Released MBAA*1*7 SEQ #5
Extracted from mail message
**KIDS**:MBAA*1.0*7^

**INSTALL NAME**
MBAA*1.0*7
"BLD",10627,0)
MBAA*1.0*7^MOBILE SCHEDULING APPLICATIONS^0^3180705^y
"BLD",10627,4,0)
^9.64PA^^
"BLD",10627,6.3)
16
"BLD",10627,"ABPKG")
n
"BLD",10627,"KRN",0)
^9.67PA^779.2^20
"BLD",10627,"KRN",.4,0)
.4
"BLD",10627,"KRN",.401,0)
.401
"BLD",10627,"KRN",.402,0)
.402
"BLD",10627,"KRN",.403,0)
.403
"BLD",10627,"KRN",.5,0)
.5
"BLD",10627,"KRN",.84,0)
.84
"BLD",10627,"KRN",3.6,0)
3.6
"BLD",10627,"KRN",3.8,0)
3.8
"BLD",10627,"KRN",9.2,0)
9.2
"BLD",10627,"KRN",9.8,0)
9.8
"BLD",10627,"KRN",9.8,"NM",0)
^9.68A^9^6
"BLD",10627,"KRN",9.8,"NM",1,0)
MBAAMDA1^^0^B69863598
"BLD",10627,"KRN",9.8,"NM",5,0)
MBAAMAP2^^0^B110563284
"BLD",10627,"KRN",9.8,"NM",6,0)
MBAAMDA2^^0^B19510830
"BLD",10627,"KRN",9.8,"NM",7,0)
MBAAMDAL^^0^B14206968
"BLD",10627,"KRN",9.8,"NM",8,0)
MBAARPC2^^0^B89267561
"BLD",10627,"KRN",9.8,"NM",9,0)
MBAAMAP1^^0^B55478568
"BLD",10627,"KRN",9.8,"NM","B","MBAAMAP1",9)

"BLD",10627,"KRN",9.8,"NM","B","MBAAMAP2",5)

"BLD",10627,"KRN",9.8,"NM","B","MBAAMDA1",1)

"BLD",10627,"KRN",9.8,"NM","B","MBAAMDA2",6)

"BLD",10627,"KRN",9.8,"NM","B","MBAAMDAL",7)

"BLD",10627,"KRN",9.8,"NM","B","MBAARPC2",8)

"BLD",10627,"KRN",19,0)
19
"BLD",10627,"KRN",19,"NM",0)
^9.68A^^
"BLD",10627,"KRN",19.1,0)
19.1
"BLD",10627,"KRN",101,0)
101
"BLD",10627,"KRN",409.61,0)
409.61
"BLD",10627,"KRN",771,0)
771
"BLD",10627,"KRN",779.2,0)
779.2
"BLD",10627,"KRN",870,0)
870
"BLD",10627,"KRN",8989.51,0)
8989.51
"BLD",10627,"KRN",8989.52,0)
8989.52
"BLD",10627,"KRN",8994,0)
8994
"BLD",10627,"KRN","B",.4,.4)

"BLD",10627,"KRN","B",.401,.401)

"BLD",10627,"KRN","B",.402,.402)

"BLD",10627,"KRN","B",.403,.403)

"BLD",10627,"KRN","B",.5,.5)

"BLD",10627,"KRN","B",.84,.84)

"BLD",10627,"KRN","B",3.6,3.6)

"BLD",10627,"KRN","B",3.8,3.8)

"BLD",10627,"KRN","B",9.2,9.2)

"BLD",10627,"KRN","B",9.8,9.8)

"BLD",10627,"KRN","B",19,19)

"BLD",10627,"KRN","B",19.1,19.1)

"BLD",10627,"KRN","B",101,101)

"BLD",10627,"KRN","B",409.61,409.61)

"BLD",10627,"KRN","B",771,771)

"BLD",10627,"KRN","B",779.2,779.2)

"BLD",10627,"KRN","B",870,870)

"BLD",10627,"KRN","B",8989.51,8989.51)

"BLD",10627,"KRN","B",8989.52,8989.52)

"BLD",10627,"KRN","B",8994,8994)

"BLD",10627,"QUES",0)
^9.62^^
"BLD",10627,"REQB",0)
^9.611^1^1
"BLD",10627,"REQB",1,0)
MBAA*1.0*5^1
"BLD",10627,"REQB","B","MBAA*1.0*5",1)

"MBREQ")
0
"PKG",665,-1)
1^1
"PKG",665,0)
MOBILE SCHEDULING APPLICATIONS^MBAA^Mobile Application for Scheduling Calendar View
"PKG",665,20,0)
^9.402P^^
"PKG",665,22,0)
^9.49I^1^1
"PKG",665,22,1,0)
1.0^3160601^3160601^520736418
"PKG",665,22,1,"PAH",1,0)
7^3180705
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","MBAAMAP1")
0^9^B55478568^B37295947
"RTN","MBAAMAP1",1,0)
MBAAMAP1 ;OIT-PD/VSL - APPOINTMENT API ;02/10/2016
"RTN","MBAAMAP1",2,0)
 ;;1.0;Scheduling Calendar View;**1,7**;Aug 27, 2014;Build 16
"RTN","MBAAMAP1",3,0)
 ;
"RTN","MBAAMAP1",4,0)
 ;Associated ICRs
"RTN","MBAAMAP1",5,0)
 ;  ICR#
"RTN","MBAAMAP1",6,0)
 ;  10104 XLFSTR
"RTN","MBAAMAP1",7,0)
 ;  10103 XLFDT
"RTN","MBAAMAP1",8,0)
 ;   6934 TAG PTFU uses $O(^SCE("ADFN",DFN,SDT),-1)
"RTN","MBAAMAP1",9,0)
 ;
"RTN","MBAAMAP1",10,0)
 ;code removed below is scheduled for a future release of MBAA
"RTN","MBAAMAP1",11,0)
CLNCK(RETURN,CLN) ;Check clinic for valid stop code restriction. Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMAP1",12,0)
 ;  INPUT:   CLN   = IEN of Clinic
"RTN","MBAAMAP1",13,0)
 ;
"RTN","MBAAMAP1",14,0)
 ;  OUTPUT:  1 if no error or 0^error message
"RTN","MBAAMAP1",15,0)
 N PSC,SSC,ND0,VAL,FLDS
"RTN","MBAAMAP1",16,0)
 S RETURN=0
"RTN","MBAAMAP1",17,0)
 I CLN="" D ERRX^MBAAAPIE(.RETURN,"CLNINV") Q 0
"RTN","MBAAMAP1",18,0)
 D GETCLN^MBAAMDA1(.FLDS,CLN,1,0,0)
"RTN","MBAAMAP1",19,0)
 I '$D(FLDS) D ERRX^MBAAAPIE(.RETURN,"CLNNDFN") Q 0
"RTN","MBAAMAP1",20,0)
 I $G(FLDS(2))'="C" Q 1     ;not a Clinic
"RTN","MBAAMAP1",21,0)
 S %=$$SCREST(.RETURN,FLDS(8),"P")
"RTN","MBAAMAP1",22,0)
 Q:'% %  Q:FLDS(2503)="" 1
"RTN","MBAAMAP1",23,0)
 S %=$$SCREST(.RETURN,FLDS(2503),"S")
"RTN","MBAAMAP1",24,0)
 S RETURN=%
"RTN","MBAAMAP1",25,0)
 Q RETURN
"RTN","MBAAMAP1",26,0)
 ;
"RTN","MBAAMAP1",27,0)
SCREST(RETURN,SCIEN,TYP) ;check stop code restriction in file 40.7 for a clinic. MBAA RPC: MBAA APPOINTMENT MAKE
"RTN","MBAAMAP1",28,0)
 ;  INPUT:   SCIEN = IEN of Stop Code
"RTN","MBAAMAP1",29,0)
 ;           TYP   = Stop Code Type, Primary (P) or Secondary (S)
"RTN","MBAAMAP1",30,0)
 ;           DIS   = Message Display, 1 - Display or 0 No Display
"RTN","MBAAMAP1",31,0)
 ;
"RTN","MBAAMAP1",32,0)
 ;  OUTPUT:  1 if no error, or 0^error message
"RTN","MBAAMAP1",33,0)
 ;          
"RTN","MBAAMAP1",34,0)
 N SCN,RTY,CTY,RDT,STR,STYP,FLDS,TEXT
"RTN","MBAAMAP1",35,0)
 S STYP="("_$S(TYP="P":"Prim",1:"Second")_"ary)"
"RTN","MBAAMAP1",36,0)
 S RETURN=0
"RTN","MBAAMAP1",37,0)
 I +SCIEN<1 S TEXT(1)=STYP D ERRX^MBAAAPIE(.RETURN,"CLNSCIN",.TEXT) Q 0
"RTN","MBAAMAP1",38,0)
 S CTY=$S(TYP="P":"^P^E^",1:"^S^E^")
"RTN","MBAAMAP1",39,0)
 D GETCSC^MBAAMDA1(.FLDS,SCIEN)
"RTN","MBAAMAP1",40,0)
 S RTY=$G(FLDS(5)),RDT=$G(FLDS(6))
"RTN","MBAAMAP1",41,0)
 I RTY="" D  Q 0
"RTN","MBAAMAP1",42,0)
 . S TEXT(1)=$G(FLDS(1)),TEXT(2)=STYP
"RTN","MBAAMAP1",43,0)
 . D ERRX^MBAAAPIE(.RETURN,"CLNSCNR",.TEXT)
"RTN","MBAAMAP1",44,0)
 I CTY'[("^"_RTY_"^") D  Q 0
"RTN","MBAAMAP1",45,0)
 . S TEXT(1)=$G(FLDS(1)),TEXT(2)=$S(TYP="P":"Prim",1:"Second")_"ary"
"RTN","MBAAMAP1",46,0)
 . D ERRX^MBAAAPIE(.RETURN,"CLNSCPS",.TEXT)
"RTN","MBAAMAP1",47,0)
 I RDT>DT D  Q 0
"RTN","MBAAMAP1",48,0)
 . S TEXT(1)=$G(FLDS(1)),TEXT(2)=$$FMTE^XLFDT(RDT,"1F"),TEXT(3)=STYP  ;ICR#: 10103 XLFDT
"RTN","MBAAMAP1",49,0)
 . D ERRX^MBAAAPIE(.RETURN,"CLNSCRD",.TEXT)
"RTN","MBAAMAP1",50,0)
 S RETURN=1
"RTN","MBAAMAP1",51,0)
 Q 1
"RTN","MBAAMAP1",52,0)
 ; ;
"RTN","MBAAMAP1",53,0)
GETCLN(RETURN,CLN) ; Get Clinic data MBAA RPC: MBAA PATIENT PENDING APPT
"RTN","MBAAMAP1",54,0)
 ;  INPUT:   CLN = IEN of Clinic
"RTN","MBAAMAP1",55,0)
 N DATA
"RTN","MBAAMAP1",56,0)
 S RETURN=0
"RTN","MBAAMAP1",57,0)
 D GETCLN^MBAAMDA1(.DATA,CLN,1,1,1)
"RTN","MBAAMAP1",58,0)
 I '$D(DATA) D ERRX^MBAAAPIE(.RETURN,"CLNNFND") Q 0
"RTN","MBAAMAP1",59,0)
 M RETURN=DATA
"RTN","MBAAMAP1",60,0)
 S RETURN=1
"RTN","MBAAMAP1",61,0)
 Q 1
"RTN","MBAAMAP1",62,0)
 ;
"RTN","MBAAMAP1",63,0)
 ;LSTCLNS(RETURN,SEARCH,START,NUMBER) ; Return clinics filtered by name.
"RTN","MBAAMAP1",64,0)
 ; N LST
"RTN","MBAAMAP1",65,0)
 ; D LSTCLNS^MBAAMDA1(.LST,$G(SEARCH),.START,$G(NUMBER))
"RTN","MBAAMAP1",66,0)
 ; D BLDLST^MBAAMAPI(.RETURN,.LST)
"RTN","MBAAMAP1",67,0)
 ; Q 1
"RTN","MBAAMAP1",68,0)
 ; ;
"RTN","MBAAMAP1",69,0)
CLNRGHT(RETURN,CLN) ; Verifies (DUZ) user access to Clinic Called by RPC MBAA APPOINTMENT MAKE, MBAA RPC: MBAA CANCEL APPOINTMENT
"RTN","MBAAMAP1",70,0)
 N DATA,TXT
"RTN","MBAAMAP1",71,0)
 S RETURN=0
"RTN","MBAAMAP1",72,0)
 D GETCLN^MBAAMDA1(.DATA,CLN,1)
"RTN","MBAAMAP1",73,0)
 I DATA(2500)="Y"  D  Q RETURN
"RTN","MBAAMAP1",74,0)
 . I $D(DATA(2501,DUZ,.01))>0 S RETURN=1 Q
"RTN","MBAAMAP1",75,0)
 . E  D
"RTN","MBAAMAP1",76,0)
 . . S RETURN=0 S TXT(1)=DATA(.01),TXT(2)=$C(10)
"RTN","MBAAMAP1",77,0)
 . . D ERRX^MBAAAPIE(.RETURN,"CLNURGT",.TXT)
"RTN","MBAAMAP1",78,0)
 . . S RETURN("CLN")=DATA(.01)
"RTN","MBAAMAP1",79,0)
 E  S RETURN=1 Q 1
"RTN","MBAAMAP1",80,0)
 ;
"RTN","MBAAMAP1",81,0)
 ;CLNVSC(RETURN,SC) ; Verifies clinic stop code validation
"RTN","MBAAMAP1",82,0)
 ; N DATA
"RTN","MBAAMAP1",83,0)
 ; S RETURN=0
"RTN","MBAAMAP1",84,0)
 ; D GETCSC^MBAAMDA1(.DATA,+SC)
"RTN","MBAAMAP1",85,0)
 ; I $S('$D(DATA):1,'DATA(2):0,1:$G(DATA(2))'>DT) D  Q RETURN
"RTN","MBAAMAP1",86,0)
 ; . S TEXT(1)=+SC
"RTN","MBAAMAP1",87,0)
 ; . D ERRX^MBAAAPIE(.RETURN,"CLNSCIN",.TEXT)
"RTN","MBAAMAP1",88,0)
 ; . S RETURN=0
"RTN","MBAAMAP1",89,0)
 ; S RETURN=1
"RTN","MBAAMAP1",90,0)
 ; Q RETURN
"RTN","MBAAMAP1",91,0)
 ;
"RTN","MBAAMAP1",92,0)
GETSCAP(RETURN,SC,DFN,SD) ; Get clinic appointment Called by RPC MBAA APPOINTMENT MAKE, MBAA RPC: MBAA CANCEL APPOINTMENT
"RTN","MBAAMAP1",93,0)
 N NOD0,CO
"RTN","MBAAMAP1",94,0)
 I '$D(DFN)!(+$G(DFN)'>0) S RETURN=0,TXT(1)="DFN" D ERRX^MBAAAPIE(.RETURN,"INVPARAM",.TXT)
"RTN","MBAAMAP1",95,0)
 I '$D(SC)!(+$G(SC)'>0) S RETURN=0,TXT(1)="SC" D ERRX^MBAAAPIE(.RETURN,"INVPARAM",.TXT)
"RTN","MBAAMAP1",96,0)
 I '$D(SD)!(+$G(SD)'>0) S RETURN=0,TXT(1)="SD" D ERRX^MBAAAPIE(.RETURN,"INVPARAM",.TXT)
"RTN","MBAAMAP1",97,0)
 D GETSCAP^MBAAMDA1(.RETURN,+SC,+DFN,+SD)
"RTN","MBAAMAP1",98,0)
 I $D(RETURN) D
"RTN","MBAAMAP1",99,0)
 . S NOD0=RETURN(0),CO=$G(RETURN("C"))
"RTN","MBAAMAP1",100,0)
 . S RETURN("IFN")=RETURN
"RTN","MBAAMAP1",101,0)
 . S RETURN("USER")=$P(NOD0,U,6)
"RTN","MBAAMAP1",102,0)
 . S RETURN("DATE")=$P(NOD0,U,7)
"RTN","MBAAMAP1",103,0)
 . S RETURN("CHECKOUT")=$P(CO,U,3)
"RTN","MBAAMAP1",104,0)
 . S RETURN("CHECKIN")=$P(CO,U,1)
"RTN","MBAAMAP1",105,0)
 . S RETURN("LENGTH")=$P(NOD0,U,2)
"RTN","MBAAMAP1",106,0)
 . S RETURN("CONSULT")=$P(NOD0,U,11)
"RTN","MBAAMAP1",107,0)
 Q 1
"RTN","MBAAMAP1",108,0)
 ;
"RTN","MBAAMAP1",109,0)
SLOTS(RETURN,SC) ; Get available slots MBAA RPC: MBAA GET CLINIC AVAILABILITY
"RTN","MBAAMAP1",110,0)
 D SLOTS^MBAAMDA2(.RETURN,SC)
"RTN","MBAAMAP1",111,0)
 S RETURN=1
"RTN","MBAAMAP1",112,0)
 Q 1
"RTN","MBAAMAP1",113,0)
 ;code below is not being used in the initial release of MBAA. It will be released at a later date in a future release of MBAA
"RTN","MBAAMAP1",114,0)
 ;SCEXST(RETURN,CSC) ; Get Stop Cod Exception status
"RTN","MBAAMAP1",115,0)
 ; N RET,LAST
"RTN","MBAAMAP1",116,0)
 ; D SCEXST^MBAAMDA2(.RET,CSC)
"RTN","MBAAMAP1",117,0)
 ; S RETURN=RET
"RTN","MBAAMAP1",118,0)
 ; I RET>0 S LAST=99999999999,LAST=$O(RET("EFFECTIVE DATE",LAST),-1) D
"RTN","MBAAMAP1",119,0)
 ; . M RETURN=RET("EFFECTIVE DATE",LAST)
"RTN","MBAAMAP1",120,0)
 ; Q RETURN
"RTN","MBAAMAP1",121,0)
 ; ;
"RTN","MBAAMAP1",122,0)
LSTAPPT(RETURN,SEARCH,START,NUMBER) ; Lists appointment types MBAA RPC: MBAA APPOINTMENT LIST BY NAME
"RTN","MBAAMAP1",123,0)
 N RET,DL,IN
"RTN","MBAAMAP1",124,0)
 S:'$D(START) START="" S:'$D(SEARCH) SEARCH=""
"RTN","MBAAMAP1",125,0)
 S:'$G(NUMBER) NUMBER=""
"RTN","MBAAMAP1",126,0)
 S RETURN=0
"RTN","MBAAMAP1",127,0)
 D LSTAPPT^MBAAMDA2(.RET,$$UP^XLFSTR(SEARCH),.START,NUMBER)  ;ICR#: 10104 XLFSTR
"RTN","MBAAMAP1",128,0)
 S RETURN(0)=RET("DILIST",0)
"RTN","MBAAMAP1",129,0)
 S DL="DILIST"
"RTN","MBAAMAP1",130,0)
 F IN=1:1:$P(RETURN(0),U,1) D
"RTN","MBAAMAP1",131,0)
 . S RETURN(IN)=""
"RTN","MBAAMAP1",132,0)
 . S RETURN(IN,"ID")=RET(DL,2,IN)
"RTN","MBAAMAP1",133,0)
 . S RETURN(IN,"NAME")=RET(DL,"ID",IN,".01")
"RTN","MBAAMAP1",134,0)
 S RETURN=1
"RTN","MBAAMAP1",135,0)
 Q 1
"RTN","MBAAMAP1",136,0)
 ;code below is not being used in the initial release of MBAA. It will be released at a later date in a future release of MBAA
"RTN","MBAAMAP1",137,0)
 ;GETAPPT(RETURN,TYPE) ; Returns Appointment Type detail
"RTN","MBAAMAP1",138,0)
 ; D GETAPPT^MBAAMDA2(.RETURN,TYPE,1,1,1)
"RTN","MBAAMAP1",139,0)
 ; S RETURN=1
"RTN","MBAAMAP1",140,0)
 ; Q 1
"RTN","MBAAMAP1",141,0)
 ; ;
"RTN","MBAAMAP1",142,0)
 ;GETELIG(RETURN,ELIG) ; Returns Eligibility Code detail 
"RTN","MBAAMAP1",143,0)
 ; D GETELIG^MBAAMDA2(.RETURN,ELIG,1,1,1)
"RTN","MBAAMAP1",144,0)
 ; S RETURN=1
"RTN","MBAAMAP1",145,0)
 ; Q 1
"RTN","MBAAMAP1",146,0)
 ; ;
"RTN","MBAAMAP1",147,0)
 ;GETPEND(RETURN,DFN,DT) ; Get pending appointments
"RTN","MBAAMAP1",148,0)
 ; N CNT,SCAP,APP,CLN,%
"RTN","MBAAMAP1",149,0)
 ; S CNT=""
"RTN","MBAAMAP1",150,0)
 ; D GETPEND^MBAAMDA2(.APP,DFN,DT)
"RTN","MBAAMAP1",151,0)
 ; F  S CNT=$O(APP(CNT)) Q:CNT=""  D
"RTN","MBAAMAP1",152,0)
 ; . S RETURN(CNT,"COLLATERAL VISIT")=APP(CNT,13)
"RTN","MBAAMAP1",153,0)
 ; . S RETURN(CNT,"APPOINTMENT TYPE")=$$APTYNAME^MBAAMDA2(APP(CNT,9.5))
"RTN","MBAAMAP1",154,0)
 ; . S RETURN(CNT,"LAB")=APP(CNT,2)
"RTN","MBAAMAP1",155,0)
 ; . S RETURN(CNT,"XRAY")=APP(CNT,3)
"RTN","MBAAMAP1",156,0)
 ; . S RETURN(CNT,"EKG")=APP(CNT,4)
"RTN","MBAAMAP1",157,0)
 ; . S %=$$GETCLN^MBAAMAP1(.CLN,APP(CNT,.01))
"RTN","MBAAMAP1",158,0)
 ; . S RETURN(CNT,"CLINIC")=$P(CLN("NAME"),U,2)
"RTN","MBAAMAP1",159,0)
 ; . S %=$$GETSCAP^MBAAMAP1(.SCAP,APP(CNT,.01),DFN,CNT)
"RTN","MBAAMAP1",160,0)
 ; . S RETURN(CNT,"LENGTH OF APP'T")=$G(SCAP("LENGTH"))
"RTN","MBAAMAP1",161,0)
 ; . S RETURN(CNT,"CONSULT LINK")=$G(SCAP("CONSULT"))
"RTN","MBAAMAP1",162,0)
 ; S RETURN=($D(RETURN)>0)
"RTN","MBAAMAP1",163,0)
 ; Q 1
"RTN","MBAAMAP1",164,0)
 ; ;
"RTN","MBAAMAP1",165,0)
 ;GETAPTS(RETURN,DFN,SD) ; Get patient appointments
"RTN","MBAAMAP1",166,0)
 ; S DFN=+DFN
"RTN","MBAAMAP1",167,0)
 ; D GETAPTS^MBAAMDA2(.RETURN,+DFN,.SD)
"RTN","MBAAMAP1",168,0)
 ; S RETURN=($D(RETURN)>0)
"RTN","MBAAMAP1",169,0)
 ; Q 1
"RTN","MBAAMAP1",170,0)
 ; ;
"RTN","MBAAMAP1",171,0)
LSTCRSNS(RETURN,SEARCH,START,NUMBER) ; MBAA RPC: MBAA LIST CANCELLATION REASONS
"RTN","MBAAMAP1",172,0)
 N LST
"RTN","MBAAMAP1",173,0)
 M LST=RETURN
"RTN","MBAAMAP1",174,0)
 D LSTCRSNS^MBAAMDA2(.LST,$$UP^XLFSTR($G(SEARCH)),.START,$G(NUMBER))
"RTN","MBAAMAP1",175,0)
 D BLDLST^MBAAMAPI(.RETURN,.LST)
"RTN","MBAAMAP1",176,0)
 Q RETURN
"RTN","MBAAMAP1",177,0)
 ;code below is not being used in the initial release of MBAA. It will be released at a later date in a future release of MBAA
"RTN","MBAAMAP1",178,0)
 ;FRSTAVBL(RETURN,SC) ; Get first available date
"RTN","MBAAMAP1",179,0)
 ; D FRSTAVBL^MBAAMDA2(.RETURN,SC)
"RTN","MBAAMAP1",180,0)
 ; Q 1
"RTN","MBAAMAP1",181,0)
 ; ;
"RTN","MBAAMAP1",182,0)
 ;linetag LSTCAPTS is removed, it is not needed until the next enhancement of MBAA
"RTN","MBAAMAP1",183,0)
 ;LSTCAPTS(RETURN,SC,SDBEG,SDEND,STAT) ; Returns clinic appointments filtered by date and status
"RTN","MBAAMAP1",184,0)
 ;N APTS,CNT,IND,FAPTS,GROUPS
"RTN","MBAAMAP1",185,0)
 ;S CNT=0,IND=0
"RTN","MBAAMAP1",186,0)
 ;S RETURN=0
"RTN","MBAAMAP1",187,0)
 ;D GROUP^SDAM($P(STAT,U),.GROUPS)
"RTN","MBAAMAP1",188,0)
 ;D LSTCAPTS^MBAAMDA1(.APTS,SC,.SDBEG,.SDEND)
"RTN","MBAAMAP1",189,0)
 ;D BLDAPTS(.RETURN,.APTS,SC,,.GROUPS)
"RTN","MBAAMAP1",190,0)
 ;S RETURN=1
"RTN","MBAAMAP1",191,0)
 ;Q 1
"RTN","MBAAMAP1",192,0)
 ;
"RTN","MBAAMAP1",193,0)
 ;linetag LSTPAPTS is removed, this functionality is not needed until a future enhancement of MBAA
"RTN","MBAAMAP1",194,0)
 ;LSTPAPTS(RETURN,DFN,SDBEG,SDEND,STAT) ; Returns patient appointments filtered by date and status
"RTN","MBAAMAP1",195,0)
 ;N APTS,CNT,IND,FAPTS,GROUPS
"RTN","MBAAMAP1",196,0)
 ;S CNT=0,IND=0
"RTN","MBAAMAP1",197,0)
 ;S RETURN=0
"RTN","MBAAMAP1",198,0)
 ;D GROUP^SDAM($P(STAT,U),.GROUPS)
"RTN","MBAAMAP1",199,0)
 ;D LSTPAPTS^MBAAMDA1(.APTS,DFN,.SDBEG,.SDEND)
"RTN","MBAAMAP1",200,0)
 ;D BLDAPTS(.RETURN,.APTS,,DFN,.GROUPS)
"RTN","MBAAMAP1",201,0)
 ;S RETURN=1
"RTN","MBAAMAP1",202,0)
 ;Q 1
"RTN","MBAAMAP1",203,0)
 ;
"RTN","MBAAMAP1",204,0)
 ;linetag BLDAPTS is removed, it is not needed until the next enhancement of MBAA
"RTN","MBAAMAP1",205,0)
 ;BLDAPTS(RETURN,APTS,SSC,SDFN,GROUPS) ; Build appointment list
"RTN","MBAAMAP1",206,0)
 ;N IND,DFN,SC,VA,VADM,CDATA,SDATA,SDDA,SDSTAT,CAPT,PAPT
"RTN","MBAAMAP1",207,0)
 ;F IND=0:0 S IND=$O(APTS(IND)) Q:IND=""  D
"RTN","MBAAMAP1",208,0)
 ;. S SDATA=APTS(IND,"SDATA")
"RTN","MBAAMAP1",209,0)
 ;. Q:'$G(SDFN)&($P(SDATA,U,2)["C")
"RTN","MBAAMAP1",210,0)
 ;. S DFN=$S('$G(SDFN):+APTS(IND,"CDATA"),1:SDFN)
"RTN","MBAAMAP1",211,0)
 ;. S SD=APTS(IND,"SD")
"RTN","MBAAMAP1",212,0)
 ;. S SC=$S('$G(SSC):APTS(IND,"SC"),1:SSC)
"RTN","MBAAMAP1",213,0)
 ;. S SDDA=APTS(IND,"SDDA")
"RTN","MBAAMAP1",214,0)
 ;. S CDATA=$G(APTS(IND,"CDATA"))
"RTN","MBAAMAP1",215,0)
 ;. S SDSTAT=$$STATUS^SDAM1(DFN,SD,SC,SDATA,$S($D(SDDA):SDDA,1:""))
"RTN","MBAAMAP1",216,0)
 ;. Q:'$$CHK^SDAM1(,,,,.GROUPS,SDSTAT)
"RTN","MBAAMAP1",217,0)
 ;. Q:$G(SSC)&(($P(CDATA,U,9)="C")!($P(SDATA,U,2)["C")&($G(SC)))
"RTN","MBAAMAP1",218,0)
 ;. S CNT=CNT+1
"RTN","MBAAMAP1",219,0)
 ;. D 2^VADPT
"RTN","MBAAMAP1",220,0)
 ;. S RETURN(CNT,"BID")=VA("BID")
"RTN","MBAAMAP1",221,0)
 ;. S RETURN(CNT,"NAME")=VADM(1)
"RTN","MBAAMAP1",222,0)
 ;. D GETPAPT^MBAAMDA4(.PAPT,DFN,SD)
"RTN","MBAAMAP1",223,0)
 ;. S RETURN(CNT,"GAF")=$$GAFREQ(DFN,SC,$P(SDATA,U,11))
"RTN","MBAAMAP1",224,0)
 ;. S RETURN(CNT,"SD")=SD
"RTN","MBAAMAP1",225,0)
 ;. S RETURN(CNT,"STAT")=SDSTAT
"RTN","MBAAMAP1",226,0)
 ;. S RETURN(CNT,"STATI")=PAPT(3,"I")
"RTN","MBAAMAP1",227,0)
 ;. S RETURN(CNT,"OE")=PAPT(21,"I")
"RTN","MBAAMAP1",228,0)
 ;. S RETURN(CNT,"DFN")=DFN
"RTN","MBAAMAP1",229,0)
 ;. S RETURN(CNT,"LAB")=$P(SDATA,U,3)
"RTN","MBAAMAP1",230,0)
 ;. S RETURN(CNT,"XRAY")=$P(SDATA,U,4)
"RTN","MBAAMAP1",231,0)
 ;. S RETURN(CNT,"EKG")=$P(SDATA,U,5)
"RTN","MBAAMAP1",232,0)
 ;. S RETURN(CNT,"SC")=SC
"RTN","MBAAMAP1",233,0)
 ;. D GETCAPT^MBAAMDA4(.CAPT,DFN,SD)
"RTN","MBAAMAP1",234,0)
 ;. S RETURN(CNT,"LEN")=CAPT(1)
"RTN","MBAAMAP1",235,0)
 ;. S RETURN(CNT,"CLINIC")=PAPT(.01,"E")
"RTN","MBAAMAP1",236,0)
 ;. S RETURN(CNT,"SDDA")=APTS(IND,"SDDA")
"RTN","MBAAMAP1",237,0)
 ;. S:$G(APTS(IND,"CONS"))>0 RETURN(CNT,"CSTAT")=$$CNSSTAT^MBAAMEXT(APTS(IND,"CONS"))
"RTN","MBAAMAP1",238,0)
 ;Q
"RTN","MBAAMAP1",239,0)
 ;
"RTN","MBAAMAP1",240,0)
 ;GAFREQ(DFN,SC,CVSIT) ;
"RTN","MBAAMAP1",241,0)
 ; N SDELIG,SDGAF,SDGAFST
"RTN","MBAAMAP1",242,0)
 ; S SDELIG=$$ELSTAT^SDUTL2(DFN)
"RTN","MBAAMAP1",243,0)
 ; I $$MHCLIN^SDUTL2(SC),'($$COLLAT^SDUTL2(SDELIG)!$G(CVSIT)) D  Q SDGAFST
"RTN","MBAAMAP1",244,0)
 ; . S SDGAF=$$NEWGAF^SDUTL2(DFN),SDGAFST=$P(SDGAF,"^") Q
"RTN","MBAAMAP1",245,0)
 ; Q 0
"RTN","MBAAMAP1",246,0)
 ; ;
"RTN","MBAAMAP1",247,0)
 ;GETCSC(RETURN,SC) ; Get clinic stop code
"RTN","MBAAMAP1",248,0)
 ; N CLN
"RTN","MBAAMAP1",249,0)
 ; D GETCLN^MBAAMDA1(.CLN,SC,1)
"RTN","MBAAMAP1",250,0)
 ; D GETCSC^MBAAMDA1(.RETURN,$G(CLN(8)))
"RTN","MBAAMAP1",251,0)
 ; S RETURN=1
"RTN","MBAAMAP1",252,0)
 ; Q 1
"RTN","MBAAMAP1",253,0)
 ; ;
"RTN","MBAAMAP1",254,0)
CPAIR(RETURN,SC) ;Validate primary stop code, get credit pair MBAA RPC: MBAA APPOINTMENT MAKE
"RTN","MBAAMAP1",255,0)
 ;Input: SC=HOSPITAL LOCATION record IFN
"RTN","MBAAMAP1",256,0)
 ;Input: RETURN=variable to return clinic credit pair (pass by reference)
"RTN","MBAAMAP1",257,0)
 ;Output: 1=success, 0=invalid primary stop code
"RTN","MBAAMAP1",258,0)
 N SDSSC,CLN,CS   ;WCJ;MBAA*1*7; Newed CLN & CS
"RTN","MBAAMAP1",259,0)
 D GETCLN^MBAAMDA1(.CLN,SC,1)
"RTN","MBAAMAP1",260,0)
 Q:'$G(CLN(8)) 0
"RTN","MBAAMAP1",261,0)
 D GETCSC^MBAAMDA1(.CS,CLN(8))
"RTN","MBAAMAP1",262,0)
 S RETURN=$G(CS(1)),RETURN=$S(RETURN<100:0,RETURN>999:0,1:RETURN)
"RTN","MBAAMAP1",263,0)
 Q:RETURN'>0 0
"RTN","MBAAMAP1",264,0)
 K CS D GETCSC^MBAAMDA1(.CS,CLN(2503))
"RTN","MBAAMAP1",265,0)
 S SDSSC=$G(CS(1)),RETURN=RETURN_$S(SDSSC<100:"000",SDSSC>999:"000",1:SDSSC)
"RTN","MBAAMAP1",266,0)
 Q 1
"RTN","MBAAMAP1",267,0)
 ;
"RTN","MBAAMAP1",268,0)
PTFU(RETURN,DFN,SC)    ;Determine if this is a follow-up (return to clinic within 24 months)
"RTN","MBAAMAP1",269,0)
 ;Input: DFN=patient ifn
"RTN","MBAAMAP1",270,0)
 ;Input: SC=clinic ifn
"RTN","MBAAMAP1",271,0)
 ;Output: '1' if seen within 24 months, '0' otherwise
"RTN","MBAAMAP1",272,0)
 ;
"RTN","MBAAMAP1",273,0)
 Q:'DFN!'SC 0  ;variable check
"RTN","MBAAMAP1",274,0)
 N SDBDT,SDT,SDX,SDY,SDCP1,SDCP2,SDENC,SDCT
"RTN","MBAAMAP1",275,0)
 ;set up variables
"RTN","MBAAMAP1",276,0)
 S SDBDT=(DT-20000)+.24,SDT=DT_.999999,SDY=0
"RTN","MBAAMAP1",277,0)
 S SDX=$$CPAIR(.SDCP1,SC)  ;get credit pair for this clinic
"RTN","MBAAMAP1",278,0)
 Q:'SDX 0
"RTN","MBAAMAP1",279,0)
 ;Iterate through encounters
"RTN","MBAAMAP1",280,0)
 F  S SDT=$O(^SCE("ADFN",DFN,SDT),-1) Q:(SDT<SDBDT)!SDY  D
"RTN","MBAAMAP1",281,0)
 .S SDENC=0 F  S SDENC=$O(^SCE("ADFN",DFN,SDT,SDENC)) Q:'SDENC!SDY  D
"RTN","MBAAMAP1",282,0)
 ..Q:$$GET1^DIQ(409.68,SDENC,.06,"I")  ;parent encounters only
"RTN","MBAAMAP1",283,0)
 ..S SDX=$$GET1^DIQ(409.68,SDENC,.04,"I")  ;get clinic
"RTN","MBAAMAP1",284,0)
 ..Q:'SDX
"RTN","MBAAMAP1",285,0)
 ..S SDX=$$CPAIR(.SDCP2,SDX)  ;get credit pair for this clinic
"RTN","MBAAMAP1",286,0)
 ..Q:'SDX
"RTN","MBAAMAP1",287,0)
 ..S SDY=SDCP1=SDCP2  ;compare credit pairs
"RTN","MBAAMAP1",288,0)
 ..Q
"RTN","MBAAMAP1",289,0)
 .Q
"RTN","MBAAMAP1",290,0)
 Q SDY
"RTN","MBAAMAP1",291,0)
 ;
"RTN","MBAAMAP1",292,0)
 ;code below is not being used in the initial release of MBAA. It will be released at a later date in a future release of MBAA
"RTN","MBAAMAP1",293,0)
 ;HASPEND(RETURN,DFN,DT) ; Check if patient has panding appointments
"RTN","MBAAMAP1",294,0)
 ; D HASPEND^MBAAMDA2(.RETURN,DFN,DT)
"RTN","MBAAMAP1",295,0)
 ; Q 1
"RTN","MBAAMAP1",296,0)
 ; ;
"RTN","MBAAMAP1",297,0)
 ;LSTSRT(RETURN) ;List scheduling request types
"RTN","MBAAMAP1",298,0)
 ; K RETURN
"RTN","MBAAMAP1",299,0)
 ; S RETURN=1
"RTN","MBAAMAP1",300,0)
 ; D LSTSCOD^MBAAMDAL(2.98,25,.RETURN)
"RTN","MBAAMAP1",301,0)
 ; Q 1
"RTN","MBAAMAP1",302,0)
 ; ;
"RTN","MBAAMAP1",303,0)
 ;LSTAPPST(RETURN) ;List appointment statuses
"RTN","MBAAMAP1",304,0)
 ; K RETURN
"RTN","MBAAMAP1",305,0)
 ; S RETURN=1
"RTN","MBAAMAP1",306,0)
 ; D LSTSCOD^MBAAMDAL(2.98,3,.RETURN)
"RTN","MBAAMAP1",307,0)
 ; Q 1
"RTN","MBAAMAP1",308,0)
 ; ;
"RTN","MBAAMAP1",309,0)
 ;LSTHLTP(RETURN) ;List hospital location types
"RTN","MBAAMAP1",310,0)
 ; K RETURN
"RTN","MBAAMAP1",311,0)
 ; S RETURN=1
"RTN","MBAAMAP1",312,0)
 ; D LSTSCOD^MBAAMDAL(44,2,.RETURN)
"RTN","MBAAMAP1",313,0)
 ; Q 1
"RTN","MBAAMAP1",314,0)
 ;
"RTN","MBAAMAP1",315,0)
 ;
"RTN","MBAAMAP1",316,0)
 ;WCJ;MAAA*1*7;old PTFU tag saved for posterity
"RTN","MBAAMAP1",317,0)
 ;deemed too slow since it goes through the entire outpatient encounter file
"RTN","MBAAMAP1",318,0)
 ;and while it uses a screen, it was still way too slow
"RTN","MBAAMAP1",319,0)
 ;
"RTN","MBAAMAP1",320,0)
PTFU2(RETURN,DFN,SC)    ;Determine if this is a follow-up (return to clinic within 24 months) Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMAP1",321,0)
 ;Input: DFN=patient ifn
"RTN","MBAAMAP1",322,0)
 ;Input: SC=clinic ifn
"RTN","MBAAMAP1",323,0)
 ;Output: '1' if seen within 24 months, '0' otherwise
"RTN","MBAAMAP1",324,0)
 ;
"RTN","MBAAMAP1",325,0)
 Q:'DFN!'SC 0  ;variable check
"RTN","MBAAMAP1",326,0)
 S RETURN=1
"RTN","MBAAMAP1",327,0)
 N SDBDT,SDT,SDX,SDY,SDZ,SDCP,SDCP1,SC0,SDENC,SDCT,LST,ENC,FLDS
"RTN","MBAAMAP1",328,0)
 ;set up variables
"RTN","MBAAMAP1",329,0)
 S SDBDT=(DT-20000)+.24,SDT=DT_.999999,SDY=0
"RTN","MBAAMAP1",330,0)
 S SDX=$$CPAIR(.SDCP,SC)  ;get credit pair for this clinic
"RTN","MBAAMAP1",331,0)
 ;Iterate through encounters
"RTN","MBAAMAP1",332,0)
 D LSTAENC^MBAAMDA1(.LST,DFN)
"RTN","MBAAMAP1",333,0)
 S FLDS(.04)="CLINIC",FLDS(.06)="PARENT"
"RTN","MBAAMAP1",334,0)
 D BLDLST^MBAAMAPI(.ENC,.LST,.FLDS)
"RTN","MBAAMAP1",335,0)
 F  S SDT=$O(ENC(SDT),-1) Q:'SDT!SDY  D
"RTN","MBAAMAP1",336,0)
 . Q:ENC(SDT,"PARENT")]""  ;parent encounters only
"RTN","MBAAMAP1",337,0)
 . Q:ENC(SDT,"NAME")<SDBDT
"RTN","MBAAMAP1",338,0)
 . S SDX=$$CPAIR(.SDCP1,ENC(SDT,"CLINIC"))  ;get credit pair for encounter
"RTN","MBAAMAP1",339,0)
 . S SDY=SDCP=SDCP1  ;compare credit pairs
"RTN","MBAAMAP1",340,0)
 . Q
"RTN","MBAAMAP1",341,0)
 Q SDY
"RTN","MBAAMAP2")
0^5^B110563284^B80917578
"RTN","MBAAMAP2",1,0)
MBAAMAP2 ;OIT-PD/VSL - APPOINTMENT API ;FEB 23, 2017
"RTN","MBAAMAP2",2,0)
 ;;1.0;Scheduling Calendar View;**1,4,5,7**;May 5, 2015;Build 16
"RTN","MBAAMAP2",3,0)
 ;
"RTN","MBAAMAP2",4,0)
 ;Associated ICRs
"RTN","MBAAMAP2",5,0)
 ;  ICR#
"RTN","MBAAMAP2",6,0)
 ;  5838 SDAMEVT
"RTN","MBAAMAP2",7,0)
 ;  6048 SDAMEVT
"RTN","MBAAMAP2",8,0)
 ;  6054 MBAA USE OF SDAM2 API get inpatient data
"RTN","MBAAMAP2",9,0)
 ;  6049 MBAA SDMANA API USE
"RTN","MBAAMAP2",10,0)
 ;  5838 SDAMEVT
"RTN","MBAAMAP2",11,0)
 ;
"RTN","MBAAMAP2",12,0)
CHKAPP(RETURN,SC,DFN,SD,LEN,LVL) ; Check make appointment Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMAP2",13,0)
 N PAT,CLN,VAL,PATT,HOL,TXT,X1,X2,APT,CAPT,FRSTA,SDEDT,SDSOH,%
"RTN","MBAAMAP2",14,0)
 K RETURN
"RTN","MBAAMAP2",15,0)
 S RETURN=1
"RTN","MBAAMAP2",16,0)
 S:'$G(LVL) LVL=7
"RTN","MBAAMAP2",17,0)
 D GETPAT^MBAAMDA3(.PAT,DFN,1) ; get patient data
"RTN","MBAAMAP2",18,0)
 D GETCLN^MBAAMDA1(.CLN,SC,1) ; get clinic data
"RTN","MBAAMAP2",19,0)
 ;check patient, stop code and inactive
"RTN","MBAAMAP2",20,0)
 S %=$$CHKAPTU(.RETURN,SC,DFN,SD,.CLN,.PAT) Q:RETURN=0 0
"RTN","MBAAMAP2",21,0)
 ;check user permissions
"RTN","MBAAMAP2",22,0)
 S VAL=$$CLNRGHT^MBAAMAP1(.RETURN,SC) Q:VAL=0 VAL
"RTN","MBAAMAP2",23,0)
 S %=$$SETST^MBAAMAP4(.RETURN,SC,SD) Q:RETURN=0 0
"RTN","MBAAMAP2",24,0)
 ;verify that day hasn't been canceled via "SET UP A CLINIC"
"RTN","MBAAMAP2",25,0)
 D GETPATT^MBAAMDA1(.PATT,SC,SD) I $G(PATT(0))'["[" S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTCLUV") Q 0
"RTN","MBAAMAP2",26,0)
 ;check if schedule on holiday is permited
"RTN","MBAAMAP2",27,0)
 D GETHOL^MBAAMDA1(.HOL,$P(SD,"."))
"RTN","MBAAMAP2",28,0)
 S SDSOH=$S('$D(CLN(1918.5)):0,CLN(1918.5)']"":0,1:1)
"RTN","MBAAMAP2",29,0)
 I $D(HOL(0)),'SDSOH S TXT(1)=$P(HOL(0),U,2) S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTSHOL",.TXT) Q 0
"RTN","MBAAMAP2",30,0)
 ;check if exceed max days for future appointment
"RTN","MBAAMAP2",31,0)
 S X1=DT,SDEDT=$G(CLN(2002))
"RTN","MBAAMAP2",32,0)
 S:SDEDT'>0 SDEDT=365
"RTN","MBAAMAP2",33,0)
 S X2=SDEDT D C^%DTC S SDEDT=X
"RTN","MBAAMAP2",34,0)
 I $P(SD,".")'<SDEDT S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTEXCD") Q 0
"RTN","MBAAMAP2",35,0)
 ;
"RTN","MBAAMAP2",36,0)
 ;check if patient has an active appointment on the same time
"RTN","MBAAMAP2",37,0)
 ;
"RTN","MBAAMAP2",38,0)
 ;WCJ;MBAA*1*7;Need to expand to check for overlaps beyond starting at the exact same time
"RTN","MBAAMAP2",39,0)
 ;check if new appointment + LEN crosses an appointment on file (that isn't cancelled) and
"RTN","MBAAMAP2",40,0)
 ;check if appointments on file (that isn't cancelled) + duration crosses the appointment we are trying to book
"RTN","MBAAMAP2",41,0)
 ;
"RTN","MBAAMAP2",42,0)
 ; first, get the appointments for the day
"RTN","MBAAMAP2",43,0)
 D GETAPTS^MBAAMDA2(.APT,DFN,$P(SD,"."))
"RTN","MBAAMAP2",44,0)
 ;
"RTN","MBAAMAP2",45,0)
 ; Then check if new one plus its length crosses another appointment already scheduled.
"RTN","MBAAMAP2",46,0)
 ; Add LENgth of new appointment to the starting time of new appoinment to get the appointment end time.
"RTN","MBAAMAP2",47,0)
 ; can they have an 60 minute at 8 and another appt at 9 ???
"RTN","MBAAMAP2",48,0)
 ; assuming they can for now and subtracting a second will allow that.
"RTN","MBAAMAP2",49,0)
 N LOOPSD,APPTEND
"RTN","MBAAMAP2",50,0)
 S APPTEND=$$FMADD^XLFDT(SD,0,0,LEN,-1)
"RTN","MBAAMAP2",51,0)
 ;
"RTN","MBAAMAP2",52,0)
 ; Loop thru appointments on file starting with the start time of the new appointment (minus a second)
"RTN","MBAAMAP2",53,0)
 ; Quit when the start time of existing appointment > end time of new one since more overlaps not possible
"RTN","MBAAMAP2",54,0)
 ; If there is an appointment in between which is not cancelled, we (royal one) have an issue
"RTN","MBAAMAP2",55,0)
 S LOOPSD=$$FMADD^XLFDT(SD,0,0,0,-1)  ; subtract a second to catch ones with exact same start time
"RTN","MBAAMAP2",56,0)
 F  S LOOPSD=$O(APT("APT",LOOPSD)) Q:LOOPSD>APPTEND!('+LOOPSD)  I APT("APT",LOOPSD,"STATUS")'["C" D  Q
"RTN","MBAAMAP2",57,0)
 . ;MBAA*1*5 - use clinic of existing appointment
"RTN","MBAAMAP2",58,0)
 . N SC1 S SC1=$P($G(APT("APT",LOOPSD,"CLINIC")),U) Q:'SC1
"RTN","MBAAMAP2",59,0)
 . S %=$$GETSCAP^MBAAMAP1(.CAPT,SC1,DFN,LOOPSD) Q:'$D(CAPT)
"RTN","MBAAMAP2",60,0)
 . S TXT(1)="("_CAPT("LENGTH")_" MINUTES)"
"RTN","MBAAMAP2",61,0)
 . S RETURN=0
"RTN","MBAAMAP2",62,0)
 . D ERRX^MBAAAPIE(.RETURN,"APTPAHA",.TXT,2)
"RTN","MBAAMAP2",63,0)
 Q:RETURN=0 0
"RTN","MBAAMAP2",64,0)
 ;
"RTN","MBAAMAP2",65,0)
 ; Now check if an existing appointment plus its length crosses this new one.
"RTN","MBAAMAP2",66,0)
 ; going back 1 day to start.  probably overkill - if max length of an appointment is a thing, we could go back that far.
"RTN","MBAAMAP2",67,0)
 S LOOPSD=$$FMADD^XLFDT(SD,-1,0,0,0)
"RTN","MBAAMAP2",68,0)
 F  S LOOPSD=$O(APT("APT",LOOPSD)) Q:LOOPSD>APPTEND!('+LOOPSD)  I APT("APT",LOOPSD,"STATUS")'["C" D  Q:RETURN=0
"RTN","MBAAMAP2",69,0)
 . ;MBAA*1*5 - use clinic of existing appointment
"RTN","MBAAMAP2",70,0)
 . N SC1 S SC1=$P($G(APT("APT",LOOPSD,"CLINIC")),U) Q:'SC1
"RTN","MBAAMAP2",71,0)
 . S %=$$GETSCAP^MBAAMAP1(.CAPT,SC1,DFN,LOOPSD)
"RTN","MBAAMAP2",72,0)
 . Q:'+$G(CAPT("LENGTH"))  ; can't check for overlaps without length so assume it's cool
"RTN","MBAAMAP2",73,0)
 . Q:'($$FMADD^XLFDT(LOOPSD,0,0,+$G(CAPT("LENGTH")),-1)>SD)  ; check if existing start + length - 1 sec > new appt start
"RTN","MBAAMAP2",74,0)
 . S TXT(1)="("_CAPT("LENGTH")_" MINUTES)"
"RTN","MBAAMAP2",75,0)
 . S RETURN=0
"RTN","MBAAMAP2",76,0)
 . D ERRX^MBAAAPIE(.RETURN,"APTPAHA",.TXT,2)
"RTN","MBAAMAP2",77,0)
 Q:RETURN=0 0
"RTN","MBAAMAP2",78,0)
 ;
"RTN","MBAAMAP2",79,0)
 ; left the old check for now, just in case
"RTN","MBAAMAP2",80,0)
 ; Check if patient has an appointment that starts exactly at the same time that hasn't been cancelled
"RTN","MBAAMAP2",81,0)
 ;I $D(APT),APT("APT",SD,"STATUS")'["C"  D
"RTN","MBAAMAP2",82,0)
 ;. ;MBAA*1*5 - use clinic of existing appointment
"RTN","MBAAMAP2",83,0)
 ;. N SC1 S SC1=$P($G(APT("APT",SD,"CLINIC")),U) Q:'SC1
"RTN","MBAAMAP2",84,0)
 ;. S %=$$GETSCAP^MBAAMAP1(.CAPT,SC1,DFN,SD) Q:'$D(CAPT)
"RTN","MBAAMAP2",85,0)
 ;. S TXT(1)="("_CAPT("LENGTH")_" MINUTES)"
"RTN","MBAAMAP2",86,0)
 ;. S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTPAHA",.TXT,2)
"RTN","MBAAMAP2",87,0)
 ;Q:RETURN=0 0
"RTN","MBAAMAP2",88,0)
 ; 
"RTN","MBAAMAP2",89,0)
 ;check if patient has an active appointment on the same day
"RTN","MBAAMAP2",90,0)
 I LVL>2 D
"RTN","MBAAMAP2",91,0)
 . K APT N IDX S IDX=""
"RTN","MBAAMAP2",92,0)
 . D GETDAPTS^MBAAMDA2(.APT,DFN,$P(SD,"."))
"RTN","MBAAMAP2",93,0)
 . F  S IDX=$O(APT(IDX)) Q:IDX=""  I APT(IDX,2)'["C"  D  Q
"RTN","MBAAMAP2",94,0)
 . . K TXT S TXT(1)="(AT "_$E(IDX_0,9,10)_":"_$E(IDX_"000",11,12)_")"
"RTN","MBAAMAP2",95,0)
 . . S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTPHSD",.TXT,3)
"RTN","MBAAMAP2",96,0)
 Q:RETURN=0 0
"RTN","MBAAMAP2",97,0)
 ;
"RTN","MBAAMAP2",98,0)
 ;check if patient has an canceled appointment on the same time
"RTN","MBAAMAP2",99,0)
 I LVL'<2 D
"RTN","MBAAMAP2",100,0)
 . K APT
"RTN","MBAAMAP2",101,0)
 . D GETAPTS^MBAAMDA2(.APT,DFN,SD)
"RTN","MBAAMAP2",102,0)
 . I $D(APT),APT("APT",SD,"STATUS")["P" D 
"RTN","MBAAMAP2",103,0)
 . . S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTPPCP",,2)
"RTN","MBAAMAP2",104,0)
 Q:RETURN=0 0
"RTN","MBAAMAP2",105,0)
 ;
"RTN","MBAAMAP2",106,0)
 ;check if date is prior to patient birth date
"RTN","MBAAMAP2",107,0)
 I $P(SD,".",1)<$P(PAT(.03),U,1) S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTPPAB") Q RETURN
"RTN","MBAAMAP2",108,0)
 ;
"RTN","MBAAMAP2",109,0)
 ;check if date is prior to clinic availability
"RTN","MBAAMAP2",110,0)
 S FRSTA=$$GETFSTA^MBAAMDA1(SC) I FRSTA,$P(SD,".",1)<FRSTA S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTPCLA") Q 0
"RTN","MBAAMAP2",111,0)
 ;
"RTN","MBAAMAP2",112,0)
 ;check overbook
"RTN","MBAAMAP2",113,0)
 S %=$$CHKOVB(.RETURN,.CLN,SC,SD,LEN,LVL) Q:RETURN=0 RETURN
"RTN","MBAAMAP2",114,0)
 S RETURN=1
"RTN","MBAAMAP2",115,0)
 Q RETURN
"RTN","MBAAMAP2",116,0)
 ;
"RTN","MBAAMAP2",117,0)
CHKOVB(RETURN,CLN,SC,SD,LEN,LVL) ; Check overbook Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMAP2",118,0)
 N TXT,ACC,SM,MAXOB,OBNO,PP,KEYS
"RTN","MBAAMAP2",119,0)
 S RETURN=1 S:'$G(LVL) LVL=7
"RTN","MBAAMAP2",120,0)
 S SM=$$DECAVA(.CLN,SC,SD,LEN,.PP)
"RTN","MBAAMAP2",121,0)
 Q:'SM 0
"RTN","MBAAMAP2",122,0)
 S KEYS("SDOB")="",KEYS("SDMOB")=""
"RTN","MBAAMAP2",123,0)
 D GETXUS^MBAAMDA3(.ACC,.KEYS,DUZ)
"RTN","MBAAMAP2",124,0)
 I '$D(ACC("SDOB")) S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTNOST") Q 0
"RTN","MBAAMAP2",125,0)
 S MAXOB=CLN(1918)
"RTN","MBAAMAP2",126,0)
 S OBNO=$$GETOBNO(SC,SD)
"RTN","MBAAMAP2",127,0)
 S TXT(1)=MAXOB,TXT(2)=$S(OBNO>1:"S",1:"")
"RTN","MBAAMAP2",128,0)
 I OBNO>MAXOB,'$D(ACC("SDMOB")) S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTOAPD",.TXT) Q 0
"RTN","MBAAMAP2",129,0)
 I OBNO>MAXOB,LVL>1 S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTEXOB",,2) Q 0
"RTN","MBAAMAP2",130,0)
 I SM=6,LVL>1 S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTOVBK",,2) Q 0
"RTN","MBAAMAP2",131,0)
 I SM=7 S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTOVOS",,2) Q 0
"RTN","MBAAMAP2",132,0)
 I SM=1 S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTCBCP") Q 0
"RTN","MBAAMAP2",133,0)
 Q RETURN
"RTN","MBAAMAP2",134,0)
 ;
"RTN","MBAAMAP2",135,0)
GETOBNO(SC,SD) ; Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMAP2",136,0)
 N IND,CNT,APTS
"RTN","MBAAMAP2",137,0)
 S IND="",CNT=0
"RTN","MBAAMAP2",138,0)
 D GETDAYA^MBAAMDA1(.APTS,SC,SD)
"RTN","MBAAMAP2",139,0)
 F  S IND=$O(APTS(IND)) Q:IND=""  S:APTS(IND,"OB")>0 CNT=CNT+1
"RTN","MBAAMAP2",140,0)
 Q CNT
"RTN","MBAAMAP2",141,0)
 ;
"RTN","MBAAMAP2",142,0)
CHKAPTU(RETURN,SC,DFN,SD,CLN,PAT,UNS) ; Check make unscheduled appointment MBAA RPC: MBAA APPOINTMENT MAKE
"RTN","MBAAMAP2",143,0)
 N PAPT,CLN,TXT
"RTN","MBAAMAP2",144,0)
 D:'$D(PAT) GETPAT^MBAAMDA3(.PAT,DFN,1) ; get patient data
"RTN","MBAAMAP2",145,0)
 D:'$D(CLN) GETCLN^MBAAMDA1(.CLN,SC,1) ; get clinic data
"RTN","MBAAMAP2",146,0)
 ;check if patient already has appointment
"RTN","MBAAMAP2",147,0)
 S PAPT(.01)="" D GETPAPT^MBAAMDA2(.PAPT,DFN,SD)
"RTN","MBAAMAP2",148,0)
 S TXT(1)=$$FTIME^VALM1(SD)  ;ICR#: 10116 VALM1
"RTN","MBAAMAP2",149,0)
 I PAPT(.01)>0,$D(UNS) S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTPAHU",.TXT) Q RETURN
"RTN","MBAAMAP2",150,0)
 ;check if patient is dead
"RTN","MBAAMAP2",151,0)
 I +$G(PAT(.351))>0 S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"PATDIED") Q RETURN
"RTN","MBAAMAP2",152,0)
 ;check if clinic is valid (stop code)
"RTN","MBAAMAP2",153,0)
 S VAL=$$CLNCK^MBAAMAP1(.RETURN,SC) Q:VAL=0 VAL
"RTN","MBAAMAP2",154,0)
 ;check inactive clinic period
"RTN","MBAAMAP2",155,0)
 I CLN(2505),$P(SD,".")'<CLN(2505),$S('CLN(2506):1,CLN(2506)>$P(SD,".")!('CLN(2506)):1,1:0) D  Q 0
"RTN","MBAAMAP2",156,0)
 . S TXT(1)=$$DTS^MBAAMAPI(CLN(2505))
"RTN","MBAAMAP2",157,0)
 . S:CLN(2506) TXT(2)=" and reactivated on "_$$DTS^MBAAMAPI(CLN(2506))
"RTN","MBAAMAP2",158,0)
 . S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTCINV",.TXT)
"RTN","MBAAMAP2",159,0)
 Q 1
"RTN","MBAAMAP2",160,0)
 ;code below is not being used in the initial release of MBAA. It will be released at a later date in a future release of MBAA
"RTN","MBAAMAP2",161,0)
 ;MAKEUS(RETURN,DFN,SC,SD,TYP,STYP) ; Make unscheduled appointment
"RTN","MBAAMAP2",162,0)
 ; N SCAP,STAT,CHKIN,%
"RTN","MBAAMAP2",163,0)
 ; S RETURN=0
"RTN","MBAAMAP2",164,0)
 ; S %=$$CHKAPTU(.RETURN,SC,DFN,SD,,,1) Q:RETURN=0 0
"RTN","MBAAMAP2",165,0)
 ; S STAT=$$INP^SDAM2(DFN,SD)
"RTN","MBAAMAP2",166,0)
 ; D GETCLN^MBAAMDA1(.CLN,SC,1)
"RTN","MBAAMAP2",167,0)
 ; D MAKE^MBAAMDA3(DFN,SD,SC,TYP,.STYP,STAT,4,DUZ,DT,"W",0)
"RTN","MBAAMAP2",168,0)
 ; D MAKE^MBAAMDA1(SC,SD,DFN,CLN(1912),,DUZ)
"RTN","MBAAMAP2",169,0)
 ; S %=$$LOCKST^MBAAMDA1(SC,SD) I '% S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTLOCK") Q 0
"RTN","MBAAMAP2",170,0)
 ; S SM=$$DECAVA(.CLN,SC,SD,CLN(1912),.S)
"RTN","MBAAMAP2",171,0)
 ; D SETST^MBAAMDA1(SC,SD,S)
"RTN","MBAAMAP2",172,0)
 ; D UNLCKST^MBAAMDA1(SC,SD)
"RTN","MBAAMAP2",173,0)
 ; S %=$$GETSCAP^MBAAMAP1(.SCAP,SC,DFN,SD)
"RTN","MBAAMAP2",174,0)
 ; D MAKE^SDAMEVT(DFN,SD,SC,SCAP("IFN"))
"RTN","MBAAMAP2",175,0)
 ; Q 1
"RTN","MBAAMAP2",176,0)
 ; ;
"RTN","MBAAMAP2",177,0)
MAKE(RETURN,DFN,SC,SD,TYPE,STYP,LEN,SRT,OTHR,CIO,LAB,XRAY,EKG,RQXRAY,CONS,LVL,DESDT) ; Make appointment Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMAP2",178,0)
 N %
"RTN","MBAAMAP2",179,0)
 ;IF WE NEED TO CHECK FOR DEPARTMENT OF DEFENSE PUT IN THE CODE TO DO THE TASKS BELOW
"RTN","MBAAMAP2",180,0)
 ;I DUZ="" THEN SET DUZ FOR DEPARTMENT OF DEFENSE 
"RTN","MBAAMAP2",181,0)
 ;S REC=$O(^VA(200,"B","DEPARTMENT OF DEFENSE,USER",""))
"RTN","MBAAMAP2",182,0)
 ;I REC'>0 SEND ERROR MESSAGE THAT THE DEPARTMENT OF DEFENSE,USER DOESN'T EXIST ON THE SYSTEM
"RTN","MBAAMAP2",183,0)
 ;I REC>0 S DUZ=REC D CLNRGHT^MBAAMRP1(.RETURN,SC) I RETURN(0)=1 S RETURN="0^RESTRICED CLINIC, USER NOT ALLOWED TO BOOK APPTS IN THIS CLINIC" Q
"RTN","MBAAMAP2",184,0)
 ;CALL VERIFY CLINIC ACCESS
"RTN","MBAAMAP2",185,0)
 ;Q:IF NOT ACCESS 
"RTN","MBAAMAP2",186,0)
 S:'$G(LVL) LVL=7
"RTN","MBAAMAP2",187,0)
 S RETURN=1
"RTN","MBAAMAP2",188,0)
 F I="SC","DFN","SD","LEN" I '$D(@I) S RETURN=0,TXT(1)=I D ERRX^MBAAAPIE(.RETURN,"INVPARAM",.TXT)
"RTN","MBAAMAP2",189,0)
 I RETURN=0 Q 0
"RTN","MBAAMAP2",190,0)
 S %=$$CHKAPP(.RETURN,SC,DFN,SD,LEN,LVL)
"RTN","MBAAMAP2",191,0)
 I RETURN=0,$P(RETURN(0),U,3)'>LVL Q RETURN(0)
"RTN","MBAAMAP2",192,0)
 I RETURN=0,$P(RETURN(0),U)="PATDIED" Q RETURN(0)
"RTN","MBAAMAP2",193,0)
 ;MBAA*1*5 - RETURN ERROR ON DUPLICATE DATE/TIME - REMOVE CANCEL AND REMAKE
"RTN","MBAAMAP2",194,0)
 ;I RETURN=0,$P(RETURN(0),U)="APTPAHA" D
"RTN","MBAAMAP2",195,0)
 ;. S %=$$CANCEL(.RETURN,DFN,SC,SD,"C",13,"")
"RTN","MBAAMAP2",196,0)
 I RETURN=0,$P(RETURN(0),U)="APTPAHA" Q RETURN(0)
"RTN","MBAAMAP2",197,0)
 E  Q:'$G(RETURN)&('$G(LVL)) 0
"RTN","MBAAMAP2",198,0)
 N CLN,S,SM,SDY,SCAP,SRT0
"RTN","MBAAMAP2",199,0)
 S %=$$LOCKST^MBAAMDA1(SC,SD) I '% S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTLOCK") Q 0
"RTN","MBAAMAP2",200,0)
 S %=$$LOCKS^MBAAMDA1(SC,SD) I '% S RETURN=0 D ERRX^MBAAAPIE(.RETURN,"APTLOCK") Q 0
"RTN","MBAAMAP2",201,0)
 D GETCLN^MBAAMDA1(.CLN,SC,1)
"RTN","MBAAMAP2",202,0)
 S SM=$$DECAVA(.CLN,SC,SD,+LEN,.S)
"RTN","MBAAMAP2",203,0)
 D SETST^MBAAMDA1(SC,SD,S)
"RTN","MBAAMAP2",204,0)
 D MAKE^MBAAMDA1(SC,SD,DFN,+LEN,SM,DUZ,$G(OTHR),.RQXRAY)
"RTN","MBAAMAP2",205,0)
 D UNLCKS^MBAAMDA1(SC,SD)
"RTN","MBAAMAP2",206,0)
 D UNLCKST^MBAAMDA1(SC,SD)
"RTN","MBAAMAP2",207,0)
 S STAT=$$INP^SDAM2(DFN,SD)  ;ICR#: 6054 MBAA USE OF SDAM2 API get inpatient data
"RTN","MBAAMAP2",208,0)
 S:SD<DT SRT="W"
"RTN","MBAAMAP2",209,0)
 S SRT0=$$NAVA^SDMANA(SC,SD,.SRT)  ;ICR#: 6049 MBAA SDMANA API USE
"RTN","MBAAMAP2",210,0)
 D MAKE^MBAAMDA3(DFN,SD,SC,.TYPE,.STYP,STAT,3,DUZ,DT,SRT,SRT0,.LAB,.XRAY,.EKG,$G(DESDT))
"RTN","MBAAMAP2",211,0)
 ;
"RTN","MBAAMAP2",212,0)
 ;WCJ;MBAA*1*7;This has previously been commented out.  Took out the set of field 27 (it was set in line above)
"RTN","MBAAMAP2",213,0)
 ;and sped up the call to get encounters to make below function useable
"RTN","MBAAMAP2",214,0)
 N DATA ; S DATA(27)=DT,
"RTN","MBAAMAP2",215,0)
 S DATA(28)=$$PTFU^MBAAMAP1(,DFN,SC)
"RTN","MBAAMAP2",216,0)
 D UPDPAPT^MBAAMDA4(.DATA,DFN,SD)
"RTN","MBAAMAP2",217,0)
 ;
"RTN","MBAAMAP2",218,0)
 S %=$$GETSCAP^MBAAMAP1(.SCAP,SC,DFN,SD)
"RTN","MBAAMAP2",219,0)
 I $G(CONS)>0 S DATA(688)=CONS
"RTN","MBAAMAP2",220,0)
 D UPDCAPT^MBAAMDA4(.DATA,SC,SD,$G(SCAP("IFN")))
"RTN","MBAAMAP2",221,0)
 S:$G(CONS)>0 %=$$EDITCS^MBAAAPI1(.RETURN,CONS,SD,.OTHR,$G(CLN("NAME"))) ;SD/478
"RTN","MBAAMAP2",222,0)
 D MAKE^SDAMEVT(DFN,SD,SC,$G(SCAP("IFN")),2) ;ICR#: 6048 SDAMEVT
"RTN","MBAAMAP2",223,0)
 ;alb/sat 4 - begin mod to update SDEC files
"RTN","MBAAMAP2",224,0)
 N SDAPTYP,SDECAR,SDECR,SDRES,SDRQTYP,SDSTAT
"RTN","MBAAMAP2",225,0)
 S CONS=$G(CONS)
"RTN","MBAAMAP2",226,0)
 S:'CONS SDECAR=$$SDWLA^SDM1A(DFN,SD,SC,DESDT,TYPE)  ;build SDEC APPT REQUEST entry
"RTN","MBAAMAP2",227,0)
 S SDAPTYP=$S(+CONS:"C|"_CONS,1:"A|"_SDECAR)
"RTN","MBAAMAP2",228,0)
 S SDRES=$$GETRES^SDECUTL(SC)
"RTN","MBAAMAP2",229,0)
 D PCSTGET^SDEC(.SDECR,DFN,SC) S SDSTAT=$P(@SDECR@(1),$C(30,31),1),SDECR=$S($P(SDSTAT,U,2)="YES":"E",1:"N")
"RTN","MBAAMAP2",230,0)
 D SDECADD^SDEC07(SD,,DFN,SDRES,0,$G(DESDT),"",SDAPTYP,,SC,$G(OTHR),,SDRES,TYPE,SDECR) ;add SDEC APPOINTMENT entry
"RTN","MBAAMAP2",231,0)
 ;alb/sat 4 - end mod
"RTN","MBAAMAP2",232,0)
 I $D(CIO),CIO="CI" S %=$$CHECKIN^MBAAMAP2(.CHKIN,DFN,SD,SC,SD)
"RTN","MBAAMAP2",233,0)
 K CHKIN,DATA,STAT
"RTN","MBAAMAP2",234,0)
 Q 1
"RTN","MBAAMAP2",235,0)
 ;
"RTN","MBAAMAP2",236,0)
DECAVA(CLN,SC,SD,LEN,PATT) ; Decrease availability Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMAP2",237,0)
 N AV,S,SB,X,Y,I,SS,ST,STR,STARTDAY,HSI,SI,SDDIF,SM,CAN,SDNOT
"RTN","MBAAMAP2",238,0)
 S SM=0,CAN=0
"RTN","MBAAMAP2",239,0)
 D GETPATT^MBAAMDA1(.AV,SC,SD)
"RTN","MBAAMAP2",240,0)
 S S=$G(AV(0)),SB=CLN(1914)
"RTN","MBAAMAP2",241,0)
 S STARTDAY=$S($L(SB):SB,1:8),SB=STARTDAY-1/100
"RTN","MBAAMAP2",242,0)
 S X=CLN(1917),HSI=$S(X=1:X,X:X,1:4),SI=$S(X="":4,X<3:4,X:X,1:4)
"RTN","MBAAMAP2",243,0)
 S STR="#@!$* XXWVUTSRQPONMLKJIHGFEDCBA0123456789jklmnopqrstuvwxyz",SDDIF=$S(HSI<3:8/HSI,1:2)
"RTN","MBAAMAP2",244,0)
 S I=SD#1-SB*100,ST=I#1*SI\.6+($P(I,".")*SI),SS=LEN*HSI/60*SDDIF+ST+ST
"RTN","MBAAMAP2",245,0)
 I SM<7 S %=$F(S,"[",SS-1) S:'%!(CLN(1917)<3) %=999 I $F(S,"]",SS)'<%!(SDDIF=2&$E(S,ST+ST+1,SS-1)["[") S SM=7
"RTN","MBAAMAP2",246,0)
 I ST+ST>$L(S),$L(S)<80 S S=S_" "
"RTN","MBAAMAP2",247,0)
 S SDNOT=1   ;SD*5.3*490 naked Do added below
"RTN","MBAAMAP2",248,0)
 F I=ST+ST:SDDIF:SS-SDDIF S ST=$E(S,I+1) S:ST="" ST=" " S Y=$E(STR,$F(STR,ST)-2) S:S["CAN"!(ST="X"&($D(AV(1)))) CAN=1 Q:CAN  S:Y'?1NL&(SM<6) SM=6 S ST=$E(S,I+2,999) D  S:ST="" ST=" " S S=$E(S,1,I)_Y_ST
"RTN","MBAAMAP2",249,0)
 .Q:ST'=""
"RTN","MBAAMAP2",250,0)
 .Q:+LEN'>CLN(1912)
"RTN","MBAAMAP2",251,0)
 .S ST="   "
"RTN","MBAAMAP2",252,0)
 .Q
"RTN","MBAAMAP2",253,0)
 S PATT=S
"RTN","MBAAMAP2",254,0)
 Q:CAN CAN
"RTN","MBAAMAP2",255,0)
 Q SM
"RTN","MBAAMAP2",256,0)
 ;
"RTN","MBAAMAP2",257,0)
CANCEL(RETURN,DFN,SC,SD,TYP,RSN,RMK) ; Cancel appointment Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMAP2",258,0)
 N CDATE,CDT,ERR,ODT,OIFN,OUSR,%
"RTN","MBAAMAP2",259,0)
 S RETURN=0
"RTN","MBAAMAP2",260,0)
 S %=$$CHKCAN^MBAAMAP3(.RETURN,DFN,SC,SD) Q:RETURN=0 0
"RTN","MBAAMAP2",261,0)
 S CDATE=$$NOW^XLFDT  ;ICR#: 10103 XLFDT
"RTN","MBAAMAP2",262,0)
 S %=$$GETSCAP^MBAAMAP1(.CAPT,SC,DFN,SD)
"RTN","MBAAMAP2",263,0)
 S CIFN=CAPT("IFN")
"RTN","MBAAMAP2",264,0)
 S OUSR=CAPT("USER"),ODT=CAPT("DATE")
"RTN","MBAAMAP2",265,0)
 N SDATA,SDCPHDL
"RTN","MBAAMAP2",266,0)
 S SDCPHDL=$$HANDLE^SDAMEVT(1) ;ICR#: 5838 SDAMEVT
"RTN","MBAAMAP2",267,0)
 D BEFORE^SDAMEVT(.SDATA,DFN,SD,SC,CIFN,SDCPHDL) ;ICR#: 5835 SDAMEVT
"RTN","MBAAMAP2",268,0)
 S CDT=$$NOW^XLFDT()  ;ICR#: 10103 XLFDT
"RTN","MBAAMAP2",269,0)
 D CANCEL^MBAAMDA3(.ERR,DFN,SD,TYP,RSN,RMK,$E(CDT,1,12),DUZ,OUSR,ODT)
"RTN","MBAAMAP2",270,0)
 S OIFN=$$COVERB^MBAAMDA1(SC,SD,CIFN)
"RTN","MBAAMAP2",271,0)
 S %=$$CANCEL^MBAAAPI1(RETURN,CAPT("CONSULT"),SC,SD,CIFN,RMK,TYP)
"RTN","MBAAMAP2",272,0)
 D CANCEL^MBAAMDA1(SC,SD,DFN,CIFN)
"RTN","MBAAMAP2",273,0)
 D CANCEL^SDAMEVT(.SDATA,DFN,SD,SC,CIFN,0,SDCPHDL) ;ICR#: 6048 MBAA SDAMEVT API CALLS
"RTN","MBAAMAP2",274,0)
 S RETURN=1 K CIFN
"RTN","MBAAMAP2",275,0)
 Q RETURN
"RTN","MBAAMAP2",276,0)
 ;
"RTN","MBAAMAP2",277,0)
CHECKIN(RETURN,DFN,SD,SC,CIDT) ; Check in appointment Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMAP2",278,0)
 N CAPT,CI,%
"RTN","MBAAMAP2",279,0)
 S CI=DT
"RTN","MBAAMAP2",280,0)
 S:$D(CIDT) CI=CIDT
"RTN","MBAAMAP2",281,0)
 S %=$$GETSCAP^MBAAMAP1(.CAPT,SC,DFN,SD)
"RTN","MBAAMAP2",282,0)
 I $G(CAPT(0))="" D ERRX^MBAAAPIE(.RETURN,"APTWHEN") Q 0
"RTN","MBAAMAP2",283,0)
 S CIFN=$G(CAPT("IFN"))
"RTN","MBAAMAP2",284,0)
 I 'CIFN D ERRX^MBAAAPIE(.RETURN,"APTWHEN") Q 0
"RTN","MBAAMAP2",285,0)
 N SDATA,SDCIHDL,X
"RTN","MBAAMAP2",286,0)
 S SDATA=CIFN_U_DFN_U_SD_U_SC,SDCIHDL=$$HANDLE^SDAMEVT(1) ;ICR#: 5835 SDAMEVT
"RTN","MBAAMAP2",287,0)
 D BEFORE^SDAMEVT(.SDATA,DFN,SD,SC,CIFN,SDCIHDL) ;ICR#: 5838 SDAMEVT
"RTN","MBAAMAP2",288,0)
 S %=$$CHKCIN^MBAAMAP3(.RETURN,DFN,SD,+SDATA("BEFORE","STATUS")) Q:'% 0
"RTN","MBAAMAP2",289,0)
 S CD(302)=DUZ,CD(309)=CI
"RTN","MBAAMAP2",290,0)
 D UPDCAPT^MBAAMDA4(.CD,SC,SD,CAPT("IFN"))
"RTN","MBAAMAP2",291,0)
 D AFTER^SDAMEVT(.SDATA,DFN,SD,SC,CIFN,SDCIHDL) ;ICR#: 5838 SDAMEVT
"RTN","MBAAMAP2",292,0)
 M RETURN=SDATA
"RTN","MBAAMAP2",293,0)
 I SDATA("BEFORE","STATUS")'=SDATA("AFTER","STATUS") D
"RTN","MBAAMAP2",294,0)
 . D EVT^SDAMEVT(.SDATA,4,0,SDCIHDL) ; 4 := ci evt , 0 := interactive mode  ;ICR#: 5838 SDAMEVT
"RTN","MBAAMAP2",295,0)
 K CD,CIFN
"RTN","MBAAMAP2",296,0)
 Q 1
"RTN","MBAAMAP2",297,0)
 ;code below is not being used in the initial release of MBAA. It will be released at a later date in a future release of MBAA
"RTN","MBAAMAP2",298,0)
 ;Linetag NOSHOW is not needed until the next enhancement of MBAA
"RTN","MBAAMAP2",299,0)
 ;NOSHOW(RETURN,DFN,SC,SD,LVL) ; No-show appointment
"RTN","MBAAMAP2",300,0)
 ;N APT0,STATUS,APTSTAT,AUTO,CNSTLNK,NSDA,NSDIE,%
"RTN","MBAAMAP2",301,0)
 ;S:'$D(LVL) LVL=7
"RTN","MBAAMAP2",302,0)
 ;S APT0=$$GETAPT0^MBAAMDA2(DFN,SD)
"RTN","MBAAMAP2",303,0)
 ;S APTSTAT=$P(APT0,U,2)
"RTN","MBAAMAP2",304,0)
 ;S STATUS=$$STATUS^SDAM1(DFN,SD,+$G(APT0),$G(APT0))
"RTN","MBAAMAP2",305,0)
 ;S RETURN=0
"RTN","MBAAMAP2",306,0)
 ;S %=$$CHKNS^MBAAMAP3(.RETURN,APT0,+STATUS,LVL)
"RTN","MBAAMAP2",307,0)
 ;I RETURN=0,$P(RETURN(0),U,3)'>LVL Q RETURN
"RTN","MBAAMAP2",308,0)
 ;N FDA,CIFN,CAPT
"RTN","MBAAMAP2",309,0)
 ;S %=$$GETSCAP^MBAAMAP1(.CAPT,SC,DFN,SD)
"RTN","MBAAMAP2",310,0)
 ;S CIFN=CAPT("IFN")
"RTN","MBAAMAP2",311,0)
 ;S CNSTLNK=$G(CAPT("CONSULT"))
"RTN","MBAAMAP2",312,0)
 ;S RETURN("BEFORE")=STATUS
"RTN","MBAAMAP2",313,0)
 ;N SDNSHDL S SDNSHDL=$$HANDLE^SDAMEVT(1)
"RTN","MBAAMAP2",314,0)
 ;D BEFORE^SDAMEVT(.SDATA,DFN,SD,SC,CIFN,SDNSHDL)
"RTN","MBAAMAP2",315,0)
 ;I APTSTAT=""!(APTSTAT="NT") D
"RTN","MBAAMAP2",316,0)
 ;. S FDA(3)="N",FDA(14)=DUZ,FDA(15)=$$NOW^XLFDT()
"RTN","MBAAMAP2",317,0)
 ;E  D
"RTN","MBAAMAP2",318,0)
 ;. S FDA(3)="@",FDA(14)="@",FDA(15)="@"
"RTN","MBAAMAP2",319,0)
 ;D UPDPAPT^MBAAMDA4(.FDA,DFN,SD)
"RTN","MBAAMAP2",320,0)
 ;D NOSHOW^SDAMEVT(.SDATA,DFN,SD,SC,CIFN,2,SDNSHDL)
"RTN","MBAAMAP2",321,0)
 ;S:+$G(CNSTLNK) %=$$NOSHOW^MBAAAPI1(.RETURN,SC,SD,DFN,CNSTLNK,CIFN)
"RTN","MBAAMAP2",322,0)
 ;S APT0=$$GETAPT0^MBAAMDA2(DFN,SD)
"RTN","MBAAMAP2",323,0)
 ;S APTSTAT=$P(APT0,U,2)
"RTN","MBAAMAP2",324,0)
 ;S STATUS=$$STATUS^SDAM1(DFN,SD,+$G(APT0),$G(APT0))
"RTN","MBAAMAP2",325,0)
 ;S RETURN("AFTER")=STATUS
"RTN","MBAAMAP2",326,0)
 ;Q 1
"RTN","MBAAMDA1")
0^1^B69863598^B68118160
"RTN","MBAAMDA1",1,0)
MBAAMDA1 ;OIT-PD/CBR - APPOINTMENT API ;02/10/2016
"RTN","MBAAMDA1",2,0)
 ;;1.0;Scheduling Calendar View;**1,5,7**;Feb 13, 2015;Build 16
"RTN","MBAAMDA1",3,0)
 ;
"RTN","MBAAMDA1",4,0)
 ;Associated ICRs
"RTN","MBAAMDA1",5,0)
 ;  ICR#
"RTN","MBAAMDA1",6,0)
 ;  10038 HOLIDAY FILE
"RTN","MBAAMDA1",7,0)
 ;  6044 SC(
"RTN","MBAAMDA1",8,0)
 ;  10103 XLFDT
"RTN","MBAAMDA1",9,0)
 ;
"RTN","MBAAMDA1",10,0)
GETCLN(RETURN,CLN,INT,EXT,REZ) ; Get clinic detail Called by RPC MBAA APPOINTMENT MAKE, MBAA RPC: MBAA CANCEL APPOINTMENT, MBAA PATIENT PENDING APPT
"RTN","MBAAMDA1",11,0)
 N FILE,SFILES,FLDS
"RTN","MBAAMDA1",12,0)
 S FILE=44
"RTN","MBAAMDA1",13,0)
 S FLDS("*")=""
"RTN","MBAAMDA1",14,0)
 S SFILES("2501")="",SFILES("2501","N")="PRIVILEGED USER",SFILES("2501","F")="44.04"
"RTN","MBAAMDA1",15,0)
 S SFILES("1910")="",SFILES("1910","N")="SI",SFILES("1910","F")="44.03"
"RTN","MBAAMDA1",16,0)
 D GETREC^MBAAMDAL(.RETURN,CLN,FILE,.FLDS,.SFILES,$G(INT),$G(EXT),$G(REZ))
"RTN","MBAAMDA1",17,0)
 Q
"RTN","MBAAMDA1",18,0)
 ;
"RTN","MBAAMDA1",19,0)
GETCLNX(RETURN,SC) ; Get clinic detailx Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",20,0)
 N IND
"RTN","MBAAMDA1",21,0)
 F IND=0:0 S IND=$O(RETURN(IND)) Q:IND=""  D
"RTN","MBAAMDA1",22,0)
 . S RETURN(IND)=$$GET1^DIQ(44,SC_",",IND,"I")
"RTN","MBAAMDA1",23,0)
 S RETURN=1
"RTN","MBAAMDA1",24,0)
 Q
"RTN","MBAAMDA1",25,0)
 ;code below is not being used in the initial release of MBAA. It will be released at a later date in a future release of MBAA
"RTN","MBAAMDA1",26,0)
 ;LSTCLNS(RETURN,SEARCH,START,NUMBER) ; Return clinics filtered by name.
"RTN","MBAAMDA1",27,0)
 ; N FILE,FIELDS,RET,SCR
"RTN","MBAAMDA1",28,0)
 ; S FILE="44",FIELDS="@;.01"
"RTN","MBAAMDA1",29,0)
 ; S:$D(START)=0 START="" S:$D(SEARCH)=0 SEARCH=""
"RTN","MBAAMDA1",30,0)
 ; S SCR="I $P(^(0),U,3)=""C"",'$G(^(""OOS""))"
"RTN","MBAAMDA1",31,0)
 ; D LIST^DIC(FILE,"",FIELDS,"",$G(NUMBER),.START,SEARCH,"B",.SCR,"","RETURN")
"RTN","MBAAMDA1",32,0)
 ; Q
"RTN","MBAAMDA1",33,0)
 ; ;
"RTN","MBAAMDA1",34,0)
GETCSC(FLDS,CSC) ; Get Clinic Stop Code MBAA RPC: MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",35,0)
 N FLD,C
"RTN","MBAAMDA1",36,0)
 D GETS^DIQ(40.7,CSC,"*","I","C")
"RTN","MBAAMDA1",37,0)
 S FLD=""
"RTN","MBAAMDA1",38,0)
 F  S FLD=$O(C(40.7,""_CSC_",",FLD)) Q:FLD=""  D
"RTN","MBAAMDA1",39,0)
 . S FLDS(FLD)=C(40.7,""_CSC_",",FLD,"I")
"RTN","MBAAMDA1",40,0)
 Q
"RTN","MBAAMDA1",41,0)
 ;code below is not being used in the initial release of MBAA. It will be released at a later date in a future release of MBAA
"RTN","MBAAMDA1",42,0)
 ;CLNURGHT(CLN,USR,DATA) ; Return user right
"RTN","MBAAMDA1",43,0)
 ; S DATA=$G(^SC(CLN,"SDPRIV",USR,0))
"RTN","MBAAMDA1",44,0)
 ; Q
"RTN","MBAAMDA1",45,0)
 ;
"RTN","MBAAMDA1",46,0)
 ;LSTTMPL(RETURN,CLN) ; List defined day template
"RTN","MBAAMDA1",47,0)
 ; N FILE,SFILES,FLDS
"RTN","MBAAMDA1",48,0)
 ; S FILE=44
"RTN","MBAAMDA1",49,0)
 ; S SFILES("1922")="",SFILES("1922","N")="SUNDAY TEMPLATE",SFILES("1922","F")="44.06"
"RTN","MBAAMDA1",50,0)
 ; S SFILES("1923")="",SFILES("1923","N")="MONDAY TEMPLATE",SFILES("1923","F")="44.07"
"RTN","MBAAMDA1",51,0)
 ; S SFILES("1924")="",SFILES("1924","N")="TUESDAY TEMPLATE",SFILES("1924","F")="44.08"
"RTN","MBAAMDA1",52,0)
 ; S SFILES("1925")="",SFILES("1925","N")="WEDNESDAY TEMPLATE",SFILES("1925","F")="44.09"
"RTN","MBAAMDA1",53,0)
 ; S SFILES("1926")="",SFILES("1926","N")="THURSDAY TEMPLATE",SFILES("1926","F")="44.08"
"RTN","MBAAMDA1",54,0)
 ; S SFILES("1927")="",SFILES("1927","N")="FRIDAY TEMPLATE",SFILES("1927","F")="44.09"
"RTN","MBAAMDA1",55,0)
 ; S SFILES("1928")="",SFILES("1928","N")="SATURDAY TEMPLATE",SFILES("1928","F")="44.0001"
"RTN","MBAAMDA1",56,0)
 ; D GETREC^MBAAMDAL(.RETURN,CLN,FILE,.FLDS,.SFILES)
"RTN","MBAAMDA1",57,0)
 ; Q
"RTN","MBAAMDA1",58,0)
 ;
"RTN","MBAAMDA1",59,0)
 ;NXTAV(CLN,SD) ; Get next available day.
"RTN","MBAAMDA1",60,0)
 ; Q $O(^SC(CLN,"ST",SD))
"RTN","MBAAMDA1",61,0)
 ; ;
"RTN","MBAAMDA1",62,0)
GETHOL(RETURN,SDATE) ; Get holiday. Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",63,0)
 S RETURN=0
"RTN","MBAAMDA1",64,0)
 ;S:$D(^HOLIDAY(SDATE)) RETURN(0)=$G(^HOLIDAY(SDATE,0))
"RTN","MBAAMDA1",65,0)
 N X,X1
"RTN","MBAAMDA1",66,0)
 S X=$$GET1^DIQ(40.5,SDATE,.01,"I")  ;ICR#: 10038 HOLIDAY FILE
"RTN","MBAAMDA1",67,0)
 S X1=$$GET1^DIQ(40.5,SDATE,2,"I")  ;ICR#: 10038 HOLIDAY FILE
"RTN","MBAAMDA1",68,0)
 I $G(X)'="" S RETURN(0)=X_"^"_X1
"RTN","MBAAMDA1",69,0)
 K X,X1
"RTN","MBAAMDA1",70,0)
 S RETURN=1
"RTN","MBAAMDA1",71,0)
 Q
"RTN","MBAAMDA1",72,0)
 ;
"RTN","MBAAMDA1",73,0)
 ;GETPATT(RETURN,SC,SD) ; Get date pattern Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",74,0)
GETPATT(RETURN,SC,SD) ; Get date pattern Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",75,0)
 S RETURN=0
"RTN","MBAAMDA1",76,0)
 ;T13 change to use FM reads
"RTN","MBAAMDA1",77,0)
 N X S IENS=$P(SD,".")_","_SC_",",X=$$GET1^DIQ(44.005,IENS,1),RETURN(0)=$G(X)
"RTN","MBAAMDA1",78,0)
 ;S:$D(^SC(SC,"ST",$P(SD,"."),1)) RETURN(0)=^SC(SC,"ST",$P(SD,"."),1)  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",79,0)
 ;N X S IENS=$P(SD,".")_","_SC_",",X=$$GET1^DIQ(44.005,IENS,"CAN"),RETURN(0)=$G(X)
"RTN","MBAAMDA1",80,0)
 ;T13 the line below is removed as this node is not defined in the DD.
"RTN","MBAAMDA1",81,0)
 ;S:$D(^SC(SC,"ST",$P(SD,"."),"CAN")) RETURN(1)=^SC(SC,"ST",$P(SD,"."),"CAN")  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",82,0)
 S RETURN=1
"RTN","MBAAMDA1",83,0)
 Q
"RTN","MBAAMDA1",84,0)
 ;
"RTN","MBAAMDA1",85,0)
GETSCAP(RETURN,SC,DFN,SD) ; Get clinic appointment Called by RPC MBAA APPOINTMENT MAKE, MBAA RPC: MBAA CANCEL APPOINTMENT, MBAA PATIENT PENDING APPT
"RTN","MBAAMDA1",86,0)
 N ZL,CO
"RTN","MBAAMDA1",87,0)
 I $D(^SC(SC,"S",SD))  D  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",88,0)
 . S ZL=0
"RTN","MBAAMDA1",89,0)
 . F  S ZL=$O(^SC(SC,"S",SD,1,ZL)) Q:'ZL  D  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",90,0)
 . . I '$D(^SC(SC,"S",SD,1,ZL,0)) Q  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",91,0)
 . . S IENS=$G(ZL)_","_$G(SD)_","_$G(SC)_",",FLDS=".01;1;2;3;4;7;8;10;310;30;9;688"
"RTN","MBAAMDA1",92,0)
 . . N LEN,XRAY,OTHER,WARD,CLERK,DTMADE,XRAYRST,APTCAN,ELIG,OB,ARRAY,ERR,CON1
"RTN","MBAAMDA1",93,0)
 . . N ARRAY,ERR D GETS^DIQ(44.003,IENS,FLDS,"IE","ARRAY","ERR")
"RTN","MBAAMDA1",94,0)
 . . I $G(ARRAY(44.003,IENS,.01,"I"))'=DFN Q
"RTN","MBAAMDA1",95,0)
 . . S LEN=$G(ARRAY(44.003,IENS,1,"I")),XRAY=$G(ARRAY(44.003,IENS,2,"I")),OTHER=$G(ARRAY(44.003,IENS,3,"I"))
"RTN","MBAAMDA1",96,0)
 . . S WARD=$G(ARRAY(44.003,IENS,4,"I")),CLERK=$G(ARRAY(44.003,IENS,7,"I")),DTMADE=$G(ARRAY(44.003,IENS,8,"I")),OB=$G(ARRAY(44.003,IENS,9,"I"))
"RTN","MBAAMDA1",97,0)
 . . S XRAYRST=$G(ARRAY(44.003,IENS,10,"I")),APTCAN=$G(ARRAY(44.003,IENS,310,"I")),ELIG=$G(ARRAY(44.003,IENS,30,"I")),CON1=$G(ARRAY(44.003,IENS,688,"I"))
"RTN","MBAAMDA1",98,0)
 . . ;N CON1 S CON1=$$GET1^DIQ(44,IENS,688)
"RTN","MBAAMDA1",99,0)
 . . S RETURN(0)=$G(DFN)_U_$G(LEN)_U_$G(XRAY)_U_$G(OTHER)_U_$G(WARD)_U_$G(CLERK)_U_$G(DTMADE)_U_$G(XRAYRST)_U_$G(APTCAN)_U_$G(ELIG)_U_$G(CON1)
"RTN","MBAAMDA1",100,0)
 . . S:$G(OB)'="" RETURN("OB")=$G(OB)
"RTN","MBAAMDA1",101,0)
 . . S RETURN=ZL
"RTN","MBAAMDA1",102,0)
 . Q
"RTN","MBAAMDA1",103,0)
 Q
"RTN","MBAAMDA1",104,0)
 ;
"RTN","MBAAMDA1",105,0)
GETCAPT(RETURN,SC,SD,IFN,FLAG) ; Get clinic appointment by IFN Called by RPC MBAA APPOINTMENT MAKE, MBAA RPC: MBAA CANCEL APPOINTMENT
"RTN","MBAAMDA1",106,0)
 N CAPT
"RTN","MBAAMDA1",107,0)
 S DIQ="CAPT(",DIC="^SC(SC,""S"",SD,1,",DIQ(0)=$G(FLAG)  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",108,0)
 S DA=IFN,DR=".01;1;3;7;8;9;30;309;302;303;304;306;688"
"RTN","MBAAMDA1",109,0)
 D EN^DIQ1
"RTN","MBAAMDA1",110,0)
 M RETURN=CAPT(44.003,IFN)
"RTN","MBAAMDA1",111,0)
 S RETURN(222)=SC
"RTN","MBAAMDA1",112,0)
 S RETURN(333)=IFN
"RTN","MBAAMDA1",113,0)
 Q
"RTN","MBAAMDA1",114,0)
 ;
"RTN","MBAAMDA1",115,0)
LOCKST(SC,SD) ; Lock availability node Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",116,0)
 L +^SC(SC,"ST",$P(SD,"."),1):5 Q:'$T 0  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",117,0)
 Q 1
"RTN","MBAAMDA1",118,0)
 ;
"RTN","MBAAMDA1",119,0)
UNLCKST(SC,SD) ; Lock availability node  Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",120,0)
 L -^SC(SC,"ST",$P(SD,"."),1)  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",121,0)
 Q
"RTN","MBAAMDA1",122,0)
 ;
"RTN","MBAAMDA1",123,0)
LOCKS(SC,SD) ; Lock clinic date node Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",124,0)
 L +^SC(SC,"S",$P(SD,"."),1):5 Q:'$T 0  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",125,0)
 Q 1
"RTN","MBAAMDA1",126,0)
 ;
"RTN","MBAAMDA1",127,0)
UNLCKS(SC,SD) ; Unlock clinic date node Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",128,0)
 L -^SC(SC,"S",$P(SD,"."),1)  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",129,0)
 Q
"RTN","MBAAMDA1",130,0)
 ;
"RTN","MBAAMDA1",131,0)
SETST(SC,SD,S) ; Set availability Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",132,0)
 ;S ^SC(SC,"ST",$P(SD,".",1),1)=S  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",133,0)
 ;T13 CHANGE
"RTN","MBAAMDA1",134,0)
 N ERR,FDA,IENS
"RTN","MBAAMDA1",135,0)
 S IENS=$P(SD,".")_","_SC_","
"RTN","MBAAMDA1",136,0)
 ;S IENS(2)=$P(SD,".")
"RTN","MBAAMDA1",137,0)
 ;S FDA(44.005,IENS,.01)=$P(SD,".")
"RTN","MBAAMDA1",138,0)
 S FDA(44.005,IENS,1)=$G(S)
"RTN","MBAAMDA1",139,0)
 D FILE^DIE("","FDA","ERR")
"RTN","MBAAMDA1",140,0)
 Q
"RTN","MBAAMDA1",141,0)
 ;
"RTN","MBAAMDA1",142,0)
 ;MAKE(SC,SD,DFN,LEN,SM,USR,OTHR,RQXRAY) ; Make clinic appointment Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",143,0)
MAKE(SC,SD,DFN,LEN,SM,USR,OTHR,RQXRAY)  ; Make clinic appointment Called by the RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",144,0)
 N ERR,FDA,IENS
"RTN","MBAAMDA1",145,0)
 S IENS="?+2,"_SC_","   ;WCJ;MBAA*1*7 added ? because it might already be there.  Otherwise false error is returned on occassion.
"RTN","MBAAMDA1",146,0)
 S IENS(2)=+SD
"RTN","MBAAMDA1",147,0)
 S FDA(44.001,IENS,.01)=+SD
"RTN","MBAAMDA1",148,0)
 D UPDATE^DIE("","FDA","IENS","ERR")
"RTN","MBAAMDA1",149,0)
 S SD=$G(IENS(2))
"RTN","MBAAMDA1",150,0)
 K FDA,IENS
"RTN","MBAAMDA1",151,0)
 S IENS="+1,"_+SD_","_SC_","
"RTN","MBAAMDA1",152,0)
 S FDA(44.003,IENS,.01)=DFN
"RTN","MBAAMDA1",153,0)
 S FDA(44.003,IENS,1)=LEN
"RTN","MBAAMDA1",154,0)
 S FDA(44.003,IENS,3)=$G(OTHR)
"RTN","MBAAMDA1",155,0)
 S FDA(44.003,IENS,7)=USR
"RTN","MBAAMDA1",156,0)
 S FDA(44.003,IENS,8)=$P($$NOW^XLFDT,".")  ;ICR#: 10103 XLFDT
"RTN","MBAAMDA1",157,0)
 S:$G(SM) FDA(44.003,IENS,9)="O"
"RTN","MBAAMDA1",158,0)
 ;T13 change
"RTN","MBAAMDA1",159,0)
 ;I $D(RQXRAY),RQXRAY>0 S ^SC("ARAD",SC,SD,DFN)=""  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",160,0)
 I $D(RQXRAY),RQXRAY>0 S FDA(44.003,IENS,10)="Y"  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",161,0)
 D UPDATE^DIE("","FDA","IENS","ERR")
"RTN","MBAAMDA1",162,0)
 Q
"RTN","MBAAMDA1",163,0)
 ;
"RTN","MBAAMDA1",164,0)
CANCEL(SC,SD,DFN,CIFN) ; Kill clinic appointment Called by RPC MBAA APPOINTMENT MAKE, MBAA RPC: MBAA CANCEL APPOINTMENT
"RTN","MBAAMDA1",165,0)
 ;S SDNODE=^SC(SC,"S",SD,1,CIFN,0)
"RTN","MBAAMDA1",166,0)
 N HSI,SB,SDDIF,SI,SL,SS,ST,STARTDAY,STR
"RTN","MBAAMDA1",167,0)
 S SC1=SC
"RTN","MBAAMDA1",168,0)
 S ^SC("ARAD",SC,SD,DFN)="N"  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",169,0)
 ;S TLNK=$P($G(^SC(SC,"S",SD,1,CIFN,"CONS")),U)  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",170,0)
 K ^SC(SC,"S",SD,1,CIFN)  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",171,0)
 K:$O(^SC(SC,"S",SD,0))'>0 ^SC(SC,"S",SD,0)  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",172,0)
 ;T13 CHANGE
"RTN","MBAAMDA1",173,0)
 ;K:TLNK'="" ^SC("AWAS1",TLNK),TLNK  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",174,0)
 Q:'$D(^SC(SC,"ST",SD\1,1))  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",175,0)
 ;T13 Change
"RTN","MBAAMDA1",176,0)
 N XL1,IENS
"RTN","MBAAMDA1",177,0)
 S IENS=SC_"," D GETS^DIQ(44,IENS,"1914;1917","I","XL1") S SL=$G(XL1(44,IENS,1917,"I")),X=$G(XL1(44,IENS,1914,"I"))
"RTN","MBAAMDA1",178,0)
 ;MBAA*1*5 - correct cancellation - calculation of X value
"RTN","MBAAMDA1",179,0)
 S SL=$$GET1^DIQ(44,SC,1917,"I"),STARTDAY=$S($L(X):X,1:8),SB=STARTDAY-1/100,X=SL,HSI=$S(X:X,1:4),SI=$S(X="":4,X<3:4,X:X,1:4),STR="#@!$* XXWVUTSRQPONMLKJIHGFEDCBA0123456789jklmnopqrstuvwxyz",SDDIF=$S(HSI<3:8/HSI,1:2) K Y  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",180,0)
 ;S SL=$$GET1^DIQ(44,SC,1917,"I"),STARTDAY=$S($L(X):X,1:8),SB=STARTDAY-1/100,X=$P(SL,U,6),HSI=$S(X:X,1:4),SI=$S(X="":4,X<3:4,X:X,1:4),STR="#@!$* XXWVUTSRQPONMLKJIHGFEDCBA0123456789jklmnopqrstuvwxyz",SDDIF=$S(HSI<3:8/HSI,1:2) K Y  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",181,0)
 ;S SL=^SC(SC,"SL"),X=$P(SL,U,3),STARTDAY=$S($L(X):X,1:8),SB=STARTDAY-1/100,X=$P(SL,U,6),HSI=$S(X:X,1:4),SI=$S(X="":4,X<3:4,X:X,1:4),STR="#@!$* XXWVUTSRQPONMLKJIHGFEDCBA0123456789jklmnopqrstuvwxyz",SDDIF=$S(HSI<3:8/HSI,1:2) K Y  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",182,0)
 N IENS
"RTN","MBAAMDA1",183,0)
 S:$G(CAPT("LENGTH")) SL=CAPT("LENGTH") ;MBAA*1*5 - include length of appointment in calculation
"RTN","MBAAMDA1",184,0)
 S IENS=$P(SD,".")_","_SC_",",S=$$GET1^DIQ(44.005,IENS,1),Y=SD#1-SB*100,ST=Y#1*SI\.6+(Y\1*SI),SS=SL*HSI/60
"RTN","MBAAMDA1",185,0)
 ;S S=^SC(SC,"ST",SD\1,1),Y=SD#1-SB*100,ST=Y#1*SI\.6+(Y\1*SI),SS=SL*HSI/60  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",186,0)
 I Y'<1 F I=ST+ST:SDDIF S Y=$E(STR,$F(STR,$E(S,I+1))) Q:Y=""  S S=$E(S,1,I)_Y_$E(S,I+2,999),SS=SS-1 Q:SS'>0
"RTN","MBAAMDA1",187,0)
 ;Code below changed to correct the naked global reference
"RTN","MBAAMDA1",188,0)
 ;S ^(1)=S
"RTN","MBAAMDA1",189,0)
 ;S ^SC(SC,"ST",SD\1,1)=S  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",190,0)
 ;T13 CHANGE
"RTN","MBAAMDA1",191,0)
 S SC=SC1 K SC1
"RTN","MBAAMDA1",192,0)
 D SETST(SC,SD,S)
"RTN","MBAAMDA1",193,0)
 Q
"RTN","MBAAMDA1",194,0)
 ;
"RTN","MBAAMDA1",195,0)
COVERB(SC,SD,IFN) ; Kill first overbook appointment Called by RPC MBAA APPOINTMENT MAKE, MBAA RPC: MBAA CANCEL APPOINTMENT
"RTN","MBAAMDA1",196,0)
 I $D(^SC(SC,"S",SD,1,IFN,"OB")) Q 0  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",197,0)
 N X,OIFN
"RTN","MBAAMDA1",198,0)
 S X=IFN,OIFN=0
"RTN","MBAAMDA1",199,0)
 F  S X=$O(^SC(SC,"S",SD,1,X)) Q:X=""!(OIFN>0)  D  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",200,0)
 . I $D(^SC(SC,"S",SD,1,X,"OB")) K ^SC(SC,"S",SD,1,X,"OB") S OIFN=X  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",201,0)
 Q OIFN
"RTN","MBAAMDA1",202,0)
 ;
"RTN","MBAAMDA1",203,0)
GETFSTA(SC) ; Get first available day. Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",204,0)
 N I
"RTN","MBAAMDA1",205,0)
 S I=0
"RTN","MBAAMDA1",206,0)
 Q $O(^SC(SC,"T",I))  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",207,0)
 ;
"RTN","MBAAMDA1",208,0)
GETDAYA(RETURN,SC,SD) ; Get all day appointments Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",209,0)
 N IND,I,D
"RTN","MBAAMDA1",210,0)
 S I=$P(SD,".",1)
"RTN","MBAAMDA1",211,0)
 F D=I-.01:0 S D=$O(^SC(SC,"S",D)) Q:$P(D,".",1)-I  D  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",212,0)
 . S %=0
"RTN","MBAAMDA1",213,0)
 . F  S %=$O(^SC(SC,"S",D,1,%)) Q:%'>0  D  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",214,0)
 . . Q:'$D(^SC(SC,"S",D,1,%,0))  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",215,0)
 . . ; next two lines changed to correct the naked global reference
"RTN","MBAAMDA1",216,0)
 . . ;S RETURN(%,"STATUS")=$P(^(0),U,9)
"RTN","MBAAMDA1",217,0)
 . . ;S RETURN(%,"OB")=$D(^("OB"))
"RTN","MBAAMDA1",218,0)
 . . ;T13 Change
"RTN","MBAAMDA1",219,0)
 . . S DIQ="CAPT(",DIC="^SC(SC,""S"",D,1,",DA=%,DR="310;9" D EN^DIQ1
"RTN","MBAAMDA1",220,0)
 . . S %=DA
"RTN","MBAAMDA1",221,0)
 . . S RETURN(%,"STATUS")=$G(CAPT(44.003,%,310))
"RTN","MBAAMDA1",222,0)
 . . S RETURN(%,"OB")=$G(CAPT(44.003,%,9))
"RTN","MBAAMDA1",223,0)
 . . K DIQ,DA,DR,DIC,CAPT
"RTN","MBAAMDA1",224,0)
 . . I $G(I)="" S I=$P(SD,".",1)
"RTN","MBAAMDA1",225,0)
 . . ;S RETURN(%,"STATUS")=$P(^SC(SC,"S",D,1,%,0),U,9)
"RTN","MBAAMDA1",226,0)
 . . ;S RETURN(%,"OB")=$D(^SC(SC,"S",D,1,%,"OB"))
"RTN","MBAAMDA1",227,0)
 Q
"RTN","MBAAMDA1",228,0)
 ;code below is not being used in the initial release of MBAA. It will be released at a later date in a future release of MBAA
"RTN","MBAAMDA1",229,0)
 ;LSTCAPTS(RETURN,SC,SDBEG,SDEND) ; 
"RTN","MBAAMDA1",230,0)
 ; N SDT,SDDA,CNT,APT,SDATA,CNSTLNK
"RTN","MBAAMDA1",231,0)
 ; S CNT=0 S:'$D(SDBEG) SDBEG=1 S:'$D(SDEND) SDEND=99999999
"RTN","MBAAMDA1",232,0)
 ; F SDT=SDBEG:0 S SDT=$O(^SC(SC,"S",SDT)) Q:'SDT!($P(SDT,".",1)>SDEND)  D
"RTN","MBAAMDA1",233,0)
 ; . F SDDA=0:0 S SDDA=$O(^SC(SC,"S",SDT,1,SDDA)) Q:'SDDA  D
"RTN","MBAAMDA1",234,0)
 ; . . S CNSTLNK=$P($G(^SC(SC,"S",SDT,1,SDDA,"CONS")),U)
"RTN","MBAAMDA1",235,0)
 ; . . Q:'$D(^SC(SC,"S",SDT,1,SDDA,0))
"RTN","MBAAMDA1",236,0)
 ; . . ; next line changed to correct the naked global reference
"RTN","MBAAMDA1",237,0)
 ; . . ;S APT=^(0)
"RTN","MBAAMDA1",238,0)
 ; . . S APT=$G(^SC(SC,"S",SDT,1,SDDA,0))
"RTN","MBAAMDA1",239,0)
 ; . . S CNT=CNT+1
"RTN","MBAAMDA1",240,0)
 ; . . S SDATA=^DPT(+APT,"S",SDT,0)
"RTN","MBAAMDA1",241,0)
 ; . . S RETURN(CNT,"CONS")=$G(CNSTLNK)
"RTN","MBAAMDA1",242,0)
 ; . . S RETURN(CNT,"SD")=SDT
"RTN","MBAAMDA1",243,0)
 ; . . S RETURN(CNT,"SC")=+SDATA
"RTN","MBAAMDA1",244,0)
 ; . . S RETURN(CNT,"DFN")=+APT
"RTN","MBAAMDA1",245,0)
 ; . . S RETURN(CNT,"SDDA")=SDDA
"RTN","MBAAMDA1",246,0)
 ; . . S RETURN(CNT,"SDATA")=SDATA
"RTN","MBAAMDA1",247,0)
 ; . . S RETURN(CNT,"CDATA")=APT
"RTN","MBAAMDA1",248,0)
 ; Q
"RTN","MBAAMDA1",249,0)
 ; ;
"RTN","MBAAMDA1",250,0)
 ;LSTPAPTS(RETURN,DFN,SDBEG,SDEND) ; Get patient appointments
"RTN","MBAAMDA1",251,0)
 ; N SDT,CNT,SDDA,SC,CN,CNPAT
"RTN","MBAAMDA1",252,0)
 ; S CNT=0 S:'$D(SDBEG) SDBEG=DT S:'$D(SDEND) SDEND=99999999
"RTN","MBAAMDA1",253,0)
 ; F SDT=SDBEG:0 S SDT=$O(^DPT(DFN,"S",SDT)) Q:'SDT!($P(SDT,".",1)>SDEND)  D
"RTN","MBAAMDA1",254,0)
 ; . Q:'$D(^(SDT,0))
"RTN","MBAAMDA1",255,0)
 ; . S CNT=CNT+1
"RTN","MBAAMDA1",256,0)
 ; . S SDATA=^DPT(+DFN,"S",SDT,0)
"RTN","MBAAMDA1",257,0)
 ; . S SC=+SDATA
"RTN","MBAAMDA1",258,0)
 ; . S RETURN(CNT,"CONS")=$G(CNSTLNK)
"RTN","MBAAMDA1",259,0)
 ; . S RETURN(CNT,"SD")=SDT
"RTN","MBAAMDA1",260,0)
 ; . S RETURN(CNT,"SC")=SC
"RTN","MBAAMDA1",261,0)
 ; . S RETURN(CNT,"DFN")=DFN
"RTN","MBAAMDA1",262,0)
 ; . S SDDA="",CN=0
"RTN","MBAAMDA1",263,0)
 ; . F  S CN=$O(^SC(SC,"S",SDT,1,CN)) Q:'+CN!(SDDA>0)  D
"RTN","MBAAMDA1",264,0)
 ; . . S CNPAT=$P($G(^SC(SC,"S",SDT,1,CN,0)),U)
"RTN","MBAAMDA1",265,0)
 ; . . Q:CNPAT'=DFN
"RTN","MBAAMDA1",266,0)
 ; . . S SDDA=CN
"RTN","MBAAMDA1",267,0)
 ; . S RETURN(CNT,"SDDA")=SDDA
"RTN","MBAAMDA1",268,0)
 ; . S RETURN(CNT,"SDATA")=SDATA
"RTN","MBAAMDA1",269,0)
 ; . S:SDDA>0 RETURN(CNT,"CDATA")=$G(^SC(SC,"S",SDT,1,SDDA,0))
"RTN","MBAAMDA1",270,0)
 ; Q
"RTN","MBAAMDA1",271,0)
 ;
"RTN","MBAAMDA1",272,0)
GETDST(SC,SD) ; Get day slot  Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",273,0)
 ;T13 change to use a FM call to get the data from the file
"RTN","MBAAMDA1",274,0)
 N X S IENS=$P(SD,".")_","_SC_",",X=$$GET1^DIQ(44.005,IENS,1)
"RTN","MBAAMDA1",275,0)
 Q X    ;ICR#: 6044 SC(
"RTN","MBAAMDA1",276,0)
 ;Q $G(^SC(SC,"ST",SD,1))  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",277,0)
 ;
"RTN","MBAAMDA1",278,0)
GETDPATT(RETURN,SC,SD,DAY) ; Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",279,0)
 S RETURN("IEN")=$O(^SC(SC,"T"_DAY,SD))  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",280,0)
 S:RETURN("IEN")'="" RETURN("PAT")=$G(^SC(SC,"T"_DAY,RETURN("IEN"),1))  ;ICR#: 6044 SC(
"RTN","MBAAMDA1",281,0)
 Q
"RTN","MBAAMDA1",282,0)
 ;code below is not being used in the initial release of MBAA. It will be released at a later date in a future release of MBAA
"RTN","MBAAMDA1",283,0)
 ;UPDPATT(DATA,SC,SD) ; Update day pattern
"RTN","MBAAMDA1",284,0)
 ; N IENS,I
"RTN","MBAAMDA1",285,0)
 ; S IENS=SD_","_SC_","
"RTN","MBAAMDA1",286,0)
 ; N FDA
"RTN","MBAAMDA1",287,0)
 ; F I=0:0 S I=$O(DATA(I)) Q:I=""  D
"RTN","MBAAMDA1",288,0)
 ; . S FDA(44.005,IENS,I)=DATA(I)
"RTN","MBAAMDA1",289,0)
 ; N ERR
"RTN","MBAAMDA1",290,0)
 ; D UPDATE^DIE("","FDA",,"ERR")
"RTN","MBAAMDA1",291,0)
 ; Q
"RTN","MBAAMDA1",292,0)
 ;
"RTN","MBAAMDA1",293,0)
ADDPATT(DATA,SC,SD) ; Add day pattern Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",294,0)
 N IENS,I,FDA,ERR
"RTN","MBAAMDA1",295,0)
 S IENS="+1,"_SC_","
"RTN","MBAAMDA1",296,0)
 S IENS(1)=SD
"RTN","MBAAMDA1",297,0)
 F I=0:0 S I=$O(DATA(I)) Q:I=""  D
"RTN","MBAAMDA1",298,0)
 . S FDA(44.005,IENS,I)=DATA(I)
"RTN","MBAAMDA1",299,0)
 D UPDATE^DIE("","FDA","IENS","ERR")
"RTN","MBAAMDA1",300,0)
 Q
"RTN","MBAAMDA1",301,0)
 ;
"RTN","MBAAMDA1",302,0)
LSTAENC(RETURN,SEARCH,START,NUMBER) ; Returns active encounters. MBAA RPC: MBAA APPOINTMENT MAKE
"RTN","MBAAMDA1",303,0)
 N FILE,FIELDS,RET,SCR
"RTN","MBAAMDA1",304,0)
 S FILE="409.68",FIELDS="@;.01I;.04I;.06"
"RTN","MBAAMDA1",305,0)
 S:$D(START)=0 START="" S:$D(SEARCH)=0 SEARCH=""
"RTN","MBAAMDA1",306,0)
 S SCR="I $P(^(0),""^"",2)="_SEARCH_"&($D(^SCE(""ADFN"","_SEARCH_",$P(^(0),""^"",1))))"
"RTN","MBAAMDA1",307,0)
 K SEARCH
"RTN","MBAAMDA1",308,0)
 D LIST^DIC(FILE,"",.FIELDS,"",$G(NUMBER),.START,.SEARCH,"B",.SCR,"","RETURN","ERR")
"RTN","MBAAMDA1",309,0)
 Q
"RTN","MBAAMDA2")
0^6^B19510830^B19055571
"RTN","MBAAMDA2",1,0)
MBAAMDA2 ;OIT-PD/VSL - APPOINTMENT API ;02/10/2016
"RTN","MBAAMDA2",2,0)
 ;;1.0;Scheduling Calendar View;**1,5,7**;Feb 13, 2015;Build 16
"RTN","MBAAMDA2",3,0)
 ;
"RTN","MBAAMDA2",4,0)
 ;Associated ICRs
"RTN","MBAAMDA2",5,0)
 ;  ICR#
"RTN","MBAAMDA2",6,0)
 ;  6053 DPT
"RTN","MBAAMDA2",7,0)
 ;  6044 SC(
"RTN","MBAAMDA2",8,0)
 ;
"RTN","MBAAMDA2",9,0)
 ;code below is not being used in the initial release of MBAA. It will be released at a later date in a future release of MBAA
"RTN","MBAAMDA2",10,0)
 ;FRSTAVBL(RETURN,SC) ; Get first available date
"RTN","MBAAMDA2",11,0)
 ; S RETURN=$O(^SC(+SC,"T",0))
"RTN","MBAAMDA2",12,0)
 ; S RETURN=$O(^(0))
"RTN","MBAAMDA2",13,0)
 ; Q
"RTN","MBAAMDA2",14,0)
 ; ;
"RTN","MBAAMDA2",15,0)
SLOTS(RETURN,SC,SD) ; Get available slots MBAA RPC: MBAA GET CLINIC AVAILABILITY
"RTN","MBAAMDA2",16,0)
 ; RETURN - RETURN array passed in by reference
"RTN","MBAAMDA2",17,0)
 ; SC - scheduling clinic IEN of File #44
"RTN","MBAAMDA2",18,0)
 ; SD - starting date for slots - use DT if not passed in
"RTN","MBAAMDA2",19,0)
 ;
"RTN","MBAAMDA2",20,0)
 ;WCJ;MBAA*1*7; Start with either a date passed in or today.
"RTN","MBAAMDA2",21,0)
 I '$G(SD) S SD=DT
"RTN","MBAAMDA2",22,0)
 S SD=$$FMADD^XLFDT($P(SD,"."),-1,0,0,0)
"RTN","MBAAMDA2",23,0)
 ;
"RTN","MBAAMDA2",24,0)
 F  S SD=$O(^SC(SC,"ST",SD)) Q:SD'>0  D    ;ICR#: 6044 SC(
"RTN","MBAAMDA2",25,0)
 .N IENS,ARRAY,ERR
"RTN","MBAAMDA2",26,0)
 .S IENS=$G(SD)_","_SC_","
"RTN","MBAAMDA2",27,0)
 .D GETS^DIQ(44.005,IENS,".01;1","I","ARRAY","ERR")
"RTN","MBAAMDA2",28,0)
 .S RETURN(SD,0)=$G(ARRAY(44.005,IENS,.01,"I"))
"RTN","MBAAMDA2",29,0)
 .S RETURN(SD,1)=$G(ARRAY(44.005,IENS,1,"I"))
"RTN","MBAAMDA2",30,0)
 .I $E(RETURN(SD,1),6,11)="      " S $E(RETURN(SD,1),6,11)="  " Q  ;MBAA*1*5 - 10 MINS SLOTS
"RTN","MBAAMDA2",31,0)
 .I $E(RETURN(SD,1),6)'=" " S RETURN(SD,1)=$E(RETURN(SD,1),1,5)_"  "_$E(RETURN(SD,1),6,99) ;MBAA*1*5 20 MINS SLOTS
"RTN","MBAAMDA2",32,0)
 ;
"RTN","MBAAMDA2",33,0)
 ;K SD
"RTN","MBAAMDA2",34,0)
 ;M RETURN=^SC(+SC,"ST")  ;ICR#: 6044 SC(
"RTN","MBAAMDA2",35,0)
 Q
"RTN","MBAAMDA2",36,0)
 ;code below is not being used in the initial release of MBAA. It will be released at a later date in a future release of MBAA
"RTN","MBAAMDA2",37,0)
 ;SCEXST(RETURN,CSC) ; Returns Outpatient Classification Stop Code Exception status
"RTN","MBAAMDA2",38,0)
 ; N FILE,STOPN,IENACT,FLDS,FS
"RTN","MBAAMDA2",39,0)
 ; S STOPN=$$GET1^DIQ(40.7,+CSC_",",1)
"RTN","MBAAMDA2",40,0)
 ; S IENACT=""
"RTN","MBAAMDA2",41,0)
 ; S IENACT=$O(^SD(409.45,"B",STOPN,IENACT))
"RTN","MBAAMDA2",42,0)
 ; S FILE="409.45"
"RTN","MBAAMDA2",43,0)
 ; S FLDS("*")=""
"RTN","MBAAMDA2",44,0)
 ; S FS("75")="",FS("75","F")="409.4575",FS("75","N")="EFFECTIVE DATE"
"RTN","MBAAMDA2",45,0)
 ; S RETURN=0
"RTN","MBAAMDA2",46,0)
 ; I $D(IENACT) D
"RTN","MBAAMDA2",47,0)
 ; . D GETREC^MBAAMDAL(.RETURN,IENACT,FILE,.FLDS,.FS,1,1,1) S RETURN=1
"RTN","MBAAMDA2",48,0)
 ; Q
"RTN","MBAAMDA2",49,0)
 ; ;
"RTN","MBAAMDA2",50,0)
LSTAPPT(RETURN,SEARCH,START,NUMBER) ; Lists appointment types MBAA RPC: MBAA APPOINTMENT LIST BY NAME
"RTN","MBAAMDA2",51,0)
 N FILE,FIELDS,RET
"RTN","MBAAMDA2",52,0)
 S FILE="409.1",FIELDS="@;.01"
"RTN","MBAAMDA2",53,0)
 S:$D(START)=0 START="" S:$D(SEARCH)=0 SEARCH=""
"RTN","MBAAMDA2",54,0)
 D LIST^DIC(FILE,"",FIELDS,"",$G(NUMBER),.START,SEARCH,"B","","","RETURN")
"RTN","MBAAMDA2",55,0)
 Q
"RTN","MBAAMDA2",56,0)
 ;code below is not being used in the initial release of MBAA. It will be released at a later date in a future release of MBAA
"RTN","MBAAMDA2",57,0)
 ;GETAPPT(RETURN,TYPE,INT,EXT,REZ) ; Get Appointment Type
"RTN","MBAAMDA2",58,0)
 ; N FILE,FLDS,SF
"RTN","MBAAMDA2",59,0)
 ; S FILE=409.1,FLDS("*")=""
"RTN","MBAAMDA2",60,0)
 ; D GETREC^MBAAMDAL(.RETURN,TYPE,FILE,.FLDS,.SF,$G(INT),$G(EXT),$G(REZ))
"RTN","MBAAMDA2",61,0)
 ; Q
"RTN","MBAAMDA2",62,0)
 ;
"RTN","MBAAMDA2",63,0)
 ;GETELIG(RETURN,ELIG,INT,EXT,REZ) ; Get eligibility code
"RTN","MBAAMDA2",64,0)
 ;N FILE,FLDS
"RTN","MBAAMDA2",65,0)
 ;S FILE=8,FLDS("*")=""
"RTN","MBAAMDA2",66,0)
 ;D GETREC^MBAAMDAL(.RETURN,ELIG,FILE,.FLDS,,$G(INT),$G(EXT),$G(REZ))
"RTN","MBAAMDA2",67,0)
 ;Q
"RTN","MBAAMDA2",68,0)
 ; ;
"RTN","MBAAMDA2",69,0)
 ;HASPEND(RETURN,PAT,DT) ; Return 1 if patient has pending appointment
"RTN","MBAAMDA2",70,0)
 ; S RETURN=0
"RTN","MBAAMDA2",71,0)
 ; I '$D(^DPT(+$G(PAT),0)) D ERRX^MBAAAPIE(.RETURN,"PATNFND") Q RETURN
"RTN","MBAAMDA2",72,0)
 ; S:$O(^DPT(PAT,"S",DT))>DT RETURN=1
"RTN","MBAAMDA2",73,0)
 ; Q RETURN
"RTN","MBAAMDA2",74,0)
 ; ;
"RTN","MBAAMDA2",75,0)
 ;GETPEND(RETURN,PAT,DT) ; Get pending appointments
"RTN","MBAAMDA2",76,0)
 ; N Y,AP
"RTN","MBAAMDA2",77,0)
 ; F Y=DT:0 S Y=$O(^DPT(PAT,"S",Y)) Q:Y'>0  D
"RTN","MBAAMDA2",78,0)
 ; . S AP=^(Y,0)
"RTN","MBAAMDA2",79,0)
 ; . I "I"[$P(AP,U,2) D
"RTN","MBAAMDA2",80,0)
 ; . . S RETURN(Y,.01)=$P(AP,U,1)
"RTN","MBAAMDA2",81,0)
 ; . . S RETURN(Y,13)=$P(AP,U,11)
"RTN","MBAAMDA2",82,0)
 ; . . S RETURN(Y,9.5)=$P(AP,U,16)
"RTN","MBAAMDA2",83,0)
 ; . . S RETURN(Y,2)=$P(AP,U,3)
"RTN","MBAAMDA2",84,0)
 ; . . S RETURN(Y,3)=$P(AP,U,4)
"RTN","MBAAMDA2",85,0)
 ; . . S RETURN(Y,4)=$P(AP,U,5)
"RTN","MBAAMDA2",86,0)
 ; Q
"RTN","MBAAMDA2",87,0)
 ; ;
"RTN","MBAAMDA2",88,0)
APTYNAME(TYPE) ; Get appointment type name MBAA RPC: MBAA PATIENT PENDING APPT
"RTN","MBAAMDA2",89,0)
 Q $$GET1^DIQ(409.1,TYPE_",",.01)
"RTN","MBAAMDA2",90,0)
 ;
"RTN","MBAAMDA2",91,0)
GETAPTS(RETURN,DFN,SD) ; Get patient appointments Called by RPC MBAA APPOINTMENT MAKE, MBAA RPC: MBAA CANCEL APPOINTMENT
"RTN","MBAAMDA2",92,0)
 ;INPUT
"RTN","MBAAMDA2",93,0)
 ; RETURN - by reference for results being RETURNed
"RTN","MBAAMDA2",94,0)
 ; DFN - IEN to PATIENT (#2) file
"RTN","MBAAMDA2",95,0)
 ; SD - FileMan Date time if you want information on a specific appointment
"RTN","MBAAMDA2",96,0)
 ;
"RTN","MBAAMDA2",97,0)
 N FILE,SFILES,TMPDT
"RTN","MBAAMDA2",98,0)
 S FILE=2
"RTN","MBAAMDA2",99,0)
 S SFILES("1900")="",SFILES("1900","N")="APT",SFILES("1900","F")="2.98"
"RTN","MBAAMDA2",100,0)
 D GETREC^MBAAMDAL(.RETURN,DFN,FILE,,.SFILES,1,1,1,$G(SD))
"RTN","MBAAMDA2",101,0)
 Q
"RTN","MBAAMDA2",102,0)
 ;
"RTN","MBAAMDA2",103,0)
 ; Placed Quit above
"RTN","MBAAMDA2",104,0)
 ; it would only get here if called from future functionality SCHED^MBAAAPI1
"RTN","MBAAMDA2",105,0)
 ; replaced code altering DT to use TMPDT - otherwise a violation of SAC
"RTN","MBAAMDA2",106,0)
 S TMPDT=$S(SD(0)=1:$P(SD,"."),SD(0)=0:$O(APTS("APT","")))
"RTN","MBAAMDA2",107,0)
 F  S TMPDT=$O(APTS("APT",TMPDT)) Q:TMPDT=""  D
"RTN","MBAAMDA2",108,0)
 . M RETURN("APT",TMPDT)=APTS("APT",TMPDT)
"RTN","MBAAMDA2",109,0)
 Q
"RTN","MBAAMDA2",110,0)
 ;
"RTN","MBAAMDA2",111,0)
GETDAPTS(RETURN,DFN,SD) ; Get all appointments in the day Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA2",112,0)
 N NOD
"RTN","MBAAMDA2",113,0)
 S RETURN=0
"RTN","MBAAMDA2",114,0)
 S IND=$P(SD,".")
"RTN","MBAAMDA2",115,0)
 F  S IND=$O(^DPT(DFN,"S",IND)) Q:IND=""!($P(IND,".")>$P(SD,"."))  D  ;ICR#: 6053 DPT
"RTN","MBAAMDA2",116,0)
 . ;T13 Change to use FM to get these fields
"RTN","MBAAMDA2",117,0)
 . N ARRAY S IENS=$G(SD)_","_$G(DFN)_"," D GETS^DIQ(2.98,IENS,".01;3","I","ARRAY")
"RTN","MBAAMDA2",118,0)
 . S RETURN(IND,1)=$G(ARRAY(2.98,IENS,.01,"I"))
"RTN","MBAAMDA2",119,0)
 . S RETURN(IND,2)=$G(ARRAY(2.98,IENS,3,"I"))
"RTN","MBAAMDA2",120,0)
 S RETURN=1
"RTN","MBAAMDA2",121,0)
 Q
"RTN","MBAAMDA2",122,0)
 ;
"RTN","MBAAMDA2",123,0)
LSTCRSNS(RETURN,SEARCH,START,NUMBER) ; MBAA RPC: MBAA LIST CANCELLATION REASONS
"RTN","MBAAMDA2",124,0)
 N FILE,FIELDS,RET,SCR,TYP
"RTN","MBAAMDA2",125,0)
 S FILE="409.2",FIELDS="@;.01"
"RTN","MBAAMDA2",126,0)
 S:$D(START)=0 START="" S:$D(SEARCH)=0 SEARCH=""
"RTN","MBAAMDA2",127,0)
 ;T16 Change to return only cancel reasons that a patient can select
"RTN","MBAAMDA2",128,0)
 ;I $D(RETURN("TYPE")) S TYP=RETURN("TYPE"),SCR="I $P(^(0),U,2)[""PB""&'$P(^(0),U,4),(TYP_""B""[$P(^(0),U,2))"
"RTN","MBAAMDA2",129,0)
 I $D(RETURN("TYPE")) S TYP=RETURN("TYPE")
"RTN","MBAAMDA2",130,0)
 S SCR="I ""BP""[$P(^(0),U,2)"
"RTN","MBAAMDA2",131,0)
 K RETURN
"RTN","MBAAMDA2",132,0)
 D LIST^DIC(FILE,"",FIELDS,"",$G(NUMBER),.START,SEARCH,"B",.SCR,"","RETURN","ERR")
"RTN","MBAAMDA2",133,0)
 Q
"RTN","MBAAMDA2",134,0)
 ;
"RTN","MBAAMDA2",135,0)
LSTCSTA1(RETURN,SEARCH,START,NUMBER) ; Returns the list of states that allow cancellation. MBAA RPC: MBAA CANCEL APPOINTMENT
"RTN","MBAAMDA2",136,0)
 N FILE,FIELDS,RET,SCR
"RTN","MBAAMDA2",137,0)
 S FILE="409.63",FIELDS="@;.01"
"RTN","MBAAMDA2",138,0)
 S:$D(START)=0 START="" S:$D(SEARCH)=0 SEARCH=""
"RTN","MBAAMDA2",139,0)
 S START(1)=1
"RTN","MBAAMDA2",140,0)
 S START(2)=0
"RTN","MBAAMDA2",141,0)
 D LIST^DIC(FILE,"",FIELDS,"",$G(NUMBER),.START,SEARCH,"ACAN",.SCR,"","RETURN","ERR")
"RTN","MBAAMDA2",142,0)
 Q
"RTN","MBAAMDA2",143,0)
 ;
"RTN","MBAAMDA2",144,0)
LSTCIST1(RETURN,SEARCH,START,NUMBER) ; Returns the list of states that allow check in. MBAA RPC: MBAA APPOINTMENT MAKE
"RTN","MBAAMDA2",145,0)
 N FILE,FIELDS,RET,SCR
"RTN","MBAAMDA2",146,0)
 S FILE="409.63",FIELDS="@;.01"
"RTN","MBAAMDA2",147,0)
 S:$D(START)=0 START="" S:$D(SEARCH)=0 SEARCH=""
"RTN","MBAAMDA2",148,0)
 S START(1)=1
"RTN","MBAAMDA2",149,0)
 S START(2)=0
"RTN","MBAAMDA2",150,0)
 D LIST^DIC(FILE,"",FIELDS,"",$G(NUMBER),.START,SEARCH,"ACI",.SCR,"","RETURN","ERR")
"RTN","MBAAMDA2",151,0)
 Q
"RTN","MBAAMDA2",152,0)
 ;code below is not being used in the initial release of MBAA. It will be released at a later date in a future release of MBAA
"RTN","MBAAMDA2",153,0)
 ;LSTCOST1(RETURN,SEARCH,START,NUMBER) ; Returns the list of states that allow check in.
"RTN","MBAAMDA2",154,0)
 ; N FILE,FIELDS,RET,SCR
"RTN","MBAAMDA2",155,0)
 ; S FILE="409.63",FIELDS="@;.01"
"RTN","MBAAMDA2",156,0)
 ; S:$D(START)=0 START="" S:$D(SEARCH)=0 SEARCH=""
"RTN","MBAAMDA2",157,0)
 ; S START(1)=1
"RTN","MBAAMDA2",158,0)
 ; S START(2)=0
"RTN","MBAAMDA2",159,0)
 ; D LIST^DIC(FILE,"",FIELDS,"",$G(NUMBER),.START,SEARCH,"ACO",.SCR,"","RETURN","ERR")
"RTN","MBAAMDA2",160,0)
 ; Q
"RTN","MBAAMDA2",161,0)
 ;
"RTN","MBAAMDA2",162,0)
 ;LSTNSTA1(RETURN,SEARCH,START,NUMBER) ; Returns the list of states that allow no-show. 
"RTN","MBAAMDA2",163,0)
 ;N FILE,FIELDS,RET,SCR
"RTN","MBAAMDA2",164,0)
 ;S FILE="409.63",FIELDS="@;.01"
"RTN","MBAAMDA2",165,0)
 ;S:$D(START)=0 START="" S:$D(SEARCH)=0 SEARCH=""
"RTN","MBAAMDA2",166,0)
 ;S START(1)=1
"RTN","MBAAMDA2",167,0)
 ;S START(2)=0
"RTN","MBAAMDA2",168,0)
 ;D LIST^DIC(FILE,"",FIELDS,"",$G(NUMBER),.START,SEARCH,"ANS",,"","RETURN","ERR")
"RTN","MBAAMDA2",169,0)
 ;Q
"RTN","MBAAMDA2",170,0)
 ;
"RTN","MBAAMDA2",171,0)
GETAPT0(DFN,SD) ; Get appointment 0 node MBAA RPC: MBAA CANCEL APPOINTMENT
"RTN","MBAAMDA2",172,0)
 Q $G(^DPT(DFN,"S",SD,0))  ;ICR#: 6053 DPT
"RTN","MBAAMDA2",173,0)
 ;
"RTN","MBAAMDA2",174,0)
GETPAPT(RETURN,DFN,SD) ; Get patient appointment Called by RPC MBAA APPOINTMENT MAKE
"RTN","MBAAMDA2",175,0)
 ; MBAA*1*7;WCJ;Seems like it would more efficient to string them all together and make one GETS^DIQ call, just saying
"RTN","MBAAMDA2",176,0)
 N IND
"RTN","MBAAMDA2",177,0)
 F IND=0:0 S IND=$O(RETURN(IND)) Q:IND=""  D
"RTN","MBAAMDA2",178,0)
 . S RETURN(IND)=$$GET1^DIQ(2.98,SD_","_DFN_",",IND,"I")
"RTN","MBAAMDA2",179,0)
 S RETURN=1
"RTN","MBAAMDA2",180,0)
 Q
"RTN","MBAAMDA2",181,0)
 ;
"RTN","MBAAMDAL")
0^7^B14206968^B8935806
"RTN","MBAAMDAL",1,0)
MBAAMDAL ;OIT-PD/VSL - FILE ACCESS DAL ;02/10/2016
"RTN","MBAAMDAL",2,0)
 ;;1.0;Scheduling Calendar View;**1,7**;Feb 13, 2015;Build 16
"RTN","MBAAMDAL",3,0)
 ;
"RTN","MBAAMDAL",4,0)
GETREC(RETURN,IFN,FILE,FLDS,SFILES,INT,EXT,REZ,SD) ;
"RTN","MBAAMDAL",5,0)
 ; Input Variables
"RTN","MBAAMDAL",6,0)
 ; RETURN - RETURN results passed by reference
"RTN","MBAAMDAL",7,0)
 ; IFN - Internal Entry Number to the Files passed in (File 2 or File 44)
"RTN","MBAAMDAL",8,0)
 ; FILE - File #
"RTN","MBAAMDAL",9,0)
 ; FLDS = Array of FLDS
"RTN","MBAAMDAL",10,0)
 ; SFILES - Array of Sub-files
"RTN","MBAAMDAL",11,0)
 ; INT - Internal values returned
"RTN","MBAAMDAL",12,0)
 ; EXT - External values returned
"RTN","MBAAMDAL",13,0)
 ; REZ - Resolve field names instead of those peck numbers
"RTN","MBAAMDAL",14,0)
 ; SD - Date.Time if you only want one appointment in particular
"RTN","MBAAMDAL",15,0)
 ;      Date if you want all appointment on a give date
"RTN","MBAAMDAL",16,0)
 ;      or nothing if you want all appointments from today forward
"RTN","MBAAMDAL",17,0)
 ;
"RTN","MBAAMDAL",18,0)
 ; Get one record and specified subfiles from a file Called by RPC MBAA APPOINTMENT MAKE, MBAA RPC: MBAA CANCEL APPOINTMENT, MBAA PATIENT PENDING APPT
"RTN","MBAAMDAL",19,0)
 N STRF,FLD,FLAG,C,SFILE,IFLD,REC,SFLDN,SKIPSF
"RTN","MBAAMDAL",20,0)
 S STRF=""
"RTN","MBAAMDAL",21,0)
 S IFLD=""
"RTN","MBAAMDAL",22,0)
 F  S IFLD=$O(FLDS(IFLD)) Q:IFLD=""  S STRF=STRF_$S(STRF="":"",1:";")_IFLD
"RTN","MBAAMDAL",23,0)
 S SFILE=""
"RTN","MBAAMDAL",24,0)
 ;
"RTN","MBAAMDAL",25,0)
 ; want to skip subfile 2.98 so it can be done differently.  no need to pull in all appointments for a patient since the beginning of time.
"RTN","MBAAMDAL",26,0)
 F  S SFILE=$O(SFILES(SFILE)) Q:SFILE=""  I $G(SFILES(SFILE,"F"))'=2.98 S STRF=STRF_$S(STRF="":"",1:";")_SFILE_"*"
"RTN","MBAAMDAL",27,0)
 ;
"RTN","MBAAMDAL",28,0)
 S FLD="",FLAG=""
"RTN","MBAAMDAL",29,0)
 S:$G(INT) FLAG=FLAG_"I" ;Returns Internal values
"RTN","MBAAMDAL",30,0)
 S:$G(EXT) FLAG=FLAG_"E" ;Returns External values
"RTN","MBAAMDAL",31,0)
 S:$G(REZ) FLAG=FLAG_"R" ;Resolves field numbers to field names
"RTN","MBAAMDAL",32,0)
 ;
"RTN","MBAAMDAL",33,0)
 D GETS^DIQ(FILE,IFN,STRF,FLAG,"REC")
"RTN","MBAAMDAL",34,0)
 ;
"RTN","MBAAMDAL",35,0)
 I $G(SFILES(1900,"F"))=2.98 D GETRECA  ;  this one we'll treat differently cause it can be huge and want to use a screen
"RTN","MBAAMDAL",36,0)
 ;
"RTN","MBAAMDAL",37,0)
 F  S FLD=$O(REC(FILE,""_IFN_",",FLD)) Q:FLD=""  D
"RTN","MBAAMDAL",38,0)
 . S:FLAG=""!(FLAG="R") RETURN(FLD)=REC(FILE,""_IFN_",",FLD)
"RTN","MBAAMDAL",39,0)
 . S:FLAG["I" RETURN(FLD)=REC(FILE,""_IFN_",",FLD,"I")
"RTN","MBAAMDAL",40,0)
 . S:FLAG["E" RETURN(FLD)=$S($L($G(RETURN(FLD)))>0:RETURN(FLD)_U,1:"")_REC(FILE,""_IFN_",",FLD,"E")
"RTN","MBAAMDAL",41,0)
 ;
"RTN","MBAAMDAL",42,0)
 S SFILE=""
"RTN","MBAAMDAL",43,0)
 F  S SFILE=$O(SFILES(SFILE)) Q:SFILE=""  D
"RTN","MBAAMDAL",44,0)
 . S SFLDN=$S(FLAG["R":SFILES(SFILE,"N"),1:SFILE)
"RTN","MBAAMDAL",45,0)
 . D GETSREC(.RETURN,.REC,SFILES(SFILE,"F"),SFLDN,FLAG)
"RTN","MBAAMDAL",46,0)
 K FLAG,FILE,STRF
"RTN","MBAAMDAL",47,0)
 Q
"RTN","MBAAMDAL",48,0)
 ;
"RTN","MBAAMDAL",49,0)
GETSREC(RETURN,REC,SFILE,SFLD,FLAG) ; Get record subfile data Called by RPC MBAA APPOINTMENT MAKE, MBAA RPC: MBAA CANCEL APPOINTMENT, MBAA PATIENT PENDING APPT
"RTN","MBAAMDAL",50,0)
 N IDX,ID S FLD="",IDX=""
"RTN","MBAAMDAL",51,0)
 F  S IDX=$O(REC(SFILE,IDX)) Q:IDX=""  D
"RTN","MBAAMDAL",52,0)
 . F  S FLD=$O(REC(SFILE,IDX,FLD)) Q:FLD=""  D
"RTN","MBAAMDAL",53,0)
 . . S ID=$P(IDX,",",1)
"RTN","MBAAMDAL",54,0)
 . . S:FLAG=""!(FLAG="R") RETURN(SFLD,ID,FLD)=REC(SFILE,IDX,FLD)
"RTN","MBAAMDAL",55,0)
 . . S:FLAG["I" RETURN(SFLD,ID,FLD)=REC(SFILE,IDX,FLD,"I")
"RTN","MBAAMDAL",56,0)
 . . S:FLAG["E" RETURN(SFLD,ID,FLD)=$S($L($G(RETURN(SFLD,ID,FLD)))>0:RETURN(SFLD,ID,FLD)_U,1:"")_REC(SFILE,IDX,FLD,"E")
"RTN","MBAAMDAL",57,0)
 . . N SI S SI=0
"RTN","MBAAMDAL",58,0)
 . . F  S SI=$O(REC(SFILE,IDX,FLD,SI)) Q:SI=""!(SI="I")!(SI="E")  D
"RTN","MBAAMDAL",59,0)
 . . . S RETURN(SFLD,ID,FLD,SI)=REC(SFILE,IDX,FLD,SI),RETURN(SFLD,ID,FLD)=""
"RTN","MBAAMDAL",60,0)
 Q
"RTN","MBAAMDAL",61,0)
 ;code below is not being used in the initial release of MBAA. It will be released at a later date in a future release of MBAA
"RTN","MBAAMDAL",62,0)
 ;LSTSCOD(FILE,FIELD,LIST) ;List codes in SET OF CODE fields
"RTN","MBAAMDAL",63,0)
 ; ;FILE = file number
"RTN","MBAAMDAL",64,0)
 ; ;FIELD = field number
"RTN","MBAAMDAL",65,0)
 ; ;LIST = output array:
"RTN","MBAAMDAL",66,0)
 ; ;   LIST(#)=code^display_name
"RTN","MBAAMDAL",67,0)
 ; N SET,NODE,CODE,NAME,I,COUNT
"RTN","MBAAMDAL",68,0)
 ; S SET=$$GET1^DID(FILE,FIELD,,"POINTER")
"RTN","MBAAMDAL",69,0)
 ; S COUNT=1
"RTN","MBAAMDAL",70,0)
 ; F I=1:1:$L(SET,";") D
"RTN","MBAAMDAL",71,0)
 ; . S NODE=$P(SET,";",I)
"RTN","MBAAMDAL",72,0)
 ; . S CODE=$P(NODE,":")
"RTN","MBAAMDAL",73,0)
 ; . Q:CODE=""
"RTN","MBAAMDAL",74,0)
 ; . S NAME=$P(NODE,":",2)
"RTN","MBAAMDAL",75,0)
 ; . S LIST(COUNT)=CODE_"^"_NAME
"RTN","MBAAMDAL",76,0)
 ; . S COUNT=COUNT+1
"RTN","MBAAMDAL",77,0)
 ; S LIST(0)=COUNT-1
"RTN","MBAAMDAL",78,0)
 ; Q
"RTN","MBAAMDAL",79,0)
 ;
"RTN","MBAAMDAL",80,0)
GETRECA ;MBAA*1*7;will use SCREEN to get only the data that is needed from sub-file 2.98
"RTN","MBAAMDAL",81,0)
 ; The orignal code pulled every appointment the patient ever had by doing one inquiry on the patient file.
"RTN","MBAAMDAL",82,0)
 ; It returned so many that it had to store in a global and then parse the global to return everything > than yesterday
"RTN","MBAAMDAL",83,0)
 ; and then potentially further parse when it gets back to calling routine which may have only wanted one to cancel
"RTN","MBAAMDAL",84,0)
 ; Instead of one DIQ call on the patient, it has been changed to a LIST^DIC call using a SCREEN on the sub-file which gets just what you want.
"RTN","MBAAMDAL",85,0)
 ;
"RTN","MBAAMDAL",86,0)
 ; This was rewritten to get a specific appointment for cancellation (SD would be a date.time in FileMan format)
"RTN","MBAAMDAL",87,0)
 ;  Or
"RTN","MBAAMDAL",88,0)
 ; It will give everything on a certain date (SD will be just a date, no time)
"RTN","MBAAMDAL",89,0)
 ;  Or
"RTN","MBAAMDAL",90,0)
 ; everything from today forward if no date passed in
"RTN","MBAAMDAL",91,0)
 ; 
"RTN","MBAAMDAL",92,0)
 ; Will it ever want past appointments?
"RTN","MBAAMDAL",93,0)
 ;
"RTN","MBAAMDAL",94,0)
 N ERROR,TARGET,APT,IENS,LP,SCREEN
"RTN","MBAAMDAL",95,0)
 S SCREEN=$$SCREEN($G(SD))
"RTN","MBAAMDAL",96,0)
 S IENS=","_IFN_","
"RTN","MBAAMDAL",97,0)
 D LIST^DIC(2.98,IENS,".001;@","EI",,,,,SCREEN,,"TARGET","ERROR")
"RTN","MBAAMDAL",98,0)
 ;
"RTN","MBAAMDAL",99,0)
 ; returns something like this so loop through it
"RTN","MBAAMDAL",100,0)
 ;TARGET("DILIST",0)="97^*^0^"
"RTN","MBAAMDAL",101,0)
 ;TARGET("DILIST",2,1)=3140826.09
"RTN","MBAAMDAL",102,0)
 ;TARGET("DILIST",2,2)=3140925.1
"RTN","MBAAMDAL",103,0)
 ;TARGET("DILIST",2,3)=3141023.08
"RTN","MBAAMDAL",104,0)
 ;
"RTN","MBAAMDAL",105,0)
 ; Make sure we have a bite
"RTN","MBAAMDAL",106,0)
 I '$D(TARGET("DILIST",2,1)) Q
"RTN","MBAAMDAL",107,0)
 ;
"RTN","MBAAMDAL",108,0)
 ; Now, loop through that list and get the deets
"RTN","MBAAMDAL",109,0)
 S LP=0 F  S LP=$O(TARGET("DILIST",2,LP)) Q:LP=""  D
"RTN","MBAAMDAL",110,0)
 . S IENS=TARGET("DILIST",2,LP)_","_IFN_","
"RTN","MBAAMDAL",111,0)
 . K APT   ; mant to make sure it's clean going in
"RTN","MBAAMDAL",112,0)
 . D GETS^DIQ(2.98,IENS,"*",FLAG,"APT")    ; might need to revisit the * but maybe not.  GETREC above also grabs all fields in a subfile.
"RTN","MBAAMDAL",113,0)
 . M REC=APT  ; save off the appointment it's returning
"RTN","MBAAMDAL",114,0)
 Q
"RTN","MBAAMDAL",115,0)
 ;
"RTN","MBAAMDAL",116,0)
SCREEN(SD) ;
"RTN","MBAAMDAL",117,0)
 ; SCREEN will either be I Y=SD (FileMan format)
"RTN","MBAAMDAL",118,0)
 ; or I $P(Y,".")=SD
"RTN","MBAAMDAL",119,0)
 ; or I Y>(TODAY - 1 second) (FileMan Format)
"RTN","MBAAMDAL",120,0)
 I $P($G(SD),".",2) Q "I Y="_SD
"RTN","MBAAMDAL",121,0)
 I $G(SD) Q "I $P(Y,""."")="_SD
"RTN","MBAAMDAL",122,0)
 Q "I Y>"_$$FMADD^XLFDT(DT,0,0,0,-1)
"RTN","MBAARPC2")
0^8^B89267561^B83940049
"RTN","MBAARPC2",1,0)
MBAARPC2 ;OIT-PD/PB - Scheduling RPCs ;FEB 23, 2017
"RTN","MBAARPC2",2,0)
 ;;1.0;Scheduling Calendar View;**1,4,5,7**;Feb 13, 2015;Build 16
"RTN","MBAARPC2",3,0)
 ;
"RTN","MBAARPC2",4,0)
 ;This routine has multiple RPCs created to support the mobile Scheduling apps
"RTN","MBAARPC2",5,0)
 ;
"RTN","MBAARPC2",6,0)
 ;Associated ICRs:
"RTN","MBAARPC2",7,0)
 ;  ICR#
"RTN","MBAARPC2",8,0)
 ;  10103 XLFDT
"RTN","MBAARPC2",9,0)
 ;  5838 SDAMEVT
"RTN","MBAARPC2",10,0)
 ;  6048 SDAMEVT
"RTN","MBAARPC2",11,0)
 ;  6053 DPT
"RTN","MBAARPC2",12,0)
 ;  4433 SDAMA301
"RTN","MBAARPC2",13,0)
 ;
"RTN","MBAARPC2",14,0)
 ;Cancel an Appointment
"RTN","MBAARPC2",15,0)
CANCEL(RV,DFN,SC,SD,TYPE,RSN,RMK) ; SD APPOINTMENT CANCEL 
"RTN","MBAARPC2",16,0)
 ; MBAA RPC: MBAA CANCEL APPOINTMENT
"RTN","MBAARPC2",17,0)
 N STATUS,RESULT
"RTN","MBAARPC2",18,0)
 S STATUS=$$CANCEL1(.RESULT,DFN,SC,SD,TYPE,RSN,RMK)
"RTN","MBAARPC2",19,0)
 ;D MERGE^MBAAMRPC(.RV,.RESULT)
"RTN","MBAARPC2",20,0)
 S RV=$G(RESULT(0)) ; MBAA*1*5 - Return error text with error code
"RTN","MBAARPC2",21,0)
 Q
"RTN","MBAARPC2",22,0)
CANCEL1(RETURN,DFN,SC,SD,TYP,RSN,RMK) ; Cancel appointment MBAA RPC: MBAA CANCEL APPOINTMENT
"RTN","MBAARPC2",23,0)
 N CDATE,CDT,ERR,ODT,OIFN,OUSR,%
"RTN","MBAARPC2",24,0)
 N CAPT,CIFN  ;alb/sat 4 - existing variables need to be Newed
"RTN","MBAARPC2",25,0)
 S RETURN=0
"RTN","MBAARPC2",26,0)
 S %=$$CHKCAN(.RETURN,DFN,SC,SD) I $E(%,1,3)="APT" Q RETURN
"RTN","MBAARPC2",27,0)
 S CDATE=$$NOW^XLFDT  ;ICR#: 10103 XLFDT
"RTN","MBAARPC2",28,0)
 S %=$$GETSCAP^MBAAMAP1(.CAPT,SC,DFN,SD)
"RTN","MBAARPC2",29,0)
 S CIFN=CAPT("IFN")
"RTN","MBAARPC2",30,0)
 S OUSR=CAPT("USER"),ODT=CAPT("DATE")
"RTN","MBAARPC2",31,0)
 N SDATA,SDCPHDL
"RTN","MBAARPC2",32,0)
 S SDCPHDL=$$HANDLE^SDAMEVT(1) ;ICR#: 5838 SDAMEVT
"RTN","MBAARPC2",33,0)
 D BEFORE^SDAMEVT(.SDATA,DFN,SD,SC,CIFN,SDCPHDL)
"RTN","MBAARPC2",34,0)
 S CDT=$$NOW^XLFDT()  ;ICR#: 10103 XLFDT
"RTN","MBAARPC2",35,0)
 D CANCEL^MBAAMDA3(.ERR,DFN,SD,TYP,RSN,RMK,$E(CDT,1,12),DUZ,OUSR,ODT)
"RTN","MBAARPC2",36,0)
 S OIFN=$$COVERB^MBAAMDA1(SC,SD,CIFN)
"RTN","MBAARPC2",37,0)
 S %=$$CANCEL^MBAAAPI1(RETURN,CAPT("CONSULT"),SC,SD,CIFN,RMK,TYP)
"RTN","MBAARPC2",38,0)
 D CANCEL^MBAAMDA1(SC,SD,DFN,CIFN)
"RTN","MBAARPC2",39,0)
 ;alb/sat 4 - begin mod to update SDEC
"RTN","MBAARPC2",40,0)
 N SDECAPPT
"RTN","MBAARPC2",41,0)
 S SDECAPPT=$$APPTGET^SDECUTL(DFN,SD,SC)
"RTN","MBAARPC2",42,0)
 D:+SDECAPPT SDECCAN^SDEC08(SDECAPPT,"PC",RSN,RMK,"",DUZ,"01")
"RTN","MBAARPC2",43,0)
 ;alb/sat 4 - end mod
"RTN","MBAARPC2",44,0)
 D CANCEL^SDAMEVT(.SDATA,DFN,SD,SC,CIFN,0,SDCPHDL) ;ICR#: 6048 MBAA SDAMEVT API CALLS
"RTN","MBAARPC2",45,0)
 S RETURN=1
"RTN","MBAARPC2",46,0)
 Q RETURN
"RTN","MBAARPC2",47,0)
 ;
"RTN","MBAARPC2",48,0)
CHKCAN(RETURN,DFN,SC,SD) ; Verify cancel MBAA RPC: MBAA CANCEL APPOINTMENT
"RTN","MBAARPC2",49,0)
 ;N APT,RET,%
"RTN","MBAARPC2",50,0)
 K APT N RET,TXT,%   ;alb/sat 4 - existing TXT needs to be Newed
"RTN","MBAARPC2",51,0)
 S RETURN=0
"RTN","MBAARPC2",52,0)
 I '$D(^DPT(DFN,"S",SD)) S RETURN="APTNTSCH" Q RETURN ; patient doesn't have an appointment at the requested time  ;ICR#: 6053 DPT
"RTN","MBAARPC2",53,0)
 ;
"RTN","MBAARPC2",54,0)
 D GETAPTS^MBAAMDA2(.APT,DFN,.SD)
"RTN","MBAARPC2",55,0)
 ;
"RTN","MBAARPC2",56,0)
 I APT("APT",SD,"STATUS")["C" D  S RETURN="APTCAND" Q RETURN ; Appointment already canceled.
"RTN","MBAARPC2",57,0)
 . D ERRX^MBAAAPIE(.RETURN,"APTCAND")
"RTN","MBAARPC2",58,0)
 ;
"RTN","MBAARPC2",59,0)
 I $$ISAPTCO^MBAAMAP4(,DFN,SD) D  S RETURN="APTCCHO" Q RETURN ; Appointment has a check out date and can't be canceled - MBAA*1*5
"RTN","MBAARPC2",60,0)
 . D ERRX^MBAAAPIE(.RETURN,"APTCCHO")
"RTN","MBAARPC2",61,0)
 ;
"RTN","MBAARPC2",62,0)
 S %=$$CLNRGHT^MBAAMAP1(.RET,+SC)
"RTN","MBAARPC2",63,0)
 I RET=0 D  S RETURN="APTCRGT" Q RETURN ; Appointment not cancelled. Access to this clinic to this clinic is restricted to only priv. users - MBAA*1*5
"RTN","MBAARPC2",64,0)
 . S TXT(1)=RET("CLN"),TXT(2)=$C(10)
"RTN","MBAARPC2",65,0)
 . D ERRX^MBAAAPIE(.RETURN,"APTCRGT",.TXT)
"RTN","MBAARPC2",66,0)
 ;
"RTN","MBAARPC2",67,0)
 I '$$CHKSPC(.STAT,DFN,SD) D  S RETURN="APTCNPE" Q RETURN ; This appointment can't be canceled - MBAA*1*5
"RTN","MBAARPC2",68,0)
 . D ERRX^MBAAAPIE(.RETURN,"APTCNPE",.TXT)
"RTN","MBAARPC2",69,0)
 ;
"RTN","MBAARPC2",70,0)
 ; OK if you made it this far
"RTN","MBAARPC2",71,0)
 S RETURN=1
"RTN","MBAARPC2",72,0)
 ;
"RTN","MBAARPC2",73,0)
 Q RETURN
"RTN","MBAARPC2",74,0)
 ;
"RTN","MBAARPC2",75,0)
CHKSPC(RETURN,DFN,SD) ; Check if status permit cancelation, MBAA RPC: MBAA CANCEL APPOINTMENT
"RTN","MBAARPC2",76,0)
 ;INPUT: RETURN -Looks like flag of 1 or 0 is RETURNed here and by the function
"RTN","MBAARPC2",77,0)
 ;       DFN - Patient IEN
"RTN","MBAARPC2",78,0)
 ;       SD - Date/Time of appointment
"RTN","MBAARPC2",79,0)
 N APT0,STATUS,IND,STAT,STATS
"RTN","MBAARPC2",80,0)
 S RETURN=0
"RTN","MBAARPC2",81,0)
 ;
"RTN","MBAARPC2",82,0)
 ; get appointment 0 node
"RTN","MBAARPC2",83,0)
 S APT0=$$GETAPT0^MBAAMDA2(DFN,SD)
"RTN","MBAARPC2",84,0)
 ;
"RTN","MBAARPC2",85,0)
 ;T13 Change to use SDAMA301 API
"RTN","MBAARPC2",86,0)
 K R1 D STATUS^MBAARPC1(.R1,DFN,SD,+$G(APT0)) S STATUS=+R1 K R1  ;ICR 4433
"RTN","MBAARPC2",87,0)
 ;S STATUS=+$$STATUS^SDAM1(DFN,SD,+$G(APT0),$G(APT0))  ;ICR#: 2851 MBAA ACCESS TO SDAM1 API get appointment status
"RTN","MBAARPC2",88,0)
 D LSTCSTA1^MBAAMDA2(.STAT)
"RTN","MBAARPC2",89,0)
 D BLDLST^MBAAMAPI(.STATS,.STAT)
"RTN","MBAARPC2",90,0)
 S IND=0
"RTN","MBAARPC2",91,0)
 F  S IND=$O(STATS(IND)) Q:IND=""!(RETURN=1)  D
"RTN","MBAARPC2",92,0)
 . I STATS(IND,"ID")=STATUS S RETURN=1 Q
"RTN","MBAARPC2",93,0)
 ;
"RTN","MBAARPC2",94,0)
 S RETURN=$G(RETURN)
"RTN","MBAARPC2",95,0)
 Q RETURN
"RTN","MBAARPC2",96,0)
 ;
"RTN","MBAARPC2",97,0)
 ;Line Tags CLNDATA, RECALL, DELETE, CHK, NEWEWL, WFCK, ENRCHK, REQBY is commented out due to the functionality being descoped from the first release
"RTN","MBAARPC2",98,0)
 ;CLNDATA(RETURN,CLINICID) ; returns additional clinic data MBAA ADDITIONAL CLINIC DETAILS
"RTN","MBAARPC2",99,0)
 ; Input: CLINICID - IEN for the Clinic in the Hospital Location file (#44)
"RTN","MBAARPC2",100,0)
 ; Returns: 
"RTN","MBAARPC2",101,0)
 ; If Successful:
"RTN","MBAARPC2",102,0)
 ;  RETURN(0)="TREATING SPECIALTY^STOP CODE^CREDIT STOP CODE^SPECIALTY"
"RTN","MBAARPC2",103,0)
 ; If Failure:
"RTN","MBAARPC2",104,0)
 ;  RETURN(0)="0^Missing CLINICID" 
"RTN","MBAARPC2",105,0)
 ;  RETURN(0)="0^Clinic doesn't exist."
"RTN","MBAARPC2",106,0)
 ;
"RTN","MBAARPC2",107,0)
 ;I $G(CLINICID)="" S RETURN(0)="0^Missing CLINICID" Q
"RTN","MBAARPC2",108,0)
 ;I '$D(^SC(CLINICID,0)) S RETURN(0)="0^Clinic doesn't exist." Q  ;ICR#: 6044
"RTN","MBAARPC2",109,0)
 ;I $P(^SC(CLINICID,0),"^",3)'="C" S RETURN(0)="0^Clinic doesn't exist." Q  ;ICR#: 6044
"RTN","MBAARPC2",110,0)
 ;N NODE,STOPPTR,SPECPTR,CREDITPRT,SPECLTY,SPECL,SPEC,SPEC2,STOPCODE,CREDIT,CREDITPTR,CLINIC1,SPEC1  ;IRC#: 6044
"RTN","MBAARPC2",111,0)
 ;S NODE=$G(^SC(CLINICID,0)),STOPPTR=$P(NODE,"^",7),SPECPTR=$P(NODE,"^",20),CREDITPTR=$P(NODE,"^",18)
"RTN","MBAARPC2",112,0)
 ;S STOPCODE=$P(^DIC(40.7,STOPPTR,0),"^"),CREDIT=$P(^DIC(40.7,CREDITPTR,0),"^"),SPEC=$P(^DIC(45.7,SPECPTR,0),"^")  ;ICR#: 1024, 362
"RTN","MBAARPC2",113,0)
 ;S SPECLTY=$P(^DIC(45.7,SPECPTR,0),"^",2),SPECL=$P(^DIC(42.4,SPECLTY,0),"^",1)  ;ICR#: 430, 362
"RTN","MBAARPC2",114,0)
 ;D GETS^DIQ(44,CLINICID,"8;9.5;2503","IE","CLINIC1")
"RTN","MBAARPC2",115,0)
 ;S SPEC=$G(CLINIC1(44,CLINICID_",",9.5,"I")),STOPCODE=$G(CLINIC1(44,CLINICID_",",8,"E")),CREDIT=$G(CLINIC1(44,CLINICID_",",2503,"E")),SPEC2=$G(CLINIC1(44,CLINICID_",",9.5,"E"))
"RTN","MBAARPC2",116,0)
 ;D GETS^DIQ(45.7,SPEC,".01;1","IE","SPEC1")
"RTN","MBAARPC2",117,0)
 ;S SPECL=$G(SPEC1(45.7,SPEC_",",1,"E"))
"RTN","MBAARPC2",118,0)
 ;S RETURN(0)=$G(SPEC2)_"^"_$G(STOPCODE)_"^"_$G(CREDIT)_"^"_$G(SPECL)
"RTN","MBAARPC2",119,0)
 ;K NODE,STOPPTR,SPECPTR,CREDITPRT,SPECLTY,SPECL,SPEC,STOPCODE,CREDIT,CREDITPTR,CLINIC1,SPEC1
"RTN","MBAARPC2",120,0)
 ;Q
"RTN","MBAARPC2",121,0)
 ;RECALL(RESULTS,DFN,CLINIC,RECALLDT,PTRECDT,PROVIDER,LEN,FAST,TEST,USER,COMMENT) ; adds new patients to the Recall List MBAA RPC: MBAA ADD TO RECALL LIST
"RTN","MBAARPC2",122,0)
 ; Input parameter is the Patient DFN
"RTN","MBAARPC2",123,0)
 ;S RESULTS(0)=1
"RTN","MBAARPC2",124,0)
 ;I $G(DFN)="" S RESULTS(0)="0^DFN is not defined" Q
"RTN","MBAARPC2",125,0)
 ;T13 Change to FM read
"RTN","MBAARPC2",126,0)
 ;N JX S JX=$$GET1^DIQ(2,$G(DFN),.01) I $G(JX)="" S RESULTS(0)="0^Not a patient in this system." Q  ;ICR#: 6053 DPT
"RTN","MBAARPC2",127,0)
 ;I '$D(^DPT(DFN,0)) S RESULTS(0)="0^Not a patient in this system." Q  ;ICR#: 6053 DPT
"RTN","MBAARPC2",128,0)
 ;I $G(CLINIC)="" S RESULTS(0)="0^Clinic not provided." Q
"RTN","MBAARPC2",129,0)
 ;T13 Change to FM read
"RTN","MBAARPC2",130,0)
 ;I '$D(^SC(CLINIC,0)) S RESULTS(0)="0^Clinic not in the Hospital Location File." Q  ;ICR#: 6044
"RTN","MBAARPC2",131,0)
 ;N JX S JX=$$GET1^DIQ(44,$G(CLINIC),.01) I $G(JX)="" S RESULTS(0)="0^Clinic not in the Hospital Location File." Q  ;ICR#: 6044
"RTN","MBAARPC2",132,0)
 ;I ($G(RECALLDT)=""!($G(RECALLDT)'>DT)) S RESULTS(0)="0^Provider Recall date not provided or not a valid date. Date must be in the future." Q
"RTN","MBAARPC2",133,0)
 ;I ($G(PTRECDT)=""!($G(PTRECDT)'>DT)) S RESULTS(0)="0^Patient recall date not provided or not a valid date. Date must be in the future" Q
"RTN","MBAARPC2",134,0)
 ;I $G(PROVIDER)="" S RESULTS(0)="0^Provider IEN not provided." Q
"RTN","MBAARPC2",135,0)
 ;I '$D(^VA(200,$G(PROVIDER),0)) S RESULTS(0)="0^Provider not provided." Q
"RTN","MBAARPC2",136,0)
 ;N JX S JX=$$GET1^DIQ(200,$G(PROVIDER),.01) I $G(JX)="" S RESULTS(0)="0^Provider not in the New Person file." Q  ;ICR#: 713 VA(200
"RTN","MBAARPC2",137,0)
 ;I $G(LEN)'>0 S RESULTS(0)="0^Appointment length not provided." Q
"RTN","MBAARPC2",138,0)
 ;I $G(FAST)="" S RESULTS(0)="0^FAST code not provided." Q
"RTN","MBAARPC2",139,0)
 ;S FAST=$$LOW^XLFSTR($G(FAST))
"RTN","MBAARPC2",140,0)
 ;I "nf"'[FAST S RESULTS(0)="0^FAST code not provided." Q
"RTN","MBAARPC2",141,0)
 ;I $G(TEST)'>0 S RESULTS(0)="0^Appointment Type code not provided. Appointment Type is a numeric value." Q
"RTN","MBAARPC2",142,0)
 ;I $G(USER)'>0 S RESULTS(0)="0^User IEN not provided." Q
"RTN","MBAARPC2",143,0)
 ;I '$D(^VA(200,$G(USER),0)) S RESULTS(0)="0^User IEN not provided." Q
"RTN","MBAARPC2",144,0)
 ;N JX S JX=$$GET1^DIQ(200,$G(USER),.01) I $G(JX)="" S RESULTS(0)="0^User not in the New Person File." Q  ;ICR#: 713 VA(200
"RTN","MBAARPC2",145,0)
 ;S ERR=0 D CHK I ERR=1 S RESULTS(0)="0^Duplicate Recall List Entry" Q
"RTN","MBAARPC2",146,0)
 ;K DO S (DIC,DIE)="^SD(403.5,",DIC(0)="Z",X=DFN,DLAYGO=403.5 D FILE^DICN K DO S NUM=+Y  ;ICR#: 6045 SD(403.5
"RTN","MBAARPC2",147,0)
 ;S DA=NUM,DR="4.5///"_$G(CLINIC)_";4///"_$G(PROVIDER)_";2.6///"_$G(FAST)_";4.7///"_$G(LEN)_";5///"_$G(RECALLDT)_";5.5///"_$G(PTRECDT)_";2.5///"_$G(COMMENT)_";3///"_$G(TEST)_";7///"_$G(USER)
"RTN","MBAARPC2",148,0)
 ;D ^DIE
"RTN","MBAARPC2",149,0)
 ;S DA=NUM,DR="[SDRR RECALL CARD ADD]",DIE("NO^")="Not Allowed" D ^DIE
"RTN","MBAARPC2",150,0)
 ;I $D(DTOUT) D DELETE
"RTN","MBAARPC2",151,0)
 ;K DIC,DIE,DR,D0,DA,DLAYGO,NUM,PROV,X,Y,Z,OK,RDT,DIR,DTOUT
"RTN","MBAARPC2",152,0)
 ;Q
"RTN","MBAARPC2",153,0)
 ;DELETE ;delete new incomplete record and display message MBAA RPC: MBAA ADD TO RECALL LIST
"RTN","MBAARPC2",154,0)
 ;S DIK=DIE
"RTN","MBAARPC2",155,0)
 ;D ^DIK K DIK
"RTN","MBAARPC2",156,0)
 ;S RESULTS(0)="0^All required data was not provided. Recall was not created!"
"RTN","MBAARPC2",157,0)
 ;Q
"RTN","MBAARPC2",158,0)
 ;CHK ; checks to see if the patient is on the recall list for the clinic and provider date MBAA RPC: MBAA ADD TO RECALL LIST
"RTN","MBAARPC2",159,0)
 ;S XX=0 F  S XX=$O(^SD(403.5,"B",DFN,XX)) Q:XX'>0  D  ;ICR#: 6045 SD(403.5
"RTN","MBAARPC2",160,0)
 ;.;T13 Change to use FM
"RTN","MBAARPC2",161,0)
 ;.N ARRAY,ERR,C1,RD1,P1 D GETS^DIQ(403.5,XX_",","2;4,5","I","ARRAY","ERR")   ;ICR#: 6045 SD(403.5
"RTN","MBAARPC2",162,0)
 ;.S C1=$G(ARRAY(403.5,XX_",",2,"I")),RD1=$G(ARRAY(403.5,XX_",",5,"I")),P1=$G(ARRAY(403.5,XX_",",4,"I"))
"RTN","MBAARPC2",163,0)
 ;.I $G(C1)=CLINIC&($G(RD1)=RECALLDT)&($G(P1)=PROVIDER) S ERR=1
"RTN","MBAARPC2",164,0)
 ;.;S NODE=$G(^SD(403.5,XX,0))  ;ICR#: 6045 SD(403.5
"RTN","MBAARPC2",165,0)
 ;.;I ($P(NODE,"^",2)=CLINIC&($P(NODE,"^",6)=RECALLDT)&($P(NODE,"^",5)=PROVIDER)) S ERR=1
"RTN","MBAARPC2",166,0)
 ;I $G(ERR)>0 S ERR=1
"RTN","MBAARPC2",167,0)
 ;Q
"RTN","MBAARPC2",168,0)
 ;code below is not being used in the initial release of MBAA. It will be released at a later date in a future release of MBAA
"RTN","MBAARPC2",169,0)
 ;CLNRGHT(RV,CLN) ;
"RTN","MBAARPC2",170,0)
 ; N STATUS,RESULT S STATUS=$$CLNRGHT^MBAAMAP1(.RESULT,CLN)
"RTN","MBAARPC2",171,0)
 ; ;D MERGE^MBAAMRPC(.RV,.RESULT)
"RTN","MBAARPC2",172,0)
 ; S RV(0)=$G(RESULT)
"RTN","MBAARPC2",173,0)
 ; Q
"RTN","MBAARPC2",174,0)
NEWEWL(RV,SDWLD) ; ZLV EWL NEW
"RTN","MBAARPC2",175,0)
 N Y   ;alb/sat 4 - existing Y needs to be Newed
"RTN","MBAARPC2",176,0)
 I $G(SDWLD)="" S RV(0)="0^SDWLD List missing." Q
"RTN","MBAARPC2",177,0)
 S SDWLD("WLTYPE")=$P($G(SDWLD),"^",1)
"RTN","MBAARPC2",178,0)
 I SDWLD("WLTYPE")=""  S RV(0)="0^INVPARAM WLTYPE IS NULL" Q
"RTN","MBAARPC2",179,0)
 I $G(SDWLD("WLTYPE"))'>0!($G(SDWLD("WLTYPE"))'<5) S RV(0)="0^INVPARAM WLTYPE" Q
"RTN","MBAARPC2",180,0)
 S SDWLD("PATIENT")=$P($G(SDWLD),"^",2)
"RTN","MBAARPC2",181,0)
 I SDWLD("PATIENT")=""  S RV(0)="0^INVPARAM PATIENT IS NULL" Q
"RTN","MBAARPC2",182,0)
 S DFN=$G(SDWLD("PATIENT")) I '$D(^DPT(DFN,0)) S RV(0)="0^INVPARAM PATIENT DOESN'T EXIST." K DFN Q  ;ICR#: 6053 DPT
"RTN","MBAARPC2",183,0)
 S SDWLD("INSTITUTION")=$P($G(SDWLD),"^",3)
"RTN","MBAARPC2",184,0)
 I SDWLD("INSTITUTION")=""  S RV(0)="0^INVPARAM INSTITUTION IS NULL" Q
"RTN","MBAARPC2",185,0)
 N SITE S X=$G(SDWLD("INSTITUTION")) S SITE=$$IEN^XUMF(4,,X) I +$G(SITE)'>0 S RV(0)="0^INVPARAM INVALID INSTITUTION NUMBER." Q  ;ICR#:3795 XUMF
"RTN","MBAARPC2",186,0)
 S SDWLD("WAITFOR")=$P($G(SDWLD),"^",4)
"RTN","MBAARPC2",187,0)
 I SDWLD("WAITFOR")=""  S RV(0)="0^INVPARAM WAITFOR IS NULL" Q
"RTN","MBAARPC2",188,0)
 ;S ERR=0 D WFCK Q:$G(ERR)>0
"RTN","MBAARPC2",189,0)
 S SDWLD("PRIORITY")=$P($G(SDWLD),"^",5)
"RTN","MBAARPC2",190,0)
 I SDWLD("PRIORITY")=""  S RV(0)="0^INVPARAM PRIORITY IS NULL" Q
"RTN","MBAARPC2",191,0)
 I SDWLD("PRIORITY")'="A",(SDWLD("PRIORITY")'="F") S RV(0)="0^INVPARAM INVALID PRIORITY" Q
"RTN","MBAARPC2",192,0)
 S SDWLD("REQBY")=$P($G(SDWLD),"^",6)
"RTN","MBAARPC2",193,0)
 D REQBY
"RTN","MBAARPC2",194,0)
 Q:$G(ERR)=1
"RTN","MBAARPC2",195,0)
 S SDWLD("PROVIDER")=$P($G(SDWLD),"^",7)
"RTN","MBAARPC2",196,0)
 I SDWLD("PROVIDER")'="" D
"RTN","MBAARPC2",197,0)
 .N IEN S ERR=0,IEN=$G(SDWLD("PROVIDER"))
"RTN","MBAARPC2",198,0)
 .N JX S JX=$$GET1^DIQ(200,$G(IEN),.01) I $G(JX)="" S ERR=1,RV(0)="0^INVPARAM PROVIDER IS NOT IN THE NEW PERSON FILE" Q  ;ICR#: 713 VA(200
"RTN","MBAARPC2",199,0)
 .;I '$D(^VA(200,IEN,0)) S ERR=1,RV(0)="0^INVPARAM PROVIDER IS NOT IN THE NEW PERSON FILE" Q  ;ICR#: 713 VA(200
"RTN","MBAARPC2",200,0)
 .I '$D(^XUSEC("PROVIDER",IEN)) S ERR=1,RV(0)="0^INVPARAM NOT A PROVIDER" Q  ;ICR#: 10076 XUSEC
"RTN","MBAARPC2",201,0)
 Q:$G(ERR)=1
"RTN","MBAARPC2",202,0)
 S SDWLD("SCPRCNT")=$P($G(SDWLD),"^",8)
"RTN","MBAARPC2",203,0)
 I SDWLD("SCPRCNT")'=""  D
"RTN","MBAARPC2",204,0)
 .S ERR=0 I SDWLD("SCPRCNT")'>0!(SDWLD("SCPRCNT")'<101) S ERR=1,RV(0)="0^INVPARAM SERVICE CONNECTED PERCENTAGE" Q
"RTN","MBAARPC2",205,0)
 Q:$G(ERR)=1
"RTN","MBAARPC2",206,0)
 S SDWLD("SCPRIORITY")=$P($G(SDWLD),"^",9)
"RTN","MBAARPC2",207,0)
 I SDWLD("SCPRIORITY")'=""  D
"RTN","MBAARPC2",208,0)
 .S ERR=0 I $G(SDWLD("SCPRIORITY"))'=0,($G(SDWLD("SCPRIORITY"))'=1) S ERR=1,RV(0)="0^INVPARAM INVALID PRIORITY" Q
"RTN","MBAARPC2",209,0)
 Q:$G(ERR)=1
"RTN","MBAARPC2",210,0)
 S SDWLD("DSRDDT")=$P($G(SDWLD),"^",10)
"RTN","MBAARPC2",211,0)
 I SDWLD("DSRDDT")=""  S RV(0)="0^INVPARAM DESIRED DATE OF APPOINTMENT IS NULL" Q
"RTN","MBAARPC2",212,0)
 S ERR=0,X=$G(SDWLD("DSRDDT")) D ^%DT I Y=-1 S ERR=0,RV(0)="0^INVPARAM NOT A VALID DATE" Q
"RTN","MBAARPC2",213,0)
 Q:$G(ERR)=1
"RTN","MBAARPC2",214,0)
 S SDWLD("CMNTS")=$P($G(SDWLD),"^",11)
"RTN","MBAARPC2",215,0)
 I SDWLD("CMNTS")'=""  D
"RTN","MBAARPC2",216,0)
 .I $L($G(SDWLD("CMNTS")))'>0!($L($G(SDWLD("CMNTS")))'<61) S ERR=1,RV(0)="0^INVPARAM COMMENTS ARE TOO LONG" Q
"RTN","MBAARPC2",217,0)
 Q:$G(ERR)=1
"RTN","MBAARPC2",218,0)
 S SDWLD("ENRSTAT")=$P($G(SDWLD),"^",12)
"RTN","MBAARPC2",219,0)
 I SDWLD("ENRSTAT")=""  S RV(0)="0^INVPARAM ENROLLEE STATUS IS NULL" Q
"RTN","MBAARPC2",220,0)
 S ERR=0 D ENRCHK Q:$G(ERR)=1
"RTN","MBAARPC2",221,0)
 S SDWLD("ENRDU")=$P($G(SDWLD),"^",13)
"RTN","MBAARPC2",222,0)
 I SDWLD("ENRDU")'=""  D
"RTN","MBAARPC2",223,0)
 .S ERR=0 S X=$G(SDWLD("ENRDU")) D ^%DT I $G(Y)=-1 S ERR=1,RV(0)="0^INVPARAM ENROLLEE DATE INVALID DATE" Q
"RTN","MBAARPC2",224,0)
 Q:$G(ERR)=1
"RTN","MBAARPC2",225,0)
 S SDWLD("ENRDF")=$P($G(SDWLD),"^",14)
"RTN","MBAARPC2",226,0)
 I SDWLD("ENRDF")'=""  D
"RTN","MBAARPC2",227,0)
 .S ERR=0 I $G(SDWLD("ENRDF"))'=0,($G(SDWLD("ENRDF"))'<5) S ERR=1,RV(0)="0^INVPARAM ENROLLEE DATABASE FILE" Q
"RTN","MBAARPC2",228,0)
 Q:ERR=1
"RTN","MBAARPC2",229,0)
 S SDWLD("TICKLER")=$P($G(SDWLD),"^",15)
"RTN","MBAARPC2",230,0)
 I SDWLD("TICKLER")'=""  D
"RTN","MBAARPC2",231,0)
 .S SDWLD("TICKLER")=$$UP^XLFSTR($G(SDWLD("TICKLER")))
"RTN","MBAARPC2",232,0)
 .S ERR=0 I $G(SDWLD("TICKLER"))'="Y" S ERR=1,RV(0)="0^INVPARAM TICKLER" Q
"RTN","MBAARPC2",233,0)
 Q:ERR=1
"RTN","MBAARPC2",234,0)
 S SDWLD("CHDCLINP")=$P($G(SDWLD),"^",16)
"RTN","MBAARPC2",235,0)
 I SDWLD("CHDCLINP")'=""  D
"RTN","MBAARPC2",236,0)
 .N APTR
"RTN","MBAARPC2",237,0)
 .S ERR=0,PTR=$G(SDWLD("CHDCLINP")) I '$D(^SDWL(409.3,PTR,0)) S ERR=1,RV(0)="0^INVPARAM CHANGED CLINIC PARENT POINTER IS NOT VALID" Q  ;ICR#: 6046 SDWL(409.3
"RTN","MBAARPC2",238,0)
 .;T13 Change to use FM
"RTN","MBAARPC2",239,0)
 .I $D(^SDWL(409.3,PTR,0)) S APTR=$$GET1^DIQ(409.3,PTR_",",".01","I") I APTR'=SDWLD("PATIENT") S ERR=1,RV(0)="0^INVPARAM CHANGED CLINIC PARENT POINTER IS FOR A DIFFERENT PATIENT" Q  ;ICR#: 6046 SDWL(409.3
"RTN","MBAARPC2",240,0)
 .;I $D(^SDWL(409.3,PTR,0)) S APTR=$P(^SDWL(409.3,PTR,0),"^",1) I APTR'=SDWLD("PATIENT") S ERR=1,RV(0)="0^INVPARAM CHANGED CLINIC PARENT POINTER IS FOR A DIFFERENT PATIENT" Q  ;ICR#: 6046 SDWL(409.3
"RTN","MBAARPC2",241,0)
 .K APTR
"RTN","MBAARPC2",242,0)
 Q:ERR=1
"RTN","MBAARPC2",243,0)
 I SDWLD("WLTYPE")=3!(SDWLD("WLTYPE")=4) D
"RTN","MBAARPC2",244,0)
 .K ERR S ERR=0
"RTN","MBAARPC2",245,0)
 .I SDWLD("REQBY")'=1,$G(SDWLD("REQBY"))'=2 S ERR=1
"RTN","MBAARPC2",246,0)
 I ERR=1 K ERR S RV(0)="0^INVPARAM REQBY" Q
"RTN","MBAARPC2",247,0)
 N STATUS,RESULT S STATUS=$$NEW^MBAAWLAP(.RESULT,.SDWLD)
"RTN","MBAARPC2",248,0)
 I 'STATUS S RV=-1
"RTN","MBAARPC2",249,0)
 I $G(STATUS) S RV(0)=1
"RTN","MBAARPC2",250,0)
 K ERR,X,IEN,DFN,PTR,CHK,TYPE,REQBY
"RTN","MBAARPC2",251,0)
 Q
"RTN","MBAARPC2",252,0)
 ;WFCK ; Check to make sure the pointer is valid for the Waitfor parameter
"RTN","MBAARPC2",253,0)
 ;N PTR S PTR=$G(SDWLD("WAITFOR")),ERR=0
"RTN","MBAARPC2",254,0)
 ;I SDWLD("WLTYPE")=1 D
"RTN","MBAARPC2",255,0)
 ;.;I '$D(^SCTM(404.51,PTR,0)) S ERR=1,RV(0)="0^INVPARAM INVALID TEAM" Q  ;ICR#: 1945 DBIA 1945
"RTN","MBAARPC2",256,0)
 ;.N JX S JX=$$GET1^DIQ(404.51,$G(PTR),.01) I $G(JX)="" S ERR=1,RV(0)="0^INVPARAM INVALID TEAM" Q  ;ICR#: 1945 DBIA 1945
"RTN","MBAARPC2",257,0)
 ;Q:$G(ERR)>0
"RTN","MBAARPC2",258,0)
 ;I SDWLD("WLTYPE")=2 D
"RTN","MBAARPC2",259,0)
 ;.;I '$D(^SCTM(404.57,PTR,0)) S ERR=1,RV(0)="0^INVPARAM INVALID POSITION" Q  ;ICR#: 6064 MBAA ACCESS TO SCTM(404.57
"RTN","MBAARPC2",260,0)
 ;.N JX S JX=$$GET1^DIQ(404.57,$G(PTR),.01) I $G(JX)="" S ERR=1,RV(0)="0^INVPARAM INVALID POSITION" Q  ;ICR#: 6064 MBAA ACCESS TO SCTM(404.57
"RTN","MBAARPC2",261,0)
 ;Q:$G(ERR)>0
"RTN","MBAARPC2",262,0)
 ;I SDWLD("WLTYPE")=3 D
"RTN","MBAARPC2",263,0)
 ;.;I '$D(^SDWL(409.31,PTR,0)) S ERR=1,RV(0)="0^INVPARAM INVALID SPECIALTY" Q  ;ICR#: 6046 SDWL(409.3
"RTN","MBAARPC2",264,0)
 ;.N JX S JX=$$GET1^DIQ(409.31,$G(PTR),.01) I $G(JX)="" S ERR=1,RV(0)="0^INVPARAM INVALID SPECIALTY" Q  ;ICR#: 6046 SDWL(409.3
"RTN","MBAARPC2",265,0)
 ;Q:$G(ERR)>0
"RTN","MBAARPC2",266,0)
 ;I SDWLD("WLTYPE")=4 D
"RTN","MBAARPC2",267,0)
 ;.;I '$D(^SDWL(409.32,PTR,0)) S ERR=1,RV(0)="0^INVPARAM INVALID WAIT LIST CLINIC" Q  ;ICR#: 6046 SDWL(409.3
"RTN","MBAARPC2",268,0)
 ;.N JX S JX=$$GET1^DIQ(409.32,$G(PTR),.01) I $G(JX)="" S ERR=1,RV(0)="0^INVPARAM INVALID WAIT LIST CLINIC" Q  ;ICR#: 6046 SDWL(409.3
"RTN","MBAARPC2",269,0)
 ;Q:$G(ERR)>0
"RTN","MBAARPC2",270,0)
 ;I SDWLD("WLTYPE")>5 S RV(0)="0^INVPARAM WAIT LIST TYPE" Q
"RTN","MBAARPC2",271,0)
 ;Q
"RTN","MBAARPC2",272,0)
ENRCHK ; Check enrollee status codes - must be either N, E, P or U
"RTN","MBAARPC2",273,0)
 S CHK=$G(SDWLD("ENRSTAT"))
"RTN","MBAARPC2",274,0)
 I CHK'="N",(CHK'="E"),(CHK'="P"),(CHK'="U") S ERR=1,RV(0)="0^INVPARAM INVALID ENROLLEE STATUS" Q
"RTN","MBAARPC2",275,0)
 Q
"RTN","MBAARPC2",276,0)
REQBY ; Checksto be sure a correct value for the REQBY parameter is correct based on the Wait List Type
"RTN","MBAARPC2",277,0)
 S ERR=0,TYPE=$G(SDWLD("WLTYPE")),REQBY=$G(SDWLD("REQBY"))
"RTN","MBAARPC2",278,0)
 I $G(REQBY)'=1,($G(REQBY)'=2),($G(REQBY)'="") S ERR=1,RV(0)="0^INVPARAM INVALID REQBY" Q
"RTN","MBAARPC2",279,0)
 I $G(REQBY)'=""  D
"RTN","MBAARPC2",280,0)
 .I TYPE=3,(TYPE=4) D
"RTN","MBAARPC2",281,0)
 ..I REQBY'=1,(REQBY'=2) S ERR=1,RV(0)="0^INVPARAM INVALID REQBY" Q
"RTN","MBAARPC2",282,0)
 .I TYPE=1,(TYPE=2) D
"RTN","MBAARPC2",283,0)
 ..I REQBY=1,(REQBY'=2) S ERR=1,RV(0)="0^INVPARAM INVALID REQBY" Q
"RTN","MBAARPC2",284,0)
 I $G(REQBY)="" D
"RTN","MBAARPC2",285,0)
 .I TYPE'=1,(TYPE'=2) S ERR=1,RV(0)="0^INVPARAM INVALID REQBY" Q
"RTN","MBAARPC2",286,0)
 Q
"VER")
8.0^22.2
"BLD",10627,6)
^5
**END**
**END**

