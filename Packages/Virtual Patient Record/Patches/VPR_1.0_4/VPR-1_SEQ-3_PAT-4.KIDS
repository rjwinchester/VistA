Released VPR*1*4 SEQ #3
Extracted from mail message
**KIDS**:VPR*1.0*4^

**INSTALL NAME**
VPR*1.0*4
"BLD",9095,0)
VPR*1.0*4^VIRTUAL PATIENT RECORD^0^3150115^y
"BLD",9095,1,0)
^^1^1^3141203^
"BLD",9095,1,1,0)
JLV and VLER support
"BLD",9095,4,0)
^9.64PA^^
"BLD",9095,6.3)
6
"BLD",9095,"ABPKG")
n
"BLD",9095,"KRN",0)
^9.67PA^779.2^20
"BLD",9095,"KRN",.4,0)
.4
"BLD",9095,"KRN",.401,0)
.401
"BLD",9095,"KRN",.402,0)
.402
"BLD",9095,"KRN",.403,0)
.403
"BLD",9095,"KRN",.5,0)
.5
"BLD",9095,"KRN",.84,0)
.84
"BLD",9095,"KRN",3.6,0)
3.6
"BLD",9095,"KRN",3.8,0)
3.8
"BLD",9095,"KRN",9.2,0)
9.2
"BLD",9095,"KRN",9.8,0)
9.8
"BLD",9095,"KRN",9.8,"NM",0)
^9.68A^13^13
"BLD",9095,"KRN",9.8,"NM",1,0)
VPRD^^0^B35636643
"BLD",9095,"KRN",9.8,"NM",2,0)
VPRDOR^^0^B17346787
"BLD",9095,"KRN",9.8,"NM",3,0)
VPRDPS^^0^B20707464
"BLD",9095,"KRN",9.8,"NM",4,0)
VPRDPSOR^^0^B39578958
"BLD",9095,"KRN",9.8,"NM",5,0)
VPRDTIU^^0^B83582740
"BLD",9095,"KRN",9.8,"NM",6,0)
VPRDVSIT^^0^B100077212
"BLD",9095,"KRN",9.8,"NM",7,0)
VPRDPT^^0^B81010751
"BLD",9095,"KRN",9.8,"NM",8,0)
VPRDGMV^^0^B42263746
"BLD",9095,"KRN",9.8,"NM",9,0)
VPRDTST^^0^B11854461
"BLD",9095,"KRN",9.8,"NM",10,0)
VPRDGMPL^^0^B28051660
"BLD",9095,"KRN",9.8,"NM",11,0)
VPRDPXIM^^0^B16291131
"BLD",9095,"KRN",9.8,"NM",12,0)
VPRDPSO^^0^B16064542
"BLD",9095,"KRN",9.8,"NM",13,0)
VPRDGMRC^^0^B12856313
"BLD",9095,"KRN",9.8,"NM","B","VPRD",1)

"BLD",9095,"KRN",9.8,"NM","B","VPRDGMPL",10)

"BLD",9095,"KRN",9.8,"NM","B","VPRDGMRC",13)

"BLD",9095,"KRN",9.8,"NM","B","VPRDGMV",8)

"BLD",9095,"KRN",9.8,"NM","B","VPRDOR",2)

"BLD",9095,"KRN",9.8,"NM","B","VPRDPS",3)

"BLD",9095,"KRN",9.8,"NM","B","VPRDPSO",12)

"BLD",9095,"KRN",9.8,"NM","B","VPRDPSOR",4)

"BLD",9095,"KRN",9.8,"NM","B","VPRDPT",7)

"BLD",9095,"KRN",9.8,"NM","B","VPRDPXIM",11)

"BLD",9095,"KRN",9.8,"NM","B","VPRDTIU",5)

"BLD",9095,"KRN",9.8,"NM","B","VPRDTST",9)

"BLD",9095,"KRN",9.8,"NM","B","VPRDVSIT",6)

"BLD",9095,"KRN",19,0)
19
"BLD",9095,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",9095,"KRN",19,"NM",1,0)
VPR TEST XML^^0
"BLD",9095,"KRN",19,"NM","B","VPR TEST XML",1)

"BLD",9095,"KRN",19.1,0)
19.1
"BLD",9095,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",9095,"KRN",101,0)
101
"BLD",9095,"KRN",101,"NM",0)
^9.68A^^
"BLD",9095,"KRN",409.61,0)
409.61
"BLD",9095,"KRN",771,0)
771
"BLD",9095,"KRN",779.2,0)
779.2
"BLD",9095,"KRN",870,0)
870
"BLD",9095,"KRN",8989.51,0)
8989.51
"BLD",9095,"KRN",8989.52,0)
8989.52
"BLD",9095,"KRN",8994,0)
8994
"BLD",9095,"KRN","B",.4,.4)

"BLD",9095,"KRN","B",.401,.401)

"BLD",9095,"KRN","B",.402,.402)

"BLD",9095,"KRN","B",.403,.403)

"BLD",9095,"KRN","B",.5,.5)

"BLD",9095,"KRN","B",.84,.84)

"BLD",9095,"KRN","B",3.6,3.6)

"BLD",9095,"KRN","B",3.8,3.8)

"BLD",9095,"KRN","B",9.2,9.2)

"BLD",9095,"KRN","B",9.8,9.8)

"BLD",9095,"KRN","B",19,19)

"BLD",9095,"KRN","B",19.1,19.1)

"BLD",9095,"KRN","B",101,101)

"BLD",9095,"KRN","B",409.61,409.61)

"BLD",9095,"KRN","B",771,771)

"BLD",9095,"KRN","B",779.2,779.2)

"BLD",9095,"KRN","B",870,870)

"BLD",9095,"KRN","B",8989.51,8989.51)

"BLD",9095,"KRN","B",8989.52,8989.52)

"BLD",9095,"KRN","B",8994,8994)

"BLD",9095,"QUES",0)
^9.62^^
"BLD",9095,"REQB",0)
^9.611^1^1
"BLD",9095,"REQB",1,0)
VPR*1.0*2^2
"BLD",9095,"REQB","B","VPR*1.0*2",1)

"KRN",19,14279,-1)
0^1
"KRN",19,14279,0)
VPR TEST XML^View XML results^^R^^^^^^^^VIRTUAL PATIENT RECORD
"KRN",19,14279,1,0)
^19.06^2^2^3141203^^^
"KRN",19,14279,1,1,0)
This option provides a way to run the VPR GET PATIENT DATA remote
"KRN",19,14279,1,2,0)
procedure call from within VistA and view the results onscreen.
"KRN",19,14279,25)
EN^VPRDTST
"KRN",19,14279,"U")
VIEW XML RESULTS
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",571,-1)
1^1
"PKG",571,0)
VIRTUAL PATIENT RECORD^VPR^Utilities to manage a virtual copy of the patient record
"PKG",571,20,0)
^9.402P^^
"PKG",571,22,0)
^9.49I^1^1
"PKG",571,22,1,0)
1.0^3110804^3110525^1085
"PKG",571,22,1,"PAH",1,0)
4^3150115
"PKG",571,22,1,"PAH",1,1,0)
^^1^1^3150115
"PKG",571,22,1,"PAH",1,1,1,0)
JLV and VLER support
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
13
"RTN","VPRD")
0^1^B35636643^B29175301
"RTN","VPRD",1,0)
VPRD ;SLC/MKB -- Serve VistA data as XML via RPC ;8/2/11  15:29
"RTN","VPRD",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,2,4**;Sep 01, 2011;Build 6
"RTN","VPRD",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRD",4,0)
 ;
"RTN","VPRD",5,0)
 ; External References          DBIA#
"RTN","VPRD",6,0)
 ; -------------------          -----
"RTN","VPRD",7,0)
 ; ^DPT                         10035
"RTN","VPRD",8,0)
 ; ^SC                          10040
"RTN","VPRD",9,0)
 ; ^USC(8932.1)                  4984
"RTN","VPRD",10,0)
 ; DIQ                           2056
"RTN","VPRD",11,0)
 ; MPIF001                       2701
"RTN","VPRD",12,0)
 ; VASITE                       10112
"RTN","VPRD",13,0)
 ; XLFDT                        10103
"RTN","VPRD",14,0)
 ; XLFSTR                       10104
"RTN","VPRD",15,0)
 ; XPAR                          2263
"RTN","VPRD",16,0)
 ; XUAF4                         2171
"RTN","VPRD",17,0)
 ; XUSTAX                        4911
"RTN","VPRD",18,0)
 ;
"RTN","VPRD",19,0)
GET(VPR,DFN,TYPE,START,STOP,MAX,ID,FILTER) ; -- Return search results as XML in @VPR@(n) 
"RTN","VPRD",20,0)
 ; RPC = VPR GET PATIENT DATA
"RTN","VPRD",21,0)
 N ICN,VPRI,VPRTOTL,VPRTEXT
"RTN","VPRD",22,0)
 S VPR=$NA(^TMP("VPR",$J)) K @VPR
"RTN","VPRD",23,0)
 S VPRTEXT=+$G(FILTER("text")) ;include report/document text?
"RTN","VPRD",24,0)
 ;
"RTN","VPRD",25,0)
 ; parse & validate input parameters
"RTN","VPRD",26,0)
 S ICN=+$P($G(DFN),";",2),DFN=+$G(DFN),ID=$G(ID)
"RTN","VPRD",27,0)
 I DFN<1,ICN S DFN=+$$GETDFN^MPIF001(ICN)
"RTN","VPRD",28,0)
 I DFN<1!'$D(^DPT(DFN)) D ERR(1,DFN) G GTQ
"RTN","VPRD",29,0)
 S TYPE=$$LOW^XLFSTR($G(TYPE)) I TYPE="" S TYPE=$$ALL
"RTN","VPRD",30,0)
 S:'$G(START) START=1410102 S:'$G(STOP) STOP=4141015 S:'$G(MAX) MAX=9999
"RTN","VPRD",31,0)
 I START,STOP,STOP<START N X S X=START,START=STOP,STOP=X  ;switch
"RTN","VPRD",32,0)
 I STOP,$L(STOP,".")<2 S STOP=STOP_".24"
"RTN","VPRD",33,0)
 I ID="",$D(FILTER("id")) S ID=FILTER("id")
"RTN","VPRD",34,0)
 ;
"RTN","VPRD",35,0)
 ; extract data
"RTN","VPRD",36,0)
 N VPRTYPE,VPRP,VPRHDR,VPRTAG,VPRTN
"RTN","VPRD",37,0)
 D ADD("<results version='"_$$GET^XPAR("ALL","VPR VERSION")_"' timeZone='"_$$TZ^XLFDT_"' >")
"RTN","VPRD",38,0)
 S VPRTYPE=TYPE
"RTN","VPRD",39,0)
 F VPRP=1:1:$L(VPRTYPE,";") S VPRTAG=$P(VPRTYPE,";",VPRP) I $L(VPRTAG) D
"RTN","VPRD",40,0)
 . S VPRTN="EN^"_$$RTN(.VPRTAG) Q:'$L($T(@VPRTN))  ;D ERR(2) Q
"RTN","VPRD",41,0)
 . D ADD("<"_VPRTAG) S VPRHDR=VPRI,VPRTOTL=0
"RTN","VPRD",42,0)
 . D @(VPRTN_"(DFN,START,STOP,MAX,ID)")
"RTN","VPRD",43,0)
 . S @VPR@(VPRHDR)=@VPR@(VPRHDR)_" total='"_+$G(VPRTOTL)_"' >" D ADD("</"_VPRTAG_">")
"RTN","VPRD",44,0)
 D ADD("</results>")
"RTN","VPRD",45,0)
 ;
"RTN","VPRD",46,0)
GTQ ; end
"RTN","VPRD",47,0)
 Q
"RTN","VPRD",48,0)
 ;
"RTN","VPRD",49,0)
RTN(X) ; -- Return name of VPRDxxxx routine for clinical domain X
"RTN","VPRD",50,0)
 ;  X is also enforced as expected group tag name, if passed by ref
"RTN","VPRD",51,0)
 N Y S Y="VPRD",X=$G(X) I X="" Q Y
"RTN","VPRD",52,0)
 I X["accession"    S Y="VPRDLRA",X="accessions"
"RTN","VPRD",53,0)
 I X["allerg"       S Y="VPRDGMRA",X="reactions"
"RTN","VPRD",54,0)
 I X["appointment"  S Y="VPRDSDAM",X="appointments"
"RTN","VPRD",55,0)
 I X["clinicalProc" S Y="VPRDMC",X="clinicalProcedures"
"RTN","VPRD",56,0)
 I X["consult"      S Y="VPRDGMRC",X="consults"
"RTN","VPRD",57,0)
 I X["demograph"    S Y="VPRDPT",X="demographics"
"RTN","VPRD",58,0)
 I X["document"     S Y="VPRDTIU",X="documents"
"RTN","VPRD",59,0)
 I X["factor"       S Y="VPRDPXHF",X="healthFactors"
"RTN","VPRD",60,0)
 I X["flag"         S Y="VPRDGPF",X="flags"
"RTN","VPRD",61,0)
 I X["immunization" S Y="VPRDPXIM",X="immunizations"
"RTN","VPRD",62,0)
 I X["skin"         S Y="VPRDPXSK",X="skinTests"
"RTN","VPRD",63,0)
 I X?1"exam".E      S Y="VPRDPXAM",X="exams"
"RTN","VPRD",64,0)
 I X["educat"       S Y="VPRDPXED",X="educationTopics"
"RTN","VPRD",65,0)
 I X["insur"        S Y="VPRDIB",X="insurancePolicies"
"RTN","VPRD",66,0)
 I X["polic"        S Y="VPRDIB",X="insurancePolicies"
"RTN","VPRD",67,0)
 I X["lab"          S Y="VPRDLR",X="labs"
"RTN","VPRD",68,0)
 I X["panel"        S Y="VPRDLRO",X="panels"
"RTN","VPRD",69,0)
 I X["med"          S Y="VPRDPS",X="meds"
"RTN","VPRD",70,0)
 I X["pharm"        S Y="VPRDPSOR",X="meds"
"RTN","VPRD",71,0)
 I X["observ"       S Y="VPRDMDC",X="observations"
"RTN","VPRD",72,0)
 I X["order"        S Y="VPRDOR",X="orders"
"RTN","VPRD",73,0)
 I X["patient"      S Y="VPRDPT",X="demographics"
"RTN","VPRD",74,0)
 I X["problem"      S Y="VPRDGMPL",X="problems"
"RTN","VPRD",75,0)
 I X["procedure"    S Y="VPRDPROC",X="procedures"
"RTN","VPRD",76,0)
 I X["reaction"     S Y="VPRDGMRA",X="reactions"
"RTN","VPRD",77,0)
 I X["surg"         S Y="VPRDSR",X="surgeries"
"RTN","VPRD",78,0)
 I X["visit"        S Y="VPRDVSIT",X="visits"
"RTN","VPRD",79,0)
 I X["vital"        S Y="VPRDGMV",X="vitals"
"RTN","VPRD",80,0)
 I X["rad"          S Y="VPRDRA",X="radiologyExams"
"RTN","VPRD",81,0)
 I X["xray"         S Y="VPRDRA",X="radiologyExams"
"RTN","VPRD",82,0)
 Q Y
"RTN","VPRD",83,0)
 ;
"RTN","VPRD",84,0)
TAG(X) ; -- return plural name for group tags
"RTN","VPRD",85,0)
 N Y S:X'?1.L X=$$LOW^XLFSTR(X)
"RTN","VPRD",86,0)
 I $E(X,$L(X))="s" S Y=X
"RTN","VPRD",87,0)
 I $E(X,$L(X))="y" S Y=$E(X,1,$L(X)-1)_"ies"
"RTN","VPRD",88,0)
 E  S Y=X_"s"
"RTN","VPRD",89,0)
 Q Y
"RTN","VPRD",90,0)
 ;
"RTN","VPRD",91,0)
ALL() ; -- return string for all types of data
"RTN","VPRD",92,0)
 Q "demographics;reactions;problems;vitals;labs;meds;immunizations;observation;visits;appointments;documents;procedures;consults;flags;factors;skinTests;exams;education;insurance"
"RTN","VPRD",93,0)
 ;
"RTN","VPRD",94,0)
ERR(X,VAL) ; -- return error message
"RTN","VPRD",95,0)
 N MSG  S MSG="Error"
"RTN","VPRD",96,0)
 I X=1  S MSG="Patient with DFN '"_$G(VAL)_"' not found"
"RTN","VPRD",97,0)
 I X=2  S MSG="Requested domain type '"_$G(VAL)_"' not recognized"
"RTN","VPRD",98,0)
 I X=99 S MSG="Unknown request"
"RTN","VPRD",99,0)
 ;
"RTN","VPRD",100,0)
 D ADD("<error>")
"RTN","VPRD",101,0)
 D ADD("<message>"_MSG_"</message>")
"RTN","VPRD",102,0)
 D ADD("</error>")
"RTN","VPRD",103,0)
 Q
"RTN","VPRD",104,0)
 ;
"RTN","VPRD",105,0)
ESC(X) ; -- escape outgoing XML
"RTN","VPRD",106,0)
 ; Q $ZCONVERT(X,"O","HTML")  ; uncomment for fastest performance on Cache
"RTN","VPRD",107,0)
 ;
"RTN","VPRD",108,0)
 N I,Y,QOT S QOT=""""
"RTN","VPRD",109,0)
 S Y=$P(X,"&") F I=2:1:$L(X,"&") S Y=Y_"&amp;"_$P(X,"&",I)
"RTN","VPRD",110,0)
 S X=Y,Y=$P(X,"<") F I=2:1:$L(X,"<") S Y=Y_"&lt;"_$P(X,"<",I)
"RTN","VPRD",111,0)
 S X=Y,Y=$P(X,">") F I=2:1:$L(X,">") S Y=Y_"&gt;"_$P(X,">",I)
"RTN","VPRD",112,0)
 S X=Y,Y=$P(X,"'") F I=2:1:$L(X,"'") S Y=Y_"&apos;"_$P(X,"'",I)
"RTN","VPRD",113,0)
 S X=Y,Y=$P(X,QOT) F I=2:1:$L(X,QOT) S Y=Y_"&quot;"_$P(X,QOT,I)
"RTN","VPRD",114,0)
 Q Y
"RTN","VPRD",115,0)
 ;
"RTN","VPRD",116,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRD",117,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRD",118,0)
 S @VPR@(VPRI)=X
"RTN","VPRD",119,0)
 Q
"RTN","VPRD",120,0)
 ;
"RTN","VPRD",121,0)
STRING(ARRAY) ; -- Return text in ARRAY(n) or ARRAY(n,0) as a string
"RTN","VPRD",122,0)
 N I,X,Y S Y=""
"RTN","VPRD",123,0)
 S I=+$O(ARRAY("")) I I=0 S I=+$O(ARRAY(0))
"RTN","VPRD",124,0)
 S Y=$S($D(ARRAY(I,0)):ARRAY(I,0),1:$G(ARRAY(I)))
"RTN","VPRD",125,0)
 F  S I=$O(ARRAY(I)) Q:I<1  D
"RTN","VPRD",126,0)
 . S X=$S($D(ARRAY(I,0)):ARRAY(I,0),1:ARRAY(I))
"RTN","VPRD",127,0)
 . I $E(X)=" " S Y=Y_$C(13,10)_X Q
"RTN","VPRD",128,0)
 . S Y=Y_$S($E(Y,$L(Y))=" ":"",1:" ")_X
"RTN","VPRD",129,0)
 Q Y
"RTN","VPRD",130,0)
 ;
"RTN","VPRD",131,0)
FAC(X) ; -- return Institution file station# for location X
"RTN","VPRD",132,0)
 N HLOC,FAC,Y0,Y S Y=""
"RTN","VPRD",133,0)
 S HLOC=$G(^SC(+$G(X),0)),FAC=$P(HLOC,U,4)
"RTN","VPRD",134,0)
 ; Get P:4 via Med Ctr Div, if not directly linked
"RTN","VPRD",135,0)
 I 'FAC,$P(HLOC,U,15) S FAC=$$GET1^DIQ(44,+$G(X)_",","3.5:.07","I")
"RTN","VPRD",136,0)
 S Y0=$S(FAC:$$NS^XUAF4(FAC),1:$P($$SITE^VASITE,U,2,3)) ;name^stn#
"RTN","VPRD",137,0)
 S:$L(Y0) Y=$P(Y0,U,2)_U_$P(Y0,U) ;switch to stn#^name
"RTN","VPRD",138,0)
 I $L(Y),'Y S $P(Y,U)=FAC
"RTN","VPRD",139,0)
 Q Y
"RTN","VPRD",140,0)
 ;
"RTN","VPRD",141,0)
PROVSPC(NP) ; -- Return specialty info for provider NP from 200/8932.1 as
"RTN","VPRD",142,0)
 ; X12 code ^ Provider Type ^ Classification ^ Area of Specialization
"RTN","VPRD",143,0)
 N X,Y,I,CLS S NP=+$G(NP) ;protect I for calling routine
"RTN","VPRD",144,0)
 S X=$$TAXIND^XUSTAX(NP) ;= X12 code ^ Person Class #8932.1 ien
"RTN","VPRD",145,0)
 S Y="^^^" I $P(X,U,2) D
"RTN","VPRD",146,0)
 . S CLS=$G(^USC(8932.1,$P(X,U,2),0)) Q:CLS=""
"RTN","VPRD",147,0)
 . S Y=$P(X,U)_U_$P(CLS,U,1,3)
"RTN","VPRD",148,0)
 Q Y
"RTN","VPRD",149,0)
 ;
"RTN","VPRD",150,0)
VUID(IEN,FILE) ; -- Return VUID for item
"RTN","VPRD",151,0)
 Q $$GET1^DIQ(FILE,IEN_",",99.99)
"RTN","VPRD",152,0)
 ;
"RTN","VPRD",153,0)
VERSION(RET) ; -- Return current version of data extracts
"RTN","VPRD",154,0)
 S RET=$$GET^XPAR("ALL","VPR VERSION")
"RTN","VPRD",155,0)
 Q
"RTN","VPRD",156,0)
 ;
"RTN","VPRD",157,0)
TEST(DFN,TYPE,ID,START,STOP,MAX,TEXT,IN) ; -- test GET, write results to screen
"RTN","VPRD",158,0)
 N OUT,IDX S U="^"
"RTN","VPRD",159,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRD",160,0)
 S TYPE=$G(TYPE) Q:TYPE=""
"RTN","VPRD",161,0)
 D GET(.OUT,DFN,TYPE,$G(START),$G(STOP),$G(MAX),$G(ID),.IN)
"RTN","VPRD",162,0)
 ;
"RTN","VPRD",163,0)
 S IDX=OUT
"RTN","VPRD",164,0)
 F  S IDX=$Q(@IDX) Q:IDX'?1"^TMP(""VPR"","1.N.E  Q:+$P(IDX,",",2)'=$J  W !,@IDX
"RTN","VPRD",165,0)
 Q
"RTN","VPRDGMPL")
0^10^B28051660^B27827751
"RTN","VPRDGMPL",1,0)
VPRDGMPL ;SLC/MKB -- Problem extract ;8/2/11  15:29
"RTN","VPRDGMPL",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,2,4**;Sep 01, 2011;Build 6
"RTN","VPRDGMPL",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDGMPL",4,0)
 ;
"RTN","VPRDGMPL",5,0)
 ; External References          DBIA#
"RTN","VPRDGMPL",6,0)
 ; -------------------          -----
"RTN","VPRDGMPL",7,0)
 ; ^AUPNPROB                     5703
"RTN","VPRDGMPL",8,0)
 ; ^DPT                         10035
"RTN","VPRDGMPL",9,0)
 ; ^VA(200                      10060
"RTN","VPRDGMPL",10,0)
 ; ^WV(790.05                    5772
"RTN","VPRDGMPL",11,0)
 ; %DT                          10003
"RTN","VPRDGMPL",12,0)
 ; DIQ                           2056
"RTN","VPRDGMPL",13,0)
 ; GMPLUTL2                      2741
"RTN","VPRDGMPL",14,0)
 ; SDUTL3                        1252
"RTN","VPRDGMPL",15,0)
 ; XLFDT                        10103
"RTN","VPRDGMPL",16,0)
 ; XUAF4                         2171
"RTN","VPRDGMPL",17,0)
 ;
"RTN","VPRDGMPL",18,0)
 ; ------------ Get problems from VistA ------------
"RTN","VPRDGMPL",19,0)
 ;
"RTN","VPRDGMPL",20,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's problems
"RTN","VPRDGMPL",21,0)
 N VPRSTS,VPRPROB,VPRN,VPRITM,VPRCNT,X
"RTN","VPRDGMPL",22,0)
 ;
"RTN","VPRDGMPL",23,0)
 ; get one problem
"RTN","VPRDGMPL",24,0)
 I $G(IFN)="790.05" D WV(.VPRITM,1),XML(.VPRITM):$D(VPRITM) Q
"RTN","VPRDGMPL",25,0)
 I $G(IFN) D EN1(IFN,.VPRITM),XML(.VPRITM) Q
"RTN","VPRDGMPL",26,0)
 ;
"RTN","VPRDGMPL",27,0)
 ; get all patient problems
"RTN","VPRDGMPL",28,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDGMPL",29,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999),VPRCNT=0
"RTN","VPRDGMPL",30,0)
 S VPRSTS=$G(FILTER("status")) ;default = all problems
"RTN","VPRDGMPL",31,0)
 D LIST^GMPLUTL2(.VPRPROB,DFN,VPRSTS)
"RTN","VPRDGMPL",32,0)
 S VPRN=0 F  S VPRN=$O(VPRPROB(VPRN)) Q:(VPRN<1)!(VPRCNT'<MAX)  D
"RTN","VPRDGMPL",33,0)
 . S X=$P(VPRPROB(VPRN),U,5) I X,(X<BEG)!(X>END) Q  ;onset
"RTN","VPRDGMPL",34,0)
 . S X=+VPRPROB(VPRN) K VPRITM ;ien
"RTN","VPRDGMPL",35,0)
 . D EN1(X,.VPRITM),XML(.VPRITM)
"RTN","VPRDGMPL",36,0)
 . S VPRCNT=VPRCNT+1
"RTN","VPRDGMPL",37,0)
 I $P($G(^DPT(DFN,0)),U,2)="F" D WV(.VPRITM),XML(.VPRITM):$D(VPRITM)
"RTN","VPRDGMPL",38,0)
 Q
"RTN","VPRDGMPL",39,0)
 ;
"RTN","VPRDGMPL",40,0)
EN1(ID,PROB) ; -- return a problem in PROB("attribute")=value
"RTN","VPRDGMPL",41,0)
 N VPRL,X,I,J K PROB
"RTN","VPRDGMPL",42,0)
 S ID=+$G(ID) Q:ID<1  ;invalid ien
"RTN","VPRDGMPL",43,0)
 D DETAIL^GMPLUTL2(ID,.VPRL) Q:'$D(VPRL)  ;doesn't exist
"RTN","VPRDGMPL",44,0)
 S PROB("id")=ID,PROB("name")=$G(VPRL("NARRATIVE"))
"RTN","VPRDGMPL",45,0)
 S X=$G(VPRL("MODIFIED")) S:$L(X) PROB("updated")=$$DATE(X)
"RTN","VPRDGMPL",46,0)
 S PROB("icd")=$G(VPRL("DIAGNOSIS"))
"RTN","VPRDGMPL",47,0)
 F I="SCTC","SCTD","SCTT" S X=$G(VPRL(I)) S:$L(X) PROB($$LOW^XLFSTR(I))=X
"RTN","VPRDGMPL",48,0)
 S X=$G(VPRL("STATUS")) S:$L(X) PROB("status")=$E(X)_U_X
"RTN","VPRDGMPL",49,0)
 S X=$G(VPRL("HISTORY"))  S:$L(X) PROB("history")=$E(X)_U_X
"RTN","VPRDGMPL",50,0)
 S X=$G(VPRL("PRIORITY")) S:$L(X) PROB("acuity")=$E(X)_U_X
"RTN","VPRDGMPL",51,0)
 S X=$G(VPRL("ONSET")) S:$L(X) PROB("onset")=$$DATE(X)
"RTN","VPRDGMPL",52,0)
 S X=$$GET1^DIQ(9000011,ID_",",1.07,"I") S:X PROB("resolved")=X
"RTN","VPRDGMPL",53,0)
 S X=$P($G(VPRL("ENTERED")),U)  S:$L(X) PROB("entered")=$$DATE(X)
"RTN","VPRDGMPL",54,0)
 S X=$$GET1^DIQ(9000011,ID_",",1.02,"I")
"RTN","VPRDGMPL",55,0)
 S:X="P" PROB("unverified")=0,PROB("removed")=0
"RTN","VPRDGMPL",56,0)
 S:X="T" PROB("unverified")=1,PROB("removed")=0
"RTN","VPRDGMPL",57,0)
 S:X="H" PROB("unverified")=0,PROB("removed")=1
"RTN","VPRDGMPL",58,0)
 S X=$G(VPRL("SC")),X=$S(X="YES":1,X="NO":0,1:"")
"RTN","VPRDGMPL",59,0)
 S:$L(X) PROB("sc")=X I $G(VPRL("EXPOSURE")) D   ;ao^rad^pgulf^hnc^mst^cv
"RTN","VPRDGMPL",60,0)
 . S I=0 F  S I=$O(VPRL("EXPOSURE",I)) Q:I<1  D
"RTN","VPRDGMPL",61,0)
 .. S X=$G(VPRL("EXPOSURE",I))
"RTN","VPRDGMPL",62,0)
 .. S PROB("exposure",I)=$$EXP(X)
"RTN","VPRDGMPL",63,0)
 S X=$G(VPRL("PROVIDER")) S:$L(X) PROB("provider")=$$GET1^DIQ(9000011,ID_",",1.05,"I")_U_X
"RTN","VPRDGMPL",64,0)
 S X=$$GET1^DIQ(9000011,ID_",",1.06) S:$L(X) PROB("service")=X
"RTN","VPRDGMPL",65,0)
 S X=$G(VPRL("CLINIC")) S:$L(X) PROB("location")=X
"RTN","VPRDGMPL",66,0)
 S X=+$$GET1^DIQ(9000011,ID_",",.06,"I")
"RTN","VPRDGMPL",67,0)
 S:X PROB("facility")=$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U)
"RTN","VPRDGMPL",68,0)
 I 'X S PROB("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDGMPL",69,0)
CMT ; comments
"RTN","VPRDGMPL",70,0)
 Q:'$G(VPRL("COMMENT"))
"RTN","VPRDGMPL",71,0)
 S I=0 F  S I=$O(VPRL("COMMENT",I)) Q:I<1  D
"RTN","VPRDGMPL",72,0)
 . S X=$G(VPRL("COMMENT",I))
"RTN","VPRDGMPL",73,0)
 . S PROB("comment",I)=$$DATE($P(X,U))_U_$P(X,U,2,3)
"RTN","VPRDGMPL",74,0)
 . ; = date ^ name of author ^ text
"RTN","VPRDGMPL",75,0)
 Q
"RTN","VPRDGMPL",76,0)
 ;
"RTN","VPRDGMPL",77,0)
WV(PROB,UPD) ; -- return a pregnancy log entry in PROB("attribute")=value
"RTN","VPRDGMPL",78,0)
 N I,X0,Y K PROB
"RTN","VPRDGMPL",79,0)
 S I=$O(^WV(790.05,"C",DFN,""),-1) Q:'I    ;last entry
"RTN","VPRDGMPL",80,0)
 S X0=$G(^WV(790.05,I,0)),Y=0
"RTN","VPRDGMPL",81,0)
 ; status=YES, future due date (allow past 14 days)
"RTN","VPRDGMPL",82,0)
 I $P(X0,U,3),$P(X0,U,4)'<$$FMADD^XLFDT(DT,-14) S Y=1
"RTN","VPRDGMPL",83,0)
 I 'Y,'$G(UPD) Q
"RTN","VPRDGMPL",84,0)
 ; continue if pregnant, or update requested
"RTN","VPRDGMPL",85,0)
 S PROB("id")="790.05",PROB("entered")=+X0
"RTN","VPRDGMPL",86,0)
 S PROB("name")="Pregnancy",PROB("icd")="V22.2"
"RTN","VPRDGMPL",87,0)
 ; PROB("problemType")=64572001            ;HITSP/Condition
"RTN","VPRDGMPL",88,0)
 S PROB("status")=$S(Y:"A^ACTIVE",1:"I^INACTIVE")
"RTN","VPRDGMPL",89,0)
 S PROB("resolved")=$P(X0,U,4)             ;due date
"RTN","VPRDGMPL",90,0)
 S PROB("provider")=$$OUTPTPR^SDUTL3(DFN)  ;primary care
"RTN","VPRDGMPL",91,0)
 S PROB("facility")=$$FAC^VPRD
"RTN","VPRDGMPL",92,0)
 Q
"RTN","VPRDGMPL",93,0)
 ;
"RTN","VPRDGMPL",94,0)
DATE(X) ; -- Return internal form of date X
"RTN","VPRDGMPL",95,0)
 N %DT,Y
"RTN","VPRDGMPL",96,0)
 S %DT="" D ^%DT S:Y<1 Y=X
"RTN","VPRDGMPL",97,0)
 Q Y
"RTN","VPRDGMPL",98,0)
 ;
"RTN","VPRDGMPL",99,0)
VA200(X) ; -- Return ien of New Person X
"RTN","VPRDGMPL",100,0)
 N Y S Y=$S($L($G(X)):+$O(^VA(200,"B",X,0)),1:"")
"RTN","VPRDGMPL",101,0)
 Q Y
"RTN","VPRDGMPL",102,0)
 ;
"RTN","VPRDGMPL",103,0)
EXP(X) ; -- Return code for exposure name X
"RTN","VPRDGMPL",104,0)
 N Y S Y="",X=$E($G(X))
"RTN","VPRDGMPL",105,0)
 I X="A" S Y="AO"  ;agent orange
"RTN","VPRDGMPL",106,0)
 I X="R" S Y="IR"  ;ionizing radiation
"RTN","VPRDGMPL",107,0)
 I X="E" S Y="PG"  ;persian gulf
"RTN","VPRDGMPL",108,0)
 I X="H" S Y="HNC" ;head/neck cancer
"RTN","VPRDGMPL",109,0)
 I X="M" S Y="MST" ;military sexual trauma
"RTN","VPRDGMPL",110,0)
 I X="C" S Y="CV"  ;combat vet
"RTN","VPRDGMPL",111,0)
 I X="S" S Y="SHAD"
"RTN","VPRDGMPL",112,0)
 Q Y
"RTN","VPRDGMPL",113,0)
 ;
"RTN","VPRDGMPL",114,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDGMPL",115,0)
 ;
"RTN","VPRDGMPL",116,0)
XML(PROB) ; -- Return patient problem as XML in @VPR@(I)
"RTN","VPRDGMPL",117,0)
 N ATT,I,X,Y,P,TAG
"RTN","VPRDGMPL",118,0)
 D ADD("<problem>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDGMPL",119,0)
 S ATT="" F  S ATT=$O(PROB(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDGMPL",120,0)
 . I ATT="exposure" D  S Y="" Q
"RTN","VPRDGMPL",121,0)
 .. S Y="<exposures>" D ADD(Y)
"RTN","VPRDGMPL",122,0)
 .. S I=0 F  S I=$O(PROB(ATT,I)) Q:I<1  S X=$G(PROB(ATT,I)) S:$L(X) Y="<exposure value='"_X_"' />" D ADD(Y)
"RTN","VPRDGMPL",123,0)
 .. D ADD("</exposures>")
"RTN","VPRDGMPL",124,0)
 . I ATT="comment" D  S Y="" Q
"RTN","VPRDGMPL",125,0)
 .. D ADD("<comments>")
"RTN","VPRDGMPL",126,0)
 .. S I=0 F  S I=$O(PROB(ATT,I)) Q:I<1  S X=$G(PROB(ATT,I)) D
"RTN","VPRDGMPL",127,0)
 ... S Y="<comment id='"_I
"RTN","VPRDGMPL",128,0)
 ... S:$L($P(X,U,1)) Y=Y_"' entered='"_$P(X,U)
"RTN","VPRDGMPL",129,0)
 ... S:$L($P(X,U,2)) Y=Y_"' enteredBy='"_$$ESC^VPRD($P(X,U,2))
"RTN","VPRDGMPL",130,0)
 ... S:$L($P(X,U,3)) Y=Y_"' commentText='"_$$ESC^VPRD($P(X,U,3))
"RTN","VPRDGMPL",131,0)
 ... S Y=Y_"' />" D ADD(Y)
"RTN","VPRDGMPL",132,0)
 .. D ADD("</comments>")
"RTN","VPRDGMPL",133,0)
 . S X=$G(PROB(ATT)),Y="" Q:'$L(X)
"RTN","VPRDGMPL",134,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDGMPL",135,0)
 . I $L(X)>1 D  S Y=""
"RTN","VPRDGMPL",136,0)
 .. S Y="<"_ATT_" "
"RTN","VPRDGMPL",137,0)
 .. F P=1:1 S TAG=$P("code^name^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMPL",138,0)
 .. S Y=Y_"/>" D ADD(Y)
"RTN","VPRDGMPL",139,0)
 D ADD("</problem>")
"RTN","VPRDGMPL",140,0)
 Q
"RTN","VPRDGMPL",141,0)
 ;
"RTN","VPRDGMPL",142,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDGMPL",143,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDGMPL",144,0)
 S @VPR@(VPRI)=X
"RTN","VPRDGMPL",145,0)
 Q
"RTN","VPRDGMRC")
0^13^B12856313^B10880986
"RTN","VPRDGMRC",1,0)
VPRDGMRC ;SLC/MKB -- Consult extract ;8/2/11  15:29
"RTN","VPRDGMRC",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,4**;Sep 01, 2011;Build 6
"RTN","VPRDGMRC",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDGMRC",4,0)
 ;
"RTN","VPRDGMRC",5,0)
 ; External References          DBIA#
"RTN","VPRDGMRC",6,0)
 ; -------------------          -----
"RTN","VPRDGMRC",7,0)
 ; ^TIU(8925.1                   5677
"RTN","VPRDGMRC",8,0)
 ; DIQ                           2056
"RTN","VPRDGMRC",9,0)
 ; GMRCGUIB                      2980
"RTN","VPRDGMRC",10,0)
 ; GMRCSLM1,^TMP("GMRCR",$J)     2740
"RTN","VPRDGMRC",11,0)
 ; TIULQ                         2693
"RTN","VPRDGMRC",12,0)
 ; XUAF4                         2171
"RTN","VPRDGMRC",13,0)
 ;
"RTN","VPRDGMRC",14,0)
 ; ------------ Get consults from VistA ------------
"RTN","VPRDGMRC",15,0)
 ;
"RTN","VPRDGMRC",16,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's consults
"RTN","VPRDGMRC",17,0)
 N VPRN,VPRX,VPRITM K ^TMP("GMRCR",$J,"CS")
"RTN","VPRDGMRC",18,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDGMRC",19,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDGMRC",20,0)
 ;
"RTN","VPRDGMRC",21,0)
 D OER^GMRCSLM1(DFN,"",BEG,END,"")
"RTN","VPRDGMRC",22,0)
 S VPRN=0 F  S VPRN=$O(^TMP("GMRCR",$J,"CS",VPRN)) Q:VPRN<1!(VPRN>MAX)  S VPRX=$G(^(VPRN,0)) Q:$E(VPRX)="<"  D
"RTN","VPRDGMRC",23,0)
 . I $G(IFN),IFN'=+VPRX Q
"RTN","VPRDGMRC",24,0)
 . K VPRITM D EN1(+VPRX,.VPRITM),XML(.VPRITM)
"RTN","VPRDGMRC",25,0)
 K ^TMP("GMRCR",$J,"CS"),^TMP("VPRTEXT",$J)
"RTN","VPRDGMRC",26,0)
 Q
"RTN","VPRDGMRC",27,0)
 ;
"RTN","VPRDGMRC",28,0)
EN1(ID,CONS) ; -- return a consult in CONS("attribute")=value
"RTN","VPRDGMRC",29,0)
 ;     Expects DFN, VPRX=^TMP("GMRCR",$J,"CS",VPRN,0) [from EN]
"RTN","VPRDGMRC",30,0)
 N VPRD,X0,VPRJ,X,VPRTIU,LT,NT
"RTN","VPRDGMRC",31,0)
 K CONS,^TMP("VPRTEXT",$J)
"RTN","VPRDGMRC",32,0)
 S CONS("id")=ID,CONS("requested")=$P(VPRX,U,2)
"RTN","VPRDGMRC",33,0)
 S CONS("status")=$P(VPRX,U,3),CONS("service")=$P(VPRX,U,4)
"RTN","VPRDGMRC",34,0)
 S CONS("procedure")=$P(VPRX,U,5),CONS("name")=$P(VPRX,U,7)
"RTN","VPRDGMRC",35,0)
 I $P(VPRX,U,6)="*" S CONS("result")="SIGNIFICANT FINDINGS"
"RTN","VPRDGMRC",36,0)
 S CONS("orderID")=$P(VPRX,U,8),CONS("type")=$P(VPRX,U,9)
"RTN","VPRDGMRC",37,0)
 D DOCLIST^GMRCGUIB(.VPRD,ID) S X0=$G(VPRD(0)) ;=^GMR(123,ID,0)
"RTN","VPRDGMRC",38,0)
 S X=$P(X0,U,14) S:X CONS("provider")=X_U_$P($G(^VA(200,X,0)),U)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDGMRC",39,0)
 S VPRJ=0 F  S VPRJ=$O(VPRD(50,VPRJ)) Q:VPRJ<1  S X=$G(VPRD(50,VPRJ)) D
"RTN","VPRDGMRC",40,0)
 . Q:'$D(@(U_$P(X,";",2)_+X_")"))  ;text deleted
"RTN","VPRDGMRC",41,0)
 . D EXTRACT^TIULQ(+X,"VPRTIU",,.01)
"RTN","VPRDGMRC",42,0)
 . S LT=$G(VPRTIU(+X,.01,"E")) ;print name
"RTN","VPRDGMRC",43,0)
 . S NT=$$GET1^DIQ(8925.1,+$G(VPRTIU(+X,.01,"I"))_",",1501)
"RTN","VPRDGMRC",44,0)
 . S CONS("document",VPRJ)=+X_U_LT_U_NT
"RTN","VPRDGMRC",45,0)
 . S:$G(VPRTEXT) CONS("document",VPRJ,"content")=$$TEXT^VPRDTIU(X)
"RTN","VPRDGMRC",46,0)
 S X=$P(X0,U,21),CONS("facility")=$S(X:$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U),1:$$FAC^VPRD)
"RTN","VPRDGMRC",47,0)
 Q
"RTN","VPRDGMRC",48,0)
 ;
"RTN","VPRDGMRC",49,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDGMRC",50,0)
 ;
"RTN","VPRDGMRC",51,0)
XML(CONS) ; -- Return patient consult as XML
"RTN","VPRDGMRC",52,0)
 ;  as <element code='123' displayName='ABC' />
"RTN","VPRDGMRC",53,0)
 N ATT,X,Y,I,J,NAMES
"RTN","VPRDGMRC",54,0)
 D ADD("<consult>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDGMRC",55,0)
 S ATT="" F  S ATT=$O(CONS(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDGMRC",56,0)
 . S NAMES=$S(ATT="document":"id^localTitle^nationalTitle",ATT="provider":"code^name^taxonomyCode^providerType^classification^specialization",1:"code^name")_"^Z"
"RTN","VPRDGMRC",57,0)
 . I $O(CONS(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDGMRC",58,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDGMRC",59,0)
 .. S I=0 F  S I=$O(CONS(ATT,I)) Q:I<1  D
"RTN","VPRDGMRC",60,0)
 ... S X=$G(CONS(ATT,I)),Y="<"_ATT_" "_$$LOOP
"RTN","VPRDGMRC",61,0)
 ... S X=$G(CONS(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDGMRC",62,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDGMRC",63,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDGMRC",64,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDGMRC",65,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDGMRC",66,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDGMRC",67,0)
 . S X=$G(CONS(ATT)),Y="" Q:'$L(X)
"RTN","VPRDGMRC",68,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDGMRC",69,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDGMRC",70,0)
 D ADD("</consult>")
"RTN","VPRDGMRC",71,0)
 Q
"RTN","VPRDGMRC",72,0)
 ;
"RTN","VPRDGMRC",73,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDGMRC",74,0)
 N STR,P,TAG S STR=""
"RTN","VPRDGMRC",75,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMRC",76,0)
 Q STR
"RTN","VPRDGMRC",77,0)
 ;
"RTN","VPRDGMRC",78,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDGMRC",79,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDGMRC",80,0)
 S @VPR@(VPRI)=X
"RTN","VPRDGMRC",81,0)
 Q
"RTN","VPRDGMV")
0^8^B42263746^B41671211
"RTN","VPRDGMV",1,0)
VPRDGMV ;SLC/MKB -- Vitals extract ;8/2/11  15:29
"RTN","VPRDGMV",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,4**;Sep 01, 2011;Build 6
"RTN","VPRDGMV",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDGMV",4,0)
 ;
"RTN","VPRDGMV",5,0)
 ; External References          DBIA#
"RTN","VPRDGMV",6,0)
 ; -------------------          -----
"RTN","VPRDGMV",7,0)
 ; ^SC                          10040
"RTN","VPRDGMV",8,0)
 ; ^VA(200                      10060
"RTN","VPRDGMV",9,0)
 ; DILFD                         2055
"RTN","VPRDGMV",10,0)
 ; GMRVUT0,^UTILITY($J,"GMRVD")  1446
"RTN","VPRDGMV",11,0)
 ; GMVGETQL                      5048
"RTN","VPRDGMV",12,0)
 ; GMVGETVT                      5047
"RTN","VPRDGMV",13,0)
 ; GMVRPCM                       5702
"RTN","VPRDGMV",14,0)
 ; GMVUTL                        5046
"RTN","VPRDGMV",15,0)
 ;
"RTN","VPRDGMV",16,0)
 ; ------------ Get vitals from VistA ------------
"RTN","VPRDGMV",17,0)
 ;
"RTN","VPRDGMV",18,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's vitals
"RTN","VPRDGMV",19,0)
 N VPRITM,VPRPARAM,GMRVSTR,IDT,TYPE,VIT,CNT,X0,X,Y,I,N
"RTN","VPRDGMV",20,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDGMV",21,0)
 ;
"RTN","VPRDGMV",22,0)
 ; get one measurement
"RTN","VPRDGMV",23,0)
 I $G(IFN),IFN?7N1"."1.6N S (BEG,END)=IFN K IFN
"RTN","VPRDGMV",24,0)
 I $G(IFN) D EN1(IFN,.VPRITM),XML(.VPRITM) Q
"RTN","VPRDGMV",25,0)
 ;
"RTN","VPRDGMV",26,0)
 ; get all measurements
"RTN","VPRDGMV",27,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDGMV",28,0)
 S GMRVSTR="BP;T;R;P;HT;WT;CVP;CG;PO2;PN",GMRVSTR(0)=BEG_U_END_U_MAX_"^1"
"RTN","VPRDGMV",29,0)
 K ^UTILITY($J,"GMRVD") D EN1^GMRVUT0
"RTN","VPRDGMV",30,0)
 S (IDT,CNT)=0 F  S IDT=$O(^UTILITY($J,"GMRVD",IDT)) Q:IDT<1  D  Q:CNT'<MAX
"RTN","VPRDGMV",31,0)
 . K VIT S VIT("taken")=9999999-IDT,CNT=CNT+1,N=0
"RTN","VPRDGMV",32,0)
 . S TYPE="" F  S TYPE=$O(^UTILITY($J,"GMRVD",IDT,TYPE)) Q:TYPE=""  D
"RTN","VPRDGMV",33,0)
 .. N NAME,VUID,RESULT,UNIT,MRES,MUNT,HIGH,LOW,BMI,QUAL
"RTN","VPRDGMV",34,0)
 .. S IFN=+$O(^UTILITY($J,"GMRVD",IDT,TYPE,0)),X0=$G(^(IFN))
"RTN","VPRDGMV",35,0)
 .. S X=+$P(X0,U,3),NAME=$$FIELD^GMVGETVT(X,1)
"RTN","VPRDGMV",36,0)
 .. S VUID=$$FIELD^GMVGETVT(X,4),RESULT=$P(X0,U,8),UNIT=$$UNIT(TYPE)
"RTN","VPRDGMV",37,0)
 .. S (MRES,MUNT)="" I $L($P(X0,U,13)) D
"RTN","VPRDGMV",38,0)
 ... S X=$S(TYPE="T":"C",TYPE="HT":"cm",TYPE="WT":"kg",TYPE="CG":"cm",1:"")
"RTN","VPRDGMV",39,0)
 ... S MRES=$P(X0,U,13) S:$L(X) MUNT=X
"RTN","VPRDGMV",40,0)
 .. S X=$$RANGE(TYPE),(HIGH,LOW)="" I $L(X) S HIGH=$P(X,U),LOW=$P(X,U,2)
"RTN","VPRDGMV",41,0)
 .. S BMI=$S(TYPE="WT":$P(X0,U,14),1:"")
"RTN","VPRDGMV",42,0)
 .. S N=N+1,VIT("measurement",N)=IFN_U_VUID_U_NAME_U_RESULT_U_UNIT_U_MRES_U_MUNT_U_HIGH_U_LOW_U_BMI
"RTN","VPRDGMV",43,0)
 .. S QUAL=$P(X0,U,17) I $L(QUAL) F I=1:1:$L(QUAL,";") D
"RTN","VPRDGMV",44,0)
 ... S X=$P(QUAL,";",I),Y=$$GETIEN^GMVGETQL(X,1)
"RTN","VPRDGMV",45,0)
 ... I Y S VIT("measurement",N,"qualifier",I)=X_U_$$FIELD^GMVGETQL(Y,3)
"RTN","VPRDGMV",46,0)
 . S VIT("entered")=$P($G(X0),U,4) ;use last one
"RTN","VPRDGMV",47,0)
 . S X=+$P($G(X0),U,5) S:X VIT("location")=$$LOC(X)
"RTN","VPRDGMV",48,0)
 . S VIT("facility")=$$FAC^VPRD(X)
"RTN","VPRDGMV",49,0)
 . D XML(.VIT)
"RTN","VPRDGMV",50,0)
 K ^UTILITY($J,"GMRVD")
"RTN","VPRDGMV",51,0)
 Q
"RTN","VPRDGMV",52,0)
 ;
"RTN","VPRDGMV",53,0)
EN1(ID,VIT) ; -- return a vital/measurement in VIT("attribute")
"RTN","VPRDGMV",54,0)
 K VIT S ID=+$G(ID) Q:ID<1  ;invalid ien
"RTN","VPRDGMV",55,0)
 N VPRY,X0,DFN,TYPE,X,Y,NAME,VUID,RESULT,UNIT,MRES,MUNT,HIGH,LOW,I
"RTN","VPRDGMV",56,0)
 D GETREC^GMVUTL(.VPRY,ID,1) S X0=$G(VPRY(0))
"RTN","VPRDGMV",57,0)
 S DFN=+$P(X0,U,2) Q:DFN<1
"RTN","VPRDGMV",58,0)
 S TYPE=$$FIELD^GMVGETVT(+$P(X0,U,3),2)
"RTN","VPRDGMV",59,0)
 S X=+$P(X0,U,5),VIT("location")=$$LOC(X)
"RTN","VPRDGMV",60,0)
 S VIT("facility")=$$FAC^VPRD(X)
"RTN","VPRDGMV",61,0)
 S NAME=$$FIELD^GMVGETVT($P(X0,U,3),1),VUID=$$FIELD^GMVGETVT($P(X0,U,3),4)
"RTN","VPRDGMV",62,0)
 S X=$P(X0,U,8),RESULT=X,UNIT=$$UNIT(TYPE),(MRES,MUNT)=""
"RTN","VPRDGMV",63,0)
 I TYPE="T"  S MUNT="C",MRES=$J(X-32*5/9,0,1) ;EN1^GMRVUTL
"RTN","VPRDGMV",64,0)
 I TYPE="HT" S MUNT="cm",MRES=$J(2.54*X,0,2)  ;EN2^GMRVUTL
"RTN","VPRDGMV",65,0)
 I TYPE="WT" S MUNT="kg",MRES=$J(X/2.2,0,2)   ;EN3^GMRVUTL
"RTN","VPRDGMV",66,0)
 I TYPE="CG" S MUNT="cm",MRES=$J(2.54*X,0,2)
"RTN","VPRDGMV",67,0)
 S VIT("taken")=+X0,VIT("entered")=+$P(X0,U,4),(HIGH,LOW)=""
"RTN","VPRDGMV",68,0)
 S X=$$RANGE(TYPE) I $L(X) S HIGH=$P(X,U),LOW=$P(X,U,2)
"RTN","VPRDGMV",69,0)
 S VIT("measurement",1)=ID_U_VUID_U_NAME_U_RESULT_U_UNIT_U_MRES_U_MUNT_U_HIGH_U_LOW
"RTN","VPRDGMV",70,0)
 F I=1:1:$L(VPRY(5),U) S X=$P(VPRY(5),U,I),VIT("measurement",1,"qualifier",I)=$$FIELD^GMVGETQL(X,1)_U_$$FIELD^GMVGETQL(X,3) ;name^VUID
"RTN","VPRDGMV",71,0)
 I $G(VPRY(2)) D  ;entered in error/reasons
"RTN","VPRDGMV",72,0)
 . S X=$P(VPRY(2),U,3)
"RTN","VPRDGMV",73,0)
 . F I=1:1:$L(X,"~") S VIT("removed",I)=$$EXTERNAL^DILFD(120.506,.01,,$P(X,"~",I))
"RTN","VPRDGMV",74,0)
 Q
"RTN","VPRDGMV",75,0)
 ;
"RTN","VPRDGMV",76,0)
UNIT(X) ; -- Return unit for vital type X
"RTN","VPRDGMV",77,0)
 N Y S Y=""
"RTN","VPRDGMV",78,0)
 I TYPE="BP"  S Y="mm[Hg]"
"RTN","VPRDGMV",79,0)
 I TYPE="T"   S Y="F"
"RTN","VPRDGMV",80,0)
 I TYPE="R"   S Y="/min"
"RTN","VPRDGMV",81,0)
 I TYPE="P"   S Y="/min"
"RTN","VPRDGMV",82,0)
 I TYPE="HT"  S Y="in"
"RTN","VPRDGMV",83,0)
 I TYPE="WT"  S Y="lb"
"RTN","VPRDGMV",84,0)
 I TYPE="CVP" S Y="cmH2O"
"RTN","VPRDGMV",85,0)
 I TYPE="CG"  S Y="in"
"RTN","VPRDGMV",86,0)
 I TYPE="PO2" S Y="%"
"RTN","VPRDGMV",87,0)
 Q Y
"RTN","VPRDGMV",88,0)
 ;
"RTN","VPRDGMV",89,0)
USER(X) ; -- Return ien^name for person# X
"RTN","VPRDGMV",90,0)
 N Y S X=+$G(X)
"RTN","VPRDGMV",91,0)
 S Y=$S(X:X_U_$P($G(^VA(200,X,0)),U),1:"^")
"RTN","VPRDGMV",92,0)
 Q Y
"RTN","VPRDGMV",93,0)
 ;
"RTN","VPRDGMV",94,0)
LOC(X) ; -- Return ien^name for hospital location X
"RTN","VPRDGMV",95,0)
 N Y S X=+$G(X)
"RTN","VPRDGMV",96,0)
 S Y=$S(X:X_U_$P($G(^SC(X,0)),U),1:"^")
"RTN","VPRDGMV",97,0)
 Q Y
"RTN","VPRDGMV",98,0)
 ;
"RTN","VPRDGMV",99,0)
RANGE(TYPE) ; -- return high^low range of values for TYPE
"RTN","VPRDGMV",100,0)
 N Y I '$D(VPRPARAM(TYPE)) D  ;get parameter values
"RTN","VPRDGMV",101,0)
 . N VPRFLDS,VPRI,VPRY,VPRN,VPRX,X
"RTN","VPRDGMV",102,0)
 . S VPRFLDS=$S(TYPE="T":"5.1^5.2",TYPE="P":"5.3^5.4",TYPE="R":"5.5^5.6",TYPE="CVP":"6.1^6.2",TYPE="PO2":6.3,TYPE="BP":"5.7^5.71^5.8^5.81",1:"") Q:VPRFLDS=""
"RTN","VPRDGMV",103,0)
 . F VPRI=1:1:$L(VPRFLDS,U) S VPRN=$P(VPRFLDS,U,VPRI) D RPC^GMVRPCM(.VPRY,"GETHILO",VPRN) S VPRX(VPRN)=$G(@VPRY@(0))
"RTN","VPRDGMV",104,0)
 . I TYPE="T" S VPRPARAM(TYPE)=$G(VPRX(5.1))_U_$G(VPRX(5.2))
"RTN","VPRDGMV",105,0)
 . I TYPE="P" S VPRPARAM(TYPE)=$G(VPRX(5.3))_U_$G(VPRX(5.4))
"RTN","VPRDGMV",106,0)
 . I TYPE="R" S VPRPARAM(TYPE)=$G(VPRX(5.5))_U_$G(VPRX(5.6))
"RTN","VPRDGMV",107,0)
 . I TYPE="CVP" S VPRPARAM(TYPE)=$G(VPRX(6.1))_U_$G(VPRX(6.2))
"RTN","VPRDGMV",108,0)
 . I TYPE="PO2" S VPRPARAM(TYPE)="100^"_$G(VPRX(6.3))
"RTN","VPRDGMV",109,0)
 . I TYPE="BP" S VPRPARAM(TYPE)=$G(VPRX(5.7))_"/"_$G(VPRX(5.71))_U_$G(VPRX(5.8))_"/"_$G(VPRX(5.81))
"RTN","VPRDGMV",110,0)
 S Y=$G(VPRPARAM(TYPE))
"RTN","VPRDGMV",111,0)
 Q Y
"RTN","VPRDGMV",112,0)
 ;
"RTN","VPRDGMV",113,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDGMV",114,0)
 ;
"RTN","VPRDGMV",115,0)
NAME(X) ; -- Return name of measurement type X for XML element
"RTN","VPRDGMV",116,0)
 N Y S X=$G(X),Y=""
"RTN","VPRDGMV",117,0)
 S Y=$S(X="BP":"bloodPressure",X="T":"temperature",X="R":"respiration",X="P":"pulse",X="HT":"height",X="WT":"weight",X="CVP":"centralVenousPressure",X="CG":"circumferenceGirth",X="PO2":"pulseOximetry",X="PN":"pain",1:"")
"RTN","VPRDGMV",118,0)
 Q Y
"RTN","VPRDGMV",119,0)
 ;
"RTN","VPRDGMV",120,0)
XML(VIT) ; -- Return vital measurement as XML in @VPR@(#)
"RTN","VPRDGMV",121,0)
 N ATT,X,Y,I,J,P,NAMES,TAG
"RTN","VPRDGMV",122,0)
 D ADD("<vital>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDGMV",123,0)
 S ATT="" F  S ATT=$O(VIT(ATT)) Q:ATT=""  D
"RTN","VPRDGMV",124,0)
 . I ATT="measurement" D  Q
"RTN","VPRDGMV",125,0)
 .. D ADD("<measurements>")
"RTN","VPRDGMV",126,0)
 .. S NAMES="id^vuid^name^value^units^metricValue^metricUnits^high^low^bmi^Z"
"RTN","VPRDGMV",127,0)
 .. S I=0 F  S I=$O(VIT(ATT,I)) Q:I<1  D
"RTN","VPRDGMV",128,0)
 ... S X=$G(VIT(ATT,I)),Y="<"_ATT_" "
"RTN","VPRDGMV",129,0)
 ... F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMV",130,0)
 ... I '$D(VIT(ATT,I,"qualifier")) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDGMV",131,0)
 ... S Y=Y_">" D ADD(Y),ADD("<qualifiers>")
"RTN","VPRDGMV",132,0)
 ... S J=0 F  S J=$O(VIT(ATT,I,"qualifier",J)) Q:J<1  D
"RTN","VPRDGMV",133,0)
 .... S Y="<qualifier ",X=$G(VIT(ATT,I,"qualifier",J))
"RTN","VPRDGMV",134,0)
 .... F P=1:1 S TAG=$P("name^vuid^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMV",135,0)
 .... S Y=Y_"/>" D ADD(Y)
"RTN","VPRDGMV",136,0)
 ... D ADD("</qualifiers>"),ADD("</measurement>")
"RTN","VPRDGMV",137,0)
 .. D ADD("</measurements>")
"RTN","VPRDGMV",138,0)
 . I ATT="removed" D  Q
"RTN","VPRDGMV",139,0)
 .. D ADD("<removed>")
"RTN","VPRDGMV",140,0)
 .. S I=0 F  S I=$O(VIT(ATT,I)) Q:I<1  S Y="<reason value='"_$G(VIT(ATT,I))_"' />" D ADD(Y)
"RTN","VPRDGMV",141,0)
 .. D ADD("</removed>")
"RTN","VPRDGMV",142,0)
 . S X=$G(VIT(ATT)),Y="" Q:'$L(X)
"RTN","VPRDGMV",143,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" D ADD(Y) Q
"RTN","VPRDGMV",144,0)
 . I $L(X)>1 D
"RTN","VPRDGMV",145,0)
 .. S Y="<"_ATT_" "
"RTN","VPRDGMV",146,0)
 .. F P=1:1 S TAG=$P("code^name^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMV",147,0)
 .. S Y=Y_"/>" D ADD(Y)
"RTN","VPRDGMV",148,0)
 D ADD("</vital>")
"RTN","VPRDGMV",149,0)
 Q
"RTN","VPRDGMV",150,0)
 ;
"RTN","VPRDGMV",151,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDGMV",152,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDGMV",153,0)
 S @VPR@(VPRI)=X
"RTN","VPRDGMV",154,0)
 Q
"RTN","VPRDOR")
0^2^B17346787^B13221791
"RTN","VPRDOR",1,0)
VPRDOR ;SLC/MKB -- Orders extract ;8/2/11  15:29
"RTN","VPRDOR",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,4**;Sep 01, 2011;Build 6
"RTN","VPRDOR",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDOR",4,0)
 ;
"RTN","VPRDOR",5,0)
 ; External References          DBIA#
"RTN","VPRDOR",6,0)
 ; -------------------          -----
"RTN","VPRDOR",7,0)
 ; ^ORA(102.4)                   5769
"RTN","VPRDOR",8,0)
 ; ^ORD(100.98)                   873
"RTN","VPRDOR",9,0)
 ; ^SC                          10040
"RTN","VPRDOR",10,0)
 ; ^VA(200)                     10060
"RTN","VPRDOR",11,0)
 ; DIQ                           2056
"RTN","VPRDOR",12,0)
 ; ORQ1,^TMP("ORR",$J)           3154
"RTN","VPRDOR",13,0)
 ; ORQ12,^TMP("ORGOTIT",$J)      5704
"RTN","VPRDOR",14,0)
 ; ORX8                          2467
"RTN","VPRDOR",15,0)
 ;
"RTN","VPRDOR",16,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDOR",17,0)
 ;
"RTN","VPRDOR",18,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find a patient's orders
"RTN","VPRDOR",19,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDOR",20,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDOR",21,0)
 N ORLIST,ORDG,ORFLG,MULT,VPRN,VPRITM,VPRCNT
"RTN","VPRDOR",22,0)
 ;
"RTN","VPRDOR",23,0)
 ; get one order
"RTN","VPRDOR",24,0)
 I $G(IFN) D  G ENQ
"RTN","VPRDOR",25,0)
 . N ORLST S ORLST=0,ORLIST=$H
"RTN","VPRDOR",26,0)
 . D GET^ORQ12(+IFN,ORLIST,1,$P(IFN,";",2)) S VPRN=1
"RTN","VPRDOR",27,0)
 . D EN1(VPRN,.VPRITM),XML(.VPRITM)
"RTN","VPRDOR",28,0)
 . K ^TMP("ORGOTIT",$J)
"RTN","VPRDOR",29,0)
 ;
"RTN","VPRDOR",30,0)
 ; get [all] orders
"RTN","VPRDOR",31,0)
 S ORDG=$G(FILTER("group"),"ALL"),ORDG=+$O(^ORD(100.98,"B",ORDG,0))
"RTN","VPRDOR",32,0)
 S ORFLG=+$G(FILTER("view"),6) ;default = Recent Activity
"RTN","VPRDOR",33,0)
 S MULT=$S("^1^6^8^9^10^11^13^14^20^22^"[(U_ORFLG_U):1,1:0)
"RTN","VPRDOR",34,0)
 D EN^ORQ1(DFN_";DPT(",ORDG,ORFLG,,BEG,END,1,MULT) S VPRCNT=0
"RTN","VPRDOR",35,0)
 S VPRN=0 F  S VPRN=$O(^TMP("ORR",$J,ORLIST,VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDOR",36,0)
 . K VPRITM D EN1(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDOR",37,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDOR",38,0)
ENQ ; end
"RTN","VPRDOR",39,0)
 K ^TMP("ORR",$J),^TMP("VPRTEXT",$J)
"RTN","VPRDOR",40,0)
 Q
"RTN","VPRDOR",41,0)
 ;
"RTN","VPRDOR",42,0)
EN1(NUM,ORD) ; -- return an order in ORD("attribute")=value
"RTN","VPRDOR",43,0)
 ;  from EN: expects ^TMP("ORR",$J,ORLIST,VPRN)
"RTN","VPRDOR",44,0)
 N X0,IFN,LOC,X,DA
"RTN","VPRDOR",45,0)
 K ORD,^TMP("VPRTEXT",$J)
"RTN","VPRDOR",46,0)
 S X0=$G(^TMP("ORR",$J,ORLIST,NUM)),IFN=$P(X0,U)
"RTN","VPRDOR",47,0)
 S ORD("id")=IFN,ORD("name")=$P($$OI^ORX8(+IFN),U,1,2)
"RTN","VPRDOR",48,0)
 S ORD("group")=$P(X0,U,2),ORD("entered")=$P(X0,U,3)
"RTN","VPRDOR",49,0)
 S ORD("start")=$P(X0,U,4),ORD("stop")=$P(X0,U,5)
"RTN","VPRDOR",50,0)
 S ORD("status")=$P(X0,U,7)_U_$P(X0,U,6)_U_$$STS($P(X0,U,7))
"RTN","VPRDOR",51,0)
 M ^TMP("VPRTEXT",$J,IFN)=^TMP("ORR",$J,ORLIST,VPRN,"TX")
"RTN","VPRDOR",52,0)
 S ORD("content")=$NA(^TMP("VPRTEXT",$J,IFN))
"RTN","VPRDOR",53,0)
 S X=+$$GET1^DIQ(100,+IFN_",",1,"I")
"RTN","VPRDOR",54,0)
 S:X ORD("provider")=X_U_$P($G(^VA(200,X,0)),U)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDOR",55,0)
 S X=$$GET1^DIQ(100,+IFN_",",6),LOC="" I $L(X) D
"RTN","VPRDOR",56,0)
 . S LOC=+$O(^SC("B",X,0)),ORD("location")=LOC_U_X
"RTN","VPRDOR",57,0)
 S ORD("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDOR",58,0)
 S ORD("service")=$$GET1^DIQ(100,+IFN_",","12:1")
"RTN","VPRDOR",59,0)
 S X=$P(X0,U,2),X=$S($L(X):+$O(^ORD(100.98,"B",X,0)),1:0)
"RTN","VPRDOR",60,0)
 S:X ORD("type")=$P($G(^ORD(100.98,X,0)),U,2)
"RTN","VPRDOR",61,0)
 ; acknowledgements
"RTN","VPRDOR",62,0)
 S DA=0 F  S DA=$O(^ORA(102.4,"B",+IFN,DA)) Q:DA<1  D
"RTN","VPRDOR",63,0)
 . S X0=$G(^ORA(102.4,DA,0)) Q:'$P(X0,U,3)  ;stub - not ack'd
"RTN","VPRDOR",64,0)
 . S X=+$P(X0,U,2),X=$S(X:X_U_$P($G(^VA(200,X,0)),U),1:U)
"RTN","VPRDOR",65,0)
 . S ORD("acknowledgement",DA)=X_U_$P(X0,U,3)
"RTN","VPRDOR",66,0)
 Q
"RTN","VPRDOR",67,0)
 ;
"RTN","VPRDOR",68,0)
STS(X) ; -- return VUID for status abbreviation X
"RTN","VPRDOR",69,0)
 N Y,I,STS
"RTN","VPRDOR",70,0)
 S STS="dc^comp^hold^flag^pend^actv^exp^schd^part^dlay^unr^dc/e^canc^laps^rnew^none"
"RTN","VPRDOR",71,0)
 F I=1:1:16 Q:$P(STS,U,I)=X
"RTN","VPRDOR",72,0)
 S Y=$$VUID^VPRD(I,100.01)
"RTN","VPRDOR",73,0)
 Q Y
"RTN","VPRDOR",74,0)
 ;
"RTN","VPRDOR",75,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDOR",76,0)
 ;
"RTN","VPRDOR",77,0)
XML(ORD) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDOR",78,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDOR",79,0)
 N ATT,X,Y,I,NAMES
"RTN","VPRDOR",80,0)
 D ADD("<order>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDOR",81,0)
 S ATT="" F  S ATT=$O(ORD(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDOR",82,0)
 . S NAMES="code^name"_$S(ATT?1"ack".E:"^date",ATT="status":"^vuid",ATT="provider":"^taxonomyCode^providerType^classification^specialization",1:"")_"^Z"
"RTN","VPRDOR",83,0)
 . I ATT?1"ack".E D  S Y="" Q
"RTN","VPRDOR",84,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDOR",85,0)
 .. S I=0 F  S I=$O(ORD(ATT,I)) Q:I<1  D
"RTN","VPRDOR",86,0)
 ... S X=$G(ORD(ATT,I))
"RTN","VPRDOR",87,0)
 ... S Y="<"_ATT_" "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDOR",88,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDOR",89,0)
 . S X=$G(ORD(ATT)),Y="" Q:'$L(X)
"RTN","VPRDOR",90,0)
 . I ATT="content" D  S Y="" Q  ;text
"RTN","VPRDOR",91,0)
 .. S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDOR",92,0)
 .. S I=0 F  S I=$O(@X@(I)) Q:I<1  S Y=$$ESC^VPRD(@X@(I)) D ADD(Y)
"RTN","VPRDOR",93,0)
 .. D ADD("</content>")
"RTN","VPRDOR",94,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDOR",95,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDOR",96,0)
 D ADD("</order>")
"RTN","VPRDOR",97,0)
 Q
"RTN","VPRDOR",98,0)
 ;
"RTN","VPRDOR",99,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDOR",100,0)
 N STR,P,TAG S STR=""
"RTN","VPRDOR",101,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDOR",102,0)
 Q STR
"RTN","VPRDOR",103,0)
 ;
"RTN","VPRDOR",104,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDOR",105,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDOR",106,0)
 S @VPR@(VPRI)=X
"RTN","VPRDOR",107,0)
 Q
"RTN","VPRDPS")
0^3^B20707464^B18817165
"RTN","VPRDPS",1,0)
VPRDPS ;SLC/MKB -- Pharmacy extract ;8/2/11  15:29
"RTN","VPRDPS",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,4**;Sep 01, 2011;Build 6
"RTN","VPRDPS",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPS",4,0)
 ;
"RTN","VPRDPS",5,0)
 ; External References          DBIA#
"RTN","VPRDPS",6,0)
 ; -------------------          -----
"RTN","VPRDPS",7,0)
 ; ^OR(100)                      5771
"RTN","VPRDPS",8,0)
 ; ORX8                          2467
"RTN","VPRDPS",9,0)
 ; PSOORRL,^TMP("PS",$J)         2400
"RTN","VPRDPS",10,0)
 ; PSS50,^TMP($J                 4533
"RTN","VPRDPS",11,0)
 ; PSS50P7,^TMP($J               4662
"RTN","VPRDPS",12,0)
 ; PSSDI                         4551
"RTN","VPRDPS",13,0)
 ;
"RTN","VPRDPS",14,0)
 ; ------------ Get medications from VistA ------------
"RTN","VPRDPS",15,0)
 ;
"RTN","VPRDPS",16,0)
EN(DFN,BEG,END,MAX,ORIFN) ; -- find patient's meds
"RTN","VPRDPS",17,0)
 N PS0,VPRN,VPRITM,TYPE,ID K ^TMP("PS",$J)
"RTN","VPRDPS",18,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDPS",19,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDPS",20,0)
 ;
"RTN","VPRDPS",21,0)
 ; get one med
"RTN","VPRDPS",22,0)
 I $G(ORIFN) D EN1^VPRDPSOR(ORIFN,.VPRITM),XML(.VPRITM):$D(VPRITM) Q
"RTN","VPRDPS",23,0)
 ;
"RTN","VPRDPS",24,0)
 ; get all meds
"RTN","VPRDPS",25,0)
 D OCL^PSOORRL(DFN,BEG,END) M ^TMP("VPRPS",$J)=^TMP("PS",$J)
"RTN","VPRDPS",26,0)
 S TYPE=$G(FILTER("vaType"))
"RTN","VPRDPS",27,0)
 S VPRN=0 F  S VPRN=$O(^TMP("VPRPS",$J,VPRN)) Q:VPRN<1!(VPRN>MAX)  S PS0=$G(^(VPRN,0)) D  I $D(VPRITM)>9 D XML(.VPRITM)
"RTN","VPRDPS",28,0)
 . S ID=$P(PS0,U),ORIFN=+$P(PS0,U,8) K VPRITM
"RTN","VPRDPS",29,0)
 . Q:'ORIFN!'$D(^OR(100,ORIFN,0))
"RTN","VPRDPS",30,0)
 . I $L(TYPE) Q:'$$MATCH
"RTN","VPRDPS",31,0)
 . D:ORIFN EN1^VPRDPSOR(ORIFN,.VPRITM)
"RTN","VPRDPS",32,0)
 K ^TMP("VPRPS",$J),^TMP("PS",$J),^TMP($J,"PSOI")
"RTN","VPRDPS",33,0)
 Q
"RTN","VPRDPS",34,0)
 ;
"RTN","VPRDPS",35,0)
MATCH() ; -- Return 1 or 0, if order matches FILTER criteria
"RTN","VPRDPS",36,0)
 N Y S Y=0
"RTN","VPRDPS",37,0)
 I ID["O" D
"RTN","VPRDPS",38,0)
 . I TYPE="N",ID["N" S Y=1 Q
"RTN","VPRDPS",39,0)
 . I TYPE="O",ID'["N" S Y=1 Q
"RTN","VPRDPS",40,0)
 . ; TYPE="S",ID'["N",$$SUPPLY(ORIFN) S Y=1 Q
"RTN","VPRDPS",41,0)
 I ID["I" D
"RTN","VPRDPS",42,0)
 . N IV S IV=$S(ID["V":1,$G(^TMP("VPRPS",$J,VPRN,"B",0)):1,1:0)
"RTN","VPRDPS",43,0)
 . I TYPE="V",IV S Y=1
"RTN","VPRDPS",44,0)
 . I TYPE="I",'IV S Y=1
"RTN","VPRDPS",45,0)
 Q Y
"RTN","VPRDPS",46,0)
 ;
"RTN","VPRDPS",47,0)
SUPPLY(ORDER) ; -- Return 1 or 0, if ORDER is for a supply item
"RTN","VPRDPS",48,0)
 N OI,Y S OI=$$OI^ORX8(ORDER),Y=0
"RTN","VPRDPS",49,0)
 D ZERO^PSS50P7(+$P(OI,U,3),,,"PSOI")
"RTN","VPRDPS",50,0)
 S Y=+$G(^TMP($J,"PSOI",+$P(OI,U,3),.09))
"RTN","VPRDPS",51,0)
 Q Y
"RTN","VPRDPS",52,0)
 ;
"RTN","VPRDPS",53,0)
NDF(DRUG,VPI,ORD) ; -- Set NDF data for dispense DRUG ien
"RTN","VPRDPS",54,0)
 N VPRX,STR,VUID,X,I
"RTN","VPRDPS",55,0)
 S DRUG=+$G(DRUG) Q:'DRUG
"RTN","VPRDPS",56,0)
 D EN^PSSDI(50,,50,"901;902",DRUG,"VPRX")
"RTN","VPRDPS",57,0)
 S STR=$S($G(VPRX(50,DRUG,901)):$G(VPRX(50,DRUG,901))_" "_$G(VPRX(50,DRUG,902)),1:"")
"RTN","VPRDPS",58,0)
 D NDF^PSS50(DRUG,,,,,"NDF") S VPI=+$G(VPI,1)
"RTN","VPRDPS",59,0)
 S MED("product",VPI)=DRUG_U_$G(^TMP($J,"NDF",DRUG,.01))_"^^D^"_STR_U_$G(ORD) ;Drug
"RTN","VPRDPS",60,0)
 S X=$G(^TMP($J,"NDF",DRUG,20)) ;VA Generic
"RTN","VPRDPS",61,0)
 S MED("product",VPI,"G")=X_U_$$VUID^VPRD(+X,50.6)
"RTN","VPRDPS",62,0)
 S X=$G(^TMP($J,"NDF",DRUG,22)) ;VA Product
"RTN","VPRDPS",63,0)
 S MED("product",VPI,"P")=X_U_$$VUID^VPRD(+X,50.68)
"RTN","VPRDPS",64,0)
 S X=$G(^TMP($J,"NDF",DRUG,25)) ;VA Drug Class
"RTN","VPRDPS",65,0)
 S MED("product",VPI,"C")=$P(X,U,2,3)_U_$$VUID^VPRD(+X,50.605)
"RTN","VPRDPS",66,0)
 K ^TMP($J,"NDF",DRUG)
"RTN","VPRDPS",67,0)
 Q
"RTN","VPRDPS",68,0)
 ;
"RTN","VPRDPS",69,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPS",70,0)
 ;
"RTN","VPRDPS",71,0)
XML(MED) ; -- Return patient meds as XML
"RTN","VPRDPS",72,0)
 N ATT,X,Y,I,NAMES
"RTN","VPRDPS",73,0)
 D ADD("<med>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPS",74,0)
 S ATT="" F  S ATT=$O(MED(ATT)) Q:ATT=""  D  I $L(Y) D ADD(Y)
"RTN","VPRDPS",75,0)
 . I $O(MED(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDPS",76,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDPS",77,0)
 .. S I=0 F  S I=$O(MED(ATT,I)) Q:I<1  D
"RTN","VPRDPS",78,0)
 ... S X=$G(MED(ATT,I)),NAMES=""
"RTN","VPRDPS",79,0)
 ... I ATT="dose" S NAMES="dose^units^unitsPerDose^noun^route^schedule^duration^conjunction^doseStart^doseStop^order^Z"
"RTN","VPRDPS",80,0)
 ... I ATT="fill" S NAMES="fillDate^fillRouting^releaseDate^fillQuantity^fillDaysSupply^partial^Z"
"RTN","VPRDPS",81,0)
 ... I ATT="product" S NAMES="code^name^vuid^role^concentration^order^Z"
"RTN","VPRDPS",82,0)
 ... S Y="<"_ATT_" "_$$LOOP_$S(ATT'="product":"/>",1:">") D ADD(Y)
"RTN","VPRDPS",83,0)
 ... Q:ATT'="product"
"RTN","VPRDPS",84,0)
 ... S X=$G(MED(ATT,I,"O")) I $L(X) S Y="<ordItem "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPS",85,0)
 ... S X=$G(MED(ATT,I,"C")) I $L(X) S Y="<class "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPS",86,0)
 ... S X=$G(MED(ATT,I,"G")) I $L(X) S Y="<vaGeneric "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPS",87,0)
 ... S X=$G(MED(ATT,I,"P")) I $L(X) S Y="<vaProduct "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPS",88,0)
 ... D ADD("</product>")
"RTN","VPRDPS",89,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDPS",90,0)
 . S X=$G(MED(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPS",91,0)
 . I ATT="sig"!(ATT?1"ptIn"1.A) S Y="<"_ATT_" xml:space='preserve'>"_$$ESC^VPRD(X)_"</"_ATT_">" Q
"RTN","VPRDPS",92,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPS",93,0)
 . I $L(X)>1 S NAMES="code^name"_$S(ATT["Provider":"^taxonomyCode^providerType^classification^specialization",1:"")_"^Z",Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDPS",94,0)
 D ADD("</med>")
"RTN","VPRDPS",95,0)
 Q
"RTN","VPRDPS",96,0)
 ;
"RTN","VPRDPS",97,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDPS",98,0)
 N STR,P,TAG S STR=""
"RTN","VPRDPS",99,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDPS",100,0)
 Q STR
"RTN","VPRDPS",101,0)
 ;
"RTN","VPRDPS",102,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDPS",103,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPS",104,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPS",105,0)
 Q
"RTN","VPRDPSO")
0^12^B16064542^B15569449
"RTN","VPRDPSO",1,0)
VPRDPSO ;SLC/MKB -- Outpatient Pharmacy extract ;8/2/11  15:29
"RTN","VPRDPSO",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,4**;Sep 01, 2011;Build 6
"RTN","VPRDPSO",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPSO",4,0)
 ;
"RTN","VPRDPSO",5,0)
 ; External References          DBIA#
"RTN","VPRDPSO",6,0)
 ; -------------------          -----
"RTN","VPRDPSO",7,0)
 ; PSODI                         4858
"RTN","VPRDPSO",8,0)
 ; PSOORDER,^TMP("PSOR",$J)      1878
"RTN","VPRDPSO",9,0)
 ; PSS50P7                       4662
"RTN","VPRDPSO",10,0)
 ; PSS51P2                       4548
"RTN","VPRDPSO",11,0)
 ; XLFDT                        10103
"RTN","VPRDPSO",12,0)
 ; XLFSTR                       10104
"RTN","VPRDPSO",13,0)
 ;
"RTN","VPRDPSO",14,0)
 ; ------------ Get prescription from VistA ------------
"RTN","VPRDPSO",15,0)
 ;
"RTN","VPRDPSO",16,0)
RX(ID,MED) ; -- return a prescription in MED("attribute")=value
"RTN","VPRDPSO",17,0)
 N RX0,RX1,DRUG,PSOI,X,I,START,STOP,ORIFN,FILL,RFD,PRV K MED
"RTN","VPRDPSO",18,0)
 N VPR ;PSOORDER kills VPR
"RTN","VPRDPSO",19,0)
 K ^TMP("PSOR",$J) D EN^PSOORDER(DFN,+ID)
"RTN","VPRDPSO",20,0)
 S RX0=$G(^TMP("PSOR",$J,+ID,0)),RX1=$G(^(1)),DRUG=$G(^("DRUG",0))
"RTN","VPRDPSO",21,0)
 S MED("medID")=ID_";O",MED("vaType")="O",MED("type")="Prescription"
"RTN","VPRDPSO",22,0)
 S ORIFN=+$P(RX1,U,8) S:ORIFN MED("orderID")=ORIFN
"RTN","VPRDPSO",23,0)
 S PSOI=$G(^TMP("PSOR",$J,+ID,"DRUGOI",0)) I PSOI D
"RTN","VPRDPSO",24,0)
 . S MED("name")=$P(PSOI,";",2)
"RTN","VPRDPSO",25,0)
 . D ZERO^PSS50P7(+PSOI,,,"OI")
"RTN","VPRDPSO",26,0)
 . S MED("form")=$P($G(^TMP($J,"OI",+PSOI,.02)),U,2)
"RTN","VPRDPSO",27,0)
 . S:+$G(^TMP($J,"OI",+PSOI,.09)) MED("supply")=1
"RTN","VPRDPSO",28,0)
 D:DRUG NDF^VPRDPS(+DRUG) ;add NDF data
"RTN","VPRDPSO",29,0)
 S START=$P(RX0,U) S:START MED("start")=START
"RTN","VPRDPSO",30,0)
 S STOP=$P(RX0,U,12) S:STOP MED("stop")=STOP ;_".2359"?
"RTN","VPRDPSO",31,0)
 S X=$$GET1^PSODI(52,+ID_",",26,"I") S:X MED("expires")=$P(X,U,2) ;1^date
"RTN","VPRDPSO",32,0)
 S X=$P(RX0,U,17) S:X MED("ordered")=X
"RTN","VPRDPSO",33,0)
 S MED("vaStatus")=$$UP^XLFSTR($P($P(RX0,U,4),";",2)),X=$P($P(RX0,U,4),";")
"RTN","VPRDPSO",34,0)
 S MED("status")=$S(X="H":"hold",X="DC":"not active",X="D"!(X="E"):"historical",1:"active")
"RTN","VPRDPSO",35,0)
 S MED("quantity")=$P(RX0,U,6),MED("daysSupply")=$P(RX0,U,7)
"RTN","VPRDPSO",36,0)
 S MED("fillsAllowed")=$P(RX0,U,8),MED("fillsRemaining")=$P(RX0,U,9)
"RTN","VPRDPSO",37,0)
 S MED("routing")=$P($P(RX1,U,6),";"),MED("prescription")=$P(RX0,U,5)
"RTN","VPRDPSO",38,0)
 S MED("lastFilled")=$P(RX0,U,3) K FILL
"RTN","VPRDPSO",39,0)
 S I=0 F  S I=$O(^TMP("PSOR",$J,+ID,"REF",I)) Q:I<1  S X=$G(^(I,0)),FILL(+X)=X
"RTN","VPRDPSO",40,0)
 S I=0 F  S I=$O(^TMP("PSOR",$J,+ID,"RPAR",I)) Q:I<1  S X=$G(^(I,0)),$P(X,U,14)=1,FILL(+X)=X
"RTN","VPRDPSO",41,0)
 S (I,RFD,PRV)=0 F  S RFD=$O(FILL(RFD)) Q:RFD<1  S X=$G(FILL(RFD)) D  ;sort 1st
"RTN","VPRDPSO",42,0)
 . N MW,REL S I=I+1
"RTN","VPRDPSO",43,0)
 . S MW=$P($P(X,U,10),";"),REL=$P($P(X,U,8),".")
"RTN","VPRDPSO",44,0)
 . S MED("fill",I)=$P(RFD,".")_U_MW_U_REL_U_$P(X,U,4,5)_$S($P(X,U,14):"^1",1:"")
"RTN","VPRDPSO",45,0)
 . S:$P(X,U,2) PRV=$P(X,U,2) ;save last provider
"RTN","VPRDPSO",46,0)
 . ; fill comments?
"RTN","VPRDPSO",47,0)
 S X=$S($P(RX0,U,11):$P(RX0,U,11),$P(RX0,U,10):$P(RX0,U,10),1:0)
"RTN","VPRDPSO",48,0)
 S:X MED("fillCost")=X
"RTN","VPRDPSO",49,0)
 S X=$G(^TMP("PSOR",$J,+ID,"SIG",1,0)),I=1
"RTN","VPRDPSO",50,0)
 F  S I=$O(^TMP("PSOR",$J,+ID,"SIG",I)) Q:I<1  S X=X_$G(^(I,0))
"RTN","VPRDPSO",51,0)
 S MED("sig")=X
"RTN","VPRDPSO",52,0)
 S X=$G(^TMP("PSOR",$J,+ID,"PI",1,0)),I=1
"RTN","VPRDPSO",53,0)
 F  S I=$O(^TMP("PSOR",$J,+ID,"PI",I)) Q:I<1  S X=X_$G(^(I,0))
"RTN","VPRDPSO",54,0)
 S:$L(X) MED("ptInstructions")=X
"RTN","VPRDPSO",55,0)
 S I=0 F  S I=$O(^TMP("PSOR",$J,+ID,"MI",I)) Q:I<1  S X=$G(^(I,0)) D
"RTN","VPRDPSO",56,0)
 . N UD,NOUN,DOSE,UNIT,RTE,SCH,DUR,CONJ,END
"RTN","VPRDPSO",57,0)
 . S UD=$P(X,U,2),NOUN=$P(X,U,4)
"RTN","VPRDPSO",58,0)
 . S DOSE=$P(X,U),UNIT=$P($P(X,U,3),";",2)
"RTN","VPRDPSO",59,0)
 . S RTE=+$P(X,U,7) D ALL^PSS51P2(RTE,,,,"MR")
"RTN","VPRDPSO",60,0)
 . S RTE=$G(^TMP($J,"MR",RTE,1))
"RTN","VPRDPSO",61,0)
 . S DUR=$P(X,U,5),CONJ=$P(X,U,6),SCH=$P(X,U,8)
"RTN","VPRDPSO",62,0)
 . S END=$S(DUR:$$STOP(START,DUR),1:STOP)
"RTN","VPRDPSO",63,0)
 . S MED("dose",I)=DOSE_U_UNIT_U_UD_U_NOUN_U_RTE_U_SCH_U_DUR_U_CONJ_U_START_U_END
"RTN","VPRDPSO",64,0)
 . I $E(CONJ)="T",DUR S START=END
"RTN","VPRDPSO",65,0)
 S:RX1 X=$TR($P(RX1,U),";","^")_U_$$PROVSPC^VPRD(+RX1),MED("orderingProvider")=X,MED("currentProvider")=X
"RTN","VPRDPSO",66,0)
 S:$G(PRV) MED("currentProvider")=$TR(PRV,";","^")_U_$$PROVSPC^VPRD(+PRV)
"RTN","VPRDPSO",67,0)
 S:$P(RX1,U,9) MED("pharmacist")=$TR($P(RX1,U,9),";","^")
"RTN","VPRDPSO",68,0)
 S:$P(RX1,U,4) MED("location")=$TR($P(RX1,U,4),";","^")
"RTN","VPRDPSO",69,0)
 S MED("facility")=$$FAC^VPRD(+$P(RX1,U,4))
"RTN","VPRDPSO",70,0)
 K ^TMP("PSOR",$J),^TMP($J,"MR"),^TMP($J,"NDF"),^TMP($J,"OI")
"RTN","VPRDPSO",71,0)
 Q
"RTN","VPRDPSO",72,0)
 ;
"RTN","VPRDPSO",73,0)
STOP(BEG,X) ; -- Return date after adding X to BEG
"RTN","VPRDPSO",74,0)
 N D,H,M,UNT,Y
"RTN","VPRDPSO",75,0)
 S Y=BEG,(D,H,M)=0,UNT=$P(X,+X,2),X=+X
"RTN","VPRDPSO",76,0)
 S:$E(UNT)=" " UNT=$E(UNT,2,99) I UNT="" S UNT="D"
"RTN","VPRDPSO",77,0)
 S:UNT="L" D=30*X
"RTN","VPRDPSO",78,0)
 S:UNT="W" D=7*X
"RTN","VPRDPSO",79,0)
 S:UNT="D" D=X
"RTN","VPRDPSO",80,0)
 S:UNT="H" H=X
"RTN","VPRDPSO",81,0)
 S:UNT="M" M=X
"RTN","VPRDPSO",82,0)
 S Y=$$FMADD^XLFDT(BEG,D,H,M)
"RTN","VPRDPSO",83,0)
 Q Y
"RTN","VPRDPSO",84,0)
 ;
"RTN","VPRDPSO",85,0)
ACTIVE(X) ; -- return 1 or 0, if X is an active status
"RTN","VPRDPSO",86,0)
 N Y S Y=1
"RTN","VPRDPSO",87,0)
 I X="PURGE" S Y=0
"RTN","VPRDPSO",88,0)
 I X="DELETED" S Y=0
"RTN","VPRDPSO",89,0)
 I X="EXPIRED" S Y=0 ;keep, to renew?
"RTN","VPRDPSO",90,0)
 I $P(X," ")="DISCONTINUED" S Y=0
"RTN","VPRDPSO",91,0)
 Q Y
"RTN","VPRDPSOR")
0^4^B39578958^B39128356
"RTN","VPRDPSOR",1,0)
VPRDPSOR ;SLC/MKB -- Medication extract by order ;8/2/11  15:29
"RTN","VPRDPSOR",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,4**;Sep 01, 2011;Build 6
"RTN","VPRDPSOR",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPSOR",4,0)
 ;
"RTN","VPRDPSOR",5,0)
 ; External References          DBIA#
"RTN","VPRDPSOR",6,0)
 ; -------------------          -----
"RTN","VPRDPSOR",7,0)
 ; ^OR(100                       5771
"RTN","VPRDPSOR",8,0)
 ; ^ORD(100.98                    873
"RTN","VPRDPSOR",9,0)
 ; ^SC                          10040
"RTN","VPRDPSOR",10,0)
 ; ^VA(200                      10060
"RTN","VPRDPSOR",11,0)
 ; DIQ                           2056
"RTN","VPRDPSOR",12,0)
 ; ORCD                          5493
"RTN","VPRDPSOR",13,0)
 ; ORQ1,^TMP("ORR",$J)           3154
"RTN","VPRDPSOR",14,0)
 ; ORX8                 871,2467,3071
"RTN","VPRDPSOR",15,0)
 ; PSOORRL,^TMP("PS",$J)         2400
"RTN","VPRDPSOR",16,0)
 ; PSS50P7                       4662
"RTN","VPRDPSOR",17,0)
 ; PSS51P2                       4548
"RTN","VPRDPSOR",18,0)
 ;
"RTN","VPRDPSOR",19,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDPSOR",20,0)
 ;
"RTN","VPRDPSOR",21,0)
EN(DFN,BEG,END,MAX,ORIFN) ; -- find a patient's orders
"RTN","VPRDPSOR",22,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDPSOR",23,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDPSOR",24,0)
 N ORDIALOG              ;med dialog array, keep/reuse
"RTN","VPRDPSOR",25,0)
 ;
"RTN","VPRDPSOR",26,0)
 ; get one order
"RTN","VPRDPSOR",27,0)
 I $G(ORIFN) D EN1(ORIFN,.VPRITM),XML^VPRDPS(.VPRITM):$D(VPRITM) Q
"RTN","VPRDPSOR",28,0)
 ;
"RTN","VPRDPSOR",29,0)
 ; get all orders
"RTN","VPRDPSOR",30,0)
 N TYPE,ORDG,ORVP,ORLIST,VPRITM,VPRCNT,VPRN,ORLIST,ORIFN,X3,X4,DAD
"RTN","VPRDPSOR",31,0)
 S TYPE=$G(FILTER("vaType")) S:$L(TYPE) TYPE=$S(TYPE="N":"NV",TYPE="V":"IV",1:TYPE)_" "
"RTN","VPRDPSOR",32,0)
 S ORDG=+$O(^ORD(100.98,"B",TYPE_"RX",0)),ORVP=DFN_";DPT("
"RTN","VPRDPSOR",33,0)
 D EN^ORQ1(ORVP,ORDG,6,,BEG,END)
"RTN","VPRDPSOR",34,0)
 K ^TMP("VPROR",$J) S (VPRCNT,VPRN)=0
"RTN","VPRDPSOR",35,0)
 F  S VPRN=$O(^TMP("ORR",$J,ORLIST,VPRN)) Q:VPRN<1  S ORIFN=$G(^(VPRN)) D  Q:VPRCNT'<MAX
"RTN","VPRDPSOR",36,0)
 . Q:$D(^TMP("VPROR",$J,+ORIFN))  Q:$P(ORIFN,";",2)>1  S ORIFN=+ORIFN
"RTN","VPRDPSOR",37,0)
 . S X3=$G(^OR(100,ORIFN,3)),X4=$G(^(4))
"RTN","VPRDPSOR",38,0)
 . Q:$P(X3,U,3)=13  I X4["P",$P(X3,U,3)=1 Q  ;cancelled
"RTN","VPRDPSOR",39,0)
 . S DAD=$P(X3,U,9) I DAD Q:$D(^TMP("VPROR",$J,DAD))  S ORIFN=DAD
"RTN","VPRDPSOR",40,0)
 . K VPRITM D EN1(ORIFN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPSOR",41,0)
 . D XML^VPRDPS(.VPRITM)
"RTN","VPRDPSOR",42,0)
 . S ^TMP("VPROR",$J,ORIFN)="",VPRCNT=VPRCNT+1
"RTN","VPRDPSOR",43,0)
 K ^TMP("VPROR",$J),^TMP("ORR",$J),^TMP($J,"PSOI")
"RTN","VPRDPSOR",44,0)
 Q
"RTN","VPRDPSOR",45,0)
 ;
"RTN","VPRDPSOR",46,0)
EN1(IFN,MED) ; -- return an order in MED("attribute")=value [from EN]
"RTN","VPRDPSOR",47,0)
 N ORUPCHUK,ORVP,ORPCL,ORPK,ORDUZ,ORODT,ORSTRT,ORSTOP,ORL,ORTO,ORSTS,ORNP,ORPV,ORTX
"RTN","VPRDPSOR",48,0)
 N CLS,OI,X,LOC,DRUG,DA,CNT,VPRESP K MED
"RTN","VPRDPSOR",49,0)
 S IFN=+$G(IFN) I IFN<1!'$D(^OR(100,IFN)) Q
"RTN","VPRDPSOR",50,0)
 S ORPK=$$PKGID^ORX8(IFN)
"RTN","VPRDPSOR",51,0)
 S X=$S(ORPK:$E(ORPK,$L(ORPK)),1:"Z") S:X=+X X="R" ;last char = PS file
"RTN","VPRDPSOR",52,0)
 S CLS=$S("RSN"[X:"O","UV"[X:"I",1:$$GET1^DIQ(100,IFN_",",10,"I"))
"RTN","VPRDPSOR",53,0)
 I CLS="O",ORPK=+ORPK!(ORPK["R") D RX^VPRDPSO(ORPK,.MED) S MED("id")=IFN Q
"RTN","VPRDPSOR",54,0)
 S MED("id")=IFN,MED("orderID")=IFN,MED("vaType")=CLS
"RTN","VPRDPSOR",55,0)
 S:ORPK MED("medID")=ORPK_";"_CLS
"RTN","VPRDPSOR",56,0)
 D EN^ORX8(IFN) S X="" F  S X=$O(ORUPCHUK(X)) Q:X=""  S:$D(ORUPCHUK(X))#2 @X=ORUPCHUK(X)
"RTN","VPRDPSOR",57,0)
 S MED("ordered")=$G(ORODT),MED("orderingProvider")=$G(ORNP)_U_$$PROVSPC^VPRD(+ORNP)
"RTN","VPRDPSOR",58,0)
 S X=$$LASTPROV(IFN),MED("currentProvider")=X_U_$$PROVSPC^VPRD(+X)
"RTN","VPRDPSOR",59,0)
 S MED("start")=$G(ORSTRT),MED("stop")=$G(ORSTOP)
"RTN","VPRDPSOR",60,0)
 S MED("vaStatus")=$P($G(ORSTS),U,2),MED("status")=$$STATUS(+$G(ORSTS))
"RTN","VPRDPSOR",61,0)
 S LOC=+$G(ORL) S:LOC MED("location")=LOC_U_$P(^SC(LOC,0),U)
"RTN","VPRDPSOR",62,0)
 I CLS="I" D
"RTN","VPRDPSOR",63,0)
 . S:$P($G(^SC(+$G(LOC),0)),U,25) MED("IMO")=1
"RTN","VPRDPSOR",64,0)
 . S X=$P($G(^OR(100,IFN,3)),U,9) S:X MED("parent")=X
"RTN","VPRDPSOR",65,0)
 S MED("facility")=$$FAC^VPRD(LOC) I ORPK D
"RTN","VPRDPSOR",66,0)
 . N IFN D OEL^PSOORRL(DFN,ORPK_";"_CLS)
"RTN","VPRDPSOR",67,0)
 I $$IV D IV^VPRDPSI Q
"RTN","VPRDPSOR",68,0)
 S:CLS="O" MED("type")="Prescription"
"RTN","VPRDPSOR",69,0)
 S:ORPK["N" MED("vaType")="N",MED("type")="OTC"
"RTN","VPRDPSOR",70,0)
ENA ; get order responses
"RTN","VPRDPSOR",71,0)
 S OI=$$OI^ORX8(IFN) I OI S MED("name")=$P(OI,U,2) D
"RTN","VPRDPSOR",72,0)
 . D ZERO^PSS50P7(+$P(OI,U,3),,,"PSOI")
"RTN","VPRDPSOR",73,0)
 . S MED("form")=$P($G(^TMP($J,"PSOI",+$P(OI,U,3),.02)),U,2)
"RTN","VPRDPSOR",74,0)
 . S:+$G(^TMP($J,"PSOI",+$P(OI,U,3),.09)) MED("supply")=1
"RTN","VPRDPSOR",75,0)
 D RESP(IFN,.VPRESP) ;order responses
"RTN","VPRDPSOR",76,0)
 S DRUG=+$G(^TMP("PS",$J,"DD",1,0)) S:'DRUG DRUG=+$G(VPRESP("DRUG",1))
"RTN","VPRDPSOR",77,0)
 S MED("sig")=$S(CLS="I":"Give: ",1:"")_$G(VPRESP("SIG",1)) ;ORTX(2)
"RTN","VPRDPSOR",78,0)
 I CLS="I"!(ORPK["N") D  G ENQ ;UD or NVA: single dose, or child orders
"RTN","VPRDPSOR",79,0)
 . I '$O(^OR(100,IFN,2,0)) S MED("dose",1)=$$DOSE(1)_U_$G(ORSTRT)_U_$G(ORSTOP) Q
"RTN","VPRDPSOR",80,0)
 . N DD,CONJ M CONJ=VPRESP("CONJ")
"RTN","VPRDPSOR",81,0)
 . S (DA,CNT)=0 F  S DA=$O(^OR(100,IFN,2,DA)) Q:DA<1  D
"RTN","VPRDPSOR",82,0)
 .. K VPRESP D RESP(DA,.VPRESP)
"RTN","VPRDPSOR",83,0)
 .. S CNT=CNT+1,MED("dose",CNT)=$$DOSE(1)_U_$P($G(^OR(100,DA,0)),U,8,9)_U_DA
"RTN","VPRDPSOR",84,0)
 .. S $P(MED("dose",CNT),U,8)=$G(CONJ(CNT))
"RTN","VPRDPSOR",85,0)
 .. I $P(MED("dose",CNT),U,10)>$G(ORSTOP) S ORSTOP=$P(MED("dose",CNT),U,10)
"RTN","VPRDPSOR",86,0)
 .. S:'DRUG DD=+$G(VPRESP("DRUG",1)),DD(DD,DA)="" ;dispense drug(s)
"RTN","VPRDPSOR",87,0)
 .. ; get ^TMP("PS",$J) from 1st child, if Inpt parent:
"RTN","VPRDPSOR",88,0)
 .. I '$D(^TMP("PS",$J)) S ORPK=$$PKGID^ORX8(DA) D OEL^PSOORRL(DFN,ORPK_";"_CLS)
"RTN","VPRDPSOR",89,0)
 . S MED("stop")=$G(ORSTOP) ;reset from last child order
"RTN","VPRDPSOR",90,0)
 . S DD=$O(DD(0)) I DD,'$O(DD(DD)) S DRUG=DD Q  ;1 drug for order
"RTN","VPRDPSOR",91,0)
 . S (DD,CNT)=0 F  S DD=$O(DD(DD)) Q:DD<1  S DA=0 F  S DA=$O(DD(DD,DA)) Q:DA<1  S CNT=CNT+1 D NDF^VPRDPS(DD,CNT,DA)
"RTN","VPRDPSOR",92,0)
 ; pending Rx: dose(s), qty, etc.
"RTN","VPRDPSOR",93,0)
 S CNT=0 F  S CNT=$O(VPRESP("INSTR",CNT)) Q:CNT<1  S MED("dose",CNT)=$$DOSE(CNT) ;_STRT^STOP
"RTN","VPRDPSOR",94,0)
 S MED("quantity")=$G(VPRESP("QTY",1))
"RTN","VPRDPSOR",95,0)
 S MED("daysSupply")=$G(VPRESP("SUPPLY",1))
"RTN","VPRDPSOR",96,0)
 S MED("routing")=$G(VPRESP("PICKUP",1))
"RTN","VPRDPSOR",97,0)
 S MED("fillsAllowed")=$G(VPRESP("REFILLS",1))
"RTN","VPRDPSOR",98,0)
 S MED("ptInstructions")=$G(VPRESP("PI",1))
"RTN","VPRDPSOR",99,0)
ENQ ; finish
"RTN","VPRDPSOR",100,0)
 D:DRUG NDF^VPRDPS(+DRUG)
"RTN","VPRDPSOR",101,0)
 S X=+$P($G(^TMP("PS",$J,"RXN",0)),U,5)
"RTN","VPRDPSOR",102,0)
 S:X MED("pharmacist")=X_U_$P($G(^VA(200,X,0)),U)
"RTN","VPRDPSOR",103,0)
 K ^TMP("PS",$J),^TMP($J,"PSOI")
"RTN","VPRDPSOR",104,0)
 Q
"RTN","VPRDPSOR",105,0)
 ;
"RTN","VPRDPSOR",106,0)
IV() ; -- Return 1 or 0, if order is for IV/infusion
"RTN","VPRDPSOR",107,0)
 I ORPK["V" Q 1
"RTN","VPRDPSOR",108,0)
 I $P($G(ORTO),U,2)?1"IV".E Q 1
"RTN","VPRDPSOR",109,0)
 I +$G(ORPCL)=130 Q 1
"RTN","VPRDPSOR",110,0)
 I $G(^TMP("PS",$J,"B",0)) Q 1
"RTN","VPRDPSOR",111,0)
 Q 0
"RTN","VPRDPSOR",112,0)
 ;
"RTN","VPRDPSOR",113,0)
DOSE(N) ; --add dosage data from VPRESP(ID,N) [instance N]
"RTN","VPRDPSOR",114,0)
 N DOSE,X,ID S N=+$G(N,1)
"RTN","VPRDPSOR",115,0)
 S DOSE=$P($G(VPRESP("DOSE",N)),"&",1,4),DOSE=$TR(DOSE,"&","^")
"RTN","VPRDPSOR",116,0)
 I '$L($P(DOSE,U)) S DOSE=$G(VPRESP("INSTR",N))_"^^^"
"RTN","VPRDPSOR",117,0)
 S X=+$G(VPRESP("ROUTE",N)) D ALL^PSS51P2(X,,,,"VPRTE")
"RTN","VPRDPSOR",118,0)
 S DOSE=DOSE_U_$G(^TMP($J,"VPRTE",X,1))
"RTN","VPRDPSOR",119,0)
 F ID="SCHEDULE","DAYS","CONJ" S DOSE=DOSE_U_$G(VPRESP(ID,N))
"RTN","VPRDPSOR",120,0)
 K ^TMP($J,"VPRTE")
"RTN","VPRDPSOR",121,0)
 Q DOSE
"RTN","VPRDPSOR",122,0)
 ;
"RTN","VPRDPSOR",123,0)
LASTPROV(IFN) ; -- return last provider who took action on order IFN
"RTN","VPRDPSOR",124,0)
 N I,X,Y S Y="^"
"RTN","VPRDPSOR",125,0)
 S I="A" F  S I=$O(^OR(100,IFN,8,I),-1) Q:I<1  S X=$G(^(I,0)) D  Q:Y
"RTN","VPRDPSOR",126,0)
 . I $P(X,U,5) S Y=+$P(X,U,5) Q  ;signer
"RTN","VPRDPSOR",127,0)
 . I $P(X,U,3) S Y=+$P(X,U,3) Q  ;orderer
"RTN","VPRDPSOR",128,0)
 S:Y Y=Y_U_$P($G(^VA(200,Y,0)),U)
"RTN","VPRDPSOR",129,0)
 Q Y
"RTN","VPRDPSOR",130,0)
 ;
"RTN","VPRDPSOR",131,0)
STRING(IFN,ID) ; -- return text value as a string
"RTN","VPRDPSOR",132,0)
 N DA,I,X,Y
"RTN","VPRDPSOR",133,0)
 S DA=+$O(^OR(100,IFN,4.5,"ID",ID,0)) Q:DA<1 ""
"RTN","VPRDPSOR",134,0)
 S I=+$O(^OR(100,IFN,4.5,DA,2,0)),Y=$G(^(I,0))
"RTN","VPRDPSOR",135,0)
 F  S I=+$O(^OR(100,IFN,4.5,DA,2,I)) Q:I<1  S X=$G(^(I,0)) D
"RTN","VPRDPSOR",136,0)
 . I $E(Y,$L(Y))'=" " S Y=Y_" "
"RTN","VPRDPSOR",137,0)
 . S Y=Y_X
"RTN","VPRDPSOR",138,0)
 Q Y
"RTN","VPRDPSOR",139,0)
 ;
"RTN","VPRDPSOR",140,0)
STATUS(X) ; -- return HITSP status for 100.01 #X
"RTN","VPRDPSOR",141,0)
 S X=+$G(X) S:'X X=99  ;no status
"RTN","VPRDPSOR",142,0)
 I X=3 Q "hold"
"RTN","VPRDPSOR",143,0)
 I X=10!(X=11)!(X=5) Q "not active"
"RTN","VPRDPSOR",144,0)
 I X=1!(X=12)!(X=13) Q "not active"
"RTN","VPRDPSOR",145,0)
 I X=14!(X=99)       Q "not active"
"RTN","VPRDPSOR",146,0)
 I X=2!(X=7)!(X=15)  Q "historical"
"RTN","VPRDPSOR",147,0)
 Q "active"
"RTN","VPRDPSOR",148,0)
 ;
"RTN","VPRDPSOR",149,0)
RESP(ORIFN,RESP) ; -- return order responses [internal form]
"RTN","VPRDPSOR",150,0)
 N VPRDLG,I,J,W,ID,TYPE,X,Y
"RTN","VPRDPSOR",151,0)
 I '$D(ORDIALOG) S ORDIALOG=129 D GETDLG1^ORCD(129)
"RTN","VPRDPSOR",152,0)
 D GETORDER^ORCD(+$G(ORIFN),"VPRDLG")
"RTN","VPRDPSOR",153,0)
 S I=0 F  S I=$O(VPRDLG(I)) Q:I<1  D
"RTN","VPRDPSOR",154,0)
 . S ID=$P($G(ORDIALOG(I)),U,2) Q:'$L(ID)
"RTN","VPRDPSOR",155,0)
 . S TYPE=$P($G(ORDIALOG(I,0)),U)
"RTN","VPRDPSOR",156,0)
 . S J=0 F  S J=$O(VPRDLG(I,J)) Q:J<1  I $D(VPRDLG(I,J)) D
"RTN","VPRDPSOR",157,0)
 .. S X=VPRDLG(I,J) I TYPE'="W" S RESP(ID,J)=X Q
"RTN","VPRDPSOR",158,0)
 .. S Y=$G(@X@(1,0)),W=1 F  S W=$O(@X@(W)) Q:W<1  S Y=Y_$S($E(Y,$L(Y))'=" ":" ",1:"")_$G(@X@(W,0))
"RTN","VPRDPSOR",159,0)
 .. S:$L(Y) RESP(ID,J)=Y
"RTN","VPRDPSOR",160,0)
 Q
"RTN","VPRDPT")
0^7^B81010751^B70553505
"RTN","VPRDPT",1,0)
VPRDPT ;SLC/MKB -- Patient demographics extract ;8/11/11  15:29
"RTN","VPRDPT",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,4**;Sep 01, 2011;Build 6
"RTN","VPRDPT",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPT",4,0)
 ;
"RTN","VPRDPT",5,0)
 ; External References          DBIA#
"RTN","VPRDPT",6,0)
 ; -------------------          -----
"RTN","VPRDPT",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDPT",8,0)
 ; ^DGSL(38.1                     767
"RTN","VPRDPT",9,0)
 ; ^DIC(4                       10090
"RTN","VPRDPT",10,0)
 ; ^DIC(31                        733
"RTN","VPRDPT",11,0)
 ; ^DIC(42                  723,10039
"RTN","VPRDPT",12,0)
 ; ^DPT               3581,5597,10035
"RTN","VPRDPT",13,0)
 ; DGCV                          4156
"RTN","VPRDPT",14,0)
 ; DGMSTAPI                      2716
"RTN","VPRDPT",15,0)
 ; DGNTAPI                       3457
"RTN","VPRDPT",16,0)
 ; DGPFAPI                       3860
"RTN","VPRDPT",17,0)
 ; DGRPDB                        4807
"RTN","VPRDPT",18,0)
 ; DILFD                         2055
"RTN","VPRDPT",19,0)
 ; DIQ                           2056
"RTN","VPRDPT",20,0)
 ; MPIF001                       2701
"RTN","VPRDPT",21,0)
 ; SCAPMC                        1916
"RTN","VPRDPT",22,0)
 ; SDUTL3                        1252
"RTN","VPRDPT",23,0)
 ; VADPT                        10061
"RTN","VPRDPT",24,0)
 ; VAFCTFU1                      2990
"RTN","VPRDPT",25,0)
 ; VASITE                       10112
"RTN","VPRDPT",26,0)
 ; XUAF4                         2171
"RTN","VPRDPT",27,0)
 ;
"RTN","VPRDPT",28,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDPT",29,0)
 ;
"RTN","VPRDPT",30,0)
EN(DFN,BEG,END,MAX,ID) ; -- find current patient demographics
"RTN","VPRDPT",31,0)
 ; [BEG,END,MAX,ID not currently used]
"RTN","VPRDPT",32,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDPT",33,0)
 N PAT,SYS S SYS=$$SITE^VASITE
"RTN","VPRDPT",34,0)
 D DEM,SVC,PRF,ATC,SUPP,ALIAS,FAC,INPT
"RTN","VPRDPT",35,0)
 I $D(PAT)>9 D XML(.PAT)
"RTN","VPRDPT",36,0)
 Q
"RTN","VPRDPT",37,0)
 ;
"RTN","VPRDPT",38,0)
DEM ;-demographic data
"RTN","VPRDPT",39,0)
 N VADM,VA,VAERR,X
"RTN","VPRDPT",40,0)
 S X=+$$GETICN^MPIF001(DFN) S:X>1 PAT("icn")=X
"RTN","VPRDPT",41,0)
 D DEM^VADPT S X=VADM(1),PAT("fullName")=X
"RTN","VPRDPT",42,0)
 S PAT("familyName")=$P(X,","),PAT("givenNames")=$P(X,",",2,99)
"RTN","VPRDPT",43,0)
 S PAT("ssn")=$P(VADM(2),U),PAT("id")=DFN
"RTN","VPRDPT",44,0)
 S:$D(VA("BID")) PAT("bid")=$E(X)_VA("BID")
"RTN","VPRDPT",45,0)
 S PAT("dob")=+$P($P(VADM(3),U),".")
"RTN","VPRDPT",46,0)
 S PAT("gender")=$P(VADM(5),U)
"RTN","VPRDPT",47,0)
 S PAT("lrdfn")=+$G(^DPT(DFN,"LR"))
"RTN","VPRDPT",48,0)
 S X=+$P($P(VADM(6),U),".") S:X PAT("died")=X
"RTN","VPRDPT",49,0)
 S X=$$GET1^DIQ(38.1,DFN_",",2,"I") S:$L(X) PAT("sensitive")=X
"RTN","VPRDPT",50,0)
 S X=+VADM(9) S:X PAT("religion")=X
"RTN","VPRDPT",51,0)
 S X=$P(VADM(10),U,2) S:$L(X) PAT("maritalStatus")=$E(X)
"RTN","VPRDPT",52,0)
 I VADM(11) D
"RTN","VPRDPT",53,0)
 . N I S I=0
"RTN","VPRDPT",54,0)
 . F  S I=$O(VADM(11,I)) Q:I<1  S X=+VADM(11,I),PAT("ethnicity",X)=$$GET1^DIQ(2.06,X_","_DFN_",",".01:3")
"RTN","VPRDPT",55,0)
 I VADM(12) D
"RTN","VPRDPT",56,0)
 . N I S I=0
"RTN","VPRDPT",57,0)
 . F  S I=$O(VADM(12,I)) Q:I<1  S X=+VADM(12,I),PAT("race",X)=$$GET1^DIQ(2.02,X_","_DFN_",",".01:3")
"RTN","VPRDPT",58,0)
 Q
"RTN","VPRDPT",59,0)
SVC ;-service data
"RTN","VPRDPT",60,0)
 N VAEL,VASV,VAERR,X,Y,I,AO,IR,PGF,HNC,MST,CV
"RTN","VPRDPT",61,0)
 D 7^VADPT
"RTN","VPRDPT",62,0)
 S PAT("veteran")=VAEL(4)
"RTN","VPRDPT",63,0)
 S PAT("sc")=+VAEL(3) S:VAEL(3) PAT("scPercent")=+$P(VAEL(3),U,2)
"RTN","VPRDPT",64,0)
 ;
"RTN","VPRDPT",65,0)
 ; exposures
"RTN","VPRDPT",66,0)
 S AO=VASV(2),IR=VASV(3)
"RTN","VPRDPT",67,0)
 S PGF=VASV(11)!VASV(12)!VASV(13) ;OIF/OEF
"RTN","VPRDPT",68,0)
 S X=$$GETCUR^DGNTAPI(DFN,"HNC"),X=+($G(HNC("STAT")))
"RTN","VPRDPT",69,0)
 S HNC=$S(X=4:1,X=5:1,X=1:0,X=6:0,1:"")
"RTN","VPRDPT",70,0)
 S X=$P($$GETSTAT^DGMSTAPI(DFN),U,2),MST=$S(X="Y":1,X="N":0,1:"")
"RTN","VPRDPT",71,0)
 S X=$$CVEDT^DGCV(DFN),CV=$S(+X<0:"",+X=0:0,$P(X,U,3):1,1:0)
"RTN","VPRDPT",72,0)
 S PAT("exposures")=AO_U_IR_U_PGF_U_HNC_U_MST_U_CV
"RTN","VPRDPT",73,0)
 ;
"RTN","VPRDPT",74,0)
 ; rated disabilities [DGRPDB]
"RTN","VPRDPT",75,0)
 N VPRDIS,DIS,NM,DX
"RTN","VPRDPT",76,0)
 D RDIS^DGRPDB(DFN,.VPRDIS)
"RTN","VPRDPT",77,0)
 S I=0 F  S I=$O(VPRDIS(I)) Q:I<1  D
"RTN","VPRDPT",78,0)
 . S DIS=VPRDIS(I)
"RTN","VPRDPT",79,0)
 . S NM=$$GET1^DIQ(31,+DIS_",",.01),DX=$$GET1^DIQ(31,+DIS_",",2)
"RTN","VPRDPT",80,0)
 . S PAT("disability",+DX)=NM_U_$P(DIS,U,3)_U_$P(DIS,U,2) ;name^sc^%
"RTN","VPRDPT",81,0)
 Q
"RTN","VPRDPT",82,0)
PRF ;-patient record flags
"RTN","VPRDPT",83,0)
 N VPRPF,I,NAME,TEXT
"RTN","VPRDPT",84,0)
 Q:'$$GETACT^DGPFAPI(DFN,"VPRPF")
"RTN","VPRDPT",85,0)
 S I=0 F  S I=$O(VPRPF(I)) Q:I<1  D
"RTN","VPRDPT",86,0)
 . S NAME=$P(VPRPF(I,"FLAG"),U,2)
"RTN","VPRDPT",87,0)
 . M TEXT=VPRPF(I,"NARR")
"RTN","VPRDPT",88,0)
 . S PAT("flag",I)=NAME_U_$$STRING^VPRD(.TEXT)
"RTN","VPRDPT",89,0)
 Q
"RTN","VPRDPT",90,0)
ATC ;-address & telecom
"RTN","VPRDPT",91,0)
 N VAPA,I,X
"RTN","VPRDPT",92,0)
 S VAPA("P")="" D ADD^VADPT ;permanent address
"RTN","VPRDPT",93,0)
 S X="" F I=1:1:4 S X=X_VAPA(I)_U
"RTN","VPRDPT",94,0)
 S X=X_$P(VAPA(5),U,2)_U_$P(VAPA(11),U,2)
"RTN","VPRDPT",95,0)
 S PAT("address")=X ;street1^st2^st3^city^state^zip
"RTN","VPRDPT",96,0)
 S X=$$FORMAT(VAPA(8))_U_$$FORMAT($$GET1^DIQ(2,DFN_",",.134))_U_$$FORMAT($$GET1^DIQ(2,DFN_",",.132))
"RTN","VPRDPT",97,0)
 S PAT("telecom")=X ;home^cell^work phones
"RTN","VPRDPT",98,0)
 Q
"RTN","VPRDPT",99,0)
SUPP ;-support contacts
"RTN","VPRDPT",100,0)
 N VAOA,A,I,X,TYPE
"RTN","VPRDPT",101,0)
 F A="",1 K VAOA D
"RTN","VPRDPT",102,0)
 . S:A VAOA("A")=A D OAD^VADPT Q:'$L($G(VAOA(9)))
"RTN","VPRDPT",103,0)
 . S TYPE=$S(A=1:"ECON",1:"NOK")
"RTN","VPRDPT",104,0)
 . S PAT("support",TYPE)=VAOA(9)_U_VAOA(10) ;name^relationship
"RTN","VPRDPT",105,0)
 . S X="" F I=1:1:4 S X=X_VAOA(I)_U
"RTN","VPRDPT",106,0)
 . S X=X_$P(VAOA(5),U,2)_U_$P(VAOA(11),U,2)
"RTN","VPRDPT",107,0)
 . S PAT("support",TYPE,"address")=X ;street1^st2^st3^city^state^zip
"RTN","VPRDPT",108,0)
 . S I=$S(A=1:.33011,1:.21011),X=$$FORMAT(VAOA(8))_U_U_$$FORMAT($$GET1^DIQ(2,DFN_",",I))
"RTN","VPRDPT",109,0)
 . S PAT("support",TYPE,"telecom")=X ;home^cell^work phones
"RTN","VPRDPT",110,0)
 Q
"RTN","VPRDPT",111,0)
ALIAS ;-other names used
"RTN","VPRDPT",112,0)
 N I,X
"RTN","VPRDPT",113,0)
 S I=0 F  S I=$O(^DPT(DFN,.01,I)) Q:I<1  S X=$P($G(^(I,0)),U) D
"RTN","VPRDPT",114,0)
 . S PAT("alias",I)=X_U_$P(X,",")_U_$P(X,",",2,99)
"RTN","VPRDPT",115,0)
 Q
"RTN","VPRDPT",116,0)
FORMAT(X) ; -- enforce (xxx)xxx-xxxx phone format
"RTN","VPRDPT",117,0)
 S X=$G(X) I X?1"("3N1")"3N1"-"4N.E Q X
"RTN","VPRDPT",118,0)
 N P,N,I,Y S P=""
"RTN","VPRDPT",119,0)
 F I=1:1:$L(X) S N=$E(X,I) I N=+N S P=P_N
"RTN","VPRDPT",120,0)
 S:$L(P)<10 P=$E("0000000000",1,10-$L(P))_P
"RTN","VPRDPT",121,0)
 S Y=$S(P:"("_$E(P,1,3)_")"_$E(P,4,6)_"-"_$E(P,7,10),1:"")
"RTN","VPRDPT",122,0)
 Q Y
"RTN","VPRDPT",123,0)
FAC ;-treating facilities [see FACLIST^ORWCIRN]
"RTN","VPRDPT",124,0)
 N IFN S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDPT",125,0)
 N VPRY,HOME,LAST,I,X,IEN
"RTN","VPRDPT",126,0)
 I $L($T(TFL^VAFCTFU1)) D TFL^VAFCTFU1(.VPRY,DFN)
"RTN","VPRDPT",127,0)
 S HOME=+$P($G(^DPT(DFN,"MPI")),U,3) ;home facility
"RTN","VPRDPT",128,0)
 I $P($G(VPRY(1)),U)<0 D  Q  ;not setup
"RTN","VPRDPT",129,0)
 . S X=$O(^AUPNVSIT("AA",DFN,0)),LAST=$S(X:9999999-$P(X,"."),1:"")
"RTN","VPRDPT",130,0)
 . S X=$$SITE^VASITE
"RTN","VPRDPT",131,0)
 . S PAT("facility",+X)=$P(X,U,3)_U_$P(X,U,2)_U_LAST_U_$$GET1^DIQ(4,+X_",",60)
"RTN","VPRDPT",132,0)
 S I=0 F  S I=$O(VPRY(I)) Q:I<1  D
"RTN","VPRDPT",133,0)
 . S X=VPRY(I) Q:$P(X,U)=""  ;unknown
"RTN","VPRDPT",134,0)
 . S IEN=+$$IEN^XUAF4($P(X,U))
"RTN","VPRDPT",135,0)
 . I +X=776!(+X=200) S $P(X,U,2)="DEPT. OF DEFENSE"
"RTN","VPRDPT",136,0)
 . S PAT("facility",IEN)=$P(X,U,1,2)_U_$P($P(X,U,3),".")
"RTN","VPRDPT",137,0)
 . ; = stn# ^ name ^ last date ^ VistA domain
"RTN","VPRDPT",138,0)
 . S $P(PAT("facility",IEN),U,4)=$$GET1^DIQ(4,IEN_",",60)
"RTN","VPRDPT",139,0)
 . I IEN=HOME S $P(PAT("facility",IEN),U,5)=1
"RTN","VPRDPT",140,0)
 Q
"RTN","VPRDPT",141,0)
 ;
"RTN","VPRDPT",142,0)
INPT ;-current inpt status data
"RTN","VPRDPT",143,0)
 N ADM,X,X13,X15
"RTN","VPRDPT",144,0)
 S ADM=+$G(^DPT(DFN,.105)) I ADM D
"RTN","VPRDPT",145,0)
 . N VAIN,VAERR,HLOC,SVC
"RTN","VPRDPT",146,0)
 . D INP^VADPT S PAT("admitted")=ADM_U_+VAIN(7)
"RTN","VPRDPT",147,0)
 . S PAT("ward")=VAIN(4),PAT("roomBed")=VAIN(5)
"RTN","VPRDPT",148,0)
 . S HLOC=+$G(^DIC(42,+VAIN(4),44)),SVC=$P($G(^(0)),U,3)
"RTN","VPRDPT",149,0)
 . S PAT("location")=HLOC_U_$P(VAIN(4),U,2)
"RTN","VPRDPT",150,0)
 . S:$L(SVC) PAT("locSvc")=SVC_U_$$EXTERNAL^DILFD(42,.03,,SVC)
"RTN","VPRDPT",151,0)
 . S PAT("specialty")=VAIN(3)
"RTN","VPRDPT",152,0)
 . S PAT("attending")=VAIN(11)
"RTN","VPRDPT",153,0)
 . S X=$$FAC^VPRD(HLOC),PAT("site")=X
"RTN","VPRDPT",154,0)
 S PAT("inpatient")=$S(ADM:"true",1:"false")
"RTN","VPRDPT",155,0)
 S X=$$OUTPTPR^SDUTL3(DFN),X13=$G(^VA(200,+X,.13)),X15=$G(^(.15))
"RTN","VPRDPT",156,0)
 S:X PAT("pcProvider")=X_U_$P(X13,U,2)_U_$P(X13,U,7,8)_U_$P(X15,U)_U_$$PROVSPC^VPRD(+X)
"RTN","VPRDPT",157,0)
 S X=$$OUTPTTM^SDUTL3(DFN) I X S PAT("pcTeam")=X D
"RTN","VPRDPT",158,0)
 . N VPRT,I,POS
"RTN","VPRDPT",159,0)
 . S X=$$PRTM^SCAPMC(+X,,,,.VPRT) Q:'X
"RTN","VPRDPT",160,0)
 . S I=0 F  S I=$O(@VPRT@(I)) Q:I<1  D
"RTN","VPRDPT",161,0)
 .. S X=$G(@VPRT@(I)),X13=$G(^VA(200,+X,.13)),X15=$G(^(.15))
"RTN","VPRDPT",162,0)
 .. S POS=$S($L($P(X,U,8)):$P(X,U,8),1:$P(X,U,4))
"RTN","VPRDPT",163,0)
 .. ; return ien^name^[std]position^phone^pagers
"RTN","VPRDPT",164,0)
 .. S PAT("pcTeamMember",I)=$P(X,U,1,2)_U_POS_U_$P(X13,U,2)_U_$P(X13,U,7,8)_U_$P(X15,U)_U_$$PROVSPC^VPRD(+X)
"RTN","VPRDPT",165,0)
 Q
"RTN","VPRDPT",166,0)
 ;
"RTN","VPRDPT",167,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPT",168,0)
 ;
"RTN","VPRDPT",169,0)
XML(ITEM) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDPT",170,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDPT",171,0)
 N ATT,X,Y,NAMES,I,ID
"RTN","VPRDPT",172,0)
 D ADD("<patient>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPT",173,0)
 S ATT="" F  S ATT=$O(ITEM(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDPT",174,0)
 . I $L($O(ITEM(ATT,""))) D  Q  ;multiples
"RTN","VPRDPT",175,0)
 .. S ID=$S($E(ATT,$L(ATT))="s":ATT_"es",$E(ATT,$L(ATT))="y":$E(ATT,1,$L(ATT)-1)_"ies",1:ATT_"s")
"RTN","VPRDPT",176,0)
 .. D ADD("<"_ID_">")
"RTN","VPRDPT",177,0)
 .. S I="" F  S I=$O(ITEM(ATT,I)) Q:I=""  D
"RTN","VPRDPT",178,0)
 ... S X=ITEM(ATT,I),NAMES="value^Z",Y="<"_ATT_" "
"RTN","VPRDPT",179,0)
 ... I ATT="support" D  S Y="" Q
"RTN","VPRDPT",180,0)
 .... S NAMES="name^relationship^Z"
"RTN","VPRDPT",181,0)
 .... S Y=Y_"contactType='"_I_"' "_$$LOOP_">" D ADD(Y)
"RTN","VPRDPT",182,0)
 .... S X=$G(ITEM(ATT,I,"address")) I $L(X) D ADDR(X)
"RTN","VPRDPT",183,0)
 .... S X=$G(ITEM(ATT,I,"telecom")) I $L(X) D PHONE(X)
"RTN","VPRDPT",184,0)
 .... D ADD("</support>")
"RTN","VPRDPT",185,0)
 ... I ATT="disability" S Y=Y_"vaCode='"_I_"' ",NAMES="printName^sc^scPercent^Z"
"RTN","VPRDPT",186,0)
 ... I ATT="alias" S NAMES="fullName^familyName^givenNames^Z"
"RTN","VPRDPT",187,0)
 ... I ATT="flag" S NAMES="name^text^Z"
"RTN","VPRDPT",188,0)
 ... I ATT="facility" S NAMES="code^name^latestDate^domain^homeSite^Z"
"RTN","VPRDPT",189,0)
 ... I ATT="pcTeamMember" S NAMES="code^name^role^officePhone^analogPager^digitalPager^email^taxonomyCode^providerType^classification^specialization^Z"
"RTN","VPRDPT",190,0)
 ... S Y=Y_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPT",191,0)
 .. D ADD("</"_ID_">") S Y=""
"RTN","VPRDPT",192,0)
 . ;
"RTN","VPRDPT",193,0)
 . S X=$G(ITEM(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPT",194,0)
 . I ATT="exposures" D:X["1"  S Y="" Q
"RTN","VPRDPT",195,0)
 .. S I=0,Y="<exposures>" D ADD(Y)
"RTN","VPRDPT",196,0)
 .. F ID="AO","IR","PG","HNC","MST","CV" S I=I+1 I $P(X,U,I) S Y="<exposure value='"_ID_"' />" D ADD(Y)
"RTN","VPRDPT",197,0)
 .. D ADD("</exposures>")
"RTN","VPRDPT",198,0)
 . I ATT="address" D ADDR(X) S Y="" Q
"RTN","VPRDPT",199,0)
 . I ATT="telecom" D PHONE(X) S Y="" Q
"RTN","VPRDPT",200,0)
 . S NAMES="code^name"_$S("pcProvider":"^officePhone^analogPager^digitalPager^email^taxonomyCode^providerType^classification^specialization",1:"")_"^Z"
"RTN","VPRDPT",201,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPT",202,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDPT",203,0)
 D ADD("</patient>")
"RTN","VPRDPT",204,0)
 Q
"RTN","VPRDPT",205,0)
 ;
"RTN","VPRDPT",206,0)
ADDR(X) ; -- XML address node from X=street1^st2^st3^city^state^zip
"RTN","VPRDPT",207,0)
 N I,Y Q:$L(X)'>5  ;no data
"RTN","VPRDPT",208,0)
 S Y="<address"
"RTN","VPRDPT",209,0)
 F I=1,2,3 I $L($P(X,U,I)) S Y=Y_" streetLine"_I_"='"_$$ESC^VPRD($P(X,U,I))_"'"
"RTN","VPRDPT",210,0)
 I $L($P(X,U,4)) S Y=Y_" city='"_$$ESC^VPRD($P(X,U,4))_"'"
"RTN","VPRDPT",211,0)
 I $L($P(X,U,5)) S Y=Y_" stateProvince='"_$P(X,U,5)_"'"
"RTN","VPRDPT",212,0)
 I $L($P(X,U,6)) S Y=Y_" postalCode='"_$P(X,U,6)_"'"
"RTN","VPRDPT",213,0)
 S Y=Y_" />" D ADD(Y)
"RTN","VPRDPT",214,0)
 Q
"RTN","VPRDPT",215,0)
 ;
"RTN","VPRDPT",216,0)
PHONE(X) ; -- XML telecom node from X=home^cell^work numbers
"RTN","VPRDPT",217,0)
 N I,Y Q:$L(X)'>2  ;no data
"RTN","VPRDPT",218,0)
 D ADD("<telecomList>")
"RTN","VPRDPT",219,0)
 I $L($P(X,U,1)) S Y="<telecom usageType='H' value='"_$P(X,U,1)_"' />" D ADD(Y)
"RTN","VPRDPT",220,0)
 I $L($P(X,U,2)) S Y="<telecom usageType='MC' value='"_$P(X,U,2)_"' />" D ADD(Y)
"RTN","VPRDPT",221,0)
 I $L($P(X,U,3)) S Y="<telecom usageType='WP' value='"_$P(X,U,3)_"' />" D ADD(Y)
"RTN","VPRDPT",222,0)
 D ADD("</telecomList>")
"RTN","VPRDPT",223,0)
 Q
"RTN","VPRDPT",224,0)
 ;
"RTN","VPRDPT",225,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDPT",226,0)
 N STR,P,TAG S STR=""
"RTN","VPRDPT",227,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDPT",228,0)
 Q STR
"RTN","VPRDPT",229,0)
 ;
"RTN","VPRDPT",230,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDPT",231,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPT",232,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPT",233,0)
 Q
"RTN","VPRDPXIM")
0^11^B16291131^B15866293
"RTN","VPRDPXIM",1,0)
VPRDPXIM ;SLC/MKB -- Immunizations extract ;8/2/11  15:29
"RTN","VPRDPXIM",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**2,4**;Sep 01, 2011;Build 6
"RTN","VPRDPXIM",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPXIM",4,0)
 ;
"RTN","VPRDPXIM",5,0)
 ; External References          DBIA#
"RTN","VPRDPXIM",6,0)
 ; -------------------          -----
"RTN","VPRDPXIM",7,0)
 ; ^PXRMINDX                     4290
"RTN","VPRDPXIM",8,0)
 ; ^SC                          10040
"RTN","VPRDPXIM",9,0)
 ; ^VA(200                      10060
"RTN","VPRDPXIM",10,0)
 ; DILFD                         2055
"RTN","VPRDPXIM",11,0)
 ; DIQ                           2056
"RTN","VPRDPXIM",12,0)
 ; PXAPI                         1894
"RTN","VPRDPXIM",13,0)
 ; PXPXRM                        4250
"RTN","VPRDPXIM",14,0)
 ; XUAF4                         2171
"RTN","VPRDPXIM",15,0)
 ; 
"RTN","VPRDPXIM",16,0)
 ; ------------ Get immunizations from VistA ------------
"RTN","VPRDPXIM",17,0)
 ;
"RTN","VPRDPXIM",18,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's immunizations
"RTN","VPRDPXIM",19,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDPXIM",20,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999),VPRCNT=0
"RTN","VPRDPXIM",21,0)
 N VPRIDT,VPRN,VPRITM,VPRCNT
"RTN","VPRDPXIM",22,0)
 ;
"RTN","VPRDPXIM",23,0)
 ; get one immunization
"RTN","VPRDPXIM",24,0)
 I $G(IFN) D  Q
"RTN","VPRDPXIM",25,0)
 . N IMZ,DATE K ^TMP("VPRIMM",$J)
"RTN","VPRDPXIM",26,0)
 . S IMZ=0 F  S IMZ=$O(^PXRMINDX(9000010.11,"PI",+$G(DFN),IMZ)) Q:IMZ<1  D  Q:$D(VPRITM)
"RTN","VPRDPXIM",27,0)
 .. S DATE=0 F  S DATE=$O(^PXRMINDX(9000010.11,"PI",+$G(DFN),IMZ,DATE)) Q:DATE<1  I $D(^(DATE,IFN)) D  Q
"RTN","VPRDPXIM",28,0)
 ... S VPRIDT=9999999-DATE,VPRN=IFN
"RTN","VPRDPXIM",29,0)
 ... S ^TMP("VPRIMM",$J,VPRIDT,IFN)=IMZ_U_DATE ;SORT node
"RTN","VPRDPXIM",30,0)
 ... D EN1(IFN,.VPRITM),XML(.VPRITM)
"RTN","VPRDPXIM",31,0)
 . K ^TMP("VPRIMM",$J),^TMP("PXKENC",$J)
"RTN","VPRDPXIM",32,0)
 ;
"RTN","VPRDPXIM",33,0)
 ; get all immunizations
"RTN","VPRDPXIM",34,0)
 D SORT(DFN,BEG,END) S VPRCNT=0
"RTN","VPRDPXIM",35,0)
 S VPRIDT=0 F  S VPRIDT=$O(^TMP("VPRIMM",$J,VPRIDT)) Q:VPRIDT<1  D  Q:VPRCNT'<MAX
"RTN","VPRDPXIM",36,0)
 . S VPRN=0 F  S VPRN=$O(^TMP("VPRIMM",$J,VPRIDT,VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDPXIM",37,0)
 .. K VPRITM D EN1(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPXIM",38,0)
 .. D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDPXIM",39,0)
 K ^TMP("VPRIMM",$J),^TMP("PXKENC",$J)
"RTN","VPRDPXIM",40,0)
 Q
"RTN","VPRDPXIM",41,0)
 ;
"RTN","VPRDPXIM",42,0)
SORT(DFN,START,STOP) ; -- build ^TMP("VPRIMM",$J,9999999-DATE,DA)=IMM^DATE in range
"RTN","VPRDPXIM",43,0)
 ;  from ^PXRMINDX(9000010.11,"PI",DFN,IMM,DATE,DA)
"RTN","VPRDPXIM",44,0)
 N IMZ,DATE,DA,IDT K ^TMP("VPRIMM",$J)
"RTN","VPRDPXIM",45,0)
 S IMZ=0 F  S IMZ=$O(^PXRMINDX(9000010.11,"PI",+$G(DFN),IMZ)) Q:IMZ<1  D
"RTN","VPRDPXIM",46,0)
 . S DATE=0 F  S DATE=$O(^PXRMINDX(9000010.11,"PI",+$G(DFN),IMZ,DATE)) Q:DATE<1  D
"RTN","VPRDPXIM",47,0)
 .. Q:DATE<START  Q:DATE>STOP  S IDT=9999999-DATE
"RTN","VPRDPXIM",48,0)
 .. S DA=0 F  S DA=$O(^PXRMINDX(9000010.11,"PI",+$G(DFN),IMZ,DATE,DA)) Q:DA<1  S ^TMP("VPRIMM",$J,IDT,DA)=IMZ_U_DATE
"RTN","VPRDPXIM",49,0)
 Q
"RTN","VPRDPXIM",50,0)
 ;
"RTN","VPRDPXIM",51,0)
EN1(IEN,IMM) ; -- return an immunization in IMM("attribute")=value
"RTN","VPRDPXIM",52,0)
 ; Expects ^TMP("VPRIMM",$J,VPRIDT,VPRN)=IMM^DATE from EN/SORT
"RTN","VPRDPXIM",53,0)
 N TMP,VPRM,VISIT,X0,FAC,LOC,X12,X,I K IMM
"RTN","VPRDPXIM",54,0)
 S TMP=$G(^TMP("VPRIMM",$J,VPRIDT,VPRN))
"RTN","VPRDPXIM",55,0)
 S IMM("id")=IEN,IMM("administered")=+$P(TMP,U,2)
"RTN","VPRDPXIM",56,0)
 S IMM("name")=$$EXTERNAL^DILFD(9000010.11,.01,,+TMP)
"RTN","VPRDPXIM",57,0)
 D VIMM^PXPXRM(IEN,.VPRM)
"RTN","VPRDPXIM",58,0)
 S X=$G(VPRM("SERIES")),IMM("series")=$$EXTERNAL^DILFD(9000010.11,.04,,X)
"RTN","VPRDPXIM",59,0)
 S X=$G(VPRM("REACTION")),IMM("reaction")=$$EXTERNAL^DILFD(9000010.11,.06,,X)
"RTN","VPRDPXIM",60,0)
 S IMM("contraindicated")=+$G(VPRM("CONTRAINDICATED"))
"RTN","VPRDPXIM",61,0)
 S IMM("comment")=$G(VPRM("COMMENTS"))
"RTN","VPRDPXIM",62,0)
 S VISIT=+$G(VPRM("VISIT")),IMM("encounter")=VISIT
"RTN","VPRDPXIM",63,0)
 I '$D(^TMP("PXKENC",$J,VISIT)) D ENCEVENT^PXAPI(VISIT,1)
"RTN","VPRDPXIM",64,0)
 S X0=$G(^TMP("PXKENC",$J,VISIT,"VST",VISIT,0))
"RTN","VPRDPXIM",65,0)
 S FAC=+$P(X0,U,6),LOC=+$P(X0,U,22)
"RTN","VPRDPXIM",66,0)
 S:FAC IMM("facility")=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDPXIM",67,0)
 S:'FAC IMM("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDPXIM",68,0)
 S IMM("location")=$P($G(^SC(LOC,0)),U)
"RTN","VPRDPXIM",69,0)
 S X12=$G(^TMP("PXKENC",$J,VISIT,"IMM",IEN,12))
"RTN","VPRDPXIM",70,0)
 S X=$P(X12,U,4) S:'X X=$P(X12,U,2)
"RTN","VPRDPXIM",71,0)
 I 'X S I=0 F  S I=$O(^TMP("PXKENC",$J,VISIT,"PRV",I)) Q:I<1  I $P($G(^(I,0)),U,4)="P" S X=+^(0) Q
"RTN","VPRDPXIM",72,0)
 S:X IMM("provider")=X_U_$P($G(^VA(200,X,0)),U)
"RTN","VPRDPXIM",73,0)
 ; CVX, CPT mappings
"RTN","VPRDPXIM",74,0)
 S X=$$GET1^DIQ(9999999.14,+TMP_",",.03) S:$L(X) IMM("cvx")=X
"RTN","VPRDPXIM",75,0)
 S X=+$$FIND1^DIC(811.1,,"QX",+TMP_";AUTTIMM(","B") I X>0 D
"RTN","VPRDPXIM",76,0)
 . S Y=$$GET1^DIQ(811.1,X_",",.02,"I") Q:Y<1
"RTN","VPRDPXIM",77,0)
 . N CPT S CPT=$G(@(U_$P(Y,";",2)_+Y_",0)"))
"RTN","VPRDPXIM",78,0)
 . S IMM("cpt")=$P(CPT,U,1,2)
"RTN","VPRDPXIM",79,0)
 Q
"RTN","VPRDPXIM",80,0)
 ;
"RTN","VPRDPXIM",81,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPXIM",82,0)
 ;
"RTN","VPRDPXIM",83,0)
XML(IMM) ; -- Return immunizations as XML
"RTN","VPRDPXIM",84,0)
 N ATT,X,Y,I,P,NAMES,TAG
"RTN","VPRDPXIM",85,0)
 D ADD("<immunization>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPXIM",86,0)
 S ATT="" F  S ATT=$O(IMM(ATT)) Q:ATT=""  D
"RTN","VPRDPXIM",87,0)
 . S X=$G(IMM(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPXIM",88,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" D ADD(Y) Q
"RTN","VPRDPXIM",89,0)
 . I $L(X)>1 D
"RTN","VPRDPXIM",90,0)
 .. S Y="<"_ATT_" "
"RTN","VPRDPXIM",91,0)
 .. F P=1:1 S TAG=$P("code^name^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDPXIM",92,0)
 .. S Y=Y_"/>" D ADD(Y)
"RTN","VPRDPXIM",93,0)
 D ADD("</immunization>")
"RTN","VPRDPXIM",94,0)
 Q
"RTN","VPRDPXIM",95,0)
 ;
"RTN","VPRDPXIM",96,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDPXIM",97,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPXIM",98,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPXIM",99,0)
 Q
"RTN","VPRDTIU")
0^5^B83582740^B81103735
"RTN","VPRDTIU",1,0)
VPRDTIU ;SLC/MKB -- TIU extract ;8/2/11  15:29
"RTN","VPRDTIU",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,2,4**;Sep 01, 2011;Build 6
"RTN","VPRDTIU",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDTIU",4,0)
 ;
"RTN","VPRDTIU",5,0)
 ; External References          DBIA#
"RTN","VPRDTIU",6,0)
 ; -------------------          -----
"RTN","VPRDTIU",7,0)
 ; ^SC(                         10040
"RTN","VPRDTIU",8,0)
 ; ^TIU(8925.1              2321,5677
"RTN","VPRDTIU",9,0)
 ; ^TIU(8926.1                   5678
"RTN","VPRDTIU",10,0)
 ; ^VA(200                      10060
"RTN","VPRDTIU",11,0)
 ; DIQ                           2056
"RTN","VPRDTIU",12,0)
 ; RAO7PC1                       2043
"RTN","VPRDTIU",13,0)
 ; TIUCNSLT                      5546
"RTN","VPRDTIU",14,0)
 ; TIUCP                         3568
"RTN","VPRDTIU",15,0)
 ; TIULQ                         2693
"RTN","VPRDTIU",16,0)
 ; TIULX                         3058
"RTN","VPRDTIU",17,0)
 ; TIUSROI                       5676
"RTN","VPRDTIU",18,0)
 ; TIUSRVLO                 2834,2865
"RTN","VPRDTIU",19,0)
 ; TIUSRVR1                      2944
"RTN","VPRDTIU",20,0)
 ; XLFSTR                       10104
"RTN","VPRDTIU",21,0)
 ;
"RTN","VPRDTIU",22,0)
 ; ------------ Get documents from VistA ------------
"RTN","VPRDTIU",23,0)
 ;
"RTN","VPRDTIU",24,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's documents
"RTN","VPRDTIU",25,0)
 N VPRITM,VPRN,VPRX,VPRY,VPRCNT
"RTN","VPRDTIU",26,0)
 S DFN=+$G(DFN) Q:$G(DFN)<1
"RTN","VPRDTIU",27,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDTIU",28,0)
 ;
"RTN","VPRDTIU",29,0)
 ; get one document
"RTN","VPRDTIU",30,0)
 I $L($G(ID)),ID[";" D  G ENQ
"RTN","VPRDTIU",31,0)
 . I ID D RPT1^VPRDMC(DFN,ID,.VPRITM),XML(.VPRITM) Q  ;CP
"RTN","VPRDTIU",32,0)
 . D RPT1^VPRDLRA(DFN,ID,.VPRITM),XML(.VPRITM) Q      ;Lab
"RTN","VPRDTIU",33,0)
 I $G(ID),ID["-" D  G ENQ                             ;Radiology
"RTN","VPRDTIU",34,0)
 . S (BEG,END)=9999999.9999-+ID D EN1^RAO7PC1(DFN,BEG,END,"99P")
"RTN","VPRDTIU",35,0)
 . D RPT1^VPRDRA(DFN,ID,.VPRITM),XML(.VPRITM)
"RTN","VPRDTIU",36,0)
 . K ^TMP($J,"RAE1")
"RTN","VPRDTIU",37,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM):$D(VPRITM) G ENQ
"RTN","VPRDTIU",38,0)
 ;
"RTN","VPRDTIU",39,0)
 ; get all documents
"RTN","VPRDTIU",40,0)
 N CLASS,SUBCLASS,TITLE,SERVICE,SUBJECT,NOTSUBJ,STATUS,VPRC,CLS,VPRS,CTXT
"RTN","VPRDTIU",41,0)
 D SETUP S VPRCNT=0 ;define search criteria
"RTN","VPRDTIU",42,0)
 I CLASS="CP" D RPTS^VPRDMC(DFN,BEG,END,MAX) Q
"RTN","VPRDTIU",43,0)
 I CLASS="RA" D RPTS^VPRDRA(DFN,BEG,END,MAX) Q
"RTN","VPRDTIU",44,0)
 I CLASS="LR" D RPTS^VPRDLRA(DFN,BEG,END,MAX) Q
"RTN","VPRDTIU",45,0)
 F VPRC=1:1:$L(CLASS,U) S CLS=$P(CLASS,U,VPRC) D  Q:VPRCNT'<MAX
"RTN","VPRDTIU",46,0)
 . F VPRS=1:1:$L(STATUS,U) S CTXT=$P(STATUS,U,VPRS) D  Q:VPRCNT'<MAX
"RTN","VPRDTIU",47,0)
 .. D CONTEXT^TIUSRVLO(.VPRY,CLS,CTXT,DFN,BEG,END,,MAX,,1)
"RTN","VPRDTIU",48,0)
 .. S VPRN=0 F  S VPRN=$O(@VPRY@(VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDTIU",49,0)
 ... S VPRX=$G(@VPRY@(VPRN)) Q:'$$MATCH(VPRX)
"RTN","VPRDTIU",50,0)
 ... Q:$D(^TMP("VPRD",$J,+VPRX))  ;already included
"RTN","VPRDTIU",51,0)
 ... K VPRITM D EN1(VPRX,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDTIU",52,0)
 ... D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDTIU",53,0)
 .. K @VPRY
"RTN","VPRDTIU",54,0)
ENQ ; end
"RTN","VPRDTIU",55,0)
 K ^TMP("VPRTEXT",$J)
"RTN","VPRDTIU",56,0)
 Q
"RTN","VPRDTIU",57,0)
 ;
"RTN","VPRDTIU",58,0)
EN1(VPRX,DOC) ; -- return a document in DOC("attribute")=value
"RTN","VPRDTIU",59,0)
 ;  Expects DFN, VPRX=IEN^$$RESOLVE^TIUSRVLO(IEN)
"RTN","VPRDTIU",60,0)
 N IEN,X,NAME,VPRTIU,ES,I,VPRY
"RTN","VPRDTIU",61,0)
 K DOC,^TMP("VPRTEXT",$J)
"RTN","VPRDTIU",62,0)
 S IEN=+$G(VPRX) Q:IEN<1  ;invalid ien
"RTN","VPRDTIU",63,0)
 I +VPRX=VPRX D  ;get data string, if needed
"RTN","VPRDTIU",64,0)
 . N SHOWADD,DA S SHOWADD=1,DA=+VPRX
"RTN","VPRDTIU",65,0)
 . S VPRX=DA_U_$$RESOLVE^TIUSRVLO(DA)
"RTN","VPRDTIU",66,0)
 Q:"UNKNOWN"[$P($G(VPRX),U,2)  ;null or invalid
"RTN","VPRDTIU",67,0)
 S NAME=$P(VPRX,U,2) ;I $P(VPRX,U,14),$P(NAME," ")="Addendum" Q
"RTN","VPRDTIU",68,0)
 S DOC("id")=IEN,DOC("localTitle")=NAME
"RTN","VPRDTIU",69,0)
 D EXTRACT^TIULQ(IEN,"VPRTIU",,".01:.04;1501:1508")
"RTN","VPRDTIU",70,0)
 S X=$$GET1^DIQ(8925,IEN_",",".01:1501","I") I X D
"RTN","VPRDTIU",71,0)
 . N IENS,TIU,Y,FNUM
"RTN","VPRDTIU",72,0)
 . S IENS=X_"," D GETS^DIQ(8926.1,IENS,"*","IE","TIU")
"RTN","VPRDTIU",73,0)
 . S DOC("nationalTitle")=$G(TIU(8926.1,IENS,99.99,"E"))_U_$G(TIU(8926.1,IENS,.01,"E"))
"RTN","VPRDTIU",74,0)
 . F I=".04^Subject^2",".05^Role^3",".06^Setting^4",".07^Service^5",".08^Type^6" D
"RTN","VPRDTIU",75,0)
 .. S Y=+$G(TIU(8926.1,IENS,+I,"I")) Q:Y'>0
"RTN","VPRDTIU",76,0)
 .. S FNUM="8926."_+$P(I,U,3)
"RTN","VPRDTIU",77,0)
 .. S DOC("nationalTitle"_$P(I,U,2))=$$VUID^VPRD(Y,FNUM)_U_$G(TIU(8926.1,IENS,+I,"E"))
"RTN","VPRDTIU",78,0)
 S:$G(FILTER("loinc")) DOC("loinc")=$P(FILTER("loinc"),U)
"RTN","VPRDTIU",79,0)
 S X=+$G(VPRTIU(IEN,.01,"I")),X=$$CATG(X),(DOC("type"),DOC("category"))=X
"RTN","VPRDTIU",80,0)
 S DOC("documentClass")=$S(X="LR":"LR LABORATORY REPORTS",X="SR":"SURGICAL REPORTS",X="CP":"CLINICAL PROCEDURES",X="DS":"DISCHARGE SUMMARY",1:"PROGRESS NOTES")
"RTN","VPRDTIU",81,0)
 S DOC("referenceDateTime")=$P(VPRX,U,3)
"RTN","VPRDTIU",82,0)
 S X=$P(VPRX,U,6) D  ;S:$L(X) DOC("location")=X
"RTN","VPRDTIU",83,0)
 . N LOC S LOC=$S($L(X):+$O(^SC("B",X,0)),1:0)
"RTN","VPRDTIU",84,0)
 . S DOC("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDTIU",85,0)
 S X=$P(VPRX,U,7) S:$L(X) DOC("status")=X
"RTN","VPRDTIU",86,0)
 S:$P(VPRX,U,11) DOC("images")=+$P(VPRX,U,11)
"RTN","VPRDTIU",87,0)
 S:$L($P(VPRX,U,12)) DOC("subject")=$P(VPRX,U,12)
"RTN","VPRDTIU",88,0)
 ; X=$S($P(VPRX,U,13)[">":"C",$P(VPRX,U,13)["<":"I",1:"") ;componentType
"RTN","VPRDTIU",89,0)
 I $P(VPRX,U,14)>5 S DOC("parent")=$P(VPRX,U,14) ;ID notes
"RTN","VPRDTIU",90,0)
 S DOC("encounter")=$G(VPRTIU(IEN,.03,"I"))
"RTN","VPRDTIU",91,0)
 S:$G(VPRTEXT) DOC("content")=$$TEXT(IEN)
"RTN","VPRDTIU",92,0)
 ; providers &/or signatures
"RTN","VPRDTIU",93,0)
 S X=$P(VPRX,U,5),I=0               ;author
"RTN","VPRDTIU",94,0)
 S:X I=I+1,DOC("clinician",I)=+X_U_$P(X,";",3)_"^A^^^"_$$PROVSPC^VPRD(+X)
"RTN","VPRDTIU",95,0)
 M ES=VPRTIU(IEN) I ES(1501,"I") D  ;signed
"RTN","VPRDTIU",96,0)
 . S I=I+1,X=ES(1502,"I")
"RTN","VPRDTIU",97,0)
 . S DOC("clinician",I)=X_U_ES(1502,"E")_"^S^"_ES(1501,"I")_U_$$SIG(X)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDTIU",98,0)
 I ES(1507,"I") D                   ;cosigned
"RTN","VPRDTIU",99,0)
 . S I=I+1,X=ES(1508,"I")
"RTN","VPRDTIU",100,0)
 . S DOC("clinician",I)=X_U_ES(1508,"E")_"^C^"_ES(1507,"I")_U_$$SIG(X)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDTIU",101,0)
 Q
"RTN","VPRDTIU",102,0)
 ;
"RTN","VPRDTIU",103,0)
CATG(DA) ; -- Return a code for document type #8925.1 DA
"RTN","VPRDTIU",104,0)
 N X
"RTN","VPRDTIU",105,0)
 D ISCNSLT^TIUCNSLT(.X,DA) I X Q "CR"  ;consult result
"RTN","VPRDTIU",106,0)
 I $$ISA^TIULX(DA,25) Q "A"            ;CWAD note/Allergy
"RTN","VPRDTIU",107,0)
 I $$ISA^TIULX(DA,27) Q "D"            ;CWAD note/Advance Directive
"RTN","VPRDTIU",108,0)
 I $$ISA^TIULX(DA,30) Q "C"            ;CWAD note/Crisis Note
"RTN","VPRDTIU",109,0)
 I $$ISA^TIULX(DA,31) Q "W"            ;CWAD note/Clinical Warning
"RTN","VPRDTIU",110,0)
 I $$ISA^TIULX(DA,3) Q "PN"            ;progress note
"RTN","VPRDTIU",111,0)
 ;
"RTN","VPRDTIU",112,0)
 I $$ISA^TIULX(DA,244) Q "DS"          ;discharge summary
"RTN","VPRDTIU",113,0)
 D ISCP^TIUCP(.X,DA) I X Q "CP"        ;clinical procedure
"RTN","VPRDTIU",114,0)
 D ISSURG^TIUSROI(.X,DA) I X Q "SR"    ;surgery
"RTN","VPRDTIU",115,0)
 I $$ISA^TIULX(DA,$$LR) Q "LR"         ;laboratory
"RTN","VPRDTIU",116,0)
 Q ""
"RTN","VPRDTIU",117,0)
 ;
"RTN","VPRDTIU",118,0)
LR() ; -- Return ien of Lab class
"RTN","VPRDTIU",119,0)
 N Y S Y=+$O(^TIU(8925.1,"B","LR LABORATORY REPORTS",0))
"RTN","VPRDTIU",120,0)
 I Y>0,$S($P($G(^TIU(8925.1,Y,0)),U,4)="CL":0,$P($G(^(0)),U,4)="DC":0,1:1) S Y=0
"RTN","VPRDTIU",121,0)
 Q Y
"RTN","VPRDTIU",122,0)
 ;
"RTN","VPRDTIU",123,0)
SIG(X) ; -- Return Signature Block Name_Title
"RTN","VPRDTIU",124,0)
 N X20,Y S X20=$G(^VA(200,+$G(X),20))
"RTN","VPRDTIU",125,0)
 S Y=$P(X20,U,2)_" "_$P(X20,U,3)
"RTN","VPRDTIU",126,0)
 Q Y
"RTN","VPRDTIU",127,0)
 ;
"RTN","VPRDTIU",128,0)
RPT(VPRY,IFN) ; -- Return text of document in @VPRY@(n)
"RTN","VPRDTIU",129,0)
 N I,J ;protect for calling loops
"RTN","VPRDTIU",130,0)
 D TGET^TIUSRVR1(.VPRY,IFN)
"RTN","VPRDTIU",131,0)
 Q
"RTN","VPRDTIU",132,0)
 ;
"RTN","VPRDTIU",133,0)
TEXT(IFN) ; -- Get document IFN text, return temp array name
"RTN","VPRDTIU",134,0)
 N VPRY,Y,I,J ;protect I&J for calling loops
"RTN","VPRDTIU",135,0)
 S IFN=+$G(IFN) D TGET^TIUSRVR1(.VPRY,IFN)
"RTN","VPRDTIU",136,0)
 M ^TMP("VPRTEXT",$J,IFN)=@VPRY K @VPRY
"RTN","VPRDTIU",137,0)
 S Y=$NA(^TMP("VPRTEXT",$J,IFN))
"RTN","VPRDTIU",138,0)
 Q Y
"RTN","VPRDTIU",139,0)
 ;
"RTN","VPRDTIU",140,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDTIU",141,0)
 ;
"RTN","VPRDTIU",142,0)
XML(DOC) ; -- Return patient documents as XML
"RTN","VPRDTIU",143,0)
 N ATT,X,Y,NAMES,TYPE,I
"RTN","VPRDTIU",144,0)
 D ADD("<document>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDTIU",145,0)
 S ATT="" F  S ATT=$O(DOC(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDTIU",146,0)
 . I $O(DOC(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDTIU",147,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDTIU",148,0)
 .. S I=0 F  S I=$O(DOC(ATT,I)) Q:I<1  D
"RTN","VPRDTIU",149,0)
 ... S X=$G(DOC(ATT,I)),NAMES=""
"RTN","VPRDTIU",150,0)
 ... I ATT="clinician" S NAMES="code^name^role^dateTime^signature^taxonomyCode^providerType^classification^specialization^Z"
"RTN","VPRDTIU",151,0)
 ... S Y="<"_ATT_" "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDTIU",152,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDTIU",153,0)
 . S X=$G(DOC(ATT)),Y="" Q:'$L(X)
"RTN","VPRDTIU",154,0)
 . I ATT="content" D  S Y="" Q  ;text
"RTN","VPRDTIU",155,0)
 .. S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDTIU",156,0)
 .. S I=0 F  S I=$O(@X@(I)) Q:I<1  S Y=$$ESC^VPRD(@X@(I)) D ADD(Y)
"RTN","VPRDTIU",157,0)
 .. D ADD("</content>")
"RTN","VPRDTIU",158,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDTIU",159,0)
 . I $L(X)>1 S NAMES="code^name^Z",Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDTIU",160,0)
 D ADD("</document>")
"RTN","VPRDTIU",161,0)
 Q
"RTN","VPRDTIU",162,0)
 ;
"RTN","VPRDTIU",163,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDTIU",164,0)
 N STR,P,TAG S STR=""
"RTN","VPRDTIU",165,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDTIU",166,0)
 Q STR
"RTN","VPRDTIU",167,0)
 ;
"RTN","VPRDTIU",168,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDTIU",169,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDTIU",170,0)
 S @VPR@(VPRI)=X
"RTN","VPRDTIU",171,0)
 Q
"RTN","VPRDTIU",172,0)
 ;
"RTN","VPRDTIU",173,0)
 ; ------------ Get/apply search criteria ------------
"RTN","VPRDTIU",174,0)
 ;
"RTN","VPRDTIU",175,0)
SETUP ; -- convert FILTER("attribute") = value to TIU criteria
"RTN","VPRDTIU",176,0)
 ; Expects: FILTER("category") = code (see $$CATG)
"RTN","VPRDTIU",177,0)
 ;          FILTER("loinc")    = LOINC
"RTN","VPRDTIU",178,0)
 ;          FILTER("status")   = 'all','completed','unsigned'
"RTN","VPRDTIU",179,0)
 ; Returns CLASS,[SUBCLASS,TITLE,SERVICE,SUBJECT,STATUS]
"RTN","VPRDTIU",180,0)
 ;
"RTN","VPRDTIU",181,0)
 N LOINC,TYPE,STS,CP
"RTN","VPRDTIU",182,0)
 S LOINC=+$G(FILTER("loinc")),TYPE=$$UP^XLFSTR($G(FILTER("category")))
"RTN","VPRDTIU",183,0)
 S CLASS="3^244",(SUBCLASS,TITLE,SERVICE,SUBJECT,NOTSUBJ,STATUS)=""
"RTN","VPRDTIU",184,0)
 ;
"RTN","VPRDTIU",185,0)
 ; status [default='complete']
"RTN","VPRDTIU",186,0)
 S STS=$$LOW^XLFSTR($G(FILTER("status")))
"RTN","VPRDTIU",187,0)
 S STATUS=$S(STS?1"unsig".E:2,STS="all":"5^2",1:5)  ;TIUSRVLO statuses
"RTN","VPRDTIU",188,0)
 ;
"RTN","VPRDTIU",189,0)
 ; progress notes
"RTN","VPRDTIU",190,0)
 I TYPE="PN" S CLASS=3 Q
"RTN","VPRDTIU",191,0)
 I TYPE="CR"!(LOINC=11488) S CLASS=3,SUBCLASS=+$$CLASS^TIUCNSLT Q
"RTN","VPRDTIU",192,0)
 ; LOINC=26442 S CLASS=3,SUBJECT="^114^" Q         ;OB/GYN
"RTN","VPRDTIU",193,0)
 I LOINC=34117 S CLASS=3,SERVICE="^88^" Q          ;H&P
"RTN","VPRDTIU",194,0)
 I TYPE="CWAD" S CLASS=3,SUBCLASS="25^27^30^31" Q  ;CWAD
"RTN","VPRDTIU",195,0)
 I TYPE="C" S CLASS=3,SUBCLASS=30 Q                ;Crisis Note
"RTN","VPRDTIU",196,0)
 I TYPE="W" S CLASS=3,SUBCLASS=31 Q                ;Clinical Warning
"RTN","VPRDTIU",197,0)
 I TYPE="A" S CLASS=3,SUBCLASS=25 Q                ;Allergy Note
"RTN","VPRDTIU",198,0)
 I TYPE="D"!(LOINC=42348) S CLASS=3,SUBCLASS=27 Q  ;Advance Directive
"RTN","VPRDTIU",199,0)
 ;
"RTN","VPRDTIU",200,0)
 ; discharge summaries
"RTN","VPRDTIU",201,0)
 I TYPE="DS"!(LOINC=18842) S CLASS=244 Q
"RTN","VPRDTIU",202,0)
 ;
"RTN","VPRDTIU",203,0)
 ; procedures
"RTN","VPRDTIU",204,0)
 I TYPE="SR"!(LOINC=29752) S CLASS=+$$CLASS^TIUSROI("SURGICAL REPORTS") Q
"RTN","VPRDTIU",205,0)
 D CPCLASS^TIUCP(.CP)
"RTN","VPRDTIU",206,0)
 I TYPE="CP" S CLASS=$S(STATUS=2:CP,1:"CP") Q       ;CLINICAL PROCEDURES
"RTN","VPRDTIU",207,0)
 I LOINC=26441 D  Q                                 ;CARDIOLOGY
"RTN","VPRDTIU",208,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",209,0)
 . S SUBJECT="^18^142^174^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",210,0)
 I LOINC=27896 D  Q                                 ;PULMONARY
"RTN","VPRDTIU",211,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",212,0)
 . S SUBJECT="^23^142^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",213,0)
 I LOINC=27895 D  Q                                 ;GASTROENTEROLOGY
"RTN","VPRDTIU",214,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",215,0)
 . S SUBJECT="^20^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",216,0)
 I LOINC=27897 D  Q                                 ;NEUROLOGY
"RTN","VPRDTIU",217,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",218,0)
 . S SUBJECT="^44^45^52^111^112^143^146^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",219,0)
 I LOINC=28619 D  Q                                 ;OPHTH/OPTOMETRY
"RTN","VPRDTIU",220,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",221,0)
 . S SUBJECT="^13^14^103^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",222,0)
 I LOINC=28634 D  Q                                 ;MISC/ALL OTHERS
"RTN","VPRDTIU",223,0)
 . S CLASS=CP_"^3",SERVICE="^75^76^115^"
"RTN","VPRDTIU",224,0)
 . S NOTSUBJ="^18^142^174^23^142^20^44^45^52^111^112^143^146^13^14^103^"
"RTN","VPRDTIU",225,0)
 I LOINC=28570 D  Q                                 ;UNSPECIFIED/ALL
"RTN","VPRDTIU",226,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",227,0)
 . S SERVICE="^75^76^115^"
"RTN","VPRDTIU",228,0)
 ;
"RTN","VPRDTIU",229,0)
 ; pathology/lab
"RTN","VPRDTIU",230,0)
 I TYPE="LR"!(LOINC=27898) S CLASS=$S(STATUS=2:$$LR,1:"LR") Q
"RTN","VPRDTIU",231,0)
 ;
"RTN","VPRDTIU",232,0)
 ; radiology
"RTN","VPRDTIU",233,0)
 I TYPE="RA"!(LOINC=18726) S CLASS="RA" Q
"RTN","VPRDTIU",234,0)
 ;
"RTN","VPRDTIU",235,0)
 ; unknown
"RTN","VPRDTIU",236,0)
 I $L(TYPE)!LOINC S CLASS=0
"RTN","VPRDTIU",237,0)
 Q
"RTN","VPRDTIU",238,0)
 ;
"RTN","VPRDTIU",239,0)
MATCH(DOC) ; -- Return 1 or 0, if document DA matches search criteria
"RTN","VPRDTIU",240,0)
 N Y,DA,LOCAL,NATL,X0,OK S Y=0
"RTN","VPRDTIU",241,0)
 S DA=+$G(DOC) G:DA<1 MQ
"RTN","VPRDTIU",242,0)
 ; include addenda if pulling only unsigned items:
"RTN","VPRDTIU",243,0)
 I $P(DOC,U,2)?1"Addendum ".E,STATUS'=2 G MQ
"RTN","VPRDTIU",244,0)
 ; remove completed parent notes from TIU unsigned list:
"RTN","VPRDTIU",245,0)
 I CTXT=2,$P(DOC,U,7)'="unsigned" G MQ
"RTN","VPRDTIU",246,0)
 ; remove Uncosigned notes from 'complete' view:
"RTN","VPRDTIU",247,0)
 I STATUS=5,$P(DOC,U,7)="uncosigned" G MQ
"RTN","VPRDTIU",248,0)
 ; Check title & attributes for a match ...
"RTN","VPRDTIU",249,0)
 S LOCAL=$$GET1^DIQ(8925,DA_",",.01,"I") ;local Title 8925.1 ien
"RTN","VPRDTIU",250,0)
 I $L(SUBCLASS) D  G:'OK MQ
"RTN","VPRDTIU",251,0)
 . N I,X S OK=0
"RTN","VPRDTIU",252,0)
 . F I=1:1:$L(SUBCLASS,"^") S X=$P(SUBCLASS,U,I) I $$ISA^TIULX(LOCAL,X) S OK=1 Q
"RTN","VPRDTIU",253,0)
 S NATL=+$$GET1^DIQ(8925.1,LOCAL_",",1501,"I") ;Natl Title 8926.1 ien
"RTN","VPRDTIU",254,0)
 I $L(TITLE) G:TITLE'[(U_+NATL_U) MQ
"RTN","VPRDTIU",255,0)
 S X0=$G(^TIU(8926.1,NATL,0))
"RTN","VPRDTIU",256,0)
 I $L(SERVICE) G:SERVICE'[(U_+$P(X0,U,7)_U) MQ
"RTN","VPRDTIU",257,0)
 I $L(SUBJECT) G:SUBJECT'[(U_+$P(X0,U,4)_U) MQ
"RTN","VPRDTIU",258,0)
 I $L(NOTSUBJ) G:NOTSUBJ[(U_+$P(X0,U,4)_U) MQ
"RTN","VPRDTIU",259,0)
 S Y=1
"RTN","VPRDTIU",260,0)
MQ Q Y
"RTN","VPRDTST")
0^9^B11854461^n/a
"RTN","VPRDTST",1,0)
VPRDTST ;SLC/MKB -- Test VistA data XML RPC ;10/18/12 6:26pm
"RTN","VPRDTST",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**4**;Sep 01, 2011;Build 6
"RTN","VPRDTST",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDTST",4,0)
 ;
"RTN","VPRDTST",5,0)
 ; External References          DBIA#
"RTN","VPRDTST",6,0)
 ; -------------------          -----
"RTN","VPRDTST",7,0)
 ; DIC                           2051
"RTN","VPRDTST",8,0)
 ; DIR                          10026
"RTN","VPRDTST",9,0)
 ;
"RTN","VPRDTST",10,0)
EN ; -- test GET^VPRD, write results to screen
"RTN","VPRDTST",11,0)
 N DFN,TYPE,TEXT,START,STOP,MAX,ID,IN,OUT,IDX
"RTN","VPRDTST",12,0)
 F  S DFN=$$PATIENT Q:DFN<1  D 
"RTN","VPRDTST",13,0)
 . F  S TYPE=$$DOMAIN Q:"^"[TYPE  D
"RTN","VPRDTST",14,0)
 .. D RPC W !!
"RTN","VPRDTST",15,0)
 .. K TEXT,START,STOP,MAX
"RTN","VPRDTST",16,0)
 Q
"RTN","VPRDTST",17,0)
 ;
"RTN","VPRDTST",18,0)
RPC ; -- get search parameters, run and display
"RTN","VPRDTST",19,0)
 I TYPE="document" S TEXT=$$SHOW Q:TEXT="^"
"RTN","VPRDTST",20,0)
 S START=$$START Q:START="^"
"RTN","VPRDTST",21,0)
 I START S STOP=$$STOP(START) Q:STOP="^"
"RTN","VPRDTST",22,0)
 S MAX=$$TOTAL Q:MAX="^"
"RTN","VPRDTST",23,0)
 ; ID=$$ITEM
"RTN","VPRDTST",24,0)
 ;
"RTN","VPRDTST",25,0)
 S:$L($G(TEXT)) IN("text")=TEXT
"RTN","VPRDTST",26,0)
 D GET^VPRD(.OUT,+$G(DFN),$G(TYPE),$G(START),$G(STOP),$G(MAX),$G(ID),.IN)
"RTN","VPRDTST",27,0)
 ;
"RTN","VPRDTST",28,0)
 S IDX=OUT W !
"RTN","VPRDTST",29,0)
 F  S IDX=$Q(@IDX) Q:IDX'?1"^TMP(""VPR"","1.N.E  Q:+$P(IDX,",",2)'=$J  W !,@IDX
"RTN","VPRDTST",30,0)
 Q
"RTN","VPRDTST",31,0)
 ;
"RTN","VPRDTST",32,0)
PATIENT() ; -- select patient
"RTN","VPRDTST",33,0)
 N X,Y,DIC
"RTN","VPRDTST",34,0)
 S DIC=2,DIC(0)="AEQM" D ^DIC
"RTN","VPRDTST",35,0)
 Q Y
"RTN","VPRDTST",36,0)
 ;
"RTN","VPRDTST",37,0)
DOMAIN() ; -- select domain
"RTN","VPRDTST",38,0)
 N X,Y,I,DIR,VPR
"RTN","VPRDTST",39,0)
 S DIR(0)="SAO^",DIR("A")="Select DOMAIN: "
"RTN","VPRDTST",40,0)
 F I=1:1 S X=$P($T(TYPE+I),";",3) Q:X=99  S DIR(0)=DIR(0)_$P(X,":",1,2)_";",VPR(+X)=$P(X,":",3)
"RTN","VPRDTST",41,0)
 D ^DIR S:Y Y=VPR(Y)
"RTN","VPRDTST",42,0)
 Q Y
"RTN","VPRDTST",43,0)
 ;
"RTN","VPRDTST",44,0)
TYPE ;;CODE:NAME:TAG
"RTN","VPRDTST",45,0)
 ;;1:ALLERGIES/REACTIONS:allergy
"RTN","VPRDTST",46,0)
 ;;2:APPOINTMENTS:appointment
"RTN","VPRDTST",47,0)
 ;;3:CLINICAL PROCEDURES:clinicalProcedure
"RTN","VPRDTST",48,0)
 ;;4:CONSULTS:consult
"RTN","VPRDTST",49,0)
 ;;5:DEMOGRAPHICS:demographics
"RTN","VPRDTST",50,0)
 ;;6:DOCUMENTS:document
"RTN","VPRDTST",51,0)
 ;;7:EXAMS:exam
"RTN","VPRDTST",52,0)
 ;;8:HEALTH FACTORS:factor
"RTN","VPRDTST",53,0)
 ;;9:IMMUNIZATIONS:immunization
"RTN","VPRDTST",54,0)
 ;;10:INSURANCE:insurance
"RTN","VPRDTST",55,0)
 ;;11:LAB RESULTS:lab
"RTN","VPRDTST",56,0)
 ;;12:LABS BY ACCESSION:accession
"RTN","VPRDTST",57,0)
 ;;13:LABS BY ORDER:panel
"RTN","VPRDTST",58,0)
 ;;14:MEDS:med
"RTN","VPRDTST",59,0)
 ;;15:OBSERVATIONS (CLiO):observation
"RTN","VPRDTST",60,0)
 ;;16:ORDERS:order
"RTN","VPRDTST",61,0)
 ;;17:PATIENT EDUCATION:education
"RTN","VPRDTST",62,0)
 ;;18:PATIENT RECORD FLAGS:flag
"RTN","VPRDTST",63,0)
 ;;19:PROBLEMS:problem
"RTN","VPRDTST",64,0)
 ;;20:PROCEDURES (ALL):procedure
"RTN","VPRDTST",65,0)
 ;;21:RADIOLOGY EXAMS:xray
"RTN","VPRDTST",66,0)
 ;;22:SKIN TESTS:skin
"RTN","VPRDTST",67,0)
 ;;23:SURGERIES:surgery
"RTN","VPRDTST",68,0)
 ;;24:VISITS:visit
"RTN","VPRDTST",69,0)
 ;;25:VITALS:vital
"RTN","VPRDTST",70,0)
 ;;99
"RTN","VPRDTST",71,0)
 ;
"RTN","VPRDTST",72,0)
SHOW() ; -- true/false to include body of note
"RTN","VPRDTST",73,0)
 N X,Y,DIR,DUOUT,DTOUT
"RTN","VPRDTST",74,0)
 S DIR(0)="YAO",DIR("A")="Include the text of each document? "
"RTN","VPRDTST",75,0)
 D ^DIR S:$D(DTOUT) Y="^"
"RTN","VPRDTST",76,0)
 Q Y
"RTN","VPRDTST",77,0)
 ;
"RTN","VPRDTST",78,0)
START() ; -- select a start date
"RTN","VPRDTST",79,0)
 N X,Y,DIR,DUOUT,DTOUT
"RTN","VPRDTST",80,0)
 S DIR(0)="DAO^::AEPT",DIR("A")="Select START DATE: "
"RTN","VPRDTST",81,0)
 S DIR("?")="Enter an optional date[.time] to begin searching for data"
"RTN","VPRDTST",82,0)
 D ^DIR S:$D(DTOUT) Y="^"
"RTN","VPRDTST",83,0)
 Q Y
"RTN","VPRDTST",84,0)
 ;
"RTN","VPRDTST",85,0)
STOP(START) ; -- select a stop date
"RTN","VPRDTST",86,0)
 N X,Y,DIR,DUOUT,DTOUT
"RTN","VPRDTST",87,0)
 S DIR(0)="DA^"_START_"::AEPT",DIR("A")="Select STOP DATE: "
"RTN","VPRDTST",88,0)
 S DIR("?")="Enter a date[.time] after the START to end searching for data"
"RTN","VPRDTST",89,0)
 D ^DIR S:$D(DTOUT) Y="^"
"RTN","VPRDTST",90,0)
 Q Y
"RTN","VPRDTST",91,0)
 ;
"RTN","VPRDTST",92,0)
TOTAL() ; -- select the max# to return
"RTN","VPRDTST",93,0)
 N X,Y,DIR,DUOUT,DTOUT
"RTN","VPRDTST",94,0)
 S DIR(0)="NAO^1:9999",DIR("A")="Select TOTAL #items: "
"RTN","VPRDTST",95,0)
 S DIR("?")="Enter an optional maximum number of items to return, up to 9999"
"RTN","VPRDTST",96,0)
 D ^DIR S:$D(DTOUT) Y="^"
"RTN","VPRDTST",97,0)
 Q Y
"RTN","VPRDVSIT")
0^6^B100077212^B89271062
"RTN","VPRDVSIT",1,0)
VPRDVSIT ;SLC/MKB -- Visit/Encounter extract ;8/2/11  15:29
"RTN","VPRDVSIT",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,2,4**;Sep 01, 2011;Build 6
"RTN","VPRDVSIT",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDVSIT",4,0)
 ;
"RTN","VPRDVSIT",5,0)
 ; External References          DBIA#
"RTN","VPRDVSIT",6,0)
 ; -------------------          -----
"RTN","VPRDVSIT",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDVSIT",8,0)
 ; ^DIC(40.7                      557
"RTN","VPRDVSIT",9,0)
 ; ^DIC(42                      10039
"RTN","VPRDVSIT",10,0)
 ; ^DIC(45.7                     1154
"RTN","VPRDVSIT",11,0)
 ; ^DPT(                        10035
"RTN","VPRDVSIT",12,0)
 ; ^SC                          10040
"RTN","VPRDVSIT",13,0)
 ; ^VA(200                      10060
"RTN","VPRDVSIT",14,0)
 ; DGPTFAPI                      3157
"RTN","VPRDVSIT",15,0)
 ; DIC                           2051
"RTN","VPRDVSIT",16,0)
 ; DILFD                         2055
"RTN","VPRDVSIT",17,0)
 ; DIQ                           2056
"RTN","VPRDVSIT",18,0)
 ; ICDCODE                       3990
"RTN","VPRDVSIT",19,0)
 ; ICPTCOD                       1995
"RTN","VPRDVSIT",20,0)
 ; PXAPI,^TMP("PXKENC",$J        1894
"RTN","VPRDVSIT",21,0)
 ; SDOE                          2546
"RTN","VPRDVSIT",22,0)
 ; VADPT                        10061
"RTN","VPRDVSIT",23,0)
 ; VADPT2                         325
"RTN","VPRDVSIT",24,0)
 ; XUAF4                         2171
"RTN","VPRDVSIT",25,0)
 ;
"RTN","VPRDVSIT",26,0)
 ; ------------ Get encounter(s) from VistA ------------
"RTN","VPRDVSIT",27,0)
 ;
"RTN","VPRDVSIT",28,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's visits and appointments
"RTN","VPRDVSIT",29,0)
 N VPRCNT,VPRITM,VPRDT,VPRLOC,VPRDA
"RTN","VPRDVSIT",30,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDVSIT",31,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDVSIT",32,0)
 ;
"RTN","VPRDVSIT",33,0)
 ; get one visit
"RTN","VPRDVSIT",34,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) G ENQ
"RTN","VPRDVSIT",35,0)
 ;
"RTN","VPRDVSIT",36,0)
 ; -- get all visits
"RTN","VPRDVSIT",37,0)
 I END,END'["." S END=END_".24" ;assume end of day
"RTN","VPRDVSIT",38,0)
 S VPRCNT=0
"RTN","VPRDVSIT",39,0)
 ;F  S IDX=$Q(@IDX,-1) Q:DFN'=$P(IDX,",",2)  Q:$P(IDX,",",3)<BEG  I $P(IDX,",",5)["P" D
"RTN","VPRDVSIT",40,0)
 S VPRDT=END F  S VPRDT=$O(^AUPNVSIT("AET",DFN,VPRDT),-1)  Q:VPRDT<BEG  D  Q:VPRCNT'<MAX
"RTN","VPRDVSIT",41,0)
 . S VPRLOC=0 F  S VPRLOC=$O(^AUPNVSIT("AET",DFN,VPRDT,VPRLOC)) Q:VPRLOC<1  D
"RTN","VPRDVSIT",42,0)
 .. S VPRDA=0 F  S VPRDA=$O(^AUPNVSIT("AET",DFN,VPRDT,VPRLOC,"P",VPRDA)) Q:VPRDA<1  D
"RTN","VPRDVSIT",43,0)
 ... K VPRITM D EN1(VPRDA,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDVSIT",44,0)
 ... D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDVSIT",45,0)
ENQ ; end
"RTN","VPRDVSIT",46,0)
 K ^TMP("VPRTEXT",$J)
"RTN","VPRDVSIT",47,0)
 Q
"RTN","VPRDVSIT",48,0)
 ;
"RTN","VPRDVSIT",49,0)
ENAA(DFN,BEG,END,MAX,ID) ; -- find patient's visits and appointments [AA]
"RTN","VPRDVSIT",50,0)
 N IDT,DA,VPRCNT,VPRITM
"RTN","VPRDVSIT",51,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDVSIT",52,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDVSIT",53,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) Q  ;one visit
"RTN","VPRDVSIT",54,0)
 D IDT S VPRCNT=0
"RTN","VPRDVSIT",55,0)
 S IDT=BEG F  S IDT=$O(^AUPNVSIT("AA",DFN,IDT)) Q:IDT<1!(IDT>END)  D  Q:VPRCNT'<MAX
"RTN","VPRDVSIT",56,0)
 . S DA=0 F  S DA=$O(^AUPNVSIT("AA",DFN,IDT,DA)) Q:DA<1  D
"RTN","VPRDVSIT",57,0)
 .. K VPRITM D EN1(DA,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDVSIT",58,0)
 .. D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDVSIT",59,0)
 Q
"RTN","VPRDVSIT",60,0)
IDT ; -- invert BEG and END dates for visit format:
"RTN","VPRDVSIT",61,0)
 ;  IDT=(9999999-$P(VDT,"."))_"."_$P(VDT,".",2)
"RTN","VPRDVSIT",62,0)
 N X S X=BEG
"RTN","VPRDVSIT",63,0)
 S BEG=(9999999-$P(END,"."))
"RTN","VPRDVSIT",64,0)
 S END=(9999999-$P(X,"."))_".2359"
"RTN","VPRDVSIT",65,0)
 Q
"RTN","VPRDVSIT",66,0)
 ;
"RTN","VPRDVSIT",67,0)
EN1(IEN,VST) ; -- return a visit in VST("attribute")=value
"RTN","VPRDVSIT",68,0)
 N X0,X15,X,FAC,LOC,CATG,INPT,DA
"RTN","VPRDVSIT",69,0)
 K VST,^TMP("VPRTEXT",$J)
"RTN","VPRDVSIT",70,0)
 S IEN=+$G(IEN) Q:IEN<1  ;invalid
"RTN","VPRDVSIT",71,0)
 D ENCEVENT^PXAPI(IEN)
"RTN","VPRDVSIT",72,0)
 S X0=$G(^TMP("PXKENC",$J,IEN,"VST",IEN,0)),X15=$G(^(150))
"RTN","VPRDVSIT",73,0)
 Q:$P(X15,U,3)'="P"  Q:$P(X0,U,7)="E"  ;want primary, not historical
"RTN","VPRDVSIT",74,0)
 I $P(X0,U,7)="H" D ADM(IEN,+X0,.VST) Q
"RTN","VPRDVSIT",75,0)
 S VST("id")=IEN,VST("dateTime")=+X0
"RTN","VPRDVSIT",76,0)
 S FAC=+$P(X0,U,6),CATG=$P(X0,U,7),LOC=+$P(X0,U,22)
"RTN","VPRDVSIT",77,0)
 S:FAC VST("facility")=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDVSIT",78,0)
 S:'FAC VST("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDVSIT",79,0)
 S VST("serviceCategory")=CATG_U_$$CATG(CATG)
"RTN","VPRDVSIT",80,0)
 S VST("visitString")=LOC_";"_+X0_";"_CATG
"RTN","VPRDVSIT",81,0)
 S INPT=$P(X15,U,2) S:INPT="" INPT=$S("H^I^R^D"[CATG:1,1:0)
"RTN","VPRDVSIT",82,0)
 S X=$$CPT(IEN) S:X VST("type")=$P($$CPT^ICPTCOD(X),U,2,3)
"RTN","VPRDVSIT",83,0)
 I 'X S VST("type")=U_$S('INPT&LOC:$P($G(^SC(LOC,0)),U)_" VISIT",1:$$CATG(CATG))
"RTN","VPRDVSIT",84,0)
 S VST("patientClass")=$S(INPT:"IMP",1:"AMB")
"RTN","VPRDVSIT",85,0)
 S X=$P(X0,U,8) S:X VST("stopCode")=$$AMIS(X) I LOC D
"RTN","VPRDVSIT",86,0)
 . N L0 S L0=$G(^SC(LOC,0))
"RTN","VPRDVSIT",87,0)
 . I 'X S VST("stopCode")=$$AMIS($P(L0,U,7))
"RTN","VPRDVSIT",88,0)
 . S VST("location")=$P(L0,U),VST("service")=$$SERV($P(L0,U,20))
"RTN","VPRDVSIT",89,0)
 . S X=$P(L0,U,18) S:X VST("creditStopCode")=$$AMIS(X)
"RTN","VPRDVSIT",90,0)
 S VST("reason")=$$POV(IEN)
"RTN","VPRDVSIT",91,0)
 ; provider(s), including taxonomy/specialty info
"RTN","VPRDVSIT",92,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,IEN,"PRV",DA)) Q:DA<1  S X0=$G(^(DA,0)) D
"RTN","VPRDVSIT",93,0)
 . S VST("provider",DA)=+X0_U_$P($G(^VA(200,+X0,0)),U)_$S($P(X0,U,4)="P":"^P^1",1:"^S^")_U_$$PROVSPC^VPRD(+X0)
"RTN","VPRDVSIT",94,0)
 ; cpt(s)
"RTN","VPRDVSIT",95,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,IEN,"CPT",DA)) Q:DA<1  S X0=$G(^(DA,0)) D
"RTN","VPRDVSIT",96,0)
 . S VST("cpt",DA)=$P($$CPT^ICPTCOD(+X0),U,2,3)
"RTN","VPRDVSIT",97,0)
 ; icd(s)
"RTN","VPRDVSIT",98,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,IEN,"POV",DA)) Q:DA<1  S X0=$G(^(DA,0)) D
"RTN","VPRDVSIT",99,0)
 . S VST("icd",DA)=$$ICD(+X0)_U_$$EXTERNAL^DILFD(9000010.07,.04,,$P(X0,U,4))_U_$S($L($P(X0,U,12)):$P(X0,U,12),1:"U")
"RTN","VPRDVSIT",100,0)
 ; note(s)
"RTN","VPRDVSIT",101,0)
 D TIU(IEN)
"RTN","VPRDVSIT",102,0)
 K ^TMP("PXKENC",$J,IEN)
"RTN","VPRDVSIT",103,0)
 Q
"RTN","VPRDVSIT",104,0)
 ;
"RTN","VPRDVSIT",105,0)
TIU(VISIT) ; -- add notes to VST("document")
"RTN","VPRDVSIT",106,0)
 N X,Y,I,VPRX,LT,NT,DA,CNT,VPRY
"RTN","VPRDVSIT",107,0)
 D FIND^DIC(8925,,.01,"QX",+$G(VISIT),,"V",,,"VPRX")
"RTN","VPRDVSIT",108,0)
 S Y="",(I,CNT)=0
"RTN","VPRDVSIT",109,0)
 F  S I=$O(VPRX("DILIST",1,I)) Q:I<1  D
"RTN","VPRDVSIT",110,0)
 . S LT=$G(VPRX("DILIST","ID",I,.01)) Q:$P(LT," ")="Addendum"
"RTN","VPRDVSIT",111,0)
 . S DA=$G(VPRX("DILIST",2,I))
"RTN","VPRDVSIT",112,0)
 . S NT=$$GET1^DIQ(8925,+DA_",",".01:1501")
"RTN","VPRDVSIT",113,0)
 . S CNT=CNT+1,VST("document",CNT)=DA_U_LT_U_NT
"RTN","VPRDVSIT",114,0)
 . S:$G(VPRTEXT) VST("document",CNT,"content")=$$TEXT^VPRDTIU(DA)
"RTN","VPRDVSIT",115,0)
 Q
"RTN","VPRDVSIT",116,0)
 ;
"RTN","VPRDVSIT",117,0)
POV(VISIT) ; -- return the primary Purpose of Visit as ICD^ProviderNarrative
"RTN","VPRDVSIT",118,0)
 N DA,Y,X,X0,ICD S Y=""
"RTN","VPRDVSIT",119,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,VISIT,"POV",DA)) Q:DA<1  S X0=$G(^(DA,0)) I $P(X0,U,12)="P" D  Q:$L(Y)
"RTN","VPRDVSIT",120,0)
 . S X=+$P(X0,U,4),ICD=$$ICD(+X0)
"RTN","VPRDVSIT",121,0)
 . S Y=ICD_U_$$EXTERNAL^DILFD(9000010.07,.04,,X)
"RTN","VPRDVSIT",122,0)
 Q Y
"RTN","VPRDVSIT",123,0)
 ;
"RTN","VPRDVSIT",124,0)
ICD(IEN) ; -- return code^description for ICD code, or "^" if error
"RTN","VPRDVSIT",125,0)
 N X0,VPRX,N,I,X,Y S IEN=+$G(IEN)
"RTN","VPRDVSIT",126,0)
 S X0=$$ICDDX^ICDCODE(IEN) I X0<0 Q "^"
"RTN","VPRDVSIT",127,0)
 S Y=$P(X0,U,2)_U_$P(X0,U,4)       ;ICD Code^Dx name
"RTN","VPRDVSIT",128,0)
 S N=$$ICDD^ICDCODE($P(Y,U),"VPRX") ;ICD Description
"RTN","VPRDVSIT",129,0)
 I N>0,$L($G(VPRX(1))) S $P(Y,U,2)=VPRX(1)
"RTN","VPRDVSIT",130,0)
 Q Y
"RTN","VPRDVSIT",131,0)
 ;
"RTN","VPRDVSIT",132,0)
CPT(VISIT) ; -- Return CPT code of encounter type
"RTN","VPRDVSIT",133,0)
 N DA,Y,X,X0 S Y=""
"RTN","VPRDVSIT",134,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,VISIT,"CPT",DA)) Q:DA<1  S X0=$G(^(DA,0)) D  Q:$L(Y)
"RTN","VPRDVSIT",135,0)
 . S X=$P(X0,U) I X?1"992"2N S Y=X Q
"RTN","VPRDVSIT",136,0)
 Q Y
"RTN","VPRDVSIT",137,0)
 ;
"RTN","VPRDVSIT",138,0)
AMIS(X) ; -- return the AMIS code^name of Credit Stop X
"RTN","VPRDVSIT",139,0)
 N Y,X0 S Y=""
"RTN","VPRDVSIT",140,0)
 S X0=$G(^DIC(40.7,+$G(X),0)) S:$L(X0) Y=$P(X0,U,2)_U_$P(X0,U)
"RTN","VPRDVSIT",141,0)
 Q Y
"RTN","VPRDVSIT",142,0)
 ;
"RTN","VPRDVSIT",143,0)
CATG(X) ; -- Return name of visit Service Category code X
"RTN","VPRDVSIT",144,0)
 N Y S Y=""
"RTN","VPRDVSIT",145,0)
 I X="A" S Y="AMBULATORY"
"RTN","VPRDVSIT",146,0)
 I X="H" S Y="HOSPITALIZATION"
"RTN","VPRDVSIT",147,0)
 I X="I" S Y="IN HOSPITAL"
"RTN","VPRDVSIT",148,0)
 I X="C" S Y="CHART REVIEW"
"RTN","VPRDVSIT",149,0)
 I X="T" S Y="TELECOMMUNICATIONS"
"RTN","VPRDVSIT",150,0)
 I X="N" S Y="NOT FOUND"
"RTN","VPRDVSIT",151,0)
 I X="S" S Y="DAY SURGERY"
"RTN","VPRDVSIT",152,0)
 I X="O" S Y="OBSERVATION"
"RTN","VPRDVSIT",153,0)
 I X="E" S Y="EVENT (HISTORICAL)"
"RTN","VPRDVSIT",154,0)
 I X="R" S Y="NURSING HOME"
"RTN","VPRDVSIT",155,0)
 I X="D" S Y="DAILY HOSPITALIZATION DATA"
"RTN","VPRDVSIT",156,0)
 I X="X" S Y="ANCILLARY PACKAGE DAILY DATA"
"RTN","VPRDVSIT",157,0)
 Q Y
"RTN","VPRDVSIT",158,0)
 ;
"RTN","VPRDVSIT",159,0)
SERV(FTS) ; -- Return #42.4 Service for a Facility Treating Specialty
"RTN","VPRDVSIT",160,0)
 N Y S Y="",FTS=+$G(FTS)
"RTN","VPRDVSIT",161,0)
 S Y=$$GET1^DIQ(45.7,FTS_",","1:3","E")
"RTN","VPRDVSIT",162,0)
 Q Y
"RTN","VPRDVSIT",163,0)
 ;
"RTN","VPRDVSIT",164,0)
ADM(IEN,DATE,ADM) ; -- return an admission in ADM("attribute")=value
"RTN","VPRDVSIT",165,0)
 N VAINDT,VADMVT,VAIP,VAIN,VAERR,HLOC,ICD,I K ADM
"RTN","VPRDVSIT",166,0)
 S IEN=+$G(IEN),DATE=+$G(DATE) Q:IEN<1  Q:DATE<1
"RTN","VPRDVSIT",167,0)
 S VAINDT=DATE D ADM^VADPT2 Q:VADMVT<1
"RTN","VPRDVSIT",168,0)
 I VADMVT=$G(^DPT(DFN,.105)) D INPT Q  ;current inpatient
"RTN","VPRDVSIT",169,0)
 S VAIP("E")=VADMVT D IN5^VADPT Q:'$G(VAIP(1))  ;deleted
"RTN","VPRDVSIT",170,0)
 S ADM("id")=IEN,ADM("patientClass")="IMP"
"RTN","VPRDVSIT",171,0)
 ; ADM("admitType")=$P($G(VAIP(4)),U,2)
"RTN","VPRDVSIT",172,0)
 S DATE=+$G(VAIP(13,1)),(ADM("dateTime"),ADM("arrivalDateTime"))=DATE,I=0
"RTN","VPRDVSIT",173,0)
 S X=$G(VAIP(7)) S:X I=I+1,ADM("provider",I)=X_"^P^1"_U_$$PROVSPC^VPRD(+X) ;primary
"RTN","VPRDVSIT",174,0)
 S X=$G(VAIP(18)) S:X I=I+1,ADM("provider",I)=X_"^A^"_U_$$PROVSPC^VPRD(+X) ;attending
"RTN","VPRDVSIT",175,0)
 S ADM("specialty")=$P($G(VAIP(8)),U,2)
"RTN","VPRDVSIT",176,0)
 S X=$$SERV(+$G(VAIP(8))),ADM("service")=X
"RTN","VPRDVSIT",177,0)
 S ICD=$$POV(IEN) S:'ICD ICD=$$PTF(DFN,VAIP(12)) ;PTF>ICD
"RTN","VPRDVSIT",178,0)
 S ADM("reason")=ICD_U_$G(VAIP(9)) ;ICD code^description^Dx text
"RTN","VPRDVSIT",179,0)
 S HLOC=+$G(^DIC(42,+$G(VAIP(5)),44))
"RTN","VPRDVSIT",180,0)
 S:HLOC ADM("location")=$P($G(^SC(HLOC,0)),U)
"RTN","VPRDVSIT",181,0)
 S ADM("facility")=$$FAC^VPRD(+HLOC),ADM("roomBed")=$P(VAIP(6),U,2)
"RTN","VPRDVSIT",182,0)
 S ADM("serviceCategory")="H^HOSPITALIZATION"
"RTN","VPRDVSIT",183,0)
 S X=$$CPT(IEN),ADM("type")=$S(X:$P($$CPT^ICPTCOD(X),U,2,3),1:U_$$CATG("H"))
"RTN","VPRDVSIT",184,0)
 I $G(VAIP(17)) D
"RTN","VPRDVSIT",185,0)
 . S ADM("departureDateTime")=+$G(VAIP(17,1))
"RTN","VPRDVSIT",186,0)
 . ; ADM("disposition")=$G(VAIP(17,3)) ;Discharge Mvt Type
"RTN","VPRDVSIT",187,0)
 S ADM("visitString")=HLOC_";"_DATE_";H"
"RTN","VPRDVSIT",188,0)
 D TIU(IEN) ;notes/summary
"RTN","VPRDVSIT",189,0)
 Q
"RTN","VPRDVSIT",190,0)
 ;
"RTN","VPRDVSIT",191,0)
INPT ; -- return current admission in ADM("attribute")=value [from ADM]
"RTN","VPRDVSIT",192,0)
 K VAINDT D INP^VADPT Q:VAIN(1)<1
"RTN","VPRDVSIT",193,0)
 S ADM("id")=IEN,ADM("patientClass")="IMP"
"RTN","VPRDVSIT",194,0)
 ; ADM("admitType")=$P($G(VAIN(8)),U,2)
"RTN","VPRDVSIT",195,0)
 S DATE=+$G(VAIN(7)),(ADM("dateTime"),ADM("arrivalDateTime"))=DATE,I=0
"RTN","VPRDVSIT",196,0)
 S X=$G(VAIN(2)) S:X I=I+1,ADM("provider",I)=X_"^P^1"_U_$$PROVSPC^VPRD(+X) ;primary
"RTN","VPRDVSIT",197,0)
 S X=$G(VAIN(11)) S:X I=I+1,ADM("provider",I)=X_"^A^"_U_$$PROVSPC^VPRD(+X) ;attending
"RTN","VPRDVSIT",198,0)
 S ADM("specialty")=$P($G(VAIN(3)),U,2)
"RTN","VPRDVSIT",199,0)
 S X=$$SERV(+$G(VAIN(3))),ADM("service")=X
"RTN","VPRDVSIT",200,0)
 S ICD=$$POV(IEN) S:'ICD ICD=$$PTF(DFN,VAIN(10)) ;PTF>ICD
"RTN","VPRDVSIT",201,0)
 S ADM("reason")=ICD_U_$G(VAIN(9)) ;ICD code^description^Dx text
"RTN","VPRDVSIT",202,0)
 S HLOC=+$G(^DIC(42,+$G(VAIN(4)),44))
"RTN","VPRDVSIT",203,0)
 S:HLOC ADM("location")=$P($G(^SC(HLOC,0)),U)
"RTN","VPRDVSIT",204,0)
 S ADM("facility")=$$FAC^VPRD(+HLOC),ADM("roomBed")=VAIN(5)
"RTN","VPRDVSIT",205,0)
 S ADM("serviceCategory")="H^HOSPITALIZATION"
"RTN","VPRDVSIT",206,0)
 S X=$$CPT(IEN),ADM("type")=$S(X:$P($$CPT^ICPTCOD(X),U,2,3),1:U_$$CATG("H"))
"RTN","VPRDVSIT",207,0)
 ; ADM("visitString")=HLOC_";"_DATE_";H"
"RTN","VPRDVSIT",208,0)
 D TIU(IEN) ;notes/summary
"RTN","VPRDVSIT",209,0)
 Q
"RTN","VPRDVSIT",210,0)
 ;
"RTN","VPRDVSIT",211,0)
PTF(DFN,PTF) ; -- return ICD code^description for a PTF record
"RTN","VPRDVSIT",212,0)
 N VPRPTF,N,VPRX
"RTN","VPRDVSIT",213,0)
 D:$G(PTF) RPC^DGPTFAPI(.VPRPTF,+PTF) I $G(VPRPTF(0))<1 Q "^"
"RTN","VPRDVSIT",214,0)
 S Y=$P($G(VPRPTF(1)),U,3)_U
"RTN","VPRDVSIT",215,0)
 S N=$$ICDD^ICDCODE(Y,"VPRX") ;ICD Description
"RTN","VPRDVSIT",216,0)
 I N>0,$L($G(VPRX(1))) S Y=Y_VPRX(1)
"RTN","VPRDVSIT",217,0)
 Q Y
"RTN","VPRDVSIT",218,0)
 ;
"RTN","VPRDVSIT",219,0)
ENC(IEN,ENC) ; -- return an encounter in ENC("attribute")=value
"RTN","VPRDVSIT",220,0)
 N X0,DATE,HLOC,TYPE,STS,X,Y K ENC
"RTN","VPRDVSIT",221,0)
 S IEN=+$G(IEN) Q:IEN<1  ;invalid ien
"RTN","VPRDVSIT",222,0)
 S ENC("id")="E"_IEN,X0=$$GETOE^SDOE(IEN) ;^SCE(IEN,0) node
"RTN","VPRDVSIT",223,0)
 S DATE=+X0,ENC("dateTime")=DATE
"RTN","VPRDVSIT",224,0)
 S HLOC=+$P(X0,U,4) I HLOC D
"RTN","VPRDVSIT",225,0)
 . S HLOC=HLOC_U_$P($G(^SC(HLOC,0)),U)
"RTN","VPRDVSIT",226,0)
 . S ENC("location")=$P(HLOC,U,2)
"RTN","VPRDVSIT",227,0)
 . S X=$$GET1^DIQ(44,+HLOC_",",9.5,"I")
"RTN","VPRDVSIT",228,0)
 . I X S ENC("service")=$$SERV(X)
"RTN","VPRDVSIT",229,0)
 S ENC("facility")=$$FAC^VPRD(+HLOC)
"RTN","VPRDVSIT",230,0)
 S STS=$$EXTERNAL^DILFD(409.68,.12,,$P(X0,U,12))
"RTN","VPRDVSIT",231,0)
 S X=$S(STS?1"INP".E:"IMP",1:"AMB"),ENC("patientClass")=X,TYPE=$E(X)
"RTN","VPRDVSIT",232,0)
 S ENC("type")=U_$S(HLOC:$P(HLOC,U,2)_" VISIT",1:$$CATG(TYPE))
"RTN","VPRDVSIT",233,0)
 S ENC("serviceCategory")=TYPE_U_$$CATG(TYPE)
"RTN","VPRDVSIT",234,0)
 S ENC("visitString")=+HLOC_";"_DATE_";"_TYPE
"RTN","VPRDVSIT",235,0)
 Q
"RTN","VPRDVSIT",236,0)
 ;
"RTN","VPRDVSIT",237,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDVSIT",238,0)
 ;
"RTN","VPRDVSIT",239,0)
XML(VISIT) ; -- Return patient visit as XML
"RTN","VPRDVSIT",240,0)
 N ATT,X,Y,NAMES,I,J
"RTN","VPRDVSIT",241,0)
 D ADD("<visit>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDVSIT",242,0)
 S ATT="" F  S ATT=$O(VISIT(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDVSIT",243,0)
 . I $O(VISIT(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDVSIT",244,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDVSIT",245,0)
 .. S I=0 F  S I=$O(VISIT(ATT,I)) Q:I<1  D
"RTN","VPRDVSIT",246,0)
 ... S X=$G(VISIT(ATT,I)),NAMES=""
"RTN","VPRDVSIT",247,0)
 ... I ATT="document" S NAMES="id^localTitle^nationalTitle^Z"
"RTN","VPRDVSIT",248,0)
 ... I ATT="provider" S NAMES="code^name^role^primary^taxonomyCode^providerType^classification^specialization^Z"
"RTN","VPRDVSIT",249,0)
 ... I ATT="cpt" S NAMES="code^name^Z"
"RTN","VPRDVSIT",250,0)
 ... I ATT="icd" S NAMES="code^name^narrative^ranking^Z"
"RTN","VPRDVSIT",251,0)
 ... S Y="<"_ATT_" "_$$LOOP ;_"/>" D ADD(Y)
"RTN","VPRDVSIT",252,0)
 ... S X=$G(VISIT(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDVSIT",253,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDVSIT",254,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDVSIT",255,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDVSIT",256,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDVSIT",257,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDVSIT",258,0)
 . S X=$G(VISIT(ATT)),Y="" Q:'$L(X)
"RTN","VPRDVSIT",259,0)
 . S NAMES="code^name^"_$S(ATT="reason":"narrative^",1:"")_"Z"
"RTN","VPRDVSIT",260,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDVSIT",261,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDVSIT",262,0)
 D ADD("</visit>")
"RTN","VPRDVSIT",263,0)
 Q
"RTN","VPRDVSIT",264,0)
 ;
"RTN","VPRDVSIT",265,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDVSIT",266,0)
 N STR,P,TAG S STR=""
"RTN","VPRDVSIT",267,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDVSIT",268,0)
 Q STR
"RTN","VPRDVSIT",269,0)
 ;
"RTN","VPRDVSIT",270,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDVSIT",271,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDVSIT",272,0)
 S @VPR@(VPRI)=X
"RTN","VPRDVSIT",273,0)
 Q
"VER")
8.0^22.0
"BLD",9095,6)
^3
**END**
**END**

