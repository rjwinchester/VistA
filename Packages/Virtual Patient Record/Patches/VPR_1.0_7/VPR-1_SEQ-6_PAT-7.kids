Released VPR*1*7 SEQ #6
Extracted from mail message
**KIDS**:VPR*1.0*7^

**INSTALL NAME**
VPR*1.0*7
"BLD",9471,0)
VPR*1.0*7^VIRTUAL PATIENT RECORD^0^3180406^y
"BLD",9471,4,0)
^9.64PA^^
"BLD",9471,6.3)
3
"BLD",9471,"ABPKG")
n
"BLD",9471,"INIT")
POST^VPRPATCH
"BLD",9471,"KRN",0)
^9.67PA^779.2^20
"BLD",9471,"KRN",.4,0)
.4
"BLD",9471,"KRN",.401,0)
.401
"BLD",9471,"KRN",.402,0)
.402
"BLD",9471,"KRN",.403,0)
.403
"BLD",9471,"KRN",.5,0)
.5
"BLD",9471,"KRN",.84,0)
.84
"BLD",9471,"KRN",3.6,0)
3.6
"BLD",9471,"KRN",3.8,0)
3.8
"BLD",9471,"KRN",9.2,0)
9.2
"BLD",9471,"KRN",9.8,0)
9.8
"BLD",9471,"KRN",9.8,"NM",0)
^9.68A^8^8
"BLD",9471,"KRN",9.8,"NM",1,0)
VPRDLRO^^0^B28036256
"BLD",9471,"KRN",9.8,"NM",2,0)
VPRDVSIT^^0^B106024378
"BLD",9471,"KRN",9.8,"NM",3,0)
VPRDJ04^^0^B48510921
"BLD",9471,"KRN",9.8,"NM",4,0)
VPRDPT^^0^B114535256
"BLD",9471,"KRN",9.8,"NM",5,0)
VPRDJ00^^0^B75961021
"BLD",9471,"KRN",9.8,"NM",6,0)
VPRDGMRC^^0^B15053458
"BLD",9471,"KRN",9.8,"NM",7,0)
VPRDJ03^^0^B54129495
"BLD",9471,"KRN",9.8,"NM",8,0)
VPRPATCH^^0^B532746
"BLD",9471,"KRN",9.8,"NM","B","VPRDGMRC",6)

"BLD",9471,"KRN",9.8,"NM","B","VPRDJ00",5)

"BLD",9471,"KRN",9.8,"NM","B","VPRDJ03",7)

"BLD",9471,"KRN",9.8,"NM","B","VPRDJ04",3)

"BLD",9471,"KRN",9.8,"NM","B","VPRDLRO",1)

"BLD",9471,"KRN",9.8,"NM","B","VPRDPT",4)

"BLD",9471,"KRN",9.8,"NM","B","VPRDVSIT",2)

"BLD",9471,"KRN",9.8,"NM","B","VPRPATCH",8)

"BLD",9471,"KRN",19,0)
19
"BLD",9471,"KRN",19.1,0)
19.1
"BLD",9471,"KRN",101,0)
101
"BLD",9471,"KRN",409.61,0)
409.61
"BLD",9471,"KRN",771,0)
771
"BLD",9471,"KRN",779.2,0)
779.2
"BLD",9471,"KRN",870,0)
870
"BLD",9471,"KRN",8989.51,0)
8989.51
"BLD",9471,"KRN",8989.52,0)
8989.52
"BLD",9471,"KRN",8994,0)
8994
"BLD",9471,"KRN","B",.4,.4)

"BLD",9471,"KRN","B",.401,.401)

"BLD",9471,"KRN","B",.402,.402)

"BLD",9471,"KRN","B",.403,.403)

"BLD",9471,"KRN","B",.5,.5)

"BLD",9471,"KRN","B",.84,.84)

"BLD",9471,"KRN","B",3.6,3.6)

"BLD",9471,"KRN","B",3.8,3.8)

"BLD",9471,"KRN","B",9.2,9.2)

"BLD",9471,"KRN","B",9.8,9.8)

"BLD",9471,"KRN","B",19,19)

"BLD",9471,"KRN","B",19.1,19.1)

"BLD",9471,"KRN","B",101,101)

"BLD",9471,"KRN","B",409.61,409.61)

"BLD",9471,"KRN","B",771,771)

"BLD",9471,"KRN","B",779.2,779.2)

"BLD",9471,"KRN","B",870,870)

"BLD",9471,"KRN","B",8989.51,8989.51)

"BLD",9471,"KRN","B",8989.52,8989.52)

"BLD",9471,"KRN","B",8994,8994)

"BLD",9471,"QUES",0)
^9.62^^
"BLD",9471,"REQB",0)
^9.611^2^2
"BLD",9471,"REQB",1,0)
VPR*1.0*5^2
"BLD",9471,"REQB",2,0)
GMRC*3.0*80^2
"BLD",9471,"REQB","B","GMRC*3.0*80",2)

"BLD",9471,"REQB","B","VPR*1.0*5",1)

"INIT")
POST^VPRPATCH
"MBREQ")
0
"PKG",571,-1)
1^1
"PKG",571,0)
VIRTUAL PATIENT RECORD^VPR^Utilities to manage a virtual copy of the patient record
"PKG",571,20,0)
^9.402P^^
"PKG",571,22,0)
^9.49I^1^1
"PKG",571,22,1,0)
1.0^3110804^3110901^1
"PKG",571,22,1,"PAH",1,0)
7^3180406
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
8
"RTN","VPRDGMRC")
0^6^B15053458^B10985584
"RTN","VPRDGMRC",1,0)
VPRDGMRC ;SLC/MKB -- Consult extract ;8/2/11  15:29
"RTN","VPRDGMRC",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,4,5,7**;Sep 01, 2011;Build 3
"RTN","VPRDGMRC",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDGMRC",4,0)
 ;
"RTN","VPRDGMRC",5,0)
 ; External References          DBIA#
"RTN","VPRDGMRC",6,0)
 ; -------------------          -----
"RTN","VPRDGMRC",7,0)
 ; ^VA(200                      10060
"RTN","VPRDGMRC",8,0)
 ; GMRCAPI                       6082
"RTN","VPRDGMRC",9,0)
 ; GMRCGUIB                      2980
"RTN","VPRDGMRC",10,0)
 ; GMRCSLM1,^TMP("GMRCR",$J)     2740
"RTN","VPRDGMRC",11,0)
 ; XUAF4                         2171
"RTN","VPRDGMRC",12,0)
 ;
"RTN","VPRDGMRC",13,0)
 ; ------------ Get consults from VistA ------------
"RTN","VPRDGMRC",14,0)
 ;
"RTN","VPRDGMRC",15,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's consults
"RTN","VPRDGMRC",16,0)
 N VPRN,VPRX,VPRITM K ^TMP("GMRCR",$J,"CS")
"RTN","VPRDGMRC",17,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDGMRC",18,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDGMRC",19,0)
 ;
"RTN","VPRDGMRC",20,0)
 D OER^GMRCSLM1(DFN,"",BEG,END,"")
"RTN","VPRDGMRC",21,0)
 S VPRN=0 F  S VPRN=$O(^TMP("GMRCR",$J,"CS",VPRN)) Q:VPRN<1!(VPRN>MAX)  S VPRX=$G(^(VPRN,0)) Q:$E(VPRX)="<"  D
"RTN","VPRDGMRC",22,0)
 . I $G(IFN),IFN'=+VPRX Q
"RTN","VPRDGMRC",23,0)
 . K VPRITM D EN1(+VPRX,.VPRITM),XML(.VPRITM)
"RTN","VPRDGMRC",24,0)
 K ^TMP("GMRCR",$J,"CS"),^TMP("VPRTEXT",$J)
"RTN","VPRDGMRC",25,0)
 Q
"RTN","VPRDGMRC",26,0)
 ;
"RTN","VPRDGMRC",27,0)
EN1(ID,CONS) ; -- return a consult in CONS("attribute")=value
"RTN","VPRDGMRC",28,0)
 ;     Expects DFN, VPRX=^TMP("GMRCR",$J,"CS",VPRN,0) [from EN]
"RTN","VPRDGMRC",29,0)
 N VPRD,X0,VPRJ,X,VPRTIU
"RTN","VPRDGMRC",30,0)
 K CONS,^TMP("VPRTEXT",$J)
"RTN","VPRDGMRC",31,0)
 S CONS("id")=ID,CONS("requested")=$P(VPRX,U,2)
"RTN","VPRDGMRC",32,0)
 S CONS("status")=$P(VPRX,U,3),CONS("service")=$P(VPRX,U,4)
"RTN","VPRDGMRC",33,0)
 S CONS("procedure")=$P(VPRX,U,5),CONS("name")=$P(VPRX,U,7)
"RTN","VPRDGMRC",34,0)
 I $P(VPRX,U,6)="*" S CONS("result")="SIGNIFICANT FINDINGS"
"RTN","VPRDGMRC",35,0)
 S CONS("orderID")=$P(VPRX,U,8),CONS("type")=$P(VPRX,U,9)
"RTN","VPRDGMRC",36,0)
 ;D DOCLIST^GMRCGUIB(.VPRD,ID) S X0=$G(VPRD(0)) ;=^GMR(123,ID,0)
"RTN","VPRDGMRC",37,0)
 D GET^GMRCAPI(.VPRD,ID) S X0=$G(VPRD(0)) ;=^GMR(123,ID,0)
"RTN","VPRDGMRC",38,0)
 S X=$P(X0,U,9) S:$L(X) CONS("urgency")=X
"RTN","VPRDGMRC",39,0)
 S X=$P(X0,U,14) S:X CONS("provider")=X_U_$P($G(^VA(200,X,0)),U)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDGMRC",40,0)
 I $O(VPRD(20,0)) D
"RTN","VPRDGMRC",41,0)
 . S X=$NA(^TMP("VPRTEXT",$J,"reason"))
"RTN","VPRDGMRC",42,0)
 . S VPRJ=0 F  S VPRJ=$O(VPRD(20,VPRJ)) Q:VPRJ<1  S @X@(VPRJ)=$G(VPRD(20,VPRJ,0))
"RTN","VPRDGMRC",43,0)
 . S CONS("reason")=X
"RTN","VPRDGMRC",44,0)
 I $D(VPRD(30))!$D(VPRD(30.1)) D
"RTN","VPRDGMRC",45,0)
 . S X=$G(VPRD(30.1)),$P(X,U,2)=""
"RTN","VPRDGMRC",46,0)
 . S:$D(VPRD(30)) $P(X,U,2)=VPRD(30)
"RTN","VPRDGMRC",47,0)
 . S:$L(X) CONS("provDx")=X
"RTN","VPRDGMRC",48,0)
 S VPRJ=0 F  S VPRJ=$O(VPRD(50,VPRJ)) Q:VPRJ<1  S X=$G(VPRD(50,VPRJ)) D
"RTN","VPRDGMRC",49,0)
 . N Y S Y=$$INFO^VPRDTIU(+X) Q:Y<1  ;draft or retracted
"RTN","VPRDGMRC",50,0)
 . S CONS("document",VPRJ)=Y
"RTN","VPRDGMRC",51,0)
 . S:$G(VPRTEXT) CONS("document",VPRJ,"content")=$$TEXT^VPRDTIU(X)
"RTN","VPRDGMRC",52,0)
 S X=$P(X0,U,21),CONS("facility")=$S(X:$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U),1:$$FAC^VPRD)
"RTN","VPRDGMRC",53,0)
 Q
"RTN","VPRDGMRC",54,0)
 ;
"RTN","VPRDGMRC",55,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDGMRC",56,0)
 ;
"RTN","VPRDGMRC",57,0)
XML(CONS) ; -- Return patient consult as XML
"RTN","VPRDGMRC",58,0)
 ;  as <element code='123' displayName='ABC' />
"RTN","VPRDGMRC",59,0)
 N ATT,X,Y,I,J,NAMES
"RTN","VPRDGMRC",60,0)
 D ADD("<consult>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDGMRC",61,0)
 S ATT="" F  S ATT=$O(CONS(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDGMRC",62,0)
 . S NAMES=$S(ATT="document":"id^localTitle^nationalTitle^vuid",ATT="provider":"code^name^"_$$PROVTAGS^VPRD,ATT="provDx":"code^name^system",1:"code^name")_"^Z"
"RTN","VPRDGMRC",63,0)
 . I $O(CONS(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDGMRC",64,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDGMRC",65,0)
 .. S I=0 F  S I=$O(CONS(ATT,I)) Q:I<1  D
"RTN","VPRDGMRC",66,0)
 ... S X=$G(CONS(ATT,I)),Y="<"_ATT_" "_$$LOOP
"RTN","VPRDGMRC",67,0)
 ... S X=$G(CONS(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDGMRC",68,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDGMRC",69,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDGMRC",70,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDGMRC",71,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDGMRC",72,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDGMRC",73,0)
 . S X=$G(CONS(ATT)),Y="" Q:'$L(X)
"RTN","VPRDGMRC",74,0)
 . I ATT="reason" D  S Y="" Q
"RTN","VPRDGMRC",75,0)
 .. S Y="<reason xml:space='preserve'>" D ADD(Y)
"RTN","VPRDGMRC",76,0)
 .. S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDGMRC",77,0)
 .. D ADD("</reason>")
"RTN","VPRDGMRC",78,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDGMRC",79,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDGMRC",80,0)
 D ADD("</consult>")
"RTN","VPRDGMRC",81,0)
 Q
"RTN","VPRDGMRC",82,0)
 ;
"RTN","VPRDGMRC",83,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDGMRC",84,0)
 N STR,P,TAG S STR=""
"RTN","VPRDGMRC",85,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMRC",86,0)
 Q STR
"RTN","VPRDGMRC",87,0)
 ;
"RTN","VPRDGMRC",88,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDGMRC",89,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDGMRC",90,0)
 S @VPR@(VPRI)=X
"RTN","VPRDGMRC",91,0)
 Q
"RTN","VPRDJ00")
0^5^B75961021^B58623073
"RTN","VPRDJ00",1,0)
VPRDJ00 ;SLC/MKB -- Patient demographics ;8/11/11  15:29
"RTN","VPRDJ00",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**2,7**;Sep 01, 2011;Build 3
"RTN","VPRDJ00",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDJ00",4,0)
 ;
"RTN","VPRDJ00",5,0)
 ; External References          DBIA#
"RTN","VPRDJ00",6,0)
 ; -------------------          -----
"RTN","VPRDJ00",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDJ00",8,0)
 ; ^DPT                         10035
"RTN","VPRDJ00",9,0)
 ; ^VA(200                      10060
"RTN","VPRDJ00",10,0)
 ; DGCV                          4156
"RTN","VPRDJ00",11,0)
 ; DGMSTAPI                      2716
"RTN","VPRDJ00",12,0)
 ; DGNTAPI                       3457
"RTN","VPRDJ00",13,0)
 ; DGPFAPI                       3860
"RTN","VPRDJ00",14,0)
 ; DGRPDB                        4807
"RTN","VPRDJ00",15,0)
 ; DIC                           2051
"RTN","VPRDJ00",16,0)
 ; DIQ                           2056
"RTN","VPRDJ00",17,0)
 ; MPIF001                       2701
"RTN","VPRDJ00",18,0)
 ; SCAPMC                        1916
"RTN","VPRDJ00",19,0)
 ; SDUTL3                        1252
"RTN","VPRDJ00",20,0)
 ; VADPT                        10061
"RTN","VPRDJ00",21,0)
 ; VAFCTFU1                      2990
"RTN","VPRDJ00",22,0)
 ; VASITE                       10112
"RTN","VPRDJ00",23,0)
 ; XUAF4                         2171
"RTN","VPRDJ00",24,0)
 ;
"RTN","VPRDJ00",25,0)
 ; All tags expect DFN, VPRID, [VPRSTART, VPRSTOP, VPRMAX, VPRTEXT]
"RTN","VPRDJ00",26,0)
 ;
"RTN","VPRDJ00",27,0)
DPT1 ; -- Demographics [VPRSTART,VPRSTOP,VPRMAX,VPRID not currently used here]
"RTN","VPRDJ00",28,0)
 N PAT,SYS S SYS=$$SITE^VASITE
"RTN","VPRDJ00",29,0)
 D DEM,SVC,PRF,ATC,SUPP,ALIAS,FAC,PC
"RTN","VPRDJ00",30,0)
 I $D(PAT)>9 D ADD^VPRDJ("PAT")
"RTN","VPRDJ00",31,0)
 Q
"RTN","VPRDJ00",32,0)
 ;
"RTN","VPRDJ00",33,0)
DEM ;-demographic data
"RTN","VPRDJ00",34,0)
 N VADM,VA,VAERR,X
"RTN","VPRDJ00",35,0)
 S X=+$$GETICN^MPIF001(DFN) S:X>1 PAT("icn")=X
"RTN","VPRDJ00",36,0)
 D DEM^VADPT S X=VADM(1),PAT("fullName")=X
"RTN","VPRDJ00",37,0)
 S PAT("familyName")=$P(X,","),PAT("givenNames")=$P(X,",",2,99)
"RTN","VPRDJ00",38,0)
 S PAT("ssn")=$P(VADM(2),U),PAT("localId")=DFN
"RTN","VPRDJ00",39,0)
 S PAT("uid")=$$SETUID^VPRUTILS("patient",DFN,DFN)
"RTN","VPRDJ00",40,0)
 S:$D(VA("BID")) PAT("briefId")=$E(X)_VA("BID")
"RTN","VPRDJ00",41,0)
 S X=+$P($P(VADM(3),U),"."),PAT("dateOfBirth")=$$JSONDT^VPRUTILS(X)
"RTN","VPRDJ00",42,0)
 S X=$P(VADM(5),U),PAT("genderCode")="urn:va:pat-gender:"_X,PAT("genderName")=$$NAME(X,"gender")
"RTN","VPRDJ00",43,0)
 S X=+$P($P(VADM(6),U),".") S:X PAT("died")=$$JSONDT^VPRUTILS(X)
"RTN","VPRDJ00",44,0)
 S X=$$GET1^DIQ(38.1,DFN_",",2,"I") S:$L(X) PAT("sensitive")=$$BOOL(X)
"RTN","VPRDJ00",45,0)
 S X=+VADM(9) S:X PAT("religionCode")="urn:va:pat-religion:"_X,PAT("religionName")=$$NAME(X,"religion")
"RTN","VPRDJ00",46,0)
 S X=$P(VADM(10),U,2) I $L(X) D  ;PAT("maritalStatus")=$E(X)
"RTN","VPRDJ00",47,0)
 . S X=$E(X),X=$S(X="S":"L",X="N":"S",1:X)
"RTN","VPRDJ00",48,0)
 . S PAT("maritalStatuses",1,"code")="urn:va:pat-maritalStatus:"_X
"RTN","VPRDJ00",49,0)
 . S PAT("maritalStatuses",1,"name")=$$NAME(X,"maritalStatus")
"RTN","VPRDJ00",50,0)
 I VADM(11) D
"RTN","VPRDJ00",51,0)
 . N I S I=0
"RTN","VPRDJ00",52,0)
 . F  S I=$O(VADM(11,I)) Q:I<1  S X=+VADM(11,I),PAT("ethnicities",X,"ethnicity")=$$GET1^DIQ(2.06,X_","_DFN_",",".01:3")
"RTN","VPRDJ00",53,0)
 I VADM(12) D
"RTN","VPRDJ00",54,0)
 . N I S I=0
"RTN","VPRDJ00",55,0)
 . F  S I=$O(VADM(12,I)) Q:I<1  S X=+VADM(12,I),PAT("races",X,"race")=$$GET1^DIQ(2.02,X_","_DFN_",",".01:3")
"RTN","VPRDJ00",56,0)
 I $G(VADM(13)) D
"RTN","VPRDJ00",57,0)
 . N I S I=+$O(VADM(13,0)),X=$P($G(VADM(13,I)),U,2)
"RTN","VPRDJ00",58,0)
 . S I=$$FIND1^DIC(.85,,"X",X)
"RTN","VPRDJ00",59,0)
 . S PAT("languageCode")=$$GET1^DIQ(.85,I_",",.02)
"RTN","VPRDJ00",60,0)
 . S PAT("languageName")=X
"RTN","VPRDJ00",61,0)
 Q
"RTN","VPRDJ00",62,0)
SVC ;-service data
"RTN","VPRDJ00",63,0)
 N VAEL,VASV,VAERR,X,Y,I,AO,IR,PGF,HNC,MST,CV
"RTN","VPRDJ00",64,0)
 D 7^VADPT
"RTN","VPRDJ00",65,0)
 S PAT("veteran","isVet")=VAEL(4)
"RTN","VPRDJ00",66,0)
 S PAT("veteran","serviceConnected")=$$BOOL(+VAEL(3))
"RTN","VPRDJ00",67,0)
 S:VAEL(3) PAT("veteran","serviceConnectionPercent")=+$P(VAEL(3),U,2)
"RTN","VPRDJ00",68,0)
 S X=+$G(^DPT(DFN,"LR")) S:X PAT("veteran","lrdfn")=X
"RTN","VPRDJ00",69,0)
 S:VAEL(2) PAT("servicePeriod")=$P(VAEL(2),U,2)
"RTN","VPRDJ00",70,0)
 I VAEL(1) D
"RTN","VPRDJ00",71,0)
 . S PAT("eligibility",+VAEL(1),"name")=$P(VAEL(1),U,2)
"RTN","VPRDJ00",72,0)
 . S PAT("eligibility",+VAEL(1),"primary")="1",I=0
"RTN","VPRDJ00",73,0)
 . F  S I=$O(VAEL(1,I)) Q:I<1  S PAT("eligibility",I)=$P(VAEL(1,I),U,2)
"RTN","VPRDJ00",74,0)
 S:$L(VAEL(8)) PAT("eligibilityStatus")=$P(VAEL(8),U,2)
"RTN","VPRDJ00",75,0)
 S:$L(VAEL(9)) PAT("meansTest")=$P(VAEL(9),U,2)
"RTN","VPRDJ00",76,0)
 ;
"RTN","VPRDJ00",77,0)
 ; exposures
"RTN","VPRDJ00",78,0)
 S AO=VASV(2),IR=VASV(3)
"RTN","VPRDJ00",79,0)
 S PGF=VASV(11)!VASV(12)!VASV(13) ;OIF/OEF
"RTN","VPRDJ00",80,0)
 S X=$$GETCUR^DGNTAPI(DFN,"HNC"),X=+($G(HNC("STAT")))
"RTN","VPRDJ00",81,0)
 S HNC=$S(X=4:1,X=5:1,X=1:0,X=6:0,1:"")
"RTN","VPRDJ00",82,0)
 S X=$P($$GETSTAT^DGMSTAPI(DFN),U,2),MST=$S(X="Y":1,X="N":0,1:"")
"RTN","VPRDJ00",83,0)
 S X=$$CVEDT^DGCV(DFN),CV=$S(+X<0:"",+X=0:0,$P(X,U,3):1,1:0)
"RTN","VPRDJ00",84,0)
 S X=AO_U_IR_U_PGF_U_HNC_U_MST_U_CV
"RTN","VPRDJ00",85,0)
 F P=1:1:6 S I=$P(X,U,P),$P(X,U,P)=$S(I:"Yes",I=0:"No",1:"Unknown")
"RTN","VPRDJ00",86,0)
 S NM="agent-orange^ionizing-radiation^sw-asia^head-neck-cancer^mst^combat-vet"
"RTN","VPRDJ00",87,0)
 F P=1:1:6 S PAT("exposures",P,"uid")="urn:va:"_$P(NM,U,P)_":"_$E($P(X,U,P)),PAT("exposures",P,"name")=$P(X,U,P)
"RTN","VPRDJ00",88,0)
 ;
"RTN","VPRDJ00",89,0)
 ; rated disabilities [DGRPDB]
"RTN","VPRDJ00",90,0)
 N VPRDIS,DIS
"RTN","VPRDJ00",91,0)
 D RDIS^DGRPDB(DFN,.VPRDIS)
"RTN","VPRDJ00",92,0)
 S I=0 F  S I=$O(VPRDIS(I)) Q:I<1  D
"RTN","VPRDJ00",93,0)
 . S DIS=VPRDIS(I) ;ien^%^sc
"RTN","VPRDJ00",94,0)
 . S PAT("disability",I,"name")=$$GET1^DIQ(31,+DIS_",",.01)
"RTN","VPRDJ00",95,0)
 . S PAT("disability",I,"sc")=+$P(DIS,U,3)
"RTN","VPRDJ00",96,0)
 . S PAT("disability",I,"disPercent")=+$P(DIS,U,2)
"RTN","VPRDJ00",97,0)
 . S PAT("disability",I,"vaCode")=+$$GET1^DIQ(31,+DIS_",",2)
"RTN","VPRDJ00",98,0)
 Q
"RTN","VPRDJ00",99,0)
PRF ;-patient record flags
"RTN","VPRDJ00",100,0)
 N VPRPF,I,NAME,TEXT
"RTN","VPRDJ00",101,0)
 Q:'$$GETACT^DGPFAPI(DFN,"VPRPF")
"RTN","VPRDJ00",102,0)
 S I=0 F  S I=$O(VPRPF(I)) Q:I<1  D
"RTN","VPRDJ00",103,0)
 . S NAME=$P(VPRPF(I,"FLAG"),U,2)
"RTN","VPRDJ00",104,0)
 . M TEXT=VPRPF(I,"NARR")
"RTN","VPRDJ00",105,0)
 . S PAT("flags",I,"name")=NAME
"RTN","VPRDJ00",106,0)
 . S PAT("flags",I,"text")=$$STRING^VPRD(.TEXT)
"RTN","VPRDJ00",107,0)
 Q
"RTN","VPRDJ00",108,0)
ATC ;-address & telecom
"RTN","VPRDJ00",109,0)
 N VAPA,I,X,P,NM
"RTN","VPRDJ00",110,0)
 S VAPA("P")="" D ADD^VADPT ;permanent address
"RTN","VPRDJ00",111,0)
 S:$L(VAPA(1)) PAT("addresses",1,"streetLine1")=VAPA(1)
"RTN","VPRDJ00",112,0)
 S X=VAPA(2) I $L(X),$L(VAPA(3)) S X=X_" "_VAPA(3)
"RTN","VPRDJ00",113,0)
 S:$L(X) PAT("addresses",1,"streetLine2")=X
"RTN","VPRDJ00",114,0)
 S:$L(VAPA(4)) PAT("addresses",1,"city")=VAPA(4)
"RTN","VPRDJ00",115,0)
 S X=$P(VAPA(5),U,2) S:$L(X) PAT("addresses",1,"stateProvince")=X
"RTN","VPRDJ00",116,0)
 S X=$P(VAPA(11),U,2) S:$L(X) PAT("addresses",1,"postalCode")=X
"RTN","VPRDJ00",117,0)
 ; 
"RTN","VPRDJ00",118,0)
 ; X=home^cell^work phones
"RTN","VPRDJ00",119,0)
 S X=$$FORMAT(VAPA(8))_U_$$FORMAT($$GET1^DIQ(2,DFN_",",.134))_U_$$FORMAT($$GET1^DIQ(2,DFN_",",.132))
"RTN","VPRDJ00",120,0)
 S NM="H^MC^WP" F P=1:1:3 I $L($P(X,U,P)) D
"RTN","VPRDJ00",121,0)
 . S I=$P(NM,U,P),PAT("telecoms",P,"usageCode")=I
"RTN","VPRDJ00",122,0)
 . S PAT("telecoms",P,"usageName")=$S(I="WP":"work place",I="MC":"mobile contact",1:"home address")
"RTN","VPRDJ00",123,0)
 . S PAT("telecoms",P,"telecom")=$P(X,U,P)
"RTN","VPRDJ00",124,0)
 Q
"RTN","VPRDJ00",125,0)
SUPP ;-support contacts
"RTN","VPRDJ00",126,0)
 N VAOA,A,I,X,TYPE,S
"RTN","VPRDJ00",127,0)
 S S=0 F A="",1 K VAOA D
"RTN","VPRDJ00",128,0)
 . S:A VAOA("A")=A D OAD^VADPT Q:'$L($G(VAOA(9)))
"RTN","VPRDJ00",129,0)
 . S S=S+1,TYPE=$S(A=1:"ECON^Emergency Contact",1:"NOK^Next of Kin")
"RTN","VPRDJ00",130,0)
 . S PAT("supports",S,"contactTypeCode")="urn:va:pat-contact:"_$P(TYPE,U)
"RTN","VPRDJ00",131,0)
 . S PAT("supports",S,"contactTypeName")=$P(TYPE,U,2)
"RTN","VPRDJ00",132,0)
 . S:$L(VAOA(9)) PAT("supports",S,"name")=VAOA(9)
"RTN","VPRDJ00",133,0)
 . S:$L(VAOA(10)) PAT("supports",S,"relationship")=VAOA(10)
"RTN","VPRDJ00",134,0)
 . S:$L(VAOA(1)) PAT("supports",S,"addresses",1,"streetLine1")=VAOA(1)
"RTN","VPRDJ00",135,0)
 . S X=VAOA(2) I $L(X),$L(VAOA(3)) S X=X_" "_VAOA(3)
"RTN","VPRDJ00",136,0)
 . S:$L(X) PAT("supports",S,"addresses",1,"streetLine2")=X
"RTN","VPRDJ00",137,0)
 . S:$L(VAOA(4)) PAT("supports",S,"addresses",1,"city")=VAOA(4)
"RTN","VPRDJ00",138,0)
 . S X=$P(VAOA(5),U,2) S:$L(X) PAT("supports",S,"addresses",1,"stateProvince")=X
"RTN","VPRDJ00",139,0)
 . S X=$P(VAOA(11),U,2) S:$L(X) PAT("supports",S,"addresses",1,"postalCode")=X
"RTN","VPRDJ00",140,0)
 . S I=$S(A=1:.33011,1:.21011),X=$$FORMAT(VAOA(8))_U_U_$$FORMAT($$GET1^DIQ(2,DFN_",",I))
"RTN","VPRDJ00",141,0)
 . ; X=home^cell^work phones
"RTN","VPRDJ00",142,0)
 . S NM="H^MC^WP" F P=1:1:3 I $L($P(X,U,P)) D
"RTN","VPRDJ00",143,0)
 .. S I=$P(NM,U,P),PAT("supports",S,"telecomList",P,"usageCode")=I
"RTN","VPRDJ00",144,0)
 .. S PAT("supports",S,"telecomList",P,"usageName")=$S(I="WP":"work place",I="MC":"mobile contact",1:"home address")
"RTN","VPRDJ00",145,0)
 .. S PAT("supports",S,"telecomList",P,"telecom")=$P(X,U,P)
"RTN","VPRDJ00",146,0)
 Q
"RTN","VPRDJ00",147,0)
ALIAS ;-other names used
"RTN","VPRDJ00",148,0)
 N I,X
"RTN","VPRDJ00",149,0)
 S I=0 F  S I=$O(^DPT(DFN,.01,I)) Q:I<1  S X=$P($G(^(I,0)),U) D
"RTN","VPRDJ00",150,0)
 . S PAT("aliases",I,"fullName")=X
"RTN","VPRDJ00",151,0)
 . S PAT("aliases",I,"familyName")=$P(X,",")
"RTN","VPRDJ00",152,0)
 . S PAT("aliases",I,"givenNames")=$P(X,",",2,99)
"RTN","VPRDJ00",153,0)
 Q
"RTN","VPRDJ00",154,0)
FAC ;-treating facilities [see FACLIST^ORWCIRN]
"RTN","VPRDJ00",155,0)
 N IFN S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDJ00",156,0)
 N VPRY,HOME,LAST,I,X,IEN,VASITE
"RTN","VPRDJ00",157,0)
 S X=$$ALL^VASITE ;VASITE(stn#)=stn# for all local
"RTN","VPRDJ00",158,0)
 I $L($T(TFL^VAFCTFU1)) D TFL^VAFCTFU1(.VPRY,DFN)
"RTN","VPRDJ00",159,0)
 S HOME=+$P($G(^DPT(DFN,"MPI")),U,3) ;home facility
"RTN","VPRDJ00",160,0)
 I $P($G(VPRY(1)),U)<0 D  ;not setup
"RTN","VPRDJ00",161,0)
 . S X=$O(^AUPNVSIT("AA",DFN,0)),LAST=$S(X:9999999-$P(X,"."),1:"")
"RTN","VPRDJ00",162,0)
 . S X=$$SITE^VASITE
"RTN","VPRDJ00",163,0)
 . S VPRY(1)=$P(X,U,3)_U_$P(X,U,2)_U_LAST_U_$$GET1^DIQ(4,+X_",",60)
"RTN","VPRDJ00",164,0)
 S I=0 F  S I=$O(VPRY(I)) Q:I<1  D
"RTN","VPRDJ00",165,0)
 . S X=VPRY(I) Q:$P(X,U)=""  ;unknown
"RTN","VPRDJ00",166,0)
 . S IEN=+$$IEN^XUAF4($P(X,U))
"RTN","VPRDJ00",167,0)
 . I +X=776!(+X=200) S $P(X,U,2)="DEPT. OF DEFENSE"
"RTN","VPRDJ00",168,0)
 . S PAT("facilities",I,"code")=$P(X,U)    ;stn#
"RTN","VPRDJ00",169,0)
 . S PAT("facilities",I,"name")=$P(X,U,2)  ;name
"RTN","VPRDJ00",170,0)
 . S:IEN=HOME PAT("facilities",I,"homeSite")="true"
"RTN","VPRDJ00",171,0)
 . S:$L($P(X,U,3)) PAT("facilities",I,"latestDate")=$$JSONDT^VPRUTILS($P($P(X,U,3),"."))
"RTN","VPRDJ00",172,0)
 . I $D(VASITE(+X)) D
"RTN","VPRDJ00",173,0)
 .. S PAT("facilities",I,"localPatientId")=DFN
"RTN","VPRDJ00",174,0)
 .. S PAT("facilities",I,"systemId")=VPRSYS
"RTN","VPRDJ00",175,0)
 Q
"RTN","VPRDJ00",176,0)
PC ;-primary care assignments
"RTN","VPRDJ00",177,0)
 N X,I,VPRT,PRV,POS
"RTN","VPRDJ00",178,0)
 S X=$$OUTPTPR^SDUTL3(DFN) I X D
"RTN","VPRDJ00",179,0)
 . S PAT("pcProviderUid")=$$SETUID^VPRUTILS("user",,+X)
"RTN","VPRDJ00",180,0)
 . S PAT("pcProviderName")=$P(X,U,2)
"RTN","VPRDJ00",181,0)
 S X=$$OUTPTTM^SDUTL3(DFN) I X D
"RTN","VPRDJ00",182,0)
 . S PAT("pcTeamUid")=$$SETUID^VPRUTILS("team",,+X)
"RTN","VPRDJ00",183,0)
 . S PAT("pcTeamName")=$$GET1^DIQ(404.51,+X_",",.01)
"RTN","VPRDJ00",184,0)
 . S X=$$PRTM^SCAPMC(+X,,,,.VPRT) Q:'X
"RTN","VPRDJ00",185,0)
 . S (I,PRV)=0 F  S PRV=+$O(@VPRT@("SCPR",PRV)) Q:PRV<1  D
"RTN","VPRDJ00",186,0)
 .. S POS=$O(@VPRT@("SCPR",PRV,0)),I=I+1
"RTN","VPRDJ00",187,0)
 .. S PAT("pcTeamMembers",I,"uid")=$$SETUID^VPRUTILS("user",,PRV)
"RTN","VPRDJ00",188,0)
 .. S PAT("pcTeamMembers",I,"name")=$P($G(^VA(200,PRV,0)),U)
"RTN","VPRDJ00",189,0)
 .. S PAT("pcTeamMembers",I,"position")=$$GET1^DIQ(404.57,POS_",",.01)
"RTN","VPRDJ00",190,0)
 I $G(^DPT(DFN,.105)) S PAT("inpatient")="true"
"RTN","VPRDJ00",191,0)
 Q
"RTN","VPRDJ00",192,0)
 ;
"RTN","VPRDJ00",193,0)
FORMAT(X) ; -- enforce (xxx)xxx-xxxx phone format
"RTN","VPRDJ00",194,0)
 S X=$G(X) I X?1"("3N1")"3N1"-"4N.E Q X
"RTN","VPRDJ00",195,0)
 N P,N,I,Y S P=""
"RTN","VPRDJ00",196,0)
 F I=1:1:$L(X) S N=$E(X,I) I N=+N S P=P_N
"RTN","VPRDJ00",197,0)
 S:$L(P)<10 P=$E("0000000000",1,10-$L(P))_P
"RTN","VPRDJ00",198,0)
 S Y=$S(P:"("_$E(P,1,3)_")"_$E(P,4,6)_"-"_$E(P,7,10),1:"")
"RTN","VPRDJ00",199,0)
 Q Y
"RTN","VPRDJ00",200,0)
 ;
"RTN","VPRDJ00",201,0)
NAME(CODE,SET) ; -- Return expanded name for code set
"RTN","VPRDJ00",202,0)
 N Y S Y="",CODE=$G(CODE)
"RTN","VPRDJ00",203,0)
 I $G(SET)="gender" S Y=$S(CODE="F":"Female",CODE="M":"Male",1:"Unknown")
"RTN","VPRDJ00",204,0)
 I $G(SET)="maritalStatus" S Y=$S(CODE="D":"Divorced",CODE="M":"Married",CODE="W":"Widowed",CODE="L":"Legally Separated",CODE="S":"Never Married",1:"Unknown")
"RTN","VPRDJ00",205,0)
 I $G(SET)="religion" S Y=$$GET1^DIQ(13,CODE_",",.01)
"RTN","VPRDJ00",206,0)
 Q Y
"RTN","VPRDJ00",207,0)
 ;
"RTN","VPRDJ00",208,0)
BOOL(X) ;
"RTN","VPRDJ00",209,0)
 Q $S(X>0:"true",1:"false")
"RTN","VPRDJ03")
0^7^B54129495^B49743518
"RTN","VPRDJ03",1,0)
VPRDJ03 ;SLC/MKB -- Consults,ClinProcedures,CLiO ;6/25/12  16:11
"RTN","VPRDJ03",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**2,7**;Sep 01, 2011;Build 3
"RTN","VPRDJ03",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDJ03",4,0)
 ;
"RTN","VPRDJ03",5,0)
 ; External References          DBIA#
"RTN","VPRDJ03",6,0)
 ; -------------------          -----
"RTN","VPRDJ03",7,0)
 ; ^SC                          10040
"RTN","VPRDJ03",8,0)
 ; ^TIU(8925.1                   5677
"RTN","VPRDJ03",9,0)
 ; ^VA(200                      10060
"RTN","VPRDJ03",10,0)
 ; %DT                          10003
"RTN","VPRDJ03",11,0)
 ; DILFD                         2055
"RTN","VPRDJ03",12,0)
 ; DIQ                           2056
"RTN","VPRDJ03",13,0)
 ; GMRCAPI                       6082
"RTN","VPRDJ03",14,0)
 ; GMRCGUIB                      2980
"RTN","VPRDJ03",15,0)
 ; GMRCSLM1,^TMP("GMRCR"         2740
"RTN","VPRDJ03",16,0)
 ; MCARUTL3                      3280
"RTN","VPRDJ03",17,0)
 ; MDPS1,^TMP("MDHSP"            4230
"RTN","VPRDJ03",18,0)
 ; ORX8                          2467
"RTN","VPRDJ03",19,0)
 ; TIULQ                         2693
"RTN","VPRDJ03",20,0)
 ; TIUSRVLO                      2834
"RTN","VPRDJ03",21,0)
 ; XLFSTR                       10104
"RTN","VPRDJ03",22,0)
 ; XUAF4                         2171
"RTN","VPRDJ03",23,0)
 ;
"RTN","VPRDJ03",24,0)
 ; All tags expect DFN, ID, [VPRSTART, VPRSTOP, VPRMAX, VPRTEXT]
"RTN","VPRDJ03",25,0)
 ;
"RTN","VPRDJ03",26,0)
GMRC1(ID) ; -- consult/request VPRX=^TMP("GMRCR",$J,"CS",VPRN,0)
"RTN","VPRDJ03",27,0)
 N CONS,ORDER,VPRD,X0,X,VPRJ,VPRTIU,NT,VPRSN
"RTN","VPRDJ03",28,0)
 S CONS("localId")=+VPRX,CONS("uid")=$$SETUID^VPRUTILS("consult",DFN,+VPRX)
"RTN","VPRDJ03",29,0)
 S CONS("dateTime")=$$JSONDT^VPRUTILS($P(VPRX,U,2))
"RTN","VPRDJ03",30,0)
 S CONS("statusName")=$P(VPRX,U,3),CONS("service")=$P(VPRX,U,4)
"RTN","VPRDJ03",31,0)
 S CONS("consultProcedure")=$P(VPRX,U,5)
"RTN","VPRDJ03",32,0)
 I $P(VPRX,U,6)="*" S CONS("interpretation")="SIGNIFICANT FINDINGS"
"RTN","VPRDJ03",33,0)
 S CONS("typeName")=$P(VPRX,U,7),CONS("category")=$P(VPRX,U,9)
"RTN","VPRDJ03",34,0)
 S ORDER=+$P(VPRX,U,8),CONS("orderName")=$P($$OI^ORX8(ORDER),U,2)
"RTN","VPRDJ03",35,0)
 S CONS("orderUid")=$$SETUID^VPRUTILS("order",DFN,ORDER)
"RTN","VPRDJ03",36,0)
 ;D DOCLIST^GMRCGUIB(.VPRD,+VPRX) S X0=$G(VPRD(0)) ;=^GMR(123,ID,0)
"RTN","VPRDJ03",37,0)
 D GET^GMRCAPI(.VPRD,+VPRX) S X0=$G(VPRD(0)) ;=^GMR(123,ID,0)
"RTN","VPRDJ03",38,0)
 S X=$P(X0,U,9) S:$L(X) CONS("urgency")=X
"RTN","VPRDJ03",39,0)
 S X=+$P(X0,U,14) I X D  ;ordering provider
"RTN","VPRDJ03",40,0)
 . S CONS("providerUid")=$$SETUID^VPRUTILS("user",,X)
"RTN","VPRDJ03",41,0)
 . S CONS("providerName")=$P($G(^VA(200,X,0)),U)
"RTN","VPRDJ03",42,0)
 I $O(VPRD(20,0)) M VPRSN=VPRD(20) S CONS("reason")=$$STRING^VPRD(.VPRSN)
"RTN","VPRDJ03",43,0)
 I $D(VPRD(30))!$D(VPRD(30.1)) D
"RTN","VPRDJ03",44,0)
 . S:$D(VPRD(30)) CONS("provisionalDx","name")=VPRD(30)
"RTN","VPRDJ03",45,0)
 . S:$D(VPRD(30.1)) CONS("provisionalDx","code")=$P(VPRD(30.1),U),CONS("provisionalDx","system")=$P(VPRD(30.1),U,3)
"RTN","VPRDJ03",46,0)
 S VPRJ=0 F  S VPRJ=$O(VPRD(50,VPRJ)) Q:VPRJ<1  S X=$G(VPRD(50,VPRJ)) D
"RTN","VPRDJ03",47,0)
 . Q:'$D(@(U_$P(X,";",2)_+X_")"))  ;text deleted
"RTN","VPRDJ03",48,0)
 . S CONS("results",VPRJ,"uid")=$$SETUID^VPRUTILS("document",DFN,+X)
"RTN","VPRDJ03",49,0)
 . D EXTRACT^TIULQ(+X,"VPRTIU",,.01)
"RTN","VPRDJ03",50,0)
 . S CONS("results",VPRJ,"localTitle")=$G(VPRTIU(+X,.01,"E"))
"RTN","VPRDJ03",51,0)
 . S NT=$$GET1^DIQ(8925.1,+$G(VPRTIU(+X,.01,"I"))_",",1501)
"RTN","VPRDJ03",52,0)
 . S:$L(NT) CONS("results",VPRJ,"nationalTitle")=NT
"RTN","VPRDJ03",53,0)
 S X=$P(X0,U,21),X=$S(X:$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U),1:$$FAC^VPRD)
"RTN","VPRDJ03",54,0)
 D FACILITY^VPRUTILS(X,"CONS")
"RTN","VPRDJ03",55,0)
 D ADD^VPRDJ("CONS","consult")
"RTN","VPRDJ03",56,0)
 Q
"RTN","VPRDJ03",57,0)
 ;
"RTN","VPRDJ03",58,0)
MDPS1(DFN,BEG,END,MAX) ; -- perform CP search (scope variables)
"RTN","VPRDJ03",59,0)
 N MCARCODE,MCARDT,MCARPROC,MCESKEY,MCESSEC,MCFILE,MDC,MDIMG,RES
"RTN","VPRDJ03",60,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDJ03",61,0)
 K ^TMP("MDHSP",$J) S RES=""
"RTN","VPRDJ03",62,0)
 D EN1^MDPS1(.RES,DFN,BEG,END,MAX,"",0) ;RES=^TMP("MDHSP",$J)
"RTN","VPRDJ03",63,0)
 Q
"RTN","VPRDJ03",64,0)
 ;
"RTN","VPRDJ03",65,0)
MC1(ID) ; -- clinical procedure VPRX=^TMP("MDHSP",$J,VPRN)
"RTN","VPRDJ03",66,0)
 N X,Y,%DT,DATE,RTN,GBL,CONS,TIUN,VPRD,X0,PROC,VPRT,LOC,FAC
"RTN","VPRDJ03",67,0)
 S RTN=$P(VPRX,U,3,4) Q:RTN="PRPRO^MDPS4"  ;skip non-CP items
"RTN","VPRDJ03",68,0)
 S X=$P(VPRX,U,6),%DT="TXS" D ^%DT Q:Y'>0  S DATE=Y
"RTN","VPRDJ03",69,0)
 S GBL=+$P(VPRX,U,2)_";"_$S(RTN="PR702^MDPS1":"MDD(702,",1:$$ROOT^VPRDMC(DFN,$P(VPRX,U,11),DATE))
"RTN","VPRDJ03",70,0)
 Q:'GBL  I $G(ID),ID'=GBL Q                ;unknown, or not requested
"RTN","VPRDJ03",71,0)
 ;
"RTN","VPRDJ03",72,0)
 S CONS=+$P(VPRX,U,13) D:CONS DOCLIST^GMRCGUIB(.VPRD,CONS) S X0=$G(VPRD(0)) ;=^GMR(123,ID,0)
"RTN","VPRDJ03",73,0)
 S TIUN=+$P(VPRX,U,14) S:TIUN TIUN=TIUN_U_$$RESOLVE^TIUSRVLO(TIUN)
"RTN","VPRDJ03",74,0)
 S PROC("localId")=GBL,PROC("category")="CP"
"RTN","VPRDJ03",75,0)
 S PROC("uid")=$$SETUID^VPRUTILS("procedure",DFN,GBL)
"RTN","VPRDJ03",76,0)
 S PROC("name")=$P(VPRX,U),PROC("dateTime")=$$JSONDT^VPRUTILS(DATE)
"RTN","VPRDJ03",77,0)
 S X=$P(VPRX,U,7) S:$L(X) PROC("interpretation")=X
"RTN","VPRDJ03",78,0)
 S PROC("kind")="Procedure"
"RTN","VPRDJ03",79,0)
 I CONS,X0 D
"RTN","VPRDJ03",80,0)
 . N VPRJ S PROC("requested")=$$JSONDT^VPRUTILS(+X0)
"RTN","VPRDJ03",81,0)
 . S PROC("consultUid")=$$SETUID^VPRUTILS("consult",DFN,CONS)
"RTN","VPRDJ03",82,0)
 . S PROC("orderUid")=$$SETUID^VPRUTILS("order",DFN,+$P(X0,U,3))
"RTN","VPRDJ03",83,0)
 . S PROC("statusName")=$$EXTERNAL^DILFD(123,8,,$P(X0,U,12))
"RTN","VPRDJ03",84,0)
 . S VPRJ=0 F  S VPRJ=$O(VPRD(50,VPRJ)) Q:VPRJ<1  S X=+$G(VPRD(50,VPRJ)) D
"RTN","VPRDJ03",85,0)
 .. D NOTE(X)
"RTN","VPRDJ03",86,0)
 .. S:'TIUN TIUN=X_U_$$RESOLVE^TIUSRVLO(X)
"RTN","VPRDJ03",87,0)
 I TIUN D
"RTN","VPRDJ03",88,0)
 . S X=$P(TIUN,U,5) I X D
"RTN","VPRDJ03",89,0)
 .. S PROC("providers",1,"providerUid")=$$SETUID^VPRUTILS("user",,+X)
"RTN","VPRDJ03",90,0)
 .. S PROC("providers",1,"providerName")=$P(X,";",3)
"RTN","VPRDJ03",91,0)
 . S:$P(TIUN,U,11) PROC("hasImages")="true"
"RTN","VPRDJ03",92,0)
 . K VPRT D EXTRACT^TIULQ(+TIUN,"VPRT",,".03;.05;1211",,,"I")
"RTN","VPRDJ03",93,0)
 . S X=+$G(VPRT(+TIUN,.03,"I")),PROC("encounterUid")=$$SETUID^VPRUTILS("visit",DFN,X)
"RTN","VPRDJ03",94,0)
 . S LOC=+$G(VPRT(+TIUN,1211,"I")) I LOC S LOC=LOC_U_$P($G(^SC(LOC,0)),U)
"RTN","VPRDJ03",95,0)
 . E  S X=$P(TIUN,U,6) S:$L(X) LOC=+$O(^SC("B",X,0))_U_X
"RTN","VPRDJ03",96,0)
 . S:LOC PROC("locationUid")=$$SETUID^VPRUTILS("location",,+LOC),PROC("locationName")=$P(LOC,U,2),FAC=$$FAC^VPRD(+LOC)
"RTN","VPRDJ03",97,0)
 . I '$D(PROC("statusName")) S X=+$G(VPRT(+TIUN,.05,"I")),PROC("statusName")=$S(X<6:"PARTIAL RESULTS",1:"COMPLETE")
"RTN","VPRDJ03",98,0)
 . I '$G(PROC("results",+TIUN)) D NOTE(+TIUN)
"RTN","VPRDJ03",99,0)
 ; if no consult or note/visit ...
"RTN","VPRDJ03",100,0)
 S:'$D(PROC("statusName")) PROC("statusName")="COMPLETE"
"RTN","VPRDJ03",101,0)
 I '$D(FAC) S X=$P(X0,U,21),FAC=$S(X:$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U),1:$$FAC^VPRD)
"RTN","VPRDJ03",102,0)
 D FACILITY^VPRUTILS(FAC,"PROC")
"RTN","VPRDJ03",103,0)
 D ADD^VPRDJ("PROC","procedure")
"RTN","VPRDJ03",104,0)
 Q
"RTN","VPRDJ03",105,0)
 ;
"RTN","VPRDJ03",106,0)
NOTE(DA) ; -- add TIU note info
"RTN","VPRDJ03",107,0)
 N VPRT,NT,TEXT
"RTN","VPRDJ03",108,0)
 D EXTRACT^TIULQ(DA,"VPRT",,.01)
"RTN","VPRDJ03",109,0)
 S PROC("results",DA,"uid")=$$SETUID^VPRUTILS("document",+$G(DFN),DA)
"RTN","VPRDJ03",110,0)
 S PROC("results",DA,"localTitle")=$G(VPRT(DA,.01,"E"))
"RTN","VPRDJ03",111,0)
 S NT=$$GET1^DIQ(8925.1,+$G(VPRT(DA,.01,"I"))_",",1501)
"RTN","VPRDJ03",112,0)
 S:$L(NT) PROC("results",DA,"nationalTitle")=NT
"RTN","VPRDJ03",113,0)
 Q
"RTN","VPRDJ03",114,0)
 ;
"RTN","VPRDJ03",115,0)
MDC1(ID) ; -- clinical observation
"RTN","VPRDJ03",116,0)
 N GUID,CLIO,VPRC,VPRT,LOC,FAC,I,X,Y
"RTN","VPRDJ03",117,0)
 S GUID=$G(ID) Q:GUID=""  ;invalid GUID
"RTN","VPRDJ03",118,0)
 D QRYOBS^VPRDMDC("VPRC",GUID) Q:'$D(VPRC)  ;doesn't exist
"RTN","VPRDJ03",119,0)
 Q:$L($G(VPRC("PARENT_ID","E")))            ;PARENT also in list
"RTN","VPRDJ03",120,0)
 ;
"RTN","VPRDJ03",121,0)
 S CLIO("localId")=GUID,CLIO("uid")=$$SETUID^VPRUTILS("obs",DFN,GUID)
"RTN","VPRDJ03",122,0)
 S X=$G(VPRC("TERM_ID","I")) S:X CLIO("typeVuid")="urn:va:vuid:"_X
"RTN","VPRDJ03",123,0)
 S CLIO("typeCode")="urn:va:clioterminology:"_$G(VPRC("TERM_ID","GUID"))
"RTN","VPRDJ03",124,0)
 S CLIO("typeName")=$G(VPRC("TERM_ID","E"))
"RTN","VPRDJ03",125,0)
 S CLIO("result")=$G(VPRC("SVALUE","E"))
"RTN","VPRDJ03",126,0)
 S X=$G(VPRC("UNIT_ID","ABBV")) S:$L(X) CLIO("units")=X
"RTN","VPRDJ03",127,0)
 S X=$G(VPRC("ENTERED_DATE_TIME","I")),CLIO("entered")=$$JSONDT^VPRUTILS(X)
"RTN","VPRDJ03",128,0)
 S X=$G(VPRC("OBSERVED_DATE_TIME","I")),CLIO("observed")=$$JSONDT^VPRUTILS(X)
"RTN","VPRDJ03",129,0)
 D QRYTYPES^VPRDMDC("VPRT")
"RTN","VPRDJ03",130,0)
 F I=3,5 S X=$G(VPRT(I,"XML")) I $L($G(VPRC(X,"E"))) D
"RTN","VPRDJ03",131,0)
 . S Y=VPRT(I,"NAME"),Y=$S(Y="LOCATION":"bodySite",1:$$LOW^XLFSTR(Y))
"RTN","VPRDJ03",132,0)
 . S CLIO(Y_"Code")=VPRC(X,"I"),CLIO(Y_"Name")=VPRC(X,"E")
"RTN","VPRDJ03",133,0)
 F I=4,6,7 S X=$G(VPRT(I,"XML")) I $L($G(VPRC(X,"E"))) D
"RTN","VPRDJ03",134,0)
 . S CLIO("qualifiers",I,"type")=$$LOW^XLFSTR(VPRT(I,"NAME"))
"RTN","VPRDJ03",135,0)
 . S CLIO("qualifiers",I,"code")=VPRC(X,"I")
"RTN","VPRDJ03",136,0)
 . S CLIO("qualifiers",I,"name")=VPRC(X,"E")
"RTN","VPRDJ03",137,0)
 S X=$G(VPRC("RANGE","E")) I $L(X) D
"RTN","VPRDJ03",138,0)
 . S Y=$S(X="Out of Bounds Low":"<",X="Out of Bounds High":">",1:$E(X))
"RTN","VPRDJ03",139,0)
 . S CLIO("interpretationCode")="urn:hl7:observation-interpretation:"_Y
"RTN","VPRDJ03",140,0)
 . S CLIO("interpretationName")=$S(X="<":"Low off scale",X=">":"High off scale",1:X)
"RTN","VPRDJ03",141,0)
 ; X=$G(VPRC("STATUS","E")) S:$L(X) CLIO("resultStatus")=$S(X="unverified":"active",1:"complete")
"RTN","VPRDJ03",142,0)
 I $D(VPRC("SUPP_PAGE")) D  ;add set info
"RTN","VPRDJ03",143,0)
 . S CLIO("setID")=$G(VPRC("SUPP_PAGE","GUID"))
"RTN","VPRDJ03",144,0)
 . S CLIO("setName")=$G(VPRC("SUPP_PAGE","DISPLAY_NAME"))
"RTN","VPRDJ03",145,0)
 . S X=$G(VPRC("SUPP_PAGE","TYPE")) S:$L(X) CLIO("setType")=X
"RTN","VPRDJ03",146,0)
 . S X=$G(VPRC("SUPP_PAGE","ACTIVATED_DATE_TIME")) S:X CLIO("setStart")=$$JSONDT^VPRUTILS(X)
"RTN","VPRDJ03",147,0)
 . S X=$G(VPRC("SUPP_PAGE","DEACTIVATED_DATE_TIME")) S:X CLIO("setStop")=$$JSONDT^VPRUTILS(X)
"RTN","VPRDJ03",148,0)
 S CLIO("statusCode")="urn:va:observation-status:complete",CLIO("statusName")="complete"
"RTN","VPRDJ03",149,0)
 S LOC=$G(VPRC("HOSPITAL_LOCATION_ID","I")),FAC=$$FAC^VPRD(LOC)
"RTN","VPRDJ03",150,0)
 S CLIO("locationUid")=$$SETUID^VPRUTILS("location",,LOC)
"RTN","VPRDJ03",151,0)
 S CLIO("locationName")=$G(VPRC("HOSPITAL_LOCATION_ID","E"))
"RTN","VPRDJ03",152,0)
 D FACILITY^VPRUTILS(FAC,"CLIO")
"RTN","VPRDJ03",153,0)
 S X=$G(VPRC("COMMENT","E")) S:$L(X) CLIO("comment")=X
"RTN","VPRDJ03",154,0)
 D ADD^VPRDJ("CLIO","obs")
"RTN","VPRDJ03",155,0)
 Q
"RTN","VPRDJ04")
0^3^B48510921^B48088220
"RTN","VPRDJ04",1,0)
VPRDJ04 ;SLC/MKB -- Appointments,Visits ;6/25/12  16:11
"RTN","VPRDJ04",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**2,5,7**;Sep 01, 2011;Build 3
"RTN","VPRDJ04",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDJ04",4,0)
 ;
"RTN","VPRDJ04",5,0)
 ; External References          DBIA#
"RTN","VPRDJ04",6,0)
 ; -------------------          -----
"RTN","VPRDJ04",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDJ04",8,0)
 ; ^DGS(41.1                     3796
"RTN","VPRDJ04",9,0)
 ; ^DIC(42                      10039
"RTN","VPRDJ04",10,0)
 ; ^SC                          10040
"RTN","VPRDJ04",11,0)
 ; ^VA(200                      10060
"RTN","VPRDJ04",12,0)
 ; DIQ                           2056
"RTN","VPRDJ04",13,0)
 ; ICPTCOD                       1995
"RTN","VPRDJ04",14,0)
 ; PXAPI,^TMP("PXKENC",$J        1894
"RTN","VPRDJ04",15,0)
 ; SDAMA301                      4433
"RTN","VPRDJ04",16,0)
 ; XLFDT                        10103
"RTN","VPRDJ04",17,0)
 ; XLFSTR                       10104
"RTN","VPRDJ04",18,0)
 ; XUAF4                         2171
"RTN","VPRDJ04",19,0)
 ;
"RTN","VPRDJ04",20,0)
 ; All tags expect DFN, ID, [VPRSTART, VPRSTOP, VPRMAX, VPRTEXT]
"RTN","VPRDJ04",21,0)
 ;
"RTN","VPRDJ04",22,0)
SDAM1 ; -- appointment ^TMP($J,"SDAMA301",DFN,VPRDT)
"RTN","VPRDJ04",23,0)
 N NODE,HLOC,APPT,X,STS,CLS,FAC,SV,PRV
"RTN","VPRDJ04",24,0)
 S NODE=$G(^TMP($J,"SDAMA301",DFN,VPRDT))
"RTN","VPRDJ04",25,0)
 ;
"RTN","VPRDJ04",26,0)
 S HLOC=$P(NODE,U,2),X="A;"_VPRDT_";"_+HLOC
"RTN","VPRDJ04",27,0)
 I $L($G(ID)),$P(ID,";",1,3)'=X Q
"RTN","VPRDJ04",28,0)
 S APPT("localId")=X,APPT("uid")=$$SETUID^VPRUTILS("appointment",DFN,X)
"RTN","VPRDJ04",29,0)
 S X=$P(NODE,U,10),APPT("typeCode")=$P(X,";"),APPT("typeName")=$P(X,";",2)
"RTN","VPRDJ04",30,0)
 S STS=$P(NODE,U,3),CLS=$S($E(STS)="I":"I",1:"O")
"RTN","VPRDJ04",31,0)
 S APPT("dateTime")=$$JSONDT^VPRUTILS(VPRDT)
"RTN","VPRDJ04",32,0)
 S:$L($P(NODE,U,6)) APPT("comment")=$P(NODE,U,6)
"RTN","VPRDJ04",33,0)
 S:$P(NODE,U,9) APPT("checkIn")=$$JSONDT^VPRUTILS($P(NODE,U,9))
"RTN","VPRDJ04",34,0)
 S:$P(NODE,U,11) APPT("checkOut")=$$JSONDT^VPRUTILS($P(NODE,U,11))
"RTN","VPRDJ04",35,0)
 I $L(ID,";")>3 S APPT("reasonName")=$P(ID,";",4),PRV=+$P(ID,";",5) ;from SDAM event
"RTN","VPRDJ04",36,0)
 S FAC=$$FAC^VPRD(+HLOC) D FACILITY^VPRUTILS(FAC,"APPT") I HLOC D
"RTN","VPRDJ04",37,0)
 . S APPT("locationName")=$P(HLOC,";",2)
"RTN","VPRDJ04",38,0)
 . S APPT("locationUid")=$$SETUID^VPRUTILS("location",,+HLOC)
"RTN","VPRDJ04",39,0)
 . S X=$$AMIS^VPRDVSIT(+$P(NODE,U,13))
"RTN","VPRDJ04",40,0)
 . S:$L(X) APPT("stopCodeUid")="urn:va:stop-code:"_$P(X,U),APPT("stopCodeName")=$P(X,U,2)
"RTN","VPRDJ04",41,0)
 . S SV=$$GET1^DIQ(44,+HLOC_",",9.5,"I")
"RTN","VPRDJ04",42,0)
 . I SV S APPT("service")=$$SERV^VPRDSDAM(SV)
"RTN","VPRDJ04",43,0)
 . ;find default provider
"RTN","VPRDJ04",44,0)
 . S:'$G(PRV) PRV=+$$GET1^DIQ(44,+HLOC_",",16,"I") I 'PRV D
"RTN","VPRDJ04",45,0)
 .. N VPRP,I,FIRST
"RTN","VPRDJ04",46,0)
 .. D GETS^DIQ(44,+HLOC_",","2600*","I","VPRP")
"RTN","VPRDJ04",47,0)
 .. S FIRST=$O(VPRP(44.1,"")),I=""
"RTN","VPRDJ04",48,0)
 .. F  S I=$O(VPRP(44.1,I)) Q:I=""  I $G(VPRP(44.1,I,.02,"I")) S PRV=$G(VPRP(44.1,I,.01,"I")) Q
"RTN","VPRDJ04",49,0)
 .. I 'PRV,FIRST S PRV=$G(VPRP(44.1,FIRST,.01,"I"))
"RTN","VPRDJ04",50,0)
 I $G(PRV) S APPT("providers",1,"providerUid")=$$SETUID^VPRUTILS("user",,PRV),APPT("providers",1,"providerName")=$P($G(^VA(200,PRV,0)),U)
"RTN","VPRDJ04",51,0)
 I $G(SV) S APPT("summary")="${"_APPT("service")_"}:"_$P(HLOC,";",2)
"RTN","VPRDJ04",52,0)
 S APPT("patientClassCode")="urn:va:patient-class:"_$S(CLS="I":"IMP",1:"AMB")
"RTN","VPRDJ04",53,0)
 S APPT("patientClassName")=$S(CLS="I":"Inpatient",1:"Ambulatory")
"RTN","VPRDJ04",54,0)
 S APPT("categoryCode")="urn:va:encounter-category:OV",APPT("categoryName")="Outpatient Visit"
"RTN","VPRDJ04",55,0)
 S APPT("appointmentStatus")=$P(STS,";",2)
"RTN","VPRDJ04",56,0)
 D ADD^VPRDJ("APPT","appointment")
"RTN","VPRDJ04",57,0)
 Q
"RTN","VPRDJ04",58,0)
 ;
"RTN","VPRDJ04",59,0)
DGS ; scheduled admissions [from APPOINTM^VPRDJ0]
"RTN","VPRDJ04",60,0)
 S VPRA=0 F  S VPRA=$O(^DGS(41.1,"B",DFN,VPRA)) Q:VPRA<1  D  Q:VPRI'<VPRMAX
"RTN","VPRDJ04",61,0)
 . S VPRX=$G(^DGS(41.1,VPRA,0))
"RTN","VPRDJ04",62,0)
 . I $L($G(ID)),+$P(ID,";",2)=+$P(VPRX,U,2) D DGS1(VPRA) Q
"RTN","VPRDJ04",63,0)
 . Q:$P(VPRX,U,13)  Q:$P(VPRX,U,17)  ;cancelled or admitted
"RTN","VPRDJ04",64,0)
 . S X=$P(VPRX,U,2) Q:X<VPRSTART!(X>VPRSTOP)  ;out of date range
"RTN","VPRDJ04",65,0)
 . D DGS1(VPRA)
"RTN","VPRDJ04",66,0)
 Q
"RTN","VPRDJ04",67,0)
 ;
"RTN","VPRDJ04",68,0)
DGS1(IFN) ; -- scheduled admission
"RTN","VPRDJ04",69,0)
 N ADM,X0,DATE,HLOC,FAC,SV,X
"RTN","VPRDJ04",70,0)
 S X0=$G(^DGS(41.1,+$G(IFN),0)) Q:X0=""  ;deleted
"RTN","VPRDJ04",71,0)
 ;
"RTN","VPRDJ04",72,0)
 S DATE=+$P(X0,U,2),HLOC=+$G(^DIC(42,+$P(X0,U,8),44))
"RTN","VPRDJ04",73,0)
 S X="H;"_DATE,ADM("localId")=X,ADM("uid")=$$SETUID^VPRUTILS("appointment",DFN,X)
"RTN","VPRDJ04",74,0)
 S ADM("dateTime")=$$JSONDT^VPRUTILS(DATE)
"RTN","VPRDJ04",75,0)
 S FAC=$$FAC^VPRD(+HLOC) D FACILITY^VPRUTILS(FAC,"ADM") I HLOC D
"RTN","VPRDJ04",76,0)
 . S HLOC=+HLOC_";"_$P($G(^SC(+HLOC,0)),U)
"RTN","VPRDJ04",77,0)
 . S ADM("uid")=ADM("uid")_";"_+HLOC
"RTN","VPRDJ04",78,0)
 . S ADM("locationName")=$P(HLOC,";",2)
"RTN","VPRDJ04",79,0)
 . S ADM("locationUid")=$$SETUID^VPRUTILS("location",,+HLOC)
"RTN","VPRDJ04",80,0)
 . S X=$$GET1^DIQ(44,+HLOC_",",8,"I"),X=$$AMIS^VPRDVSIT(X)
"RTN","VPRDJ04",81,0)
 . S:$L(X) ADM("stopCodeUid")="urn:va:stop-code:"_$P(X,U),ADM("stopCodeName")=$P(X,U,2)
"RTN","VPRDJ04",82,0)
 . S SV=$$GET1^DIQ(44,+HLOC_",",9.5,"I")
"RTN","VPRDJ04",83,0)
 . I SV S ADM("service")=$$SERV^VPRDSDAM(SV)
"RTN","VPRDJ04",84,0)
 I $G(SV) S ADM("summary")="${"_ADM("service")_"}:"_$P(HLOC,";",2)
"RTN","VPRDJ04",85,0)
 S X=+$P(X0,U,5) I X D
"RTN","VPRDJ04",86,0)
 . S ADM("providers",1,"providerUid")=$$SETUID^VPRUTILS("user",,X)
"RTN","VPRDJ04",87,0)
 . S ADM("providers",1,"providerName")=$P($G(^VA(200,X,0)),U)
"RTN","VPRDJ04",88,0)
 S ADM("patientClassCode")="urn:va:patient-class:IMP",ADM("patientClassName")="Inpatient"
"RTN","VPRDJ04",89,0)
 S ADM("categoryCode")="urn:va:encounter-category:AD",ADM("categoryName")="Admission"
"RTN","VPRDJ04",90,0)
 S ADM("appointmentStatus")=$S($P(X0,U,17):"ADMITTED",$P(X0,U,13):"CANCELLED",1:"SCHEDULED")
"RTN","VPRDJ04",91,0)
 D ADD^VPRDJ("ADM","appointment")
"RTN","VPRDJ04",92,0)
 Q
"RTN","VPRDJ04",93,0)
 ;
"RTN","VPRDJ04",94,0)
VSIT1(ID) ; -- visit
"RTN","VPRDJ04",95,0)
 N VST,X0,X15,X,FAC,LOC,CATG,AMIS,INPT,DA
"RTN","VPRDJ04",96,0)
 I $G(ID)?1"H"1.N D ADM^VPRDJ04A(ID) Q
"RTN","VPRDJ04",97,0)
 D ENCEVENT^PXAPI(ID)
"RTN","VPRDJ04",98,0)
 ;
"RTN","VPRDJ04",99,0)
 S X0=$G(^TMP("PXKENC",$J,ID,"VST",ID,0)),X15=$G(^(150))
"RTN","VPRDJ04",100,0)
 Q:$P(X15,U,3)'="P"  Q:$P(X0,U,12)  ;Q:$P(X0,U,7)="E"  ;primary, not historical or child
"RTN","VPRDJ04",101,0)
 I $P(X0,U,7)="H" D ADM^VPRDJ04A(ID,+X0) Q
"RTN","VPRDJ04",102,0)
 S VST("localId")=ID,VST("uid")=$$SETUID^VPRUTILS("visit",DFN,ID)
"RTN","VPRDJ04",103,0)
 S VST("dateTime")=$$JSONDT^VPRUTILS(+X0)
"RTN","VPRDJ04",104,0)
 S:$P(X0,U,18) VST("checkOut")=$$JSONDT^VPRUTILS($P(X0,U,18))
"RTN","VPRDJ04",105,0)
 S FAC=+$P(X0,U,6),CATG=$P(X0,U,7),LOC=+$P(X0,U,22)
"RTN","VPRDJ04",106,0)
 S:FAC X=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDJ04",107,0)
 S:'FAC X=$$FAC^VPRD(LOC) D FACILITY^VPRUTILS(X,"VST")
"RTN","VPRDJ04",108,0)
 S X=$S(CATG="H":"AD",CATG="C":"CR",CATG="T":"TC",CATG="N":"U",CATG="R":"NH","D^X"[CATG:"O",1:"OV")
"RTN","VPRDJ04",109,0)
 S VST("categoryCode")="urn:va:encounter-category:"_X
"RTN","VPRDJ04",110,0)
 S VST("categoryName")=$S(X="AD":"Admission",X="CR":"Chart Review",X="TC":"Phone Contact",X="U":"Unknown",X="NH":"Nursing Home",X="O":"Other",1:"Outpatient Visit")
"RTN","VPRDJ04",111,0)
 S INPT=$P(X15,U,2) S:INPT="" INPT=$S("H^I^R^D"[CATG:1,1:0)
"RTN","VPRDJ04",112,0)
 S X=$$CPT^VPRDVSIT(ID) S:X VST("typeName")=$P($$CPT^ICPTCOD(X),U,3)
"RTN","VPRDJ04",113,0)
 I 'X S VST("typeName")=$S('INPT&LOC:$P($G(^SC(LOC,0)),U)_" VISIT",1:$$CATG^VPRDVSIT(CATG))
"RTN","VPRDJ04",114,0)
 S VST("patientClassCode")="urn:va:patient-class:"_$S(INPT:"IMP",1:"AMB")
"RTN","VPRDJ04",115,0)
 S VST("patientClassName")=$S(INPT:"Inpatient",1:"Ambulatory")
"RTN","VPRDJ04",116,0)
 S X=$P(X0,U,8) S:X AMIS=$$AMIS^VPRDVSIT(X) I LOC D
"RTN","VPRDJ04",117,0)
 . N L0 S L0=$G(^SC(LOC,0))
"RTN","VPRDJ04",118,0)
 . I 'X S AMIS=$$AMIS^VPRDVSIT($P(L0,U,7))
"RTN","VPRDJ04",119,0)
 . S VST("locationUid")=$$SETUID^VPRUTILS("location",,+LOC)
"RTN","VPRDJ04",120,0)
 . S VST("locationName")=$P(L0,U)
"RTN","VPRDJ04",121,0)
 . S X=$$SERV^VPRDVSIT($P(L0,U,20)) Q:X=""
"RTN","VPRDJ04",122,0)
 . S:$L(X) VST("service")=X,VST("summary")="${"_VST("service")_"}:"_$P(L0,U)
"RTN","VPRDJ04",123,0)
 S:$D(AMIS) VST("stopCodeUid")="urn:va:stop-code:"_$P(AMIS,U),VST("stopCodeName")=$P(AMIS,U,2)
"RTN","VPRDJ04",124,0)
 S X=$$POV^VPRDVSIT(ID) I $L(X) D
"RTN","VPRDJ04",125,0)
 . N SYS S SYS=$P(X,U,3),SYS=$$LOW^XLFSTR(SYS)
"RTN","VPRDJ04",126,0)
 . S VST("reasonUid")=$$SETNCS^VPRUTILS(SYS,$P(X,U)),VST("reasonName")=$P(X,U,2)
"RTN","VPRDJ04",127,0)
 ; provider(s)
"RTN","VPRDJ04",128,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,ID,"PRV",DA)) Q:DA<1  S X0=$G(^(DA,0)) D
"RTN","VPRDJ04",129,0)
 . I $P(X0,U,4)="P" D PROV("VST",DA,+X0,"P",1) Q  ;primary
"RTN","VPRDJ04",130,0)
 . D PROV("VST",DA,+X0,"S")                       ;secondary
"RTN","VPRDJ04",131,0)
 K ^TMP("PXKENC",$J,ID)
"RTN","VPRDJ04",132,0)
 ; note(s)
"RTN","VPRDJ04",133,0)
 D TIU^VPRDJ04A(ID,.VST)
"RTN","VPRDJ04",134,0)
 D ADD^VPRDJ("VST","visit")
"RTN","VPRDJ04",135,0)
 Q
"RTN","VPRDJ04",136,0)
 ;
"RTN","VPRDJ04",137,0)
PROV(ARR,I,IEN,ROLE,PRIM) ; -- add providers
"RTN","VPRDJ04",138,0)
 S @ARR@("providers",I,"providerUid")=$$SETUID^VPRUTILS("user",,+IEN)
"RTN","VPRDJ04",139,0)
 S @ARR@("providers",I,"providerName")=$P($G(^VA(200,+IEN,0)),U)
"RTN","VPRDJ04",140,0)
 S @ARR@("providers",I,"role")=ROLE
"RTN","VPRDJ04",141,0)
 S:$G(PRIM) @ARR@("providers",I,"primary")="true"
"RTN","VPRDJ04",142,0)
 Q
"RTN","VPRDJ04",143,0)
 ;
"RTN","VPRDJ04",144,0)
NAME(IEN) ; -- Return a string 'name' for the visit
"RTN","VPRDJ04",145,0)
 N Y,X0,LOC,DATE
"RTN","VPRDJ04",146,0)
 S X0=$G(^AUPNVSIT(+$G(IEN),0)),Y=""
"RTN","VPRDJ04",147,0)
 S DATE=+X0,LOC=+$P(X0,U,22) S:LOC LOC=$P($G(^SC(LOC,0)),U)_" "
"RTN","VPRDJ04",148,0)
 S Y=LOC_$$FMTE^XLFDT(DATE,"1D") ;Mon DD, YYYY
"RTN","VPRDJ04",149,0)
 Q Y
"RTN","VPRDLRO")
0^1^B28036256^B34279293
"RTN","VPRDLRO",1,0)
VPRDLRO ;SLC/MKB -- Lab extract by order/panel ;8/2/11  15:29
"RTN","VPRDLRO",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**2,5,7**;Sep 01, 2011;Build 3
"RTN","VPRDLRO",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDLRO",4,0)
 ;
"RTN","VPRDLRO",5,0)
 ; External References          DBIA#
"RTN","VPRDLRO",6,0)
 ; -------------------          -----
"RTN","VPRDLRO",7,0)
 ; ^DPT                         10035
"RTN","VPRDLRO",8,0)
 ; ^LAB(60                      10054
"RTN","VPRDLRO",9,0)
 ; ^LR                            525
"RTN","VPRDLRO",10,0)
 ; ^ORD(100.98)                   873
"RTN","VPRDLRO",11,0)
 ; ^VA(200)                     10060
"RTN","VPRDLRO",12,0)
 ; DIQ                           2056
"RTN","VPRDLRO",13,0)
 ; LR7OR1,^TMP("LRRR",$J)        2503
"RTN","VPRDLRO",14,0)
 ; LR7OU1                        2955
"RTN","VPRDLRO",15,0)
 ; LRPXAPIU                      4246
"RTN","VPRDLRO",16,0)
 ; ORQ1,^TMP("ORR",$J)           3154
"RTN","VPRDLRO",17,0)
 ; ORQ12,^TMP("ORGOTIT",$J)      5704
"RTN","VPRDLRO",18,0)
 ; ORX8                     2467,3071
"RTN","VPRDLRO",19,0)
 ; XUAF4                         2171
"RTN","VPRDLRO",20,0)
 ;
"RTN","VPRDLRO",21,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDLRO",22,0)
 ;
"RTN","VPRDLRO",23,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find a patient's lab orders
"RTN","VPRDLRO",24,0)
 N ORLIST,ORDG,ORFLG,ORIGVIEW,ORDER,VPRN,VPRITM,VPRCNT,LRDFN
"RTN","VPRDLRO",25,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDLRO",26,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDLRO",27,0)
 S LRDFN=$G(^DPT(DFN,"LR"))
"RTN","VPRDLRO",28,0)
 ;
"RTN","VPRDLRO",29,0)
 ; get one lab order's results
"RTN","VPRDLRO",30,0)
 I $G(IFN) D  G ENQ
"RTN","VPRDLRO",31,0)
 . N ORLST S ORLST=0,ORLIST=$H
"RTN","VPRDLRO",32,0)
 . S ORIGVIEW=2 ;get original view of order
"RTN","VPRDLRO",33,0)
 . D GET^ORQ12(+IFN,ORLIST,1) S VPRN=ORLST
"RTN","VPRDLRO",34,0)
 . D EN1(VPRN,.VPRITM),XML(.VPRITM)
"RTN","VPRDLRO",35,0)
 . K ^TMP("ORGOTIT",$J)
"RTN","VPRDLRO",36,0)
 ;
"RTN","VPRDLRO",37,0)
 ; get [all] lab orders with results
"RTN","VPRDLRO",38,0)
 S ORDG=$G(FILTER("type"),"LAB"),ORDG=+$O(^ORD(100.98,"B",ORDG,0))
"RTN","VPRDLRO",39,0)
 S ORFLG=6    ;search by Released Orders
"RTN","VPRDLRO",40,0)
 S ORIGVIEW=2 ;get original view of order
"RTN","VPRDLRO",41,0)
 D EN^ORQ1(DFN_";DPT(",ORDG,ORFLG,,BEG,END,1) S VPRCNT=0
"RTN","VPRDLRO",42,0)
 S VPRN=0 F  S VPRN=$O(^TMP("ORR",$J,ORLIST,VPRN)) Q:VPRN<1  S ORDER=$G(^(VPRN)) D  Q:VPRCNT'<MAX
"RTN","VPRDLRO",43,0)
 . I $P($P(ORDER,U),";",2)>1 Q  ;skip order actions
"RTN","VPRDLRO",44,0)
 . I $P(ORDER,U,7)'="comp" Q    ;completed only -- want results
"RTN","VPRDLRO",45,0)
 . K VPRITM D EN1(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDLRO",46,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDLRO",47,0)
ENQ ; end
"RTN","VPRDLRO",48,0)
 K ^TMP("ORR",$J),^TMP("VPRTEXT",$J),^TMP("LRRR",$J,DFN)
"RTN","VPRDLRO",49,0)
 Q
"RTN","VPRDLRO",50,0)
 ;
"RTN","VPRDLRO",51,0)
EN1(NUM,ORD) ; -- return an order in ORD("attribute")=value
"RTN","VPRDLRO",52,0)
 ;  from EN: expects ^TMP("ORR",$J,ORLIST,VPRN),LRDFN
"RTN","VPRDLRO",53,0)
 N ORPK,X0,IFN,OI,VPRSUB,VPRIDT,LR0,X,I,VPRL,VPRT
"RTN","VPRDLRO",54,0)
 K ORD,^TMP("VPRTEXT",$J)
"RTN","VPRDLRO",55,0)
 S X0=$G(^TMP("ORR",$J,ORLIST,NUM)),IFN=+X0
"RTN","VPRDLRO",56,0)
 S ORPK=$$PKGID^ORX8(+IFN) Q:'ORPK
"RTN","VPRDLRO",57,0)
 S ORD("id")=IFN,ORD("labOrderID")=ORPK
"RTN","VPRDLRO",58,0)
 S OI=$$OI^ORX8(+IFN),ORD("name")=$P(OI,U,2)
"RTN","VPRDLRO",59,0)
 S ORD("order")=+IFN_U_$P(OI,U,2)
"RTN","VPRDLRO",60,0)
 ;
"RTN","VPRDLRO",61,0)
 K ^TMP("LRRR",$J,DFN) D RR^LR7OR1(DFN,ORPK)
"RTN","VPRDLRO",62,0)
 S VPRSUB=$O(^TMP("LRRR",$J,DFN,"")) Q:VPRSUB=""  Q:"CH^MI"'[VPRSUB
"RTN","VPRDLRO",63,0)
 S VPRIDT=$O(^TMP("LRRR",$J,DFN,VPRSUB,0)) Q:VPRIDT<1  Q:'$O(^(VPRIDT,0))
"RTN","VPRDLRO",64,0)
 ; I $G(ID),$P(ID,";",1,3)'=$P($P(X,U,3),";",1,3) Q  ;single order/specimen
"RTN","VPRDLRO",65,0)
 S ORD("type")=VPRSUB,ORD("status")="completed"
"RTN","VPRDLRO",66,0)
 S ORD("collected")=9999999-VPRIDT
"RTN","VPRDLRO",67,0)
 S LR0=$G(^LR(LRDFN,VPRSUB,VPRIDT,0))
"RTN","VPRDLRO",68,0)
 S X=$P(LR0,U,3) I VPRSUB="MI",'X S ORD("status")="incomplete"
"RTN","VPRDLRO",69,0)
 S ORD("resulted")=X,X=+$P(LR0,U,5) I X D  ;specimen
"RTN","VPRDLRO",70,0)
 . N IENS,VPRY S IENS=X_","
"RTN","VPRDLRO",71,0)
 . D GETS^DIQ(61,IENS,".01:2",,"VPRY")
"RTN","VPRDLRO",72,0)
 . S ORD("specimen")=$G(VPRY(61,IENS,2))_U_$G(VPRY(61,IENS,.01)) ;SNOMED^name
"RTN","VPRDLRO",73,0)
 . S ORD("sample")=$$GET1^DIQ(61,X_",",4.1) ;name
"RTN","VPRDLRO",74,0)
 S ORD("groupName")=$P(LR0,U,6),X=+$P(LR0,U,14)
"RTN","VPRDLRO",75,0)
 S:X ORD("facility")=$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U)
"RTN","VPRDLRO",76,0)
 I 'X S ORD("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDLRO",77,0)
 S I=$S(VPRSUB="CH":10,1:7),X=+$P(LR0,U,I)
"RTN","VPRDLRO",78,0)
 S:X ORD("provider")=X_U_$P($G(^VA(200,X,0)),U)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDLRO",79,0)
 ;
"RTN","VPRDLRO",80,0)
 K VPRT D EXPAND^LR7OU1(+$P(OI,U,3),.VPRT) ;get individual tests
"RTN","VPRDLRO",81,0)
 S VPRL=0 F  S VPRL=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT,VPRL)) Q:VPRL<1  S X=$G(^(VPRL)) D
"RTN","VPRDLRO",82,0)
 . Q:'$D(VPRT(+X))  ;test not in order/panel
"RTN","VPRDLRO",83,0)
 . S:VPRSUB="CH" ORD("value",VPRL)=$$CH(X)
"RTN","VPRDLRO",84,0)
 . S:VPRSUB="MI" ORD("value",VPRL)=$$MI(X)
"RTN","VPRDLRO",85,0)
 I $D(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT,"N")) K CMMT M CMMT=^("N") S ORD("comment")=$$STRING^VPRD(.CMMT)
"RTN","VPRDLRO",86,0)
 Q
"RTN","VPRDLRO",87,0)
 ;
"RTN","VPRDLRO",88,0)
CH(X0) ; -- return a Chemistry result as:
"RTN","VPRDLRO",89,0)
 ;   id^test^result^interpretation^units^low^high^loinc^vuid^performingLab
"RTN","VPRDLRO",90,0)
 ;   Expects X0=^TMP("LRRR",$J,DFN,"CH",VPRIDT,VPRL),LRDFN
"RTN","VPRDLRO",91,0)
 N P,X,Y,NODE,LOINC
"RTN","VPRDLRO",92,0)
 S P=$$LRDN^LRPXAPIU(+X0) ;get LR node# for test
"RTN","VPRDLRO",93,0)
 S NODE=$G(^LR(LRDFN,"CH",VPRIDT,P))
"RTN","VPRDLRO",94,0)
 S X=$P($G(^LAB(60,+X0,0)),U)
"RTN","VPRDLRO",95,0)
 S Y="CH;"_VPRIDT_";"_P_U_X_U_$P(X0,U,2,4)
"RTN","VPRDLRO",96,0)
 S X=$P(X0,U,5) I $L(X),X["-" S X=$TR(X,"- ","^"),$P(Y,U,6,7)=X
"RTN","VPRDLRO",97,0)
 S X=$P($P(NODE,U,3),"!",3) S:X LOINC=$$GET1^DIQ(95.3,X_",",.01)
"RTN","VPRDLRO",98,0)
 S:$G(LOINC) $P(Y,U,8,9)=LOINC_U_$$VUID^VPRD(+LOINC,95.3)
"RTN","VPRDLRO",99,0)
 S X=+$P(NODE,U,9) S:X $P(Y,U,10)=$$NAME^XUAF4(X) ;performing lab
"RTN","VPRDLRO",100,0)
 Q Y
"RTN","VPRDLRO",101,0)
 ;
"RTN","VPRDLRO",102,0)
MI(X0) ; -- return a Microbiology result as:
"RTN","VPRDLRO",103,0)
 ;   id^test^result^interpretation^units
"RTN","VPRDLRO",104,0)
 ;   Expects X0=^TMP("LRRR",$J,DFN,"MI",VPRIDT,VPRL)
"RTN","VPRDLRO",105,0)
 N Y S Y=""
"RTN","VPRDLRO",106,0)
 S:$L($P(X0,U))>1 Y="MI;"_VPRIDT_";"_VPRL_U_$P(X0,U,1,4)
"RTN","VPRDLRO",107,0)
 Q Y
"RTN","VPRDLRO",108,0)
 ;
"RTN","VPRDLRO",109,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDLRO",110,0)
 ;
"RTN","VPRDLRO",111,0)
XML(LAB) ; -- Return result as XML in @VPR@(#)
"RTN","VPRDLRO",112,0)
 N ATT,X,Y,I,J,P,NAMES,TAG
"RTN","VPRDLRO",113,0)
 D ADD("<panel>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDLRO",114,0)
 S ATT="" F  S ATT=$O(LAB(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDLRO",115,0)
 . I $O(LAB(ATT,0)) D  S Y="" Q
"RTN","VPRDLRO",116,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDLRO",117,0)
 .. I ATT="value" S NAMES="id^test^result^interpretation^units^low^high^loinc^vuid^performingLab^Z"
"RTN","VPRDLRO",118,0)
 .. E  S NAMES="code^name^Z"
"RTN","VPRDLRO",119,0)
 .. S I=0 F  S I=$O(LAB(ATT,I)) Q:I<1  D
"RTN","VPRDLRO",120,0)
 ... S X=$G(LAB(ATT,I)),Y="<"_ATT_" "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDLRO",121,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDLRO",122,0)
 . S X=$G(LAB(ATT)),Y="" Q:'$L(X)
"RTN","VPRDLRO",123,0)
 . I ATT="comment" S Y="<"_ATT_" xml:space='preserve'>"_$$ESC^VPRD(X)_"</"_ATT_">" Q
"RTN","VPRDLRO",124,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDLRO",125,0)
 . S NAMES="code^name"_$S(ATT="provider":U_$$PROVTAGS^VPRD,1:"")_"^Z"
"RTN","VPRDLRO",126,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDLRO",127,0)
 D ADD("</panel>")
"RTN","VPRDLRO",128,0)
 Q
"RTN","VPRDLRO",129,0)
 ;
"RTN","VPRDLRO",130,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDLRO",131,0)
 N STR,P,TAG S STR=""
"RTN","VPRDLRO",132,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDLRO",133,0)
 Q STR
"RTN","VPRDLRO",134,0)
 ;
"RTN","VPRDLRO",135,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDLRO",136,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDLRO",137,0)
 S @VPR@(VPRI)=X
"RTN","VPRDLRO",138,0)
 Q
"RTN","VPRDPT")
0^4^B114535256^B99429749
"RTN","VPRDPT",1,0)
VPRDPT ;SLC/MKB -- Patient demographics extract ;8/11/11  15:29
"RTN","VPRDPT",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,4,5,7**;Sep 01, 2011;Build 3
"RTN","VPRDPT",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPT",4,0)
 ;
"RTN","VPRDPT",5,0)
 ; External References          DBIA#
"RTN","VPRDPT",6,0)
 ; -------------------          -----
"RTN","VPRDPT",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDPT",8,0)
 ; ^DGSL(38.1                     767
"RTN","VPRDPT",9,0)
 ; ^DIC(4                       10090
"RTN","VPRDPT",10,0)
 ; ^DIC(31                        733
"RTN","VPRDPT",11,0)
 ; ^DIC(42                  723,10039
"RTN","VPRDPT",12,0)
 ; ^DPT               3581,5597,10035
"RTN","VPRDPT",13,0)
 ; ^VA(200                      10060
"RTN","VPRDPT",14,0)
 ; DGCV                          4156
"RTN","VPRDPT",15,0)
 ; DGMSTAPI                      2716
"RTN","VPRDPT",16,0)
 ; DGNTAPI                       3457
"RTN","VPRDPT",17,0)
 ; DGPFAPI                       3860
"RTN","VPRDPT",18,0)
 ; DGRPDB                        4807
"RTN","VPRDPT",19,0)
 ; DIC                           2051
"RTN","VPRDPT",20,0)
 ; DILFD                         2055
"RTN","VPRDPT",21,0)
 ; DIQ                           2056
"RTN","VPRDPT",22,0)
 ; MPIF001                       2701
"RTN","VPRDPT",23,0)
 ; SCAPMC                        1916
"RTN","VPRDPT",24,0)
 ; SCAPMCA                       2848
"RTN","VPRDPT",25,0)
 ; SDUTL3                        1252
"RTN","VPRDPT",26,0)
 ; VADPT                        10061
"RTN","VPRDPT",27,0)
 ; VAFCTFU1                      2990
"RTN","VPRDPT",28,0)
 ; VASITE                       10112
"RTN","VPRDPT",29,0)
 ; XUAF4                         2171
"RTN","VPRDPT",30,0)
 ;
"RTN","VPRDPT",31,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDPT",32,0)
 ;
"RTN","VPRDPT",33,0)
EN(DFN,BEG,END,MAX,ID) ; -- find current patient demographics
"RTN","VPRDPT",34,0)
 ; [BEG,END,MAX,ID not currently used]
"RTN","VPRDPT",35,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDPT",36,0)
 N PAT,SYS S SYS=$$SITE^VASITE
"RTN","VPRDPT",37,0)
 D DEM,SVC,PRF,ATC,SUPP,ALIAS,FAC,INPT,PC
"RTN","VPRDPT",38,0)
 I $D(PAT)>9 D XML(.PAT)
"RTN","VPRDPT",39,0)
 Q
"RTN","VPRDPT",40,0)
 ;
"RTN","VPRDPT",41,0)
DEM ;-demographic data
"RTN","VPRDPT",42,0)
 N VADM,VA,VAERR,X
"RTN","VPRDPT",43,0)
 S X=+$$GETICN^MPIF001(DFN) S:X>1 PAT("icn")=X
"RTN","VPRDPT",44,0)
 D DEM^VADPT S X=VADM(1),PAT("fullName")=X
"RTN","VPRDPT",45,0)
 S PAT("familyName")=$P(X,","),PAT("givenNames")=$P(X,",",2,99)
"RTN","VPRDPT",46,0)
 S PAT("ssn")=$P(VADM(2),U),PAT("id")=DFN
"RTN","VPRDPT",47,0)
 S:$D(VA("BID")) PAT("bid")=$E(X)_VA("BID")
"RTN","VPRDPT",48,0)
 S PAT("dob")=+$P($P(VADM(3),U),".")
"RTN","VPRDPT",49,0)
 S PAT("gender")=$P(VADM(5),U)
"RTN","VPRDPT",50,0)
 S PAT("lrdfn")=+$G(^DPT(DFN,"LR"))
"RTN","VPRDPT",51,0)
 S X=+$P($P(VADM(6),U),".") S:X PAT("died")=X
"RTN","VPRDPT",52,0)
 S X=$$GET1^DIQ(38.1,DFN_",",2,"I") S:$L(X) PAT("sensitive")=X
"RTN","VPRDPT",53,0)
 S X=+VADM(9) S:X PAT("religion")=X
"RTN","VPRDPT",54,0)
 S X=$P(VADM(10),U,2) S:$L(X) PAT("maritalStatus")=$E(X)
"RTN","VPRDPT",55,0)
 I VADM(11) D
"RTN","VPRDPT",56,0)
 . N I S I=0
"RTN","VPRDPT",57,0)
 . F  S I=$O(VADM(11,I)) Q:I<1  S X=+VADM(11,I),PAT("ethnicity",X)=$$GET1^DIQ(2.06,X_","_DFN_",",".01:3")
"RTN","VPRDPT",58,0)
 I VADM(12) D
"RTN","VPRDPT",59,0)
 . N I S I=0
"RTN","VPRDPT",60,0)
 . F  S I=$O(VADM(12,I)) Q:I<1  S X=+VADM(12,I),PAT("race",X)=$$GET1^DIQ(2.02,X_","_DFN_",",".01:3")
"RTN","VPRDPT",61,0)
 I $G(VADM(13)) D
"RTN","VPRDPT",62,0)
 . N I S I=+$O(VADM(13,0)),X=$P($G(VADM(13,I)),U,2)
"RTN","VPRDPT",63,0)
 . S I=$$FIND1^DIC(.85,,"X",X)
"RTN","VPRDPT",64,0)
 . S PAT("language")=$$GET1^DIQ(.85,I_",",.02)_U_X
"RTN","VPRDPT",65,0)
 Q
"RTN","VPRDPT",66,0)
SVC ;-service data
"RTN","VPRDPT",67,0)
 N VAEL,VASV,VAERR,X,Y,I,AO,IR,PGF,HNC,MST,CV
"RTN","VPRDPT",68,0)
 D 7^VADPT
"RTN","VPRDPT",69,0)
 S PAT("veteran")=VAEL(4)
"RTN","VPRDPT",70,0)
 S PAT("sc")=+VAEL(3) S:VAEL(3) PAT("scPercent")=+$P(VAEL(3),U,2)
"RTN","VPRDPT",71,0)
 S:VAEL(2) PAT("servicePeriod")=$P(VAEL(2),U,2)
"RTN","VPRDPT",72,0)
 I VAEL(1) D
"RTN","VPRDPT",73,0)
 . S PAT("eligibility",+VAEL(1))=$P(VAEL(1),U,2)_"^1",I=0
"RTN","VPRDPT",74,0)
 . F  S I=$O(VAEL(1,I)) Q:I<1  S PAT("eligibility",I)=$P(VAEL(1,I),U,2)
"RTN","VPRDPT",75,0)
 S:$L(VAEL(8)) PAT("eligibilityStatus")=$P(VAEL(8),U,2)
"RTN","VPRDPT",76,0)
 S:$L(VAEL(9)) PAT("meansTest")=$P(VAEL(9),U,2)
"RTN","VPRDPT",77,0)
 ;
"RTN","VPRDPT",78,0)
 ; exposures
"RTN","VPRDPT",79,0)
 S AO=VASV(2),IR=VASV(3)
"RTN","VPRDPT",80,0)
 S PGF=VASV(11)!VASV(12)!VASV(13) ;OIF/OEF
"RTN","VPRDPT",81,0)
 S X=$$GETCUR^DGNTAPI(DFN,"HNC"),X=+($G(HNC("STAT")))
"RTN","VPRDPT",82,0)
 S HNC=$S(X=4:1,X=5:1,X=1:0,X=6:0,1:"")
"RTN","VPRDPT",83,0)
 S X=$P($$GETSTAT^DGMSTAPI(DFN),U,2),MST=$S(X="Y":1,X="N":0,1:"")
"RTN","VPRDPT",84,0)
 S X=$$CVEDT^DGCV(DFN),CV=$S(+X<0:"",+X=0:0,$P(X,U,3):1,1:0)
"RTN","VPRDPT",85,0)
 S PAT("exposures")=AO_U_IR_U_PGF_U_HNC_U_MST_U_CV
"RTN","VPRDPT",86,0)
 ;
"RTN","VPRDPT",87,0)
 ; rated disabilities [DGRPDB]
"RTN","VPRDPT",88,0)
 N VPRDIS,DIS,NM,DX
"RTN","VPRDPT",89,0)
 D RDIS^DGRPDB(DFN,.VPRDIS)
"RTN","VPRDPT",90,0)
 S I=0 F  S I=$O(VPRDIS(I)) Q:I<1  D
"RTN","VPRDPT",91,0)
 . S DIS=VPRDIS(I)
"RTN","VPRDPT",92,0)
 . S NM=$$GET1^DIQ(31,+DIS_",",.01),DX=$$GET1^DIQ(31,+DIS_",",2)
"RTN","VPRDPT",93,0)
 . S PAT("disability",+DX)=NM_U_$P(DIS,U,3)_U_$P(DIS,U,2) ;name^sc^%
"RTN","VPRDPT",94,0)
 Q
"RTN","VPRDPT",95,0)
PRF ;-patient record flags
"RTN","VPRDPT",96,0)
 N VPRPF,I,NAME,TEXT
"RTN","VPRDPT",97,0)
 Q:'$$GETACT^DGPFAPI(DFN,"VPRPF")
"RTN","VPRDPT",98,0)
 S I=0 F  S I=$O(VPRPF(I)) Q:I<1  D
"RTN","VPRDPT",99,0)
 . S NAME=$P(VPRPF(I,"FLAG"),U,2)
"RTN","VPRDPT",100,0)
 . M TEXT=VPRPF(I,"NARR")
"RTN","VPRDPT",101,0)
 . S PAT("flag",I)=NAME_U_$$STRING^VPRD(.TEXT)
"RTN","VPRDPT",102,0)
 Q
"RTN","VPRDPT",103,0)
ATC ;-address & telecom
"RTN","VPRDPT",104,0)
 N VAPA,I,X
"RTN","VPRDPT",105,0)
 S VAPA("P")="" D ADD^VADPT ;permanent address
"RTN","VPRDPT",106,0)
 S X="" F I=1:1:4 S X=X_VAPA(I)_U
"RTN","VPRDPT",107,0)
 S X=X_$P(VAPA(5),U,2)_U_$P(VAPA(11),U,2)
"RTN","VPRDPT",108,0)
 S PAT("address")=X ;street1^st2^st3^city^state^zip
"RTN","VPRDPT",109,0)
 S X=$$FORMAT(VAPA(8))_U_$$FORMAT($$GET1^DIQ(2,DFN_",",.134))_U_$$FORMAT($$GET1^DIQ(2,DFN_",",.132))
"RTN","VPRDPT",110,0)
 S PAT("telecom")=X ;home^cell^work phones
"RTN","VPRDPT",111,0)
 Q
"RTN","VPRDPT",112,0)
SUPP ;-support contacts
"RTN","VPRDPT",113,0)
 N VAOA,A,I,X,TYPE
"RTN","VPRDPT",114,0)
 F A="",1 K VAOA D
"RTN","VPRDPT",115,0)
 . S:A VAOA("A")=A D OAD^VADPT Q:'$L($G(VAOA(9)))
"RTN","VPRDPT",116,0)
 . S TYPE=$S(A=1:"ECON",1:"NOK")
"RTN","VPRDPT",117,0)
 . S PAT("support",TYPE)=VAOA(9)_U_VAOA(10) ;name^relationship
"RTN","VPRDPT",118,0)
 . S X="" F I=1:1:4 S X=X_VAOA(I)_U
"RTN","VPRDPT",119,0)
 . S X=X_$P(VAOA(5),U,2)_U_$P(VAOA(11),U,2)
"RTN","VPRDPT",120,0)
 . S PAT("support",TYPE,"address")=X ;street1^st2^st3^city^state^zip
"RTN","VPRDPT",121,0)
 . S I=$S(A=1:.33011,1:.21011),X=$$FORMAT(VAOA(8))_U_U_$$FORMAT($$GET1^DIQ(2,DFN_",",I))
"RTN","VPRDPT",122,0)
 . S PAT("support",TYPE,"telecom")=X ;home^cell^work phones
"RTN","VPRDPT",123,0)
 Q
"RTN","VPRDPT",124,0)
ALIAS ;-other names used
"RTN","VPRDPT",125,0)
 N I,X
"RTN","VPRDPT",126,0)
 S I=0 F  S I=$O(^DPT(DFN,.01,I)) Q:I<1  S X=$P($G(^(I,0)),U) D
"RTN","VPRDPT",127,0)
 . S PAT("alias",I)=X_U_$P(X,",")_U_$P(X,",",2,99)
"RTN","VPRDPT",128,0)
 Q
"RTN","VPRDPT",129,0)
FORMAT(X) ; -- enforce (xxx)xxx-xxxx phone format
"RTN","VPRDPT",130,0)
 S X=$G(X) I X?1"("3N1")"3N1"-"4N.E Q X
"RTN","VPRDPT",131,0)
 N P,N,I,Y S P=""
"RTN","VPRDPT",132,0)
 F I=1:1:$L(X) S N=$E(X,I) I N=+N S P=P_N
"RTN","VPRDPT",133,0)
 S:$L(P)<10 P=$E("0000000000",1,10-$L(P))_P
"RTN","VPRDPT",134,0)
 S Y=$S(P:"("_$E(P,1,3)_")"_$E(P,4,6)_"-"_$E(P,7,10),1:"")
"RTN","VPRDPT",135,0)
 Q Y
"RTN","VPRDPT",136,0)
FAC ;-treating facilities [see FACLIST^ORWCIRN]
"RTN","VPRDPT",137,0)
 N IFN S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDPT",138,0)
 N VPRY,HOME,LAST,I,X,IEN
"RTN","VPRDPT",139,0)
 I $L($T(TFL^VAFCTFU1)) D TFL^VAFCTFU1(.VPRY,DFN)
"RTN","VPRDPT",140,0)
 S HOME=+$P($G(^DPT(DFN,"MPI")),U,3) ;home facility
"RTN","VPRDPT",141,0)
 I $P($G(VPRY(1)),U)<0 D  Q  ;not setup
"RTN","VPRDPT",142,0)
 . S X=$O(^AUPNVSIT("AA",DFN,0)),LAST=$S(X:9999999-$P(X,"."),1:"")
"RTN","VPRDPT",143,0)
 . S X=$$SITE^VASITE
"RTN","VPRDPT",144,0)
 . S PAT("facility",+X)=$P(X,U,3)_U_$P(X,U,2)_U_LAST_U_$$GET1^DIQ(4,+X_",",60)
"RTN","VPRDPT",145,0)
 S I=0 F  S I=$O(VPRY(I)) Q:I<1  D
"RTN","VPRDPT",146,0)
 . S X=VPRY(I) Q:$P(X,U)=""  ;unknown
"RTN","VPRDPT",147,0)
 . S IEN=+$$IEN^XUAF4($P(X,U))
"RTN","VPRDPT",148,0)
 . I +X=776!(+X=200) S $P(X,U,2)="DEPT. OF DEFENSE"
"RTN","VPRDPT",149,0)
 . S PAT("facility",IEN)=$P(X,U,1,2)_U_$P($P(X,U,3),".")
"RTN","VPRDPT",150,0)
 . ; = stn# ^ name ^ last date ^ VistA domain
"RTN","VPRDPT",151,0)
 . S $P(PAT("facility",IEN),U,4)=$$GET1^DIQ(4,IEN_",",60)
"RTN","VPRDPT",152,0)
 . I IEN=HOME S $P(PAT("facility",IEN),U,5)=1
"RTN","VPRDPT",153,0)
 Q
"RTN","VPRDPT",154,0)
INPT ;-current inpt status
"RTN","VPRDPT",155,0)
 N ADM,X,VAIN,VAERR,HLOC,SVC
"RTN","VPRDPT",156,0)
 S ADM=+$G(^DPT(DFN,.105)) I ADM D
"RTN","VPRDPT",157,0)
 . D INP^VADPT S PAT("admitted")=ADM_U_+VAIN(7)
"RTN","VPRDPT",158,0)
 . S PAT("ward")=VAIN(4),PAT("roomBed")=VAIN(5)
"RTN","VPRDPT",159,0)
 . S HLOC=+$G(^DIC(42,+VAIN(4),44)),SVC=$P($G(^(0)),U,3)
"RTN","VPRDPT",160,0)
 . S PAT("location")=HLOC_U_$P(VAIN(4),U,2)
"RTN","VPRDPT",161,0)
 . S:$L(SVC) PAT("locSvc")=SVC_U_$$EXTERNAL^DILFD(42,.03,,SVC)
"RTN","VPRDPT",162,0)
 . S PAT("specialty")=VAIN(3)
"RTN","VPRDPT",163,0)
 . S PAT("attending")=VAIN(11)
"RTN","VPRDPT",164,0)
 . S X=$$FAC^VPRD(HLOC),PAT("site")=X
"RTN","VPRDPT",165,0)
 S PAT("inpatient")=$S(ADM:"true",1:"false")
"RTN","VPRDPT",166,0)
 Q
"RTN","VPRDPT",167,0)
ZPC ;-primary care [not used: GETALL not returning team members]
"RTN","VPRDPT",168,0)
 N TEAM,VPRPC,VPRI,VPRTM,PCPR,FAC,X,ST
"RTN","VPRDPT",169,0)
 S TEAM=$$INSTPCTM^SCAPMC(DFN) Q:'TEAM  ;teamIEN^name^instIEN^name
"RTN","VPRDPT",170,0)
 S PAT("pcTeam")=$P(TEAM,U,1,2)
"RTN","VPRDPT",171,0)
 D GETALL^SCAPMCA(DFN,,.VPRPC)
"RTN","VPRDPT",172,0)
 S VPRI=+$O(@VPRPC@(DFN,"TM",+TEAM,0)),VPRTM=$G(^(VPRI))
"RTN","VPRDPT",173,0)
 S:$P(VPRTM,U,4) PAT("pcAssigned")=$P(VPRTM,U,4)
"RTN","VPRDPT",174,0)
 S PCPR=$G(@VPRPC@(DFN,"PCPR",1)) I PCPR D
"RTN","VPRDPT",175,0)
 . S PAT("pcProvider")=$P(PCPR,U,1,2)_U_$$PROVSPC^VPRD(+PCPR)
"RTN","VPRDPT",176,0)
 . S FAC=$P(TEAM,U,3,4) S:FAC<1 FAC=$$SITE^VASITE
"RTN","VPRDPT",177,0)
 . S X=$$PADD^XUAF4(+FAC) ;street^city^st^zip
"RTN","VPRDPT",178,0)
 . S ST=$$GET1^DIQ(4,+FAC_",",.02) S:ST="" ST=$P(X,U,3) ;get state name
"RTN","VPRDPT",179,0)
 . S PAT("pcProvider","address")=$P(X,U)_"^^^"_$P(X,U,2)_U_ST_U_$P(X,U,4)
"RTN","VPRDPT",180,0)
 ; get team members
"RTN","VPRDPT",181,0)
 S VPRI=0 F  S VPRI=$O(@VPRPC@(DFN,"TM",+VPRTM,+$P(VPRTM,U,3),"POS",VPRI)) Q:VPRI<1  I +$G(^(VPRI))'=$P(PCPR,U,3) D
"RTN","VPRDPT",182,0)
 . S I=+$O(@VPRPC@(DFN,"TM",+VPRTM,+$P(VPRTM,U,3),"POS",VPRI,"PROV",0)),X=$G(^(I)) Q:X=""
"RTN","VPRDPT",183,0)
 . S POS=$S($L($P(X,U,8)):$P(X,U,8),1:$P(X,U,4))
"RTN","VPRDPT",184,0)
 . S PAT("pcTeamMember",I)=$P(X,U,1,2)_U_POS_U_$$PROVSPC^VPRD(+X)
"RTN","VPRDPT",185,0)
 K @VPRPC
"RTN","VPRDPT",186,0)
 Q
"RTN","VPRDPT",187,0)
 ;
"RTN","VPRDPT",188,0)
PC ;-primary care
"RTN","VPRDPT",189,0)
 N TEAM,X,VPRT,PRV,POS,FAC,ST,I
"RTN","VPRDPT",190,0)
 S TEAM=$$INSTPCTM^SCAPMC(DFN) I TEAM D  ;PC teamIEN^name^instIEN^name
"RTN","VPRDPT",191,0)
 . S PAT("pcTeam")=$P(TEAM,U,1,2)
"RTN","VPRDPT",192,0)
 . S X=$$TMPT^SCAPMC(DFN,,,.VPRT) I X S I=0 F  S I=$O(@VPRT@(I)) Q:I<1  I +$G(@VPRT@(I))=+TEAM S PAT("pcAssigned")=$P(@VPRT@(I),U,4) Q
"RTN","VPRDPT",193,0)
 . K @VPRT,VPRT,X
"RTN","VPRDPT",194,0)
 . S X=$$PRTM^SCAPMC(+TEAM,,,,.VPRT) Q:'X
"RTN","VPRDPT",195,0)
 . S (I,PRV)=0 F  S PRV=+$O(@VPRT@("SCPR",PRV)) Q:PRV<1  D
"RTN","VPRDPT",196,0)
 .. S POS=$O(@VPRT@("SCPR",PRV,0))
"RTN","VPRDPT",197,0)
 .. S X=PRV_U_$P($G(^VA(200,PRV,0)),U)
"RTN","VPRDPT",198,0)
 .. S POS=$$GET1^DIQ(404.57,POS_",",.01)
"RTN","VPRDPT",199,0)
 .. S I=I+1,PAT("pcTeamMember",I)=X_U_POS_U_$$PROVSPC^VPRD(+X)
"RTN","VPRDPT",200,0)
 . K @VPRT,VPRT,X
"RTN","VPRDPT",201,0)
 S X=$$OUTPTPR^SDUTL3(DFN) I X D
"RTN","VPRDPT",202,0)
 . S PAT("pcProvider")=X_U_$$PROVSPC^VPRD(+X)
"RTN","VPRDPT",203,0)
 . S FAC=$P(TEAM,U,3,4) S:FAC<1 FAC=$$SITE^VASITE
"RTN","VPRDPT",204,0)
 . S X=$$PADD^XUAF4(+FAC) ;street^city^st^zip
"RTN","VPRDPT",205,0)
 . S ST=$$GET1^DIQ(4,+FAC_",",.02) S:ST="" ST=$P(X,U,3) ;get state name
"RTN","VPRDPT",206,0)
 . S PAT("pcProvider","address")=$P(X,U)_"^^^"_$P(X,U,2)_U_ST_U_$P(X,U,4)
"RTN","VPRDPT",207,0)
 Q
"RTN","VPRDPT",208,0)
 ;
"RTN","VPRDPT",209,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPT",210,0)
 ;
"RTN","VPRDPT",211,0)
XML(ITEM) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDPT",212,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDPT",213,0)
 N ATT,X,Y,NAMES,I,ID
"RTN","VPRDPT",214,0)
 D ADD("<patient>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPT",215,0)
 S ATT="" F  S ATT=$O(ITEM(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDPT",216,0)
 . S X=$G(ITEM(ATT)),NAMES=$$LABELS(ATT),Y=""
"RTN","VPRDPT",217,0)
 . I ATT="pcProvider" D  Q
"RTN","VPRDPT",218,0)
 .. S Y="<"_ATT_" "_$$LOOP_">" D ADD(Y)
"RTN","VPRDPT",219,0)
 .. S X=$G(ITEM(ATT,"address")) I $L(X) D ADDR(X)
"RTN","VPRDPT",220,0)
 .. D ADD("</"_ATT_">") S Y=""
"RTN","VPRDPT",221,0)
 . ;
"RTN","VPRDPT",222,0)
 . I $L($O(ITEM(ATT,""))) D  Q  ;multiples
"RTN","VPRDPT",223,0)
 .. S ID=$S($E(ATT,$L(ATT))="s":ATT_"es",$E(ATT,$L(ATT))="y":$E(ATT,1,$L(ATT)-1)_"ies",1:ATT_"s")
"RTN","VPRDPT",224,0)
 .. D ADD("<"_ID_">")
"RTN","VPRDPT",225,0)
 .. S I="" F  S I=$O(ITEM(ATT,I)) Q:I=""  D
"RTN","VPRDPT",226,0)
 ... S X=ITEM(ATT,I),Y="<"_ATT_" "
"RTN","VPRDPT",227,0)
 ... I ATT="support" D  S Y="" Q
"RTN","VPRDPT",228,0)
 .... S Y=Y_"contactType='"_I_"' "_$$LOOP_">" D ADD(Y)
"RTN","VPRDPT",229,0)
 .... S X=$G(ITEM(ATT,I,"address")) I $L(X) D ADDR(X)
"RTN","VPRDPT",230,0)
 .... S X=$G(ITEM(ATT,I,"telecom")) I $L(X) D PHONE(X)
"RTN","VPRDPT",231,0)
 .... D ADD("</support>")
"RTN","VPRDPT",232,0)
 ... I ATT="disability" S Y=Y_"vaCode='"_I_"' "
"RTN","VPRDPT",233,0)
 ... S Y=Y_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPT",234,0)
 .. D ADD("</"_ID_">") S Y=""
"RTN","VPRDPT",235,0)
 . ;
"RTN","VPRDPT",236,0)
 . I ATT="exposures" D:X["1"  S Y="" Q
"RTN","VPRDPT",237,0)
 .. S I=0,Y="<exposures>" D ADD(Y)
"RTN","VPRDPT",238,0)
 .. F ID="AO","IR","PG","HNC","MST","CV" S I=I+1 I $P(X,U,I) S Y="<exposure value='"_ID_"' />" D ADD(Y)
"RTN","VPRDPT",239,0)
 .. D ADD("</exposures>")
"RTN","VPRDPT",240,0)
 . ;
"RTN","VPRDPT",241,0)
 . I ATT="address" D ADDR(X) S Y="" Q
"RTN","VPRDPT",242,0)
 . I ATT="telecom" D PHONE(X) S Y="" Q
"RTN","VPRDPT",243,0)
 . ;
"RTN","VPRDPT",244,0)
 . Q:X=""  ;no data
"RTN","VPRDPT",245,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPT",246,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDPT",247,0)
 D ADD("</patient>")
"RTN","VPRDPT",248,0)
 Q
"RTN","VPRDPT",249,0)
 ;
"RTN","VPRDPT",250,0)
ADDR(X) ; -- XML address node from X=street1^st2^st3^city^state^zip
"RTN","VPRDPT",251,0)
 N I,Y Q:$L(X)'>5  ;no data
"RTN","VPRDPT",252,0)
 S Y="<address"
"RTN","VPRDPT",253,0)
 F I=1,2,3 I $L($P(X,U,I)) S Y=Y_" streetLine"_I_"='"_$$ESC^VPRD($P(X,U,I))_"'"
"RTN","VPRDPT",254,0)
 I $L($P(X,U,4)) S Y=Y_" city='"_$$ESC^VPRD($P(X,U,4))_"'"
"RTN","VPRDPT",255,0)
 I $L($P(X,U,5)) S Y=Y_" stateProvince='"_$P(X,U,5)_"'"
"RTN","VPRDPT",256,0)
 I $L($P(X,U,6)) S Y=Y_" postalCode='"_$P(X,U,6)_"'"
"RTN","VPRDPT",257,0)
 S Y=Y_" />" D ADD(Y)
"RTN","VPRDPT",258,0)
 Q
"RTN","VPRDPT",259,0)
 ;
"RTN","VPRDPT",260,0)
PHONE(X) ; -- XML telecom node from X=home^cell^work numbers
"RTN","VPRDPT",261,0)
 N I,Y Q:$L(X)'>2  ;no data
"RTN","VPRDPT",262,0)
 D ADD("<telecomList>")
"RTN","VPRDPT",263,0)
 I $L($P(X,U,1)) S Y="<telecom usageType='H' value='"_$P(X,U,1)_"' />" D ADD(Y)
"RTN","VPRDPT",264,0)
 I $L($P(X,U,2)) S Y="<telecom usageType='MC' value='"_$P(X,U,2)_"' />" D ADD(Y)
"RTN","VPRDPT",265,0)
 I $L($P(X,U,3)) S Y="<telecom usageType='WP' value='"_$P(X,U,3)_"' />" D ADD(Y)
"RTN","VPRDPT",266,0)
 D ADD("</telecomList>")
"RTN","VPRDPT",267,0)
 Q
"RTN","VPRDPT",268,0)
 ;
"RTN","VPRDPT",269,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDPT",270,0)
 N STR,P,TAG S STR=""
"RTN","VPRDPT",271,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDPT",272,0)
 Q STR
"RTN","VPRDPT",273,0)
 ;
"RTN","VPRDPT",274,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDPT",275,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPT",276,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPT",277,0)
 Q
"RTN","VPRDPT",278,0)
 ;
"RTN","VPRDPT",279,0)
LABELS(X) ; -- return string of attribute labels for element X
"RTN","VPRDPT",280,0)
 N Y S Y="code^name^Z"
"RTN","VPRDPT",281,0)
 I X="pcProvider" S Y="code^name^"_$$PROVTAGS^VPRD_"^Z"
"RTN","VPRDPT",282,0)
 I X="support" S Y="name^relationship^Z"
"RTN","VPRDPT",283,0)
 I X="eligibility" S Y="name^primary^Z"
"RTN","VPRDPT",284,0)
 I X="disability" S Y="printName^sc^scPercent^Z"
"RTN","VPRDPT",285,0)
 I X="alias" S Y="fullName^familyName^givenNames^Z"
"RTN","VPRDPT",286,0)
 I X="flag" S Y="name^text^Z"
"RTN","VPRDPT",287,0)
 I X="facility" S Y="code^name^latestDate^domain^homeSite^Z"
"RTN","VPRDPT",288,0)
 I X="pcTeamMember" S Y="code^name^role^"_$$PROVTAGS^VPRD_"^Z"
"RTN","VPRDPT",289,0)
 I X="ethnicity"!(X="race") S Y="value^Z"
"RTN","VPRDPT",290,0)
 I X="admitted" S Y="id^date^Z"
"RTN","VPRDPT",291,0)
 Q Y
"RTN","VPRDVSIT")
0^2^B106024378^B106014987
"RTN","VPRDVSIT",1,0)
VPRDVSIT ;SLC/MKB -- Visit/Encounter extract ;8/2/11  15:29
"RTN","VPRDVSIT",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,2,4,5,7**;Sep 01, 2011;Build 3
"RTN","VPRDVSIT",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDVSIT",4,0)
 ;
"RTN","VPRDVSIT",5,0)
 ; External References          DBIA#
"RTN","VPRDVSIT",6,0)
 ; -------------------          -----
"RTN","VPRDVSIT",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDVSIT",8,0)
 ; ^DIC(40.7                      557
"RTN","VPRDVSIT",9,0)
 ; ^DIC(42                      10039
"RTN","VPRDVSIT",10,0)
 ; ^DIC(45.7                     1154
"RTN","VPRDVSIT",11,0)
 ; ^DPT(                        10035
"RTN","VPRDVSIT",12,0)
 ; ^SC                          10040
"RTN","VPRDVSIT",13,0)
 ; ^VA(200                      10060
"RTN","VPRDVSIT",14,0)
 ; DGPTFAPI                      3157
"RTN","VPRDVSIT",15,0)
 ; DIC                           2051
"RTN","VPRDVSIT",16,0)
 ; DILFD                         2055
"RTN","VPRDVSIT",17,0)
 ; DIQ                           2056
"RTN","VPRDVSIT",18,0)
 ; ICDEX                         5747
"RTN","VPRDVSIT",19,0)
 ; ICPTCOD                       1995
"RTN","VPRDVSIT",20,0)
 ; PXAPI,^TMP("PXKENC",$J        1894
"RTN","VPRDVSIT",21,0)
 ; SDOE                          2546
"RTN","VPRDVSIT",22,0)
 ; VADPT                        10061
"RTN","VPRDVSIT",23,0)
 ; VADPT2                         325
"RTN","VPRDVSIT",24,0)
 ; XUAF4                         2171
"RTN","VPRDVSIT",25,0)
 ;
"RTN","VPRDVSIT",26,0)
 ; ------------ Get encounter(s) from VistA ------------
"RTN","VPRDVSIT",27,0)
 ;
"RTN","VPRDVSIT",28,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's visits and appointments
"RTN","VPRDVSIT",29,0)
 N VPRCNT,VPRITM,VPRDT,VPRLOC,VPRDA
"RTN","VPRDVSIT",30,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDVSIT",31,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDVSIT",32,0)
 ;
"RTN","VPRDVSIT",33,0)
 ; get one visit
"RTN","VPRDVSIT",34,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) G ENQ
"RTN","VPRDVSIT",35,0)
 ;
"RTN","VPRDVSIT",36,0)
 ; -- get all visits
"RTN","VPRDVSIT",37,0)
 I END,END'["." S END=END_".24" ;assume end of day
"RTN","VPRDVSIT",38,0)
 S VPRCNT=0
"RTN","VPRDVSIT",39,0)
 ;F  S IDX=$Q(@IDX,-1) Q:DFN'=$P(IDX,",",2)  Q:$P(IDX,",",3)<BEG  I $P(IDX,",",5)["P" D
"RTN","VPRDVSIT",40,0)
 S VPRDT=END F  S VPRDT=$O(^AUPNVSIT("AET",DFN,VPRDT),-1)  Q:VPRDT<BEG  D  Q:VPRCNT'<MAX
"RTN","VPRDVSIT",41,0)
 . S VPRLOC=0 F  S VPRLOC=$O(^AUPNVSIT("AET",DFN,VPRDT,VPRLOC)) Q:VPRLOC<1  D
"RTN","VPRDVSIT",42,0)
 .. S VPRDA=0 F  S VPRDA=$O(^AUPNVSIT("AET",DFN,VPRDT,VPRLOC,"P",VPRDA)) Q:VPRDA<1  D
"RTN","VPRDVSIT",43,0)
 ... K VPRITM D EN1(VPRDA,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDVSIT",44,0)
 ... D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDVSIT",45,0)
ENQ ; end
"RTN","VPRDVSIT",46,0)
 K ^TMP("VPRTEXT",$J)
"RTN","VPRDVSIT",47,0)
 Q
"RTN","VPRDVSIT",48,0)
 ;
"RTN","VPRDVSIT",49,0)
ENAA(DFN,BEG,END,MAX,ID) ; -- find patient's visits and appointments [AA]
"RTN","VPRDVSIT",50,0)
 N IDT,DA,VPRCNT,VPRITM
"RTN","VPRDVSIT",51,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDVSIT",52,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDVSIT",53,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) Q  ;one visit
"RTN","VPRDVSIT",54,0)
 D IDT S VPRCNT=0
"RTN","VPRDVSIT",55,0)
 S IDT=BEG F  S IDT=$O(^AUPNVSIT("AA",DFN,IDT)) Q:IDT<1!(IDT>END)  D  Q:VPRCNT'<MAX
"RTN","VPRDVSIT",56,0)
 . S DA=0 F  S DA=$O(^AUPNVSIT("AA",DFN,IDT,DA)) Q:DA<1  D
"RTN","VPRDVSIT",57,0)
 .. K VPRITM D EN1(DA,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDVSIT",58,0)
 .. D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDVSIT",59,0)
 Q
"RTN","VPRDVSIT",60,0)
IDT ; -- invert BEG and END dates for visit format:
"RTN","VPRDVSIT",61,0)
 ;  IDT=(9999999-$P(VDT,"."))_"."_$P(VDT,".",2)
"RTN","VPRDVSIT",62,0)
 N X S X=BEG
"RTN","VPRDVSIT",63,0)
 S BEG=(9999999-$P(END,"."))
"RTN","VPRDVSIT",64,0)
 S END=(9999999-$P(X,"."))_".2359"
"RTN","VPRDVSIT",65,0)
 Q
"RTN","VPRDVSIT",66,0)
 ;
"RTN","VPRDVSIT",67,0)
EN1(IEN,VST) ; -- return a visit in VST("attribute")=value
"RTN","VPRDVSIT",68,0)
 N X0,X15,X,DATE,FAC,LOC,CATG,INPT,DA
"RTN","VPRDVSIT",69,0)
 K VST,^TMP("VPRTEXT",$J)
"RTN","VPRDVSIT",70,0)
 S IEN=+$G(IEN) Q:IEN<1  ;invalid
"RTN","VPRDVSIT",71,0)
 D ENCEVENT^PXAPI(IEN)
"RTN","VPRDVSIT",72,0)
 S X0=$G(^TMP("PXKENC",$J,IEN,"VST",IEN,0)),X15=$G(^(150))
"RTN","VPRDVSIT",73,0)
 Q:$P(X15,U,3)'="P"  ;Q:$P(X0,U,7)="E"  ;want primary, not historical
"RTN","VPRDVSIT",74,0)
 I $P(X0,U,7)="H" D ADM(IEN,+X0,.VST) Q
"RTN","VPRDVSIT",75,0)
 S VST("id")=IEN,VST("dateTime")=+X0,DATE=+X0
"RTN","VPRDVSIT",76,0)
 S FAC=+$P(X0,U,6),CATG=$P(X0,U,7),LOC=+$P(X0,U,22)
"RTN","VPRDVSIT",77,0)
 S:FAC VST("facility")=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDVSIT",78,0)
 S:'FAC VST("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDVSIT",79,0)
 S VST("serviceCategory")=CATG_U_$$CATG(CATG)
"RTN","VPRDVSIT",80,0)
 S VST("visitString")=LOC_";"_DATE_";"_CATG
"RTN","VPRDVSIT",81,0)
 S INPT=$P(X15,U,2) S:INPT="" INPT=$S("H^I^R^D"[CATG:1,1:0)
"RTN","VPRDVSIT",82,0)
 S X=$$CPT(IEN) S:X VST("type")=$P($$CPT^ICPTCOD(X),U,2,3)
"RTN","VPRDVSIT",83,0)
 I 'X S VST("type")=U_$S('INPT&LOC:$P($G(^SC(LOC,0)),U)_" VISIT",1:$$CATG(CATG))
"RTN","VPRDVSIT",84,0)
 S VST("patientClass")=$S(INPT:"IMP",1:"AMB")
"RTN","VPRDVSIT",85,0)
 S:INPT VST("admission")=$$ADMVT(DATE) ;get related mvt# if inpt visit/data
"RTN","VPRDVSIT",86,0)
 S X=$P(X0,U,8) S:X VST("stopCode")=$$AMIS(X) I LOC D
"RTN","VPRDVSIT",87,0)
 . N L0 S L0=$G(^SC(LOC,0))
"RTN","VPRDVSIT",88,0)
 . I 'X S VST("stopCode")=$$AMIS($P(L0,U,7))
"RTN","VPRDVSIT",89,0)
 . S VST("location")=$P(L0,U),VST("service")=$$SERV($P(L0,U,20))
"RTN","VPRDVSIT",90,0)
 . S X=$P(L0,U,18) S:X VST("creditStopCode")=$$AMIS(X)
"RTN","VPRDVSIT",91,0)
 S VST("reason")=$$POV(IEN,DATE)
"RTN","VPRDVSIT",92,0)
 ; provider(s), including taxonomy/specialty info
"RTN","VPRDVSIT",93,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,IEN,"PRV",DA)) Q:DA<1  S X0=$G(^(DA,0)) D
"RTN","VPRDVSIT",94,0)
 . S VST("provider",DA)=+X0_U_$P($G(^VA(200,+X0,0)),U)_$S($P(X0,U,4)="P":"^P^1",1:"^S^")_U_$$PROVSPC^VPRD(+X0)
"RTN","VPRDVSIT",95,0)
 ; cpt(s)
"RTN","VPRDVSIT",96,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,IEN,"CPT",DA)) Q:DA<1  S X0=$G(^(DA,0)) D
"RTN","VPRDVSIT",97,0)
 . S VST("cpt",DA)=$P($$CPT^ICPTCOD(+X0),U,2,3)
"RTN","VPRDVSIT",98,0)
 ; icd(s)
"RTN","VPRDVSIT",99,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,IEN,"POV",DA)) Q:DA<1  S X0=$G(^(DA,0)) D
"RTN","VPRDVSIT",100,0)
 . S VST("icd",DA)=$$ICD(+X0,DATE)_U_$$EXTERNAL^DILFD(9000010.07,.04,,$P(X0,U,4))_U_$S($L($P(X0,U,12)):$P(X0,U,12),1:"U")
"RTN","VPRDVSIT",101,0)
 ; note(s)
"RTN","VPRDVSIT",102,0)
 D TIU(IEN)
"RTN","VPRDVSIT",103,0)
 K ^TMP("PXKENC",$J,IEN)
"RTN","VPRDVSIT",104,0)
 Q
"RTN","VPRDVSIT",105,0)
 ;
"RTN","VPRDVSIT",106,0)
TIU(VISIT) ; -- add notes to VST("document")
"RTN","VPRDVSIT",107,0)
 N X,Y,I,VPRX,LT,NT,DA,CNT,VPRY
"RTN","VPRDVSIT",108,0)
 D FIND^DIC(8925,,.01,"QX",+$G(VISIT),,"V",,,"VPRX")
"RTN","VPRDVSIT",109,0)
 S Y="",(I,CNT)=0
"RTN","VPRDVSIT",110,0)
 F  S I=$O(VPRX("DILIST",1,I)) Q:I<1  D
"RTN","VPRDVSIT",111,0)
 . S DA=$G(VPRX("DILIST",2,I))
"RTN","VPRDVSIT",112,0)
 . S Y=$$INFO^VPRDTIU(+DA) Q:Y<1  ;draft or retracted
"RTN","VPRDVSIT",113,0)
 . S CNT=CNT+1,VST("document",CNT)=Y
"RTN","VPRDVSIT",114,0)
 . S:$G(VPRTEXT) VST("document",CNT,"content")=$$TEXT^VPRDTIU(DA)
"RTN","VPRDVSIT",115,0)
 Q
"RTN","VPRDVSIT",116,0)
 ;
"RTN","VPRDVSIT",117,0)
POV(VISIT,VDT) ; -- return the primary Purpose of Visit as ICD^ProviderNarrative
"RTN","VPRDVSIT",118,0)
 N DA,Y,X,X0,ICD S Y=""
"RTN","VPRDVSIT",119,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,VISIT,"POV",DA)) Q:DA<1  S X0=$G(^(DA,0)) I $P(X0,U,12)="P" D  Q:$L(Y)
"RTN","VPRDVSIT",120,0)
 . S X=+$P(X0,U,4),ICD=$$ICD(+X0,$G(VDT))
"RTN","VPRDVSIT",121,0)
 . S Y=ICD_U_$$EXTERNAL^DILFD(9000010.07,.04,,X)
"RTN","VPRDVSIT",122,0)
 Q Y
"RTN","VPRDVSIT",123,0)
 ;
"RTN","VPRDVSIT",124,0)
ICD(IEN,DATE) ; -- return code^description^system for ICD code, or "^^" if error
"RTN","VPRDVSIT",125,0)
 N X0,VPRX,N,I,X,Y
"RTN","VPRDVSIT",126,0)
 S IEN=+$G(IEN),DATE=+$G(DATE,DT)
"RTN","VPRDVSIT",127,0)
 S Y=$$CODEC^ICDEX(80,IEN),X=$$VLTD^ICDEX(IEN,DATE)
"RTN","VPRDVSIT",128,0)
 I $L(X) S Y=Y_U_X
"RTN","VPRDVSIT",129,0)
 E  S Y=Y_U_$$VSTD^ICDEX(IEN,DATE)
"RTN","VPRDVSIT",130,0)
 S X=$$CSI^ICDEX(80,IEN),$P(Y,U,3)=$$SAB^ICDEX(X)
"RTN","VPRDVSIT",131,0)
 Q Y
"RTN","VPRDVSIT",132,0)
 ;
"RTN","VPRDVSIT",133,0)
CPT(VISIT) ; -- Return CPT code of encounter type
"RTN","VPRDVSIT",134,0)
 N DA,Y,X,X0 S Y=""
"RTN","VPRDVSIT",135,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,VISIT,"CPT",DA)) Q:DA<1  S X0=$G(^(DA,0)) D  Q:$L(Y)
"RTN","VPRDVSIT",136,0)
 . S X=$P(X0,U) I X?1"992"2N S Y=X Q
"RTN","VPRDVSIT",137,0)
 Q Y
"RTN","VPRDVSIT",138,0)
 ;
"RTN","VPRDVSIT",139,0)
AMIS(X) ; -- return the AMIS code^name of Credit Stop X
"RTN","VPRDVSIT",140,0)
 N Y,X0 S Y=""
"RTN","VPRDVSIT",141,0)
 S X0=$G(^DIC(40.7,+$G(X),0)) S:$L(X0) Y=$P(X0,U,2)_U_$P(X0,U)
"RTN","VPRDVSIT",142,0)
 Q Y
"RTN","VPRDVSIT",143,0)
 ;
"RTN","VPRDVSIT",144,0)
CATG(X) ; -- Return name of visit Service Category code X
"RTN","VPRDVSIT",145,0)
 N Y S Y=""
"RTN","VPRDVSIT",146,0)
 I X="A" S Y="AMBULATORY"
"RTN","VPRDVSIT",147,0)
 I X="H" S Y="HOSPITALIZATION"
"RTN","VPRDVSIT",148,0)
 I X="I" S Y="IN HOSPITAL"
"RTN","VPRDVSIT",149,0)
 I X="C" S Y="CHART REVIEW"
"RTN","VPRDVSIT",150,0)
 I X="T" S Y="TELECOMMUNICATIONS"
"RTN","VPRDVSIT",151,0)
 I X="N" S Y="NOT FOUND"
"RTN","VPRDVSIT",152,0)
 I X="S" S Y="DAY SURGERY"
"RTN","VPRDVSIT",153,0)
 I X="O" S Y="OBSERVATION"
"RTN","VPRDVSIT",154,0)
 I X="E" S Y="EVENT (HISTORICAL)"
"RTN","VPRDVSIT",155,0)
 I X="R" S Y="NURSING HOME"
"RTN","VPRDVSIT",156,0)
 I X="D" S Y="DAILY HOSPITALIZATION DATA"
"RTN","VPRDVSIT",157,0)
 I X="X" S Y="ANCILLARY PACKAGE DAILY DATA"
"RTN","VPRDVSIT",158,0)
 Q Y
"RTN","VPRDVSIT",159,0)
 ;
"RTN","VPRDVSIT",160,0)
SERV(FTS) ; -- Return #42.4 Service for a Facility Treating Specialty
"RTN","VPRDVSIT",161,0)
 N Y S Y="",FTS=+$G(FTS)
"RTN","VPRDVSIT",162,0)
 S Y=$$GET1^DIQ(45.7,FTS_",","1:3","E")
"RTN","VPRDVSIT",163,0)
 Q Y
"RTN","VPRDVSIT",164,0)
 ;
"RTN","VPRDVSIT",165,0)
ADMVT(VAINDT) ; -- return movement# for related admission
"RTN","VPRDVSIT",166,0)
 N VADMVT,VAERR
"RTN","VPRDVSIT",167,0)
 D ADM^VADPT2
"RTN","VPRDVSIT",168,0)
 Q VADMVT
"RTN","VPRDVSIT",169,0)
 ;
"RTN","VPRDVSIT",170,0)
ADM(IEN,DATE,ADM) ; -- return an admission in ADM("attribute")=value
"RTN","VPRDVSIT",171,0)
 N VAINDT,VADMVT,VAIP,VAIN,VAERR,HLOC,ICD,I K ADM
"RTN","VPRDVSIT",172,0)
 S IEN=+$G(IEN),DATE=+$G(DATE) Q:IEN<1  Q:DATE<1
"RTN","VPRDVSIT",173,0)
 S VAINDT=DATE D ADM^VADPT2 Q:VADMVT<1
"RTN","VPRDVSIT",174,0)
 I VADMVT=$G(^DPT(DFN,.105)) D INPT Q  ;current inpatient
"RTN","VPRDVSIT",175,0)
 S VAIP("E")=VADMVT D IN5^VADPT Q:'$G(VAIP(1))  ;deleted
"RTN","VPRDVSIT",176,0)
 S ADM("id")=IEN,ADM("patientClass")="IMP",ADM("admission")=$G(VAIP(13))
"RTN","VPRDVSIT",177,0)
 ; ADM("admitType")=$P($G(VAIP(4)),U,2)
"RTN","VPRDVSIT",178,0)
 S DATE=+$G(VAIP(13,1)),(ADM("dateTime"),ADM("arrivalDateTime"))=DATE,I=0
"RTN","VPRDVSIT",179,0)
 S X=$G(VAIP(7)) S:X I=I+1,ADM("provider",I)=X_"^P^1"_U_$$PROVSPC^VPRD(+X) ;primary
"RTN","VPRDVSIT",180,0)
 S X=$G(VAIP(18)) S:X I=I+1,ADM("provider",I)=X_"^A^"_U_$$PROVSPC^VPRD(+X) ;attending
"RTN","VPRDVSIT",181,0)
 S ADM("specialty")=$P($G(VAIP(8)),U,2)
"RTN","VPRDVSIT",182,0)
 S X=$$SERV(+$G(VAIP(8))),ADM("service")=X,ADM("ptf")=VAIP(12)
"RTN","VPRDVSIT",183,0)
 S ICD=$$POV(IEN,DATE) S:'ICD ICD=$$PTF(DFN,VAIP(12),DATE) ;PTF>ICD
"RTN","VPRDVSIT",184,0)
 S ADM("reason")=ICD_U_$G(VAIP(9)) ;ICD code^description^system^Dx text
"RTN","VPRDVSIT",185,0)
 S HLOC=+$G(^DIC(42,+$G(VAIP(5)),44))
"RTN","VPRDVSIT",186,0)
 S:HLOC ADM("location")=$P($G(^SC(HLOC,0)),U)
"RTN","VPRDVSIT",187,0)
 S ADM("facility")=$$FAC^VPRD(+HLOC),ADM("roomBed")=$P(VAIP(6),U,2)
"RTN","VPRDVSIT",188,0)
 S ADM("serviceCategory")="H^HOSPITALIZATION"
"RTN","VPRDVSIT",189,0)
 S X=$$CPT(IEN),ADM("type")=$S(X:$P($$CPT^ICPTCOD(X),U,2,3),1:U_$$CATG("H"))
"RTN","VPRDVSIT",190,0)
 I $G(VAIP(17)) D
"RTN","VPRDVSIT",191,0)
 . S ADM("departureDateTime")=+$G(VAIP(17,1))
"RTN","VPRDVSIT",192,0)
 . ; ADM("disposition")=$G(VAIP(17,3)) ;Discharge Mvt Type
"RTN","VPRDVSIT",193,0)
 S ADM("visitString")=HLOC_";"_DATE_";H"
"RTN","VPRDVSIT",194,0)
 D TIU(IEN) ;notes/summary
"RTN","VPRDVSIT",195,0)
 Q
"RTN","VPRDVSIT",196,0)
 ;
"RTN","VPRDVSIT",197,0)
INPT ; -- return current admission in ADM("attribute")=value [from ADM]
"RTN","VPRDVSIT",198,0)
 K VAINDT D INP^VADPT Q:$G(VAIN(1))<1
"RTN","VPRDVSIT",199,0)
 S ADM("id")=IEN,ADM("patientClass")="IMP",ADM("admission")=VAIN(1)
"RTN","VPRDVSIT",200,0)
 ; ADM("admitType")=$P($G(VAIN(8)),U,2)
"RTN","VPRDVSIT",201,0)
 S DATE=+$G(VAIN(7)),(ADM("dateTime"),ADM("arrivalDateTime"))=DATE,I=0
"RTN","VPRDVSIT",202,0)
 S X=$G(VAIN(2)) S:X I=I+1,ADM("provider",I)=X_"^P^1"_U_$$PROVSPC^VPRD(+X) ;primary
"RTN","VPRDVSIT",203,0)
 S X=$G(VAIN(11)) S:X I=I+1,ADM("provider",I)=X_"^A^"_U_$$PROVSPC^VPRD(+X) ;attending
"RTN","VPRDVSIT",204,0)
 S ADM("specialty")=$P($G(VAIN(3)),U,2)
"RTN","VPRDVSIT",205,0)
 S X=$$SERV(+$G(VAIN(3))),ADM("service")=X,ADM("ptf")=VAIN(10)
"RTN","VPRDVSIT",206,0)
 S ICD=$$POV(IEN,DATE) S:'ICD ICD=$$PTF(DFN,VAIN(10),DATE) ;PTF>ICD
"RTN","VPRDVSIT",207,0)
 S ADM("reason")=ICD_U_$G(VAIN(9)) ;ICD code^description^system^Dx text
"RTN","VPRDVSIT",208,0)
 S HLOC=+$G(^DIC(42,+$G(VAIN(4)),44))
"RTN","VPRDVSIT",209,0)
 S:HLOC ADM("location")=$P($G(^SC(HLOC,0)),U)
"RTN","VPRDVSIT",210,0)
 S ADM("facility")=$$FAC^VPRD(+HLOC),ADM("roomBed")=VAIN(5)
"RTN","VPRDVSIT",211,0)
 S ADM("serviceCategory")="H^HOSPITALIZATION"
"RTN","VPRDVSIT",212,0)
 S X=$$CPT(IEN),ADM("type")=$S(X:$P($$CPT^ICPTCOD(X),U,2,3),1:U_$$CATG("H"))
"RTN","VPRDVSIT",213,0)
 ; ADM("visitString")=HLOC_";"_DATE_";H"
"RTN","VPRDVSIT",214,0)
 D TIU(IEN) ;notes/summary
"RTN","VPRDVSIT",215,0)
 Q
"RTN","VPRDVSIT",216,0)
 ;
"RTN","VPRDVSIT",217,0)
PTF(DFN,PTF,DATE) ; -- return ICD code^description^system for a PTF record
"RTN","VPRDVSIT",218,0)
 N VPRPTF,X0,Y
"RTN","VPRDVSIT",219,0)
 D:$G(PTF) RPC^DGPTFAPI(.VPRPTF,+PTF) I $G(VPRPTF(0))<0 Q "^^"
"RTN","VPRDVSIT",220,0)
 S Y=$P($G(VPRPTF(1)),U,3),DATE=+$G(DATE,DT)
"RTN","VPRDVSIT",221,0)
 S X0=$$ICDDX^ICDEX(Y,DATE,,"E") I X0<0 Q "^^"
"RTN","VPRDVSIT",222,0)
 S Y=$P(X0,U,2)_U_$P(X0,U,4)          ;ICD Code^Dx name
"RTN","VPRDVSIT",223,0)
 S $P(Y,U,3)=$$SAB^ICDEX($P(X0,U,20)) ;coding system
"RTN","VPRDVSIT",224,0)
 Q Y
"RTN","VPRDVSIT",225,0)
 ;
"RTN","VPRDVSIT",226,0)
ENC(IEN,ENC) ; -- return an encounter in ENC("attribute")=value
"RTN","VPRDVSIT",227,0)
 N X0,DATE,HLOC,TYPE,STS,X,Y K ENC
"RTN","VPRDVSIT",228,0)
 S IEN=+$G(IEN) Q:IEN<1  ;invalid ien
"RTN","VPRDVSIT",229,0)
 S ENC("id")="E"_IEN,X0=$$GETOE^SDOE(IEN) ;^SCE(IEN,0) node
"RTN","VPRDVSIT",230,0)
 S DATE=+X0,ENC("dateTime")=DATE
"RTN","VPRDVSIT",231,0)
 S HLOC=+$P(X0,U,4) I HLOC D
"RTN","VPRDVSIT",232,0)
 . S HLOC=HLOC_U_$P($G(^SC(HLOC,0)),U)
"RTN","VPRDVSIT",233,0)
 . S ENC("location")=$P(HLOC,U,2)
"RTN","VPRDVSIT",234,0)
 . S X=$$GET1^DIQ(44,+HLOC_",",9.5,"I")
"RTN","VPRDVSIT",235,0)
 . I X S ENC("service")=$$SERV(X)
"RTN","VPRDVSIT",236,0)
 S ENC("facility")=$$FAC^VPRD(+HLOC)
"RTN","VPRDVSIT",237,0)
 S STS=$$EXTERNAL^DILFD(409.68,.12,,$P(X0,U,12))
"RTN","VPRDVSIT",238,0)
 S X=$S(STS?1"INP".E:"IMP",1:"AMB"),ENC("patientClass")=X,TYPE=$E(X)
"RTN","VPRDVSIT",239,0)
 S ENC("type")=U_$S(HLOC:$P(HLOC,U,2)_" VISIT",1:$$CATG(TYPE))
"RTN","VPRDVSIT",240,0)
 S ENC("serviceCategory")=TYPE_U_$$CATG(TYPE)
"RTN","VPRDVSIT",241,0)
 S ENC("visitString")=+HLOC_";"_DATE_";"_TYPE
"RTN","VPRDVSIT",242,0)
 Q
"RTN","VPRDVSIT",243,0)
 ;
"RTN","VPRDVSIT",244,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDVSIT",245,0)
 ;
"RTN","VPRDVSIT",246,0)
XML(VISIT) ; -- Return patient visit as XML
"RTN","VPRDVSIT",247,0)
 N ATT,X,Y,NAMES,I,J
"RTN","VPRDVSIT",248,0)
 D ADD("<visit>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDVSIT",249,0)
 S ATT="" F  S ATT=$O(VISIT(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDVSIT",250,0)
 . I $O(VISIT(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDVSIT",251,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDVSIT",252,0)
 .. S I=0 F  S I=$O(VISIT(ATT,I)) Q:I<1  D
"RTN","VPRDVSIT",253,0)
 ... S X=$G(VISIT(ATT,I)),NAMES=""
"RTN","VPRDVSIT",254,0)
 ... I ATT="document" S NAMES="id^localTitle^nationalTitle^vuid^Z"
"RTN","VPRDVSIT",255,0)
 ... I ATT="provider" S NAMES="code^name^role^primary^"_$$PROVTAGS^VPRD_"^Z"
"RTN","VPRDVSIT",256,0)
 ... I ATT="cpt" S NAMES="code^name^Z"
"RTN","VPRDVSIT",257,0)
 ... I ATT="icd" S NAMES="code^name^system^narrative^ranking^Z"
"RTN","VPRDVSIT",258,0)
 ... S Y="<"_ATT_" "_$$LOOP ;_"/>" D ADD(Y)
"RTN","VPRDVSIT",259,0)
 ... S X=$G(VISIT(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDVSIT",260,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDVSIT",261,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDVSIT",262,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDVSIT",263,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDVSIT",264,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDVSIT",265,0)
 . S X=$G(VISIT(ATT)),Y="" Q:'$L(X)
"RTN","VPRDVSIT",266,0)
 . S NAMES="code^name^"_$S(ATT="reason":"system^narrative^",1:"")_"Z"
"RTN","VPRDVSIT",267,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDVSIT",268,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDVSIT",269,0)
 D ADD("</visit>")
"RTN","VPRDVSIT",270,0)
 Q
"RTN","VPRDVSIT",271,0)
 ;
"RTN","VPRDVSIT",272,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDVSIT",273,0)
 N STR,P,TAG S STR=""
"RTN","VPRDVSIT",274,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDVSIT",275,0)
 Q STR
"RTN","VPRDVSIT",276,0)
 ;
"RTN","VPRDVSIT",277,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDVSIT",278,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDVSIT",279,0)
 S @VPR@(VPRI)=X
"RTN","VPRDVSIT",280,0)
 Q
"RTN","VPRPATCH")
0^8^B532746^n/a
"RTN","VPRPATCH",1,0)
VPRPATCH ;SLC/MKB -- VPR patch post install ;8/14/13  11:22
"RTN","VPRPATCH",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**7**;Sep 01, 2011;Build 3
"RTN","VPRPATCH",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRPATCH",4,0)
 ;
"RTN","VPRPATCH",5,0)
 ; External References          DBIA#
"RTN","VPRPATCH",6,0)
 ; -------------------          -----
"RTN","VPRPATCH",7,0)
 ; XPAR                          2263
"RTN","VPRPATCH",8,0)
 ;
"RTN","VPRPATCH",9,0)
 ;
"RTN","VPRPATCH",10,0)
PRE ; -- pre init
"RTN","VPRPATCH",11,0)
 Q
"RTN","VPRPATCH",12,0)
 ;
"RTN","VPRPATCH",13,0)
POST ; -- post init
"RTN","VPRPATCH",14,0)
 N P,N S P=+$P($G(XPDNM),"*",3) I P D  ;update version#
"RTN","VPRPATCH",15,0)
 . S N="1."_$S(P<10:"0",1:"")_P
"RTN","VPRPATCH",16,0)
 . D PUT^XPAR("PKG","VPR VERSION",1,N)
"RTN","VPRPATCH",17,0)
 Q
"VER")
8.0^22.2
"BLD",9471,6)
^6
**END**
**END**

