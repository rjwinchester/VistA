EMERGENCY Released VPR*1*5 SEQ #4
Extracted from mail message
**KIDS**:VPR*1.0*5^

**INSTALL NAME**
VPR*1.0*5
"BLD",9185,0)
VPR*1.0*5^VIRTUAL PATIENT RECORD^0^3150813^y
"BLD",9185,4,0)
^9.64PA^^
"BLD",9185,6.3)
21
"BLD",9185,"INID")
^y
"BLD",9185,"INIT")
POST^VPRP5I
"BLD",9185,"KRN",0)
^9.67PA^779.2^20
"BLD",9185,"KRN",.4,0)
.4
"BLD",9185,"KRN",.401,0)
.401
"BLD",9185,"KRN",.402,0)
.402
"BLD",9185,"KRN",.403,0)
.403
"BLD",9185,"KRN",.5,0)
.5
"BLD",9185,"KRN",.84,0)
.84
"BLD",9185,"KRN",3.6,0)
3.6
"BLD",9185,"KRN",3.8,0)
3.8
"BLD",9185,"KRN",9.2,0)
9.2
"BLD",9185,"KRN",9.8,0)
9.8
"BLD",9185,"KRN",9.8,"NM",0)
^9.68A^26^26
"BLD",9185,"KRN",9.8,"NM",1,0)
VPRD^^0^B43397804
"BLD",9185,"KRN",9.8,"NM",2,0)
VPRDGMPL^^0^B30131363
"BLD",9185,"KRN",9.8,"NM",3,0)
VPRDIB^^0^B13733802
"BLD",9185,"KRN",9.8,"NM",4,0)
VPRDOR^^0^B27908661
"BLD",9185,"KRN",9.8,"NM",5,0)
VPRDPT^^0^B99429749
"BLD",9185,"KRN",9.8,"NM",6,0)
VPRDPXIM^^0^B29791486
"BLD",9185,"KRN",9.8,"NM",7,0)
VPRDPXRM^^0^B9085519
"BLD",9185,"KRN",9.8,"NM",8,0)
VPRDRMIM^^0^B24311841
"BLD",9185,"KRN",9.8,"NM",9,0)
VPRDSDAM^^0^B21167478
"BLD",9185,"KRN",9.8,"NM",10,0)
VPRDTST^^0^B32685783
"BLD",9185,"KRN",9.8,"NM",11,0)
VPRDRA^^0^B49387414
"BLD",9185,"KRN",9.8,"NM",12,0)
VPRDGMRC^^0^B10985584
"BLD",9185,"KRN",9.8,"NM",13,0)
VPRDLRA^^0^B97052919
"BLD",9185,"KRN",9.8,"NM",14,0)
VPRDMC^^0^B61607238
"BLD",9185,"KRN",9.8,"NM",15,0)
VPRDSR^^0^B30721686
"BLD",9185,"KRN",9.8,"NM",16,0)
VPRDVSIT^^0^B106014987
"BLD",9185,"KRN",9.8,"NM",17,0)
VPRDPROC^^0^B10655010
"BLD",9185,"KRN",9.8,"NM",18,0)
VPRDTIU^^0^B90403730
"BLD",9185,"KRN",9.8,"NM",19,0)
VPRDLR^^0^B29963842
"BLD",9185,"KRN",9.8,"NM",20,0)
VPRDLRO^^0^B34279293
"BLD",9185,"KRN",9.8,"NM",21,0)
VPRDPS^^0^B21702415
"BLD",9185,"KRN",9.8,"NM",22,0)
VPRDJ0^^0^B83117538
"BLD",9185,"KRN",9.8,"NM",23,0)
VPRDJ02^^0^B44230094
"BLD",9185,"KRN",9.8,"NM",24,0)
VPRDJ04^^0^B48088220
"BLD",9185,"KRN",9.8,"NM",25,0)
VPRDJ04A^^0^B35067136
"BLD",9185,"KRN",9.8,"NM",26,0)
VPRDJ09^^0^B36288746
"BLD",9185,"KRN",9.8,"NM","B","VPRD",1)

"BLD",9185,"KRN",9.8,"NM","B","VPRDGMPL",2)

"BLD",9185,"KRN",9.8,"NM","B","VPRDGMRC",12)

"BLD",9185,"KRN",9.8,"NM","B","VPRDIB",3)

"BLD",9185,"KRN",9.8,"NM","B","VPRDJ0",22)

"BLD",9185,"KRN",9.8,"NM","B","VPRDJ02",23)

"BLD",9185,"KRN",9.8,"NM","B","VPRDJ04",24)

"BLD",9185,"KRN",9.8,"NM","B","VPRDJ04A",25)

"BLD",9185,"KRN",9.8,"NM","B","VPRDJ09",26)

"BLD",9185,"KRN",9.8,"NM","B","VPRDLR",19)

"BLD",9185,"KRN",9.8,"NM","B","VPRDLRA",13)

"BLD",9185,"KRN",9.8,"NM","B","VPRDLRO",20)

"BLD",9185,"KRN",9.8,"NM","B","VPRDMC",14)

"BLD",9185,"KRN",9.8,"NM","B","VPRDOR",4)

"BLD",9185,"KRN",9.8,"NM","B","VPRDPROC",17)

"BLD",9185,"KRN",9.8,"NM","B","VPRDPS",21)

"BLD",9185,"KRN",9.8,"NM","B","VPRDPT",5)

"BLD",9185,"KRN",9.8,"NM","B","VPRDPXIM",6)

"BLD",9185,"KRN",9.8,"NM","B","VPRDPXRM",7)

"BLD",9185,"KRN",9.8,"NM","B","VPRDRA",11)

"BLD",9185,"KRN",9.8,"NM","B","VPRDRMIM",8)

"BLD",9185,"KRN",9.8,"NM","B","VPRDSDAM",9)

"BLD",9185,"KRN",9.8,"NM","B","VPRDSR",15)

"BLD",9185,"KRN",9.8,"NM","B","VPRDTIU",18)

"BLD",9185,"KRN",9.8,"NM","B","VPRDTST",10)

"BLD",9185,"KRN",9.8,"NM","B","VPRDVSIT",16)

"BLD",9185,"KRN",19,0)
19
"BLD",9185,"KRN",19.1,0)
19.1
"BLD",9185,"KRN",101,0)
101
"BLD",9185,"KRN",409.61,0)
409.61
"BLD",9185,"KRN",771,0)
771
"BLD",9185,"KRN",779.2,0)
779.2
"BLD",9185,"KRN",870,0)
870
"BLD",9185,"KRN",8989.51,0)
8989.51
"BLD",9185,"KRN",8989.52,0)
8989.52
"BLD",9185,"KRN",8994,0)
8994
"BLD",9185,"KRN","B",.4,.4)

"BLD",9185,"KRN","B",.401,.401)

"BLD",9185,"KRN","B",.402,.402)

"BLD",9185,"KRN","B",.403,.403)

"BLD",9185,"KRN","B",.5,.5)

"BLD",9185,"KRN","B",.84,.84)

"BLD",9185,"KRN","B",3.6,3.6)

"BLD",9185,"KRN","B",3.8,3.8)

"BLD",9185,"KRN","B",9.2,9.2)

"BLD",9185,"KRN","B",9.8,9.8)

"BLD",9185,"KRN","B",19,19)

"BLD",9185,"KRN","B",19.1,19.1)

"BLD",9185,"KRN","B",101,101)

"BLD",9185,"KRN","B",409.61,409.61)

"BLD",9185,"KRN","B",771,771)

"BLD",9185,"KRN","B",779.2,779.2)

"BLD",9185,"KRN","B",870,870)

"BLD",9185,"KRN","B",8989.51,8989.51)

"BLD",9185,"KRN","B",8989.52,8989.52)

"BLD",9185,"KRN","B",8994,8994)

"BLD",9185,"QUES",0)
^9.62^^
"BLD",9185,"REQB",0)
^9.611^1^1
"BLD",9185,"REQB",1,0)
VPR*1.0*4^2
"BLD",9185,"REQB","B","VPR*1.0*4",1)

"INIT")
POST^VPRP5I
"MBREQ")
0
"PKG",571,-1)
1^1
"PKG",571,0)
VIRTUAL PATIENT RECORD^VPR^Utilities to manage a virtual copy of the patient record
"PKG",571,20,0)
^9.402P^^
"PKG",571,22,0)
^9.49I^1^1
"PKG",571,22,1,0)
1.0^3110804^3110901^1
"PKG",571,22,1,"PAH",1,0)
5^3150813
"PKG",571,22,1,"PAH",1,1,0)
^^59^59^3150417
"PKG",571,22,1,"PAH",1,1,1,0)
This patch to the Virtual Patient Record (VPR) package updates the VPR GET 
"PKG",571,22,1,"PAH",1,1,2,0)
PATIENT DATA remote procedure call (RPC) that extracts patient health data 
"PKG",571,22,1,"PAH",1,1,3,0)
from a Veterans Health Information Systems and Technology Architecture 
"PKG",571,22,1,"PAH",1,1,4,0)
(VistA) database in Extensible Markup Language (XML) format, requested by 
"PKG",571,22,1,"PAH",1,1,5,0)
the Joint Legacy Viewer (JLV) and Virtual Lifetime Electronic Record (VLER) 
"PKG",571,22,1,"PAH",1,1,6,0)
projects. Data domains updated are:
"PKG",571,22,1,"PAH",1,1,7,0)
  * Demographics
"PKG",571,22,1,"PAH",1,1,8,0)
  * Functional Independence Measurements (new)
"PKG",571,22,1,"PAH",1,1,9,0)
  * Immunizations
"PKG",571,22,1,"PAH",1,1,10,0)
  * Orders
"PKG",571,22,1,"PAH",1,1,11,0)
  * Problems
"PKG",571,22,1,"PAH",1,1,12,0)
  * Wellness Reminders (new)
"PKG",571,22,1,"PAH",1,1,13,0)
 
"PKG",571,22,1,"PAH",1,1,14,0)
 
"PKG",571,22,1,"PAH",1,1,15,0)
Documentation Retrieval
"PKG",571,22,1,"PAH",1,1,16,0)
-----------------------
"PKG",571,22,1,"PAH",1,1,17,0)
Documentation can be found on the VA Software Documentation Library:
"PKG",571,22,1,"PAH",1,1,18,0)
 http://www4.domain.ext/vdl/
"PKG",571,22,1,"PAH",1,1,19,0)
 
"PKG",571,22,1,"PAH",1,1,20,0)
 
"PKG",571,22,1,"PAH",1,1,21,0)
Patch Installation
"PKG",571,22,1,"PAH",1,1,22,0)
------------------
"PKG",571,22,1,"PAH",1,1,23,0)
This patch may be installed with users on the system although it is 
"PKG",571,22,1,"PAH",1,1,24,0)
recommended that it be installed during non-peak hours to minimize
"PKG",571,22,1,"PAH",1,1,25,0)
potential disruption to users.  This patch should take less than 1 minute 
"PKG",571,22,1,"PAH",1,1,26,0)
to install.
"PKG",571,22,1,"PAH",1,1,27,0)
 
"PKG",571,22,1,"PAH",1,1,28,0)
1.  Choose the PackMan message containing this patch.
"PKG",571,22,1,"PAH",1,1,29,0)
 
"PKG",571,22,1,"PAH",1,1,30,0)
2.  Choose the INSTALL/CHECK MESSAGE PackMan option.  
"PKG",571,22,1,"PAH",1,1,31,0)
 
"PKG",571,22,1,"PAH",1,1,32,0)
3.  From the Kernel Installation and Distribution System Menu, select
"PKG",571,22,1,"PAH",1,1,33,0)
    the Installation Menu.  From this menu, you may elect to use the
"PKG",571,22,1,"PAH",1,1,34,0)
    following options. When prompted for the INSTALL NAME, enter VPR*1.0*5.
"PKG",571,22,1,"PAH",1,1,35,0)
  
"PKG",571,22,1,"PAH",1,1,36,0)
    a.  Backup a Transport Global - This option will create a backup
"PKG",571,22,1,"PAH",1,1,37,0)
        message of any routines exported with this patch. It will not
"PKG",571,22,1,"PAH",1,1,38,0)
        backup any other changes such as DD?s or templates.
"PKG",571,22,1,"PAH",1,1,39,0)
    b.  Compare Transport Global to Current System - This option will
"PKG",571,22,1,"PAH",1,1,40,0)
        allow you to view all changes that will be made when this patch
"PKG",571,22,1,"PAH",1,1,41,0)
        is installed.  It compares all components of this patch
"PKG",571,22,1,"PAH",1,1,42,0)
        (routines, DD?s, templates, etc.).
"PKG",571,22,1,"PAH",1,1,43,0)
    c.  Verify Checksums in Transport Global - This option will allow
"PKG",571,22,1,"PAH",1,1,44,0)
        you to ensure the integrity of the routines that are in the
"PKG",571,22,1,"PAH",1,1,45,0)
        transport global.
"PKG",571,22,1,"PAH",1,1,46,0)
 
"PKG",571,22,1,"PAH",1,1,47,0)
4.  From the Installation Menu, select the Install Package(s) option and
"PKG",571,22,1,"PAH",1,1,48,0)
    choose the patch to install.
"PKG",571,22,1,"PAH",1,1,49,0)
 
"PKG",571,22,1,"PAH",1,1,50,0)
5.  When prompted ?Want KIDS to Rebuild Menu Trees Upon Completion of 
"PKG",571,22,1,"PAH",1,1,51,0)
    Install? NO//? enter NO.
"PKG",571,22,1,"PAH",1,1,52,0)
 
"PKG",571,22,1,"PAH",1,1,53,0)
6.  When prompted ?Want KIDS to INHIBIT LOGONs during the install?
"PKG",571,22,1,"PAH",1,1,54,0)
    NO//? enter NO.
"PKG",571,22,1,"PAH",1,1,55,0)
 
"PKG",571,22,1,"PAH",1,1,56,0)
7.  When prompted 'Want to DISABLE Scheduled Options, Menu Options, 
"PKG",571,22,1,"PAH",1,1,57,0)
    and Protocols? NO//? enter NO.
"PKG",571,22,1,"PAH",1,1,58,0)
 
"PKG",571,22,1,"PAH",1,1,59,0)
8.  If prompted ?Delay Install (Minutes):  (0 ? 60): 0// respond 0.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
27
"RTN","VPRD")
0^1^B43397804^B35636643
"RTN","VPRD",1,0)
VPRD ;SLC/MKB -- Serve VistA data as XML via RPC ;8/2/11  15:29
"RTN","VPRD",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,2,4,5**;Sep 01, 2011;Build 21
"RTN","VPRD",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRD",4,0)
 ;
"RTN","VPRD",5,0)
 ; External References          DBIA#
"RTN","VPRD",6,0)
 ; -------------------          -----
"RTN","VPRD",7,0)
 ; ^DPT                         10035
"RTN","VPRD",8,0)
 ; ^SC                          10040
"RTN","VPRD",9,0)
 ; ^USC(8932.1)                  4984
"RTN","VPRD",10,0)
 ; DIQ                           2056
"RTN","VPRD",11,0)
 ; MPIF001                       2701
"RTN","VPRD",12,0)
 ; VASITE                       10112
"RTN","VPRD",13,0)
 ; XLFDT                        10103
"RTN","VPRD",14,0)
 ; XLFSTR                       10104
"RTN","VPRD",15,0)
 ; XPAR                          2263
"RTN","VPRD",16,0)
 ; XUAF4                         2171
"RTN","VPRD",17,0)
 ; XUSTAX                        4911
"RTN","VPRD",18,0)
 ;
"RTN","VPRD",19,0)
GET(VPR,DFN,TYPE,START,STOP,MAX,ID,FILTER) ; -- Return search results as XML in @VPR@(n)
"RTN","VPRD",20,0)
 ; RPC = VPR GET PATIENT DATA
"RTN","VPRD",21,0)
 N ICN,VPRI,VPRTOTL,VPRTEXT
"RTN","VPRD",22,0)
 S VPR=$NA(^TMP("VPR",$J)) K @VPR
"RTN","VPRD",23,0)
 S VPRTEXT=+$G(FILTER("text")) ;include report/document text?
"RTN","VPRD",24,0)
 ;
"RTN","VPRD",25,0)
 ; parse & validate input parameters
"RTN","VPRD",26,0)
 S ICN=+$P($G(DFN),";",2),DFN=+$G(DFN),ID=$G(ID)
"RTN","VPRD",27,0)
 I DFN<1,ICN S DFN=+$$GETDFN^MPIF001(ICN)
"RTN","VPRD",28,0)
 I DFN<1!'$D(^DPT(DFN)) D ERR(1,DFN) G GTQ
"RTN","VPRD",29,0)
 S TYPE=$$LOW^XLFSTR($G(TYPE)) I TYPE="" S TYPE=$$ALL
"RTN","VPRD",30,0)
 S:'$G(START) START=1410102 S:'$G(STOP) STOP=4141015 S:'$G(MAX) MAX=9999
"RTN","VPRD",31,0)
 I START,STOP,STOP<START N X S X=START,START=STOP,STOP=X  ;switch
"RTN","VPRD",32,0)
 I STOP,$L(STOP,".")<2 S STOP=STOP_".24"
"RTN","VPRD",33,0)
 I ID="",$D(FILTER("id")) S ID=FILTER("id")
"RTN","VPRD",34,0)
 ;
"RTN","VPRD",35,0)
 ; extract data
"RTN","VPRD",36,0)
 N VPRTYPE,VPRP,VPRHDR,VPRTAG,VPRTN
"RTN","VPRD",37,0)
 D ADD("<results version='"_$$GET^XPAR("ALL","VPR VERSION")_"' timeZone='"_$$TZ^XLFDT_"' >")
"RTN","VPRD",38,0)
 S VPRTYPE=TYPE
"RTN","VPRD",39,0)
 F VPRP=1:1:$L(VPRTYPE,";") S VPRTAG=$P(VPRTYPE,";",VPRP) I $L(VPRTAG) D
"RTN","VPRD",40,0)
 . S VPRTN="EN^"_$$RTN(.VPRTAG) Q:'$L($T(@VPRTN))  ;D ERR(2) Q
"RTN","VPRD",41,0)
 . D ADD("<"_VPRTAG) S VPRHDR=VPRI,VPRTOTL=0
"RTN","VPRD",42,0)
 . D @(VPRTN_"(DFN,START,STOP,MAX,ID)")
"RTN","VPRD",43,0)
 . S @VPR@(VPRHDR)=@VPR@(VPRHDR)_" total='"_+$G(VPRTOTL)_"' >" D ADD("</"_VPRTAG_">")
"RTN","VPRD",44,0)
 D ADD("</results>")
"RTN","VPRD",45,0)
 ;
"RTN","VPRD",46,0)
GTQ ; end
"RTN","VPRD",47,0)
 K ^TMP("VPRD",$J)
"RTN","VPRD",48,0)
 Q
"RTN","VPRD",49,0)
 ;
"RTN","VPRD",50,0)
RTN(X) ; -- Return name of VPRDxxxx routine for clinical domain X
"RTN","VPRD",51,0)
 ;  X is also enforced as expected group tag name, if passed by ref
"RTN","VPRD",52,0)
 N Y S Y="VPRD",X=$G(X) I X="" Q Y
"RTN","VPRD",53,0)
 I X["accession"    S Y="VPRDLRA",X="accessions"
"RTN","VPRD",54,0)
 I X["allerg"       S Y="VPRDGMRA",X="reactions"
"RTN","VPRD",55,0)
 I X["appointment"  S Y="VPRDSDAM",X="appointments"
"RTN","VPRD",56,0)
 I X["clinicalproc" S Y="VPRDMC",X="clinicalProcedures"
"RTN","VPRD",57,0)
 I X["consult"      S Y="VPRDGMRC",X="consults"
"RTN","VPRD",58,0)
 I X["demograph"    S Y="VPRDPT",X="demographics"
"RTN","VPRD",59,0)
 I X["document"     S Y="VPRDTIU",X="documents"
"RTN","VPRD",60,0)
 I X["factor"       S Y="VPRDPXHF",X="healthFactors"
"RTN","VPRD",61,0)
 I X["flag"         S Y="VPRDGPF",X="flags"
"RTN","VPRD",62,0)
 I X["function"     S Y="VPRDRMIM",X="functionalMeasurements"
"RTN","VPRD",63,0)
 I X="fim"          S Y="VPRDRMIM",X="functionalMeasurements"
"RTN","VPRD",64,0)
 I X["immunization" S Y="VPRDPXIM",X="immunizations"
"RTN","VPRD",65,0)
 I X["skin"         S Y="VPRDPXSK",X="skinTests"
"RTN","VPRD",66,0)
 I X?1"exam".E      S Y="VPRDPXAM",X="exams"
"RTN","VPRD",67,0)
 I X["educat"       S Y="VPRDPXED",X="educationTopics"
"RTN","VPRD",68,0)
 I X["insur"        S Y="VPRDIB",X="insurancePolicies"
"RTN","VPRD",69,0)
 I X["polic"        S Y="VPRDIB",X="insurancePolicies"
"RTN","VPRD",70,0)
 I X["lab"          S Y="VPRDLR",X="labs"
"RTN","VPRD",71,0)
 I X["panel"        S Y="VPRDLRO",X="panels"
"RTN","VPRD",72,0)
 I X["med"          S Y="VPRDPS",X="meds"
"RTN","VPRD",73,0)
 I X["pharm"        S Y="VPRDPSOR",X="meds"
"RTN","VPRD",74,0)
 I X["observ"       S Y="VPRDMDC",X="observations"
"RTN","VPRD",75,0)
 I X["order"        S Y="VPRDOR",X="orders"
"RTN","VPRD",76,0)
 I X["patient"      S Y="VPRDPT",X="demographics"
"RTN","VPRD",77,0)
 I X["problem"      S Y="VPRDGMPL",X="problems"
"RTN","VPRD",78,0)
 I X?1"procedure".E S Y="VPRDPROC",X="procedures"
"RTN","VPRD",79,0)
 I X["reaction"     S Y="VPRDGMRA",X="reactions"
"RTN","VPRD",80,0)
 I X["reminder"     S Y="VPRDPXRM",X="reminders"
"RTN","VPRD",81,0)
 I X["surg"         S Y="VPRDSR",X="surgeries"
"RTN","VPRD",82,0)
 I X["visit"        S Y="VPRDVSIT",X="visits"
"RTN","VPRD",83,0)
 I X["vital"        S Y="VPRDGMV",X="vitals"
"RTN","VPRD",84,0)
 I X["rad"          S Y="VPRDRA",X="radiologyExams"
"RTN","VPRD",85,0)
 I X["xray"         S Y="VPRDRA",X="radiologyExams"
"RTN","VPRD",86,0)
 Q Y
"RTN","VPRD",87,0)
 ;
"RTN","VPRD",88,0)
TAG(X) ; -- return plural name for group tags
"RTN","VPRD",89,0)
 N Y S:X'?1.L X=$$LOW^XLFSTR(X)
"RTN","VPRD",90,0)
 I $E(X,$L(X))="s" S Y=X
"RTN","VPRD",91,0)
 I $E(X,$L(X))="y" S Y=$E(X,1,$L(X)-1)_"ies"
"RTN","VPRD",92,0)
 E  S Y=X_"s"
"RTN","VPRD",93,0)
 Q Y
"RTN","VPRD",94,0)
 ;
"RTN","VPRD",95,0)
ALL() ; -- return string for all types of data
"RTN","VPRD",96,0)
 Q "demographics;reactions;problems;vitals;labs;meds;immunizations;observations;visits;appointments;documents;procedures;consults;flags;factors;skinTests;exams;education;insurance;reminders"
"RTN","VPRD",97,0)
 ;
"RTN","VPRD",98,0)
ERR(X,VAL) ; -- return error message
"RTN","VPRD",99,0)
 N MSG  S MSG="Error"
"RTN","VPRD",100,0)
 I X=1  S MSG="Patient with DFN '"_$G(VAL)_"' not found"
"RTN","VPRD",101,0)
 I X=2  S MSG="Requested domain type '"_$G(VAL)_"' not recognized"
"RTN","VPRD",102,0)
 I X=99 S MSG="Unknown request"
"RTN","VPRD",103,0)
 ;
"RTN","VPRD",104,0)
 D ADD("<error>")
"RTN","VPRD",105,0)
 D ADD("<message>"_MSG_"</message>")
"RTN","VPRD",106,0)
 D ADD("</error>")
"RTN","VPRD",107,0)
 Q
"RTN","VPRD",108,0)
 ;
"RTN","VPRD",109,0)
ESC(X) ; -- escape outgoing XML
"RTN","VPRD",110,0)
 ; Q $ZCONVERT(X,"O","HTML")  ; uncomment for fastest performance on Cache
"RTN","VPRD",111,0)
 ;
"RTN","VPRD",112,0)
 N I,Y,QOT S QOT=""""
"RTN","VPRD",113,0)
 S Y=$P(X,"&") F I=2:1:$L(X,"&") S Y=Y_"&amp;"_$P(X,"&",I)
"RTN","VPRD",114,0)
 S X=Y,Y=$P(X,"<") F I=2:1:$L(X,"<") S Y=Y_"&lt;"_$P(X,"<",I)
"RTN","VPRD",115,0)
 S X=Y,Y=$P(X,">") F I=2:1:$L(X,">") S Y=Y_"&gt;"_$P(X,">",I)
"RTN","VPRD",116,0)
 S X=Y,Y=$P(X,"'") F I=2:1:$L(X,"'") S Y=Y_"&apos;"_$P(X,"'",I)
"RTN","VPRD",117,0)
 S X=Y,Y=$P(X,QOT) F I=2:1:$L(X,QOT) S Y=Y_"&quot;"_$P(X,QOT,I)
"RTN","VPRD",118,0)
 Q Y
"RTN","VPRD",119,0)
 ;
"RTN","VPRD",120,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRD",121,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRD",122,0)
 S @VPR@(VPRI)=X
"RTN","VPRD",123,0)
 Q
"RTN","VPRD",124,0)
 ;
"RTN","VPRD",125,0)
STRING(ARRAY) ; -- Return text in ARRAY(n) or ARRAY(n,0) as a string
"RTN","VPRD",126,0)
 N I,X,Y S Y=""
"RTN","VPRD",127,0)
 S I=+$O(ARRAY("")) I I=0 S I=+$O(ARRAY(0))
"RTN","VPRD",128,0)
 S Y=$S($D(ARRAY(I,0)):ARRAY(I,0),1:$G(ARRAY(I)))
"RTN","VPRD",129,0)
 F  S I=$O(ARRAY(I)) Q:I<1  D
"RTN","VPRD",130,0)
 . S X=$S($D(ARRAY(I,0)):ARRAY(I,0),1:ARRAY(I))
"RTN","VPRD",131,0)
 . I $E(X)=" " S Y=Y_$C(13,10)_X Q
"RTN","VPRD",132,0)
 . S Y=Y_$S($E(Y,$L(Y))=" ":"",1:" ")_X
"RTN","VPRD",133,0)
 Q Y
"RTN","VPRD",134,0)
 ;
"RTN","VPRD",135,0)
FAC(X) ; -- return Institution file station# for location X
"RTN","VPRD",136,0)
 N HLOC,FAC,Y0,Y S Y=""
"RTN","VPRD",137,0)
 S HLOC=$G(^SC(+$G(X),0)),FAC=$P(HLOC,U,4)
"RTN","VPRD",138,0)
 ; Get P:4 via Med Ctr Div, if not directly linked
"RTN","VPRD",139,0)
 I 'FAC,$P(HLOC,U,15) S FAC=$$GET1^DIQ(44,+$G(X)_",","3.5:.07","I")
"RTN","VPRD",140,0)
 S Y0=$S(FAC:$$NS^XUAF4(FAC),1:$P($$SITE^VASITE,U,2,3)) ;name^stn#
"RTN","VPRD",141,0)
 S:$L(Y0) Y=$P(Y0,U,2)_U_$P(Y0,U) ;switch to stn#^name
"RTN","VPRD",142,0)
 I $L(Y),'Y S $P(Y,U)=FAC
"RTN","VPRD",143,0)
 Q Y
"RTN","VPRD",144,0)
 ;
"RTN","VPRD",145,0)
PROVTAGS() ; -- Return attribute tags for provider info as built below
"RTN","VPRD",146,0)
 Q "officePhone^analogPager^fax^email^taxonomyCode^providerType^classification^specialization^service"
"RTN","VPRD",147,0)
 ;
"RTN","VPRD",148,0)
PROVSPC(NP) ; -- Return contact & specialty info for provider NP
"RTN","VPRD",149,0)
 ; save strings in ^TMP("VPRD",$J,NP) for efficiency
"RTN","VPRD",150,0)
 N X,Y,I,CLS,RES,X13,X15 S NP=+$G(NP) ;protect I for calling routine
"RTN","VPRD",151,0)
 S RES=$G(^TMP("VPRD",$J,NP)) I $L(RES) Q RES
"RTN","VPRD",152,0)
 S X13=$G(^VA(200,NP,.13)),X15=$G(^(.15))
"RTN","VPRD",153,0)
 S RES=$P(X13,U,2)_U_$P(X13,U,7)_U_$P(X13,U,6)_U_$P(X15,U)_U
"RTN","VPRD",154,0)
 S X=$$TAXIND^XUSTAX(NP) I $P(X,U,2) D  ;= X12 code ^ #8932.1 ien
"RTN","VPRD",155,0)
 . S CLS=$G(^USC(8932.1,$P(X,U,2),0)) Q:CLS=""
"RTN","VPRD",156,0)
 . S RES=RES_$P(X,U)_U_$P(CLS,U,1,3) ;X12^type^class^specialization
"RTN","VPRD",157,0)
 S $P(RES,U,9)=$$GET1^DIQ(200,NP_",",29)
"RTN","VPRD",158,0)
 S ^TMP("VPRD",$J,NP)=RES
"RTN","VPRD",159,0)
 Q RES
"RTN","VPRD",160,0)
 ;
"RTN","VPRD",161,0)
VUID(IEN,FILE) ; -- Return VUID for item
"RTN","VPRD",162,0)
 Q $$GET1^DIQ(FILE,IEN_",",99.99)
"RTN","VPRD",163,0)
 ;
"RTN","VPRD",164,0)
VERSION(RET) ; -- Return current version of data extracts
"RTN","VPRD",165,0)
 S RET=$$GET^XPAR("ALL","VPR VERSION")
"RTN","VPRD",166,0)
 Q
"RTN","VPRD",167,0)
 ;
"RTN","VPRD",168,0)
TEST(DFN,TYPE,ID,START,STOP,MAX,TEXT,IN) ; -- test GET, write results to screen
"RTN","VPRD",169,0)
 N OUT,IDX S U="^"
"RTN","VPRD",170,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRD",171,0)
 S TYPE=$G(TYPE) Q:TYPE=""
"RTN","VPRD",172,0)
 D GET(.OUT,DFN,TYPE,$G(START),$G(STOP),$G(MAX),$G(ID),.IN)
"RTN","VPRD",173,0)
 ;
"RTN","VPRD",174,0)
 S IDX=OUT
"RTN","VPRD",175,0)
 F  S IDX=$Q(@IDX) Q:IDX'?1"^TMP(""VPR"","1.N.E  Q:+$P(IDX,",",2)'=$J  W !,@IDX
"RTN","VPRD",176,0)
 Q
"RTN","VPRDGMPL")
0^2^B30131363^B28051660
"RTN","VPRDGMPL",1,0)
VPRDGMPL ;SLC/MKB -- Problem extract ;8/2/11  15:29
"RTN","VPRDGMPL",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,2,4,5**;Sep 01, 2011;Build 21
"RTN","VPRDGMPL",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDGMPL",4,0)
 ;
"RTN","VPRDGMPL",5,0)
 ; External References          DBIA#
"RTN","VPRDGMPL",6,0)
 ; -------------------          -----
"RTN","VPRDGMPL",7,0)
 ; ^AUPNPROB                     5703
"RTN","VPRDGMPL",8,0)
 ; ^DPT                         10035
"RTN","VPRDGMPL",9,0)
 ; ^VA(200                      10060
"RTN","VPRDGMPL",10,0)
 ; ^WV(790.05                    5772
"RTN","VPRDGMPL",11,0)
 ; %DT                          10003
"RTN","VPRDGMPL",12,0)
 ; DIQ                           2056
"RTN","VPRDGMPL",13,0)
 ; GMPLUTL2                      2741
"RTN","VPRDGMPL",14,0)
 ; SDUTL3                        1252
"RTN","VPRDGMPL",15,0)
 ; XLFDT                        10103
"RTN","VPRDGMPL",16,0)
 ; XUAF4                         2171
"RTN","VPRDGMPL",17,0)
 ;
"RTN","VPRDGMPL",18,0)
 ; ------------ Get problems from VistA ------------
"RTN","VPRDGMPL",19,0)
 ;
"RTN","VPRDGMPL",20,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's problems
"RTN","VPRDGMPL",21,0)
 N VPRSTS,VPRPROB,VPRN,VPRITM,VPRCNT,X
"RTN","VPRDGMPL",22,0)
 ;
"RTN","VPRDGMPL",23,0)
 ; get one problem
"RTN","VPRDGMPL",24,0)
 I $G(IFN)="790.05" D WV(.VPRITM,1),XML(.VPRITM):$D(VPRITM) Q
"RTN","VPRDGMPL",25,0)
 I $G(IFN) D EN1(IFN,.VPRITM),XML(.VPRITM) Q
"RTN","VPRDGMPL",26,0)
 ;
"RTN","VPRDGMPL",27,0)
 ; get all patient problems
"RTN","VPRDGMPL",28,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDGMPL",29,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999),VPRCNT=0
"RTN","VPRDGMPL",30,0)
 S VPRSTS=$G(FILTER("status")) ;default = all problems
"RTN","VPRDGMPL",31,0)
 D LIST^GMPLUTL2(.VPRPROB,DFN,VPRSTS)
"RTN","VPRDGMPL",32,0)
 S VPRN=0 F  S VPRN=$O(VPRPROB(VPRN)) Q:(VPRN<1)!(VPRCNT'<MAX)  D
"RTN","VPRDGMPL",33,0)
 . S X=$P(VPRPROB(VPRN),U,5) I X,(X<BEG)!(X>END) Q  ;onset
"RTN","VPRDGMPL",34,0)
 . S X=+VPRPROB(VPRN) K VPRITM ;ien
"RTN","VPRDGMPL",35,0)
 . D EN1(X,.VPRITM),XML(.VPRITM)
"RTN","VPRDGMPL",36,0)
 . S VPRCNT=VPRCNT+1
"RTN","VPRDGMPL",37,0)
 I $P($G(^DPT(DFN,0)),U,2)="F" D WV(.VPRITM),XML(.VPRITM):$D(VPRITM)
"RTN","VPRDGMPL",38,0)
 Q
"RTN","VPRDGMPL",39,0)
 ;
"RTN","VPRDGMPL",40,0)
EN1(ID,PROB) ; -- return a problem in PROB("attribute")=value
"RTN","VPRDGMPL",41,0)
 N VPRL,X,I,J K PROB
"RTN","VPRDGMPL",42,0)
 S ID=+$G(ID) Q:ID<1  ;invalid ien
"RTN","VPRDGMPL",43,0)
 D DETAIL^GMPLUTL2(ID,.VPRL) Q:'$D(VPRL)  ;doesn't exist
"RTN","VPRDGMPL",44,0)
 S PROB("id")=ID,PROB("name")=$G(VPRL("NARRATIVE"))
"RTN","VPRDGMPL",45,0)
 S PROB("icd")=$G(VPRL("DIAGNOSIS")),PROB("codingSystem")=$G(VPRL("CSYS"),"ICD")
"RTN","VPRDGMPL",46,0)
 F I="SCTC","SCTD","SCTT","ICDD" S X=$G(VPRL(I)) S:$L(X) PROB($$LOW^XLFSTR(I))=X
"RTN","VPRDGMPL",47,0)
 S X=$G(VPRL("STATUS")) S:$L(X) PROB("status")=$E(X)_U_X
"RTN","VPRDGMPL",48,0)
 S X=$G(VPRL("HISTORY"))  S:$L(X) PROB("history")=$E(X)_U_X
"RTN","VPRDGMPL",49,0)
 S X=$G(VPRL("PRIORITY")) S:$L(X) PROB("acuity")=$E(X)_U_X
"RTN","VPRDGMPL",50,0)
 ; get internal form of dates via FM instead of DETAIL
"RTN","VPRDGMPL",51,0)
 S X=$$GET1^DIQ(9000011,ID_",",.03,"I") S:X PROB("updated")=X
"RTN","VPRDGMPL",52,0)
 S X=$$GET1^DIQ(9000011,ID_",",.08,"I") S:X PROB("entered")=X
"RTN","VPRDGMPL",53,0)
 S X=$$GET1^DIQ(9000011,ID_",",.13,"I") S:X PROB("onset")=X
"RTN","VPRDGMPL",54,0)
 S X=$$GET1^DIQ(9000011,ID_",",1.07,"I") S:X PROB("resolved")=X
"RTN","VPRDGMPL",55,0)
 S X=$E($G(VPRL("CONDITION")))
"RTN","VPRDGMPL",56,0)
 S:X="P" PROB("unverified")=0,PROB("removed")=0
"RTN","VPRDGMPL",57,0)
 S:X="T" PROB("unverified")=1,PROB("removed")=0
"RTN","VPRDGMPL",58,0)
 S:X="H" PROB("unverified")=0,PROB("removed")=1
"RTN","VPRDGMPL",59,0)
 S X=$G(VPRL("SC")),X=$S(X="YES":1,X="NO":0,1:"")
"RTN","VPRDGMPL",60,0)
 S:$L(X) PROB("sc")=X I $G(VPRL("EXPOSURE")) D   ;ao^rad^pgulf^hnc^mst^cv
"RTN","VPRDGMPL",61,0)
 . S I=0 F  S I=$O(VPRL("EXPOSURE",I)) Q:I<1  D
"RTN","VPRDGMPL",62,0)
 .. S X=$G(VPRL("EXPOSURE",I))
"RTN","VPRDGMPL",63,0)
 .. S PROB("exposure",I)=$$EXP(X)
"RTN","VPRDGMPL",64,0)
 S X=$G(VPRL("PROVIDER")) S:$L(X) PROB("provider")=$$GET1^DIQ(9000011,ID_",",1.05,"I")_U_X
"RTN","VPRDGMPL",65,0)
 S X=$G(VPRL("SERVICE")) S:$L(X) PROB("service")=X
"RTN","VPRDGMPL",66,0)
 S X=$G(VPRL("CLINIC")) S:$L(X) PROB("location")=X
"RTN","VPRDGMPL",67,0)
 S X=+$G(VPRL("FACILITY"))
"RTN","VPRDGMPL",68,0)
 S:X PROB("facility")=$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U)
"RTN","VPRDGMPL",69,0)
 I 'X S PROB("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDGMPL",70,0)
CMT ; comments
"RTN","VPRDGMPL",71,0)
 Q:'$G(VPRL("COMMENT"))
"RTN","VPRDGMPL",72,0)
 S I=0 F  S I=$O(VPRL("COMMENT",I)) Q:I<1  D
"RTN","VPRDGMPL",73,0)
 . S X=$G(VPRL("COMMENT",I))
"RTN","VPRDGMPL",74,0)
 . S PROB("comment",I)=$$DATE($P(X,U))_U_$P(X,U,2,3)
"RTN","VPRDGMPL",75,0)
 . ; = date ^ name of author ^ text
"RTN","VPRDGMPL",76,0)
 Q
"RTN","VPRDGMPL",77,0)
 ;
"RTN","VPRDGMPL",78,0)
WV(PROB,UPD) ; -- return a pregnancy log entry in PROB("attribute")=value
"RTN","VPRDGMPL",79,0)
 N I,X0,Y K PROB
"RTN","VPRDGMPL",80,0)
 S I=$O(^WV(790.05,"C",DFN,""),-1) Q:'I    ;last entry
"RTN","VPRDGMPL",81,0)
 S X0=$G(^WV(790.05,I,0)),Y=0
"RTN","VPRDGMPL",82,0)
 ; status=YES, future due date (allow past 14 days)
"RTN","VPRDGMPL",83,0)
 I $P(X0,U,3),$P(X0,U,4)'<$$FMADD^XLFDT(DT,-14) S Y=1
"RTN","VPRDGMPL",84,0)
 I 'Y,'$G(UPD) Q
"RTN","VPRDGMPL",85,0)
 ; continue if pregnant, or update requested
"RTN","VPRDGMPL",86,0)
 S PROB("id")="790.05",PROB("entered")=+X0
"RTN","VPRDGMPL",87,0)
 S PROB("name")="Pregnancy",PROB("icd")="V22.2"
"RTN","VPRDGMPL",88,0)
 S PROB("icdd")="PREGNANT STATE, INCIDENTAL"
"RTN","VPRDGMPL",89,0)
 S PROB("codingSystem")="ICD"
"RTN","VPRDGMPL",90,0)
 S PROB("sctc")="77386006",PROB("sctt")="Patient currently pregnant (finding)"
"RTN","VPRDGMPL",91,0)
 ; PROB("problemType")=64572001            ;HITSP/Condition
"RTN","VPRDGMPL",92,0)
 S PROB("status")=$S(Y:"A^ACTIVE",1:"I^INACTIVE")
"RTN","VPRDGMPL",93,0)
 S PROB("resolved")=$P(X0,U,4)             ;due date
"RTN","VPRDGMPL",94,0)
 S PROB("provider")=$$OUTPTPR^SDUTL3(DFN)  ;primary care
"RTN","VPRDGMPL",95,0)
 S PROB("facility")=$$FAC^VPRD
"RTN","VPRDGMPL",96,0)
 Q
"RTN","VPRDGMPL",97,0)
 ;
"RTN","VPRDGMPL",98,0)
DATE(X) ; -- Return internal form of date X
"RTN","VPRDGMPL",99,0)
 N %DT,Y
"RTN","VPRDGMPL",100,0)
 S %DT="" D ^%DT S:Y<1 Y=X
"RTN","VPRDGMPL",101,0)
 Q Y
"RTN","VPRDGMPL",102,0)
 ;
"RTN","VPRDGMPL",103,0)
VA200(X) ; -- Return ien of New Person X
"RTN","VPRDGMPL",104,0)
 N Y S Y=$S($L($G(X)):+$O(^VA(200,"B",X,0)),1:"")
"RTN","VPRDGMPL",105,0)
 Q Y
"RTN","VPRDGMPL",106,0)
 ;
"RTN","VPRDGMPL",107,0)
EXP(X) ; -- Return code for exposure name X
"RTN","VPRDGMPL",108,0)
 N Y S Y="",X=$E($G(X))
"RTN","VPRDGMPL",109,0)
 I X="A" S Y="AO"  ;agent orange
"RTN","VPRDGMPL",110,0)
 I X="R" S Y="IR"  ;ionizing radiation
"RTN","VPRDGMPL",111,0)
 I X="E" S Y="PG"  ;persian gulf
"RTN","VPRDGMPL",112,0)
 I X="H" S Y="HNC" ;head/neck cancer
"RTN","VPRDGMPL",113,0)
 I X="M" S Y="MST" ;military sexual trauma
"RTN","VPRDGMPL",114,0)
 I X="C" S Y="CV"  ;combat vet
"RTN","VPRDGMPL",115,0)
 I X="S" S Y="SHAD"
"RTN","VPRDGMPL",116,0)
 Q Y
"RTN","VPRDGMPL",117,0)
 ;
"RTN","VPRDGMPL",118,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDGMPL",119,0)
 ;
"RTN","VPRDGMPL",120,0)
XML(PROB) ; -- Return patient problem as XML in @VPR@(I)
"RTN","VPRDGMPL",121,0)
 N ATT,I,X,Y,P,TAG
"RTN","VPRDGMPL",122,0)
 D ADD("<problem>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDGMPL",123,0)
 S ATT="" F  S ATT=$O(PROB(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDGMPL",124,0)
 . I ATT="exposure" D  S Y="" Q
"RTN","VPRDGMPL",125,0)
 .. S Y="<exposures>" D ADD(Y)
"RTN","VPRDGMPL",126,0)
 .. S I=0 F  S I=$O(PROB(ATT,I)) Q:I<1  S X=$G(PROB(ATT,I)) S:$L(X) Y="<exposure value='"_X_"' />" D ADD(Y)
"RTN","VPRDGMPL",127,0)
 .. D ADD("</exposures>")
"RTN","VPRDGMPL",128,0)
 . I ATT="comment" D  S Y="" Q
"RTN","VPRDGMPL",129,0)
 .. D ADD("<comments>")
"RTN","VPRDGMPL",130,0)
 .. S I=0 F  S I=$O(PROB(ATT,I)) Q:I<1  S X=$G(PROB(ATT,I)) D
"RTN","VPRDGMPL",131,0)
 ... S Y="<comment id='"_I
"RTN","VPRDGMPL",132,0)
 ... S:$L($P(X,U,1)) Y=Y_"' entered='"_$P(X,U)
"RTN","VPRDGMPL",133,0)
 ... S:$L($P(X,U,2)) Y=Y_"' enteredBy='"_$$ESC^VPRD($P(X,U,2))
"RTN","VPRDGMPL",134,0)
 ... S:$L($P(X,U,3)) Y=Y_"' commentText='"_$$ESC^VPRD($P(X,U,3))
"RTN","VPRDGMPL",135,0)
 ... S Y=Y_"' />" D ADD(Y)
"RTN","VPRDGMPL",136,0)
 .. D ADD("</comments>")
"RTN","VPRDGMPL",137,0)
 . S X=$G(PROB(ATT)),Y="" Q:'$L(X)
"RTN","VPRDGMPL",138,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDGMPL",139,0)
 . I $L(X)>1 D  S Y=""
"RTN","VPRDGMPL",140,0)
 .. S Y="<"_ATT_" "
"RTN","VPRDGMPL",141,0)
 .. F P=1:1 S TAG=$P("code^name^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMPL",142,0)
 .. S Y=Y_"/>" D ADD(Y)
"RTN","VPRDGMPL",143,0)
 D ADD("</problem>")
"RTN","VPRDGMPL",144,0)
 Q
"RTN","VPRDGMPL",145,0)
 ;
"RTN","VPRDGMPL",146,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDGMPL",147,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDGMPL",148,0)
 S @VPR@(VPRI)=X
"RTN","VPRDGMPL",149,0)
 Q
"RTN","VPRDGMRC")
0^12^B10985584^B12856313
"RTN","VPRDGMRC",1,0)
VPRDGMRC ;SLC/MKB -- Consult extract ;8/2/11  15:29
"RTN","VPRDGMRC",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,4,5**;Sep 01, 2011;Build 21
"RTN","VPRDGMRC",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDGMRC",4,0)
 ;
"RTN","VPRDGMRC",5,0)
 ; External References          DBIA#
"RTN","VPRDGMRC",6,0)
 ; -------------------          -----
"RTN","VPRDGMRC",7,0)
 ; DIQ                           2056
"RTN","VPRDGMRC",8,0)
 ; GMRCGUIB                      2980
"RTN","VPRDGMRC",9,0)
 ; GMRCSLM1,^TMP("GMRCR",$J)     2740
"RTN","VPRDGMRC",10,0)
 ; XUAF4                         2171
"RTN","VPRDGMRC",11,0)
 ;
"RTN","VPRDGMRC",12,0)
 ; ------------ Get consults from VistA ------------
"RTN","VPRDGMRC",13,0)
 ;
"RTN","VPRDGMRC",14,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's consults
"RTN","VPRDGMRC",15,0)
 N VPRN,VPRX,VPRITM K ^TMP("GMRCR",$J,"CS")
"RTN","VPRDGMRC",16,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDGMRC",17,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDGMRC",18,0)
 ;
"RTN","VPRDGMRC",19,0)
 D OER^GMRCSLM1(DFN,"",BEG,END,"")
"RTN","VPRDGMRC",20,0)
 S VPRN=0 F  S VPRN=$O(^TMP("GMRCR",$J,"CS",VPRN)) Q:VPRN<1!(VPRN>MAX)  S VPRX=$G(^(VPRN,0)) Q:$E(VPRX)="<"  D
"RTN","VPRDGMRC",21,0)
 . I $G(IFN),IFN'=+VPRX Q
"RTN","VPRDGMRC",22,0)
 . K VPRITM D EN1(+VPRX,.VPRITM),XML(.VPRITM)
"RTN","VPRDGMRC",23,0)
 K ^TMP("GMRCR",$J,"CS"),^TMP("VPRTEXT",$J)
"RTN","VPRDGMRC",24,0)
 Q
"RTN","VPRDGMRC",25,0)
 ;
"RTN","VPRDGMRC",26,0)
EN1(ID,CONS) ; -- return a consult in CONS("attribute")=value
"RTN","VPRDGMRC",27,0)
 ;     Expects DFN, VPRX=^TMP("GMRCR",$J,"CS",VPRN,0) [from EN]
"RTN","VPRDGMRC",28,0)
 N VPRD,X0,VPRJ,X,VPRTIU
"RTN","VPRDGMRC",29,0)
 K CONS,^TMP("VPRTEXT",$J)
"RTN","VPRDGMRC",30,0)
 S CONS("id")=ID,CONS("requested")=$P(VPRX,U,2)
"RTN","VPRDGMRC",31,0)
 S CONS("status")=$P(VPRX,U,3),CONS("service")=$P(VPRX,U,4)
"RTN","VPRDGMRC",32,0)
 S CONS("procedure")=$P(VPRX,U,5),CONS("name")=$P(VPRX,U,7)
"RTN","VPRDGMRC",33,0)
 I $P(VPRX,U,6)="*" S CONS("result")="SIGNIFICANT FINDINGS"
"RTN","VPRDGMRC",34,0)
 S CONS("orderID")=$P(VPRX,U,8),CONS("type")=$P(VPRX,U,9)
"RTN","VPRDGMRC",35,0)
 D DOCLIST^GMRCGUIB(.VPRD,ID) S X0=$G(VPRD(0)) ;=^GMR(123,ID,0)
"RTN","VPRDGMRC",36,0)
 S X=$P(X0,U,14) S:X CONS("provider")=X_U_$P($G(^VA(200,X,0)),U)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDGMRC",37,0)
 S VPRJ=0 F  S VPRJ=$O(VPRD(50,VPRJ)) Q:VPRJ<1  S X=$G(VPRD(50,VPRJ)) D
"RTN","VPRDGMRC",38,0)
 . N Y S Y=$$INFO^VPRDTIU(+X) Q:Y<1  ;draft or retracted
"RTN","VPRDGMRC",39,0)
 . S CONS("document",VPRJ)=Y
"RTN","VPRDGMRC",40,0)
 . S:$G(VPRTEXT) CONS("document",VPRJ,"content")=$$TEXT^VPRDTIU(X)
"RTN","VPRDGMRC",41,0)
 S X=$P(X0,U,21),CONS("facility")=$S(X:$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U),1:$$FAC^VPRD)
"RTN","VPRDGMRC",42,0)
 Q
"RTN","VPRDGMRC",43,0)
 ;
"RTN","VPRDGMRC",44,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDGMRC",45,0)
 ;
"RTN","VPRDGMRC",46,0)
XML(CONS) ; -- Return patient consult as XML
"RTN","VPRDGMRC",47,0)
 ;  as <element code='123' displayName='ABC' />
"RTN","VPRDGMRC",48,0)
 N ATT,X,Y,I,J,NAMES
"RTN","VPRDGMRC",49,0)
 D ADD("<consult>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDGMRC",50,0)
 S ATT="" F  S ATT=$O(CONS(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDGMRC",51,0)
 . S NAMES=$S(ATT="document":"id^localTitle^nationalTitle^vuid",ATT="provider":"code^name^"_$$PROVTAGS^VPRD,1:"code^name")_"^Z"
"RTN","VPRDGMRC",52,0)
 . I $O(CONS(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDGMRC",53,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDGMRC",54,0)
 .. S I=0 F  S I=$O(CONS(ATT,I)) Q:I<1  D
"RTN","VPRDGMRC",55,0)
 ... S X=$G(CONS(ATT,I)),Y="<"_ATT_" "_$$LOOP
"RTN","VPRDGMRC",56,0)
 ... S X=$G(CONS(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDGMRC",57,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDGMRC",58,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDGMRC",59,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDGMRC",60,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDGMRC",61,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDGMRC",62,0)
 . S X=$G(CONS(ATT)),Y="" Q:'$L(X)
"RTN","VPRDGMRC",63,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDGMRC",64,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDGMRC",65,0)
 D ADD("</consult>")
"RTN","VPRDGMRC",66,0)
 Q
"RTN","VPRDGMRC",67,0)
 ;
"RTN","VPRDGMRC",68,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDGMRC",69,0)
 N STR,P,TAG S STR=""
"RTN","VPRDGMRC",70,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMRC",71,0)
 Q STR
"RTN","VPRDGMRC",72,0)
 ;
"RTN","VPRDGMRC",73,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDGMRC",74,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDGMRC",75,0)
 S @VPR@(VPRI)=X
"RTN","VPRDGMRC",76,0)
 Q
"RTN","VPRDIB")
0^3^B13733802^B12692505
"RTN","VPRDIB",1,0)
VPRDIB ;SLC/MKB -- Integrated Billing (insurance) ;3/14/12  09:01
"RTN","VPRDIB",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,5**;Sep 01,2011;Build 21
"RTN","VPRDIB",3,0)
 ;
"RTN","VPRDIB",4,0)
 ; External References          DBIA#
"RTN","VPRDIB",5,0)
 ; -------------------          -----
"RTN","VPRDIB",6,0)
 ;   IBBAPI                      4419
"RTN","VPRDIB",7,0)
 ;
"RTN","VPRDIB",8,0)
 ;
"RTN","VPRDIB",9,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDIB",10,0)
 ;
"RTN","VPRDIB",11,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's insurance data
"RTN","VPRDIB",12,0)
 ; [END,ID not currently used]
"RTN","VPRDIB",13,0)
 N X,I,VPRX,VPRITM,VPRCNT,VPRINS,VPRDT,VPRSTS
"RTN","VPRDIB",14,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDIB",15,0)
 S MAX=$G(MAX,9999),VPRDT=DT
"RTN","VPRDIB",16,0)
 ; $G(BEG),BEG>2000000 S VPRDT=BEG
"RTN","VPRDIB",17,0)
 S VPRSTS=$G(FILTER("status"),"RB")
"RTN","VPRDIB",18,0)
 I VPRSTS["A" S VPRDT="" ;no date if requesting inactive policies
"RTN","VPRDIB",19,0)
 ;
"RTN","VPRDIB",20,0)
 ; get one policy
"RTN","VPRDIB",21,0)
 ;I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) Q
"RTN","VPRDIB",22,0)
 ;
"RTN","VPRDIB",23,0)
 ; get all policies
"RTN","VPRDIB",24,0)
 S X=$$INSUR^IBBAPI(DFN,VPRDT,VPRSTS,.VPRX,"*") Q:X<1
"RTN","VPRDIB",25,0)
 S (I,VPRCNT)=0 F  S I=$O(VPRX("IBBAPI","INSUR",I)) Q:I<1  D  Q:VPRCNT'<MAX
"RTN","VPRDIB",26,0)
 . M VPRINS=VPRX("IBBAPI","INSUR",I) K VPRITM
"RTN","VPRDIB",27,0)
 . I $G(ID),DFN'=+ID!(+VPRINS(1)'=$P(ID,";",2))!(+VPRINS(8)'=$P(ID,";",3)) Q
"RTN","VPRDIB",28,0)
 . S VPRITM("id")=DFN_";"_+VPRINS(1)_";"_+VPRINS(8) ; = DFN;COMPANY;POLICY
"RTN","VPRDIB",29,0)
 . S VPRITM("company")=VPRINS(1),X=VPRINS(2)
"RTN","VPRDIB",30,0)
 . F J=23,24,3,4,5 S X=X_U_VPRINS(J)
"RTN","VPRDIB",31,0)
 . S VPRITM("company","address")=X
"RTN","VPRDIB",32,0)
 . S X=VPRINS(6) S:$L(X) VPRITM("company","telecom")=$$FORMAT(X)
"RTN","VPRDIB",33,0)
 . S VPRITM("effectiveDate")=VPRINS(10)
"RTN","VPRDIB",34,0)
 . S VPRITM("expirationDate")=VPRINS(11)
"RTN","VPRDIB",35,0)
 . S VPRITM("groupName")=$P(VPRINS(8),U,2)
"RTN","VPRDIB",36,0)
 . S VPRITM("groupNumber")=VPRINS(18)
"RTN","VPRDIB",37,0)
 . S X=VPRINS(21),VPRITM("insuranceType")=X
"RTN","VPRDIB",38,0)
 . ; VPRITM("insuranceType")=$$GET^XPAR(355.1,+X_",",.03) ;Maj Catg
"RTN","VPRDIB",39,0)
 . S VPRITM("relationship")=$P(VPRINS(19),U,2)
"RTN","VPRDIB",40,0)
 . S VPRITM("subscriber")=VPRINS(14)_U_VPRINS(13)
"RTN","VPRDIB",41,0)
 . ; VPRITM("subscriber","address")
"RTN","VPRDIB",42,0)
 . ; VPRITM("subscriber","telecom")
"RTN","VPRDIB",43,0)
 . ; VPRITM("memberID")
"RTN","VPRDIB",44,0)
 . S VPRITM("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDIB",45,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDIB",46,0)
 Q
"RTN","VPRDIB",47,0)
 ;
"RTN","VPRDIB",48,0)
FORMAT(X) ; -- enforce (xxx)xxx-xxxx phone format
"RTN","VPRDIB",49,0)
 S X=$G(X) I X?1"("3N1")"3N1"-"4N.E Q X
"RTN","VPRDIB",50,0)
 N P,N,I,Y S P=""
"RTN","VPRDIB",51,0)
 F I=1:1:$L(X) S N=$E(X,I) I N=+N S P=P_N
"RTN","VPRDIB",52,0)
 S:$L(P)<10 P=$E("0000000000",1,10-$L(P))_P
"RTN","VPRDIB",53,0)
 S Y=$S(P:"("_$E(P,1,3)_")"_$E(P,4,6)_"-"_$E(P,7,10),1:"")
"RTN","VPRDIB",54,0)
 Q Y
"RTN","VPRDIB",55,0)
 ;
"RTN","VPRDIB",56,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDIB",57,0)
 ;
"RTN","VPRDIB",58,0)
XML(ITEM) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDIB",59,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDIB",60,0)
 N ATT,X,Y,I,SUB
"RTN","VPRDIB",61,0)
 D ADD("<insurancePolicy>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDIB",62,0)
 S ATT="" F  S ATT=$O(ITEM(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDIB",63,0)
 . S X=$G(ITEM(ATT)),Y="" Q:'$L(X)
"RTN","VPRDIB",64,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)
"RTN","VPRDIB",65,0)
 . I $L(X,"^")>1 S Y="<"_ATT_" code='"_$P(X,U)_"' name='"_$$ESC^VPRD($P(X,U,2))
"RTN","VPRDIB",66,0)
 . S SUB=$O(ITEM(ATT,"")) I SUB="" S Y=Y_"' />" Q
"RTN","VPRDIB",67,0)
 . S Y=Y_"' >" D ADD(Y) S X=$G(ITEM(ATT,SUB))
"RTN","VPRDIB",68,0)
 . I SUB="address" D ADDR(X)
"RTN","VPRDIB",69,0)
 . I SUB="telecom" D PHONE(X)
"RTN","VPRDIB",70,0)
 . S Y="</"_ATT_">"
"RTN","VPRDIB",71,0)
 D ADD("</insurancePolicy>")
"RTN","VPRDIB",72,0)
 Q
"RTN","VPRDIB",73,0)
 ;
"RTN","VPRDIB",74,0)
ADDR(X) ; -- XML address node from X=street1^st2^st3^city^state^zip
"RTN","VPRDIB",75,0)
 N I,Y Q:$L(X)'>5  ;no data
"RTN","VPRDIB",76,0)
 S Y="<address"
"RTN","VPRDIB",77,0)
 F I=1,2,3 I $L($P(X,U,I)) S Y=Y_" streetLine"_I_"='"_$$ESC^VPRD($P(X,U,I))_"'"
"RTN","VPRDIB",78,0)
 I $L($P(X,U,4)) S Y=Y_" city='"_$$ESC^VPRD($P(X,U,4))_"'"
"RTN","VPRDIB",79,0)
 I $L($P(X,U,5)) S Y=Y_" stateProvince='"_$P(X,U,5)_"'"
"RTN","VPRDIB",80,0)
 I $L($P(X,U,6)) S Y=Y_" postalCode='"_$P(X,U,6)_"'"
"RTN","VPRDIB",81,0)
 S Y=Y_" />" D ADD(Y)
"RTN","VPRDIB",82,0)
 Q
"RTN","VPRDIB",83,0)
 ;
"RTN","VPRDIB",84,0)
PHONE(X) ; -- XML telecom node from X=home^cell^work numbers
"RTN","VPRDIB",85,0)
 N I,Y Q:$L(X)'>2  ;no data
"RTN","VPRDIB",86,0)
 D ADD("<telecomList>")
"RTN","VPRDIB",87,0)
 I $L($P(X,U,1)) S Y="<telecom usageType='H' value='"_$P(X,U,1)_"' />" D ADD(Y)
"RTN","VPRDIB",88,0)
 I $L($P(X,U,2)) S Y="<telecom usageType='MC' value='"_$P(X,U,2)_"' />" D ADD(Y)
"RTN","VPRDIB",89,0)
 I $L($P(X,U,3)) S Y="<telecom usageType='WP' value='"_$P(X,U,3)_"' />" D ADD(Y)
"RTN","VPRDIB",90,0)
 D ADD("</telecomList>")
"RTN","VPRDIB",91,0)
 Q
"RTN","VPRDIB",92,0)
 ;
"RTN","VPRDIB",93,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDIB",94,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDIB",95,0)
 S @VPR@(VPRI)=X
"RTN","VPRDIB",96,0)
 Q
"RTN","VPRDJ0")
0^22^B83117538^B87481337
"RTN","VPRDJ0",1,0)
VPRDJ0 ;SLC/MKB -- Serve VistA data as JSON cont ;6/25/12  16:11
"RTN","VPRDJ0",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**2,5**;Sep 01, 2011;Build 21
"RTN","VPRDJ0",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDJ0",4,0)
 ;
"RTN","VPRDJ0",5,0)
 ; External References          DBIA#
"RTN","VPRDJ0",6,0)
 ; -------------------          -----
"RTN","VPRDJ0",7,0)
 ; ^DPT                         10035  <see VPRDJ0* for others>
"RTN","VPRDJ0",8,0)
 ;
"RTN","VPRDJ0",9,0)
 ; All tags expect DFN, VPRSTART, VPRSTOP, VPRMAX, VPRID, VPRTEXT
"RTN","VPRDJ0",10,0)
 ;
"RTN","VPRDJ0",11,0)
PATIENT ; -- Patient Registration
"RTN","VPRDJ0",12,0)
 D DPT1^VPRDJ00
"RTN","VPRDJ0",13,0)
 Q
"RTN","VPRDJ0",14,0)
 ;
"RTN","VPRDJ0",15,0)
PROBLEM ; -- Problem List
"RTN","VPRDJ0",16,0)
 I $G(VPRID) D GMPL1^VPRDJ02(VPRID) Q
"RTN","VPRDJ0",17,0)
 N ID,VPRSTS,VPRPROB,VPRN,X
"RTN","VPRDJ0",18,0)
 S VPRSTS=$G(FILTER("status")) ;default = all problems
"RTN","VPRDJ0",19,0)
 D LIST^GMPLUTL2(.VPRPROB,DFN,VPRSTS)
"RTN","VPRDJ0",20,0)
 S VPRN=0 F  S VPRN=$O(VPRPROB(VPRN)) Q:(VPRN<1)!(VPRI'<VPRMAX)  D
"RTN","VPRDJ0",21,0)
 . S X=$P(VPRPROB(VPRN),U,6) I X,(X<VPRSTART)!(X>VPRSTOP) Q  ;last updated
"RTN","VPRDJ0",22,0)
 . S ID=+VPRPROB(VPRN) D GMPL1^VPRDJ02(ID)
"RTN","VPRDJ0",23,0)
 Q
"RTN","VPRDJ0",24,0)
 ;
"RTN","VPRDJ0",25,0)
ALLERGY ; -- Allergies/Adverse Reactions
"RTN","VPRDJ0",26,0)
 N GMRAL,ID D EN1^GMRADPT
"RTN","VPRDJ0",27,0)
 I 'GMRAL Q  ;D NKA^VPRDJ02 Q
"RTN","VPRDJ0",28,0)
 I $G(VPRID) D GMRA1^VPRDJ02(VPRID) Q
"RTN","VPRDJ0",29,0)
 S ID=0 F  S ID=+$O(GMRAL(ID)) Q:ID<1  D GMRA1^VPRDJ02(ID) Q:VPRI'<VPRMAX
"RTN","VPRDJ0",30,0)
 Q
"RTN","VPRDJ0",31,0)
 ;
"RTN","VPRDJ0",32,0)
CONSULT ; -- Consult/Request Tracking
"RTN","VPRDJ0",33,0)
 N VPRN,VPRX,ID
"RTN","VPRDJ0",34,0)
 D OER^GMRCSLM1(DFN,"",VPRSTART,VPRSTOP,"")
"RTN","VPRDJ0",35,0)
 S VPRN=0 F  S VPRN=$O(^TMP("GMRCR",$J,"CS",VPRN)) Q:VPRN<1!(VPRN>VPRMAX)  S VPRX=$G(^(VPRN,0)) Q:$E(VPRX)="<"  D
"RTN","VPRDJ0",36,0)
 . I $G(VPRID),VPRID'=+VPRX Q
"RTN","VPRDJ0",37,0)
 . D GMRC1^VPRDJ03(+VPRX)
"RTN","VPRDJ0",38,0)
 K ^TMP("GMRCR",$J,"CS")
"RTN","VPRDJ0",39,0)
 Q
"RTN","VPRDJ0",40,0)
 ;
"RTN","VPRDJ0",41,0)
VITAL ; -- GMR Vital Measurements
"RTN","VPRDJ0",42,0)
 I $L($G(VPRID)) D GMV1^VPRDJ02(VPRID) Q
"RTN","VPRDJ0",43,0)
 N GMRVSTR,VPRIDT,VPRTYP,ID
"RTN","VPRDJ0",44,0)
 S GMRVSTR="BP;T;R;P;HT;WT;CVP;CG;PO2;PN"
"RTN","VPRDJ0",45,0)
 S GMRVSTR(0)=VPRSTART_U_VPRSTOP_U_VPRMAX_"^1"
"RTN","VPRDJ0",46,0)
 D EN1^GMRVUT0
"RTN","VPRDJ0",47,0)
 S VPRIDT=0 F  S VPRIDT=$O(^UTILITY($J,"GMRVD",VPRIDT)) Q:VPRIDT<1  D  Q:VPRI'<VPRMAX
"RTN","VPRDJ0",48,0)
 . S VPRTYP="" F  S VPRTYP=$O(^UTILITY($J,"GMRVD",VPRIDT,VPRTYP)) Q:VPRTYP=""  D
"RTN","VPRDJ0",49,0)
 .. S ID=$O(^UTILITY($J,"GMRVD",VPRIDT,VPRTYP,0)) D GMV1^VPRDJ02(ID)
"RTN","VPRDJ0",50,0)
 K ^UTILITY($J,"GMRVD")
"RTN","VPRDJ0",51,0)
 Q
"RTN","VPRDJ0",52,0)
 ;
"RTN","VPRDJ0",53,0)
LAB ; -- Lab Results
"RTN","VPRDJ0",54,0)
 N LRDFN,VPRSUB,VPRIDT,VPRN,VPRP,VPRACC,BEG,END,SUB,ORPK,ID,X
"RTN","VPRDJ0",55,0)
 S LRDFN=$G(^DPT(DFN,"LR")),VPRSUB=$G(FILTER("category"))
"RTN","VPRDJ0",56,0)
 S BEG=VPRSTART,END=VPRSTOP,VPRID=$G(VPRID),ORPK=""
"RTN","VPRDJ0",57,0)
 I $L(VPRID) D  ;reset for LR7OR1
"RTN","VPRDJ0",58,0)
 . I VPRID S ORPK=VPRID,VPRID=$P(VPRID,";",4,99) Q:VPRID=""  ;order
"RTN","VPRDJ0",59,0)
 . S VPRSUB=$P(VPRID,";"),VPRIDT=+$P(VPRID,";",2)
"RTN","VPRDJ0",60,0)
 . S:VPRIDT (BEG,END)=9999999-VPRIDT
"RTN","VPRDJ0",61,0)
 S SUB=VPRSUB I $L(SUB),"CH^MI"'[SUB S SUB="AP"
"RTN","VPRDJ0",62,0)
 D RR^LR7OR1(DFN,ORPK,BEG,END,SUB,,,VPRMAX)
"RTN","VPRDJ0",63,0)
 S VPRSUB="" F  S VPRSUB=$O(^TMP("LRRR",$J,DFN,VPRSUB)) Q:VPRSUB=""  D
"RTN","VPRDJ0",64,0)
 . S VPRIDT=0 F  S VPRIDT=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT)) Q:VPRIDT<1  I $O(^(VPRIDT,0)) D  Q:VPRI'<VPRMAX
"RTN","VPRDJ0",65,0)
 .. I VPRSUB="MI"  S ID=VPRSUB_";"_VPRIDT D MI^VPRDJ06 Q
"RTN","VPRDJ0",66,0)
 .. I VPRSUB'="CH" S ID=VPRSUB_";"_VPRIDT D AP^VPRDJ06 Q
"RTN","VPRDJ0",67,0)
 .. D ACC^VPRDJ06 ;get chem accession data
"RTN","VPRDJ0",68,0)
 .. S VPRP=0 F  S VPRP=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT,VPRP)) Q:VPRP<1  S X=+$G(^(VPRP)) D
"RTN","VPRDJ0",69,0)
 ... S VPRN=$$LRDN^LRPXAPIU(X) I $L(VPRID,";")>2,VPRN'=$P(VPRID,";",3) Q
"RTN","VPRDJ0",70,0)
 ... S ID=VPRSUB_";"_VPRIDT_";"_VPRN D CH1^VPRDJ06
"RTN","VPRDJ0",71,0)
 K ^TMP("LRRR",$J),^TMP("LRX",$J)
"RTN","VPRDJ0",72,0)
 Q
"RTN","VPRDJ0",73,0)
 ;
"RTN","VPRDJ0",74,0)
PROCEDUR ; -- Clinical Procedures
"RTN","VPRDJ0",75,0)
 N VPRN,VPRX,BEG,END,ID
"RTN","VPRDJ0",76,0)
 S BEG=VPRSTART,END=VPRSTOP
"RTN","VPRDJ0",77,0)
 I $G(VPRID) D  ;reset dates for VPRID only
"RTN","VPRDJ0",78,0)
 . N VPRMC,IEN,FILE,X
"RTN","VPRDJ0",79,0)
 . S IEN=+VPRID,FILE=+$P(VPRID,"(",2)  Q:FILE=702  Q:'FILE
"RTN","VPRDJ0",80,0)
 . D MEDLKUP^MCARUTL3(.VPRMC,FILE,IEN)
"RTN","VPRDJ0",81,0)
 . S X=$P(VPRMC,U,6) S:X (BEG,END)=X
"RTN","VPRDJ0",82,0)
 D MDPS1^VPRDJ03(DFN,BEG,END,VPRMAX)    ;gets ^TMP("MDHSP",$J)
"RTN","VPRDJ0",83,0)
 S VPRN=0 F  S VPRN=$O(^TMP("MDHSP",$J,VPRN)) Q:VPRN<1  S VPRX=$G(^(VPRN)) D
"RTN","VPRDJ0",84,0)
 . I $G(VPRID),+VPRID'=+$P(VPRX,U,2) Q  ;update 1 procedure
"RTN","VPRDJ0",85,0)
 . D MC1^VPRDJ03($G(VPRID))             ;uses VPRX
"RTN","VPRDJ0",86,0)
 K ^TMP("MDHSP",$J)
"RTN","VPRDJ0",87,0)
 Q
"RTN","VPRDJ0",88,0)
 ;
"RTN","VPRDJ0",89,0)
OBS ; -- Clinical Observations (CLiO)
"RTN","VPRDJ0",90,0)
 N VPRCLIO,VPRN,ID,X
"RTN","VPRDJ0",91,0)
 I $L($G(VPRID)) D MDC1^VPRDJ03(VPRID) Q
"RTN","VPRDJ0",92,0)
 D QRYPT^VPRDMDC("VPRCLIO",DFN,VPRSTART,VPRSTOP) ;all [verified] observations
"RTN","VPRDJ0",93,0)
 S VPRN=0 F  S VPRN=$O(VPRCLIO(VPRN)) Q:(VPRN<1)!(VPRI'<VPRMAX)  D
"RTN","VPRDJ0",94,0)
 . S ID=$G(VPRCLIO(VPRN)) ;GUID
"RTN","VPRDJ0",95,0)
 . D MDC1^VPRDJ03(ID)
"RTN","VPRDJ0",96,0)
 Q
"RTN","VPRDJ0",97,0)
 ;
"RTN","VPRDJ0",98,0)
ORDER ; -- Order Entry
"RTN","VPRDJ0",99,0)
 N ORLIST,VPRN,DAD,ID,X,X3,X4
"RTN","VPRDJ0",100,0)
 I $G(VPRID) S ORLIST=$H D OR1^VPRDJ01(VPRID) G ORQ
"RTN","VPRDJ0",101,0)
 D EN^ORQ1(DFN_";DPT(",,6,,VPRSTART,VPRSTOP,,,,1)
"RTN","VPRDJ0",102,0)
 S VPRN=0 F  S VPRN=$O(^TMP("ORR",$J,ORLIST,VPRN)) Q:VPRN<1  S ID=$G(^(VPRN)) D  Q:VPRI'<VPRMAX
"RTN","VPRDJ0",103,0)
 . Q:$D(^TMP("ORGOTIT",$J,+ID))  Q:$P(ID,";",2)>1  S ID=+ID    ;actions
"RTN","VPRDJ0",104,0)
 . S X3=$G(^OR(100,ID,3)),X4=$G(^(4))
"RTN","VPRDJ0",105,0)
 . Q:$P(X3,U,3)=13  I X4["P",$P(X3,U,3)=1!($P(X3,U,3)=12) Q  ;cancelled
"RTN","VPRDJ0",106,0)
 . S DAD=+$P(X3,U,9) I DAD D:'$D(^TMP("ORGOTIT",$J,DAD)) OR1^VPRDJ01(DAD) Q
"RTN","VPRDJ0",107,0)
 . D OR1^VPRDJ01(ID)
"RTN","VPRDJ0",108,0)
ORQ ; end
"RTN","VPRDJ0",109,0)
 K ^TMP("ORR",$J),^TMP("ORGOTIT",$J)
"RTN","VPRDJ0",110,0)
 Q
"RTN","VPRDJ0",111,0)
 ;
"RTN","VPRDJ0",112,0)
TREATMEN ; -- Nursing Treatments (orders)
"RTN","VPRDJ0",113,0)
 N ORLIST,ORDG,VPRN,ID,X,X3,X4
"RTN","VPRDJ0",114,0)
 I $G(VPRID) S ORLIST=$H D NTX1^VPRDJ01(VPRID) G TXQ
"RTN","VPRDJ0",115,0)
 S ORDG=+$O(^ORD(100.98,"B","NTX",0))
"RTN","VPRDJ0",116,0)
 D EN^ORQ1(DFN_";DPT(",ORDG,6,,VPRSTART,VPRSTOP,,,,1)
"RTN","VPRDJ0",117,0)
 S VPRN=0 F  S VPRN=$O(^TMP("ORR",$J,ORLIST,VPRN)) Q:VPRN<1  S ID=$G(^(VPRN)) D  Q:VPRI'<VPRMAX
"RTN","VPRDJ0",118,0)
 . Q:$D(^TMP("ORGOTIT",$J,+ID))  Q:$P(ID,";",2)>1  S ID=+ID  ;actions
"RTN","VPRDJ0",119,0)
 . S X3=$G(^OR(100,ID,3)),X4=$G(^(4))
"RTN","VPRDJ0",120,0)
 . Q:$P(X3,U,3)=13  I X4["P",$P(X3,U,3)=1!($P(X3,U,3)=12) Q  ;cancelled
"RTN","VPRDJ0",121,0)
 . D NTX1^VPRDJ01(ID)
"RTN","VPRDJ0",122,0)
TXQ ; end
"RTN","VPRDJ0",123,0)
 K ^TMP("ORR",$J),^TMP("ORGOTIT",$J)
"RTN","VPRDJ0",124,0)
 Q
"RTN","VPRDJ0",125,0)
 ;
"RTN","VPRDJ0",126,0)
MED ; -- Pharmacy
"RTN","VPRDJ0",127,0)
 N ORDIALOG I $G(VPRID),$D(^OR(100,+VPRID)) D PS1^VPRDJ05(VPRID) Q       ;get 1 order
"RTN","VPRDJ0",128,0)
 N TYPE,ORDG,ORVP,ORLIST,VPRN,ORLIST,X3,X4,DAD,ID
"RTN","VPRDJ0",129,0)
 S TYPE=$G(FILTER("vaType")) S:$L(TYPE) TYPE=$S(TYPE="N":"NV",TYPE="V":"IV",1:TYPE)_" "
"RTN","VPRDJ0",130,0)
 S ORDG=+$O(^ORD(100.98,"B",TYPE_"RX",0)),ORVP=DFN_";DPT("
"RTN","VPRDJ0",131,0)
 D EN^ORQ1(ORVP,ORDG,6,,VPRSTART,VPRSTOP)
"RTN","VPRDJ0",132,0)
 K ^TMP("VPROR",$J) S VPRN=0
"RTN","VPRDJ0",133,0)
 F  S VPRN=$O(^TMP("ORR",$J,ORLIST,VPRN)) Q:VPRN<1  S ID=$G(^(VPRN)) D  Q:VPRI'<VPRMAX
"RTN","VPRDJ0",134,0)
 . Q:$D(^TMP("VPROR",$J,+ID))  Q:$P(ID,";",2)>1  S ID=+ID
"RTN","VPRDJ0",135,0)
 . S X3=$G(^OR(100,ID,3)),X4=$G(^(4))
"RTN","VPRDJ0",136,0)
 . Q:$P(X3,U,3)=13  I X4["P",$P(X3,U,3)=1!($P(X3,U,3)=12) Q  ;cancelled
"RTN","VPRDJ0",137,0)
 . S DAD=$P(X3,U,9) I DAD Q:$D(^TMP("VPROR",$J,DAD))  S ID=DAD
"RTN","VPRDJ0",138,0)
 . D PS1^VPRDJ05(ID) S ^TMP("VPROR",$J,ID)=""
"RTN","VPRDJ0",139,0)
 K ^TMP("VPROR",$J),^TMP("ORR",$J),^TMP("ORGOTIT",$J),^TMP($J,"PSOI")
"RTN","VPRDJ0",140,0)
 Q
"RTN","VPRDJ0",141,0)
 ;
"RTN","VPRDJ0",142,0)
PTF ; -- Patient Treatment File
"RTN","VPRDJ0",143,0)
 N VPRIDT,ID
"RTN","VPRDJ0",144,0)
 D PTF^VPRDJ09 ;sort ^PXRMINDX into ^TMP("VPRPX",$J,IDT)
"RTN","VPRDJ0",145,0)
 I $G(VPRID),VPRID'=+VPRID D PTFA^VPRDJ04A(VPRID) Q
"RTN","VPRDJ0",146,0)
 S VPRIDT=0 F  S VPRIDT=$O(^TMP("VPRPX",$J,VPRIDT)) Q:VPRIDT<1  D  Q:VPRI'<VPRMAX
"RTN","VPRDJ0",147,0)
 . S ID="" F  S ID=$O(^TMP("VPRPX",$J,VPRIDT,ID)) Q:ID=""  D
"RTN","VPRDJ0",148,0)
 .. I VPRID=+VPRID,+ID'=+VPRID Q  ;single PTF record only
"RTN","VPRDJ0",149,0)
 .. D PTF1^VPRDJ04A
"RTN","VPRDJ0",150,0)
 K ^TMP("VPRPX",$J)
"RTN","VPRDJ0",151,0)
 Q
"RTN","VPRDJ0",152,0)
 ;
"RTN","VPRDJ0",153,0)
FACTOR   D PX^VPRDJ09(9000010.23) Q   ; -- PCE Health Factors
"RTN","VPRDJ0",154,0)
IMMUNIZA D PX^VPRDJ09(9000010.11) Q   ; -- PCE Immunizations
"RTN","VPRDJ0",155,0)
EXAM     D PX^VPRDJ09(9000010.13) Q   ; -- PCE Exams
"RTN","VPRDJ0",156,0)
CPT      D PX^VPRDJ09(9000010.18) Q   ; -- PCE CPT
"RTN","VPRDJ0",157,0)
EDUCATIO D PX^VPRDJ09(9000010.16) Q   ; -- PCE Patient Education
"RTN","VPRDJ0",158,0)
POV      D PX^VPRDJ09(9000010.07) Q   ; -- PCE Purpose of Visit (POV)
"RTN","VPRDJ0",159,0)
SKIN     D PX^VPRDJ09(9000010.12) Q   ; -- PCE Skin Tests
"RTN","VPRDJ0",160,0)
 ;
"RTN","VPRDJ0",161,0)
IMAGE ; -- Radiology/Nuclear Medicine
"RTN","VPRDJ0",162,0)
 D EN1^RAO7PC1(DFN,VPRSTART,VPRSTOP,VPRMAX_"P")
"RTN","VPRDJ0",163,0)
 I $G(VPRID) D RA1^VPRDJ07(VPRID) G IMQ
"RTN","VPRDJ0",164,0)
 N ID S ID=""
"RTN","VPRDJ0",165,0)
 F  S ID=$O(^TMP($J,"RAE1",DFN,ID)) Q:ID=""  D RA1^VPRDJ07(ID)  Q:VPRI'<+VPRMAX
"RTN","VPRDJ0",166,0)
IMQ ; end
"RTN","VPRDJ0",167,0)
 K ^TMP($J,"RAE1")
"RTN","VPRDJ0",168,0)
 Q
"RTN","VPRDJ0",169,0)
 ;
"RTN","VPRDJ0",170,0)
APPOINTM ; -- Scheduling/Appointment Mgt
"RTN","VPRDJ0",171,0)
 N VPRX,VPRNUM,VPRDT,X,VPRA,ID
"RTN","VPRDJ0",172,0)
 S VPRX(1)=VPRSTART_";"_VPRSTOP,VPRX(4)=DFN,ID=$G(VPRID)
"RTN","VPRDJ0",173,0)
 S VPRX("FLDS")="1;2;3;6;9;10;11;13",VPRX("SORT")="P"
"RTN","VPRDJ0",174,0)
 I $L(ID) G:$E(ID)="H" DGS^VPRDJ04 D  Q
"RTN","VPRDJ0",175,0)
 . S VPRDT=$P(ID,";",2),VPRX(1)=$P(ID,";",2)_";"_$P(ID,";",2)
"RTN","VPRDJ0",176,0)
 . S VPRX(2)=$P(ID,";",3)
"RTN","VPRDJ0",177,0)
 . S VPRNUM=$$SDAPI^SDAMA301(.VPRX)
"RTN","VPRDJ0",178,0)
 . D:VPRNUM>0 SDAM1^VPRDJ04
"RTN","VPRDJ0",179,0)
 . K ^TMP($J,"SDAMA301",DFN)
"RTN","VPRDJ0",180,0)
 ; appointments
"RTN","VPRDJ0",181,0)
 S VPRX(3)="R;I;NS;NSR;NT" ;no cancelled appt's
"RTN","VPRDJ0",182,0)
 S VPRNUM=$$SDAPI^SDAMA301(.VPRX),VPRDT=0
"RTN","VPRDJ0",183,0)
 F  S VPRDT=$O(^TMP($J,"SDAMA301",DFN,VPRDT)) Q:VPRDT<1  D  Q:VPRI'<VPRMAX
"RTN","VPRDJ0",184,0)
 . S X=$P($G(^TMP($J,"SDAMA301",DFN,VPRDT)),U,3)
"RTN","VPRDJ0",185,0)
 . ;I VPRDT<DT,$P(X,";")'["NS" Q   ;no prior kept appt's
"RTN","VPRDJ0",186,0)
 . D SDAM1^VPRDJ04
"RTN","VPRDJ0",187,0)
 K ^TMP($J,"SDAMA301",DFN)
"RTN","VPRDJ0",188,0)
 Q
"RTN","VPRDJ0",189,0)
 ;
"RTN","VPRDJ0",190,0)
SURGERY ; -- Surgery
"RTN","VPRDJ0",191,0)
 I $G(VPRID) D SR1^VPRDJ07(VPRID) Q
"RTN","VPRDJ0",192,0)
 Q:'$L($T(LIST^SROESTV))
"RTN","VPRDJ0",193,0)
 N SHOWADD S SHOWADD=1 ;to omit leading '+' with note titles
"RTN","VPRDJ0",194,0)
 N VPRN,VPRY,ID D LIST^SROESTV(.VPRY,DFN,VPRSTART,VPRSTOP,VPRMAX,1)
"RTN","VPRDJ0",195,0)
 S VPRN=0 F  S VPRN=$O(@VPRY@(VPRN)) Q:VPRN<1  D
"RTN","VPRDJ0",196,0)
 . S ID=+$G(@VPRY@(VPRN)) D:ID SR1^VPRDJ07(ID)
"RTN","VPRDJ0",197,0)
 K @VPRY
"RTN","VPRDJ0",198,0)
 Q
"RTN","VPRDJ0",199,0)
 ;
"RTN","VPRDJ0",200,0)
DOCUMENT ; -- Text Integration Utilities
"RTN","VPRDJ0",201,0)
 N VPRC,CLS,VPRS,CTXT,VPRY,VPRN,VPRX,ID
"RTN","VPRDJ0",202,0)
 I $L($G(VPRID)) D TIU1^VPRDJ08(VPRID) Q
"RTN","VPRDJ0",203,0)
 N CLASS,SUBCLASS,STATUS
"RTN","VPRDJ0",204,0)
 D SETUP^VPRDJ08 ;define search criteria
"RTN","VPRDJ0",205,0)
 F VPRC=1:1:$L(CLASS,U) S CLS=$P(CLASS,U,VPRC) D  Q:VPRI'<VPRMAX
"RTN","VPRDJ0",206,0)
 . I CLS="CP" D CP^VPRDJ08A(DFN,VPRSTART,VPRSTOP,VPRMAX) Q
"RTN","VPRDJ0",207,0)
 . I CLS="RA" D RA^VPRDJ08A(DFN,VPRSTART,VPRSTOP,VPRMAX) Q
"RTN","VPRDJ0",208,0)
 . I CLS="LR" D LR^VPRDJ08A(DFN,VPRSTART,VPRSTOP,VPRMAX) Q
"RTN","VPRDJ0",209,0)
 . ; TIU document classes, by sig status
"RTN","VPRDJ0",210,0)
 . F VPRS=1:1:$L(STATUS,U) S CTXT=$P(STATUS,U,VPRS) D  Q:VPRI'<VPRMAX
"RTN","VPRDJ0",211,0)
 .. D CONTEXT^TIUSRVLO(.VPRY,CLS,CTXT,DFN,VPRSTART,VPRSTOP,,,,1)
"RTN","VPRDJ0",212,0)
 .. S VPRN=0 F  S VPRN=$O(@VPRY@(VPRN)) Q:VPRN<1  D  Q:VPRI'<VPRMAX
"RTN","VPRDJ0",213,0)
 ... S VPRX=$G(@VPRY@(VPRN)) Q:'$$MATCH^VPRDJ08(VPRX,CTXT)
"RTN","VPRDJ0",214,0)
 ... Q:$D(^TMP("VPRD",$J,+VPRX))  ;already included
"RTN","VPRDJ0",215,0)
 ... D EN1^VPRDJ08(VPRX,CLS)
"RTN","VPRDJ0",216,0)
 .. K @VPRY
"RTN","VPRDJ0",217,0)
 Q
"RTN","VPRDJ0",218,0)
 ;
"RTN","VPRDJ0",219,0)
VISIT ; -- Visits
"RTN","VPRDJ0",220,0)
 I $L($G(VPRID)) D VSIT1^VPRDJ04(VPRID) Q
"RTN","VPRDJ0",221,0)
 N VPRDT,VPRLOC,END,ID
"RTN","VPRDJ0",222,0)
 N VPRADMIT S VPRADMIT=+$G(^DPT(DFN,.105)) ;current admission
"RTN","VPRDJ0",223,0)
 S END=VPRSTOP I VPRSTOP,VPRSTOP'["." S END=VPRSTOP_".24" ;assume end of day
"RTN","VPRDJ0",224,0)
 S VPRDT=END F  S VPRDT=$O(^AUPNVSIT("AET",DFN,VPRDT),-1)  Q:VPRDT<VPRSTART  D  Q:VPRI'<VPRMAX
"RTN","VPRDJ0",225,0)
 . S VPRLOC=0 F  S VPRLOC=$O(^AUPNVSIT("AET",DFN,VPRDT,VPRLOC)) Q:VPRLOC<1  D
"RTN","VPRDJ0",226,0)
 .. S ID=0 F  S ID=$O(^AUPNVSIT("AET",DFN,VPRDT,VPRLOC,"P",ID)) Q:ID<1  D VSIT1^VPRDJ04(ID)
"RTN","VPRDJ0",227,0)
 ; kill VPRADMIT in VSIT1 if adm is included, but add unless filtered
"RTN","VPRDJ0",228,0)
 I $G(VPRADMIT),VPRMAX'<9999,VPRSTART'>1410102 D VSIT1^VPRDJ04("H"_VPRADMIT)
"RTN","VPRDJ0",229,0)
 Q
"RTN","VPRDJ0",230,0)
 ;
"RTN","VPRDJ0",231,0)
VPR ; -- VPR Patient Objects
"RTN","VPRDJ0",232,0)
 D VPR^VPRDJ02($G(TYPE))
"RTN","VPRDJ0",233,0)
 Q
"RTN","VPRDJ0",234,0)
 ;
"RTN","VPRDJ0",235,0)
MH ; -- Mental Health
"RTN","VPRDJ0",236,0)
 I $L($T(MH^VPRDJ09M)) D MH^VPRDJ09M
"RTN","VPRDJ0",237,0)
 Q
"RTN","VPRDJ02")
0^23^B44230094^B43626306
"RTN","VPRDJ02",1,0)
VPRDJ02 ;SLC/MKB -- Problems,Allergies,Vitals ;6/25/12  16:11
"RTN","VPRDJ02",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**2,5**;Sep 01, 2011;Build 21
"RTN","VPRDJ02",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDJ02",4,0)
 ;
"RTN","VPRDJ02",5,0)
 ; External References          DBIA#
"RTN","VPRDJ02",6,0)
 ; -------------------          -----
"RTN","VPRDJ02",7,0)
 ; ^PXRMINDX                     4290
"RTN","VPRDJ02",8,0)
 ; ^SC                          10040
"RTN","VPRDJ02",9,0)
 ; DIC                           2051
"RTN","VPRDJ02",10,0)
 ; DIQ                           2056
"RTN","VPRDJ02",11,0)
 ; GMPLUTL2                      2741
"RTN","VPRDJ02",12,0)
 ; GMRADPT                      10099
"RTN","VPRDJ02",13,0)
 ; GMRAOR2                       2422
"RTN","VPRDJ02",14,0)
 ; GMRVUT0,^UTILITY($J           1446
"RTN","VPRDJ02",15,0)
 ; GMVGETQL                      5048
"RTN","VPRDJ02",16,0)
 ; GMVGETVT                      5047
"RTN","VPRDJ02",17,0)
 ; GMVUTL                        5046
"RTN","VPRDJ02",18,0)
 ; ICDEX                         5747
"RTN","VPRDJ02",19,0)
 ; XLFSTR                       10104
"RTN","VPRDJ02",20,0)
 ; XUAF4                         2171
"RTN","VPRDJ02",21,0)
 ;
"RTN","VPRDJ02",22,0)
 ; All tags expect DFN, ID, [VPRSTART, VPRSTOP, VPRMAX, VPRTEXT]
"RTN","VPRDJ02",23,0)
 ;
"RTN","VPRDJ02",24,0)
GMPL1(ID) ; -- problem
"RTN","VPRDJ02",25,0)
 N VPRL,PROB,X,I,DATE,USER,FAC
"RTN","VPRDJ02",26,0)
 D DETAIL^GMPLUTL2(ID,.VPRL) Q:'$D(VPRL)  ;doesn't exist
"RTN","VPRDJ02",27,0)
 ;
"RTN","VPRDJ02",28,0)
 S PROB("uid")=$$SETUID^VPRUTILS("problem",DFN,ID),PROB("localId")=ID
"RTN","VPRDJ02",29,0)
 S PROB("problemText")=$G(VPRL("NARRATIVE"))
"RTN","VPRDJ02",30,0)
 S DATE=$P($G(VPRL("ENTERED")),U)
"RTN","VPRDJ02",31,0)
 S:$L(DATE) DATE=$$DATE^VPRDGMPL(DATE),PROB("entered")=$$JSONDT^VPRUTILS(DATE)
"RTN","VPRDJ02",32,0)
 S X=$G(VPRL("DIAGNOSIS")) I $L(X) D
"RTN","VPRDJ02",33,0)
 . N ICD9ZN,DIAG,SYS
"RTN","VPRDJ02",34,0)
 . I DATE'>0 S DATE=DT
"RTN","VPRDJ02",35,0)
 . S ICD9ZN=$$ICDDX^ICDEX(X,DATE,,"E"),DIAG=$S($P($G(ICD9ZN),U,4)'="":$P(ICD9ZN,U,4),1:X)
"RTN","VPRDJ02",36,0)
 . S SYS=$$LOW^XLFSTR($G(VPRL("CSYS"),"ICD")) ;icd or 10d
"RTN","VPRDJ02",37,0)
 . S PROB("icdCode")=$$SETNCS^VPRUTILS(SYS,X),PROB("icdName")=DIAG
"RTN","VPRDJ02",38,0)
 S X=$G(VPRL("ONSET")) S:$L(X) X=$$DATE^VPRDGMPL(X),PROB("onset")=$$JSONDT^VPRUTILS(X)
"RTN","VPRDJ02",39,0)
 S X=$G(VPRL("MODIFIED")) S:$L(X) X=$$DATE^VPRDGMPL(X),PROB("updated")=$$JSONDT^VPRUTILS(X)
"RTN","VPRDJ02",40,0)
 S X=$G(VPRL("STATUS")) I $L(X) D
"RTN","VPRDJ02",41,0)
 . S PROB("statusName")=X,X=$E(X)
"RTN","VPRDJ02",42,0)
 . S X=$S(X="A":55561003,X="I":73425007,1:"")
"RTN","VPRDJ02",43,0)
 . S PROB("statusCode")=$$SETNCS^VPRUTILS("sct",X)
"RTN","VPRDJ02",44,0)
 S X=$G(VPRL("PRIORITY")) I X]"" D
"RTN","VPRDJ02",45,0)
 . S X=$$LOW^XLFSTR(X),PROB("acuityName")=X
"RTN","VPRDJ02",46,0)
 . S PROB("acuityCode")=$$SETVURN^VPRUTILS("prob-acuity",$E(X))
"RTN","VPRDJ02",47,0)
 S X=$$GET1^DIQ(9000011,ID_",",1.07,"I") S:X PROB("resolved")=$$JSONDT^VPRUTILS(X)
"RTN","VPRDJ02",48,0)
 S X=$$GET1^DIQ(9000011,ID_",",1.02,"I")
"RTN","VPRDJ02",49,0)
 S:X="P" PROB("unverified")="false",PROB("removed")="false"
"RTN","VPRDJ02",50,0)
 S:X="T" PROB("unverified")="true",PROB("removed")="false"
"RTN","VPRDJ02",51,0)
 S:X="H" PROB("unverified")="false",PROB("removed")="true"
"RTN","VPRDJ02",52,0)
 S X=$G(VPRL("SC")),X=$S(X="YES":"",X="NO":"false",1:"")
"RTN","VPRDJ02",53,0)
 S:$L(X) PROB("serviceConnected")=X
"RTN","VPRDJ02",54,0)
 S X=$G(VPRL("PROVIDER")) I $L(X) D
"RTN","VPRDJ02",55,0)
 . S PROB("providerName")=X,X=$$GET1^DIQ(9000011,ID_",",1.05,"I")
"RTN","VPRDJ02",56,0)
 . S PROB("providerUid")=$$SETUID^VPRUTILS("user",,+X)
"RTN","VPRDJ02",57,0)
 S X=$$GET1^DIQ(9000011,ID_",",1.06) S:$L(X) PROB("service")=X
"RTN","VPRDJ02",58,0)
 S X=$G(VPRL("CLINIC")) I $L(X) D
"RTN","VPRDJ02",59,0)
 . S PROB("locationName")=X
"RTN","VPRDJ02",60,0)
 . N LOC S LOC=+$$FIND1^DIC(44,,"QX",X)
"RTN","VPRDJ02",61,0)
 . S:LOC PROB("locationUid")=$$SETUID^VPRUTILS("location",,LOC)
"RTN","VPRDJ02",62,0)
 S X=+$$GET1^DIQ(9000011,ID_",",.06,"I")
"RTN","VPRDJ02",63,0)
 S:X FAC=$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U)
"RTN","VPRDJ02",64,0)
 I 'X S FAC=$$FAC^VPRD ;local stn#^name
"RTN","VPRDJ02",65,0)
 D FACILITY^VPRUTILS(FAC,"PROB")
"RTN","VPRDJ02",66,0)
 S I=0 F  S I=$O(VPRL("COMMENT",I)) Q:I<1  D
"RTN","VPRDJ02",67,0)
 . S X=$G(VPRL("COMMENT",I))
"RTN","VPRDJ02",68,0)
 . S USER=$$VA200^VPRDGMPL($P(X,U,2)),DATE=$$DATE^VPRDGMPL($P(X,U))
"RTN","VPRDJ02",69,0)
 . S PROB("comments",I,"enteredByCode")=$$SETUID^VPRUTILS("user",,+USER)
"RTN","VPRDJ02",70,0)
 . S PROB("comments",I,"enteredByName")=$P(X,U,2)
"RTN","VPRDJ02",71,0)
 . S PROB("comments",I,"entered")=$$JSONDT^VPRUTILS(DATE)
"RTN","VPRDJ02",72,0)
 . S PROB("comments",I,"comment")=$P(X,U,3)
"RTN","VPRDJ02",73,0)
 D ADD^VPRDJ("PROB","problem")
"RTN","VPRDJ02",74,0)
 Q
"RTN","VPRDJ02",75,0)
 ;
"RTN","VPRDJ02",76,0)
GMRA1(ID) ; -- allergy/reaction GMRAL(ID)
"RTN","VPRDJ02",77,0)
 N GMRA,VPRY,REAC,X,Y,I
"RTN","VPRDJ02",78,0)
 S GMRA=$G(GMRAL(ID)) D EN1^GMRAOR2(ID,"VPRY")
"RTN","VPRDJ02",79,0)
 ;
"RTN","VPRDJ02",80,0)
 S X=$P(VPRY,U,10) I $L(X) S X=$$DATE^VPRDGMRA(X) Q:X<VPRSTART  Q:X>VPRSTOP  S REAC("entered")=$$JSONDT^VPRUTILS(X)
"RTN","VPRDJ02",81,0)
 S X=$$FAC^VPRD D FACILITY^VPRUTILS(X,"REAC")
"RTN","VPRDJ02",82,0)
 S REAC("kind")="Allergy / Adverse Reaction"
"RTN","VPRDJ02",83,0)
 S REAC("localId")=ID,REAC("uid")=$$SETUID^VPRUTILS("allergy",DFN,ID)
"RTN","VPRDJ02",84,0)
 S (REAC("summary"),REAC("products",1,"name"))=$P(VPRY,U) I $P(GMRA,U,9) D
"RTN","VPRDJ02",85,0)
 . S X=$P(GMRA,U,9),REAC("reference")=X
"RTN","VPRDJ02",86,0)
 . S Y=+$P(X,"(",2) I 'Y,X["PSDRUG" S Y=50
"RTN","VPRDJ02",87,0)
 . S I=$$VUID^VPRD(+X,Y),REAC("products",1,"vuid")=$$SETVURN^VPRUTILS("vuid",I)
"RTN","VPRDJ02",88,0)
 S REAC("historical")=$S($E($P(VPRY,U,5))="H":"true",1:"false")
"RTN","VPRDJ02",89,0)
 ; REAC("adverseEventTypeName")=$P(VPRY,U,7)_" "_$P(VPRY,U,6) ;TYPE_MECH
"RTN","VPRDJ02",90,0)
 I $P(VPRY,U,4)="VERIFIED",$P(VPRY,U,9) S REAC("verified")=$$JSONDT^VPRUTILS($P(VPRY,U,9))
"RTN","VPRDJ02",91,0)
 ; reactions
"RTN","VPRDJ02",92,0)
 S I=0 F  S I=$O(GMRAL(ID,"S",I)) Q:I<1  D
"RTN","VPRDJ02",93,0)
 . S X=$G(GMRAL(ID,"S",I))
"RTN","VPRDJ02",94,0)
 . S REAC("reactions",I,"name")=$P(X,";")
"RTN","VPRDJ02",95,0)
 . S Y=$$VUID^VPRD(+$P(X,";",2),120.83)
"RTN","VPRDJ02",96,0)
 . S REAC("reactions",I,"vuid")=$$SETVURN^VPRUTILS("vuid",Y)
"RTN","VPRDJ02",97,0)
 I GMRA="" S REAC("removed")="true" ;entered in error
"RTN","VPRDJ02",98,0)
 D ADD^VPRDJ("REAC","allergy")
"RTN","VPRDJ02",99,0)
 Q
"RTN","VPRDJ02",100,0)
 ;
"RTN","VPRDJ02",101,0)
NKA ; -- no assessment or NKA [GMRAL=0 or ""]
"RTN","VPRDJ02",102,0)
 N REAC,X
"RTN","VPRDJ02",103,0)
 S REAC("assessment")=$S(GMRAL=0:"nka",1:"not done")
"RTN","VPRDJ02",104,0)
 S X=$$FAC^VPRD D FACILITY^VPRUTILS(X,"REAC")
"RTN","VPRDJ02",105,0)
 D ADD^VPRDJ("REAC","allergy")
"RTN","VPRDJ02",106,0)
 Q
"RTN","VPRDJ02",107,0)
 ;
"RTN","VPRDJ02",108,0)
GMV1(ID) ; -- vital/measurement ^UTILITY($J,"GMRVD",VPRIDT,VPRTYP,ID)
"RTN","VPRDJ02",109,0)
 N VIT,VPRY,X0,TYPE,LOC,FAC,X,Y,MRES,MUNT,HIGH,LOW,I
"RTN","VPRDJ02",110,0)
 D GETREC^GMVUTL(.VPRY,ID,1) S X0=$G(VPRY(0))
"RTN","VPRDJ02",111,0)
 ; GMRVUT0 returns CLiO data with a pseudo-ID >> get real ID
"RTN","VPRDJ02",112,0)
 I X0="",$G(VPRIDT),$D(VPRTYP) D  ;[from VPRDJ0]
"RTN","VPRDJ02",113,0)
 . N GMRVD S GMRVD=$G(^UTILITY($J,"GMRVD",VPRIDT,VPRTYP,ID))
"RTN","VPRDJ02",114,0)
 . S ID=$O(^PXRMINDX(120.5,"PI",DFN,$P(GMRVD,U,3),+GMRVD,""))
"RTN","VPRDJ02",115,0)
 . I $L(ID) D GETREC^GMVUTL(.VPRY,ID,1) S X0=$G(VPRY(0))
"RTN","VPRDJ02",116,0)
 Q:X0=""
"RTN","VPRDJ02",117,0)
 ;
"RTN","VPRDJ02",118,0)
 S VIT("localId")=ID,VIT("kind")="Vital Sign"
"RTN","VPRDJ02",119,0)
 S VIT("uid")=$$SETUID^VPRUTILS("vital",DFN,ID)
"RTN","VPRDJ02",120,0)
 S VIT("observed")=$$JSONDT^VPRUTILS(+X0)
"RTN","VPRDJ02",121,0)
 S VIT("resulted")=$$JSONDT^VPRUTILS(+$P(X0,U,4))
"RTN","VPRDJ02",122,0)
 S TYPE=$$FIELD^GMVGETVT(+$P(X0,U,3),2)
"RTN","VPRDJ02",123,0)
 S VIT("displayName")=TYPE
"RTN","VPRDJ02",124,0)
 S VIT("typeName")=$$FIELD^GMVGETVT($P(X0,U,3),1)
"RTN","VPRDJ02",125,0)
 S VIT("typeCode")="urn:va:vuid:"_$$FIELD^GMVGETVT($P(X0,U,3),4)
"RTN","VPRDJ02",126,0)
 S X=$P(X0,U,8),VIT("result")=X
"RTN","VPRDJ02",127,0)
 S VIT("units")=$$UNIT^VPRDGMV(TYPE),(MRES,MUNT)=""
"RTN","VPRDJ02",128,0)
 I TYPE="T"  S MUNT="C",MRES=$J(X-32*5/9,0,1) ;EN1^GMRVUTL
"RTN","VPRDJ02",129,0)
 I TYPE="HT" S MUNT="cm",MRES=$J(2.54*X,0,2)  ;EN2^GMRVUTL
"RTN","VPRDJ02",130,0)
 I TYPE="WT" S MUNT="kg",MRES=$J(X/2.2,0,2)   ;EN3^GMRVUTL
"RTN","VPRDJ02",131,0)
 I TYPE="CG" S MUNT="cm",MRES=$J(2.54*X,0,2)
"RTN","VPRDJ02",132,0)
 S:MRES VIT("metricResult")=MRES,VIT("metricUnits")=MUNT
"RTN","VPRDJ02",133,0)
 S X=$$RANGE^VPRDGMV(TYPE) I $L(X) S VIT("high")=$P(X,U),VIT("low")=$P(X,U,2)
"RTN","VPRDJ02",134,0)
 S VIT("summary")=VIT("typeName")_" "_VIT("result")_" "_VIT("units")
"RTN","VPRDJ02",135,0)
 F I=1:1:$L(VPRY(5),U) S X=$P(VPRY(5),U,I) I X D
"RTN","VPRDJ02",136,0)
 . S VIT("qualifiers",I,"name")=$$FIELD^GMVGETQL(X,1)
"RTN","VPRDJ02",137,0)
 . S VIT("qualifiers",I,"vuid")=$$FIELD^GMVGETQL(X,3)
"RTN","VPRDJ02",138,0)
 I $G(VPRY(2)) S VIT("removed")="true"        ;entered in error
"RTN","VPRDJ02",139,0)
 S LOC=+$P(X0,U,5),FAC=$$FAC^VPRD(LOC)
"RTN","VPRDJ02",140,0)
 S VIT("locationUid")=$$SETUID^VPRUTILS("location",,LOC)
"RTN","VPRDJ02",141,0)
 S VIT("locationName")=$S(LOC:$P($G(^SC(LOC,0)),U),1:"unknown")
"RTN","VPRDJ02",142,0)
 D FACILITY^VPRUTILS(FAC,"VIT")
"RTN","VPRDJ02",143,0)
 D ADD^VPRDJ("VIT","vital")
"RTN","VPRDJ02",144,0)
 Q
"RTN","VPRDJ02",145,0)
 ;
"RTN","VPRDJ02",146,0)
VPR(COLL) ; -- VPR Patient Objects
"RTN","VPRDJ02",147,0)
 N ID I $L($G(VPRID)) D  Q
"RTN","VPRDJ02",148,0)
 . S ID=+VPRID I 'ID S ID=+$O(^VPR(560.1,"B",VPRID,0)) ;IEN or UID
"RTN","VPRDJ02",149,0)
 . D:ID VPR1(560.1,ID)
"RTN","VPRDJ02",150,0)
 Q:$G(COLL)=""  ;error
"RTN","VPRDJ02",151,0)
 S ID=0 F  S ID=$O(^VPR(560.1,"C",DFN,COLL,ID)) Q:ID<1  D VPR1(560.1,ID)
"RTN","VPRDJ02",152,0)
 Q
"RTN","VPRDJ02",153,0)
VPR1(FNUM,ID) ; -- [patient] object
"RTN","VPRDJ02",154,0)
 N I,X,VPRY
"RTN","VPRDJ02",155,0)
 S I=0 F  S I=$O(^VPR(FNUM,ID,1,I)) Q:I<1  S X=$G(^(I,0)),VPRY(I)=X
"RTN","VPRDJ02",156,0)
 I $D(VPRY) D  ;already encoded JSON
"RTN","VPRDJ02",157,0)
 . S VPRI=VPRI+1 S:VPRI>1 @VPR@(VPRI,.3)=","
"RTN","VPRDJ02",158,0)
 . M @VPR@(VPRI)=VPRY
"RTN","VPRDJ02",159,0)
 Q
"RTN","VPRDJ04")
0^24^B48088220^B47678729
"RTN","VPRDJ04",1,0)
VPRDJ04 ;SLC/MKB -- Appointments,Visits ;6/25/12  16:11
"RTN","VPRDJ04",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**2,5**;Sep 01, 2011;Build 21
"RTN","VPRDJ04",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDJ04",4,0)
 ;
"RTN","VPRDJ04",5,0)
 ; External References          DBIA#
"RTN","VPRDJ04",6,0)
 ; -------------------          -----
"RTN","VPRDJ04",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDJ04",8,0)
 ; ^DGS(41.1                     3796
"RTN","VPRDJ04",9,0)
 ; ^DIC(42                      10039
"RTN","VPRDJ04",10,0)
 ; ^SC                          10040
"RTN","VPRDJ04",11,0)
 ; ^VA(200                      10060
"RTN","VPRDJ04",12,0)
 ; DIQ                           2056
"RTN","VPRDJ04",13,0)
 ; ICPTCOD                       1995
"RTN","VPRDJ04",14,0)
 ; PXAPI,^TMP("PXKENC"           1894
"RTN","VPRDJ04",15,0)
 ; SDAMA301                      4433
"RTN","VPRDJ04",16,0)
 ; XLFDT                        10103
"RTN","VPRDJ04",17,0)
 ; XUAF4                         2171
"RTN","VPRDJ04",18,0)
 ;
"RTN","VPRDJ04",19,0)
 ; All tags expect DFN, ID, [VPRSTART, VPRSTOP, VPRMAX, VPRTEXT]
"RTN","VPRDJ04",20,0)
 ;
"RTN","VPRDJ04",21,0)
SDAM1 ; -- appointment ^TMP($J,"SDAMA301",DFN,VPRDT)
"RTN","VPRDJ04",22,0)
 N NODE,HLOC,APPT,X,STS,CLS,FAC,SV,PRV
"RTN","VPRDJ04",23,0)
 S NODE=$G(^TMP($J,"SDAMA301",DFN,VPRDT))
"RTN","VPRDJ04",24,0)
 ;
"RTN","VPRDJ04",25,0)
 S HLOC=$P(NODE,U,2),X="A;"_VPRDT_";"_+HLOC
"RTN","VPRDJ04",26,0)
 I $L($G(ID)),$P(ID,";",1,3)'=X Q
"RTN","VPRDJ04",27,0)
 S APPT("localId")=X,APPT("uid")=$$SETUID^VPRUTILS("appointment",DFN,X)
"RTN","VPRDJ04",28,0)
 S X=$P(NODE,U,10),APPT("typeCode")=$P(X,";"),APPT("typeName")=$P(X,";",2)
"RTN","VPRDJ04",29,0)
 S STS=$P(NODE,U,3),CLS=$S($E(STS)="I":"I",1:"O")
"RTN","VPRDJ04",30,0)
 S APPT("dateTime")=$$JSONDT^VPRUTILS(VPRDT)
"RTN","VPRDJ04",31,0)
 S:$L($P(NODE,U,6)) APPT("comment")=$P(NODE,U,6)
"RTN","VPRDJ04",32,0)
 S:$P(NODE,U,9) APPT("checkIn")=$$JSONDT^VPRUTILS($P(NODE,U,9))
"RTN","VPRDJ04",33,0)
 S:$P(NODE,U,11) APPT("checkOut")=$$JSONDT^VPRUTILS($P(NODE,U,11))
"RTN","VPRDJ04",34,0)
 I $L(ID,";")>3 S APPT("reasonName")=$P(ID,";",4),PRV=+$P(ID,";",5) ;from SDAM event
"RTN","VPRDJ04",35,0)
 S FAC=$$FAC^VPRD(+HLOC) D FACILITY^VPRUTILS(FAC,"APPT") I HLOC D
"RTN","VPRDJ04",36,0)
 . S APPT("locationName")=$P(HLOC,";",2)
"RTN","VPRDJ04",37,0)
 . S APPT("locationUid")=$$SETUID^VPRUTILS("location",,+HLOC)
"RTN","VPRDJ04",38,0)
 . S X=$$AMIS^VPRDVSIT(+$P(NODE,U,13))
"RTN","VPRDJ04",39,0)
 . S:$L(X) APPT("stopCodeUid")="urn:va:stop-code:"_$P(X,U),APPT("stopCodeName")=$P(X,U,2)
"RTN","VPRDJ04",40,0)
 . S SV=$$GET1^DIQ(44,+HLOC_",",9.5,"I")
"RTN","VPRDJ04",41,0)
 . I SV S APPT("service")=$$SERV^VPRDSDAM(SV)
"RTN","VPRDJ04",42,0)
 . ;find default provider
"RTN","VPRDJ04",43,0)
 . S:'$G(PRV) PRV=+$$GET1^DIQ(44,+HLOC_",",16,"I") I 'PRV D
"RTN","VPRDJ04",44,0)
 .. N VPRP,I,FIRST
"RTN","VPRDJ04",45,0)
 .. D GETS^DIQ(44,+HLOC_",","2600*","I","VPRP")
"RTN","VPRDJ04",46,0)
 .. S FIRST=$O(VPRP(44.1,"")),I=""
"RTN","VPRDJ04",47,0)
 .. F  S I=$O(VPRP(44.1,I)) Q:I=""  I $G(VPRP(44.1,I,.02,"I")) S PRV=$G(VPRP(44.1,I,.01,"I")) Q
"RTN","VPRDJ04",48,0)
 .. I 'PRV,FIRST S PRV=$G(VPRP(44.1,FIRST,.01,"I"))
"RTN","VPRDJ04",49,0)
 I $G(PRV) S APPT("providers",1,"providerUid")=$$SETUID^VPRUTILS("user",,PRV),APPT("providers",1,"providerName")=$P($G(^VA(200,PRV,0)),U)
"RTN","VPRDJ04",50,0)
 I $G(SV) S APPT("summary")="${"_APPT("service")_"}:"_$P(HLOC,";",2)
"RTN","VPRDJ04",51,0)
 S APPT("patientClassCode")="urn:va:patient-class:"_$S(CLS="I":"IMP",1:"AMB")
"RTN","VPRDJ04",52,0)
 S APPT("patientClassName")=$S(CLS="I":"Inpatient",1:"Ambulatory")
"RTN","VPRDJ04",53,0)
 S APPT("categoryCode")="urn:va:encounter-category:OV",APPT("categoryName")="Outpatient Visit"
"RTN","VPRDJ04",54,0)
 S APPT("appointmentStatus")=$P(STS,";",2)
"RTN","VPRDJ04",55,0)
 D ADD^VPRDJ("APPT","appointment")
"RTN","VPRDJ04",56,0)
 Q
"RTN","VPRDJ04",57,0)
 ;
"RTN","VPRDJ04",58,0)
DGS ; scheduled admissions [from APPOINTM^VPRDJ0]
"RTN","VPRDJ04",59,0)
 S VPRA=0 F  S VPRA=$O(^DGS(41.1,"B",DFN,VPRA)) Q:VPRA<1  D  Q:VPRI'<VPRMAX
"RTN","VPRDJ04",60,0)
 . S VPRX=$G(^DGS(41.1,VPRA,0))
"RTN","VPRDJ04",61,0)
 . I $L($G(ID)),+$P(ID,";",2)=+$P(VPRX,U,2) D DGS1(VPRA) Q
"RTN","VPRDJ04",62,0)
 . Q:$P(VPRX,U,13)  Q:$P(VPRX,U,17)  ;cancelled or admitted
"RTN","VPRDJ04",63,0)
 . S X=$P(VPRX,U,2) Q:X<VPRSTART!(X>VPRSTOP)  ;out of date range
"RTN","VPRDJ04",64,0)
 . D DGS1(VPRA)
"RTN","VPRDJ04",65,0)
 Q
"RTN","VPRDJ04",66,0)
 ;
"RTN","VPRDJ04",67,0)
DGS1(IFN) ; -- scheduled admission
"RTN","VPRDJ04",68,0)
 N ADM,X0,DATE,HLOC,FAC,SV,X
"RTN","VPRDJ04",69,0)
 S X0=$G(^DGS(41.1,+$G(IFN),0)) Q:X0=""  ;deleted
"RTN","VPRDJ04",70,0)
 ;
"RTN","VPRDJ04",71,0)
 S DATE=+$P(X0,U,2),HLOC=+$G(^DIC(42,+$P(X0,U,8),44))
"RTN","VPRDJ04",72,0)
 S X="H;"_DATE,ADM("localId")=X,ADM("uid")=$$SETUID^VPRUTILS("appointment",DFN,X)
"RTN","VPRDJ04",73,0)
 S ADM("dateTime")=$$JSONDT^VPRUTILS(DATE)
"RTN","VPRDJ04",74,0)
 S FAC=$$FAC^VPRD(+HLOC) D FACILITY^VPRUTILS(FAC,"ADM") I HLOC D
"RTN","VPRDJ04",75,0)
 . S HLOC=+HLOC_";"_$P($G(^SC(+HLOC,0)),U)
"RTN","VPRDJ04",76,0)
 . S ADM("uid")=ADM("uid")_";"_+HLOC
"RTN","VPRDJ04",77,0)
 . S ADM("locationName")=$P(HLOC,";",2)
"RTN","VPRDJ04",78,0)
 . S ADM("locationUid")=$$SETUID^VPRUTILS("location",,+HLOC)
"RTN","VPRDJ04",79,0)
 . S X=$$GET1^DIQ(44,+HLOC_",",8,"I"),X=$$AMIS^VPRDVSIT(X)
"RTN","VPRDJ04",80,0)
 . S:$L(X) ADM("stopCodeUid")="urn:va:stop-code:"_$P(X,U),ADM("stopCodeName")=$P(X,U,2)
"RTN","VPRDJ04",81,0)
 . S SV=$$GET1^DIQ(44,+HLOC_",",9.5,"I")
"RTN","VPRDJ04",82,0)
 . I SV S ADM("service")=$$SERV^VPRDSDAM(SV)
"RTN","VPRDJ04",83,0)
 I $G(SV) S ADM("summary")="${"_ADM("service")_"}:"_$P(HLOC,";",2)
"RTN","VPRDJ04",84,0)
 S X=+$P(X0,U,5) I X D
"RTN","VPRDJ04",85,0)
 . S ADM("providers",1,"providerUid")=$$SETUID^VPRUTILS("user",,X)
"RTN","VPRDJ04",86,0)
 . S ADM("providers",1,"providerName")=$P($G(^VA(200,X,0)),U)
"RTN","VPRDJ04",87,0)
 S ADM("patientClassCode")="urn:va:patient-class:IMP",ADM("patientClassName")="Inpatient"
"RTN","VPRDJ04",88,0)
 S ADM("categoryCode")="urn:va:encounter-category:AD",ADM("categoryName")="Admission"
"RTN","VPRDJ04",89,0)
 S ADM("appointmentStatus")=$S($P(X0,U,17):"ADMITTED",$P(X0,U,13):"CANCELLED",1:"SCHEDULED")
"RTN","VPRDJ04",90,0)
 D ADD^VPRDJ("ADM","appointment")
"RTN","VPRDJ04",91,0)
 Q
"RTN","VPRDJ04",92,0)
 ;
"RTN","VPRDJ04",93,0)
VSIT1(ID) ; -- visit
"RTN","VPRDJ04",94,0)
 N VST,X0,X15,X,FAC,LOC,CATG,AMIS,INPT,DA
"RTN","VPRDJ04",95,0)
 I $G(ID)?1"H"1.N D ADM^VPRDJ04A(ID) Q
"RTN","VPRDJ04",96,0)
 D ENCEVENT^PXAPI(ID)
"RTN","VPRDJ04",97,0)
 ;
"RTN","VPRDJ04",98,0)
 S X0=$G(^TMP("PXKENC",$J,ID,"VST",ID,0)),X15=$G(^(150))
"RTN","VPRDJ04",99,0)
 Q:$P(X15,U,3)'="P"  Q:$P(X0,U,7)="E"  Q:$P(X0,U,12)  ;primary, not historical or child
"RTN","VPRDJ04",100,0)
 I $P(X0,U,7)="H" D ADM^VPRDJ04A(ID,+X0) Q
"RTN","VPRDJ04",101,0)
 S VST("localId")=ID,VST("uid")=$$SETUID^VPRUTILS("visit",DFN,ID)
"RTN","VPRDJ04",102,0)
 S VST("dateTime")=$$JSONDT^VPRUTILS(+X0)
"RTN","VPRDJ04",103,0)
 S:$P(X0,U,18) VST("checkOut")=$$JSONDT^VPRUTILS($P(X0,U,18))
"RTN","VPRDJ04",104,0)
 S FAC=+$P(X0,U,6),CATG=$P(X0,U,7),LOC=+$P(X0,U,22)
"RTN","VPRDJ04",105,0)
 S:FAC X=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDJ04",106,0)
 S:'FAC X=$$FAC^VPRD(LOC) D FACILITY^VPRUTILS(X,"VST")
"RTN","VPRDJ04",107,0)
 S X=$S(CATG="H":"AD",CATG="C":"CR",CATG="T":"TC",CATG="N":"U",CATG="R":"NH","D^X"[CATG:"O",1:"OV")
"RTN","VPRDJ04",108,0)
 S VST("categoryCode")="urn:va:encounter-category:"_X
"RTN","VPRDJ04",109,0)
 S VST("categoryName")=$S(X="AD":"Admission",X="CR":"Chart Review",X="TC":"Phone Contact",X="U":"Unknown",X="NH":"Nursing Home",X="O":"Other",1:"Outpatient Visit")
"RTN","VPRDJ04",110,0)
 S INPT=$P(X15,U,2) S:INPT="" INPT=$S("H^I^R^D"[CATG:1,1:0)
"RTN","VPRDJ04",111,0)
 S X=$$CPT^VPRDVSIT(ID) S:X VST("typeName")=$P($$CPT^ICPTCOD(X),U,3)
"RTN","VPRDJ04",112,0)
 I 'X S VST("typeName")=$S('INPT&LOC:$P($G(^SC(LOC,0)),U)_" VISIT",1:$$CATG^VPRDVSIT(CATG))
"RTN","VPRDJ04",113,0)
 S VST("patientClassCode")="urn:va:patient-class:"_$S(INPT:"IMP",1:"AMB")
"RTN","VPRDJ04",114,0)
 S VST("patientClassName")=$S(INPT:"Inpatient",1:"Ambulatory")
"RTN","VPRDJ04",115,0)
 S X=$P(X0,U,8) S:X AMIS=$$AMIS^VPRDVSIT(X) I LOC D
"RTN","VPRDJ04",116,0)
 . N L0 S L0=$G(^SC(LOC,0))
"RTN","VPRDJ04",117,0)
 . I 'X S AMIS=$$AMIS^VPRDVSIT($P(L0,U,7))
"RTN","VPRDJ04",118,0)
 . S VST("locationUid")=$$SETUID^VPRUTILS("location",,+LOC)
"RTN","VPRDJ04",119,0)
 . S VST("locationName")=$P(L0,U)
"RTN","VPRDJ04",120,0)
 . S X=$$SERV^VPRDVSIT($P(L0,U,20)) Q:X=""
"RTN","VPRDJ04",121,0)
 . S:$L(X) VST("service")=X,VST("summary")="${"_VST("service")_"}:"_$P(L0,U)
"RTN","VPRDJ04",122,0)
 S:$D(AMIS) VST("stopCodeUid")="urn:va:stop-code:"_$P(AMIS,U),VST("stopCodeName")=$P(AMIS,U,2)
"RTN","VPRDJ04",123,0)
 S X=$$POV^VPRDVSIT(ID) I $L(X) D
"RTN","VPRDJ04",124,0)
 . N SYS S SYS=$P(X,U,3),SYS=$$LOW^XLFSTR(SYS)
"RTN","VPRDJ04",125,0)
 . S VST("reasonUid")=$$SETNCS^VPRUTILS(SYS,$P(X,U)),VST("reasonName")=$P(X,U,2)
"RTN","VPRDJ04",126,0)
 ; provider(s)
"RTN","VPRDJ04",127,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,ID,"PRV",DA)) Q:DA<1  S X0=$G(^(DA,0)) D
"RTN","VPRDJ04",128,0)
 . I $P(X0,U,4)="P" D PROV("VST",DA,+X0,"P",1) Q  ;primary
"RTN","VPRDJ04",129,0)
 . D PROV("VST",DA,+X0,"S")                       ;secondary
"RTN","VPRDJ04",130,0)
 K ^TMP("PXKENC",$J,ID)
"RTN","VPRDJ04",131,0)
 ; note(s)
"RTN","VPRDJ04",132,0)
 D TIU^VPRDJ04A(ID,.VST)
"RTN","VPRDJ04",133,0)
 D ADD^VPRDJ("VST","visit")
"RTN","VPRDJ04",134,0)
 Q
"RTN","VPRDJ04",135,0)
 ;
"RTN","VPRDJ04",136,0)
PROV(ARR,I,IEN,ROLE,PRIM) ; -- add providers
"RTN","VPRDJ04",137,0)
 S @ARR@("providers",I,"providerUid")=$$SETUID^VPRUTILS("user",,+IEN)
"RTN","VPRDJ04",138,0)
 S @ARR@("providers",I,"providerName")=$P($G(^VA(200,+IEN,0)),U)
"RTN","VPRDJ04",139,0)
 S @ARR@("providers",I,"role")=ROLE
"RTN","VPRDJ04",140,0)
 S:$G(PRIM) @ARR@("providers",I,"primary")="true"
"RTN","VPRDJ04",141,0)
 Q
"RTN","VPRDJ04",142,0)
 ;
"RTN","VPRDJ04",143,0)
NAME(IEN) ; -- Return a string 'name' for the visit
"RTN","VPRDJ04",144,0)
 N Y,X0,LOC,DATE
"RTN","VPRDJ04",145,0)
 S X0=$G(^AUPNVSIT(+$G(IEN),0)),Y=""
"RTN","VPRDJ04",146,0)
 S DATE=+X0,LOC=+$P(X0,U,22) S:LOC LOC=$P($G(^SC(LOC,0)),U)_" "
"RTN","VPRDJ04",147,0)
 S Y=LOC_$$FMTE^XLFDT(DATE,"1D") ;Mon DD, YYYY
"RTN","VPRDJ04",148,0)
 Q Y
"RTN","VPRDJ04A")
0^25^B35067136^B36420588
"RTN","VPRDJ04A",1,0)
VPRDJ04A ;SLC/MKB -- Admissions,PTF ;7/25/13
"RTN","VPRDJ04A",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**2,5**;Sep 01, 2011;Build 21
"RTN","VPRDJ04A",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDJ04A",4,0)
 ;
"RTN","VPRDJ04A",5,0)
 ; External References          DBIA#
"RTN","VPRDJ04A",6,0)
 ; -------------------          -----
"RTN","VPRDJ04A",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDJ04A",8,0)
 ; ^DGPM                         1865
"RTN","VPRDJ04A",9,0)
 ; ^DIC(42                      10039
"RTN","VPRDJ04A",10,0)
 ; ^DPT                         10035
"RTN","VPRDJ04A",11,0)
 ; ^SC                          10040
"RTN","VPRDJ04A",12,0)
 ; ^VA(200                      10060
"RTN","VPRDJ04A",13,0)
 ; DGPTFAPI                      3157
"RTN","VPRDJ04A",14,0)
 ; DIC                           2051
"RTN","VPRDJ04A",15,0)
 ; DILFD                         2055
"RTN","VPRDJ04A",16,0)
 ; DIQ                           2056
"RTN","VPRDJ04A",17,0)
 ; ICDEX                         5747
"RTN","VPRDJ04A",18,0)
 ; ICPTCOD                       1995
"RTN","VPRDJ04A",19,0)
 ; VADPT                        10061
"RTN","VPRDJ04A",20,0)
 ; XUAF4                         2171
"RTN","VPRDJ04A",21,0)
 ;
"RTN","VPRDJ04A",22,0)
 ; All tags expect DFN, ID, [VPRSTART, VPRSTOP, VPRMAX, VPRTEXT]
"RTN","VPRDJ04A",23,0)
 ;
"RTN","VPRDJ04A",24,0)
ADM(ID,DATE) ; -- admission [from VSIT1]
"RTN","VPRDJ04A",25,0)
 N ADM,VADMVT,VAIP,VAERR,MVT,SPEC,HLOC,FAC,ICD,I
"RTN","VPRDJ04A",26,0)
 S ID=$G(ID),DATE=+$G(DATE) Q:ID=""  ;Q:DATE<1
"RTN","VPRDJ04A",27,0)
 I ID S VAIP("D")=DATE,VST=+ID
"RTN","VPRDJ04A",28,0)
 I ID?1"H"1.N S VAIP("E")=+$E(ID,2,99),VST=0
"RTN","VPRDJ04A",29,0)
 D IN5^VADPT Q:'$G(VAIP(1))  ;deleted
"RTN","VPRDJ04A",30,0)
 S VADMVT=+$G(VAIP(13)),ID="H"_VADMVT
"RTN","VPRDJ04A",31,0)
 S ADM("localId")=ID,ADM("uid")=$$SETUID^VPRUTILS("visit",DFN,ID)
"RTN","VPRDJ04A",32,0)
 S:'DATE DATE=+$G(VAIP(13,1)) S:'VST VST=$$VISIT(DFN,DATE)
"RTN","VPRDJ04A",33,0)
 S (ADM("dateTime"),ADM("stay","arrivalDateTime"))=$$JSONDT^VPRUTILS(DATE)
"RTN","VPRDJ04A",34,0)
 S:$L($P(VAIP(6),U,2)) ADM("roomBed")=$P(VAIP(6),U,2)
"RTN","VPRDJ04A",35,0)
 S MVT=13,I=0 I VADMVT=$G(^DPT(DFN,.105)) D  ;if current admission,
"RTN","VPRDJ04A",36,0)
 . S ADM("current")="true",MVT=14            ; use last movement info
"RTN","VPRDJ04A",37,0)
 . S X=$G(^DPT(DFN,.101)) S:$L(X) ADM("roomBed")=X
"RTN","VPRDJ04A",38,0)
 . K VPRADMIT                                ;kill flag from VPRDJ0
"RTN","VPRDJ04A",39,0)
 S SPEC=$G(VAIP(MVT,6)),ADM("specialty")=$P(SPEC,U,2)
"RTN","VPRDJ04A",40,0)
 S X=$$SERV^VPRDVSIT(+SPEC),ADM("service")=X
"RTN","VPRDJ04A",41,0)
 S HLOC=+$G(^DIC(42,+$G(VAIP(MVT,4)),44)),FAC=$$FAC^VPRD(+HLOC) I HLOC D
"RTN","VPRDJ04A",42,0)
 . S ADM("locationUid")=$$SETUID^VPRUTILS("location",,+HLOC)
"RTN","VPRDJ04A",43,0)
 . S ADM("locationName")=$P($G(^SC(HLOC,0)),U)
"RTN","VPRDJ04A",44,0)
 . S X=$$AMIS^VPRDVSIT($P($G(^SC(HLOC,0)),U,7))
"RTN","VPRDJ04A",45,0)
 . S:$L($G(X)) ADM("stopCodeUid")="urn:va:stop-code:"_$P(X,U),ADM("stopCodeName")=$P(X,U,2)
"RTN","VPRDJ04A",46,0)
 . S ADM("summary")="${"_ADM("service")_"}:"_ADM("locationName")
"RTN","VPRDJ04A",47,0)
 D FACILITY^VPRUTILS(FAC,"ADM")
"RTN","VPRDJ04A",48,0)
 S ADM("categoryCode")="urn:va:encounter-category:AD",ADM("categoryName")="Admission"
"RTN","VPRDJ04A",49,0)
 S ADM("patientClassCode")="urn:va:patient-class:IMP",ADM("patientClassName")="Inpatient"
"RTN","VPRDJ04A",50,0)
 I $G(VAIP(17)) S ADM("stay","dischargeDateTime")=$$JSONDT^VPRUTILS(+$G(VAIP(17,1)))
"RTN","VPRDJ04A",51,0)
 I $G(VAIP(18)) S I=I+1 D PROV("ADM",I,+VAIP(18),"A")         ;attending
"RTN","VPRDJ04A",52,0)
 I $G(VAIP(MVT,5)) S I=I+1 D PROV("ADM",I,+VAIP(MVT,5),"P",1) ;primary
"RTN","VPRDJ04A",53,0)
 S ICD=$$POV^VPRDVSIT(VST,DATE) S:'ICD ICD=$$PTF^VPRDVSIT(DFN,VAIP(12),DATE) ;PTF>ICD
"RTN","VPRDJ04A",54,0)
 I $L(ICD)<3 S ADM("reasonName")=$G(VAIP(MVT,7))
"RTN","VPRDJ04A",55,0)
 E  D
"RTN","VPRDJ04A",56,0)
 . N SYS S SYS=$P(ICD,U,3),SYS=$$LOW^XLFSTR(SYS)
"RTN","VPRDJ04A",57,0)
 . S ADM("reasonUid")=$$SETNCS^VPRUTILS(SYS,ICD),ADM("reasonName")=$P(ICD,U,2)
"RTN","VPRDJ04A",58,0)
 S X=$$CPT^VPRDVSIT(VST),ADM("typeName")=$S(X:$P($$CPT^ICPTCOD(X),U,3),1:$$CATG^VPRDVSIT("H"))
"RTN","VPRDJ04A",59,0)
 D MVT(VADMVT)   ;sub-movements
"RTN","VPRDJ04A",60,0)
 D TIU(VST,.ADM) ;notes/summary
"RTN","VPRDJ04A",61,0)
 D ADD^VPRDJ("ADM","visit")
"RTN","VPRDJ04A",62,0)
 Q
"RTN","VPRDJ04A",63,0)
 ;
"RTN","VPRDJ04A",64,0)
TIU(VISIT,ARR) ; -- add notes to ARR("document")
"RTN","VPRDJ04A",65,0)
 N X,Y,I,SCR,VPRX,LT,NT,DA,CNT,VPRY
"RTN","VPRDJ04A",66,0)
 S SCR="I $P(^(0),U,5)>6,$P(^(0),U,5)<14"
"RTN","VPRDJ04A",67,0)
 D FIND^DIC(8925,,.01,"QX",+$G(VISIT),,"V",SCR,,"VPRX")
"RTN","VPRDJ04A",68,0)
 S Y="",(I,CNT)=0
"RTN","VPRDJ04A",69,0)
 F  S I=$O(VPRX("DILIST",1,I)) Q:I<1  D
"RTN","VPRDJ04A",70,0)
 . S LT=$G(VPRX("DILIST","ID",I,.01)) Q:$P(LT," ")="Addendum"
"RTN","VPRDJ04A",71,0)
 . S DA=$G(VPRX("DILIST",2,I))
"RTN","VPRDJ04A",72,0)
 . S NT=$$GET1^DIQ(8925,+DA_",",".01:1501")
"RTN","VPRDJ04A",73,0)
 . S CNT=CNT+1,ARR("documents",CNT,"uid")=$$SETUID^VPRUTILS("document",DFN,+DA)
"RTN","VPRDJ04A",74,0)
 . S ARR("documents",CNT,"localTitle")=LT
"RTN","VPRDJ04A",75,0)
 . S:$L(NT) ARR("documents",CNT,"nationalTitle")=NT
"RTN","VPRDJ04A",76,0)
 Q
"RTN","VPRDJ04A",77,0)
 ;
"RTN","VPRDJ04A",78,0)
PROV(ARR,I,IEN,ROLE,PRIM) ; -- add providers
"RTN","VPRDJ04A",79,0)
 S @ARR@("providers",I,"providerUid")=$$SETUID^VPRUTILS("user",,+IEN)
"RTN","VPRDJ04A",80,0)
 S @ARR@("providers",I,"providerName")=$P($G(^VA(200,+IEN,0)),U)
"RTN","VPRDJ04A",81,0)
 S @ARR@("providers",I,"role")=ROLE
"RTN","VPRDJ04A",82,0)
 S:$G(PRIM) @ARR@("providers",I,"primary")="true"
"RTN","VPRDJ04A",83,0)
 Q
"RTN","VPRDJ04A",84,0)
 ;
"RTN","VPRDJ04A",85,0)
MVT(CA) ; -- add movements to ADM("movement",i,"attribute")
"RTN","VPRDJ04A",86,0)
 N DATE,DA,CNT,X S (DATE,CNT)=0
"RTN","VPRDJ04A",87,0)
 F  S DATE=$O(^DGPM("APCA",DFN,CA,DATE)) Q:DATE<1  S DA=+$O(^(DATE,0)) I DA'=CA D
"RTN","VPRDJ04A",88,0)
 . S X0=$G(^DGPM(DA,0)),CNT=CNT+1
"RTN","VPRDJ04A",89,0)
 . S ADM("movements",CNT,"localId")=DA
"RTN","VPRDJ04A",90,0)
 . S ADM("movements",CNT,"dateTime")=$$JSONDT^VPRUTILS(DATE)
"RTN","VPRDJ04A",91,0)
 . S ADM("movements",CNT,"movementType")=$$EXTERNAL^DILFD(405,.02,,$P(X0,U,2))
"RTN","VPRDJ04A",92,0)
 . S X=+$P(X0,U,19) I X D
"RTN","VPRDJ04A",93,0)
 .. S ADM("movements",CNT,"providerUid")=$$SETUID^VPRUTILS("user",,X)
"RTN","VPRDJ04A",94,0)
 .. S ADM("movements",CNT,"providerName")=$P($G(^VA(200,X,0)),U)
"RTN","VPRDJ04A",95,0)
 . S X=+$P(X0,U,9)
"RTN","VPRDJ04A",96,0)
 . S:X ADM("movements",CNT,"specialty")=$$EXTERNAL^DILFD(405,.09,,X)
"RTN","VPRDJ04A",97,0)
 . S HLOC=+$G(^DIC(42,+$P(X0,U,6),44)),FAC=$$FAC^VPRD(HLOC) I HLOC D
"RTN","VPRDJ04A",98,0)
 .. S ADM("movements",CNT,"locationUid")=$$SETUID^VPRUTILS("location",,HLOC)
"RTN","VPRDJ04A",99,0)
 .. S ADM("movements",CNT,"locationName")=$P($G(^SC(HLOC,0)),U)
"RTN","VPRDJ04A",100,0)
 Q
"RTN","VPRDJ04A",101,0)
 ;
"RTN","VPRDJ04A",102,0)
PTFA(ID) ; -- find ID in ^TMP("VPRPX",$J), fall thru to PX1 if successful
"RTN","VPRDJ04A",103,0)
 N IDT S (IDT,VPRIDT)=0
"RTN","VPRDJ04A",104,0)
 F  S IDT=$O(^TMP("VPRPX",$J,IDT)) Q:IDT<1  I $D(^(IDT,ID)) S VPRIDT=IDT Q
"RTN","VPRDJ04A",105,0)
 Q:VPRIDT<1  ;not found
"RTN","VPRDJ04A",106,0)
PTF1 ; -- PTF where ID=iens;TYPE
"RTN","VPRDJ04A",107,0)
 ;   Expects ^TMP("VPRPX",$J,VPRIDT,ID)=ITM^[DISCHARGE]DATE^SYS
"RTN","VPRDJ04A",108,0)
 N TMP,PTF,ADM,DIS,VAIN,VAINDT,HLOC,FAC,X,Y,VISIT,X0
"RTN","VPRDJ04A",109,0)
 ; PTF^DGPTPXRM(+ID,.VPRF)
"RTN","VPRDJ04A",110,0)
 S TMP=$G(^TMP("VPRPX",$J,VPRIDT,ID))
"RTN","VPRDJ04A",111,0)
 ;
"RTN","VPRDJ04A",112,0)
 S PTF("localId")=ID,PTF("uid")=$$SETUID^VPRUTILS("ptf",DFN,ID)
"RTN","VPRDJ04A",113,0)
 S P=$L(ID,";"),TYPE=$P(ID,";",P) S:TYPE="DXLS" PTF("principalDx")="true"
"RTN","VPRDJ04A",114,0)
 S X=$$ICDDX^ICDEX($P(TMP,U),$P(TMP,U,2),,"E")
"RTN","VPRDJ04A",115,0)
 S Y=$$LOW^XLFSTR($$SAB^ICDEX($P(X,U,20))) ;coding system
"RTN","VPRDJ04A",116,0)
 S PTF("icdCode")=$$SETNCS^VPRUTILS(Y,$P(X,U,2)),PTF("icdName")=$P(X,U,4)
"RTN","VPRDJ04A",117,0)
 S DIS=$P(TMP,U,2) S:DIS VAINDT=DIS-.0001 D INP^VADPT
"RTN","VPRDJ04A",118,0)
 S ADM=+$G(VAIN(7)),HLOC=+$G(^DIC(42,+$G(VAIN(4)),44))
"RTN","VPRDJ04A",119,0)
 S:ADM PTF("arrivalDateTime")=$$JSONDT^VPRUTILS(ADM)
"RTN","VPRDJ04A",120,0)
 S:DIS PTF("dischargeDateTime")=$$JSONDT^VPRUTILS(DIS)
"RTN","VPRDJ04A",121,0)
 S FAC=$$FAC^VPRD(HLOC)
"RTN","VPRDJ04A",122,0)
 S VISIT=+$$VISIT(DFN,ADM) I VISIT D
"RTN","VPRDJ04A",123,0)
 . S PTF("encounterUid")=$$SETUID^VPRUTILS("visit",DFN,VISIT)
"RTN","VPRDJ04A",124,0)
 . S PTF("encounterName")=$$NAME^VPRDJ04(VISIT) Q:FAC
"RTN","VPRDJ04A",125,0)
 . S X0=$G(^AUPNVSIT(+VISIT,0)),FAC=+$P(X0,U,6)
"RTN","VPRDJ04A",126,0)
 . S:FAC X=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDJ04A",127,0)
 . S:'FAC X=$$FAC^VPRD(+$P(X0,U,22)) ;location
"RTN","VPRDJ04A",128,0)
 D:FAC FACILITY^VPRUTILS(FAC,"PTF")
"RTN","VPRDJ04A",129,0)
 D ADD^VPRDJ("PTF","ptf")
"RTN","VPRDJ04A",130,0)
 Q
"RTN","VPRDJ04A",131,0)
 ;
"RTN","VPRDJ04A",132,0)
VISIT(DFN,DATE) ; -- Return visit# for admission
"RTN","VPRDJ04A",133,0)
 N X,Y
"RTN","VPRDJ04A",134,0)
 S X=9999999-$P(DATE,".")_"."_$P(DATE,".",2)
"RTN","VPRDJ04A",135,0)
 S Y=+$O(^AUPNVSIT("AAH",DFN,X,0))
"RTN","VPRDJ04A",136,0)
 Q Y
"RTN","VPRDJ09")
0^26^B36288746^B37647658
"RTN","VPRDJ09",1,0)
VPRDJ09 ;SLC/MKB -- PCE ;8/2/11  15:29
"RTN","VPRDJ09",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**2,5**;Sep 01, 2011;Build 21
"RTN","VPRDJ09",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDJ09",4,0)
 ;
"RTN","VPRDJ09",5,0)
 ; External References          DBIA#
"RTN","VPRDJ09",6,0)
 ; -------------------          -----
"RTN","VPRDJ09",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDJ09",8,0)
 ; ^PXRMINDX                     4290
"RTN","VPRDJ09",9,0)
 ; ^SC                          10040
"RTN","VPRDJ09",10,0)
 ; ^VA(200                      10060
"RTN","VPRDJ09",11,0)
 ; DIC                           2051
"RTN","VPRDJ09",12,0)
 ; DILFD                         2055
"RTN","VPRDJ09",13,0)
 ; DIQ                           2056
"RTN","VPRDJ09",14,0)
 ; PXAPI,^TMP("PXKENC"           1894
"RTN","VPRDJ09",15,0)
 ; VALM1                        10116
"RTN","VPRDJ09",16,0)
 ; XUAF4                         2171
"RTN","VPRDJ09",17,0)
 ;
"RTN","VPRDJ09",18,0)
 ; All tags expect DFN, ID, [VPRSTART, VPRSTOP, VPRMAX, VPRTEXT]
"RTN","VPRDJ09",19,0)
 ;
"RTN","VPRDJ09",20,0)
PX(FNUM) ; -- PCE item(s)
"RTN","VPRDJ09",21,0)
 N VPRIDT,ID
"RTN","VPRDJ09",22,0)
 D SORT ;sort ^PXRMINDX into ^TMP("VPRPX",$J,IDT)
"RTN","VPRDJ09",23,0)
 S VPRIDT=0 F  S VPRIDT=$O(^TMP("VPRPX",$J,VPRIDT)) Q:VPRIDT<1  D  Q:VPRI'<VPRMAX
"RTN","VPRDJ09",24,0)
 . S ID=0 F  S ID=$O(^TMP("VPRPX",$J,VPRIDT,ID)) Q:ID<1  D  Q:VPRI'<VPRMAX
"RTN","VPRDJ09",25,0)
 .. I $G(VPRID),ID'=VPRID Q
"RTN","VPRDJ09",26,0)
 .. D PX1
"RTN","VPRDJ09",27,0)
 K ^TMP("VPRPX",$J)
"RTN","VPRDJ09",28,0)
 Q
"RTN","VPRDJ09",29,0)
 ;
"RTN","VPRDJ09",30,0)
PX1 ; -- PCE ^TMP("VPRPX",$J,VPRIDT,ID)=ITM^DATE for FNUM
"RTN","VPRDJ09",31,0)
 N N,COLL,TAG,VPRF,FLD,TMP,VISIT,X0,X12,FAC,LOC,X,Y,PCE
"RTN","VPRDJ09",32,0)
 S N=+$P(FNUM,".",2),TAG=$S(N=7:"VPOV",N=11:"VIMM",N=12:"VSKIN",N=13:"VXAM",N=16:"VPEDU",N=18:"VCPT",1:"VHF")
"RTN","VPRDJ09",33,0)
 D @(TAG_"^PXPXRM(ID,.VPRF)")
"RTN","VPRDJ09",34,0)
 ;
"RTN","VPRDJ09",35,0)
 S PCE("localId")=ID,TMP=$G(^TMP("VPRPX",$J,VPRIDT,ID))
"RTN","VPRDJ09",36,0)
 S COLL=$S(N=7:"pov",N=11:"immunization",N=12:"skin",N=13:"exam",N=16:"education",N=18:"cpt",1:"factor")
"RTN","VPRDJ09",37,0)
 S PCE("uid")=$$SETUID^VPRUTILS(COLL,DFN,ID)
"RTN","VPRDJ09",38,0)
 ; TAG=$S(N=23:"recorded",N=11:"administeredDateTime",1:"dateTimeEntered")
"RTN","VPRDJ09",39,0)
 S TAG=$S(N=11:"administeredDateTime",1:"entered")
"RTN","VPRDJ09",40,0)
 S PCE(TAG)=$$JSONDT^VPRUTILS($P(TMP,U,2))
"RTN","VPRDJ09",41,0)
 S PCE("name")=$S($P(TMP,U,3)="10D":$P(TMP,U),1:$$EXTERNAL^DILFD(FNUM,.01,,+TMP))
"RTN","VPRDJ09",42,0)
 S VISIT=+$G(VPRF("VISIT")),PCE("encounterUid")=$$SETUID^VPRUTILS("visit",DFN,VISIT)
"RTN","VPRDJ09",43,0)
 S PCE("encounterName")=$$NAME^VPRDJ04(VISIT)
"RTN","VPRDJ09",44,0)
 S X0=$G(^AUPNVSIT(+VISIT,0)),FAC=+$P(X0,U,6),LOC=+$P(X0,U,22)
"RTN","VPRDJ09",45,0)
 S:FAC X=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDJ09",46,0)
 S:'FAC X=$$FAC^VPRD(LOC)
"RTN","VPRDJ09",47,0)
 D FACILITY^VPRUTILS(X,"PCE")
"RTN","VPRDJ09",48,0)
 S:LOC PCE("locationUid")=$$SETUID^VPRUTILS("location",,LOC),PCE("locationName")=$P($G(^SC(LOC,0)),U)
"RTN","VPRDJ09",49,0)
 S X=$G(VPRF("COMMENTS")) S:$L(X) PCE("comment")=X
"RTN","VPRDJ09",50,0)
POV I FNUM=9000010.07 D  G PXQ
"RTN","VPRDJ09",51,0)
 . S X=$G(VPRF("PRIMARY/SECONDARY")),PCE("type")=$S($L(X):X,1:"U")
"RTN","VPRDJ09",52,0)
 . S Y=$$LOW^XLFSTR($P(TMP,U,3)) ;coding system
"RTN","VPRDJ09",53,0)
 . S X=PCE("name"),PCE("icdCode")=$$SETNCS^VPRUTILS(Y,X)
"RTN","VPRDJ09",54,0)
 . S X=$G(VPRF("PROVIDER NARRATIVE")),PCE("name")=$$EXTERNAL^DILFD(9000010.07,.04,,X)
"RTN","VPRDJ09",55,0)
CPT I FNUM=9000010.18 D  G PXQ
"RTN","VPRDJ09",56,0)
 . S X=$G(VPRF("PRINCIPAL PROCEDURE")),PCE("type")=$S($L(X):X,1:"U")
"RTN","VPRDJ09",57,0)
 . S X=PCE("name"),PCE("cptCode")=$$SETNCS^VPRUTILS("cpt",X)
"RTN","VPRDJ09",58,0)
 . S X=$G(VPRF("PROVIDER NARRATIVE")),PCE("name")=$$EXTERNAL^DILFD(9000010.18,.04,,X)
"RTN","VPRDJ09",59,0)
 . S PCE("quantity")=VPRF("QUANTITY")
"RTN","VPRDJ09",60,0)
 S X=$G(VPRF("VALUE")),FLD=$S(FNUM=9000010.16:.06,1:.04)
"RTN","VPRDJ09",61,0)
 S Y=$$EXTERNAL^DILFD(FNUM,FLD,,X)
"RTN","VPRDJ09",62,0)
IM I FNUM=9000010.11 D  G PXQ ;immunization
"RTN","VPRDJ09",63,0)
 . S:$L(Y) PCE("seriesName")=Y,PCE("seriesCode")=$$SETUID^VPRUTILS("series",DFN,Y)
"RTN","VPRDJ09",64,0)
 . S X=$G(VPRF("REACTION")) I $L(X) D
"RTN","VPRDJ09",65,0)
 .. S PCE("reactionName")=$$EXTERNAL^DILFD(9000010.11,.06,,X)
"RTN","VPRDJ09",66,0)
 .. S PCE("reactionCode")=$$SETUID^VPRUTILS("reaction",DFN,X)
"RTN","VPRDJ09",67,0)
 . S PCE("contraindicated")=$S(+$G(VPRF("CONTRAINDICATED")):"true",1:"false")
"RTN","VPRDJ09",68,0)
 . I '$D(^TMP("PXKENC",$J,VISIT)) D ENCEVENT^PXAPI(VISIT,1)
"RTN","VPRDJ09",69,0)
 . S X12=$G(^TMP("PXKENC",$J,VISIT,"IMM",ID,12))
"RTN","VPRDJ09",70,0)
 . S X=$P(X12,U,4) S:'X X=$P(X12,U,2)
"RTN","VPRDJ09",71,0)
 . I 'X S I=0 F  S I=$O(^TMP("PXKENC",$J,VISIT,"PRV",I)) Q:I<1  I $P($G(^(I,0)),U,4)="P" S X=+^(0) Q
"RTN","VPRDJ09",72,0)
 . S:X PCE("performerUid")=$$SETUID^VPRUTILS("user",,+X),PCE("performerName")=$P($G(^VA(200,X,0)),U)
"RTN","VPRDJ09",73,0)
 . ; CPT mapping
"RTN","VPRDJ09",74,0)
 . S X=+$$FIND1^DIC(811.1,,"QX",+TMP_";AUTTIMM(","B") I X>0 D
"RTN","VPRDJ09",75,0)
 .. S Y=$$GET1^DIQ(811.1,X_",",.02,"I") Q:Y<1
"RTN","VPRDJ09",76,0)
 .. N CPT S CPT=$G(@(U_$P(Y,";",2)_+Y_",0)"))
"RTN","VPRDJ09",77,0)
 .. S PCE("cptCode")=$$SETNCS^VPRUTILS("cpt",+CPT)
"RTN","VPRDJ09",78,0)
 .. S (PCE("summary"),PCE("cptName"))=$P(CPT,U,2)
"RTN","VPRDJ09",79,0)
HF I FNUM=9000010.23 D  G PXQ ;health factor
"RTN","VPRDJ09",80,0)
 . S:$L(X) PCE("severityUid")=$$SETVURN^VPRUTILS("factor-severity",X),PCE("severityName")=$$LOWER^VALM1(Y)
"RTN","VPRDJ09",81,0)
 . S X=$$GET1^DIQ(9999999.64,+TMP_",",.03,"I") I X D
"RTN","VPRDJ09",82,0)
 .. S PCE("categoryUid")=$$SETVURN^VPRUTILS("factor-category",X)
"RTN","VPRDJ09",83,0)
 .. S PCE("categoryName")=$$EXTERNAL^DILFD(9999999.64,.03,"",X)
"RTN","VPRDJ09",84,0)
 . S X=$$GET1^DIQ(9999999.64,+TMP_",",.08)
"RTN","VPRDJ09",85,0)
 . I $E(X)="Y" S PCE("display")="true"
"RTN","VPRDJ09",86,0)
 . S PCE("kind")="Health Factor",PCE("summary")=PCE("name")
"RTN","VPRDJ09",87,0)
SK I FNUM=9000010.12 D  ;skin test [fall thru to set result]
"RTN","VPRDJ09",88,0)
 . S X=$G(VPRF("READING")) S:$L(X) PCE("reading")=X
"RTN","VPRDJ09",89,0)
 . S X=$G(VPRF("DATE READ")) S:X PCE("dateRead")=$$JSONDT^VPRUTILS(X)
"RTN","VPRDJ09",90,0)
 S:$L(Y) PCE("result")=Y
"RTN","VPRDJ09",91,0)
PXQ ;finish
"RTN","VPRDJ09",92,0)
 D ADD^VPRDJ("PCE",COLL)
"RTN","VPRDJ09",93,0)
 Q
"RTN","VPRDJ09",94,0)
 ;
"RTN","VPRDJ09",95,0)
SORT ; -- build ^TMP("VPRPX",$J,9999999-DATE,DA)=ITEM^DATE^[SYS] in range
"RTN","VPRDJ09",96,0)
 ;  Expects VPRSTART and VPRSTOP
"RTN","VPRDJ09",97,0)
 N TYPE,ITEM,DATE,DA,IDT,SYS K ^TMP("VPRPX",$J)
"RTN","VPRDJ09",98,0)
 I FNUM=9000010.07!(FNUM=9000010.18) D  Q
"RTN","VPRDJ09",99,0)
 . N INDEX
"RTN","VPRDJ09",100,0)
 . S INDEX=$NA(^PXRMINDX(FNUM)) D PPI(INDEX)
"RTN","VPRDJ09",101,0)
 . I FNUM=9000010.07 S INDEX=$NA(^PXRMINDX(FNUM,"10D")) D PPI(INDEX)
"RTN","VPRDJ09",102,0)
PI ; from ^PXRMINDX(FNUM,"PI",DFN,ITEM,DATE,DA)
"RTN","VPRDJ09",103,0)
 S ITEM=0 F  S ITEM=$O(^PXRMINDX(FNUM,"PI",+$G(DFN),ITEM)) Q:ITEM<1  D
"RTN","VPRDJ09",104,0)
 . S DATE=0 F  S DATE=$O(^PXRMINDX(FNUM,"PI",+$G(DFN),ITEM,DATE)) Q:DATE<1  D
"RTN","VPRDJ09",105,0)
 .. Q:DATE<VPRSTART  Q:DATE>VPRSTOP  S IDT=9999999-DATE
"RTN","VPRDJ09",106,0)
 .. S DA=0 F  S DA=$O(^PXRMINDX(FNUM,"PI",+$G(DFN),ITEM,DATE,DA)) Q:DA<1  S ^TMP("VPRPX",$J,IDT,DA)=ITEM_U_DATE
"RTN","VPRDJ09",107,0)
 Q
"RTN","VPRDJ09",108,0)
PPI(INDX) ; from ^PXRMINDX(FNUM,["10D",]"PPI",DFN,TYPE,ITEM,DATE,DA)
"RTN","VPRDJ09",109,0)
 S TYPE="" F  S TYPE=$O(@INDX@("PPI",+$G(DFN),TYPE)) Q:TYPE=""  D
"RTN","VPRDJ09",110,0)
 . S ITEM="" F  S ITEM=$O(@INDX@("PPI",+$G(DFN),TYPE,ITEM)) Q:ITEM=""  D
"RTN","VPRDJ09",111,0)
 .. S DATE=0 F  S DATE=$O(@INDX@("PPI",+$G(DFN),TYPE,ITEM,DATE)) Q:DATE<1  D
"RTN","VPRDJ09",112,0)
 ... Q:DATE<VPRSTART  Q:DATE>VPRSTOP  S IDT=9999999-DATE
"RTN","VPRDJ09",113,0)
 ... S SYS=$S(INDX["10D":"10D",INDX[".07":"ICD",1:"CPT")
"RTN","VPRDJ09",114,0)
 ... S DA=0 F  S DA=$O(@INDX@("PPI",+$G(DFN),TYPE,ITEM,DATE,DA)) Q:DA<1  S ^TMP("VPRPX",$J,IDT,DA)=ITEM_U_DATE_U_SYS
"RTN","VPRDJ09",115,0)
 Q
"RTN","VPRDJ09",116,0)
PTF ; from ^PXRMINDX(45,"ICD","PNI",DFN,TYPE,ITEM,DATE,DA)
"RTN","VPRDJ09",117,0)
 ;  Expects VPRSTART and VPRSTOP
"RTN","VPRDJ09",118,0)
 N SYS,TYPE,ITEM,DATE,IDT,DA
"RTN","VPRDJ09",119,0)
 F SYS="ICD","10D" D
"RTN","VPRDJ09",120,0)
 .S TYPE="" F  S TYPE=$O(^PXRMINDX(45,SYS,"PNI",+$G(DFN),TYPE)) Q:TYPE=""  D
"RTN","VPRDJ09",121,0)
 .. S ITEM=0 F  S ITEM=$O(^PXRMINDX(45,SYS,"PNI",+$G(DFN),TYPE,ITEM)) Q:ITEM<1  D
"RTN","VPRDJ09",122,0)
 ... S DATE=0 F  S DATE=$O(^PXRMINDX(45,SYS,"PNI",+$G(DFN),TYPE,ITEM,DATE)) Q:DATE<1  D
"RTN","VPRDJ09",123,0)
 .... Q:DATE<VPRSTART  Q:DATE>VPRSTOP  S IDT=9999999-DATE
"RTN","VPRDJ09",124,0)
 .... S DA="" F  S DA=$O(^PXRMINDX(45,SYS,"PNI",+$G(DFN),TYPE,ITEM,DATE,DA)) Q:DA=""  S ^TMP("VPRPX",$J,IDT,DA_";"_TYPE)=ITEM_U_DATE_U_SYS
"RTN","VPRDJ09",125,0)
 Q
"RTN","VPRDLR")
0^19^B29963842^B24009801
"RTN","VPRDLR",1,0)
VPRDLR ;SLC/MKB -- Laboratory extract ;8/2/11  15:29
"RTN","VPRDLR",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**2,5**;Sep 01, 2011;Build 21
"RTN","VPRDLR",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDLR",4,0)
 ;
"RTN","VPRDLR",5,0)
 ; External References          DBIA#
"RTN","VPRDLR",6,0)
 ; -------------------          -----
"RTN","VPRDLR",7,0)
 ; ^DPT                         10035
"RTN","VPRDLR",8,0)
 ; ^LAB(60                      10054
"RTN","VPRDLR",9,0)
 ; ^LAB(61                        524
"RTN","VPRDLR",10,0)
 ; ^LRO(69                       2407
"RTN","VPRDLR",11,0)
 ; ^LR                            525
"RTN","VPRDLR",12,0)
 ; DIC                           2051
"RTN","VPRDLR",13,0)
 ; DIQ                           2056
"RTN","VPRDLR",14,0)
 ; LR7OR1,^TMP("LRRR",$J)        2503
"RTN","VPRDLR",15,0)
 ; LRPXAPIU                      4246
"RTN","VPRDLR",16,0)
 ; XUAF4                         2171
"RTN","VPRDLR",17,0)
 ;
"RTN","VPRDLR",18,0)
 ; ------------ Get results from VistA ------------
"RTN","VPRDLR",19,0)
 ;
"RTN","VPRDLR",20,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's lab results
"RTN","VPRDLR",21,0)
 N VPRSUB,VPRIDT,VPRN,VPRP,VPRITM,LRDFN,SUB,X
"RTN","VPRDLR",22,0)
 S DFN=+$G(DFN) Q:$G(DFN)<1
"RTN","VPRDLR",23,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDLR",24,0)
 S LRDFN=$G(^DPT(DFN,"LR")),VPRSUB=$G(FILTER("type"),"CH")
"RTN","VPRDLR",25,0)
 K ^TMP("LRRR",$J,DFN)
"RTN","VPRDLR",26,0)
 ;
"RTN","VPRDLR",27,0)
 ; get result(s)
"RTN","VPRDLR",28,0)
 I $L($G(ID)) D  ;reset for LR7OR1
"RTN","VPRDLR",29,0)
 . S VPRSUB=$P(ID,";"),VPRIDT=+$P(ID,";",2)
"RTN","VPRDLR",30,0)
 . S:VPRIDT (BEG,END)=9999999-VPRIDT
"RTN","VPRDLR",31,0)
 ;
"RTN","VPRDLR",32,0)
 D RR^LR7OR1(DFN,,BEG,END,VPRSUB,,,MAX)
"RTN","VPRDLR",33,0)
 S VPRSUB="" F  S VPRSUB=$O(^TMP("LRRR",$J,DFN,VPRSUB)) Q:VPRSUB=""  D
"RTN","VPRDLR",34,0)
 . S VPRIDT=0 F  S VPRIDT=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT)) Q:VPRIDT<1  D
"RTN","VPRDLR",35,0)
 .. S VPRP=0 F  S VPRP=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT,VPRP)) Q:VPRP<1  S X=+$G(^(VPRP)) D
"RTN","VPRDLR",36,0)
 ... S VPRN=$$LRDN^LRPXAPIU(X) I $L($G(ID),";")>2,VPRN'=$P(ID,";",3) Q
"RTN","VPRDLR",37,0)
 ... K VPRITM S SUB=$S("CH^MI"[VPRSUB:VPRSUB,1:"AP")_"(.VPRITM)"
"RTN","VPRDLR",38,0)
 ... D @SUB,XML(.VPRITM):$D(VPRITM)
"RTN","VPRDLR",39,0)
 K ^TMP("LRRR",$J,DFN)
"RTN","VPRDLR",40,0)
 Q
"RTN","VPRDLR",41,0)
 ;
"RTN","VPRDLR",42,0)
CH(LAB) ; -- return a Chemistry result in LAB("attribute")=value
"RTN","VPRDLR",43,0)
 ;      Expects ^TMP("LRRR",$J,DFN,"CH",VPRIDT,VPRP),VPRN,LRDFN
"RTN","VPRDLR",44,0)
 N X0,CDT,LR0,LRI,X,LOINC,ORD,CMMT K LAB
"RTN","VPRDLR",45,0)
 S X0=$G(^TMP("LRRR",$J,DFN,"CH",VPRIDT,VPRP))
"RTN","VPRDLR",46,0)
 S LAB("id")="CH;"_VPRIDT_";"_VPRN,LAB("type")="CH"
"RTN","VPRDLR",47,0)
 S CDT=9999999-VPRIDT,LAB("collected")=CDT
"RTN","VPRDLR",48,0)
 S LR0=$G(^LR(LRDFN,"CH",VPRIDT,0)),LRI=$G(^(VPRN))
"RTN","VPRDLR",49,0)
 S LAB("status")="completed",LAB("resulted")=$P(LR0,U,3)
"RTN","VPRDLR",50,0)
 S LAB("test")=$P($G(^LAB(60,+X0,0)),U) ;$P(X0,U,10)?
"RTN","VPRDLR",51,0)
 S:$L($P(X0,U,2)) LAB("result")=$P(X0,U,2)
"RTN","VPRDLR",52,0)
 S:$L($P(X0,U,4)) LAB("units")=$P(X0,U,4)
"RTN","VPRDLR",53,0)
 S:$L($P(X0,U,3)) LAB("interpretation")=$P(X0,U,3)
"RTN","VPRDLR",54,0)
 S X=$P(X0,U,5) I $L(X),X["-" S LAB("low")=$$TRIM^XLFSTR($P(X,"-")),LAB("high")=$$TRIM^XLFSTR($P(X,"-",2))
"RTN","VPRDLR",55,0)
 S LAB("localName")=$S($L($P(X0,U,15)):$P(X0,U,15),1:LAB("test"))
"RTN","VPRDLR",56,0)
 S LAB("groupName")=$P(X0,U,16) ;accession#
"RTN","VPRDLR",57,0)
 S X=+$P(X0,U,19) I X D  ;specimen
"RTN","VPRDLR",58,0)
 . N IENS,VPRY S IENS=X_","
"RTN","VPRDLR",59,0)
 . D GETS^DIQ(61,IENS,".01;2",,"VPRY")
"RTN","VPRDLR",60,0)
 . S LAB("specimen")=$G(VPRY(61,IENS,2))_U_$G(VPRY(61,IENS,.01)) ;SNOMED^name
"RTN","VPRDLR",61,0)
 . S LAB("sample")=$$GET1^DIQ(61,X_",",4.1) ;name
"RTN","VPRDLR",62,0)
 S ORD=+$P(X0,U,17) S:ORD LAB("labOrderID")=ORD
"RTN","VPRDLR",63,0)
 S X=$$ORDER(ORD,+X0) S:X LAB("orderID")=X
"RTN","VPRDLR",64,0)
 S X=$P($P(LRI,U,3),"!",3) S:X LOINC=$$GET1^DIQ(95.3,X_",",.01)
"RTN","VPRDLR",65,0)
 I $G(LOINC) S LAB("loinc")=LOINC,LAB("vuid")=$$VUID^VPRD(+LOINC,95.3)
"RTN","VPRDLR",66,0)
 S X=$P(LRI,U,9) S:X LAB("performingLab")=$$NAME^XUAF4(X)
"RTN","VPRDLR",67,0)
 S X=+$P(LR0,U,10) S:X LAB("provider")=X_U_$P($G(^VA(200,X,0)),U)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDLR",68,0)
 S X=$P(LR0,U,14) S:X LAB("facility")=$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U)
"RTN","VPRDLR",69,0)
 I 'X S LAB("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDLR",70,0)
 I $D(^TMP("LRRR",$J,DFN,"CH",VPRIDT,"N")) M CMMT=^("N") S LAB("comment")=$$STRING^VPRD(.CMMT)
"RTN","VPRDLR",71,0)
 Q
"RTN","VPRDLR",72,0)
 ;
"RTN","VPRDLR",73,0)
ORDER(LABORD,TEST) ; -- return #100 order for Lab order# & Test
"RTN","VPRDLR",74,0)
 N Y,D,S,T S Y=""
"RTN","VPRDLR",75,0)
 S D=$O(^LRO(69,"C",LABORD,0)) I D D
"RTN","VPRDLR",76,0)
 . S S=0 F  S S=$O(^LRO(69,"C",LABORD,D,S)) Q:S<1  D
"RTN","VPRDLR",77,0)
 .. S T=0 F  S T=$O(^LRO(69,D,1,S,2,T)) Q:T<1  I +$G(^(T,0))=TEST S Y=+$P(^(0),U,7)
"RTN","VPRDLR",78,0)
 Q Y
"RTN","VPRDLR",79,0)
 ;
"RTN","VPRDLR",80,0)
MI(LAB) ; -- return a Microbiology result in LAB("attribute")=value
"RTN","VPRDLR",81,0)
 ;    Expects ^TMP("LRRR",$J,DFN,"MI",VPRIDT,VPRP),LRDFN
"RTN","VPRDLR",82,0)
 N ID,CDT,X0,X,CMMT,LR0 K LAB
"RTN","VPRDLR",83,0)
 S X0=$G(^TMP("LRRR",$J,DFN,"MI",VPRIDT,VPRP)) Q:$L($P(X0,U))'>1
"RTN","VPRDLR",84,0)
 S LAB("id")="MI;"_VPRIDT_"#"_VPRP,LAB("status")="completed"
"RTN","VPRDLR",85,0)
 S LAB("type")="MI",CDT=9999999-VPRIDT,LAB("collected")=CDT
"RTN","VPRDLR",86,0)
 S LR0=$G(^LR(LRDFN,"MI",VPRIDT,0)),LAB("resulted")=$P(LR0,U,3)
"RTN","VPRDLR",87,0)
 I '$P(LR0,U,3) S LAB("status")="incomplete"
"RTN","VPRDLR",88,0)
 S:$L($P(X0,U,2)) LAB("result")=$P(X0,U,2)
"RTN","VPRDLR",89,0)
 S:$L($P(X0,U,4)) LAB("units")=$P(X0,U,4)
"RTN","VPRDLR",90,0)
 S:$L($P(X0,U,3)) LAB("interpretation")=$P(X0,U,3)
"RTN","VPRDLR",91,0)
 S (LAB("test"),LAB("localName"))=$P(X0,U,15)
"RTN","VPRDLR",92,0)
 S X=+$P(X0,U,19) I X D  ;specimen
"RTN","VPRDLR",93,0)
 . N IENS,VPRY S IENS=X_","
"RTN","VPRDLR",94,0)
 . D GETS^DIQ(61,IENS,".01;2",,"VPRY")
"RTN","VPRDLR",95,0)
 . S LAB("specimen")=$G(VPRY(61,IENS,2))_U_$G(VPRY(61,IENS,.01)) ;SNOMED^name
"RTN","VPRDLR",96,0)
 . S LAB("sample")=$$GET1^DIQ(61,X_",",4.1) ;name
"RTN","VPRDLR",97,0)
 S X=+$P(LR0,U,7) S:X LAB("provider")=X_U_$P($G(^VA(200,X,0)),U)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDLR",98,0)
 S X=$P(LR0,U,14)
"RTN","VPRDLR",99,0)
 S:X LAB("facility")=$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U)
"RTN","VPRDLR",100,0)
 I 'X S LAB("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDLR",101,0)
 I $D(^TMP("LRRR",$J,DFN,"MI",VPRIDT,"N")) M CMMT=^("N") S LAB("comment")=$$STRING^VPRD(.CMMT)
"RTN","VPRDLR",102,0)
 Q
"RTN","VPRDLR",103,0)
 ;
"RTN","VPRDLR",104,0)
AP(LAB) ; -- return a Pathology result in LAB("attribute")=value
"RTN","VPRDLR",105,0)
 K LAB  ;implemented in VPRDLRA
"RTN","VPRDLR",106,0)
 Q
"RTN","VPRDLR",107,0)
 ;
"RTN","VPRDLR",108,0)
LOINC(DFN,ORPK,TEST) ; -- return LOINC code for ordered TEST
"RTN","VPRDLR",109,0)
 N LRDT,LRN,Y Q:$P(ORPK,";",4)'="CH" ""
"RTN","VPRDLR",110,0)
 S LRDT=$$LRIDT^LRPXAPIU($P(ORPK,";",5)),Y=""
"RTN","VPRDLR",111,0)
 D VALUE^LRPXAPI(.LRN,DFN,LRDT,TEST) ;LRN="" if panel
"RTN","VPRDLR",112,0)
 S X=$P($P(LRN,U,3),"!",3) S:X Y=$$GET1^DIQ(95.3,X_",",.01)
"RTN","VPRDLR",113,0)
 Q Y
"RTN","VPRDLR",114,0)
 ;
"RTN","VPRDLR",115,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDLR",116,0)
 ;
"RTN","VPRDLR",117,0)
XML(LAB) ; -- Return result as XML in @VPR@(#)
"RTN","VPRDLR",118,0)
 N ATT,X,Y,P,NAMES,TAG
"RTN","VPRDLR",119,0)
 D ADD("<lab>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDLR",120,0)
 S ATT="" F  S ATT=$O(LAB(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDLR",121,0)
 . S X=$G(LAB(ATT)),Y="" Q:'$L(X)
"RTN","VPRDLR",122,0)
 . I ATT="comment" S Y="<"_ATT_" xml:space='preserve'>"_$$ESC^VPRD(X)_"</"_ATT_">" Q
"RTN","VPRDLR",123,0)
 . ;
"RTN","VPRDLR",124,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDLR",125,0)
 . I $L(X)>1 D  S Y=""
"RTN","VPRDLR",126,0)
 .. S Y="<"_ATT_" ",NAMES="code^name^Z"
"RTN","VPRDLR",127,0)
 .. S:ATT="provider" NAMES="code^name^"_$$PROVTAGS^VPRD_"^Z"
"RTN","VPRDLR",128,0)
 .. F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDLR",129,0)
 .. S Y=Y_"/>" D ADD(Y)
"RTN","VPRDLR",130,0)
 D ADD("</lab>")
"RTN","VPRDLR",131,0)
 Q
"RTN","VPRDLR",132,0)
 ;
"RTN","VPRDLR",133,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDLR",134,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDLR",135,0)
 S @VPR@(VPRI)=X
"RTN","VPRDLR",136,0)
 Q
"RTN","VPRDLRA")
0^13^B97052919^B76865545
"RTN","VPRDLRA",1,0)
VPRDLRA ;SLC/MKB -- Laboratory extract by accession ;8/2/11  15:29
"RTN","VPRDLRA",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,2,5**;Sep 01, 2011;Build 21
"RTN","VPRDLRA",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDLRA",4,0)
 ;
"RTN","VPRDLRA",5,0)
 ; External References          DBIA#
"RTN","VPRDLRA",6,0)
 ; -------------------          -----
"RTN","VPRDLRA",7,0)
 ; ^DPT                         10035
"RTN","VPRDLRA",8,0)
 ; ^LAB(60                      10054
"RTN","VPRDLRA",9,0)
 ; ^LAB(61                        524
"RTN","VPRDLRA",10,0)
 ; ^LRO(68                       1963
"RTN","VPRDLRA",11,0)
 ; ^LRO(69                       2407
"RTN","VPRDLRA",12,0)
 ; ^LR                            525
"RTN","VPRDLRA",13,0)
 ; ^SC                          10040
"RTN","VPRDLRA",14,0)
 ; ^VA(200                      10060
"RTN","VPRDLRA",15,0)
 ; DIC                           2051
"RTN","VPRDLRA",16,0)
 ; DIQ                           2056
"RTN","VPRDLRA",17,0)
 ; LR7OR1,^TMP("LRRR",$J)        2503
"RTN","VPRDLRA",18,0)
 ; LR7OSUM,^TMP("LRC",$J),       2766
"RTN","VPRDLRA",19,0)
 ;  ^TMP("LRH",$J),^TMP("LRT",$J)
"RTN","VPRDLRA",20,0)
 ; LRPXAPIU                      4246
"RTN","VPRDLRA",21,0)
 ; PXAPI                         1894
"RTN","VPRDLRA",22,0)
 ; XUAF4                         2171
"RTN","VPRDLRA",23,0)
 ;
"RTN","VPRDLRA",24,0)
 ; ------------ Get results from VistA ------------
"RTN","VPRDLRA",25,0)
 ;
"RTN","VPRDLRA",26,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's lab results
"RTN","VPRDLRA",27,0)
 N VPRTYPE,SUB,VPRSUB,VPRIDT,VPRP,VPRITM,LRDFN,LR0,ORD,X,I
"RTN","VPRDLRA",28,0)
 S DFN=+$G(DFN) Q:$G(DFN)<1
"RTN","VPRDLRA",29,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDLRA",30,0)
 S VPRTYPE=$G(FILTER("type"),"CH;MI;CY;EM;SP;AU")
"RTN","VPRDLRA",31,0)
 S LRDFN=$G(^DPT(DFN,"LR")),SUB=$$SUB(VPRTYPE)
"RTN","VPRDLRA",32,0)
 K ^TMP("LRRR",$J,DFN)
"RTN","VPRDLRA",33,0)
 ;
"RTN","VPRDLRA",34,0)
 ; get result(s)
"RTN","VPRDLRA",35,0)
 I $L($G(ID)) D  ;reset search parameters
"RTN","VPRDLRA",36,0)
 . S SUB=$P(ID,";"),VPRIDT=+$P(ID,";",2)
"RTN","VPRDLRA",37,0)
 . S:VPRIDT (BEG,END)=9999999-VPRIDT
"RTN","VPRDLRA",38,0)
 . S:"CH^MI"'[SUB SUB="AP"
"RTN","VPRDLRA",39,0)
 ;
"RTN","VPRDLRA",40,0)
 D RR^LR7OR1(DFN,,BEG,END,SUB,,,MAX)
"RTN","VPRDLRA",41,0)
 S VPRSUB="" F  S VPRSUB=$O(^TMP("LRRR",$J,DFN,VPRSUB)) Q:VPRSUB=""  D
"RTN","VPRDLRA",42,0)
 . Q:$G(VPRTYPE)'[VPRSUB  ;requested types only
"RTN","VPRDLRA",43,0)
 . S VPRIDT=0 F  S VPRIDT=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT)) Q:VPRIDT<1  I $O(^(VPRIDT,0)) D
"RTN","VPRDLRA",44,0)
 .. K VPRITM,ORD,CMMT,^TMP("VPRTEXT",$J)
"RTN","VPRDLRA",45,0)
 .. I "CH^MI"'[VPRSUB D AP(.VPRITM),XML(.VPRITM) Q
"RTN","VPRDLRA",46,0)
 .. S VPRITM("type")=VPRSUB,VPRITM("id")=VPRSUB_";"_VPRIDT
"RTN","VPRDLRA",47,0)
 .. S VPRITM("collected")=9999999-VPRIDT,VPRITM("status")="completed"
"RTN","VPRDLRA",48,0)
 .. S LR0=$G(^LR(LRDFN,VPRSUB,VPRIDT,0))
"RTN","VPRDLRA",49,0)
 .. S VPRITM("resulted")=$P(LR0,U,3),X=+$P(LR0,U,5) I X D
"RTN","VPRDLRA",50,0)
 ... N IENS,VPRY S IENS=X_","
"RTN","VPRDLRA",51,0)
 ... D GETS^DIQ(61,IENS,".01;2;4.1",,"VPRY")
"RTN","VPRDLRA",52,0)
 ... S VPRITM("specimen")=$G(VPRY(61,IENS,2))_U_$G(VPRY(61,IENS,.01)) ;SNOMED^name
"RTN","VPRDLRA",53,0)
 ... S VPRITM("sample")=$G(VPRY(61,IENS,4.1)) ;name
"RTN","VPRDLRA",54,0)
 .. S X=$P(LR0,U,6),VPRITM("name")=$$AREA(X),VPRITM("groupName")=X
"RTN","VPRDLRA",55,0)
 .. S I=$S(VPRSUB="CH":10,1:7),X=+$P(LR0,U,I)
"RTN","VPRDLRA",56,0)
 .. S:X VPRITM("provider")=X_U_$P($G(^VA(200,X,0)),U)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDLRA",57,0)
 .. S X=+$P(LR0,U,14) S:X VPRITM("facility")=$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U)
"RTN","VPRDLRA",58,0)
 .. I 'X S VPRITM("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDLRA",59,0)
 .. I VPRSUB="MI" D  ;report
"RTN","VPRDLRA",60,0)
 ... I '$P(LR0,U,3) S VPRITM("status")="incomplete" Q
"RTN","VPRDLRA",61,0)
 ... S VPRITM("document",1)=VPRSUB_";"_VPRIDT_"^LR MICROBIOLOGY REPORT^LABORATORY NOTE^4697105"
"RTN","VPRDLRA",62,0)
 ... S:$G(VPRTEXT) VPRITM("document",1,"content")=$$TEXT(DFN,VPRSUB,VPRIDT)
"RTN","VPRDLRA",63,0)
 .. S VPRP=0 F  S VPRP=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT,VPRP)) Q:VPRP<1  D
"RTN","VPRDLRA",64,0)
 ... S X=$S(VPRSUB="MI":$$MI,1:$$CH)
"RTN","VPRDLRA",65,0)
 ... S:$L(X) VPRITM("value",VPRP)=X
"RTN","VPRDLRA",66,0)
 ... S:$G(ORD) VPRITM("labOrderID")=ORD
"RTN","VPRDLRA",67,0)
 .. I $D(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT,"N")) M CMMT=^("N") S VPRITM("comment")=$$STRING^VPRD(.CMMT)
"RTN","VPRDLRA",68,0)
 .. D XML(.VPRITM)
"RTN","VPRDLRA",69,0)
 K ^TMP("LRRR",$J,DFN),^TMP("VPRTEXT",$J)
"RTN","VPRDLRA",70,0)
 Q
"RTN","VPRDLRA",71,0)
 ;
"RTN","VPRDLRA",72,0)
CH() ; -- return a Chemistry result as:
"RTN","VPRDLRA",73,0)
 ;   id^test^result^interpretation^units^low^high^localName^loinc^vuid^order^performingLab
"RTN","VPRDLRA",74,0)
 ;   Expects ^TMP("LRRR",$J,DFN,"CH",VPRIDT,VPRP),LRDFN
"RTN","VPRDLRA",75,0)
 N X,Y,X0,VPRN,NODE,CMMT,LOINC
"RTN","VPRDLRA",76,0)
 S X0=$G(^TMP("LRRR",$J,DFN,"CH",VPRIDT,VPRP)),VPRN=$$LRDN^LRPXAPIU(+X0)
"RTN","VPRDLRA",77,0)
 S NODE=$G(^LR(LRDFN,"CH",VPRIDT,VPRN))
"RTN","VPRDLRA",78,0)
 S X=$P($G(^LAB(60,+X0,0)),U)
"RTN","VPRDLRA",79,0)
 S Y="CH;"_VPRIDT_";"_VPRN_U_X_U_$P(X0,U,2,4)
"RTN","VPRDLRA",80,0)
 S X=$P(X0,U,5) I $L(X),X["-" S X=$TR(X,"- ","^"),$P(Y,U,6,7)=X
"RTN","VPRDLRA",81,0)
 S $P(Y,U,8)=$P(X0,U,15) ;test short name
"RTN","VPRDLRA",82,0)
 S X=$P($P(NODE,U,3),"!",3) S:X LOINC=$$GET1^DIQ(95.3,X_",",.01)
"RTN","VPRDLRA",83,0)
 S:$G(LOINC) $P(Y,U,9,10)=LOINC_U_$$VUID^VPRD(+LOINC,95.3)
"RTN","VPRDLRA",84,0)
 S ORD=+$P(X0,U,17),X=$$ORDER(ORD,+X0) S:X $P(Y,U,11)=X
"RTN","VPRDLRA",85,0)
 S X=+$P(NODE,U,9) S:X $P(Y,U,12)=$$NAME^XUAF4(X) ;performing lab
"RTN","VPRDLRA",86,0)
 Q Y
"RTN","VPRDLRA",87,0)
 ;
"RTN","VPRDLRA",88,0)
MI() ; -- return a Microbiology result as:
"RTN","VPRDLRA",89,0)
 ;   id^test^result^interpretation^units
"RTN","VPRDLRA",90,0)
 ;   Expects ^TMP("LRRR",$J,DFN,"MI",VPRIDT,VPRP)
"RTN","VPRDLRA",91,0)
 N Y,X0
"RTN","VPRDLRA",92,0)
 S X0=$G(^TMP("LRRR",$J,DFN,"MI",VPRIDT,VPRP)),Y=""
"RTN","VPRDLRA",93,0)
 S:$L($P(X0,U))>1 Y="MI;"_VPRIDT_";"_VPRP_U_$P(X0,U,1,4)
"RTN","VPRDLRA",94,0)
 S ORD=+$P(X0,U,17)
"RTN","VPRDLRA",95,0)
 Q Y
"RTN","VPRDLRA",96,0)
 ;
"RTN","VPRDLRA",97,0)
AP(LAB) ; -- return a Pathology result in LAB("attribute")=value
"RTN","VPRDLRA",98,0)
 N LR0,X,I,NODE
"RTN","VPRDLRA",99,0)
 S LR0=$G(^LR(LRDFN,VPRSUB,VPRIDT,0)) I VPRSUB="AU" D
"RTN","VPRDLRA",100,0)
 . N AU S AU=$G(^LR(LRDFN,"AU")) ;set pieces needed into LR0
"RTN","VPRDLRA",101,0)
 . S LR0=+AU_U_$P(AU,U,10)_"^^^^"_$P(AU,U,6)_U_$P(AU,U,12)_"^^^^"_$P(AU,U,15)
"RTN","VPRDLRA",102,0)
 S LAB("type")=VPRSUB,LAB("id")=VPRSUB_";"_VPRIDT
"RTN","VPRDLRA",103,0)
 S LAB("collected")=9999999-VPRIDT,LAB("resulted")=$P(LR0,U,11)
"RTN","VPRDLRA",104,0)
 S X=$P(LR0,U,6),LAB("groupName")=X,LAB("name")=$$AREA(X)
"RTN","VPRDLRA",105,0)
 S X=+$P(LR0,U,2) S:X LAB("pathologist")=X_U_$P($G(^VA(200,X,0)),U)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDLRA",106,0)
 S X=+$P(LR0,U,7) S:X LAB("provider")=X_U_$P($G(^VA(200,X,0)),U)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDLRA",107,0)
 S LAB("status")=$S('$P(LR0,U,11):"incomplete",1:"completed")
"RTN","VPRDLRA",108,0)
 S X="",I=0 F  S I=$O(^LR(LRDFN,VPRSUB,VPRIDT,.1,I)) Q:I<1  S X=X_$S($L(X):", ",1:"")_$P($G(^(I,0)),U)
"RTN","VPRDLRA",109,0)
 S:$L(X) LAB("specimen")=U_X
"RTN","VPRDLRA",110,0)
 S LAB("facility")=$$FAC^VPRD
"RTN","VPRDLRA",111,0)
 S NODE=$S(VPRSUB="AU":$NA(^LR(LRDFN,101)),1:$NA(^LR(LRDFN,VPRSUB,VPRIDT,.05)))
"RTN","VPRDLRA",112,0)
 S I=0 F  S I=$O(@NODE@(I)) Q:I<1  S X=+$P($G(@NODE@(I,0)),U,2) I X D
"RTN","VPRDLRA",113,0)
 . N Y S Y=$$INFO^VPRDTIU(+X) Q:Y<1  ;draft or retracted
"RTN","VPRDLRA",114,0)
 . S LAB("document",I)=Y
"RTN","VPRDLRA",115,0)
 . S:$G(VPRTEXT) LAB("document",I,"content")=$$TEXT^VPRDTIU(+X)
"RTN","VPRDLRA",116,0)
 I '$O(LAB("document",0)),$P(LR0,U,11) D  ;non-TIU reports
"RTN","VPRDLRA",117,0)
 . S LAB("document",1)=VPRSUB_";"_VPRIDT_"^LR "_$$NAME(VPRSUB)_" REPORT^LABORATORY NOTE^4697105"
"RTN","VPRDLRA",118,0)
 . S:$G(VPRTEXT) LAB("document",1,"content")=$$TEXT(DFN,VPRSUB,VPRIDT)
"RTN","VPRDLRA",119,0)
 Q
"RTN","VPRDLRA",120,0)
 ;
"RTN","VPRDLRA",121,0)
SUB(X) ; -- return string of type(s) needed for LR api
"RTN","VPRDLRA",122,0)
 N Y S Y="",X=$G(X)
"RTN","VPRDLRA",123,0)
 S:X["CH" Y=Y_"CH"
"RTN","VPRDLRA",124,0)
 S:X["MI" Y=Y_"MI"
"RTN","VPRDLRA",125,0)
 I X["AP"!(X["CY")!(X["EM")!(X["SP")!(X["AU") S Y=Y_"AP"
"RTN","VPRDLRA",126,0)
 Q Y
"RTN","VPRDLRA",127,0)
 ;
"RTN","VPRDLRA",128,0)
ORDER(LABORD,TEST) ; -- return #100 order number for Lab order# & Test
"RTN","VPRDLRA",129,0)
 N Y,D,S,T
"RTN","VPRDLRA",130,0)
 S D=$P(9999999-VPRIDT,"."),Y=""
"RTN","VPRDLRA",131,0)
 S S=0 F  S S=$O(^LRO(69,"C",LABORD,D,S)) Q:S<1  D  Q:Y
"RTN","VPRDLRA",132,0)
 . S T=0 F  S T=$O(^LRO(69,D,1,S,2,T)) Q:T<1  I 'TEST!(+$G(^(T,0))=TEST) S Y=+$P(^(0),U,7)
"RTN","VPRDLRA",133,0)
 Q Y
"RTN","VPRDLRA",134,0)
 ;
"RTN","VPRDLRA",135,0)
NAME(X) ; -- Return name of subscript X
"RTN","VPRDLRA",136,0)
 I X="AU" Q "AUTOPSY"
"RTN","VPRDLRA",137,0)
 I X="BB" Q "BLOOD BANK"
"RTN","VPRDLRA",138,0)
 I X="CH" Q "CHEM,HEM,TOX,RIA,SER,etc."
"RTN","VPRDLRA",139,0)
 I X="CY" Q "CYTOPATHOLOGY"
"RTN","VPRDLRA",140,0)
 I X="EM" Q "ELECTRON MICROSCOPY"
"RTN","VPRDLRA",141,0)
 I X="MI" Q "MICROBIOLOGY"
"RTN","VPRDLRA",142,0)
 I X="SP" Q "SURGICAL PATHOLOGY"
"RTN","VPRDLRA",143,0)
 Q "ANATOMIC PATHOLOGY"
"RTN","VPRDLRA",144,0)
 ;
"RTN","VPRDLRA",145,0)
AREA(ACCNUM) ; -- Return name of accession area
"RTN","VPRDLRA",146,0)
 N X,Y,VPRA
"RTN","VPRDLRA",147,0)
 S X=$P($G(ACCNUM)," "),Y=""
"RTN","VPRDLRA",148,0)
 I $L(X) D FIND^DIC(68,,.01,"QX",X,,,,,"VPRA")
"RTN","VPRDLRA",149,0)
 S Y=$G(VPRA("DILIST",1,1))
"RTN","VPRDLRA",150,0)
 Q Y
"RTN","VPRDLRA",151,0)
 ;
"RTN","VPRDLRA",152,0)
 ; ------------ Get report(s) [via VPRDTIU] ------------
"RTN","VPRDLRA",153,0)
 ;
"RTN","VPRDLRA",154,0)
RPTS(DFN,BEG,END,MAX) ; -- find patient's lab reports
"RTN","VPRDLRA",155,0)
 N VPRSUB,VPRIDT,VPRITM,VPRTIU,LR0,VPRXID,LRDFN,VPRN,DA
"RTN","VPRDLRA",156,0)
 S DFN=+$G(DFN) Q:$G(DFN)<1
"RTN","VPRDLRA",157,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDLRA",158,0)
 S LRDFN=$G(^DPT(DFN,"LR"))
"RTN","VPRDLRA",159,0)
 K ^TMP("LRRR",$J,DFN) D RR^LR7OR1(DFN,,BEG,END,"AP",,,MAX)
"RTN","VPRDLRA",160,0)
 S VPRSUB="" F  S VPRSUB=$O(^TMP("LRRR",$J,DFN,VPRSUB)) Q:VPRSUB=""  D
"RTN","VPRDLRA",161,0)
 . S VPRIDT=0 F  S VPRIDT=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT)) Q:VPRIDT<1  I $O(^(VPRIDT,0)) D
"RTN","VPRDLRA",162,0)
 .. S VPRTIU=$S(VPRSUB="AU":$NA(^LR(LRDFN,101)),1:$NA(^LR(LRDFN,VPRSUB,VPRIDT,.05)))
"RTN","VPRDLRA",163,0)
 .. S LR0=$S(VPRSUB="AU":$G(^LR(LRDFN,"AU")),1:$G(^LR(LRDFN,VPRSUB,VPRIDT,0)))
"RTN","VPRDLRA",164,0)
 .. K VPRITM S VPRXID=VPRSUB_";"_VPRIDT
"RTN","VPRDLRA",165,0)
 .. ; generate report from Lab if not in TIU
"RTN","VPRDLRA",166,0)
 .. I '$O(@VPRTIU@(0)) D  Q
"RTN","VPRDLRA",167,0)
 ... Q:'$P(LR0,U,$S(VPRSUB="AU":15,1:11))  ;Rpt Release Date
"RTN","VPRDLRA",168,0)
 ... D RPT1(DFN,VPRXID,.VPRITM),XML^VPRDTIU(.VPRITM):$D(VPRITM)
"RTN","VPRDLRA",169,0)
 .. S VPRN=0 F  S VPRN=$O(@VPRTIU@(VPRN)) Q:VPRN<1  D
"RTN","VPRDLRA",170,0)
 ... S DA=+$P($G(@VPRTIU@(VPRN,0)),U,2) Q:DA<1  K VPRITM
"RTN","VPRDLRA",171,0)
 ... Q:$$INFO^VPRDTIU(DA)<1  ;draft or retracted
"RTN","VPRDLRA",172,0)
 ... D EN1^VPRDTIU(DA,.VPRITM),XML^VPRDTIU(.VPRITM):$D(VPRITM)
"RTN","VPRDLRA",173,0)
 K ^TMP("LRRR",$J,DFN),^TMP("VPRTEXT",$J)
"RTN","VPRDLRA",174,0)
 Q
"RTN","VPRDLRA",175,0)
 ;
"RTN","VPRDLRA",176,0)
RPT1(DFN,ID,RPT) ; -- return report as a TIU document
"RTN","VPRDLRA",177,0)
 S DFN=+$G(DFN),ID=$G(ID) Q:DFN<1  Q:'$L(ID)
"RTN","VPRDLRA",178,0)
 N SUB,IDT,LRDFN,LR0,X,LOC
"RTN","VPRDLRA",179,0)
 K RPT,^TMP("VPRTEXT",$J)
"RTN","VPRDLRA",180,0)
 S SUB=$P(ID,";"),IDT=+$P(ID,";",2),LRDFN=$G(^DPT(DFN,"LR"))
"RTN","VPRDLRA",181,0)
 S LR0=$S(SUB="AU":$G(^LR(LRDFN,"AU")),1:$G(^LR(LRDFN,SUB,IDT,0)))
"RTN","VPRDLRA",182,0)
 S RPT("id")=ID,RPT("referenceDateTime")=9999999-IDT
"RTN","VPRDLRA",183,0)
 S RPT("localTitle")="LR "_$$NAME(SUB)_" REPORT"
"RTN","VPRDLRA",184,0)
 S RPT("documentClass")="LR LABORATORY REPORTS"
"RTN","VPRDLRA",185,0)
 S RPT("nationalTitle")="4697105^LABORATORY NOTE"
"RTN","VPRDLRA",186,0)
 S RPT("nationalTitleSubject")="4697104^LABORATORY"
"RTN","VPRDLRA",187,0)
 S RPT("nationalTitleType")="4696120^NOTE"
"RTN","VPRDLRA",188,0)
 S RPT("type")="LR",RPT("status")="UNRELEASED"
"RTN","VPRDLRA",189,0)
 S:$G(FILTER("loinc")) RPT("loinc")=$P(FILTER("loinc"),U)
"RTN","VPRDLRA",190,0)
 S X=$P(LR0,U,$S(SUB="AU":5,1:8)),LOC="" S:$L(X) LOC=+$O(^SC("B",X,0))
"RTN","VPRDLRA",191,0)
 S RPT("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDLRA",192,0)
 I LOC D  ;look-up visit
"RTN","VPRDLRA",193,0)
 . N CDT S CDT=9999999-IDT
"RTN","VPRDLRA",194,0)
 . S X=$$GETENC^PXAPI(DFN,CDT,LOC)
"RTN","VPRDLRA",195,0)
 . S:X RPT("encounter")=+X
"RTN","VPRDLRA",196,0)
 S X=+$P(LR0,U,$S(SUB="AU":10,1:2)) ;pathologist
"RTN","VPRDLRA",197,0)
 S:X RPT("clinician",1)=X_U_$P($G(^VA(200,X,0)),U)_"^A^^^"_$$PROVSPC^VPRD(X)
"RTN","VPRDLRA",198,0)
 ; check if Report Released
"RTN","VPRDLRA",199,0)
 S X=$S(SUB="AU":$P(LR0,U,15,16),1:$P(LR0,U,11)_U_$P(LR0,U,13)) I X D
"RTN","VPRDLRA",200,0)
 . N Y S Y=$P(X,U,2),RPT("status")="COMPLETED"
"RTN","VPRDLRA",201,0)
 . S RPT("clinician",2)=Y_U_$P($G(^VA(200,+Y,0)),U)_"^S^"_+X_U_$P($G(^VA(200,+Y,20)),U,2)_U_$$PROVSPC^VPRD(+Y)
"RTN","VPRDLRA",202,0)
 . S:$G(VPRTEXT) RPT("content")=$$TEXT(DFN,SUB,IDT)
"RTN","VPRDLRA",203,0)
 Q
"RTN","VPRDLRA",204,0)
 ;
"RTN","VPRDLRA",205,0)
TEXT(DFN,SUB,IDT) ; -- Get report text, return temp array name
"RTN","VPRDLRA",206,0)
 N LRDFN,DATE,NAME,VPRS,VPRY,I,X,Y
"RTN","VPRDLRA",207,0)
 K ^TMP("LRC",$J),^TMP("LRH",$J),^TMP("LRT",$J)
"RTN","VPRDLRA",208,0)
 S DATE=9999999-+$G(IDT),NAME=$S(SUB="EM":"EM",1:$$NAME(SUB)),VPRS(NAME)=""
"RTN","VPRDLRA",209,0)
 D EN^LR7OSUM(.VPRY,DFN,DATE,DATE,,,.VPRS)
"RTN","VPRDLRA",210,0)
 S Y=$NA(^TMP("VPRTEXT",$J,SUB_";"_IDT)) K @Y
"RTN","VPRDLRA",211,0)
 S I=+$G(^TMP("LRH",$J,NAME)) ;LRH=header
"RTN","VPRDLRA",212,0)
 F  S I=$O(^TMP("LRC",$J,I)) Q:I<1  S X=$G(^(I,0)) Q:X?1."="  S @Y@(I)=X
"RTN","VPRDLRA",213,0)
 K ^TMP("LRC",$J),^TMP("LRH",$J),^TMP("LRT",$J)
"RTN","VPRDLRA",214,0)
 Q Y
"RTN","VPRDLRA",215,0)
 ;
"RTN","VPRDLRA",216,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDLRA",217,0)
 ;
"RTN","VPRDLRA",218,0)
XML(LAB) ; -- Return result as XML in @VPR@(#)
"RTN","VPRDLRA",219,0)
 N ATT,X,Y,NAMES,I,J
"RTN","VPRDLRA",220,0)
 D ADD("<accession>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDLRA",221,0)
 S ATT="" F  S ATT=$O(LAB(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDLRA",222,0)
 . I $O(LAB(ATT,0)) D  S Y="" Q
"RTN","VPRDLRA",223,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDLRA",224,0)
 .. S NAMES=$S(ATT="document":"id^localTitle^nationalTitle^vuid^Z",ATT="value":"id^test^result^interpretation^units^low^high^localName^loinc^vuid^order^performingLab^Z",1:"code^name^Z")
"RTN","VPRDLRA",225,0)
 .. S I=0 F  S I=$O(LAB(ATT,I)) Q:I<1  D
"RTN","VPRDLRA",226,0)
 ... S X=$G(LAB(ATT,I))
"RTN","VPRDLRA",227,0)
 ... S Y="<"_ATT_" "_$$LOOP ;_"/>" D ADD(Y)
"RTN","VPRDLRA",228,0)
 ... S X=$G(LAB(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDLRA",229,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDLRA",230,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDLRA",231,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDLRA",232,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDLRA",233,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDLRA",234,0)
 . S X=$G(LAB(ATT)),Y="" Q:'$L(X)
"RTN","VPRDLRA",235,0)
 . I ATT="comment" S Y="<"_ATT_" xml:space='preserve'>"_$$ESC^VPRD(X)_"</"_ATT_">" Q
"RTN","VPRDLRA",236,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDLRA",237,0)
 . I $L(X)>1 D  S Y=""
"RTN","VPRDLRA",238,0)
 .. S NAMES="code^name"_$S(ATT="provider"!(ATT="pathologist"):U_$$PROVTAGS^VPRD,1:"")_"^Z"
"RTN","VPRDLRA",239,0)
 .. S Y="<"_ATT_" "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDLRA",240,0)
 D ADD("</accession>")
"RTN","VPRDLRA",241,0)
 Q
"RTN","VPRDLRA",242,0)
 ;
"RTN","VPRDLRA",243,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDLRA",244,0)
 N STR,P,TAG S STR=""
"RTN","VPRDLRA",245,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDLRA",246,0)
 Q STR
"RTN","VPRDLRA",247,0)
 ;
"RTN","VPRDLRA",248,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDLRA",249,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDLRA",250,0)
 S @VPR@(VPRI)=X
"RTN","VPRDLRA",251,0)
 Q
"RTN","VPRDLRO")
0^20^B34279293^B27947758
"RTN","VPRDLRO",1,0)
VPRDLRO ;SLC/MKB -- Laboratory extract by order/panel ;8/2/11  15:29
"RTN","VPRDLRO",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**2,5**;Sep 01, 2011;Build 21
"RTN","VPRDLRO",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDLRO",4,0)
 ;
"RTN","VPRDLRO",5,0)
 ; External References          DBIA#
"RTN","VPRDLRO",6,0)
 ; -------------------          -----
"RTN","VPRDLRO",7,0)
 ; ^DPT                         10035
"RTN","VPRDLRO",8,0)
 ; ^LAB(60                      10054
"RTN","VPRDLRO",9,0)
 ; ^LAB(61                        524
"RTN","VPRDLRO",10,0)
 ; ^LRO(69                       2407
"RTN","VPRDLRO",11,0)
 ; ^LR                            525
"RTN","VPRDLRO",12,0)
 ; ^PXRMINDX                     4290
"RTN","VPRDLRO",13,0)
 ; DIQ                           2056
"RTN","VPRDLRO",14,0)
 ; LR7OR1,^TMP("LRRR",$J)        2503
"RTN","VPRDLRO",15,0)
 ; LR7OU1                        2955
"RTN","VPRDLRO",16,0)
 ; LRPXAPIU                      4246
"RTN","VPRDLRO",17,0)
 ; ORX8                          3071
"RTN","VPRDLRO",18,0)
 ; XUAF4                         2171
"RTN","VPRDLRO",19,0)
 ;
"RTN","VPRDLRO",20,0)
 ; ------------ Get results from VistA ------------
"RTN","VPRDLRO",21,0)
 ;
"RTN","VPRDLRO",22,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's lab results
"RTN","VPRDLRO",23,0)
 N VPRSUB,VPRIDT,VPRN,VPRLRO,VPRT,VPRITM,CMMT,LRDFN,LR0,X,I,VPRPL
"RTN","VPRDLRO",24,0)
 S DFN=+$G(DFN) Q:$G(DFN)<1
"RTN","VPRDLRO",25,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDLRO",26,0)
 S LRDFN=$G(^DPT(DFN,"LR")),VPRSUB=$G(FILTER("type"),"CH")
"RTN","VPRDLRO",27,0)
 K ^TMP("LRRR",$J,DFN)
"RTN","VPRDLRO",28,0)
 ;
"RTN","VPRDLRO",29,0)
 ; get result(s)
"RTN","VPRDLRO",30,0)
 I $G(ID)  D RR^LR7OR1(DFN,ID)
"RTN","VPRDLRO",31,0)
 I '$G(ID) D  ;no id, or accession format (no lab order)
"RTN","VPRDLRO",32,0)
 . S:$G(ID)'="" VPRSUB=$P(ID,";"),(BEG,END)=9999999-$P(ID,";",2)
"RTN","VPRDLRO",33,0)
 . D RR^LR7OR1(DFN,,BEG,END,VPRSUB,,,MAX)
"RTN","VPRDLRO",34,0)
 ;
"RTN","VPRDLRO",35,0)
 S VPRSUB="" F  S VPRSUB=$O(^TMP("LRRR",$J,DFN,VPRSUB)) Q:VPRSUB=""  D
"RTN","VPRDLRO",36,0)
 . S VPRIDT=0 F  S VPRIDT=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT)) Q:VPRIDT<1  I $O(^(VPRIDT,0)) D
"RTN","VPRDLRO",37,0)
 .. I "CH^MI"'[VPRSUB Q
"RTN","VPRDLRO",38,0)
 .. ;group accession by lab orders > VPRLRO(panel,VPRN)=data node
"RTN","VPRDLRO",39,0)
 .. D SORT:VPRSUB="CH",PXRM:VPRSUB="MI"
"RTN","VPRDLRO",40,0)
 .. S VPRT="" F  S VPRT=$O(VPRLRO(VPRT)) Q:VPRT=""  D
"RTN","VPRDLRO",41,0)
 ... K VPRITM,CMMT,VPRPL S X=$G(VPRLRO(VPRT))
"RTN","VPRDLRO",42,0)
 ... I $G(ID),$P(ID,";",1,3)'=$P($P(X,U,3),";",1,3) Q  ;single order/specimen
"RTN","VPRDLRO",43,0)
 ... S VPRITM("id")=$P(X,U,3),VPRITM("order")=$P(X,U,1,2)
"RTN","VPRDLRO",44,0)
 ... S VPRITM("type")=VPRSUB,VPRITM("status")="completed"
"RTN","VPRDLRO",45,0)
 ... S VPRITM("collected")=9999999-VPRIDT
"RTN","VPRDLRO",46,0)
 ... S LR0=$G(^LR(LRDFN,VPRSUB,VPRIDT,0))
"RTN","VPRDLRO",47,0)
 ... S X=$P(LR0,U,3) I VPRSUB="MI",'X S VPRITM("status")="incomplete"
"RTN","VPRDLRO",48,0)
 ... S VPRITM("resulted")=X,X=+$P(LR0,U,5) I X D  ;specimen
"RTN","VPRDLRO",49,0)
 .... N IENS,VPRY S IENS=X_","
"RTN","VPRDLRO",50,0)
 .... D GETS^DIQ(61,IENS,".01:2",,"VPRY")
"RTN","VPRDLRO",51,0)
 .... S VPRITM("specimen")=$G(VPRY(61,IENS,2))_U_$G(VPRY(61,IENS,.01)) ;SNOMED^name
"RTN","VPRDLRO",52,0)
 .... S VPRITM("sample")=$$GET1^DIQ(61,X_",",4.1) ;name
"RTN","VPRDLRO",53,0)
 ... S VPRITM("groupName")=$P(LR0,U,6),X=+$P(LR0,U,14)
"RTN","VPRDLRO",54,0)
 ... S:X VPRITM("facility")=$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U)
"RTN","VPRDLRO",55,0)
 ... I 'X S VPRITM("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDLRO",56,0)
 ... S I=$S(VPRSUB="CH":10,1:7),X=+$P(LR0,U,I)
"RTN","VPRDLRO",57,0)
 ... S:X VPRITM("provider")=X_U_$P($G(^VA(200,X,0)),U)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDLRO",58,0)
 ... S VPRN=0 F  S VPRN=$O(VPRLRO(VPRT,VPRN)) Q:VPRN<1  D
"RTN","VPRDLRO",59,0)
 .... S X=$G(VPRLRO(VPRT,VPRN))
"RTN","VPRDLRO",60,0)
 .... S:VPRSUB="CH" VPRITM("value",VPRN)=$$CH(X)
"RTN","VPRDLRO",61,0)
 .... S:VPRSUB="MI" VPRITM("value",VPRN)=$$MI(X)
"RTN","VPRDLRO",62,0)
 ... I $D(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT,"N")) M CMMT=^("N") S VPRITM("comment")=$$STRING^VPRD(.CMMT)
"RTN","VPRDLRO",63,0)
 ... D XML(.VPRITM)
"RTN","VPRDLRO",64,0)
 K ^TMP("LRRR",$J,DFN)
"RTN","VPRDLRO",65,0)
 Q
"RTN","VPRDLRO",66,0)
 ;
"RTN","VPRDLRO",67,0)
SORT ; -- return VPRLRO(PANEL) = CPRS order# ^ panel/test name ^ Lab Order string
"RTN","VPRDLRO",68,0)
 ;               VPRLRO(PANEL,VPRN) = result node
"RTN","VPRDLRO",69,0)
 N VPRP,X0,NUM,ORD,ODT,SN,T,T0,ORIFN,I,VPRY,VPRLRT K VPRLRO
"RTN","VPRDLRO",70,0)
 S VPRP=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT,0)),X0=$G(^(VPRP)) ;first
"RTN","VPRDLRO",71,0)
 S NUM=$P(X0,U,16),ORD=$P(X0,U,17),ODT=+$P(9999999-VPRIDT,".")
"RTN","VPRDLRO",72,0)
 ; - build VPRLRT list of result nodes for each test/panel
"RTN","VPRDLRO",73,0)
 I ORD S SN=0 F  S SN=$O(^LRO(69,"C",ORD,ODT,SN)) Q:SN<1  D  Q:$D(VPRLRT)
"RTN","VPRDLRO",74,0)
 . I $G(ID),$P(ID,";",3)'=SN Q
"RTN","VPRDLRO",75,0)
 . S T=0 F  S T=+$O(^LRO(69,ODT,1,SN,2,T)) Q:T<1  D
"RTN","VPRDLRO",76,0)
 .. I $G(ID),$P(ID,";",4),T'=$P(ID,";",4) Q
"RTN","VPRDLRO",77,0)
 .. S T0=$G(^LRO(69,ODT,1,SN,2,T,0))
"RTN","VPRDLRO",78,0)
 .. ; is test/panel part of same accession?
"RTN","VPRDLRO",79,0)
 .. S ORIFN=+$P(T0,U,7)
"RTN","VPRDLRO",80,0)
 .. Q:VPRIDT'=$P($$PKGID^ORX8(ORIFN),";",5)
"RTN","VPRDLRO",81,0)
 .. ; expand panel into unit tests
"RTN","VPRDLRO",82,0)
 .. K VPRY D EXPAND^LR7OU1(+T0,.VPRY)
"RTN","VPRDLRO",83,0)
 .. S I=0 F  S I=$O(VPRY(I)) Q:I<1  S VPRLRT(I,+T0)="" ;VPRLRT(test,panel)=""
"RTN","VPRDLRO",84,0)
 .. S VPRLRO(+T0)=$P(T0,U,7)_U_$P($G(^LAB(60,+T0,0)),U)_U_ORD_";"_ODT_";"_SN_";"_T
"RTN","VPRDLRO",85,0)
 S:'$D(VPRLRO) VPRLRO(0)=$S(VPRSUB="MI":"^MICROBIOLOGY^MI;",1:"^ACCESSION^CH;")_VPRIDT ;no Lab Order
"RTN","VPRDLRO",86,0)
 ; - build VPRLRO(panel#,VPRN) = ^TMP node
"RTN","VPRDLRO",87,0)
 S VPRP=0 F  S VPRP=$O(^TMP("LRRR",$J,DFN,"CH",VPRIDT,VPRP)) Q:VPRP<1  S X0=$G(^(VPRP)) D
"RTN","VPRDLRO",88,0)
 . S VPRN=$$LRDN^LRPXAPIU(+X0)
"RTN","VPRDLRO",89,0)
 . I '$D(VPRLRT(+X0)) S VPRLRO(0,VPRN)=X0 Q  ;no Lab Order
"RTN","VPRDLRO",90,0)
 . S T=0 F  S T=$O(VPRLRT(+X0,T)) Q:T<1  S VPRLRO(T,VPRN)=X0
"RTN","VPRDLRO",91,0)
 Q
"RTN","VPRDLRO",92,0)
 ;
"RTN","VPRDLRO",93,0)
PXRM ; -- ck Rem Index for MI ordered test >> VPRLRO(0)=^test^MI;invdate
"RTN","VPRDLRO",94,0)
 N CDT,PXI,DA,LRT K VPRLRO
"RTN","VPRDLRO",95,0)
 S CDT=9999999-VPRIDT,PXI=$O(^PXRMINDX(63,"PDI",DFN,CDT,"M;T;0"))
"RTN","VPRDLRO",96,0)
 I PXI?1"M;T;"1.N S DA=+$P(PXI,";",3),LRT=$P($G(^LAB(60,DA,0)),U)
"RTN","VPRDLRO",97,0)
 S VPRLRO(0)=U_$S($L($G(LRT)):LRT,1:"MICROBIOLOGY")_"^MI;"_VPRIDT
"RTN","VPRDLRO",98,0)
 Q
"RTN","VPRDLRO",99,0)
 ;
"RTN","VPRDLRO",100,0)
CH(X0) ; -- return a Chemistry result as:
"RTN","VPRDLRO",101,0)
 ;   id^test^result^interpretation^units^low^high^loinc^vuid^performingLab
"RTN","VPRDLRO",102,0)
 ;   Expects X0=^TMP("LRRR",$J,DFN,"CH",VPRIDT,VPRP),VPRN,LRDFN
"RTN","VPRDLRO",103,0)
 N X,Y,NODE,LOINC
"RTN","VPRDLRO",104,0)
 S NODE=$G(^LR(LRDFN,"CH",VPRIDT,VPRN))
"RTN","VPRDLRO",105,0)
 S X=$P($G(^LAB(60,+X0,0)),U)
"RTN","VPRDLRO",106,0)
 S Y="CH;"_VPRIDT_";"_VPRN_U_X_U_$P(X0,U,2,4)
"RTN","VPRDLRO",107,0)
 S X=$P(X0,U,5) I $L(X),X["-" S X=$TR(X,"- ","^"),$P(Y,U,6,7)=X
"RTN","VPRDLRO",108,0)
 S X=$P($P(NODE,U,3),"!",3) S:X LOINC=$$GET1^DIQ(95.3,X_",",.01)
"RTN","VPRDLRO",109,0)
 S:$G(LOINC) $P(Y,U,8,9)=LOINC_U_$$VUID^VPRD(+LOINC,95.3)
"RTN","VPRDLRO",110,0)
 S X=+$P(NODE,U,9) S:X $P(Y,U,10)=$$NAME^XUAF4(X) ;performing lab
"RTN","VPRDLRO",111,0)
 Q Y
"RTN","VPRDLRO",112,0)
 ;
"RTN","VPRDLRO",113,0)
MI(X0) ; -- return a Microbiology result as:
"RTN","VPRDLRO",114,0)
 ;   id^test^result^interpretation^units
"RTN","VPRDLRO",115,0)
 ;   Expects X0=^TMP("LRRR",$J,DFN,"MI",VPRIDT,VPRP)
"RTN","VPRDLRO",116,0)
 N Y S Y=""
"RTN","VPRDLRO",117,0)
 S:$L($P(X0,U))>1 Y="MI;"_VPRIDT_";"_VPRN_U_$P(X0,U,1,4)
"RTN","VPRDLRO",118,0)
 Q Y
"RTN","VPRDLRO",119,0)
 ;
"RTN","VPRDLRO",120,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDLRO",121,0)
 ;
"RTN","VPRDLRO",122,0)
XML(LAB) ; -- Return result as XML in @VPR@(#)
"RTN","VPRDLRO",123,0)
 N ATT,X,Y,I,J,P,NAMES,TAG
"RTN","VPRDLRO",124,0)
 D ADD("<panel>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDLRO",125,0)
 S ATT="" F  S ATT=$O(LAB(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDLRO",126,0)
 . I $O(LAB(ATT,0)) D  S Y="" Q
"RTN","VPRDLRO",127,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDLRO",128,0)
 .. I ATT="value" S NAMES="id^test^result^interpretation^units^low^high^loinc^vuid^performingLab^Z"
"RTN","VPRDLRO",129,0)
 .. E  S NAMES="code^name^Z"
"RTN","VPRDLRO",130,0)
 .. S I=0 F  S I=$O(LAB(ATT,I)) Q:I<1  D
"RTN","VPRDLRO",131,0)
 ... S X=$G(LAB(ATT,I)),Y="<"_ATT_" "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDLRO",132,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDLRO",133,0)
 . S X=$G(LAB(ATT)),Y="" Q:'$L(X)
"RTN","VPRDLRO",134,0)
 . I ATT="comment" S Y="<"_ATT_" xml:space='preserve'>"_$$ESC^VPRD(X)_"</"_ATT_">" Q
"RTN","VPRDLRO",135,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDLRO",136,0)
 . S NAMES="code^name"_$S(ATT="provider":U_$$PROVTAGS^VPRD,1:"")_"^Z"
"RTN","VPRDLRO",137,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDLRO",138,0)
 D ADD("</panel>")
"RTN","VPRDLRO",139,0)
 Q
"RTN","VPRDLRO",140,0)
 ;
"RTN","VPRDLRO",141,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDLRO",142,0)
 N STR,P,TAG S STR=""
"RTN","VPRDLRO",143,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDLRO",144,0)
 Q STR
"RTN","VPRDLRO",145,0)
 ;
"RTN","VPRDLRO",146,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDLRO",147,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDLRO",148,0)
 S @VPR@(VPRI)=X
"RTN","VPRDLRO",149,0)
 Q
"RTN","VPRDMC")
0^14^B61607238^B58353015
"RTN","VPRDMC",1,0)
VPRDMC ;SLC/MKB -- Clinical Procedures (Medicine) ;3/14/12  09:03
"RTN","VPRDMC",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,2,5**;Sep 01, 2011;Build 21
"RTN","VPRDMC",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDMC",4,0)
 ;
"RTN","VPRDMC",5,0)
 ; External References          DBIA#
"RTN","VPRDMC",6,0)
 ; -------------------          -----
"RTN","VPRDMC",7,0)
 ; ^SC                          10040
"RTN","VPRDMC",8,0)
 ; ^VA(200                      10060
"RTN","VPRDMC",9,0)
 ; %DT                          10003
"RTN","VPRDMC",10,0)
 ; DILFD                         2055
"RTN","VPRDMC",11,0)
 ; DIQ                           2056
"RTN","VPRDMC",12,0)
 ; GMRCGUIB                      2980
"RTN","VPRDMC",13,0)
 ; ICPTCOD                       1995
"RTN","VPRDMC",14,0)
 ; MCARUTL2                      3279
"RTN","VPRDMC",15,0)
 ; MCARUTL3                      3280
"RTN","VPRDMC",16,0)
 ; MDPS1,^TMP("MDHSP"/"MDPTXT"   4230
"RTN","VPRDMC",17,0)
 ; TIULQ                         2693
"RTN","VPRDMC",18,0)
 ; TIUSRVLO                      2834
"RTN","VPRDMC",19,0)
 ; XUAF4                         2171
"RTN","VPRDMC",20,0)
 ;
"RTN","VPRDMC",21,0)
 ; ------------ Get procedures from VistA ------------
"RTN","VPRDMC",22,0)
 ;
"RTN","VPRDMC",23,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's procedures
"RTN","VPRDMC",24,0)
 N VPRITM,RES,VPRN,VPRX,RTN,DATE,CONS,TIUN,X0,DA,GBL,X,Y,%DT,VPRT,LOC
"RTN","VPRDMC",25,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDMC",26,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDMC",27,0)
 ;
"RTN","VPRDMC",28,0)
 ; get one procedure
"RTN","VPRDMC",29,0)
 I $G(ID) D  ;reset dates for MDPS1
"RTN","VPRDMC",30,0)
 . N VPRMC,IEN,FILE
"RTN","VPRDMC",31,0)
 . S IEN=+ID,FILE=+$P(ID,"(",2) Q:FILE=702
"RTN","VPRDMC",32,0)
 . D MEDLKUP^MCARUTL3(.VPRMC,FILE,IEN)
"RTN","VPRDMC",33,0)
 . S X=$P(VPRMC,U,6) S:X (BEG,END)=X
"RTN","VPRDMC",34,0)
 ;
"RTN","VPRDMC",35,0)
 ; get all procedures
"RTN","VPRDMC",36,0)
 K ^TMP("MDHSP",$J) S RES=""
"RTN","VPRDMC",37,0)
 D EN1^MDPS1(RES,DFN,BEG,END,MAX,"",0)
"RTN","VPRDMC",38,0)
 S VPRN=0 F  S VPRN=$O(^TMP("MDHSP",$J,VPRN)) Q:VPRN<1  S VPRX=$G(^(VPRN)) D
"RTN","VPRDMC",39,0)
 . I $G(ID),ID'=+$P(VPRX,U,2) Q              ;update one procedure
"RTN","VPRDMC",40,0)
 . S RTN=$P(VPRX,U,3,4) Q:RTN="PRPRO^MDPS4"  ;skip non-CP items
"RTN","VPRDMC",41,0)
 . S X=$P(VPRX,U,6),%DT="STX" D ^%DT S:Y>0 DATE=Y
"RTN","VPRDMC",42,0)
 . S GBL=+$P(VPRX,U,2)_";"_$S(RTN="PR702^MDPS1":"MDD(702,",1:$$ROOT(DFN,$P(VPRX,U,11),DATE))
"RTN","VPRDMC",43,0)
 . Q:'GBL  I $G(ID),ID'=GBL Q                ;unknown, or not requested
"RTN","VPRDMC",44,0)
 . ;
"RTN","VPRDMC",45,0)
 . S CONS=+$P(VPRX,U,13) D:CONS DOCLIST^GMRCGUIB(.VPRD,CONS) S X0=$G(VPRD(0)) ;=^GMR(123,ID,0)
"RTN","VPRDMC",46,0)
 . S TIUN=+$P(VPRX,U,14) S:TIUN TIUN=TIUN_U_$$RESOLVE^TIUSRVLO(TIUN)
"RTN","VPRDMC",47,0)
A . ;
"RTN","VPRDMC",48,0)
 . K VPRITM S VPRITM("id")=GBL,VPRITM("name")=$P(VPRX,U)
"RTN","VPRDMC",49,0)
 . S VPRITM("dateTime")=DATE,VPRITM("category")="CP"
"RTN","VPRDMC",50,0)
 . S X=$P(VPRX,U,7) S:$L(X) VPRITM("interpretation")=X
"RTN","VPRDMC",51,0)
 . I CONS,X0 D
"RTN","VPRDMC",52,0)
 .. N VPRJ S VPRITM("consult")=CONS
"RTN","VPRDMC",53,0)
 .. S VPRITM("requested")=+X0,VPRITM("order")=+$P(X0,U,3)
"RTN","VPRDMC",54,0)
 .. S VPRITM("status")=$$EXTERNAL^DILFD(123,8,,$P(X0,U,12))
"RTN","VPRDMC",55,0)
 .. S VPRJ=0 F  S VPRJ=$O(VPRD(50,VPRJ)) Q:VPRJ<1  S X=+$G(VPRD(50,VPRJ)) D
"RTN","VPRDMC",56,0)
 ... N Y S Y=$$INFO^VPRDTIU(+X) Q:Y<1  ;draft or retracted
"RTN","VPRDMC",57,0)
 ... S VPRITM("document",X)=Y  ;ien^local^national title^VUID
"RTN","VPRDMC",58,0)
 ... S:$G(VPRTEXT) VPRITM("document",X,"content")=$$TEXT^VPRDTIU(X)
"RTN","VPRDMC",59,0)
 ... S:'TIUN TIUN=X ;get supporting fields
"RTN","VPRDMC",60,0)
B . ;
"RTN","VPRDMC",61,0)
 . I TIUN D
"RTN","VPRDMC",62,0)
 .. S X=$P(TIUN,U,5) S:X VPRITM("provider")=+X_U_$P(X,";",3)_U_$$PROVSPC^VPRD(+X)
"RTN","VPRDMC",63,0)
 .. S:$P(TIUN,U,11) VPRITM("hasImages")=1
"RTN","VPRDMC",64,0)
 .. K VPRT D EXTRACT^TIULQ(+TIUN,"VPRT",,".03;.05;1211",,,"I")
"RTN","VPRDMC",65,0)
 .. S VPRITM("encounter")=+$G(VPRT(+TIUN,.03,"I"))
"RTN","VPRDMC",66,0)
 .. S LOC=+$G(VPRT(+TIUN,1211,"I")) I LOC S LOC=LOC_U_$P($G(^SC(LOC,0)),U)
"RTN","VPRDMC",67,0)
 .. E  S X=$P(TIUN,U,6) S:$L(X) LOC=+$O(^SC("B",X,0))_U_X
"RTN","VPRDMC",68,0)
 .. S:LOC VPRITM("location")=LOC,VPRITM("facility")=$$FAC^VPRD(+LOC)
"RTN","VPRDMC",69,0)
 .. I '$D(VPRITM("status")) S X=+$G(VPRT(+TIUN,.05,"I")),VPRITM("status")=$S(X<6:"PARTIAL RESULTS",1:"COMPLETE")
"RTN","VPRDMC",70,0)
 .. I '$G(VPRITM("document",+TIUN)) D
"RTN","VPRDMC",71,0)
 ... N Y S Y=$$INFO^VPRDTIU(+TIUN) Q:Y<1  ;draft or retracted
"RTN","VPRDMC",72,0)
 ... S VPRITM("document",+TIUN)=Y  ;ien^local^national title^VUID
"RTN","VPRDMC",73,0)
 ... S:$G(VPRTEXT) VPRITM("document",+TIUN,"content")=$$TEXT^VPRDTIU(+TIUN)
"RTN","VPRDMC",74,0)
C . ;
"RTN","VPRDMC",75,0)
 . ; if no consult or note/visit ...
"RTN","VPRDMC",76,0)
 . I TIUN<1 D
"RTN","VPRDMC",77,0)
 .. S VPRITM("document",1)=GBL_U_$P(VPRX,U)_"^PROCEDURE REPORT^4696566"
"RTN","VPRDMC",78,0)
 .. S:$G(VPRTEXT) VPRITM("document",1,"content")=$$TEXT(DFN,GBL,$P(VPRX,U,11))
"RTN","VPRDMC",79,0)
 . I '$D(VPRITM("facility")) S X=$P(X0,U,21),VPRITM("facility")=$S(X:$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U),1:$$FAC^VPRD)
"RTN","VPRDMC",80,0)
 . I '$D(VPRITM("status")) S VPRITM("status")="COMPLETE"
"RTN","VPRDMC",81,0)
 . ;I DA D  ;get CPT code from #697.2
"RTN","VPRDMC",82,0)
 . ;. K VPRT D GETS^DIQ(697.2,DA_",","1000*",,"VPRT")
"RTN","VPRDMC",83,0)
 . ;. N IENS S IENS=$O(VPRT(697.21,"")) Q:IENS=""
"RTN","VPRDMC",84,0)
 . ;. S X=VPRT(697.21,IENS,.01),VPRITM("type")=$$CPT(X)
"RTN","VPRDMC",85,0)
 . ;
"RTN","VPRDMC",86,0)
 . D XML(.VPRITM)
"RTN","VPRDMC",87,0)
ENQ ;
"RTN","VPRDMC",88,0)
 K ^TMP("MDHSP",$J),^TMP("VPRTEXT",$J)
"RTN","VPRDMC",89,0)
 Q
"RTN","VPRDMC",90,0)
 ;
"RTN","VPRDMC",91,0)
ROOT(DFN,NAME,DATE) ; -- return vptr ID for procedure instance
"RTN","VPRDMC",92,0)
 N VPRMC,Y
"RTN","VPRDMC",93,0)
 D SUB^MCARUTL2(.VPRMC,DFN,NAME,DATE,DATE)
"RTN","VPRDMC",94,0)
 S Y=$S(+$G(VPRMC):$P($G(VPRMC(VPRMC)),U,4)_",",1:"")
"RTN","VPRDMC",95,0)
 Q Y
"RTN","VPRDMC",96,0)
 ;
"RTN","VPRDMC",97,0)
CPT(IEN) ; -- return code^description for CPT code, or "^" if error
"RTN","VPRDMC",98,0)
 N X0,VPRX,N,I,X,Y S IEN=+$G(IEN)
"RTN","VPRDMC",99,0)
 S X0=$$CPT^ICPTCOD(IEN) I X0<0 Q "^"
"RTN","VPRDMC",100,0)
 S Y=$P(X0,U,2,3)                   ;CPT Code^Short Name
"RTN","VPRDMC",101,0)
 S N=$$CPTD^ICPTCOD($P(Y,U),"VPRX") ;CPT Description
"RTN","VPRDMC",102,0)
 I N>0,$L($G(VPRX(1))) D
"RTN","VPRDMC",103,0)
 . S X=$G(VPRX(1)),I=1
"RTN","VPRDMC",104,0)
 . F  S I=$O(VPRX(I)) Q:I<1  Q:VPRX(I)=" "  S X=X_" "_VPRX(I)
"RTN","VPRDMC",105,0)
 . S $P(Y,U,2)=X
"RTN","VPRDMC",106,0)
 Q Y
"RTN","VPRDMC",107,0)
 ;
"RTN","VPRDMC",108,0)
 ; ------------ Get report(s) [via VPRDTIU] ------------
"RTN","VPRDMC",109,0)
 ;
"RTN","VPRDMC",110,0)
RPTS(DFN,BEG,END,MAX) ; -- find patient's medicine reports
"RTN","VPRDMC",111,0)
 N VPRITM,VPRN,VPRX,RTN,TIUN,CONS,VPRD,I,DA,X,Y,%DT,DATE,GBL,RES
"RTN","VPRDMC",112,0)
 S DFN=+$G(DFN) Q:$G(DFN)<1
"RTN","VPRDMC",113,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999),RES=""
"RTN","VPRDMC",114,0)
 K ^TMP("MDHSP",$J) D EN1^MDPS1(RES,DFN,BEG,END,MAX,"",0)
"RTN","VPRDMC",115,0)
 S VPRN=0 F  S VPRN=$O(^TMP("MDHSP",$J,VPRN)) Q:VPRN<1  S VPRX=$G(^(VPRN)) D
"RTN","VPRDMC",116,0)
 . S RTN=$P(VPRX,U,3,4) ;Q:RTN="PRPRO^MDPS4"  ;skip non-CP items
"RTN","VPRDMC",117,0)
 . S TIUN=+$P(VPRX,U,14) K VPRITM
"RTN","VPRDMC",118,0)
 . I TIUN,$$INFO^VPRDTIU(TIUN)>0 D EN1^VPRDTIU(TIUN,.VPRITM),XML^VPRDTIU(.VPRITM):$D(VPRITM)
"RTN","VPRDMC",119,0)
 . S CONS=+$P(VPRX,U,13) D:CONS DOCLIST^GMRCGUIB(.VPRD,CONS)
"RTN","VPRDMC",120,0)
 . S I=0 F  S I=$O(VPRD(50,I)) Q:I<1  D
"RTN","VPRDMC",121,0)
 .. K VPRITM S DA=+VPRD(50,I) Q:DA=TIUN  Q:$$INFO^VPRDTIU(DA)<1
"RTN","VPRDMC",122,0)
 .. D EN1^VPRDTIU(DA,.VPRITM),XML^VPRDTIU(.VPRITM):$D(VPRITM)
"RTN","VPRDMC",123,0)
 . Q:TIUN!$G(DA)                             ;done [got TIU note(s)]
"RTN","VPRDMC",124,0)
 . Q:RTN="PR702^MDPS1"                       ;CP, but no TIU note yet
"RTN","VPRDMC",125,0)
 . Q:RTN="PRPRO^MDPS4"                       ;non-CP procedure
"RTN","VPRDMC",126,0)
 . ; find ID for pre-TIU report
"RTN","VPRDMC",127,0)
 . S X=$P(VPRX,U,6),%DT="TX" D ^%DT S:Y>0 DATE=Y
"RTN","VPRDMC",128,0)
 . S GBL=+$P(VPRX,U,2)_";"_$$ROOT(DFN,$P(VPRX,U,11),DATE)
"RTN","VPRDMC",129,0)
 . I GBL D RPT1(DFN,GBL,.VPRITM),XML^VPRDTIU(.VPRITM):$D(VPRITM)
"RTN","VPRDMC",130,0)
 K ^TMP("MDHSP",$J),^TMP("VPRTEXT",$J)
"RTN","VPRDMC",131,0)
 Q
"RTN","VPRDMC",132,0)
 ;
"RTN","VPRDMC",133,0)
RPT1(DFN,ID,RPT) ; -- return report as a TIU document
"RTN","VPRDMC",134,0)
 S DFN=+$G(DFN),ID=$G(ID) Q:DFN<1  Q:'$L(ID)
"RTN","VPRDMC",135,0)
 N VPRY,VPRFN,X
"RTN","VPRDMC",136,0)
 S VPRFN=+$P(ID,"(",2)
"RTN","VPRDMC",137,0)
 D MEDLKUP^MCARUTL3(.VPRY,VPRFN,+ID)
"RTN","VPRDMC",138,0)
 S RPT("id")=ID,RPT("referenceDateTime")=$P(VPRY,U,6)
"RTN","VPRDMC",139,0)
 S RPT("localTitle")=$P(VPRY,U,9),RPT("category")="CP"
"RTN","VPRDMC",140,0)
 S RPT("documentClass")="CLINICAL PROCEDURES"
"RTN","VPRDMC",141,0)
 S RPT("nationalTitle")="4696566^PROCEDURE REPORT"
"RTN","VPRDMC",142,0)
 S RPT("nationalTitleService")="4696471^PROCEDURE"
"RTN","VPRDMC",143,0)
 S RPT("nationalTitleType")="4696123^REPORT"
"RTN","VPRDMC",144,0)
 S:$G(FILTER("loinc")) RPT("loinc")=$P(FILTER("loinc"),U)
"RTN","VPRDMC",145,0)
 S X=$$GET1^DIQ(VPRFN,+ID_",",1506)
"RTN","VPRDMC",146,0)
 S RPT("status")=$S($L(X):X,1:"COMPLETED")
"RTN","VPRDMC",147,0)
 S X=+$$GET1^DIQ(VPRFN,+ID_",",701,"I")
"RTN","VPRDMC",148,0)
 S:X RPT("clinician",1)=X_U_$P($G(^VA(200,X,0)),U)_"^A^^^"_$$PROVSPC^VPRD(X)
"RTN","VPRDMC",149,0)
 S X=+$$GET1^DIQ(VPRFN,+ID_",",1503,"I")
"RTN","VPRDMC",150,0)
 S:X RPT("clinician",2)=X_U_$P($G(^VA(200,X,0)),U)_"^S^"_$$GET1^DIQ(VPRFN,+ID_",",1505,"I")_U_$$SIG^VPRDTIU(X)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDMC",151,0)
 ; RPT("encounter")=$$GET1^DIQ(VPRFN,+ID_",",900,"I")
"RTN","VPRDMC",152,0)
 S RPT("facility")=$$FAC^VPRD
"RTN","VPRDMC",153,0)
 S:$G(VPRTEXT) RPT("content")=$$TEXT(DFN,ID,$P(VPRY,U,9))
"RTN","VPRDMC",154,0)
 Q
"RTN","VPRDMC",155,0)
 ;
"RTN","VPRDMC",156,0)
TEXT(DFN,ID,NAME) ; -- Get report text, return temp array name
"RTN","VPRDMC",157,0)
 N MCARGDA,MCPRO,MDALL,I,X,Y
"RTN","VPRDMC",158,0)
 S MCARGDA=+$G(ID),MCPRO=NAME,MDALL=1 D PR690^MDPS1
"RTN","VPRDMC",159,0)
 K ^TMP("VPRTEXT",$J,ID)
"RTN","VPRDMC",160,0)
 S I=0 F  S I=$O(^TMP("MDPTXT",$J,MCARGDA,MCPRO,I)) Q:I<1  S X=$G(^(I,0)),^TMP("VPRTEXT",$J,ID,I)=X
"RTN","VPRDMC",161,0)
 S Y=$NA(^TMP("VPRTEXT",$J,ID))
"RTN","VPRDMC",162,0)
 K ^TMP("MDPTXT",$J)
"RTN","VPRDMC",163,0)
 Q Y
"RTN","VPRDMC",164,0)
 ;
"RTN","VPRDMC",165,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDMC",166,0)
 ;
"RTN","VPRDMC",167,0)
XML(PROC) ; -- Return patient procedure as XML
"RTN","VPRDMC",168,0)
 ;  as <element code='123' displayName='ABC' />
"RTN","VPRDMC",169,0)
 N ATT,X,Y,I,J,NAMES
"RTN","VPRDMC",170,0)
 D ADD("<procedure>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDMC",171,0)
 S ATT="" F  S ATT=$O(PROC(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDMC",172,0)
 . S NAMES=$S(ATT="document":"id^localTitle^nationalTitle^vuid",ATT="provider":"code^name^"_$$PROVTAGS^VPRD,1:"code^name")_"^Z"
"RTN","VPRDMC",173,0)
 . I $O(PROC(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDMC",174,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDMC",175,0)
 .. S I=0 F  S I=$O(PROC(ATT,I)) Q:I<1  D
"RTN","VPRDMC",176,0)
 ... S X=$G(PROC(ATT,I)),Y="<"_ATT_" "_$$LOOP
"RTN","VPRDMC",177,0)
 ... S X=$G(PROC(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDMC",178,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDMC",179,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDMC",180,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDMC",181,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDMC",182,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDMC",183,0)
 . S X=$G(PROC(ATT)),Y="" Q:'$L(X)
"RTN","VPRDMC",184,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDMC",185,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDMC",186,0)
 D ADD("</procedure>")
"RTN","VPRDMC",187,0)
 Q
"RTN","VPRDMC",188,0)
 ;
"RTN","VPRDMC",189,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDMC",190,0)
 N STR,P,TAG S STR=""
"RTN","VPRDMC",191,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDMC",192,0)
 Q STR
"RTN","VPRDMC",193,0)
 ;
"RTN","VPRDMC",194,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDMC",195,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDMC",196,0)
 S @VPR@(VPRI)=X
"RTN","VPRDMC",197,0)
 Q
"RTN","VPRDOR")
0^4^B27908661^B17346787
"RTN","VPRDOR",1,0)
VPRDOR ;SLC/MKB -- Orders extract ;8/2/11  15:29
"RTN","VPRDOR",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,4,5**;Sep 01, 2011;Build 21
"RTN","VPRDOR",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDOR",4,0)
 ;
"RTN","VPRDOR",5,0)
 ; External References          DBIA#
"RTN","VPRDOR",6,0)
 ; -------------------          -----
"RTN","VPRDOR",7,0)
 ; ^OR(100)                      5771
"RTN","VPRDOR",8,0)
 ; ^ORA(102.4)                   5769
"RTN","VPRDOR",9,0)
 ; ^ORD(100.98)                   873
"RTN","VPRDOR",10,0)
 ; ^ORD(101.43)                  2843
"RTN","VPRDOR",11,0)
 ; ^SC                          10040
"RTN","VPRDOR",12,0)
 ; ^VA(200)                     10060
"RTN","VPRDOR",13,0)
 ; DIQ                           2056
"RTN","VPRDOR",14,0)
 ; ORQ1,^TMP("ORR",$J)           3154
"RTN","VPRDOR",15,0)
 ; ORQ12,^TMP("ORGOTIT",$J)      5704
"RTN","VPRDOR",16,0)
 ; ORX8                     2467,3071
"RTN","VPRDOR",17,0)
 ;
"RTN","VPRDOR",18,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDOR",19,0)
 ;
"RTN","VPRDOR",20,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find a patient's orders
"RTN","VPRDOR",21,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDOR",22,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDOR",23,0)
 N ORLIST,ORDG,ORFLG,ORIGVIEW,ORACT,ORDER,VPRN,VPRITM,VPRCNT
"RTN","VPRDOR",24,0)
 ;
"RTN","VPRDOR",25,0)
 ; get one order
"RTN","VPRDOR",26,0)
 I $G(IFN) D  G ENQ
"RTN","VPRDOR",27,0)
 . N ORLST S ORLST=0,ORLIST=$H
"RTN","VPRDOR",28,0)
 . S:$P(IFN,";",2)'>1 ORIGVIEW=2 ;force orig order text
"RTN","VPRDOR",29,0)
 . D GET^ORQ12(+IFN,ORLIST,1,$P(IFN,";",2)) S VPRN=1
"RTN","VPRDOR",30,0)
 . D EN1(VPRN,.VPRITM),XML(.VPRITM)
"RTN","VPRDOR",31,0)
 . K ^TMP("ORGOTIT",$J)
"RTN","VPRDOR",32,0)
 ;
"RTN","VPRDOR",33,0)
 ; get [all] orders
"RTN","VPRDOR",34,0)
 S ORDG=$G(FILTER("group"),"ALL"),ORDG=+$O(^ORD(100.98,"B",ORDG,0))
"RTN","VPRDOR",35,0)
 S ORFLG=+$G(FILTER("view"),6) ;default = Released Orders
"RTN","VPRDOR",36,0)
 S ORACT=$S("^2^8^9^10^11^13^14^20^21^"[(U_ORFLG_U):1,1:0)
"RTN","VPRDOR",37,0)
 I 'ORACT S ORIGVIEW=2 ;get original view of order unless action req'd
"RTN","VPRDOR",38,0)
 D EN^ORQ1(DFN_";DPT(",ORDG,ORFLG,,BEG,END,1,1) S VPRCNT=0
"RTN","VPRDOR",39,0)
 S VPRN=0 F  S VPRN=$O(^TMP("ORR",$J,ORLIST,VPRN)) Q:VPRN<1  S ORDER=$G(^(VPRN)) D  Q:VPRCNT'<MAX
"RTN","VPRDOR",40,0)
 . I $P($P(ORDER,U),";",2)>1,'$G(ORACT) Q  ;skip order actions
"RTN","VPRDOR",41,0)
 . K VPRITM D EN1(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDOR",42,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDOR",43,0)
ENQ ; end
"RTN","VPRDOR",44,0)
 K ^TMP("ORR",$J),^TMP("VPRTEXT",$J)
"RTN","VPRDOR",45,0)
 Q
"RTN","VPRDOR",46,0)
 ;
"RTN","VPRDOR",47,0)
EN1(NUM,ORD) ; -- return an order in ORD("attribute")=value
"RTN","VPRDOR",48,0)
 ;  from EN: expects ^TMP("ORR",$J,ORLIST,VPRN)
"RTN","VPRDOR",49,0)
 N X0,X8,IFN,OI,LOC,PKG,ORPK,X,DA
"RTN","VPRDOR",50,0)
 K ORD,^TMP("VPRTEXT",$J)
"RTN","VPRDOR",51,0)
 S X0=$G(^TMP("ORR",$J,ORLIST,NUM)),IFN=$P(X0,U)
"RTN","VPRDOR",52,0)
 S ORD("id")=IFN,OI=$$OI^ORX8(+IFN),ORD("name")=$P(OI,U,1,2)
"RTN","VPRDOR",53,0)
 S ORD("codingSystem")=$P($G(^ORD(101.43,+OI,0)),U,3,4)
"RTN","VPRDOR",54,0)
 S ORD("group")=$P(X0,U,2),ORD("entered")=$P(X0,U,3)
"RTN","VPRDOR",55,0)
 S ORD("start")=$P(X0,U,4),ORD("stop")=$P(X0,U,5)
"RTN","VPRDOR",56,0)
 S ORD("status")=$P(X0,U,7)_U_$P(X0,U,6)_U_$$STS($P(X0,U,7))
"RTN","VPRDOR",57,0)
 M ^TMP("VPRTEXT",$J,IFN)=^TMP("ORR",$J,ORLIST,VPRN,"TX")
"RTN","VPRDOR",58,0)
 S ORD("content")=$NA(^TMP("VPRTEXT",$J,IFN))
"RTN","VPRDOR",59,0)
 S X=$$GET1^DIQ(100,+IFN_",",6),LOC="" I $L(X) D
"RTN","VPRDOR",60,0)
 . S LOC=+$O(^SC("B",X,0)),ORD("location")=LOC_U_X
"RTN","VPRDOR",61,0)
 S ORD("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDOR",62,0)
 S PKG=$$GET1^DIQ(100,+IFN_",","12:1"),ORD("service")=PKG
"RTN","VPRDOR",63,0)
 S X=$P(X0,U,2),X=$S($L(X):+$O(^ORD(100.98,"B",X,0)),1:0)
"RTN","VPRDOR",64,0)
 S:X ORD("type")=$P($G(^ORD(100.98,X,0)),U,2)
"RTN","VPRDOR",65,0)
 S ORPK=$$PKGID^ORX8(+IFN)
"RTN","VPRDOR",66,0)
 S X=$S(PKG?1"PS".E:+IFN,1:ORPK)         ;order#(PS) or 4-node
"RTN","VPRDOR",67,0)
 S ORD("resultID")=$S(PKG="GMRC":+X,1:X) ;strip trailing string
"RTN","VPRDOR",68,0)
 S:PKG?1"PS".E ORD("vuid")=$$VUID^VPRDPS(+IFN)
"RTN","VPRDOR",69,0)
 I PKG="LR" D
"RTN","VPRDOR",70,0)
 . N LNC S LNC=$$LOINC^VPRDLR(DFN,ORPK,+$P(OI,U,3)) Q:'LNC
"RTN","VPRDOR",71,0)
 . S ORD("codingSystem")=LNC_"^LNC"
"RTN","VPRDOR",72,0)
 . S ORD("vuid")=$$VUID^VPRD(+LNC,95.3)
"RTN","VPRDOR",73,0)
ENA ; order [NEW] action info
"RTN","VPRDOR",74,0)
 S DA=$P(IFN,";",2) S:DA<1 DA=1
"RTN","VPRDOR",75,0)
 S X8=$G(^OR(100,+IFN,8,DA,0)),X=$P(X8,U,3)
"RTN","VPRDOR",76,0)
 S:X ORD("provider")=X_U_$P($G(^VA(200,X,0)),U)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDOR",77,0)
 S ORD("signatureStatus")=$$EXTERNAL^DILFD(100.008,4,,$P(X8,U,4))
"RTN","VPRDOR",78,0)
 S X=$P(X8,U,6) S:X ORD("signed")=X S X=$P(X8,U,5)
"RTN","VPRDOR",79,0)
 S:X ORD("signer")=X_U_$P($G(^VA(200,X,0)),U)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDOR",80,0)
 S X=$P(X8,U,16) S:X ORD("released")=X
"RTN","VPRDOR",81,0)
 I "dca"[$E(ORD("status"),1,2) D  ;discontinued
"RTN","VPRDOR",82,0)
 . N DC,X6 S X6=$G(^OR(100,+IFN,6))
"RTN","VPRDOR",83,0)
 . S DC=$P(X6,U,3),X=+$P(X6,U,2) Q:DC<1
"RTN","VPRDOR",84,0)
 . S DC=DC_U_$S(X:X_U_$P($G(^VA(200,X,0)),U),1:U)
"RTN","VPRDOR",85,0)
 . S X=$P(X6,U,5) I X="" S X=$$EXTERNAL^DILFD(100,64,,$P(X6,U,4))
"RTN","VPRDOR",86,0)
 . S ORD("discontinued")=DC_$S($L(X):U_X,1:"")
"RTN","VPRDOR",87,0)
 ; acknowledgements
"RTN","VPRDOR",88,0)
 S DA=0 F  S DA=$O(^ORA(102.4,"B",+IFN,DA)) Q:DA<1  D
"RTN","VPRDOR",89,0)
 . S X0=$G(^ORA(102.4,DA,0)) Q:'$P(X0,U,3)  ;stub - not ack'd
"RTN","VPRDOR",90,0)
 . S X=+$P(X0,U,2),X=$S(X:X_U_$P($G(^VA(200,X,0)),U),1:U)
"RTN","VPRDOR",91,0)
 . S ORD("acknowledgement",DA)=X_U_$P(X0,U,3)
"RTN","VPRDOR",92,0)
 Q
"RTN","VPRDOR",93,0)
 ;
"RTN","VPRDOR",94,0)
STS(X) ; -- return VUID for status abbreviation X
"RTN","VPRDOR",95,0)
 N Y,I,STS
"RTN","VPRDOR",96,0)
 S STS="dc^comp^hold^flag^pend^actv^exp^schd^part^dlay^unr^dc/e^canc^laps^rnew^none"
"RTN","VPRDOR",97,0)
 F I=1:1:16 Q:$P(STS,U,I)=X
"RTN","VPRDOR",98,0)
 S Y=$$VUID^VPRD(I,100.01)
"RTN","VPRDOR",99,0)
 Q Y
"RTN","VPRDOR",100,0)
 ;
"RTN","VPRDOR",101,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDOR",102,0)
 ;
"RTN","VPRDOR",103,0)
XML(ORD) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDOR",104,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDOR",105,0)
 N ATT,X,Y,I,NAMES
"RTN","VPRDOR",106,0)
 D ADD("<order>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDOR",107,0)
 S ATT="" F  S ATT=$O(ORD(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDOR",108,0)
 . S NAMES=$$LABELS(ATT)
"RTN","VPRDOR",109,0)
 . I ATT?1"ack".E D  S Y="" Q
"RTN","VPRDOR",110,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDOR",111,0)
 .. S I=0 F  S I=$O(ORD(ATT,I)) Q:I<1  D
"RTN","VPRDOR",112,0)
 ... S X=$G(ORD(ATT,I))
"RTN","VPRDOR",113,0)
 ... S Y="<"_ATT_" "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDOR",114,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDOR",115,0)
 . S X=$G(ORD(ATT)),Y="" Q:'$L(X)
"RTN","VPRDOR",116,0)
 . I ATT="content" D  S Y="" Q  ;text
"RTN","VPRDOR",117,0)
 .. S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDOR",118,0)
 .. S I=0 F  S I=$O(@X@(I)) Q:I<1  S Y=$$ESC^VPRD(@X@(I)) D ADD(Y)
"RTN","VPRDOR",119,0)
 .. D ADD("</content>")
"RTN","VPRDOR",120,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDOR",121,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDOR",122,0)
 D ADD("</order>")
"RTN","VPRDOR",123,0)
 Q
"RTN","VPRDOR",124,0)
 ;
"RTN","VPRDOR",125,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDOR",126,0)
 N STR,P,TAG S STR=""
"RTN","VPRDOR",127,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDOR",128,0)
 Q STR
"RTN","VPRDOR",129,0)
 ;
"RTN","VPRDOR",130,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDOR",131,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDOR",132,0)
 S @VPR@(VPRI)=X
"RTN","VPRDOR",133,0)
 Q
"RTN","VPRDOR",134,0)
 ;
"RTN","VPRDOR",135,0)
LABELS(X) ; -- return string of attribute labels for element X
"RTN","VPRDOR",136,0)
 N Y S Y="code^name"
"RTN","VPRDOR",137,0)
 I X?1"ack".E S Y=Y_"^date"
"RTN","VPRDOR",138,0)
 I X="status" S Y=Y_"^vuid"
"RTN","VPRDOR",139,0)
 I X="provider"!(X="signer") S Y=Y_U_$$PROVTAGS^VPRD
"RTN","VPRDOR",140,0)
 I X="discontinued" S Y="date^by^byName^reason"
"RTN","VPRDOR",141,0)
 S Y=Y_"^Z"
"RTN","VPRDOR",142,0)
 Q Y
"RTN","VPRDPROC")
0^17^B10655010^B10570617
"RTN","VPRDPROC",1,0)
VPRDPROC ;SLC/MKB -- Procedure extract ;8/2/11  15:29
"RTN","VPRDPROC",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,5**;Sep 01, 2011;Build 21
"RTN","VPRDPROC",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPROC",4,0)
 ;
"RTN","VPRDPROC",5,0)
 ; External References          DBIA#
"RTN","VPRDPROC",6,0)
 ; -------------------          -----
"RTN","VPRDPROC",7,0)
 ; RAO7PC1                       2043
"RTN","VPRDPROC",8,0)
 ; SROESTV                       3533
"RTN","VPRDPROC",9,0)
 ;
"RTN","VPRDPROC",10,0)
 ; ------------ Get procedure(s) from VistA ------------
"RTN","VPRDPROC",11,0)
 ;
"RTN","VPRDPROC",12,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's procedures
"RTN","VPRDPROC",13,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDPROC",14,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDPROC",15,0)
 ;
"RTN","VPRDPROC",16,0)
 N VPRN,VPRCNT,VPRITM,VPRY,VPRCATG
"RTN","VPRDPROC",17,0)
 S VPRCATG=$G(FILTER("category"),"SR;RA") ;NwHIN default
"RTN","VPRDPROC",18,0)
 ;
"RTN","VPRDPROC",19,0)
 ; get one procedure
"RTN","VPRDPROC",20,0)
 I $G(ID),ID'[";" D  D:$D(VPRITM) XML(.VPRITM) Q
"RTN","VPRDPROC",21,0)
 . I ID'["-" D EN1^VPRDSR(ID,.VPRITM) Q    ;Surgery
"RTN","VPRDPROC",22,0)
 . S (BEG,END)=9999999.9999=+ID D EN1^RAO7PC1(DFN,BEG,END,"1P")
"RTN","VPRDPROC",23,0)
 . D EN1^VPRDRA(ID,.VPRITM)                ;Radiology
"RTN","VPRDPROC",24,0)
 . K ^TMP($J,"RAE1")
"RTN","VPRDPROC",25,0)
 I $G(ID),ID[";" D EN^VPRDMC(DFN,,,,ID) Q  ;CP/Medicine
"RTN","VPRDPROC",26,0)
 ;
"RTN","VPRDPROC",27,0)
SR ; get all surgeries
"RTN","VPRDPROC",28,0)
 I VPRCATG'["SR" G RA
"RTN","VPRDPROC",29,0)
 N SHOWADD S SHOWADD=1 ;to omit leading '+' with note titles
"RTN","VPRDPROC",30,0)
 D LIST^SROESTV(.VPRY,DFN,BEG,END,MAX,1)
"RTN","VPRDPROC",31,0)
 S VPRN=0 F  S VPRN=$O(@VPRY@(VPRN)) Q:VPRN<1  D
"RTN","VPRDPROC",32,0)
 . K VPRITM D ONE^VPRDSR(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPROC",33,0)
 . ;Q:$G(VPRITM("status"))'?1"COMP".E
"RTN","VPRDPROC",34,0)
 . D XML(.VPRITM)
"RTN","VPRDPROC",35,0)
 K @VPRY
"RTN","VPRDPROC",36,0)
 ;
"RTN","VPRDPROC",37,0)
RA ; get all radiology exams
"RTN","VPRDPROC",38,0)
 I VPRCATG'["RA" G CP
"RTN","VPRDPROC",39,0)
 K ^TMP($J,"RAE1") D EN1^RAO7PC1(DFN,BEG,END,MAX)
"RTN","VPRDPROC",40,0)
 S VPRCNT=+$G(VPRTOTL),VPRN=""
"RTN","VPRDPROC",41,0)
 F  S VPRN=$O(^TMP($J,"RAE1",DFN,VPRN)) Q:VPRN=""   D  Q:VPRCNT'<MAX  ;I $P($P($G(^(VPRN)),U,6),"~",2)?1"COMP".E
"RTN","VPRDPROC",42,0)
 . K VPRITM D EN1^VPRDRA(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPROC",43,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDPROC",44,0)
 K ^TMP($J,"RAE1")
"RTN","VPRDPROC",45,0)
 ;
"RTN","VPRDPROC",46,0)
CP ; get CP procedures
"RTN","VPRDPROC",47,0)
 D:VPRCATG["CP" EN^VPRDMC(DFN,BEG,END,MAX)
"RTN","VPRDPROC",48,0)
 ;
"RTN","VPRDPROC",49,0)
 ; V-CPT
"RTN","VPRDPROC",50,0)
 ;
"RTN","VPRDPROC",51,0)
 Q
"RTN","VPRDPROC",52,0)
 ;
"RTN","VPRDPROC",53,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPROC",54,0)
 ;
"RTN","VPRDPROC",55,0)
XML(PROC) ; -- Return procedures as XML
"RTN","VPRDPROC",56,0)
 N ATT,X,Y,I,J,NAMES
"RTN","VPRDPROC",57,0)
 D ADD("<procedure>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPROC",58,0)
 S ATT="" F  S ATT=$O(PROC(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDPROC",59,0)
 . S NAMES=$S(ATT="document"!(ATT="opReport"):"id^localTitle^nationalTitle^vuid^status^Z",1:"code^name^Z")
"RTN","VPRDPROC",60,0)
 . I $O(PROC(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDPROC",61,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDPROC",62,0)
 .. S I=0 F  S I=$O(PROC(ATT,I)) Q:I<1  D
"RTN","VPRDPROC",63,0)
 ... S X=$G(PROC(ATT,I))
"RTN","VPRDPROC",64,0)
 ... S Y="<"_ATT_" "_$$LOOP ;_"/>" D ADD(Y)
"RTN","VPRDPROC",65,0)
 ... S X=$G(PROC(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDPROC",66,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDPROC",67,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDPROC",68,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDPROC",69,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDPROC",70,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDPROC",71,0)
 . S X=$G(PROC(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPROC",72,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPROC",73,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDPROC",74,0)
 D ADD("</procedure>")
"RTN","VPRDPROC",75,0)
 Q
"RTN","VPRDPROC",76,0)
 ;
"RTN","VPRDPROC",77,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDPROC",78,0)
 N STR,P,TAG S STR=""
"RTN","VPRDPROC",79,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDPROC",80,0)
 Q STR
"RTN","VPRDPROC",81,0)
 ;
"RTN","VPRDPROC",82,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDPROC",83,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPROC",84,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPROC",85,0)
 Q
"RTN","VPRDPS")
0^21^B21702415^B20707464
"RTN","VPRDPS",1,0)
VPRDPS ;SLC/MKB -- Pharmacy extract ;8/2/11  15:29
"RTN","VPRDPS",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,4,5**;Sep 01, 2011;Build 21
"RTN","VPRDPS",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPS",4,0)
 ;
"RTN","VPRDPS",5,0)
 ; External References          DBIA#
"RTN","VPRDPS",6,0)
 ; -------------------          -----
"RTN","VPRDPS",7,0)
 ; ^OR(100)                      5771
"RTN","VPRDPS",8,0)
 ; ORX8                          2467
"RTN","VPRDPS",9,0)
 ; PSOORRL,^TMP("PS",$J)         2400
"RTN","VPRDPS",10,0)
 ; PSS50,^TMP($J                 4533
"RTN","VPRDPS",11,0)
 ; PSS50P7,^TMP($J               4662
"RTN","VPRDPS",12,0)
 ; PSSDI                         4551
"RTN","VPRDPS",13,0)
 ;
"RTN","VPRDPS",14,0)
 ; ------------ Get medications from VistA ------------
"RTN","VPRDPS",15,0)
 ;
"RTN","VPRDPS",16,0)
EN(DFN,BEG,END,MAX,ORIFN) ; -- find patient's meds
"RTN","VPRDPS",17,0)
 N PS0,VPRN,VPRITM,TYPE,ID K ^TMP("PS",$J)
"RTN","VPRDPS",18,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDPS",19,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDPS",20,0)
 ;
"RTN","VPRDPS",21,0)
 ; get one med
"RTN","VPRDPS",22,0)
 I $G(ORIFN) D EN1^VPRDPSOR(ORIFN,.VPRITM),XML(.VPRITM):$D(VPRITM) Q
"RTN","VPRDPS",23,0)
 ;
"RTN","VPRDPS",24,0)
 ; get all meds
"RTN","VPRDPS",25,0)
 D OCL^PSOORRL(DFN,BEG,END) M ^TMP("VPRPS",$J)=^TMP("PS",$J)
"RTN","VPRDPS",26,0)
 S TYPE=$G(FILTER("vaType"))
"RTN","VPRDPS",27,0)
 S VPRN=0 F  S VPRN=$O(^TMP("VPRPS",$J,VPRN)) Q:VPRN<1!(VPRN>MAX)  S PS0=$G(^(VPRN,0)) D  I $D(VPRITM)>9 D XML(.VPRITM)
"RTN","VPRDPS",28,0)
 . S ID=$P(PS0,U),ORIFN=+$P(PS0,U,8) K VPRITM
"RTN","VPRDPS",29,0)
 . Q:'ORIFN!'$D(^OR(100,ORIFN,0))
"RTN","VPRDPS",30,0)
 . I $L(TYPE) Q:'$$MATCH
"RTN","VPRDPS",31,0)
 . D:ORIFN EN1^VPRDPSOR(ORIFN,.VPRITM)
"RTN","VPRDPS",32,0)
 K ^TMP("VPRPS",$J),^TMP("PS",$J),^TMP($J,"PSOI")
"RTN","VPRDPS",33,0)
 Q
"RTN","VPRDPS",34,0)
 ;
"RTN","VPRDPS",35,0)
MATCH() ; -- Return 1 or 0, if order matches FILTER criteria
"RTN","VPRDPS",36,0)
 N Y S Y=0
"RTN","VPRDPS",37,0)
 I ID["O" D
"RTN","VPRDPS",38,0)
 . I TYPE="N",ID["N" S Y=1 Q
"RTN","VPRDPS",39,0)
 . I TYPE="O",ID'["N" S Y=1 Q
"RTN","VPRDPS",40,0)
 . ; TYPE="S",ID'["N",$$SUPPLY(ORIFN) S Y=1 Q
"RTN","VPRDPS",41,0)
 I ID["I" D
"RTN","VPRDPS",42,0)
 . N IV S IV=$S(ID["V":1,$G(^TMP("VPRPS",$J,VPRN,"B",0)):1,1:0)
"RTN","VPRDPS",43,0)
 . I TYPE="V",IV S Y=1
"RTN","VPRDPS",44,0)
 . I TYPE="I",'IV S Y=1
"RTN","VPRDPS",45,0)
 Q Y
"RTN","VPRDPS",46,0)
 ;
"RTN","VPRDPS",47,0)
SUPPLY(ORDER) ; -- Return 1 or 0, if ORDER is for a supply item
"RTN","VPRDPS",48,0)
 N OI,Y S OI=$$OI^ORX8(ORDER),Y=0
"RTN","VPRDPS",49,0)
 D ZERO^PSS50P7(+$P(OI,U,3),,,"PSOI")
"RTN","VPRDPS",50,0)
 S Y=+$G(^TMP($J,"PSOI",+$P(OI,U,3),.09))
"RTN","VPRDPS",51,0)
 Q Y
"RTN","VPRDPS",52,0)
 ;
"RTN","VPRDPS",53,0)
NDF(DRUG,VPI,ORD) ; -- Set NDF data for dispense DRUG ien
"RTN","VPRDPS",54,0)
 N VPRX,STR,VUID,X,I
"RTN","VPRDPS",55,0)
 S DRUG=+$G(DRUG) Q:'DRUG
"RTN","VPRDPS",56,0)
 D EN^PSSDI(50,,50,"901;902",DRUG,"VPRX")
"RTN","VPRDPS",57,0)
 S STR=$S($G(VPRX(50,DRUG,901)):$G(VPRX(50,DRUG,901))_" "_$G(VPRX(50,DRUG,902)),1:"")
"RTN","VPRDPS",58,0)
 D NDF^PSS50(DRUG,,,,,"NDF") S VPI=+$G(VPI,1)
"RTN","VPRDPS",59,0)
 S MED("product",VPI)=DRUG_U_$G(^TMP($J,"NDF",DRUG,.01))_"^^D^"_STR_U_$G(ORD) ;Drug
"RTN","VPRDPS",60,0)
 S X=$G(^TMP($J,"NDF",DRUG,20)) ;VA Generic
"RTN","VPRDPS",61,0)
 S MED("product",VPI,"G")=X_U_$$VUID^VPRD(+X,50.6)
"RTN","VPRDPS",62,0)
 S X=$G(^TMP($J,"NDF",DRUG,22)) ;VA Product
"RTN","VPRDPS",63,0)
 S MED("product",VPI,"P")=X_U_$$VUID^VPRD(+X,50.68)
"RTN","VPRDPS",64,0)
 S X=$G(^TMP($J,"NDF",DRUG,25)) ;VA Drug Class
"RTN","VPRDPS",65,0)
 S MED("product",VPI,"C")=$P(X,U,2,3)_U_$$VUID^VPRD(+X,50.605)
"RTN","VPRDPS",66,0)
 K ^TMP($J,"NDF",DRUG)
"RTN","VPRDPS",67,0)
 Q
"RTN","VPRDPS",68,0)
 ;
"RTN","VPRDPS",69,0)
VUID(ORDER) ; -- return VUID for VA Product in ORDER
"RTN","VPRDPS",70,0)
 N X,Y,DRUG S Y=""
"RTN","VPRDPS",71,0)
 S DRUG=$$VALUE^ORX8(+$G(ORDER),"DRUG")
"RTN","VPRDPS",72,0)
 I DRUG D
"RTN","VPRDPS",73,0)
 . D NDF^PSS50(DRUG,,,,,"NDF")
"RTN","VPRDPS",74,0)
 . S X=$G(^TMP($J,"NDF",DRUG,22)),Y=$$VUID^VPRD(+X,50.68)
"RTN","VPRDPS",75,0)
 . K ^TMP($J,"NDF")
"RTN","VPRDPS",76,0)
 Q Y
"RTN","VPRDPS",77,0)
 ;
"RTN","VPRDPS",78,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPS",79,0)
 ;
"RTN","VPRDPS",80,0)
XML(MED) ; -- Return patient meds as XML
"RTN","VPRDPS",81,0)
 N ATT,X,Y,I,NAMES
"RTN","VPRDPS",82,0)
 D ADD("<med>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPS",83,0)
 S ATT="" F  S ATT=$O(MED(ATT)) Q:ATT=""  D  I $L(Y) D ADD(Y)
"RTN","VPRDPS",84,0)
 . I $O(MED(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDPS",85,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDPS",86,0)
 .. S I=0 F  S I=$O(MED(ATT,I)) Q:I<1  D
"RTN","VPRDPS",87,0)
 ... S X=$G(MED(ATT,I)),NAMES=""
"RTN","VPRDPS",88,0)
 ... I ATT="dose" S NAMES="dose^units^unitsPerDose^noun^route^schedule^duration^conjunction^doseStart^doseStop^order^Z"
"RTN","VPRDPS",89,0)
 ... I ATT="fill" S NAMES="fillDate^fillRouting^releaseDate^fillQuantity^fillDaysSupply^partial^Z"
"RTN","VPRDPS",90,0)
 ... I ATT="product" S NAMES="code^name^vuid^role^concentration^order^Z"
"RTN","VPRDPS",91,0)
 ... S Y="<"_ATT_" "_$$LOOP_$S(ATT'="product":"/>",1:">") D ADD(Y)
"RTN","VPRDPS",92,0)
 ... Q:ATT'="product"
"RTN","VPRDPS",93,0)
 ... S X=$G(MED(ATT,I,"O")) I $L(X) S Y="<ordItem "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPS",94,0)
 ... S X=$G(MED(ATT,I,"C")) I $L(X) S Y="<class "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPS",95,0)
 ... S X=$G(MED(ATT,I,"G")) I $L(X) S Y="<vaGeneric "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPS",96,0)
 ... S X=$G(MED(ATT,I,"P")) I $L(X) S Y="<vaProduct "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPS",97,0)
 ... D ADD("</product>")
"RTN","VPRDPS",98,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDPS",99,0)
 . S X=$G(MED(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPS",100,0)
 . I ATT="sig"!(ATT?1"ptIn"1.A) S Y="<"_ATT_" xml:space='preserve'>"_$$ESC^VPRD(X)_"</"_ATT_">" Q
"RTN","VPRDPS",101,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPS",102,0)
 . I $L(X)>1 S NAMES="code^name"_$S(ATT["Provider":U_$$PROVTAGS^VPRD,1:"")_"^Z",Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDPS",103,0)
 D ADD("</med>")
"RTN","VPRDPS",104,0)
 Q
"RTN","VPRDPS",105,0)
 ;
"RTN","VPRDPS",106,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDPS",107,0)
 N STR,P,TAG S STR=""
"RTN","VPRDPS",108,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDPS",109,0)
 Q STR
"RTN","VPRDPS",110,0)
 ;
"RTN","VPRDPS",111,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDPS",112,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPS",113,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPS",114,0)
 Q
"RTN","VPRDPT")
0^5^B99429749^B81010751
"RTN","VPRDPT",1,0)
VPRDPT ;SLC/MKB -- Patient demographics extract ;8/11/11  15:29
"RTN","VPRDPT",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,4,5**;Sep 01, 2011;Build 21
"RTN","VPRDPT",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPT",4,0)
 ;
"RTN","VPRDPT",5,0)
 ; External References          DBIA#
"RTN","VPRDPT",6,0)
 ; -------------------          -----
"RTN","VPRDPT",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDPT",8,0)
 ; ^DGSL(38.1                     767
"RTN","VPRDPT",9,0)
 ; ^DIC(4                       10090
"RTN","VPRDPT",10,0)
 ; ^DIC(31                        733
"RTN","VPRDPT",11,0)
 ; ^DIC(42                  723,10039
"RTN","VPRDPT",12,0)
 ; ^DPT               3581,5597,10035
"RTN","VPRDPT",13,0)
 ; DGCV                          4156
"RTN","VPRDPT",14,0)
 ; DGMSTAPI                      2716
"RTN","VPRDPT",15,0)
 ; DGNTAPI                       3457
"RTN","VPRDPT",16,0)
 ; DGPFAPI                       3860
"RTN","VPRDPT",17,0)
 ; DGRPDB                        4807
"RTN","VPRDPT",18,0)
 ; DILFD                         2055
"RTN","VPRDPT",19,0)
 ; DIQ                           2056
"RTN","VPRDPT",20,0)
 ; MPIF001                       2701
"RTN","VPRDPT",21,0)
 ; SCAPMC                        1916
"RTN","VPRDPT",22,0)
 ; SCAPMCA                       2848
"RTN","VPRDPT",23,0)
 ; VADPT                        10061
"RTN","VPRDPT",24,0)
 ; VAFCTFU1                      2990
"RTN","VPRDPT",25,0)
 ; VASITE                       10112
"RTN","VPRDPT",26,0)
 ; XUAF4                         2171
"RTN","VPRDPT",27,0)
 ;
"RTN","VPRDPT",28,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDPT",29,0)
 ;
"RTN","VPRDPT",30,0)
EN(DFN,BEG,END,MAX,ID) ; -- find current patient demographics
"RTN","VPRDPT",31,0)
 ; [BEG,END,MAX,ID not currently used]
"RTN","VPRDPT",32,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDPT",33,0)
 N PAT,SYS S SYS=$$SITE^VASITE
"RTN","VPRDPT",34,0)
 D DEM,SVC,PRF,ATC,SUPP,ALIAS,FAC,INPT,PC
"RTN","VPRDPT",35,0)
 I $D(PAT)>9 D XML(.PAT)
"RTN","VPRDPT",36,0)
 Q
"RTN","VPRDPT",37,0)
 ;
"RTN","VPRDPT",38,0)
DEM ;-demographic data
"RTN","VPRDPT",39,0)
 N VADM,VA,VAERR,X
"RTN","VPRDPT",40,0)
 S X=+$$GETICN^MPIF001(DFN) S:X>1 PAT("icn")=X
"RTN","VPRDPT",41,0)
 D DEM^VADPT S X=VADM(1),PAT("fullName")=X
"RTN","VPRDPT",42,0)
 S PAT("familyName")=$P(X,","),PAT("givenNames")=$P(X,",",2,99)
"RTN","VPRDPT",43,0)
 S PAT("ssn")=$P(VADM(2),U),PAT("id")=DFN
"RTN","VPRDPT",44,0)
 S:$D(VA("BID")) PAT("bid")=$E(X)_VA("BID")
"RTN","VPRDPT",45,0)
 S PAT("dob")=+$P($P(VADM(3),U),".")
"RTN","VPRDPT",46,0)
 S PAT("gender")=$P(VADM(5),U)
"RTN","VPRDPT",47,0)
 S PAT("lrdfn")=+$G(^DPT(DFN,"LR"))
"RTN","VPRDPT",48,0)
 S X=+$P($P(VADM(6),U),".") S:X PAT("died")=X
"RTN","VPRDPT",49,0)
 S X=$$GET1^DIQ(38.1,DFN_",",2,"I") S:$L(X) PAT("sensitive")=X
"RTN","VPRDPT",50,0)
 S X=+VADM(9) S:X PAT("religion")=X
"RTN","VPRDPT",51,0)
 S X=$P(VADM(10),U,2) S:$L(X) PAT("maritalStatus")=$E(X)
"RTN","VPRDPT",52,0)
 I VADM(11) D
"RTN","VPRDPT",53,0)
 . N I S I=0
"RTN","VPRDPT",54,0)
 . F  S I=$O(VADM(11,I)) Q:I<1  S X=+VADM(11,I),PAT("ethnicity",X)=$$GET1^DIQ(2.06,X_","_DFN_",",".01:3")
"RTN","VPRDPT",55,0)
 I VADM(12) D
"RTN","VPRDPT",56,0)
 . N I S I=0
"RTN","VPRDPT",57,0)
 . F  S I=$O(VADM(12,I)) Q:I<1  S X=+VADM(12,I),PAT("race",X)=$$GET1^DIQ(2.02,X_","_DFN_",",".01:3")
"RTN","VPRDPT",58,0)
 Q
"RTN","VPRDPT",59,0)
SVC ;-service data
"RTN","VPRDPT",60,0)
 N VAEL,VASV,VAERR,X,Y,I,AO,IR,PGF,HNC,MST,CV
"RTN","VPRDPT",61,0)
 D 7^VADPT
"RTN","VPRDPT",62,0)
 S PAT("veteran")=VAEL(4)
"RTN","VPRDPT",63,0)
 S PAT("sc")=+VAEL(3) S:VAEL(3) PAT("scPercent")=+$P(VAEL(3),U,2)
"RTN","VPRDPT",64,0)
 S:VAEL(2) PAT("servicePeriod")=$P(VAEL(2),U,2)
"RTN","VPRDPT",65,0)
 I VAEL(1) D
"RTN","VPRDPT",66,0)
 . S PAT("eligibility",+VAEL(1))=$P(VAEL(1),U,2)_"^1",I=0
"RTN","VPRDPT",67,0)
 . F  S I=$O(VAEL(1,I)) Q:I<1  S PAT("eligibility",I)=$P(VAEL(1,I),U,2)
"RTN","VPRDPT",68,0)
 S:$L(VAEL(8)) PAT("eligibilityStatus")=$P(VAEL(8),U,2)
"RTN","VPRDPT",69,0)
 S:$L(VAEL(9)) PAT("meansTest")=$P(VAEL(9),U,2)
"RTN","VPRDPT",70,0)
 ;
"RTN","VPRDPT",71,0)
 ; exposures
"RTN","VPRDPT",72,0)
 S AO=VASV(2),IR=VASV(3)
"RTN","VPRDPT",73,0)
 S PGF=VASV(11)!VASV(12)!VASV(13) ;OIF/OEF
"RTN","VPRDPT",74,0)
 S X=$$GETCUR^DGNTAPI(DFN,"HNC"),X=+($G(HNC("STAT")))
"RTN","VPRDPT",75,0)
 S HNC=$S(X=4:1,X=5:1,X=1:0,X=6:0,1:"")
"RTN","VPRDPT",76,0)
 S X=$P($$GETSTAT^DGMSTAPI(DFN),U,2),MST=$S(X="Y":1,X="N":0,1:"")
"RTN","VPRDPT",77,0)
 S X=$$CVEDT^DGCV(DFN),CV=$S(+X<0:"",+X=0:0,$P(X,U,3):1,1:0)
"RTN","VPRDPT",78,0)
 S PAT("exposures")=AO_U_IR_U_PGF_U_HNC_U_MST_U_CV
"RTN","VPRDPT",79,0)
 ;
"RTN","VPRDPT",80,0)
 ; rated disabilities [DGRPDB]
"RTN","VPRDPT",81,0)
 N VPRDIS,DIS,NM,DX
"RTN","VPRDPT",82,0)
 D RDIS^DGRPDB(DFN,.VPRDIS)
"RTN","VPRDPT",83,0)
 S I=0 F  S I=$O(VPRDIS(I)) Q:I<1  D
"RTN","VPRDPT",84,0)
 . S DIS=VPRDIS(I)
"RTN","VPRDPT",85,0)
 . S NM=$$GET1^DIQ(31,+DIS_",",.01),DX=$$GET1^DIQ(31,+DIS_",",2)
"RTN","VPRDPT",86,0)
 . S PAT("disability",+DX)=NM_U_$P(DIS,U,3)_U_$P(DIS,U,2) ;name^sc^%
"RTN","VPRDPT",87,0)
 Q
"RTN","VPRDPT",88,0)
PRF ;-patient record flags
"RTN","VPRDPT",89,0)
 N VPRPF,I,NAME,TEXT
"RTN","VPRDPT",90,0)
 Q:'$$GETACT^DGPFAPI(DFN,"VPRPF")
"RTN","VPRDPT",91,0)
 S I=0 F  S I=$O(VPRPF(I)) Q:I<1  D
"RTN","VPRDPT",92,0)
 . S NAME=$P(VPRPF(I,"FLAG"),U,2)
"RTN","VPRDPT",93,0)
 . M TEXT=VPRPF(I,"NARR")
"RTN","VPRDPT",94,0)
 . S PAT("flag",I)=NAME_U_$$STRING^VPRD(.TEXT)
"RTN","VPRDPT",95,0)
 Q
"RTN","VPRDPT",96,0)
ATC ;-address & telecom
"RTN","VPRDPT",97,0)
 N VAPA,I,X
"RTN","VPRDPT",98,0)
 S VAPA("P")="" D ADD^VADPT ;permanent address
"RTN","VPRDPT",99,0)
 S X="" F I=1:1:4 S X=X_VAPA(I)_U
"RTN","VPRDPT",100,0)
 S X=X_$P(VAPA(5),U,2)_U_$P(VAPA(11),U,2)
"RTN","VPRDPT",101,0)
 S PAT("address")=X ;street1^st2^st3^city^state^zip
"RTN","VPRDPT",102,0)
 S X=$$FORMAT(VAPA(8))_U_$$FORMAT($$GET1^DIQ(2,DFN_",",.134))_U_$$FORMAT($$GET1^DIQ(2,DFN_",",.132))
"RTN","VPRDPT",103,0)
 S PAT("telecom")=X ;home^cell^work phones
"RTN","VPRDPT",104,0)
 Q
"RTN","VPRDPT",105,0)
SUPP ;-support contacts
"RTN","VPRDPT",106,0)
 N VAOA,A,I,X,TYPE
"RTN","VPRDPT",107,0)
 F A="",1 K VAOA D
"RTN","VPRDPT",108,0)
 . S:A VAOA("A")=A D OAD^VADPT Q:'$L($G(VAOA(9)))
"RTN","VPRDPT",109,0)
 . S TYPE=$S(A=1:"ECON",1:"NOK")
"RTN","VPRDPT",110,0)
 . S PAT("support",TYPE)=VAOA(9)_U_VAOA(10) ;name^relationship
"RTN","VPRDPT",111,0)
 . S X="" F I=1:1:4 S X=X_VAOA(I)_U
"RTN","VPRDPT",112,0)
 . S X=X_$P(VAOA(5),U,2)_U_$P(VAOA(11),U,2)
"RTN","VPRDPT",113,0)
 . S PAT("support",TYPE,"address")=X ;street1^st2^st3^city^state^zip
"RTN","VPRDPT",114,0)
 . S I=$S(A=1:.33011,1:.21011),X=$$FORMAT(VAOA(8))_U_U_$$FORMAT($$GET1^DIQ(2,DFN_",",I))
"RTN","VPRDPT",115,0)
 . S PAT("support",TYPE,"telecom")=X ;home^cell^work phones
"RTN","VPRDPT",116,0)
 Q
"RTN","VPRDPT",117,0)
ALIAS ;-other names used
"RTN","VPRDPT",118,0)
 N I,X
"RTN","VPRDPT",119,0)
 S I=0 F  S I=$O(^DPT(DFN,.01,I)) Q:I<1  S X=$P($G(^(I,0)),U) D
"RTN","VPRDPT",120,0)
 . S PAT("alias",I)=X_U_$P(X,",")_U_$P(X,",",2,99)
"RTN","VPRDPT",121,0)
 Q
"RTN","VPRDPT",122,0)
FORMAT(X) ; -- enforce (xxx)xxx-xxxx phone format
"RTN","VPRDPT",123,0)
 S X=$G(X) I X?1"("3N1")"3N1"-"4N.E Q X
"RTN","VPRDPT",124,0)
 N P,N,I,Y S P=""
"RTN","VPRDPT",125,0)
 F I=1:1:$L(X) S N=$E(X,I) I N=+N S P=P_N
"RTN","VPRDPT",126,0)
 S:$L(P)<10 P=$E("0000000000",1,10-$L(P))_P
"RTN","VPRDPT",127,0)
 S Y=$S(P:"("_$E(P,1,3)_")"_$E(P,4,6)_"-"_$E(P,7,10),1:"")
"RTN","VPRDPT",128,0)
 Q Y
"RTN","VPRDPT",129,0)
FAC ;-treating facilities [see FACLIST^ORWCIRN]
"RTN","VPRDPT",130,0)
 N IFN S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDPT",131,0)
 N VPRY,HOME,LAST,I,X,IEN
"RTN","VPRDPT",132,0)
 I $L($T(TFL^VAFCTFU1)) D TFL^VAFCTFU1(.VPRY,DFN)
"RTN","VPRDPT",133,0)
 S HOME=+$P($G(^DPT(DFN,"MPI")),U,3) ;home facility
"RTN","VPRDPT",134,0)
 I $P($G(VPRY(1)),U)<0 D  Q  ;not setup
"RTN","VPRDPT",135,0)
 . S X=$O(^AUPNVSIT("AA",DFN,0)),LAST=$S(X:9999999-$P(X,"."),1:"")
"RTN","VPRDPT",136,0)
 . S X=$$SITE^VASITE
"RTN","VPRDPT",137,0)
 . S PAT("facility",+X)=$P(X,U,3)_U_$P(X,U,2)_U_LAST_U_$$GET1^DIQ(4,+X_",",60)
"RTN","VPRDPT",138,0)
 S I=0 F  S I=$O(VPRY(I)) Q:I<1  D
"RTN","VPRDPT",139,0)
 . S X=VPRY(I) Q:$P(X,U)=""  ;unknown
"RTN","VPRDPT",140,0)
 . S IEN=+$$IEN^XUAF4($P(X,U))
"RTN","VPRDPT",141,0)
 . I +X=776!(+X=200) S $P(X,U,2)="DEPT. OF DEFENSE"
"RTN","VPRDPT",142,0)
 . S PAT("facility",IEN)=$P(X,U,1,2)_U_$P($P(X,U,3),".")
"RTN","VPRDPT",143,0)
 . ; = stn# ^ name ^ last date ^ VistA domain
"RTN","VPRDPT",144,0)
 . S $P(PAT("facility",IEN),U,4)=$$GET1^DIQ(4,IEN_",",60)
"RTN","VPRDPT",145,0)
 . I IEN=HOME S $P(PAT("facility",IEN),U,5)=1
"RTN","VPRDPT",146,0)
 Q
"RTN","VPRDPT",147,0)
INPT ;-current inpt status
"RTN","VPRDPT",148,0)
 N ADM,X,VAIN,VAERR,HLOC,SVC
"RTN","VPRDPT",149,0)
 S ADM=+$G(^DPT(DFN,.105)) I ADM D
"RTN","VPRDPT",150,0)
 . D INP^VADPT S PAT("admitted")=ADM_U_+VAIN(7)
"RTN","VPRDPT",151,0)
 . S PAT("ward")=VAIN(4),PAT("roomBed")=VAIN(5)
"RTN","VPRDPT",152,0)
 . S HLOC=+$G(^DIC(42,+VAIN(4),44)),SVC=$P($G(^(0)),U,3)
"RTN","VPRDPT",153,0)
 . S PAT("location")=HLOC_U_$P(VAIN(4),U,2)
"RTN","VPRDPT",154,0)
 . S:$L(SVC) PAT("locSvc")=SVC_U_$$EXTERNAL^DILFD(42,.03,,SVC)
"RTN","VPRDPT",155,0)
 . S PAT("specialty")=VAIN(3)
"RTN","VPRDPT",156,0)
 . S PAT("attending")=VAIN(11)
"RTN","VPRDPT",157,0)
 . S X=$$FAC^VPRD(HLOC),PAT("site")=X
"RTN","VPRDPT",158,0)
 S PAT("inpatient")=$S(ADM:"true",1:"false")
"RTN","VPRDPT",159,0)
 Q
"RTN","VPRDPT",160,0)
PC ;-primary care
"RTN","VPRDPT",161,0)
 N TEAM,VPRPC,I,X,FAC,ST
"RTN","VPRDPT",162,0)
 S TEAM=$$INSTPCTM^SCAPMC(DFN) Q:'TEAM  ;teamIEN^name^instIEN^name
"RTN","VPRDPT",163,0)
 S PAT("pcTeam")=$P(TEAM,U,1,2)
"RTN","VPRDPT",164,0)
 D GETALL^SCAPMCA(DFN,,.VPRPC)
"RTN","VPRDPT",165,0)
 S I=+$O(@VPRPC@(DFN,"TM",+TEAM,0)),X=$G(^(I))
"RTN","VPRDPT",166,0)
 S:$P(X,U,4) PAT("pcAssigned")=$P(X,U,4)
"RTN","VPRDPT",167,0)
 S X=$G(@VPRPC@(DFN,"PCPR",1)) I X D
"RTN","VPRDPT",168,0)
 . S PAT("pcProvider")=$P(X,U,1,2)_U_$$PROVSPC^VPRD(+X)
"RTN","VPRDPT",169,0)
 . S FAC=$P(TEAM,U,3,4) S:FAC<1 FAC=$$SITE^VASITE
"RTN","VPRDPT",170,0)
 . S X=$$PADD^XUAF4(+FAC) ;street^city^st^zip
"RTN","VPRDPT",171,0)
 . S ST=$$GET1^DIQ(4,+FAC_",",.02) S:ST="" ST=$P(X,U,3) ;get state name
"RTN","VPRDPT",172,0)
 . S PAT("pcProvider","address")=$P(X,U)_"^^^"_$P(X,U,2)_U_ST_U_$P(X,U,4)
"RTN","VPRDPT",173,0)
 K @VPRPC
"RTN","VPRDPT",174,0)
 Q
"RTN","VPRDPT",175,0)
 ;
"RTN","VPRDPT",176,0)
ZPC ;-primary care [hold this version for now]
"RTN","VPRDPT",177,0)
 N TEAM,X,VPRT,I,POS,FAC,ST
"RTN","VPRDPT",178,0)
 S TEAM=$$INSTPCTM^SCAPMC(DFN) I TEAM D  ;teamIEN^name^instIEN^name
"RTN","VPRDPT",179,0)
 . S PAT("pcTeam")=$P(TEAM,U,1,2)
"RTN","VPRDPT",180,0)
 . S X=$$PRTM^SCAPMC(+TEAM,,,,.VPRT) Q:'X
"RTN","VPRDPT",181,0)
 . S I=0 F  S I=$O(@VPRT@(I)) Q:I<1  D
"RTN","VPRDPT",182,0)
 .. S X=$G(@VPRT@(I))
"RTN","VPRDPT",183,0)
 .. S POS=$S($L($P(X,U,8)):$P(X,U,8),1:$P(X,U,4))
"RTN","VPRDPT",184,0)
 .. S PAT("pcTeamMember",I)=$P(X,U,1,2)_U_POS_U_$$PROVSPC^VPRD(+X)
"RTN","VPRDPT",185,0)
 S X=$$OUTPTPR^SDUTL3(DFN) I X D
"RTN","VPRDPT",186,0)
 . S PAT("pcProvider")=X_U_$$PROVSPC^VPRD(+X)
"RTN","VPRDPT",187,0)
 . S FAC=$P(TEAM,U,3,4) S:FAC<1 FAC=$$SITE^VASITE
"RTN","VPRDPT",188,0)
 . S X=$$PADD^XUAF4(+FAC) ;street^city^st^zip
"RTN","VPRDPT",189,0)
 . S ST=$$GET1^DIQ(4,+FAC_",",.02) S:ST="" ST=$P(X,U,3) ;get state name
"RTN","VPRDPT",190,0)
 . S PAT("pcProvider","address")=$P(X,U)_"^^^"_$P(X,U,2)_U_ST_U_$P(X,U,4)
"RTN","VPRDPT",191,0)
 Q
"RTN","VPRDPT",192,0)
 ;
"RTN","VPRDPT",193,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPT",194,0)
 ;
"RTN","VPRDPT",195,0)
XML(ITEM) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDPT",196,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDPT",197,0)
 N ATT,X,Y,NAMES,I,ID
"RTN","VPRDPT",198,0)
 D ADD("<patient>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPT",199,0)
 S ATT="" F  S ATT=$O(ITEM(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDPT",200,0)
 . S X=$G(ITEM(ATT)),NAMES=$$LABELS(ATT),Y=""
"RTN","VPRDPT",201,0)
 . I ATT="pcProvider" D  Q
"RTN","VPRDPT",202,0)
 .. S Y="<"_ATT_" "_$$LOOP_">" D ADD(Y)
"RTN","VPRDPT",203,0)
 .. S X=$G(ITEM(ATT,"address")) I $L(X) D ADDR(X)
"RTN","VPRDPT",204,0)
 .. D ADD("</"_ATT_">") S Y=""
"RTN","VPRDPT",205,0)
 . ;
"RTN","VPRDPT",206,0)
 . I $L($O(ITEM(ATT,""))) D  Q  ;multiples
"RTN","VPRDPT",207,0)
 .. S ID=$S($E(ATT,$L(ATT))="s":ATT_"es",$E(ATT,$L(ATT))="y":$E(ATT,1,$L(ATT)-1)_"ies",1:ATT_"s")
"RTN","VPRDPT",208,0)
 .. D ADD("<"_ID_">")
"RTN","VPRDPT",209,0)
 .. S I="" F  S I=$O(ITEM(ATT,I)) Q:I=""  D
"RTN","VPRDPT",210,0)
 ... S X=ITEM(ATT,I),Y="<"_ATT_" "
"RTN","VPRDPT",211,0)
 ... I ATT="support" D  S Y="" Q
"RTN","VPRDPT",212,0)
 .... S Y=Y_"contactType='"_I_"' "_$$LOOP_">" D ADD(Y)
"RTN","VPRDPT",213,0)
 .... S X=$G(ITEM(ATT,I,"address")) I $L(X) D ADDR(X)
"RTN","VPRDPT",214,0)
 .... S X=$G(ITEM(ATT,I,"telecom")) I $L(X) D PHONE(X)
"RTN","VPRDPT",215,0)
 .... D ADD("</support>")
"RTN","VPRDPT",216,0)
 ... I ATT="disability" S Y=Y_"vaCode='"_I_"' "
"RTN","VPRDPT",217,0)
 ... S Y=Y_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPT",218,0)
 .. D ADD("</"_ID_">") S Y=""
"RTN","VPRDPT",219,0)
 . ;
"RTN","VPRDPT",220,0)
 . I ATT="exposures" D:X["1"  S Y="" Q
"RTN","VPRDPT",221,0)
 .. S I=0,Y="<exposures>" D ADD(Y)
"RTN","VPRDPT",222,0)
 .. F ID="AO","IR","PG","HNC","MST","CV" S I=I+1 I $P(X,U,I) S Y="<exposure value='"_ID_"' />" D ADD(Y)
"RTN","VPRDPT",223,0)
 .. D ADD("</exposures>")
"RTN","VPRDPT",224,0)
 . ;
"RTN","VPRDPT",225,0)
 . I ATT="address" D ADDR(X) S Y="" Q
"RTN","VPRDPT",226,0)
 . I ATT="telecom" D PHONE(X) S Y="" Q
"RTN","VPRDPT",227,0)
 . ;
"RTN","VPRDPT",228,0)
 . Q:X=""  ;no data
"RTN","VPRDPT",229,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPT",230,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDPT",231,0)
 D ADD("</patient>")
"RTN","VPRDPT",232,0)
 Q
"RTN","VPRDPT",233,0)
 ;
"RTN","VPRDPT",234,0)
ADDR(X) ; -- XML address node from X=street1^st2^st3^city^state^zip
"RTN","VPRDPT",235,0)
 N I,Y Q:$L(X)'>5  ;no data
"RTN","VPRDPT",236,0)
 S Y="<address"
"RTN","VPRDPT",237,0)
 F I=1,2,3 I $L($P(X,U,I)) S Y=Y_" streetLine"_I_"='"_$$ESC^VPRD($P(X,U,I))_"'"
"RTN","VPRDPT",238,0)
 I $L($P(X,U,4)) S Y=Y_" city='"_$$ESC^VPRD($P(X,U,4))_"'"
"RTN","VPRDPT",239,0)
 I $L($P(X,U,5)) S Y=Y_" stateProvince='"_$P(X,U,5)_"'"
"RTN","VPRDPT",240,0)
 I $L($P(X,U,6)) S Y=Y_" postalCode='"_$P(X,U,6)_"'"
"RTN","VPRDPT",241,0)
 S Y=Y_" />" D ADD(Y)
"RTN","VPRDPT",242,0)
 Q
"RTN","VPRDPT",243,0)
 ;
"RTN","VPRDPT",244,0)
PHONE(X) ; -- XML telecom node from X=home^cell^work numbers
"RTN","VPRDPT",245,0)
 N I,Y Q:$L(X)'>2  ;no data
"RTN","VPRDPT",246,0)
 D ADD("<telecomList>")
"RTN","VPRDPT",247,0)
 I $L($P(X,U,1)) S Y="<telecom usageType='H' value='"_$P(X,U,1)_"' />" D ADD(Y)
"RTN","VPRDPT",248,0)
 I $L($P(X,U,2)) S Y="<telecom usageType='MC' value='"_$P(X,U,2)_"' />" D ADD(Y)
"RTN","VPRDPT",249,0)
 I $L($P(X,U,3)) S Y="<telecom usageType='WP' value='"_$P(X,U,3)_"' />" D ADD(Y)
"RTN","VPRDPT",250,0)
 D ADD("</telecomList>")
"RTN","VPRDPT",251,0)
 Q
"RTN","VPRDPT",252,0)
 ;
"RTN","VPRDPT",253,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDPT",254,0)
 N STR,P,TAG S STR=""
"RTN","VPRDPT",255,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDPT",256,0)
 Q STR
"RTN","VPRDPT",257,0)
 ;
"RTN","VPRDPT",258,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDPT",259,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPT",260,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPT",261,0)
 Q
"RTN","VPRDPT",262,0)
 ;
"RTN","VPRDPT",263,0)
LABELS(X) ; -- return string of attribute labels for element X
"RTN","VPRDPT",264,0)
 N Y S Y="code^name^Z"
"RTN","VPRDPT",265,0)
 I X="pcProvider" S Y="code^name^"_$$PROVTAGS^VPRD_"^Z"
"RTN","VPRDPT",266,0)
 I X="support" S Y="name^relationship^Z"
"RTN","VPRDPT",267,0)
 I X="eligibility" S Y="name^primary^Z"
"RTN","VPRDPT",268,0)
 I X="disability" S Y="printName^sc^scPercent^Z"
"RTN","VPRDPT",269,0)
 I X="alias" S Y="fullName^familyName^givenNames^Z"
"RTN","VPRDPT",270,0)
 I X="flag" S Y="name^text^Z"
"RTN","VPRDPT",271,0)
 I X="facility" S Y="code^name^latestDate^domain^homeSite^Z"
"RTN","VPRDPT",272,0)
 I X="pcTeamMember" S Y="code^name^role^"_$$PROVTAGS^VPRD_"^Z"
"RTN","VPRDPT",273,0)
 I X="ethnicity"!(X="race") S Y="value^Z"
"RTN","VPRDPT",274,0)
 I X="admitted" S Y="id^date^Z"
"RTN","VPRDPT",275,0)
 Q Y
"RTN","VPRDPXIM")
0^6^B29791486^B16291131
"RTN","VPRDPXIM",1,0)
VPRDPXIM ;SLC/MKB -- Immunizations extract ;8/2/11  15:29
"RTN","VPRDPXIM",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**2,4,5**;Sep 01, 2011;Build 21
"RTN","VPRDPXIM",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPXIM",4,0)
 ;
"RTN","VPRDPXIM",5,0)
 ; External References          DBIA#
"RTN","VPRDPXIM",6,0)
 ; -------------------          -----
"RTN","VPRDPXIM",7,0)
 ; ^PXRMINDX                     4290
"RTN","VPRDPXIM",8,0)
 ; ^SC                          10040
"RTN","VPRDPXIM",9,0)
 ; ^VA(200                      10060
"RTN","VPRDPXIM",10,0)
 ; DILFD                         2055
"RTN","VPRDPXIM",11,0)
 ; DIQ                           2056
"RTN","VPRDPXIM",12,0)
 ; ICPTCOD                       1995
"RTN","VPRDPXIM",13,0)
 ; PXAPI                         1894
"RTN","VPRDPXIM",14,0)
 ; PXPXRM                        4250
"RTN","VPRDPXIM",15,0)
 ; XUAF4                         2171
"RTN","VPRDPXIM",16,0)
 ; 
"RTN","VPRDPXIM",17,0)
 ; ------------ Get immunizations from VistA ------------
"RTN","VPRDPXIM",18,0)
 ;
"RTN","VPRDPXIM",19,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's immunizations
"RTN","VPRDPXIM",20,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDPXIM",21,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999),VPRCNT=0
"RTN","VPRDPXIM",22,0)
 N VPRIDT,VPRN,VPRITM,VPRCNT
"RTN","VPRDPXIM",23,0)
 ;
"RTN","VPRDPXIM",24,0)
 ; get one immunization
"RTN","VPRDPXIM",25,0)
 I $G(IFN) D  Q
"RTN","VPRDPXIM",26,0)
 . N IMZ,DATE K ^TMP("VPRIMM",$J)
"RTN","VPRDPXIM",27,0)
 . S IMZ=0 F  S IMZ=$O(^PXRMINDX(9000010.11,"PI",+$G(DFN),IMZ)) Q:IMZ<1  D  Q:$D(VPRITM)
"RTN","VPRDPXIM",28,0)
 .. S DATE=0 F  S DATE=$O(^PXRMINDX(9000010.11,"PI",+$G(DFN),IMZ,DATE)) Q:DATE<1  I $D(^(DATE,IFN)) D  Q
"RTN","VPRDPXIM",29,0)
 ... S VPRIDT=9999999-DATE,VPRN=IFN
"RTN","VPRDPXIM",30,0)
 ... S ^TMP("VPRIMM",$J,VPRIDT,IFN)=IMZ_U_DATE ;SORT node
"RTN","VPRDPXIM",31,0)
 ... D EN1(IFN,.VPRITM),XML(.VPRITM)
"RTN","VPRDPXIM",32,0)
 . K ^TMP("VPRIMM",$J),^TMP("PXKENC",$J)
"RTN","VPRDPXIM",33,0)
 ;
"RTN","VPRDPXIM",34,0)
 ; get all immunizations
"RTN","VPRDPXIM",35,0)
 D SORT(DFN,BEG,END) S VPRCNT=0
"RTN","VPRDPXIM",36,0)
 S VPRIDT=0 F  S VPRIDT=$O(^TMP("VPRIMM",$J,VPRIDT)) Q:VPRIDT<1  D  Q:VPRCNT'<MAX
"RTN","VPRDPXIM",37,0)
 . S VPRN=0 F  S VPRN=$O(^TMP("VPRIMM",$J,VPRIDT,VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDPXIM",38,0)
 .. K VPRITM D EN1(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPXIM",39,0)
 .. D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDPXIM",40,0)
 K ^TMP("VPRIMM",$J),^TMP("PXKENC",$J)
"RTN","VPRDPXIM",41,0)
 Q
"RTN","VPRDPXIM",42,0)
 ;
"RTN","VPRDPXIM",43,0)
SORT(DFN,START,STOP) ; -- build ^TMP("VPRIMM",$J,9999999-DATE,DA)=IMM^DATE in range
"RTN","VPRDPXIM",44,0)
 ;  from ^PXRMINDX(9000010.11,"PI",DFN,IMM,DATE,DA)
"RTN","VPRDPXIM",45,0)
 N IMZ,DATE,DA,IDT K ^TMP("VPRIMM",$J)
"RTN","VPRDPXIM",46,0)
 S IMZ=0 F  S IMZ=$O(^PXRMINDX(9000010.11,"PI",+$G(DFN),IMZ)) Q:IMZ<1  D
"RTN","VPRDPXIM",47,0)
 . S DATE=0 F  S DATE=$O(^PXRMINDX(9000010.11,"PI",+$G(DFN),IMZ,DATE)) Q:DATE<1  D
"RTN","VPRDPXIM",48,0)
 .. Q:DATE<START  Q:DATE>STOP  S IDT=9999999-DATE
"RTN","VPRDPXIM",49,0)
 .. S DA=0 F  S DA=$O(^PXRMINDX(9000010.11,"PI",+$G(DFN),IMZ,DATE,DA)) Q:DA<1  S ^TMP("VPRIMM",$J,IDT,DA)=IMZ_U_DATE
"RTN","VPRDPXIM",50,0)
 Q
"RTN","VPRDPXIM",51,0)
 ;
"RTN","VPRDPXIM",52,0)
EN1(IEN,IMM) ; -- return an immunization in IMM("attribute")=value
"RTN","VPRDPXIM",53,0)
 ; Expects ^TMP("VPRIMM",$J,VPRIDT,VPRN)=IMM^DATE from EN/SORT
"RTN","VPRDPXIM",54,0)
 N TMP,VPRM,VISIT,X0,FAC,LOC,X2,X12,X13,LOT,X,I K IMM
"RTN","VPRDPXIM",55,0)
 S TMP=$G(^TMP("VPRIMM",$J,VPRIDT,VPRN))
"RTN","VPRDPXIM",56,0)
 S IMM("id")=IEN,IMM("administered")=+$P(TMP,U,2)
"RTN","VPRDPXIM",57,0)
 D VIMM^PXPXRM(IEN,.VPRM)
"RTN","VPRDPXIM",58,0)
 S X=$G(VPRM("IMMUNIZATION")) I X S IMM("name")=$P(X,U,2)
"RTN","VPRDPXIM",59,0)
 E  S IMM("name")=$$EXTERNAL^DILFD(9000010.11,.01,,+TMP)
"RTN","VPRDPXIM",60,0)
 S X=$G(VPRM("SERIES")),IMM("series")=$$EXTERNAL^DILFD(9000010.11,.04,,X)
"RTN","VPRDPXIM",61,0)
 S X=$G(VPRM("REACTION")),IMM("reaction")=$$EXTERNAL^DILFD(9000010.11,.06,,X)
"RTN","VPRDPXIM",62,0)
 S IMM("contraindicated")=+$G(VPRM("CONTRAINDICATED"))
"RTN","VPRDPXIM",63,0)
 S IMM("comment")=$G(VPRM("COMMENTS"))
"RTN","VPRDPXIM",64,0)
 S VISIT=+$G(VPRM("VISIT")),IMM("encounter")=VISIT
"RTN","VPRDPXIM",65,0)
VST ; look for values added by PX*1*210
"RTN","VPRDPXIM",66,0)
 S X=$G(VPRM("LOCATION")) S:X IMM("location")=$P(X,U,2) I 'X D  G LOT
"RTN","VPRDPXIM",67,0)
 . I '$D(^TMP("PXKENC",$J,VISIT)) D ENCEVENT^PXAPI(VISIT,1)
"RTN","VPRDPXIM",68,0)
 . S X0=$G(^TMP("PXKENC",$J,VISIT,"VST",VISIT,0))
"RTN","VPRDPXIM",69,0)
 . S FAC=+$P(X0,U,6),LOC=+$P(X0,U,22)
"RTN","VPRDPXIM",70,0)
 . S:FAC IMM("facility")=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDPXIM",71,0)
 . S:'FAC IMM("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDPXIM",72,0)
 . S IMM("location")=$P($G(^SC(LOC,0)),U)
"RTN","VPRDPXIM",73,0)
 . S X12=$G(^TMP("PXKENC",$J,VISIT,"IMM",IEN,12)),X13=$G(^(13))
"RTN","VPRDPXIM",74,0)
 . S X=$P(X12,U,4) ;S:'X X=$P(X12,U,2)
"RTN","VPRDPXIM",75,0)
 . I 'X S I=0 F  S I=$O(^TMP("PXKENC",$J,VISIT,"PRV",I)) Q:I<1  I $P($G(^(I,0)),U,4)="P" S X=+^(0) Q
"RTN","VPRDPXIM",76,0)
 . S:X IMM("provider")=X_U_$P($G(^VA(200,X,0)),U)
"RTN","VPRDPXIM",77,0)
 S X=$G(VPRM("FACILITY")) S:X IMM("facility")=$P(X,U,3)_U_$P(X,U,2)
"RTN","VPRDPXIM",78,0)
 S X=$G(VPRM("ENCOUNTER PROVIDER")) S:X IMM("provider")=X
"RTN","VPRDPXIM",79,0)
LOT ; lot number, information
"RTN","VPRDPXIM",80,0)
 S X=$G(VPRM("ORDERING PROVIDER")) S:X IMM("orderingProvider")=X
"RTN","VPRDPXIM",81,0)
 S X=$G(VPRM("DOCUMENTER")) S:X IMM("documentedBy")=X
"RTN","VPRDPXIM",82,0)
 S LOT=$G(VPRM("LOT NUMBER")) I LOT D  ;Lot#
"RTN","VPRDPXIM",83,0)
 . S IMM("lot")=$P(LOT,U,2)
"RTN","VPRDPXIM",84,0)
 . S X=$G(VPRM("MANUFACTURER")) S:X IMM("manufacturer")=$P(X,U,2)
"RTN","VPRDPXIM",85,0)
 . S X=$G(VPRM("EXPIRATION DATE")) S:X IMM("expirationDate")=X
"RTN","VPRDPXIM",86,0)
 S X=$G(VPRM("INFO SOURCE")) S:X IMM("source")=$P(X,U,2,3)
"RTN","VPRDPXIM",87,0)
 S X=$G(VPRM("ADMIN ROUTE")) S:X IMM("route")=$P(X,U,2,3)
"RTN","VPRDPXIM",88,0)
 S X=$G(VPRM("ADMIN SITE")) S:X IMM("bodySite")=$P(X,U,2,3)
"RTN","VPRDPXIM",89,0)
 S X=$G(VPRM("DOSAGE")) I $L(X) S IMM("dose")=X
"RTN","VPRDPXIM",90,0)
 E  D  ;Dose field to be split
"RTN","VPRDPXIM",91,0)
 . S X=$G(VPRM("DOSE")) S:$L(X) IMM("dose")=X
"RTN","VPRDPXIM",92,0)
 . S X=$G(VPRM("DOSE UNITS")) S:$L(X) IMM("units")=X
"RTN","VPRDPXIM",93,0)
VIS ; vaccine information sheet
"RTN","VPRDPXIM",94,0)
 S I=0 F  S I=$O(VPRM("VIS OFFERED",I)) Q:I<1  D
"RTN","VPRDPXIM",95,0)
 . S X=$G(VPRM("VIS OFFERED",I,0)) ;ien^date^name^editionDate^language
"RTN","VPRDPXIM",96,0)
 . S IMM("vis",+I)=$P(X,U,2,5)
"RTN","VPRDPXIM",97,0)
CVX ; CVX, CPT mappings
"RTN","VPRDPXIM",98,0)
 S X=$G(VPRM("CVX")) I $L(X) S IMM("cvx")=X
"RTN","VPRDPXIM",99,0)
 E  S X=$$GET1^DIQ(9999999.14,+TMP_",",.03) S:$L(X) IMM("cvx")=X
"RTN","VPRDPXIM",100,0)
 S X=$G(VPRM("CODES","CPT")) I $L(X) D  Q
"RTN","VPRDPXIM",101,0)
 . S X=$$CPT^ICPTCOD(X)
"RTN","VPRDPXIM",102,0)
 . S IMM("cpt")=$P(X,U,2,3)
"RTN","VPRDPXIM",103,0)
 ; phase out codes from 811.1 ...
"RTN","VPRDPXIM",104,0)
 S X=+$$FIND1^DIC(811.1,,"QX",+TMP_";AUTTIMM(","B") I X>0 D
"RTN","VPRDPXIM",105,0)
 . S Y=$$GET1^DIQ(811.1,X_",",.02,"I") Q:Y<1
"RTN","VPRDPXIM",106,0)
 . N CPT S CPT=$G(@(U_$P(Y,";",2)_+Y_",0)"))
"RTN","VPRDPXIM",107,0)
 . S IMM("cpt")=$P(CPT,U,1,2)
"RTN","VPRDPXIM",108,0)
 Q
"RTN","VPRDPXIM",109,0)
 ;
"RTN","VPRDPXIM",110,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPXIM",111,0)
 ;
"RTN","VPRDPXIM",112,0)
XML(IMM) ; -- Return immunizations as XML
"RTN","VPRDPXIM",113,0)
 N ATT,X,Y,I,NAMES
"RTN","VPRDPXIM",114,0)
 D ADD("<immunization>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPXIM",115,0)
 S ATT="" F  S ATT=$O(IMM(ATT)) Q:ATT=""  D
"RTN","VPRDPXIM",116,0)
 . S NAMES=$S(ATT="vis":"date^name^editionDate^language",1:"code^name")_"^Z"
"RTN","VPRDPXIM",117,0)
 . I ATT="vis" D  Q
"RTN","VPRDPXIM",118,0)
 .. D ADD("<"_ATT_">")
"RTN","VPRDPXIM",119,0)
 .. S I="" F  S I=$O(IMM(ATT,I)) Q:I=""  D
"RTN","VPRDPXIM",120,0)
 ... S X=$G(IMM(ATT,I)),Y="<sheet "_$$LOOP_"/>"
"RTN","VPRDPXIM",121,0)
 ... D ADD(Y)
"RTN","VPRDPXIM",122,0)
 .. D ADD("</"_ATT_">")
"RTN","VPRDPXIM",123,0)
 . S X=$G(IMM(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPXIM",124,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" D ADD(Y) Q
"RTN","VPRDPXIM",125,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPXIM",126,0)
 D ADD("</immunization>")
"RTN","VPRDPXIM",127,0)
 Q
"RTN","VPRDPXIM",128,0)
 ;
"RTN","VPRDPXIM",129,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDPXIM",130,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPXIM",131,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPXIM",132,0)
 Q
"RTN","VPRDPXIM",133,0)
 ;
"RTN","VPRDPXIM",134,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDPXIM",135,0)
 N STR,P,TAG S STR=""
"RTN","VPRDPXIM",136,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDPXIM",137,0)
 Q STR
"RTN","VPRDPXRM")
0^7^B9085519^n/a
"RTN","VPRDPXRM",1,0)
VPRDPXRM ;SLC/MKB -- Reminders extract ;8/2/11  15:29
"RTN","VPRDPXRM",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**5**;Sep 01, 2011;Build 21
"RTN","VPRDPXRM",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPXRM",4,0)
 ;
"RTN","VPRDPXRM",5,0)
 ; External References          DBIA#
"RTN","VPRDPXRM",6,0)
 ; -------------------          -----
"RTN","VPRDPXRM",7,0)
 ; ^DPT                         10035
"RTN","VPRDPXRM",8,0)
 ; ^VA(200                      10060
"RTN","VPRDPXRM",9,0)
 ; %DT                          10003
"RTN","VPRDPXRM",10,0)
 ; DIQ                           2056
"RTN","VPRDPXRM",11,0)
 ; PXRMMHV                       4811
"RTN","VPRDPXRM",12,0)
 ;(returns ^TMP("PXRMMHVC",$J) and ^TMP("PXRMMHVL,$J))
"RTN","VPRDPXRM",13,0)
 ; XLFDT                        10103
"RTN","VPRDPXRM",14,0)
 ; XUAF4                         2171
"RTN","VPRDPXRM",15,0)
 ;
"RTN","VPRDPXRM",16,0)
 ; ------------ Get reminders from VistA ------------
"RTN","VPRDPXRM",17,0)
 ;
"RTN","VPRDPXRM",18,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's reminders
"RTN","VPRDPXRM",19,0)
 ; [BEG,END,IFN not currently used]
"RTN","VPRDPXRM",20,0)
 N VPRPROB,VPRN,VPRITM,VPRCNT,X
"RTN","VPRDPXRM",21,0)
 D PREMLIST^PXRMMHV
"RTN","VPRDPXRM",22,0)
 ;
"RTN","VPRDPXRM",23,0)
 ; get one reminder
"RTN","VPRDPXRM",24,0)
 I $G(IFN) D EN1(IFN,.VPRITM),XML(.VPRITM) G ENQ
"RTN","VPRDPXRM",25,0)
 ;
"RTN","VPRDPXRM",26,0)
 ; get all patient reminders
"RTN","VPRDPXRM",27,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDPXRM",28,0)
 S MAX=$G(MAX,9999),VPRCNT=0
"RTN","VPRDPXRM",29,0)
 D MHVC^PXRMMHV(DFN)
"RTN","VPRDPXRM",30,0)
 S VPRN=0 F  S VPRN=$O(^TMP("PXRMMHVC",$J,VPRN)) Q:(VPRN<1)!(VPRCNT'<MAX)  D
"RTN","VPRDPXRM",31,0)
 . S X=$G(^TMP("PXRMMHVC",$J,VPRN,"STATUS")) Q:$P(X,U)="N/A"
"RTN","VPRDPXRM",32,0)
 . K VPRITM D EN1(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPXRM",33,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDPXRM",34,0)
ENQ K ^TMP("PXRMMHVC",$J),^TMP("PXRMMHVL",$J)
"RTN","VPRDPXRM",35,0)
 Q
"RTN","VPRDPXRM",36,0)
 ;
"RTN","VPRDPXRM",37,0)
EN1(ID,REM) ; -- return a reminder in REM("attribute")=value
"RTN","VPRDPXRM",38,0)
 N VPRM,X,I,J K REM
"RTN","VPRDPXRM",39,0)
 S ID=+$G(ID) Q:ID<1  ;invalid ien
"RTN","VPRDPXRM",40,0)
 S VPRM=$G(^TMP("PXRMMHVL",$J,ID)) Q:$P(VPRM,U,3)'="N"  ;nat'l only
"RTN","VPRDPXRM",41,0)
 S REM("id")=ID,REM("name")=$P(VPRM,U,2),X=$P(VPRM,U,3)
"RTN","VPRDPXRM",42,0)
 S REM("class")=X_U_$S(X="N":"NATIONAL",X="V":"VISN",X="L":"LOCAL",1:X)
"RTN","VPRDPXRM",43,0)
 S X=$G(^TMP("PXRMMHVC",$J,ID,"STATUS"))
"RTN","VPRDPXRM",44,0)
 S REM("status")=$P(X,U)
"RTN","VPRDPXRM",45,0)
 S:$L($P(X,U,2)) REM("due")=$P(X,U,2) ;string or FM date
"RTN","VPRDPXRM",46,0)
 S:$L($P(X,U,3)) REM("lastDone")=$P(X,U,3) ;string or FM date
"RTN","VPRDPXRM",47,0)
 S REM("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDPXRM",48,0)
 I $O(^TMP("PXRMMHVC",$J,ID,"DETAIL",0)) M REM("detail")=^TMP("PXRMMHVC",$J,ID,"DETAIL")
"RTN","VPRDPXRM",49,0)
 I $O(^TMP("PXRMMHVC",$J,ID,"SUMMARY",0)) M REM("summary")=^TMP("PXRMMHVC",$J,ID,"SUMMARY")
"RTN","VPRDPXRM",50,0)
 Q
"RTN","VPRDPXRM",51,0)
 ;
"RTN","VPRDPXRM",52,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPXRM",53,0)
 ;
"RTN","VPRDPXRM",54,0)
XML(REM) ; -- Return patient reminder as XML in @VPR@(I)
"RTN","VPRDPXRM",55,0)
 N ATT,I,X,Y,NAMES
"RTN","VPRDPXRM",56,0)
 D ADD("<reminder>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPXRM",57,0)
 S ATT="" F  S ATT=$O(REM(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDPXRM",58,0)
 . I ATT="detail"!(ATT="summary") D  S Y="" Q  ;text
"RTN","VPRDPXRM",59,0)
 .. S Y="<"_ATT_" xml:space='preserve'>" D ADD(Y)
"RTN","VPRDPXRM",60,0)
 .. S I=0 F  S I=$O(REM(ATT,I)) Q:I<1  S X=$G(REM(ATT,I)),Y=$$ESC^VPRD(X) D ADD(Y)
"RTN","VPRDPXRM",61,0)
 .. D ADD("</"_ATT_">")
"RTN","VPRDPXRM",62,0)
 . S X=$G(REM(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPXRM",63,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPXRM",64,0)
 . I $L(X)>1 S NAMES="code^name^Z",Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDPXRM",65,0)
 D ADD("</reminder>")
"RTN","VPRDPXRM",66,0)
 Q
"RTN","VPRDPXRM",67,0)
 ;
"RTN","VPRDPXRM",68,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDPXRM",69,0)
 N STR,P,TAG S STR=""
"RTN","VPRDPXRM",70,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDPXRM",71,0)
 Q STR
"RTN","VPRDPXRM",72,0)
 ;
"RTN","VPRDPXRM",73,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDPXRM",74,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPXRM",75,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPXRM",76,0)
 Q
"RTN","VPRDRA")
0^11^B49387414^B41770325
"RTN","VPRDRA",1,0)
VPRDRA ;SLC/MKB -- Radiology extract ;8/2/11  15:29
"RTN","VPRDRA",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,5**;Sep 01, 2011;Build 21
"RTN","VPRDRA",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDRA",4,0)
 ;
"RTN","VPRDRA",5,0)
 ; External References          DBIA#
"RTN","VPRDRA",6,0)
 ; -------------------          -----
"RTN","VPRDRA",7,0)
 ; ^RADPT                        2480
"RTN","VPRDRA",8,0)
 ; ^RARPT                        5605
"RTN","VPRDRA",9,0)
 ; ^OR(100                       5771
"RTN","VPRDRA",10,0)
 ; ^SC(                         10040
"RTN","VPRDRA",11,0)
 ; ^VA(200                      10060
"RTN","VPRDRA",12,0)
 ; DIQ                           2056
"RTN","VPRDRA",13,0)
 ; ICPTCOD                       1995
"RTN","VPRDRA",14,0)
 ; ORX8                          2467
"RTN","VPRDRA",15,0)
 ; RAO7PC1                  2043,2265
"RTN","VPRDRA",16,0)
 ; RAO7PC3                       2877
"RTN","VPRDRA",17,0)
 ;
"RTN","VPRDRA",18,0)
 ; ------------ Get exam(s) from VistA ------------
"RTN","VPRDRA",19,0)
 ;
"RTN","VPRDRA",20,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's radiology exams
"RTN","VPRDRA",21,0)
 N VPRITM,VPRXID
"RTN","VPRDRA",22,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDRA",23,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)_"P"
"RTN","VPRDRA",24,0)
 K ^TMP($J,"RAE1") D EN1^RAO7PC1(DFN,BEG,END,MAX)
"RTN","VPRDRA",25,0)
 ;
"RTN","VPRDRA",26,0)
 ; get exam(s) by single case or RA order#
"RTN","VPRDRA",27,0)
 I $G(ID) D  G ENQ
"RTN","VPRDRA",28,0)
 . I ID["-" D EN1(ID,.VPRITM),XML(.VPRITM) Q
"RTN","VPRDRA",29,0)
 . N IDT,CN S IDT=+$O(^RADPT("AO",ID,DFN,0)) Q:'IDT
"RTN","VPRDRA",30,0)
 . S CN=0 F  S CN=$O(^RADPT("AO",ID,DFN,IDT,CN)) Q:CN<1  D
"RTN","VPRDRA",31,0)
 .. K VPRITM D EN1(IDT_"-"_CN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDRA",32,0)
 .. D XML(.VPRITM)
"RTN","VPRDRA",33,0)
 ;
"RTN","VPRDRA",34,0)
 ; get all exams
"RTN","VPRDRA",35,0)
 S VPRXID="" F  S VPRXID=$O(^TMP($J,"RAE1",DFN,VPRXID)) Q:VPRXID=""  D
"RTN","VPRDRA",36,0)
 . K VPRITM D EN1(VPRXID,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDRA",37,0)
 . D XML(.VPRITM)
"RTN","VPRDRA",38,0)
ENQ ; end
"RTN","VPRDRA",39,0)
 K ^TMP($J,"RAE1"),^TMP("VPRTEXT",$J)
"RTN","VPRDRA",40,0)
 Q
"RTN","VPRDRA",41,0)
 ;
"RTN","VPRDRA",42,0)
EN1(ID,EXAM) ; -- return an exam in EXAM("attribute")=value
"RTN","VPRDRA",43,0)
 ;   Expects ^TMP($J,"RAE1",DFN,ID) from EN1^RAO7PC1
"RTN","VPRDRA",44,0)
 N X0,SET,PROC,DATE,LOC,X,Y,IENS
"RTN","VPRDRA",45,0)
 K EXAM,^TMP("VPRTEXT",$J)
"RTN","VPRDRA",46,0)
 S X0=$G(^TMP($J,"RAE1",DFN,ID)),SET=$G(^(ID,"CPRS")),PROC=$P(X0,U)
"RTN","VPRDRA",47,0)
 S EXAM("id")=ID,EXAM("name")=PROC,EXAM("case")=$P(X0,U,2)
"RTN","VPRDRA",48,0)
 S DATE=9999999.9999-+ID,EXAM("dateTime")=DATE
"RTN","VPRDRA",49,0)
 I $P(X0,U,5) D  ;report exists
"RTN","VPRDRA",50,0)
 . S X=$P(X0,U,3) Q:X="No Report"!(X="Deleted")!(X["Draft")  ;Rpt sts
"RTN","VPRDRA",51,0)
 . N NM S NM=$S(+SET=2:$P(SET,U,2),1:PROC)     ;2 = shared report
"RTN","VPRDRA",52,0)
 . S EXAM("document",1)=ID_U_NM_"^RADIOLOGY REPORT^4695068^"_X
"RTN","VPRDRA",53,0)
 . ; id^localTitle^nationalTitle^vuid^status
"RTN","VPRDRA",54,0)
 . S:$G(VPRTEXT) EXAM("document",1,"content")=$$TEXT(DFN,ID)
"RTN","VPRDRA",55,0)
 S:$L($P(X0,U,6)) EXAM("status")=$P($P(X0,U,6),"~",2) ;Exam sts
"RTN","VPRDRA",56,0)
 S X=$P(X0,U,7),LOC="" I $L(X) D
"RTN","VPRDRA",57,0)
 . S LOC=+$O(^SC("B",X,0)),EXAM("location")=LOC_U_X
"RTN","VPRDRA",58,0)
 S EXAM("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDRA",59,0)
 I $L($P(X0,U,8)) S X=$TR($P(X0,U,8),"~","^"),EXAM("imagingType")=X
"RTN","VPRDRA",60,0)
 S IENS=$P(ID,"-",2)_","_+ID_","_DFN_","
"RTN","VPRDRA",61,0)
 S X=$P(X0,U,10) I X D
"RTN","VPRDRA",62,0)
 . S EXAM("type")=$$CPT(X)
"RTN","VPRDRA",63,0)
 . I $D(^TMP($J,"RAE1",DFN,ID,"CMOD")) M EXAM("modifier")=^("CMOD")
"RTN","VPRDRA",64,0)
 I $P(X0,U,11) D
"RTN","VPRDRA",65,0)
 . S EXAM("order")=+$P(X0,U,11)_U_$S($L(SET):$P(SET,U,2),1:PROC)
"RTN","VPRDRA",66,0)
 . S EXAM("radOrderID")=$G(^OR(100,+$P(X0,U,11),4))
"RTN","VPRDRA",67,0)
 . S EXAM("urgency")=$$VALUE^ORX8(+$P(X0,U,11),"URGENCY",1,"E")
"RTN","VPRDRA",68,0)
 S EXAM("hasImages")=$S($P(X0,U,12)="Y":1,1:0)
"RTN","VPRDRA",69,0)
 I $P(X0,U,4)="Y"!($P(X0,U,9)="Y") S EXAM("interpretation")="ABNORMAL"
"RTN","VPRDRA",70,0)
 S EXAM("encounter")=$$GET1^DIQ(70.03,IENS,27,"I")
"RTN","VPRDRA",71,0)
 S ID=DFN_U_$TR(ID,"-","^") D EN3^RAO7PC1(ID) D  ;get additional values
"RTN","VPRDRA",72,0)
 . S X=+$G(^TMP($J,"RAE2",DFN,+$P(ID,U,3),PROC,"P"))
"RTN","VPRDRA",73,0)
 . I X S EXAM("provider")=X_U_$P($G(^VA(200,X,0)),U)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDRA",74,0)
 S EXAM("category")="RA"
"RTN","VPRDRA",75,0)
 Q
"RTN","VPRDRA",76,0)
 ;
"RTN","VPRDRA",77,0)
CPT(IEN) ; -- return code^description for CPT code, or "^" if error
"RTN","VPRDRA",78,0)
 N X0,VPRX,N,I,X,Y S IEN=+$G(IEN)
"RTN","VPRDRA",79,0)
 S X0=$$CPT^ICPTCOD(IEN) I X0<0 Q "^"
"RTN","VPRDRA",80,0)
 S Y=$P(X0,U,2,3)                  ;CPT Code^Short Name
"RTN","VPRDRA",81,0)
 S N=$$CPTD^ICPTCOD($P(Y,U),"VPRX") ;CPT Description
"RTN","VPRDRA",82,0)
 I N>0,$L($G(VPRX(1))) D
"RTN","VPRDRA",83,0)
 . S X=$G(VPRX(1)),I=1
"RTN","VPRDRA",84,0)
 . F  S I=$O(VPRX(I)) Q:I<1  Q:VPRX(I)=" "  S X=X_" "_VPRX(I)
"RTN","VPRDRA",85,0)
 . S $P(Y,U,2)=X
"RTN","VPRDRA",86,0)
 Q Y
"RTN","VPRDRA",87,0)
 ;
"RTN","VPRDRA",88,0)
TEXT(PAT,ID) ; -- Get report text, return temp array name
"RTN","VPRDRA",89,0)
 S PAT=+$G(PAT),ID=$G(ID) I PAT<1!(ID<1) Q ""
"RTN","VPRDRA",90,0)
 N DFN,EXAM,CASE,PROC,I,X,Y
"RTN","VPRDRA",91,0)
 S EXAM=PAT_U_$TR(ID,"-","^") D EN3^RAO7PC3(EXAM)
"RTN","VPRDRA",92,0)
 S Y=$NA(^TMP("VPRTEXT",$J,ID)) K @Y
"RTN","VPRDRA",93,0)
 S CASE=$O(^TMP($J,"RAE3",PAT,0)),PROC=$O(^(CASE,""))
"RTN","VPRDRA",94,0)
 S I=0 F  S I=$O(^TMP($J,"RAE3",PAT,CASE,PROC,I)) Q:I<1  S X=^(I),@Y@(I)=X
"RTN","VPRDRA",95,0)
 K ^TMP($J,"RAE3",PAT)
"RTN","VPRDRA",96,0)
 Q Y
"RTN","VPRDRA",97,0)
 ;
"RTN","VPRDRA",98,0)
 ; ------------ Get report(s) [via VPRDTIU] ------------
"RTN","VPRDRA",99,0)
 ;
"RTN","VPRDRA",100,0)
RPTS(DFN,BEG,END,MAX) ; -- find patient's radiology reports
"RTN","VPRDRA",101,0)
 N VPRITM,VPRXID,STS,PSET
"RTN","VPRDRA",102,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDRA",103,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)_"P"
"RTN","VPRDRA",104,0)
 K ^TMP($J,"RAE1") D EN1^RAO7PC1(DFN,BEG,END,MAX)
"RTN","VPRDRA",105,0)
 S VPRXID="" F  S VPRXID=$O(^TMP($J,"RAE1",DFN,VPRXID)) Q:VPRXID=""  D
"RTN","VPRDRA",106,0)
 . S STS=$P($G(^TMP($J,"RAE1",DFN,VPRXID)),U,3),PSET=$G(^(VPRXID,"CPRS"))
"RTN","VPRDRA",107,0)
 . Q:STS="No Report"!(STS="Deleted")!(STS["Draft")
"RTN","VPRDRA",108,0)
 . I +PSET=2,$G(PSET(+VPRXID,$P(PSET,U,2))) Q  ;already have report
"RTN","VPRDRA",109,0)
 . K VPRITM D RPT1(DFN,VPRXID,.VPRITM) D:$D(VPRITM) XML^VPRDTIU(.VPRITM)
"RTN","VPRDRA",110,0)
 . I +PSET=2 S PSET(+VPRXID,$P(PSET,U,2))=$P(VPRXID,"-",2) ;parent
"RTN","VPRDRA",111,0)
 K ^TMP($J,"RAE1"),^TMP("VPRTEXT",$J)
"RTN","VPRDRA",112,0)
 Q
"RTN","VPRDRA",113,0)
 ;
"RTN","VPRDRA",114,0)
RPT1(DFN,ID,RPT) ; -- return report as a TIU document
"RTN","VPRDRA",115,0)
 S DFN=+$G(DFN),ID=$G(ID) Q:DFN<1  Q:ID<1
"RTN","VPRDRA",116,0)
 N EXAM,CASE,PROC,RAE3,RAE1,I,X,Y,IENS,LOC
"RTN","VPRDRA",117,0)
 K RPT,^TMP("VPRTEXT",$J)
"RTN","VPRDRA",118,0)
 S EXAM=DFN_U_$TR(ID,"-","^") D
"RTN","VPRDRA",119,0)
 . N DFN D EN3^RAO7PC3(EXAM) ;report
"RTN","VPRDRA",120,0)
 . D EN3^RAO7PC1(EXAM)       ;add'l values
"RTN","VPRDRA",121,0)
 S CASE=$O(^TMP($J,"RAE3",DFN,0)),PROC=$O(^(CASE,"")),RAE3=$G(^(PROC))
"RTN","VPRDRA",122,0)
 S RAE1=$G(^TMP($J,"RAE1",DFN,ID))
"RTN","VPRDRA",123,0)
 I $G(VPRTEXT) D
"RTN","VPRDRA",124,0)
 . S Y=$NA(^TMP("VPRTEXT",$J,ID))
"RTN","VPRDRA",125,0)
 . S I=0 F  S I=$O(^TMP($J,"RAE3",DFN,CASE,PROC,I)) Q:I<1  S X=^(I),@Y@(I)=X
"RTN","VPRDRA",126,0)
 . S RPT("content")=Y
"RTN","VPRDRA",127,0)
 S RPT("id")=ID,RPT("status")=$P(RAE3,U)
"RTN","VPRDRA",128,0)
 S X=9999999.9999-(+ID),RPT("referenceDateTime")=X
"RTN","VPRDRA",129,0)
 S X=+$G(^TMP($J,"RAE2",DFN,CASE,PROC,"P"))
"RTN","VPRDRA",130,0)
 I X S RPT("clinician",1)=X_U_$P($G(^VA(200,X,0)),U)_"^A^^^"_$$PROVSPC^VPRD(X)
"RTN","VPRDRA",131,0)
 S X=$G(^TMP($J,"RAE2",DFN,CASE,PROC,"V")) I X D
"RTN","VPRDRA",132,0)
 . N Y S Y=$$GET1^DIQ(74,+$P(RAE1,U,5)_",",7,"I")
"RTN","VPRDRA",133,0)
 . S RPT("clinician",2)=+X_U_$P($G(^VA(200,+X,0)),U)_"^S^"_Y_U_$P(X,U,2)_U_$$PROVSPC^VPRD(+X)
"RTN","VPRDRA",134,0)
 I $D(^TMP($J,"RAE3",DFN,"PRINT_SET")) S PROC=$G(^("ORD")) ;use parent, if printset
"RTN","VPRDRA",135,0)
 S RPT("localTitle")=PROC,RPT("category")="RA"
"RTN","VPRDRA",136,0)
 S RPT("nationalTitle")="4695068^RADIOLOGY REPORT"
"RTN","VPRDRA",137,0)
 S RPT("nationalTitleSubject")="4693357^RADIOLOGY"
"RTN","VPRDRA",138,0)
 S RPT("nationalTitleType")="4696123^REPORT"
"RTN","VPRDRA",139,0)
 S X=$P(RAE1,U,7),LOC="" I $L(X) D
"RTN","VPRDRA",140,0)
 . S LOC=+$O(^SC("B",X,0)) ;,EXAM("location")=LOC_U_X
"RTN","VPRDRA",141,0)
 S RPT("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDRA",142,0)
 S IENS=$P(ID,"-",2)_","_+ID_","_DFN_","
"RTN","VPRDRA",143,0)
 S RPT("encounter")=$$GET1^DIQ(70.03,IENS,27,"I")
"RTN","VPRDRA",144,0)
 S:$G(FILTER("loinc")) RPT("loinc")=$P(FILTER("loinc"),U)
"RTN","VPRDRA",145,0)
 K ^TMP($J,"RAE3",DFN),^TMP($J,"RAE2",DFN)
"RTN","VPRDRA",146,0)
 Q
"RTN","VPRDRA",147,0)
 ;
"RTN","VPRDRA",148,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDRA",149,0)
 ;
"RTN","VPRDRA",150,0)
XML(EXAM) ; -- Return exams as XML
"RTN","VPRDRA",151,0)
 N ATT,X,Y,NAMES,I,J
"RTN","VPRDRA",152,0)
 D ADD("<radiology>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDRA",153,0)
 S ATT="" F  S ATT=$O(EXAM(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDRA",154,0)
 . S NAMES=$S(ATT="document":"id^localTitle^nationalTitle^vuid^status",ATT="provider":"code^name^"_$$PROVTAGS^VPRD,1:"code^name")_"^Z"
"RTN","VPRDRA",155,0)
 . I $O(EXAM(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDRA",156,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDRA",157,0)
 .. S I=0 F  S I=$O(EXAM(ATT,I)) Q:I<1  D
"RTN","VPRDRA",158,0)
 ... S X=$G(EXAM(ATT,I))
"RTN","VPRDRA",159,0)
 ... S Y="<"_ATT_" "_$$LOOP ;_"/>" D ADD(Y)
"RTN","VPRDRA",160,0)
 ... S X=$G(EXAM(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDRA",161,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDRA",162,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDRA",163,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDRA",164,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDRA",165,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDRA",166,0)
 . S X=$G(EXAM(ATT)),Y="" Q:'$L(X)
"RTN","VPRDRA",167,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDRA",168,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDRA",169,0)
 D ADD("</radiology>")
"RTN","VPRDRA",170,0)
 Q
"RTN","VPRDRA",171,0)
 ;
"RTN","VPRDRA",172,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDRA",173,0)
 N STR,P,TAG S STR=""
"RTN","VPRDRA",174,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDRA",175,0)
 Q STR
"RTN","VPRDRA",176,0)
 ;
"RTN","VPRDRA",177,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDRA",178,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDRA",179,0)
 S @VPR@(VPRI)=X
"RTN","VPRDRA",180,0)
 Q
"RTN","VPRDRMIM")
0^8^B24311841^n/a
"RTN","VPRDRMIM",1,0)
VPRDRMIM ;SLC/MKB -- FIM extract ;8/2/11  15:29
"RTN","VPRDRMIM",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**5**;Sep 01, 2011;Build 21
"RTN","VPRDRMIM",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDRMIM",4,0)
 ;
"RTN","VPRDRMIM",5,0)
 ; External References          DBIA#
"RTN","VPRDRMIM",6,0)
 ; -------------------          -----
"RTN","VPRDRMIM",7,0)
 ; %DT                          10003
"RTN","VPRDRMIM",8,0)
 ; DIQ                           2056
"RTN","VPRDRMIM",9,0)
 ; RMIMRP                        4745
"RTN","VPRDRMIM",10,0)
 ;
"RTN","VPRDRMIM",11,0)
 ; ------------ Get FIM cases from VistA ------------
"RTN","VPRDRMIM",12,0)
 ;
"RTN","VPRDRMIM",13,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's FIM cases
"RTN","VPRDRMIM",14,0)
 N VPRSITE,VPRS,VPRN,VPRY,ADM,VPRITM,VPRCNT
"RTN","VPRDRMIM",15,0)
 D PRM^RMIMRP(.VPRSITE) Q:'$O(VPRSITE(1))
"RTN","VPRDRMIM",16,0)
 ;
"RTN","VPRDRMIM",17,0)
 ; get one case
"RTN","VPRDRMIM",18,0)
 I $G(IFN) D EN1(IFN,.VPRITM),XML(.VPRITM) G ENQ
"RTN","VPRDRMIM",19,0)
 ;
"RTN","VPRDRMIM",20,0)
 ; get all patient FIM cases
"RTN","VPRDRMIM",21,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDRMIM",22,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999),VPRCNT=0
"RTN","VPRDRMIM",23,0)
 S VPRS=1 F  S VPRS=$O(VPRSITE(VPRS)) Q:VPRS<1  D
"RTN","VPRDRMIM",24,0)
 . S VPRN=DFN_U_VPRSITE(VPRS)
"RTN","VPRDRMIM",25,0)
 . D LC^RMIMRP(.VPRY,VPRN) Q:VPRY(1)<1
"RTN","VPRDRMIM",26,0)
 . S VPRN=1 F  S VPRN=$O(VPRY(VPRN)) Q:(VPRN<1)!(VPRCNT'<MAX)  D
"RTN","VPRDRMIM",27,0)
 .. S ADM=$$DATE($P(VPRY(VPRN),U,4)) Q:ADM<BEG  Q:ADM>END
"RTN","VPRDRMIM",28,0)
 .. K VPRITM D EN1(+VPRY(VPRN),.VPRITM),XML(.VPRITM)
"RTN","VPRDRMIM",29,0)
 .. S VPRCNT=VPRCNT+1
"RTN","VPRDRMIM",30,0)
ENQ ;done
"RTN","VPRDRMIM",31,0)
 Q
"RTN","VPRDRMIM",32,0)
 ;
"RTN","VPRDRMIM",33,0)
EN1(ID,FIM) ; -- return a case in FIM("attribute")=value
"RTN","VPRDRMIM",34,0)
 N VPRM,X,I,TYPE,MOTOR,COGNTV K FIM
"RTN","VPRDRMIM",35,0)
 S ID=+$G(ID) Q:ID<1  ;invalid ien
"RTN","VPRDRMIM",36,0)
 D GC^RMIMRP(.VPRM,ID)
"RTN","VPRDRMIM",37,0)
 S FIM("id")=ID,FIM("name")="Functional Independence Measurement"
"RTN","VPRDRMIM",38,0)
 S FIM("facility")=$P(VPRSITE(1),U,2)_U_$P(VPRSITE(1),U) ;local stn#^name
"RTN","VPRDRMIM",39,0)
 S X=$G(VPRM(1)),FIM("case")=$P(X,U,2)
"RTN","VPRDRMIM",40,0)
 S FIM("care")=$P(X,U,7),FIM("impairmentGroup")=$P(X,U,8)
"RTN","VPRDRMIM",41,0)
 S FIM("onset")=$$DATE($P(X,U,9))
"RTN","VPRDRMIM",42,0)
 S FIM("admitted")=$$DATE($P(X,U,10))
"RTN","VPRDRMIM",43,0)
 S FIM("discharged")=$$DATE($P(X,U,11))
"RTN","VPRDRMIM",44,0)
 S X=+$P(X,U,12) I X D
"RTN","VPRDRMIM",45,0)
 . N Y S Y=$$INFO^VPRDTIU(X) Q:Y<1  ;draft or retracted
"RTN","VPRDRMIM",46,0)
 . S FIM("document")=Y              ;ien^localTitle^natlTitle^VUID
"RTN","VPRDRMIM",47,0)
 . S:$G(VPRTEXT) FIM("document","content")=$$TEXT^VPRDTIU(X)
"RTN","VPRDRMIM",48,0)
 S X=$G(VPRM(3)) S:X FIM("admitClass")=+X
"RTN","VPRDRMIM",49,0)
 S:$L($P(X,U,3)) FIM("interruptionCode")=$P(X,U,3)
"RTN","VPRDRMIM",50,0)
 F I=4,6,8 I $P(X,U,I) S FIM("interruption",I)=$P(X,U,I,I+1)
"RTN","VPRDRMIM",51,0)
 F I=5:1:9 I VPRM(I)'?1."^" D  ;has data
"RTN","VPRDRMIM",52,0)
 . S TYPE=$S(I=5:"admission",I=6:"discharge",I=7:"interim",I=8:"follow up",1:"goals")
"RTN","VPRDRMIM",53,0)
 . S X=VPRM(I),MOTOR=$$TOTAL(X,1,13) Q:'MOTOR  ;incomplete results
"RTN","VPRDRMIM",54,0)
 . S COGNTV=$$TOTAL(X,14,18) Q:'COGNTV         ;incomplete results
"RTN","VPRDRMIM",55,0)
 . S FIM("assessment",TYPE)=X
"RTN","VPRDRMIM",56,0)
 . S FIM("assessment",TYPE,"motorScore")=MOTOR
"RTN","VPRDRMIM",57,0)
 . S FIM("assessment",TYPE,"cognitiveScore")=COGNTV
"RTN","VPRDRMIM",58,0)
 . S FIM("assessment",TYPE,"totalScore")=MOTOR+COGNTV
"RTN","VPRDRMIM",59,0)
 Q
"RTN","VPRDRMIM",60,0)
 ;
"RTN","VPRDRMIM",61,0)
DATE(X) ; -- Return internal form of date X
"RTN","VPRDRMIM",62,0)
 N %DT,Y
"RTN","VPRDRMIM",63,0)
 S %DT="" D ^%DT S:Y<1 Y=X
"RTN","VPRDRMIM",64,0)
 Q Y
"RTN","VPRDRMIM",65,0)
 ;
"RTN","VPRDRMIM",66,0)
TOTAL(NODE,P1,P2) ; -- Return total of scores, or "" if incomplete
"RTN","VPRDRMIM",67,0)
 N SUM,I,X
"RTN","VPRDRMIM",68,0)
 S SUM=0 F I=P1:1:P2 S X=$P(NODE,U,I) S:X SUM=SUM+X I X<1 S SUM="" Q
"RTN","VPRDRMIM",69,0)
 Q SUM
"RTN","VPRDRMIM",70,0)
 ;
"RTN","VPRDRMIM",71,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDRMIM",72,0)
 ;
"RTN","VPRDRMIM",73,0)
XML(FIM) ; -- Return FIM case as XML in @VPR@(I)
"RTN","VPRDRMIM",74,0)
 N ATT,I,J,X,Y,NAMES,TEXT
"RTN","VPRDRMIM",75,0)
 D ADD("<fim>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDRMIM",76,0)
 S ATT="" F  S ATT=$O(FIM(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDRMIM",77,0)
 . I ATT="assessment" D  S Y="" Q
"RTN","VPRDRMIM",78,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDRMIM",79,0)
 .. S I="" F  S I=$O(FIM(ATT,I)) Q:I=""  D
"RTN","VPRDRMIM",80,0)
 ... S Y="<"_ATT_" type='"_I,J=""
"RTN","VPRDRMIM",81,0)
 ... F  S J=$O(FIM(ATT,I,J)) Q:J=""  S Y=Y_"' "_J_"='"_FIM(ATT,I,J)
"RTN","VPRDRMIM",82,0)
 ... S Y=Y_"' >" D ADD(Y)
"RTN","VPRDRMIM",83,0)
 ... S X=FIM(ATT,I) D VAL(X),ADD("</"_ATT_">")
"RTN","VPRDRMIM",84,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDRMIM",85,0)
 . ;
"RTN","VPRDRMIM",86,0)
 . I ATT?1"interruption"1N D  S Y="" Q
"RTN","VPRDRMIM",87,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDRMIM",88,0)
 .. S I=0 F  S I=$O(FIM(ATT,I)) Q:I<1  D
"RTN","VPRDRMIM",89,0)
 ... S X=FIM(ATT,I),Y="<"_ATT_" transfer='"_$P(X,U)
"RTN","VPRDRMIM",90,0)
 ... S:$P(X,U,2) Y=Y_"' return='"_$P(X,U,2)
"RTN","VPRDRMIM",91,0)
 ... S Y=Y_"' >" D ADD(Y)
"RTN","VPRDRMIM",92,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDRMIM",93,0)
 . ;
"RTN","VPRDRMIM",94,0)
 . S X=$G(FIM(ATT)),Y="" Q:'$L(X)
"RTN","VPRDRMIM",95,0)
 . I ATT="document" D  S Y="" Q
"RTN","VPRDRMIM",96,0)
 .. S NAMES="id^localTitle^nationalTitle^vuid^Z",TEXT=$G(FIM(ATT,"content"))
"RTN","VPRDRMIM",97,0)
 .. S Y="<"_ATT_" "_$$LOOP_$S($L(TEXT):">",1:"/>")
"RTN","VPRDRMIM",98,0)
 .. D ADD(Y) Q:'$L(TEXT)
"RTN","VPRDRMIM",99,0)
 .. S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDRMIM",100,0)
 .. S I=0 F  S I=$O(@TEXT@(I)) Q:I<1  S Y=$$ESC^VPRD(@TEXT@(I)) D ADD(Y)
"RTN","VPRDRMIM",101,0)
 .. D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDRMIM",102,0)
 . ;
"RTN","VPRDRMIM",103,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDRMIM",104,0)
 . I $L(X)>1 S NAMES="code^name^Z",Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDRMIM",105,0)
 D ADD("</fim>")
"RTN","VPRDRMIM",106,0)
 Q
"RTN","VPRDRMIM",107,0)
 ;
"RTN","VPRDRMIM",108,0)
VAL(X) ; -- add FIM measurement values
"RTN","VPRDRMIM",109,0)
 N NAMES,Y S Y=""
"RTN","VPRDRMIM",110,0)
 S NAMES="eat^groom^bath^dressUp^dressLo^toilet^bladder^bowel^transChair^transToilet^transTub^locomWalk^locomStair^comprehend^express^interact^problem^memory^walkMode^comprehendMode^expressMode^Z"
"RTN","VPRDRMIM",111,0)
 S Y="<values "_$$LOOP_"/>"
"RTN","VPRDRMIM",112,0)
 D ADD(Y)
"RTN","VPRDRMIM",113,0)
 Q
"RTN","VPRDRMIM",114,0)
 ;
"RTN","VPRDRMIM",115,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDRMIM",116,0)
 N STR,P,TAG S STR=""
"RTN","VPRDRMIM",117,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDRMIM",118,0)
 Q STR
"RTN","VPRDRMIM",119,0)
 ;
"RTN","VPRDRMIM",120,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDRMIM",121,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDRMIM",122,0)
 S @VPR@(VPRI)=X
"RTN","VPRDRMIM",123,0)
 Q
"RTN","VPRDSDAM")
0^9^B21167478^B20114385
"RTN","VPRDSDAM",1,0)
VPRDSDAM ;SLC/MKB -- Appointment extract ;8/2/11  15:29
"RTN","VPRDSDAM",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,5**;Sep 01, 2011;Build 21
"RTN","VPRDSDAM",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDSDAM",4,0)
 ;
"RTN","VPRDSDAM",5,0)
 ; External References          DBIA#
"RTN","VPRDSDAM",6,0)
 ; -------------------          -----
"RTN","VPRDSDAM",7,0)
 ; ^DGS(41.1                     3796
"RTN","VPRDSDAM",8,0)
 ; ^DIC(42                      10039
"RTN","VPRDSDAM",9,0)
 ; ^SC                          10040
"RTN","VPRDSDAM",10,0)
 ; ^VA(200                      10060
"RTN","VPRDSDAM",11,0)
 ; DIQ                           2056
"RTN","VPRDSDAM",12,0)
 ; SDAMA301                      4433
"RTN","VPRDSDAM",13,0)
 ;
"RTN","VPRDSDAM",14,0)
 ; ------------ Get appointment(s) from VistA ------------
"RTN","VPRDSDAM",15,0)
 ;
"RTN","VPRDSDAM",16,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's [future] appointments
"RTN","VPRDSDAM",17,0)
 N VPRX,VPRNUM,VPRDT,VPRCNT,VPRITM,VPRA,X
"RTN","VPRDSDAM",18,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDSDAM",19,0)
 I $G(BEG)<2000000 S BEG=DT
"RTN","VPRDSDAM",20,0)
 S END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDSDAM",21,0)
 S VPRX(1)=BEG_";"_END,VPRX(4)=DFN,VPRX("FLDS")="1;2;3;10;13",VPRX("SORT")="P"
"RTN","VPRDSDAM",22,0)
 ;
"RTN","VPRDSDAM",23,0)
 ; get one appt
"RTN","VPRDSDAM",24,0)
 I $L($G(ID)) D  Q
"RTN","VPRDSDAM",25,0)
 . S (BEG,END)=$P(ID,";",2),VPRX(1)=BEG_";"_END,VPRX(2)=$P(ID,";",3)
"RTN","VPRDSDAM",26,0)
 . S VPRNUM=$$SDAPI^SDAMA301(.VPRX) Q:VPRNUM<1
"RTN","VPRDSDAM",27,0)
 . D EN1(BEG,.VPRITM),XML(.VPRITM)
"RTN","VPRDSDAM",28,0)
 . K ^TMP($J,"SDAMA301",DFN)
"RTN","VPRDSDAM",29,0)
 ;
"RTN","VPRDSDAM",30,0)
 ; get all [future] appointments
"RTN","VPRDSDAM",31,0)
 S VPRX(3)="R;I;NS;NSR;NT" ;no cancelled appt's
"RTN","VPRDSDAM",32,0)
 S VPRNUM=$$SDAPI^SDAMA301(.VPRX),(VPRDT,VPRCNT)=0
"RTN","VPRDSDAM",33,0)
 F  S VPRDT=$O(^TMP($J,"SDAMA301",DFN,VPRDT)) Q:VPRDT<1  D  Q:VPRCNT'<MAX
"RTN","VPRDSDAM",34,0)
 . S X=$P($G(^TMP($J,"SDAMA301",DFN,VPRDT)),U,3)
"RTN","VPRDSDAM",35,0)
 . I VPRDT<DT,$P(X,";")'["NS" Q   ;no prior kept appt's
"RTN","VPRDSDAM",36,0)
 . K VPRITM D EN1(VPRDT,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDSDAM",37,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDSDAM",38,0)
 K ^TMP($J,"SDAMA301",DFN)
"RTN","VPRDSDAM",39,0)
 ;
"RTN","VPRDSDAM",40,0)
 ; get scheduled admissions
"RTN","VPRDSDAM",41,0)
 S VPRA=0 F  S VPRA=$O(^DGS(41.1,"B",DFN,VPRA)) Q:VPRA<1  D  Q:VPRCNT'<MAX
"RTN","VPRDSDAM",42,0)
 . S VPRX=$G(^DGS(41.1,VPRA,0))
"RTN","VPRDSDAM",43,0)
 . Q:$P(VPRX,U,13)  Q:$P(VPRX,U,17)  ;cancelled or admitted
"RTN","VPRDSDAM",44,0)
 . S X=$P(VPRX,U,2) Q:X<BEG!(X>END)  ;out of date range
"RTN","VPRDSDAM",45,0)
 . K VPRITM D DGS(VPRA,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDSDAM",46,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDSDAM",47,0)
 Q
"RTN","VPRDSDAM",48,0)
 ;
"RTN","VPRDSDAM",49,0)
EN1(DATE,APPT) ; -- return an appointment in APPT("attribute")=value
"RTN","VPRDSDAM",50,0)
 ;  Expects ^TMP($J,"SDAMA301",DFN,DATE)
"RTN","VPRDSDAM",51,0)
 N X,HLOC,STS,CLS,SV,PRV K APPT
"RTN","VPRDSDAM",52,0)
 S X=$G(^TMP($J,"SDAMA301",DFN,DATE))
"RTN","VPRDSDAM",53,0)
 S DATE=+$G(DATE),HLOC=$P(X,U,2),APPT("type")=$TR($P(X,U,10),";","^")
"RTN","VPRDSDAM",54,0)
 S STS=$P(X,U,3),CLS=$S($E(STS)="I":"I",1:"O")
"RTN","VPRDSDAM",55,0)
 S APPT("id")="A;"_DATE_";"_+HLOC,APPT("dateTime")=DATE I HLOC D
"RTN","VPRDSDAM",56,0)
 . S APPT("location")=$P(HLOC,";",2)
"RTN","VPRDSDAM",57,0)
 . S APPT("clinicStop")=$$AMIS^VPRDVSIT(+$P(X,U,13))
"RTN","VPRDSDAM",58,0)
 . S SV=$$GET1^DIQ(44,+HLOC_",",9.5,"I")
"RTN","VPRDSDAM",59,0)
 . I SV S APPT("service")=$$SERV(SV)
"RTN","VPRDSDAM",60,0)
 . I 'SV S APPT("service")=$$GET1^DIQ(44,+HLOC_",",9)
"RTN","VPRDSDAM",61,0)
 . ;find default provider
"RTN","VPRDSDAM",62,0)
 . S PRV=+$$GET1^DIQ(44,+HLOC_",",16,"I") I 'PRV D
"RTN","VPRDSDAM",63,0)
 .. N VPRP,I,FIRST
"RTN","VPRDSDAM",64,0)
 .. D GETS^DIQ(44,+HLOC_",","2600*","I","VPRP")
"RTN","VPRDSDAM",65,0)
 .. S FIRST=$O(VPRP(44.1,"")),I=""
"RTN","VPRDSDAM",66,0)
 .. F  S I=$O(VPRP(44.1,I)) Q:I=""  I $G(VPRP(44.1,I,.02,"I")) S PRV=$G(VPRP(44.1,I,.01,"I")) Q
"RTN","VPRDSDAM",67,0)
 .. I 'PRV,FIRST S PRV=$G(VPRP(44.1,FIRST,.01,"I"))
"RTN","VPRDSDAM",68,0)
 . I PRV S APPT("provider")=PRV_U_$P($G(^VA(200,PRV,0)),U) Q
"RTN","VPRDSDAM",69,0)
 S APPT("facility")=$$FAC^VPRD(+HLOC)
"RTN","VPRDSDAM",70,0)
 S APPT("patientClass")=$S(CLS="I":"IMP",1:"AMB")
"RTN","VPRDSDAM",71,0)
 S APPT("serviceCategory")=$S(CLS="I":"I^INPATIENT VISIT",1:"A^AMBULATORY")
"RTN","VPRDSDAM",72,0)
 S APPT("apptStatus")=$P(STS,";",2)
"RTN","VPRDSDAM",73,0)
 S APPT("visitString")=+HLOC_";"_DATE_";A"
"RTN","VPRDSDAM",74,0)
 Q
"RTN","VPRDSDAM",75,0)
 ;
"RTN","VPRDSDAM",76,0)
SERV(FTS) ; -- Return #42.4 Service for a Facility Treating Specialty
"RTN","VPRDSDAM",77,0)
 N Y S Y="",FTS=+$G(FTS)
"RTN","VPRDSDAM",78,0)
 S Y=$$GET1^DIQ(45.7,FTS_",","1:3","E")
"RTN","VPRDSDAM",79,0)
 Q Y
"RTN","VPRDSDAM",80,0)
 ;
"RTN","VPRDSDAM",81,0)
DGS(IFN,ADM) ; -- return a scheduled admission in ADM("attribute")=value
"RTN","VPRDSDAM",82,0)
 N X0,DATE,HLOC,SV,X K ADM
"RTN","VPRDSDAM",83,0)
 S X0=$G(^DGS(41.1,+$G(IFN),0)) Q:X0=""  ;deleted
"RTN","VPRDSDAM",84,0)
 S DATE=+$P(X0,U,2),HLOC=+$G(^DIC(42,+$P(X0,U,8),44))
"RTN","VPRDSDAM",85,0)
 S ADM("id")="H;"_DATE,ADM("dateTime")=DATE I HLOC D
"RTN","VPRDSDAM",86,0)
 . S ADM("id")=ADM("id")_";"_HLOC,ADM("visitString")=HLOC_";"_DATE_";H"
"RTN","VPRDSDAM",87,0)
 . S ADM("location")=HLOC_U_$P($G(^SC(HLOC,0)),U)
"RTN","VPRDSDAM",88,0)
 . S X=$$GET1^DIQ(44,HLOC_",",8,"I"),ADM("clinicStop")=$$AMIS^VPRDVSIT(X)
"RTN","VPRDSDAM",89,0)
 . S SV=$$GET1^DIQ(44,HLOC_",",9.5,"I")
"RTN","VPRDSDAM",90,0)
 . I SV S ADM("service")=$$SERV(SV)
"RTN","VPRDSDAM",91,0)
 . I 'SV S ADM("service")=$$GET1^DIQ(44,+HLOC_",",9)
"RTN","VPRDSDAM",92,0)
 S ADM("facility")=$$FAC^VPRD(HLOC)
"RTN","VPRDSDAM",93,0)
 S X=$P(X0,U,5) I X S ADM("provider")=X_U_$P($G(^VA(200,X,0)),U)
"RTN","VPRDSDAM",94,0)
 S ADM("patientClass")="IMP",ADM("serviceCategory")="H^HOSPITALIZATION"
"RTN","VPRDSDAM",95,0)
 S ADM("apptStatus")=$S($P(X0,U,17):"ADMITTED",$P(X0,U,13):"CANCELLED",1:"SCHEDULED")
"RTN","VPRDSDAM",96,0)
 Q
"RTN","VPRDSDAM",97,0)
 ;
"RTN","VPRDSDAM",98,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDSDAM",99,0)
 ;
"RTN","VPRDSDAM",100,0)
XML(APPT) ; -- Return appointment as XML
"RTN","VPRDSDAM",101,0)
 N ATT,X,Y,NAMES
"RTN","VPRDSDAM",102,0)
 D ADD("<appointment>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDSDAM",103,0)
 S ATT="" F  S ATT=$O(APPT(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDSDAM",104,0)
 . S X=$G(APPT(ATT)),Y="" Q:'$L(X)
"RTN","VPRDSDAM",105,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDSDAM",106,0)
 . I $L(X)>1 S NAMES="code^name^Z",Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDSDAM",107,0)
 D ADD("</appointment>")
"RTN","VPRDSDAM",108,0)
 Q
"RTN","VPRDSDAM",109,0)
 ;
"RTN","VPRDSDAM",110,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDSDAM",111,0)
 N STR,P,TAG S STR=""
"RTN","VPRDSDAM",112,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDSDAM",113,0)
 Q STR
"RTN","VPRDSDAM",114,0)
 ;
"RTN","VPRDSDAM",115,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDSDAM",116,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDSDAM",117,0)
 S @VPR@(VPRI)=X
"RTN","VPRDSDAM",118,0)
 Q
"RTN","VPRDSR")
0^15^B30721686^B30371946
"RTN","VPRDSR",1,0)
VPRDSR ;SLC/MKB -- Surgical Procedures ;8/2/11  15:29
"RTN","VPRDSR",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,5**;Sep 01, 2011;Build 21
"RTN","VPRDSR",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDSR",4,0)
 ;
"RTN","VPRDSR",5,0)
 ; External References          DBIA#
"RTN","VPRDSR",6,0)
 ; -------------------          -----
"RTN","VPRDSR",7,0)
 ; ^SRF(130                      5675
"RTN","VPRDSR",8,0)
 ; ^SRO(136                      4872
"RTN","VPRDSR",9,0)
 ; DIQ                           2056
"RTN","VPRDSR",10,0)
 ; ICPTCOD                       1995
"RTN","VPRDSR",11,0)
 ; ICPTMOD                       1996
"RTN","VPRDSR",12,0)
 ; SROESTV                       3533
"RTN","VPRDSR",13,0)
 ;
"RTN","VPRDSR",14,0)
 ; ------------ Get surgery(ies) from VistA ------------
"RTN","VPRDSR",15,0)
 ;
"RTN","VPRDSR",16,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's surgeries
"RTN","VPRDSR",17,0)
 N VPRN,VPRCNT,VPRITM,VPRY
"RTN","VPRDSR",18,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDSR",19,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDSR",20,0)
 ;
"RTN","VPRDSR",21,0)
 ; get one surgery
"RTN","VPRDSR",22,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) G ENQ
"RTN","VPRDSR",23,0)
 ;
"RTN","VPRDSR",24,0)
 ; get all surgeries
"RTN","VPRDSR",25,0)
 Q:'$L($T(LIST^SROESTV))
"RTN","VPRDSR",26,0)
 N SHOWADD S SHOWADD=1 ;to omit leading '+' with note titles
"RTN","VPRDSR",27,0)
 D LIST^SROESTV(.VPRY,DFN,BEG,END,MAX,1)
"RTN","VPRDSR",28,0)
 S VPRN=0 F  S VPRN=$O(@VPRY@(VPRN)) Q:VPRN<1  D
"RTN","VPRDSR",29,0)
 . K VPRITM D ONE(VPRN,.VPRITM)
"RTN","VPRDSR",30,0)
 . I $D(VPRITM) D XML(.VPRITM)
"RTN","VPRDSR",31,0)
 K @VPRY
"RTN","VPRDSR",32,0)
ENQ ; end
"RTN","VPRDSR",33,0)
 K ^TMP("VPRTEXT",$J)
"RTN","VPRDSR",34,0)
 Q
"RTN","VPRDSR",35,0)
 ;
"RTN","VPRDSR",36,0)
ONE(NUM,SURG) ; -- return a surgery in SURG("attribute")=value
"RTN","VPRDSR",37,0)
 ;  Expects DFN, @VPRY@(NUM) from LIST^SROESTV
"RTN","VPRDSR",38,0)
 N IEN,VPRX,X,Y,I,VPRMOD,VPROTH
"RTN","VPRDSR",39,0)
 K SURG,^TMP("VPRTEXT",$J)
"RTN","VPRDSR",40,0)
 S VPRX=$G(@VPRY@(NUM)),IEN=+$P(VPRX,U) Q:IEN<1
"RTN","VPRDSR",41,0)
 S SURG("id")=IEN,X=$P(VPRX,U,2),SURG("status")="COMPLETED"
"RTN","VPRDSR",42,0)
 I X?1"* Aborted * ".E S X=$E(X,13,999),SURG("status")="ABORTED"
"RTN","VPRDSR",43,0)
 S SURG("name")=X,SURG("dateTime")=$P(VPRX,U,3)
"RTN","VPRDSR",44,0)
 S X=$P(VPRX,U,4) S:X SURG("provider")=$TR(X,";","^")_U_$$PROVSPC^VPRD(+X)
"RTN","VPRDSR",45,0)
 S X=$$GET1^DIQ(130,IEN_",",50,"I"),SURG("facility")=$$FAC^VPRD(X)
"RTN","VPRDSR",46,0)
 S SURG("encounter")=$$GET1^DIQ(130,IEN_",",.015,"I")
"RTN","VPRDSR",47,0)
 S X=$$GET1^DIQ(136,IEN_",",.02,"I") I X D
"RTN","VPRDSR",48,0)
 . S SURG("type")=$$CPT(X)
"RTN","VPRDSR",49,0)
 . D GETS^DIQ(136,IEN_",","1*","I","VPRMOD") ;CPT modifiers
"RTN","VPRDSR",50,0)
 . S I="" F  S I=$O(VPRMOD(136.01,I)) Q:I=""  D
"RTN","VPRDSR",51,0)
 .. S X=+$G(VPRMOD(136.01,I,.01,"I")),Y=$$MOD^ICPTMOD(X,"I")
"RTN","VPRDSR",52,0)
 .. S SURG("modifier",+I)=$P(Y,U,2,3)
"RTN","VPRDSR",53,0)
 D GETS^DIQ(136,IEN_",","3*","I","VPROTH") ;other procedures
"RTN","VPRDSR",54,0)
 S I="" F  S I=$O(VPROTH(136.03,I)) Q:I=""  D
"RTN","VPRDSR",55,0)
 . S X=+$G(VPROTH(136.03,I,.01,"I")) Q:'X
"RTN","VPRDSR",56,0)
 . S SURG("otherProcedure",+I)=$$CPT(X)
"RTN","VPRDSR",57,0)
 S I=0 F  S I=$O(@VPRY@(NUM,I)) Q:I<1  S X=$G(@VPRY@(NUM,I)) I X D
"RTN","VPRDSR",58,0)
 . S Y=$$INFO^VPRDTIU(+X) Q:Y<1  ;draft or retracted
"RTN","VPRDSR",59,0)
 . S SURG("document",I)=Y
"RTN","VPRDSR",60,0)
 . S:$G(VPRTEXT) SURG("document",I,"content")=$$TEXT^VPRDTIU(+X)
"RTN","VPRDSR",61,0)
 . I Y["OPERATION REPORT"!(Y["PROCEDURE REPORT") S SURG("opReport")=Y
"RTN","VPRDSR",62,0)
 S SURG("category")="SR"
"RTN","VPRDSR",63,0)
 Q
"RTN","VPRDSR",64,0)
 ;
"RTN","VPRDSR",65,0)
EN1(IEN,SURG) ; -- return a surgery in SURG("attribute")=value
"RTN","VPRDSR",66,0)
 N VPRX,VPRY,X,Y,I,VPRMOD,VPROTH,SHOWADD
"RTN","VPRDSR",67,0)
 K SURG,^TMP("VPRTEXT",$J)
"RTN","VPRDSR",68,0)
 S SHOWADD=1 ;to omit leading '+' with note titles
"RTN","VPRDSR",69,0)
 D ONE^SROESTV("VPRY",IEN) S VPRX=$G(VPRY(IEN)) Q:VPRX=""
"RTN","VPRDSR",70,0)
 S SURG("id")=IEN,X=$P(VPRX,U,2),SURG("status")="COMPLETED"
"RTN","VPRDSR",71,0)
 I X?1"* Aborted * ".E S X=$E(X,13,999),SURG("status")="ABORTED"
"RTN","VPRDSR",72,0)
 S SURG("name")=X,SURG("dateTime")=$P(VPRX,U,3)
"RTN","VPRDSR",73,0)
 S X=$P(VPRX,U,4) S:X SURG("provider")=$TR(X,";","^")_U_$$PROVSPC^VPRD(+X)
"RTN","VPRDSR",74,0)
 S X=$$GET1^DIQ(130,IEN_",",50,"I"),SURG("facility")=$$FAC^VPRD(X)
"RTN","VPRDSR",75,0)
 S SURG("encounter")=$$GET1^DIQ(130,IEN_",",.015,"I")
"RTN","VPRDSR",76,0)
 S X=$$GET1^DIQ(136,IEN_",",.02,"I") I X D
"RTN","VPRDSR",77,0)
 . S SURG("type")=$$CPT(X)
"RTN","VPRDSR",78,0)
 . D GETS^DIQ(136,IEN_",","1*","I","VPRMOD") ;CPT modifiers
"RTN","VPRDSR",79,0)
 . S I="" F  S I=$O(VPRMOD(136.01,I)) Q:I=""  D
"RTN","VPRDSR",80,0)
 .. S X=+$G(VPRMOD(136.01,I,.01,"I")),Y=$$MOD^ICPTMOD(X,"I")
"RTN","VPRDSR",81,0)
 .. S SURG("modifier",+I)=$P(Y,U,2,3)
"RTN","VPRDSR",82,0)
 D GETS^DIQ(136,IEN_",","3*","I","VPROTH") ;other procedures
"RTN","VPRDSR",83,0)
 S I="" F  S I=$O(VPROTH(136.03,I)) Q:I=""  D
"RTN","VPRDSR",84,0)
 . S X=+$G(VPROTH(136.03,I,.01,"I")) Q:'X
"RTN","VPRDSR",85,0)
 . S SURG("otherProcedure",+I)=$$CPT(X)
"RTN","VPRDSR",86,0)
 S I=0 F  S I=$O(VPRY(IEN,I)) Q:I<1  S X=$G(VPRY(IEN,I)) I X D
"RTN","VPRDSR",87,0)
 . S Y=$$INFO^VPRDTIU(+X) Q:Y<1  ;draft or retracted
"RTN","VPRDSR",88,0)
 . S SURG("document",I)=Y
"RTN","VPRDSR",89,0)
 . S:$G(VPRTEXT) SURG("document",I,"content")=$$TEXT^VPRDTIU(+X)
"RTN","VPRDSR",90,0)
 . I Y["OPERATION REPORT"!(Y["PROCEDURE REPORT") S SURG("opReport")=Y
"RTN","VPRDSR",91,0)
 S SURG("category")="SR"
"RTN","VPRDSR",92,0)
 Q
"RTN","VPRDSR",93,0)
 ;
"RTN","VPRDSR",94,0)
CPT(IEN) ; -- return code^description for CPT code, or "^" if error
"RTN","VPRDSR",95,0)
 N X0,VPRX,N,I,X,Y S IEN=+$G(IEN)
"RTN","VPRDSR",96,0)
 S X0=$$CPT^ICPTCOD(IEN) I X0<0 Q "^"
"RTN","VPRDSR",97,0)
 S Y=$P(X0,U,2,3)                  ;CPT Code^Short Name
"RTN","VPRDSR",98,0)
 S N=$$CPTD^ICPTCOD($P(Y,U),"VPRX") ;CPT Description
"RTN","VPRDSR",99,0)
 I N>0,$L($G(VPRX(1))) D
"RTN","VPRDSR",100,0)
 . S X=$G(VPRX(1)),I=1
"RTN","VPRDSR",101,0)
 . F  S I=$O(VPRX(I)) Q:I<1  Q:VPRX(I)=" "  S X=X_" "_VPRX(I)
"RTN","VPRDSR",102,0)
 . S $P(Y,U,2)=X
"RTN","VPRDSR",103,0)
 Q Y
"RTN","VPRDSR",104,0)
 ;
"RTN","VPRDSR",105,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDSR",106,0)
 ;
"RTN","VPRDSR",107,0)
XML(SURG) ; -- Return surgery as XML
"RTN","VPRDSR",108,0)
 N ATT,X,Y,NAMES,I,J
"RTN","VPRDSR",109,0)
 D ADD("<surgery>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDSR",110,0)
 S ATT="" F  S ATT=$O(SURG(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDSR",111,0)
 . I $O(SURG(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDSR",112,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDSR",113,0)
 .. S I=0 F  S I=$O(SURG(ATT,I)) Q:I<1  D
"RTN","VPRDSR",114,0)
 ... S X=$G(SURG(ATT,I)),NAMES=""
"RTN","VPRDSR",115,0)
 ... S NAMES=$S(ATT="document":"id^localTitle^nationalTitle^vuid^Z",1:"code^name^Z")
"RTN","VPRDSR",116,0)
 ... S Y="<"_ATT_" "_$$LOOP ;_"/>" D ADD(Y)
"RTN","VPRDSR",117,0)
 ... S X=$G(SURG(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDSR",118,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDSR",119,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDSR",120,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDSR",121,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDSR",122,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDSR",123,0)
 . S X=$G(SURG(ATT)),Y="" Q:'$L(X)
"RTN","VPRDSR",124,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDSR",125,0)
 . S NAMES=$S(ATT="opReport":"id^localTitle^nationalTitle^vuid",ATT="provider":"code^name^"_$$PROVTAGS^VPRD,1:"code^name")_"^Z"
"RTN","VPRDSR",126,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDSR",127,0)
 D ADD("</surgery>")
"RTN","VPRDSR",128,0)
 Q
"RTN","VPRDSR",129,0)
 ;
"RTN","VPRDSR",130,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDSR",131,0)
 N STR,P,TAG S STR=""
"RTN","VPRDSR",132,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDSR",133,0)
 Q STR
"RTN","VPRDSR",134,0)
 ;
"RTN","VPRDSR",135,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDSR",136,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDSR",137,0)
 S @VPR@(VPRI)=X
"RTN","VPRDSR",138,0)
 Q
"RTN","VPRDTIU")
0^18^B90403730^B83582740
"RTN","VPRDTIU",1,0)
VPRDTIU ;SLC/MKB -- TIU extract ;8/2/11  15:29
"RTN","VPRDTIU",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,2,4,5**;Sep 01, 2011;Build 21
"RTN","VPRDTIU",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDTIU",4,0)
 ;
"RTN","VPRDTIU",5,0)
 ; External References          DBIA#
"RTN","VPRDTIU",6,0)
 ; -------------------          -----
"RTN","VPRDTIU",7,0)
 ; ^SC(                         10040
"RTN","VPRDTIU",8,0)
 ; ^TIU(8925.1              2321,5677
"RTN","VPRDTIU",9,0)
 ; ^TIU(8926.1                   5678
"RTN","VPRDTIU",10,0)
 ; ^VA(200                      10060
"RTN","VPRDTIU",11,0)
 ; DIQ                           2056
"RTN","VPRDTIU",12,0)
 ; RAO7PC1                       2043
"RTN","VPRDTIU",13,0)
 ; TIUCNSLT                      5546
"RTN","VPRDTIU",14,0)
 ; TIUCP                         3568
"RTN","VPRDTIU",15,0)
 ; TIULQ                         2693
"RTN","VPRDTIU",16,0)
 ; TIULX                         3058
"RTN","VPRDTIU",17,0)
 ; TIUSROI                       5676
"RTN","VPRDTIU",18,0)
 ; TIUSRVLO                 2834,2865
"RTN","VPRDTIU",19,0)
 ; TIUSRVR1                      2944
"RTN","VPRDTIU",20,0)
 ; XLFSTR                       10104
"RTN","VPRDTIU",21,0)
 ;
"RTN","VPRDTIU",22,0)
 ; ------------ Get documents from VistA ------------
"RTN","VPRDTIU",23,0)
 ;
"RTN","VPRDTIU",24,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's documents
"RTN","VPRDTIU",25,0)
 N VPRITM,VPRN,VPRX,VPRY,VPRCNT
"RTN","VPRDTIU",26,0)
 S DFN=+$G(DFN) Q:$G(DFN)<1
"RTN","VPRDTIU",27,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDTIU",28,0)
 ;
"RTN","VPRDTIU",29,0)
 ; get one document
"RTN","VPRDTIU",30,0)
 I $L($G(ID)),ID[";" D  G ENQ
"RTN","VPRDTIU",31,0)
 . I ID D RPT1^VPRDMC(DFN,ID,.VPRITM),XML(.VPRITM) Q  ;CP
"RTN","VPRDTIU",32,0)
 . D RPT1^VPRDLRA(DFN,ID,.VPRITM),XML(.VPRITM) Q      ;Lab
"RTN","VPRDTIU",33,0)
 I $G(ID),ID["-" D  G ENQ                             ;Radiology
"RTN","VPRDTIU",34,0)
 . S (BEG,END)=9999999.9999-+ID D EN1^RAO7PC1(DFN,BEG,END,"99P")
"RTN","VPRDTIU",35,0)
 . D RPT1^VPRDRA(DFN,ID,.VPRITM),XML(.VPRITM)
"RTN","VPRDTIU",36,0)
 . K ^TMP($J,"RAE1")
"RTN","VPRDTIU",37,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM):$D(VPRITM) G ENQ
"RTN","VPRDTIU",38,0)
 ;
"RTN","VPRDTIU",39,0)
 ; get all documents
"RTN","VPRDTIU",40,0)
 N CLASS,SUBCLASS,TITLE,SERVICE,SUBJECT,NOTSUBJ,STATUS,VPRC,CLS,VPRS,CTXT
"RTN","VPRDTIU",41,0)
 D SETUP S VPRCNT=0 ;define search criteria
"RTN","VPRDTIU",42,0)
 I CLASS="CP" D RPTS^VPRDMC(DFN,BEG,END,MAX) Q
"RTN","VPRDTIU",43,0)
 I CLASS="RA" D RPTS^VPRDRA(DFN,BEG,END,MAX) Q
"RTN","VPRDTIU",44,0)
 I CLASS="LR" D RPTS^VPRDLRA(DFN,BEG,END,MAX) Q
"RTN","VPRDTIU",45,0)
 F VPRC=1:1:$L(CLASS,U) S CLS=$P(CLASS,U,VPRC) D  Q:VPRCNT'<MAX
"RTN","VPRDTIU",46,0)
 . F VPRS=1:1:$L(STATUS,U) S CTXT=$P(STATUS,U,VPRS) D  Q:VPRCNT'<MAX
"RTN","VPRDTIU",47,0)
 .. D CONTEXT^TIUSRVLO(.VPRY,CLS,CTXT,DFN,BEG,END,,,,1)
"RTN","VPRDTIU",48,0)
 .. S VPRN=0 F  S VPRN=$O(@VPRY@(VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDTIU",49,0)
 ... S VPRX=$G(@VPRY@(VPRN)) Q:'$$MATCH(VPRX)
"RTN","VPRDTIU",50,0)
 ... K VPRITM D EN1(VPRX,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDTIU",51,0)
 ... D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDTIU",52,0)
 .. K @VPRY
"RTN","VPRDTIU",53,0)
ENQ ; end
"RTN","VPRDTIU",54,0)
 K ^TMP("VPRTEXT",$J)
"RTN","VPRDTIU",55,0)
 Q
"RTN","VPRDTIU",56,0)
 ;
"RTN","VPRDTIU",57,0)
EN1(VPRX,DOC) ; -- return a document in DOC("attribute")=value
"RTN","VPRDTIU",58,0)
 ;  Expects DFN, VPRX=IEN^$$RESOLVE^TIUSRVLO(IEN)
"RTN","VPRDTIU",59,0)
 N IEN,X,NAME,VPRTIU,ES,I,VPRY
"RTN","VPRDTIU",60,0)
 K DOC,^TMP("VPRTEXT",$J)
"RTN","VPRDTIU",61,0)
 S IEN=+$G(VPRX) Q:IEN<1  ;invalid ien
"RTN","VPRDTIU",62,0)
 I +VPRX=VPRX D  ;get data string, if needed
"RTN","VPRDTIU",63,0)
 . N SHOWADD,DA S SHOWADD=1,DA=+VPRX
"RTN","VPRDTIU",64,0)
 . S VPRX=DA_U_$$RESOLVE^TIUSRVLO(DA)
"RTN","VPRDTIU",65,0)
 Q:"UNKNOWN"[$P($G(VPRX),U,2)  ;null or invalid
"RTN","VPRDTIU",66,0)
 S NAME=$P(VPRX,U,2) ;I $P(VPRX,U,14),$P(NAME," ")="Addendum" Q
"RTN","VPRDTIU",67,0)
 S DOC("id")=IEN,DOC("localTitle")=NAME
"RTN","VPRDTIU",68,0)
 D EXTRACT^TIULQ(IEN,"VPRTIU",,".01:.04;1501:1508")
"RTN","VPRDTIU",69,0)
 S X=$$GET1^DIQ(8925,IEN_",",".01:1501","I") I X D
"RTN","VPRDTIU",70,0)
 . N IENS,TIU,Y,FNUM
"RTN","VPRDTIU",71,0)
 . S IENS=X_"," D GETS^DIQ(8926.1,IENS,"*","IE","TIU")
"RTN","VPRDTIU",72,0)
 . S DOC("nationalTitle")=$G(TIU(8926.1,IENS,99.99,"E"))_U_$G(TIU(8926.1,IENS,.01,"E"))
"RTN","VPRDTIU",73,0)
 . F I=".04^Subject^2",".05^Role^3",".06^Setting^4",".07^Service^5",".08^Type^6" D
"RTN","VPRDTIU",74,0)
 .. S Y=+$G(TIU(8926.1,IENS,+I,"I")) Q:Y'>0
"RTN","VPRDTIU",75,0)
 .. S FNUM="8926."_+$P(I,U,3)
"RTN","VPRDTIU",76,0)
 .. S DOC("nationalTitle"_$P(I,U,2))=$$VUID^VPRD(Y,FNUM)_U_$G(TIU(8926.1,IENS,+I,"E"))
"RTN","VPRDTIU",77,0)
 S:$G(FILTER("loinc")) DOC("loinc")=$P(FILTER("loinc"),U)
"RTN","VPRDTIU",78,0)
 S X=+$G(VPRTIU(IEN,.01,"I")),X=$$CATG(X),(DOC("type"),DOC("category"))=X
"RTN","VPRDTIU",79,0)
 S DOC("documentClass")=$S(X="LR":"LR LABORATORY REPORTS",X="SR":"SURGICAL REPORTS",X="CP":"CLINICAL PROCEDURES",X="DS":"DISCHARGE SUMMARY",1:"PROGRESS NOTES")
"RTN","VPRDTIU",80,0)
 S DOC("referenceDateTime")=$P(VPRX,U,3)
"RTN","VPRDTIU",81,0)
 S X=$P(VPRX,U,6) D  ;S:$L(X) DOC("location")=X
"RTN","VPRDTIU",82,0)
 . N LOC S LOC=$S($L(X):+$O(^SC("B",X,0)),1:0)
"RTN","VPRDTIU",83,0)
 . S DOC("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDTIU",84,0)
 S X=$P(VPRX,U,7) S:$L(X) DOC("status")=X
"RTN","VPRDTIU",85,0)
 S:$P(VPRX,U,11) DOC("images")=+$P(VPRX,U,11)
"RTN","VPRDTIU",86,0)
 S:$L($P(VPRX,U,12)) DOC("subject")=$P(VPRX,U,12)
"RTN","VPRDTIU",87,0)
 ; X=$S($P(VPRX,U,13)[">":"C",$P(VPRX,U,13)["<":"I",1:"") ;componentType
"RTN","VPRDTIU",88,0)
 I $P(VPRX,U,14)>5 S DOC("parent")=$P(VPRX,U,14) ;ID notes
"RTN","VPRDTIU",89,0)
 S DOC("encounter")=$G(VPRTIU(IEN,.03,"I"))
"RTN","VPRDTIU",90,0)
 S:$G(VPRTEXT) DOC("content")=$$TEXT(IEN)
"RTN","VPRDTIU",91,0)
 ; providers &/or signatures
"RTN","VPRDTIU",92,0)
 S X=$P(VPRX,U,5),I=0               ;author
"RTN","VPRDTIU",93,0)
 S:X I=I+1,DOC("clinician",I)=+X_U_$P(X,";",3)_"^A^^^"_$$PROVSPC^VPRD(+X)
"RTN","VPRDTIU",94,0)
 M ES=VPRTIU(IEN) I ES(1501,"I") D  ;signed
"RTN","VPRDTIU",95,0)
 . S I=I+1,X=ES(1502,"I")
"RTN","VPRDTIU",96,0)
 . S DOC("clinician",I)=X_U_ES(1502,"E")_"^S^"_ES(1501,"I")_U_$$SIG(X)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDTIU",97,0)
 I ES(1507,"I") D                   ;cosigned
"RTN","VPRDTIU",98,0)
 . S I=I+1,X=ES(1508,"I")
"RTN","VPRDTIU",99,0)
 . S DOC("clinician",I)=X_U_ES(1508,"E")_"^C^"_ES(1507,"I")_U_$$SIG(X)_U_$$PROVSPC^VPRD(X)
"RTN","VPRDTIU",100,0)
 Q
"RTN","VPRDTIU",101,0)
 ;
"RTN","VPRDTIU",102,0)
CATG(DA) ; -- Return a code for document type #8925.1 DA
"RTN","VPRDTIU",103,0)
 N X
"RTN","VPRDTIU",104,0)
 D ISCNSLT^TIUCNSLT(.X,DA) I X Q "CR"  ;consult result
"RTN","VPRDTIU",105,0)
 I $$ISA^TIULX(DA,25) Q "A"            ;CWAD note/Allergy
"RTN","VPRDTIU",106,0)
 I $$ISA^TIULX(DA,27) Q "D"            ;CWAD note/Advance Directive
"RTN","VPRDTIU",107,0)
 I $$ISA^TIULX(DA,30) Q "C"            ;CWAD note/Crisis Note
"RTN","VPRDTIU",108,0)
 I $$ISA^TIULX(DA,31) Q "W"            ;CWAD note/Clinical Warning
"RTN","VPRDTIU",109,0)
 I $$ISA^TIULX(DA,3) Q "PN"            ;progress note
"RTN","VPRDTIU",110,0)
 ;
"RTN","VPRDTIU",111,0)
 I $$ISA^TIULX(DA,244) Q "DS"          ;discharge summary
"RTN","VPRDTIU",112,0)
 D ISCP^TIUCP(.X,DA) I X Q "CP"        ;clinical procedure
"RTN","VPRDTIU",113,0)
 D ISSURG^TIUSROI(.X,DA) I X Q "SR"    ;surgery
"RTN","VPRDTIU",114,0)
 I $$ISA^TIULX(DA,$$LR) Q "LR"         ;laboratory
"RTN","VPRDTIU",115,0)
 Q ""
"RTN","VPRDTIU",116,0)
 ;
"RTN","VPRDTIU",117,0)
LR() ; -- Return ien of Lab class
"RTN","VPRDTIU",118,0)
 N Y S Y=+$O(^TIU(8925.1,"B","LR LABORATORY REPORTS",0))
"RTN","VPRDTIU",119,0)
 I Y>0,$S($P($G(^TIU(8925.1,Y,0)),U,4)="CL":0,$P($G(^(0)),U,4)="DC":0,1:1) S Y=0
"RTN","VPRDTIU",120,0)
 Q Y
"RTN","VPRDTIU",121,0)
 ;
"RTN","VPRDTIU",122,0)
SIG(X) ; -- Return Signature Block Name_Title
"RTN","VPRDTIU",123,0)
 N X20,Y S X20=$G(^VA(200,+$G(X),20))
"RTN","VPRDTIU",124,0)
 S Y=$P(X20,U,2)_" "_$P(X20,U,3)
"RTN","VPRDTIU",125,0)
 Q Y
"RTN","VPRDTIU",126,0)
 ;
"RTN","VPRDTIU",127,0)
RPT(VPRY,IFN) ; -- Return text of document in @VPRY@(n)
"RTN","VPRDTIU",128,0)
 N I,J ;protect for calling loops
"RTN","VPRDTIU",129,0)
 D TGET^TIUSRVR1(.VPRY,IFN)
"RTN","VPRDTIU",130,0)
 Q
"RTN","VPRDTIU",131,0)
 ;
"RTN","VPRDTIU",132,0)
TEXT(VPRIFN) ; -- Get document IFN text, return temp array name
"RTN","VPRDTIU",133,0)
 N VPRY,Y
"RTN","VPRDTIU",134,0)
 N IEN,IFN,CLASS,STATUS,CNT,X0,X,I,J ;protect for calling loops
"RTN","VPRDTIU",135,0)
 S VPRIFN=+$G(VPRIFN) D TGET^TIUSRVR1(.VPRY,VPRIFN)
"RTN","VPRDTIU",136,0)
 M ^TMP("VPRTEXT",$J,VPRIFN)=@VPRY K @VPRY
"RTN","VPRDTIU",137,0)
 S Y=$NA(^TMP("VPRTEXT",$J,VPRIFN))
"RTN","VPRDTIU",138,0)
 Q Y
"RTN","VPRDTIU",139,0)
 ;
"RTN","VPRDTIU",140,0)
INFO(IFN) ; -- Returns ien^localTitle^natlTitle^VUID
"RTN","VPRDTIU",141,0)
 ; or -1^STATUS if not viewable
"RTN","VPRDTIU",142,0)
 N X,Y,VPRTIU,LT,NT,VUID,I,J S IFN=+$G(IFN)
"RTN","VPRDTIU",143,0)
 I '$D(^TIU(8925,IFN,0)) Q "-1^DELETED"
"RTN","VPRDTIU",144,0)
 D EXTRACT^TIULQ(IFN,"VPRTIU",,".01;.05")
"RTN","VPRDTIU",145,0)
 I VPRTIU(IFN,.05,"I")<7!(VPRTIU(IFN,.05,"I")>13) Q "-1^"_VPRTIU(IFN,.05,"E")
"RTN","VPRDTIU",146,0)
 S LT=$G(VPRTIU(IFN,.01,"E")),VUID=""
"RTN","VPRDTIU",147,0)
 I $P(LT," ")="Addendum" Q "-1^ADDENDUM"
"RTN","VPRDTIU",148,0)
 S NT=$P($G(^TIU(8925.1,+$G(VPRTIU(IFN,.01,"I")),15)),U) I NT D
"RTN","VPRDTIU",149,0)
 . S VUID=$$VUID^VPRD(+NT,8926.1)
"RTN","VPRDTIU",150,0)
 . S NT=$$GET1^DIQ(8926.1,+NT_",",.01)
"RTN","VPRDTIU",151,0)
 S Y=IFN_U_LT_U_NT_U_VUID
"RTN","VPRDTIU",152,0)
 Q Y
"RTN","VPRDTIU",153,0)
 ;
"RTN","VPRDTIU",154,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDTIU",155,0)
 ;
"RTN","VPRDTIU",156,0)
XML(DOC) ; -- Return patient documents as XML
"RTN","VPRDTIU",157,0)
 N ATT,X,Y,NAMES,TYPE,I
"RTN","VPRDTIU",158,0)
 D ADD("<document>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDTIU",159,0)
 S ATT="" F  S ATT=$O(DOC(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDTIU",160,0)
 . I $O(DOC(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDTIU",161,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDTIU",162,0)
 .. S I=0 F  S I=$O(DOC(ATT,I)) Q:I<1  D
"RTN","VPRDTIU",163,0)
 ... S X=$G(DOC(ATT,I)),NAMES=""
"RTN","VPRDTIU",164,0)
 ... I ATT="clinician" S NAMES="code^name^role^dateTime^signature^"_$$PROVTAGS^VPRD_"^Z"
"RTN","VPRDTIU",165,0)
 ... S Y="<"_ATT_" "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDTIU",166,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDTIU",167,0)
 . S X=$G(DOC(ATT)),Y="" Q:'$L(X)
"RTN","VPRDTIU",168,0)
 . I ATT="content" D  S Y="" Q  ;text
"RTN","VPRDTIU",169,0)
 .. S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDTIU",170,0)
 .. S I=0 F  S I=$O(@X@(I)) Q:I<1  S Y=$$ESC^VPRD(@X@(I)) D ADD(Y)
"RTN","VPRDTIU",171,0)
 .. D ADD("</content>")
"RTN","VPRDTIU",172,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDTIU",173,0)
 . I $L(X)>1 S NAMES="code^name^Z",Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDTIU",174,0)
 D ADD("</document>")
"RTN","VPRDTIU",175,0)
 Q
"RTN","VPRDTIU",176,0)
 ;
"RTN","VPRDTIU",177,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDTIU",178,0)
 N STR,P,TAG S STR=""
"RTN","VPRDTIU",179,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDTIU",180,0)
 Q STR
"RTN","VPRDTIU",181,0)
 ;
"RTN","VPRDTIU",182,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDTIU",183,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDTIU",184,0)
 S @VPR@(VPRI)=X
"RTN","VPRDTIU",185,0)
 Q
"RTN","VPRDTIU",186,0)
 ;
"RTN","VPRDTIU",187,0)
 ; ------------ Get/apply search criteria ------------
"RTN","VPRDTIU",188,0)
 ;
"RTN","VPRDTIU",189,0)
SETUP ; -- convert FILTER("attribute") = value to TIU criteria
"RTN","VPRDTIU",190,0)
 ; Expects: FILTER("category") = code (see $$CATG)
"RTN","VPRDTIU",191,0)
 ;          FILTER("loinc")    = LOINC
"RTN","VPRDTIU",192,0)
 ;          FILTER("status")   = 'all','completed','unsigned'
"RTN","VPRDTIU",193,0)
 ; Returns CLASS,[SUBCLASS,TITLE,SERVICE,SUBJECT,STATUS]
"RTN","VPRDTIU",194,0)
 ;
"RTN","VPRDTIU",195,0)
 N LOINC,TYPE,STS,CP
"RTN","VPRDTIU",196,0)
 S LOINC=+$G(FILTER("loinc")),TYPE=$$UP^XLFSTR($G(FILTER("category")))
"RTN","VPRDTIU",197,0)
 S CLASS="3^244",(SUBCLASS,TITLE,SERVICE,SUBJECT,NOTSUBJ,STATUS)=""
"RTN","VPRDTIU",198,0)
 ;
"RTN","VPRDTIU",199,0)
 ; status [default='complete']
"RTN","VPRDTIU",200,0)
 S STS=$$LOW^XLFSTR($G(FILTER("status")))
"RTN","VPRDTIU",201,0)
 S STATUS=$S(STS?1"unsig".E:2,STS="all":"5^2",1:5)  ;TIUSRVLO statuses
"RTN","VPRDTIU",202,0)
 ;
"RTN","VPRDTIU",203,0)
 ; progress notes
"RTN","VPRDTIU",204,0)
 I TYPE="PN" S CLASS=3 Q
"RTN","VPRDTIU",205,0)
 I TYPE="CR"!(LOINC=11488) S CLASS=3,SUBCLASS=+$$CLASS^TIUCNSLT Q
"RTN","VPRDTIU",206,0)
 ; LOINC=26442 S CLASS=3,SUBJECT="^114^" Q         ;OB/GYN
"RTN","VPRDTIU",207,0)
 I LOINC=34117 S CLASS=3,SERVICE="^88^" Q          ;H&P
"RTN","VPRDTIU",208,0)
 I TYPE="CWAD" S CLASS=3,SUBCLASS="25^27^30^31" Q  ;CWAD
"RTN","VPRDTIU",209,0)
 I TYPE="C" S CLASS=3,SUBCLASS=30 Q                ;Crisis Note
"RTN","VPRDTIU",210,0)
 I TYPE="W" S CLASS=3,SUBCLASS=31 Q                ;Clinical Warning
"RTN","VPRDTIU",211,0)
 I TYPE="A" S CLASS=3,SUBCLASS=25 Q                ;Allergy Note
"RTN","VPRDTIU",212,0)
 I TYPE="D"!(LOINC=42348) S CLASS=3,SUBCLASS=27 Q  ;Advance Directive
"RTN","VPRDTIU",213,0)
 ;
"RTN","VPRDTIU",214,0)
 ; discharge summaries
"RTN","VPRDTIU",215,0)
 I TYPE="DS"!(LOINC=18842) S CLASS=244 Q
"RTN","VPRDTIU",216,0)
 ;
"RTN","VPRDTIU",217,0)
 ; procedures
"RTN","VPRDTIU",218,0)
 I TYPE="SR"!(LOINC=29752) S CLASS=+$$CLASS^TIUSROI("SURGICAL REPORTS") Q
"RTN","VPRDTIU",219,0)
 D CPCLASS^TIUCP(.CP)
"RTN","VPRDTIU",220,0)
 I TYPE="CP" S CLASS=$S(STATUS=2:CP,1:"CP") Q       ;CLINICAL PROCEDURES
"RTN","VPRDTIU",221,0)
 I LOINC=26441 D  Q                                 ;CARDIOLOGY
"RTN","VPRDTIU",222,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",223,0)
 . S SUBJECT="^18^142^174^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",224,0)
 I LOINC=27896 D  Q                                 ;PULMONARY
"RTN","VPRDTIU",225,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",226,0)
 . S SUBJECT="^23^142^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",227,0)
 I LOINC=27895 D  Q                                 ;GASTROENTEROLOGY
"RTN","VPRDTIU",228,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",229,0)
 . S SUBJECT="^20^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",230,0)
 I LOINC=27897 D  Q                                 ;NEUROLOGY
"RTN","VPRDTIU",231,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",232,0)
 . S SUBJECT="^44^45^52^111^112^143^146^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",233,0)
 I LOINC=28619 D  Q                                 ;OPHTH/OPTOMETRY
"RTN","VPRDTIU",234,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",235,0)
 . S SUBJECT="^13^14^103^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",236,0)
 I LOINC=28634 D  Q                                 ;MISC/ALL OTHERS
"RTN","VPRDTIU",237,0)
 . S CLASS=CP_"^3",SERVICE="^75^76^115^"
"RTN","VPRDTIU",238,0)
 . S NOTSUBJ="^18^142^174^23^142^20^44^45^52^111^112^143^146^13^14^103^"
"RTN","VPRDTIU",239,0)
 I LOINC=28570 D  Q                                 ;UNSPECIFIED/ALL
"RTN","VPRDTIU",240,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",241,0)
 . S SERVICE="^75^76^115^"
"RTN","VPRDTIU",242,0)
 ;
"RTN","VPRDTIU",243,0)
 ; pathology/lab
"RTN","VPRDTIU",244,0)
 I TYPE="LR"!(LOINC=27898) S CLASS=$S(STATUS=2:$$LR,1:"LR") Q
"RTN","VPRDTIU",245,0)
 ;
"RTN","VPRDTIU",246,0)
 ; radiology
"RTN","VPRDTIU",247,0)
 I TYPE="RA"!(LOINC=18726) S CLASS="RA" Q
"RTN","VPRDTIU",248,0)
 ;
"RTN","VPRDTIU",249,0)
 ; unknown
"RTN","VPRDTIU",250,0)
 I $L(TYPE)!LOINC S CLASS=0
"RTN","VPRDTIU",251,0)
 Q
"RTN","VPRDTIU",252,0)
 ;
"RTN","VPRDTIU",253,0)
MATCH(DOC) ; -- Return 1 or 0, if document DA matches search criteria
"RTN","VPRDTIU",254,0)
 N Y,DA,LOCAL,NATL,X0,OK S Y=0
"RTN","VPRDTIU",255,0)
 S DA=+$G(DOC) G:DA<1 MQ
"RTN","VPRDTIU",256,0)
 ; both parent + addenda returned by TIU if any match search criteria
"RTN","VPRDTIU",257,0)
 ; include addenda if pulling only unsigned items:
"RTN","VPRDTIU",258,0)
 I $P(DOC,U,2)?1"Addendum ".E,STATUS'=2 G MQ
"RTN","VPRDTIU",259,0)
 ; remove completed parent notes from TIU unsigned list:
"RTN","VPRDTIU",260,0)
 I CTXT=2,$P(DOC,U,7)'="unsigned" G MQ
"RTN","VPRDTIU",261,0)
 ; remove Uncosigned notes from 'complete' view:
"RTN","VPRDTIU",262,0)
 I STATUS=5,$P(DOC,U,7)="uncosigned" G MQ
"RTN","VPRDTIU",263,0)
 ; Check title & attributes for a match ...
"RTN","VPRDTIU",264,0)
 S LOCAL=$$GET1^DIQ(8925,DA_",",.01,"I") ;local Title 8925.1 ien
"RTN","VPRDTIU",265,0)
 I $L(SUBCLASS) D  G:'OK MQ
"RTN","VPRDTIU",266,0)
 . N I,X S OK=0
"RTN","VPRDTIU",267,0)
 . F I=1:1:$L(SUBCLASS,"^") S X=$P(SUBCLASS,U,I) I $$ISA^TIULX(LOCAL,X) S OK=1 Q
"RTN","VPRDTIU",268,0)
 S NATL=+$$GET1^DIQ(8925.1,LOCAL_",",1501,"I") ;Natl Title 8926.1 ien
"RTN","VPRDTIU",269,0)
 I $L(TITLE) G:TITLE'[(U_+NATL_U) MQ
"RTN","VPRDTIU",270,0)
 S X0=$G(^TIU(8926.1,NATL,0))
"RTN","VPRDTIU",271,0)
 I $L(SERVICE) G:SERVICE'[(U_+$P(X0,U,7)_U) MQ
"RTN","VPRDTIU",272,0)
 I $L(SUBJECT) G:SUBJECT'[(U_+$P(X0,U,4)_U) MQ
"RTN","VPRDTIU",273,0)
 I $L(NOTSUBJ) G:NOTSUBJ[(U_+$P(X0,U,4)_U) MQ
"RTN","VPRDTIU",274,0)
 S Y=1
"RTN","VPRDTIU",275,0)
MQ Q Y
"RTN","VPRDTST")
0^10^B32685783^B11854461
"RTN","VPRDTST",1,0)
VPRDTST ;SLC/MKB -- Test VistA data XML RPC ;10/18/12 6:26pm
"RTN","VPRDTST",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**4,5**;Sep 01, 2011;Build 21
"RTN","VPRDTST",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDTST",4,0)
 ;
"RTN","VPRDTST",5,0)
 ; External References          DBIA#
"RTN","VPRDTST",6,0)
 ; -------------------          -----
"RTN","VPRDTST",7,0)
 ; DIC                           2051
"RTN","VPRDTST",8,0)
 ; DIR                          10026
"RTN","VPRDTST",9,0)
 ;
"RTN","VPRDTST",10,0)
EN ; -- test GET^VPRD, write results to screen
"RTN","VPRDTST",11,0)
 N DFN,TYPE,TEXT,START,STOP,MAX,ID,IN,OUT,IDX
"RTN","VPRDTST",12,0)
 F  S DFN=$$PATIENT Q:DFN<1  D
"RTN","VPRDTST",13,0)
 . F  S TYPE=$$DOMAIN Q:"^"[TYPE  D
"RTN","VPRDTST",14,0)
 .. D RPC W !!
"RTN","VPRDTST",15,0)
 .. K TEXT,START,STOP,MAX,IN,ID
"RTN","VPRDTST",16,0)
 Q
"RTN","VPRDTST",17,0)
 ;
"RTN","VPRDTST",18,0)
RPC ; -- get search parameters, run and display
"RTN","VPRDTST",19,0)
 I $$DOC(TYPE) S TEXT=$$SHOW Q:TEXT="^"
"RTN","VPRDTST",20,0)
 N DONE S DONE=0
"RTN","VPRDTST",21,0)
 I TYPE'="patient",TYPE'="flag",TYPE'="reminder" D  Q:DONE
"RTN","VPRDTST",22,0)
 . S START=$S(TYPE'["insurance":$$START,1:"") I START="^" S DONE=1 Q
"RTN","VPRDTST",23,0)
 . I START S STOP=$$STOP(START) I STOP="^" S DONE=1 Q
"RTN","VPRDTST",24,0)
 . S MAX=$$TOTAL I MAX="^" S DONE=1 Q
"RTN","VPRDTST",25,0)
 . I $$FILTERS(.IN)="^" S DONE=1 Q
"RTN","VPRDTST",26,0)
 . I START="",MAX="",'$D(IN) S ID=$$ITEM S:ID="^" DONE=1
"RTN","VPRDTST",27,0)
 ;
"RTN","VPRDTST",28,0)
 Q:DONE
"RTN","VPRDTST",29,0)
 S:$L($G(TEXT)) IN("text")=TEXT
"RTN","VPRDTST",30,0)
 D GET^VPRD(.OUT,+$G(DFN),$G(TYPE),$G(START),$G(STOP),$G(MAX),$G(ID),.IN)
"RTN","VPRDTST",31,0)
 ;
"RTN","VPRDTST",32,0)
 S IDX=OUT W !
"RTN","VPRDTST",33,0)
 F  S IDX=$Q(@IDX) Q:IDX'?1"^TMP(""VPR"","1.N.E  Q:+$P(IDX,",",2)'=$J  W !,@IDX
"RTN","VPRDTST",34,0)
 Q
"RTN","VPRDTST",35,0)
 ;
"RTN","VPRDTST",36,0)
PATIENT() ; -- select patient
"RTN","VPRDTST",37,0)
 N X,Y,DIC
"RTN","VPRDTST",38,0)
 S DIC=2,DIC(0)="AEQM" D ^DIC
"RTN","VPRDTST",39,0)
 Q Y
"RTN","VPRDTST",40,0)
 ;
"RTN","VPRDTST",41,0)
DOMAIN() ; -- select domain
"RTN","VPRDTST",42,0)
 N X,Y,I,DIR,VPR
"RTN","VPRDTST",43,0)
 S DIR(0)="SAO^",DIR("A")="Select DOMAIN: " D DIRL
"RTN","VPRDTST",44,0)
 F I=1:1 S X=$P($T(TYPE+I),";",3) Q:X=99  S DIR(0)=DIR(0)_$P(X,":",1,2)_";",VPR(+X)=$P(X,":",3)
"RTN","VPRDTST",45,0)
 S DIR("?")="Select the type of clinical data to extract from VistA for this patient"
"RTN","VPRDTST",46,0)
 D ^DIR S:Y Y=VPR(Y)
"RTN","VPRDTST",47,0)
 Q Y
"RTN","VPRDTST",48,0)
 ;
"RTN","VPRDTST",49,0)
TYPE ;;CODE:NAME:TAG
"RTN","VPRDTST",50,0)
 ;;1:ALLERGIES/REACTIONS:allergy
"RTN","VPRDTST",51,0)
 ;;2:APPOINTMENTS:appointment
"RTN","VPRDTST",52,0)
 ;;3:CLINICAL PROCEDURES:clinicalProcedure
"RTN","VPRDTST",53,0)
 ;;4:CONSULTS:consult
"RTN","VPRDTST",54,0)
 ;;5:DEMOGRAPHICS:patient
"RTN","VPRDTST",55,0)
 ;;6:DOCUMENTS:document
"RTN","VPRDTST",56,0)
 ;;7:EXAMS:exam
"RTN","VPRDTST",57,0)
 ;;8:FUNCTIONAL MEASUREMENTS:fim
"RTN","VPRDTST",58,0)
 ;;9:HEALTH FACTORS:factor
"RTN","VPRDTST",59,0)
 ;;10:IMMUNIZATIONS:immunization
"RTN","VPRDTST",60,0)
 ;;11:INSURANCE:insurancePolicy
"RTN","VPRDTST",61,0)
 ;;12:LAB RESULTS:lab
"RTN","VPRDTST",62,0)
 ;;13:LABS BY ACCESSION:accession
"RTN","VPRDTST",63,0)
 ;;14:LABS BY ORDER:panel
"RTN","VPRDTST",64,0)
 ;;15:MEDS (by EXP DT):med
"RTN","VPRDTST",65,0)
 ;;16:MEDS (by REL DT):pharmacy
"RTN","VPRDTST",66,0)
 ;;17:OBSERVATIONS (CLiO):observation
"RTN","VPRDTST",67,0)
 ;;18:ORDERS:order
"RTN","VPRDTST",68,0)
 ;;19:PATIENT EDUCATION:educationTopic
"RTN","VPRDTST",69,0)
 ;;20:PATIENT RECORD FLAGS:flag
"RTN","VPRDTST",70,0)
 ;;21:PROBLEMS:problem
"RTN","VPRDTST",71,0)
 ;;22:PROCEDURES (ALL):procedure
"RTN","VPRDTST",72,0)
 ;;23:RADIOLOGY EXAMS:radiology
"RTN","VPRDTST",73,0)
 ;;24:SKIN TESTS:skinTest
"RTN","VPRDTST",74,0)
 ;;25:SURGERIES:surgery
"RTN","VPRDTST",75,0)
 ;;26:VISITS:visit
"RTN","VPRDTST",76,0)
 ;;27:VITALS:vital
"RTN","VPRDTST",77,0)
 ;;28:WELLNESS REMINDERS:reminder
"RTN","VPRDTST",78,0)
 ;;99
"RTN","VPRDTST",79,0)
 ;
"RTN","VPRDTST",80,0)
DIRL ; -- set up DIR("L") array
"RTN","VPRDTST",81,0)
 S DIR("L",1)=" 1  ALLERGIES/REACTIONS           15  MEDS (by Expiration Date)"
"RTN","VPRDTST",82,0)
 S DIR("L",2)=" 2  APPOINTMENTS                  16  MEDS (by Release Date)"
"RTN","VPRDTST",83,0)
 S DIR("L",3)=" 3  CLINICAL PROCEDURES           17  OBSERVATIONS (CLiO)"
"RTN","VPRDTST",84,0)
 S DIR("L",4)=" 4  CONSULTS                      18  ORDERS"
"RTN","VPRDTST",85,0)
 S DIR("L",5)=" 5  DEMOGRAPHICS                  19  PATIENT EDUCATION"
"RTN","VPRDTST",86,0)
 S DIR("L",6)=" 6  DOCUMENTS                     20  PATIENT RECORD FLAGS"
"RTN","VPRDTST",87,0)
 S DIR("L",7)=" 7  EXAMS                         21  PROBLEMS"
"RTN","VPRDTST",88,0)
 S DIR("L",8)=" 8  FUNCTIONAL MEASUREMENTS       22  PROCEDURES (ALL)"
"RTN","VPRDTST",89,0)
 S DIR("L",9)=" 9  HEALTH FACTORS                23  RADIOLOGY EXAMS"
"RTN","VPRDTST",90,0)
 S DIR("L",10)="10  IMMUNIZATIONS                 24  SKIN TESTS"
"RTN","VPRDTST",91,0)
 S DIR("L",11)="11  INSURANCE                     25  SURGERIES"
"RTN","VPRDTST",92,0)
 S DIR("L",12)="12  LAB RESULTS                   26  VISITS"
"RTN","VPRDTST",93,0)
 S DIR("L",13)="13  LABS BY ACCESSION             27  VITALS"
"RTN","VPRDTST",94,0)
 S DIR("L")="14  LABS BY ORDER                 28  WELLNESS REMINDERS"
"RTN","VPRDTST",95,0)
 Q
"RTN","VPRDTST",96,0)
 ;
"RTN","VPRDTST",97,0)
DOC(X) ; -- Returns 1 or 0, if type X includes a document
"RTN","VPRDTST",98,0)
 N Y S Y=0
"RTN","VPRDTST",99,0)
 I X="document" S Y=1
"RTN","VPRDTST",100,0)
 I X="accession" S Y=1
"RTN","VPRDTST",101,0)
 I X="visit" S Y=1
"RTN","VPRDTST",102,0)
 I X="surgery" S Y=1
"RTN","VPRDTST",103,0)
 I X="radiology" S Y=1
"RTN","VPRDTST",104,0)
 I X="procedure" S Y=1
"RTN","VPRDTST",105,0)
 I X="clinicalProcedure" S Y=1
"RTN","VPRDTST",106,0)
 I X="consult" S Y=1
"RTN","VPRDTST",107,0)
 I X="fim" S Y=1
"RTN","VPRDTST",108,0)
 Q Y
"RTN","VPRDTST",109,0)
 ;
"RTN","VPRDTST",110,0)
SHOW() ; -- true/false to include body of note
"RTN","VPRDTST",111,0)
 N X,Y,DIR,DUOUT,DTOUT
"RTN","VPRDTST",112,0)
 S DIR(0)="YAO",DIR("A")="Include the text of each document? "
"RTN","VPRDTST",113,0)
 D ^DIR S:$D(DTOUT) Y="^"
"RTN","VPRDTST",114,0)
 Q Y
"RTN","VPRDTST",115,0)
 ;
"RTN","VPRDTST",116,0)
START() ; -- select a start date
"RTN","VPRDTST",117,0)
 N X,Y,DIR,DUOUT,DTOUT
"RTN","VPRDTST",118,0)
 S DIR(0)="DAO^::AEPT",DIR("A")="Select START DATE: "
"RTN","VPRDTST",119,0)
 S DIR("?")="Enter an optional date[.time] to begin searching for data"
"RTN","VPRDTST",120,0)
 D ^DIR S:$D(DTOUT) Y="^"
"RTN","VPRDTST",121,0)
 Q Y
"RTN","VPRDTST",122,0)
 ;
"RTN","VPRDTST",123,0)
STOP(START) ; -- select a stop date
"RTN","VPRDTST",124,0)
 N X,Y,DIR,DUOUT,DTOUT
"RTN","VPRDTST",125,0)
 S DIR(0)="DA^"_START_"::AEPT",DIR("A")="Select STOP DATE: "
"RTN","VPRDTST",126,0)
 S DIR("?")="Enter a date[.time] after the START to end searching for data"
"RTN","VPRDTST",127,0)
 D ^DIR S:$D(DTOUT) Y="^"
"RTN","VPRDTST",128,0)
 Q Y
"RTN","VPRDTST",129,0)
 ;
"RTN","VPRDTST",130,0)
TOTAL() ; -- select the max# to return
"RTN","VPRDTST",131,0)
 N X,Y,DIR,DUOUT,DTOUT
"RTN","VPRDTST",132,0)
 S DIR(0)="NAO^1:9999",DIR("A")="Select TOTAL #items: "
"RTN","VPRDTST",133,0)
 S DIR("?")="Enter an optional maximum number of items to return, up to 9999"
"RTN","VPRDTST",134,0)
 D ^DIR S:$D(DTOUT) Y="^"
"RTN","VPRDTST",135,0)
 Q Y
"RTN","VPRDTST",136,0)
 ;
"RTN","VPRDTST",137,0)
FILTERS(LIST) ; -- define additional filters for domain
"RTN","VPRDTST",138,0)
 I "^document^insurancePolicy^lab^accession^panel^med^pharmacy^order^problem^"'[(U_TYPE_U) S Y="" G FQ
"RTN","VPRDTST",139,0)
 N X,Y,DIR,DUOUT,DTOUT,NAME
"RTN","VPRDTST",140,0)
F1 S DIR(0)="FAO^1:20",DIR("A")="Select FILTER: "
"RTN","VPRDTST",141,0)
 S DIR("?")="Enter the name of an attribute, to filter this domain."
"RTN","VPRDTST",142,0)
 D ^DIR S:$D(DTOUT) Y="^" I "^^"[Y G FQ
"RTN","VPRDTST",143,0)
 S NAME=$$LOW^XLFSTR(Y),DIR("A")="        VALUE: " K X,Y
"RTN","VPRDTST",144,0)
 S DIR("?")="Enter the value of the attribute, to filter this domain."
"RTN","VPRDTST",145,0)
 D ^DIR S:$D(DTOUT) Y="^" I "^^"[Y G FQ
"RTN","VPRDTST",146,0)
 S LIST(NAME)=Y G F1
"RTN","VPRDTST",147,0)
FQ Q Y
"RTN","VPRDTST",148,0)
 ;
"RTN","VPRDTST",149,0)
ITEM() ; -- select an item ID to return
"RTN","VPRDTST",150,0)
 N X,Y,DIR,DUOUT,DTOUT
"RTN","VPRDTST",151,0)
 S DIR(0)="FAO^1:20",DIR("A")="ID: "
"RTN","VPRDTST",152,0)
 S DIR("?")="Enter the id of an item to return."
"RTN","VPRDTST",153,0)
 D ^DIR S:$D(DTOUT) Y="^"
"RTN","VPRDTST",154,0)
 Q Y
"RTN","VPRDVSIT")
0^16^B106014987^B100077212
"RTN","VPRDVSIT",1,0)
VPRDVSIT ;SLC/MKB -- Visit/Encounter extract ;8/2/11  15:29
"RTN","VPRDVSIT",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1,2,4,5**;Sep 01, 2011;Build 21
"RTN","VPRDVSIT",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDVSIT",4,0)
 ;
"RTN","VPRDVSIT",5,0)
 ; External References          DBIA#
"RTN","VPRDVSIT",6,0)
 ; -------------------          -----
"RTN","VPRDVSIT",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDVSIT",8,0)
 ; ^DIC(40.7                      557
"RTN","VPRDVSIT",9,0)
 ; ^DIC(42                      10039
"RTN","VPRDVSIT",10,0)
 ; ^DIC(45.7                     1154
"RTN","VPRDVSIT",11,0)
 ; ^DPT(                        10035
"RTN","VPRDVSIT",12,0)
 ; ^SC                          10040
"RTN","VPRDVSIT",13,0)
 ; ^VA(200                      10060
"RTN","VPRDVSIT",14,0)
 ; DGPTFAPI                      3157
"RTN","VPRDVSIT",15,0)
 ; DIC                           2051
"RTN","VPRDVSIT",16,0)
 ; DILFD                         2055
"RTN","VPRDVSIT",17,0)
 ; DIQ                           2056
"RTN","VPRDVSIT",18,0)
 ; ICDEX                         5747
"RTN","VPRDVSIT",19,0)
 ; ICPTCOD                       1995
"RTN","VPRDVSIT",20,0)
 ; PXAPI,^TMP("PXKENC",$J        1894
"RTN","VPRDVSIT",21,0)
 ; SDOE                          2546
"RTN","VPRDVSIT",22,0)
 ; VADPT                        10061
"RTN","VPRDVSIT",23,0)
 ; VADPT2                         325
"RTN","VPRDVSIT",24,0)
 ; XUAF4                         2171
"RTN","VPRDVSIT",25,0)
 ;
"RTN","VPRDVSIT",26,0)
 ; ------------ Get encounter(s) from VistA ------------
"RTN","VPRDVSIT",27,0)
 ;
"RTN","VPRDVSIT",28,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's visits and appointments
"RTN","VPRDVSIT",29,0)
 N VPRCNT,VPRITM,VPRDT,VPRLOC,VPRDA
"RTN","VPRDVSIT",30,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDVSIT",31,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDVSIT",32,0)
 ;
"RTN","VPRDVSIT",33,0)
 ; get one visit
"RTN","VPRDVSIT",34,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) G ENQ
"RTN","VPRDVSIT",35,0)
 ;
"RTN","VPRDVSIT",36,0)
 ; -- get all visits
"RTN","VPRDVSIT",37,0)
 I END,END'["." S END=END_".24" ;assume end of day
"RTN","VPRDVSIT",38,0)
 S VPRCNT=0
"RTN","VPRDVSIT",39,0)
 ;F  S IDX=$Q(@IDX,-1) Q:DFN'=$P(IDX,",",2)  Q:$P(IDX,",",3)<BEG  I $P(IDX,",",5)["P" D
"RTN","VPRDVSIT",40,0)
 S VPRDT=END F  S VPRDT=$O(^AUPNVSIT("AET",DFN,VPRDT),-1)  Q:VPRDT<BEG  D  Q:VPRCNT'<MAX
"RTN","VPRDVSIT",41,0)
 . S VPRLOC=0 F  S VPRLOC=$O(^AUPNVSIT("AET",DFN,VPRDT,VPRLOC)) Q:VPRLOC<1  D
"RTN","VPRDVSIT",42,0)
 .. S VPRDA=0 F  S VPRDA=$O(^AUPNVSIT("AET",DFN,VPRDT,VPRLOC,"P",VPRDA)) Q:VPRDA<1  D
"RTN","VPRDVSIT",43,0)
 ... K VPRITM D EN1(VPRDA,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDVSIT",44,0)
 ... D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDVSIT",45,0)
ENQ ; end
"RTN","VPRDVSIT",46,0)
 K ^TMP("VPRTEXT",$J)
"RTN","VPRDVSIT",47,0)
 Q
"RTN","VPRDVSIT",48,0)
 ;
"RTN","VPRDVSIT",49,0)
ENAA(DFN,BEG,END,MAX,ID) ; -- find patient's visits and appointments [AA]
"RTN","VPRDVSIT",50,0)
 N IDT,DA,VPRCNT,VPRITM
"RTN","VPRDVSIT",51,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDVSIT",52,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDVSIT",53,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) Q  ;one visit
"RTN","VPRDVSIT",54,0)
 D IDT S VPRCNT=0
"RTN","VPRDVSIT",55,0)
 S IDT=BEG F  S IDT=$O(^AUPNVSIT("AA",DFN,IDT)) Q:IDT<1!(IDT>END)  D  Q:VPRCNT'<MAX
"RTN","VPRDVSIT",56,0)
 . S DA=0 F  S DA=$O(^AUPNVSIT("AA",DFN,IDT,DA)) Q:DA<1  D
"RTN","VPRDVSIT",57,0)
 .. K VPRITM D EN1(DA,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDVSIT",58,0)
 .. D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDVSIT",59,0)
 Q
"RTN","VPRDVSIT",60,0)
IDT ; -- invert BEG and END dates for visit format:
"RTN","VPRDVSIT",61,0)
 ;  IDT=(9999999-$P(VDT,"."))_"."_$P(VDT,".",2)
"RTN","VPRDVSIT",62,0)
 N X S X=BEG
"RTN","VPRDVSIT",63,0)
 S BEG=(9999999-$P(END,"."))
"RTN","VPRDVSIT",64,0)
 S END=(9999999-$P(X,"."))_".2359"
"RTN","VPRDVSIT",65,0)
 Q
"RTN","VPRDVSIT",66,0)
 ;
"RTN","VPRDVSIT",67,0)
EN1(IEN,VST) ; -- return a visit in VST("attribute")=value
"RTN","VPRDVSIT",68,0)
 N X0,X15,X,DATE,FAC,LOC,CATG,INPT,DA
"RTN","VPRDVSIT",69,0)
 K VST,^TMP("VPRTEXT",$J)
"RTN","VPRDVSIT",70,0)
 S IEN=+$G(IEN) Q:IEN<1  ;invalid
"RTN","VPRDVSIT",71,0)
 D ENCEVENT^PXAPI(IEN)
"RTN","VPRDVSIT",72,0)
 S X0=$G(^TMP("PXKENC",$J,IEN,"VST",IEN,0)),X15=$G(^(150))
"RTN","VPRDVSIT",73,0)
 Q:$P(X15,U,3)'="P"  Q:$P(X0,U,7)="E"  ;want primary, not historical
"RTN","VPRDVSIT",74,0)
 I $P(X0,U,7)="H" D ADM(IEN,+X0,.VST) Q
"RTN","VPRDVSIT",75,0)
 S VST("id")=IEN,VST("dateTime")=+X0,DATE=+X0
"RTN","VPRDVSIT",76,0)
 S FAC=+$P(X0,U,6),CATG=$P(X0,U,7),LOC=+$P(X0,U,22)
"RTN","VPRDVSIT",77,0)
 S:FAC VST("facility")=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDVSIT",78,0)
 S:'FAC VST("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDVSIT",79,0)
 S VST("serviceCategory")=CATG_U_$$CATG(CATG)
"RTN","VPRDVSIT",80,0)
 S VST("visitString")=LOC_";"_DATE_";"_CATG
"RTN","VPRDVSIT",81,0)
 S INPT=$P(X15,U,2) S:INPT="" INPT=$S("H^I^R^D"[CATG:1,1:0)
"RTN","VPRDVSIT",82,0)
 S X=$$CPT(IEN) S:X VST("type")=$P($$CPT^ICPTCOD(X),U,2,3)
"RTN","VPRDVSIT",83,0)
 I 'X S VST("type")=U_$S('INPT&LOC:$P($G(^SC(LOC,0)),U)_" VISIT",1:$$CATG(CATG))
"RTN","VPRDVSIT",84,0)
 S VST("patientClass")=$S(INPT:"IMP",1:"AMB")
"RTN","VPRDVSIT",85,0)
 S:INPT VST("admission")=$$ADMVT(DATE) ;get related mvt# if inpt visit/data
"RTN","VPRDVSIT",86,0)
 S X=$P(X0,U,8) S:X VST("stopCode")=$$AMIS(X) I LOC D
"RTN","VPRDVSIT",87,0)
 . N L0 S L0=$G(^SC(LOC,0))
"RTN","VPRDVSIT",88,0)
 . I 'X S VST("stopCode")=$$AMIS($P(L0,U,7))
"RTN","VPRDVSIT",89,0)
 . S VST("location")=$P(L0,U),VST("service")=$$SERV($P(L0,U,20))
"RTN","VPRDVSIT",90,0)
 . S X=$P(L0,U,18) S:X VST("creditStopCode")=$$AMIS(X)
"RTN","VPRDVSIT",91,0)
 S VST("reason")=$$POV(IEN,DATE)
"RTN","VPRDVSIT",92,0)
 ; provider(s), including taxonomy/specialty info
"RTN","VPRDVSIT",93,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,IEN,"PRV",DA)) Q:DA<1  S X0=$G(^(DA,0)) D
"RTN","VPRDVSIT",94,0)
 . S VST("provider",DA)=+X0_U_$P($G(^VA(200,+X0,0)),U)_$S($P(X0,U,4)="P":"^P^1",1:"^S^")_U_$$PROVSPC^VPRD(+X0)
"RTN","VPRDVSIT",95,0)
 ; cpt(s)
"RTN","VPRDVSIT",96,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,IEN,"CPT",DA)) Q:DA<1  S X0=$G(^(DA,0)) D
"RTN","VPRDVSIT",97,0)
 . S VST("cpt",DA)=$P($$CPT^ICPTCOD(+X0),U,2,3)
"RTN","VPRDVSIT",98,0)
 ; icd(s)
"RTN","VPRDVSIT",99,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,IEN,"POV",DA)) Q:DA<1  S X0=$G(^(DA,0)) D
"RTN","VPRDVSIT",100,0)
 . S VST("icd",DA)=$$ICD(+X0,DATE)_U_$$EXTERNAL^DILFD(9000010.07,.04,,$P(X0,U,4))_U_$S($L($P(X0,U,12)):$P(X0,U,12),1:"U")
"RTN","VPRDVSIT",101,0)
 ; note(s)
"RTN","VPRDVSIT",102,0)
 D TIU(IEN)
"RTN","VPRDVSIT",103,0)
 K ^TMP("PXKENC",$J,IEN)
"RTN","VPRDVSIT",104,0)
 Q
"RTN","VPRDVSIT",105,0)
 ;
"RTN","VPRDVSIT",106,0)
TIU(VISIT) ; -- add notes to VST("document")
"RTN","VPRDVSIT",107,0)
 N X,Y,I,VPRX,LT,NT,DA,CNT,VPRY
"RTN","VPRDVSIT",108,0)
 D FIND^DIC(8925,,.01,"QX",+$G(VISIT),,"V",,,"VPRX")
"RTN","VPRDVSIT",109,0)
 S Y="",(I,CNT)=0
"RTN","VPRDVSIT",110,0)
 F  S I=$O(VPRX("DILIST",1,I)) Q:I<1  D
"RTN","VPRDVSIT",111,0)
 . S DA=$G(VPRX("DILIST",2,I))
"RTN","VPRDVSIT",112,0)
 . S Y=$$INFO^VPRDTIU(+DA) Q:Y<1  ;draft or retracted
"RTN","VPRDVSIT",113,0)
 . S CNT=CNT+1,VST("document",CNT)=Y
"RTN","VPRDVSIT",114,0)
 . S:$G(VPRTEXT) VST("document",CNT,"content")=$$TEXT^VPRDTIU(DA)
"RTN","VPRDVSIT",115,0)
 Q
"RTN","VPRDVSIT",116,0)
 ;
"RTN","VPRDVSIT",117,0)
POV(VISIT,VDT) ; -- return the primary Purpose of Visit as ICD^ProviderNarrative
"RTN","VPRDVSIT",118,0)
 N DA,Y,X,X0,ICD S Y=""
"RTN","VPRDVSIT",119,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,VISIT,"POV",DA)) Q:DA<1  S X0=$G(^(DA,0)) I $P(X0,U,12)="P" D  Q:$L(Y)
"RTN","VPRDVSIT",120,0)
 . S X=+$P(X0,U,4),ICD=$$ICD(+X0,$G(VDT))
"RTN","VPRDVSIT",121,0)
 . S Y=ICD_U_$$EXTERNAL^DILFD(9000010.07,.04,,X)
"RTN","VPRDVSIT",122,0)
 Q Y
"RTN","VPRDVSIT",123,0)
 ;
"RTN","VPRDVSIT",124,0)
ICD(IEN,DATE) ; -- return code^description^system for ICD code, or "^^" if error
"RTN","VPRDVSIT",125,0)
 N X0,VPRX,N,I,X,Y
"RTN","VPRDVSIT",126,0)
 S IEN=+$G(IEN),DATE=+$G(DATE,DT)
"RTN","VPRDVSIT",127,0)
 S Y=$$CODEC^ICDEX(80,IEN),X=$$VLTD^ICDEX(IEN,DATE)
"RTN","VPRDVSIT",128,0)
 I $L(X) S Y=Y_U_X
"RTN","VPRDVSIT",129,0)
 E  S Y=Y_U_$$VSTD^ICDEX(IEN,DATE)
"RTN","VPRDVSIT",130,0)
 S X=$$CSI^ICDEX(80,IEN),$P(Y,U,3)=$$SAB^ICDEX(X)
"RTN","VPRDVSIT",131,0)
 Q Y
"RTN","VPRDVSIT",132,0)
 ;
"RTN","VPRDVSIT",133,0)
CPT(VISIT) ; -- Return CPT code of encounter type
"RTN","VPRDVSIT",134,0)
 N DA,Y,X,X0 S Y=""
"RTN","VPRDVSIT",135,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,VISIT,"CPT",DA)) Q:DA<1  S X0=$G(^(DA,0)) D  Q:$L(Y)
"RTN","VPRDVSIT",136,0)
 . S X=$P(X0,U) I X?1"992"2N S Y=X Q
"RTN","VPRDVSIT",137,0)
 Q Y
"RTN","VPRDVSIT",138,0)
 ;
"RTN","VPRDVSIT",139,0)
AMIS(X) ; -- return the AMIS code^name of Credit Stop X
"RTN","VPRDVSIT",140,0)
 N Y,X0 S Y=""
"RTN","VPRDVSIT",141,0)
 S X0=$G(^DIC(40.7,+$G(X),0)) S:$L(X0) Y=$P(X0,U,2)_U_$P(X0,U)
"RTN","VPRDVSIT",142,0)
 Q Y
"RTN","VPRDVSIT",143,0)
 ;
"RTN","VPRDVSIT",144,0)
CATG(X) ; -- Return name of visit Service Category code X
"RTN","VPRDVSIT",145,0)
 N Y S Y=""
"RTN","VPRDVSIT",146,0)
 I X="A" S Y="AMBULATORY"
"RTN","VPRDVSIT",147,0)
 I X="H" S Y="HOSPITALIZATION"
"RTN","VPRDVSIT",148,0)
 I X="I" S Y="IN HOSPITAL"
"RTN","VPRDVSIT",149,0)
 I X="C" S Y="CHART REVIEW"
"RTN","VPRDVSIT",150,0)
 I X="T" S Y="TELECOMMUNICATIONS"
"RTN","VPRDVSIT",151,0)
 I X="N" S Y="NOT FOUND"
"RTN","VPRDVSIT",152,0)
 I X="S" S Y="DAY SURGERY"
"RTN","VPRDVSIT",153,0)
 I X="O" S Y="OBSERVATION"
"RTN","VPRDVSIT",154,0)
 I X="E" S Y="EVENT (HISTORICAL)"
"RTN","VPRDVSIT",155,0)
 I X="R" S Y="NURSING HOME"
"RTN","VPRDVSIT",156,0)
 I X="D" S Y="DAILY HOSPITALIZATION DATA"
"RTN","VPRDVSIT",157,0)
 I X="X" S Y="ANCILLARY PACKAGE DAILY DATA"
"RTN","VPRDVSIT",158,0)
 Q Y
"RTN","VPRDVSIT",159,0)
 ;
"RTN","VPRDVSIT",160,0)
SERV(FTS) ; -- Return #42.4 Service for a Facility Treating Specialty
"RTN","VPRDVSIT",161,0)
 N Y S Y="",FTS=+$G(FTS)
"RTN","VPRDVSIT",162,0)
 S Y=$$GET1^DIQ(45.7,FTS_",","1:3","E")
"RTN","VPRDVSIT",163,0)
 Q Y
"RTN","VPRDVSIT",164,0)
 ;
"RTN","VPRDVSIT",165,0)
ADMVT(VAINDT) ; -- return movement# for related admission
"RTN","VPRDVSIT",166,0)
 N VADMVT,VAERR
"RTN","VPRDVSIT",167,0)
 D ADM^VADPT2
"RTN","VPRDVSIT",168,0)
 Q VADMVT
"RTN","VPRDVSIT",169,0)
 ;
"RTN","VPRDVSIT",170,0)
ADM(IEN,DATE,ADM) ; -- return an admission in ADM("attribute")=value
"RTN","VPRDVSIT",171,0)
 N VAINDT,VADMVT,VAIP,VAIN,VAERR,HLOC,ICD,I K ADM
"RTN","VPRDVSIT",172,0)
 S IEN=+$G(IEN),DATE=+$G(DATE) Q:IEN<1  Q:DATE<1
"RTN","VPRDVSIT",173,0)
 S VAINDT=DATE D ADM^VADPT2 Q:VADMVT<1
"RTN","VPRDVSIT",174,0)
 I VADMVT=$G(^DPT(DFN,.105)) D INPT Q  ;current inpatient
"RTN","VPRDVSIT",175,0)
 S VAIP("E")=VADMVT D IN5^VADPT Q:'$G(VAIP(1))  ;deleted
"RTN","VPRDVSIT",176,0)
 S ADM("id")=IEN,ADM("patientClass")="IMP",ADM("admission")=$G(VAIP(13))
"RTN","VPRDVSIT",177,0)
 ; ADM("admitType")=$P($G(VAIP(4)),U,2)
"RTN","VPRDVSIT",178,0)
 S DATE=+$G(VAIP(13,1)),(ADM("dateTime"),ADM("arrivalDateTime"))=DATE,I=0
"RTN","VPRDVSIT",179,0)
 S X=$G(VAIP(7)) S:X I=I+1,ADM("provider",I)=X_"^P^1"_U_$$PROVSPC^VPRD(+X) ;primary
"RTN","VPRDVSIT",180,0)
 S X=$G(VAIP(18)) S:X I=I+1,ADM("provider",I)=X_"^A^"_U_$$PROVSPC^VPRD(+X) ;attending
"RTN","VPRDVSIT",181,0)
 S ADM("specialty")=$P($G(VAIP(8)),U,2)
"RTN","VPRDVSIT",182,0)
 S X=$$SERV(+$G(VAIP(8))),ADM("service")=X,ADM("ptf")=VAIP(12)
"RTN","VPRDVSIT",183,0)
 S ICD=$$POV(IEN,DATE) S:'ICD ICD=$$PTF(DFN,VAIP(12),DATE) ;PTF>ICD
"RTN","VPRDVSIT",184,0)
 S ADM("reason")=ICD_U_$G(VAIP(9)) ;ICD code^description^system^Dx text
"RTN","VPRDVSIT",185,0)
 S HLOC=+$G(^DIC(42,+$G(VAIP(5)),44))
"RTN","VPRDVSIT",186,0)
 S:HLOC ADM("location")=$P($G(^SC(HLOC,0)),U)
"RTN","VPRDVSIT",187,0)
 S ADM("facility")=$$FAC^VPRD(+HLOC),ADM("roomBed")=$P(VAIP(6),U,2)
"RTN","VPRDVSIT",188,0)
 S ADM("serviceCategory")="H^HOSPITALIZATION"
"RTN","VPRDVSIT",189,0)
 S X=$$CPT(IEN),ADM("type")=$S(X:$P($$CPT^ICPTCOD(X),U,2,3),1:U_$$CATG("H"))
"RTN","VPRDVSIT",190,0)
 I $G(VAIP(17)) D
"RTN","VPRDVSIT",191,0)
 . S ADM("departureDateTime")=+$G(VAIP(17,1))
"RTN","VPRDVSIT",192,0)
 . ; ADM("disposition")=$G(VAIP(17,3)) ;Discharge Mvt Type
"RTN","VPRDVSIT",193,0)
 S ADM("visitString")=HLOC_";"_DATE_";H"
"RTN","VPRDVSIT",194,0)
 D TIU(IEN) ;notes/summary
"RTN","VPRDVSIT",195,0)
 Q
"RTN","VPRDVSIT",196,0)
 ;
"RTN","VPRDVSIT",197,0)
INPT ; -- return current admission in ADM("attribute")=value [from ADM]
"RTN","VPRDVSIT",198,0)
 K VAINDT D INP^VADPT Q:$G(VAIN(1))<1
"RTN","VPRDVSIT",199,0)
 S ADM("id")=IEN,ADM("patientClass")="IMP",ADM("admission")=VAIN(1)
"RTN","VPRDVSIT",200,0)
 ; ADM("admitType")=$P($G(VAIN(8)),U,2)
"RTN","VPRDVSIT",201,0)
 S DATE=+$G(VAIN(7)),(ADM("dateTime"),ADM("arrivalDateTime"))=DATE,I=0
"RTN","VPRDVSIT",202,0)
 S X=$G(VAIN(2)) S:X I=I+1,ADM("provider",I)=X_"^P^1"_U_$$PROVSPC^VPRD(+X) ;primary
"RTN","VPRDVSIT",203,0)
 S X=$G(VAIN(11)) S:X I=I+1,ADM("provider",I)=X_"^A^"_U_$$PROVSPC^VPRD(+X) ;attending
"RTN","VPRDVSIT",204,0)
 S ADM("specialty")=$P($G(VAIN(3)),U,2)
"RTN","VPRDVSIT",205,0)
 S X=$$SERV(+$G(VAIN(3))),ADM("service")=X,ADM("ptf")=VAIN(10)
"RTN","VPRDVSIT",206,0)
 S ICD=$$POV(IEN,DATE) S:'ICD ICD=$$PTF(DFN,VAIN(10),DATE) ;PTF>ICD
"RTN","VPRDVSIT",207,0)
 S ADM("reason")=ICD_U_$G(VAIN(9)) ;ICD code^description^system^Dx text
"RTN","VPRDVSIT",208,0)
 S HLOC=+$G(^DIC(42,+$G(VAIN(4)),44))
"RTN","VPRDVSIT",209,0)
 S:HLOC ADM("location")=$P($G(^SC(HLOC,0)),U)
"RTN","VPRDVSIT",210,0)
 S ADM("facility")=$$FAC^VPRD(+HLOC),ADM("roomBed")=VAIN(5)
"RTN","VPRDVSIT",211,0)
 S ADM("serviceCategory")="H^HOSPITALIZATION"
"RTN","VPRDVSIT",212,0)
 S X=$$CPT(IEN),ADM("type")=$S(X:$P($$CPT^ICPTCOD(X),U,2,3),1:U_$$CATG("H"))
"RTN","VPRDVSIT",213,0)
 ; ADM("visitString")=HLOC_";"_DATE_";H"
"RTN","VPRDVSIT",214,0)
 D TIU(IEN) ;notes/summary
"RTN","VPRDVSIT",215,0)
 Q
"RTN","VPRDVSIT",216,0)
 ;
"RTN","VPRDVSIT",217,0)
PTF(DFN,PTF,DATE) ; -- return ICD code^description^system for a PTF record
"RTN","VPRDVSIT",218,0)
 N VPRPTF,X0,Y
"RTN","VPRDVSIT",219,0)
 D:$G(PTF) RPC^DGPTFAPI(.VPRPTF,+PTF) I $G(VPRPTF(0))<0 Q "^^"
"RTN","VPRDVSIT",220,0)
 S Y=$P($G(VPRPTF(1)),U,3),DATE=+$G(DATE,DT)
"RTN","VPRDVSIT",221,0)
 S X0=$$ICDDX^ICDEX(Y,DATE,,"E") I X0<0 Q "^^"
"RTN","VPRDVSIT",222,0)
 S Y=$P(X0,U,2)_U_$P(X0,U,4)          ;ICD Code^Dx name
"RTN","VPRDVSIT",223,0)
 S $P(Y,U,3)=$$SAB^ICDEX($P(X0,U,20)) ;coding system
"RTN","VPRDVSIT",224,0)
 Q Y
"RTN","VPRDVSIT",225,0)
 ;
"RTN","VPRDVSIT",226,0)
ENC(IEN,ENC) ; -- return an encounter in ENC("attribute")=value
"RTN","VPRDVSIT",227,0)
 N X0,DATE,HLOC,TYPE,STS,X,Y K ENC
"RTN","VPRDVSIT",228,0)
 S IEN=+$G(IEN) Q:IEN<1  ;invalid ien
"RTN","VPRDVSIT",229,0)
 S ENC("id")="E"_IEN,X0=$$GETOE^SDOE(IEN) ;^SCE(IEN,0) node
"RTN","VPRDVSIT",230,0)
 S DATE=+X0,ENC("dateTime")=DATE
"RTN","VPRDVSIT",231,0)
 S HLOC=+$P(X0,U,4) I HLOC D
"RTN","VPRDVSIT",232,0)
 . S HLOC=HLOC_U_$P($G(^SC(HLOC,0)),U)
"RTN","VPRDVSIT",233,0)
 . S ENC("location")=$P(HLOC,U,2)
"RTN","VPRDVSIT",234,0)
 . S X=$$GET1^DIQ(44,+HLOC_",",9.5,"I")
"RTN","VPRDVSIT",235,0)
 . I X S ENC("service")=$$SERV(X)
"RTN","VPRDVSIT",236,0)
 S ENC("facility")=$$FAC^VPRD(+HLOC)
"RTN","VPRDVSIT",237,0)
 S STS=$$EXTERNAL^DILFD(409.68,.12,,$P(X0,U,12))
"RTN","VPRDVSIT",238,0)
 S X=$S(STS?1"INP".E:"IMP",1:"AMB"),ENC("patientClass")=X,TYPE=$E(X)
"RTN","VPRDVSIT",239,0)
 S ENC("type")=U_$S(HLOC:$P(HLOC,U,2)_" VISIT",1:$$CATG(TYPE))
"RTN","VPRDVSIT",240,0)
 S ENC("serviceCategory")=TYPE_U_$$CATG(TYPE)
"RTN","VPRDVSIT",241,0)
 S ENC("visitString")=+HLOC_";"_DATE_";"_TYPE
"RTN","VPRDVSIT",242,0)
 Q
"RTN","VPRDVSIT",243,0)
 ;
"RTN","VPRDVSIT",244,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDVSIT",245,0)
 ;
"RTN","VPRDVSIT",246,0)
XML(VISIT) ; -- Return patient visit as XML
"RTN","VPRDVSIT",247,0)
 N ATT,X,Y,NAMES,I,J
"RTN","VPRDVSIT",248,0)
 D ADD("<visit>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDVSIT",249,0)
 S ATT="" F  S ATT=$O(VISIT(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDVSIT",250,0)
 . I $O(VISIT(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDVSIT",251,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDVSIT",252,0)
 .. S I=0 F  S I=$O(VISIT(ATT,I)) Q:I<1  D
"RTN","VPRDVSIT",253,0)
 ... S X=$G(VISIT(ATT,I)),NAMES=""
"RTN","VPRDVSIT",254,0)
 ... I ATT="document" S NAMES="id^localTitle^nationalTitle^vuid^Z"
"RTN","VPRDVSIT",255,0)
 ... I ATT="provider" S NAMES="code^name^role^primary^"_$$PROVTAGS^VPRD_"^Z"
"RTN","VPRDVSIT",256,0)
 ... I ATT="cpt" S NAMES="code^name^Z"
"RTN","VPRDVSIT",257,0)
 ... I ATT="icd" S NAMES="code^name^system^narrative^ranking^Z"
"RTN","VPRDVSIT",258,0)
 ... S Y="<"_ATT_" "_$$LOOP ;_"/>" D ADD(Y)
"RTN","VPRDVSIT",259,0)
 ... S X=$G(VISIT(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDVSIT",260,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDVSIT",261,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDVSIT",262,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDVSIT",263,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDVSIT",264,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDVSIT",265,0)
 . S X=$G(VISIT(ATT)),Y="" Q:'$L(X)
"RTN","VPRDVSIT",266,0)
 . S NAMES="code^name^"_$S(ATT="reason":"system^narrative^",1:"")_"Z"
"RTN","VPRDVSIT",267,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDVSIT",268,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDVSIT",269,0)
 D ADD("</visit>")
"RTN","VPRDVSIT",270,0)
 Q
"RTN","VPRDVSIT",271,0)
 ;
"RTN","VPRDVSIT",272,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDVSIT",273,0)
 N STR,P,TAG S STR=""
"RTN","VPRDVSIT",274,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDVSIT",275,0)
 Q STR
"RTN","VPRDVSIT",276,0)
 ;
"RTN","VPRDVSIT",277,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDVSIT",278,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDVSIT",279,0)
 S @VPR@(VPRI)=X
"RTN","VPRDVSIT",280,0)
 Q
"RTN","VPRP5I")
0^^B91053^n/a
"RTN","VPRP5I",1,0)
VPRP5I ;SLC/MKB -- VPR patch 5 post install ;8/14/13  11:22
"RTN","VPRP5I",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**5**;Sep 01, 2011;Build 21
"RTN","VPRP5I",3,0)
 ;
"RTN","VPRP5I",4,0)
 ; External References          DBIA#
"RTN","VPRP5I",5,0)
 ; -------------------          -----
"RTN","VPRP5I",6,0)
 ; XPAR                          2263
"RTN","VPRP5I",7,0)
 ;
"RTN","VPRP5I",8,0)
PRE ; -- pre init
"RTN","VPRP5I",9,0)
 Q
"RTN","VPRP5I",10,0)
 ;
"RTN","VPRP5I",11,0)
POST ; -- post init
"RTN","VPRP5I",12,0)
 D PUT^XPAR("PKG","VPR VERSION",1,"1.05")
"RTN","VPRP5I",13,0)
 Q
"VER")
8.0^22.0
"BLD",9185,6)
^4
**END**
**END**

