EMERGENCY Released PSB*3*97 SEQ #79
Extracted from mail message
**KIDS**:PSB*3.0*97^

**INSTALL NAME**
PSB*3.0*97
"BLD",9541,0)
PSB*3.0*97^BAR CODE MED ADMIN^0^3161230^y
"BLD",9541,1,0)
^^11^11^3161230^
"BLD",9541,1,1,0)
Patch PSB*3*97 will change the version number of the Bar Code 
"BLD",9541,1,2,0)
Medication Administration (BCMA) client application to version 97
"BLD",9541,1,3,0)
from version 83 to correct an issue discovered immediately after release
"BLD",9541,1,4,0)
of version 83.  
"BLD",9541,1,5,0)
 
"BLD",9541,1,6,0)
A hard error can occur in the BCMA client application with a new button
"BLD",9541,1,7,0)
provided that displays a Body Site Image for selecting body location of
"BLD",9541,1,8,0)
transdermal type medications.
"BLD",9541,1,9,0)
 
"BLD",9541,1,10,0)
Some reports that print Legends had some issues where the user name and
"BLD",9541,1,11,0)
initials were inaccurate for transdermal type medications.
"BLD",9541,4,0)
^9.64PA^^
"BLD",9541,6.3)
3
"BLD",9541,"ABPKG")
n
"BLD",9541,"KRN",0)
^9.67PA^9002226^21
"BLD",9541,"KRN",.4,0)
.4
"BLD",9541,"KRN",.401,0)
.401
"BLD",9541,"KRN",.402,0)
.402
"BLD",9541,"KRN",.403,0)
.403
"BLD",9541,"KRN",.5,0)
.5
"BLD",9541,"KRN",.84,0)
.84
"BLD",9541,"KRN",3.6,0)
3.6
"BLD",9541,"KRN",3.8,0)
3.8
"BLD",9541,"KRN",9.2,0)
9.2
"BLD",9541,"KRN",9.8,0)
9.8
"BLD",9541,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",9541,"KRN",9.8,"NM",1,0)
PSBRPC3^^0^B292055
"BLD",9541,"KRN",9.8,"NM",2,0)
PSBOMH1^^0^B93225080
"BLD",9541,"KRN",9.8,"NM",3,0)
PSBOMT^^0^B105395791
"BLD",9541,"KRN",9.8,"NM",4,0)
PSBUTL^^0^B245001483
"BLD",9541,"KRN",9.8,"NM","B","PSBOMH1",2)

"BLD",9541,"KRN",9.8,"NM","B","PSBOMT",3)

"BLD",9541,"KRN",9.8,"NM","B","PSBRPC3",1)

"BLD",9541,"KRN",9.8,"NM","B","PSBUTL",4)

"BLD",9541,"KRN",19,0)
19
"BLD",9541,"KRN",19.1,0)
19.1
"BLD",9541,"KRN",101,0)
101
"BLD",9541,"KRN",409.61,0)
409.61
"BLD",9541,"KRN",771,0)
771
"BLD",9541,"KRN",779.2,0)
779.2
"BLD",9541,"KRN",870,0)
870
"BLD",9541,"KRN",8989.51,0)
8989.51
"BLD",9541,"KRN",8989.52,0)
8989.52
"BLD",9541,"KRN",8994,0)
8994
"BLD",9541,"KRN",9002226,0)
9002226
"BLD",9541,"KRN","B",.4,.4)

"BLD",9541,"KRN","B",.401,.401)

"BLD",9541,"KRN","B",.402,.402)

"BLD",9541,"KRN","B",.403,.403)

"BLD",9541,"KRN","B",.5,.5)

"BLD",9541,"KRN","B",.84,.84)

"BLD",9541,"KRN","B",3.6,3.6)

"BLD",9541,"KRN","B",3.8,3.8)

"BLD",9541,"KRN","B",9.2,9.2)

"BLD",9541,"KRN","B",9.8,9.8)

"BLD",9541,"KRN","B",19,19)

"BLD",9541,"KRN","B",19.1,19.1)

"BLD",9541,"KRN","B",101,101)

"BLD",9541,"KRN","B",409.61,409.61)

"BLD",9541,"KRN","B",771,771)

"BLD",9541,"KRN","B",779.2,779.2)

"BLD",9541,"KRN","B",870,870)

"BLD",9541,"KRN","B",8989.51,8989.51)

"BLD",9541,"KRN","B",8989.52,8989.52)

"BLD",9541,"KRN","B",8994,8994)

"BLD",9541,"KRN","B",9002226,9002226)

"BLD",9541,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9541,"QUES",0)
^9.62^^
"BLD",9541,"REQB",0)
^9.611^1^1
"BLD",9541,"REQB",1,0)
PSB*3.0*83^2
"BLD",9541,"REQB","B","PSB*3.0*83",1)

"MBREQ")
0
"PKG",536,-1)
1^1
"PKG",536,0)
BAR CODE MED ADMIN^PSB^BAR CODE MEDICATION ADMINISTRATION
"PKG",536,20,0)
^9.402P^^0
"PKG",536,22,0)
^9.49I^1^1
"PKG",536,22,1,0)
3.0^3040224^3040318^11874
"PKG",536,22,1,"PAH",1,0)
97^3161230
"PKG",536,22,1,"PAH",1,1,0)
^^11^11^3161230
"PKG",536,22,1,"PAH",1,1,1,0)
Patch PSB*3*97 will change the version number of the Bar Code 
"PKG",536,22,1,"PAH",1,1,2,0)
Medication Administration (BCMA) client application to version 97
"PKG",536,22,1,"PAH",1,1,3,0)
from version 83 to correct an issue discovered immediately after release
"PKG",536,22,1,"PAH",1,1,4,0)
of version 83.  
"PKG",536,22,1,"PAH",1,1,5,0)
 
"PKG",536,22,1,"PAH",1,1,6,0)
A hard error can occur in the BCMA client application with a new button
"PKG",536,22,1,"PAH",1,1,7,0)
provided that displays a Body Site Image for selecting body location of
"PKG",536,22,1,"PAH",1,1,8,0)
transdermal type medications.
"PKG",536,22,1,"PAH",1,1,9,0)
 
"PKG",536,22,1,"PAH",1,1,10,0)
Some reports that print Legends had some issues where the user name and
"PKG",536,22,1,"PAH",1,1,11,0)
initials were inaccurate for transdermal type medications.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSBOMH1")
0^2^B93225080^B93853760
"RTN","PSBOMH1",1,0)
PSBOMH1 ;BIRMINGHAM/EFC-MAH ;03/06/16 3:06pm
"RTN","PSBOMH1",2,0)
 ;;3.0;BAR CODE MED ADMIN;**6,3,9,11,26,38,45,51,50,57,67,64,72,83,97**;Mar 2004;Build 3
"RTN","PSBOMH1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBOMH1",4,0)
 ;
"RTN","PSBOMH1",5,0)
 ; Reference/IA
"RTN","PSBOMH1",6,0)
 ; ^DILF/2054
"RTN","PSBOMH1",7,0)
 ; File 200/10060
"RTN","PSBOMH1",8,0)
 ;
"RTN","PSBOMH1",9,0)
 ;*83 - add Remove events per Give events when occurred.
"RTN","PSBOMH1",10,0)
 ;
"RTN","PSBOMH1",11,0)
EN ;
"RTN","PSBOMH1",12,0)
 ; Load administrations
"RTN","PSBOMH1",13,0)
 N PSBDT,X,Y,Z
"RTN","PSBOMH1",14,0)
 S (PSBORD,PSBIEN,PSBR1,PSBADIEN,PSBABR)="",PSBDT=PSBSTRT
"RTN","PSBOMH1",15,0)
 K PSBTSA
"RTN","PSBOMH1",16,0)
 F  S PSBDT=$O(^PSB(53.79,"AADT",DFN,PSBDT)) Q:'PSBDT!(PSBDT>PSBSTOP)  D
"RTN","PSBOMH1",17,0)
 .F  S PSBIEN=$O(^PSB(53.79,"AADT",DFN,PSBDT,PSBIEN)) Q:'PSBIEN  Q:'$D(^PSB(53.79,PSBIEN))  I $P(^PSB(53.79,PSBIEN,0),U,9)]"" D  ;Remove Lock as file is only read, PSB*3*64
"RTN","PSBOMH1",18,0)
 ..Q:'$P($G(^PSB(53.79,PSBIEN,0)),U,6)  ; Bad IEN -no evnt dt
"RTN","PSBOMH1",19,0)
 ..Q:$P(^PSB(53.79,PSBIEN,0),U,9)="N"  ;NGiven
"RTN","PSBOMH1",20,0)
 ..S PSBORD=$P($G(^PSB(53.79,PSBIEN,.1)),U,1)
"RTN","PSBOMH1",21,0)
 ..;PSB*3*45 Anyone on the audit log should be in the legend
"RTN","PSBOMH1",22,0)
 ..N TMPCT S TMPCT=0 F  S TMPCT=$O(^PSB(53.79,PSBIEN,.9,TMPCT)) Q:'TMPCT  D
"RTN","PSBOMH1",23,0)
 ...S PSBINIT=$$GET1^DIQ(53.799,TMPCT_","_PSBIEN,"USER:INITIAL"),PSBNAME=$$GET1^DIQ(53.799,TMPCT_","_PSBIEN_",","USER")
"RTN","PSBOMH1",24,0)
 ...S:PSBINIT="" PSBINIT=99
"RTN","PSBOMH1",25,0)
 ...S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",26,0)
 ..; Continuous
"RTN","PSBOMH1",27,0)
 ..D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)="C"
"RTN","PSBOMH1",28,0)
 ...S X=PSBDT D H^%DTC S PSBWEEK=PSBAR(%H) D CLEAN^PSBVT,PSJ1^PSBVT($P(^PSB(53.79,PSBIEN,0),U,1),$P(^PSB(53.79,PSBIEN,.1),U,1))
"RTN","PSBOMH1",29,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,6)'=PSBDT,'$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,PSBIVPSH) D  D CLEAN^PSBVT Q  ;chck IV audit
"RTN","PSBOMH1",30,0)
 ....S PSBSIEN=PSBIEN
"RTN","PSBOMH1",31,0)
 ....I $P(^PSB(53.79,PSBIEN,0),"^",10)]"" D BAGDTL^PSBRPC2(.PSBAUD,$P(^PSB(53.79,PSBIEN,0),U,10),$P(^PSB(53.79,PSBIEN,.1),U,1))
"RTN","PSBOMH1",32,0)
 ....S PSBIEN=PSBSIEN K PSBSIEN
"RTN","PSBOMH1",33,0)
 ....S X=0 F  S X=$O(PSBAUD(X)) Q:X=""  I $P(PSBAUD(X),U,3)="" K PSBAUD(X)
"RTN","PSBOMH1",34,0)
 ....S X=0 F  S X=$O(PSBAUD(X)) Q:X=""  Q:$P(PSBAUD(X),U,1)=PSBDT
"RTN","PSBOMH1",35,0)
 ....I X="" K PSBAUD Q
"RTN","PSBOMH1",36,0)
 ....I '$D(PSBAUD(X)) K PSBAUD Q
"RTN","PSBOMH1",37,0)
 ....S PSBS=$P(PSBAUD(X),U,3)
"RTN","PSBOMH1",38,0)
 ....I PSBS="GIVEN",$P($G(PSBAUD(X-1)),U,3)="NOT GIVEN" Q
"RTN","PSBOMH1",39,0)
 ....I PSBS="NOT GIVEN" Q
"RTN","PSBOMH1",40,0)
 ....S PSBS=$S(PSBS="INFUSING":"I",PSBS="GIVEN":"G",PSBS="COMPLETED":"C",PSBS="HELD":"H",PSBS="REFUSED":"R",PSBS="REMOVED":"RM",PSBS="STOPPED":"S",PSBS["MISSING":"M",1:"NOACTION")
"RTN","PSBOMH1",41,0)
 ....D PSBSTIV^PSBOMH2
"RTN","PSBOMH1",42,0)
 ....S X=PSBDT_U_$P(PSBAUD(X),U,2)_U_PSBS_U_PSBIEN
"RTN","PSBOMH1",43,0)
 ....S Y=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,""),-1)+1
"RTN","PSBOMH1",44,0)
 ....S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,Y)=X ;PSB*3*67
"RTN","PSBOMH1",45,0)
 ....S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,0)=Y
"RTN","PSBOMH1",46,0)
 ....D PSBOUT($P((X),"^",1),$P((X),"^",2))
"RTN","PSBOMH1",47,0)
 ....K PSBAUD
"RTN","PSBOMH1",48,0)
 ...S PSBINIT=$$GETINIT^PSBCSUTX(PSBIEN,"I") ;Get initials of who took action, PSB*3*72
"RTN","PSBOMH1",49,0)
 ...S PSBNAME=$$GETINIT^PSBCSUTX(PSBIEN,"N") ;Get name of who took action, PSB*3*72
"RTN","PSBOMH1",50,0)
 ...I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",51,0)
 ...;get instrc info - audt log
"RTN","PSBOMH1",52,0)
 ...I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",53,0)
 ....D INSTR^PSBOMH
"RTN","PSBOMH1",54,0)
 ....S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",55,0)
 ...I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",56,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,9)="G",PSBDT=$P(^PSB(53.79,PSBIEN,0),U,6)  D PSBCK1^PSBOMH2("A")
"RTN","PSBOMH1",57,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,9)'="G",PSBDT=$P(^PSB(53.79,PSBIEN,0),U,6)  D PSBCK1^PSBOMH2("B")
"RTN","PSBOMH1",58,0)
 ...I PSBDT'=$P(^PSB(53.79,PSBIEN,0),U,6),$P(^PSB(53.79,PSBIEN,0),U,9)="RM" D
"RTN","PSBOMH1",59,0)
 ....D DDAUD
"RTN","PSBOMH1",60,0)
 ....S I="" F  S I=$O(PSBTAR(I),-1) Q:I=""  I $P(PSBTAR(I),U,1)=PSBDT D
"RTN","PSBOMH1",61,0)
 .....S PSBS=$P(PSBTAR(I),U,3)
"RTN","PSBOMH1",62,0)
 .....I PSBS="GIVEN",$P($G(PSBTAR(I-1)),U,3)="NOT GIVEN" Q  ; canceled - not given
"RTN","PSBOMH1",63,0)
 .....I PSBS="NOT GIVEN" Q
"RTN","PSBOMH1",64,0)
 .....S PSBS=$S(PSBS="INFUSING":"I",PSBS="GIVEN":"G",PSBS="COMPLETED":"C",PSBS="HELD":"H",PSBS="REFUSED":"R",PSBS="REMOVED":"RM",PSBS="STOPPED":"S",PSBS["MISSING":"M",1:"NO ACTION")
"RTN","PSBOMH1",65,0)
 .....D PSBCTAR^PSBOMH2
"RTN","PSBOMH1",66,0)
 .....S X=$P(PSBTAR(I),U,1,2)_U_PSBS_U_PSBIEN
"RTN","PSBOMH1",67,0)
 ...Q:'+X  ;Quit if invalid data is returned, PSB*3*67
"RTN","PSBOMH1",68,0)
 ...;
"RTN","PSBOMH1",69,0)
 ...;Remove event, insert Give 1st, then re-add Remove event       *83
"RTN","PSBOMH1",70,0)
 ...I $P(X,U,3)="RM" D
"RTN","PSBOMH1",71,0)
 ....S Z=X                               ;save remove event
"RTN","PSBOMH1",72,0)
 ....S X=$$FINDGIVE^PSBUTL($P(Z,U,4))     ;find Give and add to grid
"RTN","PSBOMH1",73,0)
 ....S Y=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,$P(X,".",1)\1,""),-1)+1
"RTN","PSBOMH1",74,0)
 ....S ^TMP("PSB",$J,PSBWEEK,PSBORD,$P(X,U)\1,Y)=X
"RTN","PSBOMH1",75,0)
 ....S ^TMP("PSB",$J,PSBWEEK,PSBORD,$P(X,U)\1,0)=Y
"RTN","PSBOMH1",76,0)
 ....S X=Z                               ;restore remove event to grid
"RTN","PSBOMH1",77,0)
 ...;
"RTN","PSBOMH1",78,0)
 ...S Y=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,""),-1)+1
"RTN","PSBOMH1",79,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,Y)=X ;PSB*3*67
"RTN","PSBOMH1",80,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,0)=Y
"RTN","PSBOMH1",81,0)
 ...D PSBOUT($P((X),"^",1),$P((X),"^",2))
"RTN","PSBOMH1",82,0)
 ...Q
"RTN","PSBOMH1",83,0)
 ..;
"RTN","PSBOMH1",84,0)
 ..; 1-Time On Call or PRN
"RTN","PSBOMH1",85,0)
 ..D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)'="C"
"RTN","PSBOMH1",86,0)
 ...I PSBDT'=$$GET1^DIQ(53.79,PSBIEN_",",.06,"I") Q
"RTN","PSBOMH1",87,0)
 ...S PSBINIT=$$GETINIT^PSBCSUTX(PSBIEN,"I") ;Get initials of who took action, PSB*3*72
"RTN","PSBOMH1",88,0)
 ...S PSBNAME=$$GETINIT^PSBCSUTX(PSBIEN,"N") ;Get name of who took action, PSB*3*72
"RTN","PSBOMH1",89,0)
 ...I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",90,0)
 ...S (PSBXA,PSBM)=1,(PSBZ,PSBT,PSBFLG)=""
"RTN","PSBOMH1",91,0)
 ...I $$GET1^DIQ(53.79,PSBIEN_",",.09)="REMOVED"  D
"RTN","PSBOMH1",92,0)
 ....F I=1:1 S PSBXA=$O(^PSB(53.79,PSBIEN,.9,PSBXA)) Q:PSBXA=""  I PSBXA?1.3N  S PSBZ=PSBZ+1,PSBT(PSBZ)=^PSB(53.79,PSBIEN,.9,PSBXA,0)
"RTN","PSBOMH1",93,0)
 ....F S=1:1 Q:PSBM<1  S PSBM=PSBZ-S  I (PSBM>0) I (PSBT(PSBM)["GIVEN")  S PSBFLG="1" S PRELINE1=$P(PSBT(PSBM),"'",2)_" "_$$GET1^DIQ(53.79,PSBIEN_",",.04)_" "_$E($P(PSBT(PSBM),"'",4),1,3) Q
"RTN","PSBOMH1",94,0)
 ...I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",95,0)
 ....D INSTR^PSBOMH
"RTN","PSBOMH1",96,0)
 ....S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",97,0)
 ...I '$D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,".")))  D PSBOUT(PSBDT,PSBINIT)
"RTN","PSBOMH1",98,0)
 ...S PSBLINE1=$$GET1^DIQ(53.79,PSBIEN_",",.09)_" "_$$GET1^DIQ(53.79,PSBIEN_",",.06)_" "_PSBINIT_"            "_$$GET1^DIQ(53.79,PSBIEN_",",.21),PSBLINE2=""
"RTN","PSBOMH1",99,0)
 ...I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",100,0)
 ...D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)="P"
"RTN","PSBOMH1",101,0)
 ....I $P($G(^PSB(53.79,PSBIEN,.2)),U,2)="" S PSBLINE2="  Results: <No PRN Results On File>"
"RTN","PSBOMH1",102,0)
 ....E  D
"RTN","PSBOMH1",103,0)
 .....S PSBINIT=$$GET1^DIQ(53.79,PSBIEN_",","PRN EFFECTIVENESS ENTERED BY:INITIAL")
"RTN","PSBOMH1",104,0)
 .....S PSBNAME=$$GET1^DIQ(53.79,PSBIEN_",","PRN EFFECTIVENESS ENTERED BY:NAME")
"RTN","PSBOMH1",105,0)
 .....I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",106,0)
 .....I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",107,0)
 ......S PSBINIT=PSBINIT_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."),0),U,3)_"  "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",108,0)
 ......S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",109,0)
 .....I '$D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,".")))  D
"RTN","PSBOMH1",110,0)
 ......D:$D(^PSB(53.79,PSBIEN,.9,0))
"RTN","PSBOMH1",111,0)
 .......S (PSBXA2,PSBFG)=0,PSBEFFDT=$P(^PSB(53.79,PSBIEN,.2),U,4) F  S PSBXA2=$O(^PSB(53.79,PSBIEN,.9,PSBXA2)) Q:+PSBXA2'>0  D  Q:PSBFG=1
"RTN","PSBOMH1",112,0)
 ........D:($P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U)=PSBEFFDT)&($P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,3)["Instruct")&($P(^PSB(53.79,PSBIEN,.2),U,3)=$P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,2))
"RTN","PSBOMH1",113,0)
 .........S PSBINIT=PSBINIT_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,3)_"  "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",114,0)
 .........S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)="",PSBFG=1
"RTN","PSBOMH1",115,0)
 .....S PSBLINE2="  Results: "_$$GET1^DIQ(53.79,PSBIEN_",",.22)
"RTN","PSBOMH1",116,0)
 .....S PSBRTXTW="     Entered By "_PSBINIT_" on "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",117,0)
 .....N PSBEIECMT,PSBCMTCH S PSBEIECMT="",PSBCMTCH=0 F  S PSBCMTCH=$O(^PSB(53.79,PSBIEN,.3,PSBCMTCH)) Q:'PSBCMTCH  D
"RTN","PSBOMH1",118,0)
 ......I $P($G(^PSB(53.79,PSBIEN,.3,PSBCMTCH,0)),U)["**Pain Score of" S PSBEIECMT=" **This Pain Score may have been Entered in Error. See Vitals Package.**"
"RTN","PSBOMH1",119,0)
 .....S PSBLINE2=PSBLINE2_PSBEIECMT
"RTN","PSBOMH1",120,0)
 .....I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",121,0)
 ...S X=PSBDT D H^%DTC F PSBWEEK=PSBAR(%H):-7 Q:$D(^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",0))!('$D(PSBAR(PSBWEEK)))
"RTN","PSBOMH1",122,0)
 ...S X=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",""),-1)+1
"RTN","PSBOMH1",123,0)
 ...I PSBFLG="1" S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X)=PRELINE1
"RTN","PSBOMH1",124,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+1)=PSBLINE1
"RTN","PSBOMH1",125,0)
 ...I $G(PSBLINE2)]"" D
"RTN","PSBOMH1",126,0)
 ....I $L(PSBLINE2)<=90 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+2)=PSBLINE2 S:$$GET1^DIQ(53.79,PSBIEN_",",.24)'="" ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+3)="      "_PSBRTXTW
"RTN","PSBOMH1",127,0)
 ....I $L(PSBLINE2)>90 D
"RTN","PSBOMH1",128,0)
 .....S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+2)=$E(PSBLINE2,1,90)
"RTN","PSBOMH1",129,0)
 .....S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+3)="           "_$E(PSBLINE2,91,169)
"RTN","PSBOMH1",130,0)
 .....I $L(PSBLINE2)'>169 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+4)="     "_PSBRTXTW
"RTN","PSBOMH1",131,0)
 .....I $L(PSBLINE2)>169 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+4)="           "_$E(PSBLINE2,170,245),^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+5)="     "_PSBRTXTW
"RTN","PSBOMH1",132,0)
 D RELINE^PSBOMH3(PSBWEEK) ;Line up administrations with their admin times - PSB*3*67
"RTN","PSBOMH1",133,0)
 Q
"RTN","PSBOMH1",134,0)
 ;
"RTN","PSBOMH1",135,0)
DDAUD ;  audits for dispen drugs
"RTN","PSBOMH1",136,0)
 ;
"RTN","PSBOMH1",137,0)
 M PSBMLA=^PSB(53.79,PSBIEN)
"RTN","PSBOMH1",138,0)
 S PSBGA="" I $D(PSBMLA(.9,0)) D
"RTN","PSBOMH1",139,0)
 .F PSBX=1:1 Q:'$D(PSBMLA(.9,PSBX))  I ((PSBMLA(.9,PSBX,0)["ACTION STATUS")!(PSBMLA(.9,PSBX,0)["ADMINISTRATION STATUS")) D  Q
"RTN","PSBOMH1",140,0)
 ..I $D(PSBMLA(.9,PSBX-2,0)) D DT^DILF("ENPST",$P(PSBMLA(.9,PSBX-2,0),"'",2),.PSBDATE)
"RTN","PSBOMH1",141,0)
 ..I '$D(PSBMLA(.9,PSBX-2,0)) S PSBDATE=$P(^PSB(53.79,PSBIEN,0),U,6)
"RTN","PSBOMH1",142,0)
 ..S PSBTMP(10000000-PSBDATE,"B")=PSBDATE_U_$$INITIAL^PSBRPC2($P(PSBMLA(0),U,5))_U_$P(PSBMLA(.9,PSBX,0),"'",2)
"RTN","PSBOMH1",143,0)
 ..S PSBGA=1
"RTN","PSBOMH1",144,0)
 .F PSBX=1:1 Q:'$D(PSBMLA(.9,PSBX))  I ((PSBMLA(.9,PSBX,0)["ACTION STATUS")!(PSBMLA(.9,PSBX,0)["ADMINISTRATION STATUS")) D
"RTN","PSBOMH1",145,0)
 ..S PSBTMP(10000000-$P(PSBMLA(.9,PSBX,0),U,1),"B")=$P(PSBMLA(.9,PSBX,0),U,1)_U_$$INITIAL^PSBRPC2($P(PSBMLA(.9,PSBX,0),U,2))_U_$P($P(PSBMLA(.9,PSBX,0),U,3),"'",2)
"RTN","PSBOMH1",146,0)
 ..S PSBGA=1
"RTN","PSBOMH1",147,0)
 ;PSB*3*45 Remove Use of $Q(<>,-1)
"RTN","PSBOMH1",148,0)
 N PSBTMQ
"RTN","PSBOMH1",149,0)
 I PSBGA'=1 S PSBTMP(10000000-$P(PSBMLA(0),U,6),"A")=$P(PSBMLA(0),U,6)_U_$$INITIAL^PSBRPC2($P(PSBMLA(0),U,7))
"RTN","PSBOMH1",150,0)
 S PSBQRY="PSBTMP",PSBCNT=1 F  S PSBTMQ=PSBQRY,PSBQRY=$Q(@PSBQRY) Q:PSBQRY=""  D  ; does comment go with action
"RTN","PSBOMH1",151,0)
 .S PSBPQRY=$G(PSBTMQ)
"RTN","PSBOMH1",152,0)
 .I PSBPQRY="" S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1 Q  ; no prev action
"RTN","PSBOMH1",153,0)
 .I $QS(PSBPQRY,2)="C"  S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1 Q  ; prev line = comment
"RTN","PSBOMH1",154,0)
 .I $QS(PSBQRY,2)="C",$E($P(@PSBTMQ,U,1),1,12)=$E($P(@PSBQRY,U,1),1,12),$P(@PSBTMQ,U,2)=$P(@PSBQRY,U,2) D  Q
"RTN","PSBOMH1",155,0)
 ..S X=$P(@PSBQRY,U,4) S:X[":" X=$P(X,":",2) S $P(PSBTAR(PSBCNT-1),U,4)=X Q
"RTN","PSBOMH1",156,0)
 .S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1
"RTN","PSBOMH1",157,0)
 Q
"RTN","PSBOMH1",158,0)
 ;
"RTN","PSBOMH1",159,0)
PSBOUT(PSBTET,PSBOT1) ;
"RTN","PSBOMH1",160,0)
 I '$D(^PSB(53.79,PSBIEN,.9,0))  D PSBENT^PSBOMH2(PSBOT1)
"RTN","PSBOMH1",161,0)
 S PSBIDA="" I $P(^PSB(53.79,PSBIEN,0),U,6)=PSBTET S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,7),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",162,0)
 S PSBXA1=0
"RTN","PSBOMH1",163,0)
 F  S PSBXA1=$O(^PSB(53.79,PSBIEN,.9,PSBXA1)) Q:+PSBXA1'>0  I PSBXA1'=0  D  Q:$G(PSBOT1)["*"
"RTN","PSBOMH1",164,0)
 .I $L(PSBXA1)<4  D
"RTN","PSBOMH1",165,0)
 ..I $P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",1)=PSBTET  D
"RTN","PSBOMH1",166,0)
 ...S:$G(PSBIDA)="" PSBIDA=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",2),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",167,0)
 ...I (PSBIDA=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",2)),$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",3)["Instruct"  D
"RTN","PSBOMH1",168,0)
 ....S INSDD=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",1),Y=INSDD D DD^%DT S INSDD=Y
"RTN","PSBOMH1",169,0)
 ....S PSBOT1=PSBOT1_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),U,3)_" "_INSDD
"RTN","PSBOMH1",170,0)
 I $G(PSBIDA)="",$P(^PSB(53.79,PSBIEN,0),U,4)=PSBTET D
"RTN","PSBOMH1",171,0)
 .S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,5),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",172,0)
 I $G(PSBNAME)="" D
"RTN","PSBOMH1",173,0)
 . S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,5),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",174,0)
 S ^TMP("PSB",$J,"LEGEND",$S($G(PSBOT1)="":99,1:PSBOT1),PSBNAME)=""
"RTN","PSBOMH1",175,0)
 Q
"RTN","PSBOMH1",176,0)
 ;
"RTN","PSBOMT")
0^3^B105395791^B104162476
"RTN","PSBOMT",1,0)
PSBOMT ;BIRMINGHAM/TEJ-BCMA MEDICATION THERAPY REPORT ;03/06/16 3:06pm
"RTN","PSBOMT",2,0)
 ;;3.0;BAR CODE MED ADMIN;**32,50,70,72,83,97**;Mar 2004;Build 3
"RTN","PSBOMT",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBOMT",4,0)
 ;
"RTN","PSBOMT",5,0)
 ; Reference/IA
"RTN","PSBOMT",6,0)
 ; File 50.7/2880
"RTN","PSBOMT",7,0)
 ; File 52.6/436
"RTN","PSBOMT",8,0)
 ; File 52.7/437
"RTN","PSBOMT",9,0)
 ; File 200/10060
"RTN","PSBOMT",10,0)
 ; EN^PSJBCMA1/2829
"RTN","PSBOMT",11,0)
 ; IEN^PSN50P65/4543
"RTN","PSBOMT",12,0)
 ; DRGIEN^PSS50P7/4662
"RTN","PSBOMT",13,0)
 ; VAC^PSS50/4533
"RTN","PSBOMT",14,0)
 ; ^PSDRUG(/221 
"RTN","PSBOMT",15,0)
 ;
"RTN","PSBOMT",16,0)
 ;*70 - reset PSBCLINORD = 2 to signify combined orders report
"RTN","PSBOMT",17,0)
 ;*83 - Add MRR meds remove times to report.
"RTN","PSBOMT",18,0)
 ;
"RTN","PSBOMT",19,0)
EN ;
"RTN","PSBOMT",20,0)
 N PSBHDR,PSBORDS,PSBORD,PSBOIP
"RTN","PSBOMT",21,0)
 N TMP
"RTN","PSBOMT",22,0)
 K TMP("PSBOIS",$J),TMP("VA CLASS",$J),TMP("PSBADDS",$J),TMP("PSBSOLS",$J),PSBLGD,PSBOIL,PSBDDL,PSBSOLL,PSBADDL
"RTN","PSBOMT",23,0)
 S PSBCLSS=0,PSBCFLG=0
"RTN","PSBOMT",24,0)
 S PSBXDFN=$P(PSBRPT(.1),U,2)
"RTN","PSBOMT",25,0)
 S PSBSTRT=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,7),PSBSTOP=$P(PSBRPT(.1),U,8)+$P(PSBRPT(.1),U,9)
"RTN","PSBOMT",26,0)
 K PSBOCRIT F Y=1:1:4 I $P(PSBRPT(.2),U,Y) S PSBOCRIT=$G(PSBOCRIT,"")_$P("C^P^OC^O",U,Y)_"^"
"RTN","PSBOMT",27,0)
 D NOW^%DTC S (Y,PSBNOWX)=% D DD^%DT S PSBDTTM=$E(Y,1,18)
"RTN","PSBOMT",28,0)
 S:+PSBSTRT'>0 PSBSTRT=$$FMADD^XLFDT(X,-1)
"RTN","PSBOMT",29,0)
 S:+PSBSTOP'>0 PSBSTOP=$P(%,".")
"RTN","PSBOMT",30,0)
 I $D(PSBRPT(.2)) I $P(PSBRPT(.2),U,8) S PSBCFLG=1
"RTN","PSBOMT",31,0)
 I $D(PSBRPT(2)) F XD=$O(PSBRPT(2,0)):1:$O(PSBRPT(2,"B"),-1) S PSBRPT(2,XD,0)=$TR(PSBRPT(2,XD,0),"~",U) D:$P(PSBRPT(2,XD,0),U)="MT"
"RTN","PSBOMT",32,0)
 .I $P(PSBRPT(2,XD,0),U,2)="OIT" D  Q
"RTN","PSBOMT",33,0)
 ..S PSBSRCHL="ORDERABLE ITEM SEARCH LIST:",PSBOIL(+$P(PSBRPT(2,XD,0),U,3))=""
"RTN","PSBOMT",34,0)
 ..S PSB=$P(PSBRPT(2,XD,0),U,3) F X=1:1:$L(PSB,",") Q:$P(PSB,",",X)=""  S (TMP("PSBOIS",$J,$P(PSB,",",X)),PSBOIP("OIP",$P(PSB,",",X)))=""
"RTN","PSBOMT",35,0)
 .I $P(PSBRPT(2,XD,0),U,2)="ADD" D  Q
"RTN","PSBOMT",36,0)
 ..S PSBSRCHL="IV MEDICATION SEARCH LIST:"
"RTN","PSBOMT",37,0)
 ..I $D(^PSDRUG("A526",$P(PSBRPT(2,XD,0),U,3))) S X2=$O(^PSDRUG("A526",$P(PSBRPT(2,XD,0),U,3),"")) S PSBADDL(X2)="",TMP("PSBOIS",$J,$$OFROMA(X2))=""
"RTN","PSBOMT",38,0)
 .I $P(PSBRPT(2,XD,0),U,2)="SOL" D  Q
"RTN","PSBOMT",39,0)
 ..S PSBSRCHL="IV MEDICATION SEARCH LIST:"
"RTN","PSBOMT",40,0)
 ..I $D(^PSDRUG("A527",$P(PSBRPT(2,XD,0),U,3))) S X2=$O(^PSDRUG("A527",$P(PSBRPT(2,XD,0),U,3),"")) S PSBSOLL(X2)="",TMP("PSBOIS",$J,$$OFROMS(X2))=""
"RTN","PSBOMT",41,0)
 .I $P(PSBRPT(2,XD,0),U,2)="DD" D  K PSBDRGS Q
"RTN","PSBOMT",42,0)
 ..S PSBSRCHL="DISPENSED DRUG SEARCH LIST:",PSBDDL($P(PSBRPT(2,XD,0),U,3))=""
"RTN","PSBOMT",43,0)
 ..K PSBDRGS S PSBDRGS="" D OILST^PSBRPCMO(.PSBDRGS,$P(PSBRPT(2,XD,0),U,3),"UD")
"RTN","PSBOMT",44,0)
 ..F X2=PSBDRGS(0):1:$O(PSBDRGS(""),-1) I +PSBDRGS(1)'<0 S TMP("PSBOIS",$J,$P(PSBDRGS(X2),U,4))=""
"RTN","PSBOMT",45,0)
 .I $P(PSBRPT(2,XD,0),U,2)="VAC" D
"RTN","PSBOMT",46,0)
 ..S PSBSRCHL="VA DRUG CLASS SEARCH LIST:"
"RTN","PSBOMT",47,0)
 ..S PSBCLS=$P(PSBRPT(2,XD,0),U,3) D GETCLSS(PSBCLS) K PSBDDRG("VAC") M TMP("VA CLASS",$J,PSBCLS,"DDRG")=PSBDDRG K PSBDDRG
"RTN","PSBOMT",48,0)
 ..S PSBCLSS=1
"RTN","PSBOMT",49,0)
 M PSBOIP("OIP")=TMP("PSBOIS",$J)
"RTN","PSBOMT",50,0)
 D OUT(PSBXDFN,PSBSTRT,PSBSTOP)
"RTN","PSBOMT",51,0)
 Q
"RTN","PSBOMT",52,0)
OUT(PSBXDFN,PSBSTRT,PSBSTOP) ;
"RTN","PSBOMT",53,0)
 D:PSBCLSS GETOIS  ; POSSBLE CLASS ITEMS VIA AVAIL ORDERS
"RTN","PSBOMT",54,0)
 D GETADSO^PSBOMT1 ; ALL ADDS AND SOLS
"RTN","PSBOMT",55,0)
 D FINDIENS^PSBOMT1 ; FIND ALL MED LOG ENTRS
"RTN","PSBOMT",56,0)
 D PREOUT ;   WRIT TO GLOBL
"RTN","PSBOMT",57,0)
 D WRITEOT
"RTN","PSBOMT",58,0)
 D CLEANSUM^PSBOMT1
"RTN","PSBOMT",59,0)
 D CLEANALL^PSBOMT1
"RTN","PSBOMT",60,0)
 Q
"RTN","PSBOMT",61,0)
GETOIS ;
"RTN","PSBOMT",62,0)
 K ^TMP("PSJ",$J),PSBTMP
"RTN","PSBOMT",63,0)
 D EN^PSJBCMA(PSBXDFN,PSBSTRT)
"RTN","PSBOMT",64,0)
 Q:^TMP("PSJ",$J,1,0)<0
"RTN","PSBOMT",65,0)
 M PSBTMP=^TMP("PSJ",$J) K ^TMP("PSJ",$J)
"RTN","PSBOMT",66,0)
 S X=0 F  S X=$O(PSBTMP(X)) Q:+X=0  D
"RTN","PSBOMT",67,0)
 .Q:$G(PSBOCRIT,"")'[$P(PSBTMP(X,1),U,2)_"^"
"RTN","PSBOMT",68,0)
 .S PSBORDN=$P(PSBTMP(X,0),U,3) S PSBORDS(PSBORDN)=""
"RTN","PSBOMT",69,0)
 .I $D(PSBTMP(X,700)) D  Q
"RTN","PSBOMT",70,0)
 ..F XX=1:1:PSBTMP(X,700,0) D
"RTN","PSBOMT",71,0)
 ...S PSBCLS="" F  S PSBCLS=$O(TMP("VA CLASS",$J,PSBCLS)) Q:+PSBCLS=0  D
"RTN","PSBOMT",72,0)
 ....I '$D(TMP("VA CLASS",$J,PSBCLS,"DDRG",$P(PSBTMP(X,700,XX,0),U))) Q
"RTN","PSBOMT",73,0)
 ....S PSBORDS(PSBORDN,"DD",$P(PSBTMP(X,700,XX,0),U))=""
"RTN","PSBOMT",74,0)
 ....S PSBORDS(PSBORDN,"OIP",$P(PSBTMP(X,3),U))=""
"RTN","PSBOMT",75,0)
 ..M PSBOIP("OIP")=PSBORDS(PSBORDN,"OIP")
"RTN","PSBOMT",76,0)
 .I $D(PSBTMP(X,850)) M PSBORDS(PSBORDN,"ADD")=PSBTMP(X,850) D
"RTN","PSBOMT",77,0)
 ..F XX=1:1:PSBORDS(PSBORDN,"ADD",0) S PSBORDS(PSBORDN,"OIP",$$OFROMA($P(PSBORDS(PSBORDN,"ADD",XX,0),U)))=""
"RTN","PSBOMT",78,0)
 ..M PSBOIP("OIP")=PSBORDS(PSBORDN,"OIP")
"RTN","PSBOMT",79,0)
 .I $D(PSBTMP(X,950)) M PSBORDS(PSBORDN,"SOL")=PSBTMP(X,950) D
"RTN","PSBOMT",80,0)
 ..F XX=1:1:PSBORDS(PSBORDN,"SOL",0) S PSBORDS(PSBORDN,"OIP",$$OFROMS($P(PSBORDS(PSBORDN,"SOL",XX,0),U)))=""
"RTN","PSBOMT",81,0)
 ..M PSBOIP("OIP")=PSBORDS(PSBORDN,"OIP")
"RTN","PSBOMT",82,0)
 K PSBTMP
"RTN","PSBOMT",83,0)
 M TMP("PSBOIS",$J)=PSBOIP("OIP")
"RTN","PSBOMT",84,0)
 Q
"RTN","PSBOMT",85,0)
OFROMA(PSBADD) ;OITEM FROM AN ADDITIVE
"RTN","PSBOMT",86,0)
 S X1=$$GET1^DIQ(52.6,PSBADD_",",15,"I")
"RTN","PSBOMT",87,0)
 I PSBCLSS D
"RTN","PSBOMT",88,0)
 .S X2=$$GETDRN(X1)
"RTN","PSBOMT",89,0)
 .S PSBCLS="" K X3 F  Q:$D(X3)  S PSBCLS=$O(TMP("VA CLASS",$J,PSBCLS)) Q:+PSBCLS=0  D
"RTN","PSBOMT",90,0)
 ..I $D(TMP("VA CLASS",$J,PSBCLS,"DDRG",X2)) S X3=X1
"RTN","PSBOMT",91,0)
 .I '$D(X3) S X3=0
"RTN","PSBOMT",92,0)
 Q $G(X3,X1)
"RTN","PSBOMT",93,0)
OFROMS(PSBSOL) ;OITEM FROM A SOLUTION
"RTN","PSBOMT",94,0)
 S X1=$$GET1^DIQ(52.7,PSBSOL_",",9,"I")
"RTN","PSBOMT",95,0)
 I PSBCLSS D
"RTN","PSBOMT",96,0)
 .S X2=$$GETDRN(X1)
"RTN","PSBOMT",97,0)
 .S PSBCLS="" K X3 F  Q:$D(X3)  S PSBCLS=$O(TMP("VA CLASS",$J,PSBCLS)) Q:+PSBCLS=0  D
"RTN","PSBOMT",98,0)
 ..I $D(TMP("VA CLASS",$J,PSBCLS,"DDRG",X2)) S X3=X1
"RTN","PSBOMT",99,0)
 .I '$D(X3) S X3=0
"RTN","PSBOMT",100,0)
 Q $G(X3,X1)
"RTN","PSBOMT",101,0)
PREOUT ;
"RTN","PSBOMT",102,0)
 K PSBUNK S XDT="" F  S XDT=$O(TMP("PSBIENS",$J,XDT),-1) Q:XDT=""  S XIEN="",XIEN=$O(TMP("PSBIENS",$J,XDT,XIEN)) D
"RTN","PSBOMT",103,0)
 .Q:$$NONSTS(PSBXDFN,XIEN)
"RTN","PSBOMT",104,0)
 .S PSBIEN=XIEN
"RTN","PSBOMT",105,0)
 .S PSBIENS=PSBIEN_","
"RTN","PSBOMT",106,0)
 .D OUTPUT
"RTN","PSBOMT",107,0)
 Q
"RTN","PSBOMT",108,0)
OUTPUT ;
"RTN","PSBOMT",109,0)
 S PSBSPC=$J("",80)
"RTN","PSBOMT",110,0)
 S W=$E($$GET1^DIQ(53.79,PSBIENS,.02)_PSBSPC,1,20)_" "
"RTN","PSBOMT",111,0)
 S W=W_$S($P(^PSB(53.79,PSBIEN,0),U,9)="":"?? ",1:$E($P(^PSB(53.79,PSBIEN,0),U,9)_"  ",1,2)_" ")
"RTN","PSBOMT",112,0)
 S:$P(^PSB(53.79,PSBIEN,0),U,9)="" PSBUNK=1
"RTN","PSBOMT",113,0)
 S W=W_$E($P($G(^PSB(53.79,PSBIEN,.1)),U,2)_PSBSPC,1,2)_"  "
"RTN","PSBOMT",114,0)
 S W=W_$E($E($$GET1^DIQ(53.79,PSBIENS,.06),1,18)_PSBSPC,1,21)_" "
"RTN","PSBOMT",115,0)
 S W=W_$E($$GETINIT^PSBCSUTX(PSBIEN,"I")_PSBSPC,1,10)_" ",PSBLGD("INITIALS",$$GETINIT^PSBCSUTX(PSBIEN,"II"))="" ;Get IEN and initials of who took action, PSB*3*72
"RTN","PSBOMT",116,0)
 ;Inj or Derm site info *83
"RTN","PSBOMT",117,0)
 S W=W_$S($P($G(^PSB(53.79,PSBIEN,.1)),U,8)]"":$P(^(.1),U,8),1:$P(^(.1),U,6))
"RTN","PSBOMT",118,0)
 ;
"RTN","PSBOMT",119,0)
 D ADD(W)
"RTN","PSBOMT",120,0)
 S W=$J("",56)
"RTN","PSBOMT",121,0)
 ;
"RTN","PSBOMT",122,0)
 ;find Give associated with remove event *83
"RTN","PSBOMT",123,0)
 D:$P(^PSB(53.79,PSBIEN,0),U,9)="RM"
"RTN","PSBOMT",124,0)
 .N RMEV,INI
"RTN","PSBOMT",125,0)
 .S RMEV=$$FINDGIVE^PSBUTL(PSBIEN)
"RTN","PSBOMT",126,0)
 .S Y=$P(RMEV,U)+.0000001     ;give dt/tm
"RTN","PSBOMT",127,0)
 .S INI=$P(RMEV,U,2)          ;give by user ini
"RTN","PSBOMT",128,0)
 .S X=$P(RMEV,U,3)            ;give sts code
"RTN","PSBOMT",129,0)
 .S W=$E(PSBSPC,1,21)_$E(X_" ",1,2)_" "
"RTN","PSBOMT",130,0)
 .S W=W_$E($P($G(^PSB(53.79,PSBIEN,.1)),U,2)_PSBSPC,1,2)_"  "
"RTN","PSBOMT",131,0)
 .S W=W_$$UP^XLFSTR($E($$FMTE^XLFDT(Y),1,18))_"    "_$E(INI_PSBSPC,1,6)
"RTN","PSBOMT",132,0)
 .S PSBLGD("INITIALS",$P(RMEV,U,5))=""  ;give by user in  (Legend use)
"RTN","PSBOMT",133,0)
 ;
"RTN","PSBOMT",134,0)
 K PSBV
"RTN","PSBOMT",135,0)
 F PSBNODE=.5,.6,.7 D
"RTN","PSBOMT",136,0)
 .S PSBDD=$S(PSBNODE=.5:53.795,PSBNODE=.6:53.796,1:53.797)
"RTN","PSBOMT",137,0)
 .F PSBY=0:0 S PSBY=$O(^PSB(53.79,PSBIEN,PSBNODE,PSBY)) Q:'PSBY  D
"RTN","PSBOMT",138,0)
 ..I $$GET1^DIQ(53.79,PSBIENS,.11)["V" S PSBV=1
"RTN","PSBOMT",139,0)
 ..;add W possible remove string to wrapmeds  *83
"RTN","PSBOMT",140,0)
 ..D WRAPMEDS(W,$$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.01),$$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.03),$$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.02),$$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.04))
"RTN","PSBOMT",141,0)
 D PRNEFF
"RTN","PSBOMT",142,0)
 I PSBCFLG=1 D COMNTS
"RTN","PSBOMT",143,0)
 D ADD("")
"RTN","PSBOMT",144,0)
 Q
"RTN","PSBOMT",145,0)
PRNEFF ;Add PRN Effectiveness to Medication theropy Report  - PSB*3*50
"RTN","PSBOMT",146,0)
 N PSBPRN,PSBEIECMT,PSBLINE1,PSBLINE2
"RTN","PSBOMT",147,0)
 S PSBEIECMT=""
"RTN","PSBOMT",148,0)
 I $P($G(PSBRPT(.2)),U,8)=0,$D(^PSB(53.79,PSBIEN,.2)) S PSBEIECMT=$$PRNEFF^PSBO(PSBEIECMT,PSBIEN)
"RTN","PSBOMT",149,0)
 I $D(^PSB(53.79,PSBIEN,.2)) D
"RTN","PSBOMT",150,0)
 .D ADD("")
"RTN","PSBOMT",151,0)
 .D ADD($J("",35)_"PRN Effectiveness: "_$$MAKELINE^PSBOMT1("-",78))
"RTN","PSBOMT",152,0)
 .I $P(^PSB(53.79,PSBIEN,.2),U,2)'="" D
"RTN","PSBOMT",153,0)
 ..S PSBPRN=$P(^PSB(53.79,PSBIEN,.2),U,2)
"RTN","PSBOMT",154,0)
 .I $P(^PSB(53.79,PSBIEN,.2),U,2)="" S PSBPRN="<No PRN Effectiveness Entered>"
"RTN","PSBOMT",155,0)
 .S PSBLINE1=$E(PSBPRN_PSBEIECMT,1,75),PSBLINE2=$E(PSBPRN_PSBEIECMT,76,245) D WRAP(PSBLINE2,PSBLINE1,PSBIEN)
"RTN","PSBOMT",156,0)
 Q 
"RTN","PSBOMT",157,0)
COMNTS ;
"RTN","PSBOMT",158,0)
 N Z,CNT
"RTN","PSBOMT",159,0)
 S Z="",CNT=0
"RTN","PSBOMT",160,0)
 I $D(^PSB(53.79,PSBIEN,.3,0)) D
"RTN","PSBOMT",161,0)
 .D ADD("")
"RTN","PSBOMT",162,0)
 .D ADD($J("",45)_"Comments: "_$$MAKELINE^PSBOMT1("-",78))
"RTN","PSBOMT",163,0)
 .S XT="" F  S XT=$O(^PSB(53.79,PSBIEN,.3,XT)) Q:XT=""  I XT'=0  D
"RTN","PSBOMT",164,0)
 ..D:CNT=1 ADD("")
"RTN","PSBOMT",165,0)
 ..S Y=$P(^PSB(53.79,PSBIEN,.3,XT,0),"^",3) D DD^%DT S XBR=Y
"RTN","PSBOMT",166,0)
 ..S Z=XBR_"   "_$P(^VA(200,$P(^PSB(53.79,PSBIEN,.3,XT,0),"^",2),0),"^",2)
"RTN","PSBOMT",167,0)
 ..D WRAP($P(^PSB(53.79,PSBIEN,.3,XT,0),"^",1),Z,PSBIEN)
"RTN","PSBOMT",168,0)
 ..S CNT=1
"RTN","PSBOMT",169,0)
 ..S PSBLGD("INITIALS",$$GET1^DIQ(53.793,XT_","_PSBIEN_",",.02,"I"))="" ;Get name for legend for those who entered comments
"RTN","PSBOMT",170,0)
 .D ADD($J("",55)_$$MAKELINE^PSBOMT1("-",78))
"RTN","PSBOMT",171,0)
 Q
"RTN","PSBOMT",172,0)
WRAPMEDS(W,MED,UG,UO,UOA) ;insert parm W (possible RM string) to print on line 1 *83
"RTN","PSBOMT",173,0)
 ;THIS WILL CREATE UPTO 3 LINES
"RTN","PSBOMT",174,0)
 S MED=$E(MED_$J("",40),1,40)
"RTN","PSBOMT",175,0)
 N UGWRAP,ORWRAP
"RTN","PSBOMT",176,0)
 S (CNTX,UOA1,UOA16,UOA31)=""
"RTN","PSBOMT",177,0)
 I +$G(UG)?1"."1.N S UG=0_+UG
"RTN","PSBOMT",178,0)
 I +$G(UO)?1"."1.N S UO=0_+UO
"RTN","PSBOMT",179,0)
 I $G(PSBV,0) S UO="NA"
"RTN","PSBOMT",180,0)
 F CNT=1:15:45  D
"RTN","PSBOMT",181,0)
 .D PARSE^PSBOMT1(UOA,CNT)
"RTN","PSBOMT",182,0)
 .S UGWRAP=$E(UG,CNT,(CNT+7)),UOWRAP=$E(UO,CNT,(CNT+7))
"RTN","PSBOMT",183,0)
 .I CNT=1 D ADD(W_MED_" "_$$PAD^PSBOMT1(UOWRAP,8)_" "_$$PAD^PSBOMT1(UGWRAP,8)_"  "_$$PAD^PSBOMT1(UOA1,15))  ;*83
"RTN","PSBOMT",184,0)
 .I (CNT>1),($L(UGWRAP)>0!$L(@("UOA"_CNT))>0) D ADD($J("",94)_$$PAD^PSBOMT1(UOWRAP,8)_" "_$$PAD^PSBOMT1(UGWRAP,8)_"  "_$$PAD^PSBOMT1(@("UOA"_CNT),15))
"RTN","PSBOMT",185,0)
 Q
"RTN","PSBOMT",186,0)
HEADA ;
"RTN","PSBOMT",187,0)
 W !
"RTN","PSBOMT",188,0)
 W "Location",?21,"St Sch Administration Date",?50,"By",?61,"Body Site",?96,"Units",?104,"Units",?113,"Units of"  ;*83
"RTN","PSBOMT",189,0)
 W !,?56,"Medication & Dosage",?96,"Ordered",?104,"Given",?113,"Administration"
"RTN","PSBOMT",190,0)
 W !
"RTN","PSBOMT",191,0)
 W $$MAKELINE^PSBOMT1("-",132)
"RTN","PSBOMT",192,0)
 Q
"RTN","PSBOMT",193,0)
NONSTS(PSBX,PSBY) ;
"RTN","PSBOMT",194,0)
 D CLEAN^PSBVT,PSJ1^PSBVT(PSBX,$$GET1^DIQ(53.79,PSBY_",","ORDER REFERENCE NUMBER","I"))
"RTN","PSBOMT",195,0)
 Q PSBOCRIT'[PSBSCHT_"^"
"RTN","PSBOMT",196,0)
WRITEOT ;
"RTN","PSBOMT",197,0)
 D HDR^PSBOMT1
"RTN","PSBOMT",198,0)
 D MEDS
"RTN","PSBOMT",199,0)
 N PSBCLINORD S PSBCLINORD=2             ;2 = both order types   *70
"RTN","PSBOMT",200,0)
 D PT^PSBOHDR(PSBXDFN,.PSBHDR),HEADA
"RTN","PSBOMT",201,0)
 I '$D(TMP("PSBIENS",$J)) D ADD("<<<< NO HISTORY FOUND FOR THIS TIME FRAME >>>>")
"RTN","PSBOMT",202,0)
 S EX="" F  S EX=$O(^TMP("PSB",$J,EX)) Q:EX=""  D
"RTN","PSBOMT",203,0)
 .I $Y>(IOSL-5) D
"RTN","PSBOMT",204,0)
 ..W $$PTFTR^PSBOHDR()
"RTN","PSBOMT",205,0)
 ..D PT^PSBOHDR(PSBXDFN,.PSBHDR),HEADA
"RTN","PSBOMT",206,0)
 .W !,$G(^TMP("PSB",$J,EX))
"RTN","PSBOMT",207,0)
 D:$D(TMP("PSBIENS",$J)) LEGEND^PSBOMT1
"RTN","PSBOMT",208,0)
 D FTR^PSBOMT1
"RTN","PSBOMT",209,0)
 Q
"RTN","PSBOMT",210,0)
MEDS ;
"RTN","PSBOMT",211,0)
 N MED,XA,XB
"RTN","PSBOMT",212,0)
 S MED="",XB=$O(PSBHDR(""),-1)+1
"RTN","PSBOMT",213,0)
 S PSBHDR(XB)=PSBSRCHL
"RTN","PSBOMT",214,0)
 I PSBCLSS S XA=0 K PSBGOT F  S XA=$O(TMP("VA CLASS",$J,XA)) Q:+XA=0  D
"RTN","PSBOMT",215,0)
 .K ^TMP($J,"PSBLIST") D IEN^PSN50P65(XA,"??","PSBLIST")
"RTN","PSBOMT",216,0)
 .I ^TMP($J,"PSBLIST",0)>0 S MED=^TMP($J,"PSBLIST",XA,1) Q:$D(PSBGOT(MED))  K ^TMP($J,"PSBLIST")
"RTN","PSBOMT",217,0)
 .I $L(PSBHDR(XB)_" "_$G(MED," * NO DATA FOUND * "))+3>IOM D  Q
"RTN","PSBOMT",218,0)
 ..S XB=XB+1,PSBHDR(XB)="                         / "_MED S PSBGOT(MED)=""
"RTN","PSBOMT",219,0)
 .S PSBHDR(XB)=PSBHDR(XB)_$S(($L(PSBHDR(XB),":")=2)&($P(PSBHDR(XB),":",2)=""):" ",1:" / ")_MED,PSBGOT(MED)=""
"RTN","PSBOMT",220,0)
 I $D(PSBOIL) S XA="" K PSBGOT F  S XA=$O(PSBOIL(XA)) Q:XA=""  D
"RTN","PSBOMT",221,0)
 .S MED=$$GET1^DIQ(50.7,XA,.01) Q:$D(PSBGOT(MED))  S PSBGOT(MED)=""
"RTN","PSBOMT",222,0)
 .I $L(PSBHDR(XB)_" / "_MED)+3>IOM D  Q
"RTN","PSBOMT",223,0)
 ..S XB=XB+1,PSBHDR(XB)="                         / "_MED
"RTN","PSBOMT",224,0)
 .S PSBHDR(XB)=PSBHDR(XB)_$S(($L(PSBHDR(XB),":")=2)&($P(PSBHDR(XB),":",2)=""):" ",1:" / ")_MED
"RTN","PSBOMT",225,0)
 I $D(PSBADDL) S XA="" K PSBGOT F  S XA=$O(PSBADDL(XA)) Q:XA=""  D
"RTN","PSBOMT",226,0)
 .S MED=$$GET1^DIQ(52.6,XA,.01) Q:$D(PSBGOT(MED))  S PSBGOT(MED)=""
"RTN","PSBOMT",227,0)
 .I $L(PSBHDR(XB)_" / "_MED)+3>IOM D  Q
"RTN","PSBOMT",228,0)
 ..S XB=XB+1,PSBHDR(XB)="                         / "_MED
"RTN","PSBOMT",229,0)
 .S PSBHDR(XB)=PSBHDR(XB)_$S(($L(PSBHDR(XB),":")=2)&($P(PSBHDR(XB),":",2)=""):" ",1:" / ")_MED
"RTN","PSBOMT",230,0)
 I $D(PSBSOLL) S XA="" K PSBGOT F  S XA=$O(PSBSOLL(XA)) Q:XA=""  D
"RTN","PSBOMT",231,0)
 .S MED=$$GET1^DIQ(52.7,XA,.01) Q:$D(PSBGOT(MED))  S PSBGOT(MED)=""
"RTN","PSBOMT",232,0)
 .I $L(PSBHDR(XB)_" / "_MED)+3>IOM D  Q
"RTN","PSBOMT",233,0)
 ..S XB=XB+1,PSBHDR(XB)="                         / "_MED
"RTN","PSBOMT",234,0)
 .S PSBHDR(XB)=PSBHDR(XB)_$S(($L(PSBHDR(XB),":")=2)&($P(PSBHDR(XB),":",2)=""):" ",1:" / ")_MED
"RTN","PSBOMT",235,0)
 I $D(PSBDDL) S XA="" F  S XA=$O(PSBDDL(XA)) Q:XA=""  D
"RTN","PSBOMT",236,0)
 .S MED=$$GET1^DIQ(50,XA,.01)
"RTN","PSBOMT",237,0)
 .I $L(PSBHDR(XB)_" / "_MED)+3>IOM D  Q
"RTN","PSBOMT",238,0)
 ..S XB=XB+1,PSBHDR(XB)="                         / "_MED
"RTN","PSBOMT",239,0)
 .S PSBHDR(XB)=PSBHDR(XB)_$S(($L(PSBHDR(XB),":")=2)&($P(PSBHDR(XB),":",2)=""):" ",1:" / ")_MED
"RTN","PSBOMT",240,0)
 Q
"RTN","PSBOMT",241,0)
WRAP(SIZE,ZP,BRIEN) ;
"RTN","PSBOMT",242,0)
 D ADD($J("",56)_ZP)
"RTN","PSBOMT",243,0)
 D ADD($J("",56)_$E(SIZE,1,75))
"RTN","PSBOMT",244,0)
 I $L(SIZE)>75 D ADD($J("",56)_$E(SIZE,76,150))
"RTN","PSBOMT",245,0)
 Q
"RTN","PSBOMT",246,0)
ADD(XE) ;
"RTN","PSBOMT",247,0)
 S ^TMP("PSB",$J,$O(^TMP("PSB",$J,""),-1)+1)=XE
"RTN","PSBOMT",248,0)
 Q
"RTN","PSBOMT",249,0)
GETDRN(IEN1) ;
"RTN","PSBOMT",250,0)
 ; Get the Drug IEN (p50) via OI IEN (p50.7)
"RTN","PSBOMT",251,0)
 K ^TMP($J,"PSBLIST")
"RTN","PSBOMT",252,0)
 D DRGIEN^PSS50P7(IEN1,,"PSBLIST")
"RTN","PSBOMT",253,0)
 S DN=$O(^TMP($J,"PSBLIST",0))
"RTN","PSBOMT",254,0)
 K ^TMP($J,"PSBLIST")
"RTN","PSBOMT",255,0)
 Q DN
"RTN","PSBOMT",256,0)
GETCLSS(IEN1) ;
"RTN","PSBOMT",257,0)
 ; Get the Items w/i VA Class
"RTN","PSBOMT",258,0)
 K ^TMP($J,"PSBLIST")
"RTN","PSBOMT",259,0)
 D VAC^PSS50(IEN1,,,"PSBLIST")
"RTN","PSBOMT",260,0)
 M PSBDDRG=^TMP($J,"PSBLIST")
"RTN","PSBOMT",261,0)
 K ^TMP($J,"PSBLIST")
"RTN","PSBOMT",262,0)
 Q
"RTN","PSBRPC3")
0^1^B292055^B291911
"RTN","PSBRPC3",1,0)
PSBRPC3 ;BIRMINGHAM/VRN - BCMA RPC BROKER CALLS ;03/06/16 3:06pm
"RTN","PSBRPC3",2,0)
 ;;3.0;BAR CODE MED ADMIN;**6,3,4,16,13,10,32,28,42,58,68,70,83,97**;Mar 2004;Build 3
"RTN","PSBRPC3",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBRPC3",4,0)
 ;
"RTN","PSBRPC3",5,0)
GUICHK(RESULTS,DUMMY) ;
"RTN","PSBRPC3",6,0)
 ;
"RTN","PSBRPC3",7,0)
 ; RPC : PSB VERSION CHECK
"RTN","PSBRPC3",8,0)
 ;
"RTN","PSBRPC3",9,0)
 K RESULTS
"RTN","PSBRPC3",10,0)
 N PSBCURR,PSBPREV,PSBCNT
"RTN","PSBRPC3",11,0)
 S PSBCURR="3.0.97.*"
"RTN","PSBRPC3",12,0)
 S PSBPREV="",PSBCNT=0
"RTN","PSBRPC3",13,0)
 S PSBCNT=PSBCNT+1
"RTN","PSBRPC3",14,0)
 S RESULTS(PSBCNT)=PSBCURR_U_PSBPREV
"RTN","PSBRPC3",15,0)
 S RESULTS(0)=PSBCNT
"RTN","PSBRPC3",16,0)
 Q
"RTN","PSBRPC3",17,0)
 ;
"RTN","PSBUTL")
0^4^B245001483^B243063193
"RTN","PSBUTL",1,0)
PSBUTL ;BIRMINGHAM/EFC-BCMA UTILITIES ;03/06/16 3:06pm
"RTN","PSBUTL",2,0)
 ;;3.0;BAR CODE MED ADMIN;**3,9,13,38,45,46,63,83,97**;Mar 2004;Build 3
"RTN","PSBUTL",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBUTL",4,0)
 ;
"RTN","PSBUTL",5,0)
 ; Reference/IA
"RTN","PSBUTL",6,0)
 ; $$PATCH & $$VERSION^XPDUTL/10141
"RTN","PSBUTL",7,0)
 ; File 50/221
"RTN","PSBUTL",8,0)
 ; File 200/10060
"RTN","PSBUTL",9,0)
 ; EN^PSJBCMA1/2829
"RTN","PSBUTL",10,0)
 ;
"RTN","PSBUTL",11,0)
 ;*83 - Add tags called by DD trigger xrefs
"RTN","PSBUTL",12,0)
 ;    - Add FIXADM to add to coversheet Results the G give action.
"RTN","PSBUTL",13,0)
 ;
"RTN","PSBUTL",14,0)
DIWP(X,Y,PSB,PSBARGN) ; 
"RTN","PSBUTL",15,0)
 K ^UTILITY($J,"W")
"RTN","PSBUTL",16,0)
 S DIWL=0,DIWR=Y,DIWF="C"_Y D ^DIWP
"RTN","PSBUTL",17,0)
 F X=0:0 S X=$O(^UTILITY($J,"W",0,X)) Q:'X  D
"RTN","PSBUTL",18,0)
 .S Y=$O(@PSB@(""),-1)+1
"RTN","PSBUTL",19,0)
 .; Naked Ref ^UTILITY($J,"W",0,X)
"RTN","PSBUTL",20,0)
 .S @PSB@(Y)=$J("",+$G(PSBARGN))_^(X,0)
"RTN","PSBUTL",21,0)
 S @PSB@(0)=+$O(@PSB@(""),-1)
"RTN","PSBUTL",22,0)
 K ^UTILITY($J,"W"),DIWL,DIWR,DIWF
"RTN","PSBUTL",23,0)
 Q
"RTN","PSBUTL",24,0)
 ;
"RTN","PSBUTL",25,0)
SATURDAY(X,PSBDISP) ; 
"RTN","PSBUTL",26,0)
 S X=X\1 D H^%DTC ; Convert to $H
"RTN","PSBUTL",27,0)
 S %H=%H+(6-%Y) ;   Set it forward to Saturday
"RTN","PSBUTL",28,0)
 D YMD^%DTC ;       Back to FM Format
"RTN","PSBUTL",29,0)
 I $G(PSBDISP) S PSBDISP=$E(X,4,5)_"/"_$E(X,6,7)_"/"_(1700+$E(X,1,3)) D EN^DDIOL("Actual date is Saturday "_PSBDISP)
"RTN","PSBUTL",30,0)
 Q X
"RTN","PSBUTL",31,0)
 ;
"RTN","PSBUTL",32,0)
SUNDAY(X,PSBDISP) ; 
"RTN","PSBUTL",33,0)
 S X=X\1 D H^%DTC ; Convert to $H
"RTN","PSBUTL",34,0)
 S %H=%H-%Y ;       Set it back to Sunday
"RTN","PSBUTL",35,0)
 D YMD^%DTC ;       Back to FM Format
"RTN","PSBUTL",36,0)
 I $G(PSBDISP) S PSBDISP=$E(X,4,5)_"/"_$E(X,6,7)_"/"_(1700+$E(X,1,3)) D EN^DDIOL("Actual date is Sunday "_PSBDISP)
"RTN","PSBUTL",37,0)
 Q X
"RTN","PSBUTL",38,0)
 ;
"RTN","PSBUTL",39,0)
CLOCK(RESULTS,X) ; Verify Client/Server Date/Times are close enough
"RTN","PSBUTL",40,0)
 ;
"RTN","PSBUTL",41,0)
 ; RPC: PSB SERVER CLOCK VARIANCE
"RTN","PSBUTL",42,0)
 ;
"RTN","PSBUTL",43,0)
 ; Description:
"RTN","PSBUTL",44,0)
 ; Returns variance from server to client in minutes
"RTN","PSBUTL",45,0)
 ;
"RTN","PSBUTL",46,0)
 N PSBCLNT,PSBSRVR,PSBDIFF,PSBMDNT
"RTN","PSBUTL",47,0)
 S PSBMDNT=0
"RTN","PSBUTL",48,0)
 I $P(X,"@",2)="0000" S $P(X,"@",2)="2400",PSBMDNT=1 ;Change Delphi time for midnight from 0000 to 2400 in PSB*3.0*63
"RTN","PSBUTL",49,0)
 S %DT="RS" D ^%DT S PSBCLNT=Y
"RTN","PSBUTL",50,0)
 D NOW^%DTC S PSBSRVR=%
"RTN","PSBUTL",51,0)
 S:$G(PSBMDNT) PSBCLNT=$$FMADD^XLFDT(PSBCLNT,-1,0,0,0) ;Change Delphi date for midnight from day following midnight to day previous to midnight in PSB*3.0*63
"RTN","PSBUTL",52,0)
 S PSBDIFF=$$DIFF(PSBSRVR,PSBCLNT)
"RTN","PSBUTL",53,0)
 S X=$$GET^XPAR("DIV","PSB SERVER CLOCK VARIANCE")
"RTN","PSBUTL",54,0)
 I PSBDIFF>X!(PSBDIFF<(X*-1)) S RESULTS(0)="-1^"_PSBDIFF
"RTN","PSBUTL",55,0)
 E  S RESULTS(0)="1^"_PSBDIFF
"RTN","PSBUTL",56,0)
 Q
"RTN","PSBUTL",57,0)
 ;
"RTN","PSBUTL",58,0)
DIFF(X,X1) ; Difference in minutes between 2 FM dates
"RTN","PSBUTL",59,0)
 ; Code copied from Fileman Function MINUTES
"RTN","PSBUTL",60,0)
 S Y=$E(X1_"000",9,10)-$E(X_"000",9,10)*60+$E(X1_"00000",11,12)-$E(X_"00000",11,12),X2=X,X=$P(X,".",1)'=$P(X1,".",1) D ^%DTC:X S X=X*1440+Y
"RTN","PSBUTL",61,0)
 Q X
"RTN","PSBUTL",62,0)
 ;
"RTN","PSBUTL",63,0)
DRUGINQ ; Drug File Inquiry
"RTN","PSBUTL",64,0)
 N PSBRET,PSBIEN,DIC,DIR,IOINORM,IOINHI
"RTN","PSBUTL",65,0)
 S X="IOINHI;IOINORM" D ENDR^%ZISS
"RTN","PSBUTL",66,0)
 S X=$TR(X,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSBUTL",67,0)
 S DIC="^PSDRUG(",DIC(0)="AEQMVTN",DIC("T")="",D="B^C^VAPN^VAC^NDC^XATC",DIC("A")="Select DRUG: "
"RTN","PSBUTL",68,0)
 ; Display active drugs and those for appl packages IV and Unit Dose
"RTN","PSBUTL",69,0)
 S DIC("S")="I '$G(^PSDRUG(+Y,""I""))!($G(^(""I""))>DT),$P($G(^PSDRUG(+Y,2)),U,3)[""I""!($P($G(^PSDRUG(+Y,2)),U,3)[""U"")"
"RTN","PSBUTL",70,0)
 F  W @IOF,!,"DRUG FILE INQUIRY",! D ^DIC  Q:+Y<1  D
"RTN","PSBUTL",71,0)
 .K PSBRET
"RTN","PSBUTL",72,0)
 .S PSBIEN=+Y_","
"RTN","PSBUTL",73,0)
 .D GETS^DIQ(50,PSBIEN,".01;16;25;51;215;213;101;9*","","PSBRET")
"RTN","PSBUTL",74,0)
 .W @IOF,!,"DRUG NAME: ",IOINHI,PSBRET(50,PSBIEN,.01)
"RTN","PSBUTL",75,0)
 .W "  (IEN: ",+PSBIEN,")",IOINORM,!,$TR($J("",IOM)," ","-"),!
"RTN","PSBUTL",76,0)
 .F X=16,25,51,215,213,101 D
"RTN","PSBUTL",77,0)
 ..D FIELD^DID(50,X,"","LABEL","PSBRET")
"RTN","PSBUTL",78,0)
 ..W !,PSBRET("LABEL"),":",?30,IOINHI
"RTN","PSBUTL",79,0)
 ..D:$L(PSBRET(50,PSBIEN,X))>49
"RTN","PSBUTL",80,0)
 ...F Y=1:1 Q:$L($P(PSBRET(50,PSBIEN,X)," ",1,Y))>49
"RTN","PSBUTL",81,0)
 ...W $P(PSBRET(50,PSBIEN,X)," ",1,Y-1),!?30
"RTN","PSBUTL",82,0)
 ...S PSBRET(50,PSBIEN,X)=$P(PSBRET(50,PSBIEN,X)," ",Y,250)
"RTN","PSBUTL",83,0)
 ..W ?30,PSBRET(50,PSBIEN,X),IOINORM
"RTN","PSBUTL",84,0)
 .W !!,"SYNONYMS:",IOINHI,!?15
"RTN","PSBUTL",85,0)
 .S X="" F  S X=$O(PSBRET(50.1,X)) Q:X=""  W:$X>40 !?15 W:$X>15 ?40 W PSBRET(50.1,X,.01)
"RTN","PSBUTL",86,0)
 .W IOINORM
"RTN","PSBUTL",87,0)
 .F  Q:$Y>(IOSL-3)  W !
"RTN","PSBUTL",88,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSBUTL",89,0)
 Q
"RTN","PSBUTL",90,0)
 ;
"RTN","PSBUTL",91,0)
DPTSET ; Set Logic for pt-merge x-ref on patient field in file 53.79
"RTN","PSBUTL",92,0)
 ;
"RTN","PSBUTL",93,0)
 ; Entered Date/Time
"RTN","PSBUTL",94,0)
 I $P(^PSB(53.79,DA,0),U,4) S ^PSB(53.79,"AEDT",X,$P(^PSB(53.79,DA,0),U,4),DA)=""
"RTN","PSBUTL",95,0)
 ;
"RTN","PSBUTL",96,0)
 ; Administration Date/Time
"RTN","PSBUTL",97,0)
 D:$P(^PSB(53.79,DA,0),U,6)
"RTN","PSBUTL",98,0)
 .S ^PSB(53.79,"AADT",X,$P(^PSB(53.79,DA,0),U,6),DA)=""
"RTN","PSBUTL",99,0)
 .;
"RTN","PSBUTL",100,0)
 .; Orderable Item + Administration Date/Time
"RTN","PSBUTL",101,0)
 .I $P(^PSB(53.79,DA,0),U,8) S ^PSB(53.79,"AOIP",X,$P(^PSB(53.79,DA,0),U,8),$P(^PSB(53.79,DA,0),U,6),DA)=""
"RTN","PSBUTL",102,0)
 ;
"RTN","PSBUTL",103,0)
 ; PRN's by entered date/time
"RTN","PSBUTL",104,0)
 I $P($G(^PSB(53.79,DA,.1)),U,2)="P"&($P(^(0),U,4)) S ^PSB(53.79,"APRN",X,$P(^PSB(53.79,DA,0),U,4),DA)=""
"RTN","PSBUTL",105,0)
 ;
"RTN","PSBUTL",106,0)
 ; Order+Administration Date and Time
"RTN","PSBUTL",107,0)
 I $P($G(^PSB(53.79,DA,.1)),U)]""&($P($G(^PSB(53.79,DA,.1)),U,3)) S ^PSB(53.79,"AORD",X,$P(^PSB(53.79,DA,.1),U),$P(^PSB(53.79,DA,.1),U,3),DA)=""
"RTN","PSBUTL",108,0)
 Q
"RTN","PSBUTL",109,0)
 ;
"RTN","PSBUTL",110,0)
DPTKILL ; Kill Logic for pt-merge x-ref on patient field in file 53.79
"RTN","PSBUTL",111,0)
 ;
"RTN","PSBUTL",112,0)
 ; Entered Date/Time
"RTN","PSBUTL",113,0)
 I $P(^PSB(53.79,DA,0),U,4) K ^PSB(53.79,"AEDT",X,$P(^PSB(53.79,DA,0),U,4),DA)
"RTN","PSBUTL",114,0)
 ;
"RTN","PSBUTL",115,0)
 ; Administration Date/Time
"RTN","PSBUTL",116,0)
 D:$P(^PSB(53.79,DA,0),U,6)
"RTN","PSBUTL",117,0)
 .K ^PSB(53.79,"AADT",X,$P(^PSB(53.79,DA,0),U,6),DA)
"RTN","PSBUTL",118,0)
 .;
"RTN","PSBUTL",119,0)
 .; Orderable Item + Administration Date/Time
"RTN","PSBUTL",120,0)
 .I $P(^PSB(53.79,DA,0),U,8) K ^PSB(53.79,"AOIP",X,$P(^PSB(53.79,DA,0),U,8),$P(^PSB(53.79,DA,0),U,6),DA)
"RTN","PSBUTL",121,0)
 ;
"RTN","PSBUTL",122,0)
 ; PRN's by entered date/time
"RTN","PSBUTL",123,0)
 I $P($G(^PSB(53.79,DA,.1)),U,2)="P"&($P(^(0),U,4)) K ^PSB(53.79,"APRN",X,$P(^PSB(53.79,DA,0),U,4),DA)
"RTN","PSBUTL",124,0)
 ;
"RTN","PSBUTL",125,0)
 ; Order+Administration Date and Time
"RTN","PSBUTL",126,0)
 I $P($G(^PSB(53.79,DA,.1)),U)]""&($P($G(^PSB(53.79,DA,.1)),U,3)) K ^PSB(53.79,"AORD",X,$P(^PSB(53.79,DA,.1),U),$P(^PSB(53.79,DA,.1),U,3),DA)
"RTN","PSBUTL",127,0)
 Q
"RTN","PSBUTL",128,0)
 ;
"RTN","PSBUTL",129,0)
TIMEIN ;
"RTN","PSBUTL",130,0)
 X ^%ZOSF("UPPERCASE") S X=Y
"RTN","PSBUTL",131,0)
 I X="NOON" S X=.12 Q
"RTN","PSBUTL",132,0)
 I X="MID" S X=.24 Q
"RTN","PSBUTL",133,0)
 I (X="NOW")!(X="N") D NOW^%DTC S X=$E($P(%,".",2)_"0000",1,4)
"RTN","PSBUTL",134,0)
 S X="T@"_X,%DT="R" D ^%DT
"RTN","PSBUTL",135,0)
 I Y<1 K X Q
"RTN","PSBUTL",136,0)
 S X=Y-DT
"RTN","PSBUTL",137,0)
 Q
"RTN","PSBUTL",138,0)
 ;
"RTN","PSBUTL",139,0)
TIMEOUT(X) ; 
"RTN","PSBUTL",140,0)
 N HOUR,MIN,AMPM
"RTN","PSBUTL",141,0)
 S X=$E($P(X,".",2)_"0000",1,4)
"RTN","PSBUTL",142,0)
 I X="2400" Q "12:00m"
"RTN","PSBUTL",143,0)
 I X="1200" Q "12:00n"
"RTN","PSBUTL",144,0)
 S HOUR=+$E(X,1,2),MIN=$E(X,3,4)
"RTN","PSBUTL",145,0)
 S AMPM="a"
"RTN","PSBUTL",146,0)
 S AMPM=$S(HOUR<12:"a",HOUR>11:"p",1:"**")
"RTN","PSBUTL",147,0)
 S:HOUR>12 HOUR=HOUR-12
"RTN","PSBUTL",148,0)
 Q HOUR_":"_MIN_AMPM
"RTN","PSBUTL",149,0)
 ;
"RTN","PSBUTL",150,0)
HFSOPEN(HANDLE) ; 
"RTN","PSBUTL",151,0)
 N PSBDIR,PSBFILE
"RTN","PSBUTL",152,0)
 S PSBDIR=$$DEFDIR^%ZISH()
"RTN","PSBUTL",153,0)
 S PSBFILE="PSB"_DUZ_".DAT"
"RTN","PSBUTL",154,0)
 D OPEN^%ZISH(HANDLE,PSBDIR,PSBFILE,"W") Q:POP
"RTN","PSBUTL",155,0)
 S IOM=132,IOSL=99999,IOST="P-DUMMY",IOF=""""""
"RTN","PSBUTL",156,0)
 Q
"RTN","PSBUTL",157,0)
 ;
"RTN","PSBUTL",158,0)
HFSCLOSE(HANDLE) ; 
"RTN","PSBUTL",159,0)
 N PSBDIR,PSBFILE,PSBDEL
"RTN","PSBUTL",160,0)
 D CLOSE^%ZISH(HANDLE)
"RTN","PSBUTL",161,0)
 K ^TMP("PSBO",$J)
"RTN","PSBUTL",162,0)
 S PSBDIR=$$DEFDIR^%ZISH()
"RTN","PSBUTL",163,0)
 S PSBFILE="PSB"_DUZ_".DAT",PSBDEL(PSBFILE)=""
"RTN","PSBUTL",164,0)
 S X=$$FTG^%ZISH(PSBDIR,PSBFILE,$NAME(^TMP("PSBO",$J,2)),3)
"RTN","PSBUTL",165,0)
 S X=$$DEL^%ZISH(PSBDIR,$NA(PSBDEL))
"RTN","PSBUTL",166,0)
 Q
"RTN","PSBUTL",167,0)
 ;
"RTN","PSBUTL",168,0)
AUDIT(PSBREC,PSBDD,PSBFLD,PSBDATA,PSBSK) ; Med Log Audit
"RTN","PSBUTL",169,0)
 ; used by cross references to 53.79 to track changes to fields in Med Log file
"RTN","PSBUTL",170,0)
 ; xref AU05, AU06, AU09, AU16, AU21, AU22 pass the value 53.79 as PSBDD
"RTN","PSBUTL",171,0)
 ; xref AU303, AU304 pass the value 53.795 as PSBDD
"RTN","PSBUTL",172,0)
 ; xref AU603, AU604 pass the value 53.796 as PSBDD
"RTN","PSBUTL",173,0)
 ; xref AU703, AU704 pass the value 53.797 as PSBDD
"RTN","PSBUTL",174,0)
 ;
"RTN","PSBUTL",175,0)
 N PSBDT,PSBTMP
"RTN","PSBUTL",176,0)
 I '$D(PSBOLSTS) S PSBOLSTS=$P(^PSB(53.79,PSBREC,0),U,9)
"RTN","PSBUTL",177,0)
 I '$D(PSBOLDUZ) S PSBOLDUZ=$P(^PSB(53.79,PSBREC,0),U,5)
"RTN","PSBUTL",178,0)
 Q:$G(PSBDATA)=""!('$G(PSBAUDIT))
"RTN","PSBUTL",179,0)
 D NOW^%DTC S PSBDT=%
"RTN","PSBUTL",180,0)
 S PSBDATA=$$EXTERNAL^DILFD(PSBDD,PSBFLD,"",PSBDATA)  ; PSBDD=53.79, 53.795, 53.796, or 53.797 see comment AUDIT
"RTN","PSBUTL",181,0)
 D FIELD^DID(PSBDD,PSBFLD,"","LABEL","PSBTMP")  ; PSBDD=53.79, 53.795, 53.796, or 53.797 see comment AUDIT
"RTN","PSBUTL",182,0)
 S:'$D(^PSB(53.79,PSBREC,.9,0)) ^(0)="^53.799^^"
"RTN","PSBUTL",183,0)
 S Y=$O(^PSB(53.79,PSBREC,.9,""),-1)+1,X=""
"RTN","PSBUTL",184,0)
 I PSBTMP("LABEL")["ACTION STATUS" D  Q
"RTN","PSBUTL",185,0)
 .I PSBSK["K" S XY=Y F  S XY=$O(^PSB(53.79,PSBREC,.9,XY),-1) Q:($D(PSBGOON))!(+XY'>0)  D
"RTN","PSBUTL",186,0)
 ..I ^PSB(53.79,PSBREC,.9,XY,0)["ACTION STATUS Set to '" D  Q
"RTN","PSBUTL",187,0)
 ...S PSBGOON=1,PSBOLDUZ=$P(^PSB(53.79,PSBREC,.9,XY,0),U,2),X=$P(^PSB(53.79,PSBREC,.9,XY,0),"'",2)
"RTN","PSBUTL",188,0)
 .S:$L(X)'>2 X=PSBOLSTS,X=$S(X="G":"GIVEN",X="H":"HELD",X="R":"REFUSED",X="I":"INFUSING",X="C":"COMPLETED",X="S":"STOPPED",X="N":"NOT GIVEN",X="RM":"REMOVED",X="M":"MISSING DOSE",X="":PSBOLSTS)
"RTN","PSBUTL",189,0)
 .I PSBSK["K" S ^PSB(53.79,PSBREC,.9,Y,0)=PSBDT_U_DUZ_U_"Field: "_PSBTMP("LABEL")_" '"_PSBDATA_"' by '"_$$GET1^DIQ(200,PSBOLDUZ,"INITIAL")_"' deleted."
"RTN","PSBUTL",190,0)
 .;PSB*3*45 Store Action status and last given fields.
"RTN","PSBUTL",191,0)
 .E  S ^PSB(53.79,PSBREC,.9,Y,0)=PSBDT_U_DUZ_U_"Field: "_PSBTMP("LABEL")_" Set to '"_PSBDATA_"' by '"_$$GET1^DIQ(200,DUZ,"INITIAL")_"'."_U_PSBDATA_U_$P(^PSB(53.79,PSBREC,0),"^",7)
"RTN","PSBUTL",192,0)
 I PSBSK["K" S ^PSB(53.79,PSBREC,.9,Y,0)=PSBDT_U_DUZ_U_"Field: "_PSBTMP("LABEL")_" '"_PSBDATA_"' deleted."
"RTN","PSBUTL",193,0)
 E  S ^PSB(53.79,PSBREC,.9,Y,0)=PSBDT_U_DUZ_U_"Field: "_PSBTMP("LABEL")_$S(PSBTMP("LABEL")["DISPENSE DRUG":" Added '",1:" Set to '")_PSBDATA_"'."
"RTN","PSBUTL",194,0)
 K XY,PSBGOON
"RTN","PSBUTL",195,0)
 Q
"RTN","PSBUTL",196,0)
 ;
"RTN","PSBUTL",197,0)
CHECK(RESULTS,PSBWHAT,PSBDATA) ; Checks for KIDS Patch or Build
"RTN","PSBUTL",198,0)
 ; Module added in Patch PSB*1.0*3 DP/TOPEKA 22-DEC-1999 11:51:22 
"RTN","PSBUTL",199,0)
 ; PSBWHAT: B = Returns Build Version for packages by Namespace
"RTN","PSBUTL",200,0)
 ;          P = Returns if Patch is installed
"RTN","PSBUTL",201,0)
 ; PSBDATA: Build/Package namespace (i.e. PSB) or Patch Number
"RTN","PSBUTL",202,0)
 ;         (i.e. PSB*1.0*1)
"RTN","PSBUTL",203,0)
 ;
"RTN","PSBUTL",204,0)
 S RESULTS(0)="-1^Unknown Parameter "_$G(PSBWHAT,"<PSBWHAT Undefined>")
"RTN","PSBUTL",205,0)
 S PSBWHAT=$G(PSBWHAT),PSBDATA=$G(PSBDATA)
"RTN","PSBUTL",206,0)
 D:PSBWHAT="B"
"RTN","PSBUTL",207,0)
 .S X=$$VERSION^XPDUTL(PSBDATA)
"RTN","PSBUTL",208,0)
 .S RESULTS(0)=$S(X="":"-1^Unknown Package/Build",1:"1^"_X)
"RTN","PSBUTL",209,0)
 D:PSBWHAT="P"
"RTN","PSBUTL",210,0)
 .S X=$$PATCH^XPDUTL(PSBDATA)
"RTN","PSBUTL",211,0)
 .S RESULTS(0)=$S(X:"1^Patch Is Installed",1:"-1^Patch Is Not Installed")
"RTN","PSBUTL",212,0)
 Q
"RTN","PSBUTL",213,0)
 ;
"RTN","PSBUTL",214,0)
VERSION() ; [Extrinsic] 
"RTN","PSBUTL",215,0)
 ; Returns V#.# for display purposes
"RTN","PSBUTL",216,0)
 Q "V"_$J(2,0,1)
"RTN","PSBUTL",217,0)
 ;
"RTN","PSBUTL",218,0)
RESETADM ;
"RTN","PSBUTL",219,0)
 ;
"RTN","PSBUTL",220,0)
 ;  This Subroutine will reset a medication order's resources
"RTN","PSBUTL",221,0)
 ;  based on Med Log New Entry or Edit Med Log activity.
"RTN","PSBUTL",222,0)
 ;
"RTN","PSBUTL",223,0)
 ;  No input is necessary. Environment should be setup at call.
"RTN","PSBUTL",224,0)
 ;
"RTN","PSBUTL",225,0)
 I '$G(PSBMMEN) S X=$S($P(PSBIEN,",",2)]"":$P(PSBIEN,",",2),1:+PSBIEN) D CLEAN^PSBVT,PSJ1^PSBVT($P(^PSB(53.79,X,0),U),$P(^PSB(53.79,X,.1),U)) D:($$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,+$G(PSBIVPSH)))  D CLEAN^PSBVT
"RTN","PSBUTL",226,0)
 .S X=PSBIEN,X2=X_$S(X="+1":",",1:"") Q:'$D(PSBFDA(53.79,X2,.09))  I $F("HR",PSBFDA(53.79,X2,.09))>1 S PSBFDA(53.79,X2,.26)=""
"RTN","PSBUTL",227,0)
 I $G(PSBMMEN),PSBIEN="+1",$G(PSBONX)["V" S PSBWSID=PSBFDA(53.79,"+1,",.26) K PSBFDA(53.79,"+1,",.26),PSBFDA(53.79,"+1,",.09)
"RTN","PSBUTL",228,0)
 I $G(PSBMMEN) I ($D(PSBWSID))&($G(Y(0))="SAVE") D
"RTN","PSBUTL",229,0)
 .S:(PSBREC(3)="G") PSBFDAX(53.79,X,.26)=PSBWSID
"RTN","PSBUTL",230,0)
 .S:$F("HR",PSBREC(3))>1 PSBFDAX(53.79,X,.26)=""
"RTN","PSBUTL",231,0)
 .S X=$P(PSBIEN,"+1,",2)
"RTN","PSBUTL",232,0)
 .D UPDATE^DIE("","PSBFDAX","X","PSBMSG")
"RTN","PSBUTL",233,0)
 Q
"RTN","PSBUTL",234,0)
 ;
"RTN","PSBUTL",235,0)
SCRNPTCH ;
"RTN","PSBUTL",236,0)
 ;
"RTN","PSBUTL",237,0)
 ; Maintain the "APATCH" index from SCREENMAN and Manual Med Entry.
"RTN","PSBUTL",238,0)
 ;
"RTN","PSBUTL",239,0)
 I Y(0)'="GIVEN" S PSBGPTCH=0 Q
"RTN","PSBUTL",240,0)
 S PSBX=0 F  S PSBX=$O(^PSB(53.79,DA,.5,PSBX))  Q:+PSBX=0  Q:$P(^PSB(53.79,DA,.5,+PSBX,0),U,4)="PATCH"
"RTN","PSBUTL",241,0)
 Q:+PSBX=0
"RTN","PSBUTL",242,0)
 S PSBGPTCH=1
"RTN","PSBUTL",243,0)
 Q
"RTN","PSBUTL",244,0)
 ;
"RTN","PSBUTL",245,0)
GIVEPTCH ;
"RTN","PSBUTL",246,0)
 I $D(^PSB(53.79,"AORD",DFN,PSBONX)) N PSBX S PSBX="" F  S PSBX=$O(^PSB(53.79,"AORD",DFN,PSBONX,PSBX)) Q:+PSBX=0  D:$D(^PSB(53.79,"AORD",DFN,PSBONX,PSBX,DA))  Q:'$D(PSBX)
"RTN","PSBUTL",247,0)
 .I $D(^PSB(53.79,"AORD",DFN,PSBONX,PSBX,DA)) D
"RTN","PSBUTL",248,0)
 ..S PSBX=$P(^PSB(53.79,DA,0),U,6)
"RTN","PSBUTL",249,0)
 ..I PSBGPTCH S ^PSB(53.79,"APATCH",DFN,PSBX,DA)="" K PSBX,PSBGPTCH Q
"RTN","PSBUTL",250,0)
 ..I 'PSBGPTCH K ^PSB(53.79,"APATCH",DFN,PSBX,DA),PSBX,PSBGPTCH
"RTN","PSBUTL",251,0)
 Q
"RTN","PSBUTL",252,0)
 ;
"RTN","PSBUTL",253,0)
VALGIV() ;Validate Give, variance time set during a Trigger call      *83
"RTN","PSBUTL",254,0)
 Q:'$P($G(^PSB(53.79,DA,0)),U,6) 0
"RTN","PSBUTL",255,0)
 Q ($P($G(^PSB(53.79,DA,.1)),U,2)="C"&($P($G(^(.1)),U,3)]"")&($G(PSBACTN)="G"))
"RTN","PSBUTL",256,0)
 ;
"RTN","PSBUTL",257,0)
VALREM() ;Validate Remove, variance time set during a Trigger call    *83
"RTN","PSBUTL",258,0)
 Q:'$P($G(^PSB(53.79,DA,0)),U,6) 0
"RTN","PSBUTL",259,0)
 Q ($P($G(^PSB(53.79,DA,.1)),U,2)="C"&($P($G(^(.1)),U,7)]"")&($G(PSBACTN)="RM"))
"RTN","PSBUTL",260,0)
 ;
"RTN","PSBUTL",261,0)
REMSTR(A,D,TY,SP,PRSP) ;build remove time string from admin time string via DOA value *83
"RTN","PSBUTL",262,0)
 ;    A = admin time strg e.g. "0900-2100"
"RTN","PSBUTL",263,0)
 ;    D = Duration of Admin (DOA)
"RTN","PSBUTL",264,0)
 ;   TY = sched type
"RTN","PSBUTL",265,0)
 ;   SP = order stop date
"RTN","PSBUTL",266,0)
 ; PRSP = previous stop date
"RTN","PSBUTL",267,0)
 ;
"RTN","PSBUTL",268,0)
 N RMTM,RMSTR,Q
"RTN","PSBUTL",269,0)
 S RMSTR="",TY=$G(TY),SP=$G(SP),PRSP=$G(PRSP)
"RTN","PSBUTL",270,0)
 ;
"RTN","PSBUTL",271,0)
 ;no admin time, return null RMSTR
"RTN","PSBUTL",272,0)
 Q:(TY'="O")&('A) RMSTR
"RTN","PSBUTL",273,0)
 ;
"RTN","PSBUTL",274,0)
 ;sched typ is One Time, return Ord stop time as RMSTR
"RTN","PSBUTL",275,0)
 I TY="O" D  Q RMSTR
"RTN","PSBUTL",276,0)
 .S RMSTR=$S(PRSP:PRSP,1:SP),RMSTR=$E($P(RMSTR,".",2)_"0000",1,4)
"RTN","PSBUTL",277,0)
 ;
"RTN","PSBUTL",278,0)
 ;continuous schedules with valid admin times
"RTN","PSBUTL",279,0)
 F Q=1:1:$L(A,"-") D
"RTN","PSBUTL",280,0)
 .S RMTM=DT_"."_$P(A,"-",Q)
"RTN","PSBUTL",281,0)
 .S RMTM=$$FMADD^XLFDT(RMTM,,,D)
"RTN","PSBUTL",282,0)
 .S RMTM=$P(RMTM,".",2),RMTM=$E(RMTM_"0000",1,4)
"RTN","PSBUTL",283,0)
 .S $P(RMSTR,"-",Q)=RMTM
"RTN","PSBUTL",284,0)
 Q RMSTR
"RTN","PSBUTL",285,0)
 ;
"RTN","PSBUTL",286,0)
CNVRT4(STR,SEP) ;Converts a time string to 4 digit for consistency         *83
"RTN","PSBUTL",287,0)
 ;  STR - string of times
"RTN","PSBUTL",288,0)
 ;  SEP - separator character between times
"RTN","PSBUTL",289,0)
 ;
"RTN","PSBUTL",290,0)
 N QQ
"RTN","PSBUTL",291,0)
 F QQ=1:1:$L(STR,SEP) S $P(STR,SEP,QQ)=$E($P(STR,SEP,QQ)_"0000",1,4)
"RTN","PSBUTL",292,0)
 Q STR
"RTN","PSBUTL",293,0)
 ;
"RTN","PSBUTL",294,0)
FINDGIVE(IEN) ;Finds the last Give date/time in the Audit log for a RM sts *83
"RTN","PSBUTL",295,0)
 ;   When a Remove action occurs and saved to 53.79, the Give Action
"RTN","PSBUTL",296,0)
 ;   Status & Action Date/Time are overwritten. This Function will
"RTN","PSBUTL",297,0)
 ;   retrieve that Give info.
"RTN","PSBUTL",298,0)
 ;
"RTN","PSBUTL",299,0)
 ; Function returns - string formatted as the MAH report uses:
"RTN","PSBUTL",300,0)
 ;
"RTN","PSBUTL",301,0)
 ; date/time^by initials^action code^IEN of #53.79^IEN of user #200
"RTN","PSBUTL",302,0)
 ;
"RTN","PSBUTL",303,0)
 Q:$P(^PSB(53.79,IEN,0),U,9)'="RM" ""
"RTN","PSBUTL",304,0)
 N DA,DAT,GIVE,FOUND,STR,QQ,PRVDA,PRVDAT,SKIP
"RTN","PSBUTL",305,0)
 S (FOUND,STR,GIVE)=""
"RTN","PSBUTL",306,0)
 F DA=99999:0 S DA=$O(^PSB(53.79,IEN,.9,DA),-1) Q:'DA  D  Q:FOUND
"RTN","PSBUTL",307,0)
 .S DAT=^PSB(53.79,IEN,.9,DA,0),SKIP=0
"RTN","PSBUTL",308,0)
 .; check for previous audit to be an Undo RM, if so skip it
"RTN","PSBUTL",309,0)
 .I DAT["ACTION STATUS Set to 'GIVEN'" D  Q
"RTN","PSBUTL",310,0)
 ..S PRVDA=$O(^PSB(53.79,IEN,.9,DA),-1) ;previous audit DA
"RTN","PSBUTL",311,0)
 ..D:PRVDA
"RTN","PSBUTL",312,0)
 ...S PRVDAT=^PSB(53.79,IEN,.9,PRVDA,0)
"RTN","PSBUTL",313,0)
 ...I PRVDAT["ACTION STATUS 'REMOVED'",PRVDAT["deleted" S SKIP=1
"RTN","PSBUTL",314,0)
 ..Q:SKIP
"RTN","PSBUTL",315,0)
 ..S $P(STR,U,1)=$P(DAT,U,1)            ;init date just in case
"RTN","PSBUTL",316,0)
 ..S $P(STR,U,2)=$P(DAT,"'",4)          ;by initials
"RTN","PSBUTL",317,0)
 ..S $P(STR,U,3)="G"                    ;action sts Give
"RTN","PSBUTL",318,0)
 ..S $P(STR,U,4)=IEN                    ;ien of transaction
"RTN","PSBUTL",319,0)
 ..S $P(STR,U,5)=$P(DAT,U,2)            ;ien of user file 200
"RTN","PSBUTL",320,0)
 ..S GIVE=1
"RTN","PSBUTL",321,0)
 .Q:SKIP
"RTN","PSBUTL",322,0)
 .;
"RTN","PSBUTL",323,0)
 .;preferred date of action is in external form, as manual med edits
"RTN","PSBUTL",324,0)
 .;can be back dated and show up here vs audit date/time for the Give
"RTN","PSBUTL",325,0)
 .D:GIVE
"RTN","PSBUTL",326,0)
 ..Q:DAT'["DATE/TIME Set to"
"RTN","PSBUTL",327,0)
 ..S:DAT?.E1"@".E $P(STR,U,1)=$$ETFM($P(^(0),"'",2))
"RTN","PSBUTL",328,0)
 ..;found real date
"RTN","PSBUTL",329,0)
 ..S FOUND=1
"RTN","PSBUTL",330,0)
 Q STR
"RTN","PSBUTL",331,0)
 ;
"RTN","PSBUTL",332,0)
ETFM(EX) ;convert external to FM date format
"RTN","PSBUTL",333,0)
 N M,MM,MTH,TM,DY,Y,Y1,Y2,YYY,YYYY,Q
"RTN","PSBUTL",334,0)
 S MTH=$E(EX,1,3)
"RTN","PSBUTL",335,0)
 S Q=0
"RTN","PSBUTL",336,0)
 F M="JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC" S Q=Q+.01,MM(M)=Q
"RTN","PSBUTL",337,0)
 S MM=$E($P(MM(MTH),".",2)_"0",1,2)
"RTN","PSBUTL",338,0)
 ;
"RTN","PSBUTL",339,0)
 S DY=$P(EX," ",2),DY=$TR(DY,",","")
"RTN","PSBUTL",340,0)
 S Y=$P(EX," ",3),YYYY=$P(Y,"@"),Y1=$E(YYYY,1,2)-17,Y2=$E(YYYY,3,4),YYYY=Y1_Y2
"RTN","PSBUTL",341,0)
 S TM=$P(Y,"@",2),TM=$TR(TM,":","")
"RTN","PSBUTL",342,0)
 Q $E(YYYY_MM_DY_"."_TM,1,12)
"RTN","PSBUTL",343,0)
 ;
"RTN","PSBUTL",344,0)
MEDHIST(LIST,DFN,OI,MAX) ;Last nn admin actions per a patients Orderable Item
"RTN","PSBUTL",345,0)
 ;
"RTN","PSBUTL",346,0)
 ; Reference/IA
"RTN","PSBUTL",347,0)
 ; #6271 for Inpatient Medications to call into BCMA   *83
"RTN","PSBUTL",348,0)
 ;   ** NOTE **
"RTN","PSBUTL",349,0)
 ;     THIS API IS DIRECTLY/INDIRECTLY DEPENDANT ON 3 OTHER INTERNAL
"RTN","PSBUTL",350,0)
 ;     API's: LASTSITE^PSBINJEC, RPC^PSBVDLUD, & FINDGIVE^PSBUTL
"RTN","PSBUTL",351,0)
 ;   
"RTN","PSBUTL",352,0)
 ; Input:
"RTN","PSBUTL",353,0)
 ;   DFN - Patient num
"RTN","PSBUTL",354,0)
 ;   OI  - Inpatient Meds Orderable Item ien
"RTN","PSBUTL",355,0)
 ;   MAX - Max days back to search
"RTN","PSBUTL",356,0)
 ; Output:
"RTN","PSBUTL",357,0)
 ;   LIST - Array of actions formatted as :
"RTN","PSBUTL",358,0)
 ;     DATE^ACTION^ORDNO^LSTSITE^LOCATION^NURSINITL
"RTN","PSBUTL",359,0)
 ;
"RTN","PSBUTL",360,0)
 K LIST
"RTN","PSBUTL",361,0)
 N DTE,CNT,IEN,ACTN,GIVE,DATE,LSITE,ACTBY,NURINI,ORDN,LOC
"RTN","PSBUTL",362,0)
 ;
"RTN","PSBUTL",363,0)
 S DTE=DT+1
"RTN","PSBUTL",364,0)
 F  S DTE=$O(^PSB(53.79,"AOIP",DFN,OI,DTE),-1) Q:'DTE  D  Q:$$FMDIFF^XLFDT($$NOW^XLFDT,DTE,1)>MAX
"RTN","PSBUTL",365,0)
 .S IEN=0
"RTN","PSBUTL",366,0)
 .F  S IEN=$O(^PSB(53.79,"AOIP",DFN,OI,DTE,IEN)) Q:'IEN  D  Q:$$FMDIFF^XLFDT($$NOW^XLFDT,DTE,1)>MAX
"RTN","PSBUTL",367,0)
 ..S ACTN=$$GET1^DIQ(53.79,IEN,.09)
"RTN","PSBUTL",368,0)
 ..S ORDN=$$GET1^DIQ(53.79,IEN,.11)
"RTN","PSBUTL",369,0)
 ..S LOC=$$GET1^DIQ(53.79,IEN,.02)
"RTN","PSBUTL",370,0)
 ..S ACTBY=$$GET1^DIQ(53.79,IEN,.07,"I")
"RTN","PSBUTL",371,0)
 ..S NURINI=$$GET1^DIQ(200,ACTBY,1)
"RTN","PSBUTL",372,0)
 ..Q:ACTN="NOT GIVEN"
"RTN","PSBUTL",373,0)
 ..Q:$$FMDIFF^XLFDT($$NOW^XLFDT,DTE,1)>MAX
"RTN","PSBUTL",374,0)
 ..S LSITE=$$LASTSITE^PSBINJEC(DFN,OI)
"RTN","PSBUTL",375,0)
 ..S LIST(DTE)=DTE_U_ACTN_U_ORDN_U_LSITE_U_LOC_U_NURINI
"RTN","PSBUTL",376,0)
 ..I ACTN="REMOVED" D
"RTN","PSBUTL",377,0)
 ...S GIVE=$$FINDGIVE(IEN)
"RTN","PSBUTL",378,0)
 ...S DATE=$P(GIVE,U)
"RTN","PSBUTL",379,0)
 ...S NURINI=$P(GIVE,U,2)
"RTN","PSBUTL",380,0)
 ...Q:$$FMDIFF^XLFDT($$NOW^XLFDT,DATE,1)>MAX
"RTN","PSBUTL",381,0)
 ...S LIST(DATE)=DATE_U_"GIVEN"_U_ORDN_U_LSITE_U_LOC_U_NURINI
"RTN","PSBUTL",382,0)
 Q
"RTN","PSBUTL",383,0)
 ;
"RTN","PSBUTL",384,0)
FIXADM ;Update ORD seg with GIVE status based on ALL ADM Records         *83
"RTN","PSBUTL",385,0)
 ;  If any ADM's contain G then remove required for this ORDER
"RTN","PSBUTL",386,0)
 N QQ,MRR,ADSTS,ADIEN,OIEN,RMTM
"RTN","PSBUTL",387,0)
 S MRR=0,ADSTS=""
"RTN","PSBUTL",388,0)
 F QQ=1:1:+$G(^TMP("PSB",$J,"CVRSHT",0)) D
"RTN","PSBUTL",389,0)
 .Q:$E(^TMP("PSB",$J,"CVRSHT",QQ),1,3)="END"
"RTN","PSBUTL",390,0)
 .I $E(^TMP("PSB",$J,"CVRSHT",QQ),1,3)="ORD" S OIEN=QQ,MRR=0 Q
"RTN","PSBUTL",391,0)
 .I $E(^TMP("PSB",$J,"CVRSHT",QQ),1,2)="DD" D
"RTN","PSBUTL",392,0)
 ..S MRR=$P(^TMP("PSB",$J,"CVRSHT",QQ),U,8)
"RTN","PSBUTL",393,0)
 .;only update sts in ORD.14 if G found for any med
"RTN","PSBUTL",394,0)
 .I $E(^TMP("PSB",$J,"CVRSHT",QQ),1,3)="ADM" D  Q:ADSTS="G"
"RTN","PSBUTL",395,0)
 ..S ADSTS=$P(^TMP("PSB",$J,"CVRSHT",QQ),U,5)
"RTN","PSBUTL",396,0)
 ..S ADIEN=$P(^TMP("PSB",$J,"CVRSHT",QQ),U,4)
"RTN","PSBUTL",397,0)
 ..S:ADIEN RMTM=$P(^PSB(53.79,ADIEN,.1),U,7)
"RTN","PSBUTL",398,0)
 ..;if a Give & MRR med, then the Remove time needs to be retrieved
"RTN","PSBUTL",399,0)
 ..;again from 53.79.  The last info found by PSBVDLUD may not be for
"RTN","PSBUTL",400,0)
 ..;this medlog record.
"RTN","PSBUTL",401,0)
 ..D:ADSTS="G"&MRR
"RTN","PSBUTL",402,0)
 ...S $P(^TMP("PSB",$J,"CVRSHT",OIEN),U,14)=ADSTS
"RTN","PSBUTL",403,0)
 ...S $P(^TMP("PSB",$J,"CVRSHT",OIEN),U,36)=RMTM
"RTN","PSBUTL",404,0)
 Q
"RTN","PSBUTL",405,0)
 ;
"RTN","PSBUTL",406,0)
REMOVES(DFN,TYPE) ;Searches xrefs for MRR type meds needing removal and adds    *83
"RTN","PSBUTL",407,0)
 ;
"RTN","PSBUTL",408,0)
 ;Type = (P)atient, (W)ard, (C)linic
"RTN","PSBUTL",409,0)
 ;
"RTN","PSBUTL",410,0)
 N PSBGNODE,PSBIEN,PSBZON,PSBRMDT,PSBMRRFL,PSBONX,PSBOITX,PSBOSP,PSBOSTS
"RTN","PSBUTL",411,0)
 ;
"RTN","PSBUTL",412,0)
 ;Xref APATCH search (backwards compatible xref)
"RTN","PSBUTL",413,0)
 S PSBGNODE="^PSB(53.79,"_"""APATCH"""_","_DFN_")"
"RTN","PSBUTL",414,0)
 F  S PSBGNODE=$Q(@PSBGNODE) Q:PSBGNODE']""  Q:($QS(PSBGNODE,2)'="APATCH")!($QS(PSBGNODE,3)'=DFN)  D
"RTN","PSBUTL",415,0)
 .S PSBIEN=$QS(PSBGNODE,5),PSBONX=$P(^PSB(53.79,PSBIEN,.1),U)
"RTN","PSBUTL",416,0)
 .D PSJ1^PSBVT(DFN,PSBONX)
"RTN","PSBUTL",417,0)
 .Q:(TYPE="C")&('PSBCLIEN)                      ;not a clinic order
"RTN","PSBUTL",418,0)
 .Q:'$D(^PSB(53.79,PSBIEN,.5,1))                ;no disp drug
"RTN","PSBUTL",419,0)
 .Q:$P(^PSB(53.79,PSBIEN,.5,1,0),U,4)'="PATCH"  ;not a Patch
"RTN","PSBUTL",420,0)
 .Q:$P(^PSB(53.79,PSBIEN,0),U,9)'="G"           ;not Given
"RTN","PSBUTL",421,0)
 .D SETMRR
"RTN","PSBUTL",422,0)
 ;
"RTN","PSBUTL",423,0)
 ;Xref AMRR search   (new xref for transdermal meds)
"RTN","PSBUTL",424,0)
 S PSBGNODE="^PSB(53.79,"_"""AMRR"""_","_DFN_")"
"RTN","PSBUTL",425,0)
 F  S PSBGNODE=$Q(@PSBGNODE) Q:PSBGNODE']""  Q:($QS(PSBGNODE,2)'="AMRR")!($QS(PSBGNODE,3)'=DFN)  D
"RTN","PSBUTL",426,0)
 .S PSBIEN=$QS(PSBGNODE,5),PSBONX=$P(^PSB(53.79,PSBIEN,.1),U)
"RTN","PSBUTL",427,0)
 .D PSJ1^PSBVT(DFN,PSBONX)
"RTN","PSBUTL",428,0)
 .Q:(TYPE="C")&('PSBCLIEN)                      ;not a clinic order
"RTN","PSBUTL",429,0)
 .Q:$P(^PSB(53.79,PSBIEN,.5,1,0),U,4)="PATCH"   ;Is patch already seen
"RTN","PSBUTL",430,0)
 .Q:'$D(^PSB(53.79,PSBIEN,.5,1))                ;no disp drug
"RTN","PSBUTL",431,0)
 .Q:'$P(^PSB(53.79,PSBIEN,.5,1,0),U,6)          ;no MRR flag
"RTN","PSBUTL",432,0)
 .Q:$P(^PSB(53.79,PSBIEN,0),U,9)'="G"           ;not Given
"RTN","PSBUTL",433,0)
 .D SETMRR
"RTN","PSBUTL",434,0)
 ;
"RTN","PSBUTL",435,0)
 D CLEAN^PSBVT
"RTN","PSBUTL",436,0)
 Q
"RTN","PSBUTL",437,0)
 ;
"RTN","PSBUTL",438,0)
SETMRR ;Get and set MRR info for printing Removals
"RTN","PSBUTL",439,0)
 ; If clinic order mode, skip removes for locations not on clinic list
"RTN","PSBUTL",440,0)
 ;   If No list then All clinics desired.
"RTN","PSBUTL",441,0)
 N CLNAM S CLNAM=$P(^PSB(53.79,PSBIEN,0),U,2)
"RTN","PSBUTL",442,0)
 I '$G(PSBIENS) N PSBIENS S PSBIENS=PSBRPT
"RTN","PSBUTL",443,0)
 I PSBCLINORD,$D(^PSB(53.69,+PSBIENS,2,"B")),CLNAM]"",'$D(^PSB(53.69,+PSBIENS,2,"B",CLNAM)) Q   ;not on selection list when list is present
"RTN","PSBUTL",444,0)
 S PSBZON=$P(^PSB(53.79,PSBIEN,.1),"^")
"RTN","PSBUTL",445,0)
 S PSBRMDT=$P(^PSB(53.79,PSBIEN,.1),"^",7)
"RTN","PSBUTL",446,0)
 Q:'PSBRMDT
"RTN","PSBUTL",447,0)
 Q:(PSBRMDT<PSBSTART)!(PSBRMDT>PSBSTOP)
"RTN","PSBUTL",448,0)
 K ^TMP("PSJ1",$J) D EN^PSJBCMA1(DFN,PSBZON,1)
"RTN","PSBUTL",449,0)
 Q:$G(^TMP("PSJ1",$J,0))=-1
"RTN","PSBUTL",450,0)
 S PSBONX=$P(^TMP("PSJ1",$J,0),U,3)     ; ord num w/  type "U" or "V"
"RTN","PSBUTL",451,0)
 S PSBOSTS=$P(^TMP("PSJ1",$J,1),U,10)   ; ord status
"RTN","PSBUTL",452,0)
 S PSBOITX=$P(^TMP("PSJ1",$J,2),U,2)    ; order item (expanded)
"RTN","PSBUTL",453,0)
 S PSBOSP=$P(^TMP("PSJ1",$J,4),U,7)     ; stop date FM
"RTN","PSBUTL",454,0)
 S ^TMP("PSB",$J,DFN,PSBRMDT,PSBOITX,PSBONX,"RM")=""
"RTN","PSBUTL",455,0)
 S PSBS(DFN,PSBONX,$S(PSBOSTS="A":"Active",PSBOSTS="H":"On Hold",PSBOSTS="D":"DC'd",PSBOSTS="DE":"DC'd (Edit)",PSBOSTS="E":"Expired",PSBOSTS="O":"On Call",PSBOSTS="R":"Renewed",1:"*Unknown*"))="" ;PSB*3*76 adds Renewed as status
"RTN","PSBUTL",456,0)
 S PSBSTXP(PSBONX,DFN,$$DTFMT^PSBOMM2(PSBOSP))=""
"RTN","PSBUTL",457,0)
 Q
"VER")
8.0^22.0
"BLD",9541,6)
^79
**END**
**END**

