Released PSB*3*80 SEQ #70
Extracted from mail message
**KIDS**:PSB*3.0*80^

**INSTALL NAME**
PSB*3.0*80
"BLD",9701,0)
PSB*3.0*80^BAR CODE MED ADMIN^0^3150218^y
"BLD",9701,1,0)
^^17^17^3140509^
"BLD",9701,1,1,0)
This Patch Addresses 6 issues:
"BLD",9701,1,2,0)
 
"BLD",9701,1,3,0)
1. The Bar Code Medication Administration (BCMA) MEDICATION
"BLD",9701,1,4,0)
VARIANCE LOG (#53.78) file does not save data in DRUG SCANNED
"BLD",9701,1,5,0)
(#.07) field.
"BLD",9701,1,6,0)
2. BCMA stores the initials of the user who viewed the patient's record
"BLD",9701,1,7,0)
instead of the initials of the user who marked a Vital Entered in Error.
"BLD",9701,1,8,0)
3. The BCMA Unable to Scan Detailed report does not display any data
"BLD",9701,1,9,0)
when run for a Nursing Ward if the user running the report is logged into 
"BLD",9701,1,10,0)
a different division. 
"BLD",9701,1,11,0)
4. The BCMA Administration Times report does not display historical
"BLD",9701,1,12,0)
data when run by ward.
"BLD",9701,1,13,0)
5. The BCMA Clinical Reminders tab does not display that a PRN 
"BLD",9701,1,14,0)
Effectiveness is needed when the PRN is given on the same day as the 
"BLD",9701,1,15,0)
patient is admitted.
"BLD",9701,1,16,0)
6. The Unable to Scan detailed report does not display the full Health 
"BLD",9701,1,17,0)
Record Number (HRN) for Indian Health Services (IHS) sites.
"BLD",9701,4,0)
^9.64PA^53.78^1
"BLD",9701,4,53.78,0)
53.78
"BLD",9701,4,53.78,2,0)
^9.641^53.78^1
"BLD",9701,4,53.78,2,53.78,0)
BCMA MEDICATION VARIANCE LOG  (File-top level)
"BLD",9701,4,53.78,2,53.78,1,0)
^9.6411^.07^1
"BLD",9701,4,53.78,2,53.78,1,.07,0)
DRUG SCANNED
"BLD",9701,4,53.78,222)
y^y^p^^^^n^^n
"BLD",9701,4,53.78,224)

"BLD",9701,4,"APDD",53.78,53.78)

"BLD",9701,4,"APDD",53.78,53.78,.07)

"BLD",9701,4,"B",53.78,53.78)

"BLD",9701,6.3)
6
"BLD",9701,"KRN",0)
^9.67PA^779.2^20
"BLD",9701,"KRN",.4,0)
.4
"BLD",9701,"KRN",.401,0)
.401
"BLD",9701,"KRN",.402,0)
.402
"BLD",9701,"KRN",.403,0)
.403
"BLD",9701,"KRN",.5,0)
.5
"BLD",9701,"KRN",.84,0)
.84
"BLD",9701,"KRN",3.6,0)
3.6
"BLD",9701,"KRN",3.8,0)
3.8
"BLD",9701,"KRN",9.2,0)
9.2
"BLD",9701,"KRN",9.8,0)
9.8
"BLD",9701,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",9701,"KRN",9.8,"NM",1,0)
PSBPRN^^0^B42972466
"BLD",9701,"KRN",9.8,"NM",2,0)
PSBVAR^^0^B15546139
"BLD",9701,"KRN",9.8,"NM",3,0)
PSBOSF^^0^B221628856
"BLD",9701,"KRN",9.8,"NM",4,0)
PSBCSUTL^^0^B184801061
"BLD",9701,"KRN",9.8,"NM",5,0)
PSBOWA^^0^B133947862
"BLD",9701,"KRN",9.8,"NM","B","PSBCSUTL",4)

"BLD",9701,"KRN",9.8,"NM","B","PSBOSF",3)

"BLD",9701,"KRN",9.8,"NM","B","PSBOWA",5)

"BLD",9701,"KRN",9.8,"NM","B","PSBPRN",1)

"BLD",9701,"KRN",9.8,"NM","B","PSBVAR",2)

"BLD",9701,"KRN",19,0)
19
"BLD",9701,"KRN",19.1,0)
19.1
"BLD",9701,"KRN",101,0)
101
"BLD",9701,"KRN",409.61,0)
409.61
"BLD",9701,"KRN",771,0)
771
"BLD",9701,"KRN",779.2,0)
779.2
"BLD",9701,"KRN",870,0)
870
"BLD",9701,"KRN",8989.51,0)
8989.51
"BLD",9701,"KRN",8989.52,0)
8989.52
"BLD",9701,"KRN",8994,0)
8994
"BLD",9701,"KRN","B",.4,.4)

"BLD",9701,"KRN","B",.401,.401)

"BLD",9701,"KRN","B",.402,.402)

"BLD",9701,"KRN","B",.403,.403)

"BLD",9701,"KRN","B",.5,.5)

"BLD",9701,"KRN","B",.84,.84)

"BLD",9701,"KRN","B",3.6,3.6)

"BLD",9701,"KRN","B",3.8,3.8)

"BLD",9701,"KRN","B",9.2,9.2)

"BLD",9701,"KRN","B",9.8,9.8)

"BLD",9701,"KRN","B",19,19)

"BLD",9701,"KRN","B",19.1,19.1)

"BLD",9701,"KRN","B",101,101)

"BLD",9701,"KRN","B",409.61,409.61)

"BLD",9701,"KRN","B",771,771)

"BLD",9701,"KRN","B",779.2,779.2)

"BLD",9701,"KRN","B",870,870)

"BLD",9701,"KRN","B",8989.51,8989.51)

"BLD",9701,"KRN","B",8989.52,8989.52)

"BLD",9701,"KRN","B",8994,8994)

"BLD",9701,"QUES",0)
^9.62^^
"BLD",9701,"REQB",0)
^9.611^2^2
"BLD",9701,"REQB",1,0)
PSB*3.0*52^2
"BLD",9701,"REQB",2,0)
PSB*3.0*70^2
"BLD",9701,"REQB","B","PSB*3.0*52",1)

"BLD",9701,"REQB","B","PSB*3.0*70",2)

"FIA",53.78)
BCMA MEDICATION VARIANCE LOG
"FIA",53.78,0)
^PSB(53.78,
"FIA",53.78,0,0)
53.78PAO
"FIA",53.78,0,1)
y^y^p^^^^n^^n
"FIA",53.78,0,10)

"FIA",53.78,0,11)

"FIA",53.78,0,"RLRO")

"FIA",53.78,0,"VR")
3.0^PSB
"FIA",53.78,53.78)
1
"FIA",53.78,53.78,.07)

"MBREQ")
0
"PKG",550,-1)
1^1
"PKG",550,0)
BAR CODE MED ADMIN^PSB^BAR CODE MEDICATION ADMINISTRATION
"PKG",550,20,0)
^9.402P^^
"PKG",550,22,0)
^9.49I^1^1
"PKG",550,22,1,0)
3.0^3040224^3040311^66481
"PKG",550,22,1,"PAH",1,0)
80^3150218
"PKG",550,22,1,"PAH",1,1,0)
^^17^17^3150218
"PKG",550,22,1,"PAH",1,1,1,0)
This Patch Addresses 6 issues:
"PKG",550,22,1,"PAH",1,1,2,0)
 
"PKG",550,22,1,"PAH",1,1,3,0)
1. The Bar Code Medication Administration (BCMA) MEDICATION
"PKG",550,22,1,"PAH",1,1,4,0)
VARIANCE LOG (#53.78) file does not save data in DRUG SCANNED
"PKG",550,22,1,"PAH",1,1,5,0)
(#.07) field.
"PKG",550,22,1,"PAH",1,1,6,0)
2. BCMA stores the initials of the user who viewed the patient's record
"PKG",550,22,1,"PAH",1,1,7,0)
instead of the initials of the user who marked a Vital Entered in Error.
"PKG",550,22,1,"PAH",1,1,8,0)
3. The BCMA Unable to Scan Detailed report does not display any data
"PKG",550,22,1,"PAH",1,1,9,0)
when run for a Nursing Ward if the user running the report is logged into 
"PKG",550,22,1,"PAH",1,1,10,0)
a different division. 
"PKG",550,22,1,"PAH",1,1,11,0)
4. The BCMA Administration Times report does not display historical
"PKG",550,22,1,"PAH",1,1,12,0)
data when run by ward.
"PKG",550,22,1,"PAH",1,1,13,0)
5. The BCMA Clinical Reminders tab does not display that a PRN 
"PKG",550,22,1,"PAH",1,1,14,0)
Effectiveness is needed when the PRN is given on the same day as the 
"PKG",550,22,1,"PAH",1,1,15,0)
patient is admitted.
"PKG",550,22,1,"PAH",1,1,16,0)
6. The Unable to Scan detailed report does not display the full Health 
"PKG",550,22,1,"PAH",1,1,17,0)
Record Number (HRN) for Indian Health Services (IHS) sites.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","PSBCSUTL")
0^4^B184801061^B171997833
"RTN","PSBCSUTL",1,0)
PSBCSUTL ;BIRMINGHAM/TEJ- BCMA-HSC COVER SHEET UTILITIES ;11/15/12 2:40pm
"RTN","PSBCSUTL",2,0)
 ;;3.0;BAR CODE MED ADMIN;**16,13,38,32,50,60,58,68,70,80**;Mar 2004;Build 6
"RTN","PSBCSUTL",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBCSUTL",4,0)
 ;
"RTN","PSBCSUTL",5,0)
 ; Reference/IA
"RTN","PSBCSUTL",6,0)
 ; EN^PSJBCMA/2828
"RTN","PSBCSUTL",7,0)
 ; IN5^VADPT/10061
"RTN","PSBCSUTL",8,0)
 ; $$GET^XPAR/2263
"RTN","PSBCSUTL",9,0)
 ; ^%DTC/10000
"RTN","PSBCSUTL",10,0)
 ; $$FMADD^XLFDT/10103
"RTN","PSBCSUTL",11,0)
 ; $$GET1^DIQ/2056
"RTN","PSBCSUTL",12,0)
 ; EN1^GMVDCEXT/4251
"RTN","PSBCSUTL",13,0)
 ; GETPROVL^PSGSICH1/5653
"RTN","PSBCSUTL",14,0)
 ; INTRDIC^PSGSICH1/5654
"RTN","PSBCSUTL",15,0)
 ;
"RTN","PSBCSUTL",16,0)
 ;*58 - add 30th piece to Results for Override/Intervention flag 1/0
"RTN","PSBCSUTL",17,0)
 ;*68 - add new parameter to use new SI/OPI word processing fields
"RTN","PSBCSUTL",18,0)
 ;*70 - add Clinic order request IN param flag (true/false 0/1).
"RTN","PSBCSUTL",19,0)
 ;      also add to return array ORD line 32 piece Clinic name for CO.
"RTN","PSBCSUTL",20,0)
 ;      for CO mode: set to -7 days for pulling pull meds & viewing
"RTN","PSBCSUTL",21,0)
 ;       Expired/DC'd orders; set to +7 days to view future orders.
"RTN","PSBCSUTL",22,0)
 ;
"RTN","PSBCSUTL",23,0)
 ; ** Warning: PSBSIOPI & PSBCLINORD will be used as global variables
"RTN","PSBCSUTL",24,0)
 ;             for all down stream calls from this RPC tag.
"RTN","PSBCSUTL",25,0)
 ;
"RTN","PSBCSUTL",26,0)
RPC(RESULTS,DFN,EXPWIN,PSBSIOPI,PSBCLINORD) ;
"RTN","PSBCSUTL",27,0)
 K RESULTS,^TMP("PSB",$J),^TMP("PSJ",$J)
"RTN","PSBCSUTL",28,0)
 S EXPWIN=+$G(EXPWIN)       ;*70
"RTN","PSBCSUTL",29,0)
 S PSBSIOPI=+$G(PSBSIOPI)   ;*68 init to 0 if not present or 1 if sent
"RTN","PSBCSUTL",30,0)
 S PSBCLINORD=+$G(PSBCLINORD)                   ;*70 init to 0 if null
"RTN","PSBCSUTL",31,0)
 S PSBTAB="CVRSHT"
"RTN","PSBCSUTL",32,0)
 N PSBCNT S PSBTRFL=0,PSBDFNX=DFN
"RTN","PSBCSUTL",33,0)
 D PAINCMT(DFN) ;;Correct Comment if Pain Score entered in BCMA was marked "Entered in Error" in Vitals. (PSB*3*50)
"RTN","PSBCSUTL",34,0)
 S RESULTS=$NAME(^TMP("PSB",$J,PSBTAB))
"RTN","PSBCSUTL",35,0)
 K ^TMP("PSB",$J,PSBTAB) S ^TMP("PSB",$J,PSBTAB,0)=1 D LIGHTS(PSBDFNX)
"RTN","PSBCSUTL",36,0)
 S ^TMP("PSB",$J,PSBTAB,0)=1,^TMP("PSB",$J,PSBTAB,1)=^TMP("PSB",$J,PSBTAB,1)
"RTN","PSBCSUTL",37,0)
 Q:$P(^TMP("PSB",$J,PSBTAB,1),U,4)=-1
"RTN","PSBCSUTL",38,0)
 D NOW^%DTC S PSBNOW=+$E(%,1,10),PSBDT=$P(%,".",1)
"RTN","PSBCSUTL",39,0)
 ;set range
"RTN","PSBCSUTL",40,0)
 ;*70 - use diff window values for CO mode vs IM mode
"RTN","PSBCSUTL",41,0)
 I PSBCLINORD D
"RTN","PSBCSUTL",42,0)
 . S:'EXPWIN EXPWIN=24*7   ;not passed in def to 7 days
"RTN","PSBCSUTL",43,0)
 . S PSBWBEG=$P($$FMADD^XLFDT(PSBNOW,-EXPWIN\24),".")
"RTN","PSBCSUTL",44,0)
 . S PSBWEND=$P($$FMADD^XLFDT(PSBNOW,EXPWIN\24),".")
"RTN","PSBCSUTL",45,0)
 E  D
"RTN","PSBCSUTL",46,0)
 . S:'EXPWIN EXPWIN=24   ;not passed in def to 24 hr
"RTN","PSBCSUTL",47,0)
 . S PSBWBEG=$$FMADD^XLFDT(PSBNOW,"",-EXPWIN)
"RTN","PSBCSUTL",48,0)
 . S PSBWEND=$$FMADD^XLFDT(PSBNOW,"",EXPWIN)
"RTN","PSBCSUTL",49,0)
 ;
"RTN","PSBCSUTL",50,0)
 S PSBWADM=$$GET^XPAR("DIV","PSB ADMIN BEFORE"),PSBMHBCK=$$GET^XPAR("ALL","PSB MED HIST DAYS BACK",,"B") I +PSBMHBCK=0 S PSBMHBCK=30
"RTN","PSBCSUTL",51,0)
 D NOW^%DTC S PSBWADM=$$FMADD^XLFDT(%,"","",+PSBWADM),PSBMHBCK=$$FMADD^XLFDT(%,-1*(PSBMHBCK))
"RTN","PSBCSUTL",52,0)
 ;use lst movemnt for API
"RTN","PSBCSUTL",53,0)
 S VAIP("D")="LAST" D IN5^VADPT S PSBTRDT=+VAIP(3),PSBTRTYP=$P(VAIP(2),U,2),PSBMVTYP=$P(VAIP(4),U,2) K VAIP
"RTN","PSBCSUTL",54,0)
 S PSBPTTR=$$GET^XPAR("DIV","PSB PATIENT TRANSFER") I PSBPTTR="" S PSBPTTR=72
"RTN","PSBCSUTL",55,0)
 D NOW^%DTC S PSBNTDT=$$FMADD^XLFDT(%,"",-PSBPTTR) I PSBNTDT'>PSBTRDT S PSBTRFL=1
"RTN","PSBCSUTL",56,0)
 ;*70  go back 7 days to pull meds for clinic orders
"RTN","PSBCSUTL",57,0)
 S X1=$P(PSBNOW,"."),X2=$S(PSBCLINORD:-7,1:-3) D C^%DTC
"RTN","PSBCSUTL",58,0)
 D EN^PSJBCMA(PSBDFNX,X,$S(PSBMHBCK<PSBWBEG:PSBMHBCK,PSBWBEG<PSBMHBCK:PSBWBEG,1:PSBMHBCK))
"RTN","PSBCSUTL",59,0)
 ;Filter in/out Clinic Orders               *70
"RTN","PSBCSUTL",60,0)
 D:PSBCLINORD
"RTN","PSBCSUTL",61,0)
 . I $D(PSBRPT(2)) D FILTERCO^PSBO Q
"RTN","PSBCSUTL",62,0)
 . D INCLUDCO^PSBVDLU1
"RTN","PSBCSUTL",63,0)
 D:'PSBCLINORD REMOVECO^PSBVDLU1
"RTN","PSBCSUTL",64,0)
 ;Devlop Outp
"RTN","PSBCSUTL",65,0)
 S PSBTBOUT=0
"RTN","PSBCSUTL",66,0)
 I ^TMP("PSJ",$J,1,0)>0 F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:('PSBX)!(PSBTBOUT)  D
"RTN","PSBCSUTL",67,0)
 .S:(PSBTAB'="CVRSHT")&($G(^TMP("PSB",$J,"CVRSHT",2))>0) PSBTBOUT=1
"RTN","PSBCSUTL",68,0)
 .D CLEAN^PSBVT,PSJ^PSBVT(PSBX),NOW^%DTC
"RTN","PSBCSUTL",69,0)
 .Q:PSBONX["P"  Q:(PSBOSP<PSBWBEG)&'(PSBONX["V")  ;in rnge?
"RTN","PSBCSUTL",70,0)
 .S (PSBREC,PSBONTAB)=""
"RTN","PSBCSUTL",71,0)
 .S $P(PSBREC,U,1)=PSBDFN ;Dfn
"RTN","PSBCSUTL",72,0)
 .S $P(PSBREC,U,2)=PSBONX ;OrdX 
"RTN","PSBCSUTL",73,0)
 .S $P(PSBREC,U,3)=PSBON ;Ord#
"RTN","PSBCSUTL",74,0)
 .S $P(PSBREC,U,4)=PSBOTYP ;v/u/p
"RTN","PSBCSUTL",75,0)
 .S $P(PSBREC,U,5)=PSBSCHT ;Schtyp
"RTN","PSBCSUTL",76,0)
 .S $P(PSBREC,U,6)=PSBSCH ;Sch
"RTN","PSBCSUTL",77,0)
 .S $P(PSBREC,U,7)=$S(PSBHSM:"HSM",PSBSM:"SM",1:"") ; slfmed
"RTN","PSBCSUTL",78,0)
 .S $P(PSBREC,U,8)=PSBOITX ;Drgnm
"RTN","PSBCSUTL",79,0)
 .S $P(PSBREC,U,9)=PSBDOSE_" "_PSBIFR ;Dose
"RTN","PSBCSUTL",80,0)
 .S $P(PSBREC,U,10)=PSBMR ;med route
"RTN","PSBCSUTL",81,0)
 .;Lst Gvn -AOIP xRef
"RTN","PSBCSUTL",82,0)
 .S (PSBCNT,PSBFLAG)=0,(Y,PSBSTUS)="" K PSBHSTA,PSBHSTAX
"RTN","PSBCSUTL",83,0)
 .F XZ=1:1:20 S Y=$O(^PSB(53.79,"AOIP",PSBDFN,PSBOIT,Y),-1),(PSBCNT,PSBFLAG)=0 Q:Y=""  D
"RTN","PSBCSUTL",84,0)
 ..S:Y>0 $P(PSBREC,U,11)=Y
"RTN","PSBCSUTL",85,0)
 ..S X="" F  S X=$O(^PSB(53.79,"AOIP",PSBDFN,PSBOIT,Y,X),-1) Q:X=""  D
"RTN","PSBCSUTL",86,0)
 ...S PSBSTUS=$P(^PSB(53.79,X,0),U,9) S:$G(PSBSTUS)="" PSBSTUS="X" I (PSBSTUS'="N") S PSBFLAG=1,PSBHSTA(Y,$G(PSBSTUS))="ORIG"_U_X
"RTN","PSBCSUTL",87,0)
 ...D:PSBSTUS="N"
"RTN","PSBCSUTL",88,0)
 ....S ($P(PSBREC,U,11),Z)=""
"RTN","PSBCSUTL",89,0)
 ....F  S Z=$O(^PSB(53.79,X,.9,Z),-1) Q:'Z  Q:PSBFLAG=1  S PSBDATA=$G(^(Z,0)) D
"RTN","PSBCSUTL",90,0)
 .....I (PSBDATA["Set to 'NOT GIVEN'")!(PSBDATA["Set to 'GIVEN'")!(PSBDATA["Set to 'REFUSED'")!(PSBDATA["Set to 'HELD'")!(PSBDATA["Set to 'MISSING DOSE'")!(PSBDATA["Set to 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBCSUTL",91,0)
 .....I (PSBDATA["STATUS 'HELD'")!(PSBDATA["STATUS 'GIVEN'")!(PSBDATA["STATUS 'REFUSED'")!(PSBDATA["STATUS 'MISSING DOSE'")!(PSBDATA["STATUS 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBCSUTL",92,0)
 .....I PSBCNT#2=0,PSBDATA["'REFUSED'" S PSBSTUS="R" D LAST^PSBVDLU1
"RTN","PSBCSUTL",93,0)
 .....I PSBCNT#2=0,PSBDATA["'HELD'" S PSBSTUS="H" D LAST^PSBVDLU1
"RTN","PSBCSUTL",94,0)
 .....I PSBCNT#2=0,PSBDATA["'MISSING DOSE'" S PSBSTUS="M" D LAST^PSBVDLU1
"RTN","PSBCSUTL",95,0)
 .....I PSBCNT#2=0,PSBDATA["'REMOVED'" S PSBSTUS="RM" D LAST^PSBVDLU1
"RTN","PSBCSUTL",96,0)
 .....I PSBFLAG=1,'$D(PSBHSTA($P(PSBREC,U,11),$G(PSBSTUS))) S PSBHSTA($P(PSBREC,U,11),$G(PSBSTUS))=Z_U_X
"RTN","PSBCSUTL",97,0)
 .I $D(PSBHSTA) S $P(PSBREC,U,11)=$O(PSBHSTA(""),-1),PSBSTUS=$O(PSBHSTA($P(PSBREC,U,11),""),-1) M PSBHSTAX(PSBOIT)=PSBHSTA K PSBHSTA  ;last action date/time
"RTN","PSBCSUTL",98,0)
 .S $P(PSBREC,U,12)="" ;ien - below
"RTN","PSBCSUTL",99,0)
 .S $P(PSBREC,U,13)="" ;sttus - below
"RTN","PSBCSUTL",100,0)
 .S $P(PSBREC,U,14)="" ;admn dte - below
"RTN","PSBCSUTL",101,0)
 .S $P(PSBREC,U,15)=PSBOIT ;OI Pointer
"RTN","PSBCSUTL",102,0)
 .S $P(PSBREC,U,16)=PSBNJECT  ;njctble med route flag
"RTN","PSBCSUTL",103,0)
 .;Var dosg
"RTN","PSBCSUTL",104,0)
 .I $P(PSBREC,U,9)?1.4N1"-"1.4N.E S $P(PSBREC,U,17)=1
"RTN","PSBCSUTL",105,0)
 .E  S $P(PSBREC,U,17)=0
"RTN","PSBCSUTL",106,0)
 .S:PSBDOSEF?1"CAP".E!(PSBDOSEF?1"TAB".E)!(PSBDOSEF="PATCH") $P(PSBREC,U,18)=PSBDOSEF ;DosgFrm
"RTN","PSBCSUTL",107,0)
 .D PSJ1^PSBVT(PSBDFN,PSBONX)
"RTN","PSBCSUTL",108,0)
 .S PSBPB=$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,+$G(PSBIVPSH)),PSBLVIV=0
"RTN","PSBCSUTL",109,0)
 .Q:PSBPB&(PSBOSP<PSBWBEG)
"RTN","PSBCSUTL",110,0)
 .S:(PSBONX["V"&'PSBPB) PSBLVIV=1
"RTN","PSBCSUTL",111,0)
 .S $P(PSBREC,U,19)=$S(PSBVNI]"":PSBVNI,PSBVNI']"":"***") ;VerfNrsInts
"RTN","PSBCSUTL",112,0)
 .S $P(PSBREC,U,20)=PSBSTUS S:$P(PSBREC,U,11)="" $P(PSBREC,U,20)=""  ;LstActn
"RTN","PSBCSUTL",113,0)
 .S $P(PSBREC,U,21)=PSBOST
"RTN","PSBCSUTL",114,0)
 .S $P(PSBREC,U,22)=PSBOSTS
"RTN","PSBCSUTL",115,0)
 .S $P(PSBREC,U,25)=0 I $G(PSBTRFL),$P(PSBREC,U,11)]"",$P(PSBREC,U,11)'<$G(PSBNTDT),$P(PSBREC,U,11)'>$G(PSBTRDT) S $P(PSBREC,U,25)=1
"RTN","PSBCSUTL",116,0)
 .S $P(PSBREC,U,26)=PSBOSP  ;OrdStpDt/Tm
"RTN","PSBCSUTL",117,0)
 .S $P(PSBREC,U,27)=$$LASTG($P(PSBREC,U,1),$P(PSBREC,U,15))
"RTN","PSBCSUTL",118,0)
 .S $P(PSBREC,U,28)=$S((PSBONX["U")&('PSBPB):1,PSBPB:2,(PSBONX["V")&'PSBPB:3,1:"")
"RTN","PSBCSUTL",119,0)
 .;*58 determine if override exists, send 1/0 (true/false)
"RTN","PSBCSUTL",120,0)
 .N PSBARR D GETPROVL^PSGSICH1(DFN,PSBONX,.PSBARR)
"RTN","PSBCSUTL",121,0)
 .I $O(PSBARR(""))="" D INTRDIC^PSGSICH1(DFN,PSBONX,.PSBARR,2)
"RTN","PSBCSUTL",122,0)
 .S $P(PSBREC,U,29)=$S($O(PSBARR(""))]"":1,1:0)
"RTN","PSBCSUTL",123,0)
 .;*70 add Clinic name & ien ptr to piece 32 and 33 for CO's, remember
"RTN","PSBCSUTL",124,0)
 .;   "ORD" is inserted later as piece 1 which offsets all here by +1
"RTN","PSBCSUTL",125,0)
 .S $P(PSBREC,U,31)=$G(PSBCLORD)
"RTN","PSBCSUTL",126,0)
 .S $P(PSBREC,U,32)=$G(PSBCLIEN)
"RTN","PSBCSUTL",127,0)
 .;get all Admn(s) - DD info.
"RTN","PSBCSUTL",128,0)
 .S (PSBDDS,PSBSOLS,PSBADDS,PSBFLAG)="0"
"RTN","PSBCSUTL",129,0)
 .;PSB*3*60 adds additional checks to ensure an expired order is within the coversheet time parameter and an "END" is only added to the temp global after an order is added
"RTN","PSBCSUTL",130,0)
 .I PSBLVIV D XFERBAGS^PSBCSUTY,LVIV^PSBCSUTY I $G(PSBEXPRD) S X1=$O(^TMP("PSB",$J,PSBTAB,""),-1) S:^TMP("PSB",$J,PSBTAB,X1)'="END"&(X1>1) ^TMP("PSB",$J,PSBTAB,X1+1)="END" Q  ;PSB*3*60
"RTN","PSBCSUTL",131,0)
 .D GETADMX^PSBCSUTY
"RTN","PSBCSUTL",132,0)
 .F Y=0:0 S Y=$O(PSBDDA(Y)) Q:'Y  D
"RTN","PSBCSUTL",133,0)
 ..I $P(PSBDDA(Y),U,5)=$P(%,".") S PSBFLAG=1  ;drug nactvt
"RTN","PSBCSUTL",134,0)
 ..Q:$P(PSBDDA(Y),U,5)&($P(PSBDDA(Y),U,5)<%)  ;nactv
"RTN","PSBCSUTL",135,0)
 ..S:$P(PSBDDA(Y),U,4)="" $P(PSBDDA(Y),U,4)=1
"RTN","PSBCSUTL",136,0)
 ..S PSBDDS=PSBDDS_U_$P(PSBDDA(Y),U,1,4),$P(PSBDDS,U,1)=PSBDDS+1
"RTN","PSBCSUTL",137,0)
 .;OnCa O PRN
"RTN","PSBCSUTL",138,0)
 .I ("^O^OC^P^"[(U_PSBSCHT_U))!(PSBLVIV) D  S ($P(PSBREC,U,12),$P(PSBREC,U,14))=""  Q
"RTN","PSBCSUTL",139,0)
 ..S (PSBIENX,PSBGOT1)="",PSBADMTM="" F  S PSBADMTM=$O(^PSB(53.79,"AORDX",PSBDFNX,PSBONX,PSBADMTM)) Q:(PSBADMTM="")  D
"RTN","PSBCSUTL",140,0)
 ...Q:(PSBADMTM<PSBMHBCK)&'PSBLVIV
"RTN","PSBCSUTL",141,0)
 ...F  S PSBIENX=$O(^PSB(53.79,"AORDX",PSBDFNX,PSBONX,PSBADMTM,PSBIENX)) Q:PSBIENX=""  D
"RTN","PSBCSUTL",142,0)
 ....S $P(PSBREC,U,12)=PSBIENX,$P(PSBREC,U,14)=PSBADMTM,$P(PSBREC,U,23)=$$GET1^DIQ(53.79,PSBIENX_",","IV UNIQUE ID")
"RTN","PSBCSUTL",143,0)
 ....S PSBQRR=1 I PSBWBEG<PSBOSP D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBADMTM,PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") S PSBGOT1=1 ;PSB*3*60
"RTN","PSBCSUTL",144,0)
 ..I ('+PSBGOT1)&(PSBOSP'<PSBWBEG) D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1_".",PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") S PSBGOT1=1
"RTN","PSBCSUTL",145,0)
 ..I ('+PSBGOT1)&($D(PSBADMX(PSBONX)))&(PSBWBEG<PSBOSP) D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1_".",PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") ;PSB*3*60
"RTN","PSBCSUTL",146,0)
 ..S PSBGLBX=$O(^TMP("PSB",$J,PSBTAB,""),-1) S:^TMP("PSB",$J,PSBTAB,PSBGLBX)'="END"&(PSBGLBX>1) ^TMP("PSB",$J,PSBTAB,PSBGLBX+1)="END" ;PSB*3*60
"RTN","PSBCSUTL",147,0)
 .;cont - proces AdmnTm
"RTN","PSBCSUTL",148,0)
 .S (PSBYES,PSBODD,PSBYTF)=0 S:$$PSBDCHK1^PSBVT1(PSBSCH) PSBYES=1
"RTN","PSBCSUTL",149,0)
 .I PSBYES,PSBADST="" Q
"RTN","PSBCSUTL",150,0)
 .F I=1:1 Q:$P(PSBSCH,"-",I)=""  I $P(PSBSCH,"-",I)?2N!($P(PSBSCH,"-",I)?4N) S PSBYES=1,PSBYTF=1
"RTN","PSBCSUTL",151,0)
 .I PSBSCHT="C",PSBYTF="1",PSBADST="" Q
"RTN","PSBCSUTL",152,0)
 .S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX)
"RTN","PSBCSUTL",153,0)
 .I PSBFREQ="O" S PSBFREQ=1440
"RTN","PSBCSUTL",154,0)
 .I PSBFREQ="D" S PSBFREQ=""
"RTN","PSBCSUTL",155,0)
 .S:PSBLVIV PSBYES=1
"RTN","PSBCSUTL",156,0)
 .I 'PSBYES,PSBFREQ<1 Q
"RTN","PSBCSUTL",157,0)
 .I (PSBADST="")&(+PSBFREQ>0) D ODDSCH^PSBVDLU1(PSBTAB) Q
"RTN","PSBCSUTL",158,0)
 .I +PSBFREQ>0 I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODD=1
"RTN","PSBCSUTL",159,0)
 .I PSBODD,PSBADST'="" Q
"RTN","PSBCSUTL",160,0)
 .S PSBDTX=PSBWBEG\1,PSBGOT1=0
"RTN","PSBCSUTL",161,0)
 .F PSBXX=1:1:2 D  S PSBDTX=$$FMADD^XLFDT(PSBDTX,"",24)  ;incrmnt 1 day!
"RTN","PSBCSUTL",162,0)
 ..F PSBY=1:1:$L(PSBADST,"-") Q:$P(PSBADST,"-",PSBY)=""  D
"RTN","PSBCSUTL",163,0)
 ...S PSB=+(PSBDTX_"."_$P(PSBADST,"-",PSBY))
"RTN","PSBCSUTL",164,0)
 ...I (PSB'<PSBWBEG)&(PSB'>PSBWEND) D  ;wndow?
"RTN","PSBCSUTL",165,0)
 ....D:(PSB'<PSBOST)&(PSB<PSBOSP)    ;actv?
"RTN","PSBCSUTL",166,0)
 .....D:$$OKAY^PSBVDLU1(PSBOST,PSB,PSBSCH,PSBONX,PSBOITX,PSBFREQ,PSBOSTS)  ;dt?
"RTN","PSBCSUTL",167,0)
 ......D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") S PSBGOT1=1
"RTN","PSBCSUTL",168,0)
 ...S PSB=+(PSBWEND\1_"."_$P(PSBADST,"-",PSBY))
"RTN","PSBCSUTL",169,0)
 ...I (PSB'<PSBWBEG)&(PSB'>PSBWEND) D  ;wndow?
"RTN","PSBCSUTL",170,0)
 ....D:(PSB'<PSBOST)&(PSB<PSBOSP)    ;actv?
"RTN","PSBCSUTL",171,0)
 .....D:$$OKAY^PSBVDLU1(PSBOST,PSB,PSBSCH,PSBONX,PSBOITX,PSBFREQ,PSBOSTS)  ;dt?
"RTN","PSBCSUTL",172,0)
 ......D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") S PSBGOT1=1
"RTN","PSBCSUTL",173,0)
 .I ('PSBGOT1)&(PSBOSP'<PSBWBEG) D ADD^PSBVDLU1(PSBREC,PSBOTXT,+(PSBWEND\1_"."_$P(PSBADST,"-")),PSBDDS,PSBSOLS,PSBADDS,"CVRSHT")
"RTN","PSBCSUTL",174,0)
 .K PSBSTUS
"RTN","PSBCSUTL",175,0)
 D EN^PSBVDLPA
"RTN","PSBCSUTL",176,0)
 I $G(^TMP("PSB",$J,PSBTAB,2))]"" S PSBI1=$O(^TMP("PSB",$J,PSBTAB,""),-1) I ^TMP("PSB",$J,PSBTAB,PSBI1)'="END" S ^TMP("PSB",$J,PSBTAB,PSBI1+1)="END"
"RTN","PSBCSUTL",177,0)
 S ^TMP("PSB",$J,PSBTAB,0)=$O(^TMP("PSB",$J,PSBTAB,""),-1)
"RTN","PSBCSUTL",178,0)
 I $G(^TMP("PSB",$J,PSBTAB,2))']"" S $P(^TMP("PSB",$J,PSBTAB,1),U,4)="-1^No orders to display on Coversheet"     ;*70 was "To" now "to"
"RTN","PSBCSUTL",179,0)
 I $G(^TMP("PSB",$J,PSBTAB,2))]"" S $P(^TMP("PSB",$J,PSBTAB,1),U,4)="1^COVERSHEET DATA FOLLOWS" D ADD^PSBCSUTX
"RTN","PSBCSUTL",180,0)
 D CLEAN
"RTN","PSBCSUTL",181,0)
 Q
"RTN","PSBCSUTL",182,0)
LASTG(PSBPATPT,PSBOIPT) ;LstGvn-(inpt: DFN,OrItm IEN)
"RTN","PSBCSUTL",183,0)
 K PSBHSTG S Y="",LASTG="" F XZ=1:1:20 S Y=$O(^PSB(53.79,"AOIP",PSBPATPT,PSBOIPT,Y),-1),(PSBCNT,PSBFLAG)=0 Q:Y=""  D
"RTN","PSBCSUTL",184,0)
 .S:Y>0 LASTG="",X="" F  S X=$O(^PSB(53.79,"AOIP",PSBPATPT,PSBOIPT,Y,X),-1) Q:X=""  D
"RTN","PSBCSUTL",185,0)
 ..S PSBSTX=$P(^PSB(53.79,X,0),U,9) S:PSBSTX']"" PSBHSTG(Y)=-1 I PSBSTX="G"  S PSBHSTG(Y)="G"
"RTN","PSBCSUTL",186,0)
 ..Q:PSBSTX="N"
"RTN","PSBCSUTL",187,0)
 ..D:(PSBSTX'="G")
"RTN","PSBCSUTL",188,0)
 ...S Z="" F  S Z=$O(^PSB(53.79,X,.9,Z),-1) Q:'Z  Q:PSBFLAG=1  S PSBDATA=$G(^(Z,0)) D
"RTN","PSBCSUTL",189,0)
 ....I (PSBDATA["Set to 'GIVEN'") S PSBCNT=PSBCNT+1
"RTN","PSBCSUTL",190,0)
 ....I (PSBDATA["STATUS 'GIVEN'") S PSBCNT=PSBCNT+1
"RTN","PSBCSUTL",191,0)
 ....I PSBCNT#2=0,PSBDATA'["'GIVEN'" Q
"RTN","PSBCSUTL",192,0)
 ....I '$D(PSBHSTG($P(PSBDATA,U))) S PSBFLAG=1,PSBHSTG($P(PSBDATA,U))=""
"RTN","PSBCSUTL",193,0)
 I $D(PSBHSTG) S LASTG="" F  S LASTG=$O(PSBHSTG(LASTG),-1) Q:+LASTG=0  Q:PSBHSTG(LASTG)="G"  I PSBHSTG(LASTG)=-1 S LASTG="" Q
"RTN","PSBCSUTL",194,0)
 Q LASTG
"RTN","PSBCSUTL",195,0)
PAINCMT(DFN) ;;Add comment if Pain Score entered in BCMA was marked "Entered in Error" in Vitals.
"RTN","PSBCSUTL",196,0)
 ;;This will run through all the patients appointments, check their comments to see if they had a Pain Vital entered  through BCMA, and check if that Vital was marked "Entered in Error."
"RTN","PSBCSUTL",197,0)
 Q:'$D(^DPT(DFN,0))
"RTN","PSBCSUTL",198,0)
 N PSBCMT,PSBGMR,PSBCMTGLB,PSBIEN,PSBCMTM,PSBVITM,PSBTMDF,PSBBDT,PSBEDT,PSBEFTM,PSBCMFL,PSBEXTM,PSBERFL,PSBPNSC,PSBNOW,PSBDFN,PSBPRNDT,PSBSTRTDT,PSBMDHST,PSBEFFL,PSBCOMMENT,X,X1,X2,PSBDUZ,PSBPAIN
"RTN","PSBCSUTL",199,0)
 K ^TMP("PSBGMV",$J)
"RTN","PSBCSUTL",200,0)
 D NOW^%DTC S PSBEDT=%
"RTN","PSBCSUTL",201,0)
 S PSBMDHST=+($$GET^XPAR("ALL","PSB MED HIST DAYS BACK",,"B")) S:+$G(PSBMDHST)=0 PSBMDHST=30
"RTN","PSBCSUTL",202,0)
 S X1=$P(PSBEDT,"."),X2=-(PSBMDHST) D C^%DTC S PSBMDHST=X
"RTN","PSBCSUTL",203,0)
 S PSBSTRTDT=$S($G(PSBSTRT)]0:PSBSTRT,1:PSBMDHST)
"RTN","PSBCSUTL",204,0)
 S PSBPRNDT=PSBSTRTDT F  S PSBPRNDT=$O(^PSB(53.79,"APRN",DFN,PSBPRNDT)) Q:'PSBPRNDT  D
"RTN","PSBCSUTL",205,0)
 .S PSBIEN=0 F  S PSBIEN=$O(^PSB(53.79,"APRN",DFN,PSBPRNDT,PSBIEN)) Q:'PSBIEN  D
"RTN","PSBCSUTL",206,0)
 ..S PSBCMT=0 F  S PSBCMT=$O(^PSB(53.79,PSBIEN,.3,PSBCMT)) Q:'PSBCMT  S PSBCMTGLB=^PSB(53.79,PSBIEN,.3,PSBCMT,0) D
"RTN","PSBCSUTL",207,0)
 ...I $P($G(PSBCMTGLB),U)["Pain Score of" S PSBPAIN=$E($P(PSBCMTGLB,U),15) D
"RTN","PSBCSUTL",208,0)
 ....I $E($P($G(PSBCMTGLB),U),1,14)="*Pain Score of" S PSBCMFL=""
"RTN","PSBCSUTL",209,0)
 ....I $E($P($G(PSBCMTGLB),U),1,15)="**Pain Score of" S PSBEFFL=""
"RTN","PSBCSUTL",210,0)
 ....S PSBCMTM=$P($G(PSBCMTGLB),U,3)
"RTN","PSBCSUTL",211,0)
 ....S PSBBDT=$E(PSBCMTM,1,12)
"RTN","PSBCSUTL",212,0)
 ....S PSBEXTM=$$FMTE^XLFDT(PSBBDT,"5Z")
"RTN","PSBCSUTL",213,0)
 ....I '$D(^TMP("PSBGMV",$J)) D EN1^GMVDCEXT("^TMP(""PSBGMV"",$J)",DFN,2,,1,PSBSTRTDT,PSBEDT,,1)
"RTN","PSBCSUTL",214,0)
 ....S PSBGMR=0 F  S PSBGMR=$O(^TMP("PSBGMV",$J,PSBGMR)) Q:PSBGMR=""  I $P(^TMP("PSBGMV",$J,PSBGMR),U,4)="PN" D
"RTN","PSBCSUTL",215,0)
 .....S PSBVITM=$P(^TMP("PSBGMV",$J,PSBGMR),U,5)
"RTN","PSBCSUTL",216,0)
 .....S PSBTMDF=$$FMDIFF^XLFDT(PSBVITM,PSBCMTM,2)
"RTN","PSBCSUTL",217,0)
 .....I PSBTMDF>=-($S($G(DILOCKTM)>0:DILOCKTM,1:3)),PSBTMDF<=$S($G(DILOCKTM)>0:DILOCKTM,1:3) S PSBDUZ=$P(^TMP("PSBGMV",$J,PSBGMR),U,10) D  ;User who marked Pain Score Entered in error, PSB*3*80
"RTN","PSBCSUTL",218,0)
 ......I $P(^TMP("PSBGMV",$J,PSBGMR),U,9)=1 S PSBPNSC=$P(^TMP("PSBGMV",$J,PSBGMR),U,8),PSBERFL="" D
"RTN","PSBCSUTL",219,0)
 .......I $D(PSBERFL),'$D(PSBCMFL),$G(PSBDUZ),PSBPAIN=PSBPNSC D
"RTN","PSBCSUTL",220,0)
 ........S PSBCOMMENT="*Pain Score of "_PSBPNSC_" entered in Vitals via BCMA at "_PSBEXTM_" may have been marked 'Entered in Error'. See Vitals Package for an updated Score." D PNCMNT(PSBIEN,PSBCOMMENT,PSBDUZ) S PSBCMFL=""
"RTN","PSBCSUTL",221,0)
 ..K PSBCMFL,PSBERFL
"RTN","PSBCSUTL",222,0)
 ..S PSBEFTM=$P($G(^PSB(53.79,PSBIEN,.2)),U,4) Q:PSBEFTM=""
"RTN","PSBCSUTL",223,0)
 ..S PSBBDT=$E(PSBEFTM,1,12),PSBPAIN=$E($P(^PSB(53.79,PSBIEN,.2),U,2),15)
"RTN","PSBCSUTL",224,0)
 ..S PSBEXTM=$$FMTE^XLFDT(PSBBDT,"5Z")
"RTN","PSBCSUTL",225,0)
 ..D:'$D(^TMP("PSBGMV",$J)) EN1^GMVDCEXT("^TMP(""PSBGMV"",$J)",DFN,2,,1,PSBSTRTDT,PSBEDT,,1)
"RTN","PSBCSUTL",226,0)
 ..S PSBGMR=0 F  S PSBGMR=$O(^TMP("PSBGMV",$J,PSBGMR)) Q:PSBGMR=""  I $P(^TMP("PSBGMV",$J,PSBGMR),U,4)="PN" D
"RTN","PSBCSUTL",227,0)
 ...S PSBVITM=$P(^TMP("PSBGMV",$J,PSBGMR),U,5)
"RTN","PSBCSUTL",228,0)
 ...S PSBTMDF=$$FMDIFF^XLFDT(PSBVITM,PSBEFTM,2)
"RTN","PSBCSUTL",229,0)
 ...I PSBTMDF>=-($S($G(DILOCKTM)>0:DILOCKTM,1:3)),PSBTMDF<=$S($G(DILOCKTM)>0:DILOCKTM,1:3)  S PSBDUZ=$P(^TMP("PSBGMV",$J,PSBGMR),U,10) D  ;User who marked Pain Score Entered in error, PSB*3*80
"RTN","PSBCSUTL",230,0)
 ....I $P(^TMP("PSBGMV",$J,PSBGMR),U,9)=1 S PSBPNSC=$P(^TMP("PSBGMV",$J,PSBGMR),U,8),PSBERFL="" D
"RTN","PSBCSUTL",231,0)
 .....I $D(PSBERFL),'$D(PSBEFFL),$G(PSBDUZ),PSBPAIN=PSBPNSC D
"RTN","PSBCSUTL",232,0)
 ......S PSBCOMMENT="**Pain Score of "_PSBPNSC_" entered in Vitals via BCMA at "_PSBEXTM_" may have been marked 'Entered in Error'. See Vitals Package for an updated Score." D PNCMNT(PSBIEN,PSBCOMMENT,PSBDUZ) S PSBEFFL=""
"RTN","PSBCSUTL",233,0)
 ..K PSBERFL,PSBEFFL
"RTN","PSBCSUTL",234,0)
 K ^TMP("PSBGMV",$J)
"RTN","PSBCSUTL",235,0)
 Q
"RTN","PSBCSUTL",236,0)
PNCMNT(DA,PSBCMT,PSBDUZ) ;Add pain score comment, PSB*3*80
"RTN","PSBCSUTL",237,0)
 N PSBFDA,PSBIEN,PSBNOW
"RTN","PSBCSUTL",238,0)
 S PSBIEN="+1,"_DA_","
"RTN","PSBCSUTL",239,0)
 D NOW^%DTC S PSBNOW=%
"RTN","PSBCSUTL",240,0)
 D VAL^PSBML(53.793,PSBIEN,.01,PSBCMT)
"RTN","PSBCSUTL",241,0)
 S PSBFDA(53.793,PSBIEN,.02)=PSBDUZ
"RTN","PSBCSUTL",242,0)
 S PSBFDA(53.793,PSBIEN,.03)=PSBNOW
"RTN","PSBCSUTL",243,0)
 D FILEIT^PSBML
"RTN","PSBCSUTL",244,0)
 Q
"RTN","PSBCSUTL",245,0)
LIGHTS(PSBDFN) ;
"RTN","PSBCSUTL",246,0)
 D RPC^PSBVDLTB(,PSBDFN,"NO TAB",,PSBSIOPI,PSBCLINORD) S PSBTAB="CVRSHT"
"RTN","PSBCSUTL",247,0)
 M ^TMP("PSB",$J,PSBTAB,1)=^TMP("PSB",$J,"NO TAB",1) K ^TMP("PSB",$J,"NO TAB")
"RTN","PSBCSUTL",248,0)
 Q
"RTN","PSBCSUTL",249,0)
CLEAN ;
"RTN","PSBCSUTL",250,0)
 D CLEAN^PSBVT
"RTN","PSBCSUTL",251,0)
 K PSBACT,PSBACTBY,PSBACTDT,PSBACTPT,PSBADDS,PSBBAGID,PSBCHDT,PSBCHKV,PSBCNT1,PSBCNT2,PSBDDS,PSBDFNX,PSBWEND
"RTN","PSBCSUTL",252,0)
 K PSBDT,PSBFLAG,PSBHSTAX,PSBI1,PSBIEN,PSBIENX,PSBLSTS,PSBMAUD,PSBMVTYP,PSBMWC,PSBNOW,PSBNTDT,PSBONMBR,PSBY,PSBXX
"RTN","PSBCSUTL",253,0)
 K PSBONXS,PSBORREC,PSBPDT,PSBPRNRE,PSBPTTR,PSBQR,PSBRDOW,PSBREC,PSBRECHD,PSBSCHBR,PSBSCHTM,PSBSOLS,PSBTAB,PSBADMTM,PSBDTX
"RTN","PSBCSUTL",254,0)
 K PSBTBOUT,PSBTRDT,PSBTRFL,PSBTRTYP,PSBUID,PSBUIDS,PSBX,PSBXIEN,PSBX2,PSBYEA,PSBYEA1,PSBYTF,PSBYES,VAIP,PSBWADM,PSBWBEG
"RTN","PSBCSUTL",255,0)
 K PSBXREC,PSBGOT1,PSBCDT,PSBQUIT,PSBUSED,PSBLST4X,PSBADMX,PSBI2,PSBXXX,PSBI,PSBPB,PSBSHWTB,PSBONTAB,PSBDONE,^TMP("PSJ",$J)
"RTN","PSBCSUTL",256,0)
 K PSBNXTDU,LASTG,LSTTIME,PSBMHBCK,PSBHSTG,PSBNXTDT,NEXTADM,PSBLVIV
"RTN","PSBCSUTL",257,0)
 Q
"RTN","PSBOSF")
0^3^B221628856^B212704733
"RTN","PSBOSF",1,0)
PSBOSF ;BIRMINGHAM/EFC-UNABLE TO SCAN DETAIL REPORT ; 29 Aug 2008  11:33 PM
"RTN","PSBOSF",2,0)
 ;;3.0;BAR CODE MED ADMIN;**28,52,80**;Mar 2004;Build 6
"RTN","PSBOSF",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBOSF",4,0)
 ;
"RTN","PSBOSF",5,0)
 ; Reference/IA
"RTN","PSBOSF",6,0)
 ; ^NURSF(211.4/1409
"RTN","PSBOSF",7,0)
 ; WARD^NURSUT5/3052
"RTN","PSBOSF",8,0)
 ;
"RTN","PSBOSF",9,0)
EN ; UTS Report Entry Point - Report OPTION used by PSB UNABLE TO SCAN (UTS) key holders.
"RTN","PSBOSF",10,0)
 N PSBX1,PSBX2,PSBX3,PSBIEN,PSBMRGST,PSBHDR,PSBTOT,PSBDSCN
"RTN","PSBOSF",11,0)
 N PSBCMNT0,PSBCMNTX,PSBCMTLN,PSBCRLF,PSBI,PSBINDAT,PSBNDENT,PSBMRG,PSBX,I,J
"RTN","PSBOSF",12,0)
 K PSBSRTBY,PSBSTWD
"RTN","PSBOSF",13,0)
 ; Set Wards based on selection and user's Division - DUZ(2).
"RTN","PSBOSF",14,0)
 S PSBSTWD=$P(PSBRPT(.1),U,3) I $G(PSBSTWD)'="" K PSBWARD D LISTWD
"RTN","PSBOSF",15,0)
 K PSBWDDV D WARDDIV^PSBOST(.PSBWDDV,DUZ(2))
"RTN","PSBOSF",16,0)
 ; Set Start and End dates/times.
"RTN","PSBOSF",17,0)
 S PSBDTST=+$P(PSBRPT(.1),U,6)_$P(PSBRPT(.1),U,7)
"RTN","PSBOSF",18,0)
 S PSBDTSP=+$P(PSBRPT(.1),U,8)_$P(PSBRPT(.1),U,9)
"RTN","PSBOSF",19,0)
  ; Set the sort options internal values. If no sort option
"RTN","PSBOSF",20,0)
 ; selected, default to ascending date/time.
"RTN","PSBOSF",21,0)
 S PSBSRTBY=$G(PSBRPT(.52)) S:$G(PSBSRTBY)="" PSBSRTBY="2,,"
"RTN","PSBOSF",22,0)
 D NOW^%DTC S Y=% D DD^%DT S PSBDTTM=Y
"RTN","PSBOSF",23,0)
 ; Kill the scratch sort file.
"RTN","PSBOSF",24,0)
 K ^XTMP("PSBO",$J,"PSBLIST"),^TMP("PSBSF",$J),PSBLIST ;PSB*3*52 will now store report data in ^TMP("PSBSF",$J) instead of PSBOUTP array
"RTN","PSBOSF",25,0)
 S (PSBLNTOT,PSBTOT,PSBX1)="",PSBPGNUM=0
"RTN","PSBOSF",26,0)
 S PSBX1=$$FMADD^XLFDT(PSBDTST,,,,-.1)
"RTN","PSBOSF",27,0)
 ; Get the records from the MSF UTS log by date (PSBX1) and IEN (PSBX2).
"RTN","PSBOSF",28,0)
 F  S PSBX1=$O(^PSB(53.77,"ASFDT",PSBX1)) Q:(PSBX1>PSBDTSP)!(+PSBX1=0)  D
"RTN","PSBOSF",29,0)
 .S PSBX2="" F  S PSBX2=$O(^PSB(53.77,"ASFDT",PSBX1,PSBX2)) Q:PSBX2=""  D
"RTN","PSBOSF",30,0)
 ..; Don't report successful scans.
"RTN","PSBOSF",31,0)
 ..N PSBSCTYP S PSBSCTYP=$P(^PSB(53.77,PSBX2,0),U,5)
"RTN","PSBOSF",32,0)
 ..; Don't list successful scans.
"RTN","PSBOSF",33,0)
 ..I "WSCN,WKEY,MSCN,MKEY,MMME"[PSBSCTYP Q
"RTN","PSBOSF",34,0)
 ..I '$D(^PSB(53.77,PSBX2,0))!($D(PSBLIST(PSBX2))) Q
"RTN","PSBOSF",35,0)
 ..S PSBWRD=$P($P($G(^PSB(53.77,PSBX2,0)),U,3),"$",1)_"$"
"RTN","PSBOSF",36,0)
 ..; Filter data by institution.
"RTN","PSBOSF",37,0)
 ..I '$D(PSBWDDV(PSBWRD)),'$D(PSBWARD(+PSBSTWD,PSBWRD)) Q  ;Add check for report run by nursing ward, PSB*3*80 
"RTN","PSBOSF",38,0)
 ..I $G(PSBSTWD)]"",'$D(PSBWARD(PSBSTWD)) Q
"RTN","PSBOSF",39,0)
 ..I $G(PSBSTWD)]"",'$D(PSBWARD(PSBSTWD,PSBWRD)) Q
"RTN","PSBOSF",40,0)
 ..L +^PSB(53.77,PSBX2):3 I  L -^PSB(53.77,PSBX2) S PSBLIST(PSBX2)=""
"RTN","PSBOSF",41,0)
 S Y=PSBDTST D DD^%DT S Y1=Y S Y=PSBDTSP D DD^%DT S Y2=Y
"RTN","PSBOSF",42,0)
 ; Create the Sort Option Header text.
"RTN","PSBOSF",43,0)
 F X=1:1:3 D
"RTN","PSBOSF",44,0)
 .S PSBHDR=$G(PSBHDR)_$S($P(PSBSRTBY,",",X)=1:"PATIENT'S NAME; ",$P(PSBSRTBY,",",X)=2:"DATE/TIME of UTS (ascending); ",$P(PSBSRTBY,",",X)=3:"LOCATION WARD/RmBd; ",1:"")
"RTN","PSBOSF",45,0)
 .S PSBHDR=$G(PSBHDR)_$S($P(PSBSRTBY,",",X)=4:"TYPE; ",$P(PSBSRTBY,",",X)=5:"DRUG; ",$P(PSBSRTBY,",",X)=6:"USER'S NAME; ",1:"")
"RTN","PSBOSF",46,0)
 .S PSBHDR=$G(PSBHDR)_$S($P(PSBSRTBY,",",X)=7:"REASON UNABLE TO SCAN; ",$P(PSBSRTBY,",",X)=-2:"DATE/TIME of UTS (descending); ",1:"")
"RTN","PSBOSF",47,0)
 .Q
"RTN","PSBOSF",48,0)
 S PSBHDR=$E(PSBHDR,1,($L(PSBHDR)-2))
"RTN","PSBOSF",49,0)
 ; Add the record to the scratch sort file.
"RTN","PSBOSF",50,0)
 D BLDRPT
"RTN","PSBOSF",51,0)
 I PSBTOT=0 S ^TMP("PSBSF",$J,0,14)="W !!,""<<<< NO DOCUMENTED BCMA UNABLE TO SCAN EVENTS FOR THIS DATE RANGE >>>>"",!!"
"RTN","PSBOSF",52,0)
 ;
"RTN","PSBOSF",53,0)
 ; Send the report.
"RTN","PSBOSF",54,0)
 D WRTRPT
"RTN","PSBOSF",55,0)
 K %,O,PSBBLANK,PSBDTSP,PSBDTST,PSBDTTM
"RTN","PSBOSF",56,0)
 K PSBFLD,PSBLNO,PSBLNTOT,PSBMORE
"RTN","PSBOSF",57,0)
 K PSBPG,PSBPGNUM,PSBPGRM,PSBRPT,PSBSFCMT,PSBSFHD2,PSBSRTBY,PSBSRTNM
"RTN","PSBOSF",58,0)
 K PSBSTWD,PSBCMNT0,PSBTAB0,PSBTAB4,PSBTAB7,PSBTOT1,PSBTOTX,PSBVAL
"RTN","PSBOSF",59,0)
 K PSBVAL1,PSBVAL2,PSBVAL3,PSBWARD,PSBWRD,PSBXORX,XX,Y1,Y2,YY,ZZ
"RTN","PSBOSF",60,0)
 Q
"RTN","PSBOSF",61,0)
 ;
"RTN","PSBOSF",62,0)
BLDRPT ; Compile the report.
"RTN","PSBOSF",63,0)
 S PSBPGNUM="",PSBX3="" D CREATHDR
"RTN","PSBOSF",64,0)
 S PSBPGNUM=1,PSBTOT1=0
"RTN","PSBOSF",65,0)
 I '$D(^XUSEC("PSB UNABLE TO SCAN",DUZ)) D  Q
"RTN","PSBOSF",66,0)
 .S ^TMP("PSBSF",$J,0,14)="W !!,""<<<< BCMA UNABLE TO SCAN REPORTS HAVE RESTRICTED ACCESS >>>>"",!!"
"RTN","PSBOSF",67,0)
 I '$D(PSBSFHD1) D  Q
"RTN","PSBOSF",68,0)
 .S ^TMP("PSBSF",$J,0,14)="W !!,""<<<< Print format NOT SUPPORTED.  80&132 col formats ARE supported. >>>>"",!!"
"RTN","PSBOSF",69,0)
 I '$D(PSBLIST) D  Q
"RTN","PSBOSF",70,0)
 .S ^TMP("PSBSF",$J,0,14)="W !!,""<<<< NO DOCUMENTED BCMA UNABLE TO SCAN EVENTS FOR THIS DATE RANGE >>>>"",!!"
"RTN","PSBOSF",71,0)
 ;
"RTN","PSBOSF",72,0)
 ; Extract the data for the list of records.
"RTN","PSBOSF",73,0)
 F  S PSBX3=$O(PSBLIST(PSBX3))  Q:+PSBX3=0  K PSBDATA D
"RTN","PSBOSF",74,0)
 .;
"RTN","PSBOSF",75,0)
 .; Patient's Name (VAID)
"RTN","PSBOSF",76,0)
 .I $P(^PSB(53.77,PSBX3,0),U,2)]"" D
"RTN","PSBOSF",77,0)
 ..N DFN,VA,VADM S DFN=$P(^PSB(53.77,PSBX3,0),U,2)
"RTN","PSBOSF",78,0)
 ..D DEM^VADPT,PID^VADPT
"RTN","PSBOSF",79,0)
 ..S PSBDATA(1)=VADM(1),PSBDATA(1,0)="("_$S(DUZ("AG")="I":(VA("PID")),1:$E(VA("PID"),$L(VA("PID"))-3,999))_")" ;Add code to send full HRN for IHS sites, PSB*3*80
"RTN","PSBOSF",80,0)
 .;
"RTN","PSBOSF",81,0)
 .; Scan Failure Date/Time
"RTN","PSBOSF",82,0)
 .S PSBINDAT=$$GET1^DIQ(53.77,PSBX3_",",.04,"I"),Y=PSBINDAT D DD^%DT
"RTN","PSBOSF",83,0)
 .S PSBDATA(2)=$TR($P(Y,"@")," "),PSBDATA(2,0)="@"_$P(Y,"@",2)
"RTN","PSBOSF",84,0)
 .;
"RTN","PSBOSF",85,0)
 .; UTS Location
"RTN","PSBOSF",86,0)
 .S PSBDATA(3)=$P($$GET1^DIQ(53.77,PSBX3_",",.03),"$"),PSBDATA(3,0)="/"_($P($$GET1^DIQ(53.77,PSBX3_",",.03),"$",2))
"RTN","PSBOSF",87,0)
 .;
"RTN","PSBOSF",88,0)
 .; UTS Type - Get the parameter from File #53.69, compare it to the value below,and quit if not compatible.
"RTN","PSBOSF",89,0)
 .S PSBDATA(4)=$S($E($P($$GET1^DIQ(53.77,PSBX3_",",.05)," "),1)="M":"MED",$E($P($$GET1^DIQ(53.77,PSBX3_",",.05)," "),1)="W":"WRIST")
"RTN","PSBOSF",90,0)
 .I $P($G(PSBRPT(3)),",",1)=1&(PSBDATA(4)="WRIST") Q
"RTN","PSBOSF",91,0)
 .I $P($G(PSBRPT(3)),",",1)=2&(PSBDATA(4)="MED") Q
"RTN","PSBOSF",92,0)
 .;
"RTN","PSBOSF",93,0)
 .; Drug (IEN)
"RTN","PSBOSF",94,0)
 .S (PSBDATA(5),PSBDATA(5,0))=""
"RTN","PSBOSF",95,0)
 .F PSBI=2,3,4 I $D(^PSB(53.77,PSBX3,PSBI,1,0)) S PSBDATA(5,0)="("_$P(^PSB(53.77,PSBX3,PSBI,1,0),U)_")",PSBDATA(5)=$P(^PSB(53.77,PSBX3,PSBI,1,0),U,2) Q
"RTN","PSBOSF",96,0)
 .I $$GET1^DIQ(53.77,PSBX3_",",13)["WS" S PSBDATA(4,0)="(WS)",PSBDATA(5,0)="("_$$GET1^DIQ(53.77,PSBX3_",",13)_")",PSBDATA(5)=$P(^PSB(53.77,PSBX3,5),U,2)
"RTN","PSBOSF",97,0)
 .I $$GET1^DIQ(53.77,PSBX3_",",13)]"",$$GET1^DIQ(53.77,PSBX3_",",13)'["WS" D
"RTN","PSBOSF",98,0)
 ..S PSBDATA(4,0)="(UID)",PSBDATA(5,0)="("_$$GET1^DIQ(53.77,PSBX3_",",13)_")",PSBDATA(5)=$$GET1^DIQ(53.77,PSBX3_",",15)
"RTN","PSBOSF",99,0)
 .S:PSBDATA(5)="" PSBDATA(5)=" " S:PSBDATA(5,0)="" PSBDATA(5.0)=" "
"RTN","PSBOSF",100,0)
 .;
"RTN","PSBOSF",101,0)
 .; User Name
"RTN","PSBOSF",102,0)
 .S PSBDATA(6)=$$GET1^DIQ(53.77,PSBX3_",",.01)
"RTN","PSBOSF",103,0)
 .;
"RTN","PSBOSF",104,0)
 .; UTS Reason - Get the parameter from File #53.69. Quit if defined and '= reason.
"RTN","PSBOSF",105,0)
 .S PSBDATA(7)=$$GET1^DIQ(53.77,PSBX3_",",.06)
"RTN","PSBOSF",106,0)
 .I $P($G(PSBRPT(3)),",",2)=1&(PSBDATA(7)'="Damaged Medication Label") Q
"RTN","PSBOSF",107,0)
 .I $P($G(PSBRPT(3)),",",2)=2&(PSBDATA(7)'="Damaged Wristband") Q
"RTN","PSBOSF",108,0)
 .I $P($G(PSBRPT(3)),",",2)=3&(PSBDATA(7)'="No Bar Code") Q
"RTN","PSBOSF",109,0)
 .I $P($G(PSBRPT(3)),",",2)=4&(PSBDATA(7)'="Scanning Equipment Failure") Q
"RTN","PSBOSF",110,0)
 .I $P($G(PSBRPT(3)),",",2)=5&(PSBDATA(7)'="Unable to Determine") Q
"RTN","PSBOSF",111,0)
 .I $P($G(PSBRPT(3)),",",2)=6&(PSBDATA(7)'="Dose Discrepancy") Q
"RTN","PSBOSF",112,0)
 .;
"RTN","PSBOSF",113,0)
 .; Create sort subscripts.
"RTN","PSBOSF",114,0)
 .S (PSBDATA(0),PSBIEN)=PSBX3
"RTN","PSBOSF",115,0)
 .;
"RTN","PSBOSF",116,0)
SORT     .; Sort the line.
"RTN","PSBOSF",117,0)
 .; Sort Option internal values:
"RTN","PSBOSF",118,0)
 .;    1=PATIENT'S NAME
"RTN","PSBOSF",119,0)
 .;    2=DATE/TIME OF SCAN FAILURE (ascending)
"RTN","PSBOSF",120,0)
 .;    3=LOCATION WARD/RmBd
"RTN","PSBOSF",121,0)
 .;    4=TYPE
"RTN","PSBOSF",122,0)
 .;    5=DRUG
"RTN","PSBOSF",123,0)
 .;    6=USER'S NAME
"RTN","PSBOSF",124,0)
 .;    7=UNABLE TO SCAN REASON
"RTN","PSBOSF",125,0)
 .;   -2=DATE/TIME OF SCAN FAILURE (descending)
"RTN","PSBOSF",126,0)
 .;
"RTN","PSBOSF",127,0)
 .; Count how many sort options were selected.
"RTN","PSBOSF",128,0)
 .F X=0:1:2 Q:$P(PSBSRTBY,",",X+1)=""  S PSBSRTNM=X+1
"RTN","PSBOSF",129,0)
 .;
"RTN","PSBOSF",130,0)
 .; Add current line to sort file using the sort option data as the
"RTN","PSBOSF",131,0)
 .; record's file subscripts. Convert commas in the data to a $ in
"RTN","PSBOSF",132,0)
 .; case the data (PSBX2) is one of the sort keys.
"RTN","PSBOSF",133,0)
 .S (PSBX1,PSBX2)="",PSBMRG="^XTMP(""PSBO"",$J,""PSBLIST"""
"RTN","PSBOSF",134,0)
 .F X=1:1:PSBSRTNM S PSBX1=$P(PSBSRTBY,",",X) Q:PSBX1=""  S PSBDSCN="" D
"RTN","PSBOSF",135,0)
 ..I PSBX1=2!(PSBX1=-2) S:PSBX1=-2 PSBDSCN="-" S PSBX2=PSBINDAT D
"RTN","PSBOSF",136,0)
 ...I PSBSRTNM>1,X=1!(X=2) S PSBX2=$P(PSBINDAT,".")
"RTN","PSBOSF",137,0)
 ...S PSBX2=PSBDSCN_PSBX2
"RTN","PSBOSF",138,0)
 ..I PSBX1'=2&(PSBX1'=-2) S PSBX2=PSBDATA(PSBX1),PSBX2=$TR(PSBX2,",","$")
"RTN","PSBOSF",139,0)
 ..S PSBMRG=PSBMRG_","_""""_PSBX2_""""
"RTN","PSBOSF",140,0)
 .S PSBMRG=PSBMRG_","_PSBIEN_")" M @PSBMRG=PSBDATA
"RTN","PSBOSF",141,0)
 .S PSBTOT=PSBTOT+1 I +PSBTOT=0 K PSBLIST,^XTMP("PSBO",$J,"PSBLIST")
"RTN","PSBOSF",142,0)
 ; Retrieve the sorted records.
"RTN","PSBOSF",143,0)
 ; Set sort file root.
"RTN","PSBOSF",144,0)
 S PSBMRG="^XTMP(""PSBO"",$J,""PSBLIST"")"
"RTN","PSBOSF",145,0)
 ; Work through the sort file zero node for each scan event and load the data into
"RTN","PSBOSF",146,0)
 ; the local array PSBDATA.
"RTN","PSBOSF",147,0)
 F  S PSBMRG=$Q(@PSBMRG) Q:PSBMRG=""!($P(PSBMRG,",")'["PSBO")!($P(PSBMRG,",",2)'=$J)  D
"RTN","PSBOSF",148,0)
 .K PSBRPLN,PSBCMNT1,PSBCMNT2,PSBCMNT3 S PSBX1=$P(PSBMRG,",",PSBSRTNM+4)
"RTN","PSBOSF",149,0)
 .;
"RTN","PSBOSF",150,0)
 .; Get comment. Skip the comment parsing if no comment.
"RTN","PSBOSF",151,0)
 .S PSBSFCMT=$G(^PSB(53.77,PSBX1,1)),PSBCMNTX="COMMENT: "_PSBSFCMT,PSBNDENT=" "
"RTN","PSBOSF",152,0)
 .S $E(PSBCMNT0,PSBTAB7)="|"
"RTN","PSBOSF",153,0)
 .I PSBCMNTX="COMMENT: " S PSBCMNT1=PSBCMNTX G CONSTR
"RTN","PSBOSF",154,0)
 .;
"RTN","PSBOSF",155,0)
 .; Replace any quotes in comment.
"RTN","PSBOSF",156,0)
 .I $F(PSBCMNTX,"""")>0 S PSBCMNTX=$TR(PSBCMNTX,"""","'")
"RTN","PSBOSF",157,0)
 .;
"RTN","PSBOSF",158,0)
 .; # of lines needed to parse comment.
"RTN","PSBOSF",159,0)
 .S PSBCMTLN=$L(PSBCMNTX)\PSBTAB7+($L(PSBCMNTX)#PSBTAB7>0)
"RTN","PSBOSF",160,0)
 .;
"RTN","PSBOSF",161,0)
 .; Parse and wrap the comment by space character. Treat consecutive spaces
"RTN","PSBOSF",162,0)
 .; as one space. Treat a "!~" sequence as a forced CRLF token from GUI.
"RTN","PSBOSF",163,0)
 .; PSBTAB7 is the report width based on the user's device.
"RTN","PSBOSF",164,0)
 .; If "!~" CRLF token sent by GUI, separate the system comment from the user comment.
"RTN","PSBOSF",165,0)
 .S PSBX=$F(PSBCMNTX,"!~"),PSBCRLF=0 I PSBX>0 S PSBCRLF=1 D
"RTN","PSBOSF",166,0)
 ..S PSBCMNT1=$E(PSBCMNTX,1,PSBX-3),PSBCMNTX=$E(PSBCMNTX,PSBX,999)
"RTN","PSBOSF",167,0)
 .;
"RTN","PSBOSF",168,0)
 .; Wrap the system comment if needed.
"RTN","PSBOSF",169,0)
 .I PSBCRLF=1,$L(PSBCMNT1)>PSBTAB7 D
"RTN","PSBOSF",170,0)
 ..S PSBCMNT2=PSBNDENT
"RTN","PSBOSF",171,0)
 ..F PSBI=1:1:$L(PSBCMNT1," ") I $L($P(PSBCMNT1," ",1,PSBI))>PSBTAB7 D  Q
"RTN","PSBOSF",172,0)
 ...S PSBCMNT2=PSBCMNT2_$P(PSBCMNT1," ",PSBI,999)
"RTN","PSBOSF",173,0)
 ...S PSBCMNT1=$P(PSBCMNT1," ",1,PSBI-1)
"RTN","PSBOSF",174,0)
 ..S PSBCRLF=2
"RTN","PSBOSF",175,0)
 .;
"RTN","PSBOSF",176,0)
 .; If no space character in user comment, insert a space in the comment
"RTN","PSBOSF",177,0)
 .; based on line length in PSBTAB7.
"RTN","PSBOSF",178,0)
 .I $E(PSBCMNTX,10,999)'[" " S PSBCMNTX=$E(PSBCMNTX,1,PSBTAB7-15)_" "_$E(PSBCMNTX,PSBTAB7-14,999)
"RTN","PSBOSF",179,0)
 .;
"RTN","PSBOSF",180,0)
 .; Wrap the comment into multiple lines if needed.
"RTN","PSBOSF",181,0)
 .S PSBLNO=1+PSBCRLF F PSBI=1:1:$L(PSBCMNTX," ") D
"RTN","PSBOSF",182,0)
 ..I PSBCRLF,PSBLNO>1,$G(@("PSBCMNT"_PSBLNO))="" S @("PSBCMNT"_PSBLNO)=PSBNDENT
"RTN","PSBOSF",183,0)
 ..S PSBX=$P(PSBCMNTX," ",PSBI) Q:PSBX=""  ; Don't wrap for contiguous spaces.
"RTN","PSBOSF",184,0)
 ..D
"RTN","PSBOSF",185,0)
 ...I $L($G(@("PSBCMNT"_PSBLNO)))+$L(PSBX)'>PSBTAB7 S @("PSBCMNT"_PSBLNO)=$G(@("PSBCMNT"_PSBLNO))_PSBX_" " Q
"RTN","PSBOSF",186,0)
 ...S PSBLNO=PSBLNO+1,@("PSBCMNT"_PSBLNO)=PSBNDENT_PSBX_" "
"RTN","PSBOSF",187,0)
 .;
"RTN","PSBOSF",188,0)
CONSTR   .; Construct output from UTS event record.
"RTN","PSBOSF",189,0)
 .S PSBTOT1=PSBTOT1+1,PSBTOTX=PSBBLANK,$E(PSBTOTX,0,$L(PSBTOT1_".")-1)=PSBTOT1_"."
"RTN","PSBOSF",190,0)
 .S PSBXORX=$$GET1^DIQ(53.77,PSBX1_",",.08)
"RTN","PSBOSF",191,0)
 .I PSBXORX]"" S PSBXORX="ORD#: "_PSBXORX,$E(PSBTOTX,PSBTAB4+2,PSBTAB4+2+($L(PSBXORX)-1))=PSBXORX
"RTN","PSBOSF",192,0)
 .K PSBDATA M PSBDATA=@($P(PSBMRG,",",1,PSBSRTNM+4)_")")
"RTN","PSBOSF",193,0)
 .D BUILDLN
"RTN","PSBOSF",194,0)
 .S ^TMP("PSBSF",$J,$$PGTOT,PSBLNTOT)="W """_PSBTOTX_""""
"RTN","PSBOSF",195,0)
 .F I=1:1:10 Q:'$D(PSBRPLN(I))  D
"RTN","PSBOSF",196,0)
 ..F J=1:1:7 S $E(PSBRPLN(I),@("PSBTAB"_J))="|"
"RTN","PSBOSF",197,0)
 ..S ^TMP("PSBSF",$J,$$PGTOT,PSBLNTOT)="W !,"""_PSBRPLN(I)_""""
"RTN","PSBOSF",198,0)
 .S $E(PSBCMNT1,PSBTAB7)="|"
"RTN","PSBOSF",199,0)
 .I $D(PSBCMNT2) S $E(PSBCMNT2,PSBTAB7)="|"
"RTN","PSBOSF",200,0)
 .I $D(PSBCMNT3) S $E(PSBCMNT3,PSBTAB7)="|"
"RTN","PSBOSF",201,0)
 .S ^TMP("PSBSF",$J,$$PGTOT,PSBLNTOT)="W !,"""_PSBCMNT0_""""
"RTN","PSBOSF",202,0)
 .S ^TMP("PSBSF",$J,$$PGTOT,PSBLNTOT)="W !,"""_PSBCMNT1_""""
"RTN","PSBOSF",203,0)
 .I $D(PSBCMNT2) S ^TMP("PSBSF",$J,$$PGTOT,PSBLNTOT)="W !,"""_PSBCMNT2_""""
"RTN","PSBOSF",204,0)
 .I $D(PSBCMNT3) S ^TMP("PSBSF",$J,$$PGTOT,PSBLNTOT)="W !,"""_PSBCMNT3_""""
"RTN","PSBOSF",205,0)
 .S ^TMP("PSBSF",$J,$$PGTOT(2),PSBLNTOT)="W !,$TR($J("""",PSBTAB7),"" "",""-""),!"
"RTN","PSBOSF",206,0)
 .;
"RTN","PSBOSF",207,0)
 .; Force a skip to the next record's zero node.
"RTN","PSBOSF",208,0)
 .S $P(PSBMRG,",",PSBSRTNM+5)="999999)"
"RTN","PSBOSF",209,0)
 ;
"RTN","PSBOSF",210,0)
 K PSBRPLN,PSBCMNT1,PSBCMNT2,PSBCMNT3
"RTN","PSBOSF",211,0)
 Q
"RTN","PSBOSF",212,0)
 ;
"RTN","PSBOSF",213,0)
BUILDLN  ; Construct records
"RTN","PSBOSF",214,0)
 K LN,J F PSBFLD=1:1:7 D FORMDAT(PSBFLD) S LN(J)="" K J
"RTN","PSBOSF",215,0)
 Q
"RTN","PSBOSF",216,0)
 ;
"RTN","PSBOSF",217,0)
FORMDAT(FLD) ; Format the data.
"RTN","PSBOSF",218,0)
 S J=3,PSBVAL=PSBDATA(FLD),PSBVAL(0)="" I $D(PSBDATA(FLD,0)) S PSBVAL(0)=PSBDATA(FLD,0)
"RTN","PSBOSF",219,0)
 I IOM'>90 S XX=@("PSBTAB"_(FLD-1))+1,YY=(@("PSBTAB"_FLD)-1)-XX,ZZ=PSBVAL_" "_PSBVAL(0) D  Q
"RTN","PSBOSF",220,0)
 .S O=$$WRAPPER(XX,YY,ZZ)
"RTN","PSBOSF",221,0)
 I ($L(PSBVAL)+(@("PSBTAB"_(FLD-1))))<(@("PSBTAB"_FLD)-1) D  Q
"RTN","PSBOSF",222,0)
 .F PSBI=$L(PSBVAL)+(@("PSBTAB"_(FLD-1))):1:(@("PSBTAB"_FLD)-3) S PSBVAL=PSBVAL_" "
"RTN","PSBOSF",223,0)
 .S $E(PSBRPLN(1),@("PSBTAB"_(FLD-1))+2,(@("PSBTAB"_FLD)-1))=PSBVAL
"RTN","PSBOSF",224,0)
 .F PSBI=$L(PSBVAL(0))+(@("PSBTAB"_(FLD-1))):1:(@("PSBTAB"_FLD)-3) S PSBVAL(0)=PSBVAL(0)_" "
"RTN","PSBOSF",225,0)
 .S $E(PSBRPLN(2),@("PSBTAB"_(FLD-1))+2,(@("PSBTAB"_FLD)-1))=PSBVAL(0)
"RTN","PSBOSF",226,0)
 I ($L(PSBVAL)+(@("PSBTAB"_(FLD-1))))'<(@("PSBTAB"_FLD)-1) D  Q
"RTN","PSBOSF",227,0)
 .I $F(PSBVAL,",")>1 S PSBVAL1=$E(PSBVAL,1,$F(PSBVAL,",")-1),PSBVAL2=$E(PSBVAL,$F(PSBVAL,","),999)
"RTN","PSBOSF",228,0)
 .E  S PSBVAL1=$E(PSBVAL,1,$F(PSBVAL," ")-1),PSBVAL2=$E(PSBVAL,$F(PSBVAL," "),999)
"RTN","PSBOSF",229,0)
 .F PSBI=$L(PSBVAL1)+(@("PSBTAB"_(FLD-1))):1:(@("PSBTAB"_FLD)-3) S PSBVAL1=PSBVAL1_" "
"RTN","PSBOSF",230,0)
 .I $D(PSBVAL2) I ($L(PSBVAL2)+(@("PSBTAB"_(FLD-1))))'<(@("PSBTAB"_FLD)-1) D
"RTN","PSBOSF",231,0)
 ..S PSBVAL3=$E(PSBVAL2,$F(PSBVAL2," "),999),PSBVAL2=$E(PSBVAL2,1,$F(PSBVAL2," ")-1)
"RTN","PSBOSF",232,0)
 ..F PSBI=$L(PSBVAL3)+(@("PSBTAB"_(FLD-1))):1:(@("PSBTAB"_FLD)-3) S PSBVAL3=PSBVAL3_" "
"RTN","PSBOSF",233,0)
 ..S $E(PSBRPLN(3),@("PSBTAB"_(FLD-1))+2,(@("PSBTAB"_FLD)-1))=PSBVAL3
"RTN","PSBOSF",234,0)
 .I ($L(PSBVAL1)+(@("PSBTAB"_(FLD-1))))>(@("PSBTAB"_FLD)-2) D
"RTN","PSBOSF",235,0)
 ..S PSBVAL2=($E(PSBVAL1,(@("PSBTAB"_FLD)-1)-(@("PSBTAB"_(FLD-1))),999))_PSBVAL2
"RTN","PSBOSF",236,0)
 ..S PSBVAL1=$E(PSBVAL1,1,(((@("PSBTAB"_FLD)-1))-(@("PSBTAB"_(FLD-1))+1)))
"RTN","PSBOSF",237,0)
 .S $E(PSBRPLN(1),@("PSBTAB"_(FLD-1))+2,(@("PSBTAB"_FLD)-1))=PSBVAL1
"RTN","PSBOSF",238,0)
 .F PSBI=$L(PSBVAL2)+(@("PSBTAB"_(FLD-1))):1:(@("PSBTAB"_FLD)-3) S PSBVAL2=PSBVAL2_" "
"RTN","PSBOSF",239,0)
 .S $E(PSBRPLN(2),@("PSBTAB"_(FLD-1))+2,(@("PSBTAB"_FLD)-1))=$E(PSBVAL2,1,((@("PSBTAB"_FLD)-1))-(@("PSBTAB"_(FLD-1))+1))
"RTN","PSBOSF",240,0)
 .I $E(PSBVAL(0),1)'="" D
"RTN","PSBOSF",241,0)
 ..F PSBI=$L(PSBVAL(0))+(@("PSBTAB"_(FLD-1))):1:(@("PSBTAB"_FLD)-3) S PSBVAL(0)=PSBVAL(0)_" "
"RTN","PSBOSF",242,0)
 ..S $E(PSBRPLN(3),@("PSBTAB"_(FLD-1))+2,(@("PSBTAB"_FLD)-1))=PSBVAL(0)
"RTN","PSBOSF",243,0)
 Q
"RTN","PSBOSF",244,0)
 ;
"RTN","PSBOSF",245,0)
WRTRPT   ; Write the report.
"RTN","PSBOSF",246,0)
 I $O(^TMP("PSBSF",$J,""),-1)<1 D  Q
"RTN","PSBOSF",247,0)
 .S ^TMP("PSBSF",$J,0,14)="W !!,""<<<< NO DOCUMENTED BCMA UNABLE TO SCAN EVENTS FOR THIS DATE RANGE >>>>"",!!"
"RTN","PSBOSF",248,0)
 .D HDR
"RTN","PSBOSF",249,0)
 .X ^TMP("PSBSF",$J,$O(^TMP("PSBSF",$J,""),-1),14)
"RTN","PSBOSF",250,0)
 .D FTR
"RTN","PSBOSF",251,0)
 S PSBPGNUM=1
"RTN","PSBOSF",252,0)
 D HDR
"RTN","PSBOSF",253,0)
 S PSBX1="" F  S PSBX1=$O(^TMP("PSBSF",$J,PSBX1)) Q:PSBX1=""  D
"RTN","PSBOSF",254,0)
 .I PSBPGNUM'=PSBX1 D FTR S PSBPGNUM=PSBX1 D HDR
"RTN","PSBOSF",255,0)
 .S PSBX2="" F  S PSBX2=$O(^TMP("PSBSF",$J,PSBX1,PSBX2)) Q:PSBX2=""  D
"RTN","PSBOSF",256,0)
 ..X ^TMP("PSBSF",$J,PSBX1,PSBX2)
"RTN","PSBOSF",257,0)
 D FTR
"RTN","PSBOSF",258,0)
 K ^XTMP("PSBO",$J,"PSBLIST"),^TMP("PSBSF",$J)
"RTN","PSBOSF",259,0)
 Q
"RTN","PSBOSF",260,0)
 ;
"RTN","PSBOSF",261,0)
HDR      ; Write the report header.
"RTN","PSBOSF",262,0)
 N PSBDIV,PSBARRY,PSBNPAR ;New variables for PSB*3*80
"RTN","PSBOSF",263,0)
 I '$D(PSBHDR) S PSBHDR=""
"RTN","PSBOSF",264,0)
 W:$Y>1 @IOF W:$X>1 !
"RTN","PSBOSF",265,0)
 S PSBPG="Page: "_PSBPGNUM_" of "_$S($O(^TMP("PSBSF",$J,""),-1)=0:1,1:$O(^TMP("PSBSF",$J,""),-1))
"RTN","PSBOSF",266,0)
 S PSBPGRM=PSBTAB7-($L(PSBPG))
"RTN","PSBOSF",267,0)
 I $P(PSBRPT(0),U,4)="" S $P(PSBRPT(0),U,4)=DUZ(2)
"RTN","PSBOSF",268,0)
 D CREATHDR
"RTN","PSBOSF",269,0)
 W !!,"BCMA UNABLE TO SCAN (Detailed)" W ?PSBPGRM,PSBPG
"RTN","PSBOSF",270,0)
 W !!,"Date/Time: "_PSBDTTM,!,"Report Date Range:  Start Date: "_Y1_"   Stop Date: "_Y2
"RTN","PSBOSF",271,0)
 W !,"Type of Scanning Failure: ",$S(+$P($G(PSBRPT(3)),",",1)=0:"All",+$P($G(PSBRPT(3)),",",1)=1:"Medication",1:"Wristband")
"RTN","PSBOSF",272,0)
 W !,"Reason: " D
"RTN","PSBOSF",273,0)
 .I $P($G(PSBRPT(3)),",",2)=0 W "All Reasons" Q
"RTN","PSBOSF",274,0)
 .I $P($G(PSBRPT(3)),",",2)=1 W "Damaged Medication Label" Q
"RTN","PSBOSF",275,0)
 .I $P($G(PSBRPT(3)),",",2)=2 W "Damaged Wristband" Q
"RTN","PSBOSF",276,0)
 .I $P($G(PSBRPT(3)),",",2)=3 W "No Bar Code" Q
"RTN","PSBOSF",277,0)
 .I $P($G(PSBRPT(3)),",",2)=4 W "Scanning Equipment Failure" Q
"RTN","PSBOSF",278,0)
 .I $P($G(PSBRPT(3)),",",2)=5 W "Unable to Determine" Q
"RTN","PSBOSF",279,0)
 .I $P($G(PSBRPT(3)),",",2)=6 W "Dose Discrepancy" Q
"RTN","PSBOSF",280,0)
 S PSBDIV=$P($G(^DIC(4,DUZ("2"),0)),U,1) I $G(PSBWLOC) S PSBNPAR="L^"_PSBWLOC D WARD^NURSUT5(PSBNPAR,.PSBARRY) S PSBDIV=$P($G(PSBARRY(PSBWLOC,.02)),U,2) ;Set Division based on ward, PSB*3*80 
"RTN","PSBOSF",281,0)
 W !,"Division: ",PSBDIV
"RTN","PSBOSF",282,0)
 W "    Nurse Location: " D
"RTN","PSBOSF",283,0)
 .I $G(PSBSTWD)]"" W $$NURLOC(PSBSTWD) Q
"RTN","PSBOSF",284,0)
 .W "All"
"RTN","PSBOSF",285,0)
 W !,"Sorted By: "_PSBHDR,?(PSBTAB7-($L("Total BCMA Unable to Scan events: "_+PSBTOT))),"Total BCMA Unable to Scan events: "_+PSBTOT
"RTN","PSBOSF",286,0)
 W !!,$$WRAP^PSBO(5,PSBTAB7-5,"This is a report of documented BCMA ""Unable to Scan"" events within the given date range.")
"RTN","PSBOSF",287,0)
 W !!,$TR($J("",PSBTAB7)," ","_")
"RTN","PSBOSF",288,0)
 I $D(PSBSFHD1) W !,PSBSFHD1
"RTN","PSBOSF",289,0)
 I $D(PSBSFHD2) W !,PSBSFHD2
"RTN","PSBOSF",290,0)
 W !,$TR($J("",PSBTAB7)," ","="),!
"RTN","PSBOSF",291,0)
 Q
"RTN","PSBOSF",292,0)
 ;
"RTN","PSBOSF",293,0)
FTR      ; Write the report footer.
"RTN","PSBOSF",294,0)
 I IOSL<100 F  Q:$Y>(IOSL-12)  W !
"RTN","PSBOSF",295,0)
 W !,$TR($J("",PSBTAB7)," ","=")
"RTN","PSBOSF",296,0)
 W $$WRAP^PSBO(5,PSBTAB7-5,"Note: IV orders will display the orderable item associated with that IV Order in the Drug column."),!
"RTN","PSBOSF",297,0)
 W !,PSBDTTM,!,"BCMA UNABLE TO SCAN (Detailed)"
"RTN","PSBOSF",298,0)
 W ?PSBPGRM,PSBPG,!
"RTN","PSBOSF",299,0)
 Q
"RTN","PSBOSF",300,0)
 ;
"RTN","PSBOSF",301,0)
PGTOT(X) ; Track PAGE Number.
"RTN","PSBOSF",302,0)
 S:'$D(X) PSBLNTOT=PSBLNTOT+1 S:$D(X) PSBLNTOT=PSBLNTOT+X
"RTN","PSBOSF",303,0)
 I PSBPGNUM=1,(PSBLNTOT=1) S PSBLNTOT=15 S PSBMORE=PSBLNTOT+7 Q PSBPGNUM
"RTN","PSBOSF",304,0)
 I PSBLNTOT'<PSBMORE D
"RTN","PSBOSF",305,0)
 .S PSBMORE=PSBLNTOT+7
"RTN","PSBOSF",306,0)
 .I PSBMORE>(IOSL-9) S PSBPGNUM=PSBPGNUM+1,PSBLNTOT=15 S PSBMORE=PSBLNTOT+7
"RTN","PSBOSF",307,0)
 Q PSBPGNUM
"RTN","PSBOSF",308,0)
 ;
"RTN","PSBOSF",309,0)
CREATHDR ; Create report header.
"RTN","PSBOSF",310,0)
 K PSBSFHD1
"RTN","PSBOSF",311,0)
 I IOM'<122 S PSBSFHD1=$P($T(SFHD132A),";",3),PSBSFHD2=$P($T(SFHD132B),";",3),PSBBLANK=$P($T(SF132BLK),";",3)
"RTN","PSBOSF",312,0)
 I (IOM'>90),(IOM'<75) S PSBSFHD1=$P($T(SFHD80A),";",3),PSBSFHD2=$P($T(SFHD80B),";",3),PSBBLANK=$P($T(SF80BLK),";",3)
"RTN","PSBOSF",313,0)
 I '$D(PSBSFHD1) S PSBTAB7=80 Q
"RTN","PSBOSF",314,0)
 ; reset tabs
"RTN","PSBOSF",315,0)
 S PSBTAB0=1 F PSBI=0:1:($L(PSBSFHD1,"|")-2) S:PSBI>0 @("PSBTAB"_PSBI)=($F(PSBSFHD1,"|",@("PSBTAB"_(PSBI-1))+1))-1
"RTN","PSBOSF",316,0)
 Q
"RTN","PSBOSF",317,0)
 ;
"RTN","PSBOSF",318,0)
SFHD132A ;;| PATIENT'S NAME  | DATE/TIME |      LOCATION     |       |           DRUG            |                     |   REASON   |
"RTN","PSBOSF",319,0)
 Q
"RTN","PSBOSF",320,0)
SFHD132B ;;|     (PID)       |   of UTS  |      WARD/RmBd    | TYPE  |           (ID#)           |      USER'S NAME    |    UTS     |
"RTN","PSBOSF",321,0)
 Q
"RTN","PSBOSF",322,0)
SF132BLK ;;                 |           |                   |       |                           |                     |            |
"RTN","PSBOSF",323,0)
 Q
"RTN","PSBOSF",324,0)
SF80BLK  ;;           |         |          |       |            |            |        |
"RTN","PSBOSF",325,0)
 Q
"RTN","PSBOSF",326,0)
SFHD80A  ;;|PATIENT'S |DATE/TIME| LOCATION |       |   DRUG     |   USER'S   | REASON |
"RTN","PSBOSF",327,0)
 Q
"RTN","PSBOSF",328,0)
SFHD80B  ;;|NAME (PID)|  of UTS | WARD/RmBd|  TYPE |   (ID#)    |   NAME     |  UTS   |
"RTN","PSBOSF",329,0)
 Q
"RTN","PSBOSF",330,0)
 ;
"RTN","PSBOSF",331,0)
WRAPPER(X,Y,Z) ; Wrap text line.
"RTN","PSBOSF",332,0)
 N PSB S J=1
"RTN","PSBOSF",333,0)
 F  Q:'$L(Z)  D
"RTN","PSBOSF",334,0)
 .I $L(Z)<Y S $E(PSBRPLN(J),X)=Z S Z="" Q
"RTN","PSBOSF",335,0)
 .F PSB=Y:-1:0 Q:$E(Z,PSB)=" "
"RTN","PSBOSF",336,0)
 .S:PSB<1 PSB=Y S $E(PSBRPLN(J),X)=$E(Z,1,PSB)
"RTN","PSBOSF",337,0)
 .S Z=$E(Z,PSB+1,250),J=J+1
"RTN","PSBOSF",338,0)
 Q ""
"RTN","PSBOSF",339,0)
 ;
"RTN","PSBOSF",340,0)
LISTWD   ; List wards & nursing locations.
"RTN","PSBOSF",341,0)
 K PSBWARD I $G(PSBSTWD)']"" Q
"RTN","PSBOSF",342,0)
 N PSBLOOP S PSBLOOP=0
"RTN","PSBOSF",343,0)
 F  S PSBLOOP=$O(^NURSF(211.4,PSBSTWD,3,PSBLOOP)) Q:PSBLOOP=""  D
"RTN","PSBOSF",344,0)
 .S PSBWARD(PSBSTWD,$P($G(^NURSF(211.4,PSBSTWD,3,PSBLOOP,0)),U,1))=$P($G(^DIC(42,$P($G(^NURSF(211.4,PSBSTWD,3,PSBLOOP,0)),U,1),0)),U,1)_"$"
"RTN","PSBOSF",345,0)
 .S PSBWARD(PSBSTWD,$P($G(^DIC(42,$P($G(^NURSF(211.4,PSBSTWD,3,PSBLOOP,0)),U,1),0)),U,1)_"$")=$P($G(^NURSF(211.4,PSBSTWD,3,PSBLOOP,0)),U,1)
"RTN","PSBOSF",346,0)
 Q
"RTN","PSBOSF",347,0)
 ;
"RTN","PSBOSF",348,0)
NURLOC(X) ; Nursing Location Name.
"RTN","PSBOSF",349,0)
 N PSBNULC S PSBNULC=$G(^NURSF(211.4,X,0)) I PSBNULC="" Q PSBNULC
"RTN","PSBOSF",350,0)
 S PSBNULC=$P($G(^SC(PSBNULC,0)),U,1)
"RTN","PSBOSF",351,0)
 Q PSBNULC
"RTN","PSBOWA")
0^5^B133947862^B134110503
"RTN","PSBOWA",1,0)
PSBOWA ;BIRMINGHAM/EFC-WARD ADMINISTRATION TIMES ;9/29/12 1:57am
"RTN","PSBOWA",2,0)
 ;;3.0;BAR CODE MED ADMIN;**9,32,56,70,80**;Mar 2004;Build 6
"RTN","PSBOWA",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBOWA",4,0)
 ;
"RTN","PSBOWA",5,0)
 ; Reference/IA
"RTN","PSBOWA",6,0)
 ; ^DPT/10035
"RTN","PSBOWA",7,0)
 ; EN^PSJBCMA/2828
"RTN","PSBOWA",8,0)
 ;
"RTN","PSBOWA",9,0)
 ;*70 - add Clinic filter and clinic name into array
"RTN","PSBOWA",10,0)
 ;      1480: Add clinic to header and breakdown by clinic in detail.
"RTN","PSBOWA",11,0)
 ;
"RTN","PSBOWA",12,0)
EN ;
"RTN","PSBOWA",13,0)
 N PSBHDR,PSBGTOT,PSBTOT,PSBINDX,DFN,PSBX,PSBY,PSBSM,PSBADST,PSBZ
"RTN","PSBOWA",14,0)
 N PSBSRCHL,PSBSORT,PSBCL                                      ;[*70-1480]
"RTN","PSBOWA",15,0)
 S PSBSORT=$P(PSBRPT(.1),U,1)                   ;init PSBSORT  ;*70
"RTN","PSBOWA",16,0)
 S (Y,PSBEVDT)=$P(PSBRPT(.1),U,6) D D^DIQ
"RTN","PSBOWA",17,0)
 S PSBHDR(2)="ADMINISTRATION DATE: "_Y
"RTN","PSBOWA",18,0)
 ;check Clinic or Nurs Unit search list                        ;*70
"RTN","PSBOWA",19,0)
 S PSBSRCHL=$$SRCHLIST^PSBOHDR()
"RTN","PSBOWA",20,0)
 D:$G(PSBSRCHL)]""
"RTN","PSBOWA",21,0)
 .S PSBHDR(3)=""
"RTN","PSBOWA",22,0)
 .S:$P(PSBRPT(4),U,2)="C" PSBHDR(4)="Clinic Search List: "
"RTN","PSBOWA",23,0)
 .S:$P(PSBRPT(4),U,2)="I" PSBHDR(4)="Ward Location: "
"RTN","PSBOWA",24,0)
 ;
"RTN","PSBOWA",25,0)
 S (Y,PSBEVDT2)=$S($P(PSBRPT(.1),U,8)']"":PSBEVDT,1:$P(PSBRPT(.1),U,8)) D D^DIQ
"RTN","PSBOWA",26,0)
 S PSBHDR(2)=PSBHDR(2)_" to "_Y
"RTN","PSBOWA",27,0)
 F PSBIX=0:1 S PSBRPDT=$$FMADD^XLFDT(PSBEVDT,PSBIX) Q:PSBRPDT>PSBEVDT2!(PSBRPDT="-1")  D
"RTN","PSBOWA",28,0)
 .;
"RTN","PSBOWA",29,0)
 .; * * *  Print By Ward  * * *
"RTN","PSBOWA",30,0)
 .D:PSBSORT="W"
"RTN","PSBOWA",31,0)
 ..F X=0,.01:.01:.24 S PSBGTOT(X)=""
"RTN","PSBOWA",32,0)
 ..W $$WRDHDR()
"RTN","PSBOWA",33,0)
 ..S PSBINDX=""
"RTN","PSBOWA",34,0)
 ..F  S PSBINDX=$O(^TMP("PSBO",$J,"B",PSBINDX)) Q:PSBINDX=""  D
"RTN","PSBOWA",35,0)
 ...F DFN=0:0 S DFN=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN)) Q:'DFN  D
"RTN","PSBOWA",36,0)
 ....W:$Y>(IOSL-10) $$WRDHDR()
"RTN","PSBOWA",37,0)
 ....W !,$P(^DPT(DFN,0),U,1),!,"SSN: ",$P(^(0),U,9)
"RTN","PSBOWA",38,0)
 ....W !,"Ward: ",$E($G(^DPT(DFN,.1)),1,25),!,"Room-Bed:  ",$E($G(^(.101)),1,21)
"RTN","PSBOWA",39,0)
 ....W ?32
"RTN","PSBOWA",40,0)
 ....F X=0,.01:.01:.24 S PSBTOT(X)=""
"RTN","PSBOWA",41,0)
 ....K ^TMP("PSJ",$J)
"RTN","PSBOWA",42,0)
 ....D EN^PSJBCMA(DFN,$P(PSBRPT(.1),U,6))
"RTN","PSBOWA",43,0)
 ....D REMOVECO^PSBVDLU1        ;*70 always remove CO orders from ward
"RTN","PSBOWA",44,0)
 ....F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:'PSBX  D
"RTN","PSBOWA",45,0)
 .....Q:^TMP("PSJ",$J,PSBX,0)=-1  ; No Orders
"RTN","PSBOWA",46,0)
 .....D CLEAN^PSBVT
"RTN","PSBOWA",47,0)
 .....D PSJ^PSBVT(PSBX)
"RTN","PSBOWA",48,0)
 .....Q:PSBSCHT'="C"  ; Not a Continuous
"RTN","PSBOWA",49,0)
 .....Q:PSBOSTS'="A"&(PSBOSTS'="R")&(PSBOSTS'="O")  ; Active? - PSB*3*56 adds on call as an active status
"RTN","PSBOWA",50,0)
 .....Q:PSBSM=1  ;Self med?
"RTN","PSBOWA",51,0)
 .....S (PSBCADM,PSBYES,PSBODD)=0
"RTN","PSBOWA",52,0)
 .....S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX)
"RTN","PSBOWA",53,0)
 .....S:$$PSBDCHK1^PSBVT1(PSBSCH) PSBYES=1
"RTN","PSBOWA",54,0)
 .....F I=1:1 Q:$P(PSBSCH,"-",I)=""  I ($P(PSBSCH,"-",I)?2N)!($P(PSBSCH,"-",I)?4N) S PSBYES=1
"RTN","PSBOWA",55,0)
 .....I PSBYES,PSBADST="",PSBSCHT'="O",PSBSCHT'="OC",PSBSCHT'="P" D  Q
"RTN","PSBOWA",56,0)
 ......D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Admin times required",PSBSCH)
"RTN","PSBOWA",57,0)
 .....I "PCS"'[PSBIVT,PSBONX'["U" Q
"RTN","PSBOWA",58,0)
 .....I PSBIVT["S",PSBISYR'=1 Q  ;    allow intermittent syringe only
"RTN","PSBOWA",59,0)
 .....I PSBIVT["C",PSBCHEMT'="P",PSBISYR'=1 Q
"RTN","PSBOWA",60,0)
 .....I PSBIVT["C",PSBCHEMT="A" Q  ;     allow Chemo with intermittent syringe or Piggyback type only
"RTN","PSBOWA",61,0)
 .....I PSBFREQ="D" S PSBFREQ=""
"RTN","PSBOWA",62,0)
 .....I 'PSBYES,PSBFREQ<1 D  Q
"RTN","PSBOWA",63,0)
 ......D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid frequency received from order",PSBSCH)
"RTN","PSBOWA",64,0)
 .....I +PSBFREQ>0 D
"RTN","PSBOWA",65,0)
 ......I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODD=1
"RTN","PSBOWA",66,0)
 .....I PSBODD,PSBADST'="" D  Q
"RTN","PSBOWA",67,0)
 ......D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Administration Times on ODD SCHEDULE",PSBSCH)
"RTN","PSBOWA",68,0)
 .....K ^TMP("PSB",$J,"GETADMIN")
"RTN","PSBOWA",69,0)
 .....I PSBADST="" S PSBADST=$$GETADMIN^PSBVDLU1(DFN,PSBONX,PSBOST,PSBFREQ,PSBRPDT) S:PSBADST'="" PSBCADM=1
"RTN","PSBOWA",70,0)
 .....E  S ^TMP("PSB",$J,"GETADMIN",0)=PSBADST
"RTN","PSBOWA",71,0)
 .....Q:PSBADST=""
"RTN","PSBOWA",72,0)
 .....I PSBONX'["V" D  Q:'$$OKAY^PSBVDLU1(PSBOST,PSBRPDT,PSBSCH,PSBONX,PSBOIT,PSBFREQ)           ;[*70-1480]
"RTN","PSBOWA",73,0)
 .....I PSBONX["V",PSBSCH'=""  Q:'$$OKAY^PSBVDLU1(PSBOST,PSBRPDT,PSBSCH,PSBONX,PSBOIT,PSBFREQ)   ;[*70-1480]
"RTN","PSBOWA",74,0)
 .....F PSBXX=0:1 Q:'$D(^TMP("PSB",$J,"GETADMIN",PSBXX))  S PSBADST=$G(^TMP("PSB",$J,"GETADMIN",PSBXX)) D
"RTN","PSBOWA",75,0)
 ......F Y=1:1:$L(PSBADST,"-") S Z=+("."_$E($P(PSBADST,"-",Y),1,2)) D
"RTN","PSBOWA",76,0)
 .......Q:((PSBRPDT+Z)<$E(PSBOST,1,12))&($G(Z)'=0)  ;Start Date
"RTN","PSBOWA",77,0)
 .......Q:(PSBRPDT+Z)'<$E(PSBOSP,1,12)  ;Stop Date
"RTN","PSBOWA",78,0)
 .......;For invalid admin times
"RTN","PSBOWA",79,0)
 .......D:($P(PSBADST,"-",Y)'?2N)&($P(PSBADST,"-",Y)'?4N)
"RTN","PSBOWA",80,0)
 ........D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid Admin times",PSBSCH)
"RTN","PSBOWA",81,0)
 .......S PSBTOT(Z)=PSBTOT(Z)+1
"RTN","PSBOWA",82,0)
 .......S PSBGTOT(Z)=PSBGTOT(Z)+1
"RTN","PSBOWA",83,0)
 ....S PSBX="" F  S PSBX=$O(PSBTOT(PSBX)) Q:$G(PSBX)=""  W $J(PSBTOT(PSBX),4)
"RTN","PSBOWA",84,0)
 ....W !,$TR($J("",IOM)," ","-")
"RTN","PSBOWA",85,0)
 ..W !!,$TR($J("",IOM)," ","=")
"RTN","PSBOWA",86,0)
 ..W !?32 F X=0,.01:.01:.24 W $J($E(X_"00",2,3),4)
"RTN","PSBOWA",87,0)
 ..W !,"Hourly Totals:",?32
"RTN","PSBOWA",88,0)
 ..S PSBGTOT=0
"RTN","PSBOWA",89,0)
 ..S PSBX="" F  S PSBX=$O(PSBGTOT(PSBX)) Q:$G(PSBX)=""  D
"RTN","PSBOWA",90,0)
 ...W $J(PSBGTOT(PSBX),4)
"RTN","PSBOWA",91,0)
 ...S PSBGTOT=PSBGTOT+PSBGTOT(PSBX)
"RTN","PSBOWA",92,0)
 ..W !!,"Ward Total:",?32,$J(PSBGTOT,4)
"RTN","PSBOWA",93,0)
 ..W !!,$TR($J("",IOM)," ","-")
"RTN","PSBOWA",94,0)
 ..K ^TMP("PSJ",$J)
"RTN","PSBOWA",95,0)
 .;
"RTN","PSBOWA",96,0)
 .; * * *  Print By Clinic  * * *
"RTN","PSBOWA",97,0)
 .D:PSBSORT="C"
"RTN","PSBOWA",98,0)
 ..F X=0,.01:.01:.24 S PSBGTOT(PSBRPDT,X)=""   ;[*70-1480]
"RTN","PSBOWA",99,0)
 ..S PSBINDX=""
"RTN","PSBOWA",100,0)
 ..F  S PSBINDX=$O(^TMP("PSBO",$J,"B",PSBINDX)) Q:PSBINDX=""  D
"RTN","PSBOWA",101,0)
 ...F DFN=0:0 S DFN=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN)) Q:'DFN  D
"RTN","PSBOWA",102,0)
 ....K ^TMP("PSJ",$J)
"RTN","PSBOWA",103,0)
 ....D EN^PSJBCMA(DFN,$P(PSBRPT(.1),U,6))
"RTN","PSBOWA",104,0)
 ....;Filter in/out Clinic Orders               *70
"RTN","PSBOWA",105,0)
 ....D:PSBCLINORD
"RTN","PSBOWA",106,0)
 ..... I $D(PSBRPT(2)) D FILTERCO^PSBO Q
"RTN","PSBOWA",107,0)
 ..... D INCLUDCO^PSBVDLU1
"RTN","PSBOWA",108,0)
 ....F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:'PSBX  D             ;[*70-1480]
"RTN","PSBOWA",109,0)
 .....S PSBCL=$P($G(^TMP("PSJ",$J,PSBX,0)),U,11)                      ;[*70-1480]
"RTN","PSBOWA",110,0)
 .....I PSBCL]"" F X=0,.01:.01:.24 S PSBTOT(PSBRPDT,DFN,PSBCL,X)=""   ;[*70-1480]
"RTN","PSBOWA",111,0)
 ....F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:'PSBX  D
"RTN","PSBOWA",112,0)
 .....S PSBCL=$P($G(^TMP("PSJ",$J,PSBX,0)),U,11)                      ;[*70-1480]
"RTN","PSBOWA",113,0)
 .....Q:^TMP("PSJ",$J,PSBX,0)=-1  ; No Orders
"RTN","PSBOWA",114,0)
 .....D CLEAN^PSBVT
"RTN","PSBOWA",115,0)
 .....D PSJ^PSBVT(PSBX)
"RTN","PSBOWA",116,0)
 .....Q:PSBSCHT'="C"  ; Not a Continuous
"RTN","PSBOWA",117,0)
 .....Q:PSBOSTS'="A"&(PSBOSTS'="R")&(PSBOSTS'="O")  ; Active? - PSB*3*56 adds on call as an active status
"RTN","PSBOWA",118,0)
 .....Q:PSBSM=1  ;Self med?
"RTN","PSBOWA",119,0)
 .....S (PSBCADM,PSBYES,PSBODD)=0
"RTN","PSBOWA",120,0)
 .....S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX)
"RTN","PSBOWA",121,0)
 .....S:$$PSBDCHK1^PSBVT1(PSBSCH) PSBYES=1
"RTN","PSBOWA",122,0)
 .....F I=1:1 Q:$P(PSBSCH,"-",I)=""  I ($P(PSBSCH,"-",I)?2N)!($P(PSBSCH,"-",I)?4N) S PSBYES=1
"RTN","PSBOWA",123,0)
 .....I PSBYES,PSBADST="",PSBSCHT'="O",PSBSCHT'="OC",PSBSCHT'="P" D  Q
"RTN","PSBOWA",124,0)
 ......D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Admin times required",PSBSCH)
"RTN","PSBOWA",125,0)
 .....I "PCS"'[PSBIVT,PSBONX'["U" Q
"RTN","PSBOWA",126,0)
 .....I PSBIVT["S",PSBISYR'=1 Q  ;    allow intermittent syringe only
"RTN","PSBOWA",127,0)
 .....I PSBIVT["C",PSBCHEMT'="P",PSBISYR'=1 Q
"RTN","PSBOWA",128,0)
 .....I PSBIVT["C",PSBCHEMT="A" Q  ;     allow Chemo with intermittent syringe or Piggyback type only
"RTN","PSBOWA",129,0)
 .....I PSBFREQ="D" S PSBFREQ=""
"RTN","PSBOWA",130,0)
 .....I 'PSBYES,PSBFREQ<1 D  Q
"RTN","PSBOWA",131,0)
 ......D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid frequency received from order",PSBSCH)
"RTN","PSBOWA",132,0)
 .....I +PSBFREQ>0 D
"RTN","PSBOWA",133,0)
 ......I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODD=1
"RTN","PSBOWA",134,0)
 .....I PSBODD,PSBADST'="" D  Q
"RTN","PSBOWA",135,0)
 ......D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Administration Times on ODD SCHEDULE",PSBSCH)
"RTN","PSBOWA",136,0)
 .....K ^TMP("PSB",$J,"GETADMIN")
"RTN","PSBOWA",137,0)
 .....I PSBADST="" S PSBADST=$$GETADMIN^PSBVDLU1(DFN,PSBONX,PSBOST,PSBFREQ,PSBRPDT) S:PSBADST'="" PSBCADM=1
"RTN","PSBOWA",138,0)
 .....E  S ^TMP("PSB",$J,"GETADMIN",0)=PSBADST
"RTN","PSBOWA",139,0)
 .....Q:PSBADST=""
"RTN","PSBOWA",140,0)
 .....I PSBONX'["V" D  Q:'$$OKAY^PSBVDLU1(PSBOST,PSBRPDT,PSBSCH,PSBONX,PSBOIT,PSBFREQ)           ;[*70-1480]
"RTN","PSBOWA",141,0)
 .....I PSBONX["V",PSBSCH'=""  Q:'$$OKAY^PSBVDLU1(PSBOST,PSBRPDT,PSBSCH,PSBONX,PSBOIT,PSBFREQ)   ;[*70-1480]
"RTN","PSBOWA",142,0)
 .....F PSBXX=0:1 Q:'$D(^TMP("PSB",$J,"GETADMIN",PSBXX))  S PSBADST=$G(^TMP("PSB",$J,"GETADMIN",PSBXX)) D
"RTN","PSBOWA",143,0)
 ......F Y=1:1:$L(PSBADST,"-") S Z=+("."_$E($P(PSBADST,"-",Y),1,2)) D
"RTN","PSBOWA",144,0)
 .......Q:((PSBRPDT)<$E(PSBOST,1,12))&($G(Z)'=0)  ;Start Date                                    ;[*70-1480]
"RTN","PSBOWA",145,0)
 .......Q:(PSBRPDT)'<$E(PSBOSP,1,12)              ;Stop Date                                     ;[*70-1480]
"RTN","PSBOWA",146,0)
 .......;For invalid admin times
"RTN","PSBOWA",147,0)
 .......D:($P(PSBADST,"-",Y)'?2N)&($P(PSBADST,"-",Y)'?4N)
"RTN","PSBOWA",148,0)
 ........D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid Admin times",PSBSCH)
"RTN","PSBOWA",149,0)
 .......S PSBTOT(PSBRPDT,DFN,PSBCL,Z)=PSBTOT(PSBRPDT,DFN,PSBCL,Z)+1                              ;[*70-1480]
"RTN","PSBOWA",150,0)
 .......S PSBGTOT(PSBRPDT,Z)=PSBGTOT(PSBRPDT,Z)+1                                                ;[*70-1480]
"RTN","PSBOWA",151,0)
 ..K ^TMP("PSJ",$J)
"RTN","PSBOWA",152,0)
 .;
"RTN","PSBOWA",153,0)
 .; * * *  Print By Patient  * * *
"RTN","PSBOWA",154,0)
 .D:PSBSORT="P"
"RTN","PSBOWA",155,0)
 ..S DFN=PSBDFN
"RTN","PSBOWA",156,0)
 ..S PSBHDR(1)="WARD ADMINISTRATION TIMES"
"RTN","PSBOWA",157,0)
 ..S Y=$P(PSBRPT(.1),U,6) D D^DIQ S PSBHDR(2)="ADMINISTRATION DATE: "_Y
"RTN","PSBOWA",158,0)
 ..S Y=PSBEVDT2 D D^DIQ S PSBHDR(2)=PSBHDR(2)_" to "_Y
"RTN","PSBOWA",159,0)
 ..W $$PTHDR()
"RTN","PSBOWA",160,0)
 ..K ^TMP("PSJ",$J),PSBTOT
"RTN","PSBOWA",161,0)
 ..D EN^PSJBCMA(PSBDFN,PSBRPDT,"")
"RTN","PSBOWA",162,0)
 ..D:PSBCLINORD                                     ;*70 filer clinics
"RTN","PSBOWA",163,0)
 ... I $D(PSBRPT(2)) D FILTERCO^PSBO Q
"RTN","PSBOWA",164,0)
 ... D INCLUDCO^PSBVDLU1
"RTN","PSBOWA",165,0)
 ..I 'PSBCLINORD D REMOVECO^PSBVDLU1                ;*70
"RTN","PSBOWA",166,0)
 ..F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:'PSBX  D
"RTN","PSBOWA",167,0)
 ...Q:^TMP("PSJ",$J,PSBX,0)=-1  ; No Orders
"RTN","PSBOWA",168,0)
 ...D CLEAN^PSBVT
"RTN","PSBOWA",169,0)
 ...D PSJ^PSBVT(PSBX)
"RTN","PSBOWA",170,0)
 ...Q:PSBSCHT'="C"  ; Not a Continuous
"RTN","PSBOWA",171,0)
 ...Q:PSBOSTS'="A"&(PSBOSTS'="R")&(PSBOSTS'="O")  ; Active? - PSB*3*56 adds on call as an active status
"RTN","PSBOWA",172,0)
 ...S (PSBCADM,PSBYES,PSBODD)=0
"RTN","PSBOWA",173,0)
 ...S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX)
"RTN","PSBOWA",174,0)
 ...S:$$PSBDCHK1^PSBVT1(PSBSCH) PSBYES=1
"RTN","PSBOWA",175,0)
 ...F I=1:1 Q:$P(PSBSCH,"-",I)=""  I ($P(PSBSCH,"-",I)?2N)!($P(PSBSCH,"-",I)?4N) S PSBYES=1
"RTN","PSBOWA",176,0)
 ...I PSBYES,PSBADST="",PSBSCHT'="O",PSBSCHT'="OC",PSBSCHT'="P" D  Q
"RTN","PSBOWA",177,0)
 ....D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Admin times required",PSBSCH)
"RTN","PSBOWA",178,0)
 ...I "PCS"'[PSBIVT,PSBONX'["U" Q
"RTN","PSBOWA",179,0)
 ...I PSBIVT["S",PSBISYR'=1 Q  ;    allow intermittent syringe only
"RTN","PSBOWA",180,0)
 ...I PSBIVT["C",PSBCHEMT'="P",PSBISYR'=1 Q
"RTN","PSBOWA",181,0)
 ...I PSBIVT["C",PSBCHEMT="A" Q  ;     allow Chemo with intermittent syringe or Piggyback type only
"RTN","PSBOWA",182,0)
 ...I PSBFREQ="D" S PSBFREQ=""
"RTN","PSBOWA",183,0)
 ...I 'PSBYES,PSBFREQ<1 D  Q
"RTN","PSBOWA",184,0)
 ....D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid frequency received from order",PSBSCH)
"RTN","PSBOWA",185,0)
 ...I +PSBFREQ>0 D
"RTN","PSBOWA",186,0)
 ....I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODD=1
"RTN","PSBOWA",187,0)
 ...I PSBODD,PSBADST'="" D  Q
"RTN","PSBOWA",188,0)
 ....D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Administration Times on ODD SCHEDULE",PSBSCH)
"RTN","PSBOWA",189,0)
 ...K ^TMP("PSB",$J,"GETADMIN")
"RTN","PSBOWA",190,0)
 ...I PSBADST="",+$G(PSBFREQ)>0,$G(PSBFREQ)<30 S PSBADST="MESSAGE",$P(PSBTOT(PSBADST,PSBOITX,PSBONX),2)="Due every "_PSBFREQ_" Mins" Q
"RTN","PSBOWA",191,0)
 ...I PSBADST="",+$G(PSBFREQ)'<30 S PSBADST=$$GETADMIN^PSBVDLU1(DFN,PSBONX,PSBOST,PSBFREQ,PSBRPDT) S:PSBADST'="" PSBCADM=1
"RTN","PSBOWA",192,0)
 ...E  S ^TMP("PSB",$J,"GETADMIN",0)=PSBADST
"RTN","PSBOWA",193,0)
 ...Q:PSBADST=""
"RTN","PSBOWA",194,0)
 ...I PSBONX'["V" D  Q:'$$OKAY^PSBVDLU1(PSBOST,PSBRPDT,PSBSCH,PSBONX,PSBOIT,PSBFREQ)
"RTN","PSBOWA",195,0)
 ...I PSBONX["V",PSBSCH'=""  Q:'$$OKAY^PSBVDLU1(PSBOST,PSBRPDT,PSBSCH,PSBONX,PSBOIT,PSBFREQ)
"RTN","PSBOWA",196,0)
 ...F PSBXX=0:1 Q:'$D(^TMP("PSB",$J,"GETADMIN",PSBXX))  S PSBADST=$G(^TMP("PSB",$J,"GETADMIN",PSBXX)) D
"RTN","PSBOWA",197,0)
 ....F Y=1:1:$L(PSBADST,"-") S Z=+("."_$P(PSBADST,"-",Y)) D
"RTN","PSBOWA",198,0)
 .....Q:(PSBRPDT+Z)<$E(PSBOST,1,12)  ; Start Date
"RTN","PSBOWA",199,0)
 .....Q:(PSBRPDT+Z)'<$E(PSBOSP,1,12)  ; Stop Date
"RTN","PSBOWA",200,0)
 .....;For Invalid admin times
"RTN","PSBOWA",201,0)
 .....D:($P(PSBADST,"-",Y)'?2N)&($P(PSBADST,"-",Y)'?4N)
"RTN","PSBOWA",202,0)
 ......D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid Admin times",PSBSCH)
"RTN","PSBOWA",203,0)
 .....S PSBSM=$S(PSBHSM=1:"HSM",PSBSM=1:"SM",1:"")
"RTN","PSBOWA",204,0)
 .....;*** Local array to include order no
"RTN","PSBOWA",205,0)
 .....S PSBTOT(Z,PSBOITX,PSBONX)=PSBSM_U_"Dosage: "_PSBDOSE_"  Route: "_PSBMR_"  "_PSBIFR_U_PSBCLORD         ;add clinic name  *70
"RTN","PSBOWA",206,0)
 ..S PSBX="" F  S PSBX=$O(PSBTOT(PSBX)) Q:PSBX=""  D
"RTN","PSBOWA",207,0)
 ...W !
"RTN","PSBOWA",208,0)
 ...S PSBY="" F  S PSBY=$O(PSBTOT(PSBX,PSBY)) Q:PSBY=""  D
"RTN","PSBOWA",209,0)
 ....S PSBZ="" F  S PSBZ=$O(PSBTOT(PSBX,PSBY,PSBZ)) Q:PSBZ=""  D
"RTN","PSBOWA",210,0)
 .....W:$Y>(IOSL-6) $$PTFTR^PSBOHDR(),$$PTHDR()
"RTN","PSBOWA",211,0)
 .....I PSBX="MESSAGE" W !,$P(PSBTOT(PSBX,PSBY,PSBZ),U,1),?20,PSBY Q
"RTN","PSBOWA",212,0)
 .....W:PSBCLINORD !,$P(PSBTOT(PSBX,PSBY,PSBZ),U,3)
"RTN","PSBOWA",213,0)
 .....W !,$$TIMEOUT^PSBUTL(PSBX),?10
"RTN","PSBOWA",214,0)
 .....W $P(PSBTOT(PSBX,PSBY,PSBZ),U,1),?20,PSBY,?55,$P(PSBTOT(PSBX,PSBY,PSBZ),U,2)
"RTN","PSBOWA",215,0)
 .....;;;W:PSBCLINORD ?103,$P(PSBTOT(PSBX,PSBY,PSBZ),U,3)
"RTN","PSBOWA",216,0)
 .....;W !
"RTN","PSBOWA",217,0)
 ..W $$PTFTR^PSBOHDR()
"RTN","PSBOWA",218,0)
 .K ^TMP("PSJ",$J),^TMP("PSB",$J)
"RTN","PSBOWA",219,0)
 .Q
"RTN","PSBOWA",220,0)
 ;
"RTN","PSBOWA",221,0)
 ;   Start...;[*70-1480]
"RTN","PSBOWA",222,0)
 I PSBSORT="C",$D(PSBTOT) D
"RTN","PSBOWA",223,0)
 .S PSBRPDT="" F  S PSBRPDT=$O(PSBTOT(PSBRPDT)) Q:PSBRPDT=""  D
"RTN","PSBOWA",224,0)
 ..W $$CLNHDR()
"RTN","PSBOWA",225,0)
 ..S DFN="" F  S DFN=$O(PSBTOT(PSBRPDT,DFN)) Q:DFN=""  D
"RTN","PSBOWA",226,0)
 ...W:$Y>(IOSL-10) $$CLNHDR()
"RTN","PSBOWA",227,0)
 ...W !,$P(^DPT(DFN,0),U),!,$P(^(0),U,9)
"RTN","PSBOWA",228,0)
 ...S PSBCL="" F  S PSBCL=$O(PSBTOT(PSBRPDT,DFN,PSBCL)) Q:PSBCL=""  D
"RTN","PSBOWA",229,0)
 ....W:$Y>(IOSL-10) $$CLNHDR()
"RTN","PSBOWA",230,0)
 ....W !,PSBCL,?32
"RTN","PSBOWA",231,0)
 ....S PSBX=""  F  S PSBX=$O(PSBTOT(PSBRPDT,DFN,PSBCL,PSBX)) Q:PSBX=""  D
"RTN","PSBOWA",232,0)
 .....W:$Y>(IOSL-10) $$CLNHDR()
"RTN","PSBOWA",233,0)
 .....W $J(PSBTOT(PSBRPDT,DFN,PSBCL,PSBX),4)
"RTN","PSBOWA",234,0)
 ...W !,$TR($J("",IOM)," ","-")
"RTN","PSBOWA",235,0)
 ..W !!,$TR($J("",IOM)," ","=")
"RTN","PSBOWA",236,0)
 ..W !?32 F X=0,.01:.01:.24 W $J($E(X_"00",2,3),4)
"RTN","PSBOWA",237,0)
 ..W !,"Hourly Totals:",?32
"RTN","PSBOWA",238,0)
 ..S PSBGTOT=0
"RTN","PSBOWA",239,0)
 ..S PSBX="" F  S PSBX=$O(PSBGTOT(PSBRPDT,PSBX)) Q:$G(PSBX)=""  D
"RTN","PSBOWA",240,0)
 ...W $J(PSBGTOT(PSBRPDT,PSBX),4)
"RTN","PSBOWA",241,0)
 ...S PSBGTOT=PSBGTOT+PSBGTOT(PSBRPDT,PSBX)
"RTN","PSBOWA",242,0)
 ..W !!,"Report Date Total:",?32,$J(PSBGTOT,4)
"RTN","PSBOWA",243,0)
 ..W !!,$TR($J("",IOM)," ","-")
"RTN","PSBOWA",244,0)
 ;   End...;[*70-1480]
"RTN","PSBOWA",245,0)
 ;
"RTN","PSBOWA",246,0)
WRDHDR() ;
"RTN","PSBOWA",247,0)
 S PSBHDR(1)="WARD ADMINISTRATION TIMES"
"RTN","PSBOWA",248,0)
 D WARD^PSBOHDR(PSBWRD,.PSBHDR,,,PSBSRCHL)
"RTN","PSBOWA",249,0)
 S Y=PSBRPDT D D^DIQ
"RTN","PSBOWA",250,0)
 W !,"Patient Name",?64,Y_" Administration Times"
"RTN","PSBOWA",251,0)
 W !,"Room-Bed",?32
"RTN","PSBOWA",252,0)
 F X=0,.01:.01:.24 W $J($E(X_"00",2,3),4)
"RTN","PSBOWA",253,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBOWA",254,0)
 Q ""
"RTN","PSBOWA",255,0)
 ;
"RTN","PSBOWA",256,0)
CLNHDR() ;
"RTN","PSBOWA",257,0)
 S PSBHDR(1)="CLINIC ADMINISTRATION TIMES"
"RTN","PSBOWA",258,0)
 D CLINIC^PSBOHDR(.PSBRPT,.PSBHDR,,,PSBSRCHL)
"RTN","PSBOWA",259,0)
 ;
"RTN","PSBOWA",260,0)
 S Y=PSBRPDT D D^DIQ
"RTN","PSBOWA",261,0)
 W !,"Patient Name",?64,Y_" Administration Times"
"RTN","PSBOWA",262,0)
 W !,"SSN",!,"Location",?32                       ;[*70-1480]
"RTN","PSBOWA",263,0)
 F X=0,.01:.01:.24 W $J($E(X_"00",2,3),4)
"RTN","PSBOWA",264,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBOWA",265,0)
 Q ""
"RTN","PSBOWA",266,0)
 ;
"RTN","PSBOWA",267,0)
PTHDR() ;
"RTN","PSBOWA",268,0)
 S PSBHDR(1)="PATIENT ADMINISTRATION TIMES"
"RTN","PSBOWA",269,0)
 D PT^PSBOHDR(PSBDFN,.PSBHDR,,,PSBSRCHL)
"RTN","PSBOWA",270,0)
 W:PSBCLINORD !,"Location"
"RTN","PSBOWA",271,0)
 W !,"Date/Time",?10,"Self Med",?20,"Medication",?55,"Dose/Route"
"RTN","PSBOWA",272,0)
 ;;;W:PSBCLINORD ?103,"Location"
"RTN","PSBOWA",273,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBOWA",274,0)
 S Y=PSBRPDT D D^DIQ
"RTN","PSBOWA",275,0)
 W !!,Y,!
"RTN","PSBOWA",276,0)
 Q ""
"RTN","PSBPRN")
0^1^B42972466^B41292164
"RTN","PSBPRN",1,0)
PSBPRN ;BIRMINGHAM/EFC-BCMA PRN FUNCTIONS ;12/14/12 12:22pm
"RTN","PSBPRN",2,0)
 ;;3.0;BAR CODE MED ADMIN;**5,3,13,61,68,70,80**;Mar 2004;Build 6
"RTN","PSBPRN",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBPRN",4,0)
 ;
"RTN","PSBPRN",5,0)
 ;Reference/IA
"RTN","PSBPRN",6,0)
 ;DEM^VADPT/10061
"RTN","PSBPRN",7,0)
 ;INP^VADPT/10061
"RTN","PSBPRN",8,0)
 ;$$GET1^DIQ/2056
"RTN","PSBPRN",9,0)
 ;GETSIOPI^PSJBCMA5/5763
"RTN","PSBPRN",10,0)
 ;
"RTN","PSBPRN",11,0)
 ;*68 - add call to add special instructions (SI) entries to the
"RTN","PSBPRN",12,0)
 ;      ^TMP("PSB")  global that ends up in the RESULTS ARRAY of
"RTN","PSBPRN",13,0)
 ;      RPC PSB GETPRNS.
"RTN","PSBPRN",14,0)
 ;      and add new parameter to GETPRNS tag to use new SI/OPI word
"RTN","PSBPRN",15,0)
 ;      processing fields.
"RTN","PSBPRN",16,0)
 ;*70 - remove discharged status from the api and rename DECEASED
"RTN","PSBPRN",17,0)
 ;      see below, in tag Getprns, for searchng back rules and dates
"RTN","PSBPRN",18,0)
 ;      of CO vs IM orders.
"RTN","PSBPRN",19,0)
 ;
"RTN","PSBPRN",20,0)
 ; ** Warning: PSBSIOPI will be used as a global variable for all down
"RTN","PSBPRN",21,0)
 ;    streams calls from this RPC tag call.
"RTN","PSBPRN",22,0)
 ;
"RTN","PSBPRN",23,0)
EN ;
"RTN","PSBPRN",24,0)
 Q
"RTN","PSBPRN",25,0)
 ;
"RTN","PSBPRN",26,0)
EDIT ; Edit Medication Log PRN Effectiveness
"RTN","PSBPRN",27,0)
 NEW DFN ;* Undef DFN at EDIT+7^PSBPRN (NOIS: HUN-0699-21494)
"RTN","PSBPRN",28,0)
 W !! S DA=""
"RTN","PSBPRN",29,0)
 S DIC="^DPT(",DIC(0)="AEQM",DIC("A")="Select Patient Name: "
"RTN","PSBPRN",30,0)
 D ^DIC K DIC Q:+Y<1
"RTN","PSBPRN",31,0)
 S DFN=+Y
"RTN","PSBPRN",32,0)
 D EDIT1
"RTN","PSBPRN",33,0)
 K DFN,DA
"RTN","PSBPRN",34,0)
 G EDIT
"RTN","PSBPRN",35,0)
 ;
"RTN","PSBPRN",36,0)
EDIT1 ;
"RTN","PSBPRN",37,0)
 S %DT="AEQ",%DT("A")="Select Date to Begin Searching Back From: "
"RTN","PSBPRN",38,0)
 S %DT("B")="Today"
"RTN","PSBPRN",39,0)
 W !! D ^%DT Q:+Y<1  S PSBDT=Y
"RTN","PSBPRN",40,0)
 F  D  Q:'PSBDT
"RTN","PSBPRN",41,0)
 .W @IOF,!,"Searching Date " S Y=PSBDT D D^DIQ W Y
"RTN","PSBPRN",42,0)
 .W !," #  Medication",?45,"St",?50,"D/T Given",?75,"Int"
"RTN","PSBPRN",43,0)
 .W !,$TR($J("",IOM)," ","-")
"RTN","PSBPRN",44,0)
 .S PSBSRCH=PSBDT+.9,PSBCNT=0
"RTN","PSBPRN",45,0)
 .K PSBTMP
"RTN","PSBPRN",46,0)
 .F  S PSBSRCH=$O(^PSB(53.79,"APRN",DFN,PSBSRCH),-1) Q:'PSBSRCH!(PSBSRCH<PSBDT)  D
"RTN","PSBPRN",47,0)
 ..S PSBIEN=""
"RTN","PSBPRN",48,0)
 ..F  S PSBIEN=$O(^PSB(53.79,"APRN",DFN,PSBSRCH,PSBIEN),-1) Q:'PSBIEN  D
"RTN","PSBPRN",49,0)
 ...Q:$P($G(^PSB(53.79,PSBIEN,.2)),U,2)]""
"RTN","PSBPRN",50,0)
 ...Q:$P($G(^PSB(53.79,PSBIEN,0)),U,9)'="G"
"RTN","PSBPRN",51,0)
 ...S PSBCNT=PSBCNT+1,PSBTMP(PSBCNT)=PSBIEN
"RTN","PSBPRN",52,0)
 ...I $Y>19 W ! S DIR(0)="E" D ^DIR W @IOF,!,"Searching Date " S Y=PSBDT D D^DIQ W Y,!," #  Medication",?45,"St",?50,"D/T Given",?75,"Int",!,$TR($J("",IOM)," ","-")
"RTN","PSBPRN",53,0)
 ...W !,$J(PSBCNT,2),". "
"RTN","PSBPRN",54,0)
 ...W ?5,$$GET1^DIQ(53.79,PSBIEN_",",.08)
"RTN","PSBPRN",55,0)
 ...W ?45,$P(^PSB(53.79,PSBIEN,0),U,9)
"RTN","PSBPRN",56,0)
 ...W ?50,$$GET1^DIQ(53.79,PSBIEN_",",.06)
"RTN","PSBPRN",57,0)
 ...W ?75,$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:INITIAL")
"RTN","PSBPRN",58,0)
 .I PSBCNT W ! S DIR(0)="NO^1:"_PSBCNT_":0" D ^DIR S:Y DA=PSBTMP(Y),PSBDT="" Q:Y
"RTN","PSBPRN",59,0)
 .I 'PSBCNT W !!?5,"No Meds Found!"
"RTN","PSBPRN",60,0)
 .S X1=PSBDT,X2=-1 D C^%DTC S (PSBDT,Y)=X D D^DIQ
"RTN","PSBPRN",61,0)
 .W !!,"Continue With ",Y
"RTN","PSBPRN",62,0)
 .S %=1 D YN^DICN I %'=1 S PSBDT=0
"RTN","PSBPRN",63,0)
 I DA S DDSFILE=53.79,DR="[PSB PRN EFFECTIVENESS]" D ^DDS S %=2 W !,"Edit another entry" D YN^DICN G:%=1 EDIT1
"RTN","PSBPRN",64,0)
 K PSBCNT,PSBDT,PSBIEN,PSBSRCH,PSBTMP,DA,DR,DDSFILE
"RTN","PSBPRN",65,0)
 Q
"RTN","PSBPRN",66,0)
 ;
"RTN","PSBPRN",67,0)
GETPRNS(RESULTS,DFN,PSBORD,PSBSIOPI) ; Get the PRN's for a pt needing effectiveness
"RTN","PSBPRN",68,0)
 ;
"RTN","PSBPRN",69,0)
 ; RPC PSB GETPRNS
"RTN","PSBPRN",70,0)
 ;
"RTN","PSBPRN",71,0)
 ; Description:
"RTN","PSBPRN",72,0)
 ; Returns all administrations of a PRN order that have NOT had
"RTN","PSBPRN",73,0)
 ; the PRN Effectiveness documented BASED ON THE TRANSFER DATE AND SITE PARAM
"RTN","PSBPRN",74,0)
 ;
"RTN","PSBPRN",75,0)
 N PSBADMDT,PSBHOUR,PSBPRNDT,PSBIEN,PSBSTOP,PSBIMHR,PSBIMPRNDT,PSBCODY,PSBCOPRNDT           ;*70
"RTN","PSBPRN",76,0)
 K ^TMP("PSB",$J),RESULTS
"RTN","PSBPRN",77,0)
 S PSBSIOPI=+$G(PSBSIOPI)   ;*68 init to 0 if not present or 1 if sent
"RTN","PSBPRN",78,0)
 ;
"RTN","PSBPRN",79,0)
 Q:$$DECEASED(DFN)                                                ;*70
"RTN","PSBPRN",80,0)
 ;
"RTN","PSBPRN",81,0)
 D INP^VADPT S PSBADMDT=+VAIN(7)                   ;get admit date *70
"RTN","PSBPRN",82,0)
 ;get IM site param then build IM & CO PRN dates                   *70
"RTN","PSBPRN",83,0)
 S PSBIMHR=$$GET^XPAR("DIV","PSB PRN DOCUMENTATION")  ;IM hours
"RTN","PSBPRN",84,0)
 S:'PSBIMHR PSBIMHR=72                ;IM def=72 hrs if param null *70
"RTN","PSBPRN",85,0)
 S PSBCODY=1                          ;CO def = 1 day, no time     *70
"RTN","PSBPRN",86,0)
 ;
"RTN","PSBPRN",87,0)
 ;*70
"RTN","PSBPRN",88,0)
 ; BUILD IM & CO prn date limit from Site param and/or defaults,
"RTN","PSBPRN",89,0)
 ; then use the oldest of the 2 PRN dates for the loop quit value.
"RTN","PSBPRN",90,0)
 ; If an admit date exists and is older than the IM date, then use
"RTN","PSBPRN",91,0)
 ; it for the loop. Also if admit date is present, then CO orders
"RTN","PSBPRN",92,0)
 ; should use IM rules and dates.
"RTN","PSBPRN",93,0)
 ;
"RTN","PSBPRN",94,0)
 ; CO date, for non-admitted patient, will be a whole day, no time.
"RTN","PSBPRN",95,0)
 ;
"RTN","PSBPRN",96,0)
 D NOW^%DTC S PSBSTRT=%
"RTN","PSBPRN",97,0)
 ;create IM & CO past date limit to include these order types     *70
"RTN","PSBPRN",98,0)
 S PSBIMPRNDT=$$FMADD^XLFDT(PSBSTRT,"",-PSBIMHR)
"RTN","PSBPRN",99,0)
 S PSBCOPRNDT=$$FMADD^XLFDT($P(PSBSTRT,"."),-PSBCODY)
"RTN","PSBPRN",100,0)
 S PSBPRNDT=$S(PSBCOPRNDT<PSBIMPRNDT:PSBCOPRNDT,1:PSBIMPRNDT)
"RTN","PSBPRN",101,0)
 ;use older of PSBPRNDT & PSBADMDT(admission) for loop quit value
"RTN","PSBPRN",102,0)
 I PSBADMDT,PSBADMDT<PSBPRNDT S (PSBPRNDT,PSBIMPRNDT,PSBCOPRNDT)=PSBADMDT
"RTN","PSBPRN",103,0)
 I PSBADMDT,PSBPRNDT<PSBIMPRNDT S PSBIMPRNDT=PSBADMDT ;Preserve admission date for inpatient medications, PSB*3*80
"RTN","PSBPRN",104,0)
 ;end dates                                                       *70
"RTN","PSBPRN",105,0)
 ;
"RTN","PSBPRN",106,0)
 ;begin loop of PRN records
"RTN","PSBPRN",107,0)
 S PSBSTRT="" F  S PSBSTRT=$O(^PSB(53.79,"APRN",DFN,PSBSTRT),-1) Q:(PSBSTRT<PSBPRNDT)  D
"RTN","PSBPRN",108,0)
 .S PSBIEN=""
"RTN","PSBPRN",109,0)
 .F  S PSBIEN=$O(^PSB(53.79,"APRN",DFN,PSBSTRT,PSBIEN),-1) Q:'PSBIEN  D
"RTN","PSBPRN",110,0)
 ..Q:(PSBORD'="")&($P(^PSB(53.79,PSBIEN,.1),U)'=PSBORD)  ;  Not the right order
"RTN","PSBPRN",111,0)
 ..I ($P(^PSB(53.79,PSBIEN,0),U,9)'="G")&($P(^PSB(53.79,PSBIEN,0),U,9)'="RM") Q    ; Med was never given
"RTN","PSBPRN",112,0)
 ..Q:$P($G(^PSB(53.79,PSBIEN,.2)),U,2)]""  ; Already entered
"RTN","PSBPRN",113,0)
 ..S PSBX=PSBIEN_U_DFN,PSBIENS=PSBIEN_","
"RTN","PSBPRN",114,0)
 ..S PSBX=PSBX_U_$$GET1^DIQ(53.79,PSBIENS,.02)
"RTN","PSBPRN",115,0)
 ..S PSBX=PSBX_U_$$GET1^DIQ(53.79,PSBIENS,.06,"I")
"RTN","PSBPRN",116,0)
 ..S PSBX=PSBX_U_$$GET1^DIQ(53.79,PSBIENS,.07)
"RTN","PSBPRN",117,0)
 ..S PSBX=PSBX_U_$$GET1^DIQ(53.79,PSBIENS,.08)
"RTN","PSBPRN",118,0)
 ..S PSBX=PSBX_U_$$GET1^DIQ(53.79,PSBIENS,.21)
"RTN","PSBPRN",119,0)
 ..D PSJ1^PSBVT(DFN,$$GET1^DIQ(53.79,PSBIENS,.11))
"RTN","PSBPRN",120,0)
 ..;admit date exists, force CO order to look like an IM           *70
"RTN","PSBPRN",121,0)
 ..I PSBADMDT S PSBCLORD=""
"RTN","PSBPRN",122,0)
 ..;skip CO order admins that are older than CO PRN date           *70
"RTN","PSBPRN",123,0)
 ..Q:($G(PSBCLORD)]"")&($P(PSBSTRT,".")<$P(PSBCOPRNDT,"."))
"RTN","PSBPRN",124,0)
 ..;skip IM order admins that are older than IM PRN date           *70
"RTN","PSBPRN",125,0)
 ..Q:($G(PSBCLORD)="")&(PSBSTRT<PSBIMPRNDT)
"RTN","PSBPRN",126,0)
 ..S PSBX=PSBX_U_PSBOIT_U_PSBONX
"RTN","PSBPRN",127,0)
 ..S PSBX=PSBX_U_$$GET1^DIQ(53.79,PSBIENS,.27)
"RTN","PSBPRN",128,0)
 ..S Y=$O(^TMP("PSB",$J,""),-1)+1
"RTN","PSBPRN",129,0)
 ..S ^TMP("PSB",$J,Y)=PSBX
"RTN","PSBPRN",130,0)
 ..;Special instructions
"RTN","PSBPRN",131,0)
 ..S Y=Y+1,^TMP("PSB",$J,Y)=PSBOTXT
"RTN","PSBPRN",132,0)
 ..F PSBZ=.5,.6,.7 F PSBY=0:0 S PSBY=$O(^PSB(53.79,PSBIEN,PSBZ,PSBY)) Q:'PSBY  D
"RTN","PSBPRN",133,0)
 ...S PSBDD=$S(PSBZ=.5:53.795,PSBZ=.6:53.796,1:53.797)
"RTN","PSBPRN",134,0)
 ...S PSBSOL=$S(PSBZ=.5:"DD",PSBZ=.6:"ADD",1:"SOL")
"RTN","PSBPRN",135,0)
 ...Q:'$D(^PSB(53.79,PSBIEN,PSBZ,PSBY))
"RTN","PSBPRN",136,0)
 ...S PSBUNIT=$$GET1^DIQ(PSBDD,PSBY_","_PSBIEN_",",.03)
"RTN","PSBPRN",137,0)
 ...S PSBUNFR=$$GET1^DIQ(PSBDD,PSBY_","_PSBIEN_",",.04)
"RTN","PSBPRN",138,0)
 ...I PSBUNIT>0&(PSBUNIT<1) S PSBUNIT="0"_+PSBUNIT ;add leading 0 for a decimal value less than 1 - PSB*3*61
"RTN","PSBPRN",139,0)
 ...S Y=Y+1
"RTN","PSBPRN",140,0)
 ...S ^TMP("PSB",$J,Y)=PSBSOL_U_$$GET1^DIQ(PSBDD,PSBY_","_PSBIEN_",",.01)_U_PSBUNIT_U_PSBUNFR
"RTN","PSBPRN",141,0)
 ..D:PSBSIOPI GETSI(DFN,PSBONX,.Y)     ;*68 get spec inst/oth prt info
"RTN","PSBPRN",142,0)
 ..S Y=Y+1,^TMP("PSB",$J,Y)="END"
"RTN","PSBPRN",143,0)
 S ^TMP("PSB",$J,0)=+$O(^TMP("PSB",$J,""),-1)
"RTN","PSBPRN",144,0)
 S RESULTS=$NAME(^TMP("PSB",$J))
"RTN","PSBPRN",145,0)
 D CLEAN^PSBVT
"RTN","PSBPRN",146,0)
 Q
"RTN","PSBPRN",147,0)
 ;
"RTN","PSBPRN",148,0)
DECEASED(DFN) ; Patient Deceased?                                        *70
"RTN","PSBPRN",149,0)
 ;
"RTN","PSBPRN",150,0)
 S DECEASED=0
"RTN","PSBPRN",151,0)
 ;
"RTN","PSBPRN",152,0)
 D DEM^VADPT ;check for date of death entry
"RTN","PSBPRN",153,0)
 I VADM(6)]"" S DECEASED=1,^TMP("PSB",$J,0)=0 K VADM
"RTN","PSBPRN",154,0)
 ;
"RTN","PSBPRN",155,0)
 I DECEASED D  ;setup results and clean up
"RTN","PSBPRN",156,0)
 .S RESULTS=$NAME(^TMP("PSB",$J))
"RTN","PSBPRN",157,0)
 .D CLEAN^PSBVT
"RTN","PSBPRN",158,0)
 ;
"RTN","PSBPRN",159,0)
 Q DECEASED
"RTN","PSBPRN",160,0)
 ;
"RTN","PSBPRN",161,0)
GETSI(DFN,ORD,PSB) ;Get Special Instructions/Other Print Info from IM   ;*68
"RTN","PSBPRN",162,0)
 ;
"RTN","PSBPRN",163,0)
 ; This Tag will load the SIOPI WP text into the TMP global used by
"RTN","PSBPRN",164,0)
 ; the PSB GETPRNS RPC, which ends up in the RESULTS array passed
"RTN","PSBPRN",165,0)
 ; back to the BCMA GUI.
"RTN","PSBPRN",166,0)
 ;
"RTN","PSBPRN",167,0)
 N QQ
"RTN","PSBPRN",168,0)
 K ^TMP("PSJBCMA5",$J,DFN,ORD)
"RTN","PSBPRN",169,0)
 D GETSIOPI^PSJBCMA5(DFN,ORD,1)
"RTN","PSBPRN",170,0)
 Q:'$D(^TMP("PSJBCMA5",$J,DFN,ORD))
"RTN","PSBPRN",171,0)
 F QQ=0:0 S QQ=$O(^TMP("PSJBCMA5",$J,DFN,ORD,QQ)) Q:'QQ  D
"RTN","PSBPRN",172,0)
 .S PSB=PSB+1
"RTN","PSBPRN",173,0)
 .S ^TMP("PSB",$J,PSB)="SI^"_^TMP("PSJBCMA5",$J,DFN,ORD,QQ)
"RTN","PSBPRN",174,0)
 K ^TMP("PSJBCMA5",$J,DFN,ORD)
"RTN","PSBPRN",175,0)
 Q
"RTN","PSBVAR")
0^2^B15546139^B15144988
"RTN","PSBVAR",1,0)
PSBVAR ;BIRMINGHAM/EFC-BCMA VARIANCE LOG FUNCTIONS ;9/19/12 5:44pm
"RTN","PSBVAR",2,0)
 ;;3.0;BAR CODE MED ADMIN;*31,70,80*;Mar 2004;Build 6
"RTN","PSBVAR",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBVAR",4,0)
 ;
"RTN","PSBVAR",5,0)
 ; Reference/IA
"RTN","PSBVAR",6,0)
 ; ^DPT/10035
"RTN","PSBVAR",7,0)
 ; ^DIC(42/10039
"RTN","PSBVAR",8,0)
 ;
"RTN","PSBVAR",9,0)
 ;*70 - alter DD trigger code so Clinic Orders do not update variances
"RTN","PSBVAR",10,0)
 ;
"RTN","PSBVAR",11,0)
EN ;
"RTN","PSBVAR",12,0)
 Q
"RTN","PSBVAR",13,0)
 ;
"RTN","PSBVAR",14,0)
CHKPRN(DFN,PSBMIN,PSBLOG) ;
"RTN","PSBVAR",15,0)
 Q:PSBMIN=""
"RTN","PSBVAR",16,0)
 Q:PSBMIN'>$$GET^XPAR("DIV","PSB ADMIN PRN EFFECT")
"RTN","PSBVAR",17,0)
 D ADD(.RESULTS,DFN,3,PSBMIN,"",PSBLOG)
"RTN","PSBVAR",18,0)
 Q
"RTN","PSBVAR",19,0)
 ;
"RTN","PSBVAR",20,0)
 ;CHECK^PSBVAR() calling point is used to create a new variance entry.
"RTN","PSBVAR",21,0)
 ;  Triggered by Order Administration Variance Field # .14 in the BCMA
"RTN","PSBVAR",22,0)
 ;  Medication Log File (#53.79).
"RTN","PSBVAR",23,0)
 ;
"RTN","PSBVAR",24,0)
CHECK(DFN,PSBMIN,PSBLOG) ;
"RTN","PSBVAR",25,0)
 Q:PSBMIN=""
"RTN","PSBVAR",26,0)
 N RESULTS
"RTN","PSBVAR",27,0)
 ; Checks the timing from the Med Log Entry X-Ref
"RTN","PSBVAR",28,0)
 S PSBDRUG=$$GET1^DIQ(53.79,PSBLOG_",",.08,"I")
"RTN","PSBVAR",29,0)
 I PSBMIN<0 D:(PSBMIN*-1)>$$GET^XPAR("DIV","PSB ADMIN BEFORE") ADD(.RESULTS,DFN,2,PSBMIN,PSBDRUG,PSBLOG)
"RTN","PSBVAR",30,0)
 I PSBMIN>0 D:PSBMIN>$$GET^XPAR("DIV","PSB ADMIN AFTER") ADD(.RESULTS,DFN,2,PSBMIN,PSBDRUG,PSBLOG)
"RTN","PSBVAR",31,0)
 Q
"RTN","PSBVAR",32,0)
 ;
"RTN","PSBVAR",33,0)
ADD(RESULTS,DFN,PSBEVNT,PSBMIN,PSBDRUG,PSBLOG) ;
"RTN","PSBVAR",34,0)
 ;
"RTN","PSBVAR",35,0)
 ; DFN:      Patient File (#2) Pointer
"RTN","PSBVAR",36,0)
 ; PSBEVNT:  Event Code (See DD for 53.78)
"RTN","PSBVAR",37,0)
 ; PSBMIN:   Minutes off of schedule (Optional)
"RTN","PSBVAR",38,0)
 ; PSBDRUG:  Drug File (#50) Pointer (Optional)
"RTN","PSBVAR",39,0)
 ; PSBLOG:   BCMA Med Log IEN (Optional)
"RTN","PSBVAR",40,0)
 ;
"RTN","PSBVAR",41,0)
 ;Do not create variance for below events:
"RTN","PSBVAR",42,0)
 ;   Med order with missing dose status.
"RTN","PSBVAR",43,0)
 ;   Clinic orders
"RTN","PSBVAR",44,0)
 ;
"RTN","PSBVAR",45,0)
 I $G(PSBLOG),$P($G(^PSB(53.79,PSBLOG,0)),U,9)="M" Q
"RTN","PSBVAR",46,0)
 Q:($G(PSBCLIN)]"")!($G(PSBCLORD)]"")  ;Clin Flags defined - PSBML *70
"RTN","PSBVAR",47,0)
 ;
"RTN","PSBVAR",48,0)
 N PSBDT,PSBRB,PSBWRD,PSBXX
"RTN","PSBVAR",49,0)
 ;
"RTN","PSBVAR",50,0)
 D EN^DDIOL("Filing Variance...")
"RTN","PSBVAR",51,0)
 D NOW^%DTC
"RTN","PSBVAR",52,0)
 L +(^PSB(53.78,0)):5 E  S RESULTS(0)="-1^Variance Log Locked" Q
"RTN","PSBVAR",53,0)
 S PSBXX=$O(^PSB(53.78,"A"),-1)+1
"RTN","PSBVAR",54,0)
 S $P(^PSB(53.78,0),U,3)=PSBXX
"RTN","PSBVAR",55,0)
 S $P(^PSB(53.78,0),U,4)=$P(^PSB(53.78,0),U,4)+1
"RTN","PSBVAR",56,0)
 ;
"RTN","PSBVAR",57,0)
WARD ;Extract the ward and room/bed information.
"RTN","PSBVAR",58,0)
 ;DFN is pre-defined.
"RTN","PSBVAR",59,0)
 S PSBRB=$P($G(^DPT(DFN,.101)),U)
"RTN","PSBVAR",60,0)
 S PSBRB=$S(PSBRB'="":PSBRB,1:"***")
"RTN","PSBVAR",61,0)
 S PSBWRD=$P($G(^DPT(DFN,.1)),U)
"RTN","PSBVAR",62,0)
 ;Convert Ward Name to Ward IEN
"RTN","PSBVAR",63,0)
 I PSBWRD'="" D
"RTN","PSBVAR",64,0)
 . S PSBDT=%
"RTN","PSBVAR",65,0)
 . S PSBWRD=$$FIND1^DIC(42,"","X",PSBWRD,"","","ERR")
"RTN","PSBVAR",66,0)
 . S %=PSBDT ;reset after $$FIND1^DIC fileman call
"RTN","PSBVAR",67,0)
 S PSBWRD=$S($G(PSBWRD):PSBWRD,1:"***")
"RTN","PSBVAR",68,0)
 ;
"RTN","PSBVAR",69,0)
 ; Set Variance Entry
"RTN","PSBVAR",70,0)
 S ^PSB(53.78,PSBXX,0)=DFN_U_PSBRB_U_DUZ_U_%_U_PSBEVNT_U_$G(PSBMIN)_U_$G(PSBDRUG)_U_$G(PSBLOG)_U_PSBWRD
"RTN","PSBVAR",71,0)
 ;
"RTN","PSBVAR",72,0)
 S ^PSB(53.78,"ADT",%,PSBXX)=""
"RTN","PSBVAR",73,0)
 S ^PSB(53.78,"B",DFN,PSBXX)=""
"RTN","PSBVAR",74,0)
 L -(^PSB(53.78,0))
"RTN","PSBVAR",75,0)
 S RESULTS(0)="1^Data Filed"
"RTN","PSBVAR",76,0)
 Q
"RTN","PSBVAR",77,0)
 ;
"RTN","PSBVAR",78,0)
 ; Unable to UPDATE^DIE WHILE IN UPDATE^DIE
"RTN","PSBVAR",79,0)
 W !,"Filing Variance..."
"RTN","PSBVAR",80,0)
 D EN^DDIOL("Filing Variance...")
"RTN","PSBVAR",81,0)
 N PSBVFDA,PSBVMSG,PSBVIEN
"RTN","PSBVAR",82,0)
 D VAL(.01,"`"_DFN) ; Patient Pointer
"RTN","PSBVAR",83,0)
 S Y=$G(^DPT(DFN,.1),"Unk Ward")_" "_$G(^DPT(DFN,.101),"Unk Bed")
"RTN","PSBVAR",84,0)
 D VAL(.02,Y) ; Patient Location
"RTN","PSBVAR",85,0)
 D VAL(.03,"`"_DUZ) ; New Person Pointer
"RTN","PSBVAR",86,0)
 D VAL(.04,"NOW") ; DT Entered
"RTN","PSBVAR",87,0)
 D VAL(.05,PSBEVNT) ; Event Code
"RTN","PSBVAR",88,0)
 D:$G(PSBMIN) VAL(.06,PSBMIN) ; Minutes Early/Late
"RTN","PSBVAR",89,0)
 D:$G(PSBDRUG) VAL(.07,"`"_PSBDRUG) ; Drug File Pointer
"RTN","PSBVAR",90,0)
 D:$G(PSBLOG) VAL(.08,"`"_PSBLOG)
"RTN","PSBVAR",91,0)
 ; Call UPDATE^DIE and set Results(0)
"RTN","PSBVAR",92,0)
 D UPDATE^DIE("","PSBVFDA","PSBVIEN","PSBVMSG")  ; PSBVFDA set into file 53.68, BCMA MEDICATION VARIANCE LOG at VAL+3
"RTN","PSBVAR",93,0)
 I $D(PSBVMSG) S RESULTS(0)="-1^"_PSBVMSG("DIERR",1)_": "_PSBVMSG("DIERR",1,"TEXT",1)
"RTN","PSBVAR",94,0)
 E  S RESULTS(0)="1^Data Successfully Filed^"_PSBVIEN(1)
"RTN","PSBVAR",95,0)
 W !,RESULTS(0)
"RTN","PSBVAR",96,0)
 Q
"RTN","PSBVAR",97,0)
 ;
"RTN","PSBVAR",98,0)
VAL(PSBVFLD,PSBVVAL) ;
"RTN","PSBVAR",99,0)
 N PSBVRET
"RTN","PSBVAR",100,0)
 K ^TMP("DIERR",$J)
"RTN","PSBVAR",101,0)
 D VAL^DIE(53.78,"+1,",PSBVFLD,"F",PSBVVAL,.PSBVRET,"PSBVFDA")
"RTN","PSBVAR",102,0)
 I PSBVRET="^" F X=0:0 S X=$O(^TMP("DIERR",$J,X)) Q:'X  S Y=^TMP("DIERR",$J,X)_": "_$G(^(X,"TEXT",1),"**"),RESULTS($O(RESULTS(""),-1)+1)="Data Validation Error: "_Y
"RTN","PSBVAR",103,0)
 K ^TMP("DIERR",$J)
"RTN","PSBVAR",104,0)
 Q
"RTN","PSBVAR",105,0)
 ;
"VER")
8.0^22.0
"^DD",53.78,53.78,.07,0)
DRUG SCANNED^P50.7'^PS(50.7,^0;7^Q
"^DD",53.78,53.78,.07,3)
Enter the medication that was scanned for this order.
"^DD",53.78,53.78,.07,21,0)
^^2^2^2990731^^
"^DD",53.78,53.78,.07,21,1,0)
Pointer to the drug file of the medication that was scanned for this
"^DD",53.78,53.78,.07,21,2,0)
variance.
"^DD",53.78,53.78,.07,"DT")
3140422
"BLD",9701,6)
^70
**END**
**END**

