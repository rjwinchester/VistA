Released PSB*3*72 SEQ #69
Extracted from mail message
**KIDS**:PSB*3.0*72^

**INSTALL NAME**
PSB*3.0*72
"BLD",9625,0)
PSB*3.0*72^BAR CODE MED ADMIN^0^3150225^y
"BLD",9625,1,0)
^^18^18^3140326^
"BLD",9625,1,1,0)
This Patch Addresses 7 issues:
"BLD",9625,1,2,0)
 
"BLD",9625,1,3,0)
1. The Medication History report in Bar Code Medication 
"BLD",9625,1,4,0)
Administration (BCMA) displays amounts in the Units Given
"BLD",9625,1,5,0)
field for an order that has not been given. 
"BLD",9625,1,6,0)
2. When a user makes a change to an order using the Edit Med Log
"BLD",9625,1,7,0)
option which does not change the action status, several reports 
"BLD",9625,1,8,0)
display the initials of the person who edited the order instead of
"BLD",9625,1,9,0)
who created the action on the order.
"BLD",9625,1,10,0)
3. The BCMA Medication Log and Medication Variance report headers
"BLD",9625,1,11,0)
do not display the time frame of the report.
"BLD",9625,1,12,0)
4. The BCMA AUDIT LOG (#53.799) sub-file does not include an entry 
"BLD",9625,1,13,0)
for Pro Re Nada (PRN) Effectiveness when a PRN is "Un-Given"
"BLD",9625,1,14,0)
5. The Legend of the Medication Therapy report does not include users
"BLD",9625,1,15,0)
who entered comments for an order.
"BLD",9625,1,16,0)
6. The 2nd line of routine PSBOPE has an invalid format.
"BLD",9625,1,17,0)
7. Update the unsupported $$UCASE^XUSG Application Programming 
"BLD",9625,1,18,0)
Interface (API) to the supported API $$UP^XLFSTR in routine PSBMLLKU.
"BLD",9625,4,0)
^9.64PA^^
"BLD",9625,6.3)
16
"BLD",9625,"INID")
^y
"BLD",9625,"INIT")
EN^PSB372P
"BLD",9625,"KRN",0)
^9.67PA^779.2^20
"BLD",9625,"KRN",.4,0)
.4
"BLD",9625,"KRN",.401,0)
.401
"BLD",9625,"KRN",.402,0)
.402
"BLD",9625,"KRN",.403,0)
.403
"BLD",9625,"KRN",.5,0)
.5
"BLD",9625,"KRN",.84,0)
.84
"BLD",9625,"KRN",3.6,0)
3.6
"BLD",9625,"KRN",3.8,0)
3.8
"BLD",9625,"KRN",9.2,0)
9.2
"BLD",9625,"KRN",9.8,0)
9.8
"BLD",9625,"KRN",9.8,"NM",0)
^9.68A^10^10
"BLD",9625,"KRN",9.8,"NM",1,0)
PSBOML^^0^B64746915
"BLD",9625,"KRN",9.8,"NM",2,0)
PSBOMH1^^0^B84411239
"BLD",9625,"KRN",9.8,"NM",3,0)
PSBCSUTX^^0^B69934937
"BLD",9625,"KRN",9.8,"NM",4,0)
PSBOMT^^0^B93970205
"BLD",9625,"KRN",9.8,"NM",5,0)
PSBOPE^^0^B23332859
"BLD",9625,"KRN",9.8,"NM",6,0)
PSBOPM^^0^B93804999
"BLD",9625,"KRN",9.8,"NM",7,0)
PSBML^^0^B127507803
"BLD",9625,"KRN",9.8,"NM",8,0)
PSBML2^^0^B103484155
"BLD",9625,"KRN",9.8,"NM",9,0)
PSBMLLKU^^0^B106582479
"BLD",9625,"KRN",9.8,"NM",10,0)
PSBOMV^^0^B55477289
"BLD",9625,"KRN",9.8,"NM","B","PSBCSUTX",3)
 
"BLD",9625,"KRN",9.8,"NM","B","PSBML",7)
 
"BLD",9625,"KRN",9.8,"NM","B","PSBML2",8)
 
"BLD",9625,"KRN",9.8,"NM","B","PSBMLLKU",9)
 
"BLD",9625,"KRN",9.8,"NM","B","PSBOMH1",2)
 
"BLD",9625,"KRN",9.8,"NM","B","PSBOML",1)
 
"BLD",9625,"KRN",9.8,"NM","B","PSBOMT",4)
 
"BLD",9625,"KRN",9.8,"NM","B","PSBOMV",10)
 
"BLD",9625,"KRN",9.8,"NM","B","PSBOPE",5)
 
"BLD",9625,"KRN",9.8,"NM","B","PSBOPM",6)
 
"BLD",9625,"KRN",19,0)
19
"BLD",9625,"KRN",19.1,0)
19.1
"BLD",9625,"KRN",101,0)
101
"BLD",9625,"KRN",409.61,0)
409.61
"BLD",9625,"KRN",771,0)
771
"BLD",9625,"KRN",779.2,0)
779.2
"BLD",9625,"KRN",870,0)
870
"BLD",9625,"KRN",8989.51,0)
8989.51
"BLD",9625,"KRN",8989.52,0)
8989.52
"BLD",9625,"KRN",8994,0)
8994
"BLD",9625,"KRN","B",.4,.4)
 
"BLD",9625,"KRN","B",.401,.401)
 
"BLD",9625,"KRN","B",.402,.402)
 
"BLD",9625,"KRN","B",.403,.403)
 
"BLD",9625,"KRN","B",.5,.5)
 
"BLD",9625,"KRN","B",.84,.84)
 
"BLD",9625,"KRN","B",3.6,3.6)
 
"BLD",9625,"KRN","B",3.8,3.8)
 
"BLD",9625,"KRN","B",9.2,9.2)
 
"BLD",9625,"KRN","B",9.8,9.8)
 
"BLD",9625,"KRN","B",19,19)
 
"BLD",9625,"KRN","B",19.1,19.1)
 
"BLD",9625,"KRN","B",101,101)
 
"BLD",9625,"KRN","B",409.61,409.61)
 
"BLD",9625,"KRN","B",771,771)
 
"BLD",9625,"KRN","B",779.2,779.2)
 
"BLD",9625,"KRN","B",870,870)
 
"BLD",9625,"KRN","B",8989.51,8989.51)
 
"BLD",9625,"KRN","B",8989.52,8989.52)
 
"BLD",9625,"KRN","B",8994,8994)
 
"BLD",9625,"QUES",0)
^9.62^^
"BLD",9625,"REQB",0)
^9.611^2^2
"BLD",9625,"REQB",1,0)
PSB*3.0*78^2
"BLD",9625,"REQB",2,0)
PSB*3.0*64^2
"BLD",9625,"REQB","B","PSB*3.0*64",2)
 
"BLD",9625,"REQB","B","PSB*3.0*78",1)
 
"INIT")
EN^PSB372P
"MBREQ")
0
"PKG",550,-1)
1^1
"PKG",550,0)
BAR CODE MED ADMIN^PSB^BAR CODE MEDICATION ADMINISTRATION
"PKG",550,20,0)
^9.402P^^
"PKG",550,22,0)
^9.49I^1^1
"PKG",550,22,1,0)
3.0^3040224^3040311^66481
"PKG",550,22,1,"PAH",1,0)
72^3150225
"PKG",550,22,1,"PAH",1,1,0)
^^18^18^3150225
"PKG",550,22,1,"PAH",1,1,1,0)
This Patch Addresses 7 issues:
"PKG",550,22,1,"PAH",1,1,2,0)
 
"PKG",550,22,1,"PAH",1,1,3,0)
1. The Medication History report in Bar Code Medication 
"PKG",550,22,1,"PAH",1,1,4,0)
Administration (BCMA) displays amounts in the Units Given
"PKG",550,22,1,"PAH",1,1,5,0)
field for an order that has not been given. 
"PKG",550,22,1,"PAH",1,1,6,0)
2. When a user makes a change to an order using the Edit Med Log
"PKG",550,22,1,"PAH",1,1,7,0)
option which does not change the action status, several reports 
"PKG",550,22,1,"PAH",1,1,8,0)
display the initials of the person who edited the order instead of
"PKG",550,22,1,"PAH",1,1,9,0)
who created the action on the order.
"PKG",550,22,1,"PAH",1,1,10,0)
3. The BCMA Medication Log and Medication Variance report headers
"PKG",550,22,1,"PAH",1,1,11,0)
do not display the time frame of the report.
"PKG",550,22,1,"PAH",1,1,12,0)
4. The BCMA AUDIT LOG (#53.799) sub-file does not include an entry 
"PKG",550,22,1,"PAH",1,1,13,0)
for Pro Re Nada (PRN) Effectiveness when a PRN is "Un-Given"
"PKG",550,22,1,"PAH",1,1,14,0)
5. The Legend of the Medication Therapy report does not include users
"PKG",550,22,1,"PAH",1,1,15,0)
who entered comments for an order.
"PKG",550,22,1,"PAH",1,1,16,0)
6. The 2nd line of routine PSBOPE has an invalid format.
"PKG",550,22,1,"PAH",1,1,17,0)
7. Update the unsupported $$UCASE^XUSG Application Programming 
"PKG",550,22,1,"PAH",1,1,18,0)
Interface (API) to the supported API $$UP^XLFSTR in routine PSBMLLKU.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")
 
"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
11
"RTN","PSB372P")
0^^B7779557^n/a
"RTN","PSB372P",1,0)
PSB372P ;MNT/BJR - Move Units Given field to Units Ordered ; 
"RTN","PSB372P",2,0)
 ;;3.0;BAR CODE MED ADMIN;**72**;Mar 2004;Build 16
"RTN","PSB372P",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSB372P",4,0)
 ;
"RTN","PSB372P",5,0)
 Q
"RTN","PSB372P",6,0)
EN ;This routine will move the date in the units given field to the units ordered field for patch PSB*3*72
"RTN","PSB372P",7,0)
 N DR,DA,DIE
"RTN","PSB372P",8,0)
 D MES^XPDUTL("")
"RTN","PSB372P",9,0)
 D MES^XPDUTL("*** PSB*3*72 Post Install Running ***")
"RTN","PSB372P",10,0)
 D MES^XPDUTL("")
"RTN","PSB372P",11,0)
 N X,PSBIEN,PSBADD,PSBDOSE,PSBSTAT,PSBSOL
"RTN","PSB372P",12,0)
 D NOW^%DTC S ^XTMP("PSB72P",0)=$$FMADD^XLFDT(X,30)_"^"_X_"^"_"PSB*3.0*72 Changed Entries"
"RTN","PSB372P",13,0)
 S PSBIEN=999999999999 F  S PSBIEN=$O(^PSB(53.79,PSBIEN),-1) Q:'PSBIEN  D
"RTN","PSB372P",14,0)
 .I $G(^PSB(53.79,PSBIEN,.6,0))'="" S PSBADD=0 F  S PSBADD=$O(^PSB(53.79,PSBIEN,.6,PSBADD)) Q:'PSBADD  D
"RTN","PSB372P",15,0)
 ..M:'$D(^XTMP("PSB72P",PSBIEN,.6)) ^XTMP("PSB72P",PSBIEN,.6)=^PSB(53.79,PSBIEN,.6) S PSBDOSE=$$GET1^DIQ(53.796,PSBADD_","_PSBIEN,.03),PSBSTAT=$$GET1^DIQ(53.79,PSBIEN,.09,"I")
"RTN","PSB372P",16,0)
 ..I PSBDOSE'="" S DR=".02///^S X=PSBDOSE",DIE="^PSB(53.79,"_PSBIEN_",.6,",DA(1)=PSBIEN,DA=PSBADD D ^DIE K DR,DA,DIE
"RTN","PSB372P",17,0)
 ..I PSBSTAT'="G",PSBSTAT'="RM",PSBSTAT'="I",PSBSTAT'="C" S DR=".03///^S X=""@""",DIE="^PSB(53.79,"_PSBIEN_",.6,",DA(1)=PSBIEN,DA=PSBADD D ^DIE K DR,DA,DIE
"RTN","PSB372P",18,0)
 .I $G(^PSB(53.79,PSBIEN,.7,0))'="" S PSBSOL=0 F  S PSBSOL=$O(^PSB(53.79,PSBIEN,.7,PSBSOL)) Q:'PSBSOL  D
"RTN","PSB372P",19,0)
 ..M:'$D(^XTMP("PSB72P",PSBIEN,.7)) ^XTMP("PSB72P",PSBIEN,.7)=^PSB(53.79,PSBIEN,.7) S PSBDOSE=$$GET1^DIQ(53.797,PSBSOL_","_PSBIEN,.03),PSBSTAT=$$GET1^DIQ(53.79,PSBIEN,.09,"I")
"RTN","PSB372P",20,0)
 ..I PSBDOSE'="" S DR=".02///^S X=PSBDOSE",DIE="^PSB(53.79,"_PSBIEN_",.7,",DA(1)=PSBIEN,DA=PSBSOL D ^DIE K DR,DA,DIE
"RTN","PSB372P",21,0)
 ..I PSBSTAT'="G",PSBSTAT'="RM",PSBSTAT'="I",PSBSTAT'="C" S DR=".03///^S X=""@""",DIE="^PSB(53.79,"_PSBIEN_",.7,",DA(1)=PSBIEN,DA=PSBSOL D ^DIE K DR,DA,DIE
"RTN","PSB372P",22,0)
 D MES^XPDUTL("")
"RTN","PSB372P",23,0)
 D MES^XPDUTL("*** PSB*3*72 Post Install Complete ***")
"RTN","PSB372P",24,0)
 D MES^XPDUTL("*** You may review global ^XTMP(""PSB72P"") for a list of entries modified ***")
"RTN","PSB372P",25,0)
 D MES^XPDUTL("")
"RTN","PSB372P",26,0)
 Q
"RTN","PSBCSUTX")
0^3^B69934937^B62829638
"RTN","PSBCSUTX",1,0)
PSBCSUTX ;BIRMINGHAM/TEJ- BCMA-HSC COVER SHEET UTILITIES 2 ;Mar 2004
"RTN","PSBCSUTX",2,0)
 ;;3.0;BAR CODE MED ADMIN;**16,13,38,32,72**;Mar 2004;Build 16
"RTN","PSBCSUTX",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBCSUTX",4,0)
 ; Reference/IA
"RTN","PSBCSUTX",5,0)
 ; $$GET1^DIQ/2056
"RTN","PSBCSUTX",6,0)
 ; $$SCH^XLFDT/10103
"RTN","PSBCSUTX",7,0)
 ; $$FMADD^XLFDT/10103
"RTN","PSBCSUTX",8,0)
 ; NEW PERSON FILE/10060
"RTN","PSBCSUTX",9,0)
ADD ; otput: ORD-ORC-DD-ADD-SOL-ID-ADM-CMT-END segmnts
"RTN","PSBCSUTX",10,0)
 K PSBDONE S PSBRECHD="ORD",PSBDONE=0,PSBCNT1=^TMP("PSB",$J,PSBTAB,0),PSBCNT2=1,$P(^TMP("PSB",$J,"CVRSHT2",0),U)=0
"RTN","PSBCSUTX",11,0)
 F PSBI1=1:1:PSBCNT1 D  Q:PSBDONE
"RTN","PSBCSUTX",12,0)
 .I PSBCNT1'>1 S PSBDONE=1 Q
"RTN","PSBCSUTX",13,0)
 .I PSBI1=1 S ^TMP("PSB",$J,"CVRSHT2",PSBCNT2)=^TMP("PSB",$J,"CVRSHT",1) Q
"RTN","PSBCSUTX",14,0)
 .I ^TMP("PSB",$J,PSBTAB,PSBI1)="END" S PSBRECHD="ORD",PSBCNT2=PSBCNT2+1,^TMP("PSB",$J,"CVRSHT2",PSBCNT2)="END"  Q
"RTN","PSBCSUTX",15,0)
 .I PSBRECHD="ORD" D ORD Q
"RTN","PSBCSUTX",16,0)
 .I PSBRECHD="ORC" D ORC^PSBCSUTY Q
"RTN","PSBCSUTX",17,0)
 .I PSBRECHD="ORF" D ORF^PSBCSUTY
"RTN","PSBCSUTX",18,0)
 .I PSBRECHD="MED" D MED^PSBCSUTY Q
"RTN","PSBCSUTX",19,0)
 S $P(^TMP("PSB",$J,"CVRSHT2",0),U)=PSBCNT2
"RTN","PSBCSUTX",20,0)
 M ^TMP("PSB",$J,PSBTAB)=^TMP("PSB",$J,"CVRSHT2") K PSBNXTDU D ADM
"RTN","PSBCSUTX",21,0)
 K ^TMP("PSB",$J,PSBTAB) M ^TMP("PSB",$J,PSBTAB)=^TMP("PSB",$J,"CVRSHT2") K ^TMP("PSB",$J,"CVRSHT2") D FINALPAS^PSBCSUTY
"RTN","PSBCSUTX",22,0)
 K ^TMP("PSB",$J,PSBTAB) M ^TMP("PSB",$J,PSBTAB)=^TMP("PSB",$J,"CVRSHT2") K ^TMP("PSB",$J,"CVRSHT2")
"RTN","PSBCSUTX",23,0)
 Q
"RTN","PSBCSUTX",24,0)
ORD ;
"RTN","PSBCSUTX",25,0)
 S PSBCNT2=PSBCNT2+1,(PSBORREC,PSBXREC)=^TMP("PSB",$J,PSBTAB,PSBI1)
"RTN","PSBCSUTX",26,0)
 S ($P(PSBXREC,U,12),$P(PSBXREC,U,23),$P(PSBXREC,U,24),PSBSCHTM,PSBONMBR,PSBIENX,PSBBAGID,PSBACT,PSBACTBY,PSBACTDT,PSBACTPT,PSBPRNRE,PSBXX,PSBXXX)=""
"RTN","PSBCSUTX",27,0)
 S ^TMP("PSB",$J,"CVRSHT2",PSBCNT2)="ORD",$P(^TMP("PSB",$J,"CVRSHT2",PSBCNT2),U,2)=PSBXREC
"RTN","PSBCSUTX",28,0)
 S PSBSCHTM=$P(PSBORREC,U,14),PSBONMBR=$P(PSBORREC,U,2),PSBIENX=$P(PSBORREC,U,12),PSBLRGIV=0
"RTN","PSBCSUTX",29,0)
 D CLEAN^PSBVT,PSJ1^PSBVT(DFN,PSBONMBR) S:(PSBONMBR["V")&'$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,+$G(PSBIVPSH)) PSBLRGIV=1
"RTN","PSBCSUTX",30,0)
 I '$D(PSBLST4X(PSBONMBR)) S PSBXX="" F PSBI=1:1 S PSBXX=$O(PSBADMX(PSBONMBR,PSBXX),-1) Q:PSBXX=""  S PSBXXX="" D  Q:$G(PSBLST4X(PSBONMBR))=4
"RTN","PSBCSUTX",31,0)
 .F  S PSBXXX=$O(PSBADMX(PSBONMBR,PSBXX,PSBXXX)) Q:PSBXXX=""  D  Q:$G(PSBLST4X(PSBONMBR))=4
"RTN","PSBCSUTX",32,0)
 ..I $$GET1^DIQ(53.79,PSBXXX_",","ACTION STATUS","I")'="N" S PSBLST4X(PSBONMBR,PSBXXX)="",PSBLST4X(PSBONMBR)=$G(PSBLST4X(PSBONMBR))+1
"RTN","PSBCSUTX",33,0)
 ..I ($$GET1^DIQ(53.79,PSBXXX_",","ACTION STATUS","I")="N")&($O(PSBADMX(PSBONMBR,PSBXX))="")  S PSBLST4X(PSBONMBR,PSBXXX)="",PSBLST4X(PSBONMBR)=$G(PSBLST4X(PSBONMBR))+1
"RTN","PSBCSUTX",34,0)
 I PSBIENX]"",$D(PSBLST4X(PSBONMBR,PSBIENX)) D
"RTN","PSBCSUTX",35,0)
 .S PSBBAGID=$$GET1^DIQ(53.79,PSBIENX_",","IV UNIQUE ID")
"RTN","PSBCSUTX",36,0)
 .S PSBACTDT=$$GET1^DIQ(53.79,PSBIENX_",","ACTION DATE/TIME","I")
"RTN","PSBCSUTX",37,0)
 .S PSBACT=$$GET1^DIQ(53.79,PSBIENX_",","ACTION STATUS","I")
"RTN","PSBCSUTX",38,0)
 .S PSBPRNRE=$$GET1^DIQ(53.79,PSBIENX_",","PRN REASON")
"RTN","PSBCSUTX",39,0)
 .S PSBACTBY=$$GETINIT^PSBCSUTX(PSBIENX,"I") S:PSBACTBY']"" PSBACTBY="***" ;Get initials of who took action, PSB*3*72
"RTN","PSBCSUTX",40,0)
 .S PSBACTPT=$$GETINIT^PSBCSUTX(PSBIENX,"II") ;Get IEN of who took action, PSB*3*72
"RTN","PSBCSUTX",41,0)
 .I '$D(PSBDONE(PSBIENX)) D
"RTN","PSBCSUTX",42,0)
 ..I PSBLRGIV,(PSBFON]"") Q
"RTN","PSBCSUTX",43,0)
 ..S PSBADMS(PSBONMBR,PSBSCHTM_PSBIENX)=PSBSCHTM_"^"_PSBBAGID_"^"_PSBIENX_"^"_PSBACT_"^"_PSBACTDT_"^"_PSBACTBY_"^"_PSBACTPT_"^"_PSBPRNRE
"RTN","PSBCSUTX",44,0)
 ..I PSBLRGIV D
"RTN","PSBCSUTX",45,0)
 ...I PSBOSP<PSBNOW S PSBADMS(PSBONMBR,"EXP")=""
"RTN","PSBCSUTX",46,0)
 ...S PSBADMS(PSBONMBR,PSBSCHTM_PSBIENX,1)=1
"RTN","PSBCSUTX",47,0)
 ..S PSBDONE(PSBIENX)="" K PSBADMX(PSBONMBR,PSBSCHTM,PSBIENX) D
"RTN","PSBCSUTX",48,0)
 ...S PSBXX="" F  S PSBXX=$O(PSBADMX(PSBONMBR,PSBXX)) Q:PSBXX=""  I $D(PSBADMX(PSBONMBR,PSBXX,PSBIENX)) K PSBADMX(PSBONMBR,PSBXX,PSBIENX)
"RTN","PSBCSUTX",49,0)
 I PSBIENX']"" D
"RTN","PSBCSUTX",50,0)
 .S PSBADMS(PSBONMBR,PSBSCHTM_PSBIENX)=PSBSCHTM_"^^^^^^^"
"RTN","PSBCSUTX",51,0)
 .I PSBLRGIV S PSBADMS(PSBONMBR,PSBSCHTM,1)=1
"RTN","PSBCSUTX",52,0)
 I "^O^OC^P^"[(U_PSBSCHT_U)&('$D(PSBADMS(PSBONMBR))) S PSBADMS(PSBONMBR,PSBSCHTM_PSBIENX)=PSBSCHTM_"^^^^^^^"
"RTN","PSBCSUTX",53,0)
 S PSBRECHD="ORC" K PSBSCHTM S PSBXREC=""
"RTN","PSBCSUTX",54,0)
 Q
"RTN","PSBCSUTX",55,0)
ADM ; Admn data
"RTN","PSBCSUTX",56,0)
 K PSBDONE S (PSBONMBR,PSBSCHTM)="" F PSBI1=2:1:$P(^TMP("PSB",$J,PSBTAB,0),U) D
"RTN","PSBCSUTX",57,0)
 .I $P(^TMP("PSB",$J,PSBTAB,PSBI1),U)="ORD" S PSBONMBR=$P(^TMP("PSB",$J,PSBTAB,PSBI1),U,3),$P(^TMP("PSB",$J,"CVRSHT2",PSBI1),U,15)=""
"RTN","PSBCSUTX",58,0)
 .S (PSBXX,PSBXXX)="" F  S PSBXX=$O(PSBADMX(PSBONMBR,PSBXX)) Q:PSBXX=""  F  S PSBXXX=$O(PSBADMX(PSBONMBR,PSBXX,PSBXXX)) Q:PSBXXX=""  D
"RTN","PSBCSUTX",59,0)
 ..S PSBSCHTM=PSBXX,PSBIENX=PSBXXX
"RTN","PSBCSUTX",60,0)
 ..I $D(PSBNOX(PSBONMBR)) I $P(^TMP("PSB",$J,"CVRSHT2",$O(PSBNOX(PSBONMBR,""))),U)="NOX" K ^TMP("PSB",$J,"CVRSHT2",$O(PSBNOX(PSBONMBR,"")))
"RTN","PSBCSUTX",61,0)
 ..Q:'$D(PSBLST4X(PSBONMBR,PSBIENX))
"RTN","PSBCSUTX",62,0)
 ..S PSBACT=$$GET1^DIQ(53.79,PSBIENX_",","ACTION STATUS","I")
"RTN","PSBCSUTX",63,0)
 ..I PSBACT']"" S PSBACT="U"
"RTN","PSBCSUTX",64,0)
 ..S PSBACTDT=$$GET1^DIQ(53.79,PSBIENX_",","ACTION DATE/TIME","I")
"RTN","PSBCSUTX",65,0)
 ..S PSBBAGID=$$GET1^DIQ(53.79,PSBIENX_",","IV UNIQUE ID")
"RTN","PSBCSUTX",66,0)
 ..S PSBPRNRE=$$GET1^DIQ(53.79,PSBIENX_",","PRN REASON")
"RTN","PSBCSUTX",67,0)
 ..S PSBACTBY=$$GETINIT^PSBCSUTX(PSBIENX,"I") S:PSBACTBY']"" PSBACTBY="***" ;Get initials of who took action, PSB*3*72
"RTN","PSBCSUTX",68,0)
 ..S PSBACTPT=$$GETINIT^PSBCSUTX(PSBIENX,"II") ;Get initials of who took action, PSB*3*72
"RTN","PSBCSUTX",69,0)
 ..S PSBADMS(PSBONMBR,PSBSCHTM_PSBIENX)=PSBSCHTM_"^"_PSBBAGID_"^"_PSBIENX_"^"_PSBACT_"^"_PSBACTDT_"^"_PSBACTBY_"^"_PSBACTPT_"^"_PSBPRNRE
"RTN","PSBCSUTX",70,0)
 ..I PSBIENX]"" K PSBADMX(PSBONMBR,PSBSCHTM,PSBIENX)
"RTN","PSBCSUTX",71,0)
 .I '$D(PSBADMS(PSBONMBR)) K ^TMP("PSB",$J,"CVRSHT2",PSBI1) Q
"RTN","PSBCSUTX",72,0)
 .I $P(^TMP("PSB",$J,PSBTAB,PSBI1),U)="END" K PSBADMS(PSBONMBR) Q
"RTN","PSBCSUTX",73,0)
 .I $P(^TMP("PSB",$J,PSBTAB,PSBI1+1),U)="END" D  Q
"RTN","PSBCSUTX",74,0)
 ..S PSBCNT2=1,PSBSCHTM=""
"RTN","PSBCSUTX",75,0)
 ..F  S PSBSCHTM=$O(PSBADMS(PSBONMBR,PSBSCHTM)) Q:+$G(PSBSCHTM)=0  D
"RTN","PSBCSUTX",76,0)
 ...S PSBIENX=$P(PSBADMS(PSBONMBR,PSBSCHTM),U,3)
"RTN","PSBCSUTX",77,0)
 ...I PSBIENX]"",'$D(PSBDONE(PSBIENX))  D
"RTN","PSBCSUTX",78,0)
 ....I $D(PSBNOX(PSBONMBR)) I $P(^TMP("PSB",$J,"CVRSHT2",$O(PSBNOX(PSBONMBR,""))),U)="NOX" K ^TMP("PSB",$J,"CVRSHT2",$O(PSBNOX(PSBONMBR,"")))
"RTN","PSBCSUTX",79,0)
 ....S PSBACT=$$GET1^DIQ(53.79,PSBIENX_",","ACTION STATUS","I")
"RTN","PSBCSUTX",80,0)
 ....I PSBACT']"" S PSBACT="U"
"RTN","PSBCSUTX",81,0)
 ....S PSBACTDT=$$GET1^DIQ(53.79,PSBIENX_",","ACTION DATE/TIME","I")
"RTN","PSBCSUTX",82,0)
 ....Q:PSBACT="N"
"RTN","PSBCSUTX",83,0)
 ....Q:$D(PSBADMS(PSBONMBR,"EXP"))&("SI"'[PSBACT)
"RTN","PSBCSUTX",84,0)
 ....S $P(PSBADMS(PSBONMBR,PSBSCHTM),U,4)=PSBACT
"RTN","PSBCSUTX",85,0)
 ....S ^TMP("PSB",$J,"CVRSHT2",PSBI1,PSBCNT2)="ADM^"_PSBADMS(PSBONMBR,PSBSCHTM)_"^"_$$NEXTADM(PSBDFNX,PSBONMBR),PSBCNT2=PSBCNT2+1
"RTN","PSBCSUTX",86,0)
 ....S PSBDONE(PSBIENX)=""
"RTN","PSBCSUTX",87,0)
 ....D CMT^PSBCSUTY
"RTN","PSBCSUTX",88,0)
 ...I (PSBIENX']"")&($G(PSBADMS(PSBONMBR,PSBSCHTM,1))'=1) D
"RTN","PSBCSUTX",89,0)
 ....S ^TMP("PSB",$J,"CVRSHT2",PSBI1,PSBCNT2)="ADM^"_PSBADMS(PSBONMBR,PSBSCHTM)_"^"_$$NEXTADM(PSBDFNX,PSBONMBR),PSBCNT2=PSBCNT2+1
"RTN","PSBCSUTX",90,0)
 ....I $D(PSBNOX(PSBONMBR)) I $P(^TMP("PSB",$J,"CVRSHT2",$O(PSBNOX(PSBONMBR,""))),U)="NOX" K ^TMP("PSB",$J,"CVRSHT2",$O(PSBNOX(PSBONMBR,"")))
"RTN","PSBCSUTX",91,0)
 K PSBSCHTM
"RTN","PSBCSUTX",92,0)
 Q
"RTN","PSBCSUTX",93,0)
NEXTADM(XX,YY) ;
"RTN","PSBCSUTX",94,0)
 S NEXTADM=""
"RTN","PSBCSUTX",95,0)
 I $D(PSBNXTDU(YY)) S NEXTADM=PSBNXTDU(YY) Q NEXTADM
"RTN","PSBCSUTX",96,0)
 D:YY'["P"
"RTN","PSBCSUTX",97,0)
 .S PSBPATX=XX,PSBORXX=YY D CLEAN^PSBVT,PSJ1^PSBVT(XX,YY)
"RTN","PSBCSUTX",98,0)
 .Q:(PSBORXX["V")&'$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,+$G(PSBIVPSH))
"RTN","PSBCSUTX",99,0)
 .S PSBGSCH=PSBADST,XX=PSBPATX,YY=PSBORXX,(NEXTADM,X,Y)="",X=$O(^PSB(53.79,"AORD",XX,YY,X),-1)
"RTN","PSBCSUTX",100,0)
 .I X]"" S Y=$O(^PSB(53.79,"AORD",XX,YY,X,Y),-1) I ($F("NM",$P(^PSB(53.79,Y,0),U,9))>1)!($P(^PSB(53.79,Y,0),U,9)="") S NEXTADM=X
"RTN","PSBCSUTX",101,0)
 .D:X']""
"RTN","PSBCSUTX",102,0)
 ..S Y="",X=$O(^PSB(53.79,"AORDX",XX,YY,X),-1)
"RTN","PSBCSUTX",103,0)
 ..I X]"" S Y=$O(^PSB(53.79,"AORDX",XX,YY,X,Y),-1) I $F("NM",$P(^PSB(53.79,Y,0),U,9))>1!($P(^PSB(53.79,Y,0),U,9)="") S NEXTADM=$P(^PSB(53.79,Y,0),U,6)
"RTN","PSBCSUTX",104,0)
 .D:NEXTADM=""
"RTN","PSBCSUTX",105,0)
 ..S PSBGOTY=Y,PSBFREQ=$$GETFREQ^PSBVDLU1(XX,YY)
"RTN","PSBCSUTX",106,0)
 ..S PSBFREQ=$S(PSBFREQ="O":1440,PSBFREQ="D":"",1:PSBFREQ)
"RTN","PSBCSUTX",107,0)
 ..S (PSBXSCH,LSTTIME,LSTIEN)=""
"RTN","PSBCSUTX",108,0)
 ..S:PSBGOTY]"" LSTTIME=$O(^PSB(53.79,"AORD",PSBPATX,PSBORXX,LSTTIME),-1) I LSTTIME]"" S LSTIEN=$O(^PSB(53.79,"AORD",PSBPATX,PSBORXX,LSTTIME,""),-1)
"RTN","PSBCSUTX",109,0)
 ..I LSTIEN]"" S:$P(^PSB(53.79,LSTIEN,0),U,9)']"" LSTTIME=""
"RTN","PSBCSUTX",110,0)
 ..S:LSTTIME="" LSTTIME=$$FMADD^XLFDT(PSBOST,,,,-0.1)
"RTN","PSBCSUTX",111,0)
 ..I +PSBFREQ>0 S PSBXSCH=(+PSBFREQ/60)_"H"
"RTN","PSBCSUTX",112,0)
 ..S X=LSTTIME
"RTN","PSBCSUTX",113,0)
 ..F PSBIX1=1:1:($L(PSBGSCH,"-")+1) D  Q:NEXTADM>LSTTIME
"RTN","PSBCSUTX",114,0)
 ...I ($P(PSBGSCH,"-",PSBIX1))']"" D  Q
"RTN","PSBCSUTX",115,0)
 ....I PSBIX1=1 D  Q
"RTN","PSBCSUTX",116,0)
 .....I X<PSBOST S NEXTADM=PSBOST Q
"RTN","PSBCSUTX",117,0)
 .....S X=PSBOST F  S X=$$SCH^XLFDT(PSBXSCH,X) S Y="" S Y=$O(^PSB(53.79,"AORD",PSBPATX,PSBORXX,Y),-1)  I X>Y S NEXTADM=X Q
"RTN","PSBCSUTX",118,0)
 ....I PSBGSCH]"" D  Q
"RTN","PSBCSUTX",119,0)
 .....I (+PSBFREQ'>1440) F I=0:1 S PSBDTXX=$$FMADD^XLFDT(PSBOST,I) S $P(PSBDTXX,".",2)=($P(PSBGSCH,"-")) I PSBDTXX>LSTTIME S NEXTADM=PSBDTXX Q
"RTN","PSBCSUTX",120,0)
 .....I (+PSBFREQ'<1440),(1440#PSBFREQ=1440) F I=0:1 S PSBDTXX=$$FMADD^XLFDT(PSBOST,(I*(PSBFREQ\1440))) S $P(PSBDTXX,".",2)=($P(PSBGSCH,"-")) I PSBDTXX>LSTTIME S NEXTADM=PSBDTXX Q
"RTN","PSBCSUTX",121,0)
 ....S $P(X,".",2)=$P(PSBGSCH,"-"),NEXTADM=$$SCH^XLFDT(PSBXSCH,X) Q
"RTN","PSBCSUTX",122,0)
 ...S $P(X,".",2)=$P(PSBGSCH,"-",PSBIX1) S:X<PSBOSP NEXTADM=X
"RTN","PSBCSUTX",123,0)
 .S:NEXTADM'<PSBOSP NEXTADM=""
"RTN","PSBCSUTX",124,0)
 .I $$PSBDCHK1^PSBVT1(PSBSCH) D
"RTN","PSBCSUTX",125,0)
 ..S YY=PSBORXX,XX=PSBPATX
"RTN","PSBCSUTX",126,0)
 ..I $G(LSTTIME)]"" S NEXTADM=$S(LSTTIME'<PSBOST:LSTTIME,NEXTADM>LSTTIME:NEXTADM,1:PSBOST)
"RTN","PSBCSUTX",127,0)
 ..I PSBFREQ="" S PSBDTX=$P(NEXTADM,".") F PSBIX3=0:1 S X=$$FMADD^XLFDT(PSBDTX,PSBIX3) Q:X>PSBOSP  D  Q:$G(PSBYS)
"RTN","PSBCSUTX",128,0)
 ...S PSBNXTDT=X D DW^%DTC S PSBYS=0 F PSBIX2=1:1 S PSBDY=$P($P(PSBSCH,"@"),"-",PSBIX2) Q:PSBDY=""  I $F(X,PSBDY)>1 S PSBYS=1
"RTN","PSBCSUTX",129,0)
 ...I PSBYS S PSBSCTM=$$GETADMIN^PSBVDLU1(XX,YY,PSBNXTDT,"","") K ^TMP("PSB",$J,"GETADMIN") D
"RTN","PSBCSUTX",130,0)
 ....F PSBIX4=1:1 S PSBTX=$P(PSBSCTM,"-",PSBIX4) Q:PSBTX=""  D  Q:PSBYS
"RTN","PSBCSUTX",131,0)
 .....I NEXTADM>(PSBNXTDT_"."_PSBTX) S PSBYS=0 Q
"RTN","PSBCSUTX",132,0)
 .....S NEXTADM=PSBNXTDT,$P(NEXTADM,".",2)=PSBTX
"RTN","PSBCSUTX",133,0)
 .....I NEXTADM]"" I (NEXTADM<PSBOST)!$D(^PSB(53.79,"AORD",PSBPATX,PSBORXX,+NEXTADM))!(NEXTADM>PSBOSP) S PSBYS=0,NEXTADM="" Q
"RTN","PSBCSUTX",134,0)
 .....S PSBYS=1
"RTN","PSBCSUTX",135,0)
 .S PSBNXTDU(PSBORXX)=NEXTADM
"RTN","PSBCSUTX",136,0)
 .D CLEAN^PSBVT
"RTN","PSBCSUTX",137,0)
 Q NEXTADM
"RTN","PSBCSUTX",138,0)
GETINIT(PSBIEN,PSBTYPE) ;Get initials or name of who actually took the action, PSB*3*72
"RTN","PSBCSUTX",139,0)
 N PSBACT,PSBINT
"RTN","PSBCSUTX",140,0)
 S (PSBINT,PSBACT)="" I $D(^PSB(53.79,PSBIEN,.9)) D
"RTN","PSBCSUTX",141,0)
 .F  S PSBACT=$O(^PSB(53.79,PSBIEN,.9,PSBACT),-1) Q:'PSBACT  I $P($G(^PSB(53.79,PSBIEN,.9,PSBACT,0)),U,3)["Field: ACTION STATUS" S PSBINT=$P(^PSB(53.79,PSBIEN,.9,PSBACT,0),U,5) Q
"RTN","PSBCSUTX",142,0)
 I PSBINT,PSBTYPE="II" Q PSBINT
"RTN","PSBCSUTX",143,0)
 I PSBINT,PSBTYPE="I" S PSBINT=$$GET1^DIQ(200,PSBINT,1)
"RTN","PSBCSUTX",144,0)
 I PSBINT,PSBTYPE="N" S PSBINT=$$GET1^DIQ(200,PSBINT,.01)
"RTN","PSBCSUTX",145,0)
 Q PSBINT
"RTN","PSBML")
0^7^B127507803^B123316080
"RTN","PSBML",1,0)
PSBML ;BIRMINGHAM/EFC-BCMA MED LOG FUNCTIONS ;10/23/12 12:14pm
"RTN","PSBML",2,0)
 ;;3.0;BAR CODE MED ADMIN;**6,3,4,9,11,13,25,45,33,52,70,72**;Mar 2004;Build 16
"RTN","PSBML",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBML",4,0)
 ; Reference/IA
"RTN","PSBML",5,0)
 ; ^DPT/10035
"RTN","PSBML",6,0)
 ; DIC(42/10039
"RTN","PSBML",7,0)
 ; DIC(42/2440
"RTN","PSBML",8,0)
 ; File 200/10060
"RTN","PSBML",9,0)
 ; EN^PSJBCMA3/3320
"RTN","PSBML",10,0)
 ; $$SITE^VASITE/10112
"RTN","PSBML",11,0)
 ; ^XUSEC(/10076
"RTN","PSBML",12,0)
 ;
"RTN","PSBML",13,0)
 ;*70 - store clinic name to admin location if exists.
"RTN","PSBML",14,0)
 ;    - add witness duz, dt/tm for high risk/alert drug, Order level
"RTN","PSBML",15,0)
 ;      HR code, and a witnesssed y/n flag to MEDLOG file.
"RTN","PSBML",16,0)
 ;
"RTN","PSBML",17,0)
RPC(RESULTS,PSBHDR,PSBREC) ;BCMA MedLog Filing
"RTN","PSBML",18,0)
 S PSBEDTFL=0
"RTN","PSBML",19,0)
 N PSBORD,PSBTRAN,PSBFDA,PSBMES ;Add PSBMES variable for PSB*3*52
"RTN","PSBML",20,0)
 N PSBCLIN,PSBWITN,PSBWITCM,PSBWITHR,PSBWITFL,LOC                 ;*70
"RTN","PSBML",21,0)
 K PSBIEN,PSBHL7
"RTN","PSBML",22,0)
 S PSBIEN=$P(PSBHDR,U,1)
"RTN","PSBML",23,0)
 S PSBTRAN=$P(PSBHDR,U,2),PSBHL7=PSBTRAN
"RTN","PSBML",24,0)
 S PSBINST=$P($G(PSBHDR),U,3)
"RTN","PSBML",25,0)
 ;*70 witness fields
"RTN","PSBML",26,0)
 S PSBWITN=+$P(PSBHDR,U,4)                   ;init witness duz var
"RTN","PSBML",27,0)
 S PSBWITCM=$P(PSBHDR,U,5)                   ;init witness comment
"RTN","PSBML",28,0)
 S PSBWITHR=+$P(PSBHDR,U,6)                  ;init witn HR order level
"RTN","PSBML",29,0)
 S PSBWITFL=$S(PSBWITN:1,1:0)             ;init witnessed?
"RTN","PSBML",30,0)
 I PSBWITN="",PSBWITHR=3 D  Q
"RTN","PSBML",31,0)
 .S RESULTS(0)=1
"RTN","PSBML",32,0)
 .S RESULTS(1)="-1^A Witness is required, however Witness information was null."
"RTN","PSBML",33,0)
 ;PSB*3*45 We should be recording the first entry in the audit log.
"RTN","PSBML",34,0)
 ;S PSBAUDIT=$S(PSBIEN="+1":0,1:1)
"RTN","PSBML",35,0)
 S PSBAUDIT=1
"RTN","PSBML",36,0)
 D NOW^%DTC S PSBNOW=%
"RTN","PSBML",37,0)
 I $D(^XUSEC("PSB STUDENT",DUZ)),PSBINST="" S RESULTS(0)=1,RESULTS(1)="-1^Instructor not present" Q
"RTN","PSBML",38,0)
 I $D(^XUSEC("PSB STUDENT",DUZ)),'$D(^XUSEC("PSB INSTRUCTOR",PSBINST)) S RESULTS(0)=1,RESULTS(1)="-1^Instructor doesn't have authority" Q
"RTN","PSBML",39,0)
 S PSBINST(0)=$$GET1^DIQ(200,PSBINST_",",.01)
"RTN","PSBML",40,0)
 I PSBTRAN="ADD COMMENT" D COMMENT^PSBML1 Q
"RTN","PSBML",41,0)
 I PSBTRAN="PRN EFFECTIVENESS" D PRN^PSBML1 Q
"RTN","PSBML",42,0)
 ;
"RTN","PSBML",43,0)
 ;update medlog rec
"RTN","PSBML",44,0)
UPD I PSBTRAN="UPDATE STATUS" D  Q
"RTN","PSBML",45,0)
 .I '$D(^PSB(53.79,PSBIEN)) D  Q
"RTN","PSBML",46,0)
 ..S RESULTS(0)=1
"RTN","PSBML",47,0)
 ..S RESULTS(1)="-1^Administration is at an UNKNOWN STATUS"
"RTN","PSBML",48,0)
 .D UPDATED^PSBML2
"RTN","PSBML",49,0)
 ;
"RTN","PSBML",50,0)
 ;edit Medlog rec
"RTN","PSBML",51,0)
 I PSBTRAN="EDIT" D EDIT^PSBML2 Q
"RTN","PSBML",52,0)
 ;
"RTN","PSBML",53,0)
 ;SAGG
"RTN","PSBML",54,0)
 N PSBWARD S PSBWARD=$G(^DPT(+$G(PSBREC(0)),.1),"UNKNOWN"),^PSB("SAGG",PSBWARD,DT)=$G(^PSB("SAGG",PSBWARD,DT))+1
"RTN","PSBML",55,0)
 ;*70 save clinic name if exists before manipulating PSBREC(1) param
"RTN","PSBML",56,0)
 S PSBCLIN=$P(PSBREC(1),U,2) I PSBCLIN="" S PSBCLIN=$S($G(PSBCLIEN):$P($G(^SC(+PSBCLIEN,0)),"^"),($G(PSBCLORD)]""):PSBCLORD,1:"")
"RTN","PSBML",57,0)
 S PSBREC(1)=$P(PSBREC(1),U)
"RTN","PSBML",58,0)
 ;
"RTN","PSBML",59,0)
 ;pre-existing psbrec(1) manipulation logic to *70
"RTN","PSBML",60,0)
 I PSBREC(1)?1U1";"1.6N S PSBREC(1)=$P(PSBREC(1),";",1)_$E(PSBREC(1))
"RTN","PSBML",61,0)
 D PSJ1^PSBVT(PSBREC(0),$P(PSBREC(1),";",2)_$P(PSBREC(1),";",1))
"RTN","PSBML",62,0)
 S PSBTAB=$P(PSBREC(9),U,1),PSBUID=$P(PSBREC(9),U,2)
"RTN","PSBML",63,0)
MEDP D:PSBTRAN="MEDPASS"
"RTN","PSBML",64,0)
 .I (PSBDOSEF["PATCH"),(PSBREC(3)="G") D  Q:+$G(RESULTS(1))<0
"RTN","PSBML",65,0)
 ..S PSBXDT="" F  S PSBXDT=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBXDT)) Q:PSBXDT=""  D  Q:+$G(RESULTS(1))<0
"RTN","PSBML",66,0)
 ...S PSBYZ="" F  S PSBYZ=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBXDT,PSBYZ)) Q:'PSBYZ  I ("G"[$$GET1^DIQ(53.79,PSBYZ,.09,"I")) D  Q
"RTN","PSBML",67,0)
 ....S:($$GET1^DIQ(53.79,PSBYZ,.09,"I")="G") RESULTS(0)=1,RESULTS(1)="-1^Previous Patch has not been removed. Administration canceled."
"RTN","PSBML",68,0)
 ....S:($$GET1^DIQ(53.79,PSBYZ,.09,"I")="")&(($$GET1^DIQ(53.79,PSBYZ,.07,"I")'=DUZ)&('$D(^XUSEC("PSB MANAGER",DUZ)))) RESULTS(0)=1,RESULTS(1)="-1^Patch status ""*UNKNOWN*"". Administration canceled."
"RTN","PSBML",69,0)
 .I PSBREC(7)="BCMA/CPRS Interface Entry." S PSBNOW=PSBREC(5)  ;MOB
"RTN","PSBML",70,0)
 .F X=0:1:9 S PSBREC(X)=$G(PSBREC(X))
"RTN","PSBML",71,0)
 .I PSBREC(1)?1U1";".N S PSBREC(1)=$P(PSBREC(1),";",2)_$P(PSBREC(1),";",1)
"RTN","PSBML",72,0)
 .I PSBREC(1)["V",+PSBREC(5)>0,+$P(PSBREC(5),".",2)=0,PSBIVT'["P" D NOW^%DTC S PSBREC(5)=$P(PSBREC(5),".",1)_"."_$P(%,".",2)
"RTN","PSBML",73,0)
 .I $P(PSBREC(9),U,1)="IVTAB",$P(PSBREC(9),U,2)="" S PSBUID=$$GETWSID^PSBVDLU2(PSBREC(0),PSBREC(1))
"RTN","PSBML",74,0)
 .I $P(PSBREC(9),U,1)="PBTAB",$P(PSBREC(9),U,2)="",PSBREC(1)'["U",PSBREC(3)'="M",PSBREC(3)'="R",PSBREC(3)'="H" S PSBUID=$$GETWSID^PSBVDLU2(PSBREC(0),PSBREC(1))
"RTN","PSBML",75,0)
 .;OnCal
"RTN","PSBML",76,0)
 .D:PSBREC(2)="OC"
"RTN","PSBML",77,0)
 ..S X=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),"")) Q:X=""
"RTN","PSBML",78,0)
 ..S Y=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),X,0))
"RTN","PSBML",79,0)
 ..I $P(^PSB(53.79,Y,0),U,9)="G"&('$$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL")) D ERR(1,"On-Call already given")
"RTN","PSBML",80,0)
 .;1x
"RTN","PSBML",81,0)
 .D:PSBREC(2)="O"
"RTN","PSBML",82,0)
 ..S X=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),"")) Q:X=""
"RTN","PSBML",83,0)
 ..S Y=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),X,0))
"RTN","PSBML",84,0)
 ..I $P(^PSB(53.79,Y,0),U,9)="G" D ERR(1,"One Time already Given")
"RTN","PSBML",85,0)
 .;PRN
"RTN","PSBML",86,0)
 .I PSBREC(2)="P",PSBREC(3)'="M",$P(PSBREC(9),U,1)'="IVTAB" D
"RTN","PSBML",87,0)
 ..I PSBREC(6)="" D ERR(1,"PRN Medications MUST Have a PRN Reason")
"RTN","PSBML",88,0)
 ..I PSBREC(5)]"" D ERR(1,"PRN Orders don't have scheduled times")
"RTN","PSBML",89,0)
 ..I PSBREC(3)'="G" D ERR(1,"PRN Orders cannot be marked NOT Given")
"RTN","PSBML",90,0)
 .;Cnt
"RTN","PSBML",91,0)
 .I PSBREC(2)="C",PSBTAB'="IVTAB" D
"RTN","PSBML",92,0)
 ..D:PSBREC(5)="" ERR(1,"Continuous Order needs admin time")
"RTN","PSBML",93,0)
 ..D:PSBREC(6)]"" ERR(1,"No PRN Reason allowed on Continuous Orders")
"RTN","PSBML",94,0)
 .I PSBREC(2)="C",$D(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),+PSBREC(5))),PSBIEN="+1" D  K PSBADMBY,PSBADMAT Q:PSBSIEN=""  Q:$P(^PSB(53.79,PSBSIEN,0),U,9)'="N"
"RTN","PSBML",95,0)
 ..S PSBSIEN=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),PSBREC(5),""))
"RTN","PSBML",96,0)
 ..I PSBSIEN]"" I '(($P(^PSB(53.79,PSBSIEN,0),U,7)=DUZ)!($D(^XUSEC("PSB MANAGER",DUZ)))) S PSBSIEN=""
"RTN","PSBML",97,0)
 ..I PSBSIEN']"" S RESULTS(0)=2,RESULTS(1)="-2^Error Filing Transaction MEDPASS",RESULTS(2)="The PSB MANAGER key is required to modify this scheduled admin" Q
"RTN","PSBML",98,0)
 ..D:$P(^PSB(53.79,PSBSIEN,0),U,9)'="N"
"RTN","PSBML",99,0)
 ...K PSBINCX I $P(^PSB(53.79,PSBSIEN,0),U,9)="" S PSBINCX=PSBSIEN L +^PSB(53.79,PSBINCX):1 Q:'$T  L -^PSB(53.79,PSBINCX)
"RTN","PSBML",100,0)
 ...S Y=$P(^PSB(53.79,PSBSIEN,0),U,6) D DD^%DT S PSBADMAT=Y
"RTN","PSBML",101,0)
 ...S PSBADMBY=$$GET1^DIQ(200,$P(^PSB(53.79,PSBSIEN,0),U,7),.01,)
"RTN","PSBML",102,0)
 ...S RESULTS(0)=3,RESULTS(1)="-2^Error Filing Transaction MEDPASS"
"RTN","PSBML",103,0)
 ...S RESULTS(2)="Continuous Administration Date/Time already on file."
"RTN","PSBML",104,0)
 ...S RESULTS(3)="Administered by "_PSBADMBY_" at "_PSBADMAT_"."
"RTN","PSBML",105,0)
 ...I $D(XWB) S RESULTS(0)=RESULTS(0)+2,RESULTS(4)="                                         ",RESULTS(5)="            VDL will now be updated."
"RTN","PSBML",106,0)
 .;Non Given
"RTN","PSBML",107,0)
 .I PSBREC(3)'="G",PSBREC(3)'="M",PSBUID'["V",PSBUID'["W" D
"RTN","PSBML",108,0)
 ..I PSBREC(7)="",PSBTAB'="IVTAB" D ERR(1,"Comment needed if Not Marked Given")
"RTN","PSBML",109,0)
 ..I PSBREC(7)="",PSBTAB="IVTAB" D ERR(1,"Comment needed if Not Marked Completed")
"RTN","PSBML",110,0)
 .S:PSBREC(3)="H" PSBREC(7)="Held: "_PSBREC(7)    ;.3
"RTN","PSBML",111,0)
 .S:PSBREC(3)="R" PSBREC(7)="Refused: "_PSBREC(7) ;.3
"RTN","PSBML",112,0)
 .S:PSBREC(3)="S" PSBREC(7)="Stopped: "_PSBREC(7) ;.3
"RTN","PSBML",113,0)
 .;Valid?
"RTN","PSBML",114,0)
 .I $G(PSBSIEN)'="" I $D(^PSB(53.79,PSBSIEN,0)) I $P(^PSB(53.79,PSBSIEN,0),U,9)="N" S PSBIEN=+PSBSIEN_",",$P(PSBHDR,U)=PSBIEN,PSBTRAN="UPDATE STATUS",PSBAUDIT=1                   ;do UPDATE
"RTN","PSBML",115,0)
 .D:PSBIEN="+1"                          ;New fields only?
"RTN","PSBML",116,0)
 ..D VAL(53.79,PSBIEN,.01,"`"_PSBREC(0))           ;Patn
"RTN","PSBML",117,0)
 ..S LOC=$G(^DPT(PSBREC(0),.1))_" "_$G(^(.101))    ;Ward Room/Bed LOC
"RTN","PSBML",118,0)
 ..S:PSBCLIN]"" LOC=PSBCLIN         ;If clinic order use clin name *70
"RTN","PSBML",119,0)
 ..D VAL(53.79,PSBIEN,.02,LOC)                     ;Patn Location LOC
"RTN","PSBML",120,0)
 ..D:$G(^DPT(PSBREC(0),.1))'=""
"RTN","PSBML",121,0)
 ...S Y=$O(^DIC(42,"B",$G(^DPT(PSBREC(0),.1)),"")),Y=$$GET1^DIQ(42,Y,.015,"I"),PSBDIV=$$SITE^VASITE(DT,Y)
"RTN","PSBML",122,0)
 ...D VAL(53.79,PSBIEN,.03,"`"_$P(PSBDIV,U,1))     ;Div
"RTN","PSBML",123,0)
 ..D VAL(53.79,PSBIEN,.04,PSBNOW)                  ;Entered dt/tm
"RTN","PSBML",124,0)
 ..D VAL(53.79,PSBIEN,.05,"`"_DUZ)                 ;Entered by duz
"RTN","PSBML",125,0)
 ..D VAL(53.79,PSBIEN,.06,PSBNOW)                  ;Admin dt/tm
"RTN","PSBML",126,0)
 ..D VAL(53.79,PSBIEN,.07,"`"_DUZ)                 ;Admin By duz
"RTN","PSBML",127,0)
 ..D VAL(53.79,PSBIEN,.08,"`"_PSBREC(4))           ;Orderable Item
"RTN","PSBML",128,0)
 ..D VAL(53.79,PSBIEN,.11,PSBREC(1))               ;Ord file 55 IEN
"RTN","PSBML",129,0)
 ..D VAL(53.79,PSBIEN,.12,PSBREC(2))               ;Ord Schd Type
"RTN","PSBML",130,0)
 ..D VAL(53.79,PSBIEN,.13,PSBREC(5))               ;Schd Adm dt/tm
"RTN","PSBML",131,0)
 ..D:PSBTAB'="UDTAB" VAL(53.79,PSBIEN,.26,PSBUID)  ;IV Bag ID
"RTN","PSBML",132,0)
 ..D:PSBTAB="IVTAB" VAL(53.79,PSBIEN,.13,"")       ;Schd Admdt/tm null
"RTN","PSBML",133,0)
 ..D:PSBREC(1)?.N1"U" VAL(53.79,PSBIEN,.15,PSBDOSE)  ;UD Dosage
"RTN","PSBML",134,0)
 ..D:PSBREC(1)?.N1"V" VAL(53.79,PSBIEN,.35,PSBIFR)   ;IV Infuse Rate
"RTN","PSBML",135,0)
 ..I PSBWITHR>1,(PSBREC(3)="G")!(PSBREC(3)="I") D          ;Witness logic and Give?  *70
"RTN","PSBML",136,0)
 ...D:PSBWITN VAL(53.79,PSBIEN,.28,PSBNOW)        ;Witness dt/time
"RTN","PSBML",137,0)
 ...D:PSBWITN VAL(53.79,PSBIEN,.29,"`"_PSBWITN)   ;Witness duz
"RTN","PSBML",138,0)
 ...D:PSBWITCM]"" VAL(53.79,PSBIEN,.31,PSBWITCM)  ;Witness comment
"RTN","PSBML",139,0)
 ...D VAL(53.79,PSBIEN,.32,PSBWITHR)              ;Witness HR ord code
"RTN","PSBML",140,0)
 ...D VAL(53.79,PSBIEN,.33,PSBWITFL)              ;Witnessed? flag
"RTN","PSBML",141,0)
 .;
"RTN","PSBML",142,0)
 .;Overwrite fields below, rec already exsts
"RTN","PSBML",143,0)
 .I PSBREC(3)="G"!(PSBREC(3))="C" D                ;Gvn/Completed?
"RTN","PSBML",144,0)
 ..D VAL(53.79,PSBIEN,.06,PSBNOW)                    ;Admin dt/tm
"RTN","PSBML",145,0)
 ..D VAL(53.79,PSBIEN,.07,"`"_DUZ)                   ;Admin By duz
"RTN","PSBML",146,0)
 .D:PSBREC(8)]"" VAL(53.79,PSBIEN,.16,PSBREC(8))   ;InjctSte
"RTN","PSBML",147,0)
 .D:'$G(PSBMMEN) VAL(53.79,PSBIEN,.09,PSBREC(3))   ;AStats
"RTN","PSBML",148,0)
 .I PSBREC(6)]"" D                                 ;PRN reason?
"RTN","PSBML",149,0)
 ..D VAL(53.79,PSBIEN,.21,$P(PSBREC(6),U))           ;reason dt/tm
"RTN","PSBML",150,0)
 ..D VAL(53.79,PSBIEN,.27,$P(PSBREC(6),U,2))         ;PRN reason
"RTN","PSBML",151,0)
 .D:PSBREC(7)]""
"RTN","PSBML",152,0)
 ..D VAL(53.793,"+2,"_PSBIEN,.01,PSBREC(7))        ;Comment
"RTN","PSBML",153,0)
 ..D VAL(53.793,"+2,"_PSBIEN,.02,"`"_DUZ)          ;comnt person duz
"RTN","PSBML",154,0)
 ..D VAL(53.793,"+2,"_PSBIEN,.03,PSBNOW)           ;comnt dt/time
"RTN","PSBML",155,0)
 .;DD/SOL/ADD
"RTN","PSBML",156,0)
 .I PSBREC(3)="G"!(PSBREC(3)="I")!(PSBREC(3)="H")!(PSBREC(3)="R")!(PSBREC(3)="M") D     ;given/action stat codes?
"RTN","PSBML",157,0)
 ..I PSBTRAN="UPDATE STATUS" K ^PSB(53.79,+PSBIEN,.5),^PSB(53.79,+PSBIEN,.6),^PSB(53.79,+PSBIEN,.7)
"RTN","PSBML",158,0)
 ..F PSBCNT=10:1 Q:'$D(PSBREC(PSBCNT))  D
"RTN","PSBML",159,0)
 ...S Y=$P(PSBREC(PSBCNT),U)
"RTN","PSBML",160,0)
 ...S PSBDD=$S(Y="DD":53.795,Y="ADD":53.796,Y="SOL":53.797,1:0)
"RTN","PSBML",161,0)
 ...Q:'PSBDD
"RTN","PSBML",162,0)
 ...S PSBIENS="+"_PSBCNT_","_PSBIEN
"RTN","PSBML",163,0)
 ...D VAL(PSBDD,PSBIENS,.01,"`"_$P(PSBREC(PSBCNT),U,2))
"RTN","PSBML",164,0)
 ...D:PSBDD=53.795 VAL(PSBDD,PSBIENS,.02,$P(PSBREC(PSBCNT),U,3))
"RTN","PSBML",165,0)
 ...D:PSBDD=53.796!(PSBDD=53.797) VAL(PSBDD,PSBIENS,.02,$P(PSBREC(PSBCNT),U,4)) ;Store units in Units ordered field, PSB*3*72
"RTN","PSBML",166,0)
 ...D:PSBREC(3)="G"!(PSBREC(3)="I") VAL(PSBDD,PSBIENS,.03,$P(PSBREC(PSBCNT),U,4)) ;only store units given when infusing or given, PSB*3*72
"RTN","PSBML",167,0)
 ...D:(PSBTAB="UDTAB")!(PSBTAB="PBTAB") VAL(PSBDD,PSBIENS,.04,$E($P(PSBREC(PSBCNT),U,5),1,40))
"RTN","PSBML",168,0)
 ...D VAL(PSBDD,PSBIENS,.05,$P(PSBREC(PSBCNT),U,7))        ;HR ind *70
"RTN","PSBML",169,0)
 .;Modify Filing Transaction Medpass error message too inclde details - PSB*3*52
"RTN","PSBML",170,0)
 .I $O(RESULTS("")) D  Q
"RTN","PSBML",171,0)
 ..N PSBERR
"RTN","PSBML",172,0)
 ..I $D(PSBMES) D
"RTN","PSBML",173,0)
 ...S RESULTS(1)="-2^***Your documentation is NOT being recorded in the patient record.***",RESULTS(2)=""
"RTN","PSBML",174,0)
 ...S RESULTS(3)="Please write down the information (below) AND contact your BCMA Coordinator or IT Support for assistance:",RESULTS(4)=""
"RTN","PSBML",175,0)
 ...S RESULTS(5)="Error(s) Filing Transaction MEDPASS"
"RTN","PSBML",176,0)
 ..S PSBERR=0 F  S PSBERR=$O(PSBMES(PSBERR)) Q:PSBERR=""  D
"RTN","PSBML",177,0)
 ...S RESULTS($O(RESULTS(""),-1)+1)=PSBMES(PSBERR),RESULTS(0)=$O(RESULTS(""),-1)
"RTN","PSBML",178,0)
 .;
"RTN","PSBML",179,0)
 .D FILEIT
"RTN","PSBML",180,0)
 .;
"RTN","PSBML",181,0)
 .;PSB*3*33
"RTN","PSBML",182,0)
 .D:((PSBREC(2)="O")!($$ONE^PSJBCMA(PSBREC(0),PSBREC(1))="O"))&(PSBREC(3)="G") EXPIRE^PSBML1  ;1x exp?
"RTN","PSBML",183,0)
 .D:(PSBREC(2)="O")&(PSBREC(3)="G") EXPIRE^PSBML1  ;1x exp?
"RTN","PSBML",184,0)
 .I $P(RESULTS(0),U,1)=1,PSBTAB'="UDTAB",PSBUID]"",PSBUID'["WS" S PSBON=+PSBREC(1) D EN^PSJBCMA3(PSBREC(0),PSBON,PSBUID,PSBREC(3),PSBNOW)
"RTN","PSBML",185,0)
 Q
"RTN","PSBML",186,0)
BCBU ;HL7,NatContng
"RTN","PSBML",187,0)
 Q:+$G(RESULTS(0))'>0
"RTN","PSBML",188,0)
 N PSBIEN1 S PSBIEN1=$S($P(PSBIEN,",",2)'="":+$P(PSBIEN,",",2),$G(PSBIEN)="+1":PSBIEN(1),1:+$G(PSBIEN))
"RTN","PSBML",189,0)
 I $G(PSBIEN1)="" S RESULTS(0)=1,RESULTS(1)="-1^Contingency NOT processed" Q
"RTN","PSBML",190,0)
 I $G(PSBIEN)="+1" S PSBHL7="MEDPASS"
"RTN","PSBML",191,0)
 E  S:$G(PSBHL7)="" PSBHL7="UPDATE STATUS"
"RTN","PSBML",192,0)
 D:('$D(Y(0))!($G(Y(0))="SAVE")!($G(Y(0))="YES")) EN^PSBSVHL7(+PSBIEN1,PSBHL7),MEDL^ALPBCBU(+PSBIEN1) K PSBHL7
"RTN","PSBML",193,0)
 ;<<HDR-VDEF(frm *3)
"RTN","PSBML",194,0)
 Q
"RTN","PSBML",195,0)
VAL(PSBDD,PSBIEN,PSBFLD,PSBVAL) ;
"RTN","PSBML",196,0)
 K ^TMP("DIERR",$J),PSBRET
"RTN","PSBML",197,0)
 D VAL^DIE(PSBDD,PSBIEN,PSBFLD,"F",PSBVAL,.PSBRET,"PSBFDA")
"RTN","PSBML",198,0)
 I PSBRET="^" F X=0:0 S X=$O(^TMP("DIERR",$J,X)) Q:'X  D ERR(2,^TMP("DIERR",$J,X)_": "_$G(^(X,"TEXT",1),"**"))
"RTN","PSBML",199,0)
 K ^TMP("DIERR",$J),PSBRET
"RTN","PSBML",200,0)
 Q
"RTN","PSBML",201,0)
FILEIT ;Updt
"RTN","PSBML",202,0)
 N PSBMSG,PSBAUD
"RTN","PSBML",203,0)
 S (PSB1,PSB2)=""
"RTN","PSBML",204,0)
 D APATCH^PSBML3
"RTN","PSBML",205,0)
 D CLEAN^DILF
"RTN","PSBML",206,0)
 D RESETADM^PSBUTL
"RTN","PSBML",207,0)
 D UPDATE^DIE("","PSBFDA","PSBIEN","PSBMSG")
"RTN","PSBML",208,0)
 I '$G(PSBMMEN) S X=+PSBIEN I $F("HR",$P(^PSB(53.79,X,0),U,9))>1 F Y=.5,.6,.7 S Z=0 F  S Z=$O(^PSB(53.79,+X,Y,Z)) Q:+Z=0  S $P(^PSB(53.79,+X,Y,Z,0),U,3)=0
"RTN","PSBML",209,0)
 I $D(PSBMSG("DIERR")) S RESULTS(0)=1,RESULTS(1)="-1^"_PSBMSG("DIERR",1)_": "_PSBMSG("DIERR",1,"TEXT",1)  Q
"RTN","PSBML",210,0)
 I $G(PSB1)]"" X PSB1 I $G(PSB2)]"" X PSB2
"RTN","PSBML",211,0)
 I $D(PSBHDR) D:"NHMR"[$P(^PSB(53.79,$S($P(PSBHDR,"^",1)="+1":PSBIEN(1),1:+PSBIEN),0),U,9)
"RTN","PSBML",212,0)
 .N PSBINDX S PSBINDX=$S($P(PSBHDR,"^",1)="+1":PSBIEN(1),1:+PSBIEN)
"RTN","PSBML",213,0)
 .K ^PSB(53.79,"APATCH",$P(^PSB(53.79,PSBINDX,0),U),$P(^PSB(53.79,PSBINDX,0),U,6),PSBINDX)
"RTN","PSBML",214,0)
 S RESULTS(0)=1,RESULTS(1)="1^Data Successfully Filed^"_$S($G(PSBIEN(1))'="":$G(PSBIEN(1)),1:+$G(PSBIEN))
"RTN","PSBML",215,0)
 D BCBU  ;NatContng
"RTN","PSBML",216,0)
 I $G(PSBINST,0) S PSBAUD=$S($P(PSBHDR,"^",1)="+1":PSBIEN(1),1:$P(PSBHDR,"^",1)) D AUDIT^PSBMLU(PSBAUD,"Instructor "_PSBINST(0)_" present.",PSBTRAN)
"RTN","PSBML",217,0)
 Q
"RTN","PSBML",218,0)
ERR(X,Y) ;
"RTN","PSBML",219,0)
 S X=$P("Business Logic Error^Data Validation Error",U,X)
"RTN","PSBML",220,0)
 S RESULTS($O(RESULTS(""),-1)+1)=X_": "_Y
"RTN","PSBML",221,0)
 S PSBMES($O(PSBMES(""),-1)+1)=X_": "_Y
"RTN","PSBML",222,0)
 Q
"RTN","PSBML",223,0)
COMMENT(DA,PSBCMT) ;
"RTN","PSBML",224,0)
 N PSBFDA,PSBIEN,PSBNOW
"RTN","PSBML",225,0)
 S PSBIEN="+1,"_DA_","
"RTN","PSBML",226,0)
 D NOW^%DTC S PSBNOW=%
"RTN","PSBML",227,0)
 D VAL(53.793,PSBIEN,.01,PSBCMT)
"RTN","PSBML",228,0)
 S PSBFDA(53.793,PSBIEN,.02)=DUZ
"RTN","PSBML",229,0)
 S PSBFDA(53.793,PSBIEN,.03)=PSBNOW
"RTN","PSBML",230,0)
 D FILEIT
"RTN","PSBML",231,0)
 Q
"RTN","PSBML2")
0^8^B103484155^B90238392
"RTN","PSBML2",1,0)
PSBML2 ;BIRMINGHAM/TEJ-BCMA UTILITY TO EDIT THE PSB MED LOG  ; 2/11/13 4:47pm
"RTN","PSBML2",2,0)
 ;;3.0;BAR CODE MED ADMIN;**3,18,22,23,13,45,42,70,72**;Mar 2004;Build 16
"RTN","PSBML2",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.;
"RTN","PSBML2",4,0)
 ; Reference/IA
"RTN","PSBML2",5,0)
 ; EN^PSJBCMA3/3320
"RTN","PSBML2",6,0)
 ; ENE^PSJBCMA4/3416
"RTN","PSBML2",7,0)
 ; ENR^PSJBCMA4/3416
"RTN","PSBML2",8,0)
 ;
"RTN","PSBML2",9,0)
 ;*70 - update Witness if present and Giving now as an updated, could 
"RTN","PSBML2",10,0)
 ;      mean undo given or a hold/refused was done first.
"RTN","PSBML2",11,0)
 ;
"RTN","PSBML2",12,0)
EDIT ;
"RTN","PSBML2",13,0)
 K RESULTS S PSBEDIEN=PSBIEN_",",RESULTS(0)=0
"RTN","PSBML2",14,0)
 I $G(PSBREC(7))']"" S RESULTS(0)=1,RESULTS(1)="-1^Data NOT filed - Comment is required" Q
"RTN","PSBML2",15,0)
 D
"RTN","PSBML2",16,0)
 .S PSBEDTFL=1,PSBMODS=0,PSBREC(1)=""
"RTN","PSBML2",17,0)
 .D:PSBREC(4)]"" VAL^PSBML(53.79,PSBEDIEN,.06,PSBREC(4))
"RTN","PSBML2",18,0)
 .I (PSBREC(0)="N") D
"RTN","PSBML2",19,0)
 ..I ($$GET1^DIQ(53.79,PSBEDIEN,.11)["V") F PSBX=1:1:6 S PSBREC(PSBX)=""
"RTN","PSBML2",20,0)
 .I ("NHR"[PSBREC(0)),$D(^PSB(53.79,+PSBEDIEN,.2)) D
"RTN","PSBML2",21,0)
 ..; Audit PRN
"RTN","PSBML2",22,0)
 ..D:$P(^PSB(53.79,+PSBEDIEN,.2),U,2)]"" AUDIT^PSBUTL(+PSBEDIEN,53.79,.22,$P(^PSB(53.79,+PSBEDIEN,.2),U,2),"K")
"RTN","PSBML2",23,0)
 ..I ($P(^PSB(53.79,+PSBEDIEN,0),U,9)="G")!($P(^PSB(53.79,+PSBEDIEN,0),U,9)="I") D
"RTN","PSBML2",24,0)
 ...I $D(^PSB(53.79,"APRN",$P(^PSB(53.79,+PSBEDIEN,0),U,1),$P(^PSB(53.79,+PSBEDIEN,0),U,6),+PSBEDIEN)) D
"RTN","PSBML2",25,0)
 ....K ^PSB(53.79,"APRN",$P(^PSB(53.79,+PSBEDIEN,0),U,1),$P(^PSB(53.79,+PSBEDIEN,0),U,6),+PSBEDIEN) K ^PSB(53.79,+PSBEDIEN,.2)
"RTN","PSBML2",26,0)
 .I ("NHR"'[PSBREC(0)) D:$G(PSBREC(5))]"" VAL^PSBML(53.79,PSBEDIEN,.21,$G(PSBREC(5))) D:$G(PSBREC(6))]"" VAL^PSBML(53.79,PSBEDIEN,.22,$G(PSBREC(6)))
"RTN","PSBML2",27,0)
 .I +$G(RESULTS(0))<0 S RESULTS(1)="-1^Data NOT filed - "_$P(RESULTS(0),U,2),RESULTS(0)=1 Q
"RTN","PSBML2",28,0)
 .D:$D(^PSB(53.79,+PSBEDIEN,.2)) VAL^PSBML(53.79,PSBEDIEN,.21,$G(PSBREC(5))),VAL^PSBML(53.79,PSBEDIEN,.22,$G(PSBREC(6)))
"RTN","PSBML2",29,0)
 .D VAL^PSBML(53.793,"+2,"_PSBIEN,.01,PSBREC(7))
"RTN","PSBML2",30,0)
 .D VAL^PSBML(53.793,"+2,"_PSBIEN,.02,"`"_DUZ)
"RTN","PSBML2",31,0)
 .D VAL^PSBML(53.793,"+2,"_PSBIEN,.03,PSBNOW)
"RTN","PSBML2",32,0)
 Q:+$G(RESULTS(1))<0
"RTN","PSBML2",33,0)
 S PSBMODS=$$CHANGE^PSBML3(.PSBREC,PSBEDIEN)
"RTN","PSBML2",34,0)
 D:PSBMODS UPDATED
"RTN","PSBML2",35,0)
 D:('$G(PSBERR))&('$G(PSBMODS)) FILEIT^PSBML
"RTN","PSBML2",36,0)
 ; Audit DD
"RTN","PSBML2",37,0)
 I $D(PSBORDMD) S (PSBXY,PSBXZ)="" D
"RTN","PSBML2",38,0)
 .F  S PSBXY=$O(PSBORDMD(PSBXY)) Q:PSBXY=""  S PSBFDAX=$S(PSBXY=.6:53.796,PSBXY=.7:53.797,1:53.795) F  S PSBXZ=$O(PSBORDMD(PSBXY,PSBXZ)) Q:PSBXZ=""  D
"RTN","PSBML2",39,0)
 ..S PSBXACT="",PSBXACT=$G(PSBORDMD(PSBXY,PSBXZ,0))
"RTN","PSBML2",40,0)
 ..D:PSBXACT["ADD" AUDIT^PSBUTL(+PSBEDIEN,PSBFDAX,.01,PSBXZ,"S") D:PSBXACT["DELETE" AUDIT^PSBUTL(+PSBEDIEN,PSBFDAX,.01,PSBXZ,"K")
"RTN","PSBML2",41,0)
 ;
"RTN","PSBML2",42,0)
 K PSBORDMD,PSBCHNG,PSBDDX,PSBEDTFL,PSBEDIEN,PSBFILED
"RTN","PSBML2",43,0)
 Q
"RTN","PSBML2",44,0)
 ;
"RTN","PSBML2",45,0)
UPDATED ;
"RTN","PSBML2",46,0)
 N PSBADD
"RTN","PSBML2",47,0)
 S PSBIEN=PSBIEN_",",PSBXPTCH=0
"RTN","PSBML2",48,0)
 S PSBRECNO=$S(PSBEDTFL:8,1:4)
"RTN","PSBML2",49,0)
 I "^G^N^H^R^RM^S^C^I^M^"[(U_PSBREC(0)_U) D
"RTN","PSBML2",50,0)
 .D:('PSBEDTFL) VAL^PSBML(53.79,PSBIEN,.06,PSBNOW)
"RTN","PSBML2",51,0)
 .D:$D(PSBREC(4,0)) VAL^PSBML(53.79,PSBIEN,.06,PSBREC(4))
"RTN","PSBML2",52,0)
 .D VAL^PSBML(53.79,PSBIEN,.07,"`"_DUZ)
"RTN","PSBML2",53,0)
 .D:('PSBEDTFL)!($G(PSBREC(0,0))) VAL^PSBML(53.79,PSBIEN,.09,PSBREC(0))
"RTN","PSBML2",54,0)
 .I $G(PSBREC(3))]"" D VAL^PSBML(53.79,PSBIEN,.26,PSBREC(3))
"RTN","PSBML2",55,0)
 I $D(PSBREC(PSBRECNO)) D:($G(PSBREC(0))="G")&($P(PSBREC(PSBRECNO),U,5)["PATCH")  Q:+$G(RESULTS(1))<0
"RTN","PSBML2",56,0)
 .Q:$$GET1^DIQ(53.79,PSBIEN,.09,"I")=""
"RTN","PSBML2",57,0)
 .S PSBXDFN=$$GET1^DIQ(53.79,PSBIEN,.01,"I")
"RTN","PSBML2",58,0)
 .S PSBXORN=$$GET1^DIQ(53.79,+PSBIEN,.11,"I")
"RTN","PSBML2",59,0)
 .S PSBXDT="" F  S PSBXDT=$O(^PSB(53.79,"AORDX",PSBXDFN,PSBXORN,PSBXDT)) Q:PSBXDT=""  D  Q:+$G(RESULTS(1))<0
"RTN","PSBML2",60,0)
 ..S PSBYZ="" F  S PSBYZ=$O(^PSB(53.79,"AORDX",PSBXDFN,PSBXORN,PSBXDT,PSBYZ)) Q:'PSBYZ  I ($$GET1^DIQ(53.79,PSBYZ,.09,"I")="G"),(PSBYZ'=+PSBIEN) S RESULTS(0)=1,RESULTS(1)="-1^Previous Patch has not been removed. Administration canceled." Q
"RTN","PSBML2",61,0)
 S:'$D(PSBXDFN) PSBXDFN=$$GET1^DIQ(53.79,PSBIEN,.01,"I"),PSBXORN=$$GET1^DIQ(53.79,+PSBIEN,.11,"I")
"RTN","PSBML2",62,0)
 I $G(PSBREC(3))']"",$G(PSBREC(0))="G",$P($G(PSBREC(4)),U)'="DD",$P($G(PSBREC(8)),U)'="DD" S PSBUID=$$GETWSID^PSBVDLU2(+PSBXDFN,+PSBXORN) D VAL^PSBML(53.79,PSBIEN,.26,PSBUID)
"RTN","PSBML2",63,0)
 D:$G(PSBREC(0))="N"
"RTN","PSBML2",64,0)
 .I (PSBREC(0)="N"),($$GET1^DIQ(53.79,+PSBIEN,.09,"I")="G") S PSBREC(1)="Undo Given: "_$G(PSBREC(1))
"RTN","PSBML2",65,0)
 .I ((PSBREC(0)="N")!(PSBREC(0)="G")),($$GET1^DIQ(53.79,+PSBIEN,.09,"I")="RM") S PSBREC(1)="Undo Remove: "_$G(PSBREC(1))
"RTN","PSBML2",66,0)
 .; Undo PRN
"RTN","PSBML2",67,0)
 .I $D(^PSB(53.79,+PSBIEN,.2)) D
"RTN","PSBML2",68,0)
 ..I $P(^PSB(53.79,+PSBIEN,0),U,9)="G"!($P(^PSB(53.79,+PSBIEN,0),U,9)="I") D VAL^PSBML(53.79,PSBIEN,.21,"@") D  ;Use BCMA Edit function to delete PRN Reason Field
"RTN","PSBML2",69,0)
 ...N DIK,DA
"RTN","PSBML2",70,0)
 ...I $$GET1^DIQ(53.79,PSBIEN_",",.22)]"" D VAL^PSBML(53.79,PSBIEN,.22,"@"),VAL^PSBML(53.79,PSBIEN,.23,"@"),VAL^PSBML(53.79,PSBIEN,.24,"@"),VAL^PSBML(53.79,PSBIEN,.25,"@") ;Use BCMA Edit function to delete PRN Effectiveness fields
"RTN","PSBML2",71,0)
 ...S DIK(1)=".12",DA=+PSBIEN,DIK="^PSB(53.79,"_DA_"," D EN2^DIK ;Use FM to properly delete order status and clean up "APRN" cross reference,PSB*3*72
"RTN","PSBML2",72,0)
 ..D:$$GET1^DIQ(53.79,PSBIEN_",",.27)=1 VAL^PSBML(53.79,PSBIEN,.27,"@") ;Use BCMA Edit function to delete PRN Reason Flag field, PSB*3*72
"RTN","PSBML2",73,0)
 D:$G(PSBREC(1))]""
"RTN","PSBML2",74,0)
 .S:PSBREC(0)="H" PSBREC(1)="Held: "_PSBREC(1)
"RTN","PSBML2",75,0)
 .S:PSBREC(0)="R" PSBREC(1)="Refused: "_PSBREC(1)
"RTN","PSBML2",76,0)
 .S:PSBREC(0)="RM" PSBREC(1)="Removed: "_PSBREC(1)
"RTN","PSBML2",77,0)
 .I $D(PSBFDA(53.793,"+2,"_PSBIEN,.01)) S PSBREC(1)=PSBREC(1)_(PSBFDA(53.793,"+2,"_PSBIEN,.01))
"RTN","PSBML2",78,0)
 .D VAL^PSBML(53.793,"+2,"_PSBIEN,.01,PSBREC(1)),VAL^PSBML(53.793,"+2,"_PSBIEN,.02,"`"_DUZ),VAL^PSBML(53.793,"+2,"_PSBIEN,.03,PSBNOW)
"RTN","PSBML2",79,0)
 S PSBXDFN=$$GET1^DIQ(53.79,PSBIEN,.01,"I")
"RTN","PSBML2",80,0)
 I ($$GET1^DIQ(53.79,+PSBIEN,.09,"I")="RM"),((PSBREC(0)="N")!(PSBREC(0)="G")) D
"RTN","PSBML2",81,0)
 .I '(($D(^XUSEC("PSB MANAGER",DUZ)))!($$GET1^DIQ(53.79,+PSBIEN,.07,"I")=DUZ)) S RESULTS(0)=1,RESULTS(1)="-1^Verify PSB MANAGER allocation" Q
"RTN","PSBML2",82,0)
 .S PSBXPTCH=1,PSBYY="",PSBGIVEN=0 F  S PSBYY=$O(^PSB(53.79,+PSBIEN,.9,PSBYY),-1) Q:'PSBYY  Q:(+$G(RESULTS(0))<0)  Q:PSBGIVEN  S PSBXDAT=$G(^(PSBYY,0))  D
"RTN","PSBML2",83,0)
 ..;PSB*3*45 Should be checking if action status changed to GIVEN
"RTN","PSBML2",84,0)
 ..I $P(PSBXDAT,"^",4)["GIVEN" D
"RTN","PSBML2",85,0)
 ...S PSBXDATE=$P(^PSB(53.79,+PSBIEN,.9,PSBYY,0),U)
"RTN","PSBML2",86,0)
 ...S PSBXORN=$$GET1^DIQ(53.79,+PSBIEN,.11,"I")
"RTN","PSBML2",87,0)
 ...S PSBYX=(PSBYY-2) I (PSBYX)>0 I ^PSB(53.79,+PSBIEN,.9,PSBYX,0)["ACTION DATE/TIME '" S PSBXDATE=$P(^PSB(53.79,+PSBIEN,.9,PSBYX,0),"'",2),X=$P(PSBXDATE,"@"),%DT="" D ^%DT S PSBXDATE=Y_"."_$TR($P(PSBXDATE,"@",2),":")
"RTN","PSBML2",88,0)
 ...S PSBXDT="" F  S PSBXDT=$O(^PSB(53.79,"AORDX",PSBXDFN,PSBXORN,PSBXDT)) Q:PSBXDT=""  D  Q:+$G(RESULTS(1))<0
"RTN","PSBML2",89,0)
 ....S PSBYZ="" F  S PSBYZ=$O(^PSB(53.79,"AORDX",PSBXDFN,PSBXORN,PSBXDT,PSBYZ)) Q:'PSBYZ  I ($$GET1^DIQ(53.79,PSBYZ,.09,"I")="G"),(PSBYZ'=+PSBIEN) S RESULTS(0)=1,RESULTS(1)="-1^Cannot UNDO! Order has GIVEN patch" Q
"RTN","PSBML2",90,0)
 ...I '(+$G(RESULTS(1))<0) D  S PSBGIVEN=1
"RTN","PSBML2",91,0)
 ....;PSB*3*45 Added PSBLSTG for the last user who gave the patch. this will be logged in order to undo multiple removed.
"RTN","PSBML2",92,0)
 ....S PSBLSTG=$P(PSBXDAT,"^",2),I="" F  S I=$O(^PSB(53.79,+PSBIEN,.9,I),-1) Q:'I  I $P(^PSB(53.79,+PSBIEN,.9,I,0),"^",4)["GIVEN" D  Q
"RTN","PSBML2",93,0)
 .....S PSBLSTG=$S($P($G(PSBXDAT),"^",5):$P(PSBXDAT,"^",5),1:$P(PSBXDAT,"^",2))
"RTN","PSBML2",94,0)
 ....D VAL^PSBML(53.79,PSBIEN,.06,PSBXDATE),VAL^PSBML(53.79,PSBIEN,.07,"`"_PSBLSTG),VAL^PSBML(53.79,PSBIEN,.09,"G") K PSBLSTG
"RTN","PSBML2",95,0)
 ..D:('(+$G(RESULTS(1))<0))&('PSBGIVEN)&($G(PSBXPTCH))&(PSBYY'>1)
"RTN","PSBML2",96,0)
 ...S PSBXDATE=$P(^PSB(53.79,+PSBIEN,.9,PSBYY,0),"'",2),X=$P(PSBXDATE,"@"),%DT="" D ^%DT S PSBXDATE=Y_"."_$TR($P(PSBXDATE,"@",2),":")
"RTN","PSBML2",97,0)
 ...D VAL^PSBML(53.79,PSBIEN,.06,PSBXDATE),VAL^PSBML(53.79,PSBIEN,.07,"`"_$$GET1^DIQ(53.79,+PSBIEN,.07,"I")),VAL^PSBML(53.79,PSBIEN,.09,"G") S PSBGIVEN=1
"RTN","PSBML2",98,0)
 Q:(+$G(RESULTS(1))<0)
"RTN","PSBML2",99,0)
 I PSBEDTFL,$G(PSBGIVEN),PSBXPTCH S PSBREC(0)="G",PSBUNTSG=$P(PSBREC(8),U,4) D VAL^PSBML(53.795,(1_","_PSBIEN),.03,$S(PSBUNTSG'=0:PSBUNTSG,1:1)) K PSBXPTCH
"RTN","PSBML2",100,0)
 I $G(PSBREC(2))]"" D VAL^PSBML(53.79,PSBIEN,.16,PSBREC(2))
"RTN","PSBML2",101,0)
 S PSBOLDUZ=$P(^PSB(53.79,+PSBIEN,0),U,7),PSBOLSTS=$P(^PSB(53.79,+PSBIEN,0),U,9)
"RTN","PSBML2",102,0)
 I $G(PSBREC(PSBRECNO))]"" D  ; DD/SOL/ADD
"RTN","PSBML2",103,0)
 .I PSBREC(0)="G"!(PSBREC(0)="I")!(PSBREC(0)="H")!(PSBREC(0)="R")!(PSBREC(0)="M") D  ; Only if gvn or infus
"RTN","PSBML2",104,0)
 ..Q:(PSBEDTFL)&('$G(PSBCHNG))
"RTN","PSBML2",105,0)
 ..F PSBCNT=PSBRECNO:1 Q:'$D(PSBREC(PSBCNT))  D
"RTN","PSBML2",106,0)
 ...S Y=$P(PSBREC(PSBCNT),U)
"RTN","PSBML2",107,0)
 ...S PSBDD=$S(Y="DD":53.795,Y="ADD":53.796,Y="SOL":53.797,1:0)
"RTN","PSBML2",108,0)
 ...Q:'PSBDD
"RTN","PSBML2",109,0)
 ...I $G(PSBCHNG) D
"RTN","PSBML2",110,0)
 ....I $D(PSBFIND(PSBCNT)) S PSBIENS=$QS($Q(PSBFIND(PSBCNT)),2)_","_PSBIEN
"RTN","PSBML2",111,0)
 ....I '$D(PSBFIND(PSBCNT)) S PSBIENS="+1,"_PSBIEN
"RTN","PSBML2",112,0)
 ....D VAL^PSBML(PSBDD,PSBIENS,.01,"`"_$P(PSBREC(PSBCNT),U,2))
"RTN","PSBML2",113,0)
 ....D:PSBDD=53.795 VAL^PSBML(PSBDD,PSBIENS,.02,$P(PSBREC(PSBCNT),U,3))
"RTN","PSBML2",114,0)
 ....I (PSBDD=53.796!(PSBDD=53.797))&($P(PSBREC(PSBCNT),U,4)) D VAL^PSBML(PSBDD,PSBIENS,.02,$P(PSBREC(PSBCNT),U,4)) ;Store units in Units ordered field, PSB*3*72
"RTN","PSBML2",115,0)
 ....D:PSBREC(0)="G"!(PSBREC(0)="I") VAL^PSBML(PSBDD,PSBIENS,.03,$P(PSBREC(PSBCNT),U,4)) ;only store units given when infusing or given, PSB*3*72
"RTN","PSBML2",116,0)
 ....D:Y="DD" VAL^PSBML(PSBDD,PSBIENS,.04,$P(PSBREC(PSBCNT),U,5))
"RTN","PSBML2",117,0)
 ....D VAL^PSBML(PSBDD,PSBIENS,.05,$P(PSBREC(PSBCNT),U,7))     ;HR *70
"RTN","PSBML2",118,0)
 .I ('PSBEDTFL)!((PSBREC(0)'="G")&($$GET1^DIQ(53.79,PSBIEN,.09,"I")="G")) D
"RTN","PSBML2",119,0)
 ..S (PSBDCNT,PSBACNT,PSBSCNT)=0,PSBADD=3 F PSBCNT=PSBRECNO:1 Q:'$D(PSBREC(PSBCNT))  D
"RTN","PSBML2",120,0)
 ...S Y=$P(PSBREC(PSBCNT),U)
"RTN","PSBML2",121,0)
 ...S PSBDD=$S(Y="DD":53.795,Y="ADD":53.796,Y="SOL":53.797,1:0)
"RTN","PSBML2",122,0)
 ...Q:'PSBDD
"RTN","PSBML2",123,0)
 ...S @("PSB"_$E(Y)_"CNT")=@("PSB"_$E(Y)_"CNT")+1
"RTN","PSBML2",124,0)
 ...S PSBIENS=(@("PSB"_$E(Y)_"CNT"))_","_PSBIEN
"RTN","PSBML2",125,0)
 ...I '$$GET1^DIQ(PSBDD,PSBIENS,.01,"I") S PSBIENS="+"_PSBADD_","_PSBIEN,PSBADD=PSBADD+1
"RTN","PSBML2",126,0)
 ...D VAL^PSBML(PSBDD,PSBIENS,.01,"`"_$P(PSBREC(PSBCNT),U,2))
"RTN","PSBML2",127,0)
 ...D:PSBDD=53.795 VAL^PSBML(PSBDD,PSBIENS,.02,$P(PSBREC(PSBCNT),U,3))
"RTN","PSBML2",128,0)
 ...I (PSBDD=53.796!(PSBDD=53.797))&($P(PSBREC(PSBCNT),U,4)) D VAL^PSBML(PSBDD,PSBIENS,.02,$P(PSBREC(PSBCNT),U,4)) ;Store units in Units ordered field, PSB*3*72
"RTN","PSBML2",129,0)
 ...D:Y="DD" VAL^PSBML(PSBDD,PSBIENS,.03,$S(PSBREC(0)="G"!(PSBREC(0)="RM"):$P(PSBREC(PSBCNT),U,4),1:0)),VAL^PSBML(PSBDD,PSBIENS,.04,$P(PSBREC(PSBCNT),U,5))
"RTN","PSBML2",130,0)
 ...I PSBDD=53.796!(PSBDD=53.797),PSBREC(0)="G" D VAL^PSBML(PSBDD,PSBIENS,.03,$P(PSBREC(PSBCNT),U,4))
"RTN","PSBML2",131,0)
 I ($G(PSBREC(PSBRECNO))']""),(PSBREC(0)="N"),($$GET1^DIQ(53.79,PSBIEN,.09,"I")="G") D
"RTN","PSBML2",132,0)
 .S PSBX=0 F  S PSBX=$O(^PSB(53.79,+PSBIEN,.5,PSBX)) Q:'+PSBX  D VAL^PSBML(53.795,(PSBX_","_PSBIEN),.03,0)
"RTN","PSBML2",133,0)
 I PSBWITHR>1,PSBREC(0)="G" D     ;Witness logic and Give?  *70
"RTN","PSBML2",134,0)
 .D:PSBWITN VAL^PSBML(53.79,PSBIEN,.28,PSBNOW)        ;Witness dt/time
"RTN","PSBML2",135,0)
 .D:PSBWITN VAL^PSBML(53.79,PSBIEN,.29,"`"_PSBWITN)   ;Witness duz
"RTN","PSBML2",136,0)
 .D:PSBWITCM]"" VAL^PSBML(53.79,PSBIEN,.31,PSBWITCM)  ;Witness comment
"RTN","PSBML2",137,0)
 .D VAL^PSBML(53.79,PSBIEN,.32,PSBWITHR)          ;Witness HR ord code
"RTN","PSBML2",138,0)
 .D VAL^PSBML(53.79,PSBIEN,.33,PSBWITFL)          ;Witnessed? flag
"RTN","PSBML2",139,0)
 ;
"RTN","PSBML2",140,0)
 I PSBWITHR>1,PSBREC(0)="N" D      ;Undo Give of Witness fields    *70
"RTN","PSBML2",141,0)
 .N WTDT,WTNS,WTCM,WTHR,WTFL       ;only delete if currently has data
"RTN","PSBML2",142,0)
 .S WTDT=$$GET1^DIQ(53.79,+PSBIEN,.28,"I")
"RTN","PSBML2",143,0)
 .S WTNS=$$GET1^DIQ(53.79,+PSBIEN,.29,"I")
"RTN","PSBML2",144,0)
 .S WTCM=$$GET1^DIQ(53.79,+PSBIEN,.31,"I")
"RTN","PSBML2",145,0)
 .S WTHR=$$GET1^DIQ(53.79,+PSBIEN,.32,"I")
"RTN","PSBML2",146,0)
 .S WTFL=$$GET1^DIQ(53.79,+PSBIEN,.33,"I")
"RTN","PSBML2",147,0)
 .D:WTDT VAL^PSBML(53.79,PSBIEN,.28,"@")
"RTN","PSBML2",148,0)
 .D:WTNS VAL^PSBML(53.79,PSBIEN,.29,"@")
"RTN","PSBML2",149,0)
 .D:WTCM]"" VAL^PSBML(53.79,PSBIEN,.31,"@")
"RTN","PSBML2",150,0)
 .D:WTHR>1 VAL^PSBML(53.79,PSBIEN,.32,"@")
"RTN","PSBML2",151,0)
 .D:WTFL]"" VAL^PSBML(53.79,PSBIEN,.33,"@")
"RTN","PSBML2",152,0)
 D FILEIT^PSBML
"RTN","PSBML2",153,0)
 I $P($G(RESULTS(1)),U,1)=1 D
"RTN","PSBML2",154,0)
 .S PSBUID=$P(^PSB(53.79,+PSBIEN,0),U,10) I PSBUID]"",PSBUID'["WS" D
"RTN","PSBML2",155,0)
 ..S PSBTS=PSBREC(0)
"RTN","PSBML2",156,0)
 ..S PSBON=$P(^PSB(53.79,+PSBIEN,.1),U,1)
"RTN","PSBML2",157,0)
 ..S PSBDFN=$P(^PSB(53.79,+PSBIEN,0),U,1)
"RTN","PSBML2",158,0)
 ..I PSBREC(0)="N" S PSBTS="" D
"RTN","PSBML2",159,0)
 ...M PSBAR=^PSB(53.79,+PSBIEN,.9)
"RTN","PSBML2",160,0)
 ...S (PSBDN,X)="" F  S X=$O(PSBAR(X),-1) Q:X=0!(PSBDN=1)  D
"RTN","PSBML2",161,0)
 ....I PSBAR(X,0)["ACTION STATUS",PSBAR(X,0)["deleted",PSBAR(X,0)'["GIVEN" D
"RTN","PSBML2",162,0)
 .....S PSBTS=$P($P(PSBAR(X,0),"'",2),"'",1)
"RTN","PSBML2",163,0)
 .....S PSBTS=$S(PSBTS="HELD":"H",PSBTS="REFUSED":"R",PSBTS="REMOVED":"RM",PSBTS="MISSING":"M",1:""),PSBDN=1
"RTN","PSBML2",164,0)
 ...D VAL^PSBML(53.79,PSBIEN,.26,"") D CLEAN^DILF,UPDATE^DIE("","PSBFDA","PSBIEN","PSBMSG")
"RTN","PSBML2",165,0)
 ..D EN^PSJBCMA3(PSBDFN,+PSBON,PSBUID,PSBTS,PSBNOW)
"RTN","PSBML2",166,0)
 I ($$GET1^DIQ(53.79,+PSBIEN,.12,"I")="O")&($$GET1^DIQ(53.79,+PSBIEN,.09,"I")="N") S PSBDFN=$$GET1^DIQ(53.79,+PSBIEN,.01,"I") D ENR^PSJBCMA4(PSBDFN,$$GET1^DIQ(53.79,+PSBIEN,.11))
"RTN","PSBML2",167,0)
 I ($$GET1^DIQ(53.79,+PSBIEN,.12,"I")="O")&($$GET1^DIQ(53.79,+PSBIEN,.09,"I")="G") S PSBDFN=$$GET1^DIQ(53.79,+PSBIEN,.01,"I") D ENE^PSJBCMA4(PSBDFN,$$GET1^DIQ(53.79,+PSBIEN,.11))
"RTN","PSBML2",168,0)
 I (PSBREC(0)="N")&($$GET1^DIQ(53.79,+PSBIEN,.09,"I")="N") D NGRESET^PSBML3(.PSBREC,PSBIEN)
"RTN","PSBML2",169,0)
 Q
"RTN","PSBMLLKU")
0^9^B106582479^B105244000
"RTN","PSBMLLKU",1,0)
PSBMLLKU ;BIRMINGHAM/TEJ - BCMA RPC LOOKUP UTLILITIES ;9/18/12 1:24am
"RTN","PSBMLLKU",2,0)
 ;;3.0;BAR CODE MED ADMIN;**3,9,11,20,13,38,32,56,42,70,72**;Mar 2004;Build 16
"RTN","PSBMLLKU",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBMLLKU",4,0)
 ;
"RTN","PSBMLLKU",5,0)
 ; Reference/IA
"RTN","PSBMLLKU",6,0)
 ; EN^PSJBCMA1/2829
"RTN","PSBMLLKU",7,0)
 ; $$DOB^DPTLK1/3266
"RTN","PSBMLLKU",8,0)
 ; $$SSN^DPTLK1/3267
"RTN","PSBMLLKU",9,0)
 ; ^DPT/10035
"RTN","PSBMLLKU",10,0)
 ; ^XUSEC/10076
"RTN","PSBMLLKU",11,0)
 ; File 52.6/436
"RTN","PSBMLLKU",12,0)
 ; File 52.7/437
"RTN","PSBMLLKU",13,0)
 ; File 50/221
"RTN","PSBMLLKU",14,0)
 ; File 211.4/1409
"RTN","PSBMLLKU",15,0)
 ; $$UP^XLFSTR/10104
"RTN","PSBMLLKU",16,0)
 ;
"RTN","PSBMLLKU",17,0)
 ;*70 - create a lookup for Clinics that returns all patients per 
"RTN","PSBMLLKU",18,0)
 ;      clinic selected for Client to then pass one at a time for
"RTN","PSBMLLKU",19,0)
 ;      coversheet reports and enable the NEXT button for user
"RTN","PSBMLLKU",20,0)
 ;      selection to process the next DFN for a coversheet report.
"RTN","PSBMLLKU",21,0)
 ;
"RTN","PSBMLLKU",22,0)
RPC(RESULTS,PSBREC) ; Remote Procedure Call Entry Point.
"RTN","PSBMLLKU",23,0)
 ;
"RTN","PSBMLLKU",24,0)
 ;*70 piece out mode if exists & reset 0 node for bkwds compatability
"RTN","PSBMLLKU",25,0)
 N PSBCLINORD
"RTN","PSBMLLKU",26,0)
 S PSBCLINORD=$P(PSBREC(0),U,2),PSBREC(0)=$P(PSBREC(0),U)
"RTN","PSBMLLKU",27,0)
 ;
"RTN","PSBMLLKU",28,0)
 S RESULTS="" D @(PSBREC(0)_"(.RESULTS,.PSBREC)") Q
"RTN","PSBMLLKU",29,0)
 Q
"RTN","PSBMLLKU",30,0)
 ;
"RTN","PSBMLLKU",31,0)
ADMLKUP(RESULTS,PSBREC) ;
"RTN","PSBMLLKU",32,0)
 ;  Lookup ADMinistrations per DFN and search DATE
"RTN","PSBMLLKU",33,0)
 ;   input - PSBREC(1)  DFN
"RTN","PSBMLLKU",34,0)
 ;           PSBREC(2)  Search DATE
"RTN","PSBMLLKU",35,0)
 ;
"RTN","PSBMLLKU",36,0)
 ;   outpt - RESULTS (array)
"RTN","PSBMLLKU",37,0)
 ;          (Administrations returned will be dated  = to Search Date
"RTN","PSBMLLKU",38,0)
 ;
"RTN","PSBMLLKU",39,0)
 ;
"RTN","PSBMLLKU",40,0)
 K RESULTS
"RTN","PSBMLLKU",41,0)
 S DFN=PSBREC(1),PSBSRCH=$G(PSBREC(2)) I $G(PSBSRCH)']"" D NOW^%DTC S PSBSRCH=$P(%,".")
"RTN","PSBMLLKU",42,0)
 S PSBDT=PSBSRCH,PSBCNT=0 S:PSBSRCH'["." PSBSRCH=PSBSRCH+.9
"RTN","PSBMLLKU",43,0)
 S RESULTS(0)=1,RESULTS(1)="-1^No Meds Found!"
"RTN","PSBMLLKU",44,0)
 F  S PSBSRCH=$O(^PSB(53.79,"AADT",DFN,PSBSRCH),-1) Q:'PSBSRCH!(PSBSRCH<PSBDT)  D
"RTN","PSBMLLKU",45,0)
 .S PSBIEN=""
"RTN","PSBMLLKU",46,0)
 .F  S PSBIEN=$O(^PSB(53.79,"AADT",DFN,PSBSRCH,PSBIEN),-1) Q:'PSBIEN  D:'$D(^PSB(53.79,PSBIEN)) KILLAADT  Q:'$D(^PSB(53.79,PSBIEN))  D:$$CHKKEY(PSBIEN)
"RTN","PSBMLLKU",47,0)
 ..L +^PSB(53.79,PSBIEN):1
"RTN","PSBMLLKU",48,0)
 ..I  L -^PSB(53.79,PSBIEN)
"RTN","PSBMLLKU",49,0)
 ..E  Q
"RTN","PSBMLLKU",50,0)
 ..S PSBXORDN=$$GET1^DIQ(53.79,PSBIEN_",",.11) Q:'$D(^PSB(53.79,"AORDX",DFN,PSBXORDN,PSBSRCH))
"RTN","PSBMLLKU",51,0)
 ..Q:($$GET1^DIQ(53.79,PSBIEN_",",.06,"I")>PSBSRCH)
"RTN","PSBMLLKU",52,0)
 ..Q:($$GET1^DIQ(53.79,PSBIEN_",",.09,"I")="N")
"RTN","PSBMLLKU",53,0)
 ..S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=PSBIEN
"RTN","PSBMLLKU",54,0)
 ..S $P(RESULTS(PSBCNT),U,2)=PSBSRCH
"RTN","PSBMLLKU",55,0)
 ..S $P(RESULTS(PSBCNT),U,3)=$$GET1^DIQ(53.79,PSBIEN_",",.08)
"RTN","PSBMLLKU",56,0)
 ..S:$$GET1^DIQ(53.79,PSBIEN_",",.26) $P(RESULTS(PSBCNT),U,4)=$$GET1^DIQ(53.79,PSBIEN_",",.26)
"RTN","PSBMLLKU",57,0)
 ..S $P(RESULTS(PSBCNT),U,5)=$S($$GET1^DIQ(53.79,PSBIEN_",",.09,"I")']"":"U",1:$$GET1^DIQ(53.79,PSBIEN_",",.09,"I"))
"RTN","PSBMLLKU",58,0)
 ..D  ; Get order information
"RTN","PSBMLLKU",59,0)
 ...K ^TMP("PSJ1",$J) D EN^PSJBCMA1(DFN,PSBXORDN,1)
"RTN","PSBMLLKU",60,0)
 ...S $P(RESULTS(PSBCNT),U,3)=$P(^TMP("PSJ1",$J,2),U,2)  ;OItem_" "_Dosage Form
"RTN","PSBMLLKU",61,0)
 ...S $P(RESULTS(PSBCNT),U,6)=$P(^TMP("PSJ1",$J,4),U)    ;Sched Type
"RTN","PSBMLLKU",62,0)
 ...K ^TMP("PSJ1",$J)
"RTN","PSBMLLKU",63,0)
 ..S $P(RESULTS(PSBCNT),U,7)=$$GET1^DIQ(53.79,PSBIEN_",",.06,"I")
"RTN","PSBMLLKU",64,0)
 ..S $P(RESULTS(PSBCNT),U,8)=$$GETINIT^PSBCSUTX(PSBIEN,"I") ;Get initials of who took action, PSB*3*72
"RTN","PSBMLLKU",65,0)
 ..S:$D(^PSB(53.79,PSBIEN,.2)) $P(RESULTS(PSBCNT),U,9)=$P(^PSB(53.79,PSBIEN,.2),U),$P(RESULTS(PSBCNT),U,10)=$P(^PSB(53.79,PSBIEN,.2),U,2)
"RTN","PSBMLLKU",66,0)
 S:+$G(RESULTS(1))>0 $P(RESULTS(0),U)=PSBCNT
"RTN","PSBMLLKU",67,0)
 Q
"RTN","PSBMLLKU",68,0)
 ;
"RTN","PSBMLLKU",69,0)
CHKKEY(PSBIENX) ;
"RTN","PSBMLLKU",70,0)
 I '(($D(^XUSEC("PSB MANAGER",DUZ)))!($$GET1^DIQ(53.79,+PSBIENX,.07,"I")=DUZ)) Q 0
"RTN","PSBMLLKU",71,0)
 Q 1
"RTN","PSBMLLKU",72,0)
 ;
"RTN","PSBMLLKU",73,0)
PTLKUP(RESULTS,PSBREC) ; Patient lookup handled separately for security
"RTN","PSBMLLKU",74,0)
 ;   input - PSBREC (array)  User entered patient lookup data
"RTN","PSBMLLKU",75,0)
 ;
"RTN","PSBMLLKU",76,0)
 ;   outpt - RESULTS (array)
"RTN","PSBMLLKU",77,0)
 ;          (Person(s) in PATIENT File (#2) meeting search criteria)
"RTN","PSBMLLKU",78,0)
 ;
"RTN","PSBMLLKU",79,0)
 ;
"RTN","PSBMLLKU",80,0)
 N PSBNRSWD,PSBINDX,PSBRPT
"RTN","PSBMLLKU",81,0)
 K RESULTS,PSBDATA
"RTN","PSBMLLKU",82,0)
 K PSBPT S PSBPT(0)=0
"RTN","PSBMLLKU",83,0)
 S PSBINDX="" K ^TMP("DILIST",$J)
"RTN","PSBMLLKU",84,0)
 I PSBCLINORD'="C" D
"RTN","PSBMLLKU",85,0)
 .S PSBDATA=$E(PSBREC(1),1,60)
"RTN","PSBMLLKU",86,0)
 .I PSBDATA?12N!(PSBDATA?1.6N)&(DUZ("AG")="I") D  Q  ; HRN/ASUFAC code
"RTN","PSBMLLKU",87,0)
 ..N X
"RTN","PSBMLLKU",88,0)
 ..S X=$$HRCNF^APSPFUNC($S($L(PSBDATA)=12:PSBDATA,1:$$PAD($$GET1^DIQ(9999999.06,+DUZ(2),.12))_$$PAD(PSBDATA)))
"RTN","PSBMLLKU",89,0)
 ..I X<0 D  Q
"RTN","PSBMLLKU",90,0)
 ...S RESULTS(0)=1,RESULTS(1)="-1^No patients matching '"_PSBDATA_"'."
"RTN","PSBMLLKU",91,0)
 ..S RESULTS(0)=1
"RTN","PSBMLLKU",92,0)
 ..S RESULTS(1)=$$PTREC(X)
"RTN","PSBMLLKU",93,0)
 .S PSBDATA1=PSBDATA
"RTN","PSBMLLKU",94,0)
 .I $E(PSBDATA,$L(PSBDATA)-10,60)=" [MAS WARD]" S PSBINDX="CN" S PSBDATA=$P(PSBDATA," [MAS WARD]")
"RTN","PSBMLLKU",95,0)
 .I $E(PSBDATA,$L(PSBDATA)-11,60)=" [NURS UNIT]" S PSBINDX="CN" S PSBDATA=$P(PSBDATA," [NURS UNIT]") D
"RTN","PSBMLLKU",96,0)
 ..K PSBPT S PSBPT(0)=0
"RTN","PSBMLLKU",97,0)
 ..S PSBZ=0 F  S PSBZ=$O(^NURSF(211.4,PSBZ)) Q:PSBZ'?.N  S PSBNRSWD=$$GET1^DIQ(211.4,PSBZ_",",.01) I $$UP^XLFSTR(PSBNRSWD)=PSBDATA S PSBY=PSBZ Q  ;Update API, PSB*3*72
"RTN","PSBMLLKU",98,0)
 ..K PSBDATA S PSBDATA=""
"RTN","PSBMLLKU",99,0)
 ..S PSBX=0 F  S PSBX=$O(^NURSF(211.4,PSBY,3,PSBX)) Q:PSBX=""  S PSBDATA(PSBX)=$$GET1^DIQ(42,$P(^NURSF(211.4,PSBY,3,PSBX,0),U)_",",.01)
"RTN","PSBMLLKU",100,0)
 ;
"RTN","PSBMLLKU",101,0)
 I PSBCLINORD="C" D
"RTN","PSBMLLKU",102,0)
 .;Clinic mode report - get and return array of all DFN's that belong
"RTN","PSBMLLKU",103,0)
 .;  to clinics passed in by user.
"RTN","PSBMLLKU",104,0)
 .F QQ=0:0 S QQ=$O(PSBREC(QQ)) Q:'QQ  D
"RTN","PSBMLLKU",105,0)
 ..S PSBRPT(2,QQ,0)=PSBREC(QQ)
"RTN","PSBMLLKU",106,0)
 ..S PSBRPT(2,"B",PSBREC(QQ),QQ)=""
"RTN","PSBMLLKU",107,0)
 .S PSBDATA=1 D CLIN^PSBO(.PSBRPT,.PSBDATA)
"RTN","PSBMLLKU",108,0)
 .I $D(PSBDATA)=11 D
"RTN","PSBMLLKU",109,0)
 ..N DFNXX S PSBCNT=0
"RTN","PSBMLLKU",110,0)
 ..F DFNXX=0:0 S DFNXX=$O(PSBDATA(DFNXX)) Q:'DFNXX  D
"RTN","PSBMLLKU",111,0)
 ...S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$PTREC(DFNXX)
"RTN","PSBMLLKU",112,0)
 .; check if any data found
"RTN","PSBMLLKU",113,0)
 .I '$D(RESULTS) D
"RTN","PSBMLLKU",114,0)
 ..S RESULTS(0)=1
"RTN","PSBMLLKU",115,0)
 ..S RESULTS(1)="-1^No patients matching Clinic Search List"
"RTN","PSBMLLKU",116,0)
 .E  D
"RTN","PSBMLLKU",117,0)
 ..S RESULTS(0)=+$O(RESULTS(""),-1)
"RTN","PSBMLLKU",118,0)
 ..S PSBINDX="CN"
"RTN","PSBMLLKU",119,0)
 I PSBCLINORD="C",+RESULTS(1)=-1 Q
"RTN","PSBMLLKU",120,0)
 ;
"RTN","PSBMLLKU",121,0)
 I PSBINDX="" S PSBINDX=$S(PSBDATA?9N.1P:"SSN",PSBDATA?4N.1P:"BS5^BS",1:PSBINDX)
"RTN","PSBMLLKU",122,0)
 I ($O(PSBDATA(""))'>0) D FIND^DIC(2,"","@;.01;.02;.03;.09","MP",PSBDATA,200,PSBINDX)
"RTN","PSBMLLKU",123,0)
 I ($O(PSBDATA(""))>0) D
"RTN","PSBMLLKU",124,0)
 .S PSBX="",PSBY=1 F  S PSBX=$O(PSBDATA(PSBX)) Q:PSBX=""  D  K ^TMP("DILIST",$J) Q:$P(PSBPT(0),U,3)=1
"RTN","PSBMLLKU",125,0)
 ..D FIND^DIC(2,"","@;.01;.02;.03;.09","MPO",PSBDATA(PSBX),200,PSBINDX)
"RTN","PSBMLLKU",126,0)
 ..S PSBZ=0 F  S PSBZ=$O(^TMP("DILIST",$J,PSBZ)) Q:PSBZ=""  S PSBPT(PSBY,0)=^TMP("DILIST",$J,PSBZ,0),PSBPT(0)=PSBY,PSBY=PSBY+1 I PSBY>200 S $P(PSBPT(0),U,3)=1
"RTN","PSBMLLKU",127,0)
 K:+$G(PSBPT(0))=0 PSBPT
"RTN","PSBMLLKU",128,0)
 I $D(PSBPT) M ^TMP("DILIST",$J)=PSBPT
"RTN","PSBMLLKU",129,0)
 I $P($G(^TMP("DILIST",$J,0)),U,3) D  Q
"RTN","PSBMLLKU",130,0)
 .S RESULTS(0)=1,RESULTS(1)="-1^Too many patients found matching '"_PSBDATA1_"'. Please be more specific."
"RTN","PSBMLLKU",131,0)
 I $D(^TMP("DILIST",$J,0)) D
"RTN","PSBMLLKU",132,0)
 .F PSBXX=0:0 S PSBXX=$O(^TMP("DILIST",$J,PSBXX)) Q:'PSBXX  D
"RTN","PSBMLLKU",133,0)
 ..S RESULTS(PSBXX)=$$PTREC(+^TMP("DILIST",$J,PSBXX,0))
"RTN","PSBMLLKU",134,0)
 I '$D(RESULTS) S RESULTS(0)=1,RESULTS(1)="-1^No patients matching '"_PSBDATA1_"'"
"RTN","PSBMLLKU",135,0)
 E  S RESULTS(0)=+$O(RESULTS(""),-1)
"RTN","PSBMLLKU",136,0)
 Q
"RTN","PSBMLLKU",137,0)
 ;
"RTN","PSBMLLKU",138,0)
PTREC(DFN) ;
"RTN","PSBMLLKU",139,0)
 ; Extrinsic to return a Pt Rec  in standard list format
"RTN","PSBMLLKU",140,0)
 N PSBXX
"RTN","PSBMLLKU",141,0)
 S PSBXX=$G(^DPT(DFN,0))
"RTN","PSBMLLKU",142,0)
 S PSBXX=DFN_U_$P(PSBXX,U,1)_U_$P(PSBXX,U,2)_U_$P(PSBXX,U,3)_U_$S(DUZ("AG")="I":$$HRCNF^BDGF2(DFN,DUZ(2)),1:$P(PSBXX,U,9))
"RTN","PSBMLLKU",143,0)
 S $P(PSBXX,U,6)=$$GET1^DIQ(2,DFN_",",.1)
"RTN","PSBMLLKU",144,0)
 S $P(PSBXX,U,7)=$$GET1^DIQ(2,DFN_",",.101)
"RTN","PSBMLLKU",145,0)
 S $P(PSBXX,U,10)=$$DOB^DPTLK1(DFN)
"RTN","PSBMLLKU",146,0)
 S $P(PSBXX,U,11)=$S(DUZ("AG")="I":$$HRN^AUPNPAT(DFN,DUZ(2)),1:$$SSN^DPTLK1(DFN))
"RTN","PSBMLLKU",147,0)
 Q PSBXX
"RTN","PSBMLLKU",148,0)
 ;
"RTN","PSBMLLKU",149,0)
SELECTAD(RESULTS,PSBREC) ; Select Administration
"RTN","PSBMLLKU",150,0)
 ;
"RTN","PSBMLLKU",151,0)
 ;  Process the SELECTed ADministration
"RTN","PSBMLLKU",152,0)
 ;   input - PSBREC(1) = PSB Med Log File (#53.79) IEN
"RTN","PSBMLLKU",153,0)
 ;
"RTN","PSBMLLKU",154,0)
 ;
"RTN","PSBMLLKU",155,0)
 ;   outpt - RESULTS (array)
"RTN","PSBMLLKU",156,0)
 ;          (Administration data that can be subsequently updated via GUI MED LOG EDIT)
"RTN","PSBMLLKU",157,0)
 ;
"RTN","PSBMLLKU",158,0)
 ;
"RTN","PSBMLLKU",159,0)
 K RESULTS,PSBXIV,PSBPTCHX
"RTN","PSBMLLKU",160,0)
 N PSBIEN,PSBCNT,PSBX S PSBIEN=PSBREC(1),PSBCNT=2
"RTN","PSBMLLKU",161,0)
 ; Construct form data    Patient^SSN^Med^BagID^AdminStat^AdminD/T^InjctSt^PRNReas^PRNEff^DisDrg^UntsGiven^Unt^
"RTN","PSBMLLKU",162,0)
 S RESULTS(0)=0
"RTN","PSBMLLKU",163,0)
 D:$$CHKKEY(PSBIEN)
"RTN","PSBMLLKU",164,0)
 .L +^PSB(53.79,PSBIEN):1
"RTN","PSBMLLKU",165,0)
 .E  I $P(^PSB(53.79,PSBIEN,0),U,9)]"" S PSBCNT=1,RESULTS(1)="-1^ This administration is being modified by another process at this moment." L -^PSB(53.79,PSBIEN) Q
"RTN","PSBMLLKU",166,0)
 .S $P(RESULTS(1),U)=PSBIEN
"RTN","PSBMLLKU",167,0)
 .S $P(RESULTS(1),U,2)=$$GET1^DIQ(53.79,PSBIEN_",",.01,"I")
"RTN","PSBMLLKU",168,0)
 .S $P(RESULTS(1),U,3)=$$GET1^DIQ(53.79,PSBIEN_",",.01)
"RTN","PSBMLLKU",169,0)
 .S $P(RESULTS(1),U,4)=$$GET1^DIQ(2,$P(RESULTS(1),U,2)_",",.09)
"RTN","PSBMLLKU",170,0)
 .S $P(RESULTS(1),U,5)=$$GET1^DIQ(53.79,PSBIEN_",",.08,"I")_"~"_$$GET1^DIQ(53.79,PSBIEN_",",.08)
"RTN","PSBMLLKU",171,0)
 .S $P(RESULTS(1),U,6)=$$GET1^DIQ(53.79,PSBIEN_",",.26)
"RTN","PSBMLLKU",172,0)
 .S $P(RESULTS(1),U,7)=$S($$GET1^DIQ(53.79,PSBIEN_",",.09,"I")']"":"U",1:$$GET1^DIQ(53.79,PSBIEN_",",.09,"I"))
"RTN","PSBMLLKU",173,0)
 .;
"RTN","PSBMLLKU",174,0)
 .D:($P(RESULTS(1),U,7)'="N")&($P(RESULTS(1),U,7)]"") SELSTTUS(.RESULTS)  ; Amend RESULTS(1) data...
"RTN","PSBMLLKU",175,0)
 .S Y=$E($$GET1^DIQ(53.79,PSBIEN_",",.06,"I"),1,12) D DD^%DT
"RTN","PSBMLLKU",176,0)
 .S $P(RESULTS(1),U,8)=Y
"RTN","PSBMLLKU",177,0)
 .S $P(RESULTS(1),U,9)=$$GET1^DIQ(53.79,PSBIEN_",",.06,"I")
"RTN","PSBMLLKU",178,0)
 .S $P(RESULTS(1),U,10)=$$GET1^DIQ(53.79,PSBIEN_",",.16)
"RTN","PSBMLLKU",179,0)
 .S $P(RESULTS(1),U,16)=0
"RTN","PSBMLLKU",180,0)
 .S $P(RESULTS(2),U)=$$GET1^DIQ(53.79,PSBIEN_",",.21),$P(RESULTS(2),U,2)=$$GET1^DIQ(53.79,PSBIEN_",",.22)
"RTN","PSBMLLKU",181,0)
 .; Determine if there are any active IVs/Patchs per order
"RTN","PSBMLLKU",182,0)
 .D:$G(PSBPTCHX)
"RTN","PSBMLLKU",183,0)
 ..S PSBX="",PSBX="^PSB(53.79,""APATCH"","_$P(RESULTS(1),U,2)_")"
"RTN","PSBMLLKU",184,0)
 ..F  S PSBX=$Q(@PSBX) Q:PSBX=""  Q:$QS(PSBX,3)'=$P(RESULTS(1),U,2)  D  Q:$P(RESULTS(1),U,16)
"RTN","PSBMLLKU",185,0)
 ...S PSBXX=$QS(PSBX,5),PSBXXX=$S(($P(^PSB(53.79,PSBXX,0),U,9)="G")&(PSBXX'=PSBIEN):1,1:0)
"RTN","PSBMLLKU",186,0)
 ...I PSBXXX&($P(^PSB(53.79,PSBXX,.1),U)=$P(RESULTS(1),U,15)) S $P(RESULTS(1),U,16)=1
"RTN","PSBMLLKU",187,0)
 .D:$G(PSBXIV)
"RTN","PSBMLLKU",188,0)
 ..S PSBX="",PSBX="^PSB(53.79,""AUID"","_$P(RESULTS(1),U,2)_")"
"RTN","PSBMLLKU",189,0)
 ..F  S PSBX=$Q(@PSBX) Q:PSBX=""  Q:$QS(PSBX,3)'=$P(RESULTS(1),U,2)  Q:$QS(PSBX,4)>$P(RESULTS(1),U,15)  D  Q:$P(RESULTS(1),U,16)
"RTN","PSBMLLKU",190,0)
 ...Q:$QS(PSBX,4)'=$P(RESULTS(1),U,15)
"RTN","PSBMLLKU",191,0)
 ...S PSBXX=$QS(PSBX,6) S:(PSBXX'=PSBIEN) $P(RESULTS(1),U,16)=$S($P(^PSB(53.79,PSBXX,0),U,9)="I":1,$P(^PSB(53.79,PSBXX,0),U,9)="S":1,1:0)
"RTN","PSBMLLKU",192,0)
 .;
"RTN","PSBMLLKU",193,0)
 .; LOOP - Place DD in RESULTS
"RTN","PSBMLLKU",194,0)
 .S PSBX=0 F  S PSBX=$O(^PSB(53.79,PSBIEN,.5,PSBX)) Q:'(+PSBX)  D
"RTN","PSBMLLKU",195,0)
 ..S PSBCNT=PSBCNT+1
"RTN","PSBMLLKU",196,0)
 ..S RESULTS(PSBCNT)="DD^"_$P(^PSB(53.79,PSBIEN,.5,PSBX,0),U)_"^"_$$GET1^DIQ(50,$P(^PSB(53.79,PSBIEN,.5,PSBX,0),U)_",",.01)
"RTN","PSBMLLKU",197,0)
 ..S $P(RESULTS(PSBCNT),U,4)=$P(^PSB(53.79,PSBIEN,.5,PSBX,0),U,2)_"^"_$P(^PSB(53.79,PSBIEN,.5,PSBX,0),U,3)_"^"_$P(^PSB(53.79,PSBIEN,.5,PSBX,0),U,4)
"RTN","PSBMLLKU",198,0)
 ..S:$P(RESULTS(PSBCNT),U,4)?1"."1.N $P(RESULTS(PSBCNT),U,4)=0_+$P(RESULTS(PSBCNT),U,4)
"RTN","PSBMLLKU",199,0)
 ..S:$P(RESULTS(PSBCNT),U,5)?1"."1.N $P(RESULTS(PSBCNT),U,5)=0_+$P(RESULTS(PSBCNT),U,5)
"RTN","PSBMLLKU",200,0)
 .; LOOP - Place ADD in RESULTS
"RTN","PSBMLLKU",201,0)
 .S PSBX=0 F  S PSBX=$O(^PSB(53.79,PSBIEN,.6,PSBX)) Q:'(+PSBX)  D
"RTN","PSBMLLKU",202,0)
 ..S PSBCNT=PSBCNT+1
"RTN","PSBMLLKU",203,0)
 ..S RESULTS(PSBCNT)="ADD^"_$P(^PSB(53.79,PSBIEN,.6,PSBX,0),U)_"^"_$$GET1^DIQ(52.6,$P(^PSB(53.79,PSBIEN,.6,PSBX,0),U)_",",.01)
"RTN","PSBMLLKU",204,0)
 ..S $P(RESULTS(PSBCNT),U,4)=$P(^PSB(53.79,PSBIEN,.6,PSBX,0),U,2)_"^"_$P(^PSB(53.79,PSBIEN,.6,PSBX,0),U,3)_"^"_$P(^PSB(53.79,PSBIEN,.6,PSBX,0),U,4)
"RTN","PSBMLLKU",205,0)
 .; LOOP - Place SOL in RESULTS
"RTN","PSBMLLKU",206,0)
 .S PSBX=0 F  S PSBX=$O(^PSB(53.79,PSBIEN,.7,PSBX)) Q:'(+PSBX)  D
"RTN","PSBMLLKU",207,0)
 ..S PSBCNT=PSBCNT+1
"RTN","PSBMLLKU",208,0)
 ..S RESULTS(PSBCNT)="SOL^"_$P(^PSB(53.79,PSBIEN,.7,PSBX,0),U)_"^"_$$GET1^DIQ(52.7,$P(^PSB(53.79,PSBIEN,.7,PSBX,0),U)_",",.01)
"RTN","PSBMLLKU",209,0)
 ..S $P(RESULTS(PSBCNT),U,4)=$P(^PSB(53.79,PSBIEN,.7,PSBX,0),U,2)_"^"_$P(^PSB(53.79,PSBIEN,.7,PSBX,0),U,3)_"^"_$P(^PSB(53.79,PSBIEN,.7,PSBX,0),U,4)
"RTN","PSBMLLKU",210,0)
 .L -^PSB(53.79,PSBIEN)
"RTN","PSBMLLKU",211,0)
 S:PSBCNT>0 RESULTS(0)=PSBCNT
"RTN","PSBMLLKU",212,0)
 Q
"RTN","PSBMLLKU",213,0)
 ;
"RTN","PSBMLLKU",214,0)
SELSTTUS(RESULTS) ;
"RTN","PSBMLLKU",215,0)
 ; Provide the SELectable STaTUS
"RTN","PSBMLLKU",216,0)
 ;
"RTN","PSBMLLKU",217,0)
 ; Get TAB, ScheduleType, Current Status, provide Selectable Staus(s) in ^8
"RTN","PSBMLLKU",218,0)
 N PSBORTYP,PSBIVTYP,PSBINTSY,PSBCHMTY,PSBIVPSH,PSBXTAB
"RTN","PSBMLLKU",219,0)
 K ^TMP("PSJ1",$J) D EN^PSJBCMA1($$GET1^DIQ(53.79,PSBIEN_",",.01,"I"),$$GET1^DIQ(53.79,PSBIEN_",",.11),1)
"RTN","PSBMLLKU",220,0)
 I ^TMP("PSJ1",$J,0)>0 D
"RTN","PSBMLLKU",221,0)
 .S PSBORTYP=$TR($P(^TMP("PSJ1",$J,0),U,3),"1234567890"),PSBIVTYP=$P(^TMP("PSJ1",$J,0),U,6)
"RTN","PSBMLLKU",222,0)
 .S PSBINTSY=$P(^TMP("PSJ1",$J,0),U,7),PSBCHMTY=$P(^TMP("PSJ1",$J,0),U,8),PSBIVPSH=+$P($G(^TMP("PSJ1",$J,1,0)),U,2)
"RTN","PSBMLLKU",223,0)
 .S:$$IVPTAB^PSBVDLU3(PSBORTYP,PSBIVTYP,PSBINTSY,PSBCHMTY,PSBIVPSH) PSBXTAB="PB"
"RTN","PSBMLLKU",224,0)
 .D:'$D(PSBXTAB)
"RTN","PSBMLLKU",225,0)
 ..I PSBORTYP="U" S PSBXTAB="UD"
"RTN","PSBMLLKU",226,0)
 ..I PSBORTYP="V" S PSBXTAB="IV"
"RTN","PSBMLLKU",227,0)
 ; Set Results(1) and other flags...
"RTN","PSBMLLKU",228,0)
 I ^TMP("PSJ1",$J,0)>0 D
"RTN","PSBMLLKU",229,0)
 .S $P(RESULTS(1),U,13)=$P(^TMP("PSJ1",$J,4),U)
"RTN","PSBMLLKU",230,0)
 .S $P(RESULTS(1),U,14)=$P(^TMP("PSJ1",$J,1),U,10)
"RTN","PSBMLLKU",231,0)
 .S $P(RESULTS(1),U,15)=$P(^TMP("PSJ1",$J,0),U,3)
"RTN","PSBMLLKU",232,0)
 .I (PSBXTAB="UD"),($P(^TMP("PSJ1",$J,2),U,6)="PATCH") S PSBPTCHX=1
"RTN","PSBMLLKU",233,0)
 .I PSBXTAB="IV" S PSBXIV=1
"RTN","PSBMLLKU",234,0)
 .S:$G(PSBXTAB)]"" $P(RESULTS(1),U,11)=$G(PSBXTAB)
"RTN","PSBMLLKU",235,0)
 K ^TMP("PSJ1",$J)
"RTN","PSBMLLKU",236,0)
 Q
"RTN","PSBMLLKU",237,0)
 ;
"RTN","PSBMLLKU",238,0)
KILLAADT ;
"RTN","PSBMLLKU",239,0)
 ;   Here because there is an errorant index entry via version 1.0/2.0
"RTN","PSBMLLKU",240,0)
 ;   Cleansing!
"RTN","PSBMLLKU",241,0)
 ;
"RTN","PSBMLLKU",242,0)
 K ^PSB(53.79,"AADT",DFN,PSBSRCH,PSBIEN)
"RTN","PSBMLLKU",243,0)
 Q
"RTN","PSBMLLKU",244,0)
 ;
"RTN","PSBMLLKU",245,0)
PAD(VAL) ; Return VAL with leading zeroes padded to 6 characters
"RTN","PSBMLLKU",246,0)
 Q $E("000000",1,6-$L(VAL))_VAL
"RTN","PSBOMH1")
0^2^B84411239^B83153329
"RTN","PSBOMH1",1,0)
PSBOMH1 ;BIRMINGHAM/EFC-MAH ; 2/16/12 1:00pm
"RTN","PSBOMH1",2,0)
 ;;3.0;BAR CODE MED ADMIN;**6,3,9,11,26,38,45,51,50,57,67,64,72**;Mar 2004;Build 16
"RTN","PSBOMH1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBOMH1",4,0)
 ;
"RTN","PSBOMH1",5,0)
 ; Reference/IA
"RTN","PSBOMH1",6,0)
 ; ^DILF/2054
"RTN","PSBOMH1",7,0)
 ; File 200/10060
"RTN","PSBOMH1",8,0)
 ;
"RTN","PSBOMH1",9,0)
EN ;
"RTN","PSBOMH1",10,0)
 ; Load administrations
"RTN","PSBOMH1",11,0)
 N PSBDT,X,Y
"RTN","PSBOMH1",12,0)
 S (PSBORD,PSBIEN,PSBR1,PSBADIEN,PSBABR)="",PSBDT=PSBSTRT
"RTN","PSBOMH1",13,0)
 K PSBTSA
"RTN","PSBOMH1",14,0)
 F  S PSBDT=$O(^PSB(53.79,"AADT",DFN,PSBDT)) Q:'PSBDT!(PSBDT>PSBSTOP)  D
"RTN","PSBOMH1",15,0)
 .F  S PSBIEN=$O(^PSB(53.79,"AADT",DFN,PSBDT,PSBIEN)) Q:'PSBIEN  Q:'$D(^PSB(53.79,PSBIEN))  I $P(^PSB(53.79,PSBIEN,0),U,9)]"" D  ;Remove Lock as file is only read, PSB*3*64
"RTN","PSBOMH1",16,0)
 ..Q:'$P($G(^PSB(53.79,PSBIEN,0)),U,6)  ; Bad IEN -no evnt dt
"RTN","PSBOMH1",17,0)
 ..Q:$P(^PSB(53.79,PSBIEN,0),U,9)="N"  ;NGiven
"RTN","PSBOMH1",18,0)
 ..S PSBORD=$P($G(^PSB(53.79,PSBIEN,.1)),U,1)
"RTN","PSBOMH1",19,0)
 ..;PSB*3*45 Anyone on the audit log should be in the legend
"RTN","PSBOMH1",20,0)
 ..N TMPCT S TMPCT=0 F  S TMPCT=$O(^PSB(53.79,PSBIEN,.9,TMPCT)) Q:'TMPCT  D
"RTN","PSBOMH1",21,0)
 ...S PSBINIT=$$GET1^DIQ(53.799,TMPCT_","_PSBIEN,"USER:INITIAL"),PSBNAME=$$GET1^DIQ(53.799,TMPCT_","_PSBIEN_",","USER")
"RTN","PSBOMH1",22,0)
 ...S:PSBINIT="" PSBINIT=99
"RTN","PSBOMH1",23,0)
 ...S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",24,0)
 ..; Continuous
"RTN","PSBOMH1",25,0)
 ..D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)="C"
"RTN","PSBOMH1",26,0)
 ...S X=PSBDT D H^%DTC S PSBWEEK=PSBAR(%H) D CLEAN^PSBVT,PSJ1^PSBVT($P(^PSB(53.79,PSBIEN,0),U,1),$P(^PSB(53.79,PSBIEN,.1),U,1))
"RTN","PSBOMH1",27,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,6)'=PSBDT,'$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,PSBIVPSH) D  D CLEAN^PSBVT Q  ;chck IV audit
"RTN","PSBOMH1",28,0)
 ....S PSBSIEN=PSBIEN
"RTN","PSBOMH1",29,0)
 ....I $P(^PSB(53.79,PSBIEN,0),"^",10)]"" D BAGDTL^PSBRPC2(.PSBAUD,$P(^PSB(53.79,PSBIEN,0),U,10),$P(^PSB(53.79,PSBIEN,.1),U,1))
"RTN","PSBOMH1",30,0)
 ....S PSBIEN=PSBSIEN K PSBSIEN
"RTN","PSBOMH1",31,0)
 ....S X=0 F  S X=$O(PSBAUD(X)) Q:X=""  I $P(PSBAUD(X),U,3)="" K PSBAUD(X)
"RTN","PSBOMH1",32,0)
 ....S X=0 F  S X=$O(PSBAUD(X)) Q:X=""  Q:$P(PSBAUD(X),U,1)=PSBDT
"RTN","PSBOMH1",33,0)
 ....I X="" K PSBAUD Q
"RTN","PSBOMH1",34,0)
 ....I '$D(PSBAUD(X)) K PSBAUD Q
"RTN","PSBOMH1",35,0)
 ....S PSBS=$P(PSBAUD(X),U,3)
"RTN","PSBOMH1",36,0)
 ....I PSBS="GIVEN",$P($G(PSBAUD(X-1)),U,3)="NOT GIVEN" Q
"RTN","PSBOMH1",37,0)
 ....I PSBS="NOT GIVEN" Q
"RTN","PSBOMH1",38,0)
 ....S PSBS=$S(PSBS="INFUSING":"I",PSBS="GIVEN":"G",PSBS="COMPLETED":"C",PSBS="HELD":"H",PSBS="REFUSED":"R",PSBS="REMOVED":"RM",PSBS="STOPPED":"S",PSBS["MISSING":"M",1:"NOACTION")
"RTN","PSBOMH1",39,0)
 ....D PSBSTIV^PSBOMH2
"RTN","PSBOMH1",40,0)
 ....S X=PSBDT_U_$P(PSBAUD(X),U,2)_U_PSBS_U_PSBIEN
"RTN","PSBOMH1",41,0)
 ....S Y=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,""),-1)+1
"RTN","PSBOMH1",42,0)
 ....S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,Y)=X ;PSB*3*67
"RTN","PSBOMH1",43,0)
 ....S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,0)=Y
"RTN","PSBOMH1",44,0)
 ....D PSBOUT($P((X),"^",1),$P((X),"^",2))
"RTN","PSBOMH1",45,0)
 ....K PSBAUD
"RTN","PSBOMH1",46,0)
 ...S PSBINIT=$$GETINIT^PSBCSUTX(PSBIEN,"I") ;Get initials of who took action, PSB*3*72
"RTN","PSBOMH1",47,0)
 ...S PSBNAME=$$GETINIT^PSBCSUTX(PSBIEN,"N") ;Get name of who took action, PSB*3*72
"RTN","PSBOMH1",48,0)
 ...I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",49,0)
 ...;get instrc info - audt log
"RTN","PSBOMH1",50,0)
 ...I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",51,0)
 ....D INSTR^PSBOMH
"RTN","PSBOMH1",52,0)
 ....S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",53,0)
 ...I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",54,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,9)="G",PSBDT=$P(^PSB(53.79,PSBIEN,0),U,6)  D PSBCK1^PSBOMH2("A")
"RTN","PSBOMH1",55,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,9)'="G",PSBDT=$P(^PSB(53.79,PSBIEN,0),U,6)  D PSBCK1^PSBOMH2("B")
"RTN","PSBOMH1",56,0)
 ...I PSBDT'=$P(^PSB(53.79,PSBIEN,0),U,6),$P(^PSB(53.79,PSBIEN,0),U,9)="RM" D
"RTN","PSBOMH1",57,0)
 ....D DDAUD
"RTN","PSBOMH1",58,0)
 ....S I="" F  S I=$O(PSBTAR(I),-1) Q:I=""  I $P(PSBTAR(I),U,1)=PSBDT D
"RTN","PSBOMH1",59,0)
 .....S PSBS=$P(PSBTAR(I),U,3)
"RTN","PSBOMH1",60,0)
 .....I PSBS="GIVEN",$P($G(PSBTAR(I-1)),U,3)="NOT GIVEN" Q  ; canceled - not given
"RTN","PSBOMH1",61,0)
 .....I PSBS="NOT GIVEN" Q
"RTN","PSBOMH1",62,0)
 .....S PSBS=$S(PSBS="INFUSING":"I",PSBS="GIVEN":"G",PSBS="COMPLETED":"C",PSBS="HELD":"H",PSBS="REFUSED":"R",PSBS="REMOVED":"RM",PSBS="STOPPED":"S",PSBS["MISSING":"M",1:"NO ACTION")
"RTN","PSBOMH1",63,0)
 .....D PSBCTAR^PSBOMH2
"RTN","PSBOMH1",64,0)
 .....S X=$P(PSBTAR(I),U,1,2)_U_PSBS_U_PSBIEN
"RTN","PSBOMH1",65,0)
 ...Q:'+X  ;Quit if invalid data is returned, PSB*3*67
"RTN","PSBOMH1",66,0)
 ...S Y=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,""),-1)+1
"RTN","PSBOMH1",67,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,Y)=X ;PSB*3*67
"RTN","PSBOMH1",68,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,0)=Y
"RTN","PSBOMH1",69,0)
 ...D PSBOUT($P((X),"^",1),$P((X),"^",2))
"RTN","PSBOMH1",70,0)
 ...Q
"RTN","PSBOMH1",71,0)
 ..; 1-Time On Call or PRN
"RTN","PSBOMH1",72,0)
 ..D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)'="C"
"RTN","PSBOMH1",73,0)
 ...I PSBDT'=$$GET1^DIQ(53.79,PSBIEN_",",.06,"I") Q
"RTN","PSBOMH1",74,0)
 ...S PSBINIT=$$GETINIT^PSBCSUTX(PSBIEN,"I") ;Get initials of who took action, PSB*3*72
"RTN","PSBOMH1",75,0)
 ...S PSBNAME=$$GETINIT^PSBCSUTX(PSBIEN,"N") ;Get name of who took action, PSB*3*72
"RTN","PSBOMH1",76,0)
 ...I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",77,0)
 ...S (PSBXA,PSBM)=1,(PSBZ,PSBT,PSBFLG)=""
"RTN","PSBOMH1",78,0)
 ...I $$GET1^DIQ(53.79,PSBIEN_",",.09)="REMOVED"  D
"RTN","PSBOMH1",79,0)
 ....F I=1:1 S PSBXA=$O(^PSB(53.79,PSBIEN,.9,PSBXA)) Q:PSBXA=""  I PSBXA?1.3N  S PSBZ=PSBZ+1,PSBT(PSBZ)=^PSB(53.79,PSBIEN,.9,PSBXA,0)
"RTN","PSBOMH1",80,0)
 ....F S=1:1 Q:PSBM<1  S PSBM=PSBZ-S  I (PSBM>0) I (PSBT(PSBM)["GIVEN")  S PSBFLG="1" S PRELINE1=$P(PSBT(PSBM),"'",2)_" "_$$GET1^DIQ(53.79,PSBIEN_",",.04)_" "_$E($P(PSBT(PSBM),"'",4),1,3) Q
"RTN","PSBOMH1",81,0)
 ...I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",82,0)
 ....D INSTR^PSBOMH
"RTN","PSBOMH1",83,0)
 ....S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",84,0)
 ...I '$D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,".")))  D PSBOUT(PSBDT,PSBINIT)
"RTN","PSBOMH1",85,0)
 ...S PSBLINE1=$$GET1^DIQ(53.79,PSBIEN_",",.09)_" "_$$GET1^DIQ(53.79,PSBIEN_",",.06)_" "_PSBINIT_"            "_$$GET1^DIQ(53.79,PSBIEN_",",.21),PSBLINE2=""
"RTN","PSBOMH1",86,0)
 ...I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",87,0)
 ...D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)="P"
"RTN","PSBOMH1",88,0)
 ....I $P($G(^PSB(53.79,PSBIEN,.2)),U,2)="" S PSBLINE2="  Results: <No PRN Results On File>"
"RTN","PSBOMH1",89,0)
 ....E  D
"RTN","PSBOMH1",90,0)
 .....S PSBINIT=$$GET1^DIQ(53.79,PSBIEN_",","PRN EFFECTIVENESS ENTERED BY:INITIAL")
"RTN","PSBOMH1",91,0)
 .....S PSBNAME=$$GET1^DIQ(53.79,PSBIEN_",","PRN EFFECTIVENESS ENTERED BY:NAME")
"RTN","PSBOMH1",92,0)
 .....I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",93,0)
 .....I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",94,0)
 ......S PSBINIT=PSBINIT_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."),0),U,3)_"  "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",95,0)
 ......S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",96,0)
 .....I '$D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,".")))  D
"RTN","PSBOMH1",97,0)
 ......D:$D(^PSB(53.79,PSBIEN,.9,0))
"RTN","PSBOMH1",98,0)
 .......S (PSBXA2,PSBFG)=0,PSBEFFDT=$P(^PSB(53.79,PSBIEN,.2),U,4) F  S PSBXA2=$O(^PSB(53.79,PSBIEN,.9,PSBXA2)) Q:+PSBXA2'>0  D  Q:PSBFG=1
"RTN","PSBOMH1",99,0)
 ........D:($P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U)=PSBEFFDT)&($P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,3)["Instruct")&($P(^PSB(53.79,PSBIEN,.2),U,3)=$P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,2))
"RTN","PSBOMH1",100,0)
 .........S PSBINIT=PSBINIT_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,3)_"  "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",101,0)
 .........S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)="",PSBFG=1
"RTN","PSBOMH1",102,0)
 .....S PSBLINE2="  Results: "_$$GET1^DIQ(53.79,PSBIEN_",",.22)
"RTN","PSBOMH1",103,0)
 .....S PSBRTXTW="     Entered By "_PSBINIT_" on "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",104,0)
 .....N PSBEIECMT,PSBCMTCH S PSBEIECMT="",PSBCMTCH=0 F  S PSBCMTCH=$O(^PSB(53.79,PSBIEN,.3,PSBCMTCH)) Q:'PSBCMTCH  D
"RTN","PSBOMH1",105,0)
 ......I $P($G(^PSB(53.79,PSBIEN,.3,PSBCMTCH,0)),U)["**Pain Score of" S PSBEIECMT=" **This Pain Score may have been Entered in Error. See Vitals Package.**"
"RTN","PSBOMH1",106,0)
 .....S PSBLINE2=PSBLINE2_PSBEIECMT
"RTN","PSBOMH1",107,0)
 .....I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",108,0)
 ...S X=PSBDT D H^%DTC F PSBWEEK=PSBAR(%H):-7 Q:$D(^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",0))!('$D(PSBAR(PSBWEEK)))
"RTN","PSBOMH1",109,0)
 ...S X=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",""),-1)+1
"RTN","PSBOMH1",110,0)
 ...I PSBFLG="1" S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X)=PRELINE1
"RTN","PSBOMH1",111,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+1)=PSBLINE1
"RTN","PSBOMH1",112,0)
 ...I $G(PSBLINE2)]"" D
"RTN","PSBOMH1",113,0)
 ....I $L(PSBLINE2)<=90 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+2)=PSBLINE2 S:$$GET1^DIQ(53.79,PSBIEN_",",.24)'="" ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+3)="      "_PSBRTXTW
"RTN","PSBOMH1",114,0)
 ....I $L(PSBLINE2)>90 D
"RTN","PSBOMH1",115,0)
 .....S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+2)=$E(PSBLINE2,1,90)
"RTN","PSBOMH1",116,0)
 .....S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+3)="           "_$E(PSBLINE2,91,169)
"RTN","PSBOMH1",117,0)
 .....I $L(PSBLINE2)'>169 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+4)="     "_PSBRTXTW
"RTN","PSBOMH1",118,0)
 .....I $L(PSBLINE2)>169 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+4)="           "_$E(PSBLINE2,170,245),^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+5)="     "_PSBRTXTW
"RTN","PSBOMH1",119,0)
 D RELINE^PSBOMH3(PSBWEEK) ;Line up administrations with their admin times - PSB*3*67
"RTN","PSBOMH1",120,0)
 Q
"RTN","PSBOMH1",121,0)
 ;
"RTN","PSBOMH1",122,0)
DDAUD ;  audits for dispen drugs
"RTN","PSBOMH1",123,0)
 ;
"RTN","PSBOMH1",124,0)
 M PSBMLA=^PSB(53.79,PSBIEN)
"RTN","PSBOMH1",125,0)
 S PSBGA="" I $D(PSBMLA(.9,0)) D
"RTN","PSBOMH1",126,0)
 .F PSBX=1:1 Q:'$D(PSBMLA(.9,PSBX))  I ((PSBMLA(.9,PSBX,0)["ACTION STATUS")!(PSBMLA(.9,PSBX,0)["ADMINISTRATION STATUS")) D  Q
"RTN","PSBOMH1",127,0)
 ..I $D(PSBMLA(.9,PSBX-2,0)) D DT^DILF("ENPST",$P(PSBMLA(.9,PSBX-2,0),"'",2),.PSBDATE)
"RTN","PSBOMH1",128,0)
 ..I '$D(PSBMLA(.9,PSBX-2,0)) S PSBDATE=$P(^PSB(53.79,PSBIEN,0),U,6)
"RTN","PSBOMH1",129,0)
 ..S PSBTMP(10000000-PSBDATE,"B")=PSBDATE_U_$$INITIAL^PSBRPC2($P(PSBMLA(0),U,5))_U_$P(PSBMLA(.9,PSBX,0),"'",2)
"RTN","PSBOMH1",130,0)
 ..S PSBGA=1
"RTN","PSBOMH1",131,0)
 .F PSBX=1:1 Q:'$D(PSBMLA(.9,PSBX))  I ((PSBMLA(.9,PSBX,0)["ACTION STATUS")!(PSBMLA(.9,PSBX,0)["ADMINISTRATION STATUS")) D
"RTN","PSBOMH1",132,0)
 ..S PSBTMP(10000000-$P(PSBMLA(.9,PSBX,0),U,1),"B")=$P(PSBMLA(.9,PSBX,0),U,1)_U_$$INITIAL^PSBRPC2($P(PSBMLA(.9,PSBX,0),U,2))_U_$P($P(PSBMLA(.9,PSBX,0),U,3),"'",2)
"RTN","PSBOMH1",133,0)
 ..S PSBGA=1
"RTN","PSBOMH1",134,0)
 ;PSB*3*45 Remove Use of $Q(<>,-1)
"RTN","PSBOMH1",135,0)
 N PSBTMQ
"RTN","PSBOMH1",136,0)
 I PSBGA'=1 S PSBTMP(10000000-$P(PSBMLA(0),U,6),"A")=$P(PSBMLA(0),U,6)_U_$$INITIAL^PSBRPC2($P(PSBMLA(0),U,7))
"RTN","PSBOMH1",137,0)
 S PSBQRY="PSBTMP",PSBCNT=1 F  S PSBTMQ=PSBQRY,PSBQRY=$Q(@PSBQRY) Q:PSBQRY=""  D  ; does comment go with action
"RTN","PSBOMH1",138,0)
 .S PSBPQRY=$G(PSBTMQ)
"RTN","PSBOMH1",139,0)
 .I PSBPQRY="" S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1 Q  ; no prev action
"RTN","PSBOMH1",140,0)
 .I $QS(PSBPQRY,2)="C"  S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1 Q  ; prev line = comment
"RTN","PSBOMH1",141,0)
 .I $QS(PSBQRY,2)="C",$E($P(@PSBTMQ,U,1),1,12)=$E($P(@PSBQRY,U,1),1,12),$P(@PSBTMQ,U,2)=$P(@PSBQRY,U,2) D  Q
"RTN","PSBOMH1",142,0)
 ..S X=$P(@PSBQRY,U,4) S:X[":" X=$P(X,":",2) S $P(PSBTAR(PSBCNT-1),U,4)=X Q
"RTN","PSBOMH1",143,0)
 .S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1
"RTN","PSBOMH1",144,0)
 Q
"RTN","PSBOMH1",145,0)
 ;
"RTN","PSBOMH1",146,0)
PSBOUT(PSBTET,PSBOT1) ;
"RTN","PSBOMH1",147,0)
 I '$D(^PSB(53.79,PSBIEN,.9,0))  D PSBENT^PSBOMH2(PSBOT1)
"RTN","PSBOMH1",148,0)
 S PSBIDA="" I $P(^PSB(53.79,PSBIEN,0),U,6)=PSBTET S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,7),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",149,0)
 S PSBXA1=0
"RTN","PSBOMH1",150,0)
 F  S PSBXA1=$O(^PSB(53.79,PSBIEN,.9,PSBXA1)) Q:+PSBXA1'>0  I PSBXA1'=0  D  Q:$G(PSBOT1)["*"
"RTN","PSBOMH1",151,0)
 .I $L(PSBXA1)<4  D
"RTN","PSBOMH1",152,0)
 ..I $P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",1)=PSBTET  D
"RTN","PSBOMH1",153,0)
 ...S:$G(PSBIDA)="" PSBIDA=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",2),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",154,0)
 ...I (PSBIDA=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",2)),$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",3)["Instruct"  D
"RTN","PSBOMH1",155,0)
 ....S INSDD=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",1),Y=INSDD D DD^%DT S INSDD=Y
"RTN","PSBOMH1",156,0)
 ....S PSBOT1=PSBOT1_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),U,3)_" "_INSDD
"RTN","PSBOMH1",157,0)
 I $G(PSBIDA)="",$P(^PSB(53.79,PSBIEN,0),U,4)=PSBTET D
"RTN","PSBOMH1",158,0)
 .S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,5),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",159,0)
 I $G(PSBNAME)="" D
"RTN","PSBOMH1",160,0)
 . S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,5),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",161,0)
 S ^TMP("PSB",$J,"LEGEND",$S($G(PSBOT1)="":99,1:PSBOT1),PSBNAME)=""
"RTN","PSBOMH1",162,0)
 Q
"RTN","PSBOMH1",163,0)
 ;
"RTN","PSBOML")
0^1^B64746915^B62348455
"RTN","PSBOML",1,0)
PSBOML ;BIRMINGHAM/EFC-MEDICATION LOG ;11/14/12 11:58am
"RTN","PSBOML",2,0)
 ;;3.0;BAR CODE MED ADMIN;**3,11,50,54,70,72**;Mar 2004;Build 16
"RTN","PSBOML",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBOML",4,0)
 ;
"RTN","PSBOML",5,0)
 ; Reference/IA
"RTN","PSBOML",6,0)
 ; ^DPT/10035
"RTN","PSBOML",7,0)
 ; SENDMSG^XMXAPI/2729
"RTN","PSBOML",8,0)
 ; ^XLFDT/10103
"RTN","PSBOML",9,0)
 ;
"RTN","PSBOML",10,0)
 ;*70 - Add Witness for High Risk Drug to report
"RTN","PSBOML",11,0)
 ;    - print Clinic name with each order that occurred in a clinic
"RTN","PSBOML",12,0)
 ;    - set psbclinord=2 for dual hdr text
"RTN","PSBOML",13,0)
 ;    - create var for Search list and use for both IM & CO, pass to
"RTN","PSBOML",14,0)
 ;      PSBOHDR api
"RTN","PSBOML",15,0)
 ;    - 1489: Blended PSB*3*54 with PSB*3*70
"RTN","PSBOML",16,0)
 ;
"RTN","PSBOML",17,0)
EN ; Begin printing
"RTN","PSBOML",18,0)
 N PSBSTRT,PSBSTOP,PSBHDR,DFN,PSBSORT,PSBSRCHL
"RTN","PSBOML",19,0)
 S PSBSORT=$P(PSBRPT(.1),U,1)                                     ;*70
"RTN","PSBOML",20,0)
 S PSBSTRT=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,7)
"RTN","PSBOML",21,0)
 S PSBSTOP=$P(PSBRPT(.1),U,8)+$P(PSBRPT(.1),U,9)
"RTN","PSBOML",22,0)
 S PSBAUDF=$P(PSBRPT(.2),U,9)
"RTN","PSBOML",23,0)
 S PSBHDR(0)="Medication Log Report for "_$$FMTE^XLFDT(PSBSTRT)_" to "_$$FMTE^XLFDT(PSBSTOP) ;Add time frame for report header, PSB*3*72
"RTN","PSBOML",24,0)
 S PSBHDR(1)="Continuing/PRN/Stat/One Time Medication/Treatment Record (Detailed Log) (VAF 10-2970 B, C, D)"
"RTN","PSBOML",25,0)
 ;check Clinic or Nurs Unit search list                *70
"RTN","PSBOML",26,0)
 S PSBSRCHL=$$SRCHLIST^PSBOHDR()
"RTN","PSBOML",27,0)
 ;
"RTN","PSBOML",28,0)
 ; Patient Report
"RTN","PSBOML",29,0)
 ;
"RTN","PSBOML",30,0)
 D:PSBSORT="P"
"RTN","PSBOML",31,0)
 .S PSBHDR(2)="Log Type: INDIVIDUAL PATIENT"
"RTN","PSBOML",32,0)
 .S DFN=+$P(PSBRPT(.1),U,2)
"RTN","PSBOML",33,0)
 .W $$PTHDR()
"RTN","PSBOML",34,0)
 .S X=$O(^PSB(53.79,"AADT",DFN,PSBSTRT-.0000001))
"RTN","PSBOML",35,0)
 .I X>PSBSTOP!(X="") W !!?10,"<<<< NO MEDICATIONS FOUND FOR THIS TIME FRAME >>>>",!! Q
"RTN","PSBOML",36,0)
 .S PSBGBL=$NAME(^PSB(53.79,"AADT",DFN,PSBSTRT-.0000001))
"RTN","PSBOML",37,0)
 .F  S PSBGBL=$Q(@PSBGBL) Q:PSBGBL=""  Q:$QS(PSBGBL,2)'="AADT"!($QS(PSBGBL,3)'=DFN)!($QS(PSBGBL,4)>PSBSTOP)  D
"RTN","PSBOML",38,0)
 ..S PSBIEN=$QS(PSBGBL,5) Q:'$D(^PSB(53.79,PSBIEN))
"RTN","PSBOML",39,0)
 ..I $P(^PSB(53.79,PSBIEN,0),U,6)'=$QS(PSBGBL,4) Q
"RTN","PSBOML",40,0)
 ..I $Y>(IOSL-10) W $$PTFTR^PSBOHDR(),$$PTHDR()
"RTN","PSBOML",41,0)
 ..W $$LINE(PSBIEN)
"RTN","PSBOML",42,0)
 .W $$PTFTR^PSBOHDR()
"RTN","PSBOML",43,0)
 ;
"RTN","PSBOML",44,0)
 ; Ward Output
"RTN","PSBOML",45,0)
 ;
"RTN","PSBOML",46,0)
 D:PSBSORT="W"
"RTN","PSBOML",47,0)
 .S PSBHDR(2)="LOG TYPE: WARD"
"RTN","PSBOML",48,0)
 .W $$WDHDR(PSBWRD)
"RTN","PSBOML",49,0)
 .S PSBTMPG=$NAME(^TMP("PSBO",$J,"B"))
"RTN","PSBOML",50,0)
 .F  S PSBTMPG=$Q(@PSBTMPG) Q:PSBTMPG=""  Q:$QS(PSBTMPG,1)'="PSBO"!($QS(PSBTMPG,2)'=$J)  D
"RTN","PSBOML",51,0)
 ..S DFN=$QS(PSBTMPG,5)
"RTN","PSBOML",52,0)
 ..I $Y>(IOSL-14) W $$WDHDR(PSBWRD)
"RTN","PSBOML",53,0)
 ..W !,$P(^DPT(DFN,0),U),"  (",$P(^(0),U,9),")"
"RTN","PSBOML",54,0)
 ..W !,"Ward: ",$G(^DPT(DFN,.1),"***"),"  Rm-Bed: ",$G(^DPT(DFN,.101),"***"),!
"RTN","PSBOML",55,0)
 ..S X=$O(^PSB(53.79,"AADT",DFN,PSBSTRT-.0000001))
"RTN","PSBOML",56,0)
 ..I X>PSBSTOP!(X="") W !!?10,"<<<< NO MEDICATIONS FOUND FOR THIS TIME FRAME >>>>",!! Q
"RTN","PSBOML",57,0)
 ..S PSBGBL=$NAME(^PSB(53.79,"AADT",DFN,PSBSTRT-.0000001))
"RTN","PSBOML",58,0)
 ..F  S PSBGBL=$Q(@PSBGBL) Q:PSBGBL=""  Q:$QS(PSBGBL,2)'="AADT"!($QS(PSBGBL,3)'=DFN)!($QS(PSBGBL,4)>PSBSTOP)  D
"RTN","PSBOML",59,0)
 ...S PSBIEN=$QS(PSBGBL,5) I $P(^PSB(53.79,PSBIEN,0),U,6)'=$QS(PSBGBL,4) Q
"RTN","PSBOML",60,0)
 ...W:$Y>(IOSL-10) $$WDHDR(PSBWRD)
"RTN","PSBOML",61,0)
 ...W $$LINE(PSBIEN)
"RTN","PSBOML",62,0)
 Q
"RTN","PSBOML",63,0)
 ;
"RTN","PSBOML",64,0)
LINE(PSBIEN) ; Displays the med log entry in PSBIEN
"RTN","PSBOML",65,0)
 N PSBX,PSBASTUS,PSBMME,PSBEXIST
"RTN","PSBOML",66,0)
 S X=$P($G(^PSB(53.79,PSBIEN,.1)),U)
"RTN","PSBOML",67,0)
 I X="" W !,"Error: Med Log Entry ",PSBIEN," has no order reference number!" Q ""
"RTN","PSBOML",68,0)
 I 'PSBAUDF,$P(^PSB(53.79,PSBIEN,0),U,9)="N" Q ""
"RTN","PSBOML",69,0)
 D CLEAN^PSBVT
"RTN","PSBOML",70,0)
 D PSJ1^PSBVT(DFN,X,,.PSBEXIST)
"RTN","PSBOML",71,0)
 ;   ;[*70-1489]...start
"RTN","PSBOML",72,0)
 I '$G(PSBEXIST),($G(PSBSCRT)="-1") D  ;send email to BCMA UKNOWN ACTIONS group if order given in BCMA does not have a corresponding # 55 file entry
"RTN","PSBOML",73,0)
 .N XMDUZ,XMSUB,XMTEXT,XMY,PSBERR,PSBPARAM,PSBMG
"RTN","PSBOML",74,0)
 .S XMSUB="Order given in BCMA does not exist in Pharmacy Patient file"
"RTN","PSBOML",75,0)
 .S XMDUZ=DUZ
"RTN","PSBOML",76,0)
 .S XMTEXT="PSBERR"
"RTN","PSBOML",77,0)
 .S PSBMG=$$GET^XPAR("DIV","PSB MG ADMIN ERROR",,"E"),PSBMG="G."_PSBMG
"RTN","PSBOML",78,0)
 .S XMY(PSBMG)=""
"RTN","PSBOML",79,0)
 .S PSBERR(1)="Order #"_$G(PSBIEN)_" given in BCMA no longer has"
"RTN","PSBOML",80,0)
 .S PSBERR(2)="a corresponding entry in the Pharmacy Patient (#55) file."
"RTN","PSBOML",81,0)
 .S PSBERR(3)="Please submit a remedy ticket for this issue."
"RTN","PSBOML",82,0)
 .D SENDMSG^XMXAPI(XMDUZ,XMSUB,XMTEXT,.XMY)
"RTN","PSBOML",83,0)
 .Q
"RTN","PSBOML",84,0)
  ;   ;[*70-1489]...end
"RTN","PSBOML",85,0)
 I PSBDFN="-1" W !,"Error: Inpatient Meds API Failure!" Q ""
"RTN","PSBOML",86,0)
 M PSBX=^PSB(53.79,PSBIEN)
"RTN","PSBOML",87,0)
 S Y=$P(PSBX(0),U,4)+.0000001
"RTN","PSBOML",88,0)
 ;*70 print location name per each clinic order
"RTN","PSBOML",89,0)
 S PSBMME=$$MME(+$G(PSBIEN)) I $G(PSBMME),($TR($P(PSBX(0),U,2)," ","")="") S $P(PSBX(0),U,2)="MME/UNKNOWN LOCATION"
"RTN","PSBOML",90,0)
 W:$P(PSBX(0),U,2)]"" !,?3,$P(PSBX(0),U,2)
"RTN","PSBOML",91,0)
 W !,$E(Y,4,5),"/",$E(Y,6,7),"/",$E(Y,2,3)
"RTN","PSBOML",92,0)
 W " ",$E(Y,9,10),":",$E(Y,11,12)
"RTN","PSBOML",93,0)
 S Y=$$GET1^DIQ(53.79,PSBIEN_",",.08)
"RTN","PSBOML",94,0)
 S Y=Y_" ["_$G(PSBDOSE)_$G(PSBIFR)_" "_$G(PSBSCH)   ;[*70-1489]
"RTN","PSBOML",95,0)
 S Y=Y_" "_$G(PSBMRAB)                              ;[*70-1489]
"RTN","PSBOML",96,0)
 S:$P($G(^PSB(53.79,PSBIEN,.1)),U,6)]"" Y=Y_" Inj Site: "_$P(^(.1),U,6)
"RTN","PSBOML",97,0)
 S Y=Y_"]"
"RTN","PSBOML",98,0)
 W $$WRAP^PSBO(16,32,Y)
"RTN","PSBOML",99,0)
 W ?50,$$GETINIT^PSBCSUTX(PSBIEN,"I") ;Get initials of who took action, PSB*3*72
"RTN","PSBOML",100,0)
 S X=$P(PSBX(0),U,9)
"RTN","PSBOML",101,0)
 S PSBASTUS=$S(X="G":"Given",X="H":"Held",X="R":"Refused",X="I":"Infusing",X="C":"Completed",X="S":"Stopped",X="N":"Not Given",X="RM":"Removed",X="M":"Missing dose",1:"Status Unknown")
"RTN","PSBOML",102,0)
 S Y=$P(PSBX(0),U,6)+.0000001
"RTN","PSBOML",103,0)
 S Y=$E(Y,4,5)_"/"_$E(Y,6,7)_"/"_$E(Y,2,3)_" "_$E(Y,9,10)_":"_$E(Y,11,12)
"RTN","PSBOML",104,0)
 S Y=Y_" "_$G(PSBASTUS)   ;[*70-1489]
"RTN","PSBOML",105,0)
 W $$WRAP^PSBO(57,15,Y)
"RTN","PSBOML",106,0)
 W:$P(PSBX(.1),U)["V" ?75,"Bag ID #",$$GET1^DIQ(53.79,PSBIEN,"IV UNIQUE ID")
"RTN","PSBOML",107,0)
 W:$P(PSBX(.1),U)["V" ?107,"NA",?115,"NA",?120,"NA"
"RTN","PSBOML",108,0)
 W !,$TR($$FMTE^XLFDT($G(PSBOST),2),"@"," ")_">"   ;[*70-1489]
"RTN","PSBOML",109,0)
 F PSBZ=.5,.6,.7 S PSBDHIT=0 F PSBY=0:0 S PSBY=$O(PSBX(PSBZ,PSBY)) Q:'PSBY  D
"RTN","PSBOML",110,0)
 .W:$X>75 !
"RTN","PSBOML",111,0)
 .S PSBDD=$S(PSBZ=.5:53.795,PSBZ=.6:53.796,1:53.797)
"RTN","PSBOML",112,0)
 .S Y=$$EXTERNAL^DILFD(PSBDD,.01,"",$P(PSBX(PSBZ,PSBY,0),U,1))
"RTN","PSBOML",113,0)
 .W $$WRAP^PSBO(75,28,Y)
"RTN","PSBOML",114,0)
 .I $P(PSBX(.1),U)["U" W ?105,$J($P(PSBX(PSBZ,PSBY,0),U,2),6,2),?113,$J($P(PSBX(PSBZ,PSBY,0),U,3),6,2) W $$WRAP^PSBO(120,12,$P(PSBX(PSBZ,PSBY,0),U,4)) S PSBDHIT=1
"RTN","PSBOML",115,0)
 .W:$P(PSBX(.1),U)["V"&($X+3+$L($P(PSBX(PSBZ,PSBY,0),U,3))>105) !?75
"RTN","PSBOML",116,0)
 .W:$P(PSBX(.1),U)["V" " - ",$P(PSBX(PSBZ,PSBY,0),U,2) ;Use units ordered field for IV's, PSB*3*72
"RTN","PSBOML",117,0)
 D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)="P"
"RTN","PSBOML",118,0)
 .W !?16,"PRN Reason: ",?30,$$GET1^DIQ(53.79,PSBIEN_",",.21)
"RTN","PSBOML",119,0)
 .W !?16,"PRN Effectiveness: "
"RTN","PSBOML",120,0)
 .I $P($G(^PSB(53.79,PSBIEN,.2)),U,2)="" W "<No PRN Effectiveness Entered>" Q
"RTN","PSBOML",121,0)
 .N PSBEIECMT S PSBEIECMT="" I $P($G(^PSB(53.79,PSBIEN,.2)),U,2)'="",$P(PSBRPT(.2),U,8)=0 S PSBEIECMT=$$PRNEFF^PSBO(PSBEIECMT,PSBIEN)
"RTN","PSBOML",122,0)
 .W $$WRAP^PSBO(20,100,$$GET1^DIQ(53.79,PSBIEN_",",.22)_PSBEIECMT)
"RTN","PSBOML",123,0)
 .W !?20,"Entered By: ",$$GET1^DIQ(53.79,PSBIEN_",",.23)
"RTN","PSBOML",124,0)
 .W " Date/Time: ",$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOML",125,0)
 .W " Minutes: ",$$GET1^DIQ(53.79,PSBIEN_",",.25)
"RTN","PSBOML",126,0)
 D:$P(PSBRPT(.2),U,8)
"RTN","PSBOML",127,0)
 .W !?16,"Comments: ",?30 I '$O(PSBX(.3,0)) W "<No Comments>"
"RTN","PSBOML",128,0)
 .F PSBY=0:0 S PSBY=$O(PSBX(.3,PSBY)) Q:'PSBY  D
"RTN","PSBOML",129,0)
 ..W:$X>30 !?30
"RTN","PSBOML",130,0)
 ..S Y=$P(PSBX(.3,PSBY,0),U,3)+.0000001
"RTN","PSBOML",131,0)
 ..W $E(Y,4,5),"/",$E(Y,6,7),"/",$E(Y,2,3)
"RTN","PSBOML",132,0)
 ..W " ",$E(Y,9,10),":",$E(Y,11,12)
"RTN","PSBOML",133,0)
 ..W ?46,$$GET1^DIQ(53.793,PSBY_","_PSBIEN_",","ENTERED BY:INITIAL")
"RTN","PSBOML",134,0)
 ..W $$WRAP^PSBO(52,70,$P(PSBX(.3,PSBY,0),U,1))
"RTN","PSBOML",135,0)
 .;*70 Witness new line after Comments section chosen
"RTN","PSBOML",136,0)
 .N WITBY,WITDT,WITCM,WITHR,WITFL
"RTN","PSBOML",137,0)
 .S WITBY=$$GET1^DIQ(53.79,PSBIEN_",",.29)
"RTN","PSBOML",138,0)
 .S WITDT=$$GET1^DIQ(53.79,PSBIEN_",",.28,"I")
"RTN","PSBOML",139,0)
 .S WITCM=$$GET1^DIQ(53.79,PSBIEN_",",.31)
"RTN","PSBOML",140,0)
 .S WITHR=$$GET1^DIQ(53.79,PSBIEN_",",.32)
"RTN","PSBOML",141,0)
 .S WITFL=$$GET1^DIQ(53.79,PSBIEN_",",.33)
"RTN","PSBOML",142,0)
 .I WITBY]"" D
"RTN","PSBOML",143,0)
 ..W !?16,"Witnessed by:",?30,WITBY," on "
"RTN","PSBOML",144,0)
 ..W $P($$FMTE^XLFDT($$GET1^DIQ(53.79,PSBIEN_",",.28,"I"),2),":",1,2)
"RTN","PSBOML",145,0)
 .I WITFL="NO",WITBY="" D
"RTN","PSBOML",146,0)
 ..W !?16,"Witnessed?:",?30,WITFL
"RTN","PSBOML",147,0)
 .W:WITCM]"" !,$$WRAP^PSBO(30,102,WITCM)
"RTN","PSBOML",148,0)
 .;
"RTN","PSBOML",149,0)
 .W !,$TR($$FMTE^XLFDT($G(PSBOSP),2),"@"," ")_"<"   ;[*70-1489]
"RTN","PSBOML",150,0)
 .;
"RTN","PSBOML",151,0)
 D:PSBAUDF
"RTN","PSBOML",152,0)
 .W !?16,"Audits: ",?30 I '$O(PSBX(.9,0)) W "<No Audits>" Q
"RTN","PSBOML",153,0)
 .F PSBY=0:0 S PSBY=$O(PSBX(.9,PSBY)) Q:'PSBY  D
"RTN","PSBOML",154,0)
 ..W:$X>30 !?30
"RTN","PSBOML",155,0)
 ..S Y=$P(PSBX(.9,PSBY,0),U,1)+.0000001
"RTN","PSBOML",156,0)
 ..W $E(Y,4,5),"/",$E(Y,6,7),"/",$E(Y,2,3)
"RTN","PSBOML",157,0)
 ..W " ",$E(Y,9,10),":",$E(Y,11,12)
"RTN","PSBOML",158,0)
 ..W ?46,$$GET1^DIQ(53.799,PSBY_","_PSBIEN_",","USER:INITIAL")
"RTN","PSBOML",159,0)
 ..W $$WRAP^PSBO(52,70,$P(PSBX(.9,PSBY,0),U,3))
"RTN","PSBOML",160,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBOML",161,0)
 Q ""
"RTN","PSBOML",162,0)
 ;
"RTN","PSBOML",163,0)
WDHDR(PSBWARD) ;
"RTN","PSBOML",164,0)
 N PSBCLINORD S PSBCLINORD=2              ;2=both order type hdr   *70
"RTN","PSBOML",165,0)
 S PSBHDR(3)="",PSBHDR(4)="Ward Location: "
"RTN","PSBOML",166,0)
 D WARD^PSBOHDR(PSBWARD,.PSBHDR,,,PSBSRCHL)
"RTN","PSBOML",167,0)
 W $$SUB()
"RTN","PSBOML",168,0)
 Q ""
"RTN","PSBOML",169,0)
 ;
"RTN","PSBOML",170,0)
PTHDR() ;
"RTN","PSBOML",171,0)
 N PSBCLINORD S PSBCLINORD=2              ;2=both order type hdr   *70
"RTN","PSBOML",172,0)
 S:$G(PSBSRCHL)]"" PSBHDR(3)="",PSBHDR(4)="Ward Location: "
"RTN","PSBOML",173,0)
 D PT^PSBOHDR(DFN,.PSBHDR,,,PSBSRCHL)
"RTN","PSBOML",174,0)
 W $$SUB()
"RTN","PSBOML",175,0)
 Q ""
"RTN","PSBOML",176,0)
 ;
"RTN","PSBOML",177,0)
SUB() ; Med Log Sub Header
"RTN","PSBOML",178,0)
 W:$X>1 !
"RTN","PSBOML",179,0)
 W "Location",!
"RTN","PSBOML",180,0)
 W "Activity Date",?16,"Orderable Item",?50,"Action",?57,"Action"
"RTN","PSBOML",181,0)
 W !,"Start Date>",?16,"[Dose/Sched/Route/Inj Site]",?50,"By"
"RTN","PSBOML",182,0)
 W ?57,"Date/Time",?75,"Drug/Additive/Solution",?105," U/Ord"
"RTN","PSBOML",183,0)
 W ?113," U/Gvn",?120,"Unit",!,"Stop Date<"
"RTN","PSBOML",184,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBOML",185,0)
 Q ""
"RTN","PSBOML",186,0)
 ;
"RTN","PSBOML",187,0)
MME(PSBIEN) ; Administered via Manual Med Entry?
"RTN","PSBOML",188,0)
 N MME,CMMT,CMMTND S MME=0
"RTN","PSBOML",189,0)
 S CMMT="" F  S CMMT=$O(^PSB(53.79,+PSBIEN,.3,CMMT)) Q:CMMT=""!$G(MME)  D
"RTN","PSBOML",190,0)
 .S CMMTND=$G(^PSB(53.79,+PSBIEN,.3,CMMT,0)) I CMMTND["Entry created with 'Manual Medication Entry'" S MME=1
"RTN","PSBOML",191,0)
 Q $S($G(MME):1,1:0)
"RTN","PSBOMT")
0^4^B93970205^B91036821
"RTN","PSBOMT",1,0)
PSBOMT ;BIRMINGHAM/TEJ-BCMA MEDICATION THERAPY REPORT ;8/12/12 9:56pm
"RTN","PSBOMT",2,0)
 ;;3.0;BAR CODE MED ADMIN;**32,50,70,72**;Mar 2004;Build 16
"RTN","PSBOMT",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBOMT",4,0)
 ;
"RTN","PSBOMT",5,0)
 ; Reference/IA
"RTN","PSBOMT",6,0)
 ; File 50.7/2880
"RTN","PSBOMT",7,0)
 ; File 52.6/436
"RTN","PSBOMT",8,0)
 ; File 52.7/437
"RTN","PSBOMT",9,0)
 ; File 200/10060
"RTN","PSBOMT",10,0)
 ; EN^PSJBCMA1/2829
"RTN","PSBOMT",11,0)
 ; IEN^PSN50P65/4543
"RTN","PSBOMT",12,0)
 ; DRGIEN^PSS50P7/4662
"RTN","PSBOMT",13,0)
 ; VAC^PSS50/4533
"RTN","PSBOMT",14,0)
 ; ^PSDRUG(/221 
"RTN","PSBOMT",15,0)
 ;
"RTN","PSBOMT",16,0)
 ;*70 - reset PSBCLINORD = 2 to signify combined orders report
"RTN","PSBOMT",17,0)
 ;
"RTN","PSBOMT",18,0)
EN ;
"RTN","PSBOMT",19,0)
 N PSBHDR,PSBORDS,PSBORD,PSBOIP
"RTN","PSBOMT",20,0)
 N TMP
"RTN","PSBOMT",21,0)
 K TMP("PSBOIS",$J),TMP("VA CLASS",$J),TMP("PSBADDS",$J),TMP("PSBSOLS",$J),PSBLGD,PSBOIL,PSBDDL,PSBSOLL,PSBADDL
"RTN","PSBOMT",22,0)
 S PSBCLSS=0,PSBCFLG=0
"RTN","PSBOMT",23,0)
 S PSBXDFN=$P(PSBRPT(.1),U,2)
"RTN","PSBOMT",24,0)
 S PSBSTRT=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,7),PSBSTOP=$P(PSBRPT(.1),U,8)+$P(PSBRPT(.1),U,9)
"RTN","PSBOMT",25,0)
 K PSBOCRIT F Y=1:1:4 I $P(PSBRPT(.2),U,Y) S PSBOCRIT=$G(PSBOCRIT,"")_$P("C^P^OC^O",U,Y)_"^"
"RTN","PSBOMT",26,0)
 D NOW^%DTC S (Y,PSBNOWX)=% D DD^%DT S PSBDTTM=$E(Y,1,18)
"RTN","PSBOMT",27,0)
 S:+PSBSTRT'>0 PSBSTRT=$$FMADD^XLFDT(X,-1)
"RTN","PSBOMT",28,0)
 S:+PSBSTOP'>0 PSBSTOP=$P(%,".")
"RTN","PSBOMT",29,0)
 I $D(PSBRPT(.2)) I $P(PSBRPT(.2),U,8) S PSBCFLG=1
"RTN","PSBOMT",30,0)
 I $D(PSBRPT(2)) F XD=$O(PSBRPT(2,0)):1:$O(PSBRPT(2,"B"),-1) S PSBRPT(2,XD,0)=$TR(PSBRPT(2,XD,0),"~",U) D:$P(PSBRPT(2,XD,0),U)="MT"
"RTN","PSBOMT",31,0)
 .I $P(PSBRPT(2,XD,0),U,2)="OIT" D  Q
"RTN","PSBOMT",32,0)
 ..S PSBSRCHL="ORDERABLE ITEM SEARCH LIST:",PSBOIL(+$P(PSBRPT(2,XD,0),U,3))=""
"RTN","PSBOMT",33,0)
 ..S PSB=$P(PSBRPT(2,XD,0),U,3) F X=1:1:$L(PSB,",") Q:$P(PSB,",",X)=""  S (TMP("PSBOIS",$J,$P(PSB,",",X)),PSBOIP("OIP",$P(PSB,",",X)))=""
"RTN","PSBOMT",34,0)
 .I $P(PSBRPT(2,XD,0),U,2)="ADD" D  Q
"RTN","PSBOMT",35,0)
 ..S PSBSRCHL="IV MEDICATION SEARCH LIST:"
"RTN","PSBOMT",36,0)
 ..I $D(^PSDRUG("A526",$P(PSBRPT(2,XD,0),U,3))) S X2=$O(^PSDRUG("A526",$P(PSBRPT(2,XD,0),U,3),"")) S PSBADDL(X2)="",TMP("PSBOIS",$J,$$OFROMA(X2))=""
"RTN","PSBOMT",37,0)
 .I $P(PSBRPT(2,XD,0),U,2)="SOL" D  Q
"RTN","PSBOMT",38,0)
 ..S PSBSRCHL="IV MEDICATION SEARCH LIST:"
"RTN","PSBOMT",39,0)
 ..I $D(^PSDRUG("A527",$P(PSBRPT(2,XD,0),U,3))) S X2=$O(^PSDRUG("A527",$P(PSBRPT(2,XD,0),U,3),"")) S PSBSOLL(X2)="",TMP("PSBOIS",$J,$$OFROMS(X2))=""
"RTN","PSBOMT",40,0)
 .I $P(PSBRPT(2,XD,0),U,2)="DD" D  K PSBDRGS Q
"RTN","PSBOMT",41,0)
 ..S PSBSRCHL="DISPENSED DRUG SEARCH LIST:",PSBDDL($P(PSBRPT(2,XD,0),U,3))=""
"RTN","PSBOMT",42,0)
 ..K PSBDRGS S PSBDRGS="" D OILST^PSBRPCMO(.PSBDRGS,$P(PSBRPT(2,XD,0),U,3),"UD")
"RTN","PSBOMT",43,0)
 ..F X2=PSBDRGS(0):1:$O(PSBDRGS(""),-1) I +PSBDRGS(1)'<0 S TMP("PSBOIS",$J,$P(PSBDRGS(X2),U,4))=""
"RTN","PSBOMT",44,0)
 .I $P(PSBRPT(2,XD,0),U,2)="VAC" D
"RTN","PSBOMT",45,0)
 ..S PSBSRCHL="VA DRUG CLASS SEARCH LIST:"
"RTN","PSBOMT",46,0)
 ..S PSBCLS=$P(PSBRPT(2,XD,0),U,3) D GETCLSS(PSBCLS) K PSBDDRG("VAC") M TMP("VA CLASS",$J,PSBCLS,"DDRG")=PSBDDRG K PSBDDRG
"RTN","PSBOMT",47,0)
 ..S PSBCLSS=1
"RTN","PSBOMT",48,0)
 M PSBOIP("OIP")=TMP("PSBOIS",$J)
"RTN","PSBOMT",49,0)
 D OUT(PSBXDFN,PSBSTRT,PSBSTOP)
"RTN","PSBOMT",50,0)
 Q
"RTN","PSBOMT",51,0)
OUT(PSBXDFN,PSBSTRT,PSBSTOP) ;
"RTN","PSBOMT",52,0)
 D:PSBCLSS GETOIS  ; POSSBLE CLASS ITEMS VIA AVAIL ORDERS
"RTN","PSBOMT",53,0)
 D GETADSO^PSBOMT1 ; ALL ADDS AND SOLS
"RTN","PSBOMT",54,0)
 D FINDIENS^PSBOMT1 ; FIND ALL MED LOG ENTRS
"RTN","PSBOMT",55,0)
 D PREOUT ;   WRIT TO GLOBL
"RTN","PSBOMT",56,0)
 D WRITEOT
"RTN","PSBOMT",57,0)
 D CLEANSUM^PSBOMT1
"RTN","PSBOMT",58,0)
 D CLEANALL^PSBOMT1
"RTN","PSBOMT",59,0)
 Q
"RTN","PSBOMT",60,0)
GETOIS ;
"RTN","PSBOMT",61,0)
 K ^TMP("PSJ",$J),PSBTMP
"RTN","PSBOMT",62,0)
 D EN^PSJBCMA(PSBXDFN,PSBSTRT)
"RTN","PSBOMT",63,0)
 Q:^TMP("PSJ",$J,1,0)<0
"RTN","PSBOMT",64,0)
 M PSBTMP=^TMP("PSJ",$J) K ^TMP("PSJ",$J)
"RTN","PSBOMT",65,0)
 S X=0 F  S X=$O(PSBTMP(X)) Q:+X=0  D
"RTN","PSBOMT",66,0)
 .Q:$G(PSBOCRIT,"")'[$P(PSBTMP(X,1),U,2)_"^"
"RTN","PSBOMT",67,0)
 .S PSBORDN=$P(PSBTMP(X,0),U,3) S PSBORDS(PSBORDN)=""
"RTN","PSBOMT",68,0)
 .I $D(PSBTMP(X,700)) D  Q
"RTN","PSBOMT",69,0)
 ..F XX=1:1:PSBTMP(X,700,0) D
"RTN","PSBOMT",70,0)
 ...S PSBCLS="" F  S PSBCLS=$O(TMP("VA CLASS",$J,PSBCLS)) Q:+PSBCLS=0  D
"RTN","PSBOMT",71,0)
 ....I '$D(TMP("VA CLASS",$J,PSBCLS,"DDRG",$P(PSBTMP(X,700,XX,0),U))) Q
"RTN","PSBOMT",72,0)
 ....S PSBORDS(PSBORDN,"DD",$P(PSBTMP(X,700,XX,0),U))=""
"RTN","PSBOMT",73,0)
 ....S PSBORDS(PSBORDN,"OIP",$P(PSBTMP(X,3),U))=""
"RTN","PSBOMT",74,0)
 ..M PSBOIP("OIP")=PSBORDS(PSBORDN,"OIP")
"RTN","PSBOMT",75,0)
 .I $D(PSBTMP(X,850)) M PSBORDS(PSBORDN,"ADD")=PSBTMP(X,850) D
"RTN","PSBOMT",76,0)
 ..F XX=1:1:PSBORDS(PSBORDN,"ADD",0) S PSBORDS(PSBORDN,"OIP",$$OFROMA($P(PSBORDS(PSBORDN,"ADD",XX,0),U)))=""
"RTN","PSBOMT",77,0)
 ..M PSBOIP("OIP")=PSBORDS(PSBORDN,"OIP")
"RTN","PSBOMT",78,0)
 .I $D(PSBTMP(X,950)) M PSBORDS(PSBORDN,"SOL")=PSBTMP(X,950) D
"RTN","PSBOMT",79,0)
 ..F XX=1:1:PSBORDS(PSBORDN,"SOL",0) S PSBORDS(PSBORDN,"OIP",$$OFROMS($P(PSBORDS(PSBORDN,"SOL",XX,0),U)))=""
"RTN","PSBOMT",80,0)
 ..M PSBOIP("OIP")=PSBORDS(PSBORDN,"OIP")
"RTN","PSBOMT",81,0)
 K PSBTMP
"RTN","PSBOMT",82,0)
 M TMP("PSBOIS",$J)=PSBOIP("OIP")
"RTN","PSBOMT",83,0)
 Q
"RTN","PSBOMT",84,0)
OFROMA(PSBADD) ;OITEM FROM AN ADDITIVE
"RTN","PSBOMT",85,0)
 S X1=$$GET1^DIQ(52.6,PSBADD_",",15,"I")
"RTN","PSBOMT",86,0)
 I PSBCLSS D
"RTN","PSBOMT",87,0)
 .S X2=$$GETDRN(X1)
"RTN","PSBOMT",88,0)
 .S PSBCLS="" K X3 F  Q:$D(X3)  S PSBCLS=$O(TMP("VA CLASS",$J,PSBCLS)) Q:+PSBCLS=0  D
"RTN","PSBOMT",89,0)
 ..I $D(TMP("VA CLASS",$J,PSBCLS,"DDRG",X2)) S X3=X1
"RTN","PSBOMT",90,0)
 .I '$D(X3) S X3=0
"RTN","PSBOMT",91,0)
 Q $G(X3,X1)
"RTN","PSBOMT",92,0)
OFROMS(PSBSOL) ;OITEM FROM A SOLUTION
"RTN","PSBOMT",93,0)
 S X1=$$GET1^DIQ(52.7,PSBSOL_",",9,"I")
"RTN","PSBOMT",94,0)
 I PSBCLSS D
"RTN","PSBOMT",95,0)
 .S X2=$$GETDRN(X1)
"RTN","PSBOMT",96,0)
 .S PSBCLS="" K X3 F  Q:$D(X3)  S PSBCLS=$O(TMP("VA CLASS",$J,PSBCLS)) Q:+PSBCLS=0  D
"RTN","PSBOMT",97,0)
 ..I $D(TMP("VA CLASS",$J,PSBCLS,"DDRG",X2)) S X3=X1
"RTN","PSBOMT",98,0)
 .I '$D(X3) S X3=0
"RTN","PSBOMT",99,0)
 Q $G(X3,X1)
"RTN","PSBOMT",100,0)
PREOUT ;
"RTN","PSBOMT",101,0)
 K PSBUNK S XDT="" F  S XDT=$O(TMP("PSBIENS",$J,XDT),-1) Q:XDT=""  S XIEN="",XIEN=$O(TMP("PSBIENS",$J,XDT,XIEN)) D
"RTN","PSBOMT",102,0)
 .Q:$$NONSTS(PSBXDFN,XIEN)
"RTN","PSBOMT",103,0)
 .S PSBIEN=XIEN
"RTN","PSBOMT",104,0)
 .S PSBIENS=PSBIEN_","
"RTN","PSBOMT",105,0)
 .D OUTPUT
"RTN","PSBOMT",106,0)
 Q
"RTN","PSBOMT",107,0)
OUTPUT ;
"RTN","PSBOMT",108,0)
 S PSBSPC=$J("",80)
"RTN","PSBOMT",109,0)
 S W=$E($$GET1^DIQ(53.79,PSBIENS,.02)_PSBSPC,1,20)_" "
"RTN","PSBOMT",110,0)
 S W=W_$S($P(^PSB(53.79,PSBIEN,0),U,9)="":"?? ",1:$E($P(^PSB(53.79,PSBIEN,0),U,9)_"  ",1,2)_" ")
"RTN","PSBOMT",111,0)
 S:$P(^PSB(53.79,PSBIEN,0),U,9)="" PSBUNK=1
"RTN","PSBOMT",112,0)
 S W=W_$E($P($G(^PSB(53.79,PSBIEN,.1)),U,2)_PSBSPC,1,2)_"  "
"RTN","PSBOMT",113,0)
 S W=W_$E($E($$GET1^DIQ(53.79,PSBIENS,.06),1,18)_PSBSPC,1,21)_" "
"RTN","PSBOMT",114,0)
 S W=W_$E($$GETINIT^PSBCSUTX(PSBIEN,"I")_PSBSPC,1,10)_" ",PSBLGD("INITIALS",$$GETINIT^PSBCSUTX(PSBIEN,"II"))="" ;Get IEN and initials of who took action, PSB*3*72
"RTN","PSBOMT",115,0)
 S W=W_$$GET1^DIQ(53.79,PSBIENS,.16)
"RTN","PSBOMT",116,0)
 D ADD(W)
"RTN","PSBOMT",117,0)
 K PSBV
"RTN","PSBOMT",118,0)
 F PSBNODE=.5,.6,.7 D
"RTN","PSBOMT",119,0)
 .S PSBDD=$S(PSBNODE=.5:53.795,PSBNODE=.6:53.796,1:53.797)
"RTN","PSBOMT",120,0)
 .F PSBY=0:0 S PSBY=$O(^PSB(53.79,PSBIEN,PSBNODE,PSBY)) Q:'PSBY  D
"RTN","PSBOMT",121,0)
 ..I $$GET1^DIQ(53.79,PSBIENS,.11)["V" S PSBV=1
"RTN","PSBOMT",122,0)
 ..D WRAPMEDS($$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.01),$$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.03),$$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.02),$$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.04))
"RTN","PSBOMT",123,0)
 D PRNEFF
"RTN","PSBOMT",124,0)
 I PSBCFLG=1 D COMNTS
"RTN","PSBOMT",125,0)
 D ADD("")
"RTN","PSBOMT",126,0)
 Q
"RTN","PSBOMT",127,0)
PRNEFF ;Add PRN Effectiveness to Medication theropy Report  - PSB*3*50
"RTN","PSBOMT",128,0)
 N PSBPRN,PSBEIECMT,PSBLINE1,PSBLINE2
"RTN","PSBOMT",129,0)
 S PSBEIECMT=""
"RTN","PSBOMT",130,0)
 I $P($G(PSBRPT(.2)),U,8)=0,$D(^PSB(53.79,PSBIEN,.2)) S PSBEIECMT=$$PRNEFF^PSBO(PSBEIECMT,PSBIEN)
"RTN","PSBOMT",131,0)
 I $D(^PSB(53.79,PSBIEN,.2)) D
"RTN","PSBOMT",132,0)
 .D ADD("")
"RTN","PSBOMT",133,0)
 .D ADD($J("",35)_"PRN Effectiveness: "_$$MAKELINE^PSBOMT1("-",78))
"RTN","PSBOMT",134,0)
 .I $P(^PSB(53.79,PSBIEN,.2),U,2)'="" D
"RTN","PSBOMT",135,0)
 ..S PSBPRN=$P(^PSB(53.79,PSBIEN,.2),U,2)
"RTN","PSBOMT",136,0)
 .I $P(^PSB(53.79,PSBIEN,.2),U,2)="" S PSBPRN="<No PRN Effectiveness Entered>"
"RTN","PSBOMT",137,0)
 .S PSBLINE1=$E(PSBPRN_PSBEIECMT,1,75),PSBLINE2=$E(PSBPRN_PSBEIECMT,76,245) D WRAP(PSBLINE2,PSBLINE1,PSBIEN)
"RTN","PSBOMT",138,0)
 Q 
"RTN","PSBOMT",139,0)
COMNTS ;
"RTN","PSBOMT",140,0)
 N Z,CNT
"RTN","PSBOMT",141,0)
 S Z="",CNT=0
"RTN","PSBOMT",142,0)
 I $D(^PSB(53.79,PSBIEN,.3,0)) D
"RTN","PSBOMT",143,0)
 .D ADD("")
"RTN","PSBOMT",144,0)
 .D ADD($J("",44)_"Comments: "_$$MAKELINE^PSBOMT1("-",78))
"RTN","PSBOMT",145,0)
 .S XT="" F  S XT=$O(^PSB(53.79,PSBIEN,.3,XT)) Q:XT=""  I XT'=0  D
"RTN","PSBOMT",146,0)
 ..D:CNT=1 ADD("")
"RTN","PSBOMT",147,0)
 ..S Y=$P(^PSB(53.79,PSBIEN,.3,XT,0),"^",3) D DD^%DT S XBR=Y
"RTN","PSBOMT",148,0)
 ..S Z=XBR_"   "_$P(^VA(200,$P(^PSB(53.79,PSBIEN,.3,XT,0),"^",2),0),"^",2)
"RTN","PSBOMT",149,0)
 ..D WRAP($P(^PSB(53.79,PSBIEN,.3,XT,0),"^",1),Z,PSBIEN)
"RTN","PSBOMT",150,0)
 ..S CNT=1
"RTN","PSBOMT",151,0)
 ..S PSBLGD("INITIALS",$$GET1^DIQ(53.793,XT_","_PSBIEN_",",.02,"I"))="" ;Get name for legend for those who entered comments
"RTN","PSBOMT",152,0)
 .D ADD($J("",54)_$$MAKELINE^PSBOMT1("-",78))
"RTN","PSBOMT",153,0)
 Q
"RTN","PSBOMT",154,0)
WRAPMEDS(MED,UG,UO,UOA) ;
"RTN","PSBOMT",155,0)
 ;THIS WILL CREATE UPTO 3 LINES
"RTN","PSBOMT",156,0)
 S MED=$E(MED_$J("",40),1,40)
"RTN","PSBOMT",157,0)
 N UGWRAP,ORWRAP
"RTN","PSBOMT",158,0)
 S (CNTX,UOA1,UOA16,UOA31)=""
"RTN","PSBOMT",159,0)
 I +$G(UG)?1"."1.N S UG=0_+UG
"RTN","PSBOMT",160,0)
 I +$G(UO)?1"."1.N S UO=0_+UO
"RTN","PSBOMT",161,0)
 I $G(PSBV,0) S UO="NA"
"RTN","PSBOMT",162,0)
 F CNT=1:15:45  D
"RTN","PSBOMT",163,0)
 .D PARSE^PSBOMT1(UOA,CNT)
"RTN","PSBOMT",164,0)
 .S UGWRAP=$E(UG,CNT,(CNT+7)),UOWRAP=$E(UO,CNT,(CNT+7))
"RTN","PSBOMT",165,0)
 .I CNT=1 D ADD($J("",55)_MED_" "_$$PAD^PSBOMT1(UOWRAP,8)_" "_$$PAD^PSBOMT1(UGWRAP,8)_"  "_$$PAD^PSBOMT1(UOA1,15))
"RTN","PSBOMT",166,0)
 .I (CNT>1),($L(UGWRAP)>0!$L(@("UOA"_CNT))>0) D ADD($J("",94)_$$PAD^PSBOMT1(UOWRAP,8)_" "_$$PAD^PSBOMT1(UGWRAP,8)_"  "_$$PAD^PSBOMT1(@("UOA"_CNT),15))
"RTN","PSBOMT",167,0)
 Q
"RTN","PSBOMT",168,0)
HEADA ;
"RTN","PSBOMT",169,0)
 W !
"RTN","PSBOMT",170,0)
 W "Location",?21,"St Sch Administration Date",?50,"By",?61,"Injection Site",?96,"Units",?104,"Units",?113,"Units of"
"RTN","PSBOMT",171,0)
 W !,?55,"Medication & Dosage",?96,"Ordered",?104,"Given",?113,"Administration"
"RTN","PSBOMT",172,0)
 W !
"RTN","PSBOMT",173,0)
 W $$MAKELINE^PSBOMT1("-",132)
"RTN","PSBOMT",174,0)
 Q
"RTN","PSBOMT",175,0)
NONSTS(PSBX,PSBY) ;
"RTN","PSBOMT",176,0)
 D CLEAN^PSBVT,PSJ1^PSBVT(PSBX,$$GET1^DIQ(53.79,PSBY_",","ORDER REFERENCE NUMBER","I"))
"RTN","PSBOMT",177,0)
 Q PSBOCRIT'[PSBSCHT_"^"
"RTN","PSBOMT",178,0)
WRITEOT ;
"RTN","PSBOMT",179,0)
 D HDR^PSBOMT1
"RTN","PSBOMT",180,0)
 D MEDS
"RTN","PSBOMT",181,0)
 N PSBCLINORD S PSBCLINORD=2             ;2 = both order types   *70
"RTN","PSBOMT",182,0)
 D PT^PSBOHDR(PSBXDFN,.PSBHDR),HEADA
"RTN","PSBOMT",183,0)
 I '$D(TMP("PSBIENS",$J)) D ADD("<<<< NO HISTORY FOUND FOR THIS TIME FRAME >>>>")
"RTN","PSBOMT",184,0)
 S EX="" F  S EX=$O(^TMP("PSB",$J,EX)) Q:EX=""  D
"RTN","PSBOMT",185,0)
 .I $Y>(IOSL-5) D
"RTN","PSBOMT",186,0)
 ..W $$PTFTR^PSBOHDR()
"RTN","PSBOMT",187,0)
 ..D PT^PSBOHDR(PSBXDFN,.PSBHDR),HEADA
"RTN","PSBOMT",188,0)
 .W !,$G(^TMP("PSB",$J,EX))
"RTN","PSBOMT",189,0)
 D:$D(TMP("PSBIENS",$J)) LEGEND^PSBOMT1
"RTN","PSBOMT",190,0)
 D FTR^PSBOMT1
"RTN","PSBOMT",191,0)
 Q
"RTN","PSBOMT",192,0)
MEDS ;
"RTN","PSBOMT",193,0)
 N MED,XA,XB
"RTN","PSBOMT",194,0)
 S MED="",XB=$O(PSBHDR(""),-1)+1
"RTN","PSBOMT",195,0)
 S PSBHDR(XB)=PSBSRCHL
"RTN","PSBOMT",196,0)
 I PSBCLSS S XA=0 K PSBGOT F  S XA=$O(TMP("VA CLASS",$J,XA)) Q:+XA=0  D
"RTN","PSBOMT",197,0)
 .K ^TMP($J,"PSBLIST") D IEN^PSN50P65(XA,"??","PSBLIST")
"RTN","PSBOMT",198,0)
 .I ^TMP($J,"PSBLIST",0)>0 S MED=^TMP($J,"PSBLIST",XA,1) Q:$D(PSBGOT(MED))  K ^TMP($J,"PSBLIST")
"RTN","PSBOMT",199,0)
 .I $L(PSBHDR(XB)_" "_$G(MED," * NO DATA FOUND * "))+3>IOM D  Q
"RTN","PSBOMT",200,0)
 ..S XB=XB+1,PSBHDR(XB)="                         / "_MED S PSBGOT(MED)=""
"RTN","PSBOMT",201,0)
 .S PSBHDR(XB)=PSBHDR(XB)_$S(($L(PSBHDR(XB),":")=2)&($P(PSBHDR(XB),":",2)=""):" ",1:" / ")_MED,PSBGOT(MED)=""
"RTN","PSBOMT",202,0)
 I $D(PSBOIL) S XA="" K PSBGOT F  S XA=$O(PSBOIL(XA)) Q:XA=""  D
"RTN","PSBOMT",203,0)
 .S MED=$$GET1^DIQ(50.7,XA,.01) Q:$D(PSBGOT(MED))  S PSBGOT(MED)=""
"RTN","PSBOMT",204,0)
 .I $L(PSBHDR(XB)_" / "_MED)+3>IOM D  Q
"RTN","PSBOMT",205,0)
 ..S XB=XB+1,PSBHDR(XB)="                         / "_MED
"RTN","PSBOMT",206,0)
 .S PSBHDR(XB)=PSBHDR(XB)_$S(($L(PSBHDR(XB),":")=2)&($P(PSBHDR(XB),":",2)=""):" ",1:" / ")_MED
"RTN","PSBOMT",207,0)
 I $D(PSBADDL) S XA="" K PSBGOT F  S XA=$O(PSBADDL(XA)) Q:XA=""  D
"RTN","PSBOMT",208,0)
 .S MED=$$GET1^DIQ(52.6,XA,.01) Q:$D(PSBGOT(MED))  S PSBGOT(MED)=""
"RTN","PSBOMT",209,0)
 .I $L(PSBHDR(XB)_" / "_MED)+3>IOM D  Q
"RTN","PSBOMT",210,0)
 ..S XB=XB+1,PSBHDR(XB)="                         / "_MED
"RTN","PSBOMT",211,0)
 .S PSBHDR(XB)=PSBHDR(XB)_$S(($L(PSBHDR(XB),":")=2)&($P(PSBHDR(XB),":",2)=""):" ",1:" / ")_MED
"RTN","PSBOMT",212,0)
 I $D(PSBSOLL) S XA="" K PSBGOT F  S XA=$O(PSBSOLL(XA)) Q:XA=""  D
"RTN","PSBOMT",213,0)
 .S MED=$$GET1^DIQ(52.7,XA,.01) Q:$D(PSBGOT(MED))  S PSBGOT(MED)=""
"RTN","PSBOMT",214,0)
 .I $L(PSBHDR(XB)_" / "_MED)+3>IOM D  Q
"RTN","PSBOMT",215,0)
 ..S XB=XB+1,PSBHDR(XB)="                         / "_MED
"RTN","PSBOMT",216,0)
 .S PSBHDR(XB)=PSBHDR(XB)_$S(($L(PSBHDR(XB),":")=2)&($P(PSBHDR(XB),":",2)=""):" ",1:" / ")_MED
"RTN","PSBOMT",217,0)
 I $D(PSBDDL) S XA="" F  S XA=$O(PSBDDL(XA)) Q:XA=""  D
"RTN","PSBOMT",218,0)
 .S MED=$$GET1^DIQ(50,XA,.01)
"RTN","PSBOMT",219,0)
 .I $L(PSBHDR(XB)_" / "_MED)+3>IOM D  Q
"RTN","PSBOMT",220,0)
 ..S XB=XB+1,PSBHDR(XB)="                         / "_MED
"RTN","PSBOMT",221,0)
 .S PSBHDR(XB)=PSBHDR(XB)_$S(($L(PSBHDR(XB),":")=2)&($P(PSBHDR(XB),":",2)=""):" ",1:" / ")_MED
"RTN","PSBOMT",222,0)
 Q
"RTN","PSBOMT",223,0)
WRAP(SIZE,ZP,BRIEN) ;
"RTN","PSBOMT",224,0)
 D ADD($J("",55)_ZP)
"RTN","PSBOMT",225,0)
 D ADD($J("",55)_$E(SIZE,1,75))
"RTN","PSBOMT",226,0)
 I $L(SIZE)>75 D ADD($J("",55)_$E(SIZE,76,150))
"RTN","PSBOMT",227,0)
 Q
"RTN","PSBOMT",228,0)
ADD(XE) ;
"RTN","PSBOMT",229,0)
 S ^TMP("PSB",$J,$O(^TMP("PSB",$J,""),-1)+1)=XE
"RTN","PSBOMT",230,0)
 Q
"RTN","PSBOMT",231,0)
GETDRN(IEN1) ;
"RTN","PSBOMT",232,0)
 ; Get the Drug IEN (p50) via OI IEN (p50.7)
"RTN","PSBOMT",233,0)
 K ^TMP($J,"PSBLIST")
"RTN","PSBOMT",234,0)
 D DRGIEN^PSS50P7(IEN1,,"PSBLIST")
"RTN","PSBOMT",235,0)
 S DN=$O(^TMP($J,"PSBLIST",0))
"RTN","PSBOMT",236,0)
 K ^TMP($J,"PSBLIST")
"RTN","PSBOMT",237,0)
 Q DN
"RTN","PSBOMT",238,0)
GETCLSS(IEN1) ;
"RTN","PSBOMT",239,0)
 ; Get the Items w/i VA Class
"RTN","PSBOMT",240,0)
 K ^TMP($J,"PSBLIST")
"RTN","PSBOMT",241,0)
 D VAC^PSS50(IEN1,,,"PSBLIST")
"RTN","PSBOMT",242,0)
 M PSBDDRG=^TMP($J,"PSBLIST")
"RTN","PSBOMT",243,0)
 K ^TMP($J,"PSBLIST")
"RTN","PSBOMT",244,0)
 Q
"RTN","PSBOMV")
0^10^B55477289^B51967870
"RTN","PSBOMV",1,0)
PSBOMV ;BIRMINGHAM/EFC-BCMA UNIT DOSE VIRTUAL DUE LIST FUNCTIONS ;Mar 2004
"RTN","PSBOMV",2,0)
 ;;3.0;BAR CODE MED ADMIN;**60,78,72**;Mar 2004;Build 16
"RTN","PSBOMV",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBOMV",4,0)
 ;
"RTN","PSBOMV",5,0)
 ; Reference/IA
"RTN","PSBOMV",6,0)
 ; ^DPT/10035
"RTN","PSBOMV",7,0)
 ; ^NURSF(211.4/1409
"RTN","PSBOMV",8,0)
 ; ^XLFDT/10103
"RTN","PSBOMV",9,0)
 ;
"RTN","PSBOMV",10,0)
EN ;
"RTN","PSBOMV",11,0)
 N CNT,PSBHDR,PSBPT,PSBINDX,DFN,PSBY,PSBSORT,PSBPRINT,PSBDT,PSBEV,PSBLOG,PSBPRCX,PSBRB,PSBSTOP,PSBSTRT,PSBTIME,PSBWLF,PSBWRD,PSBWRDA,PSBX,PSBY,PSBXX
"RTN","PSBOMV",12,0)
 ;
"RTN","PSBOMV",13,0)
 K ^TMP("PSBO",$J)
"RTN","PSBOMV",14,0)
 S PSBSTRT=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,7)
"RTN","PSBOMV",15,0)
 S PSBSTOP=$P(PSBRPT(.1),U,8)+$P(PSBRPT(.1),U,9)
"RTN","PSBOMV",16,0)
 S CNT=0,PSBPRINT=$P($G(PSBRPT(.1)),U)
"RTN","PSBOMV",17,0)
 I PSBPRINT="P" S PSBPT=$P(PSBRPT(.1),U,2)
"RTN","PSBOMV",18,0)
 I PSBPRINT="W" S PSBSORT=$P($G(PSBRPT(.1)),U,5),PSBWRD=$P(PSBRPT(.1),U,3) Q:'PSBWRD  D WARD^NURSUT5("L^"_PSBWRD,.PSBWRDA)
"RTN","PSBOMV",19,0)
 ;
"RTN","PSBOMV",20,0)
RANGE ;Locate data between date range.
"RTN","PSBOMV",21,0)
 N PSBTMDF
"RTN","PSBOMV",22,0)
 S PSBX=PSBSTRT F  S PSBX=$O(^PSB(53.78,"ADT",PSBX)) Q:'PSBX!(PSBX>PSBSTOP)  D
"RTN","PSBOMV",23,0)
 .F PSBY=0:0 S PSBY=$O(^PSB(53.78,"ADT",PSBX,PSBY)) Q:'PSBY  D
"RTN","PSBOMV",24,0)
 ..S DFN=+^PSB(53.78,PSBY,0),PSBWLF=$P($G(^(0)),U,9),PSBTIME=$P($G(^(0)),U,4),PSBLOG=$P($G(^(0)),U,8)
"RTN","PSBOMV",25,0)
CHECK ..;Ward IEN must exist in Ward Field # 9.
"RTN","PSBOMV",26,0)
 ..Q:'$G(PSBWLF)
"RTN","PSBOMV",27,0)
 ..Q:'$G(PSBLOG)
"RTN","PSBOMV",28,0)
 ..;PSB*3*60 adds code to allow a variance equal to system variable DILOCKTM when checking for removal of a patch
"RTN","PSBOMV",29,0)
 ..S PSBTMDF=$$FMDIFF^XLFDT($P($G(^PSB(53.79,PSBLOG,0)),U,6),$G(PSBTIME),2) ;PSB*3*60
"RTN","PSBOMV",30,0)
 ..I PSBTMDF>=-($S($G(DILOCKTM)>0:DILOCKTM,1:3)),PSBTMDF<=$S($G(DILOCKTM)>0:DILOCKTM,1:3),$P($G(^PSB(53.79,PSBLOG,0)),U,9)="RM" Q  ;PSB*3*60
"RTN","PSBOMV",31,0)
 ..;Quit if Ward IEN is not in Nurse Location file.
"RTN","PSBOMV",32,0)
 ..I PSBPRINT="W",'$O(^NURSF(211.4,"C",PSBWLF,PSBWRD,0)) Q
"RTN","PSBOMV",33,0)
 ..;Compare date/time and Quit if order status set to Remove.
"RTN","PSBOMV",34,0)
 ..;
"RTN","PSBOMV",35,0)
BUILD ..I $G(PSBSORT)'="B" S ^TMP("PSBO",$J,DFN,PSBX,PSBY)=""
"RTN","PSBOMV",36,0)
 ..I PSBPRINT="P",DFN=PSBPT S ^TMP("PSBO",$J,"B",$P(^DPT(DFN,0),U),DFN)="" Q
"RTN","PSBOMV",37,0)
 ..S ^TMP("PSBO",$J,DFN,0)=^DPT(DFN,0)
"RTN","PSBOMV",38,0)
 ..I PSBPRINT="W" D SORTING
"RTN","PSBOMV",39,0)
 ;
"RTN","PSBOMV",40,0)
BYWDPT ;Print by Ward and Sort by Patient.
"RTN","PSBOMV",41,0)
 I $G(PSBPRINT)="W",$G(PSBSORT)'="B" D
"RTN","PSBOMV",42,0)
 .;Print report by the selected ward name.
"RTN","PSBOMV",43,0)
 .W $$WRDHDR()
"RTN","PSBOMV",44,0)
 .S PSBINDX=""
"RTN","PSBOMV",45,0)
 .F  S PSBINDX=$O(^TMP("PSBO",$J,"B",PSBINDX)) Q:PSBINDX=""  D
"RTN","PSBOMV",46,0)
 ..F DFN=0:0 S DFN=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN)) Q:'DFN  D
"RTN","PSBOMV",47,0)
 ...W:$Y>(IOSL-10) $$WRDHDR()
"RTN","PSBOMV",48,0)
 ...F PSBDT=0:0 S PSBDT=$O(^TMP("PSBO",$J,DFN,PSBDT)) Q:'PSBDT  D
"RTN","PSBOMV",49,0)
 ....F PSBY=0:0 S PSBY=$O(^TMP("PSBO",$J,DFN,PSBDT,PSBY)) Q:'PSBY  D
"RTN","PSBOMV",50,0)
 .....D EVENTS  ;Set Total Number of Events
"RTN","PSBOMV",51,0)
 .....S PSBRB=$$GET1^DIQ(53.78,PSBY_",",.02)
"RTN","PSBOMV",52,0)
 .....W !,PSBRB
"RTN","PSBOMV",53,0)
 .....W ?20,$P(^TMP("PSBO",$J,DFN,0),U,1)
"RTN","PSBOMV",54,0)
 .....W ?48,$$GET1^DIQ(53.78,PSBY_",",.04)
"RTN","PSBOMV",55,0)
 .....W ?75,$$GET1^DIQ(53.78,PSBY_",",.05)
"RTN","PSBOMV",56,0)
 .....W ?95,$$GET1^DIQ(53.78,PSBY_",",.06)
"RTN","PSBOMV",57,0)
 .....W ?102,$$GET1^DIQ(53.78,PSBY_",",.07)
"RTN","PSBOMV",58,0)
 .....W ?102,$$GET1^DIQ(53.78,PSBY_",","MED LOG PTR:ADMINISTRATION MEDICATION")
"RTN","PSBOMV",59,0)
 .....D VCOM ;Print Ward and Comments from Med Log.
"RTN","PSBOMV",60,0)
 .....W !?52
"RTN","PSBOMV",61,0)
 .W !!  D EVEPRNT
"RTN","PSBOMV",62,0)
 ;
"RTN","PSBOMV",63,0)
BYWDRB ;Print by Ward and Sort by Room and Bed.
"RTN","PSBOMV",64,0)
 I $G(PSBPRINT)="W",$G(PSBSORT)="B" D
"RTN","PSBOMV",65,0)
 .;Print report by the selected ward name.
"RTN","PSBOMV",66,0)
 .W $$WRDHDR()
"RTN","PSBOMV",67,0)
 .S PSBINDX=""
"RTN","PSBOMV",68,0)
 .F  S PSBINDX=$O(^TMP("PSBO",$J,"B",PSBINDX)) Q:PSBINDX=""  D
"RTN","PSBOMV",69,0)
 ..F DFN=0:0 S DFN=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN)) Q:'DFN  D
"RTN","PSBOMV",70,0)
 ...W:$Y>(IOSL-10) $$WRDHDR()
"RTN","PSBOMV",71,0)
 ...F PSBDT=0:0 S PSBDT=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN,PSBDT)) Q:'PSBDT  D
"RTN","PSBOMV",72,0)
 ....F PSBY=0:0 S PSBY=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN,PSBDT,PSBY)) Q:'PSBY  D
"RTN","PSBOMV",73,0)
 .....D EVENTS  ;Set Total Number of Events
"RTN","PSBOMV",74,0)
 .....S PSBRB=$$GET1^DIQ(53.78,PSBY_",",.02)
"RTN","PSBOMV",75,0)
 .....W !,PSBRB
"RTN","PSBOMV",76,0)
 .....W ?20,$P(^TMP("PSBO",$J,DFN,0),U,1)
"RTN","PSBOMV",77,0)
 .....W ?48,$$GET1^DIQ(53.78,PSBY_",",.04)
"RTN","PSBOMV",78,0)
 .....W ?75,$$GET1^DIQ(53.78,PSBY_",",.05)
"RTN","PSBOMV",79,0)
 .....W ?95,$$GET1^DIQ(53.78,PSBY_",",.06)
"RTN","PSBOMV",80,0)
 .....W ?102,$$GET1^DIQ(53.78,PSBY_",",.07)
"RTN","PSBOMV",81,0)
 .....W ?102,$$GET1^DIQ(53.78,PSBY_",","MED LOG PTR:ADMINISTRATION MEDICATION")
"RTN","PSBOMV",82,0)
 .....D VCOM ;Print Ward and Comments from Med Log.
"RTN","PSBOMV",83,0)
 .....W !?52
"RTN","PSBOMV",84,0)
 .W !!  D EVEPRNT
"RTN","PSBOMV",85,0)
 ;
"RTN","PSBOMV",86,0)
BYDFN ;Print by Patient.
"RTN","PSBOMV",87,0)
 D:$G(PSBPRINT)="P"
"RTN","PSBOMV",88,0)
 .W $$PTHDR()
"RTN","PSBOMV",89,0)
 .S PSBINDX=""
"RTN","PSBOMV",90,0)
 .F  S PSBINDX=$O(^TMP("PSBO",$J,"B",PSBINDX)) Q:PSBINDX=""  D
"RTN","PSBOMV",91,0)
 ..F DFN=0:0 S DFN=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN)) Q:'DFN  D
"RTN","PSBOMV",92,0)
 ...W:$Y>(IOSL-10) $$PTHDR()
"RTN","PSBOMV",93,0)
 ...F PSBDT=0:0 S PSBDT=$O(^TMP("PSBO",$J,DFN,PSBDT)) Q:'PSBDT  D
"RTN","PSBOMV",94,0)
 ....F PSBY=0:0 S PSBY=$O(^TMP("PSBO",$J,DFN,PSBDT,PSBY)) Q:'PSBY  D
"RTN","PSBOMV",95,0)
 .....D EVENTS  ;Set Total Number of Events
"RTN","PSBOMV",96,0)
 .....W !,$$GET1^DIQ(53.78,PSBY_",",.04)
"RTN","PSBOMV",97,0)
 .....W ?23,$$GET1^DIQ(53.78,PSBY_",",.05)
"RTN","PSBOMV",98,0)
 .....W ?43,$$GET1^DIQ(53.78,PSBY_",",.06)
"RTN","PSBOMV",99,0)
 .....W ?50,$$GET1^DIQ(53.78,PSBY_",",.07)
"RTN","PSBOMV",100,0)
 .....W ?50,$$GET1^DIQ(53.78,PSBY_",","MED LOG PTR:ADMINISTRATION MEDICATION")
"RTN","PSBOMV",101,0)
 .....D VCOM ;Print Ward and Comments from Med Log.
"RTN","PSBOMV",102,0)
 .W !!  D EVEPRNT
"RTN","PSBOMV",103,0)
 .W $$PTFTR^PSBOHDR()
"RTN","PSBOMV",104,0)
 Q
"RTN","PSBOMV",105,0)
 ;
"RTN","PSBOMV",106,0)
WRDHDR() ;
"RTN","PSBOMV",107,0)
 N PSBSRCHL ;Add PSBSRCHL variable and additional PSBHDR array spacers for PSBOHDR call, PSB*3*78
"RTN","PSBOMV",108,0)
 S PSBHDR(1)="MEDICATION VARIANCE LOG for "_$$FMTE^XLFDT(PSBSTRT)_" to "_$$FMTE^XLFDT(PSBSTOP) ;Add time frame for report header, PSB*3*72
"RTN","PSBOMV",109,0)
 S PSBSRCHL=$$SRCHLIST^PSBOHDR()
"RTN","PSBOMV",110,0)
 S PSBHDR(2)="",PSBHDR(3)="",PSBHDR(4)="Ward Location: "
"RTN","PSBOMV",111,0)
 D WARD^PSBOHDR(PSBWRD,.PSBHDR,,,PSBSRCHL)
"RTN","PSBOMV",112,0)
 W !,"Rm-Bed",?20,"Patient Name",?48,"Event Date/Time",?75,"Event",?95,"Var",?102,"Medication",!,$TR($J("",IOM)," ","-")
"RTN","PSBOMV",113,0)
 Q ""
"RTN","PSBOMV",114,0)
 ;
"RTN","PSBOMV",115,0)
PTHDR() ;
"RTN","PSBOMV",116,0)
 S PSBHDR(1)="MEDICATION VARIANCE LOG for "_$$FMTE^XLFDT(PSBSTRT)_" to "_$$FMTE^XLFDT(PSBSTOP) ;Add time frame for report header, PSB*3*72
"RTN","PSBOMV",117,0)
 D PT^PSBOHDR(PSBDFN,.PSBHDR)
"RTN","PSBOMV",118,0)
 W !,"Event Date/Time",?23,"Event",?43,"Var",?50,"Medication",!,$TR($J("",IOM)," ","-")
"RTN","PSBOMV",119,0)
 Q ""
"RTN","PSBOMV",120,0)
 ;
"RTN","PSBOMV",121,0)
VCOM ;Print Ward and Comments from Med Log on Variance Report.
"RTN","PSBOMV",122,0)
 N PSBCOM,PSBML,Y
"RTN","PSBOMV",123,0)
 Q:'$P($G(^PSB(53.78,PSBY,0)),"^",8)  S PSBML=$P(^(0),"^",8)
"RTN","PSBOMV",124,0)
 I $P(PSBRPT(.1),U)="P" W !,?23,"Ward:      ",?34 D
"RTN","PSBOMV",125,0)
 .I $P($G(^PSB(53.79,PSBML,0)),U,2)=""  W "<No Ward>" Q
"RTN","PSBOMV",126,0)
 .W $P($G(^PSB(53.79,PSBML,0)),U,2)
"RTN","PSBOMV",127,0)
 W !,?23,"Comments:  ",?34 I '$O(^PSB(53.79,PSBML,.3,0))  W "<No Comments>" I $Y>(IOSL-10) D  Q  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",128,0)
 .I $G(PSBPRINT)="P" W $$PTFTR^PSBOHDR(),!,$$PTHDR()  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",129,0)
 .I $G(PSBPRINT)="W" W !,$$WRDHDR()  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",130,0)
 F PSBCOM=0:0 S PSBCOM=$O(^PSB(53.79,PSBML,.3,PSBCOM)) Q:'PSBCOM  D
"RTN","PSBOMV",131,0)
 .W:$X>34 !?34
"RTN","PSBOMV",132,0)
 .S Y=$P(^PSB(53.79,PSBML,.3,PSBCOM,0),U,3)+.0000001
"RTN","PSBOMV",133,0)
 .W $E(Y,4,5),"/",$E(Y,6,7),"/",$E(Y,2,3)," ",$E(Y,9,10),":",$E(Y,11,12),?50,"By: ",$$GET1^DIQ(53.793,PSBCOM_","_PSBML_",","ENTERED BY:INITIAL"),$$WRAP^PSBO(60,75,$P(^PSB(53.79,PSBML,.3,PSBCOM,0),U,1))
"RTN","PSBOMV",134,0)
 .I $Y>(IOSL-10) D  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",135,0)
 ..I $G(PSBPRINT)="P" W $$PTFTR^PSBOHDR(),!,$$PTHDR()  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",136,0)
 ..I $G(PSBPRINT)="W" W !,$$WRDHDR()  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",137,0)
 Q
"RTN","PSBOMV",138,0)
 ;
"RTN","PSBOMV",139,0)
EVENTS ;Record total number of events.
"RTN","PSBOMV",140,0)
 S PSBEV=$P($G(^PSB(53.78,PSBY,0)),U,5) Q:'$G(PSBEV)
"RTN","PSBOMV",141,0)
 S ^TMP("PSBO",$J,"EVENTS",PSBEV,0)=$P($G(^TMP("PSBO",$J,"EVENTS",PSBEV,0)),U)+1
"RTN","PSBOMV",142,0)
 S CNT=CNT+1,^TMP("PSBO",$J,"EVENTSTOT",0)=CNT
"RTN","PSBOMV",143,0)
 Q
"RTN","PSBOMV",144,0)
EVEPRNT ;Display Total and Percentage of Events.
"RTN","PSBOMV",145,0)
 ;
"RTN","PSBOMV",146,0)
 Q:'$D(^TMP("PSBO",$J,"EVENTSTOT"))  ;Quit if there are no events
"RTN","PSBOMV",147,0)
 W !,"Total Number of Events for the reporting period is: "_$P(^TMP("PSBO",$J,"EVENTSTOT",0),U)_".",!
"RTN","PSBOMV",148,0)
 F PSBXX=0:0 S PSBXX=$O(^TMP("PSBO",$J,"EVENTS",PSBXX)) Q:'PSBXX  D
"RTN","PSBOMV",149,0)
 .W !,"Total number of "_$$EXTERNAL^DILFD(53.78,.05,"",PSBXX)_" events is "_$P($G(^TMP("PSBO",$J,"EVENTS",PSBXX,0)),U)_"."
"RTN","PSBOMV",150,0)
 .S PSBPRCX=$E($FN($P(^TMP("PSBO",$J,"EVENTS",PSBXX,0),U)/$P(^TMP("PSBO",$J,"EVENTSTOT",0),U),"",2),3,4)
"RTN","PSBOMV",151,0)
 .W !,"Percentage of Total Events: "_$S(PSBPRCX="00":"100",1:PSBPRCX)_"%",!
"RTN","PSBOMV",152,0)
 Q
"RTN","PSBOMV",153,0)
 ;
"RTN","PSBOMV",154,0)
SORTING ;Sort by Patient or Room and Bed Information
"RTN","PSBOMV",155,0)
 ;
"RTN","PSBOMV",156,0)
 I $G(PSBSORT)="P"!($G(PSBSORT)="") S PSBINDX=$P(^DPT(DFN,0),U),^TMP("PSBO",$J,"B",PSBINDX,DFN)="" Q
"RTN","PSBOMV",157,0)
 I $G(PSBSORT)="B" S PSBINDX=$P($G(^PSB(53.78,+PSBY,0)),U,2) S:PSBINDX="" PSBINDX="** NO ROOM/BED **" S ^TMP("PSBO",$J,"B",PSBINDX,DFN,PSBX,PSBY)=""
"RTN","PSBOMV",158,0)
 Q 
"RTN","PSBOPE")
0^5^B23332859^B22369471
"RTN","PSBOPE",1,0)
PSBOPE ;BIRMINGHAM/EFC-PRN EFFECTIVENESS WORKSHEET ;8/12/12 10:57pm
"RTN","PSBOPE",2,0)
 ;;3.0;BAR CODE MED ADMIN;**5,23,32,70,78,72**;Mar 2004;Build 16
"RTN","PSBOPE",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBOPE",4,0)
 ;
"RTN","PSBOPE",5,0)
 ; Reference/IA
"RTN","PSBOPE",6,0)
 ; ^DPT/10035
"RTN","PSBOPE",7,0)
 ; EN^PSJBCMA/2828
"RTN","PSBOPE",8,0)
 ;
"RTN","PSBOPE",9,0)
 ;*70 - reset PSBCLINORD = 2 to signify combined orders report
"RTN","PSBOPE",10,0)
 ;
"RTN","PSBOPE",11,0)
EN ; Called from DQ^PSBO
"RTN","PSBOPE",12,0)
 N PSBSTRT,PSBSTOP,DFN
"RTN","PSBOPE",13,0)
 K ^TMP("PSB",$J)
"RTN","PSBOPE",14,0)
 S PSBSTRT=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,7)
"RTN","PSBOPE",15,0)
 S PSBSTOP=$P(PSBRPT(.1),U,8)+$P(PSBRPT(.1),U,9)
"RTN","PSBOPE",16,0)
 F DFN=0:0 S DFN=$O(^TMP("PSBO",$J,DFN)) Q:'DFN  D EN1
"RTN","PSBOPE",17,0)
 D PRINT
"RTN","PSBOPE",18,0)
 K ^TMP("PSJ",$J),^TMP("PSB",$J)
"RTN","PSBOPE",19,0)
 Q
"RTN","PSBOPE",20,0)
 ;
"RTN","PSBOPE",21,0)
EN1 ; Expects DFN,PSBSTRT,PSBSTOP from EN
"RTN","PSBOPE",22,0)
 N PSBGBL,PSBHDR,PSBX,PSBADMIN,PSBDFN,PSBDT,PSBMED,PSBORD,PSBOSTRT,PSBSCHED
"RTN","PSBOPE",23,0)
 K ^TMP("PSJ",$J)
"RTN","PSBOPE",24,0)
 S PSBDT=PSBSTRT-.0000001
"RTN","PSBOPE",25,0)
 F  S PSBDT=$O(^PSB(53.79,"AADT",DFN,PSBDT)) Q:'PSBDT!(PSBDT>PSBSTOP)  D
"RTN","PSBOPE",26,0)
 .S PSBIEN=0
"RTN","PSBOPE",27,0)
 .F  S PSBIEN=$O(^PSB(53.79,"AADT",DFN,PSBDT,PSBIEN)) Q:'PSBIEN  D
"RTN","PSBOPE",28,0)
 ..Q:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)'="P"  ; Not a PRN Administration
"RTN","PSBOPE",29,0)
 ..Q:$P($G(^PSB(53.79,PSBIEN,.2)),U,2)]""  ; Effectiveness entered
"RTN","PSBOPE",30,0)
 ..Q:($P($G(^PSB(53.79,PSBIEN,0)),U,9)'="G")&($P($G(^PSB(53.79,PSBIEN,0)),U,9)'="RM")  ;Allow only entries with at status of "GIVEN" and "REMOVED"
"RTN","PSBOPE",31,0)
 ..Q:$P($G(^PSB(53.79,PSBIEN,0)),U,6)<PSBDT
"RTN","PSBOPE",32,0)
 ..Q:$P($G(^PSB(53.79,PSBIEN,0)),U,6)>PSBSTOP
"RTN","PSBOPE",33,0)
 ..S ^TMP("PSB",$J,DFN,PSBIEN)=""
"RTN","PSBOPE",34,0)
 Q
"RTN","PSBOPE",35,0)
PRINT ; Print meds stored in ^TMP("PSB",$J,DFN,....
"RTN","PSBOPE",36,0)
 N PSBHDR,PSBDT,PSBMED,DFN
"RTN","PSBOPE",37,0)
 ;
"RTN","PSBOPE",38,0)
 ; Print by Patient
"RTN","PSBOPE",39,0)
 ;
"RTN","PSBOPE",40,0)
 D:$P(PSBRPT(.1),U,1)="P"
"RTN","PSBOPE",41,0)
 .S PSBHDR(1)="PRN EFFECTIVENESS LIST for "_$$FMTE^XLFDT(PSBSTRT)_" to "_$$FMTE^XLFDT(PSBSTOP)
"RTN","PSBOPE",42,0)
 .S DFN=$P(PSBRPT(.1),U,2)
"RTN","PSBOPE",43,0)
 .W $$PTHDR()
"RTN","PSBOPE",44,0)
 .I '$O(^TMP("PSB",$J,DFN,0)) W !,"No PRN Medications Found",$$PTFTR^PSBOHDR() Q
"RTN","PSBOPE",45,0)
 .W !  ; Line Break Between Admin Times
"RTN","PSBOPE",46,0)
 .S PSBIEN=""
"RTN","PSBOPE",47,0)
 .F  S PSBIEN=$O(^TMP("PSB",$J,DFN,PSBIEN)) Q:PSBIEN=""  D
"RTN","PSBOPE",48,0)
 ..S PSBIENS=PSBIEN_","
"RTN","PSBOPE",49,0)
 ..I $Y>(IOSL-5) W $$PTFTR^PSBOHDR(),$$PTHDR()
"RTN","PSBOPE",50,0)
 ..W !,$$GET1^DIQ(53.79,PSBIENS,.06),?30,$$GET1^DIQ(53.79,PSBIENS,.08),?64,$$GETINIT^PSBCSUTX(PSBIEN,"N") ;*70 - Get name of who took action, PSB*3*72
"RTN","PSBOPE",51,0)
 ..W ?102,$$GET1^DIQ(53.79,PSBIENS,"PATIENT LOCATION")           ;*70
"RTN","PSBOPE",52,0)
 ..W !,?5,"PRN Reason: ",$$GET1^DIQ(53.79,PSBIENS,.21)
"RTN","PSBOPE",53,0)
 .W $$PTFTR^PSBOHDR()
"RTN","PSBOPE",54,0)
 .Q
"RTN","PSBOPE",55,0)
 ;
"RTN","PSBOPE",56,0)
 ; Print by Ward
"RTN","PSBOPE",57,0)
 ;
"RTN","PSBOPE",58,0)
 D:$P(PSBRPT(.1),U,1)="W"
"RTN","PSBOPE",59,0)
 .S PSBHDR(1)="PRN EFFECTIVENESS LIST  from "_$$FMTE^XLFDT(PSBSTRT)_" thru "_$$FMTE^XLFDT(PSBSTOP)
"RTN","PSBOPE",60,0)
 .S PSBWARD=$P(PSBRPT(.1),U,3)
"RTN","PSBOPE",61,0)
 .W $$WRDHDR()
"RTN","PSBOPE",62,0)
 .I '$O(^TMP("PSB",$J,0)) W !,"No PRN Medications Found" Q
"RTN","PSBOPE",63,0)
 .S PSBSORT=$P(PSBRPT(.1),U,5)
"RTN","PSBOPE",64,0)
 .F DFN=0:0 S DFN=$O(^TMP("PSB",$J,DFN)) Q:'DFN  D
"RTN","PSBOPE",65,0)
 ..S PSBINDX=$S(PSBSORT="P":$P(^DPT(DFN,0),U),1:$G(^DPT(DFN,.1))_" "_$G(^DPT(DFN,.101)))  ;PSB*3*23
"RTN","PSBOPE",66,0)
 ..S:PSBINDX="" PSBINDX=$P(^DPT(DFN,0),U)
"RTN","PSBOPE",67,0)
 ..S ^TMP("PSB",$J,"B",PSBINDX,DFN)=""
"RTN","PSBOPE",68,0)
 .S PSBINDX=""
"RTN","PSBOPE",69,0)
 .F  S PSBINDX=$O(^TMP("PSB",$J,"B",PSBINDX)) Q:PSBINDX=""  D
"RTN","PSBOPE",70,0)
 ..F DFN=0:0 S DFN=$O(^TMP("PSB",$J,"B",PSBINDX,DFN)) Q:'DFN  D
"RTN","PSBOPE",71,0)
 ...W ! ; Line Break Between Pt's
"RTN","PSBOPE",72,0)
 ...W:$P(PSBRPT(.1),U,5)="P" !,$$GET1^DIQ(2,DFN_",",.01),?32,$$GET1^DIQ(2,DFN_",",.1),"  ",$$GET1^DIQ(2,DFN_",",.101)
"RTN","PSBOPE",73,0)
 ...W:$P(PSBRPT(.1),U,5)="B" !,$$GET1^DIQ(2,DFN_",",.1),"  ",$$GET1^DIQ(2,DFN_",",.101),?20,$$GET1^DIQ(2,DFN_",",.01)
"RTN","PSBOPE",74,0)
 ...W !  ; Line Break Between Admin Times
"RTN","PSBOPE",75,0)
 ...S PSBIEN=""
"RTN","PSBOPE",76,0)
 ...F  S PSBIEN=$O(^TMP("PSB",$J,DFN,PSBIEN)) Q:PSBIEN=""  D
"RTN","PSBOPE",77,0)
 ....I $Y>(IOSL-5) W $$WRDHDR()
"RTN","PSBOPE",78,0)
 ....W !?5,$$GET1^DIQ(53.79,PSBIEN_",",.06),?35,$$GET1^DIQ(53.79,PSBIEN_",",.08),?68,$$GETINIT^PSBCSUTX(PSBIEN,"N") ;*70 - Get name of who took action, PSB*3*72
"RTN","PSBOPE",79,0)
 ....W ?102,$$GET1^DIQ(53.79,PSBIEN_",","PATIENT LOCATION")   ;*70
"RTN","PSBOPE",80,0)
 ....W !?10,"PRN Reason: ",$$GET1^DIQ(53.79,PSBIEN_",",.21)
"RTN","PSBOPE",81,0)
 Q
"RTN","PSBOPE",82,0)
 ;
"RTN","PSBOPE",83,0)
WRDHDR() ; Ward Header
"RTN","PSBOPE",84,0)
 N PSBSRCHL ;Add PSBSRCHL variable and additional PSBHDR array spacers for PSBOHDR call, PSB*3*78
"RTN","PSBOPE",85,0)
  S PSBSRCHL=$$SRCHLIST^PSBOHDR()
"RTN","PSBOPE",86,0)
 S PSBHDR(2)="",PSBHDR(3)="",PSBHDR(4)="Ward Location: "
"RTN","PSBOPE",87,0)
 N PSBCLINORD S PSBCLINORD=2               ;2 = both order types   *70
"RTN","PSBOPE",88,0)
 D WARD^PSBOHDR(PSBWRD,.PSBHDR,,,PSBSRCHL)
"RTN","PSBOPE",89,0)
 W:$P(PSBRPT(.1),U,5)="B" !,"Ward Rm-Bed",?20,"Patient"
"RTN","PSBOPE",90,0)
 W:$P(PSBRPT(.1),U,5)="P" !,"Patient",?32,"Ward Rm-Bed"
"RTN","PSBOPE",91,0)
 ;adjust name of headings and colums to make room for Location    ;*70
"RTN","PSBOPE",92,0)
 W !?5,"Admin Date/Time",?35,"Medication",?68,"Administered By"   ;*70
"RTN","PSBOPE",93,0)
 W ?102,"Location"                                                ;*70
"RTN","PSBOPE",94,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBOPE",95,0)
 Q ""
"RTN","PSBOPE",96,0)
 ;
"RTN","PSBOPE",97,0)
PTHDR() ; Patient Header
"RTN","PSBOPE",98,0)
 N PSBCLINORD S PSBCLINORD=2               ;2 = both order types   *70
"RTN","PSBOPE",99,0)
 D PT^PSBOHDR(DFN,.PSBHDR)
"RTN","PSBOPE",100,0)
 W !,"Admin Date/Time",?30,"Medication",?64,"Administered By"
"RTN","PSBOPE",101,0)
 W ?102,"Location"
"RTN","PSBOPE",102,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBOPE",103,0)
 Q ""
"RTN","PSBOPE",104,0)
 ;
"RTN","PSBOPM")
0^6^B93804999^B75665878
"RTN","PSBOPM",1,0)
PSBOPM ;BIRMINGHAM/BSR-BCMA OIT HISTORY ;8/12/12 7:59pm
"RTN","PSBOPM",2,0)
 ;;3.0;BAR CODE MED ADMIN;**3,9,13,17,40,70,72**;Mar 2004;Build 16
"RTN","PSBOPM",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBOPM",4,0)
 ;
"RTN","PSBOPM",5,0)
 ; Reference/IA
"RTN","PSBOPM",6,0)
 ; File 50.7/2880
"RTN","PSBOPM",7,0)
 ; File 52.6/436
"RTN","PSBOPM",8,0)
 ; File 52.7/437
"RTN","PSBOPM",9,0)
 ; File 200/10060
"RTN","PSBOPM",10,0)
 ; EN^PSJBCMA1/2829
"RTN","PSBOPM",11,0)
 ;
"RTN","PSBOPM",12,0)
 ;*70 - reset PSBCLINORD = 2 to signify combined orders report
"RTN","PSBOPM",13,0)
 ;
"RTN","PSBOPM",14,0)
EN ;
"RTN","PSBOPM",15,0)
 N PSBHDR,DFN
"RTN","PSBOPM",16,0)
 S PSBGBL="^TMP(""PSBO"",$J,""B"")"
"RTN","PSBOPM",17,0)
 F  S PSBGBL=$Q(@PSBGBL) Q:PSBGBL=""  Q:$QS(PSBGBL,2)'=$J  Q:$QS(PSBGBL,1)'["PSBO"  D
"RTN","PSBOPM",18,0)
 .S DFN=$QS(PSBGBL,5)
"RTN","PSBOPM",19,0)
 I '$G(DFN) W !,("Error: No Patient IEN")  Q
"RTN","PSBOPM",20,0)
 S PSBSTRT=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,7)
"RTN","PSBOPM",21,0)
 S PSBSTOP=$P(PSBRPT(.1),U,8)+$P(PSBRPT(.1),U,9)
"RTN","PSBOPM",22,0)
 S PSBCOM=$P(PSBRPT(.2),"^",8)   ;COMMENT FLAG 1 MEANS YES
"RTN","PSBOPM",23,0)
 I PSBSTRT="0" D
"RTN","PSBOPM",24,0)
 .D NOW^%DTC S PSBSTOP=%
"RTN","PSBOPM",25,0)
 .S X1=((PSBSTOP)\1) S X2=-$$GET^XPAR("ALL","PSB MED HIST DAYS BACK")
"RTN","PSBOPM",26,0)
 .S:X2'<0 X2=-30 D C^%DTC  S PSBSTRT=X
"RTN","PSBOPM",27,0)
 .S PSBCOM=$$GET^XPAR("ALL","PSB RPT INCL COMMENTS")
"RTN","PSBOPM",28,0)
 D OUT(DFN,PSBSTRT,PSBSTOP,PSBORDNM)
"RTN","PSBOPM",29,0)
 Q
"RTN","PSBOPM",30,0)
 ;
"RTN","PSBOPM",31,0)
OUT(DFN,PSBSTRT,PSBSTOP,PSBORDNM)        ;
"RTN","PSBOPM",32,0)
 D CLEANALL ;CLEAN UP VARIABLES AND TMP ARRAY
"RTN","PSBOPM",33,0)
 ;
"RTN","PSBOPM",34,0)
 ;IF PSBORDNM DOESN'T CONTAIN A "U" OR A "V", SKIP THE ORDER LOOKUP
"RTN","PSBOPM",35,0)
 S PSBOR=1
"RTN","PSBOPM",36,0)
 I PSBORDNM'["U",PSBORDNM'["V" D
"RTN","PSBOPM",37,0)
 .S:'$$GETORD^PSBOPM1(.PSBORDNM) PSBOR=0
"RTN","PSBOPM",38,0)
 .I 'PSBOR&(PSBORDNM]"") S TMP("PSBOIS",$J,PSBORDNM)=""
"RTN","PSBOPM",39,0)
 I PSBOR D
"RTN","PSBOPM",40,0)
 .D GETORDN
"RTN","PSBOPM",41,0)
 .D GETOIS
"RTN","PSBOPM",42,0)
 D GETADSO ;  GET ALL ADDITIVES AND SOLUTIONS
"RTN","PSBOPM",43,0)
 D FINDIENS^PSBOPM1 ; FIND EVERY MED LOG ENTRIES THAT SHOULD BE ON THE RPT
"RTN","PSBOPM",44,0)
 D PREOUT ;   WRITE DATA TO GLOBAL
"RTN","PSBOPM",45,0)
 D WRITEOT ;
"RTN","PSBOPM",46,0)
 D CLEANSUM ; CLEAN UP AND LEAVE LIST OF IENS FOR THE REPORT.
"RTN","PSBOPM",47,0)
 Q
"RTN","PSBOPM",48,0)
 ;
"RTN","PSBOPM",49,0)
GETORDN ;
"RTN","PSBOPM",50,0)
 K ^TMP("PSJ1",$J)
"RTN","PSBOPM",51,0)
 D EN^PSJBCMA1(DFN,PSBORDNM,1)
"RTN","PSBOPM",52,0)
 Q
"RTN","PSBOPM",53,0)
 ;
"RTN","PSBOPM",54,0)
GETOIS  ; LOAD PSBOIS(#) WITH ALL OF THE ORDERABLE ITEMS
"RTN","PSBOPM",55,0)
 I PSBORDNM["U" D
"RTN","PSBOPM",56,0)
 .;GET UNIT DOSE ORDERS
"RTN","PSBOPM",57,0)
 .I $D(^TMP("PSJ1",$J,2)) D
"RTN","PSBOPM",58,0)
 ..S PSBOI=$P(^TMP("PSJ1",$J,2),"^")
"RTN","PSBOPM",59,0)
 ..S PSBOI=$S(PSBOI["U":$TR(PSBOI,"U",""),PSBOI["V":$TR(PSBOI,"V",""),1:PSBOI)
"RTN","PSBOPM",60,0)
 ..S TMP("PSBOIS",$J,PSBOI)=""
"RTN","PSBOPM",61,0)
 ;
"RTN","PSBOPM",62,0)
 ;IV ORDERS NEED TO USE THE ADDITIVE AND SOLUTION NUMBER TO BACK
"RTN","PSBOPM",63,0)
 ;TRACK TO THE OI ASSOCIATED WITH IT
"RTN","PSBOPM",64,0)
 I PSBORDNM["V" D
"RTN","PSBOPM",65,0)
 .;GET ADDITIVES OFF THE ORDER
"RTN","PSBOPM",66,0)
 .I $G(^TMP("PSJ1",$J,850,0))  D
"RTN","PSBOPM",67,0)
 ..S XXX="" F  S XXX=$O(^TMP("PSJ1",$J,850,XXX)) Q:XXX=""  D
"RTN","PSBOPM",68,0)
 ...S XXY="" F  S XXY=$O(^TMP("PSJ1",$J,850,XXX,XXY)) Q:XXY=""  D
"RTN","PSBOPM",69,0)
 ....S PSBADD=$P(^TMP("PSJ1",$J,850,XXX,XXY),"^")
"RTN","PSBOPM",70,0)
 ....;CONVERT ADDITIVE TO ORDERABLE ITEM AND ADD TO LIST
"RTN","PSBOPM",71,0)
 ....S TMP("PSBOIS",$J,$$OFROMA(PSBADD))=""
"RTN","PSBOPM",72,0)
 .;   GET SOLUTIONS OFF THE ORDER
"RTN","PSBOPM",73,0)
 .I $G(^TMP("PSJ1",$J,950,0))  D
"RTN","PSBOPM",74,0)
 ..S XXX="" F  S XXX=$O(^TMP("PSJ1",$J,950,XXX)) Q:XXX=""  D
"RTN","PSBOPM",75,0)
 ...S XXY="" F  S XXY=$O(^TMP("PSJ1",$J,950,XXX,XXY)) Q:XXY=""  D
"RTN","PSBOPM",76,0)
 ....S PSBSOL=$P(^TMP("PSJ1",$J,950,XXX,XXY),"^")
"RTN","PSBOPM",77,0)
 ....;
"RTN","PSBOPM",78,0)
 ....;CONVERT SOLUTIOIN TO ORDERABLE ITEM AND ADD TO LIST
"RTN","PSBOPM",79,0)
 ....S TMP("PSBOIS",$J,$$OFROMS(PSBSOL))=""
"RTN","PSBOPM",80,0)
 Q
"RTN","PSBOPM",81,0)
 ;
"RTN","PSBOPM",82,0)
OFROMA(PSBADD) ;GET ORDERABLE ITEM FROM AN ADDITIVE
"RTN","PSBOPM",83,0)
 Q $$GET1^DIQ(52.6,PSBADD_",",15,"I")
"RTN","PSBOPM",84,0)
 ; 
"RTN","PSBOPM",85,0)
OFROMS(PSBSOL) ; GET ORDERABLE ITEM FROM A SOLUTION
"RTN","PSBOPM",86,0)
 Q $$GET1^DIQ(52.7,PSBSOL_",",9,"I")
"RTN","PSBOPM",87,0)
 ;
"RTN","PSBOPM",88,0)
GETADSO ; GET ALL ADDITIVES FOR ALL ORDERABLE ITEMS
"RTN","PSBOPM",89,0)
 K PSBAOUT,PSBSOUT
"RTN","PSBOPM",90,0)
 S XA="" F  S XA=$O(TMP("PSBOIS",$J,XA)) Q:XA=""  D
"RTN","PSBOPM",91,0)
 .D LIST^DIC(52.6,"","@;15I","QPI","","","","AOI","","","PSBAOUT")
"RTN","PSBOPM",92,0)
 .S XB=0 F  S XB=$O(PSBAOUT("DILIST",XB)) Q:XB=""  D
"RTN","PSBOPM",93,0)
 ..I $P(PSBAOUT("DILIST",XB,0),"^",2)=XA D
"RTN","PSBOPM",94,0)
 ...S TMP("PSBADDS",$J,$P(PSBAOUT("DILIST",XB,0),"^",1))=""
"RTN","PSBOPM",95,0)
 K PSBAOUT
"RTN","PSBOPM",96,0)
 ; GET ALL SOLUTIONS FOR ALL ORDERABLE ITEMS
"RTN","PSBOPM",97,0)
 S XA="" F  S XA=$O(TMP("PSBOIS",$J,XA)) Q:XA=""  D
"RTN","PSBOPM",98,0)
 .D LIST^DIC(52.7,"","@;9I","QPI","","","","AOI","","","PSBSOUT")
"RTN","PSBOPM",99,0)
 .S XB=0 F  S XB=$O(PSBSOUT("DILIST",XB)) Q:XB=""  D
"RTN","PSBOPM",100,0)
 ..I $P(PSBSOUT("DILIST",XB,0),"^",2)=XA D
"RTN","PSBOPM",101,0)
 ...S TMP("PSBSOLS",$J,$P(PSBSOUT("DILIST",XB,0),"^",1))=""
"RTN","PSBOPM",102,0)
 K PSBSOUT
"RTN","PSBOPM",103,0)
 Q
"RTN","PSBOPM",104,0)
 ;
"RTN","PSBOPM",105,0)
PREOUT ;
"RTN","PSBOPM",106,0)
 N TYP
"RTN","PSBOPM",107,0)
 F TYP="UD","ADD","SOL"  D
"RTN","PSBOPM",108,0)
 .Q:'$D(TMP("PSBIENS",$J,TYP))
"RTN","PSBOPM",109,0)
 .K PSBUNK S XDT="" F  S XDT=$O(TMP("PSBIENS",$J,TYP,XDT),-1) Q:XDT=""  D
"RTN","PSBOPM",110,0)
 ..S I="" F  S I=$O(TMP("PSBIENS",$J,TYP,XDT,I)) Q:I=""  D
"RTN","PSBOPM",111,0)
 ...I TYP="UD" Q:$D(TMP("PSBIENS",$J,"ADD",XDT,I))  Q:$D(TMP("PSBIENS",$J,"SOL",XDT,I))
"RTN","PSBOPM",112,0)
 ...S PSBIEN=I
"RTN","PSBOPM",113,0)
 ...S PSBIENS=PSBIEN_","
"RTN","PSBOPM",114,0)
 ...D OUTPUT(TYP)
"RTN","PSBOPM",115,0)
 Q
"RTN","PSBOPM",116,0)
 ;
"RTN","PSBOPM",117,0)
OUTPUT(TYP) ;
"RTN","PSBOPM",118,0)
 S PSBSPC=$J("",80)
"RTN","PSBOPM",119,0)
 S W=$E($$GET1^DIQ(53.79,PSBIENS,.02)_PSBSPC,1,20)_" "
"RTN","PSBOPM",120,0)
 I $TR(W," ")="",$$MME^PSBOML(+PSBIENS) S W="MME/UNKNOWN LOCATION "
"RTN","PSBOPM",121,0)
 S W=W_$S($P(^PSB(53.79,PSBIEN,0),U,9)="":"?? ",1:$E($P(^PSB(53.79,PSBIEN,0),U,9)_"  ",1,2)_" ")
"RTN","PSBOPM",122,0)
 S:$P(^PSB(53.79,PSBIEN,0),U,9)="" PSBUNK=1
"RTN","PSBOPM",123,0)
 S W=W_$E($P($G(^PSB(53.79,PSBIEN,.1)),U,2)_PSBSPC,1,2)_"  "
"RTN","PSBOPM",124,0)
 S W=W_$E($E($$GET1^DIQ(53.79,PSBIENS,.06),1,18)_PSBSPC,1,21)_" "
"RTN","PSBOPM",125,0)
 S W=W_$E($$GETINIT^PSBCSUTX(PSBIEN,"I")_PSBSPC,1,10)_" " ;Get initials of who took action, PSB*3*72
"RTN","PSBOPM",126,0)
 S W=W_$$GET1^DIQ(53.79,PSBIENS,.16)
"RTN","PSBOPM",127,0)
 D ADD(W,TYP)
"RTN","PSBOPM",128,0)
 F PSBNODE=.5,.6,.7 D
"RTN","PSBOPM",129,0)
 .S PSBDD=$S(PSBNODE=.5:53.795,PSBNODE=.6:53.796,1:53.797)
"RTN","PSBOPM",130,0)
 .F PSBY=0:0 S PSBY=$O(^PSB(53.79,PSBIEN,PSBNODE,PSBY)) Q:'PSBY  D  ;Include units ordered for IV's
"RTN","PSBOPM",131,0)
 ..D:PSBDD=53.795 WRAPMEDS($$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.01),$$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.03),$$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.04),TYP)
"RTN","PSBOPM",132,0)
 ..D:PSBDD=53.796!(PSBDD=53.797) WRAPMEDS($$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.01)_" - "_$$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.02),$$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.03),$$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.04),TYP)
"RTN","PSBOPM",133,0)
 I PSBCOM=1  D COMNTS   ;GETS COMMENTS
"RTN","PSBOPM",134,0)
 D ADD("",TYP)
"RTN","PSBOPM",135,0)
 Q
"RTN","PSBOPM",136,0)
 ;
"RTN","PSBOPM",137,0)
COMNTS  ;
"RTN","PSBOPM",138,0)
 N Z,CNT
"RTN","PSBOPM",139,0)
 S Z="",CNT=0
"RTN","PSBOPM",140,0)
 I $D(^PSB(53.79,PSBIEN,.3,0)) D
"RTN","PSBOPM",141,0)
 .D ADD("",TYP)
"RTN","PSBOPM",142,0)
 .D ADD($J("",44)_"Comments: "_$$MAKELINE("-",78),TYP)
"RTN","PSBOPM",143,0)
 .S XT="" F  S XT=$O(^PSB(53.79,PSBIEN,.3,XT)) Q:XT=""  I XT'=0  D
"RTN","PSBOPM",144,0)
 ..D:CNT=1 ADD("",TYP)
"RTN","PSBOPM",145,0)
 ..S Y=$P(^PSB(53.79,PSBIEN,.3,XT,0),"^",3) D DD^%DT S XBR=Y
"RTN","PSBOPM",146,0)
 ..S Z=XBR_"   "_$P(^VA(200,$P(^PSB(53.79,PSBIEN,.3,XT,0),"^",2),0),"^",2)
"RTN","PSBOPM",147,0)
 ..D WRAP($P(^PSB(53.79,PSBIEN,.3,XT,0),"^",1),Z,PSBIEN)
"RTN","PSBOPM",148,0)
 ..S CNT=1
"RTN","PSBOPM",149,0)
 .D ADD($J("",54)_$$MAKELINE("-",78),TYP)
"RTN","PSBOPM",150,0)
 Q
"RTN","PSBOPM",151,0)
        ;
"RTN","PSBOPM",152,0)
WRAP(SIZE,ZP,BRIEN)         ;
"RTN","PSBOPM",153,0)
 D ADD($J("",55)_ZP,TYP)
"RTN","PSBOPM",154,0)
 D ADD($J("",55)_$E(SIZE,1,75),TYP)
"RTN","PSBOPM",155,0)
 I $L(SIZE)>75 D ADD($J("",55)_$E(SIZE,76,150),TYP)
"RTN","PSBOPM",156,0)
 Q
"RTN","PSBOPM",157,0)
 ;
"RTN","PSBOPM",158,0)
HEADA ;
"RTN","PSBOPM",159,0)
 W !
"RTN","PSBOPM",160,0)
 W "Location",?21,"St Sch Administration Date",?50,"By",?61,"Injection Site",?96,"Units",?112,"Units of"
"RTN","PSBOPM",161,0)
 W !,?55,"Medication & Dosage",?96,"GIVEN",?112,"Administration"
"RTN","PSBOPM",162,0)
 W !
"RTN","PSBOPM",163,0)
 W $$MAKELINE("-",132)
"RTN","PSBOPM",164,0)
 Q
"RTN","PSBOPM",165,0)
 ;
"RTN","PSBOPM",166,0)
ADD(XE,TYP)  ;
"RTN","PSBOPM",167,0)
 S ^TMP("PSB",$J,TYP,$O(^TMP("PSB",$J,TYP,""),-1)+1)=XE
"RTN","PSBOPM",168,0)
 Q
"RTN","PSBOPM",169,0)
 ;
"RTN","PSBOPM",170,0)
WRAPMEDS(MED,UG,UOA,TYP)  ;
"RTN","PSBOPM",171,0)
 ;MED IS NOT WRAPPED: MAX LENGTH IN PSDRUG/52.6/52.7 IS 40
"RTN","PSBOPM",172,0)
 ;UG/UOA MAX AT 30/40 AND WILL BE WRAPPED AT 15 EACH
"RTN","PSBOPM",173,0)
 ;THIS WILL CREATE UPTO 3 LINES
"RTN","PSBOPM",174,0)
 S MED=$S($L(MED)>40:$E(MED_$J("",80),1,80),1:$E(MED_$J("",40),1,40)) ;Add wrapping for med/units ordered
"RTN","PSBOPM",175,0)
 N UGWRAP,PSBMED1,PSBMED41,PSBMED81,PSBCNT
"RTN","PSBOPM",176,0)
 S (CNTX,UOA1,UOA16,UOA31,PSBMED1,PSBMED41,PSBMED81)=""
"RTN","PSBOPM",177,0)
 I +$G(UG)?1"."1.N S UG=0_+UG
"RTN","PSBOPM",178,0)
 F CNT=1:15:45  D
"RTN","PSBOPM",179,0)
 .S PSBCNT=$S(CNT=1:1,CNT=16:41,CNT=31:81,1:120)
"RTN","PSBOPM",180,0)
 .D PARSEM(MED,PSBCNT)
"RTN","PSBOPM",181,0)
 .D PARSE(UOA,CNT)
"RTN","PSBOPM",182,0)
 .S UGWRAP=$E(UG,CNT,(CNT+14))
"RTN","PSBOPM",183,0)
 .I CNT=1 D ADD($J("",55)_MED_" "_$$PAD(UGWRAP,15)_" "_$$PAD(UOA1,15),TYP)
"RTN","PSBOPM",184,0)
 .I (CNT>1),($L(UGWRAP)>0!$L(@("UOA"_CNT))>0) D ADD($J("",96)_$$PAD(UGWRAP,15)_" "_$$PAD(@("UOA"_CNT),15),TYP)
"RTN","PSBOPM",185,0)
 Q
"RTN","PSBOPM",186,0)
 ;
"RTN","PSBOPM",187,0)
PAD(X,CNT) ;
"RTN","PSBOPM",188,0)
 Q $E(X_$J("",CNT),1,CNT)
"RTN","PSBOPM",189,0)
WRITEOT ;
"RTN","PSBOPM",190,0)
 N TPE
"RTN","PSBOPM",191,0)
 S Y=$P(PSBSTRT,".",1)  D D^DIQ  S PSTRTA=Y
"RTN","PSBOPM",192,0)
 S Y=$P(PSBSTOP,".",1)  D D^DIQ  S PSTP=Y
"RTN","PSBOPM",193,0)
 S PSBHDR(1)="MEDICATION HISTORY for "_PSTRTA_"  to  "_PSTP
"RTN","PSBOPM",194,0)
 I '$D(TMP("PSBIENS",$J)) D ADD("<<<< NO HISTORY FOUND FOR THIS TIME FRAME >>>>","UD")
"RTN","PSBOPM",195,0)
 S TPE="" F  S TPE=$O(^TMP("PSB",$J,TPE)) Q:TPE=""  D
"RTN","PSBOPM",196,0)
 .D MEDS(TPE)
"RTN","PSBOPM",197,0)
 .N PSBCLINORD S PSBCLINORD=2 D PT^PSBOHDR(DFN,.PSBHDR),HEADA     ;*70
"RTN","PSBOPM",198,0)
 .S EX="" F  S EX=$O(^TMP("PSB",$J,TPE,EX)) Q:EX=""  D
"RTN","PSBOPM",199,0)
 ..I $Y>(IOSL-5) D
"RTN","PSBOPM",200,0)
 ...W $$PTFTR^PSBOHDR()
"RTN","PSBOPM",201,0)
 ...D PT^PSBOHDR(DFN,.PSBHDR),HEADA
"RTN","PSBOPM",202,0)
 ..W !,$G(^TMP("PSB",$J,TPE,EX))
"RTN","PSBOPM",203,0)
 W $$PTFTR^PSBOHDR()
"RTN","PSBOPM",204,0)
 Q
"RTN","PSBOPM",205,0)
 ;
"RTN","PSBOPM",206,0)
FTR() ;
"RTN","PSBOPM",207,0)
 I (IOSL<100) F  Q:$Y>(IOSL-10)  W !
"RTN","PSBOPM",208,0)
 W !,$TR($J("",IOM)," ","=")
"RTN","PSBOPM",209,0)
 S X="Ward: "_PSBHDR("WARD")_"  Room-Bed: "_PSBHDR("ROOM")
"RTN","PSBOPM",210,0)
 W !,PSBHDR("NAME"),?(IOM-11\2),PSBHDR("SSN"),?(IOM-$L(X)),X
"RTN","PSBOPM",211,0)
 Q ""
"RTN","PSBOPM",212,0)
 ;
"RTN","PSBOPM",213,0)
MEDS(TYP) ;
"RTN","PSBOPM",214,0)
 N MED,XA,XB,DPTR,DRG,FLE,SBSC
"RTN","PSBOPM",215,0)
 S MED="",XB=3,DRG=""
"RTN","PSBOPM",216,0)
 S PSBHDR(3)="MEDICATIONS SEARCH LIST:"
"RTN","PSBOPM",217,0)
 S XA="" F  S XA=$O(TMP("PSBOIS",$J,XA)) Q:XA=""  D
"RTN","PSBOPM",218,0)
 .S MED=$$GET1^DIQ(50.7,XA,.01)
"RTN","PSBOPM",219,0)
 .I $L(PSBHDR(XB)_" "_MED)>IOM D
"RTN","PSBOPM",220,0)
 ..S XB=XB+1,PSBHDR(XB)="                         "_MED
"RTN","PSBOPM",221,0)
 .E  S PSBHDR(XB)=PSBHDR(XB)_$S($L(PSBHDR(XB))<26:" ",1:"; ")_MED
"RTN","PSBOPM",222,0)
 S XA=999 F  S XA=$O(PSBHDR(XA),-1) Q:XA=XB  K PSBHDR(XA)
"RTN","PSBOPM",223,0)
 I TYP'="" D
"RTN","PSBOPM",224,0)
 .I TYP["UD" S TYP="UNIT DOSE",SBSC="PSBOIS",FLE=50.7
"RTN","PSBOPM",225,0)
 .I TYP["AD" S TYP="ADDITIVE",SBSC="PSBADDS",FLE=52.6
"RTN","PSBOPM",226,0)
 .I TYP["SO" S TYP="SOLUTION",SBSC="PSBSOLS",FLE=52.7
"RTN","PSBOPM",227,0)
 .S DPTR="" F  S DPTR=$O(TMP(SBSC,$J,DPTR)) Q:DPTR=""  I TMP(SBSC,$J,DPTR) D
"RTN","PSBOPM",228,0)
 ..S DRG=$$GET1^DIQ(FLE,DPTR,.01)
"RTN","PSBOPM",229,0)
 ..S PSBHDR($O(PSBHDR(999),-1)+1)=$S(TYP="UNIT DOSE":"",1:"SEARCH FOR "_TYP_": "_DRG)
"RTN","PSBOPM",230,0)
 .K TMP(SBSC,$J)
"RTN","PSBOPM",231,0)
 Q
"RTN","PSBOPM",232,0)
 ;
"RTN","PSBOPM",233,0)
CLEANALL        ; KILL ALL TMP LEVELS USED VARIABLES
"RTN","PSBOPM",234,0)
 K ^TMP("PSB",$J),^TMP("PSJ1",$J),TMP("PSBOIS",$J),TMP("PSBADDS",$J),TMP("PSBSOLS",$J),TMP("PSBIENS",$J),TMP("ARY",$J),DRG,DPTR,PSBOR,FLE,SBSC,TPE
"RTN","PSBOPM",235,0)
 Q
"RTN","PSBOPM",236,0)
 ;
"RTN","PSBOPM",237,0)
CLEANSUM        ; KILLL ALL BUT THE "PSBIENS" LEVEL
"RTN","PSBOPM",238,0)
 K ^TMP("PSB",$J),^TMP("PSJ1",$J),TMP("PSBIENS",$J),TMP("PSBOIS",$J),TMP("PSBADDS",$J),TMP("PSBSOLS",$J)
"RTN","PSBOPM",239,0)
 Q
"RTN","PSBOPM",240,0)
MAKELINE(X,CNT) ;LINE OF WHAT'S PASSED IN CNT TIMES
"RTN","PSBOPM",241,0)
 N Y,Z
"RTN","PSBOPM",242,0)
 S Y=""
"RTN","PSBOPM",243,0)
 F Z=1:1:CNT S Y=Y_X
"RTN","PSBOPM",244,0)
 Q Y
"RTN","PSBOPM",245,0)
 ;
"RTN","PSBOPM",246,0)
PARSE(X,CNT) ;Split text for wrapping.
"RTN","PSBOPM",247,0)
 S CNTX="UOA"_CNT,@CNTX=@CNTX_$E(X,CNT,(CNT+14)),UOAX=""
"RTN","PSBOPM",248,0)
 F  S:$F(@CNTX,", ",+UOAX)>0 UOAX=$F(@CNTX,", ",+UOAX)  Q:'$F(@CNTX,", ",+UOAX)
"RTN","PSBOPM",249,0)
 I UOAX<1 F  S:$F(@CNTX," ",+UOAX)>0 UOAX=$F(@CNTX," ",+UOAX)  Q:'$F(@CNTX," ",+UOAX)
"RTN","PSBOPM",250,0)
 I UOAX>1,(($L(UOA)-(CNT+14))>0) S CNTXX=$E(@CNTX,1,UOAX-1),@("UOA"_(CNT+15))=$E(@CNTX,UOAX,UOAX+14),@CNTX=CNTXX
"RTN","PSBOPM",251,0)
 Q
"RTN","PSBOPM",252,0)
 ;
"RTN","PSBOPM",253,0)
PARSEM(PSBMED,PSBCNT) ;Split text for wrapping meds, PSB*3*72
"RTN","PSBOPM",254,0)
 N PSBCNTX,PSBMEDX,PSBMEDX,PSBCNTXX
"RTN","PSBOPM",255,0)
 S PSBCNTX="PSBMED"_PSBCNT,@PSBCNTX=@PSBCNTX_$E(PSBMED,PSBCNT,(PSBCNT+39)),PSBMEDX=""
"RTN","PSBOPM",256,0)
 F  S:$F(@PSBCNTX,", ",+PSBMEDX)>0 PSBMEDX=$F(@PSBCNTX,", ",+PSBMEDX)  Q:'$F(@PSBCNTX,", ",+PSBMEDX)
"RTN","PSBOPM",257,0)
 I PSBMEDX<1 F  S:$F(@PSBCNTX," ",+PSBMEDX)>0 PSBMEDX=$F(@PSBCNTX," ",+PSBMEDX)  Q:'$F(@PSBCNTX," ",+PSBMEDX)
"RTN","PSBOPM",258,0)
 I PSBMEDX>1,(($L(MED)-(PSBCNT+39))>0) S PSBCNTXX=$E(@PSBCNTX,1,PSBMEDX-1),@("PSBMED"_(PSBCNT+40))=$E(@PSBCNTX,PSBMEDX,PSBMEDX+39),@PSBCNTX=PSBCNTXX
"RTN","PSBOPM",259,0)
 Q
"VER")
8.0^22.0
"BLD",9625,6)
^69
**END**
**END**

