Released PSB*3*100 SEQ #87
Extracted from mail message
**KIDS**:PSB*3.0*100^

**INSTALL NAME**
PSB*3.0*100
"BLD",10173,0)
PSB*3.0*100^BAR CODE MED ADMIN^0^3171010^y
"BLD",10173,1,0)
^^3^3^3170921^
"BLD",10173,1,1,0)
This patch provides multi-division sites the ability to run the report 
"BLD",10173,1,2,0)
'Missing Dose Followup' by division. Single division sites are not 
"BLD",10173,1,3,0)
affected by the changes in this patch.
"BLD",10173,4,0)
^9.64PA^53.68^1
"BLD",10173,4,53.68,0)
53.68
"BLD",10173,4,53.68,2,0)
^9.641^53.68^1
"BLD",10173,4,53.68,2,53.68,0)
BCMA MISSING DOSE REQUEST  (File-top level)
"BLD",10173,4,53.68,2,53.68,1,0)
^9.6411^.07^2
"BLD",10173,4,53.68,2,53.68,1,.04,0)
DIVISION
"BLD",10173,4,53.68,2,53.68,1,.07,0)
STATUS
"BLD",10173,4,53.68,222)
y^n^p^^^^n^^n
"BLD",10173,4,53.68,224)

"BLD",10173,4,"APDD",53.68,53.68)

"BLD",10173,4,"APDD",53.68,53.68,.04)

"BLD",10173,4,"APDD",53.68,53.68,.07)

"BLD",10173,4,"B",53.68,53.68)

"BLD",10173,6.3)
17
"BLD",10173,"ABPKG")
n
"BLD",10173,"INID")
^y
"BLD",10173,"INIT")
POST^PSB3P100
"BLD",10173,"KRN",0)
^9.67PA^779.2^20
"BLD",10173,"KRN",.4,0)
.4
"BLD",10173,"KRN",.401,0)
.401
"BLD",10173,"KRN",.402,0)
.402
"BLD",10173,"KRN",.403,0)
.403
"BLD",10173,"KRN",.5,0)
.5
"BLD",10173,"KRN",.84,0)
.84
"BLD",10173,"KRN",3.6,0)
3.6
"BLD",10173,"KRN",3.8,0)
3.8
"BLD",10173,"KRN",9.2,0)
9.2
"BLD",10173,"KRN",9.8,0)
9.8
"BLD",10173,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",10173,"KRN",9.8,"NM",1,0)
PSBMD^^0^B151152763
"BLD",10173,"KRN",9.8,"NM","B","PSBMD",1)

"BLD",10173,"KRN",19,0)
19
"BLD",10173,"KRN",19.1,0)
19.1
"BLD",10173,"KRN",101,0)
101
"BLD",10173,"KRN",409.61,0)
409.61
"BLD",10173,"KRN",771,0)
771
"BLD",10173,"KRN",779.2,0)
779.2
"BLD",10173,"KRN",870,0)
870
"BLD",10173,"KRN",8989.51,0)
8989.51
"BLD",10173,"KRN",8989.51,"NM",0)
^9.68A^^0
"BLD",10173,"KRN",8989.52,0)
8989.52
"BLD",10173,"KRN",8994,0)
8994
"BLD",10173,"KRN","B",.4,.4)

"BLD",10173,"KRN","B",.401,.401)

"BLD",10173,"KRN","B",.402,.402)

"BLD",10173,"KRN","B",.403,.403)

"BLD",10173,"KRN","B",.5,.5)

"BLD",10173,"KRN","B",.84,.84)

"BLD",10173,"KRN","B",3.6,3.6)

"BLD",10173,"KRN","B",3.8,3.8)

"BLD",10173,"KRN","B",9.2,9.2)

"BLD",10173,"KRN","B",9.8,9.8)

"BLD",10173,"KRN","B",19,19)

"BLD",10173,"KRN","B",19.1,19.1)

"BLD",10173,"KRN","B",101,101)

"BLD",10173,"KRN","B",409.61,409.61)

"BLD",10173,"KRN","B",771,771)

"BLD",10173,"KRN","B",779.2,779.2)

"BLD",10173,"KRN","B",870,870)

"BLD",10173,"KRN","B",8989.51,8989.51)

"BLD",10173,"KRN","B",8989.52,8989.52)

"BLD",10173,"KRN","B",8994,8994)

"BLD",10173,"QUES",0)
^9.62^^
"BLD",10173,"REQB",0)
^9.611^1^1
"BLD",10173,"REQB",1,0)
PSB*3.0*70^1
"BLD",10173,"REQB","B","PSB*3.0*70",1)

"FIA",53.68)
BCMA MISSING DOSE REQUEST
"FIA",53.68,0)
^PSB(53.68,
"FIA",53.68,0,0)
53.68
"FIA",53.68,0,1)
y^n^p^^^^n^^n
"FIA",53.68,0,10)

"FIA",53.68,0,11)

"FIA",53.68,0,"RLRO")

"FIA",53.68,0,"VR")
3.0^PSB
"FIA",53.68,53.68)
1
"FIA",53.68,53.68,.04)

"FIA",53.68,53.68,.07)

"INIT")
POST^PSB3P100
"IX",53.68,53.68,"DIVAS",0)
53.68^DIVAS^Compound cross reference of Status and Division.^R^^R^IR^I^53.68^^^^^LS
"IX",53.68,53.68,"DIVAS",.1,0)
^^2^2^3170405^
"IX",53.68,53.68,"DIVAS",.1,1,0)
This cross reference sorts entries by Status and Division; it is used for
"IX",53.68,53.68,"DIVAS",.1,2,0)
lookups in the report 'Missing Dose Followup'.
"IX",53.68,53.68,"DIVAS",1)
S ^PSB(53.68,"DIVAS",X(1),X(2),DA)=""
"IX",53.68,53.68,"DIVAS",2)
K ^PSB(53.68,"DIVAS",X(1),X(2),DA)
"IX",53.68,53.68,"DIVAS",2.5)
K ^PSB(53.68,"DIVAS")
"IX",53.68,53.68,"DIVAS",11.1,0)
^.114IA^2^2
"IX",53.68,53.68,"DIVAS",11.1,1,0)
1^F^53.68^.07^^1^F
"IX",53.68,53.68,"DIVAS",11.1,2,0)
2^F^53.68^.04^^2^F
"IX",53.68,53.68,"DIVAS","NOREINDEX")
0
"MBREQ")
0
"PKG",607,-1)
1^1
"PKG",607,0)
BAR CODE MED ADMIN^PSB^BAR CODE MEDICATION ADMINISTRATION
"PKG",607,20,0)
^9.402P^^
"PKG",607,22,0)
^9.49I^1^1
"PKG",607,22,1,0)
3.0^3040224^3040503^568
"PKG",607,22,1,"PAH",1,0)
100^3171010
"PKG",607,22,1,"PAH",1,1,0)
^^3^3^3171010
"PKG",607,22,1,"PAH",1,1,1,0)
This patch provides multi-division sites the ability to run the report 
"PKG",607,22,1,"PAH",1,1,2,0)
'Missing Dose Followup' by division. Single division sites are not 
"PKG",607,22,1,"PAH",1,1,3,0)
affected by the changes in this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSB3P100")
0^^B721273^n/a
"RTN","PSB3P100",1,0)
PSB3P100 ;AITC/CR - Post installation for Patch 100 ; 9/14/17 1:34pm
"RTN","PSB3P100",2,0)
 ;;3.0;BAR CODE MED ADMIN;**100**;Mar 2004;Build 17
"RTN","PSB3P100",3,0)
 ;
"RTN","PSB3P100",4,0)
 ; This routine is used with the New-Style cross reference
"RTN","PSB3P100",5,0)
 ; 'DIVAS' in file #53.68 to re-index the entire file so that multi-division
"RTN","PSB3P100",6,0)
 ; sites can run the report 'Missing Dose Followup' by division
"RTN","PSB3P100",7,0)
POST ; prepare entries for 'Missing Dose Followup' sorted by Status and Division
"RTN","PSB3P100",8,0)
 D BMES^XPDUTL(">>> Post-Init: Re-indexing of file #53.68 in progress...")
"RTN","PSB3P100",9,0)
 N DIK
"RTN","PSB3P100",10,0)
 S DIK="^PSB(53.68,"
"RTN","PSB3P100",11,0)
 S DIK(1)=".04^DIVAS"  ; only need one field for the combined cross ref
"RTN","PSB3P100",12,0)
 D ENALL^DIK
"RTN","PSB3P100",13,0)
 D BMES^XPDUTL(">>> Post-Init completed!")
"RTN","PSB3P100",14,0)
 Q
"RTN","PSBMD")
0^1^B151152763^B90525242
"RTN","PSBMD",1,0)
PSBMD ;BIRMINGHAM/EFC - BCMA MISSING DOSE FUNCTIONS ; 9/26/17 3:25pm
"RTN","PSBMD",2,0)
 ;;3.0;BAR CODE MED ADMIN;**23,42,70,100**;Mar 2004;Build 17
"RTN","PSBMD",3,0)
 ;
"RTN","PSBMD",4,0)
 ; Reference/IA
"RTN","PSBMD",5,0)
 ; ^DIC(42/10039
"RTN","PSBMD",6,0)
 ; ^DPT(/10035
"RTN","PSBMD",7,0)
 ; IN5^VADPT/10061
"RTN","PSBMD",8,0)
 ; DEM^VADPT/10061
"RTN","PSBMD",9,0)
 ; ^XMB/10070
"RTN","PSBMD",10,0)
 ; 52.6/436
"RTN","PSBMD",11,0)
 ; 52.7/437
"RTN","PSBMD",12,0)
 ; ^DG(40.8/417
"RTN","PSBMD",13,0)
 ; 4/2171
"RTN","PSBMD",14,0)
 ; ^DG(40.8/2817
"RTN","PSBMD",15,0)
 ; ^VA(200/10060
"RTN","PSBMD",16,0)
 ; ^DIC(4/10090
"RTN","PSBMD",17,0)
 ; ^DG(43/6812
"RTN","PSBMD",18,0)
 ;
"RTN","PSBMD",19,0)
 ;*70 -  add new kernel variable for CO Missing Dose Printer.
"RTN","PSBMD",20,0)
 ;       use Clinc name if passed in for the new field Clinic or
"RTN","PSBMD",21,0)
 ;        assume Ward and get ien.
"RTN","PSBMD",22,0)
 ;
"RTN","PSBMD",23,0)
RPC(RESULTS,PSBDFN,PSBDRUG,PSBDOSE,PSBRSN,PSBADMIN,PSBNEED,PSBUID,PSBON,PSBSCHD,PSBCLIN,PSBCLNIEN) ;
"RTN","PSBMD",24,0)
 ;
"RTN","PSBMD",25,0)
 ; RPC: PSB SUBMIT MISSING DOSE
"RTN","PSBMD",26,0)
 ;
"RTN","PSBMD",27,0)
 ; Description:
"RTN","PSBMD",28,0)
 ; Allows the client to submit a missing dose interactively
"RTN","PSBMD",29,0)
 ;
"RTN","PSBMD",30,0)
 N DFN,PSBNOW,PSBFDA,PSBIENS,PSBMD,PSBMSG
"RTN","PSBMD",31,0)
 S PSBCLNIEN=+$G(PSBCLNIEN)    ;*70 insure numeric
"RTN","PSBMD",32,0)
 D NEW(.PSBMD)
"RTN","PSBMD",33,0)
 I +PSBMD(0)<1 S RESULTS(0)="-1^Unable to create missing dose request"  Q
"RTN","PSBMD",34,0)
 S PSBIENS=+PSBMD(0)_","
"RTN","PSBMD",35,0)
 D NOW^%DTC S PSBNOW=%
"RTN","PSBMD",36,0)
 S PSBFDA(53.68,PSBIENS,.02)=PSBNOW
"RTN","PSBMD",37,0)
 S PSBFDA(53.68,PSBIENS,.03)=DUZ
"RTN","PSBMD",38,0)
 S PSBFDA(53.68,PSBIENS,.04)=DUZ(2)
"RTN","PSBMD",39,0)
 S PSBFDA(53.68,PSBIENS,.11)=PSBDFN
"RTN","PSBMD",40,0)
 ; Ward or Clinic - use Clinic name if passed, else get Ward ien.  *70
"RTN","PSBMD",41,0)
 I PSBCLIN]"" D
"RTN","PSBMD",42,0)
 .S PSBFDA(53.68,PSBIENS,1)=PSBCLNIEN
"RTN","PSBMD",43,0)
 E  D
"RTN","PSBMD",44,0)
 .S X=$G(^DPT(PSBDFN,.1))
"RTN","PSBMD",45,0)
 .I X]"" S X=$O(^DIC(42,"B",X,0)) S:X PSBFDA(53.68,PSBIENS,.12)=X
"RTN","PSBMD",46,0)
 .S DFN=PSBDFN D IN5^VADPT S PSBFDA(53.68,PSBIENS,.18)=$P(VAIP(6),U,1)
"RTN","PSBMD",47,0)
 S PSBFDA(53.68,PSBIENS,.13)=PSBDRUG
"RTN","PSBMD",48,0)
 S PSBFDA(53.68,PSBIENS,.14)=PSBDOSE
"RTN","PSBMD",49,0)
 S PSBFDA(53.68,PSBIENS,.15)=PSBRSN
"RTN","PSBMD",50,0)
 S PSBFDA(53.68,PSBIENS,.16)=PSBADMIN
"RTN","PSBMD",51,0)
 S PSBFDA(53.68,PSBIENS,.17)=PSBNEED
"RTN","PSBMD",52,0)
 S PSBFDA(53.68,PSBIENS,.19)=PSBSCHD
"RTN","PSBMD",53,0)
 S PSBFDA(53.68,PSBIENS,.25)=PSBUID
"RTN","PSBMD",54,0)
 D FILE^DIE("","PSBFDA","PSBMSG")
"RTN","PSBMD",55,0)
 L +^PSB(53.68,+PSBIENS):$S($G(DILOCKTM)>0:DILOCKTM,1:3)  ; PSB*3*23
"RTN","PSBMD",56,0)
 I $G(PSBUID)'="" D
"RTN","PSBMD",57,0)
 .D PSJ1^PSBVT(PSBDFN,PSBON) K PSBADA,PSBSOLA
"RTN","PSBMD",58,0)
 .I '$D(PSBUIDA(PSBUID)) F  D PSJ1^PSBVT(PSBDFN,PSBPONX) K PSBADA,PSBSOLA Q:$D(PSBUIDA(PSBUID))  Q:PSBPONX=""
"RTN","PSBMD",59,0)
 .F I=1:1 S PSBAD=$P(PSBUIDA(PSBUID),U,I) Q:PSBAD=""  I PSBAD["ADD" S PSBADA($P(PSBAD,";",2))=""
"RTN","PSBMD",60,0)
 .I $D(PSBADA) S X="" F I=1:1 S X=$O(PSBADA(X)) Q:X=""  S PSBFDA(53.686,I_","_PSBIENS,.01)=X,^PSB(53.68,+PSBIENS,.6,I,0)=I
"RTN","PSBMD",61,0)
 .F I=1:1 S PSBSOL=$P(PSBUIDA(PSBUID),U,I) Q:PSBSOL=""  I PSBSOL["SOL" S PSBSOLA($P(PSBSOL,";",2))=""
"RTN","PSBMD",62,0)
 .I $D(PSBSOLA) S X="" F I=1:1 S X=$O(PSBSOLA(X)) Q:X=""  S PSBFDA(53.687,I_","_PSBIENS,.01)=X,^PSB(53.68,+PSBIENS,.7,I,0)=I
"RTN","PSBMD",63,0)
 I $G(PSBUID)="",$G(PSBDRUG)="" D
"RTN","PSBMD",64,0)
 .D PSJ1^PSBVT(PSBDFN,PSBON)
"RTN","PSBMD",65,0)
 .I $D(PSBADA) S X="" F I=1:1 S X=$O(PSBADA(X)) Q:X=""  S PSBFDA(53.686,I_","_PSBIENS,.01)=$P(PSBADA(X),U,2),^PSB(53.68,+PSBIENS,.6,I,0)=X
"RTN","PSBMD",66,0)
 .I $D(PSBSOLA) S X="" F I=1:1 S X=$O(PSBSOLA(X)) Q:X=""  S PSBFDA(53.687,I_","_PSBIENS,.01)=$P(PSBSOLA(X),U,2),^PSB(53.68,+PSBIENS,.7,I,0)=X
"RTN","PSBMD",67,0)
 D FILE^DIE("","PSBFDA","PSBMSG")
"RTN","PSBMD",68,0)
 L -^PSB(53.68,+PSBIENS) ; PSB83*23
"RTN","PSBMD",69,0)
 D SUBMIT(+PSBIENS)
"RTN","PSBMD",70,0)
 S RESULTS(0)="1^Missing Dose Submitted^"_+PSBIENS
"RTN","PSBMD",71,0)
 D CLEAN^PSBVT
"RTN","PSBMD",72,0)
 Q
"RTN","PSBMD",73,0)
 ;
"RTN","PSBMD",74,0)
XQ ; Called via Kernel Menus
"RTN","PSBMD",75,0)
 N PSBMD,PSBSAVE,DA,DIK,DR,DDSFILE,XMY,XMTEXT,XMSUB
"RTN","PSBMD",76,0)
 D NEW(.PSBMD)
"RTN","PSBMD",77,0)
 I +PSBMD(0)<1 W !,"Error: ",$P(PSBMD(0),U,2) S DIR(0)="E" D ^DIR Q
"RTN","PSBMD",78,0)
 S DA=+PSBMD(0),DR="[PSB MISSING DOSE REQUEST]",DDSFILE=53.68 D ^DDS
"RTN","PSBMD",79,0)
 W @IOF
"RTN","PSBMD",80,0)
 I 'PSBSAVE W !,"Cancelling Request..." S DIK="^PSB(53.68," D ^DIK W "Cancelled!"
"RTN","PSBMD",81,0)
 D:PSBSAVE SUBMIT(DA)
"RTN","PSBMD",82,0)
 Q
"RTN","PSBMD",83,0)
 ;
"RTN","PSBMD",84,0)
SUBMIT(DA) ; Submit Request to Pharmacy
"RTN","PSBMD",85,0)
 N PSBWRD,PSBMG,PSBPRT,CLIEN
"RTN","PSBMD",86,0)
 S PSBWRD=$P(^PSB(53.68,DA,.1),U,2)
"RTN","PSBMD",87,0)
 S PSBWRD=+$G(^DIC(42,+PSBWRD,44))
"RTN","PSBMD",88,0)
 I PSBCLIN]"" S CLIEN=+$O(^PS(53.46,"B",PSBCLNIEN,""))
"RTN","PSBMD",89,0)
 ;
"RTN","PSBMD",90,0)
 ; Get Mail Group
"RTN","PSBMD",91,0)
 ;
"RTN","PSBMD",92,0)
 S PSBMG=$$GET^XPAR(PSBWRD_";SC(","PSB MG MISSING DOSE",,"E")
"RTN","PSBMD",93,0)
 S:PSBMG="" PSBMG=$$GET^XPAR("DIV","PSB MG MISSING DOSE",,"E")
"RTN","PSBMD",94,0)
 S $P(^PSB(53.68,DA,0),U,5)=PSBMG ; Add MG to notification
"RTN","PSBMD",95,0)
 ;
"RTN","PSBMD",96,0)
 ; Get Printer - If NO printer can be found, then DO NOT print!!
"RTN","PSBMD",97,0)
 ;*70 - get CO printer if Clinic orders, else IM med & get IM printer
"RTN","PSBMD",98,0)
 ; IM printer uses Variable PSB PRINTER MISSING DOSE
"RTN","PSBMD",99,0)
 ; CO printer can come from 3 sources:
"RTN","PSBMD",100,0)
 ;  1st from Clinic Defintion file for the specific Clinic if defined
"RTN","PSBMD",101,0)
 ;  2nd from the Variable PSB PRINTER CO MISSING DOSE if defined
"RTN","PSBMD",102,0)
 ;  3rd just use the IM med printer Variable.
"RTN","PSBMD",103,0)
 ;
"RTN","PSBMD",104,0)
 D:PSBCLIN]""                                             ;*70
"RTN","PSBMD",105,0)
 .S PSBPRT=$$GET1^DIQ(53.46,CLIEN,4)
"RTN","PSBMD",106,0)
 .S:PSBPRT="" PSBPRT=$$GET^XPAR("DIV","PSB PRINTER CO MISSING DOSE",,"E")
"RTN","PSBMD",107,0)
 .S:PSBPRT="" PSBPRT=$$GET^XPAR("DIV","PSB PRINTER MISSING DOSE",,"E")
"RTN","PSBMD",108,0)
 D:PSBCLIN=""                                             ;*70
"RTN","PSBMD",109,0)
 .S PSBPRT=$$GET^XPAR(PSBWRD_";SC(","PSB PRINTER MISSING DOSE",,"E")
"RTN","PSBMD",110,0)
 .S:PSBPRT="" PSBPRT=$$GET^XPAR("DIV","PSB PRINTER MISSING DOSE",,"E")
"RTN","PSBMD",111,0)
 ;
"RTN","PSBMD",112,0)
 S $P(^PSB(53.68,DA,0),U,6)=PSBPRT ; Add MG to notification
"RTN","PSBMD",113,0)
 ;
"RTN","PSBMD",114,0)
 ; Send the report to the specified printer
"RTN","PSBMD",115,0)
 ;
"RTN","PSBMD",116,0)
 D:PSBPRT]""
"RTN","PSBMD",117,0)
 .W !,"Submitting Request To Pharmacy on device ",PSBPRT,"..."
"RTN","PSBMD",118,0)
 .D NOW^%DTC
"RTN","PSBMD",119,0)
 .S ZTIO=PSBPRT
"RTN","PSBMD",120,0)
 .S ZTDTH=%
"RTN","PSBMD",121,0)
 .S ZTDESC="BCMA - MISSING DOSE REQUEST"
"RTN","PSBMD",122,0)
 .S ZTRTN="DQ^PSBMD("_DA_")"
"RTN","PSBMD",123,0)
 .D ^%ZTLOAD
"RTN","PSBMD",124,0)
 .W "Done!"
"RTN","PSBMD",125,0)
 ;
"RTN","PSBMD",126,0)
 ; Send the same stuff to the mail group
"RTN","PSBMD",127,0)
 ;
"RTN","PSBMD",128,0)
 D:PSBMG]""
"RTN","PSBMD",129,0)
 .W !,"Notifying Pharmacy via Mail Group ",PSBMG,"..."
"RTN","PSBMD",130,0)
 .D HFSOPEN^PSBUTL("MISSING DOSE")
"RTN","PSBMD",131,0)
 .U IO D DQ(DA,1)
"RTN","PSBMD",132,0)
 .D HFSCLOSE^PSBUTL("MISSING DOSE")
"RTN","PSBMD",133,0)
 .S XMY("G."_PSBMG)="",XMTEXT="^TMP(""PSBO"",$J,"
"RTN","PSBMD",134,0)
 .S XMSUB="BCMA - Missing Dose Request"
"RTN","PSBMD",135,0)
 .D ^XMD
"RTN","PSBMD",136,0)
 .W "Done!"
"RTN","PSBMD",137,0)
 Q
"RTN","PSBMD",138,0)
 ;
"RTN","PSBMD",139,0)
DQ(PSBMD,PSBMM) ; Dequeue report from Taskman
"RTN","PSBMD",140,0)
 N PSBFLD,PSBRET
"RTN","PSBMD",141,0)
 Q:'$D(^PSB(53.68,PSBMD,0))
"RTN","PSBMD",142,0)
 L +^PSB(53.68,PSBMD):$S($G(DILOCKTM)>0:DILOCKTM,1:3) ; PSB*3*23
"RTN","PSBMD",143,0)
 S PSBCFLD=$P(^PSB(53.68,PSBMD,.1),U,3)
"RTN","PSBMD",144,0)
 L -^PSB(53.68,PSBMD) ; PSB*3*23
"RTN","PSBMD",145,0)
 D:'$G(PSBMM)  ; It is not a mail message
"RTN","PSBMD",146,0)
 .W !,$TR($J("",75)," ","=")
"RTN","PSBMD",147,0)
 .W !,"Report:       MISSING DOSE REQUEST"
"RTN","PSBMD",148,0)
 .W !,"Date Created: " D NOW^%DTC S Y=% D D^DIQ W Y
"RTN","PSBMD",149,0)
 .W !,$TR($J("",75)," ","="),!
"RTN","PSBMD",150,0)
 I $G(PSBCFLD)'="" F PSBFLD=.01,.02,.03,.04,.05,.06,.11,.12,.18,1,.13,.14,.19,.15,.16,.17 D OUT  ;*70
"RTN","PSBMD",151,0)
 I $G(PSBCFLD)="" F PSBFLD=.01,.02,.03,.04,.05,.06,.11,.12,.18,1,.25,.15,.19,.16,.17 D OUT  ;*70
"RTN","PSBMD",152,0)
 I $D(^PSB(53.68,PSBMD,.6)) S X=0 F  S X=$O(^PSB(53.68,PSBMD,.6,X)) Q:'X  W !?3,"ADDITIVE:  ",$$GET1^DIQ(52.6,+^PSB(53.68,PSBMD,.6,X,0),.01)
"RTN","PSBMD",153,0)
 I $D(^PSB(53.68,PSBMD,.7)) S X=0 F  S X=$O(^PSB(53.68,PSBMD,.7,X)) Q:'X  W !?3,"SOLUTION:  ",$$GET1^DIQ(52.7,+^PSB(53.68,PSBMD,.7,X,0),.01)
"RTN","PSBMD",154,0)
 Q
"RTN","PSBMD",155,0)
OUT ;
"RTN","PSBMD",156,0)
 D FIELD^DID(53.68,PSBFLD,"","LABEL","PSBRET")
"RTN","PSBMD",157,0)
 W !?3,PSBRET("LABEL"),":" F  Q:$X>30  W "."
"RTN","PSBMD",158,0)
 W $$GET1^DIQ(53.68,PSBMD_",",PSBFLD)
"RTN","PSBMD",159,0)
 I PSBFLD=.11 D
"RTN","PSBMD",160,0)
 .N DFN,VA,VADM S DFN=$$GET1^DIQ(53.68,PSBMD_",",.11,"I") D DEM^VADPT
"RTN","PSBMD",161,0)
 .W !?3,$$GET^XPAR("ALL","PSB PATIENT ID LABEL")
"RTN","PSBMD",162,0)
 .I $G(DUZ("AG"))="I" D
"RTN","PSBMD",163,0)
 ..W ":" F  Q:$X>30  W "."
"RTN","PSBMD",164,0)
 .E  D
"RTN","PSBMD",165,0)
 ..W " (LAST 4 NUMBERS):" F  Q:$X>30  W "."
"RTN","PSBMD",166,0)
 .W VA("BID")
"RTN","PSBMD",167,0)
 W:PSBFLD=.13 " ("_$P($G(^PSB(53.68,PSBMD,.1)),U,3)_")"
"RTN","PSBMD",168,0)
 S ZTREQ="@"
"RTN","PSBMD",169,0)
 Q
"RTN","PSBMD",170,0)
 ;
"RTN","PSBMD",171,0)
NEW(RESULTS) ; Create a new missing dose request
"RTN","PSBMD",172,0)
 ; Called interactively and via RPCBroker
"RTN","PSBMD",173,0)
 N DIC
"RTN","PSBMD",174,0)
 K RESULTS
"RTN","PSBMD",175,0)
 I '+$G(DUZ) S RESULTS(0)="-1^Undefined User" Q
"RTN","PSBMD",176,0)
 I '$G(DUZ(2)) S RESULTS(0)="-1^Undefined Division" Q
"RTN","PSBMD",177,0)
 ; Lock Log
"RTN","PSBMD",178,0)
 L +^PSB(53.68,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3)
"RTN","PSBMD",179,0)
 E  S RESULTS(0)="-1^Request Log Locked" Q
"RTN","PSBMD",180,0)
 ; Generate Unique Entry and Create
"RTN","PSBMD",181,0)
 F  D NOW^%DTC S X=$E(%_"000000",1,14),X=(1700+$E(X,1,3))_$E(X,4,14),X="MD-"_$TR(X,".","-") Q:'$D(^PSB(53.68,"B",X))
"RTN","PSBMD",182,0)
 S DIC="^PSB(53.68,",DIC(0)="L"
"RTN","PSBMD",183,0)
 S DIC("DR")=".02///N;.03////^S X=DUZ;.04////^S X=DUZ(2);.07///1"
"RTN","PSBMD",184,0)
 K D0         ;VRN
"RTN","PSBMD",185,0)
 D FILE^DICN
"RTN","PSBMD",186,0)
 L -^PSB(53.68,0)
"RTN","PSBMD",187,0)
 ; Okay, setup return and Boogie
"RTN","PSBMD",188,0)
 I +Y<1 S RESULTS(0)="-1^Error Creating Request"
"RTN","PSBMD",189,0)
 E  S RESULTS(0)=Y
"RTN","PSBMD",190,0)
 Q
"RTN","PSBMD",191,0)
 ;
"RTN","PSBMD",192,0)
VAL(PSBFLDS) ; Validate that fields in PSBFLDS are filled in
"RTN","PSBMD",193,0)
 N PSB,PSBFLD,PSBMSG
"RTN","PSBMD",194,0)
 F PSB=1:1 Q:$P(PSBFLDS,";",PSB)=""  S PSBFLD=$P(PSBFLDS,";",PSB),PSBFLD(PSBFLD)=$$GET^DDSVAL(53.68,DA,PSBFLD)
"RTN","PSBMD",195,0)
 I $D(PSBFLD(.21)) K:PSBFLD(.21)="N" PSBFLD(.22),PSBFLD(.23)
"RTN","PSBMD",196,0)
 S PSB=""  F  S PSB=$O(PSBFLD(PSB)) Q:PSB=""  D:PSBFLD(PSB)=""
"RTN","PSBMD",197,0)
 .I '$D(PSBMSG) S PSBMSG(0)="UNABLE TO FILE REQUEST",PSBMSG(1)=" ",PSBMSG(2)="ERROR: MISSING DATA - ALL FIELDS ARE REQUIRED"
"RTN","PSBMD",198,0)
 .D FIELD^DID(53.68,PSB,"","TITLE;LABEL","PSB")
"RTN","PSBMD",199,0)
 .S X="  Missing Field: "_$S(PSB("TITLE")]"":PSB("TITLE"),1:PSB("LABEL")),PSBMSG($O(PSBMSG(""),-1)+1)=X
"RTN","PSBMD",200,0)
 Q:'$D(PSBMSG)  ; All is well
"RTN","PSBMD",201,0)
 D MSG^DDSUTL(.PSBMSG)
"RTN","PSBMD",202,0)
 S DDSERROR=1
"RTN","PSBMD",203,0)
 Q
"RTN","PSBMD",204,0)
 ;
"RTN","PSBMD",205,0)
CHK1 ; Start PSB*3*100 changes: use 'DIVAS' cross ref for multidivision sites
"RTN","PSBMD",206,0)
 ; DUZ(2), the user's division, is set at sign-on. At multidivision sites where a user has access
"RTN","PSBMD",207,0)
 ; to multiple divisions, allow selection of a division from the divisions defined in file #40.8.
"RTN","PSBMD",208,0)
 ; The user must have at least one division from file #40.8 in his file #200 record.
"RTN","PSBMD",209,0)
 K ^TMP("PSBMD",$J)
"RTN","PSBMD",210,0)
 N DIR
"RTN","PSBMD",211,0)
 W !
"RTN","PSBMD",212,0)
 S DIR(0)="SB^A:All Divisions;O:One Division"
"RTN","PSBMD",213,0)
 S DIR("?")="Select either All Divisions or One Division."
"RTN","PSBMD",214,0)
 S DIR("A")="Do you want (A)ll Divisions or just (O)ne Division"
"RTN","PSBMD",215,0)
 S DIR("B")="O"
"RTN","PSBMD",216,0)
 D ^DIR K DIR I $D(DUOUT)!$D(DTOUT)!$D(DIROUT)!$D(DIRUT) Q
"RTN","PSBMD",217,0)
 I Y="" Q
"RTN","PSBMD",218,0)
 I Y(0)="One Division" D ONE Q   ; regardless user divisions in file #200
"RTN","PSBMD",219,0)
 I Y(0)="All Divisions" D ALL Q
"RTN","PSBMD",220,0)
 Q
"RTN","PSBMD",221,0)
 ;
"RTN","PSBMD",222,0)
ALL ; user gets all divisions (current behavior); applicable to single division sites as well
"RTN","PSBMD",223,0)
 S Y(0)="All Divisions"
"RTN","PSBMD",224,0)
 S PSBDIV=DUZ(2)
"RTN","PSBMD",225,0)
 S PSBSTIEN=+$O(^DG(40.8,"AD",DUZ(2),"")) ; current IEN for station
"RTN","PSBMD",226,0)
 S Y=$$GET1^DIQ(40.8,PSBSTIEN,.01,"E")
"RTN","PSBMD",227,0)
 I '$D(Y) S Y=DUZ(2)
"RTN","PSBMD",228,0)
 S PSBNAME=$$NAME^XUAF4(DUZ(2))
"RTN","PSBMD",229,0)
 S PSBMUDV=0
"RTN","PSBMD",230,0)
 S ^TMP("PSBMD",$J)=PSBMUDV_U_PSBDIV_U_PSBNAME
"RTN","PSBMD",231,0)
 Q
"RTN","PSBMD",232,0)
 ;
"RTN","PSBMD",233,0)
ONE ; when user selects one division from many in file #200, look at file #40.8 for a match if available
"RTN","PSBMD",234,0)
 W !
"RTN","PSBMD",235,0)
 S PSBSTIEN=+$O(^DG(40.8,"AD",DUZ(2),"")) ; current IEN for station
"RTN","PSBMD",236,0)
 S PSBDVNM=$$GET1^DIQ(40.8,PSBSTIEN,.01,"I") ;division name
"RTN","PSBMD",237,0)
 S DIC("B")=PSBDVNM
"RTN","PSBMD",238,0)
 S DIC("A")="Select Division: ",DIC="^DG(40.8,",DIC(0)="AEMQ",DIC("S")="I $$SITE^VASITE(,+Y)>0"
"RTN","PSBMD",239,0)
 D ^DIC
"RTN","PSBMD",240,0)
 ; capture the division name and number after user selection
"RTN","PSBMD",241,0)
 S PSBNAME=$$GET1^DIQ(40.8,+Y,.01,"E")
"RTN","PSBMD",242,0)
 S PSBDPTR=$$GET1^DIQ(40.8,+Y,.07,"I") ; pointer to file #4
"RTN","PSBMD",243,0)
 S PSBDIV=PSBDPTR
"RTN","PSBMD",244,0)
 S ^TMP("PSBMD",$J)=PSBMUDV_U_PSBDIV_U_PSBNAME
"RTN","PSBMD",245,0)
 Q
"RTN","PSBMD",246,0)
 ;end of changes for PSB*3*100
"RTN","PSBMD",247,0)
 ;
"RTN","PSBMD",248,0)
FLWUP ; Follow-Up on missing dose
"RTN","PSBMD",249,0)
 ; start PSB*3*100 changes
"RTN","PSBMD",250,0)
 N D0,DIC,PSBDATA,PSBDPTR,PSBDIV,PSBDVNM,PSBNAME,PSBMUDV,PSBSTIEN,X,Y
"RTN","PSBMD",251,0)
 S D0=1,PSBMUDV=$S($$GET1^DIQ(43,D0,11,"I")=1:1,1:0)
"RTN","PSBMD",252,0)
 I $P($G(^VA(200,DUZ,2,0)),U,4)=0 W !!,$C(7),"You have no valid divisions in the NEW PERSON file." S Y="^" Q
"RTN","PSBMD",253,0)
 I '$O(^DG(40.8,"AD",DUZ(2),"")) W !!,$C(7),"Your NEW PERSON file division was not found in the MEDICAL CENTER DIVISION file." S Y="^" Q
"RTN","PSBMD",254,0)
 I PSBMUDV=1 D CHK1
"RTN","PSBMD",255,0)
 I PSBMUDV=0 D ALL
"RTN","PSBMD",256,0)
 I Y=""!(Y<0)!(Y="^") Q
"RTN","PSBMD",257,0)
 S PSBDIV=$P($G(^TMP("PSBMD",$J)),U,2)
"RTN","PSBMD",258,0)
 S PSBNAME=$P($G(^TMP("PSBMD",$J)),U,3)
"RTN","PSBMD",259,0)
 ; end of changes for PSB*3*100
"RTN","PSBMD",260,0)
 N DIR,PSBIEN,PSBX,DA,DR,DDSFILE,PSBHDR,PSBDRUG,LOC            ;*70
"RTN","PSBMD",261,0)
 S Y="" F  Q:Y="^"  D
"RTN","PSBMD",262,0)
 .K ^TMP("PSB",$J) S X=""
"RTN","PSBMD",263,0)
 .;start PSB*3*100 changes: user did not select one division and will see all the records (single station functionality)
"RTN","PSBMD",264,0)
 .I $G(PSBMUDV)=0 D
"RTN","PSBMD",265,0)
 ..F  S X=$O(^PSB(53.68,"AS",1,X),-1) Q:'X  S Y=$O(^TMP("PSB",$J,""),-1)+1,^TMP("PSB",$J,Y)=X,^TMP("PSB",$J,0)=Y
"RTN","PSBMD",266,0)
 .;
"RTN","PSBMD",267,0)
 .; user selected one division
"RTN","PSBMD",268,0)
 .I $G(PSBMUDV)=1 D
"RTN","PSBMD",269,0)
 ..F  S X=$O(^PSB(53.68,"DIVAS",1,PSBDIV,X),-1) Q:'X  S Y=$O(^TMP("PSB",$J,""),-1)+1,^TMP("PSB",$J,Y)=X,^TMP("PSB",$J,0)=Y
"RTN","PSBMD",270,0)
 .;
"RTN","PSBMD",271,0)
 .I '$O(^TMP("PSB",$J,0)) W !!,"No Unresolved Missing Dose Requests Found." S Y="^" Q
"RTN","PSBMD",272,0)
 .I $G(PSBMUDV)=0 S PSBHDR="Currently Unresolved Missing Dose Requests"
"RTN","PSBMD",273,0)
 .I $G(PSBMUDV)=1 S PSBHDR="Currently Unresolved Missing Dose Requests for: "_PSBNAME
"RTN","PSBMD",274,0)
 .;end of changes for PSB*3*100
"RTN","PSBMD",275,0)
 .W @IOF,PSBHDR,!,$TR($J("",IOM)," ","-")
"RTN","PSBMD",276,0)
 .F PSBX=0:0 S PSBX=$O(^TMP("PSB",$J,PSBX)) Q:'PSBX!(Y="^")  S PSBIEN=^(PSBX)_"," D
"RTN","PSBMD",277,0)
 ..W !,$J(PSBX,2),". ",$$GET1^DIQ(53.68,PSBIEN,.01)
"RTN","PSBMD",278,0)
 ..W ?25,$$GET1^DIQ(53.68,PSBIEN,.11)
"RTN","PSBMD",279,0)
 ..; get correct location                                     ;*70
"RTN","PSBMD",280,0)
 ..S LOC=$S($$GET1^DIQ(53.68,PSBIEN,1)]"":$$GET1^DIQ(53.68,PSBIEN,1),1:$$GET1^DIQ(53.68,PSBIEN,.12))
"RTN","PSBMD",281,0)
 ..W ?57,LOC                                                  ;*70
"RTN","PSBMD",282,0)
 ..S PSBDRUG=$$GET1^DIQ(53.68,PSBIEN,.13)
"RTN","PSBMD",283,0)
 ..I PSBDRUG]"" W !?5,PSBDRUG
"RTN","PSBMD",284,0)
 ..I PSBDRUG="" D
"RTN","PSBMD",285,0)
 ...W !?5,"UNIQUE ID: ",$$GET1^DIQ(53.68,PSBIEN,.25)
"RTN","PSBMD",286,0)
 ...S X=0 F  S X=$O(^PSB(53.68,+PSBIEN,.6,X)) Q:'X  W !?10,"ADDITIVES:  ",$$GET1^DIQ(52.6,+^PSB(53.68,+PSBIEN,.6,X,0),.01)
"RTN","PSBMD",287,0)
 ...S X=0 F  S X=$O(^PSB(53.68,+PSBIEN,.7,X)) Q:'X  W !?10,"SOLUTIONS:  ",$$GET1^DIQ(52.7,+^PSB(53.68,+PSBIEN,.7,X,0),.01)
"RTN","PSBMD",288,0)
 ..S:$Y>(IOSL-4) Y=$$PAGE(PSBX)
"RTN","PSBMD",289,0)
 .S:Y'="^" Y=$$PAGE(PSBX)
"RTN","PSBMD",290,0)
 K ^TMP("PSB",$J),^TMP("PSBMD",$J) ; PSB*3*100
"RTN","PSBMD",291,0)
 Q
"RTN","PSBMD",292,0)
 ;
"RTN","PSBMD",293,0)
PAGE(PSBIX) ;
"RTN","PSBMD",294,0)
 ;
"RTN","PSBMD",295,0)
 N X,X1,PSBCX,PSBDX
"RTN","PSBMD",296,0)
 S DIR("A")="Select Missing Dose Request # (<RET> to continue, '^' to quit)"
"RTN","PSBMD",297,0)
 I PSBIX="" S DIR("A")="Select Missing Dose Request # (<RET> or '^' to quit)"
"RTN","PSBMD",298,0)
 S DIR(0)="NO^1:"_$S(PSBIX="":$O(^TMP("PSB",$J,PSBX),-1),1:PSBIX)_":0"
"RTN","PSBMD",299,0)
 D ^DIR S PSBDX=+Y
"RTN","PSBMD",300,0)
 I PSBIX="",Y="" S Y="^" Q Y
"RTN","PSBMD",301,0)
 I $G(DTOUT) S Y="^" Q Y
"RTN","PSBMD",302,0)
 I Y="^" Q Y
"RTN","PSBMD",303,0)
 I Y="" W @IOF,PSBHDR,!,$TR($J("",IOM)," ","-") Q Y
"RTN","PSBMD",304,0)
 S (DA,PSBCX)=^TMP("PSB",$J,+Y),DR="[PSB MISSING DOSE FOLLOWUP]",DDSFILE=53.68
"RTN","PSBMD",305,0)
 D  Q Y
"RTN","PSBMD",306,0)
 .D ^DDS
"RTN","PSBMD",307,0)
 .; start changes for PSB*3*100
"RTN","PSBMD",308,0)
 .I $G(PSBMUDV)=0,$D(^PSB(53.68,"AS",0,PSBCX)) K ^TMP("PSB",$J) S X="" F  S X=$O(^PSB(53.68,"AS",1,X),-1) Q:'X  S X1=$O(^TMP("PSB",$J,""),-1)+1,^TMP("PSB",$J,X1)=X,^TMP("PSB",$J,0)=X1
"RTN","PSBMD",309,0)
 .I $G(PSBMUDV)=1,$D(^PSB(53.68,"DIVAS",0,PSBCX)) K ^TMP("PSB",$J) S X="" F  S X=$O(^PSB(53.68,"DIVAS",1,PSBDIV,X),-1) Q:'X  S X1=$O(^TMP("PSB",$J,""),-1)+1,^TMP("PSB",$J,X1)=X,^TMP("PSB",$J,0)=X1
"RTN","PSBMD",310,0)
 .; stop printing header twice (old bug) by checking PSBX before setting it to zero.
"RTN","PSBMD",311,0)
 .I PSBX>0 S PSBX=0 W @IOF,PSBHDR,!,$TR($J("",IOM)," ","-")
"RTN","PSBMD",312,0)
 ; end of changes for PSB*3*100
"RTN","PSBMD",313,0)
 ;
"RTN","PSBMD",314,0)
POST ;call from 'Patient' field of screenman form PSB MISSING DOSE REQUEST
"RTN","PSBMD",315,0)
 ; 
"RTN","PSBMD",316,0)
 N DFN
"RTN","PSBMD",317,0)
 S DFN=X D IN5^VADPT
"RTN","PSBMD",318,0)
 D PUT^DDSVAL(DIE,.DA,.12,$P(VAIP(5),U,2))  ; value of DIE is 53.68, BCMA MISSING DOSE REQUEST FILE called from ScreenMan
"RTN","PSBMD",319,0)
 D PUT^DDSVAL(DIE,.DA,.18,$P(VAIP(6),U,1),"","I")  ; value of DIE is 53.68, BCMA MISSING DOSE REQUEST FILE called from ScreenMan
"RTN","PSBMD",320,0)
 D REFRESH^DDSUTL
"RTN","PSBMD",321,0)
 Q
"VER")
8.0^22.2
"^DD",53.68,53.68,.04,0)
DIVISION^P4'^DIC(4,^0;4^Q
"^DD",53.68,53.68,.04,3)
Select an institution.
"^DD",53.68,53.68,.04,21,0)
^^2^2^2990731^^^
"^DD",53.68,53.68,.04,21,1,0)
Automatically stuffed at record creation time with the current value of
"^DD",53.68,53.68,.04,21,2,0)
DUZ(2).
"^DD",53.68,53.68,.04,"DT")
3170419
"^DD",53.68,53.68,.07,0)
STATUS^S^0:CLOSED;1:UNRESOLVED;^0;7^Q
"^DD",53.68,53.68,.07,1,0)
^.1^^-1
"^DD",53.68,53.68,.07,1,1,0)
53.68^AS
"^DD",53.68,53.68,.07,1,1,1)
S ^PSB(53.68,"AS",$E(X,1,30),DA)=""
"^DD",53.68,53.68,.07,1,1,2)
K ^PSB(53.68,"AS",$E(X,1,30),DA)
"^DD",53.68,53.68,.07,1,1,"DT")
2990408
"^DD",53.68,53.68,.07,3)
Enter 0 or CLOSED if the request has been closed. Enter 1 or UNRESOLVED for a new request.
"^DD",53.68,53.68,.07,5,1,0)
53.68^.24^1
"^DD",53.68,53.68,.07,21,0)
^^1^1^2990731^
"^DD",53.68,53.68,.07,21,1,0)
Status of the request as Closed or Unresolved.
"^DD",53.68,53.68,.07,"DT")
3170419
"BLD",10173,6)
^87
**END**
**END**

