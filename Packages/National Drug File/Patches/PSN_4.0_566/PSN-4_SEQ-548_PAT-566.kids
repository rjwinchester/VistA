Released PSN*4*566 SEQ #548
Extracted from mail message
**KIDS**:PSN*4.0*566^

**INSTALL NAME**
PSN*4.0*566
"BLD",10975,0)
PSN*4.0*566^NATIONAL DRUG FILE^0^3181127^y
"BLD",10975,1,0)
^^2^2^3181119^^
"BLD",10975,1,1,0)
The description of this build can be found in the National Patch Module 
"BLD",10975,1,2,0)
under PSN*4*566.
"BLD",10975,4,0)
^9.64PA^^
"BLD",10975,6.3)
2
"BLD",10975,"ABPKG")
n
"BLD",10975,"INID")
^y
"BLD",10975,"INIT")
POST^PSN566PO
"BLD",10975,"KRN",0)
^9.67PA^1.61^23
"BLD",10975,"KRN",.4,0)
.4
"BLD",10975,"KRN",.401,0)
.401
"BLD",10975,"KRN",.402,0)
.402
"BLD",10975,"KRN",.403,0)
.403
"BLD",10975,"KRN",.5,0)
.5
"BLD",10975,"KRN",.84,0)
.84
"BLD",10975,"KRN",1.6,0)
1.6
"BLD",10975,"KRN",1.61,0)
1.61
"BLD",10975,"KRN",1.62,0)
1.62
"BLD",10975,"KRN",3.6,0)
3.6
"BLD",10975,"KRN",3.8,0)
3.8
"BLD",10975,"KRN",9.2,0)
9.2
"BLD",10975,"KRN",9.8,0)
9.8
"BLD",10975,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",10975,"KRN",9.8,"NM",1,0)
PSNPPSNU^^0^B51460995
"BLD",10975,"KRN",9.8,"NM","B","PSNPPSNU",1)

"BLD",10975,"KRN",19,0)
19
"BLD",10975,"KRN",19.1,0)
19.1
"BLD",10975,"KRN",101,0)
101
"BLD",10975,"KRN",409.61,0)
409.61
"BLD",10975,"KRN",771,0)
771
"BLD",10975,"KRN",779.2,0)
779.2
"BLD",10975,"KRN",870,0)
870
"BLD",10975,"KRN",8989.51,0)
8989.51
"BLD",10975,"KRN",8989.52,0)
8989.52
"BLD",10975,"KRN",8994,0)
8994
"BLD",10975,"KRN","B",.4,.4)

"BLD",10975,"KRN","B",.401,.401)

"BLD",10975,"KRN","B",.402,.402)

"BLD",10975,"KRN","B",.403,.403)

"BLD",10975,"KRN","B",.5,.5)

"BLD",10975,"KRN","B",.84,.84)

"BLD",10975,"KRN","B",1.6,1.6)

"BLD",10975,"KRN","B",1.61,1.61)

"BLD",10975,"KRN","B",1.62,1.62)

"BLD",10975,"KRN","B",3.6,3.6)

"BLD",10975,"KRN","B",3.8,3.8)

"BLD",10975,"KRN","B",9.2,9.2)

"BLD",10975,"KRN","B",9.8,9.8)

"BLD",10975,"KRN","B",19,19)

"BLD",10975,"KRN","B",19.1,19.1)

"BLD",10975,"KRN","B",101,101)

"BLD",10975,"KRN","B",409.61,409.61)

"BLD",10975,"KRN","B",771,771)

"BLD",10975,"KRN","B",779.2,779.2)

"BLD",10975,"KRN","B",870,870)

"BLD",10975,"KRN","B",8989.51,8989.51)

"BLD",10975,"KRN","B",8989.52,8989.52)

"BLD",10975,"KRN","B",8994,8994)

"BLD",10975,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",10975,"QUES",0)
^9.62^^
"BLD",10975,"REQB",0)
^9.611^1^1
"BLD",10975,"REQB",1,0)
PSN*4.0*563^1
"BLD",10975,"REQB","B","PSN*4.0*563",1)

"INIT")
POST^PSN566PO
"MBREQ")
0
"PKG",163,-1)
1^1
"PKG",163,0)
NATIONAL DRUG FILE^PSN^This is the National Drug File Package V 3.14
"PKG",163,22,0)
^9.49I^1^1
"PKG",163,22,1,0)
4.0^2981030^2981221^1
"PKG",163,22,1,"PAH",1,0)
566^3181127
"PKG",163,22,1,"PAH",1,1,0)
^^2^2^3181127
"PKG",163,22,1,"PAH",1,1,1,0)
The description of this build can be found in the National Patch Module 
"PKG",163,22,1,"PAH",1,1,2,0)
under PSN*4*566.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSN566PO")
0^^B7846893^n/a
"RTN","PSN566PO",1,0)
PSN566PO ;BIR/SJA-Post install routine for patch PSN*4*566 ; 02 Aug 2018  2:00 PM
"RTN","PSN566PO",2,0)
 ;;4.0;NATIONAL DRUG FILE;**566**; 30 Oct 98;Build 2
"RTN","PSN566PO",3,0)
 ;
"RTN","PSN566PO",4,0)
 Q
"RTN","PSN566PO",5,0)
 ;
"RTN","PSN566PO",6,0)
POST ; entry point
"RTN","PSN566PO",7,0)
 N CNT,DATA,II,NAME,NODE1,PSNDA
"RTN","PSN566PO",8,0)
 S CNT=4 K ^TMP("PSN",$J)
"RTN","PSN566PO",9,0)
 D BMES^XPDUTL("  Starting post-install for PSN*4*566")
"RTN","PSN566PO",10,0)
 ;
"RTN","PSN566PO",11,0)
 D BMES^XPDUTL("Re-indexing the 'AQ1' of the CMOP ID field (#27) of the DRUG file (#50)...")
"RTN","PSN566PO",12,0)
 K ^PSDRUG("AQ1") K DIK S DIK="^PSDRUG(",DIK(1)="27^AQ1" D ENALL^DIK K DIK
"RTN","PSN566PO",13,0)
 ;
"RTN","PSN566PO",14,0)
 D BMES^XPDUTL("  Restore GCNSEQNO field for specific VA Products....")
"RTN","PSN566PO",15,0)
 F II=1:1 S DATA=$P($T(@("LIST+"_II_"^PSN566PO")),";;",2) Q:DATA=""  D
"RTN","PSN566PO",16,0)
 . S PSNDA=+DATA,NAME=$E($P($G(^PSNDF(50.68,PSNDA,0)),"^"),1,40),NODE1=$G(^PSNDF(50.68,PSNDA,1))
"RTN","PSN566PO",17,0)
 . I $D(^PSNDF(50.68,PSNDA,0)),'$P(NODE1,"^",5) S $P(^PSNDF(50.68,PSNDA,1),"^",5)=$E(1000000+$P(DATA,",",2),2,7) D
"RTN","PSN566PO",18,0)
 . . S CNT=CNT+1,^TMP("PSN",$J,CNT)=PSNDA_$J("",15-$L(PSNDA))_NAME_$J("",50-$L(NAME))_$E(1000000+$P(DATA,",",2),2,7)
"RTN","PSN566PO",19,0)
 D MSG K ^TMP("PSN",$J)
"RTN","PSN566PO",20,0)
 D BMES^XPDUTL("  Finished post-install for PSN*4*566")
"RTN","PSN566PO",21,0)
 Q
"RTN","PSN566PO",22,0)
 ;
"RTN","PSN566PO",23,0)
MSG ; Sends Mailman message about updates
"RTN","PSN566PO",24,0)
 N XMX,XMSUB,XMDUZ,XMTEXT
"RTN","PSN566PO",25,0)
 S II=0 F  S II=$O(^XUSEC("PSNMGR",II)) Q:'II  S XMY(II)=""
"RTN","PSN566PO",26,0)
 S XMY(DUZ)="",XMSUB="PSN*4*566 - GCNSEQNO field Update"
"RTN","PSN566PO",27,0)
 S ^TMP("PSN",$J,1)="The post-install routine restored the GCNSEQNO field value for the following VA PRODUCT entries:"
"RTN","PSN566PO",28,0)
 S ^TMP("PSN",$J,2)=""
"RTN","PSN566PO",29,0)
 S ^TMP("PSN",$J,3)="VA Product #   Product Name                                      GCNSEQNO   "
"RTN","PSN566PO",30,0)
 S ^TMP("PSN",$J,4)="------------   ----------------------------------------          --------"
"RTN","PSN566PO",31,0)
 S:'$D(^TMP("PSN",$J,5)) ^TMP("PSN",$J,5)="No updates performed."
"RTN","PSN566PO",32,0)
 S XMDUZ=.5,XMTEXT="^TMP(""PSN"",$J," N DIFROM D ^XMD
"RTN","PSN566PO",33,0)
 Q
"RTN","PSN566PO",34,0)
 ;
"RTN","PSN566PO",35,0)
LIST ; VA PRODUCT entries missing GCNSEQNO field
"RTN","PSN566PO",36,0)
 ;;5556,003242
"RTN","PSN566PO",37,0)
 ;;19980,062059
"RTN","PSN566PO",38,0)
 ;;21020,065368
"RTN","PSN566PO",39,0)
 ;;26849,074811
"RTN","PSN566PO",40,0)
 ;;7657,004247
"RTN","PSN566PO",41,0)
 ;;7658,004247
"RTN","PSN566PO",42,0)
 ;;15709,004053
"RTN","PSN566PO",43,0)
 ;;16451,003298
"RTN","PSN566PO",44,0)
 ;;25333,073234
"RTN","PSN566PO",45,0)
 ;;27516,077118
"RTN","PSN566PO",46,0)
 ;;27887,065744
"RTN","PSN566PO",47,0)
 ;;28658,064056
"RTN","PSN566PO",48,0)
 ;;28674,078605
"RTN","PSN566PO",49,0)
 ;;28238,047061
"RTN","PSN566PO",50,0)
 ;;1845,045155
"RTN","PSN566PO",51,0)
 ;;2473,008764
"RTN","PSN566PO",52,0)
 ;;8871,015612
"RTN","PSN566PO",53,0)
 ;;16385,051884
"RTN","PSN566PO",54,0)
 ;;18652,021444
"RTN","PSN566PO",55,0)
 ;;23735,070630
"RTN","PSN566PO",56,0)
 ;;25841,074409
"RTN","PSN566PO",57,0)
 ;;25843,074410
"RTN","PSN566PO",58,0)
 ;;26452,013648
"RTN","PSN566PO",59,0)
 ;;26453,013649
"RTN","PSN566PO",60,0)
 ;;3352,005154
"RTN","PSN566PO",61,0)
 ;;12622,064400
"RTN","PSN566PO",62,0)
 ;;27302,050831
"RTN","PSN566PO",63,0)
 ;;6105,048520
"RTN","PSN566PO",64,0)
 ;;16670,016963
"RTN","PSN566PO",65,0)
 ;;24499,071837
"RTN","PSN566PO",66,0)
 ;;26436,066702
"RTN","PSN566PO",67,0)
 ;;26437,066702
"RTN","PSN566PO",68,0)
 ;;27191,076607
"RTN","PSN566PO",69,0)
 ;;27192,076608
"RTN","PSN566PO",70,0)
 ;;28836,071475
"RTN","PSN566PO",71,0)
 ;;28837,073153
"RTN","PSN566PO",72,0)
 ;;28845,079002
"RTN","PSN566PO",73,0)
 ;;52,000214
"RTN","PSN566PO",74,0)
 ;;18283,062597
"RTN","PSN566PO",75,0)
 ;;19294,042966
"RTN","PSN566PO",76,0)
 ;;20737,061237
"RTN","PSN566PO",77,0)
 ;;25133,072283
"RTN","PSN566PO",78,0)
 ;;27435,072292
"RTN","PSN566PO",79,0)
 ;;27452,072284
"RTN","PSN566PO",80,0)
 ;;27454,072291
"RTN","PSN566PO",81,0)
 ;;27581,031511
"RTN","PSN566PO",82,0)
 ;
"RTN","PSNPPSNU")
0^1^B51460995^B50930121
"RTN","PSNPPSNU",1,0)
PSNPPSNU ;HP/MJE-PPSN update NDF data ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSNU",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513,563,566**; 30 Oct 98;Build 2
"RTN","PSNPPSNU",3,0)
 ;Reference to ^PSDRUG supported by DBIA #2192
"RTN","PSNPPSNU",4,0)
 ;Reference to PSN^PSSHUIDG supported by DBIA #3621
"RTN","PSNPPSNU",5,0)
 ;Reference to ^GMR(120.8) supported by DBIA #4606
"RTN","PSNPPSNU",6,0)
 ;Reference to ^DD supported by DBIA #1258
"RTN","PSNPPSNU",7,0)
 ;
"RTN","PSNPPSNU",8,0)
 ; Note: this routine is an adapted version of the origional code by Dr. Dave Alexander
"RTN","PSNPPSNU",9,0)
 ;
"RTN","PSNPPSNU",10,0)
 N CL,CLA,CMOP,CT,DA,DA1,DIA,DIC,DIE,DIK,DINUM,DR,FDA,FILE,FLDS,GE,GROOT,GROOT1,IENS,IN,INA,IND,INDX,INV,J,JJ,K
"RTN","PSNPPSNU",11,0)
 N LI,LINE,NA,NAME,ND,NEW,NFI,POST,PR,PSN,PSN1,PSN11,PSN21,PSNDF,R1,ROOT,ROOT1,ROOT2,ROOT3,SUBS,VAC,VAIN,VAPN
"RTN","PSNPPSNU",12,0)
 N X,XMDUZ,XMSUB,XMTEXT,XMY,XMZ,TREC,PSNMULTI,MJJ,PSNERROR
"RTN","PSNPPSNU",13,0)
 N ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,XPATH
"RTN","PSNPPSNU",14,0)
 N PSNPS,XPDIDTOT,RES1,PSNTMPN
"RTN","PSNPPSNU",15,0)
 K ^TMP($J),^TMP("PSN",$J),^TMP("PSNN",$J),^TMP("PSN PPSN.WP",$J),^TMP("PSN PPSN ERR",$J),^TMP("PSNINGRED",$J)
"RTN","PSNPPSNU",16,0)
 ;
"RTN","PSNPPSNU",17,0)
 ;SETUP PRODUCTION OR SQA
"RTN","PSNPPSNU",18,0)
 S PSNPS=$P($G(^PS(59.7,1,10)),"^",12),PSNERROR=0
"RTN","PSNPPSNU",19,0)
 I PSNPS="T"!(PSNPS="S") S PSNPS="P" ;test account and support account is same as production.
"RTN","PSNPPSNU",20,0)
 S PSNDF=1,XPDIDTOT=+$G(^TMP("PSN PPSN PARSED",$J,"TREC")),TREC=0
"RTN","PSNPPSNU",21,0)
 ;TO ALLOW ADDS TO 56,50.416,50.605,50.606, AND 50.6
"RTN","PSNPPSNU",22,0)
 ;
"RTN","PSNPPSNU",23,0)
 D DATANT^PSNPPSI1
"RTN","PSNPPSNU",24,0)
 I PSNPS="N" D POSTRUN^PSNPPSNK
"RTN","PSNPPSNU",25,0)
 ;
"RTN","PSNPPSNU",26,0)
WORD ;
"RTN","PSNPPSNU",27,0)
 D CTRKDL^PSNPPSMS("Storing report messages information")
"RTN","PSNPPSNU",28,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",6)="WORD"
"RTN","PSNPPSNU",29,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSNU",30,0)
 K FDA
"RTN","PSNPPSNU",31,0)
 S ROOT1=$NA(^TMP("PSN PPSN PARSED",$J,"WORD")),CT=0,ROOT2=$NA(@ROOT1@(0))
"RTN","PSNPPSNU",32,0)
 F  S CT=$O(@ROOT2) Q:'CT  D CTRLSS^PSNPPSMS(CT) S ROOT2=$NA(@ROOT1@(CT)),NAME=@ROOT2,ROOT3=$NA(@ROOT2@("D")) K @NAME M @NAME=@ROOT3
"RTN","PSNPPSNU",33,0)
 ;
"RTN","PSNPPSNU",34,0)
 D CTRKDL^PSNPPSMS("Sending mail messages")
"RTN","PSNPPSNU",35,0)
 D MESSAGE^PSNPPSMG
"RTN","PSNPPSNU",36,0)
 ;
"RTN","PSNPPSNU",37,0)
 D CTRKDL^PSNPPSMS("Beginning un-march/re-match")
"RTN","PSNPPSNU",38,0)
 W:'$G(PSNSCJOB) !,"Beginning un-match/re-match to local drug file...",!
"RTN","PSNPPSNU",39,0)
DRUGFILE ;
"RTN","PSNPPSNU",40,0)
 ;NOW UPDATE LOCAL DRUG FILE
"RTN","PSNPPSNU",41,0)
 N REM,PSNUNMAT
"RTN","PSNPPSNU",42,0)
 K ^TMP($J)
"RTN","PSNPPSNU",43,0)
 I PSNPS="N" S OLDNDF="" F  S OLDNDF=$O(^TMP("PSN PPSN PARSED",$J,"REM",OLDNDF)) Q:OLDNDF=""  D EN1^PSNPPSNW(OLDNDF,"")
"RTN","PSNPPSNU",44,0)
 S OLDNDF="",PSN=$$PATCH^XPDUTL("PSS*1.0*34"),PSN1=$$PATCH^XPDUTL("PSS*1.0*42")
"RTN","PSNPPSNU",45,0)
 S ROOT2=$NA(^TMP("PSN PPSN PARSED",$J,"PRODUCTS TO UNMATCH")),ROOT3=$NA(^TMP("PSN PPSN PARSED",$J,"POE")),DA=0
"RTN","PSNPPSNU",46,0)
 S DA=0 F  S DA=$O(^PSDRUG(DA)) Q:'DA  S X=$G(^PSDRUG(DA,0)) I X]"" S NA=$P(X,"^"),CLA=$P(X,"^",2),INV=$P(X,"^",3)["I",X=$G(^("ND")),IN=$P($G(^("I"),9999999),"^"),INA=IN'>DT,GE=+X,PR=+$P(X,"^",3),CMOP=$P(X,"^",10),VAPN=$P(X,"^",2) I GE I PR D
"RTN","PSNPPSNU",47,0)
 .S OLDNDF=$P($G(^PSDRUG(DA,"ND")),"^",3) ;va product name (3P:50.68); NA = generic name; CLA = VA Class; INV = DEA Special HDLG 
"RTN","PSNPPSNU",48,0)
 .S VAIN=$P($G(^PSNDF(50.68,PR,7)),"^",3) ;inactivation date
"RTN","PSNPPSNU",49,0)
 .I $D(@ROOT2@(PR))!VAIN S X="" S:CMOP]"" X="    (CMOP "_CMOP_")" D
"RTN","PSNPPSNU",50,0)
 ..S $E(X,30)=VAPN,$E(X,65)=$$FMTE^XLFDT(VAIN,5),INDX=$S(INA:"I",INV:"X",1:"A")
"RTN","PSNPPSNU",51,0)
 ..S:IN=9999999 IN="" S ^TMP($J,INDX,NA_"^"_DA_"^"_IN,1)=X,^TMP($J,"^",DA)=""
"RTN","PSNPPSNU",52,0)
 ..D UNMDRG
"RTN","PSNPPSNU",53,0)
 ..I PSN I $P($G(^PSDRUG(DA,"DOS")),"^")]""!$O(^("DOS1",0))!$O(^PSDRUG(DA,"DOS2",0)) D LOAD^PSNPPSNV K ^PSDRUG(DA,"DOS"),^("DOS1"),^("DOS2")
"RTN","PSNPPSNU",54,0)
 ..I $P($G(^PSDRUG(DA,3)),"^") S DIE=50,DR="213////0;" D ^DIE D ERROR:$D(ERROR("DIERR")) K DIE,DR I PSN1 S IND=$O(^PSDRUG(DA,4," "),-1),$P(^(IND,0),"^",6)="NDF Update"
"RTN","PSNPPSNU",55,0)
 .;check here if PR (50.68 IEN this local drug is matched to) exists in TMP rematch
"RTN","PSNPPSNU",56,0)
 .;if a re-match for that IEN is not null, do re-match (file re-match, add to report)
"RTN","PSNPPSNU",57,0)
 .S REM="" I OLDNDF'="" S REM=$G(^TMP("PSN PPSN PARSED",$J,"REM",OLDNDF))
"RTN","PSNPPSNU",58,0)
 .I REM'="" D REMATCH^PSNPPSNW(DA,REM)
"RTN","PSNPPSNU",59,0)
 .I PSN,$D(@ROOT3@(PR)) K ^PSDRUG(DA,"DOS"),^("DOS1"),^("DOS2")
"RTN","PSNPPSNU",60,0)
 .S ND=$G(^PSDRUG(DA,"ND")),PR=$P(ND,"^",3) I PR D
"RTN","PSNPPSNU",61,0)
 ..S NFI=$P($G(^PSNDF(50.68,PR,5)),"^") I $P(ND,"^",11)'=NFI S DIE=50,DR="29////"_NFI_";" D ^DIE D ERROR:$D(ERROR("DIERR"))
"RTN","PSNPPSNU",62,0)
 ..S VAC=$P($G(^PSNDF(50.68,PR,3)),"^") I VAC S VAC=$P(^PS(50.605,VAC,0),"^"),DIE=50,DR="2////"_VAC_";" D ^DIE D ERROR:$D(ERROR("DIERR"))
"RTN","PSNPPSNU",63,0)
 ..I $P($G(^PSDRUG(DA,3)),"^"),'$P($G(^PSNDF(50.68,PR,1)),"^",3) S DIE=50,DR="213////0;" D ^DIE D ERROR:$D(ERROR("DIERR")) K DIE,DR S IND=$O(^PSDRUG(DA,4," "),-1),$P(^(IND,0),"^",6)="NDF Update"
"RTN","PSNPPSNU",64,0)
 .;S TREC=TREC+1 I '(TREC#500) D UPDATE^XPDID(TREC)
"RTN","PSNPPSNU",65,0)
 D DRGMSG^PSNPPSMG
"RTN","PSNPPSNU",66,0)
 ;package specific post install
"RTN","PSNPPSNU",67,0)
 I $D(^TMP("PSN PPSN PARSED",$J,"POST")) S POST=^("POST") S:POST'["^" POST="^"_POST I @("$T("_POST_")]]""""") D @POST
"RTN","PSNPPSNU",68,0)
 ;
"RTN","PSNPPSNU",69,0)
 ;call to HL7 drug update message
"RTN","PSNPPSNU",70,0)
 I $T(PSN^PSSHUIDG)]"" I $O(^TMP($J,"^",0)) S ZTRTN="PSN^PSSHUIDG",ZTIO="",ZTDTH=$H,ZTDESC="DRUG UPDATE MESSAGE",ZTSAVE("^TMP($J,""^"",")="" D ^%ZTLOAD
"RTN","PSNPPSNU",71,0)
 ;
"RTN","PSNPPSNU",72,0)
 D CTRKDL^PSNPPSMS("Validating cross references")
"RTN","PSNPPSNU",73,0)
 W:'$G(PSNSCJOB) !,"Validating cross references...",!
"RTN","PSNPPSNU",74,0)
REINDEX ;Make sure APC xref is correct
"RTN","PSNPPSNU",75,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",6)="REINDEX"
"RTN","PSNPPSNU",76,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSNU",77,0)
 K FDA
"RTN","PSNPPSNU",78,0)
 N SUB,DA,DIK,GMRAIEN,CLASS
"RTN","PSNPPSNU",79,0)
 S SUB=0 F  S SUB=$O(^GMR(120.8,SUB)) Q:'+SUB  I $D(^GMR(120.8,SUB,3)) D
"RTN","PSNPPSNU",80,0)
 .S GMRAIEN=+$P($G(^GMR(120.8,SUB,0)),U) Q:'GMRAIEN
"RTN","PSNPPSNU",81,0)
 .S CLASS="" F  S CLASS=$O(^GMR(120.8,"APC",GMRAIEN,CLASS)) Q:CLASS=""  K ^GMR(120.8,"APC",GMRAIEN,CLASS,SUB)
"RTN","PSNPPSNU",82,0)
 .S DA(1)=SUB
"RTN","PSNPPSNU",83,0)
 .S DIK="^GMR(120.8,DA(1),3,"
"RTN","PSNPPSNU",84,0)
 .S DIK(1)=".01^ADRG3"
"RTN","PSNPPSNU",85,0)
 .D ENALL^DIK ;Reset the drug class xref
"RTN","PSNPPSNU",86,0)
 ;
"RTN","PSNPPSNU",87,0)
MORE ; REINDEXING
"RTN","PSNPPSNU",88,0)
 D CTRKDL^PSNPPSMS("Reindexing")
"RTN","PSNPPSNU",89,0)
 ;now the APD
"RTN","PSNPPSNU",90,0)
 K ^PS(50.416,"APD") S DA=0 F  S DA=$O(^PS(50.416,DA)),K=0 Q:'DA  F  S K=$O(^PS(50.416,DA,1,K)) Q:'K  S X=^(K,0),^PS(50.416,"APD",X,DA)=""
"RTN","PSNPPSNU",91,0)
 ;now the interactions
"RTN","PSNPPSNU",92,0)
 K ^PS(56,"APD") S DA=0 F  S DA=$O(^PS(56,DA)) Q:'DA  K PSN1,PSN2 S PSN1=$P(^(DA,0),"^",2),PSN2=$P(^(0),"^",3) D
"RTN","PSNPPSNU",93,0)
 .S NA="" F  S NA=$O(^PS(50.416,PSN1,1,"B",NA)) Q:NA=""  S PSN1(NA)=""
"RTN","PSNPPSNU",94,0)
 .S PSN11=0 F  S PSN11=$O(^PS(50.416,"APS",PSN1,PSN11)),NA="" Q:'PSN11  F  S NA=$O(^PS(50.416,PSN11,1,"B",NA)) Q:NA=""  S PSN1(NA)=""
"RTN","PSNPPSNU",95,0)
 .S NA="" F  S NA=$O(^PS(50.416,PSN2,1,"B",NA)) Q:NA=""  S PSN2(NA)=""
"RTN","PSNPPSNU",96,0)
 .S PSN21=0 F  S PSN21=$O(^PS(50.416,"APS",PSN2,PSN21)),NA="" Q:'PSN21  F  S NA=$O(^PS(50.416,PSN21,1,"B",NA)) Q:NA=""  S PSN2(NA)=""
"RTN","PSNPPSNU",97,0)
 .S PSN1="" F  S PSN1=$O(PSN1(PSN1)),PSN2="" Q:PSN1=""  F  S PSN2=$O(PSN2(PSN2)) Q:PSN2=""  S ^PS(56,"APD",PSN1,PSN2,DA)="",^PS(56,"APD",PSN2,PSN1,DA)=""
"RTN","PSNPPSNU",98,0)
 ;
"RTN","PSNPPSNU",99,0)
 D ^PSNPPSCL
"RTN","PSNPPSNU",100,0)
 D ERRORMS^PSNPPSMS
"RTN","PSNPPSNU",101,0)
 ;
"RTN","PSNPPSNU",102,0)
QUIT ;
"RTN","PSNPPSNU",103,0)
 ;D UPDATE^XPDID(XPDIDTOT)
"RTN","PSNPPSNU",104,0)
 K CL,CLA,CMOP,CT,DA,DA1,DIA,DIC,DIE,DIK,DINUM,DR,FDA,FILE,FLDS,GE,GROOT,GROOT1,IENS,IN,INA,IND,INDX,INV,J,JJ,K,LI,LINE,NA,NAME,ND,NEW,NFI,POST,PR,PSN,PSN1,PSN11,PSN21,PSNDF,R1,ROOT,ROOT1,ROOT2,ROOT3,SUBS,VAC,VAIN,VAPN
"RTN","PSNPPSNU",105,0)
 K X,XMDUZ,XMSUB,XMTEXT,XMY,XMZ,XUMF,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE
"RTN","PSNPPSNU",106,0)
 K ^TMP($J),^TMP("PSN",$J),^TMP("PSNN",$J),^TMP("PSN PPSN ERR",$J),^TMP("PSNINGRED",$J)
"RTN","PSNPPSNU",107,0)
 Q
"RTN","PSNPPSNU",108,0)
 ;
"RTN","PSNPPSNU",109,0)
ERROR ;Track file errors
"RTN","PSNPPSNU",110,0)
 D APPERROR^%ZTER("PPSN ERROR")
"RTN","PSNPPSNU",111,0)
 N PSNERRC,ERRFILE,ERRIEN
"RTN","PSNPPSNU",112,0)
 S PSNERROR=PSNERROR+1,PSNERRC=0,ERRFILE=0,ERRIEN=0
"RTN","PSNPPSNU",113,0)
 F  S PSNERRC=$O(ERROR("DIERR",PSNERRC)) Q:'PSNERRC  D:$D(ERROR("DIERR",PSNERRC,"TEXT",1))
"RTN","PSNPPSNU",114,0)
 .S ERRFILE=$G(ERROR("DIERR",PSNERRC,"PARAM","FILE")) S ERRIEN=$S("^351^352^311^"[("^"_$G(ERROR("DIERR",PSNERRC))_"^"):" ",1:$P(DIA,"^"))
"RTN","PSNPPSNU",115,0)
 .S ^TMP("PSN PPSN ERR",$J,PSNTMPN,$S($G(ERRFILE):ERRFILE,$G(FILE)'="":FILE,1:ROOT),ERRIEN,$P(DIA,"^",3),PSNERROR)=ERROR("DIERR",PSNERRC,"TEXT",1)_"|"_$S($G(FILE)'="":FILE,1:ROOT)_"-"_$P(DIA,"^",3)_"|"_NEW
"RTN","PSNPPSNU",116,0)
 Q
"RTN","PSNPPSNU",117,0)
 ;
"RTN","PSNPPSNU",118,0)
ERROR2(PSNERRN,PSNERRF,PSNERRIE,PSNERRFL,PSNERRTY) ;Track DICN errors
"RTN","PSNPPSNU",119,0)
 D APPERROR^%ZTER("PPSN ERROR2")
"RTN","PSNPPSNU",120,0)
 S PSNERROR=PSNERROR+1,PSNERRC=""
"RTN","PSNPPSNU",121,0)
 S ^TMP("PSN PPSN ERR",$J,PSNERRN,PSNERRF,PSNERRIE,PSNERRFL,PSNERRTY)=DIA_"^"_NEW
"RTN","PSNPPSNU",122,0)
 Q
"RTN","PSNPPSNU",123,0)
STRIP(X) ; Strip control characters
"RTN","PSNPPSNU",124,0)
 N I,Y
"RTN","PSNPPSNU",125,0)
 S Y="" F I=1:1:$L(X) S:$A(X,I)>31 Y=Y_$E(X,I)
"RTN","PSNPPSNU",126,0)
 Q Y
"RTN","PSNPPSNU",127,0)
 ;
"RTN","PSNPPSNU",128,0)
UNMDRG ; Unmatch Drug File entry
"RTN","PSNPPSNU",129,0)
 N PIECE,PRDNAM,ND,NDP10
"RTN","PSNPPSNU",130,0)
 S ND=$G(^PSDRUG(DA,"ND")),PRDNAM=$E($P(ND,"^",2),1,30),NDP10=$P(ND,"^",10)
"RTN","PSNPPSNU",131,0)
 F PIECE=1:1:5,10,11 S $P(^PSDRUG(DA,"ND"),"^",PIECE)=""
"RTN","PSNPPSNU",132,0)
 I PRDNAM'="" K ^PSDRUG("VAPN",PRDNAM,DA)
"RTN","PSNPPSNU",133,0)
 I NDP10'="" K ^PSDRUG("AQ1",NDP10,DA)
"RTN","PSNPPSNU",134,0)
 Q
"VER")
8.0^22.2
"BLD",10975,6)
^548
**END**
**END**

