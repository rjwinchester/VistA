Released PSN*4*513 SEQ #531
Extracted from mail message
**KIDS**:PSN*4.0*513^

**INSTALL NAME**
PSN*4.0*513
"BLD",9663,0)
PSN*4.0*513^NATIONAL DRUG FILE^0^3171215^y
"BLD",9663,4,0)
^9.64PA^59.7^2
"BLD",9663,4,57.23,0)
57.23
"BLD",9663,4,57.23,222)
y^y^f^^^^n
"BLD",9663,4,59.7,0)
59.7
"BLD",9663,4,59.7,2,0)
^9.641^59.7^1
"BLD",9663,4,59.7,2,59.7,0)
PHARMACY SYSTEM  (File-top level)
"BLD",9663,4,59.7,2,59.7,1,0)
^9.6411^17^1
"BLD",9663,4,59.7,2,59.7,1,17,0)
PPS-N NATIONAL SQA ACCOUNT
"BLD",9663,4,59.7,222)
y^y^p^^^^n^^n
"BLD",9663,4,59.7,224)

"BLD",9663,4,"APDD",59.7,59.7)

"BLD",9663,4,"APDD",59.7,59.7,17)

"BLD",9663,4,"B",57.23,57.23)

"BLD",9663,4,"B",59.7,59.7)

"BLD",9663,6)
14^
"BLD",9663,6.3)
53
"BLD",9663,"ABPKG")
n
"BLD",9663,"INI")

"BLD",9663,"INID")
^y^
"BLD",9663,"INIT")
POST^PSN513PO
"BLD",9663,"KRN",0)
^9.67PA^779.2^20
"BLD",9663,"KRN",.4,0)
.4
"BLD",9663,"KRN",.401,0)
.401
"BLD",9663,"KRN",.402,0)
.402
"BLD",9663,"KRN",.402,"NM",0)
^9.68A^^0
"BLD",9663,"KRN",.403,0)
.403
"BLD",9663,"KRN",.5,0)
.5
"BLD",9663,"KRN",.84,0)
.84
"BLD",9663,"KRN",3.6,0)
3.6
"BLD",9663,"KRN",3.8,0)
3.8
"BLD",9663,"KRN",9.2,0)
9.2
"BLD",9663,"KRN",9.8,0)
9.8
"BLD",9663,"KRN",9.8,"NM",0)
^9.68A^28^25
"BLD",9663,"KRN",9.8,"NM",1,0)
PSNPPSI1^^0^B5027313
"BLD",9663,"KRN",9.8,"NM",2,0)
PSNPPSI2^^0^B117398131
"BLD",9663,"KRN",9.8,"NM",3,0)
PSNPPSI3^^0^B48818890
"BLD",9663,"KRN",9.8,"NM",4,0)
PSNPPSNU^^0^B51690215
"BLD",9663,"KRN",9.8,"NM",5,0)
PSNPPSNP^^0^B105233579
"BLD",9663,"KRN",9.8,"NM",6,0)
PSNPPSDL^^0^B29912980
"BLD",9663,"KRN",9.8,"NM",7,0)
PSNPPSNK^^0^B45231905
"BLD",9663,"KRN",9.8,"NM",8,0)
PSNPPSNR^^0^B98892215
"BLD",9663,"KRN",9.8,"NM",9,0)
PSNCLEAN^^0^B38230094
"BLD",9663,"KRN",9.8,"NM",11,0)
PSNPPSMG^^0^B90560472
"BLD",9663,"KRN",9.8,"NM",12,0)
PSNPPSNV^^0^B179018356
"BLD",9663,"KRN",9.8,"NM",13,0)
PSNPPSMS^^0^B168622866
"BLD",9663,"KRN",9.8,"NM",14,0)
PSNPPSNW^^0^B35107109
"BLD",9663,"KRN",9.8,"NM",15,0)
PSNFTP^^0^B220445770
"BLD",9663,"KRN",9.8,"NM",16,0)
PSNFTP2^^0^B136877012
"BLD",9663,"KRN",9.8,"NM",17,0)
PSNPPSNF^^0^B92527436
"BLD",9663,"KRN",9.8,"NM",18,0)
PSNPPSNC^^0^B14201170
"BLD",9663,"KRN",9.8,"NM",20,0)
PSNPARM^^0^B55605893
"BLD",9663,"KRN",9.8,"NM",21,0)
PSNVCR^^0^B169194760
"BLD",9663,"KRN",9.8,"NM",22,0)
PSNVCR1^^0^B106479512
"BLD",9663,"KRN",9.8,"NM",23,0)
PSNVCR2^^0^B207861885
"BLD",9663,"KRN",9.8,"NM",24,0)
PSNCFINQ^^0^B51923740
"BLD",9663,"KRN",9.8,"NM",25,0)
PSNOSKEY^^0^B85865292
"BLD",9663,"KRN",9.8,"NM",26,0)
PSNFTP3^^0^B8030989
"BLD",9663,"KRN",9.8,"NM",28,0)
PSNPPSCL^^0^B48571285
"BLD",9663,"KRN",9.8,"NM","B","PSNCFINQ",24)

"BLD",9663,"KRN",9.8,"NM","B","PSNCLEAN",9)

"BLD",9663,"KRN",9.8,"NM","B","PSNFTP",15)

"BLD",9663,"KRN",9.8,"NM","B","PSNFTP2",16)

"BLD",9663,"KRN",9.8,"NM","B","PSNFTP3",26)

"BLD",9663,"KRN",9.8,"NM","B","PSNOSKEY",25)

"BLD",9663,"KRN",9.8,"NM","B","PSNPARM",20)

"BLD",9663,"KRN",9.8,"NM","B","PSNPPSCL",28)

"BLD",9663,"KRN",9.8,"NM","B","PSNPPSDL",6)

"BLD",9663,"KRN",9.8,"NM","B","PSNPPSI1",1)

"BLD",9663,"KRN",9.8,"NM","B","PSNPPSI2",2)

"BLD",9663,"KRN",9.8,"NM","B","PSNPPSI3",3)

"BLD",9663,"KRN",9.8,"NM","B","PSNPPSMG",11)

"BLD",9663,"KRN",9.8,"NM","B","PSNPPSMS",13)

"BLD",9663,"KRN",9.8,"NM","B","PSNPPSNC",18)

"BLD",9663,"KRN",9.8,"NM","B","PSNPPSNF",17)

"BLD",9663,"KRN",9.8,"NM","B","PSNPPSNK",7)

"BLD",9663,"KRN",9.8,"NM","B","PSNPPSNP",5)

"BLD",9663,"KRN",9.8,"NM","B","PSNPPSNR",8)

"BLD",9663,"KRN",9.8,"NM","B","PSNPPSNU",4)

"BLD",9663,"KRN",9.8,"NM","B","PSNPPSNV",12)

"BLD",9663,"KRN",9.8,"NM","B","PSNPPSNW",14)

"BLD",9663,"KRN",9.8,"NM","B","PSNVCR",21)

"BLD",9663,"KRN",9.8,"NM","B","PSNVCR1",22)

"BLD",9663,"KRN",9.8,"NM","B","PSNVCR2",23)

"BLD",9663,"KRN",19,0)
19
"BLD",9663,"KRN",19,"NM",0)
^9.68A^14^13
"BLD",9663,"KRN",19,"NM",1,0)
PSN PPS MANUAL DOWNLOAD^^0
"BLD",9663,"KRN",19,"NM",2,0)
PSN PPS MANUAL INSTALL^^0
"BLD",9663,"KRN",19,"NM",3,0)
PSN PPS PARAM^^0
"BLD",9663,"KRN",19,"NM",4,0)
PSN PPS REJECT FILE^^0
"BLD",9663,"KRN",19,"NM",5,0)
PSN PPS SCHEDULE DOWNLOAD^^0
"BLD",9663,"KRN",19,"NM",6,0)
PSN PPS SCHEDULE INSTALL^^0
"BLD",9663,"KRN",19,"NM",7,0)
PSN PPS MENU^^0
"BLD",9663,"KRN",19,"NM",8,0)
PSN TASK SCHEDULED DOWNLOAD^^0
"BLD",9663,"KRN",19,"NM",9,0)
PSN PPS VISTA COMPARISON RPT^^0
"BLD",9663,"KRN",19,"NM",11,0)
PSN PPS SSH KEY MANAGEMENT^^0
"BLD",9663,"KRN",19,"NM",12,0)
PSN PPS DNLD/INST STATUS REP^^0
"BLD",9663,"KRN",19,"NM",13,0)
PSN TASK SCHEDULED INSTALL^^0
"BLD",9663,"KRN",19,"NM",14,0)
PSN PPS INSTALL VERIFY^^0
"BLD",9663,"KRN",19,"NM","B","PSN PPS DNLD/INST STATUS REP",12)

"BLD",9663,"KRN",19,"NM","B","PSN PPS INSTALL VERIFY",14)

"BLD",9663,"KRN",19,"NM","B","PSN PPS MANUAL DOWNLOAD",1)

"BLD",9663,"KRN",19,"NM","B","PSN PPS MANUAL INSTALL",2)

"BLD",9663,"KRN",19,"NM","B","PSN PPS MENU",7)

"BLD",9663,"KRN",19,"NM","B","PSN PPS PARAM",3)

"BLD",9663,"KRN",19,"NM","B","PSN PPS REJECT FILE",4)

"BLD",9663,"KRN",19,"NM","B","PSN PPS SCHEDULE DOWNLOAD",5)

"BLD",9663,"KRN",19,"NM","B","PSN PPS SCHEDULE INSTALL",6)

"BLD",9663,"KRN",19,"NM","B","PSN PPS SSH KEY MANAGEMENT",11)

"BLD",9663,"KRN",19,"NM","B","PSN PPS VISTA COMPARISON RPT",9)

"BLD",9663,"KRN",19,"NM","B","PSN TASK SCHEDULED DOWNLOAD",8)

"BLD",9663,"KRN",19,"NM","B","PSN TASK SCHEDULED INSTALL",13)

"BLD",9663,"KRN",19.1,0)
19.1
"BLD",9663,"KRN",19.1,"NM",0)
^9.68A^2^2
"BLD",9663,"KRN",19.1,"NM",1,0)
PSN PPS ADMIN^^0
"BLD",9663,"KRN",19.1,"NM",2,0)
PSN PPS COORD^^0
"BLD",9663,"KRN",19.1,"NM","B","PSN PPS ADMIN",1)

"BLD",9663,"KRN",19.1,"NM","B","PSN PPS COORD",2)

"BLD",9663,"KRN",101,0)
101
"BLD",9663,"KRN",101,"NM",0)
^9.68A^^
"BLD",9663,"KRN",409.61,0)
409.61
"BLD",9663,"KRN",771,0)
771
"BLD",9663,"KRN",779.2,0)
779.2
"BLD",9663,"KRN",870,0)
870
"BLD",9663,"KRN",8989.51,0)
8989.51
"BLD",9663,"KRN",8989.52,0)
8989.52
"BLD",9663,"KRN",8994,0)
8994
"BLD",9663,"KRN","B",.4,.4)

"BLD",9663,"KRN","B",.401,.401)

"BLD",9663,"KRN","B",.402,.402)

"BLD",9663,"KRN","B",.403,.403)

"BLD",9663,"KRN","B",.5,.5)

"BLD",9663,"KRN","B",.84,.84)

"BLD",9663,"KRN","B",3.6,3.6)

"BLD",9663,"KRN","B",3.8,3.8)

"BLD",9663,"KRN","B",9.2,9.2)

"BLD",9663,"KRN","B",9.8,9.8)

"BLD",9663,"KRN","B",19,19)

"BLD",9663,"KRN","B",19.1,19.1)

"BLD",9663,"KRN","B",101,101)

"BLD",9663,"KRN","B",409.61,409.61)

"BLD",9663,"KRN","B",771,771)

"BLD",9663,"KRN","B",779.2,779.2)

"BLD",9663,"KRN","B",870,870)

"BLD",9663,"KRN","B",8989.51,8989.51)

"BLD",9663,"KRN","B",8989.52,8989.52)

"BLD",9663,"KRN","B",8994,8994)

"BLD",9663,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9663,"QUES",0)
^9.62^^
"BLD",9663,"REQB",0)
^9.611^2^2
"BLD",9663,"REQB",1,0)
PSN*4.0*396^2
"BLD",9663,"REQB",2,0)
PSN*4.0*176^1
"BLD",9663,"REQB","B","PSN*4.0*176",2)

"BLD",9663,"REQB","B","PSN*4.0*396",1)

"FIA",57.23)
PPS-N UPDATE CONTROL
"FIA",57.23,0)
^PS(57.23,
"FIA",57.23,0,0)
57.23
"FIA",57.23,0,1)
y^y^f^^^^n
"FIA",57.23,0,10)

"FIA",57.23,0,11)

"FIA",57.23,0,"RLRO")

"FIA",57.23,0,"VR")
4.0^PSN
"FIA",57.23,57.23)
0
"FIA",57.23,57.231)
0
"FIA",57.23,57.233)
0
"FIA",57.23,57.2331)
0
"FIA",57.23,57.2332)
0
"FIA",57.23,57.2333)
0
"FIA",57.23,57.2334)
0
"FIA",57.23,57.234)
0
"FIA",57.23,57.236)
0
"FIA",57.23,57.24)
0
"FIA",59.7)
PHARMACY SYSTEM
"FIA",59.7,0)
^PS(59.7,
"FIA",59.7,0,0)
59.7
"FIA",59.7,0,1)
y^y^p^^^^n^^n
"FIA",59.7,0,10)

"FIA",59.7,0,11)

"FIA",59.7,0,"RLRO")

"FIA",59.7,0,"VR")
4.0^PSN
"FIA",59.7,59.7)
1
"FIA",59.7,59.7,17)

"INIT")
POST^PSN513PO
"IX",57.23,57.231,"C",0)
57.231^C^Cross Reference by Install Begin Date/Time^R^^F^IR^I^57.231^^^^^LS
"IX",57.23,57.231,"C",.1,0)
^^2^2^3170222^
"IX",57.23,57.231,"C",.1,1,0)
This cross reference is used by the Install Status Report 
"IX",57.23,57.231,"C",.1,2,0)
[PSN PPS INSTALL STATUS REPORT] option for lookup and sorting.
"IX",57.23,57.231,"C",1)
S ^PS(57.23,DA(1),5,"C",X,DA)=""
"IX",57.23,57.231,"C",2)
K ^PS(57.23,DA(1),5,"C",X,DA)
"IX",57.23,57.231,"C",2.5)
K ^PS(57.23,DA(1),5,"C")
"IX",57.23,57.231,"C",11.1,0)
^.114IA^1^1
"IX",57.23,57.231,"C",11.1,1,0)
1^F^57.231^1^^1^F
"IX",57.23,57.231,"F",0)
57.231^F^Cross reference by NAME, INSTALL BEGIN DATE/TIME, IEN^R^^R^IR^I^57.231^^^^^LS
"IX",57.23,57.231,"F",.1,0)
^^2^2^3170222^
"IX",57.23,57.231,"F",.1,1,0)
This cross reference is used by the Install Status Report
"IX",57.23,57.231,"F",.1,2,0)
[PSN PPS INSTALL STATUS REPORT] option for lookup and sorting.
"IX",57.23,57.231,"F",1)
S ^PS(57.23,DA(1),5,"F",$E(X(1),1,30),X(2),DA)=""
"IX",57.23,57.231,"F",2)
K ^PS(57.23,DA(1),5,"F",$E(X(1),1,30),X(2),DA)
"IX",57.23,57.231,"F",2.5)
K ^PS(57.23,DA(1),5,"F")
"IX",57.23,57.231,"F",11.1,0)
^.114IA^2^2
"IX",57.23,57.231,"F",11.1,1,0)
1^F^57.231^.01^30^1^F
"IX",57.23,57.231,"F",11.1,2,0)
2^F^57.231^1^^2^F
"IX",57.23,57.234,"D",0)
57.234^D^Cross reference for Download Begin Date/Time^R^^F^IR^I^57.234^^^^^LS
"IX",57.23,57.234,"D",.1,0)
^^2^2^3170222^
"IX",57.23,57.234,"D",.1,1,0)
This cross reference is used by the Install Status Report 
"IX",57.23,57.234,"D",.1,2,0)
[PSN PPS INSTALL STATUS REPORT] option for lookup and sorting.
"IX",57.23,57.234,"D",1)
S ^PS(57.23,DA(1),4,"D",X,DA)=""
"IX",57.23,57.234,"D",2)
K ^PS(57.23,DA(1),4,"D",X,DA)
"IX",57.23,57.234,"D",2.5)
K ^PS(57.23,DA(1),4,"D")
"IX",57.23,57.234,"D",11.1,0)
^.114IA^1^1
"IX",57.23,57.234,"D",11.1,1,0)
1^F^57.234^1^^1^F
"IX",57.23,57.234,"D",11.1,1,3)

"IX",57.23,57.234,"E",0)
57.234^E^Download cross reference by NAME, DOWNLOAD BEGIN DATE/TIME, IEN^R^^R^IR^I^57.234^^^^^LS
"IX",57.23,57.234,"E",.1,0)
^^2^2^3170222^
"IX",57.23,57.234,"E",.1,1,0)
This cross reference is used by the Install Status Report
"IX",57.23,57.234,"E",.1,2,0)
[PSN PPS INSTALL STATUS REPORT] option for lookup and sorting.
"IX",57.23,57.234,"E",1)
S ^PS(57.23,DA(1),4,"E",$E(X(1),1,30),X(2),DA)=""
"IX",57.23,57.234,"E",2)
K ^PS(57.23,DA(1),4,"E",$E(X(1),1,30),X(2),DA)
"IX",57.23,57.234,"E",2.5)
K ^PS(57.23,DA(1),4,"E")
"IX",57.23,57.234,"E",11.1,0)
^.114IA^2^2
"IX",57.23,57.234,"E",11.1,1,0)
1^F^57.234^.01^30^1^F
"IX",57.23,57.234,"E",11.1,2,0)
2^F^57.234^1^^2^F
"KRN",19,14406,-1)
0^1
"KRN",19,14406,0)
PSN PPS MANUAL DOWNLOAD^Manual Download of NDF Update file^^R^^PSN PPS ADMIN^^^^^^NATIONAL DRUG FILE
"KRN",19,14406,1,0)
^19.06^2^2^3170125^^^
"KRN",19,14406,1,1,0)
This option will start the download of any new NDF update files from
"KRN",19,14406,1,2,0)
PPS-N.  This should be run during off-peak hours.
"KRN",19,14406,25)
DOWNLOAD^PSNPPSDL
"KRN",19,14406,"U")
MANUAL DOWNLOAD OF NDF UPDATE 
"KRN",19,14407,-1)
0^8
"KRN",19,14407,0)
PSN TASK SCHEDULED DOWNLOAD^TaskMan scheduled download of NDF updates^^R^^^^^^^^NATIONAL DRUG FILE
"KRN",19,14407,1,0)
^19.06^3^3^3160223^^^^
"KRN",19,14407,1,1,0)
This option is submitted to TaskMan as a scheduled task to download 
"KRN",19,14407,1,2,0)
any available NDF update files.  This option should be scheduled for 
"KRN",19,14407,1,3,0)
off-peak hours.
"KRN",19,14407,25)
RUNIT^PSNPPSDL
"KRN",19,14407,200.9)

"KRN",19,14407,"U")
TASKMAN SCHEDULED DOWNLOAD OF 
"KRN",19,14408,-1)
0^4
"KRN",19,14408,0)
PSN PPS REJECT FILE^Reject/Complete of NDF Update file^^R^^PSN PPS ADMIN^^^^^^NATIONAL DRUG FILE
"KRN",19,14408,1,0)
^^3^3^3170323^
"KRN",19,14408,1,1,0)
This option should only be used to identify installation problems in 
"KRN",19,14408,1,2,0)
the National VistA account. Local VistA users will only have access to
"KRN",19,14408,1,3,0)
send completion message for the compliance report in PPS-N.
"KRN",19,14408,25)
IGU^PSNPPSMS
"KRN",19,14408,"U")
REJECT/COMPLETE OF NDF UPDATE 
"KRN",19,14409,-1)
0^2
"KRN",19,14409,0)
PSN PPS MANUAL INSTALL^Manual Install of NDF Update file^^R^^PSN PPS ADMIN^^^^^^NATIONAL DRUG FILE
"KRN",19,14409,1,0)
^19.06^4^4^3170125^^^^
"KRN",19,14409,1,1,0)
Using this option, you can immediately begin the process that checks for
"KRN",19,14409,1,2,0)
any PPS-N update files that are available and if valid update your VistA
"KRN",19,14409,1,3,0)
NDF files. Normally this process is executed during off-peak hours so be
"KRN",19,14409,1,4,0)
sure that users are not accessing PDM.
"KRN",19,14409,25)
MFIND^PSNPPSNF
"KRN",19,14409,"U")
MANUAL INSTALL OF NDF UPDATE F
"KRN",19,14410,-1)
0^6
"KRN",19,14410,0)
PSN PPS SCHEDULE INSTALL^Schedule Install of NDF Update file^^R^^PSN PPS ADMIN^^^^^^NATIONAL DRUG FILE
"KRN",19,14410,1,0)
^19.06^2^2^3170125^^
"KRN",19,14410,1,1,0)
This option is used during scheduling of an Update of NDF data from 
"KRN",19,14410,1,2,0)
Pharmacy Product System - National (PPS-N).
"KRN",19,14410,25)
SCHDOPT^PSNPPSNV
"KRN",19,14410,"U")
SCHEDULE INSTALL OF NDF UPDATE
"KRN",19,14411,-1)
0^5
"KRN",19,14411,0)
PSN PPS SCHEDULE DOWNLOAD^Schedule download of NDF update file^^R^^PSN PPS ADMIN^^^^^^NATIONAL DRUG FILE
"KRN",19,14411,1,0)
^19.06^2^2^3170125^^^
"KRN",19,14411,1,1,0)
This option will allow a user to schedule the download of new NDF files
"KRN",19,14411,1,2,0)
from PPS-N.  Downloads should be scheduled for off-peak hours. 
"KRN",19,14411,25)
SCHDOPT^PSNPPSDL
"KRN",19,14411,"U")
SCHEDULE DOWNLOAD OF NDF UPDAT
"KRN",19,14412,-1)
0^11
"KRN",19,14412,0)
PSN PPS SSH KEY MANAGEMENT^Manage Secure Shell (SSH) Keys^^A^^PSN PPS COORD^^^^^^NATIONAL DRUG FILE^^1
"KRN",19,14412,1,0)
^19.06^2^2^3170301^^^
"KRN",19,14412,1,1,0)
This option is used for managing SSH encryption keys used in PPS-N data 
"KRN",19,14412,1,2,0)
file download from the server. 
"KRN",19,14412,20)
D EN^PSNOSKEY
"KRN",19,14412,99)
64217,42162
"KRN",19,14412,"U")
MANAGE SECURE SHELL (SSH) KEYS
"KRN",19,14413,-1)
0^3
"KRN",19,14413,0)
PSN PPS PARAM^PPS-N Site Parameters (Enter/Edit)^^R^^PSN PPS ADMIN^^^^^^^^
"KRN",19,14413,1,0)
^19.06^2^2^3170125^^^^
"KRN",19,14413,1,1,0)
This option is used to create or update site parameters for the Pharmacy 
"KRN",19,14413,1,2,0)
Product System - National (PPS-N).
"KRN",19,14413,20)

"KRN",19,14413,25)
EN^PSNPARM
"KRN",19,14413,"U")
PPS-N SITE PARAMETERS (ENTER/E
"KRN",19,14414,-1)
0^7
"KRN",19,14414,0)
PSN PPS MENU^PPS-N Menu^^M^^PSN PPS ADMIN^^^^^^NATIONAL DRUG FILE
"KRN",19,14414,1,0)
^19.06^2^2^3170327^^^^
"KRN",19,14414,1,1,0)
This option is a Sub-menu which contains all the PPS-N options of the
"KRN",19,14414,1,2,0)
National Drug File package. 
"KRN",19,14414,10,0)
^19.01IP^10^10
"KRN",19,14414,10,1,0)
14411^SD^1
"KRN",19,14414,10,1,"^")
PSN PPS SCHEDULE DOWNLOAD
"KRN",19,14414,10,2,0)
14406^MD^3
"KRN",19,14414,10,2,"^")
PSN PPS MANUAL DOWNLOAD
"KRN",19,14414,10,3,0)
14408^RJ^5
"KRN",19,14414,10,3,"^")
PSN PPS REJECT FILE
"KRN",19,14414,10,4,0)
14413^SP^6
"KRN",19,14414,10,4,"^")
PSN PPS PARAM
"KRN",19,14414,10,6,0)
14410^SI^2
"KRN",19,14414,10,6,"^")
PSN PPS SCHEDULE INSTALL
"KRN",19,14414,10,7,0)
14409^MI^4
"KRN",19,14414,10,7,"^")
PSN PPS MANUAL INSTALL
"KRN",19,14414,10,8,0)
14415^VC^7
"KRN",19,14414,10,8,"^")
PSN PPS VISTA COMPARISON RPT
"KRN",19,14414,10,9,0)
14416^DIS^8
"KRN",19,14414,10,9,"^")
PSN PPS DNLD/INST STATUS REP
"KRN",19,14414,10,10,0)
14412^SSH^9
"KRN",19,14414,10,10,"^")
PSN PPS SSH KEY MANAGEMENT
"KRN",19,14414,99)
64506,32695
"KRN",19,14414,"U")
PPS-N MENU
"KRN",19,14415,-1)
0^9
"KRN",19,14415,0)
PSN PPS VISTA COMPARISON RPT^Vista Comparison Report^^R^^^^^^^^NATIONAL DRUG FILE
"KRN",19,14415,1,0)
^^2^2^3170127^
"KRN",19,14415,1,1,0)
This option is used to view or print changes to National Drug File files
"KRN",19,14415,1,2,0)
that are tracked in the AUDIT (#1.1) File.
"KRN",19,14415,25)
PSNVCR
"KRN",19,14415,"U")
VISTA COMPARISON REPORT
"KRN",19,14416,-1)
0^12
"KRN",19,14416,0)
PSN PPS DNLD/INST STATUS REP^Download/Install Status Report^^R^^^^^^^^NATIONAL DRUG FILE
"KRN",19,14416,1,0)
^19.06^2^2^3171211^^^
"KRN",19,14416,1,1,0)
This option is used to display information regarding the status of 
"KRN",19,14416,1,2,0)
DOWNLOAD or INSTALL of files found in the PPS-N UPDATE CONTROL file (#57.23).
"KRN",19,14416,25)
PSNCFINQ
"KRN",19,14416,"U")
DOWNLOAD/INSTALL STATUS REPORT
"KRN",19,14417,-1)
0^13
"KRN",19,14417,0)
PSN TASK SCHEDULED INSTALL^TaskMan scheduled update of NDF data from PPS-N^^R^^^^^^^^NATIONAL DRUG FILE
"KRN",19,14417,1,0)
^^4^4^3170424^
"KRN",19,14417,1,1,0)
This option is used called by TaskMan to begin the process that 
"KRN",19,14417,1,2,0)
checks for any PPS-N update files that are available and if valid 
"KRN",19,14417,1,3,0)
update your VistA NDF files. Normally this process is executed during
"KRN",19,14417,1,4,0)
off-peak hours so be sure that users are not accessing PDM.
"KRN",19,14417,25)
SCHED^PSNPPSNF
"KRN",19,14417,"U")
TASKMAN SCHEDULED UPDATE OF ND
"KRN",19,14418,-1)
0^14
"KRN",19,14418,0)
PSN PPS INSTALL VERIFY^TaskMan scheduled install verify of data file^^R^^^^^^^^NATIONAL DRUG FILE
"KRN",19,14418,1,0)
^19.06^3^3^3171215^^
"KRN",19,14418,1,1,0)
This option is called by the installion of NDF file process to
"KRN",19,14418,1,2,0)
verify and monitor if the installation completed successfully within 
"KRN",19,14418,1,3,0)
an hour or so. If not completed, it will send error message.
"KRN",19,14418,25)
VERIFY^PSNFTP3
"KRN",19,14418,"U")
TASKMAN SCHEDULED INSTALL VERI
"KRN",19.1,706,-1)
0^1
"KRN",19.1,706,0)
PSN PPS ADMIN^
"KRN",19.1,706,1,0)
^19.11^2^2^3170125^^
"KRN",19.1,706,1,1,0)
This key will be required for the PPS-N Menu of the National Drug File 
"KRN",19.1,706,1,2,0)
package.
"KRN",19.1,707,-1)
0^2
"KRN",19.1,707,0)
PSN PPS COORD
"KRN",19.1,707,1,0)
^19.11^2^2^3170125^^
"KRN",19.1,707,1,1,0)
This key is used by the National Drug File (PSN) package to grant certain
"KRN",19.1,707,1,2,0)
users privileges to perform configuration updates.
"MBREQ")
0
"ORD",3,19.1)
19.1;3;;;KEY^XPDTA1;KEYF1^XPDIA1;KEYE1^XPDIA1;KEYF2^XPDIA1;;KEYDEL^XPDIA1
"ORD",3,19.1,0)
SECURITY KEY
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",136,-1)
1^1
"PKG",136,0)
NATIONAL DRUG FILE^PSN^This is the National Drug File Package V 3.14
"PKG",136,20,0)
^9.402P^^
"PKG",136,22,0)
^9.49I^1^1
"PKG",136,22,1,0)
4.0^2981030^2981223^11595
"PKG",136,22,1,"PAH",1,0)
513^3171215^10000000068
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
26
"RTN","PSN513PO")
0^^B71890628^n/a
"RTN","PSN513PO",1,0)
PSN513PO ;BIR/SJA-Post install routine for patch PSN*4*513 ; 19 Jan 2017  1:20 PM
"RTN","PSN513PO",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSN513PO",3,0)
 ;
"RTN","PSN513PO",4,0)
 Q
"RTN","PSN513PO",5,0)
POST ; -- post-install entry
"RTN","PSN513PO",6,0)
 N II,PSNA,ITEM,PSNSVR1 S PSSMXUA2=1
"RTN","PSN513PO",7,0)
 ; delete invalid hazard waste entries 
"RTN","PSN513PO",8,0)
 S II=0 F  S II=$O(^PSNDF(50.68,II)) Q:'II  D
"RTN","PSN513PO",9,0)
 . I $G(^PSNDF(50.68,II,"HAZTODIS2",0))=0 K ^PSNDF(50.68,II,"HAZTODIS2",0)
"RTN","PSN513PO",10,0)
 ;
"RTN","PSN513PO",11,0)
 D BMES^XPDUTL("Rebuilding National Drug File Menu....")
"RTN","PSN513PO",12,0)
 D ADD
"RTN","PSN513PO",13,0)
 D BMES^XPDUTL("Rebuilding menus complete.")
"RTN","PSN513PO",14,0)
 D PPSN
"RTN","PSN513PO",15,0)
 D SETWS
"RTN","PSN513PO",16,0)
 S PSNSVR1=$$FILESRVR("PPSN","vaausppsapp21.aac.domain.ext",443)
"RTN","PSN513PO",17,0)
 D SERVICE("UPDATE_STATUS","PPSN",PSNSVR1) ; add web service to web server
"RTN","PSN513PO",18,0)
 Q
"RTN","PSN513PO",19,0)
 ;
"RTN","PSN513PO",20,0)
ADD ; -- add new menu option and update order for PSNMGR & PSN PPS MENU
"RTN","PSN513PO",21,0)
 S PSNA=$$ADD^XPDMENU("PSNMGR","PSNPMIS PRINT","PMIS",9)
"RTN","PSN513PO",22,0)
 S PSNA=$$ADD^XPDMENU("PSNMGR","PSN MED GUIDE","FDA",10)
"RTN","PSN513PO",23,0)
 S PSNA=$$ADD^XPDMENU("PSNMGR","PSN PPS MENU","PPS",20)
"RTN","PSN513PO",24,0)
 D BMES^XPDUTL("  PSN PPS MENU option "_$S('+$G(PSNA):"NOT ",1:"")_"added to menu PSNMGR")
"RTN","PSN513PO",25,0)
 D BMES^XPDUTL("Updating PSN PPS MENU menu display order...")
"RTN","PSN513PO",26,0)
 S ITEM="PSN PPS SCHEDULE DOWNLOAD",PSNA=$$ADD^XPDMENU("PSN PPS MENU",ITEM,"SD",1) D MSG(ITEM,PSNA)
"RTN","PSN513PO",27,0)
 S ITEM="PSN PPS SCHEDULE INSTALL",PSNA=$$ADD^XPDMENU("PSN PPS MENU",ITEM,"SI",2)
"RTN","PSN513PO",28,0)
 S ITEM="PSN PPS MANUAL DOWNLOAD",PSNA=$$ADD^XPDMENU("PSN PPS MENU",ITEM,"MD",3)
"RTN","PSN513PO",29,0)
 S ITEM="PSN PPS MANUAL INSTALL",PSNA=$$ADD^XPDMENU("PSN PPS MENU",ITEM,"MI",4)
"RTN","PSN513PO",30,0)
 S ITEM="PSN PPS REJECT FILE",PSNA=$$ADD^XPDMENU("PSN PPS MENU",ITEM,"RJ",5)
"RTN","PSN513PO",31,0)
 S ITEM="PSN PPS PARAM",PSNA=$$ADD^XPDMENU("PSN PPS MENU",ITEM,"SP",6)
"RTN","PSN513PO",32,0)
 D MES^XPDUTL("Display order updated")
"RTN","PSN513PO",33,0)
 Q
"RTN","PSN513PO",34,0)
MSG(ITEM,PSNA) ; -- write message
"RTN","PSN513PO",35,0)
 D BMES^XPDUTL("  "_ITEM_" option "_$S('+$G(PSNA):"NOT ",1:"")_"added to menu PSN PPS MENU")
"RTN","PSN513PO",36,0)
 Q
"RTN","PSN513PO",37,0)
PPSN ; -- add new entry in ^PS(57.23 if it doesn't exist
"RTN","PSN513PO",38,0)
 Q:$O(^PS(57.23,0))
"RTN","PSN513PO",39,0)
 N PSNTN,RADD,RUSR
"RTN","PSN513PO",40,0)
 K DA,DIC S X="PPSN",DIC="^PS(57.23,",DIC(0)="L" D FILE^DICN K DIC
"RTN","PSN513PO",41,0)
 S PSNTN=+Y
"RTN","PSN513PO",42,0)
 S RADD="vaausmocftpprd01.aac.domain.ext",RUSR="presftp"
"RTN","PSN513PO",43,0)
 S DA=PSNTN,DIE=57.23,DR="2///0;8///0;9///N;10///N;20///"_RADD_";22///"_RUSR_";45///Y" D ^DIE K DR
"RTN","PSN513PO",44,0)
 S $P(^PS(59.7,1,10),"^",12)="P"
"RTN","PSN513PO",45,0)
 Q
"RTN","PSN513PO",46,0)
 ;
"RTN","PSN513PO",47,0)
SETWS ;define UPDATE_STATUS web service
"RTN","PSN513PO",48,0)
 N PSSWSERV,PSSWSER2,PPSWPPSN,PSSWSCNT,PSSWSMSG,PSSWSSTA,PSSWSERR,DA,DIE,DIC,DR,X,Y,DLAYGO,WSARR
"RTN","PSN513PO",49,0)
 S (PSSWSERR,PSSWSCNT)=0,PSSMXUA2=1
"RTN","PSN513PO",50,0)
 S DIC="^XOB(18.12,",X="PPSN",DIC(0)="X" D ^DIC
"RTN","PSN513PO",51,0)
 I Y<1 D
"RTN","PSN513PO",52,0)
 .D BMES^XPDUTL("  Creating PPSN web server.") S PSSMXUA2=PSSMXUA2+1
"RTN","PSN513PO",53,0)
 .S WSARR("WSDL FILE")=""
"RTN","PSN513PO",54,0)
 .S WSARR("CACHE PACKAGE NAME")=""
"RTN","PSN513PO",55,0)
 .S WSARR("WEB SERVICE NAME")="PPSN"
"RTN","PSN513PO",56,0)
 .S WSARR("AVAILABILITY RESOURCE")="?wsdl"
"RTN","PSN513PO",57,0)
 .S XOBSTAT=$$GENPORT^XOBWLIB(.WSARR)
"RTN","PSN513PO",58,0)
 .S DIC="^XOB(18.12,",X="PPSN",DIC(0)=X
"RTN","PSN513PO",59,0)
 S PPSWPPSN=+Y K DIC  ;find the PPSN web server IEN
"RTN","PSN513PO",60,0)
 D BMES^XPDUTL("Beginning UPDATE_STATUS Web Service definition for PPSN web server: ")
"RTN","PSN513PO",61,0)
 S @XPDGREF@("PSSMLMSG",PSSMXUA2)="Beginning UPDATE_STATUS Web Service definition: " S PSSMXUA2=PSSMXUA2+1
"RTN","PSN513PO",62,0)
 I PPSWPPSN=-1 D  G SETWSQT
"RTN","PSN513PO",63,0)
 .D BMES^XPDUTL("     PPSN Web Server is not defined. Please contact product support.") S PSSWSERR=1
"RTN","PSN513PO",64,0)
 .S @XPDGREF@("PSSMLMSG",PSSMXUA2)="  PPSN Web Server isn't defined and UPDATE_STATUS Web Service couldn't be" S PSSMXUA2=PSSMXUA2+1
"RTN","PSN513PO",65,0)
 .S @XPDGREF@("PSSMLMSG",PSSMXUA2)="     created.  Please log a National Help Desk Ticket and refer to this message." S PSSMXUA2=PSSMXUA2+1
"RTN","PSN513PO",66,0)
SETWS2 ;
"RTN","PSN513PO",67,0)
 S DIC="^XOB(18.02,",X="UPDATE_STATUS",DIC(0)="X" D ^DIC S PSSWSERV=+Y ;get the IEN for the UPDATE_STATUS web service
"RTN","PSN513PO",68,0)
 I +Y<1,PSSWSCNT=0 D REGREST^XOBWLIB("UPDATE_STATUS","/PRE/ndf/update/","status") H 3 S PSSWSCNT=1 G SETWS2  ;if not there register the web service
"RTN","PSN513PO",69,0)
 I +Y<1 D  H 3 G SETWSQT
"RTN","PSN513PO",70,0)
 .D BMES^XPDUTL("  UPDATE_STATUS web service has NOT been created. Please contact product support.")
"RTN","PSN513PO",71,0)
 .S @XPDGREF@("PSSMLMSG",PSSMXUA2)="  UPDATE_STATUS web service has NOT been defined.  Please log a" S PSSMXUA2=PSSMXUA2+1,PSSWSERR=1
"RTN","PSN513PO",72,0)
 .S @XPDGREF@("PSSMLMSG",PSSMXUA2)="  National Help Desk ticket and refer to this message." S PSSMXUA2=PSSMXUA2+1
"RTN","PSN513PO",73,0)
 .S @XPDGREF@("PSSMLMSG",PSSMXUA2)=" " S PSSMXUA2=PSSMXUA2+1
"RTN","PSN513PO",74,0)
 S PSSWSMSG=$S(PSSWSCNT=0:"UPDATE_STATUS web service was previously defined.  No action taken.",1:"UPDATE_STATUS web service has been defined.")
"RTN","PSN513PO",75,0)
 S @XPDGREF@("PSSMLMSG",PSSMXUA2)="  "_PSSWSMSG S PSSMXUA2=PSSMXUA2+1
"RTN","PSN513PO",76,0)
 D BMES^XPDUTL("     "_PSSWSMSG)
"RTN","PSN513PO",77,0)
 ;
"RTN","PSN513PO",78,0)
 K DIC,DIE,DA,DR,X,Y
"RTN","PSN513PO",79,0)
 S DIC="^XOB(18.12,"_PPSWPPSN_",100,",X="UPDATE_STATUS",DIC(0)="X" D ^DIC S PSSWSER2=+Y
"RTN","PSN513PO",80,0)
 L +^XOB(18.12,PPSWPPSN):20 I '$T D  H 3 G SETWSQT
"RTN","PSN513PO",81,0)
 .D BMES^XPDUTL("     Unable to lock file 18.12 to enable UPDATE_STATUS web service. Please ")
"RTN","PSN513PO",82,0)
 .D BMES^XPDUTL("     contact product support.")
"RTN","PSN513PO",83,0)
 .S @XPDGREF@("PSSMLMSG",PSSMXUA2)="  Unable to lock file 18.12 to enable UPDATE_STATUS web service." S PSSMXUA2=PSSMXUA2+1
"RTN","PSN513PO",84,0)
 .S @XPDGREF@("PSSMLMSG",PSSMXUA2)="  Please contact the National Help Desk and refer to this message." S PSSMXUA2=PSSMXUA2+1,PSSWSERR=1
"RTN","PSN513PO",85,0)
 I PSSWSER2=-1 D PSSENABL G SETWSQT
"RTN","PSN513PO",86,0)
 S PSSWSSTA=$$GET1^DIQ(18.121,PSSWSER2_",1",".06","I")
"RTN","PSN513PO",87,0)
 I PSSWSSTA=-1 D PSSENABL G SETWSQT
"RTN","PSN513PO",88,0)
 I PSSWSSTA=""!(PSSWSSTA=0) D PSSENAB2 G SETWSQT
"RTN","PSN513PO",89,0)
 I PSSWSSTA D
"RTN","PSN513PO",90,0)
 .D BMES^XPDUTL("     UPDATE_STATUS web service was previously enabled.  No action taken.")
"RTN","PSN513PO",91,0)
 .S @XPDGREF@("PSSMLMSG",PSSMXUA2)="  UPDATE_STATUS web service was previously enabled. No action taken." S PSSMXUA2=PSSMXUA2+1
"RTN","PSN513PO",92,0)
SETWSQT ;
"RTN","PSN513PO",93,0)
 L -^XOB(18.12,PPSWPPSN)
"RTN","PSN513PO",94,0)
 I $G(PSSWSERR) D
"RTN","PSN513PO",95,0)
 .D BMES^XPDUTL("  **************************************************************************")
"RTN","PSN513PO",96,0)
 .D BMES^XPDUTL("  ** Due to error(s), UPDATE_STATUS web service definition is not complete. **")
"RTN","PSN513PO",97,0)
 .D BMES^XPDUTL("  **************************************************************************")
"RTN","PSN513PO",98,0)
 .S @XPDGREF@("PSSMLMSG",PSSMXUA2)="*** Due to error(s), UPDATE_STATUS web service definition is not complete." S PSSMXUA2=PSSMXUA2+1
"RTN","PSN513PO",99,0)
 I '$G(PSSWSERR) D BMES^XPDUTL("Web Service definition process is complete for PPSN web server.") D
"RTN","PSN513PO",100,0)
 .S @XPDGREF@("PSSMLMSG",PSSMXUA2)="Web Service definition process is complete." S PSSMXUA2=PSSMXUA2+1
"RTN","PSN513PO",101,0)
 D LINE
"RTN","PSN513PO",102,0)
 Q
"RTN","PSN513PO",103,0)
 ;
"RTN","PSN513PO",104,0)
LINE ;
"RTN","PSN513PO",105,0)
 S @XPDGREF@("PSSMLMSG",PSSMXUA2)=" " S PSSMXUA2=PSSMXUA2+1
"RTN","PSN513PO",106,0)
 Q
"RTN","PSN513PO",107,0)
 ;
"RTN","PSN513PO",108,0)
PSSENABL ;
"RTN","PSN513PO",109,0)
 S DIC="^XOB(18.12,"_PPSWPPSN_",100,",DLAYGO=18.121,DIC(0)="L",DA(1)=PPSWPPSN,X="UPDATE_STATUS" D ^DIC S PSSWSER2=+Y
"RTN","PSN513PO",110,0)
PSSENAB2 ;
"RTN","PSN513PO",111,0)
 S DIE="^XOB(18.12,"_PPSWPPSN_",100,",DR=".06///ENABLE",DA(1)=PPSWPPSN,DA=PSSWSER2 D ^DIE
"RTN","PSN513PO",112,0)
 S PSSWSSTA=$$GET1^DIQ(18.121,PSSWSER2_",1",".06","I")
"RTN","PSN513PO",113,0)
 I PSSWSSTA D
"RTN","PSN513PO",114,0)
 .D BMES^XPDUTL("     UPDATE_STATUS web service has been enabled.")
"RTN","PSN513PO",115,0)
 .S @XPDGREF@("PSSMLMSG",PSSMXUA2)="  UPDATE_STATUS web service has been enabled." S PSSMXUA2=PSSMXUA2+1
"RTN","PSN513PO",116,0)
 Q
"RTN","PSN513PO",117,0)
 ;
"RTN","PSN513PO",118,0)
FILESRVR(PSNSRVR,PSNADRS,PSNPORT) ; File a new record in file #18.12 or edit existing
"RTN","PSN513PO",119,0)
 ; Input: PSNSRVR - web server name
"RTN","PSN513PO",120,0)
 ;        PSNADRS - web server address
"RTN","PSN513PO",121,0)
 ;        PSNPORT - port number
"RTN","PSN513PO",122,0)
 ; Output:
"RTN","PSN513PO",123,0)
 ;        Function Value - Returns IEN of record on success, 0 on failure
"RTN","PSN513PO",124,0)
 ;
"RTN","PSN513PO",125,0)
 N FDA,FDAI,PSNERR,PSNIENS,PSNIEN,DIERR
"RTN","PSN513PO",126,0)
 S PSNIEN=+$$FIND1^DIC(18.12,"","BX",PSNSRVR,"","","")
"RTN","PSN513PO",127,0)
 ;
"RTN","PSN513PO",128,0)
 ; If record doesn't already exist, create new
"RTN","PSN513PO",129,0)
 I PSNIEN S PSNIENS=PSNIEN_","
"RTN","PSN513PO",130,0)
 E  S PSNIENS="+1,"
"RTN","PSN513PO",131,0)
 D BMES^XPDUTL($S(PSNIEN:"Updating",1:"Creating")_" PPSN Web Server...")
"RTN","PSN513PO",132,0)
 S @XPDGREF@("PSSMLMSG",PSSMXUA2)=$S(PSNIEN:"Updating",1:"Creating")_" PPSN Web Server..."
"RTN","PSN513PO",133,0)
 S PSSMXUA2=PSSMXUA2+1
"RTN","PSN513PO",134,0)
 ;
"RTN","PSN513PO",135,0)
 ; Set up FDA with field values
"RTN","PSN513PO",136,0)
 S FDA(18.12,PSNIENS,.01)=$G(PSNSRVR) ;server name
"RTN","PSN513PO",137,0)
 S FDA(18.12,PSNIENS,.03)=$G(PSNPORT) ;ws port nbr
"RTN","PSN513PO",138,0)
 I 'PSNIEN S FDA(18.12,PSNIENS,.04)=$G(PSNADRS) ;server address
"RTN","PSN513PO",139,0)
 S FDA(18.12,PSNIENS,.06)=1 ;status
"RTN","PSN513PO",140,0)
 S FDA(18.12,PSNIENS,.07)=30 ;timeout
"RTN","PSN513PO",141,0)
 S FDA(18.12,PSNIENS,3.01)=1 ;ssl enabled
"RTN","PSN513PO",142,0)
 S FDA(18.12,PSNIENS,3.02)="encrypt_only" ;SSL configuration
"RTN","PSN513PO",143,0)
 S FDA(18.12,PSNIENS,3.03)=443 ;SSL port number
"RTN","PSN513PO",144,0)
 ;
"RTN","PSN513PO",145,0)
 I PSNIEN D  ;update current record
"RTN","PSN513PO",146,0)
 . D FILE^DIE("K","FDA","PSNERR")
"RTN","PSN513PO",147,0)
 . I $D(PSNERR) D
"RTN","PSN513PO",148,0)
 . . D DISPERR($NA(PSNERR),PSSMXUA2)
"RTN","PSN513PO",149,0)
 . . S PSNIEN=0
"RTN","PSN513PO",150,0)
 E  D  ;create new record
"RTN","PSN513PO",151,0)
 . D UPDATE^DIE("","FDA","FDAI","PSNERR")
"RTN","PSN513PO",152,0)
 . I $D(PSNERR) D
"RTN","PSN513PO",153,0)
 . . D DISPERR($NA(PSNERR),PSSMXUA2)
"RTN","PSN513PO",154,0)
 . . S PSNIEN=0
"RTN","PSN513PO",155,0)
 . E  D
"RTN","PSN513PO",156,0)
 . . S PSNIEN=$G(FDAI(1))
"RTN","PSN513PO",157,0)
 ;
"RTN","PSN513PO",158,0)
 Q $S($G(PSNIEN)>0:PSNIEN,1:0)
"RTN","PSN513PO",159,0)
 ;
"RTN","PSN513PO",160,0)
SERVICE(SVCS,SRVR,SVRIEN) ; add web service to web server
"RTN","PSN513PO",161,0)
 ; Input: SVCS   - web service name
"RTN","PSN513PO",162,0)
 ;        SRVR   - web server name
"RTN","PSN513PO",163,0)
 ;        SVRIEN - web server ien
"RTN","PSN513PO",164,0)
 ;
"RTN","PSN513PO",165,0)
 N SVCIEN,PSNIENS,PSNFDA,PSNFDAI,PSNERR,DIERR
"RTN","PSN513PO",166,0)
 ;
"RTN","PSN513PO",167,0)
 S SVCIEN=+$$FIND1^DIC(18.02,"","BX",SVCS,"","","")
"RTN","PSN513PO",168,0)
 I '$D(^XOB(18.12,"AB",SVCIEN,SVRIEN)) D
"RTN","PSN513PO",169,0)
 . ;add sub rec
"RTN","PSN513PO",170,0)
 . S PSNIENS="+1,"_SVRIEN_","
"RTN","PSN513PO",171,0)
 . S PSNFDA(18.121,PSNIENS,.01)=SVCIEN ;service ien
"RTN","PSN513PO",172,0)
 . S PSNFDA(18.121,PSNIENS,.06)=1 ;status
"RTN","PSN513PO",173,0)
 . D UPDATE^DIE("","PSNFDA","PSNFDAI","PSNERR")
"RTN","PSN513PO",174,0)
 . I $D(DIERR) D
"RTN","PSN513PO",175,0)
 . . D DISPERR($NA(PSNERR))
"RTN","PSN513PO",176,0)
 . . D MES^XPDUTL(" o  ERROR occurred registering WEB SERVICE '"_SVCS_"' to WEB SERVER '"_SRVR_"'")
"RTN","PSN513PO",177,0)
 . . D MES^XPDUTL(" ")
"RTN","PSN513PO",178,0)
 . E  D
"RTN","PSN513PO",179,0)
 . . D MES^XPDUTL(" o  WEB SERVICE '"_SVCS_"' was registered to WEB SERVER '"_SRVR_"'")
"RTN","PSN513PO",180,0)
 . . D MES^XPDUTL(" ")
"RTN","PSN513PO",181,0)
 . D CLEAN^DILF
"RTN","PSN513PO",182,0)
 E  D
"RTN","PSN513PO",183,0)
 . D MES^XPDUTL(" o  WEB SERVICE '"_SVCS_"' already registered to WEB SERVER '"_SRVR_"'")
"RTN","PSN513PO",184,0)
 . D MES^XPDUTL(" ")
"RTN","PSN513PO",185,0)
 Q
"RTN","PSN513PO",186,0)
 ;
"RTN","PSN513PO",187,0)
DISPERR(PSNARR,PSSMXUA2) ; display error message
"RTN","PSN513PO",188,0)
 N PSNOUT,PSNI
"RTN","PSN513PO",189,0)
 W !,"Database Server Error Information:" S PSSMXUA2=PSSMXUA2+1
"RTN","PSN513PO",190,0)
 D MSG^DIALOG("AE",.PSNOUT,70,"",PSNARR)
"RTN","PSN513PO",191,0)
 F PSNI=1:1 Q:$D(PSNOUT(PSNI))=0  W !,$G(PSNOUT(PSNI)) S PSSMXUA2=PSSMXUA2+1
"RTN","PSN513PO",192,0)
 Q
"RTN","PSN513PO",193,0)
 ;
"RTN","PSNCFINQ")
0^24^B51923740^n/a
"RTN","PSNCFINQ",1,0)
PSNCFINQ ;BIR/PC - Control File Inquiry Screen ;01/30/2017
"RTN","PSNCFINQ",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNCFINQ",3,0)
 ;
"RTN","PSNCFINQ",4,0)
 N PSNCFBEG,PSNCFEND,PSNCFB,PSNCFE,PSNCFIEN,CNT,PSNCFAX
"RTN","PSNCFINQ",5,0)
 K DIC,DIR
"RTN","PSNCFINQ",6,0)
ASK ;ask if Download or Install Inquiry
"RTN","PSNCFINQ",7,0)
 S (PSNCFOUT,PSNCFQ)=0,PSNCFPG=1,$P(PSNCFLIN,"-",78)=""
"RTN","PSNCFINQ",8,0)
 W ! K DIR,Y S DIR(0)="SA^D:DOWNLOAD;I:INSTALL;Q:QUIT"
"RTN","PSNCFINQ",9,0)
 S DIR("A")="Select (D)ownload Detail, (I)nstall Detail or (Q)uit: "
"RTN","PSNCFINQ",10,0)
 D ^DIR I Y="Q"!$D(DIRUT) G END
"RTN","PSNCFINQ",11,0)
 S PSNCFAX=Y
"RTN","PSNCFINQ",12,0)
 D DATE I PSNCFQ=1 G END
"RTN","PSNCFINQ",13,0)
ASK1 ;
"RTN","PSNCFINQ",14,0)
 D @$S(PSNCFAX="I":"ISUM",1:"DSUM") I PSNCFQ=1 G ASK
"RTN","PSNCFINQ",15,0)
 D CHOOSE I PSNCFQ=1!($D(DIRUT)) G ASK
"RTN","PSNCFINQ",16,0)
 K PSNCFAR D GETS^DIQ(57.23,1,".01;1;2;3;5;6;8;9;10","E","PSNCFAR") ;ZERO level
"RTN","PSNCFINQ",17,0)
 S PSNINNM=$S(PSNCFAX="I":$$GET1^DIQ(57.231,PSNCFIEN_",1,",.01,"E"),1:$$GET1^DIQ(57.234,PSNCFIEN_",1,",.01,"E"))
"RTN","PSNCFINQ",18,0)
 I PSNCFAX="I" D INSTALL S PSNCFQ=0 G ASK1
"RTN","PSNCFINQ",19,0)
 I PSNCFAX="D" D DOWNLD,CONT G ASK1
"RTN","PSNCFINQ",20,0)
 Q
"RTN","PSNCFINQ",21,0)
DATE ;enter date range for list of .DAT files
"RTN","PSNCFINQ",22,0)
 N %DT,X K PSNDT
"RTN","PSNCFINQ",23,0)
 S %DT(0)=-DT,%DT="AEP",%DT("A")="Enter Start Date: " W ! D ^%DT I Y<0!($D(DTOUT)) S PSNCFQ=1 Q
"RTN","PSNCFINQ",24,0)
 S PSNCFBEG=Y\1-.00001,PSNCFB=Y
"RTN","PSNCFINQ",25,0)
 S %DT(0)=PSNCFBEG+1\1,%DT("A")="Enter End Date: " W ! D ^%DT I Y<0!($D(DTOUT)) S PSNCFQ=1 Q
"RTN","PSNCFINQ",26,0)
 S PSNCFEND=Y\1+.99999,PSNCFE=Y
"RTN","PSNCFINQ",27,0)
 S PSNCFL2=$$FMTE^XLFDT(PSNCFB)_" to "_$$FMTE^XLFDT(PSNCFE)
"RTN","PSNCFINQ",28,0)
 S PSNCFOUT=0,PSNCFDEV=$S($E(IOST,1,2)'="C-":"P",1:"C"),PSNCFPG=1
"RTN","PSNCFINQ",29,0)
 Q
"RTN","PSNCFINQ",30,0)
 ;
"RTN","PSNCFINQ",31,0)
ISUM ; SUMMARY SCREEN FOR INSTALL FILES
"RTN","PSNCFINQ",32,0)
 K PSNX1,PSNCARR S PSNCFPG=1,PSNJ=""
"RTN","PSNCFINQ",33,0)
 D HEAD S CNT=0,PSNCFOUT=0
"RTN","PSNCFINQ",34,0)
 I '$D(PSNDT) S PSNX1=PSNCFBEG F  S PSNX1=$O(^PS(57.23,1,5,"C",PSNX1)) Q:PSNX1=""!(PSNX1>PSNCFEND)  F  S PSNJ=$O(^PS(57.23,1,5,"C",PSNX1,PSNJ)) Q:PSNJ=""  S PSNDT(PSNJ)=PSNX1
"RTN","PSNCFINQ",35,0)
 S PSNCFIEN=0 F  S PSNCFIEN=$O(PSNDT(PSNCFIEN)) Q:PSNCFIEN=""  D GETS^DIQ(57.231,PSNCFIEN_",1",".01;1;2","E","PSNCARR") D  Q:PSNCFOUT=1
"RTN","PSNCFINQ",36,0)
 . S CNT=CNT+1,PSNCFSM(CNT)=PSNCFIEN_"^"_PSNCARR(57.231,PSNCFIEN_",1,",.01,"E")
"RTN","PSNCFINQ",37,0)
 . W !,"("_CNT_") ",PSNCARR(57.231,PSNCFIEN_",1,",.01,"E"),?32,PSNCARR(57.231,PSNCFIEN_",1,",1,"E"),?55,PSNCARR(57.231,PSNCFIEN_",1,",2,"E")
"RTN","PSNCFINQ",38,0)
 . I ($Y+5)>IOSL D HEAD Q:PSNCFOUT=1
"RTN","PSNCFINQ",39,0)
 W !! I CNT=0 W !!,"No Install files for date range chosen.  Please enter new dates.",$C(7) W ! D CONT S PSNCFQ=1
"RTN","PSNCFINQ",40,0)
 Q
"RTN","PSNCFINQ",41,0)
 ;
"RTN","PSNCFINQ",42,0)
DSUM ; SUMMARY SCREEN FOR DOWNLOAD FILES
"RTN","PSNCFINQ",43,0)
 K PSNX1,PSNCARD S PSNCFPG=1,PSNJ=""
"RTN","PSNCFINQ",44,0)
 D HEAD S CNT=0,PSNCFOUT=0
"RTN","PSNCFINQ",45,0)
 I '$D(PSNDT) S PSNX1=PSNCFBEG F  S PSNX1=$O(^PS(57.23,1,4,"D",PSNX1)) Q:PSNX1=""!(PSNX1>PSNCFEND)  F  S PSNJ=$O(^PS(57.23,1,4,"D",PSNX1,PSNJ)) Q:PSNJ=""  S PSNDT(PSNJ)=PSNX1
"RTN","PSNCFINQ",46,0)
 S PSNCFIEN=0 F  S PSNCFIEN=$O(PSNDT(PSNCFIEN)) Q:PSNCFIEN=""  D GETS^DIQ(57.234,PSNCFIEN_",1",".01;1;2","E","PSNCARD") D  Q:PSNCFOUT=1
"RTN","PSNCFINQ",47,0)
 . S CNT=CNT+1,PSNCFSM(CNT)=PSNCFIEN_"^"_PSNCARD(57.234,PSNCFIEN_",1,",.01,"E")
"RTN","PSNCFINQ",48,0)
 . W !,"("_CNT_") ",PSNCARD(57.234,PSNCFIEN_",1,",.01,"E"),?32,PSNCARD(57.234,PSNCFIEN_",1,",1,"E"),?55,PSNCARD(57.234,PSNCFIEN_",1,",2,"E")
"RTN","PSNCFINQ",49,0)
 . I ($Y+5)>IOSL D HEAD Q:PSNCFOUT=1
"RTN","PSNCFINQ",50,0)
 W !! I CNT=0 W !!,"No Download files for date range chosen.  Please enter new dates.",$C(7) W ! D CONT S PSNCFQ=1
"RTN","PSNCFINQ",51,0)
 Q
"RTN","PSNCFINQ",52,0)
 ;
"RTN","PSNCFINQ",53,0)
HEAD ; SUMMARY HEADER PAGE
"RTN","PSNCFINQ",54,0)
 I $G(PSNCFPG)'=1 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue, '^' to exit" D ^DIR K DIR I 'Y S PSNCFOUT=1 Q
"RTN","PSNCFINQ",55,0)
 W @IOF
"RTN","PSNCFINQ",56,0)
 W !,$S(PSNCFAX="D":"DOWNLOAD",1:"INSTALL")_" FILE NAME",?32,$S(PSNCFAX="D":"DOWNLOAD",1:"INSTALL")_" BEGIN DT/TM",?55,"COMPLETION DT/TM"
"RTN","PSNCFINQ",57,0)
 W !,PSNCFL2,?68,"PAGE: "_PSNCFPG,!,PSNCFLIN S PSNCFPG=PSNCFPG+1
"RTN","PSNCFINQ",58,0)
 Q
"RTN","PSNCFINQ",59,0)
 ;
"RTN","PSNCFINQ",60,0)
HEAD1(PSNH) ; DETAIL HEADER PAGE
"RTN","PSNCFINQ",61,0)
 ;PSNP = DETAIL OR ERROR
"RTN","PSNCFINQ",62,0)
 I $G(PSNCFPG)'=1 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue, '^' to exit" D ^DIR K DIR I 'Y S PSNCFQ=1 Q
"RTN","PSNCFINQ",63,0)
 W @IOF
"RTN","PSNCFINQ",64,0)
 W !,PSNH_" INFORMATION FOR FILE "_PSNINNM
"RTN","PSNCFINQ",65,0)
 W !,?68,"PAGE: "_PSNCFPG,!,PSNCFLIN S PSNCFPG=PSNCFPG+1
"RTN","PSNCFINQ",66,0)
 Q
"RTN","PSNCFINQ",67,0)
 ;
"RTN","PSNCFINQ",68,0)
CHOOSE ;File Selection
"RTN","PSNCFINQ",69,0)
 K DIR,X,Y,DIRUT,DUOUT S PSNCFQ=0 S DIR(0)="LA^1:"_CNT
"RTN","PSNCFINQ",70,0)
 S DIR("A")="Select "_$S(PSNCFAX="D":"a Download",1:"an Install")_" File for greater detail. Choose 1-"_CNT_" or '^' to Quit: "
"RTN","PSNCFINQ",71,0)
 S DIR("?")="Select from the above list of files or a enter '^' to Quit."
"RTN","PSNCFINQ",72,0)
 D ^DIR I $D(DIRUT)!($D(DUOUT)) S PSNCFQ=1 Q
"RTN","PSNCFINQ",73,0)
 S PSNCFANS=$P(Y,",",1),PSNCFIEN=$P(PSNCFSM(PSNCFANS),"^",1)
"RTN","PSNCFINQ",74,0)
 Q
"RTN","PSNCFINQ",75,0)
 ;
"RTN","PSNCFINQ",76,0)
INSTALL ; INSTALL SCREEN
"RTN","PSNCFINQ",77,0)
 K PSNCFARR
"RTN","PSNCFINQ",78,0)
 D GETS^DIQ(57.231,PSNCFIEN_",1,","**","ERN","PSNCFARR")  ;INSTALL INFORMATION
"RTN","PSNCFINQ",79,0)
 W !!,"Current Install Status:",!,"-----------------------"
"RTN","PSNCFINQ",80,0)
 W !,"Name: ",?30,$G(PSNCFAR(57.23,"1,",.01,"E"))
"RTN","PSNCFINQ",81,0)
 W !,"Open VMS Local Directory:",?30,$G(PSNCFAR(57.23,"1,",1,"E"))
"RTN","PSNCFINQ",82,0)
 W !,"UNIX/LINUX Local Directory:",?30,$G(PSNCFAR(57.23,"1,",3,"E"))
"RTN","PSNCFINQ",83,0)
 W !,"PPS-N Install Version:",?30,$G(PSNCFAR(57.23,"1,",2,"E"))
"RTN","PSNCFINQ",84,0)
 W !,"PPS-N Mail Group:",?30,$G(PSNCFAR(57.23,"1,",5,"E"))
"RTN","PSNCFINQ",85,0)
 W !,"Secondary Mail Group:",?30,$G(PSNCFAR(57.23,"1,",6,"E"))
"RTN","PSNCFINQ",86,0)
 W !,"PPS-N Download Version:",?30,$G(PSNCFAR(57.23,"1,",8,"E"))
"RTN","PSNCFINQ",87,0)
 W !,"Download Status:",?30,$G(PSNCFAR(57.23,"1,",9,"E"))
"RTN","PSNCFINQ",88,0)
 W !,"Install Status:",?30,$G(PSNCFAR(57.23,"1,",10,"E"))
"RTN","PSNCFINQ",89,0)
 W !!,"Install Information for file "_PSNINNM_":",!,"--------------------------------------------------"
"RTN","PSNCFINQ",90,0)
 W !,"Install Begin Date/Time:",?30,$G(PSNCFARR(57.231,PSNCFIEN_",1,","INSTALL BEGIN DATE/TIME","E"))
"RTN","PSNCFINQ",91,0)
 W !,"Install Completion Date/Time:",?30,$G(PSNCFARR(57.231,PSNCFIEN_",1,","INSTALL COMPLETION DATE/TIME","E"))
"RTN","PSNCFINQ",92,0)
 W !,"Last VistA file processed:",?30,$G(PSNCFARR(57.231,PSNCFIEN_",1,","LAST VISTA FILE PROCESSED","E"))
"RTN","PSNCFINQ",93,0)
 W !,"Last File IEN processed:",?30,$G(PSNCFARR(57.231,PSNCFIEN_",1,","LAST FILE IEN PROCESSED","E"))
"RTN","PSNCFINQ",94,0)
 W !,"Last TMP file subscript:",?30,$G(PSNCFARR(57.231,PSNCFIEN_",1,","LAST TMP FILE SUBSCRIPT","E"))
"RTN","PSNCFINQ",95,0)
 W !,"Last Update file section:",?30,$G(PSNCFARR(57.231,PSNCFIEN_",1,","LAST UPDATE FILE SECTION","E"))
"RTN","PSNCFINQ",96,0)
 W !,"Displayed Last:",?30,$G(PSNCFARR(57.231,PSNCFIEN_",1,","DISPLAYED LAST","E"))
"RTN","PSNCFINQ",97,0)
 ; ask if Error or Quit
"RTN","PSNCFINQ",98,0)
 W ! K DIR,Y S DIR(0)="SA^E:ERROR;Q:QUIT"
"RTN","PSNCFINQ",99,0)
 S DIR("A")="Select (E)rror Detail or (Q)uit: "
"RTN","PSNCFINQ",100,0)
 D ^DIR I Y="Q"!$D(DIRUT) S PSNCFQ=1 Q
"RTN","PSNCFINQ",101,0)
 S PSNCFXX=Y
"RTN","PSNCFINQ",102,0)
 I PSNCFXX="E" D ERROR G INSTALL
"RTN","PSNCFINQ",103,0)
 Q
"RTN","PSNCFINQ",104,0)
DOWNLD ; DOWNLOAD HISTORY
"RTN","PSNCFINQ",105,0)
 S PSNCFPG=1,PSFLG=0 D HEAD1("DOWNLOAD")
"RTN","PSNCFINQ",106,0)
 S PSNJ="" F  S PSNJ=$O(^PS(57.23,1,4,"B",$P(PSNINNM,";",1),PSNJ)) Q:PSNJ=""   D  I PSFLG=1 D CONT Q
"RTN","PSNCFINQ",107,0)
 . S PSNDND=$G(^PS(57.23,1,4,PSNJ,0)) I PSNDND="" W !!,"No Download Information for this file" S PSFLG=1 Q
"RTN","PSNCFINQ",108,0)
 . W !,"Download File Name:",?33,$P(PSNDND,"^",1)
"RTN","PSNCFINQ",109,0)
 . W !,"Download Begin Date/Time:",?33,$$FMTE^XLFDT($P(PSNDND,"^",2))
"RTN","PSNCFINQ",110,0)
 . W !,"Download Complete Date/Time:",?33,$$FMTE^XLFDT($P(PSNDND,"^",3))
"RTN","PSNCFINQ",111,0)
 . W !,"Download File Size:",?33,$E($P(PSNDND,"^",4),2,99)
"RTN","PSNCFINQ",112,0)
 . W !,"Download Error Message:" I $L($P(PSNDND,"^",5))<46 W ?33,$P(PSNDND,"^",5),! Q
"RTN","PSNCFINQ",113,0)
 . N X,DIWL,DIWR,DIWF S X=$P(PSNDND,"^",5),DIWL=34,DIWR=79,DIWF="W" K ^UTILITY($J,"W") D ^DIWP D ^DIWW K ^UTILITY($J,"W")
"RTN","PSNCFINQ",114,0)
 Q
"RTN","PSNCFINQ",115,0)
 ;
"RTN","PSNCFINQ",116,0)
ERROR ; INSTALL ERROR SCREEN
"RTN","PSNCFINQ",117,0)
 S PSNCFPG=1 D HEAD1("ERROR")
"RTN","PSNCFINQ",118,0)
 I '$D(^PS(57.23,1,5,PSNCFIEN,2,1,0)) W !!,"No Error Information for this file" D CONT Q
"RTN","PSNCFINQ",119,0)
 S PSNJ="" F PSNJ=1:1 S PSNJ=$O(^PS(57.23,1,5,PSNCFIEN,2,PSNJ)) Q:PSNJ=""  D
"RTN","PSNCFINQ",120,0)
 . S PSNJD=$G(^PS(57.23,1,5,PSNCFIEN,2,PSNJ,0))
"RTN","PSNCFINQ",121,0)
 . W !,"Error Date/Time:",?33,$$FMTE^XLFDT($P(PSNJD,"^",1))
"RTN","PSNCFINQ",122,0)
 . W !,"Error File:",?33,$P(PSNJD,"^",2)
"RTN","PSNCFINQ",123,0)
 . W !,"Error IEN:",?33,$P(PSNJD,"^",3)
"RTN","PSNCFINQ",124,0)
 . W !,"Error TMP file subscript:",?33,$P(PSNJD,"^",4)
"RTN","PSNCFINQ",125,0)
 . W !,"Error Message: " I $L($P(PSNJD,"^",5))<46 W ?33,$P(PSNJD,"^",5),! Q
"RTN","PSNCFINQ",126,0)
 . N X,DIWL,DIWR,DIWF S X=$P(PSNJD,"^",5),DIWL=33,DIWR=79,DIWF="W" K ^UTILITY($J,"W") D ^DIWP D ^DIWW K ^UTILITY($J,"W")
"RTN","PSNCFINQ",127,0)
 D CONT
"RTN","PSNCFINQ",128,0)
 Q
"RTN","PSNCFINQ",129,0)
 ;
"RTN","PSNCFINQ",130,0)
CONT ;
"RTN","PSNCFINQ",131,0)
 K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR
"RTN","PSNCFINQ",132,0)
 Q
"RTN","PSNCFINQ",133,0)
 ;
"RTN","PSNCFINQ",134,0)
END ; KILL VARIABLES
"RTN","PSNCFINQ",135,0)
 K X,%DT,DA,DA,DIC,DIE,DIR,DR,DIRUT,DTOUT,PSNCFAR,PSNCFER,PSNCFARR,PSNCFDEV,PSNINNM,PSNCARR,PSNDND
"RTN","PSNCFINQ",136,0)
 K PSNCFBEG,PSNCFEND,PSNCFOUT,PSNCFPG,PSNCFL2,PSNCFLIN,PSNCFBG,PSNCFIEN,PSNCFXX,PSNCFDN,PSNCFANS
"RTN","PSNCFINQ",137,0)
 K PSNCFSM,PSNDT,PSNH,PSNJ,PSNX,PSFLG,PSNJD,PSNCFAX,PSNCFQ,PSNJ,PSNCFE,PSNCFB
"RTN","PSNCFINQ",138,0)
 Q
"RTN","PSNCLEAN")
0^9^B38230094^B38230094
"RTN","PSNCLEAN",1,0)
PSNCLEAN ;BIR/DMA-clean up ingredients and interactions ; 19 Aug 2008  9:42 AM
"RTN","PSNCLEAN",2,0)
 ;;4.0;NATIONAL DRUG FILE;**117,176,513**; 3O Oct 98;Build 53
"RTN","PSNCLEAN",3,0)
 ;
"RTN","PSNCLEAN",4,0)
 ;Reference to ^GMR(120.8 supported by DBIA# 2545
"RTN","PSNCLEAN",5,0)
 ;
"RTN","PSNCLEAN",6,0)
 N DA,DIE,DIK,DR,J,LINE,NA,NEWDA,PSN,PSNDA,PSNI,PSNI1,PSNI1N,PSNI1P,PSNI2,PSNI2N,PSNI2P,PSNN,PSNK,PSNPAT,PSNX,X,XMDUZ,XMSUB,XMTEXT,XMY
"RTN","PSNCLEAN",7,0)
 K ^TMP($J),^TMP("PSN",$J)
"RTN","PSNCLEAN",8,0)
INTER ;CHECK FOR NON-PRIMARIES
"RTN","PSNCLEAN",9,0)
 S DA=0 F  S DA=$O(^PS(56,DA)) Q:'DA  S X=^(DA,0),PSNI1=$P(X,"^",2),PSNI2=$P(X,"^",3),PSNI1N=$P(^PS(50.416,PSNI1,0),"^",2),PSNI2N=$P(^PS(50.416,PSNI2,0),"^",2) D
"RTN","PSNCLEAN",10,0)
 .I 'PSNI1N,'PSNI2N Q
"RTN","PSNCLEAN",11,0)
 .S PSNI1P=$S('PSNI1N:PSNI1,1:PSNI1N),PSNI2P=$S('PSNI2N:PSNI2,1:PSNI2N)
"RTN","PSNCLEAN",12,0)
 .I '$D(^PS(56,"AE",PSNI1P,PSNI2P)) D  Q
"RTN","PSNCLEAN",13,0)
 ..;NO PRE-EXISTING INTERACTION - RENAME AND QUIT
"RTN","PSNCLEAN",14,0)
 ..K PSN,PSNN S PSN($P(^PS(50.416,PSNI1P,0),"^"))="",PSN($P(^PS(50.416,PSNI2P,0),"^"))="",PSNN=$O(PSN(""))_"/"_$O(PSN($O(PSN("")))),^TMP($J,"RENAM",$P(X,"^")_"^"_PSNN)="",DIE="^PS(56,",DR=".01////"_PSNN D ^DIE
"RTN","PSNCLEAN",15,0)
 ..K ^PS(56,"AI1",PSNI1,DA),^PS(56,"AI2",PSNI2,DA),^PS(56,"AE",PSNI1,PSNI2,DA),^PS(56,"AE",PSNI2,PSNI1,DA) S (^PS(56,"AI1",PSNI1P,DA),^PS(56,"AI2",PSNI2P,DA),^PS(56,"AE",PSNI1P,PSNI2P,DA),^PS(56,"AE",PSNI2P,PSNI1P,DA))=""
"RTN","PSNCLEAN",16,0)
 ..S $P(^PS(56,DA,0),"^",2,3)=PSNI1P_"^"_PSNI2P
"RTN","PSNCLEAN",17,0)
 .;PRE-EXISTING INTERACTIONS - LOG TO DELETE
"RTN","PSNCLEAN",18,0)
 .S NEWDA=$QS($Q(^PS(56,"AE",PSNI1P,PSNI2P)),5) D
"RTN","PSNCLEAN",19,0)
 ..S ^TMP($J,"DEL",$P(X,"^"))="",^TMP($J,"DELIEN",DA)=NEWDA
"RTN","PSNCLEAN",20,0)
 ;NOW DELETE AND REPOINT
"RTN","PSNCLEAN",21,0)
 S PSN=0 F  S PSN=$O(^TMP($J,"DELIEN",PSN)) Q:'PSN  S X=^PS(56,PSN,0),PSNI1=$P(X,"^",2),PSNI2=$P(X,"^",3),$P(^PS(56,PSN,0),"^",2,7)="" K ^PS(56,"AI1",PSNI1,PSN),^PS(56,"AI2",PSNI2,PSN),^PS(56,"AE",PSNI1,PSNI2,PSN),^PS(56,"AE",PSNI2,PSNI1,PSN)
"RTN","PSNCLEAN",22,0)
 ;NOW THE APD
"RTN","PSNCLEAN",23,0)
 S X="^PS(56,""APD"")" F  S X=$Q(@X) Q:$QS(X,2)'="APD"  I $D(^TMP($J,"DELIEN",$QS(X,5))) S NEWDA=^($QS(X,5)) K @X,^PS(56,"APD",$QS(X,4),$QS(X,3),$QS(X,5)) S (^PS(56,"APD",$QS(X,3),$QS(X,4),NEWDA),^PS(56,"APD",$QS(X,4),$QS(X,3),NEWDA))=""
"RTN","PSNCLEAN",24,0)
 ;NOW THE 0 NODE
"RTN","PSNCLEAN",25,0)
 S PSN=0 F  S PSN=$O(^TMP($J,"DELIEN",PSN)) Q:'PSN  S DIK="^PS(56,",DA=PSN D ^DIK
"RTN","PSNCLEAN",26,0)
 ;
"RTN","PSNCLEAN",27,0)
 I '$D(^TMP($J,"DEL")),'$D(^("RENAM")) D  G ALLER
"RTN","PSNCLEAN",28,0)
 .F LINE=1:1 S X=$P($T(TEXT4+LINE),";",3,300) Q:X=""  S ^TMP("PSN",$J,LINE,0)=X
"RTN","PSNCLEAN",29,0)
 F LINE=1:1 S X=$P($T(TEXT+LINE),";",3,300) Q:X=""  S ^TMP("PSN",$J,LINE,0)=X
"RTN","PSNCLEAN",30,0)
 I '$D(^TMP($J,"RENAM")) S ^TMP("PSN",$J,LINE,0)=" ",^TMP("PSN",$J,LINE+1,0)="none found",LINE=LINE+2
"RTN","PSNCLEAN",31,0)
 S NA="" F  S NA=$O(^TMP($J,"RENAM",NA)) Q:NA=""  S ^TMP("PSN",$J,LINE,0)=$P(NA,"^")_" was changed to",^TMP("PSN",$J,LINE+1,0)="   "_$P(NA,"^",2),^TMP("PSN",$J,LINE+2,0)=" ",LINE=LINE+3
"RTN","PSNCLEAN",32,0)
 F J=1:1 S X=$P($T(TEXT2+J),";",3,300) Q:X=""  S ^TMP("PSN",$J,LINE,0)=X,LINE=LINE+1
"RTN","PSNCLEAN",33,0)
 I '$D(^TMP($J,"DEL")) S ^TMP("PSN",$J,LINE,0)="none found",LINE=LINE+1
"RTN","PSNCLEAN",34,0)
 S NA="" F  S NA=$O(^TMP($J,"DEL",NA)) Q:NA=""  S ^TMP("PSN",$J,LINE,0)=NA,LINE=LINE+1
"RTN","PSNCLEAN",35,0)
ALLER ;now the allergies
"RTN","PSNCLEAN",36,0)
 I ^XMB("NETNAME")["CMOP" G SENDIT
"RTN","PSNCLEAN",37,0)
 ;skip allergies for CMOPs
"RTN","PSNCLEAN",38,0)
 K ^TMP($J)
"RTN","PSNCLEAN",39,0)
 S PSNDA=0 F  S PSNDA=$O(^GMR(120.8,PSNDA)) Q:'PSNDA  I $D(^(PSNDA,0)) S PSNPAT=+^(0) I $D(^DPT(PSNPAT,0)) S PSNPAT=$P(^(0),"^"),PSNI=$P(^GMR(120.8,PSNDA,0),"^",3) D
"RTN","PSNCLEAN",40,0)
 .I PSNI["PS(50.416",$D(^PS(50.416,+PSNI,0)),$P(^(0),"^",2) S PSNI=$P(^(0),"^",2)_";PS(50.416,",$P(^GMR(120.8,PSNDA,0),"^",3)=PSNI
"RTN","PSNCLEAN",41,0)
 .S PSNK=0 F  S PSNK=$O(^GMR(120.8,PSNDA,2,PSNK)) Q:'PSNK  S PSNI=^(PSNK,0) D
"RTN","PSNCLEAN",42,0)
 ..S PSNX=$P(^PS(50.416,PSNI,0),"^",2) I PSNX S DA(1)=PSNDA,DA=PSNK,DIE="^GMR(120.8,DA(1),2,",DR=".01////"_$S($D(^GMR(120.8,DA(1),2,"B",PSNX)):"@",1:PSNX) D ^DIE S ^TMP($J,1,PSNPAT,$P(^PS(50.416,PSNI,0),"^")_"^"_$P(^PS(50.416,PSNX,0),"^"))=""
"RTN","PSNCLEAN",43,0)
 ;
"RTN","PSNCLEAN",44,0)
 I '$D(^TMP($J,1)) D  G SENDIT
"RTN","PSNCLEAN",45,0)
 .F J=1:1 S X=$P($T(TEXT5+J),";",3,300) Q:X=""  S ^TMP("PSN",$J,LINE,0)=X,LINE=LINE+1
"RTN","PSNCLEAN",46,0)
 F J=1:1 S X=$P($T(TEXT3+J),";",3,300) Q:X=""  S ^TMP("PSN",$J,LINE,0)=X,LINE=LINE+1
"RTN","PSNCLEAN",47,0)
 I '$D(^TMP($J,1)) S ^TMP("PSN",$J,LINE,0)="none found",LINE=LINE+1
"RTN","PSNCLEAN",48,0)
 S NA="" F  S NA=$O(^TMP($J,1,NA)) Q:NA=""  S X="" F  S X=$O(^TMP($J,1,NA,X)) Q:X=""  S ^TMP("PSN",$J,LINE,0)="Patient: "_NA,LINE=LINE+1,^TMP("PSN",$J,LINE,0)="Non-primary ingredient "_$P(X,"^"),LINE=LINE+1 D
"RTN","PSNCLEAN",49,0)
 .S ^TMP("PSN",$J,LINE,0)="was replaced with primary ingredient "_$P(X,"^",2),LINE=LINE+1,^TMP("PSN",$J,LINE,0)=" ",LINE=LINE+1
"RTN","PSNCLEAN",50,0)
 ;
"RTN","PSNCLEAN",51,0)
SENDIT ;
"RTN","PSNCLEAN",52,0)
 S XMSUB="INTERACTIONS and ALLERGIES UPDATED",XMDUZ="NDF MANAGER",XMTEXT="^TMP(""PSN"",$J," K XMY S XMY(DUZ)="",XMY("G.NDF DATA@"_^XMB("NETNAME"))="",DA=0 F  S DA=$O(^XUSEC("PSNMGR",DA)) Q:'DA  S XMY(DA)=""
"RTN","PSNCLEAN",53,0)
 N DIFROM D ^XMD
"RTN","PSNCLEAN",54,0)
QUIT K DA,DIE,DIK,DR,J,LINE,NA,NEWDA,PSN,PSNDA,PSNI,PSNI1,PSNI1N,PSNI1P,PSNI2,PSNI2N,PSNI2P,PSNN,PSNK,PSNPAT,PSNX,X,XMDUZ,XMSUB,XMTEXT,XMY,^TMP($J),^TMP("PSN",$J)
"RTN","PSNCLEAN",55,0)
PRO  K ^TMP("PSN",$J) M ^TMP("PSN",$J)=@XPDGREF@("CLASS") K ^TMP("PSN",$J,0) I $D(^TMP("PSN",$J)) S ZTSAVE("^TMP(""PSN"",$J,")="",ZTIO="",ZTDTH=$H,ZTRTN="PROTO^PSNCLEAN" D ^%ZTLOAD K ZTSAVE,ZTIO,ZTDTH,ZTRTN Q
"RTN","PSNCLEAN",56,0)
 Q
"RTN","PSNCLEAN",57,0)
PROTO S X="PSN NEW CLASS",DIC=101 D EN^XQOR K X,DIC Q
"RTN","PSNCLEAN",58,0)
 Q
"RTN","PSNCLEAN",59,0)
TEXT3 ; 
"RTN","PSNCLEAN",60,0)
 ;;  
"RTN","PSNCLEAN",61,0)
 ;;=========================================================================
"RTN","PSNCLEAN",62,0)
 ;;Allergy information for the following patients has been changed.
"RTN","PSNCLEAN",63,0)
 ;; 
"RTN","PSNCLEAN",64,0)
 ;;The allergy for the listed patients was created with a non-primary
"RTN","PSNCLEAN",65,0)
 ;;ingredient.  These have been updated to replace the non-primary
"RTN","PSNCLEAN",66,0)
 ;;ingredient with the proper primary ingredient.
"RTN","PSNCLEAN",67,0)
 ;;  
"RTN","PSNCLEAN",68,0)
 ;
"RTN","PSNCLEAN",69,0)
TEXT ;
"RTN","PSNCLEAN",70,0)
 ;; 
"RTN","PSNCLEAN",71,0)
 ;;The following interactions have been edited because they
"RTN","PSNCLEAN",72,0)
 ;;involved ingredients that are not primary ingredients.
"RTN","PSNCLEAN",73,0)
 ;; 
"RTN","PSNCLEAN",74,0)
 ;
"RTN","PSNCLEAN",75,0)
TEXT2 ; 
"RTN","PSNCLEAN",76,0)
 ;; 
"RTN","PSNCLEAN",77,0)
 ;;The following interactions have been deleted because
"RTN","PSNCLEAN",78,0)
 ;;Primary Ingredient/Other Ingredient combination already
"RTN","PSNCLEAN",79,0)
 ;;exists in the DRUG INGREDIENTS file involved ingredients
"RTN","PSNCLEAN",80,0)
 ;;that are not primary ingredients. 
"RTN","PSNCLEAN",81,0)
 ;; 
"RTN","PSNCLEAN",82,0)
 ;
"RTN","PSNCLEAN",83,0)
TEXT4 ;
"RTN","PSNCLEAN",84,0)
 ;; 
"RTN","PSNCLEAN",85,0)
 ;;No DRUG INTERACTIONS were updated due to Primary Ingredients being
"RTN","PSNCLEAN",86,0)
 ;;changed to Non-Primary ingredients in the Data Update.
"RTN","PSNCLEAN",87,0)
 ;; 
"RTN","PSNCLEAN",88,0)
 ;
"RTN","PSNCLEAN",89,0)
TEXT5 ;
"RTN","PSNCLEAN",90,0)
 ;; 
"RTN","PSNCLEAN",91,0)
 ;;No PATIENT ALLERGIES were updated due to Primary Ingredients being
"RTN","PSNCLEAN",92,0)
 ;;changed to Non-Primary ingredients during the Data Update.
"RTN","PSNCLEAN",93,0)
 ;; 
"RTN","PSNFTP")
0^15^B220445770^n/a
"RTN","PSNFTP",1,0)
PSNFTP ;HP/ART - PPS-N National Drug File Updates File Transfer ;09/25/2015
"RTN","PSNFTP",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNFTP",3,0)
 ;Supported ICRs/IAs
"RTN","PSNFTP",4,0)
 ;External reference to $$DECRYP^XUSRB1() supported by DBIA 2241
"RTN","PSNFTP",5,0)
 ;External reference to ^%ZISH supported by DBIA 2320
"RTN","PSNFTP",6,0)
 ;External reference to USE^%ZISUTL supported by DBIA 2119
"RTN","PSNFTP",7,0)
 ;External reference to $$OS^%ZOSV supported by DBIA 10097
"RTN","PSNFTP",8,0)
 ;External reference to ^XLFDT supported by DBIA 10103
"RTN","PSNFTP",9,0)
 ;External reference to ^XMD supported by DBIA 10070
"RTN","PSNFTP",10,0)
 ;External reference to ^PS(59.7 supported by DBIA #2613
"RTN","PSNFTP",11,0)
 ;External reference to ^XUSEC supported by DBIA #10076
"RTN","PSNFTP",12,0)
 ;
"RTN","PSNFTP",13,0)
 ;SAC Exemption For use of Cache function $ZF(-1, was granted 10/23/15 by SACC committee
"RTN","PSNFTP",14,0)
 ;
"RTN","PSNFTP",15,0)
EN ; Main Entry Point for PPS-N National Drug File Updates File Transfer
"RTN","PSNFTP",16,0)
 ;If a scheduled job initiates the PSNSCJOB=1 will be defined.
"RTN","PSNFTP",17,0)
 I $$GET1^DIQ(57.23,1,9,"I")="Y" Q
"RTN","PSNFTP",18,0)
 ;
"RTN","PSNFTP",19,0)
 N PSRC,PSOS,PSREMFIL,PSFILE,PSFFND,DIE,DA,DR,LOCDIR,PSUID,PSNDNLDB
"RTN","PSNFTP",20,0)
 N PSPREV,PSLAST,PSNEW,PSERRMSG,PSSIZE,PSWRKDIR,PSOLDF,PSFDCNT,PSOS2,PRSC,PSNPS,PSOUNXLD,X,XPV
"RTN","PSNFTP",21,0)
 D NOW^%DTC S PSNDNLDB=%
"RTN","PSNFTP",22,0)
 S PSFFND=0,(PSFDCNT,PSRC)=1
"RTN","PSNFTP",23,0)
 S PSOS=$$GETOS
"RTN","PSNFTP",24,0)
 S (PSFILE,PSREMFIL,PSOLDF)=""
"RTN","PSNFTP",25,0)
 S PSWRKDIR=$$GETD()
"RTN","PSNFTP",26,0)
 I PSOS["UNIX",'$$DIREXIST^PSNFTP2(PSWRKDIR) D MAKEDIR^PSNFTP2(PSWRKDIR)
"RTN","PSNFTP",27,0)
 K DIE,DA,DR
"RTN","PSNFTP",28,0)
 S DIE="^PS(57.23,",DA=1,DR="9///Y" D ^DIE K DIE,DA,DR
"RTN","PSNFTP",29,0)
 F  D  Q:+PSRC<1
"RTN","PSNFTP",30,0)
 . S PSERRMSG(1)="0^RETRIEVAL VERSION in PPS-N UPDATE CONTROL (#57.23) file is not defined"
"RTN","PSNFTP",31,0)
 . ;last file downloaded
"RTN","PSNFTP",32,0)
 . S PSLAST=$$GET1^DIQ(57.23,1,8)
"RTN","PSNFTP",33,0)
 . I PSLAST="" D  Q
"RTN","PSNFTP",34,0)
 . . S PSRC=PSERRMSG(1)
"RTN","PSNFTP",35,0)
 . . D MAILFTP(0,"undeterminedFileName","",$P(PSRC,U,2))
"RTN","PSNFTP",36,0)
 . . W "Determine remote file name failed ",PSOS," rc=",PSRC,!
"RTN","PSNFTP",37,0)
 . ;
"RTN","PSNFTP",38,0)
 . S PSNEW=PSLAST+1
"RTN","PSNFTP",39,0)
 . S (PSFILE,PSREMFIL)="PPS_"_PSLAST_"PRV_"_PSNEW_"NEW.DAT"
"RTN","PSNFTP",40,0)
 . I PSFDCNT=1 S PSOLDF=PSFILE
"RTN","PSNFTP",41,0)
 . S PSFDCNT=PSFDCNT+1
"RTN","PSNFTP",42,0)
 . I 'PSFFND W !!,"Beginning download for Update file name: ",PSREMFIL
"RTN","PSNFTP",43,0)
 . I PSFFND W !!,"Continuing with the next file sequence. Attempting download",!," for: "_PSREMFIL
"RTN","PSNFTP",44,0)
 . W !!
"RTN","PSNFTP",45,0)
 . ;ping the remote server
"RTN","PSNFTP",46,0)
 . D PING(.PSRC,PSOS)
"RTN","PSNFTP",47,0)
 . USE 0
"RTN","PSNFTP",48,0)
 . I '+PSRC D  Q
"RTN","PSNFTP",49,0)
 . . D MAILFTP(0,PSREMFIL,"",$P(PSRC,U,2)) W "Server ping failed ",PSOS," rc=",PSRC,!
"RTN","PSNFTP",50,0)
 . W "Server ping successful ",PSOS," rc=",PSRC,!
"RTN","PSNFTP",51,0)
 . S PSOS2="",PSOS2=$S(PSOS["VMS":"VMS",PSOS["UNIX":"LINIX",1:"LINUX")_"DEL"
"RTN","PSNFTP",52,0)
 . I PSOS["VMS" D
"RTN","PSNFTP",53,0)
 . . ;D @PSOS2^PSNFTP2(PSRC,PSWRKDIR,"PSNPING.COM")
"RTN","PSNFTP",54,0)
 . . ;D @PSOS2^PSNFTP2(PSRC,PSWRKDIR,"PSNPING.LOG")
"RTN","PSNFTP",55,0)
 . ;
"RTN","PSNFTP",56,0)
 . I PSOS["LINIX" D
"RTN","PSNFTP",57,0)
 . . D @PSOS2^PSNFTP2(PSRC,PSWRKDIR,"PSNPING.LOG")
"RTN","PSNFTP",58,0)
 . ;
"RTN","PSNFTP",59,0)
 . ;transfer a file
"RTN","PSNFTP",60,0)
 . S PSRC=PSERRMSG(1)
"RTN","PSNFTP",61,0)
 . D FTP(.PSRC,PSOS,PSREMFIL,.PSERRMSG)
"RTN","PSNFTP",62,0)
 . U 0
"RTN","PSNFTP",63,0)
 . I +PSOS=1 D
"RTN","PSNFTP",64,0)
 . . ;D VMSDEL^PSNFTP2(PSRC,PSWRKDIR,"PSNFTP.COM")
"RTN","PSNFTP",65,0)
 . . ;D VMSDEL^PSNFTP2(PSRC,PSWRKDIR,"PSNFTP.LOG")
"RTN","PSNFTP",66,0)
 . . ;D VMSDEL^PSNFTP2(PSRC,PSWRKDIR,"PSNSFTP.DAT")
"RTN","PSNFTP",67,0)
 . I +PSOS=3 D
"RTN","PSNFTP",68,0)
 . . D LINUXDEL(PSRC,PSWRKDIR,"PSNFTP.sh")
"RTN","PSNFTP",69,0)
 . . D LINUXDEL(PSRC,PSWRKDIR,"PSNFTP.LOG")
"RTN","PSNFTP",70,0)
 . . D LINUXDEL(PSRC,PSWRKDIR,"PSNSFTP.DAT")
"RTN","PSNFTP",71,0)
 . . D LINUXDEL(PSRC,PSWRKDIR,"PSNPING.LOG")
"RTN","PSNFTP",72,0)
 . ;
"RTN","PSNFTP",73,0)
 . I +PSRC=0&(PSFFND) D  Q
"RTN","PSNFTP",74,0)
 . . W !!,PSREMFIL_" does not exist.",!!,"PPS-N/NDF Download process is complete.",!
"RTN","PSNFTP",75,0)
 . ;
"RTN","PSNFTP",76,0)
 . I +PSRC=0&('PSFFND) D  Q
"RTN","PSNFTP",77,0)
 . . D MAILFTP(0,PSREMFIL,"",$P(PSRC,U,2))
"RTN","PSNFTP",78,0)
 . . Q:PSOLDF=PSREMFIL
"RTN","PSNFTP",79,0)
 . . W "file transfer failed ",PSOS," rc=",PSRC,!
"RTN","PSNFTP",80,0)
 . ;
"RTN","PSNFTP",81,0)
 . I +PSRC=-1&('PSFFND) D  Q
"RTN","PSNFTP",82,0)
 . . D MAILFTP(0,PSREMFIL,"",$P(PSRC,U,2))
"RTN","PSNFTP",83,0)
 . . Q:PSOLDF=PSREMFIL
"RTN","PSNFTP",84,0)
 . . W "remote file not found ",PSOS," rc=",PSRC,!
"RTN","PSNFTP",85,0)
 . ;
"RTN","PSNFTP",86,0)
 . ;update PPS-N UPDATE CONTROL:RETRIEVAL VERSION (#57.23:8)
"RTN","PSNFTP",87,0)
 . I +PSRC=1 W "file transfer successful ",PSOS," rc=",PSRC,!
"RTN","PSNFTP",88,0)
 . Q:+PSRC'=1
"RTN","PSNFTP",89,0)
 . S PSFFND=1
"RTN","PSNFTP",90,0)
 . K DIE,DA,DR
"RTN","PSNFTP",91,0)
 . S DIE="^PS(57.23,",DA=1,DR="8///"_PSNEW D ^DIE K DIE,DA,DR
"RTN","PSNFTP",92,0)
 . S PSSIZE=""
"RTN","PSNFTP",93,0)
 . ;
"RTN","PSNFTP",94,0)
 . ;**VMS file size
"RTN","PSNFTP",95,0)
 . I +PSOS=1 D FILSIZE^PSNFTP2(PSWRKDIR,PSFILE,.PSSIZE,"")
"RTN","PSNFTP",96,0)
 . ;
"RTN","PSNFTP",97,0)
 . ;**linux file size
"RTN","PSNFTP",98,0)
 . I +PSOS=3 D
"RTN","PSNFTP",99,0)
 . . S XPV="S PV=$ZF(-1,""stat -c%s "_PSWRKDIR_PSFILE_">"_PSWRKDIR_"PSNSIZE.DAT"")"
"RTN","PSNFTP",100,0)
 . . X XPV
"RTN","PSNFTP",101,0)
 . . S PSXLOG="",PSXLOG=$$FTG^%ZISH(PSWRKDIR,"PSNSIZE.DAT",$NAME(^TMP("PSNFSIZELOG",$J,1)),3)
"RTN","PSNFTP",102,0)
 . . I $D(^TMP("PSNFSIZELOG",$J,1)) S PSSIZE=^TMP("PSNFSIZELOG",$J,1)
"RTN","PSNFTP",103,0)
 . ;
"RTN","PSNFTP",104,0)
 . D MAILFTP(1,PSFILE,PSSIZE,""),DELFILES^PSNFTP2(PSWRKDIR)
"RTN","PSNFTP",105,0)
 . W !!,"Completed download for: ",PSREMFIL,!!
"RTN","PSNFTP",106,0)
 . D UPDTCTRL
"RTN","PSNFTP",107,0)
 . S PRSC=0
"RTN","PSNFTP",108,0)
 K DIE,DA,DR
"RTN","PSNFTP",109,0)
 S DIE="^PS(57.23,",DA=1,DR="9///N" D ^DIE K DIE,DA,DR
"RTN","PSNFTP",110,0)
 D NOW^%DTC S DIE="^PS(57.23,1,4,",DA=1,DR="3///"_% D ^DIE K DIE,DA,DR
"RTN","PSNFTP",111,0)
 K DIE,DA,DR
"RTN","PSNFTP",112,0)
 Q
"RTN","PSNFTP",113,0)
 ;
"RTN","PSNFTP",114,0)
PING(PSRC,PSOS) ; Check for availability of server (ping)
"RTN","PSNFTP",115,0)
 ;Inputs: PSRC - reference to return code
"RTN","PSNFTP",116,0)
 ;        PSOS - current OS
"RTN","PSNFTP",117,0)
 ;Output: PSRC - populated return code
"RTN","PSNFTP",118,0)
 ;
"RTN","PSNFTP",119,0)
 N PSERRMSG,PSADDR,PSCOMFIL,PSLOGFIL,PSFILES
"RTN","PSNFTP",120,0)
 S PSERRMSG(1)="0^Remote Server Address in the PPS-N Site Parameters is not defined or invalid"
"RTN","PSNFTP",121,0)
 S PSERRMSG(2)="0^"_$S($$GETOS["VMS":"VMS",$$GETOS["LINUX":"Unix/Linux",1:"")_" Local Directory in the PPS-N Site Parameters is not defined or invalid"
"RTN","PSNFTP",122,0)
 ;S PSERRMSG(2)="0^Local Directory in the PPS-N Site Parameters is not defined or invalid"
"RTN","PSNFTP",123,0)
 S PSRC=1
"RTN","PSNFTP",124,0)
 S PSADDR=$$GET1^DIQ(57.23,1,20) I PSADDR="" S PSRC=PSERRMSG(1) Q
"RTN","PSNFTP",125,0)
 ;S PSWRKDIR="USER$:[SFTP.PPSN]"
"RTN","PSNFTP",126,0)
 S PSWRKDIR=$$GETD() I PSWRKDIR="" S PSRC=PSERRMSG(2) Q
"RTN","PSNFTP",127,0)
 S PSCOMFIL="PSNPING.COM"
"RTN","PSNFTP",128,0)
 S PSLOGFIL="PSNPING.LOG"
"RTN","PSNFTP",129,0)
 ;
"RTN","PSNFTP",130,0)
 ;VMS
"RTN","PSNFTP",131,0)
 I +PSOS=1 D
"RTN","PSNFTP",132,0)
 . D VMSPING(.PSRC,PSADDR,PSWRKDIR,PSCOMFIL,PSLOGFIL)
"RTN","PSNFTP",133,0)
 . S PSFILES(PSCOMFIL)=""
"RTN","PSNFTP",134,0)
 . I '$$DELFILES(PSWRKDIR,.PSFILES) W !,"File cleanup/delete failed.",!
"RTN","PSNFTP",135,0)
 ;
"RTN","PSNFTP",136,0)
 ;Linux
"RTN","PSNFTP",137,0)
 I +PSOS=3 D LINXPING(.PSRC,PSADDR,PSWRKDIR,PSLOGFIL)
"RTN","PSNFTP",138,0)
 ;
"RTN","PSNFTP",139,0)
 ;Windows
"RTN","PSNFTP",140,0)
 I +PSOS=2 D WINPING(.PSRC,PSADDR,PSWRKDIR,PSLOGFIL)
"RTN","PSNFTP",141,0)
 Q
"RTN","PSNFTP",142,0)
 ;
"RTN","PSNFTP",143,0)
FTP(PSRC,PSOS,PSREMFIL,PSERRMSG) ; ftp (get) a file
"RTN","PSNFTP",144,0)
 ;Inputs: PSRC - reference to return code
"RTN","PSNFTP",145,0)
 ;        PSOS - current OS
"RTN","PSNFTP",146,0)
 ;        PSREMFIL - remote file name
"RTN","PSNFTP",147,0)
 ;Output: PSRC - populated return code
"RTN","PSNFTP",148,0)
 ;
"RTN","PSNFTP",149,0)
 N PSADDR,PSNUSER,PSREMDIR,PSCOMFIL,PSSHFILE
"RTN","PSNFTP",150,0)
 N PSLOCDIR,PSCMDFIL,PSLOGFIL,PSDATFIL
"RTN","PSNFTP",151,0)
 S PSERRMSG(1)="0^REMOTE SERVER ADDRESS in PPS-N UPDATE CONTROL (#57.23) file is not defined"
"RTN","PSNFTP",152,0)
 S PSERRMSG(2)="0^REMOTE SFTP USER ID in PPS-N UPDATE CONTROL (#57.23) file is not defined"
"RTN","PSNFTP",153,0)
 S PSERRMSG(3)="0^PRIMARY HFS DIRECTORY in KERNEL SYSTEM PARAMETERS (#8989.3) file is not defined"
"RTN","PSNFTP",154,0)
 S PSERRMSG(4)="0^DIRECTORY PATH in PPS-N UPDATE CONTROL (#57.23) file is not defined"
"RTN","PSNFTP",155,0)
 S PSERRMSG(5)="0^REMOTE DIRECTORY ACCESS in PPS-N UPDATE CONTROL (#57.23) file is not defined"
"RTN","PSNFTP",156,0)
 S PSRC=1
"RTN","PSNFTP",157,0)
 S PSADDR=$$GET1^DIQ(57.23,1,20) I PSADDR="" S PSRC=PSERRMSG(1) Q
"RTN","PSNFTP",158,0)
 S PSNUSER=$$GET1^DIQ(57.23,1,22) I PSNUSER="" S PSRC=PSERRMSG(2) Q
"RTN","PSNFTP",159,0)
 S PSWRKDIR=$$GETD() I PSWRKDIR="" S PSRC=PSERRMSG(3) Q
"RTN","PSNFTP",160,0)
 S PSLOCDIR=$$GETD() I PSLOCDIR="" S PSRC=PSERRMSG(4) Q
"RTN","PSNFTP",161,0)
 S PSREMDIR=$$GET1^DIQ(57.23,1,21) I PSREMDIR="" S PSRC=PSERRMSG(5) Q
"RTN","PSNFTP",162,0)
 S PSCOMFIL="PSNFTP.COM"
"RTN","PSNFTP",163,0)
 S PSSHFILE="PSNFTP.sh"
"RTN","PSNFTP",164,0)
 S PSCMDFIL="PSNFTPCMDS.txt"
"RTN","PSNFTP",165,0)
 S PSLOGFIL="PSNFTP.LOG"
"RTN","PSNFTP",166,0)
 S PSDATFIL="PSNSFTP.DAT"
"RTN","PSNFTP",167,0)
 D SAVEKEYS^PSNFTP2(PSWRKDIR)
"RTN","PSNFTP",168,0)
 ;
"RTN","PSNFTP",169,0)
 ;VMS
"RTN","PSNFTP",170,0)
 I +PSOS=1 D
"RTN","PSNFTP",171,0)
 . D VMSFTP^PSNFTP2(.PSRC,PSADDR,PSNUSER,PSWRKDIR,PSLOCDIR,PSREMDIR,PSREMFIL,PSCOMFIL,PSLOGFIL,PSDATFIL,.PSERRMSG)
"RTN","PSNFTP",172,0)
 . S PSFILES(PSCOMFIL)="",PSFILES("VSSHID.")="",PSFILES("VSSHKEY.")="",PSFILES("VSSHKEY.PUB")=""
"RTN","PSNFTP",173,0)
 . I '$$DELFILES(PSWRKDIR,.PSFILES) W !,"File cleanup/delete failed.",!
"RTN","PSNFTP",174,0)
 ;
"RTN","PSNFTP",175,0)
 ;Linux
"RTN","PSNFTP",176,0)
 I +PSOS=3 D
"RTN","PSNFTP",177,0)
 . S PSLOCDIR=$E(PSLOCDIR,1,($L(PSLOCDIR)-1)) ; chop off trailing /
"RTN","PSNFTP",178,0)
 . D LINUXFTP^PSNFTP2(.PSRC,PSADDR,PSNUSER,PSWRKDIR,PSLOCDIR,PSREMDIR,PSREMFIL,PSSHFILE,PSLOGFIL,PSDATFIL)
"RTN","PSNFTP",179,0)
 . S PSFILES(PSSHFILE)="",PSFILES("VSSHKEY")="",PSFILES("uxsshkey")=""
"RTN","PSNFTP",180,0)
 . I '$$DELFILES(PSWRKDIR,.PSFILES) W !,"File cleanup/delete failed.",!
"RTN","PSNFTP",181,0)
 ;
"RTN","PSNFTP",182,0)
 ;Windows
"RTN","PSNFTP",183,0)
 I +PSOS=2 D
"RTN","PSNFTP",184,0)
 . S PSLOCDIR=$E(PSLOCDIR,1,($L(PSLOCDIR)-1)) ; chop off trailing \
"RTN","PSNFTP",185,0)
 . D WINFTP^PSNFTP2(.PSRC,PSADDR,PSUID,PSWRKDIR,PSLOCDIR,PSREMDIR,PSREMFIL,PSCMDFIL,PSLOGFIL)
"RTN","PSNFTP",186,0)
 . S PSFILES(PSCMDFIL)=""
"RTN","PSNFTP",187,0)
 . I '$$DELFILES(PSWRKDIR,.PSFILES) WRITE !,"File cleanup/delete failed.",!
"RTN","PSNFTP",188,0)
 Q
"RTN","PSNFTP",189,0)
 ;
"RTN","PSNFTP",190,0)
GETOS() ;Determine OS
"RTN","PSNFTP",191,0)
 ;Returns: PSOS - local OS
"RTN","PSNFTP",192,0)
 N PSOS S PSOS=$$OS^%ZOSV()
"RTN","PSNFTP",193,0)
 S PSOS=$S(PSOS["VMS":"1-VMS",PSOS["NT":"2-MSW",PSOS["UNIX":"3-LINUX",1:"0-")
"RTN","PSNFTP",194,0)
 Q PSOS
"RTN","PSNFTP",195,0)
 ;
"RTN","PSNFTP",196,0)
VMSPING(PSRC,PSADDR,PSWRKDIR,PSCOMFIL,PSLOGFIL) ; PING VMS server to ensure it is available
"RTN","PSNFTP",197,0)
 ;Inputs: PSRC - return code, by reference
"RTN","PSNFTP",198,0)
 ;        PSADDR - remote server address
"RTN","PSNFTP",199,0)
 ;        PSWRKDIR - local work directory name
"RTN","PSNFTP",200,0)
 ;        PSCOMFIL - .com file name
"RTN","PSNFTP",201,0)
 ;        PSLOGFIL - log file name
"RTN","PSNFTP",202,0)
 ;Output: PSRC - populated return code
"RTN","PSNFTP",203,0)
 ;
"RTN","PSNFTP",204,0)
 ;check parameters
"RTN","PSNFTP",205,0)
 I $G(PSADDR)="" S PSRC="0^no target server address" Q
"RTN","PSNFTP",206,0)
 I $G(PSWRKDIR)="" S PSRC="0^no local work directory name" Q
"RTN","PSNFTP",207,0)
 I $G(PSCOMFIL)="" S PSRC="0^no .com file name" Q
"RTN","PSNFTP",208,0)
 I $G(PSLOGFIL)="" S PSRC="0^no log file name" Q
"RTN","PSNFTP",209,0)
 ; Create .COM file
"RTN","PSNFTP",210,0)
 N POP
"RTN","PSNFTP",211,0)
 D OPEN^%ZISH("FILE1",PSWRKDIR,PSCOMFIL,"W")
"RTN","PSNFTP",212,0)
 I POP S PSRC="0^failed to open ping .com file" Q
"RTN","PSNFTP",213,0)
 D USE^%ZISUTL("FILE1")
"RTN","PSNFTP",214,0)
 W "$ SET VERIFY=(PROCEDURE,IMAGE)",!
"RTN","PSNFTP",215,0)
 W "$ SET DEFAULT "_PSWRKDIR,!
"RTN","PSNFTP",216,0)
 W "$ TCPIP",!
"RTN","PSNFTP",217,0)
 W "PING "_PSADDR,!
"RTN","PSNFTP",218,0)
 W "EXIT",!
"RTN","PSNFTP",219,0)
 W "$ EXIT 3",!
"RTN","PSNFTP",220,0)
 D CLOSE^%ZISH("FILE1")
"RTN","PSNFTP",221,0)
 ; Execute .COM file, create logfile
"RTN","PSNFTP",222,0)
 N PSZFRC
"RTN","PSNFTP",223,0)
 S PSZFRC=$ZF(-1,"@"_PSWRKDIR_PSCOMFIL_"/OUTPUT="_PSWRKDIR_PSLOGFIL)
"RTN","PSNFTP",224,0)
 ; Error check
"RTN","PSNFTP",225,0)
 I PSZFRC=-1 S PSRC="0^VMS OS command execution failed" Q
"RTN","PSNFTP",226,0)
 ; Read Logfile into working global, check for error
"RTN","PSNFTP",227,0)
 K ^TMP("PSNPINGLOG",$J)
"RTN","PSNFTP",228,0)
 N PSXLOG,PSPNG,PSPNG1
"RTN","PSNFTP",229,0)
 S PSXLOG=$$FTG^%ZISH(PSWRKDIR,PSLOGFIL,$NAME(^TMP("PSNPINGLOG",$J,1)),3)
"RTN","PSNFTP",230,0)
 S PSPNG="",PSPNG1=0
"RTN","PSNFTP",231,0)
 F  S PSPNG=$O(^TMP("PSNPINGLOG",$J,PSPNG)) Q:PSPNG=""  D
"RTN","PSNFTP",232,0)
 . S PSPNG1=$G(^TMP("PSNPINGLOG",$J,PSPNG))
"RTN","PSNFTP",233,0)
 . I PSPNG1["0 packets received" S PSRC="0^Remote server - "_PSADDR_" - did not respond"
"RTN","PSNFTP",234,0)
 . I PSPNG1["%SYSTEM" S PSRC="0^Remote server - "_PSADDR_" - did not respond"
"RTN","PSNFTP",235,0)
 D DELFILES^PSNFTP2($G(PSWRKDIR),$G(PSLOGFIL),$G(PSCOMFIL),"")
"RTN","PSNFTP",236,0)
 Q
"RTN","PSNFTP",237,0)
 ;
"RTN","PSNFTP",238,0)
LINXPING(PSRC,PSADDR,PSWRKDIR,PSLOGFIL) ; PING Unix/Linux server to ensure it is available
"RTN","PSNFTP",239,0)
 ;Inputs: PSRC - return code, by reference
"RTN","PSNFTP",240,0)
 ;        PSADDR - remote server address
"RTN","PSNFTP",241,0)
 ;        PSWRKDIR - local work directory name
"RTN","PSNFTP",242,0)
 ;        PSLOGFIL - log file name
"RTN","PSNFTP",243,0)
 ;Output: PSRC - populated return code
"RTN","PSNFTP",244,0)
 ;
"RTN","PSNFTP",245,0)
 ;check parameters
"RTN","PSNFTP",246,0)
 I PSADDR="" S PSRC="0^no target server address" Q
"RTN","PSNFTP",247,0)
 I $G(PSWRKDIR)="" S PSRC="0^no local work directory name" Q
"RTN","PSNFTP",248,0)
 I $G(PSLOGFIL)="" S PSRC="0^no log file name" Q
"RTN","PSNFTP",249,0)
 ; Execute ping, create logfile
"RTN","PSNFTP",250,0)
 N PSZFRC
"RTN","PSNFTP",251,0)
 S PSZFRC=$ZF(-1,"ping -c 4 "_PSADDR_">"_PSWRKDIR_PSLOGFIL)
"RTN","PSNFTP",252,0)
 ; Error check
"RTN","PSNFTP",253,0)
 I PSZFRC=-1 S PSRC="0^Linux OS command execution failed" Q
"RTN","PSNFTP",254,0)
 ; Read Logfile into working global, check for error
"RTN","PSNFTP",255,0)
 K ^TMP("PSNPINGLOG",$J)
"RTN","PSNFTP",256,0)
 N PSXLOG,PSPNG,PSPNG1 S PSPNG="",PSPNG1=0
"RTN","PSNFTP",257,0)
 S PSXLOG=$$FTG^%ZISH(PSWRKDIR,PSLOGFIL,$NAME(^TMP("PSNPINGLOG",$J,1)),3)
"RTN","PSNFTP",258,0)
 F  S PSPNG=$O(^TMP("PSNPINGLOG",$J,PSPNG)) Q:PSPNG=""  D
"RTN","PSNFTP",259,0)
 . S PSPNG1=$G(^TMP("PSNPINGLOG",$J,PSPNG))
"RTN","PSNFTP",260,0)
 . I PSPNG1["0 received" S PSRC="0^Remote server - "_PSADDR_" - did not respond"
"RTN","PSNFTP",261,0)
 ;D DELFILES^PSNFTP2($G(PSWRKDIR),$G(PSLOGFIL))
"RTN","PSNFTP",262,0)
 Q
"RTN","PSNFTP",263,0)
WINPING(PSRC,PSADDR,PSWRKDIR,PSLOGFIL) ; PING server to ensure it is available
"RTN","PSNFTP",264,0)
 ;Inputs: PSRC - return code, by reference
"RTN","PSNFTP",265,0)
 ;        PSADDR - remote server address
"RTN","PSNFTP",266,0)
 ;        PSWRKDIR - local work directory name
"RTN","PSNFTP",267,0)
 ;        PSLOGFIL - log file name
"RTN","PSNFTP",268,0)
 ;Output: PSRC - populated return code
"RTN","PSNFTP",269,0)
 ;
"RTN","PSNFTP",270,0)
 ;check parameters
"RTN","PSNFTP",271,0)
 I PSADDR="" S PSRC="0^no target server address" Q
"RTN","PSNFTP",272,0)
 I $G(PSWRKDIR)="" SET PSRC="0^no local work directory name" Q
"RTN","PSNFTP",273,0)
 I $G(PSLOGFIL)="" S PSRC="0^no log file name" Q
"RTN","PSNFTP",274,0)
 ;
"RTN","PSNFTP",275,0)
 ; Execute ping, create logfile
"RTN","PSNFTP",276,0)
 N PSZFRC
"RTN","PSNFTP",277,0)
 S PSZFRC=$ZF(-1,"ping "_PSADDR_">"_PSWRKDIR_PSLOGFIL)
"RTN","PSNFTP",278,0)
 ; Error check
"RTN","PSNFTP",279,0)
 I PSZFRC=-1 S PSRC="0^Windows OS command execution failed" Q
"RTN","PSNFTP",280,0)
 ;
"RTN","PSNFTP",281,0)
 ; Read Logfile into working global, check for error
"RTN","PSNFTP",282,0)
 K ^TMP("PSNPINGLOG",$J)
"RTN","PSNFTP",283,0)
 N PSXLOG
"RTN","PSNFTP",284,0)
 S PSXLOG=$$FTG^%ZISH(PSWRKDIR,PSLOGFIL,$NAME(^TMP("PSNPINGLOG",$J,1)),3)
"RTN","PSNFTP",285,0)
 N PSPNG,PSPNG1
"RTN","PSNFTP",286,0)
 S PSPNG="",PSPNG1=0
"RTN","PSNFTP",287,0)
 F  S PSPNG=$O(^TMP("PSNPINGLOG",$J,PSPNG)) Q:PSPNG=""  D
"RTN","PSNFTP",288,0)
 . S PSPNG1=$G(^TMP("PSNPINGLOG",$J,PSPNG))
"RTN","PSNFTP",289,0)
 . I PSPNG1["Received = 0" S PSRC="0^Remote server - "_PSADDR_" - did not respond"
"RTN","PSNFTP",290,0)
 ; 
"RTN","PSNFTP",291,0)
 Q
"RTN","PSNFTP",292,0)
MAILFTP(PSMSGTYP,PSFILE,PSSIZE,PSERRMSG) ; mail message to notify users of the NDF Update File download status
"RTN","PSNFTP",293,0)
 ;Inputs: PSMSGTYP - message type - 1=file downloaded, 0=error
"RTN","PSNFTP",294,0)
 ;        PSFILE - file name
"RTN","PSNFTP",295,0)
 ;        PSSIZE - file size
"RTN","PSNFTP",296,0)
 ;        PSERRMSG - error message
"RTN","PSNFTP",297,0)
 ;
"RTN","PSNFTP",298,0)
 N XMDUZ,XMSUB,XMTEXT,XMY,XMZ,PSMSGTXT,PSGRP
"RTN","PSNFTP",299,0)
 I PSERRMSG'="" D UPDTCTRL D
"RTN","PSNFTP",300,0)
 . N CTRLIEN,CTRLXIEN
"RTN","PSNFTP",301,0)
 . S CTRLIEN=$O(^PS(57.23,"B","PPSN",""))
"RTN","PSNFTP",302,0)
 . S CTRLXIEN=$O(^PS(57.23,1,4,"B",PSREMFIL,""),-1)
"RTN","PSNFTP",303,0)
 . S FDA(57.234,CTRLXIEN_","_"1,",4)=PSERRMSG
"RTN","PSNFTP",304,0)
 . D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNFTP",305,0)
 ;
"RTN","PSNFTP",306,0)
 ;SETUP PRODUCTION OR SQA
"RTN","PSNFTP",307,0)
 S PSNPS=$P($G(^PS(59.7,1,10)),"^",12)
"RTN","PSNFTP",308,0)
 S XMSUB="",XMDUZ="noreply@domain.ext"
"RTN","PSNFTP",309,0)
 I PSMSGTYP D
"RTN","PSNFTP",310,0)
 . ;I PSNPS'="" I PSNPS="P"!(PSNPS="S")!(PSNPS="T") 
"RTN","PSNFTP",311,0)
 . S XMSUB="PPS-N/NDF File "_PSFILE_$S(PSSIZE="":"was not",1:"")_" DOWNLOADED"
"RTN","PSNFTP",312,0)
 . I PSNPS'="" I PSNPS="Q" S XMSUB="PPS-N/NDF File "_PSFILE_$S(PSSIZE="":"was not",1:"")_" DOWNLOADED FOR QA"
"RTN","PSNFTP",313,0)
 . I PSSIZE="" D MSGTEXT0(PSFILE,PSSIZE,"File could not be downloaded.") Q
"RTN","PSNFTP",314,0)
 . D MSGTEXT1(PSFILE,PSSIZE,.PSMSGTXT)
"RTN","PSNFTP",315,0)
 I 'PSMSGTYP D
"RTN","PSNFTP",316,0)
 . S XMSUB="ERROR: PPS-N/NDF File "_PSFILE_" "_$$FMTE^XLFDT($$NOW^XLFDT,"5Z")
"RTN","PSNFTP",317,0)
 . D MSGTEXT0(PSFILE,PSERRMSG,.PSMSGTXT)
"RTN","PSNFTP",318,0)
 S XMTEXT="PSMSGTXT("
"RTN","PSNFTP",319,0)
 S DA=0 F  S DA=$O(^XUSEC("PSNMGR",DA)) Q:'DA  S XMY(DA)=""
"RTN","PSNFTP",320,0)
 S PSGRP=$$GET1^DIQ(57.23,1,5) I PSGRP'="" S XMY($$MG^PSNPPSMG(PSGRP))="" ;PRIMARY PPS-N MAIL GROUP
"RTN","PSNFTP",321,0)
 S PSGRP="",PSGRP=$$GET1^DIQ(57.23,1,6) I PSGRP'="" S XMY($$MG^PSNPPSMG(PSGRP))="" ;SECONDARY MAIL GROUP
"RTN","PSNFTP",322,0)
 D ^XMD
"RTN","PSNFTP",323,0)
 Q
"RTN","PSNFTP",324,0)
 ;
"RTN","PSNFTP",325,0)
MSGTEXT0(PSFILE,PSERRMSG,PSMSGTXT) ;build message text
"RTN","PSNFTP",326,0)
 ;Inputs: PSFILE - file name
"RTN","PSNFTP",327,0)
 ;        PSERRMSG - error message
"RTN","PSNFTP",328,0)
 ;        PSMSGTXT - array reference for message text
"RTN","PSNFTP",329,0)
 ;Output: populated PSMSGTXT
"RTN","PSNFTP",330,0)
 ;
"RTN","PSNFTP",331,0)
 S PSMSGTXT(1)="**************************************************************************"
"RTN","PSNFTP",332,0)
 S PSMSGTXT(2)="*** An error occurred during download of the following Update file(s): ***"
"RTN","PSNFTP",333,0)
 S PSMSGTXT(3)="**************************************************************************"
"RTN","PSNFTP",334,0)
 S PSMSGTXT(4)="The following file(s) could not be downloaded:"
"RTN","PSNFTP",335,0)
 S PSMSGTXT(5)=""
"RTN","PSNFTP",336,0)
 S PSMSGTXT(6)="      Update file Name"
"RTN","PSNFTP",337,0)
 S PSMSGTXT(7)="      -------------------"
"RTN","PSNFTP",338,0)
 S PSMSGTXT(8)="      "_PSFILE
"RTN","PSNFTP",339,0)
 S PSMSGTXT(9)=""
"RTN","PSNFTP",340,0)
 S PSMSGTXT(10)="An error occurred for:"
"RTN","PSNFTP",341,0)
 S PSMSGTXT(11)="               File: "
"RTN","PSNFTP",342,0)
 S PSMSGTXT(12)="                IEN: "
"RTN","PSNFTP",343,0)
 S PSMSGTXT(13)="         Entry Name: "
"RTN","PSNFTP",344,0)
 S PSMSGTXT(14)="Update file section: "
"RTN","PSNFTP",345,0)
 S PSMSGTXT(15)=""
"RTN","PSNFTP",346,0)
 S PSMSGTXT(16)="Error Message: "_PSERRMSG_"."
"RTN","PSNFTP",347,0)
 S PSMSGTXT(17)=""
"RTN","PSNFTP",348,0)
 S PSMSGTXT(18)="How to correct your error:"
"RTN","PSNFTP",349,0)
 S PSMSGTXT(19)="1.    Validate that the PPS-N Site Parameters settings are correct."
"RTN","PSNFTP",350,0)
 S PSMSGTXT(20)="2.    Validate that PRV version above is the version installed locally."
"RTN","PSNFTP",351,0)
 S PSMSGTXT(21)="3.    Rerun the download option to re-attempt retrieval."
"RTN","PSNFTP",352,0)
 S PSMSGTXT(22)="4.    Contact the National Help Desk or enter a ticket."
"RTN","PSNFTP",353,0)
 S PSMSGTXT(23)=""
"RTN","PSNFTP",354,0)
 S PSMSGTXT(24)="Further details can be found on the Download/Install Status Report option."
"RTN","PSNFTP",355,0)
 Q
"RTN","PSNFTP",356,0)
 ;
"RTN","PSNFTP",357,0)
MSGTEXT1(PSFILE,PSSIZE,PSMSGTXT) ;build message text
"RTN","PSNFTP",358,0)
 ;Inputs: PSFILE - file name
"RTN","PSNFTP",359,0)
 ;        PSSIZE - file size
"RTN","PSNFTP",360,0)
 ;        PSMSGTXT - array reference for message text
"RTN","PSNFTP",361,0)
 ;Output: populated PSMSGTXT
"RTN","PSNFTP",362,0)
 ;
"RTN","PSNFTP",363,0)
 S PSMSGTXT(1)="The PPS-N/NDF file "_PSFILE_" (Size "_PSSIZE_$S(PSSIZE["MB":"",1:" bytes")_")"
"RTN","PSNFTP",364,0)
 S PSMSGTXT(2)="has been DOWNLOADED and is available for installation via the scheduled"
"RTN","PSNFTP",365,0)
 S PSMSGTXT(3)="or manual process utilized at your site.  The following VistA options will"
"RTN","PSNFTP",366,0)
 S PSMSGTXT(4)="be placed out of order while the NDF Update file is installed: Print PMI"
"RTN","PSNFTP",367,0)
 S PSMSGTXT(5)="Sheet, Patient Prescription Processing, Release Medication, and Reprint"
"RTN","PSNFTP",368,0)
 S PSMSGTXT(6)="an Outpatient Rx label."
"RTN","PSNFTP",369,0)
 Q
"RTN","PSNFTP",370,0)
 ;
"RTN","PSNFTP",371,0)
 ;<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>> SFTP COMMANDS FILE <<<<<<<<<<<<<<<<<<<<<<<<<<
"RTN","PSNFTP",372,0)
CREATDAT(PSRC,PSDATFIL,PSWRKDIR,PSREMDIR,PSREMFIL) ; create .dat file with sftp commands - "PSNSFTP.DAT"
"RTN","PSNFTP",373,0)
 N POP
"RTN","PSNFTP",374,0)
 D OPEN^%ZISH("FILE1",PSWRKDIR,PSDATFIL,"W")
"RTN","PSNFTP",375,0)
 I POP S PSRC="0^failed to open sftp .dat file" Q
"RTN","PSNFTP",376,0)
 D USE^%ZISUTL("FILE1")
"RTN","PSNFTP",377,0)
 W "cd ",PSREMDIR,!
"RTN","PSNFTP",378,0)
 I +PSOS'=3 W "ascii",!
"RTN","PSNFTP",379,0)
 W "get ",PSREMFIL,!
"RTN","PSNFTP",380,0)
 W "exit",!
"RTN","PSNFTP",381,0)
 D CLOSE^%ZISH("FILE1")
"RTN","PSNFTP",382,0)
 Q
"RTN","PSNFTP",383,0)
 ;
"RTN","PSNFTP",384,0)
DELFILES(PSDIR,PSFILES) ;Delete Local Host File, any OS
"RTN","PSNFTP",385,0)
 ;Inputs: PSDIR - directory (path) name - in proper format of OS, including trailing / or \
"RTN","PSNFTP",386,0)
 ;        PSFILES - array of file names, by reference
"RTN","PSNFTP",387,0)
 ;          Ex: PSFILES("FILE1.DAT")=""
"RTN","PSNFTP",388,0)
 ;Returns:
"RTN","PSNFTP",389,0)
 ;    1-Success for all deletions.
"RTN","PSNFTP",390,0)
 ;    0-Failure on at least one deletion.
"RTN","PSNFTP",391,0)
 ;
"RTN","PSNFTP",392,0)
 N PSRC
"RTN","PSNFTP",393,0)
 S PSRC=$$DEL^%ZISH(PSDIR,$NAME(PSFILES))
"RTN","PSNFTP",394,0)
 Q PSRC
"RTN","PSNFTP",395,0)
 ;
"RTN","PSNFTP",396,0)
LINUXDEL(PSRC,PSDIR,PSFILE) ;Delete Local Host File
"RTN","PSNFTP",397,0)
 ;Inputs: PSRC - return code, by reference
"RTN","PSNFTP",398,0)
 ;        PSDIR - directory name
"RTN","PSNFTP",399,0)
 ;        PSFILE - file name
"RTN","PSNFTP",400,0)
 ;Output: PSRC - populated return code
"RTN","PSNFTP",401,0)
 ;
"RTN","PSNFTP",402,0)
 ;check parameters
"RTN","PSNFTP",403,0)
 I $G(PSDIR)="" S PSRC="0^no directory name" Q
"RTN","PSNFTP",404,0)
 I $G(PSFILE)="" S PSRC="0^no file name" Q
"RTN","PSNFTP",405,0)
 S PSZFRC=$ZF(-1,"rm -f "_PSDIR_PSFILE)
"RTN","PSNFTP",406,0)
 I PSZFRC=-1 S PSRC="0^Linux OS command execution failed" Q
"RTN","PSNFTP",407,0)
 Q
"RTN","PSNFTP",408,0)
 ;
"RTN","PSNFTP",409,0)
GETD() ; get the right directory based on OS type
"RTN","PSNFTP",410,0)
 N CDIR,PSOSX S CDIR=""
"RTN","PSNFTP",411,0)
 S PSOSX=$$OS^%ZOSV()
"RTN","PSNFTP",412,0)
 I PSOSX["VMS" S CDIR=$$GET1^DIQ(57.23,1,1)
"RTN","PSNFTP",413,0)
 I PSOSX["UNIX" S CDIR=$$GET1^DIQ(57.23,1,3)
"RTN","PSNFTP",414,0)
 Q CDIR
"RTN","PSNFTP",415,0)
 ;
"RTN","PSNFTP",416,0)
UPDTCTRL ;
"RTN","PSNFTP",417,0)
 K CTRLIEN S CTRLIEN=$O(^PS(57.23,"B","PPSN",""))
"RTN","PSNFTP",418,0)
 K FDA S FDA(57.234,"+2,"_1_",",.01)=PSREMFIL D UPDATE^DIE("","FDA")
"RTN","PSNFTP",419,0)
 K CTRLXIEN S CTRLXIEN=$O(^PS(57.23,1,4,"B",PSREMFIL,""),-1)
"RTN","PSNFTP",420,0)
 K FDA S FDA(57.234,CTRLXIEN_","_CTRLIEN_",",1)=PSNDNLDB
"RTN","PSNFTP",421,0)
 D NOW^%DTC
"RTN","PSNFTP",422,0)
 S FDA(57.234,CTRLXIEN_","_CTRLIEN_",",2)=%
"RTN","PSNFTP",423,0)
 S FDA(57.234,CTRLXIEN_","_CTRLIEN_",",3)=PSSIZE
"RTN","PSNFTP",424,0)
 I $G(PSERRMSG)'="" S FDA(57.234,CTRLXIEN_","_CTRLIEN_",",4)=PSERRMSG
"RTN","PSNFTP",425,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNFTP",426,0)
 S ^PS(57.23,1,4,"G",PSREMFIL)=$G(^PS(57.23,1,4,"G",PSREMFIL))+1
"RTN","PSNFTP",427,0)
 S ^PS(57.23,1,4,"G",PSREMFIL,CTRLXIEN)=$G(^PS(57.23,1,4,"G",PSREMFIL))
"RTN","PSNFTP",428,0)
 K FDA S FDA(57.23,CTRLIEN_",",30)=1 D FILE^DIE("","FDA") K FDA
"RTN","PSNFTP",429,0)
 Q
"RTN","PSNFTP",430,0)
 ;
"RTN","PSNFTP2")
0^16^B136877012^n/a
"RTN","PSNFTP2",1,0)
PSNFTP2 ;HP/ART - PPS-N National Drug File Updates File Transfer ;09/25/2015
"RTN","PSNFTP2",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNFTP2",3,0)
 ;Supported ICRs/IAs
"RTN","PSNFTP2",4,0)
 ;External reference to ^%ZISH supported by DBIA 2320
"RTN","PSNFTP2",5,0)
 ;External reference to ^%ZISUTL supported by DBIA 2119
"RTN","PSNFTP2",6,0)
 ;External reference to ^XLFSTR supported by DBIA 10104
"RTN","PSNFTP2",7,0)
 ;Reference to ^PS(59.7 supported by DBIA 2613
"RTN","PSNFTP2",8,0)
 ;
"RTN","PSNFTP2",9,0)
VMSFTP(PSRC,PSADDR,PSNUSER,PSWRKDIR,PSLOCDIR,PSREMDIR,PSREMFIL,PSCOMFIL,PSLOGFIL,PSDATFIL,PSERRMSG) ; VMS FTP
"RTN","PSNFTP2",10,0)
 ;        ALL PARARMETERS ARE REQUIRED EXCEPT PASSWORD
"RTN","PSNFTP2",11,0)
 ;Inputs: PSRC - return code, by reference
"RTN","PSNFTP2",12,0)
 ;        PSADDR - remote server address
"RTN","PSNFTP2",13,0)
 ;        PSNUSER - target system user name
"RTN","PSNFTP2",14,0)
 ;        PSWRKDIR - local work directory name
"RTN","PSNFTP2",15,0)
 ;        PSLOCDIR - local directory name
"RTN","PSNFTP2",16,0)
 ;        PSREMDIR - remote directory name
"RTN","PSNFTP2",17,0)
 ;        PSREMFIL - remote file name
"RTN","PSNFTP2",18,0)
 ;        PSCOMFIL - ftp .com file name
"RTN","PSNFTP2",19,0)
 ;        PSLOGFIL - ftp log file name
"RTN","PSNFTP2",20,0)
 ;        PSDATFIL - sftp commands file name
"RTN","PSNFTP2",21,0)
 ;Output: PSRC - populated return code
"RTN","PSNFTP2",22,0)
 ;
"RTN","PSNFTP2",23,0)
 ;check parameters
"RTN","PSNFTP2",24,0)
 I $G(PSADDR)="" S PSRC="0^no target server address" Q
"RTN","PSNFTP2",25,0)
 I $G(PSNUSER)="" S PSRC="0^no user name" Q
"RTN","PSNFTP2",26,0)
 I $G(PSWRKDIR)="" S PSRC="0^no local work directory name" Q
"RTN","PSNFTP2",27,0)
 I $G(PSLOCDIR)="" S PSRC="0^no local directory name" Q
"RTN","PSNFTP2",28,0)
 I $G(PSREMDIR)="" S PSRC="0^no remote directory name" Q
"RTN","PSNFTP2",29,0)
 I $G(PSREMFIL)="" S PSRC="0^no remote file name" Q
"RTN","PSNFTP2",30,0)
 I $G(PSCOMFIL)="" S PSRC="0^no ftp .com file name" Q
"RTN","PSNFTP2",31,0)
 I $G(PSLOGFIL)="" S PSRC="0^no ftp log file name" Q
"RTN","PSNFTP2",32,0)
 I $G(PSDATFIL)="" S PSRC="0^no sftp commands file name" Q
"RTN","PSNFTP2",33,0)
 ;
"RTN","PSNFTP2",34,0)
 ;create .dat file with sftp commands
"RTN","PSNFTP2",35,0)
 D CREATDAT^PSNFTP(.PSRC,PSDATFIL,PSWRKDIR,PSREMDIR,PSREMFIL) Q:'+PSRC
"RTN","PSNFTP2",36,0)
 ;
"RTN","PSNFTP2",37,0)
 ;create .com file
"RTN","PSNFTP2",38,0)
 N POP,FTPPORT S FTPPORT=""
"RTN","PSNFTP2",39,0)
 D OPEN^%ZISH("FILE1",PSWRKDIR,PSCOMFIL,"W")
"RTN","PSNFTP2",40,0)
 I POP S PSRC="0^failed to open ftp .com file" Q
"RTN","PSNFTP2",41,0)
 D USE^%ZISUTL("FILE1")
"RTN","PSNFTP2",42,0)
 W "$ set verify=(PROCEDURE,IMAGE)",!
"RTN","PSNFTP2",43,0)
 W "$ set default ",PSLOCDIR,!
"RTN","PSNFTP2",44,0)
 W "$ sftp"_$S(FTPPORT:" -oPort="_FTPPORT,1:"")_" -oIdentityFile="""_$$XVMSDIR(PSWRKDIR)_"VSSHID."" -""B"" "_PSWRKDIR_PSDATFIL_" -oUser="_PSNUSER_" "_PSADDR,!
"RTN","PSNFTP2",45,0)
 W "$ exit",!
"RTN","PSNFTP2",46,0)
 D CLOSE^%ZISH("FILE1")
"RTN","PSNFTP2",47,0)
 ;
"RTN","PSNFTP2",48,0)
 D OPEN^%ZISH("VSSHID",PSWRKDIR,"VSSHID.","W")
"RTN","PSNFTP2",49,0)
 I POP S PSRC="-1^FTP Script file <"_PSWRKDIR_"VSSHID.> could not be created." Q
"RTN","PSNFTP2",50,0)
 D USE^%ZISUTL("VSSHID")
"RTN","PSNFTP2",51,0)
 W "IDKEY "_$$XVMSDIR(PSWRKDIR)_"VSSHKEY"
"RTN","PSNFTP2",52,0)
 D CLOSE^%ZISH("VSSHID")
"RTN","PSNFTP2",53,0)
 ;
"RTN","PSNFTP2",54,0)
EXECUTE ;Execute .COM file, create logfile
"RTN","PSNFTP2",55,0)
 N PSZFRC
"RTN","PSNFTP2",56,0)
 S PSZFRC=$ZF(-1,"@"_PSWRKDIR_PSCOMFIL_"/OUTPUT="_PSWRKDIR_PSLOGFIL)
"RTN","PSNFTP2",57,0)
 ; Error check
"RTN","PSNFTP2",58,0)
 I PSZFRC=-1 S PSRC="0^VMS OS command execution failed" Q
"RTN","PSNFTP2",59,0)
 ;
"RTN","PSNFTP2",60,0)
 ; Read Logfile into working global
"RTN","PSNFTP2",61,0)
 K ^TMP("PSNFTPLOG",$J)
"RTN","PSNFTP2",62,0)
 N PSXLOG
"RTN","PSNFTP2",63,0)
 S PSXLOG=$$FTG^%ZISH(PSWRKDIR,PSLOGFIL,$NA(^TMP("PSNFTPLOG",$J,1)),3)
"RTN","PSNFTP2",64,0)
 ; Check for error during ftp
"RTN","PSNFTP2",65,0)
 N PSPNG,PSPNG1,PSSTOP
"RTN","PSNFTP2",66,0)
 S PSPNG="",PSPNG1=0,PSSTOP=0
"RTN","PSNFTP2",67,0)
 F  S PSPNG=$O(^TMP("PSNFTPLOG",$J,PSPNG)) Q:PSPNG=""!PSSTOP  D
"RTN","PSNFTP2",68,0)
 . S PSPNG1=$G(^TMP("PSNFTPLOG",$J,PSPNG))
"RTN","PSNFTP2",69,0)
 . I PSPNG1["%TCPIP-E-SSH_FC_ERR_NO_S, file doesn't exist" S PSRC="0^Remote file was not found",PSSTOP=1 Q
"RTN","PSNFTP2",70,0)
 . I PSPNG1["%TCPIP-F-SSH_FATAL" S PSRC="0^non-specific fatal error",PSSTOP=1 Q
"RTN","PSNFTP2",71,0)
 . I PSPNG1["530 Login incorrect" S PSRC="0^server login failure",PSSTOP=1 Q
"RTN","PSNFTP2",72,0)
 . I PSPNG1["550-Failed to open" S PSRC="-1^remote file not found",PSSTOP=1 Q
"RTN","PSNFTP2",73,0)
 . I PSPNG1["550 file not found" S PSRC="-1^remote file not found",PSSTOP=1 Q
"RTN","PSNFTP2",74,0)
 . I PSPNG1["no such file" S PSRC="-1^remote file not found",PSSTOP=1 Q
"RTN","PSNFTP2",75,0)
 . I PSPNG1["No such file" S PSRC="-1^remote file not found",PSSTOP=1 Q
"RTN","PSNFTP2",76,0)
 . I PSPNG1["error processing output file" S PSRC="-1^remote file already downloaded",PSSTOP=1 Q
"RTN","PSNFTP2",77,0)
 . I PSPNG1["insufficient privilege" S PSRC="-1^remote file already downloaded",PSSTOP=1 Q
"RTN","PSNFTP2",78,0)
 . I PSPNG1["%SET-F-SEARCHFAIL" S PSRC="0^local file not found - change file permission",PSSTOP=1 Q
"RTN","PSNFTP2",79,0)
 . I PSPNG1["%TCPIP-E-SSH_FC_ERR_DEST" S PSRC="0^destination is not directory or does not exist",PSSTOP=1 Q
"RTN","PSNFTP2",80,0)
 . I PSPNG1["%TCPIP-E-SSH_FC_ERROR" S PSRC="0^destination is not directory or does not exist",PSSTOP=1 Q
"RTN","PSNFTP2",81,0)
 I PSSTOP=0 S PSERRMSG(1)="1^File Transfer is complete"
"RTN","PSNFTP2",82,0)
 D DELFILES($G(PSWRKDIR),$G(PSLOGFIL),$G(PSCOMFIL),$G(PSDATFIL))
"RTN","PSNFTP2",83,0)
 Q
"RTN","PSNFTP2",84,0)
 ;
"RTN","PSNFTP2",85,0)
LINUXFTP(PSRC,PSADDR,PSNUSER,PSWRKDIR,PSLOCDIR,PSREMDIR,PSREMFIL,PSSHFILE,PSLOGFIL,PSDATFIL) ; Linux FTP
"RTN","PSNFTP2",86,0)
 ;        ALL PARARMETERS ARE REQUIRED EXCEPT PASSWORD
"RTN","PSNFTP2",87,0)
 ;Inputs: PSRC - return code, by reference
"RTN","PSNFTP2",88,0)
 ;        PSADDR - remote server address
"RTN","PSNFTP2",89,0)
 ;        PSNUSER - target system user name
"RTN","PSNFTP2",90,0)
 ;        PSWRKDIR - local work directory name
"RTN","PSNFTP2",91,0)
 ;        PSLOCDIR - local directory name
"RTN","PSNFTP2",92,0)
 ;        PSREMDIR - remote directory name
"RTN","PSNFTP2",93,0)
 ;        PSREMFIL - remote file name
"RTN","PSNFTP2",94,0)
 ;        PSSHFILE - ftp .sh file name
"RTN","PSNFTP2",95,0)
 ;        PSLOGFIL - ftp log file name
"RTN","PSNFTP2",96,0)
 ;        PSDATFIL - sftp commands file name
"RTN","PSNFTP2",97,0)
 ;Output: PSRC - populated return code
"RTN","PSNFTP2",98,0)
 ;
"RTN","PSNFTP2",99,0)
 ;check parameters
"RTN","PSNFTP2",100,0)
 I $G(PSADDR)="" S PSRC="0^no target server address" Q
"RTN","PSNFTP2",101,0)
 I $G(PSNUSER)="" S PSRC="0^no user name" Q
"RTN","PSNFTP2",102,0)
 I $G(PSWRKDIR)="" S PSRC="0^no local work directory name" Q
"RTN","PSNFTP2",103,0)
 I $G(PSLOCDIR)="" S PSRC="0^no local directory name" Q
"RTN","PSNFTP2",104,0)
 I $G(PSREMDIR)="" S PSRC="0^no remote directory name" Q
"RTN","PSNFTP2",105,0)
 I $G(PSREMFIL)="" S PSRC="0^no remote file name" Q
"RTN","PSNFTP2",106,0)
 I $G(PSSHFILE)="" S PSRC="0^no ftp .sh file name" Q
"RTN","PSNFTP2",107,0)
 I $G(PSLOGFIL)="" S PSRC="0^no ftp log file name" Q
"RTN","PSNFTP2",108,0)
 I $G(PSDATFIL)="" S PSRC="0^no sftp commands file name" Q
"RTN","PSNFTP2",109,0)
 ;
"RTN","PSNFTP2",110,0)
 ;create .dat file with sftp commands
"RTN","PSNFTP2",111,0)
 D CREATDAT^PSNFTP(.PSRC,PSDATFIL,PSWRKDIR,PSREMDIR,PSREMFIL) Q:'+PSRC
"RTN","PSNFTP2",112,0)
 ;create .sh file
"RTN","PSNFTP2",113,0)
 N POP,DEBUG1 S DEBUG1=1
"RTN","PSNFTP2",114,0)
 D OPEN^%ZISH("FILE1",PSWRKDIR,PSSHFILE,"W")
"RTN","PSNFTP2",115,0)
 I POP S PSRC="0^failed to open ftp .sh file" Q
"RTN","PSNFTP2",116,0)
 D USE^%ZISUTL("FILE1")
"RTN","PSNFTP2",117,0)
 ; Linux .sh commands
"RTN","PSNFTP2",118,0)
 W "#!/bin/bash",!!
"RTN","PSNFTP2",119,0)
 W "cd ",PSWRKDIR,!
"RTN","PSNFTP2",120,0)
 W "sftp"_" -oIdentityFile="""""_PSWRKDIR_"uxsshkey"""" -b "_PSWRKDIR_PSDATFIL_" -oStrictHostKeyChecking=no -oUser="_PSNUSER_" "_PSADDR_" >> "_PSWRKDIR_PSLOGFIL
"RTN","PSNFTP2",121,0)
 W !,"exit",!
"RTN","PSNFTP2",122,0)
 D CLOSE^%ZISH("FILE1")
"RTN","PSNFTP2",123,0)
 ;
"RTN","PSNFTP2",124,0)
 ; Execute .sh file, create logfile
"RTN","PSNFTP2",125,0)
 N PSZFRC
"RTN","PSNFTP2",126,0)
 S PSZFRC=$ZF(-1,PSWRKDIR_PSSHFILE_" >"_PSWRKDIR_PSLOGFIL)
"RTN","PSNFTP2",127,0)
 ; Error check
"RTN","PSNFTP2",128,0)
 I PSZFRC=-1 S PSRC="0^Linux OS command execution failed" Q
"RTN","PSNFTP2",129,0)
 ;
"RTN","PSNFTP2",130,0)
 ; Read Logfile into working global
"RTN","PSNFTP2",131,0)
 K ^TMP("PSNFTPLOG",$J)
"RTN","PSNFTP2",132,0)
 N PSXLOG
"RTN","PSNFTP2",133,0)
 S PSXLOG=$$FTG^%ZISH(PSWRKDIR,PSLOGFIL,$NA(^TMP("PSNFTPLOG",$J,1)),3)
"RTN","PSNFTP2",134,0)
 ; Check for error during ftp
"RTN","PSNFTP2",135,0)
 N PSPNG,PSPNG1,PSSTOP,UXEXIT
"RTN","PSNFTP2",136,0)
 S PSPNG="",(PSPNG1,PSSTOP,UXEXIT)=0
"RTN","PSNFTP2",137,0)
 F  S PSPNG=$O(^TMP("PSNFTPLOG",$J,PSPNG)) Q:PSPNG=""!PSSTOP  D
"RTN","PSNFTP2",138,0)
 . S PSPNG1=$G(^TMP("PSNFTPLOG",$J,PSPNG))
"RTN","PSNFTP2",139,0)
 . I $$UP^XLFSTR(PSPNG1)["SFTP> EXIT" S UXEXIT=1 Q
"RTN","PSNFTP2",140,0)
 . I PSPNG1["425 Not logged in" S PSRC="0^Login incorrect",PSSTOP=1 Q
"RTN","PSNFTP2",141,0)
 . I PSPNG1["530 Login incorrect" S PSRC="0^Login incorrect",PSSTOP=1 Q
"RTN","PSNFTP2",142,0)
 . I PSPNG1["550-Failed to open" S PSRC="-1^remote file not found",PSSTOP=1 Q
"RTN","PSNFTP2",143,0)
 . I PSPNG1["550 file not found" S PSRC="-1^remote file not found",PSSTOP=1 Q
"RTN","PSNFTP2",144,0)
 . I PSPNG1["no such file" S PSRC="-1^remote file not found",PSSTOP=1 Q
"RTN","PSNFTP2",145,0)
 . I PSPNG1["No such file" S PSRC="-1^remote file not found",PSSTOP=1 Q
"RTN","PSNFTP2",146,0)
 I UXEXIT=0 S PSRC="-1^Remote file was not found",PSSTOP=1 Q
"RTN","PSNFTP2",147,0)
 I PSSTOP=0,UXEXIT S PSERRMSG(1)="1^File Transfer is complete"
"RTN","PSNFTP2",148,0)
 D DELFILES($G(PSWRKDIR),$G(PSLOGFIL),$G(PSCOMFIL),$G(PSDATFIL))
"RTN","PSNFTP2",149,0)
 Q
"RTN","PSNFTP2",150,0)
 ;
"RTN","PSNFTP2",151,0)
WINFTP(PSRC,PSADDR,PSUID,PSWRKDIR,PSLOCDIR,PSREMDIR,PSREMFIL,PSCMDFIL,PSLOGFIL) ; Windows FTP
"RTN","PSNFTP2",152,0)
 ;        ALL PARARMETERS ARE REQUIRED EXCEPT PASSWORD
"RTN","PSNFTP2",153,0)
 ;Inputs: PSRC - return code, by reference
"RTN","PSNFTP2",154,0)
 ;        PSADDR - remote server address
"RTN","PSNFTP2",155,0)
 ;        PSUID - target system user name
"RTN","PSNFTP2",156,0)
 ;        PSWRKDIR - local work directory name
"RTN","PSNFTP2",157,0)
 ;        PSLOCDIR - local directory name
"RTN","PSNFTP2",158,0)
 ;        PSREMDIR - remote directory name
"RTN","PSNFTP2",159,0)
 ;        PSREMFIL - remote file name
"RTN","PSNFTP2",160,0)
 ;        PSCMDFIL - ftp commands file name
"RTN","PSNFTP2",161,0)
 ;        PSLOGFIL - ftp log file name
"RTN","PSNFTP2",162,0)
 ;Output: PSRC - populated return code
"RTN","PSNFTP2",163,0)
 ;
"RTN","PSNFTP2",164,0)
 ;check parameters
"RTN","PSNFTP2",165,0)
 I $G(PSADDR)="" S PSRC="0^no target server address" Q
"RTN","PSNFTP2",166,0)
 I $G(PSUID)="" S PSRC="0^no user name" Q
"RTN","PSNFTP2",167,0)
 I $G(PSWRKDIR)="" S PSRC="0^no local work directory name" Q
"RTN","PSNFTP2",168,0)
 I $G(PSLOCDIR)="" S PSRC="0^no local directory name" Q
"RTN","PSNFTP2",169,0)
 I $G(PSREMDIR)="" S PSRC="0^no remote directory name" Q
"RTN","PSNFTP2",170,0)
 I $G(PSREMFIL)="" S PSRC="0^no remote file name" Q
"RTN","PSNFTP2",171,0)
 I $G(PSCMDFIL)="" S PSRC="0^no ftp commands file name" Q
"RTN","PSNFTP2",172,0)
 I $G(PSLOGFIL)="" S PSRC="0^no ftp log file name" Q
"RTN","PSNFTP2",173,0)
 ;create ftp commands file
"RTN","PSNFTP2",174,0)
 N POP
"RTN","PSNFTP2",175,0)
 D OPEN^%ZISH("FILE1",PSWRKDIR,PSCMDFIL,"W")
"RTN","PSNFTP2",176,0)
 I POP S PSRC="0^failed to open ftp commands file" Q
"RTN","PSNFTP2",177,0)
 D USE^%ZISUTL("FILE1")
"RTN","PSNFTP2",178,0)
 W "open ",PSADDR,!
"RTN","PSNFTP2",179,0)
 W PSUID,!
"RTN","PSNFTP2",180,0)
 W "lcd ",PSLOCDIR,!
"RTN","PSNFTP2",181,0)
 W "cd ",PSREMDIR,!
"RTN","PSNFTP2",182,0)
 W "ascii",!
"RTN","PSNFTP2",183,0)
 W "get ",PSREMFIL,!
"RTN","PSNFTP2",184,0)
 W "quit",!
"RTN","PSNFTP2",185,0)
 D CLOSE^%ZISH("FILE1")
"RTN","PSNFTP2",186,0)
 ; Execute ftp file, create logfile
"RTN","PSNFTP2",187,0)
 N PSZFRC
"RTN","PSNFTP2",188,0)
 S PSZFRC=$ZF(-1,"sftp -s:"_PSWRKDIR_PSCMDFIL_" >"_PSWRKDIR_PSLOGFIL)
"RTN","PSNFTP2",189,0)
 ; Error check
"RTN","PSNFTP2",190,0)
 I PSZFRC=-1 S PSRC="0^Windows OS command execution failed" Q
"RTN","PSNFTP2",191,0)
 ; Read Logfile into working global
"RTN","PSNFTP2",192,0)
 K ^TMP("PSNFTPLOG",$J)
"RTN","PSNFTP2",193,0)
 N PSXLOG
"RTN","PSNFTP2",194,0)
 S PSXLOG=$$FTG^%ZISH(PSWRKDIR,PSLOGFIL,$NA(^TMP("PSNFTPLOG",$J,1)),3)
"RTN","PSNFTP2",195,0)
 ; Check for error during ftp
"RTN","PSNFTP2",196,0)
 N PSPNG,PSPNG1,PSSTOP
"RTN","PSNFTP2",197,0)
 S PSPNG=""
"RTN","PSNFTP2",198,0)
 S PSPNG1=0
"RTN","PSNFTP2",199,0)
 S PSSTOP=0
"RTN","PSNFTP2",200,0)
 F  S PSPNG=$O(^TMP("PSNFTPLOG",$J,PSPNG)) Q:PSPNG=""!PSSTOP  D
"RTN","PSNFTP2",201,0)
 . S PSPNG1=$G(^TMP("PSNFTPLOG",$J,PSPNG))
"RTN","PSNFTP2",202,0)
 . I PSPNG1["530 Login incorrect" S PSRC="0^Login incorrect",PSSTOP=1 Q
"RTN","PSNFTP2",203,0)
 . I PSPNG1["425 Not logged in" S PSRC="0^Login incorrect",PSSTOP=1 Q
"RTN","PSNFTP2",204,0)
 . I PSPNG1["550-Failed to open" S PSRC="-1^remote file not found",PSSTOP=1 Q
"RTN","PSNFTP2",205,0)
 . I PSPNG1["550 file not found" S PSRC="-1^remote file not found",PSSTOP=1 Q
"RTN","PSNFTP2",206,0)
 . I PSPNG1["no such file" S PSRC="-1^remote file not found",PSSTOP=1 Q
"RTN","PSNFTP2",207,0)
 . I PSPNG1["No such file" S PSRC="-1^remote file not found",PSSTOP=1 Q
"RTN","PSNFTP2",208,0)
 Q
"RTN","PSNFTP2",209,0)
 ;
"RTN","PSNFTP2",210,0)
FILSIZE(PSDIR,PSFILE,PSSIZE,PSNFLAG1) ;get the file size after retrieval
"RTN","PSNFTP2",211,0)
 N PSDIR,PSFSIZL,PSFSIZL2,DIE,DA,D0,DR,PSXLOG,PSSEQ,PSSEQD,PSIEN,ERROR,PSOS,X
"RTN","PSNFTP2",212,0)
 S PSOS=$$GETOS^PSNFTP
"RTN","PSNFTP2",213,0)
 S:'$D(PSDIR) PSDIR=$$GETD^PSNFTP()
"RTN","PSNFTP2",214,0)
 S PSFSIZL="PSFSIZE.LOG"
"RTN","PSNFTP2",215,0)
 S X=$ZF(-1,"DIR/SIZE=UNITS=BYTES "_PSDIR_PSFILE,PSDIR_PSFSIZL)
"RTN","PSNFTP2",216,0)
 S PSXLOG="",PSXLOG=$$FTG^%ZISH(PSDIR,PSFSIZL,$NA(^TMP("PSNFSIZELOG",$J,1)),3)
"RTN","PSNFTP2",217,0)
 S (PSSEQ,PSSEQD,PSIEN,DIE,DR,DA)=""
"RTN","PSNFTP2",218,0)
 F  S PSSEQ=$O(^TMP("PSNFSIZELOG",$J,PSSEQ)) Q:PSSEQ=""  D
"RTN","PSNFTP2",219,0)
 . S PSSEQD=$G(^TMP("PSNFSIZELOG",$J,PSSEQ))
"RTN","PSNFTP2",220,0)
 . I PSSEQD["Total of" S PSSIZE=$P(PSSEQD,",",2)
"RTN","PSNFTP2",221,0)
 S PSFSIZL2="PSFSIZE2.LOG"
"RTN","PSNFTP2",222,0)
 S X=$ZF(-1,"DIR/SIZE "_PSDIR_PSFILE,PSDIR_PSFSIZL2)
"RTN","PSNFTP2",223,0)
 S PSXLOG="",PSXLOG=$$FTG^%ZISH(PSDIR,PSFSIZL2,$NA(^TMP("PSNFSIZELOG2",$J,1)),3)
"RTN","PSNFTP2",224,0)
 S (PSSEQ,PSSEQD,PSIEN,DIE,DR,DA)=""
"RTN","PSNFTP2",225,0)
 F  S PSSEQ=$O(^TMP("PSNFSIZELOG2",$J,PSSEQ)) Q:PSSEQ=""  D
"RTN","PSNFTP2",226,0)
 . S PSSEQD=$G(^TMP("PSNFSIZELOG2",$J,PSSEQ))
"RTN","PSNFTP2",227,0)
 . I PSSEQD["Total of" S PSSIZE=PSSIZE_" or"_$P($P(PSSEQD,",",2),".")
"RTN","PSNFTP2",228,0)
 G:$G(PSNFLAG1) FILSIZQ
"RTN","PSNFTP2",229,0)
 S PSIEN="",PSIEN=$O(^PS(57.23,1,4,"B",PSFILE_";1",PSIEN))
"RTN","PSNFTP2",230,0)
 G FILSIZQ:PSIEN=""
"RTN","PSNFTP2",231,0)
 I '$G(PSNFLAG1) S DIE="^PS(57.23,1,4,",DA=PSIEN,DR="3///"_PSSIZE D ^DIE
"RTN","PSNFTP2",232,0)
FILSIZQ ;
"RTN","PSNFTP2",233,0)
 I '$G(PSOS) S PSOS=$$GETOS^PSNFTP
"RTN","PSNFTP2",234,0)
 I PSOS["VMS" D
"RTN","PSNFTP2",235,0)
 . D VMSDEL(1,PSDIR,PSFSIZL)
"RTN","PSNFTP2",236,0)
 . D VMSDEL(1,PSDIR,PSFSIZL2)
"RTN","PSNFTP2",237,0)
 K ^TMP("PSNFSIZELOG",$J)
"RTN","PSNFTP2",238,0)
 Q
"RTN","PSNFTP2",239,0)
 ;
"RTN","PSNFTP2",240,0)
VMSDEL(PSRC,PSDIR,PSFILE) ;Delete Local Host File
"RTN","PSNFTP2",241,0)
 ;Inputs: PSRC - return code, by reference
"RTN","PSNFTP2",242,0)
 ;        PSDIR - directory name
"RTN","PSNFTP2",243,0)
 ;        PSFILE - file name
"RTN","PSNFTP2",244,0)
 ;Output: PSRC - populated return code
"RTN","PSNFTP2",245,0)
 ;
"RTN","PSNFTP2",246,0)
 ;check parameters
"RTN","PSNFTP2",247,0)
 I $G(PSDIR)="" S PSRC="0^no directory name" Q
"RTN","PSNFTP2",248,0)
 I $G(PSFILE)="" S PSRC="0^no file name" Q
"RTN","PSNFTP2",249,0)
 S PSZFRC=$ZF(-1,"delete "_PSDIR_PSFILE_";*")
"RTN","PSNFTP2",250,0)
 I PSZFRC=-1 S PSRC="0^VMS OS command execution failed" Q
"RTN","PSNFTP2",251,0)
 Q
"RTN","PSNFTP2",252,0)
 ;
"RTN","PSNFTP2",253,0)
SAVEKEYS(LOCDIR) ; Saves Key to local directory
"RTN","PSNFTP2",254,0)
 ;Input: LOCDIR - Local directory where the keys should be saved to      
"RTN","PSNFTP2",255,0)
 N WLN,XPV
"RTN","PSNFTP2",256,0)
 I $$GET1^DIQ(57.23,1,39,"I")="SSH2" D
"RTN","PSNFTP2",257,0)
 . ;Saving the Private SSH Key
"RTN","PSNFTP2",258,0)
 . D OPEN^%ZISH("VSSHKEY",LOCDIR,"VSSHKEY","W")
"RTN","PSNFTP2",259,0)
 . D USE^%ZISUTL("VSSHKEY")
"RTN","PSNFTP2",260,0)
 . F WLN=1:1 Q:'$D(^PS(57.23,1,"PRVKEY",WLN))  D
"RTN","PSNFTP2",261,0)
 . . W $$DECRYP^XUSRB1(^PS(57.23,1,"PRVKEY",WLN,0)),!
"RTN","PSNFTP2",262,0)
 . D CLOSE^%ZISH("VSSHKEY")
"RTN","PSNFTP2",263,0)
 ;
"RTN","PSNFTP2",264,0)
 I $$OS^%ZOSV()["VMS" D  Q
"RTN","PSNFTP2",265,0)
 . ;Saving the Public SSH Key (Assuming SSH2 format) - VMS Only
"RTN","PSNFTP2",266,0)
 . D OPEN^%ZISH("VSSHKEY",LOCDIR,"VSSHKEY.PUB","W")
"RTN","PSNFTP2",267,0)
 . D USE^%ZISUTL("VSSHKEY")
"RTN","PSNFTP2",268,0)
 . F WLN=1:1 Q:'$D(^PS(57.23,1,"PUBKEY",WLN))  D
"RTN","PSNFTP2",269,0)
 . . W $$DECRYP^XUSRB1(^PS(57.23,1,"PUBKEY",WLN,0)),!
"RTN","PSNFTP2",270,0)
 . D CLOSE^%ZISH("VSSHKEY")
"RTN","PSNFTP2",271,0)
 ;
"RTN","PSNFTP2",272,0)
 I $$OS^%ZOSV()["UNIX" D  Q
"RTN","PSNFTP2",273,0)
 . ;If Key format is SSH2, convert VSSHKEY to OpenSSH format; Otherwise write directly from VistA
"RTN","PSNFTP2",274,0)
 . I $$GET1^DIQ(57.23,1,39,"I")="SSH2" D
"RTN","PSNFTP2",275,0)
 . . S XPV="S PV=$ZF(-1,""ssh-keygen -i -f "_LOCDIR_"VSSHKEY > "_LOCDIR_"uxsshkey"")"
"RTN","PSNFTP2",276,0)
 . . X XPV
"RTN","PSNFTP2",277,0)
 . E  D
"RTN","PSNFTP2",278,0)
 . . ;Saving the Private SSH Key (OpenSSH Format)
"RTN","PSNFTP2",279,0)
 . . D OPEN^%ZISH("uxsshkey",LOCDIR,"uxsshkey","W")
"RTN","PSNFTP2",280,0)
 . . D USE^%ZISUTL("uxsshkey")
"RTN","PSNFTP2",281,0)
 . . F WLN=1:1 Q:'$D(^PS(57.23,1,"PRVKEY",WLN))  D
"RTN","PSNFTP2",282,0)
 . . . W $$DECRYP^XUSRB1(^PS(57.23,1,"PRVKEY",WLN,0)),!
"RTN","PSNFTP2",283,0)
 . . D CLOSE^%ZISH("uxsshkey")
"RTN","PSNFTP2",284,0)
 . S XPV="S PV=$ZF(-1,""chmod 600 "_LOCDIR_"uxsshkey"")"
"RTN","PSNFTP2",285,0)
 . X XPV
"RTN","PSNFTP2",286,0)
 Q
"RTN","PSNFTP2",287,0)
DIREXIST(DIR) ; Returns whether the Linux Directory for sFTP already exists
"RTN","PSNFTP2",288,0)
 ;Input: DIR - Linux Directory name to be checked
"RTN","PSNFTP2",289,0)
 ;
"RTN","PSNFTP2",290,0)
 N DIREXIST
"RTN","PSNFTP2",291,0)
 I DIR="" Q 0
"RTN","PSNFTP2",292,0)
 I $$OS^%ZOSV()'="UNIX",($$UP^XLFSTR($$VERSION^%ZOSV(1))'["CACHE") Q 0
"RTN","PSNFTP2",293,0)
 I $E(DIR,$L(DIR))="/" S $E(DIR,$L(DIR))=""
"RTN","PSNFTP2",294,0)
 X "S DIREXIST=$ZSEARCH(DIR)"
"RTN","PSNFTP2",295,0)
 Q $S(DIREXIST="":0,1:1)
"RTN","PSNFTP2",296,0)
 ;
"RTN","PSNFTP2",297,0)
MAKEDIR(DIR) ; Create a new directory
"RTN","PSNFTP2",298,0)
 ;Input: DIR - Linux Directory name to be created
"RTN","PSNFTP2",299,0)
 ;
"RTN","PSNFTP2",300,0)
 N MKDIR
"RTN","PSNFTP2",301,0)
 I $$OS^%ZOSV()'="UNIX" Q
"RTN","PSNFTP2",302,0)
 I $$UP^XLFSTR($$VERSION^%ZOSV(1))'["CACHE" Q
"RTN","PSNFTP2",303,0)
 I $$DIREXIST(DIR) Q
"RTN","PSNFTP2",304,0)
 X "S MKDIR=$ZF(-1,""mkdir ""_DIR)"
"RTN","PSNFTP2",305,0)
 I 'MKDIR X "S MKDIR=$ZF(-1,""chmod 777 ""_DIR)"
"RTN","PSNFTP2",306,0)
 Q
"RTN","PSNFTP2",307,0)
 ;
"RTN","PSNFTP2",308,0)
DELFILES(LOCDIR,LOGFILE,PSCOMFIL,PSDATFIL) ; Delete Files
"RTN","PSNFTP2",309,0)
 ;Input: LOCDIR   - Local Directory
"RTN","PSNFTP2",310,0)
 ;
"RTN","PSNFTP2",311,0)
 N FILE2DEL,PSOOS
"RTN","PSNFTP2",312,0)
 I $G(LOCDIR)="" Q
"RTN","PSNFTP2",313,0)
 S PSOOS=$$OS^%ZOSV()
"RTN","PSNFTP2",314,0)
 S:$G(LOGFILE)'="" FILE2DEL(LOGFILE)=""
"RTN","PSNFTP2",315,0)
 S:$G(PSCOMFIL)'="" FILE2DEL(PSCOMFIL)=""
"RTN","PSNFTP2",316,0)
 S:$G(PSDATFIL)'="" FILE2DEL(PSDATFIL)=""
"RTN","PSNFTP2",317,0)
 I PSOOS["VMS" S FILE2DEL("VSSHID.")="",FILE2DEL("VSSHKEY.")="",FILE2DEL("VSSHKEY.PUB")=""
"RTN","PSNFTP2",318,0)
 I PSOOS["UNIX" S FILE2DEL("PSNSIZE.DAT")="",FILE2DEL("VSSHKEY")="",FILE2DEL("uxsshkey")=""
"RTN","PSNFTP2",319,0)
 I PSOOS["NT" S FILE2DEL("VSSHKEY")="",FILE2DEL("VSSHKEY.PUB")=""
"RTN","PSNFTP2",320,0)
 D DEL^%ZISH(LOCDIR,"FILE2DEL")
"RTN","PSNFTP2",321,0)
 Q
"RTN","PSNFTP2",322,0)
 ;
"RTN","PSNFTP2",323,0)
XVMSDIR(VMSDIR) ; Converts a VMS directory
"RTN","PSNFTP2",324,0)
 ; Input: VMSDIR    - OpenVMS directory name (e.g., "USER$:[SFTP.PPSN]")
"RTN","PSNFTP2",325,0)
 ; Output: $$XVMSDIR - Converted VMS directory (e.g., "/USER$/PPSN/")
"RTN","PSNFTP2",326,0)
 ;
"RTN","PSNFTP2",327,0)
 Q "/"_$TR(VMSDIR,".[]:","///")
"RTN","PSNFTP2",328,0)
 ;
"RTN","PSNFTP3")
0^26^B8030989^n/a
"RTN","PSNFTP3",1,0)
PSNFTP3 ;HP/ART - PPS-N NDF Updates File Transfer ;05/15/2017
"RTN","PSNFTP3",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNFTP3",3,0)
 ;
"RTN","PSNFTP3",4,0)
 Q
"RTN","PSNFTP3",5,0)
 ;
"RTN","PSNFTP3",6,0)
VERIFY ; PPS-N installation verification
"RTN","PSNFTP3",7,0)
 N NOW,RUN,START,PSNHLD,NODE,JOB,TYPE
"RTN","PSNFTP3",8,0)
 D NOW^%DTC S NOW=%,TYPE="I"
"RTN","PSNFTP3",9,0)
 S JOB=0 F  S JOB=$O(^XTMP("PSN PPS VERIFY",JOB)) Q:'JOB  S PSNHLD=""  F  S PSNHLD=$O(^XTMP("PSN PPS VERIFY",JOB,PSNHLD)) Q:PSNHLD=""  S NODE=$G(^XTMP("PSN PPS VERIFY",JOB,PSNHLD,0)) D
"RTN","PSNFTP3",10,0)
 . S START=$P(NODE,"^",2),RUN=$$FMDIFF^XLFDT(NOW,START,2) I RUN>3600 D
"RTN","PSNFTP3",11,0)
 . . K ^XTMP("PSN PPS VERIFY",JOB,PSNHLD,0)
"RTN","PSNFTP3",12,0)
 . . D MSG
"RTN","PSNFTP3",13,0)
 Q
"RTN","PSNFTP3",14,0)
 ;
"RTN","PSNFTP3",15,0)
MSG ; send error message to indicate installation did not complete
"RTN","PSNFTP3",16,0)
 N PSGRP,PSDA,PSNTXT,XMSUB,XMTEXT
"RTN","PSNFTP3",17,0)
 S XMSUB="ERROR: PPS-N "_$S(TYPE="D":"download",TYPE="I":"install",1:"")_" did not complete"
"RTN","PSNFTP3",18,0)
 S PSNFILE=$S($D(PSREMFIL):PSREMFIL,$D(PSNHLD):PSNHLD,1:"")
"RTN","PSNFTP3",19,0)
 I $D(DUZ) S XMY(DUZ)=""
"RTN","PSNFTP3",20,0)
 S PSDA=0 F  S PSDA=$O(^XUSEC("PSNMGR",PSDA)) Q:'PSDA  S XMY(PSDA)=""
"RTN","PSNFTP3",21,0)
 S PSGRP="",PSGRP=$$GET1^DIQ(57.23,1,5) I PSGRP'="" S XMY($$MG^PSNPPSMG(PSGRP))=""
"RTN","PSNFTP3",22,0)
 S PSGRP="",PSGRP=$$GET1^DIQ(57.23,1,6) I PSGRP'="" S XMY($$MG^PSNPPSMG(PSGRP))=""
"RTN","PSNFTP3",23,0)
 S PSNTXT(1)="**************************************************************************"
"RTN","PSNFTP3",24,0)
 S PSNTXT(2)="*** An error occurred during "_$S(TYPE="D":"download",1:"install")_" of the following Update file(s): ***"
"RTN","PSNFTP3",25,0)
 S PSNTXT(3)="**************************************************************************"
"RTN","PSNFTP3",26,0)
 S PSNTXT(4)="The following file(s) could not be "_$S(TYPE="D":"downloaded",1:"installed")_":"
"RTN","PSNFTP3",27,0)
 S PSNTXT(5)=""
"RTN","PSNFTP3",28,0)
 S PSNTXT(6)="      Update file Name"
"RTN","PSNFTP3",29,0)
 S PSNTXT(7)="      -------------------"
"RTN","PSNFTP3",30,0)
 S PSNTXT(8)="      "_PSNFILE
"RTN","PSNFTP3",31,0)
 S PSNTXT(9)=""
"RTN","PSNFTP3",32,0)
 S PSNTXT(10)="Error: "_$$EC^%ZOSV
"RTN","PSNFTP3",33,0)
 S PSNTXT(11)=""
"RTN","PSNFTP3",34,0)
 S PSNTXT(12)="How to correct your error:"
"RTN","PSNFTP3",35,0)
 S PSNTXT(13)="1. Rerun the "_$S(TYPE="D":"downloaded",TYPE="I":"installed",1:"")_" option to re-attempt retrieval."
"RTN","PSNFTP3",36,0)
 S PSNTXT(14)="2. Contact the National Help Desk or enter a ticket."
"RTN","PSNFTP3",37,0)
 S PSNTXT(15)=""
"RTN","PSNFTP3",38,0)
 S PSNTXT(16)="Further details can be found on the Download/Install Status Report option."
"RTN","PSNFTP3",39,0)
 S XMTEXT="PSNTXT("
"RTN","PSNFTP3",40,0)
 D ^XMD K XMSUB,XMY,XMTEXT
"RTN","PSNFTP3",41,0)
 Q
"RTN","PSNOSKEY")
0^25^B85865292^n/a
"RTN","PSNOSKEY",1,0)
PSNOSKEY ;BIR/SJA-PPS-N SSH Key Management ;09/16/2016
"RTN","PSNOSKEY",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNOSKEY",3,0)
 ;
"RTN","PSNOSKEY",4,0)
 ; taken mostly from: PSOSPMKY - State Prescription Monitoring Program - SSH Key Management
"RTN","PSNOSKEY",5,0)
 ;
"RTN","PSNOSKEY",6,0)
EN ; -- Entry point
"RTN","PSNOSKEY",7,0)
 N X,Y,PSNOS,LOCALDIR,X1,DIR
"RTN","PSNOSKEY",8,0)
 ;
"RTN","PSNOSKEY",9,0)
ACTION ; -- SSH Key Action
"RTN","PSNOSKEY",10,0)
 K DIR S DIR("A")="Action"
"RTN","PSNOSKEY",11,0)
 S DIR(0)="S^V:View Public SSH Key;C:Create New SSH Key Pair;D:Delete SSH Key Pair;H:Help with SSH Keys",DIR("B")="V"
"RTN","PSNOSKEY",12,0)
 D ^DIR
"RTN","PSNOSKEY",13,0)
 I $D(DUOUT)!($D(DIRUT)) G END
"RTN","PSNOSKEY",14,0)
 I Y="C"!(Y="D"),'$D(^XUSEC("PSN PPS COORD",DUZ)) D  G ACTION
"RTN","PSNOSKEY",15,0)
 .W !!,"The PSN PPS COORD security key is required for this action.",$C(7)
"RTN","PSNOSKEY",16,0)
 K ^TMP("PSNPUBKY",$J) D RETRIEVE("PUB")
"RTN","PSNOSKEY",17,0)
 I Y="V"!(Y="D"),'$D(^TMP("PSNPUBKY",$J)) D  G ACTION
"RTN","PSNOSKEY",18,0)
 .W !!,"[No SSH Key Pair found]",$C(7) D PAUSE
"RTN","PSNOSKEY",19,0)
 I Y="C"!(Y="D") D SIG^XUSESIG I X="^"!($G(X1)="") W:$G(X1)="" " SIGNATURE NOT VERIFIED",$C(7) G ACTION
"RTN","PSNOSKEY",20,0)
 ; 
"RTN","PSNOSKEY",21,0)
 ; -- View Public SSH Key
"RTN","PSNOSKEY",22,0)
 I Y="V" W ! D VIEW,PAUSE G ACTION
"RTN","PSNOSKEY",23,0)
 ;
"RTN","PSNOSKEY",24,0)
 ; -- Create New SSH Key Pair
"RTN","PSNOSKEY",25,0)
 I Y="C" D  G ACTION
"RTN","PSNOSKEY",26,0)
 .I '$$ASK() W !!,"No action taken!",$C(7) Q
"RTN","PSNOSKEY",27,0)
 .S PSNOS=$$ENDOS()
"RTN","PSNOSKEY",28,0)
 .S LOCALDIR=$$GET1^DIQ(57.23,1,$S(PSNOS["VMS":1,1:3))
"RTN","PSNOSKEY",29,0)
 .I LOCALDIR="" D  Q
"RTN","PSNOSKEY",30,0)
 ..W !!,"The ",$S(PSNOS["VMS":"OPEN VMS",1:"UNIX/LINUX")," LOCAL DIRECTORY parameter is missing. Please, update it in"
"RTN","PSNOSKEY",31,0)
 ..W !,"the 'PPS-N Site Parameters (Enter/Edit)' option and try again.",$C(7) D PAUSE
"RTN","PSNOSKEY",32,0)
 .K DIR S DIR("A")="SSH Key Encryption Type",DIR("?")="^D HELP1^PSNOSKEY"
"RTN","PSNOSKEY",33,0)
 .S DIR(0)="S^RSA:Rivest, Shamir & Adleman (RSA);DSA:Digital Signature Algorithm (DSA)"
"RTN","PSNOSKEY",34,0)
 .S DIR("B")="RSA" D ^DIR I $D(DUOUT)!($D(DIRUT)) Q
"RTN","PSNOSKEY",35,0)
 .S ENCRTYPE=Y
"RTN","PSNOSKEY",36,0)
 .I $D(^TMP("PSNPUBKY",$J)) D
"RTN","PSNOSKEY",37,0)
 ..W !!,$G(IOBON),"WARNING:",$G(IOBOFF)," You may be overwriting SSH Keys that are currently in use.",$C(7)
"RTN","PSNOSKEY",38,0)
 .K DIR S DIR("A")="Confirm Creation of SSH Keys",DIR(0)="Y",DIR("B")="NO"
"RTN","PSNOSKEY",39,0)
 .W ! D ^DIR I $D(DIRUT)!$D(DUOUT)!'Y Q
"RTN","PSNOSKEY",40,0)
 .;
"RTN","PSNOSKEY",41,0)
 .; -- Deleting Existing SSH Key
"RTN","PSNOSKEY",42,0)
 .I $D(^TMP("PSNPUBKY",$J)) D DELETE
"RTN","PSNOSKEY",43,0)
 .W !!,"Creating New SSH Keys, please wait..."
"RTN","PSNOSKEY",44,0)
 .N ZTRTN,ZTIO,ZTDESC,ZTDTH,ZTSK
"RTN","PSNOSKEY",45,0)
 .S ZTRTN="NEWKEY^PSNOSKEY("""_ENCRTYPE_""")",ZTIO="",ZTDESC="SSH Key Generation",ZTDTH=$$NOW^XLFDT()
"RTN","PSNOSKEY",46,0)
 .D ^%ZTLOAD K ZTSK,^TMP("PSNPUBKY",$J)
"RTN","PSNOSKEY",47,0)
 .F I=1:1:30 D RETRIEVE("PUB") Q:$D(^TMP("PSNPUBKY",$J))  H 1
"RTN","PSNOSKEY",48,0)
 .; -- If unable to create the key via Taskman after 30 seconds, creates them in the foreground
"RTN","PSNOSKEY",49,0)
 .I '$D(^TMP("PSNPUBKY",$J)) D
"RTN","PSNOSKEY",50,0)
 ..D NEWKEY(ENCRTYPE),RETRIEVE("PUB")
"RTN","PSNOSKEY",51,0)
 .I '$D(^TMP("PSNPUBKY",$J)) D
"RTN","PSNOSKEY",52,0)
 ..W !!,"There was a problem with the generation of the new SSH Key Pair."
"RTN","PSNOSKEY",53,0)
 ..W !,"Please try again and if the problem persists contact IT Support.",$C(7) D PAUSE
"RTN","PSNOSKEY",54,0)
 .E  W "Done",$C(7)
"RTN","PSNOSKEY",55,0)
 ;
"RTN","PSNOSKEY",56,0)
 ; -- Delete SSH Key Pair
"RTN","PSNOSKEY",57,0)
 I Y="D" D  G ACTION
"RTN","PSNOSKEY",58,0)
 .D RETRIEVE("PUB")
"RTN","PSNOSKEY",59,0)
 .I '$D(^TMP("PSNPUBKY",$J)) W !!,"[No SSH Key Pair found]",$C(7) Q
"RTN","PSNOSKEY",60,0)
 .W !!,$G(IOBON),"WARNING:",$G(IOBOFF)," You may be deleting SSH Keys that are currently in use.",$C(7)
"RTN","PSNOSKEY",61,0)
 .K DIR S DIR("A")="Confirm Deletion of SSH Keys",DIR(0)="Y",DIR("B")="NO"
"RTN","PSNOSKEY",62,0)
 .W ! D ^DIR I $D(DIRUT)!$D(DUOUT)!'Y Q
"RTN","PSNOSKEY",63,0)
 .W !!,"Deleting SSH Keys..." D DELETE H 1 W "Done",$C(7)
"RTN","PSNOSKEY",64,0)
 ; SSH Key Help
"RTN","PSNOSKEY",65,0)
 I Y="H" D HELP G ACTION
"RTN","PSNOSKEY",66,0)
 G ACTION
"RTN","PSNOSKEY",67,0)
 ;
"RTN","PSNOSKEY",68,0)
END ;
"RTN","PSNOSKEY",69,0)
 Q
"RTN","PSNOSKEY",70,0)
 ;
"RTN","PSNOSKEY",71,0)
NEWKEY(ENCRTYPE) ; Generate and store a pair of SSH keys
"RTN","PSNOSKEY",72,0)
 ; Input:  (o) ENCRTYPE - SSH Encryption Type (DSA/RSA) (Default: DSA)
"RTN","PSNOSKEY",73,0)
 ;
"RTN","PSNOSKEY",74,0)
 N LOCALDIR,DTE,PSNOS,KEYFILE,PV,FILE2DEL,LN,OVFLN,PSNSPC,KYTXT,SAVEKEY,DIE,DR,DA
"RTN","PSNOSKEY",75,0)
 S PSNOS=$$OS^%ZOSV()
"RTN","PSNOSKEY",76,0)
 S LOCALDIR=$$GET1^DIQ(57.23,1,$S(PSNOS["VMS":1,1:3)) I LOCALDIR="" Q  ;Error: Missing directory
"RTN","PSNOSKEY",77,0)
 I $G(ENCRTYPE)'="RSA" S ENCRTYPE="DSA"
"RTN","PSNOSKEY",78,0)
 ; -- LOCK to avoid OS files overwrite
"RTN","PSNOSKEY",79,0)
 F  S DTE=$P($$FMTHL7^XLFDT($$HTFM^XLFDT($H)),"-") S KEYFILE="KY"_DTE L +@KEYFILE:0 Q:$T  H 2
"RTN","PSNOSKEY",80,0)
 ; -- Deleting existing SSH Keys first
"RTN","PSNOSKEY",81,0)
 D DELETE
"RTN","PSNOSKEY",82,0)
 ;
"RTN","PSNOSKEY",83,0)
 ; -- OpenVMS SSH Key Generation
"RTN","PSNOSKEY",84,0)
 I PSNOS["VMS" D
"RTN","PSNOSKEY",85,0)
 .N COMFILE S COMFILE="COM"_DTE_".COM"
"RTN","PSNOSKEY",86,0)
 .D OPEN^%ZISH("COMFILE",LOCALDIR,COMFILE,"W")
"RTN","PSNOSKEY",87,0)
 .D USE^%ZISUTL("COMFILE")
"RTN","PSNOSKEY",88,0)
 .W "SSH_KEYGEN == ""$SYS$SYSTEM:TCPIP$SSH_SSH-KEYGEN2.EXE""",!
"RTN","PSNOSKEY",89,0)
 .W "SSH_KEYGEN -t "_$$LOW^XLFSTR($G(ENCRTYPE))_" -""P"" "_LOCALDIR_KEYFILE,!
"RTN","PSNOSKEY",90,0)
 .D CLOSE^%ZISH("COMFILE")
"RTN","PSNOSKEY",91,0)
 .X "S PV=$ZF(-1,""@"_LOCALDIR_COMFILE_""")"
"RTN","PSNOSKEY",92,0)
 .S FILE2DEL(COMFILE)="",FILE2DEL(KEYFILE_".")="",FILE2DEL(KEYFILE_".PUB")=""
"RTN","PSNOSKEY",93,0)
 ;
"RTN","PSNOSKEY",94,0)
 ; -- Linux/Unix SSH Key Generation
"RTN","PSNOSKEY",95,0)
 I PSNOS["UNIX" D
"RTN","PSNOSKEY",96,0)
 .I '$$DIREXIST^PSNFTP2(LOCALDIR) D MAKEDIR^PSNFTP2(LOCALDIR)
"RTN","PSNOSKEY",97,0)
 .X "S PV=$ZF(-1,""ssh-keygen -q -N '' -C '' -t "_$$LOW^XLFSTR($G(ENCRTYPE))_" -f "_LOCALDIR_KEYFILE_""")"
"RTN","PSNOSKEY",98,0)
 .S FILE2DEL(KEYFILE)="",FILE2DEL(KEYFILE_".pub")=""
"RTN","PSNOSKEY",99,0)
 ;
"RTN","PSNOSKEY",100,0)
 K ^TMP("PSNPRVKY",$J),^TMP("PSNPUBKY",$J)
"RTN","PSNOSKEY",101,0)
 ; -- Retrieving SSH Private Key Content
"RTN","PSNOSKEY",102,0)
 S X=$$FTG^%ZISH(LOCALDIR,KEYFILE_$S(PSNOS["VMS":".",1:""),$NAME(^TMP("PSNPRVKY",$J,1)),3)
"RTN","PSNOSKEY",103,0)
 I '$D(^TMP("PSNPRVKY",$J,1)) Q
"RTN","PSNOSKEY",104,0)
 ; -- Retrieving SSH Public Key Content
"RTN","PSNOSKEY",105,0)
 S X=$$FTG^%ZISH(LOCALDIR,KEYFILE_$S(PSNOS["VMS":".PUB",1:".pub"),$NAME(^TMP("PSNPUBKY",$J,1)),3)
"RTN","PSNOSKEY",106,0)
 I '$D(^TMP("PSNPUBKY",$J,1)) Q
"RTN","PSNOSKEY",107,0)
 ;
"RTN","PSNOSKEY",108,0)
 ; -- Deleting temporary files used to generate the keys
"RTN","PSNOSKEY",109,0)
 D DEL^%ZISH(LOCALDIR,"FILE2DEL")
"RTN","PSNOSKEY",110,0)
 ;
"RTN","PSNOSKEY",111,0)
 ; -- Saving new SSH Keys content in the PPS-N UPDATE CONTROL file (#57.23)
"RTN","PSNOSKEY",112,0)
 F PSNSPC="PSNPRVKY","PSNPUBKY" D
"RTN","PSNOSKEY",113,0)
 .K KYTXT,SAVEKEY
"RTN","PSNOSKEY",114,0)
 .F LN=1:1 Q:'$D(^TMP(PSNSPC,$J,LN))  D
"RTN","PSNOSKEY",115,0)
 ..; Unix/Linux Public SSH Key has no line-feed
"RTN","PSNOSKEY",116,0)
 ..I PSNOS["UNIX",PSNSPC="PSNPUBKY" D  Q
"RTN","PSNOSKEY",117,0)
 ...S KYTXT(1)=^TMP(PSNSPC,$J,LN) F OVFLN=1:1 Q:'$D(^TMP(PSNSPC,$J,LN,"OVF",OVFLN))  D
"RTN","PSNOSKEY",118,0)
 ....S KYTXT(1)=$G(KYTXT(1))_^TMP(PSNSPC,$J,LN,"OVF",OVFLN)
"RTN","PSNOSKEY",119,0)
 ..S KYTXT(LN)=$$ENCRYP^XUSRB1(^TMP(PSNSPC,$J,LN))
"RTN","PSNOSKEY",120,0)
 .I PSNOS["UNIX",PSNSPC="PSNPUBKY" S KYTXT(1)=$$ENCRYP^XUSRB1(KYTXT(1))
"RTN","PSNOSKEY",121,0)
 .S SAVEKEY(57.23,"1,",$S(PSNSPC="PSNPRVKY":33,1:34))="KYTXT"
"RTN","PSNOSKEY",122,0)
 .D UPDATE^DIE("","SAVEKEY")
"RTN","PSNOSKEY",123,0)
 .K ^TMP(PSNSPC,$J)
"RTN","PSNOSKEY",124,0)
 ;
"RTN","PSNOSKEY",125,0)
 ; -- Saving SSH Key Format (SSH2/OpenSSH) and Encryption Type (DSA/RSA) fields
"RTN","PSNOSKEY",126,0)
 K DIE S DIE="^PS(57.23,",DA=1
"RTN","PSNOSKEY",127,0)
 S DR="39///"_$S(PSNOS["VMS":"SSH2",1:"OSSH")_";41///"_ENCRTYPE D ^DIE
"RTN","PSNOSKEY",128,0)
 L -@KEYFILE
"RTN","PSNOSKEY",129,0)
 Q
"RTN","PSNOSKEY",130,0)
 ;
"RTN","PSNOSKEY",131,0)
RETRIEVE(KTYPE) ; Retrieve the SSH Key into the ^TMP global
"RTN","PSNOSKEY",132,0)
 ;        (o) KTYPE  - SSH Key Type (PUB - Public/PRV - PRivate) (Default: Public)
"RTN","PSNOSKEY",133,0)
 ;Output: ^TMP("PSN[PUB/PRV]KY",$J,0)="SSH Key Format (SSH2/OpenSSH)^Encryption Type (DSA/RSA)"
"RTN","PSNOSKEY",134,0)
 ;        ^TMP("PSN[PUB/PRV]KY",$J,1-N)=[SSH Key Content]
"RTN","PSNOSKEY",135,0)
 ;
"RTN","PSNOSKEY",136,0)
 N X,LN,KYTXT,PSNSPC
"RTN","PSNOSKEY",137,0)
 I $G(KTYPE)'="PRV" S KTYPE="PUB"
"RTN","PSNOSKEY",138,0)
 S X=$$GET1^DIQ(57.23,"1,",$S(KTYPE="PRV":33,1:34),,"KYTXT")
"RTN","PSNOSKEY",139,0)
 S PSNSPC=$S(KTYPE="PRV":"PSNPRVKY",1:"PSNPUBKY")
"RTN","PSNOSKEY",140,0)
 K ^TMP(PSNSPC,$J)
"RTN","PSNOSKEY",141,0)
 F LN=1:1 Q:'$D(KYTXT(LN))  S ^TMP(PSNSPC,$J,LN)=$$DECRYP^XUSRB1(KYTXT(LN))
"RTN","PSNOSKEY",142,0)
 I $D(^TMP(PSNSPC,$J)) D
"RTN","PSNOSKEY",143,0)
 .S ^TMP(PSNSPC,$J,0)=$$GET1^DIQ(57.23,1,39,"I")_"^"_$$GET1^DIQ(57.23,1,41,"I")
"RTN","PSNOSKEY",144,0)
 Q
"RTN","PSNOSKEY",145,0)
 ;
"RTN","PSNOSKEY",146,0)
VIEW ; Displays the SSH Public Key
"RTN","PSNOSKEY",147,0)
 ;       ^TMP("PSNPUBKY",$J,0)="SSH Key Format (SSH2/OpenSSH)^Encryption Type (DSA/RSA)"
"RTN","PSNOSKEY",148,0)
 ;       ^TMP("PSNPUBKY",$J,1-N)=[SSH Key Content]
"RTN","PSNOSKEY",149,0)
 N SSHKEY,DASHLN
"RTN","PSNOSKEY",150,0)
 S $P(DASHLN,"-",81)="",SSHKEY=$$OPENSSH()
"RTN","PSNOSKEY",151,0)
 W !,"Public SSH Key (",$P($G(^TMP("PSNPUBKY",$J,0)),"^",2),") content (does not include dash lines):"
"RTN","PSNOSKEY",152,0)
 W !,DASHLN
"RTN","PSNOSKEY",153,0)
 F  Q:$L(SSHKEY)=0  W !,$E(SSHKEY,1,80) S SSHKEY=$E(SSHKEY,81,9999)
"RTN","PSNOSKEY",154,0)
 W !,DASHLN
"RTN","PSNOSKEY",155,0)
 Q
"RTN","PSNOSKEY",156,0)
 ;
"RTN","PSNOSKEY",157,0)
DELETE ; Delete Both SSH Keys associated
"RTN","PSNOSKEY",158,0)
 N DIE,DA,DR
"RTN","PSNOSKEY",159,0)
 S DIE="^PS(57.23,",DA=1,DR="39///@;41///@;33///@;34///@" D ^DIE
"RTN","PSNOSKEY",160,0)
 K ^TMP("PSNPRVKY",$J),^TMP("PSNPUBKY",$J)
"RTN","PSNOSKEY",161,0)
 Q
"RTN","PSNOSKEY",162,0)
 ;
"RTN","PSNOSKEY",163,0)
OPENSSH() ; Returns the SSH Public Key in OpenSSH Format (Converts if necessary)
"RTN","PSNOSKEY",164,0)
 ;Input: ^TMP("PSNPUBKY",$J,0)="SSH Key Format (SSH2/OpenSSH)^Encryption Type (DSA/RSA)"
"RTN","PSNOSKEY",165,0)
 ;       ^TMP("PSNPUBKY",$J,1-N)=[SSH Key Content]
"RTN","PSNOSKEY",166,0)
 ;
"RTN","PSNOSKEY",167,0)
 N OPENSSH,ENCRTYPE,LN
"RTN","PSNOSKEY",168,0)
 S OPENSSH=""
"RTN","PSNOSKEY",169,0)
 I $P($G(^TMP("PSNPUBKY",$J,0)),"^")="SSH2" D
"RTN","PSNOSKEY",170,0)
 .S ENCRTYPE=$P($G(^TMP("PSNPUBKY",$J,0)),"^",2),OPENSSH=""
"RTN","PSNOSKEY",171,0)
 .F LN=5:1 Q:'$D(^TMP("PSNPUBKY",$J,LN))  D
"RTN","PSNOSKEY",172,0)
 ..I $G(^TMP("PSNPUBKY",$J,LN))["---- END" Q
"RTN","PSNOSKEY",173,0)
 ..S OPENSSH=OPENSSH_$G(^TMP("PSNPUBKY",$J,LN))
"RTN","PSNOSKEY",174,0)
 .S OPENSSH=$S(ENCRTYPE="RSA":"ssh-rsa",1:"ssh-dss")_" "_OPENSSH
"RTN","PSNOSKEY",175,0)
 E  D
"RTN","PSNOSKEY",176,0)
 .F LN=1:1 Q:'$D(^TMP("PSNPUBKY",$J,LN))  D
"RTN","PSNOSKEY",177,0)
 ..S OPENSSH=OPENSSH_$G(^TMP("PSNPUBKY",$J,LN))
"RTN","PSNOSKEY",178,0)
 Q OPENSSH
"RTN","PSNOSKEY",179,0)
 ;
"RTN","PSNOSKEY",180,0)
ENDOS() ; Returns the Backend Server Operating System (OS)
"RTN","PSNOSKEY",181,0)
 ;Output: Backend Operating System (e.,g., "VMS", "UNIX")
"RTN","PSNOSKEY",182,0)
 ;
"RTN","PSNOSKEY",183,0)
 N ENDOS,ZTRTN,ZTIO,ZTDESC,ZTDTH,ZTSK,I
"RTN","PSNOSKEY",184,0)
 K ^XTMP("PSNKEY",$J,"OS")
"RTN","PSNOSKEY",185,0)
 S ENDOS="",ZTRTN="SETOS^PSNOSKEY("_$J_")",ZTIO=""
"RTN","PSNOSKEY",186,0)
 S ZTDESC="Backend Server OS Check"
"RTN","PSNOSKEY",187,0)
 S ZTDTH=$$NOW^XLFDT() D ^%ZTLOAD
"RTN","PSNOSKEY",188,0)
 F I=1:1:5 S ENDOS=$G(^XTMP("PSNKEY",$J,"OS")) Q:ENDOS'=""  H 1
"RTN","PSNOSKEY",189,0)
 K ^XTMP("PSNKEY",$J,"OS")
"RTN","PSNOSKEY",190,0)
 Q $S(ENDOS'="":ENDOS,1:$$OS^%ZOSV())
"RTN","PSNOSKEY",191,0)
 ;
"RTN","PSNOSKEY",192,0)
SETOS(JOB) ; Sets the Operating Systems in ^XTMP("PSNKEY",$J,"OS") (Called via Taskman)
"RTN","PSNOSKEY",193,0)
 ;Input: JOB - $Job value from calling process
"RTN","PSNOSKEY",194,0)
 S ^XTMP("PSNKEY",JOB,"OS")=$$OS^%ZOSV()
"RTN","PSNOSKEY",195,0)
 Q
"RTN","PSNOSKEY",196,0)
 ;
"RTN","PSNOSKEY",197,0)
HELP ; Encryption Type Help
"RTN","PSNOSKEY",198,0)
 W !!,"Secure SHell (SSH) Encryption Keys are used to allow data file download."
"RTN","PSNOSKEY",199,0)
 W !,"Follow the steps below to successfully setup data file download from Austin "
"RTN","PSNOSKEY",200,0)
 W !,"server to VistA sites:",!
"RTN","PSNOSKEY",201,0)
 W !,"Step 1: Select the 'C' (Create New SSH Key Pair) Action and follow the prompts"
"RTN","PSNOSKEY",202,0)
 W !,"        to create a new pair of SSH keys. If you already have an existing SSH"
"RTN","PSNOSKEY",203,0)
 W !,"        Key Pair you can skip this step."
"RTN","PSNOSKEY",204,0)
 W !,"        You can check whether you already have an existing SSH Key Pair"
"RTN","PSNOSKEY",205,0)
 W !,"        through the 'V' (View Public SSH Key) Action."
"RTN","PSNOSKEY",206,0)
 W !,""
"RTN","PSNOSKEY",207,0)
 D HELP1,PAUSE
"RTN","PSNOSKEY",208,0)
 W !!,"Step 2: Share the Public SSH Key content with the PPS-N SFTP server (Austin)."
"RTN","PSNOSKEY",209,0)
 W !,"        Inorder to successfully establish the data download files, the SFTP  "
"RTN","PSNOSKEY",210,0)
 W !,"        server at Austin needs to install/configure the new SSH Key created in"
"RTN","PSNOSKEY",211,0)
 W !,"        step 1 for the user id they assigned to your site. Use the 'V' (View "
"RTN","PSNOSKEY",212,0)
 W !,"        Public SSH Key) Action to retrieve the content of the Public SSH key."
"RTN","PSNOSKEY",213,0)
 W !,"        The Public SSH Key should not contain line-feed characters, therefore "
"RTN","PSNOSKEY",214,0)
 W !,"        after you copy & paste it from the terminal emulator into an email or "
"RTN","PSNOSKEY",215,0)
 W !,"        text editor make sure it contains only one line of text (no wrapping)."
"RTN","PSNOSKEY",216,0)
 Q
"RTN","PSNOSKEY",217,0)
 ;
"RTN","PSNOSKEY",218,0)
HELP1 ; Encryption Type Help
"RTN","PSNOSKEY",219,0)
 W !,"        Encryption Type: RSA or DSA?"
"RTN","PSNOSKEY",220,0)
 W !,"        ----------------------------"
"RTN","PSNOSKEY",221,0)
 W !,"        The Rivest, Shamir & Adleman (RSA) and Digital Signature Algorithm"
"RTN","PSNOSKEY",222,0)
 W !,"        (DSA) are two of the most common encryption algorithms used in IT "
"RTN","PSNOSKEY",223,0)
 W !,"        industry for securely sharing data."
"RTN","PSNOSKEY",224,0)
 Q
"RTN","PSNOSKEY",225,0)
PAUSE ; Pauses screen until user hits Return
"RTN","PSNOSKEY",226,0)
 W ! K DIR S DIR("A")="Press Return to continue",DIR(0)="E" D ^DIR
"RTN","PSNOSKEY",227,0)
 Q
"RTN","PSNOSKEY",228,0)
 ;
"RTN","PSNOSKEY",229,0)
ASK() ; confirm creating new pair
"RTN","PSNOSKEY",230,0)
 N Y S Y=0 Q:'$D(^TMP("PSNPUBKY",$J)) 1
"RTN","PSNOSKEY",231,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNOSKEY",232,0)
 S DIR("A")="Do you want to delete existing key pair and create new pair" W !!
"RTN","PSNOSKEY",233,0)
 S DIR("B")="NO" D ^DIR
"RTN","PSNOSKEY",234,0)
 Q Y
"RTN","PSNPARM")
0^20^B55605893^n/a
"RTN","PSNPARM",1,0)
PSNPARM ;BIR/SJA-PPS-N Site Parameters ; 11/16/2016
"RTN","PSNPARM",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNPARM",3,0)
 ;
"RTN","PSNPARM",4,0)
 ;Reference to ^PS(59.7 supported by DBIA #2613
"RTN","PSNPARM",5,0)
 ;Reference to ^VA(200 supported by DBIA #10060
"RTN","PSNPARM",6,0)
 ;Reference to ^XUSEC supported by DBIA #10076
"RTN","PSNPARM",7,0)
 ;Reference to ^ORD(101 supported by DBIA #872
"RTN","PSNPARM",8,0)
 ;Reference to ^DIC(19.2 supported by DBIA #1472
"RTN","PSNPARM",9,0)
 ;Reference to ^DIC(19 supported by DBIA #2246
"RTN","PSNPARM",10,0)
 ;
"RTN","PSNPARM",11,0)
EN ; -- option entry point
"RTN","PSNPARM",12,0)
 N CURLEY,FLDS,LN,PSNAR,PSNLCK,PSNNOW,PSNNOW1,PSNOUT,PSNTAG,PSNUSER,PSNX,SHEMP,TYPE,X,XX,Y,Z
"RTN","PSNPARM",13,0)
 N NODE0,NODE1,NODE2,NOD597,PSNFLD,PSNJ,PSNZ,REQFLDS,IORVON,IORVOFF
"RTN","PSNPARM",14,0)
 S PSNOUT=0,REQFLDS="^3^4^5^6^7^10^11^12^13^"
"RTN","PSNPARM",15,0)
 S X="IORVON;IORVOFF" D ENDR^%ZISS
"RTN","PSNPARM",16,0)
 ;
"RTN","PSNPARM",17,0)
ASK ; -- screen display
"RTN","PSNPARM",18,0)
 G:PSNOUT END D DISP
"RTN","PSNPARM",19,0)
 W !!,"Select field number to Edit: " R X:DTIME I '$T!("^"[X) S PSNOUT=1 G END
"RTN","PSNPARM",20,0)
 S X=$S(X="a":"A",1:X) I '$D(PSNAR(X)),(X'?.N1":".N),(X'="A") D HELP G:PSNOUT END G ASK
"RTN","PSNPARM",21,0)
 I X="A" S X="1:14"
"RTN","PSNPARM",22,0)
 I X?.N1":".N S Y=$E(X),Z=$P(X,":",2) I Y<1!(Z>14)!(Y>Z) D HELP G:PSNOUT END G ASK
"RTN","PSNPARM",23,0)
 D HDR
"RTN","PSNPARM",24,0)
 I X?.N1":".N D RANGE G ASK
"RTN","PSNPARM",25,0)
 I $D(PSNAR(X)) S FLDS=X W ! D  G ASK
"RTN","PSNPARM",26,0)
 .I $$LOCK W ! D ONE,UNLOCK
"RTN","PSNPARM",27,0)
 ;
"RTN","PSNPARM",28,0)
END ; -- kill variables and quit
"RTN","PSNPARM",29,0)
 W @IOF
"RTN","PSNPARM",30,0)
 K CURLEY,FLDS,LN,PSNAR,PSNLCK,PSNNOW,PSNNOW1,PSNOUT,PSNTAG,PSNUSER,PSNX,SHEMP,TYPE,X,Y,Z
"RTN","PSNPARM",31,0)
 K NODE0,NODE1,NODE2,NOD597,PSNFLD,PSNJ,PSNZ,REQFLDS
"RTN","PSNPARM",32,0)
 Q
"RTN","PSNPARM",33,0)
RANGE ; -- range of numbers
"RTN","PSNPARM",34,0)
 I $$LOCK D  D UNLOCK
"RTN","PSNPARM",35,0)
 .W !! S SHEMP=$P(X,":"),CURLEY=$P(X,":",2) F FLDS=SHEMP:1:CURLEY Q:PSNOUT  D ONE
"RTN","PSNPARM",36,0)
 Q
"RTN","PSNPARM",37,0)
ONE ; -- edit one item
"RTN","PSNPARM",38,0)
 I FLDS=14 D DISOPTS^PSNPPSNR Q
"RTN","PSNPARM",39,0)
 I REQFLDS[("^"_FLDS_"^"),'$D(^XUSEC("PSN PPS COORD",DUZ)) D ERR Q
"RTN","PSNPARM",40,0)
 I FLDS=4,($P($G(^PS(57.23,1,0)),"^",4)="") D RDIR
"RTN","PSNPARM",41,0)
 K DR,DIE,DA S DA=1,DR=$P(PSNAR(FLDS),"^",3)_"T",DIE=$P(PSNAR(FLDS),"^",2) D ^DIE K DR,DA I $D(Y) S PSNOUT=1
"RTN","PSNPARM",42,0)
 I FLDS=7 W !!,"Press <RET> to continue, or '^' to quit  ",$C(7) R XX:DTIME I '$T!(XX["^") S PSNOUT=1
"RTN","PSNPARM",43,0)
 I FLDS=10,($P(^PS(57.23,1,0),"^",10)="Y"&("QN"[($P(^PS(59.7,1,10),"^",12)))) D
"RTN","PSNPARM",44,0)
 . S $P(^PS(57.23,1,0),"^",10)="N" S FLDS=11,$P(PSNAR(11),"^")="NO" G ONE
"RTN","PSNPARM",45,0)
 Q
"RTN","PSNPARM",46,0)
HDR ; -- print screen header
"RTN","PSNPARM",47,0)
 S $P(LN,"-",80)="" W @IOF,!
"RTN","PSNPARM",48,0)
 W !,"Pharmacy Product System-National(PPS-N) Site Parameters",!,LN,!
"RTN","PSNPARM",49,0)
 Q
"RTN","PSNPARM",50,0)
LOCK() ; -- apply incremental lock
"RTN","PSNPARM",51,0)
 N PSNNOW,PSNNOW1,PSNTAG
"RTN","PSNPARM",52,0)
 S PSNNOW=$$NOW^XLFDT,PSNNOW1=$$FMADD^XLFDT(PSNNOW,,2)
"RTN","PSNPARM",53,0)
 S PSNLCK=1,PSNTAG=""
"RTN","PSNPARM",54,0)
 L +^XTMP("PSNPARM"):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSNPARM",55,0)
 E  D L1 S PSNLCK=0 Q PSNLCK
"RTN","PSNPARM",56,0)
 D:PSNLCK XTMP
"RTN","PSNPARM",57,0)
 Q PSNLCK
"RTN","PSNPARM",58,0)
 ;
"RTN","PSNPARM",59,0)
UNLOCK() ; -- apply decremental lock
"RTN","PSNPARM",60,0)
 L -^XTMP("PSNPARM")
"RTN","PSNPARM",61,0)
 K ^XTMP("PSNPARM")
"RTN","PSNPARM",62,0)
 Q
"RTN","PSNPARM",63,0)
XTMP S ^XTMP("PSNPARM",0)=PSNNOW1_"^"_PSNNOW_"^PSN Site Parameters Lock"_PSNTAG_"^"_$J,^XTMP("PSNPARM",$J,DUZ)=""
"RTN","PSNPARM",64,0)
 Q
"RTN","PSNPARM",65,0)
L1 S PSNX="",PSNUSER="Another person",PSNX=$O(^XTMP("PSNPARM",$J,0))
"RTN","PSNPARM",66,0)
 I PSNX S PSNUSER=$P($G(^VA(200,PSNX,0)),"^")
"RTN","PSNPARM",67,0)
 D EN^DDIOL(PSNUSER_" is editing the PPS-N site Parameters. Please try again later.","","!,$C(7)") H 3
"RTN","PSNPARM",68,0)
 Q
"RTN","PSNPARM",69,0)
DISP ; -- displays parameters
"RTN","PSNPARM",70,0)
 S $P(LN,"-",80)="" D HDR
"RTN","PSNPARM",71,0)
 S NODE0=$G(^PS(57.23,1,0)),NODE1=$G(^PS(57.23,1,1)),NODE2=$G(^PS(57.23,1,2))
"RTN","PSNPARM",72,0)
 S NOD597=$G(^PS(59.7,1,10)),TYPE=$S($P(NOD597,"^",12)]"":$P(NOD597,"^",12),1:"")
"RTN","PSNPARM",73,0)
 I TYPE]"" S TYPE=TYPE_" - "_$S(TYPE="Q":"National SQA Testing",TYPE="P":"Production",TYPE="T":"Test Account",TYPE="S":"Product Support",TYPE="N":"QA NDFMS",1:"")
"RTN","PSNPARM",74,0)
 F PSNJ=1:1 S PSNFLD=$P($T(FIELD+PSNJ),";;",2) Q:PSNFLD=""!(PSNFLD="END")  S PSNZ(PSNJ)=$P(PSNFLD,"^",2)
"RTN","PSNPARM",75,0)
 S PSNAR(1)=$P(NODE0,"^",3)_"^57.23^2",PSNAR(2)=$P(NODE0,"^",7)_"^57.23^8"
"RTN","PSNPARM",76,0)
 S PSNAR(3)=$P(NODE0,"^",2)_"^57.23^1",PSNAR(4)=$P(NODE0,"^",4)_"^57.23^3",PSNAR(5)=$P(NODE2,"^")_"^57.23^20"
"RTN","PSNPARM",77,0)
 S PSNAR(6)=$P(NODE2,"^",2)_"^57.23^21",PSNAR(7)=$P(NODE2,"^",3)_"^57.23^22"
"RTN","PSNPARM",78,0)
 S PSNAR(8)=$P(NODE0,"^",6)_"^57.23^5",PSNAR(9)=$P(NODE1,"^")_"^57.23^6",PSNAR(10)=TYPE_"^59.7^17"
"RTN","PSNPARM",79,0)
 S PSNAR(11)=$S($P(NODE0,"^",10)="Y":"YES",$P(NODE0,"^",10)="N":"NO",1:"")_"^57.23^45"
"RTN","PSNPARM",80,0)
 S PSNAR(12)=$S($P(NODE0,"^",8)="Y":"IN PROGRESS",1:"NOT IN PROGRESS")_"^57.23^9"
"RTN","PSNPARM",81,0)
 S PSNAR(13)=$S($P(NODE0,"^",9)="Y":"IN PROGRESS",1:"NOT IN PROGRESS")_"^57.23^10"
"RTN","PSNPARM",82,0)
 S PSNAR(14)=IORVON_$S($$DISBL():"<DATA>",1:"")_IORVOFF
"RTN","PSNPARM",83,0)
 F PSNJ=1:1 Q:'$D(PSNZ(PSNJ))  W !,$$RJ^XLFSTR((PSNJ_"."),3," ")," ",$S(REQFLDS[("^"_PSNJ_"^"):"*",1:" "),PSNZ(PSNJ),?33,": ",$P(PSNAR(PSNJ),"^")
"RTN","PSNPARM",84,0)
 W !,LN
"RTN","PSNPARM",85,0)
 Q
"RTN","PSNPARM",86,0)
HELP W @IOF,!!!!,"Enter the number or range of numbers you want to edit.  Examples of proper",!,"responses are listed below."
"RTN","PSNPARM",87,0)
 W !!,"An '*' (asterisk) before the field indicates that an additional security key is required."
"RTN","PSNPARM",88,0)
 W !!,"1. Enter 'A' to update all information."
"RTN","PSNPARM",89,0)
 W !!,"2. Enter a specific number to update the information in that field.  (For",!,"   example, enter '1' to Update File Version Counter)"
"RTN","PSNPARM",90,0)
 W !!,"3. Enter a range of numbers separated by a ':' to enter a range of",!,"   information.  (For example, enter '1:3' to enter PPS-N Install Version,",!,"   PPS-N Download Version, and Open VMS Local Directory.)"
"RTN","PSNPARM",91,0)
 W !!,"Press <RET> to continue, or '^' to quit  " R X:DTIME I '$T!(X["^") S PSNOUT=1
"RTN","PSNPARM",92,0)
 Q
"RTN","PSNPARM",93,0)
ERR ; -- display error message
"RTN","PSNPARM",94,0)
 W !,PSNZ(FLDS)," :",$P(PSNAR(FLDS),"^"),!
"RTN","PSNPARM",95,0)
 W !,"Security key 'PSN PPS COORD' is required for editing this field."_$C(7)
"RTN","PSNPARM",96,0)
 W !!,"Press <RET> to continue, or '^' to quit  " R X:DTIME I '$T!(X["^") S PSNOUT=1 Q
"RTN","PSNPARM",97,0)
 W !!
"RTN","PSNPARM",98,0)
 Q
"RTN","PSNPARM",99,0)
DISBL() ; -- check for out of order scheduled option/menu option/protocol
"RTN","PSNPARM",100,0)
 N X,I,ICNT,ND,SOPT K ^TMP("PSN PPSN PARSED",$J)
"RTN","PSNPARM",101,0)
 S ICNT=0 F ND="3:19.2","3.1:19","3.2:101" D
"RTN","PSNPARM",102,0)
 .S X=0 F  S X=$O(^PS(57.23,1,+ND,"B",X)) Q:'X  S I=0 F  S I=$O(^PS(57.23,1,+ND,"B",X,I)) Q:'I  D
"RTN","PSNPARM",103,0)
 ..S SOPT=$$GET1^DIQ($P(ND,":",2),X,.01,"E") S:SOPT'="" ICNT=ICNT+1,^TMP("PSN PPSN PARSED",$J,SOPT,ICNT)=I
"RTN","PSNPARM",104,0)
 I $D(^TMP("PSN PPSN PARSED",$J)) K ^TMP("PSN PPSN PARSED",$J) Q 1
"RTN","PSNPARM",105,0)
 Q 0
"RTN","PSNPARM",106,0)
 ;
"RTN","PSNPARM",107,0)
RDIR ; -- recomended Unix dirrectory
"RTN","PSNPARM",108,0)
 N RUXDIR S RUXDIR=""
"RTN","PSNPARM",109,0)
 S RUXDIR=$$LXDIR() I RUXDIR="" Q
"RTN","PSNPARM",110,0)
 W !,"*** The recommended Unix/Linux Local Directory is ",RUXDIR,$C(7),!
"RTN","PSNPARM",111,0)
 Q
"RTN","PSNPARM",112,0)
UNXLDIR ; -- Unix/Linux Local Directory
"RTN","PSNPARM",113,0)
 N UNXLD,NDIR,DIR,DUOUT,DTOUT
"RTN","PSNPARM",114,0)
 I $$OS^%ZOSV()'="UNIX" Q
"RTN","PSNPARM",115,0)
 I $$UP^XLFSTR($$VERSION^%ZOSV(1))'["CACHE" Q
"RTN","PSNPARM",116,0)
 I $G(X)'="",$E(X,$L(X))'="/" S X=X_"/"
"RTN","PSNPARM",117,0)
 S UNXLD=X
"RTN","PSNPARM",118,0)
 I UNXLD'="",'$$DIREXIST^PSNFTP2(UNXLD) W ! D
"RTN","PSNPARM",119,0)
 . S DIR("A",1)="The directory above could not be found.",DIR("A",2)=""
"RTN","PSNPARM",120,0)
 . S DIR("A")="Would you like to create it now",DIR(0)="Y",DIR("B")="N"
"RTN","PSNPARM",121,0)
 . D ^DIR I $G(DTOUT)!$G(DUOUT)!'Y S X=UNXLD W ! Q
"RTN","PSNPARM",122,0)
 . S X=UNXLD
"RTN","PSNPARM",123,0)
 . D MAKEDIR^PSNFTP2(UNXLD) S NDIR=1 W !
"RTN","PSNPARM",124,0)
 . I '$$DIREXIST^PSNFTP2(UNXLD) D
"RTN","PSNPARM",125,0)
 . . W !!,"Warning: "_$S($G(NDIR):"The directory could not be created.",1:"The directory could not be found and is required for PPSN update file download."),!,$C(7)
"RTN","PSNPARM",126,0)
 . . K DIR S DIR(0)="FOA",DIR("A")="  Press <RET> to continue, or '^' to quit " D ^DIR K DIR I $D(DTOUT)!$D(DUOUT) S PSNOUT=1
"RTN","PSNPARM",127,0)
 Q
"RTN","PSNPARM",128,0)
 ;
"RTN","PSNPARM",129,0)
LXDIR() ; -- Returns the Linux Directory for PPSN sFTP
"RTN","PSNPARM",130,0)
 N CURDIR,ROOTDIR
"RTN","PSNPARM",131,0)
 I $$OS^%ZOSV()'="UNIX" Q ""
"RTN","PSNPARM",132,0)
 I $$UP^XLFSTR($$VERSION^%ZOSV(1))'["CACHE" Q ""
"RTN","PSNPARM",133,0)
 ; Retrieving the current directory
"RTN","PSNPARM",134,0)
 X "S CURDIR=$ZU(12)" S ROOTDIR=$P(CURDIR,"/",1,4)
"RTN","PSNPARM",135,0)
 I $E(ROOTDIR,$L(ROOTDIR))="/" S $E(ROOTDIR,$L(ROOTDIR))=""
"RTN","PSNPARM",136,0)
 Q ROOTDIR_"/user/sftp/PPSN/"
"RTN","PSNPARM",137,0)
 ;
"RTN","PSNPARM",138,0)
SCR(Y) ; -- screen entry to the Legacy Update Processing field
"RTN","PSNPARM",139,0)
 N TYPE,OK
"RTN","PSNPARM",140,0)
 S TYPE=$P(^PS(59.7,1,10),"^",12),OK=1
"RTN","PSNPARM",141,0)
 I "QN"[TYPE,Y="Y" S OK=0
"RTN","PSNPARM",142,0)
 Q OK
"RTN","PSNPARM",143,0)
 ;
"RTN","PSNPARM",144,0)
STRIP(X) ; strip control chrs and any other invalid characters
"RTN","PSNPARM",145,0)
 N II,YY,CHR
"RTN","PSNPARM",146,0)
 ; remove control characters & special chars
"RTN","PSNPARM",147,0)
 S YY="" F II=1:1:$L(X) I $A(X,II)>31 S YY=YY_$E(X,II)
"RTN","PSNPARM",148,0)
 S CHR="!#%&*)({} " F II=1:1:$L(CHR) I YY[$E(CHR,II) S YY=$$STRIP^XLFSTR(YY,$E(CHR,II))
"RTN","PSNPARM",149,0)
 Q YY
"RTN","PSNPARM",150,0)
 ;
"RTN","PSNPARM",151,0)
FIELD ; -- field name
"RTN","PSNPARM",152,0)
 ;;1^PPS-N Install Version
"RTN","PSNPARM",153,0)
 ;;2^PPS-N Download Version
"RTN","PSNPARM",154,0)
 ;;3^Open VMS Local Directory
"RTN","PSNPARM",155,0)
 ;;4^Unix/Linux Local Directory
"RTN","PSNPARM",156,0)
 ;;5^Remote Server Address
"RTN","PSNPARM",157,0)
 ;;6^Remote Server Directory
"RTN","PSNPARM",158,0)
 ;;7^Remote SFTP Username
"RTN","PSNPARM",159,0)
 ;;8^Primary PPS-N Mail Group
"RTN","PSNPARM",160,0)
 ;;9^Secondary PPS-N Mail group
"RTN","PSNPARM",161,0)
 ;;10^PPS-N Account Type
"RTN","PSNPARM",162,0)
 ;;11^Legacy Update Processing
"RTN","PSNPARM",163,0)
 ;;12^Download Status
"RTN","PSNPARM",164,0)
 ;;13^Install Status
"RTN","PSNPARM",165,0)
 ;;14^Disable Menus, Options, etc
"RTN","PSNPARM",166,0)
 ;;END
"RTN","PSNPPSCL")
0^28^B48571285^n/a
"RTN","PSNPPSCL",1,0)
PSNPPSCL ;BIR/DMA-clean up ingredients and interactions ; 19 Aug 2008  9:42 AM
"RTN","PSNPPSCL",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**;  30 Oct 98;Build 53
"RTN","PSNPPSCL",3,0)
 ;Reference to ^GMR(120.8 supported by DBIA #2545
"RTN","PSNPPSCL",4,0)
 ;Reference to ^PS(59.7 supported by DBIA #2613
"RTN","PSNPPSCL",5,0)
 ;
"RTN","PSNPPSCL",6,0)
 N DA,DIE,DIK,DR,J,LINE,NA,NEWDA,PSN,PSNDA,PSNI,PSNI1,PSNI1N,PSNI1P,PSNI2,PSNI2N,PSNI2P,PSNN,PSNK,PSNPAT,PSNX,X,XMDUZ,XMSUB,XMTEXT,XMY,PSNLEG
"RTN","PSNPPSCL",7,0)
 K ^TMP($J),^TMP("PSN",$J)
"RTN","PSNPPSCL",8,0)
INTER ;CHECK FOR NON-PRIMARIES
"RTN","PSNPPSCL",9,0)
 S LINE=1
"RTN","PSNPPSCL",10,0)
 I $G(PSNHLD)'="" S ^TMP("PSN",$J,LINE,0)="PPS-N Update File: "_$P(PSNHLD,";",1),LINE=LINE+1,^TMP("PSN",$J,LINE,0)=""   ;add filename to top of file
"RTN","PSNPPSCL",11,0)
 D ENABLE^PSNPPSMS ;enable menu options - PBM decided this is where they want this to happen.
"RTN","PSNPPSCL",12,0)
 I $G(PSNSITET)'="" D CTRKDL^PSNPPSMS("Processing Interactions")
"RTN","PSNPPSCL",13,0)
 W:'$G(PSNSCJOB) !,"Processing Interactions...",!
"RTN","PSNPPSCL",14,0)
 S (PSNI1N,PSNI2N)="",DA=0 F  S DA=$O(^PS(56,DA)) Q:'DA  S X=^(DA,0),PSNI1=$P(X,"^",2),PSNI2=$P(X,"^",3),PSNI1N=$P(^PS(50.416,PSNI1,0),"^",2) D
"RTN","PSNPPSCL",15,0)
 .I 'PSNI1N,'PSNI2N Q
"RTN","PSNPPSCL",16,0)
 .S PSNI2N=$P(^PS(50.416,PSNI2,0),"^",2)
"RTN","PSNPPSCL",17,0)
 .S PSNI1P=$S('PSNI1N:PSNI1,1:PSNI1N),PSNI2P=$S('PSNI2N:PSNI2,1:PSNI2N)
"RTN","PSNPPSCL",18,0)
 .I '$D(^PS(56,"AE",PSNI1P,PSNI2P)) D  Q
"RTN","PSNPPSCL",19,0)
 ..;NO PRE-EXISTING INTERACTION - RENAME AND QUIT
"RTN","PSNPPSCL",20,0)
 ..K PSN,PSNN S PSN($P(^PS(50.416,PSNI1P,0),"^"))="",PSN($P(^PS(50.416,PSNI2P,0),"^"))="",PSNN=$O(PSN(""))_"/"_$O(PSN($O(PSN("")))),^TMP($J,"RENAM",$P(X,"^")_"^"_PSNN)="",DIE="^PS(56,",DR=".01////"_PSNN D ^DIE
"RTN","PSNPPSCL",21,0)
 ..K ^PS(56,"AI1",PSNI1,DA),^PS(56,"AI2",PSNI2,DA),^PS(56,"AE",PSNI1,PSNI2,DA),^PS(56,"AE",PSNI2,PSNI1,DA) S (^PS(56,"AI1",PSNI1P,DA),^PS(56,"AI2",PSNI2P,DA),^PS(56,"AE",PSNI1P,PSNI2P,DA),^PS(56,"AE",PSNI2P,PSNI1P,DA))=""
"RTN","PSNPPSCL",22,0)
 ..S $P(^PS(56,DA,0),"^",2,3)=PSNI1P_"^"_PSNI2P
"RTN","PSNPPSCL",23,0)
 .;PRE-EXISTING INTERACTIONS - LOG TO DELETE
"RTN","PSNPPSCL",24,0)
 .S NEWDA=$QS($Q(^PS(56,"AE",PSNI1P,PSNI2P)),5) D
"RTN","PSNPPSCL",25,0)
 ..S ^TMP($J,"DEL",$P(X,"^"))="",^TMP($J,"DELIEN",DA)=NEWDA
"RTN","PSNPPSCL",26,0)
 ;NOW DELETE AND REPOINT
"RTN","PSNPPSCL",27,0)
 S PSN=0 F  S PSN=$O(^TMP($J,"DELIEN",PSN)) Q:'PSN  S X=^PS(56,PSN,0),PSNI1=$P(X,"^",2),PSNI2=$P(X,"^",3),$P(^PS(56,PSN,0),"^",2,7)="" K ^PS(56,"AI1",PSNI1,PSN),^PS(56,"AI2",PSNI2,PSN),^PS(56,"AE",PSNI1,PSNI2,PSN),^PS(56,"AE",PSNI2,PSNI1,PSN)
"RTN","PSNPPSCL",28,0)
 ;NOW THE APD
"RTN","PSNPPSCL",29,0)
 S X="^PS(56,""APD"")" F  S X=$Q(@X) Q:$QS(X,2)'="APD"  I $D(^TMP($J,"DELIEN",$QS(X,5))) S NEWDA=^($QS(X,5)) K @X,^PS(56,"APD",$QS(X,4),$QS(X,3),$QS(X,5)) S (^PS(56,"APD",$QS(X,3),$QS(X,4),NEWDA),^PS(56,"APD",$QS(X,4),$QS(X,3),NEWDA))=""
"RTN","PSNPPSCL",30,0)
 ;NOW THE 0 NODE
"RTN","PSNPPSCL",31,0)
 S PSN=0 F  S PSN=$O(^TMP($J,"DELIEN",PSN)) Q:'PSN  S DIK="^PS(56,",DA=PSN D ^DIK
"RTN","PSNPPSCL",32,0)
 ;
"RTN","PSNPPSCL",33,0)
 I '$D(^TMP($J,"DEL")),'$D(^("RENAM")) D  G ALLER
"RTN","PSNPPSCL",34,0)
 .F J=1:1 S X=$P($T(TEXT4+J),";",3,300) Q:X=""  S LINE=LINE+1,^TMP("PSN",$J,LINE,0)=X
"RTN","PSNPPSCL",35,0)
 F J=1:1 S X=$P($T(TEXT+J),";",3,300) Q:X=""  S LINE=LINE+1,^TMP("PSN",$J,LINE,0)=X
"RTN","PSNPPSCL",36,0)
 I '$D(^TMP($J,"RENAM")) S ^TMP("PSN",$J,LINE,0)=" ",^TMP("PSN",$J,LINE+1,0)="none found",LINE=LINE+2
"RTN","PSNPPSCL",37,0)
 S NA="" F  S NA=$O(^TMP($J,"RENAM",NA)) Q:NA=""  S ^TMP("PSN",$J,LINE,0)=$P(NA,"^")_" was changed to",^TMP("PSN",$J,LINE+1,0)="   "_$P(NA,"^",2),^TMP("PSN",$J,LINE+2,0)=" ",LINE=LINE+3
"RTN","PSNPPSCL",38,0)
 F J=1:1 S X=$P($T(TEXT2+J),";",3,300) Q:X=""  S ^TMP("PSN",$J,LINE,0)=X,LINE=LINE+1
"RTN","PSNPPSCL",39,0)
 I '$D(^TMP($J,"DEL")) S ^TMP("PSN",$J,LINE,0)="none found",LINE=LINE+1
"RTN","PSNPPSCL",40,0)
 S NA="" F  S NA=$O(^TMP($J,"DEL",NA)) Q:NA=""  S ^TMP("PSN",$J,LINE,0)=NA,LINE=LINE+1
"RTN","PSNPPSCL",41,0)
ALLER ;now the allergies
"RTN","PSNPPSCL",42,0)
 I $G(PSNSITET)'="" D CTRKDL^PSNPPSMS("Processing allergies")
"RTN","PSNPPSCL",43,0)
 W:'$G(PSNSCJOB) !,"Processing allergies...",!
"RTN","PSNPPSCL",44,0)
 I ^XMB("NETNAME")["CMOP" G SENDIT
"RTN","PSNPPSCL",45,0)
 ;skip allergies for CMOPs
"RTN","PSNPPSCL",46,0)
 K ^TMP($J)
"RTN","PSNPPSCL",47,0)
 S PSNDA=0 F  S PSNDA=$O(^GMR(120.8,PSNDA)) Q:'PSNDA  I $D(^(PSNDA,0)) S PSNPAT=+^(0) I $D(^DPT(PSNPAT,0)) S PSNPAT=$P(^(0),"^"),PSNI=$P(^GMR(120.8,PSNDA,0),"^",3) D
"RTN","PSNPPSCL",48,0)
 .I PSNI["PS(50.416",$D(^PS(50.416,+PSNI,0)),$P(^(0),"^",2) S PSNI=$P(^(0),"^",2)_";PS(50.416,",$P(^GMR(120.8,PSNDA,0),"^",3)=PSNI
"RTN","PSNPPSCL",49,0)
 .S PSNK=0 F  S PSNK=$O(^GMR(120.8,PSNDA,2,PSNK)) Q:'PSNK  S PSNI=^(PSNK,0) D
"RTN","PSNPPSCL",50,0)
 ..S PSNX=$P(^PS(50.416,PSNI,0),"^",2) I PSNX S DA(1)=PSNDA,DA=PSNK,DIE="^GMR(120.8,DA(1),2,",DR=".01////"_$S($D(^GMR(120.8,DA(1),2,"B",PSNX)):"@",1:PSNX) D ^DIE S ^TMP($J,1,PSNPAT,$P(^PS(50.416,PSNI,0),"^")_"^"_$P(^PS(50.416,PSNX,0),"^"))=""
"RTN","PSNPPSCL",51,0)
 ;
"RTN","PSNPPSCL",52,0)
 I '$D(^TMP($J,1)) D  G SENDIT
"RTN","PSNPPSCL",53,0)
 .F J=1:1 S X=$P($T(TEXT5+J),";",3,300) Q:X=""  S ^TMP("PSN",$J,LINE,0)=X,LINE=LINE+1
"RTN","PSNPPSCL",54,0)
 F J=1:1 S X=$P($T(TEXT3+J),";",3,300) Q:X=""  S ^TMP("PSN",$J,LINE,0)=X,LINE=LINE+1
"RTN","PSNPPSCL",55,0)
 I '$D(^TMP($J,1)) S ^TMP("PSN",$J,LINE,0)="none found",LINE=LINE+1
"RTN","PSNPPSCL",56,0)
 S NA="" F  S NA=$O(^TMP($J,1,NA)) Q:NA=""  S X="" F  S X=$O(^TMP($J,1,NA,X)) Q:X=""  S ^TMP("PSN",$J,LINE,0)="Patient: "_NA,LINE=LINE+1,^TMP("PSN",$J,LINE,0)="Non-primary ingredient "_$P(X,"^"),LINE=LINE+1 D
"RTN","PSNPPSCL",57,0)
 .S ^TMP("PSN",$J,LINE,0)="was replaced with primary ingredient "_$P(X,"^",2),LINE=LINE+1,^TMP("PSN",$J,LINE,0)=" ",LINE=LINE+1
"RTN","PSNPPSCL",58,0)
 ;
"RTN","PSNPPSCL",59,0)
SENDIT ;
"RTN","PSNPPSCL",60,0)
 ;
"RTN","PSNPPSCL",61,0)
 I $G(PSNSITET)'="" D CTRKDL^PSNPPSMS("Sending Interactions and allergies email")
"RTN","PSNPPSCL",62,0)
 ;SETUP PRODUCTION OR SQA
"RTN","PSNPPSCL",63,0)
 N PSNPS,PSGRP
"RTN","PSNPPSCL",64,0)
 S PSNPS=$P($G(^PS(59.7,1,10)),"^",12)
"RTN","PSNPPSCL",65,0)
 S XMSUB="INTERACTIONS AND ALLERGIES UPDATED"
"RTN","PSNPPSCL",66,0)
 ;S XMDUZ="NDF_MANAGER"
"RTN","PSNPPSCL",67,0)
 S XMDUZ="NOREPLY@DOMAIN.EXT"
"RTN","PSNPPSCL",68,0)
 S XMTEXT="^TMP(""PSN"",$J,"
"RTN","PSNPPSCL",69,0)
 K XMY
"RTN","PSNPPSCL",70,0)
 S XMY(DUZ)="",DA=0 F  S DA=$O(^XUSEC("PSNMGR",DA)) Q:'DA  S XMY(DA)=""
"RTN","PSNPPSCL",71,0)
 S PSNLEG="" S PSNLEG=$$GET1^DIQ(57.23,1,45)   ;legacy update
"RTN","PSNPPSCL",72,0)
 N DIFROM D ^XMD
"RTN","PSNPPSCL",73,0)
 ;
"RTN","PSNPPSCL",74,0)
QUIT K DA,DIE,DIK,DR,J,LINE,NA,NEWDA,PSN,PSNDA,PSNI,PSNI1,PSNI1N,PSNI1P,PSNI2,PSNI2N,PSNI2P,PSNN,PSNK,PSNPAT,PSNX,X,XMDUZ,XMSUB,XMTEXT,XMY,^TMP($J),^TMP("PSN",$J)
"RTN","PSNPPSCL",75,0)
PRO K ^TMP("PSN",$J) ;M ^TMP("PSN",$J)=^TMP("PSN PPSN PARSED",$J,"CLASS")
"RTN","PSNPPSCL",76,0)
 N II,VAGEN,VADC,DATA,NDFKPR,NDFKD
"RTN","PSNPPSCL",77,0)
 S II=0 F  S II=$O(^TMP("PSN PPSN PARSED",$J,"CLASS",II)) Q:II=""  D
"RTN","PSNPPSCL",78,0)
 .S NDFKPR=II
"RTN","PSNPPSCL",79,0)
 .Q:'$D(^PSNDF(50.68,NDFKPR))
"RTN","PSNPPSCL",80,0)
 .S NDFKD=$G(^TMP("PSN PPSN PARSED",$J,"PRODS CHANGED CLASSES",NDFKPR))
"RTN","PSNPPSCL",81,0)
 .S $P(DATA,"^")=NDFKPR,$P(DATA,"^",2)=$P(NDFKD,"^",1)  ;OLD DRUG CLASS IEN
"RTN","PSNPPSCL",82,0)
 .S $P(DATA,"^",3)=$P(NDFKD,"^",2)  ;NEW DRUG CLASS IEN
"RTN","PSNPPSCL",83,0)
 .S $P(DATA,"^",4)=$P(NDFKD,"^",3)  ;VA GENERIC IEN
"RTN","PSNPPSCL",84,0)
 .Q:$P(DATA,"^",2)=""!($P(DATA,"^",3)="")!($P(DATA,"^",4)="")
"RTN","PSNPPSCL",85,0)
 .S ^TMP("PSN",$J,NDFKPR,0)=DATA
"RTN","PSNPPSCL",86,0)
 ;decision was made to not send the drug class emails, but we need to update the allergy files
"RTN","PSNPPSCL",87,0)
 I $D(^TMP("PSN",$J)) S ZTSAVE("^TMP(""PSN"",$J,")="",ZTIO="",ZTDTH=$H,ZTRTN="PROTO^PSNPPSCL" D ^%ZTLOAD K ZTSAVE,ZTIO,ZTDTH,ZTRTN Q
"RTN","PSNPPSCL",88,0)
 Q
"RTN","PSNPPSCL",89,0)
 ;
"RTN","PSNPPSCL",90,0)
PROTO S X="PSN NEW CLASS",DIC=101 D EN^XQOR K X,DIC Q
"RTN","PSNPPSCL",91,0)
 Q
"RTN","PSNPPSCL",92,0)
TEXT3 ; 
"RTN","PSNPPSCL",93,0)
 ;;  
"RTN","PSNPPSCL",94,0)
 ;;=========================================================================
"RTN","PSNPPSCL",95,0)
 ;;Allergy information for the following patients has been changed.
"RTN","PSNPPSCL",96,0)
 ;; 
"RTN","PSNPPSCL",97,0)
 ;;The allergy for the listed patients was created with a non-primary
"RTN","PSNPPSCL",98,0)
 ;;ingredient.  These have been updated to replace the non-primary
"RTN","PSNPPSCL",99,0)
 ;;ingredient with the proper primary ingredient.
"RTN","PSNPPSCL",100,0)
 ;;  
"RTN","PSNPPSCL",101,0)
 ;
"RTN","PSNPPSCL",102,0)
TEXT ;
"RTN","PSNPPSCL",103,0)
 ;; 
"RTN","PSNPPSCL",104,0)
 ;;The following interactions have been edited because they
"RTN","PSNPPSCL",105,0)
 ;;involved ingredients that are not primary ingredients.
"RTN","PSNPPSCL",106,0)
 ;; 
"RTN","PSNPPSCL",107,0)
 ;
"RTN","PSNPPSCL",108,0)
TEXT2 ; 
"RTN","PSNPPSCL",109,0)
 ;; 
"RTN","PSNPPSCL",110,0)
 ;;The following interactions have been deleted because
"RTN","PSNPPSCL",111,0)
 ;;Primary Ingredient/Other Ingredient combination already
"RTN","PSNPPSCL",112,0)
 ;;exists in the DRUG INGREDIENTS file involved ingredients
"RTN","PSNPPSCL",113,0)
 ;;that are not primary ingredients. 
"RTN","PSNPPSCL",114,0)
 ;; 
"RTN","PSNPPSCL",115,0)
 ;
"RTN","PSNPPSCL",116,0)
TEXT4 ;
"RTN","PSNPPSCL",117,0)
 ;; 
"RTN","PSNPPSCL",118,0)
 ;;No DRUG INTERACTIONS were updated due to Primary Ingredients being
"RTN","PSNPPSCL",119,0)
 ;;changed to Non-Primary ingredients in the Data Update.
"RTN","PSNPPSCL",120,0)
 ;; 
"RTN","PSNPPSCL",121,0)
 ;
"RTN","PSNPPSCL",122,0)
TEXT5 ;
"RTN","PSNPPSCL",123,0)
 ;; 
"RTN","PSNPPSCL",124,0)
 ;;No PATIENT ALLERGIES were updated due to Primary Ingredients being
"RTN","PSNPPSCL",125,0)
 ;;changed to Non-Primary ingredients during the Data Update.
"RTN","PSNPPSCL",126,0)
 ;; 
"RTN","PSNPPSDL")
0^6^B29912980^n/a
"RTN","PSNPPSDL",1,0)
PSNPPSDL ;HP/ART - National Drug File Updates File Download ;09/23/2015
"RTN","PSNPPSDL",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNPPSDL",3,0)
 ;
"RTN","PSNPPSDL",4,0)
 ;Reference to ^XUSEC( supported by IA #10076
"RTN","PSNPPSDL",5,0)
 ;
"RTN","PSNPPSDL",6,0)
 Q
"RTN","PSNPPSDL",7,0)
 ;
"RTN","PSNPPSDL",8,0)
DOWNLOAD ;Entry point for menu option PSN DOWNLOAD NDF UPDATES for immediate PPS-N update file download
"RTN","PSNPPSDL",9,0)
 N PSENTER,PSNLEGF
"RTN","PSNPPSDL",10,0)
 I $$GET1^DIQ(57.23,1,9,"I")="Y" D  Q
"RTN","PSNPPSDL",11,0)
 .W !!,"The PPS-N/NDF file download is already in progress.  Please try again later."
"RTN","PSNPPSDL",12,0)
 .R !!,"Press enter to continue...",PSENTER:120
"RTN","PSNPPSDL",13,0)
 N DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSDL",14,0)
 I '$D(^XUSEC("PSN PPS ADMIN",DUZ)) D  Q
"RTN","PSNPPSDL",15,0)
 . W !!,"You do not have the appropriate security key to use this option"
"RTN","PSNPPSDL",16,0)
 . W !,"please contact your ADPAC to resolve this issue.",!
"RTN","PSNPPSDL",17,0)
 . S DIR(0)="E",DIR("A")=" Press ENTER to Continue"
"RTN","PSNPPSDL",18,0)
 . D ^DIR
"RTN","PSNPPSDL",19,0)
 ;
"RTN","PSNPPSDL",20,0)
 S PSNLEGF="",PSNLEGF=$$LEGACY() I PSNLEGF Q
"RTN","PSNPPSDL",21,0)
 D CHKD ;update Unix directory if needed and create it if entry does not exist.
"RTN","PSNPPSDL",22,0)
 ;
"RTN","PSNPPSDL",23,0)
 W !!!,"Warning: This download should only be done during off peak hours!"
"RTN","PSNPPSDL",24,0)
 ;
"RTN","PSNPPSDL",25,0)
 N DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSDL",26,0)
 W ! S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSDL",27,0)
 S DIR("A")="Are you sure you want to immediately start an NDF update download"
"RTN","PSNPPSDL",28,0)
 S DIR("B")="NO" D ^DIR I 'Y Q
"RTN","PSNPPSDL",29,0)
 W !,"Please stand-by NDF update download may take up to 30 minutes...",!
"RTN","PSNPPSDL",30,0)
 ;
"RTN","PSNPPSDL",31,0)
RUNIT ; Entry point for tasked menu option "PSN TASK SCHEDULED DOWNLOAD"
"RTN","PSNPPSDL",32,0)
 N PSNSCJOB S PSNSCJOB=1 D EN^PSNFTP
"RTN","PSNPPSDL",33,0)
 Q
"RTN","PSNPPSDL",34,0)
 ;
"RTN","PSNPPSDL",35,0)
SCHDOPT ; Entry point for menu option "PSN TASK SCHEDULE DOWNLOAD" to create and/or edit the scheduling date/time
"RTN","PSNPPSDL",36,0)
 N DIRUT,DUOUT,DIR,X,Y,PSSTART,PSFREQ,PSERROR,PSNLEGF
"RTN","PSNPPSDL",37,0)
 I '$D(^XUSEC("PSN PPS ADMIN",DUZ)) D  Q
"RTN","PSNPPSDL",38,0)
 . W !!,"You do not have the appropriate security key to use this option"
"RTN","PSNPPSDL",39,0)
 . W !,"please contact your ADPAC to resolve this issue.",!
"RTN","PSNPPSDL",40,0)
 . S DIR(0)="E",DIR("A")=" Press ENTER to Continue"
"RTN","PSNPPSDL",41,0)
 . D ^DIR
"RTN","PSNPPSDL",42,0)
 ;
"RTN","PSNPPSDL",43,0)
 S PSNLEGF="",PSNLEGF=$$LEGACY() I PSNLEGF Q
"RTN","PSNPPSDL",44,0)
 D CHKD ;update Unix directory if needed and create it if entry does not exist.
"RTN","PSNPPSDL",45,0)
 ;
"RTN","PSNPPSDL",46,0)
 W !!!,"This option allows you to schedule a recurring TasKMan job to"
"RTN","PSNPPSDL",47,0)
 W !,"perform the NDF update file download from PPS-N."
"RTN","PSNPPSDL",48,0)
 W !!,"Warning! This download should be scheduled during non-peak hours."
"RTN","PSNPPSDL",49,0)
 W !!,"You will need to select a date/time and how often this download should reoccur."
"RTN","PSNPPSDL",50,0)
 ;
"RTN","PSNPPSDL",51,0)
 N DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSDL",52,0)
 ;W !!
"RTN","PSNPPSDL",53,0)
 D SCHCK("PSN TASK SCHEDULED DOWNLOAD","D") ;print scheduled tasks
"RTN","PSNPPSDL",54,0)
 ;
"RTN","PSNPPSDL",55,0)
 S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSDL",56,0)
 S DIR("A")="Do you want to schedule an automatic NDF download in TaskMan",DIR("B")="NO"
"RTN","PSNPPSDL",57,0)
 D ^DIR I 'Y Q
"RTN","PSNPPSDL",58,0)
 ;
"RTN","PSNPPSDL",59,0)
 N %DT,Y
"RTN","PSNPPSDL",60,0)
 D NOW^%DTC
"RTN","PSNPPSDL",61,0)
 S %DT(0)=%,%DT="EFATX",%DT("A")="Enter date/time: " D ^%DT
"RTN","PSNPPSDL",62,0)
 S PSSTART=$$FMADD^XLFDT(Y,0,0,5)
"RTN","PSNPPSDL",63,0)
 ;
"RTN","PSNPPSDL",64,0)
 N DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSDL",65,0)
 W !!
"RTN","PSNPPSDL",66,0)
 S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSDL",67,0)
 S DIR("A")="Should this download be re-scheduled at the same time weekly"
"RTN","PSNPPSDL",68,0)
 S DIR("B")="NO" D ^DIR I Y S PSFREQ="7D" G END
"RTN","PSNPPSDL",69,0)
 ;
"RTN","PSNPPSDL",70,0)
 N DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSDL",71,0)
 W !!
"RTN","PSNPPSDL",72,0)
 S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSDL",73,0)
 S DIR("A")="Should this download be re-scheduled at the same time daily"
"RTN","PSNPPSDL",74,0)
 S DIR("B")="NO" D ^DIR
"RTN","PSNPPSDL",75,0)
 I Y S PSFREQ="1D" G END
"RTN","PSNPPSDL",76,0)
 I 'Y D
"RTN","PSNPPSDL",77,0)
 . W !!,"Warning! The download you have scheduled will occur only once."
"RTN","PSNPPSDL",78,0)
 . S PSFREQ=""
"RTN","PSNPPSDL",79,0)
 ;
"RTN","PSNPPSDL",80,0)
END ;
"RTN","PSNPPSDL",81,0)
 N DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSDL",82,0)
 W !,"Your start time is:"
"RTN","PSNPPSDL",83,0)
 D RESCH^XUTMOPT("PSN TASK SCHEDULED DOWNLOAD",PSSTART,"",PSFREQ,"L",.PSERROR)
"RTN","PSNPPSDL",84,0)
 I +PSFREQ=1 W !!,"The download will automatically be re-scheduled Daily",!
"RTN","PSNPPSDL",85,0)
 I +PSFREQ=7 W !!,"The download will automatically be re-scheduled Weekly",!
"RTN","PSNPPSDL",86,0)
 I PSFREQ="" W !!,"The download will NOT automatically be re-scheduled",!
"RTN","PSNPPSDL",87,0)
 S DIR(0)="E",DIR("A")=" Press ENTER to Continue"
"RTN","PSNPPSDL",88,0)
 D ^DIR
"RTN","PSNPPSDL",89,0)
 Q
"RTN","PSNPPSDL",90,0)
 ;
"RTN","PSNPPSDL",91,0)
SCHCK(OPTION,TYPE) ; check PPS-N scheduled Download or Install tasks
"RTN","PSNPPSDL",92,0)
 ;  input - OPTION as name of option
"RTN","PSNPPSDL",93,0)
 ;          TYPE as task type (D-Download/I-Install)
"RTN","PSNPPSDL",94,0)
 ;  output - print future queued tasked (external format)
"RTN","PSNPPSDL",95,0)
 ;
"RTN","PSNPPSDL",96,0)
 N I,II,PSIEN,XX,NODE,NODE1,PSNROOT
"RTN","PSNPPSDL",97,0)
 ; check to see if the option is defined in option scheduler file and it is tasked.
"RTN","PSNPPSDL",98,0)
 D OPTSTAT^XUTMOPT(OPTION,.PSNROOT) I '+$G(PSNROOT(1)) Q
"RTN","PSNPPSDL",99,0)
 S (I,II)=0
"RTN","PSNPPSDL",100,0)
 F  S I=$O(PSNROOT(I)) Q:'I  S II=II+1 D
"RTN","PSNPPSDL",101,0)
 .I II=1 W !!!,"Scheduled "_$S(TYPE="D":"Downloads",TYPE="I":"Installs",1:"")_" are:",!,"-----------------------"
"RTN","PSNPPSDL",102,0)
 .W !,$P(PSNROOT(I),"^")_"  "_$$DATE($P(PSNROOT(I),"^",2),1),"  ",$P(PSNROOT(I),"^",3),!
"RTN","PSNPPSDL",103,0)
 I II=0 W !,"*** Currently NO scheduled "_$S(TYPE="D":"Downloads",TYPE="I":"Installs",1:"")," tasks.",!
"RTN","PSNPPSDL",104,0)
 Q
"RTN","PSNPPSDL",105,0)
 ;
"RTN","PSNPPSDL",106,0)
DATE(NODE,PIECE) ; return appropriate date
"RTN","PSNPPSDL",107,0)
 ;  input - NODE as node of data
"RTN","PSNPPSDL",108,0)
 ;          PIECE as piece of node to convert
"RTN","PSNPPSDL",109,0)
 ; output - date in external format
"RTN","PSNPPSDL",110,0)
 ;
"RTN","PSNPPSDL",111,0)
 Q $$UP^XLFSTR($$FMTE^XLFDT($P(NODE,"^",PIECE)))
"RTN","PSNPPSDL",112,0)
 ;
"RTN","PSNPPSDL",113,0)
LEGACY() ;check legacy update file processing parameter
"RTN","PSNPPSDL",114,0)
 N PSNLEG,PSNF,PSENTER
"RTN","PSNPPSDL",115,0)
 S (PSNF,PSNLEG)="",PSNLEG=$$GET1^DIQ(57.23,1,45)   ;legacy update
"RTN","PSNPPSDL",116,0)
 I PSNLEG="YES" S PSNF=1 D
"RTN","PSNPPSDL",117,0)
 .W !!,"This option may not be utilized because the Legacy Update Processing"
"RTN","PSNPPSDL",118,0)
 .W !,"site parameter is defined as YES.  You may only install FORUM NDF patch updates.",!
"RTN","PSNPPSDL",119,0)
 .R !!,"Press enter to continue...",PSENTER:120
"RTN","PSNPPSDL",120,0)
 Q PSNF
"RTN","PSNPPSDL",121,0)
 ;
"RTN","PSNPPSDL",122,0)
CHKD ; check Unix dir and update it if contains control char and other special characters
"RTN","PSNPPSDL",123,0)
 I $$OS^%ZOSV()'="UNIX" Q
"RTN","PSNPPSDL",124,0)
 N UNXLD,UNXLD1 S (UNXLD,UNXLD1)=""
"RTN","PSNPPSDL",125,0)
 D UPDT
"RTN","PSNPPSDL",126,0)
 S UNXLD=$$GETD^PSNFTP()
"RTN","PSNPPSDL",127,0)
 I '$$DIREXIST^PSNFTP2(UNXLD) D MAKEDIR^PSNFTP2(UNXLD)
"RTN","PSNPPSDL",128,0)
 Q
"RTN","PSNPPSDL",129,0)
 ;
"RTN","PSNPPSDL",130,0)
UPDT ; update unix/linux directory, called by PSNPPSDL 
"RTN","PSNPPSDL",131,0)
 N DA,DIE,DR
"RTN","PSNPPSDL",132,0)
 S UNXLD=$P($G(^PS(57.23,1,0)),"^",4) I UNXLD]"" D
"RTN","PSNPPSDL",133,0)
 .S UNXLD1=$$STRIP^PSNPARM(UNXLD) I UNXLD]"",(UNXLD'=UNXLD1) S DIE="^PS(57.23,",DA=1,DR="3////"_UNXLD D ^DIE K DIE,DA,DR
"RTN","PSNPPSDL",134,0)
 Q
"RTN","PSNPPSDL",135,0)
 ;
"RTN","PSNPPSI1")
0^1^B5027313^n/a
"RTN","PSNPPSI1",1,0)
PSNPPSI1 ;HP/MJE-PPSN update NDF data for parsing DATANT records ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSI1",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNPPSI1",3,0)
 ;
"RTN","PSNPPSI1",4,0)
 Q
"RTN","PSNPPSI1",5,0)
 ;
"RTN","PSNPPSI1",6,0)
 ;This routine parses DATANT records which add .01 fields to files and sub-files
"RTN","PSNPPSI1",7,0)
DATANT ;
"RTN","PSNPPSI1",8,0)
 K FDA
"RTN","PSNPPSI1",9,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",6)="DATANT"
"RTN","PSNPPSI1",10,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSI1",11,0)
 K FDA
"RTN","PSNPPSI1",12,0)
 D CTRLFILE^PSNPPSMS(0)
"RTN","PSNPPSI1",13,0)
 D CTRLSS^PSNPPSMS(0)
"RTN","PSNPPSI1",14,0)
 D CTRLIEN^PSNPPSMS(0)
"RTN","PSNPPSI1",15,0)
 S FILE=0,GROOT=$NA(^TMP("PSN PPSN PARSED",$J,"DATANT")),PSNTMPN="DATANT"
"RTN","PSNPPSI1",16,0)
 F  S FILE=$O(@GROOT@(FILE)) Q:'FILE  D CTRLFILE^PSNPPSMS(FILE) S ROOT=$$ROOT^DILFD(FILE) I ROOT]"" S GROOT1=$NA(@GROOT@(FILE)) F JJ=1:2 Q:'$D(@GROOT1@(JJ))  D
"RTN","PSNPPSI1",17,0)
 .S (DIA,NEW)=""
"RTN","PSNPPSI1",18,0)
 .S DIA=@GROOT1@(JJ) I $G(@GROOT1@(JJ+1))]"" S NEW=@GROOT1@(JJ+1)
"RTN","PSNPPSI1",19,0)
 .D CTRLSS^PSNPPSMS($TR(GROOT1,"^")_","_JJ)
"RTN","PSNPPSI1",20,0)
 .S DA=+DIA K FDA,IENS
"RTN","PSNPPSI1",21,0)
 .I FILE=50.68 S ^TMP("PSN PPSN PARSED",$J,"AE_PRODUCTS",DA)="" S:$P(DIA,"^",3)=.01 ^TMP("PSN PPSN PARSED",$J,"NEW PRODUCTS",DA)=""
"RTN","PSNPPSI1",22,0)
 .;
"RTN","PSNPPSI1",23,0)
 .I PSNPS="N",FILE=50.416 D INGRED^PSNPPSNK
"RTN","PSNPPSI1",24,0)
 .I PSNPS="N",FILE=56 D
"RTN","PSNPPSI1",25,0)
 ..K STAT
"RTN","PSNPPSI1",26,0)
 ..S STAT="A"
"RTN","PSNPPSI1",27,0)
 ..I $D(^PS(56,DA)) S STAT="E" S:$$GET1^DIQ(56,DA,7)'="" STAT="I"
"RTN","PSNPPSI1",28,0)
 ..S ^TMP("PSN PPSN PARSED",$J,"POST_RUN",5000.56,FILE,DA,.01)=STAT
"RTN","PSNPPSI1",29,0)
 .;
"RTN","PSNPPSI1",30,0)
 .I PSNPS="N",FILE=50.68 D
"RTN","PSNPPSI1",31,0)
 ..D NDFK^PSNPPSNK
"RTN","PSNPPSI1",32,0)
 ..K FDA,ORD,ERROR
"RTN","PSNPPSI1",33,0)
 ..S ORD=""
"RTN","PSNPPSI1",34,0)
 ..I $D(^PSNDF(50.68,DA)) S ORD=$$GET1^DIQ(FILE,DA_",",31,"I","ERROR")
"RTN","PSNPPSI1",35,0)
 ..S ^TMP("PSN PPSN PARSED",$J,"POST_RUN",5000.608,FILE,DA,.01)=ORD
"RTN","PSNPPSI1",36,0)
 .;
"RTN","PSNPPSI1",37,0)
 .I $$GET1^DIQ(FILE,DA,.01)]"" S FDA(FILE,DA_",",.01)=NEW D FILE^DIE("","FDA"),CTRLIEN^PSNPPSMS(DA) Q
"RTN","PSNPPSI1",38,0)
 .S DINUM=DA,X=NEW,DIC=ROOT,DIC(0)="L",DIC("DR")="S Y=0" K DD,DO D FILE^DICN
"RTN","PSNPPSI1",39,0)
 ;
"RTN","PSNPPSI1",40,0)
 D DATAN^PSNPPSI2
"RTN","PSNPPSI1",41,0)
 Q
"RTN","PSNPPSI2")
0^2^B117398131^n/a
"RTN","PSNPPSI2",1,0)
PSNPPSI2 ;HP/MJE-PPSN update NDF data for parsing DATAN records ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSI2",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNPPSI2",3,0)
 ;Reference to ^DD supported by DBIA #1258
"RTN","PSNPPSI2",4,0)
 ;
"RTN","PSNPPSI2",5,0)
 Q
"RTN","PSNPPSI2",6,0)
 ;
"RTN","PSNPPSI2",7,0)
 ;This routine parses DATAN records which are new entries other than .01 fields to the NDF files
"RTN","PSNPPSI2",8,0)
DATAN ;
"RTN","PSNPPSI2",9,0)
 K FDA,^TMP("PSN OLDINGRED",$J),^TMP("PSN ADDINGRED",$J),^TMP("PSN DELINGRED",$J)
"RTN","PSNPPSI2",10,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",6)="DATAN",PSNTMPN="DATAN"
"RTN","PSNPPSI2",11,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSI2",12,0)
 K FDA,SROOT
"RTN","PSNPPSI2",13,0)
 N OFLDS,OIENS,OLDNDF,MIENS,MFLDS,JJJJ,PSNVAPD,OINGRED,XFILE,XFLDS,PSNINGRED
"RTN","PSNPPSI2",14,0)
 D CTRLFILE^PSNPPSMS(0)
"RTN","PSNPPSI2",15,0)
 D CTRLSS^PSNPPSMS(0)
"RTN","PSNPPSI2",16,0)
 D CTRLIEN^PSNPPSMS(0)
"RTN","PSNPPSI2",17,0)
 S FILE=0,GROOT=$NA(^TMP("PSN PPSN PARSED",$J,"DATAN"))
"RTN","PSNPPSI2",18,0)
 ;load new multiple entries next
"RTN","PSNPPSI2",19,0)
 F  S FILE=$O(@GROOT@(FILE)) Q:'FILE  D CTRLFILE^PSNPPSMS(FILE) S ROOT=$$ROOT^DILFD(FILE) I ROOT]"" S GROOT1=$NA(@GROOT@(FILE)) F JJ=1:2 Q:'$D(@GROOT1@(JJ))  D
"RTN","PSNPPSI2",20,0)
 .S (DIA,NEW)=""
"RTN","PSNPPSI2",21,0)
 .S DIA=@GROOT1@(JJ) I $G(@GROOT1@(JJ+1))]"" S NEW=@GROOT1@(JJ+1)
"RTN","PSNPPSI2",22,0)
 .I FILE=50.68 S ^TMP("PSN PPSN PARSED",$J,"AE_PRODUCTS",+DIA)="" S:$P(DIA,"^",3)=.01 ^TMP("PSN PPSN PARSED",$J,"NEW PRODUCTS",+DIA)=""
"RTN","PSNPPSI2",23,0)
 .D CTRLSS^PSNPPSMS($TR(GROOT1,"^")_","_JJ)
"RTN","PSNPPSI2",24,0)
 .I $G(PSNMULTI) D
"RTN","PSNPPSI2",25,0)
 ..S (MIENS,MFLDS)="",MIENS=$P(DIA,"^")_",",MFLDS=$P(DIA,"^",3)
"RTN","PSNPPSI2",26,0)
 ..I MFLDS'=""&($P(NEW,"^")'=MIENS) S PSNMULTI=0,^TMP("PSN PPSN.WPXRF",$J,FILE,OIENS,OFLDS)=""
"RTN","PSNPPSI2",27,0)
 .S IENS=$P(DIA,"^")_",",FLDS=$P(DIA,"^",3),ROOT=FILE K FDA,IEN
"RTN","PSNPPSI2",28,0)
 .I FILE=50.68,($P(DIA,"^",3)="14,.01") D  Q:NEW["DELETE"
"RTN","PSNPPSI2",29,0)
 ..I '$D(^TMP("PSN OLDINGRED",$J,$P($P(DIA,"^"),","))) S OINGRED=0 F  S OINGRED=$O(^PSNDF(50.68,$P($P(DIA,"^"),","),2,OINGRED)) Q:OINGRED=""  S ^TMP("PSN OLDINGRED",$J,$P($P(DIA,"^"),","),OINGRED)=""
"RTN","PSNPPSI2",30,0)
 ..D:'$D(^TMP("PSNINGRED",$J,$P($P(DIA,"^"),","))) AIDEL($P($P(DIA,"^"),",")) S ^TMP("PSNINGRED",$J,$P($P(DIA,"^"),","))=""
"RTN","PSNPPSI2",31,0)
 .I PSNPS="N",FILE=50.68 D NDFK^PSNPPSNK D
"RTN","PSNPPSI2",32,0)
 ..I $P(DIA,"^",3)=31 D
"RTN","PSNPPSI2",33,0)
 ...K ORD
"RTN","PSNPPSI2",34,0)
 ...S ORD=NEW
"RTN","PSNPPSI2",35,0)
 ...S ^TMP("PSN PPSN PARSED",$J,"POST_RUN",5000.608,FILE,IENS,FLDS)=ORD
"RTN","PSNPPSI2",36,0)
 .I FILE=50.68 D UNMATCH
"RTN","PSNPPSI2",37,0)
 .;
"RTN","PSNPPSI2",38,0)
 .I PSNPS="N" D
"RTN","PSNPPSI2",39,0)
 ..;I FILE=50.416 D INGRED^PSNPPSNK
"RTN","PSNPPSI2",40,0)
 ..I FILE=56 D 56^PSNPPSMS(FILE,DIA,NEW,PSNTMPN)
"RTN","PSNPPSI2",41,0)
 .;
"RTN","PSNPPSI2",42,0)
 .K RES1,RES2,RES3
"RTN","PSNPPSI2",43,0)
 .I '$G(PSNMULTI) D FIELD^DID(FILE,FLDS,"","TYPE","RES1") ;I $G(RES1("TYPE"))'="WORD-PROCESSING" S PSNMULTI=0
"RTN","PSNPPSI2",44,0)
 .I $G(RES1("TYPE"))="WORD-PROCESSING"!$G(PSNMULTI) D  Q
"RTN","PSNPPSI2",45,0)
 ..I '$G(PSNMULTI) D
"RTN","PSNPPSI2",46,0)
 ...S MJJ=JJ,OIENS=IENS,OFLDS=FLDS
"RTN","PSNPPSI2",47,0)
 ...I $D(^TMP("PSN PPSN.WPXRF",$J,FILE,IENS,FLDS)) K ^TMP("PSN PPSN.WP",$J,FILE,OIENS,OFLDS),^TMP("PSN PPSN.WPXRF",$J,FILE,IENS,FLDS)
"RTN","PSNPPSI2",48,0)
 ...;Set 5000 file for word processing fields
"RTN","PSNPPSI2",49,0)
 ...S PSNWP=$$GET1^DID(FILE,"","","GLOBAL NAME")_$P(DIA,"^")_","  ;"PSNDF(FILE,"_IENS_",1)"
"RTN","PSNPPSI2",50,0)
 ...D FIELD^DID(FILE,FLDS,"Z","GLOBAL SUBSCRIPT LOCATION","RES2")
"RTN","PSNPPSI2",51,0)
 ...S RES3="",RES3=$P(RES2("GLOBAL SUBSCRIPT LOCATION"),";")
"RTN","PSNPPSI2",52,0)
 ...S PSNWP=PSNWP_$S(RES3?1AN.AN:""""_RES3_"""",1:RES3)_")"
"RTN","PSNPPSI2",53,0)
 ...I PSNPS="N",'$D(^NDFK(5000,1,4,"B",PSNWP)) S X=$O(^NDFK(5000,1,4," "),-1)+1,^(X,0)=PSNWP,^NDFK(5000,1,4,"B",PSNWP,X)=""
"RTN","PSNPPSI2",54,0)
 ..;
"RTN","PSNPPSI2",55,0)
 ..I '$P(DIA,"^",3) S ^TMP("PSN PPSN.WP",$J,FILE,OIENS,OFLDS,MJJ)=$$STRIP^PSNPPSNU(DIA),MJJ=MJJ+1
"RTN","PSNPPSI2",56,0)
 ..I '$P(NEW,"^",3) S ^TMP("PSN PPSN.WP",$J,FILE,OIENS,OFLDS,MJJ)=$$STRIP^PSNPPSNU(NEW),PSNMULTI=1,MJJ=MJJ+1
"RTN","PSNPPSI2",57,0)
 ..I $P(NEW,"^",3)'="" S JJ=JJ-1
"RTN","PSNPPSI2",58,0)
 .;
"RTN","PSNPPSI2",59,0)
 .;get multiple info
"RTN","PSNPPSI2",60,0)
 .I FLDS["," D
"RTN","PSNPPSI2",61,0)
 ..I FILE=50.68,$P($P(DIA,"^",3),",")=43 D MULTIPLE Q
"RTN","PSNPPSI2",62,0)
 ..;it should, but
"RTN","PSNPPSI2",63,0)
 ..S LI=$P(DIA,"^",3) F J=1:1:$L(LI,",")-1 S ROOT=+$P(^DD(ROOT,+$P(LI,",",J),0),"^",2)
"RTN","PSNPPSI2",64,0)
 ..S LI=$P(DIA,"^"),IENS="" F J=$L(LI,","):-1:1 S IENS=IENS_$P(LI,",",J)_",",^TMP("PSN PPSN PARSED",$J,"AE_PRODUCTS",$P(LI,",",J))=""
"RTN","PSNPPSI2",65,0)
 ..S XFLDS=$P(FLDS,",",$L(FLDS,",")-1) I $G(XFLDS)'="" S XFILE=+$P(^DD(FILE,XFLDS,0),"^",2) S:$G(XFILE)="" XFILE=FILE
"RTN","PSNPPSI2",66,0)
 ..S FLDS=$P(FLDS,",",$L(FLDS,","))
"RTN","PSNPPSI2",67,0)
 .S DA=+IENS
"RTN","PSNPPSI2",68,0)
 .D CTRLIEN^PSNPPSMS(IENS)
"RTN","PSNPPSI2",69,0)
 .;
"RTN","PSNPPSI2",70,0)
 .I FILE=50.68,$P($P(DIA,"^",3),",")=43 Q
"RTN","PSNPPSI2",71,0)
 .;
"RTN","PSNPPSI2",72,0)
 .;delete copay tiers if needed
"RTN","PSNPPSI2",73,0)
 .I ROOT=50.6845&($P($P(DIA,"^"),",",2)=1&($P(DIA,"^",3)="45,.01")) D CPTIERD($P(IENS,",",2)) Q:NEW="DELETED"
"RTN","PSNPPSI2",74,0)
 .;
"RTN","PSNPPSI2",75,0)
 .I ROOT=50.6068&($P($P(DIA,"^"),",",2)=1&($P(DIA,"^",3)="8,.01")) D DOSFORUD($P(IENS,",",2)) Q:NEW="DELETED"   ;dosage form units #50.606
"RTN","PSNPPSI2",76,0)
 .I ROOT=50.6069&($P($P(DIA,"^"),",",2)=1&($P(DIA,"^",3)="9,.01")) D DOSFORDD($P(IENS,",",2)) Q:NEW="DELETED"   ;dispense units per dose #50.606
"RTN","PSNPPSI2",77,0)
 .;
"RTN","PSNPPSI2",78,0)
 .I $P(DIA,"^",3)="99.991,.01" D  K FDA Q
"RTN","PSNPPSI2",79,0)
 ..K FDA,ERROR
"RTN","PSNPPSI2",80,0)
 ..S FDA(ROOT,"+"_IENS,FLDS)=NEW D UPDATE^DIE("","FDA","","ERROR") D ERROR^PSNPPSNU:$D(ERROR("DIERR")) K FDA
"RTN","PSNPPSI2",81,0)
 .;
"RTN","PSNPPSI2",82,0)
 .;edit single field
"RTN","PSNPPSI2",83,0)
 .I $$GET1^DIQ(ROOT,IENS,FLDS)]"" S FDA(ROOT,IENS,.01)=NEW,IEN(DA)=DA D  Q
"RTN","PSNPPSI2",84,0)
 ..D UPDATE^DIE("","FDA","IEN","") K FDA D CTRLIEN^PSNPPSMS(IENS)
"RTN","PSNPPSI2",85,0)
 .;
"RTN","PSNPPSI2",86,0)
 .;set new multiple field
"RTN","PSNPPSI2",87,0)
 .I $P(DIA,"^",3)["," D  Q
"RTN","PSNPPSI2",88,0)
 ..K DIC,FDA
"RTN","PSNPPSI2",89,0)
 ..;I ROOT'[50.6843 S DA(1)=$P($P(DIA,"^"),",")
"RTN","PSNPPSI2",90,0)
 ..S DA(1)=$P($P(DIA,"^"),","),DIC=$$ROOT^DILFD(ROOT,IENS,,1)
"RTN","PSNPPSI2",91,0)
 ..S X=NEW,DIC(0)="L",DIC("DR")="S Y=0"
"RTN","PSNPPSI2",92,0)
 ..I ROOT[50.6068!(ROOT[50.6069) S (DA,DINUM)=$P($P(DIA,"^"),",",2)  ;this is in here until PPS-N fixes the IENS
"RTN","PSNPPSI2",93,0)
 ..I ROOT[50.6845!(ROOT[50.6814) S DA=$P($P(DIA,"^"),",",2)
"RTN","PSNPPSI2",94,0)
 ..I ROOT["50.68"&($P(DIA,"^",3)="14,.01"!($P(DIA,"^",3)="16,.01")!($P(DIA,"^",3)="45,.01")) S DINUM=DA
"RTN","PSNPPSI2",95,0)
 ..K DD,DO D FILE^DICN I 'Y D ERROR2^PSNPPSNU(PSNTMPN,ROOT,IENS,DA,"Error setting new multiple entry")
"RTN","PSNPPSI2",96,0)
 ..I ROOT[50.6845,(PSNATYP="N") D CPTIER^PSNPPSNK(DIA)
"RTN","PSNPPSI2",97,0)
 .;
"RTN","PSNPPSI2",98,0)
 .I $P(DIA,"^",3)="99.991,.02" D  K FDA,ERROR Q
"RTN","PSNPPSI2",99,0)
 ..S DA=999999999999 S DA=$O(^PS(FILE,+$P(DIA,"^"),"TERMSTATUS",DA),-1)
"RTN","PSNPPSI2",100,0)
 ..I FILE=50.6!(FILE=50.68) S DA=999999999999 S DA=$O(^PSNDF(FILE,+$P(DIA,"^"),"TERMSTATUS",DA),-1)
"RTN","PSNPPSI2",101,0)
 ..S $P(IENS,",",1)=DA,FDA(ROOT,IENS,.02)=NEW D UPDATE^DIE("","FDA","IEN","ERROR") D ERROR^PSNPPSNU:$D(ERROR("DIERR")) K FDA
"RTN","PSNPPSI2",102,0)
 .;
"RTN","PSNPPSI2",103,0)
 .;set new single field
"RTN","PSNPPSI2",104,0)
 .K DIC,FDA
"RTN","PSNPPSI2",105,0)
 .S DINUM=DA,X=NEW,DIC=ROOT,DIC(0)="L",DIC("DR")="S Y=0" K DD,DO D FILE^DICN I 'Y D ERROR2^PSNPPSNU(PSNTMPN,ROOT,IENS,DA,"Error new single field")
"RTN","PSNPPSI2",106,0)
 .D CTRLIEN^PSNPPSMS(IENS)
"RTN","PSNPPSI2",107,0)
 ;
"RTN","PSNPPSI2",108,0)
DATAN2 ;word processing fields
"RTN","PSNPPSI2",109,0)
 S ERROR=0
"RTN","PSNPPSI2",110,0)
 S JJ=0 F  S JJ=$O(^TMP("PSNN",$J,JJ)) Q:'JJ  S DA=$P(JJ,",",2),DA(1)=+JJ D
"RTN","PSNPPSI2",111,0)
 . I '$D(^PSNDF(50.68,DA(1),0)) D ERROR2^PSNPPSNU(PSNTMPN,ROOT,IENS,DA(1),"VA PRODUCT entry does not exist.") Q
"RTN","PSNPPSI2",112,0)
 . D ING^PSNXREF
"RTN","PSNPPSI2",113,0)
 .;50.68 ADDED INGREDIENT 5000.508
"RTN","PSNPPSI2",114,0)
 ;S ^TMP("PSN OLDINGRED",$J,PSNVAPD,CNT1)=""
"RTN","PSNPPSI2",115,0)
 I PSNPS="N" S (PSNINGRED,PSNVAPD)="" D
"RTN","PSNPPSI2",116,0)
 .;if ingredient remains on the product, then it wasn't deleted
"RTN","PSNPPSI2",117,0)
 .F  S PSNVAPD=$O(^TMP("PSN OLDINGRED",$J,PSNVAPD)) Q:PSNVAPD=""  F  S PSNINGRED=$O(^TMP("PSN OLDINGRED",$J,PSNVAPD,PSNINGRED)) Q:PSNINGRED=""  D
"RTN","PSNPPSI2",118,0)
 ..I '$D(^PSNDF(50.68,PSNVAPD,2,PSNINGRED,0)) S ^TMP("PSN DELINGRED",$J,PSNINGRED)=""
"RTN","PSNPPSI2",119,0)
 .;if the ingredient was not one of the old ingredients then it was added
"RTN","PSNPPSI2",120,0)
 .F  S PSNVAPD=$O(^TMP("PSN OLDINGRED",$J,PSNVAPD)) Q:PSNVAPD=""  S PSNINGRED=0 F  S PSNINGRED=$O(^PSNDF(50.68,PSNVAPD,2,PSNINGRED)) Q:PSNINGRED=""  D
"RTN","PSNPPSI2",121,0)
 ..I '$D(^TMP("PSN OLDINGRED",$J,PSNVAPD,PSNINGRED)) S ^TMP("PSN ADDINGRED",$J,PSNINGRED)=""
"RTN","PSNPPSI2",122,0)
 .;I PSNPS="N" S X=+$P(DIA,"^") I '$D(^NDFK(5000.508,"B",X)) S DIC=5000.508,DIC(0)="LMXZ" D FILE^DICN
"RTN","PSNPPSI2",123,0)
 ;
"RTN","PSNPPSI2",124,0)
 S FILE="" F  S FILE=$O(^TMP("PSN PPSN.WP",$J,FILE)) Q:FILE=""  D
"RTN","PSNPPSI2",125,0)
 . S IENS="" F  S IENS=$O(^TMP("PSN PPSN.WP",$J,FILE,IENS)) Q:IENS=""  D
"RTN","PSNPPSI2",126,0)
 .. S FLDS="" F  S FLDS=$O(^TMP("PSN PPSN.WP",$J,FILE,IENS,FLDS)) Q:FLDS=""  D
"RTN","PSNPPSI2",127,0)
 ... K TMP,ERR
"RTN","PSNPPSI2",128,0)
 ... S JJ=0 F  S JJ=$O(^TMP("PSN PPSN.WP",$J,FILE,IENS,FLDS,JJ)) Q:'JJ  D
"RTN","PSNPPSI2",129,0)
 .... S TMP(JJ)=^TMP("PSN PPSN.WP",$J,FILE,IENS,FLDS,JJ)
"RTN","PSNPPSI2",130,0)
 ... D WP^DIE(FILE,IENS,FLDS,"","TMP","ERR")
"RTN","PSNPPSI2",131,0)
 K ^TMP("PSN PPSN.WP",$J)
"RTN","PSNPPSI2",132,0)
 ;
"RTN","PSNPPSI2",133,0)
 D DATAO^PSNPPSI3
"RTN","PSNPPSI2",134,0)
 Q
"RTN","PSNPPSI2",135,0)
 ;
"RTN","PSNPPSI2",136,0)
CPTIERD(PSNVAPN) ;copay tiers deleted
"RTN","PSNPPSI2",137,0)
 N COPAYACT
"RTN","PSNPPSI2",138,0)
 S CNT=0 F  S CNT=$O(^PSNDF(50.68,PSNVAPN,10,CNT)) Q:CNT=""  D
"RTN","PSNPPSI2",139,0)
 . S DIK="^PSNDF(50.68,"_PSNVAPN_",10,",DA=CNT,DA(1)=PSNVAPN
"RTN","PSNPPSI2",140,0)
 . D ^DIK
"RTN","PSNPPSI2",141,0)
 S COPAYACT=0
"RTN","PSNPPSI2",142,0)
 I PSNATYP="N" D COPNDFK
"RTN","PSNPPSI2",143,0)
 Q
"RTN","PSNPPSI2",144,0)
 ;
"RTN","PSNPPSI2",145,0)
COPNDFK ; define NDFK file 5000.93
"RTN","PSNPPSI2",146,0)
 N X,DIC,DIE,DR,NDFKSEQ,PRIEN,NAME S NDFKSEQ="",PRIEN=PSNVAPN
"RTN","PSNPPSI2",147,0)
 I '$D(^NDFK(5000.93,0)) S ^NDFK(5000.93,0)="COPAY TIERS SETTINGS CHANGES^5000.93P^0^0"
"RTN","PSNPPSI2",148,0)
 S NAME=$$GET1^DIQ(50.68,PRIEN,.01,"E")
"RTN","PSNPPSI2",149,0)
 S X=NAME,DIC=5000.93,DIC(0)="LMXZ" D ^DIC
"RTN","PSNPPSI2",150,0)
 S DIE=DIC,DA=+Y K DIC
"RTN","PSNPPSI2",151,0)
 S DR=".01///^S X=PRIEN;1///^S X="_COPAYACT  ;Copay action - 0 = delete or 1 = add/edit
"RTN","PSNPPSI2",152,0)
 D ^DIE
"RTN","PSNPPSI2",153,0)
 Q
"RTN","PSNPPSI2",154,0)
 ;
"RTN","PSNPPSI2",155,0)
DOSFORUD(PSNVAPN) ;dosage forms units deleted
"RTN","PSNPPSI2",156,0)
 N DOSFORU
"RTN","PSNPPSI2",157,0)
 S CNT=0 F  S CNT=$O(^PS(50.606,PSNVAPN,"UNIT",CNT)) Q:CNT=""  D
"RTN","PSNPPSI2",158,0)
 . S DIK="^PS(50.606,"_PSNVAPN_","_"""UNIT"""_",",DA=CNT,DA(1)=PSNVAPN
"RTN","PSNPPSI2",159,0)
 . D ^DIK
"RTN","PSNPPSI2",160,0)
 S DOSFORU=0
"RTN","PSNPPSI2",161,0)
 Q
"RTN","PSNPPSI2",162,0)
 ;
"RTN","PSNPPSI2",163,0)
DOSFORDD(PSNVAPN) ;dispense units per dose deleted
"RTN","PSNPPSI2",164,0)
 N DOSFORU
"RTN","PSNPPSI2",165,0)
 S CNT=0 F  S CNT=$O(^PS(50.606,PSNVAPN,"DUPD",CNT)) Q:CNT=""  D
"RTN","PSNPPSI2",166,0)
 . S DIK="^PS(50.606,"_PSNVAPN_","_"""DUPD"""_",",DA=CNT,DA(1)=PSNVAPN
"RTN","PSNPPSI2",167,0)
 . D ^DIK
"RTN","PSNPPSI2",168,0)
 S DOSFORU=0
"RTN","PSNPPSI2",169,0)
 Q
"RTN","PSNPPSI2",170,0)
 ;
"RTN","PSNPPSI2",171,0)
MULTIPLE ;There should only be one RxNorm entry and one RXCUI
"RTN","PSNPPSI2",172,0)
 N DA,SROOT,MROOT,MLTCNT,DIC,DINUM,X,Y,DINUM,VAPRIEN,SS1,SS2,SS3,DLAYGO
"RTN","PSNPPSI2",173,0)
 S LI=$P(DIA,"^",3),SROOT=ROOT,ROOT=50.68,MLTCNT="",VAPRIEN=$P($P(DIA,"^"),",")
"RTN","PSNPPSI2",174,0)
 ;handles a multiple and a multiple within a multiple
"RTN","PSNPPSI2",175,0)
 I FILE=50.68,$P(DIA,"^",3)="43,.01",(NEW["DELETE"!(NEW="")) D RXNORMD1(VAPRIEN) Q
"RTN","PSNPPSI2",176,0)
 I FILE=50.68,$P(DIA,"^",3)="43,.02,.01",(NEW["DELETE"!(NEW="")) D RXNORMD1(VAPRIEN) Q
"RTN","PSNPPSI2",177,0)
 I PSNTMPN="DATAN" D  ;DATAN records are new entries and should not be already defined
"RTN","PSNPPSI2",178,0)
 .I FILE=50.68,$P(DIA,"^",3)="43,.01" D:$D(^PSNDF(50.68,VAPRIEN,11,0)) RXNORMD1(VAPRIEN) Q
"RTN","PSNPPSI2",179,0)
 .I FILE=50.68,$P(DIA,"^",3)="43,.02,.01" D
"RTN","PSNPPSI2",180,0)
 ..S SS1="",SS1=$O(^PSNDF(50.68,VAPRIEN,11,"B","RxNorm",SS1))
"RTN","PSNPPSI2",181,0)
 ..Q:SS1=""
"RTN","PSNPPSI2",182,0)
 ..S (SS3,SS2)=0 F  S SS2=$O(^PSNDF(50.68,VAPRIEN,11,SS1,1,SS2)) Q:'SS2  S SS3=1
"RTN","PSNPPSI2",183,0)
 ..Q:'SS3
"RTN","PSNPPSI2",184,0)
 ..D RXNORMD2(VAPRIEN)
"RTN","PSNPPSI2",185,0)
 ;ROOT=top of file, and then sets root to the multiple root
"RTN","PSNPPSI2",186,0)
 F J=1:1:$L(LI,",")-1 S ROOT=+$P(^DD(ROOT,+$P(LI,",",J),0),"^",2)
"RTN","PSNPPSI2",187,0)
 S MROOT=ROOT
"RTN","PSNPPSI2",188,0)
 S LI=$P(DIA,"^"),IENS="" F J=$L(LI,","):-1:1 S IENS=IENS_$P(LI,",",J)_",",^TMP("PSN PPSN PARSED",$J,"AE_PRODUCTS",$P(LI,",",J))=""
"RTN","PSNPPSI2",189,0)
 F J=1:1 Q:$P(LI,",",J)=""  S MLTCNT=MLTCNT+1
"RTN","PSNPPSI2",190,0)
 S XFLDS=$P(FLDS,",",$L(FLDS,","))
"RTN","PSNPPSI2",191,0)
 I PSNTMPN="DATAO" D EDTMULT Q
"RTN","PSNPPSI2",192,0)
 I MLTCNT=2 S FLDS=$P(FLDS,",",MLTCNT) D
"RTN","PSNPPSI2",193,0)
 .K DIC,DA S DA(1)=VAPRIEN,X=VAPRIEN,DIC="^PSNDF(50.68,"_VAPRIEN_",11,",DIC(0)="ZQL",DLAYGO=50.6843,X=NEW D ^DIC
"RTN","PSNPPSI2",194,0)
 I MLTCNT>2 S FLDS=$P(FLDS,",",MLTCNT-1) D
"RTN","PSNPPSI2",195,0)
 .K DIC,DA S DA(1)=VAPRIEN,X=VAPRIEN,DIC="^PSNDF(50.68,"_VAPRIEN_",11,",DIC(0)="ZQ",X="RxNorm" D ^DIC
"RTN","PSNPPSI2",196,0)
 .I +$G(Y) S DA(1)=+Y,DA(2)=VAPRIEN
"RTN","PSNPPSI2",197,0)
 .I DA(1)="" D ERROR2^PSNPPSNU(PSNTMPN,MROOT,IENS,DA,"Error setting new multiple entry - top level multiple is not defined")
"RTN","PSNPPSI2",198,0)
 .K DIC,Y S X=DA(1),DIC="^PSNDF(50.68,"_VAPRIEN_",11,"_DA(1)_",1,",DIC(0)="ZQL",DLAYGO=50.68431,X=NEW D ^DIC
"RTN","PSNPPSI2",199,0)
 .I Y=-1!(+Y="") D ERROR2^PSNPPSNU(PSNTMPN,MROOT,IENS,DA,"Error setting new multiple entry - top level multiple is not defined") Q
"RTN","PSNPPSI2",200,0)
 .S DA=+Y,DIE=DIC K DIC S DR=".01///"_NEW D ^DIE K DIE,DR,DA,Y
"RTN","PSNPPSI2",201,0)
 Q
"RTN","PSNPPSI2",202,0)
 ;
"RTN","PSNPPSI2",203,0)
EDTMULT ;edit existing multiple entry other than .01 field
"RTN","PSNPPSI2",204,0)
 K DIC,DA S DA(1)=VAPRIEN,X=VAPRIEN,DIC="^PSNDF(50.68,"_VAPRIEN_",11,",DIC(0)="ZQ",X="RxNorm" D ^DIC
"RTN","PSNPPSI2",205,0)
 I Y=-1!(+Y="") D ERROR2^PSNPPSNU(PSNTMPN,MROOT,IENS,DA,"Error editing RxNorm multiple - top level multiple is not defined") Q
"RTN","PSNPPSI2",206,0)
 S DA(1)=+Y,DA(2)=VAPRIEN
"RTN","PSNPPSI2",207,0)
 S DA=0,DA=$O(^PSNDF(50.68,6173,11,3,""),-1)
"RTN","PSNPPSI2",208,0)
 I DA=0!(DA="") D ERROR2^PSNPPSNU(PSNTMPN,MROOT,IENS,DA,"Error editing RxNorm multiple - multiple is not defined")
"RTN","PSNPPSI2",209,0)
 S DIE=DIC,IENS=DA_","_DA(1)_","_DA(2)_","
"RTN","PSNPPSI2",210,0)
 S XPATH=$P(^DD(ROOT,.01,0),"^",3),ROOT3="^"_XPATH_DA(1)_",2,"
"RTN","PSNPPSI2",211,0)
 K FDA,ERROR S FDA(ROOT,IENS,XFLDS)=NEW D UPDATE^DIE("","FDA",DA,"ERROR")
"RTN","PSNPPSI2",212,0)
 S ROOT=SROOT
"RTN","PSNPPSI2",213,0)
 Q
"RTN","PSNPPSI2",214,0)
 ;
"RTN","PSNPPSI2",215,0)
RXNORMD1(PSNVAPN) ;RxNorm deleted
"RTN","PSNPPSI2",216,0)
 N CNT,CNT2,DIK,DA,X
"RTN","PSNPPSI2",217,0)
 S CNT=0 F  S CNT=$O(^PSNDF(50.68,PSNVAPN,11,CNT)) Q:CNT'?1N.N  D
"RTN","PSNPPSI2",218,0)
 .S X="",X=$G(^PSNDF(50.68,PSNVAPN,11,CNT,0))
"RTN","PSNPPSI2",219,0)
 .Q:X=""
"RTN","PSNPPSI2",220,0)
 .Q:X'="RxNorm"
"RTN","PSNPPSI2",221,0)
 .S DIK="^PSNDF(50.68,"_PSNVAPN_",11,",DA=CNT,DA(1)=PSNVAPN
"RTN","PSNPPSI2",222,0)
 .D ^DIK
"RTN","PSNPPSI2",223,0)
 Q
"RTN","PSNPPSI2",224,0)
 ;
"RTN","PSNPPSI2",225,0)
RXNORMD2(PSNVAPN) ;RxNorm deleted
"RTN","PSNPPSI2",226,0)
 N CNT,CNT2,DIK,DA,X,OVAL
"RTN","PSNPPSI2",227,0)
 S (CNT2,CNT)=0 F  S CNT=$O(^PSNDF(50.68,PSNVAPN,11,CNT)) Q:CNT'?1N.N  F  S CNT2=$O(^PSNDF(50.68,PSNVAPN,11,CNT,1,CNT2)) Q:CNT2'?1N.N  D
"RTN","PSNPPSI2",228,0)
 .S X="",X=$G(^PSNDF(50.68,PSNVAPN,11,CNT,1,CNT2,0))
"RTN","PSNPPSI2",229,0)
 .Q:X=""
"RTN","PSNPPSI2",230,0)
 .S OVAL=X,X=NEW
"RTN","PSNPPSI2",231,0)
 .S DIK="^PSNDF(50.68,"_PSNVAPN_",11,"_CNT_",1,",DA=CNT2,DA(1)=CNT,DA(2)=PSNVAPN
"RTN","PSNPPSI2",232,0)
 .D ^DIK
"RTN","PSNPPSI2",233,0)
 .K ^PSNDF(50.68,PSNVAPN,11,CNT,CNT2,"B",OVAL)
"RTN","PSNPPSI2",234,0)
 Q
"RTN","PSNPPSI2",235,0)
 ;
"RTN","PSNPPSI2",236,0)
UNMATCH ;DRUGS TO UNMATCH
"RTN","PSNPPSI2",237,0)
 N DIAFLD,OLDGEN
"RTN","PSNPPSI2",238,0)
 S (DIAFLD,OLDGEN)="",DIAFLD=$P(DIA,"^",3)
"RTN","PSNPPSI2",239,0)
 I DIAFLD=.05!(DIAFLD=1)!(DIAFLD=2)!(DIAFLD=3)!(DIAFLD=5)!(DIAFLD=6)!(DIAFLD=8) D
"RTN","PSNPPSI2",240,0)
 .Q:$D(^TMP("PSN PPSN PARSED",$J,"NEW PRODUCTS",+DIA))
"RTN","PSNPPSI2",241,0)
 .S ^TMP("PSN PPSN PARSED",$J,"PRODUCTS TO UNMATCH",$P(DIA,"^"))=""
"RTN","PSNPPSI2",242,0)
 .D SETPROD
"RTN","PSNPPSI2",243,0)
 Q
"RTN","PSNPPSI2",244,0)
 ;
"RTN","PSNPPSI2",245,0)
SETPROD ;
"RTN","PSNPPSI2",246,0)
 Q:PSNPS'="N"
"RTN","PSNPPSI2",247,0)
 Q:$D(^NDFK(5000.2,"B",$P(DIA,"^")))
"RTN","PSNPPSI2",248,0)
 S (DINUM,X)=$P(DIA,"^"),DIC=5000.2,DIC(0)="LMXZ" D FILE^DICN
"RTN","PSNPPSI2",249,0)
 Q
"RTN","PSNPPSI2",250,0)
 ;
"RTN","PSNPPSI2",251,0)
AIDEL(PSNVAPD) ; active ingredients deleted
"RTN","PSNPPSI2",252,0)
 N CNT1,DA,DINUM,X
"RTN","PSNPPSI2",253,0)
 S CNT1=0 F  S CNT1=$O(^PSNDF(50.68,PSNVAPD,2,CNT1)) Q:CNT1=""  D
"RTN","PSNPPSI2",254,0)
 .S DIK="^PSNDF(50.68,"_PSNVAPD_",2,",DA=CNT1,DA(1)=PSNVAPD D ^DIK
"RTN","PSNPPSI2",255,0)
 Q
"RTN","PSNPPSI3")
0^3^B48818890^n/a
"RTN","PSNPPSI3",1,0)
PSNPPSI3 ;HP/MJE-PPSN update NDF data for parsing DATAO records ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSI3",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNPPSI3",3,0)
 ;Reference to ^DD supported by DBIA #1258
"RTN","PSNPPSI3",4,0)
 ;
"RTN","PSNPPSI3",5,0)
 Q
"RTN","PSNPPSI3",6,0)
 ;
"RTN","PSNPPSI3",7,0)
 ;This routine parses DATAO records which are edits to existing file entries
"RTN","PSNPPSI3",8,0)
DATAO ;
"RTN","PSNPPSI3",9,0)
 K XFILE,XFLDS
"RTN","PSNPPSI3",10,0)
 K FDA
"RTN","PSNPPSI3",11,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",6)="DATAO",PSNTMPN="DATAO"
"RTN","PSNPPSI3",12,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSI3",13,0)
 K FDA
"RTN","PSNPPSI3",14,0)
 D CTRLFILE^PSNPPSMS(0)
"RTN","PSNPPSI3",15,0)
 D CTRLSS^PSNPPSMS(0)
"RTN","PSNPPSI3",16,0)
 D CTRLIEN^PSNPPSMS(0)
"RTN","PSNPPSI3",17,0)
 S (OJJ,FILE)=0,GROOT=$NA(^TMP("PSN PPSN PARSED",$J,"DATAO"))
"RTN","PSNPPSI3",18,0)
 ;now load the rest of the data
"RTN","PSNPPSI3",19,0)
 F  S FILE=$O(@GROOT@(FILE)) Q:'FILE  D CTRLFILE^PSNPPSMS(FILE) S ROOT=$$ROOT^DILFD(FILE) I ROOT]"" S GROOT1=$NA(@GROOT@(FILE)) F JJ=1:2 Q:'$D(@GROOT1@(JJ))  D
"RTN","PSNPPSI3",20,0)
 .S (DIA,NEW)=""
"RTN","PSNPPSI3",21,0)
 .S DIA=@GROOT1@(JJ) I $G(@GROOT1@(JJ+1))]"" S NEW=@GROOT1@(JJ+1)
"RTN","PSNPPSI3",22,0)
 .S ^TMP("PSN PPSN PARSED",$J,"AE_PRODUCTS",+DIA)=""
"RTN","PSNPPSI3",23,0)
 .D CTRLSS^PSNPPSMS($TR(GROOT1,"^")_","_JJ)
"RTN","PSNPPSI3",24,0)
 .;
"RTN","PSNPPSI3",25,0)
 .I $G(PSNMULTI) D
"RTN","PSNPPSI3",26,0)
 ..S (MIENS,MFLDS)="",MIENS=$P(DIA,"^")_",",MFLDS=$P(DIA,"^",3)
"RTN","PSNPPSI3",27,0)
 ..I MFLDS'=""&($P(NEW,"^")'=MIENS) S PSNMULTI=0,^TMP("PSN PPSN.WPXRF",$J,FILE,OIENS,OFLDS)=""
"RTN","PSNPPSI3",28,0)
 .S IENS=$P(DIA,"^")_",",FLDS=$P(DIA,"^",3),ROOT=FILE K FDA,IEN
"RTN","PSNPPSI3",29,0)
 .;
"RTN","PSNPPSI3",30,0)
 .I FILE=50.68 D UNMATCH^PSNPPSI2
"RTN","PSNPPSI3",31,0)
 .;
"RTN","PSNPPSI3",32,0)
 .K RES1
"RTN","PSNPPSI3",33,0)
 .I '$G(PSNMULTI) D FIELD^DID(FILE,FLDS,"","TYPE","RES1")
"RTN","PSNPPSI3",34,0)
 .I $G(RES1("TYPE"))="WORD-PROCESSING"!$G(PSNMULTI) D  Q
"RTN","PSNPPSI3",35,0)
 ..I '$G(PSNMULTI) D
"RTN","PSNPPSI3",36,0)
 ...S MJJ=JJ,OIENS=IENS,OFLDS=FLDS
"RTN","PSNPPSI3",37,0)
 ...I $D(^TMP("PSN PPSN.WPXRF",$J,FILE,IENS,FLDS)) K ^TMP("PSN PPSN.WP",$J,FILE,OIENS,OFLDS),^TMP("PSN PPSN.WPXRF",$J,FILE,IENS,FLDS)
"RTN","PSNPPSI3",38,0)
 ...;Set 5000 file for word processing fields
"RTN","PSNPPSI3",39,0)
 ...S PSNWP=$$GET1^DID(FILE,"","","GLOBAL NAME")_$P(DIA,"^")_","  ;"PSNDF(FILE,"_IENS_",1)"
"RTN","PSNPPSI3",40,0)
 ...D FIELD^DID(FILE,FLDS,"Z","GLOBAL SUBSCRIPT LOCATION","RES2")
"RTN","PSNPPSI3",41,0)
 ...S RES3="",RES3=$P(RES2("GLOBAL SUBSCRIPT LOCATION"),";")
"RTN","PSNPPSI3",42,0)
 ...S PSNWP=PSNWP_$S(RES3?1AN.AN:""""_RES3_"""",1:RES3)_")"
"RTN","PSNPPSI3",43,0)
 ...I PSNPS="N",'$D(^NDFK(5000,1,4,"B",PSNWP)) S X=$O(^NDFK(5000,1,4," "),-1)+1,^(X,0)=PSNWP,^NDFK(5000,1,4,"B",PSNWP,X)=""
"RTN","PSNPPSI3",44,0)
 ..;
"RTN","PSNPPSI3",45,0)
 ..I '$P(DIA,"^",3) S ^TMP("PSN PPSN.WP",$J,FILE,OIENS,OFLDS,MJJ)=$$STRIP^PSNPPSNU(DIA),MJJ=MJJ+1
"RTN","PSNPPSI3",46,0)
 ..I '$P(NEW,"^",3) S ^TMP("PSN PPSN.WP",$J,FILE,OIENS,OFLDS,MJJ)=$$STRIP^PSNPPSNU(NEW),PSNMULTI=1,MJJ=MJJ+1
"RTN","PSNPPSI3",47,0)
 ..I $P(NEW,"^",3)'="" S JJ=JJ-1
"RTN","PSNPPSI3",48,0)
 .;
"RTN","PSNPPSI3",49,0)
 .S XFILE=FILE
"RTN","PSNPPSI3",50,0)
 .I FLDS["," D
"RTN","PSNPPSI3",51,0)
 ..I FILE=50.68,$P($P(DIA,"^",3),",")=43 D MULTIPLE^PSNPPSI2 Q  ;new generic multiple .01 field code
"RTN","PSNPPSI3",52,0)
 ..S LI=$P(DIA,"^",3) F J=1:1:$L(LI,",")-1 S ROOT=+$P(^DD(ROOT,+$P(LI,",",J),0),"^",2)
"RTN","PSNPPSI3",53,0)
 ..S LI=$P(DIA,"^"),IENS="" F J=$L(LI,","):-1:1 S IENS=IENS_$P(LI,",",J)_"," S ^TMP("PSN PPSN PARSED",$J,"AE_PRODUCTS",$P(LI,",",J))=""
"RTN","PSNPPSI3",54,0)
 ..S XFLDS=$P(FLDS,",",$L(FLDS,",")-1) I $G(XFLDS)'="" S XFILE=+$P(^DD(FILE,XFLDS,0),"^",2) S:$G(XFILE)="" XFILE=FILE
"RTN","PSNPPSI3",55,0)
 ..S FLDS=$P(FLDS,",",$L(FLDS,","))
"RTN","PSNPPSI3",56,0)
 .S DA=+IENS
"RTN","PSNPPSI3",57,0)
 .D CTRLIEN^PSNPPSMS(IENS)
"RTN","PSNPPSI3",58,0)
 .I FILE=50.68,$P($P(DIA,"^",3),",")=43 Q
"RTN","PSNPPSI3",59,0)
 .;
"RTN","PSNPPSI3",60,0)
 .I PSNPS="N",FILE=50.68 D
"RTN","PSNPPSI3",61,0)
 ..D NDFK^PSNPPSNK
"RTN","PSNPPSI3",62,0)
 ..I FLDS=31 D
"RTN","PSNPPSI3",63,0)
 ...K ORDP,ORDN,ERROR
"RTN","PSNPPSI3",64,0)
 ...S ORDP=$$GET1^DIQ(50.68,+IENS_",",31,"I","ERROR")
"RTN","PSNPPSI3",65,0)
 ...S ORDN=NEW
"RTN","PSNPPSI3",66,0)
 ...S ^TMP("PSN PPSN PARSED",$J,"POST_RUN",5000.608,FILE,+IENS,FLDS)=ORDP_"^"_ORDN
"RTN","PSNPPSI3",67,0)
 ..I $P(DIA,"^",3)="14,.01" S ^TMP("PSN PPSN PARSED",$J,"POST_RUN",5000.509,FILE,IENS,FLDS)=NEW
"RTN","PSNPPSI3",68,0)
 .;
"RTN","PSNPPSI3",69,0)
 .D CLASS:FILE=50.68
"RTN","PSNPPSI3",70,0)
 .;new generic multiple .01 field code
"RTN","PSNPPSI3",71,0)
 .I FILE=50.68,$P($P(DIA,"^",3),",")=43 Q
"RTN","PSNPPSI3",72,0)
 .;
"RTN","PSNPPSI3",73,0)
 .I FILE=50.68,$P(DIA,"^",3)="21" D  K FDA
"RTN","PSNPPSI3",74,0)
 ..K FDA,ERROR
"RTN","PSNPPSI3",75,0)
 ..D NOW^%DTC
"RTN","PSNPPSI3",76,0)
 ..S FDA(50.6899,"+1,"_IENS,.01)=$S(NEW="":$P(%,"."),1:NEW),FDA(50.6899,"+1,"_IENS,.02)=$S(NEW="":1,1:0)
"RTN","PSNPPSI3",77,0)
 ..D UPDATE^DIE("","FDA","","ERROR") D ERROR^PSNPPSNU:$D(ERROR("DIERR")) K FDA
"RTN","PSNPPSI3",78,0)
 .I PSNPS="N" D
"RTN","PSNPPSI3",79,0)
 ..I FILE=50.416 D INGRED^PSNPPSNK
"RTN","PSNPPSI3",80,0)
 ..I FILE=56 D 56^PSNPPSMS(FILE,DIA,NEW,PSNTMPN)
"RTN","PSNPPSI3",81,0)
 .I PSNPS="N",FILE=50.67&($P(DIA,"^",3)=1) D 
"RTN","PSNPPSI3",82,0)
 .. S ^TMP("PSN PPSN PARSED",$J,"POST_RUN",50.628,FILE,+DIA,1)=NEW
"RTN","PSNPPSI3",83,0)
 .;****************************************************** 47
"RTN","PSNPPSI3",84,0)
 .I FILE[50.68,$P(DIA,"^",3)="45,1"!($P(DIA,"^",3)="45,2") K DIE D  Q  ;**COPAY TIERS
"RTN","PSNPPSI3",85,0)
 ..K FDA,ERROR
"RTN","PSNPPSI3",86,0)
 ..S DA=$P($P(DIA,"^"),",",2),FDA(50.6845,IENS,$P($P(DIA,"^",3),",",2))=NEW D FILE^DIE("","FDA","ERROR") D ERROR^PSNPPSNU:$D(ERROR("DIERR"))
"RTN","PSNPPSI3",87,0)
 ..K FDA
"RTN","PSNPPSI3",88,0)
 .;50.606 DOSAGE FORM UNITS
"RTN","PSNPPSI3",89,0)
 .I FILE[50.606,$P(DIA,"^",3)="8,1" K DIE D  Q
"RTN","PSNPPSI3",90,0)
 ..K FDA,ERROR
"RTN","PSNPPSI3",91,0)
 ..S DA=$P($P(DIA,"^"),",",2),FDA(50.6068,IENS,$P($P(DIA,"^",3),",",2))=NEW D FILE^DIE("","FDA","ERROR") D ERROR^PSNPPSNU:$D(ERROR("DIERR"))
"RTN","PSNPPSI3",92,0)
 ..K FDA
"RTN","PSNPPSI3",93,0)
 .;50.606 DISPENSE UNITS PER DOSE
"RTN","PSNPPSI3",94,0)
 .I FILE[50.606,$P(DIA,"^",3)="9,1" K DIE D  Q
"RTN","PSNPPSI3",95,0)
 ..K FDA,ERROR
"RTN","PSNPPSI3",96,0)
 ..S DA=$P($P(DIA,"^"),",",2),FDA(50.6069,IENS,$P($P(DIA,"^",3),",",2))=NEW D FILE^DIE("","FDA","ERROR") D ERROR^PSNPPSNU:$D(ERROR("DIERR"))
"RTN","PSNPPSI3",97,0)
 ..K FDA
"RTN","PSNPPSI3",98,0)
 .;50
"RTN","PSNPPSI3",99,0)
 .I $P(DIA,"^",3)="99.991,.01" D  K FDA Q
"RTN","PSNPPSI3",100,0)
 ..K FDA,ERROR
"RTN","PSNPPSI3",101,0)
 ..S FDA(ROOT,"+"_IENS,FLDS)=NEW D UPDATE^DIE("","FDA","","ERROR") D ERROR K FDA
"RTN","PSNPPSI3",102,0)
 .;
"RTN","PSNPPSI3",103,0)
 .I $P(DIA,"^",3)="99.991,.02" D  K FDA Q
"RTN","PSNPPSI3",104,0)
 ..K FDA,ERROR
"RTN","PSNPPSI3",105,0)
 ..S DA=999999999999 S DA=$O(^PS(FILE,$P(DIA,"^"),"TERMSTATUS",DA),-1) S:DA="" DA=1
"RTN","PSNPPSI3",106,0)
 ..I FILE=50.6!(FILE=50.68) S DA=999999999999 S DA=$O(^PSNDF(FILE,+$P(DIA,"^"),"TERMSTATUS",DA),-1)
"RTN","PSNPPSI3",107,0)
 ..S $P(IENS,",",1)=DA,FDA(ROOT,IENS,.02)=NEW D UPDATE^DIE("","FDA","IEN","ERROR") D ERROR K FDA
"RTN","PSNPPSI3",108,0)
 .;
"RTN","PSNPPSI3",109,0)
 .;delete sub-field entries if NEW="", means it was removed from the product in PPS-N
"RTN","PSNPPSI3",110,0)
 .I FILE=50.68&($P(DIA,"^",3)="14,.01")&(NEW="") D  Q
"RTN","PSNPPSI3",111,0)
 ..N DA,DIK,DIAU
"RTN","PSNPPSI3",112,0)
 ..S DA(1)=$P($P(DIA,"^"),","),ROOT3="^PSNDF(50.68,DA(1),2," ;,ROOT3="^"_XPATH_DA(1)_",2,"
"RTN","PSNPPSI3",113,0)
 ..S DIK=ROOT3,DA=$P($P(DIA,"^"),",",2) D ^DIK K DIK,DIAU
"RTN","PSNPPSI3",114,0)
 .;set fields 14,1 and 14,2
"RTN","PSNPPSI3",115,0)
 .I FILE=50.68&($P(DIA,"^",3)["14,") D  Q
"RTN","PSNPPSI3",116,0)
 ..S DA(1)=$P($P(DIA,"^"),","),XPATH=$P(^DD(ROOT,.01,0),"^",3),ROOT3="^"_XPATH_DA(1)_",2,"
"RTN","PSNPPSI3",117,0)
 ..K FDA,ERROR S FDA(ROOT,IENS,FLDS)=NEW D UPDATE^DIE("","FDA",DA,"ERROR") D ERROR
"RTN","PSNPPSI3",118,0)
 .;
"RTN","PSNPPSI3",119,0)
 .;HAZARDOUS TO DISPOSE FIELD 102 = ZERO; KILL FIELDS 103,104,105
"RTN","PSNPPSI3",120,0)
 .I FILE=50.68&($P(DIA,"^",3)=102),NEW=0 D
"RTN","PSNPPSI3",121,0)
 ..S DA=+$P(DIA,"^"),DIE="^PSNDF(50.68,",DR="103///@;104///@" D ^DIE
"RTN","PSNPPSI3",122,0)
 ..D WP^DIE(FILE,DA_",",105,,"@")
"RTN","PSNPPSI3",123,0)
 .;
"RTN","PSNPPSI3",124,0)
 .I IENS["," K FDA,ERROR S FDA(ROOT,IENS,FLDS)=NEW D FILE^DIE("","FDA","ERROR") D ERROR K FDA,ERROR Q
"RTN","PSNPPSI3",125,0)
 .K FDA,ERROR S FDA(FILE,IENS,FLDS)=NEW D FILE^DIE("","FDA","ERROR") D ERROR
"RTN","PSNPPSI3",126,0)
 .K FDA,ERROR
"RTN","PSNPPSI3",127,0)
 K XFILE,XFLDS
"RTN","PSNPPSI3",128,0)
 ;
"RTN","PSNPPSI3",129,0)
DATAO2 ;
"RTN","PSNPPSI3",130,0)
 S JJ=0 F  S JJ=$O(^TMP("PSNN",$J,JJ)) Q:'JJ  S DA=$P(JJ,",",2),DA(1)=+JJ D
"RTN","PSNPPSI3",131,0)
 . I '$D(^PSNDF(50.68,DA(1),0)) D ERROR2^PSNPPSNU(PSNTMPN,ROOT,IENS,DA(1),"VA PRODUCT entry does not exist.") Q
"RTN","PSNPPSI3",132,0)
 . D ING^PSNXREF
"RTN","PSNPPSI3",133,0)
 S FILE="" F  S FILE=$O(^TMP("PSN PPSN.WP",$J,FILE)) Q:FILE=""  D
"RTN","PSNPPSI3",134,0)
 . S IENS="" F  S IENS=$O(^TMP("PSN PPSN.WP",$J,FILE,IENS)) Q:IENS=""  D
"RTN","PSNPPSI3",135,0)
 .. S FLDS="" F  S FLDS=$O(^TMP("PSN PPSN.WP",$J,FILE,IENS,FLDS)) Q:FLDS=""  D
"RTN","PSNPPSI3",136,0)
 ... K TMP,ERR
"RTN","PSNPPSI3",137,0)
 ... S JJ=0 F  S JJ=$O(^TMP("PSN PPSN.WP",$J,FILE,IENS,FLDS,JJ)) Q:'JJ  D
"RTN","PSNPPSI3",138,0)
 .... S TMP(JJ)=^TMP("PSN PPSN.WP",$J,FILE,IENS,FLDS,JJ)
"RTN","PSNPPSI3",139,0)
 ... D WP^DIE(FILE,IENS,FLDS,"","TMP","ERR")
"RTN","PSNPPSI3",140,0)
 K ^TMP("PSN PPSN.WP",$J)
"RTN","PSNPPSI3",141,0)
 Q
"RTN","PSNPPSI3",142,0)
 ;
"RTN","PSNPPSI3",143,0)
ERROR ;
"RTN","PSNPPSI3",144,0)
 D ERROR^PSNPPSNU:$D(ERROR("DIERR"))
"RTN","PSNPPSI3",145,0)
 Q
"RTN","PSNPPSI3",146,0)
 ;
"RTN","PSNPPSI3",147,0)
CLASS ;
"RTN","PSNPPSI3",148,0)
 I $P(DIA,"^",3)=15 D
"RTN","PSNPPSI3",149,0)
 .S OLDV=$$GET1^DIQ(50.68,$P(DIA,"^"),15,"I"),VAGEN=$$GET1^DIQ(50.68,$P(DIA,"^"),.05,"I")
"RTN","PSNPPSI3",150,0)
 .S VAGENN=$$GET1^DIQ(50.68,$P(DIA,"^"),.05,"E")
"RTN","PSNPPSI3",151,0)
 .;Does not record class/edits on new VA Products same as NDFRR3 & PSSMIGRR routine
"RTN","PSNPPSI3",152,0)
 .I OLDV'="",(OLDV'=NEW) S ^TMP("PSN PPSN PARSED",$J,"PRODS CHANGED CLASSES",$P(DIA,"^"))=OLDV_"^"_NEW_"^"_VAGEN_"^"_VAGENN
"RTN","PSNPPSI3",153,0)
 Q
"RTN","PSNPPSMG")
0^11^B90560472^n/a
"RTN","PSNPPSMG",1,0)
PSNPPSMG ;HP/MJE-PPSN update NDF data ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSMG",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNPPSMG",3,0)
 ;Reference to ^PSDRUG supported by DBIA #2352,#221
"RTN","PSNPPSMG",4,0)
 ;
"RTN","PSNPPSMG",5,0)
MESSAGE ;
"RTN","PSNPPSMG",6,0)
 D CTRKDL^PSNPPSMS("Sending DATA UPDATE FOR NDF email")
"RTN","PSNPPSMG",7,0)
 W:'$G(PSNSCJOB) !,"Sending mail messages...",!
"RTN","PSNPPSMG",8,0)
 K FDA
"RTN","PSNPPSMG",9,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",6)="MESSAGE"
"RTN","PSNPPSMG",10,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSMG",11,0)
 K FDA
"RTN","PSNPPSMG",12,0)
 S FILE=0,GROOT=$NA(^TMP("PSN PPSN PARSED",$J,"DATAO"))
"RTN","PSNPPSMG",13,0)
 ;
"RTN","PSNPPSMG",14,0)
 S PSNPS=$P($G(^PS(59.7,1,10)),"^",12) I PSNPS'="N" G G1
"RTN","PSNPPSMG",15,0)
 N MESSC S MESSC=""
"RTN","PSNPPSMG",16,0)
 F  S MESSC=$O(^TMP("PSN PPSN PARSED",$J,"MESSAGE",MESSC)) Q:MESSC=""  D
"RTN","PSNPPSMG",17,0)
 .I MESSC=0 S ^NDFK(5000,1,2,0)=^TMP("PSN PPSN PARSED",$J,"MESSAGE",MESSC) Q
"RTN","PSNPPSMG",18,0)
 .S ^NDFK(5000,1,2,MESSC,0)=^TMP("PSN PPSN PARSED",$J,"MESSAGE",MESSC)
"RTN","PSNPPSMG",19,0)
 S MESSC=""
"RTN","PSNPPSMG",20,0)
 F  S MESSC=$O(^TMP("PSN PPSN PARSED",$J,"MESSAGE2",MESSC)) Q:MESSC=""  D
"RTN","PSNPPSMG",21,0)
 .I MESSC=0 S ^NDFK(5000,1,3,0)=^TMP("PSN PPSN PARSED",$J,"MESSAGE2",MESSC) Q
"RTN","PSNPPSMG",22,0)
 .S ^NDFK(5000,1,3,MESSC,0)=^TMP("PSN PPSN PARSED",$J,"MESSAGE2",MESSC)
"RTN","PSNPPSMG",23,0)
 ;
"RTN","PSNPPSMG",24,0)
G1 K ^TMP($J) M ^TMP($J)=^TMP("PSN PPSN PARSED",$J,"MESSAGE") K ^TMP($J,0)
"RTN","PSNPPSMG",25,0)
 ;
"RTN","PSNPPSMG",26,0)
GROUP K XMY S X=$G(^TMP("PSN PPSN PARSED",$J,"GROUP")) I X]"" S XMY("G."_X_"@"_^XMB("NETNAME"))=""
"RTN","PSNPPSMG",27,0)
 S PSNPS=$P($G(^PS(59.7,1,10)),"^",12)
"RTN","PSNPPSMG",28,0)
 D XMY
"RTN","PSNPPSMG",29,0)
 S XMSUB="DATA UPDATE FOR NDF"
"RTN","PSNPPSMG",30,0)
 S XMDUZ="noreply@DOMAIN.EXT"
"RTN","PSNPPSMG",31,0)
 S XMTEXT="^TMP($J," N DIFROM D ^XMD
"RTN","PSNPPSMG",32,0)
 D CTRKDL^PSNPPSMS("Sent email for DATA UPDATE FOR NDF.")
"RTN","PSNPPSMG",33,0)
 K FDA
"RTN","PSNPPSMG",34,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",6)="MESSAGE2"
"RTN","PSNPPSMG",35,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSMG",36,0)
 K FDA
"RTN","PSNPPSMG",37,0)
 K ^TMP($J) M ^TMP($J)=^TMP("PSN PPSN PARSED",$J,"MESSAGE2") K ^TMP($J,0)
"RTN","PSNPPSMG",38,0)
 K XMY S X=$G(^TMP("PSN PPSN PARSED",$J,"GROUP")) I X]"" S XMY("G."_X_"@"_^XMB("NETNAME"))=""
"RTN","PSNPPSMG",39,0)
 ;
"RTN","PSNPPSMG",40,0)
 D XMY
"RTN","PSNPPSMG",41,0)
 D CTRKDL^PSNPPSMS("Sending UPDATED INTERACTIONS and FDA MED GUIDE message")
"RTN","PSNPPSMG",42,0)
 S XMSUB="UPDATED INTERACTIONS AND FDA MED GUIDE"
"RTN","PSNPPSMG",43,0)
 S XMDUZ="noreply.domain.ext"
"RTN","PSNPPSMG",44,0)
 S XMTEXT="^TMP($J," N DIFROM D ^XMD
"RTN","PSNPPSMG",45,0)
 D CTRKDL^PSNPPSMS("Sent email for UPDATED INTERACTIONS and FDA MED GUIDE.")
"RTN","PSNPPSMG",46,0)
 K DA
"RTN","PSNPPSMG",47,0)
 Q
"RTN","PSNPPSMG",48,0)
 ;
"RTN","PSNPPSMG",49,0)
COMMSG ;Send error message that comm link with PPSN is not available
"RTN","PSNPPSMG",50,0)
 K ^TMP("PSN PPSN PARSED",$J,"COMMSG")
"RTN","PSNPPSMG",51,0)
 N PSNPS,PSMSGTXT,XMY,X,XMSUB,XMTEXT,PSGRP,LNCNT,FIRST,I3,I4,I5,I6,I7,III
"RTN","PSNPPSMG",52,0)
 S LNCNT=1,FIRST=0,(I3,I4,I5,I6,I7)="",PSNPS=$P($G(^PS(59.7,1,10)),"^",12)
"RTN","PSNPPSMG",53,0)
 S ^TMP("PSN PPSN PARSED",$J,"COMMSG",1)="*************************************************************************"
"RTN","PSNPPSMG",54,0)
 S ^TMP("PSN PPSN PARSED",$J,"COMMSG",3)="*************************************************************************"
"RTN","PSNPPSMG",55,0)
 S ^TMP("PSN PPSN PARSED",$J,"COMMSG",4)="The following file completed installation with error(s)"_$S(PSNPS="Q":" for QA",1:"")_":"
"RTN","PSNPPSMG",56,0)
 S ^TMP("PSN PPSN PARSED",$J,"COMMSG",5)=""
"RTN","PSNPPSMG",57,0)
 S ^TMP("PSN PPSN PARSED",$J,"COMMSG",6)="      Update file Name"
"RTN","PSNPPSMG",58,0)
 S ^TMP("PSN PPSN PARSED",$J,"COMMSG",7)="      -------------------"
"RTN","PSNPPSMG",59,0)
 S ^TMP("PSN PPSN PARSED",$J,"COMMSG",8)="      "_$P(PSNHLD,";")
"RTN","PSNPPSMG",60,0)
 S ^TMP("PSN PPSN PARSED",$J,"COMMSG",9)=""
"RTN","PSNPPSMG",61,0)
 S ^TMP("PSN PPSN PARSED",$J,"COMMSG",10)=""
"RTN","PSNPPSMG",62,0)
 S LNCNT=10
"RTN","PSNPPSMG",63,0)
 G:'$D(^TMP("PSN PPSN ERR",$J)) LZ S LNCNT=11 F  S I3=$O(^TMP("PSN PPSN ERR",$J,I3)) Q:I3=""  D
"RTN","PSNPPSMG",64,0)
 .F  S I4=$O(^TMP("PSN PPSN ERR",$J,I3,I4)) Q:'I4  D
"RTN","PSNPPSMG",65,0)
 ..F  S I5=$O(^TMP("PSN PPSN ERR",$J,I3,I4,I5)) Q:I5=""  D
"RTN","PSNPPSMG",66,0)
 ...F  S I6=$O(^TMP("PSN PPSN ERR",$J,I3,I4,I5,I6)) Q:I6=""  D
"RTN","PSNPPSMG",67,0)
 ....F  S I7=$O(^TMP("PSN PPSN ERR",$J,I3,I4,I5,I6,I7)) Q:'I7  D
"RTN","PSNPPSMG",68,0)
 .....S III=$G(^TMP("PSN PPSN ERR",$J,I3,I4,I5,I6,I7)) D
"RTN","PSNPPSMG",69,0)
 ......I FIRST=0 S ^TMP("PSN PPSN PARSED",$J,"COMMSG",LNCNT)="Error Message: " S LNCNT=LNCNT+1,FIRST=1
"RTN","PSNPPSMG",70,0)
 ......S ^TMP("PSN PPSN PARSED",$J,"COMMSG",LNCNT)=$$TRNS(I4,I5,I6) S LNCNT=LNCNT+1
"RTN","PSNPPSMG",71,0)
 ......S ^TMP("PSN PPSN PARSED",$J,"COMMSG",LNCNT)="      "_$P(III,"^")
"RTN","PSNPPSMG",72,0)
 ......S LNCNT=LNCNT+1
"RTN","PSNPPSMG",73,0)
LZ I '$D(^TMP("PSN PPSN ERR",$J)) S ^TMP("PSN PPSN PARSED",$J,"COMMSG",LNCNT+1)="Error Message: "_$P(COMM,"^",2)
"RTN","PSNPPSMG",74,0)
 S ^TMP("PSN PPSN PARSED",$J,"COMMSG",LNCNT+2)="               The update file completed installation but the completion"
"RTN","PSNPPSMG",75,0)
 S ^TMP("PSN PPSN PARSED",$J,"COMMSG",LNCNT+3)="               message was not accepted by PPS-N."
"RTN","PSNPPSMG",76,0)
 S ^TMP("PSN PPSN PARSED",$J,"COMMSG",LNCNT+4)=""
"RTN","PSNPPSMG",77,0)
 S ^TMP("PSN PPSN PARSED",$J,"COMMSG",LNCNT+5)="Contact the National Help Desk or enter a ticket."
"RTN","PSNPPSMG",78,0)
 S ^TMP("PSN PPSN PARSED",$J,"COMMSG",LNCNT+6)=""
"RTN","PSNPPSMG",79,0)
 S X=$G(^TMP("PSN PPSN PARSED",$J,"GROUP")) I X]"" S XMY("G."_X_"@"_^XMB("NETNAME"))=""
"RTN","PSNPPSMG",80,0)
 D XMY
"RTN","PSNPPSMG",81,0)
 S XMDUZ="noreply@domain.ext"
"RTN","PSNPPSMG",82,0)
 S XMSUB="ERROR: PPS-N/NDF File "_$P(PSNHLD,";",1)_" INSTALL"
"RTN","PSNPPSMG",83,0)
 I PSNPS'="" I PSNPS="Q" S XMSUB="ERROR: PPS-N/NDF File "_$P(PSNHLD,";",1)_" INSTALL FOR QA"
"RTN","PSNPPSMG",84,0)
 S XMTEXT="^TMP(""PSN PPSN PARSED"",$J,""COMMSG"","
"RTN","PSNPPSMG",85,0)
 N DIFROM D ^XMD
"RTN","PSNPPSMG",86,0)
 D CTRKDL^PSNPPSMS("Error email sent (COMMSG).")
"RTN","PSNPPSMG",87,0)
 Q
"RTN","PSNPPSMG",88,0)
 ;
"RTN","PSNPPSMG",89,0)
IERRMSG ;Send error message that comm link with PPSN is not available
"RTN","PSNPPSMG",90,0)
 K ^TMP("PSN PPSN PARSED",$J,"IERRMSG")
"RTN","PSNPPSMG",91,0)
 Q:INSTIEN=""
"RTN","PSNPPSMG",92,0)
 Q:'$D(^PS(57.23,1,5,INSTIEN,2,1))
"RTN","PSNPPSMG",93,0)
 N PSNEDATA,PSNPS,PSMSGTXT,XMY,X,XMSUB,XMTEXT,PSGRP,LNCNT,FIRST,I3,I4,I5,I6,I7,III
"RTN","PSNPPSMG",94,0)
 S LNCNT=1,FIRST=0,I3="",PSNPS=$P($G(^PS(59.7,1,10)),"^",12)
"RTN","PSNPPSMG",95,0)
 S ^TMP("PSN PPSN PARSED",$J,"IERRMSG",1)="*************************************************************************"
"RTN","PSNPPSMG",96,0)
 S ^TMP("PSN PPSN PARSED",$J,"IERRMSG",2)="  Error(s) occurred during the install of "_$P(PSNHLD,";")_$S(PSNPS="Q":" for QA",1:"")_":"
"RTN","PSNPPSMG",97,0)
 S ^TMP("PSN PPSN PARSED",$J,"IERRMSG",3)="*************************************************************************"
"RTN","PSNPPSMG",98,0)
 S ^TMP("PSN PPSN PARSED",$J,"IERRMSG",4)=""
"RTN","PSNPPSMG",99,0)
 S ^TMP("PSN PPSN PARSED",$J,"IERRMSG",5)="The "_$P(PSNHLD,";")_"NDF Update file completed installation with error(s)."
"RTN","PSNPPSMG",100,0)
 S ^TMP("PSN PPSN PARSED",$J,"IERRMSG",6)="Contact the National Help Desk or enter a ticket."
"RTN","PSNPPSMG",101,0)
 S ^TMP("PSN PPSN PARSED",$J,"IERRMSG",7)=""
"RTN","PSNPPSMG",102,0)
 S LNCNT=7
"RTN","PSNPPSMG",103,0)
 G:'$D(^PS(57.23,1,5,INSTIEN,2)) LZ2
"RTN","PSNPPSMG",104,0)
 S LNCNT=11,I3=0 F  S I3=$O(^PS(57.23,1,5,INSTIEN,2,I3)) Q:I3=""  I $D(^PS(57.23,1,5,INSTIEN,2,I3,0)) D
"RTN","PSNPPSMG",105,0)
 .I FIRST=0 S ^TMP("PSN PPSN PARSED",$J,"IERRMSG",LNCNT)="Error Message(s): " S LNCNT=LNCNT+1,FIRST=1
"RTN","PSNPPSMG",106,0)
 .S PSNEDATA="",PSNEDATA=^PS(57.23,1,5,INSTIEN,2,I3,0)
"RTN","PSNPPSMG",107,0)
 .S ^TMP("PSN PPSN PARSED",$J,"IERRMSG",LNCNT)="   File: "_$$LJ^XLFSTR($P(PSNEDATA,"^",2),13," ")_"   IEN: "_$$LJ^XLFSTR($P(PSNEDATA,"^",3),13," ")_"   Record Type: "_$$LJ^XLFSTR($P(PSNEDATA,"^",4),13," ") S LNCNT=LNCNT+1
"RTN","PSNPPSMG",108,0)
 .S ^TMP("PSN PPSN PARSED",$J,"IERRMSG",LNCNT)="       Last Record: "_$P(PSNEDATA,"|",2,3) S LNCNT=LNCNT+1
"RTN","PSNPPSMG",109,0)
 .S ^TMP("PSN PPSN PARSED",$J,"IERRMSG",LNCNT)="       Message: "_$P(PSNEDATA,"^",5) S LNCNT=LNCNT+1
"RTN","PSNPPSMG",110,0)
 .S ^TMP("PSN PPSN PARSED",$J,"IERRMSG",LNCNT)="  " S LNCNT=LNCNT+1
"RTN","PSNPPSMG",111,0)
 ;
"RTN","PSNPPSMG",112,0)
LZ2 ;
"RTN","PSNPPSMG",113,0)
 S ^TMP("PSN PPSN PARSED",$J,"IERRMSG",LNCNT)="",XMSUB="ERROR: PPS-N/NDF File "_$P(PSNHLD,";",1)_" INSTALL"
"RTN","PSNPPSMG",114,0)
 S X=$G(^TMP("PSN PPSN PARSED",$J,"GROUP")) I X]"" S XMY("G."_X_"@"_^XMB("NETNAME"))=""
"RTN","PSNPPSMG",115,0)
 I PSNPS'="",PSNPS="Q" S XMSUB="ERROR: PPS-N/NDF File "_$P(PSNHLD,";",1)_" INSTALL FOR QA"
"RTN","PSNPPSMG",116,0)
 K XMY S X=$G(^TMP("PSN PPSN PARSED",$J,"GROUP")) I X]"" S XMY("G."_X_"@"_^XMB("NETNAME"))=""
"RTN","PSNPPSMG",117,0)
 D XMY
"RTN","PSNPPSMG",118,0)
 S XMDUZ="noreply@domain.ext"
"RTN","PSNPPSMG",119,0)
 S XMTEXT="^TMP(""PSN PPSN PARSED"",$J,""IERRMSG"","
"RTN","PSNPPSMG",120,0)
 N DIFROM D ^XMD
"RTN","PSNPPSMG",121,0)
 D CTRKDL^PSNPPSMS("Install completed with errors and email with errors was sent (IERRMSG).")
"RTN","PSNPPSMG",122,0)
 Q
"RTN","PSNPPSMG",123,0)
 ;
"RTN","PSNPPSMG",124,0)
SMSG ;Send install successful message
"RTN","PSNPPSMG",125,0)
 K XMY
"RTN","PSNPPSMG",126,0)
 N PSNPS
"RTN","PSNPPSMG",127,0)
 ;SETUP PRODUCTION OR SQA
"RTN","PSNPPSMG",128,0)
 K ^TMP("PSN PPSN PARSED",$J,"MSG2")
"RTN","PSNPPSMG",129,0)
 N PSGRP,PSNFSIZE,PSSIZE,PSFILE,PSWRKDIR,PSOS
"RTN","PSNPPSMG",130,0)
 S PSWRKDIR=$$GETD^PSNFTP()
"RTN","PSNPPSMG",131,0)
 S PSNFSIZE=1,PSSIZE=""
"RTN","PSNPPSMG",132,0)
 S PSOS=$$GETOS^PSNFTP
"RTN","PSNPPSMG",133,0)
 I +PSOS=3 D UXFSIZE(PSWRKDIR,PSNHLD,.PSSIZE)
"RTN","PSNPPSMG",134,0)
 I +PSOS'=3 D FILSIZE^PSNFTP2(PSWRKDIR,PSNHLD,.PSSIZE,1)
"RTN","PSNPPSMG",135,0)
 ;
"RTN","PSNPPSMG",136,0)
 S PSNPS=$P($G(^PS(59.7,1,10)),"^",12)
"RTN","PSNPPSMG",137,0)
 ;
"RTN","PSNPPSMG",138,0)
 S XMSUB="PPS-N/NDF File "_$P(PSNHLD,";",1)_" INSTALLED"
"RTN","PSNPPSMG",139,0)
 I PSNPS'="" I PSNPS="Q" S XMSUB=XMSUB_" FOR QA"
"RTN","PSNPPSMG",140,0)
 S ^TMP("PSN PPSN PARSED",$J,"MSG2",1)="PPS-N/NDF File "_$P(PSNHLD,";",1)_" (Size "_PSSIZE_$S(+PSOS=1:"",+PSOS=3:" bytes",1:"")_")"
"RTN","PSNPPSMG",141,0)
 S ^TMP("PSN PPSN PARSED",$J,"MSG2",2)="INSTALLED successfully."
"RTN","PSNPPSMG",142,0)
 D XMY
"RTN","PSNPPSMG",143,0)
 S XMTEXT="^TMP(""PSN PPSN PARSED"",$J,""MSG2""," N DIFROM D ^XMD
"RTN","PSNPPSMG",144,0)
 K ^TMP("PSN PPSN PARSED",$J,"MSG2")
"RTN","PSNPPSMG",145,0)
 K ^TMP($J)
"RTN","PSNPPSMG",146,0)
 K XMSUB,XMDUZ,XMTEXT
"RTN","PSNPPSMG",147,0)
 Q
"RTN","PSNPPSMG",148,0)
 ;
"RTN","PSNPPSMG",149,0)
DRGMSG ;
"RTN","PSNPPSMG",150,0)
 W:'$G(PSNSCJOB) !,"Generating mail messages for unmatched/re-matched drugs...",!
"RTN","PSNPPSMG",151,0)
 D REPORT^PSNPPSNW ;        ********************
"RTN","PSNPPSMG",152,0)
 ;
"RTN","PSNPPSMG",153,0)
 N INDX,LINE,XMZ,PSNPS K ^TMP("PSN",$J) S LINE=1
"RTN","PSNPPSMG",154,0)
 S ^TMP("PSN",$J,LINE,0)="PPS-N Update File: "_$P(PSNHLD,";",1),LINE=LINE+1,^TMP("PSN",$J,LINE,0)="",LINE=LINE+1
"RTN","PSNPPSMG",155,0)
 F INDX="A","X","I" D LOAD1^PSNPPSMS
"RTN","PSNPPSMG",156,0)
 ;S XMDUZ="NDF_MANAGER"
"RTN","PSNPPSMG",157,0)
 S XMDUZ="noreply@domain.ext"
"RTN","PSNPPSMG",158,0)
 ;
"RTN","PSNPPSMG",159,0)
 S XMSUB="DRUGS UNMATCHED FROM NATIONAL DRUG FILE"
"RTN","PSNPPSMG",160,0)
 ;
"RTN","PSNPPSMG",161,0)
 S XMTEXT="^TMP(""PSN"",$J,"
"RTN","PSNPPSMG",162,0)
 K XMY S X=$G(^TMP("PSN PPSN PARSED",$J,"GROUP")) I X]"" S XMY("G."_X_"@"_^XMB("NETNAME"))=""
"RTN","PSNPPSMG",163,0)
 S PSGRP="",PSGRP=$$GET1^DIQ(57.23,1,5) ;get PPS-N UPDATE CONTROL:LOCAL EMAIL GROUP NAME (57.23:5)
"RTN","PSNPPSMG",164,0)
 S:PSGRP'="" XMY(PSGRP)=""
"RTN","PSNPPSMG",165,0)
 ;
"RTN","PSNPPSMG",166,0)
 S PSNPS=$P($G(^PS(59.7,1,10)),"^",12)
"RTN","PSNPPSMG",167,0)
 D XMY
"RTN","PSNPPSMG",168,0)
 N DIFROM D ^XMD I $D(XMZ) S DA=XMZ,DIE=3.9,DR="1.7///P;" D ^DIE
"RTN","PSNPPSMG",169,0)
 ;
"RTN","PSNPPSMG",170,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",10)="MESSAGE3"
"RTN","PSNPPSMG",171,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSMG",172,0)
 K FDA
"RTN","PSNPPSMG",173,0)
 K ^TMP($J) M ^TMP($J)=^TMP("PSN PPSN PARSED",$J,"MESSAGE3") K ^TMP($J,0)
"RTN","PSNPPSMG",174,0)
 K XMY S X=$G(^TMP("PSN PPSN PARSED",$J,"GROUP")) I X]"" S XMY("G."_X_"@"_^XMB("NETNAME"))=""
"RTN","PSNPPSMG",175,0)
 S PSNPS=$P($G(^PS(59.7,1,10)),"^",12)
"RTN","PSNPPSMG",176,0)
 D XMY
"RTN","PSNPPSMG",177,0)
 S XMSUB="LOCAL DRUGS REMATCHED TO NDF"
"RTN","PSNPPSMG",178,0)
 S XMDUZ="noreply@domain.ext"
"RTN","PSNPPSMG",179,0)
 S XMTEXT="^TMP($J," N DIFROM
"RTN","PSNPPSMG",180,0)
 D ^XMD
"RTN","PSNPPSMG",181,0)
 K DIE,DR
"RTN","PSNPPSMG",182,0)
 Q
"RTN","PSNPPSMG",183,0)
UXFSIZE(PSWRKDIR,PSNHLD,PSSIZE) ; get linux file size
"RTN","PSNPPSMG",184,0)
 N XPV,PSXLOG,PV S PSSIZE=""
"RTN","PSNPPSMG",185,0)
 S:'$D(PSWRKDIR) PSWRKDIR=$$GETD^PSNFTP()
"RTN","PSNPPSMG",186,0)
 S XPV="S PV=$ZF(-1,""stat -c%s "_PSWRKDIR_PSNHLD_">"_PSWRKDIR_"PSNSIZE.DAT"")"
"RTN","PSNPPSMG",187,0)
 X XPV
"RTN","PSNPPSMG",188,0)
 S PSXLOG="",PSXLOG=$$FTG^%ZISH(PSWRKDIR,"PSNSIZE.DAT",$NA(^TMP("PSNFSIZELOG",$J,1)),3)
"RTN","PSNPPSMG",189,0)
 I $D(^TMP("PSNFSIZELOG",$J,1)) S PSSIZE=$G(^TMP("PSNFSIZELOG",$J,1)) K ^TMP("PSNFSIZELOG",$J)
"RTN","PSNPPSMG",190,0)
 D LINUXDEL^PSNFTP(1,PSWRKDIR,"PSNSIZE.DAT")
"RTN","PSNPPSMG",191,0)
 Q
"RTN","PSNPPSMG",192,0)
TRNS(PSNFILE,IEN,PSNFIELD) ; get the label of file/field
"RTN","PSNPPSMG",193,0)
 N PSNF,FILE,FILENM,FIELD,PSNARR,FLD,FIELDX
"RTN","PSNPPSMG",194,0)
 S (FIELD,FILE,FILENM,PSNARR,FLD,PSNF)=""
"RTN","PSNPPSMG",195,0)
 S FILE=PSNFILE,(FIELD,FIELDX)=PSNFIELD
"RTN","PSNPPSMG",196,0)
 S PSNF=$S($D(^DIC(FILE,0)):$P($G(^DIC(FILE,0)),U),1:"**Wrong file number**")
"RTN","PSNPPSMG",197,0)
 I FIELD["," S FILENM=$P($G(^DD(FILE,+FIELD,0)),"^"),FILE=+$P($G(^DD(FILE,$P(FIELD,","),0)),"^",2) S:FILE FIELD=$P(FIELD,",",2)
"RTN","PSNPPSMG",198,0)
 K PSNARR D FIELD^DID(FILE,FIELD,"","LABEL","PSNARR") S FLD=$S(FIELDX[",":FILENM_" >>> ",1:"")_$G(PSNARR("LABEL"))
"RTN","PSNPPSMG",199,0)
 Q "   File: "_$$LJ^XLFSTR(PSNF,13," ")_"   IEN#: "_$$LJ^XLFSTR(IEN,13," ")_"   Field: "_$$LJ^XLFSTR(FLD,13," ")
"RTN","PSNPPSMG",200,0)
 ;
"RTN","PSNPPSMG",201,0)
XMY ;set XMY for mail message
"RTN","PSNPPSMG",202,0)
 S XMDUZ="noreply@domain.ext"
"RTN","PSNPPSMG",203,0)
 S DA=0 F  S DA=$O(^XUSEC("PSNMGR",DA)) Q:'DA  S XMY(DA)=""
"RTN","PSNPPSMG",204,0)
 I $D(DUZ) S XMY(DUZ)=""
"RTN","PSNPPSMG",205,0)
 S PSGRP="",PSGRP=$$GET1^DIQ(57.23,1,5) S:PSGRP'="" XMY($$MG(PSGRP))="" ;PRIMARY PPS-N MAIL GROUP
"RTN","PSNPPSMG",206,0)
 S PSGRP="",PSGRP=$$GET1^DIQ(57.23,1,6) S:PSGRP'="" XMY($$MG(PSGRP))="" ;SECONDARY MAIL GROUP
"RTN","PSNPPSMG",207,0)
 Q
"RTN","PSNPPSMG",208,0)
 ;
"RTN","PSNPPSMG",209,0)
MG(PSNGG) ; look for Mail Group
"RTN","PSNPPSMG",210,0)
 I $E(PSNGG,1,2)="G." Q:$O(^XMB(3.8,"B",$E(PSNGG,3,99),0)) PSNGG
"RTN","PSNPPSMG",211,0)
 Q:$O(^XMB(3.8,"B",PSNGG,0)) "G."_PSNGG
"RTN","PSNPPSMG",212,0)
 Q PSNGG
"RTN","PSNPPSMS")
0^13^B168622866^n/a
"RTN","PSNPPSMS",1,0)
PSNPPSMS ;HP/LE-PPSN update NDFK ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSMS",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNPPSMS",3,0)
 ;Reference to ^%ZISH supported by DBIA #2320
"RTN","PSNPPSMS",4,0)
 ;
"RTN","PSNPPSMS",5,0)
56(FILE,DIA,NEW,PSNTMPN) ;Drug Interaction file (#56) changes into 5000.561
"RTN","PSNPPSMS",6,0)
 ;5000.561 = inactivated drug interactions
"RTN","PSNPPSMS",7,0)
 ;5000.56 = added and edited drug interactions
"RTN","PSNPPSMS",8,0)
 ;
"RTN","PSNPPSMS",9,0)
 N DIC,DIE,DD,DO,DINUM,DA,FDA,NDFIEN,FLD1,TYPE,PSNPS,STAT
"RTN","PSNPPSMS",10,0)
 S PSNPS=$P($G(^PS(59.7,1,10)),"^",12) Q:PSNPS'="N"
"RTN","PSNPPSMS",11,0)
 S FLD1=$P(DIA,"^",3),NDFIEN=+DIA
"RTN","PSNPPSMS",12,0)
 S STAT="",STAT=$S((FLD1=7&(NEW'="")):"I",PSNTMPN="DATAN":"A",PSNTMPN="DATAO":"E",1:"")
"RTN","PSNPPSMS",13,0)
 I '$D(^NDFK(5000.56,$P(DIA,"^"))) D
"RTN","PSNPPSMS",14,0)
 .S DIC="^NDFK(5000.56,",DIC(0)="Z",(X,DINUM)=$P(DIA,"^") D FILE^DICN
"RTN","PSNPPSMS",15,0)
 .S DIE=DIC,DA=+Y K DIC
"RTN","PSNPPSMS",16,0)
 .S DA=+$P(DIA,"^"),DIE="^NDFK(5000.56,",DR="1///"_STAT D ^DIE
"RTN","PSNPPSMS",17,0)
 I $D(^NDFK(5000.56,$P(DIA,"^"))) D
"RTN","PSNPPSMS",18,0)
 .S DIC="^NDFK(5000.56,",DA=+$P(DIA,"^"),DIE="^NDFK(5000.56,",DR="1///"_STAT D ^DIE
"RTN","PSNPPSMS",19,0)
 Q
"RTN","PSNPPSMS",20,0)
 ;
"RTN","PSNPPSMS",21,0)
IGU ;For National VistA Test SQA use only
"RTN","PSNPPSMS",22,0)
 ;When a PPS-N Update file cannot be installed in the National VistA Test SQA account, use this option to reject the file.
"RTN","PSNPPSMS",23,0)
 ;Local VA production sites or product test accounts should NEVER use this option.  If you do, your NDF files
"RTN","PSNPPSMS",24,0)
 ;will be out of sync and may cause irreparable damage.  This is for SQA to reject corrupted files before they are nationally released.
"RTN","PSNPPSMS",25,0)
 N COMM,FILE,ANS,PARAM,ENTER,II,FLG,ACT,TYPE,PSNLEGF,ZTQUEUED,ZTREQ,IOBOFF,IOBON
"RTN","PSNPPSMS",26,0)
 S (ACT,TYPE,PARAM)="",PARAM=$$GET1^DIQ(59.7,1,17,"I")
"RTN","PSNPPSMS",27,0)
 ;
"RTN","PSNPPSMS",28,0)
IGU2 ;
"RTN","PSNPPSMS",29,0)
 S PSNLEGF="",PSNLEGF=$$LEGACY^PSNPPSDL() I PSNLEGF Q
"RTN","PSNPPSMS",30,0)
 S TYPE=$S("^P^T^S^"[("^"_PARAM_"^"):"C",1:"CR")
"RTN","PSNPPSMS",31,0)
 W !!
"RTN","PSNPPSMS",32,0)
 I TYPE="C" W "Note: Local sites may send completion messages for PPSN Update files, but may" D  ;only show for local sites, product support, local site test accounts
"RTN","PSNPPSMS",33,0)
 .W !,"not utilize the Reject Update File functionality as it is for National QA only.",!!
"RTN","PSNPPSMS",34,0)
 K DIR S DIR(0)="F^17:40^I X'?1""PPS_""1.12N1""PRV_""1.12N1""NEW.DAT"" K X"
"RTN","PSNPPSMS",35,0)
 S DIR("A")="Enter the PPS-N data file name to be "_$S(TYPE="CR":"Updated",1:"Completed")
"RTN","PSNPPSMS",36,0)
 S DIR("?",1)="  Enter the PPS-N Update file name that cannot be installed."
"RTN","PSNPPSMS",37,0)
 S DIR("?")="  The file format should be PPS_nnPRV_nnNEW.DAT." D ^DIR K DIR S FILE=Y
"RTN","PSNPPSMS",38,0)
 I (FILE="")!$D(DTOUT)!$D(DUOUT) Q
"RTN","PSNPPSMS",39,0)
 S (II,FLG)=0 F  S II=$O(^PS(57.23,1,4,"B",FILE,II)) Q:'II  I $P($G(^PS(57.23,1,4,II,0)),"^",4)]"" S FLG=1
"RTN","PSNPPSMS",40,0)
 I FLG=0 W !!!,$G(IOBON),"WARNING:",$G(IOBOFF)," The selected file hasn't been downloaded in VistA. It must be ",!,?9,"downloaded before you can be take action.",$C(7) Q
"RTN","PSNPPSMS",41,0)
 I +$P(FILE,"_",2)'=($$GET1^DIQ(57.23,1,8)-1) W !!!,$G(IOBON),"WARNING:",$G(IOBOFF)," Reject isn't allowed for Update files older than the current",!,?9,"downloaded version",$C(7) R !!,"Enter to continue... ",ENTER:60 Q
"RTN","PSNPPSMS",42,0)
 ;
"RTN","PSNPPSMS",43,0)
 I TYPE="CR" D ACTION I ACT="^" W !!,"No action taken." Q
"RTN","PSNPPSMS",44,0)
 S ACT=$S(TYPE="C":"C",1:ACT)
"RTN","PSNPPSMS",45,0)
 I ACT="C" D  D CONT Q
"RTN","PSNPPSMS",46,0)
 .S COMM="",COMM=$$SEND^PSNPPSNC("COMPLETED",$P(FILE,";"),"") H 1 W !! D
"RTN","PSNPPSMS",47,0)
 ..I COMM=1 W !,"Complete message was sent to PPS-N. File should be approved/rejected ",!,"in PPS-N side.",!
"RTN","PSNPPSMS",48,0)
 ..;E  W !,"There was a problem and the data file was not completed in PPS-N side."
"RTN","PSNPPSMS",49,0)
 ..I 'COMM D RETRY
"RTN","PSNPPSMS",50,0)
 ;
"RTN","PSNPPSMS",51,0)
RJ ; execute file rejection
"RTN","PSNPPSMS",52,0)
 N NFF S NFF=$$ASK(FILE) I $O(^PS(57.23,1,"B",$P(FILE,";")_";"_$P(NFF,"^",2),""),-1),PARAM'="Q" W !!,"No action taken." Q
"RTN","PSNPPSMS",53,0)
 W ! K DIR S DIR("A")="Are you sure you want to reject file '"_FILE_"'",DIR("B")="NO",DIR(0)="Y" D ^DIR K DIR I $D(DTOUT)!$D(DUOUT) Q
"RTN","PSNPPSMS",54,0)
 S ANS=Y I 'ANS W !!,"No action taken." Q
"RTN","PSNPPSMS",55,0)
 W !
"RTN","PSNPPSMS",56,0)
 ; send message to PPS-N - REJECTED processing
"RTN","PSNPPSMS",57,0)
 S COMM="",COMM=$$SEND^PSNPPSNC("ERROR",$P(FILE,";"),"Automatically Rejected: Unable to Install Update File in the Test Account") H 1
"RTN","PSNPPSMS",58,0)
 I 'COMM D  G IGU2
"RTN","PSNPPSMS",59,0)
 .W !?11,"*** ERROR: "_$P(COMM,"^",2)
"RTN","PSNPPSMS",60,0)
 .W !!?11,"PPS-N did not accept the REJECT transmission for "
"RTN","PSNPPSMS",61,0)
 .W !?11,FILE_"."
"RTN","PSNPPSMS",62,0)
 .W !!?11,"Contact your IRM and ask them to validate that the UPDATE_STATUS"
"RTN","PSNPPSMS",63,0)
 .W !?11,"web service manager is defined under the Web Server Name PPSN"
"RTN","PSNPPSMS",64,0)
 .W !?11,"and that it is active.  Also verify that the Pharmacy Product"
"RTN","PSNPPSMS",65,0)
 .W !?11,"System-National (PPS-N) is on-line.",!!
"RTN","PSNPPSMS",66,0)
 I COMM W !!,FILE," has been automatically rejected in PPS-N.",! S $P(^PS(57.23,1,0),"^",7)=+$P(FILE,"_",2) D
"RTN","PSNPPSMS",67,0)
 .I $P(NFF,"^",2) D REJUPD(FILE_";"_$P(NFF,"^",2))
"RTN","PSNPPSMS",68,0)
 ;
"RTN","PSNPPSMS",69,0)
CONT ;
"RTN","PSNPPSMS",70,0)
 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR
"RTN","PSNPPSMS",71,0)
 Q
"RTN","PSNPPSMS",72,0)
ACTION ; prompt user for action type (complete/reject)
"RTN","PSNPPSMS",73,0)
 I $$ASK1(FILE) S ACT="C" Q
"RTN","PSNPPSMS",74,0)
 W ! K DIR,ACT S DIR("A")="Action",DIR(0)="S^C:Complete data file;R:Reject data file",DIR("B")="C"
"RTN","PSNPPSMS",75,0)
 S DIR("?")="Enter 'R' to reject the data file in PPS-N and retain the data for next update file version.  Enter 'C' to changes the status in PPS-N which allows the user to notify PPS-N that the installation completed."
"RTN","PSNPPSMS",76,0)
 D ^DIR S ACT=$G(Y)
"RTN","PSNPPSMS",77,0)
 Q
"RTN","PSNPPSMS",78,0)
 ;
"RTN","PSNPPSMS",79,0)
RETRY ; try to resend of complete message to PPS-N within one hour
"RTN","PSNPPSMS",80,0)
 W !,"There was a problem and the data file was not completed in PPS-N side."
"RTN","PSNPPSMS",81,0)
 W !,"The completion message will be automatically resent to PPS-N until the message  is successfully transmitted or one hour has elapsed.",!
"RTN","PSNPPSMS",82,0)
 N ZTRTN,ZTIO,ZTDESC,ZTDTH,ZTSK
"RTN","PSNPPSMS",83,0)
 S ZTIO="",ZTRTN="NEWTRY^PSNPPSMS",ZTDESC="Automatic Resend of Complete message to PPS-N"
"RTN","PSNPPSMS",84,0)
 S ZTDTH=$H,ZTSAVE("FILE")="",ZTSAVE("DUZ")="" D ^%ZTLOAD I $D(ZTSK) W !!,"Queued as task #"_ZTSK K ZTSK
"RTN","PSNPPSMS",85,0)
 W !! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR
"RTN","PSNPPSMS",86,0)
 Q
"RTN","PSNPPSMS",87,0)
NEWTRY ; send of complete message to PPS-N
"RTN","PSNPPSMS",88,0)
 N PSNTXT,SDTM,ELAPS,DAY,XX,COMM,EDTM S SDTM=$H,(ELAPS,DAY,XX)=0
"RTN","PSNPPSMS",89,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSNPPSMS",90,0)
N1 S COMM=0 S COMM=$$SEND^PSNPPSNC("COMPLETED",$P(FILE,";"),"")
"RTN","PSNPPSMS",91,0)
 S EDTM=$H,DAY=+EDTM-(+SDTM)*86400 S XX=DAY+$P(EDTM,",",2)-$P(SDTM,",",2) I (XX\3600) S ELAPS=1
"RTN","PSNPPSMS",92,0)
 I (COMM+ELAPS)=0 G N1
"RTN","PSNPPSMS",93,0)
 ; send mail message notification
"RTN","PSNPPSMS",94,0)
 S XMY(DUZ)="",XMSUB="PPS-N/NDF file ["_FILE_"] - COMPLETE message status"
"RTN","PSNPPSMS",95,0)
 S PSNTXT(1)=""
"RTN","PSNPPSMS",96,0)
 S PSNTXT(2)=$S(COMM=0:"There was a problem and the data file was not completed in PPS-N side.",COMM=1:"Complete message was sent to PPS-N. File should be approved/rejected.",1:"")
"RTN","PSNPPSMS",97,0)
 S XMDUZ=.5,XMTEXT="PSNTXT("
"RTN","PSNPPSMS",98,0)
 D ^XMD
"RTN","PSNPPSMS",99,0)
 Q
"RTN","PSNPPSMS",100,0)
CTRLFILE(FILE) ;PROCESS CONTROL FILE, FILE NUMBER
"RTN","PSNPPSMS",101,0)
 K FDA
"RTN","PSNPPSMS",102,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",3)=FILE
"RTN","PSNPPSMS",103,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSMS",104,0)
 K FDA
"RTN","PSNPPSMS",105,0)
 Q
"RTN","PSNPPSMS",106,0)
 ;
"RTN","PSNPPSMS",107,0)
CTRLIEN(IENS) ;PROCESS CONTROL FILE, IENS
"RTN","PSNPPSMS",108,0)
 K FDA
"RTN","PSNPPSMS",109,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",4)=IENS
"RTN","PSNPPSMS",110,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSMS",111,0)
 K FDA
"RTN","PSNPPSMS",112,0)
 Q
"RTN","PSNPPSMS",113,0)
 ;
"RTN","PSNPPSMS",114,0)
CTRLSS(SS) ;PROCESS CONTROL FILE, SUBSCRIPT
"RTN","PSNPPSMS",115,0)
 K FDA
"RTN","PSNPPSMS",116,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",5)=$TR($TR(SS,""""),")")
"RTN","PSNPPSMS",117,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSMS",118,0)
 K FDA
"RTN","PSNPPSMS",119,0)
 Q
"RTN","PSNPPSMS",120,0)
 ;
"RTN","PSNPPSMS",121,0)
CTRKDL(DSPLY) ;PROCESS CONTROLL FILE, DISPLAYED LAST
"RTN","PSNPPSMS",122,0)
 K FDA
"RTN","PSNPPSMS",123,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",7)=DSPLY
"RTN","PSNPPSMS",124,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSMS",125,0)
 K FDA
"RTN","PSNPPSMS",126,0)
 ;
"RTN","PSNPPSMS",127,0)
RESOP ;Restarting option and protocol which were paused during install
"RTN","PSNPPSMS",128,0)
 Q:'$D(^TMP("PSNCON",$J))
"RTN","PSNPPSMS",129,0)
 N FL,IEN,DIE,DA,DR
"RTN","PSNPPSMS",130,0)
 S FL=0
"RTN","PSNPPSMS",131,0)
 F  S FL=$O(^TMP("PSNCON",$J,FL)) Q:FL=""  D
"RTN","PSNPPSMS",132,0)
 .S IEN=0
"RTN","PSNPPSMS",133,0)
 .F  S IEN=$O(^TMP("PSNCON",$J,FL,IEN)) Q:IEN=""  D
"RTN","PSNPPSMS",134,0)
 ..S DIE=FL,DA=IEN,DR="2///@"
"RTN","PSNPPSMS",135,0)
 ..D ^DIE
"RTN","PSNPPSMS",136,0)
 Q
"RTN","PSNPPSMS",137,0)
 ;
"RTN","PSNPPSMS",138,0)
LOAD1 ;BUILD THE MESSAGE
"RTN","PSNPPSMS",139,0)
 N PSNFIRST,PSNWP,DIWL,DIWR,J,NA
"RTN","PSNPPSMS",140,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",6)="TEXT"
"RTN","PSNPPSMS",141,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSMS",142,0)
 K FDA
"RTN","PSNPPSMS",143,0)
 S DIWL=1,DIWR=78 K ^UTILITY($J,"W")
"RTN","PSNPPSMS",144,0)
 S ^TMP("PSN",$J,LINE,0)=" ",LINE=LINE+1
"RTN","PSNPPSMS",145,0)
 S X="The following "_$S(INDX="A":"active",INDX="X":"investigational",1:"inactive")_" entries in your DRUG file (#50) have been" D ^DIWP
"RTN","PSNPPSMS",146,0)
 S J=0 F  S J=$O(^TMP("PSN PPSN PARSED",$J,"TEXT",J)) Q:'J  S X=^TMP("PSN PPSN PARSED",$J,"TEXT",J) D ^DIWP
"RTN","PSNPPSMS",147,0)
 S J=0 F  S J=$O(^UTILITY($J,"W",DIWL,J)) Q:J=""  S ^TMP("PSN",$J,LINE,0)=^UTILITY($J,"W",DIWL,J,0),LINE=LINE+1
"RTN","PSNPPSMS",148,0)
 K ^UTILITY($J,"W")
"RTN","PSNPPSMS",149,0)
 S ^TMP("PSN",$J,LINE,0)=" ",LINE=LINE+1
"RTN","PSNPPSMS",150,0)
 S NA="" I $O(^TMP($J,INDX,NA))="" S ^TMP("PSN",$J,LINE,0)="  NONE",LINE=LINE+1 Q
"RTN","PSNPPSMS",151,0)
 S PSNFIRST=0,NA=""
"RTN","PSNPPSMS",152,0)
 F  S NA=$O(^TMP($J,INDX,NA)) Q:NA=""  D
"RTN","PSNPPSMS",153,0)
 .I 'PSNFIRST D
"RTN","PSNPPSMS",154,0)
 ..S ^TMP("PSN",$J,LINE,0)="DRUG                                                  IEN    INACTIVATION",LINE=LINE+1
"RTN","PSNPPSMS",155,0)
 ..S ^TMP("PSN",$J,LINE,0)="                                                             DATE",LINE=LINE+1
"RTN","PSNPPSMS",156,0)
 ..S PSNFIRST=1
"RTN","PSNPPSMS",157,0)
 .S X=^TMP($J,INDX,NA,1),^TMP("PSN",$J,LINE,0)=$P(NA,"^") S $E(^TMP("PSN",$J,LINE,0),55)=$P(NA,"^",2)
"RTN","PSNPPSMS",158,0)
 .S:INDX="I" $E(^(0),62)=$$FMTE^XLFDT($P(NA,"^",3),5) S LINE=LINE+1,^TMP("PSN",$J,LINE,0)=$P(X,"^"),LINE=LINE+1
"RTN","PSNPPSMS",159,0)
 .S J=1 F  S J=$O(^TMP($J,INDX,NA,J)) Q:'J  S ^TMP("PSN",$J,LINE,0)=^(J),LINE=LINE+1
"RTN","PSNPPSMS",160,0)
 Q
"RTN","PSNPPSMS",161,0)
 ;
"RTN","PSNPPSMS",162,0)
HAZWASTE ;AFTER POPULATION OF HAZ WASTE FIELDS - CREATE DELIMITED FILE
"RTN","PSNPPSMS",163,0)
 N PSWRKDIR,POP,IEN,HAZTODIS,PRIMESC,WASTE,DOTSC,X,NAME,HAZTOHAN,DATA,PSCOMFIL,PSRC,PSVUID
"RTN","PSNPPSMS",164,0)
 S PSWRKDIR="",PSWRKDIR=$$GETD^PSNFTP()
"RTN","PSNPPSMS",165,0)
 S PSCOMFIL="PSNHAZW.TXT"
"RTN","PSNPPSMS",166,0)
 DO OPEN^%ZISH("FILE1",PSWRKDIR,PSCOMFIL,"W")
"RTN","PSNPPSMS",167,0)
 IF POP DO  QUIT
"RTN","PSNPPSMS",168,0)
 . SET PSRC="0^failed to open ftp .com file"
"RTN","PSNPPSMS",169,0)
 ;
"RTN","PSNPPSMS",170,0)
 S (POP,IEN,HAZTODIS,PRIMESC,WASTE,DOTSC,X,NAME,HAZTOHAN,PSVUID)=""
"RTN","PSNPPSMS",171,0)
 DO USE^%ZISUTL("FILE1")
"RTN","PSNPPSMS",172,0)
 W "VA PRODUCT IEN^NAME^HAZARDOUS TO HANDLE^HAZARDOUS TO DISPOSE^PRIMARY EPA CODE^WASTE SORT CODE^DOT SHIPPING CODE^VUID",!
"RTN","PSNPPSMS",173,0)
 F  S IEN=$O(^PSNDF(50.68,IEN)) Q:'IEN&(IEN'?1N.N)  D
"RTN","PSNPPSMS",174,0)
 .S X="",X=$G(^PSNDF(50.68,IEN,"HAZTODIS"))
"RTN","PSNPPSMS",175,0)
 .;Q:$P(X,"^")'="Y"
"RTN","PSNPPSMS",176,0)
 .S (DOTSC,NAME)="",NAME=$$GET1^DIQ(50.68,IEN,.01,"E"),PSVUID=$$GET1^DIQ(50.68,IEN,99.99)
"RTN","PSNPPSMS",177,0)
 .S HAZTODIS=$$GET1^DIQ(50.68,IEN,102),PRIMESC=$P(X,"^",2),WASTE=$P(X,"^",3),HAZTOHAN=$$GET1^DIQ(50.68,IEN,101)
"RTN","PSNPPSMS",178,0)
 .I $D(^PSNDF(50.68,IEN,"HAZTODIS2",1,0)) S DOTSC=^PSNDF(50.68,IEN,"HAZTODIS2",1,0)
"RTN","PSNPPSMS",179,0)
 .S DATA=IEN_"^"_NAME_"^"_HAZTOHAN_"^"_HAZTODIS_"^"_PRIMESC_"^"_WASTE_"^"_DOTSC_"^"_PSVUID
"RTN","PSNPPSMS",180,0)
 .W DATA,!
"RTN","PSNPPSMS",181,0)
 DO CLOSE^%ZISH("FILE1")
"RTN","PSNPPSMS",182,0)
 Q
"RTN","PSNPPSMS",183,0)
 ;
"RTN","PSNPPSMS",184,0)
QUEST ;
"RTN","PSNPPSMS",185,0)
 N XX,X2,X22,QUEST,PSLAST,FIRST,PSNEW,PSFLG,PSFILES,PSFILE,PSNEXT,QCNT,DIRUT,DUOUT,DTOUT
"RTN","PSNPPSMS",186,0)
 S PSFLG="",PSLAST=$$GET1^DIQ(57.23,1,2)
"RTN","PSNPPSMS",187,0)
 S PSNEW=PSLAST+1,QCNT=0
"RTN","PSNPPSMS",188,0)
 S PSFILE="PPS_"_PSLAST_"PRV_"_PSNEW_"NEW.DAT"
"RTN","PSNPPSMS",189,0)
 S PSNEXT="PPS_"_PSNEW_"PRV_"_(PSNEW+1)_"NEW.DAT"
"RTN","PSNPPSMS",190,0)
 S (XX,X2,X22,QUEST)=""
"RTN","PSNPPSMS",191,0)
 F  S X2=$O(B1(X2)) Q:X2=""  S X22=$G(B1(X2)) D
"RTN","PSNPPSMS",192,0)
 .I '$G(QCNT) W !!,"The following PPS-N/NDF Update file(s) are available for install: ",! S QCNT=1
"RTN","PSNPPSMS",193,0)
 .I ($P($P(X22,"PRV"),"_",2))<PSLAST K B1(X2) Q
"RTN","PSNPPSMS",194,0)
 .S XX=XX+1 W !?5,XX_")",?12,$P(X22,";") S PSFILES(99999999+(+$P(X22,"_",2)))=X22
"RTN","PSNPPSMS",195,0)
 W !
"RTN","PSNPPSMS",196,0)
 I '$G(XX) W !,?5,"There are no files to install.",! R !!,"Enter to continue... ",ENTER:60 S QUIT2=1 Q
"RTN","PSNPPSMS",197,0)
 I XX>1 D QUESTA
"RTN","PSNPPSMS",198,0)
 Q
"RTN","PSNPPSMS",199,0)
 ;
"RTN","PSNPPSMS",200,0)
QUESTA ;
"RTN","PSNPPSMS",201,0)
 W !,"The files must be installed in sequential order and take around"
"RTN","PSNPPSMS",202,0)
 W !,"30 minutes each to install. Pharmacy will be down for that period"
"RTN","PSNPPSMS",203,0)
 W !,"of time.  Do you want to install just the first one or all of them?"
"RTN","PSNPPSMS",204,0)
QUESTB ;
"RTN","PSNPPSMS",205,0)
 R !!,"(F)irst file only or (A)ll files: ",QUEST:120
"RTN","PSNPPSMS",206,0)
 I QUEST["^"!($G(DIRUT))!($G(DUOUT)) W !!,"No action taken.",! S QUIT2=1 Q
"RTN","PSNPPSMS",207,0)
 I QUEST["?"!("FAfa"'[QUEST) W !!,"Enter F to install only the first file or A to install all files." G QUESTB
"RTN","PSNPPSMS",208,0)
QUESTC ;
"RTN","PSNPPSMS",209,0)
 F  S X2=$O(B1(X2)) Q:X2=""  S X22=$G(B1(X2)) I '$D(PSFILES(X2)) K B1(X2)
"RTN","PSNPPSMS",210,0)
 I "Ff"[QUEST D
"RTN","PSNPPSMS",211,0)
 .S (X2,FIRST)="",FIRST=$O(PSFILES(FIRST))
"RTN","PSNPPSMS",212,0)
 .F  S X2=$O(B1(X2)) Q:X2=""  S X22=$G(B1(X2)) I X22'=$G(PSFILES(FIRST)) K B1(X2)
"RTN","PSNPPSMS",213,0)
 .W !!,"Only the first entry will be installed.",! S QUIT2=""
"RTN","PSNPPSMS",214,0)
 Q
"RTN","PSNPPSMS",215,0)
 ;
"RTN","PSNPPSMS",216,0)
DISMNU ;disable menu options
"RTN","PSNPPSMS",217,0)
 N PSREASON,Y,SEQ,NAM
"RTN","PSNPPSMS",218,0)
 W:'$G(PSNSCJOB) !,"Disabling mandatory options... " D NOW^%DTC S Y=% X ^DD("DD") W Y,!
"RTN","PSNPPSMS",219,0)
 S PSREASON="",PSREASON="PPS-N/NDF Update installation"
"RTN","PSNPPSMS",220,0)
 D OUT^XPDMENU("PSO LM BACKDOOR ORDERS",PSREASON)
"RTN","PSNPPSMS",221,0)
 D OUT^XPDMENU("PSO RELEASE",PSREASON)
"RTN","PSNPPSMS",222,0)
 D OUT^XPDMENU("PSO RXRPT",PSREASON)
"RTN","PSNPPSMS",223,0)
 D OUT^XPDMENU("PSNPMIS PRINT",PSREASON)
"RTN","PSNPPSMS",224,0)
 W:'$G(PSNSCJOB) !!,"Disabling user defined Scheduled Options... "
"RTN","PSNPPSMS",225,0)
 S (SEQ,IEN)="0"
"RTN","PSNPPSMS",226,0)
 F  S SEQ=$O(^PS(57.23,1,3,"B",SEQ)) Q:SEQ=""  S NAM=$$GET1^DIQ(19.2,SEQ,.01,"E") W !?5,NAM D DISOUT(NAM,PSREASON)
"RTN","PSNPPSMS",227,0)
 W:'$G(PSNSCJOB) !!,"Disabling user defined Menu Options... "
"RTN","PSNPPSMS",228,0)
 F  S SEQ=$O(^PS(57.23,1,3.1,"B",SEQ)) Q:SEQ=""  S NAM=$$GET1^DIQ(19,SEQ,.01,"E") W !?5,NAM D DISOUT(NAM,PSREASON)
"RTN","PSNPPSMS",229,0)
 W:'$G(PSNSCJOB) !!,"Disabling user defined Protocols... " ;D NOW^%DTC S Y=% X ^DD("DD") W Y,!
"RTN","PSNPPSMS",230,0)
 F  S SEQ=$O(^PS(57.23,1,3.2,"B",SEQ)) Q:SEQ=""  S NAM=$$GET1^DIQ(101,SEQ,.01,"E") W !?5,NAM D
"RTN","PSNPPSMS",231,0)
 .S $P(^ORD(101,SEQ,0),U,3)=PSREASON  ;ZQOO1
"RTN","PSNPPSMS",232,0)
 Q
"RTN","PSNPPSMS",233,0)
 ;
"RTN","PSNPPSMS",234,0)
DISOUT(NAM,PSREASON) ;
"RTN","PSNPPSMS",235,0)
 D OUT^XPDMENU(NAM,PSREASON)
"RTN","PSNPPSMS",236,0)
 Q
"RTN","PSNPPSMS",237,0)
ENABLE ;enable menu options
"RTN","PSNPPSMS",238,0)
 N Y,PSREASON
"RTN","PSNPPSMS",239,0)
 S PSREASON=""
"RTN","PSNPPSMS",240,0)
 W:'$G(PSNSCJOB) !,"Enabling options..."
"RTN","PSNPPSMS",241,0)
 D OUT^XPDMENU("PSO LM BACKDOOR ORDERS","")
"RTN","PSNPPSMS",242,0)
 D OUT^XPDMENU("PSO RELEASE","")
"RTN","PSNPPSMS",243,0)
 D OUT^XPDMENU("PSO RXRPT","")
"RTN","PSNPPSMS",244,0)
 D OUT^XPDMENU("PSNPMIS PRINT","")
"RTN","PSNPPSMS",245,0)
 D NOW^%DTC S Y=% X ^DD("DD") W:'$G(PSNSCJOB) Y,!
"RTN","PSNPPSMS",246,0)
 W:'$G(PSNSCJOB) !!,"Enabling user defined Scheduled Options... "
"RTN","PSNPPSMS",247,0)
 S (SEQ,IEN)=""
"RTN","PSNPPSMS",248,0)
 F  S SEQ=$O(^PS(57.23,1,3,"B",SEQ)) Q:SEQ=""  S NAM=$$GET1^DIQ(19.2,SEQ,.01,"E") W !?5,NAM D DISOUT(NAM,PSREASON)
"RTN","PSNPPSMS",249,0)
 W:'$G(PSNSCJOB) !!,"Enabling user defined Menu Options... "
"RTN","PSNPPSMS",250,0)
 F  S SEQ=$O(^PS(57.23,1,3.1,"B",SEQ)) Q:SEQ=""  S NAM=$$GET1^DIQ(19,SEQ,.01,"E") W !?5,NAM D DISOUT(NAM,PSREASON)
"RTN","PSNPPSMS",251,0)
 W:'$G(PSNSCJOB) !!,"Enabling user defined Protocols... "
"RTN","PSNPPSMS",252,0)
 F  S SEQ=$O(^PS(57.23,1,3.2,"B",SEQ)) Q:SEQ=""  S NAM=$$GET1^DIQ(101,SEQ,.01,"E") W !?5,NAM D
"RTN","PSNPPSMS",253,0)
 .S $P(^ORD(101,SEQ,0),U,3)=""
"RTN","PSNPPSMS",254,0)
 W !,"Options and protocols enabled: " D NOW^%DTC S Y=% X ^DD("DD") W Y,!
"RTN","PSNPPSMS",255,0)
 Q
"RTN","PSNPPSMS",256,0)
ENABLE2(NAM,PSREASON) ;
"RTN","PSNPPSMS",257,0)
 D OUT^XPDMENU(NAM,PSREASON)
"RTN","PSNPPSMS",258,0)
 Q
"RTN","PSNPPSMS",259,0)
 ;
"RTN","PSNPPSMS",260,0)
ERRORMS ;FILE ERRORS ENCOUNTERED
"RTN","PSNPPSMS",261,0)
 N PSNEFIL,PSNEIEN,PSNEEN,PSNEUFS,PSNEFLD,PSNESEQ,PSNESEQ2,PSMSGTXT,PSNEX,PSNECNT,PSNECNT2
"RTN","PSNPPSMS",262,0)
 D NOW^%DTC
"RTN","PSNPPSMS",263,0)
 S (PSNEUFS,PSNEFIL,PSNEIEN,PSNEFLD,PSNESEQ,PSNECNT,PSNECNT2,PSNEX)=""
"RTN","PSNPPSMS",264,0)
 I $D(^TMP("PSN PPSN ERR",$J))&($D(^PS(57.23,1))) F  S PSNEUFS=$O(^TMP("PSN PPSN ERR",$J,PSNEUFS)) Q:PSNEUFS=""  D
"RTN","PSNPPSMS",265,0)
 .F  S PSNEFIL=$O(^TMP("PSN PPSN ERR",$J,PSNEUFS,PSNEFIL)) Q:PSNEFIL=""  D
"RTN","PSNPPSMS",266,0)
 ..F  S PSNEIEN=$O(^TMP("PSN PPSN ERR",$J,PSNEUFS,PSNEFIL,PSNEIEN)) Q:PSNEIEN=""  D
"RTN","PSNPPSMS",267,0)
 ...F  S PSNEFLD=$O(^TMP("PSN PPSN ERR",$J,PSNEUFS,PSNEFIL,PSNEIEN,PSNEFLD)) Q:PSNEFLD=""  D
"RTN","PSNPPSMS",268,0)
 ....F  S PSNESEQ=$O(^TMP("PSN PPSN ERR",$J,PSNEUFS,PSNEFIL,PSNEIEN,PSNEFLD,PSNESEQ)) Q:PSNESEQ=""  D
"RTN","PSNPPSMS",269,0)
 .....S PSNEX=^TMP("PSN PPSN ERR",$J,PSNEUFS,PSNEFIL,PSNEIEN,PSNEFLD,PSNESEQ)
"RTN","PSNPPSMS",270,0)
 .....S PSNECNT=99999999999,PSNECNT=$O(^PS(57.23,1,5,PSNECNT),-1)
"RTN","PSNPPSMS",271,0)
 .....I '$D(PSNECNT) S ^PS(57.23,1,5,PSNECNT,2,0)="^57.23D^1^1"
"RTN","PSNPPSMS",272,0)
 .....S PSNECNT2=99999999999,PSNECNT2=$O(^PS(57.23,1,5,PSNECNT,2,PSNECNT2),-1)
"RTN","PSNPPSMS",273,0)
 .....S PSNECNT2=PSNECNT2+1
"RTN","PSNPPSMS",274,0)
 .....S ^PS(57.23,1,5,PSNECNT,2,PSNECNT2,0)=%_"^"_PSNEFIL_"^"_PSNEIEN_"^"_PSNEUFS_"^"_PSNEX
"RTN","PSNPPSMS",275,0)
 Q
"RTN","PSNPPSMS",276,0)
 ;
"RTN","PSNPPSMS",277,0)
ASK(FILE) ; check if the file has been finalized
"RTN","PSNPPSMS",278,0)
 ;LSTD - Last Download version
"RTN","PSNPPSMS",279,0)
 ;
"RTN","PSNPPSMS",280,0)
 N NFILE,LSTD,PSI
"RTN","PSNPPSMS",281,0)
 S PSI=0
"RTN","PSNPPSMS",282,0)
 S PSI=$O(^PS(57.23,1,4,"G",$P(FILE,";"),""),-1) I 'PSI Q "0^0"
"RTN","PSNPPSMS",283,0)
 I PSI S LSTD=$G(^PS(57.23,1,4,"G",$P(FILE,";"),PSI)),NFILE=FILE_";"_LSTD
"RTN","PSNPPSMS",284,0)
 I $D(^PS(57.23,1,6,"B",NFILE)) W !!,"WARNING: File has been rejected and finalized. It's not recommended to",!,?9,"reject it again."
"RTN","PSNPPSMS",285,0)
 Q PSI_"^"_LSTD
"RTN","PSNPPSMS",286,0)
 ;
"RTN","PSNPPSMS",287,0)
ASK1(FILE) ; check if the file has been previously installed
"RTN","PSNPPSMS",288,0)
 N NFILE,LSTD,LSTI,PSI
"RTN","PSNPPSMS",289,0)
 S (PSI,LSTD,LSTI)=0
"RTN","PSNPPSMS",290,0)
 S PSI=$O(^PS(57.23,1,4,"G",$P(FILE,";"),""),-1) I 'PSI Q 0
"RTN","PSNPPSMS",291,0)
 S LSTD=$G(^PS(57.23,1,4,"G",$P(FILE,";"),PSI)),NFILE=FILE_";"_LSTD
"RTN","PSNPPSMS",292,0)
 S LSTI=$O(^PS(57.23,1,5,"B",NFILE,0))
"RTN","PSNPPSMS",293,0)
 Q LSTI
"RTN","PSNPPSMS",294,0)
 ;
"RTN","PSNPPSMS",295,0)
REJUPD(FILE) ; update reject history node
"RTN","PSNPPSMS",296,0)
 K FDA
"RTN","PSNPPSMS",297,0)
 N PSI,LSTD S LSTD=1
"RTN","PSNPPSMS",298,0)
 S FDA(57.236,"+2,"_1_",",.01)=FILE D UPDATE^DIE("","FDA")
"RTN","PSNPPSMS",299,0)
 K IEN6,%,FDA
"RTN","PSNPPSMS",300,0)
 S IEN6=$O(^PS(57.23,1,6,"B",FILE,""),-1)
"RTN","PSNPPSMS",301,0)
 D NOW^%DTC
"RTN","PSNPPSMS",302,0)
 S FDA(57.236,IEN6_","_1_",",1)=%,FDA(57.236,IEN6_","_1_",",2)=DUZ D UPDATE^DIE("","FDA")
"RTN","PSNPPSMS",303,0)
 Q
"RTN","PSNPPSNC")
0^18^B14201170^n/a
"RTN","PSNPPSNC",1,0)
PSNPPSNC ;HP/SXT-PPSN update NDF data ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSNC",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNPPSNC",3,0)
 ;
"RTN","PSNPPSNC",4,0)
 ; taken mostly from: PSSHTTP ;WOIFO/AV - REENGINERING Sends XML Request to PEPS via HWSC ;09/20/07
"RTN","PSNPPSNC",5,0)
 ;
"RTN","PSNPPSNC",6,0)
 Q
"RTN","PSNPPSNC",7,0)
 ;;
"RTN","PSNPPSNC",8,0)
 ;
"RTN","PSNPPSNC",9,0)
SEND(STATUS,VERSION,MESSAGE) ;
"RTN","PSNPPSNC",10,0)
 ;
"RTN","PSNPPSNC",11,0)
 NEW TIME,SITE,XML,OK,DOCHAND
"RTN","PSNPPSNC",12,0)
 ;TIME FORMAT:  yyyy/mm/ddThh:mm:ss i.e. - 2014/3/24T13:20:27
"RTN","PSNPPSNC",13,0)
 S TIME=$$HTE^XLFDT($H,7)
"RTN","PSNPPSNC",14,0)
 S TIME=$TR(TIME,"@","T")
"RTN","PSNPPSNC",15,0)
 S SITE=$P($$SITE^VASITE(),"^")
"RTN","PSNPPSNC",16,0)
 S XML="<vistaUpdateStatus><message>"_MESSAGE_"</message><site>"_SITE_"</site><status>"_STATUS_"</status>"
"RTN","PSNPPSNC",17,0)
 S XML=XML_"<timeApplied>"_TIME_"</timeApplied><version>"_VERSION_"</version></vistaUpdateStatus>"
"RTN","PSNPPSNC",18,0)
 S OK=$$PPSNPOST(.DOCHAND,XML)
"RTN","PSNPPSNC",19,0)
 Q:'OK 0
"RTN","PSNPPSNC",20,0)
 Q 1
"RTN","PSNPPSNC",21,0)
 ; 
"RTN","PSNPPSNC",22,0)
TEST ;
"RTN","PSNPPSNC",23,0)
 S X=$$SEND("STARTED","PPS_1PRV_11NEW.DAT","")
"RTN","PSNPPSNC",24,0)
 W !,$S(X:"Sent",1:"Failed")
"RTN","PSNPPSNC",25,0)
 Q
"RTN","PSNPPSNC",26,0)
 ;
"RTN","PSNPPSNC",27,0)
 N RESPONSE,X S (X,RESPONSE)=""
"RTN","PSNPPSNC",28,0)
 S XML="<vistaUpdateStatus><message></message><site>512</site><status>STARTED</status>"
"RTN","PSNPPSNC",29,0)
 S XML=XML_"<timeApplied>2014-02-25T19:32:39.911-05:00</timeApplied><version>PPS_0PRV_6NEW.DAT</version></vistaUpdateStatus>"
"RTN","PSNPPSNC",30,0)
 ;S XML=XML_"<vistaUpdateStatus><version>PPS_5PRV_6NEW.DAT</version><site>512</site><status>COMPLETED</status><message></message></vistaUpdateStatus"
"RTN","PSNPPSNC",31,0)
 S X="TEST"
"RTN","PSNPPSNC",32,0)
 U 0 W !,"calling function"
"RTN","PSNPPSNC",33,0)
 S RESPONSE=$$PPSNPOST(.X,XML)
"RTN","PSNPPSNC",34,0)
 Q
"RTN","PSNPPSNC",35,0)
 ;
"RTN","PSNPPSNC",36,0)
PPSNPOST(DOCHAND,XML) ;
"RTN","PSNPPSNC",37,0)
 ; @DESC Sends an HTTP request to PEPS as a POST
"RTN","PSNPPSNC",38,0)
 ;
"RTN","PSNPPSNC",39,0)
 ; @DOCHAND Handle to XML document
"RTN","PSNPPSNC",40,0)
 ; @XML XML request as string
"RTN","PSNPPSNC",41,0)
 ;
"RTN","PSNPPSNC",42,0)
 ; @RETURNS A handle to response XML document
"RTN","PSNPPSNC",43,0)
 ;          1 for success, 0 for failure
"RTN","PSNPPSNC",44,0)
 ;
"RTN","PSNPPSNC",45,0)
 NEW PSS,PSSERR,$ETRAP,$ESTACK
"RTN","PSNPPSNC",46,0)
 ;
"RTN","PSNPPSNC",47,0)
 ; Set error trap
"RTN","PSNPPSNC",48,0)
 SET $ETRAP="DO ERROR^PSNPPSNC"
"RTN","PSNPPSNC",49,0)
 ;
"RTN","PSNPPSNC",50,0)
 SET PSS("server")="PPSN"
"RTN","PSNPPSNC",51,0)
 ;SET PSS("server")="TIM" ;DEBUG
"RTN","PSNPPSNC",52,0)
 SET PSS("webserviceName")="UPDATE_STATUS"
"RTN","PSNPPSNC",53,0)
 SET PSS("path")="status"
"RTN","PSNPPSNC",54,0)
 ;
"RTN","PSNPPSNC",55,0)
 SET PSS("parameterName")="xmlRequest"
"RTN","PSNPPSNC",56,0)
 SET PSS("parameterValue")=XML
"RTN","PSNPPSNC",57,0)
 K ^TMP($JOB,"OUT","EXCEPTION")
"RTN","PSNPPSNC",58,0)
 ;
"RTN","PSNPPSNC",59,0)
 ; Get instance of client REST request object
"RTN","PSNPPSNC",60,0)
 ;***W !,"get instance"
"RTN","PSNPPSNC",61,0)
 SET PSS("restObject")=$$GETREST^XOBWLIB(PSS("webserviceName"),PSS("server"))
"RTN","PSNPPSNC",62,0)
 IF $DATA(^TMP($JOB,"OUT","EXCEPTION"))>0 QUIT 0
"RTN","PSNPPSNC",63,0)
 ;
"RTN","PSNPPSNC",64,0)
 ; Insert XML as parameter
"RTN","PSNPPSNC",65,0)
 ;*** W !,"insert XML parameter"
"RTN","PSNPPSNC",66,0)
 DO PSS("restObject").InsertFormData(PSS("parameterName"),PSS("parameterValue"))
"RTN","PSNPPSNC",67,0)
 IF $DATA(^TMP($JOB,"OUT","EXCEPTION"))>0 QUIT 0
"RTN","PSNPPSNC",68,0)
 ;
"RTN","PSNPPSNC",69,0)
 ; Execute HTTP Post method
"RTN","PSNPPSNC",70,0)
 ;***W !,"execute POST ?" R Z I Z'="Y" B
"RTN","PSNPPSNC",71,0)
 SET PSS("postResult")=$$POST^XOBWLIB(PSS("restObject"),PSS("path"),.PSSERR)
"RTN","PSNPPSNC",72,0)
 IF $DATA(^TMP($JOB,"OUT","EXCEPTION"))>0 QUIT 0
"RTN","PSNPPSNC",73,0)
 ;
"RTN","PSNPPSNC",74,0)
 DO:PSS("postResult")
"RTN","PSNPPSNC",75,0)
 . SET PSS("result")=##class(gov.va.med.pre.ws.XMLHandler).getHandleToXmlDoc(PSS("restObject").HttpResponse.Data, .DOCHAND)
"RTN","PSNPPSNC",76,0)
 . QUIT
"RTN","PSNPPSNC",77,0)
 ;
"RTN","PSNPPSNC",78,0)
 DO:'PSS("postResult")
"RTN","PSNPPSNC",79,0)
 . SET ^TMP($JOB,"OUT","EXCEPTION")="Unable to make http request."
"RTN","PSNPPSNC",80,0)
 . SET PSS("result")=0
"RTN","PSNPPSNC",81,0)
 . QUIT
"RTN","PSNPPSNC",82,0)
 ;
"RTN","PSNPPSNC",83,0)
 QUIT PSS("result")
"RTN","PSNPPSNC",84,0)
 ;;
"RTN","PSNPPSNC",85,0)
ERROR ;
"RTN","PSNPPSNC",86,0)
 ; @DESC Handles error during request to PEPS via webservice.
"RTN","PSNPPSNC",87,0)
 ;
"RTN","PSNPPSNC",88,0)
 ; Depends on GLOBAL variable PSSERR to be set in previous call.
"RTN","PSNPPSNC",89,0)
 ;
"RTN","PSNPPSNC",90,0)
 ; @RETURNS Nothing. Value store in global.
"RTN","PSNPPSNC",91,0)
 ;
"RTN","PSNPPSNC",92,0)
 NEW ERRARRAY
"RTN","PSNPPSNC",93,0)
 ;
"RTN","PSNPPSNC",94,0)
 ; Get error object from Error Object Factory
"RTN","PSNPPSNC",95,0)
 IF $GET(PSSERR)="" SET PSSERR=$$EOFAC^XOBWLIB()
"RTN","PSNPPSNC",96,0)
 ; Store the error object in the error array
"RTN","PSNPPSNC",97,0)
 DO ERR2ARR^XOBWLIB(PSSERR,.ERRARRAY)
"RTN","PSNPPSNC",98,0)
 ;
"RTN","PSNPPSNC",99,0)
 ; Parse out the error text and store in global
"RTN","PSNPPSNC",100,0)
 SET ^TMP($JOB,"OUT","EXCEPTION")=$$GETTEXT(.ERRARRAY)
"RTN","PSNPPSNC",101,0)
 ;
"RTN","PSNPPSNC",102,0)
 ; Set ecode to empty to return to calling function
"RTN","PSNPPSNC",103,0)
 SET $ECODE=""
"RTN","PSNPPSNC",104,0)
 ;
"RTN","PSNPPSNC",105,0)
 QUIT
"RTN","PSNPPSNC",106,0)
 ;;
"RTN","PSNPPSNC",107,0)
GETTEXT(ERRARRAY) ;
"RTN","PSNPPSNC",108,0)
 ; @DESC Gets the error text from the array
"RTN","PSNPPSNC",109,0)
 ;
"RTN","PSNPPSNC",110,0)
 ; @ERRARRAY Error array stores error in format defined by web service product.
"RTN","PSNPPSNC",111,0)
 ;
"RTN","PSNPPSNC",112,0)
 ; @RETURNS Error info as a single string
"RTN","PSNPPSNC",113,0)
 ;
"RTN","PSNPPSNC",114,0)
 NEW PSS
"RTN","PSNPPSNC",115,0)
 ;
"RTN","PSNPPSNC",116,0)
 ; Loop through the text subscript of error array and concatenate
"RTN","PSNPPSNC",117,0)
 SET PSS("errorText")=""
"RTN","PSNPPSNC",118,0)
 SET PSS("I")=""
"RTN","PSNPPSNC",119,0)
 FOR  SET PSS("I")=$ORDER(ERRARRAY("text",PSS("I"))) QUIT:PSS("I")=""  DO
"RTN","PSNPPSNC",120,0)
 . SET PSS("errorText")=PSS("errorText")_ERRARRAY("text",PSS("I"))
"RTN","PSNPPSNC",121,0)
 . QUIT
"RTN","PSNPPSNC",122,0)
 ;
"RTN","PSNPPSNC",123,0)
 QUIT PSS("errorText")
"RTN","PSNPPSNC",124,0)
 ;;
"RTN","PSNPPSNF")
0^17^B92527436^n/a
"RTN","PSNPPSNF",1,0)
PSNPPSNF ;HP/MJE-PPSN update NDF data ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSNF",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNPPSNF",3,0)
 ;Reference to ^%ZISH supported by DBIA #2320
"RTN","PSNPPSNF",4,0)
 ;Reference to ^XUTMOPT supported by DBIA #1472
"RTN","PSNPPSNF",5,0)
 ;
"RTN","PSNPPSNF",6,0)
 ;This routine is used to locate and move PPSN NDF update host files into Cache for processing
"RTN","PSNPPSNF",7,0)
 Q
"RTN","PSNPPSNF",8,0)
 ;
"RTN","PSNPPSNF",9,0)
MFIND ;Entry point for menu option PSNUPDT for immediate PPS-N updates
"RTN","PSNPPSNF",10,0)
 N PSENTER,DIE,DA,DR,ERRCHK,PSIMHERE,PSNLEG,PSNLEGF,PSNHLD2
"RTN","PSNPPSNF",11,0)
 I $$GET1^DIQ(57.23,1,10,"I")="Y" D  Q
"RTN","PSNPPSNF",12,0)
 .Q:$G(PSNSCJOB)
"RTN","PSNPPSNF",13,0)
 .W !!,"A PPS-N/NDF file install is already in progress.  Please try again later."
"RTN","PSNPPSNF",14,0)
 .R !!,"Press enter to continue...",PSENTER:120
"RTN","PSNPPSNF",15,0)
 ;
"RTN","PSNPPSNF",16,0)
 I '$D(^XUSEC("PSN PPS ADMIN",DUZ))&('$G(PSNSCJOB)) D
"RTN","PSNPPSNF",17,0)
 .W !!,"You do not have the appropriate security key to use this option"
"RTN","PSNPPSNF",18,0)
 .W !,"please contact your ADPAC to resolve this issue.",!
"RTN","PSNPPSNF",19,0)
 .S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNF",20,0)
 I '$D(^XUSEC("PSN PPS ADMIN",DUZ)) Q
"RTN","PSNPPSNF",21,0)
 S PSNLEGF="",PSNLEGF=$$LEGACY^PSNPPSDL() I PSNLEGF Q
"RTN","PSNPPSNF",22,0)
 ;
"RTN","PSNPPSNF",23,0)
 D CHKD^PSNPPSDL ;update Unix directory if needed and create it if entry does not exist.
"RTN","PSNPPSNF",24,0)
 ;
"RTN","PSNPPSNF",25,0)
 I '$G(PSNSCJOB) D  Q:'Y
"RTN","PSNPPSNF",26,0)
 .W !!!,"Warning: The NDF update should only be done during off duty hours!"
"RTN","PSNPPSNF",27,0)
 .W !,"         Installation may take up to 30 minutes, and the following options"
"RTN","PSNPPSNF",28,0)
 .W !,"         will automatically be disabled during installation then enabled"
"RTN","PSNPPSNF",29,0)
 .W !,"         once installation has completed."
"RTN","PSNPPSNF",30,0)
 .W !!,"           * Print A PMI Sheet      * Patient Prescription Processing"
"RTN","PSNPPSNF",31,0)
 .W !,"           * Release Medication     * Reprint an Outpatient Rx Label",!
"RTN","PSNPPSNF",32,0)
 .K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNF",33,0)
 .S DIR("A")="Are you sure you want to immediately begin an NDF Update" W !
"RTN","PSNPPSNF",34,0)
 .S DIR("B")="NO"
"RTN","PSNPPSNF",35,0)
 .D ^DIR
"RTN","PSNPPSNF",36,0)
 .I 'Y Q
"RTN","PSNPPSNF",37,0)
 ;
"RTN","PSNPPSNF",38,0)
FIND ;Get list of files, quit if flag set to disable update function
"RTN","PSNPPSNF",39,0)
 ;I $P(^PS(57.23,1,0),"^",4)=0 Q
"RTN","PSNPPSNF",40,0)
 N A1,B1,B2,I,X2,X22,II,XX,QUEST,QUIT2,PSRUNCNT,PSGRP,REJFILE,INSFILE
"RTN","PSNPPSNF",41,0)
 K ^TMP("PSN PPSN PARSED",$J)
"RTN","PSNPPSNF",42,0)
 N PSNATYP S PSNATYP="",PSNATYP=$P(^PS(59.7,1,10),"^",12)
"RTN","PSNPPSNF",43,0)
 S A1("PPS_*")="",(PSNFND,PSNFLG,QUIT2,PSRUNCNT)=0,COMM=1
"RTN","PSNPPSNF",44,0)
 I $D(^TMP("PSN PPSN READ",$J)) K ^TMP("PSN PPSN READ",$J)
"RTN","PSNPPSNF",45,0)
 S Y=$$LIST^%ZISH($$GETD^PSNFTP(),$NA(A1),$NA(B2))
"RTN","PSNPPSNF",46,0)
 S I="" F  S I=$O(B2(I)) Q:I=""  S B1(99999999+(+$P(I,"_",2)))=I
"RTN","PSNPPSNF",47,0)
 K B2
"RTN","PSNPPSNF",48,0)
CKDIR ;
"RTN","PSNPPSNF",49,0)
 G EXIT:'$D(B1)
"RTN","PSNPPSNF",50,0)
 I '$G(PSNSCJOB) D QUEST^PSNPPSMS G EXIT:$G(QUIT2)
"RTN","PSNPPSNF",51,0)
 ;
"RTN","PSNPPSNF",52,0)
 W !,"Please stand-by NDF update processing can take around 30 minutes..."
"RTN","PSNPPSNF",53,0)
 S DIE="^PS(57.23,",DA=1,DR="10///Y" D ^DIE K DIE,DA,DR
"RTN","PSNPPSNF",54,0)
 ;
"RTN","PSNPPSNF",55,0)
 S X2="" F  S X2=$O(B1(X2)) Q:X2=""!(+$G(REJFILE))  S X22=$G(B1(X2)) D  G:COMM=0 EXIT
"RTN","PSNPPSNF",56,0)
 .I $P(X22,"_")="PPS"&(+$P(X22,"_",2)=$P(^PS(57.23,1,0),"^",3)) D
"RTN","PSNPPSNF",57,0)
 ..S (PSNFND,PSNFLG)=1 S PSNHLD=X22
"RTN","PSNPPSNF",58,0)
 ..D READ I +$G(REJFILE) Q
"RTN","PSNPPSNF",59,0)
 ..I '$G(PSNSCJOB),'+INSFILE Q
"RTN","PSNPPSNF",60,0)
 ..I '$G(PSNSCJOB) D
"RTN","PSNPPSNF",61,0)
 ...W !,"Installation completed"_$S($G(ERRCHK):" with errors.  See error mail message",1:"")_".",!
"RTN","PSNPPSNF",62,0)
 ...D CTRKDL^PSNPPSMS("Installation completed"_$S($G(ERRCHK):" with errors.  See error mail message",1:"")_".")
"RTN","PSNPPSNF",63,0)
 ..I $O(B1(X22))]"",$D(^TMP("PSN PPSN READ",$J)) W:'$G(PSNSCJOB) !,"Purging background work files before starting the next install...",! K ^TMP("PSN PPSN READ",$J),^TMP("PSN PPSN PARSED",$J)
"RTN","PSNPPSNF",64,0)
 I 'PSNFND W !,"There were no PPS-N update files to install.",!
"RTN","PSNPPSNF",65,0)
 ;I PSNFLG S PSNFLG=0 G CKDIR
"RTN","PSNPPSNF",66,0)
EXIT ;
"RTN","PSNPPSNF",67,0)
 ;D ENABLE^PSNPPSMS
"RTN","PSNPPSNF",68,0)
 K DIE,DA,DR
"RTN","PSNPPSNF",69,0)
 S DIE="^PS(57.23,",DA=1,DR="10///N" D ^DIE K DIE,DA,DR
"RTN","PSNPPSNF",70,0)
 K A1,B2,B1,^TMP("PSN PPSN READ",$J),^TMP("PSN PPSN PARSED",$J)
"RTN","PSNPPSNF",71,0)
 K X2,X22,OLDNDF,COMM,I,I1,PSNFLG,PSNFND,PSNHLD,PSNHLD1,XX,OLDNDF,XPDIDTOT
"RTN","PSNPPSNF",72,0)
 K Z11,Z12,Z13,Z14,Z15,Z16,Z17,Z18,Z19,Z191,Z192,Z193,Z194
"RTN","PSNPPSNF",73,0)
 K Z21,Z22,Z23,Z24,Z25,Z26,Z27,Z28,Z29,Z291,Z292,Z293,Z294
"RTN","PSNPPSNF",74,0)
 K Z31,Z32,Z33,Z34,Z35,Z36,Z37,Z38,Z39,Z391,Z392,Z393,Z394
"RTN","PSNPPSNF",75,0)
EXIT2 ;
"RTN","PSNPPSNF",76,0)
 Q
"RTN","PSNPPSNF",77,0)
 ;
"RTN","PSNPPSNF",78,0)
READ ;Read in file
"RTN","PSNPPSNF",79,0)
 S (INSFILE,REJFILE)=""
"RTN","PSNPPSNF",80,0)
 S REJFILE=$$REJCHK($P(PSNHLD,";")) Q:+REJFILE
"RTN","PSNPPSNF",81,0)
 S INSFILE=$$INSTCHK($P(PSNHLD,";"))
"RTN","PSNPPSNF",82,0)
 I '+INSFILE,'$G(PSNSCJOB) W !!,$P(PSNHLD,";")_" has not been installed.",! Q
"RTN","PSNPPSNF",83,0)
 W:'$G(PSNSCJOB) !!,"Beginning install for "_$P(X22,";"),!
"RTN","PSNPPSNF",84,0)
 I PSNATYP="N" I $$NDFK(PSNHLD) D NDFKP^PSNPPSNK  ;purge NDFK file before install
"RTN","PSNPPSNF",85,0)
 D XTMP
"RTN","PSNPPSNF",86,0)
 N XUMF,XPDGREF,NDFOK
"RTN","PSNPPSNF",87,0)
 S (XUMF,XPDGREF,NDFOK)=1
"RTN","PSNPPSNF",88,0)
 K CTRLIEN
"RTN","PSNPPSNF",89,0)
 S CTRLIEN=$O(^PS(57.23,"B","PPSN",""))
"RTN","PSNPPSNF",90,0)
 K FDA
"RTN","PSNPPSNF",91,0)
 S (PSNHLD2,FDA(57.231,"+2,"_1_",",.01))=$P(PSNHLD,";")_";"_$P(INSFILE,"^",2)
"RTN","PSNPPSNF",92,0)
 D UPDATE^DIE("","FDA")
"RTN","PSNPPSNF",93,0)
 K CTRLXIEN
"RTN","PSNPPSNF",94,0)
 S CTRLXIEN=$O(^PS(57.23,1,5,"B",$P(PSNHLD,";")_";"_$P(INSFILE,"^",2),""),-1)
"RTN","PSNPPSNF",95,0)
 K FDA,%
"RTN","PSNPPSNF",96,0)
 D NOW^%DTC
"RTN","PSNPPSNF",97,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",1)=%
"RTN","PSNPPSNF",98,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSNF",99,0)
 K FDA
"RTN","PSNPPSNF",100,0)
 S FDA(57.23,CTRLIEN_",",30)=1
"RTN","PSNPPSNF",101,0)
 D FILE^DIE("","FDA")
"RTN","PSNPPSNF",102,0)
 K FDA
"RTN","PSNPPSNF",103,0)
 ;
"RTN","PSNPPSNF",104,0)
 W:'$G(PSNSCJOB) !,"Importing the Update file into VistA...",!
"RTN","PSNPPSNF",105,0)
 ;write comm here to send message - file found processing has STARTED
"RTN","PSNPPSNF",106,0)
 N PSERRMSG,PSMSGTXT,PSRGP,XMTEXT,XMY,PSNSITET,PSNZISH
"RTN","PSNPPSNF",107,0)
 S PSNSITET=$P($G(^PS(59.7,1,10)),"^",12)
"RTN","PSNPPSNF",108,0)
 D CTRKDL^PSNPPSMS("Install STARTED message sent to PPS-N")
"RTN","PSNPPSNF",109,0)
 I PSNSITET="P" S COMM=$$SEND^PSNPPSNC("STARTED",$P(PSNHLD,";"),"")
"RTN","PSNPPSNF",110,0)
 S COMM=1
"RTN","PSNPPSNF",111,0)
 ;
"RTN","PSNPPSNF",112,0)
 I COMM=0 D  Q
"RTN","PSNPPSNF",113,0)
 .D CTRKDL^PSNPPSMS("Communication with PPS-N system is down or the station number is invalid.")
"RTN","PSNPPSNF",114,0)
 .S PSERRMSG="Install cannot be completed."
"RTN","PSNPPSNF",115,0)
 .S PSMSGTXT="Communication with PPS-N system is down or the station number is invalid."
"RTN","PSNPPSNF",116,0)
 .I '$G(PSNSCJOB) W !,PSERRMSG,!,PSMSGTXT,! R !!,"Press enter to continue...",PSENTER:120
"RTN","PSNPPSNF",117,0)
 .D MSGTEXT0^PSNFTP($P(PSNHLD,";"),PSERRMSG,.PSMSGTXT)
"RTN","PSNPPSNF",118,0)
 .S XMTEXT="PSMSGTXT("
"RTN","PSNPPSNF",119,0)
 .S PSGRP="",PSGRP=$$GET1^DIQ(57.23,1,5) I PSGRP'="" S XMY($$MG^PSNPPSMG(PSGRP))=""
"RTN","PSNPPSNF",120,0)
 .S PSGRP="",PSGRP=$$GET1^DIQ(57.23,1,6) I PSGRP'="" S XMY($$MG^PSNPPSMG(PSGRP))=""
"RTN","PSNPPSNF",121,0)
 .N DIFROM D ^XMD
"RTN","PSNPPSNF",122,0)
 ;
"RTN","PSNPPSNF",123,0)
 S PSNZISH=$NA(^TMP("PSN PPSN READ",$J,1)) S Y=$$FTG^%ZISH($$GETD^PSNFTP(),X22,PSNZISH,3)
"RTN","PSNPPSNF",124,0)
 ;
"RTN","PSNPPSNF",125,0)
 D CTRKDL^PSNPPSMS("Parsing data and creating TMP file")
"RTN","PSNPPSNF",126,0)
 W:'$G(PSNSCJOB) !,"Parsing the data...",!
"RTN","PSNPPSNF",127,0)
MOVE ;Move data to ^TMP for call to update
"RTN","PSNPPSNF",128,0)
 ;
"RTN","PSNPPSNF",129,0)
 D CTRKDL^PSNPPSMS("Reading update file into TMP('PSN PPSN READ',$J) global.")
"RTN","PSNPPSNF",130,0)
 N Z11,Z12,Z13,Z14,Z15,Z16,Z17,Z18,Z19,Z191,Z192,Z193,Z194,Z21,Z22,Z23,Z24,Z25,Z26,Z27,Z28,Z29,Z291,Z292,Z293,Z294,Z31,Z32,Z33,Z34,Z35,Z36,Z37,Z38,Z39,Z391,Z392,Z393,Z394
"RTN","PSNPPSNF",131,0)
 S (Z11,Z12,Z13,Z14,Z15,Z16,Z17,Z18,Z19,Z191,Z192,Z193,Z194)=0
"RTN","PSNPPSNF",132,0)
 S (Z21,Z22,Z23,Z24,Z25,Z26,Z27,Z28,Z29,Z291,Z292,Z293,Z294)=0
"RTN","PSNPPSNF",133,0)
 S (Z31,Z32,Z33,Z34,Z35,Z36,Z37,Z38,Z39,Z391,Z392,Z393,Z394)=0
"RTN","PSNPPSNF",134,0)
 D PARSE^PSNPPSNP
"RTN","PSNPPSNF",135,0)
 ;
"RTN","PSNPPSNF",136,0)
READ2 ;
"RTN","PSNPPSNF",137,0)
 ;- THIS IS WHERE THE CALL TO UPDATE IS ADDED
"RTN","PSNPPSNF",138,0)
 D CTRKDL^PSNPPSMS("Disabling menu options")
"RTN","PSNPPSNF",139,0)
 D DISMNU^PSNPPSMS  ;disable menu options
"RTN","PSNPPSNF",140,0)
 D CTRKDL^PSNPPSMS("Storing PMI data")
"RTN","PSNPPSNF",141,0)
 W:'$G(PSNSCJOB) !,"Storing PMI data...",!
"RTN","PSNPPSNF",142,0)
 D PMIUPDT^PSNPPSNV
"RTN","PSNPPSNF",143,0)
 D CTRKDL^PSNPPSMS("PMI data update complete and storing rest of NDF files.")
"RTN","PSNPPSNF",144,0)
 W:'$G(PSNSCJOB) !,"Storing data into the rest of the NDF files...",!
"RTN","PSNPPSNF",145,0)
REDO ;
"RTN","PSNPPSNF",146,0)
 D ^PSNPPSNU
"RTN","PSNPPSNF",147,0)
 D CTRKDL^PSNPPSMS("Processing data transactions")
"RTN","PSNPPSNF",148,0)
 D DATA^PSNPPSNV
"RTN","PSNPPSNF",149,0)
 I PSNFND S $P(^PS(57.23,1,0),"^",3)=+$P(PSNHLD,"_",3)
"RTN","PSNPPSNF",150,0)
COMM ;
"RTN","PSNPPSNF",151,0)
 N COMM,INSTIEN,COMMCNT,COMMAGN S (ERRCHK,COMM,INSTIEN,COMMCNT,COMMAGN)=""
"RTN","PSNPPSNF",152,0)
 S INSTIEN=$O(^PS(57.23,1,5,"B",PSNHLD2,INSTIEN),-1)
"RTN","PSNPPSNF",153,0)
 I INSTIEN'="",$D(^PS(57.23,1,5,INSTIEN,2)) S ERRCHK=1
"RTN","PSNPPSNF",154,0)
 ;write comm here to send message - COMPLETED processing
"RTN","PSNPPSNF",155,0)
 D CTRKDL^PSNPPSMS("Checking for errors and sending install completion message")
"RTN","PSNPPSNF",156,0)
 W:'$G(PSNSCJOB) !,"Sending install completion message to PPS-N...",!
"RTN","PSNPPSNF",157,0)
COMMAGN ;
"RTN","PSNPPSNF",158,0)
 I PSNSITET="Q"!(PSNSITET="P") S COMM=$$SEND^PSNPPSNC("COMPLETED",$P(PSNHLD,";"),""),COMMAGN=COMMAGN+1
"RTN","PSNPPSNF",159,0)
 I PSNSITET="T"!(PSNSITET="S")!(PSNSITET="N") S COMM=1
"RTN","PSNPPSNF",160,0)
 I 'COMM&(COMMAGN<3) H 3 W !,"Install completion message could not be sent to PPS-N.  Trying again... " G COMMAGN
"RTN","PSNPPSNF",161,0)
 I 'COMM W !,"The install completion message was not accepted by PPS-N.  Please contact ",!,"the National Help Desk.",!
"RTN","PSNPPSNF",162,0)
 I $G(ERRCHK) D IERRMSG^PSNPPSMG G COMM2
"RTN","PSNPPSNF",163,0)
 I (PSNSITET="Q"!(PSNSITET="P"))&($D(^TMP("PSN PPSN ERR",$J))) D  G COMM2
"RTN","PSNPPSNF",164,0)
 .D CTRKDL^PSNPPSMS("Install completed but completion message was not accepted by PPS-N. Call the National Help Desk.")
"RTN","PSNPPSNF",165,0)
 .W !,?5,"*****************************************************************"
"RTN","PSNPPSNF",166,0)
 .W !?5,"ERROR: ",$P(COMM,"^",2)
"RTN","PSNPPSNF",167,0)
 .W !?13,"The update file completed installation but the completion"
"RTN","PSNPPSNF",168,0)
 .W !?13,"message was not accepted by PPS-N."
"RTN","PSNPPSNF",169,0)
 .W !!?13,"Contact the National Help Desk or enter a ticket."
"RTN","PSNPPSNF",170,0)
 .D COMMSG^PSNPPSMG
"RTN","PSNPPSNF",171,0)
 .W !,?5,"*****************************************************************"
"RTN","PSNPPSNF",172,0)
 D SMSG^PSNPPSMG
"RTN","PSNPPSNF",173,0)
 D CTRKDL^PSNPPSMS("Installed successfully")
"RTN","PSNPPSNF",174,0)
 K ^XTMP("PSN PPS VERIFY",$J,PSNHLD)
"RTN","PSNPPSNF",175,0)
 ;
"RTN","PSNPPSNF",176,0)
COMM2 ;
"RTN","PSNPPSNF",177,0)
 K FDA
"RTN","PSNPPSNF",178,0)
 S FDA(57.23,CTRLIEN_",",30)=0
"RTN","PSNPPSNF",179,0)
 D FILE^DIE("","FDA")
"RTN","PSNPPSNF",180,0)
 K FDA,%
"RTN","PSNPPSNF",181,0)
 D NOW^%DTC
"RTN","PSNPPSNF",182,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",2)=%
"RTN","PSNPPSNF",183,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSNF",184,0)
 K FDA
"RTN","PSNPPSNF",185,0)
 K ^TMP("PSN PPSN PARSED",$J)
"RTN","PSNPPSNF",186,0)
 ; Restarting options/protocols which were paused
"RTN","PSNPPSNF",187,0)
 D CTRKDL^PSNPPSMS("Enabling options/protocols")
"RTN","PSNPPSNF",188,0)
 D RESOP^PSNPPSMS
"RTN","PSNPPSNF",189,0)
 Q
"RTN","PSNPPSNF",190,0)
 ;
"RTN","PSNPPSNF",191,0)
NDF ;Entry point for NDFMS
"RTN","PSNPPSNF",192,0)
 N PSNPPSNF S PSNPPSNF=1
"RTN","PSNPPSNF",193,0)
 D MFIND^PSNPPSNF
"RTN","PSNPPSNF",194,0)
 Q
"RTN","PSNPPSNF",195,0)
 ;
"RTN","PSNPPSNF",196,0)
SCHED ;tasked job entry point
"RTN","PSNPPSNF",197,0)
 N PSNSCJOB
"RTN","PSNPPSNF",198,0)
 Q:$$GET1^DIQ(57.23,1,10,"I")="Y"
"RTN","PSNPPSNF",199,0)
 S PSNSCJOB=1
"RTN","PSNPPSNF",200,0)
 G FIND
"RTN","PSNPPSNF",201,0)
 Q
"RTN","PSNPPSNF",202,0)
 ;
"RTN","PSNPPSNF",203,0)
XTMP ; task monitoring job to report error if update not finished within 1 hour
"RTN","PSNPPSNF",204,0)
 N PSNOW,PSNOW1,PSNST
"RTN","PSNPPSNF",205,0)
 S PSNOW=$$NOW^XLFDT,PSNOW1=$$FMADD^XLFDT(PSNOW,1)
"RTN","PSNPPSNF",206,0)
 S ^XTMP("PSN PPS VERIFY",$J,PSNHLD,0)=PSNOW1_"^"_PSNOW_"^PPS-N Monitoring^"_$J_"^"_PSNHLD_"^"_$G(DUZ)
"RTN","PSNPPSNF",207,0)
 S PSNST=$$FMADD^XLFDT(PSNOW,0,0,65)
"RTN","PSNPPSNF",208,0)
 W " Background monitoring started: "
"RTN","PSNPPSNF",209,0)
 D RESCH^XUTMOPT("PSN PPS INSTALL VERIFY",PSNST,,,"L")
"RTN","PSNPPSNF",210,0)
 Q
"RTN","PSNPPSNF",211,0)
NDFK(PSNHLD) ; flag to proceed with purging NDFK file
"RTN","PSNPPSNF",212,0)
 N FLG,NODE,PSI S FLG=1
"RTN","PSNPPSNF",213,0)
 S PSI=$O(^PS(57.23,1,5,"B",PSNHLD,""),-1) I PSI D
"RTN","PSNPPSNF",214,0)
 . S NODE=$G(^PS(57.23,1,5,PSI)) I '$P(NODE,"^",3) S FLG=0
"RTN","PSNPPSNF",215,0)
 Q FLG
"RTN","PSNPPSNF",216,0)
 ;
"RTN","PSNPPSNF",217,0)
REJCHK(FILE) ; check if the file has been rejected & finalized
"RTN","PSNPPSNF",218,0)
 ;LSTD - Last Download version
"RTN","PSNPPSNF",219,0)
 ;
"RTN","PSNPPSNF",220,0)
 N NFILE,LSTD,PSI
"RTN","PSNPPSNF",221,0)
 S (PSI,LSTD)=0
"RTN","PSNPPSNF",222,0)
 S PSI=$O(^PS(57.23,1,4,"G",$P(FILE,";"),""),-1) I 'PSI Q "0^0"
"RTN","PSNPPSNF",223,0)
 I PSI S LSTD=$G(^PS(57.23,1,4,"G",$P(FILE,";"),PSI)),NFILE=FILE_";"_LSTD
"RTN","PSNPPSNF",224,0)
 I $D(^PS(57.23,1,6,"B",NFILE)) D  Q PSI_"^"_LSTD
"RTN","PSNPPSNF",225,0)
 .W !!,"WARNING: File has been rejected and finalized. Install is not allowed for it." D
"RTN","PSNPPSNF",226,0)
 .W !,?9,"Installation STOPPED"
"RTN","PSNPPSNF",227,0)
 Q "0^0"
"RTN","PSNPPSNF",228,0)
 ;
"RTN","PSNPPSNF",229,0)
INSTCHK(FILE) ; check if the file has been previously installed
"RTN","PSNPPSNF",230,0)
 ;LSTD - Last Download version
"RTN","PSNPPSNF",231,0)
 ;
"RTN","PSNPPSNF",232,0)
 N NFILE,LSTD,PSI,Y
"RTN","PSNPPSNF",233,0)
 S (PSI,Y)=0
"RTN","PSNPPSNF",234,0)
 S PSI=$O(^PS(57.23,1,4,"G",$P(FILE,";"),""),-1) I 'PSI Q "0^1"
"RTN","PSNPPSNF",235,0)
 I PSI S LSTD=$G(^PS(57.23,1,4,"G",$P(FILE,";"),PSI)),NFILE=FILE_";"_LSTD
"RTN","PSNPPSNF",236,0)
 I '$D(^PS(57.23,1,5,"B",NFILE)) Q 1_"^"_LSTD
"RTN","PSNPPSNF",237,0)
 W !!,"WARNING: File has already been installed."
"RTN","PSNPPSNF",238,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N.",DIR("A")="Do you want to proceed with the installation"
"RTN","PSNPPSNF",239,0)
 S DIR("B")="YES" D ^DIR
"RTN","PSNPPSNF",240,0)
 Q Y_"^"_LSTD
"RTN","PSNPPSNK")
0^7^B45231905^n/a
"RTN","PSNPPSNK",1,0)
PSNPPSNK ;HP/MJE-PPSN NDFK Updates ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSNK",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNPPSNK",3,0)
 ;
"RTN","PSNPPSNK",4,0)
INGRED ;50.416
"RTN","PSNPPSNK",5,0)
 Q:PSNATYP'="N"
"RTN","PSNPPSNK",6,0)
 N FLD3,X,DIC,DINUM,OINGRED S FLD3=$P(DIA,"^",3)
"RTN","PSNPPSNK",7,0)
 I '$D(^TMP("PSN OLDINGRED",$J,$P($P(DIA,"^"),","))) S OINGRED=0 F  S OINGRED=$O(^PSNDF(50.68,$P($P(DIA,"^"),","),2,OINGRED)) Q:OINGRED=""  S ^TMP("PSN OLDINGRED",$J,$P($P(DIA,"^"),","),OINGRED)=""
"RTN","PSNPPSNK",8,0)
 I FLD3="99.991,.01" D
"RTN","PSNPPSNK",9,0)
 .S (DINUM,X)=+$P(DIA,"^")
"RTN","PSNPPSNK",10,0)
 .I NEW'="" I '$D(^NDFK(5000.508,"B",X)) S DIC=5000.508,DIC(0)="LMXZ" D FILE^DICN
"RTN","PSNPPSNK",11,0)
 .I NEW="" I '$D(^NDFK(5000.509,"B",X)) S DIC=5000.509,DIC(0)="LMXZ" D FILE^DICN
"RTN","PSNPPSNK",12,0)
 Q
"RTN","PSNPPSNK",13,0)
 ;
"RTN","PSNPPSNK",14,0)
CPTIER(DIA) ;
"RTN","PSNPPSNK",15,0)
 N NAME,X,DIC,DIE,DA,DR
"RTN","PSNPPSNK",16,0)
 S NAME=$$GET1^DIQ(50.68,+$P(DIA,"^"),.01,"E")
"RTN","PSNPPSNK",17,0)
 S X=NAME,DIC=5000.93,DIC(0)="LMXZ" D ^DIC
"RTN","PSNPPSNK",18,0)
 S DIE=DIC,DA=+Y K DIC
"RTN","PSNPPSNK",19,0)
 S DR="1///^S X="_1  ;Copay action - 0 = delete or 1 = add/edit
"RTN","PSNPPSNK",20,0)
 D ^DIE
"RTN","PSNPPSNK",21,0)
 Q
"RTN","PSNPPSNK",22,0)
 ;
"RTN","PSNPPSNK",23,0)
NDFK ;Setting NDFK 5000 series files
"RTN","PSNPPSNK",24,0)
 ;
"RTN","PSNPPSNK",25,0)
 ;ajf / adding code for 5000 series files
"RTN","PSNPPSNK",26,0)
 ;man / adding code for 5000.4 (strength changes) 
"RTN","PSNPPSNK",27,0)
 ;
"RTN","PSNPPSNK",28,0)
 N FDA,ERROR,FLD3,OLDV,MGFLG,DIC,OLDGEN,VAGEN,VAGENN,NEWPROD,FDAMED S FLD3=$P(DIA,"^",3)
"RTN","PSNPPSNK",29,0)
 I FLD3=40 S DIC="^NDFK(5000.92,",DIC(0)="",(X,DINUM)=$P(DIA,"^") D FILE^DICN
"RTN","PSNPPSNK",30,0)
 I FLD3=23 D
"RTN","PSNPPSNK",31,0)
 .S (DINUM,X)=$P(DIA,"^"),DIC=5000.23,DIC(0)="LMXZ" D FILE^DICN
"RTN","PSNPPSNK",32,0)
 .S DIE=DIC,DA=+Y K DIC
"RTN","PSNPPSNK",33,0)
 .S DA=+$P(DIA,"^"),DIE="^NDFK(5000.23,",DR="1///"_NEW D ^DIE
"RTN","PSNPPSNK",34,0)
 I FLD3="14,.01" S ^TMP("PSNN",$J,$P(DIA,"^"))="" Q
"RTN","PSNPPSNK",35,0)
 I FLD3=.01 S (DINUM,X)=$P(DIA,"^") I '$D(^NDFK(5000.506,"B",X)) S DIC=5000.506,DIC(0)="LMXZ" D FILE^DICN Q
"RTN","PSNPPSNK",36,0)
 I FLD3=17 S (DINUM,X)=$P(DIA,"^"),DIC=5000.5,DIC(0)="LMXZ" D FILE^DICN Q
"RTN","PSNPPSNK",37,0)
 I FLD3=7 S (DINUM,X)=$P(DIA,"^"),DIC=5000.7,DIC(0)="LMXZ" D FILE^DICN Q
"RTN","PSNPPSNK",38,0)
 I FLD3=19 K ERROR S (X,DINUM)=$P(DIA,"^"),DIC="^NDFK(5000.9,",DIC(0)="LMXZ" D FILE^DICN
"RTN","PSNPPSNK",39,0)
 ;FDA(5000.9,"+1,"_$P(DIA,"^")_",",.01)=X D UPDATE^DIE("","FDA","","ERROR") D ERROR^PSNPPSNU:$D(ERROR("DIERR")) Q
"RTN","PSNPPSNK",40,0)
 ;I FLD3=19 K ERROR S X=$P(DIA,"^"),FDA(5000.9,"+1,"_$P(DIA,"^")_",",.01)=X D UPDATE^DIE("","FDA","","ERROR") D ERROR^PSNPPSNU:$D(ERROR("DIERR")) Q
"RTN","PSNPPSNK",41,0)
 I FLD3=15 D  Q
"RTN","PSNPPSNK",42,0)
 .S NEWPROD=$O(^NDFK(5000.506,"B",$P(DIA,"^"),""))
"RTN","PSNPPSNK",43,0)
 .Q:NEWPROD'=""
"RTN","PSNPPSNK",44,0)
 .S OLDV=$$GET1^DIQ(50.68,$P(DIA,"^"),15,"I"),VAGEN=$$GET1^DIQ(50.68,$P(DIA,"^"),.05,"I")
"RTN","PSNPPSNK",45,0)
 .S VAGENN=$$GET1^DIQ(50.68,$P(DIA,"^"),.05,"E")
"RTN","PSNPPSNK",46,0)
 .K FDA
"RTN","PSNPPSNK",47,0)
 .;Does not record class/edits on new VA Products same as NDFRR3 & PSSMIGRR routine
"RTN","PSNPPSNK",48,0)
 .I OLDV'="",(OLDV'=NEW) D
"RTN","PSNPPSNK",49,0)
 ..S (DINUM,X)=$P(DIA,"^"),DIC=5000.8,DIC(0)="LMXZ" D FILE^DICN
"RTN","PSNPPSNK",50,0)
 ..S DIE=DIC,DA=$P(DIA,"^"),DIE=5000.8,DR="1////"_OLDV_";2////"_NEW_";3////"_VAGEN_";4////"_VAGENN D ^DIE
"RTN","PSNPPSNK",51,0)
 ..K FDA
"RTN","PSNPPSNK",52,0)
 ..S FDA(5000.507,"+1,",.01)=$P(DIA,"^")
"RTN","PSNPPSNK",53,0)
 ..S FDA(5000.507,"+1,",1)=$$GET1^DIQ(50.68,$P(DIA,"^"),.01)
"RTN","PSNPPSNK",54,0)
 ..S FDA(5000.507,"+1,",2)=OLDV
"RTN","PSNPPSNK",55,0)
 ..S FDA(5000.507,"+1,",3)=NEW
"RTN","PSNPPSNK",56,0)
 ..K ERROR D UPDATE^DIE("","FDA","","ERROR") D ERROR^PSNPPSNU:$D(ERROR("DIERR"))
"RTN","PSNPPSNK",57,0)
 I FLD3=2 S (DINUM,X)=$P(DIA,"^"),DIC=5000.4,DIC(0)="LMXZ" D FILE^DICN
"RTN","PSNPPSNK",58,0)
 I FLD3=100 D  K FDA Q
"RTN","PSNPPSNK",59,0)
 .K FDA,ERROR
"RTN","PSNPPSNK",60,0)
 .S MGFLG=0
"RTN","PSNPPSNK",61,0)
 .S FDAMED="",FDAMED=$$GET1^DIQ(50.68,$P(DIA,"^"),100)
"RTN","PSNPPSNK",62,0)
 .S MGFLG=$S(FDAMED="":"A",NEW="":"D",1:"E")
"RTN","PSNPPSNK",63,0)
 .S DIC="^NDFK(5000.91,",DIC(0)="Z",(X,DINUM)=$P(DIA,"^") D FILE^DICN
"RTN","PSNPPSNK",64,0)
 .S DIE=DIC,DA=+Y K DIC
"RTN","PSNPPSNK",65,0)
 .S DA=IENS,DIE="^NDFK(5000.91,",DA=$P(DIA,"^"),DR="1///"_MGFLG D ^DIE K DIE
"RTN","PSNPPSNK",66,0)
 Q
"RTN","PSNPPSNK",67,0)
 ;
"RTN","PSNPPSNK",68,0)
POSTRUN ;POST RUN FOR 50.628
"RTN","PSNPPSNK",69,0)
 D CTRKDL^PSNPPSMS("POSTRUN of PSNPPSNK processing")
"RTN","PSNPPSNK",70,0)
 N PSNPS S PSNPS=$P($G(^PS(59.7,1,10)),"^",12)
"RTN","PSNPPSNK",71,0)
 K FDA
"RTN","PSNPPSNK",72,0)
 I PSNPS="N" S IENS="" F  S IENS=$O(^TMP("PSN PPSN PARSED",$J,"POST_RUN",50.628,50.67,IENS)) Q:IENS=""  D
"RTN","PSNPPSNK",73,0)
 . S PRNDC=$G(^TMP("PSN PPSN PARSED",$J,"POST_RUN",50.628,50.67,IENS,1))
"RTN","PSNPPSNK",74,0)
 . Q:PRNDC=""
"RTN","PSNPPSNK",75,0)
 . K PROUT1 D GETS^DIQ(50.67,IENS_",","*","IE","PROUT1")
"RTN","PSNPPSNK",76,0)
 . S PRVPIEN=$G(PROUT1(50.67,IENS_",",5,"I"))
"RTN","PSNPPSNK",77,0)
 . S PRTR=$G(PROUT1(50.67,IENS_",",4,"E"))
"RTN","PSNPPSNK",78,0)
 . S PRPS=$G(PROUT1(50.67,IENS_",",8,"E"))
"RTN","PSNPPSNK",79,0)
 . S PRPT=$G(PROUT1(50.67,IENS_",",9,"E"))
"RTN","PSNPPSNK",80,0)
 .;
"RTN","PSNPPSNK",81,0)
 . K PROUT2 D GETS^DIQ(50.68,PRVPIEN_",","*","IE","PROUT2")
"RTN","PSNPPSNK",82,0)
 . S PRVAGN=$G(PROUT2(50.68,PRVPIEN_",",.05,"E"))
"RTN","PSNPPSNK",83,0)
 . S PRDFD=$G(PROUT2(50.68,PRVPIEN_",",1,"E"))
"RTN","PSNPPSNK",84,0)
 . S PRDS=$G(PROUT2(50.68,PRVPIEN_",",2,"E"))
"RTN","PSNPPSNK",85,0)
 . S PRLN=$G(PROUT2(50.68,PRVPIEN_",",5,"E"))
"RTN","PSNPPSNK",86,0)
 . S PRLN25=$G(PROUT2(50.68,PRVPIEN_",",6,"E"))
"RTN","PSNPPSNK",87,0)
 . S PRVADC=$G(PROUT2(50.68,PRVPIEN_",",15,"E"))
"RTN","PSNPPSNK",88,0)
 . S PRPT=$G(PROUT2(50.68,PRVPIEN_",",9,"E"))
"RTN","PSNPPSNK",89,0)
 . S PRPS=$G(PROUT2(50.68,PRVPIEN_",",8,"E"))
"RTN","PSNPPSNK",90,0)
 . S PRGCN=$G(PROUT2(50.68,PRVPIEN_",",11,"E"))
"RTN","PSNPPSNK",91,0)
 . S PRDC=$G(PROUT2(50.68,PRVPIEN_",",15,"E"))
"RTN","PSNPPSNK",92,0)
 .;
"RTN","PSNPPSNK",93,0)
 . K PROUT3 D GETS^DIQ(50.606,PRDFD_",","*","IE","PROUT3")
"RTN","PSNPPSNK",94,0)
 . S PRDF=$G(PROUT3(50.606,PRDFD_",",.01,"E"))
"RTN","PSNPPSNK",95,0)
 .;
"RTN","PSNPPSNK",96,0)
 . D GCNSEQ(PRNDC)
"RTN","PSNPPSNK",97,0)
 . ;
"RTN","PSNPPSNK",98,0)
 . K PRNDC,PROUT1,PROUT2,PROUT3,PRVPIEN,PRPS,PRPT,PRGCN,PRVADC,FDA,PRVAGN,PRDF,PRDS,PRDFD,PRPT,PRPS,PRLN
"RTN","PSNPPSNK",99,0)
 . K PRLN25,PRTR,PRDC,FDA,ERROR
"RTN","PSNPPSNK",100,0)
 ;
"RTN","PSNPPSNK",101,0)
POSTRUN2 ;POST RUN FOR 5000.56
"RTN","PSNPPSNK",102,0)
 K IENS
"RTN","PSNPPSNK",103,0)
 K FDA,ERROR,DAT56,PROUT4,INACT,STAT,IEN56
"RTN","PSNPPSNK",104,0)
 N PSNPS S PSNPS=$P($G(^PS(59.7,1,10)),"^",12)
"RTN","PSNPPSNK",105,0)
 Q:PSNPS'="N"
"RTN","PSNPPSNK",106,0)
 S IENS="" F  S IENS=$O(^TMP("PSN PPSN PARSED",$J,"POST_RUN",5000.56,56,IENS)) Q:IENS=""  D
"RTN","PSNPPSNK",107,0)
 . S (STAT,INACT)="",STAT=$G(^TMP("PSN PPSN PARSED",$J,"POST_RUN",5000.56,56,IENS,.01))
"RTN","PSNPPSNK",108,0)
 . S INACT=$$GET1^DIQ(56,IENS_",",7,"I","ERROR") D ERROR^PSNPPSNU:$D(ERROR("DIERR"))
"RTN","PSNPPSNK",109,0)
 . S:INACT'="" STAT="I"
"RTN","PSNPPSNK",110,0)
 .S DIC="^NDFK(5000.56,",DIC(0)="Z",(X,DINUM)=IENS D FILE^DICN
"RTN","PSNPPSNK",111,0)
 .S DIE=DIC,DA=+Y K DIC
"RTN","PSNPPSNK",112,0)
 .S DA=IENS,DIE="^NDFK(5000.56,",DR="1///"_STAT D ^DIE K DIE
"RTN","PSNPPSNK",113,0)
 ;
"RTN","PSNPPSNK",114,0)
 K FDA,DAT56,PROUT4,INACT,STAT,IEN56,ERROR
"RTN","PSNPPSNK",115,0)
 ;
"RTN","PSNPPSNK",116,0)
 ;POST RUN FOR 5000.608
"RTN","PSNPPSNK",117,0)
 K FDA,IENS,DAT1,ORDP,ORDN,VPIEN
"RTN","PSNPPSNK",118,0)
 S IENS="" F  S IENS=$O(^TMP("PSN PPSN PARSED",$J,"POST_RUN",5000.608,50.68,IENS)) Q:IENS=""  D
"RTN","PSNPPSNK",119,0)
 . S ORDP=$G(^TMP("PSN PPSN PARSED",$J,"POST_RUN",5000.608,50.68,IENS,.01))
"RTN","PSNPPSNK",120,0)
 . S DAT1=$G(^TMP("PSN PPSN PARSED",$J,"POST_RUN",5000.608,50.68,IENS,31))
"RTN","PSNPPSNK",121,0)
 . S:ORDP="" ORDP=$P(DAT1,"^",1)
"RTN","PSNPPSNK",122,0)
 . S ORDN=$P(DAT1,"^",2)
"RTN","PSNPPSNK",123,0)
 .; S FDA(5000.608,IENS_",",.01)=IENS
"RTN","PSNPPSNK",124,0)
 .; S FDA(5000.608,IENS_",",1)=$G(ORDP)
"RTN","PSNPPSNK",125,0)
 .; S FDA(5000.608,IENS_",",2)=$G(ORDN)
"RTN","PSNPPSNK",126,0)
 .; K ERROR D UPDATE^DIE("","FDA","","ERROR") D ERROR^PSNPPSNU:$D(ERROR("DIERR"))
"RTN","PSNPPSNK",127,0)
 .S DIC="^NDFK(5000.608,",DIC(0)="Z",(X,DINUM)=IENS D FILE^DICN
"RTN","PSNPPSNK",128,0)
 .S DIE=DIC,DA=+Y K DIC
"RTN","PSNPPSNK",129,0)
 .S DA=IENS,DIE="^NDFK(5000.608,",DR="1///"_$G(ORDP)_";2///"_$G(ORDN) D ^DIE K DIE
"RTN","PSNPPSNK",130,0)
 .K DAT,ORDP,ORDN,VPIEN
"RTN","PSNPPSNK",131,0)
 ;
"RTN","PSNPPSNK",132,0)
 ;POST RUN FOR 5000.508 AND 5000.509 - INGREDIENT ADDS AND DELETES
"RTN","PSNPPSNK",133,0)
 N IFLDS,IENS,DAT1,ORDP,ORDN,VPIEN,DIC
"RTN","PSNPPSNK",134,0)
 S (IENS,VPIEN)=""
"RTN","PSNPPSNK",135,0)
 F  S IENS=$O(^TMP("PSN ADDINGRED",$J,IENS)) Q:IENS=""  D
"RTN","PSNPPSNK",136,0)
 .S (DINUM,X)=IENS,DIC=5000.508,DIC(0)="LMXZ" D FILE^DICN
"RTN","PSNPPSNK",137,0)
 F  S VPIEN=$O(^TMP("PSN DELINGRED",$J,VPIEN)) Q:VPIEN=""  D
"RTN","PSNPPSNK",138,0)
 .S (DINUM,X)=VPIEN,DIC=5000.509,DIC(0)="LMXZ" D FILE^DICN
"RTN","PSNPPSNK",139,0)
 ;
"RTN","PSNPPSNK",140,0)
 K ^TMP("PSN PPSN PARSED",$J,"POST_RUN"),^TMP("PSN ADDINGRED",$J),^TMP("PSN OLDINGRED",$J),^TMP("PSN DELINGRED",$J)
"RTN","PSNPPSNK",141,0)
 Q
"RTN","PSNPPSNK",142,0)
 ;
"RTN","PSNPPSNK",143,0)
NDFKP ;Purging entries in NDFK file
"RTN","PSNPPSNK",144,0)
 N PSNATYP S PSNATYP="",PSNATYP=$P(^PS(59.7,1,10),"^",12)
"RTN","PSNPPSNK",145,0)
 Q:PSNATYP'="N"
"RTN","PSNPPSNK",146,0)
 N FILE,LOC,DA,DIK,DIAU
"RTN","PSNPPSNK",147,0)
 ;S (J,DA)=0 F  S DA=$O(^NDFK(5000,1,1,DA)) Q:'DA  S J=$P(^(DA,0),"^",2)'=$O(^DIA(DA," "),-1)+J
"RTN","PSNPPSNK",148,0)
 F FILE=5000.2:0.1:5000.9,5000.23,5000.56,5000.506:0.001:5000.509,5000.608,5000.91,5000.92,5000.93 D
"RTN","PSNPPSNK",149,0)
 .S LOC=0 F  S LOC=$O(^NDFK(FILE,LOC)) Q:'LOC  D
"RTN","PSNPPSNK",150,0)
 ..S DA="",DA=LOC,DIK="^NDFK("_FILE_"," D ^DIK K DIK,DIAU
"RTN","PSNPPSNK",151,0)
 ;
"RTN","PSNPPSNK",152,0)
 K ^NDFK(5000.561)
"RTN","PSNPPSNK",153,0)
 K ^NDFK(5000,1,2) ;GET THE MESSAGE
"RTN","PSNPPSNK",154,0)
 K ^NDFK(5000,1,3) ;AND THE SECOND MESSAGE
"RTN","PSNPPSNK",155,0)
 K ^NDFK(5000,1,4) ;GET THE WORD PROCESSING FIELDS
"RTN","PSNPPSNK",156,0)
 Q
"RTN","PSNPPSNK",157,0)
 ;
"RTN","PSNPPSNK",158,0)
GCNSEQ(PRNDC) ;
"RTN","PSNPPSNK",159,0)
 N X,DIC,DA,DIE,DR,Y
"RTN","PSNPPSNK",160,0)
 S X=PRNDC,DIC="^PS(50.628,",DIC(0)="L",DLAYGO=50.628 D FILE^DICN K DIC,DLAYGO S DA=+Y
"RTN","PSNPPSNK",161,0)
 S DIE=50.628,DA=+Y
"RTN","PSNPPSNK",162,0)
 S DR="1////"_PRGCN_";2////"_PRVAGN_";3////"_PRDFD_";4////"_PRDS_";5////"_PRLN_";6////"_PRLN25_";7////"_PRTR
"RTN","PSNPPSNK",163,0)
 S DR=DR_";9////"_PRDF_";11////"_PRPT_";12////"_PRDS_";13////"_PRDC
"RTN","PSNPPSNK",164,0)
 D ^DIE K DR
"RTN","PSNPPSNK",165,0)
 Q
"RTN","PSNPPSNK",166,0)
 ;
"RTN","PSNPPSNP")
0^5^B105233579^n/a
"RTN","PSNPPSNP",1,0)
PSNPPSNP ;HP/MJE-PPSN Parse PPS-N Update file ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSNP",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNPPSNP",3,0)
 ;
"RTN","PSNPPSNP",4,0)
 Q
"RTN","PSNPPSNP",5,0)
PARSE ;
"RTN","PSNPPSNP",6,0)
 N PSNA,PSNB
"RTN","PSNPPSNP",7,0)
 F II=0:0 S II=$O(^TMP("PSN PPSN READ",$J,II)) Q:'II  D
"RTN","PSNPPSNP",8,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATANT"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.416) D
"RTN","PSNPPSNP",9,0)
 ..S Z11=Z11+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z11)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",10,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATANT"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.6) D
"RTN","PSNPPSNP",11,0)
 ..S Z12=Z12+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z12)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",12,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATANT"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.605) D
"RTN","PSNPPSNP",13,0)
 ..S Z13=Z13+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z13)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",14,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATANT"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.606) D
"RTN","PSNPPSNP",15,0)
 ..S Z14=Z14+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z14)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",16,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATANT"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.607) D
"RTN","PSNPPSNP",17,0)
 ..S Z15=Z15+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z15)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",18,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATANT"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.608) D
"RTN","PSNPPSNP",19,0)
 ..S Z16=Z16+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z16)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",20,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATANT"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.609) D
"RTN","PSNPPSNP",21,0)
 ..S Z17=Z17+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z17)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",22,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATANT"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.64) D
"RTN","PSNPPSNP",23,0)
 ..S Z18=Z18+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z18)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",24,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATANT"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.67) D
"RTN","PSNPPSNP",25,0)
 ..S Z19=Z19+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z19)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",26,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATANT"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.68) D
"RTN","PSNPPSNP",27,0)
 ..S Z191=Z191+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z191)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",28,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATANT"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=51.2) D
"RTN","PSNPPSNP",29,0)
 ..S Z192=Z192+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z192)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",30,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATANT"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=55.95) D
"RTN","PSNPPSNP",31,0)
 ..S Z193=Z193+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z193)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",32,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATANT"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=56) D
"RTN","PSNPPSNP",33,0)
 ..S Z194=Z194+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z194)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",34,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAN"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.416) D
"RTN","PSNPPSNP",35,0)
 ..S Z21=Z21+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z21)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",36,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAN"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.6) D
"RTN","PSNPPSNP",37,0)
 ..S Z22=Z22+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z22)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",38,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAN"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.605) D
"RTN","PSNPPSNP",39,0)
 ..S Z23=Z23+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z23)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",40,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAN"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.606) D
"RTN","PSNPPSNP",41,0)
 ..S Z24=Z24+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z24)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",42,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAN"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.607) D
"RTN","PSNPPSNP",43,0)
 ..S Z25=Z25+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z25)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",44,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAN"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.608) D
"RTN","PSNPPSNP",45,0)
 ..S Z26=Z26+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z26)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",46,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAN"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.609) D
"RTN","PSNPPSNP",47,0)
 ..S Z27=Z27+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z27)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",48,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAN"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.64) D
"RTN","PSNPPSNP",49,0)
 ..S Z28=Z28+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z28)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",50,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAN"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.67) D
"RTN","PSNPPSNP",51,0)
 ..S Z29=Z29+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z29)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",52,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAN"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.68) D
"RTN","PSNPPSNP",53,0)
 ..S Z291=Z291+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z291)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",54,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAN"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=51.2) D
"RTN","PSNPPSNP",55,0)
 ..S Z292=Z292+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z292)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",56,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAN"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=55.95) D
"RTN","PSNPPSNP",57,0)
 ..S Z293=Z293+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z293)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",58,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAN"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=56) D
"RTN","PSNPPSNP",59,0)
 ..S Z294=Z294+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z294)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",60,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAO"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.416) D
"RTN","PSNPPSNP",61,0)
 ..S Z31=Z31+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z31)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",62,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAO"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.6) D
"RTN","PSNPPSNP",63,0)
 ..S Z32=Z32+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z32)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",64,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAO"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.605) D
"RTN","PSNPPSNP",65,0)
 ..S Z33=Z33+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z33)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",66,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAO"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.606) D
"RTN","PSNPPSNP",67,0)
 ..S Z34=Z34+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z34)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",68,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAO"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.607) D
"RTN","PSNPPSNP",69,0)
 ..S Z35=Z35+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z35)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",70,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAO"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.608) D
"RTN","PSNPPSNP",71,0)
 ..S Z36=Z36+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z36)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",72,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAO"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.609) D
"RTN","PSNPPSNP",73,0)
 ..S Z37=Z37+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z37)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",74,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAO"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.64) D
"RTN","PSNPPSNP",75,0)
 ..S Z38=Z38+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z38)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",76,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAO"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.67) D
"RTN","PSNPPSNP",77,0)
 ..S Z39=Z39+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z39)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",78,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAO"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=50.68) D
"RTN","PSNPPSNP",79,0)
 ..S Z391=Z391+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z391)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",80,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAO"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=51.2) D
"RTN","PSNPPSNP",81,0)
 ..S Z392=Z392+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z392)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",82,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAO"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=55.95) D
"RTN","PSNPPSNP",83,0)
 ..S Z393=Z393+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z393)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",84,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATAO"&($P(^TMP("PSN PPSN READ",$J,II),"^",2)=56) D
"RTN","PSNPPSNP",85,0)
 ..S Z394=Z394+1,^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),Z394)=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",86,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="PRODUCT" S ^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",87,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="GENERIC" S ^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",88,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="DATA" S ^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",89,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="TEXT" S ^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",90,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="POE" S ^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",91,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="CMOP" S ^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",92,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="NFI" S ^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",93,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="CLASS" S ^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",94,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="WORD" S ^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",95,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="REM" S ^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",96,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="POST" S ^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",97,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="MESSAGE" S ^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",98,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="MESSAGE2" S ^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",99,0)
 .I $P(^TMP("PSN PPSN READ",$J,II),"^")="PMIDATA" D
"RTN","PSNPPSNP",100,0)
 ..F I1=1:1:$L(^TMP("PSN PPSN READ",$J,II),"^") D
"RTN","PSNPPSNP",101,0)
 ...S PSNHLD1(I1)=$P(^TMP("PSN PPSN READ",$J,II),"^",I1)
"RTN","PSNPPSNP",102,0)
 ..I $L(^TMP("PSN PPSN READ",$J,II),"^")=3 S ^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),$P(^TMP("PSN PPSN READ",$J,II),"^",3))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",103,0)
 ..I $L(^TMP("PSN PPSN READ",$J,II),"^")=4 D
"RTN","PSNPPSNP",104,0)
 ...S ^TMP("PSN PPSN PARSED",$J,$P(^TMP("PSN PPSN READ",$J,II),"^"),$P(^TMP("PSN PPSN READ",$J,II),"^",2),$P(^TMP("PSN PPSN READ",$J,II),"^",3),$P(^TMP("PSN PPSN READ",$J,II),"^",4))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",105,0)
 ..I $L(^TMP("PSN PPSN READ",$J,II),"^")=5 D
"RTN","PSNPPSNP",106,0)
 ...S PSNA="",PSNA=$P(^TMP("PSN PPSN READ",$J,II),"^")
"RTN","PSNPPSNP",107,0)
 ...S ^TMP("PSN PPSN PARSED",$J,PSNA,$P(^TMP("PSN PPSN READ",$J,II),"^",2),$P(^TMP("PSN PPSN READ",$J,II),"^",3),$P(^TMP("PSN PPSN READ",$J,II),"^",4),$P(^TMP("PSN PPSN READ",$J,II),"^",5))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",108,0)
 ..I $L(^TMP("PSN PPSN READ",$J,II),"^")=6 D
"RTN","PSNPPSNP",109,0)
 ...S (PSNA,PSNB)="",PSNA=$P(^TMP("PSN PPSN READ",$J,II),"^"),PSNB=$P(^TMP("PSN PPSN READ",$J,II),"^",2),PSNC=$P(^TMP("PSN PPSN READ",$J,II),"^",3)
"RTN","PSNPPSNP",110,0)
 ...S ^TMP("PSN PPSN PARSED",$J,PSNA,PSNB,PSNC,$P(^TMP("PSN PPSN READ",$J,II),"^",4),$P(^TMP("PSN PPSN READ",$J,II),"^",5),$P(^TMP("PSN PPSN READ",$J,II),"^",6))=^TMP("PSN PPSN READ",$J,II+1)
"RTN","PSNPPSNP",111,0)
 .S II=II+1
"RTN","PSNPPSNP",112,0)
 Q
"RTN","PSNPPSNR")
0^8^B98892215^n/a
"RTN","PSNPPSNR",1,0)
PSNPPSNR ;HP/AF-CONF option continued ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSNR",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNPPSNR",3,0)
 ;External reference to ^ORD(101 supported by DBIA #872
"RTN","PSNPPSNR",4,0)
 ;External reference ^DIC(19.2 supported by DBIA #1472
"RTN","PSNPPSNR",5,0)
 ;Reference to ^DIC(19 supported by DBIA #2246
"RTN","PSNPPSNR",6,0)
 ;Reference to ^DIC(19.2 supported by DBIA #2910
"RTN","PSNPPSNR",7,0)
 ;Reference to ^ORD( supported by DBIA #872
"RTN","PSNPPSNR",8,0)
 ;
"RTN","PSNPPSNR",9,0)
 ;Mark Scheduled options, menu options, and protocol out of order.
"RTN","PSNPPSNR",10,0)
 ;Used by UPDT - Begin update of NDF data from PPS-N option during install of PPS-N/NDF Update file. 
"RTN","PSNPPSNR",11,0)
DISOPTS ;
"RTN","PSNPPSNR",12,0)
 N DIRUT,DUOUT,DIR,X,Y,PPG,DA,DIC,DIE,DR,DUOUT,DIRUT,PPSN
"RTN","PSNPPSNR",13,0)
 S (Y,X,PPG)="",DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNR",14,0)
 S DIR("A")="Do you want to DISABLE Scheduled Options, Menu Options and Protocols"
"RTN","PSNPPSNR",15,0)
 S DIR("B")="YES"
"RTN","PSNPPSNR",16,0)
 D ^DIR
"RTN","PSNPPSNR",17,0)
 Q:Y="^"!("Nn"[Y)!('Y)!$G(DIRUT)!$G(DTOUT)
"RTN","PSNPPSNR",18,0)
 F  D DISSO Q:PPG=""!$G(DIRUT)!$G(DTOUT)
"RTN","PSNPPSNR",19,0)
 F  D DISMO Q:PPG=""!$G(DIRUT)!$G(DTOUT)
"RTN","PSNPPSNR",20,0)
 F  D DISPR Q:PPG=""!$G(DIRUT)!$G(DTOUT)
"RTN","PSNPPSNR",21,0)
 K ^TMP("PSNPPSNR",$J)
"RTN","PSNPPSNR",22,0)
 Q
"RTN","PSNPPSNR",23,0)
 ;
"RTN","PSNPPSNR",24,0)
DISSO ;
"RTN","PSNPPSNR",25,0)
 N DIC,DIK,DR,DIR,DA,I,II,III,IV,ICNT,X,Y,DIE,DTOUT,DIRUT,DUOUT,SCHED,FILEIEN,MENUN,SOPT,ALLOF,ALLOF2,ALLNAM,LENGTH,FDA
"RTN","PSNPPSNR",26,0)
 S PPG=1
"RTN","PSNPPSNR",27,0)
 ;
"RTN","PSNPPSNR",28,0)
DISSO1 ;
"RTN","PSNPPSNR",29,0)
 D HDR^PSNPARM
"RTN","PSNPPSNR",30,0)
DISSOS ;
"RTN","PSNPPSNR",31,0)
 W !,"Enter the name or partial name of the Scheduled Option that you wish to have",!,"paused during the processing."
"RTN","PSNPPSNR",32,0)
 K ^TMP("PSNPPSNR",$J),PPSN
"RTN","PSNPPSNR",33,0)
 S (I,II,III,ICNT,X)=0,ICNT=0
"RTN","PSNPPSNR",34,0)
 F  S X=$O(^PS(57.23,1,3,"B",X)) Q:'$G(X)  F  S I=$O(^PS(57.23,1,3,"B",X,I)) Q:I=""  D
"RTN","PSNPPSNR",35,0)
 .S ^TMP("PSNPPSNR",$J,X)=I
"RTN","PSNPPSNR",36,0)
 .S ICNT=ICNT+1,SOPT="",SOPT=$$GET1^DIQ(19.2,X,.01,"E") S:SOPT'="" PPSN(SOPT,ICNT)=I
"RTN","PSNPPSNR",37,0)
 W:ICNT>0 !!?3,"PPS-N Scheduled Options defined to mark 'out of order':"
"RTN","PSNPPSNR",38,0)
 F  S I=$O(PPSN(I)) Q:I=""  W !?8,I I $Y>20 R !,"Enter to continue...",X:120 W @IOF
"RTN","PSNPPSNR",39,0)
 I $D(PPSN(2)) S I="" F  S I=$O(PPSN(I)) Q:I=""  W !,"    "_PPSN(I)
"RTN","PSNPPSNR",40,0)
 R !!,"Scheduled Options: ",Y:120
"RTN","PSNPPSNR",41,0)
 I $G(Y)=""!(Y=-1)!($G(DTOUT))!($G(DIRUT))!($G(DUOUT)) S PPG="" Q
"RTN","PSNPPSNR",42,0)
 I Y="?" W @IOF,!!,"Enter the Scheduled Option that you wish to have paused during the",!,"processing of the update file or '??' for more help. ",! G DISSOS
"RTN","PSNPPSNR",43,0)
 I Y="??" W @IOF D SHELP R !,"Enter to continue...",X:120 G DISSO1
"RTN","PSNPPSNR",44,0)
 ;
"RTN","PSNPPSNR",45,0)
 ;set all beginning with a prefix
"RTN","PSNPPSNR",46,0)
 I Y["*" S ALLOF=$P(Y,"*"),LENGTH=$L(ALLOF) D  G DISSO1
"RTN","PSNPPSNR",47,0)
 .F  S III=$O(^DIC(19.2,"B",III)) Q:III=""  S IV="" F  S IV=$O(^DIC(19.2,"B",III,IV)) Q:IV=""  D
"RTN","PSNPPSNR",48,0)
 ..S ALLNAM=$$GET1^DIQ(19.2,IV,.01,"E")
"RTN","PSNPPSNR",49,0)
 ..Q:ALLNAM=""
"RTN","PSNPPSNR",50,0)
 ..S ALLOF2=$E(ALLNAM,1,LENGTH)
"RTN","PSNPPSNR",51,0)
 ..I ALLOF=ALLOF2 D
"RTN","PSNPPSNR",52,0)
 ...Q:$D(^PS(57.23,1,3,"B",IV))
"RTN","PSNPPSNR",53,0)
 ...S DIC="^PS(57.23,1,3,",DA(1)=1
"RTN","PSNPPSNR",54,0)
 ...S FDA(57.24,"+1,1,",.01)=IV
"RTN","PSNPPSNR",55,0)
 ...D UPDATE^DIE("","FDA","","ERROR")
"RTN","PSNPPSNR",56,0)
 ;
"RTN","PSNPPSNR",57,0)
 ;delete all beginning with a prefix
"RTN","PSNPPSNR",58,0)
 I Y["@" S ALLOF=$P(Y,"@"),LENGTH=$L(ALLOF) D  G DISSO1
"RTN","PSNPPSNR",59,0)
 .K DIR S DIR("?")="Please enter Y or N.",DIR("B")="NO"
"RTN","PSNPPSNR",60,0)
 .S DIR("A")="Are you sure that you want to delete ALL items starting with "_ALLOF,DIR(0)="Y"
"RTN","PSNPPSNR",61,0)
 .D ^DIR
"RTN","PSNPPSNR",62,0)
 .Q:'$G(Y)
"RTN","PSNPPSNR",63,0)
 .F  S III=$O(^PS(57.23,1,3,"B",III)) Q:III=""  S IV="",IV=$O(^PS(57.23,1,3,"B",III,IV)) D
"RTN","PSNPPSNR",64,0)
 ..S ALLNAM=$$GET1^DIQ(19.2,III,.01,"E")
"RTN","PSNPPSNR",65,0)
 ..I ALLNAM'="" D
"RTN","PSNPPSNR",66,0)
 ...S ALLOF2="",ALLOF2=$E(ALLNAM,1,LENGTH)
"RTN","PSNPPSNR",67,0)
 ...Q:ALLOF'=ALLOF2
"RTN","PSNPPSNR",68,0)
 ...K DIK,DIC S (DIK,DIC)="^PS(57.23,1,3,"
"RTN","PSNPPSNR",69,0)
 ...S DA(1)=1,DA=IV,DR=".01///@" D ^DIK K DIR
"RTN","PSNPPSNR",70,0)
 ;
"RTN","PSNPPSNR",71,0)
DISSO2 ;
"RTN","PSNPPSNR",72,0)
 K DIC S DIC="^DIC(19.2,",DIC(0)="EQMZ",X=Y D ^DIC
"RTN","PSNPPSNR",73,0)
 I ($G(DTOUT))!($G(DIRUT))!($G(DUOUT)) S PPG="" G DISSO1
"RTN","PSNPPSNR",74,0)
 I 'Y!(Y=-1) W !!,"Selection not found.",! R !,"Enter to continue...",X:120 G DISSO1
"RTN","PSNPPSNR",75,0)
 S (SCHED,FILEIEN,MENUN)="",SCHED=$P(Y,"^")
"RTN","PSNPPSNR",76,0)
 I $D(^TMP("PSNPPSNR",$J,SCHED)) S FILEIEN=^TMP("PSNPPSNR",$J,SCHED),MENUN=$$GET1^DIQ(19,SCHED,.01,"E")
"RTN","PSNPPSNR",77,0)
 G DISSO1:'Y!(Y=-1)!($G(DTOUT))!($G(DIRUT))!($G(DUOUT))
"RTN","PSNPPSNR",78,0)
 ;
"RTN","PSNPPSNR",79,0)
DISSO3 ;
"RTN","PSNPPSNR",80,0)
 I $D(SCHED),$D(^TMP("PSNPPSNR",$J,SCHED)) D  Q
"RTN","PSNPPSNR",81,0)
 .K DIR S DIR("?")="Please enter Y or N.",DIR("B")="NO",DIR("A")="Do you want to delete it from the PPS-N Control file"
"RTN","PSNPPSNR",82,0)
 .S DIR(0)="Y"
"RTN","PSNPPSNR",83,0)
 .D ^DIR
"RTN","PSNPPSNR",84,0)
 .K DIK,DIC S (DIK,DIC)="^PS(57.23,1,3,",DA(1)=1
"RTN","PSNPPSNR",85,0)
 .I $G(Y) S DA(1)=1,DA=FILEIEN,DR=".01///@" D ^DIK K DIR
"RTN","PSNPPSNR",86,0)
 .Q:$G(DUOUT)!($G(DIRUT))!($G(DTOUT))!('$G(Y))
"RTN","PSNPPSNR",87,0)
 S FDA(57.24,"+1,1,",.01)=SCHED
"RTN","PSNPPSNR",88,0)
 D UPDATE^DIE("","FDA","","ERROR")
"RTN","PSNPPSNR",89,0)
 Q
"RTN","PSNPPSNR",90,0)
 ;
"RTN","PSNPPSNR",91,0)
DISMO ;
"RTN","PSNPPSNR",92,0)
 S PPG=1
"RTN","PSNPPSNR",93,0)
 N DIC,DIK,DR,DIR,DA,I,II,III,IV,ICNT,X,Y,DIE,DTOUT,DIRUT,DUOUT,SCHED,FILEIEN,MENUN,SOPT,ALLOF,ALLOF2,ALLNAM,LENGTH,FDA
"RTN","PSNPPSNR",94,0)
DISMO1 ;
"RTN","PSNPPSNR",95,0)
 D HDR^PSNPARM
"RTN","PSNPPSNR",96,0)
DISMOS ;
"RTN","PSNPPSNR",97,0)
 W !,"Enter the name or partial menu name of the menu that you wish to have paused",!,"during the processing."
"RTN","PSNPPSNR",98,0)
 K ^TMP("PSNPPSNR",$J),PPSN
"RTN","PSNPPSNR",99,0)
 S (I,II,III,ICNT,X)=0,ICNT=0
"RTN","PSNPPSNR",100,0)
 F  S X=$O(^PS(57.23,1,3.1,"B",X)) Q:'$G(X)  F  S I=$O(^PS(57.23,1,3.1,"B",X,I)) Q:I=""  D
"RTN","PSNPPSNR",101,0)
 .S ^TMP("PSNPPSNR",$J,X)=I
"RTN","PSNPPSNR",102,0)
 .S ICNT=ICNT+1,SOPT="",SOPT=$$GET1^DIQ(19,X,.01,"E") S:SOPT'="" PPSN(SOPT,ICNT)=I
"RTN","PSNPPSNR",103,0)
 W:ICNT>0 !!?3,"PPS-N Menu Options defined to mark 'out of order':"
"RTN","PSNPPSNR",104,0)
 F  S I=$O(PPSN(I)) Q:I=""  W !?8,I I $Y>20 R !,"Enter to continue...",X:120 W @IOF
"RTN","PSNPPSNR",105,0)
 I $D(PPSN(2)) S I="" F  S I=$O(PPSN(I)) Q:I=""  W !,"    "_PPSN(I)
"RTN","PSNPPSNR",106,0)
 R !!,"Menu Option: ",Y:120
"RTN","PSNPPSNR",107,0)
 I $G(Y)=""!(Y=-1)!($G(DTOUT))!($G(DIRUT))!($G(DUOUT)) S PPG="" Q
"RTN","PSNPPSNR",108,0)
 I Y="?" W !!,"Enter the Menu Option that you wish to have paused during the processing of the update file or '??' for more help. ",! G DISMOS
"RTN","PSNPPSNR",109,0)
 I Y="??" W @IOF D SHELP R !,"Enter to continue...",X:120 G DISMO1
"RTN","PSNPPSNR",110,0)
 ;
"RTN","PSNPPSNR",111,0)
 ;set all beginning with a prefix
"RTN","PSNPPSNR",112,0)
 I Y["*" S ALLOF=$P(Y,"*"),LENGTH=$L(ALLOF) D  G DISMO1
"RTN","PSNPPSNR",113,0)
 .F  S III=$O(^DIC(19,"B",III)) Q:III=""  S IV="" F  S IV=$O(^DIC(19,"B",III,IV)) Q:IV=""  D
"RTN","PSNPPSNR",114,0)
 ..S ALLNAM=$$GET1^DIQ(19,IV,.01,"E")
"RTN","PSNPPSNR",115,0)
 ..Q:ALLNAM=""
"RTN","PSNPPSNR",116,0)
 ..S ALLOF2=$E(ALLNAM,1,LENGTH)
"RTN","PSNPPSNR",117,0)
 ..I ALLOF=ALLOF2 D
"RTN","PSNPPSNR",118,0)
 ...Q:$D(^PS(57.23,1,3.1,"B",IV))
"RTN","PSNPPSNR",119,0)
 ...S DIC="^PS(57.23,1,3.1,",DA(1)=1
"RTN","PSNPPSNR",120,0)
 ...S FDA(57.2331,"+1,1,",.01)=IV
"RTN","PSNPPSNR",121,0)
 ...D UPDATE^DIE("","FDA","","ERROR")
"RTN","PSNPPSNR",122,0)
 ;
"RTN","PSNPPSNR",123,0)
 ;delete all beginning with a prefix
"RTN","PSNPPSNR",124,0)
 I Y["@" S ALLOF=$P(Y,"@"),LENGTH=$L(ALLOF) D  G DISMO1
"RTN","PSNPPSNR",125,0)
 .K DIR S DIR("?")="Please enter Y or N.",DIR("B")="NO",DIR("A")="Are you sure that you want to delete ALL items starting with "_ALLOF
"RTN","PSNPPSNR",126,0)
 .S DIR(0)="Y"
"RTN","PSNPPSNR",127,0)
 .D ^DIR
"RTN","PSNPPSNR",128,0)
 .Q:'$G(Y)
"RTN","PSNPPSNR",129,0)
 .F  S III=$O(^PS(57.23,1,3.1,"B",III)) Q:III=""  S IV="",IV=$O(^PS(57.23,1,3.1,"B",III,IV)) D
"RTN","PSNPPSNR",130,0)
 ..S ALLNAM=$$GET1^DIQ(19,III,.01,"E")
"RTN","PSNPPSNR",131,0)
 ..I ALLNAM'="" D
"RTN","PSNPPSNR",132,0)
 ...S ALLOF2="",ALLOF2=$E(ALLNAM,1,LENGTH)
"RTN","PSNPPSNR",133,0)
 ...Q:ALLOF'=ALLOF2
"RTN","PSNPPSNR",134,0)
 ...K DIK,DIC S (DIK,DIC)="^PS(57.23,1,3.1,"
"RTN","PSNPPSNR",135,0)
 ...S DA(1)=1,DA=IV,DR=".01///@" D ^DIK K DIR
"RTN","PSNPPSNR",136,0)
 ;
"RTN","PSNPPSNR",137,0)
DISMO2 ;
"RTN","PSNPPSNR",138,0)
 K DIC S DIC="^DIC(19,",DIC(0)="EQMZ",X=Y D ^DIC
"RTN","PSNPPSNR",139,0)
 I ($G(DTOUT))!($G(DIRUT))!($G(DUOUT)) S PPG="" G DISMO1
"RTN","PSNPPSNR",140,0)
 I 'Y!(Y=-1) W !!,"Selection not found.",! R !,"Enter to continue...",X:120 G DISMO1
"RTN","PSNPPSNR",141,0)
 S (SCHED,FILEIEN,MENUN)="",SCHED=$P(Y,"^")
"RTN","PSNPPSNR",142,0)
 I $D(^TMP("PSNPPSNR",$J,SCHED)) S FILEIEN=^TMP("PSNPPSNR",$J,SCHED),MENUN=$$GET1^DIQ(19,SCHED,.01,"E")
"RTN","PSNPPSNR",143,0)
 G DISMO1:'Y!(Y=-1)!($G(DTOUT))!($G(DIRUT))!($G(DUOUT))
"RTN","PSNPPSNR",144,0)
 ;
"RTN","PSNPPSNR",145,0)
DISMO3 ;
"RTN","PSNPPSNR",146,0)
 I $D(SCHED),$D(^TMP("PSNPPSNR",$J,SCHED)) D  Q
"RTN","PSNPPSNR",147,0)
 .K DIR S DIR("?")="Please enter Y or N.",DIR("B")="NO",DIR("A")="Do you want to delete it from the PPS-N Control file"
"RTN","PSNPPSNR",148,0)
 .S DIR(0)="Y"
"RTN","PSNPPSNR",149,0)
 .D ^DIR
"RTN","PSNPPSNR",150,0)
 .K DIK,DIC S (DIK,DIC)="^PS(57.23,1,3.1,",DA(1)=1
"RTN","PSNPPSNR",151,0)
 .I $G(Y) S DA(1)=1,DA=FILEIEN,DR=".01///@" D ^DIK K DIR
"RTN","PSNPPSNR",152,0)
 .Q:$G(DUOUT)!($G(DIRUT))!($G(DTOUT))!('$G(Y))
"RTN","PSNPPSNR",153,0)
 S FDA(57.2331,"+1,1,",.01)=SCHED
"RTN","PSNPPSNR",154,0)
 D UPDATE^DIE("","FDA","","ERROR")
"RTN","PSNPPSNR",155,0)
 Q
"RTN","PSNPPSNR",156,0)
 ;
"RTN","PSNPPSNR",157,0)
DISPR ;
"RTN","PSNPPSNR",158,0)
 ;
"RTN","PSNPPSNR",159,0)
 S PPG=1
"RTN","PSNPPSNR",160,0)
 N DIC,DIK,DR,DIR,DA,I,II,III,IV,ICNT,X,Y,DIE,DTOUT,DIRUT,DUOUT,SCHED,FILEIEN,MENUN,SOPT,ALLOF,ALLOF2,ALLNAM,LENGTH,FDA
"RTN","PSNPPSNR",161,0)
DIPRO1 ;
"RTN","PSNPPSNR",162,0)
 D HDR^PSNPARM
"RTN","PSNPPSNR",163,0)
DIPROS ;
"RTN","PSNPPSNR",164,0)
 W !,"Enter the name or partial name of the protocol that you wish to have",!,"paused during the processing."
"RTN","PSNPPSNR",165,0)
 K ^TMP("PSNPPSNR",$J),PPSN
"RTN","PSNPPSNR",166,0)
 S (I,II,III,ICNT,X)=0,ICNT=0
"RTN","PSNPPSNR",167,0)
 F  S X=$O(^PS(57.23,1,3.2,"B",X)) Q:'$G(X)  F  S I=$O(^PS(57.23,1,3.2,"B",X,I)) Q:I=""  D
"RTN","PSNPPSNR",168,0)
 .S ^TMP("PSNPPSNR",$J,X)=I
"RTN","PSNPPSNR",169,0)
 .S ICNT=ICNT+1,SOPT="",SOPT=$$GET1^DIQ(101,X,.01,"E") S:SOPT'="" PPSN(SOPT,ICNT)=I
"RTN","PSNPPSNR",170,0)
 W:ICNT>0 !!?3,"PPS-N Protocols defined to mark 'out of order':"
"RTN","PSNPPSNR",171,0)
 F  S I=$O(PPSN(I)) Q:I=""  W !?8,I I $Y>20 R !,"Enter to continue...",X:120 W @IOF
"RTN","PSNPPSNR",172,0)
 I $D(PPSN(2)) S I="" F  S I=$O(PPSN(I)) Q:I=""  W !,"    "_PPSN(I)
"RTN","PSNPPSNR",173,0)
 R !!,"Protocol: ",Y:120
"RTN","PSNPPSNR",174,0)
 I $G(Y)=""!(Y=-1)!($G(DTOUT))!($G(DIRUT))!($G(DUOUT)) S PPG="" Q
"RTN","PSNPPSNR",175,0)
 I Y="?" W !!,"Enter the Protocol that you wish to have paused during the processing of the update file or '??' for more help. ",! G DIPROS
"RTN","PSNPPSNR",176,0)
 I Y="??" W @IOF D SHELP R !,"Enter to continue...",X:120 G DIPRO1
"RTN","PSNPPSNR",177,0)
 ;
"RTN","PSNPPSNR",178,0)
 ;set all beginning with a prefix
"RTN","PSNPPSNR",179,0)
 I Y["*" S ALLOF=$P(Y,"*"),LENGTH=$L(ALLOF) D  G DIPRO1
"RTN","PSNPPSNR",180,0)
 .F  S III=$O(^ORD(101,"B",III)) Q:III=""  S IV="" F  S IV=$O(^ORD(101,"B",III,IV)) Q:IV=""  D
"RTN","PSNPPSNR",181,0)
 ..S ALLNAM=$$GET1^DIQ(101,IV,.01,"E")
"RTN","PSNPPSNR",182,0)
 ..Q:ALLNAM=""
"RTN","PSNPPSNR",183,0)
 ..S ALLOF2=$E(ALLNAM,1,LENGTH)
"RTN","PSNPPSNR",184,0)
 ..I ALLOF=ALLOF2 D
"RTN","PSNPPSNR",185,0)
 ...Q:$D(^PS(57.23,1,3.2,"B",IV))
"RTN","PSNPPSNR",186,0)
 ...S DIC="^PS(57.23,1,3.2,",DA(1)=1
"RTN","PSNPPSNR",187,0)
 ...S FDA(57.2332,"+1,1,",.01)=IV
"RTN","PSNPPSNR",188,0)
 ...D UPDATE^DIE("","FDA","","ERROR")
"RTN","PSNPPSNR",189,0)
 ;
"RTN","PSNPPSNR",190,0)
 ;delete all beginning with a prefix
"RTN","PSNPPSNR",191,0)
 I Y["@" S ALLOF=$P(Y,"@"),LENGTH=$L(ALLOF) D  G DIPRO1
"RTN","PSNPPSNR",192,0)
 .K DIR S DIR("?")="Please enter Y or N.",DIR("B")="NO",DIR("A")="Are you sure that you want to delete ALL items starting with "_ALLOF
"RTN","PSNPPSNR",193,0)
 .S DIR(0)="Y"
"RTN","PSNPPSNR",194,0)
 .D ^DIR
"RTN","PSNPPSNR",195,0)
 .Q:'$G(Y)
"RTN","PSNPPSNR",196,0)
 .F  S III=$O(^PS(57.23,1,3.2,"B",III)) Q:III=""  S IV="",IV=$O(^PS(57.23,1,3.2,"B",III,IV)) D
"RTN","PSNPPSNR",197,0)
 ..S ALLNAM=$$GET1^DIQ(101,III,.01,"E")
"RTN","PSNPPSNR",198,0)
 ..I ALLNAM'="" D
"RTN","PSNPPSNR",199,0)
 ...S ALLOF2="",ALLOF2=$E(ALLNAM,1,LENGTH)
"RTN","PSNPPSNR",200,0)
 ...Q:ALLOF'=ALLOF2
"RTN","PSNPPSNR",201,0)
 ...K DIK,DIC S (DIK,DIC)="^PS(57.23,1,3.2,"
"RTN","PSNPPSNR",202,0)
 ...S DA(1)=1,DA=IV,DR=".01///@" D ^DIK K DIR
"RTN","PSNPPSNR",203,0)
 ;
"RTN","PSNPPSNR",204,0)
 ;
"RTN","PSNPPSNR",205,0)
DIPRO2 ;
"RTN","PSNPPSNR",206,0)
 K DIC S DIC="^ORD(101,",DIC(0)="EQMZ",X=Y D ^DIC
"RTN","PSNPPSNR",207,0)
 I ($G(DTOUT))!($G(DIRUT))!($G(DUOUT)) S PPG="" G DIPRO1
"RTN","PSNPPSNR",208,0)
 I 'Y!(Y=-1) W !!,"Selection not found.",! R !,"Enter to continue...",X:120 G DIPRO1
"RTN","PSNPPSNR",209,0)
 S (SCHED,FILEIEN,MENUN)="",SCHED=$P(Y,"^")
"RTN","PSNPPSNR",210,0)
 I $D(^TMP("PSNPPSNR",$J,SCHED)) S FILEIEN=^TMP("PSNPPSNR",$J,SCHED),MENUN=$$GET1^DIQ(101,SCHED,.01,"E")
"RTN","PSNPPSNR",211,0)
 G DIPRO1:'Y!(Y=-1)!($G(DTOUT))!($G(DIRUT))!($G(DUOUT))
"RTN","PSNPPSNR",212,0)
 ;
"RTN","PSNPPSNR",213,0)
DIPRO3 ;
"RTN","PSNPPSNR",214,0)
 I $D(SCHED),$D(^TMP("PSNPPSNR",$J,SCHED)) D  Q
"RTN","PSNPPSNR",215,0)
 .K DIR S DIR("?")="Please enter Y or N.",DIR("B")="NO"
"RTN","PSNPPSNR",216,0)
 .S DIR("A")="Do you want to delete it from the PPS-N Control file",DIR(0)="Y"
"RTN","PSNPPSNR",217,0)
 .D ^DIR
"RTN","PSNPPSNR",218,0)
 .K DIK,DIC S (DIK,DIC)="^PS(57.23,1,3.2,",DA(1)=1
"RTN","PSNPPSNR",219,0)
 .I $G(Y) S DA(1)=1,DA=FILEIEN,DR=".01///@" D ^DIK K DIR
"RTN","PSNPPSNR",220,0)
 .Q:$G(DUOUT)!($G(DIRUT))!($G(DTOUT))!('$G(Y))
"RTN","PSNPPSNR",221,0)
 S FDA(57.2332,"+1,1,",.01)=SCHED
"RTN","PSNPPSNR",222,0)
 D UPDATE^DIE("","FDA","","ERROR")
"RTN","PSNPPSNR",223,0)
 G DISPR
"RTN","PSNPPSNR",224,0)
 Q
"RTN","PSNPPSNR",225,0)
 ;
"RTN","PSNPPSNR",226,0)
SHELP ;
"RTN","PSNPPSNR",227,0)
 W !,"You are building a list of options and/or protocols to be marked 'Out"
"RTN","PSNPPSNR",228,0)
 W !,"Of Order'. You may enter them in several different ways:"
"RTN","PSNPPSNR",229,0)
 W !,"You may simply enter an option or protocol name,"
"RTN","PSNPPSNR",230,0)
 W !," or  NAM  for a listing all that begin with the characters 'NAM'"
"RTN","PSNPPSNR",231,0)
 W !," or  ^    to quit and exit the program,"
"RTN","PSNPPSNR",232,0)
 W !," or  ?    to see a brief help prompt,"
"RTN","PSNPPSNR",233,0)
 W !," or  ??   to see this help screen again,"
"RTN","PSNPPSNR",234,0)
 W !," or  ???  to see all entries"
"RTN","PSNPPSNR",235,0)
 W !," or NAM* to select everything that begins with the characters 'NAM'"
"RTN","PSNPPSNR",236,0)
 W !," or NAM@ remove item that begin with the characters 'NAM'"
"RTN","PSNPPSNR",237,0)
 W !
"RTN","PSNPPSNR",238,0)
 Q
"RTN","PSNPPSNU")
0^4^B51690215^n/a
"RTN","PSNPPSNU",1,0)
PSNPPSNU ;HP/MJE-PPSN update NDF data ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSNU",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNPPSNU",3,0)
 ;Reference to ^PSDRUG supported by DBIA #2192
"RTN","PSNPPSNU",4,0)
 ;Reference to PSN^PSSHUIDG supported by DBIA #3621
"RTN","PSNPPSNU",5,0)
 ;Reference to ^GMR(120.8) supported by DBIA #4606
"RTN","PSNPPSNU",6,0)
 ;Reference to ^DD supported by DBIA #1258
"RTN","PSNPPSNU",7,0)
 ;Reference to EN^GMRAUIX0 supported by DBIA #6372
"RTN","PSNPPSNU",8,0)
 ;
"RTN","PSNPPSNU",9,0)
 ; Note: this routine is an adapted version of the origional code by Dr. Dave Alexander
"RTN","PSNPPSNU",10,0)
 ;
"RTN","PSNPPSNU",11,0)
 N CL,CLA,CMOP,CT,DA,DA1,DIA,DIC,DIE,DIK,DINUM,DR,FDA,FILE,FLDS,GE,GROOT,GROOT1,IENS,IN,INA,IND,INDX,INV,J,JJ,K
"RTN","PSNPPSNU",12,0)
 N LI,LINE,NA,NAME,ND,NEW,NFI,POST,PR,PSN,PSN1,PSN11,PSN21,PSNDF,R1,ROOT,ROOT1,ROOT2,ROOT3,SUBS,VAC,VAIN,VAPN
"RTN","PSNPPSNU",13,0)
 N X,XMDUZ,XMSUB,XMTEXT,XMY,XMZ,TREC,PSNMULTI,MJJ,PSNERROR
"RTN","PSNPPSNU",14,0)
 N ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,XPATH
"RTN","PSNPPSNU",15,0)
 N PSNPS,XPDIDTOT,RES1,PSNTMPN
"RTN","PSNPPSNU",16,0)
 K ^TMP($J),^TMP("PSN",$J),^TMP("PSNN",$J),^TMP("PSN PPSN.WP",$J),^TMP("PSN PPSN ERR",$J),^TMP("PSNINGRED",$J)
"RTN","PSNPPSNU",17,0)
 ;
"RTN","PSNPPSNU",18,0)
 ;SETUP PRODUCTION OR SQA
"RTN","PSNPPSNU",19,0)
 S PSNPS=$P($G(^PS(59.7,1,10)),"^",12),PSNERROR=0
"RTN","PSNPPSNU",20,0)
 I PSNPS="T"!(PSNPS="S") S PSNPS="P" ;test account and support account is same as production.
"RTN","PSNPPSNU",21,0)
 S PSNDF=1,XPDIDTOT=+$G(^TMP("PSN PPSN PARSED",$J,"TREC")),TREC=0
"RTN","PSNPPSNU",22,0)
 ;TO ALLOW ADDS TO 56,50.416,50.605,50.606, AND 50.6
"RTN","PSNPPSNU",23,0)
 ;
"RTN","PSNPPSNU",24,0)
 D DATANT^PSNPPSI1
"RTN","PSNPPSNU",25,0)
 I PSNPS="N" D POSTRUN^PSNPPSNK
"RTN","PSNPPSNU",26,0)
 ;
"RTN","PSNPPSNU",27,0)
WORD ;
"RTN","PSNPPSNU",28,0)
 D CTRKDL^PSNPPSMS("Storing report messages information")
"RTN","PSNPPSNU",29,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",6)="WORD"
"RTN","PSNPPSNU",30,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSNU",31,0)
 K FDA
"RTN","PSNPPSNU",32,0)
 S ROOT1=$NA(^TMP("PSN PPSN PARSED",$J,"WORD")),CT=0,ROOT2=$NA(@ROOT1@(0))
"RTN","PSNPPSNU",33,0)
 F  S CT=$O(@ROOT2) Q:'CT  D CTRLSS^PSNPPSMS(CT) S ROOT2=$NA(@ROOT1@(CT)),NAME=@ROOT2,ROOT3=$NA(@ROOT2@("D")) K @NAME M @NAME=@ROOT3
"RTN","PSNPPSNU",34,0)
 ;
"RTN","PSNPPSNU",35,0)
 D CTRKDL^PSNPPSMS("Sending mail messages")
"RTN","PSNPPSNU",36,0)
 D MESSAGE^PSNPPSMG
"RTN","PSNPPSNU",37,0)
 ;
"RTN","PSNPPSNU",38,0)
 D CTRKDL^PSNPPSMS("Beginning un-march/re-match")
"RTN","PSNPPSNU",39,0)
 W:'$G(PSNSCJOB) !,"Beginning un-match/re-match to local drug file...",!
"RTN","PSNPPSNU",40,0)
DRUGFILE ;
"RTN","PSNPPSNU",41,0)
 ;NOW UPDATE LOCAL DRUG FILE
"RTN","PSNPPSNU",42,0)
 N REM,PSNUNMAT
"RTN","PSNPPSNU",43,0)
 K ^TMP($J)
"RTN","PSNPPSNU",44,0)
 I PSNPS="N" S OLDNDF="" F  S OLDNDF=$O(^TMP("PSN PPSN PARSED",$J,"REM",OLDNDF)) Q:OLDNDF=""  D EN1^PSNPPSNW(OLDNDF,"")
"RTN","PSNPPSNU",45,0)
 S OLDNDF="",PSN=$$PATCH^XPDUTL("PSS*1.0*34"),PSN1=$$PATCH^XPDUTL("PSS*1.0*42")
"RTN","PSNPPSNU",46,0)
 S ROOT2=$NA(^TMP("PSN PPSN PARSED",$J,"PRODUCTS TO UNMATCH")),ROOT3=$NA(^TMP("PSN PPSN PARSED",$J,"POE")),DA=0
"RTN","PSNPPSNU",47,0)
 S DA=0 F  S DA=$O(^PSDRUG(DA)) Q:'DA  S X=$G(^PSDRUG(DA,0)) I X]"" S NA=$P(X,"^"),CLA=$P(X,"^",2),INV=$P(X,"^",3)["I",X=$G(^("ND")),IN=$P($G(^("I"),9999999),"^"),INA=IN'>DT,GE=+X,PR=+$P(X,"^",3),CMOP=$P(X,"^",10),VAPN=$P(X,"^",2) I GE I PR D
"RTN","PSNPPSNU",48,0)
 .S OLDNDF=$P($G(^PSDRUG(DA,"ND")),"^",3) ;va product name (3P:50.68); NA = generic name; CLA = VA Class; INV = DEA Special HDLG 
"RTN","PSNPPSNU",49,0)
 .S VAIN=$P($G(^PSNDF(50.68,PR,7)),"^",3) ;inactivation date
"RTN","PSNPPSNU",50,0)
 .I $D(@ROOT2@(PR))!VAIN S X="" S:CMOP]"" X="    (CMOP "_CMOP_")" D
"RTN","PSNPPSNU",51,0)
 ..S $E(X,30)=VAPN,$E(X,65)=$$FMTE^XLFDT(VAIN,5),INDX=$S(INA:"I",INV:"X",1:"A")
"RTN","PSNPPSNU",52,0)
 ..S:IN=9999999 IN="" S ^TMP($J,INDX,NA_"^"_DA_"^"_IN,1)=X,^TMP($J,"^",DA)=""
"RTN","PSNPPSNU",53,0)
 ..D UNMDRG
"RTN","PSNPPSNU",54,0)
 ..I PSN I $P($G(^PSDRUG(DA,"DOS")),"^")]""!$O(^("DOS1",0))!$O(^PSDRUG(DA,"DOS2",0)) D LOAD^PSNPPSNV K ^PSDRUG(DA,"DOS"),^("DOS1"),^("DOS2")
"RTN","PSNPPSNU",55,0)
 ..I $P($G(^PSDRUG(DA,3)),"^") S DIE=50,DR="213////0;" D ^DIE D ERROR:$D(ERROR("DIERR")) K DIE,DR I PSN1 S IND=$O(^PSDRUG(DA,4," "),-1),$P(^(IND,0),"^",6)="NDF Update"
"RTN","PSNPPSNU",56,0)
 .;check here if PR (50.68 IEN this local drug is matched to) exists in TMP rematch
"RTN","PSNPPSNU",57,0)
 .;if a re-match for that IEN is not null, do re-match (file re-match, add to report)
"RTN","PSNPPSNU",58,0)
 .S REM="" I OLDNDF'="" S REM=$G(^TMP("PSN PPSN PARSED",$J,"REM",OLDNDF))
"RTN","PSNPPSNU",59,0)
 .I REM'="" D REMATCH^PSNPPSNW(DA,REM)
"RTN","PSNPPSNU",60,0)
 .I PSN,$D(@ROOT3@(PR)) K ^PSDRUG(DA,"DOS"),^("DOS1"),^("DOS2")
"RTN","PSNPPSNU",61,0)
 .S ND=$G(^PSDRUG(DA,"ND")),PR=$P(ND,"^",3) I PR D
"RTN","PSNPPSNU",62,0)
 ..S NFI=$P($G(^PSNDF(50.68,PR,5)),"^") I $P(ND,"^",11)'=NFI S DIE=50,DR="29////"_NFI_";" D ^DIE D ERROR:$D(ERROR("DIERR"))
"RTN","PSNPPSNU",63,0)
 ..S VAC=$P($G(^PSNDF(50.68,PR,3)),"^") I VAC S VAC=$P(^PS(50.605,VAC,0),"^"),DIE=50,DR="2////"_VAC_";" D ^DIE D ERROR:$D(ERROR("DIERR"))
"RTN","PSNPPSNU",64,0)
 ..I $P($G(^PSDRUG(DA,3)),"^"),'$P($G(^PSNDF(50.68,PR,1)),"^",3) S DIE=50,DR="213////0;" D ^DIE D ERROR:$D(ERROR("DIERR")) K DIE,DR S IND=$O(^PSDRUG(DA,4," "),-1),$P(^(IND,0),"^",6)="NDF Update"
"RTN","PSNPPSNU",65,0)
 .;S TREC=TREC+1 I '(TREC#500) D UPDATE^XPDID(TREC)
"RTN","PSNPPSNU",66,0)
 D DRGMSG^PSNPPSMG
"RTN","PSNPPSNU",67,0)
 ;package specific post install
"RTN","PSNPPSNU",68,0)
 I $D(^TMP("PSN PPSN PARSED",$J,"POST")) S POST=^("POST") S:POST'["^" POST="^"_POST I @("$T("_POST_")]]""""") D @POST
"RTN","PSNPPSNU",69,0)
 ;
"RTN","PSNPPSNU",70,0)
 ;call to HL7 drug update message
"RTN","PSNPPSNU",71,0)
 I $T(PSN^PSSHUIDG)]"" I $O(^TMP($J,"^",0)) S ZTRTN="PSN^PSSHUIDG",ZTIO="",ZTDTH=$H,ZTDESC="DRUG UPDATE MESSAGE",ZTSAVE("^TMP($J,""^"",")="" D ^%ZTLOAD
"RTN","PSNPPSNU",72,0)
 ;
"RTN","PSNPPSNU",73,0)
 D CTRKDL^PSNPPSMS("Validating cross references")
"RTN","PSNPPSNU",74,0)
 W:'$G(PSNSCJOB) !,"Validating cross references...",!
"RTN","PSNPPSNU",75,0)
REINDEX ;Make sure APC xref is correct
"RTN","PSNPPSNU",76,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",6)="REINDEX"
"RTN","PSNPPSNU",77,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSNU",78,0)
 K FDA
"RTN","PSNPPSNU",79,0)
 I $T(EN2^GMRAUIX0)']"" G MORE
"RTN","PSNPPSNU",80,0)
 N SUB,DA,DIK,GMRAIEN,CLASS
"RTN","PSNPPSNU",81,0)
 S SUB=0 F  S SUB=$O(^GMR(120.8,SUB)) Q:'+SUB  I $D(^GMR(120.8,SUB,3)) D
"RTN","PSNPPSNU",82,0)
 .S GMRAIEN=+$P($G(^GMR(120.8,SUB,0)),U) Q:'GMRAIEN
"RTN","PSNPPSNU",83,0)
 .S CLASS="" F  S CLASS=$O(^GMR(120.8,"APC",GMRAIEN,CLASS)) Q:CLASS=""  K ^GMR(120.8,"APC",GMRAIEN,CLASS,SUB)
"RTN","PSNPPSNU",84,0)
 .S DA(1)=SUB
"RTN","PSNPPSNU",85,0)
 .S DIK="^GMR(120.8,DA(1),3,"
"RTN","PSNPPSNU",86,0)
 .S DIK(1)=".01^ADRG3"
"RTN","PSNPPSNU",87,0)
 .D ENALL^DIK ;Reset the drug class xref
"RTN","PSNPPSNU",88,0)
 ;
"RTN","PSNPPSNU",89,0)
MORE ; REINDEXING
"RTN","PSNPPSNU",90,0)
 D CTRKDL^PSNPPSMS("Reindexing")
"RTN","PSNPPSNU",91,0)
 ;now the APD
"RTN","PSNPPSNU",92,0)
 K ^PS(50.416,"APD") S DA=0 F  S DA=$O(^PS(50.416,DA)),K=0 Q:'DA  F  S K=$O(^PS(50.416,DA,1,K)) Q:'K  S X=^(K,0),^PS(50.416,"APD",X,DA)=""
"RTN","PSNPPSNU",93,0)
 ;now the interactions
"RTN","PSNPPSNU",94,0)
 K ^PS(56,"APD") S DA=0 F  S DA=$O(^PS(56,DA)) Q:'DA  K PSN1,PSN2 S PSN1=$P(^(DA,0),"^",2),PSN2=$P(^(0),"^",3) D
"RTN","PSNPPSNU",95,0)
 .S NA="" F  S NA=$O(^PS(50.416,PSN1,1,"B",NA)) Q:NA=""  S PSN1(NA)=""
"RTN","PSNPPSNU",96,0)
 .S PSN11=0 F  S PSN11=$O(^PS(50.416,"APS",PSN1,PSN11)),NA="" Q:'PSN11  F  S NA=$O(^PS(50.416,PSN11,1,"B",NA)) Q:NA=""  S PSN1(NA)=""
"RTN","PSNPPSNU",97,0)
 .S NA="" F  S NA=$O(^PS(50.416,PSN2,1,"B",NA)) Q:NA=""  S PSN2(NA)=""
"RTN","PSNPPSNU",98,0)
 .S PSN21=0 F  S PSN21=$O(^PS(50.416,"APS",PSN2,PSN21)),NA="" Q:'PSN21  F  S NA=$O(^PS(50.416,PSN21,1,"B",NA)) Q:NA=""  S PSN2(NA)=""
"RTN","PSNPPSNU",99,0)
 .S PSN1="" F  S PSN1=$O(PSN1(PSN1)),PSN2="" Q:PSN1=""  F  S PSN2=$O(PSN2(PSN2)) Q:PSN2=""  S ^PS(56,"APD",PSN1,PSN2,DA)="",^PS(56,"APD",PSN2,PSN1,DA)=""
"RTN","PSNPPSNU",100,0)
 ;
"RTN","PSNPPSNU",101,0)
 D ^PSNPPSCL
"RTN","PSNPPSNU",102,0)
 D ERRORMS^PSNPPSMS
"RTN","PSNPPSNU",103,0)
 ;
"RTN","PSNPPSNU",104,0)
QUIT ;
"RTN","PSNPPSNU",105,0)
 ;D UPDATE^XPDID(XPDIDTOT)
"RTN","PSNPPSNU",106,0)
 K CL,CLA,CMOP,CT,DA,DA1,DIA,DIC,DIE,DIK,DINUM,DR,FDA,FILE,FLDS,GE,GROOT,GROOT1,IENS,IN,INA,IND,INDX,INV,J,JJ,K,LI,LINE,NA,NAME,ND,NEW,NFI,POST,PR,PSN,PSN1,PSN11,PSN21,PSNDF,R1,ROOT,ROOT1,ROOT2,ROOT3,SUBS,VAC,VAIN,VAPN
"RTN","PSNPPSNU",107,0)
 K X,XMDUZ,XMSUB,XMTEXT,XMY,XMZ,XUMF,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE
"RTN","PSNPPSNU",108,0)
 K ^TMP($J),^TMP("PSN",$J),^TMP("PSNN",$J),^TMP("PSN PPSN ERR",$J),^TMP("PSNINGRED",$J)
"RTN","PSNPPSNU",109,0)
 Q
"RTN","PSNPPSNU",110,0)
 ;
"RTN","PSNPPSNU",111,0)
ERROR ;Track file errors
"RTN","PSNPPSNU",112,0)
 D APPERROR^%ZTER("PPSN ERROR")
"RTN","PSNPPSNU",113,0)
 N PSNERRC,ERRFILE,ERRIEN
"RTN","PSNPPSNU",114,0)
 S PSNERROR=PSNERROR+1,PSNERRC=0,ERRFILE=0,ERRIEN=0
"RTN","PSNPPSNU",115,0)
 F  S PSNERRC=$O(ERROR("DIERR",PSNERRC)) Q:'PSNERRC  D:$D(ERROR("DIERR",PSNERRC,"TEXT",1))
"RTN","PSNPPSNU",116,0)
 .S ERRFILE=$G(ERROR("DIERR",PSNERRC,"PARAM","FILE")) S ERRIEN=$S("^351^352^311^"[("^"_$G(ERROR("DIERR",PSNERRC))_"^"):" ",1:$P(DIA,"^"))
"RTN","PSNPPSNU",117,0)
 .S ^TMP("PSN PPSN ERR",$J,PSNTMPN,$S($G(ERRFILE):ERRFILE,$G(FILE)'="":FILE,1:ROOT),ERRIEN,$P(DIA,"^",3),PSNERROR)=ERROR("DIERR",PSNERRC,"TEXT",1)_"|"_$S($G(FILE)'="":FILE,1:ROOT)_"-"_$P(DIA,"^",3)_"|"_NEW
"RTN","PSNPPSNU",118,0)
 Q
"RTN","PSNPPSNU",119,0)
 ;
"RTN","PSNPPSNU",120,0)
ERROR2(PSNERRN,PSNERRF,PSNERRIE,PSNERRFL,PSNERRTY) ;Track DICN errors
"RTN","PSNPPSNU",121,0)
 D APPERROR^%ZTER("PPSN ERROR2")
"RTN","PSNPPSNU",122,0)
 S PSNERROR=PSNERROR+1,PSNERRC=""
"RTN","PSNPPSNU",123,0)
 S ^TMP("PSN PPSN ERR",$J,PSNERRN,PSNERRF,PSNERRIE,PSNERRFL,PSNERRTY)=DIA_"^"_NEW
"RTN","PSNPPSNU",124,0)
 Q
"RTN","PSNPPSNU",125,0)
STRIP(X) ; Strip control characters
"RTN","PSNPPSNU",126,0)
 N I,Y
"RTN","PSNPPSNU",127,0)
 S Y="" F I=1:1:$L(X) S:$A(X,I)>31 Y=Y_$E(X,I)
"RTN","PSNPPSNU",128,0)
 Q Y
"RTN","PSNPPSNU",129,0)
 ;
"RTN","PSNPPSNU",130,0)
UNMDRG ; Unmatch Drug File entry
"RTN","PSNPPSNU",131,0)
 N PIECE,PRDNAM
"RTN","PSNPPSNU",132,0)
 S PRDNAM=$P(^PSDRUG(DA,"ND"),"^",2)
"RTN","PSNPPSNU",133,0)
 F PIECE=1:1:5,10,11 S $P(^PSDRUG(DA,"ND"),"^",PIECE)=""
"RTN","PSNPPSNU",134,0)
 I PRDNAM'="" S PRDNAM=$E(PRDNAM,1,30) K ^PSDRUG("VAPN",PRDNAM,DA)
"RTN","PSNPPSNU",135,0)
 Q
"RTN","PSNPPSNV")
0^12^B179018356^n/a
"RTN","PSNPPSNV",1,0)
PSNPPSNV ;HP/MJE-PPSN update NDF data additional update code ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSNV",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNPPSNV",3,0)
 ;Reference to ^PS(59.7 supported by DBIA #2613
"RTN","PSNPPSNV",4,0)
 ;
"RTN","PSNPPSNV",5,0)
 Q
"RTN","PSNPPSNV",6,0)
DATA ;Process DATA transactions
"RTN","PSNPPSNV",7,0)
 K FDA
"RTN","PSNPPSNV",8,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",6)="DATA"
"RTN","PSNPPSNV",9,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSNV",10,0)
 K FDA
"RTN","PSNPPSNV",11,0)
 I '$D(^TMP("PSN PPSN PARSED",$J,"DATA")) Q
"RTN","PSNPPSNV",12,0)
 N DA,I,J,K,LINE,PSN,ROOT,X
"RTN","PSNPPSNV",13,0)
 S ROOT=$NA(^TMP("PSN PPSN PARSED",$J,"DATA")),J=0
"RTN","PSNPPSNV",14,0)
 F  S J=$O(@ROOT@(J)) Q:'J  S LINE=^(J),K=$L(LINE,"|")-1 F I=1:1:K S X=$P(LINE,"|",I),^TMP($J,$P(X,"^"))=$P(X,"^",2,4)
"RTN","PSNPPSNV",15,0)
 S DA=0 F  S DA=$O(^PSNDF(50.68,DA)) Q:'DA  S X=$P($G(^(DA,1)),"^",1,4) S:$D(^TMP($J,DA)) X=X_"^"_^(DA) S ^PSNDF(50.68,DA,1)=X
"RTN","PSNPPSNV",16,0)
 K ^TMP($J)
"RTN","PSNPPSNV",17,0)
 K DA,I,J,K,LINE,PSN,ROOT,X
"RTN","PSNPPSNV",18,0)
 Q
"RTN","PSNPPSNV",19,0)
 ;
"RTN","PSNPPSNV",20,0)
PMIUPDT ;Get PMI data and completly replace all globals 50.621-627
"RTN","PSNPPSNV",21,0)
 N FDA,DA,I,J,K,LINE,PSN,ROOT,X
"RTN","PSNPPSNV",22,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",6)="PMIDATA"
"RTN","PSNPPSNV",23,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSNV",24,0)
 N FDA,DA,I,J,K,LINE,PSN,X
"RTN","PSNPPSNV",25,0)
 I $D(^TMP("PSN PPSN PARSED",$J,"PMIDATA")) F PSN=50.621:.001:50.627 K ^PS(PSN)
"RTN","PSNPPSNV",26,0)
 S ROOT=$NA(^TMP("PSN PPSN PARSED",$J,"DATA")),J=0
"RTN","PSNPPSNV",27,0)
 K ^TMP($J)
"RTN","PSNPPSNV",28,0)
 F  S J=$O(@ROOT@(J)) Q:'J  S LINE=^(J),K=$L(LINE,"|")-1 F I=1:1:K S X=$P(LINE,"|",I),^TMP($J,$P(X,"^"))=$P(X,"^",2,4)
"RTN","PSNPPSNV",29,0)
 S DA=0 F  S DA=$O(^PSNDF(50.68,DA)) Q:'DA  S X=$P($G(^(DA,1)),"^",1,4) S:$D(^TMP($J,DA)) X=X_"^"_^(DA) S ^PSNDF(50.68,DA,1)=X
"RTN","PSNPPSNV",30,0)
 K ^TMP($J)
"RTN","PSNPPSNV",31,0)
 I $D(^TMP("PSN PPSN PARSED",$J,"PMIDATA")) F PSN=50.621:.001:50.627 M ^PS(PSN)=^TMP("PSN PPSN PARSED",$J,"PMIDATA",PSN)
"RTN","PSNPPSNV",32,0)
 K DA,I,J,K,LINE,PSN,ROOT,X
"RTN","PSNPPSNV",33,0)
 Q
"RTN","PSNPPSNV",34,0)
 ;
"RTN","PSNPPSNV",35,0)
TASKIT(FREQ,START) ; create/update PSNTUPDT option start time and frequency
"RTN","PSNPPSNV",36,0)
 ; Input:
"RTN","PSNPPSNV",37,0)
 ;   FREQ  - Optional
"RTN","PSNPPSNV",38,0)
 ;  START  - Optional
"RTN","PSNPPSNV",39,0)
 ;
"RTN","PSNPPSNV",40,0)
 K PSERROR
"RTN","PSNPPSNV",41,0)
 D NOW^%DTC S %DT(0)=%,%DT="EFATX",%DT("A")="Enter date/time: " D ^%DT
"RTN","PSNPPSNV",42,0)
 S START=$$FMADD^XLFDT(Y,0,0,5)
"RTN","PSNPPSNV",43,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",44,0)
 S DIR("A")="Should this NDF update install be re-scheduled at the same time weekly" W !!
"RTN","PSNPPSNV",45,0)
 S DIR("B")="NO"
"RTN","PSNPPSNV",46,0)
 D ^DIR
"RTN","PSNPPSNV",47,0)
 I Y S FREQ="7D" G END
"RTN","PSNPPSNV",48,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",49,0)
 S DIR("A")="Should this NDF update install be re-scheduled at the same time daily" W !!
"RTN","PSNPPSNV",50,0)
 S DIR("B")="NO"
"RTN","PSNPPSNV",51,0)
 D ^DIR
"RTN","PSNPPSNV",52,0)
 I Y S FREQ="1D" G END
"RTN","PSNPPSNV",53,0)
 I 'Y D
"RTN","PSNPPSNV",54,0)
 .W !!,"Warning! The NDF update install you have scheduled will occur only once."
"RTN","PSNPPSNV",55,0)
 .S FREQ=""
"RTN","PSNPPSNV",56,0)
END ;
"RTN","PSNPPSNV",57,0)
 W !,"Your start time is:"
"RTN","PSNPPSNV",58,0)
 D RESCH^XUTMOPT("PSN TASK SCHEDULED INSTALL",START,"",FREQ,"L",.PSERROR)
"RTN","PSNPPSNV",59,0)
 I +FREQ=1 W !!,"The NDF update install will automatically be re-scheduled Daily",!
"RTN","PSNPPSNV",60,0)
 I +FREQ=7 W !!,"The NDF update install will automatically be re-scheduled Weekly",!
"RTN","PSNPPSNV",61,0)
 I FREQ="" W !!,"The NDF update install will NOT automatically be re-scheduled",!
"RTN","PSNPPSNV",62,0)
 K DIR S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",63,0)
 Q
"RTN","PSNPPSNV",64,0)
 ;
"RTN","PSNPPSNV",65,0)
SCHDOPT ; edit option PSNTUPDT/PSN TASK SCHEDULE INSTALL to create and/or edit the scheduling date/time
"RTN","PSNPPSNV",66,0)
 ; Called from "PSN PPS SCHEDULE INSTALL" option to create and/or edit the scheduling
"RTN","PSNPPSNV",67,0)
 N PSNLEGF
"RTN","PSNPPSNV",68,0)
 I '$D(^XUSEC("PSN PPS ADMIN",DUZ)) D
"RTN","PSNPPSNV",69,0)
 .W !!,"You do not have the appropriate security key to use this option"
"RTN","PSNPPSNV",70,0)
 .W !,"please contact your ADPAC to resolve this issue.",!
"RTN","PSNPPSNV",71,0)
 .S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",72,0)
 I '$D(^XUSEC("PSN PPS ADMIN",DUZ)) Q
"RTN","PSNPPSNV",73,0)
 S PSNLEGF="",PSNLEGF=$$LEGACY^PSNPPSDL() I PSNLEGF Q
"RTN","PSNPPSNV",74,0)
 W !!!,"This option allows you to schedule a recurring TaskMan job to perform the NDF"
"RTN","PSNPPSNV",75,0)
 W !,"update installation from PPS-N."
"RTN","PSNPPSNV",76,0)
 W !!,"Warning! This NDF update install should be scheduled during non-peak hours."
"RTN","PSNPPSNV",77,0)
 W !!,"You will need to select a date/time and how often this update should reoccur."
"RTN","PSNPPSNV",78,0)
 ;
"RTN","PSNPPSNV",79,0)
 D SCHCK^PSNPPSDL("PSN TASK SCHEDULED INSTALL","I") ; print scheduled tasks
"RTN","PSNPPSNV",80,0)
 ;
"RTN","PSNPPSNV",81,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",82,0)
 S DIR("A")="Do you want to schedule an automatic NDF update install in TaskMan" W !!
"RTN","PSNPPSNV",83,0)
 S DIR("B")="NO"
"RTN","PSNPPSNV",84,0)
 D ^DIR
"RTN","PSNPPSNV",85,0)
 I 'Y Q 
"RTN","PSNPPSNV",86,0)
 N PSSROOT
"RTN","PSNPPSNV",87,0)
 D TASKIT(15)
"RTN","PSNPPSNV",88,0)
 Q
"RTN","PSNPPSNV",89,0)
 ;
"RTN","PSNPPSNV",90,0)
PROMPT ;
"RTN","PSNPPSNV",91,0)
 W @IOF I '$D(^XUSEC("PSN PPS ADMIN",DUZ)) D
"RTN","PSNPPSNV",92,0)
 .W !!,"You do not have the appropriate security key to use this option"
"RTN","PSNPPSNV",93,0)
 .W !,"please contact your ADPAC to resolve this issue.",!
"RTN","PSNPPSNV",94,0)
 .S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",95,0)
 I '$D(^XUSEC("PSN PPS ADMIN",DUZ)) Q
"RTN","PSNPPSNV",96,0)
 W !!,"This option allows a user to setup the following PPS-N configuration settings:"
"RTN","PSNPPSNV",97,0)
 W !!,"1) The Cache host disk directory path that will be used for location of the"
"RTN","PSNPPSNV",98,0)
 W !,"   PPS-N weekly NDF update file/s."
"RTN","PSNPPSNV",99,0)
 W !!,"2) The last successful INSTALL version number of the PPS-N update file."
"RTN","PSNPPSNV",100,0)
 W !,"   This is the UPDT option version number."
"RTN","PSNPPSNV",101,0)
 W !!,"3) The last successful DOWNLOAD version number of the PPS-N update file."
"RTN","PSNPPSNV",102,0)
 W !,"   This is the DNLD option version number."
"RTN","PSNPPSNV",103,0)
 W !!,"4) The Exchange email Group or Individual email address that the PPS-N national"
"RTN","PSNPPSNV",104,0)
 W !,"   and locally generated reports will be sent to."
"RTN","PSNPPSNV",105,0)
 W !!,"5) The PPS-N mail group for the PPSN NATIONAL TEST SQA email status."
"RTN","PSNPPSNV",106,0)
 W !!,"6) The Scheduled Options, Menu Options, and Protocols that should be paused"
"RTN","PSNPPSNV",107,0)
 W !,"   while the PPS-n update file is processed."
"RTN","PSNPPSNV",108,0)
 W !!,"7) The PPS-N NATIONAL SQA ACCOUNT (Q)A, (P)roduction, Product (S)upport"
"RTN","PSNPPSNV",109,0)
 W !,"    or (T)est."
"RTN","PSNPPSNV",110,0)
 W !
"RTN","PSNPPSNV",111,0)
 W ! K DIR S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",112,0)
 Q:Y="^"!(Y=0)
"RTN","PSNPPSNV",113,0)
 W @IOF,!!
"RTN","PSNPPSNV",114,0)
 W !,"At the prompt please enter the specific VMS or Linux directory path name"
"RTN","PSNPPSNV",115,0)
 W !,"where the PPS-N update file/s will be located. If you are not familiar with"
"RTN","PSNPPSNV",116,0)
 W !,"the required information please consult your ADPAC."
"RTN","PSNPPSNV",117,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",118,0)
 S DIR("A")="Do you want to change the disk directory path for PPS-N Update files" W !
"RTN","PSNPPSNV",119,0)
 S DIR("B")="NO"
"RTN","PSNPPSNV",120,0)
 D ^DIR
"RTN","PSNPPSNV",121,0)
 Q:Y="^"
"RTN","PSNPPSNV",122,0)
 I Y D PATH
"RTN","PSNPPSNV",123,0)
 ;
"RTN","PSNPPSNV",124,0)
UPDT ;
"RTN","PSNPPSNV",125,0)
 W @IOF,!!!,"At the prompt you can change the last successful update version number"
"RTN","PSNPPSNV",126,0)
 W !,"of the PPS-N update file.  This is for the UPDT option."
"RTN","PSNPPSNV",127,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",128,0)
 S DIR("A")="Do you want to change the version number of the PPS-N Update files" W !
"RTN","PSNPPSNV",129,0)
 S DIR("B")="NO"
"RTN","PSNPPSNV",130,0)
 D ^DIR
"RTN","PSNPPSNV",131,0)
 Q:Y="^"
"RTN","PSNPPSNV",132,0)
 I Y D INSTV
"RTN","PSNPPSNV",133,0)
 K DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSNV",134,0)
DNLD ;
"RTN","PSNPPSNV",135,0)
 W @IOF,!!!,"At the prompt you can change the last successful DOWNLOAD version number"
"RTN","PSNPPSNV",136,0)
 W !,"of the PPS-N update file.  This is for the DNLD option."
"RTN","PSNPPSNV",137,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",138,0)
 S DIR("A")="Do you want to change the DOWNLOAD version number of the PPS-N files" W !
"RTN","PSNPPSNV",139,0)
 S DIR("B")="NO"
"RTN","PSNPPSNV",140,0)
 D ^DIR
"RTN","PSNPPSNV",141,0)
 Q:Y="^"
"RTN","PSNPPSNV",142,0)
 I Y D DNLDV
"RTN","PSNPPSNV",143,0)
 K DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSNV",144,0)
DEMAIL ;
"RTN","PSNPPSNV",145,0)
 W @IOF,!!!,"At the prompt you can change the Exchange email Group or Individual"
"RTN","PSNPPSNV",146,0)
 W !,"email address that the PPS-N national and locally generated reports"
"RTN","PSNPPSNV",147,0)
 W !,"will be sent to."
"RTN","PSNPPSNV",148,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",149,0)
 S DIR("A")="Do you want to change the email address for the PPS-N update reports" W !
"RTN","PSNPPSNV",150,0)
 S DIR("B")="NO"
"RTN","PSNPPSNV",151,0)
 D ^DIR
"RTN","PSNPPSNV",152,0)
 Q:Y="^"
"RTN","PSNPPSNV",153,0)
 I Y D EMAIL
"RTN","PSNPPSNV",154,0)
 K DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSNV",155,0)
 ;
"RTN","PSNPPSNV",156,0)
 W @IOF,!!!,"At the prompt you can change the Exchange email Group or Individual"
"RTN","PSNPPSNV",157,0)
 W !,"email address that the PPS-N PPSN NATIONAL TEST SQA emails will be sent to."
"RTN","PSNPPSNV",158,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",159,0)
 S DIR("A")="Change the email address for the PPS-N PPSN NATIONAL TEST SQA emails" W !
"RTN","PSNPPSNV",160,0)
 S DIR("B")="NO"
"RTN","PSNPPSNV",161,0)
 D ^DIR
"RTN","PSNPPSNV",162,0)
 Q:Y="^"
"RTN","PSNPPSNV",163,0)
 I Y D SQAMAIL
"RTN","PSNPPSNV",164,0)
 K DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSNV",165,0)
 ;
"RTN","PSNPPSNV",166,0)
 D DISOPTS^PSNPPSNR
"RTN","PSNPPSNV",167,0)
 K DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSNV",168,0)
TYPE ;
"RTN","PSNPPSNV",169,0)
 W @IOF,!!!,"At the prompt you can change the PPS-N NATIONAL SQA ACCOUNT"
"RTN","PSNPPSNV",170,0)
 K DIRUT,DUOUT,DTOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",171,0)
 S DIR("A")="Do you want to change the PPS-N PPSN NATIONAL TEST SQA" W !
"RTN","PSNPPSNV",172,0)
 S DIR("B")="NO"
"RTN","PSNPPSNV",173,0)
 D ^DIR
"RTN","PSNPPSNV",174,0)
 Q:Y="^"!('Y)
"RTN","PSNPPSNV",175,0)
TYPE2 ;
"RTN","PSNPPSNV",176,0)
 N TYPE
"RTN","PSNPPSNV",177,0)
 S TYPE="",TYPE=$P($G(^PS(59.7,1,10)),"^",12)
"RTN","PSNPPSNV",178,0)
 W !!,"Your current PPS-N NATIONAL SQA ACCOUNT is set to: " W TYPE_" "_$S(TYPE="Q":"for National SQA Testing",TYPE="P":"for Production",TYPE="T":"for Test Account",TYPE="S":"for Product Support",1:"")
"RTN","PSNPPSNV",179,0)
 ;W !!,"Please enter PPS-N NATIONAL SQA ACCOUNT"
"RTN","PSNPPSNV",180,0)
TYPE3 ;
"RTN","PSNPPSNV",181,0)
 W !,"P = Production",?40,"T = Test Account"
"RTN","PSNPPSNV",182,0)
 W !,"S = Product Support",?40,"Q = QA National Testing"
"RTN","PSNPPSNV",183,0)
 W !,"N = QA NDFMS",!
"RTN","PSNPPSNV",184,0)
 R !,"Enter selection: ",X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSNPPSNV",185,0)
 I X["?" D  G TYPE2
"RTN","PSNPPSNV",186,0)
 .W !!?5,"This parameter determines if the system is SQA National Testing site,"
"RTN","PSNPPSNV",187,0)
 .W !?5,"Testing Account, Product Support or a Production site. Enter P for"
"RTN","PSNPPSNV",188,0)
 .W !,?5,"Production, T for Test Account, S for Product Support, Q for SQA"
"RTN","PSNPPSNV",189,0)
 .W !,?5,"National Testing or N for QA NDFMS account.",!
"RTN","PSNPPSNV",190,0)
 .W !!?5,"Local sites should define this parameter as P for Production or T for"
"RTN","PSNPPSNV",191,0)
 .W !?5,"their Test Account. Product support should use S. SQA National Testing"
"RTN","PSNPPSNV",192,0)
 .W !?5,"should team should have one account defined Q for QA, a different"
"RTN","PSNPPSNV",193,0)
 .w !?5,"account for P for Production, and another for N for QA NDFMS."
"RTN","PSNPPSNV",194,0)
 Q:X="^"
"RTN","PSNPPSNV",195,0)
 I ",S,Q,T,P,N,"'[(","_X_",") W !!,"You must enter P, T, S, Q or N",! G TYPE2
"RTN","PSNPPSNV",196,0)
 I X'=""&(X'="^")&($L(X)'=0) D
"RTN","PSNPPSNV",197,0)
 .S $P(^PS(59.7,1,10),"^",12)=X
"RTN","PSNPPSNV",198,0)
 .W !!,"You changed the PPS-N NATIONAL SQA ACCOUNT to: " W X
"RTN","PSNPPSNV",199,0)
 .W ! K DIR S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",200,0)
 K DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSNV",201,0)
 Q
"RTN","PSNPPSNV",202,0)
 ;
"RTN","PSNPPSNV",203,0)
PATH ;
"RTN","PSNPPSNV",204,0)
 W !!,"Your current update file path is set to: ",$$GETD^PSNFTP()
"RTN","PSNPPSNV",205,0)
 W !!,"Please enter the complete directory path: " R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSNPPSNV",206,0)
 I X["?" D  G PATH
"RTN","PSNPPSNV",207,0)
 .W !!?5,"Enter the operating system full directory path where the PPS-N Update",!?5,"file(s) will be stored."
"RTN","PSNPPSNV",208,0)
 .W "  Refer to the NDF Technical manual and/or",!?5,"contact your IRM for more information."
"RTN","PSNPPSNV",209,0)
 .W !?10,"Example:  ABC$:[USER.PPSN]"
"RTN","PSNPPSNV",210,0)
 I X'=""&(X'="^")&(X'="?") D
"RTN","PSNPPSNV",211,0)
 .D SETD(X)
"RTN","PSNPPSNV",212,0)
 .W !!,"You changed the directory path to: " W X
"RTN","PSNPPSNV",213,0)
 .W ! K DIR S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",214,0)
 Q
"RTN","PSNPPSNV",215,0)
 ;
"RTN","PSNPPSNV",216,0)
INSTV ;
"RTN","PSNPPSNV",217,0)
 W !!,"Your current PPS-N INSTALL file version number is set to: " W:$D(^PS(57.23,1,0)) $P(^PS(57.23,1,0),"^",3) W !
"RTN","PSNPPSNV",218,0)
 W !,"Please enter the current PPS-N update file version number: " R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSNPPSNV",219,0)
 I X["?" D  G INSTV
"RTN","PSNPPSNV",220,0)
 .W !!?5,"Enter the last file version installed on the system. If the last file"
"RTN","PSNPPSNV",221,0)
 .W !?5,"name installed was PPS_15PRV_16NEW.DAT, the last file version would be 16."
"RTN","PSNPPSNV",222,0)
 I X'=""&(X'="^")&($L(X)'=0)&(X'="?") D
"RTN","PSNPPSNV",223,0)
 .S $P(^PS(57.23,1,0),"^",3)=X
"RTN","PSNPPSNV",224,0)
 .W !!,"You changed the INSTALL file version number to: " W X
"RTN","PSNPPSNV",225,0)
 .W ! K DIR S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",226,0)
 Q
"RTN","PSNPPSNV",227,0)
 ;
"RTN","PSNPPSNV",228,0)
DNLDV ;
"RTN","PSNPPSNV",229,0)
 W !!,"Your current PPS-N DOWNLOAD file version number is set to: " W:$D(^PS(57.23,1,0)) $P(^PS(57.23,1,0),"^",7) W !
"RTN","PSNPPSNV",230,0)
 W !,"Please enter the current PPS-N DOWNLOAD file version number: " R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSNPPSNV",231,0)
 I X["?" D  G DNLDV
"RTN","PSNPPSNV",232,0)
 .W !!?5,"Enter the last file version downloaded to the system. If the last file"
"RTN","PSNPPSNV",233,0)
 .W !?5,"name downloaded was PPS_15PRV_16NEW.DAT, the last file version would be 16."
"RTN","PSNPPSNV",234,0)
 I X'=""&(X'="^")&($L(X)'=0)&(X'="?") D
"RTN","PSNPPSNV",235,0)
 .S $P(^PS(57.23,1,0),"^",7)=X
"RTN","PSNPPSNV",236,0)
 .W !!,"You changed the DOWNLOAD file version number to: " W X
"RTN","PSNPPSNV",237,0)
 .W ! K DIR S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",238,0)
 Q
"RTN","PSNPPSNV",239,0)
 ;
"RTN","PSNPPSNV",240,0)
EMAIL ;
"RTN","PSNPPSNV",241,0)
 W !!,"Your current email address is set to: " W:$D(^PS(57.23,1,0)) $P($G(^PS(57.23,1,0)),"^",6) W !
"RTN","PSNPPSNV",242,0)
 W !,"Please enter the email address: " R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSNPPSNV",243,0)
 I X["?" D  G EMAIL
"RTN","PSNPPSNV",244,0)
 .W !!?5,"Enter an email address for receiving PPS-N download, install and error"
"RTN","PSNPPSNV",245,0)
 .W !?5,"messages.  This is typically an MS Outlook email address since holders "
"RTN","PSNPPSNV",246,0)
 .W !?5,"of the PSN PPS ADMIN key will continue to receive the NDF update messages."
"RTN","PSNPPSNV",247,0)
 .W !?5,"These messages include success, completion, error, and the report"
"RTN","PSNPPSNV",248,0)
 .W !?5,"messages like DATA UPDATE FROM NDF, etc."
"RTN","PSNPPSNV",249,0)
 I X'=""&(X'="^")&($L(X)'=0)&(X'="?") D
"RTN","PSNPPSNV",250,0)
 .S $P(^PS(57.23,1,0),"^",6)=X
"RTN","PSNPPSNV",251,0)
 .W !!,"You changed the email address to: " W X
"RTN","PSNPPSNV",252,0)
 .W ! K DIR S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",253,0)
 Q
"RTN","PSNPPSNV",254,0)
 ;
"RTN","PSNPPSNV",255,0)
SQAMAIL ;
"RTN","PSNPPSNV",256,0)
 W !!,"Your current email address is set to: " W:$D(^PS(57.23,1,1)) $P($G(^PS(57.23,1,1)),"^",1) W !
"RTN","PSNPPSNV",257,0)
 W !,"Please enter the email address: " R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSNPPSNV",258,0)
 I X["?" D  G SQAMAIL
"RTN","PSNPPSNV",259,0)
 .W !!?5,"Enter an email address for receiving PPS-N download, install and error"
"RTN","PSNPPSNV",260,0)
 .W !?5,"messages.  This is used by SQA for a secondary email group if needed."
"RTN","PSNPPSNV",261,0)
 .W !?5,"Typically an MS Outlook email address is defined since holders of the"
"RTN","PSNPPSNV",262,0)
 .W !?5,"PSN PPS ADMIN key will continue to receive the NDF update messages.  These"
"RTN","PSNPPSNV",263,0)
 .W !?5,"messages include success, completion, error, and the report messages like"
"RTN","PSNPPSNV",264,0)
 .W !?5," DATA UPDATE FROM NDF, etc."
"RTN","PSNPPSNV",265,0)
 I X'=""&(X'="^")&($L(X)'=0)&(X'="?") D
"RTN","PSNPPSNV",266,0)
 .S $P(^PS(57.23,1,1),"^",1)=X
"RTN","PSNPPSNV",267,0)
 .W !!,"You changed the email address to: " W X
"RTN","PSNPPSNV",268,0)
 .W ! K DIR S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",269,0)
 Q
"RTN","PSNPPSNV",270,0)
 ;
"RTN","PSNPPSNV",271,0)
LOAD ;GET DOSE STUFF
"RTN","PSNPPSNV",272,0)
 N DA1
"RTN","PSNPPSNV",273,0)
 S J=2,X=$G(^PSDRUG(DA,"DOS")) I $P(X,"^"),$D(^PS(50.607,+$P(X,"^",2),0)) S ^TMP($J,INDX,NA_"^"_DA_"^"_IN,J)="    STRENGTH: "_+X_"UNITS: "_$P(^PS(50.607,+$P(X,"^",2),0),"^"),J=J+1
"RTN","PSNPPSNV",274,0)
 I $O(^PSDRUG(DA,"DOS1",0)) S ^TMP($J,INDX,NA_"^"_DA_"^"_IN,J)="    POSSIBLE DOSES",^(J+1)="    DISP UNITS/DOSE     DOSE    PACKAGE   BCMA UNITS/DOSE",DA1=0,J=J+2 D
"RTN","PSNPPSNV",275,0)
 .F  S DA1=$O(^PSDRUG(DA,"DOS1",DA1)) Q:'DA1  S X=^(DA1,0),^TMP($J,INDX,NA_"^"_DA_"^"_IN,J)="    "_$J($P(X,"^"),4),$E(^(J),25)=$J($P(X,"^",2),4),$E(^(J),35)=$P(X,"^",3),$E(^(J),43)=$P(X,"^",4),J=J+1
"RTN","PSNPPSNV",276,0)
 I $O(^PSDRUG(DA,"DOS2",0)) S ^TMP($J,INDX,NA_"^"_DA_"^"_IN,J)="    LOCAL POSSIBLE DOSES",^(J+1)="    DOSE                                            PACKAGE   BCMA UNITS/DOSE",DA1=0,J=J+2 D
"RTN","PSNPPSNV",277,0)
 .F  S DA1=$O(^PSDRUG(DA,"DOS2",DA1)) Q:'DA1  S X=^(DA1,0),^TMP($J,INDX,NA_"^"_DA_"^"_IN,J)="    "_$P(X,"^"),$E(^(J),55)=$P(X,"^",2),$E(^(J),71)=$P(X,"^",3),J=J+1
"RTN","PSNPPSNV",278,0)
 Q
"RTN","PSNPPSNV",279,0)
 ;
"RTN","PSNPPSNV",280,0)
SETD(X) ;
"RTN","PSNPPSNV",281,0)
 N PSOSX
"RTN","PSNPPSNV",282,0)
 S PSOSX=$$GETOS^PSNFTP()
"RTN","PSNPPSNV",283,0)
 I PSOSX["VMS" S $P(^PS(57.23,1,0),U,2)=X Q
"RTN","PSNPPSNV",284,0)
 I PSOSX["LINUX" S $P(^PS(57.23,1,0),U,4)=X Q
"RTN","PSNPPSNV",285,0)
 Q
"RTN","PSNPPSNW")
0^14^B35107109^n/a
"RTN","PSNPPSNW",1,0)
PSNPPSNW ;HP/MJE-PPSN update NDF data additional update code ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSNW",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNPPSNW",3,0)
 ;
"RTN","PSNPPSNW",4,0)
 ;Reference to ^PSSREF supported by DBIA #6391
"RTN","PSNPPSNW",5,0)
 ;Reference to ^PSDRUG supported by DBIA #221
"RTN","PSNPPSNW",6,0)
 ;Reference to ^PSSUTIL supported by DBIA #3107
"RTN","PSNPPSNW",7,0)
 ;Reference to ^PS(59.7 supported by DBIA #2613
"RTN","PSNPPSNW",8,0)
 ;
"RTN","PSNPPSNW",9,0)
REMATCH(DA,PSNFNM) ;called by PSNPPSNU
"RTN","PSNPPSNW",10,0)
 ;DA & DISPDRG are both local drug IEN
"RTN","PSNPPSNW",11,0)
 ;PSNFNM is IEN of NDF (50.68) entry to match to
"RTN","PSNPPSNW",12,0)
 N DISPDRG S DISPDRG=""
"RTN","PSNPPSNW",13,0)
 ;
"RTN","PSNPPSNW",14,0)
 S DISPDRG=DA
"RTN","PSNPPSNW",15,0)
 ;-vvvvvvvvv- from PSSDEE -vvvvvvvvv-
"RTN","PSNPPSNW",16,0)
 ;
"RTN","PSNPPSNW",17,0)
 N FLGNDF,K,NEWDF,NFI,NFR,NWND,NWPC1,NWPC3,OLDDF,PSNCLASS,PSNFL,PSNLOC,PSNNDF,PSNNEW,PSNOLD,PSNP,PSNPST,PSNSIZE
"RTN","PSNPPSNW",18,0)
 N PSNTYPE,PSNVADC,PSNW,VAID,REC
"RTN","PSNPPSNW",19,0)
ASKND ;  
"RTN","PSNPPSNW",20,0)
 D RSET,EN1(PSNFNM,DA)
"RTN","PSNPPSNW",21,0)
 D REACT S DA=DISPDRG I $D(^PSDRUG(DA,"ND")),$P(^PSDRUG(DA,"ND"),"^",2)]"" D
"RTN","PSNPPSNW",22,0)
 .S PSNP=$G(^PSDRUG(DA,"I")) I PSNP,PSNP<DT Q
"RTN","PSNPPSNW",23,0)
 .S NWND=^PSDRUG(DA,"ND"),NWPC1=$P(NWND,"^",1),NWPC3=$P(NWND,"^",3),DA=NWPC1,K=NWPC3 S X=$$PSJDF^PSNAPIS(DA,K) S NEWDF=$P(X,"^",2),DA=DISPDRG
"RTN","PSNPPSNW",24,0)
 .; changed PSSUTIL call 2nd argument to use 0 instead of 1 ('quiet' mode)
"RTN","PSNPPSNW",25,0)
 .D EN2^PSSUTIL(DISPDRG,0) S:'$D(OLDDF) OLDDF="" I OLDDF'=NEWDF S FLGNDF=1
"RTN","PSNPPSNW",26,0)
 .N X,Y,Z D
"RTN","PSNPPSNW",27,0)
 ..S X=$P($G(^PSDRUG(DISPDRG,0)),"^") Q:X=""
"RTN","PSNPPSNW",28,0)
 ..S Y=$G(^PSNDF(50.68,PSNFNM,1)),Z=$P(Y,"^",2),Y=$P(Y,"^")
"RTN","PSNPPSNW",29,0)
 ..S ^TMP($J,"REMATCHED",X)=Y_"^"_Z_"^"_DISPDRG_"^"_PSNFNM
"RTN","PSNPPSNW",30,0)
 Q
"RTN","PSNPPSNW",31,0)
 ;
"RTN","PSNPPSNW",32,0)
 ;-vvvvvvvvv- from PSSDEE1 -vvvvvvvvv-
"RTN","PSNPPSNW",33,0)
 ;
"RTN","PSNPPSNW",34,0)
RSET ;
"RTN","PSNPPSNW",35,0)
 S:$D(^PSDRUG(DA,"ND")) PSNID=$P(^PSDRUG(DA,"ND"),"^",10)
"RTN","PSNPPSNW",36,0)
 S PSNP=$G(^PSDRUG(DA,"I")) I PSNP,PSNP<DT Q:$D(^PSDRUG(DA,"I"))
"RTN","PSNPPSNW",37,0)
 S DA=DISPDRG D:$D(^PSDRUG(DA,"ND")) SETNULL  S:$D(^PSDRUG(DA,3)) $P(^PSDRUG(DA,3),"^",1)=0 K:$D(^PSDRUG("AQ",DA)) ^PSDRUG("AQ",DA)
"RTN","PSNPPSNW",38,0)
 I $D(PSNID),PSNID]"" K ^PSDRUG("AQ1",PSNID,DA) K PSNID
"RTN","PSNPPSNW",39,0)
 D ^PSSREF ; *OK
"RTN","PSNPPSNW",40,0)
 Q
"RTN","PSNPPSNW",41,0)
 ;
"RTN","PSNPPSNW",42,0)
SETNULL ;
"RTN","PSNPPSNW",43,0)
 S ZXZX=$P(^PSDRUG(DA,"ND"),"^",2),$P(^PSDRUG(DA,"ND"),"^",1)="",$P(^PSDRUG(DA,"ND"),"^",2)="",$P(^PSDRUG(DA,"ND"),"^",3)=""
"RTN","PSNPPSNW",44,0)
 S $P(^PSDRUG(DA,"ND"),"^",4)="",$P(^PSDRUG(DA,"ND"),"^",5)="",$P(^PSDRUG(DA,"ND"),"^",10)=""
"RTN","PSNPPSNW",45,0)
 I ZXZX]"" S ZXZX=$E(ZXZX,1,30) I $D(^PSDRUG("VAPN",ZXZX,DA)) K ^PSDRUG("VAPN",ZXZX,DA) K ZXZX
"RTN","PSNPPSNW",46,0)
 Q
"RTN","PSNPPSNW",47,0)
 ;
"RTN","PSNPPSNW",48,0)
 ;-vvvvvvvvv- from PSSUTIL -vvvvvvvvv-
"RTN","PSNPPSNW",49,0)
 ;
"RTN","PSNPPSNW",50,0)
EN1(PSNDIEN,PSN50IEN) ;Receive Drug entries that have been unmatched
"RTN","PSNPPSNW",51,0)
 N PSSLD,PSSPWXEX,X,DIC,DA
"RTN","PSNPPSNW",52,0)
 I PSNPS="N" S DIC="^NDFK(5000.2,",DIC(0)="LMXZ",X="",X=PSNDIEN K DD,DO D FILE^DICN D ERROR^PSNPPSNU:$D(ERROR("DIERR"))
"RTN","PSNPPSNW",53,0)
 Q:PSN50IEN=""
"RTN","PSNPPSNW",54,0)
 K ^PSDRUG(PSN50IEN,"DOS"),^PSDRUG(PSN50IEN,"DOS1")
"RTN","PSNPPSNW",55,0)
 K ^PSDRUG(PSN50IEN,"DOS2")
"RTN","PSNPPSNW",56,0)
 Q
"RTN","PSNPPSNW",57,0)
 ;
"RTN","PSNPPSNW",58,0)
 ;-vvvvvvvvv- from PSNOUT -vvvvvvvvv-
"RTN","PSNPPSNW",59,0)
 ;
"RTN","PSNPPSNW",60,0)
REACT ; code for reactivation of inactive drug in local drug file
"RTN","PSNPPSNW",61,0)
 I $O(^PSNDF(50.6,0)) S XX=$S('$D(^PSDRUG(DA,"ND")):1,1:$P(^("ND"),"^",2)="") I XX D
"RTN","PSNPPSNW",62,0)
 .;BLDIT^PSNCOMP is the heart of the matching, GONE is okay
"RTN","PSNPPSNW",63,0)
 .S (PSNB,PSNDRG,Z9)=DA,PSNLOC=$P(^PSDRUG(PSNB,0),"^",1) K ^PSNTRAN(PSNB) D GONE^PSNDRUG,BLDIT
"RTN","PSNPPSNW",64,0)
 .;CHK is below (needs cleaning - DONE), SET^PSNMRG & GONE are okay
"RTN","PSNPPSNW",65,0)
 .S DA=Z9 D CHK(DA),SET^PSNMRG,GONE^PSNDRUG K Z9,XX
"RTN","PSNPPSNW",66,0)
 Q
"RTN","PSNPPSNW",67,0)
 ;
"RTN","PSNPPSNW",68,0)
 ;-vvvvvvvvv- from PSNCOMP -vvvvvvvvv-
"RTN","PSNPPSNW",69,0)
 ;
"RTN","PSNPPSNW",70,0)
BLDIT ; START ATTEMPT TO MATCH
"RTN","PSNPPSNW",71,0)
 Q:'$D(^PSDRUG(PSNB,0))  Q:$P(^PSDRUG(PSNB,0),"^",1)']""
"RTN","PSNPPSNW",72,0)
 I $D(^PSDRUG(PSNB,"ND")),$P(^PSDRUG(PSNB,"ND"),"^",2)]"" Q
"RTN","PSNPPSNW",73,0)
 I $D(PSNFLB),$D(^PSNTRAN(PSNB,0)) Q
"RTN","PSNPPSNW",74,0)
 S XX=PSNFNM D KILL^PSNHIT S PSNFNM=XX K XX
"RTN","PSNPPSNW",75,0)
 ;*****  next line:  DEA check: implemented silent
"RTN","PSNPPSNW",76,0)
 D  Q:$D(PSNINACT)  Q:'$D(PSNDEA)  K PSNDEA
"RTN","PSNPPSNW",77,0)
 .K PSNINACT I $D(^PSDRUG(PSNB,"I")),$P(^PSDRUG(PSNB,"I"),"^",1)]"" S:+^PSDRUG(PSNB,"I")<DT PSNINACT=1
"RTN","PSNPPSNW",78,0)
 .S PSNDEA=$P(^PSDRUG(PSNB,0),"^",3)
"RTN","PSNPPSNW",79,0)
 .F VV=0,"I","M" I PSNDEA[VV S ^PSNTRAN(PSNB,0)="0^^^^^^^"_DUZ K VV,PSNDEA Q
"RTN","PSNPPSNW",80,0)
 .K VV Q
"RTN","PSNPPSNW",81,0)
 S PSNSIZE=$O(^PS(50.609,"B","OTHER",0)),PSNTYPE=$O(^PS(50.608,"B","OTHER",0))
"RTN","PSNPPSNW",82,0)
 S PSNNDF=$P(^PSNDF(50.68,PSNFNM,0),"^",2),PSNCLASS=$P(^PSNDF(50.68,PSNFNM,3),"^") ; GEN NM, CLASS
"RTN","PSNPPSNW",83,0)
 D SET
"RTN","PSNPPSNW",84,0)
 Q
"RTN","PSNPPSNW",85,0)
 ;-vvvvvvvvv- from PSNHIT -vvvvvvvvv- sets the match in ^PSNTRAN to be verified
"RTN","PSNPPSNW",86,0)
 ;
"RTN","PSNPPSNW",87,0)
SET S:'$D(^PSNTRAN(PSNB,0)) $P(^PSNTRAN(0),"^",4)=($P(^PSNTRAN(0),"^",4))+1,$P(^PSNTRAN(0),"^",3)=PSNB
"RTN","PSNPPSNW",88,0)
 S ^PSNTRAN(PSNB,0)=PSNNDF_"^"_PSNFNM_"^"_PSNCLASS_"^^"_PSNSIZE_"^^"_PSNTYPE_"^"_DUZ ;D PKI W:$D(IOF) @IOF 
"RTN","PSNPPSNW",89,0)
 S:'$D(PSNFL) PSNFL=0
"RTN","PSNPPSNW",90,0)
 Q
"RTN","PSNPPSNW",91,0)
 ;
"RTN","PSNPPSNW",92,0)
 ;
"RTN","PSNPPSNW",93,0)
 ;-vvvvvvvvv- from PSNVFY -vvvvvvvvv-
"RTN","PSNPPSNW",94,0)
 ;
"RTN","PSNPPSNW",95,0)
CHK(PSNB) ; 
"RTN","PSNPPSNW",96,0)
 I $D(PSNFL) Q:PSNFL
"RTN","PSNPPSNW",97,0)
 S PSNP=$G(^PSDRUG(PSNB,"I")) I PSNP,PSNP<DT K ^PSNTRAN(PSNB,0) Q
"RTN","PSNPPSNW",98,0)
 Q:'$D(^PSNTRAN(PSNB,0))  Q:$P(^PSNTRAN(PSNB,0),"^",9)="Y"  Q:'$P(^PSNTRAN(PSNB,0),"^",2)
"RTN","PSNPPSNW",99,0)
 S PSNPST=^PSNTRAN(PSNB,0),PSNOLD=$P(^PSDRUG(PSNB,0),U),PSNNEW=$P(^PSNDF(50.68,$P(PSNPST,"^",2),0),"^")
"RTN","PSNPPSNW",100,0)
 ; condensed from START^PSNVFY
"RTN","PSNPPSNW",101,0)
 S PSNW=1
"RTN","PSNPPSNW",102,0)
 S PSNVADC=$P(^PSNTRAN(PSNB,0),"^",3)
"RTN","PSNPPSNW",103,0)
 S NFI=$P($G(^PSNDF(50.68,PSNFNM,5)),"^"),NFR=$P($G(^PSNDF(50.68,PSNFNM,6,1,0)),"^")
"RTN","PSNPPSNW",104,0)
 S $P(^PSNTRAN(PSNB,0),"^",9)="Y",$P(^PSNTRAN(PSNB,0),"^",10)=DUZ
"RTN","PSNPPSNW",105,0)
 Q
"RTN","PSNPPSNW",106,0)
 ;
"RTN","PSNPPSNW",107,0)
REPORT ;
"RTN","PSNPPSNW",108,0)
 ;take data from ^TMP($J,"REMATCHED",GN_NM)= VA_PRT_NM ^ VA_PROD_ID
"RTN","PSNPPSNW",109,0)
 ;and put it into ^TMP("PSN PPSN PARSED",$J,"MESSAGE3",...
"RTN","PSNPPSNW",110,0)
 N NM,VANM,PSNDISPD,PSNVPRD,PSNVPRDN
"RTN","PSNPPSNW",111,0)
 N X S X="PPS-N Update File: "_$P(PSNHLD,";",1) D ADDLINE(X) S X="" D ADDLINE(X) ;add blank line after file name
"RTN","PSNPPSNW",112,0)
 I '$D(^TMP($J,"REMATCHED")) D MSGHDR(1) Q
"RTN","PSNPPSNW",113,0)
 D MSGHDR(0)
"RTN","PSNPPSNW",114,0)
 N X S (VANM,NM)="" F  S NM=$O(^TMP($J,"REMATCHED",NM)) Q:NM=""  D
"RTN","PSNPPSNW",115,0)
 .S VANM=$G(^TMP($J,"REMATCHED",NM)),VAID=$P(VANM,"^",2),PSNDISPD=$P(VANM,"^",3),PSNVPRD=$P(VANM,"^",4),VANM=$P(VANM,"^")
"RTN","PSNPPSNW",116,0)
 .S PSNVPRDN=$$GET1^DIQ(50.68,PSNVPRD,.01)
"RTN","PSNPPSNW",117,0)
 .S X="   "_NM_" ("_PSNDISPD_")" D ADDLINE(X)
"RTN","PSNPPSNW",118,0)
 .S X="    RE-MATCHED TO" D ADDLINE(X)
"RTN","PSNPPSNW",119,0)
 .S X="   "_VANM_"  ["_VAID_"]" D ADDLINE(X)
"RTN","PSNPPSNW",120,0)
 .S X="      "_PSNVPRDN_" ("_PSNVPRD_")" D ADDLINE(X)
"RTN","PSNPPSNW",121,0)
 .S X=" " D ADDLINE(X)
"RTN","PSNPPSNW",122,0)
 K ^TMP($J,"REMATCHED")
"RTN","PSNPPSNW",123,0)
 Q
"RTN","PSNPPSNW",124,0)
 ;
"RTN","PSNPPSNW",125,0)
MSGHDR(NONE) ;insert MESS3 header
"RTN","PSNPPSNW",126,0)
 N I,X
"RTN","PSNPPSNW",127,0)
 W !
"RTN","PSNPPSNW",128,0)
 F I=1:1 S X="HDRTXT+"_I,X=$T(@X) S X=$P(X,";",3) Q:X=""  D
"RTN","PSNPPSNW",129,0)
 .I 'NONE,X["[No re-matches]" Q
"RTN","PSNPPSNW",130,0)
 .D ADDLINE(X)
"RTN","PSNPPSNW",131,0)
 Q
"RTN","PSNPPSNW",132,0)
 ;
"RTN","PSNPPSNW",133,0)
ADDLINE(X) ;
"RTN","PSNPPSNW",134,0)
 N C
"RTN","PSNPPSNW",135,0)
 S (C,^TMP("PSN PPSN PARSED",$J,"MESSAGE3",0))=$G(^TMP("PSN PPSN PARSED",$J,"MESSAGE3",0))+1
"RTN","PSNPPSNW",136,0)
 S ^TMP("PSN PPSN PARSED",$J,"MESSAGE3",C)=X
"RTN","PSNPPSNW",137,0)
 Q
"RTN","PSNPPSNW",138,0)
 ;
"RTN","PSNPPSNW",139,0)
HDRTXT ;
"RTN","PSNPPSNW",140,0)
 ;;The following local drug entries have been re-matched to the National Drug File based on the recommendations of the PPSN management group.;
"RTN","PSNPPSNW",141,0)
 ;;If you do not agree with any of these re-matches you may re-match them locally.;
"RTN","PSNPPSNW",142,0)
 ;; ;
"RTN","PSNPPSNW",143,0)
 ;;   [No re-matches];
"RTN","PSNPPSNW",144,0)
 ;;;
"RTN","PSNPPSNW",145,0)
 ;
"RTN","PSNPPSNW",146,0)
 ;=============================
"RTN","PSNPPSNW",147,0)
 ;misc export stuff (unrelated)
"RTN","PSNPPSNW",148,0)
 ;=============================
"RTN","PSNPPSNW",149,0)
 Q
"RTN","PSNVCR")
0^21^B169194760^n/a
"RTN","PSNVCR",1,0)
PSNVCR ;BIR/RTR-VISTA COMPARISON REPORT ; 11 December 2016
"RTN","PSNVCR",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNVCR",3,0)
 ;
"RTN","PSNVCR",4,0)
 N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y,IOP,%ZIS,POP,ZTRTN,ZTDESC,ZTSAVE,ZTSK
"RTN","PSNVCR",5,0)
 N PSNVRANS,PSNVRAR,PSNVRBEG,PSNVREND,PSNVRFIL,PSNVROUT,PSNVRPMI,PSNVRSEE,PSNVRSUM,PSNVRTYP
"RTN","PSNVCR",6,0)
 S (PSNVROUT,PSNVRPMI)=0
"RTN","PSNVCR",7,0)
 ;
"RTN","PSNVCR",8,0)
 ;
"RTN","PSNVCR",9,0)
 W !!,?5,"Update File Change Report",!
"RTN","PSNVCR",10,0)
 ;
"RTN","PSNVCR",11,0)
 ;
"RTN","PSNVCR",12,0)
 D FILE^PSNVCR1 I PSNVROUT D END Q
"RTN","PSNVCR",13,0)
 D FIELD I PSNVROUT D END Q
"RTN","PSNVCR",14,0)
 I '$D(PSNVRAR) W !!?5,"No fields selected to print.",! D END Q
"RTN","PSNVCR",15,0)
 D DATE^PSNVCR1 I PSNVROUT D END Q
"RTN","PSNVCR",16,0)
 D SUMM^PSNVCR1 I PSNVROUT D END Q
"RTN","PSNVCR",17,0)
 I PSNVRSUM="S" D PMI^PSNVCR1 I PSNVROUT D END Q
"RTN","PSNVCR",18,0)
 D TYPE^PSNVCR1 I PSNVROUT D END Q
"RTN","PSNVCR",19,0)
 I PSNVRTYP="D" D DL^PSNVCR1 I PSNVROUT D END Q
"RTN","PSNVCR",20,0)
 I PSNVRTYP="D" D START1^PSNVCR2 Q
"RTN","PSNVCR",21,0)
 ;
"RTN","PSNVCR",22,0)
 K IOP,%ZIS,POP W ! S %ZIS="QM" D ^%ZIS I $G(POP)>0 D END Q
"RTN","PSNVCR",23,0)
 I $D(IO("Q")) S ZTRTN="START^PSNVCR2",ZTDESC="Update File Change Report" D  Q
"RTN","PSNVCR",24,0)
 .S ZTSAVE("PSNVRAR(")="",ZTSAVE("PSNVRBEG")="",ZTSAVE("PSNVREND")="",ZTSAVE("PSNVRSUM")="",ZTSAVE("PSNVRPMI")="",ZTSAVE("PSNVRTYP")="",ZTSAVE("PSNVRFIL(")=""
"RTN","PSNVCR",25,0)
 .D ^%ZTLOAD K %ZIS W !!,"Report queued to print.",!
"RTN","PSNVCR",26,0)
 .K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSNVCR",27,0)
 U IO D START1^PSNVCR2
"RTN","PSNVCR",28,0)
 Q
"RTN","PSNVCR",29,0)
 ;
"RTN","PSNVCR",30,0)
 ;
"RTN","PSNVCR",31,0)
FIELD ;Field selection
"RTN","PSNVCR",32,0)
 ;Sets fields in PSNVRAR(#,#)
"RTN","PSNVCR",33,0)
 I $G(PSNVRSEE)="A" G SFLD
"RTN","PSNVCR",34,0)
 W ! K DIR,Y S DIR(0)="SA^A:ALL;S:SPECIFIC"
"RTN","PSNVCR",35,0)
 S DIR("?",1)="Enter 'A' to see changes made to all of the audited fields,"
"RTN","PSNVCR",36,0)
 S DIR("?")="enter 'S' to select specific fields to see changes."
"RTN","PSNVCR",37,0)
 S DIR("A")="Select (A)ll Audited or (S)pecific Fields: "
"RTN","PSNVCR",38,0)
 D ^DIR I $D(DIRUT) S PSNVROUT=1 Q
"RTN","PSNVCR",39,0)
 S PSNVRSEE=Y
"RTN","PSNVCR",40,0)
SFLD ;
"RTN","PSNVCR",41,0)
 D SELFIELD(PSNVRSEE)
"RTN","PSNVCR",42,0)
 Q
"RTN","PSNVCR",43,0)
 ;
"RTN","PSNVCR",44,0)
 ;
"RTN","PSNVCR",45,0)
END ;
"RTN","PSNVCR",46,0)
 K DIR w !!,"No report to print.",! K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR W !
"RTN","PSNVCR",47,0)
 Q
"RTN","PSNVCR",48,0)
 ;
"RTN","PSNVCR",49,0)
 ;
"RTN","PSNVCR",50,0)
SELFIELD(PSNVRSL) ; Set Field array as PSNVRAR(#,#)=""
"RTN","PSNVCR",51,0)
 ;Where first subscript is File number, and remaining subscripts are field numbers
"RTN","PSNVCR",52,0)
 N PSNVRSL1,PSNVRSL2,PSNVRSL3,PSNVL,PSNVRAGN,PSNVRDAT,PSNVRCN,PSNVRFL,PSNVRSUB,PSNVRSTR,PSNVRSQ1,PSNVRSQ2
"RTN","PSNVCR",53,0)
 F PSNVL=0:0 S PSNVL=$O(PSNVRFIL(PSNVL)) Q:'PSNVL!(PSNVROUT)  D
"RTN","PSNVCR",54,0)
 .I PSNVL=50.416 D DIN Q
"RTN","PSNVCR",55,0)
 .D @$S(PSNVL=50.6:"VAG",PSNVL=50.605:"VDC",PSNVL=50.606:"DFO",PSNVL=50.607:"DRU",PSNVL=50.608:"PAT",PSNVL=50.609:"PAS",PSNVL=50.64:"VAD",PSNVL=50.67:"NDC",PSNVL=50.68:"VAP",PSNVL=55.95:"DRM^PSNVCR1",1:"DRI^PSNVCR1")
"RTN","PSNVCR",56,0)
 Q
"RTN","PSNVCR",57,0)
 ;
"RTN","PSNVCR",58,0)
 ;
"RTN","PSNVCR",59,0)
DIN ;Set Fields for Drug Ingredients (#50.416) File
"RTN","PSNVCR",60,0)
 I PSNVRSL="A" D  Q
"RTN","PSNVCR",61,0)
 .F PSNVRSL1=50.416,50.4161,50.4169 D
"RTN","PSNVCR",62,0)
 ..F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",63,0)
 ...S PSNVRSQ2=0 S PSNVRSTR=50.416 S PSNVRSQ1=$S(PSNVRSL1=50.4161:1,PSNVRSL1=50.4169:99.991,1:PSNVRSL2) S:PSNVRSL1'=50.416 PSNVRSQ2=PSNVRSL2
"RTN","PSNVCR",64,0)
 ...I 'PSNVRSQ2 S PSNVRAR(PSNVRSTR,PSNVRSQ1)=PSNVRSL1 Q
"RTN","PSNVCR",65,0)
 ...S PSNVRAR(PSNVRSTR,PSNVRSQ1,PSNVRSQ2)=PSNVRSL1
"RTN","PSNVCR",66,0)
 K PSNVRDAT S PSNVRCN=0  F PSNVRSL1=50.416,50.4161,50.4169 D
"RTN","PSNVCR",67,0)
 .F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",68,0)
 ..S PSNVRCN=PSNVRCN+1,PSNVRDAT(PSNVRCN)=PSNVRSL1_"^"_PSNVRSL2
"RTN","PSNVCR",69,0)
 ..S PSNVRSUB=PSNVRDAT(PSNVRCN),$P(PSNVRDAT(PSNVRCN),"^",3)=$$GET1^DID($P(PSNVRSUB,"^"),$P(PSNVRSUB,"^",2),,"LABEL")_$$DINNM
"RTN","PSNVCR",70,0)
 ..S PSNVRSQ2="" S PSNVRSTR=50.416 S PSNVRSQ1=$S(PSNVRSL1=50.4161:1,PSNVRSL1=50.4169:99.9991,1:PSNVRSL2) S:PSNVRSL1'=50.416 PSNVRSQ2=PSNVRSL2
"RTN","PSNVCR",71,0)
 ..S $P(PSNVRDAT(PSNVRCN),"^",4)=PSNVRSTR_";;"_PSNVRSQ1_";;"_PSNVRSQ2
"RTN","PSNVCR",72,0)
DINN ;Redisplay for selection
"RTN","PSNVCR",73,0)
 W @IOF
"RTN","PSNVCR",74,0)
 W !?5,"Audited fields from the Drug Ingredients (#50.416) File:",! S PSNVRFL=0
"RTN","PSNVCR",75,0)
 D AUDF
"RTN","PSNVCR",76,0)
 Q:PSNVROUT
"RTN","PSNVCR",77,0)
 I 'PSNVRFL D MESS,YN Q
"RTN","PSNVCR",78,0)
 D SELECT^PSNVCR1(PSNVRCN) I PSNVRAGN G DINN
"RTN","PSNVCR",79,0)
 Q
"RTN","PSNVCR",80,0)
DINNM() ;
"RTN","PSNVCR",81,0)
 Q $S(+PSNVRSUB=50.4161:"  (DRUG IDENTIFIER SubFile)",+PSNVRSUB=50.4169:"   (EFFECTIVE DATE/TIME Subfile)",1:"")
"RTN","PSNVCR",82,0)
 ;
"RTN","PSNVCR",83,0)
 ;
"RTN","PSNVCR",84,0)
VAG ;Set Fields for VA Generic (#50.6) File
"RTN","PSNVCR",85,0)
 I PSNVRSL="A" D  Q
"RTN","PSNVCR",86,0)
 .F PSNVRSL1=50.6,50.6009 D
"RTN","PSNVCR",87,0)
 ..F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",88,0)
 ...S PSNVRSQ2=0 S PSNVRSTR=50.6 S PSNVRSQ1=$S(PSNVRSL1=50.6009:99.991,1:PSNVRSL2) S:PSNVRSL1'=50.6 PSNVRSQ2=PSNVRSL2
"RTN","PSNVCR",89,0)
 ...I 'PSNVRSQ2 S PSNVRAR(PSNVRSTR,PSNVRSQ1)=PSNVRSL1 Q
"RTN","PSNVCR",90,0)
 ...S PSNVRAR(PSNVRSTR,PSNVRSQ1,PSNVRSQ2)=PSNVRSL1
"RTN","PSNVCR",91,0)
  K PSNVRDAT S PSNVRCN=0  F PSNVRSL1=50.6,50.6009 D
"RTN","PSNVCR",92,0)
 .F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",93,0)
 ..S PSNVRCN=PSNVRCN+1,PSNVRDAT(PSNVRCN)=PSNVRSL1_"^"_PSNVRSL2
"RTN","PSNVCR",94,0)
 ..S PSNVRSUB=PSNVRDAT(PSNVRCN),$P(PSNVRDAT(PSNVRCN),"^",3)=$$GET1^DID($P(PSNVRSUB,"^"),$P(PSNVRSUB,"^",2),,"LABEL")_$$VAGNM
"RTN","PSNVCR",95,0)
 ..S PSNVRSQ2="" S PSNVRSTR=50.6 S PSNVRSQ1=$S(PSNVRSL1=50.6009:99.991,1:PSNVRSL2) S:PSNVRSL1'=50.6 PSNVRSQ2=PSNVRSL2
"RTN","PSNVCR",96,0)
 ..S $P(PSNVRDAT(PSNVRCN),"^",4)=PSNVRSTR_";;"_PSNVRSQ1_";;"_PSNVRSQ2
"RTN","PSNVCR",97,0)
VAGN ;Redisplay for selection
"RTN","PSNVCR",98,0)
 W @IOF
"RTN","PSNVCR",99,0)
 W !?5,"Audited fields from the VA Generic (#50.6) File:",! S PSNVRFL=0
"RTN","PSNVCR",100,0)
 D AUDF
"RTN","PSNVCR",101,0)
 Q:PSNVROUT
"RTN","PSNVCR",102,0)
 I 'PSNVRFL D MESS,YN Q
"RTN","PSNVCR",103,0)
 D SELECT^PSNVCR1(PSNVRCN) I PSNVRAGN G VAGN
"RTN","PSNVCR",104,0)
 Q
"RTN","PSNVCR",105,0)
VAGNM() ;
"RTN","PSNVCR",106,0)
 Q $S(+PSNVRSUB=50.6009:"  (EFFECTIVE DATE TIME SubFile)",1:"")
"RTN","PSNVCR",107,0)
 ;
"RTN","PSNVCR",108,0)
 ;
"RTN","PSNVCR",109,0)
VDC ;Set Fields for VA Drug Class (#50.605) File
"RTN","PSNVCR",110,0)
 I PSNVRSL="A" D  Q
"RTN","PSNVCR",111,0)
 .F PSNVRSL1=50.605,50.615,50.60509 D
"RTN","PSNVCR",112,0)
 ..F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",113,0)
 ...S PSNVRSQ2=0 S PSNVRSTR=50.605 S PSNVRSQ1=$S(PSNVRSL1=50.60509:99.991,PSNVRSL1=50.615:4,1:PSNVRSL2) S:PSNVRSL1'=50.605 PSNVRSQ2=PSNVRSL2
"RTN","PSNVCR",114,0)
 ...I 'PSNVRSQ2 S PSNVRAR(PSNVRSTR,PSNVRSQ1)=PSNVRSL1 Q
"RTN","PSNVCR",115,0)
 ...S PSNVRAR(PSNVRSTR,PSNVRSQ1,PSNVRSQ2)=PSNVRSL1
"RTN","PSNVCR",116,0)
 K PSNVRDAT S PSNVRCN=0  F PSNVRSL1=50.605,50.615,50.60509 D
"RTN","PSNVCR",117,0)
 .F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",118,0)
 ..S PSNVRCN=PSNVRCN+1,PSNVRDAT(PSNVRCN)=PSNVRSL1_"^"_PSNVRSL2
"RTN","PSNVCR",119,0)
 ..S PSNVRSUB=PSNVRDAT(PSNVRCN),$P(PSNVRDAT(PSNVRCN),"^",3)=$$GET1^DID($P(PSNVRSUB,"^"),$P(PSNVRSUB,"^",2),,"LABEL")_$$VDCNM
"RTN","PSNVCR",120,0)
 ..S PSNVRSQ2="" S PSNVRSTR=50.605 S PSNVRSQ1=$S(PSNVRSL1=50.60509:99.991,PSNVRSL1=50.615:4,1:PSNVRSL2) S:PSNVRSL1'=50.605 PSNVRSQ2=PSNVRSL2
"RTN","PSNVCR",121,0)
 ..S $P(PSNVRDAT(PSNVRCN),"^",4)=PSNVRSTR_";;"_PSNVRSQ1_";;"_PSNVRSQ2
"RTN","PSNVCR",122,0)
VDCN ;Redisplay for selection
"RTN","PSNVCR",123,0)
 W @IOF
"RTN","PSNVCR",124,0)
 W !?5,"Audited fields from the VA Drug Class (#50.605) File:",! S PSNVRFL=0
"RTN","PSNVCR",125,0)
 D AUDF
"RTN","PSNVCR",126,0)
 Q:PSNVROUT
"RTN","PSNVCR",127,0)
 I 'PSNVRFL D MESS,YN Q
"RTN","PSNVCR",128,0)
 D SELECT^PSNVCR1(PSNVRCN) I PSNVRAGN G VDCN
"RTN","PSNVCR",129,0)
 Q
"RTN","PSNVCR",130,0)
VDCNM() ;
"RTN","PSNVCR",131,0)
 Q $S(+PSNVRSUB=50.615:"  (DESCRIPTION SubFile)",+PSNVRSUB=50.60509:"  (EFFECTIVE DATE/TIME SubFile)",1:"")
"RTN","PSNVCR",132,0)
 ;
"RTN","PSNVCR",133,0)
 ;
"RTN","PSNVCR",134,0)
DFO ;Set Fields for Dosage Form (#50.606) File
"RTN","PSNVCR",135,0)
 I PSNVRSL="A" D  Q
"RTN","PSNVCR",136,0)
 .F PSNVRSL1=50.606,50.6069,50.6061,50.6066,50.6068 D
"RTN","PSNVCR",137,0)
 ..F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",138,0)
 ...S PSNVRSQ2=0 S PSNVRSTR=50.606 S PSNVRSQ1=$S(PSNVRSL1=50.6069:9,PSNVRSL1=50.6061:1,PSNVRSL1=50.6066:6,PSNVRSL1=50.6068:8,1:PSNVRSL2) S:PSNVRSL1'=50.606 PSNVRSQ2=PSNVRSL2
"RTN","PSNVCR",139,0)
 ...I 'PSNVRSQ2 S PSNVRAR(PSNVRSTR,PSNVRSQ1)=PSNVRSL1 Q
"RTN","PSNVCR",140,0)
 ...S PSNVRAR(PSNVRSTR,PSNVRSQ1,PSNVRSQ2)=PSNVRSL1
"RTN","PSNVCR",141,0)
 K PSNVRDAT S PSNVRCN=0  F PSNVRSL1=50.606,50.6069,50.6061,50.6066,50.6068 D
"RTN","PSNVCR",142,0)
 .F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",143,0)
 ..S PSNVRCN=PSNVRCN+1,PSNVRDAT(PSNVRCN)=PSNVRSL1_"^"_PSNVRSL2
"RTN","PSNVCR",144,0)
 ..S PSNVRSUB=PSNVRDAT(PSNVRCN),$P(PSNVRDAT(PSNVRCN),"^",3)=$$GET1^DID($P(PSNVRSUB,"^"),$P(PSNVRSUB,"^",2),,"LABEL")_$$DFONM
"RTN","PSNVCR",145,0)
 ..S PSNVRSQ2="" S PSNVRSTR=50.606 S PSNVRSQ1=$S(PSNVRSL1=50.6069:9,PSNVRSL1=50.6061:1,PSNVRSL1=50.6066:6,PSNVRSL1=50.6068:8,1:PSNVRSL2) S:PSNVRSL1'=50.606 PSNVRSQ2=PSNVRSL2
"RTN","PSNVCR",146,0)
 ..S $P(PSNVRDAT(PSNVRCN),"^",4)=PSNVRSTR_";;"_PSNVRSQ1_";;"_PSNVRSQ2
"RTN","PSNVCR",147,0)
DFON ;Redisplay for selection
"RTN","PSNVCR",148,0)
 W @IOF
"RTN","PSNVCR",149,0)
 W !?5,"Audited fields from the Dosage Form (#50.606) File:",! S PSNVRFL=0
"RTN","PSNVCR",150,0)
 D AUDF
"RTN","PSNVCR",151,0)
 Q:PSNVROUT
"RTN","PSNVCR",152,0)
 I 'PSNVRFL D MESS,YN Q
"RTN","PSNVCR",153,0)
 D SELECT^PSNVCR1(PSNVRCN) I PSNVRAGN G DFON
"RTN","PSNVCR",154,0)
 Q
"RTN","PSNVCR",155,0)
DFONM() ;
"RTN","PSNVCR",156,0)
 Q $S(+PSNVRSUB=50.6069:"  (DISPENSE UNITS PER DOSE SubFile)",+PSNVRSUB=50.6061:"  (MED ROUTE FOR DOSAGE FORM SubFile)",+PSNVRSUB=50.6066:"  (NOUN SubFile)",+PSNVRSUB=50.6068:"  (UNITS SubFile)",1:"")
"RTN","PSNVCR",157,0)
 ;
"RTN","PSNVCR",158,0)
 ;
"RTN","PSNVCR",159,0)
DRU ;Set Fields for Drug Units (#50.607) File
"RTN","PSNVCR",160,0)
 I PSNVRSL="A" D  Q
"RTN","PSNVCR",161,0)
 .S PSNVRSL1=50.607 D
"RTN","PSNVCR",162,0)
 ..F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",163,0)
 ...S PSNVRAR(50.607,PSNVRSL2)=PSNVRSL1
"RTN","PSNVCR",164,0)
 K PSNVRDAT S PSNVRCN=0,PSNVRSL1=50.607
"RTN","PSNVCR",165,0)
 F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",166,0)
 .S PSNVRCN=PSNVRCN+1,PSNVRDAT(PSNVRCN)=PSNVRSL1_"^"_PSNVRSL2
"RTN","PSNVCR",167,0)
 .S PSNVRSUB=PSNVRDAT(PSNVRCN),$P(PSNVRDAT(PSNVRCN),"^",3)=$$GET1^DID($P(PSNVRSUB,"^"),$P(PSNVRSUB,"^",2),,"LABEL")
"RTN","PSNVCR",168,0)
 .S $P(PSNVRDAT(PSNVRCN),"^",4)=50.607_";;"_PSNVRSL2
"RTN","PSNVCR",169,0)
DRUN ;Redisplay for selection
"RTN","PSNVCR",170,0)
 W @IOF
"RTN","PSNVCR",171,0)
 W !?5,"Audited fields from the Drug Units (#50.607) File:",! S PSNVRFL=0
"RTN","PSNVCR",172,0)
 D AUDF
"RTN","PSNVCR",173,0)
 Q:PSNVROUT
"RTN","PSNVCR",174,0)
 I 'PSNVRFL D MESS,YN Q
"RTN","PSNVCR",175,0)
 D SELECT^PSNVCR1(PSNVRCN) I PSNVRAGN G DRUN
"RTN","PSNVCR",176,0)
 Q
"RTN","PSNVCR",177,0)
 ;
"RTN","PSNVCR",178,0)
 ;
"RTN","PSNVCR",179,0)
PAT ;Set Fields for Package Type (#50.608) File
"RTN","PSNVCR",180,0)
 I PSNVRSL="A" D  Q
"RTN","PSNVCR",181,0)
 .S PSNVRSL1=50.608 D
"RTN","PSNVCR",182,0)
 ..F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",183,0)
 ...S PSNVRAR(50.608,PSNVRSL2)=PSNVRSL1
"RTN","PSNVCR",184,0)
 K PSNVRDAT S PSNVRCN=0,PSNVRSL1=50.608
"RTN","PSNVCR",185,0)
 F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",186,0)
 .S PSNVRCN=PSNVRCN+1,PSNVRDAT(PSNVRCN)=PSNVRSL1_"^"_PSNVRSL2
"RTN","PSNVCR",187,0)
 .S PSNVRSUB=PSNVRDAT(PSNVRCN),$P(PSNVRDAT(PSNVRCN),"^",3)=$$GET1^DID($P(PSNVRSUB,"^"),$P(PSNVRSUB,"^",2),,"LABEL")
"RTN","PSNVCR",188,0)
 .S $P(PSNVRDAT(PSNVRCN),"^",4)=50.608_";;"_PSNVRSL2
"RTN","PSNVCR",189,0)
PATN ;Redisplay for selection
"RTN","PSNVCR",190,0)
 W @IOF
"RTN","PSNVCR",191,0)
 W !?5,"Audited fields from the Package Type (#50.608) File:",! S PSNVRFL=0
"RTN","PSNVCR",192,0)
 D AUDF
"RTN","PSNVCR",193,0)
 Q:PSNVROUT
"RTN","PSNVCR",194,0)
 I 'PSNVRFL D MESS,YN Q
"RTN","PSNVCR",195,0)
 D SELECT^PSNVCR1(PSNVRCN) I PSNVRAGN G PATN
"RTN","PSNVCR",196,0)
 Q
"RTN","PSNVCR",197,0)
 ;
"RTN","PSNVCR",198,0)
 ;
"RTN","PSNVCR",199,0)
PAS ;Set Fields for Package Size (#50.609) File
"RTN","PSNVCR",200,0)
 I PSNVRSL="A" D  Q
"RTN","PSNVCR",201,0)
 .S PSNVRSL1=50.609 D
"RTN","PSNVCR",202,0)
 ..F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",203,0)
 ...S PSNVRAR(50.609,PSNVRSL2)=PSNVRSL1
"RTN","PSNVCR",204,0)
 K PSNVRDAT S PSNVRCN=0,PSNVRSL1=50.609
"RTN","PSNVCR",205,0)
 F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",206,0)
 .S PSNVRCN=PSNVRCN+1,PSNVRDAT(PSNVRCN)=PSNVRSL1_"^"_PSNVRSL2
"RTN","PSNVCR",207,0)
 .S PSNVRSUB=PSNVRDAT(PSNVRCN),$P(PSNVRDAT(PSNVRCN),"^",3)=$$GET1^DID($P(PSNVRSUB,"^"),$P(PSNVRSUB,"^",2),,"LABEL")
"RTN","PSNVCR",208,0)
 .S $P(PSNVRDAT(PSNVRCN),"^",4)=50.609_";;"_PSNVRSL2
"RTN","PSNVCR",209,0)
PASN ;Redisplay for selection
"RTN","PSNVCR",210,0)
 W @IOF
"RTN","PSNVCR",211,0)
 W !?5,"Audited fields from the Package Size (#50.609) File:",! S PSNVRFL=0
"RTN","PSNVCR",212,0)
 D AUDF
"RTN","PSNVCR",213,0)
 Q:PSNVROUT
"RTN","PSNVCR",214,0)
 I 'PSNVRFL D MESS,YN Q
"RTN","PSNVCR",215,0)
 D SELECT^PSNVCR1(PSNVRCN) I PSNVRAGN G PASN
"RTN","PSNVCR",216,0)
 Q
"RTN","PSNVCR",217,0)
 ;
"RTN","PSNVCR",218,0)
 ;
"RTN","PSNVCR",219,0)
VAD ;Set Fields for VA Dispense Unit (#50.64) File
"RTN","PSNVCR",220,0)
 I PSNVRSL="A" D  Q
"RTN","PSNVCR",221,0)
 .S PSNVRSL1=50.64 D
"RTN","PSNVCR",222,0)
 ..F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",223,0)
 ...S PSNVRAR(50.64,PSNVRSL2)=PSNVRSL1
"RTN","PSNVCR",224,0)
 K PSNVRDAT S PSNVRCN=0,PSNVRSL1=50.64
"RTN","PSNVCR",225,0)
 F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",226,0)
 .S PSNVRCN=PSNVRCN+1,PSNVRDAT(PSNVRCN)=PSNVRSL1_"^"_PSNVRSL2
"RTN","PSNVCR",227,0)
 .S PSNVRSUB=PSNVRDAT(PSNVRCN),$P(PSNVRDAT(PSNVRCN),"^",3)=$$GET1^DID($P(PSNVRSUB,"^"),$P(PSNVRSUB,"^",2),,"LABEL")
"RTN","PSNVCR",228,0)
 .S $P(PSNVRDAT(PSNVRCN),"^",4)=50.64_";;"_PSNVRSL2
"RTN","PSNVCR",229,0)
VADN ;Redisplay for selection
"RTN","PSNVCR",230,0)
 W @IOF
"RTN","PSNVCR",231,0)
 W !?5,"Audited fields from the VA Dispense Unit (#50.64) File:",! S PSNVRFL=0
"RTN","PSNVCR",232,0)
 D AUDF
"RTN","PSNVCR",233,0)
 Q:PSNVROUT
"RTN","PSNVCR",234,0)
 I 'PSNVRFL D MESS,YN Q
"RTN","PSNVCR",235,0)
 D SELECT^PSNVCR1(PSNVRCN) I PSNVRAGN G VADN
"RTN","PSNVCR",236,0)
 Q
"RTN","PSNVCR",237,0)
 ;
"RTN","PSNVCR",238,0)
 ;
"RTN","PSNVCR",239,0)
NDC ;Set Fields for NDC/UPN (#50.67) File
"RTN","PSNVCR",240,0)
 I PSNVRSL="A" D  Q
"RTN","PSNVCR",241,0)
 .F PSNVRSL1=50.67,50.676,50.6711,50.6712 D
"RTN","PSNVCR",242,0)
 ..F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",243,0)
 ...S PSNVRSQ2=0 S PSNVRSTR=50.67 S PSNVRSQ1=$S(PSNVRSL1=50.676:6,PSNVRSL1=50.6711:11,PSNVRSL1=50.6712:12,1:PSNVRSL2) S:PSNVRSL1'=50.67 PSNVRSQ2=PSNVRSL2
"RTN","PSNVCR",244,0)
 ...I 'PSNVRSQ2 S PSNVRAR(PSNVRSTR,PSNVRSQ1)=PSNVRSL1 Q
"RTN","PSNVCR",245,0)
 ...S PSNVRAR(PSNVRSTR,PSNVRSQ1,PSNVRSQ2)=PSNVRSL1
"RTN","PSNVCR",246,0)
 K PSNVRDAT S PSNVRCN=0  F PSNVRSL1=50.67,50.676,50.6711,50.6712 D
"RTN","PSNVCR",247,0)
 .F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",248,0)
 ..S PSNVRCN=PSNVRCN+1,PSNVRDAT(PSNVRCN)=PSNVRSL1_"^"_PSNVRSL2
"RTN","PSNVCR",249,0)
 ..S PSNVRSUB=PSNVRDAT(PSNVRCN),$P(PSNVRDAT(PSNVRCN),"^",3)=$$GET1^DID($P(PSNVRSUB,"^"),$P(PSNVRSUB,"^",2),,"LABEL")_$$NDCNM
"RTN","PSNVCR",250,0)
 ..S PSNVRSQ2="" S PSNVRSTR=50.67 S PSNVRSQ1=$S(PSNVRSL1=50.676:6,PSNVRSL1=50.6711:11,PSNVRSL1=50.6712:12,1:PSNVRSL2) S:PSNVRSL1'=50.67 PSNVRSQ2=PSNVRSL2
"RTN","PSNVCR",251,0)
 ..S $P(PSNVRDAT(PSNVRCN),"^",4)=PSNVRSTR_";;"_PSNVRSQ1_";;"_PSNVRSQ2
"RTN","PSNVCR",252,0)
NDCN ;Redisplay for selection
"RTN","PSNVCR",253,0)
 W @IOF
"RTN","PSNVCR",254,0)
 W !?5,"Audited fields from the NDC/UPN (#50.67) File:",! S PSNVRFL=0
"RTN","PSNVCR",255,0)
 D AUDF
"RTN","PSNVCR",256,0)
 Q:PSNVROUT
"RTN","PSNVCR",257,0)
 I 'PSNVRFL D MESS,YN Q
"RTN","PSNVCR",258,0)
 D SELECT^PSNVCR1(PSNVRCN) I PSNVRAGN G NDCN
"RTN","PSNVCR",259,0)
 Q
"RTN","PSNVCR",260,0)
NDCNM() ;
"RTN","PSNVCR",261,0)
 Q $S(+PSNVRSUB=50.676:"  (ROUTE OF ADMINISTRATION SubFile)",+PSNVRSUB=50.6711:"   (PREVIOUS NDC Subfile)",+PSNVRSUB=50.6712:"   (PREVIOUS UPN Subfile)",1:"")
"RTN","PSNVCR",262,0)
 ;
"RTN","PSNVCR",263,0)
 ;
"RTN","PSNVCR",264,0)
VAP ;Set Fields for VA Product (#50.68) File
"RTN","PSNVCR",265,0)
 I PSNVRSL="A" D  Q
"RTN","PSNVCR",266,0)
 .F PSNVRSL1=50.68,50.6814,50.6816,50.6818,50.6845,50.6899 D
"RTN","PSNVCR",267,0)
 ..F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",268,0)
 ...S PSNVRSQ2=0 S PSNVRSTR=50.68 S PSNVRSQ1=$S(PSNVRSL1=50.6814:14,PSNVRSL1=50.6816:16,PSNVRSL1=50.6818:18,PSNVRSL1=50.6845:45,PSNVRSL1=50.6899:99.991,1:PSNVRSL2) S:PSNVRSL1'=50.68 PSNVRSQ2=PSNVRSL2
"RTN","PSNVCR",269,0)
 ...I 'PSNVRSQ2 S PSNVRAR(PSNVRSTR,PSNVRSQ1)=PSNVRSL1 Q
"RTN","PSNVCR",270,0)
 ...S PSNVRAR(PSNVRSTR,PSNVRSQ1,PSNVRSQ2)=PSNVRSL1
"RTN","PSNVCR",271,0)
 K PSNVRDAT S PSNVRCN=0  F PSNVRSL1=50.68,50.6814,50.6816,50.6818,50.6845,50.6899 D
"RTN","PSNVCR",272,0)
 .F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR",273,0)
 ..S PSNVRCN=PSNVRCN+1,PSNVRDAT(PSNVRCN)=PSNVRSL1_"^"_PSNVRSL2
"RTN","PSNVCR",274,0)
 ..S PSNVRSUB=PSNVRDAT(PSNVRCN),$P(PSNVRDAT(PSNVRCN),"^",3)=$$GET1^DID($P(PSNVRSUB,"^"),$P(PSNVRSUB,"^",2),,"LABEL")_$$VAPNM
"RTN","PSNVCR",275,0)
 ..S PSNVRSQ2="" S PSNVRSTR=50.68 S PSNVRSQ1=$S(PSNVRSL1=50.6814:14,PSNVRSL1=50.6816:16,PSNVRSL1=50.6818:18,PSNVRSL1=50.6845:45,PSNVRSL1=50.6899:99.991,1:PSNVRSL2) S:PSNVRSL1'=50.68 PSNVRSQ2=PSNVRSL2
"RTN","PSNVCR",276,0)
 ..S $P(PSNVRDAT(PSNVRCN),"^",4)=PSNVRSTR_";;"_PSNVRSQ1_";;"_PSNVRSQ2
"RTN","PSNVCR",277,0)
VAPN ;Redisplay for selection
"RTN","PSNVCR",278,0)
 W @IOF
"RTN","PSNVCR",279,0)
 W !?5,"Audited fields from the VA PRODUCT (#50.68) File:",! S PSNVRFL=0
"RTN","PSNVCR",280,0)
 D AUDF
"RTN","PSNVCR",281,0)
 Q:PSNVROUT
"RTN","PSNVCR",282,0)
 I 'PSNVRFL D MESS,YN Q
"RTN","PSNVCR",283,0)
 D SELECT^PSNVCR1(PSNVRCN) I PSNVRAGN G VAPN
"RTN","PSNVCR",284,0)
 Q
"RTN","PSNVCR",285,0)
VAPNM() ;
"RTN","PSNVCR",286,0)
 I +PSNVRSUB=50.6814 Q "  (ACTIVE INGREDIENTS SubFile)"
"RTN","PSNVCR",287,0)
 Q $S(+PSNVRSUB=50.6816:"   (SECONDARY VA DRUG CLASS Subfile)",+PSNVRSUB=50.6818:"   (NATIONAL FORMULARY RESTRICTION Subfile)",+PSNVRSUB=50.6845:"   (COPAY TIER Subfile)",+PSNVRSUB=50.6899:"   (EFFECTIVE DATE/TIME Subfile)",1:"")
"RTN","PSNVCR",288,0)
 ;
"RTN","PSNVCR",289,0)
 ;
"RTN","PSNVCR",290,0)
AUDF ;Show audited fields
"RTN","PSNVCR",291,0)
 F PSNVRSL1=1:1 Q:'$D(PSNVRDAT(PSNVRSL1))!(PSNVROUT)  D
"RTN","PSNVCR",292,0)
 .I ($Y+5)>IOSL D YN Q:PSNVROUT  W @IOF
"RTN","PSNVCR",293,0)
 .S PSNVRSUB=PSNVRDAT(PSNVRSL1)
"RTN","PSNVCR",294,0)
 .W !?2,PSNVRSL1_")  "_$P(PSNVRDAT(PSNVRSL1),"^",3) S PSNVRFL=1
"RTN","PSNVCR",295,0)
 Q
"RTN","PSNVCR",296,0)
 ;
"RTN","PSNVCR",297,0)
 ;
"RTN","PSNVCR",298,0)
MESS ;Write Message
"RTN","PSNVCR",299,0)
 W !,"***No Audited fields for this file.***"
"RTN","PSNVCR",300,0)
 Q
"RTN","PSNVCR",301,0)
 ;
"RTN","PSNVCR",302,0)
 ;
"RTN","PSNVCR",303,0)
YN ;yes or no prompt if no audited fields found for a file
"RTN","PSNVCR",304,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR
"RTN","PSNVCR",305,0)
 I $D(DTOUT)!($D(DUOUT))!('Y) S PSNVROUT=1
"RTN","PSNVCR",306,0)
 Q
"RTN","PSNVCR1")
0^22^B106479512^n/a
"RTN","PSNVCR1",1,0)
PSNVCR1 ;BIR/RTR-VISTA COMPARISON REPORT CONTINUED ; 10 January 2017
"RTN","PSNVCR1",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNVCR1",3,0)
 ;
"RTN","PSNVCR1",4,0)
 ;
"RTN","PSNVCR1",5,0)
FILE ;File Selection
"RTN","PSNVCR1",6,0)
 ;Sets selected file in PSNVRFIL array as PSNVRFIL(#)=File Name
"RTN","PSNVCR1",7,0)
 K DIR,Y S DIR(0)="SA^A:ALL;S:SPECIFIC"
"RTN","PSNVCR1",8,0)
 S DIR("?",1)="Enter 'A' to see changes made in all of the audited National Drug File files,"
"RTN","PSNVCR1",9,0)
 S DIR("?")="enter 'S' to select specific National Drug File files to see changes."
"RTN","PSNVCR1",10,0)
 S DIR("A")="Select (A)ll or (S)pecific Files: "
"RTN","PSNVCR1",11,0)
 D ^DIR I $D(DIRUT) S PSNVROUT=1 Q
"RTN","PSNVCR1",12,0)
 S PSNVRANS=Y D SELFILE(PSNVRANS) I PSNVROUT Q
"RTN","PSNVCR1",13,0)
 I PSNVRANS="A" W !!,"Since all files were selected, all audited fields will be shown on the report." S PSNVRSEE="A"
"RTN","PSNVCR1",14,0)
 Q
"RTN","PSNVCR1",15,0)
 ;
"RTN","PSNVCR1",16,0)
 ;
"RTN","PSNVCR1",17,0)
SELFILE(PSNVRSET) ; Set File array
"RTN","PSNVCR1",18,0)
 N PSNVRLP,PSNVRLPC,PSNVRLAR,PSNVRLST,PSNVRLTH,PSNVRNUM
"RTN","PSNVCR1",19,0)
 S PSNVRLAR(1)="50.416^DRUG INGREDIENTS"
"RTN","PSNVCR1",20,0)
 S PSNVRLAR(2)="50.6^VA GENERIC"
"RTN","PSNVCR1",21,0)
 S PSNVRLAR(3)="50.605^VA DRUG CLASS"
"RTN","PSNVCR1",22,0)
 S PSNVRLAR(4)="50.606^DOSAGE FORM"
"RTN","PSNVCR1",23,0)
 S PSNVRLAR(5)="50.607^DRUG UNITS"
"RTN","PSNVCR1",24,0)
 S PSNVRLAR(6)="50.608^PACKAGE TYPE"
"RTN","PSNVCR1",25,0)
 S PSNVRLAR(7)="50.609^PACKAGE SIZE"
"RTN","PSNVCR1",26,0)
 S PSNVRLAR(8)="50.64^VA DISPENSE UNIT"
"RTN","PSNVCR1",27,0)
 S PSNVRLAR(9)="50.67^NDC/UPN"
"RTN","PSNVCR1",28,0)
 S PSNVRLAR(10)="50.68^VA PRODUCT"
"RTN","PSNVCR1",29,0)
 S PSNVRLAR(11)="55.95^DRUG MANUFACTURER"
"RTN","PSNVCR1",30,0)
 S PSNVRLAR(12)="56^DRUG INTERACTION"
"RTN","PSNVCR1",31,0)
 I PSNVRSET="A" D  Q
"RTN","PSNVCR1",32,0)
 .S PSNVRLP="" F  S PSNVRLP=$O(PSNVRLAR(PSNVRLP)) Q:'PSNVRLP  S PSNVRFIL($P(PSNVRLAR(PSNVRLP),"^"))=($P(PSNVRLAR(PSNVRLP),"^",2))
"RTN","PSNVCR1",33,0)
AGAIN ;Re-prompt file selection
"RTN","PSNVCR1",34,0)
 W !!?4,"1)  "_$P(PSNVRLAR(1),"^")_"   "_$P(PSNVRLAR(1),"^",2)
"RTN","PSNVCR1",35,0)
 W !?4,"2)  "_$P(PSNVRLAR(2),"^")_"     "_$P(PSNVRLAR(2),"^",2)
"RTN","PSNVCR1",36,0)
 W !?4,"3)  "_$P(PSNVRLAR(3),"^")_"   "_$P(PSNVRLAR(3),"^",2)
"RTN","PSNVCR1",37,0)
 W !?4,"4)  "_$P(PSNVRLAR(4),"^")_"   "_$P(PSNVRLAR(4),"^",2)
"RTN","PSNVCR1",38,0)
 W !?4,"5)  "_$P(PSNVRLAR(5),"^")_"   "_$P(PSNVRLAR(5),"^",2)
"RTN","PSNVCR1",39,0)
 W !?4,"6)  "_$P(PSNVRLAR(6),"^")_"   "_$P(PSNVRLAR(6),"^",2)
"RTN","PSNVCR1",40,0)
 W !?4,"7)  "_$P(PSNVRLAR(7),"^")_"   "_$P(PSNVRLAR(7),"^",2)
"RTN","PSNVCR1",41,0)
 W !?4,"8)  "_$P(PSNVRLAR(8),"^")_"    "_$P(PSNVRLAR(8),"^",2)
"RTN","PSNVCR1",42,0)
 W !?4,"9)  "_$P(PSNVRLAR(9),"^")_"    "_$P(PSNVRLAR(9),"^",2)
"RTN","PSNVCR1",43,0)
 W !?3,"10)  "_$P(PSNVRLAR(10),"^")_"    "_$P(PSNVRLAR(10),"^",2)
"RTN","PSNVCR1",44,0)
 W !?3,"11)  "_$P(PSNVRLAR(11),"^")_"    "_$P(PSNVRLAR(11),"^",2)
"RTN","PSNVCR1",45,0)
 W !?3,"12)  "_$P(PSNVRLAR(12),"^")_"       "_$P(PSNVRLAR(12),"^",2),!
"RTN","PSNVCR1",46,0)
 K DIR,Y S DIR(0)="LA^1:12"
"RTN","PSNVCR1",47,0)
 S DIR("A")="Select from the above list of files: "
"RTN","PSNVCR1",48,0)
 S DIR("?",1)="Select from entries 1 through 12. Multiple entries can be selected by using"
"RTN","PSNVCR1",49,0)
 S DIR("?")="commas and dashes, such as 1,2,5-7 to select entries 1, 2, 5, 6, and 7."
"RTN","PSNVCR1",50,0)
 D ^DIR I $D(DIRUT) S PSNVROUT=1 Q
"RTN","PSNVCR1",51,0)
 S PSNVRLST=Y
"RTN","PSNVCR1",52,0)
 S PSNVRLPC=0 F PSNVRLP=1:1:$L(PSNVRLST) I $E(PSNVRLST,PSNVRLP)="," S PSNVRLPC=PSNVRLPC+1
"RTN","PSNVCR1",53,0)
 W !!,"You have selected the following files:",!
"RTN","PSNVCR1",54,0)
 F PSNVRLP=1:1:PSNVRLPC D
"RTN","PSNVCR1",55,0)
 .S PSNVRNUM=$P(PSNVRLST,",",PSNVRLP)
"RTN","PSNVCR1",56,0)
 .S PSNVRFIL($P(PSNVRLAR(PSNVRNUM),"^"))=$P(PSNVRLAR(PSNVRNUM),"^",2),PSNVRLTH=$L($P(PSNVRLAR(PSNVRNUM),"^"))
"RTN","PSNVCR1",57,0)
 .W !?3,$P(PSNVRLAR(PSNVRNUM),"^")_$S(PSNVRLTH=6:"  ",PSNVRLTH=5:"   ",PSNVRLTH=4:"    ",1:"      ")_$P(PSNVRLAR(PSNVRNUM),"^",2)
"RTN","PSNVCR1",58,0)
 W ! K DIR,Y S DIR(0)="Y",DIR("A")="Is this correct",DIR("B")="Y" D ^DIR
"RTN","PSNVCR1",59,0)
 I $D(DTOUT)!($D(DUOUT)) S PSNVROUT=1 Q
"RTN","PSNVCR1",60,0)
 I Y'=1 K PSNVRFIL G AGAIN
"RTN","PSNVCR1",61,0)
 Q
"RTN","PSNVCR1",62,0)
 ;
"RTN","PSNVCR1",63,0)
 ;
"RTN","PSNVCR1",64,0)
DATE ;Date selection
"RTN","PSNVCR1",65,0)
 N %DT,X,X1,X2,%H,PSNVR90
"RTN","PSNVCR1",66,0)
 S X1=DT,X2=-90 D C^%DTC S PSNVR90=X
"RTN","PSNVCR1",67,0)
 W ! S %DT="AEPTX",%DT("A")="Enter Start Date: ",%DT(0)=PSNVR90 D ^%DT I $D(DTOUT)!(Y<0) S PSNVROUT=1 Q
"RTN","PSNVCR1",68,0)
 S PSNVRBEG=Y S X1=PSNVRBEG,X2=-1 D C^%DTC S PSNVRBEG=X_.9999
"RTN","PSNVCR1",69,0)
 K %DT,X S (PSNVRBEG,%DT(0))=Y
"RTN","PSNVCR1",70,0)
 S %DT="AEPTX",%DT("A")="Enter End Date: " D ^%DT I $D(DTOUT)!(Y<0) S PSNVROUT=1 Q
"RTN","PSNVCR1",71,0)
 S PSNVREND=Y I '$P(PSNVREND,".",2) S PSNVREND=PSNVREND_.9999
"RTN","PSNVCR1",72,0)
 Q
"RTN","PSNVCR1",73,0)
 ;
"RTN","PSNVCR1",74,0)
 ;
"RTN","PSNVCR1",75,0)
SUMM ;Prompt for full listing or summary
"RTN","PSNVCR1",76,0)
 W ! K DIR,Y S DIR(0)="SA^F:Full Listing;S:Summary totals"
"RTN","PSNVCR1",77,0)
 S DIR("?",1)="Enter 'F' to see old and new values of all of the audited fields,"
"RTN","PSNVCR1",78,0)
 S DIR("?")="enter 'S' to only see total numbers of records changed."
"RTN","PSNVCR1",79,0)
 S DIR("A")="Select (F)ull Listing or (S)ummary totals: "
"RTN","PSNVCR1",80,0)
 D ^DIR I $D(DIRUT) S PSNVROUT=1 Q
"RTN","PSNVCR1",81,0)
 S PSNVRSUM=Y
"RTN","PSNVCR1",82,0)
 Q
"RTN","PSNVCR1",83,0)
 ;
"RTN","PSNVCR1",84,0)
 ;
"RTN","PSNVCR1",85,0)
PMI ;Prompt for PMI and Warning Lablels if summary was selected in prior prompt
"RTN","PSNVCR1",86,0)
 W ! K DIR,Y S DIR(0)="Y",DIR("A")="Include counts for PMI and Warning Labels",DIR("B")="Y"
"RTN","PSNVCR1",87,0)
 S DIR("?",1)="Enter 'Y' to include PMI and Warning Label counts,"
"RTN","PSNVCR1",88,0)
 S DIR("?")="enter 'N' to not include these counts."
"RTN","PSNVCR1",89,0)
 D ^DIR
"RTN","PSNVCR1",90,0)
 I $D(DTOUT)!($D(DUOUT)) S PSNVROUT=1 Q
"RTN","PSNVCR1",91,0)
 I Y=1 S PSNVRPMI=1
"RTN","PSNVCR1",92,0)
 Q
"RTN","PSNVCR1",93,0)
 ;
"RTN","PSNVCR1",94,0)
 ;
"RTN","PSNVCR1",95,0)
TYPE ;Prompt for report format or delimited list
"RTN","PSNVCR1",96,0)
 W ! K DIR,Y S DIR(0)="SA^P:Print List;D:Delimited File"
"RTN","PSNVCR1",97,0)
 S DIR("?",1)="Enter 'P' to see the output in a report format,"
"RTN","PSNVCR1",98,0)
 S DIR("?")="enter 'D' for a delimited list that can be exported to excel."
"RTN","PSNVCR1",99,0)
 S DIR("A")="Select (P)rint List or (D)elimited File: "
"RTN","PSNVCR1",100,0)
 D ^DIR I $D(DIRUT) S PSNVROUT=1 Q
"RTN","PSNVCR1",101,0)
 S PSNVRTYP=Y
"RTN","PSNVCR1",102,0)
 Q
"RTN","PSNVCR1",103,0)
 ;
"RTN","PSNVCR1",104,0)
 ;
"RTN","PSNVCR1",105,0)
SELECT(PSNVRNM) ;Select fields from each file selected
"RTN","PSNVCR1",106,0)
 N PSNVRSHO,PSNVRHPC,PSNVRHPL,PSNVRHNM,PSNVRAB1,PSNVRAB2,PSNVRAB3,PSNVRABN
"RTN","PSNVCR1",107,0)
 S PSNVRAGN=0 W ! K DIR,Y S DIR(0)="LA^1:"_PSNVRNM
"RTN","PSNVCR1",108,0)
 S DIR("A")="Select from the above list of fields: "
"RTN","PSNVCR1",109,0)
 S DIR("?",1)="Select from entries 1 through "_PSNVRNM_". Multiple entries can be selected by using"
"RTN","PSNVCR1",110,0)
 S DIR("?")="commas and dashes."
"RTN","PSNVCR1",111,0)
 D ^DIR I $D(DIRUT) S PSNVROUT=1 Q
"RTN","PSNVCR1",112,0)
 S PSNVRSHO=Y
"RTN","PSNVCR1",113,0)
 S PSNVRHPC=0 F PSNVRHPL=1:1:$L(PSNVRSHO) I $E(PSNVRSHO,PSNVRHPL)="," S PSNVRHPC=PSNVRHPC+1
"RTN","PSNVCR1",114,0)
 W !!,"You have selected the following fields:",!
"RTN","PSNVCR1",115,0)
 F PSNVRHPL=1:1:PSNVRHPC Q:PSNVROUT  D
"RTN","PSNVCR1",116,0)
 .I ($Y+5)>IOSL D YN^PSNVCR Q:PSNVROUT  W @IOF
"RTN","PSNVCR1",117,0)
 .S PSNVRHNM=$P(PSNVRSHO,",",PSNVRHPL)
"RTN","PSNVCR1",118,0)
 .W !?3,$P(PSNVRDAT(PSNVRHNM),"^",3)
"RTN","PSNVCR1",119,0)
 Q:PSNVROUT
"RTN","PSNVCR1",120,0)
 W ! K DIR,Y S DIR(0)="Y",DIR("A")="Is this correct",DIR("B")="Y" D ^DIR
"RTN","PSNVCR1",121,0)
 I $D(DTOUT)!($D(DUOUT)) S PSNVROUT=1 K PSNVRAR Q
"RTN","PSNVCR1",122,0)
 I Y'=1 S PSNVRAGN=1 Q
"RTN","PSNVCR1",123,0)
 F PSNVRHPL=1:1:PSNVRHPC D
"RTN","PSNVCR1",124,0)
 .S PSNVRHNM=$P(PSNVRSHO,",",PSNVRHPL)
"RTN","PSNVCR1",125,0)
 .S PSNVRABN=$P(PSNVRDAT(PSNVRHNM),"^",4)
"RTN","PSNVCR1",126,0)
 .S PSNVRAB1=$P(PSNVRABN,";;"),PSNVRAB2=$P(PSNVRABN,";;",2),PSNVRAB3=$P(PSNVRABN,";;",3)
"RTN","PSNVCR1",127,0)
 .I 'PSNVRAB3 S PSNVRAR(PSNVRAB1,PSNVRAB2)=$P(PSNVRDAT(PSNVRHNM),"^") Q
"RTN","PSNVCR1",128,0)
 .S PSNVRAR(PSNVRAB1,PSNVRAB2,PSNVRAB3)=$P(PSNVRDAT(PSNVRHNM),"^")
"RTN","PSNVCR1",129,0)
 Q
"RTN","PSNVCR1",130,0)
 ;
"RTN","PSNVCR1",131,0)
 ;
"RTN","PSNVCR1",132,0)
DRM ;Set Fields for Drug Manufacturer (#55.95) File
"RTN","PSNVCR1",133,0)
 I PSNVRSL="A" D  Q
"RTN","PSNVCR1",134,0)
 .S PSNVRSL1=55.95 D
"RTN","PSNVCR1",135,0)
 ..F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR1",136,0)
 ...S PSNVRAR(55.95,PSNVRSL2)=PSNVRSL1
"RTN","PSNVCR1",137,0)
 K PSNVRDAT S PSNVRCN=0,PSNVRSL1=55.95
"RTN","PSNVCR1",138,0)
 F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR1",139,0)
 .S PSNVRCN=PSNVRCN+1,PSNVRDAT(PSNVRCN)=PSNVRSL1_"^"_PSNVRSL2
"RTN","PSNVCR1",140,0)
 .S PSNVRSUB=PSNVRDAT(PSNVRCN),$P(PSNVRDAT(PSNVRCN),"^",3)=$$GET1^DID($P(PSNVRSUB,"^"),$P(PSNVRSUB,"^",2),,"LABEL")
"RTN","PSNVCR1",141,0)
 .S $P(PSNVRDAT(PSNVRCN),"^",4)=55.95_";;"_PSNVRSL2
"RTN","PSNVCR1",142,0)
DRMN ;Redisplay for selection
"RTN","PSNVCR1",143,0)
 W @IOF
"RTN","PSNVCR1",144,0)
 W !?5,"Audited fields from the Drug Manufacturer (#55.95) File:",! S PSNVRFL=0
"RTN","PSNVCR1",145,0)
 D AUDF
"RTN","PSNVCR1",146,0)
 Q:PSNVROUT
"RTN","PSNVCR1",147,0)
 I 'PSNVRFL D MESS,YN Q
"RTN","PSNVCR1",148,0)
 D SELECT(PSNVRCN) I PSNVRAGN G DRMN
"RTN","PSNVCR1",149,0)
 Q
"RTN","PSNVCR1",150,0)
 ;
"RTN","PSNVCR1",151,0)
 ;
"RTN","PSNVCR1",152,0)
DRI ;Set Fields for Drug Interaction (#56) File
"RTN","PSNVCR1",153,0)
 I PSNVRSL="A" D  Q
"RTN","PSNVCR1",154,0)
 .S PSNVRSL1=56 D
"RTN","PSNVCR1",155,0)
 ..F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR1",156,0)
 ...S PSNVRAR(56,PSNVRSL2)=PSNVRSL1
"RTN","PSNVCR1",157,0)
 K PSNVRDAT S PSNVRCN=0,PSNVRSL1=56
"RTN","PSNVCR1",158,0)
 F PSNVRSL2=0:0 S PSNVRSL2=$O(^DD(PSNVRSL1,"AUDIT",PSNVRSL2)) Q:'PSNVRSL2  D
"RTN","PSNVCR1",159,0)
 .S PSNVRCN=PSNVRCN+1,PSNVRDAT(PSNVRCN)=PSNVRSL1_"^"_PSNVRSL2
"RTN","PSNVCR1",160,0)
 .S PSNVRSUB=PSNVRDAT(PSNVRCN),$P(PSNVRDAT(PSNVRCN),"^",3)=$$GET1^DID($P(PSNVRSUB,"^"),$P(PSNVRSUB,"^",2),,"LABEL")
"RTN","PSNVCR1",161,0)
 .S $P(PSNVRDAT(PSNVRCN),"^",4)=56_";;"_PSNVRSL2
"RTN","PSNVCR1",162,0)
DRIN ;Redisplay for selection
"RTN","PSNVCR1",163,0)
 W @IOF
"RTN","PSNVCR1",164,0)
 W !?5,"Audited fields from the Drug Interaction (#56) File:",! S PSNVRFL=0
"RTN","PSNVCR1",165,0)
 D AUDF
"RTN","PSNVCR1",166,0)
 Q:PSNVROUT
"RTN","PSNVCR1",167,0)
 I 'PSNVRFL D MESS,YN Q
"RTN","PSNVCR1",168,0)
 D SELECT(PSNVRCN) I PSNVRAGN G DRIN
"RTN","PSNVCR1",169,0)
 Q
"RTN","PSNVCR1",170,0)
 ;
"RTN","PSNVCR1",171,0)
 ;
"RTN","PSNVCR1",172,0)
AUDF ;Show audited fields
"RTN","PSNVCR1",173,0)
 F PSNVRSL1=1:1 Q:'$D(PSNVRDAT(PSNVRSL1))!(PSNVROUT)  D
"RTN","PSNVCR1",174,0)
 .I ($Y+5)>IOSL D YN Q:PSNVROUT  W @IOF
"RTN","PSNVCR1",175,0)
 .S PSNVRSUB=PSNVRDAT(PSNVRSL1)
"RTN","PSNVCR1",176,0)
 .W !?2,PSNVRSL1_")  "_$P(PSNVRDAT(PSNVRSL1),"^",3) S PSNVRFL=1
"RTN","PSNVCR1",177,0)
 Q
"RTN","PSNVCR1",178,0)
 ;
"RTN","PSNVCR1",179,0)
 ;
"RTN","PSNVCR1",180,0)
MESS ;Write Message
"RTN","PSNVCR1",181,0)
 W !,"***No Audited fields for this file.***"
"RTN","PSNVCR1",182,0)
 Q
"RTN","PSNVCR1",183,0)
 ;
"RTN","PSNVCR1",184,0)
 ;
"RTN","PSNVCR1",185,0)
YN ;yes or no prompt if no audited fields found for a file
"RTN","PSNVCR1",186,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR
"RTN","PSNVCR1",187,0)
 I $D(DTOUT)!($D(DUOUT))!('Y) S PSNVROUT=1
"RTN","PSNVCR1",188,0)
 Q
"RTN","PSNVCR1",189,0)
 ;
"RTN","PSNVCR1",190,0)
 ;
"RTN","PSNVCR1",191,0)
DL ;Delimited File message
"RTN","PSNVCR1",192,0)
 ;
"RTN","PSNVCR1",193,0)
 W !!,"You have selected the delimited file output." D YN Q:PSNVROUT
"RTN","PSNVCR1",194,0)
 W @IOF
"RTN","PSNVCR1",195,0)
 W !,"The report output will be displayed on the screen in a delimited format, so"
"RTN","PSNVCR1",196,0)
 W !,"it can be captured and exported. If you are using Reflections, you can turn"
"RTN","PSNVCR1",197,0)
 W !,"logging on by selecting 'File' on the top left corner of the screen, then"
"RTN","PSNVCR1",198,0)
 W !,"select 'Logging' and capture to your desired location."
"RTN","PSNVCR1",199,0)
 W !!,"The format of the output is as follows, using '^' as the delimiter:"
"RTN","PSNVCR1",200,0)
 I PSNVRSUM="S" D  D YN Q
"RTN","PSNVCR1",201,0)
 .W !!,"File Name^Number of Records^Records Changed^Fields/Sub-fields Changed" Q:'PSNVRPMI
"RTN","PSNVCR1",202,0)
 .W !!,"**note** - the output for the PMI and Warning label Files"
"RTN","PSNVCR1",203,0)
 .W !,"           will only contain File Name and Number of Records.",!
"RTN","PSNVCR1",204,0)
 W !!,"File Name^Records - #####"
"RTN","PSNVCR1",205,0)
 W !,"File Name^Entry Name^Field Name^Field Number^Old Value^New Value"
"RTN","PSNVCR1",206,0)
 W !!,"**notes** - the Old Value and New Value will repeat as often as necessary."
"RTN","PSNVCR1",207,0)
 W !,"            duplicate Entry Names will have (duplicate #) appended."
"RTN","PSNVCR1",208,0)
 W !,"            duplicate Field Names will have the subfile number appended."
"RTN","PSNVCR1",209,0)
 W !,"            File Name^***No Changes** will print if there were no changes."
"RTN","PSNVCR1",210,0)
 D YN
"RTN","PSNVCR1",211,0)
 Q
"RTN","PSNVCR1",212,0)
 ;
"RTN","PSNVCR1",213,0)
 ;
"RTN","PSNVCR1",214,0)
PMIP ;Print PMI and Warning label totals
"RTN","PSNVCR1",215,0)
 ;
"RTN","PSNVCR1",216,0)
 I PSNFON,($Y+5)>IOSL D HD^PSNVCR2 Q:PSNCROUT
"RTN","PSNVCR1",217,0)
 I PSNFON W !
"RTN","PSNVCR1",218,0)
 I PSNFON,($Y+5)>IOSL D HD^PSNVCR2 Q:PSNCROUT
"RTN","PSNVCR1",219,0)
 I PSNFON W !,"PMI and Warning Label counts",!
"RTN","PSNVCR1",220,0)
 I PSNFON,($Y+5)>IOSL D HD^PSNVCR2 Q:PSNCROUT
"RTN","PSNVCR1",221,0)
 S PSNCRAT=0 F PSNCRA2=0:0 S PSNCRA2=$O(^PS(50.621,PSNCRA2)) Q:'PSNCRA2  I $G(^PS(50.621,PSNCRA2,0))'="" S PSNCRAT=PSNCRAT+1 I PSNCRDEV="C",PSNFON,PSNCRAT#500=0 W "."
"RTN","PSNVCR1",222,0)
 I PSNFON W !?5,"PMI-ENGLISH FILE (#50.621) - "_PSNCRAT_" records"
"RTN","PSNVCR1",223,0)
 I 'PSNFON W !,"PMI-ENGLISH FILE^"_PSNCRAT_"^0^0"
"RTN","PSNVCR1",224,0)
 ;
"RTN","PSNVCR1",225,0)
 I PSNFON,($Y+5)>IOSL D HD^PSNVCR2 Q:PSNCROUT
"RTN","PSNVCR1",226,0)
 S PSNCRAT=0 F PSNCRA2=0:0 S PSNCRA2=$O(^PS(50.622,PSNCRA2)) Q:'PSNCRA2  I $G(^PS(50.622,PSNCRA2,0))'="" S PSNCRAT=PSNCRAT+1 I PSNCRDEV="C",PSNFON,PSNCRAT#500=0 W "."
"RTN","PSNVCR1",227,0)
 I PSNFON W !!?5,"PMI-SPANISH FILE (#50.622) - "_PSNCRAT_" records"
"RTN","PSNVCR1",228,0)
 I 'PSNFON W !,"PMI-SPANISH FILE^"_PSNCRAT_"^0^0"
"RTN","PSNVCR1",229,0)
 ;
"RTN","PSNVCR1",230,0)
 I PSNFON,($Y+5)>IOSL D HD^PSNVCR2 Q:PSNCROUT
"RTN","PSNVCR1",231,0)
 S PSNCRAT=0 F PSNCRA2=0:0 S PSNCRA2=$O(^PS(50.623,PSNCRA2)) Q:'PSNCRA2  I $G(^PS(50.623,PSNCRA2,0))'="" S PSNCRAT=PSNCRAT+1 I PSNCRDEV="C",PSNFON,PSNCRAT#500=0 W "."
"RTN","PSNVCR1",232,0)
 I PSNFON W !!?5,"PMI MAP-ENGLISH FILE (#50.623) - "_PSNCRAT_" records"
"RTN","PSNVCR1",233,0)
 I 'PSNFON W !,"PMI MAP-ENGLISH FILE^"_PSNCRAT_"^0^0"
"RTN","PSNVCR1",234,0)
 ;
"RTN","PSNVCR1",235,0)
 I PSNFON,($Y+5)>IOSL D HD^PSNVCR2 Q:PSNCROUT
"RTN","PSNVCR1",236,0)
 S PSNCRAT=0 F PSNCRA2=0:0 S PSNCRA2=$O(^PS(50.624,PSNCRA2)) Q:'PSNCRA2  I $G(^PS(50.624,PSNCRA2,0))'="" S PSNCRAT=PSNCRAT+1 I PSNCRDEV="C",PSNFON,PSNCRAT#500=0 W "."
"RTN","PSNVCR1",237,0)
 I PSNFON W !!?5,"PMI MAP-SPANISH FILE (#50.624) - "_PSNCRAT_" records"
"RTN","PSNVCR1",238,0)
 I 'PSNFON W !,"PMI MAP-SPANISH FILE^"_PSNCRAT_"^0^0"
"RTN","PSNVCR1",239,0)
 I PSNFON,($Y+5)>IOSL D HD^PSNVCR2
"RTN","PSNVCR1",240,0)
 ;
"RTN","PSNVCR1",241,0)
 Q
"RTN","PSNVCR2")
0^23^B207861885^n/a
"RTN","PSNVCR2",1,0)
PSNVCR2 ;BIR/RTR-VISTA COMPARISON REPORT CONTINUED ; 11 January 2017
"RTN","PSNVCR2",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513**; 30 Oct 98;Build 53
"RTN","PSNVCR2",3,0)
 ;
"RTN","PSNVCR2",4,0)
 ;Reference to ^DIA supported by DBIA 2602
"RTN","PSNVCR2",5,0)
 ;
"RTN","PSNVCR2",6,0)
 ;
"RTN","PSNVCR2",7,0)
START ;Print report
"RTN","PSNVCR2",8,0)
 N Y,DIR,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","PSNVCR2",9,0)
START1 ;Print report without queuing
"RTN","PSNVCR2",10,0)
 N PSNCH,PSNCRA2,PSNCRAT,PSNCROUT,PSNCRDEV,PSNCRLIN,PSNCRTOT,PSNCRPG,PSNCRBG,PSNCREN,PSNCRL2,PSNCRLC1,PSNCRLC2,PSNCRLC3,PSNCRLC4,PSNCRS7,PSNCRS8,PSNCRSUB,PSNFON,PSNCRLF,PSNCRS9,PSNCRSM9
"RTN","PSNVCR2",11,0)
 S Y=$E(PSNVRBEG,1,7) D DD^%DT S PSNCRBG=Y
"RTN","PSNVCR2",12,0)
 S Y=$E(PSNVREND,1,7) D DD^%DT S PSNCREN=Y
"RTN","PSNVCR2",13,0)
 S PSNFON=$S(PSNVRTYP="P":1,1:0)
"RTN","PSNVCR2",14,0)
 S PSNCRL2=PSNCRBG_" to "_PSNCREN I PSNVRPMI S PSNCRL2=PSNCRL2_"  (Including PMI and Warning Labels)"
"RTN","PSNVCR2",15,0)
 S (PSNCROUT,PSNCRTOT,PSNCRLF)=0,PSNCRDEV=$S($E(IOST,1,2)'="C-":"P",1:"C"),PSNCRPG=1
"RTN","PSNVCR2",16,0)
 K PSNCRLIN S $P(PSNCRLIN,"-",78)="",PSNCRSUB=""
"RTN","PSNVCR2",17,0)
 I PSNFON D HD
"RTN","PSNVCR2",18,0)
 ;
"RTN","PSNVCR2",19,0)
 S PSNCH="" F  S PSNCH=$O(PSNVRFIL(PSNCH)) Q:PSNCH=""!(PSNCROUT)  D
"RTN","PSNVCR2",20,0)
 .I 'PSNFON,'PSNCRLF W !
"RTN","PSNVCR2",21,0)
 .D @$S(PSNCH=50.416:"DIN",PSNCH=50.6:"VAG",PSNCH=50.605:"VDC",PSNCH=50.606:"DFO",PSNCH=50.607:"DRU",PSNCH=50.608:"PAT",PSNCH=50.609:"PAS",PSNCH=50.64:"VAD",PSNCH=50.67:"NDC",PSNCH=50.68:"VAP",PSNCH=55.95:"DRM",1:"DRI")
"RTN","PSNVCR2",22,0)
 .I 'PSNFON S PSNCRLF=1
"RTN","PSNVCR2",23,0)
 I PSNCROUT G END
"RTN","PSNVCR2",24,0)
 I PSNVRPMI D PMIP^PSNVCR1
"RTN","PSNVCR2",25,0)
 ;
"RTN","PSNVCR2",26,0)
END ;
"RTN","PSNVCR2",27,0)
 I 'PSNCROUT,'PSNCRTOT W !!,"No data to print.",!
"RTN","PSNVCR2",28,0)
 I PSNCRDEV="P"  W !!,"End of Report.",!
"RTN","PSNVCR2",29,0)
 I 'PSNCROUT,PSNCRDEV="C" W !!,"End of Report.",! K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSNVCR2",30,0)
 I PSNCRDEV="C" W !
"RTN","PSNVCR2",31,0)
 E  W @IOF
"RTN","PSNVCR2",32,0)
 K PSNVRBEG,PSNVREND,PSNVRPMI,PSNVRTYP,PSNVRAR,PSNVRFIL,PSNVRSUM
"RTN","PSNVCR2",33,0)
 I 'PSNFON Q
"RTN","PSNVCR2",34,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSNVCR2",35,0)
 Q
"RTN","PSNVCR2",36,0)
 ;
"RTN","PSNVCR2",37,0)
 ;
"RTN","PSNVCR2",38,0)
HD ;Report Header
"RTN","PSNVCR2",39,0)
 I $G(PSNCRDEV)="C",$G(PSNCRPG)'=1 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue, '^' to exit" D ^DIR K DIR I 'Y S PSNCROUT=1 Q
"RTN","PSNVCR2",40,0)
 W @IOF
"RTN","PSNVCR2",41,0)
 W !,"UPDATE FILE CHANGE REPORT" W:PSNVRSUM="S" "  (Summary)"
"RTN","PSNVCR2",42,0)
 W ?68,"PAGE: "_PSNCRPG,!,PSNCRL2_PSNCRSUB,!,PSNCRLIN S PSNCRPG=PSNCRPG+1
"RTN","PSNVCR2",43,0)
 Q
"RTN","PSNVCR2",44,0)
 ;
"RTN","PSNVCR2",45,0)
 ;
"RTN","PSNVCR2",46,0)
MESS ;
"RTN","PSNVCR2",47,0)
 W !!,"Nothing queued to print.",!
"RTN","PSNVCR2",48,0)
 Q
"RTN","PSNVCR2",49,0)
 ;
"RTN","PSNVCR2",50,0)
 ;
"RTN","PSNVCR2",51,0)
DIN ;print info for Drug Ingredient (#50.416) File
"RTN","PSNVCR2",52,0)
 S PSNCRTOT=1,PSNCRAT=0,PSNCRLC1=50.416,PSNCRLC3="DRUG INGREDIENTS"
"RTN","PSNVCR2",53,0)
 I PSNVRSUM="F" S PSNCRSUB="   (Drug Ingredient (#50.416) File cont.)"
"RTN","PSNVCR2",54,0)
 F PSNCRA2=0:0 S PSNCRA2=$O(^PS(50.416,PSNCRA2)) Q:'PSNCRA2  I $G(^PS(50.416,PSNCRA2,0))'="" S PSNCRAT=PSNCRAT+1
"RTN","PSNVCR2",55,0)
 I PSNFON W !!,"DRUG INGREDIENT file (#50.416) - "_PSNCRAT_" records"
"RTN","PSNVCR2",56,0)
 I PSNFON,($Y+5)>IOSL D HD Q:PSNCROUT
"RTN","PSNVCR2",57,0)
 D @$S(PSNVRSUM="F":"KLF",1:"KL")
"RTN","PSNVCR2",58,0)
 I $D(PSNVRAR(PSNCRLC1)) D
"RTN","PSNVCR2",59,0)
 .I PSNVRSUM="F" D PRT(PSNCRLC1) Q
"RTN","PSNVCR2",60,0)
 .D SUM(PSNCRLC1)
"RTN","PSNVCR2",61,0)
 I PSNVRSUM="F" D PFUL(PSNCRLC3,PSNCRAT),KLF Q
"RTN","PSNVCR2",62,0)
 D PSUM(PSNCRLC3,PSNCRAT)
"RTN","PSNVCR2",63,0)
 Q
"RTN","PSNVCR2",64,0)
 ;
"RTN","PSNVCR2",65,0)
 ;
"RTN","PSNVCR2",66,0)
VAG ;print info for VA Generic (#50.6) File
"RTN","PSNVCR2",67,0)
 S PSNCRTOT=1,PSNCRAT=0,PSNCRLC1=50.6,PSNCRLC3="VA GENERIC"
"RTN","PSNVCR2",68,0)
 I PSNVRSUM="F" S PSNCRSUB="   (VA Generic (#50.6) File cont.)"
"RTN","PSNVCR2",69,0)
 F PSNCRA2=0:0 S PSNCRA2=$O(^PSNDF(50.6,PSNCRA2)) Q:'PSNCRA2  I $G(^PSNDF(50.6,PSNCRA2,0))'="" S PSNCRAT=PSNCRAT+1
"RTN","PSNVCR2",70,0)
 I PSNFON W !!,"VA GENERIC file (#50.6) - "_PSNCRAT_" records"
"RTN","PSNVCR2",71,0)
 I PSNFON,($Y+5)>IOSL D HD Q:PSNCROUT
"RTN","PSNVCR2",72,0)
 D @$S(PSNVRSUM="F":"KLF",1:"KL")
"RTN","PSNVCR2",73,0)
 I $D(PSNVRAR(PSNCRLC1)) D
"RTN","PSNVCR2",74,0)
 .I PSNVRSUM="F" D PRT(PSNCRLC1) Q
"RTN","PSNVCR2",75,0)
 .D SUM(PSNCRLC1)
"RTN","PSNVCR2",76,0)
 I PSNVRSUM="F" D PFUL(PSNCRLC3,PSNCRAT),KLF Q
"RTN","PSNVCR2",77,0)
 D PSUM(PSNCRLC3,PSNCRAT)
"RTN","PSNVCR2",78,0)
 Q
"RTN","PSNVCR2",79,0)
 ;
"RTN","PSNVCR2",80,0)
 ;
"RTN","PSNVCR2",81,0)
VDC ;print info for VA Drug Class (#50.605) File
"RTN","PSNVCR2",82,0)
 S PSNCRTOT=1,PSNCRAT=0,PSNCRLC1=50.605,PSNCRLC3="VA DRUG CLASS"
"RTN","PSNVCR2",83,0)
 I PSNVRSUM="F" S PSNCRSUB="   (VA Drug Class (#50.605) File cont.)"
"RTN","PSNVCR2",84,0)
 F PSNCRA2=0:0 S PSNCRA2=$O(^PS(50.605,PSNCRA2)) Q:'PSNCRA2  I $G(^PS(50.605,PSNCRA2,0))'="" S PSNCRAT=PSNCRAT+1
"RTN","PSNVCR2",85,0)
 I PSNFON W !!,"VA DRUG CLASS file (#50.605) - "_PSNCRAT_" records"
"RTN","PSNVCR2",86,0)
 I PSNFON,($Y+5)>IOSL D HD Q:PSNCROUT
"RTN","PSNVCR2",87,0)
 D @$S(PSNVRSUM="F":"KLF",1:"KL")
"RTN","PSNVCR2",88,0)
 I $D(PSNVRAR(PSNCRLC1)) D
"RTN","PSNVCR2",89,0)
 .I PSNVRSUM="F" D PRT(PSNCRLC1) Q
"RTN","PSNVCR2",90,0)
 .D SUM(PSNCRLC1)
"RTN","PSNVCR2",91,0)
 I PSNVRSUM="F" D PFUL(PSNCRLC3,PSNCRAT),KLF Q
"RTN","PSNVCR2",92,0)
 D PSUM(PSNCRLC3,PSNCRAT)
"RTN","PSNVCR2",93,0)
 Q
"RTN","PSNVCR2",94,0)
 ;
"RTN","PSNVCR2",95,0)
 ;
"RTN","PSNVCR2",96,0)
DFO ;print info for Dosage Form (#50.606) File
"RTN","PSNVCR2",97,0)
 S PSNCRTOT=1,PSNCRAT=0,PSNCRLC1=50.606,PSNCRLC3="DOSAGE FORM"
"RTN","PSNVCR2",98,0)
 I PSNVRSUM="F" S PSNCRSUB="   (Dosage Form (#50.606) File cont.)"
"RTN","PSNVCR2",99,0)
 F PSNCRA2=0:0 S PSNCRA2=$O(^PS(50.606,PSNCRA2)) Q:'PSNCRA2  I $G(^PS(50.606,PSNCRA2,0))'="" S PSNCRAT=PSNCRAT+1
"RTN","PSNVCR2",100,0)
 I PSNFON W !!,"DOSAGE FORM file (#50.606) - "_PSNCRAT_" records"
"RTN","PSNVCR2",101,0)
 I PSNFON,($Y+5)>IOSL D HD Q:PSNCROUT
"RTN","PSNVCR2",102,0)
 D @$S(PSNVRSUM="F":"KLF",1:"KL")
"RTN","PSNVCR2",103,0)
 I $D(PSNVRAR(PSNCRLC1)) D
"RTN","PSNVCR2",104,0)
 .I PSNVRSUM="F" D PRT(PSNCRLC1) Q
"RTN","PSNVCR2",105,0)
 .D SUM(PSNCRLC1)
"RTN","PSNVCR2",106,0)
 I PSNVRSUM="F" D PFUL(PSNCRLC3,PSNCRAT),KLF Q
"RTN","PSNVCR2",107,0)
 D PSUM(PSNCRLC3,PSNCRAT)
"RTN","PSNVCR2",108,0)
 Q
"RTN","PSNVCR2",109,0)
 ;
"RTN","PSNVCR2",110,0)
 ;
"RTN","PSNVCR2",111,0)
DRU ;print info for Drug Units (#50.607) File
"RTN","PSNVCR2",112,0)
 S PSNCRTOT=1,PSNCRAT=0,PSNCRLC1=50.607,PSNCRLC3="DRUG UNITS"
"RTN","PSNVCR2",113,0)
 I PSNVRSUM="F" S PSNCRSUB="   (Drug Units (#50.607) File cont.)"
"RTN","PSNVCR2",114,0)
 F PSNCRA2=0:0 S PSNCRA2=$O(^PS(50.607,PSNCRA2)) Q:'PSNCRA2  I $G(^PS(50.607,PSNCRA2,0))'="" S PSNCRAT=PSNCRAT+1
"RTN","PSNVCR2",115,0)
 I PSNFON W !!,"DRUG UNITS file (#50.607) - "_PSNCRAT_" records"
"RTN","PSNVCR2",116,0)
 I PSNFON,($Y+5)>IOSL D HD Q:PSNCROUT
"RTN","PSNVCR2",117,0)
 D @$S(PSNVRSUM="F":"KLF",1:"KL")
"RTN","PSNVCR2",118,0)
 I $D(PSNVRAR(PSNCRLC1)) D
"RTN","PSNVCR2",119,0)
 .I PSNVRSUM="F" D PRT(PSNCRLC1) Q
"RTN","PSNVCR2",120,0)
 .D SUM(PSNCRLC1)
"RTN","PSNVCR2",121,0)
 I PSNVRSUM="F" D PFUL(PSNCRLC3,PSNCRAT),KLF Q
"RTN","PSNVCR2",122,0)
 D PSUM(PSNCRLC3,PSNCRAT)
"RTN","PSNVCR2",123,0)
 Q
"RTN","PSNVCR2",124,0)
 ;
"RTN","PSNVCR2",125,0)
 ;
"RTN","PSNVCR2",126,0)
PAT ;print info for Package Type (#50.608) File
"RTN","PSNVCR2",127,0)
 S PSNCRTOT=1,PSNCRAT=0,PSNCRLC1=50.608,PSNCRLC3="PACKAGE TYPE"
"RTN","PSNVCR2",128,0)
 I PSNVRSUM="F" S PSNCRSUB="   (Package Type (#50.608) File cont.)"
"RTN","PSNVCR2",129,0)
 F PSNCRA2=0:0 S PSNCRA2=$O(^PS(50.608,PSNCRA2)) Q:'PSNCRA2  I $G(^PS(50.608,PSNCRA2,0))'="" S PSNCRAT=PSNCRAT+1
"RTN","PSNVCR2",130,0)
 I PSNFON W !!,"PACKAGE TYPE file (#50.608) - "_PSNCRAT_" records"
"RTN","PSNVCR2",131,0)
 I PSNFON,($Y+5)>IOSL D HD Q:PSNCROUT
"RTN","PSNVCR2",132,0)
 D @$S(PSNVRSUM="F":"KLF",1:"KL")
"RTN","PSNVCR2",133,0)
 I $D(PSNVRAR(PSNCRLC1)) D
"RTN","PSNVCR2",134,0)
 .I PSNVRSUM="F" D PRT(PSNCRLC1) Q
"RTN","PSNVCR2",135,0)
 .D SUM(PSNCRLC1)
"RTN","PSNVCR2",136,0)
 I PSNVRSUM="F" D PFUL(PSNCRLC3,PSNCRAT),KLF Q
"RTN","PSNVCR2",137,0)
 D PSUM(PSNCRLC3,PSNCRAT)
"RTN","PSNVCR2",138,0)
 Q
"RTN","PSNVCR2",139,0)
 ;
"RTN","PSNVCR2",140,0)
 ;
"RTN","PSNVCR2",141,0)
PAS ;print info for Package Size (#50.609) File
"RTN","PSNVCR2",142,0)
 S PSNCRTOT=1,PSNCRAT=0,PSNCRLC1=50.609,PSNCRLC3="PACKAGE SIZE"
"RTN","PSNVCR2",143,0)
 I PSNVRSUM="F" S PSNCRSUB="   (Package Size (#50.609) File cont.)"
"RTN","PSNVCR2",144,0)
 F PSNCRA2=0:0 S PSNCRA2=$O(^PS(50.609,PSNCRA2)) Q:'PSNCRA2  I $G(^PS(50.609,PSNCRA2,0))'="" S PSNCRAT=PSNCRAT+1
"RTN","PSNVCR2",145,0)
 I PSNFON W !!,"PACKAGE SIZE file (#50.609) - "_PSNCRAT_" records"
"RTN","PSNVCR2",146,0)
 I PSNFON,($Y+5)>IOSL D HD Q:PSNCROUT
"RTN","PSNVCR2",147,0)
 D @$S(PSNVRSUM="F":"KLF",1:"KL")
"RTN","PSNVCR2",148,0)
 I $D(PSNVRAR(PSNCRLC1)) D
"RTN","PSNVCR2",149,0)
 .I PSNVRSUM="F" D PRT(PSNCRLC1) Q
"RTN","PSNVCR2",150,0)
 .D SUM(PSNCRLC1)
"RTN","PSNVCR2",151,0)
 I PSNVRSUM="F" D PFUL(PSNCRLC3,PSNCRAT),KLF Q
"RTN","PSNVCR2",152,0)
 D PSUM(PSNCRLC3,PSNCRAT)
"RTN","PSNVCR2",153,0)
 Q
"RTN","PSNVCR2",154,0)
 ;
"RTN","PSNVCR2",155,0)
 ;
"RTN","PSNVCR2",156,0)
VAD ;print info for VA Dispense Unit (#50.64) File
"RTN","PSNVCR2",157,0)
 S PSNCRTOT=1,PSNCRAT=0,PSNCRLC1=50.64,PSNCRLC3="VA DISPENSE UNIT"
"RTN","PSNVCR2",158,0)
 I PSNVRSUM="F" S PSNCRSUB="   (VA Dispense Unit (#50.64) File cont.)"
"RTN","PSNVCR2",159,0)
 F PSNCRA2=0:0 S PSNCRA2=$O(^PSNDF(50.64,PSNCRA2)) Q:'PSNCRA2  I $G(^PSNDF(50.64,PSNCRA2,0))'="" S PSNCRAT=PSNCRAT+1
"RTN","PSNVCR2",160,0)
 I PSNFON W !!,"VA DISPENSE UNIT file (#50.64) - "_PSNCRAT_" records"
"RTN","PSNVCR2",161,0)
 I PSNFON,($Y+5)>IOSL D HD Q:PSNCROUT
"RTN","PSNVCR2",162,0)
 D @$S(PSNVRSUM="F":"KLF",1:"KL")
"RTN","PSNVCR2",163,0)
 I $D(PSNVRAR(PSNCRLC1)) D
"RTN","PSNVCR2",164,0)
 .I PSNVRSUM="F" D PRT(PSNCRLC1) Q
"RTN","PSNVCR2",165,0)
 .D SUM(PSNCRLC1)
"RTN","PSNVCR2",166,0)
 I PSNVRSUM="F" D PFUL(PSNCRLC3,PSNCRAT),KLF Q
"RTN","PSNVCR2",167,0)
 D PSUM(PSNCRLC3,PSNCRAT)
"RTN","PSNVCR2",168,0)
 Q
"RTN","PSNVCR2",169,0)
 ;
"RTN","PSNVCR2",170,0)
 ;
"RTN","PSNVCR2",171,0)
NDC ;print info for NDC/UPN (#50.67) File
"RTN","PSNVCR2",172,0)
 S PSNCRTOT=1,PSNCRAT=0,PSNCRLC1=50.67,PSNCRLC3="NDC/UPN"
"RTN","PSNVCR2",173,0)
 I PSNVRSUM="F" S PSNCRSUB="   (NDC/UPN (#50.67) File cont.)"
"RTN","PSNVCR2",174,0)
 I PSNCRDEV="C",PSNFON W !
"RTN","PSNVCR2",175,0)
 F PSNCRA2=0:0 S PSNCRA2=$O(^PSNDF(50.67,PSNCRA2)) Q:'PSNCRA2  I $G(^PSNDF(50.67,PSNCRA2,0))'="" S PSNCRAT=PSNCRAT+1 I PSNCRDEV="C",PSNFON,PSNCRAT#20000=0 W "."
"RTN","PSNVCR2",176,0)
 I PSNFON W !!,"NDC/UPN file (#50.67) - "_PSNCRAT_" records"
"RTN","PSNVCR2",177,0)
 I PSNFON,($Y+5)>IOSL D HD Q:PSNCROUT
"RTN","PSNVCR2",178,0)
 D @$S(PSNVRSUM="F":"KLF",1:"KL")
"RTN","PSNVCR2",179,0)
 I $D(PSNVRAR(PSNCRLC1)) D
"RTN","PSNVCR2",180,0)
 .I PSNVRSUM="F" D PRT(PSNCRLC1) Q
"RTN","PSNVCR2",181,0)
 .D SUM(PSNCRLC1)
"RTN","PSNVCR2",182,0)
 I PSNVRSUM="F" D PFUL(PSNCRLC3,PSNCRAT),KLF Q
"RTN","PSNVCR2",183,0)
 D PSUM(PSNCRLC3,PSNCRAT)
"RTN","PSNVCR2",184,0)
 Q
"RTN","PSNVCR2",185,0)
 ;
"RTN","PSNVCR2",186,0)
 ;
"RTN","PSNVCR2",187,0)
VAP ;print info for VA Product (#50.68) File
"RTN","PSNVCR2",188,0)
 S PSNCRTOT=1,PSNCRAT=0,PSNCRLC1=50.68,PSNCRLC3="VA PRODUCT"
"RTN","PSNVCR2",189,0)
 I PSNVRSUM="F" S PSNCRSUB="   (VA Product (#50.68) File cont.)"
"RTN","PSNVCR2",190,0)
 I PSNCRDEV="C",PSNFON W !
"RTN","PSNVCR2",191,0)
 F PSNCRA2=0:0 S PSNCRA2=$O(^PSNDF(50.68,PSNCRA2)) Q:'PSNCRA2  I $G(^PSNDF(50.68,PSNCRA2,0))'="" S PSNCRAT=PSNCRAT+1 I PSNCRDEV="C",PSNFON,PSNCRAT#5000=0 W "."
"RTN","PSNVCR2",192,0)
 I PSNFON W !!,"VA PRODUCT file (#50.68) - "_PSNCRAT_" records"
"RTN","PSNVCR2",193,0)
 I PSNFON,($Y+5)>IOSL D HD Q:PSNCROUT
"RTN","PSNVCR2",194,0)
 D @$S(PSNVRSUM="F":"KLF",1:"KL")
"RTN","PSNVCR2",195,0)
 I $D(PSNVRAR(PSNCRLC1)) D
"RTN","PSNVCR2",196,0)
 .I PSNVRSUM="F" D PRT(PSNCRLC1) Q
"RTN","PSNVCR2",197,0)
 .D SUM(PSNCRLC1)
"RTN","PSNVCR2",198,0)
 I PSNVRSUM="F" D PFUL(PSNCRLC3,PSNCRAT),KLF Q
"RTN","PSNVCR2",199,0)
 D PSUM(PSNCRLC3,PSNCRAT)
"RTN","PSNVCR2",200,0)
 Q
"RTN","PSNVCR2",201,0)
 ;
"RTN","PSNVCR2",202,0)
 ;
"RTN","PSNVCR2",203,0)
DRM ;print info for Drug Manufacturer (#55.95) File
"RTN","PSNVCR2",204,0)
 S PSNCRTOT=1,PSNCRAT=0,PSNCRLC1=55.95,PSNCRLC3="DRUG MANUFACTURER"
"RTN","PSNVCR2",205,0)
 I PSNVRSUM="F" S PSNCRSUB="   (Drug Manufacturer (#55.95) File cont.)"
"RTN","PSNVCR2",206,0)
 F PSNCRA2=0:0 S PSNCRA2=$O(^PS(55.95,PSNCRA2)) Q:'PSNCRA2  I $G(^PS(55.95,PSNCRA2,0))'="" S PSNCRAT=PSNCRAT+1
"RTN","PSNVCR2",207,0)
 I PSNFON W !!,"DRUG MANUFACTURER file (#55.95) - "_PSNCRAT_" records"
"RTN","PSNVCR2",208,0)
 I PSNFON,($Y+5)>IOSL D HD Q:PSNCROUT
"RTN","PSNVCR2",209,0)
 D @$S(PSNVRSUM="F":"KLF",1:"KL")
"RTN","PSNVCR2",210,0)
 I $D(PSNVRAR(PSNCRLC1)) D
"RTN","PSNVCR2",211,0)
 .I PSNVRSUM="F" D PRT(PSNCRLC1) Q
"RTN","PSNVCR2",212,0)
 .D SUM(PSNCRLC1)
"RTN","PSNVCR2",213,0)
 I PSNVRSUM="F" D PFUL(PSNCRLC3,PSNCRAT),KLF Q
"RTN","PSNVCR2",214,0)
 D PSUM(PSNCRLC3,PSNCRAT)
"RTN","PSNVCR2",215,0)
 Q
"RTN","PSNVCR2",216,0)
 ;
"RTN","PSNVCR2",217,0)
 ;
"RTN","PSNVCR2",218,0)
DRI ;print info for Drug Interaction (#56) File
"RTN","PSNVCR2",219,0)
 S PSNCRTOT=1,PSNCRAT=0,PSNCRLC1=56,PSNCRLC3="DRUG INTERACTION"
"RTN","PSNVCR2",220,0)
 I PSNVRSUM="F" S PSNCRSUB="   (Drug Interaction (#56) File cont.)"
"RTN","PSNVCR2",221,0)
 F PSNCRA2=0:0 S PSNCRA2=$O(^PS(56,PSNCRA2)) Q:'PSNCRA2  I $G(^PS(56,PSNCRA2,0))'="" S PSNCRAT=PSNCRAT+1
"RTN","PSNVCR2",222,0)
 I PSNFON W !!,"DRUG INTERACTION file (#56) - "_PSNCRAT_" records"
"RTN","PSNVCR2",223,0)
 I PSNFON,($Y+5)>IOSL D HD Q:PSNCROUT
"RTN","PSNVCR2",224,0)
 D @$S(PSNVRSUM="F":"KLF",1:"KL")
"RTN","PSNVCR2",225,0)
 I $D(PSNVRAR(PSNCRLC1)) D
"RTN","PSNVCR2",226,0)
 .I PSNVRSUM="F" D PRT(PSNCRLC1) Q
"RTN","PSNVCR2",227,0)
 .D SUM(PSNCRLC1)
"RTN","PSNVCR2",228,0)
 I PSNVRSUM="F" D PFUL(PSNCRLC3,PSNCRAT),KLF Q
"RTN","PSNVCR2",229,0)
 D PSUM(PSNCRLC3,PSNCRAT)
"RTN","PSNVCR2",230,0)
 Q
"RTN","PSNVCR2",231,0)
 ;
"RTN","PSNVCR2",232,0)
 ;
"RTN","PSNVCR2",233,0)
PRT(PSNCRS2) ;Print Audit File changes
"RTN","PSNVCR2",234,0)
 ;TMP("PSNFFILE",$J,.01 name, IEN, Field Name, Field Number, File or Subfile #, counter)=Old Value^New Value
"RTN","PSNVCR2",235,0)
 ;PSNCRLC2(File #, IEN, File or Subfile #, Field #)=Count
"RTN","PSNVCR2",236,0)
 N PSNCRSL1,PSNCRSL2,PSNCRSLF,PSNCRSLI,PSNCRSLN,PSNCRLAB,PSNCRNAM,PSNCROCT,PSNCRFN1,PSNCRFN2,PSNCRFN3,PSNCRFN4,PSNCRFN5,PSNCRPAS
"RTN","PSNVCR2",237,0)
 F PSNCRSL1=PSNVRBEG:0 S PSNCRSL1=$O(^DIA(PSNCRS2,"C",PSNCRSL1)) Q:'PSNCRSL1!(PSNVREND'>PSNCRSL1)  D
"RTN","PSNVCR2",238,0)
 .F PSNCRSL2=0:0 S PSNCRSL2=$O(^DIA(PSNCRS2,"C",PSNCRSL1,PSNCRSL2)) Q:'PSNCRSL2  D
"RTN","PSNVCR2",239,0)
 ..S PSNCRSLN=$G(^DIA(PSNCRS2,PSNCRSL2,0)),PSNCRPAS=1
"RTN","PSNVCR2",240,0)
 ..S PSNCRSLI=+$P(PSNCRSLN,"^"),PSNCRSLF=$P(PSNCRSLN,"^",3) Q:'PSNCRSLI  I 'PSNCRSLF S PSNCRPAS=0
"RTN","PSNVCR2",241,0)
 ..I PSNCRPAS D 
"RTN","PSNVCR2",242,0)
 ...S PSNCRFN1=$P(PSNCRSLF,","),PSNCRFN2=$P(PSNCRSLF,",",2) D
"RTN","PSNVCR2",243,0)
 ....S PSNCRFN3=0 I 'PSNCRFN2,$D(PSNVRAR(PSNCRS2,PSNCRFN1)) S PSNCRFN3=PSNVRAR(PSNCRS2,PSNCRFN1) Q
"RTN","PSNVCR2",244,0)
 ....I 'PSNCRFN2 Q
"RTN","PSNVCR2",245,0)
 ....S PSNCRFN3=$G(PSNVRAR(PSNCRS2,PSNCRFN1,PSNCRFN2))
"RTN","PSNVCR2",246,0)
 ..I PSNCRPAS,'PSNCRFN3 Q
"RTN","PSNVCR2",247,0)
 ..I PSNCRPAS S PSNCRFN4=$S(PSNCRFN2:PSNCRFN3,1:PSNCRS2),PSNCRFN5=$S(PSNCRFN2:PSNCRFN2,1:PSNCRFN1)
"RTN","PSNVCR2",248,0)
 ..I PSNCRPAS,'PSNCRFN2 S PSNCRLAB=$$GET1^DID(PSNCRS2,PSNCRFN1,,"LABEL") I PSNCRLAB="" S PSNCRPAS=0
"RTN","PSNVCR2",249,0)
 ..I PSNCRPAS,PSNCRFN2 S PSNCRLAB=$$GET1^DID(PSNCRFN3,PSNCRFN2,,"LABEL") I PSNCRLAB="" S PSNCRPAS=0
"RTN","PSNVCR2",250,0)
 ..I 'PSNCRPAS S PSNCRFN4=9999999,PSNCRFN5=9999999,PSNCRLAB="UNKNOWN"
"RTN","PSNVCR2",251,0)
 ..S PSNCRNAM=$$GET1^DIQ(PSNCRS2,PSNCRSLI,.01) I PSNCRNAM="" S PSNCRNAM="ZZZZMISSING_("_PSNCRSLI_") File entry missing"
"RTN","PSNVCR2",252,0)
 ..S (PSNCRLC2(PSNCRS2,PSNCRSLI,PSNCRFN4,PSNCRFN5),PSNCROCT)=+$G(PSNCRLC2(PSNCRS2,PSNCRSLI,PSNCRFN4,PSNCRFN5))+1
"RTN","PSNVCR2",253,0)
 ..S ^TMP("PSNFFILE",$J,PSNCRNAM,PSNCRSLI,PSNCRLAB,PSNCRFN5,PSNCRFN4,PSNCROCT)=$P($G(^DIA(PSNCRS2,PSNCRSL2,2)),"^")_"^"_$P($G(^DIA(PSNCRS2,PSNCRSL2,3)),"^")
"RTN","PSNVCR2",254,0)
 ;
"RTN","PSNVCR2",255,0)
 Q
"RTN","PSNVCR2",256,0)
 ;
"RTN","PSNVCR2",257,0)
 ;
"RTN","PSNVCR2",258,0)
SUM(PSNCRS6) ;Print Audit File summary changes
"RTN","PSNVCR2",259,0)
 ;PSNCRS7=Total records changed per file
"RTN","PSNVCR2",260,0)
 ;^TMP("PSNSFILE",$J,IEN)=""   Used to indicate this record has already been added to the PSNCRS7 array
"RTN","PSNVCR2",261,0)
 ;PSNCRS8=Total number of Fields changed
"RTN","PSNVCR2",262,0)
 ;^TMP("PSNTFILE",$J,IEN)=""    indicates already added to PSNCRS9 array, for missing PSN file entry
"RTN","PSNVCR2",263,0)
 ;PSNCRSM9=Total number of Fields changes for a missing entry
"RTN","PSNVCR2",264,0)
 N PSNCRSL1,PSNCRSL2,PSNCRSLF,PSNCRSLI,PSNCRSLN,PSNCRM1,PSNCRM2
"RTN","PSNVCR2",265,0)
 F PSNCRSL1=PSNVRBEG:0 S PSNCRSL1=$O(^DIA(PSNCRS6,"C",PSNCRSL1)) Q:'PSNCRSL1!(PSNVREND'>PSNCRSL1)  D
"RTN","PSNVCR2",266,0)
 .F PSNCRSL2=0:0 S PSNCRSL2=$O(^DIA(PSNCRS6,"C",PSNCRSL1,PSNCRSL2)) Q:'PSNCRSL2  D
"RTN","PSNVCR2",267,0)
 ..S PSNCRSLN=$G(^DIA(PSNCRS6,PSNCRSL2,0))
"RTN","PSNVCR2",268,0)
 ..S PSNCRSLI=+$P(PSNCRSLN,"^"),PSNCRSLF=$P(PSNCRSLN,"^",3) Q:'PSNCRSLI!('PSNCRSLF)
"RTN","PSNVCR2",269,0)
 ..S PSNCRM1=$P(PSNCRSLF,","),PSNCRM2=$P(PSNCRSLF,",",2)
"RTN","PSNVCR2",270,0)
 ..I 'PSNCRM2,'$D(PSNVRAR(PSNCRS6,PSNCRSLF)) Q
"RTN","PSNVCR2",271,0)
 ..I PSNCRM2,'$D(PSNVRAR(PSNCRS6,PSNCRM1,PSNCRM2)) Q
"RTN","PSNVCR2",272,0)
 ..I $$GET1^DIQ(PSNCRS6,PSNCRSLI,.01)="" D  Q
"RTN","PSNVCR2",273,0)
 ...S PSNCRS9=PSNCRS9+1
"RTN","PSNVCR2",274,0)
 ...I '$D(^TMP("PSNTFILE",$J,PSNCRSLI)) S ^TMP("PSNTFILE",$J,PSNCRSLI)="",PSNCRSM9=PSNCRSM9+1
"RTN","PSNVCR2",275,0)
 ..S PSNCRS8=PSNCRS8+1
"RTN","PSNVCR2",276,0)
 ..I '$D(^TMP("PSNSFILE",$J,PSNCRSLI)) S ^TMP("PSNSFILE",$J,PSNCRSLI)="",PSNCRS7=PSNCRS7+1
"RTN","PSNVCR2",277,0)
 Q
"RTN","PSNVCR2",278,0)
 ;
"RTN","PSNVCR2",279,0)
 ;
"RTN","PSNVCR2",280,0)
PSUM(PSNCRFDN,PSNCRFTR) ;Print summary values
"RTN","PSNVCR2",281,0)
 I 'PSNFON D  Q
"RTN","PSNVCR2",282,0)
 .W !,PSNCRFDN_"^"_PSNCRFTR_"^"_PSNCRS7_"^"_PSNCRS8
"RTN","PSNVCR2",283,0)
 .I PSNCRS9 W !,PSNCRFDN_" MISSING ENTRIES^"_PSNCRFTR_"^"_PSNCRSM9_"^"_PSNCRS9
"RTN","PSNVCR2",284,0)
 I 'PSNCRS7,'PSNCRS9 D  D KL Q 
"RTN","PSNVCR2",285,0)
 .W !?5,"No Change"
"RTN","PSNVCR2",286,0)
 .I ($Y+5)>IOSL D HD
"RTN","PSNVCR2",287,0)
 I PSNCRS7 D 
"RTN","PSNVCR2",288,0)
 .W !?5,"Records Changed: "_PSNCRS7
"RTN","PSNVCR2",289,0)
 .I ($Y+5)>IOSL D HD I PSNCROUT D KL Q
"RTN","PSNVCR2",290,0)
 .W !?5,"Fields/Sub-fields Changed: "_PSNCRS8
"RTN","PSNVCR2",291,0)
 I PSNCRS9 D
"RTN","PSNVCR2",292,0)
 .W !,PSNCRFDN_" file MISSING ENTRIES:"
"RTN","PSNVCR2",293,0)
 .W !?5,"Records Changed: "_PSNCRSM9
"RTN","PSNVCR2",294,0)
 .I ($Y+5)>IOSL D HD I PSNCROUT D KL Q
"RTN","PSNVCR2",295,0)
 .W !?5,"Fields/Sub-fields Changed: "_PSNCRS9
"RTN","PSNVCR2",296,0)
 D KL
"RTN","PSNVCR2",297,0)
 I ($Y+5)>IOSL D HD
"RTN","PSNVCR2",298,0)
 Q
"RTN","PSNVCR2",299,0)
 ;
"RTN","PSNVCR2",300,0)
 ;
"RTN","PSNVCR2",301,0)
PFUL(PSNPRHLA,PSNPRHLB) ;Print full values
"RTN","PSNVCR2",302,0)
 ;When printing, if 'File or Subfile#' changes within same field name, redisplay Field name because that means
"RTN","PSNVCR2",303,0)
 ;you have the same Field name for a top level and multiple field, and same for .01 name
"RTN","PSNVCR2",304,0)
 N PSNPR1,PSNPR2,PSNPR3,PSNPR4,PSNPR5,PSNPR6,PSNPR7,PSNPRHLD,PSNPRHLC,PSNPRHLN,PSNPRHLM,PSNPRHLO,PSNPRHL1,PSNPRHLH,PSNPRNDC,PSNPRNDM,PSNPRMS1,PSNPRMS2
"RTN","PSNVCR2",305,0)
 S PSNPRNDC=$S(PSNPRHLA="NDC/UPN":0,1:1) K PSNPRNDM
"RTN","PSNVCR2",306,0)
 I 'PSNFON W !,PSNPRHLA_"^Records - "_PSNPRHLB
"RTN","PSNVCR2",307,0)
 I '$D(^TMP("PSNFFILE",$J)) D  Q
"RTN","PSNVCR2",308,0)
 .I PSNFON W !?5,"No Change" D:($Y+5)>IOSL HD Q
"RTN","PSNVCR2",309,0)
 .W !,PSNPRHLA_"^***No Changes***"
"RTN","PSNVCR2",310,0)
 S PSNPRHLD="",PSNPRHL1=0
"RTN","PSNVCR2",311,0)
 S PSNPR1="" F  S PSNPR1=$O(^TMP("PSNFFILE",$J,PSNPR1)) Q:PSNPR1=""!(PSNCROUT)  S PSNPRHLD="" D
"RTN","PSNVCR2",312,0)
 .I 'PSNPRNDC S PSNPRNDM=$S($P($G(^PSNDF(50.67,PSNPR1,0)),"^",2)'="":$P($G(^PSNDF(50.67,PSNPR1,0)),"^",2),1:"Missing NDC")
"RTN","PSNVCR2",313,0)
 .K PSNPRMS2 S PSNPRMS1=0 I $E(PSNPR1,1,11)="ZZZZMISSING" S PSNPRMS1=1,PSNPRMS2=$E(PSNPR1,12,$L(PSNPR1))
"RTN","PSNVCR2",314,0)
 .S PSNPRHLC=0 I PSNFON W !!,$S(PSNPRNDC:PSNPR1,PSNPRMS1:PSNPRMS2,1:PSNPRNDM) I ($Y+5)>IOSL D HD I PSNCROUT Q
"RTN","PSNVCR2",315,0)
 .I 'PSNFON S PSNPRHLH=PSNPRHLA_"^"_$S(PSNPRNDC:PSNPR1,PSNPRMS1:PSNPRMS2,1:PSNPRNDM)
"RTN","PSNVCR2",316,0)
 .F PSNPR2=0:0 S PSNPR2=$O(^TMP("PSNFFILE",$J,PSNPR1,PSNPR2)) D:PSNPRHLD'=""&(PSNPRHL1)&(PSNPR2)&(PSNPRHLD=PSNPR1)&(PSNPRHL1'=PSNPR2) CH1 S PSNPRHLD=PSNPR1,PSNPRHL1=PSNPR2 Q:'PSNPR2!(PSNCROUT)  D
"RTN","PSNVCR2",317,0)
 ..S PSNPR3="" F  S PSNPR3=$O(^TMP("PSNFFILE",$J,PSNPR1,PSNPR2,PSNPR3)) Q:PSNPR3=""!(PSNCROUT)  S PSNPRHLN=0,PSNPRHLM="" D
"RTN","PSNVCR2",318,0)
 ...F PSNPR4=0:0 S PSNPR4=$O(^TMP("PSNFFILE",$J,PSNPR1,PSNPR2,PSNPR3,PSNPR4)) Q:'PSNPR4!(PSNCROUT)  D
"RTN","PSNVCR2",319,0)
 ....F PSNPR5=0:0 S PSNPR5=$O(^TMP("PSNFFILE",$J,PSNPR1,PSNPR2,PSNPR3,PSNPR4,PSNPR5)) D CH2 Q:'PSNPR5!(PSNCROUT)  D
"RTN","PSNVCR2",320,0)
 .....I PSNFON,($Y+5)>IOSL D HD I PSNCROUT Q
"RTN","PSNVCR2",321,0)
 .....F PSNPR6=0:0 S PSNPR6=$O(^TMP("PSNFFILE",$J,PSNPR1,PSNPR2,PSNPR3,PSNPR4,PSNPR5,PSNPR6)) Q:'PSNPR6!(PSNCROUT)  D
"RTN","PSNVCR2",322,0)
 ......S PSNPR7=$G(^TMP("PSNFFILE",$J,PSNPR1,PSNPR2,PSNPR3,PSNPR4,PSNPR5,PSNPR6))
"RTN","PSNVCR2",323,0)
 ......I 'PSNFON S PSNPRHLH=PSNPRHLH_"^"_$P(PSNPR7,"^")_"^"_$P(PSNPR7,"^",2) Q
"RTN","PSNVCR2",324,0)
 ......W !?5,"Old Value: "_$P(PSNPR7,"^") I ($Y+5)>IOSL D HD I PSNCROUT Q
"RTN","PSNVCR2",325,0)
 ......W !?5,"New Value: "_$P(PSNPR7,"^",2) I ($Y+5)>IOSL D HD I PSNCROUT Q
"RTN","PSNVCR2",326,0)
 .....I 'PSNFON W !,PSNPRHLH S PSNPRHLH=$P(PSNPRHLH,"^")_"^"_$P(PSNPRHLH,"^",2)
"RTN","PSNVCR2",327,0)
 Q
"RTN","PSNVCR2",328,0)
 ;
"RTN","PSNVCR2",329,0)
 ;
"RTN","PSNVCR2",330,0)
CH1 ;IEN change of the same name
"RTN","PSNVCR2",331,0)
 Q:PSNCROUT
"RTN","PSNVCR2",332,0)
 S PSNPRHLC=PSNPRHLC+1
"RTN","PSNVCR2",333,0)
 I PSNFON W !!,PSNPR1_" (Duplicate Name #"_PSNPRHLC_")" D:($Y+5)>IOSL HD Q
"RTN","PSNVCR2",334,0)
 S PSNPRHLH=PSNPRHLA_"^"_PSNPR1_" (Duplicate Name #"_PSNPRHLC_")"
"RTN","PSNVCR2",335,0)
 Q
"RTN","PSNVCR2",336,0)
 ;
"RTN","PSNVCR2",337,0)
 ;
"RTN","PSNVCR2",338,0)
CH2 ;Subfile change of the same field name name
"RTN","PSNVCR2",339,0)
 Q:PSNCROUT!('PSNPR5)
"RTN","PSNVCR2",340,0)
 S:'PSNPRHLN PSNPRHLM=PSNPR4_"^"_PSNPR5
"RTN","PSNVCR2",341,0)
 I 'PSNPRHLN,'PSNFON S PSNPRHLH=PSNPRHLH_"^"_PSNPR3_"^"_PSNPR4 S PSNPRHLN=1 Q
"RTN","PSNVCR2",342,0)
 I 'PSNPRHLN W !!?5,PSNPR3_" ("_PSNPR4_")" S PSNPRHLN=PSNPRHLN+1 D:($Y+5)>IOSL HD Q
"RTN","PSNVCR2",343,0)
 S PSNPRHLO=PSNPR4_"^"_PSNPR5 I PSNPRHLO'=PSNPRHLM D  S PSNPRHLM=PSNPRHLO,PSNPRHLN=1 Q
"RTN","PSNVCR2",344,0)
 .I PSNFON W !!?5,PSNPR3_" ("_PSNPR4_")"_" (Duplicate Field.  SubFile #"_$P(PSNPRHLO,"^",2)_")" D:($Y+5)>IOSL HD Q
"RTN","PSNVCR2",345,0)
 .S PSNPRHLH=PSNPRHLH_"^"_PSNPR3_" (SubFile #"_$P(PSNPRHLO,"^",2)_")^"_PSNPR4
"RTN","PSNVCR2",346,0)
 Q
"RTN","PSNVCR2",347,0)
 ;
"RTN","PSNVCR2",348,0)
 ;
"RTN","PSNVCR2",349,0)
KL ;Kill TMP global
"RTN","PSNVCR2",350,0)
 K ^TMP("PSNSFILE",$J),^TMP("PSNTFILE",$J) S (PSNCRS7,PSNCRS8,PSNCRS9,PSNCRSM9)=0
"RTN","PSNVCR2",351,0)
 Q
"RTN","PSNVCR2",352,0)
 ;
"RTN","PSNVCR2",353,0)
 ;
"RTN","PSNVCR2",354,0)
KLF ;Kill TMP global
"RTN","PSNVCR2",355,0)
 K ^TMP("PSNFFILE",$J),PSNCRLC2
"RTN","PSNVCR2",356,0)
 Q
"SEC","^DIC",57.23,57.23,0,"AUDIT")
@
"SEC","^DIC",57.23,57.23,0,"DD")
@
"SEC","^DIC",57.23,57.23,0,"DEL")
@
"SEC","^DIC",57.23,57.23,0,"LAYGO")
@
"SEC","^DIC",57.23,57.23,0,"RD")
@
"SEC","^DIC",57.23,57.23,0,"WR")
@
"VER")
8.0^22.0
"^DD",57.23,57.23,0)
FIELD^^45^23
"^DD",57.23,57.23,0,"DDA")
N
"^DD",57.23,57.23,0,"DT")
3170628
"^DD",57.23,57.23,0,"IX","B",57.23,.01)

"^DD",57.23,57.23,0,"NM","PPS-N UPDATE CONTROL")

"^DD",57.23,57.23,0,"VRPK")
PSN
"^DD",57.23,57.23,.01,0)
NAME^RFa^^0;1^K:$L(X)>7!($L(X)<3) X
"^DD",57.23,57.23,.01,.1)
System Name
"^DD",57.23,57.23,.01,1,0)
^.1
"^DD",57.23,57.23,.01,1,1,0)
57.23^B
"^DD",57.23,57.23,.01,1,1,1)
S ^PS(57.23,"B",$E(X,1,30),DA)=""
"^DD",57.23,57.23,.01,1,1,2)
K ^PS(57.23,"B",$E(X,1,30),DA)
"^DD",57.23,57.23,.01,3)
Answer must be 3-7 characters in length.
"^DD",57.23,57.23,.01,21,0)
^^2^2^3170908^
"^DD",57.23,57.23,.01,21,1,0)
This field will be used to store the system name for example Pharmacy 
"^DD",57.23,57.23,.01,21,2,0)
Product System uses PPSN. There should be one entry in file (#57.23).
"^DD",57.23,57.23,.01,"AUDIT")
y
"^DD",57.23,57.23,.01,"DT")
3170908
"^DD",57.23,57.23,1,0)
OPEN VMS LOCAL DIRECTORY^FaX^^0;2^K:$L(X)>100!($L(X)<1) X I $D(X) S X=$$STRIP^PSNPARM(X)
"^DD",57.23,57.23,1,.1)
Open VMS Local Directory
"^DD",57.23,57.23,1,3)
Answer must be 1-100 characters in length.
"^DD",57.23,57.23,1,21,0)
^.001^2^2^3170222^^
"^DD",57.23,57.23,1,21,1,0)
This field contains the full path directory structure where the PPS-N 
"^DD",57.23,57.23,1,21,2,0)
update file will be located (e.g., USER$:[SFTP.PPSN]).
"^DD",57.23,57.23,1,"AUDIT")
y
"^DD",57.23,57.23,1,"DT")
3171012
"^DD",57.23,57.23,2,0)
INSTALL VERSION^NJ8,0a^^0;3^K:+X'=X!(X>99999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",57.23,57.23,2,.1)
Install Version Number
"^DD",57.23,57.23,2,3)
Type a whole number between 0-99999999 for the version number of the last successful PPS-N Update file number installed.
"^DD",57.23,57.23,2,21,0)
^^4^4^3170222^
"^DD",57.23,57.23,2,21,1,0)
This field contains the current version number of the last successful
"^DD",57.23,57.23,2,21,2,0)
Pharmacy Product System - National (PPS-N) Update file that was
"^DD",57.23,57.23,2,21,3,0)
installed.  For example if the last PPS-N Update file installed was
"^DD",57.23,57.23,2,21,4,0)
PPS_25PRV_26NEW.DAT, this field would contain 26.
"^DD",57.23,57.23,2,"AUDIT")
y
"^DD",57.23,57.23,2,"DT")
3170227
"^DD",57.23,57.23,3,0)
UNIX/LINUX LOCAL DIRECTORY^FaX^^0;4^K:$L(X)>50!($L(X)<1) X I $D(X) S X=$$STRIP^PSNPARM(X) I $L(X) D UNXLDIR^PSNPARM
"^DD",57.23,57.23,3,.1)
Unix/Linux Local Directory
"^DD",57.23,57.23,3,3)
Answer must be 1-50 characters in length.
"^DD",57.23,57.23,3,21,0)
^^4^4^3170227^
"^DD",57.23,57.23,3,21,1,0)
This field contains the name of the local Unix/Linux secure 
"^DD",57.23,57.23,3,21,2,0)
directory where the Pharmacy Product System - National (PPS-N) Update 
"^DD",57.23,57.23,3,21,3,0)
file will be stored on the local system after download from the PPS-N
"^DD",57.23,57.23,3,21,4,0)
server (e.g. /usr/PPSN/).
"^DD",57.23,57.23,3,"AUDIT")
y
"^DD",57.23,57.23,3,"DT")
3171012
"^DD",57.23,57.23,5,0)
PRIMARY PPS-N MAIL GROUP^FaX^^0;6^K:$L(X)>60!($L(X)<1) X I $D(X) S X=$$STRIP^PSNPARM(X)
"^DD",57.23,57.23,5,.1)
Primary PPS-N Mail Group
"^DD",57.23,57.23,5,3)
Enter 1-60 characters for the primary individual or mail group that will receive the PPS-N Update file messages.
"^DD",57.23,57.23,5,21,0)
^.001^6^6^3170524^^^
"^DD",57.23,57.23,5,21,1,0)
This field is used to store the MS Outlook email group that
"^DD",57.23,57.23,5,21,2,0)
will receive a copy of the PPS-N update messages.  These 
"^DD",57.23,57.23,5,21,3,0)
messages include download and install information, Data Update
"^DD",57.23,57.23,5,21,4,0)
for NDF report message, Updated Interactions and FDA Med Guide,
"^DD",57.23,57.23,5,21,5,0)
Drugs Unmatched from National Drug file, Local Drugs Rematched
"^DD",57.23,57.23,5,21,6,0)
to NDF, Interactions and Allergies Updated, and error messages.
"^DD",57.23,57.23,5,"AUDIT")
y
"^DD",57.23,57.23,5,"DT")
3171015
"^DD",57.23,57.23,6,0)
SECONDARY MAIL GROUP^FaX^^1;1^K:$L(X)>60!($L(X)<1) X I $D(X) S X=$$STRIP^PSNPARM(X)
"^DD",57.23,57.23,6,.1)
Secondary PPS-N Mail group
"^DD",57.23,57.23,6,3)
Enter 1-60 characters for the secondary individual or mail group that will receive PPS-N Update file messages.
"^DD",57.23,57.23,6,21,0)
^.001^6^6^3170524^^
"^DD",57.23,57.23,6,21,1,0)
This field is used to store the secondary MS Outlook email group that 
"^DD",57.23,57.23,6,21,2,0)
will receive a copy of the PPS-N update messages.  These messages 
"^DD",57.23,57.23,6,21,3,0)
include download and install information, Data Update for NDF report
"^DD",57.23,57.23,6,21,4,0)
message, Updated Interactions and FDA Med Guide, Drugs Unmatched from
"^DD",57.23,57.23,6,21,5,0)
National Drug file, Local Drugs Rematched to NDF, Interactions and
"^DD",57.23,57.23,6,21,6,0)
Allergies Updated, and error messages.
"^DD",57.23,57.23,6,"AUDIT")
y
"^DD",57.23,57.23,6,"DT")
3171015
"^DD",57.23,57.23,8,0)
DOWNLOAD VERSION^NJ8,0a^^0;7^K:+X'=X!(X>99999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",57.23,57.23,8,.1)
Download Version Number
"^DD",57.23,57.23,8,3)
Enter the version number for the last PPS-N Update file downloaded.  The version must be a whole number between 0-99999999.
"^DD",57.23,57.23,8,21,0)
^^4^4^3170222^
"^DD",57.23,57.23,8,21,1,0)
This field contains the version number for the last Pharmacy 
"^DD",57.23,57.23,8,21,2,0)
Product System - National (PPS-N) Update file downloaded.  
"^DD",57.23,57.23,8,21,3,0)
For example if the last PPS-N Update file downloaded was
"^DD",57.23,57.23,8,21,4,0)
PPS_25PRV_26NEW.DAT, this field would contain 26.
"^DD",57.23,57.23,8,"AUDIT")
y
"^DD",57.23,57.23,8,"DT")
3170227
"^DD",57.23,57.23,9,0)
DOWNLOAD STATUS^Sa^N:NOT IN PROGRESS;Y:IN PROGRESS;^0;8^Q
"^DD",57.23,57.23,9,.1)
Download Status
"^DD",57.23,57.23,9,3)
Enter 'Y' for download in progress or 'N' for not in progress.
"^DD",57.23,57.23,9,21,0)
^.001^2^2^3170222^^^
"^DD",57.23,57.23,9,21,1,0)
This field is used to track the status of a PPS-N/NDF Update file 
"^DD",57.23,57.23,9,21,2,0)
download from the PPS-N sftp server.
"^DD",57.23,57.23,9,"AUDIT")
y
"^DD",57.23,57.23,9,"DT")
3170222
"^DD",57.23,57.23,10,0)
INSTALL STATUS^Sa^N:NOT IN PROGRESS;Y:IN PROGRESS;^0;9^Q
"^DD",57.23,57.23,10,.1)
Install Status
"^DD",57.23,57.23,10,3)
Enter 'Y' for install in progress or 'N' for not in progress.
"^DD",57.23,57.23,10,21,0)
^.001^2^2^3170222^^
"^DD",57.23,57.23,10,21,1,0)
This field is used to track the status of a PPS-N/NDF Update file 
"^DD",57.23,57.23,10,21,2,0)
install into the National Drug file package.
"^DD",57.23,57.23,10,"AUDIT")
y
"^DD",57.23,57.23,10,"DT")
3170222
"^DD",57.23,57.23,20,0)
REMOTE SERVER ADDRESS^FaX^^2;1^K:$L(X)>60!($L(X)<5) X I $D(X) S X=$$STRIP^PSNPARM(X)
"^DD",57.23,57.23,20,.1)
Remote Server Address
"^DD",57.23,57.23,20,3)
Answer must be 5-60 characters in length.
"^DD",57.23,57.23,20,21,0)
^.001^3^3^3170222^^
"^DD",57.23,57.23,20,21,1,0)
This is the secure FTP IP address of the Pharmacy Product System-
"^DD",57.23,57.23,20,21,2,0)
National(PPS-N) server where the PPS-N NDF Update file will be 
"^DD",57.23,57.23,20,21,3,0)
retrieved.
"^DD",57.23,57.23,20,"AUDIT")
y
"^DD",57.23,57.23,20,"DT")
3171015
"^DD",57.23,57.23,21,0)
REMOTE DIRECTORY ACCESS^FaX^^2;2^K:$L(X)>100!($L(X)<1) X I $D(X) S X=$$STRIP^PSNPARM(X)
"^DD",57.23,57.23,21,.1)
Remote Server Directory
"^DD",57.23,57.23,21,3)
Answer must be 1-100 characters in length.
"^DD",57.23,57.23,21,21,0)
^.001^2^2^3170222^^
"^DD",57.23,57.23,21,21,1,0)
This is the directory name at the Pharmacy Product System-National
"^DD",57.23,57.23,21,21,2,0)
(PPS-N) server where the PPS-N NDF Update file will be retrieved.
"^DD",57.23,57.23,21,"AUDIT")
y
"^DD",57.23,57.23,21,"DT")
3171015
"^DD",57.23,57.23,22,0)
REMOTE SFTP USER ID^FIa^^2;3^K:$L(X)>20!($L(X)<1) X
"^DD",57.23,57.23,22,.1)
Remote SFTP User ID
"^DD",57.23,57.23,22,3)
Enter 1-20 characters for the PPS-N secure FTP user name.
"^DD",57.23,57.23,22,21,0)
^^3^3^3170222^
"^DD",57.23,57.23,22,21,1,0)
This field contains the secure FTP username at the Pharmacy
"^DD",57.23,57.23,22,21,2,0)
Product System - National(PPS-N) server where the PPS-N NDF 
"^DD",57.23,57.23,22,21,3,0)
Update file will be retrieved.
"^DD",57.23,57.23,22,"AUDIT")
y
"^DD",57.23,57.23,22,"DT")
3170222
"^DD",57.23,57.23,30,0)
SCHEDULED OPTION^57.24P^^3;0
"^DD",57.23,57.23,30,"DT")
3151130
"^DD",57.23,57.23,31,0)
MENU OPTIONS^57.2331P^^3.1;0
"^DD",57.23,57.23,32,0)
PROTOCOLS^57.2332P^^3.2;0
"^DD",57.23,57.23,33,0)
SFTP PRIVATE KEY TEXT^57.2333^^PRVKEY;0
"^DD",57.23,57.23,33,21,0)
^.001^1^1^3170222^^^^
"^DD",57.23,57.23,33,21,1,0)
This is the Secure File Transfer Protocol (sFTP) private key text content.
"^DD",57.23,57.23,34,0)
SFTP PUBLIC KEY TEXT^57.2334^^PUBKEY;0
"^DD",57.23,57.23,34,21,0)
^.001^1^1^3160112^^^^
"^DD",57.23,57.23,34,21,1,0)
This is the Secure File Transfer Protocol (sFTP) public key text content.
"^DD",57.23,57.23,39,0)
SFTP SSH KEY FORMAT^Sa^OSSH:OpenSSH Format (Used by Linux);SSH2:SSH2 Format (Used by OpenVMS);^FILE1;1^Q
"^DD",57.23,57.23,39,.1)
SFTP SSH Key Format
"^DD",57.23,57.23,39,3)
Choose the sFTP SSH key format in use.
"^DD",57.23,57.23,39,"AUDIT")
y
"^DD",57.23,57.23,39,"DT")
3170224
"^DD",57.23,57.23,41,0)
SFTP SSH KEY ENCRYPTION^Sa^DSA:Digital Signature Algorithm;RSA:Rivest, Shamir & Adleman (Names);^FILE1;2^Q
"^DD",57.23,57.23,41,.1)
SFTP SSH Key Encryption
"^DD",57.23,57.23,41,3)
Choose the sFTP SSH Key Encryption Algorithm in use.
"^DD",57.23,57.23,41,21,0)
^^3^3^3170224^
"^DD",57.23,57.23,41,21,1,0)
This is the type of the encryption algorithm of the SSH (Secure 
"^DD",57.23,57.23,41,21,2,0)
Shell) public and private keys used to transmit data from PPS-N 
"^DD",57.23,57.23,41,21,3,0)
server via Secure File Transfer Protocol (sFTP).
"^DD",57.23,57.23,41,"AUDIT")
y
"^DD",57.23,57.23,41,"DT")
3170224
"^DD",57.23,57.23,45,0)
LEGACY UPDATE PROCESSING^R*Sa^N:NO;Y:YES;^0;10^Q
"^DD",57.23,57.23,45,.1)
Legacy Update Processing
"^DD",57.23,57.23,45,3)
Enter YES to indicate that the National Drug File will be updated via the legacy FORUM patch process or NO to indicate that NDF will be updated via the PPS-N 3.0 Update file process.
"^DD",57.23,57.23,45,12)
Entries in this field may be restricted based on Account Type.
"^DD",57.23,57.23,45,12.1)
S DIC("S")="I $$SCR^PSNPARM(Y)"
"^DD",57.23,57.23,45,21,0)
^.001^4^4^3170628^^^^
"^DD",57.23,57.23,45,21,1,0)
This field denotes YES or NO if the National Drug File 
"^DD",57.23,57.23,45,21,2,0)
will be updated by the legacy FORUM patch release process
"^DD",57.23,57.23,45,21,3,0)
or the Pharmacy Product System - National 3.0 Update 
"^DD",57.23,57.23,45,21,4,0)
file process.
"^DD",57.23,57.23,45,23,0)
^^5^5^3170628^
"^DD",57.23,57.23,45,23,1,0)
The following selection options will be available to the user based 
"^DD",57.23,57.23,45,23,2,0)
on the PPS-N Account Type field as follows:
"^DD",57.23,57.23,45,23,3,0)
 
"^DD",57.23,57.23,45,23,4,0)
If Account Type is 'Q' or 'N', only the NO option will be available . 
"^DD",57.23,57.23,45,23,5,0)
Otherwise, YES and NO options will be available for selection.
"^DD",57.23,57.23,45,"AUDIT")
y
"^DD",57.23,57.23,45,"DT")
3170628
"^DD",57.23,57.23,50,0)
DOWNLOAD HISTORY^57.234^^4;0
"^DD",57.23,57.23,50,21,0)
^.001^3^3^3170515^^^^
"^DD",57.23,57.23,50,21,1,0)
This multiple field contains the status and download history 
"^DD",57.23,57.23,50,21,2,0)
for the Pharmacy Product System - National (PPS-N)/NDF Update 
"^DD",57.23,57.23,50,21,3,0)
file download process.
"^DD",57.23,57.23,70,0)
REJECT HISTORY^57.236^^6;0
"^DD",57.23,57.23,100,0)
INSTALL HISTORY^57.231^^5;0
"^DD",57.23,57.23,100,21,0)
^.001^3^3^3170222^^^^
"^DD",57.23,57.23,100,21,1,0)
This multiple contains historical information for each
"^DD",57.23,57.23,100,21,2,0)
PPS-N Update file installed for National Drug File (NDF)
"^DD",57.23,57.23,100,21,3,0)
package.
"^DD",57.23,57.23,100,23,0)
^.001^4^4^3170222^^^^
"^DD",57.23,57.23,100,23,1,0)
This multiple is defined when the TaskMan scheduled 
"^DD",57.23,57.23,100,23,2,0)
update of NDF [PSNTUPDT] job runs or the user selects
"^DD",57.23,57.23,100,23,3,0)
to run the Begin update of NDF data from PPS-N 
"^DD",57.23,57.23,100,23,4,0)
[PSNUPDT] option manually.  It should not be edited.
"^DD",57.23,57.231,0)
INSTALL HISTORY SUB-FIELD^^7^9
"^DD",57.23,57.231,0,"DT")
3170217
"^DD",57.23,57.231,0,"IX","B",57.231,.01)

"^DD",57.23,57.231,0,"NM","INSTALL HISTORY")

"^DD",57.23,57.231,0,"UP")
57.23
"^DD",57.23,57.231,.01,0)
UPDATE FILE NAME^MF^^0;1^K:$L(X)>40!($L(X)<1) X
"^DD",57.23,57.231,.01,1,0)
^.1
"^DD",57.23,57.231,.01,1,1,0)
57.231^B
"^DD",57.23,57.231,.01,1,1,1)
S ^PS(57.23,DA(1),5,"B",$E(X,1,30),DA)=""
"^DD",57.23,57.231,.01,1,1,2)
K ^PS(57.23,DA(1),5,"B",$E(X,1,30),DA)
"^DD",57.23,57.231,.01,3)
Enter the Update file name in PPS_0PRV_1NEW.DAT format. 
"^DD",57.23,57.231,.01,21,0)
^.001^2^2^3170217^^^
"^DD",57.23,57.231,.01,21,1,0)
This field contains the file name for the Update
"^DD",57.23,57.231,.01,21,2,0)
file being retrieved or installed.
"^DD",57.23,57.231,.01,"DT")
3170222
"^DD",57.23,57.231,1,0)
INSTALL BEGIN DATE/TIME^D^^0;2^S %DT="ESTX" D ^%DT S X=Y K:Y<1 X
"^DD",57.23,57.231,1,3)
Enter the date and time that the Update file install process began.
"^DD",57.23,57.231,1,21,0)
^^2^2^3170216^
"^DD",57.23,57.231,1,21,1,0)
This field contains the date and time the PPS-N Update installation 
"^DD",57.23,57.231,1,21,2,0)
process began.
"^DD",57.23,57.231,1,"DT")
3170222
"^DD",57.23,57.231,2,0)
INSTALL COMPLETION DATE/TIME^D^^0;3^S %DT="ESTX" D ^%DT S X=Y K:Y<1 X
"^DD",57.23,57.231,2,3)
Enter the date and time that the installation of the Update fil completed.
"^DD",57.23,57.231,2,21,0)
^.001^2^2^3170216^^
"^DD",57.23,57.231,2,21,1,0)
This field contains the date and time that the install process for the 
"^DD",57.23,57.231,2,21,2,0)
PPS-N Update file completed processing.
"^DD",57.23,57.231,2,"DT")
3170216
"^DD",57.23,57.231,3,0)
LAST VISTA FILE PROCESSED^F^^0;4^K:$L(X)>15!($L(X)<1) X
"^DD",57.23,57.231,3,3)
Enter 1-15 characters for the file number for the last VistA file processed during installation.
"^DD",57.23,57.231,3,21,0)
^^2^2^3170217^
"^DD",57.23,57.231,3,21,1,0)
This field is updated during the Update file installation process to
"^DD",57.23,57.231,3,21,2,0)
indicate the last file number processed.
"^DD",57.23,57.231,3,"DT")
3170217
"^DD",57.23,57.231,4,0)
LAST FILE IEN PROCESSED^F^^0;5^K:$L(X)>30!($L(X)<1) X
"^DD",57.23,57.231,4,3)
Enter 1-30 characters for the last file Internal Entry Number (IEN) processed.
"^DD",57.23,57.231,4,21,0)
^^3^3^3170217^
"^DD",57.23,57.231,4,21,1,0)
This field contains the last Internal Entry Number (IEN) for the last
"^DD",57.23,57.231,4,21,2,0)
Vista file processed.  The format of the IEN can be "IEN," for "file IEN"
"^DD",57.23,57.231,4,21,3,0)
or "IEN,IEN" for "file IEN, sub-file IEN".
"^DD",57.23,57.231,4,"DT")
3170217
"^DD",57.23,57.231,5,0)
LAST TMP FILE SUBSCRIPT^F^^0;6^K:$L(X)>40!($L(X)<1) X
"^DD",57.23,57.231,5,3)
Enter 1-40 characters for the last TMP file subscript processed.
"^DD",57.23,57.231,5,21,0)
^^2^2^3170217^
"^DD",57.23,57.231,5,21,1,0)
This field contains the last TMP file subscript used during the install
"^DD",57.23,57.231,5,21,2,0)
process. 
"^DD",57.23,57.231,5,"DT")
3170217
"^DD",57.23,57.231,6,0)
LAST UPDATE FILE SECTION^F^^0;7^K:$L(X)>30!($L(X)<1) X
"^DD",57.23,57.231,6,3)
Enter 1-30 characters for the last Update file section processed.
"^DD",57.23,57.231,6,21,0)
^^2^2^3170217^
"^DD",57.23,57.231,6,21,1,0)
This field is used to track the last Update file section processed during
"^DD",57.23,57.231,6,21,2,0)
the install process.
"^DD",57.23,57.231,6,"DT")
3170217
"^DD",57.23,57.231,7,0)
DISPLAYED LAST^F^^0;8^K:$L(X)>35!($L(X)<1) X
"^DD",57.23,57.231,7,3)
Enter 1-35 characters for the last action displayed to the user.
"^DD",57.23,57.231,7,21,0)
^^2^2^3170217^
"^DD",57.23,57.231,7,21,1,0)
This field contains the last action displayed to the user during the
"^DD",57.23,57.231,7,21,2,0)
install process. 
"^DD",57.23,57.231,7,"DT")
3170217
"^DD",57.23,57.231,30,0)
INSTALL ERRORS^57.233D^^2;0
"^DD",57.23,57.231,30,21,0)
^.001^3^3^3170222^^
"^DD",57.23,57.231,30,21,1,0)
This field contains error information for the Pharmacy Product
"^DD",57.23,57.231,30,21,2,0)
System - National (PPS-N)/National Drug File (NDF) Update file
"^DD",57.23,57.231,30,21,3,0)
installation process.
"^DD",57.23,57.231,30,"DT")
3170216
"^DD",57.23,57.233,0)
INSTALL ERRORS SUB-FIELD^^4^5
"^DD",57.23,57.233,0,"DT")
3150928
"^DD",57.23,57.233,0,"IX","B",57.233,.01)

"^DD",57.23,57.233,0,"NM","INSTALL ERRORS")

"^DD",57.23,57.233,0,"UP")
57.231
"^DD",57.23,57.233,.01,0)
ERROR DATE/TIME^MD^^0;1^S %DT="ESTX" D ^%DT S X=Y K:Y<1 X
"^DD",57.23,57.233,.01,1,0)
^.1
"^DD",57.23,57.233,.01,1,1,0)
57.233^B
"^DD",57.23,57.233,.01,1,1,1)
S ^PS(57.23,DA(2),5,DA(1),2,"B",$E(X,1,30),DA)=""
"^DD",57.23,57.233,.01,1,1,2)
K ^PS(57.23,DA(2),5,DA(1),2,"B",$E(X,1,30),DA)
"^DD",57.23,57.233,.01,3)
Enter the date and time that the error occurred.
"^DD",57.23,57.233,.01,21,0)
^.001^2^2^3150928^^
"^DD",57.23,57.233,.01,21,1,0)
This field contains the date and time that the error
"^DD",57.23,57.233,.01,21,2,0)
occurred.
"^DD",57.23,57.233,.01,"DT")
3150928
"^DD",57.23,57.233,1,0)
FILE^F^^0;2^K:$L(X)>40!($L(X)<1) X
"^DD",57.23,57.233,1,3)
Enter 1-40 characters for the file name being retrieved or the file number being installed.
"^DD",57.23,57.233,1,21,0)
^^7^7^3150928^
"^DD",57.23,57.233,1,21,1,0)
If the error occurs during the file retrieval process,
"^DD",57.23,57.233,1,21,2,0)
this field will contain the file name being retrieved
"^DD",57.23,57.233,1,21,3,0)
(i.e. PPS_PRV34_NEW35.DAT).
"^DD",57.23,57.233,1,21,4,0)
 
"^DD",57.23,57.233,1,21,5,0)
If the error occurs during the Update file installation,
"^DD",57.23,57.233,1,21,6,0)
this field will contain the file number being installed
"^DD",57.23,57.233,1,21,7,0)
(i.e. 50.68, 50.605, etc.).
"^DD",57.23,57.233,1,"DT")
3150928
"^DD",57.23,57.233,2,0)
INTERNAL ENTRY NUMBER^F^^0;3^K:$L(X)>20!($L(X)<1) X
"^DD",57.23,57.233,2,3)
Enter 1-20 characters for the file internal entry number (IEN) when the Update file installation errored.
"^DD",57.23,57.233,2,21,0)
^.001^3^3^3150928^^
"^DD",57.23,57.233,2,21,1,0)
This field contains the Internal Entry Number (IEN)
"^DD",57.23,57.233,2,21,2,0)
for the file when an error occurred during install
"^DD",57.23,57.233,2,21,3,0)
of the PPS-N Update file.
"^DD",57.23,57.233,2,"DT")
3150928
"^DD",57.23,57.233,3,0)
TMP FILE SUBSCRIPT^F^^0;4^K:$L(X)>40!($L(X)<1) X
"^DD",57.23,57.233,3,3)
Answer must be 1-40 characters in length.
"^DD",57.23,57.233,3,21,0)
^^3^3^3150928^
"^DD",57.23,57.233,3,21,1,0)
This field contains the TMP file subscript being 
"^DD",57.23,57.233,3,21,2,0)
processed when the error occurred during the Update
"^DD",57.23,57.233,3,21,3,0)
file installation process.
"^DD",57.23,57.233,3,"DT")
3150928
"^DD",57.23,57.233,4,0)
ERROR MESSAGE^F^^0;5^K:$L(X)>60!($L(X)<1) X
"^DD",57.23,57.233,4,3)
Enter 1-60 characters to describe the type of error. For example: File #5000.507 does not exist.
"^DD",57.23,57.233,4,21,0)
^^8^8^3170222^
"^DD",57.23,57.233,4,21,1,0)
This field contains the Pharmacy Product System - National 
"^DD",57.23,57.233,4,21,2,0)
(PPS-N) Update file install error messages and related
"^DD",57.23,57.233,4,21,3,0)
information.
"^DD",57.23,57.233,4,21,4,0)
 
"^DD",57.23,57.233,4,21,5,0)
Examples:
"^DD",57.23,57.233,4,21,6,0)
File #5000.507 does not exist.
"^DD",57.23,57.233,4,21,7,0)
The entry does not exist.
"^DD",57.23,57.233,4,21,8,0)
File# 50.606 and IEN string 100,326, represent different subfile levels.
"^DD",57.23,57.233,4,"DT")
3150928
"^DD",57.23,57.2331,0)
MENU OPTIONS SUB-FIELD^^.01^1
"^DD",57.23,57.2331,0,"DT")
3151112
"^DD",57.23,57.2331,0,"IX","B",57.2331,.01)

"^DD",57.23,57.2331,0,"NM","MENU OPTIONS")

"^DD",57.23,57.2331,0,"UP")
57.23
"^DD",57.23,57.2331,.01,0)
MENU OPTIONS^MP19^DIC(19,^0;1^Q
"^DD",57.23,57.2331,.01,1,0)
^.1
"^DD",57.23,57.2331,.01,1,1,0)
57.2331^B
"^DD",57.23,57.2331,.01,1,1,1)
S ^PS(57.23,DA(1),3.1,"B",$E(X,1,30),DA)=""
"^DD",57.23,57.2331,.01,1,1,2)
K ^PS(57.23,DA(1),3.1,"B",$E(X,1,30),DA)
"^DD",57.23,57.2331,.01,3)
Enter a Menu option to mark out of order during PPS-N/NDF Update file installation.
"^DD",57.23,57.2331,.01,21,0)
^^3^3^3151112^
"^DD",57.23,57.2331,.01,21,1,0)
This multiple field is used for sites to define 
"^DD",57.23,57.2331,.01,21,2,0)
menu options to be disabled during installation
"^DD",57.23,57.2331,.01,21,3,0)
of PPS-N/NDF Update file(s).
"^DD",57.23,57.2331,.01,"DT")
3151112
"^DD",57.23,57.2332,0)
PROTOCOLS SUB-FIELD^^.01^1
"^DD",57.23,57.2332,0,"DT")
3151112
"^DD",57.23,57.2332,0,"IX","B",57.2332,.01)

"^DD",57.23,57.2332,0,"NM","PROTOCOLS")

"^DD",57.23,57.2332,0,"UP")
57.23
"^DD",57.23,57.2332,.01,0)
PROTOCOLS^MP101^ORD(101,^0;1^Q
"^DD",57.23,57.2332,.01,1,0)
^.1
"^DD",57.23,57.2332,.01,1,1,0)
57.2332^B
"^DD",57.23,57.2332,.01,1,1,1)
S ^PS(57.23,DA(1),3.2,"B",$E(X,1,30),DA)=""
"^DD",57.23,57.2332,.01,1,1,2)
K ^PS(57.23,DA(1),3.2,"B",$E(X,1,30),DA)
"^DD",57.23,57.2332,.01,3)
Enter a protocol to mark out of order during PPS-N/NDF Update file installation.
"^DD",57.23,57.2332,.01,21,0)
^^3^3^3151112^
"^DD",57.23,57.2332,.01,21,1,0)
This multiple field is used for sites to define 
"^DD",57.23,57.2332,.01,21,2,0)
Protocols to be disabled during installation
"^DD",57.23,57.2332,.01,21,3,0)
of PPS-N/NDF Update file(s).
"^DD",57.23,57.2332,.01,"DT")
3151112
"^DD",57.23,57.2333,0)
SFTP PRIVATE KEY TEXT SUB-FIELD^^.01^1
"^DD",57.23,57.2333,0,"DT")
3160112
"^DD",57.23,57.2333,0,"NM","SFTP PRIVATE KEY TEXT")

"^DD",57.23,57.2333,0,"UP")
57.23
"^DD",57.23,57.2333,.01,0)
SFTP PRIVATE KEY TEXT^Wx^^0;1^Q
"^DD",57.23,57.2333,.01,3)
Enter the Secure FTP encrypted private key content to be used to retrieve Pharmacy Product System - National (PPS-N) update files.
"^DD",57.23,57.2333,.01,21,0)
^.001^1^1^3160112^^^^
"^DD",57.23,57.2333,.01,21,1,0)
This is the Secure File Transfer Protocol (sFTP) private key text content.
"^DD",57.23,57.2333,.01,"DT")
3160112
"^DD",57.23,57.2334,0)
SFTP PUBLIC KEY TEXT SUB-FIELD^^.01^1
"^DD",57.23,57.2334,0,"DT")
3160112
"^DD",57.23,57.2334,0,"NM","SFTP PUBLIC KEY TEXT")

"^DD",57.23,57.2334,0,"UP")
57.23
"^DD",57.23,57.2334,.01,0)
SFTP PUBLIC KEY TEXT^Wx^^0;1^Q
"^DD",57.23,57.2334,.01,3)
Enter the Secure FTP encrypted public key text to be used to download Pharmacy Product System - National (PPS-N) update files. 
"^DD",57.23,57.2334,.01,21,0)
^.001^1^1^3160112^^^^
"^DD",57.23,57.2334,.01,21,1,0)
This is the Secure File Transfer Protocol (sFTP) public key text content.
"^DD",57.23,57.2334,.01,"DT")
3160112
"^DD",57.23,57.234,0)
DOWNLOAD HISTORY SUB-FIELD^^4^5
"^DD",57.23,57.234,0,"DT")
3170217
"^DD",57.23,57.234,0,"IX","B",57.234,.01)

"^DD",57.23,57.234,0,"NM","DOWNLOAD HISTORY")

"^DD",57.23,57.234,0,"UP")
57.23
"^DD",57.23,57.234,.01,0)
DOWNLOAD FILE NAME^MF^^0;1^K:$L(X)>40!($L(X)<1) X
"^DD",57.23,57.234,.01,1,0)
^.1
"^DD",57.23,57.234,.01,1,1,0)
57.234^B
"^DD",57.23,57.234,.01,1,1,1)
S ^PS(57.23,DA(1),4,"B",$E(X,1,30),DA)=""
"^DD",57.23,57.234,.01,1,1,2)
K ^PS(57.23,DA(1),4,"B",$E(X,1,30),DA)
"^DD",57.23,57.234,.01,3)
Enter 1-40 characters for the PPS-N update file name (format: PPS_XXXPRV_XXXNEW.DAT).
"^DD",57.23,57.234,.01,21,0)
^.001^2^2^3170222^^
"^DD",57.23,57.234,.01,21,1,0)
This field contains the Pharmacy Product System - National (PPS-N) Update
"^DD",57.23,57.234,.01,21,2,0)
file name in the format of PPS_XXXPRV_XXXNEW.DAT.
"^DD",57.23,57.234,.01,"DT")
3170222
"^DD",57.23,57.234,1,0)
DOWNLOAD BEGIN DATE/TIME^D^^0;2^S %DT="ESTX" D ^%DT S X=Y K:Y<1 X
"^DD",57.23,57.234,1,3)
Enter the date and time the download began.
"^DD",57.23,57.234,1,21,0)
^^2^2^3170215^
"^DD",57.23,57.234,1,21,1,0)
This field contains the date and time that the Pharmacy Product System -
"^DD",57.23,57.234,1,21,2,0)
National (PPS-N) Update file process began.
"^DD",57.23,57.234,1,"DT")
3170222
"^DD",57.23,57.234,2,0)
DOWNLOAD COMPLETE DATE/TIME^D^^0;3^S %DT="ESTX" D ^%DT S X=Y K:Y<1 X
"^DD",57.23,57.234,2,3)
Enter the date and time the PPS-N Update file download completed.
"^DD",57.23,57.234,2,21,0)
^^2^2^3170215^
"^DD",57.23,57.234,2,21,1,0)
This field contains the date and time that the Pharmacy Product
"^DD",57.23,57.234,2,21,2,0)
System - National (PPS-N) Update file process completed.
"^DD",57.23,57.234,2,"DT")
3170215
"^DD",57.23,57.234,3,0)
FILE SIZE^F^^0;4^K:$L(X)>40!($L(X)<1) X
"^DD",57.23,57.234,3,3)
Enter 1-40 characters for the file size for the PPS-N Update file.
"^DD",57.23,57.234,3,21,0)
^^2^2^3170215^
"^DD",57.23,57.234,3,21,1,0)
This field contains the file size of the Pharmacy Product System - 
"^DD",57.23,57.234,3,21,2,0)
National Update file.
"^DD",57.23,57.234,3,"DT")
3170215
"^DD",57.23,57.234,4,0)
DOWNLOAD ERROR MESSAGE^F^^0;5^K:$L(X)>80!($L(X)<1) X
"^DD",57.23,57.234,4,3)
Enter 1-80 characters to describe the error encountered during the PPS-N Update file download process.
"^DD",57.23,57.234,4,21,0)
^^11^11^3170222^
"^DD",57.23,57.234,4,21,1,0)
This field contains error information for the download process
"^DD",57.23,57.234,4,21,2,0)
of the Pharmacy Product System - National PPS-N Update file.  
"^DD",57.23,57.234,4,21,3,0)
If no errors occurred during download, this field will remain 
"^DD",57.23,57.234,4,21,4,0)
blank.
"^DD",57.23,57.234,4,21,5,0)
 
"^DD",57.23,57.234,4,21,6,0)
Examples of errors are:
"^DD",57.23,57.234,4,21,7,0)
  Unable to retrieve update file.
"^DD",57.23,57.234,4,21,8,0)
  Missing or Incomplete data in the Update file.
"^DD",57.23,57.234,4,21,9,0)
  The system was unable to read or create a national report.
"^DD",57.23,57.234,4,21,10,0)
  The system was unable to create local reports.
"^DD",57.23,57.234,4,21,11,0)
  Unknown Error.
"^DD",57.23,57.234,4,"DT")
3170222
"^DD",57.23,57.236,0)
REJECT HISTORY SUB-FIELD^^2^3
"^DD",57.23,57.236,0,"DT")
3170522
"^DD",57.23,57.236,0,"IX","B",57.236,.01)

"^DD",57.23,57.236,0,"NM","REJECT HISTORY")

"^DD",57.23,57.236,0,"UP")
57.23
"^DD",57.23,57.236,.01,0)
REJECT FILE NAME^MF^^0;1^K:$L(X)>40!($L(X)<1) X
"^DD",57.23,57.236,.01,1,0)
^.1
"^DD",57.23,57.236,.01,1,1,0)
57.236^B
"^DD",57.23,57.236,.01,1,1,1)
S ^PS(57.23,DA(1),6,"B",$E(X,1,30),DA)=""
"^DD",57.23,57.236,.01,1,1,2)
K ^PS(57.23,DA(1),6,"B",$E(X,1,30),DA)
"^DD",57.23,57.236,.01,3)
Enter 1-40 characters for the PPS-N update file name (format: PPS_XXXPRV_XXXNEW.DAT).
"^DD",57.23,57.236,.01,21,0)
^^2^2^3170515^
"^DD",57.23,57.236,.01,21,1,0)
This field contains the Pharmacy Product System - National (PPS-N) 
"^DD",57.23,57.236,.01,21,2,0)
Update file name in the format of PPS_XXXPRV_XXXNEW.DAT.
"^DD",57.23,57.236,.01,"DT")
3170515
"^DD",57.23,57.236,1,0)
REJECT BEGIN DATE/TIME^DX^^0;2^S %DT="ESTX" D ^%DT S X=Y K:X<1 X
"^DD",57.23,57.236,1,3)
Enter the date and time the reject began.
"^DD",57.23,57.236,1,21,0)
^^3^3^3170515^
"^DD",57.23,57.236,1,21,1,0)
Enter the date and time the download began. This field contains the 
"^DD",57.23,57.236,1,21,2,0)
date and time that the Pharmacy Product System - National (PPS-N) 
"^DD",57.23,57.236,1,21,3,0)
Update file process began.
"^DD",57.23,57.236,1,"DT")
3170515
"^DD",57.23,57.236,2,0)
REJECTED BY^P200'^VA(200,^0;3^Q
"^DD",57.23,57.236,2,.1)

"^DD",57.23,57.236,2,3)
This is the name of the person who previously rejected the data file.
"^DD",57.23,57.236,2,21,0)
^^3^3^3170515^
"^DD",57.23,57.236,2,21,1,0)
REJECT COMPLETE DATE/TIME This field contains the date and time that
"^DD",57.23,57.236,2,21,2,0)
the Pharmacy Product System - National (PPS-N) Update file process
"^DD",57.23,57.236,2,21,3,0)
completed.
"^DD",57.23,57.236,2,"DT")
3170522
"^DD",57.23,57.24,0)
SCHEDULED OPTION SUB-FIELD^^.01^1
"^DD",57.23,57.24,0,"DT")
3151112
"^DD",57.23,57.24,0,"IX","B",57.24,.01)

"^DD",57.23,57.24,0,"NM","SCHEDULED OPTION")

"^DD",57.23,57.24,0,"UP")
57.23
"^DD",57.23,57.24,.01,0)
SCHEDULE OPTIONS^MP19.2^DIC(19.2,^0;1^Q
"^DD",57.23,57.24,.01,1,0)
^.1
"^DD",57.23,57.24,.01,1,1,0)
57.24^B
"^DD",57.23,57.24,.01,1,1,1)
S ^PS(57.23,DA(1),3,"B",$E(X,1,30),DA)=""
"^DD",57.23,57.24,.01,1,1,2)
K ^PS(57.23,DA(1),3,"B",$E(X,1,30),DA)
"^DD",57.23,57.24,.01,3)
Enter a Scheduled option to mark out of order during PPS-N/NDF Update file installation.
"^DD",57.23,57.24,.01,21,0)
^^3^3^3151112^
"^DD",57.23,57.24,.01,21,1,0)
This multiple field is used for sites to define
"^DD",57.23,57.24,.01,21,2,0)
scheduled options to be disabled during installation
"^DD",57.23,57.24,.01,21,3,0)
of PPS-N/NDF Update file(s).
"^DD",57.23,57.24,.01,"DT")
3151112
"^DD",59.7,59.7,17,0)
PPS-N ACCOUNT TYPE^RS^P:PRODUCTION;Q:NATIONAL TEST SQA;S:PRODUCT SUPPORT;T:TEST ACCOUNT;N:QA NDFMS;^10;12^Q
"^DD",59.7,59.7,17,.1)
PPS-N Account Type
"^DD",59.7,59.7,17,3)
Only the National Test SQA team should select "Q" for SQA or "N" for QA NDFMS. All others, enter "P" for PRODUCTION, "S" for PRODUCT SUPPORT, or "T" for TEST/MIRROR ACCOUNT.  
"^DD",59.7,59.7,17,21,0)
^^8^8^3170222^
"^DD",59.7,59.7,17,21,1,0)
This field defines the type of Pharmacy Product System - 
"^DD",59.7,59.7,17,21,2,0)
National (PPS-N) account.  The account type can be one of
"^DD",59.7,59.7,17,21,3,0)
the following: "Q" for National Test SQA system, "T" for
"^DD",59.7,59.7,17,21,4,0)
Test/Mirror Account, "S" for Product Support, "N" for
"^DD",59.7,59.7,17,21,5,0)
QA NDFMS account, or "P" for Production account.
"^DD",59.7,59.7,17,21,6,0)
 
"^DD",59.7,59.7,17,21,7,0)
Local VA sites will use "P" for their production accounts
"^DD",59.7,59.7,17,21,8,0)
and "T" for their test/mirror accounts.
"^DD",59.7,59.7,17,23,0)
^.001^15^15^3170222^^^
"^DD",59.7,59.7,17,23,1,0)
The PPS-N/NDF National SQA Test Team are the only
"^DD",59.7,59.7,17,23,2,0)
users who should defined this field as "Q" for 
"^DD",59.7,59.7,17,23,3,0)
National SQA or "N" for QA NDFMS.
"^DD",59.7,59.7,17,23,4,0)
 
"^DD",59.7,59.7,17,23,5,0)
Defining the account type as "Q" or "N" flags the system 
"^DD",59.7,59.7,17,23,6,0)
that the account should define the full complement of 5000 
"^DD",59.7,59.7,17,23,7,0)
range of files utilized during the installation process and
"^DD",59.7,59.7,17,23,8,0)
for KIDS build generation.
"^DD",59.7,59.7,17,23,9,0)
 
"^DD",59.7,59.7,17,23,10,0)
Also the "Q" and "P" account types flag the system to send
"^DD",59.7,59.7,17,23,11,0)
install status information to PPS-N via the HWSC Web Service 
"^DD",59.7,59.7,17,23,12,0)
Manager "PPSN" Web Server and the UPDATE_STATUS web service 
"^DD",59.7,59.7,17,23,13,0)
manager.  For local site production accounts, the compliance
"^DD",59.7,59.7,17,23,14,0)
report in PPS-N is updated upon completion of PPS-N/NDF Update
"^DD",59.7,59.7,17,23,15,0)
file installation.
"^DD",59.7,59.7,17,"DT")
3170222
"^DIC",57.23,57.23,0)
PPS-N UPDATE CONTROL^57.23
"^DIC",57.23,57.23,0,"GL")
^PS(57.23,
"^DIC",57.23,57.23,"%",0)
^1.005^^0
"^DIC",57.23,57.23,"%D",0)
^^3^3^3150928^
"^DIC",57.23,57.23,"%D",1,0)
This file contains configuration and installation information for the 
"^DIC",57.23,57.23,"%D",2,0)
Pharmacy Product System - National (PPS-N) file retrieval and 
"^DIC",57.23,57.23,"%D",3,0)
installation process.
"^DIC",57.23,"B","PPS-N UPDATE CONTROL",57.23)

"BLD",9663,6)
^531
**END**
**END**

