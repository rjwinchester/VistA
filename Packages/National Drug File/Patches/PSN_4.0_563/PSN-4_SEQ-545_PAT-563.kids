Released PSN*4*563 SEQ #545
Extracted from mail message
**KIDS**:PSN*4.0*563^

**INSTALL NAME**
PSN*4.0*563
"BLD",9716,0)
PSN*4.0*563^NATIONAL DRUG FILE^0^3180417^y
"BLD",9716,1,0)
^^2^2^3180417^^
"BLD",9716,1,1,0)
The description of this build can be found in the National Patch Module 
"BLD",9716,1,2,0)
under PSN*4*563.
"BLD",9716,4,0)
^9.64PA^57.23^1
"BLD",9716,4,57.23,0)
57.23
"BLD",9716,4,57.23,2,0)
^9.641^57.23^1
"BLD",9716,4,57.23,2,57.23,0)
PPS-N UPDATE CONTROL  (File-top level)
"BLD",9716,4,57.23,2,57.23,1,0)
^9.6411^6^2
"BLD",9716,4,57.23,2,57.23,1,5,0)
PRIMARY PPS-N MAIL GROUP
"BLD",9716,4,57.23,2,57.23,1,6,0)
SECONDARY MAIL GROUP
"BLD",9716,4,57.23,222)
y^n^p^^^^n^^n
"BLD",9716,4,57.23,224)

"BLD",9716,4,"APDD",57.23,57.23)

"BLD",9716,4,"APDD",57.23,57.23,5)

"BLD",9716,4,"APDD",57.23,57.23,6)

"BLD",9716,4,"B",57.23,57.23)

"BLD",9716,6.3)
5
"BLD",9716,"KRN",0)
^9.67PA^779.2^20
"BLD",9716,"KRN",.4,0)
.4
"BLD",9716,"KRN",.401,0)
.401
"BLD",9716,"KRN",.402,0)
.402
"BLD",9716,"KRN",.403,0)
.403
"BLD",9716,"KRN",.5,0)
.5
"BLD",9716,"KRN",.84,0)
.84
"BLD",9716,"KRN",3.6,0)
3.6
"BLD",9716,"KRN",3.8,0)
3.8
"BLD",9716,"KRN",9.2,0)
9.2
"BLD",9716,"KRN",9.8,0)
9.8
"BLD",9716,"KRN",9.8,"NM",0)
^9.68A^6^6
"BLD",9716,"KRN",9.8,"NM",1,0)
PSNOSKEY^^0^B85806980
"BLD",9716,"KRN",9.8,"NM",2,0)
PSNPPSNC^^0^B14208219
"BLD",9716,"KRN",9.8,"NM",3,0)
PSNPPSDL^^0^B31742401
"BLD",9716,"KRN",9.8,"NM",4,0)
PSNPPSNV^^0^B182428423
"BLD",9716,"KRN",9.8,"NM",5,0)
PSNPPSNW^^0^B35107109
"BLD",9716,"KRN",9.8,"NM",6,0)
PSNPPSNU^^0^B50930121
"BLD",9716,"KRN",9.8,"NM","B","PSNOSKEY",1)

"BLD",9716,"KRN",9.8,"NM","B","PSNPPSDL",3)

"BLD",9716,"KRN",9.8,"NM","B","PSNPPSNC",2)

"BLD",9716,"KRN",9.8,"NM","B","PSNPPSNU",6)

"BLD",9716,"KRN",9.8,"NM","B","PSNPPSNV",4)

"BLD",9716,"KRN",9.8,"NM","B","PSNPPSNW",5)

"BLD",9716,"KRN",19,0)
19
"BLD",9716,"KRN",19.1,0)
19.1
"BLD",9716,"KRN",101,0)
101
"BLD",9716,"KRN",409.61,0)
409.61
"BLD",9716,"KRN",771,0)
771
"BLD",9716,"KRN",779.2,0)
779.2
"BLD",9716,"KRN",870,0)
870
"BLD",9716,"KRN",8989.51,0)
8989.51
"BLD",9716,"KRN",8989.52,0)
8989.52
"BLD",9716,"KRN",8994,0)
8994
"BLD",9716,"KRN","B",.4,.4)

"BLD",9716,"KRN","B",.401,.401)

"BLD",9716,"KRN","B",.402,.402)

"BLD",9716,"KRN","B",.403,.403)

"BLD",9716,"KRN","B",.5,.5)

"BLD",9716,"KRN","B",.84,.84)

"BLD",9716,"KRN","B",3.6,3.6)

"BLD",9716,"KRN","B",3.8,3.8)

"BLD",9716,"KRN","B",9.2,9.2)

"BLD",9716,"KRN","B",9.8,9.8)

"BLD",9716,"KRN","B",19,19)

"BLD",9716,"KRN","B",19.1,19.1)

"BLD",9716,"KRN","B",101,101)

"BLD",9716,"KRN","B",409.61,409.61)

"BLD",9716,"KRN","B",771,771)

"BLD",9716,"KRN","B",779.2,779.2)

"BLD",9716,"KRN","B",870,870)

"BLD",9716,"KRN","B",8989.51,8989.51)

"BLD",9716,"KRN","B",8989.52,8989.52)

"BLD",9716,"KRN","B",8994,8994)

"BLD",9716,"QUES",0)
^9.62^^
"BLD",9716,"REQB",0)
^9.611^1^1
"BLD",9716,"REQB",1,0)
PSN*4.0*513^1
"BLD",9716,"REQB","B","PSN*4.0*513",1)

"FIA",57.23)
PPS-N UPDATE CONTROL
"FIA",57.23,0)
^PS(57.23,
"FIA",57.23,0,0)
57.23
"FIA",57.23,0,1)
y^n^p^^^^n^^n
"FIA",57.23,0,10)

"FIA",57.23,0,11)

"FIA",57.23,0,"RLRO")

"FIA",57.23,0,"VR")
4.0^PSN
"FIA",57.23,57.23)
1
"FIA",57.23,57.23,5)

"FIA",57.23,57.23,6)

"MBREQ")
0
"PKG",136,-1)
1^1
"PKG",136,0)
NATIONAL DRUG FILE^PSN^This is the National Drug File Package V 3.14
"PKG",136,20,0)
^9.402P^^
"PKG",136,22,0)
^9.49I^1^1
"PKG",136,22,1,0)
4.0^2981030^2981223^11595
"PKG",136,22,1,"PAH",1,0)
563^3180417
"PKG",136,22,1,"PAH",1,1,0)
^^2^2^3180417
"PKG",136,22,1,"PAH",1,1,1,0)
The description of this build can be found in the National Patch Module 
"PKG",136,22,1,"PAH",1,1,2,0)
under PSN*4*563.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","PSNOSKEY")
0^1^B85806980^B85865292
"RTN","PSNOSKEY",1,0)
PSNOSKEY ;BIR/SJA-PPS-N SSH Key Management ;09/16/2016
"RTN","PSNOSKEY",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513,563**; 30 Oct 98;Build 5
"RTN","PSNOSKEY",3,0)
 ;
"RTN","PSNOSKEY",4,0)
 ; taken mostly from: PSOSPMKY - State Prescription Monitoring Program - SSH Key Management
"RTN","PSNOSKEY",5,0)
 ;
"RTN","PSNOSKEY",6,0)
EN ; -- Entry point
"RTN","PSNOSKEY",7,0)
 N X,Y,PSNOS,LOCALDIR,X1,DIR
"RTN","PSNOSKEY",8,0)
 ;
"RTN","PSNOSKEY",9,0)
ACTION ; -- SSH Key Action
"RTN","PSNOSKEY",10,0)
 K DIR S DIR("A")="Action"
"RTN","PSNOSKEY",11,0)
 S DIR(0)="S^V:View Public SSH Key;C:Create New SSH Key Pair;D:Delete SSH Key Pair;H:Help with SSH Keys",DIR("B")="V"
"RTN","PSNOSKEY",12,0)
 D ^DIR
"RTN","PSNOSKEY",13,0)
 I $D(DUOUT)!($D(DIRUT)) G END
"RTN","PSNOSKEY",14,0)
 I Y="C"!(Y="D"),'$D(^XUSEC("PSN PPS COORD",DUZ)) D  G ACTION
"RTN","PSNOSKEY",15,0)
 .W !!,"The PSN PPS COORD security key is required for this action.",$C(7)
"RTN","PSNOSKEY",16,0)
 K ^TMP("PSNPUBKY",$J) D RETRIEVE("PUB")
"RTN","PSNOSKEY",17,0)
 I Y="V"!(Y="D"),'$D(^TMP("PSNPUBKY",$J)) D  G ACTION
"RTN","PSNOSKEY",18,0)
 .W !!,"[No SSH Key Pair found]",$C(7) D PAUSE
"RTN","PSNOSKEY",19,0)
 I Y="C"!(Y="D") D SIG^XUSESIG I X="^"!($G(X1)="") W:$G(X1)="" " SIGNATURE NOT VERIFIED",$C(7) G ACTION
"RTN","PSNOSKEY",20,0)
 ; 
"RTN","PSNOSKEY",21,0)
 ; -- View Public SSH Key
"RTN","PSNOSKEY",22,0)
 I Y="V" W ! D VIEW,PAUSE G ACTION
"RTN","PSNOSKEY",23,0)
 ;
"RTN","PSNOSKEY",24,0)
 ; -- Create New SSH Key Pair
"RTN","PSNOSKEY",25,0)
 I Y="C" D  G ACTION
"RTN","PSNOSKEY",26,0)
 .I '$$ASK() W !!,"No action taken!",$C(7) Q
"RTN","PSNOSKEY",27,0)
 .S PSNOS=$$ENDOS()
"RTN","PSNOSKEY",28,0)
 .S LOCALDIR=$$GET1^DIQ(57.23,1,$S(PSNOS["VMS":1,1:3))
"RTN","PSNOSKEY",29,0)
 .I LOCALDIR="" D  Q
"RTN","PSNOSKEY",30,0)
 ..W !!,"The ",$S(PSNOS["VMS":"OPEN VMS",1:"UNIX/LINUX")," LOCAL DIRECTORY parameter is missing. Please, update it in"
"RTN","PSNOSKEY",31,0)
 ..W !,"the 'PPS-N Site Parameters (Enter/Edit)' option and try again.",$C(7) D PAUSE
"RTN","PSNOSKEY",32,0)
 .K DIR S DIR("A")="SSH Key Encryption Type",DIR("?")="^D HELP1^PSNOSKEY"
"RTN","PSNOSKEY",33,0)
 .S DIR(0)="S^RSA:Rivest, Shamir & Adleman (RSA);DSA:Digital Signature Algorithm (DSA)"
"RTN","PSNOSKEY",34,0)
 .S DIR("B")="RSA" D ^DIR I $D(DUOUT)!($D(DIRUT)) Q
"RTN","PSNOSKEY",35,0)
 .S ENCRTYPE=Y
"RTN","PSNOSKEY",36,0)
 .I $D(^TMP("PSNPUBKY",$J)) D
"RTN","PSNOSKEY",37,0)
 ..W !!,$G(IOBON),"WARNING:",$G(IOBOFF)," You may be overwriting SSH Keys that are currently in use.",$C(7)
"RTN","PSNOSKEY",38,0)
 .K DIR S DIR("A")="Confirm Creation of SSH Keys",DIR(0)="Y",DIR("B")="NO"
"RTN","PSNOSKEY",39,0)
 .W ! D ^DIR I $D(DIRUT)!$D(DUOUT)!'Y Q
"RTN","PSNOSKEY",40,0)
 .;
"RTN","PSNOSKEY",41,0)
 .; -- Deleting Existing SSH Key
"RTN","PSNOSKEY",42,0)
 .I $D(^TMP("PSNPUBKY",$J)) D DELETE
"RTN","PSNOSKEY",43,0)
 .W !!,"Creating New SSH Keys, please wait..."
"RTN","PSNOSKEY",44,0)
 .N ZTRTN,ZTIO,ZTDESC,ZTDTH,ZTSK
"RTN","PSNOSKEY",45,0)
 .S ZTRTN="NEWKEY^PSNOSKEY("""_ENCRTYPE_""")",ZTIO="",ZTDESC="SSH Key Generation",ZTDTH=$$NOW^XLFDT()
"RTN","PSNOSKEY",46,0)
 .D ^%ZTLOAD K ZTSK,^TMP("PSNPUBKY",$J)
"RTN","PSNOSKEY",47,0)
 .F I=1:1:30 D RETRIEVE("PUB") Q:$D(^TMP("PSNPUBKY",$J))  H 1
"RTN","PSNOSKEY",48,0)
 .; -- If unable to create the key via Taskman after 30 seconds, creates them in the foreground
"RTN","PSNOSKEY",49,0)
 .I '$D(^TMP("PSNPUBKY",$J)) D
"RTN","PSNOSKEY",50,0)
 ..D NEWKEY(ENCRTYPE),RETRIEVE("PUB")
"RTN","PSNOSKEY",51,0)
 .I '$D(^TMP("PSNPUBKY",$J)) D
"RTN","PSNOSKEY",52,0)
 ..W !!,"There was a problem with the generation of the new SSH Key Pair."
"RTN","PSNOSKEY",53,0)
 ..W !,"Please try again and if the problem persists contact IT Support.",$C(7) D PAUSE
"RTN","PSNOSKEY",54,0)
 .E  W "Done",$C(7)
"RTN","PSNOSKEY",55,0)
 ;
"RTN","PSNOSKEY",56,0)
 ; -- Delete SSH Key Pair
"RTN","PSNOSKEY",57,0)
 I Y="D" D  G ACTION
"RTN","PSNOSKEY",58,0)
 .D RETRIEVE("PUB")
"RTN","PSNOSKEY",59,0)
 .I '$D(^TMP("PSNPUBKY",$J)) W !!,"[No SSH Key Pair found]",$C(7) Q
"RTN","PSNOSKEY",60,0)
 .W !!,$G(IOBON),"WARNING:",$G(IOBOFF)," You may be deleting SSH Keys that are currently in use.",$C(7)
"RTN","PSNOSKEY",61,0)
 .K DIR S DIR("A")="Confirm Deletion of SSH Keys",DIR(0)="Y",DIR("B")="NO"
"RTN","PSNOSKEY",62,0)
 .W ! D ^DIR I $D(DIRUT)!$D(DUOUT)!'Y Q
"RTN","PSNOSKEY",63,0)
 .W !!,"Deleting SSH Keys..." D DELETE H 1 W "Done",$C(7)
"RTN","PSNOSKEY",64,0)
 ; SSH Key Help
"RTN","PSNOSKEY",65,0)
 I Y="H" D HELP G ACTION
"RTN","PSNOSKEY",66,0)
 G ACTION
"RTN","PSNOSKEY",67,0)
 ;
"RTN","PSNOSKEY",68,0)
END ;
"RTN","PSNOSKEY",69,0)
 Q
"RTN","PSNOSKEY",70,0)
 ;
"RTN","PSNOSKEY",71,0)
NEWKEY(ENCRTYPE) ; Generate and store a pair of SSH keys
"RTN","PSNOSKEY",72,0)
 ; Input:  (o) ENCRTYPE - SSH Encryption Type (DSA/RSA) (Default: DSA)
"RTN","PSNOSKEY",73,0)
 ;
"RTN","PSNOSKEY",74,0)
 N LOCALDIR,DTE,PSNOS,KEYFILE,PV,FILE2DEL,LN,OVFLN,PSNSPC,KYTXT,SAVEKEY,DIE,DR,DA
"RTN","PSNOSKEY",75,0)
 S PSNOS=$$OS^%ZOSV()
"RTN","PSNOSKEY",76,0)
 S LOCALDIR=$$GET1^DIQ(57.23,1,$S(PSNOS["VMS":1,1:3)) I LOCALDIR="" Q  ;Error: Missing directory
"RTN","PSNOSKEY",77,0)
 I $G(ENCRTYPE)'="RSA" S ENCRTYPE="DSA"
"RTN","PSNOSKEY",78,0)
 ; -- LOCK to avoid OS files overwrite
"RTN","PSNOSKEY",79,0)
 F  S DTE=+$$FMTHL7^XLFDT($$HTFM^XLFDT($H)) S KEYFILE="KY"_DTE L +@KEYFILE:0 Q:$T  H 2
"RTN","PSNOSKEY",80,0)
 ; -- Deleting existing SSH Keys first
"RTN","PSNOSKEY",81,0)
 D DELETE
"RTN","PSNOSKEY",82,0)
 ;
"RTN","PSNOSKEY",83,0)
 ; -- OpenVMS SSH Key Generation
"RTN","PSNOSKEY",84,0)
 I PSNOS["VMS" D
"RTN","PSNOSKEY",85,0)
 .N COMFILE S COMFILE="COM"_DTE_".COM"
"RTN","PSNOSKEY",86,0)
 .D OPEN^%ZISH("COMFILE",LOCALDIR,COMFILE,"W")
"RTN","PSNOSKEY",87,0)
 .D USE^%ZISUTL("COMFILE")
"RTN","PSNOSKEY",88,0)
 .W "SSH_KEYGEN == ""$SYS$SYSTEM:TCPIP$SSH_SSH-KEYGEN2.EXE""",!
"RTN","PSNOSKEY",89,0)
 .W "SSH_KEYGEN -t "_$$LOW^XLFSTR($G(ENCRTYPE))_" -""P"" "_LOCALDIR_KEYFILE,!
"RTN","PSNOSKEY",90,0)
 .D CLOSE^%ZISH("COMFILE")
"RTN","PSNOSKEY",91,0)
 .X "S PV=$ZF(-1,""@"_LOCALDIR_COMFILE_""")"
"RTN","PSNOSKEY",92,0)
 .S FILE2DEL(COMFILE)="",FILE2DEL(KEYFILE_".")="",FILE2DEL(KEYFILE_".PUB")=""
"RTN","PSNOSKEY",93,0)
 ;
"RTN","PSNOSKEY",94,0)
 ; -- Linux/Unix SSH Key Generation
"RTN","PSNOSKEY",95,0)
 I PSNOS["UNIX" D
"RTN","PSNOSKEY",96,0)
 .I '$$DIREXIST^PSNFTP2(LOCALDIR) D MAKEDIR^PSNFTP2(LOCALDIR)
"RTN","PSNOSKEY",97,0)
 .X "S PV=$ZF(-1,""ssh-keygen -q -N '' -C '' -t "_$$LOW^XLFSTR($G(ENCRTYPE))_" -f "_LOCALDIR_KEYFILE_""")"
"RTN","PSNOSKEY",98,0)
 .S FILE2DEL(KEYFILE)="",FILE2DEL(KEYFILE_".pub")=""
"RTN","PSNOSKEY",99,0)
 ;
"RTN","PSNOSKEY",100,0)
 K ^TMP("PSNPRVKY",$J),^TMP("PSNPUBKY",$J)
"RTN","PSNOSKEY",101,0)
 ; -- Retrieving SSH Private Key Content
"RTN","PSNOSKEY",102,0)
 S X=$$FTG^%ZISH(LOCALDIR,KEYFILE_$S(PSNOS["VMS":".",1:""),$NAME(^TMP("PSNPRVKY",$J,1)),3)
"RTN","PSNOSKEY",103,0)
 I '$D(^TMP("PSNPRVKY",$J,1)) Q
"RTN","PSNOSKEY",104,0)
 ; -- Retrieving SSH Public Key Content
"RTN","PSNOSKEY",105,0)
 S X=$$FTG^%ZISH(LOCALDIR,KEYFILE_$S(PSNOS["VMS":".PUB",1:".pub"),$NAME(^TMP("PSNPUBKY",$J,1)),3)
"RTN","PSNOSKEY",106,0)
 I '$D(^TMP("PSNPUBKY",$J,1)) Q
"RTN","PSNOSKEY",107,0)
 ;
"RTN","PSNOSKEY",108,0)
 ; -- Deleting temporary files used to generate the keys
"RTN","PSNOSKEY",109,0)
 D DEL^%ZISH(LOCALDIR,"FILE2DEL")
"RTN","PSNOSKEY",110,0)
 ;
"RTN","PSNOSKEY",111,0)
 ; -- Saving new SSH Keys content in the PPS-N UPDATE CONTROL file (#57.23)
"RTN","PSNOSKEY",112,0)
 F PSNSPC="PSNPRVKY","PSNPUBKY" D
"RTN","PSNOSKEY",113,0)
 .K KYTXT,SAVEKEY
"RTN","PSNOSKEY",114,0)
 .F LN=1:1 Q:'$D(^TMP(PSNSPC,$J,LN))  D
"RTN","PSNOSKEY",115,0)
 ..; Unix/Linux Public SSH Key has no line-feed
"RTN","PSNOSKEY",116,0)
 ..I PSNOS["UNIX",PSNSPC="PSNPUBKY" D  Q
"RTN","PSNOSKEY",117,0)
 ...S KYTXT(1)=^TMP(PSNSPC,$J,LN) F OVFLN=1:1 Q:'$D(^TMP(PSNSPC,$J,LN,"OVF",OVFLN))  D
"RTN","PSNOSKEY",118,0)
 ....S KYTXT(1)=$G(KYTXT(1))_^TMP(PSNSPC,$J,LN,"OVF",OVFLN)
"RTN","PSNOSKEY",119,0)
 ..S KYTXT(LN)=$$ENCRYP^XUSRB1(^TMP(PSNSPC,$J,LN))
"RTN","PSNOSKEY",120,0)
 .I PSNOS["UNIX",PSNSPC="PSNPUBKY" S KYTXT(1)=$$ENCRYP^XUSRB1(KYTXT(1))
"RTN","PSNOSKEY",121,0)
 .S SAVEKEY(57.23,"1,",$S(PSNSPC="PSNPRVKY":33,1:34))="KYTXT"
"RTN","PSNOSKEY",122,0)
 .D UPDATE^DIE("","SAVEKEY")
"RTN","PSNOSKEY",123,0)
 .K ^TMP(PSNSPC,$J)
"RTN","PSNOSKEY",124,0)
 ;
"RTN","PSNOSKEY",125,0)
 ; -- Saving SSH Key Format (SSH2/OpenSSH) and Encryption Type (DSA/RSA) fields
"RTN","PSNOSKEY",126,0)
 K DIE S DIE="^PS(57.23,",DA=1
"RTN","PSNOSKEY",127,0)
 S DR="39///"_$S(PSNOS["VMS":"SSH2",1:"OSSH")_";41///"_ENCRTYPE D ^DIE
"RTN","PSNOSKEY",128,0)
 L -@KEYFILE
"RTN","PSNOSKEY",129,0)
 Q
"RTN","PSNOSKEY",130,0)
 ;
"RTN","PSNOSKEY",131,0)
RETRIEVE(KTYPE) ; Retrieve the SSH Key into the ^TMP global
"RTN","PSNOSKEY",132,0)
 ;        (o) KTYPE  - SSH Key Type (PUB - Public/PRV - PRivate) (Default: Public)
"RTN","PSNOSKEY",133,0)
 ;Output: ^TMP("PSN[PUB/PRV]KY",$J,0)="SSH Key Format (SSH2/OpenSSH)^Encryption Type (DSA/RSA)"
"RTN","PSNOSKEY",134,0)
 ;        ^TMP("PSN[PUB/PRV]KY",$J,1-N)=[SSH Key Content]
"RTN","PSNOSKEY",135,0)
 ;
"RTN","PSNOSKEY",136,0)
 N X,LN,KYTXT,PSNSPC
"RTN","PSNOSKEY",137,0)
 I $G(KTYPE)'="PRV" S KTYPE="PUB"
"RTN","PSNOSKEY",138,0)
 S X=$$GET1^DIQ(57.23,"1,",$S(KTYPE="PRV":33,1:34),,"KYTXT")
"RTN","PSNOSKEY",139,0)
 S PSNSPC=$S(KTYPE="PRV":"PSNPRVKY",1:"PSNPUBKY")
"RTN","PSNOSKEY",140,0)
 K ^TMP(PSNSPC,$J)
"RTN","PSNOSKEY",141,0)
 F LN=1:1 Q:'$D(KYTXT(LN))  S ^TMP(PSNSPC,$J,LN)=$$DECRYP^XUSRB1(KYTXT(LN))
"RTN","PSNOSKEY",142,0)
 I $D(^TMP(PSNSPC,$J)) D
"RTN","PSNOSKEY",143,0)
 .S ^TMP(PSNSPC,$J,0)=$$GET1^DIQ(57.23,1,39,"I")_"^"_$$GET1^DIQ(57.23,1,41,"I")
"RTN","PSNOSKEY",144,0)
 Q
"RTN","PSNOSKEY",145,0)
 ;
"RTN","PSNOSKEY",146,0)
VIEW ; Displays the SSH Public Key
"RTN","PSNOSKEY",147,0)
 ;       ^TMP("PSNPUBKY",$J,0)="SSH Key Format (SSH2/OpenSSH)^Encryption Type (DSA/RSA)"
"RTN","PSNOSKEY",148,0)
 ;       ^TMP("PSNPUBKY",$J,1-N)=[SSH Key Content]
"RTN","PSNOSKEY",149,0)
 N SSHKEY,DASHLN
"RTN","PSNOSKEY",150,0)
 S $P(DASHLN,"-",81)="",SSHKEY=$$OPENSSH()
"RTN","PSNOSKEY",151,0)
 W !,"Public SSH Key (",$P($G(^TMP("PSNPUBKY",$J,0)),"^",2),") content (does not include dash lines):"
"RTN","PSNOSKEY",152,0)
 W !,DASHLN
"RTN","PSNOSKEY",153,0)
 F  Q:$L(SSHKEY)=0  W !,$E(SSHKEY,1,80) S SSHKEY=$E(SSHKEY,81,9999)
"RTN","PSNOSKEY",154,0)
 W !,DASHLN
"RTN","PSNOSKEY",155,0)
 Q
"RTN","PSNOSKEY",156,0)
 ;
"RTN","PSNOSKEY",157,0)
DELETE ; Delete Both SSH Keys associated
"RTN","PSNOSKEY",158,0)
 N DIE,DA,DR
"RTN","PSNOSKEY",159,0)
 S DIE="^PS(57.23,",DA=1,DR="39///@;41///@;33///@;34///@" D ^DIE
"RTN","PSNOSKEY",160,0)
 K ^TMP("PSNPRVKY",$J),^TMP("PSNPUBKY",$J)
"RTN","PSNOSKEY",161,0)
 Q
"RTN","PSNOSKEY",162,0)
 ;
"RTN","PSNOSKEY",163,0)
OPENSSH() ; Returns the SSH Public Key in OpenSSH Format (Converts if necessary)
"RTN","PSNOSKEY",164,0)
 ;Input: ^TMP("PSNPUBKY",$J,0)="SSH Key Format (SSH2/OpenSSH)^Encryption Type (DSA/RSA)"
"RTN","PSNOSKEY",165,0)
 ;       ^TMP("PSNPUBKY",$J,1-N)=[SSH Key Content]
"RTN","PSNOSKEY",166,0)
 ;
"RTN","PSNOSKEY",167,0)
 N OPENSSH,ENCRTYPE,LN
"RTN","PSNOSKEY",168,0)
 S OPENSSH=""
"RTN","PSNOSKEY",169,0)
 I $P($G(^TMP("PSNPUBKY",$J,0)),"^")="SSH2" D
"RTN","PSNOSKEY",170,0)
 .S ENCRTYPE=$P($G(^TMP("PSNPUBKY",$J,0)),"^",2),OPENSSH=""
"RTN","PSNOSKEY",171,0)
 .F LN=5:1 Q:'$D(^TMP("PSNPUBKY",$J,LN))  D
"RTN","PSNOSKEY",172,0)
 ..I $G(^TMP("PSNPUBKY",$J,LN))["---- END" Q
"RTN","PSNOSKEY",173,0)
 ..S OPENSSH=OPENSSH_$G(^TMP("PSNPUBKY",$J,LN))
"RTN","PSNOSKEY",174,0)
 .S OPENSSH=$S(ENCRTYPE="RSA":"ssh-rsa",1:"ssh-dss")_" "_OPENSSH
"RTN","PSNOSKEY",175,0)
 E  D
"RTN","PSNOSKEY",176,0)
 .F LN=1:1 Q:'$D(^TMP("PSNPUBKY",$J,LN))  D
"RTN","PSNOSKEY",177,0)
 ..S OPENSSH=OPENSSH_$G(^TMP("PSNPUBKY",$J,LN))
"RTN","PSNOSKEY",178,0)
 Q OPENSSH
"RTN","PSNOSKEY",179,0)
 ;
"RTN","PSNOSKEY",180,0)
ENDOS() ; Returns the Backend Server Operating System (OS)
"RTN","PSNOSKEY",181,0)
 ;Output: Backend Operating System (e.,g., "VMS", "UNIX")
"RTN","PSNOSKEY",182,0)
 ;
"RTN","PSNOSKEY",183,0)
 N ENDOS,ZTRTN,ZTIO,ZTDESC,ZTDTH,ZTSK,I
"RTN","PSNOSKEY",184,0)
 K ^XTMP("PSNKEY",$J,"OS")
"RTN","PSNOSKEY",185,0)
 S ENDOS="",ZTRTN="SETOS^PSNOSKEY("_$J_")",ZTIO=""
"RTN","PSNOSKEY",186,0)
 S ZTDESC="Backend Server OS Check"
"RTN","PSNOSKEY",187,0)
 S ZTDTH=$$NOW^XLFDT() D ^%ZTLOAD
"RTN","PSNOSKEY",188,0)
 F I=1:1:5 S ENDOS=$G(^XTMP("PSNKEY",$J,"OS")) Q:ENDOS'=""  H 1
"RTN","PSNOSKEY",189,0)
 K ^XTMP("PSNKEY",$J,"OS")
"RTN","PSNOSKEY",190,0)
 Q $S(ENDOS'="":ENDOS,1:$$OS^%ZOSV())
"RTN","PSNOSKEY",191,0)
 ;
"RTN","PSNOSKEY",192,0)
SETOS(JOB) ; Sets the Operating Systems in ^XTMP("PSNKEY",$J,"OS") (Called via Taskman)
"RTN","PSNOSKEY",193,0)
 ;Input: JOB - $Job value from calling process
"RTN","PSNOSKEY",194,0)
 S ^XTMP("PSNKEY",JOB,"OS")=$$OS^%ZOSV()
"RTN","PSNOSKEY",195,0)
 Q
"RTN","PSNOSKEY",196,0)
 ;
"RTN","PSNOSKEY",197,0)
HELP ; Encryption Type Help
"RTN","PSNOSKEY",198,0)
 W !!,"Secure SHell (SSH) Encryption Keys are used to allow data file download."
"RTN","PSNOSKEY",199,0)
 W !,"Follow the steps below to successfully setup data file download from Austin "
"RTN","PSNOSKEY",200,0)
 W !,"server to VistA sites:",!
"RTN","PSNOSKEY",201,0)
 W !,"Step 1: Select the 'C' (Create New SSH Key Pair) Action and follow the prompts"
"RTN","PSNOSKEY",202,0)
 W !,"        to create a new pair of SSH keys. If you already have an existing SSH"
"RTN","PSNOSKEY",203,0)
 W !,"        Key Pair you can skip this step."
"RTN","PSNOSKEY",204,0)
 W !,"        You can check whether you already have an existing SSH Key Pair"
"RTN","PSNOSKEY",205,0)
 W !,"        through the 'V' (View Public SSH Key) Action."
"RTN","PSNOSKEY",206,0)
 W !,""
"RTN","PSNOSKEY",207,0)
 D HELP1,PAUSE
"RTN","PSNOSKEY",208,0)
 W !!,"Step 2: Share the Public SSH Key content with the PPS-N SFTP server (Austin)."
"RTN","PSNOSKEY",209,0)
 W !,"        Inorder to successfully establish the data download files, the SFTP  "
"RTN","PSNOSKEY",210,0)
 W !,"        server at Austin needs to install/configure the new SSH Key created in"
"RTN","PSNOSKEY",211,0)
 W !,"        step 1 for the user id they assigned to your site. Use the 'V' (View "
"RTN","PSNOSKEY",212,0)
 W !,"        Public SSH Key) Action to retrieve the content of the Public SSH key."
"RTN","PSNOSKEY",213,0)
 W !,"        The Public SSH Key should not contain line-feed characters, therefore "
"RTN","PSNOSKEY",214,0)
 W !,"        after you copy & paste it from the terminal emulator into an email or "
"RTN","PSNOSKEY",215,0)
 W !,"        text editor make sure it contains only one line of text (no wrapping)."
"RTN","PSNOSKEY",216,0)
 Q
"RTN","PSNOSKEY",217,0)
 ;
"RTN","PSNOSKEY",218,0)
HELP1 ; Encryption Type Help
"RTN","PSNOSKEY",219,0)
 W !,"        Encryption Type: RSA or DSA?"
"RTN","PSNOSKEY",220,0)
 W !,"        ----------------------------"
"RTN","PSNOSKEY",221,0)
 W !,"        The Rivest, Shamir & Adleman (RSA) and Digital Signature Algorithm"
"RTN","PSNOSKEY",222,0)
 W !,"        (DSA) are two of the most common encryption algorithms used in IT "
"RTN","PSNOSKEY",223,0)
 W !,"        industry for securely sharing data."
"RTN","PSNOSKEY",224,0)
 Q
"RTN","PSNOSKEY",225,0)
PAUSE ; Pauses screen until user hits Return
"RTN","PSNOSKEY",226,0)
 W ! K DIR S DIR("A")="Press Return to continue",DIR(0)="E" D ^DIR
"RTN","PSNOSKEY",227,0)
 Q
"RTN","PSNOSKEY",228,0)
 ;
"RTN","PSNOSKEY",229,0)
ASK() ; confirm creating new pair
"RTN","PSNOSKEY",230,0)
 N Y S Y=0 Q:'$D(^TMP("PSNPUBKY",$J)) 1
"RTN","PSNOSKEY",231,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNOSKEY",232,0)
 S DIR("A")="Do you want to delete existing key pair and create new pair" W !!
"RTN","PSNOSKEY",233,0)
 S DIR("B")="NO" D ^DIR
"RTN","PSNOSKEY",234,0)
 Q Y
"RTN","PSNPPSDL")
0^3^B31742401^B29912980
"RTN","PSNPPSDL",1,0)
PSNPPSDL ;HP/ART - National Drug File Updates File Download ;09/23/2015
"RTN","PSNPPSDL",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513,563**; 30 Oct 98;Build 5
"RTN","PSNPPSDL",3,0)
 ;
"RTN","PSNPPSDL",4,0)
 ;Reference to ^XUSEC( supported by IA #10076
"RTN","PSNPPSDL",5,0)
 ;
"RTN","PSNPPSDL",6,0)
 Q
"RTN","PSNPPSDL",7,0)
 ;
"RTN","PSNPPSDL",8,0)
DOWNLOAD ;Entry point for menu option PSN DOWNLOAD NDF UPDATES for immediate PPS-N update file download
"RTN","PSNPPSDL",9,0)
 N PSENTER,PSNLEGF
"RTN","PSNPPSDL",10,0)
 I $$GET1^DIQ(57.23,1,9,"I")="Y" D  Q
"RTN","PSNPPSDL",11,0)
 .W !!,"The PPS-N/NDF file download is already in progress.  Please try again later."
"RTN","PSNPPSDL",12,0)
 .R !!,"Press enter to continue...",PSENTER:120
"RTN","PSNPPSDL",13,0)
 N DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSDL",14,0)
 I '$D(^XUSEC("PSN PPS ADMIN",DUZ)) D  Q
"RTN","PSNPPSDL",15,0)
 . W !!,"You do not have the appropriate security key to use this option"
"RTN","PSNPPSDL",16,0)
 . W !,"please contact your ADPAC to resolve this issue.",!
"RTN","PSNPPSDL",17,0)
 . S DIR(0)="E",DIR("A")=" Press ENTER to Continue"
"RTN","PSNPPSDL",18,0)
 . D ^DIR
"RTN","PSNPPSDL",19,0)
 ;
"RTN","PSNPPSDL",20,0)
 S PSNLEGF="",PSNLEGF=$$LEGACY() I PSNLEGF Q
"RTN","PSNPPSDL",21,0)
 D CHKD ;update Unix directory if needed and create it if entry does not exist.
"RTN","PSNPPSDL",22,0)
 ;
"RTN","PSNPPSDL",23,0)
 W !!!,"Warning: This download should only be done during off peak hours!"
"RTN","PSNPPSDL",24,0)
 ;
"RTN","PSNPPSDL",25,0)
 N DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSDL",26,0)
 W ! S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSDL",27,0)
 S DIR("A")="Are you sure you want to immediately start an NDF update download"
"RTN","PSNPPSDL",28,0)
 S DIR("B")="NO" D ^DIR I 'Y Q
"RTN","PSNPPSDL",29,0)
 W !,"Please stand-by NDF update download may take up to 30 minutes...",!
"RTN","PSNPPSDL",30,0)
 ;
"RTN","PSNPPSDL",31,0)
RUNIT ; Entry point for tasked menu option "PSN TASK SCHEDULED DOWNLOAD"
"RTN","PSNPPSDL",32,0)
 N PSNSCJOB S PSNSCJOB=1 D EN^PSNFTP
"RTN","PSNPPSDL",33,0)
 Q
"RTN","PSNPPSDL",34,0)
 ;
"RTN","PSNPPSDL",35,0)
SCHDOPT ; Entry point for menu option "PSN TASK SCHEDULE DOWNLOAD" to create and/or edit the scheduling date/time
"RTN","PSNPPSDL",36,0)
 N DIRUT,DUOUT,DIR,X,Y,PSSTART,PSFREQ,PSERROR,PSNLEGF
"RTN","PSNPPSDL",37,0)
 I '$D(^XUSEC("PSN PPS ADMIN",DUZ)) D  Q
"RTN","PSNPPSDL",38,0)
 . W !!,"You do not have the appropriate security key to use this option"
"RTN","PSNPPSDL",39,0)
 . W !,"please contact your ADPAC to resolve this issue.",!
"RTN","PSNPPSDL",40,0)
 . S DIR(0)="E",DIR("A")=" Press ENTER to Continue"
"RTN","PSNPPSDL",41,0)
 . D ^DIR
"RTN","PSNPPSDL",42,0)
 ;
"RTN","PSNPPSDL",43,0)
 S PSNLEGF="",PSNLEGF=$$LEGACY() I PSNLEGF Q
"RTN","PSNPPSDL",44,0)
 D CHKD ;update Unix directory if needed and create it if entry does not exist.
"RTN","PSNPPSDL",45,0)
 ;
"RTN","PSNPPSDL",46,0)
 W !!!,"This option allows you to schedule a recurring TasKMan job to"
"RTN","PSNPPSDL",47,0)
 W !,"perform the NDF update file download from PPS-N."
"RTN","PSNPPSDL",48,0)
 W !!,"Warning! This download should be scheduled during non-peak hours."
"RTN","PSNPPSDL",49,0)
 W !!,"You will need to select a date/time and how often this download should reoccur."
"RTN","PSNPPSDL",50,0)
 ;
"RTN","PSNPPSDL",51,0)
 N DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSDL",52,0)
 ;W !!
"RTN","PSNPPSDL",53,0)
 D SCHCK("PSN TASK SCHEDULED DOWNLOAD","D") ;print scheduled tasks
"RTN","PSNPPSDL",54,0)
 ;
"RTN","PSNPPSDL",55,0)
 S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSDL",56,0)
 S DIR("A")="Do you want to schedule an automatic NDF download in TaskMan",DIR("B")="NO"
"RTN","PSNPPSDL",57,0)
 D ^DIR I (Y'>0)!$D(DIRUT) W @IOF Q
"RTN","PSNPPSDL",58,0)
 ;
"RTN","PSNPPSDL",59,0)
 D NOW^%DTC S %DT(0)=%,%DT="EFATX",%DT("A")="Enter date/time: " D ^%DT
"RTN","PSNPPSDL",60,0)
 I (Y<0)!($D(DTOUT)) W !!,"No action taken!" D ENTER W @IOF Q
"RTN","PSNPPSDL",61,0)
 S PSSTART=$$FMADD^XLFDT(Y,0,0,5)
"RTN","PSNPPSDL",62,0)
 ;
"RTN","PSNPPSDL",63,0)
 N DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSDL",64,0)
 W !! S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSDL",65,0)
 S DIR("A")="Should this download be re-scheduled at the same time weekly"
"RTN","PSNPPSDL",66,0)
 S DIR("B")="NO" D ^DIR I Y S PSFREQ="7D" G END
"RTN","PSNPPSDL",67,0)
 I $D(DIRUT) W !!,"No action taken!" D ENTER W @IOF Q
"RTN","PSNPPSDL",68,0)
 ;
"RTN","PSNPPSDL",69,0)
 N DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSDL",70,0)
 W !! S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSDL",71,0)
 S DIR("A")="Should this download be re-scheduled at the same time daily"
"RTN","PSNPPSDL",72,0)
 S DIR("B")="NO" D ^DIR I Y S PSFREQ="1D" G END
"RTN","PSNPPSDL",73,0)
 I $D(DIRUT) W !!,"No action taken!" D ENTER W @IOF Q
"RTN","PSNPPSDL",74,0)
 I 'Y S PSFREQ="" W !!,"Warning! The download you have scheduled will occur only once."
"RTN","PSNPPSDL",75,0)
 ;
"RTN","PSNPPSDL",76,0)
END ;
"RTN","PSNPPSDL",77,0)
 N DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSDL",78,0)
 I PSFREQ="" D RESCH^XUTMOPT("PSN TASK SCHEDULED DOWNLOAD","@","","@")
"RTN","PSNPPSDL",79,0)
 W !,"Your start time is:"
"RTN","PSNPPSDL",80,0)
 D RESCH^XUTMOPT("PSN TASK SCHEDULED DOWNLOAD",PSSTART,"",PSFREQ,"L",.PSERROR)
"RTN","PSNPPSDL",81,0)
 I +PSFREQ=1 W !!,"The download will automatically be re-scheduled Daily",!
"RTN","PSNPPSDL",82,0)
 I +PSFREQ=7 W !!,"The download will automatically be re-scheduled Weekly",!
"RTN","PSNPPSDL",83,0)
 I PSFREQ="" W !!,"The download will NOT automatically be re-scheduled",!
"RTN","PSNPPSDL",84,0)
 D ENTER W @IOF
"RTN","PSNPPSDL",85,0)
 Q
"RTN","PSNPPSDL",86,0)
 ;
"RTN","PSNPPSDL",87,0)
SCHCK(OPTION,TYPE) ; check PPS-N scheduled Download or Install tasks
"RTN","PSNPPSDL",88,0)
 ;  input - OPTION as name of option
"RTN","PSNPPSDL",89,0)
 ;          TYPE as task type (D-Download/I-Install)
"RTN","PSNPPSDL",90,0)
 ;  output - print future queued tasked (external format)
"RTN","PSNPPSDL",91,0)
 ;
"RTN","PSNPPSDL",92,0)
 N I,II,PSIEN,XX,NODE,NODE1,PSNROOT
"RTN","PSNPPSDL",93,0)
 ; check to see if the option is defined in option scheduler file and it is tasked.
"RTN","PSNPPSDL",94,0)
 D OPTSTAT^XUTMOPT(OPTION,.PSNROOT) I '+$G(PSNROOT(1)) Q
"RTN","PSNPPSDL",95,0)
 S (I,II)=0
"RTN","PSNPPSDL",96,0)
 F  S I=$O(PSNROOT(I)) Q:'I  S II=II+1 D
"RTN","PSNPPSDL",97,0)
 .I II=1 W !!!,"Scheduled "_$S(TYPE="D":"Downloads",TYPE="I":"Installs",1:"")_" are:",!,"-----------------------"
"RTN","PSNPPSDL",98,0)
 .W !,$P(PSNROOT(I),"^")_"  "_$$DATE($P(PSNROOT(I),"^",2),1),"  ",$P(PSNROOT(I),"^",3),!
"RTN","PSNPPSDL",99,0)
 I II=0 W !,"*** Currently NO scheduled "_$S(TYPE="D":"Downloads",TYPE="I":"Installs",1:"")," tasks.",!
"RTN","PSNPPSDL",100,0)
 Q
"RTN","PSNPPSDL",101,0)
 ;
"RTN","PSNPPSDL",102,0)
DATE(NODE,PIECE) ; return appropriate date
"RTN","PSNPPSDL",103,0)
 ;  input - NODE as node of data
"RTN","PSNPPSDL",104,0)
 ;          PIECE as piece of node to convert
"RTN","PSNPPSDL",105,0)
 ; output - date in external format
"RTN","PSNPPSDL",106,0)
 ;
"RTN","PSNPPSDL",107,0)
 Q $$UP^XLFSTR($$FMTE^XLFDT($P(NODE,"^",PIECE)))
"RTN","PSNPPSDL",108,0)
 ;
"RTN","PSNPPSDL",109,0)
LEGACY() ;check legacy update file processing parameter
"RTN","PSNPPSDL",110,0)
 N PSNLEG,PSNF,PSENTER
"RTN","PSNPPSDL",111,0)
 S (PSNF,PSNLEG)="",PSNLEG=$$GET1^DIQ(57.23,1,45)   ;legacy update
"RTN","PSNPPSDL",112,0)
 I PSNLEG="YES" S PSNF=1 D
"RTN","PSNPPSDL",113,0)
 .W !!,"This option may not be utilized because the Legacy Update Processing"
"RTN","PSNPPSDL",114,0)
 .W !,"site parameter is defined as YES.  You may only install FORUM NDF patch updates.",!
"RTN","PSNPPSDL",115,0)
 .R !!,"Press enter to continue...",PSENTER:120
"RTN","PSNPPSDL",116,0)
 Q PSNF
"RTN","PSNPPSDL",117,0)
 ;
"RTN","PSNPPSDL",118,0)
CHKD ; check Unix dir and update it if contains control char and other special characters
"RTN","PSNPPSDL",119,0)
 I $$OS^%ZOSV()'="UNIX" Q
"RTN","PSNPPSDL",120,0)
 N UNXLD,UNXLD1 S (UNXLD,UNXLD1)=""
"RTN","PSNPPSDL",121,0)
 D UPDT
"RTN","PSNPPSDL",122,0)
 S UNXLD=$$GETD^PSNFTP()
"RTN","PSNPPSDL",123,0)
 I '$$DIREXIST^PSNFTP2(UNXLD) D MAKEDIR^PSNFTP2(UNXLD)
"RTN","PSNPPSDL",124,0)
 Q
"RTN","PSNPPSDL",125,0)
 ;
"RTN","PSNPPSDL",126,0)
UPDT ; update unix/linux directory, called by PSNPPSDL 
"RTN","PSNPPSDL",127,0)
 N DA,DIE,DR
"RTN","PSNPPSDL",128,0)
 S UNXLD=$P($G(^PS(57.23,1,0)),"^",4) I UNXLD]"" D
"RTN","PSNPPSDL",129,0)
 .S UNXLD1=$$STRIP^PSNPARM(UNXLD) I UNXLD]"",(UNXLD'=UNXLD1) S DIE="^PS(57.23,",DA=1,DR="3////"_UNXLD D ^DIE K DIE,DA,DR
"RTN","PSNPPSDL",130,0)
 Q
"RTN","PSNPPSDL",131,0)
 ;
"RTN","PSNPPSDL",132,0)
ENTER ; press enter key
"RTN","PSNPPSDL",133,0)
 K DIR
"RTN","PSNPPSDL",134,0)
 W ! S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSDL",135,0)
 Q
"RTN","PSNPPSNC")
0^2^B14208219^B14201170
"RTN","PSNPPSNC",1,0)
PSNPPSNC ;HP/SXT-PPSN update NDF data ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSNC",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513,563**; 30 Oct 98;Build 5
"RTN","PSNPPSNC",3,0)
 ;
"RTN","PSNPPSNC",4,0)
 ; taken mostly from: PSSHTTP ;WOIFO/AV - REENGINERING Sends XML Request to PEPS via HWSC ;09/20/07
"RTN","PSNPPSNC",5,0)
 ;
"RTN","PSNPPSNC",6,0)
 Q
"RTN","PSNPPSNC",7,0)
 ;;
"RTN","PSNPPSNC",8,0)
 ;
"RTN","PSNPPSNC",9,0)
SEND(STATUS,VERSION,MESSAGE) ;
"RTN","PSNPPSNC",10,0)
 ;
"RTN","PSNPPSNC",11,0)
 NEW TIME,SITE,XML,OK,DOCHAND
"RTN","PSNPPSNC",12,0)
 ;TIME FORMAT:  yyyy/mm/ddThh:mm:ss i.e. - 2014/3/24T13:20:27
"RTN","PSNPPSNC",13,0)
 S TIME=$$HTE^XLFDT($H,7)
"RTN","PSNPPSNC",14,0)
 S TIME=$TR(TIME,"@","T")
"RTN","PSNPPSNC",15,0)
 S SITE=+$P($$SITE^VASITE(),"^",3)
"RTN","PSNPPSNC",16,0)
 S XML="<vistaUpdateStatus><message>"_MESSAGE_"</message><site>"_SITE_"</site><status>"_STATUS_"</status>"
"RTN","PSNPPSNC",17,0)
 S XML=XML_"<timeApplied>"_TIME_"</timeApplied><version>"_VERSION_"</version></vistaUpdateStatus>"
"RTN","PSNPPSNC",18,0)
 S OK=$$PPSNPOST(.DOCHAND,XML)
"RTN","PSNPPSNC",19,0)
 Q:'OK 0
"RTN","PSNPPSNC",20,0)
 Q 1
"RTN","PSNPPSNC",21,0)
 ; 
"RTN","PSNPPSNC",22,0)
TEST ;
"RTN","PSNPPSNC",23,0)
 S X=$$SEND("STARTED","PPS_1PRV_11NEW.DAT","")
"RTN","PSNPPSNC",24,0)
 W !,$S(X:"Sent",1:"Failed")
"RTN","PSNPPSNC",25,0)
 Q
"RTN","PSNPPSNC",26,0)
 ;
"RTN","PSNPPSNC",27,0)
 N RESPONSE,X S (X,RESPONSE)=""
"RTN","PSNPPSNC",28,0)
 S XML="<vistaUpdateStatus><message></message><site>512</site><status>STARTED</status>"
"RTN","PSNPPSNC",29,0)
 S XML=XML_"<timeApplied>2014-02-25T19:32:39.911-05:00</timeApplied><version>PPS_0PRV_6NEW.DAT</version></vistaUpdateStatus>"
"RTN","PSNPPSNC",30,0)
 ;S XML=XML_"<vistaUpdateStatus><version>PPS_5PRV_6NEW.DAT</version><site>512</site><status>COMPLETED</status><message></message></vistaUpdateStatus"
"RTN","PSNPPSNC",31,0)
 S X="TEST"
"RTN","PSNPPSNC",32,0)
 U 0 W !,"calling function"
"RTN","PSNPPSNC",33,0)
 S RESPONSE=$$PPSNPOST(.X,XML)
"RTN","PSNPPSNC",34,0)
 Q
"RTN","PSNPPSNC",35,0)
 ;
"RTN","PSNPPSNC",36,0)
PPSNPOST(DOCHAND,XML) ;
"RTN","PSNPPSNC",37,0)
 ; @DESC Sends an HTTP request to PEPS as a POST
"RTN","PSNPPSNC",38,0)
 ;
"RTN","PSNPPSNC",39,0)
 ; @DOCHAND Handle to XML document
"RTN","PSNPPSNC",40,0)
 ; @XML XML request as string
"RTN","PSNPPSNC",41,0)
 ;
"RTN","PSNPPSNC",42,0)
 ; @RETURNS A handle to response XML document
"RTN","PSNPPSNC",43,0)
 ;          1 for success, 0 for failure
"RTN","PSNPPSNC",44,0)
 ;
"RTN","PSNPPSNC",45,0)
 NEW PSS,PSSERR,$ETRAP,$ESTACK
"RTN","PSNPPSNC",46,0)
 ;
"RTN","PSNPPSNC",47,0)
 ; Set error trap
"RTN","PSNPPSNC",48,0)
 SET $ETRAP="DO ERROR^PSNPPSNC"
"RTN","PSNPPSNC",49,0)
 ;
"RTN","PSNPPSNC",50,0)
 SET PSS("server")="PPSN"
"RTN","PSNPPSNC",51,0)
 ;SET PSS("server")="TIM" ;DEBUG
"RTN","PSNPPSNC",52,0)
 SET PSS("webserviceName")="UPDATE_STATUS"
"RTN","PSNPPSNC",53,0)
 SET PSS("path")="status"
"RTN","PSNPPSNC",54,0)
 ;
"RTN","PSNPPSNC",55,0)
 SET PSS("parameterName")="xmlRequest"
"RTN","PSNPPSNC",56,0)
 SET PSS("parameterValue")=XML
"RTN","PSNPPSNC",57,0)
 K ^TMP($JOB,"OUT","EXCEPTION")
"RTN","PSNPPSNC",58,0)
 ;
"RTN","PSNPPSNC",59,0)
 ; Get instance of client REST request object
"RTN","PSNPPSNC",60,0)
 ;***W !,"get instance"
"RTN","PSNPPSNC",61,0)
 SET PSS("restObject")=$$GETREST^XOBWLIB(PSS("webserviceName"),PSS("server"))
"RTN","PSNPPSNC",62,0)
 IF $DATA(^TMP($JOB,"OUT","EXCEPTION"))>0 QUIT 0
"RTN","PSNPPSNC",63,0)
 ;
"RTN","PSNPPSNC",64,0)
 ; Insert XML as parameter
"RTN","PSNPPSNC",65,0)
 ;*** W !,"insert XML parameter"
"RTN","PSNPPSNC",66,0)
 DO PSS("restObject").InsertFormData(PSS("parameterName"),PSS("parameterValue"))
"RTN","PSNPPSNC",67,0)
 IF $DATA(^TMP($JOB,"OUT","EXCEPTION"))>0 QUIT 0
"RTN","PSNPPSNC",68,0)
 ;
"RTN","PSNPPSNC",69,0)
 ; Execute HTTP Post method
"RTN","PSNPPSNC",70,0)
 ;***W !,"execute POST ?" R Z I Z'="Y" B
"RTN","PSNPPSNC",71,0)
 SET PSS("postResult")=$$POST^XOBWLIB(PSS("restObject"),PSS("path"),.PSSERR)
"RTN","PSNPPSNC",72,0)
 IF $DATA(^TMP($JOB,"OUT","EXCEPTION"))>0 QUIT 0
"RTN","PSNPPSNC",73,0)
 ;
"RTN","PSNPPSNC",74,0)
 DO:PSS("postResult")
"RTN","PSNPPSNC",75,0)
 . SET PSS("result")=##class(gov.va.med.pre.ws.XMLHandler).getHandleToXmlDoc(PSS("restObject").HttpResponse.Data, .DOCHAND)
"RTN","PSNPPSNC",76,0)
 . QUIT
"RTN","PSNPPSNC",77,0)
 ;
"RTN","PSNPPSNC",78,0)
 DO:'PSS("postResult")
"RTN","PSNPPSNC",79,0)
 . SET ^TMP($JOB,"OUT","EXCEPTION")="Unable to make http request."
"RTN","PSNPPSNC",80,0)
 . SET PSS("result")=0
"RTN","PSNPPSNC",81,0)
 . QUIT
"RTN","PSNPPSNC",82,0)
 ;
"RTN","PSNPPSNC",83,0)
 QUIT PSS("result")
"RTN","PSNPPSNC",84,0)
 ;;
"RTN","PSNPPSNC",85,0)
ERROR ;
"RTN","PSNPPSNC",86,0)
 ; @DESC Handles error during request to PEPS via webservice.
"RTN","PSNPPSNC",87,0)
 ;
"RTN","PSNPPSNC",88,0)
 ; Depends on GLOBAL variable PSSERR to be set in previous call.
"RTN","PSNPPSNC",89,0)
 ;
"RTN","PSNPPSNC",90,0)
 ; @RETURNS Nothing. Value store in global.
"RTN","PSNPPSNC",91,0)
 ;
"RTN","PSNPPSNC",92,0)
 NEW ERRARRAY
"RTN","PSNPPSNC",93,0)
 ;
"RTN","PSNPPSNC",94,0)
 ; Get error object from Error Object Factory
"RTN","PSNPPSNC",95,0)
 IF $GET(PSSERR)="" SET PSSERR=$$EOFAC^XOBWLIB()
"RTN","PSNPPSNC",96,0)
 ; Store the error object in the error array
"RTN","PSNPPSNC",97,0)
 DO ERR2ARR^XOBWLIB(PSSERR,.ERRARRAY)
"RTN","PSNPPSNC",98,0)
 ;
"RTN","PSNPPSNC",99,0)
 ; Parse out the error text and store in global
"RTN","PSNPPSNC",100,0)
 SET ^TMP($JOB,"OUT","EXCEPTION")=$$GETTEXT(.ERRARRAY)
"RTN","PSNPPSNC",101,0)
 ;
"RTN","PSNPPSNC",102,0)
 ; Set ecode to empty to return to calling function
"RTN","PSNPPSNC",103,0)
 SET $ECODE=""
"RTN","PSNPPSNC",104,0)
 ;
"RTN","PSNPPSNC",105,0)
 QUIT
"RTN","PSNPPSNC",106,0)
 ;;
"RTN","PSNPPSNC",107,0)
GETTEXT(ERRARRAY) ;
"RTN","PSNPPSNC",108,0)
 ; @DESC Gets the error text from the array
"RTN","PSNPPSNC",109,0)
 ;
"RTN","PSNPPSNC",110,0)
 ; @ERRARRAY Error array stores error in format defined by web service product.
"RTN","PSNPPSNC",111,0)
 ;
"RTN","PSNPPSNC",112,0)
 ; @RETURNS Error info as a single string
"RTN","PSNPPSNC",113,0)
 ;
"RTN","PSNPPSNC",114,0)
 NEW PSS
"RTN","PSNPPSNC",115,0)
 ;
"RTN","PSNPPSNC",116,0)
 ; Loop through the text subscript of error array and concatenate
"RTN","PSNPPSNC",117,0)
 SET PSS("errorText")=""
"RTN","PSNPPSNC",118,0)
 SET PSS("I")=""
"RTN","PSNPPSNC",119,0)
 FOR  SET PSS("I")=$ORDER(ERRARRAY("text",PSS("I"))) QUIT:PSS("I")=""  DO
"RTN","PSNPPSNC",120,0)
 . SET PSS("errorText")=PSS("errorText")_ERRARRAY("text",PSS("I"))
"RTN","PSNPPSNC",121,0)
 . QUIT
"RTN","PSNPPSNC",122,0)
 ;
"RTN","PSNPPSNC",123,0)
 QUIT PSS("errorText")
"RTN","PSNPPSNC",124,0)
 ;;
"RTN","PSNPPSNU")
0^6^B50930121^B51690215
"RTN","PSNPPSNU",1,0)
PSNPPSNU ;HP/MJE-PPSN update NDF data ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSNU",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513,563**; 30 Oct 98;Build 5
"RTN","PSNPPSNU",3,0)
 ;Reference to ^PSDRUG supported by DBIA #2192
"RTN","PSNPPSNU",4,0)
 ;Reference to PSN^PSSHUIDG supported by DBIA #3621
"RTN","PSNPPSNU",5,0)
 ;Reference to ^GMR(120.8) supported by DBIA #4606
"RTN","PSNPPSNU",6,0)
 ;Reference to ^DD supported by DBIA #1258
"RTN","PSNPPSNU",7,0)
 ;
"RTN","PSNPPSNU",8,0)
 ; Note: this routine is an adapted version of the origional code by Dr. Dave Alexander
"RTN","PSNPPSNU",9,0)
 ;
"RTN","PSNPPSNU",10,0)
 N CL,CLA,CMOP,CT,DA,DA1,DIA,DIC,DIE,DIK,DINUM,DR,FDA,FILE,FLDS,GE,GROOT,GROOT1,IENS,IN,INA,IND,INDX,INV,J,JJ,K
"RTN","PSNPPSNU",11,0)
 N LI,LINE,NA,NAME,ND,NEW,NFI,POST,PR,PSN,PSN1,PSN11,PSN21,PSNDF,R1,ROOT,ROOT1,ROOT2,ROOT3,SUBS,VAC,VAIN,VAPN
"RTN","PSNPPSNU",12,0)
 N X,XMDUZ,XMSUB,XMTEXT,XMY,XMZ,TREC,PSNMULTI,MJJ,PSNERROR
"RTN","PSNPPSNU",13,0)
 N ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,XPATH
"RTN","PSNPPSNU",14,0)
 N PSNPS,XPDIDTOT,RES1,PSNTMPN
"RTN","PSNPPSNU",15,0)
 K ^TMP($J),^TMP("PSN",$J),^TMP("PSNN",$J),^TMP("PSN PPSN.WP",$J),^TMP("PSN PPSN ERR",$J),^TMP("PSNINGRED",$J)
"RTN","PSNPPSNU",16,0)
 ;
"RTN","PSNPPSNU",17,0)
 ;SETUP PRODUCTION OR SQA
"RTN","PSNPPSNU",18,0)
 S PSNPS=$P($G(^PS(59.7,1,10)),"^",12),PSNERROR=0
"RTN","PSNPPSNU",19,0)
 I PSNPS="T"!(PSNPS="S") S PSNPS="P" ;test account and support account is same as production.
"RTN","PSNPPSNU",20,0)
 S PSNDF=1,XPDIDTOT=+$G(^TMP("PSN PPSN PARSED",$J,"TREC")),TREC=0
"RTN","PSNPPSNU",21,0)
 ;TO ALLOW ADDS TO 56,50.416,50.605,50.606, AND 50.6
"RTN","PSNPPSNU",22,0)
 ;
"RTN","PSNPPSNU",23,0)
 D DATANT^PSNPPSI1
"RTN","PSNPPSNU",24,0)
 I PSNPS="N" D POSTRUN^PSNPPSNK
"RTN","PSNPPSNU",25,0)
 ;
"RTN","PSNPPSNU",26,0)
WORD ;
"RTN","PSNPPSNU",27,0)
 D CTRKDL^PSNPPSMS("Storing report messages information")
"RTN","PSNPPSNU",28,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",6)="WORD"
"RTN","PSNPPSNU",29,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSNU",30,0)
 K FDA
"RTN","PSNPPSNU",31,0)
 S ROOT1=$NA(^TMP("PSN PPSN PARSED",$J,"WORD")),CT=0,ROOT2=$NA(@ROOT1@(0))
"RTN","PSNPPSNU",32,0)
 F  S CT=$O(@ROOT2) Q:'CT  D CTRLSS^PSNPPSMS(CT) S ROOT2=$NA(@ROOT1@(CT)),NAME=@ROOT2,ROOT3=$NA(@ROOT2@("D")) K @NAME M @NAME=@ROOT3
"RTN","PSNPPSNU",33,0)
 ;
"RTN","PSNPPSNU",34,0)
 D CTRKDL^PSNPPSMS("Sending mail messages")
"RTN","PSNPPSNU",35,0)
 D MESSAGE^PSNPPSMG
"RTN","PSNPPSNU",36,0)
 ;
"RTN","PSNPPSNU",37,0)
 D CTRKDL^PSNPPSMS("Beginning un-march/re-match")
"RTN","PSNPPSNU",38,0)
 W:'$G(PSNSCJOB) !,"Beginning un-match/re-match to local drug file...",!
"RTN","PSNPPSNU",39,0)
DRUGFILE ;
"RTN","PSNPPSNU",40,0)
 ;NOW UPDATE LOCAL DRUG FILE
"RTN","PSNPPSNU",41,0)
 N REM,PSNUNMAT
"RTN","PSNPPSNU",42,0)
 K ^TMP($J)
"RTN","PSNPPSNU",43,0)
 I PSNPS="N" S OLDNDF="" F  S OLDNDF=$O(^TMP("PSN PPSN PARSED",$J,"REM",OLDNDF)) Q:OLDNDF=""  D EN1^PSNPPSNW(OLDNDF,"")
"RTN","PSNPPSNU",44,0)
 S OLDNDF="",PSN=$$PATCH^XPDUTL("PSS*1.0*34"),PSN1=$$PATCH^XPDUTL("PSS*1.0*42")
"RTN","PSNPPSNU",45,0)
 S ROOT2=$NA(^TMP("PSN PPSN PARSED",$J,"PRODUCTS TO UNMATCH")),ROOT3=$NA(^TMP("PSN PPSN PARSED",$J,"POE")),DA=0
"RTN","PSNPPSNU",46,0)
 S DA=0 F  S DA=$O(^PSDRUG(DA)) Q:'DA  S X=$G(^PSDRUG(DA,0)) I X]"" S NA=$P(X,"^"),CLA=$P(X,"^",2),INV=$P(X,"^",3)["I",X=$G(^("ND")),IN=$P($G(^("I"),9999999),"^"),INA=IN'>DT,GE=+X,PR=+$P(X,"^",3),CMOP=$P(X,"^",10),VAPN=$P(X,"^",2) I GE I PR D
"RTN","PSNPPSNU",47,0)
 .S OLDNDF=$P($G(^PSDRUG(DA,"ND")),"^",3) ;va product name (3P:50.68); NA = generic name; CLA = VA Class; INV = DEA Special HDLG 
"RTN","PSNPPSNU",48,0)
 .S VAIN=$P($G(^PSNDF(50.68,PR,7)),"^",3) ;inactivation date
"RTN","PSNPPSNU",49,0)
 .I $D(@ROOT2@(PR))!VAIN S X="" S:CMOP]"" X="    (CMOP "_CMOP_")" D
"RTN","PSNPPSNU",50,0)
 ..S $E(X,30)=VAPN,$E(X,65)=$$FMTE^XLFDT(VAIN,5),INDX=$S(INA:"I",INV:"X",1:"A")
"RTN","PSNPPSNU",51,0)
 ..S:IN=9999999 IN="" S ^TMP($J,INDX,NA_"^"_DA_"^"_IN,1)=X,^TMP($J,"^",DA)=""
"RTN","PSNPPSNU",52,0)
 ..D UNMDRG
"RTN","PSNPPSNU",53,0)
 ..I PSN I $P($G(^PSDRUG(DA,"DOS")),"^")]""!$O(^("DOS1",0))!$O(^PSDRUG(DA,"DOS2",0)) D LOAD^PSNPPSNV K ^PSDRUG(DA,"DOS"),^("DOS1"),^("DOS2")
"RTN","PSNPPSNU",54,0)
 ..I $P($G(^PSDRUG(DA,3)),"^") S DIE=50,DR="213////0;" D ^DIE D ERROR:$D(ERROR("DIERR")) K DIE,DR I PSN1 S IND=$O(^PSDRUG(DA,4," "),-1),$P(^(IND,0),"^",6)="NDF Update"
"RTN","PSNPPSNU",55,0)
 .;check here if PR (50.68 IEN this local drug is matched to) exists in TMP rematch
"RTN","PSNPPSNU",56,0)
 .;if a re-match for that IEN is not null, do re-match (file re-match, add to report)
"RTN","PSNPPSNU",57,0)
 .S REM="" I OLDNDF'="" S REM=$G(^TMP("PSN PPSN PARSED",$J,"REM",OLDNDF))
"RTN","PSNPPSNU",58,0)
 .I REM'="" D REMATCH^PSNPPSNW(DA,REM)
"RTN","PSNPPSNU",59,0)
 .I PSN,$D(@ROOT3@(PR)) K ^PSDRUG(DA,"DOS"),^("DOS1"),^("DOS2")
"RTN","PSNPPSNU",60,0)
 .S ND=$G(^PSDRUG(DA,"ND")),PR=$P(ND,"^",3) I PR D
"RTN","PSNPPSNU",61,0)
 ..S NFI=$P($G(^PSNDF(50.68,PR,5)),"^") I $P(ND,"^",11)'=NFI S DIE=50,DR="29////"_NFI_";" D ^DIE D ERROR:$D(ERROR("DIERR"))
"RTN","PSNPPSNU",62,0)
 ..S VAC=$P($G(^PSNDF(50.68,PR,3)),"^") I VAC S VAC=$P(^PS(50.605,VAC,0),"^"),DIE=50,DR="2////"_VAC_";" D ^DIE D ERROR:$D(ERROR("DIERR"))
"RTN","PSNPPSNU",63,0)
 ..I $P($G(^PSDRUG(DA,3)),"^"),'$P($G(^PSNDF(50.68,PR,1)),"^",3) S DIE=50,DR="213////0;" D ^DIE D ERROR:$D(ERROR("DIERR")) K DIE,DR S IND=$O(^PSDRUG(DA,4," "),-1),$P(^(IND,0),"^",6)="NDF Update"
"RTN","PSNPPSNU",64,0)
 .;S TREC=TREC+1 I '(TREC#500) D UPDATE^XPDID(TREC)
"RTN","PSNPPSNU",65,0)
 D DRGMSG^PSNPPSMG
"RTN","PSNPPSNU",66,0)
 ;package specific post install
"RTN","PSNPPSNU",67,0)
 I $D(^TMP("PSN PPSN PARSED",$J,"POST")) S POST=^("POST") S:POST'["^" POST="^"_POST I @("$T("_POST_")]]""""") D @POST
"RTN","PSNPPSNU",68,0)
 ;
"RTN","PSNPPSNU",69,0)
 ;call to HL7 drug update message
"RTN","PSNPPSNU",70,0)
 I $T(PSN^PSSHUIDG)]"" I $O(^TMP($J,"^",0)) S ZTRTN="PSN^PSSHUIDG",ZTIO="",ZTDTH=$H,ZTDESC="DRUG UPDATE MESSAGE",ZTSAVE("^TMP($J,""^"",")="" D ^%ZTLOAD
"RTN","PSNPPSNU",71,0)
 ;
"RTN","PSNPPSNU",72,0)
 D CTRKDL^PSNPPSMS("Validating cross references")
"RTN","PSNPPSNU",73,0)
 W:'$G(PSNSCJOB) !,"Validating cross references...",!
"RTN","PSNPPSNU",74,0)
REINDEX ;Make sure APC xref is correct
"RTN","PSNPPSNU",75,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",6)="REINDEX"
"RTN","PSNPPSNU",76,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSNU",77,0)
 K FDA
"RTN","PSNPPSNU",78,0)
 N SUB,DA,DIK,GMRAIEN,CLASS
"RTN","PSNPPSNU",79,0)
 S SUB=0 F  S SUB=$O(^GMR(120.8,SUB)) Q:'+SUB  I $D(^GMR(120.8,SUB,3)) D
"RTN","PSNPPSNU",80,0)
 .S GMRAIEN=+$P($G(^GMR(120.8,SUB,0)),U) Q:'GMRAIEN
"RTN","PSNPPSNU",81,0)
 .S CLASS="" F  S CLASS=$O(^GMR(120.8,"APC",GMRAIEN,CLASS)) Q:CLASS=""  K ^GMR(120.8,"APC",GMRAIEN,CLASS,SUB)
"RTN","PSNPPSNU",82,0)
 .S DA(1)=SUB
"RTN","PSNPPSNU",83,0)
 .S DIK="^GMR(120.8,DA(1),3,"
"RTN","PSNPPSNU",84,0)
 .S DIK(1)=".01^ADRG3"
"RTN","PSNPPSNU",85,0)
 .D ENALL^DIK ;Reset the drug class xref
"RTN","PSNPPSNU",86,0)
 ;
"RTN","PSNPPSNU",87,0)
MORE ; REINDEXING
"RTN","PSNPPSNU",88,0)
 D CTRKDL^PSNPPSMS("Reindexing")
"RTN","PSNPPSNU",89,0)
 ;now the APD
"RTN","PSNPPSNU",90,0)
 K ^PS(50.416,"APD") S DA=0 F  S DA=$O(^PS(50.416,DA)),K=0 Q:'DA  F  S K=$O(^PS(50.416,DA,1,K)) Q:'K  S X=^(K,0),^PS(50.416,"APD",X,DA)=""
"RTN","PSNPPSNU",91,0)
 ;now the interactions
"RTN","PSNPPSNU",92,0)
 K ^PS(56,"APD") S DA=0 F  S DA=$O(^PS(56,DA)) Q:'DA  K PSN1,PSN2 S PSN1=$P(^(DA,0),"^",2),PSN2=$P(^(0),"^",3) D
"RTN","PSNPPSNU",93,0)
 .S NA="" F  S NA=$O(^PS(50.416,PSN1,1,"B",NA)) Q:NA=""  S PSN1(NA)=""
"RTN","PSNPPSNU",94,0)
 .S PSN11=0 F  S PSN11=$O(^PS(50.416,"APS",PSN1,PSN11)),NA="" Q:'PSN11  F  S NA=$O(^PS(50.416,PSN11,1,"B",NA)) Q:NA=""  S PSN1(NA)=""
"RTN","PSNPPSNU",95,0)
 .S NA="" F  S NA=$O(^PS(50.416,PSN2,1,"B",NA)) Q:NA=""  S PSN2(NA)=""
"RTN","PSNPPSNU",96,0)
 .S PSN21=0 F  S PSN21=$O(^PS(50.416,"APS",PSN2,PSN21)),NA="" Q:'PSN21  F  S NA=$O(^PS(50.416,PSN21,1,"B",NA)) Q:NA=""  S PSN2(NA)=""
"RTN","PSNPPSNU",97,0)
 .S PSN1="" F  S PSN1=$O(PSN1(PSN1)),PSN2="" Q:PSN1=""  F  S PSN2=$O(PSN2(PSN2)) Q:PSN2=""  S ^PS(56,"APD",PSN1,PSN2,DA)="",^PS(56,"APD",PSN2,PSN1,DA)=""
"RTN","PSNPPSNU",98,0)
 ;
"RTN","PSNPPSNU",99,0)
 D ^PSNPPSCL
"RTN","PSNPPSNU",100,0)
 D ERRORMS^PSNPPSMS
"RTN","PSNPPSNU",101,0)
 ;
"RTN","PSNPPSNU",102,0)
QUIT ;
"RTN","PSNPPSNU",103,0)
 ;D UPDATE^XPDID(XPDIDTOT)
"RTN","PSNPPSNU",104,0)
 K CL,CLA,CMOP,CT,DA,DA1,DIA,DIC,DIE,DIK,DINUM,DR,FDA,FILE,FLDS,GE,GROOT,GROOT1,IENS,IN,INA,IND,INDX,INV,J,JJ,K,LI,LINE,NA,NAME,ND,NEW,NFI,POST,PR,PSN,PSN1,PSN11,PSN21,PSNDF,R1,ROOT,ROOT1,ROOT2,ROOT3,SUBS,VAC,VAIN,VAPN
"RTN","PSNPPSNU",105,0)
 K X,XMDUZ,XMSUB,XMTEXT,XMY,XMZ,XUMF,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE
"RTN","PSNPPSNU",106,0)
 K ^TMP($J),^TMP("PSN",$J),^TMP("PSNN",$J),^TMP("PSN PPSN ERR",$J),^TMP("PSNINGRED",$J)
"RTN","PSNPPSNU",107,0)
 Q
"RTN","PSNPPSNU",108,0)
 ;
"RTN","PSNPPSNU",109,0)
ERROR ;Track file errors
"RTN","PSNPPSNU",110,0)
 D APPERROR^%ZTER("PPSN ERROR")
"RTN","PSNPPSNU",111,0)
 N PSNERRC,ERRFILE,ERRIEN
"RTN","PSNPPSNU",112,0)
 S PSNERROR=PSNERROR+1,PSNERRC=0,ERRFILE=0,ERRIEN=0
"RTN","PSNPPSNU",113,0)
 F  S PSNERRC=$O(ERROR("DIERR",PSNERRC)) Q:'PSNERRC  D:$D(ERROR("DIERR",PSNERRC,"TEXT",1))
"RTN","PSNPPSNU",114,0)
 .S ERRFILE=$G(ERROR("DIERR",PSNERRC,"PARAM","FILE")) S ERRIEN=$S("^351^352^311^"[("^"_$G(ERROR("DIERR",PSNERRC))_"^"):" ",1:$P(DIA,"^"))
"RTN","PSNPPSNU",115,0)
 .S ^TMP("PSN PPSN ERR",$J,PSNTMPN,$S($G(ERRFILE):ERRFILE,$G(FILE)'="":FILE,1:ROOT),ERRIEN,$P(DIA,"^",3),PSNERROR)=ERROR("DIERR",PSNERRC,"TEXT",1)_"|"_$S($G(FILE)'="":FILE,1:ROOT)_"-"_$P(DIA,"^",3)_"|"_NEW
"RTN","PSNPPSNU",116,0)
 Q
"RTN","PSNPPSNU",117,0)
 ;
"RTN","PSNPPSNU",118,0)
ERROR2(PSNERRN,PSNERRF,PSNERRIE,PSNERRFL,PSNERRTY) ;Track DICN errors
"RTN","PSNPPSNU",119,0)
 D APPERROR^%ZTER("PPSN ERROR2")
"RTN","PSNPPSNU",120,0)
 S PSNERROR=PSNERROR+1,PSNERRC=""
"RTN","PSNPPSNU",121,0)
 S ^TMP("PSN PPSN ERR",$J,PSNERRN,PSNERRF,PSNERRIE,PSNERRFL,PSNERRTY)=DIA_"^"_NEW
"RTN","PSNPPSNU",122,0)
 Q
"RTN","PSNPPSNU",123,0)
STRIP(X) ; Strip control characters
"RTN","PSNPPSNU",124,0)
 N I,Y
"RTN","PSNPPSNU",125,0)
 S Y="" F I=1:1:$L(X) S:$A(X,I)>31 Y=Y_$E(X,I)
"RTN","PSNPPSNU",126,0)
 Q Y
"RTN","PSNPPSNU",127,0)
 ;
"RTN","PSNPPSNU",128,0)
UNMDRG ; Unmatch Drug File entry
"RTN","PSNPPSNU",129,0)
 N PIECE,PRDNAM
"RTN","PSNPPSNU",130,0)
 S PRDNAM=$P(^PSDRUG(DA,"ND"),"^",2)
"RTN","PSNPPSNU",131,0)
 F PIECE=1:1:5,10,11 S $P(^PSDRUG(DA,"ND"),"^",PIECE)=""
"RTN","PSNPPSNU",132,0)
 I PRDNAM'="" S PRDNAM=$E(PRDNAM,1,30) K ^PSDRUG("VAPN",PRDNAM,DA)
"RTN","PSNPPSNU",133,0)
 Q
"RTN","PSNPPSNV")
0^4^B182428423^B179018356
"RTN","PSNPPSNV",1,0)
PSNPPSNV ;HP/MJE-PPSN update NDF data additional update code ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSNV",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513,563**; 30 Oct 98;Build 5
"RTN","PSNPPSNV",3,0)
 ;Reference to ^PS(59.7 supported by DBIA #2613
"RTN","PSNPPSNV",4,0)
 ;
"RTN","PSNPPSNV",5,0)
 Q
"RTN","PSNPPSNV",6,0)
DATA ;Process DATA transactions
"RTN","PSNPPSNV",7,0)
 K FDA
"RTN","PSNPPSNV",8,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",6)="DATA"
"RTN","PSNPPSNV",9,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSNV",10,0)
 K FDA
"RTN","PSNPPSNV",11,0)
 I '$D(^TMP("PSN PPSN PARSED",$J,"DATA")) Q
"RTN","PSNPPSNV",12,0)
 N DA,I,J,K,LINE,PSN,ROOT,X
"RTN","PSNPPSNV",13,0)
 S ROOT=$NA(^TMP("PSN PPSN PARSED",$J,"DATA")),J=0
"RTN","PSNPPSNV",14,0)
 F  S J=$O(@ROOT@(J)) Q:'J  S LINE=^(J),K=$L(LINE,"|")-1 F I=1:1:K S X=$P(LINE,"|",I),^TMP($J,$P(X,"^"))=$P(X,"^",2,4)
"RTN","PSNPPSNV",15,0)
 S DA=0 F  S DA=$O(^PSNDF(50.68,DA)) Q:'DA  S X=$P($G(^(DA,1)),"^",1,4) S:$D(^TMP($J,DA)) X=X_"^"_^(DA) S ^PSNDF(50.68,DA,1)=X
"RTN","PSNPPSNV",16,0)
 K ^TMP($J)
"RTN","PSNPPSNV",17,0)
 K DA,I,J,K,LINE,PSN,ROOT,X
"RTN","PSNPPSNV",18,0)
 Q
"RTN","PSNPPSNV",19,0)
 ;
"RTN","PSNPPSNV",20,0)
PMIUPDT ;Get PMI data and completly replace all globals 50.621-627
"RTN","PSNPPSNV",21,0)
 N FDA,DA,I,J,K,LINE,PSN,ROOT,X
"RTN","PSNPPSNV",22,0)
 S FDA(57.231,CTRLXIEN_","_CTRLIEN_",",6)="PMIDATA"
"RTN","PSNPPSNV",23,0)
 D UPDATE^DIE("","FDA","CTRLIEN")
"RTN","PSNPPSNV",24,0)
 N FDA,DA,I,J,K,LINE,PSN,X
"RTN","PSNPPSNV",25,0)
 I $D(^TMP("PSN PPSN PARSED",$J,"PMIDATA")) F PSN=50.621:.001:50.627 K ^PS(PSN)
"RTN","PSNPPSNV",26,0)
 S ROOT=$NA(^TMP("PSN PPSN PARSED",$J,"DATA")),J=0
"RTN","PSNPPSNV",27,0)
 K ^TMP($J)
"RTN","PSNPPSNV",28,0)
 F  S J=$O(@ROOT@(J)) Q:'J  S LINE=^(J),K=$L(LINE,"|")-1 F I=1:1:K S X=$P(LINE,"|",I),^TMP($J,$P(X,"^"))=$P(X,"^",2,4)
"RTN","PSNPPSNV",29,0)
 S DA=0 F  S DA=$O(^PSNDF(50.68,DA)) Q:'DA  S X=$P($G(^(DA,1)),"^",1,4) S:$D(^TMP($J,DA)) X=X_"^"_^(DA) S ^PSNDF(50.68,DA,1)=X
"RTN","PSNPPSNV",30,0)
 K ^TMP($J)
"RTN","PSNPPSNV",31,0)
 I $D(^TMP("PSN PPSN PARSED",$J,"PMIDATA")) F PSN=50.621:.001:50.627 M ^PS(PSN)=^TMP("PSN PPSN PARSED",$J,"PMIDATA",PSN)
"RTN","PSNPPSNV",32,0)
 K DA,I,J,K,LINE,PSN,ROOT,X
"RTN","PSNPPSNV",33,0)
 Q
"RTN","PSNPPSNV",34,0)
 ;
"RTN","PSNPPSNV",35,0)
TASKIT(FREQ,START) ; create/update PSNTUPDT option start time and frequency
"RTN","PSNPPSNV",36,0)
 ; Input:
"RTN","PSNPPSNV",37,0)
 ;   FREQ  - Optional
"RTN","PSNPPSNV",38,0)
 ;  START  - Optional
"RTN","PSNPPSNV",39,0)
 ;
"RTN","PSNPPSNV",40,0)
 K PSERROR
"RTN","PSNPPSNV",41,0)
 D NOW^%DTC S %DT(0)=%,%DT="EFATX",%DT("A")="Enter date/time: " D ^%DT
"RTN","PSNPPSNV",42,0)
 I (Y<0)!($D(DTOUT)) W !!,"No action taken!" D ENTER W @IOF Q
"RTN","PSNPPSNV",43,0)
 S START=$$FMADD^XLFDT(Y,0,0,5)
"RTN","PSNPPSNV",44,0)
 ;
"RTN","PSNPPSNV",45,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",46,0)
 S DIR("A")="Should this NDF update install be re-scheduled at the same time weekly" W !!
"RTN","PSNPPSNV",47,0)
 S DIR("B")="NO" D ^DIR I Y S FREQ="7D" G END
"RTN","PSNPPSNV",48,0)
 I $D(DIRUT) W !!,"No action taken!" D ENTER W @IOF Q
"RTN","PSNPPSNV",49,0)
 ;
"RTN","PSNPPSNV",50,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",51,0)
 S DIR("A")="Should this NDF update install be re-scheduled at the same time daily" W !!
"RTN","PSNPPSNV",52,0)
 S DIR("B")="NO" D ^DIR I Y S FREQ="1D" G END
"RTN","PSNPPSNV",53,0)
 I $D(DIRUT) W !!,"No action taken!" D ENTER W @IOF Q
"RTN","PSNPPSNV",54,0)
 I 'Y S FREQ="" W !!,"Warning! The download you have scheduled will occur only once."
"RTN","PSNPPSNV",55,0)
 ;
"RTN","PSNPPSNV",56,0)
END ;
"RTN","PSNPPSNV",57,0)
 I FREQ="" D RESCH^XUTMOPT("PSN TASK SCHEDULED INSTALL","@","","@")
"RTN","PSNPPSNV",58,0)
 W !,"Your start time is:"
"RTN","PSNPPSNV",59,0)
 D RESCH^XUTMOPT("PSN TASK SCHEDULED INSTALL",START,"",FREQ,"L",.PSERROR)
"RTN","PSNPPSNV",60,0)
 I +FREQ=1 W !!,"The NDF update install will automatically be re-scheduled Daily",!
"RTN","PSNPPSNV",61,0)
 I +FREQ=7 W !!,"The NDF update install will automatically be re-scheduled Weekly",!
"RTN","PSNPPSNV",62,0)
 I FREQ="" W !!,"The NDF update install will NOT automatically be re-scheduled",!
"RTN","PSNPPSNV",63,0)
 D ENTER W @IOF
"RTN","PSNPPSNV",64,0)
 Q
"RTN","PSNPPSNV",65,0)
 ;
"RTN","PSNPPSNV",66,0)
SCHDOPT ; edit option PSNTUPDT/PSN TASK SCHEDULE INSTALL to create and/or edit the scheduling date/time
"RTN","PSNPPSNV",67,0)
 ; Called from "PSN PPS SCHEDULE INSTALL" option to create and/or edit the scheduling
"RTN","PSNPPSNV",68,0)
 N PSNLEGF
"RTN","PSNPPSNV",69,0)
 I '$D(^XUSEC("PSN PPS ADMIN",DUZ)) D
"RTN","PSNPPSNV",70,0)
 .W !!,"You do not have the appropriate security key to use this option"
"RTN","PSNPPSNV",71,0)
 .W !,"please contact your ADPAC to resolve this issue.",!
"RTN","PSNPPSNV",72,0)
 .S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",73,0)
 I '$D(^XUSEC("PSN PPS ADMIN",DUZ)) Q
"RTN","PSNPPSNV",74,0)
 S PSNLEGF="",PSNLEGF=$$LEGACY^PSNPPSDL() I PSNLEGF Q
"RTN","PSNPPSNV",75,0)
 W !!!,"This option allows you to schedule a recurring TaskMan job to perform the NDF"
"RTN","PSNPPSNV",76,0)
 W !,"update installation from PPS-N."
"RTN","PSNPPSNV",77,0)
 W !!,"Warning! This NDF update install should be scheduled during non-peak hours."
"RTN","PSNPPSNV",78,0)
 W !!,"You will need to select a date/time and how often this update should reoccur."
"RTN","PSNPPSNV",79,0)
 ;
"RTN","PSNPPSNV",80,0)
 D SCHCK^PSNPPSDL("PSN TASK SCHEDULED INSTALL","I") ; print scheduled tasks
"RTN","PSNPPSNV",81,0)
 ;
"RTN","PSNPPSNV",82,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",83,0)
 S DIR("A")="Do you want to schedule an automatic NDF update install in TaskMan" W !!
"RTN","PSNPPSNV",84,0)
 S DIR("B")="NO"
"RTN","PSNPPSNV",85,0)
 D ^DIR
"RTN","PSNPPSNV",86,0)
 I 'Y Q 
"RTN","PSNPPSNV",87,0)
 N PSSROOT
"RTN","PSNPPSNV",88,0)
 D TASKIT(15)
"RTN","PSNPPSNV",89,0)
 Q
"RTN","PSNPPSNV",90,0)
 ;
"RTN","PSNPPSNV",91,0)
PROMPT ;
"RTN","PSNPPSNV",92,0)
 W @IOF I '$D(^XUSEC("PSN PPS ADMIN",DUZ)) D
"RTN","PSNPPSNV",93,0)
 .W !!,"You do not have the appropriate security key to use this option"
"RTN","PSNPPSNV",94,0)
 .W !,"please contact your ADPAC to resolve this issue.",!
"RTN","PSNPPSNV",95,0)
 .S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",96,0)
 I '$D(^XUSEC("PSN PPS ADMIN",DUZ)) Q
"RTN","PSNPPSNV",97,0)
 W !!,"This option allows a user to setup the following PPS-N configuration settings:"
"RTN","PSNPPSNV",98,0)
 W !!,"1) The Cache host disk directory path that will be used for location of the"
"RTN","PSNPPSNV",99,0)
 W !,"   PPS-N weekly NDF update file/s."
"RTN","PSNPPSNV",100,0)
 W !!,"2) The last successful INSTALL version number of the PPS-N update file."
"RTN","PSNPPSNV",101,0)
 W !,"   This is the UPDT option version number."
"RTN","PSNPPSNV",102,0)
 W !!,"3) The last successful DOWNLOAD version number of the PPS-N update file."
"RTN","PSNPPSNV",103,0)
 W !,"   This is the DNLD option version number."
"RTN","PSNPPSNV",104,0)
 W !!,"4) The Exchange email Group or Individual email address that the PPS-N national"
"RTN","PSNPPSNV",105,0)
 W !,"   and locally generated reports will be sent to."
"RTN","PSNPPSNV",106,0)
 W !!,"5) The PPS-N mail group for the PPSN NATIONAL TEST SQA email status."
"RTN","PSNPPSNV",107,0)
 W !!,"6) The Scheduled Options, Menu Options, and Protocols that should be paused"
"RTN","PSNPPSNV",108,0)
 W !,"   while the PPS-n update file is processed."
"RTN","PSNPPSNV",109,0)
 W !!,"7) The PPS-N NATIONAL SQA ACCOUNT (Q)A, (P)roduction, Product (S)upport"
"RTN","PSNPPSNV",110,0)
 W !,"    or (T)est."
"RTN","PSNPPSNV",111,0)
 W !
"RTN","PSNPPSNV",112,0)
 W ! K DIR S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",113,0)
 Q:Y="^"!(Y=0)
"RTN","PSNPPSNV",114,0)
 W @IOF,!!
"RTN","PSNPPSNV",115,0)
 W !,"At the prompt please enter the specific VMS or Linux directory path name"
"RTN","PSNPPSNV",116,0)
 W !,"where the PPS-N update file/s will be located. If you are not familiar with"
"RTN","PSNPPSNV",117,0)
 W !,"the required information please consult your ADPAC."
"RTN","PSNPPSNV",118,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",119,0)
 S DIR("A")="Do you want to change the disk directory path for PPS-N Update files" W !
"RTN","PSNPPSNV",120,0)
 S DIR("B")="NO"
"RTN","PSNPPSNV",121,0)
 D ^DIR
"RTN","PSNPPSNV",122,0)
 Q:Y="^"
"RTN","PSNPPSNV",123,0)
 I Y D PATH
"RTN","PSNPPSNV",124,0)
 ;
"RTN","PSNPPSNV",125,0)
UPDT ;
"RTN","PSNPPSNV",126,0)
 W @IOF,!!!,"At the prompt you can change the last successful update version number"
"RTN","PSNPPSNV",127,0)
 W !,"of the PPS-N update file.  This is for the UPDT option."
"RTN","PSNPPSNV",128,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",129,0)
 S DIR("A")="Do you want to change the version number of the PPS-N Update files" W !
"RTN","PSNPPSNV",130,0)
 S DIR("B")="NO"
"RTN","PSNPPSNV",131,0)
 D ^DIR
"RTN","PSNPPSNV",132,0)
 Q:Y="^"
"RTN","PSNPPSNV",133,0)
 I Y D INSTV
"RTN","PSNPPSNV",134,0)
 K DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSNV",135,0)
DNLD ;
"RTN","PSNPPSNV",136,0)
 W @IOF,!!!,"At the prompt you can change the last successful DOWNLOAD version number"
"RTN","PSNPPSNV",137,0)
 W !,"of the PPS-N update file.  This is for the DNLD option."
"RTN","PSNPPSNV",138,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",139,0)
 S DIR("A")="Do you want to change the DOWNLOAD version number of the PPS-N files" W !
"RTN","PSNPPSNV",140,0)
 S DIR("B")="NO"
"RTN","PSNPPSNV",141,0)
 D ^DIR
"RTN","PSNPPSNV",142,0)
 Q:Y="^"
"RTN","PSNPPSNV",143,0)
 I Y D DNLDV
"RTN","PSNPPSNV",144,0)
 K DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSNV",145,0)
DEMAIL ;
"RTN","PSNPPSNV",146,0)
 W @IOF,!!!,"At the prompt you can change the Exchange email Group or Individual"
"RTN","PSNPPSNV",147,0)
 W !,"email address that the PPS-N national and locally generated reports"
"RTN","PSNPPSNV",148,0)
 W !,"will be sent to."
"RTN","PSNPPSNV",149,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",150,0)
 S DIR("A")="Do you want to change the email address for the PPS-N update reports" W !
"RTN","PSNPPSNV",151,0)
 S DIR("B")="NO"
"RTN","PSNPPSNV",152,0)
 D ^DIR
"RTN","PSNPPSNV",153,0)
 Q:Y="^"
"RTN","PSNPPSNV",154,0)
 I Y D EMAIL
"RTN","PSNPPSNV",155,0)
 K DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSNV",156,0)
 ;
"RTN","PSNPPSNV",157,0)
 W @IOF,!!!,"At the prompt you can change the Exchange email Group or Individual"
"RTN","PSNPPSNV",158,0)
 W !,"email address that the PPS-N PPSN NATIONAL TEST SQA emails will be sent to."
"RTN","PSNPPSNV",159,0)
 K DIRUT,DUOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",160,0)
 S DIR("A")="Change the email address for the PPS-N PPSN NATIONAL TEST SQA emails" W !
"RTN","PSNPPSNV",161,0)
 S DIR("B")="NO"
"RTN","PSNPPSNV",162,0)
 D ^DIR
"RTN","PSNPPSNV",163,0)
 Q:Y="^"
"RTN","PSNPPSNV",164,0)
 I Y D SQAMAIL
"RTN","PSNPPSNV",165,0)
 K DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSNV",166,0)
 ;
"RTN","PSNPPSNV",167,0)
 D DISOPTS^PSNPPSNR
"RTN","PSNPPSNV",168,0)
 K DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSNV",169,0)
TYPE ;
"RTN","PSNPPSNV",170,0)
 W @IOF,!!!,"At the prompt you can change the PPS-N NATIONAL SQA ACCOUNT"
"RTN","PSNPPSNV",171,0)
 K DIRUT,DUOUT,DTOUT,DIR,X,Y S DIR(0)="Y",DIR("?")="Please enter Y or N."
"RTN","PSNPPSNV",172,0)
 S DIR("A")="Do you want to change the PPS-N PPSN NATIONAL TEST SQA" W !
"RTN","PSNPPSNV",173,0)
 S DIR("B")="NO"
"RTN","PSNPPSNV",174,0)
 D ^DIR
"RTN","PSNPPSNV",175,0)
 Q:Y="^"!('Y)
"RTN","PSNPPSNV",176,0)
TYPE2 ;
"RTN","PSNPPSNV",177,0)
 N TYPE
"RTN","PSNPPSNV",178,0)
 S TYPE="",TYPE=$P($G(^PS(59.7,1,10)),"^",12)
"RTN","PSNPPSNV",179,0)
 W !!,"Your current PPS-N NATIONAL SQA ACCOUNT is set to: " W TYPE_" "_$S(TYPE="Q":"for National SQA Testing",TYPE="P":"for Production",TYPE="T":"for Test Account",TYPE="S":"for Product Support",1:"")
"RTN","PSNPPSNV",180,0)
 ;W !!,"Please enter PPS-N NATIONAL SQA ACCOUNT"
"RTN","PSNPPSNV",181,0)
TYPE3 ;
"RTN","PSNPPSNV",182,0)
 W !,"P = Production",?40,"T = Test Account"
"RTN","PSNPPSNV",183,0)
 W !,"S = Product Support",?40,"Q = QA National Testing"
"RTN","PSNPPSNV",184,0)
 W !,"N = QA NDFMS",!
"RTN","PSNPPSNV",185,0)
 R !,"Enter selection: ",X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSNPPSNV",186,0)
 I X["?" D  G TYPE2
"RTN","PSNPPSNV",187,0)
 .W !!?5,"This parameter determines if the system is SQA National Testing site,"
"RTN","PSNPPSNV",188,0)
 .W !?5,"Testing Account, Product Support or a Production site. Enter P for"
"RTN","PSNPPSNV",189,0)
 .W !,?5,"Production, T for Test Account, S for Product Support, Q for SQA"
"RTN","PSNPPSNV",190,0)
 .W !,?5,"National Testing or N for QA NDFMS account.",!
"RTN","PSNPPSNV",191,0)
 .W !!?5,"Local sites should define this parameter as P for Production or T for"
"RTN","PSNPPSNV",192,0)
 .W !?5,"their Test Account. Product support should use S. SQA National Testing"
"RTN","PSNPPSNV",193,0)
 .W !?5,"should team should have one account defined Q for QA, a different"
"RTN","PSNPPSNV",194,0)
 .w !?5,"account for P for Production, and another for N for QA NDFMS."
"RTN","PSNPPSNV",195,0)
 Q:X="^"
"RTN","PSNPPSNV",196,0)
 I ",S,Q,T,P,N,"'[(","_X_",") W !!,"You must enter P, T, S, Q or N",! G TYPE2
"RTN","PSNPPSNV",197,0)
 I X'=""&(X'="^")&($L(X)'=0) D
"RTN","PSNPPSNV",198,0)
 .S $P(^PS(59.7,1,10),"^",12)=X
"RTN","PSNPPSNV",199,0)
 .W !!,"You changed the PPS-N NATIONAL SQA ACCOUNT to: " W X
"RTN","PSNPPSNV",200,0)
 .W ! K DIR S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",201,0)
 K DIRUT,DUOUT,DIR,X,Y
"RTN","PSNPPSNV",202,0)
 Q
"RTN","PSNPPSNV",203,0)
 ;
"RTN","PSNPPSNV",204,0)
PATH ;
"RTN","PSNPPSNV",205,0)
 W !!,"Your current update file path is set to: ",$$GETD^PSNFTP()
"RTN","PSNPPSNV",206,0)
 W !!,"Please enter the complete directory path: " R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSNPPSNV",207,0)
 I X["?" D  G PATH
"RTN","PSNPPSNV",208,0)
 .W !!?5,"Enter the operating system full directory path where the PPS-N Update",!?5,"file(s) will be stored."
"RTN","PSNPPSNV",209,0)
 .W "  Refer to the NDF Technical manual and/or",!?5,"contact your IRM for more information."
"RTN","PSNPPSNV",210,0)
 .W !?10,"Example:  ABC$:[USER.PPSN]"
"RTN","PSNPPSNV",211,0)
 I X'=""&(X'="^")&(X'="?") D
"RTN","PSNPPSNV",212,0)
 .D SETD(X)
"RTN","PSNPPSNV",213,0)
 .W !!,"You changed the directory path to: " W X
"RTN","PSNPPSNV",214,0)
 .W ! K DIR S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",215,0)
 Q
"RTN","PSNPPSNV",216,0)
 ;
"RTN","PSNPPSNV",217,0)
INSTV ;
"RTN","PSNPPSNV",218,0)
 W !!,"Your current PPS-N INSTALL file version number is set to: " W:$D(^PS(57.23,1,0)) $P(^PS(57.23,1,0),"^",3) W !
"RTN","PSNPPSNV",219,0)
 W !,"Please enter the current PPS-N update file version number: " R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSNPPSNV",220,0)
 I X["?" D  G INSTV
"RTN","PSNPPSNV",221,0)
 .W !!?5,"Enter the last file version installed on the system. If the last file"
"RTN","PSNPPSNV",222,0)
 .W !?5,"name installed was PPS_15PRV_16NEW.DAT, the last file version would be 16."
"RTN","PSNPPSNV",223,0)
 I X'=""&(X'="^")&($L(X)'=0)&(X'="?") D
"RTN","PSNPPSNV",224,0)
 .S $P(^PS(57.23,1,0),"^",3)=X
"RTN","PSNPPSNV",225,0)
 .W !!,"You changed the INSTALL file version number to: " W X
"RTN","PSNPPSNV",226,0)
 .W ! K DIR S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",227,0)
 Q
"RTN","PSNPPSNV",228,0)
 ;
"RTN","PSNPPSNV",229,0)
DNLDV ;
"RTN","PSNPPSNV",230,0)
 W !!,"Your current PPS-N DOWNLOAD file version number is set to: " W:$D(^PS(57.23,1,0)) $P(^PS(57.23,1,0),"^",7) W !
"RTN","PSNPPSNV",231,0)
 W !,"Please enter the current PPS-N DOWNLOAD file version number: " R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSNPPSNV",232,0)
 I X["?" D  G DNLDV
"RTN","PSNPPSNV",233,0)
 .W !!?5,"Enter the last file version downloaded to the system. If the last file"
"RTN","PSNPPSNV",234,0)
 .W !?5,"name downloaded was PPS_15PRV_16NEW.DAT, the last file version would be 16."
"RTN","PSNPPSNV",235,0)
 I X'=""&(X'="^")&($L(X)'=0)&(X'="?") D
"RTN","PSNPPSNV",236,0)
 .S $P(^PS(57.23,1,0),"^",7)=X
"RTN","PSNPPSNV",237,0)
 .W !!,"You changed the DOWNLOAD file version number to: " W X
"RTN","PSNPPSNV",238,0)
 .W ! K DIR S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",239,0)
 Q
"RTN","PSNPPSNV",240,0)
 ;
"RTN","PSNPPSNV",241,0)
EMAIL ;
"RTN","PSNPPSNV",242,0)
 W !!,"Your current email address is set to: " W:$D(^PS(57.23,1,0)) $P($G(^PS(57.23,1,0)),"^",6) W !
"RTN","PSNPPSNV",243,0)
 W !,"Please enter the email address: " R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSNPPSNV",244,0)
 I X["?" D  G EMAIL
"RTN","PSNPPSNV",245,0)
 .W !!?5,"Enter an email address for receiving PPS-N download, install and error"
"RTN","PSNPPSNV",246,0)
 .W !?5,"messages.  This is typically an MS Outlook email address since holders "
"RTN","PSNPPSNV",247,0)
 .W !?5,"of the PSN PPS ADMIN key will continue to receive the NDF update messages."
"RTN","PSNPPSNV",248,0)
 .W !?5,"These messages include success, completion, error, and the report"
"RTN","PSNPPSNV",249,0)
 .W !?5,"messages like DATA UPDATE FROM NDF, etc."
"RTN","PSNPPSNV",250,0)
 I X'=""&(X'="^")&($L(X)'=0)&(X'="?") D
"RTN","PSNPPSNV",251,0)
 .S $P(^PS(57.23,1,0),"^",6)=X
"RTN","PSNPPSNV",252,0)
 .W !!,"You changed the email address to: " W X
"RTN","PSNPPSNV",253,0)
 .W ! K DIR S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",254,0)
 Q
"RTN","PSNPPSNV",255,0)
 ;
"RTN","PSNPPSNV",256,0)
SQAMAIL ;
"RTN","PSNPPSNV",257,0)
 W !!,"Your current email address is set to: " W:$D(^PS(57.23,1,1)) $P($G(^PS(57.23,1,1)),"^",1) W !
"RTN","PSNPPSNV",258,0)
 W !,"Please enter the email address: " R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSNPPSNV",259,0)
 I X["?" D  G SQAMAIL
"RTN","PSNPPSNV",260,0)
 .W !!?5,"Enter an email address for receiving PPS-N download, install and error"
"RTN","PSNPPSNV",261,0)
 .W !?5,"messages.  This is used by SQA for a secondary email group if needed."
"RTN","PSNPPSNV",262,0)
 .W !?5,"Typically an MS Outlook email address is defined since holders of the"
"RTN","PSNPPSNV",263,0)
 .W !?5,"PSN PPS ADMIN key will continue to receive the NDF update messages.  These"
"RTN","PSNPPSNV",264,0)
 .W !?5,"messages include success, completion, error, and the report messages like"
"RTN","PSNPPSNV",265,0)
 .W !?5," DATA UPDATE FROM NDF, etc."
"RTN","PSNPPSNV",266,0)
 I X'=""&(X'="^")&($L(X)'=0)&(X'="?") D
"RTN","PSNPPSNV",267,0)
 .S $P(^PS(57.23,1,1),"^",1)=X
"RTN","PSNPPSNV",268,0)
 .W !!,"You changed the email address to: " W X
"RTN","PSNPPSNV",269,0)
 .W ! K DIR S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",270,0)
 Q
"RTN","PSNPPSNV",271,0)
 ;
"RTN","PSNPPSNV",272,0)
LOAD ;GET DOSE STUFF
"RTN","PSNPPSNV",273,0)
 N DA1
"RTN","PSNPPSNV",274,0)
 S J=2,X=$G(^PSDRUG(DA,"DOS")) I $P(X,"^"),$D(^PS(50.607,+$P(X,"^",2),0)) S ^TMP($J,INDX,NA_"^"_DA_"^"_IN,J)="    STRENGTH: "_+X_"UNITS: "_$P(^PS(50.607,+$P(X,"^",2),0),"^"),J=J+1
"RTN","PSNPPSNV",275,0)
 I $O(^PSDRUG(DA,"DOS1",0)) S ^TMP($J,INDX,NA_"^"_DA_"^"_IN,J)="    POSSIBLE DOSES",^(J+1)="    DISP UNITS/DOSE     DOSE    PACKAGE   BCMA UNITS/DOSE",DA1=0,J=J+2 D
"RTN","PSNPPSNV",276,0)
 .F  S DA1=$O(^PSDRUG(DA,"DOS1",DA1)) Q:'DA1  S X=^(DA1,0),^TMP($J,INDX,NA_"^"_DA_"^"_IN,J)="    "_$J($P(X,"^"),4),$E(^(J),25)=$J($P(X,"^",2),4),$E(^(J),35)=$P(X,"^",3),$E(^(J),43)=$P(X,"^",4),J=J+1
"RTN","PSNPPSNV",277,0)
 I $O(^PSDRUG(DA,"DOS2",0)) S ^TMP($J,INDX,NA_"^"_DA_"^"_IN,J)="    LOCAL POSSIBLE DOSES",^(J+1)="    DOSE                                            PACKAGE   BCMA UNITS/DOSE",DA1=0,J=J+2 D
"RTN","PSNPPSNV",278,0)
 .F  S DA1=$O(^PSDRUG(DA,"DOS2",DA1)) Q:'DA1  S X=^(DA1,0),^TMP($J,INDX,NA_"^"_DA_"^"_IN,J)="    "_$P(X,"^"),$E(^(J),55)=$P(X,"^",2),$E(^(J),71)=$P(X,"^",3),J=J+1
"RTN","PSNPPSNV",279,0)
 Q
"RTN","PSNPPSNV",280,0)
 ;
"RTN","PSNPPSNV",281,0)
SETD(X) ;
"RTN","PSNPPSNV",282,0)
 N PSOSX
"RTN","PSNPPSNV",283,0)
 S PSOSX=$$GETOS^PSNFTP()
"RTN","PSNPPSNV",284,0)
 I PSOSX["VMS" S $P(^PS(57.23,1,0),U,2)=X Q
"RTN","PSNPPSNV",285,0)
 I PSOSX["LINUX" S $P(^PS(57.23,1,0),U,4)=X Q
"RTN","PSNPPSNV",286,0)
 Q
"RTN","PSNPPSNV",287,0)
 ;
"RTN","PSNPPSNV",288,0)
ENTER ; press enter key
"RTN","PSNPPSNV",289,0)
 K DIR
"RTN","PSNPPSNV",290,0)
 W ! S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSNPPSNV",291,0)
 Q
"RTN","PSNPPSNW")
0^5^B35107109^B35107109
"RTN","PSNPPSNW",1,0)
PSNPPSNW ;HP/MJE-PPSN update NDF data additional update code ; 05 Mar 2014  1:20 PM
"RTN","PSNPPSNW",2,0)
 ;;4.0;NATIONAL DRUG FILE;**513,563**; 30 Oct 98;Build 5
"RTN","PSNPPSNW",3,0)
 ;
"RTN","PSNPPSNW",4,0)
 ;Reference to ^PSSREF supported by DBIA #6371
"RTN","PSNPPSNW",5,0)
 ;Reference to ^PSDRUG supported by DBIA #221
"RTN","PSNPPSNW",6,0)
 ;Reference to ^PSSUTIL supported by DBIA #3107
"RTN","PSNPPSNW",7,0)
 ;Reference to ^PS(59.7 supported by DBIA #2613
"RTN","PSNPPSNW",8,0)
 ;
"RTN","PSNPPSNW",9,0)
REMATCH(DA,PSNFNM) ;called by PSNPPSNU
"RTN","PSNPPSNW",10,0)
 ;DA & DISPDRG are both local drug IEN
"RTN","PSNPPSNW",11,0)
 ;PSNFNM is IEN of NDF (50.68) entry to match to
"RTN","PSNPPSNW",12,0)
 N DISPDRG S DISPDRG=""
"RTN","PSNPPSNW",13,0)
 ;
"RTN","PSNPPSNW",14,0)
 S DISPDRG=DA
"RTN","PSNPPSNW",15,0)
 ;-vvvvvvvvv- from PSSDEE -vvvvvvvvv-
"RTN","PSNPPSNW",16,0)
 ;
"RTN","PSNPPSNW",17,0)
 N FLGNDF,K,NEWDF,NFI,NFR,NWND,NWPC1,NWPC3,OLDDF,PSNCLASS,PSNFL,PSNLOC,PSNNDF,PSNNEW,PSNOLD,PSNP,PSNPST,PSNSIZE
"RTN","PSNPPSNW",18,0)
 N PSNTYPE,PSNVADC,PSNW,VAID,REC
"RTN","PSNPPSNW",19,0)
ASKND ;  
"RTN","PSNPPSNW",20,0)
 D RSET,EN1(PSNFNM,DA)
"RTN","PSNPPSNW",21,0)
 D REACT S DA=DISPDRG I $D(^PSDRUG(DA,"ND")),$P(^PSDRUG(DA,"ND"),"^",2)]"" D
"RTN","PSNPPSNW",22,0)
 .S PSNP=$G(^PSDRUG(DA,"I")) I PSNP,PSNP<DT Q
"RTN","PSNPPSNW",23,0)
 .S NWND=^PSDRUG(DA,"ND"),NWPC1=$P(NWND,"^",1),NWPC3=$P(NWND,"^",3),DA=NWPC1,K=NWPC3 S X=$$PSJDF^PSNAPIS(DA,K) S NEWDF=$P(X,"^",2),DA=DISPDRG
"RTN","PSNPPSNW",24,0)
 .; changed PSSUTIL call 2nd argument to use 0 instead of 1 ('quiet' mode)
"RTN","PSNPPSNW",25,0)
 .D EN2^PSSUTIL(DISPDRG,0) S:'$D(OLDDF) OLDDF="" I OLDDF'=NEWDF S FLGNDF=1
"RTN","PSNPPSNW",26,0)
 .N X,Y,Z D
"RTN","PSNPPSNW",27,0)
 ..S X=$P($G(^PSDRUG(DISPDRG,0)),"^") Q:X=""
"RTN","PSNPPSNW",28,0)
 ..S Y=$G(^PSNDF(50.68,PSNFNM,1)),Z=$P(Y,"^",2),Y=$P(Y,"^")
"RTN","PSNPPSNW",29,0)
 ..S ^TMP($J,"REMATCHED",X)=Y_"^"_Z_"^"_DISPDRG_"^"_PSNFNM
"RTN","PSNPPSNW",30,0)
 Q
"RTN","PSNPPSNW",31,0)
 ;
"RTN","PSNPPSNW",32,0)
 ;-vvvvvvvvv- from PSSDEE1 -vvvvvvvvv-
"RTN","PSNPPSNW",33,0)
 ;
"RTN","PSNPPSNW",34,0)
RSET ;
"RTN","PSNPPSNW",35,0)
 S:$D(^PSDRUG(DA,"ND")) PSNID=$P(^PSDRUG(DA,"ND"),"^",10)
"RTN","PSNPPSNW",36,0)
 S PSNP=$G(^PSDRUG(DA,"I")) I PSNP,PSNP<DT Q:$D(^PSDRUG(DA,"I"))
"RTN","PSNPPSNW",37,0)
 S DA=DISPDRG D:$D(^PSDRUG(DA,"ND")) SETNULL  S:$D(^PSDRUG(DA,3)) $P(^PSDRUG(DA,3),"^",1)=0 K:$D(^PSDRUG("AQ",DA)) ^PSDRUG("AQ",DA)
"RTN","PSNPPSNW",38,0)
 I $D(PSNID),PSNID]"" K ^PSDRUG("AQ1",PSNID,DA) K PSNID
"RTN","PSNPPSNW",39,0)
 D ^PSSREF ; *OK
"RTN","PSNPPSNW",40,0)
 Q
"RTN","PSNPPSNW",41,0)
 ;
"RTN","PSNPPSNW",42,0)
SETNULL ;
"RTN","PSNPPSNW",43,0)
 S ZXZX=$P(^PSDRUG(DA,"ND"),"^",2),$P(^PSDRUG(DA,"ND"),"^",1)="",$P(^PSDRUG(DA,"ND"),"^",2)="",$P(^PSDRUG(DA,"ND"),"^",3)=""
"RTN","PSNPPSNW",44,0)
 S $P(^PSDRUG(DA,"ND"),"^",4)="",$P(^PSDRUG(DA,"ND"),"^",5)="",$P(^PSDRUG(DA,"ND"),"^",10)=""
"RTN","PSNPPSNW",45,0)
 I ZXZX]"" S ZXZX=$E(ZXZX,1,30) I $D(^PSDRUG("VAPN",ZXZX,DA)) K ^PSDRUG("VAPN",ZXZX,DA) K ZXZX
"RTN","PSNPPSNW",46,0)
 Q
"RTN","PSNPPSNW",47,0)
 ;
"RTN","PSNPPSNW",48,0)
 ;-vvvvvvvvv- from PSSUTIL -vvvvvvvvv-
"RTN","PSNPPSNW",49,0)
 ;
"RTN","PSNPPSNW",50,0)
EN1(PSNDIEN,PSN50IEN) ;Receive Drug entries that have been unmatched
"RTN","PSNPPSNW",51,0)
 N PSSLD,PSSPWXEX,X,DIC,DA
"RTN","PSNPPSNW",52,0)
 I PSNPS="N" S DIC="^NDFK(5000.2,",DIC(0)="LMXZ",X="",X=PSNDIEN K DD,DO D FILE^DICN D ERROR^PSNPPSNU:$D(ERROR("DIERR"))
"RTN","PSNPPSNW",53,0)
 Q:PSN50IEN=""
"RTN","PSNPPSNW",54,0)
 K ^PSDRUG(PSN50IEN,"DOS"),^PSDRUG(PSN50IEN,"DOS1")
"RTN","PSNPPSNW",55,0)
 K ^PSDRUG(PSN50IEN,"DOS2")
"RTN","PSNPPSNW",56,0)
 Q
"RTN","PSNPPSNW",57,0)
 ;
"RTN","PSNPPSNW",58,0)
 ;-vvvvvvvvv- from PSNOUT -vvvvvvvvv-
"RTN","PSNPPSNW",59,0)
 ;
"RTN","PSNPPSNW",60,0)
REACT ; code for reactivation of inactive drug in local drug file
"RTN","PSNPPSNW",61,0)
 I $O(^PSNDF(50.6,0)) S XX=$S('$D(^PSDRUG(DA,"ND")):1,1:$P(^("ND"),"^",2)="") I XX D
"RTN","PSNPPSNW",62,0)
 .;BLDIT^PSNCOMP is the heart of the matching, GONE is okay
"RTN","PSNPPSNW",63,0)
 .S (PSNB,PSNDRG,Z9)=DA,PSNLOC=$P(^PSDRUG(PSNB,0),"^",1) K ^PSNTRAN(PSNB) D GONE^PSNDRUG,BLDIT
"RTN","PSNPPSNW",64,0)
 .;CHK is below (needs cleaning - DONE), SET^PSNMRG & GONE are okay
"RTN","PSNPPSNW",65,0)
 .S DA=Z9 D CHK(DA),SET^PSNMRG,GONE^PSNDRUG K Z9,XX
"RTN","PSNPPSNW",66,0)
 Q
"RTN","PSNPPSNW",67,0)
 ;
"RTN","PSNPPSNW",68,0)
 ;-vvvvvvvvv- from PSNCOMP -vvvvvvvvv-
"RTN","PSNPPSNW",69,0)
 ;
"RTN","PSNPPSNW",70,0)
BLDIT ; START ATTEMPT TO MATCH
"RTN","PSNPPSNW",71,0)
 Q:'$D(^PSDRUG(PSNB,0))  Q:$P(^PSDRUG(PSNB,0),"^",1)']""
"RTN","PSNPPSNW",72,0)
 I $D(^PSDRUG(PSNB,"ND")),$P(^PSDRUG(PSNB,"ND"),"^",2)]"" Q
"RTN","PSNPPSNW",73,0)
 I $D(PSNFLB),$D(^PSNTRAN(PSNB,0)) Q
"RTN","PSNPPSNW",74,0)
 S XX=PSNFNM D KILL^PSNHIT S PSNFNM=XX K XX
"RTN","PSNPPSNW",75,0)
 ;*****  next line:  DEA check: implemented silent
"RTN","PSNPPSNW",76,0)
 D  Q:$D(PSNINACT)  Q:'$D(PSNDEA)  K PSNDEA
"RTN","PSNPPSNW",77,0)
 .K PSNINACT I $D(^PSDRUG(PSNB,"I")),$P(^PSDRUG(PSNB,"I"),"^",1)]"" S:+^PSDRUG(PSNB,"I")<DT PSNINACT=1
"RTN","PSNPPSNW",78,0)
 .S PSNDEA=$P(^PSDRUG(PSNB,0),"^",3)
"RTN","PSNPPSNW",79,0)
 .F VV=0,"I","M" I PSNDEA[VV S ^PSNTRAN(PSNB,0)="0^^^^^^^"_DUZ K VV,PSNDEA Q
"RTN","PSNPPSNW",80,0)
 .K VV Q
"RTN","PSNPPSNW",81,0)
 S PSNSIZE=$O(^PS(50.609,"B","OTHER",0)),PSNTYPE=$O(^PS(50.608,"B","OTHER",0))
"RTN","PSNPPSNW",82,0)
 S PSNNDF=$P(^PSNDF(50.68,PSNFNM,0),"^",2),PSNCLASS=$P(^PSNDF(50.68,PSNFNM,3),"^") ; GEN NM, CLASS
"RTN","PSNPPSNW",83,0)
 D SET
"RTN","PSNPPSNW",84,0)
 Q
"RTN","PSNPPSNW",85,0)
 ;-vvvvvvvvv- from PSNHIT -vvvvvvvvv- sets the match in ^PSNTRAN to be verified
"RTN","PSNPPSNW",86,0)
 ;
"RTN","PSNPPSNW",87,0)
SET S:'$D(^PSNTRAN(PSNB,0)) $P(^PSNTRAN(0),"^",4)=($P(^PSNTRAN(0),"^",4))+1,$P(^PSNTRAN(0),"^",3)=PSNB
"RTN","PSNPPSNW",88,0)
 S ^PSNTRAN(PSNB,0)=PSNNDF_"^"_PSNFNM_"^"_PSNCLASS_"^^"_PSNSIZE_"^^"_PSNTYPE_"^"_DUZ ;D PKI W:$D(IOF) @IOF 
"RTN","PSNPPSNW",89,0)
 S:'$D(PSNFL) PSNFL=0
"RTN","PSNPPSNW",90,0)
 Q
"RTN","PSNPPSNW",91,0)
 ;
"RTN","PSNPPSNW",92,0)
 ;
"RTN","PSNPPSNW",93,0)
 ;-vvvvvvvvv- from PSNVFY -vvvvvvvvv-
"RTN","PSNPPSNW",94,0)
 ;
"RTN","PSNPPSNW",95,0)
CHK(PSNB) ; 
"RTN","PSNPPSNW",96,0)
 I $D(PSNFL) Q:PSNFL
"RTN","PSNPPSNW",97,0)
 S PSNP=$G(^PSDRUG(PSNB,"I")) I PSNP,PSNP<DT K ^PSNTRAN(PSNB,0) Q
"RTN","PSNPPSNW",98,0)
 Q:'$D(^PSNTRAN(PSNB,0))  Q:$P(^PSNTRAN(PSNB,0),"^",9)="Y"  Q:'$P(^PSNTRAN(PSNB,0),"^",2)
"RTN","PSNPPSNW",99,0)
 S PSNPST=^PSNTRAN(PSNB,0),PSNOLD=$P(^PSDRUG(PSNB,0),U),PSNNEW=$P(^PSNDF(50.68,$P(PSNPST,"^",2),0),"^")
"RTN","PSNPPSNW",100,0)
 ; condensed from START^PSNVFY
"RTN","PSNPPSNW",101,0)
 S PSNW=1
"RTN","PSNPPSNW",102,0)
 S PSNVADC=$P(^PSNTRAN(PSNB,0),"^",3)
"RTN","PSNPPSNW",103,0)
 S NFI=$P($G(^PSNDF(50.68,PSNFNM,5)),"^"),NFR=$P($G(^PSNDF(50.68,PSNFNM,6,1,0)),"^")
"RTN","PSNPPSNW",104,0)
 S $P(^PSNTRAN(PSNB,0),"^",9)="Y",$P(^PSNTRAN(PSNB,0),"^",10)=DUZ
"RTN","PSNPPSNW",105,0)
 Q
"RTN","PSNPPSNW",106,0)
 ;
"RTN","PSNPPSNW",107,0)
REPORT ;
"RTN","PSNPPSNW",108,0)
 ;take data from ^TMP($J,"REMATCHED",GN_NM)= VA_PRT_NM ^ VA_PROD_ID
"RTN","PSNPPSNW",109,0)
 ;and put it into ^TMP("PSN PPSN PARSED",$J,"MESSAGE3",...
"RTN","PSNPPSNW",110,0)
 N NM,VANM,PSNDISPD,PSNVPRD,PSNVPRDN
"RTN","PSNPPSNW",111,0)
 N X S X="PPS-N Update File: "_$P(PSNHLD,";",1) D ADDLINE(X) S X="" D ADDLINE(X) ;add blank line after file name
"RTN","PSNPPSNW",112,0)
 I '$D(^TMP($J,"REMATCHED")) D MSGHDR(1) Q
"RTN","PSNPPSNW",113,0)
 D MSGHDR(0)
"RTN","PSNPPSNW",114,0)
 N X S (VANM,NM)="" F  S NM=$O(^TMP($J,"REMATCHED",NM)) Q:NM=""  D
"RTN","PSNPPSNW",115,0)
 .S VANM=$G(^TMP($J,"REMATCHED",NM)),VAID=$P(VANM,"^",2),PSNDISPD=$P(VANM,"^",3),PSNVPRD=$P(VANM,"^",4),VANM=$P(VANM,"^")
"RTN","PSNPPSNW",116,0)
 .S PSNVPRDN=$$GET1^DIQ(50.68,PSNVPRD,.01)
"RTN","PSNPPSNW",117,0)
 .S X="   "_NM_" ("_PSNDISPD_")" D ADDLINE(X)
"RTN","PSNPPSNW",118,0)
 .S X="    RE-MATCHED TO" D ADDLINE(X)
"RTN","PSNPPSNW",119,0)
 .S X="   "_VANM_"  ["_VAID_"]" D ADDLINE(X)
"RTN","PSNPPSNW",120,0)
 .S X="      "_PSNVPRDN_" ("_PSNVPRD_")" D ADDLINE(X)
"RTN","PSNPPSNW",121,0)
 .S X=" " D ADDLINE(X)
"RTN","PSNPPSNW",122,0)
 K ^TMP($J,"REMATCHED")
"RTN","PSNPPSNW",123,0)
 Q
"RTN","PSNPPSNW",124,0)
 ;
"RTN","PSNPPSNW",125,0)
MSGHDR(NONE) ;insert MESS3 header
"RTN","PSNPPSNW",126,0)
 N I,X
"RTN","PSNPPSNW",127,0)
 W !
"RTN","PSNPPSNW",128,0)
 F I=1:1 S X="HDRTXT+"_I,X=$T(@X) S X=$P(X,";",3) Q:X=""  D
"RTN","PSNPPSNW",129,0)
 .I 'NONE,X["[No re-matches]" Q
"RTN","PSNPPSNW",130,0)
 .D ADDLINE(X)
"RTN","PSNPPSNW",131,0)
 Q
"RTN","PSNPPSNW",132,0)
 ;
"RTN","PSNPPSNW",133,0)
ADDLINE(X) ;
"RTN","PSNPPSNW",134,0)
 N C
"RTN","PSNPPSNW",135,0)
 S (C,^TMP("PSN PPSN PARSED",$J,"MESSAGE3",0))=$G(^TMP("PSN PPSN PARSED",$J,"MESSAGE3",0))+1
"RTN","PSNPPSNW",136,0)
 S ^TMP("PSN PPSN PARSED",$J,"MESSAGE3",C)=X
"RTN","PSNPPSNW",137,0)
 Q
"RTN","PSNPPSNW",138,0)
 ;
"RTN","PSNPPSNW",139,0)
HDRTXT ;
"RTN","PSNPPSNW",140,0)
 ;;The following local drug entries have been re-matched to the National Drug File based on the recommendations of the PPSN management group.;
"RTN","PSNPPSNW",141,0)
 ;;If you do not agree with any of these re-matches you may re-match them locally.;
"RTN","PSNPPSNW",142,0)
 ;; ;
"RTN","PSNPPSNW",143,0)
 ;;   [No re-matches];
"RTN","PSNPPSNW",144,0)
 ;;;
"RTN","PSNPPSNW",145,0)
 ;
"RTN","PSNPPSNW",146,0)
 ;=============================
"RTN","PSNPPSNW",147,0)
 ;misc export stuff (unrelated)
"RTN","PSNPPSNW",148,0)
 ;=============================
"RTN","PSNPPSNW",149,0)
 Q
"VER")
8.0^22.2
"^DD",57.23,57.23,5,0)
PRIMARY PPS-N MAIL GROUP^FaX^^0;6^K:$L(X)>60!($L(X)<1) X
"^DD",57.23,57.23,5,.1)
Primary PPS-N Mail Group
"^DD",57.23,57.23,5,3)
Enter 1-60 characters for the primary individual or mail group that will receive the PPS-N Update file messages.
"^DD",57.23,57.23,5,21,0)
^.001^6^6^3170524^^^
"^DD",57.23,57.23,5,21,1,0)
This field is used to store the MS Outlook email group that
"^DD",57.23,57.23,5,21,2,0)
will receive a copy of the PPS-N update messages.  These 
"^DD",57.23,57.23,5,21,3,0)
messages include download and install information, Data Update
"^DD",57.23,57.23,5,21,4,0)
for NDF report message, Updated Interactions and FDA Med Guide,
"^DD",57.23,57.23,5,21,5,0)
Drugs Unmatched from National Drug file, Local Drugs Rematched
"^DD",57.23,57.23,5,21,6,0)
to NDF, Interactions and Allergies Updated, and error messages.
"^DD",57.23,57.23,5,"AUDIT")
y
"^DD",57.23,57.23,5,"DT")
3180405
"^DD",57.23,57.23,6,0)
SECONDARY MAIL GROUP^FaXJ60^^1;1^K:$L(X)>60!($L(X)<1) X
"^DD",57.23,57.23,6,.1)
Secondary PPS-N Mail group
"^DD",57.23,57.23,6,3)
Enter 1-60 characters for the secondary individual or mail group that will receive PPS-N Update file messages.
"^DD",57.23,57.23,6,21,0)
^.001^6^6^3170524^^
"^DD",57.23,57.23,6,21,1,0)
This field is used to store the secondary MS Outlook email group that 
"^DD",57.23,57.23,6,21,2,0)
will receive a copy of the PPS-N update messages.  These messages 
"^DD",57.23,57.23,6,21,3,0)
include download and install information, Data Update for NDF report
"^DD",57.23,57.23,6,21,4,0)
message, Updated Interactions and FDA Med Guide, Drugs Unmatched from
"^DD",57.23,57.23,6,21,5,0)
National Drug file, Local Drugs Rematched to NDF, Interactions and
"^DD",57.23,57.23,6,21,6,0)
Allergies Updated, and error messages.
"^DD",57.23,57.23,6,"AUDIT")
y
"^DD",57.23,57.23,6,"DT")
3180405
"BLD",9716,6)
^545
**END**
**END**

