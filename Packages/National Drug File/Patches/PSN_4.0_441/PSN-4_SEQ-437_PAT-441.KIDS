EMERGENCY Released PSN*4*441 SEQ #437
Extracted from mail message
**KIDS**:PSN*4.0*441^

**INSTALL NAME**
PSN*4.0*441
"BLD",10014,0)
PSN*4.0*441^NATIONAL DRUG FILE^0^3150908^y
"BLD",10014,1,0)
^^6^6^3150727^
"BLD",10014,1,1,0)
Patch PSN*4.0*441 addresses the following issue:
"BLD",10014,1,2,0)
 
"BLD",10014,1,3,0)
1. INC000001243262 - Tramadol, Clonazepam, and Diazepam patient allergies 
"BLD",10014,1,4,0)
with a Trade Name in the Reactant field need to be updated to account for 
"BLD",10014,1,5,0)
VA DRUG CLASS changes distributed with the September National Drug File 
"BLD",10014,1,6,0)
Data Update
"BLD",10014,4,0)
^9.64PA^^
"BLD",10014,6)
^301
"BLD",10014,6.3)
15
"BLD",10014,"INID")
y^n
"BLD",10014,"INIT")
EN^PSN441P
"BLD",10014,"KRN",0)
^9.67PA^779.2^20
"BLD",10014,"KRN",.4,0)
.4
"BLD",10014,"KRN",.401,0)
.401
"BLD",10014,"KRN",.402,0)
.402
"BLD",10014,"KRN",.403,0)
.403
"BLD",10014,"KRN",.5,0)
.5
"BLD",10014,"KRN",.84,0)
.84
"BLD",10014,"KRN",3.6,0)
3.6
"BLD",10014,"KRN",3.8,0)
3.8
"BLD",10014,"KRN",9.2,0)
9.2
"BLD",10014,"KRN",9.8,0)
9.8
"BLD",10014,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",10014,"KRN",9.8,"NM",1,0)
PSN441E^^0^B793571
"BLD",10014,"KRN",9.8,"NM",2,0)
PSN441P^^0^B14629287
"BLD",10014,"KRN",9.8,"NM","B","PSN441E",1)

"BLD",10014,"KRN",9.8,"NM","B","PSN441P",2)

"BLD",10014,"KRN",19,0)
19
"BLD",10014,"KRN",19.1,0)
19.1
"BLD",10014,"KRN",101,0)
101
"BLD",10014,"KRN",409.61,0)
409.61
"BLD",10014,"KRN",771,0)
771
"BLD",10014,"KRN",779.2,0)
779.2
"BLD",10014,"KRN",870,0)
870
"BLD",10014,"KRN",8989.51,0)
8989.51
"BLD",10014,"KRN",8989.52,0)
8989.52
"BLD",10014,"KRN",8994,0)
8994
"BLD",10014,"KRN","B",.4,.4)

"BLD",10014,"KRN","B",.401,.401)

"BLD",10014,"KRN","B",.402,.402)

"BLD",10014,"KRN","B",.403,.403)

"BLD",10014,"KRN","B",.5,.5)

"BLD",10014,"KRN","B",.84,.84)

"BLD",10014,"KRN","B",3.6,3.6)

"BLD",10014,"KRN","B",3.8,3.8)

"BLD",10014,"KRN","B",9.2,9.2)

"BLD",10014,"KRN","B",9.8,9.8)

"BLD",10014,"KRN","B",19,19)

"BLD",10014,"KRN","B",19.1,19.1)

"BLD",10014,"KRN","B",101,101)

"BLD",10014,"KRN","B",409.61,409.61)

"BLD",10014,"KRN","B",771,771)

"BLD",10014,"KRN","B",779.2,779.2)

"BLD",10014,"KRN","B",870,870)

"BLD",10014,"KRN","B",8989.51,8989.51)

"BLD",10014,"KRN","B",8989.52,8989.52)

"BLD",10014,"KRN","B",8994,8994)

"BLD",10014,"PRE")
PSN441E
"BLD",10014,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",10014,"QUES",0)
^9.62^^
"BLD",10014,"REQB",0)
^9.611^1^1
"BLD",10014,"REQB",1,0)
PSN*4.0*454^2
"BLD",10014,"REQB","B","PSN*4.0*454",1)

"INIT")
EN^PSN441P
"MBREQ")
0
"PKG",479,-1)
1^1
"PKG",479,0)
NATIONAL DRUG FILE^PSN^This is the National Drug File Package V 3.16
"PKG",479,20,0)
^9.402P^^
"PKG",479,22,0)
^9.49I^1^1
"PKG",479,22,1,0)
4.0
"PKG",479,22,1,"PAH",1,0)
441^3150908
"PKG",479,22,1,"PAH",1,1,0)
^^6^6^3150908
"PKG",479,22,1,"PAH",1,1,1,0)
Patch PSN*4.0*441 addresses the following issue:
"PKG",479,22,1,"PAH",1,1,2,0)
 
"PKG",479,22,1,"PAH",1,1,3,0)
1. INC000001243262 - Tramadol, Clonazepam, and Diazepam patient allergies 
"PKG",479,22,1,"PAH",1,1,4,0)
with a Trade Name in the Reactant field need to be updated to account for 
"PKG",479,22,1,"PAH",1,1,5,0)
VA DRUG CLASS changes distributed with the September National Drug File 
"PKG",479,22,1,"PAH",1,1,6,0)
Data Update
"PRE")
PSN441E
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSN441E")
0^1^B793571^n/a
"RTN","PSN441E",1,0)
PSN441E ;BIR/HW-Environment Check to make sure PSN*4.0*441 can be installed; 23 June 2015  3:18 PM
"RTN","PSN441E",2,0)
 ;;4.0;NATIONAL DRUG FILE;**441**; 30 Oct 98;Build 15
"RTN","PSN441E",3,0)
 ;Check if the data update required for this patch has been installed
"RTN","PSN441E",4,0)
 I $P($G(^PSNDF(50.68,23393,0)),"^")="TRAMADOL HCL 150MG CAP,SA"&($P($G(^PSNDF(50.68,23393,3)),"^")'=73) D  Q
"RTN","PSN441E",5,0)
 .W !!,"This patch shouldn't be installed until the correct Data Update patch is installed"
"RTN","PSN441E",6,0)
 .S XPDQUIT=1
"RTN","PSN441E",7,0)
 Q
"RTN","PSN441P")
0^2^B14629287^n/a
"RTN","PSN441P",1,0)
PSN441P ;BIR/HW-Post install routine to update Trade Name allergies - Class; 29 June 2015  3:18 PM
"RTN","PSN441P",2,0)
 ;;4.0;NATIONAL DRUG FILE;**441**; 30 Oct 98;Build 15
"RTN","PSN441P",3,0)
 ;Reference to UPDATE^GMRAUTL2 supported by DBIA #4667
"RTN","PSN441P",4,0)
 ;This routine will update patient allergies with a Trade Name in the Reactant field 
"RTN","PSN441P",5,0)
 ;based on the VA Generic and VA Drug Class(es) provided 
"RTN","PSN441P",6,0)
 Q
"RTN","PSN441P",7,0)
EN ;Call at entry point
"RTN","PSN441P",8,0)
 N PSNPRIEN,PSNTNCNT,PSNGIEN,PSNCLASS,PSNX,PSNDONTK,PSNVAPRD,MSG,PSNTRNAM,PSNDCIEN,XPDIDTOT
"RTN","PSN441P",9,0)
 S XPDIDTOT=63
"RTN","PSN441P",10,0)
 K ^TMP("PSNMSG",$J),^TMP("PSN441P",$J)
"RTN","PSN441P",11,0)
 S ^TMP("PSNMSG",$J,1,0)="Number of Patient Allergy entries by VA DRUG CLASS:"
"RTN","PSN441P",12,0)
 S ^TMP("PSNMSG",$J,2,0)=" "
"RTN","PSN441P",13,0)
 S ^TMP("PSNMSG",$J,3,0)="Before update:"
"RTN","PSN441P",14,0)
 S ^TMP("PSNMSG",$J,4,0)="CN103 - NON-OPIOID ANALGESICS:                         "_$$CNT("CN103")
"RTN","PSN441P",15,0)
 S ^TMP("PSNMSG",$J,5,0)="CN101 - OPIOID ANALGESICS:                             "_$$CNT("CN101")
"RTN","PSN441P",16,0)
 S ^TMP("PSNMSG",$J,6,0)=" "
"RTN","PSN441P",17,0)
 S ^TMP("PSNMSG",$J,7,0)="CN400 - ANTICONVULSANTS:                               "_$$CNT("CN400")
"RTN","PSN441P",18,0)
 S ^TMP("PSNMSG",$J,8,0)="CN302 - BENZODIAZEPINE DERIVATIVE SEDATIVES/HYPNOTICS: "_$$CNT("CN302")
"RTN","PSN441P",19,0)
 S PSNTNCNT=0
"RTN","PSN441P",20,0)
 S PSNVAGEN=3283,PSNOCL=72,PSNNCL=73 D UPDATE(PSNVAGEN,PSNOCL,PSNNCL,.PSNTNCNT) ;TRAMADOL (72 is CN103, 73 is CN101)
"RTN","PSN441P",21,0)
 S PSNVAGEN=4924,PSNOCL=72,PSNNCL=73 D UPDATE(PSNVAGEN,PSNOCL,PSNNCL,.PSNTNCNT) ;TRAMADOL/ACETAMINOPHEN (72 is CN103, 73 is CN101)
"RTN","PSN441P",22,0)
 S PSNVAGEN=3743,PSNOCL=72,PSNNCL=73 D UPDATE(PSNVAGEN,PSNOCL,PSNNCL,.PSNTNCNT) ;ACETAMINOPHEN/TRAMADOL (72 is CN103, 73 is CN101)
"RTN","PSN441P",23,0)
 S PSNVAGEN=161,PSNOCL=84,PSNNCL=83 D UPDATE(PSNVAGEN,PSNOCL,PSNNCL,.PSNTNCNT) ;CLONAZEPAM (84 is CN400, 83 is CN302)
"RTN","PSN441P",24,0)
 S PSNVAGEN=167,PSNOCL=84,PSNNCL=83 D UPDATE(PSNVAGEN,PSNOCL,PSNNCL,.PSNTNCNT) ;DIAZEPAM (84 is CN400, 83 is CN302)
"RTN","PSN441P",25,0)
 ;
"RTN","PSN441P",26,0)
 K ^TMP("PSN441P",$J)
"RTN","PSN441P",27,0)
 ;
"RTN","PSN441P",28,0)
 S ^TMP("PSNMSG",$J,9,0)=" "
"RTN","PSN441P",29,0)
 S ^TMP("PSNMSG",$J,10,0)=" "
"RTN","PSN441P",30,0)
 S ^TMP("PSNMSG",$J,11,0)="After update:"
"RTN","PSN441P",31,0)
 S ^TMP("PSNMSG",$J,12,0)="CN103 - NON-OPIOID ANALGESICS:                         "_$$CNT("CN103")
"RTN","PSN441P",32,0)
 S ^TMP("PSNMSG",$J,13,0)="CN101 - OPIOID ANALGESICS:                             "_$$CNT("CN101")
"RTN","PSN441P",33,0)
 S ^TMP("PSNMSG",$J,14,0)=" "
"RTN","PSN441P",34,0)
 S ^TMP("PSNMSG",$J,15,0)="CN400 - ANTICONVULSANTS:                               "_$$CNT("CN400")
"RTN","PSN441P",35,0)
 S ^TMP("PSNMSG",$J,16,0)="CN302 - BENZODIAZEPINE DERIVATIVE SEDATIVES/HYPNOTICS: "_$$CNT("CN302")
"RTN","PSN441P",36,0)
 ; 
"RTN","PSN441P",37,0)
 K PSNVAGEN,PSNOCL,PSNNCL
"RTN","PSN441P",38,0)
 Q
"RTN","PSN441P",39,0)
 ;
"RTN","PSN441P",40,0)
CNT(PSNCLASS) ;Count the number of Patient Allergy entries for a specific class
"RTN","PSN441P",41,0)
 N PSNA,PSNB,PSNC,PSNCNT
"RTN","PSN441P",42,0)
 S (PSNA,PSNB,PSNC,PSNCNT)=0
"RTN","PSN441P",43,0)
 F  S PSNA=$O(^GMR(120.8,"APC",PSNA)) Q:'PSNA  D
"RTN","PSN441P",44,0)
 .F  S PSNB=$O(^GMR(120.8,"APC",PSNA,PSNCLASS,PSNB)) Q:'PSNB  D
"RTN","PSN441P",45,0)
 ..F  S PSNC=$O(^GMR(120.8,"APC",PSNA,PSNCLASS,PSNB,PSNC)) Q:'PSNC  D
"RTN","PSN441P",46,0)
 ...S PSNCNT=PSNCNT+1
"RTN","PSN441P",47,0)
 Q PSNCNT
"RTN","PSN441P",48,0)
UPDATE(PSNVAGEN,PSNOCL,PSNNCL,PSNTNCNT) ;Find Trade Names and update Allergies 
"RTN","PSN441P",49,0)
 N CLASS
"RTN","PSN441P",50,0)
 S CLASS("D",PSNOCL)="" ;IEN of class to be deleted
"RTN","PSN441P",51,0)
 S CLASS("A",PSNNCL)="" ;IEN of class to be added
"RTN","PSN441P",52,0)
 S PSNPRIEN=0
"RTN","PSN441P",53,0)
 F  S PSNPRIEN=$O(^PSNDF(50.68,PSNPRIEN)) Q:'PSNPRIEN  D
"RTN","PSN441P",54,0)
 .I +$P($G(^PSNDF(50.68,PSNPRIEN,0)),"^",2)'=PSNVAGEN Q 
"RTN","PSN441P",55,0)
 .I +$G(^PSNDF(50.68,PSNPRIEN,3))'=PSNNCL Q 
"RTN","PSN441P",56,0)
 .S PSNGIEN=$P(^PSNDF(50.68,PSNPRIEN,0),"^",2)
"RTN","PSN441P",57,0)
 .S PSNDCIEN=0
"RTN","PSN441P",58,0)
 .F  S PSNDCIEN=$O(^PSNDF(50.68,"ANDC",PSNPRIEN,PSNDCIEN)) Q:'PSNDCIEN  D 
"RTN","PSN441P",59,0)
 ..S PSNTRNAM=$P($G(^PSNDF(50.67,PSNDCIEN,0)),"^",5)
"RTN","PSN441P",60,0)
 ..I $D(^TMP("PSN441P",$J,PSNGIEN,PSNTRNAM)) Q 
"RTN","PSN441P",61,0)
 ..S PSNX=PSNGIEN_";PSNDF(50.6,^"_PSNTRNAM
"RTN","PSN441P",62,0)
 ..S PSNDONTK=0,PSNVAPRD=0
"RTN","PSN441P",63,0)
 ..F  S PSNVAPRD=$O(^PSNDF(50.6,"APRO",PSNGIEN,PSNVAPRD)) Q:'PSNVAPRD  D 
"RTN","PSN441P",64,0)
 ...I $P(^PSNDF(50.68,PSNVAPRD,3),"^")=PSNOCL S PSNDONTK=1
"RTN","PSN441P",65,0)
 ..I PSNDONTK K CLASS("D")
"RTN","PSN441P",66,0)
 ..S PSNTNCNT=PSNTNCNT+1
"RTN","PSN441P",67,0)
 ..D BMES^XPDUTL("Updating Patient Allergies for "_PSNTRNAM)
"RTN","PSN441P",68,0)
 ..I $T(UPDATE^GMRAUTL2)]"" D UPDATE^GMRAUTL2(PSNX,,.CLASS)
"RTN","PSN441P",69,0)
 ..S ^TMP("PSN441P",$J,PSNGIEN,PSNTRNAM)=""
"RTN","PSN441P",70,0)
 ..D UPDATE^XPDID(PSNTNCNT)
"RTN","PSN441P",71,0)
 Q
"VER")
8.0^22.0
"BLD",10014,6)
^437
**END**
**END**

