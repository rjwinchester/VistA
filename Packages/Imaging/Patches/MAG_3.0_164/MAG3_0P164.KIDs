KIDS Distribution saved on Nov 11, 2016@13:03:38
VistA Imaging V3 - Patch 164 - DICOM Importer
**KIDS**:MAG*3.0*164^

**INSTALL NAME**
MAG*3.0*164
"BLD",8347,0)
MAG*3.0*164^IMAGING^0^3161111^y
"BLD",8347,1,0)
^^13^13^3161111^
"BLD",8347,1,1,0)
VistA Imaging V3 - Patch 164 - DICOM Importer Maintenance
"BLD",8347,1,2,0)
 
"BLD",8347,1,3,0)
Patch 164 DICOM/IMPORTER Maintenance
"BLD",8347,1,4,0)
 - This patch handles some bug fix
"BLD",8347,1,5,0)
 
"BLD",8347,1,6,0)
Routine: MAGVIM05
"BLD",8347,1,7,0)
Routine: MAGVIM10
"BLD",8347,1,8,0)
Routine: MAGVIMRA
"BLD",8347,1,9,0)
Routine: MAGIP164
"BLD",8347,1,10,0)
 
"BLD",8347,1,11,0)
 
"BLD",8347,1,12,0)
 
"BLD",8347,1,13,0)
Note: routine MAGIP164 is deleted after the KIDS Build is installed
"BLD",8347,4,0)
^9.64PA^^0
"BLD",8347,6.3)
35
"BLD",8347,"ABNS",0)
^9.66A^^
"BLD",8347,"ABPKG")
n^n^G.IMAGING DEVELOPMENT TEAM@domain.ext
"BLD",8347,"INI")
PRE^MAGIP164
"BLD",8347,"INID")
n^y^n
"BLD",8347,"INIT")
POS^MAGIP164
"BLD",8347,"KRN",0)
^9.67PA^779.2^20
"BLD",8347,"KRN",.4,0)
.4
"BLD",8347,"KRN",.4,"NM",0)
^9.68A^^
"BLD",8347,"KRN",.401,0)
.401
"BLD",8347,"KRN",.402,0)
.402
"BLD",8347,"KRN",.403,0)
.403
"BLD",8347,"KRN",.5,0)
.5
"BLD",8347,"KRN",.84,0)
.84
"BLD",8347,"KRN",3.6,0)
3.6
"BLD",8347,"KRN",3.8,0)
3.8
"BLD",8347,"KRN",9.2,0)
9.2
"BLD",8347,"KRN",9.8,0)
9.8
"BLD",8347,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",8347,"KRN",9.8,"NM",1,0)
MAGVIM05^^0^B145735310
"BLD",8347,"KRN",9.8,"NM",2,0)
MAGVIM10^^0^B25335221
"BLD",8347,"KRN",9.8,"NM",3,0)
MAGVIMRA^^0^B26121368
"BLD",8347,"KRN",9.8,"NM",4,0)
MAGIP164^^0^B4110414
"BLD",8347,"KRN",9.8,"NM","B","MAGIP164",4)

"BLD",8347,"KRN",9.8,"NM","B","MAGVIM05",1)

"BLD",8347,"KRN",9.8,"NM","B","MAGVIM10",2)

"BLD",8347,"KRN",9.8,"NM","B","MAGVIMRA",3)

"BLD",8347,"KRN",19,0)
19
"BLD",8347,"KRN",19,"NM",0)
^9.68A^^
"BLD",8347,"KRN",19.1,0)
19.1
"BLD",8347,"KRN",101,0)
101
"BLD",8347,"KRN",409.61,0)
409.61
"BLD",8347,"KRN",771,0)
771
"BLD",8347,"KRN",779.2,0)
779.2
"BLD",8347,"KRN",870,0)
870
"BLD",8347,"KRN",8989.51,0)
8989.51
"BLD",8347,"KRN",8989.52,0)
8989.52
"BLD",8347,"KRN",8994,0)
8994
"BLD",8347,"KRN","B",.4,.4)

"BLD",8347,"KRN","B",.401,.401)

"BLD",8347,"KRN","B",.402,.402)

"BLD",8347,"KRN","B",.403,.403)

"BLD",8347,"KRN","B",.5,.5)

"BLD",8347,"KRN","B",.84,.84)

"BLD",8347,"KRN","B",3.6,3.6)

"BLD",8347,"KRN","B",3.8,3.8)

"BLD",8347,"KRN","B",9.2,9.2)

"BLD",8347,"KRN","B",9.8,9.8)

"BLD",8347,"KRN","B",19,19)

"BLD",8347,"KRN","B",19.1,19.1)

"BLD",8347,"KRN","B",101,101)

"BLD",8347,"KRN","B",409.61,409.61)

"BLD",8347,"KRN","B",771,771)

"BLD",8347,"KRN","B",779.2,779.2)

"BLD",8347,"KRN","B",870,870)

"BLD",8347,"KRN","B",8989.51,8989.51)

"BLD",8347,"KRN","B",8989.52,8989.52)

"BLD",8347,"KRN","B",8994,8994)

"BLD",8347,"PRET")

"BLD",8347,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",8347,"QUES",0)
^9.62^^
"BLD",8347,"REQB",0)
^9.611^1^1
"BLD",8347,"REQB",1,0)
MAG*3.0*138^2
"BLD",8347,"REQB","B","MAG*3.0*138",1)

"INI")
PRE^MAGIP164
"INIT")
POS^MAGIP164
"MBREQ")
0
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging-V1 to release 
"PKG",454,20,0)
^9.402P^^
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020319^3020517^126
"PKG",454,22,1,"PAH",1,0)
164^3161111^126
"PKG",454,22,1,"PAH",1,1,0)
^^13^13^3161111
"PKG",454,22,1,"PAH",1,1,1,0)
VistA Imaging V3 - Patch 164 - DICOM Maintenance G
"PKG",454,22,1,"PAH",1,1,2,0)
MaintenanceDICOM Maintence
"PKG",454,22,1,"PAH",1,1,3,0)
Patch 164 DICOM/IMPORTER Maintenance
"PKG",454,22,1,"PAH",1,1,4,0)
 - This patch handles some bug fix
"PKG",454,22,1,"PAH",1,1,5,0)
 
"PKG",454,22,1,"PAH",1,1,6,0)
Routine: MAGVIM05
"PKG",454,22,1,"PAH",1,1,7,0)
Routine: MAGVIM10
"PKG",454,22,1,"PAH",1,1,8,0)
Routine: MAGVIMRA
"PKG",454,22,1,"PAH",1,1,9,0)
Routine: MAGIP164
"PKG",454,22,1,"PAH",1,1,10,0)
 
"PKG",454,22,1,"PAH",1,1,11,0)
 
"PKG",454,22,1,"PAH",1,1,12,0)
 
"PKG",454,22,1,"PAH",1,1,13,0)
Note: routine MAGIP164 is deleted after the KIDS Build is installed
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","MAGIP164")
0^4^B4110414
"RTN","MAGIP164",1,0)
MAGIP164 ;WOIFO/DAC - Install code for MAG*3.0*164 DICOM ; 04 Nov 2016 10:05 AM
"RTN","MAGIP164",2,0)
 ;;3.0;IMAGING;**164**;Nov 04, 2016;Build 35
"RTN","MAGIP164",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIP164",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP164",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIP164",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIP164",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIP164",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIP164",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIP164",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIP164",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIP164",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIP164",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIP164",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIP164",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIP164",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP164",17,0)
 ;;
"RTN","MAGIP164",18,0)
 ; There are no environment checks here but the MAGIP164 has to be
"RTN","MAGIP164",19,0)
 ; referenced by the "Environment Check Routine" field of the KIDS
"RTN","MAGIP164",20,0)
 ; build so that entry points of the routine are available to the
"RTN","MAGIP164",21,0)
 ; KIDS during all installation phases.
"RTN","MAGIP164",22,0)
 Q
"RTN","MAGIP164",23,0)
 ;
"RTN","MAGIP164",24,0)
 ;+++++ INSTALLATION ERROR HANDLING
"RTN","MAGIP164",25,0)
ERROR ;
"RTN","MAGIP164",26,0)
 S:$D(XPDNM) XPDABORT=1
"RTN","MAGIP164",27,0)
 ;--- Display the messages and store them to the INSTALL file
"RTN","MAGIP164",28,0)
 D DUMP^MAGUERR1(),ABTMSG^MAGKIDS()
"RTN","MAGIP164",29,0)
 Q
"RTN","MAGIP164",30,0)
 ;
"RTN","MAGIP164",31,0)
 ;***** POST-INSTALL CODE
"RTN","MAGIP164",32,0)
POS ;
"RTN","MAGIP164",33,0)
 N CALLBACK
"RTN","MAGIP164",34,0)
 D CLEAR^MAGUERR(1)
"RTN","MAGIP164",35,0)
 ;
"RTN","MAGIP164",36,0)
 ;--- Send the notification e-mail
"RTN","MAGIP164",37,0)
 D BMES^XPDUTL("Post Install Mail Message: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","MAGIP164",38,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGIP164",39,0)
 Q
"RTN","MAGIP164",40,0)
 ;
"RTN","MAGIP164",41,0)
 ;***** PRE-INSTALL CODE
"RTN","MAGIP164",42,0)
PRE ;
"RTN","MAGIP164",43,0)
 Q
"RTN","MAGVIM05")
0^1^B145735310
"RTN","MAGVIM05",1,0)
MAGVIM05 ;WOIFO/MAT,BT - Utilities for RPC calls for DICOM file processing ; 21 Jun 2013  5:04 PM
"RTN","MAGVIM05",2,0)
 ;;3.0;IMAGING;**118,138,164**;Mar 19, 2002;Build 35;Nov 09, 2016
"RTN","MAGVIM05",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGVIM05",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVIM05",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGVIM05",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGVIM05",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGVIM05",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGVIM05",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGVIM05",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGVIM05",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGVIM05",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGVIM05",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGVIM05",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGVIM05",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGVIM05",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVIM05",17,0)
 ;;
"RTN","MAGVIM05",18,0)
 ;
"RTN","MAGVIM05",19,0)
 Q
"RTN","MAGVIM05",20,0)
 ;
"RTN","MAGVIM05",21,0)
 ;+++++ Wrap call to code underlying RPC: RAMAG EXAM COMPLETE & re-format output
"RTN","MAGVIM05",22,0)
 ;
"RTN","MAGVIM05",23,0)
 ; RPC: MAGV RAD STAT COMPLETE   Private IA #5072
"RTN","MAGVIM05",24,0)
 ;
"RTN","MAGVIM05",25,0)
 ; Inputs:
"RTN","MAGVIM05",26,0)
 ; =======
"RTN","MAGVIM05",27,0)
 ;
"RTN","MAGVIM05",28,0)
 ;  RETURN ...... variable to hold the results
"RTN","MAGVIM05",29,0)
 ;  RADPT ....... IEN of the RAD/NUC MED PATIENT file (#70)
"RTN","MAGVIM05",30,0)
 ;  RAEXAM1 ..... EXAM DATE (#.01) of the REGISTERED EXAMS sub-file (#70.02)
"RTN","MAGVIM05",31,0)
 ;  RAEXAM2 ..... IEN of the EXAMINATIONS sub-file (#70.03)
"RTN","MAGVIM05",32,0)
 ;  MAGVUSR ..... DUZ of the Importer 2 application user.
"RTN","MAGVIM05",33,0)
 ;  MAGVUSRDV ... DUZ(2) of the Importer 2 user.
"RTN","MAGVIM05",34,0)
 ;  RAIMGTYP .... TYPE OF IMAGING (#2) of the REGISTERED EXAMS sub-file (#70.02)
"RTN","MAGVIM05",35,0)
 ; [RASTDRPT] ... IEN of an entry in the STANDARD REPORTS file (#74.1)
"RTN","MAGVIM05",36,0)
 ;           ---- Next two are IEN(s) of entries in the DIAGNOSTIC CODES file(#78.3)
"RTN","MAGVIM05",37,0)
 ; [RADXPRIM]  .. Primary Diagnostic Code --> RAMISC Param PRIMDXCODE
"RTN","MAGVIM05",38,0)
 ; [RADXSCND] ... List of Secondary Diagnostic Codes --> RAMISC Param SECDXCODE
"RTN","MAGVIM05",39,0)
 ;  
"RTN","MAGVIM05",40,0)
 ; Outputs:
"RTN","MAGVIM05",41,0)
 ; ========
"RTN","MAGVIM05",42,0)
 ; 
"RTN","MAGVIM05",43,0)
 ; Notes:
"RTN","MAGVIM05",44,0)
 ; ======
"RTN","MAGVIM05",45,0)
 ; 
"RTN","MAGVIM05",46,0)
 ; The parameters mirror those of the underlying call.
"RTN","MAGVIM05",47,0)
 ;
"RTN","MAGVIM05",48,0)
XMCOMPLT(RETURN,RADPT,RAEXAM1,RAEXAM2,MAGVUSR,MAGVUSRDV,RAIMGTYP,RASTDRPT,RADXPRIM,RADXSCND) ;
"RTN","MAGVIM05",49,0)
 ;
"RTN","MAGVIM05",50,0)
 ;--- Initialize
"RTN","MAGVIM05",51,0)
 K RETURN
"RTN","MAGVIM05",52,0)
 N MSG,RARESULT,SEPSTAT,SEPOUTP D ZRUSEPIN
"RTN","MAGVIM05",53,0)
 ;
"RTN","MAGVIM05",54,0)
 ;--- Validate incoming parameters.
"RTN","MAGVIM05",55,0)
 N MAGERR,PARAM S MAGERR=0
"RTN","MAGVIM05",56,0)
 D
"RTN","MAGVIM05",57,0)
 . F PARAM="RADPT","RAEXAM1","RAEXAM2","MAGVUSR","MAGVUSRDV","RAIMGTYP" D  Q:MAGERR
"RTN","MAGVIM05",58,0)
 . . S:@PARAM="" MAGERR=1
"RTN","MAGVIM05",59,0)
 . . Q
"RTN","MAGVIM05",60,0)
 . Q
"RTN","MAGVIM05",61,0)
 ;
"RTN","MAGVIM05",62,0)
 I MAGERR D  Q
"RTN","MAGVIM05",63,0)
 . S RETURN(0)="-1"_SEPSTAT_"Required parameter "_PARAM_" missing or invalid."
"RTN","MAGVIM05",64,0)
 . Q
"RTN","MAGVIM05",65,0)
 ;
"RTN","MAGVIM05",66,0)
 ;--- Format incoming RAD Exam Identifiers.
"RTN","MAGVIM05",67,0)
 S RAEXAM=RADPT_U_RAEXAM1_U_RAEXAM2
"RTN","MAGVIM05",68,0)
 ;
"RTN","MAGVIM05",69,0)
 ;--- Set IMAGING SITE PARAMETERS file (#2006.1) IEN from DUZ(2).
"RTN","MAGVIM05",70,0)
 N MAGSITEP
"RTN","MAGVIM05",71,0)
 D
"RTN","MAGVIM05",72,0)
 . S MAGVUSRDV=$G(MAGVUSRDV,$G(DUZ(2))),MAGSITEP=$O(^MAG(2006.1,"B",MAGVUSRDV,"")) ;P164
"RTN","MAGVIM05",73,0)
 . I MAGSITEP="" D   ;P164 - if it is not Site IEN, try Station Number
"RTN","MAGVIM05",74,0)
 . . ;--- Get IEN of INSTITUTION file (#4) from STATION NUMBER (Supported IA# 2171)
"RTN","MAGVIM05",75,0)
 . . N IENINST S IENINST=$$IEN^XUAF4(MAGVUSRDV)
"RTN","MAGVIM05",76,0)
 . . S MAGSITEP=$O(^MAG(2006.1,"B",IENINST,"")) Q:+MAGSITEP  ;found the site
"RTN","MAGVIM05",77,0)
 . . S MAGERR=1,MSG="Unable to resolve Imaging Site Parameters entry. {DUZ(2)="_MAGVUSRDV_"} "
"RTN","MAGVIM05",78,0)
 . Q
"RTN","MAGVIM05",79,0)
 ;
"RTN","MAGVIM05",80,0)
 I MAGERR D  Q
"RTN","MAGVIM05",81,0)
 . S RETURN(0)="-1"_SEPSTAT_MSG
"RTN","MAGVIM05",82,0)
 . Q
"RTN","MAGVIM05",83,0)
 ; 
"RTN","MAGVIM05",84,0)
 ;--- Set additional RAD Order/Exam parameters.
"RTN","MAGVIM05",85,0)
 S MAGERR=$$MAKELIST("C",RAIMGTYP,.RAMSC,MAGVUSR,MAGSITEP)
"RTN","MAGVIM05",86,0)
 I MAGERR D  Q
"RTN","MAGVIM05",87,0)
 . S RETURN(0)="-1"_SEPSTAT_$P(MAGERR,U,2)
"RTN","MAGVIM05",88,0)
 . Q
"RTN","MAGVIM05",89,0)
 ;
"RTN","MAGVIM05",90,0)
 ;--- Set flag to insert Primary DX code if passed in.
"RTN","MAGVIM05",91,0)
 D:$G(RADXPRIM)'="" OUTPUT("PRIMDXCODE^^"_RADXPRIM,.RAMSC)
"RTN","MAGVIM05",92,0)
 ;
"RTN","MAGVIM05",93,0)
 ;--- Set flag to insert Secondary DX code(s) if passed in.
"RTN","MAGVIM05",94,0)
 D:$G(RADXSCND(0))'=""
"RTN","MAGVIM05",95,0)
 . ;
"RTN","MAGVIM05",96,0)
 . N CT S CT=""
"RTN","MAGVIM05",97,0)
 . F  S CT=$O(RADXSCND(CT)) Q:CT=""  D OUTPUT("SECDXCODE"_U_(CT+1)_U_RADXSCND(CT),.RAMSC)
"RTN","MAGVIM05",98,0)
 . Q
"RTN","MAGVIM05",99,0)
 ;
"RTN","MAGVIM05",100,0)
 ;--- Set flag to suppress HL7 message to dictation systems.
"RTN","MAGVIM05",101,0)
 D OUTPUT("FLAGS^^FS",.RAMSC)
"RTN","MAGVIM05",102,0)
 ;--- Call code underlying RPC: RAMAG EXAM COMPLETE (Private IA #5072)
"RTN","MAGVIM05",103,0)
 D COMPLETE^RAMAGRP1(.RARESULT,RAEXAM,.RAMSC)
"RTN","MAGVIM05",104,0)
 I $G(RARESULT(1))="-11^2" D  ; add the OUTSIDE STUDY and try the RPC again 
"RTN","MAGVIM05",105,0)
 . N INFO
"RTN","MAGVIM05",106,0)
 . D ADDROOM(.INFO,RAEXAM)
"RTN","MAGVIM05",107,0)
 . K RARESULT
"RTN","MAGVIM05",108,0)
 . I INFO(1)<0 M RARESULT=INFO Q
"RTN","MAGVIM05",109,0)
 . D COMPLETE^RAMAGRP1(.RARESULT,RAEXAM,.RAMSC)
"RTN","MAGVIM05",110,0)
 . Q
"RTN","MAGVIM05",111,0)
 ;
"RTN","MAGVIM05",112,0)
 ;--- Re-format error output or return 0.
"RTN","MAGVIM05",113,0)
 I RARESULT(0)<0 D
"RTN","MAGVIM05",114,0)
 . ;
"RTN","MAGVIM05",115,0)
 . S RETURN(0)=-1_SEPSTAT_$O(RARESULT("A"),-1)_" error lines returned."
"RTN","MAGVIM05",116,0)
 . N X S X=0
"RTN","MAGVIM05",117,0)
 . F  S X=$O(RARESULT(X)) Q:X=""  D
"RTN","MAGVIM05",118,0)
 . . S RETURN(X)=$P(RARESULT(X),U,1)_SEPSTAT_$P(RARESULT(X),U,2,999)
"RTN","MAGVIM05",119,0)
 . . Q
"RTN","MAGVIM05",120,0)
 E  D
"RTN","MAGVIM05",121,0)
 . S RETURN(0)=0_SEPSTAT_RARESULT(0)
"RTN","MAGVIM05",122,0)
 . N X S X=0
"RTN","MAGVIM05",123,0)
 . F  S X=$O(RARESULT(X)) Q:X=""  D
"RTN","MAGVIM05",124,0)
 . . S RETURN(X)=$TR(RARESULT(X),U,SEPOUTP)
"RTN","MAGVIM05",125,0)
 . . Q
"RTN","MAGVIM05",126,0)
 . ;--- Call RA* code to trigger alerts for DX codes.
"RTN","MAGVIM05",127,0)
 . D ALERT^MAGVIMRA(RADPT,RAEXAM1,RAEXAM2,1)
"RTN","MAGVIM05",128,0)
 . Q
"RTN","MAGVIM05",129,0)
 Q
"RTN","MAGVIM05",130,0)
 ;+++++ Wrap call to code underlying RPC: RAMAG EXAMINED & re-format output
"RTN","MAGVIM05",131,0)
 ;
"RTN","MAGVIM05",132,0)
 ; RPC: MAGV RAD STAT EXAMINED  Private IA #5071
"RTN","MAGVIM05",133,0)
 ;
"RTN","MAGVIM05",134,0)
 ; Inputs:
"RTN","MAGVIM05",135,0)
 ; =======
"RTN","MAGVIM05",136,0)
 ;
"RTN","MAGVIM05",137,0)
 ;  See input parameter descriptions above tag XMCOMPLT (above).
"RTN","MAGVIM05",138,0)
 ;
"RTN","MAGVIM05",139,0)
XMEXAMIN(RETURN,RADFN,RAEXAM1,RAEXAM2,MAGVUSR,MAGVUSRDV,RAIMGTYP) ;
"RTN","MAGVIM05",140,0)
 ;
"RTN","MAGVIM05",141,0)
 ;--- Initialize.
"RTN","MAGVIM05",142,0)
 K RETURN
"RTN","MAGVIM05",143,0)
 N MSG,RARESULT,SEPSTAT,SEPOUTP D ZRUSEPIN
"RTN","MAGVIM05",144,0)
 ;--- Validate incoming parameters.
"RTN","MAGVIM05",145,0)
 N MAGERR,PARAM S MAGERR=0
"RTN","MAGVIM05",146,0)
 D
"RTN","MAGVIM05",147,0)
 . F PARAM="RADFN","RAEXAM1","RAEXAM2","MAGVUSR","MAGVUSRDV","RAIMGTYP" D  Q:MAGERR
"RTN","MAGVIM05",148,0)
 . . S:@PARAM="" MAGERR=1
"RTN","MAGVIM05",149,0)
 . . Q
"RTN","MAGVIM05",150,0)
 . Q
"RTN","MAGVIM05",151,0)
 ;
"RTN","MAGVIM05",152,0)
 I MAGERR D  Q
"RTN","MAGVIM05",153,0)
 . S RETURN(0)="-1"_SEPSTAT_"Required parameter "_PARAM_" missing or invalid."
"RTN","MAGVIM05",154,0)
 . Q
"RTN","MAGVIM05",155,0)
 ;
"RTN","MAGVIM05",156,0)
 ;--- Format incoming RAD Exam Identifiers
"RTN","MAGVIM05",157,0)
 N RAEXAM S RAEXAM=RADFN_U_RAEXAM1_U_RAEXAM2
"RTN","MAGVIM05",158,0)
 ;
"RTN","MAGVIM05",159,0)
 ;--- Set IMAGING SITE PARAMETERS file (#2006.1) IEN from DUZ(2).
"RTN","MAGVIM05",160,0)
 N MAGSITEP
"RTN","MAGVIM05",161,0)
 D
"RTN","MAGVIM05",162,0)
 . S MAGSITEP=$O(^MAG(2006.1,"B",MAGVUSRDV,""))
"RTN","MAGVIM05",163,0)
 . I MAGSITEP="" S MAGERR=1,MSG="Unable to resolve Imaging Site Parameters entry."
"RTN","MAGVIM05",164,0)
 . Q
"RTN","MAGVIM05",165,0)
 ;
"RTN","MAGVIM05",166,0)
 I MAGERR D  Q
"RTN","MAGVIM05",167,0)
 . S RETURN(0)="-1"_SEPSTAT_MSG
"RTN","MAGVIM05",168,0)
 . Q
"RTN","MAGVIM05",169,0)
 ;
"RTN","MAGVIM05",170,0)
 ;--- Set required parameters
"RTN","MAGVIM05",171,0)
 S MAGERR=$$MAKELIST("E",RAIMGTYP,.RAMSC,MAGVUSR,MAGSITEP)
"RTN","MAGVIM05",172,0)
 I MAGERR D  Q
"RTN","MAGVIM05",173,0)
 . S RETURN(0)="-1"_SEPSTAT_$P(MAGERR,U,2)
"RTN","MAGVIM05",174,0)
 . Q
"RTN","MAGVIM05",175,0)
 ;
"RTN","MAGVIM05",176,0)
 ;--- Set flag to suppress HL7 message to dictation systems.
"RTN","MAGVIM05",177,0)
 D OUTPUT("FLAGS^^FS",.RAMSC)
"RTN","MAGVIM05",178,0)
 ;--- Call code underlying RPC: RAMAG EXAMINED (Private IA #5071).
"RTN","MAGVIM05",179,0)
 D EXAMINED^RAMAGRP2(.RARESULT,RAEXAM,.RAMSC)
"RTN","MAGVIM05",180,0)
 I $G(RARESULT(1))="-11^2" D  ; add the OUTSIDE STUDY and try the RPC again 
"RTN","MAGVIM05",181,0)
 . N INFO
"RTN","MAGVIM05",182,0)
 . D ADDROOM(.INFO,RAEXAM)
"RTN","MAGVIM05",183,0)
 . K RARESULT
"RTN","MAGVIM05",184,0)
 . I INFO(1)<0 M RARESULT=INFO Q
"RTN","MAGVIM05",185,0)
 . D EXAMINED^RAMAGRP2(.RARESULT,RAEXAM,.RAMSC)
"RTN","MAGVIM05",186,0)
 . Q
"RTN","MAGVIM05",187,0)
 ;
"RTN","MAGVIM05",188,0)
 ;--- Re-format error output or return 0.
"RTN","MAGVIM05",189,0)
 I RARESULT(0)<0 D
"RTN","MAGVIM05",190,0)
 . ;
"RTN","MAGVIM05",191,0)
 . S RETURN(0)=-1_SEPSTAT_$O(RARESULT("A"),-1)_" error lines returned."
"RTN","MAGVIM05",192,0)
 . N X S X=0
"RTN","MAGVIM05",193,0)
 . F  S X=$O(RARESULT(X)) Q:X=""  D
"RTN","MAGVIM05",194,0)
 . . S RETURN(X)=$P(RARESULT(X),U,1)_SEPSTAT_$P(RARESULT(X),U,2,999)
"RTN","MAGVIM05",195,0)
 . . Q
"RTN","MAGVIM05",196,0)
 E  D
"RTN","MAGVIM05",197,0)
 . S RETURN(0)=0_SEPSTAT_RARESULT(0)
"RTN","MAGVIM05",198,0)
 . N X S X=0
"RTN","MAGVIM05",199,0)
 . F  S X=$O(RARESULT(X)) Q:X=""  D
"RTN","MAGVIM05",200,0)
 . . S RETURN(X)=$TR(RARESULT(X),U,SEPOUTP)
"RTN","MAGVIM05",201,0)
 . . Q
"RTN","MAGVIM05",202,0)
 . Q
"RTN","MAGVIM05",203,0)
 Q
"RTN","MAGVIM05",204,0)
 ;+++++ Wrap calls to RPC: RAMAG EXAM ORDER & re-format output.
"RTN","MAGVIM05",205,0)
 ;
"RTN","MAGVIM05",206,0)
 ; RPC: MAGV RAD EXAM ORDER  Private IA #5068
"RTN","MAGVIM05",207,0)
 ;
"RTN","MAGVIM05",208,0)
 ; Inputs:
"RTN","MAGVIM05",209,0)
 ; =======
"RTN","MAGVIM05",210,0)
 ;
"RTN","MAGVIM05",211,0)
 ;  RETURN
"RTN","MAGVIM05",212,0)
 ;  DFN
"RTN","MAGVIM05",213,0)
 ;  RAMLC
"RTN","MAGVIM05",214,0)
 ;  RADPROC
"RTN","MAGVIM05",215,0)
 ;  STUDYDAT
"RTN","MAGVIM05",216,0)
 ;  RACAT
"RTN","MAGVIM05",217,0)
 ;  REQLOC
"RTN","MAGVIM05",218,0)
 ;  REQPHYS
"RTN","MAGVIM05",219,0)
 ;  REASON
"RTN","MAGVIM05",220,0)
 ;  MISC
"RTN","MAGVIM05",221,0)
 ;
"RTN","MAGVIM05",222,0)
 ; Notes:
"RTN","MAGVIM05",223,0)
 ; ======
"RTN","MAGVIM05",224,0)
 ; 
"RTN","MAGVIM05",225,0)
 ; The parameters are the same as those of the underlying call.
"RTN","MAGVIM05",226,0)
 ;
"RTN","MAGVIM05",227,0)
XMORDER(RETURN,DFN,RAMLC,RADPROC,STUDYDAT,RACAT,REQLOC,REQPHYS,REASON,MISC) ;
"RTN","MAGVIM05",228,0)
 ;
"RTN","MAGVIM05",229,0)
 K RETURN
"RTN","MAGVIM05",230,0)
 N SEPSTAT,SEPOUTP D ZRUSEPIN
"RTN","MAGVIM05",231,0)
 ;
"RTN","MAGVIM05",232,0)
 ;--- Private IA #5068.
"RTN","MAGVIM05",233,0)
 D ORDER^RAMAGRP1(.ORDINFO,DFN,RAMLC,RADPROC,STUDYDAT,RACAT,REQLOC,REQPHYS,REASON,.MISC)
"RTN","MAGVIM05",234,0)
 ;
"RTN","MAGVIM05",235,0)
 ;--- Re-format error output or return new IEN in RAD/NUC MED ORDERS File (#75.1)
"RTN","MAGVIM05",236,0)
 I ORDINFO(0)<0 D  K ORDINFO
"RTN","MAGVIM05",237,0)
 . ;
"RTN","MAGVIM05",238,0)
 . S RETURN(0)=-1_SEPSTAT_$O(ORDINFO("A"),-1)_" error lines returned."
"RTN","MAGVIM05",239,0)
 . N X S X=0 F  S X=$O(ORDINFO(X)) Q:X=""  D
"RTN","MAGVIM05",240,0)
 . . ;
"RTN","MAGVIM05",241,0)
 . . S RETURN(X)=$P(ORDINFO(X),U,1)_SEPSTAT_$P(ORDINFO(X),U,2,999)
"RTN","MAGVIM05",242,0)
 . . Q
"RTN","MAGVIM05",243,0)
 . Q
"RTN","MAGVIM05",244,0)
 E  S RETURN(0)=ORDINFO(0)
"RTN","MAGVIM05",245,0)
 K ORDINFO
"RTN","MAGVIM05",246,0)
 Q
"RTN","MAGVIM05",247,0)
 ;
"RTN","MAGVIM05",248,0)
 ;+++++ Wrap calls to RPC: RAMAG EXAM REGISTER & re-format output.
"RTN","MAGVIM05",249,0)
 ;
"RTN","MAGVIM05",250,0)
 ; RPC: MAGV RAD EXAM REGISTER  Private IA #5069.
"RTN","MAGVIM05",251,0)
 ; 
"RTN","MAGVIM05",252,0)
 ; Inputs:
"RTN","MAGVIM05",253,0)
 ; =======
"RTN","MAGVIM05",254,0)
 ; 
"RTN","MAGVIM05",255,0)
 ;  RETURN
"RTN","MAGVIM05",256,0)
 ;  RAOIFN
"RTN","MAGVIM05",257,0)
 ;  EXMDTE
"RTN","MAGVIM05",258,0)
 ;  RAMSC
"RTN","MAGVIM05",259,0)
 ;
"RTN","MAGVIM05",260,0)
 ; Notes:
"RTN","MAGVIM05",261,0)
 ; ======
"RTN","MAGVIM05",262,0)
 ; 
"RTN","MAGVIM05",263,0)
 ;  The parameters are the same as those of the underlying call.
"RTN","MAGVIM05",264,0)
 ;
"RTN","MAGVIM05",265,0)
XMREGSTR(RETURN,RAOIFN,EXMDTE,RAMSC) ;
"RTN","MAGVIM05",266,0)
 ;
"RTN","MAGVIM05",267,0)
 K RETURN
"RTN","MAGVIM05",268,0)
 N SEPSTAT,SEPOUTP,IMAGLOC D ZRUSEPIN
"RTN","MAGVIM05",269,0)
 ;
"RTN","MAGVIM05",270,0)
 ; Check if imaging location is present - if not find outside imaging location for procedure and division
"RTN","MAGVIM05",271,0)
 N RODATA S RODATA=$G(^RAO(75.1,RAOIFN,0))
"RTN","MAGVIM05",272,0)
 D:$P(RODATA,U,20)=""
"RTN","MAGVIM05",273,0)
 . N LOCINFO,PROCIEN,RAMLC S PROCIEN=$P(RODATA,U,2)
"RTN","MAGVIM05",274,0)
 . D IMAGELOC(.RAMLC,PROCIEN,DUZ(2))
"RTN","MAGVIM05",275,0)
 . S:$P(RAMLC,SEPSTAT)<0 RETURN(0)=RAMLC
"RTN","MAGVIM05",276,0)
 . Q:$G(RETURN(0))
"RTN","MAGVIM05",277,0)
 . S RAMLC=$P(RAMLC,SEPSTAT,2)
"RTN","MAGVIM05",278,0)
 . ; call the RPC to update the radiology imaging location in the radiology order file (#75.1).
"RTN","MAGVIM05",279,0)
 . D IMAGELOC^MAGDRPCB(.LOCINFO,RAOIFN,RAMLC)
"RTN","MAGVIM05",280,0)
 . I $G(LOCINFO)<0 S RETURN(0)=LOCINFO ;"-1"_SEPSTAT_"Error in rpc MAG DICOM SET IMAGING LOCATION"
"RTN","MAGVIM05",281,0)
 . Q
"RTN","MAGVIM05",282,0)
 ;
"RTN","MAGVIM05",283,0)
 ;Get imaging location IEN (#79.1)
"RTN","MAGVIM05",284,0)
 K RAMLC,PROCIEN
"RTN","MAGVIM05",285,0)
 S PROCIEN=$P(RODATA,U,2)
"RTN","MAGVIM05",286,0)
 D IMAGELOC(.RAMLC,PROCIEN,DUZ(2))
"RTN","MAGVIM05",287,0)
 S:$P(RAMLC,SEPSTAT)<0 RETURN(0)=RAMLC
"RTN","MAGVIM05",288,0)
 Q:$G(RETURN(0))
"RTN","MAGVIM05",289,0)
 S RAMLC=$P(RAMLC,SEPSTAT,2)
"RTN","MAGVIM05",290,0)
 ;Get corresponding hospital location IEN (#44)
"RTN","MAGVIM05",291,0)
 S IMAGLOC=$$GET1^DIQ(79.1,.RAMLC,.01,"I")
"RTN","MAGVIM05",292,0)
 K RAMSC
"RTN","MAGVIM05",293,0)
 S RAMSC(1)="PRINCLIN^^"_$G(IMAGLOC)
"RTN","MAGVIM05",294,0)
 S RAMSC(2)="FLAGS^^D"
"RTN","MAGVIM05",295,0)
 ;
"RTN","MAGVIM05",296,0)
 Q:$G(RETURN(0))
"RTN","MAGVIM05",297,0)
 ;--- Private IA #5069.
"RTN","MAGVIM05",298,0)
 D REGISTER^RAMAGRP1(.RARESULT,RAOIFN,EXMDTE,.RAMSC)
"RTN","MAGVIM05",299,0)
 ;
"RTN","MAGVIM05",300,0)
 I RARESULT(0)<0 D
"RTN","MAGVIM05",301,0)
 . ;
"RTN","MAGVIM05",302,0)
 . S RETURN(0)=-1_SEPSTAT_$O(RARESULT("A"),-1)_" error lines returned."
"RTN","MAGVIM05",303,0)
 . N X S X=0 F  S X=$O(RARESULT(X)) Q:X=""  D
"RTN","MAGVIM05",304,0)
 . . ;
"RTN","MAGVIM05",305,0)
 . . S RETURN(X)=$P(RARESULT(X),U,1)_SEPSTAT_$P(RARESULT(X),U,2,999)
"RTN","MAGVIM05",306,0)
 . . Q
"RTN","MAGVIM05",307,0)
 E  D
"RTN","MAGVIM05",308,0)
 . S RETURN(0)=0_SEPSTAT_RARESULT(0)
"RTN","MAGVIM05",309,0)
 . N X S X=0 F  S X=$O(RARESULT(X)) Q:X=""  D
"RTN","MAGVIM05",310,0)
 . . ;
"RTN","MAGVIM05",311,0)
 . . S RETURN(X)=$TR(RARESULT(X),U,SEPOUTP)
"RTN","MAGVIM05",312,0)
 . . Q
"RTN","MAGVIM05",313,0)
 . Q
"RTN","MAGVIM05",314,0)
 Q
"RTN","MAGVIM05",315,0)
 ;+++ Routine Utility: Initialize Separators
"RTN","MAGVIM05",316,0)
ZRUSEPIN ;
"RTN","MAGVIM05",317,0)
 S SEPOUTP=$$OUTSEP^MAGVIM01
"RTN","MAGVIM05",318,0)
 S SEPSTAT=$$STATSEP^MAGVIM01
"RTN","MAGVIM05",319,0)
 Q
"RTN","MAGVIM05",320,0)
 ;
"RTN","MAGVIM05",321,0)
MAKELIST(RACTION,RAIMGTYP,RAMSC,MAGVUSR,MAGSITEP) ; output required fields
"RTN","MAGVIM05",322,0)
 ; Load required flags 
"RTN","MAGVIM05",323,0)
 N INFO
"RTN","MAGVIM05",324,0)
 D EXMSTREQ^RAMAGRP2(.INFO,RACTION,RAIMGTYP)
"RTN","MAGVIM05",325,0)
 I INFO(0)<0 Q INFO(1)
"RTN","MAGVIM05",326,0)
 ;
"RTN","MAGVIM05",327,0)
 N TODAYHL7
"RTN","MAGVIM05",328,0)
 S TODAYHL7=$$NOW^XLFDT()\1,$E(TODAYHL7)=$E(TODAYHL7)+17
"RTN","MAGVIM05",329,0)
 ;
"RTN","MAGVIM05",330,0)
 N REQ,RADPVAL
"RTN","MAGVIM05",331,0)
 ;REQ001 - technologist
"RTN","MAGVIM05",332,0)
 S REQ(1)="TECH^1^"_MAGVUSR
"RTN","MAGVIM05",333,0)
 ;
"RTN","MAGVIM05",334,0)
 ;REQ002 - resident or staff
"RTN","MAGVIM05",335,0)
 ;REQ003 - detailed procedure - taken care of already
"RTN","MAGVIM05",336,0)
 ;
"RTN","MAGVIM05",337,0)
 ;REQ004 - film entry
"RTN","MAGVIM05",338,0)
 S RADPVAL=$$GET1^DIQ(2006.1,MAGSITEP,"RAD FILM SIZE","I")
"RTN","MAGVIM05",339,0)
 S REQ(4)="FILMSIZE^1^"_RADPVAL_U_"0"
"RTN","MAGVIM05",340,0)
 ;
"RTN","MAGVIM05",341,0)
 ;REQ005 - diagnostic code default, if not supplied by user.
"RTN","MAGVIM05",342,0)
 D:$G(RADXPRIM)=""
"RTN","MAGVIM05",343,0)
 . S RADPVAL=$$GET1^DIQ(2006.1,MAGSITEP,"RAD PRIMARY DIAGNOSTIC CODE","I")
"RTN","MAGVIM05",344,0)
 . S REQ(5)="PRIMDXCODE^^"_RADPVAL
"RTN","MAGVIM05",345,0)
 . Q
"RTN","MAGVIM05",346,0)
 ;
"RTN","MAGVIM05",347,0)
 ;REQ006 - camera / equipment / room
"RTN","MAGVIM05",348,0)
 S RADPVAL=$$GET1^DIQ(2006.1,MAGSITEP,"RAD PRIMARY CAMERA/EQUIP/RM","I")
"RTN","MAGVIM05",349,0)
 S REQ(6)="PRIMCAM^^"_RADPVAL
"RTN","MAGVIM05",350,0)
 ;
"RTN","MAGVIM05",351,0)
 ;REQ007 - reserved
"RTN","MAGVIM05",352,0)
 ;REQ008 - reserved
"RTN","MAGVIM05",353,0)
 ;REQ009 - reserved
"RTN","MAGVIM05",354,0)
 ;REQ010 - reserved
"RTN","MAGVIM05",355,0)
 ;
"RTN","MAGVIM05",356,0)
 ;REQ011 - report entered
"RTN","MAGVIM05",357,0)
 S REQ(11)="RPTDTE^^"_TODAYHL7
"RTN","MAGVIM05",358,0)
 I $G(RASTDRPT)="" D
"RTN","MAGVIM05",359,0)
 . S REQ(11,1)="REPORT^1^Electronically generated report for outside study."
"RTN","MAGVIM05",360,0)
 . Q
"RTN","MAGVIM05",361,0)
 ;--- Add the REPORT text of a selected STANDARD REPORT to the RAMSC array.
"RTN","MAGVIM05",362,0)
 E  D STNDRPRT(RASTDRPT,"R",1)
"RTN","MAGVIM05",363,0)
 ;
"RTN","MAGVIM05",364,0)
 ;REQ012 - verified report
"RTN","MAGVIM05",365,0)
 S REQ(12)="VERDTE^^"_TODAYHL7
"RTN","MAGVIM05",366,0)
 S REQ(12,1)="RPTSTATUS^^EF"
"RTN","MAGVIM05",367,0)
 ;
"RTN","MAGVIM05",368,0)
 ;REQ013 - procedure modifiers required - previously done
"RTN","MAGVIM05",369,0)
 ;
"RTN","MAGVIM05",370,0)
 ;REQ014 - cpt modifiers
"RTN","MAGVIM05",371,0)
 S RADPVAL=$$GET1^DIQ(2006.1,MAGSITEP,"RAD CPT MODIFIERS","I")
"RTN","MAGVIM05",372,0)
 S:RADPVAL REQ(14)="CPTMODS^1^"_RADPVAL
"RTN","MAGVIM05",373,0)
 ;
"RTN","MAGVIM05",374,0)
 ;REQ015 - reserved
"RTN","MAGVIM05",375,0)
 ;
"RTN","MAGVIM05",376,0)
 ;REQ016 - impression
"RTN","MAGVIM05",377,0)
 I $G(RASTDRPT)="" D
"RTN","MAGVIM05",378,0)
 . S REQ(16)="IMPRESSION^1^Electronically generated report for outside study."
"RTN","MAGVIM05",379,0)
 . Q
"RTN","MAGVIM05",380,0)
 ;--- Add the IMPRESSION text of a selected STANDARD REPORT to the RAMSC array.
"RTN","MAGVIM05",381,0)
 E  D STNDRPRT(RASTDRPT,"I",1)
"RTN","MAGVIM05",382,0)
 ;
"RTN","MAGVIM05",383,0)
 N INDEX
"RTN","MAGVIM05",384,0)
 F INDEX=1:1:16 I $P(INFO(0),"^",INDEX) D
"RTN","MAGVIM05",385,0)
 . D:$D(REQ(INDEX)) OUTPUT(REQ(INDEX),.RAMSC)
"RTN","MAGVIM05",386,0)
 . D:$D(REQ(INDEX,1)) OUTPUT(REQ(INDEX,1),.RAMSC)
"RTN","MAGVIM05",387,0)
 . Q
"RTN","MAGVIM05",388,0)
 ;
"RTN","MAGVIM05",389,0)
 Q 0
"RTN","MAGVIM05",390,0)
 ;
"RTN","MAGVIM05",391,0)
 ;+++++ Add selected STANDARD REPORT text to the Miscellaneous Parameters array.
"RTN","MAGVIM05",392,0)
 ;
"RTN","MAGVIM05",393,0)
STNDRPRT(RASTDRPT,SSCR,INDEX1) ;
"RTN","MAGVIM05",394,0)
 ;
"RTN","MAGVIM05",395,0)
 N PREFIX S PREFIX=$S(SSCR="R":"REPORT",SSCR="I":"IMPRESSION")
"RTN","MAGVIM05",396,0)
 ;
"RTN","MAGVIM05",397,0)
 N CT
"RTN","MAGVIM05",398,0)
 S CT=0 F  S CT=$O(^RA(74.1,RASTDRPT,SSCR,CT)) Q:CT=""  D
"RTN","MAGVIM05",399,0)
 . N RPTXT
"RTN","MAGVIM05",400,0)
 . S RPTXT=PREFIX_U_(CT+INDEX1)_U_$G(^RA(74.1,RASTDRPT,SSCR,CT,0)) D OUTPUT(RPTXT,.RAMSC)
"RTN","MAGVIM05",401,0)
 . Q
"RTN","MAGVIM05",402,0)
 Q
"RTN","MAGVIM05",403,0)
 ;
"RTN","MAGVIM05",404,0)
OUTPUT(TEXT,ARRAY) ;
"RTN","MAGVIM05",405,0)
 N I
"RTN","MAGVIM05",406,0)
 S I=$O(ARRAY(""),-1)+1
"RTN","MAGVIM05",407,0)
 S ARRAY(I)=TEXT
"RTN","MAGVIM05",408,0)
 Q
"RTN","MAGVIM05",409,0)
 ;
"RTN","MAGVIM05",410,0)
 ; MAGV OUTSIDE IMAGE LOCATION
"RTN","MAGVIM05",411,0)
 ;
"RTN","MAGVIM05",412,0)
 ; Inputs:
"RTN","MAGVIM05",413,0)
 ; =======
"RTN","MAGVIM05",414,0)
 ;
"RTN","MAGVIM05",415,0)
 ; PROCIEN -- IEN of procedure in RAD/NUC MED PROCEDURES (file #71)
"RTN","MAGVIM05",416,0)
 ; DIVISION - IEN of division in INSTITUTION (file #4)
"RTN","MAGVIM05",417,0)
 ;  
"RTN","MAGVIM05",418,0)
 ; Output:
"RTN","MAGVIM05",419,0)
 ; ========
"RTN","MAGVIM05",420,0)
 ; 
"RTN","MAGVIM05",421,0)
 ;     <0 Error message
"RTN","MAGVIM05",422,0)
 ;      0 IEN of the Outside Image Location in the IMAGE LOCATIONS (file #79.1)
"RTN","MAGVIM05",423,0)
 ;
"RTN","MAGVIM05",424,0)
IMAGELOC(RESULT,PROCIEN,DIVISION) ;
"RTN","MAGVIM05",425,0)
 ; return the outside imaging location for a given radiology procedure and division
"RTN","MAGVIM05",426,0)
 N IEN,IMAGETYPE,SEPSTAT,SEPOUTP D ZRUSEPIN
"RTN","MAGVIM05",427,0)
 K RESULT
"RTN","MAGVIM05",428,0)
 S PROCIEN=$G(PROCIEN)
"RTN","MAGVIM05",429,0)
 I (PROCIEN'>0)!(PROCIEN'=+PROCIEN) D  Q
"RTN","MAGVIM05",430,0)
 . S RESULT="-1"_SEPSTAT_"Invalid or missing Radiology Procedure pointer: """_PROCIEN_"""."
"RTN","MAGVIM05",431,0)
 . Q
"RTN","MAGVIM05",432,0)
 ;
"RTN","MAGVIM05",433,0)
 S DIVISION=$G(DIVISION)
"RTN","MAGVIM05",434,0)
 I (DIVISION'>0)!(DIVISION'=+DIVISION) D  Q
"RTN","MAGVIM05",435,0)
 . S RESULT="-2"_SEPSTAT_"Invalid or missing Division pointer:"""_DIVISION_"""."
"RTN","MAGVIM05",436,0)
 . Q
"RTN","MAGVIM05",437,0)
 ;
"RTN","MAGVIM05",438,0)
 S IMAGETYPE=$$GET1^DIQ(71,PROCIEN,12,"I")
"RTN","MAGVIM05",439,0)
 I 'IMAGETYPE D  Q
"RTN","MAGVIM05",440,0)
 . S RESULT="-3"_SEPSTAT_"Image Type could not be determined for Radiology Procedure pointer: """_PROCIEN_"""."
"RTN","MAGVIM05",441,0)
 . Q
"RTN","MAGVIM05",442,0)
 ;
"RTN","MAGVIM05",443,0)
 I $$GET1^DIQ(4,DIVISION,.01)="" D  Q
"RTN","MAGVIM05",444,0)
 . S RESULT="-4"_SEPSTAT_"Invalid Division (Institution) pointer:"""_DIVISION_"""."
"RTN","MAGVIM05",445,0)
 . Q
"RTN","MAGVIM05",446,0)
 S IEN=$O(^MAGD(2006.5759,"D",DIVISION,IMAGETYPE,""))
"RTN","MAGVIM05",447,0)
 I IEN="" D  Q
"RTN","MAGVIM05",448,0)
 . S RESULT="-5"_SEPSTAT_"Outside Imaging Location could not be determined for Division: "_DIVISION_" & Procedure: """_PROCIEN_"""."
"RTN","MAGVIM05",449,0)
 . Q
"RTN","MAGVIM05",450,0)
 S RESULT=0_SEPSTAT_$$GET1^DIQ(2006.5759,IEN,.01,"I")
"RTN","MAGVIM05",451,0)
 Q
"RTN","MAGVIM05",452,0)
ADDROOM(INFO,RAEXAM) ; add the OUTSIDE STUDY camera equipment room to the IMAGING LOCATION
"RTN","MAGVIM05",453,0)
 ;S RPCERR=$$CALLRPC^MAGM2VCU("MAG DICOM ADD CAMERA EQUIP RM","M",.INFO,RAEXAM)
"RTN","MAGVIM05",454,0)
 D ADDROOM^MAGDRPCB(.INFO,RAEXAM)
"RTN","MAGVIM05",455,0)
 Q 
"RTN","MAGVIM10")
0^2^B25335221
"RTN","MAGVIM10",1,0)
MAGVIM10 ;WOIFO/PMK/MLS/SG/DAC/JSL/MAT - Imaging RPCs for Importer ; 30 Jul 2013  7:28 PM
"RTN","MAGVIM10",2,0)
 ;;3.0;IMAGING;**118,138,164**;Mar 19, 2002;Build 35;Nov 03, 2016
"RTN","MAGVIM10",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGVIM10",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVIM10",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGVIM10",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGVIM10",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGVIM10",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGVIM10",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGVIM10",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGVIM10",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGVIM10",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGVIM10",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGVIM10",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGVIM10",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGVIM10",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVIM10",17,0)
 ;;
"RTN","MAGVIM10",18,0)
 Q
"RTN","MAGVIM10",19,0)
 ;***** RETURNS THE LIST OF RADIOLOGY PROCEDURES
"RTN","MAGVIM10",20,0)
 ; RPC: MAGV GET RADIOLOGY PROCEDURES
"RTN","MAGVIM10",21,0)
 ;
"RTN","MAGVIM10",22,0)
 ;      Modified from PROC^MAGDRPCA (RPC: MAG DICOM RADIOLOGY PROCEDURES)
"RTN","MAGVIM10",23,0)
 ;        for MAG*3.0*118.
"RTN","MAGVIM10",24,0)
 ;
"RTN","MAGVIM10",25,0)
 ; .ARRAY        Reference to a local variable where results
"RTN","MAGVIM10",26,0)
 ;               are returned to.
"RTN","MAGVIM10",27,0)
 ;
"RTN","MAGVIM10",28,0)
 ; STATIONUM     STATION NUMBER (#99) of an INSTITUTION file (#4) entry.
"RTN","MAGVIM10",29,0)
 ;
"RTN","MAGVIM10",30,0)
 ; IENMAGLOC     IEN of an entry in the IMAGING LOCATIONS file(#79.1)
"RTN","MAGVIM10",31,0)
 ;
"RTN","MAGVIM10",32,0)
 ; [IENRAPROC]   IEN of an entry in the RAD/NUC MED PROCEDURES file (#71)
"RTN","MAGVIM10",33,0)
 ;
"RTN","MAGVIM10",34,0)
 ; NOTE
"RTN","MAGVIM10",35,0)
 ; ====
"RTN","MAGVIM10",36,0)
 ;
"RTN","MAGVIM10",37,0)
 ;  Does not return procedure types of "B"road or "P"arent if a list is
"RTN","MAGVIM10",38,0)
 ;    requested (vs. a single procedure).
"RTN","MAGVIM10",39,0)
 ; 
"RTN","MAGVIM10",40,0)
 ;  The call to $$IEN^XUAF4() is Supported IA#1271.
"RTN","MAGVIM10",41,0)
 ;  Direct reads of ^RAMIS(71, via Private IA#1174.
"RTN","MAGVIM10",42,0)
 ;
"RTN","MAGVIM10",43,0)
GETPROCS(ARRAY,STATIONUM,IENMAGLOC,IENRAPROC) ;
"RTN","MAGVIM10",44,0)
 ;
"RTN","MAGVIM10",45,0)
 ;--- Initialize.
"RTN","MAGVIM10",46,0)
 N IMAGTYPE      ; IEN of the imaging type (file #79.2)
"RTN","MAGVIM10",47,0)
 N INACTDAT      ; Inactivation date of the procedure
"RTN","MAGVIM10",48,0)
 N RADPROC       ; Radiology procedure data (file #71)
"RTN","MAGVIM10",49,0)
 N TODAY         ; today's date in Fileman format
"RTN","MAGVIM10",50,0)
 N PROCTYPE      ; Type of procedure
"RTN","MAGVIM10",51,0)
 ;
"RTN","MAGVIM10",52,0)
 N IEN
"RTN","MAGVIM10",53,0)
 N MAGX S MAGX=""
"RTN","MAGVIM10",54,0)
 K ARRAY
"RTN","MAGVIM10",55,0)
 S (ARRAY(1),IEN)=0,TODAY=$$DT^XLFDT()
"RTN","MAGVIM10",56,0)
 ;
"RTN","MAGVIM10",57,0)
 ;--- Validate parameters
"RTN","MAGVIM10",58,0)
 S IENRAPROC=$G(IENRAPROC)
"RTN","MAGVIM10",59,0)
 ;;S STATIONUM=$G(STATIONUM)  ;;P164 took out STATIONUM, IENINST by David M (#I10555403FY16)
"RTN","MAGVIM10",60,0)
 ;;I (STATIONUM'>0) D  Q      ;;P164 RPC is based on the RA Imaging Location selected by the user, not the arbitrary check on Institution .vs Imaging Location Division
"RTN","MAGVIM10",61,0)
 ;;. S ARRAY(1)="-1,Invalid STATION NUMBER: '"_STATIONUM_"'."
"RTN","MAGVIM10",62,0)
 ;;. Q
"RTN","MAGVIM10",63,0)
 ;
"RTN","MAGVIM10",64,0)
 ;;--- Get IEN of INSTITUTION file (#4) from STATION NUMBER (Supported IA# 2171).
"RTN","MAGVIM10",65,0)
 ;;N IENINST S IENINST=$$IEN^XUAF4(STATIONUM)  ;P164 took out STATIONUM, IENINST
"RTN","MAGVIM10",66,0)
 ;;
"RTN","MAGVIM10",67,0)
 ;;I IENINST=""  D  Q
"RTN","MAGVIM10",68,0)
 ;;. S ARRAY(1)="-2,Could not resolve Institution from STATION NUMBER '"_STATIONUM_"'."
"RTN","MAGVIM10",69,0)
 ;;. Q
"RTN","MAGVIM10",70,0)
 ;
"RTN","MAGVIM10",71,0)
 ;--- Output a single RAD/NUC MED PROCEDURE file (#71) entry.
"RTN","MAGVIM10",72,0)
 I IENRAPROC'="" S IEN=IENRAPROC D
"RTN","MAGVIM10",73,0)
 . S RADPROC=^RAMIS(71,IEN,0),IMAGTYPE=+$P(RADPROC,U,12)
"RTN","MAGVIM10",74,0)
 . S MAGX=$O(^RA(79.1,"BIMG",IMAGTYPE,""))
"RTN","MAGVIM10",75,0)
 . Q:MAGX=""
"RTN","MAGVIM10",76,0)
 . D OUTPUT(MAGX)
"RTN","MAGVIM10",77,0)
 . Q
"RTN","MAGVIM10",78,0)
 ;--- Loop through the RAD/NUC MED PROCEDURES file (#71).
"RTN","MAGVIM10",79,0)
 E  D
"RTN","MAGVIM10",80,0)
 . F  S IEN=$O(^RAMIS(71,IEN))  Q:'IEN  D CHEKINST
"RTN","MAGVIM10",81,0)
 . Q
"RTN","MAGVIM10",82,0)
 Q
"RTN","MAGVIM10",83,0)
 ;
"RTN","MAGVIM10",84,0)
 ;+++++ Internal entry point: Validate a procedures' institution matches.
"RTN","MAGVIM10",85,0)
 ;
"RTN","MAGVIM10",86,0)
CHEKINST ;
"RTN","MAGVIM10",87,0)
 S RADPROC=^RAMIS(71,IEN,0),IMAGTYPE=+$P(RADPROC,U,12)
"RTN","MAGVIM10",88,0)
 ;
"RTN","MAGVIM10",89,0)
 ;--- Select by input IMAGING LOCATION (#79.1).
"RTN","MAGVIM10",90,0)
 N MAGXX,MATCH S (MAGXX,MATCH)=0
"RTN","MAGVIM10",91,0)
 F  S MAGXX=$O(^RA(79.1,"BIMG",IMAGTYPE,MAGXX)) Q:MAGXX=""  Q:MATCH>0  D
"RTN","MAGVIM10",92,0)
 . ;
"RTN","MAGVIM10",93,0)
 . ;--- Resolve HOSPITAL LOCATION file IEN from IMAGING LOCATION.
"RTN","MAGVIM10",94,0)
 . N IENHSPLOC S IENHSPLOC=$$GET1^DIQ(79.1,MAGXX,.01,"I")
"RTN","MAGVIM10",95,0)
 . ;
"RTN","MAGVIM10",96,0)
 . ;--- Resolve the INSTITUTION file (#4) IEN.
"RTN","MAGVIM10",97,0)
 . N IENINSPRC S IENINSPRC=$$GET1^DIQ(44,IENHSPLOC,3,"I")
"RTN","MAGVIM10",98,0)
 . ;
"RTN","MAGVIM10",99,0)
 . ;--- Quit if not in the same INSTITUTION.
"RTN","MAGVIM10",100,0)
 . ;;Q:IENINSPRC'=IENINST     ;;p164 David M took out IENINST
"RTN","MAGVIM10",101,0)
 . S:MAGXX=IENMAGLOC MATCH=MATCH+1,MAGX=MAGXX
"RTN","MAGVIM10",102,0)
 . Q
"RTN","MAGVIM10",103,0)
 Q:MATCH=0  D OUTPUT(MAGX)
"RTN","MAGVIM10",104,0)
 Q
"RTN","MAGVIM10",105,0)
 ;
"RTN","MAGVIM10",106,0)
 ;+++++ Internal entry point: Assemble output for one record.
"RTN","MAGVIM10",107,0)
 ;
"RTN","MAGVIM10",108,0)
OUTPUT(MAGX) ;
"RTN","MAGVIM10",109,0)
 N BUF S BUF=$P(RADPROC,U)_U_IEN  ; Procedure Name and IEN
"RTN","MAGVIM10",110,0)
 S PROCTYPE=$P(RADPROC,U,6)       ; Type of Procedure
"RTN","MAGVIM10",111,0)
 ;
"RTN","MAGVIM10",112,0)
 ;--- Iff list output (LOCATION was input), filter out 'B'road, 'P'arent.
"RTN","MAGVIM10",113,0)
 N FILTER S FILTER=$S(IENMAGLOC'="":1,1:0)
"RTN","MAGVIM10",114,0)
 I FILTER=1,(PROCTYPE="B")!(PROCTYPE="P") Q
"RTN","MAGVIM10",115,0)
 S $P(BUF,U,3)=PROCTYPE         ; Type of Procedure
"RTN","MAGVIM10",116,0)
 S $P(BUF,U,4)=$P(RADPROC,U,9)  ; CPT Code (file #81)
"RTN","MAGVIM10",117,0)
 S $P(BUF,U,5)=IMAGTYPE         ; Type of Imaging (file #79.2)
"RTN","MAGVIM10",118,0)
 S INACTDAT=$P($G(^RAMIS(71,IEN,"I")),U)
"RTN","MAGVIM10",119,0)
 I INACTDAT,INACTDAT<TODAY Q    ; ignore inactive procedures
"RTN","MAGVIM10",120,0)
 S $P(BUF,U,6)=INACTDAT         ; Inactivation Date
"RTN","MAGVIM10",121,0)
 S $P(BUF,U,7)=$S(IENMAGLOC="":MAGX,1:IENMAGLOC) ; Imaging Location (file #79.1)
"RTN","MAGVIM10",122,0)
 ;
"RTN","MAGVIM10",123,0)
 ;--- Resolve HOSPITAL LOCATION file IEN from IMAGING LOCATION.
"RTN","MAGVIM10",124,0)
 N IENHSPLOC S IENHSPLOC=$$GET1^DIQ(79.1,MAGX,.01,"I")
"RTN","MAGVIM10",125,0)
 S $P(BUF,U,8)=IENHSPLOC                    ; Hospital Location file (#44) - IEN
"RTN","MAGVIM10",126,0)
 S $P(BUF,U,9)=$$GET1^DIQ(44,IENHSPLOC,.01) ; Hospital Location file (#44) - NAME
"RTN","MAGVIM10",127,0)
 ;
"RTN","MAGVIM10",128,0)
 ;--- Add the descriptor to the result array
"RTN","MAGVIM10",129,0)
 S ARRAY(1)=ARRAY(1)+1,ARRAY(ARRAY(1)+1)=BUF
"RTN","MAGVIM10",130,0)
 Q
"RTN","MAGVIM10",131,0)
 ;
"RTN","MAGVIM10",132,0)
 ; MAGVIM10
"RTN","MAGVIMRA")
0^3^B26121368
"RTN","MAGVIMRA",1,0)
MAGVIMRA ;WOIFO/MAT,DWM - VISA Importer RA Utilities ; 18 Oct 2016 7:33 PM
"RTN","MAGVIMRA",2,0)
 ;;3.0;IMAGING;**138,164**;Mar 19, 2002;Build 35;Nov 09, 2016
"RTN","MAGVIMRA",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGVIMRA",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVIMRA",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGVIMRA",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGVIMRA",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGVIMRA",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGVIMRA",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGVIMRA",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGVIMRA",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGVIMRA",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGVIMRA",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGVIMRA",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGVIMRA",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGVIMRA",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVIMRA",17,0)
 ;;
"RTN","MAGVIMRA",18,0)
 ;
"RTN","MAGVIMRA",19,0)
 Q
"RTN","MAGVIMRA",20,0)
 ;+++++ Wrap calls to ALERT^RARTE7. IA #6006 (Private).
"RTN","MAGVIMRA",21,0)
 ;
"RTN","MAGVIMRA",22,0)
 ;  Called by XMCOMPLT^MAGVIM05 after exam status advanced to COMPLETE.
"RTN","MAGVIMRA",23,0)
 ;
"RTN","MAGVIMRA",24,0)
ALERT(RADFN,RADTI,RACNI,RAFIRST) ;
"RTN","MAGVIMRA",25,0)
 N RAA1,RAA2,RANY1,RANY2,RARPT
"RTN","MAGVIMRA",26,0)
 S RANY1=0
"RTN","MAGVIMRA",27,0)
 S RANY2=$$ANYDX^RARTE7(.RAA2)
"RTN","MAGVIMRA",28,0)
 S RARPT=$P(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0),"^",17)
"RTN","MAGVIMRA",29,0)
 D ALERT^RARTE7
"RTN","MAGVIMRA",30,0)
 K RAAB
"RTN","MAGVIMRA",31,0)
 Q
"RTN","MAGVIMRA",32,0)
 ;--- Increment counter.
"RTN","MAGVIMRA",33,0)
C() S C=C+1
"RTN","MAGVIMRA",34,0)
 Q C
"RTN","MAGVIMRA",35,0)
 ;+++++ Return STANDARD REPORTS file (#74.1) data w/ XML tags.
"RTN","MAGVIMRA",36,0)
 ;
"RTN","MAGVIMRA",37,0)
 ;   RPC: MAGV GET RAD STD RPTS
"RTN","MAGVIMRA",38,0)
 ;
"RTN","MAGVIMRA",39,0)
 ; Input
"RTN","MAGVIMRA",40,0)
 ;
"RTN","MAGVIMRA",41,0)
 ;  OUT        Array holding the results to return.
"RTN","MAGVIMRA",42,0)
 ;
"RTN","MAGVIMRA",43,0)
 ; Output
"RTN","MAGVIMRA",44,0)
 ;
"RTN","MAGVIMRA",45,0)
 ;  Array of XML tagged STANDARD REPORTS file (#74.1) data.
"RTN","MAGVIMRA",46,0)
 ;
"RTN","MAGVIMRA",47,0)
GETRADSR(OUT) ;
"RTN","MAGVIMRA",48,0)
 N FILE S FILE=74.1
"RTN","MAGVIMRA",49,0)
 N C S C=0
"RTN","MAGVIMRA",50,0)
 ;--- Output standard XML header. IA #4153 (Supported).
"RTN","MAGVIMRA",51,0)
 S OUT(C)=$$XMLHDR^MXMLUTL()
"RTN","MAGVIMRA",52,0)
 N TAG0 S TAG0="ArrayOfStandardReport"
"RTN","MAGVIMRA",53,0)
 S OUT($$C())=$$XMTAG(TAG0,0) D
"RTN","MAGVIMRA",54,0)
 . ;
"RTN","MAGVIMRA",55,0)
 . ;--- Read of ^RA(74.1,IEN, is IA #6004 (Private).
"RTN","MAGVIMRA",56,0)
 . N TAG1 S TAG1="StandardReport"
"RTN","MAGVIMRA",57,0)
 . N IEN
"RTN","MAGVIMRA",58,0)
 . S IEN=0 F  S IEN=$O(^RA(FILE,IEN)) Q:IEN]"A"  D RADSR(TAG1,IEN)
"RTN","MAGVIMRA",59,0)
 . Q
"RTN","MAGVIMRA",60,0)
 S OUT($$C())=$$XMTAG(TAG0,1)
"RTN","MAGVIMRA",61,0)
 Q
"RTN","MAGVIMRA",62,0)
 ;+++++ Return DIAGNOSTIC CODE file (#78.3) data w/ XML tags.
"RTN","MAGVIMRA",63,0)
 ;
"RTN","MAGVIMRA",64,0)
 ;   RPC: MAGV GET RAD DX CODES
"RTN","MAGVIMRA",65,0)
 ;
"RTN","MAGVIMRA",66,0)
 ; Input
"RTN","MAGVIMRA",67,0)
 ;
"RTN","MAGVIMRA",68,0)
 ;  OUT        Array holding the results to return.
"RTN","MAGVIMRA",69,0)
 ;
"RTN","MAGVIMRA",70,0)
 ; Output
"RTN","MAGVIMRA",71,0)
 ;
"RTN","MAGVIMRA",72,0)
 ;  Array of XML tagged DIAGNOSTIC CODES file (#78.3) data.
"RTN","MAGVIMRA",73,0)
 ;
"RTN","MAGVIMRA",74,0)
GETRADDX(OUT) ;
"RTN","MAGVIMRA",75,0)
 N FILE S FILE=78.3
"RTN","MAGVIMRA",76,0)
 N C S C=0
"RTN","MAGVIMRA",77,0)
 ;--- IA #3561 (Supported)
"RTN","MAGVIMRA",78,0)
 S OUT(C)=$$XMLHDR^MXMLUTL()
"RTN","MAGVIMRA",79,0)
 N TAG0 S TAG0="ArrayOfDiagnosticCode"
"RTN","MAGVIMRA",80,0)
 S OUT($$C())=$$XMTAG(TAG0,0) D
"RTN","MAGVIMRA",81,0)
 . ;
"RTN","MAGVIMRA",82,0)
 . ;--- Read of ^RA(78.1,IEN, is IA #6005 (Private).
"RTN","MAGVIMRA",83,0)
 . N TAG1 S TAG1="DiagnosticCode"
"RTN","MAGVIMRA",84,0)
 . N IEN
"RTN","MAGVIMRA",85,0)
 . S IEN=0 F  S IEN=$O(^RA(FILE,IEN)) Q:IEN]"A"  D RADDX(TAG1,IEN)
"RTN","MAGVIMRA",86,0)
 . Q
"RTN","MAGVIMRA",87,0)
 S OUT($$C())=$$XMTAG(TAG0,1)
"RTN","MAGVIMRA",88,0)
 Q
"RTN","MAGVIMRA",89,0)
 ;+++++ Return IMAGING LOCATIONS file (#79.1) data w/ XML tags.
"RTN","MAGVIMRA",90,0)
 ;
"RTN","MAGVIMRA",91,0)
 ;   RPC: MAGV GET RAD DX CODES
"RTN","MAGVIMRA",92,0)
 ;
"RTN","MAGVIMRA",93,0)
 ; Input
"RTN","MAGVIMRA",94,0)
 ;
"RTN","MAGVIMRA",95,0)
 ;  OUT        Array holding the results to return.
"RTN","MAGVIMRA",96,0)
 ;
"RTN","MAGVIMRA",97,0)
 ; Output
"RTN","MAGVIMRA",98,0)
 ;
"RTN","MAGVIMRA",99,0)
 ;  Array of XML tagged IMAGING LOCATIONS file (#79.1) data.
"RTN","MAGVIMRA",100,0)
 ;
"RTN","MAGVIMRA",101,0)
 ;--- Drive output assembly for one IMAGING LOCATIONS file (#78.3) record.
"RTN","MAGVIMRA",102,0)
GETRADLC(OUT) ;
"RTN","MAGVIMRA",103,0)
 N FILE S FILE=79.1
"RTN","MAGVIMRA",104,0)
 N C S C=0
"RTN","MAGVIMRA",105,0)
 ;--- IA #3561 (Supported)
"RTN","MAGVIMRA",106,0)
 S OUT(C)=$$XMLHDR^MXMLUTL()
"RTN","MAGVIMRA",107,0)
 N TAG0 S TAG0="ArrayOfImagingLocation"
"RTN","MAGVIMRA",108,0)
 S OUT($$C())=$$XMTAG(TAG0,0) D
"RTN","MAGVIMRA",109,0)
 . ;
"RTN","MAGVIMRA",110,0)
 . ;--- Read of ^RA(78.3,IEN, is IA #6007 (Private).
"RTN","MAGVIMRA",111,0)
 . N TAG1 S TAG1="ImagingLocation"
"RTN","MAGVIMRA",112,0)
 . N IEN,INACTIVE
"RTN","MAGVIMRA",113,0)
 . S IEN=0 F  S IEN=$O(^RA(FILE,IEN)) Q:IEN]"A"  D
"RTN","MAGVIMRA",114,0)
 .. S INACTIVE=$$GET1^DIQ(FILE,IEN,19,"I")  ;; p164 Check the location is active
"RTN","MAGVIMRA",115,0)
 .. I (INACTIVE="")!(INACTIVE>$$DT^XLFDT) D RADLOC^MAGVIMRA(TAG1,IEN)
"RTN","MAGVIMRA",116,0)
 .. Q
"RTN","MAGVIMRA",117,0)
 . Q
"RTN","MAGVIMRA",118,0)
 S OUT($$C())=$$XMTAG(TAG0,1)
"RTN","MAGVIMRA",119,0)
 Q
"RTN","MAGVIMRA",120,0)
 ;--- Drive output assembly for one DIAGNOSTIC CODES file (#78.3) record.
"RTN","MAGVIMRA",121,0)
RADDX(TAG1,IEN) ;
"RTN","MAGVIMRA",122,0)
 S OUT($$C())=$$XMTAG(TAG1,0) D
"RTN","MAGVIMRA",123,0)
 . N STRING
"RTN","MAGVIMRA",124,0)
 . S OUT($$C())=$$STRING("Id",IEN)
"RTN","MAGVIMRA",125,0)
 . S STRING=$$GET1^DIQ(FILE,IEN,.01)
"RTN","MAGVIMRA",126,0)
 . S OUT($$C())=$$STRING("Name",STRING)
"RTN","MAGVIMRA",127,0)
 . S STRING=$$GET1^DIQ(FILE,IEN,2)
"RTN","MAGVIMRA",128,0)
 . S OUT($$C())=$$STRING("Description",IEN)
"RTN","MAGVIMRA",129,0)
 . Q
"RTN","MAGVIMRA",130,0)
 S OUT($$C())=$$XMTAG(TAG1,1)
"RTN","MAGVIMRA",131,0)
 Q
"RTN","MAGVIMRA",132,0)
 ;--- Drive output assembly for one IMAGING LOCATIONS file (#79.1) record.
"RTN","MAGVIMRA",133,0)
RADLOC(TAG1,IEN) ;
"RTN","MAGVIMRA",134,0)
 S OUT($$C())=$$XMTAG(TAG1,0) D
"RTN","MAGVIMRA",135,0)
 . N STRING
"RTN","MAGVIMRA",136,0)
 . S OUT($$C())=$$STRING("Id",IEN)
"RTN","MAGVIMRA",137,0)
 . S STRING=$$GET1^DIQ(FILE,IEN,.01)
"RTN","MAGVIMRA",138,0)
 . S OUT($$C())=$$STRING("Name",STRING)
"RTN","MAGVIMRA",139,0)
 . S STRING=$$GET1^DIQ(FILE,IEN,21)
"RTN","MAGVIMRA",140,0)
 . S OUT($$C())=$$STRING("CreditMethod",STRING)
"RTN","MAGVIMRA",141,0)
 . Q
"RTN","MAGVIMRA",142,0)
 S OUT($$C())=$$XMTAG(TAG1,1)
"RTN","MAGVIMRA",143,0)
 Q
"RTN","MAGVIMRA",144,0)
 ;--- Drive output assembly for one STANDARD REPORT file (#78.1) record.
"RTN","MAGVIMRA",145,0)
RADSR(TAG1,IEN) ;
"RTN","MAGVIMRA",146,0)
 S OUT($$C())=$$XMTAG(TAG1,0) D
"RTN","MAGVIMRA",147,0)
 . S OUT($$C())=$$STRING("Id",IEN)
"RTN","MAGVIMRA",148,0)
 . S STRING=$$GET1^DIQ(FILE,IEN,.01)
"RTN","MAGVIMRA",149,0)
 . S OUT($$C())=$$STRING("ReportName",STRING)
"RTN","MAGVIMRA",150,0)
 . ;
"RTN","MAGVIMRA",151,0)
 . ;--- Handle word-processing fields.
"RTN","MAGVIMRA",152,0)
 . D WPTXT("ReportText",FILE,200,IEN)
"RTN","MAGVIMRA",153,0)
 . D WPTXT("Impression",FILE,300,IEN)
"RTN","MAGVIMRA",154,0)
 . Q
"RTN","MAGVIMRA",155,0)
 S OUT($$C())=$$XMTAG(TAG1,1)
"RTN","MAGVIMRA",156,0)
 Q
"RTN","MAGVIMRA",157,0)
 ;--- Tag an input string.
"RTN","MAGVIMRA",158,0)
STRING(TAG,STRING) ;
"RTN","MAGVIMRA",159,0)
 N ITEM
"RTN","MAGVIMRA",160,0)
 S ITEM=$$XMTAG(TAG,0)
"RTN","MAGVIMRA",161,0)
 ;--- Translate embedded reserved XML symbols. IA #4153 (Supported).
"RTN","MAGVIMRA",162,0)
 S ITEM=ITEM_$$SYMENC^MXMLUTL(STRING)
"RTN","MAGVIMRA",163,0)
 S ITEM=ITEM_$$XMTAG(TAG,1)
"RTN","MAGVIMRA",164,0)
 Q ITEM
"RTN","MAGVIMRA",165,0)
 ;
"RTN","MAGVIMRA",166,0)
 ;--- Tag a word processing field.
"RTN","MAGVIMRA",167,0)
WPTXT(TAG,FILE,FIELD,IEN) ;
"RTN","MAGVIMRA",168,0)
 S OUT($$C())=$$XMTAG(TAG,0)
"RTN","MAGVIMRA",169,0)
 ;
"RTN","MAGVIMRA",170,0)
 ;--- Word Processing Field
"RTN","MAGVIMRA",171,0)
 K TXTERR,TXTWP
"RTN","MAGVIMRA",172,0)
 N ITEM
"RTN","MAGVIMRA",173,0)
 S ITEM=$$GET1^DIQ(FILE,IEN,FIELD,,"TXTWP","TXTERR")
"RTN","MAGVIMRA",174,0)
 ;
"RTN","MAGVIMRA",175,0)
 ;--- Translate embedded reserved XML symbols. IA #4153 (Supported).
"RTN","MAGVIMRA",176,0)
 N NDX
"RTN","MAGVIMRA",177,0)
 S NDX=0
"RTN","MAGVIMRA",178,0)
 F  S NDX=$O(TXTWP(NDX)) Q:NDX=""  S OUT($$C())=$$SYMENC^MXMLUTL(TXTWP(NDX))
"RTN","MAGVIMRA",179,0)
 S OUT($$C())=$$XMTAG(TAG,1)
"RTN","MAGVIMRA",180,0)
 Q
"RTN","MAGVIMRA",181,0)
 ;--- Enclose a tag.
"RTN","MAGVIMRA",182,0)
XMTAG(TAG,END) ;
"RTN","MAGVIMRA",183,0)
 S OUT="<"
"RTN","MAGVIMRA",184,0)
 S:END OUT=OUT_"/"
"RTN","MAGVIMRA",185,0)
 S OUT=OUT_TAG
"RTN","MAGVIMRA",186,0)
 S OUT=OUT_">"
"RTN","MAGVIMRA",187,0)
 Q OUT
"RTN","MAGVIMRA",188,0)
 ;
"RTN","MAGVIMRA",189,0)
 ; MAGVIMRA
"VER")
8.0^22.0
**END**
**END**
