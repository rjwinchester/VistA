KIDS Distribution saved on Dec 02, 2014@15:02:32
MAG*3.0*154 BP PATCH
**KIDS**:MAG*3.0*154^

**INSTALL NAME**
MAG*3.0*154
"BLD",8326,0)
MAG*3.0*154^IMAGING^0^3141202^y
"BLD",8326,1,0)
^^1^1^3140917^
"BLD",8326,1,1,0)
Version 3.0 Patch 154 BACKGROUND PROCESSOR
"BLD",8326,4,0)
^9.64PA^2006.1^2
"BLD",8326,4,2005.2,0)
2005.2
"BLD",8326,4,2005.2,2,0)
^9.641^2005.2^1
"BLD",8326,4,2005.2,2,2005.2,0)
NETWORK LOCATION  (File-top level)
"BLD",8326,4,2005.2,2,2005.2,1,0)
^9.6411^4^3
"BLD",8326,4,2005.2,2,2005.2,1,2,0)
TOTAL SPACE
"BLD",8326,4,2005.2,2,2005.2,1,3,0)
SPACE USED
"BLD",8326,4,2005.2,2,2005.2,1,4,0)
FREE SPACE
"BLD",8326,4,2005.2,222)
y^n^p^^^^n^^n
"BLD",8326,4,2005.2,224)

"BLD",8326,4,2006.1,0)
2006.1
"BLD",8326,4,2006.1,2,0)
^9.641^2006.1^1
"BLD",8326,4,2006.1,2,2006.1,0)
IMAGING SITE PARAMETERS  (File-top level)
"BLD",8326,4,2006.1,2,2006.1,1,0)
^9.6411^60.5^1
"BLD",8326,4,2006.1,2,2006.1,1,60.5,0)
RAID PURGE FACTOR
"BLD",8326,4,2006.1,222)
y^n^p^^^^n^^n
"BLD",8326,4,2006.1,224)

"BLD",8326,4,"APDD",2005.2,2005.2)

"BLD",8326,4,"APDD",2005.2,2005.2,2)

"BLD",8326,4,"APDD",2005.2,2005.2,3)

"BLD",8326,4,"APDD",2005.2,2005.2,4)

"BLD",8326,4,"APDD",2006.1,2006.1)

"BLD",8326,4,"APDD",2006.1,2006.1,60.5)

"BLD",8326,4,"B",2005.2,2005.2)

"BLD",8326,4,"B",2006.1,2006.1)

"BLD",8326,6.3)
9
"BLD",8326,"ABNS",0)
^9.66A^1^1
"BLD",8326,"ABNS",1,0)
MAG
"BLD",8326,"ABNS",1,1,0)
^9.661A^^
"BLD",8326,"ABNS","B","MAG",1)

"BLD",8326,"ABPKG")
n^n^G.IMAGING DEVELOPMENT TEAM@DOMAIN.EXT
"BLD",8326,"INID")
^y
"BLD",8326,"INIT")
POS^MAGIP154
"BLD",8326,"KRN",0)
^9.67PA^779.2^20
"BLD",8326,"KRN",.4,0)
.4
"BLD",8326,"KRN",.401,0)
.401
"BLD",8326,"KRN",.402,0)
.402
"BLD",8326,"KRN",.403,0)
.403
"BLD",8326,"KRN",.5,0)
.5
"BLD",8326,"KRN",.84,0)
.84
"BLD",8326,"KRN",3.6,0)
3.6
"BLD",8326,"KRN",3.8,0)
3.8
"BLD",8326,"KRN",9.2,0)
9.2
"BLD",8326,"KRN",9.8,0)
9.8
"BLD",8326,"KRN",9.8,"NM",0)
^9.68A^7^7
"BLD",8326,"KRN",9.8,"NM",1,0)
MAGIP154^^0^B4013654
"BLD",8326,"KRN",9.8,"NM",2,0)
MAGQBPG1^^0^B113868040
"BLD",8326,"KRN",9.8,"NM",3,0)
MAGQBUT5^^0^B105589397
"BLD",8326,"KRN",9.8,"NM",4,0)
MAGQBUT6^^0^B145956336
"BLD",8326,"KRN",9.8,"NM",5,0)
MAGQCBP^^0^B120470319
"BLD",8326,"KRN",9.8,"NM",6,0)
MAGBAPI^^0^B85423162
"BLD",8326,"KRN",9.8,"NM",7,0)
MAGGSIU5^^0^B49972780
"BLD",8326,"KRN",9.8,"NM","B","MAGBAPI",6)

"BLD",8326,"KRN",9.8,"NM","B","MAGGSIU5",7)

"BLD",8326,"KRN",9.8,"NM","B","MAGIP154",1)

"BLD",8326,"KRN",9.8,"NM","B","MAGQBPG1",2)

"BLD",8326,"KRN",9.8,"NM","B","MAGQBUT5",3)

"BLD",8326,"KRN",9.8,"NM","B","MAGQBUT6",4)

"BLD",8326,"KRN",9.8,"NM","B","MAGQCBP",5)

"BLD",8326,"KRN",19,0)
19
"BLD",8326,"KRN",19.1,0)
19.1
"BLD",8326,"KRN",101,0)
101
"BLD",8326,"KRN",409.61,0)
409.61
"BLD",8326,"KRN",771,0)
771
"BLD",8326,"KRN",779.2,0)
779.2
"BLD",8326,"KRN",870,0)
870
"BLD",8326,"KRN",8989.51,0)
8989.51
"BLD",8326,"KRN",8989.52,0)
8989.52
"BLD",8326,"KRN",8994,0)
8994
"BLD",8326,"KRN","B",.4,.4)

"BLD",8326,"KRN","B",.401,.401)

"BLD",8326,"KRN","B",.402,.402)

"BLD",8326,"KRN","B",.403,.403)

"BLD",8326,"KRN","B",.5,.5)

"BLD",8326,"KRN","B",.84,.84)

"BLD",8326,"KRN","B",3.6,3.6)

"BLD",8326,"KRN","B",3.8,3.8)

"BLD",8326,"KRN","B",9.2,9.2)

"BLD",8326,"KRN","B",9.8,9.8)

"BLD",8326,"KRN","B",19,19)

"BLD",8326,"KRN","B",19.1,19.1)

"BLD",8326,"KRN","B",101,101)

"BLD",8326,"KRN","B",409.61,409.61)

"BLD",8326,"KRN","B",771,771)

"BLD",8326,"KRN","B",779.2,779.2)

"BLD",8326,"KRN","B",870,870)

"BLD",8326,"KRN","B",8989.51,8989.51)

"BLD",8326,"KRN","B",8989.52,8989.52)

"BLD",8326,"KRN","B",8994,8994)

"BLD",8326,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",8326,"QUES",0)
^9.62^^
"BLD",8326,"REQB",0)
^9.611^1^1
"BLD",8326,"REQB",1,0)
MAG*3.0*143^1
"BLD",8326,"REQB","B","MAG*3.0*143",1)

"FIA",2005.2)
NETWORK LOCATION
"FIA",2005.2,0)
^MAG(2005.2,
"FIA",2005.2,0,0)
2005.2
"FIA",2005.2,0,1)
y^n^p^^^^n^^n
"FIA",2005.2,0,10)

"FIA",2005.2,0,11)

"FIA",2005.2,0,"RLRO")

"FIA",2005.2,0,"VR")
3.0^MAG
"FIA",2005.2,2005.2)
1
"FIA",2005.2,2005.2,2)

"FIA",2005.2,2005.2,3)

"FIA",2005.2,2005.2,4)

"FIA",2006.1)
IMAGING SITE PARAMETERS
"FIA",2006.1,0)
^MAG(2006.1,
"FIA",2006.1,0,0)
2006.1P
"FIA",2006.1,0,1)
y^n^p^^^^n^^n
"FIA",2006.1,0,10)

"FIA",2006.1,0,11)

"FIA",2006.1,0,"RLRO")

"FIA",2006.1,0,"VR")
3.0^MAG
"FIA",2006.1,2006.1)
1
"FIA",2006.1,2006.1,60.5)

"INIT")
POS^MAGIP154
"MBREQ")
0
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging-V1 to release 
"PKG",454,20,0)
^9.402P^^
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020319^3020517^126
"PKG",454,22,1,"PAH",1,0)
154^3141202^126
"PKG",454,22,1,"PAH",1,1,0)
^^1^1^3141202
"PKG",454,22,1,"PAH",1,1,1,0)
Version 3.0 Patch 154 BACKGROUND PROCESSOR
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","MAGBAPI")
0^6^B85423162
"RTN","MAGBAPI",1,0)
MAGBAPI ;WOIFO/PMK,RMP,SEB,MLH - Background Processor API to build queues ; 27 Aug 2014 5:12 PM
"RTN","MAGBAPI",2,0)
 ;;3.0;IMAGING;**1,7,8,20,39,154**;Mar 19, 2002;Build 9;Mar 08, 2011
"RTN","MAGBAPI",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGBAPI",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBAPI",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGBAPI",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGBAPI",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGBAPI",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGBAPI",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGBAPI",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGBAPI",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGBAPI",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGBAPI",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGBAPI",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGBAPI",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGBAPI",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBAPI",17,0)
 ;;
"RTN","MAGBAPI",18,0)
 Q
"RTN","MAGBAPI",19,0)
 ; The API returns the entry's queue pointer
"RTN","MAGBAPI",20,0)
 ;
"RTN","MAGBAPI",21,0)
ABSTRACT(INPUT,PLACE) ; Entry point to create an image abstract
"RTN","MAGBAPI",22,0)
 ; input = image pointer
"RTN","MAGBAPI",23,0)
 Q:$$IMOFFLN^MAGFILEB($P($G(^MAG(2005,INPUT,0)),U,2)) 0
"RTN","MAGBAPI",24,0)
 S PLACE=$$GETPLACE($G(PLACE)) Q:'PLACE 0 ; DBI - SEB Patch 4
"RTN","MAGBAPI",25,0)
 Q $$QUEUE("ABSTRACT",INPUT,PLACE)
"RTN","MAGBAPI",26,0)
 ;
"RTN","MAGBAPI",27,0)
GCC(INPUT,PLACE) ; Entry point to create an Document Imaging Export Copy
"RTN","MAGBAPI",28,0)
 ; input = image pointer(^Second Piece Optional Location specified^3rd optional extension(s) specifier
"RTN","MAGBAPI",29,0)
 ; plus "~" separated alternate source file types
"RTN","MAGBAPI",30,0)
 S PLACE=$$GETPLACE($G(PLACE)) Q:'PLACE 0 ; DBI - SEB Patch 4
"RTN","MAGBAPI",31,0)
 Q $$QUEUE("GCC",$P(INPUT,"^")_"^^"_$P(INPUT,"^",4)_"^"_$P(INPUT,"^",2,3),PLACE)
"RTN","MAGBAPI",32,0)
JUKEBOX(INPUT,PLACE) ; Entry point to copy an image file and abstract to the Jukebox / input = image pointer
"RTN","MAGBAPI",33,0)
 N NEXT,CONS,GB
"RTN","MAGBAPI",34,0)
 S GB=$G(^MAG(2005,+$P(INPUT,U),0))
"RTN","MAGBAPI",35,0)
 S:GB="" GB=$G(^MAG(2005.1,+$P(INPUT,U),0))
"RTN","MAGBAPI",36,0)
 Q:GB="" 0
"RTN","MAGBAPI",37,0)
 Q:$$IMOFFLN^MAGFILEB($P(GB,U,2)) 0
"RTN","MAGBAPI",38,0)
 S PLACE=$$GETPLACE($G(PLACE)) Q:'PLACE 0 ; DBI - SEB Patch 4
"RTN","MAGBAPI",39,0)
 S CONS=$$CONSOLID()
"RTN","MAGBAPI",40,0)
 S NEXT=$O(^MAGQUEUE(2006.03,"E",PLACE,$P(INPUT,"^"),$$NEXTQ("JUKEBOX",PLACE)))
"RTN","MAGBAPI",41,0)
 Q:NEXT?1N.N NEXT
"RTN","MAGBAPI",42,0)
 S NEXT=$$QUEUE("JUKEBOX",INPUT,PLACE)
"RTN","MAGBAPI",43,0)
 Q:'NEXT NEXT
"RTN","MAGBAPI",44,0)
 S ^MAGQUEUE(2006.03,"E",PLACE,$P(INPUT,"^"),NEXT)=""
"RTN","MAGBAPI",45,0)
 Q NEXT
"RTN","MAGBAPI",46,0)
DELETE(INPUT,PLACE) ; Entry point to delete a file (literally from anywhere) / input = full path of file to delete
"RTN","MAGBAPI",47,0)
 N IMOD
"RTN","MAGBAPI",48,0)
 S IMOD=$S(INPUT[U:"^^"_INPUT,1:"^^^"_INPUT)
"RTN","MAGBAPI",49,0)
 S PLACE=$$GETPLACE($G(PLACE)) Q:'PLACE 0 ; DBI - SEB Patch 4
"RTN","MAGBAPI",50,0)
 Q $$QUEUE("DELETE",IMOD,PLACE) ;SETS 9TH & 10TH PIECE
"RTN","MAGBAPI",51,0)
IMPORT(INPUT,CALLBACK,TRACKID,PLACE) ; Entry point to import a file
"RTN","MAGBAPI",52,0)
 ; input = Image Parameter Array
"RTN","MAGBAPI",53,0)
 N QUEIEN,INDX,FDA,DINUM,MS1,CT,REQUE,TMP
"RTN","MAGBAPI",54,0)
 S PLACE=$$GETPLACE($G(PLACE)) Q:'PLACE "0^Missing PLACE parameter" ; DBI - SEB Patch 4
"RTN","MAGBAPI",55,0)
 S REQUE=$S($P($G(INPUT),"^",3)'?1N.N:0,1:1)
"RTN","MAGBAPI",56,0)
 I REQUE=0 Q:($O(^MAG(2006.041,"C",TRACKID,""))?1N.N) "0^Duplicate Tracking ID"
"RTN","MAGBAPI",57,0)
 S QUEIEN=$$QUEUE("IMPORT","^^"_$P($G(INPUT),"^",3)_U_$TR(CALLBACK,"^","|")_U_$P($G(INPUT),"^",4),PLACE)
"RTN","MAGBAPI",58,0)
 I REQUE=0 D
"RTN","MAGBAPI",59,0)
 . S $P(^MAGQUEUE(2006.03,QUEIEN,0),"^",11)=QUEIEN
"RTN","MAGBAPI",60,0)
 . S (DINUM,X)=QUEIEN,DIC="^MAG(2006.034,",DLAYGO="2006.034",DIC(0)="L"
"RTN","MAGBAPI",61,0)
 . K D0
"RTN","MAGBAPI",62,0)
 . D FILE^DICN
"RTN","MAGBAPI",63,0)
 . K DIC,D0,DLAYGO
"RTN","MAGBAPI",64,0)
 . S CT=0
"RTN","MAGBAPI",65,0)
 . D CONV^MAGQBUT4(.INPUT,.CT)
"RTN","MAGBAPI",66,0)
 . D MRGMULT^MAGQBUT4(.INPUT,"^MAG(2006.034,"_QUEIEN_",1,","2006.341A",CT)
"RTN","MAGBAPI",67,0)
 . Q
"RTN","MAGBAPI",68,0)
 K DIE,FDA
"RTN","MAGBAPI",69,0)
 S FDA(2006.041,"+1,",.01)=$S(REQUE=0:QUEIEN,1:$P($G(INPUT),"^",4))
"RTN","MAGBAPI",70,0)
 S FDA(2006.041,"+1,",.02)=TRACKID
"RTN","MAGBAPI",71,0)
 S FDA(2006.041,"+1,",1)=$S(REQUE=0:"QUEUING",1:"REQUEUING")
"RTN","MAGBAPI",72,0)
 S FDA(2006.041,"+1,",2)=$$NOW^XLFDT
"RTN","MAGBAPI",73,0)
 D UPDATE^DIE("U","FDA","","MAGIMP")
"RTN","MAGBAPI",74,0)
 I $D(DIERR) S TMP=MAGIMP("DIERR",1,"TEXT",1) K DIERR,MAGIMP
"RTN","MAGBAPI",75,0)
 Q $S($D(TMP):"0^"_TMP,1:QUEIEN)
"RTN","MAGBAPI",76,0)
 ;
"RTN","MAGBAPI",77,0)
JBTOHD(INPUT,PLACE) ; Entry point to copy an image from the Jukebox to the Hard Disk
"RTN","MAGBAPI",78,0)
 ; input = image pointer ^ FULL or ABSTRACT or BIG
"RTN","MAGBAPI",79,0)
 N NEXT,IEN,JDTYPE,CONS
"RTN","MAGBAPI",80,0)
 S IEN=$P(INPUT,"^"),JDTYPE=$P(INPUT,"^",2)
"RTN","MAGBAPI",81,0)
 Q:$$IMOFFLN^MAGFILEB($P($G(^MAG(2005,IEN,0)),U,2)) 0
"RTN","MAGBAPI",82,0)
 I 'PLACE S PLACE=$$DA2PLC^MAGBAPIP(IEN,$S(JDTYPE["ABSTRACT":"A",JDTYPE["BIG":"B",1:"F"))
"RTN","MAGBAPI",83,0)
 E  S PLACE=$$GETPLACE($G(PLACE)) Q:'PLACE 0 ; DBI - SEB Patch 4
"RTN","MAGBAPI",84,0)
 S NEXT=$O(^MAGQUEUE(2006.03,"F",PLACE,IEN,JDTYPE,$$NEXTQ("JBTOHD",PLACE)))
"RTN","MAGBAPI",85,0)
 Q:NEXT?1N.N NEXT
"RTN","MAGBAPI",86,0)
 S NEXT=$$QUEUE("JBTOHD",INPUT,PLACE)
"RTN","MAGBAPI",87,0)
 Q:'NEXT NEXT
"RTN","MAGBAPI",88,0)
 S ^MAGQUEUE(2006.03,"F",PLACE,$P(INPUT,"^"),$P(INPUT,"^",2),NEXT)=""
"RTN","MAGBAPI",89,0)
 Q NEXT
"RTN","MAGBAPI",90,0)
 ;
"RTN","MAGBAPI",91,0)
PREFET(INPUT,PLACE) ;
"RTN","MAGBAPI",92,0)
 ; input = image pointer ^ FULL or ABSTRACT or BIG
"RTN","MAGBAPI",93,0)
 N NEXT,IEN,JDTYPE,CONS
"RTN","MAGBAPI",94,0)
 S IEN=$P(INPUT,"^"),JDTYPE=$P(INPUT,"^",2)
"RTN","MAGBAPI",95,0)
 Q:$$IMOFFLN^MAGFILEB($P($G(^MAG(2005,IEN,0)),U,2)) 0
"RTN","MAGBAPI",96,0)
 I 'PLACE S PLACE=$$DA2PLC^MAGBAPIP(IEN,$S(JDTYPE["ABSTRACT":"A",JDTYPE["BIG":"B",1:"F"))
"RTN","MAGBAPI",97,0)
 E  S PLACE=$$GETPLACE($G(PLACE)) Q:'PLACE 0 ; DBI - SEB Patch 4
"RTN","MAGBAPI",98,0)
 S IEN=$P(INPUT,"^"),JDTYPE=$P(INPUT,"^",2)
"RTN","MAGBAPI",99,0)
 S NEXT=$O(^MAGQUEUE(2006.03,"F",PLACE,IEN,JDTYPE,$$NEXTQ("PREFET",PLACE)))
"RTN","MAGBAPI",100,0)
 Q:NEXT?1N.N NEXT
"RTN","MAGBAPI",101,0)
 S NEXT=$$QUEUE("PREFET",INPUT,PLACE)
"RTN","MAGBAPI",102,0)
 Q:'NEXT NEXT
"RTN","MAGBAPI",103,0)
 S ^MAGQUEUE(2006.03,"F",PLACE,$P(INPUT,"^"),$P(INPUT,"^",2),NEXT)=""
"RTN","MAGBAPI",104,0)
 Q NEXT
"RTN","MAGBAPI",105,0)
 ;
"RTN","MAGBAPI",106,0)
EVAL(IMAGE,PLACE) ; Entry point for before rules are evaluated
"RTN","MAGBAPI",107,0)
 S PLACE=$$GETPLACE($G(PLACE)) Q:'PLACE 0 ; DBI - SEB Patch 4
"RTN","MAGBAPI",108,0)
 Q $$QUEUE("EVAL",IMAGE,PLACE)
"RTN","MAGBAPI",109,0)
 ;
"RTN","MAGBAPI",110,0)
NEXTQ(TYPE,PLACE) ;
"RTN","MAGBAPI",111,0)
 N X
"RTN","MAGBAPI",112,0)
 S PLACE=$$GETPLACE($G(PLACE)) Q:'PLACE 0 ; DBI - SEB Patch 4
"RTN","MAGBAPI",113,0)
 S X=$O(^MAGQUEUE(2006.031,"C",PLACE,TYPE,""))
"RTN","MAGBAPI",114,0)
 Q $S('X:X,1:$P(^MAGQUEUE(2006.031,X,0),"^",2))
"RTN","MAGBAPI",115,0)
 ;
"RTN","MAGBAPI",116,0)
QUEUE(Q,INPUT,PLACE) ; Stuff the entry (header + INPUT) into the appropriate queue (Q)
"RTN","MAGBAPI",117,0)
 N MAGTIME,QPTR,QTR,X,Y,STATUS,AQSQ
"RTN","MAGBAPI",118,0)
 S U="^",STATUS="NOT_PROCESSED"
"RTN","MAGBAPI",119,0)
 S PLACE=$$GETPLACE($G(PLACE)) Q:'PLACE 0 ; DBI - SEB Patch 4
"RTN","MAGBAPI",120,0)
 Q:(((Q'["DELETE")&(Q'["IMPORT"))&($P(INPUT,U,1)'?1N.N)) 0
"RTN","MAGBAPI",121,0)
 ; increment the QPTR
"RTN","MAGBAPI",122,0)
 L +^MAGQUEUE(2006.03,0):1E9
"RTN","MAGBAPI",123,0)
 S X=^MAGQUEUE(2006.03,0)
"RTN","MAGBAPI",124,0)
 S QPTR=$O(^MAGQUEUE(2006.03," "),-1)+1
"RTN","MAGBAPI",125,0)
 S QPTR=$S(QPTR'>+$P(X,U,3):$P(X,U,3)+1,1:QPTR)  ;p154
"RTN","MAGBAPI",126,0)
 S AQSQ=$O(^MAG(2006.041,"B"," "),-1)+1          ;p154
"RTN","MAGBAPI",127,0)
 I AQSQ>QPTR S QPTR=AQSQ                         ;p154
"RTN","MAGBAPI",128,0)
 S $P(X,"^",3)=QPTR,$P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGBAPI",129,0)
 S ^MAGQUEUE(2006.03,0)=X
"RTN","MAGBAPI",130,0)
 S MAGTIME=$$NOW^XLFDT
"RTN","MAGBAPI",131,0)
 S ^MAGQUEUE(2006.03,QPTR,0)=Q_"^"_$G(DUZ)_"^"_^%ZOSF("VOL")_"^"_MAGTIME_"^"_STATUS_"^"_MAGTIME_"^"_INPUT
"RTN","MAGBAPI",132,0)
 S ^MAGQUEUE(2006.03,"C",PLACE,Q,QPTR)="",$P(^MAGQUEUE(2006.03,QPTR,0),"^",12)=PLACE
"RTN","MAGBAPI",133,0)
 S ^MAGQUEUE(2006.03,"D",PLACE,Q,STATUS,QPTR)=""
"RTN","MAGBAPI",134,0)
 L -^MAGQUEUE(2006.03,0)
"RTN","MAGBAPI",135,0)
 D ADD(1,Q,PLACE)
"RTN","MAGBAPI",136,0)
 Q QPTR
"RTN","MAGBAPI",137,0)
ADD(N,QUEUE,PLACE) ;
"RTN","MAGBAPI",138,0)
 ;
"RTN","MAGBAPI",139,0)
 N CNT,D0,I,X,CONS,PREV,QTOT
"RTN","MAGBAPI",140,0)
 S PLACE=$$GETPLACE($G(PLACE)) Q:'PLACE 0
"RTN","MAGBAPI",141,0)
 S D0=$O(^MAGQUEUE(2006.031,"C",PLACE,QUEUE,""))
"RTN","MAGBAPI",142,0)
 D:'D0
"RTN","MAGBAPI",143,0)
 . L +^MAGQUEUE(2006.031):1E9
"RTN","MAGBAPI",144,0)
 . S D0=$O(^MAGQUEUE(2006.031," "),-1)+1
"RTN","MAGBAPI",145,0)
 . S ^MAGQUEUE(2006.031,D0,0)=QUEUE_"^0^0^"_PLACE_U
"RTN","MAGBAPI",146,0)
 . S ^MAGQUEUE(2006.031,"C",PLACE,QUEUE,D0)=""
"RTN","MAGBAPI",147,0)
 . S X="IMAGE BACKGROUND QUEUE POINTER^2006.031^"_D0_"^"_D0
"RTN","MAGBAPI",148,0)
 . S ^MAGQUEUE(2006.031,0)=X
"RTN","MAGBAPI",149,0)
 . L -^MAGQUEUE(2006.031)
"RTN","MAGBAPI",150,0)
 . Q
"RTN","MAGBAPI",151,0)
 L +^MAGQUEUE(2006.031,D0):1E9
"RTN","MAGBAPI",152,0)
 S X=^MAGQUEUE(2006.031,D0,0),CNT=$P(X,U,3),PREV=$P(X,U,2),QTOT=$P(X,U,5)
"RTN","MAGBAPI",153,0)
 I CNT?1.N S CNT=CNT+N
"RTN","MAGBAPI",154,0)
 E  D
"RTN","MAGBAPI",155,0)
 . S I=$P(X,"^",2),CNT=0
"RTN","MAGBAPI",156,0)
 . F  S I=$O(^MAGQUEUE(2006.03,"C",PLACE,QUEUE,I)) Q:I'?1N.N  S CNT=CNT+1
"RTN","MAGBAPI",157,0)
 . Q
"RTN","MAGBAPI",158,0)
 S $P(X,U,4)=PLACE
"RTN","MAGBAPI",159,0)
 S:N>0 QTOT=QTOT+N
"RTN","MAGBAPI",160,0)
 ; In order to avoid the new queue from being skipped...
"RTN","MAGBAPI",161,0)
 I QUEUE'["IMPORT",$D(QPTR),QPTR<(PREV+1) S $P(X,"^",2)=QPTR-1,$P(X,"^",6)=$$NOW^XLFDT
"RTN","MAGBAPI",162,0)
 S $P(X,U,3)=CNT,$P(X,U,5)=QTOT,^MAGQUEUE(2006.031,D0,0)=X
"RTN","MAGBAPI",163,0)
 L -^MAGQUEUE(2006.031,D0)
"RTN","MAGBAPI",164,0)
 Q
"RTN","MAGBAPI",165,0)
CWL(PLACE) ;Current Write Location
"RTN","MAGBAPI",166,0)
 S PLACE=$$GETPLACE($G(PLACE)) Q:'PLACE 0 ; DBI - SEB Patch 4
"RTN","MAGBAPI",167,0)
 Q $P($G(^MAG(2006.1,PLACE,0)),"^",3)
"RTN","MAGBAPI",168,0)
PLACE(IEN) ;
"RTN","MAGBAPI",169,0)
 Q $$GETPLACE(+$O(^MAG(2006.1,"B",IEN,"")))
"RTN","MAGBAPI",170,0)
JBPTR(PLACE) ;Current JukeBox Pointer
"RTN","MAGBAPI",171,0)
 S PLACE=$$GETPLACE($G(PLACE)) Q:'PLACE 0 ; DBI - SEB Patch 4
"RTN","MAGBAPI",172,0)
 Q $P($G(^MAG(2006.1,PLACE,1)),"^",6)
"RTN","MAGBAPI",173,0)
GETPLACE(PLACE) ; Validate place
"RTN","MAGBAPI",174,0)
 N SP
"RTN","MAGBAPI",175,0)
 S SP=$G(PLACE)
"RTN","MAGBAPI",176,0)
 S PLACE=+$S($$CONSOLID():+$G(PLACE),1:$O(^MAG(2006.1," "),-1))
"RTN","MAGBAPI",177,0)
 I PLACE,$P($G(^MAG(2006.1,PLACE,0)),"^",1)="" S PLACE=0
"RTN","MAGBAPI",178,0)
 I 'PLACE,$$MAXREP(10) D
"RTN","MAGBAPI",179,0)
 . N I,MSG,S,T,J,PS
"RTN","MAGBAPI",180,0)
 . S PS=$O(^MAG(2006.1,"B",$$KSP^XUPARAM("INST"),"")) ; PLACE of the VistA host system
"RTN","MAGBAPI",181,0)
 . S MSG="Application process failure"
"RTN","MAGBAPI",182,0)
 . S I=1,MSG(I)="Cannot determine 'place' (location, division, institution) for image."
"RTN","MAGBAPI",183,0)
 . S I=1,MSG(I)=" Production Account: "_$$PROD^XUPROD("1")
"RTN","MAGBAPI",184,0)
 . S T=$J("At",11) F S=$ST-1:-1:0 D
"RTN","MAGBAPI",185,0)
 . . S I=I+1,MSG(I)=T_": "_$ST(S,"PLACE")_" = "_$ST(S,"MCODE"),T="Called From"
"RTN","MAGBAPI",186,0)
 . . Q
"RTN","MAGBAPI",187,0)
 . I $D(MAGARRAY) D
"RTN","MAGBAPI",188,0)
 . . S J="",I=I+1,MSG(I)="MAGARRAY"
"RTN","MAGBAPI",189,0)
 . . F  S J=$O(MAGARRAY(J)) Q:J=""  D
"RTN","MAGBAPI",190,0)
 . . . S I=I+1,MSG(I)="MAGARRAY("_J_")"_MAGARRAY(J)
"RTN","MAGBAPI",191,0)
 . . Q
"RTN","MAGBAPI",192,0)
 . I $D(XWBTBUF) S I=I+1,MSG(I)="XWBTBUF: "_XWBTBUF
"RTN","MAGBAPI",193,0)
 . I $D(MAGDA) S I=I+1,MSG(I)="MAGDA: "_MAGDA
"RTN","MAGBAPI",194,0)
 . I $D(MAGGDA) S I=I+1,MSG(I)="MAGGDA: "_MAGGDA
"RTN","MAGBAPI",195,0)
 . I $D(MAGGIEN("1")) S I=I+1,MSG(I)="MAGGIEN(""1""): "_MAGGIEN("1")
"RTN","MAGBAPI",196,0)
 . S:$G(DUZ) I=I+1,MSG(I)="The USER was: "_$$GET1^DIQ(200,DUZ,".01","E")_" DUZ: "_DUZ
"RTN","MAGBAPI",197,0)
 . S:$G(DUZ(2)) I=I+1,MSG(I)="The USER had a DUZ(2) setting of: "_DUZ(2)
"RTN","MAGBAPI",198,0)
 . S I=I+1,MSG(I)="The original value of the INPUT Parameter 'PLACE' was: "_SP
"RTN","MAGBAPI",199,0)
 . S I=I+1,MSG(I)="This fault may result in the failure to archive or process images."
"RTN","MAGBAPI",200,0)
 . S I=I+1,MSG(I)="The users site of origin needs to have an Associated Institution value"
"RTN","MAGBAPI",201,0)
 . S I=I+1,MSG(I)="setup on the Site Parameters window."
"RTN","MAGBAPI",202,0)
 . S I=I+1,MSG(I)="refer to the BP User manual for instructions."
"RTN","MAGBAPI",203,0)
 . S I="" F  S I=$O(MSG(I)) Q:I=""  D DFNIQ^MAGQBPG1("",MSG(I),0,PS,"$$GETPLACE_MAGBAPI")
"RTN","MAGBAPI",204,0)
 . D DFNIQ^MAGQBPG1("",MSG,1,PS,"$$GETPLACE_MAGBAPI")
"RTN","MAGBAPI",205,0)
 . Q
"RTN","MAGBAPI",206,0)
 Q PLACE
"RTN","MAGBAPI",207,0)
MAXREP(MAX) ;
"RTN","MAGBAPI",208,0)
 N REP,CNT
"RTN","MAGBAPI",209,0)
 I $P($G(^MAG(2006.1,"WARNING","MAGBAPI")),U,1)=$$DT^XLFDT D
"RTN","MAGBAPI",210,0)
 . S CNT=+$P($G(^MAG(2006.1,"WARNING","MAGBAPI")),U,2)+1
"RTN","MAGBAPI",211,0)
 . S REP=$S(CNT<MAX:1,1:0)
"RTN","MAGBAPI",212,0)
 . S $P(^MAG(2006.1,"WARNING","MAGBAPI"),U,2)=CNT
"RTN","MAGBAPI",213,0)
 . Q
"RTN","MAGBAPI",214,0)
 E  D
"RTN","MAGBAPI",215,0)
 . I $D(^MAG(2006.1,"WARNING","MAGBAPI")) D
"RTN","MAGBAPI",216,0)
 . . N I,MSG,PS
"RTN","MAGBAPI",217,0)
 . . S PS=$O(^MAG(2006.1,"B",$$KSP^XUPARAM("INST"),""))
"RTN","MAGBAPI",218,0)
 . . S MSG="Application process failure Count"
"RTN","MAGBAPI",219,0)
 . . S I=1,MSG(I)="On the following date: "_$P(^MAG(2006.1,"WARNING","MAGBAPI"),U,1)
"RTN","MAGBAPI",220,0)
 . . S I=I+1,MSG(I)=$P(^MAG(2006.1,"WARNING","MAGBAPI"),U,2)_" were logged on the host system"
"RTN","MAGBAPI",221,0)
 . . S I=I+1,MSG(I)="The Vista Imaging Development and support team is being notified."
"RTN","MAGBAPI",222,0)
 . . S I="" F  S I=$O(MSG(I)) Q:I=""  D DFNIQ^MAGQBPG1("",MSG(I),0,PS,"$$GETPLACE_MAGBAPI")
"RTN","MAGBAPI",223,0)
 . . D DFNIQ^MAGQBPG1("",MSG,1,PS,"$$GETPLACE_MAGBAPI")
"RTN","MAGBAPI",224,0)
 . . Q
"RTN","MAGBAPI",225,0)
 . S REP=1,$P(^MAG(2006.1,"WARNING","MAGBAPI"),U,1,2)=$$DT^XLFDT_U_1
"RTN","MAGBAPI",226,0)
 . Q
"RTN","MAGBAPI",227,0)
 Q REP
"RTN","MAGBAPI",228,0)
CWG(PL) ;Returns the Current RAID Group
"RTN","MAGBAPI",229,0)
 Q $P($G(^MAG(2006.1,PL,0)),U,10)
"RTN","MAGBAPI",230,0)
CONSOLID() ;
"RTN","MAGBAPI",231,0)
 Q $GET(^MAG(2006.1,"CONSOLIDATED"))="YES"
"RTN","MAGBAPI",232,0)
CONRPC(RESULT) ;[MAGG CONS]
"RTN","MAGBAPI",233,0)
 S RESULT=$$CONSOLID^MAGBAPI()
"RTN","MAGBAPI",234,0)
 Q
"RTN","MAGBAPI",235,0)
PLACER(RESULT) ;[MAGG PLACE]
"RTN","MAGBAPI",236,0)
 S RESULT=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGBAPI",237,0)
 Q
"RTN","MAGBAPI",238,0)
 ;
"RTN","MAGGSIU5")
0^7^B49972780
"RTN","MAGGSIU5",1,0)
MAGGSIU5 ;WOIFO/GEK - Utilities for Image Import API ; 11 Jun 2013 5:37 PM
"RTN","MAGGSIU5",2,0)
 ;;3.0;IMAGING;**121,135,154**;Mar 19, 2002;Build 9;Nov 07, 2014
"RTN","MAGGSIU5",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGSIU5",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIU5",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSIU5",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSIU5",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSIU5",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSIU5",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSIU5",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSIU5",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSIU5",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGSIU5",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGSIU5",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGSIU5",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGSIU5",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIU5",17,0)
 ;;
"RTN","MAGGSIU5",18,0)
 Q
"RTN","MAGGSIU5",19,0)
 ; ----- RSND1 ----- Rescind One Image
"RTN","MAGGSIU5",20,0)
 ;  This routine is called by other Imaging routines to Rescind One Image.
"RTN","MAGGSIU5",21,0)
 ;
"RTN","MAGGSIU5",22,0)
 ; Input Parameters
"RTN","MAGGSIU5",23,0)
 ; ================
"RTN","MAGGSIU5",24,0)
 ; MAGIEN = IEN of Image entry in IMAGE (#2005) File
"RTN","MAGGSIU5",25,0)
 ; TIUDA  = IEN of TIU note in TIU DOCUMENT file (#8925) 
"RTN","MAGGSIU5",26,0)
 ; DELREAS = Free text of Deleted Reason
"RTN","MAGGSIU5",27,0)
 ; 
"RTN","MAGGSIU5",28,0)
 ;  MAGIEN and TIUDA are required. 
"RTN","MAGGSIU5",29,0)
 ;  We verify that the Image entry MAGIEN, points to TIUDA.
"RTN","MAGGSIU5",30,0)
 ;  We also call the Integrity Check for the image, and we do not 
"RTN","MAGGSIU5",31,0)
 ;  process a Rescind Action if the IQ Check fails.
"RTN","MAGGSIU5",32,0)
 ;           
"RTN","MAGGSIU5",33,0)
 ; Return Values
"RTN","MAGGSIU5",34,0)
 ; =============
"RTN","MAGGSIU5",35,0)
 ; Results are passed back in the MAGRY Array
"RTN","MAGGSIU5",36,0)
 ; if error found during execution
"RTN","MAGGSIU5",37,0)
 ;   MAGRY(0) = 0^Error message"
"RTN","MAGGSIU5",38,0)
 ;   MAGRY(1..N) = messages describing the Error.
"RTN","MAGGSIU5",39,0)
 ;   
"RTN","MAGGSIU5",40,0)
 ; if success, the result array is same as Import API
"RTN","MAGGSIU5",41,0)
 ;   MAGRY(0) = 1^Success
"RTN","MAGGSIU5",42,0)
 ;   MAGRY(1) = TRKID   -  Tracking ID
"RTN","MAGGSIU5",43,0)
 ;   MAGRY(2) = QUE     -  Queue Number from IMPORT QUEUE File(#2006.034)
"RTN","MAGGSIU5",44,0)
 ;   
"RTN","MAGGSIU5",45,0)
 ;   Tracking ID is a field in each of the following files: 
"RTN","MAGGSIU5",46,0)
 ;      IMAGE File (#2005) (Field #108) (index "ATRKID")
"RTN","MAGGSIU5",47,0)
 ;      IMAGING WINDOWS SESSION File (#2006.82) (Field #8) (index "E")
"RTN","MAGGSIU5",48,0)
 ;      ACQUISITION SESSION FILE File(#2006.041)(Field #.02) (index "C")
"RTN","MAGGSIU5",49,0)
 ;
"RTN","MAGGSIU5",50,0)
 ; 
"RTN","MAGGSIU5",51,0)
RSND1(MAGRY,MAGIEN,TIUDA,DELREAS) ; Main entry point to rescind an Image
"RTN","MAGGSIU5",52,0)
 N QARR,TRKID,CALLBACK
"RTN","MAGGSIU5",53,0)
 N RSLT,REASON,REASDA,MAGTDAT
"RTN","MAGGSIU5",54,0)
 N I,QCT,N0,N2,N40,N100,MAGLT
"RTN","MAGGSIU5",55,0)
 N IMGSPLCS,MAGRQA,MAGRDY
"RTN","MAGGSIU5",56,0)
 N MAGTMP,X
"RTN","MAGGSIU5",57,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERRA^"_$T(+0)
"RTN","MAGGSIU5",58,0)
 ;
"RTN","MAGGSIU5",59,0)
 S MAGIEN=$G(MAGIEN),TIUDA=$G(TIUDA)
"RTN","MAGGSIU5",60,0)
 ;  Quit if MAGIEN is deleted.
"RTN","MAGGSIU5",61,0)
 I $$ISDEL^MAGGI11(MAGIEN) D  Q
"RTN","MAGGSIU5",62,0)
 . S MAGRY(0)="0^Image: "_MAGIEN_" is Deleted"
"RTN","MAGGSIU5",63,0)
 . Q
"RTN","MAGGSIU5",64,0)
 ;   Check for TIUDA, and TIUDA, is same as Image Entry.
"RTN","MAGGSIU5",65,0)
 I 'TIUDA S MAGRY(0)="0^A TIU Note is required" Q
"RTN","MAGGSIU5",66,0)
 ;   If Group Image, use Group (MAGTMP) for next check.
"RTN","MAGGSIU5",67,0)
 ;   because the group image won't point to TIU, only Group Parent.
"RTN","MAGGSIU5",68,0)
 S MAGTMP=MAGIEN
"RTN","MAGGSIU5",69,0)
 I $P(^MAG(2005,MAGIEN,0),"^",10) S MAGTMP=$P(^MAG(2005,MAGIEN,0),"^",10)
"RTN","MAGGSIU5",70,0)
 I $$GET1^DIQ(2005,MAGTMP_",",17,"I")'=TIUDA D  Q
"RTN","MAGGSIU5",71,0)
 . S MAGRY(0)="0^Mismatch between the TIU Note parameter and TIU Note linked to Image"
"RTN","MAGGSIU5",72,0)
 . S MAGRY(1)="TIU Note: "_TIUDA_"   Image: "_MAGIEN
"RTN","MAGGSIU5",73,0)
 . Q
"RTN","MAGGSIU5",74,0)
 ;   Run the Integrity Checker, quit if it finds problem
"RTN","MAGGSIU5",75,0)
 D CHK^MAGGSQI(.MAGRQA,MAGIEN) I 'MAGRQA(0) D  Q
"RTN","MAGGSIU5",76,0)
 . S MAGRY(0)=MAGRQA(0)
"RTN","MAGGSIU5",77,0)
 . Q
"RTN","MAGGSIU5",78,0)
 ;   Quit if Image is already Rescinded, 
"RTN","MAGGSIU5",79,0)
 ;   (checking Field # 115.2 LINKED TYPE) 
"RTN","MAGGSIU5",80,0)
 S MAGLT=$$GET1^DIQ(2005,MAGIEN_",",115.2,"I") I MAGLT=1 D  Q
"RTN","MAGGSIU5",81,0)
 . S MAGRY(0)="0^Image is already Rescinded."
"RTN","MAGGSIU5",82,0)
 . S MAGRY(1)="RESCIND Action is Canceled."
"RTN","MAGGSIU5",83,0)
 . Q
"RTN","MAGGSIU5",84,0)
 ; Now we check for OffLine Platters and other OffLine Issues.
"RTN","MAGGSIU5",85,0)
 I '$$DATAOK(.MAGRDY,MAGIEN,TIUDA) D  Q
"RTN","MAGGSIU5",86,0)
 . M MAGRY=MAGRDY
"RTN","MAGGSIU5",87,0)
 ;
"RTN","MAGGSIU5",88,0)
 S MAGRY(0)="0^Processing Rescind request..."
"RTN","MAGGSIU5",89,0)
 ;
"RTN","MAGGSIU5",90,0)
 S CALLBACK="STATCB^MAGGSIU4"
"RTN","MAGGSIU5",91,0)
 S REASON=$G(DELREAS,"Rescinded TIU Note")
"RTN","MAGGSIU5",92,0)
 S REASDA=$$FIND1^DIC(2005.88,"","X",REASON)
"RTN","MAGGSIU5",93,0)
 ;  Get data for TIU Note.
"RTN","MAGGSIU5",94,0)
 D DATA^MAGGNTI(.MAGTDAT,TIUDA)
"RTN","MAGGSIU5",95,0)
 ; 
"RTN","MAGGSIU5",96,0)
 ;   IMGSPLCS : Image paths and Image places.
"RTN","MAGGSIU5",97,0)
 ;   Get string of Full File Path's | File Places.  
"RTN","MAGGSIU5",98,0)
 ;   This is needed after success, to Delete the Files from Image Network.
"RTN","MAGGSIU5",99,0)
 ;   i.e.  Image Full Path^Abs full Path^Big full Path|Image Place^Abs Place^Big Place
"RTN","MAGGSIU5",100,0)
 S IMGSPLCS=$$IMGPLC(MAGIEN)
"RTN","MAGGSIU5",101,0)
 S I=0,QCT=0
"RTN","MAGGSIU5",102,0)
 ;   
"RTN","MAGGSIU5",103,0)
 S N0=$G(^MAG(2005,MAGIEN,0))
"RTN","MAGGSIU5",104,0)
 S N2=$G(^MAG(2005,MAGIEN,2))
"RTN","MAGGSIU5",105,0)
 S N40=$G(^MAG(2005,MAGIEN,40))
"RTN","MAGGSIU5",106,0)
 S N100=$G(^MAG(2005,MAGIEN,100))
"RTN","MAGGSIU5",107,0)
 ; 
"RTN","MAGGSIU5",108,0)
 ; We Delete the image entry first, then set the Import Queue.
"RTN","MAGGSIU5",109,0)
 S RSLT=$$DELETE^MAGGSIU4(MAGIEN,REASON)
"RTN","MAGGSIU5",110,0)
 ; Quit if we can't delete.
"RTN","MAGGSIU5",111,0)
 I $P(RSLT,"^",1)=0 D  Q  ;
"RTN","MAGGSIU5",112,0)
 . S MAGRY(0)=RSLT
"RTN","MAGGSIU5",113,0)
 . Q
"RTN","MAGGSIU5",114,0)
 ;
"RTN","MAGGSIU5",115,0)
 S TRKID=$$TRKID^MAGGSIU4()  ; Get unique Import API tracking ID
"RTN","MAGGSIU5",116,0)
 I TRKID=0 S MAGRY(0)="0^Error generating a Tracking ID" Q
"RTN","MAGGSIU5",117,0)
 ;
"RTN","MAGGSIU5",118,0)
 ; Set up Import queue data
"RTN","MAGGSIU5",119,0)
 ;--
"RTN","MAGGSIU5",120,0)
 ;   ACTION is the new Import Data Code.  We'll send 'RESCIND' to the
"RTN","MAGGSIU5",121,0)
 ;   Active X control for special processing.
"RTN","MAGGSIU5",122,0)
 S QCT=QCT+1,QARR(QCT)="ACTION^RESCIND"
"RTN","MAGGSIU5",123,0)
 S QCT=QCT+1,QARR(QCT)="PXIEN^"_TIUDA        ; IEN of TIU note
"RTN","MAGGSIU5",124,0)
 S QCT=QCT+1,QARR(QCT)="TRKID^"_TRKID        ; Import API Track ID
"RTN","MAGGSIU5",125,0)
 S QCT=QCT+1,QARR(QCT)="STSCB^"_CALLBACK  ; Status call back routine
"RTN","MAGGSIU5",126,0)
 ;   The format of 'IMAGE' Data for a Rescind is different than for
"RTN","MAGGSIU5",127,0)
 ;   a Normal Image Import.  This is by design so that the
"RTN","MAGGSIU5",128,0)
 ;   old version of the IAPI (called by BP Patch 39 and before)
"RTN","MAGGSIU5",129,0)
 ;   does not process this import.
"RTN","MAGGSIU5",130,0)
 S QCT=QCT+1,QARR(QCT)="IMAGE"_"^"_MAGIEN_"^"_IMGSPLCS
"RTN","MAGGSIU5",131,0)
 ;
"RTN","MAGGSIU5",132,0)
 ;  Now, set the Required data (plus new data) then call MAGGSIUI the
"RTN","MAGGSIU5",133,0)
 ;  same as always. It'll set an IMPORT QUEUE (#2006.034)
"RTN","MAGGSIU5",134,0)
 ;  and track the data in the IMAGING WINDOWS SESSION file (#2006.82)
"RTN","MAGGSIU5",135,0)
 ;  the same as all imports.
"RTN","MAGGSIU5",136,0)
 ;
"RTN","MAGGSIU5",137,0)
 S QCT=QCT+1,QARR(QCT)="PXPKG^8925"
"RTN","MAGGSIU5",138,0)
 ;;;S QCT=QCT+1,QARR(QCT)="PXDT^"_$P(MAGTDAT,"^",3) ;135 T6
"RTN","MAGGSIU5",139,0)
 S QCT=QCT+1,QARR(QCT)="PXDT^"_$P(N2,"^",5) ;135 T6 
"RTN","MAGGSIU5",140,0)
 ; 135 T6 Remedy INC000000795508   instead of MAGTDAT^3   (Entry Date) we use Procedure Date/Time
"RTN","MAGGSIU5",141,0)
 ;  from the Exiting Image Entry, which is the Reference Date of the TIU Note. 
"RTN","MAGGSIU5",142,0)
 S QCT=QCT+1,QARR(QCT)="IDFN^"_$P(N0,"^",7)
"RTN","MAGGSIU5",143,0)
 ; P135T6  Set Acquisition Site the same as existing Image
"RTN","MAGGSIU5",144,0)
 ; if existing Acq Site is null,  use DUZ(2)
"RTN","MAGGSIU5",145,0)
 S X=$P(N100,"^",3)
"RTN","MAGGSIU5",146,0)
 I X]"" S QCT=QCT+1,QARR(QCT)="ACQS^"_X
"RTN","MAGGSIU5",147,0)
 E  S QCT=QCT+1,QARR(QCT)="ACQS^"_DUZ(2)
"RTN","MAGGSIU5",148,0)
 S QCT=QCT+1,QARR(QCT)="ACQD^"_"IAPI" ; This is the acquisition device. Import API.
"RTN","MAGGSIU5",149,0)
 S QCT=QCT+1,QARR(QCT)="GDESC^"_$E("RESCINDED "_$p(N2,"^",4),1,60)
"RTN","MAGGSIU5",150,0)
 ;gek/p121t2  Force IXTYPE to be ADVANCE DIRECTIVE to fix IMED issue of 
"RTN","MAGGSIU5",151,0)
 ;  indexing AD's as Miscelleneous Document. 
"RTN","MAGGSIU5",152,0)
 S QCT=QCT+1,QARR(QCT)="IXTYPE^"_"ADVANCE DIRECTIVE" ;$P(N40,"^",3)  
"RTN","MAGGSIU5",153,0)
 S QCT=QCT+1,QARR(QCT)="IXPROC^"_$P(N40,"^",4)
"RTN","MAGGSIU5",154,0)
 S QCT=QCT+1,QARR(QCT)="IXSPEC^"_$P(N40,"^",5)
"RTN","MAGGSIU5",155,0)
 S QCT=QCT+1,QARR(QCT)="IXORIGIN^"_$P(N40,"^",6)
"RTN","MAGGSIU5",156,0)
 ; To this point, all data in array will be passed back from OCX.
"RTN","MAGGSIU5",157,0)
 ; The data Below : will be validated in the call to REMOTE^MAGGSIUI, and stored in the Session
"RTN","MAGGSIU5",158,0)
 ; File, but won't be returned in the call to ADD^MAGGSIA.   the old design of the IAPI prohibits
"RTN","MAGGSIU5",159,0)
 ; data except for the Import Codes known by IAPI.  So in ADD^MAGGSIA1 before the call to UPDATE^DIC,
"RTN","MAGGSIU5",160,0)
 ; the data for these fields (for Rescinded Import)  will need to be retrieved from the
"RTN","MAGGSIU5",161,0)
 ; Session file and added to the FDA array.
"RTN","MAGGSIU5",162,0)
 ; 
"RTN","MAGGSIU5",163,0)
 ; PROCEDURE  #6
"RTN","MAGGSIU5",164,0)
 ; CREATION DATE #110
"RTN","MAGGSIU5",165,0)
 ; LINKED IMAGE  #115.1
"RTN","MAGGSIU5",166,0)
 ; LINKED TYPE   #115.2
"RTN","MAGGSIU5",167,0)
 ; LINKED DATE   #115.3  (DATE TIME)
"RTN","MAGGSIU5",168,0)
 ; 
"RTN","MAGGSIU5",169,0)
 ; make sure the procedure field is not too long.
"RTN","MAGGSIU5",170,0)
 S QCT=QCT+1,QARR(QCT)="6^"_$E($P(N0,"^",8),1,10)
"RTN","MAGGSIU5",171,0)
 S QCT=QCT+1,QARR(QCT)="110^"_$P(N100,"^",6)
"RTN","MAGGSIU5",172,0)
 S QCT=QCT+1,QARR(QCT)="115.1^"_MAGIEN ;comment this out for testing.
"RTN","MAGGSIU5",173,0)
 S QCT=QCT+1,QARR(QCT)="115.2^"_"1" ; 1 = RESCIND
"RTN","MAGGSIU5",174,0)
 S QCT=QCT+1,QARR(QCT)="115.3^"_$$NOW^XLFDT
"RTN","MAGGSIU5",175,0)
 ;
"RTN","MAGGSIU5",176,0)
 K MAGRY
"RTN","MAGGSIU5",177,0)
 D REMOTE^MAGGSIUI(.MAGRY,.QARR)
"RTN","MAGGSIU5",178,0)
 I MAGRY(0) D
"RTN","MAGGSIU5",179,0)
 . S MAGRY($O(MAGRY(""),-1)+1)="TrkID: "_$G(TRKID)
"RTN","MAGGSIU5",180,0)
 . S MAGRY($O(MAGRY(""),-1)+1)="Queue: "_+MAGRY(0)
"RTN","MAGGSIU5",181,0)
 . Q
"RTN","MAGGSIU5",182,0)
 Q
"RTN","MAGGSIU5",183,0)
 ; ----- ERRA ---- Error trap 
"RTN","MAGGSIU5",184,0)
ERRA ; Error Trap for RSND1 - Array Return - MAGRY
"RTN","MAGGSIU5",185,0)
 N ERR S ERR=$$EC^%ZOSV
"RTN","MAGGSIU5",186,0)
 S MAGRY(0)="0^"_ERR
"RTN","MAGGSIU5",187,0)
 S MAGRY($O(MAGRY(""),-1)+1)=ERR
"RTN","MAGGSIU5",188,0)
 D LOGERR^MAGGTERR(ERR)
"RTN","MAGGSIU5",189,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGGSIU5",190,0)
 Q
"RTN","MAGGSIU5",191,0)
 ; ----- IMGPLC ---- internal call to return Image paths and places.
"RTN","MAGGSIU5",192,0)
 ;     MAGIEN = IMAGE File (#2005) internal entry number.
"RTN","MAGGSIU5",193,0)
IMGPLC(MAGIEN) ; return a string of FullFile^AbsFile^BigFile|FullPlace^AbsPlace^BigPlace
"RTN","MAGGSIU5",194,0)
 ; 
"RTN","MAGGSIU5",195,0)
 N MAGXX,MAGPLC,FPATH
"RTN","MAGGSIU5",196,0)
 N RFILE,RPLC
"RTN","MAGGSIU5",197,0)
 ; Here we 'New' the variables returned by MAGFILEB so they are cleared after this call.
"RTN","MAGGSIU5",198,0)
 N MAGFILE,MAGFILE1,MAGFILE2,MAGJBOL,MAGOFFLN
"RTN","MAGGSIU5",199,0)
 S RFILE="",RPLC=""
"RTN","MAGGSIU5",200,0)
 ;   Get Full Path and Place
"RTN","MAGGSIU5",201,0)
 S MAGXX=MAGIEN,MAGPLC=$$DA2PLC^MAGBAPIP(MAGIEN,"F")
"RTN","MAGGSIU5",202,0)
 D VSTNOCP^MAGFILEB
"RTN","MAGGSIU5",203,0)
 S FPATH=$P(MAGFILE2,"~",1) I FPATH="-1" S FPATH=""
"RTN","MAGGSIU5",204,0)
 S RFILE=RFILE_"^"_FPATH,RPLC=RPLC_"^"_MAGPLC
"RTN","MAGGSIU5",205,0)
 ;
"RTN","MAGGSIU5",206,0)
 ;   Get Abs Path and Place
"RTN","MAGGSIU5",207,0)
 S MAGXX=MAGIEN,MAGPLC=$$DA2PLC^MAGBAPIP(MAGIEN,"A")
"RTN","MAGGSIU5",208,0)
 D ABSNOCP^MAGFILEB
"RTN","MAGGSIU5",209,0)
 S FPATH=$P(MAGFILE2,"~",1) I FPATH="-1" S FPATH=""
"RTN","MAGGSIU5",210,0)
 S RFILE=RFILE_"^"_FPATH,RPLC=RPLC_"^"_MAGPLC
"RTN","MAGGSIU5",211,0)
 ;
"RTN","MAGGSIU5",212,0)
 ;   Get Big Patch and Place
"RTN","MAGGSIU5",213,0)
 S MAGXX=MAGIEN,MAGPLC=$$DA2PLC^MAGBAPIP(MAGIEN,"B")
"RTN","MAGGSIU5",214,0)
 D BIGNOCP^MAGFILEB
"RTN","MAGGSIU5",215,0)
 S FPATH=$P(MAGFILE2,"~",1) I FPATH="-1" S FPATH=""
"RTN","MAGGSIU5",216,0)
 S RFILE=RFILE_"^"_FPATH,RPLC=RPLC_"^"_MAGPLC
"RTN","MAGGSIU5",217,0)
 ; get rid of first '^'
"RTN","MAGGSIU5",218,0)
 Q $E(RFILE,2,999)_"|"_$E(RPLC,2,999)
"RTN","MAGGSIU5",219,0)
 ;
"RTN","MAGGSIU5",220,0)
DATAOK(RY,MAGIEN,TIUDA) ;
"RTN","MAGGSIU5",221,0)
 ; We access more data from MAGFILEB, and stop the Rescinding of Adv Directives
"RTN","MAGGSIU5",222,0)
 ; if the Platter is Offline, Network Location is OffLine, Image can't be found
"RTN","MAGGSIU5",223,0)
 ;
"RTN","MAGGSIU5",224,0)
 ; Here we 'New' the variables returned by MAGFILEB so they are cleared after this call.
"RTN","MAGGSIU5",225,0)
 N MAGFILE,MAGFILE1,MAGFILE2,MAGJBOL,MAGOFFLN
"RTN","MAGGSIU5",226,0)
 S MAGXX=MAGIEN,MAGPLC=$$DA2PLC^MAGBAPIP(MAGIEN,"F")
"RTN","MAGGSIU5",227,0)
 D VSTNOCP^MAGFILEB
"RTN","MAGGSIU5",228,0)
 ; P154 Quit if Image is Offline
"RTN","MAGGSIU5",229,0)
 I $G(MAGOFFLN)!$$IMOFFLN^MAGFILEB($P(^MAG(2005,MAGIEN,0),"^",2)) D  Q 0
"RTN","MAGGSIU5",230,0)
 . S RY(0)="0^Image is on an OffLine Platter"
"RTN","MAGGSIU5",231,0)
 . S RY(1)="Platter: "_$G(MAGJBOL)
"RTN","MAGGSIU5",232,0)
 . S RY(2)="Contact Imaging staff to get Platter on line"
"RTN","MAGGSIU5",233,0)
 . Q
"RTN","MAGGSIU5",234,0)
 ; Get here so, Image is not off line, but we'll also flag Invalid
"RTN","MAGGSIU5",235,0)
 ; or other Errors.
"RTN","MAGGSIU5",236,0)
 ; If other problem getting path to image then :
"RTN","MAGGSIU5",237,0)
 ; MAGFILE1  is of format "-1~message"
"RTN","MAGGSIU5",238,0)
 I +MAGFILE1="-1" D  Q 0
"RTN","MAGGSIU5",239,0)
 . S RY(0)="0^Error getting Image Data"
"RTN","MAGGSIU5",240,0)
 . S RY(1)="TIU Note: "_TIUDA_"   Image: "_MAGIEN
"RTN","MAGGSIU5",241,0)
 . I $D(MAGFILE1("ERROR")) S RY(2)=MAGFILE1("ERROR")
"RTN","MAGGSIU5",242,0)
 . E  S RY(2)=MAGFILE1
"RTN","MAGGSIU5",243,0)
 . Q
"RTN","MAGGSIU5",244,0)
 Q 1
"RTN","MAGIP154")
0^1^B4013654
"RTN","MAGIP154",1,0)
MAGIP154 ;PRE/Post init routine to queue site activity at install. ; 17 June 2014 11:42 AM
"RTN","MAGIP154",2,0)
 ;;3.0;IMAGING;**154**;June 17, 2014;Build 9
"RTN","MAGIP154",3,0)
 ;;  Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIP154",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP154",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIP154",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIP154",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIP154",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIP154",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIP154",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIP154",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIP154",12,0)
 ;; | a medical device.  As such, it may not be changed             |
"RTN","MAGIP154",13,0)
 ;; | in any way.  Modifications to this software may result in an  |
"RTN","MAGIP154",14,0)
 ;; | adulterated medical device under 21CFR820, the use of which   |
"RTN","MAGIP154",15,0)
 ;; | is considered to be a violation of US Federal Statutes.       |
"RTN","MAGIP154",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP154",17,0)
 ;;
"RTN","MAGIP154",18,0)
 Q
"RTN","MAGIP154",19,0)
PRE ;There are no environment checks here
"RTN","MAGIP154",20,0)
 Q
"RTN","MAGIP154",21,0)
POST ;***** POST-INSTALL CODE
"RTN","MAGIP154",22,0)
POS ;
"RTN","MAGIP154",23,0)
 N CALLBACK
"RTN","MAGIP154",24,0)
 D CLEAR^MAGUERR(1)
"RTN","MAGIP154",25,0)
 ;--- Send the notification e-mail
"RTN","MAGIP154",26,0)
 D BMES^XPDUTL("Post Install Mail Message: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","MAGIP154",27,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGIP154",28,0)
 Q
"RTN","MAGIP154",29,0)
 ;+++++ INSTALLATION ERROR HANDLING
"RTN","MAGIP154",30,0)
ERROR ;
"RTN","MAGIP154",31,0)
 S:$D(XPDNM) XPDABORT=1
"RTN","MAGIP154",32,0)
 ;--- Display the messages and store them to the INSTALL file
"RTN","MAGIP154",33,0)
 D DUMP^MAGUERR1(),ABTMSG^MAGKIDS()
"RTN","MAGIP154",34,0)
 Q
"RTN","MAGQBPG1")
0^2^B113868040
"RTN","MAGQBPG1",1,0)
MAGQBPG1 ;WOIFO/RMP - REMOTE Task SERVER Program ; 14 SEP 2014 4:12 PM
"RTN","MAGQBPG1",2,0)
 ;;3.0;IMAGING;**7,8,20,81,39,135,154**;SEP 14, 2014;Build 9
"RTN","MAGQBPG1",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQBPG1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBPG1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBPG1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBPG1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBPG1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBPG1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBPG1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBPG1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBPG1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBPG1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBPG1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBPG1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBPG1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBPG1",17,0)
 ;;
"RTN","MAGQBPG1",18,0)
 Q
"RTN","MAGQBPG1",19,0)
ENTRY(RESULT,WSTAT,PROCESS) ;RPC[MAGQ JBS]
"RTN","MAGQBPG1",20,0)
 N X,SYSIEN,SYSNAME,ZNODE,NODE,INDX,CNT,PROC,%,QPTR,QCNT,SHARE,PLACE,SCANDATE
"RTN","MAGQBPG1",21,0)
 S SCANDATE=$$FMTE^XLFDT($$NOW^XLFDT)
"RTN","MAGQBPG1",22,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",23,0)
 S (SYSIEN,CNT)=0,SYSNAME="",U="^",PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBPG1",24,0)
 S SYSIEN=$O(^MAG(2006.8,"C",PLACE,WSTAT,"")) ;TRUE WORKSTATION NAME
"RTN","MAGQBPG1",25,0)
 I 'SYSIEN S SYSIEN=$O(^MAG(2006.8,"C",PLACE,$$UPPER^MAGQE4(WSTAT),""))
"RTN","MAGQBPG1",26,0)
 I 'SYSIEN D  ;ATTEMPT TO FIND A MATCH FROM LOCAL NAME
"RTN","MAGQBPG1",27,0)
 . N TRY
"RTN","MAGQBPG1",28,0)
 . F TRY=1:1:$L(WSTAT,".") D  Q:SYSIEN?1N.N
"RTN","MAGQBPG1",29,0)
 . . S SYSIEN=$O(^MAG(2006.8,"C",PLACE,$P(WSTAT,".",TRY),""))
"RTN","MAGQBPG1",30,0)
 . . I 'SYSIEN S SYSIEN=$O(^MAG(2006.8,"C",PLACE,$$UPPER^MAGQE4($P(WSTAT,".",TRY)),""))
"RTN","MAGQBPG1",31,0)
 I SYSIEN="" D  Q
"RTN","MAGQBPG1",32,0)
 . S RESULT(0)="-1^This workstation is not currently setup as a Background Processor."
"RTN","MAGQBPG1",33,0)
 . Q
"RTN","MAGQBPG1",34,0)
 S NODE=^MAG(2006.8,SYSIEN,0)
"RTN","MAGQBPG1",35,0)
 S SYSNAME=$P(NODE,U)
"RTN","MAGQBPG1",36,0)
 I SYSNAME="" D  Q
"RTN","MAGQBPG1",37,0)
 . S RESULT(0)="-1^This workstation is not currently setup as a Background Processor."
"RTN","MAGQBPG1",38,0)
 . Q
"RTN","MAGQBPG1",39,0)
 S RESULT(0)="0^BP List^PID: "_$$BASE^XLFUTL($J,10,16)_U_SYSNAME_U_WSTAT_U_$P(^MAG(2006.1,PLACE,0),U,2)
"RTN","MAGQBPG1",40,0)
 S (X,CNT)=0
"RTN","MAGQBPG1",41,0)
 F  S X=$O(^MAG(2005.2,X)) Q:X'?1N.N  S ZNODE=$G(^(X,0)) D
"RTN","MAGQBPG1",42,0)
 . Q:'$P(ZNODE,U,6)  ;1=online
"RTN","MAGQBPG1",43,0)
 . Q:$E($P(ZNODE,U,2),1,2)'="\\"
"RTN","MAGQBPG1",44,0)
 . Q:$P(ZNODE,U,10)'=PLACE
"RTN","MAGQBPG1",45,0)
 . Q:(($P(ZNODE,U,7)'["WORM")&($P(ZNODE,U,7)'="RW"))
"RTN","MAGQBPG1",46,0)
 . S CNT=CNT+1,SHARE=$P(ZNODE,U,2)
"RTN","MAGQBPG1",47,0)
 . I $E(SHARE,$L(SHARE))="\" S SHARE=$E(SHARE,1,$L(SHARE)-1)
"RTN","MAGQBPG1",48,0)
 . S RESULT(CNT)=X_U_SHARE_U_$P(ZNODE,U,8)
"RTN","MAGQBPG1",49,0)
 Q
"RTN","MAGQBPG1",50,0)
SHR(RESULT) ; RPC[MAGQ SHARES]
"RTN","MAGQBPG1",51,0)
 N TMP,INDX,DATA,CNT,SHARE,CWL,VALUE,PLACE
"RTN","MAGQBPG1",52,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",53,0)
 S (CNT,INDX)=0,U="^",PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBPG1",54,0)
 S CWL=$$CWL^MAGBAPI(PLACE)
"RTN","MAGQBPG1",55,0)
 F  S INDX=$O(^MAG(2005.2,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQBPG1",56,0)
 . S DATA=$G(^MAG(2005.2,INDX,0))
"RTN","MAGQBPG1",57,0)
 . Q:$P(DATA,U,6,7)'["1^MAG"
"RTN","MAGQBPG1",58,0)
 . Q:$P(DATA,U,9)="1"  ;ROUTING SHARE
"RTN","MAGQBPG1",59,0)
 . Q:$P(DATA,U,2)[":"
"RTN","MAGQBPG1",60,0)
 . Q:$P(DATA,U,10)'=PLACE
"RTN","MAGQBPG1",61,0)
 . S SHARE=$P(DATA,U,2)
"RTN","MAGQBPG1",62,0)
 . Q:$E(SHARE,1,2)'="\\"
"RTN","MAGQBPG1",63,0)
 . I $E(SHARE,$L(SHARE))="\" S SHARE=$E(SHARE,1,$L(SHARE)-1)
"RTN","MAGQBPG1",64,0)
 . S SHARE=SHARE_U_$P(DATA,U,8)
"RTN","MAGQBPG1",65,0)
 . Q:$D(TMP(SHARE))
"RTN","MAGQBPG1",66,0)
 . S TMP(SHARE)=INDX
"RTN","MAGQBPG1",67,0)
 S INDX=""
"RTN","MAGQBPG1",68,0)
 F  S INDX=$O(TMP(INDX)) Q:INDX=""  D
"RTN","MAGQBPG1",69,0)
 . S RESULT(CNT)=TMP(INDX)_U_INDX,CNT=CNT+1
"RTN","MAGQBPG1",70,0)
 . S ^TMP("MAGQBP",$J,"SHRLST",CNT-1)=TMP(INDX)_U_INDX
"RTN","MAGQBPG1",71,0)
 K TMP
"RTN","MAGQBPG1",72,0)
 Q
"RTN","MAGQBPG1",73,0)
CNP2(RESULT,IEN,START,STOP,AUTO) ;[MAGQ JBSCN]
"RTN","MAGQBPG1",74,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",75,0)
 N FNAME,PIECE,ZNODE,NODE2,BNODE,BNAME,PTR,HASH,TEMP,ORDER,RDATE,PLACE,OFFLINE,PLACEOK,GL,END,ACQSITE,MAGDA,SCANCNT,OFFCNT,ALTPLACE,CORREC
"RTN","MAGQBPG1",76,0)
 S (RESULT,GL)="",PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2))),(OFFLINE,PLACEOK,SCANCNT,ALTPLACE,OFFCNT)=0,CORREC=""
"RTN","MAGQBPG1",77,0)
 I AUTO D
"RTN","MAGQBPG1",78,0)
 . S (IEN,MAGDA)=+IEN
"RTN","MAGQBPG1",79,0)
 . S ORDER="R"
"RTN","MAGQBPG1",80,0)
 . I START="" S START=$S(IEN>0:IEN,1:$O(^MAG(2005,"A"),-1))
"RTN","MAGQBPG1",81,0)
 . S STOP=$O(^MAG(2005,0))
"RTN","MAGQBPG1",82,0)
 . Q
"RTN","MAGQBPG1",83,0)
 S:START="" START=$O(^MAG(2005,0)) S:STOP="" STOP=$O(^MAG(2005,"A"),-1)
"RTN","MAGQBPG1",84,0)
 S ORDER=$S(START>STOP:"R",1:"F")
"RTN","MAGQBPG1",85,0)
 I (IEN'?1N.N)!IEN=0 D  I IEN="" S RESULT=0 Q
"RTN","MAGQBPG1",86,0)
 . I START=0 S IEN=START Q
"RTN","MAGQBPG1",87,0)
 . I ORDER="R" D
"RTN","MAGQBPG1",88,0)
 . . S I1=+$O(^MAG(2005," "),-1),I2=+$O(^MAG(2005.1," "),-1),END=$S(I1>I2:I1,1:I2)
"RTN","MAGQBPG1",89,0)
 . . S IEN=$S(START>END:START,1:START+1) Q
"RTN","MAGQBPG1",90,0)
 . E  S (IEN,MAGDA)=START-1
"RTN","MAGQBPG1",91,0)
 . Q
"RTN","MAGQBPG1",92,0)
 S (IEN,MAGDA)=+IEN
"RTN","MAGQBPG1",93,0)
 F  D SCAN^MAGQBPG1(.IEN,ORDER,.GL) D  Q:(((ORDER="R")&(IEN<STOP))!((ORDER="F")&(IEN>STOP))!(('OFFLINE)&PLACEOK)!(CORREC]"")!('IEN)!(SCANCNT>249)!($P(RESULT,U,21)="DUPE")!'$G(ACQSITE))
"RTN","MAGQBPG1",94,0)
 . Q:'IEN
"RTN","MAGQBPG1",95,0)
 . S SCANCNT=SCANCNT+1,OFFLINE=0
"RTN","MAGQBPG1",96,0)
 . S ZNODE=$G(@(GL_IEN_",0)")),ACQSITE=$P($G(@(GL_IEN_",100)")),U,3)
"RTN","MAGQBPG1",97,0)
 . S NODE2=$G(@(GL_IEN_",2)"))
"RTN","MAGQBPG1",98,0)
 . I ((ZNODE']"")!($P(ZNODE,U,1,2)="^^"))!(NODE2']"")!(($P(NODE2,U,1,8)="^^^^^^^")&(($G(@(GL_IEN_",1)"))']""))) D KLOG(GL,IEN,.CORREC) Q 
"RTN","MAGQBPG1",99,0)
 . I AUTO,$P(ZNODE,U,11)'="" D  Q
"RTN","MAGQBPG1",100,0)
 . . S $P(RESULT,U,1)=0
"RTN","MAGQBPG1",101,0)
 . . S IEN=0
"RTN","MAGQBPG1",102,0)
 . . Q
"RTN","MAGQBPG1",103,0)
 . S PLACEOK=$S($$PLACE^MAGBAPI(+ACQSITE)=$$PLACE^MAGBAPI($G(DUZ(2))):1,1:"")
"RTN","MAGQBPG1",104,0)
 . I $P(ZNODE,U,2)'="" S OFFLINE=$$IMOFFLN^MAGFILEB($P(ZNODE,U,2))  ; Only check the offline status of image files
"RTN","MAGQBPG1",105,0)
 . I OFFLINE S OFFCNT=OFFCNT+1 Q
"RTN","MAGQBPG1",106,0)
 . I 'PLACEOK S ALTPLACE=ALTPLACE+1 Q
"RTN","MAGQBPG1",107,0)
 . I ($D(^MAG(2005.1,IEN,0))&$D(^MAG(2005,IEN,0))) D  Q  ; Image is duplicated in the Archive file
"RTN","MAGQBPG1",108,0)
 . . I $P(^MAG(2005,IEN,0),U,1,8)="^^^^^^^",+$P(^MAG(2005,IEN,0),U,9) D KLOG(GL,IEN,.CORREC) Q
"RTN","MAGQBPG1",109,0)
 . . S FDA(2005,IEN_",",13.5)="1" ; Set Dupe field in the Image File 
"RTN","MAGQBPG1",110,0)
 . . S FDA(2005,IEN_",",13)="1" ; Set IQ field in the Image File  
"RTN","MAGQBPG1",111,0)
 . . D FILE^DIE("I","FDA","MSG") K FDA,MSG
"RTN","MAGQBPG1",112,0)
 . . S FDA(2005.1,IEN_",",13.5)="1" ; Set the Dupe field in the archive file
"RTN","MAGQBPG1",113,0)
 . . S FDA(2005.1,IEN_",",13)="1" ; and set the IQ field in the archive file
"RTN","MAGQBPG1",114,0)
 . . D FILE^DIE("I","FDA","MSG") K FDA,MSG
"RTN","MAGQBPG1",115,0)
 . . S $P(RESULT,U,21)="DUPE"
"RTN","MAGQBPG1",116,0)
 . . S $P(RESULT,U)=IEN
"RTN","MAGQBPG1",117,0)
 . . I $P(ZNODE,U,2)=$P($G(^MAG(2005.1,IEN,0)),U,2) S $P(RESULT,U,2)=$P(ZNODE,U,2) D
"RTN","MAGQBPG1",118,0)
 . . . I $P(RESULT,U,2)="" S $P(RESULT,U,2)="No File Name" Q
"RTN","MAGQBPG1",119,0)
 . . E  S $P(RESULT,U,2)=$P(ZNODE,U,2)_"/"_$P($G(^MAG(2005.1,IEN,0)),U,2) D
"RTN","MAGQBPG1",120,0)
 . . . I $P($P(RESULT,U,2),"/")="" S $P(RESULT,U,2)="No File Name"_$P(RESULT,U,2)
"RTN","MAGQBPG1",121,0)
 . . . I $P($P(RESULT,U,2),"/",2)="" S $P(RESULT,U,2)=$P(RESULT,U,2)_"No File Name"
"RTN","MAGQBPG1",122,0)
 . . . Q
"RTN","MAGQBPG1",123,0)
 . . Q
"RTN","MAGQBPG1",124,0)
 . E  I $P(ZNODE,U,2)'="" S $P(@(GL_IEN_",0)"),U,12)="0"
"RTN","MAGQBPG1",125,0)
 . Q
"RTN","MAGQBPG1",126,0)
 S $P(RESULT,U,25)=OFFCNT
"RTN","MAGQBPG1",127,0)
 S $P(RESULT,U,26)=ALTPLACE
"RTN","MAGQBPG1",128,0)
 I CORREC]"" D  Q
"RTN","MAGQBPG1",129,0)
 . S $P(RESULT,U,27)=CORREC
"RTN","MAGQBPG1",130,0)
 . D SCAN^MAGQBPG1(.IEN,ORDER,.GL)
"RTN","MAGQBPG1",131,0)
 . S $P(RESULT,U,24)=IEN
"RTN","MAGQBPG1",132,0)
 . Q
"RTN","MAGQBPG1",133,0)
 I $S('IEN:1,((ORDER="F")&(IEN>STOP)):1,(SCANCNT>249):1,((ORDER="R")&(IEN<STOP)):1,1:0) D  Q
"RTN","MAGQBPG1",134,0)
 . S:SCANCNT>249 $P(RESULT,U,24)=IEN
"RTN","MAGQBPG1",135,0)
 . S $P(RESULT,U,1)=0
"RTN","MAGQBPG1",136,0)
 . Q
"RTN","MAGQBPG1",137,0)
 S FNAME=$P(ZNODE,U,2)
"RTN","MAGQBPG1",138,0)
 S $P(RESULT,U)=IEN
"RTN","MAGQBPG1",139,0)
 Q:($P(RESULT,U,21)="DUPE")
"RTN","MAGQBPG1",140,0)
 S $P(RESULT,U,19)=$P($P($G(@(GL_IEN_",2)")),U),".")
"RTN","MAGQBPG1",141,0)
 I $P(ZNODE,U,2)'="" D  ;NON-GROUP PARENT
"RTN","MAGQBPG1",142,0)
 . S BNODE=$G(@(GL_IEN_",""FBIG"")"))
"RTN","MAGQBPG1",143,0)
 . I $P(ZNODE,U,5)?1N.N S $P(RESULT,U,3)=$P(ZNODE,U,5)
"RTN","MAGQBPG1",144,0)
 . S:$P(BNODE,U,2)?1N.N $P(RESULT,U,4)=$S($P(BNODE,U,3)'="":"["_$P(BNODE,U,3)_"]",1:"")_$P(BNODE,U,2)
"RTN","MAGQBPG1",145,0)
 . S:$P(ZNODE,U,3)?1N.N $P(RESULT,U,5)=$P(ZNODE,U,3)
"RTN","MAGQBPG1",146,0)
 . S:$P(ZNODE,U,4)?1N.N $P(RESULT,U,6)=$P(ZNODE,U,4)
"RTN","MAGQBPG1",147,0)
 . S:$P(BNODE,U)?1N.N $P(RESULT,U,7)=$S($P(BNODE,U,3)'="":"["_$P(BNODE,U,3)_"]",1:"")_$P(BNODE,U)
"RTN","MAGQBPG1",148,0)
 . S $P(RESULT,U,8)=$$CWL^MAGBAPI(PLACE)
"RTN","MAGQBPG1",149,0)
 . S $P(RESULT,U,2)=FNAME
"RTN","MAGQBPG1",150,0)
 . I $D(@(GL_IEN_",""FBIG"")")),'$P(BNODE,U),'$P(BNODE,U,2) S $P(RESULT,U,22)="EMPTY_FBIG"
"RTN","MAGQBPG1",151,0)
 . Q
"RTN","MAGQBPG1",152,0)
 I '$P($G(@(GL_IEN_",100)")),U,3) S $P(RESULT,U,23)=-1 ;"NO ACQ SITE VALUE"
"RTN","MAGQBPG1",153,0)
 I GL[("^MAG(2005.1,") S $P(RESULT,U,21)=$S($P($G(^MAG(2005.1,IEN,100)),U,8)=13:"NE",1:"ARCH")
"RTN","MAGQBPG1",154,0)
 E  S $P(RESULT,U,12,17)=$$CHKIMG^MAGQBUT2(IEN)
"RTN","MAGQBPG1",155,0)
 Q
"RTN","MAGQBPG1",156,0)
JPUD(RESULT,JPTR,EXT,IEN) ; RPC[MAGQ JPUD]
"RTN","MAGQBPG1",157,0)
 N TYPE,PIECE,NODE,GL
"RTN","MAGQBPG1",158,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP"),RESULT="0"
"RTN","MAGQBPG1",159,0)
 S TYPE=$$FTYPE^MAGQBPRG(EXT,IEN)
"RTN","MAGQBPG1",160,0)
 S PIECE=$S(TYPE="BIG":2,1:5)
"RTN","MAGQBPG1",161,0)
 S NODE=$S(TYPE="BIG":"FBIG",1:0)
"RTN","MAGQBPG1",162,0)
 I JPTR="0" D  Q:(RESULT<0)
"RTN","MAGQBPG1",163,0)
 . S JPTR=""
"RTN","MAGQBPG1",164,0)
 . S GL=$S($D(^MAG(2005,IEN)):"^MAG(2005,",$D(^MAG(2005.1,IEN)):"^MAG(2005.1,",1:0)
"RTN","MAGQBPG1",165,0)
 . I GL=0 S RESULT="-1" Q
"RTN","MAGQBPG1",166,0)
 . S GL=$G(@(GL_IEN_",0)")) I $P(GL,U,2)="" S RESULT=-1 Q  ;*154 No file ref.
"RTN","MAGQBPG1",167,0)
 . I $D(^MAGQUEUE(2006.033,"B",$P(GL,U,2))) D  Q  ;*154 +fix
"RTN","MAGQBPG1",168,0)
 . . S RESULT=-2 Q  ;Don't clear the JB pointer if image is on an Offline Platter
"RTN","MAGQBPG1",169,0)
 . . Q
"RTN","MAGQBPG1",170,0)
 . Q
"RTN","MAGQBPG1",171,0)
 S:$D(^MAG(2005,IEN,NODE)) $P(^MAG(2005,IEN,NODE),U,PIECE)=JPTR
"RTN","MAGQBPG1",172,0)
 S:$D(^MAG(2005.1,IEN,NODE)) $P(^MAG(2005.1,IEN,NODE),U,PIECE)=JPTR
"RTN","MAGQBPG1",173,0)
 S RESULT="1"
"RTN","MAGQBPG1",174,0)
 Q
"RTN","MAGQBPG1",175,0)
VCUD(RESULT,VCPTR,EXT,IEN) ; RPC[MAGQ VCUD]
"RTN","MAGQBPG1",176,0)
 N TYPE,PIECE,NODE
"RTN","MAGQBPG1",177,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP"),RESULT="0"
"RTN","MAGQBPG1",178,0)
 S TYPE=$$FTYPE^MAGQBPRG(EXT,IEN)
"RTN","MAGQBPG1",179,0)
 S PIECE=$S(TYPE="BIG":1,TYPE="ABS":4,1:3)
"RTN","MAGQBPG1",180,0)
 S NODE=$S(TYPE="BIG":"FBIG",1:0)
"RTN","MAGQBPG1",181,0)
 S:VCPTR="0" VCPTR=""
"RTN","MAGQBPG1",182,0)
 S:$D(^MAG(2005,IEN,NODE)) $P(^MAG(2005,IEN,NODE),U,PIECE)=VCPTR
"RTN","MAGQBPG1",183,0)
 S:$D(^MAG(2005.1,IEN,NODE)) $P(^MAG(2005.1,IEN,NODE),U,PIECE)=VCPTR
"RTN","MAGQBPG1",184,0)
 S RESULT="1"
"RTN","MAGQBPG1",185,0)
 Q
"RTN","MAGQBPG1",186,0)
DFNIQ(RESULT,INPUT,SEND,PLACE,APP) ;
"RTN","MAGQBPG1",187,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",188,0)
 N LOC,CNT,Y,XMSUB
"RTN","MAGQBPG1",189,0)
 S U="^",RESULT="1"
"RTN","MAGQBPG1",190,0)
 S CNT=+$O(^TMP($J,"MAGQDFN",PLACE,APP,""),-1)
"RTN","MAGQBPG1",191,0)
 I CNT<2 D
"RTN","MAGQBPG1",192,0)
 . S LOC=$$KSP^XUPARAM("WHERE")
"RTN","MAGQBPG1",193,0)
 . S ^TMP($J,"MAGQDFN",PLACE,APP,1)="            SITE: "_LOC
"RTN","MAGQBPG1",194,0)
 . S ^TMP($J,"MAGQDFN",PLACE,APP,2)="            DATE: "_$$FMTE^XLFDT($$NOW^XLFDT)_" "_$G(^XMB("TIMEZONE"))
"RTN","MAGQBPG1",195,0)
 . S CNT=2 Q
"RTN","MAGQBPG1",196,0)
 I SEND="1" D
"RTN","MAGQBPG1",197,0)
 . S RESULT=$$SUBCHK^XMGAPI0(INPUT,0)
"RTN","MAGQBPG1",198,0)
 . Q:$P(RESULT,U)
"RTN","MAGQBPG1",199,0)
 . S XMSUB=INPUT
"RTN","MAGQBPG1",200,0)
 . N XMTEXT,INTERVAL,XMDUZ,XMZ
"RTN","MAGQBPG1",201,0)
 . S INTERVAL=$$GETMI^MAGQBUT5(XMSUB,PLACE)
"RTN","MAGQBPG1",202,0)
 . I $$FMADD^XLFDT(+$P(INTERVAL,"^",2),"",+$P(INTERVAL,U,1),"","")>$$NOW^XLFDT D  Q
"RTN","MAGQBPG1",203,0)
 . . K ^TMP($J,"MAGQDFN",PLACE,APP) Q
"RTN","MAGQBPG1",204,0)
 . S XMTEXT="^TMP($J,""MAGQDFN"",PLACE,APP)"
"RTN","MAGQBPG1",205,0)
 . D:$$PROD^XUPROD("1") ADDMG^MAGQBUT5(INPUT,.XMY,PLACE)
"RTN","MAGQBPG1",206,0)
 . S XMY(DUZ)="",XMDUZ=DUZ,XMY(XMDUZ)=""
"RTN","MAGQBPG1",207,0)
 . S XMID=$G(DUZ) S:'XMID XMID=.5
"RTN","MAGQBPG1",208,0)
 . S XMINSTR("FLAGS")="I",XMINSTR("FROM")="VistA Imaging "_APP
"RTN","MAGQBPG1",209,0)
 . D SENDMSG^XMXAPI(XMID,XMSUB,XMTEXT,.XMY,.XMINSTR,.XMZ,)
"RTN","MAGQBPG1",210,0)
 . K ^TMP($J,"MAGQDFN",PLACE,APP)
"RTN","MAGQBPG1",211,0)
 . I $G(XMERR) M XMERR=^TMP("XMERR",$J) K XMERR
"RTN","MAGQBPG1",212,0)
 . K ^TMP($J,"MAGQDFN",PLACE,APP)
"RTN","MAGQBPG1",213,0)
 . D UDMI^MAGQBUT5(INPUT,PLACE) Q
"RTN","MAGQBPG1",214,0)
 E  S CNT=CNT+1,^TMP($J,"MAGQDFN",PLACE,APP,CNT)=INPUT
"RTN","MAGQBPG1",215,0)
 S $P(RESULT,U)=$S($P(RESULT,U):"1",1:0)
"RTN","MAGQBPG1",216,0)
 K XMY,XMINSTR,XMID
"RTN","MAGQBPG1",217,0)
 Q
"RTN","MAGQBPG1",218,0)
SCAN(IEN,ORDER,GB) ; Find the next image spanning the Image and the Image Archive file
"RTN","MAGQBPG1",219,0)
 I IEN,GB="^MAG(2005,",$D(^MAG(2005.1,IEN)) D  Q
"RTN","MAGQBPG1",220,0)
 . S IEN=IEN,GB="^MAG(2005.1," Q
"RTN","MAGQBPG1",221,0)
 N I1,I2
"RTN","MAGQBPG1",222,0)
 I $G(ORDER)="F" D 
"RTN","MAGQBPG1",223,0)
 . S I1=$O(^MAG(2005,IEN)),I1=$S(I1:I1,1:"")
"RTN","MAGQBPG1",224,0)
 . S I2=$O(^MAG(2005.1,IEN)),I2=$S(I2:I2,1:"")
"RTN","MAGQBPG1",225,0)
 . I I1,'I2 S IEN=I1,GB="^MAG(2005," Q
"RTN","MAGQBPG1",226,0)
 . I I2,'I1 S IEN=I2,GB="^MAG(2005.1," Q
"RTN","MAGQBPG1",227,0)
 . S GB=$S(I1>I2:"^MAG(2005.1,",1:"^MAG(2005,")
"RTN","MAGQBPG1",228,0)
 . S IEN=$S(I1>I2:I2,1:I1)
"RTN","MAGQBPG1",229,0)
 . Q
"RTN","MAGQBPG1",230,0)
 E  D  ;Reverse
"RTN","MAGQBPG1",231,0)
 . S I1=$O(^MAG(2005,IEN),-1),I1=$S(I1:I1,1:"")
"RTN","MAGQBPG1",232,0)
 . S I2=$O(^MAG(2005.1,IEN),-1),I2=$S(I2:I2,1:"")
"RTN","MAGQBPG1",233,0)
 . I I1,'I2 S IEN=I1,GB="^MAG(2005," Q
"RTN","MAGQBPG1",234,0)
 . I I2,'I1 S IEN=I2,GB="^MAG(2005.1," Q
"RTN","MAGQBPG1",235,0)
 . S GB=$S(I1<I2:"^MAG(2005.1,",1:"^MAG(2005,")
"RTN","MAGQBPG1",236,0)
 . S IEN=$S(I1<I2:I2,1:I1)
"RTN","MAGQBPG1",237,0)
 . Q
"RTN","MAGQBPG1",238,0)
 S (IEN,MAGDA)=$S('IEN:"",1:IEN)
"RTN","MAGQBPG1",239,0)
 Q
"RTN","MAGQBPG1",240,0)
KLOG(GL,IEN,CORREC) ;
"RTN","MAGQBPG1",241,0)
 S CORREC=$P($P(GL,","),"^MAG(",2)_"~"_IEN
"RTN","MAGQBPG1",242,0)
 D LOGKILL(GL_IEN_")") ;Journal the nodes and content being killed
"RTN","MAGQBPG1",243,0)
 K @(GL_IEN_")")
"RTN","MAGQBPG1",244,0)
 Q
"RTN","MAGQBPG1",245,0)
LOGKILL(REC) ; Log the content into the ^TMP global error log rpc
"RTN","MAGQBPG1",246,0)
 N NODE,NODE1,NODE2,NODE3,TMP,TMP1
"RTN","MAGQBPG1",247,0)
 S NODE=""
"RTN","MAGQBPG1",248,0)
 F  S NODE=$O(@REC@(NODE)) Q:NODE=""  D
"RTN","MAGQBPG1",249,0)
 . S TMP=$G(@REC@(NODE)) I TMP]"" S TMP1=$P(REC,")")_","_NODE_")="_TMP D ELOGV(TMP1)
"RTN","MAGQBPG1",250,0)
 . S NODE1="" F  S NODE1=$O(@REC@(NODE,NODE1)) Q:NODE1=""  D
"RTN","MAGQBPG1",251,0)
 . . S TMP=$G(@REC@(NODE,NODE1))  I TMP]"" S TMP1=$P(REC,")")_","_NODE_","_NODE1_")="_TMP D ELOGV(TMP1)
"RTN","MAGQBPG1",252,0)
 . . S NODE2="" F  S NODE2=$O(@REC@(NODE,NODE1,NODE2)) Q:NODE2=""  D
"RTN","MAGQBPG1",253,0)
 . . . S TMP=$G(@REC@(NODE,NODE1,NODE2)) I TMP]"" S TMP1=$P(REC,")")_","_NODE_","_NODE1_","_NODE2_")"_"="_TMP D ELOGV(TMP1)
"RTN","MAGQBPG1",254,0)
 . . . S NODE3="" F  S NODE3=$O(@REC@(NODE,NODE1,NODE2,NODE3)) Q:NODE3=""  D
"RTN","MAGQBPG1",255,0)
 . . . . S TMP=$G(@REC@(NODE,NODE1,NODE2,NODE3)) S TMP1=$P(REC,")")_","_NODE_","_NODE1_","_NODE2_","_NODE3_")="_TMP D ELOGV(TMP1)
"RTN","MAGQBPG1",256,0)
 . . . . Q
"RTN","MAGQBPG1",257,0)
 . . . Q
"RTN","MAGQBPG1",258,0)
 . . Q
"RTN","MAGQBPG1",259,0)
 . Q
"RTN","MAGQBPG1",260,0)
 Q
"RTN","MAGQBPG1",261,0)
ELOGV(MESG,LIMIT) ;TMP Log 
"RTN","MAGQBPG1",262,0)
 N INDX
"RTN","MAGQBPG1",263,0)
 N X S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",264,0)
 S INDX=+$O(^TMP("MAGQ",$J,"BPV",""),-1)+1
"RTN","MAGQBPG1",265,0)
 S ^TMP("MAGQ",$J,"BPV",INDX)=MESG
"RTN","MAGQBPG1",266,0)
 Q
"RTN","MAGQBPG1",267,0)
ELOGRV(RESULT,LIMIT) ; [MAGQ LOGV] Error log report and purge
"RTN","MAGQBPG1",268,0)
 ; Please test this
"RTN","MAGQBPG1",269,0)
 N FN,INDX,CNT
"RTN","MAGQBPG1",270,0)
 N X S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",271,0)
 S CNT=0,INDX=""
"RTN","MAGQBPG1",272,0)
 F  S INDX=$O(^TMP("MAGQ",$J,"BPV",INDX)) Q:INDX'?1N.N  Q:CNT=LIMIT  D
"RTN","MAGQBPG1",273,0)
 . S CNT=CNT+1,RESULT(CNT)=^TMP("MAGQ",$J,"BPV",INDX)
"RTN","MAGQBPG1",274,0)
 . K ^TMP("MAGQ",$J,"BPV",INDX)
"RTN","MAGQBPG1",275,0)
 . Q
"RTN","MAGQBPG1",276,0)
 S RESULT(0)=CNT
"RTN","MAGQBPG1",277,0)
 S INDX=$O(^TMP("MAGQ",$J,"BPV",""))
"RTN","MAGQBPG1",278,0)
 I INDX?1N.N S RESULT(0)=RESULT(0)_U_"MORE"
"RTN","MAGQBPG1",279,0)
 Q
"RTN","MAGQBUT5")
0^3^B105589397
"RTN","MAGQBUT5",1,0)
MAGQBUT5 ;WOIFO/RMP - BP Utilities ; 17 JUL 2014 10:19 AM
"RTN","MAGQBUT5",2,0)
 ;;3.0;IMAGING;**20,81,39,154**;Mar 19, 2002;Build 9;Jul 28, 2011
"RTN","MAGQBUT5",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQBUT5",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT5",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBUT5",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBUT5",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBUT5",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBUT5",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBUT5",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBUT5",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBUT5",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBUT5",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBUT5",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBUT5",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBUT5",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT5",17,0)
 ;;
"RTN","MAGQBUT5",18,0)
 Q
"RTN","MAGQBUT5",19,0)
AI(RESULT) ; List of Associated Institution candidates;
"RTN","MAGQBUT5",20,0)
 N INDEX,INST,J,K,L,OUT
"RTN","MAGQBUT5",21,0)
 S K=0
"RTN","MAGQBUT5",22,0)
 S RESULT(K)=""
"RTN","MAGQBUT5",23,0)
 S K=K+1
"RTN","MAGQBUT5",24,0)
 D LIST^DIC(40.8,,".01;.07I",,,,,,,,"OUT")
"RTN","MAGQBUT5",25,0)
 S RESULT(K)="The following Medical Center Divisions have Imaging Site Parameters defined on ",K=K+1
"RTN","MAGQBUT5",26,0)
 S RESULT(K)="your system:" D
"RTN","MAGQBUT5",27,0)
 . S INDEX=0,K=K+1 F  S INDEX=INDEX+1 Q:'$D(OUT("DILIST","ID",INDEX))  D
"RTN","MAGQBUT5",28,0)
 . . S INST=OUT("DILIST","ID",INDEX,.07),J=0 F  S J=$O(^MAG(2006.1,J)) Q:'J  I $P(^MAG(2006.1,J,0),U)=INST D  Q
"RTN","MAGQBUT5",29,0)
 . . . S RESULT(K)=OUT("DILIST","ID",INDEX,.01)_" "_INST,K=K+1 Q
"RTN","MAGQBUT5",30,0)
 . . Q
"RTN","MAGQBUT5",31,0)
 . Q
"RTN","MAGQBUT5",32,0)
 I INDEX=1 S RESULT(K)="None",K=K+1
"RTN","MAGQBUT5",33,0)
 S RESULT(K)="The following Medical Center Divisions have 'Associated Institutions' defined on ",K=K+1
"RTN","MAGQBUT5",34,0)
 S RESULT(K)="your system:" D
"RTN","MAGQBUT5",35,0)
 . S INDEX="",K=K+1,L=K  F  S INDEX=$O(^MAG(2006.1,"B",INDEX)) Q:'INDEX  D
"RTN","MAGQBUT5",36,0)
 . . Q:$P($G(^MAG(2006.1,$O(^MAG(2006.1,"B",INDEX,"")),0)),U)=INDEX
"RTN","MAGQBUT5",37,0)
 . . S RESULT(K)=$$GET1^DIQ(4,INDEX,.01,"E")_" "_INDEX,K=K+1 Q  ;IA fix
"RTN","MAGQBUT5",38,0)
 . Q
"RTN","MAGQBUT5",39,0)
 I K=L S RESULT(K)="None",K=K+1
"RTN","MAGQBUT5",40,0)
 S RESULT(K)="The following Medical Center Divisions have NO Imaging parameter affiliations ",K=K+1
"RTN","MAGQBUT5",41,0)
 S RESULT(K)="defined on your system:" D
"RTN","MAGQBUT5",42,0)
 . S INDEX=0,K=K+1,L=K F  S INDEX=INDEX+1 Q:'$D(OUT("DILIST","ID",INDEX))  D
"RTN","MAGQBUT5",43,0)
 . . S INST=OUT("DILIST","ID",INDEX,.07) Q:$D(^MAG(2006.1,"B",INST))  D
"RTN","MAGQBUT5",44,0)
 . . . S RESULT(K)=OUT("DILIST","ID",INDEX,.01)_" "_INST,K=K+1 Q
"RTN","MAGQBUT5",45,0)
 . . Q
"RTN","MAGQBUT5",46,0)
 . Q
"RTN","MAGQBUT5",47,0)
 I K=L S RESULT(K)="None",K=K+1
"RTN","MAGQBUT5",48,0)
 K OUT
"RTN","MAGQBUT5",49,0)
 D CLEAN^DILF
"RTN","MAGQBUT5",50,0)
 Q
"RTN","MAGQBUT5",51,0)
PLNM(PLACE) ;  Returns the Institution name of the Place
"RTN","MAGQBUT5",52,0)
 N INST
"RTN","MAGQBUT5",53,0)
 Q:'PLACE " "
"RTN","MAGQBUT5",54,0)
 S INST=$P($G(^MAG(2006.1,PLACE,0)),U)
"RTN","MAGQBUT5",55,0)
 Q $$GET1^DIQ(4,INST,.01,"E")  ;IA fix
"RTN","MAGQBUT5",56,0)
TPMESS(PLACE) ;Trigger a purge message
"RTN","MAGQBUT5",57,0)
 N Y,LOC,CNT,XMSUB
"RTN","MAGQBUT5",58,0)
 S Y=$$FMTE^XLFDT($$NOW^XLFDT)
"RTN","MAGQBUT5",59,0)
 S LOC=$$KSP^XUPARAM("WHERE")
"RTN","MAGQBUT5",60,0)
 S CNT=1,^TMP($J,"MAGQ",CNT)="SITE: "_LOC
"RTN","MAGQBUT5",61,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="DATE: "_Y_" "_$G(^XMB("TIMEZONE"))
"RTN","MAGQBUT5",62,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="SENDER: "_$$PLNM^MAGQBUT5(PLACE)_" Imaging Background Processor"
"RTN","MAGQBUT5",63,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="An automatic purge event has been initiated"
"RTN","MAGQBUT5",64,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="in order to maintain adequate image storage"
"RTN","MAGQBUT5",65,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="no operator intervention is required."
"RTN","MAGQBUT5",66,0)
 S XMSUB="VistA Imaging BP Queue processor - Autopurge"
"RTN","MAGQBUT5",67,0)
 D MAILSHR^MAGQBUT1(PLACE,"AUTOPURGE",XMSUB)
"RTN","MAGQBUT5",68,0)
 D UDMI^MAGQBUT5("VistA Imaging BP Queue processor - Autopurge",PLACE)
"RTN","MAGQBUT5",69,0)
 Q
"RTN","MAGQBUT5",70,0)
ADDMG(SUB,XMY,PLACE) ; Provide an array of Message Recipients for Message Subject
"RTN","MAGQBUT5",71,0)
 N INDEX,IEN,GROUP,NAME,J,K,L,KEY
"RTN","MAGQBUT5",72,0)
 S SUB=$TR(SUB," ","_")
"RTN","MAGQBUT5",73,0)
 S XMY("G.MAG SERVER")=""
"RTN","MAGQBUT5",74,0)
 S INDEX="" F  S INDEX=$O(^MAG(2006.1,PLACE,6,"B",INDEX)) Q:INDEX=""  D
"RTN","MAGQBUT5",75,0)
 . Q:SUB'[INDEX
"RTN","MAGQBUT5",76,0)
 . S J=$O(^MAG(2006.1,PLACE,6,"B",INDEX,"")) ; first add Mail Groups
"RTN","MAGQBUT5",77,0)
 . S K=0 F  S K=$O(^MAG(2006.1,PLACE,6,J,1,"B",K)) Q:'K  D
"RTN","MAGQBUT5",78,0)
 . . Q:'$$GOTLOCAL^XMXAPIG(K,"")
"RTN","MAGQBUT5",79,0)
 . . S NAME="G."_$$GET1^DIQ(3.8,K,.01,"E")
"RTN","MAGQBUT5",80,0)
 . . S XMY(NAME)=""
"RTN","MAGQBUT5",81,0)
 . . Q
"RTN","MAGQBUT5",82,0)
 . I +$P($G(^MAG(2006.1,PLACE,6,J,3,0)),U,4) D  ; next add Mail Message members
"RTN","MAGQBUT5",83,0)
 . . S K=0 F  S K=$O(^MAG(2006.1,PLACE,6,J,3,"B",K)) Q:'K  D
"RTN","MAGQBUT5",84,0)
 . . . Q:'+$$ACTIVE^XUSER(K)
"RTN","MAGQBUT5",85,0)
 . . . S XMY(K)=""
"RTN","MAGQBUT5",86,0)
 . . . Q
"RTN","MAGQBUT5",87,0)
 . . Q
"RTN","MAGQBUT5",88,0)
 . I +$P($G(^MAG(2006.1,PLACE,6,J,4,0)),U,4) D  ; next add designated Security Key holders
"RTN","MAGQBUT5",89,0)
 . . S K=0 F  S K=$O(^MAG(2006.1,PLACE,6,J,4,"B",K)) Q:'K  D
"RTN","MAGQBUT5",90,0)
 . . . S KEY=$P($G(^DIC(19.1,K,0)),U,1) Q:KEY=""
"RTN","MAGQBUT5",91,0)
 . . . S L="" F  S L=$O(^XUSEC(KEY,L)) Q:'L  D
"RTN","MAGQBUT5",92,0)
 . . . . Q:'+$$ACTIVE^XUSER(L)
"RTN","MAGQBUT5",93,0)
 . . . . S XMY(L)=""
"RTN","MAGQBUT5",94,0)
 . . . . Q
"RTN","MAGQBUT5",95,0)
 . . . Q
"RTN","MAGQBUT5",96,0)
 . . Q
"RTN","MAGQBUT5",97,0)
 . Q
"RTN","MAGQBUT5",98,0)
 Q
"RTN","MAGQBUT5",99,0)
GETMI(SUB,PLACE) ; Provide the message interval assigned to this message type
"RTN","MAGQBUT5",100,0)
 N INDEX,RETURN,IEN,IENS
"RTN","MAGQBUT5",101,0)
 S RETURN=0
"RTN","MAGQBUT5",102,0)
 S SUB=$TR(SUB," ","_")
"RTN","MAGQBUT5",103,0)
 S INDEX="" F  S INDEX=$O(^MAG(2006.1,PLACE,6,"B",INDEX)) Q:INDEX=""  D
"RTN","MAGQBUT5",104,0)
 . Q:SUB'[INDEX
"RTN","MAGQBUT5",105,0)
 . S IEN=$O(^MAG(2006.1,PLACE,6,"B",INDEX,""))
"RTN","MAGQBUT5",106,0)
 . S IENS=IEN_","_PLACE_","
"RTN","MAGQBUT5",107,0)
 . S RETURN=$$GET1^DIQ(2006.166,IENS,1)_U_$$GET1^DIQ(2006.166,IENS,3,"I")
"RTN","MAGQBUT5",108,0)
 Q $S('RETURN:0,1:RETURN)
"RTN","MAGQBUT5",109,0)
 ;
"RTN","MAGQBUT5",110,0)
UDMI(SUB,PLACE) ; Update DATE OF LAST MESSAGE
"RTN","MAGQBUT5",111,0)
 N INDEX,RETURN,IEN
"RTN","MAGQBUT5",112,0)
 S RETURN=0
"RTN","MAGQBUT5",113,0)
 S SUB=$TR(SUB," ","_")
"RTN","MAGQBUT5",114,0)
 S INDEX="" F  S INDEX=$O(^MAG(2006.1,PLACE,6,"B",INDEX)) Q:INDEX=""  D  Q:RETURN
"RTN","MAGQBUT5",115,0)
 . Q:SUB'[INDEX
"RTN","MAGQBUT5",116,0)
 . S IEN=$O(^MAG(2006.1,PLACE,6,"B",INDEX,""))
"RTN","MAGQBUT5",117,0)
 . S $P(^MAG(2006.1,PLACE,6,IEN,2),U,1)=$$NOW^XLFDT
"RTN","MAGQBUT5",118,0)
 . S RETURN="1"
"RTN","MAGQBUT5",119,0)
 . Q
"RTN","MAGQBUT5",120,0)
 Q RETURN
"RTN","MAGQBUT5",121,0)
 ;
"RTN","MAGQBUT5",122,0)
RMRPC(NAME) ; Removing an RPC in order to revise
"RTN","MAGQBUT5",123,0)
 N MW,RPC,MWE,DIERR,DA,DIK
"RTN","MAGQBUT5",124,0)
 S MW=$$FIND1^DIC(19,"","X","MAG WINDOWS","","","")
"RTN","MAGQBUT5",125,0)
 D CLEAN^DILF
"RTN","MAGQBUT5",126,0)
 S RPC=$$FIND1^DIC(8994,"","X",NAME,"","","")
"RTN","MAGQBUT5",127,0)
 D CLEAN^DILF
"RTN","MAGQBUT5",128,0)
 Q:'RPC
"RTN","MAGQBUT5",129,0)
 I MW D
"RTN","MAGQBUT5",130,0)
 . S MWE=$$FIND1^DIC(19.05,","_MW_",","X",NAME,"","","")
"RTN","MAGQBUT5",131,0)
 . D CLEAN^DILF
"RTN","MAGQBUT5",132,0)
 . Q:'MWE
"RTN","MAGQBUT5",133,0)
 . S DA=MWE,DA(1)=MW,DIK="^DIC(19,"_DA(1)_",""RPC"","
"RTN","MAGQBUT5",134,0)
 . D ^DIK
"RTN","MAGQBUT5",135,0)
 . K DA,DIK
"RTN","MAGQBUT5",136,0)
 . Q
"RTN","MAGQBUT5",137,0)
 S DA=RPC,DIK="^XWB(8994,"
"RTN","MAGQBUT5",138,0)
 D ^DIK
"RTN","MAGQBUT5",139,0)
 K DA,DIK
"RTN","MAGQBUT5",140,0)
 Q
"RTN","MAGQBUT5",141,0)
MOVE(RESULT,FNAM) ;[MAGQ MOVE]
"RTN","MAGQBUT5",142,0)
 N IEN,FTYPE,NMSPC,SITEID,EXT,ALT,J,X
"RTN","MAGQBUT5",143,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT5",144,0)
 S NMSPC=$TR($P(FNAM,"."),"0123456789","")
"RTN","MAGQBUT5",145,0)
 S SITEID=$$INIS^MAGQBPG2($$PLACE^MAGBAPI(+DUZ(2)))
"RTN","MAGQBUT5",146,0)
 I SITEID'[(","_NMSPC_",") D  Q
"RTN","MAGQBUT5",147,0)
 . S RESULT="0^Invalid Imaging Namespace"
"RTN","MAGQBUT5",148,0)
 S IEN=$O(^MAG(2005,"F",$P(FNAM,"."),""))
"RTN","MAGQBUT5",149,0)
 I IEN'?1N.N!('$D(^MAG(2005,IEN,0))) D  Q
"RTN","MAGQBUT5",150,0)
 . S RESULT="0^No matching 2005 entry"
"RTN","MAGQBUT5",151,0)
 S EXT=$P(FNAM,".",2)
"RTN","MAGQBUT5",152,0)
 I $P($G(^MAG(2005,IEN,0)),U,2)[FNAM S RESULT=IEN_U_"FULL"
"RTN","MAGQBUT5",153,0)
 E  D
"RTN","MAGQBUT5",154,0)
 . S FTYPE=$$FTYPE^MAGQBPRG(EXT,IEN)
"RTN","MAGQBUT5",155,0)
 . I FTYPE="FULL" D  Q
"RTN","MAGQBUT5",156,0)
 . . D FTYPE(.ALT)
"RTN","MAGQBUT5",157,0)
 . . S J=""
"RTN","MAGQBUT5",158,0)
 . . F  S J=$O(ALT(J)) Q:J'?1N.N  S:ALT(J)[EXT FTYPE="ALT"
"RTN","MAGQBUT5",159,0)
 . . I FTYPE["ALT" S RESULT=IEN_U_FTYPE
"RTN","MAGQBUT5",160,0)
 . . E  S RESULT="0^Invalid File Extension"
"RTN","MAGQBUT5",161,0)
 . E  S RESULT=IEN_U_FTYPE
"RTN","MAGQBUT5",162,0)
 Q
"RTN","MAGQBUT5",163,0)
QRNGE(RESULT,QUEUE,PROC,START,STOP,PLACE) ;
"RTN","MAGQBUT5",164,0)
 ;[MAGQ QRNGE] Requeue/Dequeue a Range of Queues
"RTN","MAGQBUT5",165,0)
 N XX,CNT,TMP,QP,X,PART
"RTN","MAGQBUT5",166,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT5",167,0)
 S CNT=0,TMP=""
"RTN","MAGQBUT5",168,0)
 S PLACE=$P($G(^MAGQUEUE(2006.03,START,0)),U,12)
"RTN","MAGQBUT5",169,0)
 Q:'PLACE
"RTN","MAGQBUT5",170,0)
 S XX=+$O(^MAGQUEUE(2006.03,"C",PLACE,QUEUE,START),-1)
"RTN","MAGQBUT5",171,0)
 F  S XX=$O(^MAGQUEUE(2006.03,"C",PLACE,QUEUE,XX)) Q:'XX  Q:XX>(STOP)  D
"RTN","MAGQBUT5",172,0)
 . S CNT=CNT+1
"RTN","MAGQBUT5",173,0)
 . D:PROC="DEL"
"RTN","MAGQBUT5",174,0)
 . . S QP=$O(^MAGQUEUE(2006.031,"C",PLACE,QUEUE,""))
"RTN","MAGQBUT5",175,0)
 . . S PART=$S(QP:$P(^MAGQUEUE(2006.031,QP,0),U,2),1:"")
"RTN","MAGQBUT5",176,0)
 . . I XX>PART D ADD^MAGBAPI(-1,QUEUE,PLACE)
"RTN","MAGQBUT5",177,0)
 . . D DQUE^MAGQBUT2(XX)
"RTN","MAGQBUT5",178,0)
 . . Q
"RTN","MAGQBUT5",179,0)
 . D:PROC="REQ" REQUE^MAGQBTM(.TMP,XX)
"RTN","MAGQBUT5",180,0)
 . Q
"RTN","MAGQBUT5",181,0)
 S RESULT=CNT
"RTN","MAGQBUT5",182,0)
 Q
"RTN","MAGQBUT5",183,0)
UAT(RESULT,PLACE) ; to support and maintain a dummy BP workstation with unassigned workstation tasks - future RPC
"RTN","MAGQBUT5",184,0)
 ;AUTO PURGE(3), AUTO VERIFY(4), ABSTRACT(12), JUKEBOX(13), JBTOHD(14), PREFET(15), IMPORT(16), GCC(17), DELETE(20)
"RTN","MAGQBUT5",185,0)
 N WSIEN,TASKS,WS,UAT,NODE,PIECE,FIELD,ASSIGNED,I
"RTN","MAGQBUT5",186,0)
 ; Remove and re-build unassigned task entry
"RTN","MAGQBUT5",187,0)
 S I=0 F  S I=$O(^MAG(2006.8,I)) Q:'I  S NODE=$G(^MAG(2006.8,I,0)) D
"RTN","MAGQBUT5",188,0)
 . Q:$P(NODE,U)'="UAT"
"RTN","MAGQBUT5",189,0)
 . Q:$P(NODE,U,2)'=PLACE
"RTN","MAGQBUT5",190,0)
 . S DIK="^MAG(2006.8,",DA=I
"RTN","MAGQBUT5",191,0)
 . D ^DIK
"RTN","MAGQBUT5",192,0)
 . K DIK
"RTN","MAGQBUT5",193,0)
 . Q 
"RTN","MAGQBUT5",194,0)
 S RESULT="1"
"RTN","MAGQBUT5",195,0)
 D:'$D(^MAG(2006.8,"C",PLACE,"Unassigned Tasks")) CUAT(PLACE)
"RTN","MAGQBUT5",196,0)
 S UAT=$O(^MAG(2006.8,"C",PLACE,"Unassigned Tasks",""))
"RTN","MAGQBUT5",197,0)
 F FIELD=3,4,12,13,14,15,16,17,20 D
"RTN","MAGQBUT5",198,0)
 . S (ASSIGNED,WS)=""
"RTN","MAGQBUT5",199,0)
 . F  S WS=$O(^MAG(2006.8,"C",PLACE,WS)) Q:WS=""  D  Q:ASSIGNED
"RTN","MAGQBUT5",200,0)
 . . S WSIEN=$O(^MAG(2006.8,"C",PLACE,WS,""))
"RTN","MAGQBUT5",201,0)
 . . S ASSIGNED=+$$GET1^DIQ(2006.8,WSIEN_",",FIELD,"I","","")
"RTN","MAGQBUT5",202,0)
 . . Q
"RTN","MAGQBUT5",203,0)
 . I 'ASSIGNED S FDA(2006.8,UAT_",",FIELD)="1"
"RTN","MAGQBUT5",204,0)
 . Q
"RTN","MAGQBUT5",205,0)
 I $D(FDA) D FILE^DIE("","FDA","FDAIEN")
"RTN","MAGQBUT5",206,0)
 K FDA,FDAIEN
"RTN","MAGQBUT5",207,0)
 Q RESULT
"RTN","MAGQBUT5",208,0)
CUAT(PLACE) ;
"RTN","MAGQBUT5",209,0)
 N CUATFDA
"RTN","MAGQBUT5",210,0)
 S CUATFDA(10,2006.8,"+1,",.01)="UAT"
"RTN","MAGQBUT5",211,0)
 S CUATFDA(10,2006.8,"+1,",.04)=PLACE
"RTN","MAGQBUT5",212,0)
 S CUATFDA(10,2006.8,"+1,",50)="Unassigned Tasks"
"RTN","MAGQBUT5",213,0)
 D UPDATE^DIE("","CUATFDA(10)","FDAIEN")
"RTN","MAGQBUT5",214,0)
 K CUATFDA
"RTN","MAGQBUT5",215,0)
 Q
"RTN","MAGQBUT5",216,0)
FINDC(RESULT,FNUM,IENS,FLAG,FNDVALUE,XREF,SCREEN) ; [MAGQ FINDC] Find with Compound Index - uses key field lookup
"RTN","MAGQBUT5",217,0)
 ;    function Find1(FNum,IENS,Flag,FndValue,XREF,Screen:string;silent:boolean): string;
"RTN","MAGQBUT5",218,0)
 N VALUE,INDEX
"RTN","MAGQBUT5",219,0)
 F INDEX=1:1:$L(FNDVALUE,U) S VALUE(INDEX)=$P(FNDVALUE,U,INDEX)
"RTN","MAGQBUT5",220,0)
 S RESULT=$$FIND1^DIC(FNUM,IENS,FLAG,.VALUE,XREF,SCREEN,"FNDERR")
"RTN","MAGQBUT5",221,0)
 K FNDERR
"RTN","MAGQBUT5",222,0)
 Q RESULT
"RTN","MAGQBUT5",223,0)
CRG(PL,RG) ; Count RAID groups by place
"RTN","MAGQBUT5",224,0)
 N CNT,I,J,NODE,NV
"RTN","MAGQBUT5",225,0)
 S I=RG,CNT=0,NV=""
"RTN","MAGQBUT5",226,0)
 F  S I=$O(^MAG(2005.2,"B",I)) Q:I=""  Q:($E(I,1,$L(RG))'[RG)  D
"RTN","MAGQBUT5",227,0)
 . S J=$O(^MAG(2005.2,"B",I,"")) Q:'J  S NODE=$G(^MAG(2005.2,J,0)) D  Q:NV'=""
"RTN","MAGQBUT5",228,0)
 . . Q:$P(NODE,"^",10)'=PL  ; Screen on Place
"RTN","MAGQBUT5",229,0)
 . . S CNT=CNT+1
"RTN","MAGQBUT5",230,0)
 . . S:'$D(^MAG(2005.2,"B",(RG_CNT))) NV=(RG_CNT)
"RTN","MAGQBUT5",231,0)
 . . Q
"RTN","MAGQBUT5",232,0)
 . Q
"RTN","MAGQBUT5",233,0)
 S:NV="" NV=RG_(CNT+1)
"RTN","MAGQBUT5",234,0)
 Q NV
"RTN","MAGQBUT5",235,0)
ADDRG(RESULT,CNT,PLACE) ; Add Raid Groups to the Network Location file
"RTN","MAGQBUT5",236,0)
 ; [MAGQ ADD RAID GROUP]
"RTN","MAGQBUT5",237,0)
 N PL,I,VALUE,NMSP,LRG,X
"RTN","MAGQBUT5",238,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT5",239,0)
 S PL=$G(PLACE)
"RTN","MAGQBUT5",240,0)
 S:PL="" PL=$$PLACE^MAGBAPI(+$G(DUZ(2))) Q:'PL  D
"RTN","MAGQBUT5",241,0)
 . S NMSP=$P($G(^MAG(2006.1,PL,0)),U,2)
"RTN","MAGQBUT5",242,0)
 . F I=1:1:CNT  D
"RTN","MAGQBUT5",243,0)
 . . S VALUE=$$CRG(PL,"RG-"_NMSP)
"RTN","MAGQBUT5",244,0)
 . . Q:$D(^MAG(2005.2,"D",PL,VALUE))  ; Do not create duplicates
"RTN","MAGQBUT5",245,0)
 . . S MAGFDA(2005.2,"+1,",.01)=VALUE
"RTN","MAGQBUT5",246,0)
 . . S MAGFDA(2005.2,"+1,",.04)=PL ;Place
"RTN","MAGQBUT5",247,0)
 . . S MAGFDA(2005.2,"+1,",5)="0" ;READ-only
"RTN","MAGQBUT5",248,0)
 . . S MAGFDA(2005.2,"+1,",6)="GRP" ;"RAID-GROUP"
"RTN","MAGQBUT5",249,0)
 . . D UPDATE^DIE("U","MAGFDA","MAGIEN","MAGERR")
"RTN","MAGQBUT5",250,0)
 . . I $D(DIERR) W !,"Error updating the Network Location file: "_MAGERR("DIERR",1,"TEXT",1)
"RTN","MAGQBUT5",251,0)
 . . K MAGFDA,DIERR,MAGIEN,MAGFDA,MAGERR
"RTN","MAGQBUT5",252,0)
 . . Q
"RTN","MAGQBUT5",253,0)
 . Q
"RTN","MAGQBUT5",254,0)
 S RESULT="1"
"RTN","MAGQBUT5",255,0)
 Q
"RTN","MAGQBUT5",256,0)
 ;
"RTN","MAGQBUT5",257,0)
CAS ; Remove Acquisition Session file entries
"RTN","MAGQBUT5",258,0)
 ; Remove entries in 2006.041 - ACQUISITION SESSION FILE
"RTN","MAGQBUT5",259,0)
 ; Find COMPLETE import series and reduce to final outcome entry, keep for unique TrackingID ?
"RTN","MAGQBUT5",260,0)
 ; Next remove IMPORT QUEUE entry if Complete
"RTN","MAGQBUT5",261,0)
 ;Remove old queue entries from 2006.034 with no 2006.041 complement
"RTN","MAGQBUT5",262,0)
 N DA,DIK,IEN,TRKID,IMPORTQ,ZNODE,STATUS,SIEN
"RTN","MAGQBUT5",263,0)
 S IEN="A"
"RTN","MAGQBUT5",264,0)
 F  S IEN=$O(^MAG(2006.041,IEN),-1) Q:'IEN  D
"RTN","MAGQBUT5",265,0)
 . S ZNODE=$G(^MAG(2006.041,IEN,0))
"RTN","MAGQBUT5",266,0)
 . S IMPORTQ=$P(ZNODE,U,1),TRKID=$P(ZNODE,U,2),STATUS=$P(ZNODE,U,5)
"RTN","MAGQBUT5",267,0)
 . I TRKID="" S DIK="^MAG(2006.041,",DA=IEN D ^DIK K DIK,DA Q
"RTN","MAGQBUT5",268,0)
 . I $D(^MAG(2006.041,"C",TRKID)) D
"RTN","MAGQBUT5",269,0)
 . . ; skip latest entry, remove preliminary status entries
"RTN","MAGQBUT5",270,0)
 . . S SIEN="A",SIEN=$O(^MAG(2006.041,"C",TRKID,SIEN),-1)
"RTN","MAGQBUT5",271,0)
 . . I $$UPPER^MAGQE4($G(^MAG(2006.041,IEN,0)))["COMPLETE" D
"RTN","MAGQBUT5",272,0)
 . . . ; Remove IMPORT QUEUE entry if Complete
"RTN","MAGQBUT5",273,0)
 . . . I $D(^MAG(2006.034,IMPORTQ,0)) D
"RTN","MAGQBUT5",274,0)
 . . . . S DIK="^MAG(2006.034,",DA=IMPORTQ
"RTN","MAGQBUT5",275,0)
 . . . . D ^DIK K DIK,DA
"RTN","MAGQBUT5",276,0)
 . . . . ; Remove Queue Record, if it exists to eliminate dangling pointer
"RTN","MAGQBUT5",277,0)
 . . . . I $D(^MAGQUEUE(2006.03,IMPORTQ,0)) D DQUE^MAGQBUT2(IMPORTQ)
"RTN","MAGQBUT5",278,0)
 . . . . Q
"RTN","MAGQBUT5",279,0)
 . . . ; Remove log activity if Complete
"RTN","MAGQBUT5",280,0)
 . . . F  S SIEN=$O(^MAG(2006.041,"C",TRKID,SIEN),-1) Q:'SIEN  D
"RTN","MAGQBUT5",281,0)
 . . . . S DIK="^MAG(2006.041,",DA=SIEN
"RTN","MAGQBUT5",282,0)
 . . . . D ^DIK K DIK,DA
"RTN","MAGQBUT5",283,0)
 . . . . Q
"RTN","MAGQBUT5",284,0)
 . Q
"RTN","MAGQBUT5",285,0)
 ; Remove old queue entries from 2006.034 with no 2006.041 complement
"RTN","MAGQBUT5",286,0)
 S IEN="" F  S IEN=$O(^MAG(2006.034,IEN)) Q:'IEN  D:'$D(^MAG(2006.041,"B",IEN))
"RTN","MAGQBUT5",287,0)
 . S DIK="^MAG(2006.034,",DA=IEN
"RTN","MAGQBUT5",288,0)
 . D ^DIK
"RTN","MAGQBUT5",289,0)
 . K DIK,DA
"RTN","MAGQBUT5",290,0)
 . ; Remove Queue Record, if it exists to eliminate dangling pointer
"RTN","MAGQBUT5",291,0)
 . I $D(^MAGQUEUE(2006.03,IMPORTQ,0)) D DQUE^MAGQBUT2(IMPORTQ)
"RTN","MAGQBUT5",292,0)
 . Q
"RTN","MAGQBUT5",293,0)
 Q
"RTN","MAGQBUT5",294,0)
 ;
"RTN","MAGQBUT5",295,0)
FTYPE(RESULT) ;
"RTN","MAGQBUT5",296,0)
 ; RPC[MAGQ FTYPE]
"RTN","MAGQBUT5",297,0)
 N MAX,INDX,PLACE,X
"RTN","MAGQBUT5",298,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT5",299,0)
 S PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBUT5",300,0)
 S U="^",MAX=$P(^MAG(2006.1,PLACE,2,0),U,4),INDX=0
"RTN","MAGQBUT5",301,0)
 Q:+MAX<1
"RTN","MAGQBUT5",302,0)
 F  S INDX=$O(^MAG(2006.1,PLACE,2,INDX)) Q:INDX'?1N.N  D  Q:INDX=MAX
"RTN","MAGQBUT5",303,0)
 . S RESULT(INDX-1)=$G(^MAG(2006.1,PLACE,2,INDX,0))
"RTN","MAGQBUT5",304,0)
 . Q
"RTN","MAGQBUT5",305,0)
 Q
"RTN","MAGQBUT6")
0^4^B145956336
"RTN","MAGQBUT6",1,0)
MAGQBUT6 ;WIOFO/RMP,JSL - Utility to Consolidate Redundant Network Location file Entries ; 17 JUL 2014 3:21 PM
"RTN","MAGQBUT6",2,0)
 ;;3.0;IMAGING;**39,154**;Mar 19, 2002;Build 9;JUL 17, 2014
"RTN","MAGQBUT6",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQBUT6",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT6",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBUT6",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBUT6",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBUT6",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBUT6",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBUT6",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBUT6",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBUT6",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBUT6",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBUT6",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBUT6",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBUT6",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT6",17,0)
 ;;
"RTN","MAGQBUT6",18,0)
 Q
"RTN","MAGQBUT6",19,0)
CHKNAM(MAG) ; This is the input transform for the PLACE field in the Network location file.
"RTN","MAGQBUT6",20,0)
 N IEN,PLACE,VALUE
"RTN","MAGQBUT6",21,0)
 Q:'$D(MAG)
"RTN","MAGQBUT6",22,0)
 I 'DUZ(2) D  K X Q
"RTN","MAGQBUT6",23,0)
 . D EN^DDIOL("You may only edit records for the configuration to which your login is associated!")
"RTN","MAGQBUT6",24,0)
 . Q
"RTN","MAGQBUT6",25,0)
 S PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBUT6",26,0)
 I $D(DA),$P($G(^MAG(2005.2,DA,0)),U,10),PLACE'=$P($G(^MAG(2005.2,DA,0)),U,10) D  K X Q
"RTN","MAGQBUT6",27,0)
 . D EN^DDIOL("You may only edit records for the configuration to which your login is associated!")
"RTN","MAGQBUT6",28,0)
 . Q
"RTN","MAGQBUT6",29,0)
 S IEN="",VALUE=MAG
"RTN","MAGQBUT6",30,0)
 F  S IEN=$O(^MAG(2005.2,"B",VALUE,IEN)) Q:'IEN  D
"RTN","MAGQBUT6",31,0)
 . Q:$G(DA)=IEN
"RTN","MAGQBUT6",32,0)
 . I $P($G(^MAG(2005.2,IEN,0)),U,10)=PLACE D
"RTN","MAGQBUT6",33,0)
 . . D EN^DDIOL("Duplicate NAMES within the same VistA Imaging configuration (PLACE) is not allowed.")
"RTN","MAGQBUT6",34,0)
 . . K X
"RTN","MAGQBUT6",35,0)
 . . Q
"RTN","MAGQBUT6",36,0)
 . Q
"RTN","MAGQBUT6",37,0)
 Q
"RTN","MAGQBUT6",38,0)
CHKNET(MAG) ; This is the input transform for the share path (PHYSICAL REFERENCE  FIELD #1) in the network location file.
"RTN","MAGQBUT6",39,0)
 N UPPER,VALUE,PLACE,TABLE,IEN,TEMP,FAILED ; should convert all physical reference values to upper case
"RTN","MAGQBUT6",40,0)
 Q:'$D(MAG)
"RTN","MAGQBUT6",41,0)
 I '$G(DUZ(2)) D  K X Q
"RTN","MAGQBUT6",42,0)
 . D EN^DDIOL("You may only edit records for the configuration to which your login is associated!")
"RTN","MAGQBUT6",43,0)
 . Q
"RTN","MAGQBUT6",44,0)
 S VALUE="",PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBUT6",45,0)
 I PLACE'=$P($G(^MAG(2005.2,DA,0)),U,10),DA'["+1" D  K X Q
"RTN","MAGQBUT6",46,0)
 . D EN^DDIOL("You may only edit records for the configuration to which your login is associated!")
"RTN","MAGQBUT6",47,0)
 . Q 
"RTN","MAGQBUT6",48,0)
 S UPPER=$$UPPER^MAGQE4(MAG),FAILED=""
"RTN","MAGQBUT6",49,0)
 Q:$P($G(^MAG(2005.2,DA,0)),U,7)["EKG"  ;Allow to shared duplicate MUSE
"RTN","MAGQBUT6",50,0)
 F  S VALUE=$O(^MAG(2005.2,"G",PLACE,VALUE)) Q:VALUE=""  D  Q:'$D(X)
"RTN","MAGQBUT6",51,0)
 . I UPPER=$$UPPER^MAGQE4(VALUE) D
"RTN","MAGQBUT6",52,0)
 . . S IEN=""
"RTN","MAGQBUT6",53,0)
 . . F  S IEN=$O(^MAG(2005.2,"G",PLACE,VALUE,IEN)) Q:'IEN  D  Q:FAILED
"RTN","MAGQBUT6",54,0)
 . . . S TEMP=$P(^MAG(2005.2,IEN,0),U,7)_U_$P(^MAG(2005.2,IEN,0),U,8)_U_$P(^MAG(2005.2,IEN,0),U,9)
"RTN","MAGQBUT6",55,0)
 . . . I $D(TABLE(TEMP)) S FAILED=1 Q
"RTN","MAGQBUT6",56,0)
 . . . S TABLE(TEMP)=""
"RTN","MAGQBUT6",57,0)
 . . . Q
"RTN","MAGQBUT6",58,0)
 . . I +FAILED D  Q
"RTN","MAGQBUT6",59,0)
 . . D EN^DDIOL("Duplicate PHYSICAL REFERENCE values within the same VistA Imaging configuration (PLACE) is not allowed.")
"RTN","MAGQBUT6",60,0)
 . . K X
"RTN","MAGQBUT6",61,0)
 . . Q
"RTN","MAGQBUT6",62,0)
 . Q
"RTN","MAGQBUT6",63,0)
 K TABLE
"RTN","MAGQBUT6",64,0)
 Q
"RTN","MAGQBUT6",65,0)
CONSHR ;  This is the interface for the Consolidate redundant shares utility
"RTN","MAGQBUT6",66,0)
 N LIST,EN,ENTRY,FLDAR,PLACE
"RTN","MAGQBUT6",67,0)
 S PLACE=$O(^MAG(2006.1,"B",$$KSP^XUPARAM("INST"),""))
"RTN","MAGQBUT6",68,0)
 D GETRL^MAGQBU6A(.LIST) ;  Get Redundant List (of shares) where the path is the same.
"RTN","MAGQBUT6",69,0)
 S EN=$O(LIST("")) I EN="" D  Q
"RTN","MAGQBUT6",70,0)
 . D PMSG("======================================================================")
"RTN","MAGQBUT6",71,0)
 . D DFNIQ^MAGQBPG1(""," Production Account: "_$$PROD^XUPROD("1"),0,PLACE,"Consolidate Shares")
"RTN","MAGQBUT6",72,0)
 . D PMSG(" Imaging patch MAG*3.0*39 found no redundant Network Location shares to consolidate.")
"RTN","MAGQBUT6",73,0)
 . D DFNIQ^MAGQBPG1("","Installation: Redundant Network Location Utility",1,PLACE,"Consolidate Shares")
"RTN","MAGQBUT6",74,0)
 . Q
"RTN","MAGQBUT6",75,0)
 D PMSG("======================================================================")
"RTN","MAGQBUT6",76,0)
 D DFNIQ^MAGQBPG1(""," Production Account: "_$$PROD^XUPROD("1"),0,PLACE,"Consolidate Shares")
"RTN","MAGQBUT6",77,0)
 D PMSG("Redundant Share List ")
"RTN","MAGQBUT6",78,0)
 D PMSG("(Share ^ Hash ^ Place) Prime IEN ^ 2nd IEN ...")
"RTN","MAGQBUT6",79,0)
 S EN="" F  S EN=$O(LIST(EN)) Q:EN=""  D PMSG("("_EN_")"_LIST(EN))
"RTN","MAGQBUT6",80,0)
 D PMSG("======================================================================")
"RTN","MAGQBUT6",81,0)
 D PMSG("")
"RTN","MAGQBUT6",82,0)
 D PMSG("Here is the list of shares that will be consolidated")
"RTN","MAGQBUT6",83,0)
 D PMSG("The share references that exist in both the 2005, 2005.1 & 2006.035 files")
"RTN","MAGQBUT6",84,0)
 D PMSG("will be reset to the PRIME share entry. ")
"RTN","MAGQBUT6",85,0)
 D DSPNL^MAGQBU6A ; Display the original Network Location file
"RTN","MAGQBUT6",86,0)
 D FAR(.FLDAR) ; Setup File/Node/Piece Table for FieldNumbers
"RTN","MAGQBUT6",87,0)
 ;The following is being performed during the post install phase.
"RTN","MAGQBUT6",88,0)
 ;D PRIME(.LIST) ; If any like shares are on - set the prime shares on
"RTN","MAGQBUT6",89,0)
 D SFRP(.LIST) ; DESTINATION field (#1) of the SEND QUEUE File (#2006.035)
"RTN","MAGQBUT6",90,0)
 ;The following is being performed during the post install phase.
"RTN","MAGQBUT6",91,0)
 ;D SPRR(.LIST) ; Site Parameter file re-reference (#.03,.07,.08,1.02,1.03,2.01,52,53,55)
"RTN","MAGQBUT6",92,0)
 S ENTRY=0 D RSREF(.LIST,ENTRY) ; Consolidate references
"RTN","MAGQBUT6",93,0)
 D RLOC^MAGQBU6A(.LIST) ; Delete Network Location file entry
"RTN","MAGQBUT6",94,0)
 D REQDUP^MAGQBU6A ; rename any duplicate .01 network location entries.
"RTN","MAGQBUT6",95,0)
 D REPNAM^MAGQBU6A ;Report residual duplicate names
"RTN","MAGQBUT6",96,0)
 D DFNIQ^MAGQBPG1("","Installation: Redundant Network Location Utility",1,PLACE,"Consolidate Shares")
"RTN","MAGQBUT6",97,0)
 K LIST
"RTN","MAGQBUT6",98,0)
 K ^TMP($J,"MAGQDFN")
"RTN","MAGQBUT6",99,0)
 Q
"RTN","MAGQBUT6",100,0)
PRIME(LIST) ; If any like shares are on - set the prime shares on
"RTN","MAGQBUT6",101,0)
 N EMSG,EN,PC,FDA,MSG,PTMP,TMP
"RTN","MAGQBUT6",102,0)
 S EN="" F  S EN=$O(LIST(EN)) Q:EN=""  D
"RTN","MAGQBUT6",103,0)
 . S PTMP=$P(^MAG(2005.2,($P(LIST(EN),U)),0),U,6) Q:PTMP  D
"RTN","MAGQBUT6",104,0)
 . . S FDA(2005.2,$P(LIST(EN),U,1)_",",5)="1"
"RTN","MAGQBUT6",105,0)
 . . D FILE^DIE("I","FDA","MSG")
"RTN","MAGQBUT6",106,0)
 . . I $D(MSG("DIERR")) D PMSG("Prime entry: '"_IEN_" failed to be set online. "_MSG("DIERR",1,"TEXT",1)) D  Q
"RTN","MAGQBUT6",107,0)
 . . . K FDA,MSG
"RTN","MAGQBUT6",108,0)
 . . . Q
"RTN","MAGQBUT6",109,0)
 . . S EMSG="Prime entry "_$P(^MAG(2005.2,$P(LIST(EN),U),0),U)_", ^MAG(2005.2,"_$P(LIST(EN),U)_",0), was set to Online."
"RTN","MAGQBUT6",110,0)
 . . D DFNIQ^MAGQBPG1("",EMSG,0,PLACE,"Consolidate Shares")
"RTN","MAGQBUT6",111,0)
 . . K FDA,MSG
"RTN","MAGQBUT6",112,0)
 . . Q
"RTN","MAGQBUT6",113,0)
 . Q
"RTN","MAGQBUT6",114,0)
 Q
"RTN","MAGQBUT6",115,0)
SPRR(LIST) ; Site Parameter file re-reference (#.03,.07,.08,1.02,1.03,2.01,52,53,55)
"RTN","MAGQBUT6",116,0)
 N EN,FDA,NEW,MSG,OLD,PC,MSG,TMP,VALUE
"RTN","MAGQBUT6",117,0)
 S EN=0 F  S EN=$O(^MAG(2006.1,EN)) Q:'EN  D
"RTN","MAGQBUT6",118,0)
 . ; fields: .03,.07,.08
"RTN","MAGQBUT6",119,0)
 . F PC=3,7,8 S (VALUE,TMP)=$P($G(^MAG(2006.1,EN,0)),U,PC) D
"RTN","MAGQBUT6",120,0)
 . . S VALUE=$$FRP(VALUE,.LIST) I VALUE D
"RTN","MAGQBUT6",121,0)
 . . . S FDA(2006.1,EN_",",FLDAR(2006.1,0,PC))=VALUE
"RTN","MAGQBUT6",122,0)
 . . . D FILE^DIE("I","FDA","MSG")
"RTN","MAGQBUT6",123,0)
 . . . I $D(MSG("DIERR")) D  Q
"RTN","MAGQBUT6",124,0)
 . . . . D PMSG("Site Parameter Filing Error for IEN: "_IEN_MSG("DIERR",1,"TEXT",1)) K FDA,MSG
"RTN","MAGQBUT6",125,0)
 . . . . Q
"RTN","MAGQBUT6",126,0)
 . . . S FLD=$P(FLDAR(2006.1,0,PC),"^"),OLD=$P(^MAG(2005.2,TMP,0),"^"),NEW=$P(^MAG(2005.2,VALUE,0),"^")
"RTN","MAGQBUT6",127,0)
 . . . D PMSG("Field #"_FLDAR(2006.1,0,PC)_" Value: "_OLD_" Changed to New Value: "_NEW)
"RTN","MAGQBUT6",128,0)
 . . . D PMSG("^MAG(2006.1,"_EN_",0)"_" Piece "_PC) K FDA,MSG
"RTN","MAGQBUT6",129,0)
 . . . Q
"RTN","MAGQBUT6",130,0)
 . . Q
"RTN","MAGQBUT6",131,0)
 . ; fields: 1.02, 1.03
"RTN","MAGQBUT6",132,0)
 . F PC=2,3 S (VALUE,TMP)=$P($G(^MAG(2006.1,EN,"PACS")),U,PC) D
"RTN","MAGQBUT6",133,0)
 . . S VALUE=$$FRP(VALUE,.LIST) I VALUE D
"RTN","MAGQBUT6",134,0)
 . . . S FDA(2006.1,EN_",",FLDAR(2006.1,"PACS",PC))=VALUE
"RTN","MAGQBUT6",135,0)
 . . . D FILE^DIE("I","FDA","MSG")
"RTN","MAGQBUT6",136,0)
 . . . I $D(MSG("DIERR")) D  Q
"RTN","MAGQBUT6",137,0)
 . . . . D PMSG("Site Parameter Filing Error for IEN: "_EN_MSG("DIERR",1,"TEXT",1)) K FDA,MSG
"RTN","MAGQBUT6",138,0)
 . . . . Q
"RTN","MAGQBUT6",139,0)
 . . . S OLD=$P(^MAG(2005.2,TMP,0),"^"),NEW=$P(^MAG(2005.2,VALUE,0),"^")
"RTN","MAGQBUT6",140,0)
 . . . D PMSG("Field #"_FLDAR(2006.1,"PACS",PC)_" Value: "_OLD_" Changed to New Value: "_NEW)
"RTN","MAGQBUT6",141,0)
 . . . D PMSG("^MAG(2006.1,"_EN_",PACS)"_" Piece "_PC) K FDA,MSG
"RTN","MAGQBUT6",142,0)
 . . . Q
"RTN","MAGQBUT6",143,0)
 . . Q
"RTN","MAGQBUT6",144,0)
 . ; field: 2.01
"RTN","MAGQBUT6",145,0)
 . S (VALUE,TMP)=$P($G(^MAG(2006.1,EN,1)),U,6) D
"RTN","MAGQBUT6",146,0)
 . . S VALUE=$$FRP(VALUE,.LIST) I VALUE D
"RTN","MAGQBUT6",147,0)
 . . . S FDA(2006.1,EN_",",FLDAR(2006.1,1,6))=VALUE
"RTN","MAGQBUT6",148,0)
 . . . D FILE^DIE("I","FDA","MSG")
"RTN","MAGQBUT6",149,0)
 . . . I $D(MSG("DIERR")) D  Q
"RTN","MAGQBUT6",150,0)
 . . . . D PMSG("Site Parameter Filing Error for IEN: "_EN_" "_MSG("DIERR",1,"TEXT",1)) K FDA,MSG
"RTN","MAGQBUT6",151,0)
 . . . . Q
"RTN","MAGQBUT6",152,0)
 . . . S OLD=$P(^MAG(2005.2,TMP,0),"^"),NEW=$P(^MAG(2005.2,VALUE,0),"^")
"RTN","MAGQBUT6",153,0)
 . . . D PMSG("Field #"_FLDAR(2006.1,1,6)_" Value: "_OLD_" Changed to New Value: "_NEW)
"RTN","MAGQBUT6",154,0)
 . . . D PMSG("^MAG(2006.1,"_EN_",1)"_" Piece "_6) K FDA,MSG
"RTN","MAGQBUT6",155,0)
 . . . Q
"RTN","MAGQBUT6",156,0)
 . . Q
"RTN","MAGQBUT6",157,0)
 . ; fields: 52,53,55
"RTN","MAGQBUT6",158,0)
 . F PC=3,4,5 S (VALUE,TMP)=$P($G(^MAG(2006.1,EN,"NET")),U,PC) D
"RTN","MAGQBUT6",159,0)
 . . S VALUE=$$FRP(VALUE,.LIST) I VALUE D
"RTN","MAGQBUT6",160,0)
 . . . S FDA(2006.1,EN_",",FLDAR(2006.1,"NET",PC))=VALUE
"RTN","MAGQBUT6",161,0)
 . . . D FILE^DIE("I","FDA","MSG")
"RTN","MAGQBUT6",162,0)
 . . . I $D(MSG("DIERR")) D  Q
"RTN","MAGQBUT6",163,0)
 . . . . D PMSG("Site Parameter Filing Error for IEN: "_EN_" "_MSG("DIERR",1,"TEXT",1)) K FDA,MSG
"RTN","MAGQBUT6",164,0)
 . . . . Q
"RTN","MAGQBUT6",165,0)
 . . . S OLD=$P(^MAG(2005.2,TMP,0),"^"),NEW=$P(^MAG(2005.2,VALUE,0),"^")
"RTN","MAGQBUT6",166,0)
 . . . D PMSG("Field #"_FLDAR(2006.1,"NET",PC)_" Value: "_OLD_" Changed to New Value: "_NEW)
"RTN","MAGQBUT6",167,0)
 . . . D PMSG("^MAG(2006.1,"_EN_",NET)"_" Piece "_PC) K FDA,MSG
"RTN","MAGQBUT6",168,0)
 . . . Q
"RTN","MAGQBUT6",169,0)
 . . Q
"RTN","MAGQBUT6",170,0)
 . Q
"RTN","MAGQBUT6",171,0)
 Q
"RTN","MAGQBUT6",172,0)
SFRP(LIST) ; DESTINATION field (#1) of the SEND QUEUE File (#2006.035).
"RTN","MAGQBUT6",173,0)
 N EN,VALUE,TMP,FDA,MSG,TEXT,TMP,OLD
"RTN","MAGQBUT6",174,0)
 S EN=0 F  S EN=$O(^MAGQUEUE(2006.035,EN)) Q:'EN  D
"RTN","MAGQBUT6",175,0)
 . I $P($P($G(^MAGQUEUE(2006.035,EN,0)),U,2),";",2)="MAG(2005.2," D
"RTN","MAGQBUT6",176,0)
 . . S (VALUE,TMP)=$P($P($G(^MAGQUEUE(2006.035,EN,0)),U,2),";",1)
"RTN","MAGQBUT6",177,0)
 . . S VALUE=$$FRP(VALUE,.LIST) I VALUE D
"RTN","MAGQBUT6",178,0)
 . . . S TMP=$P($G(^MAGQUEUE(2006.035,EN,0)),U,2),OLD=$P(TMP,";"),$P(TMP,";")=VALUE
"RTN","MAGQBUT6",179,0)
 . . . S $P(^MAGQUEUE(2006.035,EN,0),U,2)=TMP,OLD=$P(^MAG(2005.2,OLD,0),U),NEW=$P(^MAG(2005.2,VALUE,0),U)
"RTN","MAGQBUT6",180,0)
 . . . S TEXT=("DESTINATION (#1) value: "_OLD_" changed to: "_NEW)
"RTN","MAGQBUT6",181,0)
 . . . S ^XTMP("MAGP39","IMAGEFILE",2006.035,EN,1)=TEXT
"RTN","MAGQBUT6",182,0)
 . . . Q
"RTN","MAGQBUT6",183,0)
 . . Q
"RTN","MAGQBUT6",184,0)
 . Q
"RTN","MAGQBUT6",185,0)
 Q
"RTN","MAGQBUT6",186,0)
RSREF(LIST,IEN) ; Consolidate references
"RTN","MAGQBUT6",187,0)
 N GL,IEN,IENS,NODE,PIECE,FNUM,VALUE,SIEN,SPIECE,SNODE,FLD,SUB,MSG,FDA,TMP,TEXT
"RTN","MAGQBUT6",188,0)
 S GL="",IEN=$S(+$G(IEN):IEN,1:0)
"RTN","MAGQBUT6",189,0)
 F  D SCAN^MAGQBPG1(.IEN,"F",.GL) D  Q:'IEN
"RTN","MAGQBUT6",190,0)
 . Q:'IEN
"RTN","MAGQBUT6",191,0)
 . S FNUM=$S(GL[2005.1:2005.1,GL[2005:2005,1:"")
"RTN","MAGQBUT6",192,0)
 . S NODE=$G(^MAG(FNUM,IEN,0))
"RTN","MAGQBUT6",193,0)
 . F PIECE=3,4,5 S (VALUE,TMP)=$P(NODE,U,PIECE) D:VALUE
"RTN","MAGQBUT6",194,0)
 . . S VALUE=$$FRP(VALUE,.LIST) I VALUE D
"RTN","MAGQBUT6",195,0)
 . . . S FDA(FNUM,IEN_",",FLDAR(FNUM,0,PIECE))=VALUE
"RTN","MAGQBUT6",196,0)
 . . . D FILE^DIE("I","FDA","MSG")
"RTN","MAGQBUT6",197,0)
 . . . I $D(MSG("DIERR")) D  Q
"RTN","MAGQBUT6",198,0)
 . . . . D PMSG($S(FNUM=2005:"Image File",1:"Image Archive")_" Filing Error for entry: "_IEN_MSG("DIERR",1,"TEXT",1)) K FDA,MSG
"RTN","MAGQBUT6",199,0)
 . . . . Q
"RTN","MAGQBUT6",200,0)
 . . . S TEXT="FIELD #"_FLDAR(FNUM,0,PIECE)_" value: "_TMP_" changed to: "_VALUE
"RTN","MAGQBUT6",201,0)
 . . . S ^XTMP("MAGP39","IMAGEFILE",FNUM,IEN,$G(FLDAR(FNUM,0,PIECE)))=TEXT
"RTN","MAGQBUT6",202,0)
 . . . Q
"RTN","MAGQBUT6",203,0)
 . . Q
"RTN","MAGQBUT6",204,0)
 . S NODE=$G(^MAG(FNUM,IEN,"FBIG"))
"RTN","MAGQBUT6",205,0)
 . F PIECE=1,2 S VALUE=$P(NODE,U,PIECE) D:VALUE
"RTN","MAGQBUT6",206,0)
 . . S (VALUE,TMP)=$$FRP(VALUE,.LIST) I VALUE D
"RTN","MAGQBUT6",207,0)
 . . . S FDA(FNUM,IEN_",",FLDAR(FNUM,"FBIG",PIECE))=VALUE
"RTN","MAGQBUT6",208,0)
 . . . D FILE^DIE("I","FDA","MSG")
"RTN","MAGQBUT6",209,0)
 . . . I $D(MSG("DIERR")) D  Q
"RTN","MAGQBUT6",210,0)
 . . . . D PMSG($S(FNUM=2005:"Image File",1:"Image Archive")_" Filing Error for IEN: "_IEN_MSG("DIERR",1,"TEXT",1)) K FDA,MSG
"RTN","MAGQBUT6",211,0)
 . . . . Q
"RTN","MAGQBUT6",212,0)
 . . . S TEXT="FIELD #"_FLDAR(FNUM,"FBIG",PIECE)_" Value: "_TMP_" changed to: "_VALUE
"RTN","MAGQBUT6",213,0)
 . . . S ^XTMP("MAGP39","IMAGEFILE",FNUM,IEN,$G(FLDAR(FNUM,"FBIG",PIECE)))=TEXT
"RTN","MAGQBUT6",214,0)
 . . . Q
"RTN","MAGQBUT6",215,0)
 . . Q
"RTN","MAGQBUT6",216,0)
 . F SNODE=4,5,6 I $D(^MAG(FNUM,IEN,SNODE)) D  ;ROUTING TIMESTAMP, EXPORT LOCATION, ROUTING LOG
"RTN","MAGQBUT6",217,0)
 . . S SIEN=0,SPIECE=$S(SNODE=4:2,SNODE=5:1,SNODE=6:2) F  S SIEN=$O(^MAG(FNUM,IEN,SNODE,SIEN)) Q:'SIEN  D
"RTN","MAGQBUT6",218,0)
 . . . S (VALUE,TMP)=$P($G(^MAG(FNUM,IEN,SNODE,SIEN,0)),U,SPIECE)
"RTN","MAGQBUT6",219,0)
 . . . S VALUE=$$FRP(VALUE,.LIST) I VALUE D
"RTN","MAGQBUT6",220,0)
 . . . . I SNODE=4,FNUM=2005 S SUB=2005.0106
"RTN","MAGQBUT6",221,0)
 . . . . I SNODE=4,FNUM=2005.1 S SUB=2005.1106
"RTN","MAGQBUT6",222,0)
 . . . . I SNODE=5,FNUM=2005 S SUB=2005.01
"RTN","MAGQBUT6",223,0)
 . . . . I SNODE=5,FNUM=2005.1 S SUB=2005.11
"RTN","MAGQBUT6",224,0)
 . . . . I SNODE=6,FNUM=2005 S SUB=2005.0111
"RTN","MAGQBUT6",225,0)
 . . . . I SNODE=6,FNUM=2005.1 S SUB=2005.1111
"RTN","MAGQBUT6",226,0)
 . . . . S IENS=SIEN_","_IEN_","
"RTN","MAGQBUT6",227,0)
 . . . . S FDA(SUB,IENS,FLDAR(SUB,0,SPIECE))=VALUE
"RTN","MAGQBUT6",228,0)
 . . . . D FILE^DIE("I","FDA","MSG")
"RTN","MAGQBUT6",229,0)
 . . . . I $D(MSG("DIERR")) D  Q
"RTN","MAGQBUT6",230,0)
 . . . . . D PMSG($S(FNUM=2005:"Image File",1:"Image Archive")_" Filing Error for IEN: "_IEN_MSG("DIERR",1,"TEXT",1)) K FDA,MSG
"RTN","MAGQBUT6",231,0)
 . . . . . Q
"RTN","MAGQBUT6",232,0)
 . . . . S TEXT=SUB_" FIELD #"_FLDAR(SUB,0,SPIECE)_" value: "_TMP_" changed to: "_VALUE
"RTN","MAGQBUT6",233,0)
 . . . . S ^XTMP("MAGP39","IMAGEFILE",FNUM,IEN,SUB_$G(FLDAR(SUB,0,SPIECE)))=TEXT
"RTN","MAGQBUT6",234,0)
 . . . . Q
"RTN","MAGQBUT6",235,0)
 . . . Q
"RTN","MAGQBUT6",236,0)
 . . Q
"RTN","MAGQBUT6",237,0)
 . S ^XTMP("MAGP39","DUPSHARE","LAST")=IEN
"RTN","MAGQBUT6",238,0)
 . Q
"RTN","MAGQBUT6",239,0)
 Q
"RTN","MAGQBUT6",240,0)
FRP(IEN,LIST) ;Find entry number in list and return the primary
"RTN","MAGQBUT6",241,0)
 N EN,PN,PC
"RTN","MAGQBUT6",242,0)
 S EN="",PN=0 F  S EN=$O(LIST(EN)) Q:EN=""  D  Q:PN
"RTN","MAGQBUT6",243,0)
 . I (U_$P(LIST(EN),U,2,99)_U)[(U_IEN_U) S PN=$P(LIST(EN),U)
"RTN","MAGQBUT6",244,0)
 . Q
"RTN","MAGQBUT6",245,0)
 Q PN
"RTN","MAGQBUT6",246,0)
PMSG(TXT) ; Display to Screen and Build E-MAIL content
"RTN","MAGQBUT6",247,0)
 D DFNIQ^MAGQBPG1("",TXT,0,PLACE,"Consolidate Shares")
"RTN","MAGQBUT6",248,0)
 Q
"RTN","MAGQBUT6",249,0)
FAR(FLDAR) ; Setup File/Node/Piece Table for FieldNumbers
"RTN","MAGQBUT6",250,0)
 S FLDAR(2006.1,0,3)=.03
"RTN","MAGQBUT6",251,0)
 S FLDAR(2006.1,0,7)=.07
"RTN","MAGQBUT6",252,0)
 S FLDAR(2006.1,0,8)=.08
"RTN","MAGQBUT6",253,0)
 S FLDAR(2006.1,1,6)=2.01
"RTN","MAGQBUT6",254,0)
 S FLDAR(2006.1,"PACS",2)=1.02
"RTN","MAGQBUT6",255,0)
 S FLDAR(2006.1,"PACS",3)=1.03
"RTN","MAGQBUT6",256,0)
 S FLDAR(2006.1,"NET",3)=52
"RTN","MAGQBUT6",257,0)
 S FLDAR(2006.1,"NET",4)=53
"RTN","MAGQBUT6",258,0)
 S FLDAR(2006.1,"NET",5)=55
"RTN","MAGQBUT6",259,0)
 S FLDAR(2005,0,3)=2
"RTN","MAGQBUT6",260,0)
 S FLDAR(2005,0,4)=2.1
"RTN","MAGQBUT6",261,0)
 S FLDAR(2005,0,5)=2.2
"RTN","MAGQBUT6",262,0)
 S FLDAR(2005,"FBIG",1)=102
"RTN","MAGQBUT6",263,0)
 S FLDAR(2005,"FBIG",2)=103
"RTN","MAGQBUT6",264,0)
 S FLDAR(2005.1,0,3)=2
"RTN","MAGQBUT6",265,0)
 S FLDAR(2005.1,0,4)=2.1
"RTN","MAGQBUT6",266,0)
 S FLDAR(2005.1,0,5)=2.2
"RTN","MAGQBUT6",267,0)
 S FLDAR(2005.1,"FBIG",1)=102
"RTN","MAGQBUT6",268,0)
 S FLDAR(2005.1,"FBIG",2)=103
"RTN","MAGQBUT6",269,0)
 S FLDAR(2005.0106,0,2)=2
"RTN","MAGQBUT6",270,0)
 S FLDAR(2005.1106,0,2)=2
"RTN","MAGQBUT6",271,0)
 S FLDAR(2005.01,0,1)=.01
"RTN","MAGQBUT6",272,0)
 S FLDAR(2005.11,0,1)=.01
"RTN","MAGQBUT6",273,0)
 S FLDAR(2005.0111,0,2)=2
"RTN","MAGQBUT6",274,0)
 S FLDAR(2005.1111,0,2)=2
"RTN","MAGQBUT6",275,0)
 Q
"RTN","MAGQBUT6",276,0)
RTRS ;Check to see if any network locations are routers & send an email
"RTN","MAGQBUT6",277,0)
 N EN,IEN,IENS,NLIST,PRIME,RTR,SITE
"RTN","MAGQBUT6",278,0)
 D GETRL^MAGQBU6A(.NLIST) S PLACE=$O(^MAG(2006.1,"B",$$KSP^XUPARAM("INST"),""))
"RTN","MAGQBUT6",279,0)
 S EN=$O(NLIST("")) I EN="" Q  ;No duplicate network locations.
"RTN","MAGQBUT6",280,0)
 S (RTR,EN)="" F  S EN=$O(NLIST(EN)) Q:EN=""  F PC=2:1:$L(NLIST(EN),U) D
"RTN","MAGQBUT6",281,0)
 . I $P(^MAG(2005.2,+$P(NLIST(EN),U,PC),0),U,9) S RTR(EN)=$G(NLIST(EN)) Q
"RTN","MAGQBUT6",282,0)
 . Q
"RTN","MAGQBUT6",283,0)
 S EN=$O(RTR("")) I EN="" Q  ;No duplicate router network locations.
"RTN","MAGQBUT6",284,0)
 D RMSG S EN="" F  S EN=$O(RTR(EN)) Q:EN=""  D 
"RTN","MAGQBUT6",285,0)
 . S IEN=$P(RTR(EN),U),PRIME=$P(^MAG(2005.2,+IEN,0),U),SITE=$P(^MAG(2005.2,+IEN,0),U,10)
"RTN","MAGQBUT6",286,0)
 . D PMSG("Prime entry is IEN:"_IEN_" Name: "_PRIME_" "_$P(^MAG(2005.2,+IEN,0),U,2)_" SITE: "_$P(^MAG(2006.1,+SITE,0),U))
"RTN","MAGQBUT6",287,0)
 . D PMSG("  Duplicate entries that are marked for deletion: ") F PC=2:1:$L(RTR(EN),U) D
"RTN","MAGQBUT6",288,0)
 . . D PMSG("   IEN: "_+$P(RTR(EN),U,PC)_" Name: "_$P(^MAG(2005.2,+$P(RTR(EN),"^",PC),0),U))
"RTN","MAGQBUT6",289,0)
 . . Q
"RTN","MAGQBUT6",290,0)
 . Q
"RTN","MAGQBUT6",291,0)
 D:$G(PRIME)]"" DFNIQ^MAGQBPG1("","Installation: Possible Duplicate Router Shares",1,PLACE,"Consolidate Shares")
"RTN","MAGQBUT6",292,0)
 Q
"RTN","MAGQBUT6",293,0)
RMSG ;
"RTN","MAGQBUT6",294,0)
 D PMSG("The following entries may be defined as 'ROUTERS'.")
"RTN","MAGQBUT6",295,0)
 D PMSG("Review the ROUTE.DIC file on each Routing DICOM Gateway")
"RTN","MAGQBUT6",296,0)
 D PMSG("and replace any duplicate entries with prime entries.")
"RTN","MAGQBUT6",297,0)
 D PMSG("======================================================================")
"RTN","MAGQBUT6",298,0)
 Q
"RTN","MAGQCBP")
0^5^B120470319
"RTN","MAGQCBP",1,0)
MAGQCBP ;WOIFO/RP,JSL - Background Processor Queue Processor Monitor ; 28 JUL 2014 3:25 PM
"RTN","MAGQCBP",2,0)
 ;;3.0;IMAGING;**39,154**;Mar 19, 2002;Build 9;JUL 28, 2014
"RTN","MAGQCBP",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQCBP",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQCBP",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQCBP",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQCBP",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQCBP",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQCBP",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQCBP",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQCBP",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQCBP",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQCBP",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQCBP",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQCBP",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQCBP",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQCBP",17,0)
 ;;
"RTN","MAGQCBP",18,0)
 Q
"RTN","MAGQCBP",19,0)
 ; This Code evaluates whether the last queue processed or the queuing of the next queue is the later event
"RTN","MAGQCBP",20,0)
 ; So if and only if there is a queue waiting to be processed and that queue has been clear to be processed
"RTN","MAGQCBP",21,0)
 ; for a period of 15 minutes then and only then would a message event be triggered (See message event BPMSG)
"RTN","MAGQCBP",22,0)
CBP(MIN) ;Entry point for job to check the BP queue processing activity
"RTN","MAGQCBP",23,0)
 ; I Suggest 15 minutes as a reasonably sensitive value; value is site configurable
"RTN","MAGQCBP",24,0)
 ; An additional alert has been added for failed queues over 1K
"RTN","MAGQCBP",25,0)
 N DATA,FQLIM,LASTDT,LQP,NQ,NQP,QU,SPAN,PL,WS,WSNAME
"RTN","MAGQCBP",26,0)
 ;Variable  MAGEVAL, MAGMIN & FQLIM are site configurable when scheduling the task.
"RTN","MAGQCBP",27,0)
 S FQLIM=$S(+$G(MAGFQ)>0:MAGFQ,1:1000) ;T23 was setting to 1k if MAGFQ was less than 1k
"RTN","MAGQCBP",28,0)
 S MIN=$S(+$G(MAGMIN)>0:MAGMIN,1:+$G(MIN))
"RTN","MAGQCBP",29,0)
 S MAGEVAL=$S(+$G(MAGEVAL)>0:MAGEVAL,1:10000) ;this variable will be used for reviewing EVAL queues
"RTN","MAGQCBP",30,0)
 S U="^",PL=0
"RTN","MAGQCBP",31,0)
 F  S PL=$O(^MAG(2006.1,PL)) Q:'PL  D
"RTN","MAGQCBP",32,0)
 . S WS=0,WSNAME=""
"RTN","MAGQCBP",33,0)
 . F  S WSNAME=$O(^MAG(2006.8,"C",PL,WSNAME)) Q:WSNAME=""  D
"RTN","MAGQCBP",34,0)
 . . S WS=$O(^MAG(2006.8,"C",PL,WSNAME,"")) Q:'WS
"RTN","MAGQCBP",35,0)
 . . ; quit if this bp has not been active today - removed because we only report on active BP Servers
"RTN","MAGQCBP",36,0)
 . . ;Q:$P($P($G(^MAG(2006.8,WS,1)),U,5),"@",1)'=$P($$FMTE^XLFDT($$NOW^XLFDT),"@",1)
"RTN","MAGQCBP",37,0)
 . . S NQP=$$NQP(WS,PL,.NQ),RETURN=0
"RTN","MAGQCBP",38,0)
 . . I NQP>0 D
"RTN","MAGQCBP",39,0)
 . . . Q:WSNAME="Unassigned Tasks"
"RTN","MAGQCBP",40,0)
 . . . S LQP=$$LQP(WS,PL)
"RTN","MAGQCBP",41,0)
 . . . S SPAN=$S(LQP>NQP:LQP,1:NQP)
"RTN","MAGQCBP",42,0)
 . . . D CNT(NQ,PL,.RETURN) ; get counts for message.
"RTN","MAGQCBP",43,0)
 . . . I $$NOW^XLFDT>$$FMADD^XLFDT(SPAN,"","",MIN,"") D BPMSG(PL,WSNAME,MIN,NQ,LQP,NQP,RETURN)
"RTN","MAGQCBP",44,0)
 . . . Q
"RTN","MAGQCBP",45,0)
 . . Q
"RTN","MAGQCBP",46,0)
 . D:+PL FAILQ(PL,FQLIM)
"RTN","MAGQCBP",47,0)
 . D:+PL EVALQ(PL,MAGEVAL)
"RTN","MAGQCBP",48,0)
 . D:+PL CAUTO(PL) ; check for scheduled Purge and Verifier
"RTN","MAGQCBP",49,0)
 . D:+PL CISU(PL)  ; check for active Imaging Site Usage task 
"RTN","MAGQCBP",50,0)
 . Q
"RTN","MAGQCBP",51,0)
 K MAGEVAL,MAGMIN,MAGFQ   ;Variables passed from scheduled task
"RTN","MAGQCBP",52,0)
 Q
"RTN","MAGQCBP",53,0)
LQP(WS,PLACE) ; Returns the date and time of the Last Queue Processed by this BP Server
"RTN","MAGQCBP",54,0)
 N LDATE,QI,QP,TDATE,ZNODE,QUE,QSTR
"RTN","MAGQCBP",55,0)
 S QSTR="^^^^^^^^^^^^ABSTRACT^JUKEBOX^JBTOHD^PREFET^IMPORT^GCC^^^^^DELETE^"
"RTN","MAGQCBP",56,0)
 S ZNODE=$G(^MAG(2006.8,WS,0))
"RTN","MAGQCBP",57,0)
 S LDATE=0
"RTN","MAGQCBP",58,0)
 ;Priority:  JBTOHD, PREFET, ABSTRACT, IMPORT JUKEBOX, DELETE and GCC
"RTN","MAGQCBP",59,0)
 F QI=15,16,13,17,14,23,18 D:$P(ZNODE,U,QI)
"RTN","MAGQCBP",60,0)
 . S QUE=$P(QSTR,U,QI)
"RTN","MAGQCBP",61,0)
 . S QP=$O(^MAGQUEUE(2006.031,"C",PLACE,QUE,"")) Q:'QP
"RTN","MAGQCBP",62,0)
 . S TDATE=$P($G(^MAGQUEUE(2006.031,QP,0)),U,6)
"RTN","MAGQCBP",63,0)
 . I TDATE>LDATE S LDATE=TDATE
"RTN","MAGQCBP",64,0)
 . Q
"RTN","MAGQCBP",65,0)
 Q LDATE
"RTN","MAGQCBP",66,0)
NQP(WS,PLACE,NQ) ; Returns the date and time that the next queue to be processed by this BP Server was queued
"RTN","MAGQCBP",67,0)
 N LDATE,QCNT,QI,QP,TDATE,ZNODE,QUEIEN
"RTN","MAGQCBP",68,0)
 S QSTR="^^^^^^^^^^^^ABSTRACT^JUKEBOX^JBTOHD^PREFET^IMPORT^GCC^^^^^DELETE^"
"RTN","MAGQCBP",69,0)
 S ZNODE=$G(^MAG(2006.8,WS,0))
"RTN","MAGQCBP",70,0)
 S TDATE=0
"RTN","MAGQCBP",71,0)
 ;Priority:  JBTOHD, PREFET, ABSTRACT, IMPORT JUKEBOX, DELETE and GCC
"RTN","MAGQCBP",72,0)
 F QI=15,16,13,17,14,23,18 Q:'QI  I $P(ZNODE,U,QI) D  Q:TDATE>0
"RTN","MAGQCBP",73,0)
 . S NQ=$P(QSTR,U,QI)
"RTN","MAGQCBP",74,0)
 . S QP=$O(^MAGQUEUE(2006.031,"C",PLACE,NQ,"")) Q:'QP
"RTN","MAGQCBP",75,0)
 . Q:'+$P(^MAGQUEUE(2006.031,QP,0),U,3)  ; Queue count - no entries 
"RTN","MAGQCBP",76,0)
 . I +$P(^MAGQUEUE(2006.031,QP,0),U,3) D   ;Queue count
"RTN","MAGQCBP",77,0)
 . . S QUEIEN=$P($G(^MAGQUEUE(2006.031,QP,0)),U,2)
"RTN","MAGQCBP",78,0)
 . . S TDATE=$P($G(^MAGQUEUE(2006.03,QP,0)),U,4)
"RTN","MAGQCBP",79,0)
 . . I '+TDATE S TDATE=$$NQENTRY(NQ,PLACE)
"RTN","MAGQCBP",80,0)
 . . ;above line is needed - if queien value doesn't exist in the 2006.03
"RTN","MAGQCBP",81,0)
 . . ;then get the next entry using x-ref "D","NOT_Processed" for queue type.
"RTN","MAGQCBP",82,0)
 . Q
"RTN","MAGQCBP",83,0)
 Q TDATE
"RTN","MAGQCBP",84,0)
BPMSG(PLACE,WS,MIN,NQ,LASTDT,NQDATE,DATA) ;
"RTN","MAGQCBP",85,0)
 N MSG,TMP,SITE
"RTN","MAGQCBP",86,0)
 S MSG="VistA Imaging BP Server, "_WS_", has failed to process"
"RTN","MAGQCBP",87,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PLACE,"MAGQCBP")
"RTN","MAGQCBP",88,0)
 S MSG="a "_NQ_" queue within "_MIN_" minutes."
"RTN","MAGQCBP",89,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PLACE,"MAGQCBP")
"RTN","MAGQCBP",90,0)
 S MSG="The last date/time a queue was processed was on: "_$$FMTE^XLFDT(LASTDT,1)
"RTN","MAGQCBP",91,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PLACE,"MAGQCBP")
"RTN","MAGQCBP",92,0)
 S MSG="The next queue to process was created on: "_$$FMTE^XLFDT(NQDATE,1)
"RTN","MAGQCBP",93,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PLACE,"MAGQCBP")
"RTN","MAGQCBP",94,0)
 S MSG="Total "_NQ_" queues is: "_$P(DATA,U,2)_"."
"RTN","MAGQCBP",95,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PLACE,"MAGQCBP")
"RTN","MAGQCBP",96,0)
 S SITE=$P($G(^MAG(2006.1,PLACE,0)),U,1) S:(SITE'="") SITE=$$LKUP^XUAF4(SITE) ;Get Division #
"RTN","MAGQCBP",97,0)
 S TMP=$$GET1^DIQ(4,SITE,.01,"E")
"RTN","MAGQCBP",98,0)
 S MSG="This BP Queue processor was supporting the VI implementation serving: "_TMP_"."
"RTN","MAGQCBP",99,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PLACE,"MAGQCBP")
"RTN","MAGQCBP",100,0)
 S MSG="VI_BP_Queue_Processor_failure"
"RTN","MAGQCBP",101,0)
 D DFNIQ^MAGQBPG1("",MSG,1,PLACE,"MAGQCBP")
"RTN","MAGQCBP",102,0)
 Q
"RTN","MAGQCBP",103,0)
BMSGF(PLACE,WS,NQ,DATA) ;
"RTN","MAGQCBP",104,0)
 N MSG,TMP,SITE
"RTN","MAGQCBP",105,0)
 ;DATA=FAILQUECNT_U_QUEUE CNT_U_TOTAL QUE TYPE
"RTN","MAGQCBP",106,0)
 S MSG="VistA Imaging BP Server "_WS_" has "_NQ_" failed queues ("_$P(DATA,U)_")."
"RTN","MAGQCBP",107,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PLACE,"MAGQCBP")
"RTN","MAGQCBP",108,0)
 S MSG="Please review this BP server activity."
"RTN","MAGQCBP",109,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PLACE,"MAGQCBP")
"RTN","MAGQCBP",110,0)
 S MSG="The last date/time this queue was processed was on: "_$$FMTE^XLFDT($P(DATA,U,4))_"."
"RTN","MAGQCBP",111,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PLACE,"MAGQCBP")
"RTN","MAGQCBP",112,0)
 S SITE=$P($G(^MAG(2006.1,PLACE,0)),U,1) S:(SITE'="") SITE=$$LKUP^XUAF4(SITE) ;Get Division #
"RTN","MAGQCBP",113,0)
 S TMP=$$GET1^DIQ(4,SITE,.01,"E") ;IA fix
"RTN","MAGQCBP",114,0)
 S MSG="This BP Queue processor was supporting the VI implementation serving: "_TMP
"RTN","MAGQCBP",115,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PLACE,"MAGQCBP")
"RTN","MAGQCBP",116,0)
 S MSG="VI_BP_Queue_Processor_failure"
"RTN","MAGQCBP",117,0)
 D DFNIQ^MAGQBPG1("",MSG,1,PLACE,"MAGQCBP")
"RTN","MAGQCBP",118,0)
 Q
"RTN","MAGQCBP",119,0)
CAUTO(PLACE) ;
"RTN","MAGQCBP",120,0)
 N ASSIGN,BPPURGE,BPTIME,BPVER,MSG,NODE5,TMP,AUTO,SITE
"RTN","MAGQCBP",121,0)
 S BPPURGE=$G(^MAG(2006.1,PLACE,"BPPURGE")),BPTIME=0
"RTN","MAGQCBP",122,0)
 S ASSIGN=$$GTASK(PLACE,3),ASSIGN=$S(ASSIGN["is not currently assigned":0,1:1)
"RTN","MAGQCBP",123,0)
 ; ASSIGN is a flag whether the AUTO PURGE task has been assigned to a BP Server. 
"RTN","MAGQCBP",124,0)
 I +$P(BPPURGE,U,6),+ASSIGN D  ; If Scheduled is ON (#62.5) and assigned to a BP Server.
"RTN","MAGQCBP",125,0)
 . ; Add 20 min to schedule time to compensate the BP to perform MAGQ FS CHNGE.
"RTN","MAGQCBP",126,0)
 . S BPTIME=$P(BPPURGE,U,10)_"."_$P(BPPURGE,U,11) Q:'+BPTIME  S BPTIME=$$FMADD^XLFDT(BPTIME,"","",21)
"RTN","MAGQCBP",127,0)
 . Q:($$NOW^XLFDT)<BPTIME
"RTN","MAGQCBP",128,0)
 . ;DATE OF SCHEDULED PURGE (#61.3) & SCHEDULED PURGE TIME (#61.4) of SITE PARAMETERS (2006.1)
"RTN","MAGQCBP",129,0)
 . I ($$NOW^XLFDT)>BPTIME D  ;2006.1 
"RTN","MAGQCBP",130,0)
 . . Q:($P(BPPURGE,U,7)=$P(BPPURGE,U,10))    ; DATE OF LAST PURGE (#61.1) & DATE OF SCHEDULED PURGE (#61.3) of SITE PARAMETERS 2006.1 - Purge active
"RTN","MAGQCBP",131,0)
 . . S SITE=$P($G(^MAG(2006.1,PLACE,0)),U,1) S:(SITE'="") SITE=$$LKUP^XUAF4(SITE) ;Get Division #
"RTN","MAGQCBP",132,0)
 . . S TMP=$$GET1^DIQ(4,SITE,.01,"E")
"RTN","MAGQCBP",133,0)
 . . S MSG="The "_TMP_" implementation of VistA Imaging has failed to start the schedule Purge activity!"
"RTN","MAGQCBP",134,0)
 . . D DFNIQ^MAGQBPG1("",MSG,0,PLACE,"MAGQCBP")
"RTN","MAGQCBP",135,0)
 . . S MSG="The task is currently assigned to BP Server: "_$$GTASK(PLACE,3)  ;AUTO PURGE is assigned to BP Server field #3
"RTN","MAGQCBP",136,0)
 . . D DFNIQ^MAGQBPG1("",MSG,0,PLACE,"MAGQCBP")
"RTN","MAGQCBP",137,0)
 . . S MSG="Scheduled_Purge_failure"
"RTN","MAGQCBP",138,0)
 . . D DFNIQ^MAGQBPG1("",MSG,1,PLACE,"MAGQCBP") ; Send
"RTN","MAGQCBP",139,0)
 . . Q
"RTN","MAGQCBP",140,0)
 . Q
"RTN","MAGQCBP",141,0)
 S BPVER=$G(^MAG(2006.1,PLACE,"BPVERIFIER")),BPTIME=0
"RTN","MAGQCBP",142,0)
 S ASSIGN=$$GTASK(PLACE,4),ASSIGN=$S(ASSIGN["is not currently assigned":0,1:1)
"RTN","MAGQCBP",143,0)
 I $P(BPVER,U,1),+ASSIGN D    ; If Scheduled Verifier is ON (#62) and assigned to a BP Server ;
"RTN","MAGQCBP",144,0)
 . ; DATE OF SCHEDULED VERIFY (#62.3) & SCHEDULED VERIFIER TIME (62.4) of SITE PARAMETERS 2006.1
"RTN","MAGQCBP",145,0)
 . ; Add 20 min to schedule time to compensate the BP to perform MAGQ FS CHNGE.
"RTN","MAGQCBP",146,0)
 . S BPTIME=($P(BPVER,U,4)_"."_$P(BPVER,U,5)) Q:'+BPTIME  S BPTIME=$$FMADD^XLFDT(BPTIME,"","",21)
"RTN","MAGQCBP",147,0)
 . Q:($$NOW^XLFDT)<BPTIME
"RTN","MAGQCBP",148,0)
 . I ($$NOW^XLFDT)>BPTIME D
"RTN","MAGQCBP",149,0)
 . . ;Quit if the verifier has already processed.
"RTN","MAGQCBP",150,0)
 . . Q:($P(BPVER,U,2)=$P(BPVER,U,4))  ; DATE OF LAST VERIFY (#62.1) & DATE OF SCHEDULED VERIFY (#62.3) - Verifier is active
"RTN","MAGQCBP",151,0)
 . . S SITE=$P($G(^MAG(2006.1,PLACE,0)),U,1) S:(SITE'="") SITE=$$LKUP^XUAF4(SITE) ;Get Division #
"RTN","MAGQCBP",152,0)
 . . S TMP=$$GET1^DIQ(4,SITE,.01,"E")
"RTN","MAGQCBP",153,0)
 . . S MSG="The "_TMP_" implementation of VistA Imaging has failed to start the schedule Verifier activity!"
"RTN","MAGQCBP",154,0)
 . . D DFNIQ^MAGQBPG1("",MSG,0,PLACE,"MAGQCBP")
"RTN","MAGQCBP",155,0)
 . . S MSG="The task is currently assigned to BP Server: "_$$GTASK(PLACE,4)  ;AUTO VERIFY is assigned to BP Server field #3
"RTN","MAGQCBP",156,0)
 . . D DFNIQ^MAGQBPG1("",MSG,0,PLACE,"MAGQCBP")
"RTN","MAGQCBP",157,0)
 . . S MSG="Scheduled_Verifier_failure"
"RTN","MAGQCBP",158,0)
 . . D DFNIQ^MAGQBPG1("",MSG,1,PLACE,"MAGQCBP") ; Send
"RTN","MAGQCBP",159,0)
 . . Q
"RTN","MAGQCBP",160,0)
 . Q
"RTN","MAGQCBP",161,0)
 Q
"RTN","MAGQCBP",162,0)
GTASK(PLACE,TASK) ;
"RTN","MAGQCBP",163,0)
 ;AUTO PURGE(3), AUTO VERIFY(4), ABSTRACT(12), JUKEBOX(13), JBTOHD(14), PREFET(15), IMPORT(16), GCC(17), DELETE(20) 
"RTN","MAGQCBP",164,0)
 N MAGFLD,IEN,WS,ASSIGNED,WSIEN
"RTN","MAGQCBP",165,0)
 S ASSIGNED=0
"RTN","MAGQCBP",166,0)
 D FIELD^DID(2006.8,TASK,"","LABEL","MAGFLD")
"RTN","MAGQCBP",167,0)
 S WS="" F  S WS=$O(^MAG(2006.8,"C",PLACE,WS)) Q:WS=""  D  Q:ASSIGNED
"RTN","MAGQCBP",168,0)
 . Q:($$UPPER^MAGQE4(WS)="UNASSIGNED TASKS")
"RTN","MAGQCBP",169,0)
 . S WSIEN=$O(^MAG(2006.8,"C",PLACE,WS,""))
"RTN","MAGQCBP",170,0)
 . S ASSIGNED=+$$GET1^DIQ(2006.8,WSIEN_",",TASK,"I","","")
"RTN","MAGQCBP",171,0)
 . Q
"RTN","MAGQCBP",172,0)
 I 'ASSIGNED Q $G(MAGFLD("LABEL"))_" is not currently assigned"
"RTN","MAGQCBP",173,0)
 Q WS
"RTN","MAGQCBP",174,0)
CISU(PLACE) ;
"RTN","MAGQCBP",175,0)
 N ZTSK,ACTIVE,MESSAGE
"RTN","MAGQCBP",176,0)
 Q:'+PLACE
"RTN","MAGQCBP",177,0)
 S ACTIVE=0,MESSAGE="Unknown"
"RTN","MAGQCBP",178,0)
 S ZTSK=$$GET1^DIQ(2006.1,PLACE_",",10,"I","","")
"RTN","MAGQCBP",179,0)
 I ZTSK D
"RTN","MAGQCBP",180,0)
 . D STAT^%ZTLOAD ; IA#10063
"RTN","MAGQCBP",181,0)
 . I ZTSK(0)=1,ZTSK(1)<3 S ACTIVE=1
"RTN","MAGQCBP",182,0)
 . S MESSAGE=ZTSK(2)
"RTN","MAGQCBP",183,0)
 . I $$UPPER^MAGQE4(MESSAGE)="UNDEFINED" S MESSAGE="Task is undefined"
"RTN","MAGQCBP",184,0)
 . Q
"RTN","MAGQCBP",185,0)
 Q:+ACTIVE
"RTN","MAGQCBP",186,0)
 ;else START A NEW TASK,SEND A MESSAGE
"RTN","MAGQCBP",187,0)
 D STTASK^MAGQE4
"RTN","MAGQCBP",188,0)
 D DFNIQ^MAGQBPG1("","The inactive monthly Imaging Site Usage report task was restarted",0,PLACE,"MAGQCBP")
"RTN","MAGQCBP",189,0)
 D DFNIQ^MAGQBPG1("","The problem was: "_MESSAGE,0,PLACE,"MAGQCBP")
"RTN","MAGQCBP",190,0)
 D DFNIQ^MAGQBPG1("","Site_report_task_was_restarted",1,PLACE,"MAGQCBP") ; Send
"RTN","MAGQCBP",191,0)
 K ZTSK
"RTN","MAGQCBP",192,0)
 Q
"RTN","MAGQCBP",193,0)
CNT(QUE,PL,RET) ; Return the number of failed queues, queue pointer, queue type total count and last date processed.
"RTN","MAGQCBP",194,0)
 ; failed queues= queue count - total queue type count.
"RTN","MAGQCBP",195,0)
 ;^MAGQUEUE(2006.031,D0,0)= (#.01) QUEUE NAME [1F] ^ (#1) QUEUE POINTER
"RTN","MAGQCBP",196,0)
 ;                     ==>[2P:2006.03] ^ (#2) QUEUE COUNT [3N] ^ (#.04) PLACE
"RTN","MAGQCBP",197,0)
 ;                     ==>[4P:2006.1] ^ (#3) QUEUE TYPE TOTAL [5N] ^ (#4)
"RTN","MAGQCBP",198,0)
 ;                     ==>LAST_QUEUE_PROCESSED_DATE_TIME [6D] ^
"RTN","MAGQCBP",199,0)
 N QP,FAIL,QTOTAL,QCNT S RET=0
"RTN","MAGQCBP",200,0)
 Q:QUE=""!('PL)
"RTN","MAGQCBP",201,0)
 Q:'$D(^MAGQUEUE(2006.031,"C",PL,QUE))
"RTN","MAGQCBP",202,0)
 S QP=$O(^MAGQUEUE(2006.031,"C",PL,QUE,"")) Q:'QP!'$D(^MAGQUEUE(2006.031,QP))
"RTN","MAGQCBP",203,0)
 S QCNT=$P($G(^MAGQUEUE(2006.031,+QP,0)),U,3),QTOTAL=$P($G(^MAGQUEUE(2006.031,+QP,0)),U,5)
"RTN","MAGQCBP",204,0)
 S FAIL=(+QTOTAL)-(+QCNT),RET=FAIL_U_QCNT_U_QTOTAL_U_$P($G(^MAGQUEUE(2006.031,+QP,0)),U,6)
"RTN","MAGQCBP",205,0)
 Q
"RTN","MAGQCBP",206,0)
NQENTRY(NQ,PLACE) ;
"RTN","MAGQCBP",207,0)
 ;Get the date the queue entry was entered into 2006.03 file.
"RTN","MAGQCBP",208,0)
 N I
"RTN","MAGQCBP",209,0)
 Q:NQ=""!'PLACE
"RTN","MAGQCBP",210,0)
 S I=$O(^MAGQUEUE(2006.03,"D",PLACE,NQ,"NOT_PROCESSED",""))
"RTN","MAGQCBP",211,0)
 I +I,$D(^MAGQUEUE(2006.03,I,0)) Q $P(^MAGQUEUE(2006.03,I,0),U,4)
"RTN","MAGQCBP",212,0)
 Q 0
"RTN","MAGQCBP",213,0)
FAILQ(PLACE,FQLIM) ;
"RTN","MAGQCBP",214,0)
 N QU,RETURN,FAILQ,BPSERV
"RTN","MAGQCBP",215,0)
 F QU="JUKEBOX","ABSTRACT","IMPORT","JBTOHD","DELETE","GCC" D
"RTN","MAGQCBP",216,0)
 . D CNT(QU,PLACE,.RETURN)
"RTN","MAGQCBP",217,0)
 . S FAILQ=$S(+$P(RETURN,U)>+FQLIM:1,1:0),BPSERV="("_$$GTASK(PLACE,QU)_")"
"RTN","MAGQCBP",218,0)
 . ;send msg if failed queues are greater then specified value.
"RTN","MAGQCBP",219,0)
 . D:+FAILQ BMSGF(PLACE,BPSERV,QU,RETURN)
"RTN","MAGQCBP",220,0)
 . Q
"RTN","MAGQCBP",221,0)
EVALQ(PL,QLIM) ;
"RTN","MAGQCBP",222,0)
 N RETURN,MSG
"RTN","MAGQCBP",223,0)
 D CNT("EVAL",PL,.RETURN)
"RTN","MAGQCBP",224,0)
 S QCNT=$P(RETURN,U,2)
"RTN","MAGQCBP",225,0)
 Q:QCNT'>QLIM
"RTN","MAGQCBP",226,0)
 S MSG="The total number of EVAL queues is "_QCNT_".  Please review the DICOM Gateways"
"RTN","MAGQCBP",227,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PL,"MAGQCBP")
"RTN","MAGQCBP",228,0)
 S MSG="to ensure Routing is appropriately setup with the correct destination."
"RTN","MAGQCBP",229,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PL,"MAGQCBP")
"RTN","MAGQCBP",230,0)
 S MSG="If your site is not using DICOM Gateway for Routing then review "
"RTN","MAGQCBP",231,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PL,"MAGQCBP")
"RTN","MAGQCBP",232,0)
 S MSG="the Imaging DICOM Gateway Installation Guide, Section 4.3."
"RTN","MAGQCBP",233,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PL,"MAGQCBP"),BLNKLN
"RTN","MAGQCBP",234,0)
 S MSG="On-Demand Routing will not generate EVAL queues, if your site is doing"
"RTN","MAGQCBP",235,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PL,"MAGQCBP")
"RTN","MAGQCBP",236,0)
 S MSG="only On-Demand Routing then the DICOM Gateway parameters are set incorrectly."
"RTN","MAGQCBP",237,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PL,"MAGQCBP"),BLNKLN
"RTN","MAGQCBP",238,0)
 S MSG="Check the following DICOM parameters on all your Gateways:"
"RTN","MAGQCBP",239,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PL,"MAGQCBP")
"RTN","MAGQCBP",240,0)
 S MSG="(On-Demand routing does not require these parameters to be set.)"
"RTN","MAGQCBP",241,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PL,"MAGQCBP"),BLNKLN
"RTN","MAGQCBP",242,0)
 S MSG="Will this computer be a Routing Processor? // NO "
"RTN","MAGQCBP",243,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PL,"MAGQCBP")
"RTN","MAGQCBP",244,0)
 S MSG="Will this computer be part of a system where 'autorouting' is active? // NO "
"RTN","MAGQCBP",245,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PL,"MAGQCBP")
"RTN","MAGQCBP",246,0)
 S MSG="VI_BP_Eval_Queue"
"RTN","MAGQCBP",247,0)
 D DFNIQ^MAGQBPG1("",MSG,1,PL,"MAGQCBP")
"RTN","MAGQCBP",248,0)
 Q
"RTN","MAGQCBP",249,0)
BLNKLN ;
"RTN","MAGQCBP",250,0)
 S MSG="               "
"RTN","MAGQCBP",251,0)
 D DFNIQ^MAGQBPG1("",MSG,0,PL,"MAGQCBP")
"RTN","MAGQCBP",252,0)
 Q
"VER")
8.0^22.0
"^DD",2005.2,2005.2,2,0)
TOTAL SPACE^NJ14,0^^0;3^K:+X'=X!(X>99999999999999)!(X<0)!(X?.E1"."1.N) X
"^DD",2005.2,2005.2,2,3)
Type a number between 0 and 99999999999999, 0 decimal digits.
"^DD",2005.2,2005.2,2,21,0)
^.001^6^6^3100308^^^^
"^DD",2005.2,2005.2,2,21,1,0)
This is the total available formatted space of this network location. 
"^DD",2005.2,2005.2,2,21,2,0)
 
"^DD",2005.2,2005.2,2,21,3,0)
The information in this field is dependent on the connectivity of the 
"^DD",2005.2,2005.2,2,21,4,0)
share and may be set to zero if the share is not available. 
"^DD",2005.2,2005.2,2,21,5,0)
 
"^DD",2005.2,2005.2,2,21,6,0)
This field is maintained by the RPC MAGQ FS CHNGE.
"^DD",2005.2,2005.2,2,"DT")
3140728
"^DD",2005.2,2005.2,3,0)
SPACE USED^NJ14,0^^0;4^K:+X'=X!(X>99999999999999)!(X<0)!(X?.E1"."1.N) X
"^DD",2005.2,2005.2,3,3)
Type a number between 0 and 99999999999999, 0 decimal digits.
"^DD",2005.2,2005.2,3,21,0)
^^2^2^2990301^^^^
"^DD",2005.2,2005.2,3,21,1,0)
This is the amount of space which has been used for this network location
"^DD",2005.2,2005.2,3,21,2,0)
- this value is device dependent.
"^DD",2005.2,2005.2,3,"DT")
3140728
"^DD",2005.2,2005.2,4,0)
FREE SPACE^NJ14,0^^0;5^K:+X'=X!(X>99999999999999)!(X<0)!(X?.E1"."1.N) X
"^DD",2005.2,2005.2,4,3)
Type a number between 0 and 99999999999999, 0 decimal digits.
"^DD",2005.2,2005.2,4,21,0)
^.001^4^4^3100308^^^^
"^DD",2005.2,2005.2,4,21,1,0)
This is the amount of available space remaining for this network
"^DD",2005.2,2005.2,4,21,2,0)
location. The information in this field is dependent on the 
"^DD",2005.2,2005.2,4,21,3,0)
connectivity of the share and may be set to zero if the share is
"^DD",2005.2,2005.2,4,21,4,0)
not available. This field is maintained by the RPC MAGQ FS CHNGE.
"^DD",2005.2,2005.2,4,"DT")
3140728
"^DD",2006.1,2006.1,60.5,0)
RAID PURGE FACTOR^NJ5,1^^BPPURGE;8^K:+X'=X!(X>100)!(X<0)!(X?.E1"."2N.N) X
"^DD",2006.1,2006.1,60.5,3)
Type a number between 0 and 100, 1 decimal digit.
"^DD",2006.1,2006.1,60.5,21,0)
^^6^6^3140721^
"^DD",2006.1,2006.1,60.5,21,1,0)
This factor (a number between 0 and 100), when multiplied by 
"^DD",2006.1,2006.1,60.5,21,2,0)
the Percent Server Reserve (#11), determines the automatic 
"^DD",2006.1,2006.1,60.5,21,3,0)
purge event triggered by the BP Queue Processor.
"^DD",2006.1,2006.1,60.5,21,4,0)
 
"^DD",2006.1,2006.1,60.5,21,5,0)
The RPC, MAGQ FS CHNGE, uses this value and is part of the
"^DD",2006.1,2006.1,60.5,21,6,0)
automatic Purge algorithm.
"^DD",2006.1,2006.1,60.5,"DT")
3140721
**END**
**END**
