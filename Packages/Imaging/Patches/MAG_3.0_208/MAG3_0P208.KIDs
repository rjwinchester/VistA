KIDS Distribution saved on Sep 25, 2018@09:53:17
CP - DICOM Interoperability
**KIDS**:MAG*3.0*208^

**INSTALL NAME**
MAG*3.0*208
"BLD",9159,0)
MAG*3.0*208^IMAGING^0^3180925^y
"BLD",9159,1,0)
^^15^15^3180416^
"BLD",9159,1,1,0)
Clinical Procedures and DICOM Consult Request Tracking.
"BLD",9159,1,2,0)
 
"BLD",9159,1,3,0)
This patch and MD*1.0*60 work together to greatly imnprove
"BLD",9159,1,4,0)
interoperability between Clinical Procedures and Vist Imaging
"BLD",9159,1,5,0)
CPRS Consult Request Tracking DICOM.
"BLD",9159,1,6,0)
 
"BLD",9159,1,7,0)
The CP studies have the same Instrument Order Number as the
"BLD",9159,1,8,0)
regular consult and procedure Accession Number (sss-GMR-nnnnnnnn).
"BLD",9159,1,9,0)
 
"BLD",9159,1,10,0)
This allows DICOM objects created during a CP examination to be sent
"BLD",9159,1,11,0)
to VistA Imaging and be processed automatically.  It also allows them
"BLD",9159,1,12,0)
to be used with all of the other DICOM services, like query/retrieve
"BLD",9159,1,13,0)
and export.
"BLD",9159,1,14,0)
 
"BLD",9159,1,15,0)
Reports in DICOM Encapsulated PDF are highly recommended.
"BLD",9159,4,0)
^9.64PA^^
"BLD",9159,6.3)
6
"BLD",9159,"INIT")
POS^MAGIP208
"BLD",9159,"KRN",0)
^9.67PA^779.2^20
"BLD",9159,"KRN",.4,0)
.4
"BLD",9159,"KRN",.401,0)
.401
"BLD",9159,"KRN",.402,0)
.402
"BLD",9159,"KRN",.403,0)
.403
"BLD",9159,"KRN",.5,0)
.5
"BLD",9159,"KRN",.84,0)
.84
"BLD",9159,"KRN",3.6,0)
3.6
"BLD",9159,"KRN",3.8,0)
3.8
"BLD",9159,"KRN",9.2,0)
9.2
"BLD",9159,"KRN",9.8,0)
9.8
"BLD",9159,"KRN",9.8,"NM",0)
^9.68A^10^10
"BLD",9159,"KRN",9.8,"NM",1,0)
MAGDHOW1^^0^B30512294
"BLD",9159,"KRN",9.8,"NM",2,0)
MAGDHOW2^^0^B54180158
"BLD",9159,"KRN",9.8,"NM",3,0)
MAGDHOW3^^0^B35060585
"BLD",9159,"KRN",9.8,"NM",4,0)
MAGDHOW4^^0^B34588912
"BLD",9159,"KRN",9.8,"NM",5,0)
MAGDHOWC^^0^B38002639
"BLD",9159,"KRN",9.8,"NM",6,0)
MAGDHOWP^^0^B23921465
"BLD",9159,"KRN",9.8,"NM",7,0)
MAGDHOWS^^0^B16478502
"BLD",9159,"KRN",9.8,"NM",8,0)
MAGIP208^^0^B6562598
"BLD",9159,"KRN",9.8,"NM",9,0)
MAGDHLS^^0^B83963360
"BLD",9159,"KRN",9.8,"NM",10,0)
MAGDHPS^^0^B70563563
"BLD",9159,"KRN",9.8,"NM","B","MAGDHLS",9)

"BLD",9159,"KRN",9.8,"NM","B","MAGDHOW1",1)

"BLD",9159,"KRN",9.8,"NM","B","MAGDHOW2",2)

"BLD",9159,"KRN",9.8,"NM","B","MAGDHOW3",3)

"BLD",9159,"KRN",9.8,"NM","B","MAGDHOW4",4)

"BLD",9159,"KRN",9.8,"NM","B","MAGDHOWC",5)

"BLD",9159,"KRN",9.8,"NM","B","MAGDHOWP",6)

"BLD",9159,"KRN",9.8,"NM","B","MAGDHOWS",7)

"BLD",9159,"KRN",9.8,"NM","B","MAGDHPS",10)

"BLD",9159,"KRN",9.8,"NM","B","MAGIP208",8)

"BLD",9159,"KRN",19,0)
19
"BLD",9159,"KRN",19,"NM",0)
^9.68A^^
"BLD",9159,"KRN",19.1,0)
19.1
"BLD",9159,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",9159,"KRN",101,0)
101
"BLD",9159,"KRN",409.61,0)
409.61
"BLD",9159,"KRN",771,0)
771
"BLD",9159,"KRN",779.2,0)
779.2
"BLD",9159,"KRN",870,0)
870
"BLD",9159,"KRN",8989.51,0)
8989.51
"BLD",9159,"KRN",8989.52,0)
8989.52
"BLD",9159,"KRN",8994,0)
8994
"BLD",9159,"KRN","B",.4,.4)

"BLD",9159,"KRN","B",.401,.401)

"BLD",9159,"KRN","B",.402,.402)

"BLD",9159,"KRN","B",.403,.403)

"BLD",9159,"KRN","B",.5,.5)

"BLD",9159,"KRN","B",.84,.84)

"BLD",9159,"KRN","B",3.6,3.6)

"BLD",9159,"KRN","B",3.8,3.8)

"BLD",9159,"KRN","B",9.2,9.2)

"BLD",9159,"KRN","B",9.8,9.8)

"BLD",9159,"KRN","B",19,19)

"BLD",9159,"KRN","B",19.1,19.1)

"BLD",9159,"KRN","B",101,101)

"BLD",9159,"KRN","B",409.61,409.61)

"BLD",9159,"KRN","B",771,771)

"BLD",9159,"KRN","B",779.2,779.2)

"BLD",9159,"KRN","B",870,870)

"BLD",9159,"KRN","B",8989.51,8989.51)

"BLD",9159,"KRN","B",8989.52,8989.52)

"BLD",9159,"KRN","B",8994,8994)

"BLD",9159,"PRE")
MAGIP208
"BLD",9159,"QUES",0)
^9.62^^
"BLD",9159,"REQB",0)
^9.611^4^4
"BLD",9159,"REQB",1,0)
MAG*3.0*174^2
"BLD",9159,"REQB",2,0)
MAG*3.0*180^2
"BLD",9159,"REQB",3,0)
MAG*3.0*183^2
"BLD",9159,"REQB",4,0)
MAG*3.0*210^2
"BLD",9159,"REQB","B","MAG*3.0*174",1)

"BLD",9159,"REQB","B","MAG*3.0*180",2)

"BLD",9159,"REQB","B","MAG*3.0*183",3)

"BLD",9159,"REQB","B","MAG*3.0*210",4)

"INIT")
POS^MAGIP208
"MBREQ")
0
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging-V1 to release 
"PKG",454,20,0)
^9.402P^^
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020319^3020517^126
"PKG",454,22,1,"PAH",1,0)
208^3180925^126
"PKG",454,22,1,"PAH",1,1,0)
^^15^15^3180925
"PKG",454,22,1,"PAH",1,1,1,0)
Clinical Procedures and DICOM Consult Request Tracking.
"PKG",454,22,1,"PAH",1,1,2,0)
 
"PKG",454,22,1,"PAH",1,1,3,0)
This patch and MD*1.0*60 work together to greatly imnprove
"PKG",454,22,1,"PAH",1,1,4,0)
interoperability between Clinical Procedures and Vist Imaging
"PKG",454,22,1,"PAH",1,1,5,0)
CPRS Consult Request Tracking DICOM.
"PKG",454,22,1,"PAH",1,1,6,0)
 
"PKG",454,22,1,"PAH",1,1,7,0)
The CP studies have the same Instrument Order Number as the
"PKG",454,22,1,"PAH",1,1,8,0)
regular consult and procedure Accession Number (sss-GMR-nnnnnnnn).
"PKG",454,22,1,"PAH",1,1,9,0)
 
"PKG",454,22,1,"PAH",1,1,10,0)
This allows DICOM objects created during a CP examination to be sent
"PKG",454,22,1,"PAH",1,1,11,0)
to VistA Imaging and be processed automatically.  It also allows them
"PKG",454,22,1,"PAH",1,1,12,0)
to be used with all of the other DICOM services, like query/retrieve
"PKG",454,22,1,"PAH",1,1,13,0)
and export.
"PKG",454,22,1,"PAH",1,1,14,0)
 
"PKG",454,22,1,"PAH",1,1,15,0)
Reports in DICOM Encapsulated PDF are highly recommended.
"PRE")
MAGIP208
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","MAGDHLS")
0^9^B83963360
"RTN","MAGDHLS",1,0)
MAGDHLS ;WOIFO/MLH/JSL/SAF/PMK - IHE-based ADT interface for PACS - segments ;13 Sep 2018 3:55 PM
"RTN","MAGDHLS",2,0)
 ;;3.0;IMAGING;**49,123,141,138,183,208**;Mar 19, 2002;Build 6;Sep 03, 2013
"RTN","MAGDHLS",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHLS",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLS",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHLS",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHLS",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHLS",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHLS",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHLS",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHLS",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHLS",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHLS",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHLS",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHLS",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHLS",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLS",17,0)
 ;;
"RTN","MAGDHLS",18,0)
 ; Supported IA #928 reference ACTIVE^GMPLUTL subroutine call
"RTN","MAGDHLS",19,0)
 ; Supported IA #10099 reference EN1^GMRADPT subroutine call
"RTN","MAGDHLS",20,0)
 ; Supported IA #2710 reference ^MPIF001 function calls ($$ISIHS,$$GETICN,$$IFOCAL)
"RTN","MAGDHLS",21,0)
 ; Supported IA #10061 reference ^VADPT subroutine calls (DEM,IN5,PID)
"RTN","MAGDHLS",22,0)
 ; Supported IA #263 reference $$EN^VAFHLPID  function call
"RTN","MAGDHLS",23,0)
 ; Supported IA #10103 reference $$FMTHL7^XLFDT function call
"RTN","MAGDHLS",24,0)
 ;
"RTN","MAGDHLS",25,0)
 Q
"RTN","MAGDHLS",26,0)
 ;
"RTN","MAGDHLS",27,0)
 ; It is always expected that the HL7 environment variables will have
"RTN","MAGDHLS",28,0)
 ; been initialized by a call to INIT^HLFNC2 for the appropriate event
"RTN","MAGDHLS",29,0)
 ; driver protocol.
"RTN","MAGDHLS",30,0)
 ;
"RTN","MAGDHLS",31,0)
AL1(XDFN,XYMSG) ; patient allergies
"RTN","MAGDHLS",32,0)
 ; input:  XDFN      internal entry number of the patient on global ^DPT
"RTN","MAGDHLS",33,0)
 ;         XYMSG     name of array to which to add message elts
"RTN","MAGDHLS",34,0)
 ; output: @XYMSG    input array plus new subtree containing EVN elts
"RTN","MAGDHLS",35,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",36,0)
 ;
"RTN","MAGDHLS",37,0)
 N DFN ; ------ internal entry number on ^DPT
"RTN","MAGDHLS",38,0)
 N GMRAL ;----- return allergy array from EN1^GMRADPT
"RTN","MAGDHLS",39,0)
 N IXAL ; ----- allergy index (on GMRAL array)
"RTN","MAGDHLS",40,0)
 N SETID ; ---- index of the AL1 segment on this message
"RTN","MAGDHLS",41,0)
 N ALDTA ; ---- allergy data
"RTN","MAGDHLS",42,0)
 N IXREAC ; --- reaction index
"RTN","MAGDHLS",43,0)
 N REPIX ; ---- field repetition index
"RTN","MAGDHLS",44,0)
 N VA,VADPT ; - return arrays from DEM^VADPT containing patient demographics
"RTN","MAGDHLS",45,0)
 ;
"RTN","MAGDHLS",46,0)
 D DEM^VADPT
"RTN","MAGDHLS",47,0)
 ;
"RTN","MAGDHLS",48,0)
 K YSEGA
"RTN","MAGDHLS",49,0)
 S DFN=XDFN D EN1^GMRADPT ; get patient's allergies
"RTN","MAGDHLS",50,0)
 S IXAL=0
"RTN","MAGDHLS",51,0)
 F SETID=1:1 S IXAL=$O(GMRAL(IXAL)) Q:'IXAL  D
"RTN","MAGDHLS",52,0)
 . S ALDTA=$G(GMRAL(IXAL))
"RTN","MAGDHLS",53,0)
 . S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",54,0)
 . S @XYMSG@(SEGIX,0)="AL1"
"RTN","MAGDHLS",55,0)
 . S @XYMSG@(SEGIX,1,1,1,1)=SETID
"RTN","MAGDHLS",56,0)
 . S @XYMSG@(SEGIX,2,1,1,1)=$P(ALDTA,U,7) ; type
"RTN","MAGDHLS",57,0)
 . S @XYMSG@(SEGIX,3,1,2,1)=$P(ALDTA,U,2) ; description
"RTN","MAGDHLS",58,0)
 . S IXREAC=0
"RTN","MAGDHLS",59,0)
 . F REPIX=1:1 S IXREAC=$O(GMRAL(IXAL,"S",IXREAC)) Q:'IXREAC  D
"RTN","MAGDHLS",60,0)
 . . S @XYMSG@(SEGIX,5,REPIX,1,1)=$P($G(GMRAL(IXAL,"S",IXREAC)),";",1) ; reaction
"RTN","MAGDHLS",61,0)
 . . Q
"RTN","MAGDHLS",62,0)
 . Q
"RTN","MAGDHLS",63,0)
 Q 0
"RTN","MAGDHLS",64,0)
 ;
"RTN","MAGDHLS",65,0)
DG1(XDFN,XYMSG) ; FUNCTION - diagnosis
"RTN","MAGDHLS",66,0)
 ; input:  XDFN      internal entry number of the patient on global ^DPT
"RTN","MAGDHLS",67,0)
 ;         XYMSG     name of array to which to add message elts
"RTN","MAGDHLS",68,0)
 ; output: @XYMSG    input array plus new subtree containing EVN elts
"RTN","MAGDHLS",69,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",70,0)
 ;
"RTN","MAGDHLS",71,0)
 N DFN ; ----- internal entry number on ^DPT
"RTN","MAGDHLS",72,0)
 N VAIP ; ---- inpatient episode data array
"RTN","MAGDHLS",73,0)
 N SETID ; --- segment index for diagnoses
"RTN","MAGDHLS",74,0)
 N APROB ; --- problem list array
"RTN","MAGDHLS",75,0)
 N PROBIX ; -- problem list index
"RTN","MAGDHLS",76,0)
 ;
"RTN","MAGDHLS",77,0)
 S SETID=0 ; segment increment base
"RTN","MAGDHLS",78,0)
 S DFN=XDFN D IN5^VADPT ; get patient's inpatient episode data
"RTN","MAGDHLS",79,0)
 I $G(VAIP(9))'="" D  ; is there a diag assoc'd w/the latest movement?
"RTN","MAGDHLS",80,0)
 . ; yes, populate data for the DG1 segment
"RTN","MAGDHLS",81,0)
 . S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",82,0)
 . S @XYMSG@(SEGIX,0)="DG1" ; segment ID
"RTN","MAGDHLS",83,0)
 . ; populate element leaves
"RTN","MAGDHLS",84,0)
 . S SETID=SETID+1
"RTN","MAGDHLS",85,0)
 . S @XYMSG@(SEGIX,1,1,1,1)=SETID
"RTN","MAGDHLS",86,0)
 . S @XYMSG@(SEGIX,3,1,2,1)=$E(VAIP(9),1,249) ; diagnosis text
"RTN","MAGDHLS",87,0)
 . ; either admitting or working diagnosis
"RTN","MAGDHLS",88,0)
 . S @XYMSG@(SEGIX,6,1,1,1)=$S($P($G(VAIP(2)),"^",1)=1:"A",1:"W")
"RTN","MAGDHLS",89,0)
 . Q
"RTN","MAGDHLS",90,0)
 ;
"RTN","MAGDHLS",91,0)
 ; get patient's active problem list
"RTN","MAGDHLS",92,0)
 D ACTIVE^GMPLUTL(XDFN,.APROB)
"RTN","MAGDHLS",93,0)
 S PROBIX=0
"RTN","MAGDHLS",94,0)
 F  S PROBIX=$O(APROB(PROBIX)) Q:'PROBIX  D
"RTN","MAGDHLS",95,0)
 . S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",96,0)
 . S @XYMSG@(SEGIX,0)="DG1" ; segment ID
"RTN","MAGDHLS",97,0)
 . ; populate element leaves
"RTN","MAGDHLS",98,0)
 . S SETID=SETID+1
"RTN","MAGDHLS",99,0)
 . S @XYMSG@(SEGIX,1,1,1,1)=SETID
"RTN","MAGDHLS",100,0)
 . S @XYMSG@(SEGIX,3,1,2,1)=$E($P(APROB(PROBIX,1),"^",2),1,249) ; problem text
"RTN","MAGDHLS",101,0)
 . S @XYMSG@(SEGIX,6,1,1,1)="W" ; working diagnosis
"RTN","MAGDHLS",102,0)
 . Q
"RTN","MAGDHLS",103,0)
 ;
"RTN","MAGDHLS",104,0)
 Q 0
"RTN","MAGDHLS",105,0)
 ;
"RTN","MAGDHLS",106,0)
EVN(XEVENT,XEVNRDT,XEVNODT,XYMSG) ; FUNCTION - event
"RTN","MAGDHLS",107,0)
 ; input:  XEVENT   trigger event code
"RTN","MAGDHLS",108,0)
 ;         XEVNRDT  date/time the event was recorded (FM format)
"RTN","MAGDHLS",109,0)
 ;         XEVNODT  date/time the event occurred (FM format)
"RTN","MAGDHLS",110,0)
 ;         XYMSG    name of array to which to add message elts
"RTN","MAGDHLS",111,0)
 ; output: @XYMSG   input array plus new subtree containing EVN elts
"RTN","MAGDHLS",112,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",113,0)
 ; 
"RTN","MAGDHLS",114,0)
 N SEGIX ; ---- segment index on @XYMSG
"RTN","MAGDHLS",115,0)
 N STAT ; ----- status return from function calls
"RTN","MAGDHLS",116,0)
 N FLDIX ; ---- field index on @XYMSG
"RTN","MAGDHLS",117,0)
 ;
"RTN","MAGDHLS",118,0)
 S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",119,0)
 S @XYMSG@(SEGIX,0)="EVN"
"RTN","MAGDHLS",120,0)
 ; populate trigger event code and dates into element leaves
"RTN","MAGDHLS",121,0)
 S @XYMSG@(SEGIX,1,1,1,1)=XEVENT
"RTN","MAGDHLS",122,0)
 S @XYMSG@(SEGIX,2,1,1,1)=$$FMTHL7^XLFDT(XEVNRDT)
"RTN","MAGDHLS",123,0)
 S @XYMSG@(SEGIX,6,1,1,1)=$$FMTHL7^XLFDT(XEVNODT)
"RTN","MAGDHLS",124,0)
 F FLDIX=2,6 S STAT=$$STRIP0^MAG7UD($NA(@XYMSG@(SEGIX,FLDIX,1,1,1)))
"RTN","MAGDHLS",125,0)
 Q 0
"RTN","MAGDHLS",126,0)
 ;
"RTN","MAGDHLS",127,0)
MRG(XMRGSSN,XYMSG) ; FUNCTION - update SSN - P183 PMK 3/10/17
"RTN","MAGDHLS",128,0)
 ; input:  XMRGSSN   Previous value of SSN
"RTN","MAGDHLS",129,0)
 ;         XYMSG     name of array to which to add MRG segment
"RTN","MAGDHLS",130,0)
 ; output: @XYMSG    input array plus new subtree containing MRG elts
"RTN","MAGDHLS",131,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",132,0)
 ;         
"RTN","MAGDHLS",133,0)
 N SEGIX ; ---- segment index on @XYMSG
"RTN","MAGDHLS",134,0)
 N STAT ; ----- status return from function calls
"RTN","MAGDHLS",135,0)
 ;
"RTN","MAGDHLS",136,0)
 S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",137,0)
 S @XYMSG@(SEGIX,0)="MRG"
"RTN","MAGDHLS",138,0)
 ; populate SSN info into element leaves
"RTN","MAGDHLS",139,0)
 S @XYMSG@(SEGIX,1,1,1,1)=XMRGSSN
"RTN","MAGDHLS",140,0)
 S @XYMSG@(SEGIX,1,1,4,1)=$S($$ISIHS^MAGSPID():"USIHS",1:"USVHA") ; P123
"RTN","MAGDHLS",141,0)
 S @XYMSG@(SEGIX,1,1,5,1)="NI"
"RTN","MAGDHLS",142,0)
 Q 0
"RTN","MAGDHLS",143,0)
 ;
"RTN","MAGDHLS",144,0)
OBXADT(XDFN,XYMSG) G OBXADT^MAGDHLSO ; FUNCTION - patient height/weight
"RTN","MAGDHLS",145,0)
 ;
"RTN","MAGDHLS",146,0)
PID(XDFN,XYMSG) ; FUNCTION - patient ID/demo
"RTN","MAGDHLS",147,0)
 ; input:  XDFN      internal entry number of the pt on gbl ^DPT
"RTN","MAGDHLS",148,0)
 ;         XYMSG    name of array to which to add message elts
"RTN","MAGDHLS",149,0)
 ; output: @XYMSG    input array plus new subtree containing PID elts
"RTN","MAGDHLS",150,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",151,0)
 ;
"RTN","MAGDHLS",152,0)
 N PIDARY ; --- array for segment to be returned by VistA HL7 fcn
"RTN","MAGDHLS",153,0)
 N HL ; ------- array containing delims, etc. expected by VistA HL7 fcn
"RTN","MAGDHLS",154,0)
 N MSGDMY ; --- dummy array of scalar message lines for parser
"RTN","MAGDHLS",155,0)
 N I ; -------- loop counter
"RTN","MAGDHLS",156,0)
 N IX,IX1,IX2,IX3,IX4 ; dummy indices
"RTN","MAGDHLS",157,0)
 N SEGIX ; ---- segment index on @XYMSG
"RTN","MAGDHLS",158,0)
 N NUL ; ------ null return from called function
"RTN","MAGDHLS",159,0)
 N MSGTREE ; -- tree of message elements to be returned by $$PARSE^MAG7UP
"RTN","MAGDHLS",160,0)
 N STAT ; ----- status return from function calls
"RTN","MAGDHLS",161,0)
 N PTICN ; ---- patient integration control number
"RTN","MAGDHLS",162,0)
 N DFN ; ------ patient internal entry number (needed for VADPT call)
"RTN","MAGDHLS",163,0)
 N VAFPID ; --- overflow array from $$EN^VAFHLPID() ; P141 PMK 5/6/2013
"RTN","MAGDHLS",164,0)
 ;
"RTN","MAGDHLS",165,0)
 S HL("ECH")=HLECH,HL("FS")=HLFS,HL("Q")=HLQ
"RTN","MAGDHLS",166,0)
 ; does pt have a national ICN?
"RTN","MAGDHLS",167,0)
 I $L($T(IFLOCAL^MPIF001)) I $$IFLOCAL^MPIF001(XDFN)'=1 D  ; P123 - ICN is local, not national
"RTN","MAGDHLS",168,0)
 . S PTICN=$$GETICN^MPIF001(XDFN)
"RTN","MAGDHLS",169,0)
 . K:+PTICN<0 PTICN ; no ICN exists
"RTN","MAGDHLS",170,0)
 . Q
"RTN","MAGDHLS",171,0)
 ; build a dummy message including MSH, PID
"RTN","MAGDHLS",172,0)
 ; (MSH required for $$PARSE^MAG7UP to work)
"RTN","MAGDHLS",173,0)
 S MSGDMY(1)="MSH"_HLFS_HLECH
"RTN","MAGDHLS",174,0)
 S MSGDMY(2)=$$EN^VAFHLPID(XDFN,"5,7,8,10BN,11,13,14,19,22B"),IX=0 ; P141 PMK 5/6/2013, P183 PMK 3/9/2017
"RTN","MAGDHLS",175,0)
 ; if the result string is longer than 245, the remaining characters are
"RTN","MAGDHLS",176,0)
 ; returned in VAFPID(n), where n is a sequential number beginning with 1
"RTN","MAGDHLS",177,0)
 F I=1:1 Q:'$D(VAFPID(I))  S MSGDMY(2)=MSGDMY(2)_VAFPID(I) ; P141 PMK 5/6/2013
"RTN","MAGDHLS",178,0)
 S NUL=$$PARSE^MAG7UP("MSGDMY","MSGTREE") ; parse the message
"RTN","MAGDHLS",179,0)
 S DFN=XDFN D PID^VADPT  ;Get patient Identifiers in VA array
"RTN","MAGDHLS",180,0)
 ;
"RTN","MAGDHLS",181,0)
 I $G(CPINVOCATION) K MSGTREE(2,1) S MSGTREE(2,1,1,1,1)=1 ; set PID-1 to 1 for CP compatibility - P208 PMK 4/25/2018
"RTN","MAGDHLS",182,0)
 ;
"RTN","MAGDHLS",183,0)
 ; purge patient identifiers PID-2 thru PID-4
"RTN","MAGDHLS",184,0)
 F IX=2,3,4 K MSGTREE(2,IX)
"RTN","MAGDHLS",185,0)
 ; assign station number-dfn to PID-2
"RTN","MAGDHLS",186,0)
 S MSGTREE(2,2,1,1,1)=$$STATNUMB^MAGDFCNV()_"-"_XDFN
"RTN","MAGDHLS",187,0)
 S MSGTREE(2,2,1,2,1)=""
"RTN","MAGDHLS",188,0)
 S MSGTREE(2,2,1,3,1)=""
"RTN","MAGDHLS",189,0)
 S MSGTREE(2,2,1,4,1)=$S($$ISIHS^MAGSPID():"USIHS",1:"USVHA") ; P123
"RTN","MAGDHLS",190,0)
 S MSGTREE(2,2,1,5,1)="PI"
"RTN","MAGDHLS",191,0)
 ; assign HRN or social security number to PID-3
"RTN","MAGDHLS",192,0)
 S MSGTREE(2,3,1,1,1)=$S($$ISIHS^MAGSPID():VA("PID"),1:$G(MSGTREE(2,19,1,1,1))) ; P123
"RTN","MAGDHLS",193,0)
 S MSGTREE(2,3,1,2,1)=""
"RTN","MAGDHLS",194,0)
 S MSGTREE(2,3,1,3,1)=""
"RTN","MAGDHLS",195,0)
 S MSGTREE(2,3,1,4,1)=$S($$ISIHS^MAGSPID():"USIHS",1:"USVHA") ; P123
"RTN","MAGDHLS",196,0)
 S MSGTREE(2,3,1,5,1)=$S($$ISIHS^MAGSPID():"MR",1:"NI") ; P110
"RTN","MAGDHLS",197,0)
 D:$D(PTICN)  ; use nat'l ICN (if available) as the alternate pt id in PID-4
"RTN","MAGDHLS",198,0)
 . S MSGTREE(2,4,1,1,1)=PTICN
"RTN","MAGDHLS",199,0)
 . S MSGTREE(2,4,1,2,1)="" ; no checksum (included in ICN)
"RTN","MAGDHLS",200,0)
 . S MSGTREE(2,4,1,3,1)="" ; no checksum (included in ICN)
"RTN","MAGDHLS",201,0)
 . S MSGTREE(2,4,1,4,1)=$S($$ISIHS^MAGSPID():"USIHS",1:"USVHA") ; P123
"RTN","MAGDHLS",202,0)
 . S MSGTREE(2,4,1,5,1)="NI"
"RTN","MAGDHLS",203,0)
 . Q
"RTN","MAGDHLS",204,0)
 ; strip suffix, if any, off race and ethnicity codes
"RTN","MAGDHLS",205,0)
 F IX1=10,22 D
"RTN","MAGDHLS",206,0)
 . S IX2="" F  S IX2=$O(MSGTREE(2,IX1,IX2)) Q:IX2=""  D
"RTN","MAGDHLS",207,0)
 . . S:$G(MSGTREE(2,IX1,IX2,1,1))["-" MSGTREE(2,IX1,IX2,1,1)=$P(MSGTREE(2,IX1,IX2,1,1),"-",1,2)
"RTN","MAGDHLS",208,0)
 . . Q
"RTN","MAGDHLS",209,0)
 . Q
"RTN","MAGDHLS",210,0)
 ; insert PID subtree into passed-in element array
"RTN","MAGDHLS",211,0)
 ; this code eliminates values on intermediate (i.e., non-leaf) nodes
"RTN","MAGDHLS",212,0)
 S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",213,0)
 S @XYMSG@(SEGIX,0)="PID" ; segment tag
"RTN","MAGDHLS",214,0)
 S IX1=0 F  S IX1=$O(MSGTREE(2,IX1)) Q:'IX1  D
"RTN","MAGDHLS",215,0)
 . S IX2=0 F  S IX2=$O(MSGTREE(2,IX1,IX2)) Q:'IX2  D
"RTN","MAGDHLS",216,0)
 . . S IX3=0 F  S IX3=$O(MSGTREE(2,IX1,IX2,IX3)) Q:'IX3  D
"RTN","MAGDHLS",217,0)
 . . . S IX4=0 F  S IX4=$O(MSGTREE(2,IX1,IX2,IX3,IX4)) Q:'IX4  D
"RTN","MAGDHLS",218,0)
 . . . . S @XYMSG@(SEGIX,IX1,IX2,IX3,IX4)=MSGTREE(2,IX1,IX2,IX3,IX4)
"RTN","MAGDHLS",219,0)
 . . . . Q
"RTN","MAGDHLS",220,0)
 . . . Q
"RTN","MAGDHLS",221,0)
 . . Q
"RTN","MAGDHLS",222,0)
 . Q
"RTN","MAGDHLS",223,0)
 S STAT=$$STRIP0^MAG7UD($NA(@XYMSG@(SEGIX,7,1,1,1))) ; strip 0's off DOB
"RTN","MAGDHLS",224,0)
 Q 0
"RTN","MAGDHLS",225,0)
 ;
"RTN","MAGDHLS",226,0)
PV1(XDFN,XEVN,XEVNDT,XYMSG) G PV1^MAGDHLSV ; FUNCTION - patient visit
"RTN","MAGDHLS",227,0)
 ;
"RTN","MAGDHLS",228,0)
ROL(XDFN,XYMSG) ; FUNCTION role (for physicians) - propagate from PV1
"RTN","MAGDHLS",229,0)
 ; assumes PV1 segment is already populated
"RTN","MAGDHLS",230,0)
 ; 
"RTN","MAGDHLS",231,0)
 ; input:  XDFN      internal entry number of the pt on gbl ^DPT
"RTN","MAGDHLS",232,0)
 ;         XYMSG    name of array to which to add message elts
"RTN","MAGDHLS",233,0)
 ; output: @XYMSG    input array plus new subtree containing PID elts
"RTN","MAGDHLS",234,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",235,0)
 ;
"RTN","MAGDHLS",236,0)
 N PRCTYP ; -- type of practitioner
"RTN","MAGDHLS",237,0)
 N NUL ; ----- null return from called function
"RTN","MAGDHLS",238,0)
 N SETID ; --- sequential index of ROL seg(s) in this message
"RTN","MAGDHLS",239,0)
 N PV1IX ; --- index of PV1 segment in message array
"RTN","MAGDHLS",240,0)
 N PHYSELT ; - element index of attending / referring physician on PV1 segment
"RTN","MAGDHLS",241,0)
 N I ; ------- scratch loop counter
"RTN","MAGDHLS",242,0)
 ;
"RTN","MAGDHLS",243,0)
 S DFN=XDFN,SETID=0
"RTN","MAGDHLS",244,0)
 S PV1IX="",I=0 F  S I=$O(@XYMSG@(I)) Q:'I  I @XYMSG@(I,0)="PV1" S PV1IX=I Q
"RTN","MAGDHLS",245,0)
 Q:'PV1IX  ; no physicians to propagate
"RTN","MAGDHLS",246,0)
 F PRCTYP="ATT","REF" D
"RTN","MAGDHLS",247,0)
 . S PHYSELT=$S(PRCTYP="ATT":7,1:8) Q:'$D(@XYMSG@(PV1IX,PHYSELT))
"RTN","MAGDHLS",248,0)
 . S SEGIX=$O(@XYMSG@(" "),-1)+1,SETID=SETID+1
"RTN","MAGDHLS",249,0)
 . S @XYMSG@(SEGIX,0)="ROL"
"RTN","MAGDHLS",250,0)
 . S @XYMSG@(SEGIX,1,1,1,1)=SETID
"RTN","MAGDHLS",251,0)
 . S @XYMSG@(SEGIX,2,1,1,1)="UP" ; receiver should always update
"RTN","MAGDHLS",252,0)
 . S @XYMSG@(SEGIX,3,1,1,1)=$S(PRCTYP="ATT":"AT",1:"RP")
"RTN","MAGDHLS",253,0)
 . M @XYMSG@(SEGIX,4)=@XYMSG@(PV1IX,PHYSELT)
"RTN","MAGDHLS",254,0)
 . S NUL=$$NPFON^MAG7UFO($NA(@XYMSG@(SEGIX,12)),$G(@XYMSG@(SEGIX,4,1,1,1)))
"RTN","MAGDHLS",255,0)
 . Q
"RTN","MAGDHLS",256,0)
 Q 0
"RTN","MAGDHOW1")
0^1^B30512294
"RTN","MAGDHOW1",1,0)
MAGDHOW1 ;WOIFO/PMK/DAC - Capture Consult/Procedure Request data ;09 Aug 2018 7:54 AM
"RTN","MAGDHOW1",2,0)
 ;;3.0;IMAGING;**138,174,180,210,208**;Mar 19, 2002;Build 6
"RTN","MAGDHOW1",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHOW1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOW1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHOW1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHOW1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHOW1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHOW1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHOW1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHOW1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHOW1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHOW1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHOW1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHOW1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHOW1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOW1",17,0)
 ;;
"RTN","MAGDHOW1",18,0)
 ;
"RTN","MAGDHOW1",19,0)
 ; Supported IA #10006 reference ^DIC routine call
"RTN","MAGDHOW1",20,0)
 ; Supported IA #2056 reference $$GET1^DIQ function call
"RTN","MAGDHOW1",21,0)
 ; Supported IA #10103 reference $$NOW^XLFDT function call
"RTN","MAGDHOW1",22,0)
 ; Controlled IA #4110 to read REQUEST/CONSULTATION file (#123)
"RTN","MAGDHOW1",23,0)
 ; Supported IA #6925 to read HLO SUBSCRIPTION REGISTRY (#779.4)
"RTN","MAGDHOW1",24,0)
 ; 
"RTN","MAGDHOW1",25,0)
MSGSETUP(GMRCIEN,SERVICE,ORC1,ORC5,APTSCHED) ; called by ^MAGDHOWC and ^MAGDHOWS
"RTN","MAGDHOW1",26,0)
 ; setup to send a message, if required
"RTN","MAGDHOW1",27,0)
 N CONSULT,CPTIEN,DATETIME,DIVISION,FMDATE,FMDATETM
"RTN","MAGDHOW1",28,0)
 N HL7SUBLIST,I,ITYPCODE,ITYPNAME,MSGTYPE,OBXSEGNO
"RTN","MAGDHOW1",29,0)
 N ORCTRL,ORSTATUS,ORIGSERV,PARMS,SEGMENT,SENDIT,X,Y,Z
"RTN","MAGDHOW1",30,0)
 ;
"RTN","MAGDHOW1",31,0)
 S FMDATETM=$$NOW^XLFDT(),FMDATE=FMDATETM\1
"RTN","MAGDHOW1",32,0)
 S MSGTYPE="ORM" ; HL7 message type for orders
"RTN","MAGDHOW1",33,0)
 ;
"RTN","MAGDHOW1",34,0)
 ; decide if service is one that requires HL7->DICOM gateway and PACS
"RTN","MAGDHOW1",35,0)
 ;
"RTN","MAGDHOW1",36,0)
 S SENDIT=$$SERVICE(SERVICE,GMRCIEN,.DIVISION,.ITYPNAME,.ITYPCODE,.CPTIEN,.HL7SUBLIST)
"RTN","MAGDHOW1",37,0)
 ;
"RTN","MAGDHOW1",38,0)
 I SENDIT D  ; send this transaction via HL7 to DICOM gateway and PACS
"RTN","MAGDHOW1",39,0)
 . ; check for an "OK" order control value which indicates a new order
"RTN","MAGDHOW1",40,0)
 . I ORC1="OK" D
"RTN","MAGDHOW1",41,0)
 . . S ORCTRL="NW" ; order control
"RTN","MAGDHOW1",42,0)
 . . S ORSTATUS="IP" ; order status
"RTN","MAGDHOW1",43,0)
 . . Q
"RTN","MAGDHOW1",44,0)
 . ;
"RTN","MAGDHOW1",45,0)
 . ; check for a cancelled or discontinued request
"RTN","MAGDHOW1",46,0)
 . E  I " CA CR DR OC OD "[(" "_ORC1_" ") D
"RTN","MAGDHOW1",47,0)
 . . ; P210 DAC - Instead of Killing FILLER2, it will now be set to cancelled
"RTN","MAGDHOW1",48,0)
 . . S FILLER2="GMRC-CANCELLED"
"RTN","MAGDHOW1",49,0)
 . . S ORCTRL="CA" ; order control
"RTN","MAGDHOW1",50,0)
 . . S ORSTATUS="CA" ; order status
"RTN","MAGDHOW1",51,0)
 . . Q
"RTN","MAGDHOW1",52,0)
 . ;
"RTN","MAGDHOW1",53,0)
 . ; check for scheduled request (set in ^MAGDHOWS)
"RTN","MAGDHOW1",54,0)
 . E  I ORC1="XO",ORC5="SC" D
"RTN","MAGDHOW1",55,0)
 . . S ORCTRL="XO" ; order control
"RTN","MAGDHOW1",56,0)
 . . S ORSTATUS="SC" ; order status
"RTN","MAGDHOW1",57,0)
 . . Q
"RTN","MAGDHOW1",58,0)
 . ;
"RTN","MAGDHOW1",59,0)
 . ; look for a result message
"RTN","MAGDHOW1",60,0)
 . E  I ORC1="RE" D  ; result
"RTN","MAGDHOW1",61,0)
 . . S MSGTYPE="ORU" ; HL7 message type for results
"RTN","MAGDHOW1",62,0)
 . . ;
"RTN","MAGDHOW1",63,0)
 . . I (ORC5="A")!($$UNSIGNED^MAGDGMRC(GMRCIEN)) D  ; P180 DAC - Process unsigned TIU notes
"RTN","MAGDHOW1",64,0)
 . . . S FILLER2="GMRC-NEW UNSIGNED RESULT"
"RTN","MAGDHOW1",65,0)
 . . . S ORCTRL="RE" ; order control
"RTN","MAGDHOW1",66,0)
 . . . S ORSTATUS="A" ; order status
"RTN","MAGDHOW1",67,0)
 . . . Q
"RTN","MAGDHOW1",68,0)
 . . E  D  ; new signed TIU note
"RTN","MAGDHOW1",69,0)
 . . . K FILLER2 ; P174 DAC - remove any preset status like GMRC-SCHEDULED set in CHECKAPT^MAGDHOWC
"RTN","MAGDHOW1",70,0)
 . . . S ORCTRL="RE" ; order control
"RTN","MAGDHOW1",71,0)
 . . . S ORSTATUS="CM" ; order status
"RTN","MAGDHOW1",72,0)
 . . . Q
"RTN","MAGDHOW1",73,0)
 . . Q
"RTN","MAGDHOW1",74,0)
 . ;
"RTN","MAGDHOW1",75,0)
 . E  D  ; default
"RTN","MAGDHOW1",76,0)
 . . S ORCTRL="SC" ; order control
"RTN","MAGDHOW1",77,0)
 . . S ORSTATUS="IP" ; order status
"RTN","MAGDHOW1",78,0)
 . . Q
"RTN","MAGDHOW1",79,0)
 . D MESSAGE^MAGDHOW2(SERVICE)
"RTN","MAGDHOW1",80,0)
 . Q
"RTN","MAGDHOW1",81,0)
 ;
"RTN","MAGDHOW1",82,0)
 I ORC1="RE" D  ; do this for all consult results
"RTN","MAGDHOW1",83,0)
 . ; link any outstanding DICOM images to the new TIU note
"RTN","MAGDHOW1",84,0)
 . S I=$$NEWTIU^MAGDHOW0(GMRCIEN)
"RTN","MAGDHOW1",85,0)
 . Q
"RTN","MAGDHOW1",86,0)
 ;
"RTN","MAGDHOW1",87,0)
 Q
"RTN","MAGDHOW1",88,0)
 ;
"RTN","MAGDHOW1",89,0)
SERVICE(SERVICE,GMRCIEN,DIVISION,ITYPNAME,ITYPCODE,CPTIEN,HL7SUBLIST) ;
"RTN","MAGDHOW1",90,0)
 ; check if the service is in the DICOM Clinical Service dictionary, and
"RTN","MAGDHOW1",91,0)
 ; if so, then get all of the attributes
"RTN","MAGDHOW1",92,0)
 N MWLCONFIG,SENDIT,X,Y,Z
"RTN","MAGDHOW1",93,0)
 S (DIVISION,ITYPNAME,ITYPCODE,CPTIEN,HL7SUBLIST,SENDIT)=0
"RTN","MAGDHOW1",94,0)
 I SERVICE D  ; ignore SERVICE if it is null
"RTN","MAGDHOW1",95,0)
 . S MWLCONFIG=$$MWLFIND(SERVICE,GMRCIEN)
"RTN","MAGDHOW1",96,0)
 . S DIVISION=""
"RTN","MAGDHOW1",97,0)
 . I MWLCONFIG D  ; send order
"RTN","MAGDHOW1",98,0)
 . . S X=$G(^MAG(2006.5831,MWLCONFIG,0))
"RTN","MAGDHOW1",99,0)
 . . S DIVISION=$P(X,"^",5),CPTIEN=$P(X,"^",6),HL7SUBLIST=$P(X,"^",7)
"RTN","MAGDHOW1",100,0)
 . . I HL7SUBLIST,$$GET1^DIQ(779.4,HL7SUBLIST,.01)="" S HL7SUBLIST=0 ; absent
"RTN","MAGDHOW1",101,0)
 . . I 'HL7SUBLIST D  ; lookup default HL7 subscription list
"RTN","MAGDHOW1",102,0)
 . . . N DIC,DO,X,Y
"RTN","MAGDHOW1",103,0)
 . . . S DIC=779.4,DIC(0)="BX",X="MAGD DEFAULT" D ^DIC
"RTN","MAGDHOW1",104,0)
 . . . S HL7SUBLIST=$P(Y,"^",1) ; Y should equal "<ien>^MAGD DEFAULT"
"RTN","MAGDHOW1",105,0)
 . . . Q
"RTN","MAGDHOW1",106,0)
 . . ; get specialty index and procedure index (if available, otherwise, use 0)
"RTN","MAGDHOW1",107,0)
 . . S Y=$P(X,"^",3)
"RTN","MAGDHOW1",108,0)
 . . S ITYPNAME=$P(^MAG(2005.84,Y,0),"^",1)
"RTN","MAGDHOW1",109,0)
 . . S ITYPCODE=$P(^MAG(2005.84,Y,2),"^",1)
"RTN","MAGDHOW1",110,0)
 . . S Z=$P(X,"^",4)
"RTN","MAGDHOW1",111,0)
 . . I Z D  ; get procedure name and code
"RTN","MAGDHOW1",112,0)
 . . . S ITYPNAME=ITYPNAME_" -- "_$P(^MAG(2005.85,Z,0),"^",1)
"RTN","MAGDHOW1",113,0)
 . . . S ITYPCODE=ITYPCODE_"/"_$P(^MAG(2005.85,Z,2),"^",1)
"RTN","MAGDHOW1",114,0)
 . . . Q
"RTN","MAGDHOW1",115,0)
 . . S SENDIT=1
"RTN","MAGDHOW1",116,0)
 . . Q
"RTN","MAGDHOW1",117,0)
 . Q
"RTN","MAGDHOW1",118,0)
 Q SENDIT
"RTN","MAGDHOW1",119,0)
 ;
"RTN","MAGDHOW1",120,0)
MWLFIND(SERVICE,GMRCIEN) ; lookup 2006.5831 entry by service and procedure
"RTN","MAGDHOW1",121,0)
 ; ordering a procedure and the 2006.5831 procedure entry are optional
"RTN","MAGDHOW1",122,0)
 N PROCEDURE
"RTN","MAGDHOW1",123,0)
 S PROCEDURE=+$$GET1^DIQ(123,GMRCIEN,4,"I")
"RTN","MAGDHOW1",124,0)
 Q $$IREQUEST(SERVICE,PROCEDURE) ; pointer to modality worklist dictionary file #2006.5831
"RTN","MAGDHOW1",125,0)
 ;
"RTN","MAGDHOW1",126,0)
IREQUEST(SERVICE,PROCEDURE) ; return the IEN of the consult or procedure for the request service
"RTN","MAGDHOW1",127,0)
 N IEN,LIST
"RTN","MAGDHOW1",128,0)
 ;
"RTN","MAGDHOW1",129,0)
 S SERVICE=$G(SERVICE) I 'SERVICE Q 0
"RTN","MAGDHOW1",130,0)
 ;
"RTN","MAGDHOW1",131,0)
 ; if this is a lookup for a procedure, just return the "C" cross reference
"RTN","MAGDHOW1",132,0)
 S PROCEDURE=$G(PROCEDURE)
"RTN","MAGDHOW1",133,0)
 I PROCEDURE Q $O(^MAG(2006.5831,"C",SERVICE,PROCEDURE,""))
"RTN","MAGDHOW1",134,0)
 ;
"RTN","MAGDHOW1",135,0)
 ; use the "B" cross reference to make a list of all IENs for the request service
"RTN","MAGDHOW1",136,0)
 S IEN="" F  S IEN=$O(^MAG(2006.5831,"B",SERVICE,IEN)) Q:IEN=""  S LIST(IEN)=""
"RTN","MAGDHOW1",137,0)
 ;
"RTN","MAGDHOW1",138,0)
 ; use the "C" cross reference to delete the IENs for the procedures
"RTN","MAGDHOW1",139,0)
 S PROCEDURE="" F  S PROCEDURE=$O(^MAG(2006.5831,"C",SERVICE,PROCEDURE)) Q:PROCEDURE=""  D
"RTN","MAGDHOW1",140,0)
 . S IEN=$O(^MAG(2006.5831,"C",SERVICE,PROCEDURE,""))
"RTN","MAGDHOW1",141,0)
 . K LIST(IEN) ; remove the procedures from the list
"RTN","MAGDHOW1",142,0)
 . Q
"RTN","MAGDHOW1",143,0)
 ;
"RTN","MAGDHOW1",144,0)
 ; return what is left in the list, which should be the consult, if there is one
"RTN","MAGDHOW1",145,0)
 Q $O(LIST(""))
"RTN","MAGDHOW2")
0^2^B54180158
"RTN","MAGDHOW2",1,0)
MAGDHOW2 ;WOIFO/PMK/DAC - Capture Consult/GMRC data ;14 Jun 2018 10:13 AM
"RTN","MAGDHOW2",2,0)
 ;;3.0;IMAGING;**138,156,183,208**;Mar 19, 2002;Build 6;Nov 16, 2014
"RTN","MAGDHOW2",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHOW2",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOW2",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHOW2",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHOW2",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHOW2",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHOW2",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHOW2",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHOW2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHOW2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHOW2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHOW2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHOW2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHOW2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOW2",17,0)
 ;;
"RTN","MAGDHOW2",18,0)
 ;
"RTN","MAGDHOW2",19,0)
 ; Supported IA #2056 reference $$GET1^DIQ function call
"RTN","MAGDHOW2",20,0)
 ; Supported IA #4716 reference ^HLOAPI function calls
"RTN","MAGDHOW2",21,0)
 ; Supported IA #4717 reference ^HLOAPI1 function calls
"RTN","MAGDHOW2",22,0)
 ; Supported IA #5886 reference ^HLOPBLD1 function calls
"RTN","MAGDHOW2",23,0)
 ; Supported IA #6103 reference for reading ^HLA
"RTN","MAGDHOW2",24,0)
 ; Supported IA #6925 to read HLO SUBSCRIPTION REGISTRY (#779.4)
"RTN","MAGDHOW2",25,0)
 ; Supported IA #10103 reference $$DT^XLFDT function call
"RTN","MAGDHOW2",26,0)
 ; Supported IA #10103 reference $$NOW^XLFDT function call
"RTN","MAGDHOW2",27,0)
 ;
"RTN","MAGDHOW2",28,0)
 ;
"RTN","MAGDHOW2",29,0)
MESSAGE(SERVICE) ; invoked from ^MAGDHOW1
"RTN","MAGDHOW2",30,0)
 N CONSULT,ERROR,HL7IEN,HLMSTATE,I,MESSAGES,MSG,NEXT,OBXSEGNO
"RTN","MAGDHOW2",31,0)
 N PRIORITY,SAVEORCSEG,SUCCESS,TIUDOC,X,Y
"RTN","MAGDHOW2",32,0)
 ;
"RTN","MAGDHOW2",33,0)
 ; P156 DAC - Support for HL7 result messages
"RTN","MAGDHOW2",34,0)
 I MSGTYPE="ORM" D  ; order entry message
"RTN","MAGDHOW2",35,0)
 . D INIT(MSGTYPE,"O01") ; start building a new HL7 order entry message
"RTN","MAGDHOW2",36,0)
 . Q
"RTN","MAGDHOW2",37,0)
 E  D  ; result message
"RTN","MAGDHOW2",38,0)
 . D INIT(MSGTYPE,"R01") ; start building a new HL7 result message
"RTN","MAGDHOW2",39,0)
 . Q
"RTN","MAGDHOW2",40,0)
 ;
"RTN","MAGDHOW2",41,0)
 D PIDPV1^MAGDHOW2(.HLMSTATE,DFN)
"RTN","MAGDHOW2",42,0)
 D ORC^MAGDHOW3(.HLMSTATE,GMRCIEN,.SAVEORCSEG)
"RTN","MAGDHOW2",43,0)
 D OBR^MAGDHOW4(.HLMSTATE,GMRCIEN,.SAVEORCSEG,SERVICE)
"RTN","MAGDHOW2",44,0)
 D ZDS^MAGDHOW5(.HLMSTATE,GMRCIEN)
"RTN","MAGDHOW2",45,0)
 D OBX^MAGDHOW5(.HLMSTATE,GMRCIEN)
"RTN","MAGDHOW2",46,0)
 ;
"RTN","MAGDHOW2",47,0)
 ; send the message via subscription list
"RTN","MAGDHOW2",48,0)
 S PARMS("SENDING APPLICATION")="MAGD SENDER"
"RTN","MAGDHOW2",49,0)
 S PARMS("SUBSCRIPTION IEN")=HL7SUBLIST
"RTN","MAGDHOW2",50,0)
 ; the HLO private queue name is the name of the subscription list
"RTN","MAGDHOW2",51,0)
 S PARMS("QUEUE")=$$GET1^DIQ(779.4,HL7SUBLIST,.01) ; private queue
"RTN","MAGDHOW2",52,0)
 S SUCCESS=$$SENDSUB^HLOAPI1(.HLMSTATE,.PARMS,.MESSAGES)
"RTN","MAGDHOW2",53,0)
 I 'SUCCESS D
"RTN","MAGDHOW2",54,0)
 . N MSG,SUBJECT,VARIABLES
"RTN","MAGDHOW2",55,0)
 . S SUBJECT="VistA Imaging Clinical Specialty (CPRS) HL7 Generation"
"RTN","MAGDHOW2",56,0)
 . S MSG(1)="An error occurred in "_$T(+0)_" where the SENDSUB^HLOAPI1"
"RTN","MAGDHOW2",57,0)
 . S MSG(2)="invocation failed.  The error message is as follows:"
"RTN","MAGDHOW2",58,0)
 . S MSG(3)=""""_SUCCESS_""""
"RTN","MAGDHOW2",59,0)
 . S VARIABLES("HLMSTATE")=""
"RTN","MAGDHOW2",60,0)
 . S VARIABLES("PARMS")=""
"RTN","MAGDHOW2",61,0)
 . S VARIABLES("MESSAGES")=""
"RTN","MAGDHOW2",62,0)
 . D ERROR^MAGDHOWA(SUBJECT,.MSG,.VARIABLES)
"RTN","MAGDHOW2",63,0)
 . Q
"RTN","MAGDHOW2",64,0)
 D OUTPUT ; send to DICOM Gateway
"RTN","MAGDHOW2",65,0)
 ;
"RTN","MAGDHOW2",66,0)
 Q
"RTN","MAGDHOW2",67,0)
 ;
"RTN","MAGDHOW2",68,0)
INIT(MSGTYPE,EVENT) ; start building a new HL7 message
"RTN","MAGDHOW2",69,0)
 N ERROR,PARMS,SUCCESS
"RTN","MAGDHOW2",70,0)
 S PARMS("COUNTRY")="USA"
"RTN","MAGDHOW2",71,0)
 S PARMS("CONTINUATION POINTER")=0
"RTN","MAGDHOW2",72,0)
 S PARMS("EVENT")=EVENT
"RTN","MAGDHOW2",73,0)
 S PARMS("FIELD SEPARATOR")="|"
"RTN","MAGDHOW2",74,0)
 S PARMS("ENCODING CHARACTERS")="^~\&"
"RTN","MAGDHOW2",75,0)
 S PARMS("MESSAGE STRUCTURE")=MSGTYPE_"_"_EVENT
"RTN","MAGDHOW2",76,0)
 S PARMS("MESSAGE TYPE")=MSGTYPE
"RTN","MAGDHOW2",77,0)
 S PARMS("PROCESSING MODE")="T"
"RTN","MAGDHOW2",78,0)
 S PARMS("VERSION")=2.4
"RTN","MAGDHOW2",79,0)
 S SUCCESS=$$NEWMSG^HLOAPI(.PARMS,.HLMSTATE,.ERROR)
"RTN","MAGDHOW2",80,0)
 I 'SUCCESS D
"RTN","MAGDHOW2",81,0)
 . N MSG,SUBJECT,VARIABLES
"RTN","MAGDHOW2",82,0)
 . S SUBJECT="VistA Imaging Clinical Specialty (CPRS) HL7 Generation"
"RTN","MAGDHOW2",83,0)
 . S MSG(1)="An error occurred in INIT^"_$T(+0)_" where the NEWMSG^HLOAPI"
"RTN","MAGDHOW2",84,0)
 . S MSG(2)="invocation failed.  The error message is as follows:"
"RTN","MAGDHOW2",85,0)
 . S MSG(3)=""""_SUCCESS_""""
"RTN","MAGDHOW2",86,0)
 . S VARIABLES("PARMS")=""
"RTN","MAGDHOW2",87,0)
 . S VARIABLES("HLMSTATE")=""
"RTN","MAGDHOW2",88,0)
 . S VARIABLES("ERROR")=""
"RTN","MAGDHOW2",89,0)
 . D ERROR^MAGDHOWA(SUBJECT,.MSG,.VARIABLES)
"RTN","MAGDHOW2",90,0)
 . Q
"RTN","MAGDHOW2",91,0)
 Q
"RTN","MAGDHOW2",92,0)
 ;
"RTN","MAGDHOW2",93,0)
PIDPV1(HLMSTATE,DFN) ; build the PID and PV1 segments
"RTN","MAGDHOW2",94,0)
 ; Also invoked by ^MAGT7S to build these segments for Anatomic Pathology - P183 PMK 3/7/17
"RTN","MAGDHOW2",95,0)
 N HL,HL7ARRAY,HL7SEG,HLECH,HLFS,HLQ,NUL,PID,PV1,SUCCESS
"RTN","MAGDHOW2",96,0)
 S HLECH=HLMSTATE("HDR","ENCODING CHARACTERS")
"RTN","MAGDHOW2",97,0)
 S HLFS=HLMSTATE("HDR","FIELD SEPARATOR")
"RTN","MAGDHOW2",98,0)
 S HLQ="""""" ; null fields are set as "", as opposed to being empty
"RTN","MAGDHOW2",99,0)
 S HL7ARRAY(1,9,1,1,1)=""
"RTN","MAGDHOW2",100,0)
 S HL7ARRAY(1,0)="MSH"
"RTN","MAGDHOW2",101,0)
 S HL7ARRAY(1,1,1,1,1)=HLFS
"RTN","MAGDHOW2",102,0)
 S HL7ARRAY(1,2,1,1,1)=HLECH
"RTN","MAGDHOW2",103,0)
 D PID^MAGDHLS(DFN,"HL7ARRAY")
"RTN","MAGDHOW2",104,0)
 D PV1^MAGDHLS(DFN,"",DT,"HL7ARRAY")
"RTN","MAGDHOW2",105,0)
 ;
"RTN","MAGDHOW2",106,0)
 S NUL=$$MAKE^MAG7UM("HL7ARRAY","HL7SEG")
"RTN","MAGDHOW2",107,0)
 S PID=HL7SEG(2)
"RTN","MAGDHOW2",108,0)
 S PV1=HL7SEG(3)
"RTN","MAGDHOW2",109,0)
 S SUCCESS=$$MOVESEG^HLOAPI(.HLMSTATE,PID,.ERROR)
"RTN","MAGDHOW2",110,0)
 I 'SUCCESS D
"RTN","MAGDHOW2",111,0)
 . N MSG,SUBJECT,VARIABLES
"RTN","MAGDHOW2",112,0)
 . S SUBJECT="VistA Imaging Clinical Specialty (CPRS) HL7 Generation"
"RTN","MAGDHOW2",113,0)
 . S MSG(1)="An error occurred in PIDPV1^"_$T(+0)_" where the MOVESEG^HLOAPI invocation"
"RTN","MAGDHOW2",114,0)
 . S MSG(2)="for the PID segment failed.  The error message is as follows:"
"RTN","MAGDHOW2",115,0)
 . S MSG(3)=""""_SUCCESS_""""
"RTN","MAGDHOW2",116,0)
 . S VARIABLES("HLMSTATE")=""
"RTN","MAGDHOW2",117,0)
 . S VARIABLES("PID")=""
"RTN","MAGDHOW2",118,0)
 . S VARIABLES("ERROR")=""
"RTN","MAGDHOW2",119,0)
 . D ERROR^MAGDHOWA(SUBJECT,.MSG,.VARIABLES)
"RTN","MAGDHOW2",120,0)
 . Q
"RTN","MAGDHOW2",121,0)
 S SUCCESS=$$MOVESEG^HLOAPI(.HLMSTATE,PV1,.ERROR)
"RTN","MAGDHOW2",122,0)
 I 'SUCCESS D
"RTN","MAGDHOW2",123,0)
 . N MSG,SUBJECT,VARIABLES
"RTN","MAGDHOW2",124,0)
 . S SUBJECT="VistA Imaging Clinical Specialty (CPRS) HL7 Generation"
"RTN","MAGDHOW2",125,0)
 . S MSG(1)="An error occurred in PIDPV1^"_$T(+0)_" where the MOVESEG^HLOAPI invocation"
"RTN","MAGDHOW2",126,0)
 . S MSG(2)="for the PV1 segment failed.  The error message is as follows:"
"RTN","MAGDHOW2",127,0)
 . S MSG(3)=""""_SUCCESS_""""
"RTN","MAGDHOW2",128,0)
 . S VARIABLES("HLMSTATE")=""
"RTN","MAGDHOW2",129,0)
 . S VARIABLES("PID")=""
"RTN","MAGDHOW2",130,0)
 . S VARIABLES("ERROR")=""
"RTN","MAGDHOW2",131,0)
 . D ERROR^MAGDHOWA(SUBJECT,.MSG,.VARIABLES)
"RTN","MAGDHOW2",132,0)
 . Q
"RTN","MAGDHOW2",133,0)
 Q
"RTN","MAGDHOW2",134,0)
 ;
"RTN","MAGDHOW2",135,0)
OUTPUT ; output the messages to ^MAGDHL7
"RTN","MAGDHOW2",136,0)
 N D0,DEL,FMDATE,FMDATETIME,HLAIEN,HDR,HL7,HL7MSH,I,I1,I2,J,K,MSG,N,X,Y,Z
"RTN","MAGDHOW2",137,0)
 S HLAIEN=HLMSTATE("BODY")
"RTN","MAGDHOW2",138,0)
 ;
"RTN","MAGDHOW2",139,0)
 ; build the MSH segment
"RTN","MAGDHOW2",140,0)
 D BUILDHDR^HLOPBLD1(.HLMSTATE,"MSH",.HL7MSH)
"RTN","MAGDHOW2",141,0)
 ;
"RTN","MAGDHOW2",142,0)
 ; copy the two lines of the MSH segment to the HL7 array
"RTN","MAGDHOW2",143,0)
 S HL7MSH=HL7MSH(1)_HL7MSH(2) ; MSH segment
"RTN","MAGDHOW2",144,0)
 S DEL=HLMSTATE("HDR","FIELD SEPARATOR")
"RTN","MAGDHOW2",145,0)
 S $P(HL7MSH,DEL,5)="MAGD-CONSULT" ; receiving application
"RTN","MAGDHOW2",146,0)
 S $P(HL7MSH,DEL,6)="" ; receiving facility
"RTN","MAGDHOW2",147,0)
 S J=1,HL7(J)=HL7MSH
"RTN","MAGDHOW2",148,0)
 ;
"RTN","MAGDHOW2",149,0)
 ; copy the body of the message to the HL7 array
"RTN","MAGDHOW2",150,0)
 ; some of the message may be in ^HLA(HLAIEN) - if so, get it first
"RTN","MAGDHOW2",151,0)
 ;
"RTN","MAGDHOW2",152,0)
 I HLAIEN D  ; get the segments that are saved in ^HLA(HLAIEN)
"RTN","MAGDHOW2",153,0)
 . ; note: segments are separated by a blank line
"RTN","MAGDHOW2",154,0)
 . S I=0 F  S I=$O(^HLA(HLAIEN,1,I)) Q:I=""  D
"RTN","MAGDHOW2",155,0)
 . . S X=$G(^HLA(HLAIEN,1,I,0))
"RTN","MAGDHOW2",156,0)
 . . I X'="" S J=J+1,HL7(J)=X
"RTN","MAGDHOW2",157,0)
 . . Q
"RTN","MAGDHOW2",158,0)
 . Q
"RTN","MAGDHOW2",159,0)
 ;
"RTN","MAGDHOW2",160,0)
 ; get the remainder of the messages from memory
"RTN","MAGDHOW2",161,0)
 ; note: segments are separated by a blank line
"RTN","MAGDHOW2",162,0)
 S I1=0 F  S I1=$O(HLMSTATE("UNSTORED LINES",1,I1)) Q:I1=""  D
"RTN","MAGDHOW2",163,0)
 . S I2=0 F  S I2=$O(HLMSTATE("UNSTORED LINES",1,I1,I2)) Q:I2=""  D
"RTN","MAGDHOW2",164,0)
 . . S X=HLMSTATE("UNSTORED LINES",1,I1,I2)
"RTN","MAGDHOW2",165,0)
 . . I X'="" S J=J+1,HL7(J)=X
"RTN","MAGDHOW2",166,0)
 . . Q
"RTN","MAGDHOW2",167,0)
 . Q
"RTN","MAGDHOW2",168,0)
 ;
"RTN","MAGDHOW2",169,0)
 S N=J ; number of HL7 record lines
"RTN","MAGDHOW2",170,0)
 S DEL=$E(HL7(1),4) ; field separator
"RTN","MAGDHOW2",171,0)
 S $P(HL7(1),DEL,5,6)="MAGD-CONSULT"_DEL ; receiving application
"RTN","MAGDHOW2",172,0)
 ;
"RTN","MAGDHOW2",173,0)
 ; get the next node in the ^MAGDHL7 global
"RTN","MAGDHOW2",174,0)
 S FMDATETIME=$$NOW^XLFDT,FMDATE=$$DT^XLFDT
"RTN","MAGDHOW2",175,0)
 L +^MAGDHL7(2006.5,0):1E9 ; Background process MUST wait
"RTN","MAGDHOW2",176,0)
 S D0=$O(^MAGDHL7(2006.5," "),-1)+1
"RTN","MAGDHOW2",177,0)
 S ^MAGDHL7(2006.5,D0,0)=FMDATE
"RTN","MAGDHOW2",178,0)
 S:FMDATE'="" ^MAGDHL7(2006.5,"B",FMDATE,D0)=""
"RTN","MAGDHOW2",179,0)
 S HDR=$G(^MAGDHL7(2006.5,0))
"RTN","MAGDHOW2",180,0)
 S ^MAGDHL7(2006.5,0)="PACS MESSAGE^2006.5D^"_D0_"^"_($P(HDR,"^",4)+1)
"RTN","MAGDHOW2",181,0)
 L -^MAGDHL7(2006.5,0)
"RTN","MAGDHOW2",182,0)
 ;
"RTN","MAGDHOW2",183,0)
 ; copy the message to the ^MAGDHL7 global, field by field
"RTN","MAGDHOW2",184,0)
 S ^MAGDHL7(2006.5,D0,0)=FMDATE_"^"_MSGTYPE_"^"_FMDATETIME
"RTN","MAGDHOW2",185,0)
 S (I,J)=0  F I=1:1:N S X=HL7(I) D
"RTN","MAGDHOW2",186,0)
 . S Y=$P(X,DEL)
"RTN","MAGDHOW2",187,0)
 . F K=2:1:$L(X,DEL) D  ; copy the lines to the ^MAGDHL7 global
"RTN","MAGDHOW2",188,0)
 . . S Z=$P(X,DEL,K)
"RTN","MAGDHOW2",189,0)
 . . I ($L(Y)+$L(Z))>200 D  ; keep lines short for the global
"RTN","MAGDHOW2",190,0)
 . . . ; output one line of a spanned record
"RTN","MAGDHOW2",191,0)
 . . . S J=J+1,^MAGDHL7(2006.5,D0,1,J,0)=Y,Y=""
"RTN","MAGDHOW2",192,0)
 . . . Q
"RTN","MAGDHOW2",193,0)
 . . S Y=Y_DEL_$P(X,DEL,K)
"RTN","MAGDHOW2",194,0)
 . . Q
"RTN","MAGDHOW2",195,0)
 . S J=J+1,^MAGDHL7(2006.5,D0,1,J,0)=Y
"RTN","MAGDHOW2",196,0)
 . Q
"RTN","MAGDHOW2",197,0)
 S:FMDATETIME'="" ^MAGDHL7(2006.5,"C",FMDATETIME,D0)="" ; P183 PMK 3/6/17
"RTN","MAGDHOW2",198,0)
 ; The next line must be last, since WAIT^MAGDHRS1
"RTN","MAGDHOW2",199,0)
 ; uses this node to determine that the entry is complete.
"RTN","MAGDHOW2",200,0)
 S ^MAGDHL7(2006.5,D0,1,0)="^^"_J_"^"_J_"^"_FMDATETIME
"RTN","MAGDHOW2",201,0)
 ;
"RTN","MAGDHOW2",202,0)
 I $G(CPINVOCATION) D OUTPUT^MAGDHOWP(N) ; copy HL7 message for clinical procedures - P208 PMK 4/12/18
"RTN","MAGDHOW2",203,0)
 Q
"RTN","MAGDHOW3")
0^3^B35060585
"RTN","MAGDHOW3",1,0)
MAGDHOW3 ;WOIFO/PMK,DWM,DAC,GXT - Capture Consult/GMRC data ;29 May 2018 9:50 AM
"RTN","MAGDHOW3",2,0)
 ;;3.0;IMAGING;**138,180,203,208**;Mar 19, 2002;Build 6
"RTN","MAGDHOW3",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHOW3",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOW3",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHOW3",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHOW3",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHOW3",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHOW3",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHOW3",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHOW3",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHOW3",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHOW3",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHOW3",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHOW3",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHOW3",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOW3",17,0)
 ;;
"RTN","MAGDHOW3",18,0)
 ;
"RTN","MAGDHOW3",19,0)
 ; Supported IA #2051 reference $$FIND1^DIC function call
"RTN","MAGDHOW3",20,0)
 ; Supported IA #2056 reference $$GET1^DIQ function call
"RTN","MAGDHOW3",21,0)
 ; Supported IA #2056 reference GETS^DIQ subroutine call
"RTN","MAGDHOW3",22,0)
 ; Supported IA #4716 reference ^HLOAPI function calls
"RTN","MAGDHOW3",23,0)
 ; Supported IA #10103 reference $$FMTHL7^XLFDT function call
"RTN","MAGDHOW3",24,0)
 ; Supported IA #3065 reference $$HLNAME^XLFNAME function call
"RTN","MAGDHOW3",25,0)
 ; Controlled IA #4110 to read REQUEST/CONSULTATION file (#123)
"RTN","MAGDHOW3",26,0)
 ; Private IA #2698 to read URGENCY FILE (#101.42)
"RTN","MAGDHOW3",27,0)
 ; Supported IA #10060 to read phone numbers from NEW PATIENT file (#200)
"RTN","MAGDHOW3",28,0)
 ;
"RTN","MAGDHOW3",29,0)
ORC(HLMSTATE,GMRCIEN,SAVEORCSEG) ; build the ORC segment (see ORC^GMRCHL7)
"RTN","MAGDHOW3",30,0)
 N ACNUMB,ERROR,ORCSEG,ORDERENTERER,ORDERNUMBER,ORDERPLACER,PRIORITY,SUCCESS,X
"RTN","MAGDHOW3",31,0)
 D SET^HLOAPI(.ORCSEG,"ORC",0)
"RTN","MAGDHOW3",32,0)
 D SET^HLOAPI(.ORCSEG,ORCTRL,1) ; ORC-1 order control
"RTN","MAGDHOW3",33,0)
 S ORDERNUMBER=$$GET1^DIQ(123,GMRCIEN,.03,"I") ; oe/rr file number
"RTN","MAGDHOW3",34,0)
 ; D SET^HLOAPI(.ORCSEG,$$STATNUMB^MAGDFCNV()_"-OR-"_ORDERNUMBER,2) ; ORC-2 placer order number
"RTN","MAGDHOW3",35,0)
 S ACNUMB=$$GMRCACN^MAGDFCNV(GMRCIEN)
"RTN","MAGDHOW3",36,0)
 D SET^HLOAPI(.ORCSEG,ACNUMB,2) ; ORC-2 placer order number (to be compatible with CP) P208 PMK 4/26/18
"RTN","MAGDHOW3",37,0)
 D SET^HLOAPI(.ORCSEG,ACNUMB,3) ; ORC-3 filler order number
"RTN","MAGDHOW3",38,0)
 ;
"RTN","MAGDHOW3",39,0)
 D SET^HLOAPI(.ORCSEG,ORSTATUS,5) ; ORC-5 order status
"RTN","MAGDHOW3",40,0)
 ; ORC-6 not used
"RTN","MAGDHOW3",41,0)
 ;
"RTN","MAGDHOW3",42,0)
 ; store date and time of scheduled appointment for order messages, not results
"RTN","MAGDHOW3",43,0)
 I MSGTYPE="ORM",$D(APTSCHED("FM DATETIME")) D
"RTN","MAGDHOW3",44,0)
 . D SET^HLOAPI(.ORCSEG,$$FMTHL7^XLFDT(APTSCHED("FM DATETIME")),7,4) ; ORC-7 start date/time
"RTN","MAGDHOW3",45,0)
 . Q
"RTN","MAGDHOW3",46,0)
 S PRIORITY=$$GET1^DIQ(123,GMRCIEN,5),PRIORITY=$P(PRIORITY," - ",2) ; urgency
"RTN","MAGDHOW3",47,0)
 S PRIORITY=$S(PRIORITY="EMERGENCY":"STAT",PRIORITY="NOW":"STAT",PRIORITY="OUTPATIENT":"ROUTINE",1:PRIORITY)
"RTN","MAGDHOW3",48,0)
 I PRIORITY'="" D  ; convert to HL7 priority
"RTN","MAGDHOW3",49,0)
 . N URGENCY
"RTN","MAGDHOW3",50,0)
 . S URGENCY=$$FIND1^DIC(101.42,,"B",PRIORITY)
"RTN","MAGDHOW3",51,0)
 . S PRIORITY=$S(URGENCY:$$GET1^DIQ(101.42,URGENCY,2,"E"),1:"")
"RTN","MAGDHOW3",52,0)
 . Q
"RTN","MAGDHOW3",53,0)
 D SET^HLOAPI(.ORCSEG,PRIORITY,7,6) ; ORC-7 priority
"RTN","MAGDHOW3",54,0)
 ; ORC-8 not used
"RTN","MAGDHOW3",55,0)
 D SET^HLOAPI(.ORCSEG,$$FMTHL7^XLFDT(FMDATETM),9) ; ORC-9 date/time of transaction
"RTN","MAGDHOW3",56,0)
 S ORDERENTERER=$$GET1^DIQ(100,ORDERNUMBER,3,"I") ; Order file - who entered
"RTN","MAGDHOW3",57,0)
 D NAME^MAGDHOW3(ORDERENTERER,10,.ORCSEG) ; ORC-10 entered by
"RTN","MAGDHOW3",58,0)
 ; ORC-11 not used
"RTN","MAGDHOW3",59,0)
 S ORDERPLACER=$$GET1^DIQ(123,GMRCIEN,10,"I") ; sending provider
"RTN","MAGDHOW3",60,0)
 D NAME^MAGDHOW3(ORDERPLACER,12,.ORCSEG) ; ORC-12 ordering provider
"RTN","MAGDHOW3",61,0)
 S X=$$GET1^DIQ(200,ORDERENTERER,29) ; service/section
"RTN","MAGDHOW3",62,0)
 D SET^HLOAPI(.ORCSEG,X,13) ; ORC-13 enterer's location
"RTN","MAGDHOW3",63,0)
 D PHONE^MAGDHOW3(ORDERPLACER,14,.ORCSEG) ; ORC-14 call back phone number(s)
"RTN","MAGDHOW3",64,0)
 S X=$$GET1^DIQ(123,GMRCIEN,3,"I") ; date of request
"RTN","MAGDHOW3",65,0)
 D SET^HLOAPI(.ORCSEG,$$FMTHL7^XLFDT(X),15) ; ORC-15 order effective date/time
"RTN","MAGDHOW3",66,0)
 ; ORC-16 not used
"RTN","MAGDHOW3",67,0)
 S X=$$GET1^DIQ(200,ORDERPLACER,29,"I") ; ordering provider's service/section
"RTN","MAGDHOW3",68,0)
 ; entering organization (abbreviation, name, coding system)
"RTN","MAGDHOW3",69,0)
 D SET^HLOAPI(.ORCSEG,$$GET1^DIQ(49,X,1),17,1)
"RTN","MAGDHOW3",70,0)
 D SET^HLOAPI(.ORCSEG,$$GET1^DIQ(49,X,.01),17,2)
"RTN","MAGDHOW3",71,0)
 D SET^HLOAPI(.ORCSEG,"VISTA49",17,3)
"RTN","MAGDHOW3",72,0)
 ;
"RTN","MAGDHOW3",73,0)
 M SAVEORCSEG=ORCSEG ; save some of the ORC fields for the OBR segment
"RTN","MAGDHOW3",74,0)
 S SUCCESS=$$ADDSEG^HLOAPI(.HLMSTATE,.ORCSEG,.ERROR)
"RTN","MAGDHOW3",75,0)
 I 'SUCCESS D
"RTN","MAGDHOW3",76,0)
 . N MSG,SUBJECT,VARIABLES
"RTN","MAGDHOW3",77,0)
 . S SUBJECT="VistA Imaging Clinical Specialty (CPRS) HL7 Generation"
"RTN","MAGDHOW3",78,0)
 . S MSG(1)="An error occurred in ORC^"_$T(+0)_" where the ADDSEG^HLOAPI invocation"
"RTN","MAGDHOW3",79,0)
 . S MSG(2)="for the ORC segment failed.  The error message is as follows:"
"RTN","MAGDHOW3",80,0)
 . S MSG(3)=""""_SUCCESS_""""
"RTN","MAGDHOW3",81,0)
 . S VARIABLES("HLMSTATE")=""
"RTN","MAGDHOW3",82,0)
 . S VARIABLES("ORCSEG")=""
"RTN","MAGDHOW3",83,0)
 . S VARIABLES("ERROR")=""
"RTN","MAGDHOW3",84,0)
 . D ERROR^MAGDHOWA(SUBJECT,.MSG,.VARIABLES)
"RTN","MAGDHOW3",85,0)
 . Q
"RTN","MAGDHOW3",86,0)
 Q
"RTN","MAGDHOW3",87,0)
 ;
"RTN","MAGDHOW3",88,0)
NAME(IEN,FIELD,ORCSEG) ; return person's name in HL7 format
"RTN","MAGDHOW3",89,0)
 N DGNAME,I,X
"RTN","MAGDHOW3",90,0)
 S DGNAME("FILE")=200,DGNAME("IENS")=IEN,DGNAME("FIELD")=.01
"RTN","MAGDHOW3",91,0)
 S X=$$HLNAME^XLFNAME(.DGNAME,"","^")
"RTN","MAGDHOW3",92,0)
 D SET^HLOAPI(.ORCSEG,IEN,FIELD,1)
"RTN","MAGDHOW3",93,0)
 F I=1:1:$L(X,"^") D SET^HLOAPI(.ORCSEG,$P(X,"^",I),FIELD,I+1)
"RTN","MAGDHOW3",94,0)
 Q
"RTN","MAGDHOW3",95,0)
 ;
"RTN","MAGDHOW3",96,0)
PHONE(IEN,FIELD,SEGMENT) ; call back phone number(s)
"RTN","MAGDHOW3",97,0)
 N FNUMBER,EQTYPE,I,MAGOUT,MAGERR,NUMBER,USECODE,X,REP,J,VAIEN,J,NUM
"RTN","MAGDHOW3",98,0)
 I IEN="" Q  ; P203 DAC - Quit if no order placer. Fixes P180 bug.
"RTN","MAGDHOW3",99,0)
 S REP=0 ; HL7 repetition
"RTN","MAGDHOW3",100,0)
 F I=1:1 S X=$T(PHONES+I) Q:"END"[$P(X,";;",2)  D
"RTN","MAGDHOW3",101,0)
 . S FNUMBER=$P(X,";",4),USECODE=$P(X,";",5),EQTYPE=$P(X,";",6)
"RTN","MAGDHOW3",102,0)
 . S NUMBER=$$GET1^DIQ(200,IEN,FNUMBER)
"RTN","MAGDHOW3",103,0)
 . D PHONE1(.REP,FIELD,.SEGMENT,NUMBER,USECODE,EQTYPE)
"RTN","MAGDHOW3",104,0)
 . Q
"RTN","MAGDHOW3",105,0)
 ; check VISITED FROM subfile (#8910) to get PHONE AT SITE field (#5)
"RTN","MAGDHOW3",106,0)
 ; P180 DAC - New MAGOUT array to sort from earliest to latest VISITED FROM entries
"RTN","MAGDHOW3",107,0)
 ; P203 Code changes to use fileman call to sort thur VISITED FROM entries;GXT
"RTN","MAGDHOW3",108,0)
 S J=0
"RTN","MAGDHOW3",109,0)
 D GETS^DIQ(200,IEN_",","8910*","E","MAGOUT","MAGERR")
"RTN","MAGDHOW3",110,0)
 S I="" F  S I=$O(MAGOUT("200.06",I)) Q:I=""  D
"RTN","MAGDHOW3",111,0)
 . S NUM=$P(I,",",1) ; GET IEN NUMBER OF I
"RTN","MAGDHOW3",112,0)
 . I (NUM<=9)&(J<=3) D
"RTN","MAGDHOW3",113,0)
 . . S NUMBER=MAGOUT("200.06",I,5,"E")
"RTN","MAGDHOW3",114,0)
 . . N X,Y S X=NUMBER X ^%ZOSF("UPPERCASE") Q:((Y="NO PHONE")!(Y=""))
"RTN","MAGDHOW3",115,0)
 . . D PHONE1(.REP,FIELD,.SEGMENT,NUMBER,"WPN","PN")
"RTN","MAGDHOW3",116,0)
 . . S J=J+1
"RTN","MAGDHOW3",117,0)
 . . Q
"RTN","MAGDHOW3",118,0)
 . Q
"RTN","MAGDHOW3",119,0)
 I (J>=0)&(J<3) D
"RTN","MAGDHOW3",120,0)
 . S I="" F  S I=$O(MAGOUT("200.06",I)) Q:I=""  D
"RTN","MAGDHOW3",121,0)
 . . S NUM=$P(I,",",1)
"RTN","MAGDHOW3",122,0)
 . . I (NUM>=10)&(J<3) D
"RTN","MAGDHOW3",123,0)
 . . . S NUMBER=MAGOUT("200.06",I,5,"E")
"RTN","MAGDHOW3",124,0)
 . . . N X,Y S X=NUMBER X ^%ZOSF("UPPERCASE") Q:((Y="NO PHONE")!(Y=""))
"RTN","MAGDHOW3",125,0)
 . . . D PHONE1(.REP,FIELD,.SEGMENT,NUMBER,"WPN","PN")
"RTN","MAGDHOW3",126,0)
 . . . S J=J+1
"RTN","MAGDHOW3",127,0)
 . . . Q
"RTN","MAGDHOW3",128,0)
 . . Q
"RTN","MAGDHOW3",129,0)
 . Q
"RTN","MAGDHOW3",130,0)
 Q
"RTN","MAGDHOW3",131,0)
 ;
"RTN","MAGDHOW3",132,0)
PHONE1(REP,FIELD,SEGMENT,NUMBER,USECODE,EQTYPE) ; store phone info
"RTN","MAGDHOW3",133,0)
 I NUMBER'="" D
"RTN","MAGDHOW3",134,0)
 . S REP=REP+1
"RTN","MAGDHOW3",135,0)
 . D SET^HLOAPI(.SEGMENT,NUMBER,FIELD,1,1,REP)
"RTN","MAGDHOW3",136,0)
 . D SET^HLOAPI(.SEGMENT,USECODE,FIELD,2,1,REP)
"RTN","MAGDHOW3",137,0)
 . D SET^HLOAPI(.SEGMENT,EQTYPE,FIELD,3,1,REP)
"RTN","MAGDHOW3",138,0)
 . Q
"RTN","MAGDHOW3",139,0)
 Q
"RTN","MAGDHOW3",140,0)
 ;
"RTN","MAGDHOW3",141,0)
PHONES ;; field name ; field number ; HL7 Use Code ; HL7 Equipment Type
"RTN","MAGDHOW3",142,0)
 ;;PHONE (HOME);.131;PRN;PH
"RTN","MAGDHOW3",143,0)
 ;;OFFICE PHONE;.132;WPN;PH
"RTN","MAGDHOW3",144,0)
 ;;PHONE #3;.133;WPN;PN
"RTN","MAGDHOW3",145,0)
 ;;PHONE #4;.134;WPN;PN
"RTN","MAGDHOW3",146,0)
 ;;COMMERCIAL PHONE;.135;WPN;PN
"RTN","MAGDHOW3",147,0)
 ;;FAX NUMBER;.136;WPN;FX
"RTN","MAGDHOW3",148,0)
 ;;VOICE PAGER;.137;WPN;BP
"RTN","MAGDHOW3",149,0)
 ;;DIGITAL PAGER;.138;BPM;BP
"RTN","MAGDHOW3",150,0)
 ;;END
"RTN","MAGDHOW3",151,0)
 ;
"RTN","MAGDHOW4")
0^4^B34588912
"RTN","MAGDHOW4",1,0)
MAGDHOW4 ;WOIFO/PMK - Capture Consult/GMRC data ;17 Sep 2018 9:39 AM
"RTN","MAGDHOW4",2,0)
 ;;3.0;IMAGING;**138,208**;Mar 19, 2002;Build 6;Sep 03, 2013
"RTN","MAGDHOW4",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHOW4",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOW4",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHOW4",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHOW4",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHOW4",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHOW4",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHOW4",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHOW4",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHOW4",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHOW4",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHOW4",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHOW4",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHOW4",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOW4",17,0)
 ;;
"RTN","MAGDHOW4",18,0)
 ; Supported IA #2056 reference $$GET1^DIQ function call
"RTN","MAGDHOW4",19,0)
 ; Supported IA #4716 reference ^HLOAPI function calls
"RTN","MAGDHOW4",20,0)
 ; Supported IA 3536 reference GETDOCS^TIUSRVLR subroutine call
"RTN","MAGDHOW4",21,0)
 ; Supported IA #10103 reference $$FMTHL7^XLFDT function call
"RTN","MAGDHOW4",22,0)
 ; Controlled IA #4110 to read REQUEST/CONSULTATION file (#123)
"RTN","MAGDHOW4",23,0)
 ; Controlled IA #4171 to read REQUEST SERVICES file (#123.5)
"RTN","MAGDHOW4",24,0)
 ; Controlled IA #1373 to read PROTOCOL file (#101)
"RTN","MAGDHOW4",25,0)
 ; Supported IA #1995 to call CPT^ICPTCOD to get CPT code and short name
"RTN","MAGDHOW4",26,0)
 ; Supported IA #10090 to read INSTITUTION file (#4)
"RTN","MAGDHOW4",27,0)
 ; Supported IA #10040 to read HOSPITAL LOCATION file (#44)
"RTN","MAGDHOW4",28,0)
 ;
"RTN","MAGDHOW4",29,0)
OBR(HLMSTATE,GMRCIEN,SAVEORCSEG,SERVICE) ; build the OBR segment (see OBR^GMRCHL72)
"RTN","MAGDHOW4",30,0)
 N ACNUMB,AUTHOR,CPTCODE,CPTINFO,CPTNAME,CONPROC,ERROR,HL7USID,I,DEL,DEL2,OBRSEG,SUCCESS
"RTN","MAGDHOW4",31,0)
 N PRIORITY,X,Z
"RTN","MAGDHOW4",32,0)
 D SET^HLOAPI(.OBRSEG,"OBR",0)
"RTN","MAGDHOW4",33,0)
 D SET^HLOAPI(.OBRSEG,1,1) ; OBR-1
"RTN","MAGDHOW4",34,0)
 M OBRSEG(2)=SAVEORCSEG(2) ; OBR-2 placer order number
"RTN","MAGDHOW4",35,0)
 M OBRSEG(3)=SAVEORCSEG(3) ; OBR-3 filler order number
"RTN","MAGDHOW4",36,0)
 ;
"RTN","MAGDHOW4",37,0)
 ; OBR-4 Universal Service Identifier
"RTN","MAGDHOW4",38,0)
 ; check for Clinical Procedures HL7 Universal Services ID - P208 PMK 4/12/18
"RTN","MAGDHOW4",39,0)
 I $$CPORDER^MAGDHOWP(GMRCIEN,.HL7USID)>0,HL7USID'="" D  ; Clinical Procedures 
"RTN","MAGDHOW4",40,0)
 . D SET^HLOAPI(.OBRSEG,$P(HL7USID,"=",1),4,1)
"RTN","MAGDHOW4",41,0)
 . D SET^HLOAPI(.OBRSEG,$P(HL7USID,"=",2),4,2)
"RTN","MAGDHOW4",42,0)
 . Q
"RTN","MAGDHOW4",43,0)
 E  D  ; not Clinical Procedures - P208 PMK 4/12/18
"RTN","MAGDHOW4",44,0)
 . S CPTINFO=$$CPT^ICPTCOD(CPTIEN) ; get basic info on CPT/HCPCS code
"RTN","MAGDHOW4",45,0)
 . I CPTINFO<0 S CPTINFO="" ; error - no code selected or no such entry
"RTN","MAGDHOW4",46,0)
 . I $P(CPTINFO,"^",7)=0 S CPTINFO="" ; inactive CPT code
"RTN","MAGDHOW4",47,0)
 . S CPTCODE=$P(CPTINFO,"^",2) ; CPT code
"RTN","MAGDHOW4",48,0)
 . S CPTNAME=$P(CPTINFO,"^",3) ; short name
"RTN","MAGDHOW4",49,0)
 . D SET^HLOAPI(.OBRSEG,CPTCODE,4,1)
"RTN","MAGDHOW4",50,0)
 . D SET^HLOAPI(.OBRSEG,CPTNAME,4,2)
"RTN","MAGDHOW4",51,0)
 . D SET^HLOAPI(.OBRSEG,"C4",4,3)
"RTN","MAGDHOW4",52,0)
 . Q
"RTN","MAGDHOW4",53,0)
 S CONPROC=$$GET1^DIQ(123,GMRCIEN,13,"I") ; consult/procedure request type
"RTN","MAGDHOW4",54,0)
 I CONPROC="C" D  ; consult request
"RTN","MAGDHOW4",55,0)
 . D SET^HLOAPI(.OBRSEG,"C"_SERVICE,4,4)
"RTN","MAGDHOW4",56,0)
 . D SET^HLOAPI(.OBRSEG,$$GET1^DIQ(123.5,SERVICE,.01),4,5)
"RTN","MAGDHOW4",57,0)
 . D SET^HLOAPI(.OBRSEG,"99CON",4,6)
"RTN","MAGDHOW4",58,0)
 . Q
"RTN","MAGDHOW4",59,0)
 E  D  ; procedure request
"RTN","MAGDHOW4",60,0)
 . D SET^HLOAPI(.OBRSEG,"P"_(+$$GET1^DIQ(123,GMRCIEN,4,"I")),4,4)
"RTN","MAGDHOW4",61,0)
 . D SET^HLOAPI(.OBRSEG,$$GET1^DIQ(123,GMRCIEN,4),4,5)
"RTN","MAGDHOW4",62,0)
 . D SET^HLOAPI(.OBRSEG,"99PROC",4,6)
"RTN","MAGDHOW4",63,0)
 . Q
"RTN","MAGDHOW4",64,0)
 ;
"RTN","MAGDHOW4",65,0)
 S PRIORITY=$G(SAVEORCSEG(7,1,6,1))
"RTN","MAGDHOW4",66,0)
 I PRIORITY'="" D SET^HLOAPI(.OBRSEG,PRIORITY,5) ; OBR-5 priority
"RTN","MAGDHOW4",67,0)
 ;
"RTN","MAGDHOW4",68,0)
 ; OBR-6 to OBR-15 are not used
"RTN","MAGDHOW4",69,0)
 ;
"RTN","MAGDHOW4",70,0)
 M OBRSEG(16)=SAVEORCSEG(12) ; OBR-16 ordering provider
"RTN","MAGDHOW4",71,0)
 M OBRSEG(17)=SAVEORCSEG(14) ; OBR-17 call back phone number
"RTN","MAGDHOW4",72,0)
 ;
"RTN","MAGDHOW4",73,0)
 ; store the accession number
"RTN","MAGDHOW4",74,0)
 S ACNUMB=$$GMRCACN^MAGDFCNV(GMRCIEN)
"RTN","MAGDHOW4",75,0)
 D SET^HLOAPI(.OBRSEG,ACNUMB,18) ; OBR-18 placer field 1
"RTN","MAGDHOW4",76,0)
 ;
"RTN","MAGDHOW4",77,0)
 ; store the requested procedure id
"RTN","MAGDHOW4",78,0)
 D SET^HLOAPI(.OBRSEG,$P(ACNUMB,"-",3),19) ; OBR-19 placer field 2
"RTN","MAGDHOW4",79,0)
 ;
"RTN","MAGDHOW4",80,0)
 ; store misc. consult and clinic info in "filler field 1"
"RTN","MAGDHOW4",81,0)
 ;   <request type>
"RTN","MAGDHOW4",82,0)
 ; ` <place of consult>
"RTN","MAGDHOW4",83,0)
 ; ` <clinic ien> _ <clinic name>
"RTN","MAGDHOW4",84,0)
 ; ` <requesting service ien> _ <requesting service name> _ VISTA44
"RTN","MAGDHOW4",85,0)
 ;
"RTN","MAGDHOW4",86,0)
 S Z=$S(CONPROC="C":"CONSULT",CONPROC="P":"PROCEDURE",1:"UNKNOWN")_"```"
"RTN","MAGDHOW4",87,0)
 S X=$$GET1^DIQ(123,GMRCIEN,6,"I") ; place of consult
"RTN","MAGDHOW4",88,0)
 I X S $P(Z,"`",2)=$$GET1^DIQ(101,X,1)
"RTN","MAGDHOW4",89,0)
 I $D(APTSCHED("CLINIC IEN")),$D(APTSCHED("CLINIC NAME")) D
"RTN","MAGDHOW4",90,0)
 . S $P(Z,"`",3)=APTSCHED("CLINIC IEN")_"_"_APTSCHED("CLINIC NAME")
"RTN","MAGDHOW4",91,0)
 . Q
"RTN","MAGDHOW4",92,0)
 ; from service (requesting service)
"RTN","MAGDHOW4",93,0)
 S X=$$GET1^DIQ(123,GMRCIEN,2,"I") ; pointer to ^SC(Z)
"RTN","MAGDHOW4",94,0)
 I X S $P(Z,"`",4)=X_"_"_$$GET1^DIQ(44,X,.01)_"_VISTA44"
"RTN","MAGDHOW4",95,0)
 D SET^HLOAPI(.OBRSEG,Z,20) ; OBR-20 filler field 1
"RTN","MAGDHOW4",96,0)
 ;
"RTN","MAGDHOW4",97,0)
 ; store consult and clinic identification info in "filler field 2"
"RTN","MAGDHOW4",98,0)
 ;   <itype code> _ <itype name>
"RTN","MAGDHOW4",99,0)
 ; ` <service ien> _ <service name>
"RTN","MAGDHOW4",100,0)
 ; ` <division station number> _ <division name>
"RTN","MAGDHOW4",101,0)
 ; ` <current CPRS GMRC or Appointment Scheduling status>
"RTN","MAGDHOW4",102,0)
 ;
"RTN","MAGDHOW4",103,0)
 S Z=ITYPCODE_"_"_ITYPNAME_"```"
"RTN","MAGDHOW4",104,0)
 S $P(Z,"`",2)=SERVICE_"_"_$$GET1^DIQ(123.5,SERVICE,.01)
"RTN","MAGDHOW4",105,0)
 S $P(Z,"`",3)=DIVISION_"_"_$S(DIVISION:$$GET1^DIQ(4,DIVISION,.01),1:"")
"RTN","MAGDHOW4",106,0)
 ; store the current CPRS GMRC or Appointment Scheduling status
"RTN","MAGDHOW4",107,0)
 I '$D(FILLER2) S FILLER2="GMRC-"_$$GET1^DIQ(123,GMRCIEN,8) ; GMRC status
"RTN","MAGDHOW4",108,0)
 S $P(Z,"`",4)=FILLER2
"RTN","MAGDHOW4",109,0)
 ;
"RTN","MAGDHOW4",110,0)
 D SET^HLOAPI(.OBRSEG,Z,21) ; OBR-21 filler field 2
"RTN","MAGDHOW4",111,0)
 ;
"RTN","MAGDHOW4",112,0)
 ; CPRS Attention - HL7 "Result Copies To" field
"RTN","MAGDHOW4",113,0)
 S X=$$GET1^DIQ(123,GMRCIEN,7,"I") ; pointer to ^VA(200)
"RTN","MAGDHOW4",114,0)
 I X D NAME^MAGDHOW3(X,28,.OBRSEG) ; OBR-28 result copies to
"RTN","MAGDHOW4",115,0)
 ;
"RTN","MAGDHOW4",116,0)
 ; special code for result message or order message, but not both
"RTN","MAGDHOW4",117,0)
 ;
"RTN","MAGDHOW4",118,0)
 I MSGTYPE="ORU" D  ; code for result messages, not orders
"RTN","MAGDHOW4",119,0)
 . N AUTHOR
"RTN","MAGDHOW4",120,0)
 . D SET^HLOAPI(.OBRSEG,$$FMTHL7^XLFDT(FMDATETM),22) ; OBR-22
"RTN","MAGDHOW4",121,0)
 . D SET^HLOAPI(.OBRSEG,$S(ORSTATUS="CM":"F",1:"R"),25) ; OBR-25
"RTN","MAGDHOW4",122,0)
 . ; directly call rpc TIU GET DOCUMENTS FOR REQUEST
"RTN","MAGDHOW4",123,0)
 . D GETDOCS^TIUSRVLR(.TIUDOC,GMRCIEN_";GMR(123,") ; ICR 3536
"RTN","MAGDHOW4",124,0)
 . ; get author of most recent (last) report
"RTN","MAGDHOW4",125,0)
 . S I=0 F  S I=$O(@TIUDOC@(I)) Q:'I  S X=@TIUDOC@(I) D
"RTN","MAGDHOW4",126,0)
 . . S AUTHOR=$P(X,"^",5)
"RTN","MAGDHOW4",127,0)
 . . Q
"RTN","MAGDHOW4",128,0)
 . I $D(AUTHOR) D NAME^MAGDHOW3(+AUTHOR,32,.OBRSEG) ; OBR-32
"RTN","MAGDHOW4",129,0)
 . Q
"RTN","MAGDHOW4",130,0)
 ;
"RTN","MAGDHOW4",131,0)
 E  I MSGTYPE="ORM" D  ; code for order messages, not results
"RTN","MAGDHOW4",132,0)
 . M OBRSEG(27)=SAVEORCSEG(7) ; quantity/timing - OBR-27
"RTN","MAGDHOW4",133,0)
 . ;
"RTN","MAGDHOW4",134,0)
 . ; date and time of scheduled appointment
"RTN","MAGDHOW4",135,0)
 . I $D(APTSCHED("FM DATETIME")) D
"RTN","MAGDHOW4",136,0)
 . . D SET^HLOAPI(.OBRSEG,$$FMTHL7^XLFDT(APTSCHED("FM DATETIME")),36) ; OBR-36
"RTN","MAGDHOW4",137,0)
 . . Q
"RTN","MAGDHOW4",138,0)
 . Q
"RTN","MAGDHOW4",139,0)
 ;
"RTN","MAGDHOW4",140,0)
 ;
"RTN","MAGDHOW4",141,0)
 S SUCCESS=$$ADDSEG^HLOAPI(.HLMSTATE,.OBRSEG,.ERROR)
"RTN","MAGDHOW4",142,0)
 I 'SUCCESS D
"RTN","MAGDHOW4",143,0)
 . N MSG,SUBJECT,VARIABLES
"RTN","MAGDHOW4",144,0)
 . S SUBJECT="VistA Imaging Clinical Specialty (CPRS) HL7 Generation"
"RTN","MAGDHOW4",145,0)
 . S MSG(1)="An error occurred in OBR^"_$T(+0)_" where the ADDSEG^HLOAPI invocation"
"RTN","MAGDHOW4",146,0)
 . S MSG(2)="for the OBR segment failed.  The error message is as follows:"
"RTN","MAGDHOW4",147,0)
 . S MSG(3)=""""_SUCCESS_""""
"RTN","MAGDHOW4",148,0)
 . S VARIABLES("HLMSTATE")=""
"RTN","MAGDHOW4",149,0)
 . S VARIABLES("OBRSEG")=""
"RTN","MAGDHOW4",150,0)
 . S VARIABLES("ERROR")=""
"RTN","MAGDHOW4",151,0)
 . D ERROR^MAGDHOWA(SUBJECT,.MSG,.VARIABLES)
"RTN","MAGDHOW4",152,0)
 . Q
"RTN","MAGDHOW4",153,0)
 Q
"RTN","MAGDHOWC")
0^5^B38002639
"RTN","MAGDHOWC",1,0)
MAGDHOWC ;WOIFO/PMK - Capture Consult/Procedure Request data ;13 Sep 2018 4:01 PM
"RTN","MAGDHOWC",2,0)
 ;;3.0;IMAGING;**138,174,208**;Mar 19, 2002;Build 6;Sep 03, 2013
"RTN","MAGDHOWC",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHOWC",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOWC",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHOWC",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHOWC",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHOWC",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHOWC",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHOWC",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHOWC",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHOWC",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHOWC",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHOWC",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHOWC",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHOWC",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOWC",17,0)
 ;;
"RTN","MAGDHOWC",18,0)
 ;;
"RTN","MAGDHOWC",19,0)
 ; Supported IA #2056 reference $$GET1^DIQ function call
"RTN","MAGDHOWC",20,0)
 ; Supported IA #10061 reference SDA^VADPT subroutine call
"RTN","MAGDHOWC",21,0)
 ; Controlled IA #4110 to read REQUEST/CONSULTATION file (#123)
"RTN","MAGDHOWC",22,0)
 ; Supported IA #10040 to read HOSPITAL LOCATION file (#44)
"RTN","MAGDHOWC",23,0)
 ; 
"RTN","MAGDHOWC",24,0)
ENTRY ;
"RTN","MAGDHOWC",25,0)
 ; determine the kind of message and branch appropriately
"RTN","MAGDHOWC",26,0)
 N APTSCHED,CPINVOCATION,DEL,DEL2,DEL3,DEL4,DEL5,DFN,FILLER2,GMRCIEN,HL7,HL7MSH,HL7ORC
"RTN","MAGDHOWC",27,0)
 N I,SERVICE
"RTN","MAGDHOWC",28,0)
 ;
"RTN","MAGDHOWC",29,0)
 I $D(GMRCMSG) M HL7=GMRCMSG
"RTN","MAGDHOWC",30,0)
 E  I $D(XQORHSTK(0)) M HL7=XQORHSTK(0)
"RTN","MAGDHOWC",31,0)
 E  Q  ; can't find HL7 data to handle this!
"RTN","MAGDHOWC",32,0)
 S HL7MSH=HL7(1)
"RTN","MAGDHOWC",33,0)
 S DEL=$E(HL7MSH,4),X=$P(HL7MSH,DEL,2)
"RTN","MAGDHOWC",34,0)
 F I=1:1:$L(X) S @("DEL"_(I+1))=$E(X,I)
"RTN","MAGDHOWC",35,0)
 ;
"RTN","MAGDHOWC",36,0)
 ; find PID segment and get the DFN
"RTN","MAGDHOWC",37,0)
 S I=0 I '$$FINDSEG^MAGDHOW0(.HL7,"PID",.I,.X) Q  ; no PID segment
"RTN","MAGDHOWC",38,0)
 S DFN=$P(X,DEL,3)
"RTN","MAGDHOWC",39,0)
 ;
"RTN","MAGDHOWC",40,0)
 ; find ORC segment and get GMRCIEN
"RTN","MAGDHOWC",41,0)
 S I=0 I '$$FINDSEG^MAGDHOW0(.HL7,"ORC",.I,.HL7ORC) Q  ; no ORC segment
"RTN","MAGDHOWC",42,0)
 S GMRCIEN=+$P(HL7ORC,DEL,3) ; GMRC request is in ^GMR(123,GMRCIEN,...)
"RTN","MAGDHOWC",43,0)
 ;
"RTN","MAGDHOWC",44,0)
 I $$CPORDER^MAGDHOWP(GMRCIEN)="2,UNFINISHED" Q  ; don't generate HL7 for new CP orders - P208 PMK 4/24/18
"RTN","MAGDHOWC",45,0)
 S CPINVOCATION=0 ; Clinical Procedures exam HL7 flag (set to 1 in MAGDHOWP) P208 PMK 4/12/18
"RTN","MAGDHOWC",46,0)
 ;
"RTN","MAGDHOWC",47,0)
 D ^MAGDTR01 ; update the Read/Unread list with the data from the HL7 message
"RTN","MAGDHOWC",48,0)
 ;
"RTN","MAGDHOWC",49,0)
 S SERVICE=$$GET1^DIQ(123,GMRCIEN,1,"I")
"RTN","MAGDHOWC",50,0)
 D APTSCHED(GMRCIEN,SERVICE,.APTSCHED) ; get appointment scheduling information
"RTN","MAGDHOWC",51,0)
 ;
"RTN","MAGDHOWC",52,0)
 I $P($P(HL7ORC,DEL,16),DEL2,5)="FORWARD" D  ; check for a forwarded request
"RTN","MAGDHOWC",53,0)
 . N FROMSERVICE ; original service
"RTN","MAGDHOWC",54,0)
 . ; send an order cancellation to the original service
"RTN","MAGDHOWC",55,0)
 . S FILLER2="GMRC-CANCELLED" ; override actual GMRC status
"RTN","MAGDHOWC",56,0)
 . S FROMSERVICE=$$FWDFROM^MAGDGMRC(GMRCIEN) ; FORWARDED FROM service
"RTN","MAGDHOWC",57,0)
 . ;
"RTN","MAGDHOWC",58,0)
 . ; cancel the original order to the original service
"RTN","MAGDHOWC",59,0)
 . D MSGSETUP^MAGDHOW1(GMRCIEN,FROMSERVICE,"CA","CA") ; cancel order
"RTN","MAGDHOWC",60,0)
 . K FILLER2 ; use only for the first cancellation message
"RTN","MAGDHOWC",61,0)
 . ;
"RTN","MAGDHOWC",62,0)
 . ; send a new order to the new service
"RTN","MAGDHOWC",63,0)
 . D MSGSETUP^MAGDHOW1(GMRCIEN,SERVICE,"NW","IP",.APTSCHED) ; new order
"RTN","MAGDHOWC",64,0)
 . Q
"RTN","MAGDHOWC",65,0)
 ;
"RTN","MAGDHOWC",66,0)
 E  D  ; normal processing
"RTN","MAGDHOWC",67,0)
 . N ORC1,ORC5
"RTN","MAGDHOWC",68,0)
 . S ORC1=$P(HL7ORC,DEL,1) ; original HL7 message order control
"RTN","MAGDHOWC",69,0)
 . S ORC5=$P(HL7ORC,DEL,5) ; original HL7 message order status
"RTN","MAGDHOWC",70,0)
 . D MSGSETUP^MAGDHOW1(GMRCIEN,SERVICE,ORC1,ORC5,.APTSCHED) ; regular transaction
"RTN","MAGDHOWC",71,0)
 Q
"RTN","MAGDHOWC",72,0)
 ;
"RTN","MAGDHOWC",73,0)
APTSCHED(GMRCIEN,SERVICE,APTSCHED) ; get appointment scheduling information
"RTN","MAGDHOWC",74,0)
 ;
"RTN","MAGDHOWC",75,0)
 ; first check if the appointment information is in the comment
"RTN","MAGDHOWC",76,0)
 I $$CHECKCMT(GMRCIEN,.APTSCHED) Q
"RTN","MAGDHOWC",77,0)
 ;
"RTN","MAGDHOWC",78,0)
 ; no appointment information in the comment
"RTN","MAGDHOWC",79,0)
 ; check if there is an appointment that was previously scheduled
"RTN","MAGDHOWC",80,0)
 D CHECKAPT(GMRCIEN,SERVICE,.APTSCHED)
"RTN","MAGDHOWC",81,0)
 Q
"RTN","MAGDHOWC",82,0)
 ;
"RTN","MAGDHOWC",83,0)
CHECKCMT(GMRCIEN,APTSCHED) ; check if appointment is scheduled (Patch SD*5.3*478)
"RTN","MAGDHOWC",84,0)
 N COMMENT,DATETIME,I,SCHEDULE,SS1,SS2,X,Y
"RTN","MAGDHOWC",85,0)
 K APTSCHED
"RTN","MAGDHOWC",86,0)
 S SCHEDULE=""
"RTN","MAGDHOWC",87,0)
 F I=1:1 D  Q:DATETIME=""
"RTN","MAGDHOWC",88,0)
 . S SS1=I_","_GMRCIEN ; subscript for file #123.02
"RTN","MAGDHOWC",89,0)
 . S DATETIME=$$GET1^DIQ(123.02,SS1,.01) Q:DATETIME=""
"RTN","MAGDHOWC",90,0)
 . S SS2="1,"_SS1 ; subscript for file #123.25
"RTN","MAGDHOWC",91,0)
 . S COMMENT=$$GET1^DIQ(123.25,SS2,.01) Q:COMMENT=""
"RTN","MAGDHOWC",92,0)
 . I COMMENT[" Consult Appt. on " S SCHEDULE=COMMENT
"RTN","MAGDHOWC",93,0)
 . Q
"RTN","MAGDHOWC",94,0)
 I SCHEDULE'="" D
"RTN","MAGDHOWC",95,0)
 . N %DT
"RTN","MAGDHOWC",96,0)
 . S X=$P(SCHEDULE," Consult Appt. on ",1)
"RTN","MAGDHOWC",97,0)
 . S Y=$S(X'="":$O(^SC("B",X,"")),1:"") ; clinic name could be null - their bug
"RTN","MAGDHOWC",98,0)
 . S APTSCHED("CLINIC IEN")=Y ; <file #44 ien>
"RTN","MAGDHOWC",99,0)
 . S APTSCHED("CLINIC NAME")=X
"RTN","MAGDHOWC",100,0)
 . S X=$P(SCHEDULE," Consult Appt. on ",2)
"RTN","MAGDHOWC",101,0)
 . S X=$TR(X," "),%DT="T" D ^%DT ; remove spaces & convert to FM format
"RTN","MAGDHOWC",102,0)
 . S APTSCHED("FM DATETIME")=Y
"RTN","MAGDHOWC",103,0)
 . Q
"RTN","MAGDHOWC",104,0)
 Q (SCHEDULE'="")
"RTN","MAGDHOWC",105,0)
 ;
"RTN","MAGDHOWC",106,0)
CHECKAPT(GMRCIEN,SERVICE,APTSCHED) ; check if appointment was previously scheduled
"RTN","MAGDHOWC",107,0)
 ; quite often the appointment is entered before the order is entered
"RTN","MAGDHOWC",108,0)
 ; if this is the case, see if we can find the corresponding appointment
"RTN","MAGDHOWC",109,0)
 N A,CLINIC,DATETIME,EARLIEST,HIT,I,J,SDAMDFN,SDAMGMRCIEN,SS
"RTN","MAGDHOWC",110,0)
 ;
"RTN","MAGDHOWC",111,0)
 D SDA^VADPT ; get the list of the appointments
"RTN","MAGDHOWC",112,0)
 M A=^UTILITY("VASD",$J) K ^UTILITY("VASD",$J)
"RTN","MAGDHOWC",113,0)
 ;
"RTN","MAGDHOWC",114,0)
 ; remove appointments for other clinics
"RTN","MAGDHOWC",115,0)
 S I=0 F  S I=$O(A(I)) Q:'I  D
"RTN","MAGDHOWC",116,0)
 . S CLINIC=$P(A(I,"I"),"^",2)
"RTN","MAGDHOWC",117,0)
 . I '$$ISCLINIC(GMRCIEN,SERVICE,CLINIC) K A(I)
"RTN","MAGDHOWC",118,0)
 . Q
"RTN","MAGDHOWC",119,0)
 ; remove appointments for other consult/procedure requests
"RTN","MAGDHOWC",120,0)
 S (HIT,I)=0 F  S I=$O(A(I)) Q:'I  D
"RTN","MAGDHOWC",121,0)
 . S DATETIME=$P(A(I,"I"),"^",1),CLINIC=$P(A(I,"I"),"^",2)
"RTN","MAGDHOWC",122,0)
 . F J=1:1 D  Q:'SDAMDFN
"RTN","MAGDHOWC",123,0)
 . . S SS=J_","_DATETIME_","_CLINIC
"RTN","MAGDHOWC",124,0)
 . . S SDAMDFN=$$GET1^DIQ(44.003,SS,.01,"I")
"RTN","MAGDHOWC",125,0)
 . . I SDAMDFN=DFN D
"RTN","MAGDHOWC",126,0)
 . . . S SDAMGMRCIEN=$$GET1^DIQ(44.003,SS,688,"I")
"RTN","MAGDHOWC",127,0)
 . . . I SDAMGMRCIEN=GMRCIEN S HIT=I ; found one for this consult!
"RTN","MAGDHOWC",128,0)
 . . . E  I SDAMGMRCIEN'="" K A(I)
"RTN","MAGDHOWC",129,0)
 . . . ; keep ones without consult pointer
"RTN","MAGDHOWC",130,0)
 . . . Q
"RTN","MAGDHOWC",131,0)
 . . Q
"RTN","MAGDHOWC",132,0)
 . Q
"RTN","MAGDHOWC",133,0)
 ;
"RTN","MAGDHOWC",134,0)
 I 'HIT D  ; get the earliest possible date for the appointment
"RTN","MAGDHOWC",135,0)
 . S EARLIEST=$$GET1^DIQ(123,GMRCIEN,17,"I")
"RTN","MAGDHOWC",136,0)
 . I EARLIEST D
"RTN","MAGDHOWC",137,0)
 . . S I=0 F  S I=$O(A(I)) Q:'I  D  Q:HIT
"RTN","MAGDHOWC",138,0)
 . . . I A(I,"I")>EARLIEST S HIT=I
"RTN","MAGDHOWC",139,0)
 . . . Q
"RTN","MAGDHOWC",140,0)
 . . Q
"RTN","MAGDHOWC",141,0)
 . E  S HIT=$O(A("")) ; pick the earliest scheduled appointment
"RTN","MAGDHOWC",142,0)
 . Q
"RTN","MAGDHOWC",143,0)
 ;
"RTN","MAGDHOWC",144,0)
 I HIT D
"RTN","MAGDHOWC",145,0)
 . S APTSCHED("FM DATETIME")=$P(A(HIT,"I"),"^",1)
"RTN","MAGDHOWC",146,0)
 . S APTSCHED("CLINIC IEN")=$P(A(HIT,"I"),"^",2)
"RTN","MAGDHOWC",147,0)
 . S APTSCHED("DATETIME")=$P(A(HIT,"E"),"^",1)
"RTN","MAGDHOWC",148,0)
 . S APTSCHED("CLINIC NAME")=$P(A(HIT,"E"),"^",2)
"RTN","MAGDHOWC",149,0)
 . S FILLER2="GMRC-SCHEDULED" ; over-ride GMRC's status
"RTN","MAGDHOWC",150,0)
 . ; Note: If the study has been completed, FILLER2 will be killed in
"RTN","MAGDHOWC",151,0)
 . ;       MAGSETUP^MAGHOW1 so that GMRC's actual status will be used.
"RTN","MAGDHOWC",152,0)
 . Q
"RTN","MAGDHOWC",153,0)
 Q
"RTN","MAGDHOWC",154,0)
 ;
"RTN","MAGDHOWC",155,0)
ISCLINIC(GMRCIEN,SERVICE,CLINIC) ; is a particular clinic defined for a given service?
"RTN","MAGDHOWC",156,0)
 N IEN,ISCLINIC
"RTN","MAGDHOWC",157,0)
 S ISCLINIC=0
"RTN","MAGDHOWC",158,0)
 I GMRCIEN,SERVICE,CLINIC D
"RTN","MAGDHOWC",159,0)
 . S IEN=$$MWLFIND^MAGDHOW1(SERVICE,GMRCIEN)
"RTN","MAGDHOWC",160,0)
 . I IEN,$D(^MAG(2006.5831,IEN,1,"B",CLINIC)) S ISCLINIC=1
"RTN","MAGDHOWC",161,0)
 . Q
"RTN","MAGDHOWC",162,0)
 Q ISCLINIC
"RTN","MAGDHOWP")
0^6^B23921465
"RTN","MAGDHOWP",1,0)
MAGDHOWP ;WOIFO/PMK - Generate VistA Imaging HL7 message for Clinical Procedures Check-in ;04 Sep 2018 10:41 AM
"RTN","MAGDHOWP",2,0)
 ;;3.0;IMAGING;**208**;Mar 19, 2002;Build 6;Sep 03, 2013
"RTN","MAGDHOWP",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHOWP",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOWP",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHOWP",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHOWP",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHOWP",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHOWP",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHOWP",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHOWP",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHOWP",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHOWP",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHOWP",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHOWP",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHOWP",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOWP",17,0)
 ;;
"RTN","MAGDHOWP",18,0)
 ;;
"RTN","MAGDHOWP",19,0)
 ;
"RTN","MAGDHOWP",20,0)
 ; Supported IA #10000 reference NOW^%DTC subroutine call
"RTN","MAGDHOWP",21,0)
 ; Supported IA #2056 reference $$GET1^DIQ function call
"RTN","MAGDHOWP",22,0)
 ; Supported IA #2056 reference GETS^DIQ subroutine call
"RTN","MAGDHOWP",23,0)
 ; Controlled IA #4110 to read REQUEST/CONSULTATION file (#123)
"RTN","MAGDHOWP",24,0)
 ; Private IA #6928 to read CP INSTRUMENT file (#702.09)
"RTN","MAGDHOWP",25,0)
 ; Private IA #6929 to read CP TRANSACTION file (#702) 
"RTN","MAGDHOWP",26,0)
 ; Private IA #6929 to $Order thru "ACON" xfef in ^MDD(702)
"RTN","MAGDHOWP",27,0)
 ; Private IA #6930 to read CP DEFINITION file (#702.01)
"RTN","MAGDHOWP",28,0)
 ;
"RTN","MAGDHOWP",29,0)
 ; CLINPROC is called by MDHL7BH to generate VistA Imaging HL7
"RTN","MAGDHOWP",30,0)
 ; for a check-in or cancellation of a Clinical Procedure.
"RTN","MAGDHOWP",31,0)
 ; 
"RTN","MAGDHOWP",32,0)
CLINPROC(FILE702P,ORDERFLAG) ; entry point from MDHL7BH
"RTN","MAGDHOWP",33,0)
 ; FILE702P ---- pointer to the clinical procedure in ^MDD(702,FILE702P,...)
"RTN","MAGDHOWP",34,0)
 ; ORDERFLAG --- 0=cancel, 1=new order
"RTN","MAGDHOWP",35,0)
 N APTSCHED,CPINVOCATION,DFN,FILE70201P,FILLER2,GMRCIEN,ORC1,ORC5,SDATE,SERVICE
"RTN","MAGDHOWP",36,0)
 S DFN=$$GET1^DIQ(702,FILE702P,.01,"I")
"RTN","MAGDHOWP",37,0)
 S GMRCIEN=$$GET1^DIQ(702,FILE702P,.05,"I")
"RTN","MAGDHOWP",38,0)
 S SERVICE=$$GET1^DIQ(123,GMRCIEN,1,"I")
"RTN","MAGDHOWP",39,0)
 S SDATE=$$GET1^DIQ(702,FILE702P,.07,"I")
"RTN","MAGDHOWP",40,0)
 I SDATE[";" S SDATE=$P(SDATE,";",2)
"RTN","MAGDHOWP",41,0)
 I SDATE="" D NOW^%DTC S SDATE=%
"RTN","MAGDHOWP",42,0)
 I SDATE<DT D NOW^%DTC S SDATE=%
"RTN","MAGDHOWP",43,0)
 S APTSCHED("FM DATETIME")=SDATE
"RTN","MAGDHOWP",44,0)
 S FILE70201P=$$GET1^DIQ(702,FILE702P,.04,"I")
"RTN","MAGDHOWP",45,0)
 S APTSCHED("CLINIC IEN")=$$GET1^DIQ(702.01,FILE70201P,.05,"I")
"RTN","MAGDHOWP",46,0)
 S APTSCHED("CLINIC NAME")=$$GET1^DIQ(702.01,FILE70201P,.05,"E")
"RTN","MAGDHOWP",47,0)
 S FILLER2="GMRC-SCHEDULED" ; over-ride GMRC's status
"RTN","MAGDHOWP",48,0)
 I ORDERFLAG D   ; new CP order check-in
"RTN","MAGDHOWP",49,0)
 . S (ORC1,ORC5)="OK"
"RTN","MAGDHOWP",50,0)
 . Q
"RTN","MAGDHOWP",51,0)
 E  D  ; cancel CP order
"RTN","MAGDHOWP",52,0)
 . S (ORC1,ORC5)="CA"
"RTN","MAGDHOWP",53,0)
 . Q
"RTN","MAGDHOWP",54,0)
 ;
"RTN","MAGDHOWP",55,0)
 D TELEREAD(ORC1) ; put CP study on TeleReader Read/Unread list
"RTN","MAGDHOWP",56,0)
 ;
"RTN","MAGDHOWP",57,0)
 S CPINVOCATION=1 ; Clinical Procedures HL7 flag
"RTN","MAGDHOWP",58,0)
 D MSGSETUP^MAGDHOW1(GMRCIEN,SERVICE,ORC1,ORC5,.APTSCHED)
"RTN","MAGDHOWP",59,0)
 Q
"RTN","MAGDHOWP",60,0)
 ;
"RTN","MAGDHOWP",61,0)
TELEREAD(ORC1) ; add the CP order to the TeleReader Read/Unread list
"RTN","MAGDHOWP",62,0)
 N DEL,DEL2,HL7ORC
"RTN","MAGDHOWP",63,0)
 S DEL="|",DEL2="^"
"RTN","MAGDHOWP",64,0)
 S $P(HL7ORC,DEL)=ORC1
"RTN","MAGDHOWP",65,0)
 D ^MAGDTR01
"RTN","MAGDHOWP",66,0)
 Q
"RTN","MAGDHOWP",67,0)
 ;
"RTN","MAGDHOWP",68,0)
OUTPUT(N) ; called by OUTPUT^MAGDHOW2 if CPINVOCATION=1
"RTN","MAGDHOWP",69,0)
 N FILE70209P,CPDICOM
"RTN","MAGDHOWP",70,0)
 S FILE70209P=$$GET1^DIQ(702,FILE702P,.11,"I") ; get instrument
"RTN","MAGDHOWP",71,0)
 S CPDICOM=$$GET1^DIQ(702.09,FILE70209P,.19,"I") ; get CP - DICOM Interoperability
"RTN","MAGDHOWP",72,0)
 I CPDICOM=2 D  ; replace CP's HL7 message with VistA's
"RTN","MAGDHOWP",73,0)
 . ; Replace the CP HL7 message body in HLA with the VI HL7 message body
"RTN","MAGDHOWP",74,0)
 . K HLA
"RTN","MAGDHOWP",75,0)
 . F I=2:1:N S HLA("HLS",I-1)=HL7(I)
"RTN","MAGDHOWP",76,0)
 . Q
"RTN","MAGDHOWP",77,0)
 Q
"RTN","MAGDHOWP",78,0)
 ;
"RTN","MAGDHOWP",79,0)
 ;
"RTN","MAGDHOWP",80,0)
 ; CPORDER is called by MAGDHOW4, MAGDHOWC and MAGDHOWS to determine
"RTN","MAGDHOWP",81,0)
 ; if this a Clinical Procedures order.
"RTN","MAGDHOWP",82,0)
 ; 
"RTN","MAGDHOWP",83,0)
 ; In addition, MAGDHOW4 is concerned if this is a Clinical Procedures
"RTN","MAGDHOWP",84,0)
 ; order and get the HL7 Universal Service ID.
"RTN","MAGDHOWP",85,0)
 ; 
"RTN","MAGDHOWP",86,0)
 ; MAGDHOWC and MAGDHOWS need to know if this is a new/active CP order
"RTN","MAGDHOWP",87,0)
 ; for one or more bidirectional instruments.  If so, MAGDHOWC(which
"RTN","MAGDHOWP",88,0)
 ; handles GMRC CPRS Consult Request Tracking) and MAGDHOWS(which handles
"RTN","MAGDHOWP",89,0)
 ; SDAM Appointment Management) will not prematurely generate an HL7
"RTN","MAGDHOWP",90,0)
 ; message at order release time or when the appointment is scheduled.
"RTN","MAGDHOWP",91,0)
 ; 
"RTN","MAGDHOWP",92,0)
 ; Instead, the HL7 message will be generated by the CLINPROC subroutine
"RTN","MAGDHOWP",93,0)
 ; (above) when it is invoked by MDHL7BH for CP check-in.
"RTN","MAGDHOWP",94,0)
 ; 
"RTN","MAGDHOWP",95,0)
CPORDER(GMRCIEN,HL7USID) ; entry point from OBR^MAGDHOW4, ENTRY^MAGDHOWC, MAGDHOWS
"RTN","MAGDHOWP",96,0)
 ; Return Code
"RTN","MAGDHOWP",97,0)
 ; -1,ERROR -------- error return
"RTN","MAGDHOWP",98,0)
 ;  0,NOT A CP ----- not a clinical procedure
"RTN","MAGDHOWP",99,0)
 ;  1,UNIDIRECT ---- clinical procedure with no bidirectional instruments
"RTN","MAGDHOWP",100,0)
 ;  2,UNFINISHED --- unfinished clinical procedure with bidirectional instruments
"RTN","MAGDHOWP",101,0)
 ;  3,FINISHED ----- finished clinical procedure with bidirectional instruments
"RTN","MAGDHOWP",102,0)
 ; 
"RTN","MAGDHOWP",103,0)
 ; MAGHOWC and MAGDHOWS ignore consult & appointment transactions for
"RTN","MAGDHOWP",104,0)
 ; unfinished CP's ("2,UNFINISHED") and process them for cancelled, completed,
"RTN","MAGDHOWP",105,0)
 ; and discontinued CP's, CP's with no bidirectional instruments, and non-CP
"RTN","MAGDHOWP",106,0)
 ; CPRS Consult Request Tracking consults & procedures.
"RTN","MAGDHOWP",107,0)
 ; 
"RTN","MAGDHOWP",108,0)
 ; MAGDHOW4 needs to get CP's HL7 Universal Service Identifier (HL7USID) and
"RTN","MAGDHOWP",109,0)
 ; store it in OBR-4 for clinical procedures.
"RTN","MAGDHOWP",110,0)
 ;
"RTN","MAGDHOWP",111,0)
 N BIDIRECT,E,I,FILE702P,FILE70201P,FILE70209P,MCODE,STATUS,TAG
"RTN","MAGDHOWP",112,0)
 ;
"RTN","MAGDHOWP",113,0)
 S HL7USID="" ; initialize CP's HL7 Universal Service Identifier
"RTN","MAGDHOWP",114,0)
 ;
"RTN","MAGDHOWP",115,0)
 ; is this a consult/procedure in Clinical Procedures?
"RTN","MAGDHOWP",116,0)
 S FILE70201P=$$GET1^DIQ(123,GMRCIEN,1.01,"I") ; get Clinical Procedures definition
"RTN","MAGDHOWP",117,0)
 ;
"RTN","MAGDHOWP",118,0)
 I 'FILE70201P Q "0,NOT A CP" ; not a CP
"RTN","MAGDHOWP",119,0)
 ;
"RTN","MAGDHOWP",120,0)
 ; look for a bidirectional instrument associated with this CP definition
"RTN","MAGDHOWP",121,0)
 S BIDIRECT=0 ; initialize bidirectional switch
"RTN","MAGDHOWP",122,0)
 S I=0 F  S I=$O(^MDS(702.01,FILE70201P,.1,I)) Q:'I  D  Q:BIDIRECT
"RTN","MAGDHOWP",123,0)
 . S FILE70209P=$$GET1^DIQ(702.011,I_","_FILE70201P,.01,"I") Q:'FILE70209P
"RTN","MAGDHOWP",124,0)
 . S HL7USID=$$GET1^DIQ(702.09,FILE70209P,.17,"E")
"RTN","MAGDHOWP",125,0)
 . S BIDIRECT=$$GET1^DIQ(702.09,FILE70209P,.13,"I")
"RTN","MAGDHOWP",126,0)
 . Q
"RTN","MAGDHOWP",127,0)
 ;
"RTN","MAGDHOWP",128,0)
 I 'BIDIRECT Q "1,UNIDIRECT" ; no bidirectional instrument
"RTN","MAGDHOWP",129,0)
 ;
"RTN","MAGDHOWP",130,0)
 ; get CP's HL7 Universal Service Identifier from the transaction
"RTN","MAGDHOWP",131,0)
 ; the transaction is created at check-in; there is none for order release
"RTN","MAGDHOWP",132,0)
 S FILE702P=$O(^MDD(702,"ACON",GMRCIEN,""),-1) ; get last transaction
"RTN","MAGDHOWP",133,0)
 I FILE702P D  ; CP transaction exists
"RTN","MAGDHOWP",134,0)
 . S FILE70209P=$$GET1^DIQ(702,FILE702P,.11,"I") Q:'FILE70209P
"RTN","MAGDHOWP",135,0)
 . S HL7USID=$$GET1^DIQ(702.09,FILE70209P,.17,"E")
"RTN","MAGDHOWP",136,0)
 . Q
"RTN","MAGDHOWP",137,0)
 ; 
"RTN","MAGDHOWP",138,0)
 S STATUS=$$GET1^DIQ(123,GMRCIEN,8,"I")
"RTN","MAGDHOWP",139,0)
 S TAG="IEN"_$TR($J(STATUS,2)," ",0)
"RTN","MAGDHOWP",140,0)
 S MCODE=$T(@TAG)
"RTN","MAGDHOWP",141,0)
 Q $S($P(MCODE,";",3)="U":"2,UNFINISHED",1:"3,FINISHED")
"RTN","MAGDHOWP",142,0)
 ;
"RTN","MAGDHOWP",143,0)
 ; Table of Order Status (from file #100.01)
"RTN","MAGDHOWP",144,0)
 ; IEN ;;F=finished, U=unfinished;name
"RTN","MAGDHOWP",145,0)
IEN01 ;;F;DISCONTINUED
"RTN","MAGDHOWP",146,0)
IEN02 ;;F;COMPLETE
"RTN","MAGDHOWP",147,0)
IEN03 ;;U;HOLD
"RTN","MAGDHOWP",148,0)
IEN04 ;;U;FLAGGED
"RTN","MAGDHOWP",149,0)
IEN05 ;;U;PENDING
"RTN","MAGDHOWP",150,0)
IEN06 ;;U;ACTIVE
"RTN","MAGDHOWP",151,0)
IEN07 ;;F;EXPIRED
"RTN","MAGDHOWP",152,0)
IEN08 ;;U;SCHEDULED
"RTN","MAGDHOWP",153,0)
IEN09 ;;U;PARTIAL RESULTS
"RTN","MAGDHOWP",154,0)
IEN10 ;;U;DELAYED
"RTN","MAGDHOWP",155,0)
IEN11 ;;U;UNRELEASED
"RTN","MAGDHOWP",156,0)
IEN12 ;;F;DISCONTINUED/EDIT
"RTN","MAGDHOWP",157,0)
IEN13 ;;F;CANCELLED
"RTN","MAGDHOWP",158,0)
IEN14 ;;U;LAPSED
"RTN","MAGDHOWP",159,0)
IEN15 ;;U;RENEWED
"RTN","MAGDHOWP",160,0)
IEN99 ;;F;NO STATUS
"RTN","MAGDHOWS")
0^7^B16478502
"RTN","MAGDHOWS",1,0)
MAGDHOWS ;WOIFO/PMK,DAC - Capture Consult/GMRC data ;07 Jun 2018 2:35 PM
"RTN","MAGDHOWS",2,0)
 ;;3.0;IMAGING;**138,174,208**;Mar 19, 2002;Build 6
"RTN","MAGDHOWS",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHOWS",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOWS",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHOWS",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHOWS",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHOWS",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHOWS",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHOWS",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHOWS",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHOWS",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHOWS",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHOWS",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHOWS",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHOWS",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOWS",17,0)
 ;;
"RTN","MAGDHOWS",18,0)
 ; Supported IA #2056 reference $$GET1^DIQ function call
"RTN","MAGDHOWS",19,0)
 ; Supported IA #10103 reference $$HTFN^XLFDT function call
"RTN","MAGDHOWS",20,0)
 ; Supported IA #10103 reference $$NOW^XLFDT function call
"RTN","MAGDHOWS",21,0)
 ; Controlled IA #4110 to read REQUEST/CONSULTATION file (#123)
"RTN","MAGDHOWS",22,0)
 ; Supported IA #10040 to read HOSPITAL LOCATION file (#44)
"RTN","MAGDHOWS",23,0)
 ;
"RTN","MAGDHOWS",24,0)
 ; Called from PROTOCOL called MAGD APPOINTMENT (^ORD(101,...))
"RTN","MAGDHOWS",25,0)
 ; through the scheduling package
"RTN","MAGDHOWS",26,0)
 ;
"RTN","MAGDHOWS",27,0)
 N %,AFTERSTS,APTSCHED,CLINIC,CONSULTM,CUTOFF,DATETIME
"RTN","MAGDHOWS",28,0)
 N DFN,FILLER2,FMDATE,FMDATETM
"RTN","MAGDHOWS",29,0)
 N GMRCIEN,HIT,I,IREQ,MSGTYPE
"RTN","MAGDHOWS",30,0)
 N ORCTRL,ORSTATUS,SDAMDFN,SENDIT,SERVICE,SS,STATUS,UNKNOWN,X,Y,Z
"RTN","MAGDHOWS",31,0)
 ;
"RTN","MAGDHOWS",32,0)
 Q:$P($G(SDATA("AFTER","STATUS")),"^",3)=""  ; Not a valid appointment
"RTN","MAGDHOWS",33,0)
 ;
"RTN","MAGDHOWS",34,0)
 ;
"RTN","MAGDHOWS",35,0)
 S FMDATETM=$$NOW^XLFDT(),FMDATE=FMDATETM\1
"RTN","MAGDHOWS",36,0)
 S CUTOFF=$$HTFM^XLFDT($H-90) ; cutoff date is 90 days ago
"RTN","MAGDHOWS",37,0)
 S DFN=$P(SDATA,"^",2),DATETIME=$P(SDATA,"^",3),CLINIC=$P(SDATA,"^",4)
"RTN","MAGDHOWS",38,0)
 S APTSCHED("CLINIC IEN")=CLINIC,APTSCHED("FM DATETIME")=DATETIME
"RTN","MAGDHOWS",39,0)
 S APTSCHED("CLINIC NAME")=$S(CLINIC:$$GET1^DIQ(44,CLINIC,.01),1:"")
"RTN","MAGDHOWS",40,0)
 S AFTERSTS=SDATA("AFTER","STATUS"),X=$P(AFTERSTS,"^",3)
"RTN","MAGDHOWS",41,0)
 ; appointment management transactions from ^SD(409.63)
"RTN","MAGDHOWS",42,0)
 S FILLER2="" D  Q:FILLER2=""
"RTN","MAGDHOWS",43,0)
 . I X["CHECK IN" S FILLER2="SDAM-CHECKIN" Q
"RTN","MAGDHOWS",44,0)
 . I X["CHECKED IN" S FILLER2="SDAM-CHECKIN" Q
"RTN","MAGDHOWS",45,0)
 . I X["CHECK OUT" S FILLER2="SDAM-CHECKOUT" Q
"RTN","MAGDHOWS",46,0)
 . I X["CHECKED OUT" S FILLER2="SDAM-CHECKOUT" Q
"RTN","MAGDHOWS",47,0)
 . I X["AUTO RE-" S FILLER2="SDAM-SCHEDULED" Q
"RTN","MAGDHOWS",48,0)
 . I X["AUTO-RE" S FILLER2="SDAM-SCHEDULED" Q
"RTN","MAGDHOWS",49,0)
 . I X["ACTION REQUIRED" S FILLER2="SDAM-SCHEDULED" Q
"RTN","MAGDHOWS",50,0)
 . I X["ACT REQ" S FILLER2="SDAM-SCHEDULED" Q
"RTN","MAGDHOWS",51,0)
 . I X["NON-COUNT" S FILLER2="SDAM-SCHEDULED" Q
"RTN","MAGDHOWS",52,0)
 . I X["CANCELLED" S FILLER2="SDAM-CANCELLED" Q
"RTN","MAGDHOWS",53,0)
 . I X["NO-SHOW" S FILLER2="SDAM-CANCELLED" Q
"RTN","MAGDHOWS",54,0)
 . I X["DELETED" S FILLER2="SDAM-CANCELLED" Q
"RTN","MAGDHOWS",55,0)
 . I X["FUTURE" S FILLER2="SDAM-FUTURE" Q
"RTN","MAGDHOWS",56,0)
 . I X["NO ACTION TAKEN" S FILLER2="SDAM-SCHEDULED" Q
"RTN","MAGDHOWS",57,0)
 . I X["NO ACT TAKN" S FILLER2="SDAM-SCHEDULED" Q
"RTN","MAGDHOWS",58,0)
 . I X["INPATIENT" S FILLER2="SDAM-SCHEDULED" Q
"RTN","MAGDHOWS",59,0)
 . ;
"RTN","MAGDHOWS",60,0)
 . W !!,"Unexpected Status: """,X,""" in protocol MAGD APPOINTMENT."
"RTN","MAGDHOWS",61,0)
 . W !,"Please notify Customer Support"
"RTN","MAGDHOWS",62,0)
 . W !!,"Press <Enter> to continue: " R X:$G(DTIME,300)
"RTN","MAGDHOWS",63,0)
 . Q
"RTN","MAGDHOWS",64,0)
 ;
"RTN","MAGDHOWS",65,0)
 ; find the associated consult or procedure request using SD*5.3*478
"RTN","MAGDHOWS",66,0)
 S GMRCIEN="" F I=1:1 D  Q:GMRCIEN  Q:'SDAMDFN
"RTN","MAGDHOWS",67,0)
 . S SS=I_","_DATETIME_","_CLINIC
"RTN","MAGDHOWS",68,0)
 . S SDAMDFN=$$GET1^DIQ(44.003,SS,.01,"I")
"RTN","MAGDHOWS",69,0)
 . I SDAMDFN=DFN S GMRCIEN=$$GET1^DIQ(44.003,SS,688,"I")
"RTN","MAGDHOWS",70,0)
 . Q
"RTN","MAGDHOWS",71,0)
 ;
"RTN","MAGDHOWS",72,0)
 I GMRCIEN D  ; consult linked to appointment
"RTN","MAGDHOWS",73,0)
 . N GMRCSTATUS ; P174 DAC - link appointments only to active consults, ignore the rest
"RTN","MAGDHOWS",74,0)
 . N CPINVOCATION ; P208 PMK 4/18/2018
"RTN","MAGDHOWS",75,0)
 . I $$CPORDER^MAGDHOWP(GMRCIEN)="2,UNFINISHED" Q  ; don't generate HL7 for new CP orders - P208 PMK 4/24/18
"RTN","MAGDHOWS",76,0)
 . S CPINVOCATION=0 ; Clinical Procedures exam HL7 flag (set to 1 in MAGDHOWP) P208 PMK 4/18/18
"RTN","MAGDHOWS",77,0)
 . S GMRCSTATUS=$$GET1^DIQ(123,GMRCIEN,8,"E")
"RTN","MAGDHOWS",78,0)
 . I "^ACTIVE^PENDING^RENEWED^SCHEDULED^"[("^"_GMRCSTATUS_"^") D
"RTN","MAGDHOWS",79,0)
 . . S SERVICE=$$GET1^DIQ(123,GMRCIEN,1,"I")
"RTN","MAGDHOWS",80,0)
 . . D MSGSETUP^MAGDHOW1(GMRCIEN,SERVICE,"XO","SC",.APTSCHED)
"RTN","MAGDHOWS",81,0)
 . . Q
"RTN","MAGDHOWS",82,0)
 . Q
"RTN","MAGDHOWS",83,0)
 Q
"RTN","MAGDHPS")
0^10^B70563563
"RTN","MAGDHPS",1,0)
MAGDHPS ;WOIFO/MLH - Maintain subscriptions to Rad HL7 drivers ;25 Sep 2018 9:47 AM
"RTN","MAGDHPS",2,0)
 ;;3.0;IMAGING;**49,183,208**;Mar 19, 2002;Build 6;Apr 07, 2011
"RTN","MAGDHPS",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHPS",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHPS",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHPS",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHPS",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHPS",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHPS",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHPS",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHPS",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHPS",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHPS",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHPS",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHPS",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHPS",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHPS",17,0)
 ;;
"RTN","MAGDHPS",18,0)
 ; Supported IA #1373 -- accessing ^ORD(101,"B" & ^ORD(101,D0,"775" (including the "B" xref under 775)
"RTN","MAGDHPS",19,0)
 Q
"RTN","MAGDHPS",20,0)
 ;
"RTN","MAGDHPS",21,0)
MAGIP208 ; post install entry point to set subscriptions to V2.4 Radiology
"RTN","MAGDHPS",22,0)
 N MAG30P208 ; special variable to control non-intractive mode
"RTN","MAGDHPS",23,0)
 S MAG30P208=1
"RTN","MAGDHPS",24,0)
 ; 
"RTN","MAGDHPS",25,0)
MAINT ; MAIN ENTRY POINT - allow the user to select the version of HL7
"RTN","MAGDHPS",26,0)
 ; that will be used to create Radiology messages to the VistA Text/
"RTN","MAGDHPS",27,0)
 ; DICOM Gateway and to commercial imaging systems.
"RTN","MAGDHPS",28,0)
 ; 
"RTN","MAGDHPS",29,0)
 N MAGPIX ; --- protocol index, either MAGPIXO or MAGPIXR
"RTN","MAGDHPS",30,0)
 N MAGPIXO ; -- protocol index for MAGD SEND ORM
"RTN","MAGDHPS",31,0)
 N MAGPIXR ; -- protocol index for MAGD SEND ORU
"RTN","MAGDHPS",32,0)
 N RADPSTR ; -- Radiology protocol name string
"RTN","MAGDHPS",33,0)
 N I ; -------- scratch index variable
"RTN","MAGDHPS",34,0)
 N RADPA ; ---- array containing Radiology protocol names and IENs
"RTN","MAGDHPS",35,0)
 N RADPEX ; --- exception flag for Radiology protocol name processing
"RTN","MAGDHPS",36,0)
 N RADPI ; ---- Radiology protocol IEN
"RTN","MAGDHPS",37,0)
 N DA,DIC,DIK,DIR,DTOUT,DUOUT,X,Y ; -- FileMan work variables
"RTN","MAGDHPS",38,0)
 N HL7VER ; --- HL7 version desired 
"RTN","MAGDHPS",39,0)
 ;
"RTN","MAGDHPS",40,0)
 W !!,"This option is used to set the Radiology HL7 version for the DICOM Text Gateway."
"RTN","MAGDHPS",41,0)
 W !,"The HL7 v2.4 is the default and is recommended because it provides more data."
"RTN","MAGDHPS",42,0)
 ; Are there a MAGD SEND ORM and MAGD SEND ORU protocols for us to subscribe?
"RTN","MAGDHPS",43,0)
 S MAGPIXO=$O(^ORD(101,"B","MAGD SEND ORM",0))
"RTN","MAGDHPS",44,0)
 I MAGPIXO D  ; yes
"RTN","MAGDHPS",45,0)
 . U IO(0) W !!,"MAGD SEND ORM protocol found..."
"RTN","MAGDHPS",46,0)
 . Q
"RTN","MAGDHPS",47,0)
 E  D  G ABEND  ; no, bail
"RTN","MAGDHPS",48,0)
 . U IO(0) W !!,"ATTENTION:  The MAGD SEND ORM protocol does not exist"
"RTN","MAGDHPS",49,0)
 . W !,"on this system."
"RTN","MAGDHPS",50,0)
 . Q
"RTN","MAGDHPS",51,0)
 ;
"RTN","MAGDHPS",52,0)
 S MAGPIXR=$O(^ORD(101,"B","MAGD SEND ORU",0))
"RTN","MAGDHPS",53,0)
 I MAGPIXR D  ; yes
"RTN","MAGDHPS",54,0)
 . U IO(0) W !,"MAGD SEND ORU protocol found...",!
"RTN","MAGDHPS",55,0)
 . Q
"RTN","MAGDHPS",56,0)
 E  D  G ABEND  ; no, bail
"RTN","MAGDHPS",57,0)
 . U IO(0) W !!,"ATTENTION:  The MAGD SEND ORU protocol does not exist"
"RTN","MAGDHPS",58,0)
 . W !,"on this system."
"RTN","MAGDHPS",59,0)
 . Q
"RTN","MAGDHPS",60,0)
 ;
"RTN","MAGDHPS",61,0)
 ; Make sure we have all the Radiology protocols we need.
"RTN","MAGDHPS",62,0)
 S RADPSTR="RA CANCEL^RA EXAMINED^RA REG^RA RPT"
"RTN","MAGDHPS",63,0)
 F I=1:1:4 S RADPA(I,0)=$P(RADPSTR,"^",I),RADPA(I+4,0)=RADPA(I,0)_" 2.3",RADPA(I+8,0)=RADPA(I,0)_" 2.4"
"RTN","MAGDHPS",64,0)
 S RADPEX=0
"RTN","MAGDHPS",65,0)
 F I=1:1:12 D  G ABEND:RADPEX
"RTN","MAGDHPS",66,0)
 . U IO(0) W !,RADPA(I,0)_" protocol "
"RTN","MAGDHPS",67,0)
 . S RADPI=$O(^ORD(101,"B",RADPA(I,0),0))
"RTN","MAGDHPS",68,0)
 . I RADPI D
"RTN","MAGDHPS",69,0)
 . . U IO(0) W "found..."
"RTN","MAGDHPS",70,0)
 . . S RADPA(I,1)=RADPI
"RTN","MAGDHPS",71,0)
 . . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXO)) W ?35," MAGD SEND ORM subscribed "
"RTN","MAGDHPS",72,0)
 . . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXR)) W ?35," MAGD SEND ORU subscribed"
"RTN","MAGDHPS",73,0)
 . . Q
"RTN","MAGDHPS",74,0)
 . E  D
"RTN","MAGDHPS",75,0)
 . . U IO(0) W "not found..."
"RTN","MAGDHPS",76,0)
 . . S RADPEX=1
"RTN","MAGDHPS",77,0)
 . . Q
"RTN","MAGDHPS",78,0)
 . Q
"RTN","MAGDHPS",79,0)
 ;
"RTN","MAGDHPS",80,0)
 I $G(MAG30P208) S HL7VER=2.4 ; default for MAG*3.0*208 post install
"RTN","MAGDHPS",81,0)
 E  D  G END:$D(DTOUT),END:$D(DUOUT)
"RTN","MAGDHPS",82,0)
 . ; Find out which version of HL7 they want to send.
"RTN","MAGDHPS",83,0)
 . S DIR(0)="SAX^2.1:HL7 Version 2.1;2.3:HL7 Version 2.3;2.4:HL7 Version 2.4 - Highly Recommended"
"RTN","MAGDHPS",84,0)
 . S DIR("A")="Enter the desired version of HL7: "
"RTN","MAGDHPS",85,0)
 . U IO(0) W !
"RTN","MAGDHPS",86,0)
 . D ^DIR I $D(DTOUT)!$D(DUOUT) Q
"RTN","MAGDHPS",87,0)
 . S HL7VER=Y
"RTN","MAGDHPS",88,0)
 . Q
"RTN","MAGDHPS",89,0)
 ;
"RTN","MAGDHPS",90,0)
 U IO(0) W !,"Subscribing to HL7 version "_HL7VER_" Radiology HL7 protocols..."
"RTN","MAGDHPS",91,0)
 ;
"RTN","MAGDHPS",92,0)
 S RADPEX=0
"RTN","MAGDHPS",93,0)
 I HL7VER=2.1 D  G ABEND:RADPEX
"RTN","MAGDHPS",94,0)
 . ; If 2.1 protocols are already subscribed to, do nothing;
"RTN","MAGDHPS",95,0)
 . ; otherwise, subscribe to them.
"RTN","MAGDHPS",96,0)
 . F I=1:1:4 D  Q:RADPEX
"RTN","MAGDHPS",97,0)
 . . ; associate Imaging and Radiology order and report protocols appropriately
"RTN","MAGDHPS",98,0)
 . . S MAGPIX=$S(I=4:MAGPIXR,1:MAGPIXO)
"RTN","MAGDHPS",99,0)
 . . U IO(0) W !,"   Protocol "_RADPA(I,0)_" "
"RTN","MAGDHPS",100,0)
 . . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIX)) D
"RTN","MAGDHPS",101,0)
 . . . W "is already subscribed to, no action taken"
"RTN","MAGDHPS",102,0)
 . . . Q
"RTN","MAGDHPS",103,0)
 . . E  D ADD(MAGPIX,RADPA(I,1),.RADPEX)
"RTN","MAGDHPS",104,0)
 . . W "..."
"RTN","MAGDHPS",105,0)
 . . Q
"RTN","MAGDHPS",106,0)
 . ; If 2.3 or 2.4 protocols are currently subscribed to, unsubscribe from them;
"RTN","MAGDHPS",107,0)
 . ; otherwise, do nothing.
"RTN","MAGDHPS",108,0)
 . F I=5:1:12 D
"RTN","MAGDHPS",109,0)
 . . ; associate Imaging and Radiology order and report protocols appropriately
"RTN","MAGDHPS",110,0)
 . . ; S MAGPIX=$S(I=8:MAGPIXR,1:MAGPIXO)
"RTN","MAGDHPS",111,0)
 . . U IO(0) W !,"   Protocol "_RADPA(I,0)_" "
"RTN","MAGDHPS",112,0)
 . . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXO)) D
"RTN","MAGDHPS",113,0)
 . . . D KILL(MAGPIXO,RADPA(I,1))
"RTN","MAGDHPS",114,0)
 . . . Q
"RTN","MAGDHPS",115,0)
 . . E  I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXR)) D
"RTN","MAGDHPS",116,0)
 . . . D KILL(MAGPIXR,RADPA(I,1))
"RTN","MAGDHPS",117,0)
 . . . Q
"RTN","MAGDHPS",118,0)
 . . E  D
"RTN","MAGDHPS",119,0)
 . . . W "is not currently subscribed to, no action taken"
"RTN","MAGDHPS",120,0)
 . . . Q
"RTN","MAGDHPS",121,0)
 . . W "..."
"RTN","MAGDHPS",122,0)
 . . Q
"RTN","MAGDHPS",123,0)
 . Q
"RTN","MAGDHPS",124,0)
 ;
"RTN","MAGDHPS",125,0)
 I HL7VER=2.3 D  G ABEND:RADPEX
"RTN","MAGDHPS",126,0)
 . ; If 2.1 or 2.4 protocols are currently subscribed to, unsubscribe from them;
"RTN","MAGDHPS",127,0)
 . ; otherwise, do nothing.
"RTN","MAGDHPS",128,0)
 . F I=1:1:4,9:1:12 D
"RTN","MAGDHPS",129,0)
 . . ; associate Imaging and Radiology order and report protocols appropriately
"RTN","MAGDHPS",130,0)
 . . ; S MAGPIX=$S(I=4:MAGPIXR,1:MAGPIXO)
"RTN","MAGDHPS",131,0)
 . . U IO(0) W !,"   Protocol "_RADPA(I,0)_" "
"RTN","MAGDHPS",132,0)
 . . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXO)) D
"RTN","MAGDHPS",133,0)
 . . . D KILL(MAGPIXO,RADPA(I,1))
"RTN","MAGDHPS",134,0)
 . . . Q
"RTN","MAGDHPS",135,0)
 . . E  I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXR)) D
"RTN","MAGDHPS",136,0)
 . . . D KILL(MAGPIXR,RADPA(I,1))
"RTN","MAGDHPS",137,0)
 . . . Q
"RTN","MAGDHPS",138,0)
 . . E  D
"RTN","MAGDHPS",139,0)
 . . . W "is not currently subscribed to, no action taken"
"RTN","MAGDHPS",140,0)
 . . . Q
"RTN","MAGDHPS",141,0)
 . . W "..."
"RTN","MAGDHPS",142,0)
 . . Q
"RTN","MAGDHPS",143,0)
 . ; If 2.3 protocols are already subscribed to, do nothing;
"RTN","MAGDHPS",144,0)
 . ; otherwise, subscribe to them.
"RTN","MAGDHPS",145,0)
 . F I=5:1:8 D  Q:RADPEX
"RTN","MAGDHPS",146,0)
 . . ; associate Imaging and Radiology order and report protocols appropriately
"RTN","MAGDHPS",147,0)
 . . S MAGPIX=$S(I=8:MAGPIXR,1:MAGPIXO)
"RTN","MAGDHPS",148,0)
 . . U IO(0) W !,"   Protocol "_RADPA(I,0)_" "
"RTN","MAGDHPS",149,0)
 . . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIX)) D
"RTN","MAGDHPS",150,0)
 . . . W "is already subscribed to, no action taken"
"RTN","MAGDHPS",151,0)
 . . . Q
"RTN","MAGDHPS",152,0)
 . . E  D ADD(MAGPIX,RADPA(I,1),.RADPEX)
"RTN","MAGDHPS",153,0)
 . . W "..."
"RTN","MAGDHPS",154,0)
 . . Q
"RTN","MAGDHPS",155,0)
 . Q
"RTN","MAGDHPS",156,0)
 ;
"RTN","MAGDHPS",157,0)
 I HL7VER=2.4 D  G ABEND:RADPEX
"RTN","MAGDHPS",158,0)
 . ; If 2.1 or 2.3 protocols are currently subscribed to, unsubscribe from them;
"RTN","MAGDHPS",159,0)
 . ; otherwise, do nothing.
"RTN","MAGDHPS",160,0)
 . F I=1:1:8 D
"RTN","MAGDHPS",161,0)
 . . ; associate Imaging and Radiology order and report protocols appropriately
"RTN","MAGDHPS",162,0)
 . . ; S MAGPIX=$S(I=4:MAGPIXR,1:MAGPIXO)
"RTN","MAGDHPS",163,0)
 . . U IO(0) W !,"   Protocol "_RADPA(I,0)_" "
"RTN","MAGDHPS",164,0)
 . . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXO)) D
"RTN","MAGDHPS",165,0)
 . . . D KILL(MAGPIXO,RADPA(I,1))
"RTN","MAGDHPS",166,0)
 . . . Q
"RTN","MAGDHPS",167,0)
 . . E  I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXR)) D
"RTN","MAGDHPS",168,0)
 . . . D KILL(MAGPIXR,RADPA(I,1))
"RTN","MAGDHPS",169,0)
 . . . Q
"RTN","MAGDHPS",170,0)
 . . E  D
"RTN","MAGDHPS",171,0)
 . . . W "is not currently subscribed to, no action taken"
"RTN","MAGDHPS",172,0)
 . . . Q
"RTN","MAGDHPS",173,0)
 . . W "..."
"RTN","MAGDHPS",174,0)
 . . Q
"RTN","MAGDHPS",175,0)
 . ; If 2.4 protocols are already subscribed to, do nothing;
"RTN","MAGDHPS",176,0)
 . ; otherwise, subscribe to them.
"RTN","MAGDHPS",177,0)
 . F I=9:1:12 D  Q:RADPEX
"RTN","MAGDHPS",178,0)
 . . ; associate Imaging and Radiology order and report protocols appropriately
"RTN","MAGDHPS",179,0)
 . . S MAGPIX=$S(I=12:MAGPIXR,1:MAGPIXO)
"RTN","MAGDHPS",180,0)
 . . U IO(0) W !,"   Protocol "_RADPA(I,0)_" "
"RTN","MAGDHPS",181,0)
 . . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIX)) D
"RTN","MAGDHPS",182,0)
 . . . W "is already subscribed to, no action taken"
"RTN","MAGDHPS",183,0)
 . . . Q
"RTN","MAGDHPS",184,0)
 . . E  D ADD(MAGPIX,RADPA(I,1),.RADPEX)
"RTN","MAGDHPS",185,0)
 . . W "..."
"RTN","MAGDHPS",186,0)
 . . Q
"RTN","MAGDHPS",187,0)
 . Q
"RTN","MAGDHPS",188,0)
 ;
"RTN","MAGDHPS",189,0)
 ; P208 PMK 9/24/18
"RTN","MAGDHPS",190,0)
 U IO(0)
"RTN","MAGDHPS",191,0)
 W !!,"The MAGD SEND ORU protocol should no longer be a subscriber to the RA RPT *"
"RTN","MAGDHPS",192,0)
 W !,"event drivers. Vestigial MAGD SEND ORU subscribers to the RA RPT, RA RPT 2.3,"
"RTN","MAGDHPS",193,0)
 W !,"and RA RPT 2.4 protocols are now removed.",!
"RTN","MAGDHPS",194,0)
 S I=0 F  S I=$O(RADPA(I)) Q:'I  I RADPA(I,0)?1"RA RPT".E D
"RTN","MAGDHPS",195,0)
 . W !,"Protocol ",RADPA(I,0)," "
"RTN","MAGDHPS",196,0)
 . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXO)) D
"RTN","MAGDHPS",197,0)
 . . D KILL(MAGPIXR,RADPA(I,1))
"RTN","MAGDHPS",198,0)
 . . W "..."
"RTN","MAGDHPS",199,0)
 . . Q
"RTN","MAGDHPS",200,0)
 . E  I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXR)) D
"RTN","MAGDHPS",201,0)
 . . D KILL(MAGPIXR,RADPA(I,1))
"RTN","MAGDHPS",202,0)
 . . W "..."
"RTN","MAGDHPS",203,0)
 . . Q
"RTN","MAGDHPS",204,0)
 . Q
"RTN","MAGDHPS",205,0)
 Q
"RTN","MAGDHPS",206,0)
 ;
"RTN","MAGDHPS",207,0)
 G END
"RTN","MAGDHPS",208,0)
 ; 
"RTN","MAGDHPS",209,0)
ABEND ; exception raised
"RTN","MAGDHPS",210,0)
 U IO(0) W !,"Please contact Imaging Support for further assistance."
"RTN","MAGDHPS",211,0)
END ;
"RTN","MAGDHPS",212,0)
 Q
"RTN","MAGDHPS",213,0)
 ;
"RTN","MAGDHPS",214,0)
ADD(SUB,EVENTDRV,STATFLAG) ; SUBROUTINE - not to be invoked except from within this routine
"RTN","MAGDHPS",215,0)
 ; Subscribe gateway protocol SUB to the Radiology event driver protocol EVENTDRV.
"RTN","MAGDHPS",216,0)
 N Y,DIC,DA,X ; -- Fileman variables
"RTN","MAGDHPS",217,0)
 S DIC="^ORD(101,"_EVENTDRV_",775,",DIC(0)="L",DA(1)=EVENTDRV,X=SUB
"RTN","MAGDHPS",218,0)
 D FILE^DICN
"RTN","MAGDHPS",219,0)
 I Y=-1 S STATFLAG=1
"RTN","MAGDHPS",220,0)
 W $S('$G(STATFLAG):"has been",1:"could not be")_" subscribed to"
"RTN","MAGDHPS",221,0)
 Q
"RTN","MAGDHPS",222,0)
 ;
"RTN","MAGDHPS",223,0)
KILL(SUB,EVENTDRV) ; SUBROUTINE - not to be invoked except from within this routine
"RTN","MAGDHPS",224,0)
 ; Unsubscribe gateway protocol SUB from the Radiology event driver protocol EVENTDRV.
"RTN","MAGDHPS",225,0)
 N DA,DIK ; -- Fileman variables
"RTN","MAGDHPS",226,0)
 S DA(1)=EVENTDRV,DA=$O(^ORD(101,DA(1),775,"B",SUB,0))
"RTN","MAGDHPS",227,0)
 S DIK="^ORD(101,"_EVENTDRV_",775,"
"RTN","MAGDHPS",228,0)
 D ^DIK
"RTN","MAGDHPS",229,0)
 W "has been unsubscribed from"
"RTN","MAGDHPS",230,0)
 Q
"RTN","MAGIP208")
0^8^B6562598
"RTN","MAGIP208",1,0)
MAGIP208 ;WOIFO/PMK - Install code for MAG*3.0*208 ;25 Sep 2018 7:24 AM
"RTN","MAGIP208",2,0)
 ;;3.0;IMAGING;**208**;Mar 19, 2002;Build 6
"RTN","MAGIP208",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIP208",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP208",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIP208",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIP208",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIP208",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIP208",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIP208",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIP208",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIP208",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIP208",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIP208",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIP208",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIP208",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP208",17,0)
 ;;
"RTN","MAGIP208",18,0)
 ; Supported IA #10103 reference $$FMTE^XLFDT function call
"RTN","MAGIP208",19,0)
 ; Supported IA #10103 reference $$NOW^XLFDT function call
"RTN","MAGIP208",20,0)
 ; Supported IA #10141 reference BMES^XPDUTL routine call
"RTN","MAGIP208",21,0)
 ;
"RTN","MAGIP208",22,0)
 ; There are no environment checks here but the MAGIP208 has to be
"RTN","MAGIP208",23,0)
 ; referenced by the "Environment Check Routine" field of the KIDS
"RTN","MAGIP208",24,0)
 ; build so that entry points of the routine are available to the
"RTN","MAGIP208",25,0)
 ; KIDS during all installation phases.
"RTN","MAGIP208",26,0)
 Q
"RTN","MAGIP208",27,0)
 ;
"RTN","MAGIP208",28,0)
 ;+++++ INSTALLATION ERROR HANDLING
"RTN","MAGIP208",29,0)
ERROR ;
"RTN","MAGIP208",30,0)
 S:$D(XPDNM) XPDABORT=1
"RTN","MAGIP208",31,0)
 ;--- Display the messages and store them to the INSTALL file
"RTN","MAGIP208",32,0)
 D DUMP^MAGUERR1(),ABTMSG^MAGKIDS()
"RTN","MAGIP208",33,0)
 Q
"RTN","MAGIP208",34,0)
 ;
"RTN","MAGIP208",35,0)
 ;***** POST-INSTALL CODE
"RTN","MAGIP208",36,0)
POS ;
"RTN","MAGIP208",37,0)
 N CALLBACK
"RTN","MAGIP208",38,0)
 D CLEAR^MAGUERR(1)
"RTN","MAGIP208",39,0)
 ;
"RTN","MAGIP208",40,0)
 W !!!,"Setting DICOM Text Gateway to use Radiology HL7 V2.4 protocols -- PASS 1"
"RTN","MAGIP208",41,0)
 W !!,"Removing MAG SEND ORU subscriber(s) from RA RPT, RA RPT 2.3 and RA RPT 2.4"
"RTN","MAGIP208",42,0)
 D MAGIP208^MAGDHPS ; set the Radiology HL7 V2.4 for MAG SEND ORM
"RTN","MAGIP208",43,0)
 W !!!,"Setting DICOM Text Gateway to use Radiology HL7 V2.4 protocols -- PASS 2"
"RTN","MAGIP208",44,0)
 D MAGIP208^MAGDHPS ; run twice to remove any incorrect settings
"RTN","MAGIP208",45,0)
 ;
"RTN","MAGIP208",46,0)
 ;
"RTN","MAGIP208",47,0)
 ;--- Send the notification e-mail
"RTN","MAGIP208",48,0)
 D BMES^XPDUTL("Post Install Mail Message: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","MAGIP208",49,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGIP208",50,0)
 Q
"RTN","MAGIP208",51,0)
 ;
"RTN","MAGIP208",52,0)
 ;***** PRE-INSTALL CODE
"RTN","MAGIP208",53,0)
PRE ;
"RTN","MAGIP208",54,0)
 Q
"VER")
8.0^22.2
**END**
**END**
