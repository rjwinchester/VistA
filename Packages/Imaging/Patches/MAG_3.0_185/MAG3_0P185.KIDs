KIDS Distribution saved on Jan 24, 2018@16:38:17
VistA Imaging V3.0 Patch 185 - VIX Viewer v2.0 - 01/24/2018 04:38PM
**KIDS**:MAG*3.0*185^

**INSTALL NAME**
MAG*3.0*185
"BLD",3463,0)
MAG*3.0*185^IMAGING^0^3180124^y
"BLD",3463,1,0)
^^29^29^3180124
"BLD",3463,1,1,0)
VistA Imaging V3.0 Patch 185 - VIX Viewer v2.0
"BLD",3463,1,2,0)
 
"BLD",3463,1,3,0)
 
"BLD",3463,1,4,0)
Routines:
"BLD",3463,1,5,0)
MAGIP185    new value = 7630518
"BLD",3463,1,6,0)
MAGGTSYS    new value = 14702469
"BLD",3463,1,7,0)
MAGNAN01    new value = 23870147
"BLD",3463,1,8,0)
MAGNAN02    new value = 15238181
"BLD",3463,1,9,0)
MAGNAN03    new value = 67374239
"BLD",3463,1,10,0)
MAGNAU03    new value = 23753647
"BLD",3463,1,11,0)
MAGNID01    new value = 5509538
"BLD",3463,1,12,0)
MAGNILOG    new value = 4853922
"BLD",3463,1,13,0)
MAGNISET    new value = 4965992
"BLD",3463,1,14,0)
MAGNTRAI    new value = 82064307
"BLD",3463,1,15,0)
MAGNVQ01    new value = 109845219
"BLD",3463,1,16,0)
MAGNVQ02    new value = 21293638
"BLD",3463,1,17,0)
MAGNVQ03    new value = 37899553
"BLD",3463,1,18,0)
MAGNVQ04    new value = 18123604
"BLD",3463,1,19,0)
MAGNVQ05    new value = 6884375
"BLD",3463,1,20,0)
MAGNVQ06    new value = 45830251
"BLD",3463,1,21,0)
MAGNPARM    new value = 14479373
"BLD",3463,1,22,0)
MAGNU001    new value = 14211594
"BLD",3463,1,23,0)
MAGNU002    new value = 5805654
"BLD",3463,1,24,0)
MAGNU003    new value = 39650764
"BLD",3463,1,25,0)
MAGVAG05    new value = 3394973
"BLD",3463,1,26,0)
MAGVIM08    new value = 23870020
"BLD",3463,1,27,0)
 
"BLD",3463,1,28,0)
Please note that routine MAGIP185 is deleted after the KIDS Build is
"BLD",3463,1,29,0)
installed.
"BLD",3463,4,0)
^9.64PA^2005.003^1
"BLD",3463,4,2005.003,0)
2005.003
"BLD",3463,4,2005.003,222)
y^y^f^^^^n
"BLD",3463,4,"B",2005.003,2005.003)

"BLD",3463,6.3)
V3.0p185Build3463
"BLD",3463,"ABNS",0)
^9.66A^^
"BLD",3463,"ABPKG")
y^y^G.IMAGING DEVELOPMENT TEAM@domain.ext
"BLD",3463,"INID")
n^y^n
"BLD",3463,"INIT")
POS^MAGIP185
"BLD",3463,"KRN",0)
^9.67PA^8994^19
"BLD",3463,"KRN",.4,0)
.4
"BLD",3463,"KRN",.401,0)
.401
"BLD",3463,"KRN",.402,0)
.402
"BLD",3463,"KRN",.403,0)
.403
"BLD",3463,"KRN",.5,0)
.5
"BLD",3463,"KRN",.84,0)
.84
"BLD",3463,"KRN",3.6,0)
3.6
"BLD",3463,"KRN",3.8,0)
3.8
"BLD",3463,"KRN",9.2,0)
9.2
"BLD",3463,"KRN",9.8,0)
9.8
"BLD",3463,"KRN",9.8,"NM",0)
^9.68A^22^22
"BLD",3463,"KRN",9.8,"NM",1,0)
MAGIP185^^0^B7630518
"BLD",3463,"KRN",9.8,"NM",2,0)
MAGGTSYS^^0^B14702469
"BLD",3463,"KRN",9.8,"NM",3,0)
MAGNAN01^^0^B23870147
"BLD",3463,"KRN",9.8,"NM",4,0)
MAGNAN02^^0^B15238181
"BLD",3463,"KRN",9.8,"NM",5,0)
MAGNAN03^^0^B67374239
"BLD",3463,"KRN",9.8,"NM",6,0)
MAGNAU03^^0^B23753647
"BLD",3463,"KRN",9.8,"NM",7,0)
MAGNID01^^0^B5509538
"BLD",3463,"KRN",9.8,"NM",8,0)
MAGNILOG^^0^B4853922
"BLD",3463,"KRN",9.8,"NM",9,0)
MAGNISET^^0^B4965992
"BLD",3463,"KRN",9.8,"NM",10,0)
MAGNTRAI^^0^B82064307
"BLD",3463,"KRN",9.8,"NM",11,0)
MAGNVQ01^^0^B109845219
"BLD",3463,"KRN",9.8,"NM",12,0)
MAGNVQ02^^0^B21293638
"BLD",3463,"KRN",9.8,"NM",13,0)
MAGNVQ03^^0^B37899553
"BLD",3463,"KRN",9.8,"NM",14,0)
MAGNVQ04^^0^B18123604
"BLD",3463,"KRN",9.8,"NM",15,0)
MAGNVQ05^^0^B6884375
"BLD",3463,"KRN",9.8,"NM",16,0)
MAGNVQ06^^0^B45830251
"BLD",3463,"KRN",9.8,"NM",17,0)
MAGNPARM^^0^B14479373
"BLD",3463,"KRN",9.8,"NM",18,0)
MAGNU001^^0^B14211594
"BLD",3463,"KRN",9.8,"NM",19,0)
MAGNU002^^0^B5805654
"BLD",3463,"KRN",9.8,"NM",20,0)
MAGNU003^^0^B39650764
"BLD",3463,"KRN",9.8,"NM",21,0)
MAGVAG05^^0^B3394973
"BLD",3463,"KRN",9.8,"NM",22,0)
MAGVIM08^^0^B23870020
"BLD",3463,"KRN",9.8,"NM","B","MAGIP185",1)

"BLD",3463,"KRN",9.8,"NM","B","MAGGTSYS",2)

"BLD",3463,"KRN",9.8,"NM","B","MAGNAN01",3)

"BLD",3463,"KRN",9.8,"NM","B","MAGNAN02",4)

"BLD",3463,"KRN",9.8,"NM","B","MAGNAN03",5)

"BLD",3463,"KRN",9.8,"NM","B","MAGNAU03",6)

"BLD",3463,"KRN",9.8,"NM","B","MAGNID01",7)

"BLD",3463,"KRN",9.8,"NM","B","MAGNILOG",8)

"BLD",3463,"KRN",9.8,"NM","B","MAGNISET",9)

"BLD",3463,"KRN",9.8,"NM","B","MAGNTRAI",10)

"BLD",3463,"KRN",9.8,"NM","B","MAGNVQ01",11)

"BLD",3463,"KRN",9.8,"NM","B","MAGNVQ02",12)

"BLD",3463,"KRN",9.8,"NM","B","MAGNVQ03",13)

"BLD",3463,"KRN",9.8,"NM","B","MAGNVQ04",14)

"BLD",3463,"KRN",9.8,"NM","B","MAGNVQ05",15)

"BLD",3463,"KRN",9.8,"NM","B","MAGNVQ06",16)

"BLD",3463,"KRN",9.8,"NM","B","MAGNPARM",17)

"BLD",3463,"KRN",9.8,"NM","B","MAGNU001",18)

"BLD",3463,"KRN",9.8,"NM","B","MAGNU002",19)

"BLD",3463,"KRN",9.8,"NM","B","MAGNU003",20)

"BLD",3463,"KRN",9.8,"NM","B","MAGVAG05",21)

"BLD",3463,"KRN",9.8,"NM","B","MAGVIM08",22)

"BLD",3463,"KRN",19,0)
19
"BLD",3463,"KRN",19.1,0)
19.1
"BLD",3463,"KRN",101,0)
101
"BLD",3463,"KRN",409.61,0)
409.61
"BLD",3463,"KRN",771,0)
771
"BLD",3463,"KRN",870,0)
870
"BLD",3463,"KRN",8989.51,0)
8989.51
"BLD",3463,"KRN",8989.51,"NM",0)
^9.68A^1^1
"BLD",3463,"KRN",8989.51,"NM",1,0)
MAG USER PREF^^0
"BLD",3463,"KRN",8989.51,"NM","B","MAG USER PREF",1)

"BLD",3463,"KRN",8989.52,0)
8989.52
"BLD",3463,"KRN",8994,0)
8994
"BLD",3463,"KRN",8994,"NM",0)
^9.68A^14^14
"BLD",3463,"KRN",8994,"NM",1,0)
MAGN ANNOT GET IMAGE ANNOT^^0
"BLD",3463,"KRN",8994,"NM",2,0)
MAGN ANNOT GET PSTATE^^0
"BLD",3463,"KRN",8994,"NM",3,0)
MAGN ANNOT GET STUDY^^0
"BLD",3463,"KRN",8994,"NM",4,0)
MAGN ANNOT STORE STUDY^^0
"BLD",3463,"KRN",8994,"NM",5,0)
MAGN DELETE IMAGES BY IEN^^0
"BLD",3463,"KRN",8994,"NM",6,0)
MAGN IMAGE EXIST BY CONTEXT^^0
"BLD",3463,"KRN",8994,"NM",7,0)
MAGN LOG IMAGE ACCESS BY IEN^^0
"BLD",3463,"KRN",8994,"NM",8,0)
MAGN PATIENT IMAGE LIST^^0
"BLD",3463,"KRN",8994,"NM",9,0)
MAGN SET IMAGES PROPS BY IEN^^0
"BLD",3463,"KRN",8994,"NM",10,0)
MAGVA GET ALL NETWORK LOCATION^^0
"BLD",3463,"KRN",8994,"NM",11,0)
MAGN PARAM GET LIST^^0
"BLD",3463,"KRN",8994,"NM",12,0)
MAGN PARAM GET VALUE^^0
"BLD",3463,"KRN",8994,"NM",13,0)
MAGN PARAM SET LIST^^0
"BLD",3463,"KRN",8994,"NM",14,0)
MAGV GET RAD PROVIDER^^0
"BLD",3463,"KRN",8994,"NM","B","MAGN ANNOT GET IMAGE ANNOT",1)

"BLD",3463,"KRN",8994,"NM","B","MAGN ANNOT GET PSTATE",2)

"BLD",3463,"KRN",8994,"NM","B","MAGN ANNOT GET STUDY",3)

"BLD",3463,"KRN",8994,"NM","B","MAGN ANNOT STORE STUDY",4)

"BLD",3463,"KRN",8994,"NM","B","MAGN DELETE IMAGES BY IEN",5)

"BLD",3463,"KRN",8994,"NM","B","MAGN IMAGE EXIST BY CONTEXT",6)

"BLD",3463,"KRN",8994,"NM","B","MAGN LOG IMAGE ACCESS BY IEN",7)

"BLD",3463,"KRN",8994,"NM","B","MAGN PATIENT IMAGE LIST",8)

"BLD",3463,"KRN",8994,"NM","B","MAGN SET IMAGES PROPS BY IEN",9)

"BLD",3463,"KRN",8994,"NM","B","MAGVA GET ALL NETWORK LOCATION",10)

"BLD",3463,"KRN",8994,"NM","B","MAGN PARAM GET LIST",11)

"BLD",3463,"KRN",8994,"NM","B","MAGN PARAM GET VALUE",12)

"BLD",3463,"KRN",8994,"NM","B","MAGN PARAM SET LIST",13)

"BLD",3463,"KRN",8994,"NM","B","MAGV GET RAD PROVIDER",14)

"BLD",3463,"KRN","B",.4,.4)

"BLD",3463,"KRN","B",.401,.401)

"BLD",3463,"KRN","B",.402,.402)

"BLD",3463,"KRN","B",.403,.403)

"BLD",3463,"KRN","B",.5,.5)

"BLD",3463,"KRN","B",.84,.84)

"BLD",3463,"KRN","B",3.6,3.6)

"BLD",3463,"KRN","B",3.8,3.8)

"BLD",3463,"KRN","B",9.2,9.2)

"BLD",3463,"KRN","B",9.8,9.8)

"BLD",3463,"KRN","B",19,19)

"BLD",3463,"KRN","B",19.1,19.1)

"BLD",3463,"KRN","B",101,101)

"BLD",3463,"KRN","B",409.61,409.61)

"BLD",3463,"KRN","B",771,771)

"BLD",3463,"KRN","B",870,870)

"BLD",3463,"KRN","B",8989.51,8989.51)

"BLD",3463,"KRN","B",8989.52,8989.52)

"BLD",3463,"KRN","B",8994,8994)

"BLD",3463,"REQB",0)
^9.611^1^1
"BLD",3463,"REQB",1,0)
MAG*3.0*93^2
"BLD",3463,"REQB","B","MAG*3.0*93",1)

"FIA",2005.003)
IMAGING STUDY ANNOTATION
"FIA",2005.003,0)
^MAG(2005.003,
"FIA",2005.003,0,0)
2005.003
"FIA",2005.003,0,1)
y^y^f^^^^n
"FIA",2005.003,0,10)

"FIA",2005.003,0,11)

"FIA",2005.003,0,"RLRO")

"FIA",2005.003,0,"VR")
3.0^MAG
"FIA",2005.003,2005.003)
0
"FIA",2005.003,2005.0031)
0
"FIA",2005.003,2005.0032)
0
"INIT")
POS^MAGIP185
"IX",2005.003,2005.003,"C",0)
2005.003^C^This is cross reference by PSTATUID,ANNOTATOR^R^^F^IR^W^2005.0031^^^^^LS
"IX",2005.003,2005.003,"C",1)
S ^MAG(2005.003,"C",$E(X,1,64),DA(1),DA)=""
"IX",2005.003,2005.003,"C",2)
K ^MAG(2005.003,"C",$E(X,1,64),DA(1),DA)
"IX",2005.003,2005.003,"C",2.5)
K ^MAG(2005.003,"C")
"IX",2005.003,2005.003,"C",11.1,0)
^.114IA^1^1
"IX",2005.003,2005.003,"C",11.1,1,0)
1^F^2005.0031^.01^64^1^F
"KRN",8989.51,123457,-1)
0^1
"KRN",8989.51,123457,0)
MAG USER PREF^MAG USER PREF^1
"KRN",8989.51,123457,1)
W
"KRN",8989.51,123457,6)
F
"KRN",8989.51,123457,20,0)
^8989.512^2^2^3111012^^^^
"KRN",8989.51,123457,20,1,0)
This parameter holds imaging user preferences by
"KRN",8989.51,123457,20,2,0)
USER, DIVISION and SYSTEM levels.
"KRN",8989.51,123457,30,0)
^8989.513I^3^3
"KRN",8989.51,123457,30,1,0)
10^200
"KRN",8989.51,123457,30,2,0)
15^4
"KRN",8989.51,123457,30,3,0)
20^4.2
"KRN",8994,123458,-1)
0^1
"KRN",8994,123458,0)
MAGN ANNOT GET IMAGE ANNOT^IMAGEL^MAGNAN03^4^R^0^^1
"KRN",8994,123458,1,0)
^^1^1^3170801^
"KRN",8994,123458,1,1,0)
Get image annotations by CPRS context or Image IEN
"KRN",8994,123458,2,0)
^8994.02A^1^1
"KRN",8994,123458,2,1,0)
DATA^1^^1^1
"KRN",8994,123458,2,1,1,0)
^^5^5^3170801^
"KRN",8994,123458,2,1,1,1,0)
ContextID in format:
"KRN",8994,123458,2,1,1,2,0)
e.g. RPT^CPRS^29027^RA^79029185.9998-1
"KRN",8994,123458,2,1,1,3,0)
      RPT^CPRS^4658^TIU^2243408^^^^^^^^1
"KRN",8994,123458,2,1,1,4,0)
      or
"KRN",8994,123458,2,1,1,5,0)
      ^^^MAG^10454
"KRN",8994,123458,2,"B","DATA",1)

"KRN",8994,123458,2,"PARAMSEQ",1,1)

"KRN",8994,123458,3,0)
^^6^6^3170801^
"KRN",8994,123458,3,1,0)
if error MAGRY(0) = 0 ^Error message^
"KRN",8994,123458,3,2,0)
if success MAGRY(0) = 1
"KRN",8994,123458,3,3,0)
           MAGRY(1..n) = NEXT_CONTEXTID | CONTEXTID | 0 or 1 |
"KRN",8994,123458,3,4,0)
                         NEXT_IMAGE | IMAGE IEN  
"KRN",8994,123458,3,5,0)
                         images in format defined in RPC [MAGJ STUDY_DATA] or 
"KRN",8994,123458,3,6,0)
                         [MAG ANNOT GET IMAGE DETAIL], [MAG ANNOT GET IMAGE]
"KRN",8994,123459,-1)
0^2
"KRN",8994,123459,0)
MAGN ANNOT GET PSTATE^GETPSTAT^MAGNAN02^2^R
"KRN",8994,123459,1,0)
^^1^1^3170329^
"KRN",8994,123459,1,1,0)
Returns the list of annotation presentation state
"KRN",8994,123459,2,0)
^8994.02A^1^1
"KRN",8994,123459,2,1,0)
MAGPARAM^2^^1^1
"KRN",8994,123459,2,1,1,0)
^^1^1^3170329^
"KRN",8994,123459,2,1,1,1,0)
List of presentation state UID
"KRN",8994,123459,2,"B","MAGPARAM",1)

"KRN",8994,123459,2,"PARAMSEQ",1,1)

"KRN",8994,123459,3,0)
^^9^9^3170329^
"KRN",8994,123459,3,1,0)
if error found during execution
"KRN",8994,123459,3,2,0)
  MAGRY(0) = Failure status^Error getting values
"KRN",8994,123459,3,3,0)
if success
"KRN",8994,123459,3,4,0)
  MAGRY(0) =  Success status^^Total lines
"KRN",8994,123459,3,5,0)
  MAGRY(1) = header with name of the fields
"KRN",8994,123459,3,6,0)
  MAGRY(3) = "^" delimited pairs with internal and external values of the fields listed in MAGRY(1) 
"KRN",8994,123459,3,7,0)
  MAGRY(n) = "WordProcesingFieldxxx^line value"
"KRN",8994,123459,3,8,0)
  MAGRY(m) = "MultipleField000^fields header"
"KRN",8994,123459,3,9,0)
  MAGRY(m..m+1) = "MultipleField001^fields values listed in MAGRY(m)"
"KRN",8994,123460,-1)
0^3
"KRN",8994,123460,0)
MAGN ANNOT GET STUDY^GET^MAGNAN02^2^R
"KRN",8994,123460,1,0)
^8994.01^1^1^3170329^^^^
"KRN",8994,123460,1,1,0)
Returns the list of study annotations
"KRN",8994,123460,2,0)
^8994.02A^2^2
"KRN",8994,123460,2,1,0)
MAGPARAM^2^^1^1
"KRN",8994,123460,2,1,1,0)
^^1^1^3170329^
"KRN",8994,123460,2,1,1,1,0)
List of studies to being annotated.
"KRN",8994,123460,2,2,0)
MAGFLAGS^1^^^2
"KRN",8994,123460,2,2,1,0)
^8994.021^3^3^3170329^^^^
"KRN",8994,123460,2,2,1,1,0)
D - include deleted annotations 
"KRN",8994,123460,2,2,1,2,0)
U - include all user's annotations
"KRN",8994,123460,2,2,1,3,0)
W - include word processing fields
"KRN",8994,123460,2,"B","MAGFLAGS",2)

"KRN",8994,123460,2,"B","MAGPARAM",1)

"KRN",8994,123460,2,"PARAMSEQ",1,1)

"KRN",8994,123460,2,"PARAMSEQ",2,2)

"KRN",8994,123460,3,0)
^8994.03^9^9^3170329^^^^
"KRN",8994,123460,3,1,0)
if error found during execution
"KRN",8994,123460,3,2,0)
  MAGRY(0) = Failure status^Error getting values
"KRN",8994,123460,3,3,0)
if success
"KRN",8994,123460,3,4,0)
  MAGRY(0) =  Success status^^Total lines
"KRN",8994,123460,3,5,0)
  MAGRY(1) = header with name of the fields
"KRN",8994,123460,3,6,0)
  MAGRY(3) = "^" delimited pairs with internal and external values of the fields listed in MAGRY(1) 
"KRN",8994,123460,3,7,0)
  MAGRY(n) = "WordProcesingFieldxxx^line value"
"KRN",8994,123460,3,8,0)
  MAGRY(m) = "MultipleField000^fields header"
"KRN",8994,123460,3,9,0)
  MAGRY(m..m+1) = "MultipleField001^fields values listed in MAGRY(m)" 
"KRN",8994,123461,-1)
0^4
"KRN",8994,123461,0)
MAGN ANNOT STORE STUDY^STORE^MAGNAN01^2^R
"KRN",8994,123461,1,0)
^8994.01^1^1^3170329^^
"KRN",8994,123461,1,1,0)
Stores the detail of Study Annotation.
"KRN",8994,123461,2,0)
^8994.02A^1^1
"KRN",8994,123461,2,1,0)
MAGPARAM^2^^1^1
"KRN",8994,123461,2,1,1,0)
^8994.021^6^6^3170329^^
"KRN",8994,123461,2,1,1,1,0)
MAGPARAM("STUDY UID")
"KRN",8994,123461,2,1,1,2,0)
MAGPARAM("PSTATE UID"))
"KRN",8994,123461,2,1,1,3,0)
MAGPARAM("NAME")
"KRN",8994,123461,2,1,1,4,0)
MAGPARAM("SOURCE")
"KRN",8994,123461,2,1,1,5,0)
MAGPARAM("TOOL VERSION")
"KRN",8994,123461,2,1,1,6,0)
MAGPARAM(1..n)  Annotation Data (XML/JSON)
"KRN",8994,123461,2,"B","MAGPARAM",1)

"KRN",8994,123461,2,"PARAMSEQ",1,1)

"KRN",8994,123461,3,0)
^8994.03^3^3^3170329^^^^
"KRN",8994,123461,3,1,0)
MAGOUT(0) is defined and its 1st '^'-piece is 0, then an error occurred during execution of the procedure.
"KRN",8994,123461,3,2,0)
MAGOUT(0) = 1 
"KRN",8994,123461,3,3,0)
            0 ^^ error
"KRN",8994,123462,-1)
0^5
"KRN",8994,123462,0)
MAGN DELETE IMAGES BY IEN^DELIMGS^MAGNID01^4^R^0^^1
"KRN",8994,123462,1,0)
^^1^1^3170531^
"KRN",8994,123462,1,1,0)
Delete images by IEN
"KRN",8994,123462,2,0)
^8994.02A^1^1
"KRN",8994,123462,2,1,0)
MAGPARAM^2^^1^1
"KRN",8994,123462,2,1,1,0)
^^1^1^3170531^
"KRN",8994,123462,2,1,1,1,0)
MAGPARAM(1..n)=IMAGE IEN^GROUP DELETE FLAG (0|1)^REASON
"KRN",8994,123462,2,"B","MAGPARAM",1)

"KRN",8994,123462,2,"PARAMSEQ",1,1)

"KRN",8994,123462,3,0)
^^2^2^3170531^
"KRN",8994,123462,3,1,0)
MAGOUT(1..n) = IMAGE IEN^1^SUCCESS 
"KRN",8994,123462,3,2,0)
               IMAGE IEN^0^reason for failure
"KRN",8994,123463,-1)
0^6
"KRN",8994,123463,0)
MAGN IMAGE EXIST BY CONTEXT^IMGEXIST^MAGNVQ02^2^R^^^1
"KRN",8994,123463,1,0)
^8994.01^1^1^3170110^^^^
"KRN",8994,123463,1,1,0)
Check for images by context
"KRN",8994,123463,2,0)
^8994.02A^1^1
"KRN",8994,123463,2,1,0)
DATA^2^^1^1
"KRN",8994,123463,2,1,1,0)
^8994.021^4^4^3170110^^^^
"KRN",8994,123463,2,1,1,1,0)
Array holds contexts in format
"KRN",8994,123463,2,1,1,2,0)
       e.g. RPT^CPRS^29027^RA^i79029185.9998-1
"KRN",8994,123463,2,1,1,3,0)
           or
"KRN",8994,123463,2,1,1,4,0)
            RPT^CPRS^4658^TIU^2243408^^^^^^^^1
"KRN",8994,123463,2,"B","DATA",1)

"KRN",8994,123463,2,"PARAMSEQ",1,1)

"KRN",8994,123463,3,0)
^8994.03^4^4^3170110^^^^
"KRN",8994,123463,3,1,0)
if error @MAGRY@(0) = 0 ^Error message
"KRN",8994,123463,3,2,0)
if success @MAGRY@(0) = 1
"KRN",8994,123463,3,3,0)
           @MAGRY@(1..n) = CONTEXTID | 0 | error message
"KRN",8994,123463,3,4,0)
                           CONTEXTID | 1 | 0 or 1 (has image)
"KRN",8994,123464,-1)
0^7
"KRN",8994,123464,0)
MAGN LOG IMAGE ACCESS BY IEN^LOGACT^MAGNILOG^4^R^0^^1
"KRN",8994,123464,1,0)
^^1^1^3170531^
"KRN",8994,123464,1,1,0)
log an action performed on the image
"KRN",8994,123464,2,0)
^8994.02A^1^1
"KRN",8994,123464,2,1,0)
MAGPARAM^2^^1^1
"KRN",8994,123464,2,1,1,0)
^^2^2^3170531^
"KRN",8994,123464,2,1,1,1,0)
MAGPARAM(0..n)=IMAGE IEN^DATA
"KRN",8994,123464,2,1,1,2,0)
  See MAGGACTION LOG for details on DATA
"KRN",8994,123464,2,"B","MAGPARAM",1)

"KRN",8994,123464,2,"PARAMSEQ",1,1)

"KRN",8994,123464,3,0)
^^2^2^3170531^
"KRN",8994,123464,3,1,0)
MAGOUT(0..n) = IMAGE IEN^1^Ok
"KRN",8994,123464,3,2,0)
               IMAGE IEN^0^reason for failure
"KRN",8994,123465,-1)
0^8
"KRN",8994,123465,0)
MAGN PATIENT IMAGE LIST^IMAGEL^MAGNVQ04^4^R^0^^1
"KRN",8994,123465,1,0)
^^1^1^3170927^
"KRN",8994,123465,1,1,0)
List Images by Patient
"KRN",8994,123465,2,0)
^8994.02A^4^4
"KRN",8994,123465,2,1,0)
IDTYPE^1^^1^1
"KRN",8994,123465,2,1,1,0)
^^1^1^3170927^
"KRN",8994,123465,2,1,1,1,0)
"DFN"or "ICN"
"KRN",8994,123465,2,2,0)
ID1^1^^1^2
"KRN",8994,123465,2,2,1,0)
^^1^1^3170927^
"KRN",8994,123465,2,2,1,1,0)
Patient ID
"KRN",8994,123465,2,3,0)
IMGLESS^1^^0^3
"KRN",8994,123465,2,3,1,0)
^8994.021^1^1^3170927^^
"KRN",8994,123465,2,3,1,1,0)
flag to speed up queries: if=1 (true), just get study-level data
"KRN",8994,123465,2,4,0)
FLAGS^1^^0^4
"KRN",8994,123465,2,4,1,0)
^8994.021^1^1^3170927^^
"KRN",8994,123465,2,4,1,1,0)
for feature use
"KRN",8994,123465,2,"B","FLAGS",4)

"KRN",8994,123465,2,"B","ID1",2)

"KRN",8994,123465,2,"B","IDTYPE",1)

"KRN",8994,123465,2,"B","IMGLESS",3)

"KRN",8994,123465,2,"PARAMSEQ",1,1)

"KRN",8994,123465,2,"PARAMSEQ",2,2)

"KRN",8994,123465,2,"PARAMSEQ",3,3)

"KRN",8994,123465,2,"PARAMSEQ",4,4)

"KRN",8994,123465,3,0)
^^3^3^3170927^
"KRN",8994,123465,3,1,0)
if error MAGRY(0) = 0 ^Error message^
"KRN",8994,123465,3,2,0)
if success MAGRY(0) = 1
"KRN",8994,123465,3,3,0)
           MAGRY(1..n) = images in format defined in RPC [MAGN CPRS IMAGE LIST]
"KRN",8994,123466,-1)
0^9
"KRN",8994,123466,0)
MAGN SET IMAGES PROPS BY IEN^SETIMGS^MAGNISET^2^R^0^^1
"KRN",8994,123466,1,0)
^^1^1^3170531^
"KRN",8994,123466,1,1,0)
Updates one or more image properties by image IEN
"KRN",8994,123466,2,0)
^8994.02A^1^1
"KRN",8994,123466,2,1,0)
MAGPARAM^2^^1^1
"KRN",8994,123466,2,1,1,0)
^^1^1^3170531^
"KRN",8994,123466,2,1,1,1,0)
MAGPARAM(0..n)=IMAGE IEN^Parameter name^Value
"KRN",8994,123466,2,"B","MAGPARAM",1)

"KRN",8994,123466,2,"PARAMSEQ",1,1)

"KRN",8994,123466,3,0)
^^2^2^3170531^
"KRN",8994,123466,3,1,0)
MAGOUT(0..n) = IMAGE IEN^1^Ok
"KRN",8994,123466,3,2,0)
               IMAGE IEN^0^reason for failure
"KRN",8994,123467,-1)
0^10
"KRN",8994,123467,0)
MAGVA GET ALL NETWORK LOCATION^GETNL^MAGVAG05^2^R^0
"KRN",8994,123467,1,0)
^^1^1^3100326^
"KRN",8994,123467,1,1,0)
Returns all records in NETWORK LOCATION file (#2005.2)
"KRN",8994,123467,3,0)
^^6^6^3100326^
"KRN",8994,123467,3,1,0)
 if error found during execution
"KRN",8994,123467,3,2,0)
  MAGRY(0) = Failure status ^ Error getting the list
"KRN",8994,123467,3,3,0)
 if success
"KRN",8994,123467,3,4,0)
  MAGRY(0)    = Success status ^^#CNT - where #CNT is a number of records returned
"KRN",8994,123467,3,5,0)
  MAGRY(1)    = "^" delimited string with all field names in NETWORK LOCATION file (#2005.2)
"KRN",8994,123467,3,6,0)
  MAGRY(2..n) = "^" delimited string with values of fields listed in MAGRY(1) 
"KRN",8994,123468,-1)
0^11
"KRN",8994,123468,0)
MAGN PARAM GET LIST^GPARLIST^MAGNPARM^2^R^0
"KRN",8994,123468,1,0)
^^1^1^3140903^
"KRN",8994,123468,1,1,0)
Get a parameter list values.
"KRN",8994,123468,2,0)
^8994.02A^1^1
"KRN",8994,123468,2,1,0)
MAGPARAM^2^^1^1
"KRN",8994,123468,2,1,1,0)
^^3^3^3140903^
"KRN",8994,123468,2,1,1,1,0)
[MAGPARAM("PARAM")] - parameter name - default "MAG USER PREF"
"KRN",8994,123468,2,1,1,2,0)
[MAGPARAM("FORMAT")]  - I|Q|E|B - default "I" (internal)
"KRN",8994,123468,2,1,1,3,0)
[MAGPARAM("ENTITY")]  - Default "ALL"
"KRN",8994,123468,2,"B","MAGPARAM",1)

"KRN",8994,123468,2,"PARAMSEQ",1,1)

"KRN",8994,123468,3,0)
^^3^3^3140903^
"KRN",8994,123468,3,1,0)
if error MAGRY(0) = Failure status ^ Error message^
"KRN",8994,123468,3,2,0)
if success MAGRY(0) = Success status ^ counter
"KRN",8994,123468,3,3,0)
           MAGRY(1..n) = attribute ^ value
"KRN",8994,123469,-1)
0^12
"KRN",8994,123469,0)
MAGN PARAM GET VALUE^GET1^MAGNPARM^2^R^0
"KRN",8994,123469,1,0)
^^1^1^3140903^
"KRN",8994,123469,1,1,0)
Get a parameter list values.
"KRN",8994,123469,2,0)
^8994.02A^1^1
"KRN",8994,123469,2,1,0)
MAGPARAM^2^^1^1
"KRN",8994,123469,2,1,1,0)
^^3^3^3140903^
"KRN",8994,123469,2,1,1,1,0)
[MAGPARAM("PARAM")] - parameter name - default "MAG USER PREF"
"KRN",8994,123469,2,1,1,2,0)
[MAGPARAM("ENTITY")]  - Default "ALL"
"KRN",8994,123469,2,1,1,3,0)
 MAGPARAM("INSTANCE") 
"KRN",8994,123469,2,"B","MAGPARAM",1)

"KRN",8994,123469,2,"PARAMSEQ",1,1)

"KRN",8994,123469,3,0)
^^3^3^3140903^
"KRN",8994,123469,3,1,0)
if error MAGRY(0) = Failure status ^ Error message^
"KRN",8994,123469,3,2,0)
if success MAGRY(0) = Success status ^^ value
"KRN",8994,123469,3,3,0)
           MAGRY(1..n) = value line 1..n
"KRN",8994,123470,-1)
0^13
"KRN",8994,123470,0)
MAGN PARAM SET LIST^SPARLIST^MAGNPARM^1^R^0
"KRN",8994,123470,1,0)
^^1^1^3140903^
"KRN",8994,123470,1,1,0)
Get a parameter list values.
"KRN",8994,123470,2,0)
^8994.02A^1^1
"KRN",8994,123470,2,1,0)
MAGPARAM^2^^1^1
"KRN",8994,123470,2,1,1,0)
^^5^5^3140903^
"KRN",8994,123470,2,1,1,1,0)
[MAGPARAM("PARAM")] - parameter name - default "MAG USER PREF"
"KRN",8994,123470,2,1,1,2,0)
[MAGPARAM("ENTITY")] - default "USR.`DUZ"
"KRN",8994,123470,2,1,1,3,0)
[MAGPARAM("USER")]   - default DUZ
"KRN",8994,123470,2,1,1,4,0)
 MAGPARAM("INSTANCEnnn")
"KRN",8994,123470,2,1,1,5,0)
 MAGPARAM("VALUEnnn")
"KRN",8994,123470,2,"B","MAGPARAM",1)

"KRN",8994,123470,2,"PARAMSEQ",1,1)

"KRN",8994,123470,3,0)
^^2^2^3140903^
"KRN",8994,123470,3,1,0)
if error MAGRY(0) = Failure status ^ Error message^
"KRN",8994,123470,3,2,0)
if success MAGRY(0) = Success status
"KRN",8994,123471,-1)
0^14
"KRN",8994,123471,0)
MAGV GET RAD PROVIDER^PROVLST^MAGVIM08^2^P
"KRN",8994,123471,1,0)
^8994.01^1^1^3161223^^
"KRN",8994,123471,1,1,0)
Used to get a list of active RA providers.
"KRN",8994,123471,2,0)
^8994.02A^1^1
"KRN",8994,123471,2,1,0)
MAGINPUT^1^50^^1
"KRN",8994,123471,2,1,1,0)
^8994.021^1^1^3161223^^
"KRN",8994,123471,2,1,1,1,0)
Null - Find all  or lookup name of RA provider from PERSON file (#200)
"KRN",8994,123471,2,"B","MAGINPUT",1)

"KRN",8994,123471,2,"PARAMSEQ",1,1)

"KRN",8994,123471,3,0)
^8994.03^4^4^3161223^^
"KRN",8994,123471,3,1,0)
An array is returned in the format:
"KRN",8994,123471,3,2,0)
 
"KRN",8994,123471,3,3,0)
 (0)     line count of array
"KRN",8994,123471,3,4,0)
(1...n) IEN from VA(200^provider name
"MBREQ")
0
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"ORD",20,8989.51)
8989.51;20;;;PAR1E1^XPDTA2;PAR1F1^XPDIA3;PAR1E1^XPDIA3;PAR1F2^XPDIA3;;PAR1DEL^XPDIA3(%)
"ORD",20,8989.51,0)
PARAMETER DEFINITION
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging Release History
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020328^3020328^.5
"PKG",454,22,1,"PAH",1,0)
185^3180124^.5
"PKG",454,22,1,"PAH",1,1,0)
^9.49011^28^28^3180124
"PKG",454,22,1,"PAH",1,1,1,0)
Routines for Patch 185
"PKG",454,22,1,"PAH",1,1,2,0)
 
"PKG",454,22,1,"PAH",1,1,3,0)
Routines:
"PKG",454,22,1,"PAH",1,1,4,0)
MAGIP185    value = 7630518
"PKG",454,22,1,"PAH",1,1,5,0)
MAGGTSYS    value = 14702469
"PKG",454,22,1,"PAH",1,1,6,0)
MAGNAN01    value = 23870147
"PKG",454,22,1,"PAH",1,1,7,0)
MAGNAN02    value = 15238181
"PKG",454,22,1,"PAH",1,1,8,0)
MAGNAN03    value = 67374239
"PKG",454,22,1,"PAH",1,1,9,0)
MAGNAU03    value = 23753647
"PKG",454,22,1,"PAH",1,1,10,0)
MAGNID01    value = 5509538
"PKG",454,22,1,"PAH",1,1,11,0)
MAGNILOG    value = 4853922
"PKG",454,22,1,"PAH",1,1,12,0)
MAGNISET    value = 4965992
"PKG",454,22,1,"PAH",1,1,13,0)
MAGNTRAI    value = 82064307
"PKG",454,22,1,"PAH",1,1,14,0)
MAGNVQ01    value = 109845219
"PKG",454,22,1,"PAH",1,1,15,0)
MAGNVQ02    value = 21293638
"PKG",454,22,1,"PAH",1,1,16,0)
MAGNVQ03    value = 37899553
"PKG",454,22,1,"PAH",1,1,17,0)
MAGNVQ04    value = 18123604
"PKG",454,22,1,"PAH",1,1,18,0)
MAGNVQ05    value = 6884375
"PKG",454,22,1,"PAH",1,1,19,0)
MAGNVQ06    value = 45830251
"PKG",454,22,1,"PAH",1,1,20,0)
MAGNPARM    value = 14479373
"PKG",454,22,1,"PAH",1,1,21,0)
MAGNU001    value = 14211594
"PKG",454,22,1,"PAH",1,1,22,0)
MAGNU002    value = 5805654
"PKG",454,22,1,"PAH",1,1,23,0)
MAGNU003    value = 39650764
"PKG",454,22,1,"PAH",1,1,24,0)
MAGVAG05    value = 3394973
"PKG",454,22,1,"PAH",1,1,25,0)
MAGVIM08    value = 23870020
"PKG",454,22,1,"PAH",1,1,26,0)
 
"PKG",454,22,1,"PAH",1,1,27,0)
Please note that routine MAGIP185 is deleted after the KIDS Build is
"PKG",454,22,1,"PAH",1,1,28,0)
installed.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
22
"RTN","MAGIP185")
0^1^B7630518
"RTN","MAGIP185",1,0)
MAGIP185 ;WOIFO/NST - Install code for MAG*3.0*185 ; 24 Jan 2018 09:15 AM
"RTN","MAGIP185",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 2461;Jan 18, 2012
"RTN","MAGIP185",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIP185",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP185",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIP185",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIP185",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIP185",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIP185",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIP185",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIP185",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIP185",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIP185",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIP185",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIP185",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIP185",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP185",17,0)
 ;;
"RTN","MAGIP185",18,0)
 ; There are no environment checks here but the MAGIP185 has to be
"RTN","MAGIP185",19,0)
 ; referenced by the "Environment Check Routine" field of the KIDS
"RTN","MAGIP185",20,0)
 ; build so that entry points of the routine are available to the
"RTN","MAGIP185",21,0)
 ; KIDS during all installation phases.
"RTN","MAGIP185",22,0)
 Q
"RTN","MAGIP185",23,0)
 ;
"RTN","MAGIP185",24,0)
 ;+++++ INSTALLATION ERROR HANDLING
"RTN","MAGIP185",25,0)
ERROR ;
"RTN","MAGIP185",26,0)
 S:$D(XPDNM) XPDABORT=1
"RTN","MAGIP185",27,0)
 ;--- Display the messages and store them to the INSTALL file
"RTN","MAGIP185",28,0)
 D DUMP^MAGUERR1(),ABTMSG^MAGKIDS()
"RTN","MAGIP185",29,0)
 Q
"RTN","MAGIP185",30,0)
 ;
"RTN","MAGIP185",31,0)
 ;***** POST-INSTALL CODE
"RTN","MAGIP185",32,0)
POS ;
"RTN","MAGIP185",33,0)
 N CALLBACK
"RTN","MAGIP185",34,0)
 D CLEAR^MAGUERR(1)
"RTN","MAGIP185",35,0)
 ;
"RTN","MAGIP185",36,0)
 ;--- Link new remote procedures to the Broker context option.
"RTN","MAGIP185",37,0)
 S CALLBACK="$$ADDRPCS^"_$NA(MAGKIDS1("RPCLSTW^"_$T(+0),"MAG WINDOWS"))
"RTN","MAGIP185",38,0)
 I $$CP^MAGKIDS("MAG ATTACH RPCS P185 WIN",CALLBACK)<0  D ERROR  Q
"RTN","MAGIP185",39,0)
 ;
"RTN","MAGIP185",40,0)
 S CALLBACK="$$ADDRPCS^"_$NA(MAGKIDS1("RPCLSTV^"_$T(+0),"MAG DICOM VISA"))
"RTN","MAGIP185",41,0)
 I $$CP^MAGKIDS("MAG ATTACH RPCS P185 VISA",CALLBACK)<0  D ERROR  Q
"RTN","MAGIP185",42,0)
 ;
"RTN","MAGIP185",43,0)
 ;--- Send the notification e-mail
"RTN","MAGIP185",44,0)
 D BMES^XPDUTL("Post Install Mail Message: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","MAGIP185",45,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGIP185",46,0)
 Q
"RTN","MAGIP185",47,0)
 ;
"RTN","MAGIP185",48,0)
 ;***** PRE-INSTALL CODE
"RTN","MAGIP185",49,0)
PRE ;
"RTN","MAGIP185",50,0)
 Q
"RTN","MAGIP185",51,0)
 ;
"RTN","MAGIP185",52,0)
 ;+++++ LIST OF NEW REMOTE PROCEDURES
"RTN","MAGIP185",53,0)
 ; have a list in format ;;MAG4 IMAGE LIST
"RTN","MAGIP185",54,0)
RPCLSTW ;
"RTN","MAGIP185",55,0)
 ;;MAGN ANNOT GET PSTATE
"RTN","MAGIP185",56,0)
 ;;MAGN ANNOT GET STUDY
"RTN","MAGIP185",57,0)
 ;;MAGN ANNOT GET IMAGE ANNOT
"RTN","MAGIP185",58,0)
 ;;MAGN ANNOT STORE STUDY
"RTN","MAGIP185",59,0)
 ;;MAGN DELETE IMAGES BY IEN
"RTN","MAGIP185",60,0)
 ;;MAGN IMAGE EXIST BY CONTEXT
"RTN","MAGIP185",61,0)
 ;;MAGN LOG IMAGE ACCESS BY IEN
"RTN","MAGIP185",62,0)
 ;;MAGN SET IMAGES PROPS BY IEN
"RTN","MAGIP185",63,0)
 ;;MAGN PATIENT IMAGE LIST
"RTN","MAGIP185",64,0)
 ;;MAGN PARAM GET LIST
"RTN","MAGIP185",65,0)
 ;;MAGN PARAM GET VALUE
"RTN","MAGIP185",66,0)
 ;;MAGN PARAM SET LIST
"RTN","MAGIP185",67,0)
 ;;MAGVA GET ALL NETWORK LOCATION
"RTN","MAGIP185",68,0)
 ;;MAGVA GET A W KL AND AIS BY PK
"RTN","MAGIP185",69,0)
 Q 0
"RTN","MAGIP185",70,0)
 ;
"RTN","MAGIP185",71,0)
 ;+++++ LIST OF NEW REMOTE PROCEDURES
"RTN","MAGIP185",72,0)
 ; have a list in format ;;MAG4 IMAGE LIST
"RTN","MAGIP185",73,0)
RPCLSTV ;
"RTN","MAGIP185",74,0)
 ;;MAGV GET RAD PROVIDER
"RTN","MAGIP185",75,0)
 Q 0
"RTN","MAGGTSYS")
0^2^B14702469
"RTN","MAGGTSYS",1,0)
MAGGTSYS ;WOIFO/GEK/NST - Calls from Imaging windows for System Manager ; 03 Nov 2017 10:51 AM
"RTN","MAGGTSYS",2,0)
 ;;3.0;IMAGING;**59,93,117,185**;Mar 19, 2002;Build 2238;Jul 15, 2011
"RTN","MAGGTSYS",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGTSYS",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTSYS",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGTSYS",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGTSYS",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGTSYS",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGTSYS",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGTSYS",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGTSYS",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGTSYS",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGTSYS",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGTSYS",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGTSYS",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGTSYS",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTSYS",17,0)
 ;;
"RTN","MAGGTSYS",18,0)
 Q
"RTN","MAGGTSYS",19,0)
GETS(MAGRY,NODE,FLAGS) ; USE GETS^DIQ TO GET FIELD VALUES.
"RTN","MAGGTSYS",20,0)
 N MAGWIN,I,CT,Y,NC,MAGOUT,MAGERR,TNC,ZZ,MAGIEN,MAGFILE
"RTN","MAGGTSYS",21,0)
 S MAGRY=$NA(^TMP("MAGNODE",$J))
"RTN","MAGGTSYS",22,0)
 I NODE'?.1"N"1.N S @MAGRY@(0)="Node IEN "_NODE_" invalid"
"RTN","MAGGTSYS",23,0)
 I NODE?1"N"1.N D  Q
"RTN","MAGGTSYS",24,0)
 . N MAGVIEN
"RTN","MAGGTSYS",25,0)
 . S MAGVIEN=$E(NODE,2,999)
"RTN","MAGGTSYS",26,0)
 . D IMGINFO^MAGNVQ03(MAGRY,MAGVIEN)  ; Get P34 report
"RTN","MAGGTSYS",27,0)
 . I $G(@MAGRY@(0)) S @MAGRY@(0)="******    Fields for Image IEN: "_MAGVIEN_"    ******" Q
"RTN","MAGGTSYS",28,0)
 . Q
"RTN","MAGGTSYS",29,0)
 S NODE=+$G(NODE)
"RTN","MAGGTSYS",30,0)
 I 'NODE S NODE=$P(^MAG(2005,0),U,3)
"RTN","MAGGTSYS",31,0)
 S MAGIEN=NODE
"RTN","MAGGTSYS",32,0)
 S MAGWIN=$$BROKER^XWBLIB
"RTN","MAGGTSYS",33,0)
 I 'MAGWIN W !,"MAGIEN","  ",MAGIEN
"RTN","MAGGTSYS",34,0)
 S MAGFILE=$$FILE^MAGGI11(NODE)
"RTN","MAGGTSYS",35,0)
 K @MAGRY
"RTN","MAGGTSYS",36,0)
 S @MAGRY@(0)="******    Fields for "_$S(MAGFILE=2005.1:"DELETED ",1:"")_"Image IEN: "_MAGIEN_"    ******"
"RTN","MAGGTSYS",37,0)
 S I=0,CT=0
"RTN","MAGGTSYS",38,0)
 S FLAGS=$S($L($G(FLAGS)):FLAGS,1:"IERN")
"RTN","MAGGTSYS",39,0)
 I MAGFILE'>0 Q  ; problem getting file number
"RTN","MAGGTSYS",40,0)
 D GETS^DIQ(MAGFILE,MAGIEN,"*",FLAGS,"MAGOUT","MAGERR")
"RTN","MAGGTSYS",41,0)
 ;D GETS^DIQ(MAGFILE,MAGIEN,".01;1;2;2.1;2.2;3;5;6;12","R","MAGOUT","MAGERR")
"RTN","MAGGTSYS",42,0)
 S NC=MAGIEN_","
"RTN","MAGGTSYS",43,0)
 S I="" F  S I=$O(MAGOUT(MAGFILE,NC,I)) Q:I=""  D
"RTN","MAGGTSYS",44,0)
 . S CT=CT+1
"RTN","MAGGTSYS",45,0)
 . I $G(MAGOUT(MAGFILE,NC,I,"I"))=$G(MAGOUT(MAGFILE,NC,I,"E")) D  Q
"RTN","MAGGTSYS",46,0)
 . . S ZZ=I,$E(ZZ,45,999)=" = "_$G(MAGOUT(MAGFILE,NC,I,"E"))
"RTN","MAGGTSYS",47,0)
 . . S @MAGRY@(CT)=ZZ
"RTN","MAGGTSYS",48,0)
 . . ;S @MAGRY@(CT)=I_" = "_MAGOUT(MAGFILE,NC,I,"E") Q
"RTN","MAGGTSYS",49,0)
 . . Q
"RTN","MAGGTSYS",50,0)
 . ;
"RTN","MAGGTSYS",51,0)
 . S ZZ=I,$E(ZZ,25,999)=" = ("_$G(MAGOUT(MAGFILE,NC,I,"I"))_") "
"RTN","MAGGTSYS",52,0)
 . I ($L(ZZ)>44) S ZZ=ZZ_" = "_$G(MAGOUT(MAGFILE,NC,I,"E")) S @MAGRY@(CT)=ZZ Q
"RTN","MAGGTSYS",53,0)
 . I ($L(ZZ)<45) S $E(ZZ,45,999)=" = "_$G(MAGOUT(MAGFILE,NC,I,"E")) S @MAGRY@(CT)=ZZ Q
"RTN","MAGGTSYS",54,0)
 . ;S @MAGRY@(CT)=I_" = ("_$G(MAGOUT(MAGFILE,NC,I,"I"))_") = "_$G(MAGOUT(MAGFILE,NC,I,"E"))
"RTN","MAGGTSYS",55,0)
 . Q
"RTN","MAGGTSYS",56,0)
 I $P($G(^MAG(MAGFILE,MAGIEN,2)),"^",6)=8925 D
"RTN","MAGGTSYS",57,0)
 . K MAGOUT,MAGERR
"RTN","MAGGTSYS",58,0)
 . S CT=CT+1,@MAGRY@(CT)="   ***************   TIU    *************** "
"RTN","MAGGTSYS",59,0)
 . S CT=CT+1,@MAGRY@(CT)="   **** Field Values for TIUDA: "_$P(^MAG(MAGFILE,MAGIEN,2),"^",7)_"  ****"
"RTN","MAGGTSYS",60,0)
 . D GETS^DIQ(8925,$P(^MAG(MAGFILE,MAGIEN,2),"^",7),"*",FLAGS,"MAGOUT","MAGERR")
"RTN","MAGGTSYS",61,0)
 . S NC=$P(^MAG(MAGFILE,MAGIEN,2),"^",7)_","
"RTN","MAGGTSYS",62,0)
 . S I="" F  S I=$O(MAGOUT(8925,NC,I)) Q:I=""  D
"RTN","MAGGTSYS",63,0)
 . . S CT=CT+1
"RTN","MAGGTSYS",64,0)
 . . I $G(MAGOUT(8925,NC,I,"I"))=$G(MAGOUT(8925,NC,I,"E")) D  Q
"RTN","MAGGTSYS",65,0)
 . . . S ZZ=I,$E(ZZ,45,999)=" = "_$G(MAGOUT(8925,NC,I,"E"))
"RTN","MAGGTSYS",66,0)
 . . . S @MAGRY@(CT)=ZZ
"RTN","MAGGTSYS",67,0)
 . . . ;S @MAGRY@(CT)=I_" = "_MAGOUT(MAGFILE,NC,I,"E") Q
"RTN","MAGGTSYS",68,0)
 . . . Q
"RTN","MAGGTSYS",69,0)
 . . ;
"RTN","MAGGTSYS",70,0)
 . . S ZZ=I,$E(ZZ,25,999)=" = ("_$G(MAGOUT(8925,NC,I,"I"))_") "
"RTN","MAGGTSYS",71,0)
 . . I ($L(ZZ)>44) S ZZ=ZZ_" = "_$G(MAGOUT(8925,NC,I,"E")) S @MAGRY@(CT)=ZZ Q
"RTN","MAGGTSYS",72,0)
 . . I ($L(ZZ)<45) S $E(ZZ,45,999)=" = "_$G(MAGOUT(8925,NC,I,"E")) S @MAGRY@(CT)=ZZ Q
"RTN","MAGGTSYS",73,0)
 . . ;S @MAGRY@(CT)=I_" = ("_$G(MAGOUT(MAGFILE,NC,I,"I"))_") = "_$G(MAGOUT(MAGFILE,NC,I,"E"))
"RTN","MAGGTSYS",74,0)
 . . Q
"RTN","MAGGTSYS",75,0)
 . Q
"RTN","MAGGTSYS",76,0)
 Q
"RTN","MAGNAN01")
0^3^B23870147
"RTN","MAGNAN01",1,0)
MAGNAN01 ;WOIFO/NST - IMAGING ANNOTATION UTILITY RPCS ; 28 Jul 2017 11:43 AM
"RTN","MAGNAN01",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 92;Aug 02, 2012
"RTN","MAGNAN01",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNAN01",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNAN01",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNAN01",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNAN01",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNAN01",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNAN01",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNAN01",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNAN01",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNAN01",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNAN01",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNAN01",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNAN01",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNAN01",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNAN01",17,0)
 ;;
"RTN","MAGNAN01",18,0)
 Q
"RTN","MAGNAN01",19,0)
 ;
"RTN","MAGNAN01",20,0)
 ;***** STORES THE DETAIL OF STUDY ANNOTATION
"RTN","MAGNAN01",21,0)
 ;
"RTN","MAGNAN01",22,0)
 ; RPC: MAGN ANNOT STORE STUDY
"RTN","MAGNAN01",23,0)
 ;
"RTN","MAGNAN01",24,0)
 ; .MAGOUT       Reference to a local variable where the results are returned to
"RTN","MAGNAN01",25,0)
 ; .MAGPARAM
"RTN","MAGNAN01",26,0)
 ;    MAGPARAM("STUDY UID")
"RTN","MAGNAN01",27,0)
 ;    MAGPARAM("PSTATE UID")
"RTN","MAGNAN01",28,0)
 ;    MAGPARAM("NAME")
"RTN","MAGNAN01",29,0)
 ;    MAGPARAM("SOURCE")
"RTN","MAGNAN01",30,0)
 ;    MAGPARAM("TOOL VERSION")
"RTN","MAGNAN01",31,0)
 ;    MAGPARAM(1..n)  Annotation Data (XML/JSON)
"RTN","MAGNAN01",32,0)
 ;
"RTN","MAGNAN01",33,0)
 ; Return Values
"RTN","MAGNAN01",34,0)
 ; =============   
"RTN","MAGNAN01",35,0)
 ; MAGOUT(0) is defined and its 1st '^'-piece is 0, then an error
"RTN","MAGNAN01",36,0)
 ;   occurred during execution of the procedure.
"RTN","MAGNAN01",37,0)
 ; MAGOUT(0) = Success status - success 
"RTN","MAGNAN01",38,0)
 ;             Failure status - error
"RTN","MAGNAN01",39,0)
STORE(MAGOUT,MAGPARAM) ;RPC [MAGN ANNOT STORE STUDY]
"RTN","MAGNAN01",40,0)
 N MAGNFDA,MAGNXE,IENS,STUDYIEN,STUDYID,PSTATIEN,PSTATUID,EXIT
"RTN","MAGNAN01",41,0)
 ;
"RTN","MAGNAN01",42,0)
 ; Set input variables
"RTN","MAGNAN01",43,0)
 S STUDYID=$G(MAGPARAM("STUDY UID"))
"RTN","MAGNAN01",44,0)
 S PSTATUID=$G(MAGPARAM("PSTATE UID"))
"RTN","MAGNAN01",45,0)
 ;
"RTN","MAGNAN01",46,0)
 K MAGOUT
"RTN","MAGNAN01",47,0)
 S MAGOUT(0)=$$SETERROR^MAGNU002("")
"RTN","MAGNAN01",48,0)
 I '$G(DUZ) S MAGOUT(0)=$$SETERROR^MAGNU002("No DUZ defined") Q
"RTN","MAGNAN01",49,0)
 I STUDYID="" S MAGOUT(0)=$$SETERROR^MAGNU002("No STUDYID") Q
"RTN","MAGNAN01",50,0)
 I PSTATUID="" S MAGOUT(0)=$$SETERROR^MAGNU002("No PSTATEUID") Q
"RTN","MAGNAN01",51,0)
 S STUDYIEN=$$FIND1^DIC(2005.003,"","X",STUDYID,"","","MAGNXE")
"RTN","MAGNAN01",52,0)
 I $$ISERROR^MAGNU002(.MAGOUT,.MAGNXE) Q   ; Set MAGOUT and quit if error exists
"RTN","MAGNAN01",53,0)
 I 'STUDYIEN D  ; Create Study record
"RTN","MAGNAN01",54,0)
 . S IENS="+1,"
"RTN","MAGNAN01",55,0)
 . S MAGNFDA(2005.003,IENS,.01)=STUDYID
"RTN","MAGNAN01",56,0)
 . D UPDATE^DIE("","MAGNFDA","MAGNIEN","MAGNXE")
"RTN","MAGNAN01",57,0)
 . I $$ISERROR^MAGNU002(.MAGOUT,.MAGNXE) Q
"RTN","MAGNAN01",58,0)
 . ; What is the Image IEN D ENTRY^MAGLOG("MAG ANNOT",$G(DUZ),IEN,"MAG IMAGE ANNOTATION","","1",$G(SOURCE,"CLINIC")) ;log annotation
"RTN","MAGNAN01",59,0)
 . S STUDYIEN=MAGNIEN(1)
"RTN","MAGNAN01",60,0)
 . Q
"RTN","MAGNAN01",61,0)
 ;
"RTN","MAGNAN01",62,0)
 I $D(MAGNXE) Q  ; MAGOUT is aleady set with the error
"RTN","MAGNAN01",63,0)
 ;
"RTN","MAGNAN01",64,0)
 S PSTATIEN=$$FIND1^DIC(2005.0031,","_STUDYIEN_",","X",PSTATUID,"","","MAGNXE")
"RTN","MAGNAN01",65,0)
 I $$ISERROR^MAGNU002(.MAGOUT,.MAGNXE) Q  ; Set MAGOUT and quit if error exists
"RTN","MAGNAN01",66,0)
 ;
"RTN","MAGNAN01",67,0)
 I 'PSTATIEN D  Q  ; Create a new annotation record for the study and quit
"RTN","MAGNAN01",68,0)
 . S PSTATIEN=$$UPDATE(.MAGOUT,STUDYIEN,"+2",.MAGPARAM)
"RTN","MAGNAN01",69,0)
 . Q
"RTN","MAGNAN01",70,0)
 ;
"RTN","MAGNAN01",71,0)
 I $G(MAGPARAM("DELETED")) D  Q
"RTN","MAGNAN01",72,0)
 . S EXIT=$$DELANNOT(.MAGOUT,STUDYIEN,PSTATIEN)
"RTN","MAGNAN01",73,0)
 . Q
"RTN","MAGNAN01",74,0)
 ;
"RTN","MAGNAN01",75,0)
 S EXIT=$$UPDATE(.MAGOUT,STUDYIEN,PSTATIEN,.MAGPARAM)
"RTN","MAGNAN01",76,0)
 ; MAGOUT is set at this point
"RTN","MAGNAN01",77,0)
 Q
"RTN","MAGNAN01",78,0)
 ; 
"RTN","MAGNAN01",79,0)
UPDATE(MAGOUT,IEN0,IEN1,MAGPARAM) ; Add new annotation data node w/ DUZ, version, data ...
"RTN","MAGNAN01",80,0)
 N ANNOT,ANSITE,ANSERV,STUDYID,PSTATUID,NAME,SOURCE,VER
"RTN","MAGNAN01",81,0)
 N I,MAGNFDA,MAGNIEN,MAGNXE
"RTN","MAGNAN01",82,0)
 ;
"RTN","MAGNAN01",83,0)
 ; Set input variables
"RTN","MAGNAN01",84,0)
 S PSTATUID=$G(MAGPARAM("PSTATE UID"))
"RTN","MAGNAN01",85,0)
 S NAME=$G(MAGPARAM("NAME"))
"RTN","MAGNAN01",86,0)
 S SOURCE=$G(MAGPARAM("SOURCE"))
"RTN","MAGNAN01",87,0)
 S VER=$G(MAGPARAM("TOOL VERSION"))
"RTN","MAGNAN01",88,0)
 S I=0
"RTN","MAGNAN01",89,0)
 F  S I=$O(MAGPARAM(I)) Q:'I  D
"RTN","MAGNAN01",90,0)
 . S ANNOT(I)=MAGPARAM(I)
"RTN","MAGNAN01",91,0)
 . Q
"RTN","MAGNAN01",92,0)
 ;
"RTN","MAGNAN01",93,0)
 S ANSITE=$G(DUZ(2))  ; Annotation Site
"RTN","MAGNAN01",94,0)
 S ANSERV=$$GET1^DIQ(200,DUZ,29,"E")  ; Annotation service
"RTN","MAGNAN01",95,0)
 ;
"RTN","MAGNAN01",96,0)
 S IENS=IEN1_","_IEN0_","
"RTN","MAGNAN01",97,0)
 S:$E(IEN0)'="+" MAGNIEN(1)=IEN0
"RTN","MAGNAN01",98,0)
 S:$E(IEN1)'="+" MAGNIEN(2)=IEN1
"RTN","MAGNAN01",99,0)
 K MAGNFDA
"RTN","MAGNAN01",100,0)
 S MAGNFDA(2005.0031,IENS,.01)=$G(MAGPARAM("PSTATE UID"))
"RTN","MAGNAN01",101,0)
 S MAGNFDA(2005.0031,IENS,1)=DUZ           ;ANNOTATOR
"RTN","MAGNAN01",102,0)
 S:$D(ANNOT) MAGNFDA(2005.0031,IENS,2)=$$NOW^XLFDT() ;SAVE D/T
"RTN","MAGNAN01",103,0)
 S:VER'="" MAGNFDA(2005.0031,IENS,3)=VER           ;VERSION
"RTN","MAGNAN01",104,0)
 S MAGNFDA(2005.0031,IENS,4)=$G(SOURCE,"CLINIC")
"RTN","MAGNAN01",105,0)
 S MAGNFDA(2005.0031,IENS,7)=$G(ANSERV)     ;SERVICE/SECTION
"RTN","MAGNAN01",106,0)
 S MAGNFDA(2005.0031,IENS,8)=$G(ANSITE)     ;SITE
"RTN","MAGNAN01",107,0)
 S:NAME'="" MAGNFDA(2005.0031,IENS,9)=NAME           ;Annotation name
"RTN","MAGNAN01",108,0)
 D UPDATE^DIE("","MAGNFDA","MAGNIEN","MAGNXE")
"RTN","MAGNAN01",109,0)
 I $$ISERROR^MAGNU002(.MAGOUT,.MAGNXE) Q 0
"RTN","MAGNAN01",110,0)
 ;
"RTN","MAGNAN01",111,0)
 I '$D(ANNOT) Q MAGNIEN(2)
"RTN","MAGNAN01",112,0)
 S IENS=MAGNIEN(2)_","_IEN0_","
"RTN","MAGNAN01",113,0)
 ; Annotation data 2005.003 field #6
"RTN","MAGNAN01",114,0)
 D WP^DIE(2005.0031,IENS,6,"","ANNOT","MAGNXE")
"RTN","MAGNAN01",115,0)
 I $$ISERROR^MAGNU002(.MAGOUT,.MAGNXE) D  Q 0
"RTN","MAGNAN01",116,0)
 . N DA,DIK
"RTN","MAGNAN01",117,0)
 . ; clean up data
"RTN","MAGNAN01",118,0)
 . S DIK="^MAG(2005.003,"_IEN0_",1,",DA=IEN1,DA(1)=IEN0
"RTN","MAGNAN01",119,0)
 . D ^DIK
"RTN","MAGNAN01",120,0)
 . Q
"RTN","MAGNAN01",121,0)
 ;
"RTN","MAGNAN01",122,0)
 Q MAGNIEN(2)
"RTN","MAGNAN01",123,0)
 ;
"RTN","MAGNAN01",124,0)
DELANNOT(MAGOUT,IEN0,IEN1)  ; Set Deleted flag
"RTN","MAGNAN01",125,0)
 N IENS,MAGNFDA,MAGNIEN,MAGNXE
"RTN","MAGNAN01",126,0)
 ;
"RTN","MAGNAN01",127,0)
 S IENS=IEN1_","_IEN0_","
"RTN","MAGNAN01",128,0)
 K MAGNFDA
"RTN","MAGNAN01",129,0)
 S MAGNFDA(2005.0031,IENS,5)=1
"RTN","MAGNAN01",130,0)
 D UPDATE^DIE("","MAGNFDA","MAGNIEN","MAGNXE")
"RTN","MAGNAN01",131,0)
 I $$ISERROR^MAGNU002(.MAGOUT,.MAGNXE) Q 0
"RTN","MAGNAN01",132,0)
 ;
"RTN","MAGNAN01",133,0)
 Q 1
"RTN","MAGNAN02")
0^4^B15238181
"RTN","MAGNAN02",1,0)
MAGNAN02 ;WOIFO/NST - IMAGING ANNOTATION UTILITY RPCS ; 20 Oct 2017 11:43 AM
"RTN","MAGNAN02",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 92;Aug 02, 2012
"RTN","MAGNAN02",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNAN02",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNAN02",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNAN02",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNAN02",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNAN02",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNAN02",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNAN02",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNAN02",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNAN02",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNAN02",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNAN02",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNAN02",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNAN02",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNAN02",17,0)
 ;;
"RTN","MAGNAN02",18,0)
 Q
"RTN","MAGNAN02",19,0)
 ;
"RTN","MAGNAN02",20,0)
 ;***** RETURNS THE LIST OF STUDY ANNOTATIONS
"RTN","MAGNAN02",21,0)
 ;
"RTN","MAGNAN02",22,0)
 ; RPC: MAGN ANNOT GET STUDY
"RTN","MAGNAN02",23,0)
 ;
"RTN","MAGNAN02",24,0)
 ; .MAGOUT       Reference to a local variable where the results
"RTN","MAGNAN02",25,0)
 ;               are returned to.
"RTN","MAGNAN02",26,0)
 ; .MAGPARAM     List of studies to being annotated
"RTN","MAGNAN02",27,0)
 ; [MAGFLAGS]
"RTN","MAGNAN02",28,0)
 ;    D - include deleted annotations 
"RTN","MAGNAN02",29,0)
 ;    U - include all user's annotations
"RTN","MAGNAN02",30,0)
 ;    W - include word processing fields
"RTN","MAGNAN02",31,0)
 ;
"RTN","MAGNAN02",32,0)
 ; Return Values
"RTN","MAGNAN02",33,0)
 ; =============
"RTN","MAGNAN02",34,0)
 ; if error found during execution
"RTN","MAGNAN02",35,0)
 ;   MAGOUT(0) = Failure status^Error getting values
"RTN","MAGNAN02",36,0)
 ; if success
"RTN","MAGNAN02",37,0)
 ;   MAGOUT(0) =  Success status^^Total lines
"RTN","MAGNAN02",38,0)
 ;   MAGOUT(1) = header with name of the fields
"RTN","MAGNAN02",39,0)
 ;   MAGOUT(3) = "^" delimited pairs with internal and external values of the fields listed in MAGOUT(1) 
"RTN","MAGNAN02",40,0)
 ;   MAGOUT(n) = "WordProcesingFieldxxx^line value"
"RTN","MAGNAN02",41,0)
 ;   MAGOUT(m) = "MultipleField000^fields header"
"RTN","MAGNAN02",42,0)
 ;   MAGOUT(m..m+1) = "MultipleField001^fields values listed in MAGOUT(m)" 
"RTN","MAGNAN02",43,0)
 ;
"RTN","MAGNAN02",44,0)
GET(MAGOUT,MAGPARAM,MAGFLAGS) ;RPC [MAGN ANNOT GET STUDY]
"RTN","MAGNAN02",45,0)
 N CNT,ERR,MAGI,MAGNXE,CNT
"RTN","MAGNAN02",46,0)
 N FILE,FIELDS,STUDYID,STUDYIEN
"RTN","MAGNAN02",47,0)
 S MAGFLAGS=$G(MAGFLAGS)
"RTN","MAGNAN02",48,0)
 S MAGOUT(0)=$$SETERROR^MAGNU002("")
"RTN","MAGNAN02",49,0)
 S FILE=2005.003
"RTN","MAGNAN02",50,0)
 S FIELDS="**"
"RTN","MAGNAN02",51,0)
 S MAGI=""
"RTN","MAGNAN02",52,0)
 S CNT=0
"RTN","MAGNAN02",53,0)
 S ERR=0
"RTN","MAGNAN02",54,0)
 F  S MAGI=$O(MAGPARAM(MAGI)) Q:'MAGI  D  Q:ERR
"RTN","MAGNAN02",55,0)
 . S STUDYID=MAGPARAM(MAGI)
"RTN","MAGNAN02",56,0)
 . S STUDYIEN=$$FIND1^DIC(FILE,"","X",STUDYID,"","","MAGNXE")
"RTN","MAGNAN02",57,0)
 . I $$ISERROR^MAGNU002(.MAGOUT,.MAGNXE) S ERR=1 Q
"RTN","MAGNAN02",58,0)
 . I 'STUDYIEN S MAGOUT(0)=$$SETERROR^MAGNU002("Study "_STUDYID_" not found") S ERR=1 Q
"RTN","MAGNAN02",59,0)
 . D GRECBYPK^MAGNAU03(.MAGOUT,2005.003,STUDYIEN,MAGFLAGS,.CNT)
"RTN","MAGNAN02",60,0)
 . Q
"RTN","MAGNAN02",61,0)
 Q
"RTN","MAGNAN02",62,0)
 ;
"RTN","MAGNAN02",63,0)
 ;***** RETURNS THE LIST OF PSTATE ANNOTATIONS
"RTN","MAGNAN02",64,0)
 ;
"RTN","MAGNAN02",65,0)
 ; RPC: MAGN ANNOT GET PSTATE
"RTN","MAGNAN02",66,0)
 ;
"RTN","MAGNAN02",67,0)
 ; .MAGOUT       Reference to a local variable where the results
"RTN","MAGNAN02",68,0)
 ;               are returned to.
"RTN","MAGNAN02",69,0)
 ; .MAGPARAM     List of presentation state UID
"RTN","MAGNAN02",70,0)
 ;
"RTN","MAGNAN02",71,0)
 ; Return Values
"RTN","MAGNAN02",72,0)
 ; =============
"RTN","MAGNAN02",73,0)
 ; if error found during execution
"RTN","MAGNAN02",74,0)
 ;   MAGRY(0) = Failure status^Error getting values
"RTN","MAGNAN02",75,0)
 ; if success
"RTN","MAGNAN02",76,0)
 ;   MAGRY(0) =  Success status^^Total lines
"RTN","MAGNAN02",77,0)
 ;   MAGRY(1) = header with name of the fields
"RTN","MAGNAN02",78,0)
 ;   MAGRY(3) = "^" delimited pairs with internal and external values of the fields listed in MAGRY(1) 
"RTN","MAGNAN02",79,0)
 ;   MAGRY(n) = "WordProcesingFieldxxx^line value"
"RTN","MAGNAN02",80,0)
 ;   MAGRY(m) = "MultipleField000^fields header"
"RTN","MAGNAN02",81,0)
 ;   MAGRY(m..m+1) = "MultipleField001^fields values listed in MAGRY(m)" 
"RTN","MAGNAN02",82,0)
 ;
"RTN","MAGNAN02",83,0)
GETPSTAT(MAGOUT,MAGPARAM)  ;RPC [MAGN ANNOT GET PSTATE]
"RTN","MAGNAN02",84,0)
 N CNT,CNTG,ERR,MAGI,MAGTMP,FILE,FIELDS
"RTN","MAGNAN02",85,0)
 N PSTATEID,PSTATIEN,STUDYIEN
"RTN","MAGNAN02",86,0)
 K MAGOUT
"RTN","MAGNAN02",87,0)
 S MAGOUT(0)=$$SETERROR^MAGNU002("")
"RTN","MAGNAN02",88,0)
 S FILE=2005.0031
"RTN","MAGNAN02",89,0)
 S FIELDS="**"
"RTN","MAGNAN02",90,0)
 S MAGI=""
"RTN","MAGNAN02",91,0)
 S ERR=0
"RTN","MAGNAN02",92,0)
 S CNT=0
"RTN","MAGNAN02",93,0)
 S CNTG=0
"RTN","MAGNAN02",94,0)
 F  S MAGI=$O(MAGPARAM(MAGI)) Q:'MAGI  D  Q:ERR
"RTN","MAGNAN02",95,0)
 . S PSTATEID=MAGPARAM(MAGI)
"RTN","MAGNAN02",96,0)
 . S STUDYIEN=$O(^MAG(2005.003,"C",PSTATEID,0))
"RTN","MAGNAN02",97,0)
 . I 'STUDYIEN K MAGOUT S MAGOUT(0)=$$SETERROR^MAGNU002("Study not found for presentation ID: "_PSTATEID),ERR=1 Q
"RTN","MAGNAN02",98,0)
 . S PSTATIEN=$O(^MAG(2005.003,"C",PSTATEID,STUDYIEN,0))
"RTN","MAGNAN02",99,0)
 . K MAGTMP
"RTN","MAGNAN02",100,0)
 . D GRECBYPK^MAGNAU03(.MAGTMP,2005.0031,PSTATIEN_","_STUDYIEN,"DUW",.CNT)
"RTN","MAGNAN02",101,0)
 . I '$$ISOK^MAGNU002(MAGTMP(0)) K MAGOUT M MAGOUT=MAGTMP S ERR=1 Q
"RTN","MAGNAN02",102,0)
 . S CNTG=CNTG+1
"RTN","MAGNAN02",103,0)
 . D MERGE(.MAGOUT,.MAGTMP,.CNT,CNTG)
"RTN","MAGNAN02",104,0)
 . Q
"RTN","MAGNAN02",105,0)
 S:'ERR MAGOUT(0)=$$SETOKVAL^MAGNU002(CNT)
"RTN","MAGNAN02",106,0)
 Q
"RTN","MAGNAN02",107,0)
 ;
"RTN","MAGNAN02",108,0)
MERGE(MAGOUT,MAGTMP,CNT,CNTG)  ; Merge one result set to final result list
"RTN","MAGNAN02",109,0)
 N J
"RTN","MAGNAN02",110,0)
 S MAGTMP(1)="ANNOTATION GROUP000"_"^"_MAGTMP(1)
"RTN","MAGNAN02",111,0)
 S MAGTMP(2)="ANNOTATION GROUP"_$TR($J(CNTG,3)," ",0)_"^"_MAGTMP(2)
"RTN","MAGNAN02",112,0)
 S J=$S($D(MAGOUT(1)):1,1:0)  ; Start from line 1 
"RTN","MAGNAN02",113,0)
 F  S J=$O(MAGTMP(J)) Q:'J  D
"RTN","MAGNAN02",114,0)
 . S CNT=CNT+1
"RTN","MAGNAN02",115,0)
 . S MAGOUT(CNT)=MAGTMP(J)
"RTN","MAGNAN02",116,0)
 . Q
"RTN","MAGNAN02",117,0)
 Q
"RTN","MAGNAN03")
0^5^B67374239
"RTN","MAGNAN03",1,0)
MAGNAN03 ;WOIFO/NST - Get image annotations ; 21 Dec 2017 3:59 PM
"RTN","MAGNAN03",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 4525;May 01, 2013
"RTN","MAGNAN03",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNAN03",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNAN03",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNAN03",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNAN03",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNAN03",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNAN03",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNAN03",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNAN03",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNAN03",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNAN03",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNAN03",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNAN03",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNAN03",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNAN03",17,0)
 ;;
"RTN","MAGNAN03",18,0)
 Q
"RTN","MAGNAN03",19,0)
 ;
"RTN","MAGNAN03",20,0)
 ;*****  Get image annotations by CPRS context or Image IEN
"RTN","MAGNAN03",21,0)
 ;       
"RTN","MAGNAN03",22,0)
 ; RPC: MAGN ANNOT GET IMAGE ANNOT
"RTN","MAGNAN03",23,0)
 ; 
"RTN","MAGNAN03",24,0)
 ; Input Parameters
"RTN","MAGNAN03",25,0)
 ; ================
"RTN","MAGNAN03",26,0)
 ; 
"RTN","MAGNAN03",27,0)
 ; DATA - ContextID in format
"RTN","MAGNAN03",28,0)
 ;         e.g. 'RPT^CPRS^29027^RA^79029185.9998-1'
"RTN","MAGNAN03",29,0)
 ;                or
"RTN","MAGNAN03",30,0)
 ;               RPT^CPRS^4658^TIU^2243408^^^^^^^^1
"RTN","MAGNAN03",31,0)
 ;                or
"RTN","MAGNAN03",32,0)
 ;                  ^    ^    ^MAG^10454
"RTN","MAGNAN03",33,0)
 ;           
"RTN","MAGNAN03",34,0)
 ; Return Values
"RTN","MAGNAN03",35,0)
 ; =============
"RTN","MAGNAN03",36,0)
 ; 
"RTN","MAGNAN03",37,0)
 ; if error MAGRY(0) = 0 ^Error message^
"RTN","MAGNAN03",38,0)
 ; if success MAGRY(0) = 1
"RTN","MAGNAN03",39,0)
 ;            MAGRY(1..n) = NEXT_CONTEXTID | CONTEXTID | 0 or 1 |
"RTN","MAGNAN03",40,0)
 ;                          NEXT_IMAGE | IMAGE IEN  
"RTN","MAGNAN03",41,0)
 ;                          images in format defined in RPC [MAGJ STUDY_DATA] or 
"RTN","MAGNAN03",42,0)
 ;                          [MAG ANNOT GET IMAGE DETAIL], [MAG ANNOT GET IMAGE]
"RTN","MAGNAN03",43,0)
 ;
"RTN","MAGNAN03",44,0)
IMAGEL(MAGRY,DATA) ;RPC [MAGN ANNOT GET IMAGE ANNOT]
"RTN","MAGNAN03",45,0)
 N MAGNCNT,MAGNX,RARPT
"RTN","MAGNAN03",46,0)
 N $ETRAP,$ESTACK S $ETRAP="D AERRA^MAGGTERR"
"RTN","MAGNAN03",47,0)
 S MAGRY=$NA(^TMP("MAGNTRAI",$J))
"RTN","MAGNAN03",48,0)
 K @MAGRY
"RTN","MAGNAN03",49,0)
 S @MAGRY@(0)=0
"RTN","MAGNAN03",50,0)
 S MAGNCNT=0
"RTN","MAGNAN03",51,0)
 S MAGNX=$P(DATA,"^",4)
"RTN","MAGNAN03",52,0)
 I MAGNX="RA" D  Q
"RTN","MAGNAN03",53,0)
 . D GRAANNCX(MAGRY,MAGNCNT,DATA)  ; get RAD annotations
"RTN","MAGNAN03",54,0)
 . Q
"RTN","MAGNAN03",55,0)
 ;
"RTN","MAGNAN03",56,0)
 I MAGNX="TIU" D  Q
"RTN","MAGNAN03",57,0)
 . D GTUIANN(MAGRY,MAGNCNT,DATA)  ; Get TIU annotations
"RTN","MAGNAN03",58,0)
 . Q
"RTN","MAGNAN03",59,0)
 ;
"RTN","MAGNAN03",60,0)
 I MAGNX="MAG" D  Q
"RTN","MAGNAN03",61,0)
 . D GMAGANN(MAGRY,MAGNCNT,DATA)  ; Get TIU annotations
"RTN","MAGNAN03",62,0)
 . Q
"RTN","MAGNAN03",63,0)
 ;
"RTN","MAGNAN03",64,0)
 S MAGNCNT=MAGNCNT+1
"RTN","MAGNAN03",65,0)
 S @MAGRY@(MAGNCNT)="NEXT_CONTEXTID|"_DATA_"|0|"_"Invalid ContextId Type"
"RTN","MAGNAN03",66,0)
 S @MAGRY@(0)=1
"RTN","MAGNAN03",67,0)
 Q
"RTN","MAGNAN03",68,0)
 ;
"RTN","MAGNAN03",69,0)
GRAANNCX(MAGRY,MAGNCNT,MAGNCXT)  ; Get RAD annotations by CPRS Context ID
"RTN","MAGNAN03",70,0)
 N MAGX,MAGNRPT,DATA
"RTN","MAGNAN03",71,0)
 ;
"RTN","MAGNAN03",72,0)
 S MAGNRPT=$$GRARPT(MAGNCXT) ; Get RA Report IEN by CPRS Context
"RTN","MAGNAN03",73,0)
 S MAGNCNT=MAGNCNT+1
"RTN","MAGNAN03",74,0)
 S @MAGRY@(MAGNCNT)="NEXT_CONTEXTID|"_MAGNCXT_"|"_MAGNRPT_"|RAD"
"RTN","MAGNAN03",75,0)
 I MAGNRPT'>0 Q
"RTN","MAGNAN03",76,0)
 ;
"RTN","MAGNAN03",77,0)
 ; e.g. MAGNCXT=RPT^CPRS^29027^RA^79029185.9998-1
"RTN","MAGNAN03",78,0)
 ; See MAGJEX3
"RTN","MAGNAN03",79,0)
 ; MAGX--TXID ^ DFN ^ DTI ^ CNI ^ RARPT ^ MAGIEN ^ PSDETAIL
"RTN","MAGNAN03",80,0)
 S $P(MAGX,"^",1)=3 ; TXID Key and Interp Images
"RTN","MAGNAN03",81,0)
 S $P(MAGX,"^",2)=$P(MAGNCXT,"^",3) ; DFN
"RTN","MAGNAN03",82,0)
 S $P(MAGX,"^",3)=$P($P(MAGNCXT,"^",5),"-",1)
"RTN","MAGNAN03",83,0)
 S $P(MAGX,"^",4)=$P($P(MAGNCXT,"^",5),"-",2)
"RTN","MAGNAN03",84,0)
 S $P(MAGX,"^",5)=MAGNRPT ; Report IEN
"RTN","MAGNAN03",85,0)
 S $P(MAGX,"^",7)=1 ; PSDETAIL
"RTN","MAGNAN03",86,0)
 ;
"RTN","MAGNAN03",87,0)
 D GRAANN(MAGRY,.MAGNCNT,MAGNCXT,MAGX)
"RTN","MAGNAN03",88,0)
 ;
"RTN","MAGNAN03",89,0)
 ; Get Clinical Annotations
"RTN","MAGNAN03",90,0)
 D GIMGRARP(.DATA,MAGNRPT)
"RTN","MAGNAN03",91,0)
 D GIENANN(MAGRY,.MAGNCNT,MAGNCXT,.DATA)
"RTN","MAGNAN03",92,0)
 Q
"RTN","MAGNAN03",93,0)
 ;
"RTN","MAGNAN03",94,0)
GRAANNRP(MAGRY,MAGNCNT,MAGNCXT,MAGNRPT)  ; Get RAD annotations by RA Report
"RTN","MAGNAN03",95,0)
 N MAGX
"RTN","MAGNAN03",96,0)
 ;
"RTN","MAGNAN03",97,0)
 S MAGNCNT=MAGNCNT+1
"RTN","MAGNAN03",98,0)
 S @MAGRY@(MAGNCNT)="NEXT_CONTEXTID|"_MAGNCXT_"|"_MAGNRPT_"|RAD"
"RTN","MAGNAN03",99,0)
 I MAGNRPT'>0 Q
"RTN","MAGNAN03",100,0)
 ;
"RTN","MAGNAN03",101,0)
 ; e.g. MAGNCXT=^^^MAG^10454
"RTN","MAGNAN03",102,0)
 ; See MAGJEX3
"RTN","MAGNAN03",103,0)
 ; MAGX--TXID ^ DFN ^ DTI ^ CNI ^ RARPT ^ MAGIEN ^ PSDETAIL
"RTN","MAGNAN03",104,0)
 S $P(MAGX,"^",1)=3 ; TXID Key and Interp Images
"RTN","MAGNAN03",105,0)
 S $P(MAGX,"^",2)="" ; DFN
"RTN","MAGNAN03",106,0)
 S $P(MAGX,"^",3)=""
"RTN","MAGNAN03",107,0)
 S $P(MAGX,"^",4)=""
"RTN","MAGNAN03",108,0)
 S $P(MAGX,"^",5)=MAGNRPT ; Report IEN
"RTN","MAGNAN03",109,0)
 S $P(MAGX,"^",7)=1 ; PSDETAIL
"RTN","MAGNAN03",110,0)
 ;
"RTN","MAGNAN03",111,0)
 D GRAANN(MAGRY,.MAGNCNT,MAGNCXT,MAGX)
"RTN","MAGNAN03",112,0)
 Q
"RTN","MAGNAN03",113,0)
 ;
"RTN","MAGNAN03",114,0)
GRAANN(MAGRY,MAGNCNT,MAGNCXT,MAGX) ; Get Radiology study annotations
"RTN","MAGNAN03",115,0)
 N J,MAGOUT
"RTN","MAGNAN03",116,0)
 ; 
"RTN","MAGNAN03",117,0)
 D RPCIN^MAGJEX3(.MAGOUT,MAGX)
"RTN","MAGNAN03",118,0)
 S @MAGRY@(MAGNCNT)="NEXT_CONTEXTID|"_MAGNCXT_"|"_@MAGOUT@(0)_"|RAD"
"RTN","MAGNAN03",119,0)
 S J=0
"RTN","MAGNAN03",120,0)
 F  S J=$O(@MAGOUT@(J)) Q:'J  D
"RTN","MAGNAN03",121,0)
 . S MAGNCNT=MAGNCNT+1
"RTN","MAGNAN03",122,0)
 . S @MAGRY@(MAGNCNT)=@MAGOUT@(J)
"RTN","MAGNAN03",123,0)
 . Q 
"RTN","MAGNAN03",124,0)
 K @MAGOUT
"RTN","MAGNAN03",125,0)
 S @MAGRY@(0)=1
"RTN","MAGNAN03",126,0)
 Q
"RTN","MAGNAN03",127,0)
 ;
"RTN","MAGNAN03",128,0)
GTUIANN(MAGRY,MAGNCNT,MAGNCXT) ;Get TIU annotations 
"RTN","MAGNAN03",129,0)
 N DATA,MAGNTIU
"RTN","MAGNAN03",130,0)
 ;
"RTN","MAGNAN03",131,0)
 S MAGNTIU=$P(MAGNCXT,"^",5)
"RTN","MAGNAN03",132,0)
 D IMAGES^MAGGNTI(.DATA,MAGNTIU) ;  Get all images for TIU
"RTN","MAGNAN03",133,0)
 ;
"RTN","MAGNAN03",134,0)
 D GIENANN(MAGRY,.MAGNCNT,MAGNCXT,.DATA) ;Get annotations for image IEN
"RTN","MAGNAN03",135,0)
 ;
"RTN","MAGNAN03",136,0)
 Q
"RTN","MAGNAN03",137,0)
 ;
"RTN","MAGNAN03",138,0)
GMAGANN(MAGRY,MAGNCNT,MAGNCXT) ; Get study annotations by image ien
"RTN","MAGNAN03",139,0)
 N DATA,MAGIEN,MAGROOT,MAGD0
"RTN","MAGNAN03",140,0)
 ;
"RTN","MAGNAN03",141,0)
 S MAGIEN=$P(MAGNCXT,"^",5)
"RTN","MAGNAN03",142,0)
 S MAGROOT=$$GET1^DIQ(2005,MAGIEN,16)
"RTN","MAGNAN03",143,0)
 S MAGD0=$$GET1^DIQ(2005,MAGIEN,17)
"RTN","MAGNAN03",144,0)
 ; 
"RTN","MAGNAN03",145,0)
 I MAGROOT="TIU" D  Q
"RTN","MAGNAN03",146,0)
 . D IMAGES^MAGGNTI(.DATA,MAGD0) ;  Get all images for TIU
"RTN","MAGNAN03",147,0)
 . D GIENANN(MAGRY,.MAGNCNT,MAGNCXT,.DATA) ;Get annotations for image IEN
"RTN","MAGNAN03",148,0)
 . Q
"RTN","MAGNAN03",149,0)
 ;
"RTN","MAGNAN03",150,0)
 I MAGROOT="RADIOLOGY" D  Q
"RTN","MAGNAN03",151,0)
 . D GRAANNRP(MAGRY,MAGNCNT,MAGNCXT,MAGD0)
"RTN","MAGNAN03",152,0)
 . ; Try to get images in case of Capture (Clinical) annotation
"RTN","MAGNAN03",153,0)
 . D IMAGES(.DATA,MAGIEN)  ; Get Images by Group image IEN
"RTN","MAGNAN03",154,0)
 . D GIENANN(MAGRY,.MAGNCNT,MAGNCXT,.DATA) ;Get annotations for image IEN
"RTN","MAGNAN03",155,0)
 . Q
"RTN","MAGNAN03",156,0)
 ;
"RTN","MAGNAN03",157,0)
 I MAGROOT="" D  ; No report
"RTN","MAGNAN03",158,0)
 . D IMAGES(.DATA,MAGIEN)  ; Get Images by Group image IEN
"RTN","MAGNAN03",159,0)
 . D GIENANN(MAGRY,.MAGNCNT,MAGNCXT,.DATA) ;Get annotations for image IEN
"RTN","MAGNAN03",160,0)
 . Q
"RTN","MAGNAN03",161,0)
 Q
"RTN","MAGNAN03",162,0)
 ;
"RTN","MAGNAN03",163,0)
GRARPT(DATA) ; Get RA Report IEN by CPRS Context
"RTN","MAGNAN03",164,0)
 N DFN,ENT,INVDTTM,INVDT,INVTM,RARPT
"RTN","MAGNAN03",165,0)
 S DFN=+$P(DATA,U,3)
"RTN","MAGNAN03",166,0)
 S ENT=+$P($P(DATA,U,5),"-",2)
"RTN","MAGNAN03",167,0)
 S INVDTTM=$P($P(DATA,U,5),"-",1)
"RTN","MAGNAN03",168,0)
 S INVDT=$P(INVDTTM,".",1)
"RTN","MAGNAN03",169,0)
 S INVTM=$P(INVDTTM,".",2)
"RTN","MAGNAN03",170,0)
 F  Q:($L(INVDT)<8)  S INVDT=$E(INVDT,2,$L(INVDT))
"RTN","MAGNAN03",171,0)
 S INVDTTM=INVDT_"."_INVTM
"RTN","MAGNAN03",172,0)
 S RARPT=0
"RTN","MAGNAN03",173,0)
 I '$D(^RADPT(DFN,"DT",INVDTTM,"P",ENT,0)) Q "0^INVALID Data : Attempt to access Exam failed."
"RTN","MAGNAN03",174,0)
 S RARPT=$P(^RADPT(DFN,"DT",INVDTTM,"P",ENT,0),U,17)
"RTN","MAGNAN03",175,0)
 I 'RARPT Q "0^No Report for selected Exam"
"RTN","MAGNAN03",176,0)
 I $P($G(^RARPT(RARPT,0)),U,2)'=DFN Q "-2^Patient Mismatch. Radiology File"
"RTN","MAGNAN03",177,0)
 Q RARPT
"RTN","MAGNAN03",178,0)
 ;
"RTN","MAGNAN03",179,0)
GIENANN(MAGRY,MAGNCNT,MAGNCXT,DATA) ;Get annotations for image IEN
"RTN","MAGNAN03",180,0)
 ; MAGRY = Output array
"RTN","MAGNAN03",181,0)
 ; MAGNCNT  = initial output counter
"RTN","MAGNAN03",182,0)
 ; MAGNCXT  = Context ID
"RTN","MAGNAN03",183,0)
 ; DATA(0)  = Result output
"RTN","MAGNAN03",184,0)
 ; DATA(1..n) = Image IEN
"RTN","MAGNAN03",185,0)
 ; 
"RTN","MAGNAN03",186,0)
 N J,I,MAGIEN,MAGNTIU,MAGOUT
"RTN","MAGNAN03",187,0)
 ;
"RTN","MAGNAN03",188,0)
 S MAGNCNT=MAGNCNT+1
"RTN","MAGNAN03",189,0)
 S @MAGRY@(MAGNCNT)="NEXT_CONTEXTID|"_MAGNCXT_"|"_DATA(0)_"|CLN"
"RTN","MAGNAN03",190,0)
 I 'DATA(0) Q   ; Error quit
"RTN","MAGNAN03",191,0)
 ;
"RTN","MAGNAN03",192,0)
 S I=0
"RTN","MAGNAN03",193,0)
 F  S I=$O(DATA(I)) Q:'I  D
"RTN","MAGNAN03",194,0)
 . S MAGIEN=$P(DATA(I),"^",2)
"RTN","MAGNAN03",195,0)
 . K MAGOUT
"RTN","MAGNAN03",196,0)
 . ;P122 handles only one type of annotation (Clinic or VistARAD), but not on both 
"RTN","MAGNAN03",197,0)
 . I '$D(^MAG(2005.002,MAGIEN,0)) Q  ; VistA Rad annotations are present. Quit. We need only Clinic
"RTN","MAGNAN03",198,0)
 . D GETD^MAGSANNO(.MAGOUT,MAGIEN)  ; Get annotation details by image IEN
"RTN","MAGNAN03",199,0)
 . S MAGNCNT=MAGNCNT+1
"RTN","MAGNAN03",200,0)
 . S @MAGRY@(MAGNCNT)="NEXT_IMAGE|"_MAGIEN_"|"_MAGOUT(0)
"RTN","MAGNAN03",201,0)
 . I 'MAGOUT(0) Q   ; Error, get next one
"RTN","MAGNAN03",202,0)
 . S J=0
"RTN","MAGNAN03",203,0)
 . F  S J=$O(MAGOUT(J)) Q:'J  D
"RTN","MAGNAN03",204,0)
 . . S MAGNCNT=MAGNCNT+1
"RTN","MAGNAN03",205,0)
 . . S @MAGRY@(MAGNCNT)=MAGOUT(J)
"RTN","MAGNAN03",206,0)
 . . Q
"RTN","MAGNAN03",207,0)
 . Q
"RTN","MAGNAN03",208,0)
 S @MAGRY@(0)=1
"RTN","MAGNAN03",209,0)
 Q
"RTN","MAGNAN03",210,0)
 ;
"RTN","MAGNAN03",211,0)
IMAGES(DATA,MAGIEN) ; Get all Images for a Group Image IEN
"RTN","MAGNAN03",212,0)
 N GROUP
"RTN","MAGNAN03",213,0)
 S GROUP=$$ISGRP^MAGGI11(MAGIEN)
"RTN","MAGNAN03",214,0)
 S DATA(0)=1 ; Set result to okay
"RTN","MAGNAN03",215,0)
 I GROUP D  Q
"RTN","MAGNAN03",216,0)
 . N NO,CH
"RTN","MAGNAN03",217,0)
 . S NO=0
"RTN","MAGNAN03",218,0)
 . F  S NO=$O(^MAG(2005,MAGIEN,1,NO)) Q:'NO  D 
"RTN","MAGNAN03",219,0)
 . . S CH=+$G(^MAG(2005,MAGIEN,1,NO,0))
"RTN","MAGNAN03",220,0)
 . . Q:'CH
"RTN","MAGNAN03",221,0)
 . . S $P(DATA(NO),"^",2)=CH
"RTN","MAGNAN03",222,0)
 . Q
"RTN","MAGNAN03",223,0)
 S $P(DATA(1),"^",2)=MAGIEN
"RTN","MAGNAN03",224,0)
 Q
"RTN","MAGNAN03",225,0)
 ;
"RTN","MAGNAN03",226,0)
GIMGRARP(DATA,RARPT) ; Get list of images by radiology report
"RTN","MAGNAN03",227,0)
 ; RARPT -- Radiology report IEN
"RTN","MAGNAN03",228,0)
 ; and returns a list in DATA(1..n). 
"RTN","MAGNAN03",229,0)
 ;
"RTN","MAGNAN03",230,0)
 N GROUPS,OUT,REQDFN
"RTN","MAGNAN03",231,0)
 ;
"RTN","MAGNAN03",232,0)
 N CT,OI,IGCT,MAGIEN1,MAGQI,MAGX
"RTN","MAGNAN03",233,0)
 K MAGZRY
"RTN","MAGNAN03",234,0)
 S IGCT=+$P($G(^RARPT(RARPT,2005,0)),U,4)
"RTN","MAGNAN03",235,0)
 ; Quit if no images for RARPT
"RTN","MAGNAN03",236,0)
 I IGCT=0 Q 
"RTN","MAGNAN03",237,0)
 ;
"RTN","MAGNAN03",238,0)
 ; Check all Image entries in RARPT 2005 NODE. for Patient match Pointer match, from both 
"RTN","MAGNAN03",239,0)
 ;   RARPT end, and Imaging end.
"RTN","MAGNAN03",240,0)
 S MAGQI=1
"RTN","MAGNAN03",241,0)
 S OI=0,CT=1 F  S OI=$O(^RARPT(RARPT,2005,OI)) Q:'OI  D  Q:(MAGQI<1)
"RTN","MAGNAN03",242,0)
 . S MAGIEN1=$P(^RARPT(RARPT,2005,OI,0),U)
"RTN","MAGNAN03",243,0)
 . ; Assure magdfn = rarpt dfn
"RTN","MAGNAN03",244,0)
 . I $P($G(^RARPT(RARPT,0)),U,2)'=$P($G(^MAG(2005,MAGIEN1,0)),U,7) S MAGQI="-2^Patient Mismatch. Radiology Report" Q
"RTN","MAGNAN03",245,0)
 . ; Assure magien1 is pointing to this rarpt
"RTN","MAGNAN03",246,0)
 . I $P($G(^MAG(2005,MAGIEN1,2)),U,7)'=RARPT S MAGQI="-2^Pointer Mismatch. Radiology Report" Q
"RTN","MAGNAN03",247,0)
 . ; Now run the Imaging integrity check
"RTN","MAGNAN03",248,0)
 . D CHK^MAGGSQI(.MAGX,MAGIEN1) I 'MAGX(0) S MAGQI="-2^"_$P(MAGX(0),U,2,99) Q
"RTN","MAGNAN03",249,0)
 ;
"RTN","MAGNAN03",250,0)
 I MAGQI<1 S DATA(0)=MAGQI Q  ; Integrity error
"RTN","MAGNAN03",251,0)
 S CT=0
"RTN","MAGNAN03",252,0)
 ;
"RTN","MAGNAN03",253,0)
 S OI=0,CT=1 F  S OI=$O(^RARPT(RARPT,2005,OI)) Q:'OI  D
"RTN","MAGNAN03",254,0)
 . S MAGIEN1=$P(^RARPT(RARPT,2005,OI,0),U) S $P(DATA(OI),"^",2)=MAGIEN1
"RTN","MAGNAN03",255,0)
 . Q
"RTN","MAGNAN03",256,0)
 S DATA(0)=1 ; okay result
"RTN","MAGNAN03",257,0)
 Q
"RTN","MAGNAU03")
0^6^B23753647
"RTN","MAGNAU03",1,0)
MAGNAU03 ;WOIFO/NST - Utilities for RPC calls ; 29 Jun 2017 4:16 PM
"RTN","MAGNAU03",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 92;Aug 02, 2012
"RTN","MAGNAU03",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNAU03",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNAU03",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNAU03",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNAU03",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNAU03",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNAU03",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNAU03",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNAU03",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNAU03",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNAU03",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNAU03",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNAU03",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNAU03",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNAU03",17,0)
 ;;
"RTN","MAGNAU03",18,0)
 Q
"RTN","MAGNAU03",19,0)
 ;
"RTN","MAGNAU03",20,0)
 ; ****  Get a record from a file by IEN 
"RTN","MAGNAU03",21,0)
 ; 
"RTN","MAGNAU03",22,0)
 ; Input parameters
"RTN","MAGNAU03",23,0)
 ; ================
"RTN","MAGNAU03",24,0)
 ; 
"RTN","MAGNAU03",25,0)
 ; FILE = FileMan number of the file (e.g. 2005.003)
"RTN","MAGNAU03",26,0)
 ; PK = IEN in the file
"RTN","MAGNAU03",27,0)
 ; FLAGS
"RTN","MAGNAU03",28,0)
 ;    D - exclude deleted annotations 
"RTN","MAGNAU03",29,0)
 ;    U - include all user's annotations
"RTN","MAGNAU03",30,0)
 ;    W - include word processing fields
"RTN","MAGNAU03",31,0)
 ; CNT = First node in output array
"RTN","MAGNAU03",32,0)
 ;
"RTN","MAGNAU03",33,0)
 ; Return Values
"RTN","MAGNAU03",34,0)
 ; =============
"RTN","MAGNAU03",35,0)
 ; if error found during execution
"RTN","MAGNAU03",36,0)
 ;   MAGRY(0) = Failure status^Error getting values
"RTN","MAGNAU03",37,0)
 ; if success
"RTN","MAGNAU03",38,0)
 ;   MAGRY(0) =  Success status^^Total lines
"RTN","MAGNAU03",39,0)
 ;   MAGRY(1) = header with name of the fields
"RTN","MAGNAU03",40,0)
 ;   MAGRY(3) = "^" delimited pairs with internal and external values of the fields listed in MAGRY(1) 
"RTN","MAGNAU03",41,0)
 ;   MAGRY(n) = "WordProcesingFieldxxx^line value"
"RTN","MAGNAU03",42,0)
 ;   MAGRY(m) = "MultipleField000^fields header"
"RTN","MAGNAU03",43,0)
 ;   MAGRY(m..m+1) = "MultipleField001^fields values listed in MAGRY(m)" 
"RTN","MAGNAU03",44,0)
 ;   
"RTN","MAGNAU03",45,0)
GRECBYPK(MAGRY,FILE,PK,FLAGS,CNT) ;
"RTN","MAGNAU03",46,0)
 N FIELDS,FLDSARR,FLDSARRW
"RTN","MAGNAU03",47,0)
 N OUT,ERR,TMPOUT,IENS,CNTSTART
"RTN","MAGNAU03",48,0)
 N I,J,WPTYPE,SUBFILE
"RTN","MAGNAU03",49,0)
 N RESDEL
"RTN","MAGNAU03",50,0)
 S RESDEL=$$RESDEL^MAGNU002()
"RTN","MAGNAU03",51,0)
 S FIELDS=$$GETFLDS^MAGNU001(.FLDSARR,.FLDSARRW,FILE,"") ; file fields names
"RTN","MAGNAU03",52,0)
 S IENS=PK_","
"RTN","MAGNAU03",53,0)
 D GETS^DIQ(FILE,PK_",","**","IE","OUT","ERR")
"RTN","MAGNAU03",54,0)
 ;
"RTN","MAGNAU03",55,0)
 I $$ISERROR^MAGNU002(.MAGRY,.ERR) Q   ; Set MAGOUT and quit if error exists
"RTN","MAGNAU03",56,0)
 ;
"RTN","MAGNAU03",57,0)
 ; Output the data
"RTN","MAGNAU03",58,0)
 S CNT=CNT+2 ; 1 is for the header, 2 is the first record with values
"RTN","MAGNAU03",59,0)
 S CNTSTART=CNT
"RTN","MAGNAU03",60,0)
 S MAGRY(CNT)=PK
"RTN","MAGNAU03",61,0)
 S J=""
"RTN","MAGNAU03",62,0)
 F  S J=$O(FLDSARR(J)) Q:J=""  D
"RTN","MAGNAU03",63,0)
 . S MAGRY(CNT)=MAGRY(CNT)_RESDEL_OUT(FILE,IENS,J,"I")_RESDEL_OUT(FILE,IENS,J,"E")
"RTN","MAGNAU03",64,0)
 . Q
"RTN","MAGNAU03",65,0)
 ; Now get the word-processing and multiple fields
"RTN","MAGNAU03",66,0)
 S J=""
"RTN","MAGNAU03",67,0)
 F  S J=$O(FLDSARRW(J)) Q:J=""  D
"RTN","MAGNAU03",68,0)
 . I $$ISFLDWP^MAGNU001(.WPTYPE,FILE,J) D  Q
"RTN","MAGNAU03",69,0)
 . . Q:'$F(FLAGS,"W")  ; Exclude word-processing fields 
"RTN","MAGNAU03",70,0)
 . . K TMPOUT
"RTN","MAGNAU03",71,0)
 . . M TMPOUT=OUT(FILE,IENS,J)
"RTN","MAGNAU03",72,0)
 . . D WORDPROC(.MAGRY,.CNT,.TMPOUT,FLDSARRW(J))  ; get word-processing field value
"RTN","MAGNAU03",73,0)
 . . Q
"RTN","MAGNAU03",74,0)
 . ; multi field
"RTN","MAGNAU03",75,0)
 . D MULTI(.MAGRY,.CNT,.OUT,FILE,FLDSARRW(J),FLAGS)
"RTN","MAGNAU03",76,0)
 . Q
"RTN","MAGNAU03",77,0)
 ;
"RTN","MAGNAU03",78,0)
 ; write the header
"RTN","MAGNAU03",79,0)
 S MAGRY(CNTSTART-1)="IEN"
"RTN","MAGNAU03",80,0)
 S I=""
"RTN","MAGNAU03",81,0)
 F  S I=$O(FLDSARR(I)) Q:I=""  S MAGRY(CNTSTART-1)=MAGRY(CNTSTART-1)_RESDEL_FLDSARR(I)
"RTN","MAGNAU03",82,0)
 S MAGRY(0)=$$SETOKVAL^MAGNU002(CNT)
"RTN","MAGNAU03",83,0)
 Q
"RTN","MAGNAU03",84,0)
 ;
"RTN","MAGNAU03",85,0)
WORDPROC(MAGRY,CNT,WP,FLDNAME)  ; add word-processing field values to the result
"RTN","MAGNAU03",86,0)
 N L,RESDEL
"RTN","MAGNAU03",87,0)
 S RESDEL=$$RESDEL^MAGNU002()
"RTN","MAGNAU03",88,0)
 S L=""
"RTN","MAGNAU03",89,0)
 F  S L=$O(WP(L)) Q:'L  D
"RTN","MAGNAU03",90,0)
 . S CNT=CNT+1,MAGRY(CNT)=FLDNAME_$TR($J(L,3)," ",0)_RESDEL_WP(L)
"RTN","MAGNAU03",91,0)
 . Q
"RTN","MAGNAU03",92,0)
 Q
"RTN","MAGNAU03",93,0)
 ;
"RTN","MAGNAU03",94,0)
MULTI(MAGRY,CNT,OUT,FILE,FLDNAME,FLAGS)  ; add word-processing field values to the result
"RTN","MAGNAU03",95,0)
 N IEN,J,L,RESDEL
"RTN","MAGNAU03",96,0)
 N SUBFILE,FIELDS,FLDSARR,FLDSARRW
"RTN","MAGNAU03",97,0)
 ;
"RTN","MAGNAU03",98,0)
 S RESDEL=$$RESDEL^MAGNU002()
"RTN","MAGNAU03",99,0)
 S SUBFILE=$$GSUBFILE^MAGNU001(FILE,FLDNAME)  ; get sub-file number
"RTN","MAGNAU03",100,0)
 S FIELDS=$$GETFLDS^MAGNU001(.FLDSARR,.FLDSARRW,SUBFILE,"")
"RTN","MAGNAU03",101,0)
 ; write header of multiple record
"RTN","MAGNAU03",102,0)
 S CNT=CNT+1,MAGRY(CNT)=FLDNAME_"000"_RESDEL_"IEN"
"RTN","MAGNAU03",103,0)
 S J=""
"RTN","MAGNAU03",104,0)
 F  S J=$O(FLDSARR(J)) Q:J=""  S MAGRY(CNT)=MAGRY(CNT)_RESDEL_FLDSARR(J)
"RTN","MAGNAU03",105,0)
 ;
"RTN","MAGNAU03",106,0)
 ; write the values of the multiple record
"RTN","MAGNAU03",107,0)
 S L=""
"RTN","MAGNAU03",108,0)
 F  S L=$O(OUT(SUBFILE,L)) Q:L=""  D
"RTN","MAGNAU03",109,0)
 . I '$F(FLAGS,"D") Q:$G(OUT(SUBFILE,L,5,"I"))  ; Skip deleted annotations
"RTN","MAGNAU03",110,0)
 . I '$F(FLAGS,"U") Q:OUT(SUBFILE,L,1,"I")'=DUZ  ; Skip deleted annotations
"RTN","MAGNAU03",111,0)
 . S IEN=$P(L,",")  ; IEN of the mutliple record
"RTN","MAGNAU03",112,0)
 . S CNT=CNT+1,MAGRY(CNT)=FLDNAME_$TR($J(IEN,3)," ",0)_RESDEL_IEN
"RTN","MAGNAU03",113,0)
 . S J=""
"RTN","MAGNAU03",114,0)
 . F  S J=$O(FLDSARR(J)) Q:J=""  D
"RTN","MAGNAU03",115,0)
 . . S MAGRY(CNT)=MAGRY(CNT)_RESDEL_OUT(SUBFILE,L,J,"I")_RESDEL_OUT(SUBFILE,L,J,"E")
"RTN","MAGNAU03",116,0)
 . . Q
"RTN","MAGNAU03",117,0)
 . S J=""
"RTN","MAGNAU03",118,0)
 . F  S J=$O(FLDSARRW(J)) Q:J=""  D
"RTN","MAGNAU03",119,0)
 . . I $$ISFLDWP^MAGNU001(.WPTYPE,SUBFILE,J) D  Q
"RTN","MAGNAU03",120,0)
 . . . Q:'$F(FLAGS,"W")  ; skip word processing field 
"RTN","MAGNAU03",121,0)
 . . . K TMPOUT
"RTN","MAGNAU03",122,0)
 . . . M TMPOUT=OUT(SUBFILE,L,J)
"RTN","MAGNAU03",123,0)
 . . . D WORDPROC(.MAGRY,.CNT,.TMPOUT,FLDSARRW(J))  ; get word-processing field value
"RTN","MAGNAU03",124,0)
 . . . Q
"RTN","MAGNAU03",125,0)
 . . ; multi field
"RTN","MAGNAU03",126,0)
 . . D MULTI(.MAGRY,.CNT,.OUT,SUBFILE,FLDSARRW(J),FLAGS)
"RTN","MAGNAU03",127,0)
 . . Q
"RTN","MAGNAU03",128,0)
 . Q
"RTN","MAGNAU03",129,0)
 Q
"RTN","MAGNID01")
0^7^B5509538
"RTN","MAGNID01",1,0)
MAGNID01 ;WOIFO/NST - DELETE IMAGES RPCS ; 28 Jul 2017 11:43 AM
"RTN","MAGNID01",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 92;Aug 02, 2012
"RTN","MAGNID01",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNID01",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNID01",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNID01",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNID01",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNID01",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNID01",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNID01",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNID01",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNID01",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNID01",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNID01",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNID01",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNID01",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNID01",17,0)
 ;;
"RTN","MAGNID01",18,0)
 Q
"RTN","MAGNID01",19,0)
 ;
"RTN","MAGNID01",20,0)
 ;***** DELETE IMAGES BY IEN
"RTN","MAGNID01",21,0)
 ;
"RTN","MAGNID01",22,0)
 ; RPC: MAGN DELETE IMAGES BY IEN
"RTN","MAGNID01",23,0)
 ;
"RTN","MAGNID01",24,0)
 ; .MAGOUT       Reference to a local variable where the results are returned to
"RTN","MAGNID01",25,0)
 ; .MAGPARAM
"RTN","MAGNID01",26,0)
 ;    MAGPARAM(1..n)=IMAGE IEN^GROUP DELETE FLAG (0|1)^REASON
"RTN","MAGNID01",27,0)
 ;
"RTN","MAGNID01",28,0)
 ; Return Values
"RTN","MAGNID01",29,0)
 ; =============   
"RTN","MAGNID01",30,0)
 ; MAGOUT(1..n) = Image IEN^1^SUCCESS 
"RTN","MAGNID01",31,0)
 ;                Image IEN^0^reason for failure
"RTN","MAGNID01",32,0)
DELIMGS(MAGOUT,MAGPARAM) ;RPC [MAGN DELETE IMAGES BY IEN]
"RTN","MAGNID01",33,0)
 N MAGNI,MAGGRY,MAGNIEN,MAGNGDF,MAGNRSN
"RTN","MAGNID01",34,0)
 S MAGOUT=$NA(^TMP($J,"MAGNID01"))
"RTN","MAGNID01",35,0)
 K @MAGOUT
"RTN","MAGNID01",36,0)
 ;
"RTN","MAGNID01",37,0)
 S MAGNI=""
"RTN","MAGNID01",38,0)
 F  S MAGNI=$O(MAGPARAM(MAGNI)) Q:MAGNI=""  D
"RTN","MAGNID01",39,0)
 . S MAGNIEN=$P(MAGPARAM(MAGNI),"^",1)  ; Image IEN
"RTN","MAGNID01",40,0)
 . S MAGNGDF=$P(MAGPARAM(MAGNI),"^",2)  ; Group delete flag
"RTN","MAGNID01",41,0)
 . S MAGNRSN=$P(MAGPARAM(MAGNI),"^",3)  ; Reason
"RTN","MAGNID01",42,0)
 . K MAGGRY
"RTN","MAGNID01",43,0)
 . D IMAGEDEL^MAGGTID(.MAGGRY,MAGNIEN,MAGNGDF,MAGNRSN)
"RTN","MAGNID01",44,0)
 . I ($P(MAGGRY(0),"^")=1)!($P(MAGGRY(0),"^")=0) S @MAGOUT@(MAGNI)=MAGNIEN_"^"_MAGGRY(0)
"RTN","MAGNID01",45,0)
 . E  S @MAGOUT@(MAGNI)=MAGNIEN_"^0^"_MAGGRY(0)
"RTN","MAGNID01",46,0)
 . Q
"RTN","MAGNID01",47,0)
 Q
"RTN","MAGNILOG")
0^8^B4853922
"RTN","MAGNILOG",1,0)
MAGNILOG ;WOIFO/NST - LOG ACTION on IMAGES RPCS ; 14 Sep 2017 11:43 AM
"RTN","MAGNILOG",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 92;Aug 02, 2012
"RTN","MAGNILOG",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNILOG",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNILOG",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNILOG",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNILOG",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNILOG",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNILOG",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNILOG",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNILOG",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNILOG",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNILOG",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNILOG",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNILOG",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNILOG",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNILOG",17,0)
 ;;
"RTN","MAGNILOG",18,0)
 Q
"RTN","MAGNILOG",19,0)
 ;
"RTN","MAGNILOG",20,0)
 ;***** MAGN LOG IMAGE ACCESS BY IEN
"RTN","MAGNILOG",21,0)
 ;
"RTN","MAGNILOG",22,0)
 ; RPC: MAGN LOG IMAGE ACCESS BY IEN
"RTN","MAGNILOG",23,0)
 ;
"RTN","MAGNILOG",24,0)
 ; .MAGOUT       Reference to a local variable where the results are returned to
"RTN","MAGNILOG",25,0)
 ; .MAGPARAM
"RTN","MAGNILOG",26,0)
 ;    MAGPARAM(0..n)=IMAGE IEN^DATA
"RTN","MAGNILOG",27,0)
 ;      See LOGACT^MAGGTU6 for details on DATA
"RTN","MAGNILOG",28,0)
 ;
"RTN","MAGNILOG",29,0)
 ; Return Values
"RTN","MAGNILOG",30,0)
 ; =============   
"RTN","MAGNILOG",31,0)
 ; MAGOUT(0..n) = Image IEN^1^SUCCESS 
"RTN","MAGNILOG",32,0)
 ;                Image IEN^0^reason for failure
"RTN","MAGNILOG",33,0)
LOGACT(MAGOUT,MAGPARAM) ;RPC [MAGN LOG IMAGE ACCESS BY IEN]
"RTN","MAGNILOG",34,0)
 N MAGNI,MAGGRY,MAGNIEN,MAGDATA
"RTN","MAGNILOG",35,0)
 S MAGOUT=$NA(^TMP($J,"MAGNILOG"))
"RTN","MAGNILOG",36,0)
 K @MAGOUT
"RTN","MAGNILOG",37,0)
 ;
"RTN","MAGNILOG",38,0)
 S MAGNI=""
"RTN","MAGNILOG",39,0)
 F  S MAGNI=$O(MAGPARAM(MAGNI)) Q:MAGNI=""  D
"RTN","MAGNILOG",40,0)
 . S MAGNIEN=$P(MAGPARAM(MAGNI),U)
"RTN","MAGNILOG",41,0)
 . S MAGDATA=$P(MAGPARAM(MAGNI),U,2,99)
"RTN","MAGNILOG",42,0)
 . K MAGGRY
"RTN","MAGNILOG",43,0)
 . D LOGACT^MAGGTU6(.MAGGRY,MAGDATA)
"RTN","MAGNILOG",44,0)
 . I ($P(MAGGRY,"^")=1)!($P(MAGGRY,"^")=0) S @MAGOUT@(MAGNI)=MAGNIEN_"^"_MAGGRY
"RTN","MAGNILOG",45,0)
 . E  S @MAGOUT@(MAGNI)=MAGNIEN_"^0^"_MAGGRY
"RTN","MAGNILOG",46,0)
 . Q
"RTN","MAGNILOG",47,0)
 Q
"RTN","MAGNISET")
0^9^B4965992
"RTN","MAGNISET",1,0)
MAGNISET ;WOIFO/NST - UPDATES IMAGES RPCS ; 12 Sep 2017 11:43 AM
"RTN","MAGNISET",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 92;Aug 02, 2012
"RTN","MAGNISET",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNISET",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNISET",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNISET",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNISET",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNISET",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNISET",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNISET",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNISET",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNISET",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNISET",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNISET",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNISET",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNISET",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNISET",17,0)
 ;;
"RTN","MAGNISET",18,0)
 Q
"RTN","MAGNISET",19,0)
 ;
"RTN","MAGNISET",20,0)
 ;***** Updates one or more image properties
"RTN","MAGNISET",21,0)
 ;
"RTN","MAGNISET",22,0)
 ; RPC: MAGN SET IMAGES PROPS BY IEN
"RTN","MAGNISET",23,0)
 ;
"RTN","MAGNISET",24,0)
 ; .MAGOUT       Reference to a local variable where the results are returned to
"RTN","MAGNISET",25,0)
 ; .MAGPARAM
"RTN","MAGNISET",26,0)
 ;    MAGPARAM(0..n)=IMAGE IEN^Parameter name^Value
"RTN","MAGNISET",27,0)
 ;
"RTN","MAGNISET",28,0)
 ; Return Values
"RTN","MAGNISET",29,0)
 ; =============   
"RTN","MAGNISET",30,0)
 ; MAGOUT(0..n) = IMAGE IEN^1^Ok
"RTN","MAGNISET",31,0)
 ;                IMAGE IEN^0^reason for failure
"RTN","MAGNISET",32,0)
 ;
"RTN","MAGNISET",33,0)
 ; Note: See RPC [MAGG IMAGE SET PROPERTIES] for more details
"RTN","MAGNISET",34,0)
 ;
"RTN","MAGNISET",35,0)
SETIMGS(MAGOUT,MAGPARAM) ;RPC [MAGN SET IMAGES PROPS BY IEN]
"RTN","MAGNISET",36,0)
 N MAGNI,MAGGRY,MAGNIEN,FLAGS,PROPVALS
"RTN","MAGNISET",37,0)
 K MAGOUT
"RTN","MAGNISET",38,0)
 ;
"RTN","MAGNISET",39,0)
 S MAGNI=""
"RTN","MAGNISET",40,0)
 F  S MAGNI=$O(MAGPARAM(MAGNI)) Q:MAGNI=""  D
"RTN","MAGNISET",41,0)
 . S MAGNIEN=$P(MAGPARAM(MAGNI),"^",1)  ; Image IEN
"RTN","MAGNISET",42,0)
 . S PROPVALS(1)=$P(MAGPARAM(MAGNI),"^",2)_"^^"_$P(MAGPARAM(MAGNI),"^",3)
"RTN","MAGNISET",43,0)
 . S FLAGS=$P(MAGPARAM(MAGNI),"^",4)    ; Flags
"RTN","MAGNISET",44,0)
 . K MAGGRY
"RTN","MAGNISET",45,0)
 . D SETPROPS^MAGGA02(.MAGGRY,MAGNIEN,FLAGS,.PROPVALS)
"RTN","MAGNISET",46,0)
 . S MAGOUT(MAGNI)=MAGNIEN_"^"_MAGGRY(0)
"RTN","MAGNISET",47,0)
 . Q
"RTN","MAGNISET",48,0)
 Q
"RTN","MAGNTRAI")
0^10^B82064307
"RTN","MAGNTRAI",1,0)
MAGNTRAI ;WOIFO/NST - List images for Reports ; 16 Jan 2018 3:59 PM
"RTN","MAGNTRAI",2,0)
 ;;3.0;IMAGING;**170,185**;Mar 19, 2002;Build 4525;May 01, 2013
"RTN","MAGNTRAI",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNTRAI",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNTRAI",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNTRAI",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNTRAI",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNTRAI",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNTRAI",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNTRAI",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNTRAI",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNTRAI",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNTRAI",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNTRAI",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNTRAI",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNTRAI",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNTRAI",17,0)
 ;;
"RTN","MAGNTRAI",18,0)
 Q
"RTN","MAGNTRAI",19,0)
 ;
"RTN","MAGNTRAI",20,0)
 ;*****  List Images for Rad Exams or TIU Notes by CPRS context
"RTN","MAGNTRAI",21,0)
 ;       
"RTN","MAGNTRAI",22,0)
 ; RPC: MAGN CPRS IMAGE LIST
"RTN","MAGNTRAI",23,0)
 ; 
"RTN","MAGNTRAI",24,0)
 ; Input Parameters
"RTN","MAGNTRAI",25,0)
 ; ================
"RTN","MAGNTRAI",26,0)
 ; 
"RTN","MAGNTRAI",27,0)
 ; DATA - Array holds Windows message received from CPRS in format
"RTN","MAGNTRAI",28,0)
 ;         e.g. 'RPT^CPRS^29027^RA^79029185.9998-1'
"RTN","MAGNTRAI",29,0)
 ;                or
"RTN","MAGNTRAI",30,0)
 ;               RPT^CPRS^4658^TIU^2243408^^^^^^^^1
"RTN","MAGNTRAI",31,0)
 ; [IMGLESS]  flag to speed up queries: if=1 (true), just get study-level data
"RTN","MAGNTRAI",32,0)
 ;           
"RTN","MAGNTRAI",33,0)
 ; Return Values
"RTN","MAGNTRAI",34,0)
 ; =============
"RTN","MAGNTRAI",35,0)
 ; 
"RTN","MAGNTRAI",36,0)
 ; if error MAGRY(0) = 0 ^Error message^
"RTN","MAGNTRAI",37,0)
 ; if success MAGRY(0) = 1
"RTN","MAGNTRAI",38,0)
 ;            MAGRY(1..n) = CONTEXTID | 0 or 1 | images in format defined in
"RTN","MAGNTRAI",39,0)
 ;                        RPC [MAGG CPRS RAD EXAM] or [MAG3 CPRS TIU NOTE]
"RTN","MAGNTRAI",40,0)
 ;
"RTN","MAGNTRAI",41,0)
IMAGEL(MAGRY,DATA,IMGLESS) ;RPC [MAGN CPRS IMAGE LIST]
"RTN","MAGNTRAI",42,0)
 S IMGLESS=$S($D(IMGLESS):+IMGLESS,1:1)  ; Defualt is IMAGELESS
"RTN","MAGNTRAI",43,0)
 ;
"RTN","MAGNTRAI",44,0)
 N MAGVER,MAGNII
"RTN","MAGNTRAI",45,0)
 S MAGVER=""
"RTN","MAGNTRAI",46,0)
 S MAGNII=""
"RTN","MAGNTRAI",47,0)
 ; Check version of the RPC we need to call
"RTN","MAGNTRAI",48,0)
 F  S MAGNII=$O(DATA(MAGNII)) Q:(MAGVER'="")!(MAGNII="")  D
"RTN","MAGNTRAI",49,0)
 . S MAGVER=$P(DATA(MAGNII),"~",2)
"RTN","MAGNTRAI",50,0)
 . Q
"RTN","MAGNTRAI",51,0)
 I MAGVER=2 D IMAGEL^MAGNVQ06(.MAGRY,.DATA,IMGLESS) Q 
"RTN","MAGNTRAI",52,0)
 ;
"RTN","MAGNTRAI",53,0)
 N MAGNCXT,MAGNI,MAGNCNT,MAGNX,MAGNTIU,RARPT
"RTN","MAGNTRAI",54,0)
 N MAGZRY
"RTN","MAGNTRAI",55,0)
 N $ETRAP,$ESTACK S $ETRAP="D AERRA^MAGGTERR"
"RTN","MAGNTRAI",56,0)
 S IMGLESS=$S($D(IMGLESS):+IMGLESS,1:1)  ; Defualt is IMAGELESS
"RTN","MAGNTRAI",57,0)
 S MAGRY=$NA(^TMP("MAGNTRAI",$J))
"RTN","MAGNTRAI",58,0)
 K @MAGRY
"RTN","MAGNTRAI",59,0)
 S @MAGRY@(0)=0
"RTN","MAGNTRAI",60,0)
 S MAGNCNT=0
"RTN","MAGNTRAI",61,0)
 S MAGNI=""
"RTN","MAGNTRAI",62,0)
 F  S MAGNI=$O(DATA(MAGNI)) Q:MAGNI=""  D
"RTN","MAGNTRAI",63,0)
 . S MAGNCXT=DATA(MAGNI)  ; CPRS contextID
"RTN","MAGNTRAI",64,0)
 . S MAGNX=$P(MAGNCXT,"^",4)
"RTN","MAGNTRAI",65,0)
 . I MAGNX="RA" D  Q
"RTN","MAGNTRAI",66,0)
 . . D IMAGEC(.MAGZRY,MAGNCXT,IMGLESS,.RARPT)  ; get image list for a single contextID
"RTN","MAGNTRAI",67,0)
 . . D APPENDRA(MAGRY,.MAGNCNT,MAGNCXT,MAGZRY,RARPT)  ; Append individual contextID image list to final list
"RTN","MAGNTRAI",68,0)
 . . Q
"RTN","MAGNTRAI",69,0)
 . I MAGNX="TIU" D  Q
"RTN","MAGNTRAI",70,0)
 . . S MAGNTIU=$P(MAGNCXT,"^",5)
"RTN","MAGNTRAI",71,0)
 . . K MAGZRY
"RTN","MAGNTRAI",72,0)
 . . D IMAGES^MAGGNTI(.MAGZRY,MAGNTIU)
"RTN","MAGNTRAI",73,0)
 . . D APPEND2(MAGRY,.MAGNCNT,MAGNCXT,.MAGZRY,MAGNTIU)  ; Append individual contextID image list to final list
"RTN","MAGNTRAI",74,0)
 . . Q
"RTN","MAGNTRAI",75,0)
 . S MAGNCNT=MAGNCNT+1
"RTN","MAGNTRAI",76,0)
 . S @MAGRY@(MAGNCNT)="NEXT_CONTEXTID|"_MAGNCXT_"|0|"_"Invalid ContextId Type"
"RTN","MAGNTRAI",77,0)
 . Q
"RTN","MAGNTRAI",78,0)
 S @MAGRY@(0)=1
"RTN","MAGNTRAI",79,0)
 Q
"RTN","MAGNTRAI",80,0)
 ;
"RTN","MAGNTRAI",81,0)
IMAGEC(MAGZRY,DATA,IMGLESS,RARPT) ;A copy from MAGGTRAI
"RTN","MAGNTRAI",82,0)
 ; Call to list Images for a Rad Exam that was selected from CPRS 
"RTN","MAGNTRAI",83,0)
 ; and Imaging Window was notified via windows messaging
"RTN","MAGNTRAI",84,0)
 ;   INPUT :  DATA is in format of Windows message received from CPRS
"RTN","MAGNTRAI",85,0)
 ;    example   'RPT^CPRS^29027^RA^i79029185.9998-1'
"RTN","MAGNTRAI",86,0)
 N DFN,ENT,INVDTTM,INVDT,INVTM
"RTN","MAGNTRAI",87,0)
 S MAGZRY=$NA(^TMP("MAGGTRAI",$J))
"RTN","MAGNTRAI",88,0)
 K @MAGZRY
"RTN","MAGNTRAI",89,0)
 S DFN=+$P(DATA,U,3)
"RTN","MAGNTRAI",90,0)
 S ENT=+$P($P(DATA,U,5),"-",2)
"RTN","MAGNTRAI",91,0)
 S INVDTTM=$P($P(DATA,U,5),"-",1)
"RTN","MAGNTRAI",92,0)
 S INVDT=$P(INVDTTM,".",1)
"RTN","MAGNTRAI",93,0)
 S INVTM=$P(INVDTTM,".",2)
"RTN","MAGNTRAI",94,0)
 F  Q:($L(INVDT)<8)  S INVDT=$E(INVDT,2,$L(INVDT))
"RTN","MAGNTRAI",95,0)
 S INVDTTM=INVDT_"."_INVTM
"RTN","MAGNTRAI",96,0)
 S RARPT=0
"RTN","MAGNTRAI",97,0)
 I '$D(^RADPT(DFN,"DT",INVDTTM,"P",ENT,0)) S @MAGZRY@(0)="0^INVALID Data : Attempt to access Exam failed." Q
"RTN","MAGNTRAI",98,0)
 S RARPT=$P(^RADPT(DFN,"DT",INVDTTM,"P",ENT,0),U,17)
"RTN","MAGNTRAI",99,0)
 I 'RARPT S @MAGZRY@(0)="0^No Report for selected Exam" Q
"RTN","MAGNTRAI",100,0)
 ; MAGQI 8/22/01
"RTN","MAGNTRAI",101,0)
 I $P($G(^RARPT(RARPT,0)),U,2)'=DFN S @MAGZRY@(0)="-2^Patient Mismatch. Radiology File" Q
"RTN","MAGNTRAI",102,0)
 D GETSTUDY(.MAGZRY,RARPT,IMGLESS)  ; Pass input parameters
"RTN","MAGNTRAI",103,0)
 Q
"RTN","MAGNTRAI",104,0)
 ;
"RTN","MAGNTRAI",105,0)
GETSTUDY(MAGZRY,RARPT,IMGLESS) ; Private call. From other points in this routine, when RARPT is defined
"RTN","MAGNTRAI",106,0)
 ; RARPT -- Radiology report IEN
"RTN","MAGNTRAI",107,0)
 ; and returns a list in MAGZRY(1..n). 
"RTN","MAGNTRAI",108,0)
 ; We'll make a tmp list of just the image IEN's
"RTN","MAGNTRAI",109,0)
 ;  splitting groups into individual image entries.
"RTN","MAGNTRAI",110,0)
 ; If more than 1 Image group points to this report, we
"RTN","MAGNTRAI",111,0)
 ;  will prefix the Image Description with (G1), (G2) etc
"RTN","MAGNTRAI",112,0)
 ; We call GROUP^MAGGTIG to get the images for the group, this call
"RTN","MAGNTRAI",113,0)
 ;  sorts the images in Dicom Series, Dicom Image number order.
"RTN","MAGNTRAI",114,0)
 ;
"RTN","MAGNTRAI",115,0)
 N GROUPS,OUT,REQDFN
"RTN","MAGNTRAI",116,0)
 ;
"RTN","MAGNTRAI",117,0)
 N CT,OI,IGCT,MAGIEN1,MAGQI,MAGX
"RTN","MAGNTRAI",118,0)
 S IGCT=+$P($G(^RARPT(RARPT,2005,0)),U,4)
"RTN","MAGNTRAI",119,0)
 ; Quit if no images for RARPT
"RTN","MAGNTRAI",120,0)
 I IGCT=0 S @MAGZRY@(0)="0^0 Images for Radiology Report." Q 
"RTN","MAGNTRAI",121,0)
 ;
"RTN","MAGNTRAI",122,0)
 ; Check all Image entries in RARPT 2005 NODE. for Patient match Pointer match, from both 
"RTN","MAGNTRAI",123,0)
 ;   RARPT end, and Imaging end.
"RTN","MAGNTRAI",124,0)
 S MAGQI=1
"RTN","MAGNTRAI",125,0)
 S OI=0,CT=1 F  S OI=$O(^RARPT(RARPT,2005,OI)) Q:'OI  D  Q:(MAGQI<1)
"RTN","MAGNTRAI",126,0)
 . S MAGIEN1=$P(^RARPT(RARPT,2005,OI,0),U)
"RTN","MAGNTRAI",127,0)
 . ; Assure magdfn = rarpt dfn
"RTN","MAGNTRAI",128,0)
 . I $P($G(^RARPT(RARPT,0)),U,2)'=$P($G(^MAG(2005,MAGIEN1,0)),U,7) S MAGQI="-2^Patient Mismatch. Radiology Report" Q
"RTN","MAGNTRAI",129,0)
 . ; Assure magien1 is pointing to this rarpt
"RTN","MAGNTRAI",130,0)
 . I $P($G(^MAG(2005,MAGIEN1,2)),U,7)'=RARPT S MAGQI="-2^Pointer Mismatch. Radiology Report" Q
"RTN","MAGNTRAI",131,0)
 . ; Now run the Imaging integrity check
"RTN","MAGNTRAI",132,0)
 . D CHK^MAGGSQI(.MAGX,MAGIEN1) I 'MAGX(0) S MAGQI="-2^"_$P(MAGX(0),U,2,99) Q
"RTN","MAGNTRAI",133,0)
 ;
"RTN","MAGNTRAI",134,0)
 I MAGQI<1 S @MAGZRY@(0)=MAGQI Q
"RTN","MAGNTRAI",135,0)
 S CT=0
"RTN","MAGNTRAI",136,0)
 ;
"RTN","MAGNTRAI",137,0)
 S OI=0,CT=1 F  S OI=$O(^RARPT(RARPT,2005,OI)) Q:'OI  D
"RTN","MAGNTRAI",138,0)
 . S MAGIEN1=$P(^RARPT(RARPT,2005,OI,0),U) S GROUPS(OI)=MAGIEN1
"RTN","MAGNTRAI",139,0)
 . Q
"RTN","MAGNTRAI",140,0)
 ;
"RTN","MAGNTRAI",141,0)
 S REQDFN=$P($G(^RARPT(RARPT,0)),U,2)
"RTN","MAGNTRAI",142,0)
 D STUDY2^MAGDQR21(.OUT,.GROUPS,REQDFN,IMGLESS)  ; MAG DOD GET STUDIES IEN
"RTN","MAGNTRAI",143,0)
 ;
"RTN","MAGNTRAI",144,0)
 S MAGZRY=OUT
"RTN","MAGNTRAI",145,0)
 S @MAGZRY@(0)=1
"RTN","MAGNTRAI",146,0)
 ;
"RTN","MAGNTRAI",147,0)
 Q
"RTN","MAGNTRAI",148,0)
 ;
"RTN","MAGNTRAI",149,0)
APPENDRA(OUT,MAGNCNT,MAGNCXT,MAGZRY,RARPT)  ;
"RTN","MAGNTRAI",150,0)
 ; Append individual contextID image list to final list
"RTN","MAGNTRAI",151,0)
 ; and add more data 
"RTN","MAGNTRAI",152,0)
 ; OUT  - destination image list array 
"RTN","MAGNTRAI",153,0)
 ; .MAGNCNT -- Start position in the array
"RTN","MAGNTRAI",154,0)
 ; MAGNCXT -- context ID
"RTN","MAGNTRAI",155,0)
 ; MAGZRY  -- Image list to be appended - reference to a global
"RTN","MAGNTRAI",156,0)
 ;
"RTN","MAGNTRAI",157,0)
 N I,IMGIEN,MAGNCNTN,MAGSTUDY
"RTN","MAGNTRAI",158,0)
 S @MAGZRY@(0)=$G(@MAGZRY@(0))
"RTN","MAGNTRAI",159,0)
 I '@MAGZRY@(0) D  Q
"RTN","MAGNTRAI",160,0)
 . S MAGNCNT=MAGNCNT+1
"RTN","MAGNTRAI",161,0)
 . S @OUT@(MAGNCNT)="NEXT_CONTEXTID|"_MAGNCXT_"|0|"_$P(@MAGZRY@(0),"^",2)
"RTN","MAGNTRAI",162,0)
 . Q
"RTN","MAGNTRAI",163,0)
 ;
"RTN","MAGNTRAI",164,0)
 S MAGNCNTN=MAGNCNT
"RTN","MAGNTRAI",165,0)
 S MAGNCNT=MAGNCNT+1
"RTN","MAGNTRAI",166,0)
 ;
"RTN","MAGNTRAI",167,0)
 S I=1  ; start from line number 2. Line number 1 is a records count
"RTN","MAGNTRAI",168,0)
 F  S I=$O(@MAGZRY@(I)) Q:'I  D
"RTN","MAGNTRAI",169,0)
 . S MAGNCNT=MAGNCNT+1
"RTN","MAGNTRAI",170,0)
 . S @OUT@(MAGNCNT)=@MAGZRY@(I)
"RTN","MAGNTRAI",171,0)
 . I $P(@MAGZRY@(I),"|")="STUDY_IEN" D   ; Add STUDY_INFO. Better place will be MAGDQR21
"RTN","MAGNTRAI",172,0)
 . . S MAGNCNT=MAGNCNT+1
"RTN","MAGNTRAI",173,0)
 . . S IMGIEN=$P(@MAGZRY@(I),"|",2)  ; IEN of the group
"RTN","MAGNTRAI",174,0)
 . . S @OUT@(MAGNCNT)="STUDY_INFO|"_$$STDINFO(IMGIEN)_"|RA-"_RARPT
"RTN","MAGNTRAI",175,0)
 . . S MAGSTUDY=@MAGZRY@(I)
"RTN","MAGNTRAI",176,0)
 . . Q
"RTN","MAGNTRAI",177,0)
 . I IMGLESS,($P(@MAGZRY@(I),"|")="STUDY_PAT") D INSFIMG(MAGSTUDY,.MAGNCNT,OUT)  ; Append First Image Info
"RTN","MAGNTRAI",178,0)
 . Q
"RTN","MAGNTRAI",179,0)
 S @OUT@(MAGNCNTN+1)="NEXT_CONTEXTID|"_MAGNCXT_"|1|"_(MAGNCNT-MAGNCNTN)  ; @MAGZRY@(1) is a result lines count
"RTN","MAGNTRAI",180,0)
 Q
"RTN","MAGNTRAI",181,0)
 ; 
"RTN","MAGNTRAI",182,0)
INSFIMG(DATA,MAGNCNT,OUT) ; Append First Image Info I 
"RTN","MAGNTRAI",183,0)
 N IMGGRP,IMGIEN
"RTN","MAGNTRAI",184,0)
 S IMGGRP=$P(DATA,"|",2)
"RTN","MAGNTRAI",185,0)
 S IMGIEN=$P(DATA,"|",4)
"RTN","MAGNTRAI",186,0)
 S MAGNCNT=MAGNCNT+1,@OUT@(MAGNCNT)="NEXT_SERIES"
"RTN","MAGNTRAI",187,0)
 S MAGNCNT=MAGNCNT+1,@OUT@(MAGNCNT)="SERIES_IEN|"_IMGGRP
"RTN","MAGNTRAI",188,0)
 S MAGNCNT=MAGNCNT+1,@OUT@(MAGNCNT)="SERIES_NUMBER|1"
"RTN","MAGNTRAI",189,0)
 S MAGNCNT=MAGNCNT+1,@OUT@(MAGNCNT)="NEXT_IMAGE"
"RTN","MAGNTRAI",190,0)
 S MAGNCNT=MAGNCNT+1,@OUT@(MAGNCNT)="IMAGE_IEN|"_IMGIEN
"RTN","MAGNTRAI",191,0)
 S MAGNCNT=MAGNCNT+1,@OUT@(MAGNCNT)="GROUP_IEN|"_IMGGRP
"RTN","MAGNTRAI",192,0)
 S MAGNCNT=MAGNCNT+1,@OUT@(MAGNCNT)="IMAGE_INFO|"_"^"_$$INFO^MAGGAII(IMGIEN,"E")
"RTN","MAGNTRAI",193,0)
 Q
"RTN","MAGNTRAI",194,0)
 ;
"RTN","MAGNTRAI",195,0)
APPEND2(OUT,MAGNCNT,MAGNCXT,MAGZRY,MAGNTIU)  ; 
"RTN","MAGNTRAI",196,0)
 ; Append individual contextID image list to final list
"RTN","MAGNTRAI",197,0)
 ; and add more data
"RTN","MAGNTRAI",198,0)
 ; OUT  - destination image list array 
"RTN","MAGNTRAI",199,0)
 ; .MAGNCNT -- Start position in the array
"RTN","MAGNTRAI",200,0)
 ; MAGNCXT -- context ID
"RTN","MAGNTRAI",201,0)
 ; .MAGZRY  -- Image list to be appended
"RTN","MAGNTRAI",202,0)
 ;
"RTN","MAGNTRAI",203,0)
 N I,IMGIEN,STDINFO
"RTN","MAGNTRAI",204,0)
 S MAGZRY(0)=$G(MAGZRY(0))
"RTN","MAGNTRAI",205,0)
 I 'MAGZRY(0) D  Q
"RTN","MAGNTRAI",206,0)
 . S MAGNCNT=MAGNCNT+1
"RTN","MAGNTRAI",207,0)
 . S @OUT@(MAGNCNT)="NEXT_CONTEXTID|"_MAGNCXT_"|0|"_$P(MAGZRY(0),"^",2)
"RTN","MAGNTRAI",208,0)
 . Q
"RTN","MAGNTRAI",209,0)
 ;
"RTN","MAGNTRAI",210,0)
 S MAGNCNT=MAGNCNT+1
"RTN","MAGNTRAI",211,0)
 S @OUT@(MAGNCNT)="NEXT_CONTEXTID|"_MAGNCXT_"|1|"_MAGZRY(0)
"RTN","MAGNTRAI",212,0)
 S I=0
"RTN","MAGNTRAI",213,0)
 F  S I=$O(MAGZRY(I)) Q:'I  D
"RTN","MAGNTRAI",214,0)
 . S IMGIEN=$P(MAGZRY(I),"^",25)  ; IEN of the group
"RTN","MAGNTRAI",215,0)
 . S:'IMGIEN IMGIEN=$P(MAGZRY(I),"^",2)  ; Ien of the image
"RTN","MAGNTRAI",216,0)
 . S MAGNCNT=MAGNCNT+1
"RTN","MAGNTRAI",217,0)
 . S STDINFO=$$STDINFO(IMGIEN)
"RTN","MAGNTRAI",218,0)
 . S $P(STDINFO,"^",6)=$P(MAGZRY(I),"^",15)  ; Group image count per VIX request
"RTN","MAGNTRAI",219,0)
 . S @OUT@(MAGNCNT)=STDINFO_"|"_$P(MAGZRY(I),"^",2,9999)_"|TIU-"_MAGNTIU
"RTN","MAGNTRAI",220,0)
 . Q
"RTN","MAGNTRAI",221,0)
 Q
"RTN","MAGNTRAI",222,0)
 ;
"RTN","MAGNTRAI",223,0)
STDINFO(IMGIEN) ; Get study info
"RTN","MAGNTRAI",224,0)
 ; IMGIEN -- Image IEN
"RTN","MAGNTRAI",225,0)
 ;
"RTN","MAGNTRAI",226,0)
 ; Return Study( Image ) info. The code is a copy from MAGSIXG3 
"RTN","MAGNTRAI",227,0)
 N X0,X2,X40
"RTN","MAGNTRAI",228,0)
 N PKG,TYPE,EVT,SPEC,ORIG,ORIG,CAPTAPP,CLASS
"RTN","MAGNTRAI",229,0)
 N IMGNODE,FLTX
"RTN","MAGNTRAI",230,0)
 ;
"RTN","MAGNTRAI",231,0)
 S IMGNODE=$$NODE^MAGGI11(IMGIEN)  Q:IMGNODE="" 0
"RTN","MAGNTRAI",232,0)
 ;
"RTN","MAGNTRAI",233,0)
 S X0=$G(@IMGNODE@(0))
"RTN","MAGNTRAI",234,0)
 S X2=$G(@IMGNODE@(2))
"RTN","MAGNTRAI",235,0)
 S X40=$G(@IMGNODE@(40))
"RTN","MAGNTRAI",236,0)
 ;
"RTN","MAGNTRAI",237,0)
 S PKG=$P(X40,U)          ; PACKAGE INDEX (40)
"RTN","MAGNTRAI",238,0)
 S TYPE=$P(X40,U,3)       ; TYPE INDEX (42)
"RTN","MAGNTRAI",239,0)
 S EVT=$P(X40,U,4)        ; PROC/EVENT INDEX (43)
"RTN","MAGNTRAI",240,0)
 S SPEC=$P(X40,U,5)       ; SPEC/SUBSPEC INDEX (44)
"RTN","MAGNTRAI",241,0)
 S ORIG=$P(X40,U,6)       ; ORIGIN INDEX (45)
"RTN","MAGNTRAI",242,0)
 S:ORIG="" ORIG="V"       ; Show VA by default
"RTN","MAGNTRAI",243,0)
 S CAPTAPP=$P(X2,U,12)    ; CAPTURE APPLICATION (8.1)
"RTN","MAGNTRAI",244,0)
 ;
"RTN","MAGNTRAI",245,0)
 S CLASS=$S(TYPE:$P($G(^MAG(2005.83,+TYPE,0)),U,2),1:"")
"RTN","MAGNTRAI",246,0)
 ;
"RTN","MAGNTRAI",247,0)
 S FLTX=""
"RTN","MAGNTRAI",248,0)
 S $P(FLTX,U,3)=$$RPTITLE^MAGSIXG3($P(X2,U,6),$P(X2,U,7))     ; Report title
"RTN","MAGNTRAI",249,0)
 S $P(FLTX,U,4)=$$DTE^MAGSIXG3($P(X2,U,5))                    ; Procedure date
"RTN","MAGNTRAI",250,0)
 S $P(FLTX,U,5)=$P(X0,U,8)                           ; Procedure
"RTN","MAGNTRAI",251,0)
 S $P(FLTX,U,7)=$P(X2,U,4)                           ; Short descr.
"RTN","MAGNTRAI",252,0)
 S $P(FLTX,U,8)=PKG                                  ; Package
"RTN","MAGNTRAI",253,0)
 S $P(FLTX,U,9)=$P($G(^MAG(2005.82,+CLASS,0)),U)     ; Class
"RTN","MAGNTRAI",254,0)
 S $P(FLTX,U,10)=$P($G(^MAG(2005.83,+TYPE,0)),U)     ; Type
"RTN","MAGNTRAI",255,0)
 S $P(FLTX,U,11)=$P($G(^MAG(2005.84,+SPEC,0)),U)     ; (Sub)Specialty
"RTN","MAGNTRAI",256,0)
 S $P(FLTX,U,12)=$P($G(^MAG(2005.85,+EVT,0)),U)      ; Proc/Event
"RTN","MAGNTRAI",257,0)
 S $P(FLTX,U,13)=$$EXTERNAL^DILFD(2005,45,,ORIG)     ; Origin
"RTN","MAGNTRAI",258,0)
 S $P(FLTX,U,14)=$$DTE^MAGSIXG3($P(X2,U))            ; Capture date
"RTN","MAGNTRAI",259,0)
 S $P(FLTX,U,15)=$$GET1^DIQ(200,+$P(X2,U,2)_",",.01) ; Captured by
"RTN","MAGNTRAI",260,0)
 S $P(FLTX,U,16)=IMGIEN                              ; Image IEN
"RTN","MAGNTRAI",261,0)
 Q FLTX
"RTN","MAGNVQ01")
0^11^B109845219
"RTN","MAGNVQ01",1,0)
MAGNVQ01 ;WOIFO/NST - Retrieve study ; 11 Oct 2017 3:59 PM
"RTN","MAGNVQ01",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 4525;May 01, 2013
"RTN","MAGNVQ01",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNVQ01",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ01",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNVQ01",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNVQ01",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNVQ01",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNVQ01",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNVQ01",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNVQ01",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNVQ01",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNVQ01",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNVQ01",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNVQ01",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNVQ01",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ01",17,0)
 ;;
"RTN","MAGNVQ01",18,0)
 Q
"RTN","MAGNVQ01",19,0)
 ;
"RTN","MAGNVQ01",20,0)
GSTUDY(MAGOUT,REFTYPE,REFIEN,CONTEXT,IMGLESS)  ; Get Study by Reference and type
"RTN","MAGNVQ01",21,0)
 ; MAGOUT  - Output array where the images will be added
"RTN","MAGNVQ01",22,0)
 ; REFTYPE - "RAD" or "TIU" 
"RTN","MAGNVQ01",23,0)
 ; REFIEN  - Radiology Report IEN or TIU Note IEN
"RTN","MAGNVQ01",24,0)
 ; CONTEXT - Context ID
"RTN","MAGNVQ01",25,0)
 ; IMGLESS - 0|1 Include images
"RTN","MAGNVQ01",26,0)
 N STUDYUID
"RTN","MAGNVQ01",27,0)
 ;
"RTN","MAGNVQ01",28,0)
 S STUDYUID=$$STUDYUID(REFTYPE,REFIEN,CONTEXT) ; get Study UID
"RTN","MAGNVQ01",29,0)
 I STUDYUID="" Q  ; No study found for the reference
"RTN","MAGNVQ01",30,0)
 D IMGBYSTD(MAGOUT,STUDYUID,REFTYPE,REFIEN,CONTEXT,IMGLESS)
"RTN","MAGNVQ01",31,0)
 Q
"RTN","MAGNVQ01",32,0)
 ; 
"RTN","MAGNVQ01",33,0)
IMGBYSTD(MAGOUT,STUDYUID,REFTYPE,REFIEN,CONTEXT,IMGLESS) ; Get a Study images
"RTN","MAGNVQ01",34,0)
 N IARRAY,IMAGE,STYIX,SERIX,SOPIX,PROCIX,PATIX,PAT,PAT0,PATDTA
"RTN","MAGNVQ01",35,0)
 ;
"RTN","MAGNVQ01",36,0)
 S PAT=""
"RTN","MAGNVQ01",37,0)
 S STYIX=""
"RTN","MAGNVQ01",38,0)
 F  S STYIX=$O(^MAGV(2005.62,"B",STUDYUID,STYIX)) Q:'STYIX  D  Q:PAT<0
"RTN","MAGNVQ01",39,0)
 . S PROCIX=$P($G(^MAGV(2005.62,STYIX,6)),"^",1) Q:'PROCIX
"RTN","MAGNVQ01",40,0)
 . S PATIX=$P($G(^MAGV(2005.61,PROCIX,6)),"^",1) Q:'PATIX
"RTN","MAGNVQ01",41,0)
 . S PATDTA=$G(^MAGV(2005.6,PATIX,0)) Q:PATDTA=""
"RTN","MAGNVQ01",42,0)
 . S PAT0=$P(PATDTA,"^",1) S:PAT="" PAT=PAT0
"RTN","MAGNVQ01",43,0)
 . I ($P(PATDTA,"^",3)'="D")!(PAT'=PAT0) S PAT=-1 Q
"RTN","MAGNVQ01",44,0)
 . ; process study for valid pt
"RTN","MAGNVQ01",45,0)
 . S SERIX=""
"RTN","MAGNVQ01",46,0)
 . F  S SERIX=$O(^MAGV(2005.63,"C",STYIX,SERIX)) Q:'SERIX  D
"RTN","MAGNVQ01",47,0)
 . . N ACTVIMG
"RTN","MAGNVQ01",48,0)
 . . S ACTVIMG=0
"RTN","MAGNVQ01",49,0)
 . . S SOPIX=""
"RTN","MAGNVQ01",50,0)
 . . F  S SOPIX=$O(^MAGV(2005.64,"C",SERIX,SOPIX)) Q:'SOPIX  D  Q:IMGLESS&ACTVIMG
"RTN","MAGNVQ01",51,0)
 . . . S IMAGE=""
"RTN","MAGNVQ01",52,0)
 . . . F  S IMAGE=$O(^MAGV(2005.65,"C",SOPIX,IMAGE)) Q:'IMAGE  D
"RTN","MAGNVQ01",53,0)
 . . . . I $P($G(^MAGV(2005.65,IMAGE,1)),"^",5)'="I" D
"RTN","MAGNVQ01",54,0)
 . . . . . S IARRAY(STYIX,SERIX,SOPIX,IMAGE)="",ACTVIMG=1
"RTN","MAGNVQ01",55,0)
 . . . . Q
"RTN","MAGNVQ01",56,0)
 . . . Q
"RTN","MAGNVQ01",57,0)
 . . Q
"RTN","MAGNVQ01",58,0)
 . Q
"RTN","MAGNVQ01",59,0)
 I PAT<0 S @MAGOUT@(0)="0^Duplicate Study UID" Q
"RTN","MAGNVQ01",60,0)
 ;
"RTN","MAGNVQ01",61,0)
 D GETSTUDY(MAGOUT,.IARRAY,REFTYPE,REFIEN,CONTEXT) ; Get Study by graph ien
"RTN","MAGNVQ01",62,0)
 Q
"RTN","MAGNVQ01",63,0)
 ;
"RTN","MAGNVQ01",64,0)
GETSTUDY(MAGOUT,IARRAY,REFTYPE,REFIEN,CONTEXT)  ; Get Study by graph ien
"RTN","MAGNVQ01",65,0)
 N I,MAGNCNT,STYIX,SERIX,SOPIX,IMAGE
"RTN","MAGNVQ01",66,0)
 ;
"RTN","MAGNVQ01",67,0)
 I '$D(IARRAY) Q
"RTN","MAGNVQ01",68,0)
 ;
"RTN","MAGNVQ01",69,0)
 K ^TMP("MAGNVQ01",$J)
"RTN","MAGNVQ01",70,0)
 S ^TMP("MAGNVQ01",$J)=0
"RTN","MAGNVQ01",71,0)
 ;
"RTN","MAGNVQ01",72,0)
 S STYIX=""
"RTN","MAGNVQ01",73,0)
 F  S STYIX=$O(IARRAY(STYIX)) Q:'STYIX  D
"RTN","MAGNVQ01",74,0)
 . D ASTUDY(STYIX,REFTYPE,REFIEN,CONTEXT)
"RTN","MAGNVQ01",75,0)
 . S SERIX=""
"RTN","MAGNVQ01",76,0)
 . F  S SERIX=$O(IARRAY(STYIX,SERIX)) Q:'SERIX  D
"RTN","MAGNVQ01",77,0)
 . . D ASERIES(SERIX)
"RTN","MAGNVQ01",78,0)
 . . S SOPIX=""
"RTN","MAGNVQ01",79,0)
 . . F  S SOPIX=$O(IARRAY(STYIX,SERIX,SOPIX)) Q:'SOPIX  D
"RTN","MAGNVQ01",80,0)
 . . . S IMAGE=$O(IARRAY(STYIX,SERIX,SOPIX,""))  ; First image instance in SOP
"RTN","MAGNVQ01",81,0)
 . . . D ASOP(SOPIX,IMAGE)
"RTN","MAGNVQ01",82,0)
 . . . S IMAGE=""
"RTN","MAGNVQ01",83,0)
 . . . F  S IMAGE=$O(IARRAY(STYIX,SERIX,SOPIX,IMAGE)) Q:'IMAGE  D
"RTN","MAGNVQ01",84,0)
 . . . . D AIMAGE(SOPIX,IMAGE)
"RTN","MAGNVQ01",85,0)
 . . . . Q
"RTN","MAGNVQ01",86,0)
 . . . Q
"RTN","MAGNVQ01",87,0)
 . . Q
"RTN","MAGNVQ01",88,0)
 . Q
"RTN","MAGNVQ01",89,0)
 ;
"RTN","MAGNVQ01",90,0)
 ; Append it to end result
"RTN","MAGNVQ01",91,0)
 S I=0
"RTN","MAGNVQ01",92,0)
 S MAGNCNT=$O(@MAGOUT@(""),-1)
"RTN","MAGNVQ01",93,0)
 F  S I=$O(^TMP("MAGNVQ01",$J,I)) Q:'I  D
"RTN","MAGNVQ01",94,0)
 . S MAGNCNT=MAGNCNT+1
"RTN","MAGNVQ01",95,0)
 . S @MAGOUT@(MAGNCNT)=^TMP("MAGNVQ01",$J,I)
"RTN","MAGNVQ01",96,0)
 . Q
"RTN","MAGNVQ01",97,0)
 I MAGNCNT S @MAGOUT@(0)=1
"RTN","MAGNVQ01",98,0)
 Q
"RTN","MAGNVQ01",99,0)
 ;
"RTN","MAGNVQ01",100,0)
STUDYUID(REFTYPE,REFIEN,CONTEXT) ; Get Study UID by readiology report or TIU note
"RTN","MAGNVQ01",101,0)
 N ACN,STDIEN
"RTN","MAGNVQ01",102,0)
 ;
"RTN","MAGNVQ01",103,0)
 I REFTYPE="RAD" S ACN=$$ACNRAD^MAGNU003(REFIEN,CONTEXT)
"RTN","MAGNVQ01",104,0)
 I REFTYPE="TIU" S ACN=$$ACNTIU^MAGNU003(REFIEN)
"RTN","MAGNVQ01",105,0)
 I ACN="" Q ""
"RTN","MAGNVQ01",106,0)
 ;
"RTN","MAGNVQ01",107,0)
 S STDIEN=$O(^MAGV(2005.62,"D",ACN,""))  ; Get study UID IEN
"RTN","MAGNVQ01",108,0)
 Q $$GET1^DIQ(2005.62,STDIEN,".01")      ; Return study UID
"RTN","MAGNVQ01",109,0)
 ;
"RTN","MAGNVQ01",110,0)
WRTOUT(S) ; Write a new line
"RTN","MAGNVQ01",111,0)
 N CNT
"RTN","MAGNVQ01",112,0)
 S CNT=^TMP("MAGNVQ01",$J)+1
"RTN","MAGNVQ01",113,0)
 S ^TMP("MAGNVQ01",$J)=CNT
"RTN","MAGNVQ01",114,0)
 S ^TMP("MAGNVQ01",$J,CNT)=S
"RTN","MAGNVQ01",115,0)
 Q
"RTN","MAGNVQ01",116,0)
 ;
"RTN","MAGNVQ01",117,0)
ASTUDY(STYIX,REFTYPE,REFIEN,CONTEXT) ; Append Study section
"RTN","MAGNVQ01",118,0)
 N FILESTD,IENSSTD,MAGDFN,MAGOUTST,MAGOUTPR,MAGERR,UID,INFO,PROCIX
"RTN","MAGNVQ01",119,0)
 ;
"RTN","MAGNVQ01",120,0)
 S FILESTD=2005.62
"RTN","MAGNVQ01",121,0)
 S IENSSTD=STYIX_","
"RTN","MAGNVQ01",122,0)
 D GETS^DIQ(FILESTD,STYIX,"**","RIE","MAGOUTST","MAGERR")
"RTN","MAGNVQ01",123,0)
 I REFIEN="" D 
"RTN","MAGNVQ01",124,0)
 . N ACNUMB
"RTN","MAGNVQ01",125,0)
 . S ACNUMB=MAGOUTST(FILESTD,IENSSTD,"ACCESSION NUMBER","I")
"RTN","MAGNVQ01",126,0)
 . D REFBYACN^MAGNU003(.REFTYPE,.REFIEN,ACNUMB)  ; Set Reference type by Accession Number
"RTN","MAGNVQ01",127,0)
 . S CONTEXT=$$CPRSCTX^MAGNU003(REFTYPE,REFIEN)
"RTN","MAGNVQ01",128,0)
 . Q
"RTN","MAGNVQ01",129,0)
 ;
"RTN","MAGNVQ01",130,0)
 S UID=MAGOUTST(FILESTD,IENSSTD,"STUDY INSTANCE UID","I")
"RTN","MAGNVQ01",131,0)
 D WRTOUT("NEXT_STUDY|"_UID_"|NEW")
"RTN","MAGNVQ01",132,0)
 D WRTOUT("STUDY_UID|"_UID)
"RTN","MAGNVQ01",133,0)
 D WRTOUT("STUDY_IEN|"_$$STUDYIEN(.MAGOUTST,IENSSTD))
"RTN","MAGNVQ01",134,0)
 D WRTOUT("STUDY_INFO|"_$$STDINFO(.MAGOUTST,IENSSTD)_"|"_REFTYPE_"-"_REFIEN_"|"_CONTEXT)
"RTN","MAGNVQ01",135,0)
 ;
"RTN","MAGNVQ01",136,0)
 S MAGDFN=MAGOUTST(FILESTD,IENSSTD,"PATIENT REFERENCE","E")
"RTN","MAGNVQ01",137,0)
 D WRTOUT("STUDY_PAT|"_MAGDFN_"|"_$S($T(GETICN^MPIF001)'="":$$GETICN^MPIF001(MAGDFN),1:"-1^NO MPI")_"|"_$P($G(^DPT(MAGDFN,0)),"^",1))
"RTN","MAGNVQ01",138,0)
 ;
"RTN","MAGNVQ01",139,0)
 D WRTOUT("STUDY_MODALITY|"_MAGOUTST(FILESTD,IENSSTD,"MODALITIES IN STUDY","E"))
"RTN","MAGNVQ01",140,0)
 Q
"RTN","MAGNVQ01",141,0)
 ;
"RTN","MAGNVQ01",142,0)
STUDYIEN(MAGOUTST,IENSSTD) ; Return study IEN section
"RTN","MAGNVQ01",143,0)
 N INFO,FILESTD
"RTN","MAGNVQ01",144,0)
 S FILESTD=2005.62
"RTN","MAGNVQ01",145,0)
 S $P(INFO,"|",1)=+IENSSTD
"RTN","MAGNVQ01",146,0)
 S $P(INFO,"|",2)=$G(MAGOUTST(FILESTD,IENSSTD,"NUMBER OF SOP INSTANCES","I"))
"RTN","MAGNVQ01",147,0)
 Q INFO
"RTN","MAGNVQ01",148,0)
 ;
"RTN","MAGNVQ01",149,0)
STDINFO(MAGOUTST,IENSSTD) ; Return study info section
"RTN","MAGNVQ01",150,0)
 N INFO,FILEPRC,PROCIX,IENSPRC,FILESTD,MAGOUTPR,MAGERR
"RTN","MAGNVQ01",151,0)
 ;
"RTN","MAGNVQ01",152,0)
 S FILESTD=2005.62
"RTN","MAGNVQ01",153,0)
 S FILEPRC=2005.61
"RTN","MAGNVQ01",154,0)
 S PROCIX=MAGOUTST(FILESTD,IENSSTD,"PROCEDURE REFERENCE","I")
"RTN","MAGNVQ01",155,0)
 S IENSPRC=PROCIX_","
"RTN","MAGNVQ01",156,0)
 D GETS^DIQ(FILEPRC,PROCIX,"**","RIE","MAGOUTPR","MAGERR")
"RTN","MAGNVQ01",157,0)
 ;
"RTN","MAGNVQ01",158,0)
 S $P(INFO,U,4)=$$DTE^MAGSIXG3($G(MAGOUTPR(FILEPRC,IENSPRC,"PROCEDURE DATE/TIME","I")))
"RTN","MAGNVQ01",159,0)
 S $P(INFO,U,6)=$G(MAGOUTST(FILESTD,IENSSTD,"DESCRIPTION","I")) ; description
"RTN","MAGNVQ01",160,0)
 S $P(INFO,U,8)=$G(MAGOUTPR(FILEPRC,IENSPRC,"PACKAGE INDEX","I"))
"RTN","MAGNVQ01",161,0)
 S $P(INFO,U,13)=$G(MAGOUTST(FILESTD,IENSSTD,"ORIGIN INDEX","E"))
"RTN","MAGNVQ01",162,0)
 S $P(INFO,U,14)=$$DTE^MAGSIXG3($G(MAGOUTST(FILESTD,IENSSTD,"STUDY DATE/TIME","I")))  ; study date 
"RTN","MAGNVQ01",163,0)
 S $P(INFO,U,20)=$G(MAGOUTST(FILESTD,IENSSTD,"ACCESSION NUMBER","I")) ; Accession number
"RTN","MAGNVQ01",164,0)
 Q INFO
"RTN","MAGNVQ01",165,0)
 ;
"RTN","MAGNVQ01",166,0)
ASERIES(SERIX) ; Append Series section
"RTN","MAGNVQ01",167,0)
 N FILESER,IENSSER,MAGOUTSR,MAGERR
"RTN","MAGNVQ01",168,0)
 S FILESER=2005.63
"RTN","MAGNVQ01",169,0)
 S IENSSER=SERIX_","
"RTN","MAGNVQ01",170,0)
 D GETS^DIQ(FILESER,SERIX,"**","RIE","MAGOUTSR","MAGERR")
"RTN","MAGNVQ01",171,0)
 ;
"RTN","MAGNVQ01",172,0)
 D WRTOUT("NEXT_SERIES")
"RTN","MAGNVQ01",173,0)
 D WRTOUT("SERIES_UID|"_$G(MAGOUTSR(FILESER,IENSSER,"SERIES INSTANCE UID","I")))
"RTN","MAGNVQ01",174,0)
 D WRTOUT("SERIES_IEN|"_SERIX)
"RTN","MAGNVQ01",175,0)
 D WRTOUT("SERIES_MODALITY|"_$G(MAGOUTSR(FILESER,IENSSER,"MODALITY","E")))
"RTN","MAGNVQ01",176,0)
 D WRTOUT("SERIES_NUMBER|"_$G(MAGOUTSR(FILESER,IENSSER,"SERIES NUMBER","I")))
"RTN","MAGNVQ01",177,0)
 D WRTOUT("SERIES_CLASS_INDEX|"_$G(MAGOUTSR(FILESER,IENSSER,"CLASS INDEX","I")))
"RTN","MAGNVQ01",178,0)
 D WRTOUT("SERIES_PROC/EVENT_INDEX|"_$G(MAGOUTSR(FILESER,IENSSER,"PROC/EVENT INDEX","I")))
"RTN","MAGNVQ01",179,0)
 D WRTOUT("SERIES_SPEC/SUBSPEC_INDEX|"_$G(MAGOUTSR(FILESER,IENSSER,"SPEC/SUBSPEC INDEX","I")))
"RTN","MAGNVQ01",180,0)
 Q
"RTN","MAGNVQ01",181,0)
 ;
"RTN","MAGNVQ01",182,0)
ASOP(SOPIX,FIMAGE) ; Append SOP section
"RTN","MAGNVQ01",183,0)
 N FILEIMG,I,IENSIMG,FILESOP,IENSSOP,MAGOUTIM,MAGOUTSO,MAGERR
"RTN","MAGNVQ01",184,0)
 S FILESOP=2005.64
"RTN","MAGNVQ01",185,0)
 S IENSSOP=SOPIX_","
"RTN","MAGNVQ01",186,0)
 D GETS^DIQ(FILESOP,SOPIX,"**","RIE","MAGOUTSO","MAGERR")
"RTN","MAGNVQ01",187,0)
 D WRTOUT("NEXT_IMAGE")
"RTN","MAGNVQ01",188,0)
 D WRTOUT("IMAGE_IEN|"_SOPIX)
"RTN","MAGNVQ01",189,0)
 D WRTOUT("IMAGE_UID|"_$G(MAGOUTSO(FILESOP,IENSSOP,"SOP INSTANCE UID","E")))
"RTN","MAGNVQ01",190,0)
 D WRTOUT("IMAGE_NUMBER|"_$G(MAGOUTSO(FILESOP,IENSSOP,"INSTANCE NUMBER","E")))
"RTN","MAGNVQ01",191,0)
 D WRTOUT("IMAGE_INFO|"_$$IMGINFO(.MAGOUTSO,IENSSOP,FIMAGE))
"RTN","MAGNVQ01",192,0)
 Q
"RTN","MAGNVQ01",193,0)
 ;
"RTN","MAGNVQ01",194,0)
AIMAGE(SOPIX,IMAGE) ; Append Image section
"RTN","MAGNVQ01",195,0)
 N FILEIMG,IENSIMG,MAGOUTIM,MAGERR
"RTN","MAGNVQ01",196,0)
 ;
"RTN","MAGNVQ01",197,0)
 S FILEIMG=2005.65
"RTN","MAGNVQ01",198,0)
 S IENSIMG=IMAGE_","
"RTN","MAGNVQ01",199,0)
 D GETS^DIQ(FILEIMG,IMAGE,"**","RIE","MAGOUTIM","MAGERR")
"RTN","MAGNVQ01",200,0)
 ;
"RTN","MAGNVQ01",201,0)
 D AINST(MAGOUTIM(FILEIMG,IENSIMG,"ARTIFACT TOKEN","E"))  ; Add Artifact Instance
"RTN","MAGNVQ01",202,0)
 Q
"RTN","MAGNVQ01",203,0)
 ;
"RTN","MAGNVQ01",204,0)
IMGINFO(MAGOUTSO,IENSSOP,FIMAGE)  ;Get Image Info 
"RTN","MAGNVQ01",205,0)
 N INFO,FILESOP
"RTN","MAGNVQ01",206,0)
 S FILESOP=2005.64
"RTN","MAGNVQ01",207,0)
 ;
"RTN","MAGNVQ01",208,0)
 S $P(INFO,U,1)=+IENSSOP  ; Image IEN
"RTN","MAGNVQ01",209,0)
 S $P(INFO,U,2)="" ;fullFilename
"RTN","MAGNVQ01",210,0)
 S $P(INFO,U,3)="" ;absFilename
"RTN","MAGNVQ01",211,0)
 S $P(INFO,U,4)="" ;description
"RTN","MAGNVQ01",212,0)
 S $P(INFO,U,5)=""
"RTN","MAGNVQ01",213,0)
 S $P(INFO,U,6)=$G(MAGOUTSO(FILESOP,IENSSOP,"TYPE INDEX","E"))  ; Image type
"RTN","MAGNVQ01",214,0)
 S $P(INFO,U,7)="" ;procedure
"RTN","MAGNVQ01",215,0)
 S $P(INFO,U,8)="" ;procedureDate 
"RTN","MAGNVQ01",216,0)
 S $P(INFO,U,9)=""
"RTN","MAGNVQ01",217,0)
 S $P(INFO,U,10)="" ;absLocation
"RTN","MAGNVQ01",218,0)
 S $P(INFO,U,11)="" ;fullLocation
"RTN","MAGNVQ01",219,0)
 S $P(INFO,U,12)="" ;dicomSequenceNumberForDisplay
"RTN","MAGNVQ01",220,0)
 S $P(INFO,U,13)="" ;dicomImageNumberForDisplay
"RTN","MAGNVQ01",221,0)
 S $P(INFO,U,14)=""
"RTN","MAGNVQ01",222,0)
 S $P(INFO,U,15)=""
"RTN","MAGNVQ01",223,0)
 S $P(INFO,U,16)="" ;siteAbbr
"RTN","MAGNVQ01",224,0)
 S $P(INFO,U,17)="" ;qaMessage
"RTN","MAGNVQ01",225,0)
 S $P(INFO,U,18)="" ;bigFilename
"RTN","MAGNVQ01",226,0)
 S $P(INFO,U,19)="" ;patientDFN
"RTN","MAGNVQ01",227,0)
 S $P(INFO,U,20)="" ;patientName
"RTN","MAGNVQ01",228,0)
 S $P(INFO,U,21)="" ;imageClass
"RTN","MAGNVQ01",229,0)
 S $P(INFO,U,22)=$$DTE($G(MAGOUTSO(FILESOP,IENSSOP,"ACQUISITION DATE/TIME","I")))  ; 09/12/2017 16:29:32  ;captureDate
"RTN","MAGNVQ01",230,0)
 S $P(INFO,U,23)="" ;documentDate
"RTN","MAGNVQ01",231,0)
 S $P(INFO,U,24)="" ;is the IEN of the group for the image
"RTN","MAGNVQ01",232,0)
 S $P(INFO,U,25)="" ;is the IEN of the first image in a group
"RTN","MAGNVQ01",233,0)
 S $P(INFO,U,26)="" ;is the Image type of the first image in the group
"RTN","MAGNVQ01",234,0)
 S $P(INFO,U,27)=""
"RTN","MAGNVQ01",235,0)
 S $P(INFO,U,28)=$$GET1^DIQ(2005.65,FIMAGE,"18","I") ; CONFIDENTIAL /Sensitive Image
"RTN","MAGNVQ01",236,0)
 S $P(INFO,U,29)="" ;viewStatusValue
"RTN","MAGNVQ01",237,0)
 S $P(INFO,U,30)="" ;statusValue
"RTN","MAGNVQ01",238,0)
 S $P(INFO,U,31)="" ;imageHasAnnotationsValue
"RTN","MAGNVQ01",239,0)
 S $P(INFO,U,32)="" ;associatedNoteResulted
"RTN","MAGNVQ01",240,0)
 S $P(INFO,U,33)="" ;imageAnnotationStatusValue
"RTN","MAGNVQ01",241,0)
 S $P(INFO,U,34)="" ;imageAnnotationStatusDescription
"RTN","MAGNVQ01",242,0)
 S $P(INFO,U,35)="" ;imagePackage
"RTN","MAGNVQ01",243,0)
 Q INFO
"RTN","MAGNVQ01",244,0)
 ; 
"RTN","MAGNVQ01",245,0)
AINST(TOKEN)  ; Add Artifact Instance 
"RTN","MAGNVQ01",246,0)
 N KEY,VALUE,LINE,IEN,I,RES,TMPARR,QT
"RTN","MAGNVQ01",247,0)
 D GETAIENT^MAGVAG02(.RES,TOKEN,"") ; Get not deleted Artifact IEN by Token
"RTN","MAGNVQ01",248,0)
 I '$$ISOK^MAGVAF02(RES) Q
"RTN","MAGNVQ01",249,0)
 S IEN=$$GETVAL^MAGVAF02(RES)
"RTN","MAGNVQ01",250,0)
 D GETAINST^MAGVAG04(.TMPARR,IEN)
"RTN","MAGNVQ01",251,0)
 I '$$ISOK^MAGVAF02(TMPARR(0)) Q
"RTN","MAGNVQ01",252,0)
 S QT=$C(34)
"RTN","MAGNVQ01",253,0)
 S I=1
"RTN","MAGNVQ01",254,0)
 F  S I=$O(TMPARR(I)) Q:'I  S LINE=TMPARR(I) Q:LINE["</ARTIFACTINSTANCES"  D
"RTN","MAGNVQ01",255,0)
 . I LINE["<ARTIFACTINSTANCE" D WRTOUT("NEXT_ARTIFACTINSTANCE") Q
"RTN","MAGNVQ01",256,0)
 . I LINE["</ARTIFACTINSTANCE" Q
"RTN","MAGNVQ01",257,0)
 . S KEY=$P(TMPARR(I),"=",1)
"RTN","MAGNVQ01",258,0)
 . S VALUE=$TR($P(TMPARR(I),"=",2),QT,"")
"RTN","MAGNVQ01",259,0)
 . S VALUE=$P(VALUE," >")  ; special handling because of XML result set
"RTN","MAGNVQ01",260,0)
 . D WRTOUT("ARTIFACTINSTANCE_"_KEY_"|"_VALUE)
"RTN","MAGNVQ01",261,0)
 . I KEY="DISKVOLUME" D  ; Add Phisical address
"RTN","MAGNVQ01",262,0)
 . . N LOCATION
"RTN","MAGNVQ01",263,0)
 . . S LOCATION=$$GET1^DIQ(2005.2,VALUE,"1")
"RTN","MAGNVQ01",264,0)
 . . D WRTOUT("ARTIFACTINSTANCE_PHYSICALREFERENCE|"_LOCATION)
"RTN","MAGNVQ01",265,0)
 . . Q
"RTN","MAGNVQ01",266,0)
 . I KEY="STORAGEPROVIDER" D  ; Add Storage provider name
"RTN","MAGNVQ01",267,0)
 . . D WRTOUT("ARTIFACTINSTANCE_STORAGEPROVIDERTYPE|"_$$GET1^DIQ(2006.917,VALUE,"2"))
"RTN","MAGNVQ01",268,0)
 . . Q
"RTN","MAGNVQ01",269,0)
 . I KEY="ARTIFACT" D  ; Add ARTIFACT FORMAT
"RTN","MAGNVQ01",270,0)
 . . D WRTOUT("ARTIFACTINSTANCE_ARTIFACTFORMAT|"_$$GET1^DIQ(2006.916,VALUE,"2:3"))
"RTN","MAGNVQ01",271,0)
 . . Q
"RTN","MAGNVQ01",272,0)
 . Q
"RTN","MAGNVQ01",273,0)
 Q
"RTN","MAGNVQ01",274,0)
 ;
"RTN","MAGNVQ01",275,0)
 ;+++++ PERFORMS SPECIAL CONVERSION OF THE DATE/TIME
"RTN","MAGNVQ01",276,0)
DTE(DTI) ;
"RTN","MAGNVQ01",277,0)
 Q $TR($$FMTE^XLFDT(DTI,"5Z"),"@"," ")
"RTN","MAGNVQ02")
0^12^B21293638
"RTN","MAGNVQ02",1,0)
MAGNVQ02 ;WOIFO/NST - Image query by Context ; 16 Oct 2017 3:59 PM
"RTN","MAGNVQ02",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 4525;May 01, 2013
"RTN","MAGNVQ02",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNVQ02",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ02",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNVQ02",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNVQ02",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNVQ02",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNVQ02",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNVQ02",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNVQ02",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNVQ02",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNVQ02",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNVQ02",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNVQ02",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNVQ02",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ02",17,0)
 ;;
"RTN","MAGNVQ02",18,0)
 Q
"RTN","MAGNVQ02",19,0)
 ;
"RTN","MAGNVQ02",20,0)
 ;*****  Check for images by context
"RTN","MAGNVQ02",21,0)
 ;       
"RTN","MAGNVQ02",22,0)
 ; RPC: MAGN IMAGE EXIST BY CONTEXT
"RTN","MAGNVQ02",23,0)
 ; 
"RTN","MAGNVQ02",24,0)
 ; Input Parameters
"RTN","MAGNVQ02",25,0)
 ; ================
"RTN","MAGNVQ02",26,0)
 ; 
"RTN","MAGNVQ02",27,0)
 ; DATA - Array contexts in format
"RTN","MAGNVQ02",28,0)
 ;         e.g. 'RPT^CPRS^29027^RA^79029185.9998-1'
"RTN","MAGNVQ02",29,0)
 ;                or
"RTN","MAGNVQ02",30,0)
 ;               RPT^CPRS^4658^TIU^2243408^^^^^^^^1
"RTN","MAGNVQ02",31,0)
 ;           
"RTN","MAGNVQ02",32,0)
 ; Return Values
"RTN","MAGNVQ02",33,0)
 ; =============
"RTN","MAGNVQ02",34,0)
 ; 
"RTN","MAGNVQ02",35,0)
 ; if error MAGRY(0) = 0 ^Error message^
"RTN","MAGNVQ02",36,0)
 ; if success MAGRY(0) = 1
"RTN","MAGNVQ02",37,0)
 ;            MAGRY(1..n) = CONTEXTID | 0 | error message
"RTN","MAGNVQ02",38,0)
 ;                          CONTEXTID | 1 | 0 or 1 (has images)
"RTN","MAGNVQ02",39,0)
 ;
"RTN","MAGNVQ02",40,0)
IMGEXIST(MAGRY,DATA) ;RPC [MAGN IMAGE EXIST BY CONTEXT]
"RTN","MAGNVQ02",41,0)
 N MAGNI,MAGNCNT,MAGNX,RESULT,HASIMAGE
"RTN","MAGNVQ02",42,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERRA^MAGGTERR"
"RTN","MAGNVQ02",43,0)
 K MAGRY
"RTN","MAGNVQ02",44,0)
 S MAGRY(0)=0
"RTN","MAGNVQ02",45,0)
 S MAGNCNT=0
"RTN","MAGNVQ02",46,0)
 S MAGNI=""
"RTN","MAGNVQ02",47,0)
 I $G(DATA)'="" S DATA(1)=DATA  ; in case of a single context ID
"RTN","MAGNVQ02",48,0)
 F  S MAGNI=$O(DATA(MAGNI)) Q:MAGNI=""  D
"RTN","MAGNVQ02",49,0)
 . S MAGNCXT=DATA(MAGNI)  ; contextID
"RTN","MAGNVQ02",50,0)
 . I $P(MAGNCXT,"^",1,2)'="RPT^CPRS" D  Q
"RTN","MAGNVQ02",51,0)
 . . D SETRES(.MAGRY,.MAGNCNT,MAGNCXT,"0^Unsupported ContextId Type",0)
"RTN","MAGNVQ02",52,0)
 . . Q
"RTN","MAGNVQ02",53,0)
 . ;
"RTN","MAGNVQ02",54,0)
 . S MAGNX=$P(MAGNCXT,"^",4)
"RTN","MAGNVQ02",55,0)
 . I MAGNX="RA" D  Q
"RTN","MAGNVQ02",56,0)
 . . S HASIMAGE=$$IMAGERA(MAGNCXT)  ; get image list for a single Radiology contextID
"RTN","MAGNVQ02",57,0)
 . . D SETRES(.MAGRY,.MAGNCNT,MAGNCXT,1,HASIMAGE)
"RTN","MAGNVQ02",58,0)
 . . Q
"RTN","MAGNVQ02",59,0)
 . I MAGNX="TIU" D  Q
"RTN","MAGNVQ02",60,0)
 . . N MAGNTIU
"RTN","MAGNVQ02",61,0)
 . . S MAGNTIU=$P(MAGNCXT,"^",5)
"RTN","MAGNVQ02",62,0)
 . . S RESULT=$$IMAGETIU(MAGNTIU)  ; get image list for a single TIU contextID
"RTN","MAGNVQ02",63,0)
 . . D SETRES(.MAGRY,.MAGNCNT,MAGNCXT,1,HASIMAGE)
"RTN","MAGNVQ02",64,0)
 . . Q
"RTN","MAGNVQ02",65,0)
 . D SETRES(.MAGRY,.MAGNCNT,MAGNCXT,"0^Unsupported ContextId Type",0)
"RTN","MAGNVQ02",66,0)
 . Q
"RTN","MAGNVQ02",67,0)
 S MAGRY(0)=1
"RTN","MAGNVQ02",68,0)
 Q
"RTN","MAGNVQ02",69,0)
 ;
"RTN","MAGNVQ02",70,0)
IMAGERA(DATA) ;A copy from MAGGTRAI
"RTN","MAGNVQ02",71,0)
 ;   DATA is in format of Windows message received from CPRS
"RTN","MAGNVQ02",72,0)
 ;    example   'RPT^CPRS^29027^RA^i79029185.9998-1'
"RTN","MAGNVQ02",73,0)
 N DFN,ENT,INVDTTM,INVDT,INVTM,X,RARPT,ACN
"RTN","MAGNVQ02",74,0)
 S DFN=+$P(DATA,U,3)
"RTN","MAGNVQ02",75,0)
 S ENT=+$P($P(DATA,U,5),"-",2)
"RTN","MAGNVQ02",76,0)
 S INVDTTM=$P($P(DATA,U,5),"-",1)
"RTN","MAGNVQ02",77,0)
 S INVDT=$P(INVDTTM,".",1)
"RTN","MAGNVQ02",78,0)
 S INVTM=$P(INVDTTM,".",2)
"RTN","MAGNVQ02",79,0)
 F  Q:($L(INVDT)<8)  S INVDT=$E(INVDT,2,$L(INVDT))
"RTN","MAGNVQ02",80,0)
 S INVDTTM=INVDT_"."_INVTM
"RTN","MAGNVQ02",81,0)
 S RARPT=0
"RTN","MAGNVQ02",82,0)
 I '$D(^RADPT(DFN,"DT",INVDTTM,"P",ENT,0)) Q "0^INVALID Data : Attempt to access Exam failed."
"RTN","MAGNVQ02",83,0)
 S RARPT=$P(^RADPT(DFN,"DT",INVDTTM,"P",ENT,0),U,17)
"RTN","MAGNVQ02",84,0)
 I RARPT,($P($G(^RARPT(RARPT,0)),U,2)'=DFN) Q "0^Patient Mismatch. Radiology File"
"RTN","MAGNVQ02",85,0)
 ;
"RTN","MAGNVQ02",86,0)
 I $P($G(^RARPT(RARPT,2005,0)),U,4) Q 1
"RTN","MAGNVQ02",87,0)
 ;
"RTN","MAGNVQ02",88,0)
 S ACN=$$ACCNUM^RAAPI(DFN,INVDTTM,ENT)
"RTN","MAGNVQ02",89,0)
 I $L(ACN,"-")=3 S ACN=$P(ACN,"-",2,3)
"RTN","MAGNVQ02",90,0)
 ;
"RTN","MAGNVQ02",91,0)
 S X=$$IMAGVX(ACN,"RAD") ; Check for images in P34 data structure
"RTN","MAGNVQ02",92,0)
 Q X
"RTN","MAGNVQ02",93,0)
 ;
"RTN","MAGNVQ02",94,0)
IMAGVX(ACCN,TYPE) ; Image in P34 data structure by Accession
"RTN","MAGNVQ02",95,0)
 N PROCIEN,AOF
"RTN","MAGNVQ02",96,0)
 ; Check for images in P34 data structure
"RTN","MAGNVQ02",97,0)
 I ACCN="" Q 0
"RTN","MAGNVQ02",98,0)
 S PROCIEN=""
"RTN","MAGNVQ02",99,0)
 S AOF=0
"RTN","MAGNVQ02",100,0)
 F  S PROCIEN=$O(^MAGV(2005.61,"B",ACCN,PROCIEN)) Q:'PROCIEN  D  Q:AOF
"RTN","MAGNVQ02",101,0)
 . I TYPE'=$$GET1^DIQ(2005.61,PROCIEN,.03,"I") Q  ; Not the same procedure type
"RTN","MAGNVQ02",102,0)
 . S AOF=+$$GET1^DIQ(2005.61,PROCIEN,2,"I")  ; Artifact on file
"RTN","MAGNVQ02",103,0)
 . Q
"RTN","MAGNVQ02",104,0)
 Q AOF
"RTN","MAGNVQ02",105,0)
 ;
"RTN","MAGNVQ02",106,0)
IMAGETIU(MAGTIU) ; 
"RTN","MAGNVQ02",107,0)
 N ACCN,CONSIX,MAGARR,MAGDFN,MAGMRC
"RTN","MAGNVQ02",108,0)
 ;
"RTN","MAGNVQ02",109,0)
 S MAGDFN=$$GET1^DIQ(8925,MAGTIU,.02,"I") ;MAGQI 8/22/01
"RTN","MAGNVQ02",110,0)
 I 'MAGDFN Q "0^Invalid Patient DFN for Note ID: '"_MAGTIU_"'"
"RTN","MAGNVQ02",111,0)
 ;
"RTN","MAGNVQ02",112,0)
 D GETILST^TIUSRVPL(.MAGARR,MAGTIU)  ; get Images from old data structure (2005)
"RTN","MAGNVQ02",113,0)
 I $D(MAGARR) Q 1
"RTN","MAGNVQ02",114,0)
 ;
"RTN","MAGNVQ02",115,0)
 D GET1405^TIUSRVR(.MAGMRC,MAGTIU)
"RTN","MAGNVQ02",116,0)
 S CONSIX=+MAGMRC
"RTN","MAGNVQ02",117,0)
 I (CONSIX'>0)!'(MAGMRC["GMR(123") Q 0
"RTN","MAGNVQ02",118,0)
 S ACCN=$$GMRCACN^MAGDFCNV(CONSIX)  ; site-specific accession number
"RTN","MAGNVQ02",119,0)
 ;
"RTN","MAGNVQ02",120,0)
 S X=$$IMAGVX(ACCN,"CON")
"RTN","MAGNVQ02",121,0)
 Q X
"RTN","MAGNVQ02",122,0)
 ;
"RTN","MAGNVQ02",123,0)
SETRES(MAGRY,MAGNCNT,MAGNCXT,RESULT,HASIMAGE) ; Append result for one context
"RTN","MAGNVQ02",124,0)
 S MAGNCNT=MAGNCNT+1
"RTN","MAGNVQ02",125,0)
 S MAGRY(MAGNCNT)=MAGNCXT_"|"_RESULT_"|"_HASIMAGE
"RTN","MAGNVQ02",126,0)
 Q
"RTN","MAGNVQ03")
0^13^B37899553
"RTN","MAGNVQ03",1,0)
MAGNVQ03 ;WOIFO/NST - Retrieve Image Info ; 02 Oct 2017 3:59 PM
"RTN","MAGNVQ03",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 4525;May 01, 2013
"RTN","MAGNVQ03",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNVQ03",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ03",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNVQ03",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNVQ03",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNVQ03",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNVQ03",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNVQ03",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNVQ03",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNVQ03",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNVQ03",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNVQ03",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNVQ03",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNVQ03",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ03",17,0)
 ;;
"RTN","MAGNVQ03",18,0)
 Q
"RTN","MAGNVQ03",19,0)
 ;
"RTN","MAGNVQ03",20,0)
 ;*****  Return Image Info Report
"RTN","MAGNVQ03",21,0)
 ;       
"RTN","MAGNVQ03",22,0)
 ; 
"RTN","MAGNVQ03",23,0)
 ; Input Parameters
"RTN","MAGNVQ03",24,0)
 ; ================
"RTN","MAGNVQ03",25,0)
 ; 
"RTN","MAGNVQ03",26,0)
 ; DATA - Image IEN in IMAGE SOP INSTANCE file (#2005.64) 
"RTN","MAGNVQ03",27,0)
 ; Return Values
"RTN","MAGNVQ03",28,0)
 ; =============
"RTN","MAGNVQ03",29,0)
 ; 
"RTN","MAGNVQ03",30,0)
 ; if error MAGRY(0) = 0 ^Error message^
"RTN","MAGNVQ03",31,0)
 ; if success MAGRY(0) = 1
"RTN","MAGNVQ03",32,0)
 ;            MAGRY(1..n) =  Image Info Report
"RTN","MAGNVQ03",33,0)
 ;
"RTN","MAGNVQ03",34,0)
IMGINFO(MAGRY,DATA) ; Return Image Info Report
"RTN","MAGNVQ03",35,0)
 N MAGPAT,MAGPROC,MAGSTUDY,MAGSER,MAGSOP,MAGIMAGE,MAGAFACT,MAGAINST
"RTN","MAGNVQ03",36,0)
 N CNT,ERR,FILE,IEN,IENS,LINE,IMAGE
"RTN","MAGNVQ03",37,0)
 ;
"RTN","MAGNVQ03",38,0)
 N $ETRAP,$ESTACK S $ETRAP="D AERRA^MAGGTERR"
"RTN","MAGNVQ03",39,0)
 ;
"RTN","MAGNVQ03",40,0)
 K @MAGRY
"RTN","MAGNVQ03",41,0)
 ; Get SOP Details
"RTN","MAGNVQ03",42,0)
 S FILE("SOP")=2005.64
"RTN","MAGNVQ03",43,0)
 S IEN("SOP")=DATA
"RTN","MAGNVQ03",44,0)
 S IENS("SOP")=IEN("SOP")_","
"RTN","MAGNVQ03",45,0)
 D GETS^DIQ(FILE("SOP"),IEN("SOP"),"**","RIEN","MAGSOP","ERR")
"RTN","MAGNVQ03",46,0)
 I $D(ERR) S @MAGRY@(0)="0^"_$$ERRTEXT("GETS",FILE("SOP"),IEN("SOP"),.ERR) Q
"RTN","MAGNVQ03",47,0)
 ;
"RTN","MAGNVQ03",48,0)
 ; Get Series Details
"RTN","MAGNVQ03",49,0)
 S FILE("SERIES")=2005.63
"RTN","MAGNVQ03",50,0)
 S IEN("SERIES")=$G(MAGSOP(FILE("SOP"),IENS("SOP"),"SERIES REFERENCE","I"))
"RTN","MAGNVQ03",51,0)
 S IENS("SERIES")=IEN("SERIES")_","
"RTN","MAGNVQ03",52,0)
 D GETS^DIQ(FILE("SERIES"),IEN("SERIES"),"**","RIEN","MAGSER","ERR")
"RTN","MAGNVQ03",53,0)
 I $D(ERR) S @MAGRY@(0)="0^"_$$ERRTEXT("GETS",FILE("SERIES"),IEN("SERIES"),.ERR) Q
"RTN","MAGNVQ03",54,0)
 ;
"RTN","MAGNVQ03",55,0)
 ; Get Study Details
"RTN","MAGNVQ03",56,0)
 S FILE("STUDY")=2005.62
"RTN","MAGNVQ03",57,0)
 S IEN("STUDY")=$G(MAGSER(FILE("SERIES"),IENS("SERIES"),"STUDY REFERENCE","I"))
"RTN","MAGNVQ03",58,0)
 S IENS("STUDY")=IEN("STUDY")_","
"RTN","MAGNVQ03",59,0)
 D GETS^DIQ(FILE("STUDY"),IEN("STUDY"),"**","RIEN","MAGSTUDY","ERR")
"RTN","MAGNVQ03",60,0)
 I $D(ERR) S @MAGRY@(0)="0^"_$$ERRTEXT("GETS",FILE("STUDY"),IEN("STUDY"),.ERR) Q
"RTN","MAGNVQ03",61,0)
 ;
"RTN","MAGNVQ03",62,0)
 ; Get Procedure Details
"RTN","MAGNVQ03",63,0)
 S FILE("PROCEDURE")=2005.61
"RTN","MAGNVQ03",64,0)
 S IEN("PROCEDURE")=$G(MAGSTUDY(FILE("STUDY"),IENS("STUDY"),"PROCEDURE REFERENCE","I"))
"RTN","MAGNVQ03",65,0)
 S IENS("PROCEDURE")=IEN("PROCEDURE")_","
"RTN","MAGNVQ03",66,0)
 D GETS^DIQ(FILE("PROCEDURE"),IEN("PROCEDURE"),"**","RIEN","MAGPROC","ERR")
"RTN","MAGNVQ03",67,0)
 I $D(ERR) S @MAGRY@(0)="0^"_$$ERRTEXT("GETS",FILE("PROCEDURE"),IEN("PROCEDURE"),.ERR) Q
"RTN","MAGNVQ03",68,0)
 ;
"RTN","MAGNVQ03",69,0)
 ; Get Patient Details
"RTN","MAGNVQ03",70,0)
 S FILE("PATIENT")=2005.6
"RTN","MAGNVQ03",71,0)
 S IEN("PATIENT")=$G(MAGPROC(FILE("PROCEDURE"),IENS("PROCEDURE"),"PATIENT REFERENCE","I"))
"RTN","MAGNVQ03",72,0)
 S IENS("PATIENT")=IEN("PATIENT")_","
"RTN","MAGNVQ03",73,0)
 D GETS^DIQ(FILE("PATIENT"),IEN("PATIENT"),"**","RIEN","MAGPAT","ERR")
"RTN","MAGNVQ03",74,0)
 I $D(ERR) S @MAGRY@(0)="0^"_$$ERRTEXT("GETS",FILE("PATIENT"),IEN("PATIENT"),.ERR) Q
"RTN","MAGNVQ03",75,0)
 ;
"RTN","MAGNVQ03",76,0)
 S CNT=0
"RTN","MAGNVQ03",77,0)
 D ADD(MAGRY,.CNT,.MAGPAT,FILE("PATIENT"),IENS("PATIENT"))      ; Add Patient details
"RTN","MAGNVQ03",78,0)
 D ADD(MAGRY,.CNT,.MAGPROC,FILE("PROCEDURE"),IENS("PROCEDURE")) ; Add Procedure details
"RTN","MAGNVQ03",79,0)
 D ADD(MAGRY,.CNT,.MAGSTUDY,FILE("STUDY"),IENS("STUDY"))        ; Add Study details
"RTN","MAGNVQ03",80,0)
 D ADD(MAGRY,.CNT,.MAGSER,FILE("SERIES"),IENS("SERIES"))        ; Add SERIES details
"RTN","MAGNVQ03",81,0)
 D ADD(MAGRY,.CNT,.MAGSOP,FILE("SOP"),IENS("SOP"))              ; Add SOP details
"RTN","MAGNVQ03",82,0)
 ;
"RTN","MAGNVQ03",83,0)
 S IMAGE=""
"RTN","MAGNVQ03",84,0)
 F  S IMAGE=$O(^MAGV(2005.65,"C",IEN("SOP"),IMAGE)) Q:'IMAGE  D
"RTN","MAGNVQ03",85,0)
 . D ADDIMGD(MAGRY,.CNT,IMAGE)
"RTN","MAGNVQ03",86,0)
 . Q
"RTN","MAGNVQ03",87,0)
 I $G(@MAGRY@(0))=0 Q  ; Error during adding records
"RTN","MAGNVQ03",88,0)
 ; 
"RTN","MAGNVQ03",89,0)
 S @MAGRY@(0)=1
"RTN","MAGNVQ03",90,0)
 Q
"RTN","MAGNVQ03",91,0)
 ;
"RTN","MAGNVQ03",92,0)
ADD(MAGRY,CNT,DATA,FILE,IENS) ; Add Entity details to array e.g. Patient, procedure
"RTN","MAGNVQ03",93,0)
 N ATTR,HEADER,LINE,TYEREF,HEADE,DASH,LEN
"RTN","MAGNVQ03",94,0)
 ;
"RTN","MAGNVQ03",95,0)
 I CNT>0 S CNT=CNT+1,@MAGRY@(CNT)=""
"RTN","MAGNVQ03",96,0)
 S HEADER=" "_$$GETFILNM^MAGVAF01(FILE)_" (#"_FILE_") "
"RTN","MAGNVQ03",97,0)
 S LEN=(78-$L(HEADER))\2
"RTN","MAGNVQ03",98,0)
 S DASH=$TR($J("-",LEN)," ","-")
"RTN","MAGNVQ03",99,0)
 S CNT=CNT+1,@MAGRY@(CNT)=DASH_HEADER_DASH
"RTN","MAGNVQ03",100,0)
 S CNT=CNT+1,@MAGRY@(CNT)=""
"RTN","MAGNVQ03",101,0)
 ; 
"RTN","MAGNVQ03",102,0)
 S ATTR=""
"RTN","MAGNVQ03",103,0)
 F  S ATTR=$O(DATA(FILE,IENS,ATTR)) Q:ATTR=""  D
"RTN","MAGNVQ03",104,0)
 . I $$ISFLDWP^MAGVAF01(.TYEREF,FILE,ATTR) D  Q
"RTN","MAGNVQ03",105,0)
 . . ; TO-DO Do word-procesing field
"RTN","MAGNVQ03",106,0)
 . . Q
"RTN","MAGNVQ03",107,0)
 . S LINE=ATTR
"RTN","MAGNVQ03",108,0)
 . S $E(LINE,25,999)=" = ("_$G(DATA(FILE,IENS,ATTR,"I"))_")"
"RTN","MAGNVQ03",109,0)
 . S:$G(DATA(FILE,IENS,ATTR,"E"))'=$G(DATA(FILE,IENS,ATTR,"I")) $E(LINE,45,999)=" = "_$G(DATA(FILE,IENS,ATTR,"E"))
"RTN","MAGNVQ03",110,0)
 . S CNT=CNT+1,@MAGRY@(CNT)=LINE
"RTN","MAGNVQ03",111,0)
 . Q
"RTN","MAGNVQ03",112,0)
 Q
"RTN","MAGNVQ03",113,0)
 ;
"RTN","MAGNVQ03",114,0)
ADDAINST(MAGRY,CNT,AFACTIEN)  ; Add Artifact Instance  
"RTN","MAGNVQ03",115,0)
 N MAGI,FILE,LINEHDR,TMPARR,MAGOUT,OUT,ERR,VALUE,LOCATION
"RTN","MAGNVQ03",116,0)
 ;
"RTN","MAGNVQ03",117,0)
 S FILE=2006.918
"RTN","MAGNVQ03",118,0)
 D FIND^DIC(FILE,,"@;","BQX",AFACTIEN,"","","","","OUT","ERR")
"RTN","MAGNVQ03",119,0)
 S MAGI=""  ; IENs
"RTN","MAGNVQ03",120,0)
 F  S MAGI=$O(OUT("DILIST",2,MAGI)) Q:'MAGI  D  Q:$D(ERR)
"RTN","MAGNVQ03",121,0)
 . S IEN=OUT("DILIST",2,MAGI)
"RTN","MAGNVQ03",122,0)
 . D GETS^DIQ(FILE,IEN,"**","RIEN","MAGOUT","ERR")
"RTN","MAGNVQ03",123,0)
 . I $D(ERR) S @MAGRY@(0)="0^"_$$ERRTEXT("GETS",FILE,IEN,.ERR) Q
"RTN","MAGNVQ03",124,0)
 . S VALUE=$G(MAGOUT(FILE,IEN_",","DISK VOLUME","I"))
"RTN","MAGNVQ03",125,0)
 . S MAGOUT(FILE,IEN_",","DISK VOLUME","E")=$G(MAGOUT(FILE,IEN_",","DISK VOLUME","E"))_" : "_$$GET1^DIQ(2005.2,VALUE,"1")
"RTN","MAGNVQ03",126,0)
 . D ADD(MAGRY,.CNT,.MAGOUT,FILE,IEN_",")
"RTN","MAGNVQ03",127,0)
 . Q
"RTN","MAGNVQ03",128,0)
 Q
"RTN","MAGNVQ03",129,0)
 ;
"RTN","MAGNVQ03",130,0)
ADDIMGD(MAGRY,CNT,IMAGE)  ; Add one SOP instance
"RTN","MAGNVQ03",131,0)
 N FILE,IEN,IENS,ERR,MAGIMAGE,MAGAFACT
"RTN","MAGNVQ03",132,0)
 ;
"RTN","MAGNVQ03",133,0)
 S FILE("IMAGE")=2005.65
"RTN","MAGNVQ03",134,0)
 S IEN("IMAGE")=IMAGE
"RTN","MAGNVQ03",135,0)
 S IENS("IMAGE")=IMAGE_","
"RTN","MAGNVQ03",136,0)
 K MAGOUT
"RTN","MAGNVQ03",137,0)
 D GETS^DIQ(FILE("IMAGE"),IEN("IMAGE"),"**","RIEN","MAGIMAGE","ERR")
"RTN","MAGNVQ03",138,0)
 I $D(ERR) S @MAGRY@(0)="0^"_$$ERRTEXT("GETS",FILE("IMAGE"),IEN("IMAGE"),.ERR) Q
"RTN","MAGNVQ03",139,0)
 D ADD(MAGRY,.CNT,.MAGIMAGE,FILE("IMAGE"),IENS("IMAGE"))
"RTN","MAGNVQ03",140,0)
 ;
"RTN","MAGNVQ03",141,0)
 ; Get Artifact Details
"RTN","MAGNVQ03",142,0)
 S FILE("ARTIFACT")=2006.916
"RTN","MAGNVQ03",143,0)
 S IEN("ARTIFACT")=$G(MAGIMAGE(FILE("IMAGE"),IENS("IMAGE"),"ARTIFACT REFERENCE","I"))
"RTN","MAGNVQ03",144,0)
 S IENS("ARTIFACT")=IEN("ARTIFACT")_","
"RTN","MAGNVQ03",145,0)
 D GETS^DIQ(FILE("ARTIFACT"),IEN("ARTIFACT"),"**","RIEN","MAGAFACT","ERR")
"RTN","MAGNVQ03",146,0)
 I $D(ERR) S @MAGRY@(0)="0^"_$$ERRTEXT("GETS",FILE("ARTIFACT"),IEN("ARTIFACT"),.ERR) Q
"RTN","MAGNVQ03",147,0)
 ;
"RTN","MAGNVQ03",148,0)
 D ADDAINST(MAGRY,.CNT,MAGIMAGE(FILE("IMAGE"),IENS("IMAGE"),"ARTIFACT REFERENCE","I"))  ; Add Artifact Instance 
"RTN","MAGNVQ03",149,0)
 ;
"RTN","MAGNVQ03",150,0)
 Q
"RTN","MAGNVQ03",151,0)
 ;
"RTN","MAGNVQ03",152,0)
ERRTEXT(ACTION,FILE,IEN,ERR) ; Format error message
"RTN","MAGNVQ03",153,0)
 Q ACTION_" : "_FILE_" : "_IEN_" : "_$G(ERR("DIERR",1,"TEXT",1))
"RTN","MAGNVQ04")
0^14^B18123604
"RTN","MAGNVQ04",1,0)
MAGNVQ04 ;WOIFO/NST - List images for a patient ; 28 Sep 2017 3:59 PM
"RTN","MAGNVQ04",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 4525;May 01, 2013
"RTN","MAGNVQ04",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNVQ04",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ04",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNVQ04",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNVQ04",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNVQ04",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNVQ04",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNVQ04",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNVQ04",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNVQ04",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNVQ04",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNVQ04",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNVQ04",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNVQ04",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ04",17,0)
 ;;
"RTN","MAGNVQ04",18,0)
 Q
"RTN","MAGNVQ04",19,0)
 ;
"RTN","MAGNVQ04",20,0)
 ;*****  List Images by Patient
"RTN","MAGNVQ04",21,0)
 ;       
"RTN","MAGNVQ04",22,0)
 ; RPC: MAGN PATIENT IMAGE LIST
"RTN","MAGNVQ04",23,0)
 ; 
"RTN","MAGNVQ04",24,0)
 ; Input Parameters
"RTN","MAGNVQ04",25,0)
 ; ================
"RTN","MAGNVQ04",26,0)
 ; 
"RTN","MAGNVQ04",27,0)
 ; IDTYPE = "DFN"or "ICN"
"RTN","MAGNVQ04",28,0)
 ; ID     = Patient ID  
"RTN","MAGNVQ04",29,0)
 ; [IMGLESS]  flag to speed up queries: if=1 (true), just get study-level data
"RTN","MAGNVQ04",30,0)
 ; [FLAGS]  for feature use
"RTN","MAGNVQ04",31,0)
 ;           
"RTN","MAGNVQ04",32,0)
 ; Return Values
"RTN","MAGNVQ04",33,0)
 ; =============
"RTN","MAGNVQ04",34,0)
 ; 
"RTN","MAGNVQ04",35,0)
 ; if error MAGRY(0) = 0 ^Error message^
"RTN","MAGNVQ04",36,0)
 ; if success MAGRY(0) = 1
"RTN","MAGNVQ04",37,0)
 ;            MAGRY(1..n) = images in format defined in RPC [MAGN CPRS IMAGE LIST]
"RTN","MAGNVQ04",38,0)
 ;
"RTN","MAGNVQ04",39,0)
IMAGEL(MAGRY,IDTYPE,ID,IMGLESS,FLAGS) ;RPC [MAGN PATIENT IMAGE LIST]
"RTN","MAGNVQ04",40,0)
 N DFN,MAGRY2005,MAGRYP34
"RTN","MAGNVQ04",41,0)
 ;
"RTN","MAGNVQ04",42,0)
 N $ETRAP,$ESTACK S $ETRAP="D AERRA^MAGGTERR"
"RTN","MAGNVQ04",43,0)
 S IMGLESS=$S($D(IMGLESS):+IMGLESS,1:1)  ; Defualt is IMAGELESS
"RTN","MAGNVQ04",44,0)
 S FLAGS=$G(FLAGS)
"RTN","MAGNVQ04",45,0)
 ;
"RTN","MAGNVQ04",46,0)
 S DFN=ID
"RTN","MAGNVQ04",47,0)
 S MAGRY=$NA(^TMP("MAGNVQ04",$J))
"RTN","MAGNVQ04",48,0)
 K @MAGRY
"RTN","MAGNVQ04",49,0)
 S @MAGRY@(0)=0
"RTN","MAGNVQ04",50,0)
 I (IDTYPE'="DFN")&(IDTYPE'="ICN") S @MAGRY@(0)="0^Invalid IDTYPE "_IDTYPE Q
"RTN","MAGNVQ04",51,0)
 I IDTYPE="ICN" D
"RTN","MAGNVQ04",52,0)
 . S DFN=$S($T(GETDFN^MPIF001)'="":$$GETDFN^MPIF001(ID),1:"-1^NO MPI") ; Supported IA (#2701)
"RTN","MAGNVQ04",53,0)
 . Q
"RTN","MAGNVQ04",54,0)
 I DFN'>0 S @MAGRY@(0)="0^Error: "_DFN Q
"RTN","MAGNVQ04",55,0)
 D IMG2005(MAGRY,DFN,IMGLESS,FLAGS) ; Get #2005 images 
"RTN","MAGNVQ04",56,0)
 ;
"RTN","MAGNVQ04",57,0)
 D IMAGEP34(MAGRY,DFN,IMGLESS,FLAGS)  ; Get P34 images
"RTN","MAGNVQ04",58,0)
 ;
"RTN","MAGNVQ04",59,0)
 S @MAGRY@(0)=1
"RTN","MAGNVQ04",60,0)
 Q
"RTN","MAGNVQ04",61,0)
 ;
"RTN","MAGNVQ04",62,0)
IMG2005(MAGRYOUT,DFN,IMGLESS,FLAGS) ; Get images from #2005
"RTN","MAGNVQ04",63,0)
 ; DFN     = Patient DFN
"RTN","MAGNVQ04",64,0)
 ; IMGLESS = 0|1 Include images
"RTN","MAGNVQ04",65,0)
 ; [FLAGS] = for feature use
"RTN","MAGNVQ04",66,0)
 ;
"RTN","MAGNVQ04",67,0)
 N I,IMAGE,GROUPS,OUT
"RTN","MAGNVQ04",68,0)
 S IMAGE=""
"RTN","MAGNVQ04",69,0)
 S I=0
"RTN","MAGNVQ04",70,0)
 F  S IMAGE=$O(^MAG(2005,"AC",DFN,IMAGE)) Q:IMAGE=""  D
"RTN","MAGNVQ04",71,0)
 . S I=I+1
"RTN","MAGNVQ04",72,0)
 . S GROUPS(I)=IMAGE
"RTN","MAGNVQ04",73,0)
 . Q
"RTN","MAGNVQ04",74,0)
 D STUDY2^MAGDQR21(.OUT,.GROUPS,DFN,IMGLESS)  ; MAG DOD GET STUDIES IEN
"RTN","MAGNVQ04",75,0)
 ;
"RTN","MAGNVQ04",76,0)
 D UPD2005(MAGRYOUT,.OUT,IMGLESS)
"RTN","MAGNVQ04",77,0)
 S MAGRYOUT=OUT
"RTN","MAGNVQ04",78,0)
 S @MAGRYOUT@(0)=1
"RTN","MAGNVQ04",79,0)
 Q
"RTN","MAGNVQ04",80,0)
 ;
"RTN","MAGNVQ04",81,0)
UPD2005(MAGOUT,MAGIN,IMGLESS) ; Add Additional study information
"RTN","MAGNVQ04",82,0)
 N MAGI,IMGIEN,MAGNCNT,MAGSTUDY
"RTN","MAGNVQ04",83,0)
 S MAGNCNT=0
"RTN","MAGNVQ04",84,0)
 S MAGI=1 ; start from line number 2. Line number 1 is a records count
"RTN","MAGNVQ04",85,0)
 F  S MAGI=$O(@MAGIN@(MAGI)) Q:'MAGI  D
"RTN","MAGNVQ04",86,0)
 . S MAGNCNT=MAGNCNT+1
"RTN","MAGNVQ04",87,0)
 . S @MAGOUT@(MAGNCNT)=@MAGIN@(MAGI)
"RTN","MAGNVQ04",88,0)
 . I $P(@MAGIN@(MAGI),"|")="STUDY_IEN" D   ; Add STUDY_INFO. Better place will be MAGDQR21
"RTN","MAGNVQ04",89,0)
 . . S MAGNCNT=MAGNCNT+1
"RTN","MAGNVQ04",90,0)
 . . S IMGIEN=$P(@MAGIN@(MAGI),"|",2)  ; IEN of the group
"RTN","MAGNVQ04",91,0)
 . . S @MAGOUT@(MAGNCNT)="STUDY_INFO|"_$$STDINFO(IMGIEN)
"RTN","MAGNVQ04",92,0)
 . . S MAGSTUDY=@MAGIN@(MAGI)
"RTN","MAGNVQ04",93,0)
 . . Q
"RTN","MAGNVQ04",94,0)
 . I IMGLESS,($P(@MAGIN@(MAGI),"|")="STUDY_PAT") D INSFIMG^MAGNU003(MAGSTUDY,.MAGNCNT,MAGOUT)  ; Append First Image Info
"RTN","MAGNVQ04",95,0)
 . Q
"RTN","MAGNVQ04",96,0)
 Q
"RTN","MAGNVQ04",97,0)
 ;
"RTN","MAGNVQ04",98,0)
IMAGEP34(MAGRY,DFN,IMGLESS,FLAGS) ; Get P34 images
"RTN","MAGNVQ04",99,0)
 ; DFN     = Patient DFN
"RTN","MAGNVQ04",100,0)
 ; IMGLESS = 0|1 Include images
"RTN","MAGNVQ04",101,0)
 ; [FLAGS] = for feature use
"RTN","MAGNVQ04",102,0)
 ;
"RTN","MAGNVQ04",103,0)
 N IARRAY
"RTN","MAGNVQ04",104,0)
 D PATIMG34^MAGNVQ05(.IARRAY,DFN,IMGLESS,FLAGS)  ; Get patient images
"RTN","MAGNVQ04",105,0)
 ;
"RTN","MAGNVQ04",106,0)
 D GETSTUDY^MAGNVQ01(MAGRY,.IARRAY,"","","") ; Get Study by graph ien
"RTN","MAGNVQ04",107,0)
 Q
"RTN","MAGNVQ04",108,0)
 ;
"RTN","MAGNVQ04",109,0)
STDINFO(IMGIEN)  ; Get Study Info by IEN in IMAGE file (#2005)
"RTN","MAGNVQ04",110,0)
 N IMGNODE,X2,PFILE,REFTYPE,REFIEN
"RTN","MAGNVQ04",111,0)
 ;
"RTN","MAGNVQ04",112,0)
 S IMGNODE=$$NODE^MAGGI11(IMGIEN)
"RTN","MAGNVQ04",113,0)
 Q:IMGNODE="" ""
"RTN","MAGNVQ04",114,0)
 ;
"RTN","MAGNVQ04",115,0)
 S X2=$G(@IMGNODE@(2))
"RTN","MAGNVQ04",116,0)
 ;
"RTN","MAGNVQ04",117,0)
 S PFILE=$P(X2,U,6)  ; PARENT DATA FILE# 
"RTN","MAGNVQ04",118,0)
 S REFTYPE=$$GET1^DIQ(2005.03,PFILE,.02)
"RTN","MAGNVQ04",119,0)
 ;
"RTN","MAGNVQ04",120,0)
 S REFIEN=$P(X2,U,7) ;PARENT GLOBAL ROOT D0
"RTN","MAGNVQ04",121,0)
 ;
"RTN","MAGNVQ04",122,0)
 Q $$STDINFO^MAGNU003(IMGIEN,REFTYPE,REFIEN,"")
"RTN","MAGNVQ05")
0^15^B6884375
"RTN","MAGNVQ05",1,0)
MAGNVQ05 ;WOIFO/NST - List images for a patient ; 28 Sep 2017 3:59 PM
"RTN","MAGNVQ05",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 4525;May 01, 2013
"RTN","MAGNVQ05",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNVQ05",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ05",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNVQ05",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNVQ05",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNVQ05",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNVQ05",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNVQ05",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNVQ05",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNVQ05",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNVQ05",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNVQ05",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNVQ05",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNVQ05",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ05",17,0)
 ;;
"RTN","MAGNVQ05",18,0)
 Q
"RTN","MAGNVQ05",19,0)
 ;
"RTN","MAGNVQ05",20,0)
PATIMG34(IARRAY,DFN,IMGLESS,FLAGS) ; Get images from P34 database by Patient
"RTN","MAGNVQ05",21,0)
 ; IARRAY  = Output array with patient images
"RTN","MAGNVQ05",22,0)
 ; DFN     = Patient DFN
"RTN","MAGNVQ05",23,0)
 ; IMGLESS = 0|1 Include images
"RTN","MAGNVQ05",24,0)
 ; [FLAGS] = for feature use
"RTN","MAGNVQ05",25,0)
 ;
"RTN","MAGNVQ05",26,0)
 N PATIX,PROCIX,STYIX,SERIX,SOPIX,IMAGE
"RTN","MAGNVQ05",27,0)
 ;
"RTN","MAGNVQ05",28,0)
 S PATIX=""
"RTN","MAGNVQ05",29,0)
 F  S PATIX=$O(^MAGV(2005.6,"C",DFN,PATIX)) Q:'PATIX  D
"RTN","MAGNVQ05",30,0)
 . S PROCIX=""
"RTN","MAGNVQ05",31,0)
 . F  S PROCIX=$O(^MAGV(2005.61,"C",PATIX,PROCIX)) Q:'PROCIX  D
"RTN","MAGNVQ05",32,0)
 . . Q:$P($G(^MAGV(2005.61,PROCIX,0)),"^",5)'="A"  ; not active
"RTN","MAGNVQ05",33,0)
 . . S STYIX=""
"RTN","MAGNVQ05",34,0)
 . . F  S STYIX=$O(^MAGV(2005.62,"C",PROCIX,STYIX)) Q:'STYIX  D
"RTN","MAGNVQ05",35,0)
 . . . Q:$P($G(^MAGV(2005.62,STYIX,5)),"^",2)="I"  ; study marked inaccessible
"RTN","MAGNVQ05",36,0)
 . . . S SERIX=""
"RTN","MAGNVQ05",37,0)
 . . . F  S SERIX=$O(^MAGV(2005.63,"C",STYIX,SERIX)) Q:'SERIX  D
"RTN","MAGNVQ05",38,0)
 . . . . N ACTVIMG
"RTN","MAGNVQ05",39,0)
 . . . . S ACTVIMG=0
"RTN","MAGNVQ05",40,0)
 . . . . S SOPIX=""
"RTN","MAGNVQ05",41,0)
 . . . . F  S SOPIX=$O(^MAGV(2005.64,"C",SERIX,SOPIX)) Q:'SOPIX  D  Q:IMGLESS&ACTVIMG
"RTN","MAGNVQ05",42,0)
 . . . . . S IMAGE=""
"RTN","MAGNVQ05",43,0)
 . . . . . F  S IMAGE=$O(^MAGV(2005.65,"C",SOPIX,IMAGE)) Q:'IMAGE  D
"RTN","MAGNVQ05",44,0)
 . . . . . . I $P($G(^MAGV(2005.65,IMAGE,1)),"^",5)'="I" D
"RTN","MAGNVQ05",45,0)
 . . . . . . . S IARRAY(STYIX,SERIX,SOPIX,IMAGE)="",ACTVIMG=1
"RTN","MAGNVQ05",46,0)
 . . . . . . . Q
"RTN","MAGNVQ05",47,0)
 . . . . . . Q
"RTN","MAGNVQ05",48,0)
 . . . . . Q
"RTN","MAGNVQ05",49,0)
 . . . . Q
"RTN","MAGNVQ05",50,0)
 . . . Q
"RTN","MAGNVQ05",51,0)
 . . Q
"RTN","MAGNVQ05",52,0)
 . Q
"RTN","MAGNVQ05",53,0)
 Q
"RTN","MAGNVQ06")
0^16^B45830251
"RTN","MAGNVQ06",1,0)
MAGNVQ06 ;WOIFO/NST - List images for Reports ; 26 Dec 2017 3:59 PM
"RTN","MAGNVQ06",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 4525;May 01, 2013
"RTN","MAGNVQ06",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNVQ06",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ06",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNVQ06",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNVQ06",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNVQ06",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNVQ06",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNVQ06",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNVQ06",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNVQ06",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNVQ06",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNVQ06",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNVQ06",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNVQ06",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ06",17,0)
 ;;
"RTN","MAGNVQ06",18,0)
 Q
"RTN","MAGNVQ06",19,0)
 ;
"RTN","MAGNVQ06",20,0)
 ;*****  List Images for Rad Exams or TIU Notes by CPRS context
"RTN","MAGNVQ06",21,0)
 ;        
"RTN","MAGNVQ06",22,0)
 ; Input Parameters
"RTN","MAGNVQ06",23,0)
 ; ================
"RTN","MAGNVQ06",24,0)
 ; 
"RTN","MAGNVQ06",25,0)
 ; DATA - Array holds Windows message received from CPRS in format
"RTN","MAGNVQ06",26,0)
 ;         e.g. 'RPT^CPRS^29027^RA^79029185.9998-1~2'
"RTN","MAGNVQ06",27,0)
 ;                or
"RTN","MAGNVQ06",28,0)
 ;               RPT^CPRS^4658^TIU^2243408^^^^^^^^1~2
"RTN","MAGNVQ06",29,0)
 ; [IMGLESS]  flag to speed up queries: if=1 (true), just get study-level data
"RTN","MAGNVQ06",30,0)
 ;           
"RTN","MAGNVQ06",31,0)
 ; Return Values
"RTN","MAGNVQ06",32,0)
 ; =============
"RTN","MAGNVQ06",33,0)
 ; 
"RTN","MAGNVQ06",34,0)
 ; if error MAGRY(0) = 0 ^Error message^
"RTN","MAGNVQ06",35,0)
 ; if success MAGRY(0) = 1
"RTN","MAGNVQ06",36,0)
 ;            MAGRY(1..n) = CONTEXTID | 0 or 1 | images in format defined in
"RTN","MAGNVQ06",37,0)
 ;                        RPC [MAGG CPRS RAD EXAM] or [MAG3 CPRS TIU NOTE]
"RTN","MAGNVQ06",38,0)
 ;
"RTN","MAGNVQ06",39,0)
IMAGEL(MAGRY,DATA,IMGLESS) ;called by RPC [MAGN CPRS IMAGE LIST]
"RTN","MAGNVQ06",40,0)
 N MAGNCXT,MAGNI,MAGNCNT,MAGNX,REFIEN,REFTYPE
"RTN","MAGNVQ06",41,0)
 N MAGZRY,MAGRYNEW
"RTN","MAGNVQ06",42,0)
 N $ETRAP,$ESTACK S $ETRAP="D AERRA^MAGGTERR"
"RTN","MAGNVQ06",43,0)
 S IMGLESS=$S($D(IMGLESS):+IMGLESS,1:1)  ; Defualt is IMAGELESS
"RTN","MAGNVQ06",44,0)
 S MAGRY=$NA(^TMP("MAGNVQ06",$J))
"RTN","MAGNVQ06",45,0)
 K @MAGRY
"RTN","MAGNVQ06",46,0)
 S @MAGRY@(0)=0
"RTN","MAGNVQ06",47,0)
 S MAGNCNT=0
"RTN","MAGNVQ06",48,0)
 S MAGNI=""
"RTN","MAGNVQ06",49,0)
 F  S MAGNI=$O(DATA(MAGNI)) Q:MAGNI=""  D
"RTN","MAGNVQ06",50,0)
 . S MAGNCXT=$P(DATA(MAGNI),"~")  ; CPRS contextID
"RTN","MAGNVQ06",51,0)
 . S MAGNX=$P(MAGNCXT,"^",4)
"RTN","MAGNVQ06",52,0)
 . I (MAGNX'="RA")&(MAGNX'="TIU") D  Q
"RTN","MAGNVQ06",53,0)
 . . S MAGNCNT=MAGNCNT+1
"RTN","MAGNVQ06",54,0)
 . . S @MAGRY@(MAGNCNT)="NEXT_CONTEXTID|"_MAGNCXT_"|0|"_"Invalid ContextId Type"
"RTN","MAGNVQ06",55,0)
 . . Q
"RTN","MAGNVQ06",56,0)
 . S REFTYPE=$S(MAGNX="RA":"RAD",MAGNX="TIU":"TIU",1:"")
"RTN","MAGNVQ06",57,0)
 . I REFTYPE="RAD" D
"RTN","MAGNVQ06",58,0)
 . . D IMAGEC(.MAGZRY,MAGNCXT,IMGLESS,.REFIEN)          ; Get image list for a single contextID
"RTN","MAGNVQ06",59,0)
 . . Q
"RTN","MAGNVQ06",60,0)
 . I REFTYPE="TIU" D
"RTN","MAGNVQ06",61,0)
 . . S REFIEN=$P(MAGNCXT,"^",5)
"RTN","MAGNVQ06",62,0)
 . . D IMAGETIU(.MAGZRY,MAGNCXT,IMGLESS)
"RTN","MAGNVQ06",63,0)
 . . Q
"RTN","MAGNVQ06",64,0)
 . K @MAGZRY@(1)  ; delete counter node
"RTN","MAGNVQ06",65,0)
 . D GSTUDY^MAGNVQ01(MAGZRY,REFTYPE,REFIEN,MAGNCXT,IMGLESS)  ; Get imagage from new image data structure (P34) 
"RTN","MAGNVQ06",66,0)
 . D APPEND(MAGRY,.MAGNCNT,MAGNCXT,MAGZRY,REFTYPE,REFIEN)  ; Append individual contextID image list to final list
"RTN","MAGNVQ06",67,0)
 . Q
"RTN","MAGNVQ06",68,0)
 S @MAGRY@(0)=1
"RTN","MAGNVQ06",69,0)
 Q
"RTN","MAGNVQ06",70,0)
 ;
"RTN","MAGNVQ06",71,0)
IMAGETIU(MAGZRY,DATA,IMGLESS) ; Get 2005 Images by TIU Note
"RTN","MAGNVQ06",72,0)
 N I,OUT,GROUPS,IMGIEN,MAGOUT1,DFN,MAGNTIU
"RTN","MAGNVQ06",73,0)
 ;
"RTN","MAGNVQ06",74,0)
 K MAGZRY
"RTN","MAGNVQ06",75,0)
 S DFN=+$P(DATA,U,3)
"RTN","MAGNVQ06",76,0)
 S MAGNTIU=$P(DATA,U,5)
"RTN","MAGNVQ06",77,0)
 D IMAGES^MAGGNTI(.MAGOUT1,MAGNTIU)
"RTN","MAGNVQ06",78,0)
 ;
"RTN","MAGNVQ06",79,0)
 S I=0
"RTN","MAGNVQ06",80,0)
 F  S I=$O(MAGOUT1(I)) Q:'I  D
"RTN","MAGNVQ06",81,0)
 . S IMGIEN=$P(MAGOUT1(I),"^",25)  ; IEN of the group
"RTN","MAGNVQ06",82,0)
 . S:'IMGIEN IMGIEN=$P(MAGOUT1(I),"^",2)  ; Ien of the image
"RTN","MAGNVQ06",83,0)
 . S GROUPS(I)=IMGIEN
"RTN","MAGNVQ06",84,0)
 . Q
"RTN","MAGNVQ06",85,0)
 D STUDY2^MAGDQR21(.OUT,.GROUPS,DFN,IMGLESS)  ; MAG DOD GET STUDIES IEN
"RTN","MAGNVQ06",86,0)
 ;
"RTN","MAGNVQ06",87,0)
 S MAGZRY=OUT
"RTN","MAGNVQ06",88,0)
 S @MAGZRY@(0)=1
"RTN","MAGNVQ06",89,0)
 ;
"RTN","MAGNVQ06",90,0)
 Q
"RTN","MAGNVQ06",91,0)
 ;
"RTN","MAGNVQ06",92,0)
IMAGEC(MAGZRY,DATA,IMGLESS,RARPT) ;A copy from MAGGTRAI
"RTN","MAGNVQ06",93,0)
 ; Call to list Images for a Rad Exam that was selected from CPRS 
"RTN","MAGNVQ06",94,0)
 ; and Imaging Window was notified via windows messaging
"RTN","MAGNVQ06",95,0)
 ;   INPUT :  DATA is in format of Windows message received from CPRS
"RTN","MAGNVQ06",96,0)
 ;    example   'RPT^CPRS^29027^RA^i79029185.9998-1'
"RTN","MAGNVQ06",97,0)
 N DFN,ENT,INVDTTM,INVDT,INVTM
"RTN","MAGNVQ06",98,0)
 S MAGZRY=$NA(^TMP("MAGGTRAI",$J))
"RTN","MAGNVQ06",99,0)
 K @MAGZRY
"RTN","MAGNVQ06",100,0)
 S DFN=+$P(DATA,U,3)
"RTN","MAGNVQ06",101,0)
 S ENT=+$P($P(DATA,U,5),"-",2)
"RTN","MAGNVQ06",102,0)
 S INVDTTM=$P($P(DATA,U,5),"-",1)
"RTN","MAGNVQ06",103,0)
 S INVDT=$P(INVDTTM,".",1)
"RTN","MAGNVQ06",104,0)
 S INVTM=$P(INVDTTM,".",2)
"RTN","MAGNVQ06",105,0)
 F  Q:($L(INVDT)<8)  S INVDT=$E(INVDT,2,$L(INVDT))
"RTN","MAGNVQ06",106,0)
 S INVDTTM=INVDT_"."_INVTM
"RTN","MAGNVQ06",107,0)
 S RARPT=0
"RTN","MAGNVQ06",108,0)
 I '$D(^RADPT(DFN,"DT",INVDTTM,"P",ENT,0)) S @MAGZRY@(0)="0^INVALID Data : Attempt to access Exam failed." Q
"RTN","MAGNVQ06",109,0)
 S RARPT=$P(^RADPT(DFN,"DT",INVDTTM,"P",ENT,0),U,17)
"RTN","MAGNVQ06",110,0)
 I 'RARPT S @MAGZRY@(0)="1^No Report for selected Exam" Q
"RTN","MAGNVQ06",111,0)
 ; MAGQI 8/22/01
"RTN","MAGNVQ06",112,0)
 I $P($G(^RARPT(RARPT,0)),U,2)'=DFN S @MAGZRY@(0)="-2^Patient Mismatch. Radiology File" Q
"RTN","MAGNVQ06",113,0)
 D GETSTUDY(.MAGZRY,RARPT,IMGLESS)  ; Pass input parameters
"RTN","MAGNVQ06",114,0)
 Q
"RTN","MAGNVQ06",115,0)
 ;
"RTN","MAGNVQ06",116,0)
GETSTUDY(MAGZRY,RARPT,IMGLESS) ; Private call. From other points in this routine, when RARPT is defined
"RTN","MAGNVQ06",117,0)
 ; RARPT -- Radiology report IEN
"RTN","MAGNVQ06",118,0)
 ; and returns a list in MAGZRY(1..n). 
"RTN","MAGNVQ06",119,0)
 ; We'll make a tmp list of just the image IEN's
"RTN","MAGNVQ06",120,0)
 ;  splitting groups into individual image entries.
"RTN","MAGNVQ06",121,0)
 ; If more than 1 Image group points to this report, we
"RTN","MAGNVQ06",122,0)
 ;  will prefix the Image Description with (G1), (G2) etc
"RTN","MAGNVQ06",123,0)
 ; We call GROUP^MAGGTIG to get the images for the group, this call
"RTN","MAGNVQ06",124,0)
 ;  sorts the images in Dicom Series, Dicom Image number order.
"RTN","MAGNVQ06",125,0)
 ;
"RTN","MAGNVQ06",126,0)
 N GROUPS,OUT,REQDFN
"RTN","MAGNVQ06",127,0)
 ;
"RTN","MAGNVQ06",128,0)
 N CT,OI,IGCT,MAGIEN1,MAGQI,MAGX
"RTN","MAGNVQ06",129,0)
 S IGCT=+$P($G(^RARPT(RARPT,2005,0)),U,4)
"RTN","MAGNVQ06",130,0)
 ; Quit if no images for RARPT
"RTN","MAGNVQ06",131,0)
 I IGCT=0 S @MAGZRY@(0)="0^0 Images for Radiology Report." Q 
"RTN","MAGNVQ06",132,0)
 ;
"RTN","MAGNVQ06",133,0)
 ; Check all Image entries in RARPT 2005 NODE. for Patient match Pointer match, from both 
"RTN","MAGNVQ06",134,0)
 ;   RARPT end, and Imaging end.
"RTN","MAGNVQ06",135,0)
 S MAGQI=1
"RTN","MAGNVQ06",136,0)
 S OI=0,CT=1 F  S OI=$O(^RARPT(RARPT,2005,OI)) Q:'OI  D  Q:(MAGQI<1)
"RTN","MAGNVQ06",137,0)
 . S MAGIEN1=$P(^RARPT(RARPT,2005,OI,0),U)
"RTN","MAGNVQ06",138,0)
 . ; Assure magdfn = rarpt dfn
"RTN","MAGNVQ06",139,0)
 . I $P($G(^RARPT(RARPT,0)),U,2)'=$P($G(^MAG(2005,MAGIEN1,0)),U,7) S MAGQI="-2^Patient Mismatch. Radiology Report" Q
"RTN","MAGNVQ06",140,0)
 . ; Assure magien1 is pointing to this rarpt
"RTN","MAGNVQ06",141,0)
 . I $P($G(^MAG(2005,MAGIEN1,2)),U,7)'=RARPT S MAGQI="-2^Pointer Mismatch. Radiology Report" Q
"RTN","MAGNVQ06",142,0)
 . ; Now run the Imaging integrity check
"RTN","MAGNVQ06",143,0)
 . D CHK^MAGGSQI(.MAGX,MAGIEN1) I 'MAGX(0) S MAGQI="-2^"_$P(MAGX(0),U,2,99) Q
"RTN","MAGNVQ06",144,0)
 ;
"RTN","MAGNVQ06",145,0)
 I MAGQI<1 S @MAGZRY@(0)=MAGQI Q
"RTN","MAGNVQ06",146,0)
 S CT=0
"RTN","MAGNVQ06",147,0)
 ;
"RTN","MAGNVQ06",148,0)
 S OI=0,CT=1 F  S OI=$O(^RARPT(RARPT,2005,OI)) Q:'OI  D
"RTN","MAGNVQ06",149,0)
 . S MAGIEN1=$P(^RARPT(RARPT,2005,OI,0),U) S GROUPS(OI)=MAGIEN1
"RTN","MAGNVQ06",150,0)
 . Q
"RTN","MAGNVQ06",151,0)
 ;
"RTN","MAGNVQ06",152,0)
 S REQDFN=$P($G(^RARPT(RARPT,0)),U,2)
"RTN","MAGNVQ06",153,0)
 D STUDY2^MAGDQR21(.OUT,.GROUPS,REQDFN,IMGLESS)  ; MAG DOD GET STUDIES IEN
"RTN","MAGNVQ06",154,0)
 ;
"RTN","MAGNVQ06",155,0)
 S MAGZRY=OUT
"RTN","MAGNVQ06",156,0)
 S @MAGZRY@(0)=1
"RTN","MAGNVQ06",157,0)
 ;
"RTN","MAGNVQ06",158,0)
 Q
"RTN","MAGNVQ06",159,0)
 ;
"RTN","MAGNVQ06",160,0)
APPEND(MAGOUT,MAGNCNT,MAGNCXT,MAGIN,REFTYPE,REFIEN)  ;
"RTN","MAGNVQ06",161,0)
 ; Append individual contextID image list to final list
"RTN","MAGNVQ06",162,0)
 ; and add more data 
"RTN","MAGNVQ06",163,0)
 ; MAGOUT  - destination image list array 
"RTN","MAGNVQ06",164,0)
 ; .MAGNCNT -- Start position in the array
"RTN","MAGNVQ06",165,0)
 ; MAGNCXT -- context ID
"RTN","MAGNVQ06",166,0)
 ; MAGIN  -- Image list to be appended - reference to a global
"RTN","MAGNVQ06",167,0)
 ;
"RTN","MAGNVQ06",168,0)
 N I,IMGIEN,MAGNCNTN,MAGSTUDY,OLDSTUDY
"RTN","MAGNVQ06",169,0)
 S @MAGIN@(0)=$G(@MAGIN@(0))
"RTN","MAGNVQ06",170,0)
 I '@MAGIN@(0) D  Q
"RTN","MAGNVQ06",171,0)
 . S MAGNCNT=MAGNCNT+1
"RTN","MAGNVQ06",172,0)
 . S @MAGOUT@(MAGNCNT)="NEXT_CONTEXTID|"_MAGNCXT_"|0|"_$P(@MAGIN@(0),"^",2)
"RTN","MAGNVQ06",173,0)
 . Q
"RTN","MAGNVQ06",174,0)
 ;
"RTN","MAGNVQ06",175,0)
 S MAGNCNTN=MAGNCNT
"RTN","MAGNVQ06",176,0)
 S MAGNCNT=MAGNCNT+1
"RTN","MAGNVQ06",177,0)
 ;
"RTN","MAGNVQ06",178,0)
 S OLDSTUDY=0
"RTN","MAGNVQ06",179,0)
 S I=0
"RTN","MAGNVQ06",180,0)
 F  S I=$O(@MAGIN@(I)) Q:'I  D
"RTN","MAGNVQ06",181,0)
 . S MAGNCNT=MAGNCNT+1
"RTN","MAGNVQ06",182,0)
 . S @MAGOUT@(MAGNCNT)=@MAGIN@(I)
"RTN","MAGNVQ06",183,0)
 . I $P(@MAGIN@(I),"|")="NEXT_STUDY" S OLDSTUDY=$P(@MAGIN@(I),"|",3)=""
"RTN","MAGNVQ06",184,0)
 . I OLDSTUDY,$P(@MAGIN@(I),"|")="STUDY_IEN" D   ; Add STUDY_INFO. Better place will be MAGDQR21
"RTN","MAGNVQ06",185,0)
 . . S MAGNCNT=MAGNCNT+1
"RTN","MAGNVQ06",186,0)
 . . S IMGIEN=$P(@MAGIN@(I),"|",2)  ; IEN of the group
"RTN","MAGNVQ06",187,0)
 . . S @MAGOUT@(MAGNCNT)="STUDY_INFO|"_$$STDINFO^MAGNU003(IMGIEN,REFTYPE,REFIEN,MAGNCXT)
"RTN","MAGNVQ06",188,0)
 . . S MAGSTUDY=@MAGIN@(I)
"RTN","MAGNVQ06",189,0)
 . . Q
"RTN","MAGNVQ06",190,0)
 . I OLDSTUDY,IMGLESS,($P(@MAGIN@(I),"|")="STUDY_PAT") D INSFIMG^MAGNU003(MAGSTUDY,.MAGNCNT,MAGOUT)  ; Append First Image Info
"RTN","MAGNVQ06",191,0)
 . Q
"RTN","MAGNVQ06",192,0)
 S @MAGOUT@(MAGNCNTN+1)="NEXT_CONTEXTID|"_MAGNCXT_"|1|"_(MAGNCNT-MAGNCNTN)  ; @MAGIN@(1) is a result lines count
"RTN","MAGNVQ06",193,0)
 Q
"RTN","MAGNPARM")
0^17^B14479373
"RTN","MAGNPARM",1,0)
MAGNPARM ;WOIFO/NST - Utilities for RPC calls ; 10 Aug 2017 4:16 PM
"RTN","MAGNPARM",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 92;Aug 02, 2012
"RTN","MAGNPARM",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNPARM",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNPARM",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNPARM",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNPARM",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNPARM",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNPARM",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNPARM",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNPARM",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNPARM",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNPARM",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNPARM",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNPARM",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNPARM",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNPARM",17,0)
 ;;
"RTN","MAGNPARM",18,0)
 Q
"RTN","MAGNPARM",19,0)
 ;
"RTN","MAGNPARM",20,0)
 ;*****  Changes value for named parameter
"RTN","MAGNPARM",21,0)
 ;       
"RTN","MAGNPARM",22,0)
 ; RPC: MAGN PARAM SET LIST
"RTN","MAGNPARM",23,0)
 ; 
"RTN","MAGNPARM",24,0)
 ; Input Parameters
"RTN","MAGNPARM",25,0)
 ; ================
"RTN","MAGNPARM",26,0)
 ; 
"RTN","MAGNPARM",27,0)
 ; [MAGPARAM("PARAM")]  - default "MAG USER PREF"
"RTN","MAGNPARM",28,0)
 ; [MAGPARAM("ENTITY")] - default "USR.`DUZ"
"RTN","MAGNPARM",29,0)
 ; [MAGPARAM("USER")]   - default DUZ 
"RTN","MAGNPARM",30,0)
 ;  MAGPARAM("INSTANCEnnn")
"RTN","MAGNPARM",31,0)
 ;  MAGPARAM("VALUEnnn")
"RTN","MAGNPARM",32,0)
 ;
"RTN","MAGNPARM",33,0)
 ; Return Values
"RTN","MAGNPARM",34,0)
 ; =============
"RTN","MAGNPARM",35,0)
 ; if error MAGRY = Failure status ^ Error message^
"RTN","MAGNPARM",36,0)
 ; if success MAGRY = Success status
"RTN","MAGNPARM",37,0)
 ;
"RTN","MAGNPARM",38,0)
SPARLIST(MAGRY,MAGPARAM) ; RPC [MAGN PARAM SET LIST]
"RTN","MAGNPARM",39,0)
 N PARAM,VALUE,ENT,INST,ERR,USR,II,JJ
"RTN","MAGNPARM",40,0)
 ;
"RTN","MAGNPARM",41,0)
 K MAGRY
"RTN","MAGNPARM",42,0)
 S ERR=0
"RTN","MAGNPARM",43,0)
 S PARAM=$G(MAGPARAM("PARAM"),"MAG USER PREF")
"RTN","MAGNPARM",44,0)
 S USR=$G(MAGPARAM("USER"),DUZ)
"RTN","MAGNPARM",45,0)
 S ENT=$G(MAGPARAM("ENTITY"),"USR.`"_USR)
"RTN","MAGNPARM",46,0)
 S II="INSTANCE"
"RTN","MAGNPARM",47,0)
 F  S II=$O(MAGPARAM(II)) Q:II'["INSTANCE"  D  Q:ERR
"RTN","MAGNPARM",48,0)
 . S INST=MAGPARAM(II)
"RTN","MAGNPARM",49,0)
 . Q:INST=""
"RTN","MAGNPARM",50,0)
 . D EN^XPAR(ENT,PARAM,INST,"@",.ERR)  ; clean up first
"RTN","MAGNPARM",51,0)
 . S JJ="VALUE"_$P(II,"INSTANCE",2)
"RTN","MAGNPARM",52,0)
 . S VALUE=$G(MAGPARAM(JJ))
"RTN","MAGNPARM",53,0)
 . I VALUE="@" Q  ; we already deleted the value
"RTN","MAGNPARM",54,0)
 . F  S JJ=$O(MAGPARAM(JJ)) Q:JJ=""  D
"RTN","MAGNPARM",55,0)
 . . S VALUE(+$P(JJ,"_",2),0)=MAGPARAM(JJ)  ; Add word-processing text if any
"RTN","MAGNPARM",56,0)
 . . Q
"RTN","MAGNPARM",57,0)
 . D EN^XPAR(ENT,PARAM,INST,.VALUE,.ERR)
"RTN","MAGNPARM",58,0)
 . Q
"RTN","MAGNPARM",59,0)
 I ERR=0 S MAGRY=$$SETOKVAL^MAGNU002("")
"RTN","MAGNPARM",60,0)
 E  S MAGRY=$$SETERROR^MAGNU002($P(ERR,"^",2))
"RTN","MAGNPARM",61,0)
 Q
"RTN","MAGNPARM",62,0)
 ;
"RTN","MAGNPARM",63,0)
 ;*****   Get a parameter list values
"RTN","MAGNPARM",64,0)
 ;       
"RTN","MAGNPARM",65,0)
 ; RPC: MAGN PARAM GET LIST
"RTN","MAGNPARM",66,0)
 ; 
"RTN","MAGNPARM",67,0)
 ; Input Parameters
"RTN","MAGNPARM",68,0)
 ; ================
"RTN","MAGNPARM",69,0)
 ; 
"RTN","MAGNPARM",70,0)
 ; [MAGPARAM("PARAM")] - parameter name - default "MAG USER PREF"
"RTN","MAGNPARM",71,0)
 ; [MAGPARAM("FORMAT")]  - I|Q|E|B - default "I" (internal)
"RTN","MAGNPARM",72,0)
 ; [MAGPARAM("ENTITY")]  - Default "ALL"
"RTN","MAGNPARM",73,0)
 ; 
"RTN","MAGNPARM",74,0)
 ; Return Values
"RTN","MAGNPARM",75,0)
 ; =============
"RTN","MAGNPARM",76,0)
 ; if error MAGRY(0) = Failure status ^ Error message^
"RTN","MAGNPARM",77,0)
 ; if success MAGRY(0) = Success status ^ ^counter
"RTN","MAGNPARM",78,0)
 ;            MAGRY(1..n) = instance ^ value
"RTN","MAGNPARM",79,0)
 ;
"RTN","MAGNPARM",80,0)
GPARLIST(MAGRY,MAGPARAM) ; RPC [MAGN PARAM GET LIST] 
"RTN","MAGNPARM",81,0)
 N INST,CNT,ERR,TMP,PARAM,FMT,ENT
"RTN","MAGNPARM",82,0)
 ;
"RTN","MAGNPARM",83,0)
 K MAGRY
"RTN","MAGNPARM",84,0)
 S PARAM=$G(MAGPARAM("PARAM"),"MAG USER PREF")
"RTN","MAGNPARM",85,0)
 S FMT=$G(MAGPARAM("FORMAT"),"I")
"RTN","MAGNPARM",86,0)
 S ENT=$G(MAGPARAM("ENTITY"),"ALL")
"RTN","MAGNPARM",87,0)
 D GETLST^XPAR(.TMP,ENT,PARAM,FMT,.ERR)
"RTN","MAGNPARM",88,0)
 ; 
"RTN","MAGNPARM",89,0)
 I $G(ERR) S @MAGRY@(0)=$$SETERROR^MAGNU002($P(ERR,"^",2)) Q
"RTN","MAGNPARM",90,0)
 ;
"RTN","MAGNPARM",91,0)
 S CNT=0
"RTN","MAGNPARM",92,0)
 S INST=""
"RTN","MAGNPARM",93,0)
 F  S INST=$O(TMP(INST)) Q:INST=""  D
"RTN","MAGNPARM",94,0)
 . S CNT=CNT+1,MAGRY(CNT)=INST_"^"_TMP(INST)
"RTN","MAGNPARM",95,0)
 . Q
"RTN","MAGNPARM",96,0)
 S MAGRY(0)=$$SETOKVAL^MAGNU002(CNT)
"RTN","MAGNPARM",97,0)
 Q
"RTN","MAGNPARM",98,0)
 ;
"RTN","MAGNPARM",99,0)
 ;*****   Get a value of an instance
"RTN","MAGNPARM",100,0)
 ;       
"RTN","MAGNPARM",101,0)
 ; RPC: MAGN PARAM GET VALUE
"RTN","MAGNPARM",102,0)
 ; 
"RTN","MAGNPARM",103,0)
 ; Input Parameters
"RTN","MAGNPARM",104,0)
 ; ================
"RTN","MAGNPARM",105,0)
 ; 
"RTN","MAGNPARM",106,0)
 ; [MAGPARAM("PARAM")] - parameter name - default "MAG USER PREF"
"RTN","MAGNPARM",107,0)
 ; [MAGPARAM("ENTITY")]  - Default "ALL"
"RTN","MAGNPARM",108,0)
 ;  MAGPARAM("INSTANCE")  
"RTN","MAGNPARM",109,0)
 ; 
"RTN","MAGNPARM",110,0)
 ; Return Values
"RTN","MAGNPARM",111,0)
 ; =============
"RTN","MAGNPARM",112,0)
 ; if error MAGRY(0) = Failure status ^ Error message^
"RTN","MAGNPARM",113,0)
 ; if success MAGRY(0) = Success status ^ ^ value
"RTN","MAGNPARM",114,0)
 ;            MAGRY(1..n) = value line 1..n
"RTN","MAGNPARM",115,0)
GET1(MAGRY,MAGPARAM) ; RPC [MAGN PARAM GET VALUE]
"RTN","MAGNPARM",116,0)
 N I,OUT,PARAM,ENT,INST,ERR
"RTN","MAGNPARM",117,0)
 ;
"RTN","MAGNPARM",118,0)
 K MAGRY
"RTN","MAGNPARM",119,0)
 S PARAM=$G(MAGPARAM("PARAM"),"MAG USER PREF")
"RTN","MAGNPARM",120,0)
 S ENT=$G(MAGPARAM("ENTITY"),"ALL")
"RTN","MAGNPARM",121,0)
 S INST=$G(MAGPARAM("INSTANCE"),"")
"RTN","MAGNPARM",122,0)
 I INST="" S MAGRY(0)=$$SETERROR^MAGNU002("The Instance value is missing") Q 
"RTN","MAGNPARM",123,0)
 D GETWP^XPAR(.OUT,ENT,PARAM,INST,.ERR)
"RTN","MAGNPARM",124,0)
 I $G(ERR) S MAGRY(0)=$$SETERROR^MAGNU002($G(ERR)) Q
"RTN","MAGNPARM",125,0)
 I '$D(OUT) S MAGRY(0)=$$SETERROR^MAGNU002("Instance not found") Q 
"RTN","MAGNPARM",126,0)
 S MAGRY(0)=$$SETOKVAL^MAGNU002($G(OUT))
"RTN","MAGNPARM",127,0)
 S I=""
"RTN","MAGNPARM",128,0)
 F  S I=$O(OUT(I)) Q:'I  D
"RTN","MAGNPARM",129,0)
 . S MAGRY(I)=$G(OUT(I,0))
"RTN","MAGNPARM",130,0)
 . Q
"RTN","MAGNPARM",131,0)
 Q
"RTN","MAGNU001")
0^18^B14211594
"RTN","MAGNU001",1,0)
MAGNU001 ;WOIFO/NST - Utilities for RPC calls ; 25 Apr 2017 4:16 PM
"RTN","MAGNU001",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 92;Aug 02, 2012
"RTN","MAGNU001",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNU001",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNU001",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNU001",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNU001",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNU001",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNU001",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNU001",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNU001",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNU001",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNU001",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNU001",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNU001",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNU001",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNU001",17,0)
 ;;
"RTN","MAGNU001",18,0)
 Q
"RTN","MAGNU001",19,0)
 ;
"RTN","MAGNU001",20,0)
FM2IDF(FMDT) ; converts date time in FileMan format CYYMMDD.HHMMSS to YYYYMMDD.HHMMSS
"RTN","MAGNU001",21,0)
 I FMDT="" Q ""
"RTN","MAGNU001",22,0)
 N MAGTIME
"RTN","MAGNU001",23,0)
 S MAGTIME=$P(FMDT,".",2)
"RTN","MAGNU001",24,0)
 Q (FMDT\1+17000000)_"."_MAGTIME
"RTN","MAGNU001",25,0)
 ;
"RTN","MAGNU001",26,0)
 ; Input parameters
"RTN","MAGNU001",27,0)
 ; ================
"RTN","MAGNU001",28,0)
 ;   FILE = FileMan file number (e.g. 2006.917)
"RTN","MAGNU001",29,0)
GETFILNM(FILE) ; Returns file name
"RTN","MAGNU001",30,0)
 Q $$GET1^DID(FILE,"","","NAME")
"RTN","MAGNU001",31,0)
 ;
"RTN","MAGNU001",32,0)
 ; Input parameters
"RTN","MAGNU001",33,0)
 ; ================
"RTN","MAGNU001",34,0)
 ;  FILE  - FileMan file
"RTN","MAGNU001",35,0)
GETFILGL(FILE) ; Get Global root of the file
"RTN","MAGNU001",36,0)
 Q $$ROOT^DILFD(FILE)
"RTN","MAGNU001",37,0)
 ;
"RTN","MAGNU001",38,0)
 ; Input parameters
"RTN","MAGNU001",39,0)
 ; ================
"RTN","MAGNU001",40,0)
 ;  FILE  - FileMan file
"RTN","MAGNU001",41,0)
 ;  FNAME - Field name
"RTN","MAGNU001",42,0)
GETFLDID(FILE,FNAME) ; Returns a field number
"RTN","MAGNU001",43,0)
 Q $$FLDNUM^DILFD(FILE,FNAME)
"RTN","MAGNU001",44,0)
 ;
"RTN","MAGNU001",45,0)
GETFLDS(MAGRY,MAGRYW,FILE,FLAGS) ; Returns array with all fields in a file
"RTN","MAGNU001",46,0)
 ; 
"RTN","MAGNU001",47,0)
 ; Input Parameters
"RTN","MAGNU001",48,0)
 ; ================
"RTN","MAGNU001",49,0)
 ; FILE = FileMan file number
"RTN","MAGNU001",50,0)
 ; FLAGS = I - add I(internal) to the field numbers in Result e.g .01I;2I;3I
"RTN","MAGNU001",51,0)
 ; 
"RTN","MAGNU001",52,0)
 ; Return Values
"RTN","MAGNU001",53,0)
 ; =============
"RTN","MAGNU001",54,0)
 ; 
"RTN","MAGNU001",55,0)
 ; Result=n1;n2;n3 (e.g. .01;2;3) - no multiple or word-processing fields
"RTN","MAGNU001",56,0)
 ; 
"RTN","MAGNU001",57,0)
 ; MAGRY(n)=nth field name
"RTN","MAGNU001",58,0)
 ; MAGRY(n,"TYPE")=type of the field (e.g. RP2006.916, 2006.9183, RD, RN, etc.)
"RTN","MAGNU001",59,0)
 ; 
"RTN","MAGNU001",60,0)
 ; MAGRYW(n)=nth Word-Processing field name
"RTN","MAGNU001",61,0)
 ; MAGRY(n,"TYPE")=type of the field (e.g. RP2006.916, 2006.9183, RD, RN, etc.)
"RTN","MAGNU001",62,0)
 ;
"RTN","MAGNU001",63,0)
 N I,FLDID,FLDS,DEL
"RTN","MAGNU001",64,0)
 N WPTYPE,IVAL
"RTN","MAGNU001",65,0)
 K MAGRY,MAGRYW
"RTN","MAGNU001",66,0)
 S IVAL=$S($G(FLAGS)["I":"I",1:"")
"RTN","MAGNU001",67,0)
 S I=""
"RTN","MAGNU001",68,0)
 S FLDS=""
"RTN","MAGNU001",69,0)
 F  S I=$O(^DD(FILE,"B",I)) Q:I=""  D       ; IA #5551
"RTN","MAGNU001",70,0)
 . S FLDID=$O(^DD(FILE,"B",I,""))
"RTN","MAGNU001",71,0)
 . I $$ISFLDSUB^MAGNU001(.WPTYPE,FILE,FLDID) D
"RTN","MAGNU001",72,0)
 . . S MAGRYW(FLDID)=I
"RTN","MAGNU001",73,0)
 . . S MAGRYW(FLDID,"TYPE")=WPTYPE
"RTN","MAGNU001",74,0)
 . . Q
"RTN","MAGNU001",75,0)
 . E  D
"RTN","MAGNU001",76,0)
 . . S MAGRY(FLDID)=I
"RTN","MAGNU001",77,0)
 . . S MAGRY(FLDID,"TYPE")=$$GET1^DID(FILE,FLDID,"","SPECIFIER")
"RTN","MAGNU001",78,0)
 . . Q
"RTN","MAGNU001",79,0)
 . Q
"RTN","MAGNU001",80,0)
 S I="",DEL=""
"RTN","MAGNU001",81,0)
 F  S I=$O(MAGRY(I)) Q:I=""  D
"RTN","MAGNU001",82,0)
 . ; Skip multiple and word-processing fields GETS^DIQ cannot handle Word-Processing field
"RTN","MAGNU001",83,0)
 . I $$ISFLDSUB^MAGNU001(.WPTYPE,FILE,I) Q
"RTN","MAGNU001",84,0)
 . S FLDS=FLDS_DEL_I_IVAL
"RTN","MAGNU001",85,0)
 . S DEL=";"
"RTN","MAGNU001",86,0)
 . Q
"RTN","MAGNU001",87,0)
 Q FLDS
"RTN","MAGNU001",88,0)
 ;
"RTN","MAGNU001",89,0)
 ; Input parameters
"RTN","MAGNU001",90,0)
 ; ================
"RTN","MAGNU001",91,0)
 ;  FILE  - FileMan file
"RTN","MAGNU001",92,0)
 ;  FLDID - Field Number
"RTN","MAGNU001",93,0)
 ;  
"RTN","MAGNU001",94,0)
 ;  Return Values
"RTN","MAGNU001",95,0)
 ;  =============
"RTN","MAGNU001",96,0)
 ; TYPEDEF = Type of field
"RTN","MAGNU001",97,0)
ISFLDSUB(TYPEDEF,FILE,FLDID) ; Returns true(1) or false(0) if a field is from Word-Processing type or Multiple
"RTN","MAGNU001",98,0)
 N FILESUB
"RTN","MAGNU001",99,0)
 S TYPEDEF=""
"RTN","MAGNU001",100,0)
 Q:'$$GET1^DID(FILE,FLDID,"","MULTIPLE-VALUED") 0
"RTN","MAGNU001",101,0)
 S FILESUB=$$GET1^DID(FILE,FLDID,"","SPECIFIER")
"RTN","MAGNU001",102,0)
 S TYPEDEF=$$GET1^DID(+FILESUB,.01,"","SPECIFIER")
"RTN","MAGNU001",103,0)
 Q 1
"RTN","MAGNU001",104,0)
 ;
"RTN","MAGNU001",105,0)
 ; Input parameters
"RTN","MAGNU001",106,0)
 ; ================
"RTN","MAGNU001",107,0)
 ;  FILE  - FileMan file
"RTN","MAGNU001",108,0)
 ;  FLDID - Field Number
"RTN","MAGNU001",109,0)
ISFLDDT(FILE,FLDID) ; Returns true(1) or false(0) if a field is from DATE/TIME type 
"RTN","MAGNU001",110,0)
 Q $$GET1^DID(FILE,FLDID,"","TYPE")="DATE/TIME"
"RTN","MAGNU001",111,0)
 ;
"RTN","MAGNU001",112,0)
 ; Return WP field value as a string
"RTN","MAGNU001",113,0)
 ; WP = Word-Processing field values
"RTN","MAGNU001",114,0)
 ; e.g. WP(1)=Line 1
"RTN","MAGNU001",115,0)
 ;      WP(2)=Line 2
"RTN","MAGNU001",116,0)
 ;
"RTN","MAGNU001",117,0)
 ;
"RTN","MAGNU001",118,0)
 ; Input parameters
"RTN","MAGNU001",119,0)
 ; ================
"RTN","MAGNU001",120,0)
 ;  FILE  - FileMan file
"RTN","MAGNU001",121,0)
 ;  FLDID - Field Number
"RTN","MAGNU001",122,0)
 ;  
"RTN","MAGNU001",123,0)
 ;  Return Values
"RTN","MAGNU001",124,0)
 ;  =============
"RTN","MAGNU001",125,0)
 ; TYPEDEF = Type of Word-Processing field
"RTN","MAGNU001",126,0)
ISFLDWP(TYPEDEF,FILE,FLDID) ; Returns true(1) or false(0) if a field is from Word-Processing type 
"RTN","MAGNU001",127,0)
 N WPFILE
"RTN","MAGNU001",128,0)
 S TYPEDEF=""
"RTN","MAGNU001",129,0)
 Q:$$GET1^DID(FILE,FLDID,"","TYPE")'="WORD-PROCESSING" 0
"RTN","MAGNU001",130,0)
 S WPFILE=$$GET1^DID(FILE,FLDID,"","SPECIFIER")
"RTN","MAGNU001",131,0)
 S TYPEDEF=$$GET1^DID(WPFILE,.01,"","SPECIFIER")
"RTN","MAGNU001",132,0)
 Q 1
"RTN","MAGNU001",133,0)
 ;
"RTN","MAGNU001",134,0)
GSUBFILE(FILE,FIELD) ; Returns sub-file of a multiple field
"RTN","MAGNU001",135,0)
 Q +$$GET1^DID(FILE,FIELD,"","SPECIFIER")
"RTN","MAGNU001",136,0)
 ;
"RTN","MAGNU001",137,0)
GSUBROOT(FILE,FIELD,D0) ; Return open root of multiple field
"RTN","MAGNU001",138,0)
 N ROOT,NODE
"RTN","MAGNU001",139,0)
 S NODE=$$GET1^DID(FILE,FIELD,"","GLOBAL SUBSCRIPT LOCATION")
"RTN","MAGNU001",140,0)
 S NODE=$P(NODE,";")
"RTN","MAGNU001",141,0)
 S ROOT=$$GETFILGL(FILE)
"RTN","MAGNU001",142,0)
 Q ROOT_D0_","_NODE_","
"RTN","MAGNU002")
0^19^B5805654
"RTN","MAGNU002",1,0)
MAGNU002 ;WOIFO/NST - Utilities for RPC calls ; 02 May 2017 4:16 PM
"RTN","MAGNU002",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 92;Aug 02, 2012
"RTN","MAGNU002",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNU002",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNU002",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNU002",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNU002",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNU002",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNU002",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNU002",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNU002",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNU002",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNU002",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNU002",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNU002",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNU002",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNU002",17,0)
 ;;
"RTN","MAGNU002",18,0)
 Q
"RTN","MAGNU002",19,0)
 ;
"RTN","MAGNU002",20,0)
OK() Q 0   ; Success status
"RTN","MAGNU002",21,0)
 ;
"RTN","MAGNU002",22,0)
FAILED() Q -1   ; Failure status
"RTN","MAGNU002",23,0)
 ;
"RTN","MAGNU002",24,0)
RESDEL() Q "^"  ; Result delimiter
"RTN","MAGNU002",25,0)
 ;
"RTN","MAGNU002",26,0)
RESDATA() Q 3  ; Returns the piece number where the result data value is stored in MAGRY
"RTN","MAGNU002",27,0)
 ;
"RTN","MAGNU002",28,0)
ISOK(MAGRY) ; Returns 0 (failed) or 1 (success): Checks if first piece of MAGRY is success
"RTN","MAGNU002",29,0)
 Q +MAGRY=$$OK()
"RTN","MAGNU002",30,0)
 ;
"RTN","MAGNU002",31,0)
GETVAL(MAGRY) ; Returns data value in MAGRY
"RTN","MAGNU002",32,0)
 Q $P(MAGRY,$$RESDEL(),$$RESDATA())
"RTN","MAGNU002",33,0)
 ;
"RTN","MAGNU002",34,0)
SETVAL(MAGRY,VAL) ; set VAL in RY data piece
"RTN","MAGNU002",35,0)
 S $P(MAGRY,$$RESDEL(),$$RESDATA())=VAL
"RTN","MAGNU002",36,0)
 Q
"RTN","MAGNU002",37,0)
 ;
"RTN","MAGNU002",38,0)
SETOKVAL(VAL) ; set OK result and value
"RTN","MAGNU002",39,0)
 N RY
"RTN","MAGNU002",40,0)
 S RY=$$OK()
"RTN","MAGNU002",41,0)
 D SETVAL(.RY,VAL)
"RTN","MAGNU002",42,0)
 Q RY
"RTN","MAGNU002",43,0)
 ;
"RTN","MAGNU002",44,0)
SETERROR(VAL) ; set Error result and value
"RTN","MAGNU002",45,0)
 Q $$FAILED()_$$RESDEL()_VAL
"RTN","MAGNU002",46,0)
 ;
"RTN","MAGNU002",47,0)
 ;
"RTN","MAGNU002",48,0)
 ; Input Parameters
"RTN","MAGNU002",49,0)
 ; ================
"RTN","MAGNU002",50,0)
 ;  MSG = VA FileMan error array 
"RTN","MAGNU002",51,0)
 ;  
"RTN","MAGNU002",52,0)
 ; Return Values
"RTN","MAGNU002",53,0)
 ; =============
"RTN","MAGNU002",54,0)
 ; MAGRY(0) = Success status
"RTN","MAGNU002",55,0)
 ; MAGRY(0) = Failure status^Error Message
"RTN","MAGNU002",56,0)
 ;
"RTN","MAGNU002",57,0)
 ; Return 1 = error in MSG array
"RTN","MAGNU002",58,0)
 ;        0 = no error in MSG array
"RTN","MAGNU002",59,0)
ISERROR(MAGRY,MSG)   ; Check for error message
"RTN","MAGNU002",60,0)
 I '$D(MSG("DIERR")) S MAGRY(0)=$$OK() Q 0  ; No error
"RTN","MAGNU002",61,0)
 ;
"RTN","MAGNU002",62,0)
 N MAGRESA
"RTN","MAGNU002",63,0)
 D MSG^DIALOG("A",.MAGRESA,245,5,"MSG")
"RTN","MAGNU002",64,0)
 S MAGRY(0)=$$SETERROR(MAGRESA(1))
"RTN","MAGNU002",65,0)
 Q 1
"RTN","MAGNU003")
0^20^B39650764
"RTN","MAGNU003",1,0)
MAGNU003 ;WOIFO/NST - Misc fuctions for image list ; 16 Jan 2018 3:42 AM
"RTN","MAGNU003",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 2002;Feb 28, 2011
"RTN","MAGNU003",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNU003",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNU003",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNU003",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNU003",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNU003",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNU003",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNU003",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNU003",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNU003",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNU003",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNU003",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNU003",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNU003",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNU003",17,0)
 ;;
"RTN","MAGNU003",18,0)
 Q
"RTN","MAGNU003",19,0)
 ;
"RTN","MAGNU003",20,0)
STDINFO(IMGIEN,REFTYPE,REFIEN,MAGNCXT) ; Get study info by image IEN in file #2005 or #2005.1
"RTN","MAGNU003",21,0)
 ; IMGIEN -- Image IEN
"RTN","MAGNU003",22,0)
 ; REFTYPE = "RAD", "TIU"
"RTN","MAGNU003",23,0)
 ; REFIEN  = IEN in respective file of REFTYPE
"RTN","MAGNU003",24,0)
 ; MAGNCXT  = CPRS Context ID
"RTN","MAGNU003",25,0)
 ;
"RTN","MAGNU003",26,0)
 ; Return Study( Image ) info. The code is a copy from MAGSIXG3 
"RTN","MAGNU003",27,0)
 N X0,X2,X40
"RTN","MAGNU003",28,0)
 N PKG,TYPE,EVT,SPEC,ORIG,ORIG,CAPTAPP,CLASS
"RTN","MAGNU003",29,0)
 N IMGNODE,FLTX
"RTN","MAGNU003",30,0)
 ;
"RTN","MAGNU003",31,0)
 S IMGNODE=$$NODE^MAGGI11(IMGIEN)  Q:IMGNODE="" 0
"RTN","MAGNU003",32,0)
 ;
"RTN","MAGNU003",33,0)
 S X0=$G(@IMGNODE@(0))
"RTN","MAGNU003",34,0)
 S X2=$G(@IMGNODE@(2))
"RTN","MAGNU003",35,0)
 S X40=$G(@IMGNODE@(40))
"RTN","MAGNU003",36,0)
 ;
"RTN","MAGNU003",37,0)
 S PKG=$P(X40,U)          ; PACKAGE INDEX (40)
"RTN","MAGNU003",38,0)
 S TYPE=$P(X40,U,3)       ; TYPE INDEX (42)
"RTN","MAGNU003",39,0)
 S EVT=$P(X40,U,4)        ; PROC/EVENT INDEX (43)
"RTN","MAGNU003",40,0)
 S SPEC=$P(X40,U,5)       ; SPEC/SUBSPEC INDEX (44)
"RTN","MAGNU003",41,0)
 S ORIG=$P(X40,U,6)       ; ORIGIN INDEX (45)
"RTN","MAGNU003",42,0)
 S:ORIG="" ORIG="V"       ; Show VA by default
"RTN","MAGNU003",43,0)
 S CAPTAPP=$P(X2,U,12)    ; CAPTURE APPLICATION (8.1)
"RTN","MAGNU003",44,0)
 ;
"RTN","MAGNU003",45,0)
 S CLASS=$S(TYPE:$P($G(^MAG(2005.83,+TYPE,0)),U,2),1:"")
"RTN","MAGNU003",46,0)
 ;
"RTN","MAGNU003",47,0)
 S FLTX=""
"RTN","MAGNU003",48,0)
 S $P(FLTX,U,3)=$$RPTITLE^MAGSIXG3($P(X2,U,6),$P(X2,U,7))     ; Report title
"RTN","MAGNU003",49,0)
 S $P(FLTX,U,4)=$$DTE^MAGSIXG3($P(X2,U,5))                    ; Procedure date
"RTN","MAGNU003",50,0)
 S $P(FLTX,U,5)=$P(X0,U,8)                           ; Procedure
"RTN","MAGNU003",51,0)
 S $P(FLTX,U,7)=$P(X2,U,4)                           ; Short descr.
"RTN","MAGNU003",52,0)
 S $P(FLTX,U,8)=PKG                                  ; Package
"RTN","MAGNU003",53,0)
 S $P(FLTX,U,9)=$P($G(^MAG(2005.82,+CLASS,0)),U)     ; Class
"RTN","MAGNU003",54,0)
 S $P(FLTX,U,10)=$P($G(^MAG(2005.83,+TYPE,0)),U)     ; Type
"RTN","MAGNU003",55,0)
 S $P(FLTX,U,11)=$P($G(^MAG(2005.84,+SPEC,0)),U)     ; (Sub)Specialty
"RTN","MAGNU003",56,0)
 S $P(FLTX,U,12)=$P($G(^MAG(2005.85,+EVT,0)),U)      ; Proc/Event
"RTN","MAGNU003",57,0)
 S $P(FLTX,U,13)=$$EXTERNAL^DILFD(2005,45,,ORIG)     ; Origin
"RTN","MAGNU003",58,0)
 S $P(FLTX,U,14)=$$DTE^MAGSIXG3($P(X2,U))            ; Capture date
"RTN","MAGNU003",59,0)
 S $P(FLTX,U,15)=$$GET1^DIQ(200,+$P(X2,U,2)_",",.01) ; Captured by
"RTN","MAGNU003",60,0)
 S $P(FLTX,U,16)=IMGIEN                              ; Image IEN
"RTN","MAGNU003",61,0)
 S $P(FLTX,U,20)=$$ACCNUM(REFTYPE,REFIEN,MAGNCXT)    ; Accession Number 
"RTN","MAGNU003",62,0)
 Q FLTX_"|"_REFTYPE_"-"_REFIEN_"|"_$S(MAGNCXT'="":MAGNCXT,1:$$CPRSCTX(REFTYPE,REFIEN))
"RTN","MAGNU003",63,0)
 ;
"RTN","MAGNU003",64,0)
INSFIMG(DATA,MAGNCNT,OUT) ; Append First Image Info from 2005 image structure 
"RTN","MAGNU003",65,0)
 N IMGGRP,IMGIEN
"RTN","MAGNU003",66,0)
 S IMGGRP=$P(DATA,"|",2)
"RTN","MAGNU003",67,0)
 S IMGIEN=$P(DATA,"|",4)
"RTN","MAGNU003",68,0)
 S MAGNCNT=MAGNCNT+1,@OUT@(MAGNCNT)="NEXT_SERIES"
"RTN","MAGNU003",69,0)
 S MAGNCNT=MAGNCNT+1,@OUT@(MAGNCNT)="SERIES_IEN|"_IMGGRP
"RTN","MAGNU003",70,0)
 S MAGNCNT=MAGNCNT+1,@OUT@(MAGNCNT)="SERIES_NUMBER|1"
"RTN","MAGNU003",71,0)
 S MAGNCNT=MAGNCNT+1,@OUT@(MAGNCNT)="NEXT_IMAGE"
"RTN","MAGNU003",72,0)
 S MAGNCNT=MAGNCNT+1,@OUT@(MAGNCNT)="IMAGE_IEN|"_IMGIEN
"RTN","MAGNU003",73,0)
 S MAGNCNT=MAGNCNT+1,@OUT@(MAGNCNT)="GROUP_IEN|"_IMGGRP
"RTN","MAGNU003",74,0)
 S MAGNCNT=MAGNCNT+1,@OUT@(MAGNCNT)="IMAGE_INFO|"_"^"_$$INFO^MAGGAII(IMGIEN,"E")
"RTN","MAGNU003",75,0)
 Q
"RTN","MAGNU003",76,0)
 ;
"RTN","MAGNU003",77,0)
ACCNUM(REFTYPE,REFIEN,MAGNCXT)  ; Accession Number
"RTN","MAGNU003",78,0)
 I REFTYPE="TIU" Q $$ACNTIU(REFIEN)
"RTN","MAGNU003",79,0)
 I REFTYPE="RAD" Q $$ACNRAD(REFIEN,MAGNCXT)
"RTN","MAGNU003",80,0)
 Q ""
"RTN","MAGNU003",81,0)
 ;
"RTN","MAGNU003",82,0)
ACNRAD(RARPT,MAGNCXT) ; Get Accession number by RAD report IEN
"RTN","MAGNU003",83,0)
 N ACN,DFN,ENT,INVDTTM,INVDT,INVTM
"RTN","MAGNU003",84,0)
 I RARPT D  Q ACN
"RTN","MAGNU003",85,0)
 . S ACN=$P($G(^RARPT(RARPT,0)),"^") ; IA # 1171    ; Get Radiology Accession number
"RTN","MAGNU003",86,0)
 . Q
"RTN","MAGNU003",87,0)
 ;
"RTN","MAGNU003",88,0)
 I MAGNCXT="" Q ""
"RTN","MAGNU003",89,0)
 ;
"RTN","MAGNU003",90,0)
 ; Report is not defined
"RTN","MAGNU003",91,0)
 S DFN=+$P(MAGNCXT,U,3)
"RTN","MAGNU003",92,0)
 S ENT=+$P($P(MAGNCXT,U,5),"-",2)
"RTN","MAGNU003",93,0)
 S INVDTTM=$P($P(MAGNCXT,U,5),"-",1)
"RTN","MAGNU003",94,0)
 S INVDT=$P(INVDTTM,".",1)
"RTN","MAGNU003",95,0)
 S INVTM=$P(INVDTTM,".",2)
"RTN","MAGNU003",96,0)
 F  Q:($L(INVDT)<8)  S INVDT=$E(INVDT,2,$L(INVDT))
"RTN","MAGNU003",97,0)
 S INVDTTM=INVDT_"."_INVTM
"RTN","MAGNU003",98,0)
 S ACN=$$ACCNUM^RAAPI(DFN,INVDTTM,ENT)
"RTN","MAGNU003",99,0)
 I $L(ACN,"-")=3 S ACN=$P(ACN,"-",2,3)
"RTN","MAGNU003",100,0)
 Q ACN
"RTN","MAGNU003",101,0)
 ;
"RTN","MAGNU003",102,0)
ACNTIU(MAGTIUDA) ; Get Accession number by TIU Note IEN
"RTN","MAGNU003",103,0)
 N MAGMRC,IEN
"RTN","MAGNU003",104,0)
 ;
"RTN","MAGNU003",105,0)
 D GET1405^TIUSRVR(.MAGMRC,MAGTIUDA)
"RTN","MAGNU003",106,0)
 S IEN=+MAGMRC
"RTN","MAGNU003",107,0)
 I (IEN'>0)!'(MAGMRC["GMR(123") Q ""
"RTN","MAGNU003",108,0)
 Q $$GMRCACN^MAGDFCNV(IEN)  ; site-specific accession number
"RTN","MAGNU003",109,0)
 ;
"RTN","MAGNU003",110,0)
CPRSCTX(REFTYPE,REFIEN)  ; Create CPRS Context ID
"RTN","MAGNU003",111,0)
 ; REFTYPE = "RAD", "TIU"
"RTN","MAGNU003",112,0)
 ; REFIEN  = IEN in respective file of REFTYPE
"RTN","MAGNU003",113,0)
 ;
"RTN","MAGNU003",114,0)
 N CTXID
"RTN","MAGNU003",115,0)
 I REFTYPE="TIU" D  Q CTXID
"RTN","MAGNU003",116,0)
 . S CTXID=$$TIUCPRS(REFIEN)
"RTN","MAGNU003",117,0)
 . Q
"RTN","MAGNU003",118,0)
 ;
"RTN","MAGNU003",119,0)
 I REFTYPE="RAD" D  Q CTXID
"RTN","MAGNU003",120,0)
 . S CTXID=$$RACPRS(REFIEN)
"RTN","MAGNU003",121,0)
 . Q
"RTN","MAGNU003",122,0)
 ;
"RTN","MAGNU003",123,0)
 Q ""
"RTN","MAGNU003",124,0)
 ;
"RTN","MAGNU003",125,0)
REFBYACN(REFTYPE,REFIEN,ACNUMB) ; Get report by accession number
"RTN","MAGNU003",126,0)
 N GMRCIEN,IEN,LST
"RTN","MAGNU003",127,0)
 S (REFTYPE,REFIEN)=""
"RTN","MAGNU003",128,0)
 ;
"RTN","MAGNU003",129,0)
 I ACNUMB="" Q
"RTN","MAGNU003",130,0)
 S IEN=$O(^MAGV(2005.62,"D",ACNUMB,""))
"RTN","MAGNU003",131,0)
 I IEN'>0 Q
"RTN","MAGNU003",132,0)
 S REFTYPE=$$GET1^DIQ(2005.62,IEN,"11:.03","I")  ; Get procedure type (RAD, CON, etc)
"RTN","MAGNU003",133,0)
 ;
"RTN","MAGNU003",134,0)
 I REFTYPE="RAD" D  Q
"RTN","MAGNU003",135,0)
 . N I,DFN,INVDT,ENT
"RTN","MAGNU003",136,0)
 . D ACCFIND^RAAPI(ACNUMB,.LST) ; IA 5020
"RTN","MAGNU003",137,0)
 . S I=$O(LST(""))
"RTN","MAGNU003",138,0)
 . Q:I'>0
"RTN","MAGNU003",139,0)
 . S DFN=$P(LST(I),"^")
"RTN","MAGNU003",140,0)
 . S INVDT=$P(LST(I),"^",2)
"RTN","MAGNU003",141,0)
 . S ENT=$P(LST(I),"^",3)
"RTN","MAGNU003",142,0)
 . S REFIEN=$P(^RADPT(DFN,"DT",INVDT,"P",ENT,0),U,17)
"RTN","MAGNU003",143,0)
 . Q
"RTN","MAGNU003",144,0)
 ;
"RTN","MAGNU003",145,0)
 I REFTYPE="CON" D  Q
"RTN","MAGNU003",146,0)
 . S REFTYPE="TIU"
"RTN","MAGNU003",147,0)
 . S GMRCIEN=$$GMRCIEN(ACNUMB)
"RTN","MAGNU003",148,0)
 . Q:GMRCIEN'>0  ; invalid IEN
"RTN","MAGNU003",149,0)
 . D GETDOCS^TIUSRVLR(.LST,GMRCIEN_";GMR(123,") ; IA 3536
"RTN","MAGNU003",150,0)
 . S REFIEN=$P($G(@LST@(1)),"^")
"RTN","MAGNU003",151,0)
 . Q
"RTN","MAGNU003",152,0)
 Q
"RTN","MAGNU003",153,0)
 ;
"RTN","MAGNU003",154,0)
GMRCIEN(ACNUMB) ; return the GMRC IEN, given a consult/procedure accession number
"RTN","MAGNU003",155,0)
 ; ACNUMB is the accession number for a consult/procedure request
"RTN","MAGNU003",156,0)
 ; OLD Format: GMRC-<gmrcien>, where <gmrcien>is the internal entry number of the request
"RTN","MAGNU003",157,0)
 ; New Format: <sss>-GMR-<gmrcien>, where <sss> is station number, and <gmrcien>
"RTN","MAGNU003",158,0)
 ;             is the internal entry number of the request, up to 8 digits (100 million)
"RTN","MAGNU003",159,0)
 N GMRCIEN ; CPRS Consult Request Tracking GMRC IEN - REQUEST/CONSULTATION file(#123)
"RTN","MAGNU003",160,0)
 S GMRCIEN=""
"RTN","MAGNU003",161,0)
 I ACNUMB?1"GMRC-"1N.N S GMRCIEN=$P(ACNUMB,"-",2) ; return the second piece
"RTN","MAGNU003",162,0)
 E  I ACNUMB?1N.N1"-GMR-"1N.N S:$P(ACNUMB,"-",1)=$$STATNUMB^MAGDFCNV() GMRCIEN=$P(ACNUMB,"-",3) ; return the third piece
"RTN","MAGNU003",163,0)
 ;
"RTN","MAGNU003",164,0)
 Q GMRCIEN
"RTN","MAGNU003",165,0)
 ;
"RTN","MAGNU003",166,0)
RACPRS(REFIEN) ; Return Radiology CRPS context by Report IEN in file #74
"RTN","MAGNU003",167,0)
 ; REFIEN - Radiology report IEN in file #74
"RTN","MAGNU003",168,0)
 I REFIEN'>0 Q ""
"RTN","MAGNU003",169,0)
 N DAYCASE,CASE,DATETIME,INVDAT,ENT,CONTEXT
"RTN","MAGNU003",170,0)
 S DAYCASE=$$GET1^DIQ(74,REFIEN,.01)
"RTN","MAGNU003",171,0)
 S DFN=$$GET1^DIQ(74,REFIEN,2,"I")
"RTN","MAGNU003",172,0)
 S DATETIME=$$GET1^DIQ(74,REFIEN,3,"I")
"RTN","MAGNU003",173,0)
 S INVDAT=9999999.9999-DATETIME
"RTN","MAGNU003",174,0)
 S CASE=$$GET1^DIQ(74,REFIEN,4)
"RTN","MAGNU003",175,0)
 S ENT=$O(^RADPT("ADC1",DAYCASE,DFN,INVDAT,""))
"RTN","MAGNU003",176,0)
 I 'ENT S ENT=$O(^RADPT("ADC",DAYCASE,DFN,INVDAT,""))
"RTN","MAGNU003",177,0)
 S CONTEXT="RPT^CPRS^"_DFN_"^RA^i"_INVDAT_"-"_ENT_"^"_CASE
"RTN","MAGNU003",178,0)
 Q CONTEXT
"RTN","MAGNU003",179,0)
 ;
"RTN","MAGNU003",180,0)
TIUCPRS(REFIEN) ; Return TIU CRPS context by TIU note IEN in file #8925
"RTN","MAGNU003",181,0)
 ; REFIEN - TIU note IEN in file #8925
"RTN","MAGNU003",182,0)
 I REFIEN'>0 Q ""
"RTN","MAGNU003",183,0)
 N DFN,CONTEXT
"RTN","MAGNU003",184,0)
 S DFN=$$GET1^DIQ(8925,REFIEN,.02,"I")
"RTN","MAGNU003",185,0)
 S CONTEXT="RPT^CPRS^"_DFN_"^TIU^"_REFIEN
"RTN","MAGNU003",186,0)
 Q CONTEXT
"RTN","MAGVAG05")
0^21^B3394973
"RTN","MAGVAG05",1,0)
MAGVAG05 ;WOIFO/NST - Utilities for RPC calls ; 02 Oct 2017 4:18 PM
"RTN","MAGVAG05",2,0)
 ;;3.0;IMAGING;**185**;Mar 19, 2002;Build 4525;May 01, 2013
"RTN","MAGVAG05",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGVAG05",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVAG05",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGVAG05",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGVAG05",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGVAG05",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGVAG05",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGVAG05",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGVAG05",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGVAG05",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGVAG05",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGVAG05",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGVAG05",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGVAG05",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVAG05",17,0)
 ;;
"RTN","MAGVAG05",18,0)
 Q
"RTN","MAGVAG05",19,0)
 ;
"RTN","MAGVAG05",20,0)
 ;*****  Returns all records in NETWORK LOCATION file (#2005.2)
"RTN","MAGVAG05",21,0)
 ;       
"RTN","MAGVAG05",22,0)
 ; RPC: MAGVA GET ALL NETWORK LOCATIONS
"RTN","MAGVAG05",23,0)
 ; 
"RTN","MAGVAG05",24,0)
 ; if error found during execution
"RTN","MAGVAG05",25,0)
 ;   MAGRY(0) = Failure status ^ "Error getting the list"
"RTN","MAGVAG05",26,0)
 ; if success
"RTN","MAGVAG05",27,0)
 ;   MAGRY(0)    = Success status ^^#CNT" - where #CNT is a number of records returned
"RTN","MAGVAG05",28,0)
 ;   MAGRY(1)    = "^" delimited string with all field names in NETWORK LOCATION file (#2005.2)
"RTN","MAGVAG05",29,0)
 ;   MAGRY(2..n) = "^" delimited string with values of fields listed in MAGRY(1) 
"RTN","MAGVAG05",30,0)
 ;
"RTN","MAGVAG05",31,0)
GETNL(MAGRY) ; RPC [MAGVA GET ALL NETWORK LOCATION]
"RTN","MAGVAG05",32,0)
 D GALLLST^MAGVAF03(.MAGRY,2005.2,"")
"RTN","MAGVAG05",33,0)
 Q
"RTN","MAGVIM08")
0^22^B23870020
"RTN","MAGVIM08",1,0)
MAGVIM08 ;;WOIFO/NST,JSL,DAC - Imaging RPCs for Importer II/III ; 20 Dec 2017 10:01 AM
"RTN","MAGVIM08",2,0)
 ;;3.0;IMAGING;**118,185**;Mar 19, 2002;Build 3;DEC 23, 2016
"RTN","MAGVIM08",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGVIM08",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVIM08",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGVIM08",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGVIM08",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGVIM08",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGVIM08",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGVIM08",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGVIM08",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGVIM08",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGVIM08",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGVIM08",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGVIM08",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGVIM08",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVIM08",17,0)
 ;;
"RTN","MAGVIM08",18,0)
 Q
"RTN","MAGVIM08",19,0)
 ;
"RTN","MAGVIM08",20,0)
 ;*****  Return number of records in MAG WORK ITEM file (#2006.941)
"RTN","MAGVIM08",21,0)
 ;       by TYPE, SUBTYPE, and STATUS
"RTN","MAGVIM08",22,0)
 ;    
"RTN","MAGVIM08",23,0)
 ; RPC:MAGV WORK ITEMS COUNT
"RTN","MAGVIM08",24,0)
 ; 
"RTN","MAGVIM08",25,0)
 ; Input Parameters
"RTN","MAGVIM08",26,0)
 ; ================
"RTN","MAGVIM08",27,0)
 ;   TYPE    = External value of TYPE field (#2006.941,1)
"RTN","MAGVIM08",28,0)
 ;   [SUBTYPE] = External value of SUBTYPE field (#2006.941,2)
"RTN","MAGVIM08",29,0)
 ;   [STATUS]  = External value of STATUS field (#2006.941,3) 
"RTN","MAGVIM08",30,0)
 ;
"RTN","MAGVIM08",31,0)
 ; Return Values
"RTN","MAGVIM08",32,0)
 ; =============
"RTN","MAGVIM08",33,0)
 ; if error MAGRY(0) = Error number `` Error message
"RTN","MAGVIM08",34,0)
 ; if success MAGRY(0) = 0` Number of records
"RTN","MAGVIM08",35,0)
 ;            MAGRY(1) = "SUBTYPE`STATUS`COUNT"   
"RTN","MAGVIM08",36,0)
 ;            MAGRY(1..n) = SUBTYPE  ` STATUS ` COUNT
"RTN","MAGVIM08",37,0)
 ;
"RTN","MAGVIM08",38,0)
CNTWI(MAGRY,TYPE,SUBTYPE,STATUS) ; RPC [MAGV WORK ITEMS COUNT]
"RTN","MAGVIM08",39,0)
 N SSEP,MAGRESA,MAGNXE,I,OUT,TOTAL,TYPEIEN,VSUB,VSTAT
"RTN","MAGVIM08",40,0)
 S SSEP=$$STATSEP^MAGVIM01
"RTN","MAGVIM08",41,0)
 I $G(TYPE)="" S MAGRY(0)=-1_SSEP_"No type provided" Q
"RTN","MAGVIM08",42,0)
 S SUBTYPE=$G(SUBTYPE)
"RTN","MAGVIM08",43,0)
 S STATUS=$G(STATUS)
"RTN","MAGVIM08",44,0)
 ;
"RTN","MAGVIM08",45,0)
 S TYPEIEN=$$FIND1^DIC(2006.9412,"","BX",TYPE,"","","MAGNXE") ; Find the IEN for TYPE
"RTN","MAGVIM08",46,0)
 I $D(MAGNXE("DIERR")) D  Q
"RTN","MAGVIM08",47,0)
 . D MSG^DIALOG("A",.MAGRESA,245,5,"MAGNXE")
"RTN","MAGVIM08",48,0)
 . S MAGRY(0)=-1_SSEP_MAGRESA(1)
"RTN","MAGVIM08",49,0)
 . Q
"RTN","MAGVIM08",50,0)
 ;
"RTN","MAGVIM08",51,0)
 I TYPEIEN'>0 S MAGRY(0)=-2_SSEP_"Type is not found" Q
"RTN","MAGVIM08",52,0)
 ; 
"RTN","MAGVIM08",53,0)
 D FIND^DIC(2006.941,"","@;2;3","QX",TYPEIEN,"","T","","","OUT","MAGNXE")
"RTN","MAGVIM08",54,0)
 I $D(MAGNXE("DIERR")) D  Q
"RTN","MAGVIM08",55,0)
 . D MSG^DIALOG("A",.MAGRESA,245,5,"MAGNXE")
"RTN","MAGVIM08",56,0)
 . S MAGRY(0)=-3_SSEP_MAGRESA(1) Q  ; Error getting the list
"RTN","MAGVIM08",57,0)
 . Q
"RTN","MAGVIM08",58,0)
 ; Output the result
"RTN","MAGVIM08",59,0)
 ; 
"RTN","MAGVIM08",60,0)
 S I=0
"RTN","MAGVIM08",61,0)
 F  S I=$O(OUT("DILIST","ID",I)) Q:I'>0  D
"RTN","MAGVIM08",62,0)
 . S VSUB=OUT("DILIST","ID",I,2)
"RTN","MAGVIM08",63,0)
 . I (SUBTYPE'=""),(VSUB'=SUBTYPE) Q
"RTN","MAGVIM08",64,0)
 . S VSTAT=OUT("DILIST","ID",I,3)
"RTN","MAGVIM08",65,0)
 . I (STATUS'=""),(VSTAT'=STATUS) Q
"RTN","MAGVIM08",66,0)
 . S TOTAL(VSUB,VSTAT)=$G(TOTAL(VSUB,VSTAT))+1
"RTN","MAGVIM08",67,0)
 . Q
"RTN","MAGVIM08",68,0)
 ;
"RTN","MAGVIM08",69,0)
 D OUTRES(.MAGRY,.TOTAL)  ; Output the totals
"RTN","MAGVIM08",70,0)
 Q
"RTN","MAGVIM08",71,0)
 ;
"RTN","MAGVIM08",72,0)
OUTRES(MAGRY,TOTAL)  ; Output the final result by SUBTYPE and STATUS
"RTN","MAGVIM08",73,0)
 ; TOTAL - Input totals
"RTN","MAGVIM08",74,0)
 ;     TOTAL("DirectImport","New")=3
"RTN","MAGVIM08",75,0)
 ;     .....
"RTN","MAGVIM08",76,0)
 ; MAGRY - Output array
"RTN","MAGVIM08",77,0)
 ;   MAGRY(0)=0`Total pairs (SUBTYPE,STATUS)
"RTN","MAGVIM08",78,0)
 ;   MAGRY(1)="SUBTYPE`STATUS`COUNT"
"RTN","MAGVIM08",79,0)
 N SSEP,CNT,SUBVAL,STATVAL
"RTN","MAGVIM08",80,0)
 S SSEP=$$STATSEP^MAGVIM01
"RTN","MAGVIM08",81,0)
 K MAGRY
"RTN","MAGVIM08",82,0)
 S MAGRY(1)="SUBTYPE`STATUS`COUNT"
"RTN","MAGVIM08",83,0)
 S CNT=1
"RTN","MAGVIM08",84,0)
 S (SUBVAL,STATVAL)=""
"RTN","MAGVIM08",85,0)
 F  S SUBVAL=$O(TOTAL(SUBVAL)) Q:SUBVAL=""  D
"RTN","MAGVIM08",86,0)
 . F  S STATVAL=$O(TOTAL(SUBVAL,STATVAL)) Q:STATVAL=""  D
"RTN","MAGVIM08",87,0)
 . . S CNT=CNT+1,MAGRY(CNT)=SUBVAL_SSEP_STATVAL_SSEP_TOTAL(SUBVAL,STATVAL)
"RTN","MAGVIM08",88,0)
 . . Q
"RTN","MAGVIM08",89,0)
 . Q
"RTN","MAGVIM08",90,0)
 S MAGRY(0)=0_SSEP_(CNT-1)
"RTN","MAGVIM08",91,0)
 Q
"RTN","MAGVIM08",92,0)
 ;
"RTN","MAGVIM08",93,0)
 ;*****  Return RA Provider records in PERSON file (#200)
"RTN","MAGVIM08",94,0)
 ;       by DUZ, NAME , and INITIAL
"RTN","MAGVIM08",95,0)
 ;    
"RTN","MAGVIM08",96,0)
 ; RPC:MAGV GET RAD PROVIDER
"RTN","MAGVIM08",97,0)
 ; 
"RTN","MAGVIM08",98,0)
 ; Input Parameters
"RTN","MAGVIM08",99,0)
 ; ================
"RTN","MAGVIM08",100,0)
 ;   MAGIN    = Input of RA provider (string)
"RTN","MAGVIM08",101,0)
 ; Return Values
"RTN","MAGVIM08",102,0)
 ; =============
"RTN","MAGVIM08",103,0)
 ; if error RESULTS(0) = Error number `` Error message
"RTN","MAGVIM08",104,0)
 ; if success MAGRY(0) = 0` Number of records
"RTN","MAGVIM08",105,0)
 ;            MAGRY(1) = "PERSON IEN`FULL NAME`INITIAL"   
"RTN","MAGVIM08",106,0)
 ;            MAGRY(1..n) = DUZ  ` NAME ` INIT
"RTN","MAGVIM08",107,0)
 ;  For example: RESULTS(n)="123^IMAGPROVIDERONETHREEFOUR,ONETH^TST^^"
"RTN","MAGVIM08",108,0)
 ;
"RTN","MAGVIM08",109,0)
PROVLST(RESULTS,MAGIN) ; RPC [MAGV GET RAD PROVIDER]= "PSB GETPROVIDER"+ RA filter
"RTN","MAGVIM08",110,0)
 N X,Y,MAGNOW,MAGNXE,MAGRESA,PRVAUTH,PRVIACT,PRVIEN,PRVTERM
"RTN","MAGVIM08",111,0)
 K ^TMP("MAGV",$J)
"RTN","MAGVIM08",112,0)
 S MAGNOW=$$NOW^XLFDT()
"RTN","MAGVIM08",113,0)
 S MAGIN=$TR(MAGIN,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","MAGVIM08",114,0)
 S RESULTS(0)=1,RESULTS(1)="-1^No provider matching input."
"RTN","MAGVIM08",115,0)
 D LIST^DIC(200,"","","P","","",MAGIN,"B","","","^TMP(""MAGV"",$J)","MAGNXE")
"RTN","MAGVIM08",116,0)
 I $D(MAGNXE("DIERR")) D  Q
"RTN","MAGVIM08",117,0)
 . D MSG^DIALOG("A",.MAGRESA,245,5,"MAGNXE")
"RTN","MAGVIM08",118,0)
 . S RESULTS(0)="-3^"_MAGRESA(1)  ; Error getting the list
"RTN","MAGVIM08",119,0)
 . Q
"RTN","MAGVIM08",120,0)
 S X=0
"RTN","MAGVIM08",121,0)
 F  S X=$O(^TMP("MAGV",$J,"DILIST",X)) Q:(X="")  D
"RTN","MAGVIM08",122,0)
 . S PRVIEN=$P(^TMP("MAGV",$J,"DILIST",X,0),U,1)
"RTN","MAGVIM08",123,0)
 . I '$D(^XUSEC("PROVIDER",PRVIEN)) Q
"RTN","MAGVIM08",124,0)
 . S PRVIACT=$$GET1^DIQ(200,PRVIEN_",",53.4,"I")
"RTN","MAGVIM08",125,0)
 . Q:PRVIACT'=""&(+PRVIACT'>MAGNOW)  ;if Inactive date and date is less than now Q
"RTN","MAGVIM08",126,0)
 . S PRVTERM=$$GET1^DIQ(200,PRVIEN_",",9.2,"I")
"RTN","MAGVIM08",127,0)
 . Q:PRVTERM'=""&(+PRVTERM'>MAGNOW)  ;if termination date and date is less than now Q
"RTN","MAGVIM08",128,0)
 . S PRVAUTH=$$GET1^DIQ(200,PRVIEN_",",53.1,"I") I PRVAUTH'=1 Q  ;is AUTHORIZED TO WRITE MED ORDERS
"RTN","MAGVIM08",129,0)
 . S Y=PRVIEN Q:'$$PROV^RABWORD()  ;is RA provider
"RTN","MAGVIM08",130,0)
 . I RESULTS(1)["-1" S RESULTS(0)=0
"RTN","MAGVIM08",131,0)
 . S RESULTS(0)=RESULTS(0)+1,RESULTS(RESULTS(0))=$P(^TMP("MAGV",$J,"DILIST",X,0),U,1,2)
"RTN","MAGVIM08",132,0)
 . I RESULTS(0)>100 K RESULTS S RESULTS(0)=1,RESULTS(1)=-2
"RTN","MAGVIM08",133,0)
 . Q
"RTN","MAGVIM08",134,0)
 K ^TMP("MAGV",$J)
"RTN","MAGVIM08",135,0)
 Q
"SEC","^DIC",2005.003,2005.003,0,"AUDIT")

"SEC","^DIC",2005.003,2005.003,0,"DD")
@
"SEC","^DIC",2005.003,2005.003,0,"DEL")
@
"SEC","^DIC",2005.003,2005.003,0,"LAYGO")
@
"SEC","^DIC",2005.003,2005.003,0,"RD")
@
"SEC","^DIC",2005.003,2005.003,0,"WR")
@
"VER")
8.0^22.0
"^DD",2005.003,2005.003,0)
FIELD^^1^2
"^DD",2005.003,2005.003,0,"DDA")
N
"^DD",2005.003,2005.003,0,"DT")
3170403
"^DD",2005.003,2005.003,0,"IX","B",2005.003,.01)

"^DD",2005.003,2005.003,0,"NM","IMAGING STUDY ANNOTATION")

"^DD",2005.003,2005.003,0,"VRPK")
MAG
"^DD",2005.003,2005.003,.01,0)
STUDY^RF^^0;1^K:$L(X)>64!($L(X)<1) X
"^DD",2005.003,2005.003,.01,.1)
ANNOTATE STUDY
"^DD",2005.003,2005.003,.01,1,0)
^.1
"^DD",2005.003,2005.003,.01,1,1,0)
2005.003^B
"^DD",2005.003,2005.003,.01,1,1,1)
S ^MAG(2005.003,"B",$E(X,1,64),DA)=""
"^DD",2005.003,2005.003,.01,1,1,2)
K ^MAG(2005.003,"B",$E(X,1,64),DA)
"^DD",2005.003,2005.003,.01,3)
Select the study.
"^DD",2005.003,2005.003,.01,21,0)
^^1^1^3170324^^
"^DD",2005.003,2005.003,.01,21,1,0)
This is the study being annotated.
"^DD",2005.003,2005.003,.01,"DT")
3170324
"^DD",2005.003,2005.003,1,0)
ANNOTATION GROUP^2005.0031A^^1;0
"^DD",2005.003,2005.003,1,21,0)
^^1^1^3170326^
"^DD",2005.003,2005.003,1,21,1,0)
These fields store user annotations to the study..
"^DD",2005.003,2005.0031,0)
ANNOTATION GROUP SUB-FIELD^^9^10
"^DD",2005.003,2005.0031,0,"DT")
3170403
"^DD",2005.003,2005.0031,0,"IX","B",2005.0031,.01)

"^DD",2005.003,2005.0031,0,"NM","ANNOTATION GROUP")

"^DD",2005.003,2005.0031,0,"UP")
2005.003
"^DD",2005.003,2005.0031,.01,0)
PSTATEUID^RF^^0;1^K:$L(X)>64!($L(X)<1) X
"^DD",2005.003,2005.0031,.01,1,0)
^.1
"^DD",2005.003,2005.0031,.01,1,1,0)
2005.0031^B
"^DD",2005.003,2005.0031,.01,1,1,1)
S ^MAG(2005.003,DA(1),1,"B",$E(X,1,64),DA)=""
"^DD",2005.003,2005.0031,.01,1,1,2)
K ^MAG(2005.003,DA(1),1,"B",$E(X,1,64),DA)
"^DD",2005.003,2005.0031,.01,3)
This is globaly unique annotation identifier.
"^DD",2005.003,2005.0031,.01,21,0)
^^1^1^3170326^^
"^DD",2005.003,2005.0031,.01,21,1,0)
This field stores the globaly unique annotation identifier.
"^DD",2005.003,2005.0031,.01,"DT")
3170510
"^DD",2005.003,2005.0031,1,0)
ANNOTATOR^RP200'^VA(200,^0;2^Q
"^DD",2005.003,2005.0031,1,3)
Select the user who made the annotation.
"^DD",2005.003,2005.0031,1,"DT")
3170328
"^DD",2005.003,2005.0031,2,0)
SAVED DATE/TIME^RD^^0;3^S %DT="ESTR" D ^%DT S X=Y K:Y<1 X
"^DD",2005.003,2005.0031,2,3)
Enter date and time.
"^DD",2005.003,2005.0031,2,21,0)
^.001^1^1^3111116^^
"^DD",2005.003,2005.0031,2,21,1,0)
Date and time the image was annotated/stored.
"^DD",2005.003,2005.0031,2,"DT")
3170328
"^DD",2005.003,2005.0031,3,0)
VERSION^F^^0;4^K:$L(X)>15!($L(X)<1) X
"^DD",2005.003,2005.0031,3,3)
Annotation (tool) version must be 1-15 characters in length.
"^DD",2005.003,2005.0031,3,21,0)
^.001^1^1^3120430^^^
"^DD",2005.003,2005.0031,3,21,1,0)
The annotation tool version that was used to create the annotated image.
"^DD",2005.003,2005.0031,3,"DT")
3170328
"^DD",2005.003,2005.0031,4,0)
SOURCE^F^^0;5^K:$L(X)>15!($L(X)<1) X
"^DD",2005.003,2005.0031,4,3)
Annotation source must be 1-15 characters in length.
"^DD",2005.003,2005.0031,4,"DT")
3170328
"^DD",2005.003,2005.0031,5,0)
DELETED^S^1:Yes;0:No;^0;6^Q
"^DD",2005.003,2005.0031,5,3)
Was the annotation deleted?
"^DD",2005.003,2005.0031,5,21,0)
1^.001^1^1^3120716^
"^DD",2005.003,2005.0031,5,21,1,0)
Indicates whether or not an annotation layer has been marked as deleted.
"^DD",2005.003,2005.0031,5,"DT")
3170328
"^DD",2005.003,2005.0031,6,0)
PRESENTATION^2005.0032^^1;0
"^DD",2005.003,2005.0031,6,3)
Indicate the completion of TIU document image.
"^DD",2005.003,2005.0031,6,21,0)
^^1^1^3170328^^
"^DD",2005.003,2005.0031,6,21,1,0)
This field contains the annotation XML raw data.
"^DD",2005.003,2005.0031,6,"DT")
3170328
"^DD",2005.003,2005.0031,7,0)
SERVICE^P49'^DIC(49,^0;7^Q
"^DD",2005.003,2005.0031,7,3)
Enter Service/Section of annotator.
"^DD",2005.003,2005.0031,7,21,0)
^.001^1^1^3120420^^^
"^DD",2005.003,2005.0031,7,21,1,0)
Service/Section of annotator when the annotation was made.
"^DD",2005.003,2005.0031,7,23,0)
^.001^1^1^3120420^^
"^DD",2005.003,2005.0031,7,23,1,0)
Annotator Service/Section of NEW PERSON file(#200)
"^DD",2005.003,2005.0031,7,"DT")
3111122
"^DD",2005.003,2005.0031,8,0)
SITE^P4'^DIC(4,^0;8^Q
"^DD",2005.003,2005.0031,8,3)
Enter Site/Institution.
"^DD",2005.003,2005.0031,8,21,0)
^.001^1^1^3111116^^^
"^DD",2005.003,2005.0031,8,21,1,0)
The site/division at which the annotator logged in and annotated image.
"^DD",2005.003,2005.0031,8,"DT")
3110630
"^DD",2005.003,2005.0031,9,0)
ANNOTATION NAME^F^^0;9^K:$L(X)>30!($L(X)<1) X
"^DD",2005.003,2005.0031,9,3)
Answer must be 1-30 characters in length.
"^DD",2005.003,2005.0031,9,21,0)
^^1^1^3170403^
"^DD",2005.003,2005.0031,9,21,1,0)
This is the name of annotation.
"^DD",2005.003,2005.0031,9,"DT")
3170403
"^DD",2005.003,2005.0032,0)
PRESENTATION SUB-FIELD^^.01^1
"^DD",2005.003,2005.0032,0,"DT")
3110601
"^DD",2005.003,2005.0032,0,"NM","PRESENTATION")

"^DD",2005.003,2005.0032,0,"UP")
2005.0031
"^DD",2005.003,2005.0032,.01,0)
PRESENTATION DATA^Wx^^0;1^Q
"^DD",2005.003,2005.0032,.01,3)
Annotation presentation raw data
"^DD",2005.003,2005.0032,.01,23,0)
^^1^1^3120420^
"^DD",2005.003,2005.0032,.01,23,1,0)
XML raw data will be divided into 240 characters each line.
"^DD",2005.003,2005.0032,.01,"DT")
3170328
"^DIC",2005.003,2005.003,0)
IMAGING STUDY ANNOTATION^2005.003
"^DIC",2005.003,2005.003,0,"GL")
^MAG(2005.003,
"^DIC",2005.003,2005.003,"%",0)
^1.005^1^1
"^DIC",2005.003,2005.003,"%",1,0)
MAG
"^DIC",2005.003,2005.003,"%","B","MAG",1)

"^DIC",2005.003,2005.003,"%D",0)
^1.001^21^21^3111013^^^^
"^DIC",2005.003,2005.003,"%D",1,0)
 +---------------------------------------------------------------+
"^DIC",2005.003,2005.003,"%D",2,0)
 |                                                               |
"^DIC",2005.003,2005.003,"%D",3,0)
 | Property of the US Government.                                |
"^DIC",2005.003,2005.003,"%D",4,0)
 | No permission to copy or redistribute this software is given. |
"^DIC",2005.003,2005.003,"%D",5,0)
 | Use of unreleased versions of this software requires the user |
"^DIC",2005.003,2005.003,"%D",6,0)
 | to execute a written test agreement with the VistA Imaging    |
"^DIC",2005.003,2005.003,"%D",7,0)
 | Development Office of the Department of Veterans Affairs,     |
"^DIC",2005.003,2005.003,"%D",8,0)
 | telephone (301) 734-0100.                                     |
"^DIC",2005.003,2005.003,"%D",9,0)
 |                                                               |
"^DIC",2005.003,2005.003,"%D",10,0)
 | The Food and Drug Administration classifies this software as  |
"^DIC",2005.003,2005.003,"%D",11,0)
 | a medical device.  As such, it may not be changed in any way. |
"^DIC",2005.003,2005.003,"%D",12,0)
 | Modifications to this software may result in an adulterated   |
"^DIC",2005.003,2005.003,"%D",13,0)
 | medical device under 21CFR820, the use of which is considered |
"^DIC",2005.003,2005.003,"%D",14,0)
 | to be a violation of US Federal Statutes.                     |
"^DIC",2005.003,2005.003,"%D",15,0)
 |                                                               |
"^DIC",2005.003,2005.003,"%D",16,0)
 +---------------------------------------------------------------+
"^DIC",2005.003,2005.003,"%D",17,0)
 
"^DIC",2005.003,2005.003,"%D",18,0)
This file contains an entry for each annotated study. The information
"^DIC",2005.003,2005.003,"%D",19,0)
includes the detail about each annotation, e.g.: annotator, date/time
"^DIC",2005.003,2005.003,"%D",20,0)
saved, tool version, source and XML data...etc. 
"^DIC",2005.003,2005.003,"%D",21,0)

"^DIC",2005.003,"B","IMAGING STUDY ANNOTATION",2005.003)

**END**
**END**
