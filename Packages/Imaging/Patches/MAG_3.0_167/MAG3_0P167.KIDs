KIDS Distribution saved on Dec 20, 2016@11:30:37
VistA Imaging V3 - Patch 167 - Clinical Capture
**KIDS**:MAG*3.0*167^

**INSTALL NAME**
MAG*3.0*167
"BLD",8343,0)
MAG*3.0*167^IMAGING^0^3161220^y
"BLD",8343,1,0)
^^22^22^3161204^^^^
"BLD",8343,1,1,0)
VistA Imaging V3.0 Patch 167 - Display Issues
"BLD",8343,1,2,0)
 
"BLD",8343,1,3,0)
This Patch includes a new Clinical Display Client
"BLD",8343,1,4,0)
Changes in the Clinical Display client will address the
"BLD",8343,1,5,0)
upgrade to MUSE API 3.
"BLD",8343,1,6,0)
Also, Clinical Capture users will be able to open images 
"BLD",8343,1,7,0)
in a seperate window of Clinical Display for Annotation.
"BLD",8343,1,8,0)
This patch also had fixes from patch 150 for the
"BLD",8343,1,9,0)
Image Never Existed issue.
"BLD",8343,1,10,0)
A new option on the Image Delete window will allow
"BLD",8343,1,11,0)
the user to Copy the Image to the local hard drive
"BLD",8343,1,12,0)
before deleting.  This will enable the user to 
"BLD",8343,1,13,0)
import the image to a new Patient or Re-Index the 
"BLD",8343,1,14,0)
Image without the need to Print and ReScan. 
"BLD",8343,1,15,0)
  
"BLD",8343,1,16,0)
This will check the routines from a BUILD file.
"BLD",8343,1,17,0)
Select BUILD NAME:    MAG*3.0*167     IMAGING
"BLD",8343,1,18,0)
MAGGTID   value = 85911502
"BLD",8343,1,19,0)
MAGGTU4D  value = 5313921
"BLD",8343,1,20,0)
MAGIP167  value = 11436109
"BLD",8343,1,21,0)
MAGSIXG3  value = 84985360
"BLD",8343,1,22,0)
done
"BLD",8343,4,0)
^9.64PA^2006.1^1
"BLD",8343,4,2006.1,0)
2006.1
"BLD",8343,4,2006.1,2,0)
^9.641^2006.1^1
"BLD",8343,4,2006.1,2,2006.1,0)
IMAGING SITE PARAMETERS  (File-top level)
"BLD",8343,4,2006.1,2,2006.1,1,0)
^9.6411^76^2
"BLD",8343,4,2006.1,2,2006.1,1,75,0)
DISPLAY HELP URL
"BLD",8343,4,2006.1,2,2006.1,1,76,0)
CAPTURE HELP URL
"BLD",8343,4,2006.1,222)
y^y^p^^^^n^^n
"BLD",8343,4,2006.1,224)

"BLD",8343,4,"APDD",2006.1,2006.1)

"BLD",8343,4,"APDD",2006.1,2006.1,75)

"BLD",8343,4,"APDD",2006.1,2006.1,76)

"BLD",8343,4,"B",2006.1,2006.1)

"BLD",8343,6.3)
30
"BLD",8343,"ABNS",0)
^9.66A^^0
"BLD",8343,"ABPKG")
n^n^G.IMAGING DEVELOPMENT TEAM@domain.ext
"BLD",8343,"INI")
PRE^MAGIP167
"BLD",8343,"INID")
n^y^n
"BLD",8343,"INIT")
POS^MAGIP167
"BLD",8343,"KRN",0)
^9.67PA^779.2^20
"BLD",8343,"KRN",.4,0)
.4
"BLD",8343,"KRN",.401,0)
.401
"BLD",8343,"KRN",.402,0)
.402
"BLD",8343,"KRN",.403,0)
.403
"BLD",8343,"KRN",.5,0)
.5
"BLD",8343,"KRN",.84,0)
.84
"BLD",8343,"KRN",3.6,0)
3.6
"BLD",8343,"KRN",3.8,0)
3.8
"BLD",8343,"KRN",9.2,0)
9.2
"BLD",8343,"KRN",9.8,0)
9.8
"BLD",8343,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",8343,"KRN",9.8,"NM",1,0)
MAGGTU4D^^0^B5313965
"BLD",8343,"KRN",9.8,"NM",2,0)
MAGIP167^^0^B11436109
"BLD",8343,"KRN",9.8,"NM",3,0)
MAGGTID^^0^B85911502
"BLD",8343,"KRN",9.8,"NM",4,0)
MAGSIXG3^^0^B84985360
"BLD",8343,"KRN",9.8,"NM","B","MAGGTID",3)

"BLD",8343,"KRN",9.8,"NM","B","MAGGTU4D",1)

"BLD",8343,"KRN",9.8,"NM","B","MAGIP167",2)

"BLD",8343,"KRN",9.8,"NM","B","MAGSIXG3",4)

"BLD",8343,"KRN",19,0)
19
"BLD",8343,"KRN",19.1,0)
19.1
"BLD",8343,"KRN",101,0)
101
"BLD",8343,"KRN",409.61,0)
409.61
"BLD",8343,"KRN",771,0)
771
"BLD",8343,"KRN",779.2,0)
779.2
"BLD",8343,"KRN",870,0)
870
"BLD",8343,"KRN",8989.51,0)
8989.51
"BLD",8343,"KRN",8989.52,0)
8989.52
"BLD",8343,"KRN",8994,0)
8994
"BLD",8343,"KRN","B",.4,.4)

"BLD",8343,"KRN","B",.401,.401)

"BLD",8343,"KRN","B",.402,.402)

"BLD",8343,"KRN","B",.403,.403)

"BLD",8343,"KRN","B",.5,.5)

"BLD",8343,"KRN","B",.84,.84)

"BLD",8343,"KRN","B",3.6,3.6)

"BLD",8343,"KRN","B",3.8,3.8)

"BLD",8343,"KRN","B",9.2,9.2)

"BLD",8343,"KRN","B",9.8,9.8)

"BLD",8343,"KRN","B",19,19)

"BLD",8343,"KRN","B",19.1,19.1)

"BLD",8343,"KRN","B",101,101)

"BLD",8343,"KRN","B",409.61,409.61)

"BLD",8343,"KRN","B",771,771)

"BLD",8343,"KRN","B",779.2,779.2)

"BLD",8343,"KRN","B",870,870)

"BLD",8343,"KRN","B",8989.51,8989.51)

"BLD",8343,"KRN","B",8989.52,8989.52)

"BLD",8343,"KRN","B",8994,8994)

"BLD",8343,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",8343,"QUES",0)
^9.62^^
"BLD",8343,"REQB",0)
^9.611^1^1
"BLD",8343,"REQB",1,0)
MAG*3.0*162^2
"BLD",8343,"REQB","B","MAG*3.0*162",1)

"FIA",2006.1)
IMAGING SITE PARAMETERS
"FIA",2006.1,0)
^MAG(2006.1,
"FIA",2006.1,0,0)
2006.1P
"FIA",2006.1,0,1)
y^y^p^^^^n^^n
"FIA",2006.1,0,10)

"FIA",2006.1,0,11)

"FIA",2006.1,0,"RLRO")

"FIA",2006.1,0,"VR")
3.0^MAG
"FIA",2006.1,2006.1)
1
"FIA",2006.1,2006.1,75)

"FIA",2006.1,2006.1,76)

"INI")
PRE^MAGIP167
"INIT")
POS^MAGIP167
"MBREQ")
0
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging-V1 to release 
"PKG",454,20,0)
^9.402P^^
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020319^3020517^126
"PKG",454,22,1,"PAH",1,0)
167^3161220^126
"PKG",454,22,1,"PAH",1,1,0)
^^22^22^3161220
"PKG",454,22,1,"PAH",1,1,1,0)
VistA Imaging V3.0 Patch 167 - Display Issues
"PKG",454,22,1,"PAH",1,1,2,0)
 
"PKG",454,22,1,"PAH",1,1,3,0)
This Patch includes a new Clinical Display Client
"PKG",454,22,1,"PAH",1,1,4,0)
Changes in the Clinical Display client will address the
"PKG",454,22,1,"PAH",1,1,5,0)
upgrade to MUSE API 3.
"PKG",454,22,1,"PAH",1,1,6,0)
Also, Clinical Capture users will be able to open images 
"PKG",454,22,1,"PAH",1,1,7,0)
in a seperate window of Clinical Display for Annotation.
"PKG",454,22,1,"PAH",1,1,8,0)
This patch also had fixes from patch 150 for the
"PKG",454,22,1,"PAH",1,1,9,0)
Image Never Existed issue.
"PKG",454,22,1,"PAH",1,1,10,0)
A new option on the Image Delete window will allow
"PKG",454,22,1,"PAH",1,1,11,0)
the user to Copy the Image to the local hard drive
"PKG",454,22,1,"PAH",1,1,12,0)
before deleting.  This will enable the user to 
"PKG",454,22,1,"PAH",1,1,13,0)
import the image to a new Patient or Re-Index the 
"PKG",454,22,1,"PAH",1,1,14,0)
Image without the need to Print and ReScan. 
"PKG",454,22,1,"PAH",1,1,15,0)
  
"PKG",454,22,1,"PAH",1,1,16,0)
This will check the routines from a BUILD file.
"PKG",454,22,1,"PAH",1,1,17,0)
Select BUILD NAME:    MAG*3.0*167     IMAGING
"PKG",454,22,1,"PAH",1,1,18,0)
MAGGTID   value = 85911502
"PKG",454,22,1,"PAH",1,1,19,0)
MAGGTU4D  value = 5313921
"PKG",454,22,1,"PAH",1,1,20,0)
MAGIP167  value = 11436109
"PKG",454,22,1,"PAH",1,1,21,0)
MAGSIXG3  value = 84985360
"PKG",454,22,1,"PAH",1,1,22,0)
done
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","MAGGTID")
0^3^B85911502
"RTN","MAGGTID",1,0)
MAGGTID ;WOIFO/SRR/RED/SAF/GEK/SG/JSL/NST - Deletion of Images and Pointers ;
"RTN","MAGGTID",2,0)
 ;;3.0;IMAGING;**8,59,93,118,150,138,167**;Mar 19, 2002;Build 30;Dec 19, 2016
"RTN","MAGGTID",3,0)
 ;;
"RTN","MAGGTID",4,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGTID",5,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTID",6,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGTID",7,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGTID",8,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGTID",9,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGTID",10,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGTID",11,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGTID",12,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGTID",13,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGTID",14,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGTID",15,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGTID",16,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGTID",17,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTID",18,0)
 ;;
"RTN","MAGGTID",19,0)
 Q
"RTN","MAGGTID",20,0)
 ;
"RTN","MAGGTID",21,0)
IMAGEDEL(MAGGRY,MAGIEN,MAGGRPDF,REASON) ;RPC [MAGG IMAGE DELETE]
"RTN","MAGGTID",22,0)
 ; Call to Delete Image entry from Image file ^MAG(2005
"RTN","MAGGTID",23,0)
 ; MAGIEN   Image IEN ^ SYSDEL flag
"RTN","MAGGTID",24,0)
 ; MAGGRPDF   group delete flag   1 = group delete allowed
"RTN","MAGGTID",25,0)
 ; SYSDEL    Flag that forces delete, even if no KEY
"RTN","MAGGTID",26,0)
 ; 
"RTN","MAGGTID",27,0)
 N IEN,Y,RY
"RTN","MAGGTID",28,0)
 ; 1 in 3rd piece means : DELETE the Image File Also.
"RTN","MAGGTID",29,0)
 S MAGGRPDF=+$G(MAGGRPDF),REASON=$G(REASON),IEN=+MAGIEN
"RTN","MAGGTID",30,0)
 L +^MAG(2005,IEN):4
"RTN","MAGGTID",31,0)
 E  S MAGGRY(0)="Image ID# "_IEN_" is Locked. Delete is Canceled" Q
"RTN","MAGGTID",32,0)
 D DELETE(.MAGGRY,MAGIEN,1,MAGGRPDF,REASON)
"RTN","MAGGTID",33,0)
 L -^MAG(2005,IEN)
"RTN","MAGGTID",34,0)
 Q
"RTN","MAGGTID",35,0)
DELETE(RY,MAGIEN,DF,GRPDF,REASON) ;RPC [MAGQ DIK] Entry point for silent call
"RTN","MAGGTID",36,0)
 ;RY=Return Array RY(0)="1^SUCCESS" 
"RTN","MAGGTID",37,0)
 ;                RY(0)="0^reason for failure"
"RTN","MAGGTID",38,0)
 ;                ;NOT RETURNING LIST AT THIS TIME
"RTN","MAGGTID",39,0)
 ;                ( RY(1)..RY(n)= IEN's of deleted images.)
"RTN","MAGGTID",40,0)
 ;MAGIEN=Image entry number to be deleted
"RTN","MAGGTID",41,0)
 ; if MAGIEN has a 2nd piece = 1 then we force delete, don't test 
"RTN","MAGGTID",42,0)
 ; for MAG DELETE KEY
"RTN","MAGGTID",43,0)
 ; if MAGIEN has a 3rd piece,  it's an Xtra PRocessing Flag ;P150
"RTN","MAGGTID",44,0)
 ; Patch 129 Capture and Patch 135 Import API Now send this flag.  ;P150
"RTN","MAGGTID",45,0)
 ;DF=Delete file flag - 1=delete the Image file
"RTN","MAGGTID",46,0)
 ;                    - 0=don't delete the image file
"RTN","MAGGTID",47,0)
 ;
"RTN","MAGGTID",48,0)
 S REASON=$G(REASON) I REASON="" S REASON="Unknown reason"
"RTN","MAGGTID",49,0)
 S RY(0)="0^Image Delete Failed, reason unknown."
"RTN","MAGGTID",50,0)
 I '$D(MAGSYS) D
"RTN","MAGGTID",51,0)
 . N Y
"RTN","MAGGTID",52,0)
 . D GETENV^%ZOSV  ; IA # 10097 
"RTN","MAGGTID",53,0)
 . S MAGSYS=$P(Y,"^",2)
"RTN","MAGGTID",54,0)
 . Q
"RTN","MAGGTID",55,0)
 N MAGERR,SYSDEL,Z,GRPDEL,MAGACN
"RTN","MAGGTID",56,0)
 N XPRC,NOIMG ; P150
"RTN","MAGGTID",57,0)
 S XPRC=$$UP^XLFSTR($P(MAGIEN,U,3)) ;P150 The new $p(,,3) says there is XtraPRocessing.
"RTN","MAGGTID",58,0)
 S SYSDEL=+$P(MAGIEN,U,2),MAGIEN=+MAGIEN
"RTN","MAGGTID",59,0)
 S NOIMG=$S(XPRC="NOIMAGE":1,1:0) ; P150
"RTN","MAGGTID",60,0)
 I NOIMG D NOIMAGE(MAGIEN) ;P150
"RTN","MAGGTID",61,0)
 ; Check the business rules for deleting an image
"RTN","MAGGTID",62,0)
 I 'NOIMG D DELETE^MAGSIMBR(.RY,MAGIEN,SYSDEL) I +RY(0)=0 Q  ;150 put 'NOIMG
"RTN","MAGGTID",63,0)
 ;  a couple tests of privilege and valid IEN
"RTN","MAGGTID",64,0)
 I '$D(^MAG(2005,MAGIEN,0)) D  Q
"RTN","MAGGTID",65,0)
 . S RY(0)="0^Image entry doesn't exist in image file"
"RTN","MAGGTID",66,0)
 I +$O(^MAG(2005,MAGIEN,1,0)),+$G(GRPDF)=0 D  Q
"RTN","MAGGTID",67,0)
 . S RY(0)="0^Deleting a Group is not allowed."
"RTN","MAGGTID",68,0)
 I +$O(^MAG(2005,MAGIEN,1,0)),+$G(GRPDF)'=0 D  Q
"RTN","MAGGTID",69,0)
 . N MAGGRP S MAGGRP=MAGIEN N MAGIEN,MAGX,MAGOK,MAGFAIL
"RTN","MAGGTID",70,0)
 . S MAGX=0,MAGOK=0,MAGFAIL=0
"RTN","MAGGTID",71,0)
 . S GRPDEL=1  ; we are deleting a group - used in DELGRP entry
"RTN","MAGGTID",72,0)
 . F  S MAGX=$O(^MAG(2005,MAGGRP,1,MAGX)) Q:'MAGX  D
"RTN","MAGGTID",73,0)
 . . S MAGIEN=$P($G(^MAG(2005,MAGGRP,1,MAGX,0)),"^") D DEL1IMG
"RTN","MAGGTID",74,0)
 . . I +RY(0) S Z=+$O(RY(""),-1),RY(Z)=RY(Z)_"^"_RY(0),MAGOK=MAGOK+1
"RTN","MAGGTID",75,0)
 . . E  S Z=+$O(RY(""),-1)+1,RY(Z)=MAGIEN_"^"_RY(0),MAGFAIL=MAGFAIL+1
"RTN","MAGGTID",76,0)
 . . Q
"RTN","MAGGTID",77,0)
 . I +MAGFAIL=0 S RY(0)="1^Deletion of Group #"_MAGGRP_" was successful.^"_MAGOK_"^0"
"RTN","MAGGTID",78,0)
 . E  S RY(0)="0^Error deleting child image(s). Group Not Deleted.^"_MAGOK_"^"_MAGFAIL
"RTN","MAGGTID",79,0)
 . I (+MAGFAIL=0),$G(MAGACN)'="" D  ; No errors and Accession number exists
"RTN","MAGGTID",80,0)
 . . N SSEP,OUT
"RTN","MAGGTID",81,0)
 . . S SSEP=$$STATSEP^MAGVRS41
"RTN","MAGGTID",82,0)
 . . D DELNEW^MAGVD008(.OUT,MAGACN,REASON)  ; Delete studies in P34 data structure by accession number
"RTN","MAGGTID",83,0)
 . . I OUT<0 S RY(0)="0^Deletion of Group #"_MAGGRP_" was successful but failed in New: "_$P(OUT,SSEP,2)
"RTN","MAGGTID",84,0)
 . . Q
"RTN","MAGGTID",85,0)
 . Q
"RTN","MAGGTID",86,0)
 ; Ok lets start
"RTN","MAGGTID",87,0)
 ; lets delete the parent pointers first.
"RTN","MAGGTID",88,0)
DEL1IMG ;
"RTN","MAGGTID",89,0)
 N DELMSG,Z,MAGDFN
"RTN","MAGGTID",90,0)
 D DELPAR^MAGSDEL2
"RTN","MAGGTID",91,0)
 I $G(MAGERR) S RY(0)="0^Error: Deleting Specialty Pointers. Image Not Deleted. "_DELMSG Q
"RTN","MAGGTID",92,0)
 ;
"RTN","MAGGTID",93,0)
 ; Now delete image record & xref's
"RTN","MAGGTID",94,0)
 ; if this Image is member of group DELGRP will delete those pointers
"RTN","MAGGTID",95,0)
 ; and delete the Group, if this is only image in it.
"RTN","MAGGTID",96,0)
 S MAGDFN=$P($G(^MAG(2005,MAGIEN,0)),"^",7) ; Moved here from below. DELGRP needs MAGDFN now.
"RTN","MAGGTID",97,0)
 D DELGRP
"RTN","MAGGTID",98,0)
 I $G(MAGERR) S RY(0)="0^Error deleting Group Pointers." Q
"RTN","MAGGTID",99,0)
 ;
"RTN","MAGGTID",100,0)
 ; write the deleted by, delete reason, and delete date to the file.
"RTN","MAGGTID",101,0)
 ; P150   If NOIMAGE,  SetDel was already called.
"RTN","MAGGTID",102,0)
 I 'NOIMG D SETDEL(MAGIEN,REASON) ;P150 NOIMG
"RTN","MAGGTID",103,0)
 ;
"RTN","MAGGTID",104,0)
 ; save the Image record to the archive before we delete it.
"RTN","MAGGTID",105,0)
 D ARCHIVE(MAGIEN)
"RTN","MAGGTID",106,0)
 ;
"RTN","MAGGTID",107,0)
 ; Now let's set the Queue to delete the Image File, if Flag is set
"RTN","MAGGTID",108,0)
 I $G(DF) D DELFILE
"RTN","MAGGTID",109,0)
 ; 
"RTN","MAGGTID",110,0)
 ; we're having "APPXDT" crossref left around, lets delete it first.
"RTN","MAGGTID",111,0)
 S X=MAGDFN,DA=MAGIEN D KILPPXD^MAGUXRF
"RTN","MAGGTID",112,0)
 ;
"RTN","MAGGTID",113,0)
 ; now lets delete the image.
"RTN","MAGGTID",114,0)
 K DIK,DA,DA(1),DA(2),DIC,DR,DIE,DIR S DIK="^MAG(2005,",DA=MAGIEN
"RTN","MAGGTID",115,0)
 D ^DIK
"RTN","MAGGTID",116,0)
 S Z=+$O(RY(""),-1)+1,RY(Z)=MAGIEN
"RTN","MAGGTID",117,0)
 ; we were having problems with "AC" so lets check to make sure.
"RTN","MAGGTID",118,0)
 I $D(^MAG(2005,"AC",MAGDFN,MAGIEN)) K ^MAG(2005,"AC",MAGDFN,MAGIEN)
"RTN","MAGGTID",119,0)
 ; log it.
"RTN","MAGGTID",120,0)
 S X=$S(NOIMG:"NOIMAGE",1:"DELETE") ; P150 NOIMG
"RTN","MAGGTID",121,0)
 D ENTRY^MAGLOG(X,$G(DUZ),$G(MAGIEN),"PARENT:"_$G(MAGSTORE),$G(MAGDFN),1) ;P150
"RTN","MAGGTID",122,0)
 S X=$S(NOIMG:"NOIMAGE^",1:"DEL^") ; 150 NOIMG
"RTN","MAGGTID",123,0)
 S X=X_$G(MAGDFN)_"^"_$G(MAGIEN) ; 150 use X instead of "DEL^"
"RTN","MAGGTID",124,0)
 D ACTION^MAGGTAU(X,"1")
"RTN","MAGGTID",125,0)
 ; The 140 cross reference of 2005.1 has set the Status to 12,  here we change it to 13 ;P150
"RTN","MAGGTID",126,0)
 I NOIMG D SETSTAT(MAGIEN,13) ;P150
"RTN","MAGGTID",127,0)
 S RY(0)="1^Deletion of Image was Successful." ;P150 
"RTN","MAGGTID",128,0)
 ; P150 Put above line back in.  Code below is new for 118.
"RTN","MAGGTID",129,0)
 I '$G(GRPDEL),$G(MAGACN)'="" D  ; If we delete a single image in a group and ACN is defined
"RTN","MAGGTID",130,0)
 . N SSEP,OUT
"RTN","MAGGTID",131,0)
 . S SSEP=$$STATSEP^MAGVRS41
"RTN","MAGGTID",132,0)
 . D DELNEW^MAGVD008(.OUT,MAGACN,REASON)  ; Delete studies in P34 data structure by accession number
"RTN","MAGGTID",133,0)
 . I OUT<0 S RY(0)="0^Deletion of Image in Legacy was Successful but failed in New: "_$P(OUT,SSEP,2)
"RTN","MAGGTID",134,0)
 . E  S RY(0)="1^Deletion of Image was Successful."
"RTN","MAGGTID",135,0)
 . Q
"RTN","MAGGTID",136,0)
 Q
"RTN","MAGGTID",137,0)
NOIMAGE(MAGNOT) ; P150 Whole function is new. This is called when No Image exists.
"RTN","MAGGTID",138,0)
 ; Clear the Fields #2,  #2.1 and 102 This is the Abstract, Full and BIG
"RTN","MAGGTID",139,0)
 ;   pointers to the Image Share (Image Network Drive) ( Tier1 ) 
"RTN","MAGGTID",140,0)
 ; Set Status and Status Reason
"RTN","MAGGTID",141,0)
 ; Set SysDel and GrpDel Flags to allow deleting in all instances.
"RTN","MAGGTID",142,0)
 N MAGNFDA,MAGGXE,MAGERR,REASDESC,REASDA,MAGDA
"RTN","MAGGTID",143,0)
 S REASDESC="Image Never Existed"
"RTN","MAGGTID",144,0)
 S REASDA=$O(^MAG(2005.88,"B",REASDESC,""))
"RTN","MAGGTID",145,0)
 D SETDEL(MAGNOT,REASDESC) ; Set the Delete Fields. 
"RTN","MAGGTID",146,0)
 ;
"RTN","MAGGTID",147,0)
 S MAGDA=MAGNOT
"RTN","MAGGTID",148,0)
 S MAGNOT=MAGNOT_","
"RTN","MAGGTID",149,0)
 S MAGNFDA(2005,MAGNOT,2)="@" ;
"RTN","MAGGTID",150,0)
 S MAGNFDA(2005,MAGNOT,2.1)="@"
"RTN","MAGGTID",151,0)
 S MAGNFDA(2005,MAGNOT,102)="@"
"RTN","MAGGTID",152,0)
 S MAGNFDA(2005,MAGNOT,113)=13
"RTN","MAGGTID",153,0)
 S MAGNFDA(2005,MAGNOT,113.3)=REASDA
"RTN","MAGGTID",154,0)
 ;;;;;;;
"RTN","MAGGTID",155,0)
 D UPDATE^DIE("","MAGNFDA","","MAGGXE")
"RTN","MAGGTID",156,0)
 ;  ? ? If Error during UPdate..  Delete the entry.
"RTN","MAGGTID",157,0)
 I $D(DIERR) D  S RY=MAGERR Q
"RTN","MAGGTID",158,0)
 . D RTRNERR(.MAGERR)
"RTN","MAGGTID",159,0)
 . S DA=MAGDA,DIK="^MAG(2005," D ^DIK
"RTN","MAGGTID",160,0)
 . K DA,DIC,DIK
"RTN","MAGGTID",161,0)
 . D CLEAN^DILF
"RTN","MAGGTID",162,0)
 Q
"RTN","MAGGTID",163,0)
RTRNERR(ETXT) ; There was error from UPDATE^DIE quit with error text
"RTN","MAGGTID",164,0)
 ; P150 this function put in to keep NOIMAGE same
"RTN","MAGGTID",165,0)
 S ETXT="0^ERROR  "_MAGGXE("DIERR",1,"TEXT",1)
"RTN","MAGGTID",166,0)
 Q
"RTN","MAGGTID",167,0)
DELGRP ;del grp ptrs and check to see if this is the last image in the group
"RTN","MAGGTID",168,0)
 N MAGGRP,MAGX,MAGQUIT,MAGIFNS,Z
"RTN","MAGGTID",169,0)
 S MAGGRP=$P($G(^MAG(2005,MAGIEN,0)),"^",10)
"RTN","MAGGTID",170,0)
 Q:'$G(MAGGRP)
"RTN","MAGGTID",171,0)
 K DIK,DA,DA(1),DA(2),DIC,DR,DIE,DIR
"RTN","MAGGTID",172,0)
 S MAGX=0,MAGQUIT=0
"RTN","MAGGTID",173,0)
 F  S MAGX=$O(^MAG(2005,MAGGRP,1,MAGX)) Q:'MAGX  D  Q:MAGQUIT
"RTN","MAGGTID",174,0)
 . I +^MAG(2005,MAGGRP,1,MAGX,0)=MAGIEN D
"RTN","MAGGTID",175,0)
 . . S DIK="^MAG(2005,MAGGRP,1,",DA(1)=MAGGRP,DA=MAGX D ^DIK S MAGQUIT=1
"RTN","MAGGTID",176,0)
 . . ;added DA(1) needed for xref deletion of dicom series 
"RTN","MAGGTID",177,0)
 . I $O(^MAG(2005,MAGGRP,1,0))="" D
"RTN","MAGGTID",178,0)
 . . I $P($G(^MAG(2005,MAGGRP,2)),"^",6) D
"RTN","MAGGTID",179,0)
 . . . ;report is on group - need to delete it
"RTN","MAGGTID",180,0)
 . . . S MAGIFNS=MAGIEN,MAGIEN=MAGGRP
"RTN","MAGGTID",181,0)
 . . . D DELPAR^MAGSDEL2
"RTN","MAGGTID",182,0)
 . . . S MAGIEN=MAGIFNS
"RTN","MAGGTID",183,0)
 . . I '$D(MAGERR) D
"RTN","MAGGTID",184,0)
 . . . I $T(^MAGVD003)'="" D  ; This check needs to be removed after release of patch 118
"RTN","MAGGTID",185,0)
 . . . . N OUT
"RTN","MAGGTID",186,0)
 . . . . D GETACN^MAGVD003(.OUT,MAGGRP)  ; Get accession number for this group first
"RTN","MAGGTID",187,0)
 . . . . S MAGACN=$S($$ISOK^MAGVAF02(OUT):$$GETVAL^MAGVAF02(OUT),1:"")
"RTN","MAGGTID",188,0)
 . . . . Q
"RTN","MAGGTID",189,0)
 . . . D SETDEL(MAGGRP,REASON),ARCHIVE(MAGGRP) S DIK="^MAG(2005,",DA=MAGGRP D ^DIK
"RTN","MAGGTID",190,0)
 . . . ; Log the Deletion of The Group Header to  ^MAG(2006.95, and ^MAG(2006.82 
"RTN","MAGGTID",191,0)
 . . . D ENTRY^MAGLOG("DELETE",$G(DUZ),$G(MAGGRP),"PARENT:"_$G(MAGSTORE),$G(MAGDFN),1,"Group Header deleted")
"RTN","MAGGTID",192,0)
 . . . S X="DEL^"_$G(MAGDFN)_"^"_$G(MAGGRP)
"RTN","MAGGTID",193,0)
 . . . D ACTION^MAGGTAU(X,"1")
"RTN","MAGGTID",194,0)
 . . . S Z=+$O(RY(""),-1)+1,RY(Z)=MAGGRP_"^1^Deletion of Group was Successful."
"RTN","MAGGTID",195,0)
 . . . Q
"RTN","MAGGTID",196,0)
 . . Q
"RTN","MAGGTID",197,0)
 . Q
"RTN","MAGGTID",198,0)
 Q
"RTN","MAGGTID",199,0)
SETDEL(MAGIEN,REASON) ; set deletion fields
"RTN","MAGGTID",200,0)
 N DA,DR,DIE,X
"RTN","MAGGTID",201,0)
 ;N %H
"RTN","MAGGTID",202,0)
 ;S %H=$H D YMD^%DTC
"RTN","MAGGTID",203,0)
 S X=$$NOW^XLFDT
"RTN","MAGGTID",204,0)
 ;  gek - changed 3 slash to 4 slash. to stop FM question marks. ??
"RTN","MAGGTID",205,0)
 S DR="30////"_DUZ_";30.1////"_X_";30.2////"_REASON
"RTN","MAGGTID",206,0)
 S DIE="2005",DA=MAGIEN D ^DIE
"RTN","MAGGTID",207,0)
 Q
"RTN","MAGGTID",208,0)
 ;
"RTN","MAGGTID",209,0)
SETSTAT(MAGIEN,STAT) ; p150 new function.  Set STATUS fields
"RTN","MAGGTID",210,0)
 N DA,DR,DIE
"RTN","MAGGTID",211,0)
 ; 4 slash. to stop FM question marks. ??
"RTN","MAGGTID",212,0)
 S DR="113////"_STAT
"RTN","MAGGTID",213,0)
 S DIE="2005.1",DA=MAGIEN D ^DIE
"RTN","MAGGTID",214,0)
 Q
"RTN","MAGGTID",215,0)
ARCHIVE(MAGARCIE) ;save image data before deletion
"RTN","MAGGTID",216,0)
 N DA,DIK,MAGCNT,MAGLAST,SUB,TMP,%X,%Y
"RTN","MAGGTID",217,0)
 S MAGCNT=$P(^MAG(2005.1,0),U,4)+1
"RTN","MAGGTID",218,0)
 S %X="^MAG(2005,"_MAGARCIE_",",%Y="^MAG(2005.1,"_MAGARCIE_","
"RTN","MAGGTID",219,0)
 D %XY^%RCR
"RTN","MAGGTID",220,0)
 ;--- GEK 9/29/00 Fix the 3rd piece to be last IEN in file.
"RTN","MAGGTID",221,0)
 S MAGLAST=$O(^MAG(2005.1,"A"),-1)
"RTN","MAGGTID",222,0)
 S $P(^MAG(2005.1,0),U,4)=MAGCNT
"RTN","MAGGTID",223,0)
 I '($P(^MAG(2005.1,0),U,3)=MAGLAST) S $P(^MAG(2005.1,0),U,3)=MAGLAST
"RTN","MAGGTID",224,0)
 ;
"RTN","MAGGTID",225,0)
 ;--- Fix subfile numbers in the headers of the multiples (MAG*3*93).
"RTN","MAGGTID",226,0)
 ;    IF DEFINITIONS OF MULTIPLES OF THE IMAGE AUDIT FILE (#2005.1)
"RTN","MAGGTID",227,0)
 ;    CHANGE OR NEW MULTIPLES ARE ADDED, THE FOLLOWING CODE MUST BE
"RTN","MAGGTID",228,0)
 ;--- CHECKED AND UPDATED IF NECESSARY!
"RTN","MAGGTID",229,0)
 ;
"RTN","MAGGTID",230,0)
 F SUB="1^2005.14P","4^2005.1106DA","5^2005.11PA","6^2005.1111A","99^2005.199D"  D
"RTN","MAGGTID",231,0)
 . S TMP=$P(SUB,U)  Q:'($D(^MAG(2005.1,MAGARCIE,TMP,0))#2)
"RTN","MAGGTID",232,0)
 . S $P(^MAG(2005.1,MAGARCIE,TMP,0),U,2)=$P(SUB,U,2)
"RTN","MAGGTID",233,0)
 . Q
"RTN","MAGGTID",234,0)
 ;
"RTN","MAGGTID",235,0)
 ;--- Create cross-reference entries for the entry
"RTN","MAGGTID",236,0)
 S DA=MAGARCIE
"RTN","MAGGTID",237,0)
 S DIK="^MAG(2005.1," D IX1^DIK
"RTN","MAGGTID",238,0)
 Q
"RTN","MAGGTID",239,0)
DELFILE ;Delete image file on server if exists 
"RTN","MAGGTID",240,0)
 ;gek 3/21/2003  Changed to stop using FullRes Path for Abs,Big
"RTN","MAGGTID",241,0)
 ;   and only Delete .TXT and Alternates if Full is being deleted.
"RTN","MAGGTID",242,0)
 N X0,X1,X2,ALTEXT,ALTPATH,MAGXX,XBIG,MAGFILE2
"RTN","MAGGTID",243,0)
 N MAGPLC ; DBI - SEB 9/20/2002
"RTN","MAGGTID",244,0)
 ; MAGIEN IS ASSUMED TO BE DEFINED.
"RTN","MAGGTID",245,0)
 ; MAGXX         - This is IEN in ^MAG(2005, MAGFILEB Expects this to be defined.
"RTN","MAGGTID",246,0)
 ; MAGPLC        - "Place" of Full Res Image.  
"RTN","MAGGTID",247,0)
 ; ALTEXT        - Extension of the Alternate image file.
"RTN","MAGGTID",248,0)
 ; ALTPATH       - Full path of Alternate image file.
"RTN","MAGGTID",249,0)
 S X0=^MAG(2005,MAGIEN,0)
"RTN","MAGGTID",250,0)
 ;delete Full Res if one exists on Magnetic
"RTN","MAGGTID",251,0)
 I $P(X0,U,3) D
"RTN","MAGGTID",252,0)
 . S MAGXX=MAGIEN
"RTN","MAGGTID",253,0)
 . S MAGPLC=$$DA2PLC^MAGBAPIP(MAGIEN,"F")
"RTN","MAGGTID",254,0)
 . D VSTNOCP^MAGFILEB
"RTN","MAGGTID",255,0)
 . S X=$$DELETE^MAGBAPI(MAGFILE2,MAGPLC)
"RTN","MAGGTID",256,0)
 . ;Delete any other ALTernate files. ( TXT) 
"RTN","MAGGTID",257,0)
 . ;gek 3/31/03  Since ALT files are (for now) always on same server as Full
"RTN","MAGGTID",258,0)
 . ;    We only attempt to delete them here  (If we have a path to FullRes on Magnetic)
"RTN","MAGGTID",259,0)
 . S X2=0
"RTN","MAGGTID",260,0)
 . F  S X2=$O(^MAG(2006.1,MAGPLC,2,X2)) Q:'X2  D
"RTN","MAGGTID",261,0)
 . . S ALTEXT=$P(^MAG(2006.1,MAGPLC,2,X2,0),"^",1)             ;CR1023
"RTN","MAGGTID",262,0)
 . . S ALTPATH=MAGFILE2,$P(ALTPATH,".",$L(ALTPATH,"."))=ALTEXT ;CR1023 for FQDN issue
"RTN","MAGGTID",263,0)
 . . S X=$$DELETE^MAGBAPI(ALTPATH,MAGPLC)
"RTN","MAGGTID",264,0)
 . Q
"RTN","MAGGTID",265,0)
 ;
"RTN","MAGGTID",266,0)
 ;delete image abstract if one exists on Magnetic
"RTN","MAGGTID",267,0)
 I $P(X0,U,4) D
"RTN","MAGGTID",268,0)
 . S MAGXX=MAGIEN
"RTN","MAGGTID",269,0)
 . D ABSNOCP^MAGFILEB
"RTN","MAGGTID",270,0)
 . S X=$$DELETE^MAGBAPI(MAGFILE2,$$DA2PLC^MAGBAPIP(MAGIEN,"A")) ; DBI - SEB 9/20/2002
"RTN","MAGGTID",271,0)
 ;
"RTN","MAGGTID",272,0)
 ;delete the big file if one exists on Magnetic
"RTN","MAGGTID",273,0)
 S XBIG=$G(^MAG(2005,MAGIEN,"FBIG"))
"RTN","MAGGTID",274,0)
 I $P(XBIG,U) D 
"RTN","MAGGTID",275,0)
 . S MAGXX=MAGIEN
"RTN","MAGGTID",276,0)
 . D BIGNOCP^MAGFILEB
"RTN","MAGGTID",277,0)
 . S X=$$DELETE^MAGBAPI(MAGFILE2,$$DA2PLC^MAGBAPIP(MAGIEN,"B")) ; DBI - SEB 9/20/2002
"RTN","MAGGTID",278,0)
 Q
"RTN","MAGGTU4D")
0^1^B5313965
"RTN","MAGGTU4D",1,0)
MAGGTU4D ;WOIFO/SG/NST/JSL/GEK - VERSION CONTROL (CLINICAL DISPLAY) ; 25 May 2014  2:24 PM
"RTN","MAGGTU4D",2,0)
 ;;3.0;IMAGING;**93,94,106,117,122,131,149,138,156,161,167**;Mar 19, 2002;Build 30;Dec 19, 2016
"RTN","MAGGTU4D",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGTU4D",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTU4D",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGTU4D",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGTU4D",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGTU4D",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGTU4D",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGTU4D",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGTU4D",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGTU4D",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGTU4D",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGTU4D",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGTU4D",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGTU4D",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTU4D",17,0)
 ;;
"RTN","MAGGTU4D",18,0)
 ; This routine contains the version control code and data specific
"RTN","MAGGTU4D",19,0)
 ; to the Clinical Display application. DO NOT ADD ANYTHING ELSE!
"RTN","MAGGTU4D",20,0)
 Q
"RTN","MAGGTU4D",21,0)
 ;
"RTN","MAGGTU4D",22,0)
CLVERCT ;***** VERSION CONTROL TABLE FOR THE CLINICAL DISPLAY CLIENTS
"RTN","MAGGTU4D",23,0)
 ;;==================================================================
"RTN","MAGGTU4D",24,0)
 ;;| Version |Build|Seq #|                Comment                   |
"RTN","MAGGTU4D",25,0)
 ;;|---------+-----+------------------------------------------------|
"RTN","MAGGTU4D",26,0)
 ;;| 3.0.167 |   8 |  86 | Jan 2017                                 |
"RTN","MAGGTU4D",27,0)
 ;;| 3.0.161 |   2 |  85 | May 2015                                 |
"RTN","MAGGTU4D",28,0)
 ;;| 3.0.149 |   4 |  75 | Sep 2014                                 |
"RTN","MAGGTU4D",29,0)
 ;;| 3.0.130 |  18 |  70 | Aug 2013                                 |
"RTN","MAGGTU4D",30,0)
 ;;| 3.0.131 |  21 |  65 | Aug 2013                                 |
"RTN","MAGGTU4D",31,0)
 ;;==================================================================
"RTN","MAGGTU4D",32,0)
 ;
"RTN","MAGGTU4D",33,0)
 ; Each row of the version control table contains the version and
"RTN","MAGGTU4D",34,0)
 ; build number of a supported client. Released patches must also
"RTN","MAGGTU4D",35,0)
 ; indicate the sequential numbers.
"RTN","MAGGTU4D",36,0)
 ;
"RTN","MAGGTU4D",37,0)
 ; Sort order of the rows does not matter. However, the reversed
"RTN","MAGGTU4D",38,0)
 ; order of patch sequential numbers is recommended.
"RTN","MAGGTU4D",39,0)
 ; NOTE:  Patch 149 removed support for 
"RTN","MAGGTU4D",40,0)
 ;        - Patch  94
"RTN","MAGGTU4D",41,0)
 ;        - Patch 106
"RTN","MAGGTU4D",42,0)
 ;        - Patch 117
"RTN","MAGGTU4D",43,0)
 ;        Patch 167 removed support for
"RTN","MAGGTU4D",44,0)
 ;        - Patch 122
"RTN","MAGGTU4D",45,0)
 Q
"RTN","MAGGTU4D",46,0)
 ;
"RTN","MAGGTU4D",47,0)
 ;***** ADDS A CLIENT-SPECIFIC WARNING (IF NECESSARY)
"RTN","MAGGTU4D",48,0)
 ;
"RTN","MAGGTU4D",49,0)
 ; .MAGBUF       Reference to a local array that the warning text
"RTN","MAGGTU4D",50,0)
 ;               is returned to. It is appended to the RPC result
"RTN","MAGGTU4D",51,0)
 ;               array by the caller (WARNING^MAGGTU41).
"RTN","MAGGTU4D",52,0)
 ;
"RTN","MAGGTU4D",53,0)
 ;               Text must be stored at nodes with positive numbers
"RTN","MAGGTU4D",54,0)
 ;               or at the 0-node descendent from those nodes.
"RTN","MAGGTU4D",55,0)
 ;
"RTN","MAGGTU4D",56,0)
 ; CLVER         Client application version (Major.Minor.Patch.Build)
"RTN","MAGGTU4D",57,0)
 ;
"RTN","MAGGTU4D",58,0)
 ; CVRC          Version check code returned by the $$CHKVER1^MAGGTU41
"RTN","MAGGTU4D",59,0)
 ;
"RTN","MAGGTU4D",60,0)
 ; Notes
"RTN","MAGGTU4D",61,0)
 ; =====
"RTN","MAGGTU4D",62,0)
 ;
"RTN","MAGGTU4D",63,0)
 ; If the RPC result array already contains an error message that
"RTN","MAGGTU4D",64,0)
 ; will terminate the client, application, this procedure is not
"RTN","MAGGTU4D",65,0)
 ; called.
"RTN","MAGGTU4D",66,0)
 ;
"RTN","MAGGTU4D",67,0)
WARNING(MAGBUF,CLVER,CVRC) ;
"RTN","MAGGTU4D",68,0)
 Q
"RTN","MAGIP167")
0^2^B11436109
"RTN","MAGIP167",1,0)
MAGIP167 ;WOIFO/GEK - INSTALL CODE FOR MAG*3.0*167 - MUSE API3 ;
"RTN","MAGIP167",2,0)
 ;;3.0;IMAGING;**167**;Mar 19, 2002;Build 30;Dec 19, 2016
"RTN","MAGIP167",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIP167",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP167",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIP167",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIP167",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIP167",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIP167",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIP167",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIP167",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIP167",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIP167",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIP167",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIP167",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIP167",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP167",17,0)
 ;;
"RTN","MAGIP167",18,0)
 ; There are no environment checks here but the MAGIP167 has to be
"RTN","MAGIP167",19,0)
 ; referenced by the "Environment Check Routine" field of the KIDS
"RTN","MAGIP167",20,0)
 ; build so that entry points of the routine are available to the
"RTN","MAGIP167",21,0)
 ; KIDS during all installation phases.
"RTN","MAGIP167",22,0)
 ;
"RTN","MAGIP167",23,0)
 Q
"RTN","MAGIP167",24,0)
 ;
"RTN","MAGIP167",25,0)
 ;+++++ INSTALLATION ERROR HANDLING
"RTN","MAGIP167",26,0)
ERROR ;
"RTN","MAGIP167",27,0)
 S:$D(XPDNM) XPDABORT=1
"RTN","MAGIP167",28,0)
 ;--- Display the messages and store them to the INSTALL file
"RTN","MAGIP167",29,0)
 D DUMP^MAGUERR1(),ABTMSG^MAGKIDS()
"RTN","MAGIP167",30,0)
 Q
"RTN","MAGIP167",31,0)
 ;
"RTN","MAGIP167",32,0)
 ;***** POST-INSTALL CODE
"RTN","MAGIP167",33,0)
POS ;
"RTN","MAGIP167",34,0)
 N CALLBACK
"RTN","MAGIP167",35,0)
 D CLEAR^MAGUERR(1)
"RTN","MAGIP167",36,0)
 ;
"RTN","MAGIP167",37,0)
 ;--- Link new remote procedures to the Broker context option
"RTN","MAGIP167",38,0)
 ;*** None for 167 **
"RTN","MAGIP167",39,0)
 ;S CALLBACK="$$ADDRPCS^"_$NA(MAGKIDS1("RPCLST^"_$T(+0),"MAG WINDOWS"))
"RTN","MAGIP167",40,0)
 ;I $$CP^MAGKIDS("MAG ATTACH RPCS",CALLBACK)<0  D ERROR  Q
"RTN","MAGIP167",41,0)
 ;
"RTN","MAGIP167",42,0)
 ;
"RTN","MAGIP167",43,0)
 ;--- Misc Updates
"RTN","MAGIP167",44,0)
 ;*** None for 167 **
"RTN","MAGIP167",45,0)
 ;I $$CP^MAGKIDS("MAG 167 MISC UPDATES ","$$UPDATE^"_$T(+0))<0 D ERROR Q
"RTN","MAGIP167",46,0)
 ;
"RTN","MAGIP167",47,0)
 ;--- Add Display and Capture User Manual url's to the IMAGING SITE PARAMETERS File.
"RTN","MAGIP167",48,0)
 ;       #(2006.1)   Different URL's depending on VA or IHS.
"RTN","MAGIP167",49,0)
 ;
"RTN","MAGIP167",50,0)
 I $$ISIHS^MAGSPID() D  ; THIS IS IHS SITE.
"RTN","MAGIP167",51,0)
 . S HUD="https://www.ihs.gov/vistaimaging/includes/themes/newihstheme/display_objects/documents/VI_Clinical_Display_User_Manual.pdf"
"RTN","MAGIP167",52,0)
 . S HUC="https://www.ihs.gov/vistaimaging/includes/themes/newihstheme/display_objects/documents/VI_Clinical_Capture_User_Manual.pdf"
"RTN","MAGIP167",53,0)
 . Q
"RTN","MAGIP167",54,0)
 E  D  ; THIS IS VA SITE.
"RTN","MAGIP167",55,0)
 . S HUD="http://vaww.oed.portal.domain.ext/applications/VistAImaging/VistA%20Enterprise%20Documents/User%20Manuals/MAG_Display_User_Manual.pdf"
"RTN","MAGIP167",56,0)
 . S HUC="http://vaww.oed.portal.domain.ext/applications/VistAImaging/VistA%20Enterprise%20Documents/User%20Manuals/MAG_Capture_User_Manual.pdf"
"RTN","MAGIP167",57,0)
 . Q
"RTN","MAGIP167",58,0)
 S I=0 
"RTN","MAGIP167",59,0)
 F  S I=$O(^MAG(2006.1,I)) Q:'I  D  ;
"RTN","MAGIP167",60,0)
 . S ^MAG(2006.1,I,"HELPD")=HUD
"RTN","MAGIP167",61,0)
 . S ^MAG(2006.1,I,"HELPC")=HUC
"RTN","MAGIP167",62,0)
 . Q 
"RTN","MAGIP167",63,0)
 ;--- Send the notification e-mail
"RTN","MAGIP167",64,0)
 D BMES^XPDUTL("Post Install Mail Message: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","MAGIP167",65,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGIP167",66,0)
 ;
"RTN","MAGIP167",67,0)
 Q
"RTN","MAGIP167",68,0)
 ;
"RTN","MAGIP167",69,0)
 ;***** PRE-INSTALL CODE
"RTN","MAGIP167",70,0)
PRE ;
"RTN","MAGIP167",71,0)
 ;
"RTN","MAGIP167",72,0)
 Q
"RTN","MAGSIXG3")
0^4^B84985360
"RTN","MAGSIXG3",1,0)
MAGSIXG3 ;WOIFO/SG/NST - LIST OF IMAGES RPCS (CALLBACK) ;
"RTN","MAGSIXG3",2,0)
 ;;3.0;IMAGING;**93,117,150,138,167**;Mar 19, 2002;Build 30;Dec 19, 2016
"RTN","MAGSIXG3",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGSIXG3",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGSIXG3",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGSIXG3",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGSIXG3",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGSIXG3",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGSIXG3",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGSIXG3",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGSIXG3",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGSIXG3",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGSIXG3",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGSIXG3",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGSIXG3",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGSIXG3",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGSIXG3",17,0)
 ;;
"RTN","MAGSIXG3",18,0)
 ;
"RTN","MAGSIXG3",19,0)
 ; This routine uses the following ICRs:
"RTN","MAGSIXG3",20,0)
 ;
"RTN","MAGSIXG3",21,0)
 ; #3268         Read file #8925 (controlled)
"RTN","MAGSIXG3",22,0)
 ; #10060        Read file #200 (supported)
"RTN","MAGSIXG3",23,0)
 ; #2321         Read file #8925.1 (controlled)
"RTN","MAGSIXG3",24,0)
 ; #2937         Read file #8925 (controlled)
"RTN","MAGSIXG3",25,0)
 ;
"RTN","MAGSIXG3",26,0)
 ; LOCAL VARIABLE ------ DESCRIPTION
"RTN","MAGSIXG3",27,0)
 ;
"RTN","MAGSIXG3",28,0)
 ; MAGDATA               See the ^MAGSIXG4.
"RTN","MAGSIXG3",29,0)
 ;
"RTN","MAGSIXG3",30,0)
 ; TEMPORARY GLOBAL ---- DESCRIPTION
"RTN","MAGSIXG3",31,0)
 ;
"RTN","MAGSIXG3",32,0)
 ; ^TMP("MAGSIXG3",$J)   See the ^MAGSIXG4.
"RTN","MAGSIXG3",33,0)
 ;
"RTN","MAGSIXG3",34,0)
 Q
"RTN","MAGSIXG3",35,0)
 ;
"RTN","MAGSIXG3",36,0)
 ;+++++ APPENDS THE IMAGE ENTRY TO THE RPC RESULT ARRAY
"RTN","MAGSIXG3",37,0)
 ;
"RTN","MAGSIXG3",38,0)
 ; IMGIEN        IEN of the image record in file #2005 or #2005.1
"RTN","MAGSIXG3",39,0)
 ;
"RTN","MAGSIXG3",40,0)
 ; DATA          First half ("|"-piece) of the result item
"RTN","MAGSIXG3",41,0)
 ;
"RTN","MAGSIXG3",42,0)
 ; GRPCNTS       Group counts (result of the $$GRPCT^MAGGI14)
"RTN","MAGSIXG3",43,0)
 ;
"RTN","MAGSIXG3",44,0)
 ; FLAGS         Control flags for the $$INFO^MAGGAII
"RTN","MAGSIXG3",45,0)
 ;
"RTN","MAGSIXG3",46,0)
 ; Input Variables
"RTN","MAGSIXG3",47,0)
 ; ===============
"RTN","MAGSIXG3",48,0)
 ;   MAGDATA
"RTN","MAGSIXG3",49,0)
 ;
"RTN","MAGSIXG3",50,0)
 ; Output Variables
"RTN","MAGSIXG3",51,0)
 ; ================
"RTN","MAGSIXG3",52,0)
 ;   MAGDATA, MAGOUT
"RTN","MAGSIXG3",53,0)
 ;
"RTN","MAGSIXG3",54,0)
 ; Return Values
"RTN","MAGSIXG3",55,0)
 ; =============
"RTN","MAGSIXG3",56,0)
 ;           <0  Error descriptor (see the $$ERROR^MAGUERR)
"RTN","MAGSIXG3",57,0)
 ;            0  Success
"RTN","MAGSIXG3",58,0)
 ;
"RTN","MAGSIXG3",59,0)
APPEND(IMGIEN,DATA,GRPCNTS,FLAGS) ;
"RTN","MAGSIXG3",60,0)
 N IMGINFO,X
"RTN","MAGSIXG3",61,0)
 ;
"RTN","MAGSIXG3",62,0)
 ;--- Get the internal image data
"RTN","MAGSIXG3",63,0)
 S IMGINFO=$$INFO^MAGGAII(IMGIEN,FLAGS,GRPCNTS)
"RTN","MAGSIXG3",64,0)
 Q:IMGINFO<0 IMGINFO
"RTN","MAGSIXG3",65,0)
 S $P(DATA,U,2)=$P(IMGINFO,U,16)  ; Site Code
"RTN","MAGSIXG3",66,0)
 S $P(DATA,U,6)=$P(IMGINFO,U,14)  ; Number of images in the group
"RTN","MAGSIXG3",67,0)
 S $P(DATA,U,16)=$P(IMGINFO,U)    ; Image ID (IEN)
"RTN","MAGSIXG3",68,0)
 ;
"RTN","MAGSIXG3",69,0)
 ;--- Append the image data to the result array
"RTN","MAGSIXG3",70,0)
 S MAGDATA("RESCNT")=$G(MAGDATA("RESCNT"))+1
"RTN","MAGSIXG3",71,0)
 S $P(DATA,U)=MAGDATA("RESCNT")
"RTN","MAGSIXG3",72,0)
 S @MAGDATA@(MAGDATA("RESCNT")+1)=DATA_U_"|"_IMGINFO
"RTN","MAGSIXG3",73,0)
 Q:MAGDATA("RESCNT")<76 0  Q:MAGDATA["^" 0
"RTN","MAGSIXG3",74,0)
 ;
"RTN","MAGSIXG3",75,0)
 ;--- Image count is getting big, switch from
"RTN","MAGSIXG3",76,0)
 ;--- a local array to a global node
"RTN","MAGSIXG3",77,0)
 S MAGDATA=$NA(^TMP("MAGSIXG1",$J))
"RTN","MAGSIXG3",78,0)
 K @MAGDATA  M @MAGDATA=MAGOUT
"RTN","MAGSIXG3",79,0)
 S X=$$RTRNFMT^XWBLIB("GLOBAL ARRAY",1)
"RTN","MAGSIXG3",80,0)
 K MAGOUT  S MAGOUT=MAGDATA
"RTN","MAGSIXG3",81,0)
 Q 0
"RTN","MAGSIXG3",82,0)
 ;
"RTN","MAGSIXG3",83,0)
 ;+++++ PERFORMS SPECIAL CONVERSION OF THE DATE/TIME
"RTN","MAGSIXG3",84,0)
DTE(DTI) ;
"RTN","MAGSIXG3",85,0)
 N X  S X=$$FMTE^XLFDT(DTI,"5Z")
"RTN","MAGSIXG3",86,0)
 Q $P(X,"@")_" "_$S($P(X,"@",2)'="":$P(X,"@",2),1:"00:01")
"RTN","MAGSIXG3",87,0)
 ;
"RTN","MAGSIXG3",88,0)
 ;+++++ CALLBACK FUNCTION FOR IMAGE QUERY
"RTN","MAGSIXG3",89,0)
 ;
"RTN","MAGSIXG3",90,0)
 ; IMGIEN        IEN of the image record (file #2005 or #2005.1)
"RTN","MAGSIXG3",91,0)
 ;
"RTN","MAGSIXG3",92,0)
 ; FLAGS         Parameters passed into the image query API
"RTN","MAGSIXG3",93,0)
 ; .MAGDATA      ($$QUERY^MAGGI13). See the GETIMGS^MAGSIXG1
"RTN","MAGSIXG3",94,0)
 ;               for details.
"RTN","MAGSIXG3",95,0)
 ;
"RTN","MAGSIXG3",96,0)
 ; Input Variables
"RTN","MAGSIXG3",97,0)
 ; ===============
"RTN","MAGSIXG3",98,0)
 ;   MAGJOB, MAGOUT
"RTN","MAGSIXG3",99,0)
 ;
"RTN","MAGSIXG3",100,0)
 ; Output Variables
"RTN","MAGSIXG3",101,0)
 ; ================
"RTN","MAGSIXG3",102,0)
 ;   MAGJOB, MAGOUT, ^TMP("MAGSIXG3",$J,...)
"RTN","MAGSIXG3",103,0)
 ;
"RTN","MAGSIXG3",104,0)
 ; Return Values
"RTN","MAGSIXG3",105,0)
 ; =============
"RTN","MAGSIXG3",106,0)
 ;           <0  Error descriptor (see the $$ERROR^MAGUERR)
"RTN","MAGSIXG3",107,0)
 ;            0  Continue
"RTN","MAGSIXG3",108,0)
 ;           >0  Terminate the query
"RTN","MAGSIXG3",109,0)
 ;
"RTN","MAGSIXG3",110,0)
QRYCBK(IMGIEN,FLAGS,MAGDATA) ;
"RTN","MAGSIXG3",111,0)
 N CAPTAPP,CLASS,EVT,FLTX,GROUP,GRPCNTS,IIFLAGS,IMGNODE
"RTN","MAGSIXG3",112,0)
 N ORIG,PKG,PTIEN,RC,SENSIMG,SKIP,SPEC,STATUS,TYPE
"RTN","MAGSIXG3",113,0)
 N X,X0,X01,X100,X2,X40
"RTN","MAGSIXG3",114,0)
 N MAGFOUND  ; temp loop flag
"RTN","MAGSIXG3",115,0)
 S IMGNODE=$$NODE^MAGGI11(IMGIEN)  Q:IMGNODE="" 0
"RTN","MAGSIXG3",116,0)
 ;=== Terminate the query when maximum number of records is reached
"RTN","MAGSIXG3",117,0)
 I MAGDATA("MAXNUM"),MAGDATA("RESCNT")'<MAGDATA("MAXNUM")  Q 1
"RTN","MAGSIXG3",118,0)
 ;
"RTN","MAGSIXG3",119,0)
 ;=== Skip, if a group member
"RTN","MAGSIXG3",120,0)
 S X0=$G(@IMGNODE@(0))
"RTN","MAGSIXG3",121,0)
 Q:$P(X0,U,10) 0         ; GROUP PARENT (14)
"RTN","MAGSIXG3",122,0)
 ;
"RTN","MAGSIXG3",123,0)
 ;=== Check who captured the image
"RTN","MAGSIXG3",124,0)
 S X2=$G(@IMGNODE@(2)),X=+$G(MAGDATA("SAVEDBY"))
"RTN","MAGSIXG3",125,0)
 I X  Q:$P(X2,U,2)'=X 0  ; IMAGE SAVE BY (8)
"RTN","MAGSIXG3",126,0)
 ;
"RTN","MAGSIXG3",127,0)
 ;=== Perform additional screening according to the image counts
"RTN","MAGSIXG3",128,0)
 S GRPCNTS=$$GRPCT^MAGGI14(IMGIEN)
"RTN","MAGSIXG3",129,0)
 S:GRPCNTS<0 GRPCNTS=""  ;??? Ignore errors
"RTN","MAGSIXG3",130,0)
 S GROUP=$$ISGRP^MAGGI11(IMGIEN)
"RTN","MAGSIXG3",131,0)
 S SKIP=0  D  Q:SKIP 0
"RTN","MAGSIXG3",132,0)
 . ;--- Check if the image entry references "child" images of
"RTN","MAGSIXG3",133,0)
 . ;    requested kind(s). Also, safeguard against a wrong object
"RTN","MAGSIXG3",134,0)
 . ;--- type in the group header.
"RTN","MAGSIXG3",135,0)
 . I $P(GRPCNTS,U,1)>0  S GROUP=1  Q:FLAGS["E"  ; Existing "children"
"RTN","MAGSIXG3",136,0)
 . I $P(GRPCNTS,U,2)>0  S GROUP=1  Q:FLAGS["D"  ; Deleted "children"
"RTN","MAGSIXG3",137,0)
 . ;--- Skip group headers that do not reference
"RTN","MAGSIXG3",138,0)
 . ;--- any "child" images of requested kind(s)
"RTN","MAGSIXG3",139,0)
 . I GROUP  S SKIP=1  Q
"RTN","MAGSIXG3",140,0)
 . ;--- If existing images are not requested, then
"RTN","MAGSIXG3",141,0)
 . ;--- skip existing standalone image entries
"RTN","MAGSIXG3",142,0)
 . I FLAGS'["E",'$$ISDEL^MAGGI11(IMGIEN) S SKIP=1 Q
"RTN","MAGSIXG3",143,0)
 . Q
"RTN","MAGSIXG3",144,0)
 ;
"RTN","MAGSIXG3",145,0)
 ;=== Load other data associated with the image
"RTN","MAGSIXG3",146,0)
 S X40=$G(@IMGNODE@(40)),X100=$G(@IMGNODE@(100))
"RTN","MAGSIXG3",147,0)
 S PTIEN=+$P(X0,U,7)      ; PATIENT (5)
"RTN","MAGSIXG3",148,0)
 S PKG=$P(X40,U)          ; PACKAGE INDEX (40)
"RTN","MAGSIXG3",149,0)
 S TYPE=$P(X40,U,3)       ; TYPE INDEX (42)
"RTN","MAGSIXG3",150,0)
 S EVT=$P(X40,U,4)        ; PROC/EVENT INDEX (43)
"RTN","MAGSIXG3",151,0)
 S SPEC=$P(X40,U,5)       ; SPEC/SUBSPEC INDEX (44)
"RTN","MAGSIXG3",152,0)
 S ORIG=$P(X40,U,6)       ; ORIGIN INDEX (45)
"RTN","MAGSIXG3",153,0)
 S:ORIG="" ORIG="V"       ; Show VA by default
"RTN","MAGSIXG3",154,0)
 S SENSIMG=+$P(X100,U,7)  ; CONTROLLED IMAGE (112)
"RTN","MAGSIXG3",155,0)
 S STATUS=$P(X100,U,8)    ; STATUS(113)
"RTN","MAGSIXG3",156,0)
 S CAPTAPP=$P(X2,U,12)    ; CAPTURE APPLICATION (8.1)
"RTN","MAGSIXG3",157,0)
 ;
"RTN","MAGSIXG3",158,0)
 ; 150 T2 - if Group and Deleted and only 1 child: get Status of child.
"RTN","MAGSIXG3",159,0)
 I GROUP,$$ISDEL^MAGGI11(IMGIEN),$P(GRPCNTS,U,2)=1 D  ;
"RTN","MAGSIXG3",160,0)
 . S X=$O(^MAG(2005.1,"AGP",IMGIEN,""))
"RTN","MAGSIXG3",161,0)
 . I 'X Q
"RTN","MAGSIXG3",162,0)
 . S X=$P($G(^MAG(2005.1,X,100)),"^",8)
"RTN","MAGSIXG3",163,0)
 . I X S STATUS=X
"RTN","MAGSIXG3",164,0)
 . Q
"RTN","MAGSIXG3",165,0)
 ;=== Patch 150-  Status 13 is a Non Existant Image. Don't include in Image List.
"RTN","MAGSIXG3",166,0)
 I STATUS=13 Q 0  ;P150
"RTN","MAGSIXG3",167,0)
 ;=== Patch 59.  Treat Class as a computed field.
"RTN","MAGSIXG3",168,0)
 ;=== Arrange with Mike to change DB.
"RTN","MAGSIXG3",169,0)
 S CLASS=$S(TYPE:$P($G(^MAG(2005.83,+TYPE,0)),U,2),1:"")
"RTN","MAGSIXG3",170,0)
 I $D(MAGDATA("PKG")),PKG'=""    Q:'$D(MAGDATA("PKG",PKG)) 0
"RTN","MAGSIXG3",171,0)
 I $D(MAGDATA("ORIG")),ORIG'=""  Q:'$D(MAGDATA("ORIG",ORIG)) 0
"RTN","MAGSIXG3",172,0)
 I $D(MAGDATA("CLS")),CLASS'=""  Q:'$D(MAGDATA("CLS",CLASS)) 0
"RTN","MAGSIXG3",173,0)
 I $D(MAGDATA("TYPE")),TYPE      Q:'$D(MAGDATA("TYPE",TYPE)) 0
"RTN","MAGSIXG3",174,0)
 ;
"RTN","MAGSIXG3",175,0)
 I '(FLAGS["G") D  Q:'MAGFOUND 0  ; doesn't meet the criteria. One strike and you have to quit
"RTN","MAGSIXG3",176,0)
 . S MAGFOUND=1
"RTN","MAGSIXG3",177,0)
 . I $D(MAGDATA("ISTAT")),'$D(MAGDATA("ISTAT",+STATUS)) S MAGFOUND=0 Q
"RTN","MAGSIXG3",178,0)
 . Q
"RTN","MAGSIXG3",179,0)
 ;
"RTN","MAGSIXG3",180,0)
 I FLAGS["G" D  Q:'MAGFOUND 0  ; Quit. It doesn't meet the criteria
"RTN","MAGSIXG3",181,0)
 . S MAGFOUND=0
"RTN","MAGSIXG3",182,0)
 . I '$D(MAGDATA("ISTAT")) S MAGFOUND=1 Q  ;nothing to check. It means it is found
"RTN","MAGSIXG3",183,0)
 . ; Check for single images first
"RTN","MAGSIXG3",184,0)
 . I 'GROUP D  Q
"RTN","MAGSIXG3",185,0)
 . . I $D(MAGDATA("ISTAT",+STATUS)) S MAGFOUND=1  ; need this image
"RTN","MAGSIXG3",186,0)
 . . Q
"RTN","MAGSIXG3",187,0)
 . ;-- check all children in the group
"RTN","MAGSIXG3",188,0)
 . N CHI,CHIEN,CHNODE,CH100,CHSTATUS
"RTN","MAGSIXG3",189,0)
 . S CHI=0
"RTN","MAGSIXG3",190,0)
 . F  S CHI=$O(@IMGNODE@(1,CHI)) Q:CHI'>0  D  Q:MAGFOUND
"RTN","MAGSIXG3",191,0)
 . . S CHIEN=+$G(@IMGNODE@(1,CHI,0))
"RTN","MAGSIXG3",192,0)
 . . Q:CHIEN'>0
"RTN","MAGSIXG3",193,0)
 . . S CHNODE=$$NODE^MAGGI11(CHIEN) Q:CHNODE=""
"RTN","MAGSIXG3",194,0)
 . . S CH100=$G(@CHNODE@(100))
"RTN","MAGSIXG3",195,0)
 . . S CHSTATUS=$P(CH100,U,8)    ; STATUS(113)
"RTN","MAGSIXG3",196,0)
 . . I $D(MAGDATA("ISTAT",+CHSTATUS)) S MAGFOUND=1
"RTN","MAGSIXG3",197,0)
 . . Q
"RTN","MAGSIXG3",198,0)
 . Q
"RTN","MAGSIXG3",199,0)
 ;
"RTN","MAGSIXG3",200,0)
 ;=== Skip list entries with no event if event is in
"RTN","MAGSIXG3",201,0)
 ;=== the selection criteria (MAG*3*8)
"RTN","MAGSIXG3",202,0)
 I $D(MAGDATA("EVT"))   Q:EVT="" 0   Q:'$D(MAGDATA("EVT",EVT)) 0
"RTN","MAGSIXG3",203,0)
 ;
"RTN","MAGSIXG3",204,0)
 ;=== Skip list entries with no specialty if specialty is in
"RTN","MAGSIXG3",205,0)
 ;=== the selection criteria (MAG*3*8)
"RTN","MAGSIXG3",206,0)
 I $D(MAGDATA("SPEC"))  Q:SPEC="" 0  Q:'$D(MAGDATA("SPEC",SPEC)) 0
"RTN","MAGSIXG3",207,0)
 ;
"RTN","MAGSIXG3",208,0)
 ;=== Skip list entries with no capture application if
"RTN","MAGSIXG3",209,0)
 ;=== application is in the selection criteria
"RTN","MAGSIXG3",210,0)
 I $D(MAGDATA("CAPTAPP"))  Q:CAPTAPP="" 0  Q:'$D(MAGDATA("CAPTAPP",CAPTAPP)) 0
"RTN","MAGSIXG3",211,0)
 ;
"RTN","MAGSIXG3",212,0)
 ;=== Check the short description
"RTN","MAGSIXG3",213,0)
 I $D(MAGDATA("GDESC"))  Q:$$UP^XLFSTR($P(X2,U,4))'[MAGDATA("GDESC") 0
"RTN","MAGSIXG3",214,0)
 ;
"RTN","MAGSIXG3",215,0)
 ;=== Build the result item
"RTN","MAGSIXG3",216,0)
 S $P(FLTX,U,3)=$$RPTITLE($P(X2,U,6),$P(X2,U,7))     ; Report title
"RTN","MAGSIXG3",217,0)
 S $P(FLTX,U,4)=$$DTE($P(X2,U,5))                    ; Procedure date
"RTN","MAGSIXG3",218,0)
 S $P(FLTX,U,5)=$P(X0,U,8)                           ; Procedure
"RTN","MAGSIXG3",219,0)
 S $P(FLTX,U,7)=$P(X2,U,4)                           ; Short descr.
"RTN","MAGSIXG3",220,0)
 S $P(FLTX,U,8)=PKG                                  ; Package
"RTN","MAGSIXG3",221,0)
 S $P(FLTX,U,9)=$P($G(^MAG(2005.82,+CLASS,0)),U)     ; Class
"RTN","MAGSIXG3",222,0)
 S $P(FLTX,U,10)=$P($G(^MAG(2005.83,+TYPE,0)),U)     ; Type
"RTN","MAGSIXG3",223,0)
 S $P(FLTX,U,11)=$P($G(^MAG(2005.84,+SPEC,0)),U)     ; (Sub)Specialty
"RTN","MAGSIXG3",224,0)
 S $P(FLTX,U,12)=$P($G(^MAG(2005.85,+EVT,0)),U)      ; Proc/Event
"RTN","MAGSIXG3",225,0)
 S $P(FLTX,U,13)=$$EXTERNAL^DILFD(2005,45,,ORIG)     ; Origin
"RTN","MAGSIXG3",226,0)
 S $P(FLTX,U,14)=$$DTE($P(X2,U))                     ; Capture date
"RTN","MAGSIXG3",227,0)
 S $P(FLTX,U,15)=$$GET1^DIQ(200,+$P(X2,U,2)_",",.01) ; Captured by
"RTN","MAGSIXG3",228,0)
 ;
"RTN","MAGSIXG3",229,0)
 ;=== Flags for $$INFO^MAGGAII
"RTN","MAGSIXG3",230,0)
 S IIFLAGS=$$TRFLAGS^MAGUTL05(FLAGS,"DE")
"RTN","MAGSIXG3",231,0)
 ;
"RTN","MAGSIXG3",232,0)
 ;=== Sparse subset query does not append image entries to the result 
"RTN","MAGSIXG3",233,0)
 ;    array right away. It saves them to the temporary buffers in the
"RTN","MAGSIXG3",234,0)
 ;    ^TMP("MAGSIXG3",$J) global node instead. After all images are
"RTN","MAGSIXG3",235,0)
 ;    preselected, the $$SUBSET^MAGSIXG4 processes those buffers and
"RTN","MAGSIXG3",236,0)
 ;=== appends required number of image entries to the result array.
"RTN","MAGSIXG3",237,0)
 I MAGDATA("FLAGS")["S"  S RC=0  D  Q $S(RC<0:RC,1:0)
"RTN","MAGSIXG3",238,0)
 . N I,TCNT
"RTN","MAGSIXG3",239,0)
 . S (MAGDATA("TCNT"),TCNT)=$G(MAGDATA("TCNT"))+1
"RTN","MAGSIXG3",240,0)
 . ;--- If the image is associated with the same patient as the
"RTN","MAGSIXG3",241,0)
 . ;--- previous one, save it in the regular temporary buffer.
"RTN","MAGSIXG3",242,0)
 . I PTIEN=$G(MAGDATA("PREVPT"))  D  Q
"RTN","MAGSIXG3",243,0)
 . . S I=$O(^TMP("MAGSIXG3",$J,"R",""),-1)+1
"RTN","MAGSIXG3",244,0)
 . . S ^TMP("MAGSIXG3",$J,"R",I)=TCNT_"|"_IMGIEN_"|"_GRPCNTS
"RTN","MAGSIXG3",245,0)
 . . S ^TMP("MAGSIXG3",$J,"R",I,0)=FLTX
"RTN","MAGSIXG3",246,0)
 . . Q
"RTN","MAGSIXG3",247,0)
 . ;--- If the image is associated with a different patient, remember
"RTN","MAGSIXG3",248,0)
 . ;--- the new DFN and store the image into the "priority" buffer.
"RTN","MAGSIXG3",249,0)
 . S MAGDATA("PREVPT")=PTIEN
"RTN","MAGSIXG3",250,0)
 . S ^TMP("MAGSIXG3",$J,"P",TCNT)=TCNT_"|"_IMGIEN_"|"_GRPCNTS
"RTN","MAGSIXG3",251,0)
 . S ^TMP("MAGSIXG3",$J,"P",TCNT,0)=FLTX
"RTN","MAGSIXG3",252,0)
 . ;--- If the image that precedes the patient change is not in the
"RTN","MAGSIXG3",253,0)
 . ;--- "priority" buffer yet, move it there from the regular buffer.
"RTN","MAGSIXG3",254,0)
 . S X=TCNT-1  Q:$D(^TMP("MAGSIXG3",$J,"P",X))
"RTN","MAGSIXG3",255,0)
 . S I=$O(^TMP("MAGSIXG3",$J,"R",""),-1)  Q:I=""
"RTN","MAGSIXG3",256,0)
 . I $P(^TMP("MAGSIXG3",$J,"R",I),"|")'=X  D  Q
"RTN","MAGSIXG3",257,0)
 . . S RC=$$ERROR^MAGUERR(-47)  ; This should never happen!
"RTN","MAGSIXG3",258,0)
 . . Q
"RTN","MAGSIXG3",259,0)
 . M ^TMP("MAGSIXG3",$J,"P",X)=^TMP("MAGSIXG3",$J,"R",I)
"RTN","MAGSIXG3",260,0)
 . K ^TMP("MAGSIXG3",$J,"R",I)
"RTN","MAGSIXG3",261,0)
 . Q
"RTN","MAGSIXG3",262,0)
 ;
"RTN","MAGSIXG3",263,0)
 ;=== Append the image item to the result array
"RTN","MAGSIXG3",264,0)
 S RC=$$APPEND(IMGIEN,FLTX,GRPCNTS,IIFLAGS)  Q:RC<0 RC
"RTN","MAGSIXG3",265,0)
 ;
"RTN","MAGSIXG3",266,0)
 ;=== Success
"RTN","MAGSIXG3",267,0)
 Q 0
"RTN","MAGSIXG3",268,0)
 ;
"RTN","MAGSIXG3",269,0)
 ;+++++ RETURNS THE NOTE TITLE
"RTN","MAGSIXG3",270,0)
RPTITLE(FILE,IEN) ;
"RTN","MAGSIXG3",271,0)
 N TITLE,TMP
"RTN","MAGSIXG3",272,0)
 I FILE=8925,IEN>0  D  S TITLE=$P($G(^TIU(8925.1,TMP,0)),U)  ; IA #2321
"RTN","MAGSIXG3",273,0)
 . S TMP=+$P($G(^TIU(8925,+IEN,0)),U)   ; IA #2937
"RTN","MAGSIXG3",274,0)
 . Q
"RTN","MAGSIXG3",275,0)
 Q $S($G(TITLE)'="":TITLE,1:"   ")
"VER")
8.0^22.0
"^DD",2006.1,2006.1,75,0)
DISPLAY HELP URL^F^^HELPD;1^K:$L(X)>250!($L(X)<3) X
"^DD",2006.1,2006.1,75,3)
Enter the url of the Clinical Display User Manual, 3 to 250 characters.
"^DD",2006.1,2006.1,75,21,0)
^.001^4^4^3160720^^
"^DD",2006.1,2006.1,75,21,1,0)
The Display Client help menu has an option to open the
"^DD",2006.1,2006.1,75,21,2,0)
VistA Imaging Clinical Display User Manual.
"^DD",2006.1,2006.1,75,21,3,0)
The User Manual is on the VistA Imaging Sharepoint Web site.
"^DD",2006.1,2006.1,75,21,4,0)
Enter the url of the Display User Manual here.
"^DD",2006.1,2006.1,75,"DT")
3160707
"^DD",2006.1,2006.1,76,0)
CAPTURE HELP URL^F^^HELPC;1^K:$L(X)>250!($L(X)<3) X
"^DD",2006.1,2006.1,76,3)
Enter the url of the Clinical Capture User Manual, 3 to 250 characters.
"^DD",2006.1,2006.1,76,21,0)
^.001^4^4^3160720^^
"^DD",2006.1,2006.1,76,21,1,0)
The Capture Client help menu has an option to open the
"^DD",2006.1,2006.1,76,21,2,0)
VistA Imaging Clinical Capture User Manual.
"^DD",2006.1,2006.1,76,21,3,0)
The User Manual is on the VistA Imaging Sharepoint Web site.
"^DD",2006.1,2006.1,76,21,4,0)
Enter the url of the Capture User Manual here.
"^DD",2006.1,2006.1,76,"DT")
3160707
**END**
**END**
