KIDS Distribution saved on Aug 22, 2017@15:54:23
VistA Imaging V3 - Patch 186 Background Processor Maintenance
**KIDS**:MAG*3.0*186^

**INSTALL NAME**
MAG*3.0*186
"BLD",8358,0)
MAG*3.0*186^IMAGING^0^3170822^y
"BLD",8358,1,0)
^^9^9^3170601^
"BLD",8358,1,1,0)
VistA Imaging V3.0 Patch 186 - BACKGROUND PROCESSOR fix
"BLD",8358,1,2,0)
 - This patch will fix the queue entry not found or left-over issue.
"BLD",8358,1,3,0)
 - Also take care the Auto (schedule) Verifier not running (stop at IQ 
"BLD",8358,1,4,0)
set) issue
"BLD",8358,1,5,0)
 
"BLD",8358,1,6,0)
MAGQBUT2
"BLD",8358,1,7,0)
MAGQBPG1
"BLD",8358,1,8,0)
MAGQBTM
"BLD",8358,1,9,0)
MAGIP186
"BLD",8358,4,0)
^9.64PA^^0
"BLD",8358,6.3)
23
"BLD",8358,"ABNS",0)
^9.66A^^
"BLD",8358,"ABPKG")
n^n^G.IMAGING DEVELOPMENT TEAM@domain.ext
"BLD",8358,"INI")
PRE^MAGIP186
"BLD",8358,"INID")
n^y^n
"BLD",8358,"INIT")
POS^MAGIP186
"BLD",8358,"KRN",0)
^9.67PA^779.2^20
"BLD",8358,"KRN",.4,0)
.4
"BLD",8358,"KRN",.4,"NM",0)
^9.68A^^
"BLD",8358,"KRN",.401,0)
.401
"BLD",8358,"KRN",.402,0)
.402
"BLD",8358,"KRN",.403,0)
.403
"BLD",8358,"KRN",.5,0)
.5
"BLD",8358,"KRN",.84,0)
.84
"BLD",8358,"KRN",3.6,0)
3.6
"BLD",8358,"KRN",3.8,0)
3.8
"BLD",8358,"KRN",9.2,0)
9.2
"BLD",8358,"KRN",9.8,0)
9.8
"BLD",8358,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",8358,"KRN",9.8,"NM",1,0)
MAGQBTM^^0^B87348923
"BLD",8358,"KRN",9.8,"NM",2,0)
MAGIP186^^0^B10511588
"BLD",8358,"KRN",9.8,"NM",3,0)
MAGQBUT2^^0^B103758000
"BLD",8358,"KRN",9.8,"NM",4,0)
MAGQBPG1^^0^B115123718
"BLD",8358,"KRN",9.8,"NM","B","MAGIP186",2)

"BLD",8358,"KRN",9.8,"NM","B","MAGQBPG1",4)

"BLD",8358,"KRN",9.8,"NM","B","MAGQBTM",1)

"BLD",8358,"KRN",9.8,"NM","B","MAGQBUT2",3)

"BLD",8358,"KRN",19,0)
19
"BLD",8358,"KRN",19,"NM",0)
^9.68A^^
"BLD",8358,"KRN",19.1,0)
19.1
"BLD",8358,"KRN",101,0)
101
"BLD",8358,"KRN",409.61,0)
409.61
"BLD",8358,"KRN",771,0)
771
"BLD",8358,"KRN",779.2,0)
779.2
"BLD",8358,"KRN",870,0)
870
"BLD",8358,"KRN",8989.51,0)
8989.51
"BLD",8358,"KRN",8989.52,0)
8989.52
"BLD",8358,"KRN",8994,0)
8994
"BLD",8358,"KRN","B",.4,.4)

"BLD",8358,"KRN","B",.401,.401)

"BLD",8358,"KRN","B",.402,.402)

"BLD",8358,"KRN","B",.403,.403)

"BLD",8358,"KRN","B",.5,.5)

"BLD",8358,"KRN","B",.84,.84)

"BLD",8358,"KRN","B",3.6,3.6)

"BLD",8358,"KRN","B",3.8,3.8)

"BLD",8358,"KRN","B",9.2,9.2)

"BLD",8358,"KRN","B",9.8,9.8)

"BLD",8358,"KRN","B",19,19)

"BLD",8358,"KRN","B",19.1,19.1)

"BLD",8358,"KRN","B",101,101)

"BLD",8358,"KRN","B",409.61,409.61)

"BLD",8358,"KRN","B",771,771)

"BLD",8358,"KRN","B",779.2,779.2)

"BLD",8358,"KRN","B",870,870)

"BLD",8358,"KRN","B",8989.51,8989.51)

"BLD",8358,"KRN","B",8989.52,8989.52)

"BLD",8358,"KRN","B",8994,8994)

"BLD",8358,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",8358,"QUES",0)
^9.62^^
"BLD",8358,"REQB",0)
^9.611^1^1
"BLD",8358,"REQB",1,0)
MAG*3.0*154^2
"BLD",8358,"REQB","B","MAG*3.0*154",1)

"INI")
PRE^MAGIP186
"INIT")
POS^MAGIP186
"MBREQ")
0
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging-V1 to release 
"PKG",454,20,0)
^9.402P^^
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020319^3020517^126
"PKG",454,22,1,"PAH",1,0)
186^3170822^126
"PKG",454,22,1,"PAH",1,1,0)
^^9^9^3170822
"PKG",454,22,1,"PAH",1,1,1,0)
VistA Imaging V3.0 Patch 186 - BACKGROUND PROCESSOR fix
"PKG",454,22,1,"PAH",1,1,2,0)
 - This patch will fix the queue entry not found or left-over issue.
"PKG",454,22,1,"PAH",1,1,3,0)
 - Also take care the Auto (schedule) Verifier not running (stop at IQ 
"PKG",454,22,1,"PAH",1,1,4,0)
set) issue
"PKG",454,22,1,"PAH",1,1,5,0)
 
"PKG",454,22,1,"PAH",1,1,6,0)
MAGQBUT2
"PKG",454,22,1,"PAH",1,1,7,0)
MAGQBPG1
"PKG",454,22,1,"PAH",1,1,8,0)
MAGQBTM
"PKG",454,22,1,"PAH",1,1,9,0)
MAGIP186
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","MAGIP186")
0^2^B10511588
"RTN","MAGIP186",1,0)
MAGIP186 ;WOIFO/JSL,DAC,GEK - INSTALL CODE FOR MAG*3.0*186 BP FIX; 27 Jul 2017  9:23 AM
"RTN","MAGIP186",2,0)
 ;;3.0;IMAGING;**186**;Mar 19, 2002;Build 23
"RTN","MAGIP186",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIP186",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP186",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIP186",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIP186",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIP186",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIP186",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIP186",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIP186",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIP186",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIP186",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIP186",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIP186",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIP186",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP186",17,0)
 ;;
"RTN","MAGIP186",18,0)
 ; There are no environment checks here but the MAGIP186 has to be
"RTN","MAGIP186",19,0)
 ; referenced by the "Environment Check Routine" field of the KIDS
"RTN","MAGIP186",20,0)
 ; build so that entry points of the routine are available to the
"RTN","MAGIP186",21,0)
 ; KIDS during all installation phases.
"RTN","MAGIP186",22,0)
 ;
"RTN","MAGIP186",23,0)
 Q
"RTN","MAGIP186",24,0)
 ;
"RTN","MAGIP186",25,0)
 ;+++++ INSTALLATION ERROR HANDLING
"RTN","MAGIP186",26,0)
ERROR ;
"RTN","MAGIP186",27,0)
 S:$D(XPDNM) XPDABORT=1
"RTN","MAGIP186",28,0)
 ;--- Display the messages and store them to the INSTALL file
"RTN","MAGIP186",29,0)
 D DUMP^MAGUERR1(),ABTMSG^MAGKIDS()
"RTN","MAGIP186",30,0)
 Q
"RTN","MAGIP186",31,0)
 ;
"RTN","MAGIP186",32,0)
POST ;***** POST-INSTALL CODE
"RTN","MAGIP186",33,0)
POS ;
"RTN","MAGIP186",34,0)
 N CALLBACK
"RTN","MAGIP186",35,0)
 D CLEAR^MAGUERR(1)
"RTN","MAGIP186",36,0)
 I $G(DUZ)<.5 S XPDABORT=1 Q
"RTN","MAGIP186",37,0)
 ;--- Send the notification e-mail
"RTN","MAGIP186",38,0)
 D BMES^XPDUTL("Post Install Mail Message: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","MAGIP186",39,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGIP186",40,0)
 ;
"RTN","MAGIP186",41,0)
 Q
"RTN","MAGIP186",42,0)
 ;
"RTN","MAGIP186",43,0)
 ;***** PRE-INSTALL CODE
"RTN","MAGIP186",44,0)
PRE ;
"RTN","MAGIP186",45,0)
 ;
"RTN","MAGIP186",46,0)
QCLN ;;CLEAN "D" X-REF of BP MAGQUEUE #2006.03 
"RTN","MAGIP186",47,0)
 N LOC,QTYP,STG,QIEN,NO,MAX,LNT,BADCT,BADTCT
"RTN","MAGIP186",48,0)
 S LOC=0,BADTCT=0
"RTN","MAGIP186",49,0)
 W !,"Removing bad references from IMAGE BACKGROUND QUEUE (2006.03)"
"RTN","MAGIP186",50,0)
 F NO=1:1 S LOC=$O(^MAGQUEUE(2006.03,"D",LOC)) Q:'LOC  I $D(^MAG(2006.1,LOC)) W !!,"Location(PLACE) = '",LOC,"'  ",$P($G(^MAG(2006.1,LOC,0)),"^",9) D 
"RTN","MAGIP186",51,0)
 . S QTYP="A" 
"RTN","MAGIP186",52,0)
 . F  S QTYP=$O(^MAGQUEUE(2006.03,"D",LOC,QTYP)) Q:QTYP=""  W !!,"Queue = '",QTYP,"'" D
"RTN","MAGIP186",53,0)
 .. S STG="" 
"RTN","MAGIP186",54,0)
 .. F  S STG=$O(^MAGQUEUE(2006.03,"D",LOC,QTYP,STG)) Q:STG=""  W !,?4,"Category = '",STG,"'" D
"RTN","MAGIP186",55,0)
 ... S QIEN=0,BADCT=0
"RTN","MAGIP186",56,0)
 ... F MAX=1:1:1000000 S QIEN=$O(^MAGQUEUE(2006.03,"D",LOC,QTYP,STG,QIEN)) Q:'QIEN  I '$D(^MAGQUEUE(2006.03,QIEN,0)) D
"RTN","MAGIP186",57,0)
 .... W "*",QIEN S BADCT=BADCT+1 K ^MAGQUEUE(2006.03,"D",LOC,QTYP,STG,QIEN)
"RTN","MAGIP186",58,0)
 .... F LNT=1:1:$L(QIEN)+1 W $C(8)
"RTN","MAGIP186",59,0)
 ... I 'BADCT W !,?4,BADCT," bad references."
"RTN","MAGIP186",60,0)
 ... I BADCT S BADTCT=BADTCT+BADCT W !,?4,BADCT," bad references removed."
"RTN","MAGIP186",61,0)
 ... Q
"RTN","MAGIP186",62,0)
 .. Q
"RTN","MAGIP186",63,0)
 . Q
"RTN","MAGIP186",64,0)
 W !!,"Processing is complete."
"RTN","MAGIP186",65,0)
 I 'BADTCT W "  0 bad references."
"RTN","MAGIP186",66,0)
 I BADTCT W "  Total of ",BADTCT," bad references removed."
"RTN","MAGIP186",67,0)
 Q
"RTN","MAGIP186",68,0)
 ;
"RTN","MAGIP186",69,0)
 ;****
"RTN","MAGIP186",70,0)
 QUIT
"RTN","MAGQBPG1")
0^4^B115123718
"RTN","MAGQBPG1",1,0)
MAGQBPG1 ;WOIFO/RMP,JSL,DAC - REMOTE Task SERVER Program ; 27 Jul 2017 11:12 AM
"RTN","MAGQBPG1",2,0)
 ;;3.0;IMAGING;**7,8,20,81,39,135,154,186**;;Build 23
"RTN","MAGQBPG1",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQBPG1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBPG1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBPG1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBPG1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBPG1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBPG1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBPG1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBPG1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBPG1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBPG1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBPG1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBPG1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBPG1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBPG1",17,0)
 ;;
"RTN","MAGQBPG1",18,0)
 Q
"RTN","MAGQBPG1",19,0)
ENTRY(RESULT,WSTAT,PROCESS) ;RPC[MAGQ JBS]
"RTN","MAGQBPG1",20,0)
 N X,SYSIEN,SYSNAME,ZNODE,NODE,INDX,CNT,PROC,%,QPTR,QCNT,SHARE,PLACE,SCANDATE
"RTN","MAGQBPG1",21,0)
 S SCANDATE=$$FMTE^XLFDT($$NOW^XLFDT)
"RTN","MAGQBPG1",22,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",23,0)
 S (SYSIEN,CNT)=0,SYSNAME="",U="^",PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBPG1",24,0)
 S SYSIEN=$O(^MAG(2006.8,"C",PLACE,WSTAT,"")) ;TRUE WORKSTATION NAME
"RTN","MAGQBPG1",25,0)
 I 'SYSIEN S SYSIEN=$O(^MAG(2006.8,"C",PLACE,$$UPPER^MAGQE4(WSTAT),""))
"RTN","MAGQBPG1",26,0)
 I 'SYSIEN D  ;ATTEMPT TO FIND A MATCH FROM LOCAL NAME
"RTN","MAGQBPG1",27,0)
 . N TRY
"RTN","MAGQBPG1",28,0)
 . F TRY=1:1:$L(WSTAT,".") D  Q:SYSIEN?1N.N
"RTN","MAGQBPG1",29,0)
 . . S SYSIEN=$O(^MAG(2006.8,"C",PLACE,$P(WSTAT,".",TRY),""))
"RTN","MAGQBPG1",30,0)
 . . I 'SYSIEN S SYSIEN=$O(^MAG(2006.8,"C",PLACE,$$UPPER^MAGQE4($P(WSTAT,".",TRY)),""))
"RTN","MAGQBPG1",31,0)
 I SYSIEN="" D  Q
"RTN","MAGQBPG1",32,0)
 . S RESULT(0)="-1^This workstation is not currently setup as a Background Processor."
"RTN","MAGQBPG1",33,0)
 . Q
"RTN","MAGQBPG1",34,0)
 S NODE=^MAG(2006.8,SYSIEN,0)
"RTN","MAGQBPG1",35,0)
 S SYSNAME=$P(NODE,U)
"RTN","MAGQBPG1",36,0)
 I SYSNAME="" D  Q
"RTN","MAGQBPG1",37,0)
 . S RESULT(0)="-1^This workstation is not currently setup as a Background Processor."
"RTN","MAGQBPG1",38,0)
 . Q
"RTN","MAGQBPG1",39,0)
 S RESULT(0)="0^BP List^PID: "_$$BASE^XLFUTL($J,10,16)_U_SYSNAME_U_WSTAT_U_$P(^MAG(2006.1,PLACE,0),U,2)
"RTN","MAGQBPG1",40,0)
 S (X,CNT)=0
"RTN","MAGQBPG1",41,0)
 F  S X=$O(^MAG(2005.2,X)) Q:X'?1N.N  S ZNODE=$G(^(X,0)) D
"RTN","MAGQBPG1",42,0)
 . Q:'$P(ZNODE,U,6)  ;1=online
"RTN","MAGQBPG1",43,0)
 . Q:$E($P(ZNODE,U,2),1,2)'="\\"
"RTN","MAGQBPG1",44,0)
 . Q:$P(ZNODE,U,10)'=PLACE
"RTN","MAGQBPG1",45,0)
 . Q:(($P(ZNODE,U,7)'["WORM")&($P(ZNODE,U,7)'="RW"))
"RTN","MAGQBPG1",46,0)
 . S CNT=CNT+1,SHARE=$P(ZNODE,U,2)
"RTN","MAGQBPG1",47,0)
 . I $E(SHARE,$L(SHARE))="\" S SHARE=$E(SHARE,1,$L(SHARE)-1)
"RTN","MAGQBPG1",48,0)
 . S RESULT(CNT)=X_U_SHARE_U_$P(ZNODE,U,8)
"RTN","MAGQBPG1",49,0)
 Q
"RTN","MAGQBPG1",50,0)
SHR(RESULT) ; RPC[MAGQ SHARES]
"RTN","MAGQBPG1",51,0)
 N TMP,INDX,DATA,CNT,SHARE,CWL,VALUE,PLACE
"RTN","MAGQBPG1",52,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",53,0)
 S (CNT,INDX)=0,U="^",PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBPG1",54,0)
 S CWL=$$CWL^MAGBAPI(PLACE)
"RTN","MAGQBPG1",55,0)
 F  S INDX=$O(^MAG(2005.2,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQBPG1",56,0)
 . S DATA=$G(^MAG(2005.2,INDX,0))
"RTN","MAGQBPG1",57,0)
 . Q:$P(DATA,U,6,7)'["1^MAG"
"RTN","MAGQBPG1",58,0)
 . Q:$P(DATA,U,9)="1"  ;ROUTING SHARE
"RTN","MAGQBPG1",59,0)
 . Q:$P(DATA,U,2)[":"
"RTN","MAGQBPG1",60,0)
 . Q:$P(DATA,U,10)'=PLACE
"RTN","MAGQBPG1",61,0)
 . S SHARE=$P(DATA,U,2)
"RTN","MAGQBPG1",62,0)
 . Q:$E(SHARE,1,2)'="\\"
"RTN","MAGQBPG1",63,0)
 . I $E(SHARE,$L(SHARE))="\" S SHARE=$E(SHARE,1,$L(SHARE)-1)
"RTN","MAGQBPG1",64,0)
 . S SHARE=SHARE_U_$P(DATA,U,8)
"RTN","MAGQBPG1",65,0)
 . Q:$D(TMP(SHARE))
"RTN","MAGQBPG1",66,0)
 . S TMP(SHARE)=INDX
"RTN","MAGQBPG1",67,0)
 S INDX=""
"RTN","MAGQBPG1",68,0)
 F  S INDX=$O(TMP(INDX)) Q:INDX=""  D
"RTN","MAGQBPG1",69,0)
 . S RESULT(CNT)=TMP(INDX)_U_INDX,CNT=CNT+1
"RTN","MAGQBPG1",70,0)
 . S ^TMP("MAGQBP",$J,"SHRLST",CNT-1)=TMP(INDX)_U_INDX
"RTN","MAGQBPG1",71,0)
 K TMP
"RTN","MAGQBPG1",72,0)
 Q
"RTN","MAGQBPG1",73,0)
CNP2(RESULT,IEN,START,STOP,AUTO) ;[MAGQ JBSCN]
"RTN","MAGQBPG1",74,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",75,0)
 N FNAME,PIECE,ZNODE,NODE2,BNODE,BNAME,PTR,HASH,TEMP,ORDER,RDATE,PLACE,OFFLINE,PLACEOK,GL,END,ACQSITE,MAGDA,SCANCNT,OFFCNT,ALTPLACE,CORREC
"RTN","MAGQBPG1",76,0)
 S (RESULT,GL)="",PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2))),(OFFLINE,PLACEOK,SCANCNT,ALTPLACE,OFFCNT)=0,CORREC=""
"RTN","MAGQBPG1",77,0)
 I AUTO D
"RTN","MAGQBPG1",78,0)
 . S (IEN,MAGDA)=+IEN
"RTN","MAGQBPG1",79,0)
 . S ORDER="R"
"RTN","MAGQBPG1",80,0)
 . I START="" S START=$S(IEN>0:IEN,1:$O(^MAG(2005,"A"),-1))
"RTN","MAGQBPG1",81,0)
 . S STOP=$O(^MAG(2005,0))
"RTN","MAGQBPG1",82,0)
 . Q
"RTN","MAGQBPG1",83,0)
 S:START="" START=$O(^MAG(2005,0)) S:STOP="" STOP=$O(^MAG(2005,"A"),-1)
"RTN","MAGQBPG1",84,0)
 S ORDER=$S(START>STOP:"R",1:"F")
"RTN","MAGQBPG1",85,0)
 I (IEN'?1N.N)!IEN=0 D  I IEN="" S RESULT=0 Q
"RTN","MAGQBPG1",86,0)
 . I START=0 S IEN=START Q
"RTN","MAGQBPG1",87,0)
 . I ORDER="R" D
"RTN","MAGQBPG1",88,0)
 . . S I1=+$O(^MAG(2005," "),-1),I2=+$O(^MAG(2005.1," "),-1),END=$S(I1>I2:I1,1:I2)
"RTN","MAGQBPG1",89,0)
 . . S IEN=$S(START>END:START,1:START+1) Q
"RTN","MAGQBPG1",90,0)
 . E  S (IEN,MAGDA)=START-1
"RTN","MAGQBPG1",91,0)
 . Q
"RTN","MAGQBPG1",92,0)
 S (IEN,MAGDA)=+IEN
"RTN","MAGQBPG1",93,0)
 F  D SCAN^MAGQBPG1(.IEN,ORDER,.GL) D  Q:(((ORDER="R")&(IEN<STOP))!((ORDER="F")&(IEN>STOP))!(('OFFLINE)&PLACEOK)!(CORREC]"")!('IEN)!(SCANCNT>249)!($P(RESULT,U,21)="DUPE")!'$G(ACQSITE))
"RTN","MAGQBPG1",94,0)
 . Q:'IEN
"RTN","MAGQBPG1",95,0)
 . S SCANCNT=SCANCNT+1,OFFLINE=0
"RTN","MAGQBPG1",96,0)
 . S ZNODE=$G(@(GL_IEN_",0)")),ACQSITE=$P($G(@(GL_IEN_",100)")),U,3)
"RTN","MAGQBPG1",97,0)
 . S NODE2=$G(@(GL_IEN_",2)"))
"RTN","MAGQBPG1",98,0)
 . I ((ZNODE']"")!($P(ZNODE,U,1,2)="^^"))!(NODE2']"")!(($P(NODE2,U,1,8)="^^^^^^^")&(($G(@(GL_IEN_",1)"))']""))) D KLOG(GL,IEN,.CORREC) Q 
"RTN","MAGQBPG1",99,0)
 . S PLACEOK=$S($$PLACE^MAGBAPI(+ACQSITE)=$$PLACE^MAGBAPI($G(DUZ(2))):1,1:"")
"RTN","MAGQBPG1",100,0)
 . I $P(ZNODE,U,2)'="" S OFFLINE=$$IMOFFLN^MAGFILEB($P(ZNODE,U,2))  ; Only check the offline status of image files
"RTN","MAGQBPG1",101,0)
 . I OFFLINE S OFFCNT=OFFCNT+1 Q
"RTN","MAGQBPG1",102,0)
 . I 'PLACEOK S ALTPLACE=ALTPLACE+1 Q
"RTN","MAGQBPG1",103,0)
 . I AUTO,$P(ZNODE,U,11)'="" D  Q  ; P186 DAC - If PLACE is OK and auto verifier is running and IQ is set end processing
"RTN","MAGQBPG1",104,0)
 . . S $P(RESULT,U,1)=0
"RTN","MAGQBPG1",105,0)
 . . S IEN=0
"RTN","MAGQBPG1",106,0)
 . . Q
"RTN","MAGQBPG1",107,0)
 . I ($D(^MAG(2005.1,IEN,0))&$D(^MAG(2005,IEN,0))) D  Q  ; Image is duplicated in the Archive file
"RTN","MAGQBPG1",108,0)
 . . I $P(^MAG(2005,IEN,0),U,1,8)="^^^^^^^",+$P(^MAG(2005,IEN,0),U,9) D KLOG(GL,IEN,.CORREC) Q
"RTN","MAGQBPG1",109,0)
 . . S FDA(2005,IEN_",",13.5)="1" ; Set Dupe field in the Image File 
"RTN","MAGQBPG1",110,0)
 . . S FDA(2005,IEN_",",13)="1" ; Set IQ field in the Image File  
"RTN","MAGQBPG1",111,0)
 . . D FILE^DIE("I","FDA","MSG") K FDA,MSG
"RTN","MAGQBPG1",112,0)
 . . S FDA(2005.1,IEN_",",13.5)="1" ; Set the Dupe field in the archive file
"RTN","MAGQBPG1",113,0)
 . . S FDA(2005.1,IEN_",",13)="1" ; and set the IQ field in the archive file
"RTN","MAGQBPG1",114,0)
 . . D FILE^DIE("I","FDA","MSG") K FDA,MSG
"RTN","MAGQBPG1",115,0)
 . . S $P(RESULT,U,21)="DUPE"
"RTN","MAGQBPG1",116,0)
 . . S $P(RESULT,U)=IEN
"RTN","MAGQBPG1",117,0)
 . . I $P(ZNODE,U,2)=$P($G(^MAG(2005.1,IEN,0)),U,2) S $P(RESULT,U,2)=$P(ZNODE,U,2) D
"RTN","MAGQBPG1",118,0)
 . . . I $P(RESULT,U,2)="" S $P(RESULT,U,2)="No File Name" Q
"RTN","MAGQBPG1",119,0)
 . . E  S $P(RESULT,U,2)=$P(ZNODE,U,2)_"/"_$P($G(^MAG(2005.1,IEN,0)),U,2) D
"RTN","MAGQBPG1",120,0)
 . . . I $P($P(RESULT,U,2),"/")="" S $P(RESULT,U,2)="No File Name"_$P(RESULT,U,2)
"RTN","MAGQBPG1",121,0)
 . . . I $P($P(RESULT,U,2),"/",2)="" S $P(RESULT,U,2)=$P(RESULT,U,2)_"No File Name"
"RTN","MAGQBPG1",122,0)
 . . . Q
"RTN","MAGQBPG1",123,0)
 . . Q
"RTN","MAGQBPG1",124,0)
 . E  I $P(ZNODE,U,2)'="" S $P(@(GL_IEN_",0)"),U,12)="0"
"RTN","MAGQBPG1",125,0)
 . Q
"RTN","MAGQBPG1",126,0)
 S $P(RESULT,U,25)=OFFCNT
"RTN","MAGQBPG1",127,0)
 S $P(RESULT,U,26)=ALTPLACE
"RTN","MAGQBPG1",128,0)
 I CORREC]"" D  Q
"RTN","MAGQBPG1",129,0)
 . S $P(RESULT,U,27)=CORREC
"RTN","MAGQBPG1",130,0)
 . D SCAN^MAGQBPG1(.IEN,ORDER,.GL)
"RTN","MAGQBPG1",131,0)
 . S $P(RESULT,U,24)=IEN
"RTN","MAGQBPG1",132,0)
 . Q
"RTN","MAGQBPG1",133,0)
 I $S('IEN:1,((ORDER="F")&(IEN>STOP)):1,(SCANCNT>249):1,((ORDER="R")&(IEN<STOP)):1,1:0) D  Q
"RTN","MAGQBPG1",134,0)
 . S:SCANCNT>249 $P(RESULT,U,24)=IEN
"RTN","MAGQBPG1",135,0)
 . S $P(RESULT,U,1)=0
"RTN","MAGQBPG1",136,0)
 . Q
"RTN","MAGQBPG1",137,0)
 S FNAME=$P(ZNODE,U,2)
"RTN","MAGQBPG1",138,0)
 S $P(RESULT,U)=IEN
"RTN","MAGQBPG1",139,0)
 Q:($P(RESULT,U,21)="DUPE")
"RTN","MAGQBPG1",140,0)
 S $P(RESULT,U,19)=$P($P($G(@(GL_IEN_",2)")),U),".")
"RTN","MAGQBPG1",141,0)
 I $P(ZNODE,U,2)'="" D  ;NON-GROUP PARENT
"RTN","MAGQBPG1",142,0)
 . S BNODE=$G(@(GL_IEN_",""FBIG"")"))
"RTN","MAGQBPG1",143,0)
 . I $P(ZNODE,U,5)?1N.N S $P(RESULT,U,3)=$P(ZNODE,U,5)
"RTN","MAGQBPG1",144,0)
 . S:$P(BNODE,U,2)?1N.N $P(RESULT,U,4)=$S($P(BNODE,U,3)'="":"["_$P(BNODE,U,3)_"]",1:"")_$P(BNODE,U,2)
"RTN","MAGQBPG1",145,0)
 . S:$P(ZNODE,U,3)?1N.N $P(RESULT,U,5)=$P(ZNODE,U,3)
"RTN","MAGQBPG1",146,0)
 . S:$P(ZNODE,U,4)?1N.N $P(RESULT,U,6)=$P(ZNODE,U,4)
"RTN","MAGQBPG1",147,0)
 . S:$P(BNODE,U)?1N.N $P(RESULT,U,7)=$S($P(BNODE,U,3)'="":"["_$P(BNODE,U,3)_"]",1:"")_$P(BNODE,U)
"RTN","MAGQBPG1",148,0)
 . S $P(RESULT,U,8)=$$CWL^MAGBAPI(PLACE)
"RTN","MAGQBPG1",149,0)
 . S $P(RESULT,U,2)=FNAME
"RTN","MAGQBPG1",150,0)
 . I $D(@(GL_IEN_",""FBIG"")")),'$P(BNODE,U),'$P(BNODE,U,2) S $P(RESULT,U,22)="EMPTY_FBIG"
"RTN","MAGQBPG1",151,0)
 . Q
"RTN","MAGQBPG1",152,0)
 I '$P($G(@(GL_IEN_",100)")),U,3) S $P(RESULT,U,23)=-1 ;"NO ACQ SITE VALUE"
"RTN","MAGQBPG1",153,0)
 I GL[("^MAG(2005.1,") S $P(RESULT,U,21)=$S($P($G(^MAG(2005.1,IEN,100)),U,8)=13:"NE",1:"ARCH")
"RTN","MAGQBPG1",154,0)
 E  S $P(RESULT,U,12,17)=$$CHKIMG^MAGQBUT2(IEN)
"RTN","MAGQBPG1",155,0)
 Q
"RTN","MAGQBPG1",156,0)
JPUD(RESULT,JPTR,EXT,IEN) ; RPC[MAGQ JPUD]
"RTN","MAGQBPG1",157,0)
 N TYPE,PIECE,NODE,GL
"RTN","MAGQBPG1",158,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP"),RESULT="0"
"RTN","MAGQBPG1",159,0)
 S TYPE=$$FTYPE^MAGQBPRG(EXT,IEN)
"RTN","MAGQBPG1",160,0)
 S PIECE=$S(TYPE="BIG":2,1:5)
"RTN","MAGQBPG1",161,0)
 S NODE=$S(TYPE="BIG":"FBIG",1:0)
"RTN","MAGQBPG1",162,0)
 I JPTR="0" D  Q:(RESULT<0)
"RTN","MAGQBPG1",163,0)
 . S JPTR=""
"RTN","MAGQBPG1",164,0)
 . S GL=$S($D(^MAG(2005,IEN)):"^MAG(2005,",$D(^MAG(2005.1,IEN)):"^MAG(2005.1,",1:0)
"RTN","MAGQBPG1",165,0)
 . I GL=0 S RESULT="-1" Q
"RTN","MAGQBPG1",166,0)
 . S GL=$G(@(GL_IEN_",0)")) I $P(GL,U,2)="" S RESULT=-1 Q  ;*154 No file ref.
"RTN","MAGQBPG1",167,0)
 . I $D(^MAGQUEUE(2006.033,"B",$P(GL,U,2))) D  Q  ;*154 +fix
"RTN","MAGQBPG1",168,0)
 . . S RESULT=-2 Q  ;Don't clear the JB pointer if image is on an Offline Platter
"RTN","MAGQBPG1",169,0)
 . . Q
"RTN","MAGQBPG1",170,0)
 . Q
"RTN","MAGQBPG1",171,0)
 S:$D(^MAG(2005,IEN,NODE)) $P(^MAG(2005,IEN,NODE),U,PIECE)=JPTR
"RTN","MAGQBPG1",172,0)
 S:$D(^MAG(2005.1,IEN,NODE)) $P(^MAG(2005.1,IEN,NODE),U,PIECE)=JPTR
"RTN","MAGQBPG1",173,0)
 S RESULT="1"
"RTN","MAGQBPG1",174,0)
 Q
"RTN","MAGQBPG1",175,0)
VCUD(RESULT,VCPTR,EXT,IEN) ; RPC[MAGQ VCUD]
"RTN","MAGQBPG1",176,0)
 N TYPE,PIECE,NODE
"RTN","MAGQBPG1",177,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP"),RESULT="0"
"RTN","MAGQBPG1",178,0)
 S TYPE=$$FTYPE^MAGQBPRG(EXT,IEN)
"RTN","MAGQBPG1",179,0)
 S PIECE=$S(TYPE="BIG":1,TYPE="ABS":4,1:3)
"RTN","MAGQBPG1",180,0)
 S NODE=$S(TYPE="BIG":"FBIG",1:0)
"RTN","MAGQBPG1",181,0)
 S:VCPTR="0" VCPTR=""
"RTN","MAGQBPG1",182,0)
 S:$D(^MAG(2005,IEN,NODE)) $P(^MAG(2005,IEN,NODE),U,PIECE)=VCPTR
"RTN","MAGQBPG1",183,0)
 S:$D(^MAG(2005.1,IEN,NODE)) $P(^MAG(2005.1,IEN,NODE),U,PIECE)=VCPTR
"RTN","MAGQBPG1",184,0)
 S RESULT="1"
"RTN","MAGQBPG1",185,0)
 Q
"RTN","MAGQBPG1",186,0)
DFNIQ(RESULT,INPUT,SEND,PLACE,APP) ;
"RTN","MAGQBPG1",187,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",188,0)
 N LOC,CNT,Y,XMSUB
"RTN","MAGQBPG1",189,0)
 S U="^",RESULT="1"
"RTN","MAGQBPG1",190,0)
 S CNT=+$O(^TMP($J,"MAGQDFN",PLACE,APP,""),-1)
"RTN","MAGQBPG1",191,0)
 I CNT<2 D
"RTN","MAGQBPG1",192,0)
 . S LOC=$$KSP^XUPARAM("WHERE")
"RTN","MAGQBPG1",193,0)
 . S ^TMP($J,"MAGQDFN",PLACE,APP,1)="            SITE: "_LOC
"RTN","MAGQBPG1",194,0)
 . S ^TMP($J,"MAGQDFN",PLACE,APP,2)="            DATE: "_$$FMTE^XLFDT($$NOW^XLFDT)_" "_$G(^XMB("TIMEZONE"))
"RTN","MAGQBPG1",195,0)
 . S CNT=2 Q
"RTN","MAGQBPG1",196,0)
 I SEND="1" D
"RTN","MAGQBPG1",197,0)
 . S RESULT=$$SUBCHK^XMGAPI0(INPUT,0)
"RTN","MAGQBPG1",198,0)
 . Q:$P(RESULT,U)
"RTN","MAGQBPG1",199,0)
 . S XMSUB=INPUT
"RTN","MAGQBPG1",200,0)
 . N XMTEXT,INTERVAL,XMDUZ,XMZ
"RTN","MAGQBPG1",201,0)
 . S INTERVAL=$$GETMI^MAGQBUT5(XMSUB,PLACE)
"RTN","MAGQBPG1",202,0)
 . I $$FMADD^XLFDT(+$P(INTERVAL,"^",2),"",+$P(INTERVAL,U,1),"","")>$$NOW^XLFDT D  Q
"RTN","MAGQBPG1",203,0)
 . . K ^TMP($J,"MAGQDFN",PLACE,APP) Q
"RTN","MAGQBPG1",204,0)
 . S XMTEXT="^TMP($J,""MAGQDFN"",PLACE,APP)"
"RTN","MAGQBPG1",205,0)
 . D:$$PROD^XUPROD("1") ADDMG^MAGQBUT5(INPUT,.XMY,PLACE)
"RTN","MAGQBPG1",206,0)
 . S XMY(DUZ)="",XMDUZ=DUZ,XMY(XMDUZ)=""
"RTN","MAGQBPG1",207,0)
 . S XMID=$G(DUZ) S:'XMID XMID=.5
"RTN","MAGQBPG1",208,0)
 . S XMINSTR("FLAGS")="I",XMINSTR("FROM")="VistA Imaging "_APP
"RTN","MAGQBPG1",209,0)
 . D SENDMSG^XMXAPI(XMID,XMSUB,XMTEXT,.XMY,.XMINSTR,.XMZ,)
"RTN","MAGQBPG1",210,0)
 . K ^TMP($J,"MAGQDFN",PLACE,APP)
"RTN","MAGQBPG1",211,0)
 . I $G(XMERR) M XMERR=^TMP("XMERR",$J) K XMERR
"RTN","MAGQBPG1",212,0)
 . K ^TMP($J,"MAGQDFN",PLACE,APP)
"RTN","MAGQBPG1",213,0)
 . D UDMI^MAGQBUT5(INPUT,PLACE) Q
"RTN","MAGQBPG1",214,0)
 E  S CNT=CNT+1,^TMP($J,"MAGQDFN",PLACE,APP,CNT)=INPUT
"RTN","MAGQBPG1",215,0)
 S $P(RESULT,U)=$S($P(RESULT,U):"1",1:0)
"RTN","MAGQBPG1",216,0)
 K XMY,XMINSTR,XMID
"RTN","MAGQBPG1",217,0)
 Q
"RTN","MAGQBPG1",218,0)
SCAN(IEN,ORDER,GB) ; Find the next image spanning the Image and the Image Archive file
"RTN","MAGQBPG1",219,0)
 I IEN,GB="^MAG(2005,",$D(^MAG(2005.1,IEN)) D  Q
"RTN","MAGQBPG1",220,0)
 . S IEN=IEN,GB="^MAG(2005.1," Q
"RTN","MAGQBPG1",221,0)
 N I1,I2
"RTN","MAGQBPG1",222,0)
 I $G(ORDER)="F" D 
"RTN","MAGQBPG1",223,0)
 . S I1=$O(^MAG(2005,IEN)),I1=$S(I1:I1,1:"")
"RTN","MAGQBPG1",224,0)
 . S I2=$O(^MAG(2005.1,IEN)),I2=$S(I2:I2,1:"")
"RTN","MAGQBPG1",225,0)
 . I I1,'I2 S IEN=I1,GB="^MAG(2005," Q
"RTN","MAGQBPG1",226,0)
 . I I2,'I1 S IEN=I2,GB="^MAG(2005.1," Q
"RTN","MAGQBPG1",227,0)
 . S GB=$S(I1>I2:"^MAG(2005.1,",1:"^MAG(2005,")
"RTN","MAGQBPG1",228,0)
 . S IEN=$S(I1>I2:I2,1:I1)
"RTN","MAGQBPG1",229,0)
 . Q
"RTN","MAGQBPG1",230,0)
 E  D  ;Reverse
"RTN","MAGQBPG1",231,0)
 . S I1=$O(^MAG(2005,IEN),-1),I1=$S(I1:I1,1:"")
"RTN","MAGQBPG1",232,0)
 . S I2=$O(^MAG(2005.1,IEN),-1),I2=$S(I2:I2,1:"")
"RTN","MAGQBPG1",233,0)
 . I I1,'I2 S IEN=I1,GB="^MAG(2005," Q
"RTN","MAGQBPG1",234,0)
 . I I2,'I1 S IEN=I2,GB="^MAG(2005.1," Q
"RTN","MAGQBPG1",235,0)
 . S GB=$S(I1<I2:"^MAG(2005.1,",1:"^MAG(2005,")
"RTN","MAGQBPG1",236,0)
 . S IEN=$S(I1<I2:I2,1:I1)
"RTN","MAGQBPG1",237,0)
 . Q
"RTN","MAGQBPG1",238,0)
 S (IEN,MAGDA)=$S('IEN:"",1:IEN)
"RTN","MAGQBPG1",239,0)
 Q
"RTN","MAGQBPG1",240,0)
KLOG(GL,IEN,CORREC) ;
"RTN","MAGQBPG1",241,0)
 S CORREC=$P($P(GL,","),"^MAG(",2)_"~"_IEN
"RTN","MAGQBPG1",242,0)
 D LOGKILL(GL_IEN_")") ;Journal the nodes and content being killed
"RTN","MAGQBPG1",243,0)
 K @(GL_IEN_")")
"RTN","MAGQBPG1",244,0)
 Q
"RTN","MAGQBPG1",245,0)
LOGKILL(REC) ; Log the content into the ^TMP global error log rpc
"RTN","MAGQBPG1",246,0)
 N NODE,NODE1,NODE2,NODE3,TMP,TMP1
"RTN","MAGQBPG1",247,0)
 S NODE=""
"RTN","MAGQBPG1",248,0)
 F  S NODE=$O(@REC@(NODE)) Q:NODE=""  D
"RTN","MAGQBPG1",249,0)
 . S TMP=$G(@REC@(NODE)) I TMP]"" S TMP1=$P(REC,")")_","_NODE_")="_TMP D ELOGV(TMP1)
"RTN","MAGQBPG1",250,0)
 . S NODE1="" F  S NODE1=$O(@REC@(NODE,NODE1)) Q:NODE1=""  D
"RTN","MAGQBPG1",251,0)
 . . S TMP=$G(@REC@(NODE,NODE1))  I TMP]"" S TMP1=$P(REC,")")_","_NODE_","_NODE1_")="_TMP D ELOGV(TMP1)
"RTN","MAGQBPG1",252,0)
 . . S NODE2="" F  S NODE2=$O(@REC@(NODE,NODE1,NODE2)) Q:NODE2=""  D
"RTN","MAGQBPG1",253,0)
 . . . S TMP=$G(@REC@(NODE,NODE1,NODE2)) I TMP]"" S TMP1=$P(REC,")")_","_NODE_","_NODE1_","_NODE2_")"_"="_TMP D ELOGV(TMP1)
"RTN","MAGQBPG1",254,0)
 . . . S NODE3="" F  S NODE3=$O(@REC@(NODE,NODE1,NODE2,NODE3)) Q:NODE3=""  D
"RTN","MAGQBPG1",255,0)
 . . . . S TMP=$G(@REC@(NODE,NODE1,NODE2,NODE3)) S TMP1=$P(REC,")")_","_NODE_","_NODE1_","_NODE2_","_NODE3_")="_TMP D ELOGV(TMP1)
"RTN","MAGQBPG1",256,0)
 . . . . Q
"RTN","MAGQBPG1",257,0)
 . . . Q
"RTN","MAGQBPG1",258,0)
 . . Q
"RTN","MAGQBPG1",259,0)
 . Q
"RTN","MAGQBPG1",260,0)
 Q
"RTN","MAGQBPG1",261,0)
ELOGV(MESG,LIMIT) ;TMP Log 
"RTN","MAGQBPG1",262,0)
 N INDX
"RTN","MAGQBPG1",263,0)
 N X S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",264,0)
 S INDX=+$O(^TMP("MAGQ",$J,"BPV",""),-1)+1
"RTN","MAGQBPG1",265,0)
 S ^TMP("MAGQ",$J,"BPV",INDX)=MESG
"RTN","MAGQBPG1",266,0)
 Q
"RTN","MAGQBPG1",267,0)
ELOGRV(RESULT,LIMIT) ; [MAGQ LOGV] Error log report and purge
"RTN","MAGQBPG1",268,0)
 ; Please test this
"RTN","MAGQBPG1",269,0)
 N FN,INDX,CNT
"RTN","MAGQBPG1",270,0)
 N X S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",271,0)
 S CNT=0,INDX=""
"RTN","MAGQBPG1",272,0)
 F  S INDX=$O(^TMP("MAGQ",$J,"BPV",INDX)) Q:INDX'?1N.N  Q:CNT=LIMIT  D
"RTN","MAGQBPG1",273,0)
 . S CNT=CNT+1,RESULT(CNT)=^TMP("MAGQ",$J,"BPV",INDX)
"RTN","MAGQBPG1",274,0)
 . K ^TMP("MAGQ",$J,"BPV",INDX)
"RTN","MAGQBPG1",275,0)
 . Q
"RTN","MAGQBPG1",276,0)
 S RESULT(0)=CNT
"RTN","MAGQBPG1",277,0)
 S INDX=$O(^TMP("MAGQ",$J,"BPV",""))
"RTN","MAGQBPG1",278,0)
 I INDX?1N.N S RESULT(0)=RESULT(0)_U_"MORE"
"RTN","MAGQBPG1",279,0)
 Q
"RTN","MAGQBTM")
0^1^B87348923
"RTN","MAGQBTM",1,0)
MAGQBTM ;WOIFO/RMP/JL - REMOTE Task SERVER Program ; 20 April 2017 10:41 AM
"RTN","MAGQBTM",2,0)
 ;;3.0;IMAGING;**1,7,8,20,81,39,135,186**;Mar 19, 2002;Build 23;April 20, 2017
"RTN","MAGQBTM",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQBTM",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBTM",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBTM",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBTM",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBTM",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBTM",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBTM",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBTM",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBTM",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBTM",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBTM",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBTM",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBTM",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBTM",17,0)
 ;;
"RTN","MAGQBTM",18,0)
 Q
"RTN","MAGQBTM",19,0)
ENTRY(RESULT,WSTAT,PROCESS) ; RPC[MAGQ ABP]
"RTN","MAGQBTM",20,0)
 N X,SYSIEN,SYSNAME,NODE,INDX,CNT,PROC,%,QPTR,QCNT,VERS,EXEDATE,WSOS,PLACE,VOK,EXDATE
"RTN","MAGQBTM",21,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBTM",22,0)
 S (SYSIEN,CNT)=0,SYSNAME="",PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2))),VOK=""
"RTN","MAGQBTM",23,0)
 S $P(RESULT(0),U,6)=$D(^XUSEC("MAG SYSTEM",DUZ))
"RTN","MAGQBTM",24,0)
 Q:'$P(RESULT(0),U,6)
"RTN","MAGQBTM",25,0)
 S VERS=$P(WSTAT,U,2)
"RTN","MAGQBTM",26,0)
 S WSTAT=$P(WSTAT,U)
"RTN","MAGQBTM",27,0)
 S SYSIEN=$O(^MAG(2006.8,"C",PLACE,WSTAT,""))
"RTN","MAGQBTM",28,0)
 I 'SYSIEN S SYSIEN=$O(^MAG(2006.8,"C",PLACE,$$UPPER^MAGQE4(WSTAT),""))
"RTN","MAGQBTM",29,0)
 I 'SYSIEN D
"RTN","MAGQBTM",30,0)
 . N TRY
"RTN","MAGQBTM",31,0)
 . F TRY=1:1:$L(WSTAT,".") D  Q:SYSIEN?1.N
"RTN","MAGQBTM",32,0)
 . . S SYSIEN=$O(^MAG(2006.8,"C",PLACE,$P(WSTAT,".",TRY),""))
"RTN","MAGQBTM",33,0)
 . . I 'SYSIEN S SYSIEN=$O(^MAG(2006.8,"C",PLACE,$$UPPER^MAGQE4($P(WSTAT,".",TRY)),""))
"RTN","MAGQBTM",34,0)
 Q:SYSIEN=""
"RTN","MAGQBTM",35,0)
 S VERS=$P(VERS,".",1,2)_"P"_$P(VERS,".",3)
"RTN","MAGQBTM",36,0)
 D VOKR^MAGQBUT4(.VOK,VERS)
"RTN","MAGQBTM",37,0)
 Q:'$P(VOK,U)
"RTN","MAGQBTM",38,0)
 S NODE=^MAG(2006.8,SYSIEN,0)
"RTN","MAGQBTM",39,0)
 S SYSNAME=$P(NODE,U)
"RTN","MAGQBTM",40,0)
 I SYSNAME="" D  Q
"RTN","MAGQBTM",41,0)
 . S $P(RESULT(0),U,1,2)="-1^No Background Processor parameters on system"
"RTN","MAGQBTM",42,0)
 I $P(NODE,U,12)'=1 D  Q
"RTN","MAGQBTM",43,0)
 . S $P(RESULT(0),U,1,2)="-1^Not assigned as a Background Processor"
"RTN","MAGQBTM",44,0)
 F PROC="ABSTRACT;13","JUKEBOX;14","JBTOHD;15","DELETE;23","PREFET;16","GCC;18","IMPORT;17" D  Q:$P(RESULT(0),U,1)="-1"
"RTN","MAGQBTM",45,0)
 . N PIECE,NAME
"RTN","MAGQBTM",46,0)
 . I $$UBPW^MAGQBUT1(SYSNAME,PROC) D  Q
"RTN","MAGQBTM",47,0)
 . . S $P(RESULT(0),U,1,2)="-1^This BP: "_SYSNAME_" has a co-assigned queue: "_$P(PROC,";")
"RTN","MAGQBTM",48,0)
 . S NAME=$P(PROC,";")
"RTN","MAGQBTM",49,0)
 . S PIECE=$P(PROC,";",2)
"RTN","MAGQBTM",50,0)
 . I $P(NODE,U,PIECE)="1" D
"RTN","MAGQBTM",51,0)
 . . N QCNT,QPTR
"RTN","MAGQBTM",52,0)
 . . D ADD^MAGBAPI(0,NAME,PLACE)
"RTN","MAGQBTM",53,0)
 . . S QPTR=$O(^MAGQUEUE(2006.031,"C",PLACE,NAME,""))
"RTN","MAGQBTM",54,0)
 . . S QCNT=$P($G(^MAGQUEUE(2006.031,+QPTR,0)),U,3)
"RTN","MAGQBTM",55,0)
 . . S CNT=CNT+1
"RTN","MAGQBTM",56,0)
 . . S RESULT(CNT)=NAME_U_QCNT_U_(+$P($G(^MAGQUEUE(2006.031,+QPTR,0)),U,5)-QCNT)
"RTN","MAGQBTM",57,0)
 . . I +$P(RESULT(CNT),U,3)<0 D  ; Refresh the queue count if negative
"RTN","MAGQBTM",58,0)
 . . . D QCNT^MAGQBUT4("",PLACE,NAME)
"RTN","MAGQBTM",59,0)
 . . . S RESULT(CNT)=NAME_U_QCNT_U_(+$P($G(^MAGQUEUE(2006.031,+QPTR,0)),U,5)-QCNT)
"RTN","MAGQBTM",60,0)
 . . . Q
"RTN","MAGQBTM",61,0)
 . . Q
"RTN","MAGQBTM",62,0)
 . Q
"RTN","MAGQBTM",63,0)
 Q:$P(RESULT(0),U,1)="-1"
"RTN","MAGQBTM",64,0)
 S $P(RESULT(0),U,1,5)="0^BP List^PID: "_$$BASE^XLFUTL($J,10,16)_"^"_SYSNAME_U_WSTAT
"RTN","MAGQBTM",65,0)
 Q
"RTN","MAGQBTM",66,0)
GETQUE(RESULT,ACTION) ; RPC[MAGQ GET]
"RTN","MAGQBTM",67,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBTM",68,0)
 N PLACE
"RTN","MAGQBTM",69,0)
 D @(ACTION_"(.RESULT)")
"RTN","MAGQBTM",70,0)
 I +RESULT<0 D  ; Update queue status and increment the Queue pointer if the queue cannot be processed
"RTN","MAGQBTM",71,0)
 . N PLACE S PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBTM",72,0)
 . D QSTAT($P(RESULT,U,2),$P(RESULT,U,3),ACTION,.PLACE)
"RTN","MAGQBTM",73,0)
 . D QPTER(ACTION,$P(RESULT,U,2),.PLACE)
"RTN","MAGQBTM",74,0)
 . Q
"RTN","MAGQBTM",75,0)
 Q
"RTN","MAGQBTM",76,0)
ABSTRACT(RESULT) ;
"RTN","MAGQBTM",77,0)
 D DEQUEUE("ABSTRACT",.RESULT) Q
"RTN","MAGQBTM",78,0)
JUKEBOX(RESULT) ;
"RTN","MAGQBTM",79,0)
 D DEQUEUE("JUKEBOX",.RESULT) Q
"RTN","MAGQBTM",80,0)
JBTOHD(RESULT) ;
"RTN","MAGQBTM",81,0)
 D DEQUEUE("JBTOHD",.RESULT) Q
"RTN","MAGQBTM",82,0)
GCC(RESULT) ;
"RTN","MAGQBTM",83,0)
 D DEQUEUE("GCC",.RESULT) Q
"RTN","MAGQBTM",84,0)
DELETE(RESULT) ;
"RTN","MAGQBTM",85,0)
 D DEQUEUE("DELETE",.RESULT) Q
"RTN","MAGQBTM",86,0)
PREFET(RESULT) ;
"RTN","MAGQBTM",87,0)
 D DEQUEUE("PREFET",.RESULT) Q
"RTN","MAGQBTM",88,0)
IMPORT(RESULT) ;
"RTN","MAGQBTM",89,0)
 D DEQUEUE("IMPORT",.RESULT) Q
"RTN","MAGQBTM",90,0)
DEQUEUE(QUE,RESULT) ;
"RTN","MAGQBTM",91,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBTM",92,0)
 N QPTR,QPTR2,ROU,MAGIEN,ZNODE,MSG,IMQUE,PLACE
"RTN","MAGQBTM",93,0)
 S PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBTM",94,0)
 S QPTR2=$O(^MAGQUEUE(2006.031,"C",PLACE,QUE,""))
"RTN","MAGQBTM",95,0)
 S QPTR=$S(QPTR2:$P(^MAGQUEUE(2006.031,QPTR2,0),U,2),1:"")
"RTN","MAGQBTM",96,0)
 S QPTR=$O(^MAGQUEUE(2006.03,"C",PLACE,QUE,QPTR))
"RTN","MAGQBTM",97,0)
 I QPTR="" D  Q
"RTN","MAGQBTM",98,0)
 . S RESULT="0"_U_QPTR2_U_"No "_QUE_" "_QPTR2_" to process."
"RTN","MAGQBTM",99,0)
 D QSTAT(QPTR,QUE_" in progress.",QUE,.PLACE)
"RTN","MAGQBTM",100,0)
 S ZNODE=$G(^MAGQUEUE(2006.03,QPTR,0))
"RTN","MAGQBTM",101,0)
 I ZNODE="" S RESULT=-101_U_QPTR_U_"Queue Record does not exist" Q
"RTN","MAGQBTM",102,0)
 I QUE="IMPORT" D ENTRY^MAGQBIM(QPTR,QUE,QPTR2,ZNODE,.RESULT) Q
"RTN","MAGQBTM",103,0)
 S MAGIEN=$P(ZNODE,"^",7)
"RTN","MAGQBTM",104,0)
 I ("^DELETE^JUKEBOX^")'[(U_QUE_U),(('(+MAGIEN))!('$D(^MAG(2005,+MAGIEN,0)))!($P(ZNODE,U)'=QUE)) D  Q
"RTN","MAGQBTM",105,0)
 . I $D(^MAG(2005.1,+MAGIEN,0)) D
"RTN","MAGQBTM",106,0)
 . . S MSG="Image Record Deleted and in archive file."
"RTN","MAGQBTM",107,0)
 . E  S MSG="No valid image file number to process."
"RTN","MAGQBTM",108,0)
 . S RESULT=-101_U_QPTR_U_MSG
"RTN","MAGQBTM",109,0)
 S ROU=$$RESET(QUE)
"RTN","MAGQBTM",110,0)
 I ROU="" S RESULT="-1"_U_QPTR_U_QUE_" Is an inactive process" Q
"RTN","MAGQBTM",111,0)
 D @("ENTRY^"_ROU_"(.RESULT,QPTR)")
"RTN","MAGQBTM",112,0)
 Q
"RTN","MAGQBTM",113,0)
QSTAT(QPTR,MESSAGE,ACTION,PLACE) ;Update the Queue status
"RTN","MAGQBTM",114,0)
 N ZNODE,MAGTIME
"RTN","MAGQBTM",115,0)
 Q:QPTR=""
"RTN","MAGQBTM",116,0)
 S MESSAGE=$TR(MESSAGE,":;<>.?/\'()*^%$#@!0123456789","")
"RTN","MAGQBTM",117,0)
 Q:'$D(^MAGQUEUE(2006.03,QPTR,0))
"RTN","MAGQBTM",118,0)
 S ZNODE=$G(^MAGQUEUE(2006.03,QPTR,0))
"RTN","MAGQBTM",119,0)
 S MAGTIME=$$NOW^XLFDT
"RTN","MAGQBTM",120,0)
 S:'$G(PLACE) PLACE=$$QPLACE(ZNODE,QPTR)
"RTN","MAGQBTM",121,0)
 Q:'PLACE
"RTN","MAGQBTM",122,0)
 I $P(ZNODE,U,5)]"" D
"RTN","MAGQBTM",123,0)
 . K ^MAGQUEUE(2006.03,"D",PLACE,$P(ZNODE,U),$E($P(ZNODE,U,5),1,30),QPTR) Q
"RTN","MAGQBTM",124,0)
 S ^MAGQUEUE(2006.03,"D",PLACE,$P(ZNODE,U),$E(MESSAGE,1,30),QPTR)=""
"RTN","MAGQBTM",125,0)
 S $P(^MAGQUEUE(2006.03,QPTR,0),U,5,6)=$P(MESSAGE,U)_U_MAGTIME
"RTN","MAGQBTM",126,0)
 I ACTION["IMPORT" D STAT^MAGQBIM($S($P(ZNODE,U,11)?1N.N:$P(ZNODE,U,11),1:QPTR),MAGTIME,MESSAGE)
"RTN","MAGQBTM",127,0)
 Q
"RTN","MAGQBTM",128,0)
QPLACE(QNODE,PTR) ; Seek alternate PLACE values and update the Queue
"RTN","MAGQBTM",129,0)
 N IEN,VALUE,ACQ
"RTN","MAGQBTM",130,0)
 S VALUE=""
"RTN","MAGQBTM",131,0)
 I +$P(QNODE,U,12) D  Q VALUE
"RTN","MAGQBTM",132,0)
 . S VALUE=+$P(QNODE,U,12) Q
"RTN","MAGQBTM",133,0)
 S IEN=$P(QNODE,U,7) ; try the Image acquisition site
"RTN","MAGQBTM",134,0)
 I IEN?1N.N D
"RTN","MAGQBTM",135,0)
 . S ACQ=+$P($G(^MAG(2005,IEN,100)),U,3)
"RTN","MAGQBTM",136,0)
 . S:'ACQ ACQ=+$P($G(^MAG(2005.1,IEN,100)),U,3)
"RTN","MAGQBTM",137,0)
 . S:ACQ VALUE=$$PLACE^MAGBAPI(ACQ) Q
"RTN","MAGQBTM",138,0)
 S:'VALUE VALUE=$$PLACE^MAGBAPI(+$G(DUZ(2))) ; else the BP User
"RTN","MAGQBTM",139,0)
 S:VALUE $P(^MAGQUEUE(2006.03,PTR,0),U,12)=VALUE
"RTN","MAGQBTM",140,0)
 Q VALUE
"RTN","MAGQBTM",141,0)
QPTER(QUEUE,QPTR,PLACE) ; Conditionally advance the queue pointer & decrement the active queue count
"RTN","MAGQBTM",142,0)
 N QREC,PREV,PNODE
"RTN","MAGQBTM",143,0)
 I 'PLACE D  Q:'PLACE
"RTN","MAGQBTM",144,0)
 . S PLACE=$P($G(^MAGQUEUE(2006.03,QPTR,0)),U,12)
"RTN","MAGQBTM",145,0)
 . S PLACE=$S(PLACE:PLACE,1:$$PLACE^MAGBAPI(+$G(DUZ(2))))
"RTN","MAGQBTM",146,0)
 . Q
"RTN","MAGQBTM",147,0)
 S QREC=$O(^MAGQUEUE(2006.031,"C",PLACE,QUEUE,""))
"RTN","MAGQBTM",148,0)
 S PREV=$S(QREC:$P(^MAGQUEUE(2006.031,QREC,0),U,2),1:"")
"RTN","MAGQBTM",149,0)
 I PREV'=QPTR D  Q
"RTN","MAGQBTM",150,0)
 . D ADD^MAGBAPI(-1,QUEUE,PLACE)
"RTN","MAGQBTM",151,0)
 . L +^MAGQUEUE(2006.031,QREC,0):1E9
"RTN","MAGQBTM",152,0)
 . S $P(^MAGQUEUE(2006.031,QREC,0),U,2)=QPTR,$P(^MAGQUEUE(2006.031,QREC,0),U,6)=$$NOW^XLFDT
"RTN","MAGQBTM",153,0)
 . L -^MAGQUEUE(2006.031,QREC,0)
"RTN","MAGQBTM",154,0)
 . Q
"RTN","MAGQBTM",155,0)
 D ADD^MAGBAPI(0,QUEUE,PLACE)  ; Else reset the active queue count
"RTN","MAGQBTM",156,0)
 Q
"RTN","MAGQBTM",157,0)
RESET(QUEUE) ; Set Routine parameter
"RTN","MAGQBTM",158,0)
 Q:QUEUE="ABSTRACT" "MAGQBAB"
"RTN","MAGQBTM",159,0)
 Q:QUEUE="JUKEBOX" "MAGQBJB"
"RTN","MAGQBTM",160,0)
 Q:QUEUE="JBTOHD" "MAGQBJH"
"RTN","MAGQBTM",161,0)
 Q:QUEUE="DELETE" "MAGQBD"
"RTN","MAGQBTM",162,0)
 Q:QUEUE="PREFET" "MAGQBJH"
"RTN","MAGQBTM",163,0)
 Q:QUEUE="IMPORT" "MAGQBIM"
"RTN","MAGQBTM",164,0)
 Q:QUEUE="GCC" "MAGQBGCC"
"RTN","MAGQBTM",165,0)
 Q ""
"RTN","MAGQBTM",166,0)
QUPDTE(RESULT,QPTR,UPDATE) ;RPC[MAGQ QUD]
"RTN","MAGQBTM",167,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBTM",168,0)
 N NODE,STAT,TYPE,VPTR,MPTR,IEN,IDFN,MSG,PLACE,DA
"RTN","MAGQBTM",169,0)
 S RESULT="0^No Queue entry #"_$G(QPTR) Q:'$G(QPTR)  S NODE=$G(^MAGQUEUE(2006.03,QPTR,0)) I NODE="" Q   ;P186 race issue, queue entry not exist
"RTN","MAGQBTM",170,0)
 S PLACE=$P(NODE,U,12)
"RTN","MAGQBTM",171,0)
 S RESULT="1^QUEUE UPDATE COMPLETE"
"RTN","MAGQBTM",172,0)
 S STAT=$P(UPDATE,U)
"RTN","MAGQBTM",173,0)
 S TYPE=$P(NODE,U)
"RTN","MAGQBTM",174,0)
 S MSG=$S($P(UPDATE,U,2)="":TYPE_" Process Error",1:$P(UPDATE,U,2))
"RTN","MAGQBTM",175,0)
 D QSTAT(QPTR,MSG,TYPE,.PLACE)
"RTN","MAGQBTM",176,0)
 D QPTER(TYPE,QPTR,PLACE)
"RTN","MAGQBTM",177,0)
 I STAT<0 Q
"RTN","MAGQBTM",178,0)
 I "^DELETE^"[("^"_TYPE_"^") D DQUE^MAGQBUT2(QPTR) Q
"RTN","MAGQBTM",179,0)
 I "^IMPORT^"[("^"_TYPE_"^") D DQUE^MAGQBUT2(QPTR) Q
"RTN","MAGQBTM",180,0)
 S VPTR=$P(UPDATE,U,3)
"RTN","MAGQBTM",181,0)
 I VPTR?1.N D
"RTN","MAGQBTM",182,0)
 . S MPTR=$P(NODE,U,7)
"RTN","MAGQBTM",183,0)
 . I "^ABSTRACT^"[("^"_TYPE_"^") D  Q
"RTN","MAGQBTM",184,0)
 . . S $P(^MAG(2005,MPTR,0),U,4)=VPTR
"RTN","MAGQBTM",185,0)
 . . S X=$$JUKEBOX^MAGBAPI(MPTR,PLACE)
"RTN","MAGQBTM",186,0)
 . . D DQUE^MAGQBUT2(QPTR) Q
"RTN","MAGQBTM",187,0)
 . I ("^JBTOHD^"[("^"_TYPE_"^"))!("^PREFET^"[("^"_TYPE_"^")) D  Q
"RTN","MAGQBTM",188,0)
 . . I "^FULL^"[$P(NODE,U,8) S $P(^MAG(2005,MPTR,0),U,3)=VPTR
"RTN","MAGQBTM",189,0)
 . . I "^ABSTRACT^"[$P(NODE,U,8) S $P(^MAG(2005,MPTR,0),U,4)=VPTR
"RTN","MAGQBTM",190,0)
 . . I "^BIG^"[$P(NODE,U,8) S $P(^MAG(2005,MPTR,"FBIG"),U)=VPTR
"RTN","MAGQBTM",191,0)
 . . D DQUE^MAGQBUT2(QPTR) Q
"RTN","MAGQBTM",192,0)
 . I "^JUKEBOX^"[("^"_TYPE_"^") D  Q 
"RTN","MAGQBTM",193,0)
 . . I $P(UPDATE,U,2)["BIG" D  Q
"RTN","MAGQBTM",194,0)
 . . . S:$D(^MAG(2005,MPTR)) $P(^MAG(2005,MPTR,"FBIG"),U,2)=VPTR
"RTN","MAGQBTM",195,0)
 . . . S:$D(^MAG(2005.1,MPTR)) $P(^MAG(2005.1,MPTR,"FBIG"),U,2)=VPTR
"RTN","MAGQBTM",196,0)
 . . . D DQUE^MAGQBUT2(QPTR) Q
"RTN","MAGQBTM",197,0)
 . . E  D
"RTN","MAGQBTM",198,0)
 . . . S:$D(^MAG(2005,MPTR)) $P(^MAG(2005,MPTR,0),U,5)=VPTR
"RTN","MAGQBTM",199,0)
 . . . S:$D(^MAG(2005.1,MPTR)) $P(^MAG(2005.1,MPTR,0),U,5)=VPTR
"RTN","MAGQBTM",200,0)
 . . . D DQUE^MAGQBUT2(QPTR) Q
"RTN","MAGQBTM",201,0)
 . . Q
"RTN","MAGQBTM",202,0)
 . I "^GCC^"[("^"_TYPE_"^") D  Q
"RTN","MAGQBTM",203,0)
 . . S FDA(2005.01,"+1,"_MPTR_",",.01)=VPTR
"RTN","MAGQBTM",204,0)
 . . S FDA(2005.01,"+1,"_MPTR_",",1)=$$NOW^XLFDT
"RTN","MAGQBTM",205,0)
 . . S FDA(2005.01,"+1,"_MPTR_",",2)=$P($$TRIM^MAGQBUT4($P(UPDATE,U,2))," ")
"RTN","MAGQBTM",206,0)
 . . D UPDATE^DIE("U","FDA","","MAGIMP")
"RTN","MAGQBTM",207,0)
 . . K FDA
"RTN","MAGQBTM",208,0)
 . . S IDFN=$P(^MAG(2005,MPTR,0),U,7)
"RTN","MAGQBTM",209,0)
 . . D ENTRY^MAGLOG("EXPORT->"_$P($G(^MAG(2005.2,VPTR,0)),U,2),$P(NODE,U,2),MPTR,"Document Imaging",IDFN,0)
"RTN","MAGQBTM",210,0)
 . . D DQUE^MAGQBUT2(QPTR) Q
"RTN","MAGQBTM",211,0)
 . Q
"RTN","MAGQBTM",212,0)
 Q
"RTN","MAGQBTM",213,0)
REQUE(RESULT,QPTR) ;
"RTN","MAGQBTM",214,0)
 ; RPC[MAGQ REQ]
"RTN","MAGQBTM",215,0)
 N PROC,NODE,INDX,PARAM,OPDUZ,STATUS,TRACKID,PLACE,X
"RTN","MAGQBTM",216,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBTM",217,0)
 S INDX=$$TRIM^MAGQBUT4(QPTR),TRACKID=0
"RTN","MAGQBTM",218,0)
 S NODE=$G(^MAGQUEUE(2006.03,INDX,0))
"RTN","MAGQBTM",219,0)
 Q:NODE']""
"RTN","MAGQBTM",220,0)
 S PLACE=$P(NODE,U,12)
"RTN","MAGQBTM",221,0)
 Q:'PLACE
"RTN","MAGQBTM",222,0)
 S PROC=$P(NODE,U),STATUS=$P(NODE,U,5)
"RTN","MAGQBTM",223,0)
 I PROC'="IMPORT" D
"RTN","MAGQBTM",224,0)
 . D RQP(PROC,NODE,.PARAM)
"RTN","MAGQBTM",225,0)
 . D DQUE^MAGQBUT2(INDX)
"RTN","MAGQBTM",226,0)
 . S @("RESULT=$$"_PROC_"^MAGBAPI(PARAM,PLACE)")
"RTN","MAGQBTM",227,0)
 . Q
"RTN","MAGQBTM",228,0)
 E  D  Q  ;IMPORT - Doesn't De-queue Import and Session file
"RTN","MAGQBTM",229,0)
 . S $P(PARAM,U,3)=+$P(NODE,U,9)+1
"RTN","MAGQBTM",230,0)
 . S $P(PARAM,U,4)=$S($P(NODE,U,11)?1N.N:$P(NODE,U,11),1:QPTR)
"RTN","MAGQBTM",231,0)
 . D TIDL^MAGQBIM($S($P(NODE,U,11)?1N.N:$P(NODE,U,11),1:QPTR),PROC,.TRACKID)
"RTN","MAGQBTM",232,0)
 . Q:TRACKID=0
"RTN","MAGQBTM",233,0)
 . S @("RESULT=$$"_PROC_"^MAGBAPI(PARAM,$P(NODE,U,10),TRACKID,PLACE)")
"RTN","MAGQBTM",234,0)
 . D DQUE^MAGQBUT2(INDX,"1")
"RTN","MAGQBTM",235,0)
 . Q
"RTN","MAGQBTM",236,0)
 Q
"RTN","MAGQBTM",237,0)
RQP(P,N,PAR) ;
"RTN","MAGQBTM",238,0)
 N P1,P2,P3,P4
"RTN","MAGQBTM",239,0)
 I ("^JBTOHD^PREFET^")[P S P1=$P(N,U,7),P2=$P(N,U,8),P3=+$P(N,U,9)+1,PAR=P1_U_P2_U_P3 Q
"RTN","MAGQBTM",240,0)
 I P["DELETE" S P1=$P(N,U,10),P2=+$P(N,U,9)+1,PAR=P2_U_P1 Q
"RTN","MAGQBTM",241,0)
 I P["GCC" D  Q
"RTN","MAGQBTM",242,0)
 . S P1=$P(N,U,7),P2=$P(N,U,10),P3=$P(N,U,11),P4=$P(N,U,9)+1,PAR=P1_U_P2_U_P3_U_P4 Q
"RTN","MAGQBTM",243,0)
 S P1=$P(N,U,7)_"^^",P2=+$P(N,U,9)+1,PAR=P1_P2 ;JUKEBOX + ABSTRACT
"RTN","MAGQBTM",244,0)
 Q
"RTN","MAGQBTM",245,0)
ERR ;
"RTN","MAGQBTM",246,0)
 N ERRXX
"RTN","MAGQBTM",247,0)
 S ERRXX=$$EC^%ZOSV
"RTN","MAGQBTM",248,0)
 D ^%ZTER
"RTN","MAGQBTM",249,0)
 D ^XUSCLEAN
"RTN","MAGQBTM",250,0)
 Q
"RTN","MAGQBUT2")
0^3^B103758000
"RTN","MAGQBUT2",1,0)
MAGQBUT2 ;WOIFO/SRR/RMP/JL - IMAGE SITE PARAMETERS COMPANION ; 05 May 2017 3:06 PM
"RTN","MAGQBUT2",2,0)
 ;;3.0;IMAGING;**7,8,20,81,39,186**;Mar 19, 2002;Build 23;Mar 08, 2011
"RTN","MAGQBUT2",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQBUT2",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT2",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBUT2",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBUT2",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBUT2",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBUT2",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBUT2",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBUT2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBUT2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBUT2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBUT2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBUT2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBUT2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT2",17,0)
 ;;
"RTN","MAGQBUT2",18,0)
MAGSYS(LIST) ;
"RTN","MAGQBUT2",19,0)
 ; RPC[MAGQ SYSTEM]
"RTN","MAGQBUT2",20,0)
 N VAIEN,NODE,MGIEN,UNAME,TDATE
"RTN","MAGQBUT2",21,0)
 S MGIEN=$$FIND1^DIC(3.8,"","MX","MAG SERVER","","","ERR")
"RTN","MAGQBUT2",22,0)
 S VAIEN=0
"RTN","MAGQBUT2",23,0)
 F  S VAIEN=$O(^XUSEC("MAG SYSTEM",VAIEN)) Q:VAIEN'?1N.N  D
"RTN","MAGQBUT2",24,0)
 . S UNAME=$$GET1^DIQ(200,VAIEN,.01)
"RTN","MAGQBUT2",25,0)
 . Q:UNAME=""
"RTN","MAGQBUT2",26,0)
 . ;CHECK FOR TERMINATION DATE
"RTN","MAGQBUT2",27,0)
 . S TDATE=$$GET1^DIQ(200,VAIEN,9.2)
"RTN","MAGQBUT2",28,0)
 . Q:((TDATE'="")&(TDATE<$$NOW^XLFDT))
"RTN","MAGQBUT2",29,0)
 . ;the next line screens existing 'MAG SERVER' members
"RTN","MAGQBUT2",30,0)
 . I MGIEN?1N.N,$$FIND1^DIC(3.81,","_MGIEN_",","QA",VAIEN,"","","ERR") Q
"RTN","MAGQBUT2",31,0)
 . S LIST(VAIEN)=VAIEN_"^"_UNAME
"RTN","MAGQBUT2",32,0)
 Q
"RTN","MAGQBUT2",33,0)
IMPAR(RESULT,QIEN) ; Import Array
"RTN","MAGQBUT2",34,0)
 N INDX,CNT
"RTN","MAGQBUT2",35,0)
 S (INDX,CNT)=0
"RTN","MAGQBUT2",36,0)
 F  S INDX=$O(^MAG(2006.034,QIEN,1,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQBUT2",37,0)
 . S CNT=CNT+1
"RTN","MAGQBUT2",38,0)
 . S RESULT(CNT)=$G(^MAG(2006.034,QIEN,1,INDX,0))
"RTN","MAGQBUT2",39,0)
 I CNT<1 S RESULT(0)="0^Corrupted Import Array"
"RTN","MAGQBUT2",40,0)
 E  S RESULT(0)="1"
"RTN","MAGQBUT2",41,0)
 Q
"RTN","MAGQBUT2",42,0)
CHKIMG(IEN) ;
"RTN","MAGQBUT2",43,0)
 ; Given an Image IEN, return:
"RTN","MAGQBUT2",44,0)
 ;   1: Case # or accession #
"RTN","MAGQBUT2",45,0)
 ;   2: Parent application~IEN
"RTN","MAGQBUT2",46,0)
 ;   3: Application DFN
"RTN","MAGQBUT2",47,0)
 ;   4: Image DFN
"RTN","MAGQBUT2",48,0)
 ;   5: Flag: true = all DFNs in images in same parent group are identical
"RTN","MAGQBUT2",49,0)
 ;   6: Image object Class
"RTN","MAGQBUT2",50,0)
 ;
"RTN","MAGQBUT2",51,0)
 ; PF: Parent Data file number
"RTN","MAGQBUT2",52,0)
 ; PT(): Parent file data dictionary
"RTN","MAGQBUT2",53,0)
 ; PD0: Parent (Global root) IEN (D0)
"RTN","MAGQBUT2",54,0)
 ; PD1:  Lab Parent Global Root (D1)
"RTN","MAGQBUT2",55,0)
 ; PD2:  Parent Data File Image Pointer
"RTN","MAGQBUT2",56,0)
 ; T():  Error types
"RTN","MAGQBUT2",57,0)
 ; IDFN: Image file entry DFN
"RTN","MAGQBUT2",58,0)
 ; PDFN: Parent file DFN
"RTN","MAGQBUT2",59,0)
 ; GRG:  virtual Parent File Image Multiple
"RTN","MAGQBUT2",60,0)
 ; IOR: Image Object Referenced (by parent)
"RTN","MAGQBUT2",61,0)
 N GF,GP,G0,GR,GRD,GRG,GR0,IDFN,IENV,P0,PD0,PD1,PD2,PF,PT,X,X0,X2,N0,N1,R,T,GPDFN,PACS,IOR,APR,I,PDFN
"RTN","MAGQBUT2",62,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT2",63,0)
 S R="^^^^^"
"RTN","MAGQBUT2",64,0)
 S T(1)="No Image ptr in AP"
"RTN","MAGQBUT2",65,0)
 S T(2)="GP has no Images"
"RTN","MAGQBUT2",66,0)
 S T(3)="Conflicting AP & Image DFNs"
"RTN","MAGQBUT2",67,0)
 S T(4)="Invalid Image Ptr to AP"
"RTN","MAGQBUT2",68,0)
 S T(5)="Conflicting GP and GO DFN"
"RTN","MAGQBUT2",69,0)
 S T(6)="GP & GO AP Mismatch"
"RTN","MAGQBUT2",70,0)
 S T(7)="GP Missing GO ptr"
"RTN","MAGQBUT2",71,0)
 S T(8)="No AP Ptr"
"RTN","MAGQBUT2",72,0)
 S T(9)="No AP Entry ptr"
"RTN","MAGQBUT2",73,0)
 S T(10)="No AP Mult ptr"
"RTN","MAGQBUT2",74,0)
 S T(11)="GO DFN mismatches"
"RTN","MAGQBUT2",75,0)
 S T(12)="Null Image Ptr"
"RTN","MAGQBUT2",76,0)
 S T(13)="Invalid Image Ptr"
"RTN","MAGQBUT2",77,0)
 S T(14)="Invalid Image Ptr to AP"
"RTN","MAGQBUT2",78,0)
 S T(15)="Image Entry is structurally abnormal"
"RTN","MAGQBUT2",79,0)
 S T(16)="Missing Group Objects"
"RTN","MAGQBUT2",80,0)
 S T(21)="DFN Mismatches in AP Image Mult"
"RTN","MAGQBUT2",81,0)
 I IEN="" S $P(R,"^",5)=T(12)_"~1" Q R
"RTN","MAGQBUT2",82,0)
 S X0=$G(^MAG(2005,IEN,0))
"RTN","MAGQBUT2",83,0)
 I X0="" S $P(R,"^",5)=T(13)_"~1" Q R
"RTN","MAGQBUT2",84,0)
 S IDFN=$P(X0,"^",7),$P(R,"^",4)=IDFN
"RTN","MAGQBUT2",85,0)
 S PT(3.9)="^XMB(3.9,PD0,|Mail message||2|^XMB(3.9,PD0,2005,|MAIL"
"RTN","MAGQBUT2",86,0)
 ; The following 5 Lab subsections must be in-synch with FILE+42^MAGGTLB1
"RTN","MAGQBUT2",87,0)
 ; IA #1962
"RTN","MAGQBUT2",88,0)
 S PT(63)="^LR(PD0,GF,PD1,|Autopsy (microscopic)|AY|1|^LR(PD0,GF,PD1,2005.1,|AUM"
"RTN","MAGQBUT2",89,0)
 S PT(63.02)="^LR(PD0,GF,PD1,|Electron microscopy|EM|1|^LR(PD0,GF,PD1,2005,|EM"
"RTN","MAGQBUT2",90,0)
 S PT(63.08)="^LR(PD0,GF,PD1,|Surgical pathology|SP|1|^LR(PD0,GF,PD1,2005,|SP"
"RTN","MAGQBUT2",91,0)
 S PT(63.09)="^LR(PD0,GF,PD1,|Cytology|CY|1|^LR(PD0,GF,PD1,2005,|CY|"
"RTN","MAGQBUT2",92,0)
 S PT(63.2)="^LR(PD0,GF,PD1,|Autopsy (gross)|AY|1|^LR(PD0,GF,PD1,2005,|AUG"
"RTN","MAGQBUT2",93,0)
 S PT(70)="^RADPT(PDFN,|Radiology Patient||1|"
"RTN","MAGQBUT2",94,0)
 S PT(74)="^RARPT(PD0,|Radiology||2|^RARPT(PD0,2005,|RAD"
"RTN","MAGQBUT2",95,0)
 S PT(130)="^SRF(PD0,|Surgery||1|^SRF(PD0,2005,|SUR"
"RTN","MAGQBUT2",96,0)
 S PT(691)="^MCAR(691,PD0,|Echocardiogram||2|^MCAR(691,PD0,2005,|ECHO"
"RTN","MAGQBUT2",97,0)
 S PT(691.1)="^MCAR(691.1,PD0,|Cardiac catheterization||2|^MCAR(691.1,PD0,2005,|CATH"
"RTN","MAGQBUT2",98,0)
 S PT(691.5)="^MCAR(691.5,PD0,|Electrocardiography||2|^MCAR(691.5,PD0,2005,|ECG"
"RTN","MAGQBUT2",99,0)
 S PT(694)="^MCAR(694,PD0,|Hematology||2|^MCAR(694,PD0,2005,|HEM"
"RTN","MAGQBUT2",100,0)
 S PT(699)="^MCAR(699,PD0,|Endoscopy||2|^MCAR(699,PD0,2005,|ENDO"
"RTN","MAGQBUT2",101,0)
 S PT(699.5)="^MCAR(699.5,PD0,|Medicine||2|^MCAR(699.5,PD0,2005,|GEN"
"RTN","MAGQBUT2",102,0)
 S PT(8925)="^TIU(8925,PD0,|TIU||2|^TIU(8925.91,""ADI"",PD0,|TIU"
"RTN","MAGQBUT2",103,0)
 S IC=$$IC(IEN,.N0,.N2,.GPDFN),$P(R,U,6)=IC
"RTN","MAGQBUT2",104,0)
 I IC="ER" S $P(R,U,5)=T(15)_"~1" Q R
"RTN","MAGQBUT2",105,0)
 I IC["GP",'$O(^MAG(2005,IEN,1,0)) S $P(R,U,5)=T(2)_"~1" Q R
"RTN","MAGQBUT2",106,0)
 D PF(IEN,IC,N0,.PF,.PD0,.PD1,.PD2,.PACS,.IOR,.APR)
"RTN","MAGQBUT2",107,0)
 I "GP^GO"[IC D  Q:$P(R,U,5)'="" R
"RTN","MAGQBUT2",108,0)
 . S I=0
"RTN","MAGQBUT2",109,0)
 . F  S I=$O(^MAG(2005,IOR,1,I)) Q:I'?1N.N  D
"RTN","MAGQBUT2",110,0)
 . . I '$D(^MAG(2005,$P($G(^MAG(2005,IOR,1,I,0)),U),0)) S $P(R,U,5)=T(16)_$S(IC="GO":"~2",1:"~1")
"RTN","MAGQBUT2",111,0)
 . . Q
"RTN","MAGQBUT2",112,0)
 I IC["GO" S $P(R,U,6)=$P(R,U,6)_"~"_IOR
"RTN","MAGQBUT2",113,0)
 I PD2'?1N.N,(('PACS)&(PD0?1N.N)) S $P(R,U,5)=T(10)_$S(IC["GO":"~2",1:"~1") Q R
"RTN","MAGQBUT2",114,0)
 I IC["GO" D  Q:$P(R,U,5)'="" R
"RTN","MAGQBUT2",115,0)
 . N I,J
"RTN","MAGQBUT2",116,0)
 . S (I,J)=0
"RTN","MAGQBUT2",117,0)
 . F  S I=$O(^MAG(2005,IOR,1,I)) Q:I'?1N.N  S:IEN=$P($G(^MAG(2005,IOR,1,I,0)),U,1) J=1
"RTN","MAGQBUT2",118,0)
 . S:J=0 $P(R,U,5)=T(7)_"~2"
"RTN","MAGQBUT2",119,0)
 . Q
"RTN","MAGQBUT2",120,0)
 I IC["GO",IDFN'=GPDFN S $P(R,U,5)=T(5)_"~1",$P(R,U,3)=GPDFN Q R
"RTN","MAGQBUT2",121,0)
 I IC["GO" D  Q:$P(R,U,5)'="" R
"RTN","MAGQBUT2",122,0)
 . N I,J
"RTN","MAGQBUT2",123,0)
 . S I=0
"RTN","MAGQBUT2",124,0)
 . F  S I=$O(^MAG(2005,IOR,1,I)) Q:I'?1N.N  D  Q:$P(R,U,5)'=""
"RTN","MAGQBUT2",125,0)
 . . S J=$P($G(^MAG(2005,IOR,1,I,0)),U)
"RTN","MAGQBUT2",126,0)
 . . I $P($G(^MAG(2005,J,0)),U,7)'=IDFN S $P(R,U,5)=T(11)_"~2",$P(R,U,3)=$P($G(^MAG(2005,J,0)),U,7)
"RTN","MAGQBUT2",127,0)
 . . Q
"RTN","MAGQBUT2",128,0)
 I IC["GO",PACS,(($P(N2,U,6,7)'="")&($P(N2,U,6,7)'="^")),$P(N2,U,6,7)'=$P($G(^MAG(2005,$P(N0,U,10),2)),U,6,7) D  Q R
"RTN","MAGQBUT2",129,0)
 . S $P(R,U,5)=T(6)_"~1",$P(R,U,3)=$P(^MAG(2005,IOR,0),U,7) Q
"RTN","MAGQBUT2",130,0)
 I (PF\1=63),PD1'?1N.N,PD1'?1N.N1"."1N.N Q R
"RTN","MAGQBUT2",131,0)
 I PF?1N.E,$D(PT(+PF)),PD0?1N.N D
"RTN","MAGQBUT2",132,0)
 . S $P(R,"^",2)=$P(PT(PF),"|",6)_"~"_PD0
"RTN","MAGQBUT2",133,0)
 . S GR=$P(PT(PF),"|",1),GR0=GR_"0)"
"RTN","MAGQBUT2",134,0)
 . S GF=$P(PT(PF),"|",3),GP=$P(PT(PF),"|",4)
"RTN","MAGQBUT2",135,0)
 . S T=$P(PT(PF),"|",5),GRD=T_"G0,0)",GRG=T_"G0)"
"RTN","MAGQBUT2",136,0)
 E  D  Q R
"RTN","MAGQBUT2",137,0)
 . S:((IC["GP")&($P(R,U,5)="")) $P(R,U,5)="1"
"RTN","MAGQBUT2",138,0)
 S P0=$G(@GR0)
"RTN","MAGQBUT2",139,0)
 I P0="" S $P(R,"^",5)=T(4)_$S((('PACS)&(IC["GO")):"~2",1:"~1") Q R
"RTN","MAGQBUT2",140,0)
 S PDFN=$S(PF\1=63:$P(^LR(PD0,0),U,3),$P(P0,"^",GP)'="":$P(P0,"^",GP),1:PDFN)
"RTN","MAGQBUT2",141,0)
 I 'PDFN,$P($G(^VA(200,IDFN,0)),"^",1)=PDFN S PDFN=IDFN
"RTN","MAGQBUT2",142,0)
 S $P(R,"^",3)=PDFN
"RTN","MAGQBUT2",143,0)
 I PDFN'=IDFN S $P(R,U,5)=T(3)_$S((('PACS)&(IC["GO")):"~2",1:"~1") Q R
"RTN","MAGQBUT2",144,0)
 I PF=74 D
"RTN","MAGQBUT2",145,0)
 . S GR=$P(PT(70),"|",1),GR0=GR_"0)"
"RTN","MAGQBUT2",146,0)
 . S GF=$P(PT(70),"|",3),GP=$P(PT(70),"|",4)
"RTN","MAGQBUT2",147,0)
 . S P0=$G(@GR0),$P(R,"^",3)=$P(R,"^",3)_"~"_$P(P0,"^",GP)
"RTN","MAGQBUT2",148,0)
 S T=1,G0=0,IENV=0
"RTN","MAGQBUT2",149,0)
 F  S G0=$O(@GRG) Q:'G0  Q:$P(R,U,5)'=""  D  I 'T K PT Q
"RTN","MAGQBUT2",150,0)
 . I PF=8925 D  Q
"RTN","MAGQBUT2",151,0)
 . . I '$D(^MAG(2005,+G0,0)) S $P(R,U,5)=T(14)_$S((('PACS)&(IC["GO")):"~2",1:"~1")
"RTN","MAGQBUT2",152,0)
 . . S:G0=IOR IENV=1
"RTN","MAGQBUT2",153,0)
 . . I $P($G(^MAG(2005,+G0,0)),"^",7)'=IDFN S $P(R,U,5)=T(21)_"~2",$P(R,U,3)=$P($G(^MAG(2005,+G0,0)),"^",7)
"RTN","MAGQBUT2",154,0)
 . . Q
"RTN","MAGQBUT2",155,0)
 . I '$D(^MAG(2005,+$P($G(@GRD),"^",1),0)) S $P(R,U,5)=T(14)_$S((('PACS)&(IC["GO")):"~2",1:"~1")
"RTN","MAGQBUT2",156,0)
 . I $P($G(^MAG(2005,+$P($G(@GRD),"^",1),0)),"^",7)'=IDFN D  Q
"RTN","MAGQBUT2",157,0)
 . . S $P(R,U,5)=T(21)_"~2",$P(R,U,3)=$P($G(^MAG(2005,+$P($G(@GRD),"^",1),0)),"^",7) Q
"RTN","MAGQBUT2",158,0)
 . I PF=63 S:+$P($G(^LR(PD0,GF,PD1,2005.1,G0,0)),U)=IOR IENV=1
"RTN","MAGQBUT2",159,0)
 . I PF=63.2 S:+$P($G(^LR(PD0,GF,PD1,2005,G0,0)),U)=IOR IENV=1
"RTN","MAGQBUT2",160,0)
 . S:+$P($G(@GRD),"^",1)=IOR IENV=1
"RTN","MAGQBUT2",161,0)
 . Q
"RTN","MAGQBUT2",162,0)
 Q:$P(R,U,5)'="" R
"RTN","MAGQBUT2",163,0)
 I IC["GP" S $P(R,U,5)="1"
"RTN","MAGQBUT2",164,0)
 I IENV=0 S $P(R,U,5)=T(1)_"~1"
"RTN","MAGQBUT2",165,0)
 I PF=74 S $P(R,"^",1)=$P(P0,"^",1)
"RTN","MAGQBUT2",166,0)
 K PT
"RTN","MAGQBUT2",167,0)
 Q R
"RTN","MAGQBUT2",168,0)
IC(IEN,N0,N2,GPDFN) ;
"RTN","MAGQBUT2",169,0)
 S N0=$G(^MAG(2005,IEN,0))
"RTN","MAGQBUT2",170,0)
 S N1=$G(^MAG(2005,IEN,1,0))
"RTN","MAGQBUT2",171,0)
 S N2=$G(^MAG(2005,IEN,2))
"RTN","MAGQBUT2",172,0)
 I ($P(N0,U,2)="")&($P(N0,U,10)="")&($P(N1,U,4)>0) Q "GP"
"RTN","MAGQBUT2",173,0)
 I (($P(N0,U,2)'="")&($P(N0,U,10)?1N.N)&(N1="")) D  Q "GO"
"RTN","MAGQBUT2",174,0)
 . S GPDFN=$P($G(^MAG(2005,$P(N0,U,10),0)),U,7) Q
"RTN","MAGQBUT2",175,0)
 I ($P(N0,U,2)'="")&($P(N0,U,10)'?1N.N)&(N1="") Q "NG"
"RTN","MAGQBUT2",176,0)
 Q "ER"
"RTN","MAGQBUT2",177,0)
PF(IEN,IC,N0,PF,PD0,PD1,PD2,PACS,IOR,APR) ;
"RTN","MAGQBUT2",178,0)
 N N2
"RTN","MAGQBUT2",179,0)
 S PACS=$S($D(^MAG(2005,IEN,"PACS")):1,1:0)
"RTN","MAGQBUT2",180,0)
 S IOR=$S(IC="GO":$P($G(N0),U,10),1:IEN)
"RTN","MAGQBUT2",181,0)
 I ((IC="GP")!(IC="NG")!((PACS)&(IC="GO"))) S N2=$G(^MAG(2005,IEN,2))
"RTN","MAGQBUT2",182,0)
 I ((IC="GO")&('PACS)) S N2=$G(^MAG(2005,IOR,2))
"RTN","MAGQBUT2",183,0)
 S PF=$P(N2,"^",6),PD0=$P(N2,"^",7),PD1=$P(N2,"^",10),PD2=$P(N2,"^",8)
"RTN","MAGQBUT2",184,0)
 I PACS S APR=$S(PD0?1N.N:1,1:0)
"RTN","MAGQBUT2",185,0)
 E  S APR=$S(((PF'="")&(PD0?1N.N)):1,$P($G(^MAG(2005,IOR,100)),U)?1N.N:1,$P($G(^MAG(2005,IOR,0)),U,6)="18":1,1:0)
"RTN","MAGQBUT2",186,0)
 Q
"RTN","MAGQBUT2",187,0)
DBQ(QIEN,PLACE,ZNODE) ;
"RTN","MAGQBUT2",188,0)
 Q:'$G(QIEN)  N INDX,ST,I,QTYP,TMP  ;P186 X-ref clean up
"RTN","MAGQBUT2",189,0)
 F INDX="DELETE","ABSTRACT","JUKEBOX","JBTOHD","PREFET","IMPORT","EVAL" D
"RTN","MAGQBUT2",190,0)
 . K ^MAGQUEUE(2006.03,"C",PLACE,INDX,QIEN)
"RTN","MAGQBUT2",191,0)
 . K:$P(ZNODE,U,5)]"" ^MAGQUEUE(2006.03,"D",PLACE,INDX,$E($P(ZNODE,U,5),1,30),QIEN)
"RTN","MAGQBUT2",192,0)
 . I INDX="JUKEBOX" D
"RTN","MAGQBUT2",193,0)
 . . K:$P(ZNODE,U,7) ^MAGQUEUE(2006.03,"E",PLACE,$P(ZNODE,U,7),QIEN) Q
"RTN","MAGQBUT2",194,0)
 . I "^JBTOHD^PREFET^"[("^"_INDX_"^") D
"RTN","MAGQBUT2",195,0)
 . . K:((+$P(ZNODE,U,7))&($P(ZNODE,U,8)]"")) ^MAGQUEUE(2006.03,"F",PLACE,$P(ZNODE,U,7),$P(ZNODE,U,8),QIEN) Q
"RTN","MAGQBUT2",196,0)
 K ^MAGQUEUE(2006.03,QIEN,0)
"RTN","MAGQBUT2",197,0)
 L +^MAGQUEUE(2006.03,0):1E9  ;P186
"RTN","MAGQBUT2",198,0)
 S $P(^MAGQUEUE(2006.03,0),"^",4)=$P(^MAGQUEUE(2006.03,0),"^",4)-1
"RTN","MAGQBUT2",199,0)
 L -^MAGQUEUE(2006.03,0)
"RTN","MAGQBUT2",200,0)
 L +^MAGQUEUE(2006.031,QP,0):1E9
"RTN","MAGQBUT2",201,0)
 S TMP=$G(^MAGQUEUE(2006.031,QP,0)),$P(TMP,U,5)=$P(TMP,U,5)-1
"RTN","MAGQBUT2",202,0)
 S ^MAGQUEUE(2006.031,QP,0)=TMP
"RTN","MAGQBUT2",203,0)
 L -^MAGQUEUE(2006.031,QP,0)
"RTN","MAGQBUT2",204,0)
 K ^MAGQUEUE(2006.03,"C",PLACE,$P(ZNODE,U),QIEN)
"RTN","MAGQBUT2",205,0)
 S ST=$E($P(ZNODE,U,5),1,30) I $L(ST) D    ;p186 remove "D" xref COMPLETION STATUS of QIEN - ST
"RTN","MAGQBUT2",206,0)
 . F I=1:1:100 S TYPE=$O(^MAGQUEUE(2006.03,"D",PLACE,TYPE)) K ^MAGQUEUE(2006.03,"D",PLACE,TYPE,ST,QIEN)
"RTN","MAGQBUT2",207,0)
 . Q
"RTN","MAGQBUT2",208,0)
 S MAGIEN=$P(ZNODE,U,7),QTYP=$P(ZNODE,U,8) I +MAGIEN,$L(QTYP) K ^MAGQUEUE(2006.03,"F",PLACE,MAGIEN,QTYP,QIEN)
"RTN","MAGQBUT2",209,0)
 Q
"RTN","MAGQBUT2",210,0)
DQUE(QIEN,QONLY) ;
"RTN","MAGQBUT2",211,0)
 N ZNODE,TYPE,MAGIEN,PLACE,QP,TMP,DA,IMPORTIEN
"RTN","MAGQBUT2",212,0)
 S ZNODE=$G(^MAGQUEUE(2006.03,QIEN,0))
"RTN","MAGQBUT2",213,0)
 S PLACE=$P(ZNODE,U,12)
"RTN","MAGQBUT2",214,0)
 S TYPE=$P(ZNODE,U)
"RTN","MAGQBUT2",215,0)
 I TYPE="" D DBQ^MAGQBUT2(QIEN,PLACE,ZNODE) Q
"RTN","MAGQBUT2",216,0)
 I "^IMPORT^"[("^"_TYPE_"^") S IMPORTIEN=$S($P(ZNODE,U,11)?1N.N:$P(ZNODE,U,11),1:QIEN)
"RTN","MAGQBUT2",217,0)
 S MAGIEN=$P(ZNODE,U,7)
"RTN","MAGQBUT2",218,0)
 S QP=$O(^MAGQUEUE(2006.031,"C",PLACE,TYPE,""))
"RTN","MAGQBUT2",219,0)
 L +^MAGQUEUE(2006.031,QP,0):1E9
"RTN","MAGQBUT2",220,0)
 S TMP=$G(^MAGQUEUE(2006.031,QP,0))
"RTN","MAGQBUT2",221,0)
 S $P(TMP,U,5)=$P(TMP,U,5)-1
"RTN","MAGQBUT2",222,0)
 S ^MAGQUEUE(2006.031,QP,0)=TMP
"RTN","MAGQBUT2",223,0)
 L -^MAGQUEUE(2006.031,QP,0)
"RTN","MAGQBUT2",224,0)
 K ^MAGQUEUE(2006.03,"C",PLACE,$P(ZNODE,U),QIEN)
"RTN","MAGQBUT2",225,0)
 K ^MAGQUEUE(2006.03,QIEN,0)
"RTN","MAGQBUT2",226,0)
 I $P(ZNODE,U,5)]"" D  ;remove "D" xref COMPLETION STATUS of QIEN
"RTN","MAGQBUT2",227,0)
 . K ^MAGQUEUE(2006.03,"D",PLACE,TYPE,$E($P(ZNODE,U,5),1,30),QIEN)
"RTN","MAGQBUT2",228,0)
 L +^MAGQUEUE(2006.03,0):1E9
"RTN","MAGQBUT2",229,0)
 S $P(^MAGQUEUE(2006.03,0),"^",4)=$P(^MAGQUEUE(2006.03,0),"^",4)-1
"RTN","MAGQBUT2",230,0)
 L -^MAGQUEUE(2006.03,0)
"RTN","MAGQBUT2",231,0)
 I "^IMPORT^"[("^"_TYPE_"^"),'$D(QONLY) D  Q
"RTN","MAGQBUT2",232,0)
 . I $D(^MAG(2006.041,"B",IMPORTIEN)) D
"RTN","MAGQBUT2",233,0)
 . . N TRACKID,ASIEN,SIEN
"RTN","MAGQBUT2",234,0)
 . . S ASIEN=$O(^MAG(2006.041,"B",IMPORTIEN)) Q:ASIEN=""
"RTN","MAGQBUT2",235,0)
 . . S TRACKID=$P($G(^MAG(2006.041,ASIEN)),U,2) Q:TRACKID=""
"RTN","MAGQBUT2",236,0)
 . . S ASIEN="A",ASIEN=$O(^MAG(2006.041,"C",TRACKID,ASIEN),-1)
"RTN","MAGQBUT2",237,0)
 . . F  S SIEN=$O(^MAG(2006.041,"C",TRACKID,SIEN),-1) Q:'SIEN  D
"RTN","MAGQBUT2",238,0)
 . . . S DIK="^MAG(2006.041,",DA=SIEN
"RTN","MAGQBUT2",239,0)
 . . . D ^DIK K DIK,DA
"RTN","MAGQBUT2",240,0)
 . . . Q
"RTN","MAGQBUT2",241,0)
 . . Q
"RTN","MAGQBUT2",242,0)
 . S DIK="^MAG(2006.034,",DA=IMPORTIEN D ^DIK
"RTN","MAGQBUT2",243,0)
 . K DIK,DA
"RTN","MAGQBUT2",244,0)
 . K:MAGIEN ^MAGQUEUE(2006.03,"E",PLACE,MAGIEN,IMPORTIEN)
"RTN","MAGQBUT2",245,0)
 . Q 
"RTN","MAGQBUT2",246,0)
 Q:("^JBTOHD^PREFET^JUKEBOX^")'[("^"_TYPE_"^")
"RTN","MAGQBUT2",247,0)
 S MAGIEN=$P(ZNODE,U,7)
"RTN","MAGQBUT2",248,0)
 Q:'MAGIEN
"RTN","MAGQBUT2",249,0)
 I TYPE="JUKEBOX" D  Q
"RTN","MAGQBUT2",250,0)
 . K ^MAGQUEUE(2006.03,"E",PLACE,MAGIEN,QIEN)
"RTN","MAGQBUT2",251,0)
 I "^JBTOHD^PREFET^"[("^"_TYPE_"^") D  Q
"RTN","MAGQBUT2",252,0)
 . Q:$P(ZNODE,U,8)']""
"RTN","MAGQBUT2",253,0)
 . K ^MAGQUEUE(2006.03,"F",PLACE,MAGIEN,$P(ZNODE,U,8),QIEN)
"RTN","MAGQBUT2",254,0)
 . Q
"RTN","MAGQBUT2",255,0)
 Q
"RTN","MAGQBUT2",256,0)
DQUE1(RESULT,QIEN) ;[MAGQB QUEDEL]
"RTN","MAGQBUT2",257,0)
 N X,TYPE
"RTN","MAGQBUT2",258,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT2",259,0)
 S RESULT=0
"RTN","MAGQBUT2",260,0)
 S TYPE=$P($G(^MAGQUEUE(2006.03,QIEN,0)),U)
"RTN","MAGQBUT2",261,0)
 D QRNGE^MAGQBUT5(.RESULT,TYPE,"DEL",QIEN,QIEN)
"RTN","MAGQBUT2",262,0)
 S RESULT=1
"RTN","MAGQBUT2",263,0)
 Q
"RTN","MAGQBUT2",264,0)
JBQUE(RESULT,QIEN) ; RPC[MAGQ JBQUE]
"RTN","MAGQBUT2",265,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT2",266,0)
 I '+QIEN S RESULT=0 Q
"RTN","MAGQBUT2",267,0)
 S RESULT=$$JUKEBOX^MAGBAPI(QIEN,$$PLACE^MAGBAPI(+$G(DUZ(2))))
"RTN","MAGQBUT2",268,0)
 Q
"VER")
8.0^22.2
**END**
**END**
