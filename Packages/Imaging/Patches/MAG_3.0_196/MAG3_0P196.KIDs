KIDS Distribution saved on Feb 12, 2018@08:45:36
VistA Imaging V3 - Patch 196 - BP fixes.
**KIDS**:MAG*3.0*196^

**INSTALL NAME**
MAG*3.0*196
"BLD",8365,0)
MAG*3.0*196^IMAGING^0^3180212^y
"BLD",8365,1,0)
^^24^24^3180209^^^^
"BLD",8365,1,1,0)
VistA Imaging Patch 196 - BackGround Processor (BP)
"BLD",8365,1,2,0)
The development environment used to build this version 
"BLD",8365,1,3,0)
of the Background Processor was updated to Delphi XE8
"BLD",8365,1,4,0)
Change to Patch Installation:
"BLD",8365,1,5,0)
With the installation of this Patch 196,  previous versions
"BLD",8365,1,6,0)
of the BP Client GUI will be able to logon to VistA.
"BLD",8365,1,7,0)
Fixes : 
"BLD",8365,1,8,0)
EVAL Queue count is fixed.
"BLD",8365,1,9,0)
The BP has a forced delay between processing Queues.  That delay
"BLD",8365,1,10,0)
has been changed to be selectable.
"BLD",8365,1,11,0)
This will enable the BP to process more Queues per minute.
"BLD",8365,1,12,0)
GUI enhancements for Resizing of Columns, and positioning
"BLD",8365,1,13,0)
of buttons, and edit boxes on various forms to be visable
"BLD",8365,1,14,0)
at all times.
"BLD",8365,1,15,0)
Network Location properties has been fixed.  
"BLD",8365,1,16,0)
Network Locations of type URL can now be edited in the 
"BLD",8365,1,17,0)
BP GUI.
"BLD",8365,1,18,0)
  
"BLD",8365,1,19,0)
This will check the routines from a BUILD file.
"BLD",8365,1,20,0)
Select BUILD NAME: MAG*3.0*196       IMAGING
"BLD",8365,1,21,0)
MAGBRTE4  value = 76402670
"BLD",8365,1,22,0)
MAGIP196  value = 4237416
"BLD",8365,1,23,0)
MAGQBUT4  value = 97374409
"BLD",8365,1,24,0)
done.
"BLD",8365,4,0)
^9.64PA^^0
"BLD",8365,6.3)
30
"BLD",8365,"ABNS",0)
^9.66A^^
"BLD",8365,"ABPKG")
n^n^G.IMAGING DEVELOPMENT TEAM@DOMAIN.EXT
"BLD",8365,"INI")
PRE^MAGIP196
"BLD",8365,"INID")
n^y^n
"BLD",8365,"INIT")
POS^MAGIP196
"BLD",8365,"KRN",0)
^9.67PA^779.2^20
"BLD",8365,"KRN",.4,0)
.4
"BLD",8365,"KRN",.4,"NM",0)
^9.68A^^
"BLD",8365,"KRN",.401,0)
.401
"BLD",8365,"KRN",.402,0)
.402
"BLD",8365,"KRN",.403,0)
.403
"BLD",8365,"KRN",.5,0)
.5
"BLD",8365,"KRN",.84,0)
.84
"BLD",8365,"KRN",3.6,0)
3.6
"BLD",8365,"KRN",3.8,0)
3.8
"BLD",8365,"KRN",9.2,0)
9.2
"BLD",8365,"KRN",9.8,0)
9.8
"BLD",8365,"KRN",9.8,"NM",0)
^9.68A^4^3
"BLD",8365,"KRN",9.8,"NM",2,0)
MAGBRTE4^^0^B76402670
"BLD",8365,"KRN",9.8,"NM",3,0)
MAGQBUT4^^0^B97374409
"BLD",8365,"KRN",9.8,"NM",4,0)
MAGIP196^^0^B4237416
"BLD",8365,"KRN",9.8,"NM","B","MAGBRTE4",2)

"BLD",8365,"KRN",9.8,"NM","B","MAGIP196",4)

"BLD",8365,"KRN",9.8,"NM","B","MAGQBUT4",3)

"BLD",8365,"KRN",19,0)
19
"BLD",8365,"KRN",19,"NM",0)
^9.68A^^
"BLD",8365,"KRN",19.1,0)
19.1
"BLD",8365,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",8365,"KRN",101,0)
101
"BLD",8365,"KRN",409.61,0)
409.61
"BLD",8365,"KRN",771,0)
771
"BLD",8365,"KRN",779.2,0)
779.2
"BLD",8365,"KRN",870,0)
870
"BLD",8365,"KRN",8989.51,0)
8989.51
"BLD",8365,"KRN",8989.52,0)
8989.52
"BLD",8365,"KRN",8994,0)
8994
"BLD",8365,"KRN","B",.4,.4)

"BLD",8365,"KRN","B",.401,.401)

"BLD",8365,"KRN","B",.402,.402)

"BLD",8365,"KRN","B",.403,.403)

"BLD",8365,"KRN","B",.5,.5)

"BLD",8365,"KRN","B",.84,.84)

"BLD",8365,"KRN","B",3.6,3.6)

"BLD",8365,"KRN","B",3.8,3.8)

"BLD",8365,"KRN","B",9.2,9.2)

"BLD",8365,"KRN","B",9.8,9.8)

"BLD",8365,"KRN","B",19,19)

"BLD",8365,"KRN","B",19.1,19.1)

"BLD",8365,"KRN","B",101,101)

"BLD",8365,"KRN","B",409.61,409.61)

"BLD",8365,"KRN","B",771,771)

"BLD",8365,"KRN","B",779.2,779.2)

"BLD",8365,"KRN","B",870,870)

"BLD",8365,"KRN","B",8989.51,8989.51)

"BLD",8365,"KRN","B",8989.52,8989.52)

"BLD",8365,"KRN","B",8994,8994)

"BLD",8365,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",8365,"QUES",0)
^9.62^^
"BLD",8365,"REQB",0)
^9.611^4^3
"BLD",8365,"REQB",2,0)
MAG*3.0*156^2
"BLD",8365,"REQB",3,0)
MAG*3.0*168^2
"BLD",8365,"REQB",4,0)
MAG*3.0*186^2
"BLD",8365,"REQB","B","MAG*3.0*156",2)

"BLD",8365,"REQB","B","MAG*3.0*168",3)

"BLD",8365,"REQB","B","MAG*3.0*186",4)

"INI")
PRE^MAGIP196
"INIT")
POS^MAGIP196
"MBREQ")
0
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging-V1 to release 
"PKG",454,20,0)
^9.402P^^
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020319^3020517^126
"PKG",454,22,1,"PAH",1,0)
196^3180212^126
"PKG",454,22,1,"PAH",1,1,0)
^^24^24^3180212
"PKG",454,22,1,"PAH",1,1,1,0)
VistA Imaging Patch 196 - BackGround Processor (BP)
"PKG",454,22,1,"PAH",1,1,2,0)
The development environment used to build this version 
"PKG",454,22,1,"PAH",1,1,3,0)
of the Background Processor was updated to Delphi XE8
"PKG",454,22,1,"PAH",1,1,4,0)
Change to Patch Installation:
"PKG",454,22,1,"PAH",1,1,5,0)
With the installation of this Patch 196,  previous versions
"PKG",454,22,1,"PAH",1,1,6,0)
of the BP Client GUI will be able to logon to VistA.
"PKG",454,22,1,"PAH",1,1,7,0)
Fixes : 
"PKG",454,22,1,"PAH",1,1,8,0)
EVAL Queue count is fixed.
"PKG",454,22,1,"PAH",1,1,9,0)
The BP has a forced delay between processing Queues.  That delay
"PKG",454,22,1,"PAH",1,1,10,0)
has been changed to be selectable.
"PKG",454,22,1,"PAH",1,1,11,0)
This will enable the BP to process more Queues per minute.
"PKG",454,22,1,"PAH",1,1,12,0)
GUI enhancements for Resizing of Columns, and positioning
"PKG",454,22,1,"PAH",1,1,13,0)
of buttons, and edit boxes on various forms to be visable
"PKG",454,22,1,"PAH",1,1,14,0)
at all times.
"PKG",454,22,1,"PAH",1,1,15,0)
Network Location properties has been fixed.  
"PKG",454,22,1,"PAH",1,1,16,0)
Network Locations of type URL can now be edited in the 
"PKG",454,22,1,"PAH",1,1,17,0)
BP GUI.
"PKG",454,22,1,"PAH",1,1,18,0)
  
"PKG",454,22,1,"PAH",1,1,19,0)
This will check the routines from a BUILD file.
"PKG",454,22,1,"PAH",1,1,20,0)
Select BUILD NAME: MAG*3.0*196       IMAGING
"PKG",454,22,1,"PAH",1,1,21,0)
MAGBRTE4  value = 76402670
"PKG",454,22,1,"PAH",1,1,22,0)
MAGIP196  value = 4237416
"PKG",454,22,1,"PAH",1,1,23,0)
MAGQBUT4  value = 97374409
"PKG",454,22,1,"PAH",1,1,24,0)
done.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","MAGBRTE4")
0^2^B76402670
"RTN","MAGBRTE4",1,0)
MAGBRTE4 ;WOIFO/EdM,DAC,gek - Process Routing Rule Evaluation Queue ;
"RTN","MAGBRTE4",2,0)
 ;;3.0;IMAGING;**11,30,51,85,54,39,156,196**;Mar 19, 2002;Build 30;Feb 9, 2018
"RTN","MAGBRTE4",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGBRTE4",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTE4",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGBRTE4",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGBRTE4",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGBRTE4",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGBRTE4",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGBRTE4",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGBRTE4",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGBRTE4",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGBRTE4",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGBRTE4",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGBRTE4",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGBRTE4",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTE4",17,0)
 ;;
"RTN","MAGBRTE4",18,0)
 Q
"RTN","MAGBRTE4",19,0)
 ;
"RTN","MAGBRTE4",20,0)
EVAL ;
"RTN","MAGBRTE4",21,0)
 N ACTIVE ;--- Switch that controls start/stop queue processor
"RTN","MAGBRTE4",22,0)
 N ANY ;------ Flag: processed any rule
"RTN","MAGBRTE4",23,0)
 N CONS ;----- Switch that indicates whether or not site has "consolidated" code
"RTN","MAGBRTE4",24,0)
 N KEYWORD ;-- Array with all keywords
"RTN","MAGBRTE4",25,0)
 N MAGFILE1 ;- Name of file
"RTN","MAGBRTE4",26,0)
 N XMSG ;----- Message counter
"RTN","MAGBRTE4",27,0)
 ;
"RTN","MAGBRTE4",28,0)
 F I="MAGEVAL","MAGEVALSTUDY" K ^XTMP(I,ZTSK)
"RTN","MAGBRTE4",29,0)
 D LOG^MAGBRTE5("Started at "_$H)
"RTN","MAGBRTE4",30,0)
 S XMSG=1,CONS=$$CONSOLID^MAGBAPI()
"RTN","MAGBRTE4",31,0)
 S PLACE=$S(CONS:$O(^MAG(2006.1,"B",LOCATION,"")),1:1)
"RTN","MAGBRTE4",32,0)
 L +^MAGDICOM(2006.563,1,"EVAL",LOCATION):0 E  D  Q
"RTN","MAGBRTE4",33,0)
 . D LOG^MAGBRTE5("A rule evaluator is already running for "_$$GET1^DIQ(4,LOCATION,.01))
"RTN","MAGBRTE4",34,0)
 . Q
"RTN","MAGBRTE4",35,0)
 S ^MAGDICOM(2006.563,1,"EVAL")=1
"RTN","MAGBRTE4",36,0)
 ;
"RTN","MAGBRTE4",37,0)
 S I="" F  S I=$O(RULES(I)) Q:I=""  D
"RTN","MAGBRTE4",38,0)
 . N D0,D1,D2,L,Q1
"RTN","MAGBRTE4",39,0)
 . S X=RULES(I),D0=$P(X,"^",1),Q1=$P(X,"^",2),L=$L(X,"^")
"RTN","MAGBRTE4",40,0)
 . I L=3 S RULE(D0,Q1)=$P(X,"^",3) Q
"RTN","MAGBRTE4",41,0)
 . I Q1="ACTION" S RULE(D0,Q1,$P(X,"^",3))=$P(X,"^",4,L) Q
"RTN","MAGBRTE4",42,0)
 . I Q1'="CONDITION" D LOG^MAGBRTE5("Rule "_D0_" has a qualifier """_Q1_""".") Q
"RTN","MAGBRTE4",43,0)
 . I L=5 S RULE(D0,Q1,$P(X,"^",3),$P(X,"^",4))=$P(X,"^",5) Q
"RTN","MAGBRTE4",44,0)
 . S RULE(D0,Q1,$P(X,"^",3),$P(X,"^",4),$P(X,"^",6),$P(X,"^",5))=$P(X,"^",7)
"RTN","MAGBRTE4",45,0)
 . Q
"RTN","MAGBRTE4",46,0)
 K RULES
"RTN","MAGBRTE4",47,0)
 ;
"RTN","MAGBRTE4",48,0)
 S ACTIVE=1 F  D  Q:'ACTIVE
"RTN","MAGBRTE4",49,0)
 . S ANY=0
"RTN","MAGBRTE4",50,0)
 . S ACTIVE=+$G(^MAGDICOM(2006.563,1,"EVAL")) I 'ACTIVE D  Q
"RTN","MAGBRTE4",51,0)
 . . D LOG^MAGBRTE5("Stopped at "_$H)
"RTN","MAGBRTE4",52,0)
 . . Q
"RTN","MAGBRTE4",53,0)
 . D
"RTN","MAGBRTE4",54,0)
 . . N IMAGE,QPTR,QPTR2,STATUS,X
"RTN","MAGBRTE4",55,0)
 . . D:'CONS ADD^MAGBAPI(0,"EVAL")
"RTN","MAGBRTE4",56,0)
 . . D:CONS ADD^MAGBAPI(0,"EVAL",PLACE)
"RTN","MAGBRTE4",57,0)
 . . ;S QPTR2=$O(^MAGQUEUE(2006.031,"B","EVAL",""))
"RTN","MAGBRTE4",58,0)
 . . S QPTR2=$O(^MAGQUEUE(2006.031,"C",PLACE,"EVAL","")) ; "C",PLACE    was  "B" ;p196
"RTN","MAGBRTE4",59,0)
 . . S QPTR=$S(QPTR2:$P(^MAGQUEUE(2006.031,QPTR2,0),"^",2),1:"")
"RTN","MAGBRTE4",60,0)
 . . ; Get next queue pointer value
"RTN","MAGBRTE4",61,0)
 . . S:'CONS QPTR=$O(^MAGQUEUE(2006.03,"C","EVAL",QPTR)) ;    "C"  WAS "B"  ;p196
"RTN","MAGBRTE4",62,0)
 . . S:CONS QPTR=$O(^MAGQUEUE(2006.03,"C",PLACE,"EVAL",QPTR))
"RTN","MAGBRTE4",63,0)
 . . I QPTR="" Q  ; Nothing to do
"RTN","MAGBRTE4",64,0)
 . . ;
"RTN","MAGBRTE4",65,0)
 . . S X=$G(^MAGQUEUE(2006.03,QPTR,0))
"RTN","MAGBRTE4",66,0)
 . . ; After an error, sometimes the entry is purged,
"RTN","MAGBRTE4",67,0)
 . . ; but the cross reference is still present.
"RTN","MAGBRTE4",68,0)
 . . ; In such a case, remove the cross reference.
"RTN","MAGBRTE4",69,0)
 . . I X="" D  Q
"RTN","MAGBRTE4",70,0)
 . . . K:'CONS ^MAGQUEUE(2006.03,"C","EVAL",QPTR) ; "C"   was   "B"  ;p196
"RTN","MAGBRTE4",71,0)
 . . . K:CONS ^MAGQUEUE(2006.03,"C",PLACE,"EVAL",QPTR)
"RTN","MAGBRTE4",72,0)
 . . . Q
"RTN","MAGBRTE4",73,0)
 . . ;
"RTN","MAGBRTE4",74,0)
 . . S IMAGE=$P(X,"^",7),ANY=1
"RTN","MAGBRTE4",75,0)
 . . I IMAGE,$D(^MAG(2005,IMAGE,0)) D
"RTN","MAGBRTE4",76,0)
 . . . S STATUS=$$RULES() Q:STATUS'<0
"RTN","MAGBRTE4",77,0)
 . . . I STATUS["NO NETWORK LOCATION" D  Q
"RTN","MAGBRTE4",78,0)
 . . . . D LOG^MAGBRTE5("Image "_IMAGE_" has no files associated with it")
"RTN","MAGBRTE4",79,0)
 . . . . Q
"RTN","MAGBRTE4",80,0)
 . . . D LOG^MAGBRTE5("*** EVAL queue error: "_STATUS_" ***")
"RTN","MAGBRTE4",81,0)
 . . . Q
"RTN","MAGBRTE4",82,0)
 . . ;D DQUE^MAGQBUT2(QPTR)  ; replaced with line below p196
"RTN","MAGBRTE4",83,0)
 . . D QPTER^MAGQBTM("EVAL",QPTR,PLACE),DQUE^MAGQBUT2(QPTR)
"RTN","MAGBRTE4",84,0)
 . . Q
"RTN","MAGBRTE4",85,0)
 . H:'ANY 1
"RTN","MAGBRTE4",86,0)
 . D:'$D(^XTMP("MAGEVAL",ZTSK)) XTINIT^MAGDRPC5,LOG^MAGBRTE5("^XTMP was cleaned up.")
"RTN","MAGBRTE4",87,0)
 . Q
"RTN","MAGBRTE4",88,0)
 L -^MAGDICOM(2006.563,1,"EVAL",LOCATION)
"RTN","MAGBRTE4",89,0)
 Q
"RTN","MAGBRTE4",90,0)
 ;
"RTN","MAGBRTE4",91,0)
RULES() ; To be called from above
"RTN","MAGBRTE4",92,0)
 ; IMAGE ;---- IEN for image (2005)
"RTN","MAGBRTE4",93,0)
 ; LOCATION ;- Location from which queue entry originates
"RTN","MAGBRTE4",94,0)
 N ACTION ;--- Action to be taken (SEND)
"RTN","MAGBRTE4",95,0)
 N C ;-------- Loop-variable for looping through parameters and conditions
"RTN","MAGBRTE4",96,0)
 N D ;-------- Data type
"RTN","MAGBRTE4",97,0)
 N DS ;------- Data type enclosed in space-characters
"RTN","MAGBRTE4",98,0)
 N F ;-------- ...
"RTN","MAGBRTE4",99,0)
 N METMSG ;--- Message to be issued when rule is evaluated
"RTN","MAGBRTE4",100,0)
 N O ;-------- Operator
"RTN","MAGBRTE4",101,0)
 N OK ;------- Flag: indicates whether or not rule is met
"RTN","MAGBRTE4",102,0)
 N RDT ;------ Current date (don't use DT, process might run over midnight)
"RTN","MAGBRTE4",103,0)
 N STUDYUID ;- Study UID
"RTN","MAGBRTE4",104,0)
 N V ;-------- Value for property as specified in rule
"RTN","MAGBRTE4",105,0)
 N VAL ;------ Actual value of property
"RTN","MAGBRTE4",106,0)
 N VRS ;------ String of Queue Entry numbers when rule(s) are met
"RTN","MAGBRTE4",107,0)
 N X ;-------- Scratch variable
"RTN","MAGBRTE4",108,0)
 ;
"RTN","MAGBRTE4",109,0)
 S VRS=""
"RTN","MAGBRTE4",110,0)
 ;
"RTN","MAGBRTE4",111,0)
 D KEYWORD^MAGBRTK
"RTN","MAGBRTE4",112,0)
 ;
"RTN","MAGBRTE4",113,0)
 D FILEFIND^MAGDFB(IMAGE,"FULL",0,0,.MAGFILE1)
"RTN","MAGBRTE4",114,0)
 Q:MAGFILE1<0 MAGFILE1
"RTN","MAGBRTE4",115,0)
 ;
"RTN","MAGBRTE4",116,0)
 S STUDYUID=$P($G(^MAG(2005,IMAGE,"PACS")),"^",1)
"RTN","MAGBRTE4",117,0)
 S X=$P($G(^MAG(2005,IMAGE,0)),"^",10)
"RTN","MAGBRTE4",118,0)
 S:X STUDYUID=$P($G(^MAG(2005,X,"PACS")),"^",1)
"RTN","MAGBRTE4",119,0)
 ;
"RTN","MAGBRTE4",120,0)
 S RULE=0 F  S RULE=$O(RULE(RULE)) Q:'RULE  D
"RTN","MAGBRTE4",121,0)
 . S METMSG=$G(RULE(RULE,"ACTION"))
"RTN","MAGBRTE4",122,0)
 . S X=" (",C=0 F  S C=$O(RULE(RULE,"ACTION",C)) Q:'C  D
"RTN","MAGBRTE4",123,0)
 . . S METMSG=METMSG_X_$G(RULE(RULE,"ACTION",C)),X=", "
"RTN","MAGBRTE4",124,0)
 . . Q
"RTN","MAGBRTE4",125,0)
 . S:X'=" (" METMSG=METMSG_")"
"RTN","MAGBRTE4",126,0)
 . S:METMSG="" METMSG="Rule #"_RULE
"RTN","MAGBRTE4",127,0)
 . I (STUDYUID="")!(ZTSK="")!(RULE="") Q  ; P156 DAC - Prevent deleted groups from causing hard crashes
"RTN","MAGBRTE4",128,0)
 . S OK=$G(^XTMP("MAGEVALSTUDY",ZTSK,STUDYUID,RULE))
"RTN","MAGBRTE4",129,0)
 . I OK="" S OK=1,C=0 F  S C=$O(RULE(RULE,"CONDITION",C)) Q:'C  D  Q:'OK
"RTN","MAGBRTE4",130,0)
 . . S F=$G(RULE(RULE,"CONDITION",C,"KW")) Q:F=""
"RTN","MAGBRTE4",131,0)
 . . S X=$G(KEYWORD("CONDITION",F),"^DICOM^MAGBRTE3(F,""OUT"",.VAL)")
"RTN","MAGBRTE4",132,0)
 . . K VAL D @$P(X,"^",2,9)
"RTN","MAGBRTE4",133,0)
 . . ; If the field is not defined, the test passes...
"RTN","MAGBRTE4",134,0)
 . . Q:$D(VAL)'=1  ; We won't deal with multiple values just yet...
"RTN","MAGBRTE4",135,0)
 . . ;
"RTN","MAGBRTE4",136,0)
 . . S V=$G(RULE(RULE,"CONDITION",C,"VA"))
"RTN","MAGBRTE4",137,0)
 . . S D=$G(RULE(RULE,"CONDITION",C,"DT"))
"RTN","MAGBRTE4",138,0)
 . . S O=$G(RULE(RULE,"CONDITION",C,"OP"))
"RTN","MAGBRTE4",139,0)
 . . S:D="" D="S"
"RTN","MAGBRTE4",140,0)
 . . S DS=" "_D_" "
"RTN","MAGBRTE4",141,0)
 . . D:" S CS DS IS LO LT OB OW PN SH ST "[DS
"RTN","MAGBRTE4",142,0)
 . . . N WILD ;-- Wildcard to be matched
"RTN","MAGBRTE4",143,0)
 . . . S WILD=$$WLDMATCH^MAGBRTE5(VAL,V)
"RTN","MAGBRTE4",144,0)
 . . . I O="=",'WILD S OK=0 Q
"RTN","MAGBRTE4",145,0)
 . . . I O="!=",WILD S OK=0 Q
"RTN","MAGBRTE4",146,0)
 . . . Q
"RTN","MAGBRTE4",147,0)
 . . D:" DT DA TM "[DS
"RTN","MAGBRTE4",148,0)
 . . . Q:O'="="  ; Only "within range" comparisons allowed currently
"RTN","MAGBRTE4",149,0)
 . . . ;
"RTN","MAGBRTE4",150,0)
 . . . N A ;--- Flag: indicates whether at least one time-frame matches
"RTN","MAGBRTE4",151,0)
 . . . N B ;--- Begin date/time
"RTN","MAGBRTE4",152,0)
 . . . N E ;--- End date/time
"RTN","MAGBRTE4",153,0)
 . . . N I ;--- Loopcounter
"RTN","MAGBRTE4",154,0)
 . . . N M ;--- Date/time mask
"RTN","MAGBRTE4",155,0)
 . . . N N ;--- Loopcounter (time-frames)
"RTN","MAGBRTE4",156,0)
 . . . N %T ;-- FileMan internal variable
"RTN","MAGBRTE4",157,0)
 . . . N VV ;-- Actual value
"RTN","MAGBRTE4",158,0)
 . . . N WD ;-- Weekday
"RTN","MAGBRTE4",159,0)
 . . . N X1 ;-- FileMan API parameter value -- date
"RTN","MAGBRTE4",160,0)
 . . . N X2 ;-- FileMan API parameter value -- date
"RTN","MAGBRTE4",161,0)
 . . . ;
"RTN","MAGBRTE4",162,0)
 . . . ; convert the literal date/time field into the format for comparison
"RTN","MAGBRTE4",163,0)
 . . . S VV=VAL
"RTN","MAGBRTE4",164,0)
 . . . ;
"RTN","MAGBRTE4",165,0)
 . . . S (A,N)=0 F  S N=$O(RULE(RULE,"CONDITION",C,"VA",N)) Q:'N  D
"RTN","MAGBRTE4",166,0)
 . . . . N T,VB,VC,VE
"RTN","MAGBRTE4",167,0)
 . . . . S M=$G(RULE(RULE,"CONDITION",C,"VA",N,"M"))
"RTN","MAGBRTE4",168,0)
 . . . . S B=$G(RULE(RULE,"CONDITION",C,"VA",N,"B"))
"RTN","MAGBRTE4",169,0)
 . . . . S E=$G(RULE(RULE,"CONDITION",C,"VA",N,"E"))
"RTN","MAGBRTE4",170,0)
 . . . . S T=1
"RTN","MAGBRTE4",171,0)
 . . . . I $E(M,1,3)="HOL" S:$$GET1^DIQ(40.5,+$E(VV,5,11),.01)="" T=0 ; IA 10038
"RTN","MAGBRTE4",172,0)
 . . . . I $E(M,1,3)="DDD",$E(B,1,3)'=$E(VAL,1,3) S T=0
"RTN","MAGBRTE4",173,0)
 . . . . S (VB,VC,VE)=""
"RTN","MAGBRTE4",174,0)
 . . . . F I=4:1:$L(M) S:$E(M,I)?1U VC=VC_$E(VV,I),VB=VB_$E(B,I),VE=VE_$E(E,I)
"RTN","MAGBRTE4",175,0)
 . . . . S:VB>VC T=0
"RTN","MAGBRTE4",176,0)
 . . . . S:VE<VC T=0
"RTN","MAGBRTE4",177,0)
 . . . . S:T A=1
"RTN","MAGBRTE4",178,0)
 . . . . Q
"RTN","MAGBRTE4",179,0)
 . . . S:'A OK=0
"RTN","MAGBRTE4",180,0)
 . . . Q
"RTN","MAGBRTE4",181,0)
 . . Q
"RTN","MAGBRTE4",182,0)
 . S ^XTMP("MAGEVALSTUDY",ZTSK,STUDYUID,RULE)=OK
"RTN","MAGBRTE4",183,0)
 . S METMSG(OK,METMSG)=""
"RTN","MAGBRTE4",184,0)
 . S RDT=$$NOW^XLFDT()\1
"RTN","MAGBRTE4",185,0)
 . Q:'OK
"RTN","MAGBRTE4",186,0)
 . S ACTION=$G(RULE(RULE,"ACTION"))
"RTN","MAGBRTE4",187,0)
 . Q:ACTION=""
"RTN","MAGBRTE4",188,0)
 . I ACTION="SEND" D  Q
"RTN","MAGBRTE4",189,0)
 . . N D,PRI,X
"RTN","MAGBRTE4",190,0)
 . . S X=$G(RULE(RULE,"ACTION",1))
"RTN","MAGBRTE4",191,0)
 . . I X="" S METMSG(0,"No location for rule "_RULE)="" Q
"RTN","MAGBRTE4",192,0)
 . . D VALDEST^MAGDRPC1(.D,X)
"RTN","MAGBRTE4",193,0)
 . . I D<0 S METMSG(0,"Cannot find location """_X_""".")="" Q
"RTN","MAGBRTE4",194,0)
 . . S PRI=$$PRI($G(RULE(RULE,"PRIORITY")),IMAGE)
"RTN","MAGBRTE4",195,0)
 . . S VRS=$$VRS^MAGBRTE5(VRS,$$SEND^MAGBRTE5(IMAGE,D,PRI,1,LOCATION))
"RTN","MAGBRTE4",196,0)
 . . Q
"RTN","MAGBRTE4",197,0)
 . I ACTION="DICOM" D  Q
"RTN","MAGBRTE4",198,0)
 . . N D,PRI,X
"RTN","MAGBRTE4",199,0)
 . . S X=$G(RULE(RULE,"ACTION",1))
"RTN","MAGBRTE4",200,0)
 . . I X="" S METMSG(0,"No location for rule "_RULE)="" Q
"RTN","MAGBRTE4",201,0)
 . . S D=$O(^MAG(2006.587,"B",X,""))
"RTN","MAGBRTE4",202,0)
 . . I D="" S METMSG(0,"Cannot find location """_X_""".")="" Q
"RTN","MAGBRTE4",203,0)
 . . S PRI=$$PRI($G(RULE(RULE,"PRIORITY")),IMAGE)
"RTN","MAGBRTE4",204,0)
 . . S VRS=$$VRS^MAGBRTE5(VRS,$$SEND^MAGBRTE5(IMAGE,D,PRI,2,LOCATION))
"RTN","MAGBRTE4",205,0)
 . . Q
"RTN","MAGBRTE4",206,0)
 . I ACTION="BALANCE" D BALANCE^MAGBRTE5(IMAGE,.RULE) Q
"RTN","MAGBRTE4",207,0)
 . ;
"RTN","MAGBRTE4",208,0)
 . ; Other actions to be inserted here...
"RTN","MAGBRTE4",209,0)
 . ;
"RTN","MAGBRTE4",210,0)
 . Q
"RTN","MAGBRTE4",211,0)
 ;
"RTN","MAGBRTE4",212,0)
 ; Note: we may have:
"RTN","MAGBRTE4",213,0)
 ;    Rule 1: If CR, send to XXX
"RTN","MAGBRTE4",214,0)
 ;    Rule 2: If CT, send to XXX
"RTN","MAGBRTE4",215,0)
 ; For a CR, this would cause an entry of
"RTN","MAGBRTE4",216,0)
 ;    METMSG(0,"SEND(XXX)") for rule 2
"RTN","MAGBRTE4",217,0)
 ; and an entry of
"RTN","MAGBRTE4",218,0)
 ;    METMSG(1,"SEND(XXX)") for rule 1
"RTN","MAGBRTE4",219,0)
 ; and for a CT it would be the other way around.
"RTN","MAGBRTE4",220,0)
 ; So, first remove all "failed" entries that were successful
"RTN","MAGBRTE4",221,0)
 ; for a different rule.
"RTN","MAGBRTE4",222,0)
 ;
"RTN","MAGBRTE4",223,0)
 S X="" F  S X=$O(METMSG(1,X)) Q:X=""  D
"RTN","MAGBRTE4",224,0)
 . D LOG^MAGBRTE5("Image "_IMAGE_": "_X)
"RTN","MAGBRTE4",225,0)
 . K METMSG(0,X)
"RTN","MAGBRTE4",226,0)
 . Q
"RTN","MAGBRTE4",227,0)
 S X="" F  S X=$O(METMSG(0,X)) Q:X=""  D
"RTN","MAGBRTE4",228,0)
 . D LOG^MAGBRTE5("Image "_IMAGE_": Do not "_X)
"RTN","MAGBRTE4",229,0)
 . Q
"RTN","MAGBRTE4",230,0)
 Q VRS
"RTN","MAGBRTE4",231,0)
 ;
"RTN","MAGBRTE4",232,0)
 ;
"RTN","MAGBRTE4",233,0)
PRI(PRI,IMAGE) N C,D0,D1,D2,O,P,R,X
"RTN","MAGBRTE4",234,0)
 S PRI=$S(PRI="HIGH":750,PRI="NORMAL":500,PRI="LOW":250,1:500)
"RTN","MAGBRTE4",235,0)
 S X=$G(^MAG(2005,IMAGE,2))
"RTN","MAGBRTE4",236,0)
 S P=$P(X,"^",6) Q:P'=74 PRI
"RTN","MAGBRTE4",237,0)
 S R=$P(X,"^",7) Q:'R PRI
"RTN","MAGBRTE4",238,0)
 S C=$P($G(^RARPT(R,0)),"^",1) Q:C="" PRI  ; IA 1171
"RTN","MAGBRTE4",239,0)
 S D0=$O(^RADPT("ADC",C,"")) Q:'D0 PRI  ; IA 1172
"RTN","MAGBRTE4",240,0)
 S D1=$O(^RADPT("ADC",C,D0,"")) Q:'D1 PRI  ; IA 1172
"RTN","MAGBRTE4",241,0)
 S D2=$O(^RADPT("ADC",C,D0,D1,"")) Q:'D2 PRI  ; IA 1172
"RTN","MAGBRTE4",242,0)
 S O=$P($G(^RADPT(D0,"DT",D1,"P",D2,0)),"^",11) Q:'O PRI  ; IA 1172
"RTN","MAGBRTE4",243,0)
 S X=$P($G(^RAO(75.1,O,0)),"^",6) ; IA 3074
"RTN","MAGBRTE4",244,0)
 Q PRI+$S(X=1:20,X=2:10,1:0)
"RTN","MAGBRTE4",245,0)
 ;
"RTN","MAGIP196")
0^4^B4237416
"RTN","MAGIP196",1,0)
MAGIP196 ;WOIFO/JSL,DAC,GEK - INSTALL CODE FOR MAG*3.0*196 BP XE8;
"RTN","MAGIP196",2,0)
 ;;3.0;IMAGING;**196**;Mar 19, 2002;Build 30;Feb 9, 2018
"RTN","MAGIP196",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIP196",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP196",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIP196",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIP196",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIP196",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIP196",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIP196",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIP196",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIP196",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIP196",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIP196",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIP196",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIP196",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP196",17,0)
 ;;
"RTN","MAGIP196",18,0)
 ; There are no environment checks here but the MAGIP196 has to be
"RTN","MAGIP196",19,0)
 ; referenced by the "Environment Check Routine" field of the KIDS
"RTN","MAGIP196",20,0)
 ; build so that entry points of the routine are available to the
"RTN","MAGIP196",21,0)
 ; KIDS during all installation phases.
"RTN","MAGIP196",22,0)
 ;
"RTN","MAGIP196",23,0)
 Q
"RTN","MAGIP196",24,0)
 ;
"RTN","MAGIP196",25,0)
 ;+++++ INSTALLATION ERROR HANDLING
"RTN","MAGIP196",26,0)
ERROR ;
"RTN","MAGIP196",27,0)
 S:$D(XPDNM) XPDABORT=1
"RTN","MAGIP196",28,0)
 ;--- Display the messages and store them to the INSTALL file
"RTN","MAGIP196",29,0)
 D DUMP^MAGUERR1(),ABTMSG^MAGKIDS()
"RTN","MAGIP196",30,0)
 Q
"RTN","MAGIP196",31,0)
 ;
"RTN","MAGIP196",32,0)
POST ;***** POST-INSTALL CODE
"RTN","MAGIP196",33,0)
POS ;
"RTN","MAGIP196",34,0)
 N CALLBACK
"RTN","MAGIP196",35,0)
 D CLEAR^MAGUERR(1)
"RTN","MAGIP196",36,0)
 I $G(DUZ)<.5 S XPDABORT=1 Q
"RTN","MAGIP196",37,0)
 ;--- Send the notification e-mail
"RTN","MAGIP196",38,0)
 D BMES^XPDUTL("Post Install Mail Message: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","MAGIP196",39,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGIP196",40,0)
 ;
"RTN","MAGIP196",41,0)
 Q
"RTN","MAGIP196",42,0)
 ;
"RTN","MAGIP196",43,0)
 ;***** PRE-INSTALL CODE
"RTN","MAGIP196",44,0)
PRE ;
"RTN","MAGIP196",45,0)
 ;****
"RTN","MAGIP196",46,0)
 QUIT
"RTN","MAGQBUT4")
0^3^B97374409
"RTN","MAGQBUT4",1,0)
MAGQBUT4 ;WOIFO/RMP - BP Utilities ;
"RTN","MAGQBUT4",2,0)
 ;;3.0;IMAGING;**7,8,48,20,81,39,121,135,196**;Mar 19, 2002;Build 30;Feb 9, 2018
"RTN","MAGQBUT4",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQBUT4",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT4",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBUT4",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBUT4",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBUT4",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBUT4",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBUT4",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBUT4",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBUT4",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBUT4",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBUT4",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBUT4",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBUT4",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT4",17,0)
 ;;
"RTN","MAGQBUT4",18,0)
 ;
"RTN","MAGQBUT4",19,0)
 Q
"RTN","MAGQBUT4",20,0)
CONV(ARR,ICT) ;Convert any single node array to FM Style multiple
"RTN","MAGQBUT4",21,0)
 ;  The node subscripts of ARR are ignored, and not retained
"RTN","MAGQBUT4",22,0)
 ; i.e.  ARR(34)=8
"RTN","MAGQBUT4",23,0)
 ;       ARR("BLUE")=9
"RTN","MAGQBUT4",24,0)
 ;       ARR("D")=10
"RTN","MAGQBUT4",25,0)
 ; converts to
"RTN","MAGQBUT4",26,0)
 ;      ARR(1,0)=8
"RTN","MAGQBUT4",27,0)
 ;      ARR(2,0)=9
"RTN","MAGQBUT4",28,0)
 ;      ARR(3,0)=10
"RTN","MAGQBUT4",29,0)
 N I,ARO
"RTN","MAGQBUT4",30,0)
 S ICT=0,I=""
"RTN","MAGQBUT4",31,0)
 F  S I=$O(ARR(I)) Q:(I="")  D
"RTN","MAGQBUT4",32,0)
 . S ICT=ICT+1
"RTN","MAGQBUT4",33,0)
 . S ARO(ICT,0)=ARR(I)
"RTN","MAGQBUT4",34,0)
 K ARR
"RTN","MAGQBUT4",35,0)
 M ARR=ARO
"RTN","MAGQBUT4",36,0)
 Q
"RTN","MAGQBUT4",37,0)
MRGMULT(ARR,RT,RTDSC,CT) ;Merge the FM formatted array into a FM File
"RTN","MAGQBUT4",38,0)
 ;   multiple field.
"RTN","MAGQBUT4",39,0)
 ;   This isn't for general consumption.
"RTN","MAGQBUT4",40,0)
 ; RT = FILE ROOT, RECORD NUMBER, NODE
"RTN","MAGQBUT4",41,0)
 ; i.e.  "^MAG(2006.034,44,1,"   -> 44 is the IEN of MAG(2006.34
"RTN","MAGQBUT4",42,0)
 ; RTDSC is the 2nd piece of the 0 node of the multiple field.
"RTN","MAGQBUT4",43,0)
 S RT=$E(RT,1,$L(RT)-1)_")"
"RTN","MAGQBUT4",44,0)
 S @RT@(0)=U_RTDSC_U_CT_U_CT ;  i.e.    ^2006.341A^13^13
"RTN","MAGQBUT4",45,0)
 M @RT=ARR
"RTN","MAGQBUT4",46,0)
 Q
"RTN","MAGQBUT4",47,0)
DDLF(RESULTS,FILE,FIELD,FLAGS,ATTR) ;[MAG FLD ATT]
"RTN","MAGQBUT4",48,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT4",49,0)
 K X
"RTN","MAGQBUT4",50,0)
 N I
"RTN","MAGQBUT4",51,0)
 D FIELD^DID(FILE,FIELD,FLAGS,ATTR,"RESULTS","RESULTS")
"RTN","MAGQBUT4",52,0)
 S I=0 F  S I=I+1 Q:'$D(RESULTS(ATTR,I))  M RESULTS(I)=RESULTS(ATTR,I)
"RTN","MAGQBUT4",53,0)
 Q
"RTN","MAGQBUT4",54,0)
DDFA(RESULTS) ;[MAG ATT LST]
"RTN","MAGQBUT4",55,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT4",56,0)
 K X
"RTN","MAGQBUT4",57,0)
 D FIELDLST^DID(RESULTS)
"RTN","MAGQBUT4",58,0)
 Q
"RTN","MAGQBUT4",59,0)
DVAL(RESULTS,FILE,IENS,FIELD,FLAGS,VALUE) ;[MAG FIELD VALIDATE]
"RTN","MAGQBUT4",60,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT4",61,0)
 K X
"RTN","MAGQBUT4",62,0)
 I FLAGS']"" S FLAGS="EHU"
"RTN","MAGQBUT4",63,0)
 D VAL^DIE(FILE,IENS,FIELD,FLAGS,VALUE,.RESULT,"","MSG")
"RTN","MAGQBUT4",64,0)
 I RESULT=U S RESULTS="-1^"_$G(MSG("DIERR","1","TEXT","1"))
"RTN","MAGQBUT4",65,0)
 E  S RESULTS=1_U_RESULT_U_$G(RESULT(0))
"RTN","MAGQBUT4",66,0)
 Q
"RTN","MAGQBUT4",67,0)
KVAL(RESULTS,FLAGS,FDA) ;[MAG KEY VALIDATE]
"RTN","MAGQBUT4",68,0)
 N TMP,DDRFDA
"RTN","MAGQBUT4",69,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT4",70,0)
 K X
"RTN","MAGQBUT4",71,0)
 D FDASET(.FDA,.DDRFDA)
"RTN","MAGQBUT4",72,0)
 S TMP=$$KEYVAL^DIE(FLAGS,"DDRFDA","MSG")
"RTN","MAGQBUT4",73,0)
 S RESULTS=$S(TMP=1:1,1:"-1^"_$G(MSG("DIERR","1","TEXT","1")))
"RTN","MAGQBUT4",74,0)
 K DDRFDA,MSG
"RTN","MAGQBUT4",75,0)
 Q
"RTN","MAGQBUT4",76,0)
FDASET(DDRROOT,DDRFDA) ;
"RTN","MAGQBUT4",77,0)
 N DDRFILE,DDRIEN,DDRFIELD,DDRVAL,DDRERR,I
"RTN","MAGQBUT4",78,0)
 S I=0
"RTN","MAGQBUT4",79,0)
 F  S I=$O(DDRROOT(I)) Q:'I  S X=DDRROOT(I) D
"RTN","MAGQBUT4",80,0)
 . S DDRFILE=$P(X,U)
"RTN","MAGQBUT4",81,0)
 . S DDRFIELD=$P(X,U,2)
"RTN","MAGQBUT4",82,0)
 . S DDRIEN=$P(X,U,3)
"RTN","MAGQBUT4",83,0)
 . S DDRVAL=$P(X,U,4,99)
"RTN","MAGQBUT4",84,0)
 . D FDA^DILF(DDRFILE,DDRIEN_$S($E(DDRIEN,$L(DDRIEN))'=",":",",1:""),DDRFIELD,"",DDRVAL,"DDRFDA","DDRERR")
"RTN","MAGQBUT4",85,0)
 Q
"RTN","MAGQBUT4",86,0)
DHRPC(RESULTS,FNAME,FLOC) ;[MAG DIRHASH]
"RTN","MAGQBUT4",87,0)
 N TMP
"RTN","MAGQBUT4",88,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT4",89,0)
 K X
"RTN","MAGQBUT4",90,0)
 S TMP=$$DIRHASH^MAGFILEB(FNAME,FLOC)
"RTN","MAGQBUT4",91,0)
 S RESULTS=$S(TMP="":U,1:TMP)
"RTN","MAGQBUT4",92,0)
 Q
"RTN","MAGQBUT4",93,0)
GPACHX(PV) ; Get Package File Install History of Imaging
"RTN","MAGQBUT4",94,0)
 N I,LCNT,MSG,PKG
"RTN","MAGQBUT4",95,0)
 S LCNT=0
"RTN","MAGQBUT4",96,0)
 S PV(0)="Version^Install Date"
"RTN","MAGQBUT4",97,0)
 F PKG="IMAGING" D
"RTN","MAGQBUT4",98,0)
 . N J,K,L,VERS,DATE,X,Y
"RTN","MAGQBUT4",99,0)
 . S J=$O(^DIC(9.4,"B",PKG,"")) Q:'J
"RTN","MAGQBUT4",100,0)
 . S VERS="" F  S VERS=$O(^DIC(9.4,J,22,"B",VERS)) Q:VERS=""  D
"RTN","MAGQBUT4",101,0)
 . . N MSG,TAR
"RTN","MAGQBUT4",102,0)
 . . S K=$O(^DIC(9.4,J,22,"B",VERS,""))
"RTN","MAGQBUT4",103,0)
 . . D LIST^DIC(9.4901,","_K_","_J_",","@;.01;.02;.03","","","","","","","","TAR","MSG")
"RTN","MAGQBUT4",104,0)
 . . Q:$D(MSG("DIERR"))
"RTN","MAGQBUT4",105,0)
 . . S L=0 F  S L=$O(TAR("DILIST","ID",L)) Q:'L  D
"RTN","MAGQBUT4",106,0)
 . . . S LCNT=LCNT+1
"RTN","MAGQBUT4",107,0)
 . . . S PV(LCNT)=VERS_"P"_$P(TAR("DILIST","ID",L,".01"),"^",1)
"RTN","MAGQBUT4",108,0)
 . . . S X=$P($P(TAR("DILIST","ID",L,".02"),"^",1),"@",1)
"RTN","MAGQBUT4",109,0)
 . . . S PV(LCNT)=PV(LCNT)_"^"_$S(X["-1":"",1:X)
"RTN","MAGQBUT4",110,0)
 . . . Q
"RTN","MAGQBUT4",111,0)
 . . Q
"RTN","MAGQBUT4",112,0)
 . Q
"RTN","MAGQBUT4",113,0)
 Q
"RTN","MAGQBUT4",114,0)
 ;
"RTN","MAGQBUT4",115,0)
VOKR(RESULT,VER) ; RPC for VOK [MAGQ VOK]
"RTN","MAGQBUT4",116,0)
 ;P196  
"RTN","MAGQBUT4",117,0)
 N CLPATCH,SVRPATCH
"RTN","MAGQBUT4",118,0)
 ; gek p196   allow 135 and 196 Client.
"RTN","MAGQBUT4",119,0)
 ;   get client Patch number
"RTN","MAGQBUT4",120,0)
 S CLPATCH=$$TRIM($P(VER,"P",2))
"RTN","MAGQBUT4",121,0)
 ; These are allowable Clients.
"RTN","MAGQBUT4",122,0)
 S SVRPATCH=",135,196,"
"RTN","MAGQBUT4",123,0)
 ; if client patch is allowed Result = 1^...
"RTN","MAGQBUT4",124,0)
 I SVRPATCH[CLPATCH S RESULT="1^3.0P196"
"RTN","MAGQBUT4",125,0)
 E  S RESULT="0^3.0P196"
"RTN","MAGQBUT4",126,0)
 Q
"RTN","MAGQBUT4",127,0)
OLD ;
"RTN","MAGQBUT4",128,0)
 S VER="3.0P"_($$TRIM($P(VER,"P",2)))
"RTN","MAGQBUT4",129,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT4",130,0)
 S SLINE=$T(+2)
"RTN","MAGQBUT4",131,0)
 S PNUM=$$TRIM($P(SLINE,"**",2)),PNUM=$$TRIM($P(PNUM,",",$L(PNUM,",")))
"RTN","MAGQBUT4",132,0)
 S CVERS=$$TRIM($P(SLINE,";",3))_"P"_PNUM
"RTN","MAGQBUT4",133,0)
 S RESULT=$S(CVERS=VER:1,1:0)_U_CVERS
"RTN","MAGQBUT4",134,0)
 Q
"RTN","MAGQBUT4",135,0)
 ;
"RTN","MAGQBUT4",136,0)
TRIM(X) ; remove both leading and trailing blanks
"RTN","MAGQBUT4",137,0)
 N I,J
"RTN","MAGQBUT4",138,0)
 F I=1:1:$L(X) Q:$E(X,I)'=" "
"RTN","MAGQBUT4",139,0)
 F J=$L(X):-1:I Q:$E(X,J)'=" "
"RTN","MAGQBUT4",140,0)
 Q $S($E(X,I,J)=" ":"",1:$E(X,I,J))
"RTN","MAGQBUT4",141,0)
 ;
"RTN","MAGQBUT4",142,0)
QCNT(RESULT,PLC,QUE) ; [MAGQ QCNT] Called from MagQueManSet.pas and MagSiteParameters.pas
"RTN","MAGQBUT4",143,0)
 N CNT,DA,CQ,IA,X
"RTN","MAGQBUT4",144,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT4",145,0)
 ;CQ=Current Queue Pointer(#2006.03) 
"RTN","MAGQBUT4",146,0)
 ;QP=Queue file pointer(#2006.031)
"RTN","MAGQBUT4",147,0)
 ;CNT=Queue type total, IA=Not failed total
"RTN","MAGQBUT4",148,0)
 S IA="",RESULT=0
"RTN","MAGQBUT4",149,0)
 S (CNT,IA)=0,DA=""
"RTN","MAGQBUT4",150,0)
 S QP=$S($D(^MAGQUEUE(2006.031,"C",PLC,QUE)):$O(^MAGQUEUE(2006.031,"C",PLC,QUE,"")),1:"")
"RTN","MAGQBUT4",151,0)
 S CQ=$S('QP:0,1:$P($G(^MAGQUEUE(2006.031,QP,0)),U,2))
"RTN","MAGQBUT4",152,0)
 F  S DA=$O(^MAGQUEUE(2006.03,"C",PLC,QUE,DA)) Q:'DA  D
"RTN","MAGQBUT4",153,0)
 . I '$D(^MAGQUEUE(2006.03,DA,0)) K ^MAGQUEUE(2006.03,"C",PLC,QUE,DA) Q 
"RTN","MAGQBUT4",154,0)
 . S CNT=CNT+1
"RTN","MAGQBUT4",155,0)
 . I CQ<DA S IA=IA+1
"RTN","MAGQBUT4",156,0)
 . Q
"RTN","MAGQBUT4",157,0)
 D QPUP(PLC,QUE,CNT,CQ,IA,QP) Q
"RTN","MAGQBUT4",158,0)
 Q
"RTN","MAGQBUT4",159,0)
 ;
"RTN","MAGQBUT4",160,0)
QPUP(PLC,QUE,CNT,CQ,IA,QP) ;
"RTN","MAGQBUT4",161,0)
 N IEN,DIC,VAL
"RTN","MAGQBUT4",162,0)
 K VAL
"RTN","MAGQBUT4",163,0)
 S VAL(1)=PLC,VAL(2)=QUE
"RTN","MAGQBUT4",164,0)
 S QP=$S(QP:QP,1:$$FIND1^DIC(2006.031,"","QX",.VAL,"C","",""))
"RTN","MAGQBUT4",165,0)
 ;I IEN>0 D  Q:IEN
"RTN","MAGQBUT4",166,0)
 ;. S $P(^MAGQUEUE(2006.031,IEN,0),U,5)=CNT Q
"RTN","MAGQBUT4",167,0)
 I 'QP D  Q
"RTN","MAGQBUT4",168,0)
 . K DIE,FDA
"RTN","MAGQBUT4",169,0)
 . S FDA(2006.031,"+1,",.01)=QUE
"RTN","MAGQBUT4",170,0)
 . S FDA(2006.031,"+1,",.04)=PLC
"RTN","MAGQBUT4",171,0)
 . S FDA(2006.031,"+1,",1)=CQ
"RTN","MAGQBUT4",172,0)
 . S FDA(2006.031,"+1,",2)=IA
"RTN","MAGQBUT4",173,0)
 . S FDA(2006.031,"+1,",3)=CNT
"RTN","MAGQBUT4",174,0)
 . D UPDATE^DIE("U","FDA","","MAGQUP")
"RTN","MAGQBUT4",175,0)
 . K DIE,FDA
"RTN","MAGQBUT4",176,0)
 E  D
"RTN","MAGQBUT4",177,0)
 . K DIE,FDA
"RTN","MAGQBUT4",178,0)
 . S FDA(2006.031,QP_",",.01)=QUE
"RTN","MAGQBUT4",179,0)
 . S FDA(2006.031,QP_",",.04)=PLC
"RTN","MAGQBUT4",180,0)
 . S FDA(2006.031,QP_",",1)=CQ
"RTN","MAGQBUT4",181,0)
 . S FDA(2006.031,QP_",",2)=IA
"RTN","MAGQBUT4",182,0)
 . S FDA(2006.031,QP_",",3)=CNT
"RTN","MAGQBUT4",183,0)
 . D FILE^DIE("","FDA","MAGERR")
"RTN","MAGQBUT4",184,0)
 . K DIE,FDA
"RTN","MAGQBUT4",185,0)
 Q
"RTN","MAGQBUT4",186,0)
 ;
"RTN","MAGQBUT4",187,0)
CPUD ;
"RTN","MAGQBUT4",188,0)
 N PLC,INS,QUE
"RTN","MAGQBUT4",189,0)
 S (INS,PLC)=""
"RTN","MAGQBUT4",190,0)
 F  S INS=$O(^MAG(2006.1,"B",INS)) Q:INS=""  D
"RTN","MAGQBUT4",191,0)
 . S PLC=$O(^MAG(2006.1,"B",INS,""))
"RTN","MAGQBUT4",192,0)
 . S QUE="" F  S QUE=$O(^MAGQUEUE(2006.031,"C",PLC,QUE)) Q:QUE=""  D
"RTN","MAGQBUT4",193,0)
 . . D QCNT^MAGQBUT4("",PLC,QUE)
"RTN","MAGQBUT4",194,0)
 . . Q
"RTN","MAGQBUT4",195,0)
 . Q
"RTN","MAGQBUT4",196,0)
 Q
"RTN","MAGQBUT4",197,0)
CNL(GL,IEN,NLC) ;  Check Network Location
"RTN","MAGQBUT4",198,0)
 N MAGREF,MAG0,MAG1,PLC
"RTN","MAGQBUT4",199,0)
 S NLC=NLC+1
"RTN","MAGQBUT4",200,0)
 I '$G(IEN) Q ""
"RTN","MAGQBUT4",201,0)
 S MAG0=$G(@(GL_IEN_",0)"))
"RTN","MAGQBUT4",202,0)
 S MAGREF=+$P(MAG0,"^",3)            ; get file from raid
"RTN","MAGQBUT4",203,0)
 I MAGREF=0 S MAGREF=+$P(MAG0,"^",5) ; get file from jukebox
"RTN","MAGQBUT4",204,0)
 I 'MAGREF Q ""
"RTN","MAGQBUT4",205,0)
 I '$D(^MAG(2005.2,MAGREF,0)) Q ""
"RTN","MAGQBUT4",206,0)
 S PLC=$P($G(^MAG(2005.2,MAGREF,0)),U,10)
"RTN","MAGQBUT4",207,0)
 Q:'PLC ""
"RTN","MAGQBUT4",208,0)
 S PLC=$P($G(^MAG(2006.1,PLC,0)),U)
"RTN","MAGQBUT4",209,0)
 Q $S('PLC:"",1:PLC)
"RTN","MAGQBUT4",210,0)
CNSP(GL,IEN,NMSP,NSC) ;  Check NameSPace
"RTN","MAGQBUT4",211,0)
 N NMSPC,MAG0,FNAM,INSTIEN
"RTN","MAGQBUT4",212,0)
 S NSC=NSC+1
"RTN","MAGQBUT4",213,0)
 S MAG0=$G(@(GL_IEN_",0)"))
"RTN","MAGQBUT4",214,0)
 S FNAM=$P(MAG0,U,2)
"RTN","MAGQBUT4",215,0)
 S NMSPC=$TR($P(FNAM,"."),"0123456789","")
"RTN","MAGQBUT4",216,0)
 Q:NMSPC="" ""
"RTN","MAGQBUT4",217,0)
 S INSTIEN=$S($D(NMSP(NMSPC)):$O(NMSP(NMSPC,"")),1:"")
"RTN","MAGQBUT4",218,0)
 Q INSTIEN
"RTN","MAGQBUT4",219,0)
NMSP(TMPA) ;
"RTN","MAGQBUT4",220,0)
 N IEN,INS,TMP,I,J
"RTN","MAGQBUT4",221,0)
 S INS="" F  S INS=$O(^MAG(2006.1,"B",INS)) Q:INS=""  S IEN="" D
"RTN","MAGQBUT4",222,0)
 . S IEN=$O(^MAG(2006.1,"B",INS,IEN)) Q:IEN=""  D  Q
"RTN","MAGQBUT4",223,0)
 . . S TMP=","_$$UPPER^MAGQE4($$INIS^MAGQBPG2(IEN))_"," D  Q
"RTN","MAGQBUT4",224,0)
 . . . F I=2:1 S J=$P(TMP,",",I) Q:J=""  S TMPA(J,INS)=""
"RTN","MAGQBUT4",225,0)
 . . . Q
"RTN","MAGQBUT4",226,0)
 S J="" F  S J=$O(TMPA(J)) Q:J=""  S INS=$O(TMPA(J,"")) K:($O(TMPA(J,INS))]"") TMPA(J)
"RTN","MAGQBUT4",227,0)
 Q
"RTN","MAGQBUT4",228,0)
CLRQ ; Clears the Queue file and Queue Pointer files
"RTN","MAGQBUT4",229,0)
 N DA,DIK,FILE,IEN
"RTN","MAGQBUT4",230,0)
 F FILE=2006.03,2006.031 D
"RTN","MAGQBUT4",231,0)
 . S IEN=0 F  S IEN=$O(^MAGQUEUE(FILE,IEN)) Q:'IEN  D
"RTN","MAGQBUT4",232,0)
 . . S DIK="^MAGQUEUE("_FILE_","
"RTN","MAGQBUT4",233,0)
 . . S DA=IEN,DA(1)=FILE D ^DIK
"RTN","MAGQBUT4",234,0)
 K DIK,DA
"RTN","MAGQBUT4",235,0)
 Q
"RTN","MAGQBUT4",236,0)
 ; We add RPC to MAG WINDOWS Option this way instead of sending Option : MAG WINDOWS
"RTN","MAGQBUT4",237,0)
 ; If we send MAG WINDOWS Option, the last one installed will overwrite others.
"RTN","MAGQBUT4",238,0)
 ; ADDRPC copied from Patch 51, added the call "D MES^XPDUTL(" instead of "W !"
"RTN","MAGQBUT4",239,0)
ADDRPC(RPCNAME,OPTNAME) ;
"RTN","MAGQBUT4",240,0)
 N DA,DIC
"RTN","MAGQBUT4",241,0)
 S DIC="^DIC(19,",DIC(0)="",X=OPTNAME D ^DIC
"RTN","MAGQBUT4",242,0)
 I Y<0 D  Q
"RTN","MAGQBUT4",243,0)
 . D MES^XPDUTL("Cannot add RPC: """_RPCNAME_""" to Option: """_OPTNAME_""".")
"RTN","MAGQBUT4",244,0)
 . D MES^XPDUTL("Cannot find Option: """_OPTNAME_""".")
"RTN","MAGQBUT4",245,0)
 . Q
"RTN","MAGQBUT4",246,0)
 I '$D(^XWB(8994,"B",RPCNAME)) D  Q
"RTN","MAGQBUT4",247,0)
 . D MES^XPDUTL("Cannot add RPC: """_RPCNAME_""" to Option: """_OPTNAME_""".")
"RTN","MAGQBUT4",248,0)
 . D MES^XPDUTL("Cannot find RPC: """_RPCNAME_""".")
"RTN","MAGQBUT4",249,0)
 . Q
"RTN","MAGQBUT4",250,0)
 S DA(1)=+Y
"RTN","MAGQBUT4",251,0)
 I $D(^DIC(19,+Y,"RPC","B",$O(^XWB(8994,"B",RPCNAME,"")))) D  Q
"RTN","MAGQBUT4",252,0)
 . D MES^XPDUTL("Cannot add RPC: """_RPCNAME_""" to Option: """_OPTNAME_""".")
"RTN","MAGQBUT4",253,0)
 . D MES^XPDUTL("RPC: """_RPCNAME_""" is already a member of """_OPTNAME_""".")
"RTN","MAGQBUT4",254,0)
 . Q
"RTN","MAGQBUT4",255,0)
 S DIC=DIC_DA(1)_",""RPC"","
"RTN","MAGQBUT4",256,0)
 S DIC(0)="L",DLAYGO="19" ; LAYGO should be allowed here
"RTN","MAGQBUT4",257,0)
 S X=RPCNAME
"RTN","MAGQBUT4",258,0)
 D ^DIC
"RTN","MAGQBUT4",259,0)
 K DIC,D0,DLAYGO
"RTN","MAGQBUT4",260,0)
 I Y<0 D  Q
"RTN","MAGQBUT4",261,0)
 . D MES^XPDUTL("Cannot add RPC: """_RPCNAME_""" to Option: """_OPTNAME_""".")
"RTN","MAGQBUT4",262,0)
 . D MES^XPDUTL("Cannot find RPC: """_RPCNAME_""".")
"RTN","MAGQBUT4",263,0)
 . Q
"RTN","MAGQBUT4",264,0)
 Q
"RTN","MAGQBUT4",265,0)
INS(XP,DUZ,DATE,IDA) ;
"RTN","MAGQBUT4",266,0)
 N CT,CNT,COM,D,D0,D1,D2,DDATE,DG,DIC,DICR,DIW,MAGMSG,ST,XMID,XMY,PLACE,XMSUB,XMZ
"RTN","MAGQBUT4",267,0)
 S PLACE=$O(^MAG(2006.1,"B",$$KSP^XUPARAM("INST"),""))
"RTN","MAGQBUT4",268,0)
 D GETENV^%ZOSV
"RTN","MAGQBUT4",269,0)
 S CNT=0
"RTN","MAGQBUT4",270,0)
 S CNT=CNT+1,MAGMSG(CNT)="PACKAGE INSTALL"
"RTN","MAGQBUT4",271,0)
 S CNT=CNT+1,MAGMSG(CNT)="SITE: "_$$KSP^XUPARAM("WHERE")
"RTN","MAGQBUT4",272,0)
 S CNT=CNT+1,MAGMSG(CNT)=" Production Account: "_$$PROD^XUPROD("1")
"RTN","MAGQBUT4",273,0)
 S CNT=CNT+1,MAGMSG(CNT)="PACKAGE: "_XP
"RTN","MAGQBUT4",274,0)
 S CNT=CNT+1,MAGMSG(CNT)="Version: "_$$VER^XPDUTL(XP)
"RTN","MAGQBUT4",275,0)
 S ST=$$GET1^DIQ(9.7,IDA,11,"I")
"RTN","MAGQBUT4",276,0)
 S CNT=CNT+1,MAGMSG(CNT)="Start time: "_$$FMTE^XLFDT(ST)
"RTN","MAGQBUT4",277,0)
 S CT=$$GET1^DIQ(9.7,IDA,17,"I") S:+CT'=CT CT=$$NOW^XLFDT
"RTN","MAGQBUT4",278,0)
 S CNT=CNT+1,MAGMSG(CNT)="Completion time: "_$$FMTE^XLFDT(CT)
"RTN","MAGQBUT4",279,0)
 S CNT=CNT+1,MAGMSG(CNT)="Run time: "_$$FMDIFF^XLFDT(CT,ST,3)
"RTN","MAGQBUT4",280,0)
 S CNT=CNT+1,MAGMSG(CNT)="Environment: "_Y
"RTN","MAGQBUT4",281,0)
 S COM=$$GET1^DIQ(9.7,IDA,6,"I")
"RTN","MAGQBUT4",282,0)
 S CNT=CNT+1,MAGMSG(CNT)="FILE COMMENT: "_COM
"RTN","MAGQBUT4",283,0)
 S CNT=CNT+1,MAGMSG(CNT)="DATE: "_DATE
"RTN","MAGQBUT4",284,0)
 S CNT=CNT+1,MAGMSG(CNT)="Installed by: "_$$GET1^DIQ(9.7,IDA,9,"E")
"RTN","MAGQBUT4",285,0)
 S CNT=CNT+1,MAGMSG(CNT)="Install Name: "_$$GET1^DIQ(9.7,IDA,.01,"E")
"RTN","MAGQBUT4",286,0)
 S DDATE=$$GET1^DIQ(9.7,IDA,51,"I")
"RTN","MAGQBUT4",287,0)
 S CNT=CNT+1,MAGMSG(CNT)="Distribution Date: "_$$FMTE^XLFDT(DDATE)
"RTN","MAGQBUT4",288,0)
 S XMSUB=XP_" INSTALLATION"
"RTN","MAGQBUT4",289,0)
 S XMID=$G(DUZ) S:'XMID XMID=.5
"RTN","MAGQBUT4",290,0)
 S XMY(XMID)=""
"RTN","MAGQBUT4",291,0)
 S:$G(MAGDUZ) XMY(MAGDUZ)=""
"RTN","MAGQBUT4",292,0)
 S XMSUB=$E(XMSUB,1,63)
"RTN","MAGQBUT4",293,0)
 D:$$PROD^XUPROD("1") ADDMG^MAGQBUT5(XMSUB,.XMY,PLACE)
"RTN","MAGQBUT4",294,0)
 D SENDMSG^XMXAPI(XMID,XMSUB,"MAGMSG",.XMY,,.XMZ,)
"RTN","MAGQBUT4",295,0)
 I $G(XMERR) M XMERR=^TMP("XMERR",$J) K XMERR
"RTN","MAGQBUT4",296,0)
 K MAGMSG
"RTN","MAGQBUT4",297,0)
 Q
"RTN","MAGQBUT4",298,0)
TEST ;
"RTN","MAGQBUT4",299,0)
 N FDA
"RTN","MAGQBUT4",300,0)
 S FDA(4)="2006.8^.01^+1,^BP1"
"RTN","MAGQBUT4",301,0)
 S FDA(1)="2006.8^.04^+1,^1"
"RTN","MAGQBUT4",302,0)
 S FDA(3)="2006.8^50^+1,^ISW-PRICER"
"RTN","MAGQBUT4",303,0)
 S FDA(2)="2006.8^11^+1,^1"
"RTN","MAGQBUT4",304,0)
 D KVAL(.RESULTS,"Q",.FDA)
"RTN","MAGQBUT4",305,0)
 W !,"RESULTS: "_RESULTS
"RTN","MAGQBUT4",306,0)
 Q
"RTN","MAGQBUT4",307,0)
 ;
"VER")
8.0^22.2
**END**
**END**
