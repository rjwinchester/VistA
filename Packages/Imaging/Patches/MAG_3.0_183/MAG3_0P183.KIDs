KIDS Distribution saved on Jan 02, 2018@15:43:30
ADT messages for PACS
**KIDS**:MAG*3.0*183^

**INSTALL NAME**
MAG*3.0*183
"BLD",8455,0)
MAG*3.0*183^IMAGING^0^3180102^y
"BLD",8455,1,0)
^9.61A^3^3^3170531^^
"BLD",8455,1,1,0)
Send VistA patient demographic changes to PACS using ADT A08 (patient 
"BLD",8455,1,2,0)
information update) and/or ADT A47 (change patient identifier list) HL7 
"BLD",8455,1,3,0)
messages.
"BLD",8455,4,0)
^9.64PA^2006.1^1
"BLD",8455,4,2006.1,0)
2006.1
"BLD",8455,4,2006.1,2,0)
^9.641^2006.1^1
"BLD",8455,4,2006.1,2,2006.1,0)
IMAGING SITE PARAMETERS  (File-top level)
"BLD",8455,4,2006.1,2,2006.1,1,0)
^9.6411^204^2
"BLD",8455,4,2006.1,2,2006.1,1,204,0)
SEND ANATOMIC PATHOLOGY HL7
"BLD",8455,4,2006.1,2,2006.1,1,205,0)
ENABLE TELEPATH WORKLIST
"BLD",8455,4,2006.1,222)
y^n^p^^^^n^^n
"BLD",8455,4,2006.1,224)

"BLD",8455,4,"APDD",2006.1,2006.1)

"BLD",8455,4,"APDD",2006.1,2006.1,204)

"BLD",8455,4,"APDD",2006.1,2006.1,205)

"BLD",8455,4,"B",2006.1,2006.1)

"BLD",8455,6.3)
11
"BLD",8455,"ABPKG")
n
"BLD",8455,"INID")
n^n
"BLD",8455,"INIT")
POS^MAGIP183
"BLD",8455,"KRN",0)
^9.67PA^779.2^20
"BLD",8455,"KRN",.4,0)
.4
"BLD",8455,"KRN",.4,"NM",0)
^9.68A^^
"BLD",8455,"KRN",.401,0)
.401
"BLD",8455,"KRN",.401,"NM",0)
^9.68A^^
"BLD",8455,"KRN",.402,0)
.402
"BLD",8455,"KRN",.403,0)
.403
"BLD",8455,"KRN",.5,0)
.5
"BLD",8455,"KRN",.84,0)
.84
"BLD",8455,"KRN",3.6,0)
3.6
"BLD",8455,"KRN",3.8,0)
3.8
"BLD",8455,"KRN",9.2,0)
9.2
"BLD",8455,"KRN",9.8,0)
9.8
"BLD",8455,"KRN",9.8,"NM",0)
^9.68A^25^25
"BLD",8455,"KRN",9.8,"NM",1,0)
MAGDHLE^^0^B19989150
"BLD",8455,"KRN",9.8,"NM",2,0)
MAGDHLI^^0^B8285914
"BLD",8455,"KRN",9.8,"NM",3,0)
MAGDHLS^^0^B78973085
"BLD",8455,"KRN",9.8,"NM",4,0)
MAGDHLT^^0^B5902737
"BLD",8455,"KRN",9.8,"NM",5,0)
MAGDHLTA^^0^B52475695
"BLD",8455,"KRN",9.8,"NM",6,0)
MAGDHOWA^^0^B42474842
"BLD",8455,"KRN",9.8,"NM",7,0)
MAGT7MA^^0^B133779882
"BLD",8455,"KRN",9.8,"NM",8,0)
MAGDHLL^^0^B9309805
"BLD",8455,"KRN",9.8,"NM",9,0)
MAGDHOW2^^0^B50817205
"BLD",8455,"KRN",9.8,"NM",10,0)
MAGT7S^^0^B31666917
"BLD",8455,"KRN",9.8,"NM",11,0)
MAGT7SP^^1^
"BLD",8455,"KRN",9.8,"NM",12,0)
MAGT7SV^^1^
"BLD",8455,"KRN",9.8,"NM",13,0)
MAGDHLTC^^0^B19165831
"BLD",8455,"KRN",9.8,"NM",14,0)
MAGIP183^^0^B16977771
"BLD",8455,"KRN",9.8,"NM",15,0)
MAGDHL7^^0^B8379265
"BLD",8455,"KRN",9.8,"NM",16,0)
MAGDHL7T^^1^
"BLD",8455,"KRN",9.8,"NM",17,0)
MAG7RS^^1^
"BLD",8455,"KRN",9.8,"NM",18,0)
MAG7RSD^^1^
"BLD",8455,"KRN",9.8,"NM",19,0)
MAG7RSO^^1^
"BLD",8455,"KRN",9.8,"NM",20,0)
MAG7RSR^^1^
"BLD",8455,"KRN",9.8,"NM",21,0)
MAG7UDR^^1^
"BLD",8455,"KRN",9.8,"NM",22,0)
MAGT7SI^^0^B13457996
"BLD",8455,"KRN",9.8,"NM",23,0)
MAGTP005^^0^B13949061
"BLD",8455,"KRN",9.8,"NM",24,0)
MAG7UP^^0^B35026309
"BLD",8455,"KRN",9.8,"NM",25,0)
MAGDHPS^^0^B62305390
"BLD",8455,"KRN",9.8,"NM","B","MAG7RS",17)

"BLD",8455,"KRN",9.8,"NM","B","MAG7RSD",18)

"BLD",8455,"KRN",9.8,"NM","B","MAG7RSO",19)

"BLD",8455,"KRN",9.8,"NM","B","MAG7RSR",20)

"BLD",8455,"KRN",9.8,"NM","B","MAG7UDR",21)

"BLD",8455,"KRN",9.8,"NM","B","MAG7UP",24)

"BLD",8455,"KRN",9.8,"NM","B","MAGDHL7",15)

"BLD",8455,"KRN",9.8,"NM","B","MAGDHL7T",16)

"BLD",8455,"KRN",9.8,"NM","B","MAGDHLE",1)

"BLD",8455,"KRN",9.8,"NM","B","MAGDHLI",2)

"BLD",8455,"KRN",9.8,"NM","B","MAGDHLL",8)

"BLD",8455,"KRN",9.8,"NM","B","MAGDHLS",3)

"BLD",8455,"KRN",9.8,"NM","B","MAGDHLT",4)

"BLD",8455,"KRN",9.8,"NM","B","MAGDHLTA",5)

"BLD",8455,"KRN",9.8,"NM","B","MAGDHLTC",13)

"BLD",8455,"KRN",9.8,"NM","B","MAGDHOW2",9)

"BLD",8455,"KRN",9.8,"NM","B","MAGDHOWA",6)

"BLD",8455,"KRN",9.8,"NM","B","MAGDHPS",25)

"BLD",8455,"KRN",9.8,"NM","B","MAGIP183",14)

"BLD",8455,"KRN",9.8,"NM","B","MAGT7MA",7)

"BLD",8455,"KRN",9.8,"NM","B","MAGT7S",10)

"BLD",8455,"KRN",9.8,"NM","B","MAGT7SI",22)

"BLD",8455,"KRN",9.8,"NM","B","MAGT7SP",11)

"BLD",8455,"KRN",9.8,"NM","B","MAGT7SV",12)

"BLD",8455,"KRN",9.8,"NM","B","MAGTP005",23)

"BLD",8455,"KRN",19,0)
19
"BLD",8455,"KRN",19,"NM",0)
^9.68A^2^2
"BLD",8455,"KRN",19,"NM",1,0)
MAG HL7 MAINT^^2
"BLD",8455,"KRN",19,"NM",2,0)
MAG ANATOMIC PATH HL7 SWITCH^^0
"BLD",8455,"KRN",19,"NM","B","MAG ANATOMIC PATH HL7 SWITCH",2)

"BLD",8455,"KRN",19,"NM","B","MAG HL7 MAINT",1)

"BLD",8455,"KRN",19.1,0)
19.1
"BLD",8455,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",8455,"KRN",101,0)
101
"BLD",8455,"KRN",101,"NM",0)
^9.68A^26^26
"BLD",8455,"KRN",101,"NM",1,0)
MAG CPACS A01^^0
"BLD",8455,"KRN",101,"NM",2,0)
MAG CPACS A01 SUBS^^0
"BLD",8455,"KRN",101,"NM",3,0)
MAG CPACS A01 SUBS-HLO^^0
"BLD",8455,"KRN",101,"NM",4,0)
MAG CPACS A02^^0
"BLD",8455,"KRN",101,"NM",5,0)
MAG CPACS A02 SUBS^^0
"BLD",8455,"KRN",101,"NM",6,0)
MAG CPACS A02 SUBS-HLO^^0
"BLD",8455,"KRN",101,"NM",7,0)
MAG CPACS A03^^0
"BLD",8455,"KRN",101,"NM",8,0)
MAG CPACS A03 SUBS^^0
"BLD",8455,"KRN",101,"NM",9,0)
MAG CPACS A03 SUBS-HLO^^0
"BLD",8455,"KRN",101,"NM",10,0)
MAG CPACS A08^^0
"BLD",8455,"KRN",101,"NM",11,0)
MAG CPACS A08 SUBS^^0
"BLD",8455,"KRN",101,"NM",12,0)
MAG CPACS A08 SUBS-HLO^^0
"BLD",8455,"KRN",101,"NM",13,0)
MAG CPACS A11^^0
"BLD",8455,"KRN",101,"NM",14,0)
MAG CPACS A11 SUBS^^0
"BLD",8455,"KRN",101,"NM",15,0)
MAG CPACS A11 SUBS-HLO^^0
"BLD",8455,"KRN",101,"NM",16,0)
MAG CPACS A12^^0
"BLD",8455,"KRN",101,"NM",17,0)
MAG CPACS A12 SUBS^^0
"BLD",8455,"KRN",101,"NM",18,0)
MAG CPACS A12 SUBS-HLO^^0
"BLD",8455,"KRN",101,"NM",19,0)
MAG CPACS A13^^0
"BLD",8455,"KRN",101,"NM",20,0)
MAG CPACS A13 SUBS^^0
"BLD",8455,"KRN",101,"NM",21,0)
MAG CPACS A13 SUBS-HLO^^0
"BLD",8455,"KRN",101,"NM",22,0)
MAG CPACS A47^^0
"BLD",8455,"KRN",101,"NM",23,0)
MAG CPACS A47 SUBS^^0
"BLD",8455,"KRN",101,"NM",24,0)
MAG CPACS A47 SUBS-HLO^^0
"BLD",8455,"KRN",101,"NM",25,0)
MAGD PACS VAFC ADT-A08 CLIENT^^0
"BLD",8455,"KRN",101,"NM",26,0)
VAFC ADT-A08 SERVER^^2
"BLD",8455,"KRN",101,"NM","B","MAG CPACS A01",1)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A01 SUBS",2)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A01 SUBS-HLO",3)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A02",4)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A02 SUBS",5)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A02 SUBS-HLO",6)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A03",7)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A03 SUBS",8)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A03 SUBS-HLO",9)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A08",10)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A08 SUBS",11)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A08 SUBS-HLO",12)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A11",13)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A11 SUBS",14)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A11 SUBS-HLO",15)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A12",16)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A12 SUBS",17)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A12 SUBS-HLO",18)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A13",19)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A13 SUBS",20)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A13 SUBS-HLO",21)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A47",22)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A47 SUBS",23)

"BLD",8455,"KRN",101,"NM","B","MAG CPACS A47 SUBS-HLO",24)

"BLD",8455,"KRN",101,"NM","B","MAGD PACS VAFC ADT-A08 CLIENT",25)

"BLD",8455,"KRN",101,"NM","B","VAFC ADT-A08 SERVER",26)

"BLD",8455,"KRN",409.61,0)
409.61
"BLD",8455,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",8455,"KRN",771,0)
771
"BLD",8455,"KRN",779.2,0)
779.2
"BLD",8455,"KRN",779.2,"NM",0)
^9.68A^3^2
"BLD",8455,"KRN",779.2,"NM",1,0)
MAG TELEPATHOLOGY^^0
"BLD",8455,"KRN",779.2,"NM",3,0)
MAGD SENDER^^0
"BLD",8455,"KRN",779.2,"NM","B","MAG TELEPATHOLOGY",1)

"BLD",8455,"KRN",779.2,"NM","B","MAGD SENDER",3)

"BLD",8455,"KRN",870,0)
870
"BLD",8455,"KRN",870,"NM",0)
^9.68A^2^1
"BLD",8455,"KRN",870,"NM",2,0)
MAG DPS^^0
"BLD",8455,"KRN",870,"NM","B","MAG DPS",2)

"BLD",8455,"KRN",8989.51,0)
8989.51
"BLD",8455,"KRN",8989.52,0)
8989.52
"BLD",8455,"KRN",8994,0)
8994
"BLD",8455,"KRN","B",.4,.4)

"BLD",8455,"KRN","B",.401,.401)

"BLD",8455,"KRN","B",.402,.402)

"BLD",8455,"KRN","B",.403,.403)

"BLD",8455,"KRN","B",.5,.5)

"BLD",8455,"KRN","B",.84,.84)

"BLD",8455,"KRN","B",3.6,3.6)

"BLD",8455,"KRN","B",3.8,3.8)

"BLD",8455,"KRN","B",9.2,9.2)

"BLD",8455,"KRN","B",9.8,9.8)

"BLD",8455,"KRN","B",19,19)

"BLD",8455,"KRN","B",19.1,19.1)

"BLD",8455,"KRN","B",101,101)

"BLD",8455,"KRN","B",409.61,409.61)

"BLD",8455,"KRN","B",771,771)

"BLD",8455,"KRN","B",779.2,779.2)

"BLD",8455,"KRN","B",870,870)

"BLD",8455,"KRN","B",8989.51,8989.51)

"BLD",8455,"KRN","B",8989.52,8989.52)

"BLD",8455,"KRN","B",8994,8994)

"BLD",8455,"PRE")
MAGIP183
"BLD",8455,"QDEF")
^^^^^^^^^^
"BLD",8455,"QUES",0)
^9.62^^
"BLD",8455,"REQB",0)
^9.611^2^1
"BLD",8455,"REQB",2,0)
MAG*3.0*166^1
"BLD",8455,"REQB","B","MAG*3.0*166",2)

"FIA",2006.1)
IMAGING SITE PARAMETERS
"FIA",2006.1,0)
^MAG(2006.1,
"FIA",2006.1,0,0)
2006.1P
"FIA",2006.1,0,1)
y^n^p^^^^n^^n
"FIA",2006.1,0,10)

"FIA",2006.1,0,11)

"FIA",2006.1,0,"RLRO")

"FIA",2006.1,0,"VR")
3.0^MAG
"FIA",2006.1,2006.1)
1
"FIA",2006.1,2006.1,204)

"FIA",2006.1,2006.1,205)

"INIT")
POS^MAGIP183
"KRN",19,23562,-1)
2^1
"KRN",19,23562,0)
MAG HL7 MAINT^Imaging HL7 Messaging Maintenance^^M^1214^^^^^^^454
"KRN",19,23562,10,0)
^19.01IP^3^3
"KRN",19,23562,10,3,0)
24021^AHL7^30
"KRN",19,23562,10,3,"^")
MAG ANATOMIC PATH HL7 SWITCH
"KRN",19,23562,"U")
IMAGING HL7 MESSAGING MAINTENA
"KRN",19,24021,-1)
0^2
"KRN",19,24021,0)
MAG ANATOMIC PATH HL7 SWITCH^Enable/disable Anatomic Pathology HL7 messages^^E^^^^^^^^IMAGING
"KRN",19,24021,30)
MAG(2006.1,
"KRN",19,24021,31)
AEQM
"KRN",19,24021,50)
MAG(2006.1,
"KRN",19,24021,51)
204
"KRN",19,24021,"U")
ENABLE/DISABLE ANATOMIC PATHOL
"KRN",101,4583,-1)
2^26
"KRN",101,4583,0)
VAFC ADT-A08 SERVER^Registration's ADT-A08 Server Protocol^^E^126^^^^^^^5
"KRN",101,4583,775,0)
^101.0775PA^9^9
"KRN",101,4583,775,9,0)
6693
"KRN",101,4583,775,9,"^")
MAGD PACS VAFC ADT-A08 CLIENT
"KRN",101,6432,-1)
0^1
"KRN",101,6432,0)
MAG CPACS A01^Inpatient admission event driver.^^E^^^^^^^^
"KRN",101,6432,1,0)
^^2^2^3060120^
"KRN",101,6432,1,1,0)
This protocol generates headers for IHE-based inpatient admission 
"KRN",101,6432,1,2,0)
messages to be delivered to a commercial PACS system by VistA Imaging.
"KRN",101,6432,99)
64618,44777
"KRN",101,6432,770)
MAG VISTA IMGNG^^ADT^A01^^^^^^2.4^
"KRN",101,6432,775,0)
^101.0775PA^2^2
"KRN",101,6432,775,1,0)
6433
"KRN",101,6432,775,1,"^")
MAG CPACS A01 SUBS
"KRN",101,6432,775,2,0)
6696
"KRN",101,6432,775,2,"^")
MAG CPACS A01 SUBS-HLO
"KRN",101,6433,-1)
0^2
"KRN",101,6433,0)
MAG CPACS A01 SUBS^Routes inpatient admissions using HL7 1.6^^S^^^^^^^^
"KRN",101,6433,1,0)
^^2^2^3060120^
"KRN",101,6433,1,1,0)
This protocol routes inpatient admission messages to a commercial PACS 
"KRN",101,6433,1,2,0)
system.
"KRN",101,6433,99)
64618,44777
"KRN",101,6433,770)
^MAG COMRCL PACS^ADT^A01^^^MAG CPACS^^^2.4^ACK
"KRN",101,6434,-1)
0^4
"KRN",101,6434,0)
MAG CPACS A02^Patient transfer event driver.^^E^^^^^^^^
"KRN",101,6434,1,0)
^101.06^2^2^3060120^^
"KRN",101,6434,1,1,0)
This protocol generates the header for patient transfer messages to be 
"KRN",101,6434,1,2,0)
delivered to a commercial PACS system by VistA Imaging.
"KRN",101,6434,99)
64618,44777
"KRN",101,6434,770)
MAG VISTA IMGNG^^ADT^A02^2^D^^^^2.4^
"KRN",101,6434,775,0)
^101.0775PA^2^2
"KRN",101,6434,775,1,0)
6435
"KRN",101,6434,775,1,"^")
MAG CPACS A02 SUBS
"KRN",101,6434,775,2,0)
6697
"KRN",101,6434,775,2,"^")
MAG CPACS A02 SUBS-HLO
"KRN",101,6435,-1)
0^5
"KRN",101,6435,0)
MAG CPACS A02 SUBS^Routes patient transfers using HL7 1.6^^S^^^^^^^^
"KRN",101,6435,1,0)
^^2^2^3060120^
"KRN",101,6435,1,1,0)
This protocol routes patient transfer messages to a commercial PACS 
"KRN",101,6435,1,2,0)
system.
"KRN",101,6435,99)
64618,44777
"KRN",101,6435,770)
^MAG COMRCL PACS^ADT^A02^^^MAG CPACS^^^2.4^ACK
"KRN",101,6436,-1)
0^7
"KRN",101,6436,0)
MAG CPACS A03^Patient discharge event driver.^^E^^^^^^^^
"KRN",101,6436,1,0)
^^2^2^3060120^
"KRN",101,6436,1,1,0)
This protocol generates headers for IHE-based patient discharge/end visit 
"KRN",101,6436,1,2,0)
messages to be delivered to a commercial PACS system by VistA Imaging.
"KRN",101,6436,99)
64618,44777
"KRN",101,6436,770)
MAG VISTA IMGNG^^ADT^A03^^^^^^2.4^
"KRN",101,6436,775,0)
^101.0775PA^2^2
"KRN",101,6436,775,1,0)
6437
"KRN",101,6436,775,1,"^")
MAG CPACS A03 SUBS
"KRN",101,6436,775,2,0)
6698
"KRN",101,6436,775,2,"^")
MAG CPACS A03 SUBS-HLO
"KRN",101,6437,-1)
0^8
"KRN",101,6437,0)
MAG CPACS A03 SUBS^Routes patient discharges using HL7 1.6^^S^^^^^^^^
"KRN",101,6437,1,0)
^^2^2^3060120^
"KRN",101,6437,1,1,0)
This protocol routes inpatient patient discharge/end visit messages to a 
"KRN",101,6437,1,2,0)
commercial PACS system.
"KRN",101,6437,99)
64618,44777
"KRN",101,6437,770)
^MAG COMRCL PACS^ADT^A03^^^MAG CPACS^^^2.4^ACK
"KRN",101,6438,-1)
0^13
"KRN",101,6438,0)
MAG CPACS A11^Cancel patient admission event driver.^^E^^^^^^^^
"KRN",101,6438,1,0)
^101.06^3^3^3170224^^^^
"KRN",101,6438,1,1,0)
This protocol generates headers for IHE-based inpatient admission
"KRN",101,6438,1,2,0)
cancellation messages to be delivered to a commercial PACS system by VistA
"KRN",101,6438,1,3,0)
Imaging.
"KRN",101,6438,99)
64618,44777
"KRN",101,6438,770)
MAG VISTA IMGNG^^ADT^A11^^^^^^2.4^
"KRN",101,6438,775,0)
^101.0775PA^2^2
"KRN",101,6438,775,1,0)
6439
"KRN",101,6438,775,1,"^")
MAG CPACS A11 SUBS
"KRN",101,6438,775,2,0)
6699
"KRN",101,6438,775,2,"^")
MAG CPACS A11 SUBS-HLO
"KRN",101,6439,-1)
0^14
"KRN",101,6439,0)
MAG CPACS A11 SUBS^Routes admission cacellations using HL7 1.6^^S^^^^^^^^
"KRN",101,6439,1,0)
^^2^2^3090318^
"KRN",101,6439,1,1,0)
This protocol routes admission cancellation messages to a commercial PACS 
"KRN",101,6439,1,2,0)
system.
"KRN",101,6439,99)
64618,44777
"KRN",101,6439,770)
^MAG COMRCL PACS^ADT^A11^^^MAG CPACS^^^2.4^ACK
"KRN",101,6439,773)
1^1
"KRN",101,6440,-1)
0^16
"KRN",101,6440,0)
MAG CPACS A12^Cancel patient transfer event driver.^^E^^^^^^^^
"KRN",101,6440,1,0)
^^2^2^3060126^
"KRN",101,6440,1,1,0)
This protocol generates headers for IHE-based transfer cancellation
"KRN",101,6440,1,2,0)
messages to be delivered to a commercial PACS system by VistA Imaging.
"KRN",101,6440,99)
64618,44777
"KRN",101,6440,770)
MAG VISTA IMGNG^^ADT^A12^^^^^^2.4^
"KRN",101,6440,775,0)
^101.0775PA^2^2
"KRN",101,6440,775,1,0)
6441
"KRN",101,6440,775,1,"^")
MAG CPACS A12 SUBS
"KRN",101,6440,775,2,0)
6700
"KRN",101,6440,775,2,"^")
MAG CPACS A12 SUBS-HLO
"KRN",101,6441,-1)
0^17
"KRN",101,6441,0)
MAG CPACS A12 SUBS^Routes transfer cancellations using HL7 1.6^^S^^^^^^^^
"KRN",101,6441,1,0)
^^2^2^3060126^
"KRN",101,6441,1,1,0)
This protocol routes transfer cancellation messages to a commercial PACS 
"KRN",101,6441,1,2,0)
system.
"KRN",101,6441,99)
64618,44777
"KRN",101,6441,770)
^MAG COMRCL PACS^ADT^A12^^^MAG CPACS^^^2.4^ACK
"KRN",101,6442,-1)
0^19
"KRN",101,6442,0)
MAG CPACS A13^Cancel patient discharge event driver.^^E^^^^^^^^
"KRN",101,6442,1,0)
^^3^3^3060126^
"KRN",101,6442,1,1,0)
This protocol generates headers for IHE-based inpatient discharge
"KRN",101,6442,1,2,0)
cancellation messages to be delivered to a commercial PACS system by VistA
"KRN",101,6442,1,3,0)
Imaging.
"KRN",101,6442,99)
64618,44777
"KRN",101,6442,770)
MAG VISTA IMGNG^^ADT^A13^^^^^^2.4^
"KRN",101,6442,775,0)
^101.0775PA^2^2
"KRN",101,6442,775,1,0)
6443
"KRN",101,6442,775,1,"^")
MAG CPACS A13 SUBS
"KRN",101,6442,775,2,0)
6701
"KRN",101,6442,775,2,"^")
MAG CPACS A13 SUBS-HLO
"KRN",101,6443,-1)
0^20
"KRN",101,6443,0)
MAG CPACS A13 SUBS^Routes discharge cancellations using HL7 1.6^^S^^^^^^^^
"KRN",101,6443,1,0)
^^3^3^3060126^
"KRN",101,6443,1,1,0)
This protocol routes inpatient discharge
"KRN",101,6443,1,2,0)
cancellation messages to a commercial PACS
"KRN",101,6443,1,3,0)
system.
"KRN",101,6443,99)
64618,44777
"KRN",101,6443,770)
^MAG COMRCL PACS^ADT^A13^^^MAG CPACS^^^2.4^ACK
"KRN",101,6691,-1)
0^10
"KRN",101,6691,0)
MAG CPACS A08^Patient information update event driver.^^E^^^^^^^^IMAGING
"KRN",101,6691,1,0)
^^2^2^3160225^
"KRN",101,6691,1,1,0)
This protocol generates headers for IHE-based ADT patient update messages
"KRN",101,6691,1,2,0)
to be delivered to a commercial PACS by VistA Imaging.
"KRN",101,6691,99)
64618,44777
"KRN",101,6691,770)
MAG VISTA IMGNG^^ADT^A08^^^^^^2.4^
"KRN",101,6691,775,0)
^101.0775PA^4^4
"KRN",101,6691,775,2,0)
6695
"KRN",101,6691,775,2,"^")
MAG CPACS A08 SUBS
"KRN",101,6691,775,3,0)
6702
"KRN",101,6691,775,3,"^")
MAG CPACS A08 SUBS-HLO
"KRN",101,6693,-1)
0^25
"KRN",101,6693,0)
MAGD PACS VAFC ADT-A08 CLIENT^VAFC ADT A08 updates for VistA Imaging^^S^^^^^^^^IMAGING
"KRN",101,6693,1,0)
^101.06^1^1^3161130^^
"KRN",101,6693,1,1,0)
This protocol will track PATIENT file (#2) changes for VistA Imaging.
"KRN",101,6693,15)

"KRN",101,6693,20)

"KRN",101,6693,99)
64618,44777
"KRN",101,6693,770)
^MAGD-CLIENT^ADT^A08^^^^^^2.4^ACK
"KRN",101,6693,771)

"KRN",101,6693,773)
0^0^0
"KRN",101,6693,774)
D ADTA08^MAGDHLE
"KRN",101,6695,-1)
0^11
"KRN",101,6695,0)
MAG CPACS A08 SUBS^Routes patient information updates using HL7 1.6^^S^^^^^^^^
"KRN",101,6695,1,0)
^^1^1^3161229^
"KRN",101,6695,1,1,0)
This protocol routes ADT A08 Update Patient Information messages to a commercial PACS.
"KRN",101,6695,99)
64618,44777
"KRN",101,6695,770)
^MAG COMRCL PACS^ADT^A08^^^MAG CPACS^^^2.4^ACK
"KRN",101,6696,-1)
0^3
"KRN",101,6696,0)
MAG CPACS A01 SUBS-HLO^Routes inpatient admissions using HLO^^S^^^^^^^^
"KRN",101,6696,1,0)
^^2^2^3170307
"KRN",101,6696,1,1,0)
This protocol routes inpatient admission messages
"KRN",101,6696,1,2,0)
a commercial PACS using the HL7 Optimized package.
"KRN",101,6696,99)
64618,44777
"KRN",101,6696,770)
^MAGD-CLIENT^ADT^A01^^^^^^2.4^ACK
"KRN",101,6696,771)
D ENTRY^MAGDHOWA
"KRN",101,6697,-1)
0^6
"KRN",101,6697,0)
MAG CPACS A02 SUBS-HLO^Routes patient transfers using HLO^^S^^^^^^^^
"KRN",101,6697,1,0)
^^2^2^3170307
"KRN",101,6697,1,1,0)
This protocol routes patient transfer messages
"KRN",101,6697,1,2,0)
a commercial PACS using the HL7 Optimized package.
"KRN",101,6697,99)
64618,44777
"KRN",101,6697,770)
^MAGD-CLIENT^ADT^A02^^^^^^2.4^ACK
"KRN",101,6697,771)
D ENTRY^MAGDHOWA
"KRN",101,6698,-1)
0^9
"KRN",101,6698,0)
MAG CPACS A03 SUBS-HLO^Routes patient discharges using HLO^^S^^^^^^^^
"KRN",101,6698,1,0)
^^2^2^3170307
"KRN",101,6698,1,1,0)
This protocol routes patient discharge messages
"KRN",101,6698,1,2,0)
a commercial PACS using the HL7 Optimized package.
"KRN",101,6698,99)
64618,44777
"KRN",101,6698,770)
^MAGD-CLIENT^ADT^A03^^^^^^2.4^ACK
"KRN",101,6698,771)
D ENTRY^MAGDHOWA
"KRN",101,6699,-1)
0^15
"KRN",101,6699,0)
MAG CPACS A11 SUBS-HLO^Routes admission cancellations using HLO^^S^^^^^^^^
"KRN",101,6699,1,0)
^^2^2^3170307
"KRN",101,6699,1,1,0)
This protocol routes admission cancellation messages
"KRN",101,6699,1,2,0)
a commercial PACS using the HL7 Optimized package.
"KRN",101,6699,99)
64618,44777
"KRN",101,6699,770)
^MAGD-CLIENT^ADT^A11^^^^^^2.4^ACK
"KRN",101,6699,771)
D ENTRY^MAGDHOWA
"KRN",101,6700,-1)
0^18
"KRN",101,6700,0)
MAG CPACS A12 SUBS-HLO^Routes transfer cancellations using HLO^^S^^^^^^^^
"KRN",101,6700,1,0)
^^2^2^3170307
"KRN",101,6700,1,1,0)
This protocol routes transfer cancellation messages
"KRN",101,6700,1,2,0)
a commercial PACS using the HL7 Optimized package.
"KRN",101,6700,99)
64618,44777
"KRN",101,6700,770)
^MAGD-CLIENT^ADT^A12^^^^^^2.4^ACK
"KRN",101,6700,771)
D ENTRY^MAGDHOWA
"KRN",101,6701,-1)
0^21
"KRN",101,6701,0)
MAG CPACS A13 SUBS-HLO^Routes discharge cancellations using HLO^^S^^^^^^^^
"KRN",101,6701,1,0)
^^2^2^3170307
"KRN",101,6701,1,1,0)
This protocol routes discharge cancellation messages
"KRN",101,6701,1,2,0)
a commercial PACS using the HL7 Optimized package.
"KRN",101,6701,99)
64618,44777
"KRN",101,6701,770)
^MAGD-CLIENT^ADT^A13^^^^^^2.4^ACK
"KRN",101,6701,771)
D ENTRY^MAGDHOWA
"KRN",101,6702,-1)
0^12
"KRN",101,6702,0)
MAG CPACS A08 SUBS-HLO^Routes patient information updates using HLO^^S^^^^^^^^
"KRN",101,6702,1,0)
^^1^1^3170126^
"KRN",101,6702,1,1,0)
This protocol routes patient update message to a commercial PACS using the HL7 Optimized package.
"KRN",101,6702,99)
64618,44777
"KRN",101,6702,770)
^MAGD-CLIENT^ADT^A08^^^^^^2.4^ACK
"KRN",101,6702,771)
D ENTRY^MAGDHOWA
"KRN",101,6707,-1)
0^22
"KRN",101,6707,0)
MAG CPACS A47^Change patient id list event driver.^^E^^^^^^^^IMAGING
"KRN",101,6707,1,0)
^101.06^3^3^3170412^^^
"KRN",101,6707,1,1,0)
This protocol generates headers for IHE-based ADT change patient
"KRN",101,6707,1,2,0)
identifier list messages to be delivered to a commercial PACS by
"KRN",101,6707,1,3,0)
VistA Imaging.
"KRN",101,6707,99)
64618,44777
"KRN",101,6707,770)
MAG VISTA IMGNG^^ADT^A47^^^^^^2.4^
"KRN",101,6707,775,0)
^101.0775PA^2^2
"KRN",101,6707,775,1,0)
6709
"KRN",101,6707,775,1,"^")
MAG CPACS A47 SUBS
"KRN",101,6707,775,2,0)
6708
"KRN",101,6707,775,2,"^")
MAG CPACS A47 SUBS-HLO
"KRN",101,6708,-1)
0^24
"KRN",101,6708,0)
MAG CPACS A47 SUBS-HLO^Routes changes in patient id list using HLO.^^S^^^^^^^^
"KRN",101,6708,1,0)
^101.06^1^1^3170223^^^
"KRN",101,6708,1,1,0)
This protocol routes change patient identifier list messages to a commercial PACS using the HL7 Optimized package.
"KRN",101,6708,99)
64618,44777
"KRN",101,6708,770)
^MAGD-CLIENT^ADT^A47^^^^^^2.4^ACK
"KRN",101,6708,771)
D ENTRY^MAGDHOWA
"KRN",101,6709,-1)
0^23
"KRN",101,6709,0)
MAG CPACS A47 SUBS^Routes changes in patient id list using HL7 1.6^^S^^^^^^^^
"KRN",101,6709,1,0)
^^1^1^3170223^
"KRN",101,6709,1,1,0)
This protocol routes change patient identifier list messages to a commercial PACS.
"KRN",101,6709,99)
64618,44777
"KRN",101,6709,770)
^MAG COMRCL PACS^ADT^A47^^^MAG CPACS^^^2.4^ACK
"KRN",779.2,19,-1)
0^3
"KRN",779.2,19,0)
MAGD SENDER
"KRN",779.2,19,2)
IMAGING
"KRN",779.2,20,-1)
0^1
"KRN",779.2,20,0)
MAG TELEPATHOLOGY
"KRN",779.2,20,2)
IMAGING
"KRN",870,260,-1)
0^2
"KRN",870,260,0)
MAG DPS^^TCP^^^^^^^^^^^^^^^^^^10
"KRN",870,260,200)
^^^^^^^^^R
"KRN",870,260,400)
^^C^N^^^^^
"MBREQ")
0
"ORD",0,9.8)
9.8;;1;RTNF^XPDTA;RTNE^XPDTA
"ORD",0,9.8,0)
ROUTINE
"ORD",13,870)
870;13;1;;HLLL^XPDTA1;;HLLLE^XPDIA1;;;HLLLDEL^XPDIA1(%)
"ORD",13,870,0)
HL LOGICAL LINK
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"ORD",22,779.2)
779.2;22;1;;HLOAP^XPDTA1;;HLOE^XPDIA1;;;
"ORD",22,779.2,0)
HLO APPLICATION REGISTRY
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging-V1 to release 
"PKG",454,20,0)
^9.402P^^
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020319^3020517^126
"PKG",454,22,1,"PAH",1,0)
183^3180102^126
"PKG",454,22,1,"PAH",1,1,0)
^^3^3^3180102
"PKG",454,22,1,"PAH",1,1,1,0)
Send VistA patient demographic changes to PACS using ADT A08 (patient 
"PKG",454,22,1,"PAH",1,1,2,0)
information update) and/or ADT A47 (change patient identifier list) HL7 
"PKG",454,22,1,"PAH",1,1,3,0)
messages.
"PRE")
MAGIP183
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
25
"RTN","MAG7RS")
1^17
"RTN","MAG7RSD")
1^18
"RTN","MAG7RSO")
1^19
"RTN","MAG7RSR")
1^20
"RTN","MAG7UDR")
1^21
"RTN","MAG7UP")
0^24^B35026309
"RTN","MAG7UP",1,0)
MAG7UP ;WOIFO/MLH,PMK - Imaging - HL7 - utilities - break out message into a parse tree ;25 May 2017 2:30 PM
"RTN","MAG7UP",2,0)
 ;;3.0;IMAGING;**11,51,183**;MAR 19, 2002;Build 11;JUN 16, 2006
"RTN","MAG7UP",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAG7UP",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAG7UP",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAG7UP",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAG7UP",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAG7UP",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAG7UP",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAG7UP",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAG7UP",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAG7UP",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAG7UP",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAG7UP",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAG7UP",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAG7UP",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAG7UP",17,0)
 ;;
"RTN","MAG7UP",18,0)
 Q
"RTN","MAG7UP",19,0)
 ;
"RTN","MAG7UP",20,0)
PARSE(XMSG,XTREE) ; break the HL7 message lines into a parse tree
"RTN","MAG7UP",21,0)
 ;
"RTN","MAG7UP",22,0)
 ; INPUT:  The single-dimensional array of message lines
"RTN","MAG7UP",23,0)
 ;
"RTN","MAG7UP",24,0)
 ; OUTPUT:  The parse tree, in the structure
"RTN","MAG7UP",25,0)
 ;   @XTREE@(NSEG,0)                    segment name
"RTN","MAG7UP",26,0)
 ;   @XTREE@(NSEG,NFLD,NREP,NCMP,NSCM)  element data
"RTN","MAG7UP",27,0)
 ;   @XTREE@("B",SEGID,NSEG)          null
"RTN","MAG7UP",28,0)
 ;
"RTN","MAG7UP",29,0)
 N I,J,K,L,M,X,Z ; --------------------- scratch vars
"RTN","MAG7UP",30,0)
 N IMSG ; ------------------------------ message array index
"RTN","MAG7UP",31,0)
 N ISUBSEG ; --------------------------- index of continuation data for long segs
"RTN","MAG7UP",32,0)
 N ISUCC ; ----------------------------- successor element index
"RTN","MAG7UP",33,0)
 N FERR ; ------------------------------ error flag
"RTN","MAG7UP",34,0)
 N SEG ; ------------------------------- segment data
"RTN","MAG7UP",35,0)
 N SEGTAG ; ---------------------------- segment ID ("0th" piece)
"RTN","MAG7UP",36,0)
 N UFS,UCS,URS,UEC,USS ;---------------- HL7 delimiters (universal)
"RTN","MAG7UP",37,0)
 N ENC ;-------------------------------- HL7 encoding characters
"RTN","MAG7UP",38,0)
 N UFSESC,UCSESC,URSESC,UECESC,USSESC ;- HL7 escape sequences for delimiters (universal)
"RTN","MAG7UP",39,0)
 N PATTERN ; --------------------------- pattern match for spanned record
"RTN","MAG7UP",40,0)
 N NSEG ; ------------------------------ segment number in the parse tree
"RTN","MAG7UP",41,0)
 N NSEGINPT ; -------------------------- segment number of input HL7 data
"RTN","MAG7UP",42,0)
 N NFLD ; ------------------------------ field number in the segment
"RTN","MAG7UP",43,0)
 N FLD ; ------------------------------- field data
"RTN","MAG7UP",44,0)
 ;
"RTN","MAG7UP",45,0)
 S FERR=0 ; assume no error
"RTN","MAG7UP",46,0)
 S IMSG=""
"RTN","MAG7UP",47,0)
 ;
"RTN","MAG7UP",48,0)
 ; process MSH segment
"RTN","MAG7UP",49,0)
 ; If there's a message problem, return it in an NTE segment.
"RTN","MAG7UP",50,0)
 ;
"RTN","MAG7UP",51,0)
 S IMSG=$O(@XMSG@(IMSG)) ; array sent?
"RTN","MAG7UP",52,0)
 I IMSG="" D  Q FERR ; no
"RTN","MAG7UP",53,0)
 . S FERR=-1
"RTN","MAG7UP",54,0)
 . ; have to use default field separator
"RTN","MAG7UP",55,0)
 . S @XMSG@(0)="NTE|1||"_FERR_";no input array found"
"RTN","MAG7UP",56,0)
 . Q
"RTN","MAG7UP",57,0)
 S SEG=$G(@XMSG@(IMSG)) Q:$E(SEG,1,3)'="MSH" -2 ; an HL7 message?
"RTN","MAG7UP",58,0)
 I $E(SEG,1,3)'="MSH" D  Q FERR ; no
"RTN","MAG7UP",59,0)
 . S FERR=-2
"RTN","MAG7UP",60,0)
 . S ISUCC=$O(@XMSG@(IMSG)) S:'ISUCC ISUCC=IMSG+1
"RTN","MAG7UP",61,0)
 . ; have to use default field separator
"RTN","MAG7UP",62,0)
 . S @XMSG@(IMSG+ISUCC/2)="NTE|1||"_FERR_";invalid HL7 message (1st 3 chars must be MSH)"
"RTN","MAG7UP",63,0)
 . Q
"RTN","MAG7UP",64,0)
 ;
"RTN","MAG7UP",65,0)
 ; set up delimiters and escape sequences
"RTN","MAG7UP",66,0)
 S UFS=$E(SEG,4),@XTREE@(1,1,1,1,1)=UFS
"RTN","MAG7UP",67,0)
 S ENC=$P(SEG,UFS,2),@XTREE@(1,2,1,1,1)=ENC
"RTN","MAG7UP",68,0)
 S UCS=$E(ENC),URS=$E(ENC,2),UEC=$E(ENC,3),USS=$E(ENC,4)
"RTN","MAG7UP",69,0)
 S UFSESC=UEC_"F"_UEC,UCSESC=UEC_"S"_UEC,URSESC=UEC_"R"_UEC,UECESC=UEC_"E"_UEC,USSESC=UEC_"T"_UEC
"RTN","MAG7UP",70,0)
 S PATTERN="1A2AN1"""_UFS_""""
"RTN","MAG7UP",71,0)
 S @XTREE@(1,0)="MSH",@XTREE@("B","MSH",1)=""
"RTN","MAG7UP",72,0)
 F NFLD=3:1:$L(SEG,UFS) S FLD=$P(SEG,UFS,NFLD) D
"RTN","MAG7UP",73,0)
 . I FLD]"" D PROCFLD(XTREE,1,NFLD,FLD)
"RTN","MAG7UP",74,0)
 . Q
"RTN","MAG7UP",75,0)
 ; process the remaining segments
"RTN","MAG7UP",76,0)
 S SEG="" ; SEG will be a concatenated series of spanned records
"RTN","MAG7UP",77,0)
 S NSEG=2 ; next segment in the parse tree will be #2
"RTN","MAG7UP",78,0)
 F NSEGINPT=2:1 S IMSG=$O(@XMSG@(IMSG)) Q:IMSG=""  D  Q:FERR
"RTN","MAG7UP",79,0)
 . S SEG=$G(@XMSG@(IMSG)) Q:SEG=""
"RTN","MAG7UP",80,0)
 . S ISUBSEG="" ; prepare to handle very long HL7 segments (up to 32K)
"RTN","MAG7UP",81,0)
 . F  S ISUBSEG=$O(@XMSG@(IMSG,ISUBSEG)) Q:ISUBSEG=""  D
"RTN","MAG7UP",82,0)
 . . S SEG=SEG_$G(@XMSG@(IMSG,ISUBSEG))
"RTN","MAG7UP",83,0)
 . . Q
"RTN","MAG7UP",84,0)
 . S SEGTAG=$P(SEG,UFS) I SEGTAG'?1U2.3UN S FERR=-3 Q
"RTN","MAG7UP",85,0)
 . S @XTREE@(NSEG,0)=SEGTAG,@XTREE@("B",SEGTAG,NSEG)=""
"RTN","MAG7UP",86,0)
 . F NFLD=2:1:$L(SEG,UFS) D
"RTN","MAG7UP",87,0)
 . . S FLD=$P(SEG,UFS,NFLD)
"RTN","MAG7UP",88,0)
 . . I FLD]"" D PROCFLD(XTREE,NSEG,NFLD-1,FLD)
"RTN","MAG7UP",89,0)
 . . Q
"RTN","MAG7UP",90,0)
 . S SEG="" ; reinitialize SEG for the next possible concatenation
"RTN","MAG7UP",91,0)
 . S NSEG=NSEG+1 ; increment counter for next segment in the parse tree
"RTN","MAG7UP",92,0)
 . Q
"RTN","MAG7UP",93,0)
 Q FERR
"RTN","MAG7UP",94,0)
 ;
"RTN","MAG7UP",95,0)
PROCFLD(XTREE,XNSEG,XNFLD,XFLD) ; process a field
"RTN","MAG7UP",96,0)
 ;
"RTN","MAG7UP",97,0)
 ; input:  XTREE   name of MUMPS array for parse tree ($NA format)
"RTN","MAG7UP",98,0)
 ;         XNSEG   segment number for parse tree
"RTN","MAG7UP",99,0)
 ;         XNFLD   field number for parse tree
"RTN","MAG7UP",100,0)
 ;         XFLD    field data
"RTN","MAG7UP",101,0)
 ;
"RTN","MAG7UP",102,0)
 N SG ; ------ segment name
"RTN","MAG7UP",103,0)
 N NREP ; ---- repetition (occurrence) number
"RTN","MAG7UP",104,0)
 N REP ; ----- repetition data
"RTN","MAG7UP",105,0)
 N NCMP ; ---- component number
"RTN","MAG7UP",106,0)
 N CMP ; ----- component data
"RTN","MAG7UP",107,0)
 N NSCM ; ---- subcomponent number
"RTN","MAG7UP",108,0)
 N SCM ; ----- subcomponent data
"RTN","MAG7UP",109,0)
 ;
"RTN","MAG7UP",110,0)
 S SG=@XTREE@(XNSEG,0)
"RTN","MAG7UP",111,0)
 ; Per DICOM meeting 2004-02-24, reaffirmed that data may need to be
"RTN","MAG7UP",112,0)
 ; retrieved above the subcomponent level, and that those data will
"RTN","MAG7UP",113,0)
 ; need to be de-escaped because the receiving application won't have
"RTN","MAG7UP",114,0)
 ; access to the delimiters from the original message.
"RTN","MAG7UP",115,0)
 S @XTREE@(XNSEG,XNFLD)=$$DEESC(XFLD)
"RTN","MAG7UP",116,0)
 ;
"RTN","MAG7UP",117,0)
 ; Break out to the lowest delimiter level too.  This is not strictly an
"RTN","MAG7UP",118,0)
 ; HL7 parse because it does not take actual HL7 (or realm constraining)
"RTN","MAG7UP",119,0)
 ; data types into account.
"RTN","MAG7UP",120,0)
 ;
"RTN","MAG7UP",121,0)
 F NREP=1:1:$L(XFLD,URS) S REP=$P(XFLD,URS,NREP) I REP]"" D
"RTN","MAG7UP",122,0)
 . F NCMP=1:1:$L(REP,UCS) S CMP=$P(REP,UCS,NCMP) I CMP]"" D
"RTN","MAG7UP",123,0)
 . . ; Per DICOM meeting 2004-02-24, reaffirmed that data may need to be
"RTN","MAG7UP",124,0)
 . . ; retrieved above the subcomponent level, and that those data will
"RTN","MAG7UP",125,0)
 . . ; need to be de-escaped because the receiving application won't have
"RTN","MAG7UP",126,0)
 . . ; access to the delimiters from the original message.
"RTN","MAG7UP",127,0)
 . . S @XTREE@(XNSEG,XNFLD,NREP,NCMP)=$$DEESC(CMP)
"RTN","MAG7UP",128,0)
 . . F NSCM=1:1:$L(CMP,USS) S SCM=$P(CMP,USS,NSCM) I SCM]"" D
"RTN","MAG7UP",129,0)
 . . . S @XTREE@(XNSEG,XNFLD,NREP,NCMP,NSCM)=$$DEESC(SCM)
"RTN","MAG7UP",130,0)
 . . . Q
"RTN","MAG7UP",131,0)
 . . Q
"RTN","MAG7UP",132,0)
 . Q
"RTN","MAG7UP",133,0)
 Q
"RTN","MAG7UP",134,0)
 ;
"RTN","MAG7UP",135,0)
DEESC(XSCM) ; replace escape sequences with delimiter characters
"RTN","MAG7UP",136,0)
 ;
"RTN","MAG7UP",137,0)
 ; input:  XSCM   element data before replacement
"RTN","MAG7UP",138,0)
 ;
"RTN","MAG7UP",139,0)
 ; expects:  UFSESC, UCSESC, URSESC, UECESC, USSESC
"RTN","MAG7UP",140,0)
 ;                delimiter escape sequences
"RTN","MAG7UP",141,0)
 ;
"RTN","MAG7UP",142,0)
 ; function return:  element data after replacement
"RTN","MAG7UP",143,0)
 ;
"RTN","MAG7UP",144,0)
 N HIT ; need another pass after each hit
"RTN","MAG7UP",145,0)
 F  D  Q:'$D(HIT)
"RTN","MAG7UP",146,0)
 . K HIT
"RTN","MAG7UP",147,0)
 . I XSCM[UFSESC S XSCM=$P(XSCM,UFSESC)_UFS_$P(XSCM,UFSESC,2,99999),HIT=1
"RTN","MAG7UP",148,0)
 . I XSCM[UCSESC S XSCM=$P(XSCM,UCSESC)_UCS_$P(XSCM,UCSESC,2,99999),HIT=1
"RTN","MAG7UP",149,0)
 . I XSCM[URSESC S XSCM=$P(XSCM,URSESC)_URS_$P(XSCM,URSESC,2,99999),HIT=1
"RTN","MAG7UP",150,0)
 . I XSCM[UECESC S XSCM=$P(XSCM,UECESC)_UEC_$P(XSCM,UECESC,2,99999),HIT=1
"RTN","MAG7UP",151,0)
 . I XSCM[USSESC S XSCM=$P(XSCM,USSESC)_USS_$P(XSCM,USSESC,2,99999),HIT=1
"RTN","MAG7UP",152,0)
 . Q
"RTN","MAG7UP",153,0)
 Q $E(XSCM,1,510)
"RTN","MAG7UP",154,0)
 ;
"RTN","MAGDHL7")
0^15^B8379265
"RTN","MAGDHL7",1,0)
MAGDHL7 ;WOIFO/PMK,MLH - Routine to copy HL7 data from HLSDATA to ^MAGDHL7 ;30 Mar 2017 9:33 AM
"RTN","MAGDHL7",2,0)
 ;;3.0;IMAGING;**11,30,86,54,183**;12-May-2007;Build 11
"RTN","MAGDHL7",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHL7",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHL7",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHL7",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHL7",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHL7",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHL7",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHL7",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHL7",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHL7",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHL7",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHL7",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHL7",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHL7",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHL7",17,0)
 ;;
"RTN","MAGDHL7",18,0)
 Q
"RTN","MAGDHL7",19,0)
 ;
"RTN","MAGDHL7",20,0)
EN ; Entry point for HL7 1.6. Called from the MAGD SEND ORU/ORM protocols.
"RTN","MAGDHL7",21,0)
 ; Executed after the RA protocols setup the HL7 message segments.
"RTN","MAGDHL7",22,0)
 N DA,DIE,DIC,DR,I,J,K,L,MAGRAD,MAGRAN,MAGSAN,MAGTYPE,Y,X
"RTN","MAGDHL7",23,0)
 I $D(HLQUIT),HLQUIT Q  ; HL7 routines may have failed.
"RTN","MAGDHL7",24,0)
 S MAGRAD=""
"RTN","MAGDHL7",25,0)
 F I=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MAGDHL7",26,0)
 . S MAGRAD(I)=HLNODE,J=0
"RTN","MAGDHL7",27,0)
 . F  S J=$O(HLNODE(J)) Q:'J  S MAGRAD(I)=MAGRAD(I)_HLNODE(J)
"RTN","MAGDHL7",28,0)
 . Q
"RTN","MAGDHL7",29,0)
 ; Above code needed for segments greater than 245 characters.
"RTN","MAGDHL7",30,0)
 S MAGTYPE=$G(HL("MTN")),MAGRAN=$G(HL("RAN")),MAGSAN=$G(HL("SAN"))
"RTN","MAGDHL7",31,0)
 ;
"RTN","MAGDHL7",32,0)
 ; Add the entry in the MAGDHL7(2006.5 global.
"RTN","MAGDHL7",33,0)
 S Y=$$NEWMSG($$NOW^XLFDT()\1)
"RTN","MAGDHL7",34,0)
 I +Y<1 Q  ; Entry not made in file.
"RTN","MAGDHL7",35,0)
 S $P(^MAGDHL7(2006.5,+Y,0),"^",2)=MAGTYPE
"RTN","MAGDHL7",36,0)
 ; Add HL7 message into word processing field.
"RTN","MAGDHL7",37,0)
 S (L,K)=0 F  S K=$O(MAGRAD(K)) Q:'K  S L=L+1,^MAGDHL7(2006.5,+Y,1,L,0)=MAGRAD(K) D
"RTN","MAGDHL7",38,0)
 . ; If segment has more than one line of data, add as a single line
"RTN","MAGDHL7",39,0)
 . ; Peter's code will take care of this.
"RTN","MAGDHL7",40,0)
 . S J=0 F  S J=$O(MAGRAD(K,J)) Q:'J  S L=L+1,^MAGDHL7(2006.5,+Y,1,L,0)=MAGRAD(K,J)
"RTN","MAGDHL7",41,0)
 S ^MAGDHL7(2006.5,+Y,1,0)="^2006.502^"_L_"^"_L_"^"_DT
"RTN","MAGDHL7",42,0)
 S X=$P($G(^MAGDHL7(2006.5,+Y,0)),"^",3)
"RTN","MAGDHL7",43,0)
 K:X ^MAGDHL7(2006.5,"C",X,+Y)
"RTN","MAGDHL7",44,0)
 S X=$$NOW^XLFDT
"RTN","MAGDHL7",45,0)
 S $P(^MAGDHL7(2006.5,+Y,0),"^",3)=X
"RTN","MAGDHL7",46,0)
 S ^MAGDHL7(2006.5,"C",X,+Y)=""
"RTN","MAGDHL7",47,0)
 Q
"RTN","MAGDHL7",48,0)
 ;
"RTN","MAGDHL7",49,0)
NEWMSG(DATE) ; Add a stub for a new message
"RTN","MAGDHL7",50,0)
 N D0,HDR
"RTN","MAGDHL7",51,0)
 S DATE=DATE\1
"RTN","MAGDHL7",52,0)
 L +^MAGDHL7(2006.5,0):1E9 ; Background process MUST wait
"RTN","MAGDHL7",53,0)
 S D0=$O(^MAGDHL7(2006.5," "),-1)+1
"RTN","MAGDHL7",54,0)
 S ^MAGDHL7(2006.5,D0,0)=DATE
"RTN","MAGDHL7",55,0)
 S:DATE'="" ^MAGDHL7(2006.5,"B",DATE,D0)=""
"RTN","MAGDHL7",56,0)
 S HDR=$G(^MAGDHL7(2006.5,0))
"RTN","MAGDHL7",57,0)
 S ^MAGDHL7(2006.5,0)="PACS MESSAGE^2006.5D^"_D0_"^"_($P(HDR,"^",4)+1)
"RTN","MAGDHL7",58,0)
 L -^MAGDHL7(2006.5,0)
"RTN","MAGDHL7",59,0)
 Q D0
"RTN","MAGDHL7T")
1^16
"RTN","MAGDHLE")
0^1^B19989150
"RTN","MAGDHLE",1,0)
MAGDHLE ;WOIFO/SRR/PMK - PACS INTERFACE PID TRIGGERS ;26 Oct 2017 1:30 PM
"RTN","MAGDHLE",2,0)
 ;;3.0;IMAGING;**54,49,183**;Mar 19, 2002;Build 11;Apr 07, 2011
"RTN","MAGDHLE",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHLE",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLE",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHLE",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHLE",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHLE",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHLE",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHLE",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHLE",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHLE",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHLE",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHLE",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHLE",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHLE",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLE",17,0)
 ;;
"RTN","MAGDHLE",18,0)
 ; Supported IA #2602 Reading AUDIT file (#1.1) ^DIA(2,...) 
"RTN","MAGDHLE",19,0)
 Q
"RTN","MAGDHLE",20,0)
 ;
"RTN","MAGDHLE",21,0)
SENDA08(DFN) ; External API entry point from Radiology Package - P183 PMK 3/16/17
"RTN","MAGDHLE",22,0)
 N MAGSENDA08 S MAGSENDA08=1 ; flag to indicate API call
"RTN","MAGDHLE",23,0)
 ; drop through to ADTA08
"RTN","MAGDHLE",24,0)
 ;
"RTN","MAGDHLE",25,0)
ADTA08 ; Patient Update event from VAFC ADT-A08 SERVER event driver - P183 PMK 3/16/17
"RTN","MAGDHLE",26,0)
 ; Upon entry, DFN will be set to the patient
"RTN","MAGDHLE",27,0)
 ; The DG* variables are not defined by the VAFC package
"RTN","MAGDHLE",28,0)
 N DGPMDA,DGNOW,DGPMA,DGPMT,MAGKTYP,MAGDPTCL
"RTN","MAGDHLE",29,0)
 N HLECH,HLFS,HLINSTN,HLPARAM,HLPID,HLRFREQ,HLSFREQ,HLSAN,HLTYPE,HLQ,HLXM
"RTN","MAGDHLE",30,0)
 N HL771RF,HL771SF,HLCS,HLDOM,HLN,HLPARM,HLREC,SEGIX,SUB4,VA,VADM,VACNTRY
"RTN","MAGDHLE",31,0)
 N SSNCHANGES ;--- array of old & new SSNs, indexed chronologically
"RTN","MAGDHLE",32,0)
 ;
"RTN","MAGDHLE",33,0)
 S (DGPMDA,DGNOW,DGPMA,MAGDPTCL)="" ; unused
"RTN","MAGDHLE",34,0)
 I $$SSNCHECK(.SSNCHANGES) D  ; generate ADT A47
"RTN","MAGDHLE",35,0)
 . S DGPMT=47 ; set DGPMT variable for use in MAGDHLI
"RTN","MAGDHLE",36,0)
 . S MAGKTYP=47 ; set MAGKTYP variable for EVN+1 below
"RTN","MAGDHLE",37,0)
 . Q
"RTN","MAGDHLE",38,0)
 E  D  ; generate ADT A08
"RTN","MAGDHLE",39,0)
 . S DGPMT=8 ; set DGPMT variable for use in MAGDHLI
"RTN","MAGDHLE",40,0)
 . S MAGKTYP=8 ; set MAGKTYP variable for EVN+1 below
"RTN","MAGDHLE",41,0)
 . Q
"RTN","MAGDHLE",42,0)
 G TSK ; generate the HL7 ADT A08 or ADT A47 message
"RTN","MAGDHLE",43,0)
 ;
"RTN","MAGDHLE",44,0)
SSNCHECK(SSNCHANGES) ; Check for SSN change, return values
"RTN","MAGDHLE",45,0)
 ; Return 1 if there was an SSN change and 0 otherwise
"RTN","MAGDHLE",46,0)
 ; If there was an SSN change, do the following:
"RTN","MAGDHLE",47,0)
 ;   save the old value in SSNCHANGES(DATEIME,"OLD")
"RTN","MAGDHLE",48,0)
 ;   save the new value in SSNCHANGES(DATEIME,"NEW")
"RTN","MAGDHLE",49,0)
 ;   set NEWSSN(DATEIME) to the new value
"RTN","MAGDHLE",50,0)
 N DATETIME ; date and time of the SSN change
"RTN","MAGDHLE",51,0)
 N DIAIEN ; ien of the record in the AUDIT file (#1.1)
"RTN","MAGDHLE",52,0)
 N FIELDNUMBER ; SSN is field .09 in the PATIENT file (#2)
"RTN","MAGDHLE",53,0)
 N OLDSSN ; previous value of SSN, can't be null
"RTN","MAGDHLE",54,0)
 N X
"RTN","MAGDHLE",55,0)
 S DIAIEN=""
"RTN","MAGDHLE",56,0)
 F  S DIAIEN=$O(^DIA(2,"B",DFN,DIAIEN)) Q:DIAIEN=""  D
"RTN","MAGDHLE",57,0)
 . S X=$G(^DIA(2,DIAIEN,0))
"RTN","MAGDHLE",58,0)
 . S DATETIME=$P(X,"^",2),FIELDNUMBER=$P(X,"^",3)
"RTN","MAGDHLE",59,0)
 . I FIELDNUMBER'=.09 Q  ; not an SSN change record
"RTN","MAGDHLE",60,0)
 . S OLDSSN=$G(^DIA(2,DIAIEN,2))
"RTN","MAGDHLE",61,0)
 . I OLDSSN="" Q  ; no previous SSN value, don't send A47
"RTN","MAGDHLE",62,0)
 . S SSNCHANGES(DATETIME,"OLD")=OLDSSN
"RTN","MAGDHLE",63,0)
 . S SSNCHANGES(DATETIME,"NEW")=$G(^DIA(2,DIAIEN,3))
"RTN","MAGDHLE",64,0)
 . Q
"RTN","MAGDHLE",65,0)
 I '$G(MAGSENDA08) D  ; invocation by HL7 event driver
"RTN","MAGDHLE",66,0)
  . ; invocation by VAFC ADT-A08 SERVER event driver
"RTN","MAGDHLE",67,0)
  . ; keep the most recent change if it was done today
"RTN","MAGDHLE",68,0)
  . N A
"RTN","MAGDHLE",69,0)
  . S DATETIME=$O(SSNCHANGES(""),-1)
"RTN","MAGDHLE",70,0)
  . I DATETIME M A(DATETIME)=SSNCHANGES(DATETIME) ; save last change
"RTN","MAGDHLE",71,0)
  . K SSNCHANGES ; kill the SSN change history
"RTN","MAGDHLE",72,0)
  . I DT>DATETIME K A ; if last change was before today, kill it too
"RTN","MAGDHLE",73,0)
  . M SSNCHANGES=A ; save last change, if any
"RTN","MAGDHLE",74,0)
  . Q
"RTN","MAGDHLE",75,0)
 Q $D(SSNCHANGES)
"RTN","MAGDHLE",76,0)
 ;
"RTN","MAGDHLE",77,0)
 ;
"RTN","MAGDHLE",78,0)
ADT ;ADT EVENTS ;From EVENT driver
"RTN","MAGDHLE",79,0)
 ;Protocol = MAGD DHCP-PACS ADT EVENTS
"RTN","MAGDHLE",80,0)
 ;IN ;DFN
"RTN","MAGDHLE",81,0)
 ;DGPMDA = IFN Primary Movement
"RTN","MAGDHLE",82,0)
 ;DGPMA = 0th node Primary Movement AFTER movement
"RTN","MAGDHLE",83,0)
 ;DGPMP = 0th node PRIOR to movement
"RTN","MAGDHLE",84,0)
 ;^UTILITY("DGPM",$J,TRANSACTION (1,2,3,6),MOVEMENT (IFN),"P"/"A")
"RTN","MAGDHLE",85,0)
 ;
"RTN","MAGDHLE",86,0)
 N I K MAGKTYP F I=1,2,3 I $D(^UTILITY("DGPM",$J,I,DGPMDA)) S MAGKTYP=I
"RTN","MAGDHLE",87,0)
 Q:'$D(MAGKTYP)  I MAGKTYP=2,$P(^UTILITY("DGPM",$J,2,DGPMDA,"A"),U,6)=$P(^("P"),U,6) G EX
"RTN","MAGDHLE",88,0)
 ;
"RTN","MAGDHLE",89,0)
 ;
"RTN","MAGDHLE",90,0)
TSK ;CREATE TASK to make HL7 messages
"RTN","MAGDHLE",91,0)
 S ZTSAVE("MAGKTYP")="",ZTSAVE("MAGDPTCL")="",ZTSAVE("SSNCHANGES(")="" ; P183 PMK 3/9/17
"RTN","MAGDHLE",92,0)
 S ZTSAVE("DGPMDA")="",ZTSAVE("DGNOW")="",ZTSAVE("DGPMA")=""
"RTN","MAGDHLE",93,0)
 S ZTSAVE("DFN")="",ZTSAVE("DGPMT")="",ZTDTH=$H,ZTIO=""
"RTN","MAGDHLE",94,0)
 S ZTRTN="HL7^MAGDHLE",ZTDESC=$S(MAGKTYP=8:"PID",1:"ADT")_" HL7 PACS MESSAGE"
"RTN","MAGDHLE",95,0)
 I $$PROD^XUPROD D  ; production - P183 PMK 3/30/2017
"RTN","MAGDHLE",96,0)
 . D ^%ZTLOAD
"RTN","MAGDHLE",97,0)
 . Q
"RTN","MAGDHLE",98,0)
 E  D  ; development
"RTN","MAGDHLE",99,0)
 . N HLTC,HLDT,HLDT1,HLMID,HLRESLT1,HLENROU,HLEXROU ; GENERATE^HLMA variables
"RTN","MAGDHLE",100,0)
 . W !?5,"*** HL7 TASK FOR PACS ***"
"RTN","MAGDHLE",101,0)
 . D HL7 ; enable debugging in development
"RTN","MAGDHLE",102,0)
 . Q 
"RTN","MAGDHLE",103,0)
 G EX
"RTN","MAGDHLE",104,0)
 ;
"RTN","MAGDHLE",105,0)
HL7 ;Create HL7 message
"RTN","MAGDHLE",106,0)
 I $P($G(^MAG(2006.1,1,"IHE")),"^",1)="Y" D ADT^MAGDHLI
"RTN","MAGDHLE",107,0)
 Q
"RTN","MAGDHLE",108,0)
 ;
"RTN","MAGDHLE",109,0)
EX ;EXIT
"RTN","MAGDHLE",110,0)
 K ZTRTN,ZTDESC,ZTIO,ZTDTH,ZTSAVE
"RTN","MAGDHLE",111,0)
 K MAGKPID,MAGKTYP
"RTN","MAGDHLE",112,0)
 Q
"RTN","MAGDHLE",113,0)
 ;
"RTN","MAGDHLE",114,0)
 ; Vestigal code, kept around since there still cross references somewhere
"RTN","MAGDHLE",115,0)
SET ;Set Logic from MUMPS x-ref on fields .01,.03,.09 of ^DD(2 (^DPT)
"RTN","MAGDHLE",116,0)
 Q
"RTN","MAGDHLE",117,0)
 ;
"RTN","MAGDHLE",118,0)
KIL ;Kill logic "AKn" cross references
"RTN","MAGDHLE",119,0)
 Q
"RTN","MAGDHLI")
0^2^B8285914
"RTN","MAGDHLI",1,0)
MAGDHLI ;WOIFO/MLH/PMK - IHE-based ADT interface for PACS ;22 Mar 2017 8:07 AM
"RTN","MAGDHLI",2,0)
 ;;3.0;IMAGING;**49,183**;05-October-2009;Build 11;Build 1463
"RTN","MAGDHLI",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHLI",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLI",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHLI",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHLI",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHLI",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHLI",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHLI",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHLI",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHLI",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHLI",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHLI",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHLI",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHLI",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLI",17,0)
 ;;
"RTN","MAGDHLI",18,0)
 Q
"RTN","MAGDHLI",19,0)
 ;
"RTN","MAGDHLI",20,0)
ADT ; MAIN ENTRY POINT - Generate the appropriate ADT message.
"RTN","MAGDHLI",21,0)
 N STAT ; status of HL7 message generation
"RTN","MAGDHLI",22,0)
 N OCCURRED ; date/time the event occurred (from DGPMA)
"RTN","MAGDHLI",23,0)
 ;
"RTN","MAGDHLI",24,0)
 I DGPMT=1 D  Q  ; admission
"RTN","MAGDHLI",25,0)
 . S OCCURRED=$P($G(DGPMA),"^",1)
"RTN","MAGDHLI",26,0)
 . S STAT=$S(OCCURRED:$$A01^MAGDHLT(DFN,OCCURRED),1:$$A11^MAGDHLT(DFN,DGNOW))
"RTN","MAGDHLI",27,0)
 . Q
"RTN","MAGDHLI",28,0)
 I DGPMT=2 D  Q  ; transfer
"RTN","MAGDHLI",29,0)
 . S OCCURRED=$P($G(DGPMA),"^",1)
"RTN","MAGDHLI",30,0)
 . S STAT=$S(OCCURRED:$$A02^MAGDHLT(DFN,OCCURRED),1:$$A12^MAGDHLT(DFN,DGNOW))
"RTN","MAGDHLI",31,0)
 . Q
"RTN","MAGDHLI",32,0)
 I DGPMT=3 D  Q  ; discharge
"RTN","MAGDHLI",33,0)
 . S OCCURRED=$P($G(DGPMA),"^",1)
"RTN","MAGDHLI",34,0)
 . S STAT=$S(OCCURRED:$$A03^MAGDHLT(DFN,OCCURRED),1:$$A13^MAGDHLT(DFN,DGNOW))
"RTN","MAGDHLI",35,0)
 . Q
"RTN","MAGDHLI",36,0)
 I DGPMT=8 D  Q  ; patient information update - P183 PMK 3/9/17
"RTN","MAGDHLI",37,0)
 . S STAT=$$A08^MAGDHLT(DFN)
"RTN","MAGDHLI",38,0)
 . Q
"RTN","MAGDHLI",39,0)
 I DGPMT=47 D  Q  ; change patient identifier list - P183 PMK 3/9/17
"RTN","MAGDHLI",40,0)
 . N DATETIME,NEWSSN,OLDSSN
"RTN","MAGDHLI",41,0)
 . ; send the last SSN change for VAFC ADT-A08 SERVER event, or
"RTN","MAGDHLI",42,0)
 . ; all SSN changes for a call from the SENDA08 API entry point
"RTN","MAGDHLI",43,0)
 . S DATETIME=""
"RTN","MAGDHLI",44,0)
 . F  S DATETIME=$O(SSNCHANGES(DATETIME)) Q:DATETIME=""  D
"RTN","MAGDHLI",45,0)
 . . S NEWSSN=SSNCHANGES(DATETIME,"NEW")
"RTN","MAGDHLI",46,0)
 . . S OLDSSN=SSNCHANGES(DATETIME,"OLD")
"RTN","MAGDHLI",47,0)
 . . S STAT=$$A47^MAGDHLT(DFN,OLDSSN,NEWSSN,DATETIME)
"RTN","MAGDHLI",48,0)
 . . Q
"RTN","MAGDHLI",49,0)
 . ; finally, send A08 to change the PID-19 SSN
"RTN","MAGDHLI",50,0)
 . S STAT=$$A08^MAGDHLT(DFN,NEWSSN,DATETIME)
"RTN","MAGDHLI",51,0)
 . Q
"RTN","MAGDHLI",52,0)
 Q
"RTN","MAGDHLL")
0^8^B9309805
"RTN","MAGDHLL",1,0)
MAGDHLL ;WOIFO/MLH/PMK - IHE-based ADT interface for PACS - log to gateway ;07 Nov 2017 2:59 PM
"RTN","MAGDHLL",2,0)
 ;;3.0;IMAGING;**49,138,183**;Mar 19, 2002;Build 11;Jul 26, 2012
"RTN","MAGDHLL",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHLL",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLL",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHLL",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHLL",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHLL",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHLL",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHLL",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHLL",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHLL",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHLL",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHLL",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHLL",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHLL",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLL",17,0)
 ;;
"RTN","MAGDHLL",18,0)
 Q
"RTN","MAGDHLL",19,0)
 ;
"RTN","MAGDHLL",20,0)
LOGGW(XTYP) ; SUBROUTINE - log a generated message to the DICOM/text gateway
"RTN","MAGDHLL",21,0)
 ; input:    XTYP      message type (= MSH-9.1)
"RTN","MAGDHLL",22,0)
 ; expects:  HL()      array of HL7 variables
"RTN","MAGDHLL",23,0)
 ;           HLHDR()   array containing MSH segment info
"RTN","MAGDHLL",24,0)
 ;           HLA()     array of HL7 segments
"RTN","MAGDHLL",25,0)
 ;
"RTN","MAGDHLL",26,0)
 N MSGDT ; ----- message date and time from MSH-7 (in HL7 format)
"RTN","MAGDHLL",27,0)
 N MSGDFM ; ---- MSGDT date only (no time) in FileMan format
"RTN","MAGDHLL",28,0)
 N MSGDTFM ; --- MSGDT date and time in FileMan format
"RTN","MAGDHLL",29,0)
 N GWIX ; ------ gateway message index
"RTN","MAGDHLL",30,0)
 N GWHDR ; ----- 0 node of gateway message file
"RTN","MAGDHLL",31,0)
 N MSH ; ------- message header for gateway
"RTN","MAGDHLL",32,0)
 N GWSGIX ; ---- gateway segment index
"RTN","MAGDHLL",33,0)
 N FS ; -------- field separator
"RTN","MAGDHLL",34,0)
 N I,IX ;------- scratch variables
"RTN","MAGDHLL",35,0)
 ;
"RTN","MAGDHLL",36,0)
 ;
"RTN","MAGDHLL",37,0)
 ; MSH, the HL7 message header segment, is passed in two different
"RTN","MAGDHLL",38,0)
 ; variables, depending upon the subscribers to the event driver.
"RTN","MAGDHLL",39,0)
 ; 
"RTN","MAGDHLL",40,0)
 ; Originally, with just the MAG CPACS Axy SUBS subscriber, the value
"RTN","MAGDHLL",41,0)
 ; was passed in HLHDR(1).
"RTN","MAGDHLL",42,0)
 ; 
"RTN","MAGDHLL",43,0)
 ; When the MAG CPACS Axy SUBS-HLO subscriber was added, because it has
"RTN","MAGDHLL",44,0)
 ; a processing routine, the value was passed in HLREC("HDR") instead.
"RTN","MAGDHLL",45,0)
 ; 
"RTN","MAGDHLL",46,0)
 ; The code on the line below handles both situations.
"RTN","MAGDHLL",47,0)
 ; 
"RTN","MAGDHLL",48,0)
 S MSH=$G(HLHDR(1),$G(HLREC("HDR")))
"RTN","MAGDHLL",49,0)
 I MSH'="" S FS=$E(MSH,4) D MAGDHL7
"RTN","MAGDHLL",50,0)
 Q
"RTN","MAGDHLL",51,0)
 ;
"RTN","MAGDHLL",52,0)
MAGDHL7 ; output the ADT message to ^MAGDHL7 
"RTN","MAGDHLL",53,0)
 L +^MAGDHL7(2006.5,0):1E9 E  Q
"RTN","MAGDHLL",54,0)
 S GWIX=$O(^MAGDHL7(2006.5," "),-1)+1
"RTN","MAGDHLL",55,0)
 S GWHDR=$G(^MAGDHL7(2006.5,0))
"RTN","MAGDHLL",56,0)
 S $P(GWHDR,U,3)=GWIX,$P(GWHDR,U,4)=$P(GWHDR,U,4)+1
"RTN","MAGDHLL",57,0)
 S ^MAGDHL7(2006.5,0)=GWHDR
"RTN","MAGDHLL",58,0)
 S $P(MSH,FS,5)="VISTA DICOM/TEXT GATEWAY"
"RTN","MAGDHLL",59,0)
 S ^MAGDHL7(2006.5,GWIX,1,1,0)=MSH
"RTN","MAGDHLL",60,0)
 S IX=0,GWSGIX=1
"RTN","MAGDHLL",61,0)
 F I=1:1 S IX=$O(HLA("HLS",IX)) Q:'IX  D
"RTN","MAGDHLL",62,0)
 . S GWSGIX=GWSGIX+1
"RTN","MAGDHLL",63,0)
 . S ^MAGDHL7(2006.5,GWIX,1,GWSGIX,0)=HLA("HLS",IX)
"RTN","MAGDHLL",64,0)
 . Q
"RTN","MAGDHLL",65,0)
 S MSGDT=$P($P(MSH,FS,7),"-",1) ; omit TZ offset
"RTN","MAGDHLL",66,0)
 S MSGDFM=$E(MSGDT,1,8)-17000000
"RTN","MAGDHLL",67,0)
 S MSGDTFM=+(MSGDFM_"."_$E(MSGDT,9,12))
"RTN","MAGDHLL",68,0)
 S ^MAGDHL7(2006.5,GWIX,1,0)=U_U_GWSGIX_U_GWSGIX_U_MSGDFM
"RTN","MAGDHLL",69,0)
 S ^MAGDHL7(2006.5,GWIX,0)=MSGDFM_U_XTYP_U_MSGDTFM
"RTN","MAGDHLL",70,0)
 S ^MAGDHL7(2006.5,"B",MSGDFM,GWIX)="" ; P183 PMK 3/6/17
"RTN","MAGDHLL",71,0)
 S ^MAGDHL7(2006.5,"C",MSGDTFM,GWIX)="" ; P183 PMK 3/6/17
"RTN","MAGDHLL",72,0)
 L -^MAGDHL7(2006.5,0)
"RTN","MAGDHLL",73,0)
 Q
"RTN","MAGDHLS")
0^3^B78973085
"RTN","MAGDHLS",1,0)
MAGDHLS ;WOIFO/MLH/JSL/SAF/PMK - IHE-based ADT interface for PACS - segments ;10 Mar 2017 11:59 AM
"RTN","MAGDHLS",2,0)
 ;;3.0;IMAGING;**49,123,141,138,183**;Mar 19, 2002;Build 11;Sep 03, 2013
"RTN","MAGDHLS",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHLS",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLS",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHLS",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHLS",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHLS",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHLS",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHLS",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHLS",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHLS",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHLS",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHLS",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHLS",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHLS",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLS",17,0)
 ;;
"RTN","MAGDHLS",18,0)
 Q
"RTN","MAGDHLS",19,0)
 ;
"RTN","MAGDHLS",20,0)
 ; It is always expected that the HL7 environment variables will have
"RTN","MAGDHLS",21,0)
 ; been initialized by a call to INIT^HLFNC2 for the appropriate event
"RTN","MAGDHLS",22,0)
 ; driver protocol.
"RTN","MAGDHLS",23,0)
 ; 
"RTN","MAGDHLS",24,0)
AL1(XDFN,XYMSG) ; patient allergies
"RTN","MAGDHLS",25,0)
 ; input:  XDFN      internal entry number of the patient on global ^DPT
"RTN","MAGDHLS",26,0)
 ;         XYMSG     name of array to which to add message elts
"RTN","MAGDHLS",27,0)
 ; output: @XYMSG    input array plus new subtree containing EVN elts
"RTN","MAGDHLS",28,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",29,0)
 ; 
"RTN","MAGDHLS",30,0)
 N DFN ; ------ internal entry number on ^DPT
"RTN","MAGDHLS",31,0)
 N GMRAL ;----- return allergy array from EN1^GMRADPT
"RTN","MAGDHLS",32,0)
 N IXAL ; ----- allergy index (on GMRAL array)
"RTN","MAGDHLS",33,0)
 N SETID ; ---- index of the AL1 segment on this message
"RTN","MAGDHLS",34,0)
 N ALDTA ; ---- allergy data
"RTN","MAGDHLS",35,0)
 N IXREAC ; --- reaction index
"RTN","MAGDHLS",36,0)
 N REPIX ; ---- field repetition index
"RTN","MAGDHLS",37,0)
 N VA,VADPT ; - return arrays from DEM^VADPT containing patient demographics
"RTN","MAGDHLS",38,0)
 ;
"RTN","MAGDHLS",39,0)
 D DEM^VADPT
"RTN","MAGDHLS",40,0)
 ;
"RTN","MAGDHLS",41,0)
 K YSEGA
"RTN","MAGDHLS",42,0)
 S DFN=XDFN D EN1^GMRADPT ; get patient's allergies - ICR 10099
"RTN","MAGDHLS",43,0)
 S IXAL=0
"RTN","MAGDHLS",44,0)
 F SETID=1:1 S IXAL=$O(GMRAL(IXAL)) Q:'IXAL  D
"RTN","MAGDHLS",45,0)
 . S ALDTA=$G(GMRAL(IXAL))
"RTN","MAGDHLS",46,0)
 . S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",47,0)
 . S @XYMSG@(SEGIX,0)="AL1"
"RTN","MAGDHLS",48,0)
 . S @XYMSG@(SEGIX,1,1,1,1)=SETID
"RTN","MAGDHLS",49,0)
 . S @XYMSG@(SEGIX,2,1,1,1)=$P(ALDTA,U,7) ; type
"RTN","MAGDHLS",50,0)
 . S @XYMSG@(SEGIX,3,1,2,1)=$P(ALDTA,U,2) ; description
"RTN","MAGDHLS",51,0)
 . S IXREAC=0
"RTN","MAGDHLS",52,0)
 . F REPIX=1:1 S IXREAC=$O(GMRAL(IXAL,"S",IXREAC)) Q:'IXREAC  D
"RTN","MAGDHLS",53,0)
 . . S @XYMSG@(SEGIX,5,REPIX,1,1)=$P($G(GMRAL(IXAL,"S",IXREAC)),";",1) ; reaction
"RTN","MAGDHLS",54,0)
 . . Q
"RTN","MAGDHLS",55,0)
 . Q
"RTN","MAGDHLS",56,0)
 Q 0
"RTN","MAGDHLS",57,0)
 ;
"RTN","MAGDHLS",58,0)
DG1(XDFN,XYMSG) ; FUNCTION - diagnosis
"RTN","MAGDHLS",59,0)
 ; input:  XDFN      internal entry number of the patient on global ^DPT
"RTN","MAGDHLS",60,0)
 ;         XYMSG     name of array to which to add message elts
"RTN","MAGDHLS",61,0)
 ; output: @XYMSG    input array plus new subtree containing EVN elts
"RTN","MAGDHLS",62,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",63,0)
 ;
"RTN","MAGDHLS",64,0)
 N DFN ; ----- internal entry number on ^DPT
"RTN","MAGDHLS",65,0)
 N VAIP ; ---- inpatient episode data array
"RTN","MAGDHLS",66,0)
 N SETID ; --- segment index for diagnoses
"RTN","MAGDHLS",67,0)
 N APROB ; --- problem list array
"RTN","MAGDHLS",68,0)
 N PROBIX ; -- problem list index
"RTN","MAGDHLS",69,0)
 ;
"RTN","MAGDHLS",70,0)
 S SETID=0 ; segment increment base
"RTN","MAGDHLS",71,0)
 S DFN=XDFN D IN5^VADPT ; get patient's inpatient episode data
"RTN","MAGDHLS",72,0)
 I $G(VAIP(9))'="" D  ; is there a diag assoc'd w/the latest movement?
"RTN","MAGDHLS",73,0)
 . ; yes, populate data for the DG1 segment
"RTN","MAGDHLS",74,0)
 . S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",75,0)
 . S @XYMSG@(SEGIX,0)="DG1" ; segment ID
"RTN","MAGDHLS",76,0)
 . ; populate element leaves
"RTN","MAGDHLS",77,0)
 . S SETID=SETID+1
"RTN","MAGDHLS",78,0)
 . S @XYMSG@(SEGIX,1,1,1,1)=SETID
"RTN","MAGDHLS",79,0)
 . S @XYMSG@(SEGIX,3,1,2,1)=$E(VAIP(9),1,249) ; diagnosis text
"RTN","MAGDHLS",80,0)
 . ; either admitting or working diagnosis
"RTN","MAGDHLS",81,0)
 . S @XYMSG@(SEGIX,6,1,1,1)=$S($P($G(VAIP(2)),"^",1)=1:"A",1:"W")
"RTN","MAGDHLS",82,0)
 . Q
"RTN","MAGDHLS",83,0)
 ;
"RTN","MAGDHLS",84,0)
 ; get patient's active problem list
"RTN","MAGDHLS",85,0)
 D ACTIVE^GMPLUTL(XDFN,.APROB) ; DBIA #928
"RTN","MAGDHLS",86,0)
 S PROBIX=0
"RTN","MAGDHLS",87,0)
 F  S PROBIX=$O(APROB(PROBIX)) Q:'PROBIX  D
"RTN","MAGDHLS",88,0)
 . S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",89,0)
 . S @XYMSG@(SEGIX,0)="DG1" ; segment ID
"RTN","MAGDHLS",90,0)
 . ; populate element leaves
"RTN","MAGDHLS",91,0)
 . S SETID=SETID+1
"RTN","MAGDHLS",92,0)
 . S @XYMSG@(SEGIX,1,1,1,1)=SETID
"RTN","MAGDHLS",93,0)
 . S @XYMSG@(SEGIX,3,1,2,1)=$E($P(APROB(PROBIX,1),"^",2),1,249) ; problem text
"RTN","MAGDHLS",94,0)
 . S @XYMSG@(SEGIX,6,1,1,1)="W" ; working diagnosis
"RTN","MAGDHLS",95,0)
 . Q
"RTN","MAGDHLS",96,0)
 ;
"RTN","MAGDHLS",97,0)
 Q 0
"RTN","MAGDHLS",98,0)
 ;
"RTN","MAGDHLS",99,0)
EVN(XEVENT,XEVNRDT,XEVNODT,XYMSG) ; FUNCTION - event
"RTN","MAGDHLS",100,0)
 ; input:  XEVENT   trigger event code
"RTN","MAGDHLS",101,0)
 ;         XEVNRDT  date/time the event was recorded (FM format)
"RTN","MAGDHLS",102,0)
 ;         XEVNODT  date/time the event occurred (FM format)
"RTN","MAGDHLS",103,0)
 ;         XYMSG    name of array to which to add message elts
"RTN","MAGDHLS",104,0)
 ; output: @XYMSG   input array plus new subtree containing EVN elts
"RTN","MAGDHLS",105,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",106,0)
 ; 
"RTN","MAGDHLS",107,0)
 N SEGIX ; ---- segment index on @XYMSG
"RTN","MAGDHLS",108,0)
 N STAT ; ----- status return from function calls
"RTN","MAGDHLS",109,0)
 N FLDIX ; ---- field index on @XYMSG
"RTN","MAGDHLS",110,0)
 ;
"RTN","MAGDHLS",111,0)
 S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",112,0)
 S @XYMSG@(SEGIX,0)="EVN"
"RTN","MAGDHLS",113,0)
 ; populate trigger event code and dates into element leaves
"RTN","MAGDHLS",114,0)
 S @XYMSG@(SEGIX,1,1,1,1)=XEVENT
"RTN","MAGDHLS",115,0)
 S @XYMSG@(SEGIX,2,1,1,1)=$$FMTHL7^XLFDT(XEVNRDT)
"RTN","MAGDHLS",116,0)
 S @XYMSG@(SEGIX,6,1,1,1)=$$FMTHL7^XLFDT(XEVNODT)
"RTN","MAGDHLS",117,0)
 F FLDIX=2,6 S STAT=$$STRIP0^MAG7UD($NA(@XYMSG@(SEGIX,FLDIX,1,1,1)))
"RTN","MAGDHLS",118,0)
 Q 0
"RTN","MAGDHLS",119,0)
 ;
"RTN","MAGDHLS",120,0)
MRG(XMRGSSN,XYMSG) ; FUNCTION - update SSN - P183 PMK 3/10/17
"RTN","MAGDHLS",121,0)
 ; input:  XMRGSSN   Previous value of SSN
"RTN","MAGDHLS",122,0)
 ;         XYMSG     name of array to which to add MRG segment
"RTN","MAGDHLS",123,0)
 ; output: @XYMSG    input array plus new subtree containing MRG elts
"RTN","MAGDHLS",124,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",125,0)
 ;         
"RTN","MAGDHLS",126,0)
 N SEGIX ; ---- segment index on @XYMSG
"RTN","MAGDHLS",127,0)
 N STAT ; ----- status return from function calls
"RTN","MAGDHLS",128,0)
 ;
"RTN","MAGDHLS",129,0)
 S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",130,0)
 S @XYMSG@(SEGIX,0)="MRG"
"RTN","MAGDHLS",131,0)
 ; populate SSN info into element leaves
"RTN","MAGDHLS",132,0)
 S @XYMSG@(SEGIX,1,1,1,1)=XMRGSSN
"RTN","MAGDHLS",133,0)
 S @XYMSG@(SEGIX,1,1,4,1)=$S($$ISIHS^MAGSPID():"USIHS",1:"USVHA")  ;P123
"RTN","MAGDHLS",134,0)
 S @XYMSG@(SEGIX,1,1,5,1)="NI"
"RTN","MAGDHLS",135,0)
 Q 0
"RTN","MAGDHLS",136,0)
 ;
"RTN","MAGDHLS",137,0)
OBXADT(XDFN,XYMSG) G OBXADT^MAGDHLSO ; FUNCTION - patient height/weight
"RTN","MAGDHLS",138,0)
 ;
"RTN","MAGDHLS",139,0)
PID(XDFN,XYMSG) ; FUNCTION - patient ID/demo
"RTN","MAGDHLS",140,0)
 ; input:  XDFN      internal entry number of the pt on gbl ^DPT
"RTN","MAGDHLS",141,0)
 ;         XYMSG    name of array to which to add message elts
"RTN","MAGDHLS",142,0)
 ; output: @XYMSG    input array plus new subtree containing PID elts
"RTN","MAGDHLS",143,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",144,0)
 ;
"RTN","MAGDHLS",145,0)
 N PIDARY ; --- array for segment to be returned by VistA HL7 fcn
"RTN","MAGDHLS",146,0)
 N HL ; ------- array containing delims, etc. expected by VistA HL7 fcn
"RTN","MAGDHLS",147,0)
 N MSGDMY ; --- dummy array of scalar message lines for parser
"RTN","MAGDHLS",148,0)
 N I ; -------- loop counter
"RTN","MAGDHLS",149,0)
 N IX,IX1,IX2,IX3,IX4 ; dummy indices
"RTN","MAGDHLS",150,0)
 N SEGIX ; ---- segment index on @XYMSG
"RTN","MAGDHLS",151,0)
 N NUL ; ------ null return from called function
"RTN","MAGDHLS",152,0)
 N MSGTREE ; -- tree of message elements to be returned by $$PARSE^MAG7UP
"RTN","MAGDHLS",153,0)
 N STAT ; ----- status return from function calls
"RTN","MAGDHLS",154,0)
 N PTICN ; ---- patient integration control number
"RTN","MAGDHLS",155,0)
 N DFN ; ------ patient internal entry number (needed for VADPT call)
"RTN","MAGDHLS",156,0)
 N VAFPID ; --- overflow array from $$EN^VAFHLPID() ; P141 PMK 5/6/2013
"RTN","MAGDHLS",157,0)
 ;
"RTN","MAGDHLS",158,0)
 S HL("ECH")=HLECH,HL("FS")=HLFS,HL("Q")=HLQ
"RTN","MAGDHLS",159,0)
 ; does pt have a national ICN?
"RTN","MAGDHLS",160,0)
 I $L($T(IFLOCAL^MPIF001)) I $$IFLOCAL^MPIF001(XDFN)'=1 D   ;p123 - ICN is local, not national
"RTN","MAGDHLS",161,0)
 . S PTICN=$$GETICN^MPIF001(XDFN) ; ICR #2701
"RTN","MAGDHLS",162,0)
 . K:+PTICN<0 PTICN ; no ICN exists
"RTN","MAGDHLS",163,0)
 . Q
"RTN","MAGDHLS",164,0)
 ; build a dummy message including MSH, PID
"RTN","MAGDHLS",165,0)
 ; (MSH required for $$PARSE^MAG7UP to work)
"RTN","MAGDHLS",166,0)
 S MSGDMY(1)="MSH"_HLFS_HLECH
"RTN","MAGDHLS",167,0)
 S MSGDMY(2)=$$EN^VAFHLPID(XDFN,"5,7,8,10BN,11,13,14,19,22B"),IX=0 ; DBIA #263 - P141 PMK 5/6/2013, P183 PMK 3/9/2017
"RTN","MAGDHLS",168,0)
 ; if the result string is longer than 245, the remaining characters are
"RTN","MAGDHLS",169,0)
 ; returned in VAFPID(n), where n is a sequential number beginning with 1
"RTN","MAGDHLS",170,0)
 F I=1:1 Q:'$D(VAFPID(I))  S MSGDMY(2)=MSGDMY(2)_VAFPID(I) ; P141 PMK 5/6/2013
"RTN","MAGDHLS",171,0)
 S NUL=$$PARSE^MAG7UP("MSGDMY","MSGTREE") ; parse the message
"RTN","MAGDHLS",172,0)
 S DFN=XDFN D PID^VADPT  ;Get patient Identifiers in VA array
"RTN","MAGDHLS",173,0)
 ; purge patient identifiers PID-2 thru PID-4
"RTN","MAGDHLS",174,0)
 F IX=2,3,4 K MSGTREE(2,IX)
"RTN","MAGDHLS",175,0)
 ; assign station number-dfn to PID-2
"RTN","MAGDHLS",176,0)
 S MSGTREE(2,2,1,1,1)=$$STATNUMB^MAGDFCNV()_"-"_XDFN
"RTN","MAGDHLS",177,0)
 S MSGTREE(2,2,1,2,1)=""
"RTN","MAGDHLS",178,0)
 S MSGTREE(2,2,1,3,1)=""
"RTN","MAGDHLS",179,0)
 S MSGTREE(2,2,1,4,1)=$S($$ISIHS^MAGSPID():"USIHS",1:"USVHA")  ;P123
"RTN","MAGDHLS",180,0)
 S MSGTREE(2,2,1,5,1)="PI"
"RTN","MAGDHLS",181,0)
 ; assign HRN or social security number to PID-3
"RTN","MAGDHLS",182,0)
 S MSGTREE(2,3,1,1,1)=$S($$ISIHS^MAGSPID():VA("PID"),1:$G(MSGTREE(2,19,1,1,1)))  ;P123
"RTN","MAGDHLS",183,0)
 S MSGTREE(2,3,1,2,1)=""
"RTN","MAGDHLS",184,0)
 S MSGTREE(2,3,1,3,1)=""
"RTN","MAGDHLS",185,0)
 S MSGTREE(2,3,1,4,1)=$S($$ISIHS^MAGSPID():"USIHS",1:"USVHA")  ;P123
"RTN","MAGDHLS",186,0)
 S MSGTREE(2,3,1,5,1)=$S($$ISIHS^MAGSPID():"MR",1:"NI")  ;P110
"RTN","MAGDHLS",187,0)
 D:$D(PTICN)  ; use nat'l ICN (if available) as the alternate pt id in PID-4
"RTN","MAGDHLS",188,0)
 . S MSGTREE(2,4,1,1,1)=PTICN
"RTN","MAGDHLS",189,0)
 . S MSGTREE(2,4,1,2,1)="" ; no checksum (included in ICN)
"RTN","MAGDHLS",190,0)
 . S MSGTREE(2,4,1,3,1)="" ; no checksum (included in ICN)
"RTN","MAGDHLS",191,0)
 . S MSGTREE(2,4,1,4,1)=$S($$ISIHS^MAGSPID():"USIHS",1:"USVHA")  ;P123
"RTN","MAGDHLS",192,0)
 . S MSGTREE(2,4,1,5,1)="NI"
"RTN","MAGDHLS",193,0)
 . Q
"RTN","MAGDHLS",194,0)
 ; strip suffix, if any, off race and ethnicity codes
"RTN","MAGDHLS",195,0)
 F IX1=10,22 D
"RTN","MAGDHLS",196,0)
 . S IX2="" F  S IX2=$O(MSGTREE(2,IX1,IX2)) Q:IX2=""  D
"RTN","MAGDHLS",197,0)
 . . S:$G(MSGTREE(2,IX1,IX2,1,1))["-" MSGTREE(2,IX1,IX2,1,1)=$P(MSGTREE(2,IX1,IX2,1,1),"-",1,2)
"RTN","MAGDHLS",198,0)
 . . Q
"RTN","MAGDHLS",199,0)
 . Q
"RTN","MAGDHLS",200,0)
 ; insert PID subtree into passed-in element array
"RTN","MAGDHLS",201,0)
 ; this code eliminates values on intermediate (i.e., non-leaf) nodes
"RTN","MAGDHLS",202,0)
 S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",203,0)
 S @XYMSG@(SEGIX,0)="PID" ; segment tag
"RTN","MAGDHLS",204,0)
 S IX1=0 F  S IX1=$O(MSGTREE(2,IX1)) Q:'IX1  D
"RTN","MAGDHLS",205,0)
 . S IX2=0 F  S IX2=$O(MSGTREE(2,IX1,IX2)) Q:'IX2  D
"RTN","MAGDHLS",206,0)
 . . S IX3=0 F  S IX3=$O(MSGTREE(2,IX1,IX2,IX3)) Q:'IX3  D
"RTN","MAGDHLS",207,0)
 . . . S IX4=0 F  S IX4=$O(MSGTREE(2,IX1,IX2,IX3,IX4)) Q:'IX4  D
"RTN","MAGDHLS",208,0)
 . . . . S @XYMSG@(SEGIX,IX1,IX2,IX3,IX4)=MSGTREE(2,IX1,IX2,IX3,IX4)
"RTN","MAGDHLS",209,0)
 . . . . Q
"RTN","MAGDHLS",210,0)
 . . . Q
"RTN","MAGDHLS",211,0)
 . . Q
"RTN","MAGDHLS",212,0)
 . Q
"RTN","MAGDHLS",213,0)
 S STAT=$$STRIP0^MAG7UD($NA(@XYMSG@(SEGIX,7,1,1,1))) ; strip 0's off DOB
"RTN","MAGDHLS",214,0)
 Q 0
"RTN","MAGDHLS",215,0)
 ;
"RTN","MAGDHLS",216,0)
PV1(XDFN,XEVN,XEVNDT,XYMSG) G PV1^MAGDHLSV ; FUNCTION - patient visit
"RTN","MAGDHLS",217,0)
 ;
"RTN","MAGDHLS",218,0)
ROL(XDFN,XYMSG) ; FUNCTION role (for physicians) - propagate from PV1
"RTN","MAGDHLS",219,0)
 ; assumes PV1 segment is already populated
"RTN","MAGDHLS",220,0)
 ; 
"RTN","MAGDHLS",221,0)
 ; input:  XDFN      internal entry number of the pt on gbl ^DPT
"RTN","MAGDHLS",222,0)
 ;         XYMSG    name of array to which to add message elts
"RTN","MAGDHLS",223,0)
 ; output: @XYMSG    input array plus new subtree containing PID elts
"RTN","MAGDHLS",224,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",225,0)
 ;
"RTN","MAGDHLS",226,0)
 N PRCTYP ; -- type of practitioner
"RTN","MAGDHLS",227,0)
 N NUL ; ----- null return from called function
"RTN","MAGDHLS",228,0)
 N SETID ; --- sequential index of ROL seg(s) in this message
"RTN","MAGDHLS",229,0)
 N PV1IX ; --- index of PV1 segment in message array
"RTN","MAGDHLS",230,0)
 N PHYSELT ; - element index of attending / referring physician on PV1 segment
"RTN","MAGDHLS",231,0)
 N I ; ------- scratch loop counter
"RTN","MAGDHLS",232,0)
 ;
"RTN","MAGDHLS",233,0)
 S DFN=XDFN,SETID=0
"RTN","MAGDHLS",234,0)
 S PV1IX="",I=0 F  S I=$O(@XYMSG@(I)) Q:'I  I @XYMSG@(I,0)="PV1" S PV1IX=I Q
"RTN","MAGDHLS",235,0)
 Q:'PV1IX  ; no physicians to propagate
"RTN","MAGDHLS",236,0)
 F PRCTYP="ATT","REF" D
"RTN","MAGDHLS",237,0)
 . S PHYSELT=$S(PRCTYP="ATT":7,1:8) Q:'$D(@XYMSG@(PV1IX,PHYSELT))
"RTN","MAGDHLS",238,0)
 . S SEGIX=$O(@XYMSG@(" "),-1)+1,SETID=SETID+1
"RTN","MAGDHLS",239,0)
 . S @XYMSG@(SEGIX,0)="ROL"
"RTN","MAGDHLS",240,0)
 . S @XYMSG@(SEGIX,1,1,1,1)=SETID
"RTN","MAGDHLS",241,0)
 . S @XYMSG@(SEGIX,2,1,1,1)="UP" ; receiver should always update
"RTN","MAGDHLS",242,0)
 . S @XYMSG@(SEGIX,3,1,1,1)=$S(PRCTYP="ATT":"AT",1:"RP")
"RTN","MAGDHLS",243,0)
 . M @XYMSG@(SEGIX,4)=@XYMSG@(PV1IX,PHYSELT)
"RTN","MAGDHLS",244,0)
 . S NUL=$$NPFON^MAG7UFO($NA(@XYMSG@(SEGIX,12)),$G(@XYMSG@(SEGIX,4,1,1,1)))
"RTN","MAGDHLS",245,0)
 . Q
"RTN","MAGDHLS",246,0)
 Q 0
"RTN","MAGDHLT")
0^4^B5902737
"RTN","MAGDHLT",1,0)
MAGDHLT ;WOIFO/MLH/PMK - IHE-based ADT interface for PACS - trigger event vectors ;16 Mar 2017 11:15 AM
"RTN","MAGDHLT",2,0)
 ;;3.0;IMAGING;**49,183**;Mar 19, 2002;Build 11;Apr 07, 2011
"RTN","MAGDHLT",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHLT",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLT",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHLT",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHLT",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHLT",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHLT",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHLT",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHLT",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHLT",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHLT",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHLT",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHLT",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHLT",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLT",17,0)
 ;;
"RTN","MAGDHLT",18,0)
 Q
"RTN","MAGDHLT",19,0)
 ;
"RTN","MAGDHLT",20,0)
A01(XDFN,XOCCURRED) G A01^MAGDHLTA ; patient admission
"RTN","MAGDHLT",21,0)
A02(XDFN,XOCCURRED) G A02^MAGDHLTA ; patient transfer
"RTN","MAGDHLT",22,0)
A03(XDFN,XOCCURRED) G A03^MAGDHLTA ; patient discharge
"RTN","MAGDHLT",23,0)
A08(XDFN,NEWSSN,XOCCURRED) G A08^MAGDHLTA ; patient information update - P183 PMK 3/9/17
"RTN","MAGDHLT",24,0)
A11(XDFN,XDT) G A11^MAGDHLTC ; cancel patient admission
"RTN","MAGDHLT",25,0)
A12(XDFN,XDT) G A12^MAGDHLTC ; cancel patient transfer
"RTN","MAGDHLT",26,0)
A13(XDFN,XDT) G A13^MAGDHLTC ; cancel patient discharge
"RTN","MAGDHLT",27,0)
A40 Q  ;G A40^MAGDHLTM ; patient ID list merge - not now used
"RTN","MAGDHLT",28,0)
A47(XDFN,OLDSSN,NEWSSN,XOCCURRED) G A47^MAGDHLTA ; change patient identifier list - P183 PMK 3/9/17
"RTN","MAGDHLTA")
0^5^B52475695
"RTN","MAGDHLTA",1,0)
MAGDHLTA ;WOIFO/MLH/PMK - IHE-based ADT interface for PACS - trigger events - A01, A02, A03, A08, A47 ;16 Mar 2017 12:41 PM
"RTN","MAGDHLTA",2,0)
 ;;3.0;IMAGING;**49,183**;Mar 19, 2002;Build 11;Apr 07, 2011
"RTN","MAGDHLTA",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHLTA",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLTA",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHLTA",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHLTA",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHLTA",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHLTA",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHLTA",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHLTA",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHLTA",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHLTA",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHLTA",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHLTA",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHLTA",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLTA",17,0)
 ;;
"RTN","MAGDHLTA",18,0)
 Q
"RTN","MAGDHLTA",19,0)
 ;
"RTN","MAGDHLTA",20,0)
A01 ; GOTO entry point from MAGDHLT - patient admission 
"RTN","MAGDHLTA",21,0)
 ; INPUT:  XDFN       patient's internal entry number on PATIENT File (#2)
"RTN","MAGDHLTA",22,0)
 ;         XOCCURRED  date/time of the admission in FileMan format
"RTN","MAGDHLTA",23,0)
 ; function return:   result of message generation from call to GENERATE^HLMA
"RTN","MAGDHLTA",24,0)
 ;
"RTN","MAGDHLTA",25,0)
 N HL ; -------- HL7 initialization function status return
"RTN","MAGDHLTA",26,0)
 N HLA ; ------- array of HL7 message segments
"RTN","MAGDHLTA",27,0)
 N MSGA01A ; --- A01 message array
"RTN","MAGDHLTA",28,0)
 N MSG ; ------- message status
"RTN","MAGDHLTA",29,0)
 N RESULT ; ---- status message returned by message generator
"RTN","MAGDHLTA",30,0)
 ;
"RTN","MAGDHLTA",31,0)
 D INIT^HLFNC2("MAG CPACS A01",.HL)
"RTN","MAGDHLTA",32,0)
 I $G(HL) Q -1_U_$P(HL,"^",2) ; error
"RTN","MAGDHLTA",33,0)
 ;
"RTN","MAGDHLTA",34,0)
 ; build a dummy MSH segment for the $$MAKE^MAG7UM function
"RTN","MAGDHLTA",35,0)
 S MSGA01A(1,0)="MSH"
"RTN","MAGDHLTA",36,0)
 S MSGA01A(1,1,1,1,1)=HLFS
"RTN","MAGDHLTA",37,0)
 S MSGA01A(1,2,1,1,1)=HLECH
"RTN","MAGDHLTA",38,0)
 S MSGA01A(1,9,1,1,1)="ADT"
"RTN","MAGDHLTA",39,0)
 S MSGA01A(1,9,1,2,1)="A01"
"RTN","MAGDHLTA",40,0)
 ;
"RTN","MAGDHLTA",41,0)
 S MSG=$$EVN^MAGDHLS("A01",$$NOW^XLFDT,XOCCURRED,"MSGA01A")
"RTN","MAGDHLTA",42,0)
 S MSG=$$PID^MAGDHLS(XDFN,"MSGA01A")
"RTN","MAGDHLTA",43,0)
 S MSG=$$PV1^MAGDHLS(XDFN,"A01",XOCCURRED,"MSGA01A")
"RTN","MAGDHLTA",44,0)
 S MSG=$$ROL^MAGDHLS(XDFN,"MSGA01A")
"RTN","MAGDHLTA",45,0)
 S MSG=$$OBXADT^MAGDHLS(XDFN,"MSGA01A")
"RTN","MAGDHLTA",46,0)
 S MSG=$$AL1^MAGDHLS(XDFN,"MSGA01A")
"RTN","MAGDHLTA",47,0)
 S MSG=$$DG1^MAGDHLS(XDFN,"MSGA01A")
"RTN","MAGDHLTA",48,0)
 ;
"RTN","MAGDHLTA",49,0)
 ; assemble message into segments
"RTN","MAGDHLTA",50,0)
 S MSG=$$MAKE^MAG7UM("MSGA01A",$NA(HLA("HLS")))
"RTN","MAGDHLTA",51,0)
 K HLA("HLS",1) ; remove dummy MSH segment
"RTN","MAGDHLTA",52,0)
 ;
"RTN","MAGDHLTA",53,0)
 ; send message to receiver and gateway
"RTN","MAGDHLTA",54,0)
 D GENERATE^HLMA("MAG CPACS A01","LM",1,.RESULT) ; generate & send message
"RTN","MAGDHLTA",55,0)
 D LOGGW^MAGDHLL("ADT") ; log message to gateway
"RTN","MAGDHLTA",56,0)
 Q $S($P($G(RESULT),U,2,$L(RESULT,U))="":0,1:-1_U_RESULT)
"RTN","MAGDHLTA",57,0)
 ;
"RTN","MAGDHLTA",58,0)
A02 ; GOTO entry point from MAGDHLT - patient transfer
"RTN","MAGDHLTA",59,0)
 ; INPUT:  XDFN       patient's internal entry number on PATIENT File (#2)
"RTN","MAGDHLTA",60,0)
 ;         XOCCURRED  date/time of the admission in FileMan format
"RTN","MAGDHLTA",61,0)
 ; function return:   result of message generation from call to GENERATE^HLMA
"RTN","MAGDHLTA",62,0)
 ;
"RTN","MAGDHLTA",63,0)
 N HL ; -------- HL7 initialization function status return
"RTN","MAGDHLTA",64,0)
 N HLA ; ------- array of HL7 message segments
"RTN","MAGDHLTA",65,0)
 N MSGA02A ; --- A02 message array
"RTN","MAGDHLTA",66,0)
 N MSG ; ------- message status
"RTN","MAGDHLTA",67,0)
 N RESULT ; ---- status message returned by message generator
"RTN","MAGDHLTA",68,0)
 ;
"RTN","MAGDHLTA",69,0)
 D INIT^HLFNC2("MAG CPACS A02",.HL)
"RTN","MAGDHLTA",70,0)
 I $G(HL) Q -1_U_$P(HL,"^",2) ; error
"RTN","MAGDHLTA",71,0)
 ;
"RTN","MAGDHLTA",72,0)
 ; build a dummy MSH segment for the $$MAKE^MAG7UM function
"RTN","MAGDHLTA",73,0)
 S MSGA02A(1,0)="MSH"
"RTN","MAGDHLTA",74,0)
 S MSGA02A(1,1,1,1,1)=HLFS
"RTN","MAGDHLTA",75,0)
 S MSGA02A(1,2,1,1,1)=HLECH
"RTN","MAGDHLTA",76,0)
 S MSGA02A(1,9,1,1,1)="ADT"
"RTN","MAGDHLTA",77,0)
 S MSGA02A(1,9,1,2,1)="A02"
"RTN","MAGDHLTA",78,0)
 ;
"RTN","MAGDHLTA",79,0)
 ; get patient movement event information and build EVN segment
"RTN","MAGDHLTA",80,0)
 S MSG=$$EVN^MAGDHLS("A02",$$NOW^XLFDT,XOCCURRED,"MSGA02A")
"RTN","MAGDHLTA",81,0)
 S MSG=$$PID^MAGDHLS(XDFN,"MSGA02A")
"RTN","MAGDHLTA",82,0)
 S MSG=$$PV1^MAGDHLS(XDFN,"A02",XOCCURRED,"MSGA02A")
"RTN","MAGDHLTA",83,0)
 S MSG=$$ROL^MAGDHLS(XDFN,"MSGA02A")
"RTN","MAGDHLTA",84,0)
 ;
"RTN","MAGDHLTA",85,0)
 ; assemble message into segments
"RTN","MAGDHLTA",86,0)
 S MSG=$$MAKE^MAG7UM("MSGA02A",$NA(HLA("HLS")))
"RTN","MAGDHLTA",87,0)
 K HLA("HLS",1) ; remove dummy MSH segment
"RTN","MAGDHLTA",88,0)
 ;
"RTN","MAGDHLTA",89,0)
 ; send message to receiver and gateway
"RTN","MAGDHLTA",90,0)
 D GENERATE^HLMA("MAG CPACS A02","LM",1,.RESULT) ; generate & send message
"RTN","MAGDHLTA",91,0)
 D LOGGW^MAGDHLL("ADT") ; log message to gateway
"RTN","MAGDHLTA",92,0)
 Q $S($P($G(RESULT),U,2,$L(RESULT,U))="":0,1:-1_U_RESULT)
"RTN","MAGDHLTA",93,0)
 ;
"RTN","MAGDHLTA",94,0)
A03 ; GOTO entry point from MAGDHLT - patient discharge
"RTN","MAGDHLTA",95,0)
 ; INPUT:  XDFN       patient's internal entry number on PATIENT File (#2)
"RTN","MAGDHLTA",96,0)
 ;         XOCCURRED  date/time of the admission in FileMan format
"RTN","MAGDHLTA",97,0)
 ; function return:   result of message generation from call to GENERATE^HLMA
"RTN","MAGDHLTA",98,0)
 ;
"RTN","MAGDHLTA",99,0)
 N HL ; -------- HL7 initialization function status return
"RTN","MAGDHLTA",100,0)
 N HLA ; ------- array of HL7 message segments
"RTN","MAGDHLTA",101,0)
 N MSGA03A ; --- A03 message array
"RTN","MAGDHLTA",102,0)
 N MSG ; ------- message status
"RTN","MAGDHLTA",103,0)
 N RESULT ; ---- status message returned by message generator
"RTN","MAGDHLTA",104,0)
 ;
"RTN","MAGDHLTA",105,0)
 D INIT^HLFNC2("MAG CPACS A03",.HL)
"RTN","MAGDHLTA",106,0)
 I $G(HL) Q -1_U_$P(HL,"^",2) ; error
"RTN","MAGDHLTA",107,0)
 ;
"RTN","MAGDHLTA",108,0)
 ; build a dummy MSH segment for the $$MAKE^MAG7UM function
"RTN","MAGDHLTA",109,0)
 S MSGA03A(1,0)="MSH"
"RTN","MAGDHLTA",110,0)
 S MSGA03A(1,1,1,1,1)=HLFS
"RTN","MAGDHLTA",111,0)
 S MSGA03A(1,2,1,1,1)=HLECH
"RTN","MAGDHLTA",112,0)
 S MSGA03A(1,9,1,1,1)="ADT"
"RTN","MAGDHLTA",113,0)
 S MSGA03A(1,9,1,2,1)="A03"
"RTN","MAGDHLTA",114,0)
 ;
"RTN","MAGDHLTA",115,0)
 ; get patient movement event information and build EVN segment
"RTN","MAGDHLTA",116,0)
 S MSG=$$EVN^MAGDHLS("A03",$$NOW^XLFDT,XOCCURRED,"MSGA03A")
"RTN","MAGDHLTA",117,0)
 S MSG=$$PID^MAGDHLS(XDFN,"MSGA03A")
"RTN","MAGDHLTA",118,0)
 S MSG=$$PV1^MAGDHLS(XDFN,"A03",XOCCURRED,"MSGA03A")
"RTN","MAGDHLTA",119,0)
 S MSG=$$ROL^MAGDHLS(XDFN,"MSGA03A")
"RTN","MAGDHLTA",120,0)
 S MSG=$$DG1^MAGDHLS(XDFN,"MSGA03A")
"RTN","MAGDHLTA",121,0)
 ;
"RTN","MAGDHLTA",122,0)
 ; assemble message into segments
"RTN","MAGDHLTA",123,0)
 S MSG=$$MAKE^MAG7UM("MSGA03A",$NA(HLA("HLS")))
"RTN","MAGDHLTA",124,0)
 K HLA("HLS",1) ; remove dummy MSH segment
"RTN","MAGDHLTA",125,0)
 ;
"RTN","MAGDHLTA",126,0)
 ; send message to receiver and gateway
"RTN","MAGDHLTA",127,0)
 D GENERATE^HLMA("MAG CPACS A03","LM",1,.RESULT) ; generate & send message
"RTN","MAGDHLTA",128,0)
 D LOGGW^MAGDHLL("ADT") ; log message to gateway
"RTN","MAGDHLTA",129,0)
 Q $S($P($G(RESULT),U,2,$L(RESULT,U))="":0,1:-1_U_RESULT)
"RTN","MAGDHLTA",130,0)
 ;
"RTN","MAGDHLTA",131,0)
A08 ; GOTO entry point from MAGDHLT - patient information update - P183 PMK 3/9/17
"RTN","MAGDHLTA",132,0)
 ; INPUT:  XDFN       patient's internal entry number on PATIENT File (#2)
"RTN","MAGDHLTA",133,0)
 ; function return:   result of message generation from call to GENERATE^HLMA
"RTN","MAGDHLTA",134,0)
 ;
"RTN","MAGDHLTA",135,0)
 N HL ; -------- HL7 initialization function status return
"RTN","MAGDHLTA",136,0)
 N HLA ; ------- array of HL7 message segments
"RTN","MAGDHLTA",137,0)
 N MSGA08A ; --- A08 message array
"RTN","MAGDHLTA",138,0)
 N MSG ; ------- message status
"RTN","MAGDHLTA",139,0)
 N NOW ; ------- current date and time
"RTN","MAGDHLTA",140,0)
 N RESULT ; ---- status message returned by message generator
"RTN","MAGDHLTA",141,0)
 ;
"RTN","MAGDHLTA",142,0)
 D INIT^HLFNC2("MAG CPACS A08",.HL)
"RTN","MAGDHLTA",143,0)
 I $G(HL) Q -1_U_$P(HL,"^",2) ; error
"RTN","MAGDHLTA",144,0)
 ;
"RTN","MAGDHLTA",145,0)
 ; build a dummy MSH segment for the $$MAKE^MAG7UM function
"RTN","MAGDHLTA",146,0)
 S MSGA08A(1,0)="MSH"
"RTN","MAGDHLTA",147,0)
 S MSGA08A(1,1,1,1,1)=HLFS
"RTN","MAGDHLTA",148,0)
 S MSGA08A(1,2,1,1,1)=HLECH
"RTN","MAGDHLTA",149,0)
 S MSGA08A(1,9,1,1,1)="ADT"
"RTN","MAGDHLTA",150,0)
 S MSGA08A(1,9,1,2,1)="A08"
"RTN","MAGDHLTA",151,0)
 ;
"RTN","MAGDHLTA",152,0)
 S NOW=$$NOW^XLFDT
"RTN","MAGDHLTA",153,0)
 I '$D(XOCCURRED) S XOCCURRED=NOW ; XOCCURRED only set for ADT A47/A08 pair
"RTN","MAGDHLTA",154,0)
 ;
"RTN","MAGDHLTA",155,0)
 S MSG=$$EVN^MAGDHLS("A08",NOW,XOCCURRED,"MSGA08A")
"RTN","MAGDHLTA",156,0)
 S MSG=$$PID^MAGDHLS(XDFN,"MSGA08A")
"RTN","MAGDHLTA",157,0)
 S MSG=$$PV1^MAGDHLS(XDFN,"A08",XOCCURRED,"MSGA08A")
"RTN","MAGDHLTA",158,0)
 S MSG=$$ROL^MAGDHLS(XDFN,"MSGA08A")
"RTN","MAGDHLTA",159,0)
 S MSG=$$OBXADT^MAGDHLS(XDFN,"MSGA08A")
"RTN","MAGDHLTA",160,0)
 S MSG=$$AL1^MAGDHLS(XDFN,"MSGA08A")
"RTN","MAGDHLTA",161,0)
 S MSG=$$DG1^MAGDHLS(XDFN,"MSGA08A")
"RTN","MAGDHLTA",162,0)
 ;
"RTN","MAGDHLTA",163,0)
 ; Update the PID-3 and PID-19 fields to contain the new SSN at time of change
"RTN","MAGDHLTA",164,0)
 I $D(NEWSSN) D  ; NEWSSN is only set for ADT A47/A08 pair
"RTN","MAGDHLTA",165,0)
 . S MSGA08A(3,3,1,1,1)=NEWSSN ;  PID-3
"RTN","MAGDHLTA",166,0)
 . S MSGA08A(3,19,1,1,1)=NEWSSN ; PID-19
"RTN","MAGDHLTA",167,0)
 . Q
"RTN","MAGDHLTA",168,0)
 ;
"RTN","MAGDHLTA",169,0)
 ; assemble message into segments
"RTN","MAGDHLTA",170,0)
 S MSG=$$MAKE^MAG7UM("MSGA08A",$NA(HLA("HLS")))
"RTN","MAGDHLTA",171,0)
 K HLA("HLS",1) ; remove dummy MSH segment
"RTN","MAGDHLTA",172,0)
 ; send message to receiver and gateway
"RTN","MAGDHLTA",173,0)
 D GENERATE^HLMA("MAG CPACS A08","LM",1,.RESULT) ; generate & send message
"RTN","MAGDHLTA",174,0)
 D LOGGW^MAGDHLL("ADT") ; log message to gateway
"RTN","MAGDHLTA",175,0)
 Q $S($P($G(RESULT),U,2,$L(RESULT,U))="":0,1:-1_U_RESULT)
"RTN","MAGDHLTA",176,0)
 ;
"RTN","MAGDHLTA",177,0)
A47 ; GOTO entry point from MAGDHLT - change patient identifier list - P183 PMK 3/9/17
"RTN","MAGDHLTA",178,0)
 ; INPUT:  XDFN       patient's internal entry number on PATIENT File (#2)
"RTN","MAGDHLTA",179,0)
 ;         OLDSSN     patient's previous SSN
"RTN","MAGDHLTA",180,0)
 ; function return:   result of message generation from call to GENERATE^HLMA
"RTN","MAGDHLTA",181,0)
 ;
"RTN","MAGDHLTA",182,0)
 N HL ; -------- HL7 initialization function status return
"RTN","MAGDHLTA",183,0)
 N HLA ; ------- array of HL7 message segments
"RTN","MAGDHLTA",184,0)
 N MSGA47A ; --- A47 message array
"RTN","MAGDHLTA",185,0)
 N MSG ; ------- message status
"RTN","MAGDHLTA",186,0)
 N NOW ; ------- current date and time
"RTN","MAGDHLTA",187,0)
 N RESULT ; ---- status message returned by message generator
"RTN","MAGDHLTA",188,0)
 ;
"RTN","MAGDHLTA",189,0)
 D INIT^HLFNC2("MAG CPACS A47",.HL)
"RTN","MAGDHLTA",190,0)
 I $G(HL) Q -1_U_$P(HL,"^",2) ; error
"RTN","MAGDHLTA",191,0)
 ;
"RTN","MAGDHLTA",192,0)
 ; build a dummy MSH segment for the $$MAKE^MAG7UM function
"RTN","MAGDHLTA",193,0)
 S MSGA47A(1,0)="MSH"
"RTN","MAGDHLTA",194,0)
 S MSGA47A(1,1,1,1,1)=HLFS
"RTN","MAGDHLTA",195,0)
 S MSGA47A(1,2,1,1,1)=HLECH
"RTN","MAGDHLTA",196,0)
 S MSGA47A(1,9,1,1,1)="ADT"
"RTN","MAGDHLTA",197,0)
 S MSGA47A(1,9,1,2,1)="A47"
"RTN","MAGDHLTA",198,0)
 ;
"RTN","MAGDHLTA",199,0)
 S NOW=$$NOW^XLFDT
"RTN","MAGDHLTA",200,0)
 ;
"RTN","MAGDHLTA",201,0)
 S MSG=$$EVN^MAGDHLS("A47",NOW,XOCCURRED,"MSGA47A")
"RTN","MAGDHLTA",202,0)
 S MSG=$$PID^MAGDHLS(XDFN,"MSGA47A")
"RTN","MAGDHLTA",203,0)
 S MSG=$$MRG^MAGDHLS(OLDSSN,"MSGA47A")
"RTN","MAGDHLTA",204,0)
 ;
"RTN","MAGDHLTA",205,0)
 ; Update the PID-3 and PID-19 fields to contain the new SSN at time of change
"RTN","MAGDHLTA",206,0)
 S MSGA47A(3,3,1,1,1)=NEWSSN ;  PID-3
"RTN","MAGDHLTA",207,0)
 S MSGA47A(3,19,1,1,1)=NEWSSN ; PID-19
"RTN","MAGDHLTA",208,0)
 ;
"RTN","MAGDHLTA",209,0)
 ; assemble message into segments
"RTN","MAGDHLTA",210,0)
 S MSG=$$MAKE^MAG7UM("MSGA47A",$NA(HLA("HLS")))
"RTN","MAGDHLTA",211,0)
 K HLA("HLS",1) ; remove dummy MSH segment
"RTN","MAGDHLTA",212,0)
 ;
"RTN","MAGDHLTA",213,0)
 ; send message to receiver and gateway
"RTN","MAGDHLTA",214,0)
 D GENERATE^HLMA("MAG CPACS A47","LM",1,.RESULT) ; generate & send message
"RTN","MAGDHLTA",215,0)
 D LOGGW^MAGDHLL("ADT") ; log message to gateway
"RTN","MAGDHLTA",216,0)
 Q $S($P($G(RESULT),U,2,$L(RESULT,U))="":0,1:-1_U_RESULT)
"RTN","MAGDHLTC")
0^13^B19165831
"RTN","MAGDHLTC",1,0)
MAGDHLTC ;WOIFO/MLH/PMK - IHE-based ADT interface for PACS - trigger events - A11, A12, A13 ;20 Mar 2017 12:15 PM
"RTN","MAGDHLTC",2,0)
 ;;3.0;IMAGING;**49,183**;Mar 19, 2002;Build 11;Apr 07, 2011
"RTN","MAGDHLTC",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHLTC",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLTC",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHLTC",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHLTC",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHLTC",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHLTC",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHLTC",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHLTC",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHLTC",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHLTC",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHLTC",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHLTC",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHLTC",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLTC",17,0)
 ;;
"RTN","MAGDHLTC",18,0)
 Q
"RTN","MAGDHLTC",19,0)
 ;
"RTN","MAGDHLTC",20,0)
A11 ; GOTO entry point from MAGDHLT - patient admission cancel
"RTN","MAGDHLTC",21,0)
 ; INPUT:  XDFN      IEN of pt whose admission is being cancelled
"RTN","MAGDHLTC",22,0)
 ;         XDT       date/time of cancellation
"RTN","MAGDHLTC",23,0)
 ; function return:   result of message generation from call to GENERATE^HLMA
"RTN","MAGDHLTC",24,0)
 ;
"RTN","MAGDHLTC",25,0)
 N HL ; -------- HL7 initialization function status return
"RTN","MAGDHLTC",26,0)
 N HLA ; ------- array of HL7 message segments
"RTN","MAGDHLTC",27,0)
 N MSGA11A ; --- A11 message array
"RTN","MAGDHLTC",28,0)
 N MSG ; ------- message status
"RTN","MAGDHLTC",29,0)
 ;
"RTN","MAGDHLTC",30,0)
 D INIT^HLFNC2("MAG CPACS A11",.HL)
"RTN","MAGDHLTC",31,0)
 I $G(HL) Q -1_U_$P(HL,"^",2) ; error
"RTN","MAGDHLTC",32,0)
 ;
"RTN","MAGDHLTC",33,0)
 ; build a dummy MSH segment for the $$MAKE^MAG7UM function
"RTN","MAGDHLTC",34,0)
 S MSGA11A(1,0)="MSH"
"RTN","MAGDHLTC",35,0)
 S MSGA11A(1,1,1,1,1)=HLFS
"RTN","MAGDHLTC",36,0)
 S MSGA11A(1,2,1,1,1)=HLECH
"RTN","MAGDHLTC",37,0)
 S MSGA11A(1,9,1,1,1)="ADT"
"RTN","MAGDHLTC",38,0)
 S MSGA11A(1,9,1,2,1)="A11"
"RTN","MAGDHLTC",39,0)
 ;
"RTN","MAGDHLTC",40,0)
 ; gather patient information and populate segment array elements
"RTN","MAGDHLTC",41,0)
 S MSG=$$EVN^MAGDHLS("A11",XDT,XDT,"MSGA11A")
"RTN","MAGDHLTC",42,0)
 S MSG=$$PID^MAGDHLS(XDFN,"MSGA11A")
"RTN","MAGDHLTC",43,0)
 S MSG=$$PV1^MAGDHLS(XDFN,"A11",XDT,"MSGA11A")
"RTN","MAGDHLTC",44,0)
 ;
"RTN","MAGDHLTC",45,0)
 ; assemble message into segments
"RTN","MAGDHLTC",46,0)
 S MSG=$$MAKE^MAG7UM("MSGA11A",$NA(HLA("HLS")))
"RTN","MAGDHLTC",47,0)
 K HLA("HLS",1) ; remove dummy MSH segment
"RTN","MAGDHLTC",48,0)
 ;
"RTN","MAGDHLTC",49,0)
 ; send message to receiver and gateway
"RTN","MAGDHLTC",50,0)
 D GENERATE^HLMA("MAG CPACS A11","LM",1,.RESULT) ; generate & send message
"RTN","MAGDHLTC",51,0)
 D LOGGW^MAGDHLL("ADT") ; log message to gateway
"RTN","MAGDHLTC",52,0)
 Q $S($P($G(RESULT),U,2,$L(RESULT,U))="":0,1:-1_U_RESULT)
"RTN","MAGDHLTC",53,0)
 ;
"RTN","MAGDHLTC",54,0)
A12 ; GOTO entry point from MAGDHLT - cancel patient transfer
"RTN","MAGDHLTC",55,0)
 ; INPUT:  XDFN      IEN of pt whose admission is being cancelled
"RTN","MAGDHLTC",56,0)
 ;         XDT       date/time of cancellation
"RTN","MAGDHLTC",57,0)
 ; function return:   result of message generation from call to GENERATE^HLMA
"RTN","MAGDHLTC",58,0)
 ;
"RTN","MAGDHLTC",59,0)
 N HL ; -------- HL7 initialization function status return
"RTN","MAGDHLTC",60,0)
 N HLA ; ------- array of HL7 message segments
"RTN","MAGDHLTC",61,0)
 N MSGA12A ; --- A02 message array
"RTN","MAGDHLTC",62,0)
 N MSG ; ------- message status
"RTN","MAGDHLTC",63,0)
 ;
"RTN","MAGDHLTC",64,0)
 D INIT^HLFNC2("MAG CPACS A12",.HL)
"RTN","MAGDHLTC",65,0)
 I $G(HL) Q -1_U_$P(HL,"^",2) ; error
"RTN","MAGDHLTC",66,0)
 ;
"RTN","MAGDHLTC",67,0)
 ; build a dummy MSH segment for the $$MAKE^MAG7UM function
"RTN","MAGDHLTC",68,0)
 S MSGA12A(1,0)="MSH"
"RTN","MAGDHLTC",69,0)
 S MSGA12A(1,1,1,1,1)=HLFS
"RTN","MAGDHLTC",70,0)
 S MSGA12A(1,2,1,1,1)=HLECH
"RTN","MAGDHLTC",71,0)
 S MSGA12A(1,9,1,1,1)="ADT"
"RTN","MAGDHLTC",72,0)
 S MSGA12A(1,9,1,2,1)="A12"
"RTN","MAGDHLTC",73,0)
 ;
"RTN","MAGDHLTC",74,0)
 ; gather patient information and populate segment array elements
"RTN","MAGDHLTC",75,0)
 S MSG=$$EVN^MAGDHLS("A12",XDT,XDT,"MSGA12A")
"RTN","MAGDHLTC",76,0)
 S MSG=$$PID^MAGDHLS(XDFN,"MSGA12A")
"RTN","MAGDHLTC",77,0)
 S MSG=$$PV1^MAGDHLS(XDFN,"A12",XDT,"MSGA12A")
"RTN","MAGDHLTC",78,0)
 S MSG=$$ROL^MAGDHLS(XDFN,"MSGA12A")
"RTN","MAGDHLTC",79,0)
 S MSG=$$OBXADT^MAGDHLS(XDFN,"MSGA12A")
"RTN","MAGDHLTC",80,0)
 ;
"RTN","MAGDHLTC",81,0)
 ; assemble message into segments
"RTN","MAGDHLTC",82,0)
 S MSG=$$MAKE^MAG7UM("MSGA12A",$NA(HLA("HLS")))
"RTN","MAGDHLTC",83,0)
 K HLA("HLS",1) ; remove dummy MSH segment
"RTN","MAGDHLTC",84,0)
 ;
"RTN","MAGDHLTC",85,0)
 ; send message to receiver and gateway
"RTN","MAGDHLTC",86,0)
 D GENERATE^HLMA("MAG CPACS A12","LM",1,.RESULT) ; generate & send message
"RTN","MAGDHLTC",87,0)
 D LOGGW^MAGDHLL("ADT") ; log message to gateway
"RTN","MAGDHLTC",88,0)
 Q $S($P($G(RESULT),U,2,$L(RESULT,U))="":0,1:-1_U_RESULT)
"RTN","MAGDHLTC",89,0)
 ;
"RTN","MAGDHLTC",90,0)
A13 ; GOTO entry point from MAGDHLT - cancel patient discharge
"RTN","MAGDHLTC",91,0)
 ; INPUT:  XDFN      IEN of pt whose admission is being cancelled
"RTN","MAGDHLTC",92,0)
 ;         XDT       date/time of cancellation
"RTN","MAGDHLTC",93,0)
 ; function return:   result of message generation from call to GENERATE^HLMA
"RTN","MAGDHLTC",94,0)
 ;
"RTN","MAGDHLTC",95,0)
 N HL ; -------- HL7 initialization function status return
"RTN","MAGDHLTC",96,0)
 N HLA ; ------- array of HL7 message segments
"RTN","MAGDHLTC",97,0)
 N MSGA13A ; --- A13 message array
"RTN","MAGDHLTC",98,0)
 N MSG ; ------- message status
"RTN","MAGDHLTC",99,0)
 ;
"RTN","MAGDHLTC",100,0)
 D INIT^HLFNC2("MAG CPACS A13",.HL)
"RTN","MAGDHLTC",101,0)
 I $G(HL) Q -1_U_$P(HL,"^",2) ; error
"RTN","MAGDHLTC",102,0)
 ;
"RTN","MAGDHLTC",103,0)
 ; build a dummy MSH segment for the $$MAKE^MAG7UM function
"RTN","MAGDHLTC",104,0)
 S MSGA13A(1,0)="MSH"
"RTN","MAGDHLTC",105,0)
 S MSGA13A(1,1,1,1,1)=HLFS
"RTN","MAGDHLTC",106,0)
 S MSGA13A(1,2,1,1,1)=HLECH
"RTN","MAGDHLTC",107,0)
 S MSGA13A(1,9,1,1,1)="ADT"
"RTN","MAGDHLTC",108,0)
 S MSGA13A(1,9,1,2,1)="A13"
"RTN","MAGDHLTC",109,0)
 ;
"RTN","MAGDHLTC",110,0)
 ; gather patient information and populate segment array elements
"RTN","MAGDHLTC",111,0)
 S MSG=$$EVN^MAGDHLS("A13",XDT,XDT,"MSGA13A")
"RTN","MAGDHLTC",112,0)
 S MSG=$$PID^MAGDHLS(XDFN,"MSGA13A")
"RTN","MAGDHLTC",113,0)
 S MSG=$$PV1^MAGDHLS(XDFN,"A13",XDT,"MSGA13A")
"RTN","MAGDHLTC",114,0)
 S MSG=$$ROL^MAGDHLS(XDFN,"MSGA13A")
"RTN","MAGDHLTC",115,0)
 ;
"RTN","MAGDHLTC",116,0)
 ; assemble message into segments
"RTN","MAGDHLTC",117,0)
 S MSG=$$MAKE^MAG7UM("MSGA13A",$NA(HLA("HLS")))
"RTN","MAGDHLTC",118,0)
 K HLA("HLS",1) ; remove dummy MSH segment
"RTN","MAGDHLTC",119,0)
 ;
"RTN","MAGDHLTC",120,0)
 ; send message to receiver and gateway
"RTN","MAGDHLTC",121,0)
 D GENERATE^HLMA("MAG CPACS A13","LM",1,.RESULT) ; generate & send message
"RTN","MAGDHLTC",122,0)
 D LOGGW^MAGDHLL("ADT") ; log message to gateway
"RTN","MAGDHLTC",123,0)
 Q $S($P($G(RESULT),U,2,$L(RESULT,U))="":0,1:-1_U_RESULT)
"RTN","MAGDHOW2")
0^9^B50817205
"RTN","MAGDHOW2",1,0)
MAGDHOW2 ;WOIFO/PMK/DAC - Capture Consult/GMRC data ;15 May 2017 3:02 PM
"RTN","MAGDHOW2",2,0)
 ;;3.0;IMAGING;**138,156,183**;Mar 19, 2002;Build 11;Nov 16, 2014
"RTN","MAGDHOW2",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHOW2",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOW2",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHOW2",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHOW2",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHOW2",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHOW2",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHOW2",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHOW2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHOW2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHOW2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHOW2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHOW2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHOW2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOW2",17,0)
 ;;
"RTN","MAGDHOW2",18,0)
 ;
"RTN","MAGDHOW2",19,0)
 ; Supported IA #4716 reference ^HLOAPI function calls
"RTN","MAGDHOW2",20,0)
 ; Supported IA #4717 reference ^HLOAPI1 function calls
"RTN","MAGDHOW2",21,0)
 ; Supported IA #5886 reference ^HLOPBLD1 function calls
"RTN","MAGDHOW2",22,0)
 ; Supported IA #6103 reference for reading ^HLA
"RTN","MAGDHOW2",23,0)
 ;
"RTN","MAGDHOW2",24,0)
 ;
"RTN","MAGDHOW2",25,0)
MESSAGE(SERVICE) ; invoked from ^MAGDHOW1
"RTN","MAGDHOW2",26,0)
 N CONSULT,ERROR,HL7IEN,HLMSTATE,I,MESSAGES,MSG,NEXT,OBXSEGNO
"RTN","MAGDHOW2",27,0)
 N PRIORITY,SAVEORCSEG,SUCCESS,TIUDOC,X,Y
"RTN","MAGDHOW2",28,0)
 ;
"RTN","MAGDHOW2",29,0)
 ; P156 DAC - Support for HL7 result messages
"RTN","MAGDHOW2",30,0)
 I MSGTYPE="ORM" D  ; order entry message
"RTN","MAGDHOW2",31,0)
 . D INIT(MSGTYPE,"O01") ; start building a new HL7 order entry message
"RTN","MAGDHOW2",32,0)
 . Q
"RTN","MAGDHOW2",33,0)
 E  D  ; result message
"RTN","MAGDHOW2",34,0)
 . D INIT(MSGTYPE,"R01") ; start building a new HL7 result message
"RTN","MAGDHOW2",35,0)
 . Q
"RTN","MAGDHOW2",36,0)
 ;
"RTN","MAGDHOW2",37,0)
 D PIDPV1^MAGDHOW2(.HLMSTATE,DFN)
"RTN","MAGDHOW2",38,0)
 D ORC^MAGDHOW3(.HLMSTATE,GMRCIEN,.SAVEORCSEG)
"RTN","MAGDHOW2",39,0)
 D OBR^MAGDHOW4(.HLMSTATE,GMRCIEN,.SAVEORCSEG,SERVICE)
"RTN","MAGDHOW2",40,0)
 D ZDS^MAGDHOW5(.HLMSTATE,GMRCIEN)
"RTN","MAGDHOW2",41,0)
 D OBX^MAGDHOW5(.HLMSTATE,GMRCIEN)
"RTN","MAGDHOW2",42,0)
 ;
"RTN","MAGDHOW2",43,0)
 ; send the message via subscription list
"RTN","MAGDHOW2",44,0)
 S PARMS("SENDING APPLICATION")="MAGD SENDER"
"RTN","MAGDHOW2",45,0)
 S PARMS("SUBSCRIPTION IEN")=HL7SUBLIST
"RTN","MAGDHOW2",46,0)
 ; the HLO private queue name is the name of the subscription list
"RTN","MAGDHOW2",47,0)
 S PARMS("QUEUE")=$$GET1^DIQ(779.4,HL7SUBLIST,.01) ; private queue
"RTN","MAGDHOW2",48,0)
 S SUCCESS=$$SENDSUB^HLOAPI1(.HLMSTATE,.PARMS,.MESSAGES)
"RTN","MAGDHOW2",49,0)
 I 'SUCCESS D
"RTN","MAGDHOW2",50,0)
 . N MSG,SUBJECT,VARIABLES
"RTN","MAGDHOW2",51,0)
 . S SUBJECT="VistA Imaging Clinical Specialty (CPRS) HL7 Generation"
"RTN","MAGDHOW2",52,0)
 . S MSG(1)="An error occurred in "_$T(+0)_" where the SENDSUB^HLOAPI1"
"RTN","MAGDHOW2",53,0)
 . S MSG(2)="invocation failed.  The error message is as follows:"
"RTN","MAGDHOW2",54,0)
 . S MSG(3)=""""_SUCCESS_""""
"RTN","MAGDHOW2",55,0)
 . S VARIABLES("HLMSTATE")=""
"RTN","MAGDHOW2",56,0)
 . S VARIABLES("PARMS")=""
"RTN","MAGDHOW2",57,0)
 . S VARIABLES("MESSAGES")=""
"RTN","MAGDHOW2",58,0)
 . D ERROR^MAGDHOWA(SUBJECT,.MSG,.VARIABLES)
"RTN","MAGDHOW2",59,0)
 . Q
"RTN","MAGDHOW2",60,0)
 D OUTPUT ; send to DICOM Gateway
"RTN","MAGDHOW2",61,0)
 ;
"RTN","MAGDHOW2",62,0)
 Q
"RTN","MAGDHOW2",63,0)
 ;
"RTN","MAGDHOW2",64,0)
INIT(MSGTYPE,EVENT) ; start building a new HL7 message
"RTN","MAGDHOW2",65,0)
 N ERROR,PARMS,SUCCESS
"RTN","MAGDHOW2",66,0)
 S PARMS("COUNTRY")="USA"
"RTN","MAGDHOW2",67,0)
 S PARMS("CONTINUATION POINTER")=0
"RTN","MAGDHOW2",68,0)
 S PARMS("EVENT")=EVENT
"RTN","MAGDHOW2",69,0)
 S PARMS("FIELD SEPARATOR")="|"
"RTN","MAGDHOW2",70,0)
 S PARMS("ENCODING CHARACTERS")="^~\&"
"RTN","MAGDHOW2",71,0)
 S PARMS("MESSAGE STRUCTURE")=MSGTYPE_"_"_EVENT
"RTN","MAGDHOW2",72,0)
 S PARMS("MESSAGE TYPE")=MSGTYPE
"RTN","MAGDHOW2",73,0)
 S PARMS("PROCESSING MODE")="T"
"RTN","MAGDHOW2",74,0)
 S PARMS("VERSION")=2.4
"RTN","MAGDHOW2",75,0)
 S SUCCESS=$$NEWMSG^HLOAPI(.PARMS,.HLMSTATE,.ERROR)
"RTN","MAGDHOW2",76,0)
 I 'SUCCESS D
"RTN","MAGDHOW2",77,0)
 . N MSG,SUBJECT,VARIABLES
"RTN","MAGDHOW2",78,0)
 . S SUBJECT="VistA Imaging Clinical Specialty (CPRS) HL7 Generation"
"RTN","MAGDHOW2",79,0)
 . S MSG(1)="An error occurred in INIT^"_$T(+0)_" where the NEWMSG^HLOAPI"
"RTN","MAGDHOW2",80,0)
 . S MSG(2)="invocation failed.  The error message is as follows:"
"RTN","MAGDHOW2",81,0)
 . S MSG(3)=""""_SUCCESS_""""
"RTN","MAGDHOW2",82,0)
 . S VARIABLES("PARMS")=""
"RTN","MAGDHOW2",83,0)
 . S VARIABLES("HLMSTATE")=""
"RTN","MAGDHOW2",84,0)
 . S VARIABLES("ERROR")=""
"RTN","MAGDHOW2",85,0)
 . D ERROR^MAGDHOWA(SUBJECT,.MSG,.VARIABLES)
"RTN","MAGDHOW2",86,0)
 . Q
"RTN","MAGDHOW2",87,0)
 Q
"RTN","MAGDHOW2",88,0)
 ;
"RTN","MAGDHOW2",89,0)
PIDPV1(HLMSTATE,DFN) ; build the PID and PV1 segments
"RTN","MAGDHOW2",90,0)
 ; Also invoked by ^MAGT7S to build these segments for Anatomic Pathology - P183 PMK 3/7/17
"RTN","MAGDHOW2",91,0)
 N HL,HL7ARRAY,HL7SEG,HLECH,HLFS,HLQ,NUL,PID,PV1,SUCCESS
"RTN","MAGDHOW2",92,0)
 S HLECH=HLMSTATE("HDR","ENCODING CHARACTERS")
"RTN","MAGDHOW2",93,0)
 S HLFS=HLMSTATE("HDR","FIELD SEPARATOR")
"RTN","MAGDHOW2",94,0)
 S HLQ="""""" ; null fields are set as "", as opposed to being empty
"RTN","MAGDHOW2",95,0)
 S HL7ARRAY(1,9,1,1,1)=""
"RTN","MAGDHOW2",96,0)
 S HL7ARRAY(1,0)="MSH"
"RTN","MAGDHOW2",97,0)
 S HL7ARRAY(1,1,1,1,1)=HLFS
"RTN","MAGDHOW2",98,0)
 S HL7ARRAY(1,2,1,1,1)=HLECH
"RTN","MAGDHOW2",99,0)
 D PID^MAGDHLS(DFN,"HL7ARRAY")
"RTN","MAGDHOW2",100,0)
 D PV1^MAGDHLS(DFN,"",DT,"HL7ARRAY")
"RTN","MAGDHOW2",101,0)
 ;
"RTN","MAGDHOW2",102,0)
 S NUL=$$MAKE^MAG7UM("HL7ARRAY","HL7SEG")
"RTN","MAGDHOW2",103,0)
 S PID=HL7SEG(2)
"RTN","MAGDHOW2",104,0)
 S PV1=HL7SEG(3)
"RTN","MAGDHOW2",105,0)
 S SUCCESS=$$MOVESEG^HLOAPI(.HLMSTATE,PID,.ERROR)
"RTN","MAGDHOW2",106,0)
 I 'SUCCESS D
"RTN","MAGDHOW2",107,0)
 . N MSG,SUBJECT,VARIABLES
"RTN","MAGDHOW2",108,0)
 . S SUBJECT="VistA Imaging Clinical Specialty (CPRS) HL7 Generation"
"RTN","MAGDHOW2",109,0)
 . S MSG(1)="An error occurred in PIDPV1^"_$T(+0)_" where the MOVESEG^HLOAPI invocation"
"RTN","MAGDHOW2",110,0)
 . S MSG(2)="for the PID segment failed.  The error message is as follows:"
"RTN","MAGDHOW2",111,0)
 . S MSG(3)=""""_SUCCESS_""""
"RTN","MAGDHOW2",112,0)
 . S VARIABLES("HLMSTATE")=""
"RTN","MAGDHOW2",113,0)
 . S VARIABLES("PID")=""
"RTN","MAGDHOW2",114,0)
 . S VARIABLES("ERROR")=""
"RTN","MAGDHOW2",115,0)
 . D ERROR^MAGDHOWA(SUBJECT,.MSG,.VARIABLES)
"RTN","MAGDHOW2",116,0)
 . Q
"RTN","MAGDHOW2",117,0)
 S SUCCESS=$$MOVESEG^HLOAPI(.HLMSTATE,PV1,.ERROR)
"RTN","MAGDHOW2",118,0)
 I 'SUCCESS D
"RTN","MAGDHOW2",119,0)
 . N MSG,SUBJECT,VARIABLES
"RTN","MAGDHOW2",120,0)
 . S SUBJECT="VistA Imaging Clinical Specialty (CPRS) HL7 Generation"
"RTN","MAGDHOW2",121,0)
 . S MSG(1)="An error occurred in PIDPV1^"_$T(+0)_" where the MOVESEG^HLOAPI invocation"
"RTN","MAGDHOW2",122,0)
 . S MSG(2)="for the PV1 segment failed.  The error message is as follows:"
"RTN","MAGDHOW2",123,0)
 . S MSG(3)=""""_SUCCESS_""""
"RTN","MAGDHOW2",124,0)
 . S VARIABLES("HLMSTATE")=""
"RTN","MAGDHOW2",125,0)
 . S VARIABLES("PID")=""
"RTN","MAGDHOW2",126,0)
 . S VARIABLES("ERROR")=""
"RTN","MAGDHOW2",127,0)
 . D ERROR^MAGDHOWA(SUBJECT,.MSG,.VARIABLES)
"RTN","MAGDHOW2",128,0)
 . Q
"RTN","MAGDHOW2",129,0)
 Q
"RTN","MAGDHOW2",130,0)
 ;
"RTN","MAGDHOW2",131,0)
OUTPUT ; output the messages to ^MAGDHL7
"RTN","MAGDHOW2",132,0)
 N D0,DEL,FMDATE,FMDATETIME,HLAIEN,HDR,HL7,HL7MSH,I,I1,I2,J,K,MSG,N,X,Y,Z
"RTN","MAGDHOW2",133,0)
 S HLAIEN=HLMSTATE("BODY")
"RTN","MAGDHOW2",134,0)
 ;
"RTN","MAGDHOW2",135,0)
 ; build the MSH segment
"RTN","MAGDHOW2",136,0)
 D BUILDHDR^HLOPBLD1(.HLMSTATE,"MSH",.HL7MSH)
"RTN","MAGDHOW2",137,0)
 ;
"RTN","MAGDHOW2",138,0)
 ; copy the two lines of the MSH segment to the HL7 array
"RTN","MAGDHOW2",139,0)
 S HL7MSH=HL7MSH(1)_HL7MSH(2) ; MSH segment
"RTN","MAGDHOW2",140,0)
 S DEL=HLMSTATE("HDR","FIELD SEPARATOR")
"RTN","MAGDHOW2",141,0)
 S $P(HL7MSH,DEL,5)="MAGD-CONSULT" ; receiving application
"RTN","MAGDHOW2",142,0)
 S $P(HL7MSH,DEL,6)="" ; receiving facility
"RTN","MAGDHOW2",143,0)
 S J=1,HL7(J)=HL7MSH
"RTN","MAGDHOW2",144,0)
 ;
"RTN","MAGDHOW2",145,0)
 ; copy the body of the message to the HL7 array
"RTN","MAGDHOW2",146,0)
 ; some of the message may be in ^HLA(HLAIEN) - if so, get it first
"RTN","MAGDHOW2",147,0)
 ;
"RTN","MAGDHOW2",148,0)
 I HLAIEN D  ; get the segments that are saved in ^HLA(HLAIEN)
"RTN","MAGDHOW2",149,0)
 . ; note: segments are separated by a blank line
"RTN","MAGDHOW2",150,0)
 . S I=0 F  S I=$O(^HLA(HLAIEN,1,I)) Q:I=""  D
"RTN","MAGDHOW2",151,0)
 . . S X=$G(^HLA(HLAIEN,1,I,0))
"RTN","MAGDHOW2",152,0)
 . . I X'="" S J=J+1,HL7(J)=X
"RTN","MAGDHOW2",153,0)
 . . Q
"RTN","MAGDHOW2",154,0)
 . Q
"RTN","MAGDHOW2",155,0)
 ;
"RTN","MAGDHOW2",156,0)
 ; get the remainder of the messages from memory
"RTN","MAGDHOW2",157,0)
 ; note: segments are separated by a blank line
"RTN","MAGDHOW2",158,0)
 S I1=0 F  S I1=$O(HLMSTATE("UNSTORED LINES",1,I1)) Q:I1=""  D
"RTN","MAGDHOW2",159,0)
 . S I2=0 F  S I2=$O(HLMSTATE("UNSTORED LINES",1,I1,I2)) Q:I2=""  D
"RTN","MAGDHOW2",160,0)
 . . S X=HLMSTATE("UNSTORED LINES",1,I1,I2)
"RTN","MAGDHOW2",161,0)
 . . I X'="" S J=J+1,HL7(J)=X
"RTN","MAGDHOW2",162,0)
 . . Q
"RTN","MAGDHOW2",163,0)
 . Q
"RTN","MAGDHOW2",164,0)
 ;
"RTN","MAGDHOW2",165,0)
 S N=J ; number of HL7 record lines
"RTN","MAGDHOW2",166,0)
 S DEL=$E(HL7(1),4) ; field separator
"RTN","MAGDHOW2",167,0)
 S $P(HL7(1),DEL,5,6)="MAGD-CONSULT"_DEL ; receiving application
"RTN","MAGDHOW2",168,0)
 ;
"RTN","MAGDHOW2",169,0)
 ; get the next node in the ^MAGDHL7 global
"RTN","MAGDHOW2",170,0)
 S FMDATETIME=$$NOW^XLFDT,FMDATE=$$DT^XLFDT
"RTN","MAGDHOW2",171,0)
 L +^MAGDHL7(2006.5,0):1E9 ; Background process MUST wait
"RTN","MAGDHOW2",172,0)
 S D0=$O(^MAGDHL7(2006.5," "),-1)+1
"RTN","MAGDHOW2",173,0)
 S ^MAGDHL7(2006.5,D0,0)=FMDATE
"RTN","MAGDHOW2",174,0)
 S:FMDATE'="" ^MAGDHL7(2006.5,"B",FMDATE,D0)=""
"RTN","MAGDHOW2",175,0)
 S HDR=$G(^MAGDHL7(2006.5,0))
"RTN","MAGDHOW2",176,0)
 S ^MAGDHL7(2006.5,0)="PACS MESSAGE^2006.5D^"_D0_"^"_($P(HDR,"^",4)+1)
"RTN","MAGDHOW2",177,0)
 L -^MAGDHL7(2006.5,0)
"RTN","MAGDHOW2",178,0)
 ;
"RTN","MAGDHOW2",179,0)
 ; copy the message to the ^MAGDHL7 global, field by field
"RTN","MAGDHOW2",180,0)
 S ^MAGDHL7(2006.5,D0,0)=FMDATE_"^"_MSGTYPE_"^"_FMDATETIME
"RTN","MAGDHOW2",181,0)
 S (I,J)=0  F I=1:1:N S X=HL7(I) D
"RTN","MAGDHOW2",182,0)
 . S Y=$P(X,DEL)
"RTN","MAGDHOW2",183,0)
 . F K=2:1:$L(X,DEL) D  ; copy the lines to the ^MAGDHL7 global
"RTN","MAGDHOW2",184,0)
 . . S Z=$P(X,DEL,K)
"RTN","MAGDHOW2",185,0)
 . . I ($L(Y)+$L(Z))>200 D  ; keep lines short for the global
"RTN","MAGDHOW2",186,0)
 . . . ; output one line of a spanned record
"RTN","MAGDHOW2",187,0)
 . . . S J=J+1,^MAGDHL7(2006.5,D0,1,J,0)=Y,Y=""
"RTN","MAGDHOW2",188,0)
 . . . Q
"RTN","MAGDHOW2",189,0)
 . . S Y=Y_DEL_$P(X,DEL,K)
"RTN","MAGDHOW2",190,0)
 . . Q
"RTN","MAGDHOW2",191,0)
 . S J=J+1,^MAGDHL7(2006.5,D0,1,J,0)=Y
"RTN","MAGDHOW2",192,0)
 . Q
"RTN","MAGDHOW2",193,0)
 S:FMDATETIME'="" ^MAGDHL7(2006.5,"C",FMDATETIME,D0)="" ; P183 PMK 3/6/17
"RTN","MAGDHOW2",194,0)
 ; The next line must be last, since WAIT^MAGDHRS1
"RTN","MAGDHOW2",195,0)
 ; uses this node to determine that the entry is complete.
"RTN","MAGDHOW2",196,0)
 S ^MAGDHL7(2006.5,D0,1,0)="^^"_J_"^"_J_"^"_FMDATETIME
"RTN","MAGDHOW2",197,0)
 Q
"RTN","MAGDHOWA")
0^6^B42474842
"RTN","MAGDHOWA",1,0)
MAGDHOWA ;WOIFO/PMK - Route traditional 1.6 HL7 ADT messages via HLO ;17 Nov 2017 9:36 AM
"RTN","MAGDHOWA",2,0)
 ;;3.0;IMAGING;**138,183**;Mar 19, 2002;Build 11;Sep 03, 2013
"RTN","MAGDHOWA",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHOWA",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOWA",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHOWA",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHOWA",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHOWA",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHOWA",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHOWA",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHOWA",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHOWA",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHOWA",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHOWA",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHOWA",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHOWA",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOWA",17,0)
 ;;
"RTN","MAGDHOWA",18,0)
 ;
"RTN","MAGDHOWA",19,0)
 ; Supported IA #4716 reference ^HLOAPI function calls
"RTN","MAGDHOWA",20,0)
 ; Supported IA #4717 reference ^HLOAPI1 function calls
"RTN","MAGDHOWA",21,0)
 ;
"RTN","MAGDHOWA",22,0)
 ; The ADT A01, A02, A03, A11, A12, and A13 messages for commercial
"RTN","MAGDHOWA",23,0)
 ; PACS were created by patch MAG*3.0*49.
"RTN","MAGDHOWA",24,0)
 ; The ADT A08 and A47 messages were created by patch MAG*3.0*183.
"RTN","MAGDHOWA",25,0)
 ; They are transmitted using the traditional 1.6 HL7 package.
"RTN","MAGDHOWA",26,0)
 ; 
"RTN","MAGDHOWA",27,0)
 ; The HL7 for clinical specialties uses the new HL7 Optimized package.
"RTN","MAGDHOWA",28,0)
 ; 
"RTN","MAGDHOWA",29,0)
 ; This routine is referenced by subscriber protocols to the original
"RTN","MAGDHOWA",30,0)
 ; six HL7 event drivers and the two new ones for A08 and A47.
"RTN","MAGDHOWA",31,0)
 ; It enables the HL7 1.6 messages to be routed using the new HL7
"RTN","MAGDHOWA",32,0)
 ; Optimized package.  In this way, all of the clinical specialty
"RTN","MAGDHOWA",33,0)
 ; systems deal with just the HL7 Optimized package.
"RTN","MAGDHOWA",34,0)
 ; 
"RTN","MAGDHOWA",35,0)
 ; 
"RTN","MAGDHOWA",36,0)
 ; There are eight MAG CPACS ADT event drivers:
"RTN","MAGDHOWA",37,0)
 ;   MAG CPACS A01 - Inpatient admission
"RTN","MAGDHOWA",38,0)
 ;   MAG CPACS A02 - Patient transfer
"RTN","MAGDHOWA",39,0)
 ;   MAG CPACS A03 - Patient discharge
"RTN","MAGDHOWA",40,0)
 ;   MAG CPACS A08 - Update patient information 
"RTN","MAGDHOWA",41,0)
 ;   MAG CPACS A11 - Cancel inpatient admission
"RTN","MAGDHOWA",42,0)
 ;   MAG CPACS A12 - Cancel patient transfer
"RTN","MAGDHOWA",43,0)
 ;   MAG CPACS A13 - Cancel patient discharge
"RTN","MAGDHOWA",44,0)
 ;   MAG CPACS A47 - Change patient identifier list
"RTN","MAGDHOWA",45,0)
 ;   
"RTN","MAGDHOWA",46,0)
 ; There are eight MAG CPACS ADT HL7 1.6 subscribers:
"RTN","MAGDHOWA",47,0)
 ;   MAG CPACS A01 SUBS - Routes inpatient admissions
"RTN","MAGDHOWA",48,0)
 ;   MAG CPACS A02 SUBS - Routes patient transfers
"RTN","MAGDHOWA",49,0)
 ;   MAG CPACS A03 SUBS - Routes patient discharges
"RTN","MAGDHOWA",50,0)
 ;   MAG CPACS A08 SUBS - Update patient information
"RTN","MAGDHOWA",51,0)
 ;   MAG CPACS A11 SUBS - Routes admission cancellations
"RTN","MAGDHOWA",52,0)
 ;   MAG CPACS A12 SUBS - Routes transfer cancellations
"RTN","MAGDHOWA",53,0)
 ;   MAG CPACS A13 SUBS - Routes discharge cancellations
"RTN","MAGDHOWA",54,0)
 ;   MAG CPACS A47 SUBS - Routes change patient identifier list
"RTN","MAGDHOWA",55,0)
 ; All of these use the HL7 logical link MAG CPACS 
"RTN","MAGDHOWA",56,0)
 ; 
"RTN","MAGDHOWA",57,0)
 ; There are eight MAG CPACS ADT HLO subscribers that call this routine:
"RTN","MAGDHOWA",58,0)
 ;   MAG CPACS A01 SUBS-HLO - Routes inpatient admissions
"RTN","MAGDHOWA",59,0)
 ;   MAG CPACS A02 SUBS-HLO - Routes patient transfers
"RTN","MAGDHOWA",60,0)
 ;   MAG CPACS A03 SUBS-HLO - Routes patient discharges
"RTN","MAGDHOWA",61,0)
 ;   MAG CPACS A08 SUBS-HLO - Update patient information
"RTN","MAGDHOWA",62,0)
 ;   MAG CPACS A11 SUBS-HLO - Routes admission cancellations
"RTN","MAGDHOWA",63,0)
 ;   MAG CPACS A12 SUBS-HLO - Routes transfer cancellations
"RTN","MAGDHOWA",64,0)
 ;   MAG CPACS A13 SUBS-HLO - Routes discharge cancellations
"RTN","MAGDHOWA",65,0)
 ;   MAG CPACS A47 SUBS-HLO - Routes change patient identifier list
"RTN","MAGDHOWA",66,0)
 ;   
"RTN","MAGDHOWA",67,0)
 ; All eight new MAG CPACS ADT HLO subscribers call this routine - each
"RTN","MAGDHOWA",68,0)
 ; protocol file (#101) entry has PROCESSING ROUTINE: D ENTRY^MAGDHOWA
"RTN","MAGDHOWA",69,0)
 ; 
"RTN","MAGDHOWA",70,0)
 ; 
"RTN","MAGDHOWA",71,0)
ENTRY ; subscriber entry point
"RTN","MAGDHOWA",72,0)
 N HLMSTATE,MSGTYPE
"RTN","MAGDHOWA",73,0)
 ;
"RTN","MAGDHOWA",74,0)
 S MSGTYPE="ADT"
"RTN","MAGDHOWA",75,0)
 ;
"RTN","MAGDHOWA",76,0)
 D INPUT
"RTN","MAGDHOWA",77,0)
 ;
"RTN","MAGDHOWA",78,0)
 D OUTPUT
"RTN","MAGDHOWA",79,0)
 Q
"RTN","MAGDHOWA",80,0)
 ;
"RTN","MAGDHOWA",81,0)
INPUT ; get the generated HL7 message and save it in HLO's HLMSTATE
"RTN","MAGDHOWA",82,0)
 N A,B,C,ERROR,EVENT,S1,S2,S3,S4,S5
"RTN","MAGDHOWA",83,0)
 I $E($G(HLARYTYP),1)="G" M A=^TMP("HLS",$J)
"RTN","MAGDHOWA",84,0)
 E  I $E($G(HLARYTYP),1)="L" M A=HLA("HLS")
"RTN","MAGDHOWA",85,0)
 E  Q  ; no input data <-----------------------------
"RTN","MAGDHOWA",86,0)
 ;
"RTN","MAGDHOWA",87,0)
 S A(1)=HLREC("HDR")
"RTN","MAGDHOWA",88,0)
 ;
"RTN","MAGDHOWA",89,0)
 ; $$PARSE converts HL7 message "A" to HL7 tree ("B") 
"RTN","MAGDHOWA",90,0)
 ;
"RTN","MAGDHOWA",91,0)
 S X=$$PARSE^MAG7UP("A","B")
"RTN","MAGDHOWA",92,0)
 ;
"RTN","MAGDHOWA",93,0)
 ; "C" will contain the HL7 HLO tree, just the fifth subscript level
"RTN","MAGDHOWA",94,0)
 ; 
"RTN","MAGDHOWA",95,0)
 S S1="" F  S S1=$O(B(S1)) Q:S1=""  D
"RTN","MAGDHOWA",96,0)
 . S S2="" F  S S2=$O(B(S1,S2)) Q:S2=""  D
"RTN","MAGDHOWA",97,0)
 . . ;
"RTN","MAGDHOWA",98,0)
 . . ; store segment name at (S1,0,1,1,1) node
"RTN","MAGDHOWA",99,0)
 . . I S2=0 S C(S1,0,1,1,1)=B(S1,0) Q
"RTN","MAGDHOWA",100,0)
 . . ;
"RTN","MAGDHOWA",101,0)
 . . S S3="" F  S S3=$O(B(S1,S2,S3)) Q:S3=""  D
"RTN","MAGDHOWA",102,0)
  . . . S S4="" F  S S4=$O(B(S1,S2,S3,S4)) Q:S4=""  D
"RTN","MAGDHOWA",103,0)
  . . . . S S5="" F  S S5=$O(B(S1,S2,S3,S4,S5)) Q:S5=""  D
"RTN","MAGDHOWA",104,0)
 . . . . . S C(S1,S2,S3,S4,S5)=B(S1,S2,S3,S4,S5)
"RTN","MAGDHOWA",105,0)
 . . . . . Q
"RTN","MAGDHOWA",106,0)
 . . . . Q
"RTN","MAGDHOWA",107,0)
 . . . Q
"RTN","MAGDHOWA",108,0)
 . . Q
"RTN","MAGDHOWA",109,0)
 . Q
"RTN","MAGDHOWA",110,0)
 ;
"RTN","MAGDHOWA",111,0)
 I C(2,0,1,1,1)="EVN" D
"RTN","MAGDHOWA",112,0)
 . S EVENT=C(2,1,1,1,1) ; ADT event type from the EVN message
"RTN","MAGDHOWA",113,0)
 . Q
"RTN","MAGDHOWA",114,0)
 E  S EVENT="O01" ; unknown event? <-------------------------------
"RTN","MAGDHOWA",115,0)
 ;
"RTN","MAGDHOWA",116,0)
 ; build the HLO structure with all the segments, after the MSH
"RTN","MAGDHOWA",117,0)
 D INIT^MAGDHOW2(MSGTYPE,EVENT)
"RTN","MAGDHOWA",118,0)
 S S1=1 F  S S1=$O(C(S1)) Q:S1=""  D
"RTN","MAGDHOWA",119,0)
 . N SEGMENT,SUCCESS
"RTN","MAGDHOWA",120,0)
 . M SEGMENT=C(S1)
"RTN","MAGDHOWA",121,0)
 . S SUCCESS=$$ADDSEG^HLOAPI(.HLMSTATE,.SEGMENT,.ERROR)
"RTN","MAGDHOWA",122,0)
 . I 'SUCCESS D
"RTN","MAGDHOWA",123,0)
 . . N MSG,SUBJECT,VARIABLES
"RTN","MAGDHOWA",124,0)
 . . S SUBJECT="Clinical Specialty HL7 Generation"
"RTN","MAGDHOWA",125,0)
 . . S MSG(1)="An error occurred in INPUT^"_$T(+0)_" where the ADDSEG^HLOAPI"
"RTN","MAGDHOWA",126,0)
 . . S MSG(2)="invocation failed.  The error message is as follows:"
"RTN","MAGDHOWA",127,0)
 . . S MSG(3)=""""_SUCCESS_""""
"RTN","MAGDHOWA",128,0)
 . . S VARIABLES("HLMSTATE")=""
"RTN","MAGDHOWA",129,0)
 . . S VARIABLES("SEGMENT")=""
"RTN","MAGDHOWA",130,0)
 . . S VARIABLES("ERROR")=""
"RTN","MAGDHOWA",131,0)
 . . S VARIABLES("C")=""
"RTN","MAGDHOWA",132,0)
 . . D ERROR^MAGDHOWA(SUBJECT,.MSG,.VARIABLES)
"RTN","MAGDHOWA",133,0)
 . . Q
"RTN","MAGDHOWA",134,0)
 . Q
"RTN","MAGDHOWA",135,0)
 Q
"RTN","MAGDHOWA",136,0)
 ;
"RTN","MAGDHOWA",137,0)
OUTPUT ; send the HL7 message using HLO's subscription list
"RTN","MAGDHOWA",138,0)
 N DIC,DO,HL7SUBLIST,MESSAGES,PARMS,SUCCESS,X,Y
"RTN","MAGDHOWA",139,0)
 ;
"RTN","MAGDHOWA",140,0)
 ; send the message via subscription list
"RTN","MAGDHOWA",141,0)
 S DIC=779.4,DIC(0)="BX",X="MAGD ADT" D ^DIC
"RTN","MAGDHOWA",142,0)
 S HL7SUBLIST=$P(Y,"^",1) ; Y should equal "<ien>^MAGD ADT"
"RTN","MAGDHOWA",143,0)
 S PARMS("SENDING APPLICATION")="MAGD SENDER"
"RTN","MAGDHOWA",144,0)
 S PARMS("SUBSCRIPTION IEN")=HL7SUBLIST
"RTN","MAGDHOWA",145,0)
 ; the HLO private queue name is the name of the subscription list
"RTN","MAGDHOWA",146,0)
 S PARMS("QUEUE")=$E($$GET1^DIQ(779.4,HL7SUBLIST,.01),1,20) ; private queue, 20 char max.
"RTN","MAGDHOWA",147,0)
 S SUCCESS=$$SENDSUB^HLOAPI1(.HLMSTATE,.PARMS,.MESSAGES)
"RTN","MAGDHOWA",148,0)
 I 'SUCCESS D
"RTN","MAGDHOWA",149,0)
 . N MSG,SUBJECT,VARIABLES
"RTN","MAGDHOWA",150,0)
 . S SUBJECT="Clinical Specialty HL7 Generation"
"RTN","MAGDHOWA",151,0)
 . S MSG(1)="An error occurred in OUTPUT^"_$T(+0)_" where the SENDSUB^HLOAPI1"
"RTN","MAGDHOWA",152,0)
 . S MSG(2)="invocation failed.  The error message is as follows:"
"RTN","MAGDHOWA",153,0)
 . S MSG(3)=""""_SUCCESS_""""
"RTN","MAGDHOWA",154,0)
 . S VARIABLES("HLMSTATE")=""
"RTN","MAGDHOWA",155,0)
 . S VARIABLES("PARMS")=""
"RTN","MAGDHOWA",156,0)
 . D ERROR^MAGDHOWA(SUBJECT,.MSG,.VARIABLES)
"RTN","MAGDHOWA",157,0)
 . Q
"RTN","MAGDHOWA",158,0)
 Q
"RTN","MAGDHOWA",159,0)
 ;
"RTN","MAGDHOWA",160,0)
ERROR(SUBJECT,MSG,VARIABLES) ; error logging subroutine
"RTN","MAGDHOWA",161,0)
 N APP,I,PLACE,VAR
"RTN","MAGDHOWA",162,0)
 ;
"RTN","MAGDHOWA",163,0)
 S PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGDHOWA",164,0)
 S APP="CPRS_DICOM_and_HL7"
"RTN","MAGDHOWA",165,0)
 ;
"RTN","MAGDHOWA",166,0)
 K ^TMP($J,"MAGQ",PLACE,APP)
"RTN","MAGDHOWA",167,0)
 D ADD("Message:"),ADD("")
"RTN","MAGDHOWA",168,0)
 F I=1:1 Q:'$D(MSG(I))  D ADD(MSG(I))
"RTN","MAGDHOWA",169,0)
 D ADD(""),ADD("Variables:"),ADD("")
"RTN","MAGDHOWA",170,0)
 S VAR="" F  S VAR=$O(VARIABLES(VAR)) Q:VAR=""  D
"RTN","MAGDHOWA",171,0)
 . I '$D(@VAR) D ADD(VAR_" (undefined)") ; undefined
"RTN","MAGDHOWA",172,0)
 . E  I $D(@VAR)=1 D ADD(VAR_"="_@VAR) ; scalar
"RTN","MAGDHOWA",173,0)
 . E  D  ; array
"RTN","MAGDHOWA",174,0)
 . . N A
"RTN","MAGDHOWA",175,0)
 . . S A=VAR F  D  Q:A=""  ; traverse the array
"RTN","MAGDHOWA",176,0)
 . . . I $D(@A)#2 D ADD(A_"="_@A)
"RTN","MAGDHOWA",177,0)
 . . . S A=$Q(@A)
"RTN","MAGDHOWA",178,0)
 . . . Q
"RTN","MAGDHOWA",179,0)
 . . Q
"RTN","MAGDHOWA",180,0)
 . Q
"RTN","MAGDHOWA",181,0)
 D ADD("End of Message")
"RTN","MAGDHOWA",182,0)
 D MAILSHR^MAGQBUT1(PLACE,APP,SUBJECT) ; sent the mail message
"RTN","MAGDHOWA",183,0)
 Q
"RTN","MAGDHOWA",184,0)
 ;
"RTN","MAGDHOWA",185,0)
ADD(X) ; add a line to the email message
"RTN","MAGDHOWA",186,0)
 N LASTIEN
"RTN","MAGDHOWA",187,0)
 S LASTIEN=$O(^TMP($J,"MAGQ",PLACE,APP,""),-1)
"RTN","MAGDHOWA",188,0)
 S ^TMP($J,"MAGQ",PLACE,APP,LASTIEN+1)=X
"RTN","MAGDHOWA",189,0)
 Q
"RTN","MAGDHOWA",190,0)
 ;
"RTN","MAGDHOWA",191,0)
TEST ; this tests the email error trap
"RTN","MAGDHOWA",192,0)
 ; S DUZ=126,DUZ(2)=660 - set these appropriately before calling TEST
"RTN","MAGDHOWA",193,0)
 N ARRAY,SCALAR,SUBJECT,UNDEFINED
"RTN","MAGDHOWA",194,0)
 S ARRAY="This is test"
"RTN","MAGDHOWA",195,0)
 S ARRAY(1)="Still testing"
"RTN","MAGDHOWA",196,0)
 S ARRAY("B")="More testing"
"RTN","MAGDHOWA",197,0)
 S ARRAY("C",1,2,3,4,5)="Additional testing"
"RTN","MAGDHOWA",198,0)
 S SCALAR="This is a very bad error"
"RTN","MAGDHOWA",199,0)
 ; S UNDEFINED=
"RTN","MAGDHOWA",200,0)
 S VARIABLES("ARRAY")=""
"RTN","MAGDHOWA",201,0)
 S VARIABLES("SCALAR")=""
"RTN","MAGDHOWA",202,0)
 S VARIABLES("UNDEFINED")=""
"RTN","MAGDHOWA",203,0)
 S SUBJECT="Testing Clinical Specialty HL7 Generation Error Handling"
"RTN","MAGDHOWA",204,0)
 S MSG(1)="This simulated error occurred in TEST^"_$T(+0)_"."
"RTN","MAGDHOWA",205,0)
 S MSG(2)="This error tests the email messages that are used"
"RTN","MAGDHOWA",206,0)
 S MSG(3)="to report the error."
"RTN","MAGDHOWA",207,0)
 D ERROR^MAGDHOWA(SUBJECT,.MSG,.VARIABLES)
"RTN","MAGDHOWA",208,0)
 Q
"RTN","MAGDHPS")
0^25^B62305390
"RTN","MAGDHPS",1,0)
MAGDHPS ;WOIFO/MLH - Maintain subscriptions to Rad HL7 drivers ;19 Oct 2017 8:19 AM
"RTN","MAGDHPS",2,0)
 ;;3.0;IMAGING;**49,183**;Mar 19, 2002;Build 11;Apr 07, 2011
"RTN","MAGDHPS",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHPS",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHPS",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHPS",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHPS",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHPS",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHPS",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHPS",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHPS",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHPS",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHPS",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHPS",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHPS",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHPS",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHPS",17,0)
 ;;
"RTN","MAGDHPS",18,0)
 ; Supported IA #1373 -- accessing ^ORD(101,"B" & ^ORD(101,D0,"775" (including the "B" xref under 775)
"RTN","MAGDHPS",19,0)
 Q
"RTN","MAGDHPS",20,0)
 ;
"RTN","MAGDHPS",21,0)
MAGIP183 ; post install entry point to set subscriptions to V2.4 Radiology
"RTN","MAGDHPS",22,0)
 N MAG30P183 ; special variable to control non-intractive mode
"RTN","MAGDHPS",23,0)
 S MAG30P183=1
"RTN","MAGDHPS",24,0)
 ; 
"RTN","MAGDHPS",25,0)
MAINT ; MAIN ENTRY POINT - allow the user to select the version of HL7
"RTN","MAGDHPS",26,0)
 ; that will be used to create Radiology messages to the VistA Text/
"RTN","MAGDHPS",27,0)
 ; DICOM Gateway and to commercial imaging systems.
"RTN","MAGDHPS",28,0)
 ; 
"RTN","MAGDHPS",29,0)
 N MAGPIX ; --- protocol index, either MAGPIXO or MAGPIXR
"RTN","MAGDHPS",30,0)
 N MAGPIXO ; -- protocol index for MAGD SEND ORM
"RTN","MAGDHPS",31,0)
 N MAGPIXR ; -- protocol index for MAGD SEND ORU
"RTN","MAGDHPS",32,0)
 N RADPSTR ; -- Radiology protocol name string
"RTN","MAGDHPS",33,0)
 N I ; -------- scratch index variable
"RTN","MAGDHPS",34,0)
 N RADPA ; ---- array containing Radiology protocol names and IENs
"RTN","MAGDHPS",35,0)
 N RADPEX ; --- exception flag for Radiology protocol name processing
"RTN","MAGDHPS",36,0)
 N RADPI ; ---- Radiology protocol IEN
"RTN","MAGDHPS",37,0)
 N DA,DIC,DIK,DIR,DTOUT,DUOUT,X,Y ; -- FileMan work variables
"RTN","MAGDHPS",38,0)
 N HL7VER ; --- HL7 version desired 
"RTN","MAGDHPS",39,0)
 ;
"RTN","MAGDHPS",40,0)
 W !!,"This option is used to set the Radiology HL7 version for the DICOM Text Gateway."
"RTN","MAGDHPS",41,0)
 W !,"The HL7 v2.4 is the default and is recommended because it provides more data."
"RTN","MAGDHPS",42,0)
 ; Are there a MAGD SEND ORM and MAGD SEND ORU protocols for us to subscribe?
"RTN","MAGDHPS",43,0)
 S MAGPIXO=$O(^ORD(101,"B","MAGD SEND ORM",0))
"RTN","MAGDHPS",44,0)
 I MAGPIXO D  ; yes
"RTN","MAGDHPS",45,0)
 . U IO(0) W !!,"MAGD SEND ORM protocol found..."
"RTN","MAGDHPS",46,0)
 . Q
"RTN","MAGDHPS",47,0)
 E  D  G ABEND  ; no, bail
"RTN","MAGDHPS",48,0)
 . U IO(0) W !!,"ATTENTION:  The MAGD SEND ORM protocol does not exist"
"RTN","MAGDHPS",49,0)
 . W !,"on this system."
"RTN","MAGDHPS",50,0)
 . Q
"RTN","MAGDHPS",51,0)
 ;
"RTN","MAGDHPS",52,0)
 S MAGPIXR=$O(^ORD(101,"B","MAGD SEND ORU",0))
"RTN","MAGDHPS",53,0)
 I MAGPIXR D  ; yes
"RTN","MAGDHPS",54,0)
 . U IO(0) W !,"MAGD SEND ORU protocol found...",!
"RTN","MAGDHPS",55,0)
 . Q
"RTN","MAGDHPS",56,0)
 E  D  G ABEND  ; no, bail
"RTN","MAGDHPS",57,0)
 . U IO(0) W !!,"ATTENTION:  The MAGD SEND ORU protocol does not exist"
"RTN","MAGDHPS",58,0)
 . W !,"on this system."
"RTN","MAGDHPS",59,0)
 . Q
"RTN","MAGDHPS",60,0)
 ;
"RTN","MAGDHPS",61,0)
 ; Make sure we have all the Radiology protocols we need.
"RTN","MAGDHPS",62,0)
 S RADPSTR="RA CANCEL^RA EXAMINED^RA REG^RA RPT"
"RTN","MAGDHPS",63,0)
 F I=1:1:4 S RADPA(I,0)=$P(RADPSTR,"^",I),RADPA(I+4,0)=RADPA(I,0)_" 2.3",RADPA(I+8,0)=RADPA(I,0)_" 2.4"
"RTN","MAGDHPS",64,0)
 S RADPEX=0
"RTN","MAGDHPS",65,0)
 F I=1:1:12 D  G ABEND:RADPEX
"RTN","MAGDHPS",66,0)
 . U IO(0) W !,RADPA(I,0)_" protocol "
"RTN","MAGDHPS",67,0)
 . S RADPI=$O(^ORD(101,"B",RADPA(I,0),0))
"RTN","MAGDHPS",68,0)
 . I RADPI D
"RTN","MAGDHPS",69,0)
 . . U IO(0) W "found..."
"RTN","MAGDHPS",70,0)
 . . S RADPA(I,1)=RADPI
"RTN","MAGDHPS",71,0)
 . . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXO)) W ?35," MAGD SEND ORM subscribed "
"RTN","MAGDHPS",72,0)
 . . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXR)) W ?35," MAGD SEND ORU subscribed"
"RTN","MAGDHPS",73,0)
 . . Q
"RTN","MAGDHPS",74,0)
 . E  D
"RTN","MAGDHPS",75,0)
 . . U IO(0) W "not found..."
"RTN","MAGDHPS",76,0)
 . . S RADPEX=1
"RTN","MAGDHPS",77,0)
 . . Q
"RTN","MAGDHPS",78,0)
 . Q
"RTN","MAGDHPS",79,0)
 ;
"RTN","MAGDHPS",80,0)
 I $G(MAG30P183) S HL7VER=2.4 ; default for MAG*3.0*183 post install
"RTN","MAGDHPS",81,0)
 E  D  G END:$D(DTOUT),END:$D(DUOUT)
"RTN","MAGDHPS",82,0)
 . ; Find out which version of HL7 they want to send.
"RTN","MAGDHPS",83,0)
 . S DIR(0)="SAX^2.1:HL7 Version 2.1;2.3:HL7 Version 2.3;2.4:HL7 Version 2.4 - Highly Recommended"
"RTN","MAGDHPS",84,0)
 . S DIR("A")="Enter the desired version of HL7: "
"RTN","MAGDHPS",85,0)
 . U IO(0) W !
"RTN","MAGDHPS",86,0)
 . D ^DIR I $D(DTOUT)!$D(DUOUT) Q
"RTN","MAGDHPS",87,0)
 . S HL7VER=Y
"RTN","MAGDHPS",88,0)
 . Q
"RTN","MAGDHPS",89,0)
 ;
"RTN","MAGDHPS",90,0)
 U IO(0) W !,"Subscribing to HL7 version "_HL7VER_" Radiology HL7 protocols..."
"RTN","MAGDHPS",91,0)
 ;
"RTN","MAGDHPS",92,0)
 S RADPEX=0
"RTN","MAGDHPS",93,0)
 I HL7VER=2.1 D  G ABEND:RADPEX
"RTN","MAGDHPS",94,0)
 . ; If 2.1 protocols are already subscribed to, do nothing;
"RTN","MAGDHPS",95,0)
 . ; otherwise, subscribe to them.
"RTN","MAGDHPS",96,0)
 . F I=1:1:4 D  Q:RADPEX
"RTN","MAGDHPS",97,0)
 . . ; associate Imaging and Radiology order and report protocols appropriately
"RTN","MAGDHPS",98,0)
 . . S MAGPIX=$S(I=4:MAGPIXR,1:MAGPIXO)
"RTN","MAGDHPS",99,0)
 . . U IO(0) W !,"   Protocol "_RADPA(I,0)_" "
"RTN","MAGDHPS",100,0)
 . . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIX)) D
"RTN","MAGDHPS",101,0)
 . . . W "is already subscribed to, no action taken"
"RTN","MAGDHPS",102,0)
 . . . Q
"RTN","MAGDHPS",103,0)
 . . E  D ADD(MAGPIX,RADPA(I,1),.RADPEX)
"RTN","MAGDHPS",104,0)
 . . W "..."
"RTN","MAGDHPS",105,0)
 . . Q
"RTN","MAGDHPS",106,0)
 . ; If 2.3 or 2.4 protocols are currently subscribed to, unsubscribe from them;
"RTN","MAGDHPS",107,0)
 . ; otherwise, do nothing.
"RTN","MAGDHPS",108,0)
 . F I=5:1:12 D
"RTN","MAGDHPS",109,0)
 . . ; associate Imaging and Radiology order and report protocols appropriately
"RTN","MAGDHPS",110,0)
 . . ; S MAGPIX=$S(I=8:MAGPIXR,1:MAGPIXO)
"RTN","MAGDHPS",111,0)
 . . U IO(0) W !,"   Protocol "_RADPA(I,0)_" "
"RTN","MAGDHPS",112,0)
 . . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXO)) D
"RTN","MAGDHPS",113,0)
 . . . D KILL(MAGPIXO,RADPA(I,1))
"RTN","MAGDHPS",114,0)
 . . . Q
"RTN","MAGDHPS",115,0)
 . . E  I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXR)) D
"RTN","MAGDHPS",116,0)
 . . . D KILL(MAGPIXR,RADPA(I,1))
"RTN","MAGDHPS",117,0)
 . . . Q
"RTN","MAGDHPS",118,0)
 . . E  D
"RTN","MAGDHPS",119,0)
 . . . W "is not currently subscribed to, no action taken"
"RTN","MAGDHPS",120,0)
 . . . Q
"RTN","MAGDHPS",121,0)
 . . W "..."
"RTN","MAGDHPS",122,0)
 . . Q
"RTN","MAGDHPS",123,0)
 . Q
"RTN","MAGDHPS",124,0)
 ;
"RTN","MAGDHPS",125,0)
 I HL7VER=2.3 D  G ABEND:RADPEX
"RTN","MAGDHPS",126,0)
 . ; If 2.1 or 2.4 protocols are currently subscribed to, unsubscribe from them;
"RTN","MAGDHPS",127,0)
 . ; otherwise, do nothing.
"RTN","MAGDHPS",128,0)
 . F I=1:1:4,9:1:12 D
"RTN","MAGDHPS",129,0)
 . . ; associate Imaging and Radiology order and report protocols appropriately
"RTN","MAGDHPS",130,0)
 . . ; S MAGPIX=$S(I=4:MAGPIXR,1:MAGPIXO)
"RTN","MAGDHPS",131,0)
 . . U IO(0) W !,"   Protocol "_RADPA(I,0)_" "
"RTN","MAGDHPS",132,0)
 . . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXO)) D
"RTN","MAGDHPS",133,0)
 . . . D KILL(MAGPIXO,RADPA(I,1))
"RTN","MAGDHPS",134,0)
 . . . Q
"RTN","MAGDHPS",135,0)
 . . E  I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXR)) D
"RTN","MAGDHPS",136,0)
 . . . D KILL(MAGPIXR,RADPA(I,1))
"RTN","MAGDHPS",137,0)
 . . . Q
"RTN","MAGDHPS",138,0)
 . . E  D
"RTN","MAGDHPS",139,0)
 . . . W "is not currently subscribed to, no action taken"
"RTN","MAGDHPS",140,0)
 . . . Q
"RTN","MAGDHPS",141,0)
 . . W "..."
"RTN","MAGDHPS",142,0)
 . . Q
"RTN","MAGDHPS",143,0)
 . ; If 2.3 protocols are already subscribed to, do nothing;
"RTN","MAGDHPS",144,0)
 . ; otherwise, subscribe to them.
"RTN","MAGDHPS",145,0)
 . F I=5:1:8 D  Q:RADPEX
"RTN","MAGDHPS",146,0)
 . . ; associate Imaging and Radiology order and report protocols appropriately
"RTN","MAGDHPS",147,0)
 . . S MAGPIX=$S(I=8:MAGPIXR,1:MAGPIXO)
"RTN","MAGDHPS",148,0)
 . . U IO(0) W !,"   Protocol "_RADPA(I,0)_" "
"RTN","MAGDHPS",149,0)
 . . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIX)) D
"RTN","MAGDHPS",150,0)
 . . . W "is already subscribed to, no action taken"
"RTN","MAGDHPS",151,0)
 . . . Q
"RTN","MAGDHPS",152,0)
 . . E  D ADD(MAGPIX,RADPA(I,1),.RADPEX)
"RTN","MAGDHPS",153,0)
 . . W "..."
"RTN","MAGDHPS",154,0)
 . . Q
"RTN","MAGDHPS",155,0)
 . Q
"RTN","MAGDHPS",156,0)
 ;
"RTN","MAGDHPS",157,0)
 I HL7VER=2.4 D  G ABEND:RADPEX
"RTN","MAGDHPS",158,0)
 . ; If 2.1 or 2.3 protocols are currently subscribed to, unsubscribe from them;
"RTN","MAGDHPS",159,0)
 . ; otherwise, do nothing.
"RTN","MAGDHPS",160,0)
 . F I=1:1:8 D
"RTN","MAGDHPS",161,0)
 . . ; associate Imaging and Radiology order and report protocols appropriately
"RTN","MAGDHPS",162,0)
 . . ; S MAGPIX=$S(I=4:MAGPIXR,1:MAGPIXO)
"RTN","MAGDHPS",163,0)
 . . U IO(0) W !,"   Protocol "_RADPA(I,0)_" "
"RTN","MAGDHPS",164,0)
 . . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXO)) D
"RTN","MAGDHPS",165,0)
 . . . D KILL(MAGPIXO,RADPA(I,1))
"RTN","MAGDHPS",166,0)
 . . . Q
"RTN","MAGDHPS",167,0)
 . . E  I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIXR)) D
"RTN","MAGDHPS",168,0)
 . . . D KILL(MAGPIXR,RADPA(I,1))
"RTN","MAGDHPS",169,0)
 . . . Q
"RTN","MAGDHPS",170,0)
 . . E  D
"RTN","MAGDHPS",171,0)
 . . . W "is not currently subscribed to, no action taken"
"RTN","MAGDHPS",172,0)
 . . . Q
"RTN","MAGDHPS",173,0)
 . . W "..."
"RTN","MAGDHPS",174,0)
 . . Q
"RTN","MAGDHPS",175,0)
 . ; If 2.4 protocols are already subscribed to, do nothing;
"RTN","MAGDHPS",176,0)
 . ; otherwise, subscribe to them.
"RTN","MAGDHPS",177,0)
 . F I=9:1:12 D  Q:RADPEX
"RTN","MAGDHPS",178,0)
 . . ; associate Imaging and Radiology order and report protocols appropriately
"RTN","MAGDHPS",179,0)
 . . S MAGPIX=$S(I=12:MAGPIXR,1:MAGPIXO)
"RTN","MAGDHPS",180,0)
 . . U IO(0) W !,"   Protocol "_RADPA(I,0)_" "
"RTN","MAGDHPS",181,0)
 . . I $D(^ORD(101,RADPA(I,1),775,"B",MAGPIX)) D
"RTN","MAGDHPS",182,0)
 . . . W "is already subscribed to, no action taken"
"RTN","MAGDHPS",183,0)
 . . . Q
"RTN","MAGDHPS",184,0)
 . . E  D ADD(MAGPIX,RADPA(I,1),.RADPEX)
"RTN","MAGDHPS",185,0)
 . . W "..."
"RTN","MAGDHPS",186,0)
 . . Q
"RTN","MAGDHPS",187,0)
 . Q
"RTN","MAGDHPS",188,0)
 ;
"RTN","MAGDHPS",189,0)
 G END
"RTN","MAGDHPS",190,0)
 ; 
"RTN","MAGDHPS",191,0)
ABEND ; exception raised
"RTN","MAGDHPS",192,0)
 U IO(0) W !,"Please contact Imaging Support for further assistance."
"RTN","MAGDHPS",193,0)
END ;
"RTN","MAGDHPS",194,0)
 Q
"RTN","MAGDHPS",195,0)
 ;
"RTN","MAGDHPS",196,0)
ADD(SUB,EVENTDRV,STATFLAG) ; SUBROUTINE - not to be invoked except from within this routine
"RTN","MAGDHPS",197,0)
 ; Subscribe gateway protocol SUB to the Radiology event driver protocol EVENTDRV.
"RTN","MAGDHPS",198,0)
 N Y,DIC,DA,X ; -- Fileman variables
"RTN","MAGDHPS",199,0)
 S DIC="^ORD(101,"_EVENTDRV_",775,",DIC(0)="L",DA(1)=EVENTDRV,X=SUB
"RTN","MAGDHPS",200,0)
 D FILE^DICN
"RTN","MAGDHPS",201,0)
 I Y=-1 S STATFLAG=1
"RTN","MAGDHPS",202,0)
 W $S('$G(STATFLAG):"has been",1:"could not be")_" subscribed to"
"RTN","MAGDHPS",203,0)
 Q
"RTN","MAGDHPS",204,0)
 ;
"RTN","MAGDHPS",205,0)
KILL(SUB,EVENTDRV) ; SUBROUTINE - not to be invoked except from within this routine
"RTN","MAGDHPS",206,0)
 ; Unsubscribe gateway protocol SUB from the Radiology event driver protocol EVENTDRV.
"RTN","MAGDHPS",207,0)
 N DA,DIK ; -- Fileman variables
"RTN","MAGDHPS",208,0)
 S DA(1)=EVENTDRV,DA=$O(^ORD(101,DA(1),775,"B",SUB,0))
"RTN","MAGDHPS",209,0)
 S DIK="^ORD(101,"_EVENTDRV_",775,"
"RTN","MAGDHPS",210,0)
 D ^DIK
"RTN","MAGDHPS",211,0)
 W "has been unsubscribed from"
"RTN","MAGDHPS",212,0)
 Q
"RTN","MAGIP183")
0^14^B16977771
"RTN","MAGIP183",1,0)
MAGIP183 ;WOIFO/PMK - Install code for MAG*3.0*183 ;12 Oct 2017 4:10 PM
"RTN","MAGIP183",2,0)
 ;;3.0;IMAGING;**183**;Mar 19, 2002;Build 11
"RTN","MAGIP183",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIP183",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP183",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIP183",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIP183",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIP183",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIP183",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIP183",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIP183",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIP183",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIP183",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIP183",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIP183",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIP183",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP183",17,0)
 ;;
"RTN","MAGIP183",18,0)
 ; There are no environment checks here but the MAGIP183 has to be
"RTN","MAGIP183",19,0)
 ; referenced by the "Environment Check Routine" field of the KIDS
"RTN","MAGIP183",20,0)
 ; build so that entry points of the routine are available to the
"RTN","MAGIP183",21,0)
 ; KIDS during all installation phases.
"RTN","MAGIP183",22,0)
 ; 
"RTN","MAGIP183",23,0)
 ; Supported IA #1157 reference for $$ADD^XPDMENU function
"RTN","MAGIP183",24,0)
 ; 
"RTN","MAGIP183",25,0)
 Q
"RTN","MAGIP183",26,0)
 ;
"RTN","MAGIP183",27,0)
 ;+++++ INSTALLATION ERROR HANDLING
"RTN","MAGIP183",28,0)
ERROR ;
"RTN","MAGIP183",29,0)
 S:$D(XPDNM) XPDABORT=1
"RTN","MAGIP183",30,0)
 ;--- Display the messages and store them to the INSTALL file
"RTN","MAGIP183",31,0)
 D DUMP^MAGUERR1(),ABTMSG^MAGKIDS()
"RTN","MAGIP183",32,0)
 Q
"RTN","MAGIP183",33,0)
 ;
"RTN","MAGIP183",34,0)
 ;
"RTN","MAGIP183",35,0)
 ;
"RTN","MAGIP183",36,0)
 ;***** PRE-INSTALL CODE
"RTN","MAGIP183",37,0)
PRE ;
"RTN","MAGIP183",38,0)
 Q
"RTN","MAGIP183",39,0)
 ;
"RTN","MAGIP183",40,0)
 ;
"RTN","MAGIP183",41,0)
 ;
"RTN","MAGIP183",42,0)
 ;***** POST-INSTALL CODE
"RTN","MAGIP183",43,0)
POS ;
"RTN","MAGIP183",44,0)
 N CALLBACK
"RTN","MAGIP183",45,0)
 D CLEAR^MAGUERR(1)
"RTN","MAGIP183",46,0)
 ;
"RTN","MAGIP183",47,0)
 ;--- Various Updates
"RTN","MAGIP183",48,0)
 I $$CP^MAGKIDS("MAG P183 UPDATE","$$UPDATE^"_$T(+0))<0  D ERROR  Q
"RTN","MAGIP183",49,0)
 ;
"RTN","MAGIP183",50,0)
 W !!!,"Setting DICOM Text Gateway to use Radiology HL7 V2.4 protocols -- PASS 1"
"RTN","MAGIP183",51,0)
 D MAGIP183^MAGDHPS ; set the Radiology HL7 V2.4 for MAG SEND ORM/ORU
"RTN","MAGIP183",52,0)
 W !!!,"Setting DICOM Text Gateway to use Radiology HL7 V2.4 protocols -- PASS 2"
"RTN","MAGIP183",53,0)
 D MAGIP183^MAGDHPS ; run twice to remove any incorrect settings
"RTN","MAGIP183",54,0)
 ;
"RTN","MAGIP183",55,0)
 ;--- Send the notification e-mail
"RTN","MAGIP183",56,0)
 D BMES^XPDUTL("Post Install Mail Message: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","MAGIP183",57,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGIP183",58,0)
 Q
"RTN","MAGIP183",59,0)
 ;
"RTN","MAGIP183",60,0)
UPDATE() ;
"RTN","MAGIP183",61,0)
 ; This subroutine creates the MAGD PATHOLOGY entry in the
"RTN","MAGIP183",62,0)
 ; HLO SUBSCRIPTION REGISTRY (file 779.4).
"RTN","MAGIP183",63,0)
 D NEW7794 ; create new entry in file 779.4
"RTN","MAGIP183",64,0)
 D UPDTMENU ; set display order for IHE menu option
"RTN","MAGIP183",65,0)
 Q 0
"RTN","MAGIP183",66,0)
 ;
"RTN","MAGIP183",67,0)
NEW7794 ; create an entry in the HLO SUBSCRIPTION REGISTRY (file 779.4)
"RTN","MAGIP183",68,0)
 N DESCRIPTION,NAME,OWNER
"RTN","MAGIP183",69,0)
 ; create the MAGD PATHOLOGY entry
"RTN","MAGIP183",70,0)
 S NAME="MAGD PATHOLOGY"
"RTN","MAGIP183",71,0)
 S DESCRIPTION="Subscription list for anatomic pathology"
"RTN","MAGIP183",72,0)
 S OWNER="MAGD (Imaging)"
"RTN","MAGIP183",73,0)
 D NEW7794A(NAME,DESCRIPTION,OWNER)
"RTN","MAGIP183",74,0)
 Q
"RTN","MAGIP183",75,0)
 ;
"RTN","MAGIP183",76,0)
NEW7794A(NAME,DESCRIPTION,OWNER) ; create the entry in file 779.4
"RTN","MAGIP183",77,0)
 N DIC,DIERR,I,IENS,MAGERR,MAGFDA,MAGIENS,X,Y
"RTN","MAGIP183",78,0)
 ;
"RTN","MAGIP183",79,0)
 ; check to see if <NAME> already exists
"RTN","MAGIP183",80,0)
 S DIC=779.4,DIC(0)="BX",X=NAME D ^DIC
"RTN","MAGIP183",81,0)
 I Y>0 D  Q
"RTN","MAGIP183",82,0)
 . D MES^MAGKIDS(""""_NAME_""" already exists in the HLO SUBSCRIPTION REGISTRY.")
"RTN","MAGIP183",83,0)
 . Q
"RTN","MAGIP183",84,0)
 D MES^MAGKIDS("Creating new """_NAME_""" HLO SUBSCRIPTION REGISTRY entry.")
"RTN","MAGIP183",85,0)
 ;
"RTN","MAGIP183",86,0)
 S IENS="+1,"
"RTN","MAGIP183",87,0)
 S MAGFDA(779.4,IENS,.01)=NAME        ; NAME
"RTN","MAGIP183",88,0)
 S MAGFDA(779.4,IENS,.02)=OWNER       ; OWNER
"RTN","MAGIP183",89,0)
 S MAGFDA(779.4,IENS,.03)=DESCRIPTION ; DESCRIPTION
"RTN","MAGIP183",90,0)
 D UPDATE^DIE("","MAGFDA","MAGIENS","MAGERR")
"RTN","MAGIP183",91,0)
 I $D(DIERR) D  Q
"RTN","MAGIP183",92,0)
 . D MES^MAGKIDS("Error in creating """_NAME_""" in the HLO SUBSCRIPTION REGISTRY.")
"RTN","MAGIP183",93,0)
 . F I=1:1 Q:'$D(MAGERR("DIERR",1,"TEXT",I))  D
"RTN","MAGIP183",94,0)
 . . D MES^MAGKIDS(MAGERR("DIERR",1,"TEXT",I))
"RTN","MAGIP183",95,0)
 . . Q
"RTN","MAGIP183",96,0)
 . Q
"RTN","MAGIP183",97,0)
 Q 
"RTN","MAGIP183",98,0)
 ;
"RTN","MAGIP183",99,0)
UPDTMENU ; set the DISPLAY ORDER for MAG CONFIGURE IHE PACS HL7 I/F
"RTN","MAGIP183",100,0)
 N MENU,MSG,OPTION,ORDER,SYNONYM,X
"RTN","MAGIP183",101,0)
 S MENU="MAG HL7 MAINT"
"RTN","MAGIP183",102,0)
 S OPTION="MAG CONFIGURE IHE PACS HL7 I/F"
"RTN","MAGIP183",103,0)
 S SYNONYM="IHE"
"RTN","MAGIP183",104,0)
 S ORDER=20 ; display order
"RTN","MAGIP183",105,0)
 S MSG="Updating DISPLAY ORDER for "_SYNONYM_" on "_MENU_" menu -- "
"RTN","MAGIP183",106,0)
 S X=$$ADD^XPDMENU(MENU,OPTION,SYNONYM,ORDER)
"RTN","MAGIP183",107,0)
 I X>0 D
"RTN","MAGIP183",108,0)
 . D MES^MAGKIDS(MSG_"SUCCESS.")
"RTN","MAGIP183",109,0)
 . Q
"RTN","MAGIP183",110,0)
 E  D
"RTN","MAGIP183",111,0)
 . D MES^MAGKIDS(MSG_"FAILURE: """_$P(X,"^",2,999)_"""")
"RTN","MAGIP183",112,0)
 . Q
"RTN","MAGIP183",113,0)
 Q
"RTN","MAGT7MA")
0^7^B133779882
"RTN","MAGT7MA",1,0)
MAGT7MA ;WOIFO/MLH/PMK/DAC - Telepathology - create HL7 message to DPS ;02 Jan 2018 12:58 PM
"RTN","MAGT7MA",2,0)
 ;;3.0;IMAGING;**138,173,166,183**;Mar 19, 2002;Build 11;Sep 03, 2013
"RTN","MAGT7MA",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGT7MA",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGT7MA",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGT7MA",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGT7MA",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGT7MA",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGT7MA",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGT7MA",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGT7MA",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGT7MA",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGT7MA",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGT7MA",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGT7MA",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGT7MA",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGT7MA",17,0)
 ;;
"RTN","MAGT7MA",18,0)
 ;
"RTN","MAGT7MA",19,0)
 ; Supported IA #4716 reference ^HLOAPI function calls
"RTN","MAGT7MA",20,0)
 ; Supported IA #4717 reference ^HLOAPI1 function calls
"RTN","MAGT7MA",21,0)
 ; Supported IA #1947 reference ^LAB(60) global references
"RTN","MAGT7MA",22,0)
 ;
"RTN","MAGT7MA",23,0)
 Q
"RTN","MAGT7MA",24,0)
 ;
"RTN","MAGT7MA",25,0)
EDIT ; main entry point to create HL7 order message for modification
"RTN","MAGT7MA",26,0)
 N RETURN
"RTN","MAGT7MA",27,0)
 S RETURN=$$BUILDHL7("EDIT")
"RTN","MAGT7MA",28,0)
 I RETURN D ERROR^MAGT7MA(RETURN,"EDIT")
"RTN","MAGT7MA",29,0)
 Q
"RTN","MAGT7MA",30,0)
 ;
"RTN","MAGT7MA",31,0)
NEW ; entry point for to create HL7 order message for a new case
"RTN","MAGT7MA",32,0)
 N MAGNEWCASE ; cause MAGNEWCASE to be undefined (it is set to 1 in LRAPLG1)
"RTN","MAGT7MA",33,0)
 N RETURN
"RTN","MAGT7MA",34,0)
 S RETURN=$$BUILDHL7("NEW")
"RTN","MAGT7MA",35,0)
 I RETURN D ERROR^MAGT7MA(RETURN,"NEW")
"RTN","MAGT7MA",36,0)
 Q
"RTN","MAGT7MA",37,0)
 ;
"RTN","MAGT7MA",38,0)
BUILDHL7(STATE) ; build the segments
"RTN","MAGT7MA",39,0)
 ; Input variables from Lab Package
"RTN","MAGT7MA",40,0)
 ; LRDFN ----- lab file (#63) patient pointer
"RTN","MAGT7MA",41,0)
 ; LRI ------- inverse date in lab file (#63)
"RTN","MAGT7MA",42,0)
 ; LRSS ------ anatomic pathology section abbreviation in lab file (#63) - CY, EM, or SP
"RTN","MAGT7MA",43,0)
 ;
"RTN","MAGT7MA",44,0)
 N ACNUMB ; -- Accession Number (order number, not specimen number)
"RTN","MAGT7MA",45,0)
 N COMPLETED ; date the report was completed
"RTN","MAGT7MA",46,0)
 N DFN ; ----- local copy of DFN obtained from file #63 using LRDFN 
"RTN","MAGT7MA",47,0)
 N FILE ; ---- LAB DATA subfile numbers and other info
"RTN","MAGT7MA",48,0)
 N MSHELTS ; - HL7 element array for the message header
"RTN","MAGT7MA",49,0)
 N ERRMSG ; -- error message returned from called HLO modules
"RTN","MAGT7MA",50,0)
 N MSG ; ----- HLO HL7 message pointer
"RTN","MAGT7MA",51,0)
 N IENS ; ---- subscripts to lab patient record
"RTN","MAGT7MA",52,0)
 N RELEASED ;- date/time the report was released
"RTN","MAGT7MA",53,0)
 N SEGNAME ; - segment names to be created
"RTN","MAGT7MA",54,0)
 N SEGELTS ; - HL7 element array for a single segment
"RTN","MAGT7MA",55,0)
 N SETID ; --- counters used for message segments
"RTN","MAGT7MA",56,0)
 N LABDATA ; - array to hold the data for GETS^DIQ call
"RTN","MAGT7MA",57,0)
 N ERROR ; --- error variable for GETS^DIQ call
"RTN","MAGT7MA",58,0)
 ;
"RTN","MAGT7MA",59,0)
 N ERRSTAT S ERRSTAT=0 ; error status - assume nothing to report
"RTN","MAGT7MA",60,0)
 ;
"RTN","MAGT7MA",61,0)
 I $$SENDHL7()'="YES" Q ERRSTAT ; don't send the HL7 if switch isn't "YES"
"RTN","MAGT7MA",62,0)
 ;
"RTN","MAGT7MA",63,0)
 ; is this a new case?  MAGNEWCASE set in LRAPLG1 before call to MAGTP005.
"RTN","MAGT7MA",64,0)
 I $G(MAGNEWCASE)=1 Q ERRSTAT ; ignore the first call for a new case
"RTN","MAGT7MA",65,0)
 ;
"RTN","MAGT7MA",66,0)
 I $G(LRDFN)="" Q ERRSTAT  ; P173 no/null LRDFN - just quit
"RTN","MAGT7MA",67,0)
 I $G(LRI)="" Q ERRSTAT  ; P173 no/null LRI - just quit
"RTN","MAGT7MA",68,0)
 I $G(LRSS)="AU" Q ERRSTAT ; autopsy (not supported) - just quit
"RTN","MAGT7MA",69,0)
 ;
"RTN","MAGT7MA",70,0)
 I $$GET1^DIQ(63,LRDFN,.02)'="PATIENT" Q ERRSTAT  ; not in PATIENT file (#2)
"RTN","MAGT7MA",71,0)
 S DFN=$$GET1^DIQ(63,LRDFN,.03,"I")
"RTN","MAGT7MA",72,0)
 I 'DFN Q ERRSTAT  ; P173 Patient DFN not defined in LAB DATA (#63) file for LRDFN
"RTN","MAGT7MA",73,0)
 ;
"RTN","MAGT7MA",74,0)
 S MSHELTS("EVENT")="O21"
"RTN","MAGT7MA",75,0)
 S MSHELTS("MESSAGE STRUCTURE")="OML_O21"
"RTN","MAGT7MA",76,0)
 S MSHELTS("MESSAGE TYPE")="OML"
"RTN","MAGT7MA",77,0)
 S MSHELTS("VERSION")="2.5.1"
"RTN","MAGT7MA",78,0)
 S MSHELTS("COUNTRY")="USA"
"RTN","MAGT7MA",79,0)
 ;
"RTN","MAGT7MA",80,0)
 I '$$NEWMSG^HLOAPI(.MSHELTS,.MSG,.ERRMSG) S ERRSTAT="-2`HLO MESSAGE INITIALIZATION ERROR ("_ERRMSG_")" Q ERRSTAT
"RTN","MAGT7MA",81,0)
 ;
"RTN","MAGT7MA",82,0)
 ; get FILE information
"RTN","MAGT7MA",83,0)
 S ERRSTAT=$$GETFILE^MAGT7MA(LRSS) ; set FILE value
"RTN","MAGT7MA",84,0)
 Q:ERRSTAT ERRSTAT  ; quit and return the error
"RTN","MAGT7MA",85,0)
 ;
"RTN","MAGT7MA",86,0)
 S IENS=LRI_","_LRDFN_","
"RTN","MAGT7MA",87,0)
 S LABDATA=$NA(^TMP("MAG",$J,"LABDATA"))
"RTN","MAGT7MA",88,0)
 K @LABDATA
"RTN","MAGT7MA",89,0)
 D GETS^DIQ(FILE(0),IENS,"**","I",LABDATA,"ERROR")
"RTN","MAGT7MA",90,0)
 I $D(ERROR) D  Q "-1`ERROR IN GETS^DIQ CALL" ; ignore this error
"RTN","MAGT7MA",91,0)
 . N VARS
"RTN","MAGT7MA",92,0)
 . S VARS="ERROR^FILE(0)^IENS"
"RTN","MAGT7MA",93,0)
 . D ERROR^MAGT7MA("-2`ERROR IN GETS^DIQ CALL","BUILDHL7",VARS)
"RTN","MAGT7MA",94,0)
 . Q
"RTN","MAGT7MA",95,0)
 S ACNUMB=$G(@LABDATA@(FILE(0),IENS,.06,"I"))
"RTN","MAGT7MA",96,0)
 I ACNUMB="" Q "-2`Case not defined in LAB DATA (#63) file for """_LRSS_""" for IENS: """_IENS_""""
"RTN","MAGT7MA",97,0)
 ;
"RTN","MAGT7MA",98,0)
 ; lookup case in MAG PATH CASELIST file(#2005.42) -- PMK P183 5/19/17
"RTN","MAGT7MA",99,0)
 I $$TELEPATH^MAGTP005()="YES",'$D(^MAG(2005.42,"B",ACNUMB)) Q 0 ; not an error, just skip the old case
"RTN","MAGT7MA",100,0)
 ;
"RTN","MAGT7MA",101,0)
 I STATE'="NEW" D
"RTN","MAGT7MA",102,0)
 . S COMPLETED=$$GET1^DIQ(FILE(0),IENS,.03,"I") ; date report completed
"RTN","MAGT7MA",103,0)
 . I COMPLETED S STATE="COMPLETED"
"RTN","MAGT7MA",104,0)
 . ;
"RTN","MAGT7MA",105,0)
 . S RELEASED=$$GET1^DIQ(FILE(0),IENS,.11,"I") ; date/time report released
"RTN","MAGT7MA",106,0)
 . I RELEASED D  ; change status of case in MAG PATH CASELIST (#2005.42)
"RTN","MAGT7MA",107,0)
 . . D STATUPDT^MAGTP005(ACNUMB,"READ")
"RTN","MAGT7MA",108,0)
 . . Q
"RTN","MAGT7MA",109,0)
 . I STATE="CANCELLED" D
"RTN","MAGT7MA",110,0)
 . . ; remove the case from the MAG PATH CASELIST (#2005.42) file
"RTN","MAGT7MA",111,0)
 . . D CANCEL^MAGTP005(ACNUMB)
"RTN","MAGT7MA",112,0)
 . . Q
"RTN","MAGT7MA",113,0)
 . Q
"RTN","MAGT7MA",114,0)
 ;
"RTN","MAGT7MA",115,0)
 D:'ERRSTAT  ; build segments if no error from previous call
"RTN","MAGT7MA",116,0)
 . F SEGNAME="PID","PV1","ORC","TQ1","OBR","NTE","TXT","SPM","IPC" D  Q:ERRSTAT
"RTN","MAGT7MA",117,0)
 . . S ERRSTAT=$$SEGADD^MAGT7S(.MSG,.FILE,LABDATA,STATE,SEGNAME,DFN,LRDFN,LRSS,LRI,IENS,ACNUMB) Q:ERRSTAT
"RTN","MAGT7MA",118,0)
 . . Q
"RTN","MAGT7MA",119,0)
 . Q
"RTN","MAGT7MA",120,0)
 D:'ERRSTAT
"RTN","MAGT7MA",121,0)
 . N DIC,DO,HL7SUBLIST,MESSAGES,PARMS,SUCCESS,X,Y
"RTN","MAGT7MA",122,0)
 . ;
"RTN","MAGT7MA",123,0)
 . ; send the message via subscription list - P183 PMK 3/9/17
"RTN","MAGT7MA",124,0)
 . S DIC=779.4,DIC(0)="BX",X="MAGD PATHOLOGY" D ^DIC
"RTN","MAGT7MA",125,0)
 . S HL7SUBLIST=$P(Y,"^",1) ; Y should equal "<ien>^MAGD PATHOLOGY"
"RTN","MAGT7MA",126,0)
 . S PARMS("SENDING APPLICATION")="MAG TELEPATHOLOGY"
"RTN","MAGT7MA",127,0)
 . S PARMS("SUBSCRIPTION IEN")=HL7SUBLIST
"RTN","MAGT7MA",128,0)
 . ; the HLO private queue name is the name of the subscription list
"RTN","MAGT7MA",129,0)
 . S PARMS("QUEUE")=$E($$GET1^DIQ(779.4,HL7SUBLIST,.01),1,20) ; private queue, 20 char max.
"RTN","MAGT7MA",130,0)
 . S SUCCESS=$$SENDSUB^HLOAPI1(.MSG,.PARMS,.MESSAGES)
"RTN","MAGT7MA",131,0)
 . I 'SUCCESS D
"RTN","MAGT7MA",132,0)
 . . S ERRSTAT="-99`HLO MESSAGE QUEUEING ERROR"
"RTN","MAGT7MA",133,0)
 . . Q
"RTN","MAGT7MA",134,0)
 . E  D  ; send this to the DICOM Gateway
"RTN","MAGT7MA",135,0)
 . . N FMDATE ;-- fileman date
"RTN","MAGT7MA",136,0)
 . . N FMDATETM ; fileman date/time
"RTN","MAGT7MA",137,0)
 . . N HLMSTATE ; HLO parameters used in OUTPUT^MAGDHOW2
"RTN","MAGT7MA",138,0)
 . . N MSGTYPE ;- HL7 message type
"RTN","MAGT7MA",139,0)
 . . S FMDATETM=$$NOW^XLFDT(),FMDATE=FMDATETM\1
"RTN","MAGT7MA",140,0)
 . . M HLMSTATE=MSG S MSGTYPE="OML"
"RTN","MAGT7MA",141,0)
 . . D OUTPUT^MAGDHOW2
"RTN","MAGT7MA",142,0)
 . . Q
"RTN","MAGT7MA",143,0)
 . Q
"RTN","MAGT7MA",144,0)
 K @LABDATA
"RTN","MAGT7MA",145,0)
 Q ERRSTAT
"RTN","MAGT7MA",146,0)
 ;
"RTN","MAGT7MA",147,0)
GETFILE(LRSS) ; get FILE information
"RTN","MAGT7MA",148,0)
 N ERRSTAT S ERRSTAT=0 ; error status - assume nothing to report
"RTN","MAGT7MA",149,0)
 N IEN ; file 60 internal enter number
"RTN","MAGT7MA",150,0)
 ;
"RTN","MAGT7MA",151,0)
 K FILE
"RTN","MAGT7MA",152,0)
 I LRSS="CY" D
"RTN","MAGT7MA",153,0)
 . S FILE("NAME")="CYTOPATHOLOGY"
"RTN","MAGT7MA",154,0)
 . S FILE(0)=63.09
"RTN","MAGT7MA",155,0)
 . S FILE("FIELD")=9
"RTN","MAGT7MA",156,0)
 . S FILE("ORDERED TEST")=63.51
"RTN","MAGT7MA",157,0)
 . S FILE("SPECIMEN")=63.902
"RTN","MAGT7MA",158,0)
 . S FILE("SPECIMEN","SMEAR PREP")=63.9121
"RTN","MAGT7MA",159,0)
 . S FILE("SPECIMEN","SMEAR PREP","STAIN/PROCEDURE")=63.9122
"RTN","MAGT7MA",160,0)
 . S FILE("SPECIMEN","CELL BLOCK")=63.922
"RTN","MAGT7MA",161,0)
 . S FILE("SPECIMEN","CELL BLOCK","CELL BLOCK STAIN")=63.923
"RTN","MAGT7MA",162,0)
 . S FILE("SPECIMEN","MEMBRANE FILTER")=63.924
"RTN","MAGT7MA",163,0)
 . S FILE("SPECIMEN","MEMBRANE FILTER","MEMBRANE FILTER STAIN")=63.9241
"RTN","MAGT7MA",164,0)
 . S FILE("SPECIMEN","PREPARED SLIDES")=63.9024
"RTN","MAGT7MA",165,0)
 . S FILE("SPECIMEN","PREPARED SLIDES","PREPARED SLIDES STAIN")=63.90241
"RTN","MAGT7MA",166,0)
 . S FILE("SPECIMEN","CYTOSPIN")=63.9025
"RTN","MAGT7MA",167,0)
 . S FILE("SPECIMEN","CYTOSPIN","CYTOSPIN STAIN")=63.90251
"RTN","MAGT7MA",168,0)
 . S FILE("COMMENT")=63.908
"RTN","MAGT7MA",169,0)
 . S FILE("TIU REFERENCE")=63.47
"RTN","MAGT7MA",170,0)
 . S FILE("PARENT FILE")=63.09
"RTN","MAGT7MA",171,0)
 . S FILE("PROC/EVENT")=$O(^MAG(2005.85,"B","CYTOLOGY",""))
"RTN","MAGT7MA",172,0)
 . Q
"RTN","MAGT7MA",173,0)
 E  I LRSS="EM" D
"RTN","MAGT7MA",174,0)
 . S FILE("NAME")="ELECTRON MICROSCOPY"
"RTN","MAGT7MA",175,0)
 . S FILE(0)=63.02
"RTN","MAGT7MA",176,0)
 . S FILE("FIELD")=2
"RTN","MAGT7MA",177,0)
 . S FILE("ORDERED TEST")=63.52
"RTN","MAGT7MA",178,0)
 . S FILE("SPECIMEN")=63.202
"RTN","MAGT7MA",179,0)
 . S FILE("SPECIMEN","EPON BLOCK")=63.2021
"RTN","MAGT7MA",180,0)
 . S FILE("SPECIMEN","EPON BLOCK","EM PROCEDURE")=63.20211
"RTN","MAGT7MA",181,0)
 . S FILE("COMMENT")=63.208
"RTN","MAGT7MA",182,0)
 . S FILE("TIU REFERENCE")=63.49
"RTN","MAGT7MA",183,0)
 . S FILE("PARENT FILE")=63.02
"RTN","MAGT7MA",184,0)
 . S FILE("PROC/EVENT")=$O(^MAG(2005.85,"B","ELECTRON MICROSCOPY",""))
"RTN","MAGT7MA",185,0)
 . Q
"RTN","MAGT7MA",186,0)
 E  I LRSS="SP" D
"RTN","MAGT7MA",187,0)
 . S FILE("NAME")="SURGICAL PATHOLOGY"
"RTN","MAGT7MA",188,0)
 . S FILE(0)=63.08
"RTN","MAGT7MA",189,0)
 . S FILE("FIELD")=8
"RTN","MAGT7MA",190,0)
 . S FILE("ORDERED TEST")=63.53
"RTN","MAGT7MA",191,0)
 . S FILE("SPECIMEN")=63.812
"RTN","MAGT7MA",192,0)
 . S FILE("SPECIMEN","PARAFFIN BLOCK")=63.8121
"RTN","MAGT7MA",193,0)
 . S FILE("SPECIMEN","PARAFFIN BLOCK","STAIN/PROCEDURE")=63.8122
"RTN","MAGT7MA",194,0)
 . S FILE("SPECIMEN","PLASTIC BLOCK")=63.822
"RTN","MAGT7MA",195,0)
 . S FILE("SPECIMEN","PLASTIC BLOCK","PLASTIC STAIN/PROCEDURE")=63.823
"RTN","MAGT7MA",196,0)
 . S FILE("SPECIMEN","FROZEN TISSUE BLOCK")=63.824
"RTN","MAGT7MA",197,0)
 . S FILE("SPECIMEN","FROZEN TISSUE BLOCK","STAIN/PROCEDURE")=63.825
"RTN","MAGT7MA",198,0)
 . S FILE("COMMENT")=63.98
"RTN","MAGT7MA",199,0)
 . S FILE("TIU REFERENCE")=63.19
"RTN","MAGT7MA",200,0)
 . S FILE("PARENT FILE")=63.08
"RTN","MAGT7MA",201,0)
 . S FILE("PROC/EVENT")=$O(^MAG(2005.85,"B","SURGICAL PATHOLOGY",""))
"RTN","MAGT7MA",202,0)
 . Q
"RTN","MAGT7MA",203,0)
 E  S ERRSTAT="-1`Illegal AP section abbreviation: """_LRSS_""""
"RTN","MAGT7MA",204,0)
 ;
"RTN","MAGT7MA",205,0)
 D:'ERRSTAT  ; get default procedure name, first one if multiple
"RTN","MAGT7MA",206,0)
 . N X
"RTN","MAGT7MA",207,0)
 . S IEN=0 F  S IEN=$O(^LAB(60,IEN)) Q:'IEN  D  Q:$D(FILE("PROCEDURE NAME"))
"RTN","MAGT7MA",208,0)
 . . S X=$G(^LAB(60,IEN,0))
"RTN","MAGT7MA",209,0)
 . . Q:$P(X,"^",4)'=LRSS  ; SUBSCRIPT needs to match CY, EM, or SP
"RTN","MAGT7MA",210,0)
 . . Q:"IBO"'[$P(X,"^",3)  ; TYPE needs to be INPUT, OUTPUT, or BOTH
"RTN","MAGT7MA",211,0)
 . . Q:'$P($G(^LAB(60,IEN,64)),"^",1)  ; needs to have a VA National Lab Code (file #64)
"RTN","MAGT7MA",212,0)
 . . S FILE("PROCEDURE NAME")=$$GET1^DIQ(60,IEN,.01)
"RTN","MAGT7MA",213,0)
 . . S FILE("PROCEDURE IEN")=IEN
"RTN","MAGT7MA",214,0)
 . . Q
"RTN","MAGT7MA",215,0)
 . I '$D(FILE("PROCEDURE NAME")) D
"RTN","MAGT7MA",216,0)
 . . S ERRSTAT="-53`No test found in LAB(60) file for LRSS="""_LRSS_""""
"RTN","MAGT7MA",217,0)
 . . Q
"RTN","MAGT7MA",218,0)
 . Q
"RTN","MAGT7MA",219,0)
 ;
"RTN","MAGT7MA",220,0)
 Q ERRSTAT
"RTN","MAGT7MA",221,0)
 ;
"RTN","MAGT7MA",222,0)
REPORT ; main entry point - create HL7 order message for an electronically signed report
"RTN","MAGT7MA",223,0)
 Q:'$G(LRDFN)
"RTN","MAGT7MA",224,0)
 N LRI,PARENTFILE,RETURN,X
"RTN","MAGT7MA",225,0)
 S LRI=$G(LRDATA(1)) Q:LRI=""  ;P173
"RTN","MAGT7MA",226,0)
 S PARENTFILE=$G(LRSF) Q:PARENTFILE=""  ;P173
"RTN","MAGT7MA",227,0)
 S X=$$NEWTIU(LRSS,PARENTFILE,LRDFN,LRI)
"RTN","MAGT7MA",228,0)
 S RETURN=$$BUILDHL7^MAGT7MA("COMPLETED")
"RTN","MAGT7MA",229,0)
 I RETURN D ERROR^MAGT7MA(RETURN,"REPORT")
"RTN","MAGT7MA",230,0)
 Q
"RTN","MAGT7MA",231,0)
 ;
"RTN","MAGT7MA",232,0)
CANCEL ; main entry point - create HL7 order message for a cancelled order
"RTN","MAGT7MA",233,0)
 N RETURN
"RTN","MAGT7MA",234,0)
 S RETURN=$$BUILDHL7^MAGT7MA("CANCELLED")
"RTN","MAGT7MA",235,0)
 I RETURN D ERROR^MAGT7MA(RETURN,"CANCEL")
"RTN","MAGT7MA",236,0)
 Q
"RTN","MAGT7MA",237,0)
 ;
"RTN","MAGT7MA",238,0)
NEWTIU(LRSS,PARENTFILE,LRDFN,LRI) ; check if this is a TIU note to be linked to an image group
"RTN","MAGT7MA",239,0)
 ; if so, create the cross-linkages now
"RTN","MAGT7MA",240,0)
 N CROSSREF,D0,FILEDATA,HIT,MAGGP,MAGIEN,NIMAGE,TIUIEN
"RTN","MAGT7MA",241,0)
 S HIT=0
"RTN","MAGT7MA",242,0)
 S D0=""
"RTN","MAGT7MA",243,0)
 F  S D0=$O(^MAG(2006.5838,"C",PARENTFILE,LRDFN,LRI,D0)) Q:'D0  D
"RTN","MAGT7MA",244,0)
 . S MAGGP=$P($G(^MAG(2006.5838,D0,0)),"^",4) Q:'MAGGP
"RTN","MAGT7MA",245,0)
 . S TIUIEN=$$TIUIEN(LRSS,LRDFN,LRI) Q:'TIUIEN
"RTN","MAGT7MA",246,0)
 . S $P(^MAG(2005,MAGGP,2),"^",6,7)="8925^"_TIUIEN
"RTN","MAGT7MA",247,0)
 . D TIUXLINK ; create the cross-linkages to TIU
"RTN","MAGT7MA",248,0)
 . ; update the parent file pointers for all the images
"RTN","MAGT7MA",249,0)
 . S CROSSREF="8925^"_TIUIEN_"^"_FILEDATA("PARENT FILE PTR")
"RTN","MAGT7MA",250,0)
 . S NIMAGE=0 F  S NIMAGE=$O(^MAG(2005,MAGGP,1,NIMAGE)) Q:'NIMAGE  D
"RTN","MAGT7MA",251,0)
 . . S MAGIEN=$P(^MAG(2005,MAGGP,1,NIMAGE,0),"^")
"RTN","MAGT7MA",252,0)
 . . S $P(^MAG(2005,MAGIEN,2),"^",6,8)=CROSSREF
"RTN","MAGT7MA",253,0)
 . . Q
"RTN","MAGT7MA",254,0)
 . ; remove entries from ^MAG(2006.5838) & decrement the counter
"RTN","MAGT7MA",255,0)
 . K ^MAG(2006.5838,D0),^MAG(2006.5838,"C",PARENTFILE,LRDFN,LRI,D0)
"RTN","MAGT7MA",256,0)
 . L +^MAG(2006.5838):1E9 ; Background process MUST wait
"RTN","MAGT7MA",257,0)
 . S $P(^MAG(2006.5838,0),"^",4)=$P(^MAG(2006.5838,0),"^",4)-1
"RTN","MAGT7MA",258,0)
 . L -^MAG(2006.5838)
"RTN","MAGT7MA",259,0)
 . S HIT=1
"RTN","MAGT7MA",260,0)
 . Q
"RTN","MAGT7MA",261,0)
 Q HIT
"RTN","MAGT7MA",262,0)
 ;
"RTN","MAGT7MA",263,0)
TIUXLINK ; create the cross-linkages to TIU EXTERNAL DATA LINK file
"RTN","MAGT7MA",264,0)
 N TIUXDIEN
"RTN","MAGT7MA",265,0)
 D PUTIMAGE^TIUSRVPL(.TIUXDIEN,TIUIEN,MAGGP) ; DBIA #3566
"RTN","MAGT7MA",266,0)
 I TIUXDIEN D
"RTN","MAGT7MA",267,0)
 . S FILEDATA("PARENT FILE PTR")=TIUXDIEN
"RTN","MAGT7MA",268,0)
 . S $P(^MAG(2005,MAGGP,2),"^",8)=TIUXDIEN
"RTN","MAGT7MA",269,0)
 . Q
"RTN","MAGT7MA",270,0)
 E  D  ; fatal error
"RTN","MAGT7MA",271,0)
 . N MSG
"RTN","MAGT7MA",272,0)
 . S MSG(1)="ERROR ASSOCIATING WITH TIU EXTERNAL DATA LINK (file 8925.91): "
"RTN","MAGT7MA",273,0)
 . S MSG(2)=$P(TIUXDIEN,"^",2,999)
"RTN","MAGT7MA",274,0)
 . S MSG(3)=" for lookup in DICOM LAB TEMP LIST (file 2006.5838)."  ;P173
"RTN","MAGT7MA",275,0)
 . D ERR^MAGGTERR  ;P173
"RTN","MAGT7MA",276,0)
 . Q
"RTN","MAGT7MA",277,0)
 Q
"RTN","MAGT7MA",278,0)
 ;
"RTN","MAGT7MA",279,0)
TIUIEN(LRSS,LRDFN,LRI) ; lookup TIU reference
"RTN","MAGT7MA",280,0)
 N FILE ; ---- LAB DATA subfile numbers and other info
"RTN","MAGT7MA",281,0)
 N LABDATA ;-- array to hold LAB DATA (#63)
"RTN","MAGT7MA",282,0)
 N TIUIEN ;--- TIU file 8925 IEN value
"RTN","MAGT7MA",283,0)
 N TIUREF ;--- Anatomic Pathology reference file
"RTN","MAGT7MA",284,0)
 N ERROR ;---- error return for GETS^DIQ Filename API call
"RTN","MAGT7MA",285,0)
 N ERRSTAT S ERRSTAT=0 ; error status - assume nothing to repor
"RTN","MAGT7MA",286,0)
 ;
"RTN","MAGT7MA",287,0)
 S ERRSTAT=$$GETFILE^MAGT7MA(LRSS)
"RTN","MAGT7MA",288,0)
 I ERRSTAT<0 D  Q 0
"RTN","MAGT7MA",289,0)
 . D ERROR^MAGT7MA(ERRSTAT,"TIUIEN")
"RTN","MAGT7MA",290,0)
 . Q 
"RTN","MAGT7MA",291,0)
 ;
"RTN","MAGT7MA",292,0)
 S TIUREF=FILE("TIU REFERENCE")
"RTN","MAGT7MA",293,0)
 ; look up TIU note
"RTN","MAGT7MA",294,0)
 S IENS="1,"_LRI_","_LRDFN_","
"RTN","MAGT7MA",295,0)
 D GETS^DIQ(TIUREF,IENS,"**","I","LABDATA","ERROR")
"RTN","MAGT7MA",296,0)
 I $D(ERROR) D  Q 0
"RTN","MAGT7MA",297,0)
 . N VARS
"RTN","MAGT7MA",298,0)
 . S VARS="ERROR^TIUREF^IENS"
"RTN","MAGT7MA",299,0)
 . D ERROR^MAGT7MA("-2`ERROR IN GETS^DIQ CALL","TIUIEN",VARS)
"RTN","MAGT7MA",300,0)
 . Q
"RTN","MAGT7MA",301,0)
 S TIUIEN=$G(LABDATA(TIUREF,IENS,1,"I"))
"RTN","MAGT7MA",302,0)
 Q TIUIEN
"RTN","MAGT7MA",303,0)
 ;
"RTN","MAGT7MA",304,0)
ERROR(RETURN,TAG,VARS) ; log the error to the user's email
"RTN","MAGT7MA",305,0)
 N I,SUBJECT,MSG,VARIABLES
"RTN","MAGT7MA",306,0)
 S SUBJECT="Anatomic Pathology HL7 Generation"
"RTN","MAGT7MA",307,0)
 S MSG(1)="An error occurred in "_TAG_"^"_$T(+0)_" when trying to create and/or"
"RTN","MAGT7MA",308,0)
 S MSG(2)="send an HL7 message.  The error message is as follows:"
"RTN","MAGT7MA",309,0)
 S MSG(3)=""""_RETURN_""""
"RTN","MAGT7MA",310,0)
 S MSG(4)=""
"RTN","MAGT7MA",311,0)
 S MSG(5)="Please notify your local IRM Staff."
"RTN","MAGT7MA",312,0)
 S VARIABLES("LRDFN")=""
"RTN","MAGT7MA",313,0)
 S VARIABLES("LRI")=""
"RTN","MAGT7MA",314,0)
 S VARIABLES("LRSS")=""
"RTN","MAGT7MA",315,0)
 I $G(VARS)'="" F I=1:1:$L(VARS,"^") S VARIABLES($P(VARS,"^",I))=""
"RTN","MAGT7MA",316,0)
 D ERROR^MAGDHOWA(SUBJECT,.MSG,.VARIABLES)
"RTN","MAGT7MA",317,0)
 Q
"RTN","MAGT7MA",318,0)
 ;
"RTN","MAGT7MA",319,0)
SENDHL7() ; P166 DAC - Get value of SEND ANATOMIC PATHOLOGY HL7 switch
"RTN","MAGT7MA",320,0)
 N IENS
"RTN","MAGT7MA",321,0)
 S IENS=$O(^MAG(2006.1,"B",DUZ(2),""))_","
"RTN","MAGT7MA",322,0)
 Q $$GET1^DIQ(2006.1,IENS,204)
"RTN","MAGT7S")
0^10^B31666917
"RTN","MAGT7S",1,0)
MAGT7S ;WOIFO/MLH/PMK - telepathology - create HL7 message to DPS - segment build;04 May 2017 11:21 AM
"RTN","MAGT7S",2,0)
 ;;3.0;IMAGING;**138,183**;Mar 19, 2002;Build 11;Sep 03, 2013
"RTN","MAGT7S",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGT7S",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGT7S",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGT7S",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGT7S",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGT7S",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGT7S",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGT7S",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGT7S",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGT7S",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGT7S",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGT7S",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGT7S",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGT7S",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGT7S",17,0)
 ;;
"RTN","MAGT7S",18,0)
 ;
"RTN","MAGT7S",19,0)
 ; Supported IA #4716 reference ^HLOAPI function calls
"RTN","MAGT7S",20,0)
 ;
"RTN","MAGT7S",21,0)
 Q
"RTN","MAGT7S",22,0)
 ;
"RTN","MAGT7S",23,0)
SEGADD(MSG,FILE,LABDATA,STATE,SEGNAME,DFN,LRDFN,LRSS,LRI,IENS,ACNUMB) ; FUNCTION - main entry point - create a segment
"RTN","MAGT7S",24,0)
 I $G(SEGNAME)'?1U2NU Q "-4010`Invalid segment name (SEGNAME="_$G(SEGNAME)_")"
"RTN","MAGT7S",25,0)
 N SPMDT ; specimen date
"RTN","MAGT7S",26,0)
 N SEGELTS ; segment element array
"RTN","MAGT7S",27,0)
 N IENSX,IX ; indices for NTE and SPM
"RTN","MAGT7S",28,0)
 ;
"RTN","MAGT7S",29,0)
 N ERRMSG ; Error message
"RTN","MAGT7S",30,0)
 N ERRSTAT S ERRSTAT=0 ; error status - assume nothing to report
"RTN","MAGT7S",31,0)
 ;
"RTN","MAGT7S",32,0)
 D  ; SWITCH on segment name
"RTN","MAGT7S",33,0)
 . I SEGNAME="PID" D  Q  ; get pt number and populate the PID segment
"RTN","MAGT7S",34,0)
 . . D PIDPV1^MAGDHOW2(.MSG,DFN) ; P183 PMK 3/7/17
"RTN","MAGT7S",35,0)
 . . Q
"RTN","MAGT7S",36,0)
 . I SEGNAME="PV1" Q  ; done above in PIDPIV1^MAGDHOW2 - P183 PMK 3/7/17
"RTN","MAGT7S",37,0)
 . ;
"RTN","MAGT7S",38,0)
 . I SEGNAME="ORC" D  Q
"RTN","MAGT7S",39,0)
 . . S ERRSTAT=$$ORCSEG^MAGT7SO(.SEGELTS,.FILE,STATE,IENS,ACNUMB) Q:ERRSTAT
"RTN","MAGT7S",40,0)
 . . I '$$ADDSEG^HLOAPI(.MSG,.SEGELTS,.ERRMSG) D  Q
"RTN","MAGT7S",41,0)
 . . . S ERRSTAT="-2`HLO SEGMENT INSERTION ERROR ("_ERRMSG_")"
"RTN","MAGT7S",42,0)
 . . . Q
"RTN","MAGT7S",43,0)
 . . Q
"RTN","MAGT7S",44,0)
 . I SEGNAME="TQ1" D  Q
"RTN","MAGT7S",45,0)
 . . S ERRSTAT=$$TQ1SEG^MAGT7ST(.SEGELTS,DFN) Q:ERRSTAT
"RTN","MAGT7S",46,0)
 . . I '$$ADDSEG^HLOAPI(.MSG,.SEGELTS,.ERRMSG) D  Q
"RTN","MAGT7S",47,0)
 . . . S ERRSTAT="-2`HLO SEGMENT INSERTION ERROR ("_ERRMSG_")"
"RTN","MAGT7S",48,0)
 . . . Q
"RTN","MAGT7S",49,0)
 . . Q
"RTN","MAGT7S",50,0)
 . I SEGNAME="OBR" D  Q
"RTN","MAGT7S",51,0)
 . . S ERRSTAT=$$OBRSEG^MAGT7SB(.SEGELTS,.FILE,LRSS,IENS,ACNUMB) Q:ERRSTAT
"RTN","MAGT7S",52,0)
 . . I '$$ADDSEG^HLOAPI(.MSG,.SEGELTS,.ERRMSG) D  Q
"RTN","MAGT7S",53,0)
 . . . S ERRSTAT="-2`HLO SEGMENT INSERTION ERROR ("_ERRMSG_")"
"RTN","MAGT7S",54,0)
 . . . Q
"RTN","MAGT7S",55,0)
 . . Q
"RTN","MAGT7S",56,0)
 . I SEGNAME="NTE" D  Q
"RTN","MAGT7S",57,0)
 . . S IENSX=""
"RTN","MAGT7S",58,0)
 . . F  S IENSX=$O(@LABDATA@(FILE("COMMENT"),IENSX)) Q:IENSX=""  D  Q:ERRSTAT
"RTN","MAGT7S",59,0)
 . . . S IX=$P(IENSX,",",1)
"RTN","MAGT7S",60,0)
 . . . S ERRSTAT=$$NTESEGC^MAGT7SN(.SEGELTS,.FILE,IENSX,ACNUMB,IX) Q:ERRSTAT
"RTN","MAGT7S",61,0)
 . . . I '$$ADDSEG^HLOAPI(.MSG,.SEGELTS,.ERRMSG) D  Q
"RTN","MAGT7S",62,0)
 . . . . S ERRSTAT="-2`HLO SEGMENT INSERTION ERROR ("_ERRMSG_")"
"RTN","MAGT7S",63,0)
 . . . . Q
"RTN","MAGT7S",64,0)
 . . . Q
"RTN","MAGT7S",65,0)
 . . Q
"RTN","MAGT7S",66,0)
 . I SEGNAME="SPM" D  Q
"RTN","MAGT7S",67,0)
 . . S IENSX=""
"RTN","MAGT7S",68,0)
 . . F  S IENSX=$O(@LABDATA@(FILE("SPECIMEN"),IENSX)) Q:IENSX=""  D  Q:ERRSTAT
"RTN","MAGT7S",69,0)
 . . . S IX=$P(IENSX,",",1)
"RTN","MAGT7S",70,0)
 . . . S ERRSTAT=$$SPMSEG^MAGT7SS(.SEGELTS,.FILE,IENS,IENSX,ACNUMB,IX) Q:ERRSTAT
"RTN","MAGT7S",71,0)
 . . . I '$$ADDSEG^HLOAPI(.MSG,.SEGELTS,.ERRMSG) D  Q
"RTN","MAGT7S",72,0)
 . . . . S ERRSTAT="-2`HLO SEGMENT INSERTION ERROR ("_ERRMSG_")"
"RTN","MAGT7S",73,0)
 . . . . Q
"RTN","MAGT7S",74,0)
 . . . ; send ancillary specimen attributes in OBX segments
"RTN","MAGT7S",75,0)
 . . . S ERRSTAT=$$SPMANC^MAGT7SSA(.MSG,.FILE,IENSX,LRSS,IX)
"RTN","MAGT7S",76,0)
 . . . Q
"RTN","MAGT7S",77,0)
 . . Q
"RTN","MAGT7S",78,0)
 . I SEGNAME="IPC" D  Q
"RTN","MAGT7S",79,0)
 . . S ERRSTAT=$$IPCSEG^MAGT7SI(.SEGELTS,DFN,ACNUMB) Q:ERRSTAT
"RTN","MAGT7S",80,0)
 . . I '$$ADDSEG^HLOAPI(.MSG,.SEGELTS,.ERRMSG) D  Q
"RTN","MAGT7S",81,0)
 . . . S ERRSTAT="-2`HLO SEGMENT INSERTION ERROR ("_ERRMSG_")"
"RTN","MAGT7S",82,0)
 . . . Q
"RTN","MAGT7S",83,0)
 . . Q
"RTN","MAGT7S",84,0)
 . I SEGNAME="TXT" D  Q  ; output text objects as NTE segments
"RTN","MAGT7S",85,0)
 . . N SS3,TITLE
"RTN","MAGT7S",86,0)
 . . I 'ERRSTAT S TITLE="BRIEF CLINICAL HISTORY",SS3=.013 S ERRSTAT=$$BUILD(.SEGELTS,.FILE,IENS,TITLE,SS3) Q:ERRSTAT
"RTN","MAGT7S",87,0)
 . . I 'ERRSTAT S TITLE="PREOPERATIVE DIAGNOSIS",SS3=.014 S ERRSTAT=$$BUILD(.SEGELTS,.FILE,IENS,TITLE,SS3) Q:ERRSTAT
"RTN","MAGT7S",88,0)
 . . I 'ERRSTAT S TITLE="OPERATIVE FINDINGS",SS3=.015 S ERRSTAT=$$BUILD(.SEGELTS,.FILE,IENS,TITLE,SS3) Q:ERRSTAT
"RTN","MAGT7S",89,0)
 . . I 'ERRSTAT S TITLE="POSTOPERATIVE FINDINGS",SS3=.016 S ERRSTAT=$$BUILD(.SEGELTS,.FILE,IENS,TITLE,SS3) Q:ERRSTAT
"RTN","MAGT7S",90,0)
 . . I 'ERRSTAT S TITLE="GROSS DESCRIPTION",SS3=1 S ERRSTAT=$$BUILD(.SEGELTS,.FILE,IENS,TITLE,SS3) Q:ERRSTAT
"RTN","MAGT7S",91,0)
 . . I 'ERRSTAT S TITLE="MICROSCOPIC DESCRIPTION",SS3=1.1 S ERRSTAT=$$BUILD(.SEGELTS,.FILE,IENS,TITLE,SS3) Q:ERRSTAT
"RTN","MAGT7S",92,0)
 . . I 'ERRSTAT S TITLE="DIAGNOSIS",SS3=1.4 S ERRSTAT=$$BUILD(.SEGELTS,.FILE,IENS,TITLE,SS3) Q:ERRSTAT
"RTN","MAGT7S",93,0)
 . . Q
"RTN","MAGT7S",94,0)
 . S ERRSTAT="-3`unrecognized segment name ("_SEGNAME_")"
"RTN","MAGT7S",95,0)
 . Q
"RTN","MAGT7S",96,0)
 Q ERRSTAT
"RTN","MAGT7S",97,0)
 ;
"RTN","MAGT7S",98,0)
BUILD(SEGELTS,FILE,IENS,TITLE,SS3) ; output an NTE segment for each line of the result
"RTN","MAGT7S",99,0)
 N ERRSTAT S ERRSTAT=0 ; error status - assume nothing to report
"RTN","MAGT7S",100,0)
 N I,FIRST,TEXT
"RTN","MAGT7S",101,0)
 S I="",FIRST=1
"RTN","MAGT7S",102,0)
 F  S I=$O(@LABDATA@(FILE(0),IENS,SS3,I)) Q:'I  D  Q:ERRSTAT
"RTN","MAGT7S",103,0)
 . I FIRST D  S FIRST=0
"RTN","MAGT7S",104,0)
 . . S TEXT="" S ERRSTAT=$$BUILD1(.SEGELTS,TEXT) Q:ERRSTAT
"RTN","MAGT7S",105,0)
 . . S TEXT=TITLE S ERRSTAT=$$BUILD1(.SEGELTS,TEXT) Q:ERRSTAT
"RTN","MAGT7S",106,0)
 . . S TEXT=$TR($J("",$L(TITLE))," ","-") S ERRSTAT=$$BUILD1(.SEGELTS,TEXT) Q:ERRSTAT
"RTN","MAGT7S",107,0)
 . S TEXT=@LABDATA@(FILE(0),IENS,SS3,I) S ERRSTAT=$$BUILD1(.SEGELTS,TEXT) Q:ERRSTAT
"RTN","MAGT7S",108,0)
 . Q
"RTN","MAGT7S",109,0)
 Q ERRSTAT
"RTN","MAGT7S",110,0)
 ;
"RTN","MAGT7S",111,0)
BUILD1(SEGELTS,TEXT) ; output one NTE segment
"RTN","MAGT7S",112,0)
 N ERRSTAT S ERRSTAT=0 ; error status - assume nothing to report
"RTN","MAGT7S",113,0)
 D
"RTN","MAGT7S",114,0)
 . S ERRSTAT=$$NTESEGT^MAGT7SN(.SEGELTS,TEXT) Q:ERRSTAT
"RTN","MAGT7S",115,0)
 . I '$$ADDSEG^HLOAPI(.MSG,.SEGELTS,.ERRMSG) D  Q
"RTN","MAGT7S",116,0)
 . . S ERRSTAT="-2`HLO SEGMENT INSERTION ERROR ("_ERRMSG_")"
"RTN","MAGT7S",117,0)
 . . Q
"RTN","MAGT7S",118,0)
 . Q
"RTN","MAGT7S",119,0)
 Q ERRSTAT
"RTN","MAGT7SI")
0^22^B13457996
"RTN","MAGT7SI",1,0)
MAGT7SI ;WOIFO/MLH/PMK - telepathology - create HL7 message to DPS - segment build - IPC ;04 May 2017 10:40 AM
"RTN","MAGT7SI",2,0)
 ;;3.0;IMAGING;**138,183**;Mar 19, 2002;Build 11;Sep 03, 2013
"RTN","MAGT7SI",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGT7SI",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGT7SI",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGT7SI",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGT7SI",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGT7SI",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGT7SI",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGT7SI",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGT7SI",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGT7SI",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGT7SI",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGT7SI",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGT7SI",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGT7SI",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGT7SI",17,0)
 ;;
"RTN","MAGT7SI",18,0)
 ;
"RTN","MAGT7SI",19,0)
 ; Supported IA #4716 reference ^HLOAPI function calls
"RTN","MAGT7SI",20,0)
 ;
"RTN","MAGT7SI",21,0)
 Q
"RTN","MAGT7SI",22,0)
 ;
"RTN","MAGT7SI",23,0)
IPCSEG(SEGELTS,DFN,ACNUMB) ; FUNCTION - main entry point - create an IPC segment
"RTN","MAGT7SI",24,0)
 I $D(^MAGD(2006.15,1,"UID ROOT"))#10=0 Q "-1010`No study instance UID root on file"
"RTN","MAGT7SI",25,0)
 N STATNUMB ; station number
"RTN","MAGT7SI",26,0)
 N DIGIT ; 'digit' in station number
"RTN","MAGT7SI",27,0)
 N I ; scratch loop index
"RTN","MAGT7SI",28,0)
 N STUDYUID ; study instance UID
"RTN","MAGT7SI",29,0)
 N FLDACCID S FLDACCID=1 ; accession ID field number
"RTN","MAGT7SI",30,0)
 N FLDREQPROCID S FLDREQPROCID=2 ; requested procedure ID field number
"RTN","MAGT7SI",31,0)
 N FLDSTUDYUID S FLDSTUDYUID=3 ; study instance UID field number
"RTN","MAGT7SI",32,0)
 N FLDSPSID S FLDSPSID=4 ; scheduled procedure step ID field number
"RTN","MAGT7SI",33,0)
 N ERRSTAT S ERRSTAT=0 ; error status - assume nothing to report
"RTN","MAGT7SI",34,0)
 ;
"RTN","MAGT7SI",35,0)
 K SEGELTS ; always refresh *segment* array (not message array) on entry
"RTN","MAGT7SI",36,0)
 ;
"RTN","MAGT7SI",37,0)
 D SET^HLOAPI(.SEGELTS,"IPC",0) ; segment type
"RTN","MAGT7SI",38,0)
 D  ; set up fields, check exit flag after each
"RTN","MAGT7SI",39,0)
 . D  Q:ERRSTAT  ; IPC-1-accession identifier
"RTN","MAGT7SI",40,0)
 . . D SET^HLOAPI(.SEGELTS,ACNUMB,FLDACCID)
"RTN","MAGT7SI",41,0)
 . . Q
"RTN","MAGT7SI",42,0)
 . D  Q:ERRSTAT  ; IPC-2-requested procedure ID
"RTN","MAGT7SI",43,0)
 . . D SET^HLOAPI(.SEGELTS,ACNUMB,FLDREQPROCID)
"RTN","MAGT7SI",44,0)
 . . Q
"RTN","MAGT7SI",45,0)
 . D  Q:ERRSTAT  ; IPC-3-study instance UID
"RTN","MAGT7SI",46,0)
 . . S STUDYUID=$$UID^MAGT7SI(DFN,ACNUMB,"STUDY")
"RTN","MAGT7SI",47,0)
 . . D SET^HLOAPI(.SEGELTS,STUDYUID,FLDSTUDYUID)
"RTN","MAGT7SI",48,0)
 . . Q
"RTN","MAGT7SI",49,0)
 . D  Q:ERRSTAT  ; IPC-4-scheduled procedure step ID
"RTN","MAGT7SI",50,0)
 . . D SET^HLOAPI(.SEGELTS,ACNUMB,FLDSPSID)
"RTN","MAGT7SI",51,0)
 . . Q
"RTN","MAGT7SI",52,0)
 . Q
"RTN","MAGT7SI",53,0)
 ;
"RTN","MAGT7SI",54,0)
 Q ERRSTAT
"RTN","MAGT7SI",55,0)
 ;
"RTN","MAGT7SI",56,0)
UID(DFN,ACNUMB,TYPE,EXTENSION) ; generate a Study, Container, or Specimen UID
"RTN","MAGT7SI",57,0)
 ; DFN ------- file #2 patient identifier
"RTN","MAGT7SI",58,0)
 ; ACNUMB ---- accession number
"RTN","MAGT7SI",59,0)
 ; TYPE ------ "STUDY", "CONTAINER", or "SPECIMEN"
"RTN","MAGT7SI",60,0)
 ; EXTENSION - a number to add at the end
"RTN","MAGT7SI",61,0)
 ;
"RTN","MAGT7SI",62,0)
 N C,I,J,P,UID,UIDTYPE
"RTN","MAGT7SI",63,0)
 S DFN=$G(DFN) I 'DFN Q "-1, DFN value is wrong: """_DFN_""""
"RTN","MAGT7SI",64,0)
 S ACNUMB=$G(ACNUMB) I ACNUMB="" Q "-2, Accession Number is NULL"
"RTN","MAGT7SI",65,0)
 S TYPE=$G(TYPE)
"RTN","MAGT7SI",66,0)
 S UIDTYPE=$S(TYPE="STUDY":4,TYPE="CONTAINER":5,TYPE="SPECIMEN":6,1:-1)
"RTN","MAGT7SI",67,0)
 I UIDTYPE<0 Q "-3, Type is """_TYPE_""" It must be STUDY, CONTAINER, or SPECIMEN."
"RTN","MAGT7SI",68,0)
 S EXTENSION=$G(EXTENSION) ; optional
"RTN","MAGT7SI",69,0)
 S UID=^MAGD(2006.15,1,"UID ROOT")_".1."_UIDTYPE_"."_$$STATNUMB^MAGDFCNV()
"RTN","MAGT7SI",70,0)
 S UID=UID_"."_DFN
"RTN","MAGT7SI",71,0)
 F I=1:1:$L(ACNUMB," ") S P=$P(ACNUMB," ",I) D
"RTN","MAGT7SI",72,0)
 . S UID=UID_"."
"RTN","MAGT7SI",73,0)
 . I P?1N.N S UID=UID_P Q
"RTN","MAGT7SI",74,0)
 . ; convert non-numerics to ASCII equivalent
"RTN","MAGT7SI",75,0)
 . F J=1:1:$L(P) S UID=UID_$A($E(P,J))
"RTN","MAGT7SI",76,0)
 . Q
"RTN","MAGT7SI",77,0)
 I EXTENSION'="" S UID=UID_"."_EXTENSION
"RTN","MAGT7SI",78,0)
 Q UID
"RTN","MAGT7SP")
1^11
"RTN","MAGT7SV")
1^12
"RTN","MAGTP005")
0^23^B13949061
"RTN","MAGTP005",1,0)
MAGTP005 ;WOIFO/FG/PMK/DAC - TELEPATHOLOGY RPCS ;30 Jun 2017 10:18 AM
"RTN","MAGTP005",2,0)
 ;;3.0;IMAGING;**138,166,183**;Mar 19, 2002;Build 11;Sep 03, 2013
"RTN","MAGTP005",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGTP005",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGTP005",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGTP005",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGTP005",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGTP005",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGTP005",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGTP005",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGTP005",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGTP005",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGTP005",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGTP005",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGTP005",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGTP005",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGTP005",17,0)
 ;;
"RTN","MAGTP005",18,0)
 Q  ;
"RTN","MAGTP005",19,0)
 ;
"RTN","MAGTP005",20,0)
 ; +++++ ADD A NEW ENTRY IN FILE (#2005.42) WHEN
"RTN","MAGTP005",21,0)
 ;       GENERATING A NEW CASE FROM FILEMAN
"RTN","MAGTP005",22,0)
 ;
"RTN","MAGTP005",23,0)
 ; LRAC          Accession Code
"RTN","MAGTP005",24,0)
 ;
"RTN","MAGTP005",25,0)
ADD(LRAC) ;
"RTN","MAGTP005",26,0)
 Q:$$TELEPATH()'="YES"  ; only add studies if switch is enabled - P183 PMK 5/19/17
"RTN","MAGTP005",27,0)
 Q:'$$ISLRSSOK(LRSS)  ; check for supported anatomic pathology sections - P166 DAC localized AP check function
"RTN","MAGTP005",28,0)
 ;
"RTN","MAGTP005",29,0)
 N MAGFDA,MAGERR,NOW
"RTN","MAGTP005",30,0)
 S NOW=$$NOW^XLFDT
"RTN","MAGTP005",31,0)
 S MAGFDA(2005.42,"+1,",.01)=LRAC              ; Accession Number
"RTN","MAGTP005",32,0)
 S MAGFDA(2005.42,"+1,",.02)=0                 ; Priority (0:ROUTINE, 1:HIGH, 2:STAT)
"RTN","MAGTP005",33,0)
 S MAGFDA(2005.42,"+1,",.03)=0                 ; Slide available? (0:No, 1:Yes)
"RTN","MAGTP005",34,0)
 S MAGFDA(2005.42,"+1,",.04)=0                 ; Method (0:TRADITIONAL, 1:ROBOTICS, 2:WSI)
"RTN","MAGTP005",35,0)
 S MAGFDA(2005.42,"+1,",.05)="U"               ; Status (U:Unread, R:Read, C:Cancelled)
"RTN","MAGTP005",36,0)
 S MAGFDA(2005.42,"+1,",.06)=NOW               ; Start
"RTN","MAGTP005",37,0)
 S MAGFDA(2005.42,"+1,",.07)=NOW               ; Last Activity
"RTN","MAGTP005",38,0)
 S MAGFDA(2005.42,"+1,",.08)=0                 ; Number of Images
"RTN","MAGTP005",39,0)
 S MAGFDA(2005.42,"+1,",1)=0                   ; Reservation (0:Not Reserved, 1:Reserved)
"RTN","MAGTP005",40,0)
 S MAGFDA(2005.42,"+1,",2)=0                   ; Second  Lock (Accession) (0:Unlocked, 1:Locked)
"RTN","MAGTP005",41,0)
 D UPDATE^DIE("","MAGFDA","","MAGERR")
"RTN","MAGTP005",42,0)
 Q
"RTN","MAGTP005",43,0)
 ;
"RTN","MAGTP005",44,0)
STATUPDT(LRAC,STATUS) ; update the state of the case
"RTN","MAGTP005",45,0)
 N IENS,MAGFDA,MAGERR,NOW
"RTN","MAGTP005",46,0)
 ;
"RTN","MAGTP005",47,0)
 Q:$G(LRAC)=""  Q:$G(STATUS)=""
"RTN","MAGTP005",48,0)
 S STATUS=$E(STATUS) Q:"URC"'[STATUS
"RTN","MAGTP005",49,0)
 ;
"RTN","MAGTP005",50,0)
 S IENS=$O(^MAG(2005.42,"B",LRAC,"")) Q:'IENS
"RTN","MAGTP005",51,0)
 ;
"RTN","MAGTP005",52,0)
 ; update the entry
"RTN","MAGTP005",53,0)
 S IENS=IENS_","
"RTN","MAGTP005",54,0)
 S NOW=$$NOW^XLFDT
"RTN","MAGTP005",55,0)
 S MAGFDA(2005.42,IENS,.05)=STATUS            ; Status (U:Unread, R:Read)
"RTN","MAGTP005",56,0)
 S MAGFDA(2005.42,IENS,.07)=NOW               ; Last Activity
"RTN","MAGTP005",57,0)
 D UPDATE^DIE("","MAGFDA","","MAGERR")
"RTN","MAGTP005",58,0)
 Q
"RTN","MAGTP005",59,0)
 ;
"RTN","MAGTP005",60,0)
CANCEL(LRAC) ; case cancelled - remove it from the file
"RTN","MAGTP005",61,0)
 N DA,DIK,DA
"RTN","MAGTP005",62,0)
 ;
"RTN","MAGTP005",63,0)
 Q:$G(LRAC)=""
"RTN","MAGTP005",64,0)
 S DA=$O(^MAG(2005.42,"B",LRAC,"")) Q:'DA
"RTN","MAGTP005",65,0)
 ;
"RTN","MAGTP005",66,0)
 ; delete the entry
"RTN","MAGTP005",67,0)
 S DIK="^MAG(2005.42,"
"RTN","MAGTP005",68,0)
 D ^DIK
"RTN","MAGTP005",69,0)
 Q
"RTN","MAGTP005",70,0)
 ;
"RTN","MAGTP005",71,0)
IMAGECNT(LRAC,COUNT) ; update the number of images of the case
"RTN","MAGTP005",72,0)
 N IENS,MAGFDA,MAGERR,NOW,NIMAGES,TOTAL
"RTN","MAGTP005",73,0)
 ;
"RTN","MAGTP005",74,0)
 Q:$G(LRAC)=""
"RTN","MAGTP005",75,0)
 S COUNT=$G(COUNT,1)
"RTN","MAGTP005",76,0)
 ;
"RTN","MAGTP005",77,0)
 S IENS=$O(^MAG(2005.42,"B",LRAC,"")) Q:'IENS
"RTN","MAGTP005",78,0)
 S IENS=IENS_","
"RTN","MAGTP005",79,0)
 S NIMAGES=$$GET1^DIQ(2005.42,IENS,.08)
"RTN","MAGTP005",80,0)
 S TOTAL=NIMAGES+COUNT
"RTN","MAGTP005",81,0)
 ;
"RTN","MAGTP005",82,0)
 ; update the entry
"RTN","MAGTP005",83,0)
 S NOW=$$NOW^XLFDT
"RTN","MAGTP005",84,0)
 S MAGFDA(2005.42,IENS,.07)=NOW               ; Last Activity
"RTN","MAGTP005",85,0)
 S MAGFDA(2005.42,IENS,.08)=TOTAL             ; Number of Images
"RTN","MAGTP005",86,0)
 D UPDATE^DIE("","MAGFDA","","MAGERR")
"RTN","MAGTP005",87,0)
 Q
"RTN","MAGTP005",88,0)
 ;
"RTN","MAGTP005",89,0)
TELEPATH() ; P183 PMK 5/19/17 - Get value of ENABLE TELEPATH WORKLIST switch
"RTN","MAGTP005",90,0)
 N IENS
"RTN","MAGTP005",91,0)
 S IENS=$O(^MAG(2006.1,"B",DUZ(2),""))_","
"RTN","MAGTP005",92,0)
 Q $$GET1^DIQ(2006.1,IENS,205)
"RTN","MAGTP005",93,0)
 ;
"RTN","MAGTP005",94,0)
ISLRSSOK(LRSS) ; Check for supported anatomic pathology sections - P166 DAC moved AP check from MAGT7MA to MAGTP005
"RTN","MAGTP005",95,0)
 ; So far we support only  CY, EM, or SP
"RTN","MAGTP005",96,0)
 ; Return 1 - supported
"RTN","MAGTP005",97,0)
 ;        0 - not supported
"RTN","MAGTP005",98,0)
 Q LRSS?1(1"SP",1"CY",1"EM")
"VER")
8.0^22.2
"^DD",2006.1,2006.1,204,0)
SEND ANATOMIC PATHOLOGY HL7^S^NO:NO;YES:YES;^7;1^Q
"^DD",2006.1,2006.1,204,3)
Please enter YES to send the Anatomic Pathology HL7 messages to Digital Pathology Systems and the DICOM Gateway, or enter NO to disable sending them.
"^DD",2006.1,2006.1,204,21,0)
^.001^5^5^3170602^^^^
"^DD",2006.1,2006.1,204,21,1,0)
This field governs the sending of Anatomic Pathology HL7 messages.
"^DD",2006.1,2006.1,204,21,2,0)
These messages would be sent to Digital Pathology Systems and
"^DD",2006.1,2006.1,204,21,3,0)
other systems used in pathology.
"^DD",2006.1,2006.1,204,21,4,0)
 
"^DD",2006.1,2006.1,204,21,5,0)
Set this field to YES to send these HL7 messages.
"^DD",2006.1,2006.1,204,"DT")
3170602
"^DD",2006.1,2006.1,205,0)
ENABLE TELEPATH WORKLIST^S^NO:NO;YES:YES;^7;2^Q
"^DD",2006.1,2006.1,205,3)
Please enter YES to store new orders in the Telepathology Worklist file (MAG PATH CASELIST, file #2005.42), or enter NO to disable storing them.
"^DD",2006.1,2006.1,205,21,0)
^.001^4^4^3170601^^^^
"^DD",2006.1,2006.1,205,21,1,0)
This field controls the storage of new Anatomic Pathology cases in the
"^DD",2006.1,2006.1,205,21,2,0)
MAG PATH CASELIST file (#2005.42).
"^DD",2006.1,2006.1,205,21,3,0)
 
"^DD",2006.1,2006.1,205,21,4,0)
Set this field to YES to store new cases in this file.
"^DD",2006.1,2006.1,205,"DT")
3170601
**END**
**END**
