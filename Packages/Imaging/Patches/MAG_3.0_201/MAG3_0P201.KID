KIDS Distribution saved on Jan 22, 2019@18:59:41
VistA Imaging V3.0 Patch 201 - VIX Image Viewer 3.0 - 01/22/2019 06:59PM
**KIDS**:MAG*3.0*201^

**INSTALL NAME**
MAG*3.0*201
"BLD",3463,0)
MAG*3.0*201^IMAGING^0^3190122^y
"BLD",3463,1,0)
^^16^16^3190122
"BLD",3463,1,1,0)
VistA Imaging V3.0 Patch 201 - VIX Image Viewer 3.0
"BLD",3463,1,2,0)
 
"BLD",3463,1,3,0)
 
"BLD",3463,1,4,0)
Routines:
"BLD",3463,1,5,0)
MAGIP201    new value = 18271936
"BLD",3463,1,6,0)
MAGGSIA    new value = 36655133
"BLD",3463,1,7,0)
MAGGTIA1    new value = 34882923
"BLD",3463,1,8,0)
MAGJEX2    new value = 46640009
"BLD",3463,1,9,0)
MAGNUTL2    new value = 9894691
"BLD",3463,1,10,0)
MAGNWRK1    new value = 51777875
"BLD",3463,1,11,0)
MAGNAN01    new value = 23808502
"BLD",3463,1,12,0)
MAGVRS41    new value = 187565067
"BLD",3463,1,13,0)
MAGVD011    new value = 8804376
"BLD",3463,1,14,0)
 
"BLD",3463,1,15,0)
Please note that routine MAGIP201 is deleted after the KIDS Build is
"BLD",3463,1,16,0)
installed.
"BLD",3463,4,0)
^9.64PA^^0
"BLD",3463,6.3)
V3.0p201Build3463
"BLD",3463,"ABNS",0)
^9.66A^^
"BLD",3463,"ABPKG")
n^n^G.IMAGING DEVELOPMENT TEAM@AADOMAIN.EXT
"BLD",3463,"INI")
PRE^MAGIP201
"BLD",3463,"INID")
n^y^y
"BLD",3463,"INIT")
POS^MAGIP201
"BLD",3463,"KRN",0)
^9.67PA^8994^19
"BLD",3463,"KRN",.4,0)
.4
"BLD",3463,"KRN",.401,0)
.401
"BLD",3463,"KRN",.402,0)
.402
"BLD",3463,"KRN",.403,0)
.403
"BLD",3463,"KRN",.5,0)
.5
"BLD",3463,"KRN",.84,0)
.84
"BLD",3463,"KRN",3.6,0)
3.6
"BLD",3463,"KRN",3.8,0)
3.8
"BLD",3463,"KRN",9.2,0)
9.2
"BLD",3463,"KRN",9.8,0)
9.8
"BLD",3463,"KRN",9.8,"NM",0)
^9.68A^9^9
"BLD",3463,"KRN",9.8,"NM",1,0)
MAGIP201^^0^B18271936
"BLD",3463,"KRN",9.8,"NM",2,0)
MAGGSIA^^0^B36655133
"BLD",3463,"KRN",9.8,"NM",3,0)
MAGGTIA1^^0^B34882923
"BLD",3463,"KRN",9.8,"NM",4,0)
MAGJEX2^^0^B46640009
"BLD",3463,"KRN",9.8,"NM",5,0)
MAGNUTL2^^0^B9894691
"BLD",3463,"KRN",9.8,"NM",6,0)
MAGNWRK1^^0^B51777875
"BLD",3463,"KRN",9.8,"NM",7,0)
MAGNAN01^^0^B23808502
"BLD",3463,"KRN",9.8,"NM",8,0)
MAGVRS41^^0^B187565067
"BLD",3463,"KRN",9.8,"NM",9,0)
MAGVD011^^0^B8804376
"BLD",3463,"KRN",9.8,"NM","B","MAGIP201",1)

"BLD",3463,"KRN",9.8,"NM","B","MAGGSIA",2)

"BLD",3463,"KRN",9.8,"NM","B","MAGGTIA1",3)

"BLD",3463,"KRN",9.8,"NM","B","MAGJEX2",4)

"BLD",3463,"KRN",9.8,"NM","B","MAGNUTL2",5)

"BLD",3463,"KRN",9.8,"NM","B","MAGNWRK1",6)

"BLD",3463,"KRN",9.8,"NM","B","MAGNAN01",7)

"BLD",3463,"KRN",9.8,"NM","B","MAGVRS41",8)

"BLD",3463,"KRN",9.8,"NM","B","MAGVD011",9)

"BLD",3463,"KRN",19,0)
19
"BLD",3463,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",3463,"KRN",19,"NM",1,0)
MAG WORK ITEMS DELETE^^0
"BLD",3463,"KRN",19,"NM","B","MAG WORK ITEMS DELETE",1)

"BLD",3463,"KRN",19.1,0)
19.1
"BLD",3463,"KRN",101,0)
101
"BLD",3463,"KRN",101,"NM",0)
^9.68A^1^1
"BLD",3463,"KRN",101,"NM",1,0)
MAG PRECACHE^^0
"BLD",3463,"KRN",101,"NM","B","MAG PRECACHE",1)

"BLD",3463,"KRN",409.61,0)
409.61
"BLD",3463,"KRN",771,0)
771
"BLD",3463,"KRN",771,"NM",0)
^9.68A^1^1
"BLD",3463,"KRN",771,"NM",1,0)
MAG PRECACHE CLIENT^^0
"BLD",3463,"KRN",771,"NM","B","MAG PRECACHE CLIENT",1)

"BLD",3463,"KRN",870,0)
870
"BLD",3463,"KRN",8989.51,0)
8989.51
"BLD",3463,"KRN",8989.51,"NM",0)
^9.68A^2^2
"BLD",3463,"KRN",8989.51,"NM",1,0)
MAG PRECACHE ACQ ENABLED^^1
"BLD",3463,"KRN",8989.51,"NM",2,0)
MAG PRECACHE RAD REG ENABLED^^1
"BLD",3463,"KRN",8989.51,"NM","B","MAG PRECACHE ACQ ENABLED",1)

"BLD",3463,"KRN",8989.51,"NM","B","MAG PRECACHE RAD REG ENABLED",2)

"BLD",3463,"KRN",8989.52,0)
8989.52
"BLD",3463,"KRN",8994,0)
8994
"BLD",3463,"KRN","B",.4,.4)

"BLD",3463,"KRN","B",.401,.401)

"BLD",3463,"KRN","B",.402,.402)

"BLD",3463,"KRN","B",.403,.403)

"BLD",3463,"KRN","B",.5,.5)

"BLD",3463,"KRN","B",.84,.84)

"BLD",3463,"KRN","B",3.6,3.6)

"BLD",3463,"KRN","B",3.8,3.8)

"BLD",3463,"KRN","B",9.2,9.2)

"BLD",3463,"KRN","B",9.8,9.8)

"BLD",3463,"KRN","B",19,19)

"BLD",3463,"KRN","B",19.1,19.1)

"BLD",3463,"KRN","B",101,101)

"BLD",3463,"KRN","B",409.61,409.61)

"BLD",3463,"KRN","B",771,771)

"BLD",3463,"KRN","B",870,870)

"BLD",3463,"KRN","B",8989.51,8989.51)

"BLD",3463,"KRN","B",8989.52,8989.52)

"BLD",3463,"KRN","B",8994,8994)

"BLD",3463,"REQB",0)
^9.611^3^3
"BLD",3463,"REQB",1,0)
MAG*3.0*118^2
"BLD",3463,"REQB",2,0)
MAG*3.0*120^2
"BLD",3463,"REQB",3,0)
MAG*3.0*197^2
"BLD",3463,"REQB","B","MAG*3.0*118",1)

"BLD",3463,"REQB","B","MAG*3.0*120",2)

"BLD",3463,"REQB","B","MAG*3.0*197",3)

"INI")
PRE^MAGIP201
"INIT")
POS^MAGIP201
"KRN",19,123457,-1)
0^1
"KRN",19,123457,0)
MAG WORK ITEMS DELETE^Delete work items^^R^^^^^^^^IMAGING
"KRN",19,123457,1,0)
^19.06^2^2^3120510^^^^
"KRN",19,123457,1,1,0)
Delete work items in date range by
"KRN",19,123457,1,2,0)
work item type and subtype.
"KRN",19,123457,10.1)

"KRN",19,123457,25)
DELWIDTS^MAGVD011
"KRN",19,123457,200.9)
^y
"KRN",19,123457,"U")
MAG WORK ITEMS DELETE
"KRN",101,123458,-1)
0^1
"KRN",101,123458,0)
MAG PRECACHE^Client for pre-caching images^^S^^^^^^^^
"KRN",101,123458,1,0)
^101.06^1^1^3020103^^^^
"KRN",101,123458,1,1,0)
This protocol will initiate image precache for radiology exams.
"KRN",101,123458,2,0)
^101.02A^1^1
"KRN",101,123458,2,1,0)
MAG PRECACHE
"KRN",101,123458,2,"B","MAG PRECACHE",1)

"KRN",101,123458,20)

"KRN",101,123458,99)
62303,43886
"KRN",101,123458,770)
^MAG PRECACHE CLIENT^ORM^O01^^P^^^^2.1^ACK
"KRN",101,123458,771)
D PRECACHE^MAGNUTL2
"KRN",101,123458,773)
0^0^0^1
"KRN",771,123459,-1)
0^1
"KRN",771,123459,0)
MAG PRECACHE CLIENT^a^WCIOFO^^^^USA
"KRN",771,123459,"EC")

"KRN",771,123459,"FS")

"KRN",771,123459,"MSG",0)
^771.06P^^0
"KRN",771,123459,"SEG",0)
^771.05P^^0
"KRN",8989.51,123460,-1)
1^1
"KRN",8989.51,123460,0)
MAG PRECACHE ACQ ENABLED
"KRN",8989.51,123461,-1)
1^2
"KRN",8989.51,123461,0)
MAG PRECACHE RAD REG ENABLED
"MBREQ")
0
"ORD",14,771)
771;14;;;HLAP^XPDTA1;HLAPF1^XPDIA1;HLAPE1^XPDIA1;HLAPF2^XPDIA1;;HLAPDEL^XPDIA1(%)
"ORD",14,771,0)
HL7 APPLICATION PARAMETER
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"ORD",20,8989.51)
8989.51;20;;;PAR1E1^XPDTA2;PAR1F1^XPDIA3;PAR1E1^XPDIA3;PAR1F2^XPDIA3;;PAR1DEL^XPDIA3(%)
"ORD",20,8989.51,0)
PARAMETER DEFINITION
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging Release History
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020328^3020328^.5
"PKG",454,22,1,"PAH",1,0)
201^3190122^.5
"PKG",454,22,1,"PAH",1,1,0)
^9.49011^15^15^3190122
"PKG",454,22,1,"PAH",1,1,1,0)
Routines for Patch 201
"PKG",454,22,1,"PAH",1,1,2,0)
 
"PKG",454,22,1,"PAH",1,1,3,0)
Routines:
"PKG",454,22,1,"PAH",1,1,4,0)
MAGIP201    value = 18271936
"PKG",454,22,1,"PAH",1,1,5,0)
MAGGSIA    value = 36655133
"PKG",454,22,1,"PAH",1,1,6,0)
MAGGTIA1    value = 34882923
"PKG",454,22,1,"PAH",1,1,7,0)
MAGJEX2    value = 46640009
"PKG",454,22,1,"PAH",1,1,8,0)
MAGNUTL2    value = 9894691
"PKG",454,22,1,"PAH",1,1,9,0)
MAGNWRK1    value = 51777875
"PKG",454,22,1,"PAH",1,1,10,0)
MAGNAN01    value = 23808502
"PKG",454,22,1,"PAH",1,1,11,0)
MAGVRS41    value = 187565067
"PKG",454,22,1,"PAH",1,1,12,0)
MAGVD011    value = 8804376
"PKG",454,22,1,"PAH",1,1,13,0)
 
"PKG",454,22,1,"PAH",1,1,14,0)
Please note that routine MAGIP201 is deleted after the KIDS Build is
"PKG",454,22,1,"PAH",1,1,15,0)
installed.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
9
"RTN","MAGIP201")
0^1^B18271936
"RTN","MAGIP201",1,0)
MAGIP201 ;WOIFO/NST - Install code for MAG*3.0*201 ; Jan 22, 2019@09:15 AM
"RTN","MAGIP201",2,0)
 ;;3.0;IMAGING;**201**;Mar 19, 2002;Build 2461;Jan 18, 2012
"RTN","MAGIP201",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIP201",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP201",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIP201",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIP201",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIP201",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIP201",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIP201",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIP201",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIP201",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIP201",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIP201",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIP201",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIP201",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP201",17,0)
 ;;
"RTN","MAGIP201",18,0)
 ; There are no environment checks here but the MAGIP201 has to be
"RTN","MAGIP201",19,0)
 ; referenced by the "Environment Check Routine" field of the KIDS
"RTN","MAGIP201",20,0)
 ; build so that entry points of the routine are available to the
"RTN","MAGIP201",21,0)
 ; KIDS during all installation phases.
"RTN","MAGIP201",22,0)
 Q
"RTN","MAGIP201",23,0)
 ;
"RTN","MAGIP201",24,0)
 ;+++++ INSTALLATION ERROR HANDLING
"RTN","MAGIP201",25,0)
ERROR ;
"RTN","MAGIP201",26,0)
 S:$D(XPDNM) XPDABORT=1
"RTN","MAGIP201",27,0)
 ;--- Display the messages and store them to the INSTALL file
"RTN","MAGIP201",28,0)
 D DUMP^MAGUERR1(),ABTMSG^MAGKIDS()
"RTN","MAGIP201",29,0)
 Q
"RTN","MAGIP201",30,0)
 ;
"RTN","MAGIP201",31,0)
 ;***** POST-INSTALL CODE
"RTN","MAGIP201",32,0)
POS ;
"RTN","MAGIP201",33,0)
 N CALLBACK
"RTN","MAGIP201",34,0)
 D CLEAR^MAGUERR(1)
"RTN","MAGIP201",35,0)
 ;
"RTN","MAGIP201",36,0)
 D UPDATE()
"RTN","MAGIP201",37,0)
 ;
"RTN","MAGIP201",38,0)
 ;--- Send the notification e-mail
"RTN","MAGIP201",39,0)
 D BMES^XPDUTL("Post Install Mail Message: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","MAGIP201",40,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGIP201",41,0)
 Q
"RTN","MAGIP201",42,0)
 ;
"RTN","MAGIP201",43,0)
 ;***** PRE-INSTALL CODE
"RTN","MAGIP201",44,0)
PRE ;
"RTN","MAGIP201",45,0)
 Q
"RTN","MAGIP201",46,0)
 ;
"RTN","MAGIP201",47,0)
 ;+++++ Various updates
"RTN","MAGIP201",48,0)
UPDATE() ;
"RTN","MAGIP201",49,0)
 N ANSERV,I,ITEM,MAGFDA,MAGERR,MAGIENS,MSG,IEN1,IEN2,IENS
"RTN","MAGIP201",50,0)
 ;
"RTN","MAGIP201",51,0)
 ; Add "PRECACHE" to WORKLIST file (#2006.9412)
"RTN","MAGIP201",52,0)
 K MAGFDA,MAGERR
"RTN","MAGIP201",53,0)
 S ITEM="PRECACHE"
"RTN","MAGIP201",54,0)
 I '$O(^MAGV(2006.9412,"B",ITEM,0)) D
"RTN","MAGIP201",55,0)
 . S MAGFDA(2006.9412,"+1,",.01)=ITEM
"RTN","MAGIP201",56,0)
 . S MAGFDA(2006.9412,"+1,",1)=1 ;ACTIVE
"RTN","MAGIP201",57,0)
 . D UPDATE^DIE("","MAGFDA","","MAGERR")
"RTN","MAGIP201",58,0)
 . Q
"RTN","MAGIP201",59,0)
 I $D(MAGERR) S MSG(1)=MAGERR("DIERR",1,"TEXT",1) D BMES^MAGKIDS("Error in Updating: ",.MSG) ;ERROR
"RTN","MAGIP201",60,0)
 ;
"RTN","MAGIP201",61,0)
 ; Add "ACQUISITION", "REGISTRATION" and "REMOTEPRIOR" to MAG WORK ITEM SUBTYPE file (#2006.9414)
"RTN","MAGIP201",62,0)
 ;
"RTN","MAGIP201",63,0)
 K MAGFDA,MAGERR
"RTN","MAGIP201",64,0)
 F ITEM="ACQUISITION","REGISTRATION","REMOTEPRIOR" D
"RTN","MAGIP201",65,0)
 . I '$O(^MAGV(2006.9414,"B",ITEM,0)) D
"RTN","MAGIP201",66,0)
 . . S MAGFDA(2006.9414,"+1,",.01)=ITEM
"RTN","MAGIP201",67,0)
 . . D UPDATE^DIE("","MAGFDA","","MAGERR")
"RTN","MAGIP201",68,0)
 . . Q
"RTN","MAGIP201",69,0)
 . I $D(MAGERR) S MSG(1)=MAGERR("DIERR",1,"TEXT",1) D BMES^MAGKIDS("Error in Updating: ",.MSG)  ;ERROR
"RTN","MAGIP201",70,0)
 . Q
"RTN","MAGIP201",71,0)
 ;
"RTN","MAGIP201",72,0)
 ; Add MAG PRECACHE as a subscriber of RA REG
"RTN","MAGIP201",73,0)
 ;
"RTN","MAGIP201",74,0)
 K MAGFDA
"RTN","MAGIP201",75,0)
 S IEN1=$$FIND1^DIC(101,"","BX","RA REG") ; Get [RA REG] IEN
"RTN","MAGIP201",76,0)
 I 'IEN1 D  Q
"RTN","MAGIP201",77,0)
 . S MSG(1)="RA REG protocol not found"
"RTN","MAGIP201",78,0)
 . D BMES^MAGKIDS("Error in Updating: ",.MSG)
"RTN","MAGIP201",79,0)
 . Q
"RTN","MAGIP201",80,0)
 ;
"RTN","MAGIP201",81,0)
 S IEN2=$$FIND1^DIC(101,"","BX","MAG PRECACHE") ; Get [MAG PRECACHE] IEN
"RTN","MAGIP201",82,0)
 I 'IEN2 D  Q
"RTN","MAGIP201",83,0)
 . S MSG(1)="MAG PRECACHE protocol not found"
"RTN","MAGIP201",84,0)
 . D BMES^MAGKIDS("Error in Updating: ",.MSG)
"RTN","MAGIP201",85,0)
 . Q
"RTN","MAGIP201",86,0)
 ;
"RTN","MAGIP201",87,0)
 S IENS="?+1,"_IEN1_","
"RTN","MAGIP201",88,0)
 S MAGFDA(101.0775,IENS,.01)=IEN2
"RTN","MAGIP201",89,0)
 D UPDATE^DIE("","MAGFDA","MAGIENS","MAGERR")
"RTN","MAGIP201",90,0)
 I $D(DIERR) D  Q
"RTN","MAGIP201",91,0)
 . D MES^MAGKIDS("Error in updating event driver protocol [RA REG].")
"RTN","MAGIP201",92,0)
 . F I=1:1 Q:'$D(MAGERR("DIERR",1,"TEXT",I))  D
"RTN","MAGIP201",93,0)
 . . D MES^MAGKIDS(MAGERR("DIERR",1,"TEXT",I))
"RTN","MAGIP201",94,0)
 . . Q
"RTN","MAGIP201",95,0)
 . Q
"RTN","MAGIP201",96,0)
 ;
"RTN","MAGIP201",97,0)
 ; **** Convert external Annotation service value to internal value
"RTN","MAGIP201",98,0)
 S IEN1=0
"RTN","MAGIP201",99,0)
 F  S IEN1=$O(^MAG(2005.003,IEN1)) Q:'IEN1  D
"RTN","MAGIP201",100,0)
 . S IEN2=0
"RTN","MAGIP201",101,0)
 . F  S IEN2=$O(^MAG(2005.003,IEN1,1,IEN2)) Q:'IEN2  D
"RTN","MAGIP201",102,0)
 . . S ANSERV=$P($G(^MAG(2005.003,IEN1,1,IEN2,0)),"^",7)
"RTN","MAGIP201",103,0)
 . . Q:(ANSERV>0)!(ANSERV="")
"RTN","MAGIP201",104,0)
 . . N X,DIC S DIC=49,DIC(0)="B",X=ANSERV D ^DIC S ANSERV=$S(+Y:+Y,1:"") ;SERVICE/SECTION
"RTN","MAGIP201",105,0)
 . . K MAGFDA,MAGIENS,MAGERR
"RTN","MAGIP201",106,0)
 . . S IENS=IEN2_","_IEN1_","
"RTN","MAGIP201",107,0)
 . . S MAGIENS(1)=IEN1
"RTN","MAGIP201",108,0)
 . . S MAGIENS(2)=IEN2
"RTN","MAGIP201",109,0)
 . . S MAGFDA(2005.0031,IENS,7)=ANSERV     ;SERVICE/SECTION
"RTN","MAGIP201",110,0)
 . . D UPDATE^DIE("","MAGFDA","MAGIENS","MAGERR")
"RTN","MAGIP201",111,0)
 . . I $D(MAGERR) D
"RTN","MAGIP201",112,0)
 . . . D MES^MAGKIDS("Error in updating event driver protocol [RA REG].")
"RTN","MAGIP201",113,0)
 . . . F I=1:1 Q:'$D(MAGERR("DIERR",1,"TEXT",I))  D
"RTN","MAGIP201",114,0)
 . . . . D MES^MAGKIDS(MAGERR("DIERR",1,"TEXT",I))
"RTN","MAGIP201",115,0)
 . . . . Q
"RTN","MAGIP201",116,0)
 . . . Q
"RTN","MAGIP201",117,0)
 . . Q
"RTN","MAGIP201",118,0)
 . Q
"RTN","MAGIP201",119,0)
 Q
"RTN","MAGGSIA")
0^2^B36655133
"RTN","MAGGSIA",1,0)
MAGGSIA ;WOIFO/GEK/SG/NST - Imaging RPC Broker calls. Add/Modify Image entry ; OCT 23, 2018@10:43am
"RTN","MAGGSIA",2,0)
 ;;3.0;IMAGING;**7,21,8,59,93,201**;Dec 02, 2009;Build 163
"RTN","MAGGSIA",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGSIA",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIA",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSIA",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSIA",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSIA",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSIA",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSIA",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSIA",11,0)
 ;; |                                                               |
"RTN","MAGGSIA",12,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSIA",13,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGSIA",14,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGSIA",15,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGSIA",16,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGSIA",17,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIA",18,0)
 ;;
"RTN","MAGGSIA",19,0)
 Q
"RTN","MAGGSIA",20,0)
 ;
"RTN","MAGGSIA",21,0)
 ;**** CALLING ROUTINE is responsible for RENAMING THE IMAGE FILE
"RTN","MAGGSIA",22,0)
 ;**** on DISK TO THE NEW FILE NAME RETURNED BY THIS CALL.
"RTN","MAGGSIA",23,0)
 ;
"RTN","MAGGSIA",24,0)
ADD(MAGRY,MAGARRAY) ; RPC [MAG4 ADD IMAGE]
"RTN","MAGGSIA",25,0)
 ; Calls UPDATE^DIE to Add an Image File entry
"RTN","MAGGSIA",26,0)
 ;  Called from Import API Delphi component and ImportX (Active X) control.
"RTN","MAGGSIA",27,0)
 ;  Parameters : 
"RTN","MAGGSIA",28,0)
 ;    MAGARRAY -  array of field numbers and their entries
"RTN","MAGGSIA",29,0)
 ;             i.e. MAGARRAY(1)=".5^38"  field# .5   data is 38
"RTN","MAGGSIA",30,0)
 ;    If Long Description is included in array (field 11), we create a new
"RTN","MAGGSIA",31,0)
 ;      array to hold the text, and pass that to UPDATE^DIE
"RTN","MAGGSIA",32,0)
 ;    If this entry is an Image Group
"RTN","MAGGSIA",33,0)
 ;      i.e. MAGARRAY(n)="2005.04^344"
"RTN","MAGGSIA",34,0)
 ;      (the field 2005.04 is the OBJECT GROUP MULTIPLE)
"RTN","MAGGSIA",35,0)
 ;      ( 344 is the pointer to the Image File Entry that will be added
"RTN","MAGGSIA",36,0)
 ;      ( as a member of this new/existing Group)
"RTN","MAGGSIA",37,0)
 ;
"RTN","MAGGSIA",38,0)
 ;  Return Variable
"RTN","MAGGSIA",39,0)
 ;
"RTN","MAGGSIA",40,0)
 ;    MAGRY(0) - Array
"RTN","MAGGSIA",41,0)
 ;      Successful   MAGRY(0) = IEN^FILE NAME (with full path)
"RTN","MAGGSIA",42,0)
 ;      UNsuccessful MAGRY(0) = 0^Error desc
"RTN","MAGGSIA",43,0)
 ;                   MAGRY(0)(1..n) = Errors and warnings. 
"RTN","MAGGSIA",44,0)
 ;
"RTN","MAGGSIA",45,0)
 ;    CALLING ROUTINE is responsible for RENAMING THE IMAGE FILE on DISK
"RTN","MAGGSIA",46,0)
 ;      TO THE NEW FILE NAME RETURNED BY THIS CALL.
"RTN","MAGGSIA",47,0)
 ;      Changed to include hierarchical directory hash  - PMK 04/23/98
"RTN","MAGGSIA",48,0)
 ;----------------------------------------------------------------
"RTN","MAGGSIA",49,0)
 N MAGGFDA,MAGGDRV,MAGGRP,MAGCHLD,GRPCT,MAGGDA,MAGGFNM
"RTN","MAGGSIA",50,0)
 N MAGGWP,MAGERR,MAGREF,MAGDHASH,MAGTEMP,MAGACT,MAGGIEN,MAGGXE
"RTN","MAGGSIA",51,0)
 N NEWIEN,I,J,X,Y,Z,WPCT
"RTN","MAGGSIA",52,0)
 ;
"RTN","MAGGSIA",53,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERRA^MAGGSERR"
"RTN","MAGGSIA",54,0)
 I ($D(MAGARRAY)<10) S MAGRY(0)="0^No input data, Operation CANCELED" Q
"RTN","MAGGSIA",55,0)
 ;
"RTN","MAGGSIA",56,0)
 S MAGRY(0)="0^Creating VistA Image Entry..."
"RTN","MAGGSIA",57,0)
 S MAGERR="",MAGGRP=0,GRPCT=1,WPCT=0
"RTN","MAGGSIA",58,0)
 ;  Validate the Data, and Action codes in the Input Array
"RTN","MAGGSIA",59,0)
 D VAL^MAGGSIV(.MAGRY,.MAGARRAY) I 'MAGRY(0) Q
"RTN","MAGGSIA",60,0)
 ;
"RTN","MAGGSIA",61,0)
 ;  Make the FileMan FDA array and the Imaging Action array.
"RTN","MAGGSIA",62,0)
 D MAKEFDA^MAGGSIU2(.MAGGFDA,.MAGARRAY,.MAGACT,.MAGCHLD,.MAGGRP,.MAGGWP)
"RTN","MAGGSIA",63,0)
 I '$D(MAGGFDA(2005,"+1,")) S MAGRY(0)="0^No data to file.  Operation CANCELED." Q
"RTN","MAGGSIA",64,0)
 ;
"RTN","MAGGSIA",65,0)
 ;Q:'$$VALINDEX^MAGGSIV1(.MAGRY,$G(MAGGFDA(2005,"+1,",42)),$G(MAGGFDA(2005,"+1,",44)),$G(MAGGFDA(2005,"+1,",43)))
"RTN","MAGGSIA",66,0)
 ;  Check on some possible problems: required fields, create default values etc.
"RTN","MAGGSIA",67,0)
 D PRE^MAGGSIA1(.MAGERR,.MAGGFDA,MAGGRP,.MAGGDRV,.MAGREF) I $L(MAGERR) S MAGRY(0)=MAGERR Q
"RTN","MAGGSIA",68,0)
 ; Locking Patch 8. Get latest Image IEN and Deleted IEN take the greater of the two.
"RTN","MAGGSIA",69,0)
 S (MAGGIEN(1),NEWIEN)=$$NEWIEN^MAGGI12()  ; SG - MAG*3*93
"RTN","MAGGSIA",70,0)
 D UPDATE^DIE("S","MAGGFDA","MAGGIEN","MAGGXE")
"RTN","MAGGSIA",71,0)
 ;
"RTN","MAGGSIA",72,0)
 ;  ERROR: QUIT
"RTN","MAGGSIA",73,0)
 I '$G(MAGGIEN(1)) D  S MAGRY(0)=MAGERR Q
"RTN","MAGGSIA",74,0)
 . S MAGERR="0^ERROR Creating new Image File Entry "
"RTN","MAGGSIA",75,0)
 . I $D(DIERR) D RTRNERR^MAGGSIU1(.MAGERR)
"RTN","MAGGSIA",76,0)
 . D CLEAN
"RTN","MAGGSIA",77,0)
 ;
"RTN","MAGGSIA",78,0)
 S MAGGDA=MAGGIEN(1)
"RTN","MAGGSIA",79,0)
 ;
"RTN","MAGGSIA",80,0)
 D ACTION^MAGGTAU("CAP^"_MAGGFDA(2005,"+1,",5)_"^"_MAGGDA)
"RTN","MAGGSIA",81,0)
 ;
"RTN","MAGGSIA",82,0)
 ; IF a group, UpDate the GROUP PARENT in each Group Object and QUIT
"RTN","MAGGSIA",83,0)
 ;  The Return (MAGRY(0)) will be IEN with NO Filename. Groups don't get Filename
"RTN","MAGGSIA",84,0)
 I MAGGRP D  G C1
"RTN","MAGGSIA",85,0)
 . D UPDCHLD^MAGGSIM(.MAGCHLD,MAGGDA)
"RTN","MAGGSIA",86,0)
 . S MAGRY(0)=MAGGDA_U
"RTN","MAGGSIA",87,0)
 . D CLEAN
"RTN","MAGGSIA",88,0)
 . Q
"RTN","MAGGSIA",89,0)
 ; ENTRY in Image File has been made, if any errors from here on
"RTN","MAGGSIA",90,0)
 ;  then we have to delete the image entry.
"RTN","MAGGSIA",91,0)
 ;  IF This image is a member of a Group, Update the Group Entry with new child.
"RTN","MAGGSIA",92,0)
 S X=$G(MAGGFDA(2005,"+1,",14)) I +X D  I $L(MAGERR) Q
"RTN","MAGGSIA",93,0)
 . D UPDPAR^MAGGSIM(.MAGERR,X,.MAGACT,MAGGDA)
"RTN","MAGGSIA",94,0)
 . I $L(MAGERR) S MAGRY(0)=MAGERR D CLEAN
"RTN","MAGGSIA",95,0)
 ;
"RTN","MAGGSIA",96,0)
 ; Now generate the Image FileName. This is passed back to the calling app, 
"RTN","MAGGSIA",97,0)
 ;  and the calling app is responsible for renaming/copying the Image File to
"RTN","MAGGSIA",98,0)
 ;  this new name. 
"RTN","MAGGSIA",99,0)
 I $D(MAGGFDA(2005,"+1,",1)) S MAGGFNM=MAGGFDA(2005,"+1,",1)
"RTN","MAGGSIA",100,0)
 E  D  I $L(MAGERR) S MAGRY(0)=MAGERR Q
"RTN","MAGGSIA",101,0)
 . N MAGXFDA
"RTN","MAGGSIA",102,0)
 . S X=$$DA2NAME^MAGGTU1(MAGGDA,$G(MAGACT("EXT"))) I 'X D  Q
"RTN","MAGGSIA",103,0)
 . . S MAGERR=X
"RTN","MAGGSIA",104,0)
 . . D KILLENT^MAGGSIU1(MAGGDA)
"RTN","MAGGSIA",105,0)
 . . D CLEAN
"RTN","MAGGSIA",106,0)
 . ;
"RTN","MAGGSIA",107,0)
 . S MAGGFNM=$P(X,U,2),Y=MAGGDA_","
"RTN","MAGGSIA",108,0)
 . S MAGXFDA(2005,Y,1)=MAGGFNM
"RTN","MAGGSIA",109,0)
 . D UPDATE^DIE("","MAGXFDA","","MAGGXE")
"RTN","MAGGSIA",110,0)
 . ;   in case of an error
"RTN","MAGGSIA",111,0)
 . I $D(DIERR) D  Q
"RTN","MAGGSIA",112,0)
 . . D RTRNERR^MAGGSIU1(.MAGERR,.MAGGXE)
"RTN","MAGGSIA",113,0)
 . . D KILLENT^MAGGSIU1(MAGGDA)
"RTN","MAGGSIA",114,0)
 . . D CLEAN
"RTN","MAGGSIA",115,0)
 ;
"RTN","MAGGSIA",116,0)
C1 ; 59 
"RTN","MAGGSIA",117,0)
 K MAGGFDA ; P59.
"RTN","MAGGSIA",118,0)
 ;P59 Now we Auto-Generate the Index Fields, if they don't exist for this entry
"RTN","MAGGSIA",119,0)
 I '$D(^MAG(2005,MAGGDA,40)) D
"RTN","MAGGSIA",120,0)
 . N INDXD
"RTN","MAGGSIA",121,0)
 . D GENIEN^MAGXCVI(MAGGDA,.INDXD)
"RTN","MAGGSIA",122,0)
 . D COMIEN^MAGXCVC(MAGGDA,.INDXD)
"RTN","MAGGSIA",123,0)
 . S ^MAGIXCVT(2006.96,MAGGDA)=1 ; Flag. Says fields were converted by index generation
"RTN","MAGGSIA",124,0)
 . ; TRKING ID  TRKID =   MAGGFDA(2005,"+1,",108)
"RTN","MAGGSIA",125,0)
 . ;;D ACTION^MAGGTAU("GENINDX^"_MAGGFDA(2005,"+1,",5)_"^"_MAGGDA_"$$"_MAGGFDA(2005,"+1,",108))
"RTN","MAGGSIA",126,0)
 . D ACTION^MAGGTAU("INDEX-ALL^"_$P(^MAG(2005,MAGGDA,0),"^",7)_"^"_MAGGDA_"$$"_$P(^MAG(2005,MAGGDA,100),"^",5))
"RTN","MAGGSIA",127,0)
 . Q
"RTN","MAGGSIA",128,0)
 ;
"RTN","MAGGSIA",129,0)
 ;P59 If TYPE INDEX is missing we Auto-Generate Index Type and other missing Index Term values.
"RTN","MAGGSIA",130,0)
 I '$P(^MAG(2005,MAGGDA,40),"^",3) D
"RTN","MAGGSIA",131,0)
 . N INDXD,OLD40,N40
"RTN","MAGGSIA",132,0)
 . S (N40,OLD40)=^MAG(2005,MAGGDA,40)
"RTN","MAGGSIA",133,0)
 . D GENIEN^MAGXCVI(MAGGDA,.INDXD)
"RTN","MAGGSIA",134,0)
 . ; If Origin doesn't exist in existing, this will put V in. 
"RTN","MAGGSIA",135,0)
 . I $P(INDXD,"^",6)="" S $P(INDXD,"^",6)="V"
"RTN","MAGGSIA",136,0)
 . ; We're not changing existing values of Spec,Proc or Origin 
"RTN","MAGGSIA",137,0)
 . F J=1:1:6 I '$L($P(N40,"^",J)) S $P(N40,"^",J)=$P(INDXD,"^",J)
"RTN","MAGGSIA",138,0)
 . ;Validate the merged Spec and Proc, if  not valid, revert back to old Spec and Proc
"RTN","MAGGSIA",139,0)
 . I '$$VALINDEX^MAGGSIV1(.X,$P(N40,"^",3),$P(N40,"^",5),$P(N40,"^",4)) S $P(N40,"^",4,5)=$P(OLD40,"^",4,5)
"RTN","MAGGSIA",140,0)
 . S ^MAG(2005,MAGGDA,40)=N40
"RTN","MAGGSIA",141,0)
 . ;;D ACTION^MAGGTAU("INDEX-42^"_$P(^MAG(2005,MAGGDA,0),"^",7)_"^"_MAGGDA) ;_"$$"_MAGGFDA(2005,"+1,",108))
"RTN","MAGGSIA",142,0)
 . D ACTION^MAGGTAU("INDEX-42^"_$P(^MAG(2005,MAGGDA,0),"^",7)_"^"_MAGGDA_"$$"_$P(^MAG(2005,MAGGDA,100),"^",5))
"RTN","MAGGSIA",143,0)
 . D ENTRY^MAGLOG("INDEX-42",DUZ,MAGGDA,"P59",$P(^MAG(2005,MAGGDA,0),"^",7),1)
"RTN","MAGGSIA",144,0)
 . Q
"RTN","MAGGSIA",145,0)
 ;** ABS and JB image queues AREN'T SET WHEN ADDING AN IMAGE. 
"RTN","MAGGSIA",146,0)
 ;** RPC =-> 'MAG ABSJB' after abstract is/isn't created on the workstation
"RTN","MAGGSIA",147,0)
 ;
"RTN","MAGGSIA",148,0)
 ;  The Return is:  IEN ^ DRIVE:DIR ^ FILE.EXT [^ DRIVE:DIR ^ FILE.BIG]
"RTN","MAGGSIA",149,0)
 ;   example:  487^C:\IMAGE\^DC000487.TIF
"RTN","MAGGSIA",150,0)
 ;  The calling routine is responsible for renaming/naming the file
"RTN","MAGGSIA",151,0)
 ;   to the returned DRIVE:\DIR\FILENAME.EXT
"RTN","MAGGSIA",152,0)
 ;
"RTN","MAGGSIA",153,0)
 ; Modified 4/23/98 to include hierarchical directory structure -- PMK
"RTN","MAGGSIA",154,0)
 I 'MAGGRP D
"RTN","MAGGSIA",155,0)
 . S MAGDHASH=$$DIRHASH^MAGFILEB(MAGGFNM,MAGREF)
"RTN","MAGGSIA",156,0)
 . ; For now, BIG files are in same directory as FullRes (or PACS) file
"RTN","MAGGSIA",157,0)
 . S MAGRY(0)=MAGGDA_U_MAGGDRV_MAGDHASH_U_MAGGFNM
"RTN","MAGGSIA",158,0)
 . ; If BIG file also, add it's Drive, Hash, Filename to end of Return string.
"RTN","MAGGSIA",159,0)
 . I $G(MAGACT("BIG")) D
"RTN","MAGGSIA",160,0)
 . . S X=$P(MAGGFNM,".",1)_".BIG"
"RTN","MAGGSIA",161,0)
 . . S MAGRY(0)=MAGRY(0)_U_MAGGDRV_MAGDHASH_U_X
"RTN","MAGGSIA",162,0)
 . . Q
"RTN","MAGGSIA",163,0)
 . Q
"RTN","MAGGSIA",164,0)
 ;
"RTN","MAGGSIA",165,0)
 N MAGOUT
"RTN","MAGGSIA",166,0)
 I $$GET^XPAR("ALL","MAG PRECACHE ACQ ENABLED",,"I") D  ; IA# 2263 
"RTN","MAGGSIA",167,0)
 . D NWI2005^MAGNWRK1(.MAGOUT,MAGGDA) ; add a new storage work item
"RTN","MAGGSIA",168,0)
 . Q
"RTN","MAGGSIA",169,0)
 ;
"RTN","MAGGSIA",170,0)
CLEAN ; Called as tag
"RTN","MAGGSIA",171,0)
 D CLEAN^DILF
"RTN","MAGGSIA",172,0)
 L -^MAG(2005,NEWIEN)
"RTN","MAGGSIA",173,0)
 Q
"RTN","MAGGTIA1")
0^3^B34882923
"RTN","MAGGTIA1",1,0)
MAGGTIA1 ;WOIFO/GEK/SG/NST - RPC Call to Add Image File entry ; OCT 23, 2018@1:42pm
"RTN","MAGGTIA1",2,0)
 ;;3.0;IMAGING;**21,8,59,93,201**;Dec 02, 2009;Build 163
"RTN","MAGGTIA1",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGTIA1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTIA1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGTIA1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGTIA1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGTIA1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGTIA1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGTIA1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGTIA1",11,0)
 ;; |                                                               |
"RTN","MAGGTIA1",12,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGTIA1",13,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGTIA1",14,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGTIA1",15,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGTIA1",16,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGTIA1",17,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTIA1",18,0)
 ;;
"RTN","MAGGTIA1",19,0)
 Q
"RTN","MAGGTIA1",20,0)
ADD ;Now call Fileman to file the data
"RTN","MAGGTIA1",21,0)
 N NEWIEN,MAGGDA,X,Y
"RTN","MAGGTIA1",22,0)
 ;~~~ Delete this comment and the following line of code when
"RTN","MAGGTIA1",23,0)
 ;    the IMAGE AUDIT file (#2005.1) is completely eliminated.
"RTN","MAGGTIA1",24,0)
 ;    Because we delete the Image node on image deletion, we have to 
"RTN","MAGGTIA1",25,0)
 ;    check the last entry in Audit File, to see if it is greater
"RTN","MAGGTIA1",26,0)
 ;~~~ than the last image in the Image File.
"RTN","MAGGTIA1",27,0)
 I ($O(^MAG(2005,"A"),-1)<$O(^MAG(2005.1,"A"),-1)) S $P(^MAG(2005,0),U,3)=$O(^MAG(2005.1,"A"),-1)
"RTN","MAGGTIA1",28,0)
 ;   we know that MAGGIEN WILL contain the internal number.
"RTN","MAGGTIA1",29,0)
 ;    after the call.
"RTN","MAGGTIA1",30,0)
 ;
"RTN","MAGGTIA1",31,0)
 I $G(MAGMOD) D  Q  ; WE'LL QUIT AFTER MODIFICATION
"RTN","MAGGTIA1",32,0)
 . D UPDATE^DIE("S","MAGGFDA","MAGGIEN","MAGGXE")
"RTN","MAGGTIA1",33,0)
 . S MAGRY="1^OK"
"RTN","MAGGTIA1",34,0)
 . ; Now, after UPDATE^DIE, we aren't getting the MAGGIEN array., We'll use MAGMOD
"RTN","MAGGTIA1",35,0)
 . D ACTION^MAGGTAU("MOD^"_$P(^MAG(2005,+MAGMOD,0),U,7)_"^"_+$G(MAGMOD)) ; This is the Image IEN
"RTN","MAGGTIA1",36,0)
 ;
"RTN","MAGGTIA1",37,0)
 S (MAGGIEN(1),NEWIEN)=$$NEWIEN^MAGGI12()  ; SG - MAG*3*93
"RTN","MAGGTIA1",38,0)
 D UPDATE^DIE("S","MAGGFDA","MAGGIEN","MAGGXE")
"RTN","MAGGTIA1",39,0)
 ;
"RTN","MAGGTIA1",40,0)
 I '$G(MAGGIEN(1)) D  S MAGRY=MAGERR Q
"RTN","MAGGTIA1",41,0)
 . S MAGERR="0^ERROR Creating new Image File Entry "
"RTN","MAGGTIA1",42,0)
 . I $D(DIERR) D RTRNERR(.MAGERR)
"RTN","MAGGTIA1",43,0)
 . D CLEAN
"RTN","MAGGTIA1",44,0)
 ;
"RTN","MAGGTIA1",45,0)
 S MAGGDA=MAGGIEN(1)
"RTN","MAGGTIA1",46,0)
 ;
"RTN","MAGGTIA1",47,0)
 D ACTION^MAGGTAU("CAP^"_MAGGFDA(2005,"+1,",5)_"^"_MAGGDA)
"RTN","MAGGTIA1",48,0)
 ;
"RTN","MAGGTIA1",49,0)
 ; IF a group, Modify GROUP PARENT in each Group Object and QUIT
"RTN","MAGGTIA1",50,0)
 ;   we'll do this by hand, Else it'll take forever.
"RTN","MAGGTIA1",51,0)
 ;   we Return the IEN with NO Filename. Groups don't get Filename
"RTN","MAGGTIA1",52,0)
 ;
"RTN","MAGGTIA1",53,0)
 I MAGGR S MAGRY=MAGGDA_U,Z="" D  G C1
"RTN","MAGGTIA1",54,0)
 . F  S Z=$O(MAGGR(Z)) Q:Z=""  S $P(^MAG(2005,Z,0),U,10)=MAGGDA
"RTN","MAGGTIA1",55,0)
 . D CLEAN
"RTN","MAGGTIA1",56,0)
 ;
"RTN","MAGGTIA1",57,0)
 S X=$G(MAGGFDA(2005,"+1,",14)) I +X D
"RTN","MAGGTIA1",58,0)
 . ; If here: This image is a member of a Group
"RTN","MAGGTIA1",59,0)
 . ;   -Modify the Group Parent, add DA to it's group
"RTN","MAGGTIA1",60,0)
 . ;   -Also set 'Series Number' and 'Image Number' if they exist;
"RTN","MAGGTIA1",61,0)
 . K MAGGFDA
"RTN","MAGGTIA1",62,0)
 . S Y="+2,"_X_","
"RTN","MAGGTIA1",63,0)
 . S MAGGFDA(2005.04,Y,.01)=MAGGDA
"RTN","MAGGTIA1",64,0)
 . ; GEK 4/4/00 ADDED $L( we were dying on "0"
"RTN","MAGGTIA1",65,0)
 . I $L($G(MAGDCMSN)) S MAGGFDA(2005.04,Y,1)=MAGDCMSN
"RTN","MAGGTIA1",66,0)
 . I $L($G(MAGDCMIN)) S MAGGFDA(2005.04,Y,2)=MAGDCMIN
"RTN","MAGGTIA1",67,0)
 . D UPDATE^DIE("S","MAGGFDA","MAGGIEN","MAGGXE")
"RTN","MAGGTIA1",68,0)
 ;
"RTN","MAGGTIA1",69,0)
 ; Now get the Image file name. DOS FILE name
"RTN","MAGGTIA1",70,0)
 ; The ENTRY in Image File has been made, if any errors from here on
"RTN","MAGGTIA1",71,0)
 ;  then we have to delete the image entry.
"RTN","MAGGTIA1",72,0)
 I $D(MAGGFDA(2005,"+1,",1)) S MAGGFNM=MAGGFDA(2005,"+1,",1) G C1
"RTN","MAGGTIA1",73,0)
 K MAGGFDA
"RTN","MAGGTIA1",74,0)
 S X=$$DA2NAME^MAGGTU1(MAGGDA,$G(MAGGEXT)) I 'X D  S MAGRY=MAGERR Q
"RTN","MAGGTIA1",75,0)
 . S MAGERR=X
"RTN","MAGGTIA1",76,0)
 . S DA=MAGGDA,DIK="^MAG(2005," D ^DIK
"RTN","MAGGTIA1",77,0)
 . K DA,DIC,DIK
"RTN","MAGGTIA1",78,0)
 . D CLEAN
"RTN","MAGGTIA1",79,0)
 S MAGGFNM=$P(X,U,2),Y=MAGGDA_","
"RTN","MAGGTIA1",80,0)
 S MAGGFDA(2005,Y,1)=MAGGFNM
"RTN","MAGGTIA1",81,0)
 D UPDATE^DIE("","MAGGFDA","","MAGGXE")
"RTN","MAGGTIA1",82,0)
 ;   shouldn't have an error just editing one entry, but just in case.
"RTN","MAGGTIA1",83,0)
 I $D(DIERR) D  S MAGRY=MAGERR Q
"RTN","MAGGTIA1",84,0)
 . D RTRNERR(.MAGERR)
"RTN","MAGGTIA1",85,0)
 . S DA=MAGGDA,DIK="^MAG(2005," D ^DIK
"RTN","MAGGTIA1",86,0)
 . K DA,DIC,DIK
"RTN","MAGGTIA1",87,0)
 . D CLEAN
"RTN","MAGGTIA1",88,0)
 ;
"RTN","MAGGTIA1",89,0)
C1 ; we jump here if we already had a Filename sent
"RTN","MAGGTIA1",90,0)
 K MAGGFDA
"RTN","MAGGTIA1",91,0)
 ; New Index Field Check.  If this entry doesn't have the Index fields introduced
"RTN","MAGGTIA1",92,0)
 ;   in 3.0.8 then we use the Patch 17 conversion API call to generate default values.
"RTN","MAGGTIA1",93,0)
 ;
"RTN","MAGGTIA1",94,0)
 ;P59 Now we Auto-Generate the Index Fields, if they don't exist for this entry.
"RTN","MAGGTIA1",95,0)
 I '$D(^MAG(2005,MAGGDA,40)) D
"RTN","MAGGTIA1",96,0)
 . N INDXD
"RTN","MAGGTIA1",97,0)
 . D GENIEN^MAGXCVI(MAGGDA,.INDXD)
"RTN","MAGGTIA1",98,0)
 . S ^MAG(2005,MAGGDA,40)=INDXD
"RTN","MAGGTIA1",99,0)
 . S ^MAGIXCVT(2006.96,MAGGDA)=2 ; Flag. Says fields were converted Patch 59
"RTN","MAGGTIA1",100,0)
 . ; TRKING ID  TRKID =   MAGGFDA(2005,"+1,",108)
"RTN","MAGGTIA1",101,0)
 . D ACTION^MAGGTAU("INDEX-ALL^"_$P(^MAG(2005,MAGGDA,0),"^",7)_"^"_MAGGDA) ;_"$$"_MAGGFDA(2005,"+1,",108))
"RTN","MAGGTIA1",102,0)
 . D ENTRY^MAGLOG("INDEX-ALL",DUZ,MAGGDA,"P59",$P(^MAG(2005,MAGGDA,0),"^",7),1)
"RTN","MAGGTIA1",103,0)
 . Q
"RTN","MAGGTIA1",104,0)
 ;P59 If TYPE INDEX is missing we Auto-Generate Index Type and other missing Index Term values.
"RTN","MAGGTIA1",105,0)
 I '$P(^MAG(2005,MAGGDA,40),"^",3) D
"RTN","MAGGTIA1",106,0)
 . N INDXD,J,OLD40,N40
"RTN","MAGGTIA1",107,0)
 . S (N40,OLD40)=^MAG(2005,MAGGDA,40)
"RTN","MAGGTIA1",108,0)
 . D GENIEN^MAGXCVI(MAGGDA,.INDXD)
"RTN","MAGGTIA1",109,0)
 . ; If Origin doesn't exist in existing, this will put V in. 
"RTN","MAGGTIA1",110,0)
 . I $P(INDXD,"^",6)="" S $P(INDXD,"^",6)="V"
"RTN","MAGGTIA1",111,0)
 . ; We're not changing existing values of Spec,Proc or Origin 
"RTN","MAGGTIA1",112,0)
 . F J=1:1:6 I '$L($P(N40,"^",J)) S $P(N40,"^",J)=$P(INDXD,"^",J)
"RTN","MAGGTIA1",113,0)
 . ;Validate the merged Spec and Proc, if  not valid, revert back to old Spec and Proc
"RTN","MAGGTIA1",114,0)
 . I '$$VALINDEX^MAGGSIV1(.X,$P(N40,"^",3),$P(N40,"^",5),$P(N40,"^",4)) S $P(N40,"^",4,5)=$P(OLD40,"^",4,5)
"RTN","MAGGTIA1",115,0)
 . S ^MAG(2005,MAGGDA,40)=N40
"RTN","MAGGTIA1",116,0)
 . D ACTION^MAGGTAU("INDEX-42^"_$P(^MAG(2005,MAGGDA,0),"^",7)_"^"_MAGGDA) ;_"$$"_MAGGFDA(2005,"+1,",108))
"RTN","MAGGTIA1",117,0)
 . D ENTRY^MAGLOG("INDEX-42",DUZ,MAGGDA,"P59",$P(^MAG(2005,MAGGDA,0),"^",7),1)
"RTN","MAGGTIA1",118,0)
 . Q
"RTN","MAGGTIA1",119,0)
 ;** ABS and JB image queues AREN'T SET WHEN ADDING AN IMAGE. 
"RTN","MAGGTIA1",120,0)
 ;** IT IS DONE IN A SEPERATE CALL 
"RTN","MAGGTIA1",121,0)
 ;** RPC =-> 'MAG ABSJB' after abstract is/isn't created on 
"RTN","MAGGTIA1",122,0)
 ;**  the workstation
"RTN","MAGGTIA1",123,0)
 ;
"RTN","MAGGTIA1",124,0)
 ; Queue it to be copied to Jukebox.
"RTN","MAGGTIA1",125,0)
 ;        CREATE ABSTRACT
"RTN","MAGGTIA1",126,0)
 ; visn15 ADDED $$DA2PLCA to resolve the Image's current PLACE
"RTN","MAGGTIA1",127,0)
 I $G(MAGGABS)="YES" S X=$$ABSTRACT^MAGBAPI(MAGGDA,$$DA2PLC^MAGBAPIP(MAGGDA,"A"))
"RTN","MAGGTIA1",128,0)
 ;        RESTORE AFTER GLOBAL SETUP
"RTN","MAGGTIA1",129,0)
 I $G(MAGGJB)="YES" S X=$$JUKEBOX^MAGBAPI(MAGGDA,$$DA2PLC^MAGBAPIP(MAGGDA,"F"))
"RTN","MAGGTIA1",130,0)
 ;     Code for setting a Queue to Copy BIG to JUKEBOX
"RTN","MAGGTIA1",131,0)
 ; 
"RTN","MAGGTIA1",132,0)
 ;  We return the IEN ^ DRIVE:DIR ^ FILE.EXT
"RTN","MAGGTIA1",133,0)
 ;   example:   487^C:\IMAGE\^DC000487.TIF
"RTN","MAGGTIA1",134,0)
 ;  The calling routine is responsible for renaming/naming the file
"RTN","MAGGTIA1",135,0)
 ;   to the returned DRIVE:\DIR\FILENAME.EXT
"RTN","MAGGTIA1",136,0)
 ;  4/23/98 to include hierarchical directory structure -- PMK
"RTN","MAGGTIA1",137,0)
 ;
"RTN","MAGGTIA1",138,0)
 I 'MAGGR D
"RTN","MAGGTIA1",139,0)
 . S MAGDHASH=$$DIRHASH^MAGFILEB(MAGGFNM,MAGREF)
"RTN","MAGGTIA1",140,0)
 . S MAGRY=MAGGDA_U_MAGGDRV_MAGDHASH_U_MAGGFNM
"RTN","MAGGTIA1",141,0)
 . ; For now, BIG files are in same directory as FullRes (or PACS) file
"RTN","MAGGTIA1",142,0)
 . I $G(MAGBIG) D
"RTN","MAGGTIA1",143,0)
 . . S X=$P(MAGGFNM,".",1)_".BIG"
"RTN","MAGGTIA1",144,0)
 . . S MAGRY=MAGRY_U_MAGGDRV_MAGDHASH_U_X
"RTN","MAGGTIA1",145,0)
 . . Q
"RTN","MAGGTIA1",146,0)
 . Q
"RTN","MAGGTIA1",147,0)
 ;
"RTN","MAGGTIA1",148,0)
 N MAGOUT
"RTN","MAGGTIA1",149,0)
 I $$GET^XPAR("ALL","MAG PRECACHE ACQ ENABLED",,"I") D  ; IA# 2263
"RTN","MAGGTIA1",150,0)
 . D NWI2005^MAGNWRK1(.MAGOUT,MAGGDA) ; add a new storage work item
"RTN","MAGGTIA1",151,0)
 . Q
"RTN","MAGGTIA1",152,0)
 ;
"RTN","MAGGTIA1",153,0)
CLEAN ;
"RTN","MAGGTIA1",154,0)
 D CLEAN^DILF
"RTN","MAGGTIA1",155,0)
 L -^MAG(2005,NEWIEN)
"RTN","MAGGTIA1",156,0)
 Q
"RTN","MAGGTIA1",157,0)
RTRNERR(ETXT) ; There was error from UPDATE^DIE quit with error text
"RTN","MAGGTIA1",158,0)
 S ETXT="0^ERROR  "_MAGGXE("DIERR",1,"TEXT",1)
"RTN","MAGGTIA1",159,0)
 Q
"RTN","MAGGTIA1",160,0)
ERR ; Error trap
"RTN","MAGGTIA1",161,0)
 S MAGRY="0^ERROR "_$$EC^%ZOSV
"RTN","MAGGTIA1",162,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGGTIA1",163,0)
 Q
"RTN","MAGGTIA1",164,0)
MAKENAME() ; MAGGFDA exists so get info from that.
"RTN","MAGGTIA1",165,0)
 ; We'll make NAME (.01)  with PATIENT NAME   SSN
"RTN","MAGGTIA1",166,0)
 ; DOCUMENT Imaging was making name of
"RTN","MAGGTIA1",167,0)
 ; $E(PATENT NAME,1,10)' '$E(DESC CATEG,1,9)' 'MM/DD/YY   (DOC DATE)
"RTN","MAGGTIA1",168,0)
 N Z,ZT,ZNAME,ZSSN,ZDESC
"RTN","MAGGTIA1",169,0)
 ; GEK 10/10/2000
"RTN","MAGGTIA1",170,0)
 ; Modifying this procedure to make same name for all Image types
"RTN","MAGGTIA1",171,0)
 ;  The name will be (first 18 chars of patient Name) _ SSN
"RTN","MAGGTIA1",172,0)
 I $D(MAGGFDA(2005,"+1,",10)) S ZDESC=$E(MAGGFDA(2005,"+1,",10),1,30)
"RTN","MAGGTIA1",173,0)
 I $D(MAGGFDA(2005,"+1,",5)) D
"RTN","MAGGTIA1",174,0)
 . S X=MAGGFDA(2005,"+1,",5)
"RTN","MAGGTIA1",175,0)
 . S ZNAME=$P(^DPT(X,0),U),ZSSN=$P(^DPT(X,0),U,9)
"RTN","MAGGTIA1",176,0)
 ;
"RTN","MAGGTIA1",177,0)
 ; For all Images the name is first 18 characters of patient name 
"RTN","MAGGTIA1",178,0)
 ;  concatenated with SSN.  If No patient name is sent, well make
"RTN","MAGGTIA1",179,0)
 ;  the name from the short desc.
"RTN","MAGGTIA1",180,0)
 I $D(ZNAME) S Z=$E(ZNAME,1,18)_"   "_ZSSN
"RTN","MAGGTIA1",181,0)
 E  S Z=ZDESC
"RTN","MAGGTIA1",182,0)
 Q Z
"RTN","MAGJEX2")
0^4^B46640009
"RTN","MAGJEX2",1,0)
MAGJEX2 ;WIRMFO/JHC,NST - Rad. Workstation RPC calls; OCT 24, 2018@4:05 PM
"RTN","MAGJEX2",2,0)
 ;;3.0;IMAGING;**51,18,76,120,201**;Mar 19, 2002;Build 27;May 23, 2012
"RTN","MAGJEX2",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGJEX2",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJEX2",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGJEX2",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGJEX2",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGJEX2",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGJEX2",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGJEX2",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGJEX2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGJEX2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGJEX2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGJEX2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGJEX2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGJEX2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJEX2",17,0)
 ;;
"RTN","MAGJEX2",18,0)
 Q
"RTN","MAGJEX2",19,0)
 ; Subroutines for pre-fetch/ auto-route prior exams' images
"RTN","MAGJEX2",20,0)
 ; Entry Points:
"RTN","MAGJEX2",21,0)
 ;   PRIOR1  -- Pre-Fetch/Auto-route images for other related cases;
"RTN","MAGJEX2",22,0)
 ;    RPC Call: MAGJ PRIOREXAMS
"RTN","MAGJEX2",23,0)
 ;   PREFETCH -- Subroutine call via Protocol trigger
"RTN","MAGJEX2",24,0)
 ;
"RTN","MAGJEX2",25,0)
 Q
"RTN","MAGJEX2",26,0)
ERR N ERR S ERR=$$EC^%ZOSV S MAGGRY(0)="0^Server Program Error: "_ERR
"RTN","MAGJEX2",27,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGJEX2",28,0)
 Q:$Q 1  Q
"RTN","MAGJEX2",29,0)
PREFETCH ; Entry point from HL7 processing, to initiate prefetch at
"RTN","MAGJEX2",30,0)
 ; time of radiology "Register Patient for Exam" function
"RTN","MAGJEX2",31,0)
 ; Do not process if the exam is being Canceled (RACANC true)
"RTN","MAGJEX2",32,0)
 ;
"RTN","MAGJEX2",33,0)
 N RET S RET=""
"RTN","MAGJEX2",34,0)
 I '$P($G(^MAG(2006.69,1,0)),U,5) G PREFQ          ; Prefetch disabled
"RTN","MAGJEX2",35,0)
 I '($G(RADFN)&$G(RADTI)&$G(RACNI)&'$G(RACANC)) G PREFQ ; Required vars
"RTN","MAGJEX2",36,0)
 D PRIOR1(.RET,"P"_U_RADFN_U_RADTI_U_RACNI)
"RTN","MAGJEX2",37,0)
PREFQ ;
"RTN","MAGJEX2",38,0)
 Q
"RTN","MAGJEX2",39,0)
 ;
"RTN","MAGJEX2",40,0)
PRIOR1(MAGGRY,DATA) ; review all exams for a patient to find "related" exams
"RTN","MAGJEX2",41,0)
 ; This ep also called as subroutine from routing software (P51)
"RTN","MAGJEX2",42,0)
 ; MAGGRY - return array of exams to PreFetch or Auto-route
"RTN","MAGJEX2",43,0)
 ; DATA:  - input params for the Current Exam
"RTN","MAGJEX2",44,0)
 ;   1) ACTION = P -- Pre-fetch Exams (from Jukebox to Magnetic Disk)
"RTN","MAGJEX2",45,0)
 ;             = A -- Auto-route priors
"RTN","MAGJEX2",46,0)
 ;             = C -- Pre-cache exams
"RTN","MAGJEX2",47,0)
 ;   2) RADFN  = Case pointers to Rad/Nuc Med Patient file 
"RTN","MAGJEX2",48,0)
 ;   3) RADTI  =  ""        ""         ""          ""
"RTN","MAGJEX2",49,0)
 ;   4) RACNI  =  ""        ""         ""          ""
"RTN","MAGJEX2",50,0)
 ;   5) RARPT  - Case pointer to ^RARPT global
"RTN","MAGJEX2",51,0)
 ;
"RTN","MAGJEX2",52,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGJEX2"
"RTN","MAGJEX2",53,0)
 K MAGGRY
"RTN","MAGJEX2",54,0)
 N RADFN,RADTI,RACNI,RARPT,RADATA
"RTN","MAGJEX2",55,0)
 N DAYCASE,DIQUIET,ACTION,CPT,HDR,MAGDFN,MAGDTI,MAGCNI,MAGRET,MAGRACNT
"RTN","MAGJEX2",56,0)
 S ACTION=$P(DATA,U)
"RTN","MAGJEX2",57,0)
 I ACTION="P"!(ACTION="A")!(ACTION="C")
"RTN","MAGJEX2",58,0)
 E  S MAGGRY(0)="0^Invalid Request (Action code="_ACTION_")" G PRIOR1Z
"RTN","MAGJEX2",59,0)
 S MAGDFN=$P(DATA,U,2),MAGDTI=$P(DATA,U,3),MAGCNI=$P(DATA,U,4)
"RTN","MAGJEX2",60,0)
 I MAGDFN,MAGDTI,MAGCNI
"RTN","MAGJEX2",61,0)
 E  S MAGGRY(0)="0^Request Contains Invalid Case Pointer ("_DATA_")" G PRIOR1Z
"RTN","MAGJEX2",62,0)
 S DIQUIET=1 D DT^DICRW
"RTN","MAGJEX2",63,0)
 N MAGJOB D MAGJOBNC^MAGJUTL3
"RTN","MAGJEX2",64,0)
 S HDR=$S(ACTION="P":"Pre-fetch",ACTION="A":"Auto-route",ACTION="C":"Pre-cache",1:"???")_" Prior Exams for CASE: "
"RTN","MAGJEX2",65,0)
 I '$D(^DPT(MAGDFN,0)) S MAGGRY(0)="0^Request Contains Invalid Patient Pointer ("_MAGDFN_")" G PRIOR1Z
"RTN","MAGJEX2",66,0)
 I $D(^RADPT(MAGDFN,"DT",MAGDTI,"P",MAGCNI))
"RTN","MAGJEX2",67,0)
 E  S MAGGRY(0)="0^Request Contains Invalid Case Pointer ("_MAGCNI_")" G PRIOR1Z
"RTN","MAGJEX2",68,0)
 S MAGRACNT=0
"RTN","MAGJEX2",69,0)
 S MAGGRY(0)="0^Compiling Prior Radiology Exams"
"RTN","MAGJEX2",70,0)
 D GETEXAM2^MAGJUTL1(MAGDFN,MAGDTI,MAGCNI,"",.MAGRET) ; Current Exam only
"RTN","MAGJEX2",71,0)
 S RADFN=MAGDFN,RADTI=MAGDTI,RACNI=MAGCNI
"RTN","MAGJEX2",72,0)
 I 'MAGRET S MAGGRY(0)="0^Current Case is Not Accessible" G PRIOR1Z
"RTN","MAGJEX2",73,0)
 S RADATA=$G(^TMP($J,"MAGRAEX",1,1)) S DAYCASE=$P(RADATA,U,12) D SVMAG2A
"RTN","MAGJEX2",74,0)
 I 'MAGGRY(0) S MAGGRY(0)="0^Current Case either has no CPT code, or has no rules defined for its CPT code." G PRIOR1Z
"RTN","MAGJEX2",75,0)
 S HDR=HDR_DAYCASE
"RTN","MAGJEX2",76,0)
 D SRCH(MAGDFN)  ;  Search prior exams for this patient
"RTN","MAGJEX2",77,0)
PRIOR1Z ;
"RTN","MAGJEX2",78,0)
 I 'MAGGRY(0) S:(MAGGRY(0)["Compiling") MAGGRY(0)="0^No Exams Found"
"RTN","MAGJEX2",79,0)
 E  I +MAGGRY(0)=1 S MAGGRY(0)="0^No Prior Exams Found" K MAGGRY(1)
"RTN","MAGJEX2",80,0)
 E  D SVMAG2B
"RTN","MAGJEX2",81,0)
 K ^TMP($J,"MAGRAEX"),^("RAE1")
"RTN","MAGJEX2",82,0)
 Q
"RTN","MAGJEX2",83,0)
 ;
"RTN","MAGJEX2",84,0)
SRCH(RADFN) ; Traverse all exams for a patient, up to limits of age & total
"RTN","MAGJEX2",85,0)
 ; numbers of exams to consider
"RTN","MAGJEX2",86,0)
 N BEGDT,LIMYRS,LIMEXAMS
"RTN","MAGJEX2",87,0)
 S LIMYRS=30,LIMEXAMS=100 ; default limit # Exams
"RTN","MAGJEX2",88,0)
 S BEGDT=($E(DT,1,3)-LIMYRS)_$E(DT,4,7)
"RTN","MAGJEX2",89,0)
 I BEGDT<2950101 S BEGDT=2950101 ; 2 yrs prior to earliest VistaPACS
"RTN","MAGJEX2",90,0)
 S MAGRACNT=1 D GETEXAM3^MAGJUTL1(RADFN,BEGDT,"",.MAGRACNT,.MAGRET,"",LIMEXAMS)
"RTN","MAGJEX2",91,0)
 I MAGRET N IDAT S IDAT=1 D
"RTN","MAGJEX2",92,0)
 . F  S IDAT=$O(^TMP($J,"MAGRAEX",IDAT)) Q:'IDAT  S RADATA=^(IDAT,1) D
"RTN","MAGJEX2",93,0)
 . . S RADTI=$P(RADATA,U,2),RACNI=$P(RADATA,U,3)
"RTN","MAGJEX2",94,0)
 . . I RADTI=MAGDTI&(RACNI=MAGCNI) Q  ; skip current case
"RTN","MAGJEX2",95,0)
 . . D SVMAG2A
"RTN","MAGJEX2",96,0)
 Q
"RTN","MAGJEX2",97,0)
 ;
"RTN","MAGJEX2",98,0)
SVMAG2A ; 2A and 2B used by subroutine at tag PRIOR1
"RTN","MAGJEX2",99,0)
 ; Find all the patient's exams whose CPT codes are related to the
"RTN","MAGJEX2",100,0)
 ; Current exam's CPT code, according to dictionary 2006.65
"RTN","MAGJEX2",101,0)
 N RAIMGTYP,X
"RTN","MAGJEX2",102,0)
 N CPT,CPT3,CPT4,CPT5,CURCPTX,CURCPTS,HIT,MAGMATCH,MAGDTH,I
"RTN","MAGJEX2",103,0)
 S RARPT=+$P(RADATA,U,10)
"RTN","MAGJEX2",104,0)
 I MAGGRY(0) Q:'$P(MAGGRY(1),U)           ;  Cur Case CPT not in map file
"RTN","MAGJEX2",105,0)
 I  Q:(ACTION="P")&'$D(^RARPT(RARPT,2005))  ; nothing to pre-fetch
"RTN","MAGJEX2",106,0)
 I  Q:$P(RADATA,U,15)<2          ; Cancel or Waiting
"RTN","MAGJEX2",107,0)
 ;   Note: if no images, may still want to do Auto-Disp to get Report;
"RTN","MAGJEX2",108,0)
 ;      also, Current Case should still proceed
"RTN","MAGJEX2",109,0)
 S CPT=$P(RADATA,U,17)
"RTN","MAGJEX2",110,0)
 Q:'CPT  ;  algorithm REQUIRES CPT codes be used
"RTN","MAGJEX2",111,0)
 S CPT5=CPT,CPT4=$E(CPT,1,4),CPT3=$E(CPT,1,3)
"RTN","MAGJEX2",112,0)
 S MAGMATCH="^^"
"RTN","MAGJEX2",113,0)
 I 'MAGGRY(0) D  Q:'MAGMATCH  ; No rules defined for Cur. Case's CPT
"RTN","MAGJEX2",114,0)
 . S Y=""
"RTN","MAGJEX2",115,0)
 . ;  Order of CPT5/4/3 is important for the algorithm, which
"RTN","MAGJEX2",116,0)
 . ;  uses the 1st rule found at the LOWEST level of detail defined
"RTN","MAGJEX2",117,0)
 . F X=CPT5,CPT4,CPT3 I $D(^MAG(2006.65,"B",X)) S Y=Y_$S(Y:",",1:"")_X S $P(MAGMATCH,U)=Y
"RTN","MAGJEX2",118,0)
 I CPT,MAGGRY(0) D
"RTN","MAGJEX2",119,0)
 . ; curcpts has the cpt5/4/3 list generated above for Cur. Case CPT's
"RTN","MAGJEX2",120,0)
 . S HIT=0,CURCPTS=$P(MAGGRY(1),U)
"RTN","MAGJEX2",121,0)
 . F  Q:CURCPTS=""  S CURCPTX=$O(^MAG(2006.65,"B",$P(CURCPTS,","),"")) S CURCPTS=$P(CURCPTS,",",2,9) I CURCPTX]"" D  Q:HIT  ; 1st hit only
"RTN","MAGJEX2",122,0)
 . . ;  This algorithm checks from lowest detail to most general, and acts
"RTN","MAGJEX2",123,0)
 . . ;  on the information found at the FIRST Hit only
"RTN","MAGJEX2",124,0)
 . . F CPT="CPT5","CPT4","CPT3" S CPT=@CPT I CPT]"",$D(^MAG(2006.65,CURCPTX,1,"B",CPT)) S X=$O(^(CPT,"")) D  S HIT=1 Q  ;1st hit only
"RTN","MAGJEX2",125,0)
 . . . S X=^MAG(2006.65,CURCPTX,1,X,0) S Y=$S(ACTION="A":2,1:5),X=$P(X,U,Y,Y+2)
"RTN","MAGJEX2",126,0)
 . . . I +X S MAGMATCH=CPT F I=2,3 S $P(MAGMATCH,U,I)=$P(X,U,I)
"RTN","MAGJEX2",127,0)
 ;         sample of logic file:
"RTN","MAGJEX2",128,0)
 ; ^MAG(2006.65,1,0) = 730
"RTN","MAGJEX2",129,0)
 ; ^MAG(2006.65,1,1,0) = ^12000011.01^2^2
"RTN","MAGJEX2",130,0)
 ; ^MAG(2006.65,1,1,1,0) = 730^1^40^6^1^120^10
"RTN","MAGJEX2",131,0)
 ; ^MAG(2006.65,1,1,2,0) = 732^1^40^2^1^120^4
"RTN","MAGJEX2",132,0)
 ; ^MAG(2006.65,1,1,"B",730,1) =
"RTN","MAGJEX2",133,0)
 ; ^MAG(2006.65,1,1,"B",732,2) =
"RTN","MAGJEX2",134,0)
 ; ^MAG(2006.65,"B",730,1) =
"RTN","MAGJEX2",135,0)
 ;
"RTN","MAGJEX2",136,0)
 Q:'MAGMATCH
"RTN","MAGJEX2",137,0)
 ; 1  RADFN   RADTI    RACNI   RANME   RASSN    <-- from GETEXAM
"RTN","MAGJEX2",138,0)
 ; 6  RADATE  RADTE    RACN    RAPRC   RARPT
"RTN","MAGJEX2",139,0)
 ; 11 RAST    DAYCASE  RAELOC  RASTP   RASTORD
"RTN","MAGJEX2",140,0)
 ; 16 RADTPRT RACPT    RAIMGTYP
"RTN","MAGJEX2",141,0)
 S MAGDTH=$$FMTH^XLFDT($P(RADATA,U,7),1)
"RTN","MAGJEX2",142,0)
 S X=$P(RADATA,U,18)
"RTN","MAGJEX2",143,0)
 S RAIMGTYP=$S(X]"":$O(^RA(79.2,"C",X,"")),1:X)
"RTN","MAGJEX2",144,0)
 S Y=MAGGRY(0)+1,$P(MAGGRY(0),U)=Y,MAGGRY(Y)=MAGMATCH_U_MAGDTH_U_U_$P(RADATA,U,9)_U_RAIMGTYP_U_RADFN_U_RADTI_U_RACNI_U_RARPT_U_$P(RADATA,U,12)_U_$P(RADATA,U,11)
"RTN","MAGJEX2",145,0)
 Q
"RTN","MAGJEX2",146,0)
 ;
"RTN","MAGJEX2",147,0)
SVMAG2B ; For exams whose CPTs match, select a subset that are within defined
"RTN","MAGJEX2",148,0)
 ; limits with respect to time interval & maximum # exams to retrieve
"RTN","MAGJEX2",149,0)
 ; Return MAGGRY(0) =  count ^ message
"RTN","MAGJEX2",150,0)
 ;        MAGGRY(1:N) = "M08" | RADFN ^ RADTI ^ RACNI ^ RARPT
"RTN","MAGJEX2",151,0)
 N CPT,CT,CURDAT,ICPT,IREC,GO,Y
"RTN","MAGJEX2",152,0)
 S CURDAT=$P(MAGGRY(1),U,4)
"RTN","MAGJEX2",153,0)
 F IREC=2:1:MAGGRY(0) S X=MAGGRY(IREC),CPT=+X D  K MAGGRY(IREC)
"RTN","MAGJEX2",154,0)
 . I $P(X,U,2) S Y=CURDAT-$P(X,U,4) S:Y<0 Y=-Y I Y>$P(X,U,2) Q  ;too old
"RTN","MAGJEX2",155,0)
 . S Y=$G(GO(CPT))+1 I CPT,(Y>$P(X,U,3)) Q  ; already have enough cases
"RTN","MAGJEX2",156,0)
 . S GO(CPT)=Y,GO(CPT,Y)=X
"RTN","MAGJEX2",157,0)
 K MAGGRY
"RTN","MAGJEX2",158,0)
 I $D(GO) S CT=0,CPT="" D
"RTN","MAGJEX2",159,0)
 . F  S CPT=$O(GO(CPT)) Q:CPT=""  F ICPT=1:1:GO(CPT) D
"RTN","MAGJEX2",160,0)
 . . S CT=CT+1,X=GO(CPT,ICPT),RARPT=$P(X,U,11)
"RTN","MAGJEX2",161,0)
 . . S MAGGRY(CT)="M08^"_CPT_"|"_$P(X,U,8,11)
"RTN","MAGJEX2",162,0)
 . . I ACTION="P"!(ACTION="A") S Y=$$JBFETCH^MAGJUTL2(RARPT)  ; fetch from jukebox
"RTN","MAGJEX2",163,0)
 . . I ACTION="C" S Y=$$CACHE^MAGNUTL2(RARPT)  ; precache exams
"RTN","MAGJEX2",164,0)
 . S MAGGRY(0)=CT_"^"_HDR
"RTN","MAGJEX2",165,0)
 E  S MAGGRY(0)="0^No Exams Found for "_HDR
"RTN","MAGJEX2",166,0)
 Q
"RTN","MAGJEX2",167,0)
 ;
"RTN","MAGJEX2",168,0)
END ;
"RTN","MAGNUTL2")
0^5^B9894691
"RTN","MAGNUTL2",1,0)
MAGNUTL2 ;WOIFO/NST - VistRad subroutines for RPC calls ; OCT 22, 2018@1:42PM
"RTN","MAGNUTL2",2,0)
 ;;3.0;IMAGING;**201**;Dec 02, 2009;Build 163
"RTN","MAGNUTL2",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNUTL2",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNUTL2",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNUTL2",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNUTL2",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNUTL2",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNUTL2",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNUTL2",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNUTL2",11,0)
 ;; |                                                               |
"RTN","MAGNUTL2",12,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNUTL2",13,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNUTL2",14,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNUTL2",15,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNUTL2",16,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNUTL2",17,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNUTL2",18,0)
 ;;
"RTN","MAGNUTL2",19,0)
 Q
"RTN","MAGNUTL2",20,0)
 ;
"RTN","MAGNUTL2",21,0)
 ; Subroutines for pre-cache exams images
"RTN","MAGNUTL2",22,0)
 ; Entry Points:
"RTN","MAGNUTL2",23,0)
 ;   PRECACHE -- Subroutine call via Protocol trigger
"RTN","MAGNUTL2",24,0)
 ;
"RTN","MAGNUTL2",25,0)
PRECACHE ; Entry point from HL7 processing, to initiate precache at
"RTN","MAGNUTL2",26,0)
 ; time of radiology "Register Patient for Exam" RA REG protocol
"RTN","MAGNUTL2",27,0)
 ; Do not process if the exam is being Canceled (RACANC true)
"RTN","MAGNUTL2",28,0)
 ;
"RTN","MAGNUTL2",29,0)
 Q:'$$GET^XPAR("ALL","MAG PRECACHE RAD REG ENABLED",,"I")  ; IA# 2263 
"RTN","MAGNUTL2",30,0)
 ;
"RTN","MAGNUTL2",31,0)
 N RET S RET=""
"RTN","MAGNUTL2",32,0)
 I '($G(RADFN)&$G(RADTI)&$G(RACNI)&'$G(RACANC)) Q  ; Required vars
"RTN","MAGNUTL2",33,0)
 ; MAGJEX2 will call CACHE^MAGNUTL2 after collecting all images to be precached - "C" is a new action
"RTN","MAGNUTL2",34,0)
 D PRIOR1^MAGJEX2(.RET,"C"_U_RADFN_U_RADTI_U_RACNI)
"RTN","MAGNUTL2",35,0)
 Q
"RTN","MAGNUTL2",36,0)
 ;
"RTN","MAGNUTL2",37,0)
CACHE(RARPT) ; cache this case's images
"RTN","MAGNUTL2",38,0)
 ; Input: RARPT: IEN in RAD/NUC MED REPORTS file (#74)
"RTN","MAGNUTL2",39,0)
 ;
"RTN","MAGNUTL2",40,0)
 N MAGOUT
"RTN","MAGNUTL2",41,0)
 D NWRKITEM(.MAGOUT,RARPT)
"RTN","MAGNUTL2",42,0)
 Q 1
"RTN","MAGNUTL2",43,0)
 ;
"RTN","MAGNUTL2",44,0)
NWRKITEM(MAGOUT,RARPT) ;Create New MAG WORK ITEM
"RTN","MAGNUTL2",45,0)
 ; RARPT - IEN in RAD/NUC MED REPORTS file (#74)
"RTN","MAGNUTL2",46,0)
 ;
"RTN","MAGNUTL2",47,0)
 N CRTUSR,CRTAPP,DFN,ICN,J,MAGCTXID,MSGTAGS,TYPE,SUBTYPE,STATUS,PLACEID,PRIORITY,SSEP
"RTN","MAGNUTL2",48,0)
 ;
"RTN","MAGNUTL2",49,0)
 S SSEP="`"
"RTN","MAGNUTL2",50,0)
 S MAGCTXID=$$RACPRS^MAGNU003(RARPT) ; Radiology CPRS context
"RTN","MAGNUTL2",51,0)
 I MAGCTXID="" S MAGOUT=-20_SSEP_"CPRS context is blank"
"RTN","MAGNUTL2",52,0)
 S DFN=$$GET1^DIQ(74,RARPT,2,"I")
"RTN","MAGNUTL2",53,0)
 ;
"RTN","MAGNUTL2",54,0)
 S PLACEID=DUZ(2)
"RTN","MAGNUTL2",55,0)
 ;
"RTN","MAGNUTL2",56,0)
 ; TAGS
"RTN","MAGNUTL2",57,0)
 S J=0
"RTN","MAGNUTL2",58,0)
 S J=J+1,MSGTAGS(J)="contextID`"_$TR(MAGCTXID,"^","~")  ;CPRS Report Context ID and translate ^ to ~
"RTN","MAGNUTL2",59,0)
 S:DFN J=J+1,MSGTAGS(J)="patientDfn`"_DFN
"RTN","MAGNUTL2",60,0)
 I $L($T(GETICN^MPIF001)) D
"RTN","MAGNUTL2",61,0)
 . S ICN=$$GETICN^MPIF001(DFN)
"RTN","MAGNUTL2",62,0)
 . S:ICN>1 J=J+1,MSGTAGS(J)="patientIcn`"_ICN
"RTN","MAGNUTL2",63,0)
 . Q
"RTN","MAGNUTL2",64,0)
 S J=J+1,MSGTAGS(J)="registration`1"     ; precache flag
"RTN","MAGNUTL2",65,0)
 ;
"RTN","MAGNUTL2",66,0)
 S TYPE="PRECACHE"
"RTN","MAGNUTL2",67,0)
 S SUBTYPE="REGISTRATION"
"RTN","MAGNUTL2",68,0)
 S STATUS="New"
"RTN","MAGNUTL2",69,0)
 S PRIORITY=0
"RTN","MAGNUTL2",70,0)
 ;
"RTN","MAGNUTL2",71,0)
 S PLACEID=$$STA^XUAF4(PLACEID) ;IA # 2171
"RTN","MAGNUTL2",72,0)
 ;
"RTN","MAGNUTL2",73,0)
 S CRTUSR=DUZ  ; CREATED BY
"RTN","MAGNUTL2",74,0)
 ;
"RTN","MAGNUTL2",75,0)
 S CRTAPP="PRECACHE"  ; CAPTURE APPLICATION
"RTN","MAGNUTL2",76,0)
 ;
"RTN","MAGNUTL2",77,0)
 D CRTITEM^MAGVIM01(.MAGOUT,TYPE,SUBTYPE,STATUS,PLACEID,PRIORITY,.MSGTAGS,CRTUSR,CRTAPP)
"RTN","MAGNUTL2",78,0)
 Q
"RTN","MAGNWRK1")
0^6^B51777875
"RTN","MAGNWRK1",1,0)
MAGNWRK1 ;WOIFO/NST - Work items calls ; JUN 25, 2018@13:36:00
"RTN","MAGNWRK1",2,0)
 ;;3.0;IMAGING;**201**;Dec 02, 2009;Build 163
"RTN","MAGNWRK1",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNWRK1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNWRK1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNWRK1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNWRK1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNWRK1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNWRK1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNWRK1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNWRK1",11,0)
 ;; |                                                               |
"RTN","MAGNWRK1",12,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNWRK1",13,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNWRK1",14,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNWRK1",15,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNWRK1",16,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNWRK1",17,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNWRK1",18,0)
 ;;
"RTN","MAGNWRK1",19,0)
 Q
"RTN","MAGNWRK1",20,0)
 ;
"RTN","MAGNWRK1",21,0)
NWI2005(MAGVOUT,MAGGDA)  ;Create a new MAG WORK ITEM for an image stored in IMAGE file (#2005)
"RTN","MAGNWRK1",22,0)
 ; MAGGDA - IEN in IMAGE file (#2005)
"RTN","MAGNWRK1",23,0)
 ;
"RTN","MAGNWRK1",24,0)
 ;
"RTN","MAGNWRK1",25,0)
 N CRTUSR,CRTAPP,DFN,ICN,IEN,J,MAGGRP,MSGTAGS,TYPE,SUBTYPE,STATUS,PLACEID,PRIORITY,Y,TMP
"RTN","MAGNWRK1",26,0)
 N MODALITY,MAGPDATA,REFTYPE,REFIEN
"RTN","MAGNWRK1",27,0)
 ;
"RTN","MAGNWRK1",28,0)
 S IEN=+$G(MAGGDA) Q:'IEN
"RTN","MAGNWRK1",29,0)
 ;
"RTN","MAGNWRK1",30,0)
 Q:$$GET1^DIQ(2005,IEN,1,"I")=""       ; FILEREF
"RTN","MAGNWRK1",31,0)
 S DFN=$$GET1^DIQ(2005,IEN,5,"I")      ; PATIENT
"RTN","MAGNWRK1",32,0)
 S MAGGRP=$$GET1^DIQ(2005,IEN,14,"I")  ; GROUP PARENT
"RTN","MAGNWRK1",33,0)
 ;
"RTN","MAGNWRK1",34,0)
 S PLACEID=$$GET1^DIQ(2005,IEN,.05,"I")  ; ACQUISITION SITE
"RTN","MAGNWRK1",35,0)
 S:'PLACEID PLACEID=DUZ(2)
"RTN","MAGNWRK1",36,0)
 ;
"RTN","MAGNWRK1",37,0)
 ; TAGS
"RTN","MAGNWRK1",38,0)
 S J=0
"RTN","MAGNWRK1",39,0)
 S J=J+1,MSGTAGS(J)="storage`2005"  ; image is in file #2005
"RTN","MAGNWRK1",40,0)
 S J=J+1,MSGTAGS(J)="imageIen`"_IEN  ; IMAGE IEN
"RTN","MAGNWRK1",41,0)
 S:MAGGRP J=J+1,MSGTAGS(J)="studyIen`"_MAGGRP   ; GRP IEN
"RTN","MAGNWRK1",42,0)
 S:DFN J=J+1,MSGTAGS(J)="patientDfn`"_DFN
"RTN","MAGNWRK1",43,0)
 I $L($T(GETICN^MPIF001)) D
"RTN","MAGNWRK1",44,0)
 . S ICN=$$GETICN^MPIF001(DFN)
"RTN","MAGNWRK1",45,0)
 . S:ICN>1 J=J+1,MSGTAGS(J)="patientIcn`"_ICN
"RTN","MAGNWRK1",46,0)
 . Q
"RTN","MAGNWRK1",47,0)
 S J=J+1,MSGTAGS(J)="acquisition`1"     ; precash flag
"RTN","MAGNWRK1",48,0)
 ;
"RTN","MAGNWRK1",49,0)
 S MAGPDATA=$$GET1^DIQ(2005,IEN,16,"I")  ; Parent Data File
"RTN","MAGNWRK1",50,0)
 S REFTYPE=$S(MAGPDATA=74:"RAD",MAGPDATA=8925:"TIU",1:"")
"RTN","MAGNWRK1",51,0)
 I REFTYPE'="" D
"RTN","MAGNWRK1",52,0)
 . S REFIEN=$$GET1^DIQ(2005,IEN,17,"I")
"RTN","MAGNWRK1",53,0)
 . S J=J+1,MSGTAGS(J)="contextId`"_$TR($$CPRSCTX^MAGNU003(REFTYPE,REFIEN),"^","~")  ; Create CPRS Context ID and translate ^ to ~
"RTN","MAGNWRK1",54,0)
 . Q
"RTN","MAGNWRK1",55,0)
 ;
"RTN","MAGNWRK1",56,0)
 S J=J+1,MSGTAGS(J)="imageFileName`"_$$FILENAME^MAGGAII(IEN,"FULL",.TMP)
"RTN","MAGNWRK1",57,0)
 S J=J+1,MSGTAGS(J)="imageShortDescr`"_$$GET1^DIQ(2005,IEN,10,"I")
"RTN","MAGNWRK1",58,0)
 S J=J+1,MSGTAGS(J)="imageObjectType`"_$$GET1^DIQ(2005,IEN,3,"I")
"RTN","MAGNWRK1",59,0)
 S MODALITY=$$MODALITY(IEN)
"RTN","MAGNWRK1",60,0)
 S:MODALITY'="" J=J+1,MSGTAGS(J)="imageModality`"_MODALITY
"RTN","MAGNWRK1",61,0)
 ;
"RTN","MAGNWRK1",62,0)
 S TYPE="PRECACHE"
"RTN","MAGNWRK1",63,0)
 S SUBTYPE="ACQUISITION"
"RTN","MAGNWRK1",64,0)
 S STATUS="New"
"RTN","MAGNWRK1",65,0)
 S PRIORITY=0
"RTN","MAGNWRK1",66,0)
 ;
"RTN","MAGNWRK1",67,0)
 S PLACEID=$$STA^XUAF4(PLACEID) ;IA # 2171
"RTN","MAGNWRK1",68,0)
 ;
"RTN","MAGNWRK1",69,0)
 S CRTUSR=$$GET1^DIQ(2005,IEN,8,"I")    ; IMAGE SAVE BY
"RTN","MAGNWRK1",70,0)
 S:'CRTUSR CRTUSR=DUZ
"RTN","MAGNWRK1",71,0)
 ;
"RTN","MAGNWRK1",72,0)
 S CRTAPP=$$GET1^DIQ(2005,IEN,8.1,"I")  ; CAPTURE APPLICATION
"RTN","MAGNWRK1",73,0)
 S CRTAPP=$S(CRTAPP="D":"DICOM",CRTAPP="C":"CAPTURE",1:"IMPORTER")
"RTN","MAGNWRK1",74,0)
 ;
"RTN","MAGNWRK1",75,0)
 D CRTITEM^MAGVIM01(.MAGVOUT,TYPE,SUBTYPE,STATUS,PLACEID,PRIORITY,.MSGTAGS,CRTUSR,CRTAPP)
"RTN","MAGNWRK1",76,0)
 Q
"RTN","MAGNWRK1",77,0)
 ;
"RTN","MAGNWRK1",78,0)
NWI34(MAGVOUT,PIEN,IEN)  ;  ;Create a new MAG WORK ITEM for an image stored in P34 stucture
"RTN","MAGNWRK1",79,0)
 ; PIEN = IEN in IMAGE SOP INSTANCE file (#2005.64)
"RTN","MAGNWRK1",80,0)
 ; IEN  = IMAGE INSTANCE FILE file (#2005.65)
"RTN","MAGNWRK1",81,0)
 ;
"RTN","MAGNWRK1",82,0)
 N CPRSCNTX,CRTUSR,CRTAPP,DFN,ICN,J,MAGGRP,MSGTAGS,TYPE,SUBTYPE,STATUS,PLACEID,PRIORITY,Y
"RTN","MAGNWRK1",83,0)
 N MAGAENT,MAGMODAL,REFTYPE,REFIEN
"RTN","MAGNWRK1",84,0)
 ;
"RTN","MAGNWRK1",85,0)
 S DFN=""
"RTN","MAGNWRK1",86,0)
 S MAGAENT=$$GET1^DIQ(2005.64,PIEN,"11:11:13:.02","I")  ; ASSIGNING AUTHORITY in file #2005.6
"RTN","MAGNWRK1",87,0)
 I MAGAENT="V" S DFN=$$GET1^DIQ(2005.64,PIEN,"11:11:13:.01","I")  ; ENTERPRISE PATIENT ID in file #2005.6
"RTN","MAGNWRK1",88,0)
 ;
"RTN","MAGNWRK1",89,0)
 S MAGMODAL=$$GET1^DIQ(2005.64,PIEN,"11:3","I")  ; MODALITY in file #2005.63
"RTN","MAGNWRK1",90,0)
 ;
"RTN","MAGNWRK1",91,0)
 S PLACEID=$$GET1^DIQ(2005.64,PIEN,"11:31:.01","I") ; ACQUISITION LOCATION in file #2005.63
"RTN","MAGNWRK1",92,0)
 S PLACEID=$S($P(PLACEID,";",2)="DIC(4,":+PLACEID,1:"")
"RTN","MAGNWRK1",93,0)
 S:'PLACEID PLACEID=DUZ(2)
"RTN","MAGNWRK1",94,0)
 ;
"RTN","MAGNWRK1",95,0)
 S MAGGRP=$$GET1^DIQ(2005.64,PIEN,"11:11","I")  ; Study IEN in file #2005.62
"RTN","MAGNWRK1",96,0)
 ;
"RTN","MAGNWRK1",97,0)
 ; TAGS
"RTN","MAGNWRK1",98,0)
 S J=0
"RTN","MAGNWRK1",99,0)
 S J=J+1,MSGTAGS(J)="storage`2005.64"  ; image is in P34 data structure
"RTN","MAGNWRK1",100,0)
 S J=J+1,MSGTAGS(J)="imageIen`"_PIEN  ; IEN in IMAGE SOP INSTANCE file (#2005.64)
"RTN","MAGNWRK1",101,0)
 S:MAGGRP J=J+1,MSGTAGS(J)="studyIen`"_MAGGRP   ;Study IEN in IMAGE STUDY file (#2005.62)
"RTN","MAGNWRK1",102,0)
 S:DFN J=J+1,MSGTAGS(J)="patientDfn`"_DFN
"RTN","MAGNWRK1",103,0)
 I $L($T(GETICN^MPIF001)) D
"RTN","MAGNWRK1",104,0)
 . S ICN=$$GETICN^MPIF001(DFN)
"RTN","MAGNWRK1",105,0)
 . S:ICN>1 J=J+1,MSGTAGS(J)="patientIcn`"_ICN
"RTN","MAGNWRK1",106,0)
 . Q
"RTN","MAGNWRK1",107,0)
 S:MAGMODAL'="" J=J+1,MSGTAGS(J)="modality`"_MAGMODAL   ; MODALITY in file #2005.63
"RTN","MAGNWRK1",108,0)
 ;
"RTN","MAGNWRK1",109,0)
 D AINST(.MSGTAGS,.J,IEN)  ; Add Add Artifact Instance tags
"RTN","MAGNWRK1",110,0)
 ;
"RTN","MAGNWRK1",111,0)
 S J=J+1,MSGTAGS(J)="acquisition`1"     ; precash flag
"RTN","MAGNWRK1",112,0)
 ;
"RTN","MAGNWRK1",113,0)
 S CPRSCNTX=$$CPRSCTXS(MAGGRP) ; Create CPRS Context ID by Study IEN
"RTN","MAGNWRK1",114,0)
 I CPRSCNTX'="" D
"RTN","MAGNWRK1",115,0)
 . S J=J+1,MSGTAGS(J)="contextId`"_$TR(CPRSCNTX,"^","~")  ; translate ^ to ~ 
"RTN","MAGNWRK1",116,0)
 . Q
"RTN","MAGNWRK1",117,0)
 ;
"RTN","MAGNWRK1",118,0)
 S TYPE="PRECACHE"
"RTN","MAGNWRK1",119,0)
 S SUBTYPE="ACQUISITION"
"RTN","MAGNWRK1",120,0)
 S STATUS="New"
"RTN","MAGNWRK1",121,0)
 S PRIORITY=0
"RTN","MAGNWRK1",122,0)
 S PLACEID=$$STA^XUAF4(PLACEID) ;IA # 2171
"RTN","MAGNWRK1",123,0)
 ;
"RTN","MAGNWRK1",124,0)
 S CRTUSR=""    ; IMAGE SAVE BY
"RTN","MAGNWRK1",125,0)
 S:'CRTUSR CRTUSR=DUZ
"RTN","MAGNWRK1",126,0)
 ;
"RTN","MAGNWRK1",127,0)
 S CRTAPP="D"  ; CAPTURE APPLICATION
"RTN","MAGNWRK1",128,0)
 S CRTAPP=$S(CRTAPP="D":"DICOM",CRTAPP="C":"CAPTURE",1:"IMPORTER")
"RTN","MAGNWRK1",129,0)
 ;
"RTN","MAGNWRK1",130,0)
 D CRTITEM^MAGVIM01(.MAGVOUT,TYPE,SUBTYPE,STATUS,PLACEID,PRIORITY,.MSGTAGS,CRTUSR,CRTAPP)
"RTN","MAGNWRK1",131,0)
 Q
"RTN","MAGNWRK1",132,0)
 ;
"RTN","MAGNWRK1",133,0)
CPRSCTXS(STUDYIEN) ; Get CPRS context by Study IEN in IMAGE STUDY file (#2005.62)
"RTN","MAGNWRK1",134,0)
 N ACNUMB,CONTEXT,REFTYPE,REFIEN
"RTN","MAGNWRK1",135,0)
 S ACNUMB=$$GET1^DIQ(2005.62,STUDYIEN,.02,"I")
"RTN","MAGNWRK1",136,0)
 D REFBYACN^MAGNU003(.REFTYPE,.REFIEN,ACNUMB)  ; Set Reference type by Accession Number
"RTN","MAGNWRK1",137,0)
 S CONTEXT=$$CPRSCTX^MAGNU003(REFTYPE,REFIEN)
"RTN","MAGNWRK1",138,0)
 Q CONTEXT
"RTN","MAGNWRK1",139,0)
 ;
"RTN","MAGNWRK1",140,0)
AINST(MSGTAGS,J,INSTIEN)  ; Add Artifact Instance 
"RTN","MAGNWRK1",141,0)
 ; INSTIEN = IEN in IMAGE INSTANCE FILE file (#2005.65)
"RTN","MAGNWRK1",142,0)
 ;
"RTN","MAGNWRK1",143,0)
 N CNT,KEY,VALUE,LINE,IEN,I,RES,TMPARR,TOKEN,QT
"RTN","MAGNWRK1",144,0)
 S TOKEN=$$GET1^DIQ(2005.65,INSTIEN,.01,"I") ; Artifact Token
"RTN","MAGNWRK1",145,0)
 D GETAIENT^MAGVAG02(.RES,TOKEN,"") ; Get not deleted Artifact IEN by Token
"RTN","MAGNWRK1",146,0)
 I '$$ISOK^MAGVAF02(RES) Q
"RTN","MAGNWRK1",147,0)
 S IEN=$$GETVAL^MAGVAF02(RES)
"RTN","MAGNWRK1",148,0)
 D GETAINST^MAGVAG04(.TMPARR,IEN)
"RTN","MAGNWRK1",149,0)
 I '$$ISOK^MAGVAF02(TMPARR(0)) Q
"RTN","MAGNWRK1",150,0)
 S QT=$C(34)
"RTN","MAGNWRK1",151,0)
 S CNT=0
"RTN","MAGNWRK1",152,0)
 S I=1
"RTN","MAGNWRK1",153,0)
 F  S I=$O(TMPARR(I)) Q:'I  S LINE=TMPARR(I) Q:LINE["</ARTIFACTINSTANCES"  D
"RTN","MAGNWRK1",154,0)
 . I LINE["<ARTIFACTINSTANCE" S CNT=CNT+1 Q
"RTN","MAGNWRK1",155,0)
 . I LINE["</ARTIFACTINSTANCE" Q
"RTN","MAGNWRK1",156,0)
 . S KEY=$P(TMPARR(I),"=",1)
"RTN","MAGNWRK1",157,0)
 . S VALUE=$TR($P(TMPARR(I),"=",2),QT,"")
"RTN","MAGNWRK1",158,0)
 . S VALUE=$P(VALUE," >")  ; special handling because of XML result set
"RTN","MAGNWRK1",159,0)
 . I (KEY="PK")!(KEY="ARTIFACT")!(KEY="DISKVOLUME") S J=J+1,MSGTAGS(J)="ai_"_KEY_"_"_CNT_"`"_VALUE
"RTN","MAGNWRK1",160,0)
 . I KEY="STORAGEPROVIDER" D  ; Add Storage provider name
"RTN","MAGNWRK1",161,0)
 . . S J=J+1,MSGTAGS(J)="ai_storeProvType_"_CNT_"`"_$$GET1^DIQ(2006.917,VALUE,"2")
"RTN","MAGNWRK1",162,0)
 . . Q
"RTN","MAGNWRK1",163,0)
 . Q
"RTN","MAGNWRK1",164,0)
 Q
"RTN","MAGNWRK1",165,0)
 ;
"RTN","MAGNWRK1",166,0)
MODALITY(IMGIEN)  ; Get Image modality
"RTN","MAGNWRK1",167,0)
 N G,M,P,MAGFILD,MAGFILG,X
"RTN","MAGNWRK1",168,0)
 S MAGFILD=$$FILE^MAGGI11(IMGIEN)
"RTN","MAGNWRK1",169,0)
 S X=$S(MAGFILD:$G(^MAG(MAGFILD,IMGIEN,0)),1:"")
"RTN","MAGNWRK1",170,0)
 S G=+$P(X,"^",10) ;Group IEN
"RTN","MAGNWRK1",171,0)
 S M=$P(X,"^",8)   ;Procedure
"RTN","MAGNWRK1",172,0)
 S:$E(M,1,4)="RAD " M=$E(M,5,$L(M))
"RTN","MAGNWRK1",173,0)
 Q:M="" ""
"RTN","MAGNWRK1",174,0)
 S MAGFILG=$$FILE^MAGGI11(G)
"RTN","MAGNWRK1",175,0)
 S G=$S(MAGFILG:$P($G(^MAG(MAGFILG,G,2)),"^",6),1:"") ;Parent Data File# for Group IEN
"RTN","MAGNWRK1",176,0)
 S P=$S(MAGFILD:$P($G(^MAG(MAGFILD,IMGIEN,2)),"^",6),1:"") ;Parent Data File# for IEN
"RTN","MAGNWRK1",177,0)
 I P'=74,G'=74 Q ""  ;quit if not RAD/NUC MED REPORTS file (#74)
"RTN","MAGNWRK1",178,0)
 Q M
"RTN","MAGNAN01")
0^7^B23808502
"RTN","MAGNAN01",1,0)
MAGNAN01 ;WOIFO/NST - IMAGING ANNOTATION UTILITY RPCS ; 07 May 2018 11:43 AM
"RTN","MAGNAN01",2,0)
 ;;3.0;IMAGING;**185,201**;Mar 19, 2002;Build 92;Aug 02, 2012
"RTN","MAGNAN01",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNAN01",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNAN01",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNAN01",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNAN01",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNAN01",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNAN01",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNAN01",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNAN01",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNAN01",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNAN01",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNAN01",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNAN01",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNAN01",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNAN01",17,0)
 ;;
"RTN","MAGNAN01",18,0)
 Q
"RTN","MAGNAN01",19,0)
 ;
"RTN","MAGNAN01",20,0)
 ;***** STORES THE DETAIL OF STUDY ANNOTATION
"RTN","MAGNAN01",21,0)
 ;
"RTN","MAGNAN01",22,0)
 ; RPC: MAGN ANNOT STORE STUDY
"RTN","MAGNAN01",23,0)
 ;
"RTN","MAGNAN01",24,0)
 ; .MAGOUT       Reference to a local variable where the results are returned to
"RTN","MAGNAN01",25,0)
 ; .MAGPARAM
"RTN","MAGNAN01",26,0)
 ;    MAGPARAM("STUDY UID")
"RTN","MAGNAN01",27,0)
 ;    MAGPARAM("PSTATE UID")
"RTN","MAGNAN01",28,0)
 ;    MAGPARAM("NAME")
"RTN","MAGNAN01",29,0)
 ;    MAGPARAM("SOURCE")
"RTN","MAGNAN01",30,0)
 ;    MAGPARAM("TOOL VERSION")
"RTN","MAGNAN01",31,0)
 ;    MAGPARAM(1..n)  Annotation Data (XML/JSON)
"RTN","MAGNAN01",32,0)
 ;
"RTN","MAGNAN01",33,0)
 ; Return Values
"RTN","MAGNAN01",34,0)
 ; =============   
"RTN","MAGNAN01",35,0)
 ; MAGOUT(0) is defined and its 1st '^'-piece is 0, then an error
"RTN","MAGNAN01",36,0)
 ;   occurred during execution of the procedure.
"RTN","MAGNAN01",37,0)
 ; MAGOUT(0) = Success status - success 
"RTN","MAGNAN01",38,0)
 ;             Failure status - error
"RTN","MAGNAN01",39,0)
STORE(MAGOUT,MAGPARAM) ;RPC [MAGN ANNOT STORE STUDY]
"RTN","MAGNAN01",40,0)
 N MAGNFDA,MAGNXE,IENS,STUDYIEN,STUDYID,PSTATIEN,PSTATUID,EXIT
"RTN","MAGNAN01",41,0)
 ;
"RTN","MAGNAN01",42,0)
 ; Set input variables
"RTN","MAGNAN01",43,0)
 S STUDYID=$G(MAGPARAM("STUDY UID"))
"RTN","MAGNAN01",44,0)
 S PSTATUID=$G(MAGPARAM("PSTATE UID"))
"RTN","MAGNAN01",45,0)
 ;
"RTN","MAGNAN01",46,0)
 K MAGOUT
"RTN","MAGNAN01",47,0)
 S MAGOUT(0)=$$SETERROR^MAGNU002("")
"RTN","MAGNAN01",48,0)
 I '$G(DUZ) S MAGOUT(0)=$$SETERROR^MAGNU002("No DUZ defined") Q
"RTN","MAGNAN01",49,0)
 I STUDYID="" S MAGOUT(0)=$$SETERROR^MAGNU002("No STUDYID") Q
"RTN","MAGNAN01",50,0)
 I PSTATUID="" S MAGOUT(0)=$$SETERROR^MAGNU002("No PSTATEUID") Q
"RTN","MAGNAN01",51,0)
 S STUDYIEN=$$FIND1^DIC(2005.003,"","X",STUDYID,"","","MAGNXE")
"RTN","MAGNAN01",52,0)
 I $$ISERROR^MAGNU002(.MAGOUT,.MAGNXE) Q   ; Set MAGOUT and quit if error exists
"RTN","MAGNAN01",53,0)
 I 'STUDYIEN D  ; Create Study record
"RTN","MAGNAN01",54,0)
 . S IENS="+1,"
"RTN","MAGNAN01",55,0)
 . S MAGNFDA(2005.003,IENS,.01)=STUDYID
"RTN","MAGNAN01",56,0)
 . D UPDATE^DIE("","MAGNFDA","MAGNIEN","MAGNXE")
"RTN","MAGNAN01",57,0)
 . I $$ISERROR^MAGNU002(.MAGOUT,.MAGNXE) Q
"RTN","MAGNAN01",58,0)
 . ; What is the Image IEN D ENTRY^MAGLOG("MAG ANNOT",$G(DUZ),IEN,"MAG IMAGE ANNOTATION","","1",$G(SOURCE,"CLINIC")) ;log annotation
"RTN","MAGNAN01",59,0)
 . S STUDYIEN=MAGNIEN(1)
"RTN","MAGNAN01",60,0)
 . Q
"RTN","MAGNAN01",61,0)
 ;
"RTN","MAGNAN01",62,0)
 I $D(MAGNXE) Q  ; MAGOUT is aleady set with the error
"RTN","MAGNAN01",63,0)
 ;
"RTN","MAGNAN01",64,0)
 S PSTATIEN=$$FIND1^DIC(2005.0031,","_STUDYIEN_",","X",PSTATUID,"","","MAGNXE")
"RTN","MAGNAN01",65,0)
 I $$ISERROR^MAGNU002(.MAGOUT,.MAGNXE) Q  ; Set MAGOUT and quit if error exists
"RTN","MAGNAN01",66,0)
 ;
"RTN","MAGNAN01",67,0)
 I 'PSTATIEN D  Q  ; Create a new annotation record for the study and quit
"RTN","MAGNAN01",68,0)
 . S PSTATIEN=$$UPDATE(.MAGOUT,STUDYIEN,"+2",.MAGPARAM)
"RTN","MAGNAN01",69,0)
 . Q
"RTN","MAGNAN01",70,0)
 ;
"RTN","MAGNAN01",71,0)
 I $G(MAGPARAM("DELETED")) D  Q
"RTN","MAGNAN01",72,0)
 . S EXIT=$$DELANNOT(.MAGOUT,STUDYIEN,PSTATIEN)
"RTN","MAGNAN01",73,0)
 . Q
"RTN","MAGNAN01",74,0)
 ;
"RTN","MAGNAN01",75,0)
 S EXIT=$$UPDATE(.MAGOUT,STUDYIEN,PSTATIEN,.MAGPARAM)
"RTN","MAGNAN01",76,0)
 ; MAGOUT is set at this point
"RTN","MAGNAN01",77,0)
 Q
"RTN","MAGNAN01",78,0)
 ; 
"RTN","MAGNAN01",79,0)
UPDATE(MAGOUT,IEN0,IEN1,MAGPARAM) ; Add new annotation data node w/ DUZ, version, data ...
"RTN","MAGNAN01",80,0)
 N ANNOT,ANSITE,ANSERV,STUDYID,PSTATUID,NAME,SOURCE,VER
"RTN","MAGNAN01",81,0)
 N I,MAGNFDA,MAGNIEN,MAGNXE
"RTN","MAGNAN01",82,0)
 ;
"RTN","MAGNAN01",83,0)
 ; Set input variables
"RTN","MAGNAN01",84,0)
 S PSTATUID=$G(MAGPARAM("PSTATE UID"))
"RTN","MAGNAN01",85,0)
 S NAME=$G(MAGPARAM("NAME"))
"RTN","MAGNAN01",86,0)
 S SOURCE=$G(MAGPARAM("SOURCE"))
"RTN","MAGNAN01",87,0)
 S VER=$G(MAGPARAM("TOOL VERSION"))
"RTN","MAGNAN01",88,0)
 S I=0
"RTN","MAGNAN01",89,0)
 F  S I=$O(MAGPARAM(I)) Q:'I  D
"RTN","MAGNAN01",90,0)
 . S ANNOT(I)=MAGPARAM(I)
"RTN","MAGNAN01",91,0)
 . Q
"RTN","MAGNAN01",92,0)
 ;
"RTN","MAGNAN01",93,0)
 S ANSITE=$G(DUZ(2))  ; Annotation Site
"RTN","MAGNAN01",94,0)
 S ANSERV=$$GET1^DIQ(200,DUZ,29,"I")  ; Annotation service
"RTN","MAGNAN01",95,0)
 ;
"RTN","MAGNAN01",96,0)
 S IENS=IEN1_","_IEN0_","
"RTN","MAGNAN01",97,0)
 S:$E(IEN0)'="+" MAGNIEN(1)=IEN0
"RTN","MAGNAN01",98,0)
 S:$E(IEN1)'="+" MAGNIEN(2)=IEN1
"RTN","MAGNAN01",99,0)
 K MAGNFDA
"RTN","MAGNAN01",100,0)
 S MAGNFDA(2005.0031,IENS,.01)=$G(MAGPARAM("PSTATE UID"))
"RTN","MAGNAN01",101,0)
 S MAGNFDA(2005.0031,IENS,1)=DUZ           ;ANNOTATOR
"RTN","MAGNAN01",102,0)
 S:$D(ANNOT) MAGNFDA(2005.0031,IENS,2)=$$NOW^XLFDT() ;SAVE D/T
"RTN","MAGNAN01",103,0)
 S:VER'="" MAGNFDA(2005.0031,IENS,3)=VER           ;VERSION
"RTN","MAGNAN01",104,0)
 S MAGNFDA(2005.0031,IENS,4)=$G(SOURCE,"CLINIC")
"RTN","MAGNAN01",105,0)
 S MAGNFDA(2005.0031,IENS,7)=ANSERV     ;SERVICE/SECTION
"RTN","MAGNAN01",106,0)
 S MAGNFDA(2005.0031,IENS,8)=ANSITE     ;SITE
"RTN","MAGNAN01",107,0)
 S:NAME'="" MAGNFDA(2005.0031,IENS,9)=NAME           ;Annotation name
"RTN","MAGNAN01",108,0)
 D UPDATE^DIE("","MAGNFDA","MAGNIEN","MAGNXE")
"RTN","MAGNAN01",109,0)
 I $$ISERROR^MAGNU002(.MAGOUT,.MAGNXE) Q 0
"RTN","MAGNAN01",110,0)
 ;
"RTN","MAGNAN01",111,0)
 I '$D(ANNOT) Q MAGNIEN(2)
"RTN","MAGNAN01",112,0)
 S IENS=MAGNIEN(2)_","_IEN0_","
"RTN","MAGNAN01",113,0)
 ; Annotation data 2005.003 field #6
"RTN","MAGNAN01",114,0)
 D WP^DIE(2005.0031,IENS,6,"","ANNOT","MAGNXE")
"RTN","MAGNAN01",115,0)
 I $$ISERROR^MAGNU002(.MAGOUT,.MAGNXE) D  Q 0
"RTN","MAGNAN01",116,0)
 . N DA,DIK
"RTN","MAGNAN01",117,0)
 . ; clean up data
"RTN","MAGNAN01",118,0)
 . S DIK="^MAG(2005.003,"_IEN0_",1,",DA=IEN1,DA(1)=IEN0
"RTN","MAGNAN01",119,0)
 . D ^DIK
"RTN","MAGNAN01",120,0)
 . Q
"RTN","MAGNAN01",121,0)
 ;
"RTN","MAGNAN01",122,0)
 Q MAGNIEN(2)
"RTN","MAGNAN01",123,0)
 ;
"RTN","MAGNAN01",124,0)
DELANNOT(MAGOUT,IEN0,IEN1)  ; Set Deleted flag
"RTN","MAGNAN01",125,0)
 N IENS,MAGNFDA,MAGNIEN,MAGNXE
"RTN","MAGNAN01",126,0)
 ;
"RTN","MAGNAN01",127,0)
 S IENS=IEN1_","_IEN0_","
"RTN","MAGNAN01",128,0)
 K MAGNFDA
"RTN","MAGNAN01",129,0)
 S MAGNFDA(2005.0031,IENS,5)=1
"RTN","MAGNAN01",130,0)
 D UPDATE^DIE("","MAGNFDA","MAGNIEN","MAGNXE")
"RTN","MAGNAN01",131,0)
 I $$ISERROR^MAGNU002(.MAGOUT,.MAGNXE) Q 0
"RTN","MAGNAN01",132,0)
 ;
"RTN","MAGNAN01",133,0)
 Q 1
"RTN","MAGVRS41")
0^8^B187565067
"RTN","MAGVRS41",1,0)
MAGVRS41 ;WOIFO/DAC,MLH,NST - Utilities for RPC calls for DICOM file processing ; 08 May 2018 10:41 AM
"RTN","MAGVRS41",2,0)
 ;;3.0;IMAGING;**118,201**;Mar 19, 2002;Build 4525;May 01, 2013
"RTN","MAGVRS41",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGVRS41",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVRS41",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGVRS41",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGVRS41",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGVRS41",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGVRS41",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGVRS41",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGVRS41",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGVRS41",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGVRS41",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGVRS41",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGVRS41",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGVRS41",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVRS41",17,0)
 ;;
"RTN","MAGVRS41",18,0)
 Q
"RTN","MAGVRS41",19,0)
INPUTSEP() ; Name value separator for input data  ie. NAME`TESTPATIENT
"RTN","MAGVRS41",20,0)
 Q "`"
"RTN","MAGVRS41",21,0)
OUTSEP() ; Name value separator for output data ie. NAME|TESTPATIENT
"RTN","MAGVRS41",22,0)
 Q "|"
"RTN","MAGVRS41",23,0)
STATSEP() ; Status and Result separator ie. -3``No record IEN  
"RTN","MAGVRS41",24,0)
 Q "`"
"RTN","MAGVRS41",25,0)
UPDATE(OUT,FILE,ATTS,OVERRIDE) ; Update Attributes
"RTN","MAGVRS41",26,0)
 N FDA,IEN,DATETIME,UIEN,UFILE,FIELDERR
"RTN","MAGVRS41",27,0)
 ; If File is out of range quit with error
"RTN","MAGVRS41",28,0)
 S OSEP=$$OUTSEP,ISEP=$$INPUTSEP,SSEP=$$STATSEP
"RTN","MAGVRS41",29,0)
 I (FILE<2005.6)!(FILE>2005.65) S OUT(1)="-1"_SSEP_"File is not in the 2005.6 to 2005.65 range" Q
"RTN","MAGVRS41",30,0)
 ; If first attribute is not the update record's IEN quit with error
"RTN","MAGVRS41",31,0)
 I $P($G(ATTS(1)),ISEP,1)'["IEN" S OUT(1)="-2"_SSEP_"No record IEN" Q
"RTN","MAGVRS41",32,0)
 S IEN=$P(ATTS(1),ISEP,2) K ATTS(1)
"RTN","MAGVRS41",33,0)
 I (IEN<1)!(IEN>($O(^MAGV(FILE," "),-1))) S OUT(1)="-6"_SSEP_"Invalid IEN" Q
"RTN","MAGVRS41",34,0)
 I FILE'=2005.6 D  Q:$D(OUT(1))  ; logic for files with parents only!
"RTN","MAGVRS41",35,0)
 . I '$G(OVERRIDE) D  Q:$D(OUT(1))
"RTN","MAGVRS41",36,0)
 . . I $P($G(ATTS(2)),ISEP,1)'["REFERENCE" S OUT(1)="-2"_SSEP_"No record IEN" Q
"RTN","MAGVRS41",37,0)
 . . S PIEN=$P(ATTS(2),ISEP,2)
"RTN","MAGVRS41",38,0)
 . . Q
"RTN","MAGVRS41",39,0)
 . I '$G(IEN) S OUT(1)="-1"_SSEP_"No IEN" Q
"RTN","MAGVRS41",40,0)
 . I '$G(OVERRIDE),'$$PARENT(FILE,IEN,PIEN) S OUT(1)="-9"_SSEP_"Parent Record not verified" Q
"RTN","MAGVRS41",41,0)
 . ; Check for STATUS INACCESSIBLE 
"RTN","MAGVRS41",42,0)
 . I $G(PIEN),((FILE=2005.63)!(FILE=2005.64)) D  Q:$D(OUT(1))
"RTN","MAGVRS41",43,0)
 . . N PFILE,STATUS
"RTN","MAGVRS41",44,0)
 . . I FILE=2005.63 S PFILE=2005.62
"RTN","MAGVRS41",45,0)
 . . I FILE=2005.64 S PFILE=2005.63
"RTN","MAGVRS41",46,0)
 . . S STATUS=$$GET1^DIQ(PFILE,PIEN,"STATUS","I")
"RTN","MAGVRS41",47,0)
 . . I STATUS="I" S OUT(1)="-100"_SSEP_"Parent status is Inaccessible."
"RTN","MAGVRS41",48,0)
 . . Q
"RTN","MAGVRS41",49,0)
 . Q
"RTN","MAGVRS41",50,0)
 S ATTS($O(ATTS(" "),-1)+1)="STATUS"_ISEP_"A" ; update always (re)activates
"RTN","MAGVRS41",51,0)
 D SETFDA^MAGVRS44(FILE,.ATTS,IEN_",",.FDA,.FIELDERR,1)
"RTN","MAGVRS41",52,0)
 D FILE^DIE("","FDA","ERR")
"RTN","MAGVRS41",53,0)
 I $D(ERR("DIERR")) S OUT(1)="-6"_SSEP_$G(ERR("DIERR",1,"TEXT",1))
"RTN","MAGVRS41",54,0)
 I $D(ERR("DIERR")) Q
"RTN","MAGVRS41",55,0)
 K FDA,ERR
"RTN","MAGVRS41",56,0)
 I FILE=2005.65,$G(PIEN)'="" D AOFSET(PIEN,IEN)
"RTN","MAGVRS41",57,0)
 ;Update last update for record and parents
"RTN","MAGVRS41",58,0)
 S DATETIME=$$NOW^XLFDT
"RTN","MAGVRS41",59,0)
 S UIEN=IEN,UFILE=FILE
"RTN","MAGVRS41",60,0)
 F UFILE=UFILE:-.01:2005.62 Q:'UIEN  D
"RTN","MAGVRS41",61,0)
 . I FILE'=2005.65 D
"RTN","MAGVRS41",62,0)
 . . S FDA(UFILE,UIEN_",",$$GETFIELD(UFILE,"LAST UPDATE DATE/TIME"))=DATETIME
"RTN","MAGVRS41",63,0)
 . . D FILE^DIE("","FDA","ERR")
"RTN","MAGVRS41",64,0)
 . . I $D(ERR("DIERR")) S OUT(1)="-3"_SSEP_$G(ERR("DIERR",1,"TEXT",1))
"RTN","MAGVRS41",65,0)
 . . I $D(ERR("DIERR")) Q
"RTN","MAGVRS41",66,0)
 . . K FDA,ERR
"RTN","MAGVRS41",67,0)
 . . Q
"RTN","MAGVRS41",68,0)
 . I UIEN S PIEN=+$G(^MAGV(UFILE,UIEN,6))
"RTN","MAGVRS41",69,0)
 . Q
"RTN","MAGVRS41",70,0)
 S OUT(1)="0"_SSEP_$G(FIELDERR)_SSEP_IEN
"RTN","MAGVRS41",71,0)
 Q
"RTN","MAGVRS41",72,0)
ATTACH(OUT,FILE,ATTS) ; Create record; attach to parent record if applicable
"RTN","MAGVRS41",73,0)
 ; Input Variables: 
"RTN","MAGVRS41",74,0)
 ;                 FILE - File number of record
"RTN","MAGVRS41",75,0)
 ;                 ATTS - Array of name value pairs separated by an input separator
"RTN","MAGVRS41",76,0)
 ; Output Variables:
"RTN","MAGVRS41",77,0)
 ;                 OUT  - Returns success and new record IEN or error and error message 
"RTN","MAGVRS41",78,0)
 N FDA,OSEP,ISEP,SSEP,NAM,VAL,ATTNAMS,KEYFLD,UATT,IEN,STATUS,NEWATTS,I
"RTN","MAGVRS41",79,0)
 N PIEN,PPIEN,PFILE,ERR,CIEN,UID,UIEN,DATETIME,KEYNAM,FIELDERR,DFN,DEVFDA,DEVICE
"RTN","MAGVRS41",80,0)
 S OSEP=$$OUTSEP,ISEP=$$INPUTSEP,SSEP=$$STATSEP
"RTN","MAGVRS41",81,0)
 ; If file out of range quit with error
"RTN","MAGVRS41",82,0)
 I (FILE<2005.6)!(FILE>2005.65) S OUT(1)="-4"_SSEP_"File is not in the 2005.6 to 2005.65 range" Q 
"RTN","MAGVRS41",83,0)
 ; If atts not defined quit with error
"RTN","MAGVRS41",84,0)
 S I=0
"RTN","MAGVRS41",85,0)
 F  S I=$O(ATTS(I)) Q:'I  D  Q:$D(OUT(1))
"RTN","MAGVRS41",86,0)
 . S NAM=$P(ATTS(I),ISEP,1),VAL=$P(ATTS(I),ISEP,2)
"RTN","MAGVRS41",87,0)
 . I NAM="" S OUT(1)="-64"_SSEP_"Attribute name(s) missing from attribute array" Q
"RTN","MAGVRS41",88,0)
 . S ATTNAMS(NAM)=VAL
"RTN","MAGVRS41",89,0)
 . Q
"RTN","MAGVRS41",90,0)
 Q:$D(OUT(1))
"RTN","MAGVRS41",91,0)
 S KEYNAM=$$GET1^DID(FILE,.01,,"LABEL"),(UATT,KEYFLD(.01))=$G(ATTNAMS(KEYNAM))
"RTN","MAGVRS41",92,0)
 S KEYFLD(.01,"GSL")=$$GET1^DID(FILE,.01,,"GLOBAL SUBSCRIPT LOCATION")
"RTN","MAGVRS41",93,0)
 ; Set PIEN (parent IEN)
"RTN","MAGVRS41",94,0)
 I FILE=2005.61 S PIEN=$G(ATTNAMS("PATIENT REFERENCE")),PFILE=2005.6
"RTN","MAGVRS41",95,0)
 I FILE=2005.62 S PIEN=$G(ATTNAMS("PROCEDURE REFERENCE")),PFILE=2005.61
"RTN","MAGVRS41",96,0)
 I FILE=2005.63 S PIEN=$G(ATTNAMS("STUDY REFERENCE")),PFILE=2005.62
"RTN","MAGVRS41",97,0)
 I FILE=2005.64 S PIEN=$G(ATTNAMS("SERIES REFERENCE")),PFILE=2005.63
"RTN","MAGVRS41",98,0)
 I FILE=2005.65 S PIEN=$G(ATTNAMS("SOP INSTANCE REFERENCE")),PFILE=2005.64
"RTN","MAGVRS41",99,0)
 ; Check for STATUS INACCESSIBLE 
"RTN","MAGVRS41",100,0)
 I (FILE=2005.63)!(FILE=2005.64) D  Q:$D(OUT(1))
"RTN","MAGVRS41",101,0)
 . S STATUS=$$GET1^DIQ(PFILE,PIEN,"STATUS","I")
"RTN","MAGVRS41",102,0)
 . I STATUS="I" S OUT(1)="-100"_SSEP_"Parent status is Inaccessible."
"RTN","MAGVRS41",103,0)
 . Q
"RTN","MAGVRS41",104,0)
 ; File DEVICE MANUFACTURER and DEVICE MODEL as ACQUISITION DEVICE in file 2005.63
"RTN","MAGVRS41",105,0)
 I FILE=2005.63 D
"RTN","MAGVRS41",106,0)
 . ; Remove parentheses from DEVICE MANUFACTOR and DEVICE MODEL and concatenate DEVICE and place model in parentheses
"RTN","MAGVRS41",107,0)
 . S DEVMAN=$G(ATTNAMS("DEVICE MANUFACTURER"))
"RTN","MAGVRS41",108,0)
 . S DEVMODEL=$G(ATTNAMS("DEVICE MODEL"))
"RTN","MAGVRS41",109,0)
 . S DEVICE=DEVMAN_" ("_DEVMODEL_")"
"RTN","MAGVRS41",110,0)
 . ; If the device is not in 2006.04 add device
"RTN","MAGVRS41",111,0)
 . I '$D(^MAG(2006.04,"B",DEVICE)) D
"RTN","MAGVRS41",112,0)
 . . S DEVFDA(2006.04,"+1,",.01)=DEVICE
"RTN","MAGVRS41",113,0)
 . . D UPDATE^DIE("","DEVFDA","","DEVERR")
"RTN","MAGVRS41",114,0)
 . . Q
"RTN","MAGVRS41",115,0)
 . ; If the device is in 2006.04 get IEN of entry
"RTN","MAGVRS41",116,0)
 . S DEVIEN=$O(^MAG(2006.04,"B",DEVICE,""))
"RTN","MAGVRS41",117,0)
 . S ATTS($O(ATTS(" "),-1)+1)="DEVICE"_ISEP_DEVIEN
"RTN","MAGVRS41",118,0)
 . K ATTNAMS("DEVICE MANUFACTURER"),ATTNAMS("DEVICE MODEL")
"RTN","MAGVRS41",119,0)
 . Q
"RTN","MAGVRS41",120,0)
 D:('$D(ATTNAMS("ARTIFACT ON FILE")))&(FILE'=2005.65)
"RTN","MAGVRS41",121,0)
 . S ATTNAMS("ARTIFACT ON FILE")=0
"RTN","MAGVRS41",122,0)
 . S ATTS($O(ATTS(" "),-1)+1)="ARTIFACT ON FILE"_ISEP_0
"RTN","MAGVRS41",123,0)
 . Q
"RTN","MAGVRS41",124,0)
 I $G(UATT)="" S OUT(1)="-5"_SSEP_"Unique identifier not provided" Q
"RTN","MAGVRS41",125,0)
 ; If a patient ID is assigned by the VA set the PATIENT pointer
"RTN","MAGVRS41",126,0)
 I FILE=2005.6,$G(ATTNAMS("ASSIGNING AUTHORITY"))="V" D
"RTN","MAGVRS41",127,0)
 . S DFN=$G(ATTNAMS("ENTERPRISE PATIENT ID"))
"RTN","MAGVRS41",128,0)
 . I DFN'="" S ATTS($O(ATTS(" "),-1)+1)="PATIENT FILE REFERENCE"_ISEP_DFN
"RTN","MAGVRS41",129,0)
 . Q
"RTN","MAGVRS41",130,0)
 ;
"RTN","MAGVRS41",131,0)
 ; Quit with error if no assigning authority provided for a Procedure Reference
"RTN","MAGVRS41",132,0)
 I FILE=2005.61,$G(ATTNAMS("ASSIGNING AUTHORITY"))="" S OUT(1)="-5"_SSEP_"No ASSIGNING AUTHORITY provided." Q
"RTN","MAGVRS41",133,0)
 ;
"RTN","MAGVRS41",134,0)
 ; If entry exists for Patient or Procedure then it is an update
"RTN","MAGVRS41",135,0)
 D  Q:$G(IEN)  Q:$D(OUT(1))  ; Patient or procedure update?
"RTN","MAGVRS41",136,0)
 . ; Add multi-key (already checked .01)
"RTN","MAGVRS41",137,0)
 . I (FILE=2005.6)!(FILE=2005.61) D ADDMKEYS^MAGVRS46(.OUT,FILE,.ATTNAMS,.KEYFLD) Q:$D(OUT(1))
"RTN","MAGVRS41",138,0)
 . ;
"RTN","MAGVRS41",139,0)
 . S IEN=$$MATCH^MAGVRS46(FILE,UATT,$G(PIEN),.KEYFLD) ; Find match by keys
"RTN","MAGVRS41",140,0)
 . Q:'IEN  ; no exact match, create new
"RTN","MAGVRS41",141,0)
 . ;
"RTN","MAGVRS41",142,0)
 . S STATUS=$$GET1^DIQ(FILE,IEN,"STATUS","I")
"RTN","MAGVRS41",143,0)
 . I (FILE>2005.6),(PIEN'=+$G(^MAGV(FILE,IEN,6))) D  Q
"RTN","MAGVRS41",144,0)
 . . I STATUS="A" S OUT(1)="-66"_SSEP_"Parent IEN does not match parent IEN of record on file"
"RTN","MAGVRS41",145,0)
 . . E  S IEN=""   ; STATUS="I"  INACCESSIBLE
"RTN","MAGVRS41",146,0)
 . . Q
"RTN","MAGVRS41",147,0)
 . I STATUS'="I" S OUT(1)="-63"_SSEP_"Active reference with same unique ID already exists" Q
"RTN","MAGVRS41",148,0)
 . S NEWATTS(1)="IEN"_ISEP_IEN
"RTN","MAGVRS41",149,0)
 . F I=1:1 Q:'$D(ATTS(I))  S NEWATTS(I+1)=ATTS(I)
"RTN","MAGVRS41",150,0)
 . S NEWATTS($O(NEWATTS(" "),-1)+1)="STATUS"_ISEP_"A"
"RTN","MAGVRS41",151,0)
 . D UPDATE(.OUT,FILE,.NEWATTS,1)
"RTN","MAGVRS41",152,0)
 . Q
"RTN","MAGVRS41",153,0)
 Q:$D(OUT(1))
"RTN","MAGVRS41",154,0)
 I FILE>2005.6 D  Q:$G(OUT(1))'=""  ; verify that parent IEN is set
"RTN","MAGVRS41",155,0)
 . I PIEN="" S OUT(1)="-1"_SSEP_"No parent record IEN" Q
"RTN","MAGVRS41",156,0)
 . I (PIEN<1)!(PIEN>($O(^MAGV(FILE-.01," "),-1))) S OUT(1)="-6"_SSEP_"Invalid parent IEN" Q
"RTN","MAGVRS41",157,0)
 . Q
"RTN","MAGVRS41",158,0)
 ; If a series and a consult, get the current TIU note for the study (parent IEN)
"RTN","MAGVRS41",159,0)
 I FILE=2005.63 D  Q:$G(OUT(1))<0
"RTN","MAGVRS41",160,0)
 . D TIUCHK^MAGVRS43(.OUT,PIEN) Q:$G(OUT(1))<0  ; bail out if fatal exception raised
"RTN","MAGVRS41",161,0)
 . I $P(OUT(1),SSEP,1)=0 S ATTS($O(ATTS(" "),-1)+1)="TIU NOTE REFERENCE"_ISEP_$P(OUT(1),SSEP,3)
"RTN","MAGVRS41",162,0)
 . K OUT
"RTN","MAGVRS41",163,0)
 . Q
"RTN","MAGVRS41",164,0)
 S ATTS($O(ATTS(" "),-1)+1)="STATUS"_ISEP_"A"
"RTN","MAGVRS41",165,0)
 D SETFDA^MAGVRS44(FILE,.ATTS,"+1,",.FDA,.FIELDERR)
"RTN","MAGVRS41",166,0)
 S UID=$G(FDA(FILE,"+1,",.01))
"RTN","MAGVRS41",167,0)
 I UID="" S OUT(1)="-2"_SSEP_"No UID" Q
"RTN","MAGVRS41",168,0)
 ; Attach record
"RTN","MAGVRS41",169,0)
 D UPDATE^DIE("","FDA","","ERR")
"RTN","MAGVRS41",170,0)
 K FDA
"RTN","MAGVRS41",171,0)
 S CIEN=$O(^MAGV(FILE,"B",UID,""),-1) ; New Record IEN
"RTN","MAGVRS41",172,0)
 S OUT(1)="0"_SSEP_$G(FIELDERR)_SSEP_CIEN ; Set return output to IEN of new record
"RTN","MAGVRS41",173,0)
 I $D(ERR("DIERR")) S OUT(1)="-3"_SSEP_$G(ERR("DIERR",1,"TEXT",1))
"RTN","MAGVRS41",174,0)
 I $D(ERR("DIERR")) Q
"RTN","MAGVRS41",175,0)
 K ERR
"RTN","MAGVRS41",176,0)
 ; Update Number of SOP and SERIES Number fields in the Study and Series files
"RTN","MAGVRS41",177,0)
 I (FILE=2005.63)!(FILE=2005.64) S PFILE=FILE-.01,FDA(PFILE,PIEN_",",7)=+$G(^MAGV(PFILE,PIEN,4))+1
"RTN","MAGVRS41",178,0)
 I FILE=2005.64 S PFILE=2005.62 S PPIEN=+$G(^MAGV(2005.63,PIEN,6)),FDA(2005.62,PPIEN_",",20)=$P($G(^MAGV(2005.62,PPIEN,4)),U,2)+1
"RTN","MAGVRS41",179,0)
 D FILE^DIE("","FDA","ERR")
"RTN","MAGVRS41",180,0)
 K FDA
"RTN","MAGVRS41",181,0)
 I FILE=2005.65 D AOFSET(PIEN,CIEN)
"RTN","MAGVRS41",182,0)
 I FILE>2005.6 D  Q:$G(OUT(1))'=""  ;Update last update for record and parents
"RTN","MAGVRS41",183,0)
 . S DATETIME=$$NOW^XLFDT
"RTN","MAGVRS41",184,0)
 . S UIEN=CIEN
"RTN","MAGVRS41",185,0)
 . F UFILE=FILE:-.01:2005.62 Q:'UIEN  D
"RTN","MAGVRS41",186,0)
 . . I UFILE'=2005.65 D
"RTN","MAGVRS41",187,0)
 . . . S FDA(UFILE,UIEN_",",$$GETFIELD(UFILE,"LAST UPDATE DATE/TIME"))=DATETIME
"RTN","MAGVRS41",188,0)
 . . . S:$G(ERR)'="" OUT(1)=ERR
"RTN","MAGVRS41",189,0)
 . . . K ERR
"RTN","MAGVRS41",190,0)
 . . . D FILE^DIE("","FDA","ERR")
"RTN","MAGVRS41",191,0)
 . . . I $D(ERR("DIERR")) S OUT(1)="-5"_SSEP_$G(ERR("DIERR",1,"TEXT",1))
"RTN","MAGVRS41",192,0)
 . . . K FDA,ERR
"RTN","MAGVRS41",193,0)
 . . . Q
"RTN","MAGVRS41",194,0)
 . . I UIEN S UIEN=+$G(^MAGV(UFILE,UIEN,6))
"RTN","MAGVRS41",195,0)
 . . Q
"RTN","MAGVRS41",196,0)
 . Q
"RTN","MAGVRS41",197,0)
 Q
"RTN","MAGVRS41",198,0)
REFRESH(OUT,FILE,IEN,PIEN,OVERRIDE) ; Retrieve specified file data attributes
"RTN","MAGVRS41",199,0)
 N OUTI,FIELD,MULTOUT,FDA,ERR,OSEP,ISEP,SSEP,MULTIPLE,DATETIME,UIEN,UFILE,FORMAT,SUBFILE,SUBIEN,FILEMULT,DD
"RTN","MAGVRS41",200,0)
 N DEVIEN,DEVNAME,DEVMAN,DEVMODEL,VALUE
"RTN","MAGVRS41",201,0)
 S OSEP=$$OUTSEP,ISEP=$$INPUTSEP,SSEP=$$STATSEP K OUT
"RTN","MAGVRS41",202,0)
 I $G(FILE)="" S OUT(1)="-9"_SSEP_"Missing file specification" Q
"RTN","MAGVRS41",203,0)
 I '$D(^MAGV(FILE)),'$D(^MAGD(FILE)) S OUT(1)="-10"_SSEP_"Invalid file specification ("_$G(FILE)_")" Q
"RTN","MAGVRS41",204,0)
 I '$G(IEN) S OUT(1)="-1"_SSEP_"No record IEN" Q
"RTN","MAGVRS41",205,0)
 I '$G(OVERRIDE),'$G(PIEN) S OUT(1)="-2"_SSEP_"No parent record IEN" Q
"RTN","MAGVRS41",206,0)
 I FILE'=2005.61,'$G(OVERRIDE),'$$PARENT(FILE,IEN,PIEN) S OUT(1)="-3"_SSEP_"Parent Record not verified" Q
"RTN","MAGVRS41",207,0)
 I FILE'=2006.575,'$D(^MAGV(FILE,IEN)) S OUT(1)="-4"_SSEP_"IEN does not exist in "_FILE Q
"RTN","MAGVRS41",208,0)
 I FILE=2006.575,'$D(^MAGD(FILE,IEN)) S OUT(1)="-5"_SSEP_"IEN does not exist in "_FILE Q
"RTN","MAGVRS41",209,0)
 S FIELD=$$GETFIELD(FILE,"STATUS") I FIELD D  Q:$D(OUT)
"RTN","MAGVRS41",210,0)
 . S STATUS=$$GET1^DIQ(FILE,IEN,FIELD,"I")
"RTN","MAGVRS41",211,0)
 . S:STATUS="I" OUT(1)="-11"_SSEP_"No accessible entry for UID found in file "_FILE
"RTN","MAGVRS41",212,0)
 . Q
"RTN","MAGVRS41",213,0)
 S FIELD="",OUTI=2,FNUM=""
"RTN","MAGVRS41",214,0)
 D GETS^DIQ(FILE,IEN_",","**","I","DD")
"RTN","MAGVRS41",215,0)
 ; Process all non-multiple fields
"RTN","MAGVRS41",216,0)
 F  D  Q:FNUM="" 
"RTN","MAGVRS41",217,0)
 . S FNUM=$O(DD(FILE,IEN_",",FNUM)) Q:FNUM=""
"RTN","MAGVRS41",218,0)
 . I FILE=2005.63,FNUM=18 D  Q  ; DEVICE returns DEVICE MANUFACTURER and DEVICE MODEL from the ACQUISITION DEVICE file NAME (.01) field
"RTN","MAGVRS41",219,0)
 . . S DEVIEN=$G(DD("2005.63",IEN_",","18","I"))
"RTN","MAGVRS41",220,0)
 . . Q:$G(DEVIEN)=""
"RTN","MAGVRS41",221,0)
 . . S DEVNAME=$P($G(^MAG(2006.04,DEVIEN,0)),U,1)
"RTN","MAGVRS41",222,0)
 . . S DEVMAN=$P(DEVNAME," (",1)
"RTN","MAGVRS41",223,0)
 . . S DEVMODEL=$TR($P(DEVNAME," (",2),")")
"RTN","MAGVRS41",224,0)
 . . S OUT(OUTI)="DEVICE MANUFACTURER"_OSEP_DEVMAN_SSEP
"RTN","MAGVRS41",225,0)
 . . S OUT(OUTI+1)="DEVICE MODEL"_OSEP_DEVMODEL_SSEP
"RTN","MAGVRS41",226,0)
 . . S OUTI=OUTI+2
"RTN","MAGVRS41",227,0)
 . . Q
"RTN","MAGVRS41",228,0)
 . S FIELD=$$GET1^DID(FILE,FNUM,,"LABEL")
"RTN","MAGVRS41",229,0)
 . S FORMAT=$S((FIELD["INDEX")!(FIELD="SOP CLASS UID")!(FIELD="PHOTOMETRIC INTERPRETATION"):"E",1:"I") ; return internal formats except for index terms and SOP CLASS UID
"RTN","MAGVRS41",230,0)
 . I (FIELD["REFERENCE") S FORMAT="I" ; If the field is an IEN pointer return the internal format rather than the UID string 
"RTN","MAGVRS41",231,0)
 . S VALUE=$$GET1^DIQ(FILE,IEN,FIELD,$G(FORMAT))
"RTN","MAGVRS41",232,0)
 . I $$DATETIME(FILE,FIELD) S VALUE=$$FM2IDF^MAGVAF01(VALUE)
"RTN","MAGVRS41",233,0)
 . I FILE=2005.63,FIELD="ACQUISITION LOCATION",VALUE'="" S VALUE=$$GETSINST(VALUE)
"RTN","MAGVRS41",234,0)
 . I ((FILE=2005.6)!(FILE=2005.61))&(FIELD="SERVICE INSTITUTION REFERENCE"),VALUE'="" S VALUE=$$GETSINST(VALUE),FIELD="CREATING ENTITY"
"RTN","MAGVRS41",235,0)
 . S OUT(OUTI)=FIELD_OSEP_VALUE_SSEP
"RTN","MAGVRS41",236,0)
 . S OUTI=OUTI+1
"RTN","MAGVRS41",237,0)
 . Q
"RTN","MAGVRS41",238,0)
 ; Process multiple fields
"RTN","MAGVRS41",239,0)
 S FILEMULT=FILE
"RTN","MAGVRS41",240,0)
 F  D  Q:FILEMULT=""
"RTN","MAGVRS41",241,0)
 . S FILEMULT=$O(DD(FILEMULT)) Q:FILEMULT=""
"RTN","MAGVRS41",242,0)
 . S FNUM=$E(FILEMULT,$L(FILE)+1,$L(FILEMULT))
"RTN","MAGVRS41",243,0)
 . D GETS^DIQ(FILE,IEN_",",FNUM_"*","","MULTOUT")
"RTN","MAGVRS41",244,0)
 . I '$D(MULTOUT) Q 
"RTN","MAGVRS41",245,0)
 . S FIELD=$$GET1^DID(FILE,FNUM,,"LABEL")
"RTN","MAGVRS41",246,0)
 . S SUBFILE=$O(MULTOUT("")),SUBIEN=""
"RTN","MAGVRS41",247,0)
 . F  D  Q:$O(MULTOUT(SUBFILE,SUBIEN))=""
"RTN","MAGVRS41",248,0)
 . . S SUBIEN=$O(MULTOUT(SUBFILE,SUBIEN))
"RTN","MAGVRS41",249,0)
 . . S OUT(OUTI)=FIELD_OSEP_MULTOUT(SUBFILE,SUBIEN,.01)_SSEP
"RTN","MAGVRS41",250,0)
 . . S OUTI=OUTI+1
"RTN","MAGVRS41",251,0)
 . . Q
"RTN","MAGVRS41",252,0)
 . Q
"RTN","MAGVRS41",253,0)
 S OUT(1)="0"_SSEP ; Look up successful
"RTN","MAGVRS41",254,0)
 ; Update last access date time for study
"RTN","MAGVRS41",255,0)
 S DATETIME=$$NOW^XLFDT
"RTN","MAGVRS41",256,0)
 S UIEN=IEN
"RTN","MAGVRS41",257,0)
 F UFILE=FILE:-.01:2005.62 Q:'UIEN  D
"RTN","MAGVRS41",258,0)
 . I UFILE=2005.62 D
"RTN","MAGVRS41",259,0)
 . . S FDA(UFILE,UIEN_",",$$GETFIELD(UFILE,"LAST ACCESS DATE/TIME"))=DATETIME
"RTN","MAGVRS41",260,0)
 . . K ERR
"RTN","MAGVRS41",261,0)
 . . D FILE^DIE("","FDA","ERR")
"RTN","MAGVRS41",262,0)
 . . S:$G(ERR("DIERR"))'="" OUT(1)="-7"_SSEP_$G(ERR("DIERR",1,"TEXT",1))
"RTN","MAGVRS41",263,0)
 . . K FDA,ERR
"RTN","MAGVRS41",264,0)
 . . Q
"RTN","MAGVRS41",265,0)
 . I UIEN S UIEN=+$G(^MAGV(UFILE,UIEN,6))
"RTN","MAGVRS41",266,0)
 . Q
"RTN","MAGVRS41",267,0)
 Q
"RTN","MAGVRS41",268,0)
MULTIPLE(FILE,FIELD) ; Process multiple DB entries
"RTN","MAGVRS41",269,0)
 N DATATYPE,MULTIPLE,FNUM
"RTN","MAGVRS41",270,0)
 S MULTIPLE=$$GET1^DID(FILE,FIELD,,"MULTIPLE-VALUED")
"RTN","MAGVRS41",271,0)
 Q +MULTIPLE
"RTN","MAGVRS41",272,0)
NUMERIC(FILE,FIELD) ; Determine if field is numeric
"RTN","MAGVRS41",273,0)
 N DATATYPE,NUMERIC
"RTN","MAGVRS41",274,0)
 S NUMERIC=0
"RTN","MAGVRS41",275,0)
 I $$GET1^DID(FILE,FIELD,"","TYPE")="NUMERIC" S NUMERIC=1
"RTN","MAGVRS41",276,0)
 Q NUMERIC
"RTN","MAGVRS41",277,0)
DATETIME(FILE,FIELD) ; Determine if field is date time
"RTN","MAGVRS41",278,0)
 N DATATYPE,DATETIME
"RTN","MAGVRS41",279,0)
 S DATETIME=0
"RTN","MAGVRS41",280,0)
 I $$GET1^DID(FILE,FIELD,"","TYPE")="DATE/TIME" S DATETIME=1
"RTN","MAGVRS41",281,0)
 Q DATETIME
"RTN","MAGVRS41",282,0)
GETFIELD(FILE,FNAME) ; Returns a field number given a field name
"RTN","MAGVRS41",283,0)
 Q $$FLDNUM^DILFD(FILE,FNAME)
"RTN","MAGVRS41",284,0)
PARENT(FILE,IEN,PIEN) ; Check if provided parent IEN is linked to current record
"RTN","MAGVRS41",285,0)
 I PIEN'=+$G(^MAGV(FILE,IEN,6)) Q 0
"RTN","MAGVRS41",286,0)
 Q 1
"RTN","MAGVRS41",287,0)
AOFSET(PIEN,IEN) ; Set artifact on file to 1 for all parent nodes of file instance
"RTN","MAGVRS41",288,0)
 N AOFFILE,FIELD,FDA,ERR,MAGVIEN,MAGVPIEN,MAGVOUT
"RTN","MAGVRS41",289,0)
 S MAGVPIEN=PIEN  ; IEN in file #2005.64
"RTN","MAGVRS41",290,0)
 S MAGVIEN=IEN    ; IEN in file #2005.65
"RTN","MAGVRS41",291,0)
 ;
"RTN","MAGVRS41",292,0)
 F AOFFILE=2005.64,2005.63,2005.62,2005.61,2005.6 D
"RTN","MAGVRS41",293,0)
 . S FIELD=$$GETFIELD(AOFFILE,"ARTIFACT ON FILE")
"RTN","MAGVRS41",294,0)
 . I $G(FIELD)="" Q
"RTN","MAGVRS41",295,0)
 . S FDA(AOFFILE,PIEN_",",FIELD)=1
"RTN","MAGVRS41",296,0)
 . D FILE^DIE("","FDA")
"RTN","MAGVRS41",297,0)
 . K FDA,ERR
"RTN","MAGVRS41",298,0)
 . I AOFFILE>2005.6 S PIEN=+$G(^MAGV(AOFFILE,PIEN,6))
"RTN","MAGVRS41",299,0)
 . Q
"RTN","MAGVRS41",300,0)
 D NWI34^MAGNWRK1(.MAGVOUT,MAGVPIEN,MAGVIEN) ; add a new storage work item
"RTN","MAGVRS41",301,0)
 ;
"RTN","MAGVRS41",302,0)
 Q
"RTN","MAGVRS41",303,0)
INACTIVT(OUT,FILE,IEN,PIEN,OVERRIDE,REASON) ; Marks the entry indicated by file # and IEN as deleted
"RTN","MAGVRS41",304,0)
 N OSEP,ISEP,SSEP,STATUS,PFILE,ERR,FDA,AOF,FIELD,AOFIEN
"RTN","MAGVRS41",305,0)
 S OSEP=$$OUTSEP,ISEP=$$INPUTSEP,SSEP=$$STATSEP
"RTN","MAGVRS41",306,0)
 I $G(FILE)="" S OUT(1)="-23"_SSEP_"No file number provided" Q
"RTN","MAGVRS41",307,0)
 I $G(IEN)="" S OUT(1)="-20"_SSEP_"No IEN provided" Q
"RTN","MAGVRS41",308,0)
 I '$G(PIEN)="" S OUT(1)="-21"_SSEP_"No parent IEN provided" Q
"RTN","MAGVRS41",309,0)
 I '$D(OVERRIDE) S OUT(1)="-22"_SSEP_"No OVERRIDE flag provided" Q
"RTN","MAGVRS41",310,0)
 I '$D(^MAGV(FILE,IEN,0)) S OUT(1)="-1"_SSEP_"Record IEN not found in file" Q
"RTN","MAGVRS41",311,0)
 I '$D(REASON) S OUT(1)="-4"_SSEP_"No deletion reason provided" Q
"RTN","MAGVRS41",312,0)
 ; If record status is already INACCESIBLE quit with error
"RTN","MAGVRS41",313,0)
 S FIELD=$$GETFIELD(FILE,"STATUS")
"RTN","MAGVRS41",314,0)
 S STATUS=$$GET1^DIQ(FILE,IEN,FIELD,"E")
"RTN","MAGVRS41",315,0)
 I STATUS="INACCESSIBLE" S OUT(1)="2"_SSEP_"Record is already inaccessible" Q
"RTN","MAGVRS41",316,0)
 ; Call INACT to delete identified record and all children
"RTN","MAGVRS41",317,0)
 D INACT^MAGVRS44(.OUT,FILE,IEN,$G(PIEN),$G(OVERRIDE),$G(REASON))
"RTN","MAGVRS41",318,0)
 I $D(OUT(1)) Q
"RTN","MAGVRS41",319,0)
 ; Set parent records artifact on file to false if no active child records
"RTN","MAGVRS41",320,0)
 S AOFIEN=IEN,AOF=""
"RTN","MAGVRS41",321,0)
 F FILE=FILE:2005.61:-.01 Q:AOF'=""  D
"RTN","MAGVRS41",322,0)
 . F  S AOFIEN=+$G(^MAGV(FILE,"C",PIEN,AOFIEN)) Q:(AOF'="")!(AOFIEN="")  D 
"RTN","MAGVRS41",323,0)
 . . S FIELD=$$GETFIELD(FILE,"ARTIFACT ON FILE")
"RTN","MAGVRS41",324,0)
 . . S AOF=$$GET1^DIQ(FILE,AOFIEN,FIELD)
"RTN","MAGVRS41",325,0)
 . Q
"RTN","MAGVRS41",326,0)
 . ;If no child records are on file then set parent to artifact not on file
"RTN","MAGVRS41",327,0)
 . I AOF="" D
"RTN","MAGVRS41",328,0)
 . . S PFILE=FILE-.01
"RTN","MAGVRS41",329,0)
 . . S FIELD=$$GETFIELD(FILE,"ARTIFACT ON FILE")
"RTN","MAGVRS41",330,0)
 . . S FDA(PFILE,PIEN_",",FIELD)=""
"RTN","MAGVRS41",331,0)
 . . D FILE^DIE("","FDA")
"RTN","MAGVRS41",332,0)
 . . K FDA,ERR
"RTN","MAGVRS41",333,0)
 . . Q
"RTN","MAGVRS41",334,0)
 . Q 
"RTN","MAGVRS41",335,0)
 I '$D(OUT(1)) S OUT(1)="0"_SSEP_SSEP_IEN
"RTN","MAGVRS41",336,0)
 Q 
"RTN","MAGVRS41",337,0)
FINDBUID(OUT,FILE,UID) ;Find SOP or series by UID
"RTN","MAGVRS41",338,0)
 N STATUS,IEN,OSEP,ISEP,SSEP
"RTN","MAGVRS41",339,0)
 S OSEP=$$OUTSEP,ISEP=$$INPUTSEP,SSEP=$$STATSEP
"RTN","MAGVRS41",340,0)
 I $G(FILE)="" S OUT="-3"_SSEP_"No file specified" Q
"RTN","MAGVRS41",341,0)
 I "^2005.62^2005.63^2005.64^"'[("^"_FILE_"^") S OUT="-4"_SSEP_"Invalid file specified ("_FILE_")" Q
"RTN","MAGVRS41",342,0)
 I $G(UID)="" S OUT="-5"_SSEP_"No UID specified" Q
"RTN","MAGVRS41",343,0)
 S IEN=$O(^MAGV(FILE,"B",UID,""))
"RTN","MAGVRS41",344,0)
 S FIELD=$$GETFIELD(FILE,"STATUS")
"RTN","MAGVRS41",345,0)
 S STATUS=$$GET1^DIQ(FILE,IEN,FIELD,"I")
"RTN","MAGVRS41",346,0)
 I IEN'="",STATUS'="I" S OUT="0"_SSEP_SSEP_IEN Q
"RTN","MAGVRS41",347,0)
 I IEN="" S OUT="-1"_SSEP_"UID not found in file "_FILE Q
"RTN","MAGVRS41",348,0)
 I STATUS="I" S OUT="-2"_SSEP_"No active entry for UID found in file "_FILE Q
"RTN","MAGVRS41",349,0)
 Q
"RTN","MAGVRS41",350,0)
GETSINST(VALUE) ; Get the service institution value
"RTN","MAGVRS41",351,0)
 N IEN,FILE,SITE,X
"RTN","MAGVRS41",352,0)
 S SITE="Error - unknown service institution"
"RTN","MAGVRS41",353,0)
 S X=$G(^MAGV(2005.8,$G(VALUE),0))
"RTN","MAGVRS41",354,0)
 S IEN=$P(X,";",1),FILE=$P(X,";",2)
"RTN","MAGVRS41",355,0)
 I FILE="DIC(4," S SITE=$P($$NS^XUAF4(IEN),U,2) ; IA #2171 Get Station Number
"RTN","MAGVRS41",356,0)
 Q SITE
"RTN","MAGVD011")
0^9^B8804376
"RTN","MAGVD011",1,0)
MAGVD011 ;WOIFO/NST - Work item deletion utility ; OCT 24, 2018@1:42PM
"RTN","MAGVD011",2,0)
 ;;3.0;IMAGING;**201**;Dec 02, 2009;Build 163
"RTN","MAGVD011",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGVD011",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVD011",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGVD011",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGVD011",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGVD011",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGVD011",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGVD011",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGVD011",11,0)
 ;; |                                                               |
"RTN","MAGVD011",12,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGVD011",13,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGVD011",14,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGVD011",15,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGVD011",16,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGVD011",17,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVD011",18,0)
 ;;
"RTN","MAGVD011",19,0)
 Q
"RTN","MAGVD011",20,0)
 ;
"RTN","MAGVD011",21,0)
DELWIDTS ; Delete work items in date range by work item TYPE and SUBTYPE
"RTN","MAGVD011",22,0)
 ;
"RTN","MAGVD011",23,0)
 N DIR,X,Y,MAGDATE,MAGFDATE,MAGTDATE,MAGIEN,MAGOUT,MAGTYPE,MAGSUB
"RTN","MAGVD011",24,0)
 ;
"RTN","MAGVD011",25,0)
 ; Get from date
"RTN","MAGVD011",26,0)
 S DIR(0)="D^::EP",DIR("A")="Enter from date"
"RTN","MAGVD011",27,0)
 S DIR("?")="Enter a date."
"RTN","MAGVD011",28,0)
 D ^DIR
"RTN","MAGVD011",29,0)
 I 'Y!(Y="^") Q
"RTN","MAGVD011",30,0)
 S MAGFDATE=Y\1
"RTN","MAGVD011",31,0)
 ;
"RTN","MAGVD011",32,0)
 ; Get through date
"RTN","MAGVD011",33,0)
 K X,Y
"RTN","MAGVD011",34,0)
 S DIR(0)="D^::EP",DIR("A")="Enter through date"
"RTN","MAGVD011",35,0)
 S DIR("?")="Enter a date."
"RTN","MAGVD011",36,0)
 D ^DIR
"RTN","MAGVD011",37,0)
 I 'Y!(Y="^") Q
"RTN","MAGVD011",38,0)
 S MAGTDATE=Y\1
"RTN","MAGVD011",39,0)
 ;
"RTN","MAGVD011",40,0)
 ; Get Type
"RTN","MAGVD011",41,0)
 K X,Y
"RTN","MAGVD011",42,0)
 S DIR(0)="P^2006.9412:E",DIR("A")="Select work item type"
"RTN","MAGVD011",43,0)
 S DIR("?")="Enter a work item type."
"RTN","MAGVD011",44,0)
 D ^DIR
"RTN","MAGVD011",45,0)
 I 'Y!(Y="^") Q
"RTN","MAGVD011",46,0)
 S MAGTYPE=$P(Y,"^",1)
"RTN","MAGVD011",47,0)
 ;
"RTN","MAGVD011",48,0)
 ; Get Subtype
"RTN","MAGVD011",49,0)
 K X,Y
"RTN","MAGVD011",50,0)
 S DIR(0)="P^2006.9414:E",DIR("A")="Select work item subtype"
"RTN","MAGVD011",51,0)
 S DIR("?")="Enter a work item subtype."
"RTN","MAGVD011",52,0)
 D ^DIR
"RTN","MAGVD011",53,0)
 I 'Y!(Y="^") Q
"RTN","MAGVD011",54,0)
 S MAGSUB=$P(Y,"^",1)
"RTN","MAGVD011",55,0)
 ;
"RTN","MAGVD011",56,0)
 ; Confirm deletion
"RTN","MAGVD011",57,0)
 K X,Y
"RTN","MAGVD011",58,0)
 S DIR(0)="Y",DIR("A")="ARE YOU SURE YOU WANT TO DELETE WORK ITEMS"
"RTN","MAGVD011",59,0)
 S DIR("B")="NO"
"RTN","MAGVD011",60,0)
 D ^DIR
"RTN","MAGVD011",61,0)
 I 'Y D EN^DDIOL("Deletion Canceled. Work items were not deleted.","","!!") Q
"RTN","MAGVD011",62,0)
 ;
"RTN","MAGVD011",63,0)
 S MAGDATE=MAGFDATE-.0000001
"RTN","MAGVD011",64,0)
 S MAGIEN=0
"RTN","MAGVD011",65,0)
 F  S MAGDATE=$O(^MAGV(2006.941,"B",MAGDATE)) Q:'MAGDATE!((MAGDATE\1)>MAGTDATE)  D
"RTN","MAGVD011",66,0)
 . F  S MAGIEN=$O(^MAGV(2006.941,"B",MAGDATE,MAGIEN)) Q:'MAGIEN  D
"RTN","MAGVD011",67,0)
 . . Q:$$GET1^DIQ(2006.941,MAGIEN,1,"I")'=MAGTYPE
"RTN","MAGVD011",68,0)
 . . Q:$$GET1^DIQ(2006.941,MAGIEN,2,"I")'=MAGSUB
"RTN","MAGVD011",69,0)
 . . D DELWITEM^MAGVIM01(.MAGOUT,MAGIEN)
"RTN","MAGVD011",70,0)
 . . Q
"RTN","MAGVD011",71,0)
 . Q
"RTN","MAGVD011",72,0)
 Q
"VER")
8.0^22.0
**END**
**END**
