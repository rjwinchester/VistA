KIDS Distribution saved on Jul 03, 2017@17:44:49
VistA Imaging V3 - Patch 166 - Legacy DICOM Gateway Maintenance Patch
**KIDS**:MAG*3.0*166^

**INSTALL NAME**
MAG*3.0*166
"BLD",8344,0)
MAG*3.0*166^IMAGING^0^3170703^y
"BLD",8344,1,0)
^^19^19^3170630^
"BLD",8344,1,1,0)
 
"BLD",8344,1,2,0)
VistA Imaging V3.0 - Patch 166 LDGW
"BLD",8344,1,3,0)
 
"BLD",8344,1,4,0)
Routines:
"BLD",8344,1,5,0)
       
"BLD",8344,1,6,0)
MAG7RS 
"BLD",8344,1,7,0)
MAGBRTE3
"BLD",8344,1,8,0)
MAGIP166
"BLD",8344,1,9,0)
MAGT7MA
"BLD",8344,1,10,0)
MAGTP005
"BLD",8344,1,11,0)
MAGVIM05 
"BLD",8344,1,12,0)
                    
"BLD",8344,1,13,0)
 
"BLD",8344,1,14,0)
 
"BLD",8344,1,15,0)
 
"BLD",8344,1,16,0)
 
"BLD",8344,1,17,0)
 
"BLD",8344,1,18,0)
Please note that routine MAGIP166 is deleted after the KIDS build is 
"BLD",8344,1,19,0)
installed                                         
"BLD",8344,4,0)
^9.64PA^2006.1^1
"BLD",8344,4,2006.1,0)
2006.1
"BLD",8344,4,2006.1,2,0)
^9.641^2006.1^1
"BLD",8344,4,2006.1,2,2006.1,0)
IMAGING SITE PARAMETERS  (File-top level)
"BLD",8344,4,2006.1,2,2006.1,1,0)
^9.6411^204^1
"BLD",8344,4,2006.1,2,2006.1,1,204,0)
DPS HL7 MESSAGING
"BLD",8344,4,2006.1,222)
y^y^p^^^^n^^n
"BLD",8344,4,2006.1,224)

"BLD",8344,4,"APDD",2006.1,2006.1)

"BLD",8344,4,"APDD",2006.1,2006.1,204)

"BLD",8344,4,"B",2006.1,2006.1)

"BLD",8344,6.3)
45
"BLD",8344,"ABNS",0)
^9.66A^^
"BLD",8344,"ABPKG")
n^n^G.IMAGING DEVELOPMENT TEAM@domain.ext
"BLD",8344,"INID")
n^y^n
"BLD",8344,"INIT")
POS^MAGIP166
"BLD",8344,"KRN",0)
^9.67PA^779.2^20
"BLD",8344,"KRN",.4,0)
.4
"BLD",8344,"KRN",.4,"NM",0)
^9.68A^^0
"BLD",8344,"KRN",.401,0)
.401
"BLD",8344,"KRN",.401,"NM",0)
^9.68A^^0
"BLD",8344,"KRN",.402,0)
.402
"BLD",8344,"KRN",.402,"NM",0)
^9.68A^^
"BLD",8344,"KRN",.403,0)
.403
"BLD",8344,"KRN",.5,0)
.5
"BLD",8344,"KRN",.84,0)
.84
"BLD",8344,"KRN",.84,"NM",0)
^9.68A^^
"BLD",8344,"KRN",3.6,0)
3.6
"BLD",8344,"KRN",3.8,0)
3.8
"BLD",8344,"KRN",3.8,"NM",0)
^9.68A^^
"BLD",8344,"KRN",9.2,0)
9.2
"BLD",8344,"KRN",9.8,0)
9.8
"BLD",8344,"KRN",9.8,"NM",0)
^9.68A^8^6
"BLD",8344,"KRN",9.8,"NM",1,0)
MAGIP166^^0^B4110432
"BLD",8344,"KRN",9.8,"NM",4,0)
MAGT7MA^^0^B124464922
"BLD",8344,"KRN",9.8,"NM",5,0)
MAG7RS^^0^B55362619
"BLD",8344,"KRN",9.8,"NM",6,0)
MAGBRTE3^^0^B17783232
"BLD",8344,"KRN",9.8,"NM",7,0)
MAGVIM05^^0^B152501920
"BLD",8344,"KRN",9.8,"NM",8,0)
MAGTP005^^0^B12863512
"BLD",8344,"KRN",9.8,"NM","B","MAG7RS",5)

"BLD",8344,"KRN",9.8,"NM","B","MAGBRTE3",6)

"BLD",8344,"KRN",9.8,"NM","B","MAGIP166",1)

"BLD",8344,"KRN",9.8,"NM","B","MAGT7MA",4)

"BLD",8344,"KRN",9.8,"NM","B","MAGTP005",8)

"BLD",8344,"KRN",9.8,"NM","B","MAGVIM05",7)

"BLD",8344,"KRN",19,0)
19
"BLD",8344,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",8344,"KRN",19,"NM",1,0)
MAG DICOM VISA^^0
"BLD",8344,"KRN",19,"NM","B","MAG DICOM VISA",1)

"BLD",8344,"KRN",19.1,0)
19.1
"BLD",8344,"KRN",19.1,"NM",0)
^9.68A^^0
"BLD",8344,"KRN",101,0)
101
"BLD",8344,"KRN",101,"NM",0)
^9.68A^^
"BLD",8344,"KRN",409.61,0)
409.61
"BLD",8344,"KRN",771,0)
771
"BLD",8344,"KRN",771,"NM",0)
^9.68A^^
"BLD",8344,"KRN",779.2,0)
779.2
"BLD",8344,"KRN",870,0)
870
"BLD",8344,"KRN",870,"NM",0)
^9.68A^^
"BLD",8344,"KRN",8989.51,0)
8989.51
"BLD",8344,"KRN",8989.51,"NM",0)
^9.68A^^
"BLD",8344,"KRN",8989.52,0)
8989.52
"BLD",8344,"KRN",8994,0)
8994
"BLD",8344,"KRN",8994,"NM",0)
^9.68A^^0
"BLD",8344,"KRN","B",.4,.4)

"BLD",8344,"KRN","B",.401,.401)

"BLD",8344,"KRN","B",.402,.402)

"BLD",8344,"KRN","B",.403,.403)

"BLD",8344,"KRN","B",.5,.5)

"BLD",8344,"KRN","B",.84,.84)

"BLD",8344,"KRN","B",3.6,3.6)

"BLD",8344,"KRN","B",3.8,3.8)

"BLD",8344,"KRN","B",9.2,9.2)

"BLD",8344,"KRN","B",9.8,9.8)

"BLD",8344,"KRN","B",19,19)

"BLD",8344,"KRN","B",19.1,19.1)

"BLD",8344,"KRN","B",101,101)

"BLD",8344,"KRN","B",409.61,409.61)

"BLD",8344,"KRN","B",771,771)

"BLD",8344,"KRN","B",779.2,779.2)

"BLD",8344,"KRN","B",870,870)

"BLD",8344,"KRN","B",8989.51,8989.51)

"BLD",8344,"KRN","B",8989.52,8989.52)

"BLD",8344,"KRN","B",8994,8994)

"BLD",8344,"PRE")

"BLD",8344,"QDEF")
^^^^^^^^
"BLD",8344,"QUES",0)
^9.62^^
"BLD",8344,"REQB",0)
^9.611^1^1
"BLD",8344,"REQB",1,0)
MAG*3.0*173^2
"BLD",8344,"REQB","B","MAG*3.0*173",1)

"FIA",2006.1)
IMAGING SITE PARAMETERS
"FIA",2006.1,0)
^MAG(2006.1,
"FIA",2006.1,0,0)
2006.1P
"FIA",2006.1,0,1)
y^y^p^^^^n^^n
"FIA",2006.1,0,10)

"FIA",2006.1,0,11)

"FIA",2006.1,0,"RLRO")

"FIA",2006.1,0,"VR")
3.0^MAG
"FIA",2006.1,2006.1)
1
"FIA",2006.1,2006.1,204)

"INIT")
POS^MAGIP166
"KRN",19,23824,-1)
0^1
"KRN",19,23824,0)
MAG DICOM VISA^DICOM VISA^^B^^^^^^^^
"KRN",19,23824,1,0)
^19.06^1^1^3170223^^^^
"KRN",19,23824,1,1,0)
This menu option exists for the RPC Broker to establish an environment that grants a user access to the RPC subroutines that support DICOM VISA.
"KRN",19,23824,"RPC",0)
^19.05P^146^146
"KRN",19,23824,"RPC",1,0)
MAG DICOM CHECK AE TITLE
"KRN",19,23824,"RPC",2,0)
MAG DICOM GET GATEWAY INFO
"KRN",19,23824,"RPC",3,0)
MAG DICOM VISTA AE TITLE
"KRN",19,23824,"RPC",4,0)
MAGV ATTACH IMAGE INSTANCE
"KRN",19,23824,"RPC",5,0)
MAGV ATTACH PAT PROC REF
"KRN",19,23824,"RPC",6,0)
MAGV ATTACH SERIES
"KRN",19,23824,"RPC",7,0)
MAGV ATTACH SOP
"KRN",19,23824,"RPC",8,0)
MAGV ATTACH STUDY
"KRN",19,23824,"RPC",9,0)
MAGV CREATE DICOM FAILED IMAGE
"KRN",19,23824,"RPC",10,0)
MAGV CREATE PAT REF
"KRN",19,23824,"RPC",11,0)
MAGV DELETE DICOM FAILED IMAGE
"KRN",19,23824,"RPC",12,0)
MAGV DGW ACTION UID LIST
"KRN",19,23824,"RPC",13,0)
MAGV DGW INSTRUMENT LIST
"KRN",19,23824,"RPC",14,0)
MAGV DGW MODALITY LIST
"KRN",19,23824,"RPC",15,0)
MAGV DICOM GET COUNT
"KRN",19,23824,"RPC",16,0)
MAGV DICOM SET INSTRUMENT LIST
"KRN",19,23824,"RPC",17,0)
MAGV DICOM SET MODALITY LIST
"KRN",19,23824,"RPC",18,0)
MAGV FIND PAT REF
"KRN",19,23824,"RPC",19,0)
MAGV FIND PROC REF
"KRN",19,23824,"RPC",20,0)
MAGV FIND SERIES BY REFERENCE
"KRN",19,23824,"RPC",21,0)
MAGV FIND SERIES BY UID
"KRN",19,23824,"RPC",22,0)
MAGV FIND SOP BY UID
"KRN",19,23824,"RPC",23,0)
MAGV FIND STUDY BY UID
"KRN",19,23824,"RPC",24,0)
MAGV GET ACCESSION NUM
"KRN",19,23824,"RPC",25,0)
MAGV GET DGW CONFIG
"KRN",19,23824,"RPC",26,0)
MAGV GET DICOM FAILED IMAGE
"KRN",19,23824,"RPC",27,0)
MAGV GET IMAGE FILE
"KRN",19,23824,"RPC",28,0)
MAGV GET ORIG IMAGE FILE
"KRN",19,23824,"RPC",29,0)
MAGV GET PAT INFO
"KRN",19,23824,"RPC",30,0)
MAGV GET PAT REF ATTS
"KRN",19,23824,"RPC",31,0)
MAGV GET PROC REF ATTS
"KRN",19,23824,"RPC",32,0)
MAGV GET PROCEDURE INFO
"KRN",19,23824,"RPC",33,0)
MAGV GET REPORT
"KRN",19,23824,"RPC",34,0)
MAGV GET SERIES
"KRN",19,23824,"RPC",35,0)
MAGV GET SOP DATA
"KRN",19,23824,"RPC",36,0)
MAGV GET STUDY
"KRN",19,23824,"RPC",37,0)
MAGV INACTIVATE INSTANCE FILE
"KRN",19,23824,"RPC",38,0)
MAGV INACTIVATE PAT REF
"KRN",19,23824,"RPC",39,0)
MAGV INACTIVATE PROC REF
"KRN",19,23824,"RPC",40,0)
MAGV INACTIVATE SERIES
"KRN",19,23824,"RPC",41,0)
MAGV INACTIVATE SOP
"KRN",19,23824,"RPC",42,0)
MAGV INACTIVATE STUDY
"KRN",19,23824,"RPC",43,0)
MAGV SERIES UID CHECK
"KRN",19,23824,"RPC",44,0)
MAGV SET DGW CONFIG
"KRN",19,23824,"RPC",45,0)
MAGV SET DICOM FAILED IMAGE
"KRN",19,23824,"RPC",46,0)
MAGV SOP UID CHECK
"KRN",19,23824,"RPC",47,0)
MAGV STUDY LOOKUP
"KRN",19,23824,"RPC",48,0)
MAGV STUDY UID CHECK
"KRN",19,23824,"RPC",49,0)
MAGV TRAVERSE IMAGE FILE
"KRN",19,23824,"RPC",50,0)
MAGV TRAVERSE PROC REF
"KRN",19,23824,"RPC",51,0)
MAGV TRAVERSE SERIES
"KRN",19,23824,"RPC",52,0)
MAGV TRAVERSE SOP
"KRN",19,23824,"RPC",53,0)
MAGV TRAVERSE STUDY
"KRN",19,23824,"RPC",54,0)
MAGV UPDATE IMAGE FILE
"KRN",19,23824,"RPC",55,0)
MAGV UPDATE PAT PROC REF
"KRN",19,23824,"RPC",56,0)
MAGV UPDATE PAT REF
"KRN",19,23824,"RPC",57,0)
MAGV UPDATE SERIES
"KRN",19,23824,"RPC",58,0)
MAGV UPDATE SOP
"KRN",19,23824,"RPC",59,0)
MAGV UPDATE STUDY
"KRN",19,23824,"RPC",60,0)
MAGVA CREATE AD
"KRN",19,23824,"RPC",61,0)
MAGVA CREATE AINSTANCE
"KRN",19,23824,"RPC",62,0)
MAGVA CREATE ARETPOL
"KRN",19,23824,"RPC",63,0)
MAGVA CREATE ARTIFACT W KL
"KRN",19,23824,"RPC",64,0)
MAGVA CREATE KEYLIST
"KRN",19,23824,"RPC",65,0)
MAGVA CREATE PROVAVAILTY
"KRN",19,23824,"RPC",66,0)
MAGVA CREATE PROVIDER
"KRN",19,23824,"RPC",67,0)
MAGVA CREATE QUEUE
"KRN",19,23824,"RPC",68,0)
MAGVA CREATE RETPOL
"KRN",19,23824,"RPC",69,0)
MAGVA CREATE RETPOL PROV MAP
"KRN",19,23824,"RPC",70,0)
MAGVA CREATE RETPOLFF
"KRN",19,23824,"RPC",71,0)
MAGVA CREATE STORAGE TA
"KRN",19,23824,"RPC",72,0)
MAGVA CREATE TRF STATS
"KRN",19,23824,"RPC",73,0)
MAGVA DELETE KEYLIST
"KRN",19,23824,"RPC",74,0)
MAGVA DELETE PROVAVAILTY
"KRN",19,23824,"RPC",75,0)
MAGVA DELETE RETPOL PROV MAP
"KRN",19,23824,"RPC",76,0)
MAGVA DEQUEUE Q MSG
"KRN",19,23824,"RPC",77,0)
MAGVA ENQUEUE Q MSG
"KRN",19,23824,"RPC",78,0)
MAGVA FIND KEYLIST
"KRN",19,23824,"RPC",79,0)
MAGVA GET A AIS ARPS AND RPFFS
"KRN",19,23824,"RPC",80,0)
MAGVA GET A W KL AND AIS
"KRN",19,23824,"RPC",81,0)
MAGVA GET A W KL AND AIS BY KL
"KRN",19,23824,"RPC",82,0)
MAGVA GET A W KL AND AIS BY PK
"KRN",19,23824,"RPC",83,0)
MAGVA GET ALL ADS
"KRN",19,23824,"RPC",84,0)
MAGVA GET ALL PROVAVAILS
"KRN",19,23824,"RPC",85,0)
MAGVA GET ALL PROVIDERS
"KRN",19,23824,"RPC",86,0)
MAGVA GET ALL QUEUES
"KRN",19,23824,"RPC",87,0)
MAGVA GET ALL RETPOL PROV MAPS
"KRN",19,23824,"RPC",88,0)
MAGVA GET ALL RETPOLS
"KRN",19,23824,"RPC",89,0)
MAGVA GET ALL SITE PARAM IDS
"KRN",19,23824,"RPC",90,0)
MAGVA GET ARTIFACT W KL
"KRN",19,23824,"RPC",91,0)
MAGVA GET CWL
"KRN",19,23824,"RPC",92,0)
MAGVA GET JUKEBOX WL
"KRN",19,23824,"RPC",93,0)
MAGVA GET KEYLIST
"KRN",19,23824,"RPC",94,0)
MAGVA GET NET LOC DETAILS
"KRN",19,23824,"RPC",95,0)
MAGVA PEEK Q MSG
"KRN",19,23824,"RPC",96,0)
MAGVA SET AD RETPOL
"KRN",19,23824,"RPC",97,0)
MAGVA UPDATE ARETPOL
"KRN",19,23824,"RPC",98,0)
MAGVA UPDATE ARTIFACT
"KRN",19,23824,"RPC",99,0)
MAGVA UPDATE LAST ACCESS DT
"KRN",19,23824,"RPC",100,0)
MAGVA UPDATE PROVAVAILTY
"KRN",19,23824,"RPC",101,0)
MAGVA UPDATE PROVIDER
"KRN",19,23824,"RPC",102,0)
MAGVA UPDATE RETPOL PROV MAP
"KRN",19,23824,"RPC",103,0)
MAG EVENT AUDIT
"KRN",19,23824,"RPC",104,0)
MAG CFIND QUERY
"KRN",19,23824,"RPC",105,0)
MAG DICOM GET HOSP LOCATION
"KRN",19,23824,"RPC",106,0)
MAG DICOM RADIOLOGY MODIFIERS
"KRN",19,23824,"RPC",107,0)
MAG DICOM RADIOLOGY PROCEDURES
"KRN",19,23824,"RPC",108,0)
MAG IMAGE CURRENT INFO
"KRN",19,23824,"RPC",109,0)
MAG STUDY UID QUERY
"KRN",19,23824,"RPC",110,0)
MAG4 INDEX GET ORIGIN
"KRN",19,23824,"RPC",111,0)
MAGG INSTALL
"KRN",19,23824,"RPC",112,0)
MAGV ADD WORK ITEM TAGS
"KRN",19,23824,"RPC",113,0)
MAGV CONFIRM RAD ORDER
"KRN",19,23824,"RPC",114,0)
MAGV CREATE WORK ITEM
"KRN",19,23824,"RPC",115,0)
MAGV DELETE WORK ITEM
"KRN",19,23824,"RPC",116,0)
MAGV FIND WORK ITEM
"KRN",19,23824,"RPC",117,0)
MAGV GET NEXT WORK ITEM
"KRN",19,23824,"RPC",118,0)
MAGV GET PAT ORDERS
"KRN",19,23824,"RPC",119,0)
MAGV GET RADIOLOGY PROCEDURES
"KRN",19,23824,"RPC",120,0)
MAGV GET WORK ITEM
"KRN",19,23824,"RPC",121,0)
MAGV GET WORKLISTS
"KRN",19,23824,"RPC",122,0)
MAGV IMPORT MEDIA LOG STORE
"KRN",19,23824,"RPC",123,0)
MAGV IMPORT STATUS
"KRN",19,23824,"RPC",124,0)
MAGV IMPORT STUDY LOG REPORT
"KRN",19,23824,"RPC",125,0)
MAGV IMPORT STUDY LOG STORE
"KRN",19,23824,"RPC",126,0)
MAGV RAD EXAM ORDER
"KRN",19,23824,"RPC",127,0)
MAGV RAD EXAM REGISTER
"KRN",19,23824,"RPC",128,0)
MAGV RAD STAT COMPLETE
"KRN",19,23824,"RPC",129,0)
MAGV RAD STAT EXAMINED
"KRN",19,23824,"RPC",130,0)
MAGV UPDATE WORK ITEM
"KRN",19,23824,"RPC",131,0)
MAGV WORK ITEMS COUNT
"KRN",19,23824,"RPC",132,0)
PSB GETPROVIDER
"KRN",19,23824,"RPC",133,0)
MAG DICOM GET AE ENTRY
"KRN",19,23824,"RPC",134,0)
MAG DICOM GET AE ENTRY LOC
"KRN",19,23824,"RPC",135,0)
MAGVC WI DELETE
"KRN",19,23824,"RPC",136,0)
MAGVC WI GET
"KRN",19,23824,"RPC",137,0)
MAGVC WI LIST
"KRN",19,23824,"RPC",138,0)
MAGVC WI SUBMIT NEW
"KRN",19,23824,"RPC",139,0)
MAGVC WI UPDATE STATUS
"KRN",19,23824,"RPC",140,0)
MAGV GENERATE DICOM UID
"KRN",19,23824,"RPC",141,0)
MAGV GET RAD DX CODES
"KRN",19,23824,"RPC",142,0)
MAGV GET RAD IMAGING LOCATIONS
"KRN",19,23824,"RPC",143,0)
MAGV GET RAD STD RPTS
"KRN",19,23824,"RPC",144,0)
MAGV ATTACH IRRADIATION DOSE
"KRN",19,23824,"RPC",145,0)
MAGV GET IRRADIATION DOSE
"KRN",19,23824,"RPC",146,0)
MAGV FIND STUDY TIU
"KRN",19,23824,"U")
DICOM VISA
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging-V1 to release 
"PKG",454,20,0)
^9.402P^^
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020319^3020517^126
"PKG",454,22,1,"PAH",1,0)
166^3170703^126
"PKG",454,22,1,"PAH",1,1,0)
^^19^19^3170703
"PKG",454,22,1,"PAH",1,1,1,0)
 
"PKG",454,22,1,"PAH",1,1,2,0)
VistA Imaging V3.0 - Patch 166 LDGW
"PKG",454,22,1,"PAH",1,1,3,0)
 
"PKG",454,22,1,"PAH",1,1,4,0)
Routines:
"PKG",454,22,1,"PAH",1,1,5,0)
       
"PKG",454,22,1,"PAH",1,1,6,0)
MAG7RS 
"PKG",454,22,1,"PAH",1,1,7,0)
MAGBRTE3
"PKG",454,22,1,"PAH",1,1,8,0)
MAGIP166
"PKG",454,22,1,"PAH",1,1,9,0)
MAGT7MA
"PKG",454,22,1,"PAH",1,1,10,0)
MAGTP005
"PKG",454,22,1,"PAH",1,1,11,0)
MAGVIM05 
"PKG",454,22,1,"PAH",1,1,12,0)
                    
"PKG",454,22,1,"PAH",1,1,13,0)
 
"PKG",454,22,1,"PAH",1,1,14,0)
 
"PKG",454,22,1,"PAH",1,1,15,0)
 
"PKG",454,22,1,"PAH",1,1,16,0)
 
"PKG",454,22,1,"PAH",1,1,17,0)
 
"PKG",454,22,1,"PAH",1,1,18,0)
Please note that routine MAGIP166 is deleted after the KIDS build is 
"PKG",454,22,1,"PAH",1,1,19,0)
installed                                         
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","MAG7RS")
0^5^B55362619
"RTN","MAG7RS",1,0)
MAG7RS ;WOIFO/PMK,MLH,SAF,DAC - copy radiology message from HLSDATA to ^MAGDHL7 - add segment data ; 03 Mar 2017 4:11 PM
"RTN","MAG7RS",2,0)
 ;;3.0;IMAGING;**11,40,30,123,138,166**;Mar 19, 2002;Build 45
"RTN","MAG7RS",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAG7RS",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAG7RS",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAG7RS",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAG7RS",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAG7RS",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAG7RS",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAG7RS",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAG7RS",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAG7RS",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAG7RS",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAG7RS",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAG7RS",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAG7RS",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAG7RS",17,0)
 ;;
"RTN","MAG7RS",18,0)
 ;
"RTN","MAG7RS",19,0)
PIDADD ; SUBROUTINE - called by ADDDTA^MAGDHL7
"RTN","MAG7RS",20,0)
 ; Add PID info for DICOM Gateway.
"RTN","MAG7RS",21,0)
 ; Uses multi-tier array structure MAG7WRK produced by call to MAG7UP.
"RTN","MAG7RS",22,0)
 ;
"RTN","MAG7RS",23,0)
 N DIQUIET ; -------------- FileMan verbose/silent variable
"RTN","MAG7RS",24,0)
 N IXPID ; ---------------- index to PID segment in MAG7WRK array
"RTN","MAG7RS",25,0)
 N VADM,VAPA ; ------------ VADPT return arrays
"RTN","MAG7RS",26,0)
 ;
"RTN","MAG7RS",27,0)
 ; ====================================================
"RTN","MAG7RS",28,0)
 ; Get patient DFN and retrieve demo data.
"RTN","MAG7RS",29,0)
 S IXPID=$O(MAG7WRK("B","PID","")) I 'IXPID Q
"RTN","MAG7RS",30,0)
 S DFN=$P($G(MAG7WRK(IXPID,2,1,1,1)),"-",2) ; P166 DAC - DFN was being set incorrectly
"RTN","MAG7RS",31,0)
 I 'DFN S DFN=$G(MAG7WRK(IXPID,3,1,1,1)) I 'DFN Q
"RTN","MAG7RS",32,0)
 ;
"RTN","MAG7RS",33,0)
 ; ================================================
"RTN","MAG7RS",34,0)
 ; load demo information into HL7 PID segment
"RTN","MAG7RS",35,0)
 S DIQUIET=1
"RTN","MAG7RS",36,0)
 D DEM^VADPT ; demo into VADM()
"RTN","MAG7RS",37,0)
 I '$G(VAERR),VADM(3)]"" D
"RTN","MAG7RS",38,0)
 . S MAG7WRK(IXPID,7,1,1,1)=$P(VADM(3),"^")+17000000 ; DOB
"RTN","MAG7RS",39,0)
 . Q
"RTN","MAG7RS",40,0)
 ;
"RTN","MAG7RS",41,0)
 ; ================================================
"RTN","MAG7RS",42,0)
 ; load address information into HL7 PID segment
"RTN","MAG7RS",43,0)
 S DIQUIET=1
"RTN","MAG7RS",44,0)
 D ADD^VADPT ; address & phone into VAPA()
"RTN","MAG7RS",45,0)
 I '$G(VAERR) D
"RTN","MAG7RS",46,0)
 . S MAG7WRK(IXPID,10,1,2,1)=$P(VADM(8),"^",2) ; race
"RTN","MAG7RS",47,0)
 . S MAG7WRK(IXPID,11,1,1,1)=VAPA(1) ; street address 1st line
"RTN","MAG7RS",48,0)
 . S MAG7WRK(IXPID,11,1,2,1)=VAPA(2)_$S(VAPA(3)="":"",1:", "_VAPA(3)) ; lns 2-3
"RTN","MAG7RS",49,0)
 . S MAG7WRK(IXPID,11,1,3,1)=VAPA(4) ; city
"RTN","MAG7RS",50,0)
 . S MAG7WRK(IXPID,11,1,4,1)=VAPA(5) ; 2-letter state
"RTN","MAG7RS",51,0)
 . S MAG7WRK(IXPID,11,1,5,1)=VAPA(6) ; ZIP
"RTN","MAG7RS",52,0)
 . ; phone
"RTN","MAG7RS",53,0)
 . S MAG7WRK(IXPID,13,1,1,1)=VAPA(8)
"RTN","MAG7RS",54,0)
 . S MAG7WRK(IXPID,13,1,2,1)="PRN" ; phone
"RTN","MAG7RS",55,0)
 . Q
"RTN","MAG7RS",56,0)
 Q
"RTN","MAG7RS",57,0)
 ;
"RTN","MAG7RS",58,0)
ADDVSDG ; SUBROUTINE - called by ADDDTA^MAGDHL7
"RTN","MAG7RS",59,0)
 ; Add visit and diagnosis info for DICOM Gateway.
"RTN","MAG7RS",60,0)
 ;
"RTN","MAG7RS",61,0)
 N DIQUIET ; ------ FileMan verbose/silent variable
"RTN","MAG7RS",62,0)
 N I,IX,IX1 ; ----- scratch index vars
"RTN","MAG7RS",63,0)
 N IXPID,IXPV1 ; -- indices to PID, PV1 segs in MAG7WRK array
"RTN","MAG7RS",64,0)
 N IXDG1,IXOBR ; -- indices to DG1, OBR segs in MAG7WRK array
"RTN","MAG7RS",65,0)
 N IXVAEL ; ------- index of entries in VAEL()
"RTN","MAG7RS",66,0)
 N VAIN,VAEL ; ---- VADPT return arrays
"RTN","MAG7RS",67,0)
 N MAGPHYNM ; ----- physician name
"RTN","MAG7RS",68,0)
 N ELCODE ; ------- eligibility code
"RTN","MAG7RS",69,0)
 ;
"RTN","MAG7RS",70,0)
 ; ====================================================
"RTN","MAG7RS",71,0)
 ; Get patient DFN and retrieve inpatient data.
"RTN","MAG7RS",72,0)
 S IXPID=$O(MAG7WRK("B","PID","")) I 'IXPID Q
"RTN","MAG7RS",73,0)
 S DFN=MAG7WRK(IXPID,3,1,1,1) I 'DFN Q
"RTN","MAG7RS",74,0)
 S DIQUIET=1
"RTN","MAG7RS",75,0)
 D INP^VADPT Q:VAERR  ; inpatient data in VAIN()
"RTN","MAG7RS",76,0)
 D ELIG^VADPT Q:VAERR  ; eligibility data in VAEL()
"RTN","MAG7RS",77,0)
 D PV1ADD($S($G(VAIN(1))]"":"IN",1:"OUT"))
"RTN","MAG7RS",78,0)
 ; add pregnancy status and modalities if not already part of order
"RTN","MAG7RS",79,0)
 ; message
"RTN","MAG7RS",80,0)
 I $G(MAG7WRK(1,9,1,1,1))="ORM" D
"RTN","MAG7RS",81,0)
 . S IXOBR=$O(MAG7WRK("B","OBR",""))
"RTN","MAG7RS",82,0)
 . I IXOBR D PV1RAD ; pregnancy status & modality info from Radiology
"RTN","MAG7RS",83,0)
 . Q
"RTN","MAG7RS",84,0)
 Q
"RTN","MAG7RS",85,0)
 ;
"RTN","MAG7RS",86,0)
PV1ADD(XPTSTA) ; SUBROUTINE - called by ADDVSDG
"RTN","MAG7RS",87,0)
 ; Get the index of the PV1 segment - create one for the order message
"RTN","MAG7RS",88,0)
 ; if we need to.
"RTN","MAG7RS",89,0)
 ; 
"RTN","MAG7RS",90,0)
 ; input:  XPTSTA        patient status { IN | OUT }
"RTN","MAG7RS",91,0)
 ; 
"RTN","MAG7RS",92,0)
 ; Expects:  VAEL()      eligibility array from ELIG^VADPT
"RTN","MAG7RS",93,0)
 ;           VAIN()      inpatient data array from INP^VADPT
"RTN","MAG7RS",94,0)
 ;
"RTN","MAG7RS",95,0)
 N FSTAT ; -- status flag returned by MAG7UDR
"RTN","MAG7RS",96,0)
 N IXSEG ; -- segment index in message
"RTN","MAG7RS",97,0)
 N IXPRED ; -- index to predecessor segment
"RTN","MAG7RS",98,0)
 N IXSUCC ; -- index to successor segment
"RTN","MAG7RS",99,0)
 ;
"RTN","MAG7RS",100,0)
 S IXPV1=$O(MAG7WRK("B","PV1",""))
"RTN","MAG7RS",101,0)
 I 'IXPV1 Q:MAG7WRK(1,9,1,1,1)'="ORM"  D
"RTN","MAG7RS",102,0)
 . S (IXSEG,IXPRED)=$O(MAG7WRK("B","PID","")) Q:'IXSEG
"RTN","MAG7RS",103,0)
 . F  S IXSEG=$O(MAG7WRK(IXSEG)) Q:"^PD1^NTE^"'[("^"_$G(MAG7WRK(IXSEG,0))_"^")  S IXPRED=IXSEG
"RTN","MAG7RS",104,0)
 . S IXSUCC=$O(MAG7WRK(IXPRED)),IXPV1=$S(IXSUCC:IXPRED+IXSUCC/2,1:IXPRED+1)
"RTN","MAG7RS",105,0)
 . S MAG7WRK(IXPV1,0)="PV1"
"RTN","MAG7RS",106,0)
 . Q
"RTN","MAG7RS",107,0)
 ;
"RTN","MAG7RS",108,0)
 ; pt status
"RTN","MAG7RS",109,0)
 I XPTSTA="OUT" D  ; if op, just status for now
"RTN","MAG7RS",110,0)
 . S MAG7WRK(IXPV1,2,1,1,1)="O"
"RTN","MAG7RS",111,0)
 . Q
"RTN","MAG7RS",112,0)
 E  I XPTSTA'="IN" D  ; not applicable 
"RTN","MAG7RS",113,0)
 . S MAG7WRK(IXPV1,2,1,1,1)="N"
"RTN","MAG7RS",114,0)
 . Q
"RTN","MAG7RS",115,0)
 E  D  ; get visit information too
"RTN","MAG7RS",116,0)
 . S MAG7WRK(IXPV1,2,1,1,1)="I" ; -- class - always inpatient
"RTN","MAG7RS",117,0)
 . ; location
"RTN","MAG7RS",118,0)
 . ;    point of care <--- ward -- needs to be a triplet for Pete's DICOM msg
"RTN","MAG7RS",119,0)
 . S MAG7WRK(IXPV1,3,1,1,1)=$P(VAIN(4),U)
"RTN","MAG7RS",120,0)
 . S MAG7WRK(IXPV1,3,1,1,2)=$P(VAIN(4),U,2)
"RTN","MAG7RS",121,0)
 . S MAG7WRK(IXPV1,3,1,1,3)="VISTA42"
"RTN","MAG7RS",122,0)
 . S MAG7WRK(IXPV1,3,1,2,1)=$P(VAIN(5),"-") ; -------- room
"RTN","MAG7RS",123,0)
 . S MAG7WRK(IXPV1,3,1,3,1)=$P(VAIN(5),"-",2) ; ------ bed
"RTN","MAG7RS",124,0)
 . ; add segment for admitting dx to ADT and ORM messages
"RTN","MAG7RS",125,0)
 . I $G(VAIN(9))]"" D DG1DGADM^MAG7RSD
"RTN","MAG7RS",126,0)
 . Q
"RTN","MAG7RS",127,0)
 ;
"RTN","MAG7RS",128,0)
 ; add PV1 fields and ROL segments for the attending and referring DRs
"RTN","MAG7RS",129,0)
 S FSTAT=$$PRCTADD^MAG7UDR($NA(MAG7WRK(IXPV1,7)),"ATT") ; attending DR
"RTN","MAG7RS",130,0)
 I $G(MAG7WRK(IXPV1,7,1,1,1)),$G(MAG7WRK(1,9,1,1,1))="ADT" D
"RTN","MAG7RS",131,0)
 . D ROLADD^MAG7RSR($NA(MAG7WRK(IXPV1,7,1)),"AT")
"RTN","MAG7RS",132,0)
 . Q
"RTN","MAG7RS",133,0)
 S FSTAT=$$PRCTADD^MAG7UDR($NA(MAG7WRK(IXPV1,8)),"REF") ; referring DR
"RTN","MAG7RS",134,0)
 I $G(MAG7WRK(IXPV1,8,1,1,1)),$G(MAG7WRK(1,9,1,1,1))="ADT" D
"RTN","MAG7RS",135,0)
 . D ROLADD^MAG7RSR($NA(MAG7WRK(IXPV1,8,1)),"RP")
"RTN","MAG7RS",136,0)
 . Q
"RTN","MAG7RS",137,0)
 I $D(VAEL) D  ; add VIP flag if applicable and not yet present
"RTN","MAG7RS",138,0)
 . S VAEL(1,0)=VAEL(1) ; for easy array navigation
"RTN","MAG7RS",139,0)
 . S IXVAEL=""
"RTN","MAG7RS",140,0)
 . F  Q:$D(IXPV1(16))  S IXVAEL=$O(VAEL(1,IXVAEL)) Q:IXVAEL=""  D
"RTN","MAG7RS",141,0)
 . . S ELCODE=$P($G(VAEL(1,IXVAEL)),"^")
"RTN","MAG7RS",142,0)
 . . I "^6^15^"[("^"_ELCODE_"^") S IXPV1(16,1,1,1,1)=ELCODE
"RTN","MAG7RS",143,0)
 . . Q
"RTN","MAG7RS",144,0)
 . Q
"RTN","MAG7RS",145,0)
 Q
"RTN","MAG7RS",146,0)
 ;
"RTN","MAG7RS",147,0)
PV1RAD ; SUBROUTINE - called by ADDVSDG
"RTN","MAG7RS",148,0)
 ; Add "pregnant" to Ambulatory Status if patient is pregnant.
"RTN","MAG7RS",149,0)
 ; Add modalities to Diagnostic Service Section ID.
"RTN","MAG7RS",150,0)
 ; 
"RTN","MAG7RS",151,0)
 ; Expects:  MAG7WRK()     HL7 message array
"RTN","MAG7RS",152,0)
 ;           IXOBR         Index of OBR segment on MAG7WRK()
"RTN","MAG7RS",153,0)
 ;           IXPV1         Index of PV1 segment on MAG7WRK()
"RTN","MAG7RS",154,0)
 ;           
"RTN","MAG7RS",155,0)
 N RADPT2 ; ------- FileMan date of rad order
"RTN","MAG7RS",156,0)
 N RADPT3 ; ------- index of order under date on Rad/NM pt file
"RTN","MAG7RS",157,0)
 N RADPT0 ; ------- data for order on Rad/NM pt file
"RTN","MAG7RS",158,0)
 N RAOIEN ; ------- index of order on Rad/NM order file
"RTN","MAG7RS",159,0)
 N RAO0 ; --------- data for order on Rad/NM order file
"RTN","MAG7RS",160,0)
 N PROCIEN ; ------ ien of procedure on Rad/NM procedure file
"RTN","MAG7RS",161,0)
 N PROCMOD ; ------ ien of modality on Rad/NM procedure file
"RTN","MAG7RS",162,0)
 N MODIEN ; ------- ien of modality on modality defined terms file
"RTN","MAG7RS",163,0)
 N MODTERM ; ------ term for the modality
"RTN","MAG7RS",164,0)
 N PREGSTAT ; ----- pregnancy status on order
"RTN","MAG7RS",165,0)
 N REPIX ; -------- repetition index
"RTN","MAG7RS",166,0)
 N EDTA ; --------- element data
"RTN","MAG7RS",167,0)
 N AAMBMSG ; ------ ambulatory status array (from message data)
"RTN","MAG7RS",168,0)
 N AMODMSG ; ------ modality array (from message data)
"RTN","MAG7RS",169,0)
 ;
"RTN","MAG7RS",170,0)
 ; get data from Rad/NM pt and order files
"RTN","MAG7RS",171,0)
 S RADPT2=$P(MAG7WRK(IXOBR,3,1,1,1),"-")
"RTN","MAG7RS",172,0)
 S RADPT3=$P(MAG7WRK(IXOBR,3,1,1,1),"-",2)
"RTN","MAG7RS",173,0)
 S RADPT0=$G(^RADPT(DFN,"DT",RADPT2,"P",RADPT3,0))
"RTN","MAG7RS",174,0)
 S RAOIEN=$P(RADPT0,"^",11) ; IEN for ^RAO(75.1)
"RTN","MAG7RS",175,0)
 S RAO0="" I RAOIEN S RAO0=$G(^RAO(75.1,RAOIEN,0))
"RTN","MAG7RS",176,0)
 ;
"RTN","MAG7RS",177,0)
 ; add "pregnant" to ambulatory status if needed
"RTN","MAG7RS",178,0)
 ;   get data from message
"RTN","MAG7RS",179,0)
 S REPIX=""
"RTN","MAG7RS",180,0)
 F  S REPIX=$O(MAG7WRK(IXPV1,15,REPIX)) Q:'REPIX  D
"RTN","MAG7RS",181,0)
 . S EDTA=$G(MAG7WRK(IXPV1,15,REPIX,1,1)) I EDTA]"" S AAMBMSG(EDTA)=""
"RTN","MAG7RS",182,0)
 . Q
"RTN","MAG7RS",183,0)
 ;   get data from Radiology and add to message if needed and not present
"RTN","MAG7RS",184,0)
 S PREGSTAT=$P(RAO0,"^",13) I PREGSTAT="" S PREGSTAT="u"
"RTN","MAG7RS",185,0)
 I '$D(AAMBMSG("B6")),PREGSTAT="y" D
"RTN","MAG7RS",186,0)
 . S MAG7WRK(IXPV1,15,$O(MAG7WRK(IXPV1,15," "),-1)+1,1,1)="B6"
"RTN","MAG7RS",187,0)
 . Q
"RTN","MAG7RS",188,0)
 ;
"RTN","MAG7RS",189,0)
 ; add modalities to Diagnostic Service Section ID
"RTN","MAG7RS",190,0)
 ;   get data from message
"RTN","MAG7RS",191,0)
 F  S REPIX=$O(MAG7WRK(IXOBR,24,REPIX)) Q:'REPIX  D
"RTN","MAG7RS",192,0)
 . S EDTA=$G(MAG7WRK(IXOBR,24,REPIX,1,1)) I EDTA]"" S AMODMSG(EDTA)=""
"RTN","MAG7RS",193,0)
 . Q
"RTN","MAG7RS",194,0)
 ;   get data from Radiology and add to message if needed and not present
"RTN","MAG7RS",195,0)
 S PROCIEN=$P(RADPT0,U,2)
"RTN","MAG7RS",196,0)
 I PROCIEN D
"RTN","MAG7RS",197,0)
 . S PROCMOD=0
"RTN","MAG7RS",198,0)
 . F  S PROCMOD=$O(^RAMIS(71,PROCIEN,"MDL",PROCMOD)) Q:'PROCMOD  D
"RTN","MAG7RS",199,0)
 . . S MODIEN=$P($G(^RAMIS(71,PROCIEN,"MDL",PROCMOD,0)),U)
"RTN","MAG7RS",200,0)
 . . I MODIEN,$D(^RAMIS(73.1,MODIEN,0)) D
"RTN","MAG7RS",201,0)
 . . . S MODTERM=$P($G(^RAMIS(73.1,MODIEN,0)),U)
"RTN","MAG7RS",202,0)
 . . . I MODTERM]"",'$D(AMODMSG(MODTERM)) D
"RTN","MAG7RS",203,0)
 . . . . S MAG7WRK(IXOBR,24,$O(MAG7WRK(IXOBR,24," "),-1)+1,1,1)=MODTERM
"RTN","MAG7RS",204,0)
 . . . . Q
"RTN","MAG7RS",205,0)
 . . . Q
"RTN","MAG7RS",206,0)
 . . Q
"RTN","MAG7RS",207,0)
 . Q
"RTN","MAG7RS",208,0)
 Q
"RTN","MAGBRTE3")
0^6^B17783232
"RTN","MAGBRTE3",1,0)
MAGBRTE3 ;WOIFO/EdM/DAC - Find value of variable ; 02/08/2017  1:05PM
"RTN","MAGBRTE3",2,0)
 ;;3.0;IMAGING;**11,51,166**;Mar 19, 2002;Build 45
"RTN","MAGBRTE3",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGBRTE3",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTE3",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGBRTE3",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGBRTE3",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGBRTE3",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGBRTE3",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGBRTE3",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGBRTE3",11,0)
 ;; |                                                               |
"RTN","MAGBRTE3",12,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGBRTE3",13,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGBRTE3",14,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGBRTE3",15,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGBRTE3",16,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGBRTE3",17,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTE3",18,0)
 ;;
"RTN","MAGBRTE3",19,0)
 Q
"RTN","MAGBRTE3",20,0)
 ;
"RTN","MAGBRTE3",21,0)
 ; The subroutines in this routine calculate the values for
"RTN","MAGBRTE3",22,0)
 ; certain variables that may be needed for the "routing rule processor"
"RTN","MAGBRTE3",23,0)
 ;
"RTN","MAGBRTE3",24,0)
 ; Entry DICOM is the generic value finder that looks for values
"RTN","MAGBRTE3",25,0)
 ; in the data structure that describes an image file.
"RTN","MAGBRTE3",26,0)
 ; The other entries deal with other (computed) values.
"RTN","MAGBRTE3",27,0)
 ;
"RTN","MAGBRTE3",28,0)
 ; The value is always returned in output parameter VAL.
"RTN","MAGBRTE3",29,0)
 ; Note that this variable needs to be an output parameter,
"RTN","MAGBRTE3",30,0)
 ; because in some cases an "undefined value" needs to be returned,
"RTN","MAGBRTE3",31,0)
 ; and in some cases, multiple values may need to be returned.
"RTN","MAGBRTE3",32,0)
 ;
"RTN","MAGBRTE3",33,0)
DICOM(NAME,TYPE,VAL) N C,I,N,X
"RTN","MAGBRTE3",34,0)
 ;
"RTN","MAGBRTE3",35,0)
 ; Arbitrary decision: the routine stops when the first occurrence
"RTN","MAGBRTE3",36,0)
 ; of a value is found.
"RTN","MAGBRTE3",37,0)
 ; Should we continue until we find all codes that have values?
"RTN","MAGBRTE3",38,0)
 ;
"RTN","MAGBRTE3",39,0)
 S C="" F  S C=$O(KEYWORD("CONDITION",NAME,C)) Q:C=""  D  Q:$D(VAL)
"RTN","MAGBRTE3",40,0)
 . Q:'$D(^TMP("MAG",$J,"DICOM",TYPE,C))
"RTN","MAGBRTE3",41,0)
 . S (I,N)=0 F  S N=$O(^TMP("MAG",$J,"DICOM",TYPE,C,N)) Q:N=""  D
"RTN","MAGBRTE3",42,0)
 . . S X=$G(^TMP("MAG",$J,"DICOM",TYPE,C,N,1),"<unknown>") Q:X="<unknown>"
"RTN","MAGBRTE3",43,0)
 . . S I=I+1,N(I)=X
"RTN","MAGBRTE3",44,0)
 . . Q
"RTN","MAGBRTE3",45,0)
 . Q:'I
"RTN","MAGBRTE3",46,0)
 . I I=1 S VAL=N(1) Q
"RTN","MAGBRTE3",47,0)
 . F N=1:1:I S VAL(N)=N(N)
"RTN","MAGBRTE3",48,0)
 . Q
"RTN","MAGBRTE3",49,0)
 Q
"RTN","MAGBRTE3",50,0)
 ;
"RTN","MAGBRTE3",51,0)
NOW(VAL) N %,DISYS,X
"RTN","MAGBRTE3",52,0)
 ; P166 DAC - 'NOW^%DTC' required after update to FileMan v22.2
"RTN","MAGBRTE3",53,0)
 D DT^DICRW,NOW^%DTC
"RTN","MAGBRTE3",54,0)
 S VAL=$P("THU FRI SAT SUN MON TUE WED"," ",$H#7+1)_" "_%
"RTN","MAGBRTE3",55,0)
 Q
"RTN","MAGBRTE3",56,0)
 ;
"RTN","MAGBRTE3",57,0)
SOURCE(IMAGE,VAL) N X
"RTN","MAGBRTE3",58,0)
 S X=$P($G(^MAG(2005,IMAGE,100)),"^",3)
"RTN","MAGBRTE3",59,0)
 S:'X X=$G(DUZ(2))
"RTN","MAGBRTE3",60,0)
 S:'X X=$$KSP^XUPARAM("INST")
"RTN","MAGBRTE3",61,0)
 S VAL=$$GET1^DIQ(4,+X,.01)
"RTN","MAGBRTE3",62,0)
 Q
"RTN","MAGBRTE3",63,0)
 ;
"RTN","MAGBRTE3",64,0)
MAG(IMAGE,TYPE,NODE,PIECE,VAL) N D0,D1,PARENT,X
"RTN","MAGBRTE3",65,0)
 ; First look in the image itself,
"RTN","MAGBRTE3",66,0)
 ; then in its parent (if any)
"RTN","MAGBRTE3",67,0)
 ; then in any siblings.
"RTN","MAGBRTE3",68,0)
 ; Return the first value found.
"RTN","MAGBRTE3",69,0)
 ;
"RTN","MAGBRTE3",70,0)
 K VAL
"RTN","MAGBRTE3",71,0)
 S X=$P($G(^MAG(2005,IMAGE,NODE)),"^",PIECE) I X'="" S VAL=X D:$D(VAL) MAGX Q
"RTN","MAGBRTE3",72,0)
 ;
"RTN","MAGBRTE3",73,0)
 S PARENT=$P($G(^MAG(2005,IMAGE,0)),"^",10) Q:PARENT=""
"RTN","MAGBRTE3",74,0)
 S X=$P($G(^MAG(2005,PARENT,NODE)),"^",PIECE) I X'="" S VAL=X D:$D(VAL) MAGX Q
"RTN","MAGBRTE3",75,0)
 ;
"RTN","MAGBRTE3",76,0)
 S D1=0 F  S D1=$O(^MAG(2005,IMAGE,1,D1)) Q:'D1  D  Q:$D(VAL)
"RTN","MAGBRTE3",77,0)
 . S D0=$G(^MAG(2005,IMAGE,1,D1,1)) Q:'D0
"RTN","MAGBRTE3",78,0)
 . S X=$P($G(^MAG(2005,D0,NODE)),"^",PIECE) I X'="" S VAL=X Q
"RTN","MAGBRTE3",79,0)
 . Q
"RTN","MAGBRTE3",80,0)
 D:$D(VAL) MAGX
"RTN","MAGBRTE3",81,0)
 Q
"RTN","MAGBRTE3",82,0)
 ;
"RTN","MAGBRTE3",83,0)
MAGX I TYPE=0 Q
"RTN","MAGBRTE3",84,0)
 I (TYPE=2005.02)!(TYPE=2005.03)!(TYPE=2005.81)!(TYPE=2005.2) D  Q
"RTN","MAGBRTE3",85,0)
 . S X=$P($G(^MAG(TYPE,+VAL,0)),"^",1) K VAL S:X'="" VAL=X
"RTN","MAGBRTE3",86,0)
 . Q
"RTN","MAGBRTE3",87,0)
 I TYPE=2 D  Q
"RTN","MAGBRTE3",88,0)
 . S X=$P($G(^DPT(+VAL,0)),"^",1) K VAL S:X'="" VAL=X ; IA 10035
"RTN","MAGBRTE3",89,0)
 . Q
"RTN","MAGBRTE3",90,0)
 I TYPE=200 D  Q
"RTN","MAGBRTE3",91,0)
 . S X=$$GET1^DIQ(200,+VAL,.01) K VAL S:X'="" VAL=X ; IA 10060
"RTN","MAGBRTE3",92,0)
 . Q
"RTN","MAGBRTE3",93,0)
 I TYPE=44 D  Q
"RTN","MAGBRTE3",94,0)
 . S X=$P($G(^SC(+VAL,0)),"^",1) K VAL S:X'="" VAL=X ; IA 10040
"RTN","MAGBRTE3",95,0)
 . Q
"RTN","MAGBRTE3",96,0)
 I TYPE=71 D  Q
"RTN","MAGBRTE3",97,0)
 . S X=$P($G(^RAMIS(71,+VAL,0)),"^",1) K VAL S:X'="" VAL=X ; IA 1174
"RTN","MAGBRTE3",98,0)
 . Q
"RTN","MAGBRTE3",99,0)
 I TYPE=74 D  Q
"RTN","MAGBRTE3",100,0)
 . S X=$P($G(^RARPT(+VAL,0)),"^",1) K VAL S:X'="" VAL=X ; IA 1171
"RTN","MAGBRTE3",101,0)
 . Q
"RTN","MAGBRTE3",102,0)
 Q
"RTN","MAGBRTE3",103,0)
 ;
"RTN","MAGBRTE3",104,0)
DATE(IMAGE,TYPE,NODE,PIECE,WHEN,VAL) N D0,D1,FIRST,LAST,PARENT,X
"RTN","MAGBRTE3",105,0)
 ; First look in the image itself,
"RTN","MAGBRTE3",106,0)
 ; then in its parent (if any)
"RTN","MAGBRTE3",107,0)
 ; then in any siblings.
"RTN","MAGBRTE3",108,0)
 ; Return the first value found.
"RTN","MAGBRTE3",109,0)
 ;
"RTN","MAGBRTE3",110,0)
 K VAL
"RTN","MAGBRTE3",111,0)
 I WHEN=0 D MAG(IMAGE,TYPE,NODE,PIECE,.VAL) Q
"RTN","MAGBRTE3",112,0)
 ;
"RTN","MAGBRTE3",113,0)
 S X=$P($G(^MAG(2005,IMAGE,NODE)),"^",PIECE) I X'="" S X(X)=""
"RTN","MAGBRTE3",114,0)
 ;
"RTN","MAGBRTE3",115,0)
 S PARENT=$P($G(^MAG(2005,IMAGE,0)),"^",10) Q:PARENT=""
"RTN","MAGBRTE3",116,0)
 S X=$P($G(^MAG(2005,PARENT,NODE)),"^",PIECE) I X'="" S X(X)=""
"RTN","MAGBRTE3",117,0)
 ;
"RTN","MAGBRTE3",118,0)
 S D1=0 F  S D1=$O(^MAG(2005,IMAGE,1,D1)) Q:'D1  D
"RTN","MAGBRTE3",119,0)
 . S D0=$G(^MAG(2005,IMAGE,1,D1,1)) Q:'D0
"RTN","MAGBRTE3",120,0)
 . S X=$P($G(^MAG(2005,D0,NODE)),"^",PIECE) I X'="" S X(X)=""
"RTN","MAGBRTE3",121,0)
 . Q
"RTN","MAGBRTE3",122,0)
 ;
"RTN","MAGBRTE3",123,0)
 I WHEN=1 S VAL=$O(X(""),+1)
"RTN","MAGBRTE3",124,0)
 I WHEN=2 S VAL=$O(X(""),-1)
"RTN","MAGBRTE3",125,0)
 K:VAL="" VAL
"RTN","MAGBRTE3",126,0)
 Q
"RTN","MAGBRTE3",127,0)
 ;
"RTN","MAGBRTE3",128,0)
URGENCY(IMAGE,VAL) N P
"RTN","MAGBRTE3",129,0)
 S P=$$PRI^MAGBRTE4("NORMAL",IMAGE)
"RTN","MAGBRTE3",130,0)
 S VAL=$S(P=500:"ROUTINE",P=510:"URGENT",P=520:"STAT",1:P)
"RTN","MAGBRTE3",131,0)
 Q
"RTN","MAGBRTE3",132,0)
 ;
"RTN","MAGIP166")
0^1^B4110432
"RTN","MAGIP166",1,0)
MAGIP166 ;WOIFO/DAC - Install code for MAG*3.0*166 ; 08 Mar 2016 10:05 AM
"RTN","MAGIP166",2,0)
 ;;3.0;IMAGING;**166**;Mar 19, 2002;Build 45
"RTN","MAGIP166",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIP166",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP166",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIP166",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIP166",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIP166",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIP166",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIP166",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIP166",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIP166",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIP166",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIP166",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIP166",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIP166",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP166",17,0)
 ;;
"RTN","MAGIP166",18,0)
 ; There are no environment checks here but the MAGIP166 has to be
"RTN","MAGIP166",19,0)
 ; referenced by the "Environment Check Routine" field of the KIDS
"RTN","MAGIP166",20,0)
 ; build so that entry points of the routine are available to the
"RTN","MAGIP166",21,0)
 ; KIDS during all installation phases.
"RTN","MAGIP166",22,0)
 Q
"RTN","MAGIP166",23,0)
 ;
"RTN","MAGIP166",24,0)
 ;+++++ INSTALLATION ERROR HANDLING
"RTN","MAGIP166",25,0)
ERROR ;
"RTN","MAGIP166",26,0)
 S:$D(XPDNM) XPDABORT=1
"RTN","MAGIP166",27,0)
 ;--- Display the messages and store them to the INSTALL file
"RTN","MAGIP166",28,0)
 D DUMP^MAGUERR1(),ABTMSG^MAGKIDS()
"RTN","MAGIP166",29,0)
 Q
"RTN","MAGIP166",30,0)
 ;
"RTN","MAGIP166",31,0)
 ;***** POST-INSTALL CODE
"RTN","MAGIP166",32,0)
POS ;
"RTN","MAGIP166",33,0)
 N CALLBACK
"RTN","MAGIP166",34,0)
 D CLEAR^MAGUERR(1)
"RTN","MAGIP166",35,0)
 ;
"RTN","MAGIP166",36,0)
 ;--- Send the notification e-mail
"RTN","MAGIP166",37,0)
 D BMES^XPDUTL("Post Install Mail Message: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","MAGIP166",38,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGIP166",39,0)
 Q
"RTN","MAGIP166",40,0)
 ;
"RTN","MAGIP166",41,0)
 ;***** PRE-INSTALL CODE
"RTN","MAGIP166",42,0)
PRE ;
"RTN","MAGIP166",43,0)
 Q
"RTN","MAGT7MA")
0^4^B124464922
"RTN","MAGT7MA",1,0)
MAGT7MA ;WOIFO/MLH/PMK/DAC - Telepathology - create HL7 message to DPS ;30 Jun 2017 10:10 AM
"RTN","MAGT7MA",2,0)
 ;;3.0;IMAGING;**138,173,166**;Mar 19, 2002;Build 45
"RTN","MAGT7MA",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGT7MA",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGT7MA",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGT7MA",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGT7MA",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGT7MA",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGT7MA",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGT7MA",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGT7MA",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGT7MA",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGT7MA",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGT7MA",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGT7MA",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGT7MA",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGT7MA",17,0)
 ;;
"RTN","MAGT7MA",18,0)
 Q
"RTN","MAGT7MA",19,0)
 ;
"RTN","MAGT7MA",20,0)
EDIT ; main entry point to create HL7 order message for modification
"RTN","MAGT7MA",21,0)
 N RETURN
"RTN","MAGT7MA",22,0)
 S RETURN=$$BUILDHL7("EDIT")
"RTN","MAGT7MA",23,0)
 I RETURN D ERROR^MAGT7MA(RETURN,"EDIT")
"RTN","MAGT7MA",24,0)
 Q
"RTN","MAGT7MA",25,0)
 ;
"RTN","MAGT7MA",26,0)
NEW ; entry point for to create HL7 order message for a new case
"RTN","MAGT7MA",27,0)
 N MAGNEWCASE ; cause MAGNEWCASE to be undefined (it is set to 1 in LRAPLG1)
"RTN","MAGT7MA",28,0)
 N RETURN
"RTN","MAGT7MA",29,0)
 S RETURN=$$BUILDHL7("NEW")
"RTN","MAGT7MA",30,0)
 I RETURN D ERROR^MAGT7MA(RETURN,"NEW")
"RTN","MAGT7MA",31,0)
 Q
"RTN","MAGT7MA",32,0)
 ;
"RTN","MAGT7MA",33,0)
BUILDHL7(STATE) ; build the segments
"RTN","MAGT7MA",34,0)
 ; Input variables from Lab Package
"RTN","MAGT7MA",35,0)
 ; LRDFN ----- lab file (#63) patient pointer
"RTN","MAGT7MA",36,0)
 ; LRI ------- inverse date in lab file (#63)
"RTN","MAGT7MA",37,0)
 ; LRSS ------ anatomic pathology section abbreviation in lab file (#63) - CY, EM, or SP
"RTN","MAGT7MA",38,0)
 ;
"RTN","MAGT7MA",39,0)
 N ACNUMB ; -- Accession Number (order number, not specimen number)
"RTN","MAGT7MA",40,0)
 N COMPLETED ; date the report was completed
"RTN","MAGT7MA",41,0)
 N DFN ; ----- local copy of DFN obtained from file #63 using LRDFN 
"RTN","MAGT7MA",42,0)
 N FILE ; ---- LAB DATA subfile numbers and other info
"RTN","MAGT7MA",43,0)
 N MSHELTS ; - HL7 element array for the message header
"RTN","MAGT7MA",44,0)
 N ERRMSG ; -- error message returned from called HLO modules
"RTN","MAGT7MA",45,0)
 N HLBIEN ; -- HLO message subscript
"RTN","MAGT7MA",46,0)
 N MSG ; ----- HLO HL7 message pointer
"RTN","MAGT7MA",47,0)
 N IENS ; ---- subscripts to lab patient record
"RTN","MAGT7MA",48,0)
 N RELEASED ;- date/time the report was released
"RTN","MAGT7MA",49,0)
 N SEGNAME ; - segment names to be created
"RTN","MAGT7MA",50,0)
 N SEGELTS ; - HL7 element array for a single segment
"RTN","MAGT7MA",51,0)
 N SETID ; --- counters used for message segments
"RTN","MAGT7MA",52,0)
 N LABDATA ; - array to hold the data for GETS^DIQ call
"RTN","MAGT7MA",53,0)
 N ERROR ; --- error variable for GETS^DIQ call
"RTN","MAGT7MA",54,0)
 ;
"RTN","MAGT7MA",55,0)
 N ERRSTAT S ERRSTAT=0 ; error status - assume nothing to report
"RTN","MAGT7MA",56,0)
 ;
"RTN","MAGT7MA",57,0)
 I $$SENDHL7()'="YES" Q ERRSTAT ; don't send the HL7 if switch isn't "YES"
"RTN","MAGT7MA",58,0)
 ;
"RTN","MAGT7MA",59,0)
 ; is this a new case?  MAGNEWCASE set in LRAPLG1 before call to MAGTP005.
"RTN","MAGT7MA",60,0)
 I $G(MAGNEWCASE)=1 Q ERRSTAT ; ignore the first call for a new case
"RTN","MAGT7MA",61,0)
 ;
"RTN","MAGT7MA",62,0)
 I $G(LRDFN)="" Q ERRSTAT  ; P173 no/null LRDFN - just quit
"RTN","MAGT7MA",63,0)
 I $G(LRI)="" Q ERRSTAT  ; P173 no/null LRI - just quit
"RTN","MAGT7MA",64,0)
 ;
"RTN","MAGT7MA",65,0)
 I $$GET1^DIQ(63,LRDFN,.02)'="PATIENT" Q ERRSTAT  ; not in PATIENT file (#2)
"RTN","MAGT7MA",66,0)
 S DFN=$$GET1^DIQ(63,LRDFN,.03,"I")
"RTN","MAGT7MA",67,0)
 I 'DFN Q ERRSTAT  ; P173 Patient DFN not defined in LAB DATA (#63) file for LRDFN
"RTN","MAGT7MA",68,0)
 ;
"RTN","MAGT7MA",69,0)
 S MSHELTS("EVENT")="O21"
"RTN","MAGT7MA",70,0)
 S MSHELTS("MESSAGE STRUCTURE")="OML_O21"
"RTN","MAGT7MA",71,0)
 S MSHELTS("MESSAGE TYPE")="OML"
"RTN","MAGT7MA",72,0)
 S MSHELTS("VERSION")="2.5.1"
"RTN","MAGT7MA",73,0)
 S MSHELTS("COUNTRY")="USA"
"RTN","MAGT7MA",74,0)
 ;
"RTN","MAGT7MA",75,0)
 I '$$NEWMSG^HLOAPI(.MSHELTS,.MSG,.ERRMSG) S ERRSTAT="-2`HLO MESSAGE INITIALIZATION ERROR ("_ERRMSG_")" Q ERRSTAT
"RTN","MAGT7MA",76,0)
 ;
"RTN","MAGT7MA",77,0)
 ; get FILE information
"RTN","MAGT7MA",78,0)
 S ERRSTAT=$$GETFILE^MAGT7MA(LRSS) ; set FILE value
"RTN","MAGT7MA",79,0)
 Q:ERRSTAT ERRSTAT  ; quit and return the error
"RTN","MAGT7MA",80,0)
 ;
"RTN","MAGT7MA",81,0)
 S IENS=LRI_","_LRDFN_","
"RTN","MAGT7MA",82,0)
 S LABDATA=$NA(^TMP("MAG",$J,"LABDATA"))
"RTN","MAGT7MA",83,0)
 K @LABDATA
"RTN","MAGT7MA",84,0)
 D GETS^DIQ(FILE(0),IENS,"**","I",LABDATA,"ERROR")
"RTN","MAGT7MA",85,0)
 I $D(ERROR) D  Q "-1`ERROR IN GETS^DIQ CALL" ; ignore this error
"RTN","MAGT7MA",86,0)
 . N VARS
"RTN","MAGT7MA",87,0)
 . S VARS="ERROR^FILE(0)^IENS"
"RTN","MAGT7MA",88,0)
 . D ERROR^MAGT7MA("-2`ERROR IN GETS^DIQ CALL","BUILDHL7",VARS)
"RTN","MAGT7MA",89,0)
 . Q
"RTN","MAGT7MA",90,0)
 S ACNUMB=$G(@LABDATA@(FILE(0),IENS,.06,"I"))
"RTN","MAGT7MA",91,0)
 I ACNUMB="" Q "-2`Case not defined in LAB DATA (#63) file for """_LRSS_""" for IENS: """_IENS_""""
"RTN","MAGT7MA",92,0)
 ;
"RTN","MAGT7MA",93,0)
 ; lookup case in MAG PATH CASELIST file(#2005.42)
"RTN","MAGT7MA",94,0)
 I '$D(^MAG(2005.42,"B",ACNUMB)) Q 0 ; not an error, just skip the old case
"RTN","MAGT7MA",95,0)
 ;
"RTN","MAGT7MA",96,0)
 I STATE'="NEW" D
"RTN","MAGT7MA",97,0)
 . S COMPLETED=$$GET1^DIQ(FILE(0),IENS,.03,"I") ; date report completed
"RTN","MAGT7MA",98,0)
 . I COMPLETED S STATE="COMPLETED"
"RTN","MAGT7MA",99,0)
 . ;
"RTN","MAGT7MA",100,0)
 . S RELEASED=$$GET1^DIQ(FILE(0),IENS,.11,"I") ; date/time report released
"RTN","MAGT7MA",101,0)
 . I RELEASED D  ; change status of case in MAG PATH CASELIST (#2005.42)
"RTN","MAGT7MA",102,0)
 . . D STATUPDT^MAGTP005(ACNUMB,"READ")
"RTN","MAGT7MA",103,0)
 . . Q
"RTN","MAGT7MA",104,0)
 . I STATE="CANCELLED" D
"RTN","MAGT7MA",105,0)
 . . ; remove the case from the MAG PATH CASELIST (#2005.42) file
"RTN","MAGT7MA",106,0)
 . . D CANCEL^MAGTP005(ACNUMB)
"RTN","MAGT7MA",107,0)
 . . Q
"RTN","MAGT7MA",108,0)
 . Q
"RTN","MAGT7MA",109,0)
 ;
"RTN","MAGT7MA",110,0)
 D:'ERRSTAT  ; build segments if no error from previous call
"RTN","MAGT7MA",111,0)
 . F SEGNAME="PID","PV1","ORC","TQ1","OBR","NTE","TXT","SPM","IPC" D  Q:ERRSTAT
"RTN","MAGT7MA",112,0)
 . . S ERRSTAT=$$SEGADD^MAGT7S(.MSG,.FILE,LABDATA,STATE,SEGNAME,DFN,LRDFN,LRSS,LRI,IENS,ACNUMB) Q:ERRSTAT
"RTN","MAGT7MA",113,0)
 . . Q
"RTN","MAGT7MA",114,0)
 . Q
"RTN","MAGT7MA",115,0)
 D:'ERRSTAT
"RTN","MAGT7MA",116,0)
 . N WHOTO,PARMS ; --- HLO arrays
"RTN","MAGT7MA",117,0)
 . S PARMS("SENDING APPLICATION")="MAG TELEPATHOLOGY"
"RTN","MAGT7MA",118,0)
 . S WHOTO("RECEIVING APPLICATION")="DIGITAL PATHOLOGY SYSTEM"
"RTN","MAGT7MA",119,0)
 . S WHOTO("FACILITY LINK NAME")="MAG DPS"
"RTN","MAGT7MA",120,0)
 . S HLBIEN=$$SENDONE^HLOAPI1(.MSG,.PARMS,.WHOTO,.ERRMSG)
"RTN","MAGT7MA",121,0)
 . I 'HLBIEN D
"RTN","MAGT7MA",122,0)
 . . S ERRSTAT="-99`HLO MESSAGE QUEUEING ERROR ("_ERRMSG_")"
"RTN","MAGT7MA",123,0)
 . . Q
"RTN","MAGT7MA",124,0)
 . E  D  ; send this to the DICOM Gateway
"RTN","MAGT7MA",125,0)
 . . N FMDATE ;-- fileman date
"RTN","MAGT7MA",126,0)
 . . N FMDATETM ; fileman date/time
"RTN","MAGT7MA",127,0)
 . . N HLMSTATE ; HLO parameters used in OUTPUT^MAGDHOW2
"RTN","MAGT7MA",128,0)
 . . N MSGTYPE ;- HL7 message type
"RTN","MAGT7MA",129,0)
 . . S FMDATETM=$$NOW^XLFDT(),FMDATE=FMDATETM\1
"RTN","MAGT7MA",130,0)
 . . M HLMSTATE=MSG S MSGTYPE="OML"
"RTN","MAGT7MA",131,0)
 . . D OUTPUT^MAGDHOW2
"RTN","MAGT7MA",132,0)
 . . Q
"RTN","MAGT7MA",133,0)
 . Q
"RTN","MAGT7MA",134,0)
 K @LABDATA
"RTN","MAGT7MA",135,0)
 Q ERRSTAT
"RTN","MAGT7MA",136,0)
 ;
"RTN","MAGT7MA",137,0)
GETFILE(LRSS) ; get FILE information
"RTN","MAGT7MA",138,0)
 N ERRSTAT S ERRSTAT=0 ; error status - assume nothing to report
"RTN","MAGT7MA",139,0)
 N IEN ; file 60 internal enter number
"RTN","MAGT7MA",140,0)
 ;
"RTN","MAGT7MA",141,0)
 K FILE
"RTN","MAGT7MA",142,0)
 I LRSS="CY" D
"RTN","MAGT7MA",143,0)
 . S FILE("NAME")="CYTOPATHOLOGY"
"RTN","MAGT7MA",144,0)
 . S FILE(0)=63.09
"RTN","MAGT7MA",145,0)
 . S FILE("FIELD")=9
"RTN","MAGT7MA",146,0)
 . S FILE("ORDERED TEST")=63.51
"RTN","MAGT7MA",147,0)
 . S FILE("SPECIMEN")=63.902
"RTN","MAGT7MA",148,0)
 . S FILE("SPECIMEN","SMEAR PREP")=63.9121
"RTN","MAGT7MA",149,0)
 . S FILE("SPECIMEN","SMEAR PREP","STAIN/PROCEDURE")=63.9122
"RTN","MAGT7MA",150,0)
 . S FILE("SPECIMEN","CELL BLOCK")=63.922
"RTN","MAGT7MA",151,0)
 . S FILE("SPECIMEN","CELL BLOCK","CELL BLOCK STAIN")=63.923
"RTN","MAGT7MA",152,0)
 . S FILE("SPECIMEN","MEMBRANE FILTER")=63.924
"RTN","MAGT7MA",153,0)
 . S FILE("SPECIMEN","MEMBRANE FILTER","MEMBRANE FILTER STAIN")=63.9241
"RTN","MAGT7MA",154,0)
 . S FILE("SPECIMEN","PREPARED SLIDES")=63.9024
"RTN","MAGT7MA",155,0)
 . S FILE("SPECIMEN","PREPARED SLIDES","PREPARED SLIDES STAIN")=63.90241
"RTN","MAGT7MA",156,0)
 . S FILE("SPECIMEN","CYTOSPIN")=63.9025
"RTN","MAGT7MA",157,0)
 . S FILE("SPECIMEN","CYTOSPIN","CYTOSPIN STAIN")=63.90251
"RTN","MAGT7MA",158,0)
 . S FILE("COMMENT")=63.908
"RTN","MAGT7MA",159,0)
 . S FILE("TIU REFERENCE")=63.47
"RTN","MAGT7MA",160,0)
 . S FILE("PARENT FILE")=63.09
"RTN","MAGT7MA",161,0)
 . S FILE("PROC/EVENT")=$O(^MAG(2005.85,"B","CYTOLOGY",""))
"RTN","MAGT7MA",162,0)
 . Q
"RTN","MAGT7MA",163,0)
 E  I LRSS="EM" D
"RTN","MAGT7MA",164,0)
 . S FILE("NAME")="ELECTRON MICROSCOPY"
"RTN","MAGT7MA",165,0)
 . S FILE(0)=63.02
"RTN","MAGT7MA",166,0)
 . S FILE("FIELD")=2
"RTN","MAGT7MA",167,0)
 . S FILE("ORDERED TEST")=63.52
"RTN","MAGT7MA",168,0)
 . S FILE("SPECIMEN")=63.202
"RTN","MAGT7MA",169,0)
 . S FILE("SPECIMEN","EPON BLOCK")=63.2021
"RTN","MAGT7MA",170,0)
 . S FILE("SPECIMEN","EPON BLOCK","EM PROCEDURE")=63.20211
"RTN","MAGT7MA",171,0)
 . S FILE("COMMENT")=63.208
"RTN","MAGT7MA",172,0)
 . S FILE("TIU REFERENCE")=63.49
"RTN","MAGT7MA",173,0)
 . S FILE("PARENT FILE")=63.02
"RTN","MAGT7MA",174,0)
 . S FILE("PROC/EVENT")=$O(^MAG(2005.85,"B","ELECTRON MICROSCOPY",""))
"RTN","MAGT7MA",175,0)
 . Q
"RTN","MAGT7MA",176,0)
 E  I LRSS="SP" D
"RTN","MAGT7MA",177,0)
 . S FILE("NAME")="SURGICAL PATHOLOGY"
"RTN","MAGT7MA",178,0)
 . S FILE(0)=63.08
"RTN","MAGT7MA",179,0)
 . S FILE("FIELD")=8
"RTN","MAGT7MA",180,0)
 . S FILE("ORDERED TEST")=63.53
"RTN","MAGT7MA",181,0)
 . S FILE("SPECIMEN")=63.812
"RTN","MAGT7MA",182,0)
 . S FILE("SPECIMEN","PARAFFIN BLOCK")=63.8121
"RTN","MAGT7MA",183,0)
 . S FILE("SPECIMEN","PARAFFIN BLOCK","STAIN/PROCEDURE")=63.8122
"RTN","MAGT7MA",184,0)
 . S FILE("SPECIMEN","PLASTIC BLOCK")=63.822
"RTN","MAGT7MA",185,0)
 . S FILE("SPECIMEN","PLASTIC BLOCK","PLASTIC STAIN/PROCEDURE")=63.823
"RTN","MAGT7MA",186,0)
 . S FILE("SPECIMEN","FROZEN TISSUE BLOCK")=63.824
"RTN","MAGT7MA",187,0)
 . S FILE("SPECIMEN","FROZEN TISSUE BLOCK","STAIN/PROCEDURE")=63.825
"RTN","MAGT7MA",188,0)
 . S FILE("COMMENT")=63.98
"RTN","MAGT7MA",189,0)
 . S FILE("TIU REFERENCE")=63.19
"RTN","MAGT7MA",190,0)
 . S FILE("PARENT FILE")=63.08
"RTN","MAGT7MA",191,0)
 . S FILE("PROC/EVENT")=$O(^MAG(2005.85,"B","SURGICAL PATHOLOGY",""))
"RTN","MAGT7MA",192,0)
 . Q
"RTN","MAGT7MA",193,0)
 E  S ERRSTAT="-1`Illegal AP section abbreviation: """_LRSS_""""
"RTN","MAGT7MA",194,0)
 ;
"RTN","MAGT7MA",195,0)
 D:'ERRSTAT  ; get default procedure name, first one if multiple
"RTN","MAGT7MA",196,0)
 . N X
"RTN","MAGT7MA",197,0)
 . S IEN=0 F  S IEN=$O(^LAB(60,IEN)) Q:'IEN  D  Q:$D(FILE("PROCEDURE NAME"))
"RTN","MAGT7MA",198,0)
 . . S X=$G(^LAB(60,IEN,0))
"RTN","MAGT7MA",199,0)
 . . Q:$P(X,"^",4)'=LRSS  ; SUBSCRIPT needs to match CY, EM, or SP
"RTN","MAGT7MA",200,0)
 . . Q:"IBO"'[$P(X,"^",3)  ; TYPE needs to be INPUT, OUTPUT, or BOTH
"RTN","MAGT7MA",201,0)
 . . Q:'$P($G(^LAB(60,IEN,64)),"^",1)  ; needs to have a VA National Lab Code (file #64)
"RTN","MAGT7MA",202,0)
 . . S FILE("PROCEDURE NAME")=$$GET1^DIQ(60,IEN,.01)
"RTN","MAGT7MA",203,0)
 . . S FILE("PROCEDURE IEN")=IEN
"RTN","MAGT7MA",204,0)
 . . Q
"RTN","MAGT7MA",205,0)
 . I '$D(FILE("PROCEDURE NAME")) D
"RTN","MAGT7MA",206,0)
 . . S ERRSTAT="-53`No test found in LAB(60) file for LRSS="""_LRSS_""""
"RTN","MAGT7MA",207,0)
 . . Q
"RTN","MAGT7MA",208,0)
 . Q
"RTN","MAGT7MA",209,0)
 ;
"RTN","MAGT7MA",210,0)
 Q ERRSTAT
"RTN","MAGT7MA",211,0)
 ;
"RTN","MAGT7MA",212,0)
REPORT ; main entry point - create HL7 order message for an electronically signed report
"RTN","MAGT7MA",213,0)
 Q:'$G(LRDFN)
"RTN","MAGT7MA",214,0)
 N LRI,PARENTFILE,RETURN,X
"RTN","MAGT7MA",215,0)
 S LRI=$G(LRDATA(1)) Q:LRI=""  ;P173
"RTN","MAGT7MA",216,0)
 S PARENTFILE=$G(LRSF) Q:PARENTFILE=""  ;P173
"RTN","MAGT7MA",217,0)
 S X=$$NEWTIU(LRSS,PARENTFILE,LRDFN,LRI)
"RTN","MAGT7MA",218,0)
 S RETURN=$$BUILDHL7^MAGT7MA("COMPLETED")
"RTN","MAGT7MA",219,0)
 I RETURN D ERROR^MAGT7MA(RETURN,"REPORT")
"RTN","MAGT7MA",220,0)
 Q
"RTN","MAGT7MA",221,0)
 ;
"RTN","MAGT7MA",222,0)
CANCEL ; main entry point - create HL7 order message for a cancelled order
"RTN","MAGT7MA",223,0)
 N RETURN
"RTN","MAGT7MA",224,0)
 S RETURN=$$BUILDHL7^MAGT7MA("CANCELLED")
"RTN","MAGT7MA",225,0)
 I RETURN D ERROR^MAGT7MA(RETURN,"CANCEL")
"RTN","MAGT7MA",226,0)
 Q
"RTN","MAGT7MA",227,0)
 ;
"RTN","MAGT7MA",228,0)
NEWTIU(LRSS,PARENTFILE,LRDFN,LRI) ; check if this is a TIU note to be linked to an image group
"RTN","MAGT7MA",229,0)
 ; if so, create the cross-linkages now
"RTN","MAGT7MA",230,0)
 N CROSSREF,D0,FILEDATA,HIT,MAGGP,MAGIEN,NIMAGE,TIUIEN
"RTN","MAGT7MA",231,0)
 S HIT=0
"RTN","MAGT7MA",232,0)
 S D0=""
"RTN","MAGT7MA",233,0)
 F  S D0=$O(^MAG(2006.5838,"C",PARENTFILE,LRDFN,LRI,D0)) Q:'D0  D
"RTN","MAGT7MA",234,0)
 . S MAGGP=$P($G(^MAG(2006.5838,D0,0)),"^",4) Q:'MAGGP
"RTN","MAGT7MA",235,0)
 . S TIUIEN=$$TIUIEN(LRSS,LRDFN,LRI) Q:'TIUIEN
"RTN","MAGT7MA",236,0)
 . S $P(^MAG(2005,MAGGP,2),"^",6,7)="8925^"_TIUIEN
"RTN","MAGT7MA",237,0)
 . D TIUXLINK ; create the cross-linkages to TIU
"RTN","MAGT7MA",238,0)
 . ; update the parent file pointers for all the images
"RTN","MAGT7MA",239,0)
 . S CROSSREF="8925^"_TIUIEN_"^"_FILEDATA("PARENT FILE PTR")
"RTN","MAGT7MA",240,0)
 . S NIMAGE=0 F  S NIMAGE=$O(^MAG(2005,MAGGP,1,NIMAGE)) Q:'NIMAGE  D
"RTN","MAGT7MA",241,0)
 . . S MAGIEN=$P(^MAG(2005,MAGGP,1,NIMAGE,0),"^")
"RTN","MAGT7MA",242,0)
 . . S $P(^MAG(2005,MAGIEN,2),"^",6,8)=CROSSREF
"RTN","MAGT7MA",243,0)
 . . Q
"RTN","MAGT7MA",244,0)
 . ; remove entries from ^MAG(2006.5838) & decrement the counter
"RTN","MAGT7MA",245,0)
 . K ^MAG(2006.5838,D0),^MAG(2006.5838,"C",PARENTFILE,LRDFN,LRI,D0)
"RTN","MAGT7MA",246,0)
 . L +^MAG(2006.5838):1E9 ; Background process MUST wait
"RTN","MAGT7MA",247,0)
 . S $P(^MAG(2006.5838,0),"^",4)=$P(^MAG(2006.5838,0),"^",4)-1
"RTN","MAGT7MA",248,0)
 . L -^MAG(2006.5838)
"RTN","MAGT7MA",249,0)
 . S HIT=1
"RTN","MAGT7MA",250,0)
 . Q
"RTN","MAGT7MA",251,0)
 Q HIT
"RTN","MAGT7MA",252,0)
 ;
"RTN","MAGT7MA",253,0)
TIUXLINK ; create the cross-linkages to TIU EXTERNAL DATA LINK file
"RTN","MAGT7MA",254,0)
 N TIUXDIEN
"RTN","MAGT7MA",255,0)
 D PUTIMAGE^TIUSRVPL(.TIUXDIEN,TIUIEN,MAGGP) ; DBIA #3566
"RTN","MAGT7MA",256,0)
 I TIUXDIEN D
"RTN","MAGT7MA",257,0)
 . S FILEDATA("PARENT FILE PTR")=TIUXDIEN
"RTN","MAGT7MA",258,0)
 . S $P(^MAG(2005,MAGGP,2),"^",8)=TIUXDIEN
"RTN","MAGT7MA",259,0)
 . Q
"RTN","MAGT7MA",260,0)
 E  D  ; fatal error
"RTN","MAGT7MA",261,0)
 . N MSG
"RTN","MAGT7MA",262,0)
 . S MSG(1)="ERROR ASSOCIATING WITH TIU EXTERNAL DATA LINK (file 8925.91): "
"RTN","MAGT7MA",263,0)
 . S MSG(2)=$P(TIUXDIEN,"^",2,999)
"RTN","MAGT7MA",264,0)
 . S MSG(3)=" for lookup in DICOM LAB TEMP LIST (file 2006.5838)."  ;P173
"RTN","MAGT7MA",265,0)
 . D ERR^MAGGTERR  ;P173
"RTN","MAGT7MA",266,0)
 . Q
"RTN","MAGT7MA",267,0)
 Q
"RTN","MAGT7MA",268,0)
 ;
"RTN","MAGT7MA",269,0)
TIUIEN(LRSS,LRDFN,LRI) ; lookup TIU reference
"RTN","MAGT7MA",270,0)
 N FILE ; ---- LAB DATA subfile numbers and other info
"RTN","MAGT7MA",271,0)
 N LABDATA ;-- array to hold LAB DATA (#63)
"RTN","MAGT7MA",272,0)
 N TIUIEN ;--- TIU file 8925 IEN value
"RTN","MAGT7MA",273,0)
 N TIUREF ;--- Anatomic Pathology reference file
"RTN","MAGT7MA",274,0)
 N ERROR ;---- error return for GETS^DIQ Filename API call
"RTN","MAGT7MA",275,0)
 N ERRSTAT S ERRSTAT=0 ; error status - assume nothing to repor
"RTN","MAGT7MA",276,0)
 ;
"RTN","MAGT7MA",277,0)
 S ERRSTAT=$$GETFILE^MAGT7MA(LRSS)
"RTN","MAGT7MA",278,0)
 I ERRSTAT<0 D  Q 0
"RTN","MAGT7MA",279,0)
 . D ERROR^MAGT7MA(ERRSTAT,"TIUIEN")
"RTN","MAGT7MA",280,0)
 . Q 
"RTN","MAGT7MA",281,0)
 ;
"RTN","MAGT7MA",282,0)
 S TIUREF=FILE("TIU REFERENCE")
"RTN","MAGT7MA",283,0)
 ; look up TIU note
"RTN","MAGT7MA",284,0)
 S IENS="1,"_LRI_","_LRDFN_","
"RTN","MAGT7MA",285,0)
 D GETS^DIQ(TIUREF,IENS,"**","I","LABDATA","ERROR")
"RTN","MAGT7MA",286,0)
 I $D(ERROR) D  Q 0
"RTN","MAGT7MA",287,0)
 . N VARS
"RTN","MAGT7MA",288,0)
 . S VARS="ERROR^TIUREF^IENS"
"RTN","MAGT7MA",289,0)
 . D ERROR^MAGT7MA("-2`ERROR IN GETS^DIQ CALL","TIUIEN",VARS)
"RTN","MAGT7MA",290,0)
 . Q
"RTN","MAGT7MA",291,0)
 S TIUIEN=$G(LABDATA(TIUREF,IENS,1,"I"))
"RTN","MAGT7MA",292,0)
 Q TIUIEN
"RTN","MAGT7MA",293,0)
 ;
"RTN","MAGT7MA",294,0)
ERROR(RETURN,TAG,VARS) ; log the error to the user's email
"RTN","MAGT7MA",295,0)
 N I,SUBJECT,MSG,VARIABLES
"RTN","MAGT7MA",296,0)
 S SUBJECT="Anatomic Pathology HL7 Generation"
"RTN","MAGT7MA",297,0)
 S MSG(1)="An error occurred in "_TAG_"^"_$T(+0)_" when trying to create and/or"
"RTN","MAGT7MA",298,0)
 S MSG(2)="send an HL7 message.  The error message is as follows:"
"RTN","MAGT7MA",299,0)
 S MSG(3)=""""_RETURN_""""
"RTN","MAGT7MA",300,0)
 S MSG(4)=""
"RTN","MAGT7MA",301,0)
 S MSG(5)="Please notify your local IRM Staff."
"RTN","MAGT7MA",302,0)
 S VARIABLES("LRDFN")=""
"RTN","MAGT7MA",303,0)
 S VARIABLES("LRI")=""
"RTN","MAGT7MA",304,0)
 S VARIABLES("LRSS")=""
"RTN","MAGT7MA",305,0)
 I $G(VARS)'="" F I=1:1:$L(VARS,"^") S VARIABLES($P(VARS,"^",I))=""
"RTN","MAGT7MA",306,0)
 D ERROR^MAGDHOWA(SUBJECT,.MSG,.VARIABLES)
"RTN","MAGT7MA",307,0)
 Q
"RTN","MAGT7MA",308,0)
 ;
"RTN","MAGT7MA",309,0)
SENDHL7() ; P166 DAC - Get value of SEND ANATOMIC PATHOLOGY HL7 switch
"RTN","MAGT7MA",310,0)
 N IENS
"RTN","MAGT7MA",311,0)
 S IENS=$O(^MAG(2006.1,"B",DUZ(2),""))_","
"RTN","MAGT7MA",312,0)
 Q $$GET1^DIQ(2006.1,IENS,204)
"RTN","MAGTP005")
0^8^B12863512
"RTN","MAGTP005",1,0)
MAGTP005 ;WOIFO/FG/PMK/DAC - TELEPATHOLOGY RPCS ; 30 Jun 2017 9:55 AM
"RTN","MAGTP005",2,0)
 ;;3.0;IMAGING;**138,166**;Mar 19, 2002;Build 45
"RTN","MAGTP005",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGTP005",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGTP005",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGTP005",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGTP005",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGTP005",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGTP005",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGTP005",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGTP005",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGTP005",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGTP005",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGTP005",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGTP005",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGTP005",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGTP005",17,0)
 ;;
"RTN","MAGTP005",18,0)
 Q  ;
"RTN","MAGTP005",19,0)
 ;
"RTN","MAGTP005",20,0)
 ; +++++ ADD A NEW ENTRY IN FILE (#2005.42) WHEN
"RTN","MAGTP005",21,0)
 ;       GENERATING A NEW CASE FROM FILEMAN
"RTN","MAGTP005",22,0)
 ;
"RTN","MAGTP005",23,0)
 ; LRAC          Accession Code
"RTN","MAGTP005",24,0)
 ;
"RTN","MAGTP005",25,0)
ADD(LRAC) ;
"RTN","MAGTP005",26,0)
 Q:'$$ISLRSSOK(LRSS)  ; check for supported anatomic pathology sections - P166 DAC localized AP check function
"RTN","MAGTP005",27,0)
 ;
"RTN","MAGTP005",28,0)
 N MAGFDA,MAGERR,NOW
"RTN","MAGTP005",29,0)
 S NOW=$$NOW^XLFDT
"RTN","MAGTP005",30,0)
 S MAGFDA(2005.42,"+1,",.01)=LRAC              ; Accession Number
"RTN","MAGTP005",31,0)
 S MAGFDA(2005.42,"+1,",.02)=0                 ; Priority (0:ROUTINE, 1:HIGH, 2:STAT)
"RTN","MAGTP005",32,0)
 S MAGFDA(2005.42,"+1,",.03)=0                 ; Slide available? (0:No, 1:Yes)
"RTN","MAGTP005",33,0)
 S MAGFDA(2005.42,"+1,",.04)=0                 ; Method (0:TRADITIONAL, 1:ROBOTICS, 2:WSI)
"RTN","MAGTP005",34,0)
 S MAGFDA(2005.42,"+1,",.05)="U"               ; Status (U:Unread, R:Read, C:Cancelled)
"RTN","MAGTP005",35,0)
 S MAGFDA(2005.42,"+1,",.06)=NOW               ; Start
"RTN","MAGTP005",36,0)
 S MAGFDA(2005.42,"+1,",.07)=NOW               ; Last Activity
"RTN","MAGTP005",37,0)
 S MAGFDA(2005.42,"+1,",.08)=0                 ; Number of Images
"RTN","MAGTP005",38,0)
 S MAGFDA(2005.42,"+1,",1)=0                   ; Reservation (0:Not Reserved, 1:Reserved)
"RTN","MAGTP005",39,0)
 S MAGFDA(2005.42,"+1,",2)=0                   ; Second  Lock (Accession) (0:Unlocked, 1:Locked)
"RTN","MAGTP005",40,0)
 D UPDATE^DIE("","MAGFDA","","MAGERR")
"RTN","MAGTP005",41,0)
 Q
"RTN","MAGTP005",42,0)
 ;
"RTN","MAGTP005",43,0)
STATUPDT(LRAC,STATUS) ; update the state of the case
"RTN","MAGTP005",44,0)
 N IENS,MAGFDA,MAGERR,NOW
"RTN","MAGTP005",45,0)
 ;
"RTN","MAGTP005",46,0)
 Q:$G(LRAC)=""  Q:$G(STATUS)=""
"RTN","MAGTP005",47,0)
 S STATUS=$E(STATUS) Q:"URC"'[STATUS
"RTN","MAGTP005",48,0)
 ;
"RTN","MAGTP005",49,0)
 S IENS=$O(^MAG(2005.42,"B",LRAC,"")) Q:'IENS
"RTN","MAGTP005",50,0)
 ;
"RTN","MAGTP005",51,0)
 ; update the entry
"RTN","MAGTP005",52,0)
 S IENS=IENS_","
"RTN","MAGTP005",53,0)
 S NOW=$$NOW^XLFDT
"RTN","MAGTP005",54,0)
 S MAGFDA(2005.42,IENS,.05)=STATUS            ; Status (U:Unread, R:Read)
"RTN","MAGTP005",55,0)
 S MAGFDA(2005.42,IENS,.07)=NOW               ; Last Activity
"RTN","MAGTP005",56,0)
 D UPDATE^DIE("","MAGFDA","","MAGERR")
"RTN","MAGTP005",57,0)
 Q
"RTN","MAGTP005",58,0)
 ;
"RTN","MAGTP005",59,0)
CANCEL(LRAC) ; case cancelled - remove it from the file
"RTN","MAGTP005",60,0)
 N DA,DIK,DA
"RTN","MAGTP005",61,0)
 ;
"RTN","MAGTP005",62,0)
 Q:$G(LRAC)=""
"RTN","MAGTP005",63,0)
 S DA=$O(^MAG(2005.42,"B",LRAC,"")) Q:'DA
"RTN","MAGTP005",64,0)
 ;
"RTN","MAGTP005",65,0)
 ; delete the entry
"RTN","MAGTP005",66,0)
 S DIK="^MAG(2005.42,"
"RTN","MAGTP005",67,0)
 D ^DIK
"RTN","MAGTP005",68,0)
 Q
"RTN","MAGTP005",69,0)
 ;
"RTN","MAGTP005",70,0)
IMAGECNT(LRAC,COUNT) ; update the number of images of the case
"RTN","MAGTP005",71,0)
 N IENS,MAGFDA,MAGERR,NOW,NIMAGES,TOTAL
"RTN","MAGTP005",72,0)
 ;
"RTN","MAGTP005",73,0)
 Q:$G(LRAC)=""
"RTN","MAGTP005",74,0)
 S COUNT=$G(COUNT,1)
"RTN","MAGTP005",75,0)
 ;
"RTN","MAGTP005",76,0)
 S IENS=$O(^MAG(2005.42,"B",LRAC,"")) Q:'IENS
"RTN","MAGTP005",77,0)
 S IENS=IENS_","
"RTN","MAGTP005",78,0)
 S NIMAGES=$$GET1^DIQ(2005.42,IENS,.08)
"RTN","MAGTP005",79,0)
 S TOTAL=NIMAGES+COUNT
"RTN","MAGTP005",80,0)
 ;
"RTN","MAGTP005",81,0)
 ; update the entry
"RTN","MAGTP005",82,0)
 S NOW=$$NOW^XLFDT
"RTN","MAGTP005",83,0)
 S MAGFDA(2005.42,IENS,.07)=NOW               ; Last Activity
"RTN","MAGTP005",84,0)
 S MAGFDA(2005.42,IENS,.08)=TOTAL             ; Number of Images
"RTN","MAGTP005",85,0)
 D UPDATE^DIE("","MAGFDA","","MAGERR")
"RTN","MAGTP005",86,0)
 Q
"RTN","MAGTP005",87,0)
ISLRSSOK(LRSS) ; Check for supported anatomic pathology sections - P166 DAC moved AP check from MAGT7MA to MAGTP005
"RTN","MAGTP005",88,0)
 ; So far we support only  CY, EM, or SP
"RTN","MAGTP005",89,0)
 ; Return 1 - supported
"RTN","MAGTP005",90,0)
 ;        0 - not supported
"RTN","MAGTP005",91,0)
 Q LRSS?1(1"SP",1"CY",1"EM")
"RTN","MAGVIM05")
0^7^B152501920
"RTN","MAGVIM05",1,0)
MAGVIM05 ;WOIFO/MAT,BT,JL,DAC - Utilities for RPC calls for DICOM file processing ; 03 Mar 2017  5:04 PM
"RTN","MAGVIM05",2,0)
 ;;3.0;IMAGING;**118,138,164,166**;Mar 19, 2002;Build 45
"RTN","MAGVIM05",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGVIM05",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVIM05",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGVIM05",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGVIM05",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGVIM05",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGVIM05",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGVIM05",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGVIM05",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGVIM05",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGVIM05",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGVIM05",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGVIM05",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGVIM05",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVIM05",17,0)
 ;;
"RTN","MAGVIM05",18,0)
 ;
"RTN","MAGVIM05",19,0)
 Q
"RTN","MAGVIM05",20,0)
 ;
"RTN","MAGVIM05",21,0)
 ;+++++ Wrap call to code underlying RPC: RAMAG EXAM COMPLETE & re-format output
"RTN","MAGVIM05",22,0)
 ;
"RTN","MAGVIM05",23,0)
 ; RPC: MAGV RAD STAT COMPLETE   Private IA #5072
"RTN","MAGVIM05",24,0)
 ;
"RTN","MAGVIM05",25,0)
 ; Inputs:
"RTN","MAGVIM05",26,0)
 ; =======
"RTN","MAGVIM05",27,0)
 ;
"RTN","MAGVIM05",28,0)
 ;  RETURN ...... variable to hold the results
"RTN","MAGVIM05",29,0)
 ;  RADPT ....... IEN of the RAD/NUC MED PATIENT file (#70)
"RTN","MAGVIM05",30,0)
 ;  RAEXAM1 ..... EXAM DATE (#.01) of the REGISTERED EXAMS sub-file (#70.02)
"RTN","MAGVIM05",31,0)
 ;  RAEXAM2 ..... IEN of the EXAMINATIONS sub-file (#70.03)
"RTN","MAGVIM05",32,0)
 ;  MAGVUSR ..... DUZ of the Importer 2 application user.
"RTN","MAGVIM05",33,0)
 ;  MAGVUSRDV ... DUZ(2) of the Importer 2 user.
"RTN","MAGVIM05",34,0)
 ;  RAIMGTYP .... TYPE OF IMAGING (#2) of the REGISTERED EXAMS sub-file (#70.02)
"RTN","MAGVIM05",35,0)
 ; [RASTDRPT] ... IEN of an entry in the STANDARD REPORTS file (#74.1)
"RTN","MAGVIM05",36,0)
 ;           ---- Next two are IEN(s) of entries in the DIAGNOSTIC CODES file(#78.3)
"RTN","MAGVIM05",37,0)
 ; [RADXPRIM]  .. Primary Diagnostic Code --> RAMISC Param PRIMDXCODE
"RTN","MAGVIM05",38,0)
 ; [RADXSCND] ... List of Secondary Diagnostic Codes --> RAMISC Param SECDXCODE
"RTN","MAGVIM05",39,0)
 ;  
"RTN","MAGVIM05",40,0)
 ; Outputs:
"RTN","MAGVIM05",41,0)
 ; ========
"RTN","MAGVIM05",42,0)
 ; 
"RTN","MAGVIM05",43,0)
 ; Notes:
"RTN","MAGVIM05",44,0)
 ; ======
"RTN","MAGVIM05",45,0)
 ; 
"RTN","MAGVIM05",46,0)
 ; The parameters mirror those of the underlying call.
"RTN","MAGVIM05",47,0)
 ;
"RTN","MAGVIM05",48,0)
XMCOMPLT(RETURN,RADPT,RAEXAM1,RAEXAM2,MAGVUSR,MAGVUSRDV,RAIMGTYP,RASTDRPT,RADXPRIM,RADXSCND) ;
"RTN","MAGVIM05",49,0)
 ;
"RTN","MAGVIM05",50,0)
 ;--- Initialize
"RTN","MAGVIM05",51,0)
 K RETURN
"RTN","MAGVIM05",52,0)
 N MSG,RARESULT,SEPSTAT,SEPOUTP D ZRUSEPIN
"RTN","MAGVIM05",53,0)
 ;
"RTN","MAGVIM05",54,0)
 ;--- Validate incoming parameters.
"RTN","MAGVIM05",55,0)
 N MAGERR,PARAM S MAGERR=0
"RTN","MAGVIM05",56,0)
 D
"RTN","MAGVIM05",57,0)
 . F PARAM="RADPT","RAEXAM1","RAEXAM2","MAGVUSR","MAGVUSRDV","RAIMGTYP" D  Q:MAGERR
"RTN","MAGVIM05",58,0)
 . . S:@PARAM="" MAGERR=1
"RTN","MAGVIM05",59,0)
 . . Q
"RTN","MAGVIM05",60,0)
 . Q
"RTN","MAGVIM05",61,0)
 ;
"RTN","MAGVIM05",62,0)
 I MAGERR D  Q
"RTN","MAGVIM05",63,0)
 . S RETURN(0)="-1"_SEPSTAT_"Required parameter "_PARAM_" missing or invalid."
"RTN","MAGVIM05",64,0)
 . Q
"RTN","MAGVIM05",65,0)
 ;
"RTN","MAGVIM05",66,0)
 ;--- Format incoming RAD Exam Identifiers.
"RTN","MAGVIM05",67,0)
 S RAEXAM=RADPT_U_RAEXAM1_U_RAEXAM2
"RTN","MAGVIM05",68,0)
 ;
"RTN","MAGVIM05",69,0)
 ;--- Set IMAGING SITE PARAMETERS file (#2006.1) IEN from DUZ(2).
"RTN","MAGVIM05",70,0)
 N MAGSITEP
"RTN","MAGVIM05",71,0)
 D
"RTN","MAGVIM05",72,0)
 . S MAGVUSRDV=$G(MAGVUSRDV,$G(DUZ(2))),MAGSITEP=$O(^MAG(2006.1,"B",MAGVUSRDV,"")) ;P164
"RTN","MAGVIM05",73,0)
 . I MAGSITEP="" D   ;P164 - if it is not Site IEN, try Station Number
"RTN","MAGVIM05",74,0)
 . . ;--- Get IEN of INSTITUTION file (#4) from STATION NUMBER (Supported IA# 2171)
"RTN","MAGVIM05",75,0)
 . . N IENINST S IENINST=$$IEN^XUAF4(MAGVUSRDV)
"RTN","MAGVIM05",76,0)
 . . S MAGSITEP=$O(^MAG(2006.1,"B",IENINST,"")) Q:+MAGSITEP  ;found the site
"RTN","MAGVIM05",77,0)
 . . S MAGERR=1,MSG="Unable to resolve Imaging Site Parameters entry. {DUZ(2)="_MAGVUSRDV_"} "
"RTN","MAGVIM05",78,0)
 . Q
"RTN","MAGVIM05",79,0)
 ;
"RTN","MAGVIM05",80,0)
 I MAGERR D  Q
"RTN","MAGVIM05",81,0)
 . S RETURN(0)="-1"_SEPSTAT_MSG
"RTN","MAGVIM05",82,0)
 . Q
"RTN","MAGVIM05",83,0)
 ; 
"RTN","MAGVIM05",84,0)
 ;--- Set additional RAD Order/Exam parameters.
"RTN","MAGVIM05",85,0)
 S MAGERR=$$MAKELIST("C",RAIMGTYP,.RAMSC,MAGVUSR,MAGSITEP)
"RTN","MAGVIM05",86,0)
 I MAGERR D  Q
"RTN","MAGVIM05",87,0)
 . S RETURN(0)="-1"_SEPSTAT_$P(MAGERR,U,2)
"RTN","MAGVIM05",88,0)
 . Q
"RTN","MAGVIM05",89,0)
 ;
"RTN","MAGVIM05",90,0)
 ;--- Set flag to insert Primary DX code if passed in.
"RTN","MAGVIM05",91,0)
 D:$G(RADXPRIM)'="" OUTPUT("PRIMDXCODE^^"_RADXPRIM,.RAMSC)
"RTN","MAGVIM05",92,0)
 ;
"RTN","MAGVIM05",93,0)
 ;--- Set flag to insert Secondary DX code(s) if passed in.
"RTN","MAGVIM05",94,0)
 D:$G(RADXSCND(0))'=""
"RTN","MAGVIM05",95,0)
 . ;
"RTN","MAGVIM05",96,0)
 . N CT S CT=""
"RTN","MAGVIM05",97,0)
 . F  S CT=$O(RADXSCND(CT)) Q:CT=""  D OUTPUT("SECDXCODE"_U_(CT+1)_U_RADXSCND(CT),.RAMSC)
"RTN","MAGVIM05",98,0)
 . Q
"RTN","MAGVIM05",99,0)
 ;
"RTN","MAGVIM05",100,0)
 ;--- Set flag to suppress HL7 message to dictation systems.
"RTN","MAGVIM05",101,0)
 D OUTPUT("FLAGS^^FS",.RAMSC)
"RTN","MAGVIM05",102,0)
 ;--- Call code underlying RPC: RAMAG EXAM COMPLETE (Private IA #5072)
"RTN","MAGVIM05",103,0)
 D COMPLETE^RAMAGRP1(.RARESULT,RAEXAM,.RAMSC)
"RTN","MAGVIM05",104,0)
 I $G(RARESULT(1))="-11^2" D  ; add the OUTSIDE STUDY and try the RPC again 
"RTN","MAGVIM05",105,0)
 . N INFO
"RTN","MAGVIM05",106,0)
 . D ADDROOM(.INFO,RAEXAM)
"RTN","MAGVIM05",107,0)
 . K RARESULT
"RTN","MAGVIM05",108,0)
 . I INFO(1)<0 M RARESULT=INFO Q
"RTN","MAGVIM05",109,0)
 . D COMPLETE^RAMAGRP1(.RARESULT,RAEXAM,.RAMSC)
"RTN","MAGVIM05",110,0)
 . Q
"RTN","MAGVIM05",111,0)
 ;
"RTN","MAGVIM05",112,0)
 ;--- Re-format error output or return 0.
"RTN","MAGVIM05",113,0)
 I RARESULT(0)<0 D
"RTN","MAGVIM05",114,0)
 . ;
"RTN","MAGVIM05",115,0)
 . S RETURN(0)=-1_SEPSTAT_$O(RARESULT("A"),-1)_" error lines returned."
"RTN","MAGVIM05",116,0)
 . N X S X=0
"RTN","MAGVIM05",117,0)
 . F  S X=$O(RARESULT(X)) Q:X=""  D
"RTN","MAGVIM05",118,0)
 . . S RETURN(X)=$P(RARESULT(X),U,1)_SEPSTAT_$P(RARESULT(X),U,2,999)
"RTN","MAGVIM05",119,0)
 . . Q
"RTN","MAGVIM05",120,0)
 E  D
"RTN","MAGVIM05",121,0)
 . S RETURN(0)=0_SEPSTAT_RARESULT(0)
"RTN","MAGVIM05",122,0)
 . N X S X=0
"RTN","MAGVIM05",123,0)
 . F  S X=$O(RARESULT(X)) Q:X=""  D
"RTN","MAGVIM05",124,0)
 . . S RETURN(X)=$TR(RARESULT(X),U,SEPOUTP)
"RTN","MAGVIM05",125,0)
 . . Q
"RTN","MAGVIM05",126,0)
 . ;--- Call RA* code to trigger alerts for DX codes.
"RTN","MAGVIM05",127,0)
 . D ALERT^MAGVIMRA(RADPT,RAEXAM1,RAEXAM2,1)
"RTN","MAGVIM05",128,0)
 . Q
"RTN","MAGVIM05",129,0)
 Q
"RTN","MAGVIM05",130,0)
 ;+++++ Wrap call to code underlying RPC: RAMAG EXAMINED & re-format output
"RTN","MAGVIM05",131,0)
 ;
"RTN","MAGVIM05",132,0)
 ; RPC: MAGV RAD STAT EXAMINED  Private IA #5071
"RTN","MAGVIM05",133,0)
 ;
"RTN","MAGVIM05",134,0)
 ; Inputs:
"RTN","MAGVIM05",135,0)
 ; =======
"RTN","MAGVIM05",136,0)
 ;
"RTN","MAGVIM05",137,0)
 ;  See input parameter descriptions above tag XMCOMPLT (above).
"RTN","MAGVIM05",138,0)
 ;
"RTN","MAGVIM05",139,0)
XMEXAMIN(RETURN,RADFN,RAEXAM1,RAEXAM2,MAGVUSR,MAGVUSRDV,RAIMGTYP) ;
"RTN","MAGVIM05",140,0)
 ;
"RTN","MAGVIM05",141,0)
 ;--- Initialize.
"RTN","MAGVIM05",142,0)
 K RETURN
"RTN","MAGVIM05",143,0)
 N MSG,RARESULT,SEPSTAT,SEPOUTP D ZRUSEPIN
"RTN","MAGVIM05",144,0)
 ;--- Validate incoming parameters.
"RTN","MAGVIM05",145,0)
 N MAGERR,PARAM S MAGERR=0
"RTN","MAGVIM05",146,0)
 D
"RTN","MAGVIM05",147,0)
 . F PARAM="RADFN","RAEXAM1","RAEXAM2","MAGVUSR","MAGVUSRDV","RAIMGTYP" D  Q:MAGERR
"RTN","MAGVIM05",148,0)
 . . S:@PARAM="" MAGERR=1
"RTN","MAGVIM05",149,0)
 . . Q
"RTN","MAGVIM05",150,0)
 . Q
"RTN","MAGVIM05",151,0)
 ;
"RTN","MAGVIM05",152,0)
 I MAGERR D  Q
"RTN","MAGVIM05",153,0)
 . S RETURN(0)="-1"_SEPSTAT_"Required parameter "_PARAM_" missing or invalid."
"RTN","MAGVIM05",154,0)
 . Q
"RTN","MAGVIM05",155,0)
 ;
"RTN","MAGVIM05",156,0)
 ;--- Format incoming RAD Exam Identifiers
"RTN","MAGVIM05",157,0)
 N RAEXAM S RAEXAM=RADFN_U_RAEXAM1_U_RAEXAM2
"RTN","MAGVIM05",158,0)
 ;
"RTN","MAGVIM05",159,0)
 ;--- Set IMAGING SITE PARAMETERS file (#2006.1) IEN from DUZ(2).
"RTN","MAGVIM05",160,0)
 N MAGSITEP
"RTN","MAGVIM05",161,0)
 D
"RTN","MAGVIM05",162,0)
 . S MAGVUSRDV=$G(MAGVUSRDV,$G(DUZ(2))),MAGSITEP=$O(^MAG(2006.1,"B",MAGVUSRDV,"")) ;DAC P166
"RTN","MAGVIM05",163,0)
 . I MAGSITEP="" D   ;DAC P166 - if it is not Site IEN, try Station Number
"RTN","MAGVIM05",164,0)
 . . ;--- Get IEN of INSTITUTION file (#4) from STATION NUMBER (Supported IA# 2171)
"RTN","MAGVIM05",165,0)
 . . N IENINST S IENINST=$$IEN^XUAF4(MAGVUSRDV)
"RTN","MAGVIM05",166,0)
 . . I IENINST'="" S MAGSITEP=$O(^MAG(2006.1,"B",IENINST,"")) Q:+MAGSITEP  ;found the site
"RTN","MAGVIM05",167,0)
 . . S MAGERR=1,MSG="Unable to resolve Imaging Site Parameters entry. {DUZ(2)="_MAGVUSRDV_"} "
"RTN","MAGVIM05",168,0)
 . Q
"RTN","MAGVIM05",169,0)
 ;
"RTN","MAGVIM05",170,0)
 I MAGERR D  Q
"RTN","MAGVIM05",171,0)
 . S RETURN(0)="-1"_SEPSTAT_MSG
"RTN","MAGVIM05",172,0)
 . Q
"RTN","MAGVIM05",173,0)
 ; 
"RTN","MAGVIM05",174,0)
 ;
"RTN","MAGVIM05",175,0)
 ;--- Set required parameters
"RTN","MAGVIM05",176,0)
 S MAGERR=$$MAKELIST("E",RAIMGTYP,.RAMSC,MAGVUSR,MAGSITEP)
"RTN","MAGVIM05",177,0)
 I MAGERR D  Q
"RTN","MAGVIM05",178,0)
 . S RETURN(0)="-1"_SEPSTAT_$P(MAGERR,U,2)
"RTN","MAGVIM05",179,0)
 . Q
"RTN","MAGVIM05",180,0)
 ;
"RTN","MAGVIM05",181,0)
 ;--- Set flag to suppress HL7 message to dictation systems.
"RTN","MAGVIM05",182,0)
 D OUTPUT("FLAGS^^FS",.RAMSC)
"RTN","MAGVIM05",183,0)
 ;--- Call code underlying RPC: RAMAG EXAMINED (Private IA #5071).
"RTN","MAGVIM05",184,0)
 D EXAMINED^RAMAGRP2(.RARESULT,RAEXAM,.RAMSC)
"RTN","MAGVIM05",185,0)
 I $G(RARESULT(1))="-11^2" D  ; add the OUTSIDE STUDY and try the RPC again 
"RTN","MAGVIM05",186,0)
 . N INFO
"RTN","MAGVIM05",187,0)
 . D ADDROOM(.INFO,RAEXAM)
"RTN","MAGVIM05",188,0)
 . K RARESULT
"RTN","MAGVIM05",189,0)
 . I INFO(1)<0 M RARESULT=INFO Q
"RTN","MAGVIM05",190,0)
 . D EXAMINED^RAMAGRP2(.RARESULT,RAEXAM,.RAMSC)
"RTN","MAGVIM05",191,0)
 . Q
"RTN","MAGVIM05",192,0)
 ;
"RTN","MAGVIM05",193,0)
 ;--- Re-format error output or return 0.
"RTN","MAGVIM05",194,0)
 I RARESULT(0)<0 D
"RTN","MAGVIM05",195,0)
 . ;
"RTN","MAGVIM05",196,0)
 . S RETURN(0)=-1_SEPSTAT_$O(RARESULT("A"),-1)_" error lines returned."
"RTN","MAGVIM05",197,0)
 . N X S X=0
"RTN","MAGVIM05",198,0)
 . F  S X=$O(RARESULT(X)) Q:X=""  D
"RTN","MAGVIM05",199,0)
 . . S RETURN(X)=$P(RARESULT(X),U,1)_SEPSTAT_$P(RARESULT(X),U,2,999)
"RTN","MAGVIM05",200,0)
 . . Q
"RTN","MAGVIM05",201,0)
 E  D
"RTN","MAGVIM05",202,0)
 . S RETURN(0)=0_SEPSTAT_RARESULT(0)
"RTN","MAGVIM05",203,0)
 . N X S X=0
"RTN","MAGVIM05",204,0)
 . F  S X=$O(RARESULT(X)) Q:X=""  D
"RTN","MAGVIM05",205,0)
 . . S RETURN(X)=$TR(RARESULT(X),U,SEPOUTP)
"RTN","MAGVIM05",206,0)
 . . Q
"RTN","MAGVIM05",207,0)
 . Q
"RTN","MAGVIM05",208,0)
 Q
"RTN","MAGVIM05",209,0)
 ;+++++ Wrap calls to RPC: RAMAG EXAM ORDER & re-format output.
"RTN","MAGVIM05",210,0)
 ;
"RTN","MAGVIM05",211,0)
 ; RPC: MAGV RAD EXAM ORDER  Private IA #5068
"RTN","MAGVIM05",212,0)
 ;
"RTN","MAGVIM05",213,0)
 ; Inputs:
"RTN","MAGVIM05",214,0)
 ; =======
"RTN","MAGVIM05",215,0)
 ;
"RTN","MAGVIM05",216,0)
 ;  RETURN
"RTN","MAGVIM05",217,0)
 ;  DFN
"RTN","MAGVIM05",218,0)
 ;  RAMLC
"RTN","MAGVIM05",219,0)
 ;  RADPROC
"RTN","MAGVIM05",220,0)
 ;  STUDYDAT
"RTN","MAGVIM05",221,0)
 ;  RACAT
"RTN","MAGVIM05",222,0)
 ;  REQLOC
"RTN","MAGVIM05",223,0)
 ;  REQPHYS
"RTN","MAGVIM05",224,0)
 ;  REASON
"RTN","MAGVIM05",225,0)
 ;  MISC
"RTN","MAGVIM05",226,0)
 ;
"RTN","MAGVIM05",227,0)
 ; Notes:
"RTN","MAGVIM05",228,0)
 ; ======
"RTN","MAGVIM05",229,0)
 ; 
"RTN","MAGVIM05",230,0)
 ; The parameters are the same as those of the underlying call.
"RTN","MAGVIM05",231,0)
 ;
"RTN","MAGVIM05",232,0)
XMORDER(RETURN,DFN,RAMLC,RADPROC,STUDYDAT,RACAT,REQLOC,REQPHYS,REASON,MISC) ;
"RTN","MAGVIM05",233,0)
 ;
"RTN","MAGVIM05",234,0)
 K RETURN
"RTN","MAGVIM05",235,0)
 N SEPSTAT,SEPOUTP D ZRUSEPIN
"RTN","MAGVIM05",236,0)
 ;
"RTN","MAGVIM05",237,0)
 ;--- Private IA #5068.
"RTN","MAGVIM05",238,0)
 D ORDER^RAMAGRP1(.ORDINFO,DFN,RAMLC,RADPROC,STUDYDAT,RACAT,REQLOC,REQPHYS,REASON,.MISC)
"RTN","MAGVIM05",239,0)
 ;
"RTN","MAGVIM05",240,0)
 ;--- Re-format error output or return new IEN in RAD/NUC MED ORDERS File (#75.1)
"RTN","MAGVIM05",241,0)
 I ORDINFO(0)<0 D  K ORDINFO
"RTN","MAGVIM05",242,0)
 . ;
"RTN","MAGVIM05",243,0)
 . S RETURN(0)=-1_SEPSTAT_$O(ORDINFO("A"),-1)_" error lines returned."
"RTN","MAGVIM05",244,0)
 . N X S X=0 F  S X=$O(ORDINFO(X)) Q:X=""  D
"RTN","MAGVIM05",245,0)
 . . ;
"RTN","MAGVIM05",246,0)
 . . S RETURN(X)=$P(ORDINFO(X),U,1)_SEPSTAT_$P(ORDINFO(X),U,2,999)
"RTN","MAGVIM05",247,0)
 . . Q
"RTN","MAGVIM05",248,0)
 . Q
"RTN","MAGVIM05",249,0)
 E  S RETURN(0)=ORDINFO(0)
"RTN","MAGVIM05",250,0)
 K ORDINFO
"RTN","MAGVIM05",251,0)
 Q
"RTN","MAGVIM05",252,0)
 ;
"RTN","MAGVIM05",253,0)
 ;+++++ Wrap calls to RPC: RAMAG EXAM REGISTER & re-format output.
"RTN","MAGVIM05",254,0)
 ;
"RTN","MAGVIM05",255,0)
 ; RPC: MAGV RAD EXAM REGISTER  Private IA #5069.
"RTN","MAGVIM05",256,0)
 ; 
"RTN","MAGVIM05",257,0)
 ; Inputs:
"RTN","MAGVIM05",258,0)
 ; =======
"RTN","MAGVIM05",259,0)
 ; 
"RTN","MAGVIM05",260,0)
 ;  RETURN
"RTN","MAGVIM05",261,0)
 ;  RAOIFN
"RTN","MAGVIM05",262,0)
 ;  EXMDTE
"RTN","MAGVIM05",263,0)
 ;  RAMSC
"RTN","MAGVIM05",264,0)
 ;
"RTN","MAGVIM05",265,0)
 ; Notes:
"RTN","MAGVIM05",266,0)
 ; ======
"RTN","MAGVIM05",267,0)
 ; 
"RTN","MAGVIM05",268,0)
 ;  The parameters are the same as those of the underlying call.
"RTN","MAGVIM05",269,0)
 ;
"RTN","MAGVIM05",270,0)
XMREGSTR(RETURN,RAOIFN,EXMDTE,RAMSC) ;
"RTN","MAGVIM05",271,0)
 ;
"RTN","MAGVIM05",272,0)
 K RETURN
"RTN","MAGVIM05",273,0)
 N SEPSTAT,SEPOUTP,IMAGLOC D ZRUSEPIN
"RTN","MAGVIM05",274,0)
 ;
"RTN","MAGVIM05",275,0)
 ; Check if imaging location is present - if not find outside imaging location for procedure and division
"RTN","MAGVIM05",276,0)
 N RODATA S RODATA=$G(^RAO(75.1,RAOIFN,0))
"RTN","MAGVIM05",277,0)
 D:$P(RODATA,U,20)=""
"RTN","MAGVIM05",278,0)
 . N LOCINFO,PROCIEN,RAMLC S PROCIEN=$P(RODATA,U,2)
"RTN","MAGVIM05",279,0)
 . D IMAGELOC(.RAMLC,PROCIEN,DUZ(2))
"RTN","MAGVIM05",280,0)
 . S:$P(RAMLC,SEPSTAT)<0 RETURN(0)=RAMLC
"RTN","MAGVIM05",281,0)
 . Q:$G(RETURN(0))
"RTN","MAGVIM05",282,0)
 . S RAMLC=$P(RAMLC,SEPSTAT,2)
"RTN","MAGVIM05",283,0)
 . ; call the RPC to update the radiology imaging location in the radiology order file (#75.1).
"RTN","MAGVIM05",284,0)
 . D IMAGELOC^MAGDRPCB(.LOCINFO,RAOIFN,RAMLC)
"RTN","MAGVIM05",285,0)
 . I $G(LOCINFO)<0 S RETURN(0)=LOCINFO ;"-1"_SEPSTAT_"Error in rpc MAG DICOM SET IMAGING LOCATION"
"RTN","MAGVIM05",286,0)
 . Q
"RTN","MAGVIM05",287,0)
 ;
"RTN","MAGVIM05",288,0)
 ;Get imaging location IEN (#79.1)
"RTN","MAGVIM05",289,0)
 K RAMLC,PROCIEN
"RTN","MAGVIM05",290,0)
 S PROCIEN=$P(RODATA,U,2)
"RTN","MAGVIM05",291,0)
 D IMAGELOC(.RAMLC,PROCIEN,DUZ(2))
"RTN","MAGVIM05",292,0)
 S:$P(RAMLC,SEPSTAT)<0 RETURN(0)=RAMLC
"RTN","MAGVIM05",293,0)
 Q:$G(RETURN(0))
"RTN","MAGVIM05",294,0)
 S RAMLC=$P(RAMLC,SEPSTAT,2)
"RTN","MAGVIM05",295,0)
 ;Get corresponding hospital location IEN (#44)
"RTN","MAGVIM05",296,0)
 S IMAGLOC=$$GET1^DIQ(79.1,.RAMLC,.01,"I")
"RTN","MAGVIM05",297,0)
 K RAMSC
"RTN","MAGVIM05",298,0)
 S RAMSC(1)="PRINCLIN^^"_$G(IMAGLOC)
"RTN","MAGVIM05",299,0)
 S RAMSC(2)="FLAGS^^D"
"RTN","MAGVIM05",300,0)
 ;
"RTN","MAGVIM05",301,0)
 Q:$G(RETURN(0))
"RTN","MAGVIM05",302,0)
 ;--- Private IA #5069.
"RTN","MAGVIM05",303,0)
 D REGISTER^RAMAGRP1(.RARESULT,RAOIFN,EXMDTE,.RAMSC)
"RTN","MAGVIM05",304,0)
 ;
"RTN","MAGVIM05",305,0)
 I RARESULT(0)<0 D
"RTN","MAGVIM05",306,0)
 . ;
"RTN","MAGVIM05",307,0)
 . S RETURN(0)=-1_SEPSTAT_$O(RARESULT("A"),-1)_" error lines returned."
"RTN","MAGVIM05",308,0)
 . N X S X=0 F  S X=$O(RARESULT(X)) Q:X=""  D
"RTN","MAGVIM05",309,0)
 . . ;
"RTN","MAGVIM05",310,0)
 . . S RETURN(X)=$P(RARESULT(X),U,1)_SEPSTAT_$P(RARESULT(X),U,2,999)
"RTN","MAGVIM05",311,0)
 . . Q
"RTN","MAGVIM05",312,0)
 E  D
"RTN","MAGVIM05",313,0)
 . S RETURN(0)=0_SEPSTAT_RARESULT(0)
"RTN","MAGVIM05",314,0)
 . N X S X=0 F  S X=$O(RARESULT(X)) Q:X=""  D
"RTN","MAGVIM05",315,0)
 . . ;
"RTN","MAGVIM05",316,0)
 . . S RETURN(X)=$TR(RARESULT(X),U,SEPOUTP)
"RTN","MAGVIM05",317,0)
 . . Q
"RTN","MAGVIM05",318,0)
 . Q
"RTN","MAGVIM05",319,0)
 Q
"RTN","MAGVIM05",320,0)
 ;+++ Routine Utility: Initialize Separators
"RTN","MAGVIM05",321,0)
ZRUSEPIN ;
"RTN","MAGVIM05",322,0)
 S SEPOUTP=$$OUTSEP^MAGVIM01
"RTN","MAGVIM05",323,0)
 S SEPSTAT=$$STATSEP^MAGVIM01
"RTN","MAGVIM05",324,0)
 Q
"RTN","MAGVIM05",325,0)
 ;
"RTN","MAGVIM05",326,0)
MAKELIST(RACTION,RAIMGTYP,RAMSC,MAGVUSR,MAGSITEP) ; output required fields
"RTN","MAGVIM05",327,0)
 ; Load required flags 
"RTN","MAGVIM05",328,0)
 N INFO
"RTN","MAGVIM05",329,0)
 D EXMSTREQ^RAMAGRP2(.INFO,RACTION,RAIMGTYP)
"RTN","MAGVIM05",330,0)
 I INFO(0)<0 Q INFO(1)
"RTN","MAGVIM05",331,0)
 ;
"RTN","MAGVIM05",332,0)
 N TODAYHL7
"RTN","MAGVIM05",333,0)
 S TODAYHL7=$$NOW^XLFDT()\1,$E(TODAYHL7)=$E(TODAYHL7)+17
"RTN","MAGVIM05",334,0)
 ;
"RTN","MAGVIM05",335,0)
 N REQ,RADPVAL
"RTN","MAGVIM05",336,0)
 ;REQ001 - technologist
"RTN","MAGVIM05",337,0)
 S REQ(1)="TECH^1^"_MAGVUSR
"RTN","MAGVIM05",338,0)
 ;
"RTN","MAGVIM05",339,0)
 ;REQ002 - resident or staff
"RTN","MAGVIM05",340,0)
 ;REQ003 - detailed procedure - taken care of already
"RTN","MAGVIM05",341,0)
 ;
"RTN","MAGVIM05",342,0)
 ;REQ004 - film entry
"RTN","MAGVIM05",343,0)
 S RADPVAL=$$GET1^DIQ(2006.1,MAGSITEP,"RAD FILM SIZE","I")
"RTN","MAGVIM05",344,0)
 S REQ(4)="FILMSIZE^1^"_RADPVAL_U_"0"
"RTN","MAGVIM05",345,0)
 ;
"RTN","MAGVIM05",346,0)
 ;REQ005 - diagnostic code default, if not supplied by user.
"RTN","MAGVIM05",347,0)
 D:$G(RADXPRIM)=""
"RTN","MAGVIM05",348,0)
 . S RADPVAL=$$GET1^DIQ(2006.1,MAGSITEP,"RAD PRIMARY DIAGNOSTIC CODE","I")
"RTN","MAGVIM05",349,0)
 . S REQ(5)="PRIMDXCODE^^"_RADPVAL
"RTN","MAGVIM05",350,0)
 . Q
"RTN","MAGVIM05",351,0)
 ;
"RTN","MAGVIM05",352,0)
 ;REQ006 - camera / equipment / room
"RTN","MAGVIM05",353,0)
 S RADPVAL=$$GET1^DIQ(2006.1,MAGSITEP,"RAD PRIMARY CAMERA/EQUIP/RM","I")
"RTN","MAGVIM05",354,0)
 S REQ(6)="PRIMCAM^^"_RADPVAL
"RTN","MAGVIM05",355,0)
 ;
"RTN","MAGVIM05",356,0)
 ;REQ007 - reserved
"RTN","MAGVIM05",357,0)
 ;REQ008 - reserved
"RTN","MAGVIM05",358,0)
 ;REQ009 - reserved
"RTN","MAGVIM05",359,0)
 ;REQ010 - reserved
"RTN","MAGVIM05",360,0)
 ;
"RTN","MAGVIM05",361,0)
 ;REQ011 - report entered
"RTN","MAGVIM05",362,0)
 S REQ(11)="RPTDTE^^"_TODAYHL7
"RTN","MAGVIM05",363,0)
 I $G(RASTDRPT)="" D
"RTN","MAGVIM05",364,0)
 . S REQ(11,1)="REPORT^1^Electronically generated report for outside study."
"RTN","MAGVIM05",365,0)
 . Q
"RTN","MAGVIM05",366,0)
 ;--- Add the REPORT text of a selected STANDARD REPORT to the RAMSC array.
"RTN","MAGVIM05",367,0)
 E  D STNDRPRT(RASTDRPT,"R",1)
"RTN","MAGVIM05",368,0)
 ;
"RTN","MAGVIM05",369,0)
 ;REQ012 - verified report
"RTN","MAGVIM05",370,0)
 S REQ(12)="VERDTE^^"_TODAYHL7
"RTN","MAGVIM05",371,0)
 S REQ(12,1)="RPTSTATUS^^EF"
"RTN","MAGVIM05",372,0)
 ;
"RTN","MAGVIM05",373,0)
 ;REQ013 - procedure modifiers required - previously done
"RTN","MAGVIM05",374,0)
 ;
"RTN","MAGVIM05",375,0)
 ;REQ014 - cpt modifiers
"RTN","MAGVIM05",376,0)
 S RADPVAL=$$GET1^DIQ(2006.1,MAGSITEP,"RAD CPT MODIFIERS","I")
"RTN","MAGVIM05",377,0)
 S:RADPVAL REQ(14)="CPTMODS^1^"_RADPVAL
"RTN","MAGVIM05",378,0)
 ;
"RTN","MAGVIM05",379,0)
 ;REQ015 - reserved
"RTN","MAGVIM05",380,0)
 ;
"RTN","MAGVIM05",381,0)
 ;REQ016 - impression
"RTN","MAGVIM05",382,0)
 I $G(RASTDRPT)="" D
"RTN","MAGVIM05",383,0)
 . S REQ(16)="IMPRESSION^1^Electronically generated report for outside study."
"RTN","MAGVIM05",384,0)
 . Q
"RTN","MAGVIM05",385,0)
 ;--- Add the IMPRESSION text of a selected STANDARD REPORT to the RAMSC array.
"RTN","MAGVIM05",386,0)
 E  D STNDRPRT(RASTDRPT,"I",1)
"RTN","MAGVIM05",387,0)
 ;
"RTN","MAGVIM05",388,0)
 N INDEX
"RTN","MAGVIM05",389,0)
 F INDEX=1:1:16 I $P(INFO(0),"^",INDEX) D
"RTN","MAGVIM05",390,0)
 . D:$D(REQ(INDEX)) OUTPUT(REQ(INDEX),.RAMSC)
"RTN","MAGVIM05",391,0)
 . D:$D(REQ(INDEX,1)) OUTPUT(REQ(INDEX,1),.RAMSC)
"RTN","MAGVIM05",392,0)
 . Q
"RTN","MAGVIM05",393,0)
 ;
"RTN","MAGVIM05",394,0)
 Q 0
"RTN","MAGVIM05",395,0)
 ;
"RTN","MAGVIM05",396,0)
 ;+++++ Add selected STANDARD REPORT text to the Miscellaneous Parameters array.
"RTN","MAGVIM05",397,0)
 ;
"RTN","MAGVIM05",398,0)
STNDRPRT(RASTDRPT,SSCR,INDEX1) ;
"RTN","MAGVIM05",399,0)
 ;
"RTN","MAGVIM05",400,0)
 N PREFIX S PREFIX=$S(SSCR="R":"REPORT",SSCR="I":"IMPRESSION")
"RTN","MAGVIM05",401,0)
 ;
"RTN","MAGVIM05",402,0)
 N CT
"RTN","MAGVIM05",403,0)
 S CT=0 F  S CT=$O(^RA(74.1,RASTDRPT,SSCR,CT)) Q:CT=""  D
"RTN","MAGVIM05",404,0)
 . N RPTXT
"RTN","MAGVIM05",405,0)
 . S RPTXT=PREFIX_U_(CT+INDEX1)_U_$G(^RA(74.1,RASTDRPT,SSCR,CT,0)) D OUTPUT(RPTXT,.RAMSC)
"RTN","MAGVIM05",406,0)
 . Q
"RTN","MAGVIM05",407,0)
 Q
"RTN","MAGVIM05",408,0)
 ;
"RTN","MAGVIM05",409,0)
OUTPUT(TEXT,ARRAY) ;
"RTN","MAGVIM05",410,0)
 N I
"RTN","MAGVIM05",411,0)
 S I=$O(ARRAY(""),-1)+1
"RTN","MAGVIM05",412,0)
 S ARRAY(I)=TEXT
"RTN","MAGVIM05",413,0)
 Q
"RTN","MAGVIM05",414,0)
 ;
"RTN","MAGVIM05",415,0)
 ; MAGV OUTSIDE IMAGE LOCATION
"RTN","MAGVIM05",416,0)
 ;
"RTN","MAGVIM05",417,0)
 ; Inputs:
"RTN","MAGVIM05",418,0)
 ; =======
"RTN","MAGVIM05",419,0)
 ;
"RTN","MAGVIM05",420,0)
 ; PROCIEN -- IEN of procedure in RAD/NUC MED PROCEDURES (file #71)
"RTN","MAGVIM05",421,0)
 ; DIVISION - IEN of division in INSTITUTION (file #4)
"RTN","MAGVIM05",422,0)
 ;  
"RTN","MAGVIM05",423,0)
 ; Output:
"RTN","MAGVIM05",424,0)
 ; ========
"RTN","MAGVIM05",425,0)
 ; 
"RTN","MAGVIM05",426,0)
 ;     <0 Error message
"RTN","MAGVIM05",427,0)
 ;      0 IEN of the Outside Image Location in the IMAGE LOCATIONS (file #79.1)
"RTN","MAGVIM05",428,0)
 ;
"RTN","MAGVIM05",429,0)
IMAGELOC(RESULT,PROCIEN,DIVISION) ;
"RTN","MAGVIM05",430,0)
 ; return the outside imaging location for a given radiology procedure and division
"RTN","MAGVIM05",431,0)
 N IEN,IMAGETYPE,SEPSTAT,SEPOUTP D ZRUSEPIN
"RTN","MAGVIM05",432,0)
 K RESULT
"RTN","MAGVIM05",433,0)
 S PROCIEN=$G(PROCIEN)
"RTN","MAGVIM05",434,0)
 I (PROCIEN'>0)!(PROCIEN'=+PROCIEN) D  Q
"RTN","MAGVIM05",435,0)
 . S RESULT="-1"_SEPSTAT_"Invalid or missing Radiology Procedure pointer: """_PROCIEN_"""."
"RTN","MAGVIM05",436,0)
 . Q
"RTN","MAGVIM05",437,0)
 ;
"RTN","MAGVIM05",438,0)
 S DIVISION=$G(DIVISION)
"RTN","MAGVIM05",439,0)
 I (DIVISION'>0)!(DIVISION'=+DIVISION) D  Q
"RTN","MAGVIM05",440,0)
 . S RESULT="-2"_SEPSTAT_"Invalid or missing Division pointer:"""_DIVISION_"""."
"RTN","MAGVIM05",441,0)
 . Q
"RTN","MAGVIM05",442,0)
 ;
"RTN","MAGVIM05",443,0)
 S IMAGETYPE=$$GET1^DIQ(71,PROCIEN,12,"I")
"RTN","MAGVIM05",444,0)
 I 'IMAGETYPE D  Q
"RTN","MAGVIM05",445,0)
 . S RESULT="-3"_SEPSTAT_"Image Type could not be determined for Radiology Procedure pointer: """_PROCIEN_"""."
"RTN","MAGVIM05",446,0)
 . Q
"RTN","MAGVIM05",447,0)
 ;
"RTN","MAGVIM05",448,0)
 I $$GET1^DIQ(4,DIVISION,.01)="" D  Q
"RTN","MAGVIM05",449,0)
 . S RESULT="-4"_SEPSTAT_"Invalid Division (Institution) pointer:"""_DIVISION_"""."
"RTN","MAGVIM05",450,0)
 . Q
"RTN","MAGVIM05",451,0)
 S IEN=$O(^MAGD(2006.5759,"D",DIVISION,IMAGETYPE,""))
"RTN","MAGVIM05",452,0)
 I IEN="" D  Q
"RTN","MAGVIM05",453,0)
 . S RESULT="-5"_SEPSTAT_"Outside Imaging Location could not be determined for Division: "_DIVISION_" & Procedure: """_PROCIEN_"""."
"RTN","MAGVIM05",454,0)
 . Q
"RTN","MAGVIM05",455,0)
 S RESULT=0_SEPSTAT_$$GET1^DIQ(2006.5759,IEN,.01,"I")
"RTN","MAGVIM05",456,0)
 Q
"RTN","MAGVIM05",457,0)
ADDROOM(INFO,RAEXAM) ; add the OUTSIDE STUDY camera equipment room to the IMAGING LOCATION
"RTN","MAGVIM05",458,0)
 ;S RPCERR=$$CALLRPC^MAGM2VCU("MAG DICOM ADD CAMERA EQUIP RM","M",.INFO,RAEXAM)
"RTN","MAGVIM05",459,0)
 D ADDROOM^MAGDRPCB(.INFO,RAEXAM)
"RTN","MAGVIM05",460,0)
 Q 
"VER")
8.0^22.2
"^DD",2006.1,2006.1,204,0)
SEND ANATOMIC PATHOLOGY HL7^S^NO:NO;YES:YES;^7;1^Q
"^DD",2006.1,2006.1,204,3)
Enter NO to turn off ANATOMIC PATHOLOGY HL7 messaging or YES to turn it on.
"^DD",2006.1,2006.1,204,21,0)
^.001^3^3^3170606^^^^
"^DD",2006.1,2006.1,204,21,1,0)
This field governs the sending of Anatomic Pathology HL7 messages.  These messages would be sent to Digital Pathology Systems and other systems used in pathology.
"^DD",2006.1,2006.1,204,21,2,0)
 
"^DD",2006.1,2006.1,204,21,3,0)
Set this field to YES to send these HL7 messages.
"^DD",2006.1,2006.1,204,"DT")
3170509
**END**
**END**
