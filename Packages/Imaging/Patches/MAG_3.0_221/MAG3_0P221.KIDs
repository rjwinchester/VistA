KIDS Distribution saved on Feb 25, 2019@10:20:10
VistA Imaging V3.0 Patch 221 - Image Viewer v3.2 - 02/25/2019 10:20AM
**KIDS**:MAG*3.0*221^

**INSTALL NAME**
MAG*3.0*221
"BLD",3463,0)
MAG*3.0*221^IMAGING^0^3190225^y
"BLD",3463,1,0)
^^22^22^3190225
"BLD",3463,1,1,0)
VistA Imaging V3.0 Patch 221 - Image Viewer v3.2
"BLD",3463,1,2,0)
 
"BLD",3463,1,3,0)
 
"BLD",3463,1,4,0)
Routines:
"BLD",3463,1,5,0)
MAGIP221    new value = 8533414
"BLD",3463,1,6,0)
MAGDQR21    new value = 188496027
"BLD",3463,1,7,0)
MAGGSIA    new value = 35830061
"BLD",3463,1,8,0)
MAGGTIA1    new value = 34088332
"BLD",3463,1,9,0)
MAGNPCHE    new value = 19371617
"BLD",3463,1,10,0)
MAGNUTL2    new value = 23733574
"BLD",3463,1,11,0)
MAGNVQ04    new value = 30558931
"BLD",3463,1,12,0)
MAGNVQ05    new value = 35641804
"BLD",3463,1,13,0)
MAGNVQ07    new value = 5002623
"BLD",3463,1,14,0)
MAGNWRK1    new value = 53919420
"BLD",3463,1,15,0)
MAGSIXG1    new value = 40907827
"BLD",3463,1,16,0)
MAGSIXG2    new value = 69913945
"BLD",3463,1,17,0)
MAGSIXG3    new value = 109262683
"BLD",3463,1,18,0)
MAGVIM01    new value = 195265246
"BLD",3463,1,19,0)
MAGUTL06    new value = 19148168
"BLD",3463,1,20,0)
 
"BLD",3463,1,21,0)
Please note that routine MAGIP221 is deleted after the KIDS Build is
"BLD",3463,1,22,0)
installed.
"BLD",3463,4,0)
^9.64PA^2006.941^1
"BLD",3463,4,2006.941,0)
2006.941
"BLD",3463,4,2006.941,2,0)
^9.641^2006.941^1
"BLD",3463,4,2006.941,2,2006.941,0)
MAG WORK ITEM  (File-top level)
"BLD",3463,4,2006.941,2,2006.941,1,0)
^9.6411^1^1
"BLD",3463,4,2006.941,2,2006.941,1,1,0)
TYPE
"BLD",3463,4,2006.941,222)
y^y^p^^^^n^^n
"BLD",3463,4,2006.941,224)

"BLD",3463,4,"APDD",2006.941,2006.941)

"BLD",3463,4,"APDD",2006.941,2006.941,1)

"BLD",3463,4,"B",2006.941,2006.941)

"BLD",3463,6.3)
V3.0p221Build3463
"BLD",3463,"ABNS",0)
^9.66A^^
"BLD",3463,"ABPKG")
n^n^G.IMAGING DEVELOPMENT TEAM@domain.ext
"BLD",3463,"INI")
PRE^MAGIP221
"BLD",3463,"INID")
n^y^y
"BLD",3463,"INIT")
POS^MAGIP221
"BLD",3463,"KRN",0)
^9.67PA^8994^19
"BLD",3463,"KRN",.4,0)
.4
"BLD",3463,"KRN",.401,0)
.401
"BLD",3463,"KRN",.402,0)
.402
"BLD",3463,"KRN",.403,0)
.403
"BLD",3463,"KRN",.5,0)
.5
"BLD",3463,"KRN",.84,0)
.84
"BLD",3463,"KRN",3.6,0)
3.6
"BLD",3463,"KRN",3.8,0)
3.8
"BLD",3463,"KRN",9.2,0)
9.2
"BLD",3463,"KRN",9.8,0)
9.8
"BLD",3463,"KRN",9.8,"NM",0)
^9.68A^15^15
"BLD",3463,"KRN",9.8,"NM",1,0)
MAGIP221^^0^B8533414
"BLD",3463,"KRN",9.8,"NM",2,0)
MAGDQR21^^0^B188496027
"BLD",3463,"KRN",9.8,"NM",3,0)
MAGGSIA^^0^B35830061
"BLD",3463,"KRN",9.8,"NM",4,0)
MAGGTIA1^^0^B34088332
"BLD",3463,"KRN",9.8,"NM",5,0)
MAGNPCHE^^0^B19371617
"BLD",3463,"KRN",9.8,"NM",6,0)
MAGNUTL2^^0^B23733574
"BLD",3463,"KRN",9.8,"NM",7,0)
MAGNVQ04^^0^B30558931
"BLD",3463,"KRN",9.8,"NM",8,0)
MAGNVQ05^^0^B35641804
"BLD",3463,"KRN",9.8,"NM",9,0)
MAGNVQ07^^0^B5002623
"BLD",3463,"KRN",9.8,"NM",10,0)
MAGNWRK1^^0^B53919420
"BLD",3463,"KRN",9.8,"NM",11,0)
MAGSIXG1^^0^B40907827
"BLD",3463,"KRN",9.8,"NM",12,0)
MAGSIXG2^^0^B69913945
"BLD",3463,"KRN",9.8,"NM",13,0)
MAGSIXG3^^0^B109262683
"BLD",3463,"KRN",9.8,"NM",14,0)
MAGVIM01^^0^B195265246
"BLD",3463,"KRN",9.8,"NM",15,0)
MAGUTL06^^0^B19148168
"BLD",3463,"KRN",9.8,"NM","B","MAGIP221",1)

"BLD",3463,"KRN",9.8,"NM","B","MAGDQR21",2)

"BLD",3463,"KRN",9.8,"NM","B","MAGGSIA",3)

"BLD",3463,"KRN",9.8,"NM","B","MAGGTIA1",4)

"BLD",3463,"KRN",9.8,"NM","B","MAGNPCHE",5)

"BLD",3463,"KRN",9.8,"NM","B","MAGNUTL2",6)

"BLD",3463,"KRN",9.8,"NM","B","MAGNVQ04",7)

"BLD",3463,"KRN",9.8,"NM","B","MAGNVQ05",8)

"BLD",3463,"KRN",9.8,"NM","B","MAGNVQ07",9)

"BLD",3463,"KRN",9.8,"NM","B","MAGNWRK1",10)

"BLD",3463,"KRN",9.8,"NM","B","MAGSIXG1",11)

"BLD",3463,"KRN",9.8,"NM","B","MAGSIXG2",12)

"BLD",3463,"KRN",9.8,"NM","B","MAGSIXG3",13)

"BLD",3463,"KRN",9.8,"NM","B","MAGVIM01",14)

"BLD",3463,"KRN",9.8,"NM","B","MAGUTL06",15)

"BLD",3463,"KRN",19,0)
19
"BLD",3463,"KRN",19.1,0)
19.1
"BLD",3463,"KRN",101,0)
101
"BLD",3463,"KRN",409.61,0)
409.61
"BLD",3463,"KRN",771,0)
771
"BLD",3463,"KRN",870,0)
870
"BLD",3463,"KRN",8989.51,0)
8989.51
"BLD",3463,"KRN",8989.51,"NM",0)
^9.68A^2^2
"BLD",3463,"KRN",8989.51,"NM",1,0)
MAG PRECACHE ACQ ENABLED^^0
"BLD",3463,"KRN",8989.51,"NM",2,0)
MAG PRECACHE RAD REG ENABLED^^0
"BLD",3463,"KRN",8989.51,"NM","B","MAG PRECACHE ACQ ENABLED",1)

"BLD",3463,"KRN",8989.51,"NM","B","MAG PRECACHE RAD REG ENABLED",2)

"BLD",3463,"KRN",8989.52,0)
8989.52
"BLD",3463,"KRN",8994,0)
8994
"BLD",3463,"KRN",8994,"NM",0)
^9.68A^2^2
"BLD",3463,"KRN",8994,"NM",1,0)
MAGN PATIENT IMAGE LIST^^0
"BLD",3463,"KRN",8994,"NM",2,0)
MAGN PRECACHE BY CPT^^0
"BLD",3463,"KRN",8994,"NM","B","MAGN PATIENT IMAGE LIST",1)

"BLD",3463,"KRN",8994,"NM","B","MAGN PRECACHE BY CPT",2)

"BLD",3463,"KRN","B",.4,.4)

"BLD",3463,"KRN","B",.401,.401)

"BLD",3463,"KRN","B",.402,.402)

"BLD",3463,"KRN","B",.403,.403)

"BLD",3463,"KRN","B",.5,.5)

"BLD",3463,"KRN","B",.84,.84)

"BLD",3463,"KRN","B",3.6,3.6)

"BLD",3463,"KRN","B",3.8,3.8)

"BLD",3463,"KRN","B",9.2,9.2)

"BLD",3463,"KRN","B",9.8,9.8)

"BLD",3463,"KRN","B",19,19)

"BLD",3463,"KRN","B",19.1,19.1)

"BLD",3463,"KRN","B",101,101)

"BLD",3463,"KRN","B",409.61,409.61)

"BLD",3463,"KRN","B",771,771)

"BLD",3463,"KRN","B",870,870)

"BLD",3463,"KRN","B",8989.51,8989.51)

"BLD",3463,"KRN","B",8989.52,8989.52)

"BLD",3463,"KRN","B",8994,8994)

"BLD",3463,"REQB",0)
^9.611^3^3
"BLD",3463,"REQB",1,0)
MAG*3.0*119^2
"BLD",3463,"REQB",2,0)
MAG*3.0*167^2
"BLD",3463,"REQB",3,0)
MAG*3.0*201^2
"BLD",3463,"REQB","B","MAG*3.0*119",1)

"BLD",3463,"REQB","B","MAG*3.0*167",2)

"BLD",3463,"REQB","B","MAG*3.0*201",3)

"FIA",2006.941)
MAG WORK ITEM
"FIA",2006.941,0)
^MAGV(2006.941,
"FIA",2006.941,0,0)
2006.941D
"FIA",2006.941,0,1)
y^y^p^^^^n^^n
"FIA",2006.941,0,10)

"FIA",2006.941,0,11)

"FIA",2006.941,0,"RLRO")

"FIA",2006.941,2006.941)
1
"FIA",2006.941,2006.941,1)

"INI")
PRE^MAGIP221
"INIT")
POS^MAGIP221
"IX",2006.941,2006.941,"C",0)
2006.941^C^Cross-reference on TYPE, STATUS, LOCATION, and LAST UPDATED DATE/TIME^R^^R^IR^I^2006.941^^^^^LS
"IX",2006.941,2006.941,"C",.1,0)
^^2^2^3181101^
"IX",2006.941,2006.941,"C",.1,1,0)
This is a cross-reference by work item TYPE, STATUS, LOCATION, and LAST 
"IX",2006.941,2006.941,"C",.1,2,0)
UPDATED DATE/TIME.
"IX",2006.941,2006.941,"C",1)
S ^MAGV(2006.941,"C",X(1),X(2),X(3),X(4),DA)=""
"IX",2006.941,2006.941,"C",2)
K ^MAGV(2006.941,"C",X(1),X(2),X(3),X(4),DA)
"IX",2006.941,2006.941,"C",2.5)
K ^MAGV(2006.941,"C")
"IX",2006.941,2006.941,"C",11.1,0)
^.114IA^4^4
"IX",2006.941,2006.941,"C",11.1,1,0)
1^F^2006.941^1^^1^F
"IX",2006.941,2006.941,"C",11.1,2,0)
2^F^2006.941^3^^2^F
"IX",2006.941,2006.941,"C",11.1,3,0)
3^F^2006.941^4^^3^F
"IX",2006.941,2006.941,"C",11.1,4,0)
4^F^2006.941^9^^4^F
"IX",2006.941,2006.941,"C",11.1,4,3)

"KRN",8989.51,123457,-1)
1^1
"KRN",8989.51,123457,0)
MAG PRECACHE ACQ ENABLED
"KRN",8989.51,123458,-1)
1^2
"KRN",8989.51,123458,0)
MAG PRECACHE RAD REG ENABLED
"KRN",8994,123459,-1)
0^1
"KRN",8994,123459,0)
MAGN PATIENT IMAGE LIST^IMAGEL^MAGNVQ04^4^R^0^^1
"KRN",8994,123459,1,0)
^^1^1^3170927^
"KRN",8994,123459,1,1,0)
List Images by Patient
"KRN",8994,123459,2,0)
^8994.02A^7^7
"KRN",8994,123459,2,1,0)
IDTYPE^1^^1^1
"KRN",8994,123459,2,1,1,0)
^^1^1^3170927^
"KRN",8994,123459,2,1,1,1,0)
"DFN"or "ICN"
"KRN",8994,123459,2,2,0)
ID^1^^1^2
"KRN",8994,123459,2,2,1,0)
^^1^1^3170927^
"KRN",8994,123459,2,2,1,1,0)
Patient ID
"KRN",8994,123459,2,3,0)
IMGLESS^1^^0^3
"KRN",8994,123459,2,3,1,0)
^8994.021^1^1^3170927^^
"KRN",8994,123459,2,3,1,1,0)
flag to speed up queries: if=1 (true), just get study-level data
"KRN",8994,123459,2,4,0)
FLAGS^1^^0^4
"KRN",8994,123459,2,4,1,0)
^8994.021^1^1^3170927^^
"KRN",8994,123459,2,4,1,1,0)
for feature use
"KRN",8994,123459,2,5,0)
FROMDATE^1^^^5
"KRN",8994,123459,2,5,1,0)
^^11^11^3081107^
"KRN",8994,123459,2,5,1,1,0)
Beginning of the date range for image selection. Date can be in internal
"KRN",8994,123459,2,5,1,2,0)
or external FileMan format. If the parameter is not defined or empty, then
"KRN",8994,123459,2,5,1,3,0)
the date range remains open on this side.
"KRN",8994,123459,2,5,1,4,0)
 
"KRN",8994,123459,2,5,1,5,0)
Depending on the value of the FLAGS parameter, the date range filter is
"KRN",8994,123459,2,5,1,6,0)
applied either to the exam/procedure dates (PROCEDURE/EXAM DATE/TIME field
"KRN",8994,123459,2,5,1,7,0)
(15)) or image capture dates (DATE/TIME IMAGE SAVED field (7)).
"KRN",8994,123459,2,5,1,8,0)
 
"KRN",8994,123459,2,5,1,9,0)
Time parts of date range parameters are ignored and both ends of the date
"KRN",8994,123459,2,5,1,10,0)
range are included in the search. For example, in order to search images
"KRN",8994,123459,2,5,1,11,0)
for May 21, 2008, the internal value of both parameters should be 3080521.
"KRN",8994,123459,2,6,0)
TODATE^1^^^6
"KRN",8994,123459,2,6,1,0)
^^11^11^3081107^
"KRN",8994,123459,2,6,1,1,0)
End of the date range for image selection. Dates can be in internal or
"KRN",8994,123459,2,6,1,2,0)
external FileMan format. If the parameter is not defined or empty, then
"KRN",8994,123459,2,6,1,3,0)
the date range remains open on this side.
"KRN",8994,123459,2,6,1,4,0)
 
"KRN",8994,123459,2,6,1,5,0)
Depending on the value of the FLAGS parameter, the date range filter is
"KRN",8994,123459,2,6,1,6,0)
applied either to the exam/procedure dates (PROCEDURE/EXAM DATE/TIME field
"KRN",8994,123459,2,6,1,7,0)
(15)) or image capture dates (DATE/TIME IMAGE SAVED field (7)).
"KRN",8994,123459,2,6,1,8,0)
 
"KRN",8994,123459,2,6,1,9,0)
Time parts of date range parameters are ignored and both ends of the date
"KRN",8994,123459,2,6,1,10,0)
range are included in the search. For example, in order to search images
"KRN",8994,123459,2,6,1,11,0)
for May 21, 2008, the internal value of both parameters should be 3080521.
"KRN",8994,123459,2,7,0)
MISCPRMS^2^^^7
"KRN",8994,123459,2,7,1,0)
^^78^78^3090126^
"KRN",8994,123459,2,7,1,1,0)
Items of this list define various filter parameters. Each item has 3 or
"KRN",8994,123459,2,7,1,2,0)
more pieces separated by '^':
"KRN",8994,123459,2,7,1,3,0)
 
"KRN",8994,123459,2,7,1,4,0)
  ^01: Parameter name
"KRN",8994,123459,2,7,1,5,0)
  ^02: Index (for multiples and word-processing values)
"KRN",8994,123459,2,7,1,6,0)
  ^03: Value1
"KRN",8994,123459,2,7,1,7,0)
  ^04: Value2
"KRN",8994,123459,2,7,1,8,0)
  ...
"KRN",8994,123459,2,7,1,9,0)
 
"KRN",8994,123459,2,7,1,10,0)
The following filter parameters are supported by this remote procedure:
"KRN",8994,123459,2,7,1,11,0)
 
"KRN",8994,123459,2,7,1,12,0)
  CAPTAPP^^{Name or Code}^{Name or Code}^...
"KRN",8994,123459,2,7,1,13,0)
    Internal or external values of the CAPTURE APPLICATION
"KRN",8994,123459,2,7,1,14,0)
    field (8.1) of the file #2005.
"KRN",8994,123459,2,7,1,15,0)
 
"KRN",8994,123459,2,7,1,16,0)
  GDESC^^{Text}
"KRN",8994,123459,2,7,1,17,0)
    Text that should be present in the SHORT DESCRIPTION
"KRN",8994,123459,2,7,1,18,0)
    field (10) of the IMAGE file (#2005). The comparison
"KRN",8994,123459,2,7,1,19,0)
    is case-insensitive.
"KRN",8994,123459,2,7,1,20,0)
 
"KRN",8994,123459,2,7,1,21,0)
  IDFN^^{DFN}
"KRN",8994,123459,2,7,1,22,0)
    Patient IEN (DFN). If this parameter is not defined, all
"KRN",8994,123459,2,7,1,23,0)
    patients' images are considered.
"KRN",8994,123459,2,7,1,24,0)
 
"KRN",8994,123459,2,7,1,25,0)
  ISTAT^^{Name or Code}^{Name or Code}^...
"KRN",8994,123459,2,7,1,26,0)
    Internal or external values of the STATUS field (113)
"KRN",8994,123459,2,7,1,27,0)
    of the file #2005. 0 (zero) code selects image records
"KRN",8994,123459,2,7,1,28,0)
    with empty STATUS field.
"KRN",8994,123459,2,7,1,29,0)
 
"KRN",8994,123459,2,7,1,30,0)
  IXCLASS^^{Name or IEN}^{Name or IEN}^...
"KRN",8994,123459,2,7,1,31,0)
    Image class names or IENs (see the CLASS INDEX field (41)
"KRN",8994,123459,2,7,1,32,0)
    of the file #2005 for details).
"KRN",8994,123459,2,7,1,33,0)
 
"KRN",8994,123459,2,7,1,34,0)
  IXORIGIN^^{Name or Code}^{Name or Code}^...
"KRN",8994,123459,2,7,1,35,0)
    Internal or external values of the ORIGIN INDEX field (45)
"KRN",8994,123459,2,7,1,36,0)
    of the file #2005.
"KRN",8994,123459,2,7,1,37,0)
 
"KRN",8994,123459,2,7,1,38,0)
  IXPKG^^{Name or Code}^{Name or Code}^...
"KRN",8994,123459,2,7,1,39,0)
    Internal or external values of the PACKAGE INDEX field (40)
"KRN",8994,123459,2,7,1,40,0)
    of the file #2005.
"KRN",8994,123459,2,7,1,41,0)
 
"KRN",8994,123459,2,7,1,42,0)
  IXPROC^^{Name or IEN}^{Name or IEN}^...
"KRN",8994,123459,2,7,1,43,0)
    Procedure/Event names or IENs (see the PROC/EVENT INDEX
"KRN",8994,123459,2,7,1,44,0)
    field (43) of the file #2005 for details).
"KRN",8994,123459,2,7,1,45,0)
 
"KRN",8994,123459,2,7,1,46,0)
  IXSPEC^^{Name or IEN}^{Name or IEN}^...
"KRN",8994,123459,2,7,1,47,0)
    Specialty/SubSpecialty names or IENs (see the SPEC/SUBSPEC
"KRN",8994,123459,2,7,1,48,0)
    INDEX field (44) of the file #2005 for details).
"KRN",8994,123459,2,7,1,49,0)
 
"KRN",8994,123459,2,7,1,50,0)
  IXTYPE^^{Name or IEN}^{Name or IEN}^...
"KRN",8994,123459,2,7,1,51,0)
    Image type names or IENs (see the TYPE INDEX field (42) of
"KRN",8994,123459,2,7,1,52,0)
    the file #2005 for details).
"KRN",8994,123459,2,7,1,53,0)
 
"KRN",8994,123459,2,7,1,54,0)
  SAVEDBY^^{DUZ}
"KRN",8994,123459,2,7,1,55,0)
    If this parameter is defined, then only those images that were
"KRN",8994,123459,2,7,1,56,0)
    captured by this user (see the IMAGE SAVE BY field (8) of the
"KRN",8994,123459,2,7,1,57,0)
    file #2005 for details) are considered.
"KRN",8994,123459,2,7,1,58,0)
 
"KRN",8994,123459,2,7,1,59,0)
  SENSIMG^^{Name or Code}^{Name or Code}^...
"KRN",8994,123459,2,7,1,60,0)
    Internal or external values of the CONTROLLED IMAGE field (112)
"KRN",8994,123459,2,7,1,61,0)
    of the file #2005.
"KRN",8994,123459,2,7,1,62,0)
 
"KRN",8994,123459,2,7,1,63,0)
For pointer type parameters, pure numeric values are always treated as
"KRN",8994,123459,2,7,1,64,0)
internal entry numbers (IEN).
"KRN",8994,123459,2,7,1,65,0)
 
"KRN",8994,123459,2,7,1,66,0)
Parameters can be added to the list in any order. See comments preceding
"KRN",8994,123459,2,7,1,67,0)
the GETIMGS^MAGSIXG1 for more details.
"KRN",8994,123459,2,7,1,68,0)
 
"KRN",8994,123459,2,7,1,69,0)
Example:
"KRN",8994,123459,2,7,1,70,0)
 
"KRN",8994,123459,2,7,1,71,0)
  with RPCBroker.Param[4] do
"KRN",8994,123459,2,7,1,72,0)
    begin
"KRN",8994,123459,2,7,1,73,0)
      PType := list;
"KRN",8994,123459,2,7,1,74,0)
      Mult[1] := 'IXPKG^^RAD^LAB';
"KRN",8994,123459,2,7,1,75,0)
      Mult[2] := 'IXCLASS^^1^ADMIN';
"KRN",8994,123459,2,7,1,76,0)
      Mult[3] := 'IXORIGIN^^NON-VA^F';
"KRN",8994,123459,2,7,1,77,0)
      Mult[4] := 'IDFN^^2341'; 
"KRN",8994,123459,2,7,1,78,0)
    end;
"KRN",8994,123459,2,"B","FROMDATE",5)

"KRN",8994,123459,2,"B","FLAGS",4)

"KRN",8994,123459,2,"B","ID",2)

"KRN",8994,123459,2,"B","IDTYPE",1)

"KRN",8994,123459,2,"B","IMGLESS",3)

"KRN",8994,123459,2,"B","MISCPRMS",7)

"KRN",8994,123459,2,"B","TODATE",6)

"KRN",8994,123459,2,"PARAMSEQ",1,1)

"KRN",8994,123459,2,"PARAMSEQ",2,2)

"KRN",8994,123459,2,"PARAMSEQ",3,3)

"KRN",8994,123459,2,"PARAMSEQ",4,4)

"KRN",8994,123459,2,"PARAMSEQ",5,5)

"KRN",8994,123459,2,"PARAMSEQ",6,6)

"KRN",8994,123459,2,"PARAMSEQ",7,7)

"KRN",8994,123459,3,0)
^^3^3^3170927^
"KRN",8994,123459,3,1,0)
if error MAGRY(0) = 0 ^Error message^
"KRN",8994,123459,3,2,0)
if success MAGRY(0) = 1
"KRN",8994,123459,3,3,0)
           MAGRY(1..n) = images in format defined in RPC [MAGN CPRS IMAGE LIST]
"KRN",8994,123460,-1)
0^2
"KRN",8994,123460,0)
MAGN PRECACHE BY CPT^PRECACHE^MAGNPCHE^2^R
"KRN",8994,123460,1,0)
^^1^1^3180608^
"KRN",8994,123460,1,1,0)
Pre-cache patient exams by CPT code
"KRN",8994,123460,2,0)
^8994.02A^3^3
"KRN",8994,123460,2,1,0)
IDTYPE^1^^1^1
"KRN",8994,123460,2,1,1,0)
^^1^1^3180608^
"KRN",8994,123460,2,1,1,1,0)
Type of ID paramater - "DFN" or "ICN"
"KRN",8994,123460,2,2,0)
ID^1^^1^2
"KRN",8994,123460,2,2,1,0)
^^1^1^3180608^
"KRN",8994,123460,2,2,1,1,0)
Patient DFN or ICN
"KRN",8994,123460,2,3,0)
CPT^1^^1^3
"KRN",8994,123460,2,3,1,0)
^^1^1^3180608^
"KRN",8994,123460,2,3,1,1,0)
CPT code for prior patient exams
"KRN",8994,123460,2,"B","CPT",3)

"KRN",8994,123460,2,"B","ID",2)

"KRN",8994,123460,2,"B","IDTYPE",1)

"KRN",8994,123460,2,"PARAMSEQ",1,1)

"KRN",8994,123460,2,"PARAMSEQ",2,2)

"KRN",8994,123460,2,"PARAMSEQ",3,3)

"KRN",8994,123460,3,0)
^^2^2^3180608^
"KRN",8994,123460,3,1,0)
MAGRY(0) When 1st '^'-piece is 0, then an error occured. 2nd piece is the error.
"KRN",8994,123460,3,2,0)
MAGRY(1..n) MAGRY(1..n) = SITE NUMBER ^ DFN ^ ICN ^ CPRSCONTEXTID
"MBREQ")
0
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"ORD",20,8989.51)
8989.51;20;;;PAR1E1^XPDTA2;PAR1F1^XPDIA3;PAR1E1^XPDIA3;PAR1F2^XPDIA3;;PAR1DEL^XPDIA3(%)
"ORD",20,8989.51,0)
PARAMETER DEFINITION
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging Release History
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020328^3020328^.5
"PKG",454,22,1,"PAH",1,0)
221^3190225^.5
"PKG",454,22,1,"PAH",1,1,0)
^9.49011^21^21^3190225
"PKG",454,22,1,"PAH",1,1,1,0)
Routines for Patch 221
"PKG",454,22,1,"PAH",1,1,2,0)
 
"PKG",454,22,1,"PAH",1,1,3,0)
Routines:
"PKG",454,22,1,"PAH",1,1,4,0)
MAGIP221    value = 8533414
"PKG",454,22,1,"PAH",1,1,5,0)
MAGDQR21    value = 188496027
"PKG",454,22,1,"PAH",1,1,6,0)
MAGGSIA    value = 35830061
"PKG",454,22,1,"PAH",1,1,7,0)
MAGGTIA1    value = 34088332
"PKG",454,22,1,"PAH",1,1,8,0)
MAGNPCHE    value = 19371617
"PKG",454,22,1,"PAH",1,1,9,0)
MAGNUTL2    value = 23733574
"PKG",454,22,1,"PAH",1,1,10,0)
MAGNVQ04    value = 30558931
"PKG",454,22,1,"PAH",1,1,11,0)
MAGNVQ05    value = 35641804
"PKG",454,22,1,"PAH",1,1,12,0)
MAGNVQ07    value = 5002623
"PKG",454,22,1,"PAH",1,1,13,0)
MAGNWRK1    value = 53919420
"PKG",454,22,1,"PAH",1,1,14,0)
MAGSIXG1    value = 40907827
"PKG",454,22,1,"PAH",1,1,15,0)
MAGSIXG2    value = 69913945
"PKG",454,22,1,"PAH",1,1,16,0)
MAGSIXG3    value = 109262683
"PKG",454,22,1,"PAH",1,1,17,0)
MAGVIM01    value = 195265246
"PKG",454,22,1,"PAH",1,1,18,0)
MAGUTL06    value = 19148168
"PKG",454,22,1,"PAH",1,1,19,0)
 
"PKG",454,22,1,"PAH",1,1,20,0)
Please note that routine MAGIP221 is deleted after the KIDS Build is
"PKG",454,22,1,"PAH",1,1,21,0)
installed.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
15
"RTN","MAGIP221")
0^1^B8533414
"RTN","MAGIP221",1,0)
MAGIP221 ;WOIFO/NST - Install code for MAG*3.0*221 ; FEB 25, 2019@09:15AM
"RTN","MAGIP221",2,0)
 ;;3.0;IMAGING;**221**;Mar 19, 2002;Build 2461;Jan 18, 2012
"RTN","MAGIP221",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIP221",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP221",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIP221",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIP221",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIP221",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIP221",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIP221",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIP221",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIP221",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIP221",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIP221",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIP221",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIP221",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP221",17,0)
 ;;
"RTN","MAGIP221",18,0)
 ; There are no environment checks here but the MAGIP221 has to be
"RTN","MAGIP221",19,0)
 ; referenced by the "Environment Check Routine" field of the KIDS
"RTN","MAGIP221",20,0)
 ; build so that entry points of the routine are available to the
"RTN","MAGIP221",21,0)
 ; KIDS during all installation phases.
"RTN","MAGIP221",22,0)
 Q
"RTN","MAGIP221",23,0)
 ;
"RTN","MAGIP221",24,0)
 ;+++++ INSTALLATION ERROR HANDLING
"RTN","MAGIP221",25,0)
ERROR ;
"RTN","MAGIP221",26,0)
 S:$D(XPDNM) XPDABORT=1
"RTN","MAGIP221",27,0)
 ;--- Display the messages and store them to the INSTALL file
"RTN","MAGIP221",28,0)
 D DUMP^MAGUERR1(),ABTMSG^MAGKIDS()
"RTN","MAGIP221",29,0)
 Q
"RTN","MAGIP221",30,0)
 ;
"RTN","MAGIP221",31,0)
 ;***** POST-INSTALL CODE
"RTN","MAGIP221",32,0)
POS ;
"RTN","MAGIP221",33,0)
 N CALLBACK
"RTN","MAGIP221",34,0)
 D CLEAR^MAGUERR(1)
"RTN","MAGIP221",35,0)
 ;
"RTN","MAGIP221",36,0)
 ;--- Link new remote procedures to the Broker context option.
"RTN","MAGIP221",37,0)
 S CALLBACK="$$ADDRPCS^"_$NA(MAGKIDS1("RPCLSTW^"_$T(+0),"MAG WINDOWS"))
"RTN","MAGIP221",38,0)
 I $$CP^MAGKIDS("MAG ATTACH RPCS P221 WIN",CALLBACK)<0 D ERROR Q
"RTN","MAGIP221",39,0)
 ;
"RTN","MAGIP221",40,0)
 S CALLBACK="$$ADDRPCS^"_$NA(MAGKIDS1("RPCLSTV^"_$T(+0),"MAG DICOM VISA"))
"RTN","MAGIP221",41,0)
 I $$CP^MAGKIDS("MAG ATTACH RPCS P221 VISA",CALLBACK)<0 D ERROR Q
"RTN","MAGIP221",42,0)
 ;
"RTN","MAGIP221",43,0)
 D UPDATE ; Misc updates
"RTN","MAGIP221",44,0)
 ;
"RTN","MAGIP221",45,0)
 ;--- Send the notification e-mail
"RTN","MAGIP221",46,0)
 D BMES^XPDUTL("Post Install Mail Message: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","MAGIP221",47,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGIP221",48,0)
 Q
"RTN","MAGIP221",49,0)
 ;
"RTN","MAGIP221",50,0)
 ;***** PRE-INSTALL CODE
"RTN","MAGIP221",51,0)
PRE ;
"RTN","MAGIP221",52,0)
 Q
"RTN","MAGIP221",53,0)
 ;
"RTN","MAGIP221",54,0)
 ;+++++ LIST OF NEW REMOTE PROCEDURES
"RTN","MAGIP221",55,0)
 ; have a list in format ;;MAG4 IMAGE LIST
"RTN","MAGIP221",56,0)
 ;
"RTN","MAGIP221",57,0)
RPCLSTW ;
"RTN","MAGIP221",58,0)
 ;;MAGN PRECACHE BY CPT
"RTN","MAGIP221",59,0)
 ;;MAG STORAGE FETCH SET
"RTN","MAGIP221",60,0)
 Q
"RTN","MAGIP221",61,0)
 ;
"RTN","MAGIP221",62,0)
RPCLSTV ;
"RTN","MAGIP221",63,0)
 ;;MAGN PRECACHE BY CPT
"RTN","MAGIP221",64,0)
 Q
"RTN","MAGIP221",65,0)
 ;
"RTN","MAGIP221",66,0)
UPDATE ; Misc updates
"RTN","MAGIP221",67,0)
 N DIK
"RTN","MAGIP221",68,0)
 L +^MAGV(2006.941):1999999
"RTN","MAGIP221",69,0)
 S DIK="^MAGV(2006.941,"
"RTN","MAGIP221",70,0)
 K ^MAGV(2006.941,"B")
"RTN","MAGIP221",71,0)
 K ^MAGV(2006.941,"C")
"RTN","MAGIP221",72,0)
 K ^MAGV(2006.941,"H")
"RTN","MAGIP221",73,0)
 K ^MAGV(2006.941,"I")
"RTN","MAGIP221",74,0)
 K ^MAGV(2006.941,"T")
"RTN","MAGIP221",75,0)
 D IXALL^DIK  ; Rebuild all cross-references in MAG WORK ITEM file (#2006.941)
"RTN","MAGIP221",76,0)
 L -^MAGV(2006.941)
"RTN","MAGIP221",77,0)
 D MES^MAGKIDS("Rebuild of cross-references in MAG WORK ITEM file (#2006.941) has been completed.")
"RTN","MAGIP221",78,0)
 Q
"RTN","MAGDQR21")
0^2^B188496027
"RTN","MAGDQR21",1,0)
MAGDQR21 ;WOIFO/EdM,NST,MLH,JSL,SAF,BT - RPCs for Query/Retrieve SetUp ; 16 JUL,2018@4:27 PM
"RTN","MAGDQR21",2,0)
 ;;3.0;IMAGING;**83,104,123,119,221**;Mar 19, 2002;Build 4396;Apr 19, 2013
"RTN","MAGDQR21",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDQR21",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR21",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDQR21",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDQR21",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDQR21",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDQR21",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDQR21",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDQR21",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDQR21",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDQR21",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDQR21",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDQR21",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDQR21",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR21",17,0)
 ;;
"RTN","MAGDQR21",18,0)
 Q
"RTN","MAGDQR21",19,0)
 ;
"RTN","MAGDQR21",20,0)
GET(OUT,DEST,GATEWAY) ; RPC = MAG GET DICOM DEST
"RTN","MAGDQR21",21,0)
 N D0,D1,N,OK,X
"RTN","MAGDQR21",22,0)
 I $G(DEST)="" D  Q
"RTN","MAGDQR21",23,0)
 . S N=1
"RTN","MAGDQR21",24,0)
 . S X="" F  S X=$O(^MAG(2006.587,"B",X)) Q:X=""  S N=N+1,OUT(N)="B^"_X
"RTN","MAGDQR21",25,0)
 . S X="" F  S X=$O(^MAG(2006.587,"D",X)) Q:X=""  S N=N+1,OUT(N)="D^"_X
"RTN","MAGDQR21",26,0)
 . S OUT(1)=N
"RTN","MAGDQR21",27,0)
 . Q
"RTN","MAGDQR21",28,0)
 ;
"RTN","MAGDQR21",29,0)
 S GATEWAY=$G(GATEWAY) S:GATEWAY="--All DICOM Gateways--" GATEWAY=""
"RTN","MAGDQR21",30,0)
 S D0=0,OK=0 F  S D0=$O(^MAG(2006.587,D0)) Q:'D0  D  Q:OK
"RTN","MAGDQR21",31,0)
 . S X=$G(^MAG(2006.587,D0,0))
"RTN","MAGDQR21",32,0)
 . Q:$P(X,"^",1)'=DEST
"RTN","MAGDQR21",33,0)
 . I GATEWAY'="",$P(X,"^",5)'=GATEWAY Q
"RTN","MAGDQR21",34,0)
 . S OK=1,N=6
"RTN","MAGDQR21",35,0)
 . S OUT(2)="2^"_$P(X,"^",2)
"RTN","MAGDQR21",36,0)
 . S OUT(3)="3^"_$P(X,"^",3)
"RTN","MAGDQR21",37,0)
 . S OUT(4)="4^"_$P(X,"^",4)
"RTN","MAGDQR21",38,0)
 . S OUT(5)="5^"_$P(X,"^",6)
"RTN","MAGDQR21",39,0)
 . S OUT(6)="6^"_$P(X,"^",7)
"RTN","MAGDQR21",40,0)
 . S D1=0 F  S D1=$O(^MAG(2006.587,D0,1,D1)) Q:'D1  D
"RTN","MAGDQR21",41,0)
 . . S X=$G(^MAG(2006.587,D0,1,D1,0)) Q:$P(X,"^",1)=""
"RTN","MAGDQR21",42,0)
 . . S N=N+1,OUT(N)=X
"RTN","MAGDQR21",43,0)
 . . Q
"RTN","MAGDQR21",44,0)
 . Q
"RTN","MAGDQR21",45,0)
 S OUT(1)=N
"RTN","MAGDQR21",46,0)
 Q
"RTN","MAGDQR21",47,0)
 ;
"RTN","MAGDQR21",48,0)
SET(OUT,DATA,DEST,GATEWAY) ; RPC = MAG SET DICOM DEST
"RTN","MAGDQR21",49,0)
 N D0,D1,I,N,P,Q,O1,O5,O7,OK,T,X
"RTN","MAGDQR21",50,0)
 I $G(DEST)="" S OUT="-1,No Destination Specified." Q
"RTN","MAGDQR21",51,0)
 ;
"RTN","MAGDQR21",52,0)
 S I="" F  S I=$O(DATA(I)) Q:I=""  D
"RTN","MAGDQR21",53,0)
 . S T=DATA(I) Q:T'["^"
"RTN","MAGDQR21",54,0)
 . I +T=2 S P(2)=$P(T,"^",2) Q
"RTN","MAGDQR21",55,0)
 . I +T=3 S P(3)=$P(T,"^",2) Q
"RTN","MAGDQR21",56,0)
 . I +T=4 S P(4)=$P(T,"^",2) Q
"RTN","MAGDQR21",57,0)
 . I +T=5 S P(6)=$P(T,"^",2) Q
"RTN","MAGDQR21",58,0)
 . I +T=6 S P(7)=$P(T,"^",2) Q
"RTN","MAGDQR21",59,0)
 . S Q($P(T,"^",1))=(+$P(T,"^",2))_"^"_(+$P(T,"^",3))
"RTN","MAGDQR21",60,0)
 . Q
"RTN","MAGDQR21",61,0)
 ;
"RTN","MAGDQR21",62,0)
 S OUT=0
"RTN","MAGDQR21",63,0)
 S GATEWAY=$G(GATEWAY) S:GATEWAY="--All DICOM Gateways--" GATEWAY=""
"RTN","MAGDQR21",64,0)
 S D0=0,OK=0 F  S D0=$O(^MAG(2006.587,D0)) Q:'D0  D  Q:OK
"RTN","MAGDQR21",65,0)
 . S X=$G(^MAG(2006.587,D0,0)),O1=$P(X,"^",1),O5=$P(X,"^",5),O7=$P(X,"^",7)
"RTN","MAGDQR21",66,0)
 . Q:O1'=DEST
"RTN","MAGDQR21",67,0)
 . I GATEWAY'="",O5'=GATEWAY Q
"RTN","MAGDQR21",68,0)
 . S:GATEWAY'="" OK=1 S OUT=OUT+1
"RTN","MAGDQR21",69,0)
 . I O1'="",O5'="",O7'="" K ^MAG(2006.587,"C",O1,O7,O5,D0)
"RTN","MAGDQR21",70,0)
 . I O5'="",O7'="" K ^MAG(2006.587,"D",O5,O7,D0)
"RTN","MAGDQR21",71,0)
 . S I="" F  S I=$O(P(I)) Q:I=""  S:P(I)'="" $P(X,"^",I)=P(I)
"RTN","MAGDQR21",72,0)
 . S:$G(P(7))'="" O7=P(7)
"RTN","MAGDQR21",73,0)
 . S ^MAG(2006.587,D0,0)=X
"RTN","MAGDQR21",74,0)
 . I O1'="",O5'="",O7'="" S ^MAG(2006.587,"C",O1,O7,O5,D0)=""
"RTN","MAGDQR21",75,0)
 . I O5'="",O7'="" S ^MAG(2006.587,"D",O5,O7,D0)=""
"RTN","MAGDQR21",76,0)
 . K ^MAG(2006.587,D0,1)
"RTN","MAGDQR21",77,0)
 . S D1=0,I="" F  S I=$O(Q(I)) Q:I=""  D
"RTN","MAGDQR21",78,0)
 . . S D1=D1+1,^MAG(2006.587,D0,1,D1,0)=I_"^"_Q(I)
"RTN","MAGDQR21",79,0)
 . . S ^MAG(2006.587,D0,1,"B",I,D1)=""
"RTN","MAGDQR21",80,0)
 . . Q
"RTN","MAGDQR21",81,0)
 . S:D1 ^MAG(2006.587,D0,1,0)="^2006.5871SA^"_D1_"^"_D1
"RTN","MAGDQR21",82,0)
 . Q
"RTN","MAGDQR21",83,0)
 Q
"RTN","MAGDQR21",84,0)
 ;
"RTN","MAGDQR21",85,0)
TMPOUT(NAME) ; Return name of the temp
"RTN","MAGDQR21",86,0)
 N X
"RTN","MAGDQR21",87,0)
 S X=$$RTRNFMT^XWBLIB("GLOBAL ARRAY",1)
"RTN","MAGDQR21",88,0)
 S X=$NA(^TMP("MAG",$J,NAME))
"RTN","MAGDQR21",89,0)
 K @X
"RTN","MAGDQR21",90,0)
 Q X
"RTN","MAGDQR21",91,0)
 ;
"RTN","MAGDQR21",92,0)
STUDY2(OUT,GROUPS,REQDFN,IMGLESS,FLAGS) ; RPC = MAG DOD GET STUDIES IEN
"RTN","MAGDQR21",93,0)
 ; CR, 5-28-09
"RTN","MAGDQR21",94,0)
 ; IMGLESS is a new flag to speed up queries: if=1 (true), just get study-level 
"RTN","MAGDQR21",95,0)
 ;            data, if null or zero get everything. This new flag is optional.
"RTN","MAGDQR21",96,0)
 ; BT, 01-06-12
"RTN","MAGDQR21",97,0)
 ; FLAGS is ""  - Exclude Deleted records (default)
"RTN","MAGDQR21",98,0)
 ;          "D" - Include Deleted records
"RTN","MAGDQR21",99,0)
 ;       
"RTN","MAGDQR21",100,0)
 ;
"RTN","MAGDQR21",101,0)
 N STUDY,INCDEL
"RTN","MAGDQR21",102,0)
 ;
"RTN","MAGDQR21",103,0)
 S REQDFN=$G(REQDFN)
"RTN","MAGDQR21",104,0)
 S INCDEL=$G(FLAGS)["D"
"RTN","MAGDQR21",105,0)
 S IMGLESS=$G(IMGLESS)
"RTN","MAGDQR21",106,0)
 S OUT=$$TMPOUT^MAGDQR21("STUDY")
"RTN","MAGDQR21",107,0)
 S @OUT@(1)=1
"RTN","MAGDQR21",108,0)
 ;
"RTN","MAGDQR21",109,0)
 I $G(GROUPS) D CNVGRP^MAGDQR21(.GROUPS)
"RTN","MAGDQR21",110,0)
 ;
"RTN","MAGDQR21",111,0)
 D GETSTUDY^MAGDQR21(.GROUPS,.STUDY,INCDEL) ; read IENS in GROUPS and sort into STUDY by UID,IEN
"RTN","MAGDQR21",112,0)
 ;
"RTN","MAGDQR21",113,0)
 D GENOUT^MAGDQR21(.STUDY,REQDFN,IMGLESS,INCDEL) ; generate OUT based on STUDY
"RTN","MAGDQR21",114,0)
 ;
"RTN","MAGDQR21",115,0)
 ;update last counter
"RTN","MAGDQR21",116,0)
 S @OUT@(1)=@OUT@(1)-1
"RTN","MAGDQR21",117,0)
 Q
"RTN","MAGDQR21",118,0)
 ;
"RTN","MAGDQR21",119,0)
CNVGRP(GROUPS) ; Add top level GROUPS value to GROUPS array 
"RTN","MAGDQR21",120,0)
 ; GROUPS=10, GROUPS(1)=11, GROUPS(2)=12 becomes GROUPS(1)=11, GROUPS(2)=12, GROUPS(3)=10
"RTN","MAGDQR21",121,0)
 N LAST
"RTN","MAGDQR21",122,0)
 S LAST=$O(GROUPS(""),-1)+1
"RTN","MAGDQR21",123,0)
 S GROUPS(LAST)=GROUPS
"RTN","MAGDQR21",124,0)
 Q
"RTN","MAGDQR21",125,0)
 ;
"RTN","MAGDQR21",126,0)
GETSTUDY(GROUPS,STUDY,INCDEL) ; Read IENS in GROUPS and sort into STUDY by UID,IEN
"RTN","MAGDQR21",127,0)
 N I,IEN
"RTN","MAGDQR21",128,0)
 S I=""
"RTN","MAGDQR21",129,0)
 F  S I=$O(GROUPS(I)) Q:I=""  D
"RTN","MAGDQR21",130,0)
 . S IEN=$G(GROUPS(I))
"RTN","MAGDQR21",131,0)
 . Q:'IEN
"RTN","MAGDQR21",132,0)
 . I 'INCDEL D SRTUID^MAGDQR21(IEN,.STUDY)
"RTN","MAGDQR21",133,0)
 . I INCDEL D SRTUID2^MAGDQR21(IEN,.STUDY)
"RTN","MAGDQR21",134,0)
 . Q
"RTN","MAGDQR21",135,0)
 Q
"RTN","MAGDQR21",136,0)
 ;
"RTN","MAGDQR21",137,0)
SRTUID(IEN,STUDY) ; Sort group by UID, IEN
"RTN","MAGDQR21",138,0)
 N PARENT,UID
"RTN","MAGDQR21",139,0)
 ;get parent IEN
"RTN","MAGDQR21",140,0)
 S PARENT=$P($G(^MAG(2005,IEN,0)),"^",10)
"RTN","MAGDQR21",141,0)
 S:PARENT IEN=PARENT
"RTN","MAGDQR21",142,0)
 ;IEN now is parent IEN or Individual Image
"RTN","MAGDQR21",143,0)
 S UID=$P($G(^MAG(2005,IEN,"PACS")),"^",1) S:UID="" UID="?" ;no pacs
"RTN","MAGDQR21",144,0)
 S STUDY(UID,IEN)=""
"RTN","MAGDQR21",145,0)
 Q
"RTN","MAGDQR21",146,0)
 ; 
"RTN","MAGDQR21",147,0)
SRTUID2(IEN,STUDY) ; Sort group by UID, IEN (include Deleted Images)
"RTN","MAGDQR21",148,0)
 N PARENT,UID,MAGFIL
"RTN","MAGDQR21",149,0)
 ;get parent IEN
"RTN","MAGDQR21",150,0)
 S PARENT=$P($G(^MAG(2005,IEN,0)),"^",10)
"RTN","MAGDQR21",151,0)
 S:'PARENT PARENT=$P($G(^MAG(2005.1,IEN,0)),"^",10)
"RTN","MAGDQR21",152,0)
 S:PARENT IEN=PARENT
"RTN","MAGDQR21",153,0)
 ;IEN now is parent IEN or Individual Image
"RTN","MAGDQR21",154,0)
 S MAGFIL=$$FILE^MAGGI11(IEN)
"RTN","MAGDQR21",155,0)
 S UID=$S(MAGFIL:$P($G(^MAG(MAGFIL,IEN,"PACS")),"^",1),1:"")
"RTN","MAGDQR21",156,0)
 S:UID="" UID="?" ;no pacs
"RTN","MAGDQR21",157,0)
 S STUDY(UID,IEN)=""
"RTN","MAGDQR21",158,0)
 Q
"RTN","MAGDQR21",159,0)
 ;
"RTN","MAGDQR21",160,0)
GENOUT(STUDY,REQDFN,IMGLESS,INCDEL) ; Generate output in ^TMP based on STUDY array
"RTN","MAGDQR21",161,0)
 N UID,IEN
"RTN","MAGDQR21",162,0)
 ;
"RTN","MAGDQR21",163,0)
 S UID=""
"RTN","MAGDQR21",164,0)
 F  S UID=$O(STUDY(UID)) Q:UID=""  D
"RTN","MAGDQR21",165,0)
 . I UID="?" D  Q
"RTN","MAGDQR21",166,0)
 . . S IEN=""
"RTN","MAGDQR21",167,0)
 . . F  S IEN=$O(STUDY(UID,IEN)) Q:IEN=""  D STUDY^MAGDQR21("",IEN,REQDFN,IMGLESS,INCDEL)
"RTN","MAGDQR21",168,0)
 . . Q
"RTN","MAGDQR21",169,0)
 . ;ELSE
"RTN","MAGDQR21",170,0)
 . D STUDY^MAGDQR21(UID,"",REQDFN,IMGLESS,INCDEL)
"RTN","MAGDQR21",171,0)
 . Q
"RTN","MAGDQR21",172,0)
 Q
"RTN","MAGDQR21",173,0)
 ; 
"RTN","MAGDQR21",174,0)
STUDY(UID,IEN,REQDFN,IMGLESS,INCDEL) ; Generate output in ^TMP based on parameters
"RTN","MAGDQR21",175,0)
 N STUDY
"RTN","MAGDQR21",176,0)
 N SERIESARRAY ; array of series numbers for this study
"RTN","MAGDQR21",177,0)
 N TOTIMAGES ; total number of images for all series in this study
"RTN","MAGDQR21",178,0)
 N PAT ; array of IENs by patient
"RTN","MAGDQR21",179,0)
 N PATCOUNT ; array of patients, use for validation purposes, should contain only one patient
"RTN","MAGDQR21",180,0)
 N I0 ;IEN where the patient found
"RTN","MAGDQR21",181,0)
 N D0
"RTN","MAGDQR21",182,0)
 N STUMO ;Procedure array
"RTN","MAGDQR21",183,0)
 N TDCMIMG ; total number of DICOM images
"RTN","MAGDQR21",184,0)
 ;
"RTN","MAGDQR21",185,0)
 D WRTOUT^MAGDQR21("NEXT_STUDY|"_UID_"|"_IEN)
"RTN","MAGDQR21",186,0)
 ;
"RTN","MAGDQR21",187,0)
 D:UID'="" GETGPUID^MAGDQR21(UID,.STUDY,INCDEL) ;fill STUDY based on UID
"RTN","MAGDQR21",188,0)
 D:IEN GETGPIEN^MAGDQR21(IEN,.STUDY,INCDEL) ;add IEN into STUDY
"RTN","MAGDQR21",189,0)
 Q:'$O(STUDY(""))
"RTN","MAGDQR21",190,0)
 ; 
"RTN","MAGDQR21",191,0)
 D GETPAT^MAGDQR21(.STUDY,.PAT,.PATCOUNT,.TOTIMAGES,.TDCMIMG,REQDFN,INCDEL) ;get images for patient
"RTN","MAGDQR21",192,0)
 Q:'$$VALPAT^MAGDQR21(UID,.PAT,.PATCOUNT,REQDFN)  ;validate to make sure all images belonged to one patient
"RTN","MAGDQR21",193,0)
 ;
"RTN","MAGDQR21",194,0)
 S I0=$O(PAT(REQDFN,"")) ;include the first Image when writing out the STUDY section
"RTN","MAGDQR21",195,0)
 Q:'$$WRTIEN^MAGDQR21(UID,I0,TOTIMAGES,TDCMIMG,REQDFN)
"RTN","MAGDQR21",196,0)
 ;
"RTN","MAGDQR21",197,0)
 Q:'$$INTEGDFN^MAGDQR21(I0,REQDFN,INCDEL)
"RTN","MAGDQR21",198,0)
 ;
"RTN","MAGDQR21",199,0)
 D WRTOUT^MAGDQR21("STUDY_PAT|"_REQDFN_"|"_$S($T(GETICN^MPIF001)'="":$$GETICN^MPIF001(REQDFN),1:"-1^NO MPI")_"|"_$P($G(^DPT(REQDFN,0)),"^",1))
"RTN","MAGDQR21",200,0)
 ;
"RTN","MAGDQR21",201,0)
 ; CR, 5-28-09
"RTN","MAGDQR21",202,0)
 ; For study-level data stop here without additional checks 
"RTN","MAGDQR21",203,0)
 Q:IMGLESS=1
"RTN","MAGDQR21",204,0)
 ;end of check above
"RTN","MAGDQR21",205,0)
 ;
"RTN","MAGDQR21",206,0)
 S D0=""
"RTN","MAGDQR21",207,0)
 F  S D0=$O(PAT(REQDFN,D0)) Q:D0=""  D WRTIMG^MAGDQR20(.SERIESARRAY,D0,REQDFN,.STUMO,INCDEL)
"RTN","MAGDQR21",208,0)
 D WRTMOD^MAGDQR21(.STUMO) ; list all modalities
"RTN","MAGDQR21",209,0)
 Q
"RTN","MAGDQR21",210,0)
 ;
"RTN","MAGDQR21",211,0)
GETGPUID(UID,STUDY,INCDEL) ; Given UID, populate STUDY array with Image IEN 
"RTN","MAGDQR21",212,0)
 N D0
"RTN","MAGDQR21",213,0)
 S D0=""
"RTN","MAGDQR21",214,0)
 F  S D0=$O(^MAG(2005,"P",UID,D0)) Q:D0=""  D
"RTN","MAGDQR21",215,0)
 . S:'$P($G(^MAG(2005,D0,0)),"^",10) STUDY(D0)=2005 ; add either Group IEN or individual IEN (not child IEN)
"RTN","MAGDQR21",216,0)
 . Q
"RTN","MAGDQR21",217,0)
 ;
"RTN","MAGDQR21",218,0)
 I INCDEL D
"RTN","MAGDQR21",219,0)
 . S D0=""
"RTN","MAGDQR21",220,0)
 . F  S D0=$O(^MAG(2005.1,"P",UID,D0)) Q:D0=""  D
"RTN","MAGDQR21",221,0)
 . . Q:'$$ISDEL^MAGGI11(D0)
"RTN","MAGDQR21",222,0)
 . . S:'$P($G(^MAG(2005.1,D0,0)),"^",10) STUDY(D0)=2005.1 ; add either deleted Group IEN or deleted individual IEN (not child IEN)
"RTN","MAGDQR21",223,0)
 . . Q
"RTN","MAGDQR21",224,0)
 . Q
"RTN","MAGDQR21",225,0)
 Q
"RTN","MAGDQR21",226,0)
 ;
"RTN","MAGDQR21",227,0)
GETGPIEN(IEN,STUDY,INCDEL) ; Add IEN into STUDY (include deleted images)
"RTN","MAGDQR21",228,0)
 S:'$P($G(^MAG(2005,IEN,0)),"^",10) STUDY(IEN)=2005 ; add image IEN
"RTN","MAGDQR21",229,0)
 ;
"RTN","MAGDQR21",230,0)
 I INCDEL,$$ISDEL^MAGGI11(IEN) D
"RTN","MAGDQR21",231,0)
 . S:'$P($G(^MAG(2005.1,IEN,0)),"^",10) STUDY(IEN)=2005.1 ;add deleted image IEN
"RTN","MAGDQR21",232,0)
 . Q
"RTN","MAGDQR21",233,0)
 Q
"RTN","MAGDQR21",234,0)
 ;
"RTN","MAGDQR21",235,0)
GETPAT(STUDY,PAT,PATCOUNT,TOTIMAGES,TDCMIMG,REQDFN,INCDEL) ; Get Total Images count and fill Patient array based on STUDY
"RTN","MAGDQR21",236,0)
 ;Input:
"RTN","MAGDQR21",237,0)
 ;   STUDY     - array of all images
"RTN","MAGDQR21",238,0)
 ;   REQDFN    - patient
"RTN","MAGDQR21",239,0)
 ;   INCDEL    - include Deleted Images
"RTN","MAGDQR21",240,0)
 ;Output:
"RTN","MAGDQR21",241,0)
 ;   PAT       - array of all images for the patient
"RTN","MAGDQR21",242,0)
 ;   PATCOUNT  - array to validate all images should belonged only to one patient
"RTN","MAGDQR21",243,0)
 ;   TOTIMAGES - total images for the patient
"RTN","MAGDQR21",244,0)
 ;   TDCMIMG   - total DICOM images 
"RTN","MAGDQR21",245,0)
 ;
"RTN","MAGDQR21",246,0)
 N D0,MAGFIL,DFN,ISGRP,CNT
"RTN","MAGDQR21",247,0)
 S (TOTIMAGES,TDCMIMG)=0
"RTN","MAGDQR21",248,0)
 S D0=""
"RTN","MAGDQR21",249,0)
 ;
"RTN","MAGDQR21",250,0)
 F  S D0=$O(STUDY(D0)) Q:D0=""  D
"RTN","MAGDQR21",251,0)
 . S MAGFIL=STUDY(D0)
"RTN","MAGDQR21",252,0)
 . S DFN=+$P($G(^MAG(MAGFIL,D0,0)),"^",7)
"RTN","MAGDQR21",253,0)
 . S PATCOUNT(DFN)=""
"RTN","MAGDQR21",254,0)
 . S:REQDFN=DFN PAT(DFN,D0)=""
"RTN","MAGDQR21",255,0)
 . ;
"RTN","MAGDQR21",256,0)
 . ;Add image count to Total Images for the study
"RTN","MAGDQR21",257,0)
 . S ISGRP=$$ISGRP^MAGDQR21(D0,INCDEL)
"RTN","MAGDQR21",258,0)
 . I 'ISGRP,REQDFN=DFN S TOTIMAGES=TOTIMAGES+1 Q
"RTN","MAGDQR21",259,0)
 . I MAGFIL=2005 D
"RTN","MAGDQR21",260,0)
 . . S CNT=$$GETGPIM^MAGDQR21(D0,REQDFN,.PATCOUNT)
"RTN","MAGDQR21",261,0)
 . . S TOTIMAGES=TOTIMAGES+$P(CNT,"^",1) ; count group images
"RTN","MAGDQR21",262,0)
 . . S TDCMIMG=TDCMIMG+$P(CNT,"^",2)
"RTN","MAGDQR21",263,0)
 . . Q
"RTN","MAGDQR21",264,0)
 . I INCDEL D
"RTN","MAGDQR21",265,0)
 . . S CNT=$$GETGPDIM^MAGDQR21(D0,REQDFN,.PATCOUNT)
"RTN","MAGDQR21",266,0)
 . . S TOTIMAGES=TOTIMAGES+$P(CNT,"^",1) ; count deleted group images
"RTN","MAGDQR21",267,0)
 . . S TDCMIMG=TDCMIMG+$P(CNT,"^",2)
"RTN","MAGDQR21",268,0)
 . . Q
"RTN","MAGDQR21",269,0)
 . Q
"RTN","MAGDQR21",270,0)
 Q
"RTN","MAGDQR21",271,0)
 ;
"RTN","MAGDQR21",272,0)
ISGRP(D0,INCDEL) ; return 1 if D0 is a group IEN, 0 otherwise
"RTN","MAGDQR21",273,0)
 N ISGRP
"RTN","MAGDQR21",274,0)
 S ISGRP=1
"RTN","MAGDQR21",275,0)
 I 'INCDEL,'$D(^MAG(2005,D0,1)) S ISGRP=0 ; a single image (e.g., photo ID), not a group
"RTN","MAGDQR21",276,0)
 I INCDEL,'$D(^MAG(2005,D0,1)),'$D(^MAG(2005.1,D0,1)) S ISGRP=0 ; a single deleted image (e.g., photo ID), not a group
"RTN","MAGDQR21",277,0)
 Q ISGRP
"RTN","MAGDQR21",278,0)
 ;
"RTN","MAGDQR21",279,0)
GETGPIM(D0,REQDFN,PATCOUNT) ; return total images in the group and PATCOUNT array for patient validation
"RTN","MAGDQR21",280,0)
 N D1,I0,DFN,IMGCNT,IMGCNTOT,MAGOBJTP
"RTN","MAGDQR21",281,0)
 S (IMGCNT,IMGCNTOT)=0
"RTN","MAGDQR21",282,0)
 S D1=0 ;go through all images. They should belong to one pt
"RTN","MAGDQR21",283,0)
 F  S D1=$O(^MAG(2005,D0,1,D1)) Q:'D1  D
"RTN","MAGDQR21",284,0)
 . S I0=+$G(^MAG(2005,D0,1,D1,0)) Q:'I0
"RTN","MAGDQR21",285,0)
 . S DFN=+$P($G(^MAG(2005,I0,0)),"^",7)
"RTN","MAGDQR21",286,0)
 . S PATCOUNT(DFN)="" ;populate PATCOUNT with DFN for validation (DFN might be different in this case it's a corrupted record)
"RTN","MAGDQR21",287,0)
 . ; increment image count unless single pt was requested and this isn't that pt
"RTN","MAGDQR21",288,0)
 . I REQDFN'=DFN Q
"RTN","MAGDQR21",289,0)
 . S IMGCNT=IMGCNT+1
"RTN","MAGDQR21",290,0)
 . S MAGOBJTP=$P($G(^MAG(2005,I0,0)),"^",6)  ; OBJECT TYPE field (#3)
"RTN","MAGDQR21",291,0)
 . S:(MAGOBJTP=100)!(MAGOBJTP=3) IMGCNTOT=IMGCNTOT+1   ; 100 - DICOM IMAGE; 3 - XRAY
"RTN","MAGDQR21",292,0)
 . Q
"RTN","MAGDQR21",293,0)
 Q IMGCNT_"^"_IMGCNTOT
"RTN","MAGDQR21",294,0)
 ;
"RTN","MAGDQR21",295,0)
GETGPDIM(D0,REQDFN,PATCOUNT) ; return total images in the group and PATCOUNT array for patient validation
"RTN","MAGDQR21",296,0)
 N I0,DFN,IMGCNT,IMGCNTOT,MAGOBJTP
"RTN","MAGDQR21",297,0)
 S (IMGCNT,IMGCNTOT)=0
"RTN","MAGDQR21",298,0)
 S I0="" ;go through all AUDIT images.
"RTN","MAGDQR21",299,0)
 F  S I0=$O(^MAG(2005.1,"AGP",D0,I0)) Q:I0=""  D
"RTN","MAGDQR21",300,0)
 . S DFN=+$P($G(^MAG(2005.1,I0,0)),"^",7)
"RTN","MAGDQR21",301,0)
 . S PATCOUNT(DFN)="" ;populate PATCOUNT with DFN for validation (DFN might be different in this case it's a corrupted record)
"RTN","MAGDQR21",302,0)
 . ; increment image count unless single pt was requested and this isn't that pt
"RTN","MAGDQR21",303,0)
 . I REQDFN'=DFN Q
"RTN","MAGDQR21",304,0)
 . S IMGCNT=IMGCNT+1
"RTN","MAGDQR21",305,0)
 . S MAGOBJTP=$P($G(^MAG(2005.1,I0,0)),"^",6)  ; OBJECT TYPE field (#3)
"RTN","MAGDQR21",306,0)
 . S:(MAGOBJTP=100)!(MAGOBJTP=3) IMGCNTOT=IMGCNTOT+1   ; 100 - DICOM IMAGE; 3 - XRAY
"RTN","MAGDQR21",307,0)
 . Q
"RTN","MAGDQR21",308,0)
 Q IMGCNT_"^"_IMGCNTOT
"RTN","MAGDQR21",309,0)
 ;
"RTN","MAGDQR21",310,0)
VALPAT(UID,PAT,PATCOUNT,REQDFN) ; Validate - should only have one patient
"RTN","MAGDQR21",311,0)
 N CONT,DFN
"RTN","MAGDQR21",312,0)
 ;
"RTN","MAGDQR21",313,0)
 S CONT=1,PATCOUNT=0
"RTN","MAGDQR21",314,0)
 S DFN="" F  S DFN=$O(PATCOUNT(DFN)) Q:DFN=""  S PATCOUNT=PATCOUNT+1
"RTN","MAGDQR21",315,0)
 ;
"RTN","MAGDQR21",316,0)
 I PATCOUNT>1 D
"RTN","MAGDQR21",317,0)
 . ; duplicate study instance UID?
"RTN","MAGDQR21",318,0)
 . D WRTOUT^MAGDQR21("STUDY_ERR|"_UID_"|"_PATCOUNT_" different patients")
"RTN","MAGDQR21",319,0)
 . S CONT=$S('REQDFN:0,'$D(PAT(REQDFN)):0,1:1) ;continue processing with error if patient requested found 
"RTN","MAGDQR21",320,0)
 . Q
"RTN","MAGDQR21",321,0)
 ;
"RTN","MAGDQR21",322,0)
 Q CONT
"RTN","MAGDQR21",323,0)
 ;
"RTN","MAGDQR21",324,0)
WRTIEN(UID,I0,TOTIMAGES,TDCMIMG,REQDFN) ; Output STUDY UID and IEN line
"RTN","MAGDQR21",325,0)
 N OBJGRP
"RTN","MAGDQR21",326,0)
 ; 
"RTN","MAGDQR21",327,0)
 D:UID'="" WRTOUT^MAGDQR21("STUDY_UID|"_UID)
"RTN","MAGDQR21",328,0)
 I 'I0 D WRTOUT^MAGDQR21("STUDY_ERR|"_UID_"|Matching study not found for patient "_REQDFN) Q 0
"RTN","MAGDQR21",329,0)
 S OBJGRP=$$ONEGROUP^MAGDQR21(I0) ; get the first image IEN for group/image I0
"RTN","MAGDQR21",330,0)
 D WRTOUT^MAGDQR21("STUDY_IEN|"_I0_"|"_TOTIMAGES_"|"_OBJGRP_"|"_$$CPTCODE^MAGDQR21(I0)_"|"_$$GETSITE1^MAGDQR21(OBJGRP)_"|"_TDCMIMG)
"RTN","MAGDQR21",331,0)
 Q 1
"RTN","MAGDQR21",332,0)
 ; 
"RTN","MAGDQR21",333,0)
INTEGDFN(I0,REQDFN,INCDEL) ; check integrity of study record
"RTN","MAGDQR21",334,0)
 ;Return 1 if Specified DFN (REQDFN) matches study DFN (VA internal use only!)
"RTN","MAGDQR21",335,0)
 ;       0 otherwise
"RTN","MAGDQR21",336,0)
 N X,CONT,MAGFIL,QINTEG
"RTN","MAGDQR21",337,0)
 ;
"RTN","MAGDQR21",338,0)
 D CHK^MAGGSQI(.X,I0)
"RTN","MAGDQR21",339,0)
 S QINTEG='$G(X(0))
"RTN","MAGDQR21",340,0)
 D:QINTEG APDOUT^MAGDQR21("|"_$P($G(X(0)),"^",2))
"RTN","MAGDQR21",341,0)
 S CONT=1
"RTN","MAGDQR21",342,0)
 ; override QI check only if image DFN = DFN specified in call
"RTN","MAGDQR21",343,0)
 ; (VA internal only!)
"RTN","MAGDQR21",344,0)
 I QINTEG D
"RTN","MAGDQR21",345,0)
 . I 'REQDFN S CONT=0 Q
"RTN","MAGDQR21",346,0)
 . S MAGFIL=$$FILE^MAGGI11(I0)
"RTN","MAGDQR21",347,0)
 . I MAGFIL="" S CONT=0 Q
"RTN","MAGDQR21",348,0)
 . S:$P($G(^MAG(MAGFIL,I0,0)),"^",7)'=REQDFN CONT=0
"RTN","MAGDQR21",349,0)
 . Q
"RTN","MAGDQR21",350,0)
 ;
"RTN","MAGDQR21",351,0)
 Q CONT
"RTN","MAGDQR21",352,0)
 ;
"RTN","MAGDQR21",353,0)
WRTMOD(STUMO) ; Output STUDY_MODALITY line
"RTN","MAGDQR21",354,0)
 N M,X
"RTN","MAGDQR21",355,0)
 S X="",M=""
"RTN","MAGDQR21",356,0)
 F  S M=$O(STUMO(M)) Q:M=""  S X=X_$S(X'="":",",1:"")_M
"RTN","MAGDQR21",357,0)
 D:X'="" WRTOUT^MAGDQR21("STUDY_MODALITY|"_X)
"RTN","MAGDQR21",358,0)
 Q
"RTN","MAGDQR21",359,0)
 ;
"RTN","MAGDQR21",360,0)
ONEGROUP(GROUP) ; Get the first IMAGE_IEN for this group in IMAGE file (#2005)
"RTN","MAGDQR21",361,0)
 ;                or IMAGE AUDIT file (#2005.1)  
"RTN","MAGDQR21",362,0)
 N D1,IMGIEN,MAGNODE
"RTN","MAGDQR21",363,0)
 S MAGNODE=$$NODE^MAGGI11(GROUP)
"RTN","MAGDQR21",364,0)
 I MAGNODE="" Q "0^Error 2 - First Image not available; No Data"
"RTN","MAGDQR21",365,0)
 I '$D(@MAGNODE@(1)) Q GROUP ; a single image (e.g., photo ID), not a group
"RTN","MAGDQR21",366,0)
 S IMGIEN=""
"RTN","MAGDQR21",367,0)
 S D1=$O(@MAGNODE@(1,0))
"RTN","MAGDQR21",368,0)
 I D1>0 S IMGIEN=+$G(@MAGNODE@(1,D1,0))
"RTN","MAGDQR21",369,0)
 I IMGIEN'>0 S IMGIEN=$O(^MAG(2005.1,"AGP",GROUP,""))
"RTN","MAGDQR21",370,0)
 I IMGIEN'>0 S IMGIEN="0^Error 1 - First Image not available"
"RTN","MAGDQR21",371,0)
 Q IMGIEN
"RTN","MAGDQR21",372,0)
 ;
"RTN","MAGDQR21",373,0)
WRTOUT(S) ; Write a new line
"RTN","MAGDQR21",374,0)
 N CNT
"RTN","MAGDQR21",375,0)
 S CNT=^TMP("MAG",$J,"STUDY",1)+1
"RTN","MAGDQR21",376,0)
 S ^TMP("MAG",$J,"STUDY",1)=CNT
"RTN","MAGDQR21",377,0)
 S ^TMP("MAG",$J,"STUDY",CNT)=S
"RTN","MAGDQR21",378,0)
 Q
"RTN","MAGDQR21",379,0)
 ;
"RTN","MAGDQR21",380,0)
APDOUT(S) ; Append to last line
"RTN","MAGDQR21",381,0)
 N CNT
"RTN","MAGDQR21",382,0)
 S CNT=^TMP("MAG",$J,"STUDY",1)
"RTN","MAGDQR21",383,0)
 S ^TMP("MAG",$J,"STUDY",CNT)=$G(^TMP("MAG",$J,"STUDY",CNT))_S
"RTN","MAGDQR21",384,0)
 Q
"RTN","MAGDQR21",385,0)
 ;
"RTN","MAGDQR21",386,0)
CPTCODE(MAGIEN) ; Returns CPT code by IEN (image pointer) in IMAGE file (#2005)
"RTN","MAGDQR21",387,0)
 ;                or IMAGE AUDIT file (#2005.1)  
"RTN","MAGDQR21",388,0)
 ; MAGIEN = IEN in IMAGE file (#2005) or IMAGE AUDIT file (#2005.1)
"RTN","MAGDQR21",389,0)
 N RAIEN,CPTCODE,MAGFILE
"RTN","MAGDQR21",390,0)
 S MAGFILE=$$FILE^MAGGI11(MAGIEN)
"RTN","MAGDQR21",391,0)
 S RAIEN=+$$GET1^DIQ(MAGFILE,MAGIEN,62,"I")  ; Get PACS PROCEDURE field #62
"RTN","MAGDQR21",392,0)
 S CPTCODE=$P($G(^RAMIS(71,RAIEN,0)),"^",9) ; IA # 1174  get CPT Code
"RTN","MAGDQR21",393,0)
 Q:CPTCODE="" ""  ; quit with empty code
"RTN","MAGDQR21",394,0)
 S CPTCODE=$$CPT^ICPTCOD(CPTCODE) ; IA # 1995, supported reference
"RTN","MAGDQR21",395,0)
 Q $P(CPTCODE,"^",2) ; Return the code
"RTN","MAGDQR21",396,0)
 ;
"RTN","MAGDQR21",397,0)
GETSITE1(MAGIEN) ; Returns STATION NUMBER where the image is stored
"RTN","MAGDQR21",398,0)
 ; MAGIEN = IEN in IMAGE file (#2005)
"RTN","MAGDQR21",399,0)
 N MAGNODE,TMP,NLOCIEN,PLC
"RTN","MAGDQR21",400,0)
 N SITEIEN,SITENUM
"RTN","MAGDQR21",401,0)
 I MAGIEN'>0 Q ""
"RTN","MAGDQR21",402,0)
 D:'$D(MAGJOB("NETPLC")) NETPLCS^MAGGTU6 ; Initialize MAGJOB("NETPLC")
"RTN","MAGDQR21",403,0)
 S MAGNODE=$$NODE^MAGGI11(MAGIEN)
"RTN","MAGDQR21",404,0)
 I MAGNODE="" Q ""
"RTN","MAGDQR21",405,0)
 S TMP=$G(@MAGNODE@(0))
"RTN","MAGDQR21",406,0)
 S NLOCIEN=+$S($P(TMP,U,3):$P(TMP,U,3),1:$P(TMP,U,5)) ; Get IEN in NETWORK LOCATION file (#2005.2)
"RTN","MAGDQR21",407,0)
 S PLC=$P($G(MAGJOB("NETPLC",NLOCIEN)),U,1)     ; Imaging Site Parameters IEN
"RTN","MAGDQR21",408,0)
 Q $$GETSNUM^MAGDQR21(PLC)  ; Return STATION NUMBER
"RTN","MAGDQR21",409,0)
 ;
"RTN","MAGDQR21",410,0)
GETSNUM(MAGPLC) ; Returns STATION NUMBER by Image Site Parameters IEN
"RTN","MAGDQR21",411,0)
 ; MAGPLC - IEN in IMAGING SITE PARAMETERS file (#2006.1)
"RTN","MAGDQR21",412,0)
 I MAGPLC'>0 Q ""
"RTN","MAGDQR21",413,0)
 N SITEIEN,SITENUM
"RTN","MAGDQR21",414,0)
 S SITEIEN=$P($G(^MAG(2006.1,MAGPLC,0)),U,1)    ; Get Station IEN in INSTITUTION file (#4)
"RTN","MAGDQR21",415,0)
 Q:SITEIEN="" ""  ; if SITE IEN is not defined return blank
"RTN","MAGDQR21",416,0)
 S SITENUM=$P($$NS^XUAF4(SITEIEN),U,2)      ; IA #2171  Get Station Number
"RTN","MAGDQR21",417,0)
 Q SITENUM
"RTN","MAGGSIA")
0^3^B35830061
"RTN","MAGGSIA",1,0)
MAGGSIA ;WOIFO/GEK/SG/NST - Imaging RPC Broker calls. Add/Modify Image entry ; Dec 05, 2018@10:43am
"RTN","MAGGSIA",2,0)
 ;;3.0;IMAGING;**7,21,8,59,93,201,221**;Dec 02, 2009;Build 163
"RTN","MAGGSIA",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGSIA",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIA",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSIA",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSIA",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSIA",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSIA",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSIA",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSIA",11,0)
 ;; |                                                               |
"RTN","MAGGSIA",12,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSIA",13,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGSIA",14,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGSIA",15,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGSIA",16,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGSIA",17,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIA",18,0)
 ;;
"RTN","MAGGSIA",19,0)
 Q
"RTN","MAGGSIA",20,0)
 ;
"RTN","MAGGSIA",21,0)
 ;**** CALLING ROUTINE is responsible for RENAMING THE IMAGE FILE
"RTN","MAGGSIA",22,0)
 ;**** on DISK TO THE NEW FILE NAME RETURNED BY THIS CALL.
"RTN","MAGGSIA",23,0)
 ;
"RTN","MAGGSIA",24,0)
ADD(MAGRY,MAGARRAY) ; RPC [MAG4 ADD IMAGE]
"RTN","MAGGSIA",25,0)
 ; Calls UPDATE^DIE to Add an Image File entry
"RTN","MAGGSIA",26,0)
 ;  Called from Import API Delphi component and ImportX (Active X) control.
"RTN","MAGGSIA",27,0)
 ;  Parameters : 
"RTN","MAGGSIA",28,0)
 ;    MAGARRAY -  array of field numbers and their entries
"RTN","MAGGSIA",29,0)
 ;             i.e. MAGARRAY(1)=".5^38"  field# .5   data is 38
"RTN","MAGGSIA",30,0)
 ;    If Long Description is included in array (field 11), we create a new
"RTN","MAGGSIA",31,0)
 ;      array to hold the text, and pass that to UPDATE^DIE
"RTN","MAGGSIA",32,0)
 ;    If this entry is an Image Group
"RTN","MAGGSIA",33,0)
 ;      i.e. MAGARRAY(n)="2005.04^344"
"RTN","MAGGSIA",34,0)
 ;      (the field 2005.04 is the OBJECT GROUP MULTIPLE)
"RTN","MAGGSIA",35,0)
 ;      ( 344 is the pointer to the Image File Entry that will be added
"RTN","MAGGSIA",36,0)
 ;      ( as a member of this new/existing Group)
"RTN","MAGGSIA",37,0)
 ;
"RTN","MAGGSIA",38,0)
 ;  Return Variable
"RTN","MAGGSIA",39,0)
 ;
"RTN","MAGGSIA",40,0)
 ;    MAGRY(0) - Array
"RTN","MAGGSIA",41,0)
 ;      Successful   MAGRY(0) = IEN^FILE NAME (with full path)
"RTN","MAGGSIA",42,0)
 ;      UNsuccessful MAGRY(0) = 0^Error desc
"RTN","MAGGSIA",43,0)
 ;                   MAGRY(0)(1..n) = Errors and warnings. 
"RTN","MAGGSIA",44,0)
 ;
"RTN","MAGGSIA",45,0)
 ;    CALLING ROUTINE is responsible for RENAMING THE IMAGE FILE on DISK
"RTN","MAGGSIA",46,0)
 ;      TO THE NEW FILE NAME RETURNED BY THIS CALL.
"RTN","MAGGSIA",47,0)
 ;      Changed to include hierarchical directory hash  - PMK 04/23/98
"RTN","MAGGSIA",48,0)
 ;----------------------------------------------------------------
"RTN","MAGGSIA",49,0)
 N MAGGFDA,MAGGDRV,MAGGRP,MAGCHLD,GRPCT,MAGGDA,MAGGFNM
"RTN","MAGGSIA",50,0)
 N MAGGWP,MAGERR,MAGREF,MAGDHASH,MAGTEMP,MAGACT,MAGGIEN,MAGGXE
"RTN","MAGGSIA",51,0)
 N NEWIEN,I,J,X,Y,Z,WPCT
"RTN","MAGGSIA",52,0)
 ;
"RTN","MAGGSIA",53,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERRA^MAGGSERR"
"RTN","MAGGSIA",54,0)
 I ($D(MAGARRAY)<10) S MAGRY(0)="0^No input data, Operation CANCELED" Q
"RTN","MAGGSIA",55,0)
 ;
"RTN","MAGGSIA",56,0)
 S MAGRY(0)="0^Creating VistA Image Entry..."
"RTN","MAGGSIA",57,0)
 S MAGERR="",MAGGRP=0,GRPCT=1,WPCT=0
"RTN","MAGGSIA",58,0)
 ;  Validate the Data, and Action codes in the Input Array
"RTN","MAGGSIA",59,0)
 D VAL^MAGGSIV(.MAGRY,.MAGARRAY) I 'MAGRY(0) Q
"RTN","MAGGSIA",60,0)
 ;
"RTN","MAGGSIA",61,0)
 ;  Make the FileMan FDA array and the Imaging Action array.
"RTN","MAGGSIA",62,0)
 D MAKEFDA^MAGGSIU2(.MAGGFDA,.MAGARRAY,.MAGACT,.MAGCHLD,.MAGGRP,.MAGGWP)
"RTN","MAGGSIA",63,0)
 I '$D(MAGGFDA(2005,"+1,")) S MAGRY(0)="0^No data to file.  Operation CANCELED." Q
"RTN","MAGGSIA",64,0)
 ;
"RTN","MAGGSIA",65,0)
 ;Q:'$$VALINDEX^MAGGSIV1(.MAGRY,$G(MAGGFDA(2005,"+1,",42)),$G(MAGGFDA(2005,"+1,",44)),$G(MAGGFDA(2005,"+1,",43)))
"RTN","MAGGSIA",66,0)
 ;  Check on some possible problems: required fields, create default values etc.
"RTN","MAGGSIA",67,0)
 D PRE^MAGGSIA1(.MAGERR,.MAGGFDA,MAGGRP,.MAGGDRV,.MAGREF) I $L(MAGERR) S MAGRY(0)=MAGERR Q
"RTN","MAGGSIA",68,0)
 ; Locking Patch 8. Get latest Image IEN and Deleted IEN take the greater of the two.
"RTN","MAGGSIA",69,0)
 S (MAGGIEN(1),NEWIEN)=$$NEWIEN^MAGGI12()  ; SG - MAG*3*93
"RTN","MAGGSIA",70,0)
 D UPDATE^DIE("S","MAGGFDA","MAGGIEN","MAGGXE")
"RTN","MAGGSIA",71,0)
 ;
"RTN","MAGGSIA",72,0)
 ;  ERROR: QUIT
"RTN","MAGGSIA",73,0)
 I '$G(MAGGIEN(1)) D  S MAGRY(0)=MAGERR Q
"RTN","MAGGSIA",74,0)
 . S MAGERR="0^ERROR Creating new Image File Entry "
"RTN","MAGGSIA",75,0)
 . I $D(DIERR) D RTRNERR^MAGGSIU1(.MAGERR)
"RTN","MAGGSIA",76,0)
 . D CLEAN
"RTN","MAGGSIA",77,0)
 ;
"RTN","MAGGSIA",78,0)
 S MAGGDA=MAGGIEN(1)
"RTN","MAGGSIA",79,0)
 ;
"RTN","MAGGSIA",80,0)
 D ACTION^MAGGTAU("CAP^"_MAGGFDA(2005,"+1,",5)_"^"_MAGGDA)
"RTN","MAGGSIA",81,0)
 ;
"RTN","MAGGSIA",82,0)
 ; IF a group, UpDate the GROUP PARENT in each Group Object and QUIT
"RTN","MAGGSIA",83,0)
 ;  The Return (MAGRY(0)) will be IEN with NO Filename. Groups don't get Filename
"RTN","MAGGSIA",84,0)
 I MAGGRP D  G C1
"RTN","MAGGSIA",85,0)
 . D UPDCHLD^MAGGSIM(.MAGCHLD,MAGGDA)
"RTN","MAGGSIA",86,0)
 . S MAGRY(0)=MAGGDA_U
"RTN","MAGGSIA",87,0)
 . D CLEAN
"RTN","MAGGSIA",88,0)
 . Q
"RTN","MAGGSIA",89,0)
 ; ENTRY in Image File has been made, if any errors from here on
"RTN","MAGGSIA",90,0)
 ;  then we have to delete the image entry.
"RTN","MAGGSIA",91,0)
 ;  IF This image is a member of a Group, Update the Group Entry with new child.
"RTN","MAGGSIA",92,0)
 S X=$G(MAGGFDA(2005,"+1,",14)) I +X D  I $L(MAGERR) Q
"RTN","MAGGSIA",93,0)
 . D UPDPAR^MAGGSIM(.MAGERR,X,.MAGACT,MAGGDA)
"RTN","MAGGSIA",94,0)
 . I $L(MAGERR) S MAGRY(0)=MAGERR D CLEAN
"RTN","MAGGSIA",95,0)
 ;
"RTN","MAGGSIA",96,0)
 ; Now generate the Image FileName. This is passed back to the calling app, 
"RTN","MAGGSIA",97,0)
 ;  and the calling app is responsible for renaming/copying the Image File to
"RTN","MAGGSIA",98,0)
 ;  this new name. 
"RTN","MAGGSIA",99,0)
 I $D(MAGGFDA(2005,"+1,",1)) S MAGGFNM=MAGGFDA(2005,"+1,",1)
"RTN","MAGGSIA",100,0)
 E  D  I $L(MAGERR) S MAGRY(0)=MAGERR Q
"RTN","MAGGSIA",101,0)
 . N MAGXFDA
"RTN","MAGGSIA",102,0)
 . S X=$$DA2NAME^MAGGTU1(MAGGDA,$G(MAGACT("EXT"))) I 'X D  Q
"RTN","MAGGSIA",103,0)
 . . S MAGERR=X
"RTN","MAGGSIA",104,0)
 . . D KILLENT^MAGGSIU1(MAGGDA)
"RTN","MAGGSIA",105,0)
 . . D CLEAN
"RTN","MAGGSIA",106,0)
 . ;
"RTN","MAGGSIA",107,0)
 . S MAGGFNM=$P(X,U,2),Y=MAGGDA_","
"RTN","MAGGSIA",108,0)
 . S MAGXFDA(2005,Y,1)=MAGGFNM
"RTN","MAGGSIA",109,0)
 . D UPDATE^DIE("","MAGXFDA","","MAGGXE")
"RTN","MAGGSIA",110,0)
 . ;   in case of an error
"RTN","MAGGSIA",111,0)
 . I $D(DIERR) D  Q
"RTN","MAGGSIA",112,0)
 . . D RTRNERR^MAGGSIU1(.MAGERR,.MAGGXE)
"RTN","MAGGSIA",113,0)
 . . D KILLENT^MAGGSIU1(MAGGDA)
"RTN","MAGGSIA",114,0)
 . . D CLEAN
"RTN","MAGGSIA",115,0)
 ;
"RTN","MAGGSIA",116,0)
C1 ; 59 
"RTN","MAGGSIA",117,0)
 K MAGGFDA ; P59.
"RTN","MAGGSIA",118,0)
 ;P59 Now we Auto-Generate the Index Fields, if they don't exist for this entry
"RTN","MAGGSIA",119,0)
 I '$D(^MAG(2005,MAGGDA,40)) D
"RTN","MAGGSIA",120,0)
 . N INDXD
"RTN","MAGGSIA",121,0)
 . D GENIEN^MAGXCVI(MAGGDA,.INDXD)
"RTN","MAGGSIA",122,0)
 . D COMIEN^MAGXCVC(MAGGDA,.INDXD)
"RTN","MAGGSIA",123,0)
 . S ^MAGIXCVT(2006.96,MAGGDA)=1 ; Flag. Says fields were converted by index generation
"RTN","MAGGSIA",124,0)
 . ; TRKING ID  TRKID =   MAGGFDA(2005,"+1,",108)
"RTN","MAGGSIA",125,0)
 . ;;D ACTION^MAGGTAU("GENINDX^"_MAGGFDA(2005,"+1,",5)_"^"_MAGGDA_"$$"_MAGGFDA(2005,"+1,",108))
"RTN","MAGGSIA",126,0)
 . D ACTION^MAGGTAU("INDEX-ALL^"_$P(^MAG(2005,MAGGDA,0),"^",7)_"^"_MAGGDA_"$$"_$P(^MAG(2005,MAGGDA,100),"^",5))
"RTN","MAGGSIA",127,0)
 . Q
"RTN","MAGGSIA",128,0)
 ;
"RTN","MAGGSIA",129,0)
 ;P59 If TYPE INDEX is missing we Auto-Generate Index Type and other missing Index Term values.
"RTN","MAGGSIA",130,0)
 I '$P(^MAG(2005,MAGGDA,40),"^",3) D
"RTN","MAGGSIA",131,0)
 . N INDXD,OLD40,N40
"RTN","MAGGSIA",132,0)
 . S (N40,OLD40)=^MAG(2005,MAGGDA,40)
"RTN","MAGGSIA",133,0)
 . D GENIEN^MAGXCVI(MAGGDA,.INDXD)
"RTN","MAGGSIA",134,0)
 . ; If Origin doesn't exist in existing, this will put V in. 
"RTN","MAGGSIA",135,0)
 . I $P(INDXD,"^",6)="" S $P(INDXD,"^",6)="V"
"RTN","MAGGSIA",136,0)
 . ; We're not changing existing values of Spec,Proc or Origin 
"RTN","MAGGSIA",137,0)
 . F J=1:1:6 I '$L($P(N40,"^",J)) S $P(N40,"^",J)=$P(INDXD,"^",J)
"RTN","MAGGSIA",138,0)
 . ;Validate the merged Spec and Proc, if  not valid, revert back to old Spec and Proc
"RTN","MAGGSIA",139,0)
 . I '$$VALINDEX^MAGGSIV1(.X,$P(N40,"^",3),$P(N40,"^",5),$P(N40,"^",4)) S $P(N40,"^",4,5)=$P(OLD40,"^",4,5)
"RTN","MAGGSIA",140,0)
 . S ^MAG(2005,MAGGDA,40)=N40
"RTN","MAGGSIA",141,0)
 . ;;D ACTION^MAGGTAU("INDEX-42^"_$P(^MAG(2005,MAGGDA,0),"^",7)_"^"_MAGGDA) ;_"$$"_MAGGFDA(2005,"+1,",108))
"RTN","MAGGSIA",142,0)
 . D ACTION^MAGGTAU("INDEX-42^"_$P(^MAG(2005,MAGGDA,0),"^",7)_"^"_MAGGDA_"$$"_$P(^MAG(2005,MAGGDA,100),"^",5))
"RTN","MAGGSIA",143,0)
 . D ENTRY^MAGLOG("INDEX-42",DUZ,MAGGDA,"P59",$P(^MAG(2005,MAGGDA,0),"^",7),1)
"RTN","MAGGSIA",144,0)
 . Q
"RTN","MAGGSIA",145,0)
 ;** ABS and JB image queues AREN'T SET WHEN ADDING AN IMAGE. 
"RTN","MAGGSIA",146,0)
 ;** RPC =-> 'MAG ABSJB' after abstract is/isn't created on the workstation
"RTN","MAGGSIA",147,0)
 ;
"RTN","MAGGSIA",148,0)
 ;  The Return is:  IEN ^ DRIVE:DIR ^ FILE.EXT [^ DRIVE:DIR ^ FILE.BIG]
"RTN","MAGGSIA",149,0)
 ;   example:  487^C:\IMAGE\^DC000487.TIF
"RTN","MAGGSIA",150,0)
 ;  The calling routine is responsible for renaming/naming the file
"RTN","MAGGSIA",151,0)
 ;   to the returned DRIVE:\DIR\FILENAME.EXT
"RTN","MAGGSIA",152,0)
 ;
"RTN","MAGGSIA",153,0)
 ; Modified 4/23/98 to include hierarchical directory structure -- PMK
"RTN","MAGGSIA",154,0)
 I 'MAGGRP D
"RTN","MAGGSIA",155,0)
 . S MAGDHASH=$$DIRHASH^MAGFILEB(MAGGFNM,MAGREF)
"RTN","MAGGSIA",156,0)
 . ; For now, BIG files are in same directory as FullRes (or PACS) file
"RTN","MAGGSIA",157,0)
 . S MAGRY(0)=MAGGDA_U_MAGGDRV_MAGDHASH_U_MAGGFNM
"RTN","MAGGSIA",158,0)
 . ; If BIG file also, add it's Drive, Hash, Filename to end of Return string.
"RTN","MAGGSIA",159,0)
 . I $G(MAGACT("BIG")) D
"RTN","MAGGSIA",160,0)
 . . S X=$P(MAGGFNM,".",1)_".BIG"
"RTN","MAGGSIA",161,0)
 . . S MAGRY(0)=MAGRY(0)_U_MAGGDRV_MAGDHASH_U_X
"RTN","MAGGSIA",162,0)
 . . Q
"RTN","MAGGSIA",163,0)
 . Q
"RTN","MAGGSIA",164,0)
 ;
"RTN","MAGGSIA",165,0)
 N MAGOUT
"RTN","MAGGSIA",166,0)
 D NWI2005^MAGNWRK1(.MAGOUT,MAGGDA) ; add a new storage work item
"RTN","MAGGSIA",167,0)
 ;
"RTN","MAGGSIA",168,0)
CLEAN ; Called as tag
"RTN","MAGGSIA",169,0)
 D CLEAN^DILF
"RTN","MAGGSIA",170,0)
 L -^MAG(2005,NEWIEN)
"RTN","MAGGSIA",171,0)
 Q
"RTN","MAGGTIA1")
0^4^B34088332
"RTN","MAGGTIA1",1,0)
MAGGTIA1 ;WOIFO/GEK/SG/NST - RPC Call to Add Image File entry ; Dec 05, 2018@1:42pm
"RTN","MAGGTIA1",2,0)
 ;;3.0;IMAGING;**21,8,59,93,201,221**;Dec 02, 2009;Build 163
"RTN","MAGGTIA1",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGTIA1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTIA1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGTIA1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGTIA1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGTIA1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGTIA1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGTIA1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGTIA1",11,0)
 ;; |                                                               |
"RTN","MAGGTIA1",12,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGTIA1",13,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGTIA1",14,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGTIA1",15,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGTIA1",16,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGTIA1",17,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTIA1",18,0)
 ;;
"RTN","MAGGTIA1",19,0)
 Q
"RTN","MAGGTIA1",20,0)
ADD ;Now call Fileman to file the data
"RTN","MAGGTIA1",21,0)
 N NEWIEN,MAGGDA,X,Y
"RTN","MAGGTIA1",22,0)
 ;~~~ Delete this comment and the following line of code when
"RTN","MAGGTIA1",23,0)
 ;    the IMAGE AUDIT file (#2005.1) is completely eliminated.
"RTN","MAGGTIA1",24,0)
 ;    Because we delete the Image node on image deletion, we have to 
"RTN","MAGGTIA1",25,0)
 ;    check the last entry in Audit File, to see if it is greater
"RTN","MAGGTIA1",26,0)
 ;~~~ than the last image in the Image File.
"RTN","MAGGTIA1",27,0)
 I ($O(^MAG(2005,"A"),-1)<$O(^MAG(2005.1,"A"),-1)) S $P(^MAG(2005,0),U,3)=$O(^MAG(2005.1,"A"),-1)
"RTN","MAGGTIA1",28,0)
 ;   we know that MAGGIEN WILL contain the internal number.
"RTN","MAGGTIA1",29,0)
 ;    after the call.
"RTN","MAGGTIA1",30,0)
 ;
"RTN","MAGGTIA1",31,0)
 I $G(MAGMOD) D  Q  ; WE'LL QUIT AFTER MODIFICATION
"RTN","MAGGTIA1",32,0)
 . D UPDATE^DIE("S","MAGGFDA","MAGGIEN","MAGGXE")
"RTN","MAGGTIA1",33,0)
 . S MAGRY="1^OK"
"RTN","MAGGTIA1",34,0)
 . ; Now, after UPDATE^DIE, we aren't getting the MAGGIEN array., We'll use MAGMOD
"RTN","MAGGTIA1",35,0)
 . D ACTION^MAGGTAU("MOD^"_$P(^MAG(2005,+MAGMOD,0),U,7)_"^"_+$G(MAGMOD)) ; This is the Image IEN
"RTN","MAGGTIA1",36,0)
 ;
"RTN","MAGGTIA1",37,0)
 S (MAGGIEN(1),NEWIEN)=$$NEWIEN^MAGGI12()  ; SG - MAG*3*93
"RTN","MAGGTIA1",38,0)
 D UPDATE^DIE("S","MAGGFDA","MAGGIEN","MAGGXE")
"RTN","MAGGTIA1",39,0)
 ;
"RTN","MAGGTIA1",40,0)
 I '$G(MAGGIEN(1)) D  S MAGRY=MAGERR Q
"RTN","MAGGTIA1",41,0)
 . S MAGERR="0^ERROR Creating new Image File Entry "
"RTN","MAGGTIA1",42,0)
 . I $D(DIERR) D RTRNERR(.MAGERR)
"RTN","MAGGTIA1",43,0)
 . D CLEAN
"RTN","MAGGTIA1",44,0)
 ;
"RTN","MAGGTIA1",45,0)
 S MAGGDA=MAGGIEN(1)
"RTN","MAGGTIA1",46,0)
 ;
"RTN","MAGGTIA1",47,0)
 D ACTION^MAGGTAU("CAP^"_MAGGFDA(2005,"+1,",5)_"^"_MAGGDA)
"RTN","MAGGTIA1",48,0)
 ;
"RTN","MAGGTIA1",49,0)
 ; IF a group, Modify GROUP PARENT in each Group Object and QUIT
"RTN","MAGGTIA1",50,0)
 ;   we'll do this by hand, Else it'll take forever.
"RTN","MAGGTIA1",51,0)
 ;   we Return the IEN with NO Filename. Groups don't get Filename
"RTN","MAGGTIA1",52,0)
 ;
"RTN","MAGGTIA1",53,0)
 I MAGGR S MAGRY=MAGGDA_U,Z="" D  G C1
"RTN","MAGGTIA1",54,0)
 . F  S Z=$O(MAGGR(Z)) Q:Z=""  S $P(^MAG(2005,Z,0),U,10)=MAGGDA
"RTN","MAGGTIA1",55,0)
 . D CLEAN
"RTN","MAGGTIA1",56,0)
 ;
"RTN","MAGGTIA1",57,0)
 S X=$G(MAGGFDA(2005,"+1,",14)) I +X D
"RTN","MAGGTIA1",58,0)
 . ; If here: This image is a member of a Group
"RTN","MAGGTIA1",59,0)
 . ;   -Modify the Group Parent, add DA to it's group
"RTN","MAGGTIA1",60,0)
 . ;   -Also set 'Series Number' and 'Image Number' if they exist;
"RTN","MAGGTIA1",61,0)
 . K MAGGFDA
"RTN","MAGGTIA1",62,0)
 . S Y="+2,"_X_","
"RTN","MAGGTIA1",63,0)
 . S MAGGFDA(2005.04,Y,.01)=MAGGDA
"RTN","MAGGTIA1",64,0)
 . ; GEK 4/4/00 ADDED $L( we were dying on "0"
"RTN","MAGGTIA1",65,0)
 . I $L($G(MAGDCMSN)) S MAGGFDA(2005.04,Y,1)=MAGDCMSN
"RTN","MAGGTIA1",66,0)
 . I $L($G(MAGDCMIN)) S MAGGFDA(2005.04,Y,2)=MAGDCMIN
"RTN","MAGGTIA1",67,0)
 . D UPDATE^DIE("S","MAGGFDA","MAGGIEN","MAGGXE")
"RTN","MAGGTIA1",68,0)
 ;
"RTN","MAGGTIA1",69,0)
 ; Now get the Image file name. DOS FILE name
"RTN","MAGGTIA1",70,0)
 ; The ENTRY in Image File has been made, if any errors from here on
"RTN","MAGGTIA1",71,0)
 ;  then we have to delete the image entry.
"RTN","MAGGTIA1",72,0)
 I $D(MAGGFDA(2005,"+1,",1)) S MAGGFNM=MAGGFDA(2005,"+1,",1) G C1
"RTN","MAGGTIA1",73,0)
 K MAGGFDA
"RTN","MAGGTIA1",74,0)
 S X=$$DA2NAME^MAGGTU1(MAGGDA,$G(MAGGEXT)) I 'X D  S MAGRY=MAGERR Q
"RTN","MAGGTIA1",75,0)
 . S MAGERR=X
"RTN","MAGGTIA1",76,0)
 . S DA=MAGGDA,DIK="^MAG(2005," D ^DIK
"RTN","MAGGTIA1",77,0)
 . K DA,DIC,DIK
"RTN","MAGGTIA1",78,0)
 . D CLEAN
"RTN","MAGGTIA1",79,0)
 S MAGGFNM=$P(X,U,2),Y=MAGGDA_","
"RTN","MAGGTIA1",80,0)
 S MAGGFDA(2005,Y,1)=MAGGFNM
"RTN","MAGGTIA1",81,0)
 D UPDATE^DIE("","MAGGFDA","","MAGGXE")
"RTN","MAGGTIA1",82,0)
 ;   shouldn't have an error just editing one entry, but just in case.
"RTN","MAGGTIA1",83,0)
 I $D(DIERR) D  S MAGRY=MAGERR Q
"RTN","MAGGTIA1",84,0)
 . D RTRNERR(.MAGERR)
"RTN","MAGGTIA1",85,0)
 . S DA=MAGGDA,DIK="^MAG(2005," D ^DIK
"RTN","MAGGTIA1",86,0)
 . K DA,DIC,DIK
"RTN","MAGGTIA1",87,0)
 . D CLEAN
"RTN","MAGGTIA1",88,0)
 ;
"RTN","MAGGTIA1",89,0)
C1 ; we jump here if we already had a Filename sent
"RTN","MAGGTIA1",90,0)
 K MAGGFDA
"RTN","MAGGTIA1",91,0)
 ; New Index Field Check.  If this entry doesn't have the Index fields introduced
"RTN","MAGGTIA1",92,0)
 ;   in 3.0.8 then we use the Patch 17 conversion API call to generate default values.
"RTN","MAGGTIA1",93,0)
 ;
"RTN","MAGGTIA1",94,0)
 ;P59 Now we Auto-Generate the Index Fields, if they don't exist for this entry.
"RTN","MAGGTIA1",95,0)
 I '$D(^MAG(2005,MAGGDA,40)) D
"RTN","MAGGTIA1",96,0)
 . N INDXD
"RTN","MAGGTIA1",97,0)
 . D GENIEN^MAGXCVI(MAGGDA,.INDXD)
"RTN","MAGGTIA1",98,0)
 . S ^MAG(2005,MAGGDA,40)=INDXD
"RTN","MAGGTIA1",99,0)
 . S ^MAGIXCVT(2006.96,MAGGDA)=2 ; Flag. Says fields were converted Patch 59
"RTN","MAGGTIA1",100,0)
 . ; TRKING ID  TRKID =   MAGGFDA(2005,"+1,",108)
"RTN","MAGGTIA1",101,0)
 . D ACTION^MAGGTAU("INDEX-ALL^"_$P(^MAG(2005,MAGGDA,0),"^",7)_"^"_MAGGDA) ;_"$$"_MAGGFDA(2005,"+1,",108))
"RTN","MAGGTIA1",102,0)
 . D ENTRY^MAGLOG("INDEX-ALL",DUZ,MAGGDA,"P59",$P(^MAG(2005,MAGGDA,0),"^",7),1)
"RTN","MAGGTIA1",103,0)
 . Q
"RTN","MAGGTIA1",104,0)
 ;P59 If TYPE INDEX is missing we Auto-Generate Index Type and other missing Index Term values.
"RTN","MAGGTIA1",105,0)
 I '$P(^MAG(2005,MAGGDA,40),"^",3) D
"RTN","MAGGTIA1",106,0)
 . N INDXD,J,OLD40,N40
"RTN","MAGGTIA1",107,0)
 . S (N40,OLD40)=^MAG(2005,MAGGDA,40)
"RTN","MAGGTIA1",108,0)
 . D GENIEN^MAGXCVI(MAGGDA,.INDXD)
"RTN","MAGGTIA1",109,0)
 . ; If Origin doesn't exist in existing, this will put V in. 
"RTN","MAGGTIA1",110,0)
 . I $P(INDXD,"^",6)="" S $P(INDXD,"^",6)="V"
"RTN","MAGGTIA1",111,0)
 . ; We're not changing existing values of Spec,Proc or Origin 
"RTN","MAGGTIA1",112,0)
 . F J=1:1:6 I '$L($P(N40,"^",J)) S $P(N40,"^",J)=$P(INDXD,"^",J)
"RTN","MAGGTIA1",113,0)
 . ;Validate the merged Spec and Proc, if  not valid, revert back to old Spec and Proc
"RTN","MAGGTIA1",114,0)
 . I '$$VALINDEX^MAGGSIV1(.X,$P(N40,"^",3),$P(N40,"^",5),$P(N40,"^",4)) S $P(N40,"^",4,5)=$P(OLD40,"^",4,5)
"RTN","MAGGTIA1",115,0)
 . S ^MAG(2005,MAGGDA,40)=N40
"RTN","MAGGTIA1",116,0)
 . D ACTION^MAGGTAU("INDEX-42^"_$P(^MAG(2005,MAGGDA,0),"^",7)_"^"_MAGGDA) ;_"$$"_MAGGFDA(2005,"+1,",108))
"RTN","MAGGTIA1",117,0)
 . D ENTRY^MAGLOG("INDEX-42",DUZ,MAGGDA,"P59",$P(^MAG(2005,MAGGDA,0),"^",7),1)
"RTN","MAGGTIA1",118,0)
 . Q
"RTN","MAGGTIA1",119,0)
 ;** ABS and JB image queues AREN'T SET WHEN ADDING AN IMAGE. 
"RTN","MAGGTIA1",120,0)
 ;** IT IS DONE IN A SEPERATE CALL 
"RTN","MAGGTIA1",121,0)
 ;** RPC =-> 'MAG ABSJB' after abstract is/isn't created on 
"RTN","MAGGTIA1",122,0)
 ;**  the workstation
"RTN","MAGGTIA1",123,0)
 ;
"RTN","MAGGTIA1",124,0)
 ; Queue it to be copied to Jukebox.
"RTN","MAGGTIA1",125,0)
 ;        CREATE ABSTRACT
"RTN","MAGGTIA1",126,0)
 ; visn15 ADDED $$DA2PLCA to resolve the Image's current PLACE
"RTN","MAGGTIA1",127,0)
 I $G(MAGGABS)="YES" S X=$$ABSTRACT^MAGBAPI(MAGGDA,$$DA2PLC^MAGBAPIP(MAGGDA,"A"))
"RTN","MAGGTIA1",128,0)
 ;        RESTORE AFTER GLOBAL SETUP
"RTN","MAGGTIA1",129,0)
 I $G(MAGGJB)="YES" S X=$$JUKEBOX^MAGBAPI(MAGGDA,$$DA2PLC^MAGBAPIP(MAGGDA,"F"))
"RTN","MAGGTIA1",130,0)
 ;     Code for setting a Queue to Copy BIG to JUKEBOX
"RTN","MAGGTIA1",131,0)
 ; 
"RTN","MAGGTIA1",132,0)
 ;  We return the IEN ^ DRIVE:DIR ^ FILE.EXT
"RTN","MAGGTIA1",133,0)
 ;   example:   487^C:\IMAGE\^DC000487.TIF
"RTN","MAGGTIA1",134,0)
 ;  The calling routine is responsible for renaming/naming the file
"RTN","MAGGTIA1",135,0)
 ;   to the returned DRIVE:\DIR\FILENAME.EXT
"RTN","MAGGTIA1",136,0)
 ;  4/23/98 to include hierarchical directory structure -- PMK
"RTN","MAGGTIA1",137,0)
 ;
"RTN","MAGGTIA1",138,0)
 I 'MAGGR D
"RTN","MAGGTIA1",139,0)
 . S MAGDHASH=$$DIRHASH^MAGFILEB(MAGGFNM,MAGREF)
"RTN","MAGGTIA1",140,0)
 . S MAGRY=MAGGDA_U_MAGGDRV_MAGDHASH_U_MAGGFNM
"RTN","MAGGTIA1",141,0)
 . ; For now, BIG files are in same directory as FullRes (or PACS) file
"RTN","MAGGTIA1",142,0)
 . I $G(MAGBIG) D
"RTN","MAGGTIA1",143,0)
 . . S X=$P(MAGGFNM,".",1)_".BIG"
"RTN","MAGGTIA1",144,0)
 . . S MAGRY=MAGRY_U_MAGGDRV_MAGDHASH_U_X
"RTN","MAGGTIA1",145,0)
 . . Q
"RTN","MAGGTIA1",146,0)
 . Q
"RTN","MAGGTIA1",147,0)
 ;
"RTN","MAGGTIA1",148,0)
 N MAGOUT
"RTN","MAGGTIA1",149,0)
 D NWI2005^MAGNWRK1(.MAGOUT,MAGGDA) ; add a new storage work item
"RTN","MAGGTIA1",150,0)
 ;
"RTN","MAGGTIA1",151,0)
CLEAN ;
"RTN","MAGGTIA1",152,0)
 D CLEAN^DILF
"RTN","MAGGTIA1",153,0)
 L -^MAG(2005,NEWIEN)
"RTN","MAGGTIA1",154,0)
 Q
"RTN","MAGGTIA1",155,0)
RTRNERR(ETXT) ; There was error from UPDATE^DIE quit with error text
"RTN","MAGGTIA1",156,0)
 S ETXT="0^ERROR  "_MAGGXE("DIERR",1,"TEXT",1)
"RTN","MAGGTIA1",157,0)
 Q
"RTN","MAGGTIA1",158,0)
ERR ; Error trap
"RTN","MAGGTIA1",159,0)
 S MAGRY="0^ERROR "_$$EC^%ZOSV
"RTN","MAGGTIA1",160,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGGTIA1",161,0)
 Q
"RTN","MAGGTIA1",162,0)
MAKENAME() ; MAGGFDA exists so get info from that.
"RTN","MAGGTIA1",163,0)
 ; We'll make NAME (.01)  with PATIENT NAME   SSN
"RTN","MAGGTIA1",164,0)
 ; DOCUMENT Imaging was making name of
"RTN","MAGGTIA1",165,0)
 ; $E(PATENT NAME,1,10)' '$E(DESC CATEG,1,9)' 'MM/DD/YY   (DOC DATE)
"RTN","MAGGTIA1",166,0)
 N Z,ZT,ZNAME,ZSSN,ZDESC
"RTN","MAGGTIA1",167,0)
 ; GEK 10/10/2000
"RTN","MAGGTIA1",168,0)
 ; Modifying this procedure to make same name for all Image types
"RTN","MAGGTIA1",169,0)
 ;  The name will be (first 18 chars of patient Name) _ SSN
"RTN","MAGGTIA1",170,0)
 I $D(MAGGFDA(2005,"+1,",10)) S ZDESC=$E(MAGGFDA(2005,"+1,",10),1,30)
"RTN","MAGGTIA1",171,0)
 I $D(MAGGFDA(2005,"+1,",5)) D
"RTN","MAGGTIA1",172,0)
 . S X=MAGGFDA(2005,"+1,",5)
"RTN","MAGGTIA1",173,0)
 . S ZNAME=$P(^DPT(X,0),U),ZSSN=$P(^DPT(X,0),U,9)
"RTN","MAGGTIA1",174,0)
 ;
"RTN","MAGGTIA1",175,0)
 ; For all Images the name is first 18 characters of patient name 
"RTN","MAGGTIA1",176,0)
 ;  concatenated with SSN.  If No patient name is sent, well make
"RTN","MAGGTIA1",177,0)
 ;  the name from the short desc.
"RTN","MAGGTIA1",178,0)
 I $D(ZNAME) S Z=$E(ZNAME,1,18)_"   "_ZSSN
"RTN","MAGGTIA1",179,0)
 E  S Z=ZDESC
"RTN","MAGGTIA1",180,0)
 Q Z
"RTN","MAGNPCHE")
0^5^B19371617
"RTN","MAGNPCHE",1,0)
MAGNPCHE ;WOIFO/NST - Pre-Cach RPC calls; OCT 18, 2018@4:05 PM
"RTN","MAGNPCHE",2,0)
 ;;3.0;IMAGING;**221**;Mar 19, 2002;Build 27;May 23, 2012
"RTN","MAGNPCHE",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNPCHE",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNPCHE",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNPCHE",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNPCHE",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNPCHE",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNPCHE",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNPCHE",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNPCHE",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNPCHE",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNPCHE",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNPCHE",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNPCHE",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNPCHE",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNPCHE",17,0)
 ;;
"RTN","MAGNPCHE",18,0)
 Q
"RTN","MAGNPCHE",19,0)
 ;***** PRE-CACHE PATIENT EXAM BY CPT
"RTN","MAGNPCHE",20,0)
 ;
"RTN","MAGNPCHE",21,0)
 ; RPC: MAGN PRECACHE BY CPT
"RTN","MAGNPCHE",22,0)
 ;
"RTN","MAGNPCHE",23,0)
 ; .MAGOUT   Reference to a local variable where the results are returned to
"RTN","MAGNPCHE",24,0)
 ; IDTYPE    - "DFN" or "ICN"
"RTN","MAGNPCHE",25,0)
 ; ID        = Patient DFN or ICN
"RTN","MAGNPCHE",26,0)
 ; CPT       - CPT Code to search for prior patient exams
"RTN","MAGNPCHE",27,0)
 ;
"RTN","MAGNPCHE",28,0)
 ; Return Values
"RTN","MAGNPCHE",29,0)
 ; =============   
"RTN","MAGNPCHE",30,0)
 ; MAGRY(0) if error 0^error message
"RTN","MAGNPCHE",31,0)
 ; MAGRY(1..n) = SITE NUMBER ^ DFN ^ ICN ^ CPRSCONTEXTID 
"RTN","MAGNPCHE",32,0)
 ;
"RTN","MAGNPCHE",33,0)
PRECACHE(MAGRY,IDTYPE,ID,CPT) ; RPC [MAGN PRECACHE BY CPT]
"RTN","MAGNPCHE",34,0)
 N DFN,BEGDT,CHK,CNT,LIMYRS,LIMEXAMS,IDAT,MAGRET,RADATA,RARPT,MAGCPTS,Y
"RTN","MAGNPCHE",35,0)
 ;
"RTN","MAGNPCHE",36,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGGSERR"
"RTN","MAGNPCHE",37,0)
 ;
"RTN","MAGNPCHE",38,0)
 S MAGRY(0)=1
"RTN","MAGNPCHE",39,0)
 ;
"RTN","MAGNPCHE",40,0)
 S CNT=0
"RTN","MAGNPCHE",41,0)
 I (IDTYPE'="DFN")&(IDTYPE'="ICN") S MAGRY(0)="0^Invalid IDTYPE "_IDTYPE Q
"RTN","MAGNPCHE",42,0)
 ;
"RTN","MAGNPCHE",43,0)
 S DFN=$G(ID)
"RTN","MAGNPCHE",44,0)
 I IDTYPE="ICN" D
"RTN","MAGNPCHE",45,0)
 . S DFN=$S($T(GETDFN^MPIF001)'="":$$GETDFN^MPIF001(ID),1:"-1^NO MPI") ; Supported IA (#2701)
"RTN","MAGNPCHE",46,0)
 . Q
"RTN","MAGNPCHE",47,0)
 I DFN'>0 S MAGRY(0)="0^Error: "_DFN Q
"RTN","MAGNPCHE",48,0)
 ;
"RTN","MAGNPCHE",49,0)
 S MAGCPTS=$$GETCPTS(CPT)
"RTN","MAGNPCHE",50,0)
 I 'MAGCPTS Q  ; No rules defined for CPT
"RTN","MAGNPCHE",51,0)
 ;
"RTN","MAGNPCHE",52,0)
 S LIMYRS=30    ; default limit
"RTN","MAGNPCHE",53,0)
 S LIMEXAMS=100 ; default # Exams
"RTN","MAGNPCHE",54,0)
 S BEGDT=($E(DT,1,3)-LIMYRS)_$E(DT,4,7)
"RTN","MAGNPCHE",55,0)
 I BEGDT<2950101 S BEGDT=2950101 ; 2 yrs prior to earliest VistaPACS
"RTN","MAGNPCHE",56,0)
 D GETEXAM3^MAGJUTL1(DFN,BEGDT,"",0,.MAGRET,"",LIMEXAMS)  ; Get Patient's exams
"RTN","MAGNPCHE",57,0)
 S IDAT=""
"RTN","MAGNPCHE",58,0)
 F  S IDAT=$O(^TMP($J,"MAGRAEX",IDAT)) Q:'IDAT  D
"RTN","MAGNPCHE",59,0)
 . S RADATA=^TMP($J,"MAGRAEX",IDAT,1)
"RTN","MAGNPCHE",60,0)
 . S CHK=$$MATCHED(MAGCPTS,RADATA)
"RTN","MAGNPCHE",61,0)
 . I CHK D
"RTN","MAGNPCHE",62,0)
 . . S RARPT=+$P(RADATA,U,10)
"RTN","MAGNPCHE",63,0)
 . . S CNT=CNT+1,MAGRY(CNT)=$$GCPRSID^MAGNUTL2(RARPT)  ; pre-cache exams
"RTN","MAGNPCHE",64,0)
 . . Q
"RTN","MAGNPCHE",65,0)
 . Q
"RTN","MAGNPCHE",66,0)
 ;
"RTN","MAGNPCHE",67,0)
 K ^TMP($J,"MAGRAEX"),^TMP($J,"RAE1")
"RTN","MAGNPCHE",68,0)
 Q
"RTN","MAGNPCHE",69,0)
 ;
"RTN","MAGNPCHE",70,0)
GETCPTS(CPT)  ; Get CPT to search for
"RTN","MAGNPCHE",71,0)
 ; CPT - CPT to search for
"RTN","MAGNPCHE",72,0)
 N CPT3,CPT4,CPT5,MAGMATCH,X,Y
"RTN","MAGNPCHE",73,0)
 S MAGMATCH=""
"RTN","MAGNPCHE",74,0)
 S CPT5=CPT,CPT4=$E(CPT,1,4),CPT3=$E(CPT,1,3)
"RTN","MAGNPCHE",75,0)
 S Y=""
"RTN","MAGNPCHE",76,0)
 ;  Order of CPT5/4/3 is important for the algorithm, which
"RTN","MAGNPCHE",77,0)
 ;  uses the 1st rule found at the LOWEST level of detail defined
"RTN","MAGNPCHE",78,0)
 F X=CPT5,CPT4,CPT3 I $D(^MAG(2006.65,"B",X)) S Y=Y_$S(Y:",",1:"")_X S $P(MAGMATCH,U)=Y
"RTN","MAGNPCHE",79,0)
 Q MAGMATCH
"RTN","MAGNPCHE",80,0)
 ;
"RTN","MAGNPCHE",81,0)
MATCHED(MAGCPTS,RADATA) ;
"RTN","MAGNPCHE",82,0)
 ; Compare the patient's exams CPT codes to the
"RTN","MAGNPCHE",83,0)
 ; MAGCPTS CPT code, according to dictionary 2006.65
"RTN","MAGNPCHE",84,0)
 N RADFN,RARPT,RADTI,RACNI,RAIMGTYP,X,Y
"RTN","MAGNPCHE",85,0)
 N CPT,MAGMATCH,MAGDTH
"RTN","MAGNPCHE",86,0)
 S RADFN=$P(RADATA,U,1)
"RTN","MAGNPCHE",87,0)
 S RARPT=+$P(RADATA,U,10)
"RTN","MAGNPCHE",88,0)
 S RADTI=$P(RADATA,U,2)
"RTN","MAGNPCHE",89,0)
 S RACNI=$P(RADATA,U,3)
"RTN","MAGNPCHE",90,0)
 ;Q:$P(RADATA,U,15)<2 ""          ; Cancel or Waiting
"RTN","MAGNPCHE",91,0)
 S CPT=$P(RADATA,U,17)
"RTN","MAGNPCHE",92,0)
 Q:'CPT  ;  algorithm REQUIRES CPT codes be used
"RTN","MAGNPCHE",93,0)
 ;
"RTN","MAGNPCHE",94,0)
 S MAGMATCH=$$CPTMATCH(MAGCPTS,CPT)
"RTN","MAGNPCHE",95,0)
 ;
"RTN","MAGNPCHE",96,0)
 Q MAGMATCH
"RTN","MAGNPCHE",97,0)
 ;
"RTN","MAGNPCHE",98,0)
CPTMATCH(MAGCPTS,CPT) ; Find CPT match
"RTN","MAGNPCHE",99,0)
 N CPT3,CPT4,CPT5,CURCPTS,CURCPTX,HIT,MAGMATCH,X,Y,I
"RTN","MAGNPCHE",100,0)
 ;
"RTN","MAGNPCHE",101,0)
 I ('CPT)!('MAGCPTS) Q ""  ; No CPT
"RTN","MAGNPCHE",102,0)
 ;
"RTN","MAGNPCHE",103,0)
 S CURCPTS=MAGCPTS
"RTN","MAGNPCHE",104,0)
 S CPT5=CPT,CPT4=$E(CPT,1,4),CPT3=$E(CPT,1,3)
"RTN","MAGNPCHE",105,0)
 S MAGMATCH=""
"RTN","MAGNPCHE",106,0)
 S HIT=0
"RTN","MAGNPCHE",107,0)
 F  Q:CURCPTS=""  S CURCPTX=$O(^MAG(2006.65,"B",$P(CURCPTS,","),"")),CURCPTS=$P(CURCPTS,",",2,9) I CURCPTX]"" D  Q:HIT  ; 1st hit only
"RTN","MAGNPCHE",108,0)
 . ;  This algorithm checks from lowest detail to most general, and acts
"RTN","MAGNPCHE",109,0)
 . ;  on the information found at the FIRST Hit only
"RTN","MAGNPCHE",110,0)
 . F CPT="CPT5","CPT4","CPT3" Q:HIT  D  ;1st hit only
"RTN","MAGNPCHE",111,0)
 . . S CPT=@CPT
"RTN","MAGNPCHE",112,0)
 . . I CPT]"",$D(^MAG(2006.65,CURCPTX,1,"B",CPT)) D
"RTN","MAGNPCHE",113,0)
 . . . S HIT=1
"RTN","MAGNPCHE",114,0)
 . . . S X=$O(^MAG(2006.65,CURCPTX,1,"B",CPT,"")) D
"RTN","MAGNPCHE",115,0)
 . . . . S X=^MAG(2006.65,CURCPTX,1,X,0) S Y=5,X=$P(X,U,Y,Y+2)
"RTN","MAGNPCHE",116,0)
 . . . . I +X S MAGMATCH=CPT F I=2,3 S $P(MAGMATCH,U,I)=$P(X,U,I)
"RTN","MAGNPCHE",117,0)
 . . . . Q
"RTN","MAGNPCHE",118,0)
 . . . Q
"RTN","MAGNPCHE",119,0)
 . . Q
"RTN","MAGNPCHE",120,0)
 . Q
"RTN","MAGNPCHE",121,0)
 Q MAGMATCH
"RTN","MAGNUTL2")
0^6^B23733574
"RTN","MAGNUTL2",1,0)
MAGNUTL2 ;WOIFO/NST - VistRad subroutines for RPC calls ; NOV 19, 2018@1:42PM
"RTN","MAGNUTL2",2,0)
 ;;3.0;IMAGING;**201,221**;Dec 02, 2009;Build 163
"RTN","MAGNUTL2",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNUTL2",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNUTL2",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNUTL2",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNUTL2",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNUTL2",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNUTL2",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNUTL2",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNUTL2",11,0)
 ;; |                                                               |
"RTN","MAGNUTL2",12,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNUTL2",13,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNUTL2",14,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNUTL2",15,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNUTL2",16,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNUTL2",17,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNUTL2",18,0)
 ;;
"RTN","MAGNUTL2",19,0)
 Q
"RTN","MAGNUTL2",20,0)
 ;
"RTN","MAGNUTL2",21,0)
 ; Subroutines for pre-cache exams images
"RTN","MAGNUTL2",22,0)
 ; Entry Points:
"RTN","MAGNUTL2",23,0)
 ;   PRECACHE -- Subroutine call via Protocol trigger
"RTN","MAGNUTL2",24,0)
 ;
"RTN","MAGNUTL2",25,0)
PRECACHE ; Entry point from HL7 processing, to initiate precache at
"RTN","MAGNUTL2",26,0)
 ; time of radiology "Register Patient for Exam" RA REG protocol
"RTN","MAGNUTL2",27,0)
 ; Do not process if the exam is being Canceled (RACANC true)
"RTN","MAGNUTL2",28,0)
 ;
"RTN","MAGNUTL2",29,0)
 Q:'$$GET^XPAR("ALL","MAG PRECACHE RAD REG ENABLED",,"I")  ; IA# 2263 
"RTN","MAGNUTL2",30,0)
 ;
"RTN","MAGNUTL2",31,0)
 N RET S RET=""
"RTN","MAGNUTL2",32,0)
 I '($G(RADFN)&$G(RADTI)&$G(RACNI)&'$G(RACANC)) Q  ; Required vars
"RTN","MAGNUTL2",33,0)
 ; MAGJEX2 will call CACHE^MAGNUTL2 after collecting all images to be precached - "C" is a new action
"RTN","MAGNUTL2",34,0)
 D PRIOR1^MAGJEX2(.RET,"C"_U_RADFN_U_RADTI_U_RACNI)
"RTN","MAGNUTL2",35,0)
 D CPTWI(RADFN,RADTI,RACNI)  ; create work item with CPT code and patient treating facilities
"RTN","MAGNUTL2",36,0)
 Q
"RTN","MAGNUTL2",37,0)
 ;
"RTN","MAGNUTL2",38,0)
CACHE(RARPT) ; cache this case's images
"RTN","MAGNUTL2",39,0)
 ; Input: RARPT: IEN in RAD/NUC MED REPORTS file (#74)
"RTN","MAGNUTL2",40,0)
 ;
"RTN","MAGNUTL2",41,0)
 N MAGOUT
"RTN","MAGNUTL2",42,0)
 D NWRKITEM(.MAGOUT,RARPT)
"RTN","MAGNUTL2",43,0)
 Q 1
"RTN","MAGNUTL2",44,0)
 ;
"RTN","MAGNUTL2",45,0)
NWRKITEM(MAGOUT,RARPT) ;Create New MAG WORK ITEM
"RTN","MAGNUTL2",46,0)
 ; RARPT - IEN in RAD/NUC MED REPORTS file (#74)
"RTN","MAGNUTL2",47,0)
 ;
"RTN","MAGNUTL2",48,0)
 N CRTUSR,CRTAPP,DFN,ICN,J,MAGCTXID,MSGTAGS,TYPE,SUBTYPE,STATUS,PLACEID,PRIORITY,SSEP
"RTN","MAGNUTL2",49,0)
 ;
"RTN","MAGNUTL2",50,0)
 S SSEP="`"
"RTN","MAGNUTL2",51,0)
 S MAGCTXID=$$RACPRS^MAGNU003(RARPT) ; Radiology CPRS context
"RTN","MAGNUTL2",52,0)
 I MAGCTXID="" S MAGOUT=-20_SSEP_"CPRS context is blank"
"RTN","MAGNUTL2",53,0)
 S DFN=$$GET1^DIQ(74,RARPT,2,"I")
"RTN","MAGNUTL2",54,0)
 ;
"RTN","MAGNUTL2",55,0)
 S PLACEID=DUZ(2)
"RTN","MAGNUTL2",56,0)
 ;
"RTN","MAGNUTL2",57,0)
 ; TAGS
"RTN","MAGNUTL2",58,0)
 S J=0
"RTN","MAGNUTL2",59,0)
 S J=J+1,MSGTAGS(J)="contextID`"_$TR(MAGCTXID,"^","~")  ;CPRS Report Context ID and translate ^ to ~
"RTN","MAGNUTL2",60,0)
 S:DFN J=J+1,MSGTAGS(J)="patientDfn`"_DFN
"RTN","MAGNUTL2",61,0)
 I $L($T(GETICN^MPIF001)) D
"RTN","MAGNUTL2",62,0)
 . S ICN=$$GETICN^MPIF001(DFN)
"RTN","MAGNUTL2",63,0)
 . S:ICN>1 J=J+1,MSGTAGS(J)="patientIcn`"_ICN
"RTN","MAGNUTL2",64,0)
 . Q
"RTN","MAGNUTL2",65,0)
 S J=J+1,MSGTAGS(J)="registration`1"     ; precache flag
"RTN","MAGNUTL2",66,0)
 ;
"RTN","MAGNUTL2",67,0)
 S TYPE="PRECACHE"
"RTN","MAGNUTL2",68,0)
 S SUBTYPE="REGISTRATION"
"RTN","MAGNUTL2",69,0)
 S STATUS="New"
"RTN","MAGNUTL2",70,0)
 S PRIORITY=0
"RTN","MAGNUTL2",71,0)
 ;
"RTN","MAGNUTL2",72,0)
 S PLACEID=$$STA^XUAF4(PLACEID) ;IA # 2171
"RTN","MAGNUTL2",73,0)
 ;
"RTN","MAGNUTL2",74,0)
 S CRTUSR=DUZ  ; CREATED BY
"RTN","MAGNUTL2",75,0)
 ;
"RTN","MAGNUTL2",76,0)
 S CRTAPP="PRECACHE" ; CAPTURE APPLICATION
"RTN","MAGNUTL2",77,0)
 ;
"RTN","MAGNUTL2",78,0)
 D CRTITEM^MAGVIM01(.MAGOUT,TYPE,SUBTYPE,STATUS,PLACEID,PRIORITY,.MSGTAGS,CRTUSR,CRTAPP)
"RTN","MAGNUTL2",79,0)
 Q
"RTN","MAGNUTL2",80,0)
 ;
"RTN","MAGNUTL2",81,0)
CPTWI(RADFN,RADTI,RACNI)  ; create work item with CPT code and patient treating facilities
"RTN","MAGNUTL2",82,0)
 N MAGCPT,MAGDATA,MAGI,MAGOUT,MAGRET
"RTN","MAGNUTL2",83,0)
 N CRTUSR,CRTAPP,ICN,J,MSGTAGS,TYPE,SUBTYPE,STATUS,PLACEID,PRIORITY,SSEP
"RTN","MAGNUTL2",84,0)
 ;
"RTN","MAGNUTL2",85,0)
 K ^TMP($J,"MAGRAEX")
"RTN","MAGNUTL2",86,0)
 D GETEXAM2^MAGJUTL1(RADFN,RADTI,RACNI,"",.MAGRET) ; Get Exam Data
"RTN","MAGNUTL2",87,0)
 S MAGDATA=$G(^TMP($J,"MAGRAEX",1,1))
"RTN","MAGNUTL2",88,0)
 K ^TMP($J,"MAGRAEX")
"RTN","MAGNUTL2",89,0)
 S MAGCPT=$P(MAGDATA,U,17)
"RTN","MAGNUTL2",90,0)
 I 'MAGCPT Q  ; No CPT code found
"RTN","MAGNUTL2",91,0)
 ;
"RTN","MAGNUTL2",92,0)
 ; Get treating facilities 
"RTN","MAGNUTL2",93,0)
 D FACLIST^MAGJLST1(.MAGOUT,RADFN)
"RTN","MAGNUTL2",94,0)
 I MAGOUT(0)'>0 Q  ; No treating facilities found
"RTN","MAGNUTL2",95,0)
 ;
"RTN","MAGNUTL2",96,0)
 S SSEP="`"
"RTN","MAGNUTL2",97,0)
 S PLACEID=DUZ(2)
"RTN","MAGNUTL2",98,0)
 ;
"RTN","MAGNUTL2",99,0)
 ; TAGS
"RTN","MAGNUTL2",100,0)
 S J=0
"RTN","MAGNUTL2",101,0)
 S J=J+1,MSGTAGS(J)="patientDfn`"_RADFN
"RTN","MAGNUTL2",102,0)
 I $L($T(GETICN^MPIF001)) D
"RTN","MAGNUTL2",103,0)
 . S ICN=$$GETICN^MPIF001(RADFN)
"RTN","MAGNUTL2",104,0)
 . S:ICN>1 J=J+1,MSGTAGS(J)="patientIcn`"_ICN
"RTN","MAGNUTL2",105,0)
 . Q
"RTN","MAGNUTL2",106,0)
 ;
"RTN","MAGNUTL2",107,0)
 S MAGI=0
"RTN","MAGNUTL2",108,0)
 F  S MAGI=$O(MAGOUT(MAGI)) Q:'MAGI  D
"RTN","MAGNUTL2",109,0)
 . S J=J+1,MSGTAGS(J)="treatingStation"_MAGI_"`"_$P(MAGOUT(MAGI),"^")
"RTN","MAGNUTL2",110,0)
 . Q
"RTN","MAGNUTL2",111,0)
 ;
"RTN","MAGNUTL2",112,0)
 S J=J+1,MSGTAGS(J)="CPT`"_MAGCPT
"RTN","MAGNUTL2",113,0)
 S J=J+1,MSGTAGS(J)="remoteprior`1"     ; precache flag
"RTN","MAGNUTL2",114,0)
 ;
"RTN","MAGNUTL2",115,0)
 S TYPE="PRECACHE"
"RTN","MAGNUTL2",116,0)
 S SUBTYPE="REMOTEPRIOR"
"RTN","MAGNUTL2",117,0)
 S STATUS="New"
"RTN","MAGNUTL2",118,0)
 S PRIORITY=0
"RTN","MAGNUTL2",119,0)
 ;
"RTN","MAGNUTL2",120,0)
 S PLACEID=$$STA^XUAF4(PLACEID) ;IA # 2171
"RTN","MAGNUTL2",121,0)
 ;
"RTN","MAGNUTL2",122,0)
 S CRTUSR=DUZ  ; CREATED BY
"RTN","MAGNUTL2",123,0)
 ;
"RTN","MAGNUTL2",124,0)
 S CRTAPP="PRECACHE"
"RTN","MAGNUTL2",125,0)
 ;
"RTN","MAGNUTL2",126,0)
 D CRTITEM^MAGVIM01(.MAGOUT,TYPE,SUBTYPE,STATUS,PLACEID,PRIORITY,.MSGTAGS,CRTUSR,CRTAPP)
"RTN","MAGNUTL2",127,0)
 Q
"RTN","MAGNUTL2",128,0)
 ;
"RTN","MAGNUTL2",129,0)
GCPRSID(RARPT) ; return SITE, ICN, CPRSContextID
"RTN","MAGNUTL2",130,0)
 N DFN,ICN,MAGCTXID,PLACEID
"RTN","MAGNUTL2",131,0)
 ;
"RTN","MAGNUTL2",132,0)
 S MAGCTXID=$$RACPRS^MAGNU003(RARPT) ; Radiology CPRS context
"RTN","MAGNUTL2",133,0)
 I MAGCTXID="" Q ""
"RTN","MAGNUTL2",134,0)
 S DFN=$$GET1^DIQ(74,RARPT,2,"I")
"RTN","MAGNUTL2",135,0)
 ;
"RTN","MAGNUTL2",136,0)
 S PLACEID=$$STA^XUAF4(DUZ(2)) ;IA # 2171
"RTN","MAGNUTL2",137,0)
 ;
"RTN","MAGNUTL2",138,0)
 S ICN=""
"RTN","MAGNUTL2",139,0)
 S:$L($T(GETICN^MPIF001)) ICN=$$GETICN^MPIF001(DFN)
"RTN","MAGNUTL2",140,0)
 Q PLACEID_"^"_DFN_"^"_ICN_"^"_$TR(MAGCTXID,"^","~")
"RTN","MAGNVQ04")
0^7^B30558931
"RTN","MAGNVQ04",1,0)
MAGNVQ04 ;WOIFO/NST - List images for a patient ; OCT 17, 2018@3:59 PM
"RTN","MAGNVQ04",2,0)
 ;;3.0;IMAGING;**185,221**;Mar 19, 2002;Build 4525;May 01, 2013
"RTN","MAGNVQ04",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNVQ04",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ04",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNVQ04",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNVQ04",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNVQ04",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNVQ04",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNVQ04",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNVQ04",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNVQ04",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNVQ04",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNVQ04",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNVQ04",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNVQ04",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ04",17,0)
 ;;
"RTN","MAGNVQ04",18,0)
 Q
"RTN","MAGNVQ04",19,0)
 ;
"RTN","MAGNVQ04",20,0)
 ;*****  List Images by Patient
"RTN","MAGNVQ04",21,0)
 ;       
"RTN","MAGNVQ04",22,0)
 ; RPC: MAGN PATIENT IMAGE LIST
"RTN","MAGNVQ04",23,0)
 ; 
"RTN","MAGNVQ04",24,0)
 ; Input Parameters
"RTN","MAGNVQ04",25,0)
 ; ================
"RTN","MAGNVQ04",26,0)
 ; 
"RTN","MAGNVQ04",27,0)
 ; IDTYPE = "DFN"or "ICN"
"RTN","MAGNVQ04",28,0)
 ; ID     = Patient ID  
"RTN","MAGNVQ04",29,0)
 ; [IMGLESS]  flag to speed up queries: if=1 (true), just get study-level data
"RTN","MAGNVQ04",30,0)
 ; [FLAGS]  for feature use
"RTN","MAGNVQ04",31,0)
 ; [FROMDATE],[TODATE],[MISCPRMS] - see GETIMGS^MAGSIXG1 for discription
"RTN","MAGNVQ04",32,0)
 ;           
"RTN","MAGNVQ04",33,0)
 ; Return Values
"RTN","MAGNVQ04",34,0)
 ; =============
"RTN","MAGNVQ04",35,0)
 ; 
"RTN","MAGNVQ04",36,0)
 ; if error MAGRY(0) = 0 ^Error message^
"RTN","MAGNVQ04",37,0)
 ; if success MAGRY(0) = 1
"RTN","MAGNVQ04",38,0)
 ;            MAGRY(1..n) = images in format defined in RPC [MAGN CPRS IMAGE LIST]
"RTN","MAGNVQ04",39,0)
 ;
"RTN","MAGNVQ04",40,0)
IMAGEL(MAGRY,IDTYPE,ID,IMGLESS,FLAGS,FROMDATE,TODATE,MISCPRMS) ;RPC [MAGN PATIENT IMAGE LIST]
"RTN","MAGNVQ04",41,0)
 N DFN,MAGRY2005,MAGRYP34,MAGDATA,ERROR,FOUND
"RTN","MAGNVQ04",42,0)
 ;
"RTN","MAGNVQ04",43,0)
 N $ETRAP,$ESTACK S $ETRAP="D AERRA^MAGGTERR"
"RTN","MAGNVQ04",44,0)
 D CLEAR^MAGUERR(1)
"RTN","MAGNVQ04",45,0)
 S IMGLESS=$S($D(IMGLESS):+IMGLESS,1:1)  ; Default is IMAGELESS
"RTN","MAGNVQ04",46,0)
 S FLAGS=$G(FLAGS)
"RTN","MAGNVQ04",47,0)
 ;
"RTN","MAGNVQ04",48,0)
 S MAGRY=$NA(^TMP("MAGNVQ04",$J))
"RTN","MAGNVQ04",49,0)
 K @MAGRY
"RTN","MAGNVQ04",50,0)
 S @MAGRY@(0)=0
"RTN","MAGNVQ04",51,0)
 S IDTYPE=$G(IDTYPE)
"RTN","MAGNVQ04",52,0)
 I (IDTYPE'="DFN")&(IDTYPE'="ICN") S @MAGRY@(0)="0^Invalid IDTYPE "_IDTYPE Q
"RTN","MAGNVQ04",53,0)
 ;
"RTN","MAGNVQ04",54,0)
 I IDTYPE="DFN" D  I DFN'>0 S @MAGRY@(0)="0^Invalid patient ID: "_DFN Q
"RTN","MAGNVQ04",55,0)
 . S DFN=$G(ID)
"RTN","MAGNVQ04",56,0)
 . Q
"RTN","MAGNVQ04",57,0)
 I IDTYPE="ICN" D  I DFN'>0 S @MAGRY@(0)="0^Error: "_DFN Q
"RTN","MAGNVQ04",58,0)
 . S DFN=$S($T(GETDFN^MPIF001)'="":$$GETDFN^MPIF001(ID),1:"-1^NO MPI") ; Supported IA (#2701)
"RTN","MAGNVQ04",59,0)
 . Q
"RTN","MAGNVQ04",60,0)
 ;
"RTN","MAGNVQ04",61,0)
 S FLAGS=$S($G(FLAGS)="":"E",1:FLAGS)
"RTN","MAGNVQ04",62,0)
 ;
"RTN","MAGNVQ04",63,0)
 I DFN'>0 S @MAGRY@(0)="0^Invalid patient ID: "_DFN Q
"RTN","MAGNVQ04",64,0)
 ;
"RTN","MAGNVQ04",65,0)
 S I=""
"RTN","MAGNVQ04",66,0)
 S FOUND=0
"RTN","MAGNVQ04",67,0)
 F  S I=$O(MISCPRMS(I)) Q:FOUND!'I  I $P(MISCPRMS(I),"^")="IDFN" S FOUND=I
"RTN","MAGNVQ04",68,0)
 I 'FOUND D
"RTN","MAGNVQ04",69,0)
 . S I=$O(MISCPRMS(""),-1)+1  ; set next parameter counter
"RTN","MAGNVQ04",70,0)
 . S MISCPRMS(I)="IDFN^^"_DFN
"RTN","MAGNVQ04",71,0)
 . Q
"RTN","MAGNVQ04",72,0)
 ;
"RTN","MAGNVQ04",73,0)
 ;=== Validate parameters
"RTN","MAGNVQ04",74,0)
 S ERROR=$$VALPARAM^MAGSIXG1(.MAGDATA,FLAGS,.FROMDATE,.TODATE,"",.MISCPRMS)
"RTN","MAGNVQ04",75,0)
 ;
"RTN","MAGNVQ04",76,0)
 ;--- Check for errors
"RTN","MAGNVQ04",77,0)
 I ERROR D ERROR^MAGUERR(-30),ERRORS^MAGSIXG1(.MAGRY) Q
"RTN","MAGNVQ04",78,0)
 ;
"RTN","MAGNVQ04",79,0)
 D IMG2005(MAGRY,DFN,IMGLESS,FLAGS,FROMDATE,TODATE,.MAGDATA) ; Get #2005 images 
"RTN","MAGNVQ04",80,0)
 ;
"RTN","MAGNVQ04",81,0)
 D IMAGEP34(MAGRY,DFN,IMGLESS,FLAGS,FROMDATE,TODATE,.MAGDATA)  ; Get P34 images
"RTN","MAGNVQ04",82,0)
 ;
"RTN","MAGNVQ04",83,0)
 S @MAGRY@(0)=1
"RTN","MAGNVQ04",84,0)
 Q
"RTN","MAGNVQ04",85,0)
 ;
"RTN","MAGNVQ04",86,0)
IMG2005(MAGRYOUT,DFN,IMGLESS,FLAGS,FROMDATE,TODATE,MAGDATA) ; Get images from #2005
"RTN","MAGNVQ04",87,0)
 ; DFN     = Patient DFN
"RTN","MAGNVQ04",88,0)
 ; IMGLESS = 0|1 Include images
"RTN","MAGNVQ04",89,0)
 ; [FLAGS] = for feature use
"RTN","MAGNVQ04",90,0)
 ;
"RTN","MAGNVQ04",91,0)
 N I,IMAGE,GROUPS,OUT,QF,RC,TMP
"RTN","MAGNVQ04",92,0)
 ;
"RTN","MAGNVQ04",93,0)
 ;=== Query the image file(s)
"RTN","MAGNVQ04",94,0)
 S MAGDATA("FLAGS")=FLAGS,MAGDATA("MAXNUM")=""
"RTN","MAGNVQ04",95,0)
 S TMP=$S(TODATE<9999999:$$FMADD^XLFDT(TODATE,1),1:TODATE)
"RTN","MAGNVQ04",96,0)
 S QF=$$TRFLAGS^MAGUTL05(FLAGS,"CDEG")
"RTN","MAGNVQ04",97,0)
 ;
"RTN","MAGNVQ04",98,0)
 K ^TMP("MAGNVQ07",$J,"QRY2005")
"RTN","MAGNVQ04",99,0)
 S RC=$$QUERY^MAGGI13("$$QRY2005^MAGNVQ07",QF,.MAGDATA,FROMDATE,TMP,DFN)
"RTN","MAGNVQ04",100,0)
 I RC<0 D  Q
"RTN","MAGNVQ04",101,0)
 . D ERRORS^MAGSIXG1(.OUT,RC)
"RTN","MAGNVQ04",102,0)
 . M @MAGRYOUT=OUT
"RTN","MAGNVQ04",103,0)
 . Q
"RTN","MAGNVQ04",104,0)
 ;
"RTN","MAGNVQ04",105,0)
 K ^TMP("MAGNVQ07",$J,"QRY2005",0)  ; remove the counter
"RTN","MAGNVQ04",106,0)
 M GROUPS=^TMP("MAGNVQ07",$J,"QRY2005")
"RTN","MAGNVQ04",107,0)
 K ^TMP("MAGNVQ07",$J,"QRY2005")
"RTN","MAGNVQ04",108,0)
 D STUDY2^MAGDQR21(.OUT,.GROUPS,DFN,IMGLESS)  ; MAG DOD GET STUDIES IEN
"RTN","MAGNVQ04",109,0)
 ;
"RTN","MAGNVQ04",110,0)
 D UPD2005(MAGRYOUT,.OUT,IMGLESS)
"RTN","MAGNVQ04",111,0)
 S MAGRYOUT=OUT
"RTN","MAGNVQ04",112,0)
 S @MAGRYOUT@(0)=1
"RTN","MAGNVQ04",113,0)
 Q
"RTN","MAGNVQ04",114,0)
 ;
"RTN","MAGNVQ04",115,0)
UPD2005(MAGOUT,MAGIN,IMGLESS) ; Add Additional study information
"RTN","MAGNVQ04",116,0)
 N MAGI,IMGIEN,MAGNCNT,MAGSTUDY
"RTN","MAGNVQ04",117,0)
 S MAGNCNT=0
"RTN","MAGNVQ04",118,0)
 S MAGI=1 ; start from line number 2. Line number 1 is a records count
"RTN","MAGNVQ04",119,0)
 F  S MAGI=$O(@MAGIN@(MAGI)) Q:'MAGI  D
"RTN","MAGNVQ04",120,0)
 . S MAGNCNT=MAGNCNT+1
"RTN","MAGNVQ04",121,0)
 . S @MAGOUT@(MAGNCNT)=@MAGIN@(MAGI)
"RTN","MAGNVQ04",122,0)
 . I $P(@MAGIN@(MAGI),"|")="STUDY_IEN" D   ; Add STUDY_INFO. Better place will be MAGDQR21
"RTN","MAGNVQ04",123,0)
 . . S MAGNCNT=MAGNCNT+1
"RTN","MAGNVQ04",124,0)
 . . S IMGIEN=$P(@MAGIN@(MAGI),"|",2)  ; IEN of the group
"RTN","MAGNVQ04",125,0)
 . . S @MAGOUT@(MAGNCNT)="STUDY_INFO|"_$$STDINFO(IMGIEN)
"RTN","MAGNVQ04",126,0)
 . . S MAGSTUDY=@MAGIN@(MAGI)
"RTN","MAGNVQ04",127,0)
 . . Q
"RTN","MAGNVQ04",128,0)
 . I IMGLESS,($P(@MAGIN@(MAGI),"|")="STUDY_PAT") D INSFIMG^MAGNU003(MAGSTUDY,.MAGNCNT,MAGOUT)  ; Append First Image Info
"RTN","MAGNVQ04",129,0)
 . Q
"RTN","MAGNVQ04",130,0)
 Q
"RTN","MAGNVQ04",131,0)
 ;
"RTN","MAGNVQ04",132,0)
IMAGEP34(MAGRY,DFN,IMGLESS,FLAGS,FROMDATE,TODATE,MAGDATA) ; Get P34 images
"RTN","MAGNVQ04",133,0)
 ; DFN     = Patient DFN
"RTN","MAGNVQ04",134,0)
 ; IMGLESS = 0|1 Include images
"RTN","MAGNVQ04",135,0)
 ; [FLAGS] = for feature use
"RTN","MAGNVQ04",136,0)
 ;
"RTN","MAGNVQ04",137,0)
 N IARRAY
"RTN","MAGNVQ04",138,0)
 S MAGDATA("FLAGS")=FLAGS,MAGDATA("MAXNUM")=""
"RTN","MAGNVQ04",139,0)
 S TMP=$S(TODATE<9999999:$$FMADD^XLFDT(TODATE,1),1:TODATE)
"RTN","MAGNVQ04",140,0)
 D PATIMG34^MAGNVQ05(.IARRAY,DFN,IMGLESS,FROMDATE,TODATE,.MAGDATA)  ; Get patient images
"RTN","MAGNVQ04",141,0)
 ;
"RTN","MAGNVQ04",142,0)
 D GETSTUDY^MAGNVQ01(MAGRY,.IARRAY,"","","") ; Get Study by graph ien
"RTN","MAGNVQ04",143,0)
 Q
"RTN","MAGNVQ04",144,0)
 ;
"RTN","MAGNVQ04",145,0)
STDINFO(IMGIEN)  ; Get Study Info by IEN in IMAGE file (#2005)
"RTN","MAGNVQ04",146,0)
 N IMGNODE,X2,PFILE,REFTYPE,REFIEN
"RTN","MAGNVQ04",147,0)
 ;
"RTN","MAGNVQ04",148,0)
 S IMGNODE=$$NODE^MAGGI11(IMGIEN)
"RTN","MAGNVQ04",149,0)
 Q:IMGNODE="" ""
"RTN","MAGNVQ04",150,0)
 ;
"RTN","MAGNVQ04",151,0)
 S X2=$G(@IMGNODE@(2))
"RTN","MAGNVQ04",152,0)
 ;
"RTN","MAGNVQ04",153,0)
 S PFILE=$P(X2,U,6)  ; PARENT DATA FILE# 
"RTN","MAGNVQ04",154,0)
 S REFTYPE=$$GET1^DIQ(2005.03,PFILE,.02)
"RTN","MAGNVQ04",155,0)
 ;
"RTN","MAGNVQ04",156,0)
 S REFIEN=$P(X2,U,7) ;PARENT GLOBAL ROOT D0
"RTN","MAGNVQ04",157,0)
 ;
"RTN","MAGNVQ04",158,0)
 Q $$STDINFO^MAGNU003(IMGIEN,REFTYPE,REFIEN,"")
"RTN","MAGNVQ05")
0^8^B35641804
"RTN","MAGNVQ05",1,0)
MAGNVQ05 ;WOIFO/NST - List images for a patient ; OCT 18, Sep 2017 3:59 PM
"RTN","MAGNVQ05",2,0)
 ;;3.0;IMAGING;**185,221**;Mar 19, 2002;Build 4525;May 01, 2013
"RTN","MAGNVQ05",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNVQ05",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ05",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNVQ05",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNVQ05",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNVQ05",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNVQ05",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNVQ05",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNVQ05",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNVQ05",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNVQ05",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNVQ05",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNVQ05",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNVQ05",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ05",17,0)
 ;;
"RTN","MAGNVQ05",18,0)
 Q
"RTN","MAGNVQ05",19,0)
 ;
"RTN","MAGNVQ05",20,0)
QUERY34(IARRAY,DFN,IMGLESS,FROMDATE,TODATE,MAGDATA) ; Query P34 database
"RTN","MAGNVQ05",21,0)
 I DFN D PATIMG34(.IARRAY,DFN,IMGLESS,FROMDATE,TODATE,.MAGDATA) Q
"RTN","MAGNVQ05",22,0)
 ;
"RTN","MAGNVQ05",23,0)
 D STUDYQRY(.IARRAY,IMGLESS,FROMDATE,TODATE,.MAGDATA) ; Get images from P34 database by Study query
"RTN","MAGNVQ05",24,0)
 Q
"RTN","MAGNVQ05",25,0)
 ;
"RTN","MAGNVQ05",26,0)
PATIMG34(IARRAY,DFN,IMGLESS,FROMDATE,TODATE,MAGDATA) ; Get images from P34 database by Patient
"RTN","MAGNVQ05",27,0)
 ; IARRAY  = Output array with patient images
"RTN","MAGNVQ05",28,0)
 ; DFN     = Patient DFN
"RTN","MAGNVQ05",29,0)
 ; IMGLESS = 0|1 Include images
"RTN","MAGNVQ05",30,0)
 ; FROMDATE,TODATE = Capture date range of images 
"RTN","MAGNVQ05",31,0)
 ; .MAGDATA = Filters
"RTN","MAGNVQ05",32,0)
 ;
"RTN","MAGNVQ05",33,0)
 N PATIX,PROCIX,STYIX,SERIX,SOPIX,IMAGE,MAGCAPDT
"RTN","MAGNVQ05",34,0)
 N ACTVIMG,CLASS,CPTCODE,EVT,FOUND,PROC,SPEC,PKG,ORIG,TYPE,TMP
"RTN","MAGNVQ05",35,0)
 ;
"RTN","MAGNVQ05",36,0)
 S PATIX=""
"RTN","MAGNVQ05",37,0)
 F  S PATIX=$O(^MAGV(2005.6,"C",DFN,PATIX)) Q:'PATIX  D
"RTN","MAGNVQ05",38,0)
 . S PROCIX=""
"RTN","MAGNVQ05",39,0)
 . F  S PROCIX=$O(^MAGV(2005.61,"C",PATIX,PROCIX)) Q:'PROCIX  D
"RTN","MAGNVQ05",40,0)
 . . S TMP=$G(^MAGV(2005.61,PROCIX,0))
"RTN","MAGNVQ05",41,0)
 . . Q:$P(TMP,"^",5)'="A"  ; not active
"RTN","MAGNVQ05",42,0)
 . . I $D(MAGDATA("CPTCODE")) D  Q:'FOUND   ; CPT Code doesn't match
"RTN","MAGNVQ05",43,0)
 . . . S CPTCODE=""
"RTN","MAGNVQ05",44,0)
 . . . S ACCNUM=$P(TMP,"^",1)    ; Accession number
"RTN","MAGNVQ05",45,0)
 . . . S PROCTYPE=$P(TMP,"^",3)  ; Procedure Type
"RTN","MAGNVQ05",46,0)
 . . . S CPTCODE=$$CPTCODE(ACCNUM,PROCTYPE)
"RTN","MAGNVQ05",47,0)
 . . . S FOUND=$S(CPTCODE="":0,1:$D(MAGDATA("CPTCODE",CPTCODE)))
"RTN","MAGNVQ05",48,0)
 . . . Q
"RTN","MAGNVQ05",49,0)
 . . S STYIX=""
"RTN","MAGNVQ05",50,0)
 . . F  S STYIX=$O(^MAGV(2005.62,"C",PROCIX,STYIX)) Q:'STYIX  D
"RTN","MAGNVQ05",51,0)
 . . . Q:$P($G(^MAGV(2005.62,STYIX,5)),"^",2)="I"  ; study marked inaccessible
"RTN","MAGNVQ05",52,0)
 . . . S MAGCAPDT=$P($G(^MAGV(2005.62,STYIX,2)),"^",1)  ; study date time
"RTN","MAGNVQ05",53,0)
 . . . Q:(MAGCAPDT<FROMDATE)!(MAGCAPDT>TODATE)          ; study out of date range
"RTN","MAGNVQ05",54,0)
 . . . Q:'$$FLTRSTUD(STYIX,.MAGDATA)  ; Filter on study level
"RTN","MAGNVQ05",55,0)
 . . . S SERIX=""
"RTN","MAGNVQ05",56,0)
 . . . F  S SERIX=$O(^MAGV(2005.63,"C",STYIX,SERIX)) Q:'SERIX  D
"RTN","MAGNVQ05",57,0)
 . . . . Q:'$$FLTRSER(SERIX,.MAGDATA)  ; Filter on series level
"RTN","MAGNVQ05",58,0)
 . . . . ;
"RTN","MAGNVQ05",59,0)
 . . . . S ACTVIMG=0
"RTN","MAGNVQ05",60,0)
 . . . . S SOPIX=""
"RTN","MAGNVQ05",61,0)
 . . . . F  S SOPIX=$O(^MAGV(2005.64,"C",SERIX,SOPIX)) Q:'SOPIX  D  Q:IMGLESS&ACTVIMG
"RTN","MAGNVQ05",62,0)
 . . . . . I $D(MAGDATA("TYPE")) S TYPE=$P($G(^MAGV(2005.64,SOPIX,5)),"^",1) Q:TYPE=""  Q:'$D(MAGDATA("TYPE",TYPE))  ; Type Index
"RTN","MAGNVQ05",63,0)
 . . . . . S IMAGE=""
"RTN","MAGNVQ05",64,0)
 . . . . . F  S IMAGE=$O(^MAGV(2005.65,"C",SOPIX,IMAGE)) Q:'IMAGE  D
"RTN","MAGNVQ05",65,0)
 . . . . . . I $P($G(^MAGV(2005.65,IMAGE,1)),"^",5)'="I" D
"RTN","MAGNVQ05",66,0)
 . . . . . . . S IARRAY(STYIX,SERIX,SOPIX,IMAGE)="",ACTVIMG=1
"RTN","MAGNVQ05",67,0)
 . . . . . . . Q
"RTN","MAGNVQ05",68,0)
 . . . . . . Q
"RTN","MAGNVQ05",69,0)
 . . . . . Q
"RTN","MAGNVQ05",70,0)
 . . . . Q
"RTN","MAGNVQ05",71,0)
 . . . Q
"RTN","MAGNVQ05",72,0)
 . . Q
"RTN","MAGNVQ05",73,0)
 . Q
"RTN","MAGNVQ05",74,0)
 Q
"RTN","MAGNVQ05",75,0)
 ;
"RTN","MAGNVQ05",76,0)
CPTCODE(ACCNUM,PROCTYPE) ; Get CPT by Accession number
"RTN","MAGNVQ05",77,0)
 N OSEP,ISEP,SSEP,OUT,CPTCODE,I,FOUNDC,FOUNDT
"RTN","MAGNVQ05",78,0)
 I PROCTYPE'="RAD" Q ""
"RTN","MAGNVQ05",79,0)
 S OSEP=$$OUTSEP^MAGVRS41,ISEP=$$INPUTSEP^MAGVRS41,SSEP=$$STATSEP^MAGVRS41
"RTN","MAGNVQ05",80,0)
 D GETRPROC^MAGVRS81(.OUT,ACCNUM)  ; Get radiology exam details
"RTN","MAGNVQ05",81,0)
 S (FOUNDC,FOUNDT)=0
"RTN","MAGNVQ05",82,0)
 S CPTCODE=""
"RTN","MAGNVQ05",83,0)
 S I=""
"RTN","MAGNVQ05",84,0)
 F  S I=$O(OUT(I)) Q:(FOUNDC&FOUNDT)!'I  D
"RTN","MAGNVQ05",85,0)
 . I $P(OUT(I),OSEP,1)="PROCEDURE CODE" S CPTCODE=$P($P(OUT(I),OSEP,2),SSEP),FOUNDC=1 Q
"RTN","MAGNVQ05",86,0)
 . I ($P(OUT(I),OSEP,1)="TERMINOLOGY"),($P($P(OUT(I),OSEP,2),SSEP)="CPT") S FOUNDT=1 Q
"RTN","MAGNVQ05",87,0)
 . Q
"RTN","MAGNVQ05",88,0)
 Q CPTCODE
"RTN","MAGNVQ05",89,0)
 ;
"RTN","MAGNVQ05",90,0)
FLTRSER(SERIX,MAGDATA) ; Filter on Series level
"RTN","MAGNVQ05",91,0)
 N CLASS,MODALITY,PROC,SPEC,TMP
"RTN","MAGNVQ05",92,0)
 ;
"RTN","MAGNVQ05",93,0)
 I $D(MAGDATA("MODALITY")) S MODALITY=$P($G(^MAGV(2005.63,SERIX,1)),"^") Q:MODALITY="" 0 Q:'$D(MAGDATA("MODALITY",MODALITY)) 0
"RTN","MAGNVQ05",94,0)
 ;
"RTN","MAGNVQ05",95,0)
 S TMP=$G(^MAGV(2005.63,SERIX,10))
"RTN","MAGNVQ05",96,0)
 I $D(MAGDATA("CLS")) S CLASS=$P(TMP,"^",1) Q:CLASS="" 0 Q:'$D(MAGDATA("CLS",CLASS)) 0 ; CLASS INDEX
"RTN","MAGNVQ05",97,0)
 I $D(MAGDATA("PROC")) S PROC=$P(TMP,"^",2) Q:PROC="" 0 Q:'$D(MAGDATA("PROC",PROC)) 0 ; PROC/EVENT INDEX
"RTN","MAGNVQ05",98,0)
 I $D(MAGDATA("SPEC")) S SPEC=$P(TMP,"^",2) Q:SPEC="" 0 Q:'$D(MAGDATA("SPEC",SPEC)) 0 ; SPEC/SUBSPEC INDEX
"RTN","MAGNVQ05",99,0)
 Q 1
"RTN","MAGNVQ05",100,0)
 ;
"RTN","MAGNVQ05",101,0)
FLTRSTUD(STYIX,MAGDATA)  ; Filter on Study level
"RTN","MAGNVQ05",102,0)
 N TMP,ORIG,PKG
"RTN","MAGNVQ05",103,0)
 S TMP=$G(^MAGV(2005.62,STYIX,3))
"RTN","MAGNVQ05",104,0)
 I $D(MAGDATA("GDESC")) Q:$$UP^XLFSTR($P(TMP,U,1))'[MAGDATA("GDESC") 0   ; Short description
"RTN","MAGNVQ05",105,0)
 I $D(MAGDATA("ORIG")) S ORIG=$P(TMP,"^",2) Q:ORIG="" 0 Q:'$D(MAGDATA("ORIG",ORIG)) 0  ; Origin Index
"RTN","MAGNVQ05",106,0)
 I $D(MAGDATA("PKG")) S PKG=$$GET1^DIQ(2005.62,STYIX,"11:40","I") Q:PKG="" 0 Q:'$D(MAGDATA("PKG",PKG)) 0
"RTN","MAGNVQ05",107,0)
 Q 1
"RTN","MAGNVQ05",108,0)
 ;
"RTN","MAGNVQ05",109,0)
STUDYQRY(IARRAY,IMGLESS,FROMDATE,TODATE,MAGDATA) ; Get images from P34 database by Study query
"RTN","MAGNVQ05",110,0)
 ; IARRAY  = Output array with patient images
"RTN","MAGNVQ05",111,0)
 ; IMGLESS = 0|1 Include images
"RTN","MAGNVQ05",112,0)
 ; FROMDATE,TODATE = Capture date range of images 
"RTN","MAGNVQ05",113,0)
 ; .MAGDATA = Filters
"RTN","MAGNVQ05",114,0)
 N ACTVIMG,DATEIX,IMAGE,STYIX,SERIX,SOPIX,TYPE
"RTN","MAGNVQ05",115,0)
 ;
"RTN","MAGNVQ05",116,0)
 S DATEIX=FROMDATE-1
"RTN","MAGNVQ05",117,0)
 F  S DATEIX=$O(^MAGV(2005.62,"J",DATEIX)) Q:'DATEIX!(DATEIX>TODATE)  D
"RTN","MAGNVQ05",118,0)
 . S STYIX=""
"RTN","MAGNVQ05",119,0)
 . F  S STYIX=$O(^MAGV(2005.62,"J",DATEIX,STYIX)) Q:'STYIX  D
"RTN","MAGNVQ05",120,0)
 . . Q:$P($G(^MAGV(2005.62,STYIX,5)),"^",2)="I"  ; study marked inaccessible
"RTN","MAGNVQ05",121,0)
 . . Q:'$$FLTRSTUD(STYIX,.MAGDATA)  ; Filter on study level
"RTN","MAGNVQ05",122,0)
 . . S SERIX=""
"RTN","MAGNVQ05",123,0)
 . . F  S SERIX=$O(^MAGV(2005.63,"C",STYIX,SERIX)) Q:'SERIX  D
"RTN","MAGNVQ05",124,0)
 . . . Q:'$$FLTRSER(SERIX,.MAGDATA)  ; Filter on series level
"RTN","MAGNVQ05",125,0)
 . . . ;
"RTN","MAGNVQ05",126,0)
 . . . S ACTVIMG=0
"RTN","MAGNVQ05",127,0)
 . . . S SOPIX=""
"RTN","MAGNVQ05",128,0)
 . . . F  S SOPIX=$O(^MAGV(2005.64,"C",SERIX,SOPIX)) Q:'SOPIX  D  Q:IMGLESS&ACTVIMG
"RTN","MAGNVQ05",129,0)
 . . . . I $D(MAGDATA("TYPE")) S TYPE=$P($G(^MAGV(2005.64,SOPIX,5)),"^",1) Q:TYPE=""  Q:'$D(MAGDATA("TYPE",TYPE))  ; Type Index
"RTN","MAGNVQ05",130,0)
 . . . . S IMAGE=""
"RTN","MAGNVQ05",131,0)
 . . . . F  S IMAGE=$O(^MAGV(2005.65,"C",SOPIX,IMAGE)) Q:'IMAGE  D
"RTN","MAGNVQ05",132,0)
 . . . . . I $P($G(^MAGV(2005.65,IMAGE,1)),"^",5)'="I" D
"RTN","MAGNVQ05",133,0)
 . . . . . . S IARRAY(STYIX,SERIX,SOPIX,IMAGE)="",ACTVIMG=1
"RTN","MAGNVQ05",134,0)
 . . . . . . Q
"RTN","MAGNVQ05",135,0)
 . . . . . Q
"RTN","MAGNVQ05",136,0)
 . . . . Q
"RTN","MAGNVQ05",137,0)
 . . . Q
"RTN","MAGNVQ05",138,0)
 . . Q
"RTN","MAGNVQ05",139,0)
 . Q
"RTN","MAGNVQ05",140,0)
 Q
"RTN","MAGNVQ07")
0^9^B5002623
"RTN","MAGNVQ07",1,0)
MAGNVQ07 ;WOIFO/NST - List images for a patient ; NOV 20, 2018@3:59 PM
"RTN","MAGNVQ07",2,0)
 ;;3.0;IMAGING;**221**;Mar 19, 2002;Build 4525;May 01, 2013
"RTN","MAGNVQ07",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNVQ07",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ07",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNVQ07",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNVQ07",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNVQ07",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNVQ07",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNVQ07",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNVQ07",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNVQ07",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNVQ07",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNVQ07",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNVQ07",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNVQ07",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNVQ07",17,0)
 ;;
"RTN","MAGNVQ07",18,0)
 Q
"RTN","MAGNVQ07",19,0)
 ;+++++ CALLBACK FUNCTION FOR IMAGE QUERY
"RTN","MAGNVQ07",20,0)
 ;
"RTN","MAGNVQ07",21,0)
 ; IMGIEN        IEN of the image record (file #2005 or #2005.1)
"RTN","MAGNVQ07",22,0)
 ;
"RTN","MAGNVQ07",23,0)
 ; FLAGS         Parameters passed into the image query API
"RTN","MAGNVQ07",24,0)
 ; .MAGDATA      ($$QUERY^MAGGI13). See the GETIMGS^MAGSIXG1 
"RTN","MAGNVQ07",25,0)
 ;               for details.
"RTN","MAGNVQ07",26,0)
QRY2005(IMGIEN,FLAGS,MAGDATA) ; 
"RTN","MAGNVQ07",27,0)
 N CNT,FLTX,GRPCNTS,PTIEN,RC
"RTN","MAGNVQ07",28,0)
 ; 
"RTN","MAGNVQ07",29,0)
 S RC=$$FILTER^MAGSIXG3(.FLTX,.GRPCNTS,.PTIEN,IMGIEN,FLAGS,.MAGDATA) ; Apply filter 
"RTN","MAGNVQ07",30,0)
 Q:'RC 0  ; Check filter
"RTN","MAGNVQ07",31,0)
 ;
"RTN","MAGNVQ07",32,0)
 Q:RC=2 1  ; Terminate the query when maximum number of records is reached
"RTN","MAGNVQ07",33,0)
 ;
"RTN","MAGNVQ07",34,0)
 ;=== Append the image item to the result array
"RTN","MAGNVQ07",35,0)
 S ^TMP("MAGNVQ07",$J,"QRY2005",0)=$G(^TMP("MAGNVQ07",$J,"QRY2005",0))+1
"RTN","MAGNVQ07",36,0)
 S ^TMP("MAGNVQ07",$J,"QRY2005",^TMP("MAGNVQ07",$J,"QRY2005",0))=IMGIEN
"RTN","MAGNVQ07",37,0)
 ;
"RTN","MAGNVQ07",38,0)
 ;=== Success
"RTN","MAGNVQ07",39,0)
 Q 0
"RTN","MAGNWRK1")
0^10^B53919420
"RTN","MAGNWRK1",1,0)
MAGNWRK1 ;WOIFO/NST - Work items calls ; Dec 05, 2018@13:36:00
"RTN","MAGNWRK1",2,0)
 ;;3.0;IMAGING;**201,221**;Dec 02, 2009;Build 163
"RTN","MAGNWRK1",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGNWRK1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNWRK1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGNWRK1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGNWRK1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGNWRK1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGNWRK1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGNWRK1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGNWRK1",11,0)
 ;; |                                                               |
"RTN","MAGNWRK1",12,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGNWRK1",13,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGNWRK1",14,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGNWRK1",15,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGNWRK1",16,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGNWRK1",17,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGNWRK1",18,0)
 ;;
"RTN","MAGNWRK1",19,0)
 Q
"RTN","MAGNWRK1",20,0)
 ;
"RTN","MAGNWRK1",21,0)
NWI2005(MAGVOUT,MAGGDA)  ;Create a new MAG WORK ITEM for an image stored in IMAGE file (#2005)
"RTN","MAGNWRK1",22,0)
 ; MAGGDA - IEN in IMAGE file (#2005)
"RTN","MAGNWRK1",23,0)
 ;
"RTN","MAGNWRK1",24,0)
 ;
"RTN","MAGNWRK1",25,0)
 N CRTUSR,CRTAPP,DFN,ICN,IEN,J,MAGGRP,MSGTAGS,TYPE,SUBTYPE,STATUS,PLACEID,PRIORITY,Y,TMP
"RTN","MAGNWRK1",26,0)
 N MODALITY,MAGPDATA,REFTYPE,REFIEN
"RTN","MAGNWRK1",27,0)
 ;
"RTN","MAGNWRK1",28,0)
 S IEN=+$G(MAGGDA) Q:'IEN
"RTN","MAGNWRK1",29,0)
 ;
"RTN","MAGNWRK1",30,0)
 S PLACEID=$$GET1^DIQ(2005,IEN,.05,"I")  ; ACQUISITION SITE
"RTN","MAGNWRK1",31,0)
 S:'PLACEID PLACEID=DUZ(2)
"RTN","MAGNWRK1",32,0)
 ;
"RTN","MAGNWRK1",33,0)
 Q:'$$GET^XPAR("DIV.`"_PLACEID_"^SYS","MAG PRECACHE ACQ ENABLED",,"I")  ; IA# 2263 
"RTN","MAGNWRK1",34,0)
 ;
"RTN","MAGNWRK1",35,0)
 Q:$$GET1^DIQ(2005,IEN,1,"I")=""       ; FILEREF
"RTN","MAGNWRK1",36,0)
 S DFN=$$GET1^DIQ(2005,IEN,5,"I")      ; PATIENT
"RTN","MAGNWRK1",37,0)
 S MAGGRP=$$GET1^DIQ(2005,IEN,14,"I")  ; GROUP PARENT
"RTN","MAGNWRK1",38,0)
 ;
"RTN","MAGNWRK1",39,0)
 ; TAGS
"RTN","MAGNWRK1",40,0)
 S J=0
"RTN","MAGNWRK1",41,0)
 S J=J+1,MSGTAGS(J)="storage`2005"  ; image is in file #2005
"RTN","MAGNWRK1",42,0)
 S J=J+1,MSGTAGS(J)="imageIen`"_IEN  ; IMAGE IEN
"RTN","MAGNWRK1",43,0)
 S:MAGGRP J=J+1,MSGTAGS(J)="studyIen`"_MAGGRP   ; GRP IEN
"RTN","MAGNWRK1",44,0)
 S:DFN J=J+1,MSGTAGS(J)="patientDfn`"_DFN
"RTN","MAGNWRK1",45,0)
 I $L($T(GETICN^MPIF001)) D
"RTN","MAGNWRK1",46,0)
 . S ICN=$$GETICN^MPIF001(DFN)
"RTN","MAGNWRK1",47,0)
 . S:ICN>1 J=J+1,MSGTAGS(J)="patientIcn`"_ICN
"RTN","MAGNWRK1",48,0)
 . Q
"RTN","MAGNWRK1",49,0)
 S J=J+1,MSGTAGS(J)="acquisition`1"     ; precash flag
"RTN","MAGNWRK1",50,0)
 ;
"RTN","MAGNWRK1",51,0)
 S MAGPDATA=$$GET1^DIQ(2005,IEN,16,"I")  ; Parent Data File
"RTN","MAGNWRK1",52,0)
 S REFTYPE=$S(MAGPDATA=74:"RAD",MAGPDATA=8925:"TIU",1:"")
"RTN","MAGNWRK1",53,0)
 I REFTYPE'="" D
"RTN","MAGNWRK1",54,0)
 . S REFIEN=$$GET1^DIQ(2005,IEN,17,"I")
"RTN","MAGNWRK1",55,0)
 . S J=J+1,MSGTAGS(J)="contextId`"_$TR($$CPRSCTX^MAGNU003(REFTYPE,REFIEN),"^","~")  ; Create CPRS Context ID and translate ^ to ~
"RTN","MAGNWRK1",56,0)
 . Q
"RTN","MAGNWRK1",57,0)
 ;
"RTN","MAGNWRK1",58,0)
 S J=J+1,MSGTAGS(J)="imageFileName`"_$$FILENAME^MAGGAII(IEN,"FULL",.TMP)
"RTN","MAGNWRK1",59,0)
 S J=J+1,MSGTAGS(J)="imageShortDescr`"_$$GET1^DIQ(2005,IEN,10,"I")
"RTN","MAGNWRK1",60,0)
 S J=J+1,MSGTAGS(J)="imageObjectType`"_$$GET1^DIQ(2005,IEN,3,"I")
"RTN","MAGNWRK1",61,0)
 S MODALITY=$$MODALITY(IEN)
"RTN","MAGNWRK1",62,0)
 S:MODALITY'="" J=J+1,MSGTAGS(J)="imageModality`"_MODALITY
"RTN","MAGNWRK1",63,0)
 ;
"RTN","MAGNWRK1",64,0)
 S TYPE="PRECACHE"
"RTN","MAGNWRK1",65,0)
 S SUBTYPE="ACQUISITION"
"RTN","MAGNWRK1",66,0)
 S STATUS="New"
"RTN","MAGNWRK1",67,0)
 S PRIORITY=0
"RTN","MAGNWRK1",68,0)
 ;
"RTN","MAGNWRK1",69,0)
 S PLACEID=$$STA^XUAF4(PLACEID) ;IA # 2171
"RTN","MAGNWRK1",70,0)
 ;
"RTN","MAGNWRK1",71,0)
 S CRTUSR=$$GET1^DIQ(2005,IEN,8,"I")    ; IMAGE SAVE BY
"RTN","MAGNWRK1",72,0)
 S:'CRTUSR CRTUSR=DUZ
"RTN","MAGNWRK1",73,0)
 ;
"RTN","MAGNWRK1",74,0)
 S CRTAPP=$$GET1^DIQ(2005,IEN,8.1,"I")  ; CAPTURE APPLICATION
"RTN","MAGNWRK1",75,0)
 S CRTAPP=$S(CRTAPP="D":"DICOM",CRTAPP="C":"CAPTURE",1:"IMPORTER")
"RTN","MAGNWRK1",76,0)
 ;
"RTN","MAGNWRK1",77,0)
 D CRTITEM^MAGVIM01(.MAGVOUT,TYPE,SUBTYPE,STATUS,PLACEID,PRIORITY,.MSGTAGS,CRTUSR,CRTAPP)
"RTN","MAGNWRK1",78,0)
 Q
"RTN","MAGNWRK1",79,0)
 ;
"RTN","MAGNWRK1",80,0)
NWI34(MAGVOUT,PIEN,IEN)  ;  ;Create a new MAG WORK ITEM for an image stored in P34 stucture
"RTN","MAGNWRK1",81,0)
 ; PIEN = IEN in IMAGE SOP INSTANCE file (#2005.64)
"RTN","MAGNWRK1",82,0)
 ; IEN  = IMAGE INSTANCE FILE file (#2005.65)
"RTN","MAGNWRK1",83,0)
 ;
"RTN","MAGNWRK1",84,0)
 N CPRSCNTX,CRTUSR,CRTAPP,DFN,ICN,J,MAGGRP,MSGTAGS,TYPE,SUBTYPE,STATUS,PLACEID,PRIORITY,Y
"RTN","MAGNWRK1",85,0)
 N MAGAENT,MAGMODAL,REFTYPE,REFIEN
"RTN","MAGNWRK1",86,0)
 ;
"RTN","MAGNWRK1",87,0)
 S PLACEID=$$GET1^DIQ(2005.64,PIEN,"11:31:.01","I") ; ACQUISITION LOCATION in file #2005.63
"RTN","MAGNWRK1",88,0)
 S PLACEID=$S($P(PLACEID,";",2)="DIC(4,":+PLACEID,1:"")
"RTN","MAGNWRK1",89,0)
 S:'PLACEID PLACEID=DUZ(2)
"RTN","MAGNWRK1",90,0)
 ;
"RTN","MAGNWRK1",91,0)
 Q:'$$GET^XPAR("DIV.`"_PLACEID_"^SYS","MAG PRECACHE ACQ ENABLED",,"I")  ; IA# 2263 
"RTN","MAGNWRK1",92,0)
 ;
"RTN","MAGNWRK1",93,0)
 S DFN=""
"RTN","MAGNWRK1",94,0)
 S MAGAENT=$$GET1^DIQ(2005.64,PIEN,"11:11:13:.02","I")  ; ASSIGNING AUTHORITY in file #2005.6
"RTN","MAGNWRK1",95,0)
 I MAGAENT="V" S DFN=$$GET1^DIQ(2005.64,PIEN,"11:11:13:.01","I")  ; ENTERPRISE PATIENT ID in file #2005.6
"RTN","MAGNWRK1",96,0)
 ;
"RTN","MAGNWRK1",97,0)
 S MAGMODAL=$$GET1^DIQ(2005.64,PIEN,"11:3","I")  ; MODALITY in file #2005.63
"RTN","MAGNWRK1",98,0)
 ;
"RTN","MAGNWRK1",99,0)
 S MAGGRP=$$GET1^DIQ(2005.64,PIEN,"11:11","I")  ; Study IEN in file #2005.62
"RTN","MAGNWRK1",100,0)
 ;
"RTN","MAGNWRK1",101,0)
 ; TAGS
"RTN","MAGNWRK1",102,0)
 S J=0
"RTN","MAGNWRK1",103,0)
 S J=J+1,MSGTAGS(J)="storage`2005.64"  ; image is in P34 data structure
"RTN","MAGNWRK1",104,0)
 S J=J+1,MSGTAGS(J)="imageIen`"_PIEN  ; IEN in IMAGE SOP INSTANCE file (#2005.64)
"RTN","MAGNWRK1",105,0)
 S:MAGGRP J=J+1,MSGTAGS(J)="studyIen`"_MAGGRP   ;Study IEN in IMAGE STUDY file (#2005.62)
"RTN","MAGNWRK1",106,0)
 S:DFN J=J+1,MSGTAGS(J)="patientDfn`"_DFN
"RTN","MAGNWRK1",107,0)
 I $L($T(GETICN^MPIF001)) D
"RTN","MAGNWRK1",108,0)
 . S ICN=$$GETICN^MPIF001(DFN)
"RTN","MAGNWRK1",109,0)
 . S:ICN>1 J=J+1,MSGTAGS(J)="patientIcn`"_ICN
"RTN","MAGNWRK1",110,0)
 . Q
"RTN","MAGNWRK1",111,0)
 S:MAGMODAL'="" J=J+1,MSGTAGS(J)="modality`"_MAGMODAL   ; MODALITY in file #2005.63
"RTN","MAGNWRK1",112,0)
 ;
"RTN","MAGNWRK1",113,0)
 D AINST(.MSGTAGS,.J,IEN)  ; Add Add Artifact Instance tags
"RTN","MAGNWRK1",114,0)
 ;
"RTN","MAGNWRK1",115,0)
 S J=J+1,MSGTAGS(J)="acquisition`1"     ; precash flag
"RTN","MAGNWRK1",116,0)
 ;
"RTN","MAGNWRK1",117,0)
 S CPRSCNTX=$$CPRSCTXS(MAGGRP) ; Create CPRS Context ID by Study IEN
"RTN","MAGNWRK1",118,0)
 I CPRSCNTX'="" D
"RTN","MAGNWRK1",119,0)
 . S J=J+1,MSGTAGS(J)="contextId`"_$TR(CPRSCNTX,"^","~")  ; translate ^ to ~ 
"RTN","MAGNWRK1",120,0)
 . Q
"RTN","MAGNWRK1",121,0)
 ;
"RTN","MAGNWRK1",122,0)
 S TYPE="PRECACHE"
"RTN","MAGNWRK1",123,0)
 S SUBTYPE="ACQUISITION"
"RTN","MAGNWRK1",124,0)
 S STATUS="New"
"RTN","MAGNWRK1",125,0)
 S PRIORITY=0
"RTN","MAGNWRK1",126,0)
 S PLACEID=$$STA^XUAF4(PLACEID) ;IA # 2171
"RTN","MAGNWRK1",127,0)
 ;
"RTN","MAGNWRK1",128,0)
 S CRTUSR=""    ; IMAGE SAVE BY
"RTN","MAGNWRK1",129,0)
 S:'CRTUSR CRTUSR=DUZ
"RTN","MAGNWRK1",130,0)
 ;
"RTN","MAGNWRK1",131,0)
 S CRTAPP="D"  ; CAPTURE APPLICATION
"RTN","MAGNWRK1",132,0)
 S CRTAPP=$S(CRTAPP="D":"DICOM",CRTAPP="C":"CAPTURE",1:"IMPORTER")
"RTN","MAGNWRK1",133,0)
 ;
"RTN","MAGNWRK1",134,0)
 D CRTITEM^MAGVIM01(.MAGVOUT,TYPE,SUBTYPE,STATUS,PLACEID,PRIORITY,.MSGTAGS,CRTUSR,CRTAPP)
"RTN","MAGNWRK1",135,0)
 Q
"RTN","MAGNWRK1",136,0)
 ;
"RTN","MAGNWRK1",137,0)
CPRSCTXS(STUDYIEN) ; Get CPRS context by Study IEN in IMAGE STUDY file (#2005.62)
"RTN","MAGNWRK1",138,0)
 N ACNUMB,CONTEXT,REFTYPE,REFIEN
"RTN","MAGNWRK1",139,0)
 S ACNUMB=$$GET1^DIQ(2005.62,STUDYIEN,.02,"I")
"RTN","MAGNWRK1",140,0)
 D REFBYACN^MAGNU003(.REFTYPE,.REFIEN,ACNUMB)  ; Set Reference type by Accession Number
"RTN","MAGNWRK1",141,0)
 S CONTEXT=$$CPRSCTX^MAGNU003(REFTYPE,REFIEN)
"RTN","MAGNWRK1",142,0)
 Q CONTEXT
"RTN","MAGNWRK1",143,0)
 ;
"RTN","MAGNWRK1",144,0)
AINST(MSGTAGS,J,INSTIEN)  ; Add Artifact Instance 
"RTN","MAGNWRK1",145,0)
 ; INSTIEN = IEN in IMAGE INSTANCE FILE file (#2005.65)
"RTN","MAGNWRK1",146,0)
 ;
"RTN","MAGNWRK1",147,0)
 N CNT,KEY,VALUE,LINE,IEN,I,RES,TMPARR,TOKEN,QT
"RTN","MAGNWRK1",148,0)
 S TOKEN=$$GET1^DIQ(2005.65,INSTIEN,.01,"I") ; Artifact Token
"RTN","MAGNWRK1",149,0)
 D GETAIENT^MAGVAG02(.RES,TOKEN,"") ; Get not deleted Artifact IEN by Token
"RTN","MAGNWRK1",150,0)
 I '$$ISOK^MAGVAF02(RES) Q
"RTN","MAGNWRK1",151,0)
 S IEN=$$GETVAL^MAGVAF02(RES)
"RTN","MAGNWRK1",152,0)
 D GETAINST^MAGVAG04(.TMPARR,IEN)
"RTN","MAGNWRK1",153,0)
 I '$$ISOK^MAGVAF02(TMPARR(0)) Q
"RTN","MAGNWRK1",154,0)
 S QT=$C(34)
"RTN","MAGNWRK1",155,0)
 S CNT=0
"RTN","MAGNWRK1",156,0)
 S I=1
"RTN","MAGNWRK1",157,0)
 F  S I=$O(TMPARR(I)) Q:'I  S LINE=TMPARR(I) Q:LINE["</ARTIFACTINSTANCES"  D
"RTN","MAGNWRK1",158,0)
 . I LINE["<ARTIFACTINSTANCE" S CNT=CNT+1 Q
"RTN","MAGNWRK1",159,0)
 . I LINE["</ARTIFACTINSTANCE" Q
"RTN","MAGNWRK1",160,0)
 . S KEY=$P(TMPARR(I),"=",1)
"RTN","MAGNWRK1",161,0)
 . S VALUE=$TR($P(TMPARR(I),"=",2),QT,"")
"RTN","MAGNWRK1",162,0)
 . S VALUE=$P(VALUE," >")  ; special handling because of XML result set
"RTN","MAGNWRK1",163,0)
 . I (KEY="PK")!(KEY="ARTIFACT")!(KEY="DISKVOLUME") S J=J+1,MSGTAGS(J)="ai_"_KEY_"_"_CNT_"`"_VALUE
"RTN","MAGNWRK1",164,0)
 . I KEY="STORAGEPROVIDER" D  ; Add Storage provider name
"RTN","MAGNWRK1",165,0)
 . . S J=J+1,MSGTAGS(J)="ai_storeProvType_"_CNT_"`"_$$GET1^DIQ(2006.917,VALUE,"2")
"RTN","MAGNWRK1",166,0)
 . . Q
"RTN","MAGNWRK1",167,0)
 . Q
"RTN","MAGNWRK1",168,0)
 Q
"RTN","MAGNWRK1",169,0)
 ;
"RTN","MAGNWRK1",170,0)
MODALITY(IMGIEN)  ; Get Image modality
"RTN","MAGNWRK1",171,0)
 N G,M,P,MAGFILD,MAGFILG,X
"RTN","MAGNWRK1",172,0)
 S MAGFILD=$$FILE^MAGGI11(IMGIEN)
"RTN","MAGNWRK1",173,0)
 S X=$S(MAGFILD:$G(^MAG(MAGFILD,IMGIEN,0)),1:"")
"RTN","MAGNWRK1",174,0)
 S G=+$P(X,"^",10) ;Group IEN
"RTN","MAGNWRK1",175,0)
 S M=$P(X,"^",8)   ;Procedure
"RTN","MAGNWRK1",176,0)
 S:$E(M,1,4)="RAD " M=$E(M,5,$L(M))
"RTN","MAGNWRK1",177,0)
 Q:M="" ""
"RTN","MAGNWRK1",178,0)
 S MAGFILG=$$FILE^MAGGI11(G)
"RTN","MAGNWRK1",179,0)
 S G=$S(MAGFILG:$P($G(^MAG(MAGFILG,G,2)),"^",6),1:"") ;Parent Data File# for Group IEN
"RTN","MAGNWRK1",180,0)
 S P=$S(MAGFILD:$P($G(^MAG(MAGFILD,IMGIEN,2)),"^",6),1:"") ;Parent Data File# for IEN
"RTN","MAGNWRK1",181,0)
 I P'=74,G'=74 Q ""  ;quit if not RAD/NUC MED REPORTS file (#74)
"RTN","MAGNWRK1",182,0)
 Q M
"RTN","MAGSIXG1")
0^11^B40907827
"RTN","MAGSIXG1",1,0)
MAGSIXG1 ;WOIFO/EdM/GEK/SEB/SG/NST - LIST OF IMAGES RPCS ; JUN 11, 2018@11:43 AM
"RTN","MAGSIXG1",2,0)
 ;;3.0;IMAGING;**8,48,59,93,117,221**;Mar 19, 2002;Build 2238;Jul 15, 2011
"RTN","MAGSIXG1",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGSIXG1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGSIXG1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGSIXG1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGSIXG1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGSIXG1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGSIXG1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGSIXG1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGSIXG1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGSIXG1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGSIXG1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGSIXG1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGSIXG1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGSIXG1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGSIXG1",17,0)
 ;;
"RTN","MAGSIXG1",18,0)
 Q
"RTN","MAGSIXG1",19,0)
 ;
"RTN","MAGSIXG1",20,0)
 ;+++++ FORMATS RPC ERRORS
"RTN","MAGSIXG1",21,0)
ERRORS(RESULTS,RC) ;
"RTN","MAGSIXG1",22,0)
 S:$G(RC)'<0 RC=$$FIRSTERR^MAGUERR1()
"RTN","MAGSIXG1",23,0)
 D RPCERRS^MAGUERR1(.RESULTS,RC)
"RTN","MAGSIXG1",24,0)
 Q
"RTN","MAGSIXG1",25,0)
 ;
"RTN","MAGSIXG1",26,0)
 ;***** RETURNS THE LIST OF IMAGE DESCRIPTORS
"RTN","MAGSIXG1",27,0)
 ; RPC: MAG4 IMAGE LIST
"RTN","MAGSIXG1",28,0)
 ;
"RTN","MAGSIXG1",29,0)
 ; .MAGOUT       Reference to a local variable where the results
"RTN","MAGSIXG1",30,0)
 ;               are returned to.
"RTN","MAGSIXG1",31,0)
 ;
"RTN","MAGSIXG1",32,0)
 ; FLAGS         Flags that control the execution (can be combined):
"RTN","MAGSIXG1",33,0)
 ;
"RTN","MAGSIXG1",34,0)
 ;                 C  Capture date range. If this flag is provided,
"RTN","MAGSIXG1",35,0)
 ;                    then the remote procedure uses values of the
"RTN","MAGSIXG1",36,0)
 ;                    FROMDATE and TODATE parameters to select images
"RTN","MAGSIXG1",37,0)
 ;                    that were captured in this date range.
"RTN","MAGSIXG1",38,0)
 ;
"RTN","MAGSIXG1",39,0)
 ;                    Otherwise, values of those parameters are
"RTN","MAGSIXG1",40,0)
 ;                    treated as the date range when procedures were
"RTN","MAGSIXG1",41,0)
 ;                    performed.
"RTN","MAGSIXG1",42,0)
 ;
"RTN","MAGSIXG1",43,0)
 ;                 D  Include only deleted images (file #2005.1)
"RTN","MAGSIXG1",44,0)
 ;                 E  Include only existing images (file #2005)
"RTN","MAGSIXG1",45,0)
 ;
"RTN","MAGSIXG1",46,0)
 ;                 S  Return the sparse subset of images captured by
"RTN","MAGSIXG1",47,0)
 ;                    the user defined by the MISCPRMS("SAVEDBY").
"RTN","MAGSIXG1",48,0)
 ;                    The latter becomes required in this case.
"RTN","MAGSIXG1",49,0)
 ;
"RTN","MAGSIXG1",50,0)
 ;                 G  Include Group Images in the list of images returned. 
"RTN","MAGSIXG1",51,0)
 ;                    If any image in a group has an image that matches the 
"RTN","MAGSIXG1",52,0)
 ;                    status provided in the search criteria then 
"RTN","MAGSIXG1",53,0)
 ;                    the group will be returned.
"RTN","MAGSIXG1",54,0)
 ;                    
"RTN","MAGSIXG1",55,0)
 ;                    If the G flag is not set then only the status of the 
"RTN","MAGSIXG1",56,0)
 ;                    Group entry will be checked and the group will be 
"RTN","MAGSIXG1",57,0)
 ;                    returned if it passes.
"RTN","MAGSIXG1",58,0)
 ;
"RTN","MAGSIXG1",59,0)
 ;                    See description of the MAG4 IMAGE LIST remote
"RTN","MAGSIXG1",60,0)
 ;                    procedure for details.
"RTN","MAGSIXG1",61,0)
 ;
"RTN","MAGSIXG1",62,0)
 ;               If neither 'E' nor 'D' flag is provided, then an
"RTN","MAGSIXG1",63,0)
 ;               error code is returned.
"RTN","MAGSIXG1",64,0)
 ;
"RTN","MAGSIXG1",65,0)
 ; [FROMDATE]    Date range for image selection. Dates can be in
"RTN","MAGSIXG1",66,0)
 ; [TODATE]      internal or external FileMan format. If a date
"RTN","MAGSIXG1",67,0)
 ;               parameter is not defined or empty, then the date
"RTN","MAGSIXG1",68,0)
 ;               range remains open on the corresponding side.
"RTN","MAGSIXG1",69,0)
 ;
"RTN","MAGSIXG1",70,0)
 ;               Time parts of parameter values are ignored and both
"RTN","MAGSIXG1",71,0)
 ;               ends of the date range are included in the search.
"RTN","MAGSIXG1",72,0)
 ;               For example, in order to search images for May 21,
"RTN","MAGSIXG1",73,0)
 ;               2008, the internal value of both parameters should
"RTN","MAGSIXG1",74,0)
 ;               be 3080521.
"RTN","MAGSIXG1",75,0)
 ;
"RTN","MAGSIXG1",76,0)
 ;               If the FROMDATE is after the TODATE, then values of
"RTN","MAGSIXG1",77,0)
 ;               the parameters are swapped.
"RTN","MAGSIXG1",78,0)
 ;
"RTN","MAGSIXG1",79,0)
 ; [MAXNUM]      If this parameter is defined and greater than 0,
"RTN","MAGSIXG1",80,0)
 ;               then it determines the maximum number of images
"RTN","MAGSIXG1",81,0)
 ;               returned by the call.
"RTN","MAGSIXG1",82,0)
 ;
"RTN","MAGSIXG1",83,0)
 ;               If the S flag is included in the value of the FLAGS
"RTN","MAGSIXG1",84,0)
 ;               parameter, then the MAXNUM parameter must be defined
"RTN","MAGSIXG1",85,0)
 ;               and greater than 0. Its value determines percentage
"RTN","MAGSIXG1",86,0)
 ;               of preselected images to be returned in the result
"RTN","MAGSIXG1",87,0)
 ;               array.
"RTN","MAGSIXG1",88,0)
 ;
"RTN","MAGSIXG1",89,0)
 ;               See description of the MAG4 IMAGE LIST remote
"RTN","MAGSIXG1",90,0)
 ;               procedure for details.
"RTN","MAGSIXG1",91,0)
 ;
"RTN","MAGSIXG1",92,0)
 ; [.MISCPRMS]   Reference to a local variable that stores misc.
"RTN","MAGSIXG1",93,0)
 ;               parameters that define the image selection criteria.
"RTN","MAGSIXG1",94,0)
 ;               See the description of the MAG4 IMAGE LIST remote
"RTN","MAGSIXG1",95,0)
 ;               procedure for details.
"RTN","MAGSIXG1",96,0)
 ;
"RTN","MAGSIXG1",97,0)
 ; Return Values
"RTN","MAGSIXG1",98,0)
 ; =============
"RTN","MAGSIXG1",99,0)
 ;     
"RTN","MAGSIXG1",100,0)
 ; If MAGOUT(0) is defined and its 1st '^'-piece is 0, then an error
"RTN","MAGSIXG1",101,0)
 ; occurred during execution of the procedure. In this case, the array
"RTN","MAGSIXG1",102,0)
 ; is formatted as described in the comments to the RPCERRS^MAGUERR1.
"RTN","MAGSIXG1",103,0)
 ;  
"RTN","MAGSIXG1",104,0)
 ; See description of the MAG4 IMAGE LIST remote procedure for more
"RTN","MAGSIXG1",105,0)
 ; details.
"RTN","MAGSIXG1",106,0)
 ;
"RTN","MAGSIXG1",107,0)
 ; Notes
"RTN","MAGSIXG1",108,0)
 ; =====
"RTN","MAGSIXG1",109,0)
 ;
"RTN","MAGSIXG1",110,0)
 ; Temporary global nodes ^TMP("MAGSIX1",$J) and ^TMP("MAGSIXG3",$J)
"RTN","MAGSIXG1",111,0)
 ; are used by this procedure.
"RTN","MAGSIXG1",112,0)
 ;
"RTN","MAGSIXG1",113,0)
 ; If the number of images conforming to the filter reaches 76, all
"RTN","MAGSIXG1",114,0)
 ; results are stored in the ^TMP("MAGSIXG1",$J) global node, closed
"RTN","MAGSIXG1",115,0)
 ; reference is assigned to the MAGOUT parameter, and the type of the
"RTN","MAGSIXG1",116,0)
 ; RPC return parameter is changed to 'GLOBAL ARRAY'.
"RTN","MAGSIXG1",117,0)
 ;
"RTN","MAGSIXG1",118,0)
GETIMGS(MAGOUT,FLAGS,FROMDATE,TODATE,MAXNUM,MISCPRMS) ;RPC [MAG4 IMAGE LIST]
"RTN","MAGSIXG1",119,0)
 N MAGDATA       ; Array for passing the data to the callback
"RTN","MAGSIXG1",120,0)
 ;               ; function of the image query (including the
"RTN","MAGSIXG1",121,0)
 ;               ; image selection criteria).
"RTN","MAGSIXG1",122,0)
 ;
"RTN","MAGSIXG1",123,0)
 N ERROR,MISC,QF,RC,TMP
"RTN","MAGSIXG1",124,0)
 S (MAGDATA("RESCNT"),RC)=0,MAGDATA="MAGOUT"  K MAGOUT
"RTN","MAGSIXG1",125,0)
 D CLEAR^MAGUERR(1),NETPLCS^MAGGTU6
"RTN","MAGSIXG1",126,0)
 K ^TMP("MAGSIXG3",$J)
"RTN","MAGSIXG1",127,0)
 ;
"RTN","MAGSIXG1",128,0)
 S MAXNUM=$G(MAXNUM)
"RTN","MAGSIXG1",129,0)
 ;=== Validate parameters
"RTN","MAGSIXG1",130,0)
 S ERROR=$$VALPARAM(.MAGDATA,FLAGS,.FROMDATE,.TODATE,MAXNUM,.MISCPRMS)
"RTN","MAGSIXG1",131,0)
 ;
"RTN","MAGSIXG1",132,0)
 ;--- Check for errors
"RTN","MAGSIXG1",133,0)
 I ERROR D ERROR^MAGUERR(-30),ERRORS(.MAGOUT)  Q
"RTN","MAGSIXG1",134,0)
 ;
"RTN","MAGSIXG1",135,0)
 S MAXNUM=+$G(MAXNUM)
"RTN","MAGSIXG1",136,0)
 ;
"RTN","MAGSIXG1",137,0)
 ;=== Query the image file(s)
"RTN","MAGSIXG1",138,0)
 S MAGDATA("FLAGS")=FLAGS,MAGDATA("MAXNUM")=MAXNUM
"RTN","MAGSIXG1",139,0)
 S TMP=$S(TODATE<9999999:$$FMADD^XLFDT(TODATE,1),1:TODATE)
"RTN","MAGSIXG1",140,0)
 S QF=$$TRFLAGS^MAGUTL05(FLAGS,"CDEG")
"RTN","MAGSIXG1",141,0)
 S RC=$$QUERY^MAGGI13("$$QRYCBK^MAGSIXG3",QF,.MAGDATA,FROMDATE,TMP,+$G(MAGDATA("IDFN")))
"RTN","MAGSIXG1",142,0)
 I RC<0  D ERRORS(.MAGOUT,RC)  Q
"RTN","MAGSIXG1",143,0)
 ;
"RTN","MAGSIXG1",144,0)
 ;=== Post-processing for the sparse subset query
"RTN","MAGSIXG1",145,0)
 I FLAGS["S"  D  I RC<0  D ERRORS(.MAGOUT,RC)  Q
"RTN","MAGSIXG1",146,0)
 . S RC=$$SUBSET^MAGSIXG4()
"RTN","MAGSIXG1",147,0)
 . Q
"RTN","MAGSIXG1",148,0)
 ;
"RTN","MAGSIXG1",149,0)
 ;=== Cleanup
"RTN","MAGSIXG1",150,0)
 K ^TMP("MAGSIXG3",$J)
"RTN","MAGSIXG1",151,0)
 S TMP=$$FLTDESC^MAGSIXG2(.MAGDATA,FROMDATE(0),TODATE(0),FLAGS)
"RTN","MAGSIXG1",152,0)
 I 'MAGDATA("RESCNT")  D ERRORS(.MAGOUT,$$ERROR^MAGUERR(-19,,TMP))  Q
"RTN","MAGSIXG1",153,0)
 S @MAGDATA@(0)="1^"_TMP_$S($G(MAGDATA("MAXNUM")):U_(RC>0),1:"")
"RTN","MAGSIXG1",154,0)
 S @MAGDATA@(1)=$$BLDHDR^MAGSIXG2()
"RTN","MAGSIXG1",155,0)
 Q
"RTN","MAGSIXG1",156,0)
 ;
"RTN","MAGSIXG1",157,0)
 ;***** GET IMAGES FOR THE PATIENT
"RTN","MAGSIXG1",158,0)
 ; RPC: MAG4 PAT GET IMAGES
"RTN","MAGSIXG1",159,0)
 ;
"RTN","MAGSIXG1",160,0)
 ; .MAGOUT       Reference to a local variable where the results
"RTN","MAGSIXG1",161,0)
 ;               are returned to.
"RTN","MAGSIXG1",162,0)
 ;
"RTN","MAGSIXG1",163,0)
 ; DFN           Patient IEN (DFN)
"RTN","MAGSIXG1",164,0)
 ;       
"RTN","MAGSIXG1",165,0)
 ; [PKG]         Package index(es)
"RTN","MAGSIXG1",166,0)
 ; [CLASS]       Class index(es)
"RTN","MAGSIXG1",167,0)
 ; [TYPE]        Type index(es)
"RTN","MAGSIXG1",168,0)
 ; [EVENT]       Procedure/Event index(es)
"RTN","MAGSIXG1",169,0)
 ; [SPEC]        Speciality/SubSpecialty index(es)
"RTN","MAGSIXG1",170,0)
 ;
"RTN","MAGSIXG1",171,0)
 ; [FROMDATE]    Date range for image selection. See description
"RTN","MAGSIXG1",172,0)
 ; [TODATE]      of the GETIMGS^MAGSIXG1 entry point for details.
"RTN","MAGSIXG1",173,0)
 ;
"RTN","MAGSIXG1",174,0)
 ; [ORIGIN]      Origin index(es)
"RTN","MAGSIXG1",175,0)
 ;
"RTN","MAGSIXG1",176,0)
 ; [DATA]        Reserved for future use.
"RTN","MAGSIXG1",177,0)
 ;
"RTN","MAGSIXG1",178,0)
 ; [FLAGS]       Flags that control the execution (can be combined):
"RTN","MAGSIXG1",179,0)
 ;
"RTN","MAGSIXG1",180,0)
 ;                 D  Include only deleted images (file #2005.1)
"RTN","MAGSIXG1",181,0)
 ;                 E  Include only existing images (file #2005)
"RTN","MAGSIXG1",182,0)
 ;
"RTN","MAGSIXG1",183,0)
 ;               By default ($G(FLAGS)=""), the "E" value is assumed.
"RTN","MAGSIXG1",184,0)
 ; 
"RTN","MAGSIXG1",185,0)
 ; Return Values
"RTN","MAGSIXG1",186,0)
 ; =============
"RTN","MAGSIXG1",187,0)
 ;
"RTN","MAGSIXG1",188,0)
 ; See description of the MAG4 PAT GET IMAGES remote procedure.
"RTN","MAGSIXG1",189,0)
 ;
"RTN","MAGSIXG1",190,0)
PGI(MAGOUT,DFN,PKG,CLASS,TYPE,EVENT,SPEC,FROMDATE,TODATE,ORIGIN,DATA,FLAGS) ;RPC [MAG4 PAT GET IMAGES]
"RTN","MAGSIXG1",191,0)
 N I,MISCPRMS
"RTN","MAGSIXG1",192,0)
 K MAGOUT  S I=0
"RTN","MAGSIXG1",193,0)
 ;--- Check the patient IEN (DFN)
"RTN","MAGSIXG1",194,0)
 I $G(DFN)'>0  D ERRORS(.MAGOUT,$$IPVE^MAGUERR("DFN"))  Q
"RTN","MAGSIXG1",195,0)
 S I=I+1,MISCPRMS(I)="IDFN^^"_(+DFN)
"RTN","MAGSIXG1",196,0)
 ;--- Check the flags
"RTN","MAGSIXG1",197,0)
 S:$G(FLAGS)="" FLAGS="E"
"RTN","MAGSIXG1",198,0)
 I $TR(FLAGS,"DE")'=""  D ERRORS(.MAGOUT,$$IPVE^MAGUERR("FLAGS"))  Q
"RTN","MAGSIXG1",199,0)
 ;--- Pass the filter parameters through
"RTN","MAGSIXG1",200,0)
 S:$G(PKG)'="" I=I+1,MISCPRMS(I)="IXPKG^^"_$TR(PKG,",","^")
"RTN","MAGSIXG1",201,0)
 S:$G(CLASS)'="" I=I+1,MISCPRMS(I)="IXCLASS^^"_$TR(CLASS,",","^")
"RTN","MAGSIXG1",202,0)
 S:$G(TYPE)'="" I=I+1,MISCPRMS(I)="IXTYPE^^"_$TR(TYPE,",","^")
"RTN","MAGSIXG1",203,0)
 S:$G(EVENT)'="" I=I+1,MISCPRMS(I)="IXPROC^^"_$TR(EVENT,",","^")
"RTN","MAGSIXG1",204,0)
 S:$G(SPEC)'="" I=I+1,MISCPRMS(I)="IXSPEC^^"_$TR(SPEC,",","^")
"RTN","MAGSIXG1",205,0)
 S:$G(ORIGIN)'="" I=I+1,MISCPRMS(I)="IXORIGIN^^"_$TR(ORIGIN,",","^")
"RTN","MAGSIXG1",206,0)
 ;--- Call the new remote procedure implementation
"RTN","MAGSIXG1",207,0)
 D GETIMGS(.MAGOUT,FLAGS,.FROMDATE,.TODATE,,.MISCPRMS)
"RTN","MAGSIXG1",208,0)
 Q
"RTN","MAGSIXG1",209,0)
 ;
"RTN","MAGSIXG1",210,0)
VALPARAM(MAGDATA,FLAGS,FROMDATE,TODATE,MAXNUM,MISCPRMS)  ; Validate input parameters
"RTN","MAGSIXG1",211,0)
 N ERROR,MISC,MISCDEFS,RC,TMP
"RTN","MAGSIXG1",212,0)
 ;--- Control flags
"RTN","MAGSIXG1",213,0)
 S ERROR=0
"RTN","MAGSIXG1",214,0)
 S FLAGS=$G(FLAGS)
"RTN","MAGSIXG1",215,0)
 I $TR(FLAGS,"CDESG")'=""  D  S ERROR=1
"RTN","MAGSIXG1",216,0)
 . D IPVE^MAGUERR("FLAGS")     ; Unknown/Unsupported flag(s)
"RTN","MAGSIXG1",217,0)
 . Q
"RTN","MAGSIXG1",218,0)
 I $TR(FLAGS,"DE")=FLAGS  D  S ERROR=1
"RTN","MAGSIXG1",219,0)
 . D ERROR^MAGUERR(-6,,"D,E")  ; Missing required flag
"RTN","MAGSIXG1",220,0)
 . Q
"RTN","MAGSIXG1",221,0)
 ;--- Date range
"RTN","MAGSIXG1",222,0)
 S:$$DTRANGE^MAGUTL03(.FROMDATE,.TODATE)<0 ERROR=1
"RTN","MAGSIXG1",223,0)
 ;--- Miscellaneous parameters
"RTN","MAGSIXG1",224,0)
 S RC=$$LDMPDEFS^MAGUTL01(.MISCDEFS,"MISCDEFS^MAGSIXG2")
"RTN","MAGSIXG1",225,0)
 I RC<0  S ERROR=1  Q
"RTN","MAGSIXG1",226,0)
 S RC=$$RPCMISC^MAGUTL02(.MISCPRMS,.MISC,.MISCDEFS,"UV")
"RTN","MAGSIXG1",227,0)
 I RC<0  S ERROR=1  Q
"RTN","MAGSIXG1",228,0)
 S:$$VALMISC^MAGSIXG2(.MISC,.MAGDATA)<0 ERROR=1
"RTN","MAGSIXG1",229,0)
 ;--- Number/percentage of results
"RTN","MAGSIXG1",230,0)
 I $G(MAXNUM)<0  D
"RTN","MAGSIXG1",231,0)
 . D IPVE^MAGUERR("MAXNUM")  S ERROR=1
"RTN","MAGSIXG1",232,0)
 . Q
"RTN","MAGSIXG1",233,0)
 E  I FLAGS["S"  D
"RTN","MAGSIXG1",234,0)
 . ;--- Check the percentage
"RTN","MAGSIXG1",235,0)
 . S TMP=+$G(MAXNUM)
"RTN","MAGSIXG1",236,0)
 . I 'TMP!(TMP>100)  D IPVE^MAGUERR("MAXNUM")  S ERROR=1  Q
"RTN","MAGSIXG1",237,0)
 . S MAGDATA("SUBSET%")=TMP,MAXNUM=0
"RTN","MAGSIXG1",238,0)
 . ;--- User filter is required for this query
"RTN","MAGSIXG1",239,0)
 . S TMP=$NA(MAGDATA("SAVEDBY"))
"RTN","MAGSIXG1",240,0)
 . I $G(@TMP)'>0  D ERROR^MAGUERR(-8,,TMP)  S ERROR=1  Q
"RTN","MAGSIXG1",241,0)
 . Q
"RTN","MAGSIXG1",242,0)
 ;
"RTN","MAGSIXG1",243,0)
 Q ERROR
"RTN","MAGSIXG2")
0^12^B69913945
"RTN","MAGSIXG2",1,0)
MAGSIXG2 ;WOIFO/SG,NST - LIST OF IMAGES RPCS (PARAMETERS) ; 5/11/18 3:52pm
"RTN","MAGSIXG2",2,0)
 ;;3.0;IMAGING;**93,221**;Dec 02, 2009;Build 163
"RTN","MAGSIXG2",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGSIXG2",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGSIXG2",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGSIXG2",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGSIXG2",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGSIXG2",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGSIXG2",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGSIXG2",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGSIXG2",11,0)
 ;; |                                                               |
"RTN","MAGSIXG2",12,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGSIXG2",13,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGSIXG2",14,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGSIXG2",15,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGSIXG2",16,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGSIXG2",17,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGSIXG2",18,0)
 ;;
"RTN","MAGSIXG2",19,0)
 ;
"RTN","MAGSIXG2",20,0)
 ; This routine uses the following ICRs:
"RTN","MAGSIXG2",21,0)
 ;
"RTN","MAGSIXG2",22,0)
 ; #10035        Read file #2 (supported)
"RTN","MAGSIXG2",23,0)
 ;
"RTN","MAGSIXG2",24,0)
 Q
"RTN","MAGSIXG2",25,0)
 ;
"RTN","MAGSIXG2",26,0)
 ;+++++ RETURNS THE HEADER FOR THE RPC RESULT ARRAY
"RTN","MAGSIXG2",27,0)
BLDHDR() ;
"RTN","MAGSIXG2",28,0)
 N HDR,I,TMP
"RTN","MAGSIXG2",29,0)
 S HDR=""
"RTN","MAGSIXG2",30,0)
 F I=3:1  S TMP=$P($T(BLDHDR1+I),";;",2)  Q:TMP=""  D
"RTN","MAGSIXG2",31,0)
 . S HDR=HDR_U_$$TRIM^XLFSTR($P(TMP,U,2))
"RTN","MAGSIXG2",32,0)
 . Q
"RTN","MAGSIXG2",33,0)
 Q $P(HDR,U,2,9999)
"RTN","MAGSIXG2",34,0)
 ;
"RTN","MAGSIXG2",35,0)
BLDHDR1 ;+++++ TEMPLATE OF THE HEADER FOR THE RESULT ARRAY
"RTN","MAGSIXG2",36,0)
 ;;  #   Header              Data Description
"RTN","MAGSIXG2",37,0)
 ;;---   --------------      --------------------------------------
"RTN","MAGSIXG2",38,0)
 ;;  1 ^ Item~S2           ^ Sequential number
"RTN","MAGSIXG2",39,0)
 ;;  2 ^ Site              ^
"RTN","MAGSIXG2",40,0)
 ;;  3 ^ Note Title~~W0    ^ *
"RTN","MAGSIXG2",41,0)
 ;;  4 ^ Proc DT~S1        ^ Procedure date
"RTN","MAGSIXG2",42,0)
 ;;  5 ^ Procedure         ^ Procedure
"RTN","MAGSIXG2",43,0)
 ;;  6 ^ # Img~S2          ^ Number of images
"RTN","MAGSIXG2",44,0)
 ;;  7 ^ Short Desc        ^
"RTN","MAGSIXG2",45,0)
 ;;  8 ^ Pkg               ^ PACKAGE INDEX (40) - Internal
"RTN","MAGSIXG2",46,0)
 ;;  9 ^ Class             ^ CLASS INDEX (41) - External
"RTN","MAGSIXG2",47,0)
 ;; 10 ^ Type              ^ TYPE INDEX (42) - External
"RTN","MAGSIXG2",48,0)
 ;; 11 ^ Specialty         ^ SPEC/SUBSPEC INDEX (44) - External
"RTN","MAGSIXG2",49,0)
 ;; 12 ^ Event             ^ PROC/EVENT INDEX (43) - External
"RTN","MAGSIXG2",50,0)
 ;; 13 ^ Origin            ^ ORIGIN INDEX (45)
"RTN","MAGSIXG2",51,0)
 ;; 14 ^ Cap Dt~S1~W0      ^ Capture date
"RTN","MAGSIXG2",52,0)
 ;; 15 ^ Cap by~~W0        ^ User who captured the image
"RTN","MAGSIXG2",53,0)
 ;; 16 ^ Image ID~S2~W0    ^ Image IEN
"RTN","MAGSIXG2",54,0)
 ;
"RTN","MAGSIXG2",55,0)
 ; Notes
"RTN","MAGSIXG2",56,0)
 ; =====
"RTN","MAGSIXG2",57,0)
 ;
"RTN","MAGSIXG2",58,0)
 ; Only the second "^"-column is used to build the header; everything 
"RTN","MAGSIXG2",59,0)
 ; else is provided for documentation purposes.
"RTN","MAGSIXG2",60,0)
 ;
"RTN","MAGSIXG2",61,0)
 Q
"RTN","MAGSIXG2",62,0)
 ;
"RTN","MAGSIXG2",63,0)
 ;+++++ RETURNS DESCRIPTION OF THE IMAGE SELECTION CRITERIA
"RTN","MAGSIXG2",64,0)
 ;
"RTN","MAGSIXG2",65,0)
 ; .MAGFLT       Reference to a local variable that stores the image
"RTN","MAGSIXG2",66,0)
 ;               selection criteria
"RTN","MAGSIXG2",67,0)
 ;
"RTN","MAGSIXG2",68,0)
 ; FROMDATE      Date range
"RTN","MAGSIXG2",69,0)
 ; TODATE
"RTN","MAGSIXG2",70,0)
 ;
"RTN","MAGSIXG2",71,0)
 ; FLAGS         Flags that control the image selection
"RTN","MAGSIXG2",72,0)
 ; 
"RTN","MAGSIXG2",73,0)
 ; Return Values
"RTN","MAGSIXG2",74,0)
 ; =============
"RTN","MAGSIXG2",75,0)
 ;               Description of the image selection criteria.
"RTN","MAGSIXG2",76,0)
 ;
"RTN","MAGSIXG2",77,0)
FLTDESC(MAGFLT,FROMDATE,TODATE,FLAGS) ;
"RTN","MAGSIXG2",78,0)
 N BUF,DTRANGE,FLT,TMP
"RTN","MAGSIXG2",79,0)
 S FLT=""
"RTN","MAGSIXG2",80,0)
 ;
"RTN","MAGSIXG2",81,0)
 ;--- Package
"RTN","MAGSIXG2",82,0)
 S:$G(MAGFLT("PKG"))'="" FLT=FLT_"Pkg: "_MAGFLT("PKG")_" - "
"RTN","MAGSIXG2",83,0)
 ;
"RTN","MAGSIXG2",84,0)
 ;--- Class
"RTN","MAGSIXG2",85,0)
 I $G(MAGFLT("CLS"))'=""  D  S FLT=FLT_"Class: "_BUF_" - "
"RTN","MAGSIXG2",86,0)
 . S BUF=MAGFLT("CLS")
"RTN","MAGSIXG2",87,0)
 . I BUF="ADMIN^ADMIN/CLIN^CLIN/ADMIN"  S BUF="ADMIN"  Q
"RTN","MAGSIXG2",88,0)
 . I BUF="CLIN^CLIN/ADMIN^ADMIN/CLIN"   S BUF="CLIN"   Q
"RTN","MAGSIXG2",89,0)
 . Q
"RTN","MAGSIXG2",90,0)
 ;
"RTN","MAGSIXG2",91,0)
 S:$G(MAGFLT("TYPE"))'="" FLT=FLT_"Type: "_MAGFLT("TYPE")_" - "
"RTN","MAGSIXG2",92,0)
 S:$G(MAGFLT("SPEC"))'="" FLT=FLT_"Spec: "_MAGFLT("SPEC")_" - "
"RTN","MAGSIXG2",93,0)
 S:$G(MAGFLT("EVT"))'="" FLT=FLT_"Event: "_MAGFLT("EVT")_" - "
"RTN","MAGSIXG2",94,0)
 S:$G(MAGFLT("ORIG"))'="" FLT=FLT_"Origin: "_MAGFLT("ORIG")_" - "
"RTN","MAGSIXG2",95,0)
 S:$G(MAGFLT("GDESC"))'="" FLT=FLT_"Descr: '"_MAGFLT("GDESC")_"' - "
"RTN","MAGSIXG2",96,0)
 ;
"RTN","MAGSIXG2",97,0)
 ;--- Image status
"RTN","MAGSIXG2",98,0)
 S:$G(MAGFLT("ISTAT"))'="" FLT=FLT_"Status: "_MAGFLT("ISTAT")_" - "
"RTN","MAGSIXG2",99,0)
 ;
"RTN","MAGSIXG2",100,0)
 ;--- Controlled image
"RTN","MAGSIXG2",101,0)
 S:$G(MAGFLT("SENSIMG"))'="" FLT=FLT_"Controlled: "_MAGFLT("SENSIMG")_" - "
"RTN","MAGSIXG2",102,0)
 ;
"RTN","MAGSIXG2",103,0)
 ;--- Capture application
"RTN","MAGSIXG2",104,0)
 S:$G(MAGFLT("CAPTAPP"))'="" FLT=FLT_"App: "_MAGFLT("CAPTAPP")_" - "
"RTN","MAGSIXG2",105,0)
 ;
"RTN","MAGSIXG2",106,0)
 ;--- Date Range
"RTN","MAGSIXG2",107,0)
 S DTRANGE=""
"RTN","MAGSIXG2",108,0)
 S:FROMDATE'="" DTRANGE=DTRANGE_" from "_FROMDATE
"RTN","MAGSIXG2",109,0)
 S:TODATE'="" DTRANGE=DTRANGE_" to "_TODATE
"RTN","MAGSIXG2",110,0)
 ;
"RTN","MAGSIXG2",111,0)
 ;--- Percentage of sparse subset
"RTN","MAGSIXG2",112,0)
 S BUF="",TMP=+$G(MAGFLT("SUBSET%"))
"RTN","MAGSIXG2",113,0)
 S:TMP>0 BUF=$S(TMP<1:"0"_TMP,1:TMP)_"% of "
"RTN","MAGSIXG2",114,0)
 ;
"RTN","MAGSIXG2",115,0)
 ;--- Control flags
"RTN","MAGSIXG2",116,0)
 I FLT="",DTRANGE=""  S BUF=BUF_"all "
"RTN","MAGSIXG2",117,0)
 S:FLAGS["E" BUF=BUF_"existing "
"RTN","MAGSIXG2",118,0)
 S:FLAGS["D" BUF=BUF_$S(FLAGS["E":"and ",1:"")_"deleted "
"RTN","MAGSIXG2",119,0)
 S FLT=FLT_$$SNTC^MAGUTL05(BUF)_"images"
"RTN","MAGSIXG2",120,0)
 ;
"RTN","MAGSIXG2",121,0)
 ;--- User who captured the images
"RTN","MAGSIXG2",122,0)
 S BUF=$G(MAGFLT("SAVEDBY"))
"RTN","MAGSIXG2",123,0)
 S:BUF>0 FLT=FLT_" captured by "_$P(BUF,U,2)
"RTN","MAGSIXG2",124,0)
 ;
"RTN","MAGSIXG2",125,0)
 ;--- Append the date range
"RTN","MAGSIXG2",126,0)
 S FLT=FLT_DTRANGE
"RTN","MAGSIXG2",127,0)
 S:FLAGS["C" FLT=FLT_" (capture date range)"
"RTN","MAGSIXG2",128,0)
 ;
"RTN","MAGSIXG2",129,0)
 ;---
"RTN","MAGSIXG2",130,0)
 Q $TR(FLT,"^",",")
"RTN","MAGSIXG2",131,0)
 ;
"RTN","MAGSIXG2",132,0)
MISCDEFS ;+++++ DEFINITIONS OF MISCELLANEOUS PARAMETERS
"RTN","MAGSIXG2",133,0)
 ;;==================================================================
"RTN","MAGSIXG2",134,0)
 ;;| Parameter  | File  |Field|Type |Flags|        Comment          |
"RTN","MAGSIXG2",135,0)
 ;;|------------+-------+-----+-----+-----+-------------------------|
"RTN","MAGSIXG2",136,0)
 ;;|CAPTAPP     |       |  8.1| S   |     | CAPTURE APPLICATION     |
"RTN","MAGSIXG2",137,0)
 ;;|CPTCODE     |       |     |     |     | CPT CODE                |
"RTN","MAGSIXG2",138,0)
 ;;|GDESC       |       | 10  |     |     | SHORT DESCRIPTION       |
"RTN","MAGSIXG2",139,0)
 ;;|IDFN        |       |  5  | P   |     | Patient IEN (DFN)       |
"RTN","MAGSIXG2",140,0)
 ;;|ISTAT       |       |113  | S   |     | STATUS                  |
"RTN","MAGSIXG2",141,0)
 ;;|IXCLASS     |       |     | P   |     | CLASS INDEX             |
"RTN","MAGSIXG2",142,0)
 ;;|IXORIGIN    |       | 45  | S   |     | ORIGIN INDEX            |
"RTN","MAGSIXG2",143,0)
 ;;|IXPKG       |       | 40  | S   |     | PACKAGE INDEX           |
"RTN","MAGSIXG2",144,0)
 ;;|IXPROC      |       | 43  | P   |     | PROC/EVENT INDEX        |
"RTN","MAGSIXG2",145,0)
 ;;|IXSPEC      |       | 44  | P   |     | SPEC/SUBSPEC INDEX      |
"RTN","MAGSIXG2",146,0)
 ;;|IXTYPE      |       | 42  | P   |     | TYPE INDEX              |
"RTN","MAGSIXG2",147,0)
 ;;|MODALITY    |       |     |     |     | MODALITY                |
"RTN","MAGSIXG2",148,0)
 ;;|SAVEDBY     |       |  8  | P   |     | Who captured (DUZ)      |
"RTN","MAGSIXG2",149,0)
 ;;|SENSIMG     |       |112  | S   |     | CONTROLLED IMAGE        |
"RTN","MAGSIXG2",150,0)
 ;;==================================================================
"RTN","MAGSIXG2",151,0)
 ;
"RTN","MAGSIXG2",152,0)
 ; Notes
"RTN","MAGSIXG2",153,0)
 ; =====
"RTN","MAGSIXG2",154,0)
 ;
"RTN","MAGSIXG2",155,0)
 ; File numbers are not included to disable automatic validation.
"RTN","MAGSIXG2",156,0)
 ;
"RTN","MAGSIXG2",157,0)
 Q
"RTN","MAGSIXG2",158,0)
 ;
"RTN","MAGSIXG2",159,0)
 ;+++++ VALIDATES MISCELLANEOUS PARAMETERS
"RTN","MAGSIXG2",160,0)
 ;
"RTN","MAGSIXG2",161,0)
 ; .MISC         Reference to a local variable that stores the tree
"RTN","MAGSIXG2",162,0)
 ;               of miscellaneous RPC parameters
"RTN","MAGSIXG2",163,0)
 ;
"RTN","MAGSIXG2",164,0)
 ; .MAGFLT       Reference to a local variable where the image
"RTN","MAGSIXG2",165,0)
 ;               selection criteria is constructed.
"RTN","MAGSIXG2",166,0)
 ; 
"RTN","MAGSIXG2",167,0)
 ; Return Values
"RTN","MAGSIXG2",168,0)
 ; =============
"RTN","MAGSIXG2",169,0)
 ;           <0  Error code
"RTN","MAGSIXG2",170,0)
 ;            0  Success
"RTN","MAGSIXG2",171,0)
 ;
"RTN","MAGSIXG2",172,0)
VALMISC(MISC,MAGFLT) ;
"RTN","MAGSIXG2",173,0)
 N ERROR,FLAGS,PNODE,RC,VAL
"RTN","MAGSIXG2",174,0)
 S ERROR=0
"RTN","MAGSIXG2",175,0)
 ;--- Patient IEN (DFN)
"RTN","MAGSIXG2",176,0)
 S PNODE=$NA(MISC("IDFN")),VAL=$P($G(@PNODE),U)
"RTN","MAGSIXG2",177,0)
 I VAL'=""  D
"RTN","MAGSIXG2",178,0)
 . I +VAL'=VAL  S ERROR=$$IPVE^MAGUERR("VAL",PNODE)  Q
"RTN","MAGSIXG2",179,0)
 . I '($D(^DPT(VAL,0))#2)  S ERROR=$$ERROR^MAGUERR(-5,,VAL)  Q
"RTN","MAGSIXG2",180,0)
 . S MAGFLT("IDFN")=VAL
"RTN","MAGSIXG2",181,0)
 . Q
"RTN","MAGSIXG2",182,0)
 E  S MAGFLT("IDFN")=""
"RTN","MAGSIXG2",183,0)
 ;--- User IEN (DUZ)
"RTN","MAGSIXG2",184,0)
 S PNODE=$NA(MISC("SAVEDBY")),VAL=$P($G(@PNODE),U)
"RTN","MAGSIXG2",185,0)
 I VAL'=""  D
"RTN","MAGSIXG2",186,0)
 . N NAME
"RTN","MAGSIXG2",187,0)
 . I +VAL'=VAL  S ERROR=$$IPVE^MAGUERR("VAL",PNODE)  Q
"RTN","MAGSIXG2",188,0)
 . S NAME=$$NAME^XUSER(VAL,"F")
"RTN","MAGSIXG2",189,0)
 . I NAME=""  S ERROR=$$IPVE^MAGUERR("VAL",PNODE)  Q
"RTN","MAGSIXG2",190,0)
 . S MAGFLT("SAVEDBY")=VAL_U_NAME
"RTN","MAGSIXG2",191,0)
 . Q
"RTN","MAGSIXG2",192,0)
 E  S MAGFLT("SAVEDBY")=""
"RTN","MAGSIXG2",193,0)
 ;--- Capture application
"RTN","MAGSIXG2",194,0)
 S VAL=$G(MISC("CAPTAPP"))
"RTN","MAGSIXG2",195,0)
 S RC=$$VALCNLST^MAGUTL06(VAL,2005,8.1,$NA(MAGFLT("CAPTAPP")))
"RTN","MAGSIXG2",196,0)
 I RC  D:RC>0 ERROR^MAGUERR(-42,,$P(VAL,U,RC))  S ERROR=1
"RTN","MAGSIXG2",197,0)
 ;--- Short description
"RTN","MAGSIXG2",198,0)
 S VAL=$G(MISC("GDESC"))
"RTN","MAGSIXG2",199,0)
 S:VAL'="" MAGFLT("GDESC")=$$UP^XLFSTR(VAL)
"RTN","MAGSIXG2",200,0)
 ;--- Status
"RTN","MAGSIXG2",201,0)
 S VAL=$G(MISC("ISTAT"))
"RTN","MAGSIXG2",202,0)
 S RC=$$VALCNLST^MAGUTL06(VAL,2005,113,$NA(MAGFLT("ISTAT")),"Z")
"RTN","MAGSIXG2",203,0)
 I RC  D:RC>0 ERROR^MAGUERR(-31,,$P(VAL,U,RC))  S ERROR=1
"RTN","MAGSIXG2",204,0)
 ;--- Controlled image
"RTN","MAGSIXG2",205,0)
 S VAL=$G(MISC("SENSIMG"))
"RTN","MAGSIXG2",206,0)
 S RC=$$VALCNLST^MAGUTL06(VAL,2005,112,$NA(MAGFLT("SENSIMG")))
"RTN","MAGSIXG2",207,0)
 I RC  D:RC>0 ERROR^MAGUERR(-32,,$P(VAL,U,RC))  S ERROR=1
"RTN","MAGSIXG2",208,0)
 ;--- Package
"RTN","MAGSIXG2",209,0)
 S VAL=$G(MISC("IXPKG"))
"RTN","MAGSIXG2",210,0)
 S RC=$$VALCNLST^MAGUTL06(VAL,2005,40,$NA(MAGFLT("PKG")))
"RTN","MAGSIXG2",211,0)
 I RC  D:RC>0 ERROR^MAGUERR(-11,,$P(VAL,U,RC))  S ERROR=1
"RTN","MAGSIXG2",212,0)
 ;--- Class
"RTN","MAGSIXG2",213,0)
 S VAL=$G(MISC("IXCLASS"))
"RTN","MAGSIXG2",214,0)
 S RC=$$VALPNLST^MAGUTL06(VAL,2005.82,$NA(MAGFLT("CLS")),"C")
"RTN","MAGSIXG2",215,0)
 I RC  D:RC>0 ERROR^MAGUERR(-12,,$P(VAL,U,RC))  S ERROR=1
"RTN","MAGSIXG2",216,0)
 ;--- Type
"RTN","MAGSIXG2",217,0)
 S VAL=$G(MISC("IXTYPE"))
"RTN","MAGSIXG2",218,0)
 S RC=$$VALPNLST^MAGUTL06(VAL,2005.83,$NA(MAGFLT("TYPE")),"C")
"RTN","MAGSIXG2",219,0)
 I RC  D:RC>0 ERROR^MAGUERR(-13,,$P(VAL,U,RC))  S ERROR=1
"RTN","MAGSIXG2",220,0)
 ;--- Event
"RTN","MAGSIXG2",221,0)
 S VAL=$G(MISC("IXPROC"))
"RTN","MAGSIXG2",222,0)
 S RC=$$VALPNLST^MAGUTL06(VAL,2005.85,$NA(MAGFLT("EVT")),"C")
"RTN","MAGSIXG2",223,0)
 I RC  D:RC>0 ERROR^MAGUERR(-14,,$P(VAL,U,RC))  S ERROR=1
"RTN","MAGSIXG2",224,0)
 ;--- Origin
"RTN","MAGSIXG2",225,0)
 S VAL=$G(MISC("IXORIGIN"))
"RTN","MAGSIXG2",226,0)
 S RC=$$VALCNLST^MAGUTL06(VAL,2005,45,$NA(MAGFLT("ORIG")))
"RTN","MAGSIXG2",227,0)
 I RC  D:RC>0 ERROR^MAGUERR(-15,,$P(VAL,U,RC))  S ERROR=1
"RTN","MAGSIXG2",228,0)
 ;--- Specialty (patch 59: for capture we don't want subspecialties)
"RTN","MAGSIXG2",229,0)
 S FLAGS=$S('$D(MAGJOB("CAPTURE")):"S",1:"")
"RTN","MAGSIXG2",230,0)
 S VAL=$G(MISC("IXSPEC"))
"RTN","MAGSIXG2",231,0)
 S RC=$$VALSPECS(VAL,$NA(MAGFLT("SPEC")),FLAGS)
"RTN","MAGSIXG2",232,0)
 I RC  D:RC>0 ERROR^MAGUERR(-16,,$P(VAL,U,RC))  S ERROR=1
"RTN","MAGSIXG2",233,0)
 ;--- CPT Code
"RTN","MAGSIXG2",234,0)
 S VAL=$G(MISC("CPTCODE"))
"RTN","MAGSIXG2",235,0)
 S RC=$$VALCNLST^MAGUTL06(VAL,71,9,$NA(MAGFLT("CPTCODE")))
"RTN","MAGSIXG2",236,0)
 I RC  D:RC>0 ERROR^MAGUERR(-15,,$P(VAL,U,RC))  S ERROR=1
"RTN","MAGSIXG2",237,0)
 ;--- Modality
"RTN","MAGSIXG2",238,0)
 S VAL=$G(MISC("MODALITY"))
"RTN","MAGSIXG2",239,0)
 S RC=$$VALCNLST^MAGUTL06(VAL,2005,6,$NA(MAGFLT("MODALITY")))
"RTN","MAGSIXG2",240,0)
 I RC  D:RC>0 ERROR^MAGUERR(-15,,$P(VAL,U,RC))  S ERROR=1
"RTN","MAGSIXG2",241,0)
 ;---
"RTN","MAGSIXG2",242,0)
 Q $S(ERROR:-30,1:0)
"RTN","MAGSIXG2",243,0)
 ;
"RTN","MAGSIXG2",244,0)
 ;+++++ VALIDATES THE LIST OF SPECIALTIES
"RTN","MAGSIXG2",245,0)
VALSPECS(PTNMLIST,MAG8NODE,FLAGS) ;
"RTN","MAGSIXG2",246,0)
 N IEN,RC,SPIEN,XREF
"RTN","MAGSIXG2",247,0)
 S RC=$$VALPNLST^MAGUTL06(PTNMLIST,2005.84,MAG8NODE,"C")  Q:RC RC
"RTN","MAGSIXG2",248,0)
 Q:$G(FLAGS)'["S" 0
"RTN","MAGSIXG2",249,0)
 ;--- Add subspecialties if requested
"RTN","MAGSIXG2",250,0)
 S XREF=$$ROOT^DILFD(2005.84,,1),XREF=$NA(@XREF@("ASPEC"))
"RTN","MAGSIXG2",251,0)
 S SPIEN=""
"RTN","MAGSIXG2",252,0)
 F  S SPIEN=$O(@MAG8NODE@(SPIEN))  Q:SPIEN=""  D:$D(@XREF@(SPIEN))
"RTN","MAGSIXG2",253,0)
 . S IEN=""
"RTN","MAGSIXG2",254,0)
 . F  S IEN=$O(@XREF@(SPIEN,IEN))  Q:IEN=""  S @MAG8NODE@(IEN)=""
"RTN","MAGSIXG2",255,0)
 . Q
"RTN","MAGSIXG2",256,0)
 ;--- Success
"RTN","MAGSIXG2",257,0)
 Q 0
"RTN","MAGSIXG3")
0^13^B109262683
"RTN","MAGSIXG3",1,0)
MAGSIXG3 ;WOIFO/SG/NST - LIST OF IMAGES RPCS (CALLBACK) ; NOV 20, 2018@3:52pm
"RTN","MAGSIXG3",2,0)
 ;;3.0;IMAGING;**93,117,150,138,167,221**;Mar 19, 2002;Build 30
"RTN","MAGSIXG3",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGSIXG3",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGSIXG3",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGSIXG3",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGSIXG3",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGSIXG3",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGSIXG3",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGSIXG3",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGSIXG3",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGSIXG3",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGSIXG3",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGSIXG3",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGSIXG3",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGSIXG3",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGSIXG3",17,0)
 ;;
"RTN","MAGSIXG3",18,0)
 ;
"RTN","MAGSIXG3",19,0)
 ; This routine uses the following ICRs:
"RTN","MAGSIXG3",20,0)
 ;
"RTN","MAGSIXG3",21,0)
 ; #3268         Read file #8925 (controlled)
"RTN","MAGSIXG3",22,0)
 ; #10060        Read file #200 (supported)
"RTN","MAGSIXG3",23,0)
 ; #2321         Read file #8925.1 (controlled)
"RTN","MAGSIXG3",24,0)
 ; #2937         Read file #8925 (controlled)
"RTN","MAGSIXG3",25,0)
 ;
"RTN","MAGSIXG3",26,0)
 ; LOCAL VARIABLE ------ DESCRIPTION
"RTN","MAGSIXG3",27,0)
 ;
"RTN","MAGSIXG3",28,0)
 ; MAGDATA               See the ^MAGSIXG4.
"RTN","MAGSIXG3",29,0)
 ;
"RTN","MAGSIXG3",30,0)
 ; TEMPORARY GLOBAL ---- DESCRIPTION
"RTN","MAGSIXG3",31,0)
 ;
"RTN","MAGSIXG3",32,0)
 ; ^TMP("MAGSIXG3",$J)   See the ^MAGSIXG4.
"RTN","MAGSIXG3",33,0)
 ;
"RTN","MAGSIXG3",34,0)
 Q
"RTN","MAGSIXG3",35,0)
 ;
"RTN","MAGSIXG3",36,0)
 ;+++++ APPENDS THE IMAGE ENTRY TO THE RPC RESULT ARRAY
"RTN","MAGSIXG3",37,0)
 ;
"RTN","MAGSIXG3",38,0)
 ; IMGIEN        IEN of the image record in file #2005 or #2005.1
"RTN","MAGSIXG3",39,0)
 ;
"RTN","MAGSIXG3",40,0)
 ; DATA          First half ("|"-piece) of the result item
"RTN","MAGSIXG3",41,0)
 ;
"RTN","MAGSIXG3",42,0)
 ; GRPCNTS       Group counts (result of the $$GRPCT^MAGGI14)
"RTN","MAGSIXG3",43,0)
 ;
"RTN","MAGSIXG3",44,0)
 ; FLAGS         Control flags for the $$INFO^MAGGAII
"RTN","MAGSIXG3",45,0)
 ;
"RTN","MAGSIXG3",46,0)
 ; Input Variables
"RTN","MAGSIXG3",47,0)
 ; ===============
"RTN","MAGSIXG3",48,0)
 ;   MAGDATA
"RTN","MAGSIXG3",49,0)
 ;
"RTN","MAGSIXG3",50,0)
 ; Output Variables
"RTN","MAGSIXG3",51,0)
 ; ================
"RTN","MAGSIXG3",52,0)
 ;   MAGDATA, MAGOUT
"RTN","MAGSIXG3",53,0)
 ;
"RTN","MAGSIXG3",54,0)
 ; Return Values
"RTN","MAGSIXG3",55,0)
 ; =============
"RTN","MAGSIXG3",56,0)
 ;           <0  Error descriptor (see the $$ERROR^MAGUERR)
"RTN","MAGSIXG3",57,0)
 ;            0  Success
"RTN","MAGSIXG3",58,0)
 ;
"RTN","MAGSIXG3",59,0)
APPEND(IMGIEN,DATA,GRPCNTS,FLAGS) ;
"RTN","MAGSIXG3",60,0)
 N IMGINFO,X
"RTN","MAGSIXG3",61,0)
 ;
"RTN","MAGSIXG3",62,0)
 ;--- Get the internal image data
"RTN","MAGSIXG3",63,0)
 S IMGINFO=$$INFO^MAGGAII(IMGIEN,FLAGS,GRPCNTS)
"RTN","MAGSIXG3",64,0)
 Q:IMGINFO<0 IMGINFO
"RTN","MAGSIXG3",65,0)
 S $P(DATA,U,2)=$P(IMGINFO,U,16)  ; Site Code
"RTN","MAGSIXG3",66,0)
 S $P(DATA,U,6)=$P(IMGINFO,U,14)  ; Number of images in the group
"RTN","MAGSIXG3",67,0)
 S $P(DATA,U,16)=$P(IMGINFO,U)    ; Image ID (IEN)
"RTN","MAGSIXG3",68,0)
 ;
"RTN","MAGSIXG3",69,0)
 ;--- Append the image data to the result array
"RTN","MAGSIXG3",70,0)
 S MAGDATA("RESCNT")=$G(MAGDATA("RESCNT"))+1
"RTN","MAGSIXG3",71,0)
 S $P(DATA,U)=MAGDATA("RESCNT")
"RTN","MAGSIXG3",72,0)
 S @MAGDATA@(MAGDATA("RESCNT")+1)=DATA_U_"|"_IMGINFO
"RTN","MAGSIXG3",73,0)
 Q:MAGDATA("RESCNT")<76 0  Q:MAGDATA["^" 0
"RTN","MAGSIXG3",74,0)
 ;
"RTN","MAGSIXG3",75,0)
 ;--- Image count is getting big, switch from
"RTN","MAGSIXG3",76,0)
 ;--- a local array to a global node
"RTN","MAGSIXG3",77,0)
 S MAGDATA=$NA(^TMP("MAGSIXG1",$J))
"RTN","MAGSIXG3",78,0)
 K @MAGDATA  M @MAGDATA=MAGOUT
"RTN","MAGSIXG3",79,0)
 S X=$$RTRNFMT^XWBLIB("GLOBAL ARRAY",1)
"RTN","MAGSIXG3",80,0)
 K MAGOUT  S MAGOUT=MAGDATA
"RTN","MAGSIXG3",81,0)
 Q 0
"RTN","MAGSIXG3",82,0)
 ;
"RTN","MAGSIXG3",83,0)
 ;+++++ PERFORMS SPECIAL CONVERSION OF THE DATE/TIME
"RTN","MAGSIXG3",84,0)
DTE(DTI) ;
"RTN","MAGSIXG3",85,0)
 N X  S X=$$FMTE^XLFDT(DTI,"5Z")
"RTN","MAGSIXG3",86,0)
 Q $P(X,"@")_" "_$S($P(X,"@",2)'="":$P(X,"@",2),1:"00:01")
"RTN","MAGSIXG3",87,0)
 ;
"RTN","MAGSIXG3",88,0)
 ;+++++ CALLBACK FUNCTION FOR IMAGE QUERY
"RTN","MAGSIXG3",89,0)
 ;
"RTN","MAGSIXG3",90,0)
 ; IMGIEN        IEN of the image record (file #2005 or #2005.1)
"RTN","MAGSIXG3",91,0)
 ;
"RTN","MAGSIXG3",92,0)
 ; FLAGS         Parameters passed into the image query API
"RTN","MAGSIXG3",93,0)
 ; .MAGDATA      ($$QUERY^MAGGI13). See the GETIMGS^MAGSIXG1
"RTN","MAGSIXG3",94,0)
 ;               for details.
"RTN","MAGSIXG3",95,0)
 ;
"RTN","MAGSIXG3",96,0)
 ; Input Variables
"RTN","MAGSIXG3",97,0)
 ; ===============
"RTN","MAGSIXG3",98,0)
 ;   MAGJOB, MAGOUT
"RTN","MAGSIXG3",99,0)
 ;
"RTN","MAGSIXG3",100,0)
 ; Output Variables
"RTN","MAGSIXG3",101,0)
 ; ================
"RTN","MAGSIXG3",102,0)
 ;   MAGJOB, MAGOUT, ^TMP("MAGSIXG3",$J,...)
"RTN","MAGSIXG3",103,0)
 ;
"RTN","MAGSIXG3",104,0)
 ; Return Values
"RTN","MAGSIXG3",105,0)
 ; =============
"RTN","MAGSIXG3",106,0)
 ;           <0  Error descriptor (see the $$ERROR^MAGUERR)
"RTN","MAGSIXG3",107,0)
 ;            0  Continue
"RTN","MAGSIXG3",108,0)
 ;           >0  Terminate the query
"RTN","MAGSIXG3",109,0)
 ;
"RTN","MAGSIXG3",110,0)
QRYCBK(IMGIEN,FLAGS,MAGDATA) ;
"RTN","MAGSIXG3",111,0)
 N FLTX,IIFLAGS,GRPCNTS,PTIEN,RC
"RTN","MAGSIXG3",112,0)
 ;
"RTN","MAGSIXG3",113,0)
 S RC=$$FILTER(.FLTX,.GRPCNTS,.PTIEN,IMGIEN,FLAGS,.MAGDATA) ; Apply filter 
"RTN","MAGSIXG3",114,0)
 Q:'RC 0  ; Filter is not matched
"RTN","MAGSIXG3",115,0)
 ;
"RTN","MAGSIXG3",116,0)
 Q:RC=2 1  ; Terminate the query when maximum number of records is reached
"RTN","MAGSIXG3",117,0)
 ;
"RTN","MAGSIXG3",118,0)
 ;=== Flags for $$INFO^MAGGAII
"RTN","MAGSIXG3",119,0)
 S IIFLAGS=$$TRFLAGS^MAGUTL05(FLAGS,"DE")
"RTN","MAGSIXG3",120,0)
 ;
"RTN","MAGSIXG3",121,0)
 ;=== Sparse subset query does not append image entries to the result 
"RTN","MAGSIXG3",122,0)
 ;    array right away. It saves them to the temporary buffers in the
"RTN","MAGSIXG3",123,0)
 ;    ^TMP("MAGSIXG3",$J) global node instead. After all images are
"RTN","MAGSIXG3",124,0)
 ;    preselected, the $$SUBSET^MAGSIXG4 processes those buffers and
"RTN","MAGSIXG3",125,0)
 ;=== appends required number of image entries to the result array.
"RTN","MAGSIXG3",126,0)
 I MAGDATA("FLAGS")["S"  S RC=0  D  Q $S(RC<0:RC,1:0)
"RTN","MAGSIXG3",127,0)
 . N I,TCNT,X
"RTN","MAGSIXG3",128,0)
 . S (MAGDATA("TCNT"),TCNT)=$G(MAGDATA("TCNT"))+1
"RTN","MAGSIXG3",129,0)
 . ;--- If the image is associated with the same patient as the
"RTN","MAGSIXG3",130,0)
 . ;--- previous one, save it in the regular temporary buffer.
"RTN","MAGSIXG3",131,0)
 . I PTIEN=$G(MAGDATA("PREVPT")) D  Q
"RTN","MAGSIXG3",132,0)
 . . S I=$O(^TMP("MAGSIXG3",$J,"R",""),-1)+1
"RTN","MAGSIXG3",133,0)
 . . S ^TMP("MAGSIXG3",$J,"R",I)=TCNT_"|"_IMGIEN_"|"_GRPCNTS
"RTN","MAGSIXG3",134,0)
 . . S ^TMP("MAGSIXG3",$J,"R",I,0)=FLTX
"RTN","MAGSIXG3",135,0)
 . . Q
"RTN","MAGSIXG3",136,0)
 . ;--- If the image is associated with a different patient, remember
"RTN","MAGSIXG3",137,0)
 . ;--- the new DFN and store the image into the "priority" buffer.
"RTN","MAGSIXG3",138,0)
 . S MAGDATA("PREVPT")=PTIEN
"RTN","MAGSIXG3",139,0)
 . S ^TMP("MAGSIXG3",$J,"P",TCNT)=TCNT_"|"_IMGIEN_"|"_GRPCNTS
"RTN","MAGSIXG3",140,0)
 . S ^TMP("MAGSIXG3",$J,"P",TCNT,0)=FLTX
"RTN","MAGSIXG3",141,0)
 . ;--- If the image that precedes the patient change is not in the
"RTN","MAGSIXG3",142,0)
 . ;--- "priority" buffer yet, move it there from the regular buffer.
"RTN","MAGSIXG3",143,0)
 . S X=TCNT-1  Q:$D(^TMP("MAGSIXG3",$J,"P",X))
"RTN","MAGSIXG3",144,0)
 . S I=$O(^TMP("MAGSIXG3",$J,"R",""),-1)  Q:I=""
"RTN","MAGSIXG3",145,0)
 . I $P(^TMP("MAGSIXG3",$J,"R",I),"|")'=X  D  Q
"RTN","MAGSIXG3",146,0)
 . . S RC=$$ERROR^MAGUERR(-47)  ; This should never happen!
"RTN","MAGSIXG3",147,0)
 . . Q
"RTN","MAGSIXG3",148,0)
 . M ^TMP("MAGSIXG3",$J,"P",X)=^TMP("MAGSIXG3",$J,"R",I)
"RTN","MAGSIXG3",149,0)
 . K ^TMP("MAGSIXG3",$J,"R",I)
"RTN","MAGSIXG3",150,0)
 . Q
"RTN","MAGSIXG3",151,0)
 ;
"RTN","MAGSIXG3",152,0)
 ;=== Append the image item to the result array
"RTN","MAGSIXG3",153,0)
 S RC=$$APPEND(IMGIEN,FLTX,GRPCNTS,IIFLAGS)  Q:RC<0 RC
"RTN","MAGSIXG3",154,0)
 ;
"RTN","MAGSIXG3",155,0)
 ;=== Success
"RTN","MAGSIXG3",156,0)
 Q 0
"RTN","MAGSIXG3",157,0)
 ;
"RTN","MAGSIXG3",158,0)
 ;+++++ RETURNS THE NOTE TITLE
"RTN","MAGSIXG3",159,0)
RPTITLE(FILE,IEN) ;
"RTN","MAGSIXG3",160,0)
 N TITLE,TMP
"RTN","MAGSIXG3",161,0)
 I FILE=8925,IEN>0  D  S TITLE=$P($G(^TIU(8925.1,TMP,0)),U)  ; IA #2321
"RTN","MAGSIXG3",162,0)
 . S TMP=+$P($G(^TIU(8925,+IEN,0)),U)   ; IA #2937
"RTN","MAGSIXG3",163,0)
 . Q
"RTN","MAGSIXG3",164,0)
 Q $S($G(TITLE)'="":TITLE,1:"   ")
"RTN","MAGSIXG3",165,0)
 ;
"RTN","MAGSIXG3",166,0)
MODALITY(IMGIEN)  ; Get Image modality
"RTN","MAGSIXG3",167,0)
 N G,M,P,MAGFILD,MAGFILG,X
"RTN","MAGSIXG3",168,0)
 S MAGFILD=$$FILE^MAGGI11(IMGIEN)
"RTN","MAGSIXG3",169,0)
 S X=$S(MAGFILD:$G(^MAG(MAGFILD,IMGIEN,0)),1:"")
"RTN","MAGSIXG3",170,0)
 S G=+$P(X,"^",10) ;Group IEN
"RTN","MAGSIXG3",171,0)
 S M=$P(X,"^",8)   ;Procedure
"RTN","MAGSIXG3",172,0)
 S:$E(M,1,4)="RAD " M=$E(M,5,$L(M))
"RTN","MAGSIXG3",173,0)
 Q:M="" ""
"RTN","MAGSIXG3",174,0)
 S MAGFILG=$$FILE^MAGGI11(G)
"RTN","MAGSIXG3",175,0)
 S G=$S(MAGFILG:$P($G(^MAG(MAGFILG,G,2)),"^",6),1:"") ;Parent Data File# for Group IEN
"RTN","MAGSIXG3",176,0)
 S P=$S(MAGFILD:$P($G(^MAG(MAGFILD,IMGIEN,2)),"^",6),1:"") ;Parent Data File# for IEN
"RTN","MAGSIXG3",177,0)
 I P'=74,G'=74 Q ""  ;quit if not RAD/NUC MED REPORTS file (#74)
"RTN","MAGSIXG3",178,0)
 Q M
"RTN","MAGSIXG3",179,0)
 ;
"RTN","MAGSIXG3",180,0)
 ; Filter image based on filter data
"RTN","MAGSIXG3",181,0)
FILTER(FLTX,GRPCNTS,PTIEN,IMGIEN,FLAGS,MAGDATA) ;
"RTN","MAGSIXG3",182,0)
 N CAPTAPP,CLASS,EVT,GROUP,IMGNODE
"RTN","MAGSIXG3",183,0)
 N ORIG,PKG,SENSIMG,SKIP,SPEC,STATUS,TYPE
"RTN","MAGSIXG3",184,0)
 N CPTCODE,MODALITY
"RTN","MAGSIXG3",185,0)
 N X,X0,X01,X100,X2,X40
"RTN","MAGSIXG3",186,0)
 N MAGFOUND  ; temp loop flag
"RTN","MAGSIXG3",187,0)
 S FLTX=""
"RTN","MAGSIXG3",188,0)
 S IMGNODE=$$NODE^MAGGI11(IMGIEN)  Q:IMGNODE="" 0
"RTN","MAGSIXG3",189,0)
 ;=== Terminate the query when maximum number of records is reached
"RTN","MAGSIXG3",190,0)
 I MAGDATA("MAXNUM"),MAGDATA("RESCNT")'<MAGDATA("MAXNUM")  Q 2
"RTN","MAGSIXG3",191,0)
 ;
"RTN","MAGSIXG3",192,0)
 ;=== Skip, if a group member
"RTN","MAGSIXG3",193,0)
 S X0=$G(@IMGNODE@(0))
"RTN","MAGSIXG3",194,0)
 Q:$P(X0,U,10) 0         ; GROUP PARENT (14)
"RTN","MAGSIXG3",195,0)
 ;
"RTN","MAGSIXG3",196,0)
 ;=== Check who captured the image
"RTN","MAGSIXG3",197,0)
 S X2=$G(@IMGNODE@(2)),X=+$G(MAGDATA("SAVEDBY"))
"RTN","MAGSIXG3",198,0)
 I X  Q:$P(X2,U,2)'=X 0  ; IMAGE SAVE BY (8)
"RTN","MAGSIXG3",199,0)
 ;
"RTN","MAGSIXG3",200,0)
 ;=== Perform additional screening according to the image counts
"RTN","MAGSIXG3",201,0)
 S GRPCNTS=$$GRPCT^MAGGI14(IMGIEN)
"RTN","MAGSIXG3",202,0)
 S:GRPCNTS<0 GRPCNTS=""  ;??? Ignore errors
"RTN","MAGSIXG3",203,0)
 S GROUP=$$ISGRP^MAGGI11(IMGIEN)
"RTN","MAGSIXG3",204,0)
 S SKIP=0  D  Q:SKIP 0
"RTN","MAGSIXG3",205,0)
 . ;--- Check if the image entry references "child" images of
"RTN","MAGSIXG3",206,0)
 . ;    requested kind(s). Also, safeguard against a wrong object
"RTN","MAGSIXG3",207,0)
 . ;--- type in the group header.
"RTN","MAGSIXG3",208,0)
 . I $P(GRPCNTS,U,1)>0  S GROUP=1  Q:FLAGS["E"  ; Existing "children"
"RTN","MAGSIXG3",209,0)
 . I $P(GRPCNTS,U,2)>0  S GROUP=1  Q:FLAGS["D"  ; Deleted "children"
"RTN","MAGSIXG3",210,0)
 . ;--- Skip group headers that do not reference
"RTN","MAGSIXG3",211,0)
 . ;--- any "child" images of requested kind(s)
"RTN","MAGSIXG3",212,0)
 . I GROUP  S SKIP=1  Q
"RTN","MAGSIXG3",213,0)
 . ;--- If existing images are not requested, then
"RTN","MAGSIXG3",214,0)
 . ;--- skip existing standalone image entries
"RTN","MAGSIXG3",215,0)
 . I FLAGS'["E",'$$ISDEL^MAGGI11(IMGIEN) S SKIP=1 Q
"RTN","MAGSIXG3",216,0)
 . Q
"RTN","MAGSIXG3",217,0)
 ;
"RTN","MAGSIXG3",218,0)
 ;=== Load other data associated with the image
"RTN","MAGSIXG3",219,0)
 S X40=$G(@IMGNODE@(40)),X100=$G(@IMGNODE@(100))
"RTN","MAGSIXG3",220,0)
 S PTIEN=+$P(X0,U,7)      ; PATIENT (5)
"RTN","MAGSIXG3",221,0)
 S PKG=$P(X40,U)          ; PACKAGE INDEX (40)
"RTN","MAGSIXG3",222,0)
 S TYPE=$P(X40,U,3)       ; TYPE INDEX (42)
"RTN","MAGSIXG3",223,0)
 S EVT=$P(X40,U,4)        ; PROC/EVENT INDEX (43)
"RTN","MAGSIXG3",224,0)
 S SPEC=$P(X40,U,5)       ; SPEC/SUBSPEC INDEX (44)
"RTN","MAGSIXG3",225,0)
 S ORIG=$P(X40,U,6)       ; ORIGIN INDEX (45)
"RTN","MAGSIXG3",226,0)
 S:ORIG="" ORIG="V"       ; Show VA by default
"RTN","MAGSIXG3",227,0)
 S SENSIMG=+$P(X100,U,7)  ; CONTROLLED IMAGE (112)
"RTN","MAGSIXG3",228,0)
 S STATUS=$P(X100,U,8)    ; STATUS(113)
"RTN","MAGSIXG3",229,0)
 S CAPTAPP=$P(X2,U,12)    ; CAPTURE APPLICATION (8.1)
"RTN","MAGSIXG3",230,0)
 S CPTCODE=$$CPTCODE^MAGDQR21(IMGIEN)  ; CPT CODE
"RTN","MAGSIXG3",231,0)
 S MODALITY=$$MODALITY(IMGIEN)  ; Get Modality
"RTN","MAGSIXG3",232,0)
 ;
"RTN","MAGSIXG3",233,0)
 ; 150 T2 - if Group and Deleted and only 1 child: get Status of child.
"RTN","MAGSIXG3",234,0)
 I GROUP,$$ISDEL^MAGGI11(IMGIEN),$P(GRPCNTS,U,2)=1 D  ;
"RTN","MAGSIXG3",235,0)
 . S X=$O(^MAG(2005.1,"AGP",IMGIEN,""))
"RTN","MAGSIXG3",236,0)
 . I 'X Q
"RTN","MAGSIXG3",237,0)
 . S X=$P($G(^MAG(2005.1,X,100)),"^",8)
"RTN","MAGSIXG3",238,0)
 . I X S STATUS=X
"RTN","MAGSIXG3",239,0)
 . Q
"RTN","MAGSIXG3",240,0)
 ;=== Patch 150-  Status 13 is a Non Existant Image. Don't include in Image List.
"RTN","MAGSIXG3",241,0)
 I STATUS=13 Q 0  ;P150
"RTN","MAGSIXG3",242,0)
 ;=== Patch 59.  Treat Class as a computed field.
"RTN","MAGSIXG3",243,0)
 ;=== Arrange with Mike to change DB.
"RTN","MAGSIXG3",244,0)
 S CLASS=$S(TYPE:$P($G(^MAG(2005.83,+TYPE,0)),U,2),1:"")
"RTN","MAGSIXG3",245,0)
 I $D(MAGDATA("PKG")),PKG'=""    Q:'$D(MAGDATA("PKG",PKG)) 0
"RTN","MAGSIXG3",246,0)
 I $D(MAGDATA("ORIG")),ORIG'=""  Q:'$D(MAGDATA("ORIG",ORIG)) 0
"RTN","MAGSIXG3",247,0)
 I $D(MAGDATA("CLS")),CLASS'=""  Q:'$D(MAGDATA("CLS",CLASS)) 0
"RTN","MAGSIXG3",248,0)
 I $D(MAGDATA("TYPE")),TYPE      Q:'$D(MAGDATA("TYPE",TYPE)) 0
"RTN","MAGSIXG3",249,0)
 I $D(MAGDATA("CPTCODE")),CPTCODE="" Q 0
"RTN","MAGSIXG3",250,0)
 I $D(MAGDATA("MODALITY")),MODALITY="" Q 0
"RTN","MAGSIXG3",251,0)
 I $D(MAGDATA("CPTCODE")),CPTCODE'=""  Q:'$D(MAGDATA("CPTCODE",CPTCODE)) 0
"RTN","MAGSIXG3",252,0)
 I $D(MAGDATA("MODALITY")),MODALITY'=""  Q:'$D(MAGDATA("MODALITY",MODALITY)) 0
"RTN","MAGSIXG3",253,0)
 ;
"RTN","MAGSIXG3",254,0)
 I '(FLAGS["G") D  Q:'MAGFOUND 0  ; doesn't meet the criteria. One strike and you have to quit
"RTN","MAGSIXG3",255,0)
 . S MAGFOUND=1
"RTN","MAGSIXG3",256,0)
 . I $D(MAGDATA("ISTAT")),'$D(MAGDATA("ISTAT",+STATUS)) S MAGFOUND=0 Q
"RTN","MAGSIXG3",257,0)
 . Q
"RTN","MAGSIXG3",258,0)
 ;
"RTN","MAGSIXG3",259,0)
 I FLAGS["G" D  Q:'MAGFOUND 0  ; Quit. It doesn't meet the criteria
"RTN","MAGSIXG3",260,0)
 . S MAGFOUND=0
"RTN","MAGSIXG3",261,0)
 . I '$D(MAGDATA("ISTAT")) S MAGFOUND=1 Q  ;nothing to check. It means it is found
"RTN","MAGSIXG3",262,0)
 . ; Check for single images first
"RTN","MAGSIXG3",263,0)
 . I 'GROUP D  Q
"RTN","MAGSIXG3",264,0)
 . . I $D(MAGDATA("ISTAT",+STATUS)) S MAGFOUND=1  ; need this image
"RTN","MAGSIXG3",265,0)
 . . Q
"RTN","MAGSIXG3",266,0)
 . ;-- check all children in the group
"RTN","MAGSIXG3",267,0)
 . N CHI,CHIEN,CHNODE,CH100,CHSTATUS
"RTN","MAGSIXG3",268,0)
 . S CHI=0
"RTN","MAGSIXG3",269,0)
 . F  S CHI=$O(@IMGNODE@(1,CHI)) Q:CHI'>0  D  Q:MAGFOUND
"RTN","MAGSIXG3",270,0)
 . . S CHIEN=+$G(@IMGNODE@(1,CHI,0))
"RTN","MAGSIXG3",271,0)
 . . Q:CHIEN'>0
"RTN","MAGSIXG3",272,0)
 . . S CHNODE=$$NODE^MAGGI11(CHIEN) Q:CHNODE=""
"RTN","MAGSIXG3",273,0)
 . . S CH100=$G(@CHNODE@(100))
"RTN","MAGSIXG3",274,0)
 . . S CHSTATUS=$P(CH100,U,8)    ; STATUS(113)
"RTN","MAGSIXG3",275,0)
 . . I $D(MAGDATA("ISTAT",+CHSTATUS)) S MAGFOUND=1
"RTN","MAGSIXG3",276,0)
 . . Q
"RTN","MAGSIXG3",277,0)
 . Q
"RTN","MAGSIXG3",278,0)
 ;
"RTN","MAGSIXG3",279,0)
 ;=== Skip list entries with no event if event is in
"RTN","MAGSIXG3",280,0)
 ;=== the selection criteria (MAG*3*8)
"RTN","MAGSIXG3",281,0)
 I $D(MAGDATA("EVT"))   Q:EVT="" 0   Q:'$D(MAGDATA("EVT",EVT)) 0
"RTN","MAGSIXG3",282,0)
 ;
"RTN","MAGSIXG3",283,0)
 ;=== Skip list entries with no specialty if specialty is in
"RTN","MAGSIXG3",284,0)
 ;=== the selection criteria (MAG*3*8)
"RTN","MAGSIXG3",285,0)
 I $D(MAGDATA("SPEC"))  Q:SPEC="" 0  Q:'$D(MAGDATA("SPEC",SPEC)) 0
"RTN","MAGSIXG3",286,0)
 ;
"RTN","MAGSIXG3",287,0)
 ;=== Skip list entries with no capture application if
"RTN","MAGSIXG3",288,0)
 ;=== application is in the selection criteria
"RTN","MAGSIXG3",289,0)
 I $D(MAGDATA("CAPTAPP"))  Q:CAPTAPP="" 0  Q:'$D(MAGDATA("CAPTAPP",CAPTAPP)) 0
"RTN","MAGSIXG3",290,0)
 ;
"RTN","MAGSIXG3",291,0)
 ;=== Check the short description
"RTN","MAGSIXG3",292,0)
 I $D(MAGDATA("GDESC"))  Q:$$UP^XLFSTR($P(X2,U,4))'[MAGDATA("GDESC") 0
"RTN","MAGSIXG3",293,0)
 ;
"RTN","MAGSIXG3",294,0)
 ;=== Build the result item
"RTN","MAGSIXG3",295,0)
 S $P(FLTX,U,3)=$$RPTITLE($P(X2,U,6),$P(X2,U,7))     ; Report title
"RTN","MAGSIXG3",296,0)
 S $P(FLTX,U,4)=$$DTE($P(X2,U,5))                    ; Procedure date
"RTN","MAGSIXG3",297,0)
 S $P(FLTX,U,5)=$P(X0,U,8)                           ; Procedure
"RTN","MAGSIXG3",298,0)
 S $P(FLTX,U,7)=$P(X2,U,4)                           ; Short descr.
"RTN","MAGSIXG3",299,0)
 S $P(FLTX,U,8)=PKG                                  ; Package
"RTN","MAGSIXG3",300,0)
 S $P(FLTX,U,9)=$P($G(^MAG(2005.82,+CLASS,0)),U)     ; Class
"RTN","MAGSIXG3",301,0)
 S $P(FLTX,U,10)=$P($G(^MAG(2005.83,+TYPE,0)),U)     ; Type
"RTN","MAGSIXG3",302,0)
 S $P(FLTX,U,11)=$P($G(^MAG(2005.84,+SPEC,0)),U)     ; (Sub)Specialty
"RTN","MAGSIXG3",303,0)
 S $P(FLTX,U,12)=$P($G(^MAG(2005.85,+EVT,0)),U)      ; Proc/Event
"RTN","MAGSIXG3",304,0)
 S $P(FLTX,U,13)=$$EXTERNAL^DILFD(2005,45,,ORIG)     ; Origin
"RTN","MAGSIXG3",305,0)
 S $P(FLTX,U,14)=$$DTE($P(X2,U))                     ; Capture date
"RTN","MAGSIXG3",306,0)
 S $P(FLTX,U,15)=$$GET1^DIQ(200,+$P(X2,U,2)_",",.01) ; Captured by
"RTN","MAGSIXG3",307,0)
 Q 1
"RTN","MAGVIM01")
0^14^B195265246
"RTN","MAGVIM01",1,0)
MAGVIM01 ;WOIFO/DAC/NST/BT - Utilities for RPC calls for DICOM file processing ;  NOV 01,2018@2:13PM
"RTN","MAGVIM01",2,0)
 ;;3.0;IMAGING;**118,138,221**;Mar 19, 2002;Build 5380;Sep 03, 2013
"RTN","MAGVIM01",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGVIM01",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVIM01",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGVIM01",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGVIM01",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGVIM01",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGVIM01",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGVIM01",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGVIM01",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGVIM01",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGVIM01",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGVIM01",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGVIM01",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGVIM01",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVIM01",17,0)
 ;;
"RTN","MAGVIM01",18,0)
 Q
"RTN","MAGVIM01",19,0)
OUTSEP() ; Name value separator for output data ie. NAME|TESTPATIENT
"RTN","MAGVIM01",20,0)
 Q "|"
"RTN","MAGVIM01",21,0)
STATSEP() ; Status and result separator ie. -3``No record IEN
"RTN","MAGVIM01",22,0)
 Q "`"
"RTN","MAGVIM01",23,0)
INPUTSEP() ; Name value separator for input data ie. NAME`TESTPATIENT
"RTN","MAGVIM01",24,0)
 Q "`"
"RTN","MAGVIM01",25,0)
 ; RPC: MAGV GET WORKLISTS
"RTN","MAGVIM01",26,0)
GETLIST(OUT) ; Returns all worklist names and statuses
"RTN","MAGVIM01",27,0)
 N IEN,OSEP,SSEP,FILE,WORKLIST,I
"RTN","MAGVIM01",28,0)
 S IEN=0,I=0,OSEP=$$OUTSEP,SSEP=$$STATSEP,FILE=2006.9412
"RTN","MAGVIM01",29,0)
 F  S IEN=$O(^MAGV(FILE,IEN)) Q:+IEN=0  D
"RTN","MAGVIM01",30,0)
 . S I=I+1
"RTN","MAGVIM01",31,0)
 . S WORKLIST=$G(^MAGV(FILE,IEN,0))
"RTN","MAGVIM01",32,0)
 . S OUT(I+1)=$P(WORKLIST,U,1)_OSEP_$P(WORKLIST,U,2)
"RTN","MAGVIM01",33,0)
 I I>0 S OUT(1)=0_SSEP_I
"RTN","MAGVIM01",34,0)
 Q
"RTN","MAGVIM01",35,0)
 ; RPC: MAGV CREATE WORK ITEM
"RTN","MAGVIM01",36,0)
CRTITEM(OUT,TYPE,SUBTYPE,STATUS,PLACEID,PRIORITY,MSGTAGS,CRTUSR,CRTAPP) ; Creates an entry in the work item file and the work history file
"RTN","MAGVIM01",37,0)
 N FDA,ERR,SMIEN,ISEP,SSEP,MSG,APPIEN
"RTN","MAGVIM01",38,0)
 N I,CRTDAT
"RTN","MAGVIM01",39,0)
 S SSEP=$$STATSEP,ISEP=$$INPUTSEP
"RTN","MAGVIM01",40,0)
 S CRTDAT=$$NOW^XLFDT ; CREATED DATE/TIME
"RTN","MAGVIM01",41,0)
 K OUT
"RTN","MAGVIM01",42,0)
 I $G(TYPE)="" S OUT=-6_SSEP_"No work item TYPE provided" Q
"RTN","MAGVIM01",43,0)
 I $G(SUBTYPE)="" S OUT=-7_SSEP_"No work item SUBTYPE provided" Q
"RTN","MAGVIM01",44,0)
 I $G(STATUS)="" S OUT=-8_SSEP_"No work item STATUS provided" Q
"RTN","MAGVIM01",45,0)
 I $G(PLACEID)="" S OUT=-9_SSEP_"No work item LOCATION provided" Q
"RTN","MAGVIM01",46,0)
 I $G(PRIORITY)="" S OUT=-10_SSEP_"No work item PRIORITY provided" Q
"RTN","MAGVIM01",47,0)
 I ($G(CRTUSR)="")&($G(CRTAPP)="") S OUT=-11_SSEP_"No work item USER/APPLICATION provided" Q
"RTN","MAGVIM01",48,0)
 S FDA(2006.941,"+1,",.01)=CRTDAT
"RTN","MAGVIM01",49,0)
 S FDA(2006.941,"+1,",1)=TYPE
"RTN","MAGVIM01",50,0)
 S FDA(2006.941,"+1,",2)=SUBTYPE
"RTN","MAGVIM01",51,0)
 S FDA(2006.941,"+1,",3)=STATUS
"RTN","MAGVIM01",52,0)
 S FDA(2006.941,"+1,",4)=PLACEID
"RTN","MAGVIM01",53,0)
 S FDA(2006.941,"+1,",5)=PRIORITY
"RTN","MAGVIM01",54,0)
 S FDA(2006.941,"+1,",9)=CRTDAT
"RTN","MAGVIM01",55,0)
 S:$G(CRTUSR)'="" (FDA(2006.941,"+1,",8),FDA(2006.941,"+1,",10))="`"_CRTUSR  ; user DUZ is passed
"RTN","MAGVIM01",56,0)
 I $G(CRTAPP)'="" D
"RTN","MAGVIM01",57,0)
 . S APPIEN=$$GETIEN^MAGVAF05(2006.9193,CRTAPP,1)  ; Get application IEN
"RTN","MAGVIM01",58,0)
 . S (FDA(2006.941,"+1,",14),FDA(2006.941,"+1,",15))=CRTAPP
"RTN","MAGVIM01",59,0)
 . Q
"RTN","MAGVIM01",60,0)
 ; Add message text and tag names and values
"RTN","MAGVIM01",61,0)
 F I=1:1 Q:'$D(MSGTAGS(I))  D
"RTN","MAGVIM01",62,0)
 . I $E($P(MSGTAGS(I),ISEP,1),1,3)="MSG" S MSG(I+1)=$P(MSGTAGS(I),ISEP,2) Q
"RTN","MAGVIM01",63,0)
 . S FDA(2006.94111,"+"_(I+1)_",+1,",.01)=$P(MSGTAGS(I),ISEP,1)  ; TAG NAME
"RTN","MAGVIM01",64,0)
 . S FDA(2006.94111,"+"_(I+1)_",+1,",1)=$P(MSGTAGS(I),ISEP,2)    ; TAG VALUE
"RTN","MAGVIM01",65,0)
 . Q
"RTN","MAGVIM01",66,0)
 K ERR
"RTN","MAGVIM01",67,0)
 D VALIDATE^MAGVIM06(.FDA,.ERR)
"RTN","MAGVIM01",68,0)
 ; Quit on validation error
"RTN","MAGVIM01",69,0)
 I $D(ERR) S OUT="-4"_SSEP_$G(ERR) Q
"RTN","MAGVIM01",70,0)
 ; Set Work Item
"RTN","MAGVIM01",71,0)
 K ERR
"RTN","MAGVIM01",72,0)
 ;
"RTN","MAGVIM01",73,0)
 L +^MAGV(2006.941,0):5 I $T D
"RTN","MAGVIM01",74,0)
 . D UPDATE^DIE("E","FDA","SMIEN","ERR")
"RTN","MAGVIM01",75,0)
 . D
"RTN","MAGVIM01",76,0)
 . . ; Quit if error during saving
"RTN","MAGVIM01",77,0)
 . . I $D(ERR("DIERR",1,"TEXT",1)) S OUT="-1"_SSEP_$G(ERR("DIERR",1,"TEXT",1)) Q
"RTN","MAGVIM01",78,0)
 . . ; File message as word processing field
"RTN","MAGVIM01",79,0)
 . . K ERR
"RTN","MAGVIM01",80,0)
 . . ; Quit if error during saving
"RTN","MAGVIM01",81,0)
 . . I $D(MSG) D  Q:$D(ERR)
"RTN","MAGVIM01",82,0)
 . . . D WP^DIE(2006.941,SMIEN(1)_",",13,"K","MSG","ERR")
"RTN","MAGVIM01",83,0)
 . . . I $D(ERR) S OUT="-3"_SSEP_$G(ERR("DIERR",1,"TEXT",1))
"RTN","MAGVIM01",84,0)
 . . . Q
"RTN","MAGVIM01",85,0)
 . . ; Return ID of new entry
"RTN","MAGVIM01",86,0)
 . . S OUT=0_SSEP_SMIEN(1)
"RTN","MAGVIM01",87,0)
 . . Q
"RTN","MAGVIM01",88,0)
 . L -^MAGV(2006.941,0)
"RTN","MAGVIM01",89,0)
 E  D
"RTN","MAGVIM01",90,0)
 . S OUT=-5_SSEP_"Unable to lock MAG WORK ITEM file."
"RTN","MAGVIM01",91,0)
 . Q
"RTN","MAGVIM01",92,0)
 Q
"RTN","MAGVIM01",93,0)
 ;
"RTN","MAGVIM01",94,0)
 ; RPC: MAGV UPDATE WORK ITEM
"RTN","MAGVIM01",95,0)
UPDITEM(OUT,ID,EXPSTAT,NEWSTAT,MESSAGE,UPDUSR,UPDAPP) ; Update work item status and create an entry in the work history file
"RTN","MAGVIM01",96,0)
 N FDA,SSEP,ISEP,MSGUPD,APPIEN
"RTN","MAGVIM01",97,0)
 S SSEP=$$STATSEP,ISEP=$$INPUTSEP
"RTN","MAGVIM01",98,0)
 I '$D(^MAGV(2006.941,ID)) S OUT="-6"_SSEP_"Work item "_ID_" not found" Q
"RTN","MAGVIM01",99,0)
 I $G(EXPSTAT)="" S OUT=-7_SSEP_"No work item expected status provided" Q
"RTN","MAGVIM01",100,0)
 I ($G(UPDUSR)="")&($G(UPDAPP)="") S OUT=-8_SSEP_"No updated by user/application provided" Q
"RTN","MAGVIM01",101,0)
 L +^MAGV(2006.941,ID):1999999
"RTN","MAGVIM01",102,0)
 S RSTAT=$$GET1^DIQ(2006.941,ID,"STATUS")
"RTN","MAGVIM01",103,0)
 I EXPSTAT'=RSTAT S OUT=-9_SSEP_"Work item "_ID_" has a status of "_RSTAT_", not the expected status of "_EXPSTAT L -^MAGV(2006.941,ID) Q
"RTN","MAGVIM01",104,0)
 I NEWSTAT'="" S FDA(2006.941,ID_",",3)=NEWSTAT
"RTN","MAGVIM01",105,0)
 ;
"RTN","MAGVIM01",106,0)
 F I=1:1 Q:'$D(MESSAGE(I))  D
"RTN","MAGVIM01",107,0)
 . I $E($P(MESSAGE(I),ISEP,1),1,3)="MSG" S MSGUPD(I+1)=$P(MESSAGE(I),ISEP,2)
"RTN","MAGVIM01",108,0)
 . Q
"RTN","MAGVIM01",109,0)
 ;
"RTN","MAGVIM01",110,0)
 S FDA(2006.941,ID_",",9)=$$NOW^XLFDT  ; LAST UPDATED DATE/TIME
"RTN","MAGVIM01",111,0)
 S:$G(UPDUSR)'="" FDA(2006.941,ID_",",10)="`"_UPDUSR  ; LAST UPDATING USER - User DUZ is passed
"RTN","MAGVIM01",112,0)
 I $G(UPDAPP)'="" D
"RTN","MAGVIM01",113,0)
 . S APPIEN=$$GETIEN^MAGVAF05(2006.9193,UPDAPP,1)  ; Get application IEN or create a new one first
"RTN","MAGVIM01",114,0)
 . S FDA(2006.941,ID_",",15)=UPDAPP      ; LAST UPDATING APPLICATION
"RTN","MAGVIM01",115,0)
 . Q
"RTN","MAGVIM01",116,0)
 ;
"RTN","MAGVIM01",117,0)
 S OUT=$$UPDWI^MAGVIM01(ID,.FDA,.MSGUPD)  ; Update Work Item ID with FDA data and MSGUPD message
"RTN","MAGVIM01",118,0)
 L -^MAGV(2006.941,ID)
"RTN","MAGVIM01",119,0)
 Q
"RTN","MAGVIM01",120,0)
 ;
"RTN","MAGVIM01",121,0)
UPDWI(ID,FDA,MSGUPD) ; Update work item
"RTN","MAGVIM01",122,0)
 ; Return 0|Error`Message error
"RTN","MAGVIM01",123,0)
 ; 
"RTN","MAGVIM01",124,0)
 ; ID - IEN of Work Item
"RTN","MAGVIM01",125,0)
 ; FDA - VA FileMan FDA array
"RTN","MAGVIM01",126,0)
 ; MSGUPD - Message array
"RTN","MAGVIM01",127,0)
 N ERR,SSEP
"RTN","MAGVIM01",128,0)
 S SSEP=$$STATSEP
"RTN","MAGVIM01",129,0)
 ;
"RTN","MAGVIM01",130,0)
 D VALIDATE^MAGVIM06(.FDA,.ERR)
"RTN","MAGVIM01",131,0)
 I $D(ERR("DIERR",1,"TEXT",1)) Q -4_SSEP_$G(ERR("DIERR",1,"TEXT",1))  ;Quit on error
"RTN","MAGVIM01",132,0)
 ;
"RTN","MAGVIM01",133,0)
 K ERR
"RTN","MAGVIM01",134,0)
 D FILE^DIE("E","FDA","ERR")
"RTN","MAGVIM01",135,0)
 I $D(ERR("DIERR",1,"TEXT",1)) Q -3_SSEP_$G(ERR("DIERR",1,"TEXT",1))  ;Quit on error
"RTN","MAGVIM01",136,0)
 ;
"RTN","MAGVIM01",137,0)
 ; Update Message field
"RTN","MAGVIM01",138,0)
 K ERR
"RTN","MAGVIM01",139,0)
 I $D(MSGUPD) D WP^DIE(2006.941,ID_",",13,"K","MSGUPD","ERR")
"RTN","MAGVIM01",140,0)
 I $D(ERR("DIERR",1,"TEXT",1)) Q -5_SSEP_$G(ERR("DIERR",1,"TEXT",1))
"RTN","MAGVIM01",141,0)
 ;
"RTN","MAGVIM01",142,0)
 Q 0_SSEP_"Work item "_ID_" updated"
"RTN","MAGVIM01",143,0)
 ;
"RTN","MAGVIM01",144,0)
 ; RPC: MAGV FIND WORK ITEM
"RTN","MAGVIM01",145,0)
FIND(OUT,TYPE,SUBTYPE,STATUS,PLACEID,PRIORITY,STOPTAG,MAXROWS,TAGS) ; Find records with given attributes - return ID
"RTN","MAGVIM01",146,0)
 ;PLACEID is FILE #4's STATION NUMBER
"RTN","MAGVIM01",147,0)
 N IEN,IEN2,J,TAGMATCH,SSEP,ISEP,TAG,WICOUNT,FLD
"RTN","MAGVIM01",148,0)
 N VALUE,FLDS,AFLD,NOMATCH,IENS,MAGOUT,LOCIEN
"RTN","MAGVIM01",149,0)
 S SSEP=$$STATSEP,ISEP=$$INPUTSEP
"RTN","MAGVIM01",150,0)
 ;
"RTN","MAGVIM01",151,0)
 I $G(MAXROWS)'="",'(MAXROWS?1N.N) S OUT=-2_SSEP_"Invalid MAXROWS parameter provided" Q
"RTN","MAGVIM01",152,0)
 ;
"RTN","MAGVIM01",153,0)
 I $G(PLACEID)'="" D  Q:$G(OUT)<0
"RTN","MAGVIM01",154,0)
 . S LOCIEN=$$IEN^XUAF4(PLACEID) ;IA #2171 Get Institution IEN for a station number
"RTN","MAGVIM01",155,0)
 . I LOCIEN="" S OUT=-2_SSEP_"Invalid PLACEID parameter provided"
"RTN","MAGVIM01",156,0)
 . Q
"RTN","MAGVIM01",157,0)
 ;
"RTN","MAGVIM01",158,0)
 S OUT(0)=0
"RTN","MAGVIM01",159,0)
 ; AFLD(FLD,"IE") = compare the external or internal value of the field
"RTN","MAGVIM01",160,0)
 S FLDS=""
"RTN","MAGVIM01",161,0)
 I $G(TYPE)'="" S FLDS=FLDS_"1;",AFLD(1)=TYPE,AFLD(1,"IE")="E"
"RTN","MAGVIM01",162,0)
 I $G(SUBTYPE)'="" S FLDS=FLDS_"2;",AFLD(2)=SUBTYPE,AFLD(2,"IE")="E"
"RTN","MAGVIM01",163,0)
 I $G(STATUS)'="" S FLDS=FLDS_"3;",AFLD(3)=STATUS,AFLD(3,"IE")="E"
"RTN","MAGVIM01",164,0)
 I $G(LOCIEN)'="" S FLDS=FLDS_"4;",AFLD(4)=LOCIEN,AFLD(4,"IE")="I"
"RTN","MAGVIM01",165,0)
 I $G(PRIORITY)'="" S FLDS=FLDS_"5;",AFLD(5)=PRIORITY,AFLD(5,"IE")="E"
"RTN","MAGVIM01",166,0)
 ;
"RTN","MAGVIM01",167,0)
 K ERR
"RTN","MAGVIM01",168,0)
 S IEN=0,WICOUNT=0
"RTN","MAGVIM01",169,0)
 F  S IEN=$O(^MAGV(2006.941,IEN)) Q:(+IEN=0)!($D(ERR))!((($G(MAXROWS)'="")&($G(MAXROWS)<(WICOUNT+1))))  D
"RTN","MAGVIM01",170,0)
 . S IENS=IEN_","
"RTN","MAGVIM01",171,0)
 . K ERR,MAGOUT
"RTN","MAGVIM01",172,0)
 . D GETS^DIQ(2006.941,IENS,FLDS,"IE","MAGOUT","ERR")
"RTN","MAGVIM01",173,0)
 . I $D(ERR) K OUT S OUT(0)=-1_SSEP_$G(ERR("DIERR",1,"TEXT",1)) Q  ; Set Error and quit
"RTN","MAGVIM01",174,0)
 . S FLD=""
"RTN","MAGVIM01",175,0)
 . S NOMATCH=0
"RTN","MAGVIM01",176,0)
 . F  S FLD=$O(AFLD(FLD)) Q:FLD=""!NOMATCH  D
"RTN","MAGVIM01",177,0)
 . . S:AFLD(FLD)'=MAGOUT("2006.941",IENS,FLD,AFLD(FLD,"IE")) NOMATCH=1
"RTN","MAGVIM01",178,0)
 . . Q
"RTN","MAGVIM01",179,0)
 . Q:NOMATCH  ; get next one if no match
"RTN","MAGVIM01",180,0)
 . ; Tag matching
"RTN","MAGVIM01",181,0)
 . S J=0,TAGMATCH=1
"RTN","MAGVIM01",182,0)
 . F  S J=$O(TAGS(J)) Q:(J="")!'TAGMATCH  D
"RTN","MAGVIM01",183,0)
 . . S TAG=$P(TAGS(J),ISEP,1),VALUE=$P(TAGS(J),ISEP,2)
"RTN","MAGVIM01",184,0)
 . . I '$D(^MAGV(2006.941,"H",TAG,IEN)) S TAGMATCH=0 Q
"RTN","MAGVIM01",185,0)
 . . S IEN2=$O(^MAGV(2006.941,"H",TAG,IEN,""))
"RTN","MAGVIM01",186,0)
 . . I $P($G(^MAGV(2006.941,IEN,4,IEN2,0)),U,2)'=VALUE S TAGMATCH=0
"RTN","MAGVIM01",187,0)
 . . Q
"RTN","MAGVIM01",188,0)
 . I 'TAGMATCH Q
"RTN","MAGVIM01",189,0)
 . ; Add work item header to output array
"RTN","MAGVIM01",190,0)
 . D GETWI^MAGVIM09(.OUT,IEN,$G(STOPTAG))  ; Get Work Item Record
"RTN","MAGVIM01",191,0)
 . I +OUT(0)<0 S ERR=""  ; Check for error and set ERR to quit from the loop
"RTN","MAGVIM01",192,0)
 . S WICOUNT=WICOUNT+1
"RTN","MAGVIM01",193,0)
 . Q
"RTN","MAGVIM01",194,0)
 Q
"RTN","MAGVIM01",195,0)
 ;
"RTN","MAGVIM01",196,0)
 ; RPC: MAGV GET WORK ITEM
"RTN","MAGVIM01",197,0)
GETITEM(OUT,ID,EXPSTAT,NEWSTAT,UPDUSR,UPDAPP) ; Find work item with matching ID and return tags - Get and transition
"RTN","MAGVIM01",198,0)
 N I,J,SSEP,RSTAT,FDA,APPIEN
"RTN","MAGVIM01",199,0)
 S SSEP=$$STATSEP
"RTN","MAGVIM01",200,0)
 K OUT
"RTN","MAGVIM01",201,0)
 I $G(ID)="" S OUT(0)=-1_SSEP_"No work item ID provided" Q
"RTN","MAGVIM01",202,0)
 I $G(EXPSTAT)="" S OUT(0)=-2_SSEP_"No expected status provided" Q
"RTN","MAGVIM01",203,0)
 I $G(NEWSTAT)="" S OUT(0)=-3_SSEP_"No new status provided" Q
"RTN","MAGVIM01",204,0)
 I ($G(UPDUSR)="")&($G(UPDAPP)="") S OUT(0)=-4_SSEP_"No updated by user/application provided" Q
"RTN","MAGVIM01",205,0)
 I '$D(^MAGV(2006.941,ID)) S OUT(0)=-5_SSEP_"No work item with matching ID provided" Q
"RTN","MAGVIM01",206,0)
 S RSTAT=$$GET1^DIQ(2006.941,ID,"STATUS")
"RTN","MAGVIM01",207,0)
 I EXPSTAT'=RSTAT S OUT(0)=-6_SSEP_"Work item "_ID_" has a status of "_RSTAT_", not the expected status of "_EXPSTAT L -^MAGV(2006.941,ID) Q
"RTN","MAGVIM01",208,0)
 L +^MAGV(2006.941,ID):1999999
"RTN","MAGVIM01",209,0)
 S OUT(0)=0
"RTN","MAGVIM01",210,0)
 I NEWSTAT'=EXPSTAT D UPUSRAPP(.OUT,ID,NEWSTAT,UPDUSR,UPDAPP) ; Update user, app, updated time fields
"RTN","MAGVIM01",211,0)
 I +OUT(0)=0 D
"RTN","MAGVIM01",212,0)
 . S OUT(0)=0
"RTN","MAGVIM01",213,0)
 . D GETWI^MAGVIM09(.OUT,ID)  ; Get Work Item Record
"RTN","MAGVIM01",214,0)
 . Q 
"RTN","MAGVIM01",215,0)
 L -^MAGV(2006.941,ID)
"RTN","MAGVIM01",216,0)
 Q
"RTN","MAGVIM01",217,0)
 ; RPC: MAGV DELETE WORK ITEM
"RTN","MAGVIM01",218,0)
DELWITEM(OUT,ID) ; Delete Work Item
"RTN","MAGVIM01",219,0)
 N FDA,SSEP
"RTN","MAGVIM01",220,0)
 S SSEP=$$STATSEP
"RTN","MAGVIM01",221,0)
 I '$D(^MAGV(2006.941,ID)) S OUT=-1_SSEP_"Work item "_ID_" not found." Q
"RTN","MAGVIM01",222,0)
 S FDA(2006.941,ID_",",.01)="@"
"RTN","MAGVIM01",223,0)
 L +^MAGV(2006.941,0):5 I $T D
"RTN","MAGVIM01",224,0)
 . ;
"RTN","MAGVIM01",225,0)
 . ;--- Do not decrement FileMan highest entry value during delete.
"RTN","MAGVIM01",226,0)
 . N MAXIEN S MAXIEN=$P(^MAGV(2006.941,0),U,3)
"RTN","MAGVIM01",227,0)
 . D FILE^DIE("","FDA")
"RTN","MAGVIM01",228,0)
 . S:$P(^MAGV(2006.941,0),U,3)<MAXIEN $P(^MAGV(2006.941,0),U,3)=MAXIEN
"RTN","MAGVIM01",229,0)
 . S OUT=0_SSEP_"Work item "_ID_" deleted."
"RTN","MAGVIM01",230,0)
 . L -^MAGV(2006.941,0)
"RTN","MAGVIM01",231,0)
 . Q
"RTN","MAGVIM01",232,0)
 E  D
"RTN","MAGVIM01",233,0)
 . S OUT=-2_SSEP_"Work item "_ID_" is locked."
"RTN","MAGVIM01",234,0)
 . Q
"RTN","MAGVIM01",235,0)
 Q
"RTN","MAGVIM01",236,0)
 ; RPC: MAGV ADD WORK ITEM TAGS
"RTN","MAGVIM01",237,0)
ADDTAG(OUT,ID,EXPSTAT,UPDUSR,UPDAPP,TAG) ; Add tags to work item
"RTN","MAGVIM01",238,0)
 ; List of statuses
"RTN","MAGVIM01",239,0)
 N FDA1,FDA2,ERR1,ERR4,STATMATCH,STATUS,SSEP,ISEP,I,APPIEN,MSGUPD
"RTN","MAGVIM01",240,0)
 S SSEP=$$STATSEP,ISEP=$$INPUTSEP
"RTN","MAGVIM01",241,0)
 I $G(ID)="" S OUT=-9_SSEP_"No work item ID provided" Q
"RTN","MAGVIM01",242,0)
 I '$D(^MAGV(2006.941,ID)) S OUT=-5_SSEP_"No work item with matching ID provided" Q
"RTN","MAGVIM01",243,0)
 I '$D(EXPSTAT) S OUT=-6_SSEP_"No status provided" Q
"RTN","MAGVIM01",244,0)
 I ($G(UPDUSR)="")&($G(UPDAPP)="") S OUT=-7_SSEP_"No updated by user/application provided" Q
"RTN","MAGVIM01",245,0)
 I $G(TAG(1))="" S OUT=-8_SSEP_"No tag provided" Q
"RTN","MAGVIM01",246,0)
 S STATUS=$$GET1^DIQ(2006.941,ID,"STATUS")
"RTN","MAGVIM01",247,0)
 S STATMATCH=0
"RTN","MAGVIM01",248,0)
 F I=1:1  Q:$P(EXPSTAT,ISEP,I)=""  Q:STATMATCH  D
"RTN","MAGVIM01",249,0)
 . I $P(EXPSTAT,ISEP,I)=STATUS S STATMATCH=1
"RTN","MAGVIM01",250,0)
 . Q
"RTN","MAGVIM01",251,0)
 I STATMATCH=0 S OUT=-9_SSEP_"work item does not have expected status" Q
"RTN","MAGVIM01",252,0)
 L +^MAGV(2006.941,ID):1999999
"RTN","MAGVIM01",253,0)
 F I=1:1  Q:'$D(TAG(I))  D
"RTN","MAGVIM01",254,0)
 . S FDA1(2006.94111,"+"_I_","_ID_",",.01)=$P(TAG(I),ISEP,1)  ; TAG NAME
"RTN","MAGVIM01",255,0)
 . S FDA1(2006.94111,"+"_I_","_ID_",",1)=$P(TAG(I),ISEP,2)    ; TAG VALUE
"RTN","MAGVIM01",256,0)
 . Q
"RTN","MAGVIM01",257,0)
 D VALIDATE^MAGVIM06(.FDA1,.ERR4)
"RTN","MAGVIM01",258,0)
 I $D(ERR4) S OUT="-11"_SSEP_$G(ERR4) L -^MAGV(2006.941,ID) Q  ; Unlock and quit
"RTN","MAGVIM01",259,0)
 D UPDATE^DIE("","FDA1","","ERR1")
"RTN","MAGVIM01",260,0)
 I $D(ERR1("DIERR",1,"TEXT",1)) S OUT="-10"_SSEP_$G(ERR1("DIERR",1,"TEXT",1)) L -^MAGV(2006.941,ID) Q  ; Unlock and quit
"RTN","MAGVIM01",261,0)
 ;
"RTN","MAGVIM01",262,0)
 ; Set Work Item
"RTN","MAGVIM01",263,0)
 S FDA2(2006.941,ID_",",9)=$$NOW^XLFDT
"RTN","MAGVIM01",264,0)
 S:$G(UPDUSR)'="" FDA2(2006.941,ID_",",10)="`"_UPDUSR  ; LAST UPDATING USER - User DUZ is passed
"RTN","MAGVIM01",265,0)
 I $G(UPDAPP)'="" D
"RTN","MAGVIM01",266,0)
 . S APPIEN=$$GETIEN^MAGVAF05(2006.9193,UPDAPP,1)  ; Get application IEN or create a new one first
"RTN","MAGVIM01",267,0)
 . S FDA2(2006.941,ID_",",15)=UPDAPP      ; LAST UPDATING APPLICATION
"RTN","MAGVIM01",268,0)
 . Q
"RTN","MAGVIM01",269,0)
 ;
"RTN","MAGVIM01",270,0)
 S OUT=$$UPDWI^MAGVIM01(ID,.FDA2,.MSGUPD)  ; Update Work Item ID with FDA data and MSGUPD message
"RTN","MAGVIM01",271,0)
 L -^MAGV(2006.941,ID)
"RTN","MAGVIM01",272,0)
 Q
"RTN","MAGVIM01",273,0)
 ; RPC: MAGV GET NEXT WORK ITEM
"RTN","MAGVIM01",274,0)
GETNEXT(OUT,ETYPE,EXPSTAT,NEWSTAT,UPDUSR,UPDAPP,LOCATION) ; Find last update work item on worklist type provided
"RTN","MAGVIM01",275,0)
 N SSEP,ID,ETYPEIEN,ESTATIEN,ELOCIEN,UPDATEDT
"RTN","MAGVIM01",276,0)
 ;
"RTN","MAGVIM01",277,0)
 K OUT
"RTN","MAGVIM01",278,0)
 S SSEP=$$STATSEP
"RTN","MAGVIM01",279,0)
 I $G(ETYPE)="" S OUT(0)=-1_SSEP_"Work Item type not specified" Q
"RTN","MAGVIM01",280,0)
 I $G(EXPSTAT)="" S OUT(0)=-2_SSEP_"Work Item expected status not specified" Q
"RTN","MAGVIM01",281,0)
 I $G(NEWSTAT)="" S OUT(0)=-3_SSEP_"Work Item new status not specified" Q
"RTN","MAGVIM01",282,0)
 I ($G(UPDUSR)="")&($G(UPDAPP)="") S OUT(0)=-4_SSEP_"No updated by user/application provided" Q
"RTN","MAGVIM01",283,0)
 I $G(LOCATION)="" S OUT(0)=-5_SSEP_"Work Item Place ID not specified" Q
"RTN","MAGVIM01",284,0)
 ; 
"RTN","MAGVIM01",285,0)
 S ETYPEIEN=$O(^MAGV(2006.9412,"B",ETYPE,""))
"RTN","MAGVIM01",286,0)
 S ESTATIEN=$O(^MAGV(2006.9413,"B",EXPSTAT,""))
"RTN","MAGVIM01",287,0)
 S ELOCIEN=$$IEN^XUAF4(LOCATION) ; get Location IEN
"RTN","MAGVIM01",288,0)
 ;
"RTN","MAGVIM01",289,0)
 I ETYPEIEN'>0 S OUT(0)=-6_SSEP_"Work Item type IEN not found: "_ETYPE Q
"RTN","MAGVIM01",290,0)
 I ESTATIEN'>0 S OUT(0)=-7_SSEP_"Work Item expected status IEN not found: "_EXPSTAT Q 
"RTN","MAGVIM01",291,0)
 I ELOCIEN'>0 S OUT(0)=-8_SSEP_"Work Item Place ID not found: "_LOCATION Q
"RTN","MAGVIM01",292,0)
 ; 
"RTN","MAGVIM01",293,0)
 ;Get last updated record with matching parameters
"RTN","MAGVIM01",294,0)
 S UPDATEDT=$O(^MAGV(2006.941,"C",ETYPEIEN,ESTATIEN,ELOCIEN,""))
"RTN","MAGVIM01",295,0)
 I 'UPDATEDT S OUT(0)=0_SSEP_"No matching work item found" Q
"RTN","MAGVIM01",296,0)
 S ID=$O(^MAGV(2006.941,"C",ETYPEIEN,ESTATIEN,ELOCIEN,UPDATEDT,""))
"RTN","MAGVIM01",297,0)
 I 'ID S OUT(0)=0_SSEP_"No matching work item found" Q
"RTN","MAGVIM01",298,0)
 L +^MAGV(2006.941,ID):1999999
"RTN","MAGVIM01",299,0)
 S OUT(0)=0
"RTN","MAGVIM01",300,0)
 I NEWSTAT'=EXPSTAT D UPUSRAPP(.OUT,ID,NEWSTAT,UPDUSR,UPDAPP) ; Update user, app, updated time fields
"RTN","MAGVIM01",301,0)
 I +OUT(0)=0 D
"RTN","MAGVIM01",302,0)
 . S OUT(0)=0
"RTN","MAGVIM01",303,0)
 . D GETWI^MAGVIM09(.OUT,ID)  ; Get Work Item Record
"RTN","MAGVIM01",304,0)
 . Q 
"RTN","MAGVIM01",305,0)
 L -^MAGV(2006.941,ID)
"RTN","MAGVIM01",306,0)
 Q
"RTN","MAGVIM01",307,0)
 ; RPC: MAGV IMPORT STATUS
"RTN","MAGVIM01",308,0)
IMSTATUS(OUT,UIDS) ; Get import status
"RTN","MAGVIM01",309,0)
 N SSEP,STUDYLIST,SOPLIST,STUDYOUT,SOPOUT,I,CNT,STUDYUID,SERUID,SOPUID,ISEP,SOPIEN,SERIEN,STUDIEN
"RTN","MAGVIM01",310,0)
 S SSEP=$$OUTSEP,ISEP=$$INPUTSEP,I=0,CNT=0
"RTN","MAGVIM01",311,0)
 I '$D(UIDS) S OUT(1)=-6_SSEP_"No UIDs provided" Q
"RTN","MAGVIM01",312,0)
 F  S I=$O(UIDS(I)) Q:I=""  D
"RTN","MAGVIM01",313,0)
 . S CNT=I
"RTN","MAGVIM01",314,0)
 . S STUDYUID=$P(UIDS(I),ISEP,1),SERUID=$P(UIDS(I),ISEP,2),SOPUID=$P(UIDS(I),ISEP,3)
"RTN","MAGVIM01",315,0)
 . I $G(STUDYUID)="" S OUT(I+1)=-1_SSEP_"No study UID provided" Q
"RTN","MAGVIM01",316,0)
 . I $G(SERUID)="" S OUT(I+1)=-2_SSEP_"No series UID provided" Q
"RTN","MAGVIM01",317,0)
 . I $G(SOPUID)="" S OUT(I+1)=-3_SSEP_"No SOP UID provided" Q
"RTN","MAGVIM01",318,0)
 . S OUT(I+1)=-1_SSEP_UIDS(I)_SSEP_"not on file"
"RTN","MAGVIM01",319,0)
 . S STUDYLIST(1)=1,STUDYLIST(2)=STUDYUID
"RTN","MAGVIM01",320,0)
 . S SOPLIST(1)=1,SOPLIST(2)=SOPUID
"RTN","MAGVIM01",321,0)
 . ; Check ^MAG(2005) for import study status 
"RTN","MAGVIM01",322,0)
 . D CHECKUID^MAGDRPCA(.STUDYOUT,.STUDYLIST,"STUDY")
"RTN","MAGVIM01",323,0)
 . I STUDYOUT(2)'="",(+STUDYOUT(2))'<0 D
"RTN","MAGVIM01",324,0)
 . . D CHECKUID^MAGDRPCA(.SOPOUT,.SOPLIST,"SOP")
"RTN","MAGVIM01",325,0)
 . . I SOPOUT(2)'="",(+SOPOUT(2))'<0 D  S CNT=I
"RTN","MAGVIM01",326,0)
 . . . S OUT(I+1)="0"_SSEP_UIDS(I)_SSEP_"on file"
"RTN","MAGVIM01",327,0)
 . . . Q
"RTN","MAGVIM01",328,0)
 . . Q
"RTN","MAGVIM01",329,0)
 . S SOPOUT=""
"RTN","MAGVIM01",330,0)
 . ; Check SOP original and UID
"RTN","MAGVIM01",331,0)
 . I ('$D(^MAGV(2005.64,"B",SOPUID)))&('$D(^MAGV(2005.66,"B",SOPUID))) Q
"RTN","MAGVIM01",332,0)
 . S SOPIEN=$O(^MAGV(2005.64,"B",SOPUID,""),-1)
"RTN","MAGVIM01",333,0)
 . Q:SOPIEN=""
"RTN","MAGVIM01",334,0)
 . I $G(^MAGV(2005.64,SOPIEN,11))'="A" Q
"RTN","MAGVIM01",335,0)
 . ; Check Series original and UID
"RTN","MAGVIM01",336,0)
 . I ('$D(^MAGV(2005.63,"B",SERUID)))&('$D(^MAGV(2005.66,"B",SERUID))) Q
"RTN","MAGVIM01",337,0)
 . S SERIEN=$O(^MAGV(2005.63,"B",SERUID,""),-1)
"RTN","MAGVIM01",338,0)
 . Q:SERIEN=""
"RTN","MAGVIM01",339,0)
 . I $G(^MAGV(2005.63,SERIEN,9))'="A" Q
"RTN","MAGVIM01",340,0)
 . ; Check Study original and UID
"RTN","MAGVIM01",341,0)
 . I ('$D(^MAGV(2005.62,"B",STUDYUID)))&('$D(^MAGV(2005.66,"B",STUDYUID))) Q
"RTN","MAGVIM01",342,0)
 . S STUDIEN=$O(^MAGV(2005.62,"B",STUDYUID,""),-1)
"RTN","MAGVIM01",343,0)
 . Q:STUDIEN=""
"RTN","MAGVIM01",344,0)
 . I $P($G(^MAGV(2005.62,STUDIEN,5)),U,2)'="A" Q
"RTN","MAGVIM01",345,0)
 . S OUT(I+1)="0"_SSEP_UIDS(I)_SSEP_"on file"
"RTN","MAGVIM01",346,0)
 . Q
"RTN","MAGVIM01",347,0)
 ;
"RTN","MAGVIM01",348,0)
 S OUT(1)=0_SSEP_CNT
"RTN","MAGVIM01",349,0)
 Q
"RTN","MAGVIM01",350,0)
UPUSRAPP(OUT,ID,NEWSTAT,UPDUSR,UPDAPP) ; Update user, app, updated time fields
"RTN","MAGVIM01",351,0)
 N FDA,APPIEN
"RTN","MAGVIM01",352,0)
 S FDA(2006.941,ID_",",3)=NEWSTAT
"RTN","MAGVIM01",353,0)
 S FDA(2006.941,ID_",",9)=$$NOW^XLFDT
"RTN","MAGVIM01",354,0)
 S:$G(UPDUSR)'="" FDA(2006.941,ID_",",10)="`"_UPDUSR  ; LAST UPDATING USER - User DUZ is passed
"RTN","MAGVIM01",355,0)
 I $G(UPDAPP)'="" D
"RTN","MAGVIM01",356,0)
 . S APPIEN=$$GETIEN^MAGVAF05(2006.9193,UPDAPP,1)  ; Get application IEN or create a new one first
"RTN","MAGVIM01",357,0)
 . S FDA(2006.941,ID_",",15)=UPDAPP      ; LAST UPDATING APPLICATION
"RTN","MAGVIM01",358,0)
 . Q
"RTN","MAGVIM01",359,0)
 S OUT(0)=$$UPDWI^MAGVIM01(ID,.FDA)  ; Update Work Item ID with FDA data and MSGUPD message
"RTN","MAGVIM01",360,0)
 Q
"RTN","MAGUTL06")
0^15^B19148168
"RTN","MAGUTL06",1,0)
MAGUTL06 ;WOIFO/SG,NST - VALIDATION OF MULTI-VALUE PARAMETERS ; OCT 18, 2018@12:53pm
"RTN","MAGUTL06",2,0)
 ;;3.0;IMAGING;**93,221**;Dec 02, 2009;Build 163
"RTN","MAGUTL06",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGUTL06",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGUTL06",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGUTL06",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGUTL06",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGUTL06",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGUTL06",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGUTL06",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGUTL06",11,0)
 ;; |                                                               |
"RTN","MAGUTL06",12,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGUTL06",13,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGUTL06",14,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGUTL06",15,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGUTL06",16,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGUTL06",17,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGUTL06",18,0)
 ;;
"RTN","MAGUTL06",19,0)
 Q
"RTN","MAGUTL06",20,0)
 ;
"RTN","MAGUTL06",21,0)
 ;##### VALIDATES THE LIST OF NAMES/CODES
"RTN","MAGUTL06",22,0)
 ;
"RTN","MAGUTL06",23,0)
 ; CDNMLIST      List of internal and/or external values of a 'set
"RTN","MAGUTL06",24,0)
 ;               of codes' field defined by the FILE and FIELD
"RTN","MAGUTL06",25,0)
 ;               parameters. Items should be separated by the '^'
"RTN","MAGUTL06",26,0)
 ;               (see also the FLAGS parameter).
"RTN","MAGUTL06",27,0)
 ;
"RTN","MAGUTL06",28,0)
 ; FILE          File/Subfile number
"RTN","MAGUTL06",29,0)
 ; FIELD         Field number
"RTN","MAGUTL06",30,0)
 ;
"RTN","MAGUTL06",31,0)
 ; MAG8NODE      Closed reference to a node where the results are
"RTN","MAGUTL06",32,0)
 ;               returned to:
"RTN","MAGUTL06",33,0)
 ;
"RTN","MAGUTL06",34,0)
 ; @MAG8NODE@(   The list of external names is returned here. Items
"RTN","MAGUTL06",35,0)
 ;               are separated with the same delimiter as those in
"RTN","MAGUTL06",36,0)
 ;               the source list.
"RTN","MAGUTL06",37,0)
 ;
"RTN","MAGUTL06",38,0)
 ;   Code)       Name
"RTN","MAGUTL06",39,0)
 ;
"RTN","MAGUTL06",40,0)
 ; [FLAGS]       Flags that control the execution (can be combined):
"RTN","MAGUTL06",41,0)
 ;
"RTN","MAGUTL06",42,0)
 ;                 C  "Capitalize" the external names
"RTN","MAGUTL06",43,0)
 ;
"RTN","MAGUTL06",44,0)
 ;                 ,  Use comma as item separator instead of '^'
"RTN","MAGUTL06",45,0)
 ;                    (not recommended).
"RTN","MAGUTL06",46,0)
 ; 
"RTN","MAGUTL06",47,0)
 ;                 Z  Treat 0 (zero) as valid code regardles of
"RTN","MAGUTL06",48,0)
 ;                    the field definition.
"RTN","MAGUTL06",49,0)
 ;
"RTN","MAGUTL06",50,0)
 ; Return Values
"RTN","MAGUTL06",51,0)
 ; =============
"RTN","MAGUTL06",52,0)
 ;           <0  Error descriptor (see the $$ERROR^MAGUERR)
"RTN","MAGUTL06",53,0)
 ;            0  Success
"RTN","MAGUTL06",54,0)
 ;           >0  Number of the piece of the source list that
"RTN","MAGUTL06",55,0)
 ;               contains an invalid code or name.
"RTN","MAGUTL06",56,0)
 ;
"RTN","MAGUTL06",57,0)
VALCNLST(CDNMLIST,FILE,FIELD,MAG8NODE,FLAGS) ;
"RTN","MAGUTL06",58,0)
 N ERR,I,ICNT,ITEM,LS,MAG8MSG,MAG8RES,MAGI,NAME,RC
"RTN","MAGUTL06",59,0)
 S FLAGS=$G(FLAGS),LS=$S(FLAGS[",":",",1:"^")
"RTN","MAGUTL06",60,0)
 Q:$TR(FLAGS,"C,Z")'="" $$IPVE^MAGUERR("FLAGS")
"RTN","MAGUTL06",61,0)
 K @MAG8NODE  S (ICNT,RC)=0
"RTN","MAGUTL06",62,0)
 ;
"RTN","MAGUTL06",63,0)
 ;=== Process items of the list
"RTN","MAGUTL06",64,0)
 F MAGI=1:1:$L(CDNMLIST,LS)  D  Q:RC
"RTN","MAGUTL06",65,0)
 . ;--- Get item name or code
"RTN","MAGUTL06",66,0)
 . S ITEM=$$TRIM^XLFSTR($P(CDNMLIST,LS,MAGI))  Q:ITEM=""
"RTN","MAGUTL06",67,0)
 . ;--- Special check for zero
"RTN","MAGUTL06",68,0)
 . I ITEM=0,FLAGS["Z"  D  Q
"RTN","MAGUTL06",69,0)
 . . S ICNT=ICNT+1,NAME="<empty>"
"RTN","MAGUTL06",70,0)
 . . S $P(@MAG8NODE,LS,ICNT)=NAME  ; External name
"RTN","MAGUTL06",71,0)
 . . S @MAG8NODE@(0)=NAME          ; Internal code
"RTN","MAGUTL06",72,0)
 . . Q
"RTN","MAGUTL06",73,0)
 . ;--- Validate the item
"RTN","MAGUTL06",74,0)
 . D CHK^DIE(FILE,FIELD,"E",ITEM,.MAG8RES,"MAG8MSG")
"RTN","MAGUTL06",75,0)
 . I MAG8RES="^"  S RC=MAGI,ERR=$G(MAG8MSG("DIERR",1))  D:ERR'=701  Q
"RTN","MAGUTL06",76,0)
 . . I ERR=401  S RC=$$IPVE^MAGUERR("FILE")   Q
"RTN","MAGUTL06",77,0)
 . . I ERR=501  S RC=$$IPVE^MAGUERR("FIELD")  Q
"RTN","MAGUTL06",78,0)
 . ;--- Store external and internal values
"RTN","MAGUTL06",79,0)
 . S ICNT=ICNT+1
"RTN","MAGUTL06",80,0)
 . S NAME=$S(FLAGS["C":$$SNTC^MAGUTL05(MAG8RES(0)),1:MAG8RES(0))
"RTN","MAGUTL06",81,0)
 . S $P(@MAG8NODE,LS,ICNT)=NAME  ; External name
"RTN","MAGUTL06",82,0)
 . S @MAG8NODE@(MAG8RES)=NAME    ; Internal code
"RTN","MAGUTL06",83,0)
 . Q
"RTN","MAGUTL06",84,0)
 ;
"RTN","MAGUTL06",85,0)
 ;=== Cleanup
"RTN","MAGUTL06",86,0)
 I RC  K @MAG8NODE  Q RC
"RTN","MAGUTL06",87,0)
 Q 0
"RTN","MAGUTL06",88,0)
 ;
"RTN","MAGUTL06",89,0)
 ;##### VALIDATES THE LIST OF NAMES/POINTERS
"RTN","MAGUTL06",90,0)
 ;
"RTN","MAGUTL06",91,0)
 ; PTNMLIST      Reference to a local variable that stores a list of
"RTN","MAGUTL06",92,0)
 ;               IENs and/or values of the .01 field from the file
"RTN","MAGUTL06",93,0)
 ;               defined by the FILE parameter. Items should be
"RTN","MAGUTL06",94,0)
 ;               separated by the '^' (see also the FLAGS parameter).
"RTN","MAGUTL06",95,0)
 ;
"RTN","MAGUTL06",96,0)
 ; FILE          File number. The file must have the standard
"RTN","MAGUTL06",97,0)
 ;               "B" cross-reference for the .01 field.
"RTN","MAGUTL06",98,0)
 ;
"RTN","MAGUTL06",99,0)
 ;
"RTN","MAGUTL06",100,0)
 ; MAG8NODE      Closed reference to a node where the results are
"RTN","MAGUTL06",101,0)
 ;               returned to:
"RTN","MAGUTL06",102,0)
 ;
"RTN","MAGUTL06",103,0)
 ; @MAG8NODE@(   The list of names (.01 values) is returned here.
"RTN","MAGUTL06",104,0)
 ;               Items are separated with the same delimiter as those
"RTN","MAGUTL06",105,0)
 ;               in the source list.
"RTN","MAGUTL06",106,0)
 ;
"RTN","MAGUTL06",107,0)
 ;   IEN)        Name
"RTN","MAGUTL06",108,0)
 ;
"RTN","MAGUTL06",109,0)
 ; [FLAGS]       Flags that control the execution (can be combined):
"RTN","MAGUTL06",110,0)
 ;
"RTN","MAGUTL06",111,0)
 ;                 C  "Capitalize" the names
"RTN","MAGUTL06",112,0)
 ;
"RTN","MAGUTL06",113,0)
 ;                 ,  Use comma as item separator instead of '^'.
"RTN","MAGUTL06",114,0)
 ;                    (not recommended).
"RTN","MAGUTL06",115,0)
 ; 
"RTN","MAGUTL06",116,0)
 ; Return Values
"RTN","MAGUTL06",117,0)
 ; =============
"RTN","MAGUTL06",118,0)
 ;           <0  Error descriptor (see the $$ERROR^MAGUERR)
"RTN","MAGUTL06",119,0)
 ;            0  Success
"RTN","MAGUTL06",120,0)
 ;           >0  Number of the piece of the source list that
"RTN","MAGUTL06",121,0)
 ;               contains an invalid code or name.
"RTN","MAGUTL06",122,0)
 ;
"RTN","MAGUTL06",123,0)
VALPNLST(PTNMLIST,FILE,MAG8NODE,FLAGS) ;
"RTN","MAGUTL06",124,0)
 N MAGI,ICNT,IEN,ITEM,LS,MAGMSG,NAME,RC,ROOT,TMP,DIERR
"RTN","MAGUTL06",125,0)
 S FLAGS=$G(FLAGS),LS=$S(FLAGS[",":",",1:"^")
"RTN","MAGUTL06",126,0)
 Q:$TR(FLAGS,"C,")'="" $$IPVE^MAGUERR("FLAGS")
"RTN","MAGUTL06",127,0)
 K @MAG8NODE  S (ICNT,RC)=0,ROOT=$$ROOT^DILFD(FILE,,1)
"RTN","MAGUTL06",128,0)
 Q:ROOT="" $$IPVE^MAGUERR("FILE")
"RTN","MAGUTL06",129,0)
 ;
"RTN","MAGUTL06",130,0)
 ;=== Process items of the list
"RTN","MAGUTL06",131,0)
 F MAGI=1:1:$L(PTNMLIST,LS)  D  Q:RC
"RTN","MAGUTL06",132,0)
 . ;--- Get name or IEN
"RTN","MAGUTL06",133,0)
 . S ITEM=$$TRIM^XLFSTR($P(PTNMLIST,LS,MAGI))  Q:ITEM=""
"RTN","MAGUTL06",134,0)
 . ;--- IEN
"RTN","MAGUTL06",135,0)
 . I +ITEM=ITEM,$D(@ROOT@(ITEM))  D  Q
"RTN","MAGUTL06",136,0)
 . . S NAME=$$GET1^DIQ(FILE,ITEM_",",.01,,,"MAGMSG")
"RTN","MAGUTL06",137,0)
 . . I $G(DIERR)  S RC=$$DBS^MAGUERR("MAGMSG",FILE,ITEM_",")  Q
"RTN","MAGUTL06",138,0)
 . . S ICNT=ICNT+1
"RTN","MAGUTL06",139,0)
 . . S:FLAGS["C" NAME=$$SNTC^MAGUTL05(NAME)
"RTN","MAGUTL06",140,0)
 . . S $P(@MAG8NODE,LS,ICNT)=NAME  ; Name
"RTN","MAGUTL06",141,0)
 . . S @MAG8NODE@(ITEM)=NAME       ; IEN
"RTN","MAGUTL06",142,0)
 . . Q
"RTN","MAGUTL06",143,0)
 . ;--- Name
"RTN","MAGUTL06",144,0)
 . I $D(@ROOT@("B",ITEM))<10  S RC=MAGI  Q
"RTN","MAGUTL06",145,0)
 . S ICNT=ICNT+1
"RTN","MAGUTL06",146,0)
 . S NAME=$S(FLAGS["C":$$SNTC^MAGUTL05(ITEM),1:ITEM)
"RTN","MAGUTL06",147,0)
 . S $P(@MAG8NODE,LS,ICNT)=NAME
"RTN","MAGUTL06",148,0)
 . S IEN=""
"RTN","MAGUTL06",149,0)
 . F  S IEN=$O(@ROOT@("B",ITEM,IEN))  Q:IEN=""  D
"RTN","MAGUTL06",150,0)
 . . S @MAG8NODE@(IEN)=NAME
"RTN","MAGUTL06",151,0)
 . . Q
"RTN","MAGUTL06",152,0)
 . Q
"RTN","MAGUTL06",153,0)
 ;
"RTN","MAGUTL06",154,0)
 ;=== Cleanup
"RTN","MAGUTL06",155,0)
 I RC  K @MAG8NODE  Q RC
"RTN","MAGUTL06",156,0)
 Q 0
"VER")
8.0^22.0
"^DD",2006.941,2006.941,1,0)
TYPE^P2006.9412'^MAGV(2006.9412,^0;2^Q
"^DD",2006.941,2006.941,1,1,0)
^.1
"^DD",2006.941,2006.941,1,1,1,0)
2006.941^T
"^DD",2006.941,2006.941,1,1,1,1)
S ^MAGV(2006.941,"T",$E(X,1,30),DA)=""
"^DD",2006.941,2006.941,1,1,1,2)
K ^MAGV(2006.941,"T",$E(X,1,30),DA)
"^DD",2006.941,2006.941,1,1,1,"%D",0)
^^1^1^3120210^
"^DD",2006.941,2006.941,1,1,1,"%D",1,0)
This is a cross-reference on TYPE field (#1). 
"^DD",2006.941,2006.941,1,1,1,"DT")
3120210
"^DD",2006.941,2006.941,1,3)
Select type.
"^DD",2006.941,2006.941,1,21,0)
^.001^1^1^3110808^^^^
"^DD",2006.941,2006.941,1,21,1,0)
This is the type of the work item (e.g. Importer).
"^DD",2006.941,2006.941,1,"DT")
3181101
**END**
**END**
