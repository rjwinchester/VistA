KIDS Distribution saved on May 26, 2016@15:27:34
VistA Imaging V3 - Patch 168 - BP 2012 Compliance
**KIDS**:MAG*3.0*168^

**INSTALL NAME**
MAG*3.0*168
"BLD",8342,0)
MAG*3.0*168^IMAGING^0^3160526^y
"BLD",8342,1,0)
^^8^8^3160524^
"BLD",8342,1,1,0)
VistA Imaging V3.0 Patch 168 - BACKGROUND PROCESSOR 2012 Windows Compliant
"BLD",8342,1,2,0)
 - This patch tests the BP to ensure it works with Windows Server 2012
"BLD",8342,1,3,0)
 
"BLD",8342,1,4,0)
MAGIP168  Calculated    4013698
"BLD",8342,1,5,0)
MAGQBUT   Calculated  147442023
"BLD",8342,1,6,0)
 
"BLD",8342,1,7,0)
   2 Routines 
"BLD",8342,1,8,0)
Note: routine MAGIP168 is deleted after the KIDS Build is installed
"BLD",8342,4,0)
^9.64PA^^0
"BLD",8342,6.3)
18
"BLD",8342,"ABNS",0)
^9.66A^^
"BLD",8342,"ABPKG")
n^n^G.IMAGING DEVELOPMENT TEAM@domain.ext
"BLD",8342,"INI")

"BLD",8342,"INID")
n^y^n
"BLD",8342,"INIT")
POS^MAGIP168
"BLD",8342,"KRN",0)
^9.67PA^779.2^20
"BLD",8342,"KRN",.4,0)
.4
"BLD",8342,"KRN",.4,"NM",0)
^9.68A^^
"BLD",8342,"KRN",.401,0)
.401
"BLD",8342,"KRN",.402,0)
.402
"BLD",8342,"KRN",.403,0)
.403
"BLD",8342,"KRN",.5,0)
.5
"BLD",8342,"KRN",.84,0)
.84
"BLD",8342,"KRN",3.6,0)
3.6
"BLD",8342,"KRN",3.8,0)
3.8
"BLD",8342,"KRN",9.2,0)
9.2
"BLD",8342,"KRN",9.8,0)
9.8
"BLD",8342,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",8342,"KRN",9.8,"NM",1,0)
MAGIP168^^0^B4013698
"BLD",8342,"KRN",9.8,"NM",2,0)
MAGQBUT^^0^B147442023
"BLD",8342,"KRN",9.8,"NM","B","MAGIP168",1)

"BLD",8342,"KRN",9.8,"NM","B","MAGQBUT",2)

"BLD",8342,"KRN",19,0)
19
"BLD",8342,"KRN",19,"NM",0)
^9.68A^^
"BLD",8342,"KRN",19.1,0)
19.1
"BLD",8342,"KRN",101,0)
101
"BLD",8342,"KRN",409.61,0)
409.61
"BLD",8342,"KRN",771,0)
771
"BLD",8342,"KRN",779.2,0)
779.2
"BLD",8342,"KRN",870,0)
870
"BLD",8342,"KRN",8989.51,0)
8989.51
"BLD",8342,"KRN",8989.52,0)
8989.52
"BLD",8342,"KRN",8994,0)
8994
"BLD",8342,"KRN","B",.4,.4)

"BLD",8342,"KRN","B",.401,.401)

"BLD",8342,"KRN","B",.402,.402)

"BLD",8342,"KRN","B",.403,.403)

"BLD",8342,"KRN","B",.5,.5)

"BLD",8342,"KRN","B",.84,.84)

"BLD",8342,"KRN","B",3.6,3.6)

"BLD",8342,"KRN","B",3.8,3.8)

"BLD",8342,"KRN","B",9.2,9.2)

"BLD",8342,"KRN","B",9.8,9.8)

"BLD",8342,"KRN","B",19,19)

"BLD",8342,"KRN","B",19.1,19.1)

"BLD",8342,"KRN","B",101,101)

"BLD",8342,"KRN","B",409.61,409.61)

"BLD",8342,"KRN","B",771,771)

"BLD",8342,"KRN","B",779.2,779.2)

"BLD",8342,"KRN","B",870,870)

"BLD",8342,"KRN","B",8989.51,8989.51)

"BLD",8342,"KRN","B",8989.52,8989.52)

"BLD",8342,"KRN","B",8994,8994)

"BLD",8342,"PRET")

"BLD",8342,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",8342,"QUES",0)
^9.62^^
"BLD",8342,"REQB",0)
^9.611^2^2
"BLD",8342,"REQB",1,0)
MAG*3.0*135^2
"BLD",8342,"REQB",2,0)
MAG*3.0*158^2
"BLD",8342,"REQB","B","MAG*3.0*135",1)

"BLD",8342,"REQB","B","MAG*3.0*158",2)

"INIT")
POS^MAGIP168
"MBREQ")
0
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging-V1 to release 
"PKG",454,20,0)
^9.402P^^
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020319^3020517^126
"PKG",454,22,1,"PAH",1,0)
168^3160526^126
"PKG",454,22,1,"PAH",1,1,0)
^^8^8^3160526
"PKG",454,22,1,"PAH",1,1,1,0)
VistA Imaging V3.0 Patch 168 - BACKGROUND PROCESSOR 2012 Windows Compliant
"PKG",454,22,1,"PAH",1,1,2,0)
 - This patch tests the BP to ensure it works with Windows Server 2012
"PKG",454,22,1,"PAH",1,1,3,0)
 
"PKG",454,22,1,"PAH",1,1,4,0)
MAGIP168  Calculated    4013698
"PKG",454,22,1,"PAH",1,1,5,0)
MAGQBUT   Calculated  147442023
"PKG",454,22,1,"PAH",1,1,6,0)
 
"PKG",454,22,1,"PAH",1,1,7,0)
   2 Routines 
"PKG",454,22,1,"PAH",1,1,8,0)
Note: routine MAGIP168 is deleted after the KIDS Build is installed
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","MAGIP168")
0^1^B4013698
"RTN","MAGIP168",1,0)
MAGIP168 ;Install code for MAG*3.0*168 BGP OS 2012 ; 24 MAY 2016 11:42 AM
"RTN","MAGIP168",2,0)
 ;;3.0;IMAGING;**168**;MAY 24, 2016;Build 18
"RTN","MAGIP168",3,0)
 ;;  Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIP168",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP168",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIP168",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIP168",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIP168",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIP168",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIP168",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIP168",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIP168",12,0)
 ;; | a medical device.  As such, it may not be changed             |
"RTN","MAGIP168",13,0)
 ;; | in any way.  Modifications to this software may result in an  |
"RTN","MAGIP168",14,0)
 ;; | adulterated medical device under 21CFR820, the use of which   |
"RTN","MAGIP168",15,0)
 ;; | is considered to be a violation of US Federal Statutes.       |
"RTN","MAGIP168",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP168",17,0)
 ;;
"RTN","MAGIP168",18,0)
 Q
"RTN","MAGIP168",19,0)
PRE ;There are no environment checks here for this patch
"RTN","MAGIP168",20,0)
 Q
"RTN","MAGIP168",21,0)
POST ;***** POST-INSTALL CODE
"RTN","MAGIP168",22,0)
POS ;
"RTN","MAGIP168",23,0)
 N CALLBACK
"RTN","MAGIP168",24,0)
 D CLEAR^MAGUERR(1)
"RTN","MAGIP168",25,0)
 ;--- Send the notification e-mail
"RTN","MAGIP168",26,0)
 D BMES^XPDUTL("Post Install Mail Message: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","MAGIP168",27,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGIP168",28,0)
 Q
"RTN","MAGIP168",29,0)
 ;+++++ INSTALLATION ERROR HANDLING
"RTN","MAGIP168",30,0)
ERROR ;
"RTN","MAGIP168",31,0)
 S:$D(XPDNM) XPDABORT=1
"RTN","MAGIP168",32,0)
 ;--- Display the messages and store them to the INSTALL file
"RTN","MAGIP168",33,0)
 D DUMP^MAGUERR1(),ABTMSG^MAGKIDS()
"RTN","MAGIP168",34,0)
 Q
"RTN","MAGQBUT")
0^2^B147442023
"RTN","MAGQBUT",1,0)
MAGQBUT ;WOIFO/RMP,JSL - Imaging Background Processor Utilities ; 24 May 2016 11:16 AM
"RTN","MAGQBUT",2,0)
 ;;3.0;IMAGING;**7,8,48,20,39,168**;Mar 19, 2002;Build 18;May 24, 2016
"RTN","MAGQBUT",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQBUT",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBUT",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBUT",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBUT",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBUT",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBUT",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBUT",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBUT",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBUT",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBUT",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBUT",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBUT",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT",17,0)
 ;;
"RTN","MAGQBUT",18,0)
 Q
"RTN","MAGQBUT",19,0)
CHGSERV(RESULT,NOTIFY,WSOS,BPWS) ;
"RTN","MAGQBUT",20,0)
 ; RPC[MAGQ FS CHNGE]
"RTN","MAGQBUT",21,0)
 ; RESULT VALUES:-1=NO RG MEMBERS,0=BELOW RESERVE,1=ABOVE RESERVE*PURGE FACTOR,2=BETWEEN RESERVE AND RESERVE*PURGE FACTOR
"RTN","MAGQBUT",22,0)
 ; ^CWL-PHYSICAL REFERENCE^CWL-TOTAL SPACE^PURGE^%FREE SPACE^PURGE_GROUP_IEN^VERIFY^RGADVANCE
"RTN","MAGQBUT",23,0)
 N SPACE,IEN,SIZE,CWL,MIN,CNT,TNODE,TINT,NOW,TLTIME,TOD,PLACE,TSPACE,TSIZE,AUTON,GROUP
"RTN","MAGQBUT",24,0)
 N APP,PFACTOR,NG,WSIEN,X,OG
"RTN","MAGQBUT",25,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT",26,0)
 S U="^",(SPACE,SIZE,CNT,TSPACE,TSIZE)=0,(RESULT,IEN,NG)="" ; T23
"RTN","MAGQBUT",27,0)
 S PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBUT",28,0)
 S APP="MAGQ FS CHNGE: "_BPWS
"RTN","MAGQBUT",29,0)
 S WSIEN=$O(^MAG(2006.8,"C",PLACE,BPWS,""))
"RTN","MAGQBUT",30,0)
 S MIN=$$SPARM
"RTN","MAGQBUT",31,0)
 S CWL=$$CWL^MAGBAPI(PLACE)
"RTN","MAGQBUT",32,0)
 S (GROUP,OG)=$$GRP(PLACE)
"RTN","MAGQBUT",33,0)
 D:SPACE>0 REPCWL(CWL,GROUP,.RESULT) ; Update Result with Current Write Group properties
"RTN","MAGQBUT",34,0)
 S PFACTOR=$$GET1^DIQ(2006.1,PLACE,"60.5","E")
"RTN","MAGQBUT",35,0)
 S PFACTOR=$S(+PFACTOR:+PFACTOR,1:2) ; If only one group default to 1
"RTN","MAGQBUT",36,0)
 D SPRGE(WSIEN,PLACE,.RESULT) ; Check for Scheduled Purge
"RTN","MAGQBUT",37,0)
 D SVERI(WSIEN,PLACE,.RESULT) ; Check for Scheduled Verifier
"RTN","MAGQBUT",38,0)
 D RGADV(PLACE,.GROUP,.RESULT)  ;Check for RG Advance (Scheduled RAID group advance)
"RTN","MAGQBUT",39,0)
 I $P($G(^MAG(2006.1,PLACE,1)),U,10) D NAUTOW(PLACE,CWL,.SPACE,.SIZE,.RESULT,NOTIFY,GROUP) Q  ;Cache balancing off
"RTN","MAGQBUT",40,0)
 ; Evaluate space for auto-write location update/should find group with space
"RTN","MAGQBUT",41,0)
 F  D FSP(MIN,.SPACE,.SIZE,.IEN,.TSPACE,.TSIZE,PLACE,GROUP,"") Q:IEN  D  Q:$P(RESULT,U,1)="-1"  Q:GROUP=$$GRP(PLACE)  Q:OG=GROUP
"RTN","MAGQBUT",42,0)
 . S NG=$$NXTGP(PLACE,GROUP)
"RTN","MAGQBUT",43,0)
 . I NG=GROUP D  Q
"RTN","MAGQBUT",44,0)
 . . D NGF(PLACE) ; Mail "Get_Next_RAID_Group_failure" message
"RTN","MAGQBUT",45,0)
 . . I '$P($G(^MAG(2005.2,NG,7,0)),U,4)  S $P(RESULT,U,1)="-1" ; ZERO MEMBER COUNT - T23
"RTN","MAGQBUT",46,0)
 . . Q
"RTN","MAGQBUT",47,0)
 . S GROUP=NG
"RTN","MAGQBUT",48,0)
 . Q
"RTN","MAGQBUT",49,0)
 I OG'=GROUP,$P(RESULT,U,8)'="" S $P(RESULT,U,8)="Automatic RGADVANCE"
"RTN","MAGQBUT",50,0)
 Q:$P(RESULT,U,1)="-1"
"RTN","MAGQBUT",51,0)
 I TSIZE D REPCWL(IEN,GROUP,.RESULT,TSPACE,TSIZE) ; %FREE SPACE
"RTN","MAGQBUT",52,0)
 E  S $P(RESULT,U,5)="0.00"
"RTN","MAGQBUT",53,0)
 I +IEN'=CWL,IEN>0 D  ; on Change event 
"RTN","MAGQBUT",54,0)
 . D SCWL(IEN,PLACE,GROUP,APP,DUZ)  ; UPDATES SITE PARAMETER FILE WITH CURRENT WRITE AND GROUP LOCATIONS
"RTN","MAGQBUT",55,0)
 . Q
"RTN","MAGQBUT",56,0)
 ; Evaluate space for auto purge contingencies for current RAID group
"RTN","MAGQBUT",57,0)
 I TSIZE>0,(((TSPACE/TSIZE)*100)>(PFACTOR*MIN)) S $P(RESULT,U)=1 Q
"RTN","MAGQBUT",58,0)
 S $P(RESULT,U)=$S('TSIZE:0,(((TSPACE/TSIZE)*100)>MIN):1,SPACE>0:2,1:0)
"RTN","MAGQBUT",59,0)
 S $P(RESULT,U,2,3)=$P($G(^MAG(2005.2,+$P(^MAG(2006.1,PLACE,0),U,3),0)),U,1,2)
"RTN","MAGQBUT",60,0)
 I ($P($G(^MAG(2006.1,PLACE,"BPPURGE")),U)&(SPACE>0)&($$GET1^DIQ(2006.8,WSIEN,"3","I")="1")) D  Q  ;AUTOPURGE IS ENABLED
"RTN","MAGQBUT",61,0)
 . S NG=$$NXTGP(PLACE,GROUP,"1") ;NEXT PURGE CAPABLE GROUP
"RTN","MAGQBUT",62,0)
 . I 'NG D NGF(PLACE) Q
"RTN","MAGQBUT",63,0)
 . Q:($P(^MAG(2006.1,PLACE,"BPPURGE"),U,7))+4>$$DT^XLFDT  ; Allow only 1 auto-purge per 4 days
"RTN","MAGQBUT",64,0)
 . I ($$UPPER^MAGQE4(WSOS)'["SERVER") Q:(WSOS'[".6.2.")  ;;Q:$$UPPER^MAGQE4(WSOS)'["SERVER"
"RTN","MAGQBUT",65,0)
 . S $P(RESULT,U,4)="AUTO_PURGE"
"RTN","MAGQBUT",66,0)
 . S $P(RESULT,U,6)=NG ;GROUP TO BE PURGED
"RTN","MAGQBUT",67,0)
 . D DFNIQ^MAGQBPG1("","An automatic RAID Group purge has been initiated for the following",0,PLACE,"AUTO_RAID_GROUP_PURGE")
"RTN","MAGQBUT",68,0)
 . D DFNIQ^MAGQBPG1("","VistA Imaging RAID group: "_$P($G(^MAG(2005.2,NG,0)),U,1),0,PLACE,"AUTO_RAID_GROUP_PURGE")
"RTN","MAGQBUT",69,0)
 . D DFNIQ^MAGQBPG1("","Auto_RAID_group_purge",1,PLACE,"AUTO_RAID_GROUP_PURGE")
"RTN","MAGQBUT",70,0)
 . Q
"RTN","MAGQBUT",71,0)
 I TSIZE>0,(((TSPACE/TSIZE)*100)>MIN) Q
"RTN","MAGQBUT",72,0)
 D:(NOTIFY!(SPACE>0)) TMESS(SPACE,"VistA Imaging RAID storage is Critically Low",PLACE)
"RTN","MAGQBUT",73,0)
 Q 
"RTN","MAGQBUT",74,0)
TMESS(SPACE,TS,PLACE) ;Trigger a message
"RTN","MAGQBUT",75,0)
 N TN,PC,SER S TN=$$GETMI^MAGQBUT5(TS,PLACE)
"RTN","MAGQBUT",76,0)
 S PC=$P($G(^MAG(2006.1,PLACE,"BPPURGE")),U)
"RTN","MAGQBUT",77,0)
 S SER=$$PURGES(PLACE)
"RTN","MAGQBUT",78,0)
 Q:$$FMADD^XLFDT(+$P(TN,"^",2),"",+$P(TN,U,1),"","")>$$NOW^XLFDT
"RTN","MAGQBUT",79,0)
 D ICCL^MAGQBUT1(CNT_U_TS_U_SPACE_U_PC_SER,$P(TN,"^",1)_" hours.",PLACE)
"RTN","MAGQBUT",80,0)
 Q
"RTN","MAGQBUT",81,0)
PURGES(PLACE) ; BP Server Assigned to Auto-purge
"RTN","MAGQBUT",82,0)
 N IEN,NAME,SER S (NAME,SER)=""
"RTN","MAGQBUT",83,0)
 F  S NAME=$O(^MAG(2006.8,"C",PLACE,NAME)) Q:NAME=""  D  Q:SER]""
"RTN","MAGQBUT",84,0)
 . S IEN=$O(^MAG(2006.8,"C",PLACE,NAME,"")) Q:'IEN
"RTN","MAGQBUT",85,0)
 . I $P($G(^MAG(2006.8,IEN,0)),U,4)=1 S SER=$P($G(^MAG(2006.8,IEN,1)),U,1)
"RTN","MAGQBUT",86,0)
 . Q 
"RTN","MAGQBUT",87,0)
 Q SER
"RTN","MAGQBUT",88,0)
NXTGP(PL,GRP,FP) ; return sure the NEXT able group (Canonically sorted by name)
"RTN","MAGQBUT",89,0)
 N INDX,TMP,GNAME
"RTN","MAGQBUT",90,0)
 S INDX="",GNAME=$P($G(^MAG(2005.2,GRP,0)),U)
"RTN","MAGQBUT",91,0)
 F  S INDX=$O(^MAG(2005.2,"F",PL,"GRP",INDX)) Q:'INDX  D
"RTN","MAGQBUT",92,0)
 . Q:'$P($G(^MAG(2005.2,INDX,7,0)),U,4)  ; ZERO MEMBER COUNT
"RTN","MAGQBUT",93,0)
 . ; CHECK MEMBERS FOR ONLINE, READABLE, HASHED, AND SPACE
"RTN","MAGQBUT",94,0)
 . Q:'$$GABLE(INDX,$G(FP))
"RTN","MAGQBUT",95,0)
 . S TMP($P($G(^MAG(2005.2,INDX,0)),U),INDX)=""
"RTN","MAGQBUT",96,0)
 . Q
"RTN","MAGQBUT",97,0)
 Q:'$D(TMP) GRP
"RTN","MAGQBUT",98,0)
 S INDX=$O(TMP(GNAME)) ;TRY NEXT GROUP NAME CANONICALLY CH
"RTN","MAGQBUT",99,0)
 I INDX="" S INDX=$O(TMP("")) ; ELSE LOOP TO FIRST
"RTN","MAGQBUT",100,0)
 S INDX=$S(INDX'="":$O(TMP(INDX,"")),1:"") ; IF ANY GROUPS QUALIFY
"RTN","MAGQBUT",101,0)
 K TMP
"RTN","MAGQBUT",102,0)
 Q $S(INDX'="":INDX,1:GRP)
"RTN","MAGQBUT",103,0)
GABLE(GR,FP) ; next group able (has online, readable, hashed)
"RTN","MAGQBUT",104,0)
 N IEN,RESULT,MIN,SPACE,SIZE
"RTN","MAGQBUT",105,0)
 S (IEN,RESULT,SPACE,SIZE)=0
"RTN","MAGQBUT",106,0)
 S MIN=$$SPARM
"RTN","MAGQBUT",107,0)
 F  S IEN=$O(^MAG(2005.2,GR,7,"B",IEN)) Q:'IEN  D
"RTN","MAGQBUT",108,0)
 . Q:$P($G(^MAG(2005.2,IEN,0)),U,6,7)'="1^MAG"  ; Not online/MAG
"RTN","MAGQBUT",109,0)
 . Q:$P($G(^MAG(2005.2,IEN,1)),U,6)="1"  ; Read-only
"RTN","MAGQBUT",110,0)
 . Q:$P($G(^MAG(2005.2,IEN,0)),U,3)'>0  ; No total space reported
"RTN","MAGQBUT",111,0)
 . Q:$P($G(^MAG(2005.2,IEN,0)),U,8)'="Y"  ; Not hashed
"RTN","MAGQBUT",112,0)
 . Q:$P($G(^MAG(2005.2,IEN,0)),U,2)[":"  ;skip if it appears to be a local drive
"RTN","MAGQBUT",113,0)
 . Q:$E($P($G(^MAG(2005.2,IEN,0)),U,2),1,2)'="\\"  ; skip if not a normal share path address
"RTN","MAGQBUT",114,0)
 . Q:('$G(FP)&'$$MAXSP(IEN,.SPACE,.SIZE,$G(^MAG(2005.2,IEN,0)),MIN))
"RTN","MAGQBUT",115,0)
 . S RESULT="1"
"RTN","MAGQBUT",116,0)
 . Q
"RTN","MAGQBUT",117,0)
 Q RESULT
"RTN","MAGQBUT",118,0)
MAXSP(IEN,FS,SZ,NODE,MIN) ; Called from FSP (RPC[MAGQ FS CHNGE]CHGSERV:FSP) 
"RTN","MAGQBUT",119,0)
 N SPACE,SIZE
"RTN","MAGQBUT",120,0)
 S SPACE=+$P(NODE,U,5),SIZE=+$P(NODE,U,3)
"RTN","MAGQBUT",121,0)
 I SIZE>0,(((SPACE/SIZE)*100)>MIN),SPACE>FS D  Q 1
"RTN","MAGQBUT",122,0)
 . S FS=SPACE,SZ=SIZE
"RTN","MAGQBUT",123,0)
 Q 0
"RTN","MAGQBUT",124,0)
SPARM() ;Site Parameter for PERCENT server space to be held in reserve
"RTN","MAGQBUT",125,0)
 N VALUE
"RTN","MAGQBUT",126,0)
 S VALUE=$P($G(^MAG(2006.1,$$PLACE^MAGBAPI(+$G(DUZ(2))),1)),U,8)
"RTN","MAGQBUT",127,0)
 Q $S(VALUE>0:VALUE,1:5)
"RTN","MAGQBUT",128,0)
SCWL(IEN,PLACE,GROUP,APP,DUZ) ; Sets updates the Current Write Location
"RTN","MAGQBUT",129,0)
 N X,X2,CNT
"RTN","MAGQBUT",130,0)
 Q:'$$VALRD(IEN,PLACE,GROUP)
"RTN","MAGQBUT",131,0)
 S X=$$DT^XLFDT,X2=$$FMADD^XLFDT(X,30,"","","")
"RTN","MAGQBUT",132,0)
 I '$D(^XTMP("MAGSCWL "_X,0)) D 
"RTN","MAGQBUT",133,0)
 . S ^XTMP("MAGSCWL "_X,0)=X2_"^"_X_"^"_"Recording current write location updates"
"RTN","MAGQBUT",134,0)
 S ^XTMP("MAGSCWL "_X,$$NOW^XLFDT)="CWL: "_IEN_" ( "_$P($G(^MAG(2005.2,IEN,0)),U,1,2)_")^PLACE: "_PLACE_"^GROUP: "_GROUP_"^Application: "_$G(APP)_"^DUZ: "_DUZ
"RTN","MAGQBUT",135,0)
 S $P(^MAG(2006.1,PLACE,0),U,10)=GROUP
"RTN","MAGQBUT",136,0)
 S $P(^MAG(2006.1,PLACE,0),U,3)=IEN
"RTN","MAGQBUT",137,0)
 S $P(^MAG(2006.1,PLACE,"PACS"),U,3)=IEN
"RTN","MAGQBUT",138,0)
 Q
"RTN","MAGQBUT",139,0)
EGR(PL,GRP,ACTION) ; Edit Group Read Only 
"RTN","MAGQBUT",140,0)
 N INDX,ZNODE,NODE1
"RTN","MAGQBUT",141,0)
 S INDX=0
"RTN","MAGQBUT",142,0)
 F  S INDX=$O(^MAG(2005.2,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQBUT",143,0)
 . S ZNODE=$G(^MAG(2005.2,INDX,0))
"RTN","MAGQBUT",144,0)
 . Q:$P(ZNODE,U,10)'=PLACE
"RTN","MAGQBUT",145,0)
 . Q:$P(ZNODE,U,6,7)'["1^MAG"
"RTN","MAGQBUT",146,0)
 . Q:$P(ZNODE,U,9)="1"  ;ROUTING SHARE
"RTN","MAGQBUT",147,0)
 . S NODE1=$G(^MAG(2005.2,INDX,1))
"RTN","MAGQBUT",148,0)
 . Q:$P(NODE1,U,8)'=GRP
"RTN","MAGQBUT",149,0)
 . I ACTION="E" S $P(^MAG(2005.2,INDX,1),U,6)="0"
"RTN","MAGQBUT",150,0)
 . E  S $P(^MAG(2005.2,INDX,1),U,6)="1"
"RTN","MAGQBUT",151,0)
 . Q
"RTN","MAGQBUT",152,0)
 Q
"RTN","MAGQBUT",153,0)
GRP(PLACE) ;
"RTN","MAGQBUT",154,0)
 Q $S(+$P($G(^MAG(2006.1,PLACE,0)),U,10):+$P($G(^MAG(2006.1,PLACE,0)),U,10),1:$$NXTGP(PLACE,0))
"RTN","MAGQBUT",155,0)
FSP(MIN,SPACE,SIZE,IEN,TSPACE,TSIZE,PLACE,GROUP,FILTER) ; Find Space called from (RPC[MAGQ FS CHNGE]CHGSERV)
"RTN","MAGQBUT",156,0)
 N INDX,ZNODE,NODE1
"RTN","MAGQBUT",157,0)
 S (INDX,TSPACE,TSIZE)=0
"RTN","MAGQBUT",158,0)
 F  S INDX=$O(^MAG(2005.2,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQBUT",159,0)
 . Q:'$$VALRD(INDX,PLACE,GROUP)
"RTN","MAGQBUT",160,0)
 . S ZNODE=$G(^MAG(2005.2,INDX,0))
"RTN","MAGQBUT",161,0)
 . S TSPACE=TSPACE+(+$P(ZNODE,U,5))
"RTN","MAGQBUT",162,0)
 . S TSIZE=TSIZE+(+$P(ZNODE,U,3))
"RTN","MAGQBUT",163,0)
 . S CNT=CNT+1
"RTN","MAGQBUT",164,0)
 . Q:(+FILTER=INDX)  ; Find a share within the group other than this one
"RTN","MAGQBUT",165,0)
 . I $$MAXSP(INDX,.SPACE,.SIZE,ZNODE,MIN) S IEN=INDX
"RTN","MAGQBUT",166,0)
 . Q
"RTN","MAGQBUT",167,0)
 Q
"RTN","MAGQBUT",168,0)
VALRD(IEN,PLACE,GROUP) ;Validate Active RAID
"RTN","MAGQBUT",169,0)
 N ZNODE,NODE1
"RTN","MAGQBUT",170,0)
 S ZNODE=$G(^MAG(2005.2,IEN,0))
"RTN","MAGQBUT",171,0)
 S NODE1=$G(^MAG(2005.2,IEN,1))
"RTN","MAGQBUT",172,0)
 Q:$P(ZNODE,U,10)'=PLACE 0
"RTN","MAGQBUT",173,0)
 I $D(GROUP),$P(NODE1,U,8)'=GROUP Q 0
"RTN","MAGQBUT",174,0)
 Q:+$P(NODE1,U,6) 0 ;READ ONLY
"RTN","MAGQBUT",175,0)
 Q:$P(ZNODE,U,6,7)'["1^MAG" 0
"RTN","MAGQBUT",176,0)
 Q:$P(ZNODE,U,9)="1" 0 ;ROUTING SHARE
"RTN","MAGQBUT",177,0)
 Q:$P(ZNODE,U,8)'="Y" 0 ;skip not hashed
"RTN","MAGQBUT",178,0)
 Q:$P(ZNODE,U,2)[":" 0 ;skip if it appears to be a local drive - from testing
"RTN","MAGQBUT",179,0)
 Q:$E($P(ZNODE,U,2),1,2)'="\\" 0 ; skip if not a normal share path address
"RTN","MAGQBUT",180,0)
 Q 1
"RTN","MAGQBUT",181,0)
NGF(PLACE) ;
"RTN","MAGQBUT",182,0)
 D DFNIQ^MAGQBPG1("","The get next raid group function failed!",0,PLACE,"GET_NEXT_RAID_GROUP_FAILURE")
"RTN","MAGQBUT",183,0)
 D DFNIQ^MAGQBPG1("","Use your BP Network Location Manager to re-configure your RAID",0,PLACE,"GET_NEXT_RAID_GROUP_FAILURE")
"RTN","MAGQBUT",184,0)
 D DFNIQ^MAGQBPG1("","Get_Next_RAID_Group_failure",1,PLACE,"GET_NEXT_RAID_GROUP_FAILURE")
"RTN","MAGQBUT",185,0)
 Q
"RTN","MAGQBUT",186,0)
SPRGE(WSIEN,PLACE,RESULT) ; Scheduled Purge
"RTN","MAGQBUT",187,0)
 N NG
"RTN","MAGQBUT",188,0)
 ;Check for scheduled purge
"RTN","MAGQBUT",189,0)
 Q:'$$GET1^DIQ(2006.1,PLACE,"61","I")  ; Check if Scheduled purge is enabled
"RTN","MAGQBUT",190,0)
 Q:($$GET1^DIQ(2006.1,PLACE,"61.1","I")+1)>$$DT^XLFDT  ;Check if activated today
"RTN","MAGQBUT",191,0)
 I ($$UPPER^MAGQE4(WSOS)'["SERVER") Q:(WSOS'[".6.2.")  ;;Q:$$UPPER^MAGQE4(WSOS)'["SERVER"  ; workaround  Win 2012
"RTN","MAGQBUT",192,0)
 Q:'$$GET1^DIQ(2006.8,WSIEN,"3","I")  ;Check if task is assigned to this BP WS
"RTN","MAGQBUT",193,0)
 N T1,T2
"RTN","MAGQBUT",194,0)
 ;Adjust 24 hour time for Fileman format for Scheduled time (#61.4)
"RTN","MAGQBUT",195,0)
 S T1="0000",T2=$$GET1^DIQ(2006.1,PLACE,"61.4","I"),T1=$E(T1,1,($L(T1)-$L(T2)))_T2
"RTN","MAGQBUT",196,0)
 I $$FMADD^XLFDT($$NOW^XLFDT,"","",20,"")>($$GET1^DIQ(2006.1,PLACE,"61.3","I")_"."_T1) D
"RTN","MAGQBUT",197,0)
 . S NG=$$NXTGP(PLACE,GROUP,"1") ; Next purge capable Group
"RTN","MAGQBUT",198,0)
 . I 'NG D NGF(PLACE)  Q  ; Quit if next Raid Group not found
"RTN","MAGQBUT",199,0)
 . S $P(RESULT,U,4)="SCHEDULED_PURGE"_"~"_$$GET1^DIQ(2006.1,PLACE,"61.3","I")
"RTN","MAGQBUT",200,0)
 . S $P(RESULT,U,6)=NG
"RTN","MAGQBUT",201,0)
 . D DFNIQ^MAGQBPG1("","A scheduled RAID group purge has been initiated for the following",0,PLACE,"SCHEDULED_RAID_GROUP_PURGE")
"RTN","MAGQBUT",202,0)
 . D DFNIQ^MAGQBPG1("","VistA Imaging RAID group: "_$P($G(^MAG(2005.2,NG,0)),U,1),0,PLACE,"SCHEDULED_RAID_GROUP_PURGE")
"RTN","MAGQBUT",203,0)
 . D DFNIQ^MAGQBPG1("","Scheduled_RAID_group_purge",1,PLACE,"SCHEDULED_RAID_GROUP_PURGE")
"RTN","MAGQBUT",204,0)
 . Q
"RTN","MAGQBUT",205,0)
 Q
"RTN","MAGQBUT",206,0)
SVERI(WSIEN,PLACE,RESULT) ; Scheduled Verify
"RTN","MAGQBUT",207,0)
 Q:'$$GET1^DIQ(2006.1,PLACE,"62","I")  ; Check if Scheduled Verify is enabled
"RTN","MAGQBUT",208,0)
 Q:($$GET1^DIQ(2006.1,PLACE,"62.1","I")+1)>$$DT^XLFDT  ;Check if activated today
"RTN","MAGQBUT",209,0)
 I ($$UPPER^MAGQE4(WSOS)'["SERVER") Q:(WSOS'[".6.2.")  ;;Q:$$UPPER^MAGQE4(WSOS)'["SERVER"
"RTN","MAGQBUT",210,0)
 Q:'$$GET1^DIQ(2006.8,WSIEN,"4","I")  ;Check if task is assigned to this BP WS
"RTN","MAGQBUT",211,0)
 N T1,T2
"RTN","MAGQBUT",212,0)
 S T1="0000",T2=$$GET1^DIQ(2006.1,PLACE,"62.4","I"),T1=$E(T1,1,($L(T1)-$L(T2)))_T2
"RTN","MAGQBUT",213,0)
 I $$FMADD^XLFDT($$NOW^XLFDT,"","",20,"")>($$GET1^DIQ(2006.1,PLACE,"62.3","I")_"."_T1) D
"RTN","MAGQBUT",214,0)
 . S $P(RESULT,U,7)="VERIFY"_"~"_$$GET1^DIQ(2006.1,PLACE,"62.3","I")
"RTN","MAGQBUT",215,0)
 . Q
"RTN","MAGQBUT",216,0)
 Q
"RTN","MAGQBUT",217,0)
NAUTOW(PLACE,CWL,SPACE,SIZE,RESULT,NOTIFY,GROUP) ; CACHE BALANCING OFF
"RTN","MAGQBUT",218,0)
 ; No Auto RG Advance if Auto write is off
"RTN","MAGQBUT",219,0)
 S SPACE=+$P($G(^MAG(2005.2,CWL,0)),U,5),SIZE=+$P($G(^MAG(2005.2,CWL,0)),U,3)
"RTN","MAGQBUT",220,0)
 I (SIZE>0),((SPACE/SIZE)*100)>MIN D  Q  ;Here is where % Reserve is returned ...need to add by group and by RAID set also GB
"RTN","MAGQBUT",221,0)
 . S $P(RESULT,U)=1
"RTN","MAGQBUT",222,0)
 . I SIZE S $P(RESULT,U,5)=$P(((SPACE/SIZE)*100),".")_"."_$E($P(((SPACE/SIZE)*100),".",2),1,2)
"RTN","MAGQBUT",223,0)
 . E  S $P(RESULT,U,5)="0.00"
"RTN","MAGQBUT",224,0)
 . Q
"RTN","MAGQBUT",225,0)
 I SIZE>0 S $P(RESULT,U,5)=$P(((SPACE/SIZE)*100),".")_"."_$E($P(((SPACE/SIZE)*100),".",2),1,2)
"RTN","MAGQBUT",226,0)
 E  S $P(RESULT,U,5)="0.00"
"RTN","MAGQBUT",227,0)
 S $P(RESULT,U)=$S(SPACE>0:2,1:0)
"RTN","MAGQBUT",228,0)
 S $P(RESULT,U,2,3)=$P(^MAG(2005.2,$P(^MAG(2006.1,PLACE,0),U,3),0),U,1,2)
"RTN","MAGQBUT",229,0)
 I (($$GET1^DIQ(2006.1,PLACE,"61.1","I")+4)<$$DT^XLFDT) D  ;Check if activated within 4 days
"RTN","MAGQBUT",230,0)
 . I ($P($G(^MAG(2006.1,PLACE,"BPPURGE")),U)&(SPACE>0)&($$GET1^DIQ(2006.8,WSIEN,"3","I")="1")) D
"RTN","MAGQBUT",231,0)
 . . I ($$UPPER^MAGQE4(WSOS)'["SERVER") Q:(WSOS'[".6.2.")  ;;Q:$$UPPER^MAGQE4(WSOS)'["SERVER"
"RTN","MAGQBUT",232,0)
 . . S $P(RESULT,U,4)="AUTO_PURGE",$P(RESULT,U,6)=GROUP
"RTN","MAGQBUT",233,0)
 . . D DFNIQ^MAGQBPG1("","An automatic RAID Group purge has been initiated for the following",0,PLACE,"AUTO_RAID_GROUP_PURGE")
"RTN","MAGQBUT",234,0)
 . . D DFNIQ^MAGQBPG1("","VistA Imaging RAID group: "_$P($G(^MAG(2005.2,GROUP,0)),U,1),0,PLACE,"AUTO_RAID_GROUP_PURGE")
"RTN","MAGQBUT",235,0)
 . . D DFNIQ^MAGQBPG1("","Auto_RAID_group_purge",1,PLACE,"AUTO_RAID_GROUP_PURGE")
"RTN","MAGQBUT",236,0)
 . . Q
"RTN","MAGQBUT",237,0)
 . Q
"RTN","MAGQBUT",238,0)
 D:(NOTIFY!(SPACE>0)) TMESS(SPACE,"VistA Imaging RAID storage is Critically Low ",PLACE)
"RTN","MAGQBUT",239,0)
 Q
"RTN","MAGQBUT",240,0)
RGADV(PLACE,GROUP,RESULT) ; Scheduled Raid Group Advance
"RTN","MAGQBUT",241,0)
 N NODERG,NG,IEN,APP,SCH,T1,T2
"RTN","MAGQBUT",242,0)
 S NODERG=$G(^MAG(2006.1,PLACE,"RGADVANCE"))
"RTN","MAGQBUT",243,0)
 I $P(NODERG,U,1) D
"RTN","MAGQBUT",244,0)
 . Q:'(+$P(NODERG,U,4))
"RTN","MAGQBUT",245,0)
 . S T1="0000",T2=$P(NODERG,U,5),T1=$E(T1,1,($L(T1)-$L(T2)))_T2
"RTN","MAGQBUT",246,0)
 . I $$FMADD^XLFDT($$NOW^XLFDT,"","",20,"")>($P(NODERG,U,4)_"."_T1) D
"RTN","MAGQBUT",247,0)
 . . S NG=$$NXTGP(PLACE,GROUP) ;$$NXTGP returns null when no group with suitable space is found
"RTN","MAGQBUT",248,0)
 . . I ((NG)&(NG'=GROUP)) D  Q
"RTN","MAGQBUT",249,0)
 . . . S GROUP=NG,IEN=""
"RTN","MAGQBUT",250,0)
 . . . D FSP(MIN,.SPACE,.SIZE,.IEN,.TSPACE,.TSIZE,PLACE,GROUP,"")
"RTN","MAGQBUT",251,0)
 . . . S APP="Scheduled RAID Group Advance"
"RTN","MAGQBUT",252,0)
 . . . D SCWL(IEN,PLACE,GROUP,APP,DUZ)
"RTN","MAGQBUT",253,0)
 . . . S $P(RESULT,U,8)="Scheduled RGADVANCE"
"RTN","MAGQBUT",254,0)
 . . . D DFNIQ^MAGQBPG1("","A Scheduled RGADVANCE has completed",0,PLACE,APP)
"RTN","MAGQBUT",255,0)
 . . . D DFNIQ^MAGQBPG1("","The Active RAID Group is now set to: "_$P(^MAG(2005.2,GROUP,0),U,1),0,PLACE,APP)
"RTN","MAGQBUT",256,0)
 . . . D DFNIQ^MAGQBPG1("","Scheduled_RAID_Group_Advance",1,PLACE,APP)
"RTN","MAGQBUT",257,0)
 . . . S $P(^MAG(2006.1,PLACE,"RGADVANCE"),U,3)=$$DT^XLFDT ; DATE OF LAST RG ADVANCE #63.2
"RTN","MAGQBUT",258,0)
 . . . ;Allow singly scheduled RGAdvance,unschedule next if Frequency not set
"RTN","MAGQBUT",259,0)
 . . . S $P(^MAG(2006.1,PLACE,"RGADVANCE"),U,4)=$S(+$P(NODERG,U,2)>0:$$FMADD^XLFDT($$DT^XLFDT,$P(NODERG,U,2),"","",""),1:"")
"RTN","MAGQBUT",260,0)
 . . . Q
"RTN","MAGQBUT",261,0)
 . . ; Else NOTIFY & QUIT
"RTN","MAGQBUT",262,0)
 . . N MSG S MSG="The scheduled RAID Group Advance failed!"
"RTN","MAGQBUT",263,0)
 . . D DFNIQ^MAGQBPG1("",MSG,0,PLACE,"MAGQ FS CHNGE")
"RTN","MAGQBUT",264,0)
 . . S MSG="Scheduled_RAID_Group_Advance_failure!"
"RTN","MAGQBUT",265,0)
 . . D DFNIQ^MAGQBPG1("",MSG,1,PLACE,"MAGQ FS CHNGE") ; Send
"RTN","MAGQBUT",266,0)
 . . Q
"RTN","MAGQBUT",267,0)
 . Q
"RTN","MAGQBUT",268,0)
 Q
"RTN","MAGQBUT",269,0)
REPCWL(IEN,RG,RES,TSPACE,TSIZE) ;  Update Result with Current Write Group properties
"RTN","MAGQBUT",270,0)
 S $P(RES,U,2)="CWL: "_IEN_" RG: "_RG
"RTN","MAGQBUT",271,0)
 S $P(RES,U,3)=TSPACE
"RTN","MAGQBUT",272,0)
 S $P(RES,U,5)=$P(((TSPACE/TSIZE)*100),".")_"."_$E($P(((TSPACE/TSIZE)*100),".",2),1,2) ; %FREE SPACE
"RTN","MAGQBUT",273,0)
 Q
"VER")
8.0^22.0
**END**
**END**
