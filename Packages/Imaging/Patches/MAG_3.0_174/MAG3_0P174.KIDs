KIDS Distribution saved on Nov 23, 2016@09:56:47
VistA Imaging V3 - Patch 174 - Modality Worklist
**KIDS**:MAG*3.0*174^

**INSTALL NAME**
MAG*3.0*174
"BLD",8346,0)
MAG*3.0*174^IMAGING^0^3161123^y
"BLD",8346,1,0)
^^8^8^3160901^
"BLD",8346,1,1,0)
VistA Imaging V3.0 Patch 174 - Modality Worklist
"BLD",8346,1,2,0)
 - This patch handles Modality Worklist fixes
"BLD",8346,1,3,0)
 
"BLD",8346,1,4,0)
MAGIP174
"BLD",8346,1,5,0)
 
"BLD",8346,1,6,0)
 
"BLD",8346,1,7,0)
   1 Routin 
"BLD",8346,1,8,0)
Note: routine MAGIP174 is deleted after the KIDS Build is installed
"BLD",8346,4,0)
^9.64PA^^0
"BLD",8346,6.3)
30
"BLD",8346,"ABNS",0)
^9.66A^^
"BLD",8346,"ABPKG")
n^n^G.IMAGING DEVELOPMENT TEAM@domain.ext
"BLD",8346,"INI")

"BLD",8346,"INID")
n^y^n
"BLD",8346,"INIT")
POS^MAGIP174
"BLD",8346,"KRN",0)
^9.67PA^779.2^20
"BLD",8346,"KRN",.4,0)
.4
"BLD",8346,"KRN",.4,"NM",0)
^9.68A^^
"BLD",8346,"KRN",.401,0)
.401
"BLD",8346,"KRN",.402,0)
.402
"BLD",8346,"KRN",.403,0)
.403
"BLD",8346,"KRN",.5,0)
.5
"BLD",8346,"KRN",.84,0)
.84
"BLD",8346,"KRN",3.6,0)
3.6
"BLD",8346,"KRN",3.8,0)
3.8
"BLD",8346,"KRN",9.2,0)
9.2
"BLD",8346,"KRN",9.8,0)
9.8
"BLD",8346,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",8346,"KRN",9.8,"NM",1,0)
MAGIP174^^0^B4110422
"BLD",8346,"KRN",9.8,"NM",2,0)
MAGDHOW0^^0^B11099680
"BLD",8346,"KRN",9.8,"NM",3,0)
MAGDHOW1^^0^B28177499
"BLD",8346,"KRN",9.8,"NM",4,0)
MAGDHOWC^^0^B35470701
"BLD",8346,"KRN",9.8,"NM",5,0)
MAGDHOWS^^0^B13563936
"BLD",8346,"KRN",9.8,"NM","B","MAGDHOW0",2)

"BLD",8346,"KRN",9.8,"NM","B","MAGDHOW1",3)

"BLD",8346,"KRN",9.8,"NM","B","MAGDHOWC",4)

"BLD",8346,"KRN",9.8,"NM","B","MAGDHOWS",5)

"BLD",8346,"KRN",9.8,"NM","B","MAGIP174",1)

"BLD",8346,"KRN",19,0)
19
"BLD",8346,"KRN",19,"NM",0)
^9.68A^^
"BLD",8346,"KRN",19.1,0)
19.1
"BLD",8346,"KRN",101,0)
101
"BLD",8346,"KRN",409.61,0)
409.61
"BLD",8346,"KRN",771,0)
771
"BLD",8346,"KRN",779.2,0)
779.2
"BLD",8346,"KRN",870,0)
870
"BLD",8346,"KRN",8989.51,0)
8989.51
"BLD",8346,"KRN",8989.52,0)
8989.52
"BLD",8346,"KRN",8994,0)
8994
"BLD",8346,"KRN","B",.4,.4)

"BLD",8346,"KRN","B",.401,.401)

"BLD",8346,"KRN","B",.402,.402)

"BLD",8346,"KRN","B",.403,.403)

"BLD",8346,"KRN","B",.5,.5)

"BLD",8346,"KRN","B",.84,.84)

"BLD",8346,"KRN","B",3.6,3.6)

"BLD",8346,"KRN","B",3.8,3.8)

"BLD",8346,"KRN","B",9.2,9.2)

"BLD",8346,"KRN","B",9.8,9.8)

"BLD",8346,"KRN","B",19,19)

"BLD",8346,"KRN","B",19.1,19.1)

"BLD",8346,"KRN","B",101,101)

"BLD",8346,"KRN","B",409.61,409.61)

"BLD",8346,"KRN","B",771,771)

"BLD",8346,"KRN","B",779.2,779.2)

"BLD",8346,"KRN","B",870,870)

"BLD",8346,"KRN","B",8989.51,8989.51)

"BLD",8346,"KRN","B",8989.52,8989.52)

"BLD",8346,"KRN","B",8994,8994)

"BLD",8346,"PRET")

"BLD",8346,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",8346,"QUES",0)
^9.62^^
"BLD",8346,"REQB",0)
^9.611^1^1
"BLD",8346,"REQB",1,0)
MAG*3.0*162^2
"BLD",8346,"REQB","B","MAG*3.0*162",1)

"INIT")
POS^MAGIP174
"MBREQ")
0
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging-V1 to release 
"PKG",454,20,0)
^9.402P^^
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020319^3020517^126
"PKG",454,22,1,"PAH",1,0)
174^3161123^126
"PKG",454,22,1,"PAH",1,1,0)
^^8^8^3161123
"PKG",454,22,1,"PAH",1,1,1,0)
VistA Imaging V3.0 Patch 174 - Modality Worklist
"PKG",454,22,1,"PAH",1,1,2,0)
 - This patch handles Modality Worklist fixes
"PKG",454,22,1,"PAH",1,1,3,0)
 
"PKG",454,22,1,"PAH",1,1,4,0)
MAGIP174
"PKG",454,22,1,"PAH",1,1,5,0)
 
"PKG",454,22,1,"PAH",1,1,6,0)
 
"PKG",454,22,1,"PAH",1,1,7,0)
   1 Routin 
"PKG",454,22,1,"PAH",1,1,8,0)
Note: routine MAGIP174 is deleted after the KIDS Build is installed
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","MAGDHOW0")
0^2^B11099680
"RTN","MAGDHOW0",1,0)
MAGDHOW0 ;WOIFO/PMK,DAC - Capture Consult/Request data ; 10 Oct 2016 3:30 PM
"RTN","MAGDHOW0",2,0)
 ;;3.0;IMAGING;**138,174**;Mar 19, 2002;Build 30
"RTN","MAGDHOW0",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHOW0",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOW0",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHOW0",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHOW0",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHOW0",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHOW0",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHOW0",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHOW0",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHOW0",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHOW0",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHOW0",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHOW0",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHOW0",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOW0",17,0)
 ;;
"RTN","MAGDHOW0",18,0)
 ;
"RTN","MAGDHOW0",19,0)
 ;
"RTN","MAGDHOW0",20,0)
 Q
"RTN","MAGDHOW0",21,0)
 ;
"RTN","MAGDHOW0",22,0)
FINDSEG(ARRAY,SEGMENT,I,X) ; find a specific HL7 segment in an array
"RTN","MAGDHOW0",23,0)
 ; input -- ARRAY ---- an HL7 array
"RTN","MAGDHOW0",24,0)
 ; input -- SEGMENT -- three-letter HL7 segment identifier 
"RTN","MAGDHOW0",25,0)
 ; input -- I -------- index of the found segment (or null)
"RTN","MAGDHOW0",26,0)
 ; output - I -------- index of the found segment (or null)
"RTN","MAGDHOW0",27,0)
 ; output - X -------- string of fields sans segment identifier
"RTN","MAGDHOW0",28,0)
 ; return - HIT ------ flag indicating segment found 
"RTN","MAGDHOW0",29,0)
 ;
"RTN","MAGDHOW0",30,0)
 N HIT
"RTN","MAGDHOW0",31,0)
 S HIT=0
"RTN","MAGDHOW0",32,0)
 F  S I=$O(ARRAY(I)) Q:I=""  I $P(ARRAY(I),DEL)=SEGMENT D  Q
"RTN","MAGDHOW0",33,0)
 . S X=$P(ARRAY(I),DEL,2,99999) ; strip off the segment name
"RTN","MAGDHOW0",34,0)
 . S HIT=1
"RTN","MAGDHOW0",35,0)
 . Q
"RTN","MAGDHOW0",36,0)
 Q HIT
"RTN","MAGDHOW0",37,0)
 ;
"RTN","MAGDHOW0",38,0)
NEWTIU(GMRCIEN) ; check if this is a TIU note to be linked to an image group
"RTN","MAGDHOW0",39,0)
 ; if so, create the cross-linkages now
"RTN","MAGDHOW0",40,0)
 N CROSSREF,D0,FILEDATA,HIT,MAGGP,MAGIEN,NIMAGE,TIUIEN
"RTN","MAGDHOW0",41,0)
 S HIT=0
"RTN","MAGDHOW0",42,0)
 S D0=""
"RTN","MAGDHOW0",43,0)
 F  S D0=$O(^MAG(2006.5839,"C",123,GMRCIEN,D0)) Q:'D0  D
"RTN","MAGDHOW0",44,0)
 . S MAGGP=$P($G(^MAG(2006.5839,D0,0)),"^",3) Q:'MAGGP
"RTN","MAGDHOW0",45,0)
 . S TIUIEN=$$TIULAST^MAGDGMRC(GMRCIEN) Q:'TIUIEN
"RTN","MAGDHOW0",46,0)
 . S $P(^MAG(2005,MAGGP,2),"^",6,7)="8925^"_TIUIEN
"RTN","MAGDHOW0",47,0)
 . D TIUXLINK ; create the cross-linkages to TIU
"RTN","MAGDHOW0",48,0)
 . ; update the parent file pointers for all the images
"RTN","MAGDHOW0",49,0)
 . S CROSSREF="8925^"_TIUIEN_"^"_FILEDATA("PARENT FILE PTR")
"RTN","MAGDHOW0",50,0)
 . S NIMAGE=0 F  S NIMAGE=$O(^MAG(2005,MAGGP,1,NIMAGE)) Q:'NIMAGE  D
"RTN","MAGDHOW0",51,0)
 . . S MAGIEN=$P(^MAG(2005,MAGGP,1,NIMAGE,0),"^")
"RTN","MAGDHOW0",52,0)
 . . S $P(^MAG(2005,MAGIEN,2),"^",6,8)=CROSSREF
"RTN","MAGDHOW0",53,0)
 . . Q
"RTN","MAGDHOW0",54,0)
 . ; remove entries from ^MAG(2006.5839) & decrement the counter
"RTN","MAGDHOW0",55,0)
 . K ^MAG(2006.5839,D0),^MAG(2006.5839,"C",123,GMRCIEN,D0)
"RTN","MAGDHOW0",56,0)
 . L +^MAG(2006.5839):1E9 ; Background process MUST wait
"RTN","MAGDHOW0",57,0)
 . S $P(^MAG(2006.5839,0),"^",4)=$P(^MAG(2006.5839,0),"^",4)-1
"RTN","MAGDHOW0",58,0)
 . L -^MAG(2006.5839)
"RTN","MAGDHOW0",59,0)
 . S HIT=1
"RTN","MAGDHOW0",60,0)
 . Q
"RTN","MAGDHOW0",61,0)
 Q HIT
"RTN","MAGDHOW0",62,0)
 ;
"RTN","MAGDHOW0",63,0)
TIUXLINK ; create the cross-linkages to TIU EXTERNAL DATA LINK file
"RTN","MAGDHOW0",64,0)
 N TIUXDIEN
"RTN","MAGDHOW0",65,0)
 D PUTIMAGE^TIUSRVPL(.TIUXDIEN,TIUIEN,MAGGP)
"RTN","MAGDHOW0",66,0)
 I TIUXDIEN D
"RTN","MAGDHOW0",67,0)
 . S FILEDATA("PARENT FILE PTR")=TIUXDIEN
"RTN","MAGDHOW0",68,0)
 . S $P(^MAG(2005,MAGGP,2),"^",8)=TIUXDIEN
"RTN","MAGDHOW0",69,0)
 . Q
"RTN","MAGDHOW0",70,0)
 E  D  ; fatal error
"RTN","MAGDHOW0",71,0)
 . N MSG
"RTN","MAGDHOW0",72,0)
 . S MSG(1)="ERROR ASSOCIATING WITH TIU EXTERNAL DATA LINK (file 8925.91):"
"RTN","MAGDHOW0",73,0)
 . S MSG(2)=$P(TIUXDIEN,"^",2,999)
"RTN","MAGDHOW0",74,0)
 . S MSG(3)=" for lookup in DICOM GMRC TEMP LIST (file 2006.5839)."
"RTN","MAGDHOW0",75,0)
 . D ERR^MAGGTERR ; P174 DAC - Error trap call fix
"RTN","MAGDHOW0",76,0)
 . Q
"RTN","MAGDHOW0",77,0)
 Q
"RTN","MAGDHOW1")
0^3^B28177499
"RTN","MAGDHOW1",1,0)
MAGDHOW1 ;WOIFO/PMK/DAC - Capture Consult/Procedure Request data ; Nov 21, 2016
"RTN","MAGDHOW1",2,0)
 ;;3.0;IMAGING;**138,174**;Mar 19, 2002;Build 30
"RTN","MAGDHOW1",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHOW1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOW1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHOW1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHOW1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHOW1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHOW1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHOW1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHOW1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHOW1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHOW1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHOW1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHOW1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHOW1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOW1",17,0)
 ;;
"RTN","MAGDHOW1",18,0)
MSGSETUP(GMRCIEN,SERVICE,ORC1,ORC5,APTSCHED) ; called by ^MAGDHOWC and ^MAGDHOWS
"RTN","MAGDHOW1",19,0)
 ; setup to send a message, if required
"RTN","MAGDHOW1",20,0)
 N CONSULT,CPTIEN,DATETIME,DIVISION,FMDATE,FMDATETM
"RTN","MAGDHOW1",21,0)
 N HL7SUBLIST,I,ITYPCODE,ITYPNAME,MSGTYPE,OBXSEGNO
"RTN","MAGDHOW1",22,0)
 N ORCTRL,ORSTATUS,ORIGSERV,PARMS,SEGMENT,SENDIT,X,Y,Z
"RTN","MAGDHOW1",23,0)
 ;
"RTN","MAGDHOW1",24,0)
 S FMDATETM=$$NOW^XLFDT(),FMDATE=FMDATETM\1
"RTN","MAGDHOW1",25,0)
 S MSGTYPE="ORM" ; HL7 message type for orders
"RTN","MAGDHOW1",26,0)
 ;
"RTN","MAGDHOW1",27,0)
 ; decide if service is one that requires HL7->DICOM gateway and PACS
"RTN","MAGDHOW1",28,0)
 ;
"RTN","MAGDHOW1",29,0)
 S SENDIT=$$SERVICE(SERVICE,GMRCIEN,.DIVISION,.ITYPNAME,.ITYPCODE,.CPTIEN,.HL7SUBLIST)
"RTN","MAGDHOW1",30,0)
 ;
"RTN","MAGDHOW1",31,0)
 I SENDIT D  ; send this transaction via HL7 to DICOM gateway and PACS
"RTN","MAGDHOW1",32,0)
 . ; check for an "OK" order control value which indicates a new order
"RTN","MAGDHOW1",33,0)
 . I ORC1="OK" D
"RTN","MAGDHOW1",34,0)
 . . S ORCTRL="NW" ; order control
"RTN","MAGDHOW1",35,0)
 . . S ORSTATUS="IP" ; order status
"RTN","MAGDHOW1",36,0)
 . . Q
"RTN","MAGDHOW1",37,0)
 . ;
"RTN","MAGDHOW1",38,0)
 . ; check for a cancelled or discontinued request
"RTN","MAGDHOW1",39,0)
 . E  I " CA CR DR OC OD "[(" "_ORC1_" ") D
"RTN","MAGDHOW1",40,0)
 . . K FILLER2 ; P174 DAC - remove any preset status like GMRC-SCHEDULED set in CHECKAPT^MAGDHOWC
"RTN","MAGDHOW1",41,0)
 . . S ORCTRL="CA" ; order control
"RTN","MAGDHOW1",42,0)
 . . S ORSTATUS="CA" ; order status
"RTN","MAGDHOW1",43,0)
 . . Q
"RTN","MAGDHOW1",44,0)
 . ;
"RTN","MAGDHOW1",45,0)
 . ; check for scheduled request (set in ^MAGDHOWS)
"RTN","MAGDHOW1",46,0)
 . E  I ORC1="XO",ORC5="SC" D
"RTN","MAGDHOW1",47,0)
 . . S ORCTRL="XO" ; order control
"RTN","MAGDHOW1",48,0)
 . . S ORSTATUS="SC" ; order status
"RTN","MAGDHOW1",49,0)
 . . Q
"RTN","MAGDHOW1",50,0)
 . ;
"RTN","MAGDHOW1",51,0)
 . ; look for a result message
"RTN","MAGDHOW1",52,0)
 . E  I ORC1="RE" D  ; result
"RTN","MAGDHOW1",53,0)
 . . S MSGTYPE="ORU" ; HL7 message type for results
"RTN","MAGDHOW1",54,0)
 . . ;
"RTN","MAGDHOW1",55,0)
 . . I ORC5="A" D  ; unsigned TIU note
"RTN","MAGDHOW1",56,0)
 . . . S FILLER2="GMRC-NEW UNSIGNED RESULT"
"RTN","MAGDHOW1",57,0)
 . . . S ORCTRL="RE" ; order control
"RTN","MAGDHOW1",58,0)
 . . . S ORSTATUS="A" ; order status
"RTN","MAGDHOW1",59,0)
 . . . Q
"RTN","MAGDHOW1",60,0)
 . . E  D  ; new signed TIU note
"RTN","MAGDHOW1",61,0)
 . . . K FILLER2 ; P174 DAC - remove any preset status like GMRC-SCHEDULED set in CHECKAPT^MAGDHOWC
"RTN","MAGDHOW1",62,0)
 . . . S ORCTRL="RE" ; order control
"RTN","MAGDHOW1",63,0)
 . . . S ORSTATUS="CM" ; order status
"RTN","MAGDHOW1",64,0)
 . . . Q
"RTN","MAGDHOW1",65,0)
 . . Q
"RTN","MAGDHOW1",66,0)
 . ;
"RTN","MAGDHOW1",67,0)
 . E  D  ; default
"RTN","MAGDHOW1",68,0)
 . . S ORCTRL="SC" ; order control
"RTN","MAGDHOW1",69,0)
 . . S ORSTATUS="IP" ; order status
"RTN","MAGDHOW1",70,0)
 . . Q
"RTN","MAGDHOW1",71,0)
 . D MESSAGE^MAGDHOW2(SERVICE)
"RTN","MAGDHOW1",72,0)
 . Q
"RTN","MAGDHOW1",73,0)
 ;
"RTN","MAGDHOW1",74,0)
 I ORC1="RE" D  ; do this for all consult results
"RTN","MAGDHOW1",75,0)
 . ; link any outstanding DICOM images to the new TIU note
"RTN","MAGDHOW1",76,0)
 . S I=$$NEWTIU^MAGDHOW0(GMRCIEN)
"RTN","MAGDHOW1",77,0)
 . Q
"RTN","MAGDHOW1",78,0)
 ;
"RTN","MAGDHOW1",79,0)
 Q
"RTN","MAGDHOW1",80,0)
 ;
"RTN","MAGDHOW1",81,0)
SERVICE(SERVICE,GMRCIEN,DIVISION,ITYPNAME,ITYPCODE,CPTIEN,HL7SUBLIST) ;
"RTN","MAGDHOW1",82,0)
 ; check if the service is in the DICOM Clinical Service dictionary, and
"RTN","MAGDHOW1",83,0)
 ; if so, then get all of the attributes
"RTN","MAGDHOW1",84,0)
 N MWLCONFIG,SENDIT,X,Y,Z
"RTN","MAGDHOW1",85,0)
 S (DIVISION,ITYPNAME,ITYPCODE,CPTIEN,HL7SUBLIST,SENDIT)=0
"RTN","MAGDHOW1",86,0)
 I SERVICE D  ; ignore SERVICE if it is null
"RTN","MAGDHOW1",87,0)
 . S MWLCONFIG=$$MWLFIND(SERVICE,GMRCIEN)
"RTN","MAGDHOW1",88,0)
 . S DIVISION=""
"RTN","MAGDHOW1",89,0)
 . I MWLCONFIG D  ; send order
"RTN","MAGDHOW1",90,0)
 . . S X=$G(^MAG(2006.5831,MWLCONFIG,0))
"RTN","MAGDHOW1",91,0)
 . . S DIVISION=$P(X,"^",5),CPTIEN=$P(X,"^",6),HL7SUBLIST=$P(X,"^",7)
"RTN","MAGDHOW1",92,0)
 . . I HL7SUBLIST,$$GET1^DIQ(779.4,HL7SUBLIST,.01)="" S HL7SUBLIST=0 ; absent
"RTN","MAGDHOW1",93,0)
 . . I 'HL7SUBLIST D  ; lookup default HL7 subscription list
"RTN","MAGDHOW1",94,0)
 . . . N DIC,DO,X,Y
"RTN","MAGDHOW1",95,0)
 . . . S DIC=779.4,DIC(0)="BX",X="MAGD DEFAULT" D ^DIC
"RTN","MAGDHOW1",96,0)
 . . . S HL7SUBLIST=$P(Y,"^",1) ; Y should equal "<ien>^MAGD DEFAULT"
"RTN","MAGDHOW1",97,0)
 . . . Q
"RTN","MAGDHOW1",98,0)
 . . ; get specialty index and procedure index (if available, otherwise, use 0)
"RTN","MAGDHOW1",99,0)
 . . S Y=$P(X,"^",3)
"RTN","MAGDHOW1",100,0)
 . . S ITYPNAME=$P(^MAG(2005.84,Y,0),"^",1)
"RTN","MAGDHOW1",101,0)
 . . S ITYPCODE=$P(^MAG(2005.84,Y,2),"^",1)
"RTN","MAGDHOW1",102,0)
 . . S Z=$P(X,"^",4)
"RTN","MAGDHOW1",103,0)
 . . I Z D  ; get procedure name and code
"RTN","MAGDHOW1",104,0)
 . . . S ITYPNAME=ITYPNAME_" -- "_$P(^MAG(2005.85,Z,0),"^",1)
"RTN","MAGDHOW1",105,0)
 . . . S ITYPCODE=ITYPCODE_"/"_$P(^MAG(2005.85,Z,2),"^",1)
"RTN","MAGDHOW1",106,0)
 . . . Q
"RTN","MAGDHOW1",107,0)
 . . S SENDIT=1
"RTN","MAGDHOW1",108,0)
 . . Q
"RTN","MAGDHOW1",109,0)
 . Q
"RTN","MAGDHOW1",110,0)
 Q SENDIT
"RTN","MAGDHOW1",111,0)
 ;
"RTN","MAGDHOW1",112,0)
MWLFIND(SERVICE,GMRCIEN) ; lookup 2006.5831 entry by service and procedure
"RTN","MAGDHOW1",113,0)
 ; ordering a procedure and the 2006.5831 procedure entry are optional
"RTN","MAGDHOW1",114,0)
 N PROCEDURE
"RTN","MAGDHOW1",115,0)
 S PROCEDURE=+$$GET1^DIQ(123,GMRCIEN,4,"I")
"RTN","MAGDHOW1",116,0)
 Q $$IREQUEST(SERVICE,PROCEDURE) ; pointer to modality worklist dictionary file #2006.5831
"RTN","MAGDHOW1",117,0)
 ;
"RTN","MAGDHOW1",118,0)
IREQUEST(SERVICE,PROCEDURE) ; return the IEN of the consult or procedure for the request service
"RTN","MAGDHOW1",119,0)
 N IEN,LIST
"RTN","MAGDHOW1",120,0)
 ;
"RTN","MAGDHOW1",121,0)
 S SERVICE=$G(SERVICE) I 'SERVICE Q 0
"RTN","MAGDHOW1",122,0)
 ;
"RTN","MAGDHOW1",123,0)
 ; if this is a lookup for a procedure, just return the "C" cross reference
"RTN","MAGDHOW1",124,0)
 S PROCEDURE=$G(PROCEDURE)
"RTN","MAGDHOW1",125,0)
 I PROCEDURE Q $O(^MAG(2006.5831,"C",SERVICE,PROCEDURE,""))
"RTN","MAGDHOW1",126,0)
 ;
"RTN","MAGDHOW1",127,0)
 ; use the "B" cross reference to make a list of all IENs for the request service
"RTN","MAGDHOW1",128,0)
 S IEN="" F  S IEN=$O(^MAG(2006.5831,"B",SERVICE,IEN)) Q:IEN=""  S LIST(IEN)=""
"RTN","MAGDHOW1",129,0)
 ;
"RTN","MAGDHOW1",130,0)
 ; use the "C" cross reference to delete the IENs for the procedures
"RTN","MAGDHOW1",131,0)
 S PROCEDURE="" F  S PROCEDURE=$O(^MAG(2006.5831,"C",SERVICE,PROCEDURE)) Q:PROCEDURE=""  D
"RTN","MAGDHOW1",132,0)
 . S IEN=$O(^MAG(2006.5831,"C",SERVICE,PROCEDURE,""))
"RTN","MAGDHOW1",133,0)
 . K LIST(IEN) ; remove the procedures from the list
"RTN","MAGDHOW1",134,0)
 . Q
"RTN","MAGDHOW1",135,0)
 ;
"RTN","MAGDHOW1",136,0)
 ; return what is left in the list, which should be the consult, if there is one
"RTN","MAGDHOW1",137,0)
 Q $O(LIST(""))
"RTN","MAGDHOWC")
0^4^B35470701
"RTN","MAGDHOWC",1,0)
MAGDHOWC ;WOIFO/PMK - Capture Consult/Procedure Request data ; 27 Nov 2012 12:32 PM
"RTN","MAGDHOWC",2,0)
 ;;3.0;IMAGING;**138,174**;Mar 19, 2002;Build 30;Sep 03, 2013
"RTN","MAGDHOWC",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHOWC",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOWC",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHOWC",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHOWC",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHOWC",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHOWC",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHOWC",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHOWC",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHOWC",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHOWC",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHOWC",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHOWC",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHOWC",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOWC",17,0)
 ;;
"RTN","MAGDHOWC",18,0)
ENTRY ;
"RTN","MAGDHOWC",19,0)
 ; determine the kind of message and branch appropriately
"RTN","MAGDHOWC",20,0)
 N APTSCHED,DEL,DEL2,DEL3,DEL4,DEL5,DFN,FILLER2,GMRCIEN,HL7,HL7MSH,HL7ORC
"RTN","MAGDHOWC",21,0)
 N I,SERVICE
"RTN","MAGDHOWC",22,0)
 ;
"RTN","MAGDHOWC",23,0)
 I $D(GMRCMSG) M HL7=GMRCMSG
"RTN","MAGDHOWC",24,0)
 E  I $D(XQORHSTK(0)) M HL7=XQORHSTK(0)
"RTN","MAGDHOWC",25,0)
 E  Q  ; can't find HL7 data to handle this!
"RTN","MAGDHOWC",26,0)
 S HL7MSH=HL7(1)
"RTN","MAGDHOWC",27,0)
 S DEL=$E(HL7MSH,4),X=$P(HL7MSH,DEL,2)
"RTN","MAGDHOWC",28,0)
 F I=1:1:$L(X) S @("DEL"_(I+1))=$E(X,I)
"RTN","MAGDHOWC",29,0)
 ;
"RTN","MAGDHOWC",30,0)
 ; find PID segment and get the DFN
"RTN","MAGDHOWC",31,0)
 S I=0 I '$$FINDSEG^MAGDHOW0(.HL7,"PID",.I,.X) Q  ; no PID segment
"RTN","MAGDHOWC",32,0)
 S DFN=$P(X,DEL,3)
"RTN","MAGDHOWC",33,0)
 ;
"RTN","MAGDHOWC",34,0)
 ; find ORC segment and get GMRCIEN
"RTN","MAGDHOWC",35,0)
 S I=0 I '$$FINDSEG^MAGDHOW0(.HL7,"ORC",.I,.HL7ORC) Q  ; no ORC segment
"RTN","MAGDHOWC",36,0)
 S GMRCIEN=+$P(HL7ORC,DEL,3) ; GMRC request is in ^GMR(123,GMRCIEN,...)
"RTN","MAGDHOWC",37,0)
 ;
"RTN","MAGDHOWC",38,0)
 D ^MAGDTR01 ; update the Read/Unread list with the data from the HL7 message
"RTN","MAGDHOWC",39,0)
 ;
"RTN","MAGDHOWC",40,0)
 S SERVICE=$$GET1^DIQ(123,GMRCIEN,1,"I")
"RTN","MAGDHOWC",41,0)
 D APTSCHED(GMRCIEN,SERVICE,.APTSCHED) ; get appointment scheduling information
"RTN","MAGDHOWC",42,0)
 ;
"RTN","MAGDHOWC",43,0)
 I $P($P(HL7ORC,DEL,16),DEL2,5)="FORWARD" D  ; check for a forwarded request
"RTN","MAGDHOWC",44,0)
 . N FROMSERVICE ; original service
"RTN","MAGDHOWC",45,0)
 . ; send an order cancellation to the original service
"RTN","MAGDHOWC",46,0)
 . S FILLER2="GMRC-CANCELLED" ; override actual GMRC status
"RTN","MAGDHOWC",47,0)
 . S FROMSERVICE=$$FWDFROM^MAGDGMRC(GMRCIEN) ; FORWARDED FROM service
"RTN","MAGDHOWC",48,0)
 . ;
"RTN","MAGDHOWC",49,0)
 . ; cancel the original order to the original service
"RTN","MAGDHOWC",50,0)
 . D MSGSETUP^MAGDHOW1(GMRCIEN,FROMSERVICE,"CA","CA") ; cancel order
"RTN","MAGDHOWC",51,0)
 . K FILLER2 ; use only for the first cancellation message
"RTN","MAGDHOWC",52,0)
 . ;
"RTN","MAGDHOWC",53,0)
 . ; send a new order to the new service
"RTN","MAGDHOWC",54,0)
 . D MSGSETUP^MAGDHOW1(GMRCIEN,SERVICE,"NW","IP",.APTSCHED) ; new order
"RTN","MAGDHOWC",55,0)
 . Q
"RTN","MAGDHOWC",56,0)
 ;
"RTN","MAGDHOWC",57,0)
 E  D  ; normal processing
"RTN","MAGDHOWC",58,0)
 . N ORC1,ORC5
"RTN","MAGDHOWC",59,0)
 . S ORC1=$P(HL7ORC,DEL,1) ; original HL7 message order control
"RTN","MAGDHOWC",60,0)
 . S ORC5=$P(HL7ORC,DEL,5) ; original HL7 message order status
"RTN","MAGDHOWC",61,0)
 . D MSGSETUP^MAGDHOW1(GMRCIEN,SERVICE,ORC1,ORC5,.APTSCHED) ; regular transaction
"RTN","MAGDHOWC",62,0)
 Q
"RTN","MAGDHOWC",63,0)
 ;
"RTN","MAGDHOWC",64,0)
APTSCHED(GMRCIEN,SERVICE,APTSCHED) ; get appointment scheduling information
"RTN","MAGDHOWC",65,0)
 ;
"RTN","MAGDHOWC",66,0)
 ; first check if the appointment information is in the comment
"RTN","MAGDHOWC",67,0)
 I $$CHECKCMT(GMRCIEN,.APTSCHED) Q
"RTN","MAGDHOWC",68,0)
 ;
"RTN","MAGDHOWC",69,0)
 ; no appointment information in th comment
"RTN","MAGDHOWC",70,0)
 ; check if there is an appointment that was previously scheduled
"RTN","MAGDHOWC",71,0)
 D CHECKAPT(GMRCIEN,SERVICE,.APTSCHED)
"RTN","MAGDHOWC",72,0)
 Q
"RTN","MAGDHOWC",73,0)
 ;
"RTN","MAGDHOWC",74,0)
CHECKCMT(GMRCIEN,APTSCHED)  ; check if appointment is scheduled (Patch SD*5.3*478)
"RTN","MAGDHOWC",75,0)
 N COMMENT,DATETIME,I,SCHEDULE,SS1,SS2,X,Y
"RTN","MAGDHOWC",76,0)
 K APTSCHED
"RTN","MAGDHOWC",77,0)
 S SCHEDULE=""
"RTN","MAGDHOWC",78,0)
 F I=1:1 D  Q:DATETIME=""
"RTN","MAGDHOWC",79,0)
 . S SS1=I_","_GMRCIEN ; subscript for file #123.02
"RTN","MAGDHOWC",80,0)
 . S DATETIME=$$GET1^DIQ(123.02,SS1,.01) Q:DATETIME=""
"RTN","MAGDHOWC",81,0)
 . S SS2="1,"_SS1 ; subscript for file #123.25
"RTN","MAGDHOWC",82,0)
 . S COMMENT=$$GET1^DIQ(123.25,SS2,.01) Q:COMMENT=""
"RTN","MAGDHOWC",83,0)
 . I COMMENT[" Consult Appt. on " S SCHEDULE=COMMENT
"RTN","MAGDHOWC",84,0)
 . Q
"RTN","MAGDHOWC",85,0)
 I SCHEDULE'="" D
"RTN","MAGDHOWC",86,0)
 . N %DT
"RTN","MAGDHOWC",87,0)
 . S X=$P(SCHEDULE," Consult Appt. on ",1)
"RTN","MAGDHOWC",88,0)
 . S Y=$S(X'="":$O(^SC("B",X,"")),1:"") ; clinic name could be null - their bug
"RTN","MAGDHOWC",89,0)
 . S APTSCHED("CLINIC IEN")=Y ; <file #44 ien>
"RTN","MAGDHOWC",90,0)
 . S APTSCHED("CLINIC NAME")=X
"RTN","MAGDHOWC",91,0)
 . S X=$P(SCHEDULE," Consult Appt. on ",2)
"RTN","MAGDHOWC",92,0)
 . S X=$TR(X," "),%DT="T" D ^%DT ; remove spaces & convert to FM format
"RTN","MAGDHOWC",93,0)
 . S APTSCHED("FM DATETIME")=Y
"RTN","MAGDHOWC",94,0)
 . Q
"RTN","MAGDHOWC",95,0)
 Q (SCHEDULE'="")
"RTN","MAGDHOWC",96,0)
 ;
"RTN","MAGDHOWC",97,0)
CHECKAPT(GMRCIEN,SERVICE,APTSCHED)  ; check if appointment was previously scheduled
"RTN","MAGDHOWC",98,0)
 ; quite often the appointment is entered before the order is entered
"RTN","MAGDHOWC",99,0)
 ; if this is the case, see if we can find the corresponding appointment
"RTN","MAGDHOWC",100,0)
 N A,CLINIC,DATETIME,EARLIEST,HIT,I,J,SDAMDFN,SDAMGMRCIEN,SS
"RTN","MAGDHOWC",101,0)
 ;
"RTN","MAGDHOWC",102,0)
 D SDA^VADPT ; get the list of the appointments
"RTN","MAGDHOWC",103,0)
 M A=^UTILITY("VASD",$J) K ^UTILITY("VASD",$J)
"RTN","MAGDHOWC",104,0)
 ;
"RTN","MAGDHOWC",105,0)
 ; remove appointments for other clinics
"RTN","MAGDHOWC",106,0)
 S I=0 F  S I=$O(A(I)) Q:'I  D
"RTN","MAGDHOWC",107,0)
 . S CLINIC=$P(A(I,"I"),"^",2)
"RTN","MAGDHOWC",108,0)
 . I '$$ISCLINIC(GMRCIEN,SERVICE,CLINIC) K A(I)
"RTN","MAGDHOWC",109,0)
 . Q
"RTN","MAGDHOWC",110,0)
 ; remove appointments for other consult/procedure requests
"RTN","MAGDHOWC",111,0)
 S (HIT,I)=0 F  S I=$O(A(I)) Q:'I  D
"RTN","MAGDHOWC",112,0)
 . S DATETIME=$P(A(I,"I"),"^",1),CLINIC=$P(A(I,"I"),"^",2)
"RTN","MAGDHOWC",113,0)
 . F J=1:1 D  Q:'SDAMDFN
"RTN","MAGDHOWC",114,0)
 . . S SS=J_","_DATETIME_","_CLINIC
"RTN","MAGDHOWC",115,0)
 . . S SDAMDFN=$$GET1^DIQ(44.003,SS,.01,"I")
"RTN","MAGDHOWC",116,0)
 . . I SDAMDFN=DFN D
"RTN","MAGDHOWC",117,0)
 . . . S SDAMGMRCIEN=$$GET1^DIQ(44.003,SS,688,"I")
"RTN","MAGDHOWC",118,0)
 . . . I SDAMGMRCIEN=GMRCIEN S HIT=I ; found one for this consult!
"RTN","MAGDHOWC",119,0)
 . . . E  I SDAMGMRCIEN'="" K A(I)
"RTN","MAGDHOWC",120,0)
 . . . ; keep ones without consult pointer 
"RTN","MAGDHOWC",121,0)
 . . . Q
"RTN","MAGDHOWC",122,0)
 . . Q
"RTN","MAGDHOWC",123,0)
 . Q
"RTN","MAGDHOWC",124,0)
 ;
"RTN","MAGDHOWC",125,0)
 I 'HIT D  ; get the earliest possible date for the appointment
"RTN","MAGDHOWC",126,0)
 . S EARLIEST=$$GET1^DIQ(123,GMRCIEN,17,"I")
"RTN","MAGDHOWC",127,0)
 . I EARLIEST D
"RTN","MAGDHOWC",128,0)
 . . S I=0 F  S I=$O(A(I)) Q:'I  D  Q:HIT
"RTN","MAGDHOWC",129,0)
 . . . I A(I,"I")>EARLIEST S HIT=I
"RTN","MAGDHOWC",130,0)
 . . . Q
"RTN","MAGDHOWC",131,0)
 . . Q
"RTN","MAGDHOWC",132,0)
 . E  S HIT=$O(A("")) ; pick the earliest scheduled appointment
"RTN","MAGDHOWC",133,0)
 . Q
"RTN","MAGDHOWC",134,0)
 ;
"RTN","MAGDHOWC",135,0)
 I HIT D
"RTN","MAGDHOWC",136,0)
 . S APTSCHED("FM DATETIME")=$P(A(HIT,"I"),"^",1)
"RTN","MAGDHOWC",137,0)
 . S APTSCHED("CLINIC IEN")=$P(A(HIT,"I"),"^",2)
"RTN","MAGDHOWC",138,0)
 . S APTSCHED("DATETIME")=$P(A(HIT,"E"),"^",1)
"RTN","MAGDHOWC",139,0)
 . S APTSCHED("CLINIC NAME")=$P(A(HIT,"E"),"^",2)
"RTN","MAGDHOWC",140,0)
 . S FILLER2="GMRC-SCHEDULED" ; over-ride GMRC's status
"RTN","MAGDHOWC",141,0)
 . ; Note: If the study has been completed, FILLER2 will be killed in
"RTN","MAGDHOWC",142,0)
 . ;       MAGSETUP^MAGHOW1 so that GMRC's actual status will be used.
"RTN","MAGDHOWC",143,0)
 . Q
"RTN","MAGDHOWC",144,0)
 Q
"RTN","MAGDHOWC",145,0)
 ;
"RTN","MAGDHOWC",146,0)
ISCLINIC(GMRCIEN,SERVICE,CLINIC) ; is a particular clinic defined for a given service?
"RTN","MAGDHOWC",147,0)
 N IEN,ISCLINIC
"RTN","MAGDHOWC",148,0)
 S ISCLINIC=0
"RTN","MAGDHOWC",149,0)
 I GMRCIEN,SERVICE,CLINIC D
"RTN","MAGDHOWC",150,0)
 . S IEN=$$MWLFIND^MAGDHOW1(SERVICE,GMRCIEN)
"RTN","MAGDHOWC",151,0)
 . I IEN,$D(^MAG(2006.5831,IEN,1,"B",CLINIC)) S ISCLINIC=1
"RTN","MAGDHOWC",152,0)
 . Q
"RTN","MAGDHOWC",153,0)
 Q ISCLINIC
"RTN","MAGDHOWS")
0^5^B13563936
"RTN","MAGDHOWS",1,0)
MAGDHOWS ;WOIFO/PMK,DAC - Capture Consult/GMRC data ; 25 Ocy 2016 12:41 PM
"RTN","MAGDHOWS",2,0)
 ;;3.0;IMAGING;**138,174**;Mar 19, 2002;Build 30
"RTN","MAGDHOWS",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHOWS",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOWS",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHOWS",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHOWS",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHOWS",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHOWS",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHOWS",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHOWS",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHOWS",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHOWS",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHOWS",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHOWS",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHOWS",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHOWS",17,0)
 ;;
"RTN","MAGDHOWS",18,0)
 ; Called from PROTOCOL called MAGD APPOINTMENT (^ORD(101,...))
"RTN","MAGDHOWS",19,0)
 ; through the scheduling package
"RTN","MAGDHOWS",20,0)
 ;
"RTN","MAGDHOWS",21,0)
 N %,AFTERSTS,APTSCHED,CLINIC,CONSULTM,CUTOFF,DATETIME
"RTN","MAGDHOWS",22,0)
 N DFN,FILLER2,FMDATE,FMDATETM
"RTN","MAGDHOWS",23,0)
 N GMRCIEN,HIT,I,IREQ,MSGTYPE
"RTN","MAGDHOWS",24,0)
 N ORCTRL,ORSTATUS,SDAMDFN,SENDIT,SERVICE,SS,STATUS,UNKNOWN,X,Y,Z
"RTN","MAGDHOWS",25,0)
 ;
"RTN","MAGDHOWS",26,0)
 Q:$P($G(SDATA("AFTER","STATUS")),"^",3)=""  ; Not a valid appointment
"RTN","MAGDHOWS",27,0)
 ;
"RTN","MAGDHOWS",28,0)
 ;
"RTN","MAGDHOWS",29,0)
 S FMDATETM=$$NOW^XLFDT(),FMDATE=FMDATETM\1
"RTN","MAGDHOWS",30,0)
 S CUTOFF=$$HTFM^XLFDT($H-90) ; cutoff date is 90 days ago
"RTN","MAGDHOWS",31,0)
 S DFN=$P(SDATA,"^",2),DATETIME=$P(SDATA,"^",3),CLINIC=$P(SDATA,"^",4)
"RTN","MAGDHOWS",32,0)
 S APTSCHED("CLINIC IEN")=CLINIC,APTSCHED("FM DATETIME")=DATETIME
"RTN","MAGDHOWS",33,0)
 S APTSCHED("CLINIC NAME")=$S(CLINIC:$$GET1^DIQ(44,CLINIC,.01),1:"")
"RTN","MAGDHOWS",34,0)
 S AFTERSTS=SDATA("AFTER","STATUS"),X=$P(AFTERSTS,"^",3)
"RTN","MAGDHOWS",35,0)
 ; appointment management transactions from ^SD(409.63)
"RTN","MAGDHOWS",36,0)
 S FILLER2="" D  Q:FILLER2=""
"RTN","MAGDHOWS",37,0)
 . I X["CHECK IN" S FILLER2="SDAM-CHECKIN" Q
"RTN","MAGDHOWS",38,0)
 . I X["CHECKED IN" S FILLER2="SDAM-CHECKIN" Q
"RTN","MAGDHOWS",39,0)
 . I X["CHECK OUT" S FILLER2="SDAM-CHECKOUT" Q
"RTN","MAGDHOWS",40,0)
 . I X["CHECKED OUT" S FILLER2="SDAM-CHECKOUT" Q
"RTN","MAGDHOWS",41,0)
 . I X["AUTO RE-" S FILLER2="SDAM-SCHEDULED" Q
"RTN","MAGDHOWS",42,0)
 . I X["AUTO-RE" S FILLER2="SDAM-SCHEDULED" Q
"RTN","MAGDHOWS",43,0)
 . I X["ACTION REQUIRED" S FILLER2="SDAM-SCHEDULED" Q
"RTN","MAGDHOWS",44,0)
 . I X["ACT REQ" S FILLER2="SDAM-SCHEDULED" Q
"RTN","MAGDHOWS",45,0)
 . I X["NON-COUNT" S FILLER2="SDAM-SCHEDULED" Q
"RTN","MAGDHOWS",46,0)
 . I X["CANCELLED" S FILLER2="SDAM-CANCELLED" Q
"RTN","MAGDHOWS",47,0)
 . I X["NO-SHOW" S FILLER2="SDAM-CANCELLED" Q
"RTN","MAGDHOWS",48,0)
 . I X["DELETED" S FILLER2="SDAM-CANCELLED" Q
"RTN","MAGDHOWS",49,0)
 . I X["FUTURE" S FILLER2="SDAM-FUTURE" Q
"RTN","MAGDHOWS",50,0)
 . I X["NO ACTION TAKEN" S FILLER2="SDAM-SCHEDULED" Q
"RTN","MAGDHOWS",51,0)
 . I X["NO ACT TAKN" S FILLER2="SDAM-SCHEDULED" Q
"RTN","MAGDHOWS",52,0)
 . I X["INPATIENT" S FILLER2="SDAM-SCHEDULED" Q
"RTN","MAGDHOWS",53,0)
 . ;
"RTN","MAGDHOWS",54,0)
 . W !!,"Unexpected Status: """,X,""" in protocol MAGD APPOINTMENT."
"RTN","MAGDHOWS",55,0)
 . W !,"Please notify Customer Support"
"RTN","MAGDHOWS",56,0)
 . W !!,"Press <Enter> to continue: " R X:$G(DTIME,300)
"RTN","MAGDHOWS",57,0)
 . Q
"RTN","MAGDHOWS",58,0)
 ;
"RTN","MAGDHOWS",59,0)
 ; find the associated consult or procedure request using SD*5.3*478
"RTN","MAGDHOWS",60,0)
 S GMRCIEN="" F I=1:1 D  Q:GMRCIEN  Q:'SDAMDFN
"RTN","MAGDHOWS",61,0)
 . S SS=I_","_DATETIME_","_CLINIC
"RTN","MAGDHOWS",62,0)
 . S SDAMDFN=$$GET1^DIQ(44.003,SS,.01,"I")
"RTN","MAGDHOWS",63,0)
 . I SDAMDFN=DFN S GMRCIEN=$$GET1^DIQ(44.003,SS,688,"I")
"RTN","MAGDHOWS",64,0)
 . Q
"RTN","MAGDHOWS",65,0)
 ;
"RTN","MAGDHOWS",66,0)
 I GMRCIEN D  ; consult linked to appointment
"RTN","MAGDHOWS",67,0)
 . N GMRCSTATUS ; P174 DAC - link appointments only to active consults, ignore the rest
"RTN","MAGDHOWS",68,0)
 . S GMRCSTATUS=$$GET1^DIQ(123,GMRCIEN,8,"E")
"RTN","MAGDHOWS",69,0)
 . I "^ACTIVE^PENDING^RENEWED^SCHEDULED^"[("^"_GMRCSTATUS_"^") D
"RTN","MAGDHOWS",70,0)
 . . S SERVICE=$$GET1^DIQ(123,GMRCIEN,1,"I")
"RTN","MAGDHOWS",71,0)
 . . D MSGSETUP^MAGDHOW1(GMRCIEN,SERVICE,"XO","SC",.APTSCHED)
"RTN","MAGDHOWS",72,0)
 . . Q
"RTN","MAGDHOWS",73,0)
 . Q
"RTN","MAGDHOWS",74,0)
 Q
"RTN","MAGIP174")
0^1^B4110422
"RTN","MAGIP174",1,0)
MAGIP174 ;WOIFO/DAC - Install code for MAG*3.0*174 ; 31 Aug 2016 12:30 PM
"RTN","MAGIP174",2,0)
 ;;3.0;IMAGING;**174**;Mar 19, 2002;Build 30
"RTN","MAGIP174",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIP174",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP174",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIP174",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIP174",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIP174",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIP174",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIP174",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIP174",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIP174",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIP174",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIP174",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIP174",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIP174",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP174",17,0)
 ;;
"RTN","MAGIP174",18,0)
 ; There are no environment checks here but the MAGIP174 has to be
"RTN","MAGIP174",19,0)
 ; referenced by the "Environment Check Routine" field of the KIDS
"RTN","MAGIP174",20,0)
 ; build so that entry points of the routine are available to the
"RTN","MAGIP174",21,0)
 ; KIDS during all installation phases.
"RTN","MAGIP174",22,0)
 Q
"RTN","MAGIP174",23,0)
 ;
"RTN","MAGIP174",24,0)
 ;+++++ INSTALLATION ERROR HANDLING
"RTN","MAGIP174",25,0)
ERROR ;
"RTN","MAGIP174",26,0)
 S:$D(XPDNM) XPDABORT=1
"RTN","MAGIP174",27,0)
 ;--- Display the messages and store them to the INSTALL file
"RTN","MAGIP174",28,0)
 D DUMP^MAGUERR1(),ABTMSG^MAGKIDS()
"RTN","MAGIP174",29,0)
 Q
"RTN","MAGIP174",30,0)
 ;
"RTN","MAGIP174",31,0)
 ;***** POST-INSTALL CODE
"RTN","MAGIP174",32,0)
POS ;
"RTN","MAGIP174",33,0)
 N CALLBACK
"RTN","MAGIP174",34,0)
 D CLEAR^MAGUERR(1)
"RTN","MAGIP174",35,0)
 ;
"RTN","MAGIP174",36,0)
 ;--- Send the notification e-mail
"RTN","MAGIP174",37,0)
 D BMES^XPDUTL("Post Install Mail Message: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","MAGIP174",38,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGIP174",39,0)
 Q
"RTN","MAGIP174",40,0)
 ;
"RTN","MAGIP174",41,0)
 ;***** PRE-INSTALL CODE
"RTN","MAGIP174",42,0)
PRE ;
"RTN","MAGIP174",43,0)
 Q
"VER")
8.0^22.0
**END**
**END**
