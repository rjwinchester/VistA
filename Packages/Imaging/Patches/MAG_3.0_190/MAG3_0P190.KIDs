KIDS Distribution saved on Apr 26, 2018@09:05:42
VistA Imaging V3.0 - Patch 190
**KIDS**:MAG*3.0*190^

**INSTALL NAME**
MAG*3.0*190
"BLD",8366,0)
MAG*3.0*190^IMAGING^0^3180426^y
"BLD",8366,1,0)
^^10^10^3171226^
"BLD",8366,1,1,0)
VistA Imaging V3.0 - Patch 190
"BLD",8366,1,2,0)
 
"BLD",8366,1,3,0)
Routines:
"BLD",8366,1,4,0)
 
"BLD",8366,1,5,0)
MAGDRPC5
"BLD",8366,1,6,0)
MAGDRPC9 
"BLD",8366,1,7,0)
MAGIP190
"BLD",8366,1,8,0)
 
"BLD",8366,1,9,0)
Please note that routine MAGIP190 is deleted after the KIDS build is
"BLD",8366,1,10,0)
installed
"BLD",8366,4,0)
^9.64PA^^
"BLD",8366,6.3)
2
"BLD",8366,"ABNS",0)
^9.66A^^
"BLD",8366,"ABPKG")
n^n^G.IMAGING DEVELOPMENT TEAM@DOMAIN.EXT
"BLD",8366,"INID")
n^y^n
"BLD",8366,"INIT")
MAGIP190
"BLD",8366,"KRN",0)
^9.67PA^779.2^20
"BLD",8366,"KRN",.4,0)
.4
"BLD",8366,"KRN",.401,0)
.401
"BLD",8366,"KRN",.402,0)
.402
"BLD",8366,"KRN",.403,0)
.403
"BLD",8366,"KRN",.5,0)
.5
"BLD",8366,"KRN",.84,0)
.84
"BLD",8366,"KRN",3.6,0)
3.6
"BLD",8366,"KRN",3.8,0)
3.8
"BLD",8366,"KRN",9.2,0)
9.2
"BLD",8366,"KRN",9.8,0)
9.8
"BLD",8366,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",8366,"KRN",9.8,"NM",1,0)
MAGDRPC5^^0^B84608025
"BLD",8366,"KRN",9.8,"NM",2,0)
MAGDRPC9^^0^B97395044
"BLD",8366,"KRN",9.8,"NM",3,0)
MAGIP190^^0^B4110402
"BLD",8366,"KRN",9.8,"NM","B","MAGDRPC5",1)

"BLD",8366,"KRN",9.8,"NM","B","MAGDRPC9",2)

"BLD",8366,"KRN",9.8,"NM","B","MAGIP190",3)

"BLD",8366,"KRN",19,0)
19
"BLD",8366,"KRN",19.1,0)
19.1
"BLD",8366,"KRN",101,0)
101
"BLD",8366,"KRN",409.61,0)
409.61
"BLD",8366,"KRN",771,0)
771
"BLD",8366,"KRN",779.2,0)
779.2
"BLD",8366,"KRN",870,0)
870
"BLD",8366,"KRN",8989.51,0)
8989.51
"BLD",8366,"KRN",8989.52,0)
8989.52
"BLD",8366,"KRN",8994,0)
8994
"BLD",8366,"KRN","B",.4,.4)

"BLD",8366,"KRN","B",.401,.401)

"BLD",8366,"KRN","B",.402,.402)

"BLD",8366,"KRN","B",.403,.403)

"BLD",8366,"KRN","B",.5,.5)

"BLD",8366,"KRN","B",.84,.84)

"BLD",8366,"KRN","B",3.6,3.6)

"BLD",8366,"KRN","B",3.8,3.8)

"BLD",8366,"KRN","B",9.2,9.2)

"BLD",8366,"KRN","B",9.8,9.8)

"BLD",8366,"KRN","B",19,19)

"BLD",8366,"KRN","B",19.1,19.1)

"BLD",8366,"KRN","B",101,101)

"BLD",8366,"KRN","B",409.61,409.61)

"BLD",8366,"KRN","B",771,771)

"BLD",8366,"KRN","B",779.2,779.2)

"BLD",8366,"KRN","B",870,870)

"BLD",8366,"KRN","B",8989.51,8989.51)

"BLD",8366,"KRN","B",8989.52,8989.52)

"BLD",8366,"KRN","B",8994,8994)

"BLD",8366,"QUES",0)
^9.62^^
"BLD",8366,"REQB",0)
^9.611^^0
"INIT")
MAGIP190
"MBREQ")
0
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging-V1 to release 
"PKG",454,20,0)
^9.402P^^
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020319^3020517^126
"PKG",454,22,1,"PAH",1,0)
190^3180426^126
"PKG",454,22,1,"PAH",1,1,0)
^^10^10^3180426
"PKG",454,22,1,"PAH",1,1,1,0)
VistA Imaging V3.0 - Patch 190
"PKG",454,22,1,"PAH",1,1,2,0)
 
"PKG",454,22,1,"PAH",1,1,3,0)
Routines:
"PKG",454,22,1,"PAH",1,1,4,0)
 
"PKG",454,22,1,"PAH",1,1,5,0)
MAGDRPC5
"PKG",454,22,1,"PAH",1,1,6,0)
MAGDRPC9 
"PKG",454,22,1,"PAH",1,1,7,0)
MAGIP190
"PKG",454,22,1,"PAH",1,1,8,0)
 
"PKG",454,22,1,"PAH",1,1,9,0)
Please note that routine MAGIP190 is deleted after the KIDS build is
"PKG",454,22,1,"PAH",1,1,10,0)
installed
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","MAGDRPC5")
0^1^B84608025
"RTN","MAGDRPC5",1,0)
MAGDRPC5 ;WOIFO/EdM,DAC - Routing RPCs ; 26 Oct 2017 3:12PM
"RTN","MAGDRPC5",2,0)
 ;;3.0;IMAGING;**11,30,51,85,54,190**;;Build 2
"RTN","MAGDRPC5",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDRPC5",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC5",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC5",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC5",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC5",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC5",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC5",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC5",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC5",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC5",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC5",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC5",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC5",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC5",17,0)
 ;;
"RTN","MAGDRPC5",18,0)
 Q
"RTN","MAGDRPC5",19,0)
 ;
"RTN","MAGDRPC5",20,0)
START(OUT,LOCATION,RULES) ; RPC = MAG DICOM ROUTE EVAL START
"RTN","MAGDRPC5",21,0)
 N I,LOC,X,ZTDESC,ZTDTH,ZTRTN,ZTSAVE
"RTN","MAGDRPC5",22,0)
 ;
"RTN","MAGDRPC5",23,0)
 D XTINIT
"RTN","MAGDRPC5",24,0)
 ;
"RTN","MAGDRPC5",25,0)
 I '$G(LOCATION) S OUT="-1,No Location Specified" Q
"RTN","MAGDRPC5",26,0)
 I '$O(RULES("")) S OUT="-2,No Routing Rules Specified" Q
"RTN","MAGDRPC5",27,0)
 ;
"RTN","MAGDRPC5",28,0)
 S LOC=$$GET1^DIQ(4,LOCATION,.01)
"RTN","MAGDRPC5",29,0)
 L +^MAGDICOM(2006.563,1,"EVAL",LOCATION):0 E  D  Q
"RTN","MAGDRPC5",30,0)
 . S OUT="-3,A Rule Evaluator is Already Running for "_LOC
"RTN","MAGDRPC5",31,0)
 . Q
"RTN","MAGDRPC5",32,0)
 ;
"RTN","MAGDRPC5",33,0)
 S ^MAGDICOM(2006.563,1,"EVAL")=1
"RTN","MAGDRPC5",34,0)
 S ZTRTN="EVAL^MAGBRTE4"
"RTN","MAGDRPC5",35,0)
 S ZTDESC="Evaluate Routing Rules for Origin="_LOC
"RTN","MAGDRPC5",36,0)
 S ZTDTH=$H
"RTN","MAGDRPC5",37,0)
 S ZTSAVE("LOCATION")=LOCATION
"RTN","MAGDRPC5",38,0)
 S I="" F  S I=$O(RULES(I)) Q:I=""  S:+I=I ZTSAVE("RULES("_I_")")=RULES(I)
"RTN","MAGDRPC5",39,0)
 D ^%ZTLOAD,HOME^%ZIS
"RTN","MAGDRPC5",40,0)
 L -^MAGDICOM(2006.563,1,"EVAL",LOCATION)
"RTN","MAGDRPC5",41,0)
 I '$D(ZTSK) S OUT="-4,TaskMan did not Accept Request" Q
"RTN","MAGDRPC5",42,0)
 S OUT="0,TaskMan task#="_ZTSK
"RTN","MAGDRPC5",43,0)
 Q
"RTN","MAGDRPC5",44,0)
 ;
"RTN","MAGDRPC5",45,0)
STOP(OUT) ; RPC = MAG DICOM ROUTE EVAL STOP
"RTN","MAGDRPC5",46,0)
 S ^MAGDICOM(2006.563,1,"EVAL")=0,OUT=1
"RTN","MAGDRPC5",47,0)
 Q
"RTN","MAGDRPC5",48,0)
 ;
"RTN","MAGDRPC5",49,0)
XMIT(OUT,LOCATION,DEST,PRIOR,MECH,DESTS) ; RPC = MAG DICOM ROUTE NEXT FILE
"RTN","MAGDRPC5",50,0)
 N D0,DIR,DL,IM,M,NOW,OK,PLACE,TP,VP,X
"RTN","MAGDRPC5",51,0)
 ;
"RTN","MAGDRPC5",52,0)
 S PLACE=$$PLACE^MAGDRPC2(LOCATION)
"RTN","MAGDRPC5",53,0)
 S $P(^MAG(2006.1,PLACE,"LASTROUTE"),"^",1)=DT
"RTN","MAGDRPC5",54,0)
 ;
"RTN","MAGDRPC5",55,0)
 K OUT S OUT(1)=0,OK=0
"RTN","MAGDRPC5",56,0)
 S:'$G(MECH) MECH=1 I MECH'=1,MECH'=2 S MECH=1
"RTN","MAGDRPC5",57,0)
 I '$G(LOCATION) S OUT(1)="-1,No Location Specified" Q
"RTN","MAGDRPC5",58,0)
 S VP(1)=";MAG(2005.2,"
"RTN","MAGDRPC5",59,0)
 S VP(2)=";MAG(2006.587,"
"RTN","MAGDRPC5",60,0)
 S:$G(DEST) DEST=+DEST_VP(MECH)
"RTN","MAGDRPC5",61,0)
 S M="" F  S M=$O(DESTS(M)) Q:M=""  D
"RTN","MAGDRPC5",62,0)
 . S X=DESTS(M) Q:X'["^"  Q:$P(X,"^",1)'=MECH  Q:'$P(X,"^",2)
"RTN","MAGDRPC5",63,0)
 . S DL($P(X,"^",2)_VP(MECH))=""
"RTN","MAGDRPC5",64,0)
 . Q
"RTN","MAGDRPC5",65,0)
 I $O(DL(""))="" S OUT(1)="-2,No Valid Destinations Specified" Q
"RTN","MAGDRPC5",66,0)
 S:'$G(DEST) (PRIOR,DEST)=""
"RTN","MAGDRPC5",67,0)
 I $G(PRIOR) D
"RTN","MAGDRPC5",68,0)
 . I DEST S X=0 F  D  Q:X
"RTN","MAGDRPC5",69,0)
 . . N NXT
"RTN","MAGDRPC5",70,0)
 . . I $P($G(^MAG(2005.2,+DEST,0)),"^",6) S X=1 Q
"RTN","MAGDRPC5",71,0)
 . . S NOW=$$NOW^XLFDT()*1E6
"RTN","MAGDRPC5",72,0)
 . . S X=$P($G(^MAG(2005.2,+DEST,3)),"^",6)*1E6
"RTN","MAGDRPC5",73,0)
 . . I NOW-X>1500 D ONOFLINE(.X,+DEST,1) Q
"RTN","MAGDRPC5",74,0)
 . . S X=0,NXT=0
"RTN","MAGDRPC5",75,0)
 . . F  S DEST=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR,DEST)) Q:DEST=""  D  Q:NXT
"RTN","MAGDRPC5",76,0)
 . . . S:$D(DL(DEST)) NXT=1
"RTN","MAGDRPC5",77,0)
 . . . Q
"RTN","MAGDRPC5",78,0)
 . . S:'DEST X=1
"RTN","MAGDRPC5",79,0)
 . . Q
"RTN","MAGDRPC5",80,0)
 . I 'DEST S (PRIOR,DEST)="" Q
"RTN","MAGDRPC5",81,0)
 . F  D  Q:OK
"RTN","MAGDRPC5",82,0)
 . . S D0=+$G(D0)
"RTN","MAGDRPC5",83,0)
 . . S D0=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR,DEST,D0))
"RTN","MAGDRPC5",84,0)
 . . I 'D0 S OK=1 Q
"RTN","MAGDRPC5",85,0)
 . . S M=$P($G(^MAGQUEUE(2006.035,D0,0)),"^",4) I M'=1,M'=2 S M=1
"RTN","MAGDRPC5",86,0)
 . . I M=MECH S OK=1 Q
"RTN","MAGDRPC5",87,0)
 . . S (PRIOR,DEST)=""
"RTN","MAGDRPC5",88,0)
 . . Q
"RTN","MAGDRPC5",89,0)
 . Q
"RTN","MAGDRPC5",90,0)
 I OK D:$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR))
"RTN","MAGDRPC5",91,0)
 . ;
"RTN","MAGDRPC5",92,0)
 . ; Ignore higher priority items for destinations that are not accessible
"RTN","MAGDRPC5",93,0)
 . ;
"RTN","MAGDRPC5",94,0)
 . N A,D,P,T,X
"RTN","MAGDRPC5",95,0)
 . S P=PRIOR F  S P=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",P)) Q:'P  D  Q:'PRIOR
"RTN","MAGDRPC5",96,0)
 . . S D="" F  S D=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",P,D)) Q:D=""  D  Q:'PRIOR
"RTN","MAGDRPC5",97,0)
 . . . ; Interrupt only if we're transmitting there
"RTN","MAGDRPC5",98,0)
 . . . Q:'$D(DL(D))
"RTN","MAGDRPC5",99,0)
 . . . ;
"RTN","MAGDRPC5",100,0)
 . . . D:'$P(^MAG(2005.2,+D,0),"^",6)
"RTN","MAGDRPC5",101,0)
 . . . . S NOW=$$NOW^XLFDT()*1E6
"RTN","MAGDRPC5",102,0)
 . . . . S X=$P($G(^MAG(2005.2,+D,3)),"^",6)*1E6 Q:NOW-X<1500
"RTN","MAGDRPC5",103,0)
 . . . . D ONOFLINE(.X,+D,1)
"RTN","MAGDRPC5",104,0)
 . . . . Q
"RTN","MAGDRPC5",105,0)
 . . . S:$P(^MAG(2005.2,+D,0),"^",6) PRIOR=0
"RTN","MAGDRPC5",106,0)
 . . . Q
"RTN","MAGDRPC5",107,0)
 . . Q
"RTN","MAGDRPC5",108,0)
 . Q
"RTN","MAGDRPC5",109,0)
 I '$G(PRIOR) F  D  Q:OK  Q:'PRIOR
"RTN","MAGDRPC5",110,0)
 . S PRIOR=" " F  S PRIOR=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR),-1) Q:'PRIOR  D  Q:OK
"RTN","MAGDRPC5",111,0)
 . . S DEST="" F  S DEST=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR,DEST)) Q:DEST=""  D:$D(DL(DEST))  Q:OK
"RTN","MAGDRPC5",112,0)
 . . . D:'$P(^MAG(2005.2,+DEST,0),"^",6)
"RTN","MAGDRPC5",113,0)
 . . . . S NOW=$$NOW^XLFDT()*1E6
"RTN","MAGDRPC5",114,0)
 . . . . S X=$P($G(^MAG(2005.2,+DEST,3)),"^",6)*1E6 Q:NOW-X<1500
"RTN","MAGDRPC5",115,0)
 . . . . D ONOFLINE(.X,+DEST,1)
"RTN","MAGDRPC5",116,0)
 . . . . Q
"RTN","MAGDRPC5",117,0)
 . . . Q:'$P(^MAG(2005.2,+DEST,0),"^",6)
"RTN","MAGDRPC5",118,0)
 . . . S D0="" F  S D0=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR,DEST,D0)) Q:D0=""  D  Q:OK
"RTN","MAGDRPC5",119,0)
 . . . . S M=$P($G(^MAGQUEUE(2006.035,D0,0)),"^",4) I M'=1,M'=2 S M=1
"RTN","MAGDRPC5",120,0)
 . . . . I M=MECH S OK=1 Q
"RTN","MAGDRPC5",121,0)
 . . . . Q
"RTN","MAGDRPC5",122,0)
 . . . Q
"RTN","MAGDRPC5",123,0)
 . . Q
"RTN","MAGDRPC5",124,0)
 . Q
"RTN","MAGDRPC5",125,0)
 Q:'PRIOR
"RTN","MAGDRPC5",126,0)
 Q:'OK
"RTN","MAGDRPC5",127,0)
 I 'D0 S OUT(1)=0 Q  ; All files transmitted
"RTN","MAGDRPC5",128,0)
 ;
"RTN","MAGDRPC5",129,0)
 S X=^MAGQUEUE(2006.035,D0,0),IM=$P(X,"^",1),TP=$P(X,"^",3)
"RTN","MAGDRPC5",130,0)
 I 'IM D STATUS(X,D0,"SENT",LOCATION) S OUT(1)=2 Q
"RTN","MAGDRPC5",131,0)
 S OUT(2)=+DEST,OUT(3)=PRIOR,OUT(4)=MECH,OUT(9)=D0
"RTN","MAGDRPC5",132,0)
 S X=$G(^MAG(2005.2,+DEST,2)),OUT(5)=$P(X,"^",1),OUT(6)=$P(X,"^",2)
"RTN","MAGDRPC5",133,0)
 D STATUS(X,D0,"SENDING",LOCATION)
"RTN","MAGDRPC5",134,0)
 S OUT(10)=$P(^MAG(2005.2,+DEST,0),"^",2)
"RTN","MAGDRPC5",135,0)
 S DIR=$P($G(^MAG(2005.2,+DEST,4)),"^",2)
"RTN","MAGDRPC5",136,0)
 S OUT(11)=$G(^MAG(2005.2,+DEST,3))
"RTN","MAGDRPC5",137,0)
 S OUT(12)=IM
"RTN","MAGDRPC5",138,0)
 S OUT(13)=$P($G(^MAGQUEUE(2006.035,D0,1)),"^",3)
"RTN","MAGDRPC5",139,0)
 S OUT(14)=$P($G(^MAG(2005.2,+DEST,1)),"^",7) S:OUT(14)="" OUT(14)="NONE"
"RTN","MAGDRPC5",140,0)
 D XMIT^MAGDRPC6 ; Routine grew over 10,000 characters
"RTN","MAGDRPC5",141,0)
 I MECH=2 S OUT(2)=OUT(2)_"^"_$P($G(^MAG(2006.587,+DEST,0)),"^",1)
"RTN","MAGDRPC5",142,0)
 Q
"RTN","MAGDRPC5",143,0)
 ;
"RTN","MAGDRPC5",144,0)
PURGE(OUT,LOCATION,DEST,MAX,DONE) ; RPC = MAG DICOM ROUTE GET PURGE
"RTN","MAGDRPC5",145,0)
 N D0,D1,FILE,FMFILE,I,LIMIT,MORE,NOW,RETAIN,STAMP,STATUS,X
"RTN","MAGDRPC5",146,0)
 ;
"RTN","MAGDRPC5",147,0)
 S NOW=$$NOW^XLFDT()
"RTN","MAGDRPC5",148,0)
 K OUT S OUT(1)=1
"RTN","MAGDRPC5",149,0)
 S:$D(^MAG(2005.2,DEST,0)) $P(^MAG(2005.2,DEST,3),"^",4)=DT
"RTN","MAGDRPC5",150,0)
 S X=^MAG(2005.2,DEST,3)
"RTN","MAGDRPC5",151,0)
 S RETAIN=$P(X,"^",1) S:RETAIN="" RETAIN=32 S:RETAIN<0 RETAIN=0
"RTN","MAGDRPC5",152,0)
 S LIMIT=$H-RETAIN
"RTN","MAGDRPC5",153,0)
 ;
"RTN","MAGDRPC5",154,0)
 S X=$G(DONE(1)),MORE="" S:$E(X,1)="^" MORE=$P(X,"^",4,6)
"RTN","MAGDRPC5",155,0)
 ;
"RTN","MAGDRPC5",156,0)
 S I="" F  S I=$O(DONE(I)) Q:I=""  D
"RTN","MAGDRPC5",157,0)
 . N D41,D61
"RTN","MAGDRPC5",158,0)
 . S X=$G(DONE(I))
"RTN","MAGDRPC5",159,0)
 . S D0=$P(X,"^",2),D41=$P(X,"^",3)
"RTN","MAGDRPC5",160,0)
 . S STAMP=$P(X,"^",4)
"RTN","MAGDRPC5",161,0)
 . Q:'D0  Q:'D41
"RTN","MAGDRPC5",162,0)
 . ; Just in case the image is being deleted as this purge is taking place
"RTN","MAGDRPC5",163,0)
 . F FMFILE=2005,2005.1 D
"RTN","MAGDRPC5",164,0)
 . . K ^MAG(FMFILE,"ROUTE",DEST,STAMP,D0,D41)
"RTN","MAGDRPC5",165,0)
 . . S D61=$P($G(^MAG(FMFILE,D0,4,D41,0)),"^",7)
"RTN","MAGDRPC5",166,0)
 . . K ^MAG(FMFILE,D0,4,"LOC",DEST,D41)
"RTN","MAGDRPC5",167,0)
 . . K ^MAG(FMFILE,D0,4,D41,0)
"RTN","MAGDRPC5",168,0)
 . . S:D61 $P(^MAG(FMFILE,D0,6,D61,0),"^",5)=NOW
"RTN","MAGDRPC5",169,0)
 . . Q
"RTN","MAGDRPC5",170,0)
 . S MORE=""
"RTN","MAGDRPC5",171,0)
 . Q
"RTN","MAGDRPC5",172,0)
 ;
"RTN","MAGDRPC5",173,0)
 S LIMIT=$$HTFM^XLFDT(LIMIT,1)
"RTN","MAGDRPC5",174,0)
 ;
"RTN","MAGDRPC5",175,0)
 S MAX=$G(MAX) S:MAX<1 MAX=100
"RTN","MAGDRPC5",176,0)
 F FMFILE=2005,2005.1 D  Q:OUT(1)'<MAX
"RTN","MAGDRPC5",177,0)
 . S STAMP="" F  S STAMP=$O(^MAG(FMFILE,"ROUTE",DEST,STAMP)) Q:STAMP=""  Q:STAMP'<LIMIT  D  Q:OUT(1)'<MAX
"RTN","MAGDRPC5",178,0)
 . . S D0="" F  S D0=$O(^MAG(FMFILE,"ROUTE",DEST,STAMP,D0)) Q:D0=""  D  Q:OUT(1)'<MAX
"RTN","MAGDRPC5",179,0)
 . . . S D1="" F  S D1=$O(^MAG(FMFILE,"ROUTE",DEST,STAMP,D0,D1)) Q:D1=""  D  Q:OUT(1)'<MAX
"RTN","MAGDRPC5",180,0)
 . . . . I MORE'="",FMFILE_"^"_D0_"^"_D1'=MORE Q
"RTN","MAGDRPC5",181,0)
 . . . . S MORE=""
"RTN","MAGDRPC5",182,0)
 . . . . S FILE=$P($G(^MAG(FMFILE,D0,4,D1,0)),"^",4),STATUS=0
"RTN","MAGDRPC5",183,0)
 . . . . S:FILE="" FILE=$P($G(^MAG(2005.1,D0,4,D1,0)),"^",4)
"RTN","MAGDRPC5",184,0)
 . . . . I FILE="" D  Q
"RTN","MAGDRPC5",185,0)
 . . . . . K ^MAG(FMFILE,"ROUTE",DEST,STAMP,D0,D1)
"RTN","MAGDRPC5",186,0)
 . . . . . K ^MAG(FMFILE,D0,4,"LOC",DEST,D1)
"RTN","MAGDRPC5",187,0)
 . . . . . K ^MAG(FMFILE,D0,4,D1,0)
"RTN","MAGDRPC5",188,0)
 . . . . . Q
"RTN","MAGDRPC5",189,0)
 . . . . S OUT(1)=OUT(1)+1,OUT(OUT(1))=FMFILE_"^"_D0_"^"_D1_"^"_STAMP_"^"_FILE
"RTN","MAGDRPC5",190,0)
 . . . . Q
"RTN","MAGDRPC5",191,0)
 . . . Q
"RTN","MAGDRPC5",192,0)
 . . Q
"RTN","MAGDRPC5",193,0)
 . Q
"RTN","MAGDRPC5",194,0)
 Q
"RTN","MAGDRPC5",195,0)
 ;
"RTN","MAGDRPC5",196,0)
STATUS(OUT,D0,STATUS,LOCATION) ; RPC = MAG DICOM ROUTE STATUS
"RTN","MAGDRPC5",197,0)
 ; D0 ------- Internal Entry Number of Send Queue Entry
"RTN","MAGDRPC5",198,0)
 ; STATUS --- New Status
"RTN","MAGDRPC5",199,0)
 N DEST ;---- Internal Entry Number of destination
"RTN","MAGDRPC5",200,0)
 N IMAGE ;--- Internal Entry Number of image
"RTN","MAGDRPC5",201,0)
 N OLD ;----- Old Status Value
"RTN","MAGDRPC5",202,0)
 N ORIGIN ;-- Origin of image
"RTN","MAGDRPC5",203,0)
 N PRIOR ;--- Priority
"RTN","MAGDRPC5",204,0)
 N TYPE ;---- File Type (Big, Text, DICOM, etc)
"RTN","MAGDRPC5",205,0)
 N X0,X1 ;--- Queue data
"RTN","MAGDRPC5",206,0)
 ;
"RTN","MAGDRPC5",207,0)
 I '$G(D0) S OUT="-1,Invalid queue identifier: """_$G(D0)_"""." Q
"RTN","MAGDRPC5",208,0)
 ;
"RTN","MAGDRPC5",209,0)
 S X0=$G(^MAGQUEUE(2006.035,D0,0))
"RTN","MAGDRPC5",210,0)
 S X1=$G(^MAGQUEUE(2006.035,D0,1))
"RTN","MAGDRPC5",211,0)
 S OUT=0
"RTN","MAGDRPC5",212,0)
 ;
"RTN","MAGDRPC5",213,0)
 S DEST=$P(X0,"^",2) Q:DEST=""
"RTN","MAGDRPC5",214,0)
 S PRIOR=$P(X1,"^",2) Q:PRIOR=""
"RTN","MAGDRPC5",215,0)
 S ORIGIN=$P(X0,"^",5)
"RTN","MAGDRPC5",216,0)
 S:'ORIGIN ORIGIN=$G(LOCATION) Q:'ORIGIN
"RTN","MAGDRPC5",217,0)
 S OLD=$P(X1,"^",1),IMAGE=$P(X0,"^",1),TYPE=$P(X0,"^",3)
"RTN","MAGDRPC5",218,0)
 ;
"RTN","MAGDRPC5",219,0)
 K:OLD'="" ^MAGQUEUE(2006.035,"DEST",DEST,OLD,IMAGE,TYPE,D0)
"RTN","MAGDRPC5",220,0)
 K:OLD'="" ^MAGQUEUE(2006.035,"STS",ORIGIN,OLD,PRIOR,DEST,D0)
"RTN","MAGDRPC5",221,0)
 Q:STATUS=""
"RTN","MAGDRPC5",222,0)
 S $P(^MAGQUEUE(2006.035,D0,0),"^",5)=ORIGIN
"RTN","MAGDRPC5",223,0)
 S $P(^MAGQUEUE(2006.035,D0,1),"^",1)=STATUS
"RTN","MAGDRPC5",224,0)
 S ^MAGQUEUE(2006.035,"DEST",DEST,STATUS,IMAGE,TYPE,D0)=""
"RTN","MAGDRPC5",225,0)
 S ^MAGQUEUE(2006.035,"STS",ORIGIN,STATUS,PRIOR,DEST,D0)=""
"RTN","MAGDRPC5",226,0)
 S OUT=1
"RTN","MAGDRPC5",227,0)
 Q
"RTN","MAGDRPC5",228,0)
 ;
"RTN","MAGDRPC5",229,0)
LISTDEST(OUT,LOCATION) ; RPC = MAG DICOM ROUTE LIST DESTI
"RTN","MAGDRPC5",230,0)
 N D0,F,I,X,ROU,OPER
"RTN","MAGDRPC5",231,0)
 ; Return list of possible routing destinations
"RTN","MAGDRPC5",232,0)
 K OUT
"RTN","MAGDRPC5",233,0)
 S I=1,D0=0 F  S D0=$O(^MAG(2005.2,D0)) Q:'D0  D
"RTN","MAGDRPC5",234,0)
 . S X=$G(^MAG(2005.2,D0,0)) Q:'$P(X,"^",9)
"RTN","MAGDRPC5",235,0)
 . S X=$G(^MAG(2005.2,D0,0)),ROU=$P(X,U,9),OPER=$P(X,U,6)
"RTN","MAGDRPC5",236,0)
 . ; P190 DAC - include router entries; filter if inactive
"RTN","MAGDRPC5",237,0)
 . Q:'ROU!(OPER'=1)
"RTN","MAGDRPC5",238,0)
 . L +^MAGQUEUE("ROUTE",LOCATION,D0):0 S F='$T
"RTN","MAGDRPC5",239,0)
 . L:'F -^MAGQUEUE("ROUTE",LOCATION,D0)
"RTN","MAGDRPC5",240,0)
 . S I=I+1,OUT(I)=D0_"^"_F_"^"_$P(X,"^",1,2)
"RTN","MAGDRPC5",241,0)
 . Q
"RTN","MAGDRPC5",242,0)
 S OUT(1)=I-1
"RTN","MAGDRPC5",243,0)
 Q
"RTN","MAGDRPC5",244,0)
LOCK(OUT,D0,LOCATION,PLUSMIN) ; RPC = MAG DICOM ROUTE LOCK TRANSMIT
"RTN","MAGDRPC5",245,0)
 S OUT=0
"RTN","MAGDRPC5",246,0)
 I $G(PLUSMIN) L +^MAGQUEUE("ROUTE",LOCATION,D0):0 S OUT=$T Q
"RTN","MAGDRPC5",247,0)
 L -^MAGQUEUE("ROUTE",LOCATION,D0) S OUT=2
"RTN","MAGDRPC5",248,0)
 Q
"RTN","MAGDRPC5",249,0)
 ;
"RTN","MAGDRPC5",250,0)
ONOFLINE(OUT,DEST,STATUS) ; RPC = MAG DICOM NETWORK STATUS
"RTN","MAGDRPC5",251,0)
 N NET
"RTN","MAGDRPC5",252,0)
 I '$G(DEST) S OUT="-1,No Network Location Specified" Q
"RTN","MAGDRPC5",253,0)
 S STATUS=''$G(STATUS)
"RTN","MAGDRPC5",254,0)
 S NET=$P($G(^MAG(2005.2,DEST,0)),"^",2)
"RTN","MAGDRPC5",255,0)
 K ^MAG(2005.2,"C",NET,0,DEST)
"RTN","MAGDRPC5",256,0)
 K ^MAG(2005.2,"C",NET,1,DEST)
"RTN","MAGDRPC5",257,0)
 S ^MAG(2005.2,"C",NET,STATUS,DEST)=""
"RTN","MAGDRPC5",258,0)
 S $P(^MAG(2005.2,DEST,0),"^",6)=STATUS
"RTN","MAGDRPC5",259,0)
 S $P(^MAG(2005.2,DEST,3),"^",6)=$S(STATUS:"",1:$$NOW^XLFDT())
"RTN","MAGDRPC5",260,0)
 S OUT=1
"RTN","MAGDRPC5",261,0)
 Q
"RTN","MAGDRPC5",262,0)
 ;
"RTN","MAGDRPC5",263,0)
XTINIT N NODE
"RTN","MAGDRPC5",264,0)
 D DT^DICRW
"RTN","MAGDRPC5",265,0)
 F NODE="MAGEVAL","MAGEVALSTUDY" D
"RTN","MAGDRPC5",266,0)
 . S X=$G(^XTMP(NODE,0))
"RTN","MAGDRPC5",267,0)
 . S $P(X,"^",2)=DT
"RTN","MAGDRPC5",268,0)
 . S $P(X,"^",3)="Routing Rule Evaluator Log - Can be purged at any time"
"RTN","MAGDRPC5",269,0)
 . S ^XTMP(NODE,0)=X
"RTN","MAGDRPC5",270,0)
 . Q
"RTN","MAGDRPC5",271,0)
 Q
"RTN","MAGDRPC5",272,0)
 ;
"RTN","MAGDRPC9")
0^2^B97395044
"RTN","MAGDRPC9",1,0)
MAGDRPC9 ;WOIFO/EdM/MLH/JSL/SAF/DAC/PMK - Imaging RPCs ; 06 Nov 2017 4:38 PM
"RTN","MAGDRPC9",2,0)
 ;;3.0;IMAGING;**50,54,53,49,123,118,138,180,190**;Mar 19, 2002;Build 2
"RTN","MAGDRPC9",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDRPC9",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC9",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC9",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC9",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC9",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC9",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC9",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC9",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC9",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC9",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC9",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC9",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC9",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC9",17,0)
 ;;
"RTN","MAGDRPC9",18,0)
 Q
"RTN","MAGDRPC9",19,0)
 ;
"RTN","MAGDRPC9",20,0)
UIDROOT(OUT) ; RPC = MAG DICOM GET UID ROOT
"RTN","MAGDRPC9",21,0)
 S OUT=$G(^MAGD(2006.15,1,"UID ROOT"))
"RTN","MAGDRPC9",22,0)
 Q
"RTN","MAGDRPC9",23,0)
 ;
"RTN","MAGDRPC9",24,0)
NEWUID(OUT,OLD,NEW,IMAGE,DBTYPE) ; RPC = MAG NEW SOP INSTANCE UID
"RTN","MAGDRPC9",25,0)
 N D0,L,X,SOPREC,ORIGSOP
"RTN","MAGDRPC9",26,0)
 S DBTYPE=$G(DBTYPE,"OLD")
"RTN","MAGDRPC9",27,0)
 S IMAGE=+$G(IMAGE),OLD=$G(OLD)
"RTN","MAGDRPC9",28,0)
 S:$G(NEW)="" NEW=OLD
"RTN","MAGDRPC9",29,0)
 D:DBTYPE="OLD"
"RTN","MAGDRPC9",30,0)
 . S D0=IMAGE
"RTN","MAGDRPC9",31,0)
 . I 'D0 S OUT="-2,Cannot find image with UID "_OLD Q
"RTN","MAGDRPC9",32,0)
 . S OUT=$P($G(^MAG(2005,D0,"SOP")),"^",2) Q:OUT'=""
"RTN","MAGDRPC9",33,0)
 . S L=$L(NEW,".")-1,X=$P(NEW,".",L+1),L=$P(NEW,".",1,L)_"."
"RTN","MAGDRPC9",34,0)
 . L +^MAG(2005,"P"):1E9 ; Background process MUST wait
"RTN","MAGDRPC9",35,0)
 . S OUT="" F  D  Q:OUT'=""
"RTN","MAGDRPC9",36,0)
 . . S OUT=L_X
"RTN","MAGDRPC9",37,0)
 . . I $L(OUT)>64 S OUT="-3,Cannot use "_NEW_" to create valid UID" Q
"RTN","MAGDRPC9",38,0)
 . . I $D(^MAG(2005,"P",OUT)) S OUT="",X=X+1 Q
"RTN","MAGDRPC9",39,0)
 . . S $P(^MAG(2005,D0,"SOP"),"^",2)=OUT
"RTN","MAGDRPC9",40,0)
 . . S ^MAG(2005,"P",OUT,D0)=1
"RTN","MAGDRPC9",41,0)
 . . Q
"RTN","MAGDRPC9",42,0)
 . L -^MAG(2005,"P")
"RTN","MAGDRPC9",43,0)
 . Q
"RTN","MAGDRPC9",44,0)
 D:DBTYPE="NEW"
"RTN","MAGDRPC9",45,0)
 . S D0=0 S:OLD'="" D0=$O(^MAGV(2005.64,"B",OLD,""))
"RTN","MAGDRPC9",46,0)
 . I IMAGE,D0,IMAGE'=D0 S OUT="-1,UID cannot belong to multiple images ("_IMAGE_"/"_D0_")" Q
"RTN","MAGDRPC9",47,0)
 . I IMAGE,'D0 S D0=IMAGE
"RTN","MAGDRPC9",48,0)
 . S SOPREC=$G(^MAGV(2005.64,D0,0))
"RTN","MAGDRPC9",49,0)
 . I SOPREC="" S OUT="-2,IMAGE SOP INSTANCE record not found ("_D0_")" Q
"RTN","MAGDRPC9",50,0)
 . S ORIGSOP=$P(SOPREC,"^",2)
"RTN","MAGDRPC9",51,0)
 . I ORIGSOP'="" D  Q
"RTN","MAGDRPC9",52,0)
 . . I OLD=ORIGSOP S OUT=$P(SOPREC,"^",1) Q
"RTN","MAGDRPC9",53,0)
 . . S OUT="-3,ORIGINAL SOP INSTANCE UID for image ("_ORIGSOP
"RTN","MAGDRPC9",54,0)
 . . S OUT=OUT_") does not match value sent ("_OLD
"RTN","MAGDRPC9",55,0)
 . . Q
"RTN","MAGDRPC9",56,0)
 . ; need to verify and store the new SOP
"RTN","MAGDRPC9",57,0)
 . S L=$L(NEW,".")-1,X=$P(NEW,".",L+1),L=$P(NEW,".",1,L)_"."
"RTN","MAGDRPC9",58,0)
 . L +^MAGV(2005.64,"B"):1E9 ; Background process MUST wait
"RTN","MAGDRPC9",59,0)
 . S OUT="" F  D  Q:OUT'=""
"RTN","MAGDRPC9",60,0)
 . . S OUT=L_X
"RTN","MAGDRPC9",61,0)
 . . I $L(OUT)>64 S OUT="-3,Cannot use "_NEW_" to create valid UID" Q
"RTN","MAGDRPC9",62,0)
 . . I $D(^MAGV(2005.64,"B",OUT)) S OUT="",X=X+1 Q
"RTN","MAGDRPC9",63,0)
 . . S $P(SOPREC,"^",2)=$P(SOPREC,"^",1) K ^MAGV(2005.64,"B",$P(SOPREC,"^",1),D0)
"RTN","MAGDRPC9",64,0)
 . . S $P(SOPREC,"^",1)=OUT,^MAGV(2005.64,"B",OUT,D0)=""
"RTN","MAGDRPC9",65,0)
 . . S ^MAGV(2005.64,D0,0)=SOPREC
"RTN","MAGDRPC9",66,0)
 . . Q
"RTN","MAGDRPC9",67,0)
 . L -^MAGV(2005.64,"B")
"RTN","MAGDRPC9",68,0)
 . Q
"RTN","MAGDRPC9",69,0)
 Q
"RTN","MAGDRPC9",70,0)
 ;
"RTN","MAGDRPC9",71,0)
QRNEWUID(IMAGE,DBTYPE) ; Get updated UID for Query/Retrieve
"RTN","MAGDRPC9",72,0)
 N DATE,DH,FAIL,I,OLD,OUT,NEW,LASTUID,NEXTUID,TIME,X,Y
"RTN","MAGDRPC9",73,0)
 S DBTYPE=$G(DBTYPE,"OLD")
"RTN","MAGDRPC9",74,0)
 S IMAGE=+$G(IMAGE)
"RTN","MAGDRPC9",75,0)
 D:DBTYPE="OLD"  ; find new UID, if any, in legacy DB
"RTN","MAGDRPC9",76,0)
 . S NEW=$P($G(^MAG(2005,IMAGE,"SOP")),"^",2)
"RTN","MAGDRPC9",77,0)
 . Q
"RTN","MAGDRPC9",78,0)
 D:DBTYPE="NEW"  ; find new UID, if any, in P34 DB
"RTN","MAGDRPC9",79,0)
 . S NEW="" S:$P($G(^MAGV(2005.64,IMAGE,0)),"^",2)'="" NEW=$P(^(0),"^",1)
"RTN","MAGDRPC9",80,0)
 . Q
"RTN","MAGDRPC9",81,0)
 Q:NEW'="" NEW
"RTN","MAGDRPC9",82,0)
 ; Generate the next UID using date/time and counter
"RTN","MAGDRPC9",83,0)
 L +^MAGDICOM(2006.563,1,"MACHINE ID"):1E9 ; Background process must wait
"RTN","MAGDRPC9",84,0)
 S LASTUID=$G(^MAGDICOM(2006.563,1,"LAST UID"))
"RTN","MAGDRPC9",85,0)
 ; Can't use D NOW^XLFDT to set DH because it is incorrect at midnight
"RTN","MAGDRPC9",86,0)
 S DH=$H,X=$$HTFM^XLFDT(DH,1),DATE=X+17000000
"RTN","MAGDRPC9",87,0)
 S X=$P(DH,",",2) D
"RTN","MAGDRPC9",88,0)
 . N H,M,S
"RTN","MAGDRPC9",89,0)
 . S H=X\3600,M=X\60#60,S=X#60
"RTN","MAGDRPC9",90,0)
 . S TIME=H*100+M*100+S
"RTN","MAGDRPC9",91,0)
 . Q
"RTN","MAGDRPC9",92,0)
 S NEXTUID=$G(^MAGD(2006.15,1,"UID ROOT"))
"RTN","MAGDRPC9",93,0)
 I NEXTUID="" S $EC=",13:No UID Root defined - Run INIT^MAGDRUID," ; Fatal Error
"RTN","MAGDRPC9",94,0)
 ; UID type = 7, Machine ID = 0
"RTN","MAGDRPC9",95,0)
 S NEXTUID=NEXTUID_".1.7."_(+$G(DUZ(2)))_".0."_DATE_"."_TIME_".0"
"RTN","MAGDRPC9",96,0)
 ; Remove leading 0s from UID components
"RTN","MAGDRPC9",97,0)
 F I=1:1:$L(NEXTUID,".") S $P(NEXTUID,".",I)=+$P(NEXTUID,".",I)
"RTN","MAGDRPC9",98,0)
 I $P(NEXTUID,".",1,10)=$P(LASTUID,".",1,10) D
"RTN","MAGDRPC9",99,0)
 . S NEXTUID=LASTUID
"RTN","MAGDRPC9",100,0)
 . S $P(NEXTUID,".",11)=$P(NEXTUID,".",11)+1
"RTN","MAGDRPC9",101,0)
 . Q
"RTN","MAGDRPC9",102,0)
 S ^MAGDICOM(2006.563,1,"LAST UID")=NEXTUID
"RTN","MAGDRPC9",103,0)
 L -^MAGDICOM(2006.563,1,"MACHINE ID")
"RTN","MAGDRPC9",104,0)
 S OLD=$S(DBTYPE="OLD":$P($G(^MAG(2005,IMAGE,"PACS")),"^",1),1:$P($G(^MAGV(2005.64,IMAGE,0)),"^",1))
"RTN","MAGDRPC9",105,0)
 D NEWUID(.OUT,OLD,NEXTUID,IMAGE,DBTYPE) ; Store the new UID with the image
"RTN","MAGDRPC9",106,0)
 Q OUT
"RTN","MAGDRPC9",107,0)
 ;
"RTN","MAGDRPC9",108,0)
NEXT(OUT,SEED,DIR) ; RPC = MAG RAD GET NEXT RPT BY DATE
"RTN","MAGDRPC9",109,0)
 N D2,DFN,EXAMDATE,NAME
"RTN","MAGDRPC9",110,0)
 ;
"RTN","MAGDRPC9",111,0)
 ; ^RADPT(DFN,"DT",D1,"P",D2,0) = Data, $P(17) = pointer to report
"RTN","MAGDRPC9",112,0)
 ; ^RADPT("AR",9999999.9999-D1,DFN,D1)="" ; IA # 65
"RTN","MAGDRPC9",113,0)
 ;
"RTN","MAGDRPC9",114,0)
 ; OUT = report_pointer ^ ExamDate ^ Patient ^ D2
"RTN","MAGDRPC9",115,0)
 ;
"RTN","MAGDRPC9",116,0)
 S SEED=$G(SEED),DIR=$S($G(DIR)<0:-1,1:1) ; default is ascending order
"RTN","MAGDRPC9",117,0)
 S EXAMDATE=$P(SEED,"^",1),DFN=$P(SEED,"^",2),D2=$P(SEED,"^",3)
"RTN","MAGDRPC9",118,0)
 S OUT=0 F  D  Q:OUT
"RTN","MAGDRPC9",119,0)
 . I EXAMDATE="" S EXAMDATE=$O(^RADPT("AR",""),DIR),DFN="" ; IA # 65
"RTN","MAGDRPC9",120,0)
 . I EXAMDATE="" S OUT=-1 Q
"RTN","MAGDRPC9",121,0)
 . I DFN="" S DFN=$O(^RADPT("AR",EXAMDATE,""),DIR) ; IA # 65
"RTN","MAGDRPC9",122,0)
 . I DFN="" S EXAMDATE=$O(^RADPT("AR",EXAMDATE),DIR),D2="" Q  ; IA # 65
"RTN","MAGDRPC9",123,0)
 . S:'D2 D2=$S(DIR>0:0,1:" ")
"RTN","MAGDRPC9",124,0)
 . S D2=$O(^RADPT(DFN,"DT",9999999.9999-EXAMDATE,"P",D2),DIR) ; IA # 1172
"RTN","MAGDRPC9",125,0)
 . I 'D2 D  Q
"RTN","MAGDRPC9",126,0)
 . . S DFN=$O(^RADPT("AR",EXAMDATE,DFN),DIR),D2="" ; IA # 65
"RTN","MAGDRPC9",127,0)
 . . I 'DFN D
"RTN","MAGDRPC9",128,0)
 . . . S EXAMDATE=$O(^RADPT("AR",EXAMDATE),DIR),DFN="" ; IA # 65
"RTN","MAGDRPC9",129,0)
 . . . I EXAMDATE="" S OUT=-1
"RTN","MAGDRPC9",130,0)
 . . . Q
"RTN","MAGDRPC9",131,0)
 . . Q
"RTN","MAGDRPC9",132,0)
 . S OUT=$P($G(^RADPT(DFN,"DT",9999999.9999-EXAMDATE,"P",D2,0)),"^",17) ; IA # 1172
"RTN","MAGDRPC9",133,0)
 . S:OUT OUT=OUT_"^"_EXAMDATE_"^"_DFN_"^"_D2
"RTN","MAGDRPC9",134,0)
 . Q
"RTN","MAGDRPC9",135,0)
 Q
"RTN","MAGDRPC9",136,0)
 ;
"RTN","MAGDRPC9",137,0)
NXTPTRPT(OUT,DFN,RARPT1,DIR) ; RPC = MAG RAD GET NEXT RPT BY PT
"RTN","MAGDRPC9",138,0)
 S DFN=$G(DFN)
"RTN","MAGDRPC9",139,0)
 I 'DFN S OUT="-1,Patient DFN not passed" Q
"RTN","MAGDRPC9",140,0)
 I '$D(^RARPT("C",DFN)) S OUT="-2,Patient does not have any radiology reports" Q  ; IA # 2442
"RTN","MAGDRPC9",141,0)
 S RARPT1=$G(RARPT1),DIR=$S($G(DIR)<0:-1,1:1) ; default is ascending order
"RTN","MAGDRPC9",142,0)
 S OUT=$O(^RARPT("C",DFN,RARPT1),DIR) ; IA # 2442
"RTN","MAGDRPC9",143,0)
 Q
"RTN","MAGDRPC9",144,0)
 ;
"RTN","MAGDRPC9",145,0)
GETICN(OUT,DFN) ; RPC = MAG DICOM GET ICN
"RTN","MAGDRPC9",146,0)
 S OUT=$S($T(GETICN^MPIF001)'="":$$GETICN^MPIF001(DFN),1:"-1^NO MPI")
"RTN","MAGDRPC9",147,0)
 Q
"RTN","MAGDRPC9",148,0)
 ;
"RTN","MAGDRPC9",149,0)
CLEAN ; Overflow from MAGDRPC4
"RTN","MAGDRPC9",150,0)
 ; P180 DAC - Moved global locking to calling routine MAGDRPC4
"RTN","MAGDRPC9",151,0)
 N REQUESTDATETIME,STUID,PRI,S0,S1,STS,NEWSTS
"RTN","MAGDRPC9",152,0)
 S S0=$P(SENT(I),"^",1),S1=$P(SENT(I),"^",2),NEWSTS=$P(SENT(I),"^",3)
"RTN","MAGDRPC9",153,0)
 Q:'$D(^MAGDOUTP(2006.574,S0,1,S1))
"RTN","MAGDRPC9",154,0)
 ;
"RTN","MAGDRPC9",155,0)
 S X=$G(^MAGDOUTP(2006.574,S0,0)),LOC=$P(X,"^",4),PRI=+$P(X,"^",5)
"RTN","MAGDRPC9",156,0)
 S REQUESTDATETIME=$P(X,"^",7)
"RTN","MAGDRPC9",157,0)
 S STS=$P($G(^MAGDOUTP(2006.574,S0,1,S1,0)),"^",2)
"RTN","MAGDRPC9",158,0)
 ;
"RTN","MAGDRPC9",159,0)
 I NEWSTS'="" D  Q  ; just update the status and get out
"RTN","MAGDRPC9",160,0)
 . S $P(^MAGDOUTP(2006.574,S0,1,S1,0),"^",2)=NEWSTS,$P(^(0),"^",3)=$H
"RTN","MAGDRPC9",161,0)
 . I LOC'="",PRI'="" S ^MAGDOUTP(2006.574,"STS",LOC,PRI,NEWSTS,S0,S1)=""
"RTN","MAGDRPC9",162,0)
 . I LOC'="",PRI'="",STS'="" K ^MAGDOUTP(2006.574,"STS",LOC,PRI,STS,S0,S1)
"RTN","MAGDRPC9",163,0)
 . Q
"RTN","MAGDRPC9",164,0)
 ;
"RTN","MAGDRPC9",165,0)
 K ^MAGDOUTP(2006.574,S0,1,S1)
"RTN","MAGDRPC9",166,0)
 I LOC'="",PRI'="",STS'="" K ^MAGDOUTP(2006.574,"STS",LOC,PRI,STS,S0,S1)
"RTN","MAGDRPC9",167,0)
 S X=$G(^MAGDOUTP(2006.574,S0,1,0))
"RTN","MAGDRPC9",168,0)
 S $P(X,"^",4)=$P(X,"^",4)-1
"RTN","MAGDRPC9",169,0)
 S ^MAGDOUTP(2006.574,S0,1,0)=X
"RTN","MAGDRPC9",170,0)
 ;
"RTN","MAGDRPC9",171,0)
 Q:$O(^MAGDOUTP(2006.574,S0,1,0))  ; don't delete the study node yet
"RTN","MAGDRPC9",172,0)
 ;
"RTN","MAGDRPC9",173,0)
 S STUID=$G(^MAGDOUTP(2006.574,S0,2))
"RTN","MAGDRPC9",174,0)
 K ^MAGDOUTP(2006.574,S0)
"RTN","MAGDRPC9",175,0)
 K:REQUESTDATETIME'="" ^MAGDOUTP(2006.574,"C",REQUESTDATETIME,S0)
"RTN","MAGDRPC9",176,0)
 K:STUID'="" ^MAGDOUTP(2006.574,"STUDY",STUID)
"RTN","MAGDRPC9",177,0)
 S X=$G(^MAGDOUTP(2006.574,0))
"RTN","MAGDRPC9",178,0)
 S $P(X,"^",4)=$P(X,"^",4)-1
"RTN","MAGDRPC9",179,0)
 S ^MAGDOUTP(2006.574,0)=X
"RTN","MAGDRPC9",180,0)
 Q
"RTN","MAGDRPC9",181,0)
 ;
"RTN","MAGDRPC9",182,0)
IENLOOK ; Overflow from MAGDRPC4
"RTN","MAGDRPC9",183,0)
 ; lookup image by the IEN
"RTN","MAGDRPC9",184,0)
 N ACNUMB,D0,DFN,GROUPIEN,MODIFIER,P,PROCNAME,STUDYDAT,X,Y
"RTN","MAGDRPC9",185,0)
 S NUMBER=+$P(NUMBER,"`",2)
"RTN","MAGDRPC9",186,0)
 ; patient safety checks
"RTN","MAGDRPC9",187,0)
 D CHK^MAGGSQI(.X,NUMBER) I +$G(X(0))'=1 D  Q
"RTN","MAGDRPC9",188,0)
 . S OUT(1)="-9,"_$P(X(0),"^",2,999)
"RTN","MAGDRPC9",189,0)
 . Q
"RTN","MAGDRPC9",190,0)
 S GROUPIEN=$P($G(^MAG(2005,NUMBER,0)),"^",10)
"RTN","MAGDRPC9",191,0)
 I GROUPIEN D CHK^MAGGSQI(.X,GROUPIEN) I +$G(X(0))'=1 D  Q
"RTN","MAGDRPC9",192,0)
 . S OUT(1)="-10,Group #"_GROUPIEN_": "_$P(X(0),"^",2,999)
"RTN","MAGDRPC9",193,0)
 . Q
"RTN","MAGDRPC9",194,0)
 ;
"RTN","MAGDRPC9",195,0)
 S X=$G(^MAG(2005,NUMBER,2)),P=$P(X,"^",6),D0=$P(X,"^",7)
"RTN","MAGDRPC9",196,0)
 I 'P!'D0 D  ; get parent from group
"RTN","MAGDRPC9",197,0)
 . S:GROUPIEN X=$G(^MAG(2005,GROUPIEN,2)),P=$P(X,"^",6),D0=$P(X,"^",7)
"RTN","MAGDRPC9",198,0)
 . Q
"RTN","MAGDRPC9",199,0)
 ;
"RTN","MAGDRPC9",200,0)
 S OUT(2)=P_"^"_D0_"^"_NUMBER_"^" ; result w/o Accession Number
"RTN","MAGDRPC9",201,0)
 I 'P!'D0 S OUT(1)="-6,Warning - Parent file entry is not present - no Accession Number."
"RTN","MAGDRPC9",202,0)
 E  I P=74 D
"RTN","MAGDRPC9",203,0)
 . N DATETIME,I,INFO,PROC,RADPT0,RADPT1,RADPT2,RADPT3,RARPT0
"RTN","MAGDRPC9",204,0)
 . S X=$$ACCRPT^RAAPI(D0,.INFO)
"RTN","MAGDRPC9",205,0)
 . I X<0 S OUT(1)="-11,Radiology Problem: "_X Q
"RTN","MAGDRPC9",206,0)
 . S ACNUMB=INFO(1)
"RTN","MAGDRPC9",207,0)
 . S RARPT0=$G(^RARPT(D0,0)) ; IA # 1171
"RTN","MAGDRPC9",208,0)
 . S RADPT1=$P(RARPT0,"^",2),DATETIME=$P(RARPT0,"^",3)
"RTN","MAGDRPC9",209,0)
 . S RADPT2=9999999.9999-DATETIME,RADPT3=1
"RTN","MAGDRPC9",210,0)
 . S RADPT0=$G(^RADPT(RADPT1,"DT",RADPT2,"P",RADPT3,0))
"RTN","MAGDRPC9",211,0)
 . S PROCNAME=$$GET1^DIQ(71,$P(RADPT0,"^",2),.01)
"RTN","MAGDRPC9",212,0)
 . S STUDYDAT=17000000+(DATETIME\1)
"RTN","MAGDRPC9",213,0)
 . S MODIFIER=""
"RTN","MAGDRPC9",214,0)
 . S I=0 F  S I=$O(^RADPT(RADPT1,"DT",RADPT2,"P",RADPT3,"M",I)) Q:'I  D
"RTN","MAGDRPC9",215,0)
 . . S X=^RADPT(RADPT1,"DT",RADPT2,"P",RADPT3,"M",I,0)
"RTN","MAGDRPC9",216,0)
 . . S:I>1 MODIFIER=MODIFIER_", " S MODIFIER=MODIFIER_$$GET1^DIQ(71.2,X,.01)
"RTN","MAGDRPC9",217,0)
 . . Q
"RTN","MAGDRPC9",218,0)
 . S X=P_"^"_D0_"^"_NUMBER_"^"_ACNUMB_"^"_STUDYDAT_"^"_PROCNAME_"^"_MODIFIER
"RTN","MAGDRPC9",219,0)
 . S OUT(1)=1,OUT(2)=X
"RTN","MAGDRPC9",220,0)
 . Q
"RTN","MAGDRPC9",221,0)
 E  I P=8925 D
"RTN","MAGDRPC9",222,0)
 . N GMRCIEN,LABINFO
"RTN","MAGDRPC9",223,0)
 . ; get pointer from TIU to consult request
"RTN","MAGDRPC9",224,0)
 . S X=$$GET1^DIQ(8925,D0,1405,"I") ; IA ???
"RTN","MAGDRPC9",225,0)
 . I $P(X,";",2)="GMR(123," D
"RTN","MAGDRPC9",226,0)
 . . S GMRCIEN=$P(X,";"),ACNUMB=$$GMRCACN^MAGDFCNV(GMRCIEN)
"RTN","MAGDRPC9",227,0)
 . . S STUDYDAT=17000000+($$GET1^DIQ(123,GMRCIEN,.01,"I")\1)
"RTN","MAGDRPC9",228,0)
 . . S PROCNAME=$$GET1^DIQ(123,GMRCIEN,1) ; TO SERVICE
"RTN","MAGDRPC9",229,0)
 . . S MODIFIER=$$GET1^DIQ(123,GMRCIEN,4) ; PROCEDURE
"RTN","MAGDRPC9",230,0)
 . . S X=P_"^"_D0_"^"_NUMBER_"^"_ACNUMB_"^"_STUDYDAT_"^"_PROCNAME_"^"_MODIFIER
"RTN","MAGDRPC9",231,0)
 . . S OUT(1)=1,OUT(2)=X
"RTN","MAGDRPC9",232,0)
 . . Q
"RTN","MAGDRPC9",233,0)
 . S X=$$GET1^DIQ(8925,D0,.04,"E")
"RTN","MAGDRPC9",234,0)
 . I X="LR ANATOMIC PATHOLOGY" D
"RTN","MAGDRPC9",235,0)
 . . D GETINFO(.LABINFO,D0)
"RTN","MAGDRPC9",236,0)
 . . I $D(LABINFO) D
"RTN","MAGDRPC9",237,0)
 . . S X=P_"^"_D0_"^"_NUMBER_"^"_LABINFO("ACNUMB")
"RTN","MAGDRPC9",238,0)
 . . S X=X_"^"_LABINFO("DATE")
"RTN","MAGDRPC9",239,0)
 . . S X=X_"^"_LABINFO("LAB")_"^"
"RTN","MAGDRPC9",240,0)
 . . S OUT(1)=1,OUT(2)=X
"RTN","MAGDRPC9",241,0)
 . . Q
"RTN","MAGDRPC9",242,0)
 . ; P190 DAC - Next line modified to fix consult look ups that reported errors even though they were succesful
"RTN","MAGDRPC9",243,0)
 . I $G(OUT(1))'=1 S OUT(1)="-8,Problem with parent file "_P_", internal entry number "_D0_" - no Accession Number."
"RTN","MAGDRPC9",244,0)
 . Q
"RTN","MAGDRPC9",245,0)
 E  S OUT(1)="-7,Parent file "_P_" not yet supported - no Accession Number."
"RTN","MAGDRPC9",246,0)
 Q
"RTN","MAGDRPC9",247,0)
 ;
"RTN","MAGDRPC9",248,0)
GETINFO(INFO,TIUIEN) ; scan the TIU document and try to extract the accession number
"RTN","MAGDRPC9",249,0)
 N FILE ; ---- LAB DATA subfile numbers and other info
"RTN","MAGDRPC9",250,0)
 N ERRSTAT S ERRSTAT=0 ; error status - assume nothing to repor
"RTN","MAGDRPC9",251,0)
 N ERROR,I,LRSS,IENS,TEXT,X
"RTN","MAGDRPC9",252,0)
 S IENS=TIUIEN_","
"RTN","MAGDRPC9",253,0)
 D GETS^DIQ(8925,IENS,2,"I","TEXT","ERROR")
"RTN","MAGDRPC9",254,0)
 F I=1:1 Q:'$D(TEXT(8925,IENS,2,I))  S X=TEXT(8925,IENS,2,I) D
"RTN","MAGDRPC9",255,0)
 . I '$D(INFO("ACNUMB")),X["Accession No." D
"RTN","MAGDRPC9",256,0)
 . . S INFO("ACNUMB")=$P(X,"Accession No. ",2)
"RTN","MAGDRPC9",257,0)
 . . S LRSS=$E(INFO("ACNUMB"),1,2)
"RTN","MAGDRPC9",258,0)
 . . S ERRSTAT=$$GETFILE^MAGT7MA(LRSS) I ERRSTAT S INFO("LAB")="" Q
"RTN","MAGDRPC9",259,0)
 . . S INFO("LAB")=FILE("NAME")
"RTN","MAGDRPC9",260,0)
 . . Q
"RTN","MAGDRPC9",261,0)
 . I '$D(INFO("DATE")),X["Date obtained: " S INFO("DATE")=$P(X,"Date obtained: ",2)
"RTN","MAGDRPC9",262,0)
 . Q
"RTN","MAGDRPC9",263,0)
 Q 
"RTN","MAGIP190")
0^3^B4110402
"RTN","MAGIP190",1,0)
MAGIP190 ;WOIFO/DAC - Install code for MAG*3.0*190 ; 15 Nov 2017 10:05 AM
"RTN","MAGIP190",2,0)
 ;;3.0;IMAGING;**190**;Mar 19, 2002;Build 2
"RTN","MAGIP190",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIP190",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP190",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIP190",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIP190",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIP190",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIP190",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIP190",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIP190",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIP190",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIP190",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIP190",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIP190",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIP190",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP190",17,0)
 ;;
"RTN","MAGIP190",18,0)
 ; There are no environment checks here but the MAGIP190 has to be
"RTN","MAGIP190",19,0)
 ; referenced by the "Environment Check Routine" field of the KIDS
"RTN","MAGIP190",20,0)
 ; build so that entry points of the routine are available to the
"RTN","MAGIP190",21,0)
 ; KIDS during all installation phases.
"RTN","MAGIP190",22,0)
 Q
"RTN","MAGIP190",23,0)
 ;
"RTN","MAGIP190",24,0)
 ;+++++ INSTALLATION ERROR HANDLING
"RTN","MAGIP190",25,0)
ERROR ;
"RTN","MAGIP190",26,0)
 S:$D(XPDNM) XPDABORT=1
"RTN","MAGIP190",27,0)
 ;--- Display the messages and store them to the INSTALL file
"RTN","MAGIP190",28,0)
 D DUMP^MAGUERR1(),ABTMSG^MAGKIDS()
"RTN","MAGIP190",29,0)
 Q
"RTN","MAGIP190",30,0)
 ;
"RTN","MAGIP190",31,0)
 ;***** POST-INSTALL CODE
"RTN","MAGIP190",32,0)
POS ;
"RTN","MAGIP190",33,0)
 N CALLBACK
"RTN","MAGIP190",34,0)
 D CLEAR^MAGUERR(1)
"RTN","MAGIP190",35,0)
 ;
"RTN","MAGIP190",36,0)
 ;--- Send the notification e-mail
"RTN","MAGIP190",37,0)
 D BMES^XPDUTL("Post Install Mail Message: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","MAGIP190",38,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGIP190",39,0)
 Q
"RTN","MAGIP190",40,0)
 ;
"RTN","MAGIP190",41,0)
 ;***** PRE-INSTALL CODE
"RTN","MAGIP190",42,0)
PRE ;
"RTN","MAGIP190",43,0)
 Q
"VER")
8.0^22.2
**END**
**END**
