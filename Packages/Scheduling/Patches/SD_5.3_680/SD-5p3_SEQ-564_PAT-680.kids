Released SD*5.3*680 SEQ #564
Extracted from mail message
**KIDS**:SD*5.3*680^

**INSTALL NAME**
SD*5.3*680
"BLD",10517,0)
SD*5.3*680^SCHEDULING^0^3171214^y
"BLD",10517,1,0)
^^5^5^3171127^
"BLD",10517,1,1,0)
This patch (SD*5.3*680) addresses this one (1) issue:
"BLD",10517,1,2,0)
(1)  I16592426FY17 - Self Identified Gender
"BLD",10517,1,3,0)
   -       SDL--PREAPPOINTMENT LETTERS Print Template and VistA
"BLD",10517,1,4,0)
           routines SDEC40, SDECU, and SDLT are modified and
"BLD",10517,1,5,0)
           remove gender implication(s).
"BLD",10517,4,0)
^9.64PA^^
"BLD",10517,6)
1^
"BLD",10517,6.3)
2
"BLD",10517,"ABPKG")
n
"BLD",10517,"KRN",0)
^9.67PA^779.2^20
"BLD",10517,"KRN",.4,0)
.4
"BLD",10517,"KRN",.4,"NM",0)
^9.68A^1^1
"BLD",10517,"KRN",.4,"NM",1,0)
SDL--PREAPPOINTMENT LETTERS    FILE #2^2^0
"BLD",10517,"KRN",.4,"NM","B","SDL--PREAPPOINTMENT LETTERS    FILE #2",1)

"BLD",10517,"KRN",.401,0)
.401
"BLD",10517,"KRN",.402,0)
.402
"BLD",10517,"KRN",.403,0)
.403
"BLD",10517,"KRN",.5,0)
.5
"BLD",10517,"KRN",.84,0)
.84
"BLD",10517,"KRN",3.6,0)
3.6
"BLD",10517,"KRN",3.8,0)
3.8
"BLD",10517,"KRN",9.2,0)
9.2
"BLD",10517,"KRN",9.8,0)
9.8
"BLD",10517,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",10517,"KRN",9.8,"NM",1,0)
SDEC40^^0^B69194006
"BLD",10517,"KRN",9.8,"NM",2,0)
SDECU^^0^B23730358
"BLD",10517,"KRN",9.8,"NM",3,0)
SDLT^^0^B29114101
"BLD",10517,"KRN",9.8,"NM","B","SDEC40",1)

"BLD",10517,"KRN",9.8,"NM","B","SDECU",2)

"BLD",10517,"KRN",9.8,"NM","B","SDLT",3)

"BLD",10517,"KRN",19,0)
19
"BLD",10517,"KRN",19.1,0)
19.1
"BLD",10517,"KRN",101,0)
101
"BLD",10517,"KRN",409.61,0)
409.61
"BLD",10517,"KRN",771,0)
771
"BLD",10517,"KRN",779.2,0)
779.2
"BLD",10517,"KRN",870,0)
870
"BLD",10517,"KRN",8989.51,0)
8989.51
"BLD",10517,"KRN",8989.52,0)
8989.52
"BLD",10517,"KRN",8994,0)
8994
"BLD",10517,"KRN","B",.4,.4)

"BLD",10517,"KRN","B",.401,.401)

"BLD",10517,"KRN","B",.402,.402)

"BLD",10517,"KRN","B",.403,.403)

"BLD",10517,"KRN","B",.5,.5)

"BLD",10517,"KRN","B",.84,.84)

"BLD",10517,"KRN","B",3.6,3.6)

"BLD",10517,"KRN","B",3.8,3.8)

"BLD",10517,"KRN","B",9.2,9.2)

"BLD",10517,"KRN","B",9.8,9.8)

"BLD",10517,"KRN","B",19,19)

"BLD",10517,"KRN","B",19.1,19.1)

"BLD",10517,"KRN","B",101,101)

"BLD",10517,"KRN","B",409.61,409.61)

"BLD",10517,"KRN","B",771,771)

"BLD",10517,"KRN","B",779.2,779.2)

"BLD",10517,"KRN","B",870,870)

"BLD",10517,"KRN","B",8989.51,8989.51)

"BLD",10517,"KRN","B",8989.52,8989.52)

"BLD",10517,"KRN","B",8994,8994)

"BLD",10517,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",10517,"QUES",0)
^9.62^^
"BLD",10517,"REQB",0)
^9.611^2^2
"BLD",10517,"REQB",1,0)
SD*5.3*641^2
"BLD",10517,"REQB",2,0)
SD*5.3*665^2
"BLD",10517,"REQB","B","SD*5.3*641",1)

"BLD",10517,"REQB","B","SD*5.3*665",2)

"KRN",.4,5688,-1)
0^1
"KRN",.4,5688,0)
SDL--PREAPPOINTMENT LETTERS^3171214.0731^^2^^^3171214
"KRN",.4,5688,"DXS")
3
"KRN",.4,5688,"DXS",1,9.2)
S DIP(1)=$S($D(^DPT(D0,0)):^(0),1:"") S X=$P(DIP(1),U,1),DIP(2)=$G(X) S X=",",DIP(3)=$G(X) S X=2,X=$P(DIP(2),DIP(3),X)_" ",DIP(4)=$G(X) S X=$P(DIP(1),U,1)
"KRN",.4,5688,"DXS",2,9.2)
S DIP(1)=$S($D(^DPT(D0,0)):^(0),1:"") S X=$P(DIP(1),U,1),DIP(2)=$G(X) S X=",",DIP(3)=$G(X) S X=2,X=$P(DIP(2),DIP(3),X)_" ",DIP(4)=$G(X) S X=$P(DIP(1),U,1)
"KRN",.4,5688,"DXS",2,9.3)
X DXS(2,9.2) S DIP(5)=$G(X) S X=",",DIP(6)=$G(X) S X=1,X=$P(DIP(5),DIP(6),X) S Y=X,X=DIP(4),X=X_Y_","
"KRN",.4,5688,"F",1)
X DXS(1,9.2) S DIP(5)=$G(X) S X=",",DIP(6)=$G(X) S X=1,X=$P(DIP(5),DIP(6),X) S Y=X,X=DIP(4),X=X_Y W X K DIP;Z;"$P(NAME,",",2)_" "_$P(NAME,",",1)"~
"KRN",.4,5688,"F",2)
.111;C1~.114;C1~.115~.116;C1~"Dear";S2;C1~
"KRN",.4,5688,"F",3)
X DXS(2,9.3) X "F %=2:1:$L(X) I $E(X,%)?1U,$E(X,%-1)?1A S X=$E(X,0,%-1)_$C($A(X,%)+32)_$E(X,%+1,999)" W X K DIP;Z;"LOWERCASE($P(NAME,",",2)_" "_$P(NAME,",",1)_",")"~
"KRN",.4,5688,"F",4)
"Your appointment is on ";S2~1900,S X="D1" Q:X  Q:$NA(@X)[U  S X=$G(@X) S X=X D DW^%DTC W X K DIP;Z;"DAYOFWEEK(VAR("D1"))"~1900,0~
"KRN",.4,5688,"F",5)
1900,W !,$G(DRMK,""),!,"";Z;"W !,$G(DRMK,""),!,"""~"Thank you";S2~"THE VA";S2;C50~
"KRN",.4,5688,"H")
@
"KRN",.4,5688,"HLANG")
1
"MBREQ")
0
"ORD",5,.4)
.4;5;;;EDEOUT^DIFROMSO(.4,DA,"",XPDA);FPRE^DIFROMSI(.4,"",XPDA);EPRE^DIFROMSI(.4,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.4,DA,"",XPDA);DEL^DIFROMSK(.4,"",%)
"ORD",5,.4,0)
PRINT TEMPLATE
"PKG",16,-1)
1^1
"PKG",16,0)
SCHEDULING^SD^APPOINTMENTS,PROFILES,LETTERS,AMIS REPORTS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
5.3^2930813^2930930
"PKG",16,22,1,"PAH",1,0)
680^3171214^520736558
"PKG",16,22,1,"PAH",1,1,0)
^^5^5^3171214
"PKG",16,22,1,"PAH",1,1,1,0)
This patch (SD*5.3*680) addresses this one (1) issue:
"PKG",16,22,1,"PAH",1,1,2,0)
(1)  I16592426FY17 - Self Identified Gender
"PKG",16,22,1,"PAH",1,1,3,0)
   -       SDL--PREAPPOINTMENT LETTERS Print Template and VistA
"PKG",16,22,1,"PAH",1,1,4,0)
           routines SDEC40, SDECU, and SDLT are modified and
"PKG",16,22,1,"PAH",1,1,5,0)
           remove gender implication(s).
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","SDEC40")
0^1^B69194006^B68854167
"RTN","SDEC40",1,0)
SDEC40 ;ALB/SAT - VISTA SCHEDULING RPCS ;JUN 21, 2017
"RTN","SDEC40",2,0)
 ;;5.3;Scheduling;**627,665,680**;Aug 13, 1993;Build 2
"RTN","SDEC40",3,0)
 ;
"RTN","SDEC40",4,0)
 Q
"RTN","SDEC40",5,0)
 ;
"RTN","SDEC40",6,0)
 ;  APL - Print Appointment Letter
"RTN","SDEC40",7,0)
 ;
"RTN","SDEC40",8,0)
APPTLETR(SDECY,SDECAPID,LT)  ;Print Appointment Letter
"RTN","SDEC40",9,0)
 ;APPTLETR(SDECY,SDECAPID,LT)  external parameter tag is in SDEC
"RTN","SDEC40",10,0)
 ; SDECAPPT = Pointer to appointment in SDEC APPOINTMENT file 409.84
"RTN","SDEC40",11,0)
 ; LT       = Letter type - "N"=No Show; "P"=Pre-Appointment; "A"=Cancelled by Patient; "C"=Cancelled by Clinic
"RTN","SDEC40",12,0)
 ; Called by SDEC PRINT APPT LETTER remote procedure
"RTN","SDEC40",13,0)
 N SDECI,SDECNOD,SDECTMP,DFN,IN,RES,SCLT,SDC,SDLET,SDS,SDT,X1,X2,Y
"RTN","SDEC40",14,0)
 N SDIV,SDFORM,SDNAM,SDSSN,VAPA
"RTN","SDEC40",15,0)
 S SDECI=0
"RTN","SDEC40",16,0)
 K ^TMP("SDEC",$J)
"RTN","SDEC40",17,0)
 S SDECY="^TMP(""SDEC"","_$J_")"
"RTN","SDEC40",18,0)
 S ^TMP("SDEC",$J,0)="T00080ERRORID"_$C(30)
"RTN","SDEC40",19,0)
 I '+SDECAPID D ERR^SDECERR("Invalid Appointment ID.") Q
"RTN","SDEC40",20,0)
 I '$D(^SDEC(409.84,SDECAPID,0)) D ERR^SDECERR("Invalid Appointment ID.") Q
"RTN","SDEC40",21,0)
 I $G(LT)="" S LT="P"  ;D ERR^SDECERR("Invalid Letter Type.") Q
"RTN","SDEC40",22,0)
 S SDECNOD=^SDEC(409.84,SDECAPID,0)
"RTN","SDEC40",23,0)
 S SDT=$P(SDECNOD,U)  ;Get appt time
"RTN","SDEC40",24,0)
 S DFN=$P(SDECNOD,U,5)  ;Get patient pointer to VA PATIENT (^DPT) file 2
"RTN","SDEC40",25,0)
 S RES=$P(SDECNOD,U,7) S SDC=$P(^SDEC(409.831,RES,0),U,4)  ;get resource and clinic
"RTN","SDEC40",26,0)
 S SDS=^DPT(DFN,"S",SDT,0)
"RTN","SDEC40",27,0)
 S SCLT=$S(LT="N":1,LT="P":2,LT="C":3,LT="A":4,1:"2") ;get storage position of LETTER pointer
"RTN","SDEC40",28,0)
 S SDLET=$P($G(^SC(SDC,"LTR")),U,SCLT)
"RTN","SDEC40",29,0)
 I SDLET="" D ERR^SDECERR($S(SCLT=1:"No-Show",SCLT=2:"Pre-Appointment",SCLT=3:"Clinic Cancellation",1:"Patient Cancellation")_"Letter not defined for Clinic "_$P(^SC(SDC,0),U)_".") Q
"RTN","SDEC40",30,0)
 S SDIV=$P(^SC(SDC,0),"^",15),SDIV=$S(SDIV:SDIV,1:$O(^DG(40.8,0)))
"RTN","SDEC40",31,0)
 S SDFORM=$P($G(^DG(40.8,SDIV,"LTR")),U,1)
"RTN","SDEC40",32,0)
 ; data header
"RTN","SDEC40",33,0)
 S ^TMP("SDEC",$J,0)="T00080TEXT"_$C(30)
"RTN","SDEC40",34,0)
 D PRT(DFN,SDC,SDT,LT,SDLET,SDFORM)
"RTN","SDEC40",35,0)
 D WRAPP(DFN,SDC,SDT,LT,SDLET)
"RTN","SDEC40",36,0)
 D REST(DFN,SDC,SDT,LT,SDLET,SDFORM)
"RTN","SDEC40",37,0)
 S SDECI=SDECI+1 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$C(30,31)
"RTN","SDEC40",38,0)
 Q
"RTN","SDEC40",39,0)
 ;
"RTN","SDEC40",40,0)
 ;
"RTN","SDEC40",41,0)
PRT(DFN,SDC,SD,LT,SDLET,SDFORM) ;
"RTN","SDEC40",42,0)
 ;  DFN - pointer to PATIENT file 2
"RTN","SDEC40",43,0)
 ;  SDC - pointer to HOSPITAL LOCATION file 44
"RTN","SDEC40",44,0)
 ;  SD  - appointment time in FM format
"RTN","SDEC40",45,0)
 ;  LT  - Letter type - "N"=No Show; "P"=Pre-Appointment; "A"=Cancelled by Patient; "C"=Cancelled by Clinic
"RTN","SDEC40",46,0)
 ;  SDLET - pointer to LETTER file 407.5
"RTN","SDEC40",47,0)
 ;WRITE GREETING AND OPENING TEXT OF LETTER
"RTN","SDEC40",48,0)
 N A,DPTNAME,IN,X,Y
"RTN","SDEC40",49,0)
 S A=DFN
"RTN","SDEC40",50,0)
 Q:DFN=""
"RTN","SDEC40",51,0)
 Q:LT=""
"RTN","SDEC40",52,0)
 S SDFORM=$G(SDFORM)
"RTN","SDEC40",53,0)
 S Y=DT D DTS^SDUTL
"RTN","SDEC40",54,0)
 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$$FILL^SDECU(64," ")_Y_$C(13,10)
"RTN","SDEC40",55,0)
 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$$FILL^SDECU(64," ")_$$LAST4(A)_$C(13,10)
"RTN","SDEC40",56,0)
 I 'SDFORM D
"RTN","SDEC40",57,0)
 .F I=1:1:4 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$C(13,10)
"RTN","SDEC40",58,0)
 .D ADDR
"RTN","SDEC40",59,0)
 .F I=1:1:4 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$C(13,10)
"RTN","SDEC40",60,0)
 ;
"RTN","SDEC40",61,0)
 S DPTNAME("FILE")=2,DPTNAME("FIELD")=".01",DPTNAME("IENS")=(+A)_","
"RTN","SDEC40",62,0)
 S X=$$NAMEFMT^XLFNAME(.DPTNAME,"G","M")
"RTN","SDEC40",63,0)
 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)="Dear "_X_","_$C(13,10) ;SD*5.3*680 - Removed concatenation "Mr. "/"Ms. " before X .
"RTN","SDEC40",64,0)
 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$C(13,10)
"RTN","SDEC40",65,0)
 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$C(13,10)
"RTN","SDEC40",66,0)
 ;loop and display initial section of Letter
"RTN","SDEC40",67,0)
 S IN=0 F  S IN=$O(^VA(407.5,SDLET,1,IN)) Q:IN'>0  D
"RTN","SDEC40",68,0)
 . S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=^VA(407.5,SDLET,1,IN,0)_$C(13,10)
"RTN","SDEC40",69,0)
 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$C(13,10)
"RTN","SDEC40",70,0)
 Q
"RTN","SDEC40",71,0)
 ;
"RTN","SDEC40",72,0)
WRAPP(DFN,SDC,SD,LT,SDLET) ;WRITE APPOINTMENT INFORMATION
"RTN","SDEC40",73,0)
 N B,DOW,S,SDCL,SDDAT,SDHX,SDT0,SDTMP,SDX,SDX1,X
"RTN","SDEC40",74,0)
 S SDX=SD,S=$G(^DPT(DFN,"S",SD,0))  ;alb/sat 665 add S
"RTN","SDEC40",75,0)
 S SDCL=$P(^SC(+SDC,0),"^",1),SDCL="    Clinic:  "_SDCL D FORM ; SD*5.3*622 end changes
"RTN","SDEC40",76,0)
 ;
"RTN","SDEC40",77,0)
 S SDX1=SDX S:$D(SDS) S=SDS F B=3,4,5 I $P(S,"^",B)]"" S SDCL=$S(B=3:"LAB",B=4:"XRAY",1:"EKG"),SDX=$P(S,"^",B) D FORM   ;alb/sat 665
"RTN","SDEC40",78,0)
 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$C(13,10)  ;alb/sat 665
"RTN","SDEC40",79,0)
 S (SDX,X)=SDX1 Q
"RTN","SDEC40",80,0)
 ; SD*5.3*622 - add more detail for appointment and format it
"RTN","SDEC40",81,0)
FORM S:$D(SDX) X=SDX S SDHX=X D DW^%DTC S DOW=X,X=SDHX X ^DD("FUNC",2,1) S SDT0=X,SDDAT=$P("JAN^FEB^MAR^APR^MAY^JUN^JUL^AUG^SEP^OCT^NOV^DEC","^",$E(SDHX,4,5))_" "_+$E(SDHX,6,7)_", "_(1700+$E(SDHX,1,3))
"RTN","SDEC40",82,0)
 I '$D(B) S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)="     Date/Time: "_DOW_"  "_$J(SDDAT,12)_$S('$D(B)&$D(SDC):$J(SDT0,9),1:"")_$C(13,10)
"RTN","SDEC40",83,0)
 I '$D(B),$D(SDC) D
"RTN","SDEC40",84,0)
 .S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)="    "_SDCL_$C(13,10)
"RTN","SDEC40",85,0)
 ; get default provider if defined for a given clinic, print it on the
"RTN","SDEC40",86,0)
 ; letter only if we have a YES on file, same for clinic location
"RTN","SDEC40",87,0)
 ; skip printing the provider label if the field is empty in file #44
"RTN","SDEC40",88,0)
 N J,SDLOC,SDPROV,SDPRNM,SDTEL,SDTELEXT
"RTN","SDEC40",89,0)
 S SDLOC=$P($G(^SC(+SDC,0)),"^",11) ; physical location of the clinic
"RTN","SDEC40",90,0)
 S SDTEL=$G(^SC(+SDC,99))        ; telephone number of clinic
"RTN","SDEC40",91,0)
 S SDTELEXT="" I SDTEL]"",$G(^SC(+SDC,99.1))]"" D
"RTN","SDEC40",92,0)
 .S SDTELEXT=^SC(+SDC,99.1)  ; telephone ext of clinic
"RTN","SDEC40",93,0)
 ; get default provider, if any
"RTN","SDEC40",94,0)
 F J=0:0 S J=$O(^SC(+SDC,"PR",J)) Q:'J>0  I $P($G(^SC(+SDC,"PR",J,0)),U,2)=1 S SDPROV=+$P(^SC(+SDC,"PR",J,0),U,1)
"RTN","SDEC40",95,0)
 I $D(SDC),'$D(B),$P($G(^VA(407.5,SDLET,3)),U,2)="Y" D
"RTN","SDEC40",96,0)
 .I SDLOC]"" S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)="     "_"Location:  "_SDLOC_$C(13,10)
"RTN","SDEC40",97,0)
 I $D(SDC),'$D(B),SDTEL]"" D
"RTN","SDEC40",98,0)
 .S SDTMP="    Telephone:  "_SDTEL
"RTN","SDEC40",99,0)
 .I SDTELEXT]"" S SDTMP=SDTMP_"   Telephone Ext.:  "_SDTELEXT
"RTN","SDEC40",100,0)
 .S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=SDTMP_$C(13,10)
"RTN","SDEC40",101,0)
 I $D(SDPROV) D
"RTN","SDEC40",102,0)
 .I $D(SDC),SDPROV>0 S SDPRNM=$P(^VA(200,SDPROV,0),U,1)
"RTN","SDEC40",103,0)
 .I $D(SDC),'$D(B),$P($G(^VA(407.5,SDLET,3)),U,1)="Y" I SDPRNM]"" S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)="     Provider:  "_$G(SDPRNM)_$C(13,10)
"RTN","SDEC40",104,0)
 ; call handler for LAB, XRAY, and EKG tests
"RTN","SDEC40",105,0)
 I $D(B) D TST
"RTN","SDEC40",106,0)
 Q
"RTN","SDEC40",107,0)
REST(DFN,SDC,SD,LT,SDLET,SDFORM) ;WRITE THE REMAINDER OF LETTER
"RTN","SDEC40",108,0)
 N A,Z5,I,IN,X
"RTN","SDEC40",109,0)
 S A=DFN
"RTN","SDEC40",110,0)
 S SDFORM=$G(SDFORM)
"RTN","SDEC40",111,0)
 ;loop and display final section of Letter
"RTN","SDEC40",112,0)
 S IN=0 F  S IN=$O(^VA(407.5,SDLET,2,IN)) Q:IN'>0  D
"RTN","SDEC40",113,0)
 . S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=^VA(407.5,SDLET,2,IN,0)_$C(13,10)
"RTN","SDEC40",114,0)
 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$C(13,10)
"RTN","SDEC40",115,0)
 D:SDFORM=1 ADDR
"RTN","SDEC40",116,0)
 Q
"RTN","SDEC40",117,0)
ADDR K VAHOW S DFN=+A S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$$FILL^SDECU(11," ")_$$FML^DGNFUNC(DFN)_$C(13,10)
"RTN","SDEC40",118,0)
 I $D(^DG(43,1,"BT")),'$P(^("BT"),"^",3) S VAPA("P")=""
"RTN","SDEC40",119,0)
 S X1=DT,X2=5 D C^%DTC ;I '$D(VAPA("P")) S (VATEST("ADD",9),VATEST("ADD",10))=X
"RTN","SDEC40",120,0)
 D ADD^VADPT D
"RTN","SDEC40",121,0)
 .;CHANGE STATE TO ABBR.
"RTN","SDEC40",122,0)
 .N SDIENS,X
"RTN","SDEC40",123,0)
 .I $D(VAPA(5)) S SDIENS=+VAPA(5)_",",X=$$GET1^DIQ(5,SDIENS,1),$P(VAPA(5),U,2)=X
"RTN","SDEC40",124,0)
 .I $D(VAPA(17)) S SDIENS=+VAPA(17)_",",X=$$GET1^DIQ(5,SDIENS,1),$P(VAPA(17),U,2)=X
"RTN","SDEC40",125,0)
 .K SDIENS Q
"RTN","SDEC40",126,0)
 N SDCCACT1,SDCCACT2,LL
"RTN","SDEC40",127,0)
 S SDCCACT1=VAPA(12),SDCCACT2=$P($G(VAPA(22,2)),"^",3)
"RTN","SDEC40",128,0)
 ;if confidential address is not active for scheduling/appointment letters, print to regular address
"RTN","SDEC40",129,0)
 I ($G(SDCCACT1)=0)!($G(SDCCACT2)'="Y") D
"RTN","SDEC40",130,0)
 .F LL=1:1:3 I VAPA(LL)]"" S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$$FILL^SDECU(11," ")_VAPA(LL)_$C(13,10)
"RTN","SDEC40",131,0)
 .;if country is blank display as USA
"RTN","SDEC40",132,0)
 .I (VAPA(25)="")!($P(VAPA(25),"^",2)="UNITED STATES")  D  ;display city,state,zip
"RTN","SDEC40",133,0)
 ..S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$$FILL^SDECU(11," ")_VAPA(4)_" "_$P(VAPA(5),U,2)_"  "_$P(VAPA(11),U,2)_$C(13,10)
"RTN","SDEC40",134,0)
 .E  D  ;display postal code,city,province
"RTN","SDEC40",135,0)
 ..S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$$FILL^SDECU(11," ")_VAPA(24)_" "_VAPA(4)_" "_VAPA(23)_$C(13,10)
"RTN","SDEC40",136,0)
 .I ($P(VAPA(25),"^",2)'="UNITED STATES") S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$$FILL^SDECU(11," ")_$P(VAPA(25),U,2)_$C(13,10) ;display country
"RTN","SDEC40",137,0)
 ;if confidential address is active for scheduling/appointment letters, print to confidential address
"RTN","SDEC40",138,0)
 I $G(SDCCACT1)=1,$G(SDCCACT2)="Y" D
"RTN","SDEC40",139,0)
 .F LL=13:1:15 I VAPA(LL)]"" S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$$FILL^SDECU(11," ")_VAPA(LL)_$C(13,10)
"RTN","SDEC40",140,0)
 .I (VAPA(28)="")!($P(VAPA(28),"^",2)="UNITED STATES") D
"RTN","SDEC40",141,0)
 ..S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$$FILL^SDECU(11," ")_VAPA(16)_" "_$P(VAPA(17),U,2)_"  "_$P(VAPA(18),U,2)_$C(13,10)
"RTN","SDEC40",142,0)
 .E  D
"RTN","SDEC40",143,0)
 ..S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$$FILL^SDECU(11," ")_VAPA(27)_" "_VAPA(16)_" "_VAPA(26)_$C(13,10)
"RTN","SDEC40",144,0)
 .I ($P(VAPA(28),"^",2)'="UNITED STATES") S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$$FILL^SDECU(11," ")_$P(VAPA(28),U,2)_$C(13,10)
"RTN","SDEC40",145,0)
 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$C(13,10)
"RTN","SDEC40",146,0)
 D KVAR^VADPT
"RTN","SDEC40",147,0)
 Q
"RTN","SDEC40",148,0)
 ;
"RTN","SDEC40",149,0)
 ;
"RTN","SDEC40",150,0)
LAST4(DFN) ;Return patient "last four"
"RTN","SDEC40",151,0)
 N SDX
"RTN","SDEC40",152,0)
 S SDX=$G(^DPT(+DFN,0))
"RTN","SDEC40",153,0)
 Q $E(SDX)_$E($P(SDX,U,9),6,9)
"RTN","SDEC40",154,0)
 ;
"RTN","SDEC40",155,0)
BADADD ;Print patients with a Bad Address Indicator
"RTN","SDEC40",156,0)
 I '$D(^TMP($J,"BADADD")) Q
"RTN","SDEC40",157,0)
 N SDHDR,SDHDR1
"RTN","SDEC40",158,0)
 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$$FILL^SDECU(79,"*")_$C(13,10)
"RTN","SDEC40",159,0)
 S SDHDR="BAD ADDRESS INDICATOR LIST" S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$$FILL^SDECU((80-$L(SDHDR)/2)," ")_SDHDR_$C(13,10)
"RTN","SDEC40",160,0)
 S SDHDR1="** THE LETTER FOR THESE PATIENT(S) DID NOT PRINT DUE TO A BAD ADDRESS INDICATOR."
"RTN","SDEC40",161,0)
 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)="Last 4"_$C(13,10)
"RTN","SDEC40",162,0)
 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)="of SSN   "_"Patient Name"_$C(13,10)
"RTN","SDEC40",163,0)
 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$$FILL^SDECU(79,"*")_$C(13,10)
"RTN","SDEC40",164,0)
 N SDNAM,SDDFN
"RTN","SDEC40",165,0)
 S SDNAM="" F  S SDNAM=$O(^TMP($J,"BADADD",SDNAM)) Q:SDNAM=""  D
"RTN","SDEC40",166,0)
 . S SDDFN=0 F  S SDDFN=$O(^TMP($J,"BADADD",SDNAM,SDDFN)) Q:'SDDFN  D
"RTN","SDEC40",167,0)
 . . S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$$LAST4(SDDFN)_"      "_SDNAM_$C(13,10)
"RTN","SDEC40",168,0)
 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$C(13,10)
"RTN","SDEC40",169,0)
 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$C(13,10)
"RTN","SDEC40",170,0)
 S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=SDHDR1_$C(13,10)
"RTN","SDEC40",171,0)
 Q
"RTN","SDEC40",172,0)
 ;
"RTN","SDEC40",173,0)
TST ; SD*5.3*622 - handle scheduled tests
"RTN","SDEC40",174,0)
 ;S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=$C(13,10)  ;alb/sat 665 remove blank line
"RTN","SDEC40",175,0)
 I ($L(SDCL)=3&($E(SDCL,1,3)="LAB")) S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=" "_SDCL_" SCHEDULED:  "_DOW_"  "_$J(SDDAT,12)_"  "_$J(SDT0,5)_$C(13,10)  ;alb/sat 665 add space
"RTN","SDEC40",176,0)
 I ($L(SDCL)=4&($E(SDCL,1,4)="XRAY")) S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=SDCL_" SCHEDULED:  "_DOW_"  "_$J(SDDAT,12)_"  "_$J(SDT0,5)_$C(13,10)
"RTN","SDEC40",177,0)
 I ($L(SDCL)=3&($E(SDCL,1,3)="EKG")) S SDECI=SDECI+1 S ^TMP("SDEC",$J,SDECI)=" "_SDCL_" SCHEDULED:  "_DOW_"  "_$J(SDDAT,12)_"  "_$J(SDT0,5)_$C(13,10)  ;alb/sat 665 add space
"RTN","SDEC40",178,0)
 Q
"RTN","SDECU")
0^2^B23730358^B23913880
"RTN","SDECU",1,0)
SDECU ;ALB/SAT - VISTA SCHEDULING RPCS ;JUN 21, 2017
"RTN","SDECU",2,0)
 ;;5.3;Scheduling;**627,665,680**;Aug 13, 1993;Build 2
"RTN","SDECU",3,0)
 ;
"RTN","SDECU",4,0)
 Q
"RTN","SDECU",5,0)
 ;
"RTN","SDECU",6,0)
DIV() ;EP; -- returns division ien for user
"RTN","SDECU",7,0)
 ;Q +$O(^DG(40.8,"C",DUZ(2),0))  ;cmi/maw 10/1/2009 patch 1011 orig line
"RTN","SDECU",8,0)
 Q +$O(^DG(40.8,"AD",DUZ(2),0))  ;cmi/maw 10/1/2009 patch 1011 for station number
"RTN","SDECU",9,0)
 ;
"RTN","SDECU",10,0)
DIVC(CLINIC) ;EP; -- returns division for clinic
"RTN","SDECU",11,0)
 Q $$GET1^DIQ(44,+CLINIC,3.5,"I")
"RTN","SDECU",12,0)
 ;
"RTN","SDECU",13,0)
FAC(CLINIC) ;EP; -- returns institution for clinic based on division
"RTN","SDECU",14,0)
 NEW X S X=$$DIVC(CLINIC)
"RTN","SDECU",15,0)
 Q $S(+X:$$GET1^DIQ(40.8,+X,.07,"I"),1:"")
"RTN","SDECU",16,0)
 ;
"RTN","SDECU",17,0)
PRIN(CLINIC) ;PEP -- returns name of clinic's principal clinic
"RTN","SDECU",18,0)
 NEW X S X=$$GET1^DIQ(44,+CLINIC,1916)
"RTN","SDECU",19,0)
 Q $S(X]"":X,1:"UNAFFILIATED CLINICS")
"RTN","SDECU",20,0)
 ;
"RTN","SDECU",21,0)
CONF() ;EP; -- returns confidential warning
"RTN","SDECU",22,0)
 Q "Confidential Patient Data Covered by Privacy Act"
"RTN","SDECU",23,0)
 ;
"RTN","SDECU",24,0)
GREETING(LETTER,PAT) ;EP; -- returns letter salutation
"RTN","SDECU",25,0)
 NEW LINE
"RTN","SDECU",26,0)
 S LINE="Dear "
"RTN","SDECU",27,0)
 ;S LINE=LINE_$S($$SEX^SDECPAT(PAT)="M":"Mr. ",1:"Ms. ")  ;SD*5.3*680 - Removed concatenation "Mr. "/"Ms. "
"RTN","SDECU",28,0)
 ;
"RTN","SDECU",29,0)
 ;S LINE=LINE_$$NAMEPRT^BDGF2(PAT,1)  ;add printable name
"RTN","SDECU",30,0)
 ;S LINE=LINE_$$NAMEPRT^BDGF2(PAT,1)_","  ;add printable name
"RTN","SDECU",31,0)
 Q LINE
"RTN","SDECU",32,0)
 ;
"RTN","SDECU",33,0)
PRV(SDCL)   ;
"RTN","SDECU",34,0)
 Q
"RTN","SDECU",35,0)
 ;
"RTN","SDECU",36,0)
PAUSE N X
"RTN","SDECU",37,0)
 U IO(0) W !!,"Press RETURN to continue, '^' to exit:"
"RTN","SDECU",38,0)
 R X:$G(DTIME)
"RTN","SDECU",39,0)
 U IO
"RTN","SDECU",40,0)
 Q
"RTN","SDECU",41,0)
 ;
"RTN","SDECU",42,0)
CLEAR  ;remove SDEC RESOURCE USER entries; command line utility for testing
"RTN","SDECU",43,0)
 N DA,DIK,SDI,SDJ,SDK
"RTN","SDECU",44,0)
 S SDI=0 F  S SDI=$O(^SDEC(409.833,SDI)) Q:SDI'>0  D
"RTN","SDECU",45,0)
 .;W !,SDI
"RTN","SDECU",46,0)
 .S DIK="^SDEC(409.833,"
"RTN","SDECU",47,0)
 .S DA=SDI
"RTN","SDECU",48,0)
 .D ^DIK
"RTN","SDECU",49,0)
 Q
"RTN","SDECU",50,0)
 ;S SDI=0 F  S SDI=$O(^SDEC(409.833,SDI)) Q:SDI'>0  W !,SDI S DIK="^SDEC(409.833," S DA=SDI D ^DIK
"RTN","SDECU",51,0)
 ;
"RTN","SDECU",52,0)
DUPS ;find duplicate entries in SDEC APPOINTMENT
"RTN","SDECU",53,0)
 N DUP,H,NOD,NOD2,PAT,RES,TYP
"RTN","SDECU",54,0)
 ;    1         2             3           4                  5                   6
"RTN","SDECU",55,0)
 ;DUP("ENTERED",<entered d/t>,<date/time>,<patient ien_name>,<resource ien_name>,type)=CNT
"RTN","SDECU",56,0)
 ;DUP("START",  <entered d/t>,<date/time>,<patient ien_name>,<resource ien_name>,type)=CNT
"RTN","SDECU",57,0)
 S H=0 F  S H=$O(^SDEC(409.84,H)) Q:H'>0  D
"RTN","SDECU",58,0)
 .S NOD=$G(^SDEC(409.84,H,0))
"RTN","SDECU",59,0)
 .S NOD2=$G(^SDEC(409.84,H,2))
"RTN","SDECU",60,0)
 .S PAT=$P(NOD,U,5)_" "_$$GET1^DIQ(2,$P(NOD,U,5)_",",.01)
"RTN","SDECU",61,0)
 .S RES=$P(NOD,U,7)_" "_$$GET1^DIQ(409.831,$P(NOD,U,7)_",",.01)
"RTN","SDECU",62,0)
 .S TYP=$$GET1^DIQ(409.84,H_",",.22) S TYP=$S(TYP="":0,1:TYP)
"RTN","SDECU",63,0)
 .S DUP("ENTERED",$P(NOD,U,9),$P(NOD,U,1),PAT,RES,TYP)=$G(DUP($P(NOD,U,1),PAT,RES,$P(NOD,U,9),TYP))+1
"RTN","SDECU",64,0)
 .S DUP("START",$P(NOD,U,1),PAT,RES,$P(NOD,U,9),TYP)=$G(DUP($P(NOD,U,1),PAT,RES,$P(NOD,U,9),TYP))+1
"RTN","SDECU",65,0)
 N S1,S2,S3,S4,S5
"RTN","SDECU",66,0)
 S S1="" F  S S1=$O(DUP(S1)) Q:S1=""  D
"RTN","SDECU",67,0)
 .S S2="" F  S S2=$O(DUP(S1,S2)) Q:S2=""  D
"RTN","SDECU",68,0)
 ..S S3="" F  S S3=$O(DUP(S1,S2,S3)) Q:S3=""  D
"RTN","SDECU",69,0)
 ...S S4="" F  S S4=$O(DUP(S1,S2,S3,S4)) Q:S4=""  D
"RTN","SDECU",70,0)
 ....S S5="" F  S S5=$O(DUP(S1,S2,S3,S4,S5)) Q:S5=""  D
"RTN","SDECU",71,0)
 .....W !,$E(S1,1,12),?(14),$E(S2,1,15),?(31),$E(S3,1,15),?(48),$E(S4,1,12),?(62),S5,"   ",DUP(S1,S2,S3,S4,S5)
"RTN","SDECU",72,0)
 Q
"RTN","SDECU",73,0)
 ;
"RTN","SDECU",74,0)
GETSUB(TXT)  ;
"RTN","SDECU",75,0)
 N LAST
"RTN","SDECU",76,0)
 S LAST=""
"RTN","SDECU",77,0)
 I +TXT,+TXT=TXT S LAST=TXT-1   ;alb/sat 665 - handle numeric
"RTN","SDECU",78,0)
 E  D
"RTN","SDECU",79,0)
 .S LAST=$E(TXT,$L(TXT))
"RTN","SDECU",80,0)
 .S LAST=$C($A(LAST)-1)
"RTN","SDECU",81,0)
 .S LAST=$E(TXT,1,$L(TXT)-1)_LAST_"~"
"RTN","SDECU",82,0)
 Q LAST
"RTN","SDECU",83,0)
 ;
"RTN","SDECU",84,0)
FILL(PADS,CHAR)  ;pad string
"RTN","SDECU",85,0)
 N I,RET
"RTN","SDECU",86,0)
 S CHAR=$G(CHAR)
"RTN","SDECU",87,0)
 S:CHAR="" CHAR=" "
"RTN","SDECU",88,0)
 S RET=""
"RTN","SDECU",89,0)
 F I=1:1:PADS S RET=RET_CHAR
"RTN","SDECU",90,0)
 Q RET
"RTN","SDECU",91,0)
 ;
"RTN","SDECU",92,0)
RPC(BUILD) ;list rpcs  Same as fields used in 7.2 Interface Detailed Design
"RTN","SDECU",93,0)
 N DASH,RP,RPA,RPN,SDI,SDJ,SDK
"RTN","SDECU",94,0)
 Q:$G(BUILD)=""
"RTN","SDECU",95,0)
 S BUILD=$O(^XPD(9.6,"B",BUILD,0))
"RTN","SDECU",96,0)
 Q:BUILD=""
"RTN","SDECU",97,0)
 S $P(DASH,"-",75)="-"
"RTN","SDECU",98,0)
 S SDI=0 F  S SDI=$O(^XPD(9.6,BUILD,"KRN",8994,"NM",SDI)) Q:SDI'>0  D
"RTN","SDECU",99,0)
 .S RPN=$P($G(^XPD(9.6,BUILD,"KRN",8994,"NM",SDI,0)),U,1)
"RTN","SDECU",100,0)
 .S RP(RPN)=$O(^XWB(8994,"B",RPN,0))
"RTN","SDECU",101,0)
 S RPN="" F  S RPN=$O(RP(RPN)) Q:RPN=""  D
"RTN","SDECU",102,0)
 .S RP=RP(RPN)
"RTN","SDECU",103,0)
 .W !!,DASH,!!
"RTN","SDECU",104,0)
 .;NAME
"RTN","SDECU",105,0)
 .W RPN
"RTN","SDECU",106,0)
 .;DESCRIPTION
"RTN","SDECU",107,0)
 .S SDJ=0 F  S SDJ=$O(^XWB(8994,RP,1,SDJ)) Q:SDJ'>0  W !,^(SDJ,0)
"RTN","SDECU",108,0)
 .;INPUT
"RTN","SDECU",109,0)
 .W !!,"***INPUT:"
"RTN","SDECU",110,0)
 .I $O(^XWB(8994,RP,2,0))'>0 W !," NO INPUT"
"RTN","SDECU",111,0)
 .S SDJ=0 F  S SDJ=$O(^XWB(8994,RP,2,SDJ)) Q:SDJ'>0  D
"RTN","SDECU",112,0)
 ..W !," ",$P(^XWB(8994,RP,2,SDJ,0),U,1)
"RTN","SDECU",113,0)
 ..S SDK=0 F  S SDK=$O(^XWB(8994,RP,2,SDJ,1,SDK)) Q:SDK'>0  D
"RTN","SDECU",114,0)
 ...W !,^XWB(8994,RP,2,SDJ,1,SDK,0)
"RTN","SDECU",115,0)
 .W !!,"***RETURN:"
"RTN","SDECU",116,0)
 .S SDJ=0 F  S SDJ=$O(^XWB(8994,RP,3,SDJ)) Q:SDJ'>0  D
"RTN","SDECU",117,0)
 ..W !,^XWB(8994,RP,3,SDJ,0)
"RTN","SDECU",118,0)
 Q
"RTN","SDECU",119,0)
 ;
"RTN","SDECU",120,0)
RPC2(BUILD) ;list rpcs - same fields as 6.2.2.3.11 Remote Procedure Call (RPC)
"RTN","SDECU",121,0)
 N DASH,DATA,RP,RPA,RPN,SDI,SDJ,SDK,X
"RTN","SDECU",122,0)
 Q:$G(BUILD)=""
"RTN","SDECU",123,0)
 S BUILD=$O(^XPD(9.6,"B",BUILD,0))
"RTN","SDECU",124,0)
 Q:BUILD=""
"RTN","SDECU",125,0)
 S $P(DASH,"-",75)="-"
"RTN","SDECU",126,0)
 S SDI=0 F  S SDI=$O(^XPD(9.6,BUILD,"KRN",8994,"NM",SDI)) Q:SDI'>0  D
"RTN","SDECU",127,0)
 .S RPN=$P($G(^XPD(9.6,BUILD,"KRN",8994,"NM",SDI,0)),U,1)
"RTN","SDECU",128,0)
 .S RP(RPN)=$O(^XWB(8994,"B",RPN,0))
"RTN","SDECU",129,0)
 S RPN="" F  S RPN=$O(RP(RPN)) Q:RPN=""  D
"RTN","SDECU",130,0)
 .S RP=RP(RPN)
"RTN","SDECU",131,0)
 .K DATA
"RTN","SDECU",132,0)
 .D GETS^DIQ(8994,RP,"*","IE","DATA")
"RTN","SDECU",133,0)
 .S X="DATA(8994,"""_RP_","")"
"RTN","SDECU",134,0)
 .W !!,DASH,!!
"RTN","SDECU",135,0)
 .W "Name",?20,RPN
"RTN","SDECU",136,0)
 .W !,"TAG^RTN",?20,@X@(.02,"E")_"^"_@X@(.03,"E")
"RTN","SDECU",137,0)
 .W !!,"***Input Parameters"
"RTN","SDECU",138,0)
 .I $O(^XWB(8994,RP,2,0))'>0 W !," NO INPUT"
"RTN","SDECU",139,0)
 .S SDJ=0 F  S SDJ=$O(^XWB(8994,RP,2,SDJ)) Q:SDJ'>0  D
"RTN","SDECU",140,0)
 ..W !," ",$P(^XWB(8994,RP,2,SDJ,0),U,1)
"RTN","SDECU",141,0)
 ..S SDK=0 F  S SDK=$O(^XWB(8994,RP,2,SDJ,1,SDK)) Q:SDK'>0  D
"RTN","SDECU",142,0)
 ...W !,^XWB(8994,RP,2,SDJ,1,SDK,0)
"RTN","SDECU",143,0)
 .W !!,"Return Value Type",?20,@X@(.04,"E")
"RTN","SDECU",144,0)
 .;DESCRIPTION
"RTN","SDECU",145,0)
 .W !!,"DESCRIPTION"
"RTN","SDECU",146,0)
 .S SDJ=0 F  S SDJ=$O(^XWB(8994,RP,1,SDJ)) Q:SDJ'>0  W !,^(SDJ,0)
"RTN","SDECU",147,0)
 Q
"RTN","SDLT")
0^3^B29114101^B28779463
"RTN","SDLT",1,0)
SDLT ;ALB/LDB - CANCELLATION LETTERS ;14 Feb 2003
"RTN","SDLT",2,0)
 ;;5.3;Scheduling;**185,213,281,330,398,523,441,555,622,641,680**;Aug 13, 1993;Build 2
"RTN","SDLT",3,0)
 ;
"RTN","SDLT",4,0)
 ;**************************************************************************
"RTN","SDLT",5,0)
 ;                          MODIFICATIONS
"RTN","SDLT",6,0)
 ;                          
"RTN","SDLT",7,0)
 ;   DATE      PATCH     DEVELOPER  DESCRIPTION OF CHANGES
"RTN","SDLT",8,0)
 ; --------  ----------  ---------  ----------------------------------------
"RTN","SDLT",9,0)
 ; 02/14/03  SD*5.3*281  SAUNDERS   Print letters to confidential address if
"RTN","SDLT",10,0)
 ;                                  requested
"RTN","SDLT",11,0)
 ; 12/2/03   SD*5.3*330  LUNDEN     Remove form feed from PRT+0
"RTN","SDLT",12,0)
 ; 01/21/16  SD*5.3*641  HSI        Print 1st piece of 99 node
"RTN","SDLT",13,0)
 ; 11/27/17  SD*5.3*680  JACKSON    Remove gender implications
"RTN","SDLT",14,0)
 ;**************************************************************************
"RTN","SDLT",15,0)
 ;
"RTN","SDLT",16,0)
 N Z0,X
"RTN","SDLT",17,0)
 ;WRITE GREETING AND OPENING TEXT OF LETTER
"RTN","SDLT",18,0)
PRT S DFN=$P(A,U,1)  ;SD*523
"RTN","SDLT",19,0)
 I $D(SDNOSH) I $D(^DPT(DFN,.1)) S POP=1 Q:POP  ;SD/523
"RTN","SDLT",20,0)
 S Y=DT D DTS^SDUTL
"RTN","SDLT",21,0)
 I +$G(SDFIRST)=0 W @IOF ;SD*5.3*330 Form feed only after letter #1
"RTN","SDLT",22,0)
 K SDFIRST
"RTN","SDLT",23,0)
 ;S SDFIRST=0
"RTN","SDLT",24,0)
 W !,?65,Y,!,?65,$$LAST4(A),!!!!
"RTN","SDLT",25,0)
 I 'SDFORM W !!!!! D ADDR W !!!!
"RTN","SDLT",26,0)
W1 W !,"Dear " ;,$S($P(^DPT(+A,0),"^",2)="M":"Mr. ",1:"Ms. ")   SD*5.3*680
"RTN","SDLT",27,0)
 N DPTNAME
"RTN","SDLT",28,0)
 S DPTNAME("FILE")=2,DPTNAME("FIELD")=".01",DPTNAME("IENS")=(+A)_","
"RTN","SDLT",29,0)
 S X=$$NAMEFMT^XLFNAME(.DPTNAME,"G","M") W X,","
"RTN","SDLT",30,0)
 W !! K ^UTILITY($J,"W"),DIWF,DIWR,DIWF S DIWL=1,DIWF="C80WN" F Z0=0:0 S Z0=$O(^VA(407.5,SDLET,1,Z0)) Q:Z0'>0  S X=^(Z0,0) D ^DIWP
"RTN","SDLT",31,0)
 D ^DIWW K ^UTILITY($J,"W") Q
"RTN","SDLT",32,0)
WRAPP ;WRITE APPOINTMENT INFORMATION
"RTN","SDLT",33,0)
 N B
"RTN","SDLT",34,0)
 ; SD*5.3*622 - re-arrange display of clinic name
"RTN","SDLT",35,0)
 ;S:$D(SC)&'$D(SDC) SDC=SC S SDCL=$P(^SC(+SDC,0),"^",1),SDCL=SDCL_" Clinic" D FORM
"RTN","SDLT",36,0)
 S:$D(SC)&'$D(SDC) SDC=SC S SDCL=$P(^SC(+SDC,0),"^",1),SDCL="   Clinic:  "_SDCL D FORM ; SD*5.3*622 end changes
"RTN","SDLT",37,0)
 ;
"RTN","SDLT",38,0)
 S SDX1=$S($D(SDX):SDX,1:X) S:$D(SDS) S=SDS F B=3,4,5 I $P(S,"^",B)]"" S SDCL=$S(B=3:"LAB",B=4:"XRAY",1:"EKG"),SDX=$P(S,"^",B) D FORM
"RTN","SDLT",39,0)
 S (SDX,X)=SDX1 Q
"RTN","SDLT",40,0)
 ; SD*5.3*622 - add more detail for appointment and format it
"RTN","SDLT",41,0)
FORM S:$D(SDX) X=SDX S SDHX=X D DW^%DTC S DOW=X,X=SDHX X ^DD("FUNC",2,1) S SDT0=X,SDDAT=$P("JAN^FEB^MAR^APR^MAY^JUN^JUL^AUG^SEP^OCT^NOV^DEC","^",$E(SDHX,4,5))_" "_+$E(SDHX,6,7)_", "_(1700+$E(SDHX,1,3))
"RTN","SDLT",42,0)
 W:'$D(B) !?5,"Date/Time: ",?17,DOW,?$L(DOW)+19,$J(SDDAT,12)
"RTN","SDLT",43,0)
 I '$D(B),$D(SDC) W ?22,$J(SDT0,9),!?5,SDCL
"RTN","SDLT",44,0)
 ; get default provider if defined for a given clinic, print it on the
"RTN","SDLT",45,0)
 ; letter only if we have a YES on file, same for clinic location
"RTN","SDLT",46,0)
 ; skip printing the provider label if the field is empty in file #44
"RTN","SDLT",47,0)
 N J,SDLOC,SDPROV,SDPRNM,SDTEL,SDTELEXT
"RTN","SDLT",48,0)
 S SDLOC=$P($G(^SC(+SDC,0)),"^",11) ; physical location of the clinic
"RTN","SDLT",49,0)
 S SDTEL=$G(^SC(+SDC,99))        ; telephone number of clinic
"RTN","SDLT",50,0)
 S SDTELEXT="" I SDTEL]"",$G(^SC(+SDC,99.1))]"" D
"RTN","SDLT",51,0)
 .S SDTELEXT=^SC(+SDC,99.1)  ; telephone ext of clinic
"RTN","SDLT",52,0)
 ; get default provider, if any
"RTN","SDLT",53,0)
 F J=0:0 S J=$O(^SC(+SDC,"PR",J)) Q:'J>0  I $P($G(^SC(+SDC,"PR",J,0)),U,2)=1 S SDPROV=+$P(^SC(+SDC,"PR",J,0),U,1)
"RTN","SDLT",54,0)
 I $D(SDC),'$D(B),$P($G(^VA(407.5,SDLET,3)),U,2)="Y" D
"RTN","SDLT",55,0)
 .W:SDLOC]"" !?6,"Location:  "_SDLOC
"RTN","SDLT",56,0)
 I $D(SDC),'$D(B),SDTEL]"" D
"RTN","SDLT",57,0)
 .W !?5,"Telephone:  ",$P(SDTEL,U)
"RTN","SDLT",58,0)
 .W:SDTELEXT]"" "   Telephone Ext.:  ",SDTELEXT
"RTN","SDLT",59,0)
 I $D(SDPROV) D
"RTN","SDLT",60,0)
 .I $D(SDC),SDPROV>0 S SDPRNM=$P(^VA(200,SDPROV,0),U,1)
"RTN","SDLT",61,0)
 .I $D(SDC),'$D(B),$P($G(^VA(407.5,SDLET,3)),U,1)="Y" W:SDPRNM]"" !?6,"Provider:  "_$G(SDPRNM)
"RTN","SDLT",62,0)
 ; call handler for LAB, XRAY, and EKG tests
"RTN","SDLT",63,0)
 I $D(B) D TST
"RTN","SDLT",64,0)
 I $D(SDLT)&($Y>(IOSL-8)) W @IOF
"RTN","SDLT",65,0)
 ; SD*5.3*622 end changes
"RTN","SDLT",66,0)
 Q
"RTN","SDLT",67,0)
REST ;WRITE THE REMAINDER OF LETTER
"RTN","SDLT",68,0)
 N Z5,I,X
"RTN","SDLT",69,0)
 I SDLET W !?12 K ^UTILITY($J,"W"),DIWL,DIWR,DIWF S DIWL=1,DIWF="C80WN" F Z5=0:0 S Z5=$O(^VA(407.5,SDLET,2,Z5)) Q:Z5'>0  S X=^(Z5,0) D ^DIWP
"RTN","SDLT",70,0)
 D ^DIWW K ^UTILITY($J,"W") Q:'SDFORM
"RTN","SDLT",71,0)
 F I=$Y:1:IOSL-12 W !
"RTN","SDLT",72,0)
 D ADDR Q
"RTN","SDLT",73,0)
ADDR K VAHOW S DFN=+A W !?12,$$FML^DGNFUNC(DFN)
"RTN","SDLT",74,0)
 I $D(^DG(43,1,"BT")),'$P(^("BT"),"^",3) S VAPA("P")=""
"RTN","SDLT",75,0)
 S X1=DT,X2=5 D C^%DTC I '$D(VAPA("P")) S (VATEST("ADD",9),VATEST("ADD",10))=X
"RTN","SDLT",76,0)
 D ADD^VADPT D
"RTN","SDLT",77,0)
 .;CHANGE STATE TO ABBR.
"RTN","SDLT",78,0)
 .N SDIENS,X
"RTN","SDLT",79,0)
 .I $D(VAPA(5)) S SDIENS=+VAPA(5)_",",X=$$GET1^DIQ(5,SDIENS,1),$P(VAPA(5),U,2)=X
"RTN","SDLT",80,0)
 .I $D(VAPA(17)) S SDIENS=+VAPA(17)_",",X=$$GET1^DIQ(5,SDIENS,1),$P(VAPA(17),U,2)=X
"RTN","SDLT",81,0)
 .K SDIENS Q
"RTN","SDLT",82,0)
 N SDCCACT1,SDCCACT2,LL
"RTN","SDLT",83,0)
 S SDCCACT1=VAPA(12),SDCCACT2=$P($G(VAPA(22,2)),"^",3)
"RTN","SDLT",84,0)
 ;if confidential address is not active for scheduling/appointment letters, print to regular address
"RTN","SDLT",85,0)
 I ($G(SDCCACT1)=0)!($G(SDCCACT2)'="Y") D
"RTN","SDLT",86,0)
 .F LL=1:1:3 W:VAPA(LL)]"" !,?12,VAPA(LL)
"RTN","SDLT",87,0)
 .;if country is blank display as USA
"RTN","SDLT",88,0)
 .I (VAPA(25)="")!($P(VAPA(25),"^",2)="UNITED STATES")  D  ;display city,state,zip
"RTN","SDLT",89,0)
 ..W !,?12,VAPA(4)_" "_$P(VAPA(5),U,2)_"  "_$P(VAPA(11),U,2)
"RTN","SDLT",90,0)
 .E  D  ;display postal code,city,province
"RTN","SDLT",91,0)
 ..W !,?12,VAPA(24)_" "_VAPA(4)_" "_VAPA(23)
"RTN","SDLT",92,0)
 .W:($P(VAPA(25),"^",2)'="UNITED STATES") !,?12,$P(VAPA(25),U,2) ;display country
"RTN","SDLT",93,0)
 ;if confidential address is active for scheduling/appointment letters, print to confidential address
"RTN","SDLT",94,0)
 I $G(SDCCACT1)=1,$G(SDCCACT2)="Y" D
"RTN","SDLT",95,0)
 .F LL=13:1:15 W:VAPA(LL)]"" !,?12,VAPA(LL)
"RTN","SDLT",96,0)
 .I (VAPA(28)="")!($P(VAPA(28),"^",2)="UNITED STATES") D
"RTN","SDLT",97,0)
 ..W !,?12,VAPA(16)_" "_$P(VAPA(17),U,2)_"  "_$P(VAPA(18),U,2)
"RTN","SDLT",98,0)
 .E  D
"RTN","SDLT",99,0)
 ..W !,?12,VAPA(27)_" "_VAPA(16)_" "_VAPA(26)
"RTN","SDLT",100,0)
 .W:($P(VAPA(28),"^",2)'="UNITED STATES") !?12,$P(VAPA(28),U,2)
"RTN","SDLT",101,0)
 W ! D KVAR^VADPT Q
"RTN","SDLT",102,0)
 ;
"RTN","SDLT",103,0)
 ;
"RTN","SDLT",104,0)
LAST4(DFN) ;Return patient "last four"
"RTN","SDLT",105,0)
 N SDX
"RTN","SDLT",106,0)
 S SDX=$G(^DPT(+DFN,0))
"RTN","SDLT",107,0)
 Q $E(SDX)_$E($P(SDX,U,9),6,9)
"RTN","SDLT",108,0)
 ;
"RTN","SDLT",109,0)
BADADD ;Print patients with a Bad Address Indicator
"RTN","SDLT",110,0)
 I '$D(^TMP($J,"BADADD")) Q
"RTN","SDLT",111,0)
 N SDHDR,SDHDR1
"RTN","SDLT",112,0)
 W @IOF,$TR($J("",IOM)," ","*")
"RTN","SDLT",113,0)
 S SDHDR="BAD ADDRESS INDICATOR LIST" W !,?(IOM-$L(SDHDR)/2),SDHDR,!
"RTN","SDLT",114,0)
 S SDHDR1="** THE LETTER FOR THESE PATIENT(S) DID NOT PRINT DUE TO A BAD ADDRESS INDICATOR."
"RTN","SDLT",115,0)
 W !,"Last 4",!,"of SSN",?10,"Patient Name",!
"RTN","SDLT",116,0)
 W $TR($J("",IOM)," ","*")
"RTN","SDLT",117,0)
 N SDNAM,SDDFN
"RTN","SDLT",118,0)
 S SDNAM="" F  S SDNAM=$O(^TMP($J,"BADADD",SDNAM)) Q:SDNAM=""  D
"RTN","SDLT",119,0)
 . S SDDFN=0 F  S SDDFN=$O(^TMP($J,"BADADD",SDNAM,SDDFN)) Q:'SDDFN  D
"RTN","SDLT",120,0)
 . . W !,$$LAST4(SDDFN),?10,SDNAM
"RTN","SDLT",121,0)
 W !!,SDHDR1
"RTN","SDLT",122,0)
 Q
"RTN","SDLT",123,0)
 ;
"RTN","SDLT",124,0)
TST ; SD*5.3*622 - handle scheduled tests
"RTN","SDLT",125,0)
 W !
"RTN","SDLT",126,0)
 W:($L(SDCL)=3&($E(SDCL,1,3)="LAB")) ?1,SDCL_" SCHEDULED:  "_DOW_"  "_$J(SDDAT,12)_"  "_$J(SDT0,5)
"RTN","SDLT",127,0)
 W:($L(SDCL)=4&($E(SDCL,1,4)="XRAY")) SDCL_" SCHEDULED:  "_DOW_"  "_$J(SDDAT,12)_"  "_$J(SDT0,5)
"RTN","SDLT",128,0)
 W:($L(SDCL)=3&($E(SDCL,1,3)="EKG")) ?1,SDCL_" SCHEDULED:  "_DOW_"  "_$J(SDDAT,12)_"  "_$J(SDT0,5)
"RTN","SDLT",129,0)
 Q  ; SD*5.3*622 - end of changes
"VER")
8.0^22.2
"BLD",10517,6)
^564
**END**
**END**

