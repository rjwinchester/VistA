Released SD*5.3*674 SEQ #569
Extracted from mail message
**KIDS**:SD*5.3*674^

**INSTALL NAME**
SD*5.3*674
"BLD",10714,0)
SD*5.3*674^SCHEDULING^0^3180413^y
"BLD",10714,1,0)
^^7^7^3170918^^^
"BLD",10714,1,1,0)
This patch addresses the following 2 issues:
"BLD",10714,1,2,0)
 
"BLD",10714,1,3,0)
 1. Clinic availabilities with future start dates display as available 
"BLD",10714,1,4,0)
    prior to the future requested date.
"BLD",10714,1,5,0)
 
"BLD",10714,1,6,0)
 2. The Clinic Utilization & Capacity Data transmissions to Austin
"BLD",10714,1,7,0)
    should no longer be transmitted.
"BLD",10714,4,0)
^9.64PA^^
"BLD",10714,6.3)
18
"BLD",10714,"INID")
^n
"BLD",10714,"INIT")
EN^SD53674P
"BLD",10714,"KRN",0)
^9.67PA^779.2^20
"BLD",10714,"KRN",.4,0)
.4
"BLD",10714,"KRN",.401,0)
.401
"BLD",10714,"KRN",.402,0)
.402
"BLD",10714,"KRN",.403,0)
.403
"BLD",10714,"KRN",.5,0)
.5
"BLD",10714,"KRN",.84,0)
.84
"BLD",10714,"KRN",3.6,0)
3.6
"BLD",10714,"KRN",3.8,0)
3.8
"BLD",10714,"KRN",9.2,0)
9.2
"BLD",10714,"KRN",9.8,0)
9.8
"BLD",10714,"KRN",9.8,"NM",0)
^9.68A^7^7
"BLD",10714,"KRN",9.8,"NM",1,0)
SDAUT1^^0^B7091141
"BLD",10714,"KRN",9.8,"NM",2,0)
SDD0^^0^B23452464
"BLD",10714,"KRN",9.8,"NM",3,0)
SD53674P^^0^B7767783
"BLD",10714,"KRN",9.8,"NM",4,0)
SCRPW74^^0^B45475509
"BLD",10714,"KRN",9.8,"NM",5,0)
SDCLAV1^^0^B60059248
"BLD",10714,"KRN",9.8,"NM",6,0)
SDM0^^0^B100540927
"BLD",10714,"KRN",9.8,"NM",7,0)
SDM1^^0^B57988164
"BLD",10714,"KRN",9.8,"NM","B","SCRPW74",4)

"BLD",10714,"KRN",9.8,"NM","B","SD53674P",3)

"BLD",10714,"KRN",9.8,"NM","B","SDAUT1",1)

"BLD",10714,"KRN",9.8,"NM","B","SDCLAV1",5)

"BLD",10714,"KRN",9.8,"NM","B","SDD0",2)

"BLD",10714,"KRN",9.8,"NM","B","SDM0",6)

"BLD",10714,"KRN",9.8,"NM","B","SDM1",7)

"BLD",10714,"KRN",19,0)
19
"BLD",10714,"KRN",19.1,0)
19.1
"BLD",10714,"KRN",101,0)
101
"BLD",10714,"KRN",409.61,0)
409.61
"BLD",10714,"KRN",771,0)
771
"BLD",10714,"KRN",779.2,0)
779.2
"BLD",10714,"KRN",870,0)
870
"BLD",10714,"KRN",8989.51,0)
8989.51
"BLD",10714,"KRN",8989.52,0)
8989.52
"BLD",10714,"KRN",8994,0)
8994
"BLD",10714,"KRN","B",.4,.4)

"BLD",10714,"KRN","B",.401,.401)

"BLD",10714,"KRN","B",.402,.402)

"BLD",10714,"KRN","B",.403,.403)

"BLD",10714,"KRN","B",.5,.5)

"BLD",10714,"KRN","B",.84,.84)

"BLD",10714,"KRN","B",3.6,3.6)

"BLD",10714,"KRN","B",3.8,3.8)

"BLD",10714,"KRN","B",9.2,9.2)

"BLD",10714,"KRN","B",9.8,9.8)

"BLD",10714,"KRN","B",19,19)

"BLD",10714,"KRN","B",19.1,19.1)

"BLD",10714,"KRN","B",101,101)

"BLD",10714,"KRN","B",409.61,409.61)

"BLD",10714,"KRN","B",771,771)

"BLD",10714,"KRN","B",779.2,779.2)

"BLD",10714,"KRN","B",870,870)

"BLD",10714,"KRN","B",8989.51,8989.51)

"BLD",10714,"KRN","B",8989.52,8989.52)

"BLD",10714,"KRN","B",8994,8994)

"BLD",10714,"QDEF")
^^^^^^^^^^YES
"BLD",10714,"QUES",0)
^9.62^^
"BLD",10714,"REQB",0)
^9.611^8^5
"BLD",10714,"REQB",4,0)
SD*5.3*529^2
"BLD",10714,"REQB",5,0)
SD*5.3*291^2
"BLD",10714,"REQB",6,0)
SD*5.3*509^2
"BLD",10714,"REQB",7,0)
SD*5.3*645^2
"BLD",10714,"REQB",8,0)
SD*5.3*611^2
"BLD",10714,"REQB","B","SD*5.3*291",5)

"BLD",10714,"REQB","B","SD*5.3*509",6)

"BLD",10714,"REQB","B","SD*5.3*529",4)

"BLD",10714,"REQB","B","SD*5.3*611",8)

"BLD",10714,"REQB","B","SD*5.3*645",7)

"INIT")
EN^SD53674P
"MBREQ")
0
"PKG",16,-1)
1^1
"PKG",16,0)
SCHEDULING^SD^APPOINTMENTS,PROFILES,LETTERS,AMIS REPORTS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
5.3^2930813
"PKG",16,22,1,"PAH",1,0)
674^3180413
"PKG",16,22,1,"PAH",1,1,0)
^^7^7^3180413
"PKG",16,22,1,"PAH",1,1,1,0)
This patch addresses the following 2 issues:
"PKG",16,22,1,"PAH",1,1,2,0)
 
"PKG",16,22,1,"PAH",1,1,3,0)
 1. Clinic availabilities with future start dates display as available 
"PKG",16,22,1,"PAH",1,1,4,0)
    prior to the future requested date.
"PKG",16,22,1,"PAH",1,1,5,0)
 
"PKG",16,22,1,"PAH",1,1,6,0)
 2. The Clinic Utilization & Capacity Data transmissions to Austin
"PKG",16,22,1,"PAH",1,1,7,0)
    should no longer be transmitted.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","SCRPW74")
0^4^B45475509^B43863725
"RTN","SCRPW74",1,0)
SCRPW74 ;BP-CIOFO/KEITH,ESW - Clinic appointment availability extract (cont.) ; 6/10/03 9:13am
"RTN","SCRPW74",2,0)
 ;;5.3;Scheduling;**192,206,223,241,249,291,674**;AUG 13, 1993;Build 18
"RTN","SCRPW74",3,0)
 ;
"RTN","SCRPW74",4,0)
MON(SDEX,SDT,SDMON) ;Determine month and date ranges for extracts
"RTN","SCRPW74",5,0)
 ;Input: SDEX=extract type, '1' for prospective, '2' for retrospective
"RTN","SCRPW74",6,0)
 ;Input: SDT=date of extract run
"RTN","SCRPW74",7,0)
 ;Input: SDMON=array to return date information (pass by reference)
"RTN","SCRPW74",8,0)
 ;Output: month/year of extract^begin date of report data
"RTN","SCRPW74",9,0)
 ;Output: SDMON array as follows:
"RTN","SCRPW74",10,0)
 ;        SDMON("SDBDT")=begin date
"RTN","SCRPW74",11,0)
 ;        SDMON("SDDIV")=0
"RTN","SCRPW74",12,0)
 ;        SDMON("SDEDT")=end date
"RTN","SCRPW74",13,0)
 ;        SDMON("SDEX")=extract type ('1' or '2')
"RTN","SCRPW74",14,0)
 ;        SDMON("SDPAST")='1' for extract 2, '0' otherwise
"RTN","SCRPW74",15,0)
 ;        SDMON("SDPBDT")=begin date external value
"RTN","SCRPW74",16,0)
 ;        SDMON("SDPEDT")=end date external value
"RTN","SCRPW74",17,0)
 ;        SDMON("SDRPT")=month/year of extract^begin date of data
"RTN","SCRPW74",18,0)
 ;
"RTN","SCRPW74",19,0)
 N SDPAR,Y,SDX,SDY,X1,X2
"RTN","SCRPW74",20,0)
 S SDMON("SDDIV")=0,SDMON("SDPAST")=$S(SDEX=1:0,1:1)
"RTN","SCRPW74",21,0)
 S SDMON("SDEX")=SDEX,SDPAR=$G(^SD(404.91,1,"PATCH192"))
"RTN","SCRPW74",22,0)
 I SDEX=1 D
"RTN","SCRPW74",23,0)
 .S Y=$S($E(SDT,4,5)=12:$E(SDT,1,3)+1_"0101",1:$E(SDT,1,5)+1_"01")
"RTN","SCRPW74",24,0)
 .S SDMON("SDBDT")=Y X ^DD("DD") S SDMON("SDPBDT")=Y
"RTN","SCRPW74",25,0)
 .S X1=SDMON("SDBDT"),X2=$P(SDPAR,U,2) S:X2<1 X2=180 S X2=X2-1
"RTN","SCRPW74",26,0)
 .D C^%DTC S (SDMON("SDEDT"),Y)=X X ^DD("DD") S SDMON("SDPEDT")=Y
"RTN","SCRPW74",27,0)
 .Q
"RTN","SCRPW74",28,0)
 I SDEX=2 D
"RTN","SCRPW74",29,0)
 .S Y=$S($E(SDT,4,5)="01":$E(SDT,1,3)-1_1201,1:$E(SDT,1,5)-1_"01")
"RTN","SCRPW74",30,0)
 .S SDMON("SDBDT")=Y X ^DD("DD") S SDMON("SDPBDT")=Y
"RTN","SCRPW74",31,0)
 .S X1=SDMON("SDBDT"),X2=$P(SDPAR,U,4) S:X2<1 X2=31 S X2=X2-1
"RTN","SCRPW74",32,0)
 .D C^%DTC I $E(X,1,5)>$E(SDMON("SDBDT"),1,5) D
"RTN","SCRPW74",33,0)
 ..S X1=$E(X,1,5)_"01",X2=-1 D C^%DTC Q
"RTN","SCRPW74",34,0)
 .S (SDMON("SDEDT"),Y)=X X ^DD("DD") S SDMON("SDPEDT")=Y
"RTN","SCRPW74",35,0)
 .Q
"RTN","SCRPW74",36,0)
 S SDY=SDMON("SDBDT")
"RTN","SCRPW74",37,0)
 S:SDEX=2 SDY=$S($E(SDY,4,5)=12:$E(SDY,1,3)+1_"0101",1:$E(SDY,1,5)+1_"01") S SDX=+$E(SDY,4,5)
"RTN","SCRPW74",38,0)
 S SDX=$P("JANUARY^FEBRUARY^MARCH^APRIL^MAY^JUNE^JULY^AUGUST^SEPTEMBER^OCTOBER^NOVEMBER^DECEMBER",U,SDX)
"RTN","SCRPW74",39,0)
 S SDX=SDX_" "_(17+$E(SDY)_$E(SDY,2,3))_U_SDMON("SDBDT")
"RTN","SCRPW74",40,0)
 S SDMON("SDRPT")=SDX
"RTN","SCRPW74",41,0)
 Q SDX
"RTN","SCRPW74",42,0)
 ;
"RTN","SCRPW74",43,0)
QDIS(SDXTMP) ;Display extract queuing information
"RTN","SCRPW74",44,0)
 ;Input: SDXTMP=array of data from ^XTMP("SD53P192")
"RTN","SCRPW74",45,0)
 N SDEX,Y
"RTN","SCRPW74",46,0)
 W !!?18,"*** Extract queuing information on file ***"
"RTN","SCRPW74",47,0)
 I '$D(SDXTMP) W !!,"==> No extract queuing data found" Q
"RTN","SCRPW74",48,0)
 F SDEX=1,2 D
"RTN","SCRPW74",49,0)
 .W !!?22,"Extract ",SDEX," report: ",$P($G(SDXTMP("EXTRACT",SDEX,"REPORT")),U)
"RTN","SCRPW74",50,0)
 .W !?24,"Extract ",SDEX," task: ",$G(SDXTMP("EXTRACT",SDEX,"TASK"))
"RTN","SCRPW74",51,0)
 .S Y=$G(SDXTMP("EXTRACT",SDEX,"DATE")) I Y X ^DD("DD")
"RTN","SCRPW74",52,0)
 .W !?20,"Extract ",SDEX," run date: ",Y
"RTN","SCRPW74",53,0)
 .Q
"RTN","SCRPW74",54,0)
 Q
"RTN","SCRPW74",55,0)
 ;
"RTN","SCRPW74",56,0)
DAYS(SDATE,SDAY) ;Adjust target day if necessary
"RTN","SCRPW74",57,0)
 ;Input: SDATE=date
"RTN","SCRPW74",58,0)
 ;Input: SDAY=target day
"RTN","SCRPW74",59,0)
 ;Output: target SDAY for the month of SDATE, adjusted if necessary
"RTN","SCRPW74",60,0)
 N SDX,X,X1,X2
"RTN","SCRPW74",61,0)
 S X1=$S($E(SDATE,4,5)=12:($E(SDATE,1,3)+1)_"01",1:$E(SDATE,1,5)+1)_"01"
"RTN","SCRPW74",62,0)
 S X2=-1 D C^%DTC S SDX=$E(X,6,7)
"RTN","SCRPW74",63,0)
 Q $S(SDX<SDAY:SDX,1:SDAY)
"RTN","SCRPW74",64,0)
 ;
"RTN","SCRPW74",65,0)
WHEN(SDEX,SDNOW) ;Determine date for next run
"RTN","SCRPW74",66,0)
 ;Input: SDEX=extract type
"RTN","SCRPW74",67,0)
 ;Input: SDDT=date/time to calculate from (optional)
"RTN","SCRPW74",68,0)
 ;Output: if success, date/time for next run
"RTN","SCRPW74",69,0)
 ;        if already scheduled, -1^date_scheduled^task_number
"RTN","SCRPW74",70,0)
 N SDPAR,SDAY,X1,X2,X,SDTIME,SDINT,SDT,SDDT
"RTN","SCRPW74",71,0)
 S SDNOW=$G(SDNOW) I SDNOW<1 S SDNOW=$$NOW^XLFDT()
"RTN","SCRPW74",72,0)
 S SDDT=$P(SDNOW,".")
"RTN","SCRPW74",73,0)
 ;
"RTN","SCRPW74",74,0)
 ;Quit if already scheduled
"RTN","SCRPW74",75,0)
 Q:$G(^XTMP("SD53P192","EXTRACT",SDEX,"DATE"))>SDNOW "-1^"_^XTMP("SD53P192","EXTRACT",SDEX,"DATE")_U_$G(^XTMP("SD53P192","EXTRACT",SDEX,"TASK"))
"RTN","SCRPW74",76,0)
 ;
"RTN","SCRPW74",77,0)
 S SDPAR=$G(^SD(404.91,1,"PATCH192")),SDAY=$P(SDPAR,U) S:'SDAY SDAY=31
"RTN","SCRPW74",78,0)
 S SDINT=$P(SDPAR,U,5) I SDINT=""!("MQSA"'[SDINT) S SDINT="M"
"RTN","SCRPW74",79,0)
 S SDTIME=$P(SDPAR,U,6) I 'SDTIME!(SDTIME>.2359) S SDTIME=.22
"RTN","SCRPW74",80,0)
 S X1=$E(SDDT,1,5)_"01",X2=$$DAYS(SDDT,SDAY)-1 D C^%DTC
"RTN","SCRPW74",81,0)
 I (X+SDTIME)<SDNOW D
"RTN","SCRPW74",82,0)
 .S X1=$S($E(X,4,5)=12:($E(X,1,3)+1)_"01",1:$E(X,1,5)+1)_"01"
"RTN","SCRPW74",83,0)
 .S X2=$$DAYS(X1,SDAY)-1 D C^%DTC
"RTN","SCRPW74",84,0)
 .Q
"RTN","SCRPW74",85,0)
 ;
"RTN","SCRPW74",86,0)
 ;Values for monthly queuing
"RTN","SCRPW74",87,0)
 I SDINT="M" Q:SDEX=1 X+SDTIME  Q $$WHEN2(X)
"RTN","SCRPW74",88,0)
 ;
"RTN","SCRPW74",89,0)
 ;Values for quarterly queuing
"RTN","SCRPW74",90,0)
 I SDINT="Q" D  Q X
"RTN","SCRPW74",91,0)
 .S X1=+$E(X,4,5),X1=$S(X1<4:"03",X1<7:"06",X1<10:"09",1:12)
"RTN","SCRPW74",92,0)
 .S X1=$E(X,1,3)_X1_"01",X2=$$DAYS(X1,SDAY)-1 D C^%DTC
"RTN","SCRPW74",93,0)
 .I SDEX=1 S X=X+SDTIME Q
"RTN","SCRPW74",94,0)
 .S X=$$WHEN2(X) Q
"RTN","SCRPW74",95,0)
 ;
"RTN","SCRPW74",96,0)
 ;Values for semi-annual queuing
"RTN","SCRPW74",97,0)
 I SDINT="S" D  Q X
"RTN","SCRPW74",98,0)
 .S X1=+$E(X,4,5) S:X1>9 X=$E(X,1,3)+1_$E(X,4,7)
"RTN","SCRPW74",99,0)
 .S X1=$S(X1<4:"03",X1<10:"09",1:"03")
"RTN","SCRPW74",100,0)
 .S X1=$E(X,1,3)_X1_"01",X2=$$DAYS(X1,SDAY)-1 D C^%DTC
"RTN","SCRPW74",101,0)
 .I SDEX=1 S X=X+SDTIME Q
"RTN","SCRPW74",102,0)
 .S X=$$WHEN2(X) Q
"RTN","SCRPW74",103,0)
 ;
"RTN","SCRPW74",104,0)
 ;Values for annual queuing
"RTN","SCRPW74",105,0)
 S X1=+$E(X,4,5) S:X1>9 X=$E(X,1,3)+1_$E(X,4,7)
"RTN","SCRPW74",106,0)
 S X=$E(X,1,3)_"0901",X2=$$DAYS(X1,SDAY)-1 D C^%DTC
"RTN","SCRPW74",107,0)
 Q:SDEX=1 X+SDTIME  Q $$WHEN2(X)
"RTN","SCRPW74",108,0)
 ;
"RTN","SCRPW74",109,0)
WHEN2(X) ;Determine date for extract 2
"RTN","SCRPW74",110,0)
 ;Input: X=date for extract 1
"RTN","SCRPW74",111,0)
 ;Output: date/time for extract 2
"RTN","SCRPW74",112,0)
 S SDT=$S($E(X,4,5)=12:$E(X,1,3)+1_"0101",1:$E(X,1,5)+1_"01")
"RTN","SCRPW74",113,0)
 S SDAY=$P(SDPAR,U,3) S:'SDAY!SDAY>31 SDAY=5
"RTN","SCRPW74",114,0)
 S X1=SDT,X2=$$DAYS(SDT,SDAY)-1 D C^%DTC
"RTN","SCRPW74",115,0)
 S X=X+SDTIME Q X
"RTN","SCRPW74",116,0)
 ;
"RTN","SCRPW74",117,0)
SCHED(SDEX,SDT,SDRPT,SDMON,SDKID) ;Schedule repetitive extract run
"RTN","SCRPW74",118,0)
 ;Input: SDEX=extract type
"RTN","SCRPW74",119,0)
 ;Input: SDT=date/time to queue extract
"RTN","SCRPW74",120,0)
 ;Input: SDRPT=month/year of report^begin date of report data
"RTN","SCRPW74",121,0)
 ;Input: SDMON=report parameters from MON^SCRPW74 (pass by reference)
"RTN","SCRPW74",122,0)
 ;Input: SDKID='1' if from KIDS install (optional)
"RTN","SCRPW74",123,0)
 N SDI,Y,ZTSK,ZTRTN,ZTDESC,ZTDTH,ZTIO,ZTSAVE
"RTN","SCRPW74",124,0)
 S ZTDTH=SDT,ZTSAVE("SDMON(")="",ZTRTN="RUN^SCRPW74(1)",ZTIO=""
"RTN","SCRPW74",125,0)
 S ZTDESC="Clinic Appointment Wait Time Extract ("_SDMON("SDEX")_")"
"RTN","SCRPW74",126,0)
 F SDI=1:1:20 D ^%ZTLOAD Q:$G(ZTSK)
"RTN","SCRPW74",127,0)
 ;
"RTN","SCRPW74",128,0)
QQ I '$G(ZTSK) D  Q
"RTN","SCRPW74",129,0)
 .I $G(SDKID) D BMES^XPDUTL("Extract not queued!!!") Q
"RTN","SCRPW74",130,0)
 .W !!,"Extract not queued!!!",! Q
"RTN","SCRPW74",131,0)
 S Y=SDT X ^DD("DD")
"RTN","SCRPW74",132,0)
 I $G(SDKID) D BMES^XPDUTL("Extract "_SDEX_" queued for "_Y_", task number: "_ZTSK)
"RTN","SCRPW74",133,0)
 I '$G(SDKID) W !!,"Extract "_SDEX_" queued for "_Y_", task number: "_ZTSK,!
"RTN","SCRPW74",134,0)
 ;
"RTN","SCRPW74",135,0)
XTMP ;Service ^XTMP nodes
"RTN","SCRPW74",136,0)
 N X1,X2,X
"RTN","SCRPW74",137,0)
 S X1=$P($P(SDT,U),"."),X2=45 D C^%DTC S SDPGDT=X
"RTN","SCRPW74",138,0)
 I '$D(^XTMP("SD53P192",0)) D
"RTN","SCRPW74",139,0)
 .S ^XTMP("SD53P192",0)=SDPGDT_"^Patch SD*5.3*192 'Clinic Wait Time' extract repetitive queuing information.  Created by user: "_DUZ
"RTN","SCRPW74",140,0)
 .Q
"RTN","SCRPW74",141,0)
 S:$P(^XTMP("SD53P192",0),U)<SDPGDT $P(^XTMP("SD53P192",0),U)=SDPGDT
"RTN","SCRPW74",142,0)
 S ^XTMP("SD53P192","EXTRACT",SDEX,"TASK")=ZTSK
"RTN","SCRPW74",143,0)
 S ^XTMP("SD53P192","EXTRACT",SDEX,"DATE")=SDT
"RTN","SCRPW74",144,0)
 S ^XTMP("SD53P192","EXTRACT",SDEX,"REPORT")=SDRPT
"RTN","SCRPW74",145,0)
 Q
"RTN","SCRPW74",146,0)
 ;
"RTN","SCRPW74",147,0)
RUN(SDR) ;Run extract (reschedule if requested)
"RTN","SCRPW74",148,0)
 ;Input: SDR='1' if rescheduling is requested, '0' otherwise.
"RTN","SCRPW74",149,0)
 Q  ;At Request of AITC, patch SD*5.3*674 has discontinued the transmission of this option
"RTN","SCRPW74",150,0)
 N SDV,SDBDT,SDDIV,SDEDT,SDEX,SDPAST,SDPBDT,SDPEDT,SDRPT
"RTN","SCRPW74",151,0)
 S SDV="" F  S SDV=$O(SDMON(SDV)) Q:SDV=""  S @SDV=SDMON(SDV)
"RTN","SCRPW74",152,0)
 I SDR=1 D
"RTN","SCRPW74",153,0)
 .I $G(^XTMP("SD53P192","EXTRACT",SDEX,"TASK"))=ZTSK K ^XTMP("SD53P192","EXTRACT",SDEX)
"RTN","SCRPW74",154,0)
 .N SDT,SDMON
"RTN","SCRPW74",155,0)
 .S SDT=$P(SDRPT,U,2)
"RTN","SCRPW74",156,0)
 .S:SDEX=2 SDT=$S($E(SDT,4,5)=12:$E(SDT,1,3)+1_"0101",1:$E(SDT,1,5)+1_"01")
"RTN","SCRPW74",157,0)
 .S SDT=$$WHEN(SDEX),SDRPT=$$MON(SDEX,SDT,.SDMON)
"RTN","SCRPW74",158,0)
 .D SCHED(SDEX,SDT,SDRPT,.SDMON)
"RTN","SCRPW74",159,0)
 .Q
"RTN","SCRPW74",160,0)
 D EXTRACT^SCRPW72
"RTN","SCRPW74",161,0)
 ;
"RTN","SCRPW74",162,0)
EXIT I $E(IOST)="C",'$G(SDOUT),'$G(SDXM) N DIR S DIR(0)="E" D ^DIR
"RTN","SCRPW74",163,0)
 F SDI="SD","SDS","SDTMP","SDTOT","SDXM","SDNAVA","SDNAVB","SDIP","SDPAT","SDORD","SDIPLST" K ^TMP(SDI,$J)
"RTN","SCRPW74",164,0)
 K ^TMP("SDPAT",+$G(SDJN))
"RTN","SCRPW74",165,0)
 K %,%DT,%H,%I,%T,%Y,CT,D,DA,DAY,DIC,DIE,DIR,DR,DTOUT,DUOUT,ENDATE
"RTN","SCRPW74",166,0)
 K I,J,MAX,MAXDT,SC,SC0,SCNA,SD,SDAY,SDBDT,SDBEG,SDC,SDFLEN,SDREPORT
"RTN","SCRPW74",167,0)
 K SDCAP,SDCCP,SDCNAM,SDCOL,SDCP,SDCT,SDDAY,SDDIV,SDDT,SDDV,SDDW
"RTN","SCRPW74",168,0)
 K SDEDT,SDEND,SDEX,SDEXDT,SDFAC,SDFMT,SDHD,SDI,SDIN,SDINT,SDIV
"RTN","SCRPW74",169,0)
 K SDKID,SDL,SDLINE,SDMAX,SDMD,SDMG,SDMON,SDMPDT,SDNOW,SDOE,SDOE0
"RTN","SCRPW74",170,0)
 K SDOUT,SDP,SDPAGE,SDPAR,SDPAST,SDPATT,SDPBDT,SDPCT,SDPEDT,SDPG
"RTN","SCRPW74",171,0)
 K SDPGDT,SDPNOW,SDQUIT,SDR,SDRE,SDRPT,SDS,SDSC1,SDSC2,SDSIZE,SDSL
"RTN","SCRPW74",172,0)
 K SDSOH,SDSORT,SDSSC,SDSTRTDT,SDT,SDTCAP,SDTIME,SDTIT,SDTITL,SDTOE
"RTN","SCRPW74",173,0)
 K SDTSL,SDTX,SDTY,SDV,SDX,SDXM,SDXTMP,SDY,SDZ,SI,SM,SS,X,X1,X2,Y
"RTN","SCRPW74",174,0)
 K SDJN,SDFMT,SDFMTS
"RTN","SCRPW74",175,0)
 D:$D(IOM) END^SCRPW50 Q
"RTN","SD53674P")
0^3^B7767783^n/a
"RTN","SD53674P",1,0)
SD53674P ;ALB/BJR - Un-schedule and Delete CLW and CLU Transmissions ;9/16/2017 2:06 pm
"RTN","SD53674P",2,0)
 ;;5.3;Scheduling;**674**;Aug 13, 1993;Build 18
"RTN","SD53674P",3,0)
 ; Call to RTN^%ZTLOAD supported by ICR #10063
"RTN","SD53674P",4,0)
 ; Call to DQ^%ZTLOAD supported by ICR #10063
"RTN","SD53674P",5,0)
 ; Call to KILL^%ZTLOAD supported by ICR #10063
"RTN","SD53674P",6,0)
 ; Call to OWNSKEY^XUSRB supported by ICR #3277
"RTN","SD53674P",7,0)
 ; Call to BMES^XPDUTL supported by ICR #10141
"RTN","SD53674P",8,0)
 Q
"RTN","SD53674P",9,0)
EN ;Entry Point for SD*5.3*674 post install routine
"RTN","SD53674P",10,0)
 N SDRTN,SDRTN1,SDRTN2,SDLIST,ZTSK,SDKEY,SDRET
"RTN","SD53674P",11,0)
 S SDKEY="ZTMQ" D OWNSKEY^XUSRB(.SDRET,SDKEY) I '$G(SDRET(0)) D BMES^XPDUTL("The Installer MUST be assigned Security Key 'ZTMQ'.") D  Q
"RTN","SD53674P",12,0)
 .D BMES^XPDUTL("Please add the key to yourself using Allocation of Security Keys [ORLEASE] menu option.")
"RTN","SD53674P",13,0)
 .D BMES^XPDUTL("Then, either re-install the patch, or re-run post install routine EN^SS53674P from the command prompt.")
"RTN","SD53674P",14,0)
 S SDRTN="RUN^SCRPW74(1)",SDRTN1="RUN^SCRPW74(0)",SDRTN2="RUN^SCRPW74"
"RTN","SD53674P",15,0)
 S SDLIST="^TMP(""SDLIST"",$J)"
"RTN","SD53674P",16,0)
 D RTN^%ZTLOAD(SDRTN,SDLIST),RTN^%ZTLOAD(SDRTN1,SDLIST),RTN^%ZTLOAD(SDRTN2,SDLIST)
"RTN","SD53674P",17,0)
 I '$O(^TMP("SDLIST",$J,0)) D BMES^XPDUTL("No Clinic Utilization (CLU) or Clinic Wait Time (CLW) tasks found.") Q
"RTN","SD53674P",18,0)
 S ZTSK=0 F  S ZTSK=$O(^TMP("SDLIST",$J,ZTSK)) Q:'ZTSK  D
"RTN","SD53674P",19,0)
 .D DQ^%ZTLOAD I $G(ZTSK(0)) D BMES^XPDUTL("Task number "_ZTSK_" has been successfully un-scheduled.")
"RTN","SD53674P",20,0)
 .I '$G(ZTSK(0)) D BMES^XPDUTL("Task number "_ZTSK_" could not be un-scheduled. Please use Taskman Management [XUTM MGR] to un-schedule the task.")
"RTN","SD53674P",21,0)
 .D KILL^%ZTLOAD I $G(ZTSK(0)) D BMES^XPDUTL("Task number "_ZTSK_" has been successfully deleted.")
"RTN","SD53674P",22,0)
 .I '$G(ZTSK(0)) D BMES^XPDUTL("Task number "_ZTSK_" could not be deleted. Please use Taskman Management [XUTM MGR] to delete the task.")
"RTN","SD53674P",23,0)
 K ^XTMP("SD53P192","EXTRACT") D BMES^XPDUTL("The global ^XTMP(""SD53P192"",""EXTRACT"") has been deleted.")
"RTN","SD53674P",24,0)
 Q
"RTN","SDAUT1")
0^1^B7091141^B4386633
"RTN","SDAUT1",1,0)
SDAUT1 ;MAN/GRR - AUTO REBOOK SET REQUIRED AVAILABILITY NODES ;28 MAR 84  1:46 pm
"RTN","SDAUT1",2,0)
 ;;5.3;Scheduling;**140,674**;Aug 13, 1993;Build 18
"RTN","SDAUT1",3,0)
 K SDXXX S MAX=$S($D(^SC(SC,"SDP")):$P(^("SDP"),"^",4),1:0)
"RTN","SDAUT1",4,0)
 Q:MAX=0  S STIME=$S($D(^SC(SC,"SDP")):$P(^("SDP"),"^",3),1:"0800"),X1=CDATE,X2=DT D ^%DTC
"RTN","SDAUT1",5,0)
 I X<10 S X1=$S(CDATE<DT:DT,1:CDATE),X2=10 D C^%DTC S SDSTRTDT=X G OVR
"RTN","SDAUT1",6,0)
 S SDSTRTDT=CDATE
"RTN","SDAUT1",7,0)
OVR S SDSOH=$S('$D(^SC(SC,"SL")):0,$P(^("SL"),"^",8)']"":0,1:1)
"RTN","SDAUT1",8,0)
 S X1=SDSTRTDT,X2=MAX D C^%DTC S ENDATE=$S('$D(SDIN):X,SDIN>SDSTRTDT&(SDIN<X):SDIN,1:X),X=SDSTRTDT
"RTN","SDAUT1",9,0)
 N SDX,SDIEN,SDBEG,SDDOW,SDBDT ;New variables for SD*5.3*674 changes
"RTN","SDAUT1",10,0)
 ;Set beginning date to use for indefinite clinic availabilities
"RTN","SDAUT1",11,0)
 S SDX=0 F  S SDX=$O(^SC(SC,"T",SDX)) Q:'SDX  S SDBEG=$G(^SC(SC,"T",SDX,0)) I '$D(^SC(SC,"OST",SDX))!($D(^SC(SC,"T"_$$DOW^XLFDT(SDBEG,1),SDX))) S SDDOW($$DOW^XLFDT(SDBEG,1),SDBEG)="" ;SD*5.3*674
"RTN","SDAUT1",12,0)
 F SDX=0:1:6 S:'$D(SDDOW(SDX)) SDDOW(SDX,9999999)="" ;SD*5.3*674
"RTN","SDAUT1",13,0)
EN1 S:$O(^SC(+SC,"T",0))>X X=$O(^(0)) D DOW S I=Y+32,SM=X,D=Y D WM  ;Change $N to $O, SD*5.3*674
"RTN","SDAUT1",14,0)
 K J F Y=0:1:6 I $D(^SC(+SC,"T"_Y)) S J(Y)="",DA=+SC,DOW=Y D:'$D(^SC(+SC,"T"_Y,0)) TX^SDB1
"RTN","SDAUT1",15,0)
 Q:'$D(J)
"RTN","SDAUT1",16,0)
X1 Q:X>ENDATE  S X1=X\100_28
"RTN","SDAUT1",17,0)
W S X=X\1 I '$D(^SC(+SC,"ST",X,1)) S SDBDT=$O(SDDOW($$DOW^XLFDT(X,1),(X+1)),-1) I X>=($S(SDBDT:SDBDT,1:9999999)) S Y=D#7 G L:'$D(J(Y)),H:$D(^HOLIDAY(X))&('SDSOH) D  ;check beginning date, SD*5.3*674
"RTN","SDAUT1",18,0)
 .S SS=$O(^SC(+SC,"T"_Y,X)) G L:SS="",L:^(SS,1)="" S ^SC(+SC,"ST",X\1,1)=$E($P($T(DAY),U,Y+2),1,2)_" "_$E(X,6,7)_$J("",SI+SI-6)_^(1),^(0)=X\1 ;SD*5.3*674
"RTN","SDAUT1",19,0)
 I $D(SDXXX) S SDXXX=SDXXX+1 W:'(SDXXX#100) "."
"RTN","SDAUT1",20,0)
 D WM:X>SM
"RTN","SDAUT1",21,0)
L I X>ENDATE Q
"RTN","SDAUT1",22,0)
 S X=X+1,D=D+1 G W:X'>X1 S X2=X-X1 D C^%DTC G X1
"RTN","SDAUT1",23,0)
 ;
"RTN","SDAUT1",24,0)
H S ^SC(+SC,"ST",X,1)="   "_$E(X,6,7)_"    "_$P(^(X,0),U,2),^(0)=X S:'$D(^SC(+SC,"ST",0)) ^(0)="^44.005DA^^" G W
"RTN","SDAUT1",25,0)
 ;
"RTN","SDAUT1",26,0)
WM S SM=$S($E(X,4,5)[12:$E(X,1,3)+1_"01",1:$E(X,1,3)_$E(X,4,5)+1)_"00" Q
"RTN","SDAUT1",27,0)
 ;
"RTN","SDAUT1",28,0)
DOW ;
"RTN","SDAUT1",29,0)
 S Y=$$DOW^XLFDT(X,1)
"RTN","SDAUT1",30,0)
 Q
"RTN","SDAUT1",31,0)
 ;
"RTN","SDAUT1",32,0)
DAY ;;^SUN^MON^TUES^WEDNES^THURS^FRI^SATUR
"RTN","SDCLAV1")
0^5^B60059248^B58999426
"RTN","SDCLAV1",1,0)
SDCLAV1 ;ALB/LDB - OUTPUT PATTERNS (cont.) ; 9/1/00 10:57am
"RTN","SDCLAV1",2,0)
 ;;5.3;Scheduling;**140,167,168,76,383,463,490,517,533,509,674**;Aug 13, 1993;Build 18
"RTN","SDCLAV1",3,0)
 ;
"RTN","SDCLAV1",4,0)
 ;PATCH 383 STOPPED REPORT FROM CREATING AVAILIBILTY-TEH
"RTN","SDCLAV1",5,0)
 ;
"RTN","SDCLAV1",6,0)
S2 N I1,SC,SDAV,SDMED,SI,SL,SM,SS,STARTDAY,SDDD,YCNT,SDFRST
"RTN","SDCLAV1",7,0)
 S P=0 F D=0:0 S D=$O(^UTILITY($J,"SDNMS",D)) Q:D'>0!(SDUP)  S SDV="",SDZ2=SDBD F X5=0:0 S SDV=$O(^UTILITY($J,"SDNMS",D,SDV)) Q:SDV=""!SDUP  S SDC=$P(^UTILITY($J,"SDNMS",D,SDV),"^",3) D S ;Q:SDUP  ;D WR ;,SS
"RTN","SDCLAV1",8,0)
 Q
"RTN","SDCLAV1",9,0)
S1 S SD=^SC(SDC,0),D=$S($P(SD,"^",15):$P(SD,"^",15),1:$P(^DG(43,1,"GL"),"^",3)),SD5=0,SDNM=$P(SD,"^")
"RTN","SDCLAV1",10,0)
 S $P(^UTILITY($J,"SDNMS",D,SDNM),"^",3)=SDC Q
"RTN","SDCLAV1",11,0)
S I '$D(^SC(SDC,"SL")) D SDM,HDR W !!,"THIS CLINIC DOES NOT HAVE APPT. LENGTH" Q
"RTN","SDCLAV1",12,0)
 S (SDZ,SDZ2)=SDBD D SDM,HDR,TIME S SDZ=SDBD-1,SD0=0,SDMED=SDED+.9
"RTN","SDCLAV1",13,0)
 N X,SDSOH S SC=+SDC,SL=^SC(SC,"SL"),X=$P(SL,U,3),STARTDAY=$S($L(X):X,1:8),X=$P(SL,U,6),SI=$S(X="":4,X<3:4,X:X,1:4),X=SDBD,SDSOH=$P(SL,"^",8),SM=$S($E(X,4,5)[12:$E(X,1,3)+1_"01",1:$E(X,1,3)_$E(X,4,5)+1)_"00",SDZ=SDBD
"RTN","SDCLAV1",14,0)
 N POP S POP=0  ;SD/517
"RTN","SDCLAV1",15,0)
LOOP D SDM D:0&$E(SDZ,2,5)=$E(SDZ1,2,5) MON I $E(SDZ,2,5)'=$E(SDZ1,2,5) I 'SDUP D X1 I 'SDUP D A I 'SDUP D:SD0!($E(IOST,1,2)="C-") 3 I 'SDUP D WR I 'SDUP,$E(IOST,1,2)="C-" D 3
"RTN","SDCLAV1",16,0)
 D:POP MSG  ;SD/517
"RTN","SDCLAV1",17,0)
 I 'SDUP I X<SDED S (X,SDZ2)=$S($E(X,4,5)=12:$E(X,1,3)+1_"01",1:$E(X,1,5)+1)_"01",SDZ=X D SDM,HDR,TIME G LOOP
"RTN","SDCLAV1",18,0)
 D:POP MSG  ;SD/517
"RTN","SDCLAV1",19,0)
 Q
"RTN","SDCLAV1",20,0)
 ;
"RTN","SDCLAV1",21,0)
MSG ;Added SD/517
"RTN","SDCLAV1",22,0)
 D WARN
"RTN","SDCLAV1",23,0)
 Q
"RTN","SDCLAV1",24,0)
 ;
"RTN","SDCLAV1",25,0)
SS Q:SDUP  S SDZ=SDZ1,SD5=1
"RTN","SDCLAV1",26,0)
 D A Q:SDUP  D 3 Q:SDUP  D WR Q:SDUP  D:$E(IOST,1,2)="C-" 3 Q
"RTN","SDCLAV1",27,0)
MON Q:'$D(^SC(+SDC,"ST",SDZ,1))  S SDPT=^SC(+SDC,"ST",SDZ,1) D SDPT1
"RTN","SDCLAV1",28,0)
 Q
"RTN","SDCLAV1",29,0)
SDPT1 I YCNT+6>IOSL D:$E(IOST,1,2)="C-" 3 Q:SDUP  D HDR,TIME
"RTN","SDCLAV1",30,0)
 W !,SDPT S SDAP=SDZ-1 F Z=1:1 S SDAP=$O(^SC(SDC,"S",SDAP)) Q:SDAP'>0!(SDAP>(SDZ+.9999))!SDUP  D NM^SDCLAV0
"RTN","SDCLAV1",31,0)
 D YCNT
"RTN","SDCLAV1",32,0)
 Q
"RTN","SDCLAV1",33,0)
TIME ;SD/533 $Select defaults to 8 when Z5=0, so a Midnight to 8am clinic
"RTN","SDCLAV1",34,0)
 ;incorrectly prints available hours as 8am to 4pm instead of 0 to 8am
"RTN","SDCLAV1",35,0)
 ;Two new lines added to fix this and linetag T1 added at Write command
"RTN","SDCLAV1",36,0)
 ;S Z5=$P(^SC(+SDC,"SL"),U,3),SDT=$S(Z5:Z5,1:8),Z5=$P(^("SL"),U,6),SDI=$S(Z5="":4,Z5<3:4,Z5:Z5,1:4)
"RTN","SDCLAV1",37,0)
 S Z5=$P(^SC(+SDC,"SL"),U,3) I Z5=0 S SDT=0,Z5=$P(^("SL"),U,6),SDI=$S(Z5="":4,Z5<3:4,Z5:Z5,1:4) G T1
"RTN","SDCLAV1",38,0)
 S SDT=$S(Z5:Z5,1:8),Z5=$P(^SC(+SDC,"SL"),U,6),SDI=$S(Z5="":4,Z5<3:4,Z5:Z5,1:4)
"RTN","SDCLAV1",39,0)
T1 W !!," TIME",?SDI+SDI-1 F Z6=SDT:1:65\(SDI+SDI)+SDT W $E("|"_$S('Z6:0,1:(Z6-1#12+1))_"                 ",1,SDI+SDI)
"RTN","SDCLAV1",40,0)
 W !," DATE",?SDI+SDI-1,"|" K J F Z7=0:1:6 I $D(^SC(+SDC,"T"_Z7)) S J(Z7)=""
"RTN","SDCLAV1",41,0)
 S YCNT=YCNT+3
"RTN","SDCLAV1",42,0)
 F Z8=1:1:65\(SDI+SDI) W $J("|",SDI+SDI)
"RTN","SDCLAV1",43,0)
 Q
"RTN","SDCLAV1",44,0)
WR N X S (Y3,X1,SDC1,SD0)=0,C=SDZ2
"RTN","SDCLAV1",45,0)
 F S8=C:0 S SDC1=SDC1+1,C=$O(^UTILITY($J,"SDNMS",D,SDV,C)) Q:C'>0!(C>SDMED&('SD5))!SDUP  S SD0=1 D:SDC1=1 HDR1 S X=C D DW^%DTC S Y=C X ^DD("DD") S Y1=$P(Y,"@"),Y2=$P(Y,"@",2),X9=X W:Y1'=Y3 !!,?1,X9,?11,Y1 D WR1 Q:SDUP
"RTN","SDCLAV1",46,0)
 Q:SDUP  I 'SD0 D HDR1 W !!,"No appointments scheduled"
"RTN","SDCLAV1",47,0)
 D:SD0 WR2 S SDZ2=SDZ Q  ;SD/517
"RTN","SDCLAV1",48,0)
WR1 S X4="" F X1=0:0 S X4=$O(^UTILITY($J,"SDNMS",D,SDV,C,X4)) Q:X4=""!SDUP  S X6="" F X2=0:0 S X6=$O(^UTILITY($J,"SDNMS",D,SDV,C,X4,X6)) Q:X6=""  D W1
"RTN","SDCLAV1",49,0)
 Q
"RTN","SDCLAV1",50,0)
 ;
"RTN","SDCLAV1",51,0)
WR2 ;Added SD/517
"RTN","SDCLAV1",52,0)
 D 3 W @IOF D HDR1,DAT
"RTN","SDCLAV1",53,0)
 D A1^SDCLAV
"RTN","SDCLAV1",54,0)
 Q
"RTN","SDCLAV1",55,0)
 ;
"RTN","SDCLAV1",56,0)
HDR N X D NOW^%DTC S Y=$E(%,1,12) X ^DD("DD") S YCNT=1 W @IOF,!?52,Y D:$E(IOST,1,2)="P-" PG^SDCLAV
"RTN","SDCLAV1",57,0)
 I $D(^DG(43,1,"GL")),$P(^("GL"),"^",2) W !?30,$P(^DG(40.8,D,0),"^")
"RTN","SDCLAV1",58,0)
 W !?30,SDV,!?30,SDM,"  ",($E(SDZ,1,3)+1700) S YCNT=4 Q
"RTN","SDCLAV1",59,0)
HDR1 S SDZ2=$S(SDZ2=0:SDBD,SDZ2>SDED:SDED,1:SDZ2) W !!,?30,SDV,!,?30,$P(SDM1,"^",+$E(SDZ2,4,5)),"  ",($E(SDZ2,1,3)+1700) S YCNT=YCNT+3 Q
"RTN","SDCLAV1",60,0)
SDM S SDM1="JANUARY^FEBRUARY^MARCH^APRIL^MAY^JUNE^JULY^AUGUST^SEPTEMBER^OCTOBER^NOVEMBER^DECEMBER",SDM=$P(SDM1,"^",+($E(SDZ,4,5))) Q
"RTN","SDCLAV1",61,0)
W S SDUT=^UTILITY($J,"SDNMS",D,SDV,C,X4,X6) S D1="" F D8=2,3 S D1=$S($P(SDUT,"^",D8)]"":$P(SDUT,"^",D8),1:"")_D1
"RTN","SDCLAV1",62,0)
 W D1 Q
"RTN","SDCLAV1",63,0)
W1 ;added next 2 lines and changed 3rd line SD/517
"RTN","SDCLAV1",64,0)
 S X=C X ^DD("FUNC",2,1)  ;SD*509 added DO next line to delete corrupt node
"RTN","SDCLAV1",65,0)
 I +^UTILITY($J,"SDNMS",D,SDV,C,X4,X6)=0 D  Q:X4="UNKNOWN"  S X="**WARNING** "_X D W2 Q
"RTN","SDCLAV1",66,0)
 .Q:X4'="UNKNOWN"
"RTN","SDCLAV1",67,0)
 .S N1=^UTILITY($J,"SDNMS",D,SDV,C,X4,X6),SDC=$P(N1,U,2),SDAP1=$P(N1,U,3)
"RTN","SDCLAV1",68,0)
 .S DA(2)=SDC,DA(1)=C,DA=SDAP1
"RTN","SDCLAV1",69,0)
 .S DIK="^SC("_DA(2)_",""S"","_DA(1)_",1," D ^DIK
"RTN","SDCLAV1",70,0)
 .K DA,DIK,N1
"RTN","SDCLAV1",71,0)
 .Q
"RTN","SDCLAV1",72,0)
 D TAB W:T ?10 W:'T ?11 W X,?20,X4,?51,X6 D MIN W ?61,"("_M1_") MINUTES" D W S Y3=Y1,X1=X9 I YCNT+6>IOSL D 3 Q:SDUP  D HDR1,DAT
"RTN","SDCLAV1",73,0)
 Q
"RTN","SDCLAV1",74,0)
 ;
"RTN","SDCLAV1",75,0)
W2 ;added SD/517
"RTN","SDCLAV1",76,0)
 S POP=1
"RTN","SDCLAV1",77,0)
 D TAB W:T ?1 W:'T ?2 W X,?23,X4,?51,X6 D MIN W ?61,"("_M1_") MINUTES" D W S Y3=Y1,X1=X9 I YCNT+6>IOSL D 3 Q:SDUP  D HDR1,DAT
"RTN","SDCLAV1",78,0)
 Q
"RTN","SDCLAV1",79,0)
WARN ;added SD/517
"RTN","SDCLAV1",80,0)
 W @IOF,! D:$E(IOST,1,2)="P-" PG^SDCLAV
"RTN","SDCLAV1",81,0)
 D HDR1,DAT
"RTN","SDCLAV1",82,0)
 W !!,"*************************************************************************"
"RTN","SDCLAV1",83,0)
 W !,"* WARNING: There is a data inconsistency or data corruption problem      *"
"RTN","SDCLAV1",84,0)
 W !,"* with one or more of the above appointments.  These appointments will   *"
"RTN","SDCLAV1",85,0)
 W !,"* have WARNING displayed to the left of the time.  Corrective action     *"
"RTN","SDCLAV1",86,0)
 W !,"* needs to be taken.  Please cancel any of the appointments above, which *"
"RTN","SDCLAV1",87,0)
 W !,"* have the WARNING display.  If any of them are valid appointments, they *"
"RTN","SDCLAV1",88,0)
 W !,"* will have to be re-entered via Appointment Management.                 *"
"RTN","SDCLAV1",89,0)
 W !,"**************************************************************************"
"RTN","SDCLAV1",90,0)
 D 3
"RTN","SDCLAV1",91,0)
 S POP=0
"RTN","SDCLAV1",92,0)
 Q
"RTN","SDCLAV1",93,0)
 ;
"RTN","SDCLAV1",94,0)
3 N X I $E(IOST,1,2)="C-" F X=$Y:1:IOSL-6 W ! D YCNT
"RTN","SDCLAV1",95,0)
 I  R !!,"PRESS RETURN TO CONTINUE OR ^ TO QUIT  ",SDU:DTIME S:SDU="^"!('$T) SDUP=1
"RTN","SDCLAV1",96,0)
 I YCNT+6'<IOSL,'SDUP W @IOF,! S YCNT=1 D:$E(IOST,1,2)="P-" PG^SDCLAV Q
"RTN","SDCLAV1",97,0)
 Q
"RTN","SDCLAV1",98,0)
A N X D:YCNT+13>IOSL 3 Q:SDUP  D INAC^SDCLAV W !!!,"FOR CLINIC AVAILABILITY PATTERNS:"
"RTN","SDCLAV1",99,0)
 W !!?4,"0-9 and j-z",?15," --denote available slots where j=10,k=11...z=26",!?12,"A-W",?15," --denote overbooks with A being the first slot to be overbooked",!?18,"and B being the second for that same time, etc."
"RTN","SDCLAV1",100,0)
 W !?6,"*,$,!,@,#",?15," --denote overbooks or appts. that fall outside of a clinic's",!?18,"regular hours" S YCNT=YCNT+8 Q
"RTN","SDCLAV1",101,0)
TAB W ! S:$L(X)>7 T=1 S:$L(X)<8 T=0 D YCNT Q
"RTN","SDCLAV1",102,0)
MIN S M1=+^UTILITY($J,"SDNMS",D,SDV,C,X4,X6) Q
"RTN","SDCLAV1",103,0)
DAT I $E($O(^UTILITY($J,"SDNMS",D,SDV,C)),2,7)=$E(C,2,7) W !,?1,X1,?11,Y1 D YCNT
"RTN","SDCLAV1",104,0)
 Q
"RTN","SDCLAV1",105,0)
X1 S X1=X\100_$P("31^28^31^30^31^30^31^31^30^31^30^31",U,$E(X,4,5))
"RTN","SDCLAV1",106,0)
 S X1=$$LEAP(X1) I X1>SDED S X1=SDED
"RTN","SDCLAV1",107,0)
 S SDMED=X1+.9,SDAP=X-.01 F  S SDAP=$O(^SC(SDC,"S",SDAP)) Q:SDAP'>0!(SDAP>(X1+.9999))!SDUP  D NM^SDCLAV0
"RTN","SDCLAV1",108,0)
 D DOW S SDDD=Y
"RTN","SDCLAV1",109,0)
WW ;
"RTN","SDCLAV1",110,0)
 I '$D(^SC(+SC,"ST",X,1)),$$CHKDT() S Y=SDDD#7 G L:'$D(J(Y)),H:$D(^HOLIDAY(X))&('SDSOH) S SS=+$O(^SC(+SC,"T"_Y,X)) G L:SS'>0,L:^(SS,1)="" D
"RTN","SDCLAV1",111,0)
 .S ^SC(+SC,"ST",$P(X,"."),1)=$E($P($T(DAY),U,Y+2),1,2)_" "_$E(X,6,7)_$J("",SI+SI-6)_^(1),^(0)=$P(X,".")
"RTN","SDCLAV1",112,0)
 ;SD*5.3*490 added GOTO command so dates prior to clinic start date no
"RTN","SDCLAV1",113,0)
 ;longer display on grid
"RTN","SDCLAV1",114,0)
 S SDAV=1 D:X>SM WM I $D(^SC(+SC,"ST",X,1)),^(1)["["!(^(1)["CANCELLED")!($D(^HOLIDAY(X))) G:X<$O(^SC(+SC,"T",0)) L W !,$E(^SC(+SC,"ST",X,1),1,80) D YCNT S:'$D(^HOLIDAY(X))&('SDAV) SDAV=1
"RTN","SDCLAV1",115,0)
 I YCNT+6>IOSL D 3 Q:SDUP  D HDR
"RTN","SDCLAV1",116,0)
L S X=X+1,SDDD=SDDD+1
"RTN","SDCLAV1",117,0)
 G WW:X'>X1 Q
"RTN","SDCLAV1",118,0)
 ;
"RTN","SDCLAV1",119,0)
WM W !?36 S Y=$E(X,1,5)_"00",SM=$S($E(X,4,5)[12:$E(X,1,3)+1_"01",1:$E(X,1,3)_$E(X,4,5)+1)_"00" D YCNT
"RTN","SDCLAV1",120,0)
DT W $$FMTE^XLFDT(Y) Q
"RTN","SDCLAV1",121,0)
 ;
"RTN","SDCLAV1",122,0)
DOW S Y=$$DOW^XLFDT(X,1) Q
"RTN","SDCLAV1",123,0)
YCNT S YCNT=YCNT+1 Q
"RTN","SDCLAV1",124,0)
 ;
"RTN","SDCLAV1",125,0)
DAY ;;^SUN^MON^TUES^WEDNES^THURS^FRI^SATUR
"RTN","SDCLAV1",126,0)
DIFF S X1=SDRE,X2=X D ^%DTC S SDDD=SDDD+X,X=SDRE,X1=X\100_28 Q
"RTN","SDCLAV1",127,0)
H S ^SC(+SC,"ST",X,1)="   "_$E(X,6,7)_"    "_$P(^(X,0),U,2),^(0)=X G WW
"RTN","SDCLAV1",128,0)
 ;
"RTN","SDCLAV1",129,0)
LEAP(SDEOM) ;Check for leap year, adjust if indicated
"RTN","SDCLAV1",130,0)
 ;Input: SDEOM=end of month date to adjust for leap year
"RTN","SDCLAV1",131,0)
 Q:$E(SDEOM,4,5)'="02" SDEOM  ; only adjust February
"RTN","SDCLAV1",132,0)
 N SDLEAP
"RTN","SDCLAV1",133,0)
 S SDLEAP=$$FMADD^XLFDT(SDEOM,1)
"RTN","SDCLAV1",134,0)
 Q $S($E(SDLEAP,4,5)="02":SDLEAP,1:SDEOM)
"RTN","SDCLAV1",135,0)
CHKDT() ;
"RTN","SDCLAV1",136,0)
 N Y,RET,SDFA
"RTN","SDCLAV1",137,0)
 I '$D(SDFRST(D,+SC)) D
"RTN","SDCLAV1",138,0)
 .; Create array of days that have a current template.
"RTN","SDCLAV1",139,0)
 .N %H,X,SDFMTDAY,SDAYCNT,SDAYI,SDST,SDAYCHK,SDAYNAM,SDAYNUM
"RTN","SDCLAV1",140,0)
 .S %H=$H
"RTN","SDCLAV1",141,0)
 .D YX^%DTC S SDFMTDAY=X
"RTN","SDCLAV1",142,0)
 .S SDAYCNT=0
"RTN","SDCLAV1",143,0)
 .F SDAYI=0:1:6 D
"RTN","SDCLAV1",144,0)
 ..Q:'$D(^SC(+SC,"T"_SDAYI))
"RTN","SDCLAV1",145,0)
 ..I $O(^SC(+SC,"T"_SDAYI,""),-1)'<SDFMTDAY S SDFRST(D,+SC,SDAYI)="",SDAYCNT=SDAYCNT+1
"RTN","SDCLAV1",146,0)
 .; Calculate first available date for each day that has current template.
"RTN","SDCLAV1",147,0)
 .S SDST=0,SDAYCHK=0
"RTN","SDCLAV1",148,0)
 .F  S SDST=$O(^SC(+SC,"ST",SDST)) Q:SDST=""!(SDAYCHK=SDAYCNT)  D
"RTN","SDCLAV1",149,0)
 ..S SDAYNAM=$E($G(^SC(+SC,"ST",SDST,1)),1,2)
"RTN","SDCLAV1",150,0)
 ..S SDAYNUM=$S(SDAYNAM="MO":1,SDAYNAM="TU":2,SDAYNAM="WE":3,SDAYNAM="TH":4,SDAYNAM="FR":5,SDAYNAM="SA":6,SDAYNAM="SU":0,1:"")
"RTN","SDCLAV1",151,0)
 ..Q:SDAYNUM=""
"RTN","SDCLAV1",152,0)
 ..Q:$G(SDFRST(D,+SC,SDAYNUM))'=""
"RTN","SDCLAV1",153,0)
 ..Q:'$D(^SC(+SC,"T"_SDAYNUM))
"RTN","SDCLAV1",154,0)
 ..Q:$D(^SC(+SC,"OST",SDST))  ;Quit if non-indefinite schedule, SD*5.3*674
"RTN","SDCLAV1",155,0)
 ..S SDFRST(D,+SC,SDAYNUM)=SDST,SDAYCHK=SDAYCHK+1
"RTN","SDCLAV1",156,0)
 ; Get first avail date from array for particular day of week
"RTN","SDCLAV1",157,0)
 S Y=SDDD#7,RET=0
"RTN","SDCLAV1",158,0)
 S SDFA=$G(SDFRST(D,+SC,Y))
"RTN","SDCLAV1",159,0)
 I SDFA'="" D
"RTN","SDCLAV1",160,0)
 .S SDFA=$S(+$H>SDFA:+$H,1:SDFA)
"RTN","SDCLAV1",161,0)
 .I X'<SDFA S RET=1
"RTN","SDCLAV1",162,0)
 Q RET
"RTN","SDD0")
0^2^B23452464^B19483727
"RTN","SDD0",1,0)
SDD0 ;SF/GFT,ALB/BOK,JSH,LDB - REMAP A CLINIC ;26 JAN 84  3:00 pm
"RTN","SDD0",2,0)
 ;;5.3;Scheduling;**167,401,529,674**;Aug 13, 1993;Build 18
"RTN","SDD0",3,0)
SETX ;
"RTN","SDD0",4,0)
 N SDDIV
"RTN","SDD0",5,0)
 S SDDIV=$P($G(SD0),"^",15) Q:SDDIV=""
"RTN","SDD0",6,0)
 I '$D(VAUTD(SDDIV)),VAUTD=0 Q
"RTN","SDD0",7,0)
 Q:'$D(^SC(SC,"SL"))  S SDSL=^("SL"),SL=+^("SL"),X=$P(SDSL,U,3),STARTDAY=$S($L(X):X,1:8),X=$P(SDSL,U,6),HSI=$S('X:4,X<3:8/X,1:2),SI=$S(X:X,1:4),SDSI=SI
"RTN","SDD0",8,0)
 S:SI=1 SI=4 S:SI=2 SI=4 S SDSOH=$S($P(SDSL,U,8)']"":0,1:1)
"RTN","SDD0",9,0)
 K SDIN,SDRE,SDRE1 N SDNODE I $D(^SC(SC,"I")) S SDIN=+^("I"),SDRE=+$P(^("I"),"^",2),Y=SDRE D DTS^SDUTL S SDRE1=Y
"RTN","SDD0",10,0)
 N SDX,SDIEN,SDBEG,SDDOW ;New variables for SD*5.3*674 changes
"RTN","SDD0",11,0)
 ;Set beginning date to use for indefinite clinic availabilities
"RTN","SDD0",12,0)
 F SDX=0:1:6 S SDDOW(SDX,9999999)="" ;SD*5.3*674
"RTN","SDD0",13,0)
 S SDX=0 F  S SDX=$O(^SC(SC,"T",SDX)) Q:'SDX!(SDX>ENDDATE)  I '$D(^SC(SC,"OST",SDX)) S SDBEG=$G(^SC(SC,"T",SDX,0)) S SDDOW($$DOW^XLFDT(SDBEG,1),SDBEG)="" ;SD*5.3*674
"RTN","SDD0",14,0)
 F DATE=$$FMADD^XLFDT(SDBD,-1):0 S X1=DATE,X2=1 N X D C^%DTC S DATE=X S SDNODE=$D(^SC(SC,"ST",DATE)) Q:DATE'>0!(DATE>SDED)  I $S('$D(SDIN):1,'SDIN:1,SDIN>DATE:1,SDRE'>DATE&(SDRE):1,1:0) K SM,SDHOL D CHECK  ;changed 1st part of For loop SD*529
"RTN","SDD0",15,0)
 Q
"RTN","SDD0",16,0)
CHECK S X=DATE D DW^%DTC S DAY=$P("SUN^MON^TUES^WEDNES^THURS^FRI^SATUR",U,Y+1),DOW=Y
"RTN","SDD0",17,0)
 D APPT I $D(^SC(SC,"ST",DATE,1)),^(1)'[$E(DAY,1,2)&(^(1)["]") S MSG="Bogus clinic day"_$S(SDAPPT:"- Appts!",1:"") D PRNT
"RTN","SDD0",18,0)
 I $D(^SC(SC,"ST",DATE,1)),^(1)["CANCEL"!($E(^(1),$F(^(1),"["),999)?."X") S MSG="Cancelled" D PRNT Q
"RTN","SDD0",19,0)
 I $D(^HOLIDAY(DATE,0)),'SDSOH S SDHOL=1,X=$P(^(0),U,2) G HOLIDAY:'SDAPPT,Z:SDAPPT
"RTN","SDD0",20,0)
 K ^SC(SC,"ST",DATE) S SS=+$O(^SC(SC,"T"_DOW,DATE)),SB=STARTDAY-1/100,STR="{}&%?#@!$* XXWVUTSRQPONMLKJIHGFEDCBA0123456789jklmnopqrstuvwxyz"
"RTN","SDD0",21,0)
 I $D(^SC(SC,"OST",DATE,1)),^(1)]"" S (X,DR)=DATE D DOW^SDM0 S DOW=Y,SM=^SC(SC,"OST",DATE,1),SS=0 G:'SDAPPT OVR G I
"RTN","SDD0",22,0)
 G Z:'$D(^SC(SC,"T"_DOW,SS,1)) I ^(1)="" S MSG="no master pattern for this day" D:SDNODE PRNT Q
"RTN","SDD0",23,0)
 S DH=^(1),X=DATE G FIX ;NAKED REFERENCE ^SC(IFN,"T"_DOW,DATE,1)
"RTN","SDD0",24,0)
HOLIDAY S ^SC(SC,"ST",DATE,1)="   "_$E(DATE,6,7)_"    "_X,^(0)=DATE
"RTN","SDD0",25,0)
Z S MSG=$S($D(SDHOL)&SDAPPT:"- Appts!",'SDSOH&$D(SDHOL):"- Inserted",1:"") I MSG]"" S MSG=X_MSG D PRNT
"RTN","SDD0",26,0)
 Q
"RTN","SDD0",27,0)
END K %,%DT,DATE,DAY,DH,DOW,DR,DR1,HSI,I,P,POP,S,SB,SC,SDAPPT,SDAPPT1,SDBD,SDNM,SDED,SDHOL,SD0,SDIN,SDRE,SDRE1,SDSAVX,SDSL,SDSOH,SI,SM,SS,SD,SCI,SCC,ST,STARTDAY,STR,X,MSG,Y,YP,PG,DGVAR,DGPGM,VAUTD,VAUTC,SDU,BEGDATE,ENDDATE D CLOSE^DGUTQ Q
"RTN","SDD0",28,0)
FIX ;DH=PATTERN  X=DATE
"RTN","SDD0",29,0)
 D SM G:'SDAPPT OVR
"RTN","SDD0",30,0)
I S I=DR#1-SB*100,I=I#1*SI\.6+(I\1*SI)*2,S=$E(SM,I,999),SM=$E(SM,1,I-1)
"RTN","SDD0",31,0)
 I $D(^SC(SC,"S",DR,"MES")) D CAN S X=SDSAVX K SDSAVX S DR=+$O(^SC(SC,"S",DR)) G:DR\1=X I G OVR
"RTN","SDD0",32,0)
 F Y=0:0 S Y=$O(^SC(SC,"S",DR,1,Y)) Q:Y'>0  I $P(^(Y,0),"^",9)'["C" S SDSL=$P(^(0),U,2)/SL*(SL\(60/SDSI))*HSI-HSI F I=0:HSI:SDSL S ST=$E(S,I+2) S:ST="" ST=" " S S=$E(S,1,I+2-1)_$E(STR,$F(STR,ST)-2)_$E(S,I+3,999)
"RTN","SDD0",33,0)
 S SM=SM_S,DR=$O(^SC(SC,"S",DR)) I DR\1=X G I
"RTN","SDD0",34,0)
OVR I $L(SM)>SM,(X>=$O(SDDOW($$DOW^XLFDT(X,1),(X+1)),-1)&($O(SDDOW($$DOW^XLFDT(X,1),(X+1)),-1)))!($D(^SC(SC,"OST",X))) S ^SC(SC,"ST",X,0)=X,^(1)=SM S:SS'>0 ^(9)=SC ;Verify indefinite schedule after start date, SD*5.3*674
"RTN","SDD0",35,0)
 G Z
"RTN","SDD0",36,0)
SM S SM=$P("SU^MO^TU^WE^TH^FR^SA",U,DOW+1)_" "_$E(X,6,7)_$J("",SI+SI-6)_DH_$J("",64-$L(DH)) Q
"RTN","SDD0",37,0)
APPT S DR=+$O(^SC(SC,"S",DATE)),SDAPPT=0 I DR>(DATE_.9) S DR=DATE Q
"RTN","SDD0",38,0)
 F DR1=DATE:0 S DR1=$O(^SC(SC,"S",DR1)) Q:DR1'>0!(DR1>(DATE+1))!(SDAPPT)  S:$D(^(DR1,"MES")) SDAPPT=1 F SDAPPT1=0:0 S SDAPPT1=$O(^SC(SC,"S",DR1,1,SDAPPT1)) Q:SDAPPT1'>0  I $D(^(SDAPPT1,0)) S SDAPPT=$S($P(^(0),"^",9)="C":0,1:1)
"RTN","SDD0",39,0)
 Q
"RTN","SDD0",40,0)
CAN S SDSAVX=X Q:'$D(^SC(SC,"SDCAN",DR,0))  S X=$E($P(DR,".",2)_"0000",1,4),I=SM_S D TT S ST=%,X=$P(^SC(SC,"SDCAN",DR,0),"^",2) D TT S I=I_$J("",%-$L(I)),Y=""
"RTN","SDD0",41,0)
 F X=0:2:% S S=$E(I,X+SI+SI),P=$S(X<ST:S_$E(I,X+1+SI+SI),X=%:$S(Y="[":Y,1:S)_$E(I,X+1+SI+SI),1:$S(Y="["&(X=ST):"]",1:"X")_"X"),Y=$S(S="]":"",S="[":S,1:Y),I=$E(I,1,X-1+SI+SI)_P_$E(I,X+2+SI+SI,999)
"RTN","SDD0",42,0)
 S SM=I Q
"RTN","SDD0",43,0)
TT S %=$E(X,3,4),%=X\100-STARTDAY*SI+(%*SI\60)*2 Q
"RTN","SDD0",44,0)
PRNT U IO S YP=YP+1 D:YP>(IOSL-4) ESC^SDD W !,$E(SDNM,1,25),?27,$E(DAY,1,3)_" " S Y=DATE D DT^DIO2 W ?45,MSG Q
"RTN","SDD0",45,0)
ESC S SDU=0 I $E(IOST,1,2)="C-" W *7 R ESC:DTIME S:U=ESC SDU=1
"RTN","SDM0")
0^6^B100540927^B93886442
"RTN","SDM0",1,0)
SDM0 ;SF/GFT - MAKE APPOINTMENT ;1/5/16 12:26pm
"RTN","SDM0",2,0)
 ;;5.3;Scheduling;**140,167,206,186,223,237,241,384,334,547,621,622,645,674**;Aug 13, 1993;Build 18
"RTN","SDM0",3,0)
 I $D(SDXXX) S SDOK=1 Q
"RTN","SDM0",4,0)
 N SDSRTY,SDDATE,SDSDATE,SDDATE2,SDSRFU,SDDMAX,SDONCE
"RTN","SDM0",5,0)
 ;Prompt for scheduling request type
"RTN","SDM0",6,0)
M N SDHX,SDXF,SDXD
"RTN","SDM0",7,0)
 Q:'$$SRTY(.SDSRTY)  S:SDSRTY SDDATE=DT
"RTN","SDM0",8,0)
 ; SD*5.3*622 - let user see desired date
"RTN","SDM0",9,0)
 ; SD*5.3*645 - replaced DESIRED DATE with CID/PREFERRED DATE
"RTN","SDM0",10,0)
 I $D(SDDATE) S Y=SDDATE,SDDATE2=$$FMTE^XLFDT(Y) W !!,"APPOINTMENT CID/PREFERRED DATE:  "_SDDATE2 W ! H 3
"RTN","SDM0",11,0)
 ;Calculate appointment follow-up indicator
"RTN","SDM0",12,0)
 S SDSRFU=$$PTFU(DFN,SC)
"RTN","SDM0",13,0)
 ;Determine maximum days for scheduling
"RTN","SDM0",14,0)
 S SDMAX(1)=$P($G(^SC(+SC,"SDP")),U,2) S:'SDMAX(1) SDMAX(1)=365
"RTN","SDM0",15,0)
 S (SDMAX,SDDMAX)=$$FMADD^XLFDT(DT,SDMAX(1))
"RTN","SDM0",16,0)
 ;Prompt for desired date
"RTN","SDM0",17,0)
 Q:'$$DDATE(.SDDATE,SDSRTY,.SDMAX)
"RTN","SDM0",18,0)
 ;If date and time, schedule appt. directly
"RTN","SDM0",19,0)
 W ! I SDDATE#1 S SDSDATE=SDDATE,SDDATE=SDDATE\1 G ^SDM1
"RTN","SDM0",20,0)
 S (X,Y)=SDDATE K SDHX
"RTN","SDM0",21,0)
 ;Find first available after specified date
"RTN","SDM0",22,0)
 I X="F"!(X="f") D SUP,DT1 G NEXT
"RTN","SDM0",23,0)
 ;Find next available appointment
"RTN","SDM0",24,0)
 I SDSRTY,SDDATE D SUP S SDSTRTDT=SDDATE D OVR^SDMULT0 G NEXT
"RTN","SDM0",25,0)
 ;
"RTN","SDM0",26,0)
EN S:$L(X)=1 X=$TR(X,"tnN","TTT") S:X="NOW" X="T" I X?.A!(+X=X),X<13,X'?1"T".E S X=X_" 1"
"RTN","SDM0",27,0)
 D  Q:Y<1
"RTN","SDM0",28,0)
 .N %DT
"RTN","SDM0",29,0)
 .S %DT="T" D ^%DT
"RTN","SDM0",30,0)
 .I Y<1 W !!,"Unable to evaluate date value """_X_""".",!
"RTN","SDM0",31,0)
 .Q
"RTN","SDM0",32,0)
 S:$S($D(DUZ)'[0:1,1:0) ^DISV(DUZ_U_+SC)=Y
"RTN","SDM0",33,0)
DISP S IOF=$S('$D(IOF):"!#",IOF']"":"!#",1:IOF) W @IOF S SDSOH=$S('$D(^SC(+SC,"SL")):0,$P(^("SL"),"^",8)']"":0,1:1),SDAV=0
"RTN","SDM0",34,0)
 I $D(SDINA),Y'<SDINA,SDRE>Y!('SDRE) S SDHY=Y,Y=SDINA D DTS^SDUTL W !,*7,"Clinic is inactive ",$S(SDRE:"from ",1:"as of "),Y S Y=SDRE D:Y DTS^SDUTL W $S(SDRE:" to "_Y,1:"") S Y=SDHY K SDHY D PAUSE^VALM1 Q:'SDRE
"RTN","SDM0",35,0)
 S:Y#100=0 Y=Y+1 S X=Y D D:$E(X,4,5) S (SDX,X1)=X,X2=1 D C^%DTC S X=SDX K SDX G:SDAV ^SDM1 Q
"RTN","SDM0",36,0)
 ;
"RTN","SDM0",37,0)
NEXT D SET I $S('$D(FND):1,'FND:1,1:0) D  G EN
"RTN","SDM0",38,0)
 .K ^DISV($S($D(DUZ)'[0:DUZ,1:0)_U_+SC)
"RTN","SDM0",39,0)
 .I '$O(^SC(+SC,"ST",SDDATE-1)) S (X,Y)=SDDATE Q
"RTN","SDM0",40,0)
 .W $C(7),!?6,"No open slots found in the date range "
"RTN","SDM0",41,0)
 .W $$FMTE^XLFDT(SDDATE)," to ",$$FMTE^XLFDT(SDDMAX),"!",!
"RTN","SDM0",42,0)
 .H 3 S (X,Y)=SDDATE
"RTN","SDM0",43,0)
 .Q
"RTN","SDM0",44,0)
 S (X,Y)=SDAPP K SDXXX G DISP
"RTN","SDM0",45,0)
 ; SD*5.3*622 - display clinic name all the time
"RTN","SDM0",46,0)
D W #!?36,$P(^SC(+SC,0),U,1) S:$O(^SC(+SC,"T",0))>X X=+$O(^(0)) D DOW S I=Y+32,D=Y S SDXF=0 D WM I SDXF D WMH
"RTN","SDM0",47,0)
X1 S X1=X\100_$P("31^28^31^30^31^30^31^31^30^31^30^31",U,+$E(X,4,5)) ;28
"RTN","SDM0",48,0)
 ;SD*5.3*547 next line don't allow past dates to be added to pattern if prior to date DOW was added
"RTN","SDM0",49,0)
W I '$D(^SC(+SC,"ST",X,1)) S DWFLG=1,POP=0,XDT=X D DOWCHK K DWFLG,XDT G L:POP
"RTN","SDM0",50,0)
 ;Add date start date check - SD*5.3*674
"RTN","SDM0",51,0)
 I '$D(^SC(+SC,"ST",X,1)) S Y=D#7 G L:'$D(J(Y)),H:$D(^HOLIDAY(X))&('SDSOH) I '$$BEGDAT(X,Y) S SS=+$O(^SC(+SC,"T"_Y,X)) G L:SS'>0,L:^(SS,1)="" S ^SC(+SC,"ST",$P(X,"."),1)=$E($P($T(DAY),U,Y+2),1,2)_" "_$E(X,6,7)_$J("",SI+SI-6)_^(1),^(0)=$P(X,".")
"RTN","SDM0",52,0)
 S SDHX=X,SDAV=1 D:X>SM WM I SDXF<2 D WMH
"RTN","SDM0",53,0)
 I $D(^SC(+SC,"ST",X,1)),^(1)["["!(^(1)["CANCELLED")!($D(^HOLIDAY(X))) W !,$E(^SC(+SC,"ST",X,1),1,80) S:'$D(^HOLIDAY(X))&('SDAV) SDAV=1
"RTN","SDM0",54,0)
 I $Y>18 W ! Q
"RTN","SDM0",55,0)
L K POP
"RTN","SDM0",56,0)
 S X=X+1,D=D+1
"RTN","SDM0",57,0)
 I $D(SDINA),X>SDINA,SDRE>X!('SDRE) D:'SDAV NOAV S SDHY=Y,Y=SDINA D DTS^SDUTL W !,*7,?8,"Clinic is inactive ",$S(SDRE:"from ",1:"as of "),Y S Y=SDRE D:Y DTS^SDUTL W $S(SDRE:" to "_Y,1:"") S Y=SDHY K SDHY Q:'SDRE  D DIFF
"RTN","SDM0",58,0)
 G W:X'>X1 S X2=X-X1 D C^%DTC
"RTN","SDM0",59,0)
 I $D(SDINA),X>SDINA,SDRE>X!('SDRE) D:'SDAV NOAV S SDHY=Y,Y=SDINA D DTS^SDUTL W !,*7,?8,"Clinic is inactive ",$S(SDRE:"from ",1:"as of "),Y S Y=SDRE D:Y DTS^SDUTL W $S(SDRE:" to "_Y,1:"") S Y=SDHY K SDHY Q:'SDRE
"RTN","SDM0",60,0)
 G X1:D<I W ! D:'SDAV MNTH Q
"RTN","SDM0",61,0)
 ;
"RTN","SDM0",62,0)
NOAV W !,"No availability found between date chosen and inactivate date!" Q
"RTN","SDM0",63,0)
H S ^SC(+SC,"ST",X,1)="   "_$E(X,6,7)_"    "_$P(^(X,0),U,2),^(0)=X G W
"RTN","SDM0",64,0)
 ;
"RTN","SDM0",65,0)
WM W !?36 S Y=$E(X,1,5)_"00",SM=$S($E(X,4,5)[12:$E(X,1,3)+1_"01",1:$E(X,1,3)_$E(X,4,5)+1)_"00"
"RTN","SDM0",66,0)
 S SDXF=SDXF+1 I $E(X,6,7)>20 D
"RTN","SDM0",67,0)
 . S SDXD=$O(^SC(+SC,"ST",X-1)) Q:SDXD=""
"RTN","SDM0",68,0)
 . I $E(SDXD,4,5)'=$E(X,4,5) S SDXF=0
"RTN","SDM0",69,0)
 D:SDXF DT
"RTN","SDM0",70,0)
 Q
"RTN","SDM0",71,0)
WMH ;Write month heading lines
"RTN","SDM0",72,0)
 W !!," TIME",?SI+SI-1 F Y=STARTDAY:1:65\(SI+SI)+STARTDAY W $E("|"_$S('Y:0,1:(Y-1#12+1))_"                 ",1,SI+SI)
"RTN","SDM0",73,0)
 W !," DATE",?SI+SI-1,"|" K J F Y=0:1:6 I $D(^SC(+SC,"T"_Y)) S J(Y)=""
"RTN","SDM0",74,0)
 F Y=1:1:65\(SI+SI) W $J("|",SI+SI)
"RTN","SDM0",75,0)
 S SDXF=2
"RTN","SDM0",76,0)
 Q
"RTN","SDM0",77,0)
DT W $$FMTE^XLFDT(Y) Q
"RTN","SDM0",78,0)
 ;
"RTN","SDM0",79,0)
DOW S Y=$$DOW^XLFDT(X,1) Q
"RTN","SDM0",80,0)
 ;
"RTN","SDM0",81,0)
DAY ;;^SUN^MON^TUES^WEDNES^THURS^FRI^SATUR
"RTN","SDM0",82,0)
MORDIS I '$D(SDHX) W *7," ??" G ADT^SDM1
"RTN","SDM0",83,0)
 S SDXF=0,X1=SDHX,X2=1 D C^%DTC
"RTN","SDM0",84,0)
MORD2 I $D(SDINA),SDINA'>X,SDRE>X!('SDRE) S SDHY=$S($D(Y):Y,1:""),Y=SDINA D DTS^SDUTL W *7,!,"Clinic is inactivated as of ",Y S Y=SDHY K SDHY G ADT^SDM1
"RTN","SDM0",85,0)
 G EN
"RTN","SDM0",86,0)
INPAT S SDI=$O(^DGPM("ATID1",DFN,9999999-X)) I SDI>0 D I1
"RTN","SDM0",87,0)
 S:'$D(SDINP) SDINP="" K SDI,SDI1 Q
"RTN","SDM0",88,0)
I1 F SDI1=0:0 S SDI1=$O(^DGPM("ATID1",DFN,SDI,SDI1)) Q:SDI1'>0  I $D(^DGPM(SDI1,0)) S SDX=^(0) I $S($P(SDX,U,17)']"":1,+^DGPM($P(SDX,U,17),0)>X!(+^DGPM($P(SDX,U,17),0)=0):1,1:0) S SDINP="I" Q
"RTN","SDM0",89,0)
 Q
"RTN","SDM0",90,0)
 ;
"RTN","SDM0",91,0)
SUP ;Set up variables for availability search
"RTN","SDM0",92,0)
 S SDNEXT=1,SDCT=1,G1=+SC,SDC(1)=SC,FND=0,SDAV=0 K SDC1
"RTN","SDM0",93,0)
 D SAVE S IOP=$S($D(ION):ION,1:"HOME") D ^%ZIS K IOP
"RTN","SDM0",94,0)
 Q
"RTN","SDM0",95,0)
 ;
"RTN","SDM0",96,0)
SET S I1="" F I=0:0 S I1=$O(SDZ(I1)) Q:I1']""  S @I1=SDZ(I1)
"RTN","SDM0",97,0)
 K SDZ Q
"RTN","SDM0",98,0)
SAVE K SDZ F I="SDDIF","STR","SC","DFN","SL","SI","HSI","SB" S Z="SDZ("_""""_I_""")" S:$D(@I) @Z=@I
"RTN","SDM0",99,0)
 Q
"RTN","SDM0",100,0)
MNTH W !," *** No availability found for one full calendar month",!,"  Search stopped at " S Y=X D DTS^SDUTL W Y," ***",! Q
"RTN","SDM0",101,0)
DIFF S X1=SDRE,X2=X D ^%DTC S D=D+X,X=SDRE,X1=X\100_28 Q
"RTN","SDM0",102,0)
 ;
"RTN","SDM0",103,0)
SRTY(SDSRTY) ;Prompt for scheduling request type
"RTN","SDM0",104,0)
 ;Input: SDSRTY=variable to return user response (pass by reference)
"RTN","SDM0",105,0)
 ;Output: '1' if successful, '0' otherwise
"RTN","SDM0",106,0)
 ;
"RTN","SDM0",107,0)
 I $G(DFN)<1 S SDSRTY="M" Q 1  ;patient not defined
"RTN","SDM0",108,0)
 I $G(SDMM)=1 S SDSRTY="M" Q 1  ;multiple appointment booking
"RTN","SDM0",109,0)
 N DIR,DTOUT,DUOUT
"RTN","SDM0",110,0)
 S DIR(0)="Y"
"RTN","SDM0",111,0)
 S DIR("A")="IS THIS A 'NEXT AVAILABLE' APPOINTMENT REQUEST"
"RTN","SDM0",112,0)
 S DIR("?")="Answer 'yes' if scheduling to the next available appointment is desired."
"RTN","SDM0",113,0)
 W ! D ^DIR I $D(DTOUT)!$D(DUOUT) Q 0
"RTN","SDM0",114,0)
 S SDSRTY=Y,SDSRTY(0)=$$TXRT^SDM1A(.SDSRTY) Q 1
"RTN","SDM0",115,0)
 ;
"RTN","SDM0",116,0)
PTFU(DFN,SC)    ;Determine if this is a follow-up (return to clinic within 24 months)
"RTN","SDM0",117,0)
 ;Input: DFN=patient ifn
"RTN","SDM0",118,0)
 ;Input: SC=clinic ifn
"RTN","SDM0",119,0)
 ;Output: '1' if seen within 24 months, '0' otherwise
"RTN","SDM0",120,0)
 ;
"RTN","SDM0",121,0)
 Q:'DFN!'SC 0  ;variable check
"RTN","SDM0",122,0)
 N SDBDT,SDT,SDX,SDY,SDZ,SDCP,SDCP1,SC0,SDENC,SDCT
"RTN","SDM0",123,0)
 ;set up variables
"RTN","SDM0",124,0)
 S SDBDT=(DT-20000)+.24,SDT=DT_.999999,(SDCT,SDY)=0
"RTN","SDM0",125,0)
 S SC0=$G(^SC(+SC,0)),SDX=$$CPAIR^SCRPW71(SC0,.SDCP)  ;get credit pair for this clinic
"RTN","SDM0",126,0)
 ;Iterate through encounters
"RTN","SDM0",127,0)
 W !!,"Calculating follow-up status"
"RTN","SDM0",128,0)
 F  S SDT=$O(^SCE("ADFN",DFN,SDT),-1) Q:SDT<SDBDT!SDY  D
"RTN","SDM0",129,0)
 .S SDENC=0 F  S SDENC=$O(^SCE("ADFN",DFN,SDT,SDENC)) Q:'SDENC!SDY  D
"RTN","SDM0",130,0)
 ..S SDENC0=$G(^SCE(SDENC,0))  ;get encounter node
"RTN","SDM0",131,0)
 ..Q:$P(SDENC0,U,6)  ;parent encounters only
"RTN","SDM0",132,0)
 ..S SDX=$P(SDENC0,U,4) Q:'SDX  ;get clinic
"RTN","SDM0",133,0)
 ..S SC0=$G(^SC(SDX,0))
"RTN","SDM0",134,0)
 ..S SDX=$$CPAIR^SCRPW71(SC0,.SDCP1)  ;get credit pair for encounter
"RTN","SDM0",135,0)
 ..S SDY=SDCP=SDCP1  ;compare credit pairs
"RTN","SDM0",136,0)
 ..S SDCT=SDCT+1 W:SDCT#10=0 "."
"RTN","SDM0",137,0)
 ..Q
"RTN","SDM0",138,0)
 .Q
"RTN","SDM0",139,0)
 Q SDY
"RTN","SDM0",140,0)
 ;
"RTN","SDM0",141,0)
DDATE(SDDATE,SDSRTY,SDMAX) ;Desired date selection
"RTN","SDM0",142,0)
 ;Input: SDDATE=variable to return date selection (pass by reference)
"RTN","SDM0",143,0)
 ;Input: SDSRTY=variable to return request type
"RTN","SDM0",144,0)
 ;Input: SDMAX=variable to return max. days to sched. (pass by ref.)
"RTN","SDM0",145,0)
 ;Output: '1' for success, otherwise '0'
"RTN","SDM0",146,0)
 ;
"RTN","SDM0",147,0)
 Q:SDSRTY 1
"RTN","SDM0",148,0)
 W !!?2,"Select one of the following:",!
"RTN","SDM0",149,0)
 W !?5,"'F'",?19,"for First available following a specified date"
"RTN","SDM0",150,0)
 ; SD*5.3*645 - replaced desired date with CID/Preferred date, adjusted format
"RTN","SDM0",151,0)
 ; W !?5,"Date",?19,"(or date computation such as 'T+2M') for a desired date"
"RTN","SDM0",152,0)
 W !?5,"Date",?19,"(or date computation such as 'T+2M') for a CID/Preferred date"
"RTN","SDM0",153,0)
 I DFN>0 W !?5,"Date/time",?19,"to schedule a specific appointment - Note: PAST dates",!?19,"must include the Year in the input."  ;added note SD*5.3*547
"RTN","SDM0",154,0)
 W !?5,"'?'",?19,"for detailed help"
"RTN","SDM0",155,0)
DASK N DIR,X,Y,SDX,DTOUT,DUOUT
"RTN","SDM0",156,0)
 ;
"RTN","SDM0",157,0)
 ;BP OIFO/TEH PATCH SD*5.3*384 ; SD*5.3*547 added note to help text
"RTN","SDM0",158,0)
 ;
"RTN","SDM0",159,0)
 S DIR(0)="F^1:30"
"RTN","SDM0",160,0)
 ; SD*5.3*645 - replaced DATE DESIRED with CID/PREFERRED DATE
"RTN","SDM0",161,0)
 ; S DIR("A")="ENTER THE DATE DESIRED FOR THIS APPOINTMENT"
"RTN","SDM0",162,0)
 S DIR("A")="ENTER THE CID/PREFERRED DATE FOR THIS APPOINTMENT"
"RTN","SDM0",163,0)
 S DIR("?",1)="  Enter the date that is desired for this appointment."
"RTN","SDM0",164,0)
 S DIR("?",2)="  NOTE: PAST dates must include the Year in the input."
"RTN","SDM0",165,0)
 S DIR("?",3)=""
"RTN","SDM0",166,0)
 S DIR("?",4)="  You may enter 'F' to find the first available slot after a specified date."
"RTN","SDM0",167,0)
 S DIR("?",5)="  You will be prompted for begin and end dates for this search."
"RTN","SDM0",168,0)
 S DIR("?",6)=""
"RTN","SDM0",169,0)
 S DIR("?",7)="  A date may be entered to begin the display of clinic availability at the"
"RTN","SDM0",170,0)
 I DFN<1 S DIR("?")="  requested date."
"RTN","SDM0",171,0)
 I DFN>0 D
"RTN","SDM0",172,0)
 .S DIR("?",8)="  requested date."
"RTN","SDM0",173,0)
 .S DIR("?",9)=""
"RTN","SDM0",174,0)
 .S DIR("?",10)="  The entry of a date/time will result in the scheduling of an appointment at"
"RTN","SDM0",175,0)
 .S DIR("?")="  that time, if possible."
"RTN","SDM0",176,0)
 .Q
"RTN","SDM0",177,0)
 W ! D ^DIR Q:$D(DTOUT)!$D(DUOUT) 0
"RTN","SDM0",178,0)
 I Y=" " S SDX=$G(^DISV(DUZ_U_+SC)) I SDX?7N S (X,Y)=SDX
"RTN","SDM0",179,0)
 I $L(Y)=1,"fF"[Y D  Q 1
"RTN","SDM0",180,0)
 .W "    First available"
"RTN","SDM0",181,0)
 .S (SDDATE,SDSRTY)=$TR(Y,"f","F")
"RTN","SDM0",182,0)
 .Q
"RTN","SDM0",183,0)
 N %DT,SDX,SDI,POP
"RTN","SDM0",184,0)
 S SDX="N^n^NOW^now^Now" F SDI=1:1:5 S:X=$P(SDX,U,SDI) X="T"
"RTN","SDM0",185,0)
 S %DT="EFT" D ^%DT
"RTN","SDM0",186,0)
 G:Y<1 DASK S SDDATE=Y
"RTN","SDM0",187,0)
 I DFN<1 S SDDATE=SDDATE\1
"RTN","SDM0",188,0)
 ;SD*5.3*621 - check if desired date if prior to DOB and if clinic schedule is available.
"RTN","SDM0",189,0)
 I DFN>0 S POP=0 D DDCHK I POP G DASK
"RTN","SDM0",190,0)
 I DFN>0,Y'<DT,(Y\1)>SDMAX D  G DASK
"RTN","SDM0",191,0)
 .W !,$C(7)
"RTN","SDM0",192,0)
 .W "Scheduling cannot be more than ",SDMAX(1)," days in the future"
"RTN","SDM0",193,0)
 .Q
"RTN","SDM0",194,0)
 Q 1
"RTN","SDM0",195,0)
 ;
"RTN","SDM0",196,0)
DDCHK ;SD*5.3*621 - check if desired date if prior to DOB and if clinic schedule is available.
"RTN","SDM0",197,0)
 N X
"RTN","SDM0",198,0)
 S X=SDDATE D AVCHK^SDM1 I POP Q
"RTN","SDM0",199,0)
 D AVCHK1^SDM1
"RTN","SDM0",200,0)
 Q
"RTN","SDM0",201,0)
 ;
"RTN","SDM0",202,0)
DOWCHK ;SD*5.3*547 check if date is prior to date DOW was added to pattern
"RTN","SDM0",203,0)
 S (DY,DYW)="" S:'$D(DWFLG) DWFLG=0
"RTN","SDM0",204,0)
 I '$D(^SC(+SC,"ST",$P(XDT,"."),1)) D  Q:DWFLG  I POP D DWWRT Q
"RTN","SDM0",205,0)
 .S DY=$$DOW^XLFDT($P(XDT,"."))
"RTN","SDM0",206,0)
 .S DYW=$E(DY,1,2),DYW=$TR(DYW,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","SDM0",207,0)
 .S PCDT=$P(XDT,"."),CT=0,POP=1
"RTN","SDM0",208,0)
 .F  S PCDT=$O(^SC(+SC,"ST",PCDT),-1) Q:'PCDT!('POP)!(CT>30)  D
"RTN","SDM0",209,0)
 ..S CT=CT+1
"RTN","SDM0",210,0)
 ..Q:'$D(^SC(+SC,"ST",PCDT,0))
"RTN","SDM0",211,0)
 ..Q:'$D(^SC(+SC,"ST",PCDT,1))
"RTN","SDM0",212,0)
 ..Q:$E($G(^SC(+SC,"ST",PCDT,1)),1,2)'=DYW
"RTN","SDM0",213,0)
 ..I $E($G(^SC(+SC,"ST",PCDT,1)),1,2)=DYW S POP=0 Q
"RTN","SDM0",214,0)
 .Q
"RTN","SDM0",215,0)
 K PCDT,CT,DY,DYW
"RTN","SDM0",216,0)
 Q
"RTN","SDM0",217,0)
 ;
"RTN","SDM0",218,0)
DWWRT ;added SD*5.3*547
"RTN","SDM0",219,0)
 S DY=$TR(DY,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","SDM0",220,0)
 W *7,!!,"That date is prior to the date ",DY," was added to the"
"RTN","SDM0",221,0)
 W !,"availability pattern for this clinic.",!!
"RTN","SDM0",222,0)
 K DY,DYW,PCDT,CT
"RTN","SDM0",223,0)
 Q
"RTN","SDM0",224,0)
 ;
"RTN","SDM0",225,0)
BEGDAT(SDDT,SDY) ;Add begin date check - SD*5.3*674, Quit 0 if successful, 1 if fails
"RTN","SDM0",226,0)
 N SDX,SDBEG,SDDOW
"RTN","SDM0",227,0)
 F SDX=0:1:6 S SDDOW(SDX,9999999)="" ;SD*5.3*674
"RTN","SDM0",228,0)
 S SDX=0 F  S SDX=$O(^SC(+SC,"T",SDX)) Q:'SDX  I '$D(^SC(+SC,"OST",SDX)) S SDBEG=$G(^SC(+SC,"T",SDX,0)) S SDDOW($$DOW^XLFDT(SDBEG,1),SDBEG)="" ;SD*5.3*674
"RTN","SDM0",229,0)
 I $O(SDDOW(SDY,(SDDT+1)),-1) Q 0 ;Successful check, Quit 0
"RTN","SDM0",230,0)
 Q 1 ;Chec failed, Quit 1
"RTN","SDM0",231,0)
 ;
"RTN","SDM0",232,0)
1 S SDNEXT="",SDCT=0 G RD^SDMULT
"RTN","SDM0",233,0)
DT1 S FND=0,%DT(0)=-SDMAX,%DT="AEF",%DT("A")="  START SEARCH FOR NEXT AVAILABLE FROM WHAT DATE: " D ^%DT K %DT G:"^"[X 1:$S('$D(SDNEXT):1,'SDNEXT:1,1:0),END^SDMULT0 G:Y<0 DT S (SDDATE,SDSTRTDT)=+Y
"RTN","SDM0",234,0)
LIM W !,"  ENTER LATEST DATE TO CHECK FOR 1ST AVAILABLE SLOT: " S Y=SDMAX D DT^DIQ R "// ",X:DTIME G:X["^"!'($T) END^SDMULT0 I X']"" G OVR^SDMULT0
"RTN","SDM0",235,0)
 I X?.E1"?" W !,"  The latest date for future bookings for ",$P(SDC(1),"^",2)," is: " S Y=SDMAX D DTS^SDUTL W Y,!,"  If you enter a date here, it must be less than this date to further limit the",!,"  search" G LIM
"RTN","SDM0",236,0)
 S %DT="EF",%DT(0)=-SDMAX D ^%DT K %DT G:Y<0!(Y<SDSTRTDT) LIM S:Y>0 (SDDMAX,SDMAX)=+Y
"RTN","SDM0",237,0)
 G OVR^SDMULT0
"RTN","SDM1")
0^7^B57988164^B54343109
"RTN","SDM1",1,0)
SDM1 ;SF/GFT - MAKE APPOINTMENT ; 3/29/05 12:35pm [5/5/05 9:41am]  ; Compiled March 8, 2007 14:55:24  ; Compiled May 9, 2007 13:19:18  ; Compiled August 28, 2007 12:19:08
"RTN","SDM1",2,0)
 ;;5.3;Scheduling;**32,167,168,80,223,263,273,408,327,478,490,446,547,611,674**;Aug 13, 1993;Build 18
"RTN","SDM1",3,0)
1 L  Q:$D(SDXXX)  S CCXN=0 K MXOK,COV,SDPROT Q:DFN<0  S SC=+SC
"RTN","SDM1",4,0)
 S X1=DT,SDEDT=365 S:$D(^SC(SC,"SDP")) SDEDT=$P(^SC(SC,"SDP"),"^",2)
"RTN","SDM1",5,0)
 S X2=SDEDT D C^%DTC S SDEDT=X D WRT
"RTN","SDM1",6,0)
 I $D(^SC(SC,"SI")),$O(^("SI",0))>0 W !,*7,?8,"**** SPECIAL INSTRUCTIONS ****",! S %I=0 F %=0:1 S %I=$O(^SC(SC,"SI",%I)) Q:%I'>0  W ^(%I,0) W:% ! I '%,$O(^SC(SC,"SI",%I))>0 S POP=0 D SPIN Q:POP
"RTN","SDM1",7,0)
 I $D(SDINA),SDINA>DT D IN W !,?8,@SDMSG K SDMSG
"RTN","SDM1",8,0)
 G:SDMM RDTY^SDMM
"RTN","SDM1",9,0)
 ;
"RTN","SDM1",10,0)
ADT S:'$D(SDW) SDW=""
"RTN","SDM1",11,0)
 S SDSOH=$S('$D(^SC(SC,"SL")):0,$P(^("SL"),"^",8)']"":0,1:1),CCX=""
"RTN","SDM1",12,0)
 S SDONCE=$G(SDONCE)+1  ;Prevent repetitive iteration
"RTN","SDM1",13,0)
 ; Section introduced in 446.
"RTN","SDM1",14,0)
 N SDDATE1,SDQT,Y  ; Do not allow progress if there is no availability > 120 days after the desired date.
"RTN","SDM1",15,0)
 S SDDATE1=$S($G(SDDATE)="":DT,1:SDDATE)
"RTN","SDM1",16,0)
 S Y="" D  Q:Y="^"
"RTN","SDM1",17,0)
 .F  Q:Y="^"!$$WLCL120^SDM2A(SC,SDDATE1)  D
"RTN","SDM1",18,0)
 ..S Y=$$WLCLASK^SDM2A() Q:Y="^"  ; Y=0: New date, Y=1: place on EWL, Y="^": quit
"RTN","SDM1",19,0)
 ..I Y=0 D  Q
"RTN","SDM1",20,0)
 ...N SDMAX,SDDMAX
"RTN","SDM1",21,0)
 ...S SDMAX(1)=$P($G(^SC(+SC,"SDP")),U,2) S:'SDMAX(1) SDMAX(1)=365
"RTN","SDM1",22,0)
 ...S (SDMAX,SDDMAX)=$$FMADD^XLFDT(DT,SDMAX(1))
"RTN","SDM1",23,0)
 ...S Y=$$DDATE^SDM0(.SDDATE,"0^0",.SDMAX) Q:'Y  ; Y=0: "^" entered, Y=1: date entered
"RTN","SDM1",24,0)
 ...D D^SDM0
"RTN","SDM1",25,0)
 ...S SDDATE1=SDDATE
"RTN","SDM1",26,0)
 ...Q
"RTN","SDM1",27,0)
 ..D WL^SDM2A(SC)
"RTN","SDM1",28,0)
 ..S Y="^"  ; quit
"RTN","SDM1",29,0)
 ..Q
"RTN","SDM1",30,0)
 .Q
"RTN","SDM1",31,0)
 ;
"RTN","SDM1",32,0)
 S X=$S(SDONCE<2:$G(SDSDATE),1:"")  ;Use default date/time if specified as 'desired date'  
"RTN","SDM1",33,0)
 I 'X R !,"DATE/TIME: ",X:DTIME Q:X="^"!'$$WLCL120A^SDM2A(X,SDDATE1,SC)  ;sd/327,446
"RTN","SDM1",34,0)
 I X="" D WL(SC) Q  ;sd/446
"RTN","SDM1",35,0)
 G:X="M"!(X="m") MORDIS^SDM0
"RTN","SDM1",36,0)
 I X="D"!(X="d") S X=$$REDDT() G:X>0 MORD2^SDM0 S X="" W "  ??",! G ADT
"RTN","SDM1",37,0)
 I X?1"?".E D  G ADT
"RTN","SDM1",38,0)
 .W !,"Enter a date/time for the appointment - PAST dates must include the YEAR"  ;SD*547 added note about past dates
"RTN","SDM1",39,0)
 .W:$D(SD) " or a space to choose the same date/time as the patient you have just previously scheduled into this clinic"
"RTN","SDM1",40,0)
 .W ".",!,"You may also select 'M' to display the next month's availability or"
"RTN","SDM1",41,0)
 .W !,"'D' to specify an earlier or later date to begin the availability display."
"RTN","SDM1",42,0)
 I X=" ",$D(SD),SD S Y=SD D AT^SDUTL W Y S Y=SD G OVR
"RTN","SDM1",43,0)
 I $E($P(X,"@",2),1,4)?1.4"0" K %DT S X=$P(X,"@"),X=$S($L(X):X,1:"T"),%DT="XF" D ^%DT G ADT:Y'>0 S X1=Y,X2=-1 D C^%DTC S X=X_.24
"RTN","SDM1",44,0)
 K %DT S %DT="TXEF" D ^%DT
"RTN","SDM1",45,0)
 ;SD*5.3*408  verify that day hasn't been canceled via "SET UP A CLINIC"
"RTN","SDM1",46,0)
 I $G(^SC(+SC,"ST",$P(Y,"."),1))'="",^SC(+SC,"ST",$P(Y,"."),1)'["[" D  G ADT
"RTN","SDM1",47,0)
 .W !,"There is no availability for this date/time.",!
"RTN","SDM1",48,0)
 I $P(Y,".",2)=24 S X1=$P(Y,"."),X2=1 D C^%DTC S Y=X_".000001"
"RTN","SDM1",49,0)
OVR I $D(^HOLIDAY($P(Y,"."),0)),'SDSOH W *7,?50,$P(^(0),U,2),"??" K SDSDATE G ADT
"RTN","SDM1",50,0)
 I $D(SDINA),$P(Y,".")'<SDINA,$S('$D(SDRE):1,SDRE>$P(Y,".")!('SDRE):1,1:0) D IN W !,*7,@SDMSG K SDMSG K SDSDATE G ADT
"RTN","SDM1",51,0)
 I Y#1=0 K SDSDATE G 1
"RTN","SDM1",52,0)
 I $P(Y,".")'<SDEDT W !,*7,"EXCEEDS MAXIMUM DAYS FOR FUTURE APPOINTMENT!!",*7 K SDSDATE G ADT
"RTN","SDM1",53,0)
 ;
"RTN","SDM1",54,0)
EN1 S (TMPD,X,SD)=Y,SM=0 D DOW  ;SD/478
"RTN","SDM1",55,0)
 F S=$P(SD,"."):0 S S=+$O(^DPT(DFN,"S",S)) Q:$P(S,".")-($P(SD,"."))  S I=+^(S,0) G ^SDM2:$P(^(0),U,2)'["C"
"RTN","SDM1",56,0)
 ;
"RTN","SDM1",57,0)
PRECAN I $D(^DPT(DFN,"S",SD,0)),$P(^(0),U,2)["P" S %=1 W !,"THIS TIME WAS PREVIOUSLY CANCELLED BY THE PATIENT",!,"ARE YOU SURE THAT YOU WANT TO PROCEED" D YN^DICN W:'% !,"ANSWER WITH (Y)ES OR (N)O" I (%-1) K SDSDATE G ADT
"RTN","SDM1",58,0)
 W !
"RTN","SDM1",59,0)
 ;SD*5.3*490 - AVCHK/AVCHK1 to check against pat DOB and clinic avail dt
"RTN","SDM1",60,0)
S S POP=0 D AVCHK G:POP 1
"RTN","SDM1",61,0)
 S POP=0 D AVCHK1 G:POP 1
"RTN","SDM1",62,0)
 N SDBEGDT,DY ;New variables for Date check  - SD*5.3*674
"RTN","SDM1",63,0)
 ;SD*5.3*547 if selected date is prior to the date the day of the week was added to clinic, do not set the date into availability pattern
"RTN","SDM1",64,0)
 I '$D(^SC(SC,"ST",$P(SD,"."),1)) D
"RTN","SDM1",65,0)
 .S XDT=X,POP=0
"RTN","SDM1",66,0)
 .D DOWCHK^SDM0
"RTN","SDM1",67,0)
 .S SDBEGDT=$$BEGDAT^SDM0($P(SD,"."),Y) ;Check if begin date of indefinite schedule is prior to appointment date - SD*5.3*674
"RTN","SDM1",68,0)
 .K XDT
"RTN","SDM1",69,0)
 .K:POP SDSDATE
"RTN","SDM1",70,0)
 G:POP 1
"RTN","SDM1",71,0)
 I $G(SDBEGDT) S DY=$$DOW^XLFDT($P(SD,".")) D DWWRT^SDM0 G 1 ;Indefinite schedule is prior to appointment date - SD*5.3*674
"RTN","SDM1",72,0)
 K POP
"RTN","SDM1",73,0)
 I '$D(^SC(SC,"ST",$P(SD,"."),1)) S SS=+$O(^SC(+SC,"T"_Y,SD)) G XW:SS'>0,XW:^(SS,1)="" S ^SC(+SC,"ST",$P(SD,"."),1)=$E($P($T(DAY),U,Y+2),1,2)_" "_$E(SD,6,7)_$J("",SI+SI-6)_^(1),^(0)=$P(SD,".")
"RTN","SDM1",74,0)
 ;
"RTN","SDM1",75,0)
LEN I $P(SL,U,2)]"" W !,"LENGTH OF APPOINTMENT (IN MINUTES): ",+SL,"// " R S:DTIME I S]"" G:$L(S)>3 LEN Q:U[S  S POP=0 D L G LEN:POP,S:S\5*5'=S,S:S>360,S:S<5 S SL=S_U_$P(SL,U,2,99)
"RTN","SDM1",76,0)
 ;
"RTN","SDM1",77,0)
SC S SDLOCK=$S('$D(SDLOCK):1,1:SDLOCK+1) G:SDLOCK>9 LOCK
"RTN","SDM1",78,0)
 L +^SC(SC,"ST",$P(SD,"."),1):$S($G(DILOCKTM)>0:DILOCKTM,1:5) G:'$T SC  ;SD*53.*547 new required lock functionality
"RTN","SDM1",79,0)
 S SDLOCK=0,S=^SC(SC,"ST",$P(SD,"."),1)
"RTN","SDM1",80,0)
 S I=SD#1-SB*100,ST=I#1*SI\.6+($P(I,".")*SI),SS=SL*HSI/60*SDDIF+ST+ST
"RTN","SDM1",81,0)
 G X:(I<1!'$F(S,"["))&(S'["CAN")
"RTN","SDM1",82,0)
 I SM<7 S %=$F(S,"[",SS-1) S:'%!($P(SL,"^",6)<3) %=999 I $F(S,"]",SS)'<%!(SDDIF=2&$E(S,ST+ST+1,SS-1)["[") S SM=7
"RTN","SDM1",83,0)
 ;
"RTN","SDM1",84,0)
SP I ST+ST>$L(S),$L(S)<80 S S=S_" " G SP
"RTN","SDM1",85,0)
 S SDNOT=1   ;SD*5.3*490 naked Do added below
"RTN","SDM1",86,0)
 F I=ST+ST:SDDIF:SS-SDDIF S ST=$E(S,I+1) S:ST="" ST=" " S Y=$E(STR,$F(STR,ST)-2) G C:S["CAN"!(ST="X"&($D(^SC(+SC,"ST",$P(SD,"."),"CAN")))),X:Y="" S:Y'?1NL&(SM<6) SM=6 S ST=$E(S,I+2,999) D  S:ST="" ST=" " S S=$E(S,1,I)_Y_ST
"RTN","SDM1",87,0)
 .Q:ST'=""
"RTN","SDM1",88,0)
 .Q:+SL'>+^SC(SC,"SL")
"RTN","SDM1",89,0)
 .S ST="   "
"RTN","SDM1",90,0)
 .Q
"RTN","SDM1",91,0)
 Q:SDMM  G OK^SDM1A:SM#9=0,^SDM3:$P(SL,U,7)]""&('$D(MXOK))
"RTN","SDM1",92,0)
 ;
"RTN","SDM1",93,0)
E G:'$D(^XUSEC("SDOB",DUZ)) NOOB
"RTN","SDM1",94,0)
 S %=2 W *7,!,$E($T(@SM),5,99),"...OK" D YN^DICN
"RTN","SDM1",95,0)
 I '% W !,"RESPOND YES OR NO" G E
"RTN","SDM1",96,0)
 S SM=9 G SC:'(%-1) K SDSDATE G 1
"RTN","SDM1",97,0)
 ;
"RTN","SDM1",98,0)
LOCK Q:SDMM  W !,*7,"ANOTHER USER HAS LOCKED THIS DATE - TRY AGAIN LATER" Q
"RTN","SDM1",99,0)
 ;
"RTN","SDM1",100,0)
6 ;;OVERBOOK!
"RTN","SDM1",101,0)
7 ;;THAT TIME IS NOT WITHIN SCHEDULED PERIOD!
"RTN","SDM1",102,0)
C S POP=1 W !,*7,"CAN'T BOOK WITHIN A CANCELLED TIME PERIOD!",!
"RTN","SDM1",103,0)
 Q:SDMM  K SDSDATE G 1
"RTN","SDM1",104,0)
 ;
"RTN","SDM1",105,0)
DAY ;;^SUN^MON^TUES^WEDNES^THURS^FRI^SATUR
"RTN","SDM1",106,0)
 ;
"RTN","SDM1",107,0)
DOW S %=$E(X,1,3),Y=$E(X,4,5),Y=Y>2&'(%#4)+$E("144025036146",Y)
"RTN","SDM1",108,0)
 F %=%:-1:281 S Y=%#4=1+1+Y
"RTN","SDM1",109,0)
 S Y=$E(X,6,7)+Y#7 Q
"RTN","SDM1",110,0)
 ;
"RTN","SDM1",111,0)
X I SDMM S POP=1 Q
"RTN","SDM1",112,0)
 G:I<1 XW
"RTN","SDM1",113,0)
 S:Y'?1NL&(SM<6) SM=6
"RTN","SDM1",114,0)
 G OK^SDM1A:SM#9=0,^SDM3:$P(SL,U,7)]""&('$D(MXOK))
"RTN","SDM1",115,0)
XW W *7,"  WHEN??" K SDSDATE G 1
"RTN","SDM1",116,0)
 ;
"RTN","SDM1",117,0)
AVCHK ;added SD*5.3*490
"RTN","SDM1",118,0)
 I '$D(VADM) Q:'DFN  S VADM(3)=$P(^DPT(DFN,0),U,3)
"RTN","SDM1",119,0)
 Q:$P(X,".",1)=$P(VADM(3),U,1)
"RTN","SDM1",120,0)
 I $P(X,".",1)<$P(VADM(3),U,1) W *7,!!,"That date is prior to the patient's date of birth.",!! S POP=1 K SDSDATE Q
"RTN","SDM1",121,0)
 Q
"RTN","SDM1",122,0)
 ;
"RTN","SDM1",123,0)
AVCHK1 ;added SD*5.3*490
"RTN","SDM1",124,0)
 S AVDT=0,AVDT=$O(^SC(+SC,"T",AVDT)) Q:'AVDT
"RTN","SDM1",125,0)
 I $P(X,".",1)<AVDT W *7,!!,"That date is prior to the clinic's availability date.",!! S POP=1 K SDSDATE,AVDT Q
"RTN","SDM1",126,0)
 Q
"RTN","SDM1",127,0)
 ;
"RTN","SDM1",128,0)
NOOB W !,"NO OPEN SLOTS THEN",*7 K SDSDATE G 1
"RTN","SDM1",129,0)
 ;
"RTN","SDM1",130,0)
WRT W !,+SL," MINUTE APPOINTMENTS "
"RTN","SDM1",131,0)
 W $S($P(SL,U,2)["V":"(VARIABLE LENGTH)",1:"") Q
"RTN","SDM1",132,0)
 ;
"RTN","SDM1",133,0)
L S SDSL=$S($P(SL,"^",6)]"":60/$P(SL,"^",6),1:"") Q:'SDSL
"RTN","SDM1",134,0)
 I S\(SDSL)*(SDSL)'=S W *7,!,"Appt. length must = or be a multiple of the increment minutes per hour (",SDSL,")",! S POP=1
"RTN","SDM1",135,0)
 Q
"RTN","SDM1",136,0)
 ;
"RTN","SDM1",137,0)
IN S SDHY=$S($D(Y):Y,1:""),Y=SDINA D DTS^SDUTL S Y1=Y,Y=SDRE
"RTN","SDM1",138,0)
 D:Y DTS^SDUTL
"RTN","SDM1",139,0)
 S SDMSG="""*** Note: Clinic is scheduled to be inactivated on "","_""""_Y1_""""_$S(SDRE:",!,?10,"_""" and reactivated on "","_""""_Y_"""",1:""),Y=SDHY K Y1,SDHY
"RTN","SDM1",140,0)
 Q
"RTN","SDM1",141,0)
 ;
"RTN","SDM1",142,0)
SPIN W !,"There are more special instructions. Do you want to display them"
"RTN","SDM1",143,0)
 S %=2 D YN^DICN
"RTN","SDM1",144,0)
 I '% W !,"Enter Y to see the remaining special instructions, or N if you don't wish to see them" G SPIN
"RTN","SDM1",145,0)
 I (%-1) S POP=1 Q
"RTN","SDM1",146,0)
 W !,^SC(SC,"SI",%I,0),! Q
"RTN","SDM1",147,0)
 ;
"RTN","SDM1",148,0)
REDDT() ;Prompt for availability redisplay date
"RTN","SDM1",149,0)
 N %DT,X,Y
"RTN","SDM1",150,0)
 S %DT="AEX"
"RTN","SDM1",151,0)
 S %DT("A")="DATE TO BEGIN THE RE-DISPLAY OF CLINIC AVAILABILITY: "
"RTN","SDM1",152,0)
 W ! D ^%DT
"RTN","SDM1",153,0)
 Q Y
"RTN","SDM1",154,0)
WL(SC) ;Wait List Hook/teh patch 263 ;SD/327 passed 'SC'
"RTN","SDM1",155,0)
 Q:$G(SC)'>0
"RTN","SDM1",156,0)
 I '$D(^SC(SC)) Q
"RTN","SDM1",157,0)
 I $D(SC) S SDWLFLG=0 D
"RTN","SDM1",158,0)
 .I $D(^SDWL(409.32,"B",+SC)) S SDWLFLG=1
"RTN","SDM1",159,0)
 .; SD*5.3*611 DO command removed and second level dot structure removed 
"RTN","SDM1",160,0)
 .I 'SDWLFLG S SDWLDSS=$P($G(^SC(+SC,0)),U,7) I $D(^SDWL(409.31,"B",SDWLDSS)) S SDWLFLG=2
"RTN","SDM1",161,0)
 .I SDWLFLG=1 S SDWLSC=$O(^SDWL(409.32,"B",+SC,0)) I $P(^SDWL(409.32,SDWLSC,0),U,4) S SDWLFLG=0
"RTN","SDM1",162,0)
 .I SDWLFLG=2 S SDWLDS=$O(^SDWL(409.31,"E",DUZ(2),0)) I $D(^SDWL(409.31,SDWLDSS,"I",+SDWLDS,0)),$P(^(0),U,4) S SDWLFLG=0
"RTN","SDM1",163,0)
 .I SDWLFLG D
"RTN","SDM1",164,0)
 ..K SDWLSC,SDWLDSS,SDWLDS,SDWLFLG
"RTN","SDM1",165,0)
 ..S SDWLOPT=1,SDWLERR=0 D OPT^SDWLE D EN^SDWLKIL
"RTN","SDM1",166,0)
 Q
"VER")
8.0^22.2
"BLD",10714,6)
^569
**END**
**END**

