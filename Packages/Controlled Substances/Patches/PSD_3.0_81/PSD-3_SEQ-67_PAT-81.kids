Released PSD*3*81 SEQ #67
Extracted from mail message
**KIDS**:PSD*3.0*81^

**INSTALL NAME**
PSD*3.0*81
"BLD",10031,0)
PSD*3.0*81^CONTROLLED SUBSTANCES^0^3170920^y
"BLD",10031,4,0)
^9.64PA^^
"BLD",10031,6)
^55
"BLD",10031,6.3)
11
"BLD",10031,"ABPKG")
n
"BLD",10031,"KRN",0)
^9.67PA^779.2^20
"BLD",10031,"KRN",.4,0)
.4
"BLD",10031,"KRN",.401,0)
.401
"BLD",10031,"KRN",.402,0)
.402
"BLD",10031,"KRN",.403,0)
.403
"BLD",10031,"KRN",.5,0)
.5
"BLD",10031,"KRN",.84,0)
.84
"BLD",10031,"KRN",3.6,0)
3.6
"BLD",10031,"KRN",3.8,0)
3.8
"BLD",10031,"KRN",9.2,0)
9.2
"BLD",10031,"KRN",9.8,0)
9.8
"BLD",10031,"KRN",9.8,"NM",0)
^9.68A^3^1
"BLD",10031,"KRN",9.8,"NM",3,0)
PSDNRGS^^0^B29419423
"BLD",10031,"KRN",9.8,"NM","B","PSDNRGS",3)

"BLD",10031,"KRN",19,0)
19
"BLD",10031,"KRN",19,"NM",0)
^9.68A^^
"BLD",10031,"KRN",19.1,0)
19.1
"BLD",10031,"KRN",101,0)
101
"BLD",10031,"KRN",409.61,0)
409.61
"BLD",10031,"KRN",771,0)
771
"BLD",10031,"KRN",779.2,0)
779.2
"BLD",10031,"KRN",870,0)
870
"BLD",10031,"KRN",8989.51,0)
8989.51
"BLD",10031,"KRN",8989.52,0)
8989.52
"BLD",10031,"KRN",8994,0)
8994
"BLD",10031,"KRN","B",.4,.4)

"BLD",10031,"KRN","B",.401,.401)

"BLD",10031,"KRN","B",.402,.402)

"BLD",10031,"KRN","B",.403,.403)

"BLD",10031,"KRN","B",.5,.5)

"BLD",10031,"KRN","B",.84,.84)

"BLD",10031,"KRN","B",3.6,3.6)

"BLD",10031,"KRN","B",3.8,3.8)

"BLD",10031,"KRN","B",9.2,9.2)

"BLD",10031,"KRN","B",9.8,9.8)

"BLD",10031,"KRN","B",19,19)

"BLD",10031,"KRN","B",19.1,19.1)

"BLD",10031,"KRN","B",101,101)

"BLD",10031,"KRN","B",409.61,409.61)

"BLD",10031,"KRN","B",771,771)

"BLD",10031,"KRN","B",779.2,779.2)

"BLD",10031,"KRN","B",870,870)

"BLD",10031,"KRN","B",8989.51,8989.51)

"BLD",10031,"KRN","B",8989.52,8989.52)

"BLD",10031,"KRN","B",8994,8994)

"BLD",10031,"QUES",0)
^9.62^^
"BLD",10031,"REQB",0)
^9.611^1^1
"BLD",10031,"REQB",1,0)
PSD*3.0*65^2
"BLD",10031,"REQB","B","PSD*3.0*65",1)

"MBREQ")
0
"PKG",328,-1)
1^1
"PKG",328,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",328,20,0)
^9.402P^^
"PKG",328,22,0)
^9.49I^1^1
"PKG",328,22,1,0)
3.0^2970213^2980330^1
"PKG",328,22,1,"PAH",1,0)
81^3170920
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","PSDNRGS")
0^3^B29419423^B25527968
"RTN","PSDNRGS",1,0)
PSDNRGS ;BIR/JPW-Receive Green Sheet for NAOU ; 17 Jan 2017  9:42 AM
"RTN","PSDNRGS",2,0)
 ;;3.0;CONTROLLED SUBSTANCES;**56,66,65,81**;13 Feb 97;Build 11
"RTN","PSDNRGS",3,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDNRGS",4,0)
 N AKUNITS
"RTN","PSDNRGS",5,0)
 S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,$D(^XUSEC("PSD NURSE",DUZ)):1,$D(^XUSEC("PSJ RPHARM",DUZ)):2,$D(^XUSEC("PSJ PHARM TECH",DUZ)):2,1:0)
"RTN","PSDNRGS",6,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Coordinator for access to complete",!,?12,"narcotic orders.",!!,"PSJ RNURSE, PSD NURSE, PSJ RPHARM, or PSJ PHARM TECH security key required.",! K OK Q
"RTN","PSDNRGS",7,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH Q
"RTN","PSDNRGS",8,0)
 W !!,"Receive Controlled Substances Orders and Green Sheet" S PSDUZ=DUZ,PSDUZN=$S($P($G(^VA(200,PSDUZ,0)),"^")]"":$P(^(0),"^"),1:"")
"RTN","PSDNRGS",9,0)
 N X,X1 D SIG^XUSESIG Q:X1=""
"RTN","PSDNRGS",10,0)
ASKN ;ask naou
"RTN","PSDNRGS",11,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select NAOU: "
"RTN","PSDNRGS",12,0)
 S:OK=1 DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDNRGS",13,0)
 S:OK=2 DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"""
"RTN","PSDNRGS",14,0)
 D ^DIC K DIC G:Y<0 END S AOU=+Y,AOUN=$P(Y,"^",2)
"RTN","PSDNRGS",15,0)
GS ;select green sheet #
"RTN","PSDNRGS",16,0)
 W ! K DA,DIC S DIC("A")="Select the Green Sheet #: ",DIC=58.81,DIC(0)="QEASZ",D="D"
"RTN","PSDNRGS",17,0)
 S DIC("S")="I $P(^(0),""^"",11),$P(^(0),""^"",11)<12"
"RTN","PSDNRGS",18,0)
 D IX^DIC K DIC G:Y<0 ASKN S PSDA=+Y
"RTN","PSDNRGS",19,0)
 ;--------------------------------------------------
"RTN","PSDNRGS",20,0)
 ; AKD = Y(0) piece 3 = Pointer to DRUG ACCOUNTABILITY STATS (#58.8)
"RTN","PSDNRGS",21,0)
 ;     file.
"RTN","PSDNRGS",22,0)
 ; AKD(1) = Y(0) piece 5 = Pointer to DRUG (#50) file in DRUG 
"RTN","PSDNRGS",23,0)
 ;         ACCOUNTABILITY (#58.8) file.  DRUG (#50) ien is DINUM'ed for
"RTN","PSDNRGS",24,0)
 ;         DRUG field PSD(58.8,AKD,1,AKD1)
"RTN","PSDNRGS",25,0)
 ; AKUNITS = DRUG ACCOUNTABILITY file <> Subfile DRUG <> subfield
"RTN","PSDNRGS",26,0)
 ;           BREAKDOWN UNIT (Free Text).
"RTN","PSDNRGS",27,0)
 D
"RTN","PSDNRGS",28,0)
 . N AKD,AKD1
"RTN","PSDNRGS",29,0)
 . S AKD=$P(Y(0),"^",3),AKD1=$P(Y(0),"^",5)
"RTN","PSDNRGS",30,0)
 . S AKUNITS=$P(^PSD(58.8,AKD,1,AKD1,0),"^",8)
"RTN","PSDNRGS",31,0)
 . W !,AKUNITS  ; display at line beginning
"RTN","PSDNRGS",32,0)
ORD S STAT=+$P(Y(0),"^",11),PSDPN=$P(Y(0),"^",17),STATN="" I STAT S STATN=$P($G(^PSD(58.82,STAT,0)),"^")
"RTN","PSDNRGS",33,0)
 S ORD=+$P(Y(0),"^",20),NAOU=+$P(Y(0),"^",18),NAOUN=$P($G(^PSD(58.8,NAOU,0)),"^"),PSDR=+$P(Y(0),"^",5),PSDRN=$P($G(^PSDRUG(PSDR,0)),"^"),QTY=+$P(Y(0),"^",6)
"RTN","PSDNRGS",34,0)
 ; >> RJS - *65
"RTN","PSDNRGS",35,0)
 L +^PSD(58.81,PSDA):$S($G(DILOCKTM)>0:DILOCKTM,1:3)
"RTN","PSDNRGS",36,0)
 I '$T W !,"The Green Sheet # ",PSDPN," is currently in use by another user",!,"Please select another Green Sheet.",! G GS
"RTN","PSDNRGS",37,0)
 I $D(^PSD(58.81,PSDA,4)),+$P(^(4),"^",3) S QTY=$P(^(4),"^",3)
"RTN","PSDNRGS",38,0)
 I AOU'=NAOU W $C(7),!!,"The Green Sheet # ",PSDPN," is assigned to ",NAOUN,".",!,"Please select another Green Sheet.",! L -^PSD(58.81,PSDA) G GS  ; <RJS - *65
"RTN","PSDNRGS",39,0)
 I '$D(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)) W $C(7),!!,"There's no data on ",NAOUN," for Green Sheet # ",PSDPN,".",!,"Contact your Pharmacy Coordinator for assistance.",! L -^PSD(58.81,PSDA) G END  ; <RJS - *65
"RTN","PSDNRGS",40,0)
 I STAT'=3 W $C(7),!!,"This Green Sheet has a status of "_$S(STATN]"":STATN,1:"UNKNOWN")_".",!,"Please select another Green Sheet.",! L -^PSD(58.81,PSDA) G GS  ; RJS - *65
"RTN","PSDNRGS",41,0)
 D NOW^%DTC S (RECD,Y)=+$E(%,1,12) X ^DD("DD") S RECDT=Y
"RTN","PSDNRGS",42,0)
REC ;receive at order level in 58.8
"RTN","PSDNRGS",43,0)
 W !!,"Accessing ",PSDRN," information...",!!
"RTN","PSDNRGS",44,0)
 ;K DA,DIR,DIRUT S DIR(0)="58.81,27",DIR("B")=QTY D ^DIR K DIR I $D(DIRUT) W !!,"Quantity not entered.  No action taken.",!,"This order remains ",STATN,!! L -^PSD(58.81,PSDA) G END  ; < RJS - *65
"RTN","PSDNRGS",45,0)
 K DA,DIR,DIRUT D  S DIR(0)="58.81,27",DIR("B")=QTY D ^DIR K DIR I $D(DIRUT) W !!,"Quantity not entered.  No action taken.",!,"This order remains ",STATN,!! L -^PSD(58.81,PSDA) G END
"RTN","PSDNRGS",46,0)
 . S DIR("A")="QUANTITY RECEIVED ("_AKUNITS_")"  ; display units in prompt
"RTN","PSDNRGS",47,0)
 S RQTY=Y I RQTY'=QTY W $C(7),!!,"The quantity received does not match the quantity dispensed.",!,"This order must be returned to pharmacy for investigation.",!! L -^PSD(58.81,PSDA) G GS  ;< RJS - *65
"RTN","PSDNRGS",48,0)
 K DA,DIE,DR S DA=ORD,DA(1)=PSDR,DA(2)=NAOU
"RTN","PSDNRGS",49,0)
 S DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,"
"RTN","PSDNRGS",50,0)
 S DR=$S(OK=1:"6////"_PSDUZ,1:"6RECEIVED BY NURSE")_";20////"_QTY_";15////"_RECD_";10////4;22////"_$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4)_";25////"_$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4) D ^DIE K DA,DIE,DR
"RTN","PSDNRGS",51,0)
 I ($D(Y))!($D(DTOUT)) W $C(7),!!,"*** THIS ORDER HAS NOT BEEN RECEIVED ***",!,"Receiving nurses name must be entered.",!!,"The status remains "_STATN,! L -^PSD(58.81,PSDA) G END  ;< RJS - *65
"RTN","PSDNRGS",52,0)
UPDATE ;update 58.8 and 58.81
"RTN","PSDNRGS",53,0)
 ;updating drug balance in 58.8
"RTN","PSDNRGS",54,0)
 F  L +^PSD(58.8,NAOU,1,PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDNRGS",55,0)
 ;PSD*3*56;REMOVED CHECK FOR PATIENT ID
"RTN","PSDNRGS",56,0)
 S $P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)=$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)+QTY
"RTN","PSDNRGS",57,0)
 L -^PSD(58.8,NAOU,1,PSDR,0)
"RTN","PSDNRGS",58,0)
 ;update transaction file (58.81)
"RTN","PSDNRGS",59,0)
 S OREC=$P($G(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)),"^",7)
"RTN","PSDNRGS",60,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81
"RTN","PSDNRGS",61,0)
 S DR="10////"_$S('$P($G(^PSD(58.8,NAOU,2)),U,5):4,$P($G(^PSD(58.81,PSDA,9)),U):4,1:13)_";20////"_OREC_";21////"_RECD_";27////"_QTY_";I OK=1 S Y=""@1"";15COMMENTS;@1"
"RTN","PSDNRGS",62,0)
 D ^DIE K DA,DIE,DR
"RTN","PSDNRGS",63,0)
 I OK=2 S $P(^PSD(58.81,PSDA,1),"^",11)=PSDUZ
"RTN","PSDNRGS",64,0)
 W !!,"Updating your records now..."
"RTN","PSDNRGS",65,0)
 ;update worksheet file (58.85) to be purged
"RTN","PSDNRGS",66,0)
 S DA=+$O(^PSD(58.85,"AD",NAOU,PSDR,ORD,0)) I DA,$D(^PSD(58.85,DA,0)) K DIE,DR S DIE=58.85,DR="6////4" D ^DIE K DA,DIE,DR
"RTN","PSDNRGS",67,0)
 W "done.",!!
"RTN","PSDNRGS",68,0)
 S STAT=$P($G(^PSD(58.81,PSDA,0)),"^",11) W ?5,"*** Your Green Sheet #"_PSDPN_" is now "_$S($P($G(^PSD(58.82,STAT,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" ***",!
"RTN","PSDNRGS",69,0)
 L -^PSD(58.81,PSDA)  ;< RJS - *65
"RTN","PSDNRGS",70,0)
 G GS
"RTN","PSDNRGS",71,0)
END K %,%DT,%H,%I,AOU,AOUN,D,DA,DIC,DIE,DR,DTOUT,DUOUT
"RTN","PSDNRGS",72,0)
 K NAOU,NAOUN,OK,ORD,OREC,PSDPN,PSDR,PSDRN,PSDUZ,PSDUZN,QTY,RECD,RECDT,RQTY,STAT,STATN,SUB,PSDA,X,Y
"RTN","PSDNRGS",73,0)
 Q
"VER")
8.0^22.2
"BLD",10031,6)
^67
**END**
**END**

