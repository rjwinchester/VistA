Released PSD*3*83 SEQ #70
Extracted from mail message
**KIDS**:PSD*3.0*83^

**INSTALL NAME**
PSD*3.0*83
"BLD",10348,0)
PSD*3.0*83^CONTROLLED SUBSTANCES^0^3180501^y
"BLD",10348,1,0)
^^2^2^3171124^^
"BLD",10348,1,1,0)
Medication Prescribing and Dispensing Updates. Modification to Digitally 
"BLD",10348,1,2,0)
signed CS Orders Report.
"BLD",10348,4,0)
^9.64PA^^
"BLD",10348,6.3)
10
"BLD",10348,"ABPKG")
n
"BLD",10348,"KRN",0)
^9.67PA^779.2^20
"BLD",10348,"KRN",.4,0)
.4
"BLD",10348,"KRN",.401,0)
.401
"BLD",10348,"KRN",.402,0)
.402
"BLD",10348,"KRN",.403,0)
.403
"BLD",10348,"KRN",.5,0)
.5
"BLD",10348,"KRN",.84,0)
.84
"BLD",10348,"KRN",3.6,0)
3.6
"BLD",10348,"KRN",3.8,0)
3.8
"BLD",10348,"KRN",9.2,0)
9.2
"BLD",10348,"KRN",9.8,0)
9.8
"BLD",10348,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",10348,"KRN",9.8,"NM",1,0)
PSDDSOR1^^0^B34383843
"BLD",10348,"KRN",9.8,"NM",2,0)
PSDSUBOX^^0^B34180714
"BLD",10348,"KRN",9.8,"NM","B","PSDDSOR1",1)

"BLD",10348,"KRN",9.8,"NM","B","PSDSUBOX",2)

"BLD",10348,"KRN",19,0)
19
"BLD",10348,"KRN",19.1,0)
19.1
"BLD",10348,"KRN",101,0)
101
"BLD",10348,"KRN",409.61,0)
409.61
"BLD",10348,"KRN",771,0)
771
"BLD",10348,"KRN",779.2,0)
779.2
"BLD",10348,"KRN",870,0)
870
"BLD",10348,"KRN",8989.51,0)
8989.51
"BLD",10348,"KRN",8989.52,0)
8989.52
"BLD",10348,"KRN",8994,0)
8994
"BLD",10348,"KRN","B",.4,.4)

"BLD",10348,"KRN","B",.401,.401)

"BLD",10348,"KRN","B",.402,.402)

"BLD",10348,"KRN","B",.403,.403)

"BLD",10348,"KRN","B",.5,.5)

"BLD",10348,"KRN","B",.84,.84)

"BLD",10348,"KRN","B",3.6,3.6)

"BLD",10348,"KRN","B",3.8,3.8)

"BLD",10348,"KRN","B",9.2,9.2)

"BLD",10348,"KRN","B",9.8,9.8)

"BLD",10348,"KRN","B",19,19)

"BLD",10348,"KRN","B",19.1,19.1)

"BLD",10348,"KRN","B",101,101)

"BLD",10348,"KRN","B",409.61,409.61)

"BLD",10348,"KRN","B",771,771)

"BLD",10348,"KRN","B",779.2,779.2)

"BLD",10348,"KRN","B",870,870)

"BLD",10348,"KRN","B",8989.51,8989.51)

"BLD",10348,"KRN","B",8989.52,8989.52)

"BLD",10348,"KRN","B",8994,8994)

"BLD",10348,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",10348,"QUES",0)
^9.62^^
"BLD",10348,"REQB",0)
^9.611^1^1
"BLD",10348,"REQB",1,0)
PSD*3.0*73^2
"BLD",10348,"REQB","B","PSD*3.0*73",1)

"MBREQ")
0
"PKG",328,-1)
1^1
"PKG",328,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",328,20,0)
^9.402P^^
"PKG",328,22,0)
^9.49I^1^1
"PKG",328,22,1,0)
3.0^2970213^2980330^1
"PKG",328,22,1,"PAH",1,0)
83^3180501
"PKG",328,22,1,"PAH",1,1,0)
^^2^2^3180501
"PKG",328,22,1,"PAH",1,1,1,0)
Medication Prescribing and Dispensing Updates. Modification to Digitally 
"PKG",328,22,1,"PAH",1,1,2,0)
signed CS Orders Report.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSDDSOR1")
0^1^B34383843^B31741433
"RTN","PSDDSOR1",1,0)
PSDDSOR1 ;BHM/MHA/PWC - Digitally signed CS Orders Report; 08/30/02
"RTN","PSDDSOR1",2,0)
 ;;3.0;CONTROLLED SUBSTANCES;**40,67,73,83**;Feb 13,1997;Build 10
"RTN","PSDDSOR1",3,0)
 ;Ref. to ^PSRX( supported by DBIA 1977
"RTN","PSDDSOR1",4,0)
 ;Ref. to ^PS(52.41, supported by DBIA 3848
"RTN","PSDDSOR1",5,0)
 ;
"RTN","PSDDSOR1",6,0)
 Q
"RTN","PSDDSOR1",7,0)
PRT I ($Y+13)>IOSL D:AC HD^PSDDSOR D:'AC HD^PSDDSOR2 Q:$D(DIRUT)
"RTN","PSDDSOR1",8,0)
 ; PSD*3*83 - newing variables to clean up XINDEX
"RTN","PSDDSOR1",9,0)
 N I,PL,PL1,J
"RTN","PSDDSOR1",10,0)
 S I=0,PL=""
"RTN","PSDDSOR1",11,0)
 I $P($G(Y2),"^")]"" S PL=$E($P(Y2,"^"),1,30)
"RTN","PSDDSOR1",12,0)
 E  S PL=$E($P($G(Y6),"^"),1,30),I=1
"RTN","PSDDSOR1",13,0)
 W !?1," DRUG"_$S($G(I):" (OI)",1:"")_": "_PL,?50,"CS Federal Schedule: "_+$P(Y2,"^",5)
"RTN","PSDDSOR1",14,0)
 F I=1:1 Q:'$G(Y7(I))  W "       ",Y7(I),!
"RTN","PSDDSOR1",15,0)
 W !?2,"Provider: "_$E($P(Y4,"^")_P1,1,30),?50,"DEA #: "_$P(Y4,"^",3)
"RTN","PSDDSOR1",16,0)
 W !?2,"Clinic: "_$$GET1^DIQ(44,$P(Y0,"^",13),.01),?50,"Detox #: "_$P(Y4,"^",4)
"RTN","PSDDSOR1",17,0)
 S PL=$P(Y5,"^"),PL1="" F I=2:1:6 S J=$P(Y5,"^",I) D:J]""
"RTN","PSDDSOR1",18,0)
 .I PL1="",$L(J)+$L(PL)<60 S PL=PL_", "_J
"RTN","PSDDSOR1",19,0)
 .E  S PL1=PL1_$S(PL1]"":", ",1:"")_J
"RTN","PSDDSOR1",20,0)
 W !?2,"Provider Address: "_PL W:PL1]"" !?20,PL1
"RTN","PSDDSOR1",21,0)
 W !?2,"CPRS Order #: "_$P(Y0,"^",2),?50,"Date Order Written: " S Y=$P(Y0,"^",5) I Y W $E(Y,4,5)_"/"_$E(Y,6,7)_"/"_$E(Y,2,3)
"RTN","PSDDSOR1",22,0)
 W !?2,"Patient Name: "_$E($P(Y1,"^")_P1,1,30),?50,"PATIENT ID: "
"RTN","PSDDSOR1",23,0)
 S DFN=$S($P(Y0,"^",12)="R":$P(^PSRX(S5,0),"^",2),1:$P($G(^PS(52.41,S5,0)),"^",2)) D PID^VADPT W $E($P(Y1,"^"))_VA("BID")
"RTN","PSDDSOR1",24,0)
 S PL=$P(Y1,"^",2),PL1="" F I=3:1:7 S J=$P(Y1,"^",I) D:J]""
"RTN","PSDDSOR1",25,0)
 .I PL1="",$L(J)+$L(PL)<60 S PL=PL_", "_J
"RTN","PSDDSOR1",26,0)
 .E  S PL1=PL1_$S(PL1]"":", ",1:"")_J
"RTN","PSDDSOR1",27,0)
 W !?2,"Patient Address: "_PL W:PL1]"" !?19,PL1
"RTN","PSDDSOR1",28,0)
 W !?2,"Rx #: "_$S($P(Y0,"^",12)="R":$P(^PSRX(S5,0),"^"),1:"")
"RTN","PSDDSOR1",29,0)
 ;PATCH PSD*3*83 - Added ECME# to be displayed on report
"RTN","PSDDSOR1",30,0)
 I $D(Y8) W !?2,"ECME #: "_Y8
"RTN","PSDDSOR1",31,0)
 W ?50,"Qty: "_$S(AC=4:$P(^PS(52.41,S5,0),"^",10),1:$P(Y2,"^",3))
"RTN","PSDDSOR1",32,0)
 W !?2,"SIG: "
"RTN","PSDDSOR1",33,0)
 D FSIG($P(Y0,"^",12),S5,75)
"RTN","PSDDSOR1",34,0)
 I $G(FSIG(1))'="" D
"RTN","PSDDSOR1",35,0)
 . W $$UNESC^ORHLESC($G(FSIG(1)))
"RTN","PSDDSOR1",36,0)
 . I $O(FSIG(1)) D
"RTN","PSDDSOR1",37,0)
 . . F EE=1:0 S EE=$O(FSIG(EE)) Q:'EE  D
"RTN","PSDDSOR1",38,0)
 . . . W !?6,$$UNESC^ORHLESC($G(FSIG(EE)))
"RTN","PSDDSOR1",39,0)
 F  S PL=$O(Y3(PL)) Q:'PL  W ?7,Y3(PL),!
"RTN","PSDDSOR1",40,0)
P1 N RX2 S RX2=$S($P(Y0,"^",12)="R":$G(^PSRX(S5,2)),1:"")
"RTN","PSDDSOR1",41,0)
 W !?2,"Date Filled: ",$$FMTE^XLFDT($P(RX2,"^",2),2)
"RTN","PSDDSOR1",42,0)
 W ?27,"# of Refills: ",$S($P(Y0,"^",12)="R":+$P($G(^PSRX(S5,0)),"^",9),1:$P($G(^PS(52.41,S5,0)),"^",11))
"RTN","PSDDSOR1",43,0)
 W ?50,"Date Released: " S Y=$P(RX2,"^",13) I Y W $E(Y,4,5)_"/"_$E(Y,6,7)_"/"_$E(Y,2,3)
"RTN","PSDDSOR1",44,0)
 W !?2,"Releasing Pharmacist: "_$S($P(RX2,"^",3):$P(^VA(200,$P(RX2,"^",3),0),"^"),1:"")
"RTN","PSDDSOR1",45,0)
 W ?50,"Valid PKI Certificate?: "
"RTN","PSDDSOR1",46,0)
 N FL0 S FL0=$S(AC=4:"No",1:"Yes"),Y=$P(RX2,"^",2)
"RTN","PSDDSOR1",47,0)
 I $P(Y0,"^",12)="R",AC'=4,$D(^PSRX(S5,"A")) N FL S FL=0 F  S FL=$O(^PSRX(S5,"A",FL)) Q:'FL!(FL0="No")  I $P(^PSRX(S5,"A",FL,0),"^",2)="K" S FL0="No",Y=$P($P(^(0),"^"),".")
"RTN","PSDDSOR1",48,0)
 W FL0
"RTN","PSDDSOR1",49,0)
 W !?2,"Date Signature Validation Attempted by Pharmacy: "
"RTN","PSDDSOR1",50,0)
 I Y W $E(Y,4,5)_"/"_$E(Y,6,7)_"/"_$E(Y,2,3)
"RTN","PSDDSOR1",51,0)
 W !?2,"CPRS Nature of Order: "_$P(Y0,"^",3),?50,"Order Status: "_$P($P(Y0,"^",4),";",2)
"RTN","PSDDSOR1",52,0)
 S PL=$S($P(Y0,"^",7)]"":$P(Y0,"^",7),$P(Y0,"^"):"Digitally Signed",1:"")
"RTN","PSDDSOR1",53,0)
 W !?2,"Signature Status: "_$E(PL,1,60) W:$L(PL)>60 !,?20,$E(PL,61,200) W !
"RTN","PSDDSOR1",54,0)
 Q
"RTN","PSDDSOR1",55,0)
 ;
"RTN","PSDDSOR1",56,0)
GETDATA(Y,ORIEN,DFN) ;Gets data from archival file, otherwise use old CPRS call.
"RTN","PSDDSOR1",57,0)
 ;Input: ORIEN  - Order IEN
"RTN","PSDDSOR1",58,0)
 ;       DFN    - Patient IEN
"RTN","PSDDSOR1",59,0)
 ;Output Y
"RTN","PSDDSOR1",60,0)
 ;On error: Y = -1^Error message
"RTN","PSDDSOR1",61,0)
 ;Else: Y = 1^ Order # ^ Nature of order ^ Order Status ^ Date Signed
"RTN","PSDDSOR1",62,0)
 ;   Y(1) = "Patient name ^ Street1 ^ Street2 ^ Street3 ^ City ^ State ^ Zip"
"RTN","PSDDSOR1",63,0)
 ;   Y(2) = "Drug name_strength_dosage form (Dispense drug) ^ Drug IEN (file 50) ^ Drug quantity prescribed ^ Schedule of medication ^5 DEA Schedule"
"RTN","PSDDSOR1",64,0)
 ;   Y(3) = "Directions for use (SIG)"
"RTN","PSDDSOR1",65,0)
 ;   Y(4) = "Provider's name ^ DUZ ^ Provider's DEA # ^ Provider's DETOX #"
"RTN","PSDDSOR1",66,0)
 ;   Y(5) = "SiteName ^ SiteStreet1  ^ SiteStreet2 ^ SiteCity  ^ SiteState ^ SiteZip"
"RTN","PSDDSOR1",67,0)
 ;   Y(6) = "Orderable Item ^ Orderable Item IEN (file 50.7)"
"RTN","PSDDSOR1",68,0)
 ;   Y(7) = "Strenght ^ Dosage Form
"RTN","PSDDSOR1",69,0)
 N TMP,PND0,RX0,DDR,ECME,RFL,CN,EE,RXIEN,RX0,RXOI,PIEN,ORI,ORIE,STA
"RTN","PSDDSOR1",70,0)
 I $G(ORIEN)="" S Y="-1^INVALID ORDER #" Q
"RTN","PSDDSOR1",71,0)
 I $G(DFN)="" S Y="-1^INVALID PATIENT ID" Q
"RTN","PSDDSOR1",72,0)
 K ^TMP($J,"ORDEA")
"RTN","PSDDSOR1",73,0)
 D ARCHIVE^ORDEA(ORIEN)
"RTN","PSDDSOR1",74,0)
 I $D(^TMP($J,"ORDEA",ORIEN,1)),'$P(^(1),"^"),'$G(PND) N NCHK S NCHK=0 D  I 'NCHK S Y="-1^INVALID PRESCRIPTION #" Q
"RTN","PSDDSOR1",75,0)
 . S NCHK=$$SUBSCRIB^ORDEA(ORIEN,RX)
"RTN","PSDDSOR1",76,0)
 . I NCHK K ^TMP($J,"ORDEA") D ARCHIVE^ORDEA(ORIEN)
"RTN","PSDDSOR1",77,0)
 I '$D(^TMP($J,"ORDEA")) D GETDATA^ORWOR1(.Y,ORIEN,DFN) Q
"RTN","PSDDSOR1",78,0)
 F I=1:1:5 S TMP(I)=$G(^TMP($J,"ORDEA",ORIEN,I))
"RTN","PSDDSOR1",79,0)
 I DFN'=$P(TMP(4),"^",2) S Y="-1^INVALID PATIENT ID" Q
"RTN","PSDDSOR1",80,0)
 S RXIEN=$O(^PSRX("APL",ORIEN,"")),RX0=$S(RXIEN:$G(^PSRX(RXIEN,0)),1:""),RXOI=$S(RXIEN:$G(^PSRX(RXIEN,"OR1")),1:"")
"RTN","PSDDSOR1",81,0)
 S PIEN=$O(^PS(52.41,"B",ORIEN,"")),PND0=$S(PIEN:$G(^PS(52.41,PIEN,0)),1:"")
"RTN","PSDDSOR1",82,0)
 I RXIEN="",PIEN="" S Y="-1^INVALID ORDER #" Q
"RTN","PSDDSOR1",83,0)
 I RXIEN'="",RXIEN'=$P(TMP(1),"^") S Y="-1^INVALID PRESCRIPTION #" Q
"RTN","PSDDSOR1",84,0)
 I RXIEN,'$P($G(^PSRX(RXIEN,"PKI")),"^") S Y="-1^ORDER HAS NOT BEEN DIGITALLY SIGNED" Q
"RTN","PSDDSOR1",85,0)
 I PIEN,'$P(PND0,"^",24) S Y="-1^ORDER HAS NOT BEEN DIGITALLY SIGNED" Q
"RTN","PSDDSOR1",86,0)
 S DDR=$P(RX0,"^",6) S:DDR DDR=$$GET1^DIQ(50,DDR,.01)_"^"_DDR
"RTN","PSDDSOR1",87,0)
 S STA=$S(RXIEN:$P($G(^PSRX(RXIEN,"STA")),"^")_";"_$$GET1^DIQ(52,RXIEN,100),1:99_";"_$$GET1^DIQ(52.41,PIEN,2))
"RTN","PSDDSOR1",88,0)
 S Y="1^"_ORIEN_"^ELECTRONICALLY ENTERED^"_STA_"^"_$P(TMP(1),"^",2)
"RTN","PSDDSOR1",89,0)
 S Y(1)=$P(TMP(4),"^")_"^"_TMP(5)
"RTN","PSDDSOR1",90,0)
 S Y(2)=$S($P(TMP(1),"^",3)'="":$P(TMP(1),"^",3,4),DDR'="":DDR,1:"^")_"^"_$P(TMP(1),"^",6)_"^^"_$P(TMP(1),"^",5)
"RTN","PSDDSOR1",91,0)
 S Y(3)="" M Y(3)=TMP(6)
"RTN","PSDDSOR1",92,0)
 S Y(4)=$P(TMP(2),"^",3)_"^"_$P(TMP(2),"^",4)_"^"_$P(TMP(2),"^",1,2)
"RTN","PSDDSOR1",93,0)
 S Y(5)=TMP(3)
"RTN","PSDDSOR1",94,0)
 S ORI=$S($P(RXOI,"^"):$P(RXOI,"^"),1:$P(PND0,"^",8))
"RTN","PSDDSOR1",95,0)
 S ORIE=$S($D(^PS(50.7,ORI,0)):$P(^PS(50.7,ORI,0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^"),1:"")
"RTN","PSDDSOR1",96,0)
 S Y(6)=ORIE_"^"_ORI
"RTN","PSDDSOR1",97,0)
 S CN=$O(TMP(7,"")) I CN'="" S $P(Y(2),"^")=$P(Y(2),"^")_" "_$TR(TMP(7,CN),"^"," ")
"RTN","PSDDSOR1",98,0)
 S Y(7)="" M Y(7)=TMP(7) I CN'="" K Y(7,CN)
"RTN","PSDDSOR1",99,0)
 S $P(Y,"^",10)=1
"RTN","PSDDSOR1",100,0)
 ;PATCH PSD*3*83 - Added functionality to add the ECME # to the Y array
"RTN","PSDDSOR1",101,0)
 I RXIEN D
"RTN","PSDDSOR1",102,0)
 .S RFL=$$LSTRFL^PSOBPSU1(RXIEN)
"RTN","PSDDSOR1",103,0)
 .S ECME=$$ECMENUM^PSOBPSU2(RXIEN,RFL)
"RTN","PSDDSOR1",104,0)
 .S Y(8)=ECME
"RTN","PSDDSOR1",105,0)
 Q
"RTN","PSDDSOR1",106,0)
 ;
"RTN","PSDDSOR1",107,0)
FSIG(PSOFILE,PSOINTR,PSOLENTH) ;Format front door sig
"RTN","PSDDSOR1",108,0)
 ;PSOFILE is 'P' if in Pending File, 'R' if in Prescription File
"RTN","PSDDSOR1",109,0)
 ;PSOINTR is internal number for either file
"RTN","PSDDSOR1",110,0)
 ;PSOLENTH is length of each line of the Sig
"RTN","PSDDSOR1",111,0)
 ;returned in the FSIG array
"RTN","PSDDSOR1",112,0)
 K FSIG I $G(PSOFILE)=""!('$G(PSOINTR))!('$G(PSOLENTH)) G FQUIT
"RTN","PSDDSOR1",113,0)
 I PSOFILE'="P",PSOFILE'="R" G FQUIT
"RTN","PSDDSOR1",114,0)
 I PSOFILE="P",'$D(^PS(52.41,+PSOINTR,0)) G FQUIT
"RTN","PSDDSOR1",115,0)
 I PSOFILE="R",'$D(^PSRX(+PSOINTR,0)) G FQUIT
"RTN","PSDDSOR1",116,0)
 I PSOFILE="R",'$P($G(^PSRX(+PSOINTR,"SIG")),"^",2) G FQUIT
"RTN","PSDDSOR1",117,0)
 N FFF,NNN,CNT,FVAR,FVAR1,FLIM,HSIG,II
"RTN","PSDDSOR1",118,0)
 I PSOFILE="P" F NNN=0:0 S NNN=$O(^PS(52.41,PSOINTR,"SIG",NNN)) Q:'NNN  S:$G(^(NNN,0))'="" HSIG(NNN)=^(0)
"RTN","PSDDSOR1",119,0)
 I PSOFILE="P" G:'$O(HSIG(0)) FQUIT G FSTART
"RTN","PSDDSOR1",120,0)
 S FFF=1 F NNN=0:0 S NNN=$O(^PSRX(PSOINTR,"SIG1",NNN)) Q:'NNN  I $G(^(NNN,0))'="" S HSIG(FFF)=^(0) S FFF=FFF+1
"RTN","PSDDSOR1",121,0)
 G:'$O(HSIG(0)) FQUIT
"RTN","PSDDSOR1",122,0)
FSTART S (FVAR,FVAR1)="",II=1
"RTN","PSDDSOR1",123,0)
 F FFF=0:0 S FFF=$O(HSIG(FFF)) Q:'FFF  S CNT=0 F NNN=1:1:$L(HSIG(FFF)) I $E(HSIG(FFF),NNN)=" "!($L(HSIG(FFF))=NNN) S CNT=CNT+1 D  I $L(FVAR)>PSOLENTH S FSIG(II)=FLIM_" ",II=II+1,FVAR=FVAR1
"RTN","PSDDSOR1",124,0)
 .S FVAR1=$P(HSIG(FFF)," ",(CNT))
"RTN","PSDDSOR1",125,0)
 .S FLIM=FVAR
"RTN","PSDDSOR1",126,0)
 .S FVAR=$S(FVAR="":FVAR1,1:FVAR_" "_FVAR1)
"RTN","PSDDSOR1",127,0)
 I $G(FVAR)'="" S FSIG(II)=FVAR
"RTN","PSDDSOR1",128,0)
 I $G(FSIG(1))=""!($G(FSIG(1))=" ") S FSIG(1)=$G(FSIG(2)) K FSIG(2)
"RTN","PSDDSOR1",129,0)
FQUIT Q
"RTN","PSDSUBOX")
0^2^B34180714^B32552011
"RTN","PSDSUBOX",1,0)
PSDSUBOX ;BHAM ISC/JAM - DEA DATA - Waived Practitioner Report ;05 July 2011 5:30 pm
"RTN","PSDSUBOX",2,0)
 ;;3.0;CONTROLLED SUBSTANCES;**73,83**;13 Feb 97;Build 10
"RTN","PSDSUBOX",3,0)
 ;External reference to ^PS(59 supported by DBIA #2621
"RTN","PSDSUBOX",4,0)
 ;External reference to ^PSRX( supported by DBIA #1977
"RTN","PSDSUBOX",5,0)
 ;External reference to ^PSDRUG( supported by DBIA #221
"RTN","PSDSUBOX",6,0)
 ;
"RTN","PSDSUBOX",7,0)
 ;ask division/site
"RTN","PSDSUBOX",8,0)
 N PSDIV,PSPRV,RPTYP,PSDED,PSDBD,PSDSD
"RTN","PSDSUBOX",9,0)
 D DIVSEL(.PSDIV) I $G(PSDIV)="^" G EXIT
"RTN","PSDSUBOX",10,0)
 I $G(PSDIV)="^ALL" S PSDIV=0 F  S PSDIV=$O(^PS(59,PSDIV)) Q:'PSDIV  I $S('$D(^PS(59,+PSDIV,"I")):1,'^("I"):1,DT'>^("I"):1,1:0) S PSDIV(PSDIV)=""
"RTN","PSDSUBOX",11,0)
 I '$D(PSDIV) G EXIT
"RTN","PSDSUBOX",12,0)
 ;
"RTN","PSDSUBOX",13,0)
DATE ;ask date range
"RTN","PSDSUBOX",14,0)
 W ! K %DT S %DT(0)=-DT,%DT="AEP",%DT("A")="Start Date: " D ^%DT
"RTN","PSDSUBOX",15,0)
 I Y<0!($D(DTOUT)) G EXIT
"RTN","PSDSUBOX",16,0)
 S (%DT(0),PSDBD)=Y,%DT("A")="End Date: "
"RTN","PSDSUBOX",17,0)
 W ! D ^%DT I Y<0!($D(DTOUT)) G EXIT
"RTN","PSDSUBOX",18,0)
 S PSDED=Y,PSDSD=PSDBD-.000001
"RTN","PSDSUBOX",19,0)
PRV ;ask provider(s)
"RTN","PSDSUBOX",20,0)
 W !!,?5,"You may select a single provider, several providers,",!,?5,"or enter ^ALL to select all providers.",!!
"RTN","PSDSUBOX",21,0)
 K PRV,DIC S DIC("A")="Select Provider: ",DIC=200,DIC(0)="QEAM"
"RTN","PSDSUBOX",22,0)
 S DIC("S")="I $D(^(""PS"")),$P(^(""PS""),""^""),$S('$P(^(""PS""),""^"",4):1,1:$P(^(""PS""),""^"",4)'<DT)"
"RTN","PSDSUBOX",23,0)
 F  D ^DIC Q:+Y<0  S PSPRV(+Y)=""
"RTN","PSDSUBOX",24,0)
 K DIC I $$UP^XLFSTR(X)="^ALL" K DUOUT G TYP
"RTN","PSDSUBOX",25,0)
 I ($D(DUOUT))!($D(DTOUT)) G EXIT
"RTN","PSDSUBOX",26,0)
 I '$D(PSPRV)&(Y<0) G PRV
"RTN","PSDSUBOX",27,0)
TYP  ;ask report selection - detail or summary
"RTN","PSDSUBOX",28,0)
 S DIR(0)="SA^D:Detailed;S:Summary",DIR("A")="Detailed/Summary Report: ",DIR("B")="D"
"RTN","PSDSUBOX",29,0)
 D ^DIR
"RTN","PSDSUBOX",30,0)
 I $D(DIRUT) G EXIT
"RTN","PSDSUBOX",31,0)
 S RPTYP=Y
"RTN","PSDSUBOX",32,0)
 W ! K %ZIS,IOP,IO("Q"),POP S %ZIS="QM",%ZIS("B")="" D ^%ZIS I POP W !!,"NO DEVICE SELECTED OR REPORT PRINTED!!",! K IOP G EXIT
"RTN","PSDSUBOX",33,0)
 I $D(IO("Q")) D  G EXIT
"RTN","PSDSUBOX",34,0)
 .S ZTRTN="RPT^PSDSUBOX",ZTDESC="DEA Waived Practitioner Report",ZTSAVE("PSDIV(")="",ZTSAVE("PSPRV(")=""
"RTN","PSDSUBOX",35,0)
 .F G="PSDSD","PSDED","PSDBD","RPTYP" S:$D(@G) ZTSAVE(G)=""
"RTN","PSDSUBOX",36,0)
 .D ^%ZTLOAD W:$D(ZTSK) !,"Report Queued to Print !!",! D HOME^%ZIS K ZTSK,IO("Q")
"RTN","PSDSUBOX",37,0)
 U IO
"RTN","PSDSUBOX",38,0)
 ;
"RTN","PSDSUBOX",39,0)
RPT ;generate report
"RTN","PSDSUBOX",40,0)
 N RXN,ND0,ND2,DRGDA,DRGNM,DEA,DIV,PRVDA,PRVNM,PG,DTM,PATIEN
"RTN","PSDSUBOX",41,0)
 S PG=1,DTM=$$FMTE^XLFDT(DT)
"RTN","PSDSUBOX",42,0)
 K ^TMP("PSDSUBOX",$J),^TMP("PSDSUBOXC",$J)
"RTN","PSDSUBOX",43,0)
 F  S PSDSD=$O(^PSRX("AFDT",PSDSD)) Q:'PSDSD!(PSDSD>(PSDED+.99))  D
"RTN","PSDSUBOX",44,0)
 .S RXN=0 F  S RXN=$O(^PSRX("AFDT",PSDSD,RXN)) Q:'RXN  D
"RTN","PSDSUBOX",45,0)
 ..S ND0=$G(^PSRX(RXN,0)),DRGDA=$P(ND0,"^",6),DRGNM=$$GET1^DIQ(50,DRGDA,.01),DEA=$$GET1^DIQ(50,DRGDA,3),PATIEN=$P(ND0,U,2)
"RTN","PSDSUBOX",46,0)
 ..Q:DEA<1  Q:DEA>5  Q:'$$DETOX^PSSOPKI(DRGDA)
"RTN","PSDSUBOX",47,0)
 ..S ND2=$G(^PSRX(RXN,2)),DIV=$P(ND2,"^",9),PRVDA=$P(ND0,"^",4),PRVNM=$$GET1^DIQ(59,PRVDA,.01)
"RTN","PSDSUBOX",48,0)
 ..I '$D(PSDIV(+DIV)) Q
"RTN","PSDSUBOX",49,0)
 ..I $D(PSPRV) I '$D(PSPRV(+PRVDA)) Q
"RTN","PSDSUBOX",50,0)
 ..D SETMP
"RTN","PSDSUBOX",51,0)
 D PRT
"RTN","PSDSUBOX",52,0)
 ;
"RTN","PSDSUBOX",53,0)
EXIT D ^%ZISC K PG,G,DR,X,Y,DIR,DIRUT,DUOUT,I,Y,DIC,DTOUT,%DT
"RTN","PSDSUBOX",54,0)
 K ZTDESC,ZTRTN,ZTSAVE S:$D(ZTQUEUED) ZTREQ="@" K ZTQUEUED D KVA^VADPT
"RTN","PSDSUBOX",55,0)
 Q
"RTN","PSDSUBOX",56,0)
 ;
"RTN","PSDSUBOX",57,0)
SETMP ;set ^TMP("PSDSUBOX",$J global
"RTN","PSDSUBOX",58,0)
 N DRUGINFO,PROVIEN
"RTN","PSDSUBOX",59,0)
 S DRUGINFO=$E(DRGNM,1,50)_"^"_DRGDA
"RTN","PSDSUBOX",60,0)
 S PROVIEN=$E(PRVNM,1,50)_"^"_PRVDA
"RTN","PSDSUBOX",61,0)
 ;S ^TMP("PSDSUBOX",$J,DIV,DRUGINFO,PROVIEN)=$G(^TMP("PSDSUBOX",$J,DIV,DRUGINFO,PROVIEN))+1
"RTN","PSDSUBOX",62,0)
 S ^TMP("PSDSUBOX",$J,DIV,PROVIEN,DRUGINFO,RXN)=""
"RTN","PSDSUBOX",63,0)
 I '$D(^TMP("PSDSUBOXC",$J,DIV,PROVIEN,PATIEN)) D
"RTN","PSDSUBOX",64,0)
 .S ^TMP("PSDSUBOXC",$J,DIV,PROVIEN,PATIEN)=""
"RTN","PSDSUBOX",65,0)
 .S ^TMP("PSDSUBOXC",$J,DIV,PROVIEN)=$G(^TMP("PSDSUBOXC",$J,DIV,PROVIEN))+1
"RTN","PSDSUBOX",66,0)
 Q
"RTN","PSDSUBOX",67,0)
 ;
"RTN","PSDSUBOX",68,0)
PRT ;prints report
"RTN","PSDSUBOX",69,0)
 N DIV,DRG,PRV,PSDATE,PEDATE,PSDOUT
"RTN","PSDSUBOX",70,0)
 S PSDOUT=0,PSDATE=$$FMTE^XLFDT(PSDBD),PEDATE=$$FMTE^XLFDT(PSDED)
"RTN","PSDSUBOX",71,0)
 I '$D(^TMP("PSDSUBOX",$J)) D HD W !,?25,"***NO DATA FOUND FOR SELECTION***",!! D HD1^PSDDSOR I $D(DIRUT) Q
"RTN","PSDSUBOX",72,0)
 S DIV=0 F  S DIV=$O(^TMP("PSDSUBOX",$J,DIV)) Q:'DIV  D  I PSDOUT Q
"RTN","PSDSUBOX",73,0)
 .D HD,PGCHK I PSDOUT Q
"RTN","PSDSUBOX",74,0)
 .S PRV="" F  S PRV=$O(^TMP("PSDSUBOX",$J,DIV,PRV)) Q:PRV=""  D  I PSDOUT Q
"RTN","PSDSUBOX",75,0)
 ..I RPTYP="S" W !,$$GET1^DIQ(200,$P(PRV,"^",2),.01),?60,$G(^TMP("PSDSUBOXC",$J,DIV,PRV))
"RTN","PSDSUBOX",76,0)
 ..S DRG="" F  S DRG=$O(^TMP("PSDSUBOX",$J,DIV,PRV,DRG)) Q:DRG=""  D  I PSDOUT Q
"RTN","PSDSUBOX",77,0)
 ...D PRT1 Q:PSDOUT  D PGCHK
"RTN","PSDSUBOX",78,0)
 ..I RPTYP="S" W !
"RTN","PSDSUBOX",79,0)
 Q
"RTN","PSDSUBOX",80,0)
 ;
"RTN","PSDSUBOX",81,0)
PRT1 ;print report details
"RTN","PSDSUBOX",82,0)
 N ND0,LIN,DFN,PL,EE
"RTN","PSDSUBOX",83,0)
 ;/BLB/ PSD*83 - ADDED NEW COUNTER TO CORRECTLY COUNT PATIENTS PRESCRIBED SUBOXONE
"RTN","PSDSUBOX",84,0)
 I RPTYP="S" W !?3,$P(DRG,"^") Q
"RTN","PSDSUBOX",85,0)
 S RXN=0 F  S RXN=$O(^TMP("PSDSUBOX",$J,DIV,PRV,DRG,RXN)) Q:'RXN  D  Q:PSDOUT
"RTN","PSDSUBOX",86,0)
 .S ND0=$G(^PSRX(RXN,0)),DFN=$P(ND0,"^",2)
"RTN","PSDSUBOX",87,0)
 .W ?2,"Issue Date: ",$$FMTE^XLFDT($P(ND0,"^",13))
"RTN","PSDSUBOX",88,0)
 .D DEM^VADPT,ADD^VADPT
"RTN","PSDSUBOX",89,0)
 .W !?2,"Patient: ",VADM(1)
"RTN","PSDSUBOX",90,0)
 .W !?2,VAPA(1),$S(VAPA(2)'="":", "_VAPA(2),1:"")
"RTN","PSDSUBOX",91,0)
 .I VAPA(3)'="" W !?2,VAPA(3)
"RTN","PSDSUBOX",92,0)
 .W !?2,$S(VAPA(4)'="":VAPA(4)_", ",1:""),$P(VAPA(5),"^",2)," ",VAPA(6)
"RTN","PSDSUBOX",93,0)
 .D PGCHK I PSDOUT Q
"RTN","PSDSUBOX",94,0)
 .W !!?2,$$GET1^DIQ(50,$P(DRG,"^",2),.01),?50,"Qty: ",$P(ND0,"^",7),?60,"# of Refills: ",$P(ND0,"^",9)
"RTN","PSDSUBOX",95,0)
 .D FSIG^PSDDSOR1("R",RXN,75)
"RTN","PSDSUBOX",96,0)
 .I $G(FSIG(1))'="" D
"RTN","PSDSUBOX",97,0)
 ..W !?2,"SIG: ",$$UNESC^ORHLESC($G(FSIG(1)))
"RTN","PSDSUBOX",98,0)
 ..I $O(FSIG(1)) D
"RTN","PSDSUBOX",99,0)
 ...F EE=1:0 S EE=$O(FSIG(EE)) Q:'EE  D
"RTN","PSDSUBOX",100,0)
 ....W !?6,$$UNESC^ORHLESC($G(FSIG(EE)))
"RTN","PSDSUBOX",101,0)
 .D PGCHK I PSDOUT Q
"RTN","PSDSUBOX",102,0)
 .W !!?2,"Provider: ",$$GET1^DIQ(200,$P(ND0,"^",4),.01),!
"RTN","PSDSUBOX",103,0)
 .D VADR($$GET1^DIQ(52,RXN,39.3,"I"),.VADR)
"RTN","PSDSUBOX",104,0)
 .I $D(VADR(1)) W ?2,$P(VADR(1),"^"),!?2,VADR(2),!?2,VADR(3),!
"RTN","PSDSUBOX",105,0)
 .F LIN=1:1:80 W "="
"RTN","PSDSUBOX",106,0)
 .D PGCHK I PSDOUT Q
"RTN","PSDSUBOX",107,0)
 ; PSD*3.0*83 - cleaning up FSIG
"RTN","PSDSUBOX",108,0)
 K FSIG,VADM,VADR,VAPA
"RTN","PSDSUBOX",109,0)
 Q
"RTN","PSDSUBOX",110,0)
HD ;header
"RTN","PSDSUBOX",111,0)
 N DVL,DVN,LIN
"RTN","PSDSUBOX",112,0)
 W @IOF,?22,"DEA DATA-Waived Practitioner Report",?67,DTM,!,?32,$S(RPTYP="D":"Detailed",1:"Summary")_" Report"
"RTN","PSDSUBOX",113,0)
 S DVN=$P($G(^PS(59,+$G(DIV),0)),"^",1),DVL=80-(9+$L(DVN))/2
"RTN","PSDSUBOX",114,0)
 I DVN'="" W !?DVL,"DIVISION: ",DVN
"RTN","PSDSUBOX",115,0)
 W !?26,PSDATE_" to "_PEDATE,?70,"Page: "_PG,!
"RTN","PSDSUBOX",116,0)
 I RPTYP="S" W !,"PROVIDER/DRUG",?55,"# OF PATIENTS",!
"RTN","PSDSUBOX",117,0)
 F LIN=1:1:80 W "-"
"RTN","PSDSUBOX",118,0)
 S PG=PG+1
"RTN","PSDSUBOX",119,0)
 Q
"RTN","PSDSUBOX",120,0)
PGCHK ;check for page break
"RTN","PSDSUBOX",121,0)
 I ($Y+4)>IOSL D  Q
"RTN","PSDSUBOX",122,0)
 .W ! D HD1^PSDDSOR I $D(DIRUT) S PSDOUT=1 Q
"RTN","PSDSUBOX",123,0)
 .D HD W !
"RTN","PSDSUBOX",124,0)
 Q
"RTN","PSDSUBOX",125,0)
 ;
"RTN","PSDSUBOX",126,0)
DIVSEL(ARY) ;Division selection (one, multiple or ALL)
"RTN","PSDSUBOX",127,0)
 N DIC,DTOUT,DUOUT,QF,Y,X
"RTN","PSDSUBOX",128,0)
 W !!,?5,"You may select a single or multiple Divisions,"
"RTN","PSDSUBOX",129,0)
 W !,?5,"or enter ^ALL to select all Divisions.",!
"RTN","PSDSUBOX",130,0)
 S DIC("S")="I $S('$D(^PS(59,+Y,""I"")):1,'^(""I""):1,DT'>^(""I""):1,1:0)"
"RTN","PSDSUBOX",131,0)
 S DIC="^PS(59,",DIC(0)="QEZAM",DIC("A")="Division: ",QF=0
"RTN","PSDSUBOX",132,0)
 F  D ^DIC Q:X=""  D  Q:QF
"RTN","PSDSUBOX",133,0)
 .I $$UP^XLFSTR(X)="^ALL" K ARY S ARY="^ALL",QF=1 Q
"RTN","PSDSUBOX",134,0)
 .I $D(DTOUT)!$D(DUOUT) K ARY S ARY="^",QF=1 Q
"RTN","PSDSUBOX",135,0)
 .W "   ",$P(Y,"^",2),$S($D(ARY(+Y)):"       (already selected)",1:"")
"RTN","PSDSUBOX",136,0)
 .W ! S ARY(+Y)=""
"RTN","PSDSUBOX",137,0)
 I '$D(ARY) S ARY="^"
"RTN","PSDSUBOX",138,0)
 Q
"RTN","PSDSUBOX",139,0)
VADR(ORN,VADD) ;Get Provider's Address
"RTN","PSDSUBOX",140,0)
 ;ORN: Order IEN (Pointer to file #100)
"RTN","PSDSUBOX",141,0)
 K ^TMP($J,"ORDEA"),VADD
"RTN","PSDSUBOX",142,0)
 D ARCHIVE^ORDEA(ORN)
"RTN","PSDSUBOX",143,0)
 I $D(^TMP($J,"ORDEA",ORN,3)) S VADD=^(3) D
"RTN","PSDSUBOX",144,0)
 .I $P(VADD,"^",2)="" Q
"RTN","PSDSUBOX",145,0)
 .S VADD(1)=$P(VADD,"^",2),VADD(2)=$P(VADD,"^",3)
"RTN","PSDSUBOX",146,0)
 .S VADD(3)=$P(VADD,"^",4)_", "_$P(VADD,"^",5)_" "_$P(VADD,"^",6)
"RTN","PSDSUBOX",147,0)
 K ^TMP($J,"ORDEA")
"RTN","PSDSUBOX",148,0)
 Q
"VER")
8.0^22.2
"BLD",10348,6)
^70
**END**
**END**

