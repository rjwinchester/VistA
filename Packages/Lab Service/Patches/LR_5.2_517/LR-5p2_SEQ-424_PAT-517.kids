Released LR*5.2*517 SEQ #424
Extracted from mail message
**KIDS**:LR*5.2*517^

**INSTALL NAME**
LR*5.2*517
"BLD",11386,0)
LR*5.2*517^LAB SERVICE^0^3190404^y
"BLD",11386,1,0)
^^3^3^3190220^^
"BLD",11386,1,1,0)
This patch will prevent an error in CPRS that is occuring when a user is 
"BLD",11386,1,2,0)
placing a lab test order that has had a site/specimen deleted from the 
"BLD",11386,1,3,0)
lab test setup.
"BLD",11386,4,0)
^9.64PA^^
"BLD",11386,6.3)
5
"BLD",11386,"ABPKG")
n
"BLD",11386,"INID")
^y
"BLD",11386,"INIT")
LR517
"BLD",11386,"KRN",0)
^9.67PA^1.61^23
"BLD",11386,"KRN",.4,0)
.4
"BLD",11386,"KRN",.401,0)
.401
"BLD",11386,"KRN",.402,0)
.402
"BLD",11386,"KRN",.403,0)
.403
"BLD",11386,"KRN",.5,0)
.5
"BLD",11386,"KRN",.84,0)
.84
"BLD",11386,"KRN",1.6,0)
1.6
"BLD",11386,"KRN",1.61,0)
1.61
"BLD",11386,"KRN",1.62,0)
1.62
"BLD",11386,"KRN",3.6,0)
3.6
"BLD",11386,"KRN",3.8,0)
3.8
"BLD",11386,"KRN",9.2,0)
9.2
"BLD",11386,"KRN",9.8,0)
9.8
"BLD",11386,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",11386,"KRN",9.8,"NM",1,0)
LRMLED^^0^B189478521
"BLD",11386,"KRN",9.8,"NM","B","LRMLED",1)

"BLD",11386,"KRN",19,0)
19
"BLD",11386,"KRN",19.1,0)
19.1
"BLD",11386,"KRN",101,0)
101
"BLD",11386,"KRN",409.61,0)
409.61
"BLD",11386,"KRN",771,0)
771
"BLD",11386,"KRN",779.2,0)
779.2
"BLD",11386,"KRN",870,0)
870
"BLD",11386,"KRN",8989.51,0)
8989.51
"BLD",11386,"KRN",8989.52,0)
8989.52
"BLD",11386,"KRN",8994,0)
8994
"BLD",11386,"KRN","B",.4,.4)

"BLD",11386,"KRN","B",.401,.401)

"BLD",11386,"KRN","B",.402,.402)

"BLD",11386,"KRN","B",.403,.403)

"BLD",11386,"KRN","B",.5,.5)

"BLD",11386,"KRN","B",.84,.84)

"BLD",11386,"KRN","B",1.6,1.6)

"BLD",11386,"KRN","B",1.61,1.61)

"BLD",11386,"KRN","B",1.62,1.62)

"BLD",11386,"KRN","B",3.6,3.6)

"BLD",11386,"KRN","B",3.8,3.8)

"BLD",11386,"KRN","B",9.2,9.2)

"BLD",11386,"KRN","B",9.8,9.8)

"BLD",11386,"KRN","B",19,19)

"BLD",11386,"KRN","B",19.1,19.1)

"BLD",11386,"KRN","B",101,101)

"BLD",11386,"KRN","B",409.61,409.61)

"BLD",11386,"KRN","B",771,771)

"BLD",11386,"KRN","B",779.2,779.2)

"BLD",11386,"KRN","B",870,870)

"BLD",11386,"KRN","B",8989.51,8989.51)

"BLD",11386,"KRN","B",8989.52,8989.52)

"BLD",11386,"KRN","B",8994,8994)

"BLD",11386,"QUES",0)
^9.62^^
"BLD",11386,"REQB",0)
^9.611^1^1
"BLD",11386,"REQB",1,0)
LR*5.2*500^2
"BLD",11386,"REQB","B","LR*5.2*500",1)

"INIT")
LR517
"MBREQ")
0
"PKG",26,-1)
1^1
"PKG",26,0)
LAB SERVICE^LR^CORE LAB SYSTEM
"PKG",26,22,0)
^9.49I^1^1
"PKG",26,22,1,0)
5.2^2940927^2981028^66481
"PKG",26,22,1,"PAH",1,0)
517^3190404
"PKG",26,22,1,"PAH",1,1,0)
^^3^3^3190404
"PKG",26,22,1,"PAH",1,1,1,0)
This patch will prevent an error in CPRS that is occuring when a user is 
"PKG",26,22,1,"PAH",1,1,2,0)
placing a lab test order that has had a site/specimen deleted from the 
"PKG",26,22,1,"PAH",1,1,3,0)
lab test setup.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","LR517")
0^^B5492199^n/a
"RTN","LR517",1,0)
LR517 ;HPS/JLG - LR*5.2*517 PATCH POST INSTALL ROUTINE ;Mar 19, 2019@12:00
"RTN","LR517",2,0)
 ;;5.2;LAB SERVICE;**517**;Sep 27, 1994;Build 5
"RTN","LR517",3,0)
 ;
"RTN","LR517",4,0)
 ; $$HTFM^XLFDT supported by DBIA #10103
"RTN","LR517",5,0)
 ; $$SENDMSG^XMXAPI supported by IA #2729
"RTN","LR517",6,0)
 ;
"RTN","LR517",7,0)
EN ;
"RTN","LR517",8,0)
 N LRI,LRSS,LRHDR,LRMTXT,LRCTR,LRDATA,MIDX,MTXT
"RTN","LR517",9,0)
 S LRHDR=1,LRCTR=0
"RTN","LR517",10,0)
 ;
"RTN","LR517",11,0)
 S LRCTR=LRCTR+1,LRMTXT="The following orphaned data was removed from the LABORATORY TEST file (#60): " D SETMSG(LRCTR,LRMTXT)
"RTN","LR517",12,0)
 ;
"RTN","LR517",13,0)
 S LRI=0 F  S LRI=$O(^LAB(60,LRI)) Q:'LRI  D
"RTN","LR517",14,0)
 .S LRSS=0 F  S LRSS=$O(^LAB(60,LRI,1,LRSS)) Q:LRSS=""  D
"RTN","LR517",15,0)
 ..Q:'$D(^LAB(60,LRI,1,LRSS,5))  Q:$D(^LAB(60,LRI,1,LRSS,0)) 
"RTN","LR517",16,0)
 ..S:LRCTR=1 ^XTMP("LR_5.2_517_POST_INSTALL",0)=$$HTFM^XLFDT($H+30,1)_"^"_$$HTFM^XLFDT($H,1)_"^Removing Data from LABORATORY TEST file (#60)"
"RTN","LR517",17,0)
 ..S LRDATA=$G(^LAB(60,LRI,1,LRSS,5)),^XTMP("LR_5.2_517_POST_INSTALL",LRI,LRSS)=LRDATA
"RTN","LR517",18,0)
 ..K ^LAB(60,LRI,1,LRSS,5)
"RTN","LR517",19,0)
 ..S LRCTR=LRCTR+1 D SETMSG(LRCTR," ")
"RTN","LR517",20,0)
 ..S LRMTXT="LAB TEST:       "_$$GET1^DIQ(60,LRI_",",.01)_" (ien: "_LRI_")",LRCTR=LRCTR+1 D SETMSG(LRCTR,LRMTXT)
"RTN","LR517",21,0)
 ..S LRMTXT="SITE/SPECIMEN:  "_$$GET1^DIQ(61,LRSS_",",.01)_" (ien: "_LRSS_")",LRCTR=LRCTR+1 D SETMSG(LRCTR,LRMTXT)
"RTN","LR517",22,0)
 ;
"RTN","LR517",23,0)
 I LRCTR=1 S LRCTR=LRCTR+1 D SETMSG(LRCTR," ") S LRCTR=LRCTR+1 W ! D SETMSG(LRCTR,"NO DATA FOUND TO REMOVE")
"RTN","LR517",24,0)
 S LRCTR=LRCTR+1 D SETMSG(LRCTR," ")
"RTN","LR517",25,0)
 ;
"RTN","LR517",26,0)
MMMSG ; create and send a mailman message
"RTN","LR517",27,0)
 N XMY,XMSUB,XMTEXT,XMFROM,XMDUZ
"RTN","LR517",28,0)
 S XMFROM("FROM")="LR*5.2*517 Post-Install"
"RTN","LR517",29,0)
 S XMY(DUZ)=""
"RTN","LR517",30,0)
 S XMSUB="LR*5.2*517 Data Removal",XMDUZ=.5
"RTN","LR517",31,0)
 S XMTEXT="^TMP($J,""LR517"")"
"RTN","LR517",32,0)
 D SENDMSG^XMXAPI(DUZ,XMSUB,XMTEXT,.XMY,.XMFROM,,"")
"RTN","LR517",33,0)
 K ^TMP($J),XMY,XMSUB,XMTEXT,XMFROM,XMDUZ
"RTN","LR517",34,0)
 Q
"RTN","LR517",35,0)
SETMSG(MIDX,MTXT) ; set global entry for mailman message
"RTN","LR517",36,0)
 S ^TMP($J,"LR517",MIDX)=MTXT
"RTN","LR517",37,0)
 W !,MTXT
"RTN","LR517",38,0)
 Q
"RTN","LRMLED")
0^1^B189478521^B187849781
"RTN","LRMLED",1,0)
LRMLED ;BPFO/DTG - NTRT MESSAGE PROCESS AND EDITS UPDATE ;12/26/2016
"RTN","LRMLED",2,0)
 ;;5.2;LAB SERVICE;**468,500,517**;Sep 27, 1994;Build 5
"RTN","LRMLED",3,0)
 ;
"RTN","LRMLED",4,0)
 ; ESTART is called from a 'NEW' format cross reference on the 60 file AMLTFNTRT
"RTN","LRMLED",5,0)
 ; and will send NTRT message if appropiate.
"RTN","LRMLED",6,0)
EN(LRS,LR60IEN) ; entry point from cross reference
"RTN","LRMLED",7,0)
 ; only have one
"RTN","LRMLED",8,0)
 L +^TMP(LR60IEN,LRS):1 I '$T Q
"RTN","LRMLED",9,0)
 N ZTDTH,ZTRTN,ZTSAVE,ZTIO,ZTSK,ZTDESC
"RTN","LRMLED",10,0)
 ; START OF CHANGE FOR LR*5.2*500
"RTN","LRMLED",11,0)
 ;S ZTDTH=$$NOW^XLFDT,ZTDESC="LAB Create NTRT message from file 60 Cross Reference #491"
"RTN","LRMLED",12,0)
 S B=$H,A=$$HADD^XLFDT(B,,8,,),C=$$HTFM^XLFDT(A)
"RTN","LRMLED",13,0)
 S ZTDTH=C,ZTDESC="LAB Create NTRT message from file 60 Cross Reference #491"
"RTN","LRMLED",14,0)
 S ZTRTN="ESTART^LRMLED("_LR60IEN_","_LRS_")",ZTSAVE("LR60IEN")="",ZTSAVE("LRS")="",ZTIO="",ZTSAVE("LRDUZ")=DUZ
"RTN","LRMLED",15,0)
 D ^%ZTLOAD
"RTN","LRMLED",16,0)
 L -^TMP(LR60IEN,LRS)
"RTN","LRMLED",17,0)
 Q
"RTN","LRMLED",18,0)
 ;
"RTN","LRMLED",19,0)
ESTART(LR60IEN,LRS) ; pick up key data for NTRT
"RTN","LRMLED",20,0)
 Q:$D(LRMLTFREC)
"RTN","LRMLED",21,0)
 L +^TMP(LR60IEN,LRS):30 I '$T Q
"RTN","LRMLED",22,0)
 ;START OF CHANGE FOR LR*5.2*500
"RTN","LRMLED",23,0)
 N LXA,LXB,LXC,LXG,LXD,LXE,LXF,LXH,A,B,C,D,LSITE,LRNT,LRNTI,AR,LRNLT,LRSEC,I,LRNOS1,LRNOS2
"RTN","LRMLED",24,0)
 ;END OF CHANGE FOR LR*5.2*500
"RTN","LRMLED",25,0)
 N LRSITE,LRSITEN,LRGMAIL,LRSMAIL,LRNAMIL,LACT,MAILPERSON,LR64,LRCOM,LRCTY,LRSUBSCRIPT
"RTN","LRMLED",26,0)
 N LRSCHPA,LRSCHNM,ALI,LRTEXT,LR64N,LRDTNM,G
"RTN","LRMLED",27,0)
 S:$G(LRDUZ)="" LRDUZ=$G(DUZ)
"RTN","LRMLED",28,0)
 I $G(DT)="" S DT=$$DT^XLFDT
"RTN","LRMLED",29,0)
 D GET664
"RTN","LRMLED",30,0)
 ; check if allow to send to NTRT
"RTN","LRMLED",31,0)
 ; I $G(LRNTI(.1,"I"))'=1 G EOUT
"RTN","LRMLED",32,0)
 ;
"RTN","LRMLED",33,0)
 ;site number and name
"RTN","LRMLED",34,0)
 S LRSITE=$G(LRNTI(.01,"I")),LRSITEN=$G(LRNTI(.01,"E"))
"RTN","LRMLED",35,0)
 ;ntrt mail group
"RTN","LRMLED",36,0)
 S LRNMAIL=$G(LRNTI(1,"I"))
"RTN","LRMLED",37,0)
 ;lab send mail group
"RTN","LRMLED",38,0)
 S LRGMAIL=$G(LRNTI(2,"I"))
"RTN","LRMLED",39,0)
 ;lab server side mail group
"RTN","LRMLED",40,0)
 S LRSMAIL=$G(LRNTI(3,"I"))
"RTN","LRMLED",41,0)
 ;how to send mail
"RTN","LRMLED",42,0)
 S LACT=$G(LRNTI(.02,"E"))
"RTN","LRMLED",43,0)
 ; get type of test to send
"RTN","LRMLED",44,0)
 S LRSUBSCRIPT=$G(LRNTI(.07,"I")) I LRSUBSCRIPT="" S LRSUBSCRIPT=1 ; default to CH only
"RTN","LRMLED",45,0)
 ; send blood bank?
"RTN","LRMLED",46,0)
 ;
"RTN","LRMLED",47,0)
 S DA=+LR60IEN
"RTN","LRMLED",48,0)
 ;get test
"RTN","LRMLED",49,0)
EA ; .01 test name, 4 subscript (CH), 5 data name, 13 field (DD of 5), 64.1 result nlt code
"RTN","LRMLED",50,0)
 S DIQ="LXB",DIQ(0)="IE",DIC=60,DR=".01;4;64.1;5;13;131;132;133;134;135;137" K ^UTILITY("DIQ1",$J) D EN^DIQ1 K ^UTILITY("DIQ1",$J)
"RTN","LRMLED",51,0)
 K LXA M LXA=LXB(60,DA) K LXB
"RTN","LRMLED",52,0)
 D TDT
"RTN","LRMLED",53,0)
 ; check test subscript is valid for NTRT
"RTN","LRMLED",54,0)
 S A=$G(LXA(4,"I"))
"RTN","LRMLED",55,0)
 I A="WK" G EOUT ; don't send if workload
"RTN","LRMLED",56,0)
 I A="AU" G EOUT
"RTN","LRMLED",57,0)
 I A="EM" G EOUT
"RTN","LRMLED",58,0)
 I A="BB" G EOUT
"RTN","LRMLED",59,0)
 I A="CH"&((LRSUBSCRIPT=1)!(LRSUBSCRIPT=7)!(LRSUBSCRIPT=8)) G EGOOD
"RTN","LRMLED",60,0)
 I A="MI"&((LRSUBSCRIPT=2)!(LRSUBSCRIPT=7)!(LRSUBSCRIPT=8)) G EGOOD
"RTN","LRMLED",61,0)
 ; I A="EM"&((LRSUBSCRIPT=3)!(LRSUBSCRIPT=8)) G EGOOD  ; do not do AU per Leeanne 6/2016
"RTN","LRMLED",62,0)
 I A="SP"&((LRSUBSCRIPT=4)!(LRSUBSCRIPT=8)) G EGOOD
"RTN","LRMLED",63,0)
 I A="CY"&((LRSUBSCRIPT=5)!(LRSUBSCRIPT=8)) G EGOOD
"RTN","LRMLED",64,0)
 ; I A="AU"&((LRSUBSCRIPT=6)!(LRSUBSCRIPT=8)) G EGOOD ; do not do AU per Leeanne 6/2016
"RTN","LRMLED",65,0)
 G EOUT ; doesn't match up
"RTN","LRMLED",66,0)
 ;
"RTN","LRMLED",67,0)
EGOOD ; if the subscript is valid
"RTN","LRMLED",68,0)
 ; check if inactive
"RTN","LRMLED",69,0)
 S A=$G(LXA(132,"I")),B=$G(LXA(133,"I")) I A'=""!(B'="") G EOUT
"RTN","LRMLED",70,0)
 ;get synonyms
"RTN","LRMLED",71,0)
 K B S LXG="",A=0 F I=0:1 S A=$O(^LAB(60,DA,5,A)) Q:'A  S B(I)=$P(^LAB(60,DA,5,A,0),U,1)
"RTN","LRMLED",72,0)
 I I>0 S B=I-1 F I=0:1:B D  I $L(LXG)>210 Q
"RTN","LRMLED",73,0)
 . I LXG="" S LXG=B(I) Q
"RTN","LRMLED",74,0)
 . S LXG=LXG_U_B(I)
"RTN","LRMLED",75,0)
 ;get nlt number
"RTN","LRMLED",76,0)
 S LR64=$G(LXA(64.1,"I")),(LRNLT,LRSEC)="",LR64N=$G(LXA(64.1,"E"))
"RTN","LRMLED",77,0)
 I LR64'="" S LRNLT=$G(^LAM(LR64,0)),A=$P(LRNLT,U,15),LRNLT=$P(LRNLT,U,2)
"RTN","LRMLED",78,0)
 I A'="" S LRSEC=$P($G(^LAB(64.21,A,0)),U,2)
"RTN","LRMLED",79,0)
 ;get comment / data type from comment
"RTN","LRMLED",80,0)
 S (LRCOM,LRCTY,LRDTNM)="",A=$G(LXA(13,"I")),LRDTNM=$P($G(LXA(5,"I")),";",2)
"RTN","LRMLED",81,0)
 I A'="" S B=$$ETSTTYP(A),LRCOM=$P(B,"|",1),LRCTY=$P(B,"|",2) S:$P(B,"|",3)'="" LRDTNM=LRDTNM_" - "_$P(B,"|",3)
"RTN","LRMLED",82,0)
 ;START OF CHANGE FOR LR*5.2*500
"RTN","LRMLED",83,0)
 ; get the performing labs
"RTN","LRMLED",84,0)
 D LIST^DIC(60.16,","_DA_",","@;.01;1","",,,,,,,"LXB")
"RTN","LRMLED",85,0)
 K LXH M LXH=LXB("DILIST","ID") K LXB
"RTN","LRMLED",86,0)
 ;END OF CHANGE FOR LR*5.2*500
"RTN","LRMLED",87,0)
 ; get specimen info
"RTN","LRMLED",88,0)
ES ; LRS is passed in and is the specimen IEN
"RTN","LRMLED",89,0)
 S DIQ="LXB",DIQ(0)="IE",DIC=60,DR=100,DA=+LR60IEN K LXB,^UTILITY("DIQ1",$J)
"RTN","LRMLED",90,0)
 S DR(60.01)=".01;6;1;2;9.2;9.3;13;30;32;33;34;35",DA(60.01)=LRS
"RTN","LRMLED",91,0)
 D EN^DIQ1 K ^UTILITY("DIQ1",$J)
"RTN","LRMLED",92,0)
 K LXC M LXC=LXB("60.01",LRS) K LXB
"RTN","LRMLED",93,0)
 ; get the specimen INTERPRETATION
"RTN","LRMLED",94,0)
 D GETS^DIQ(60.01,LRS_","_DA,"5.5","","LXB")
"RTN","LRMLED",95,0)
 K LXE M LXE=LXB(60.01,LRS_","_DA_",",5.5) K LXB
"RTN","LRMLED",96,0)
 ; don't do if MLTF already associated
"RTN","LRMLED",97,0)
 I $G(LXC(30,"I"))'="" G EOUT
"RTN","LRMLED",98,0)
 ; don't do if inactive or already sent
"RTN","LRMLED",99,0)
 S A=$G(LXC(32,"I")),B=$G(LXC(33,"I")),C=$G(LXC(34,"I")) I $E(A,1)="Y"!(B'="")!($E(C,1)="Y") G EOUT
"RTN","LRMLED",100,0)
 ;if no send method or not allowed to send to NTRT
"RTN","LRMLED",101,0)
 ;START OF CHANGE FOR LR*5.2*500
"RTN","LRMLED",102,0)
 S LRNOS1=0 I LACT=""!($G(LRNTI(.02,"I"))="N")!($G(LRNTI(.1,"I"))'=1) S LRNOS1=1
"RTN","LRMLED",103,0)
 ;END OF CHANGE FOR LR*5.2*500
"RTN","LRMLED",104,0)
 S A=$TR(LRGMAIL,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","LRMLED",105,0)
 S LRNOS2=0 I '$$PROD^XUPROD()!(LRGMAIL'["DOMAIN.EXT") S LRNOS2=1
"RTN","LRMLED",106,0)
 I LACT=""!($E(LACT,1)="N") D MAILMAN G EOUT
"RTN","LRMLED",107,0)
 D @LACT
"RTN","LRMLED",108,0)
 ;put exception flag in 60 file
"RTN","LRMLED",109,0)
 ; since making exception flag uneditable must do physical set
"RTN","LRMLED",110,0)
 ;START OF CHANGE FOR LR*5.2*500
"RTN","LRMLED",111,0)
 ;I (LRNOS1'=1&(LRNOS2'=1)) D  ;<
"RTN","LRMLED",112,0)
 G:'$G(^LAB(60,LR60IEN,1,LRS,0)) EOUT ; p517 exit if missing 0 node rec for SITE/SPECIMEN
"RTN","LRMLED",113,0)
 N A,B,LRO,LRN,I S A=$G(^LAB(60,LR60IEN,1,LRS,5)),B=A,$P(B,U,3)="Y",^LAB(60,LR60IEN,1,LRS,5)=B
"RTN","LRMLED",114,0)
 ; need to build array for saving in audit section
"RTN","LRMLED",115,0)
 F I=1,2,4 S LRO(I)="",LRN(I)=""
"RTN","LRMLED",116,0)
 S LRO(3)=$P(A,U,3),LRN(3)=$P(B,U,3)
"RTN","LRMLED",117,0)
 N ZTDTH,ZTRTN,ZTSAVE,ZTIO,ZTSK,ZTDESC
"RTN","LRMLED",118,0)
 S ZTDTH=$$NOW^XLFDT,ZTDESC="LAB Edit Save of Deployed Flag"
"RTN","LRMLED",119,0)
 S ZTRTN="SEDA^LRMLED("_LRS_","_LR60IEN_")",ZTSAVE("LR60IEN")="",ZTSAVE("LRS")=""
"RTN","LRMLED",120,0)
 S ZTSAVE("LRN(")="",ZTSAVE("LRO(")=""
"RTN","LRMLED",121,0)
 S ZTIO=""
"RTN","LRMLED",122,0)
 D ^%ZTLOAD
"RTN","LRMLED",123,0)
 ;END OF CHANGE FOR LR*5.2*500
"RTN","LRMLED",124,0)
 G EOUT
"RTN","LRMLED",125,0)
 ;
"RTN","LRMLED",126,0)
MAILMAN ;mailman
"RTN","LRMLED",127,0)
 N XMSUB,XMY,XMTEXT,LRTEXT,XMDUZ,DA,DR,DIE
"RTN","LRMLED",128,0)
 ;
"RTN","LRMLED",129,0)
 I LRNMAIL="" Q  ; missing NTRT recipient
"RTN","LRMLED",130,0)
 ;
"RTN","LRMLED",131,0)
 S XMSUB="NEW NTRT REQUEST FOR LABORATORY"
"RTN","LRMLED",132,0)
 ;S XMY(DUZ)=""
"RTN","LRMLED",133,0)
 S XMY(LRDUZ)=""
"RTN","LRMLED",134,0)
 ; send to NTRT if ntrt mail group and send method and production/va site
"RTN","LRMLED",135,0)
 I LRNMAIL'="" S XMY(LRNMAIL)="" I LRNOS1=1!(LRNOS2=1) K XMY(LRNMAIL)
"RTN","LRMLED",136,0)
 ;
"RTN","LRMLED",137,0)
 I LRGMAIL'="" S XMDUZ("New Test/Specimen NTRT Request From: "_$E(LRSITEN,1,30))="",XMY($P(LRGMAIL,"@",1))=""
"RTN","LRMLED",138,0)
 S ALI=0
"RTN","LRMLED",139,0)
 I LRNOS1=1!(LRNOS2=1) D  ;<
"RTN","LRMLED",140,0)
 . S ALI=$$LRTP(ALI),LRTEXT(ALI)="***  THIS TEST/SPECIMEN WAS NOT SENT TO NTRT ***"
"RTN","LRMLED",141,0)
 . S A="" S:LRNOS1=1 A="Missing Send Method" S A=A_$S((LRNOS2=1&(A'="")):" and ",1:""),A=A_$S(LRNOS2=1:"Facility is Either Not Production or Not a VA Site",1:"")
"RTN","LRMLED",142,0)
 . S ALI=$$LRTP(ALI),LRTEXT(ALI)=A
"RTN","LRMLED",143,0)
 . S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",144,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="A new Laboratory Test has been entered at: "_LRSITEN
"RTN","LRMLED",145,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",146,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Facility Name/Number: "_LRSITEN_" / "_LRSITE
"RTN","LRMLED",147,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",148,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="For questions or notifications respond to: "_LRGMAIL
"RTN","LRMLED",149,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",150,0)
 ; S LRTEXT(6)="For NTRT results respond to :"_LRSMAIL
"RTN","LRMLED",151,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",152,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",153,0)
 I $G(LRRESEND)=1 S ALI=$$LRTP(ALI),LRTEXT(ALI)=" **** THIS TEST/SPECIMEN IS BEING RESENT ****"
"RTN","LRMLED",154,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="New Laboratory Test Name: "_$G(LXA(.01,"I"))
"RTN","LRMLED",155,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",156,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="New Laboratory Test LOCAL IEN: "_(+LR60IEN)
"RTN","LRMLED",157,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",158,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Laboratory Test Site/Specimen Number (IEN): "_$G(LXC(.01,"I"))
"RTN","LRMLED",159,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",160,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Laboratory Test Site/Specimen Name: "_$G(LXC(.01,"E"))
"RTN","LRMLED",161,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",162,0)
 S B="",A=$G(LXC(.01,"I")) I A S A=$G(^LAB(61,A,0)),B=$P(A,U,10) I +B>0 S B=$P($G(^LAB(64.061,B,0)),U,1)
"RTN","LRMLED",163,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",164,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Spec: "_$P(A,U,1)
"RTN","LRMLED",165,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",166,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Time Aspect: "_B
"RTN","LRMLED",167,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",168,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Units: "_$G(LXC(6,"I"))
"RTN","LRMLED",169,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",170,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="RNLT: "_LRNLT
"RTN","LRMLED",171,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",172,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Lab Section: "_LRSEC
"RTN","LRMLED",173,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",174,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Subscript: "_$G(LXA(4,"I"))
"RTN","LRMLED",175,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",176,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Data Name: "_LRDTNM
"RTN","LRMLED",177,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",178,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Data Comment: "_LRCOM
"RTN","LRMLED",179,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",180,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Data Type: "_LRCTY
"RTN","LRMLED",181,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",182,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Reference Low: "_$G(LXC(1,"I"))
"RTN","LRMLED",183,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",184,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Reference High: "_$G(LXC(2,"I"))
"RTN","LRMLED",185,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",186,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Therapeutic Low: "_$G(LXC(9.2,"I"))
"RTN","LRMLED",187,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",188,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Therapeutic High: "_$G(LXC(9.3,"I"))
"RTN","LRMLED",189,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",190,0)
 ; S A=$G(LXC(13,"I")),B=$S(A=1:"YES",1:"NO")
"RTN","LRMLED",191,0)
 ; S ALI=$$LRTP(ALI),LRTEXT(ALI)="Use Ref Lab: "_B
"RTN","LRMLED",192,0)
 ; S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",193,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Test Synonyms: "_LXG
"RTN","LRMLED",194,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",195,0)
 ; F I=10:2:44 S LRTEXT(I)=""
"RTN","LRMLED",196,0)
 S E=0 F I=1:1 S E=$O(LXE(E)) Q:'E  S G=LXE(E),ALI=$$LRTP(ALI),LRTEXT(ALI)=$S(I=1:"Specimen Interpretation: ",1:"                         ")_G
"RTN","LRMLED",197,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",198,0)
 ;START OF CHANGE FOR LR*5.2*500
"RTN","LRMLED",199,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Test Creation Date: "_$G(LXA(131,"E"))
"RTN","LRMLED",200,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",201,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Specimen Create Date: "_$G(LXC(35,"E"))
"RTN","LRMLED",202,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",203,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="In-House Test: "_$G(LXA(134,"E"))
"RTN","LRMLED",204,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",205,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="POC Test: "_$G(LXA(135,"E"))
"RTN","LRMLED",206,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",207,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Scanned Image Test: "_$G(LXA(137,"E"))
"RTN","LRMLED",208,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",209,0)
 S E=0 F I=0:1 S E=$O(LXH(E)) Q:'E&I  D  Q:'E
"RTN","LRMLED",210,0)
 . S ALI=$$LRTP(ALI),LRTEXT(ALI)="Performing Lab: "_$G(LXH(+E,.01))
"RTN","LRMLED",211,0)
 . S ALI=$$LRTP(ALI),LRTEXT(ALI)="    Order Code: "_$G(LXH(+E,1))
"RTN","LRMLED",212,0)
 . S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",213,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)="Site Notes:"
"RTN","LRMLED",214,0)
 N STNTDT S STNTDT=9999999 F  S STNTDT=$O(^LAB(60,LR60IEN,11,"B",STNTDT),-1) Q:'STNTDT  D
"RTN","LRMLED",215,0)
 . N STNTIEN,I
"RTN","LRMLED",216,0)
 . S ALI=$$LRTP(ALI),LRTEXT(ALI)="Site Notes Date: "_$$FMTE^XLFDT(STNTDT)
"RTN","LRMLED",217,0)
 . S STNTIEN=0 S STNTIEN=$O(^LAB(60,+LR60IEN,11,"B",STNTDT,STNTIEN)) Q:'STNTIEN  D  S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",218,0)
 . . S I=0 F  S I=$O(^LAB(60,+LR60IEN,11,STNTIEN,1,I)) Q:'I  D
"RTN","LRMLED",219,0)
 . . . S ALI=$$LRTP(ALI),LRTEXT(ALI)=$G(^LAB(60,+LR60IEN,11,STNTIEN,1,I,0))
"RTN","LRMLED",220,0)
 S ALI=$$LRTP(ALI),LRTEXT(ALI)=""
"RTN","LRMLED",221,0)
 ;END OF CHANGE FOR LR*5.2*500
"RTN","LRMLED",222,0)
 S XMTEXT="LRTEXT(" D ^XMD
"RTN","LRMLED",223,0)
 ;
"RTN","LRMLED",224,0)
 Q
"RTN","LRMLED",225,0)
 ;
"RTN","LRMLED",226,0)
CTCHK(LR60IEN) ; check if the test is valid for create date and it hasn't been set previously
"RTN","LRMLED",227,0)
 ; is the test valid for update
"RTN","LRMLED",228,0)
 N A,B,C,LSITE,LRNT
"RTN","LRMLED",229,0)
 S A=$$GET1^DIQ(60,LR60IEN_",",131)
"RTN","LRMLED",230,0)
 I A'="" Q 0
"RTN","LRMLED",231,0)
 S LSITE=$$SITE^VASITE,LSITE=$P(LSITE,U,1)
"RTN","LRMLED",232,0)
 S LRNT=$O(^LAB(66.4,"B",LSITE,0))
"RTN","LRMLED",233,0)
 I +LRNT<1 Q 0
"RTN","LRMLED",234,0)
 S A=$$GET1^DIQ(66.4,LRNT_",",.06)
"RTN","LRMLED",235,0)
 I A&(A>(LR60IEN-1)) Q 0
"RTN","LRMLED",236,0)
 Q 1
"RTN","LRMLED",237,0)
 ;
"RTN","LRMLED",238,0)
NSP(LR6001IEN,LR60IEN) ; entry to set specimen date if new specimen
"RTN","LRMLED",239,0)
 N ZTDTH,ZTRTN,ZTSAVE,ZTIO,ZTSK,ZTDESC,LRN,LRO
"RTN","LRMLED",240,0)
 ; X1-old array  X2-new array
"RTN","LRMLED",241,0)
 M LRO=X1,LRN=X2
"RTN","LRMLED",242,0)
 S ZTDTH=$$NOW^XLFDT,ZTDESC="LAB Edit Save from file 60 Cross Reference #490"
"RTN","LRMLED",243,0)
 S ZTRTN="NSPA^LRMLED("_LR6001IEN_","_LR60IEN_")",ZTSAVE("LR60IEN")="",ZTSAVE("LR6001IEN")=""
"RTN","LRMLED",244,0)
 S ZTSAVE("LRN(")="",ZTSAVE("LRO(")=""
"RTN","LRMLED",245,0)
 S ZTIO=""
"RTN","LRMLED",246,0)
 D ^%ZTLOAD
"RTN","LRMLED",247,0)
 Q
"RTN","LRMLED",248,0)
 ;
"RTN","LRMLED",249,0)
NSPA(LRDA,LRDA1) ; save specimen create date if new specimen for test
"RTN","LRMLED",250,0)
 ; (1)-.01 SITE/SPECIMEN
"RTN","LRMLED",251,0)
 ; LRDA - specimen IEN
"RTN","LRMLED",252,0)
 ; LRDA1 - test IEN
"RTN","LRMLED",253,0)
 ; LRO-old array  LRN-new array
"RTN","LRMLED",254,0)
 Q:$D(LRMLTFREC)
"RTN","LRMLED",255,0)
 N A,B,C,D,E,F,DA
"RTN","LRMLED",256,0)
 N DR,DIE,DIC,X
"RTN","LRMLED",257,0)
 I $G(LRO(1))'=""!($G(LRN(1))="") G NSPQ
"RTN","LRMLED",258,0)
 S DA=LRDA,DA(1)=LRDA1
"RTN","LRMLED",259,0)
 S A=$$GET1^DIQ(60.01,DA_","_DA(1),35,"I")
"RTN","LRMLED",260,0)
 I A'="" G NSPQ
"RTN","LRMLED",261,0)
 I $G(DT)="" S DT=$$DT^XLFDT
"RTN","LRMLED",262,0)
 S DIE="^LAB(60,"_DA(1)_",1,",DR="35///"_DT
"RTN","LRMLED",263,0)
 D ^DIE
"RTN","LRMLED",264,0)
 G NSPQ
"RTN","LRMLED",265,0)
 ;
"RTN","LRMLED",266,0)
NSPQ ; quit
"RTN","LRMLED",267,0)
 K A,B,C,D,E,F,DA,DR,DIE,DIC,X
"RTN","LRMLED",268,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","LRMLED",269,0)
 Q
"RTN","LRMLED",270,0)
 ;
"RTN","LRMLED",271,0)
TDT ;place creation date in test
"RTN","LRMLED",272,0)
 I $G(LXA(131,"I"))'="" Q  ; date already on file
"RTN","LRMLED",273,0)
 S A=$G(LRNTI(".06","I")) I A&(A>(LR60IEN-1)) Q  ; only set if test added after patch 468 load
"RTN","LRMLED",274,0)
 N DA,DR,DIE
"RTN","LRMLED",275,0)
 L +^LAB(60,LR60IEN):30 I '$T Q
"RTN","LRMLED",276,0)
 S DA=+LR60IEN,DR="131///"_DT,DIE="^LAB(60," D ^DIE
"RTN","LRMLED",277,0)
 L -^LAB(60,LR60IEN)
"RTN","LRMLED",278,0)
 Q
"RTN","LRMLED",279,0)
 ;
"RTN","LRMLED",280,0)
SDT ; place specimen creation dt
"RTN","LRMLED",281,0)
 I $G(LXC(35,"I"))'="" Q  ; date on file
"RTN","LRMLED",282,0)
 N DA,DR,DIE
"RTN","LRMLED",283,0)
 L +^LAB(60,LR60IEN,1,LRS):30 I '$T Q
"RTN","LRMLED",284,0)
 S DA(1)=+LR60IEN,DA=LRS,DR="35///"_DT,DIE="^LAB(60,"_DA(1)_",1," D ^DIE
"RTN","LRMLED",285,0)
 L -^LAB(60,LR60IEN,1,LRS)
"RTN","LRMLED",286,0)
 Q
"RTN","LRMLED",287,0)
 ;
"RTN","LRMLED",288,0)
LRTEXT(AL) ; update counter for message xml
"RTN","LRMLED",289,0)
 S AL=AL+1
"RTN","LRMLED",290,0)
 Q AL
"RTN","LRMLED",291,0)
 ;
"RTN","LRMLED",292,0)
HL7 ;send hl7 to NTRT
"RTN","LRMLED",293,0)
 ; currently not implemented
"RTN","LRMLED",294,0)
 Q
"RTN","LRMLED",295,0)
 ;
"RTN","LRMLED",296,0)
LRTP(AA) ;update text counter
"RTN","LRMLED",297,0)
 S AA=AA+1
"RTN","LRMLED",298,0)
 Q AA
"RTN","LRMLED",299,0)
 ;
"RTN","LRMLED",300,0)
XML ;send xml to NTRT
"RTN","LRMLED",301,0)
 ; moved to LRMLEDA for size
"RTN","LRMLED",302,0)
 D XML^LRMLEDA
"RTN","LRMLED",303,0)
 Q
"RTN","LRMLED",304,0)
 ;
"RTN","LRMLED",305,0)
 ;
"RTN","LRMLED",306,0)
ETSTTYP(LRX) ; get test data type
"RTN","LRMLED",307,0)
 N LRSTUB,LRTYPE,LRY,K,KK
"RTN","LRMLED",308,0)
 I LRX="" Q ""
"RTN","LRMLED",309,0)
 S K="^"_LRX_"0)",KK=$G(@K),$P(LRSTUB,"|",3)=$P(KK,U,1)
"RTN","LRMLED",310,0)
 S LRX=$P(LRX,"(",2)
"RTN","LRMLED",311,0)
 ;
"RTN","LRMLED",312,0)
 ; Data type
"RTN","LRMLED",313,0)
 S LRTYPE=$$GET1^DID($P(LRX,","),$P(LRX,",",2,99),"","TYPE")
"RTN","LRMLED",314,0)
 S $P(LRSTUB,"|",2)=LRTYPE
"RTN","LRMLED",315,0)
 ;
"RTN","LRMLED",316,0)
 ; Input transform
"RTN","LRMLED",317,0)
 S LRY=$$GET1^DID($P(LRX,","),$P(LRX,",",2,99),"",$S(LRTYPE="SET":"POINTER",1:"INPUT TRANSFORM"))
"RTN","LRMLED",318,0)
 I LRTYPE="NUMERIC",LRY["LRNUM" D
"RTN","LRMLED",319,0)
 . S LRX=$P(LRY,"""",2)
"RTN","LRMLED",320,0)
 . I LRX?.1"-".N1","1.N1","1N S LRY="Number from "_$P(LRX,",")_" to "_$P(LRX,",",2)_" with "_$P(LRX,",",3)_" decimal"
"RTN","LRMLED",321,0)
 . S $P(LRSTUB,"|",1)=LRY
"RTN","LRMLED",322,0)
 ; Help prompt
"RTN","LRMLED",323,0)
 I LRTYPE="FREE TEXT" D
"RTN","LRMLED",324,0)
 . S LRY=$$GET1^DID($P(LRX,","),$P(LRX,",",2,99),"","HELP-PROMPT")
"RTN","LRMLED",325,0)
 . S $P(LRSTUB,"|",1)=LRY
"RTN","LRMLED",326,0)
 Q LRSTUB
"RTN","LRMLED",327,0)
 ;
"RTN","LRMLED",328,0)
EOUT ; quit
"RTN","LRMLED",329,0)
 L -^TMP(LR60IEN,LRS)
"RTN","LRMLED",330,0)
 K LXA,LXB,LXC,LXD,LXE,LXF,LXG,LXH,A,LR60IEN,DA,DIC,DIQ,B,C,D,LRS,LSITE,LRNT,LRNTI,AR,I,LRMLTFREC
"RTN","LRMLED",331,0)
 K LRSITE,LRSITEN,LRGMAIL,LRSMAIL,LRNMAIL,LACT,MAILPERSON,LR64,LRNLT,LRSEC,LRCOM,LRCTY,LRNEWTEST,LRSUBSCRIPT
"RTN","LRMLED",332,0)
 K LRNOS1,LRNOS2,LRSCHPA,LRSCHNM,ALI,LRTEXT,LR64N,LRDTNM,G
"RTN","LRMLED",333,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","LRMLED",334,0)
 Q
"RTN","LRMLED",335,0)
 ;
"RTN","LRMLED",336,0)
 ; This section is called by the NEW Record cross references in file 60
"RTN","LRMLED",337,0)
 ; CR 489 for BED (base level edit) and SITE/SPECIMEN sub Level 490 for SED
"RTN","LRMLED",338,0)
 ;
"RTN","LRMLED",339,0)
BED(LR60IEN) ;ENTRY POINT FOR MAIN EDITS
"RTN","LRMLED",340,0)
 ;
"RTN","LRMLED",341,0)
 N ZTDTH,ZTRTN,ZTSAVE,ZTIO,ZTSK,ZTDESC,LRN,LRO
"RTN","LRMLED",342,0)
 M LRO=X1,LRN=X2
"RTN","LRMLED",343,0)
 S ZTDTH=$$NOW^XLFDT,ZTDESC="LAB Edit Save from file 60 Cross Reference #489"
"RTN","LRMLED",344,0)
 S ZTRTN="BEDA^LRMLED("_LR60IEN_")",ZTSAVE("LR60IEN")=""
"RTN","LRMLED",345,0)
 S ZTSAVE("LRN(")="",ZTSAVE("LRO(")=""
"RTN","LRMLED",346,0)
 S ZTIO=""
"RTN","LRMLED",347,0)
 D ^%ZTLOAD
"RTN","LRMLED",348,0)
 Q
"RTN","LRMLED",349,0)
 ;
"RTN","LRMLED",350,0)
BEDA(LRDA) ; edits from main level
"RTN","LRMLED",351,0)
 Q:$D(LRMLTFREC)
"RTN","LRMLED",352,0)
 ; (1)-3 TYPE (2)-131 CREATION DATE (3)-133 TEST INACTIVE DATE
"RTN","LRMLED",353,0)
 ; X1-old array  X2-new array
"RTN","LRMLED",354,0)
 N A,B,C,D,E,F,G,I,DA,LO,LN,LE,LLI,LTYP
"RTN","LRMLED",355,0)
 M A=DR S D=0
"RTN","LRMLED",356,0)
 N DR,DIE,DIC,X
"RTN","LRMLED",357,0)
 F I=1:1:3 S F=$G(LRO(I)),G=$G(LRN(I)) I F'=G S D=1
"RTN","LRMLED",358,0)
 I 'D G BEDO
"RTN","LRMLED",359,0)
 F LLI=1:1:3 S LO=$G(LRO(LLI)),LN=$G(LRN(LLI)) I LO'=LN S LTYP=$S(LLI=1:"Y",LLI=2:"C",1:"T") D  D SAV
"RTN","LRMLED",360,0)
 . ; I LTYP="C"!(LTYP="T") S:+LO>0 LO=$$FMTE^XLFDT(LO,9) S:+LN>0 LN=$$FMTE^XLFDT(LN,9)
"RTN","LRMLED",361,0)
 G BEDO
"RTN","LRMLED",362,0)
 ;
"RTN","LRMLED",363,0)
BEDO K A,B,C,D,E,I,X,DA,LRN,LRO,LO,LN,LE,LLI,DR,DIE,DIC,LRMLTFREC,LTYP
"RTN","LRMLED",364,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","LRMLED",365,0)
 Q
"RTN","LRMLED",366,0)
 ;
"RTN","LRMLED",367,0)
SAV ; file edit in 60.28
"RTN","LRMLED",368,0)
 N DR,DIE,DIC,X,DA,Y,LRMLTFREC,LE
"RTN","LRMLED",369,0)
 S DA(1)=LRDA,DA=0,LRMLTFREC=1
"RTN","LRMLED",370,0)
 S LE="^LAB(60,"_DA(1)_",15,",DIC=LE,DIC(0)="QEAL"
"RTN","LRMLED",371,0)
 S X=$$NOW^XLFDT
"RTN","LRMLED",372,0)
 L +^LAB(60,DA(1),15):30 I '$T Q
"RTN","LRMLED",373,0)
 D FILE^DICN
"RTN","LRMLED",374,0)
 L -^LAB(60,DA(1),15)
"RTN","LRMLED",375,0)
 I Y="-1" Q
"RTN","LRMLED",376,0)
 S DIE=LE,DA=+Y
"RTN","LRMLED",377,0)
 S DR=".02///"_+$G(DUZ)_";.03///"_LTYP_";.04///"_LO_";.05///"_LN
"RTN","LRMLED",378,0)
 D ^DIE
"RTN","LRMLED",379,0)
 K DR,DIE,DIC,X,DA,Y,LRMLTFREC,LE
"RTN","LRMLED",380,0)
 Q
"RTN","LRMLED",381,0)
 ;
"RTN","LRMLED",382,0)
SED(LR6001IEN,LR60IEN) ;ENTRY POINT FOR MAIN SITE/SPECIMEN EDITS
"RTN","LRMLED",383,0)
 ;
"RTN","LRMLED",384,0)
 N ZTDTH,ZTRTN,ZTSAVE,ZTIO,ZTSK,ZTDESC,LRN,LRO
"RTN","LRMLED",385,0)
 M LRO=X1,LRN=X2
"RTN","LRMLED",386,0)
 S ZTDTH=$$NOW^XLFDT,ZTDESC="LAB Edit Save from file 60 Cross Reference #490"
"RTN","LRMLED",387,0)
 S ZTRTN="SEDA^LRMLED("_LR6001IEN_","_LR60IEN_")",ZTSAVE("LR60IEN")="",ZTSAVE("LR6001IEN")=""
"RTN","LRMLED",388,0)
 S ZTSAVE("LRN(")="",ZTSAVE("LRO(")=""
"RTN","LRMLED",389,0)
 S ZTIO=""
"RTN","LRMLED",390,0)
 D ^%ZTLOAD
"RTN","LRMLED",391,0)
 Q
"RTN","LRMLED",392,0)
 ;
"RTN","LRMLED",393,0)
SEDA(LRDA,LRDA1) ; edits from site/specimen level
"RTN","LRMLED",394,0)
 ; (1)-30 MLTF VUID (2)-RESULT/SPECIMEN INACTIVE DATE (3)-EXCEPTION FLAG (4)-SPECIMEN CREATE DATE
"RTN","LRMLED",395,0)
 ; X1-old array  X2-new array
"RTN","LRMLED",396,0)
 Q:$D(LRMLTFREC)
"RTN","LRMLED",397,0)
 N A,B,C,D,E,F,DA,LLI,LTYP
"RTN","LRMLED",398,0)
 M A=DR
"RTN","LRMLED",399,0)
 N DR,DIE,DIC,X
"RTN","LRMLED",400,0)
 S D="" F I=1:1:4 S E=$G(LRO(I)),F=$G(LRN(I)) I E'=F S D=1
"RTN","LRMLED",401,0)
 I 'D G BEDO
"RTN","LRMLED",402,0)
 F LLI=1:1:4 S LO=$G(LRO(LLI)),LN=$G(LRN(LLI)) I LO'=LN S LTYP=$S(LLI=1:"M",LLI=2:"R",LLI=3:"E",1:"S") D  D SSAV
"RTN","LRMLED",403,0)
 . ; I LTYP="R"!(LTYP="S") S:+LO>0 LO=$$FMTE^XLFDT(LO,9) S:+LN>0 LN=$$FMTE^XLFDT(LN,9)
"RTN","LRMLED",404,0)
 G BEDO
"RTN","LRMLED",405,0)
 Q
"RTN","LRMLED",406,0)
 ;
"RTN","LRMLED",407,0)
SSAV ; file edit in 60.28
"RTN","LRMLED",408,0)
 N DR,DIE,DIC,X,DA,Y,LRMLTFREC,LE
"RTN","LRMLED",409,0)
 S DA(1)=LRDA1,DA=0,LRMLTFREC=1
"RTN","LRMLED",410,0)
 S LE="^LAB(60,"_DA(1)_",15,",DIC=LE,DIC(0)="QEAL"
"RTN","LRMLED",411,0)
 S X=$$NOW^XLFDT
"RTN","LRMLED",412,0)
 L +^LAB(60,DA(1),15):30 I '$T Q
"RTN","LRMLED",413,0)
 D FILE^DICN
"RTN","LRMLED",414,0)
 L -^LAB(60,DA(1),15)
"RTN","LRMLED",415,0)
 I Y="-1" Q
"RTN","LRMLED",416,0)
 S DIE=LE,DA=+Y
"RTN","LRMLED",417,0)
 S DR=".02///"_+$G(DUZ)_";.03///"_LTYP_";.04///"_LO_";.05///"_LN_";.06///"_LRDA
"RTN","LRMLED",418,0)
 D ^DIE
"RTN","LRMLED",419,0)
 K DR,DIE,DIC,X,DA,Y,LRMLTFREC,LE
"RTN","LRMLED",420,0)
 Q
"RTN","LRMLED",421,0)
 ;
"RTN","LRMLED",422,0)
GET664 ; get file 66.4 info
"RTN","LRMLED",423,0)
 S LSITE=$$SITE^VASITE,LSITE=$P(LSITE,U,1)
"RTN","LRMLED",424,0)
 S LRNT=$O(^LAB(66.4,"B",LSITE,0))
"RTN","LRMLED",425,0)
 D GETS^DIQ(66.4,LRNT_",","**","IE","AR")
"RTN","LRMLED",426,0)
 M LRNTI=AR("66.4",LRNT_",") K AR
"RTN","LRMLED",427,0)
 Q
"RTN","LRMLED",428,0)
 ;
"RTN","LRMLED",429,0)
GET60T ; get top of file 60 test info
"RTN","LRMLED",430,0)
 S DIQ="LXB",DIQ(0)="IE",DIC=60,DR=".01;131" K ^UTILITY("DIQ1",$J) D EN^DIQ1 K ^UTILITY("DIQ1",$J)
"RTN","LRMLED",431,0)
 K LXA M LXA=LXB(60,DA) K LXB
"RTN","LRMLED",432,0)
 Q
"RTN","LRMLED",433,0)
 ;
"VER")
8.0^22.2
"BLD",11386,6)
^424
**END**
**END**

