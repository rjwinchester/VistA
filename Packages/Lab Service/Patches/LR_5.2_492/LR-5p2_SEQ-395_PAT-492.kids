Released LR*5.2*492 SEQ #395
Extracted from mail message
**KIDS**:LR*5.2*492^

**INSTALL NAME**
LR*5.2*492
"BLD",10615,0)
LR*5.2*492^LAB SERVICE^0^3170707^y
"BLD",10615,1,0)
^^11^11^3170706^
"BLD",10615,1,1,0)
This patch addresses three (3) VistA Laboratory issues related to 
"BLD",10615,1,2,0)
phlebotomy collection list logic:
"BLD",10615,1,3,0)
 
"BLD",10615,1,4,0)
1.  Test orders that roll over from one collection list to another may 
"BLD",10615,1,5,0)
appear to be ordered twice in CPRS even though they are only ordered once.
"BLD",10615,1,6,0)
 
"BLD",10615,1,7,0)
2.  Merged orders created by collection list generation sometimes do not 
"BLD",10615,1,8,0)
have correct CPRS start date/times.
"BLD",10615,1,9,0)
 
"BLD",10615,1,10,0)
3.  The Lab Order Entry (#69) file Lab Arrival Date/Time (#20) field is 
"BLD",10615,1,11,0)
erroneously set during collection list generation.
"BLD",10615,4,0)
^9.64PA^^
"BLD",10615,6.3)
3
"BLD",10615,"ABPKG")
n
"BLD",10615,"KRN",0)
^9.67PA^779.2^20
"BLD",10615,"KRN",.4,0)
.4
"BLD",10615,"KRN",.401,0)
.401
"BLD",10615,"KRN",.402,0)
.402
"BLD",10615,"KRN",.403,0)
.403
"BLD",10615,"KRN",.5,0)
.5
"BLD",10615,"KRN",.84,0)
.84
"BLD",10615,"KRN",3.6,0)
3.6
"BLD",10615,"KRN",3.8,0)
3.8
"BLD",10615,"KRN",9.2,0)
9.2
"BLD",10615,"KRN",9.8,0)
9.8
"BLD",10615,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",10615,"KRN",9.8,"NM",1,0)
LRPHSET1^^0^B10839269
"BLD",10615,"KRN",9.8,"NM",2,0)
LRPHSET2^^0^B44272962
"BLD",10615,"KRN",9.8,"NM",3,0)
LRTSTSET^^0^B12817102
"BLD",10615,"KRN",9.8,"NM","B","LRPHSET1",1)

"BLD",10615,"KRN",9.8,"NM","B","LRPHSET2",2)

"BLD",10615,"KRN",9.8,"NM","B","LRTSTSET",3)

"BLD",10615,"KRN",19,0)
19
"BLD",10615,"KRN",19.1,0)
19.1
"BLD",10615,"KRN",101,0)
101
"BLD",10615,"KRN",409.61,0)
409.61
"BLD",10615,"KRN",771,0)
771
"BLD",10615,"KRN",779.2,0)
779.2
"BLD",10615,"KRN",870,0)
870
"BLD",10615,"KRN",8989.51,0)
8989.51
"BLD",10615,"KRN",8989.52,0)
8989.52
"BLD",10615,"KRN",8994,0)
8994
"BLD",10615,"KRN","B",.4,.4)

"BLD",10615,"KRN","B",.401,.401)

"BLD",10615,"KRN","B",.402,.402)

"BLD",10615,"KRN","B",.403,.403)

"BLD",10615,"KRN","B",.5,.5)

"BLD",10615,"KRN","B",.84,.84)

"BLD",10615,"KRN","B",3.6,3.6)

"BLD",10615,"KRN","B",3.8,3.8)

"BLD",10615,"KRN","B",9.2,9.2)

"BLD",10615,"KRN","B",9.8,9.8)

"BLD",10615,"KRN","B",19,19)

"BLD",10615,"KRN","B",19.1,19.1)

"BLD",10615,"KRN","B",101,101)

"BLD",10615,"KRN","B",409.61,409.61)

"BLD",10615,"KRN","B",771,771)

"BLD",10615,"KRN","B",779.2,779.2)

"BLD",10615,"KRN","B",870,870)

"BLD",10615,"KRN","B",8989.51,8989.51)

"BLD",10615,"KRN","B",8989.52,8989.52)

"BLD",10615,"KRN","B",8994,8994)

"BLD",10615,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",10615,"QUES",0)
^9.62^^
"BLD",10615,"REQB",0)
^9.611^2^2
"BLD",10615,"REQB",1,0)
LR*5.2*427^2
"BLD",10615,"REQB",2,0)
LR*5.2*423^2
"BLD",10615,"REQB","B","LR*5.2*423",2)

"BLD",10615,"REQB","B","LR*5.2*427",1)

"MBREQ")
0
"PKG",26,-1)
1^1
"PKG",26,0)
LAB SERVICE^LR^CORE LAB SYSTEM
"PKG",26,20,0)
^9.402P^1^1
"PKG",26,20,1,0)
2^^LRXDRPT
"PKG",26,20,1,1)

"PKG",26,20,"B",2,1)

"PKG",26,22,0)
^9.49I^1^1
"PKG",26,22,1,0)
5.2^2940927^2981028^66481
"PKG",26,22,1,"PAH",1,0)
492^3170707
"PKG",26,22,1,"PAH",1,1,0)
^^11^11^3170707
"PKG",26,22,1,"PAH",1,1,1,0)
This patch addresses three (3) VistA Laboratory issues related to 
"PKG",26,22,1,"PAH",1,1,2,0)
phlebotomy collection list logic:
"PKG",26,22,1,"PAH",1,1,3,0)
 
"PKG",26,22,1,"PAH",1,1,4,0)
1.  Test orders that roll over from one collection list to another may 
"PKG",26,22,1,"PAH",1,1,5,0)
appear to be ordered twice in CPRS even though they are only ordered once.
"PKG",26,22,1,"PAH",1,1,6,0)
 
"PKG",26,22,1,"PAH",1,1,7,0)
2.  Merged orders created by collection list generation sometimes do not 
"PKG",26,22,1,"PAH",1,1,8,0)
have correct CPRS start date/times.
"PKG",26,22,1,"PAH",1,1,9,0)
 
"PKG",26,22,1,"PAH",1,1,10,0)
3.  The Lab Order Entry (#69) file Lab Arrival Date/Time (#20) field is 
"PKG",26,22,1,"PAH",1,1,11,0)
erroneously set during collection list generation.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","LRPHSET1")
0^1^B10839269^B10152359
"RTN","LRPHSET1",1,0)
LRPHSET1 ;SLC/CJS-COLLECTION LIST TO ACCESSIONS ;8/11/97
"RTN","LRPHSET1",2,0)
 ;;5.2;LAB SERVICE;**121,191,221,240,423,492**;Sep 27, 1994;Build 3
"RTN","LRPHSET1",3,0)
 Q
"RTN","LRPHSET1",4,0)
EN ;from LRPHSET
"RTN","LRPHSET1",5,0)
 K ^LRO(69,DT,1,"AD") S $P(^LAB(69.9,1,5),"^",10,12)=1_"^"_$H_"^"_$S($D(DUZ):DUZ,1:"")
"RTN","LRPHSET1",6,0)
 S LRDFN=0 F  S LRDFN=$O(^LRO(69,DT,1,"AA",LRDFN)) Q:LRDFN<1  K T D S6
"RTN","LRPHSET1",7,0)
 S LRLOC="",LRCOUNT=0,LRDUZ(2)=$S($D(DUZ(2)):DUZ(2),1:"") F LRPH=0:0 S LRLOC=$O(^LRO(69,DT,1,"AD",LRLOC)) Q:LRLOC=""  D S4
"RTN","LRPHSET1",8,0)
 S $P(^LAB(69.9,1,5),"^",10)=0
"RTN","LRPHSET1",9,0)
 G END
"RTN","LRPHSET1",10,0)
S4 K DIC S D="C",X=LRLOC,DIC(0)="Z",DIC=44 D IX^DIC S LRDUZ(2)=$S(Y<1:DUZ(2),1:$S($P(Y(0),U,4):$P(Y(0),U,4),1:DUZ(2)))
"RTN","LRPHSET1",11,0)
 S LRDFN=0 F  S LRDFN=$O(^LRO(69,DT,1,"AD",LRLOC,LRDFN)) Q:LRDFN<1  D S4A
"RTN","LRPHSET1",12,0)
 Q
"RTN","LRPHSET1",13,0)
S4A S LRSN=0 F  S LRSN=$O(^LRO(69,DT,1,"AD",LRLOC,LRDFN,LRSN)) Q:LRSN<1  D:$D(^LRO(69,DT,1,LRSN,1)) S4C D:'($D(^LRO(69,DT,1,LRSN,1))#2)&($D(^(0))) S4B
"RTN","LRPHSET1",14,0)
 Q
"RTN","LRPHSET1",15,0)
S4B S X=^LRO(69,DT,1,LRSN,0) I $P(X,U,4)="LC",LRDFN=+X,$P(X,U,8)'>LRDTI S:$$GOT(DT,LRSN) LRCOUNT=LRCOUNT+1 D S5
"RTN","LRPHSET1",16,0)
 Q
"RTN","LRPHSET1",17,0)
S4C I $P(^LRO(69,DT,1,LRSN,1),U)'>LRDTI S X=^(0) I $P(X,U,4)="LC",LRDFN=+X,$P(X,U,8)'>LRDTI D S5
"RTN","LRPHSET1",18,0)
 Q
"RTN","LRPHSET1",19,0)
S5 S ^LRO(69,DT,1,"AC",LRLOC,LRSN)=1,LRSCR=$S($D(^LRO(69,DT,1,LRSN,1)):$P(^(1),U,3,99),1:""),^(1)=LRDTI_"^1^"_LRSCR,LRTJ=$P(^(0),U,3,4)_"^"_DT,LRSAMP=$P(LRTJ,U,1)
"RTN","LRPHSET1",20,0)
 S LRSPEC=$P(^LAB(62,LRSAMP,0),U,2),I=$O(^LRO(69,DT,1,LRSN,6,0)) K LRSPCDSC S:I LRSPCDSC=^(I,0)
"RTN","LRPHSET1",21,0)
 I $D(^LRO(69,DT,1,LRSN,1)),'$L($P(^(1),U,4)),$D(^(3)) S LRLLOC=$P(^LRO(69,DT,1,LRSN,0),U,7),LROLLOC=$P(^(0),U,9) D REUP^LRPHSET2
"RTN","LRPHSET1",22,0)
 D OLD^LRORDST
"RTN","LRPHSET1",23,0)
 ;
"RTN","LRPHSET1",24,0)
 ;Lab Arrival Date/Time field is set by routine LRWLST1 during call
"RTN","LRPHSET1",25,0)
 ;to OLD^LRORDST.  Re-setting it here to null rather than changing LRWLST1
"RTN","LRPHSET1",26,0)
 ;since other functions call LRWLST1.
"RTN","LRPHSET1",27,0)
 ;
"RTN","LRPHSET1",28,0)
 ;Lab Arrival Date/Time should not be set until the order is received
"RTN","LRPHSET1",29,0)
 ;into the lab.
"RTN","LRPHSET1",30,0)
 ;
"RTN","LRPHSET1",31,0)
 S $P(^LRO(69,DT,1,LRSN,3),"^")=""
"RTN","LRPHSET1",32,0)
 K LRTJ Q
"RTN","LRPHSET1",33,0)
S6 S T="",LRSN=0 F  S LRSN=$O(^LRO(69,DT,1,"AA",LRDFN,LRSN)) Q:LRSN<1  D S6A
"RTN","LRPHSET1",34,0)
 S LRSAMP=0 F  S LRSAMP=$O(T(LRSAMP)) Q:LRSAMP<1  S LRSTEP=0 D S7^LRPHSET2 S LRSTEP=1 D S7^LRPHSET2
"RTN","LRPHSET1",35,0)
 Q
"RTN","LRPHSET1",36,0)
S6A I '$S($D(^LRO(69,DT,1,LRSN,0)):$L($P(^(0),U,2)),1:0) Q
"RTN","LRPHSET1",37,0)
 Q:$P(^LRO(69,DT,1,LRSN,0),U,4)'="LC"  Q:$P(^(0),U,8)>LRDTI  I $D(^(1)),$L($P(^(1),U,4)) Q
"RTN","LRPHSET1",38,0)
 Q:'$D(^LRO(69,DT,1,LRSN,2,0))  Q:'$$GOT(DT,LRSN)
"RTN","LRPHSET1",39,0)
 S LRSAMP=$P(^LRO(69,DT,1,LRSN,0),U,3),LRLLOC=$E($P(^(0),U,7),1,30),LROLLOC=$P(^(0),U,9)
"RTN","LRPHSET1",40,0)
 S X=^LR(LRDFN,0),LRDPF=$P(X,U,2) I LRDPF=2,$D(^DPT(+$P(X,U,3),.1)) S LRLLOC=^(.1) D DPT^LRWU S $P(^LRO(69,DT,1,LRSN,0),U,7)=$S($L(LRLLOC):LRLLOC,1:"UNKNOWN")
"RTN","LRPHSET1",41,0)
 S:'$L(LRLLOC) LRLLOC="UNKNOWN" Q:LRSAMP<1  S ^LRO(69,DT,1,"AD",LRLLOC,LRDFN,LRSN)=""
"RTN","LRPHSET1",42,0)
 S I=0 F  S I=$O(^LRO(69,DT,1,LRSN,2,I)) Q:I<1  S X=^(I,0) I '$P(X,"^",6),'$P(X,"^",11) S T(LRSAMP,+X,LRSN)=I_U_$P(X,U,2)
"RTN","LRPHSET1",43,0)
 Q
"RTN","LRPHSET1",44,0)
END Q  ;BACK TO LRPHSET
"RTN","LRPHSET1",45,0)
GOT(ODT,SN) ;See if all tests have been canceled
"RTN","LRPHSET1",46,0)
 N I S GOT=0
"RTN","LRPHSET1",47,0)
 I $D(^LRO(69,ODT,1,SN)) S I=0 F  S I=$O(^LRO(69,ODT,1,SN,2,I)) Q:I<1  I $D(^(I,0)),'$P(^(0),"^",11) S GOT=1 Q
"RTN","LRPHSET1",48,0)
 Q GOT
"RTN","LRPHSET2")
0^2^B44272962^B27649309
"RTN","LRPHSET2",1,0)
LRPHSET2 ;DALOI/STAFF - COLLECTION LIST TO ACCESSIONS CONT ; 19 Jun 2017  9:05 PM
"RTN","LRPHSET2",2,0)
 ;;5.2;LAB SERVICE;**121,202,350,427,492**;Sep 27, 1994;Build 3
"RTN","LRPHSET2",3,0)
 ;
"RTN","LRPHSET2",4,0)
REUP ;FROM LRPHSET1 - ADD TO OR REBUILD TO COLLECTION LIST
"RTN","LRPHSET2",5,0)
 N LRORDTYP
"RTN","LRPHSET2",6,0)
 S $P(LRORDTYP,"^",2)=$$FIND1^DIC(64.061,"","OX","L","D","I $P(^(0),U,5)=""0065""")
"RTN","LRPHSET2",7,0)
 S LRDPF=$P(^LR(LRDFN,0),U,2),DFN=$P(^(0),U,3)
"RTN","LRPHSET2",8,0)
 S LRRB=0
"RTN","LRPHSET2",9,0)
 I LRDPF=2 S LRRB=$$GET1^DIQ(2,DFN_",",.101),LRRB=$S(LRRB'="":LRRB,1:0)
"RTN","LRPHSET2",10,0)
 ;
"RTN","LRPHSET2",11,0)
 S I=0
"RTN","LRPHSET2",12,0)
 F  S I=$O(^LRO(69,DT,1,LRSN,2,I)) Q:I<1  S X=^(I,0) I $P(X,U,3)'="" S LRAA($P(X,U,4))=$P(X,U,3)_"^"_$P(X,U,4)_"^"_$P(X,U,5)
"RTN","LRPHSET2",13,0)
 ;
"RTN","LRPHSET2",14,0)
 S LRK=0
"RTN","LRPHSET2",15,0)
 F  S LRK=$O(^LRO(69,DT,1,LRSN,2,LRK)) Q:LRK<1  S X=^(LRK,0) I $P(X,U,3)="",'$P(X,"^",11) D
"RTN","LRPHSET2",16,0)
 . S LRTS=+X,LRAA=$S($D(^LAB(60,LRTS,8,DUZ(2),0)):$P(^(0),U,2),1:"")
"RTN","LRPHSET2",17,0)
 . I LRAA'="",$D(LRAA(LRAA)),$P(^LAB(60,LRTS,0),U,7)'=1 D JAM
"RTN","LRPHSET2",18,0)
 ;
"RTN","LRPHSET2",19,0)
 S LRI=0
"RTN","LRPHSET2",20,0)
 F  S LRI=$O(^LRO(69,DT,1,LRSN,2,LRI)) Q:LRI<1  S X=^(LRI,0) I '$P(X,U,6),$P(X,U,3) D
"RTN","LRPHSET2",21,0)
 . S LRTSTN=+X,LRAD=$P(X,U,3),LRAA=$P(X,U,4),LRAN=$P(X,U,5)
"RTN","LRPHSET2",22,0)
 . I '$D(^LRO(69.1,"LRPH",LRTE,LRLLOC,LRRB,LRDFN,LRSN,LRAA,LRAN,+LRTSTN)) D REUP1
"RTN","LRPHSET2",23,0)
 ;
"RTN","LRPHSET2",24,0)
 ;Commenting out re-sets to Lab Collection Date/Time.
"RTN","LRPHSET2",25,0)
 ;Per stakeholders, the value should either be the collection list scheduled date/time
"RTN","LRPHSET2",26,0)
 ;or actual collection date/time
"RTN","LRPHSET2",27,0)
 ;
"RTN","LRPHSET2",28,0)
 I $D(REUP) S LRCOUNT=LRCOUNT+1 ;,^LRO(69,DT,1,LRSN,3)=LRDTI
"RTN","LRPHSET2",29,0)
 ;I '$D(REUP) S $P(^LRO(69,DT,1,LRSN,1),U)=$P(^LRO(69,DT,1,LRSN,3),U)
"RTN","LRPHSET2",30,0)
 K LRAD,LRI,LRAN,LRAA,LRDPF,DFN,LRZ3,LRZB,LRZ1,LRTSTN,LRRB,LRURG,REUP,I,J,LRK,F,LRAODT,LRWRD
"RTN","LRPHSET2",31,0)
 Q
"RTN","LRPHSET2",32,0)
 ;
"RTN","LRPHSET2",33,0)
REUP1 L +^LRO(69.1,LRTE):90 I '$T G REUP1
"RTN","LRPHSET2",34,0)
 S LRZ3=$S($D(^LRO(69.1,LRTE,1,0)):$P(^(0),U,3),1:0)
"RTN","LRPHSET2",35,0)
 ;
"RTN","LRPHSET2",36,0)
 ;MFLG is set when a later order was on an earlier collection list.
"RTN","LRPHSET2",37,0)
 ;Then that later order is rolled over to an earlier order which was on a later
"RTN","LRPHSET2",38,0)
 ;collection list.  This scenario has occurred at sites.
"RTN","LRPHSET2",39,0)
 ;
"RTN","LRPHSET2",40,0)
 I $G(MFLG),$G(LRSWAP),$D(^LRO(69.1,"LRPH",LRTE,LRLLOC,LRRB,LRDFN,LRSWAP,LRAA,LRAN)) D
"RTN","LRPHSET2",41,0)
 . N COLSTR,DA
"RTN","LRPHSET2",42,0)
 . S COLSTR=$G(^LRO(69.1,"LRPH",LRTE,LRLLOC,LRRB,LRDFN,LRSWAP))
"RTN","LRPHSET2",43,0)
 . S DA=$P(COLSTR,"^",5)
"RTN","LRPHSET2",44,0)
 . I DA]"" S DA(1)=LRTE,DIK="^LRO(69.1,"_DA(1)_",1," D ^DIK
"RTN","LRPHSET2",45,0)
 I '$D(^LRO(69.1,"LRPH",LRTE,LRLLOC,LRRB,LRDFN,LRSN,LRAA,LRAN)) S REUP=1
"RTN","LRPHSET2",46,0)
 ;
"RTN","LRPHSET2",47,0)
REUP2 S LRZ3=LRZ3+1
"RTN","LRPHSET2",48,0)
 G:$D(^LRO(69.1,LRTE,1,LRZ3)) REUP2
"RTN","LRPHSET2",49,0)
 S LRZO="^LRO(69.1,"_LRTE_",1,",LRZ1="69.11P",LRZB=+LRTSTN,LRIFN=LRZ3
"RTN","LRPHSET2",50,0)
 D Z^LRWU
"RTN","LRPHSET2",51,0)
 L -^LRO(69.1,LRTE)
"RTN","LRPHSET2",52,0)
 S ^LRO(69.1,LRTE,1,LRIFN,0)=+LRTSTN_"^"_LRLLOC_"^"_LRRB_"^"_LRDFN_"^"_LRSN_"^"_LRTJ_"^"_LRAD_"^"_LRAA_"^"_LRAN_"^"_LROLLOC,^LRO(69.1,"LRPH",LRTE,LRLLOC,LRRB,LRDFN,LRSN)=LRTJ_"^"_LRAD_"^"_LRIFN,^(LRSN,LRAA,LRAN,+LRTSTN)=+LRTSTN
"RTN","LRPHSET2",53,0)
 Q
"RTN","LRPHSET2",54,0)
 ;
"RTN","LRPHSET2",55,0)
JAM ;
"RTN","LRPHSET2",56,0)
 S LRAA=$P(LRAA(LRAA),U,2),LRAD=$P(LRAA(LRAA),U),LRAODT=LRAD,LRAN=$P(LRAA(LRAA),U,3),(LRURG,Y)=$P(X,U,2)
"RTN","LRPHSET2",57,0)
 D EN^LRTSTSET
"RTN","LRPHSET2",58,0)
 Q
"RTN","LRPHSET2",59,0)
 ;
"RTN","LRPHSET2",60,0)
S7 ;FROM LRPHSET1 - COMBINE OR MERGE TESTS ON ORDERS
"RTN","LRPHSET2",61,0)
 N MFLG
"RTN","LRPHSET2",62,0)
 S T=0 F  S T=$O(T(LRSAMP,T)) Q:T<1  D S7A
"RTN","LRPHSET2",63,0)
 Q
"RTN","LRPHSET2",64,0)
S7A S LRPSN=0 F  S LRPSN=$O(T(LRSAMP,T,LRPSN)) Q:LRPSN<1  D @$S(LRSTEP=0:"S8",1:"S9")
"RTN","LRPHSET2",65,0)
 Q
"RTN","LRPHSET2",66,0)
S8 S J=T
"RTN","LRPHSET2",67,0)
 D COMBINE
"RTN","LRPHSET2",68,0)
 S J=0 F  S J=$O(T(LRSAMP,J)) Q:J<1  D SCAN60
"RTN","LRPHSET2",69,0)
 Q
"RTN","LRPHSET2",70,0)
S9 S J=0 F  S J=$O(T(LRSAMP,J)) Q:J<1  D MERG
"RTN","LRPHSET2",71,0)
 Q
"RTN","LRPHSET2",72,0)
SCAN60 S K=0 F  S K=$O(^LAB(60,T,2,K)) Q:K<1  I +^(K,0)=J S LRSN=0,LRSN=$O(T(LRSAMP,J,LRSN)) D @$S(LRPSN>LRSN:"MERG",1:"COMBINE")
"RTN","LRPHSET2",73,0)
 Q
"RTN","LRPHSET2",74,0)
COMBINE S LRSN=0 F  S LRSN=$O(T(LRSAMP,J,LRSN)) Q:LRSN<1  D:LRPSN>LRSN SWAP I LRSN'=LRPSN D CB2
"RTN","LRPHSET2",75,0)
 Q
"RTN","LRPHSET2",76,0)
CB2 I $P(^LRO(69,DT,1,LRSN,2,+T(LRSAMP,J,LRSN),0),U,6)'="",$D(^LRO(69,DT,1,LRSN,.1)),$D(^LRO(69,DT,1,+$O(^LRO(69,"C",+^(.1),DT,0)),1)),$P(^(1),U,4)'="" Q
"RTN","LRPHSET2",77,0)
 I $P(T(LRSAMP,T,LRPSN),U,2)'=$P(T(LRSAMP,J,LRSN),U,2) D URGENCY S $P(^LRO(69,DT,1,LRPSN,2,+T(LRSAMP,T,LRPSN),0),U,2)=LRURG
"RTN","LRPHSET2",78,0)
 S $P(^LRO(69,DT,1,LRPSN,2,+T(LRSAMP,T,LRPSN),0),"^",14)=DT_";"_LRSN_";"_+T(LRSAMP,J,LRSN)
"RTN","LRPHSET2",79,0)
 N X,XI,X1,I,TST
"RTN","LRPHSET2",80,0)
 S X1=^LRO(69,DT,1,LRPSN,.1),TST=^LRO(69,DT,1,LRSN,2,+T(LRSAMP,J,LRSN),0),$P(^(0),U,6)=X1,$P(^LRO(69,DT,1,LRSN,1),U,4)="M",XI=$P(^(1),U,7),XI=XI_X1_"/",$P(^(1),U,7)=XI
"RTN","LRPHSET2",81,0)
 D OERR(TST)
"RTN","LRPHSET2",82,0)
 K T(LRSAMP,J,LRSN)
"RTN","LRPHSET2",83,0)
 Q
"RTN","LRPHSET2",84,0)
 ;
"RTN","LRPHSET2",85,0)
MERG S LRSN=0 F  S LRSN=$O(T(LRSAMP,J,LRSN)) Q:LRSN<1  D:LRPSN>LRSN SWAP,SWAP1 I LRSN'=LRPSN D M1
"RTN","LRPHSET2",86,0)
 Q
"RTN","LRPHSET2",87,0)
 ;
"RTN","LRPHSET2",88,0)
M1 Q:$P(^LRO(69,DT,1,LRSN,2,+T(LRSAMP,J,LRSN),0),U,6)'=""
"RTN","LRPHSET2",89,0)
 S X=$P(^LRO(69,DT,1,LRPSN,2,0),"^",3)
"RTN","LRPHSET2",90,0)
LP S X=X+1
"RTN","LRPHSET2",91,0)
 I $D(^LRO(69,DT,1,LRPSN,2,X)) G LP
"RTN","LRPHSET2",92,0)
 ;
"RTN","LRPHSET2",93,0)
 ;Some merging scenarios were causing file 69 to be set incorrectly.
"RTN","LRPHSET2",94,0)
 ;Changes were made by LR*5.2*492 so that file 69 is set correctly
"RTN","LRPHSET2",95,0)
 ;for all merging scenarios.
"RTN","LRPHSET2",96,0)
 ; 
"RTN","LRPHSET2",97,0)
 ;Also, a new Order (#100) entry is created when necessary during the
"RTN","LRPHSET2",98,0)
 ;merging process.
"RTN","LRPHSET2",99,0)
 ;
"RTN","LRPHSET2",100,0)
 S ^LRO(69,DT,1,LRPSN,2,X,0)=^LRO(69,DT,1,LRSN,2,+T(LRSAMP,J,LRSN),0),^LRO(69,DT,1,LRPSN,2,"B",J,X)="",$P(^LRO(69,DT,1,LRPSN,2,0),"^",3,4)=X_"^"_X
"RTN","LRPHSET2",101,0)
 I $G(^LRO(69,DT,1,LRSN,2,+T(LRSAMP,J,LRSN),.3)) D
"RTN","LRPHSET2",102,0)
 . S ^LRO(69,DT,1,LRPSN,2,X,.3)=$G(^LRO(69,DT,1,LRSN,2,+T(LRSAMP,J,LRSN),.3))
"RTN","LRPHSET2",103,0)
 . D MER1
"RTN","LRPHSET2",104,0)
 D OEADD
"RTN","LRPHSET2",105,0)
 S $P(^LRO(69,DT,1,LRPSN,2,X,0),"^",14)=DT_";"_LRSN_";"_+T(LRSAMP,J,LRSN)
"RTN","LRPHSET2",106,0)
 N I,XI,X1,TST
"RTN","LRPHSET2",107,0)
 S X1=^LRO(69,DT,1,LRPSN,.1),$P(^LRO(69,DT,1,LRSN,2,+T(LRSAMP,J,LRSN),0),"^",6)=X1
"RTN","LRPHSET2",108,0)
 S TST=^LRO(69,DT,1,LRPSN,2,X,0),LRURG=$P(TST,"^",2),T(LRSAMP,J,LRPSN)=T(LRSAMP,J,LRSN),$P(T(LRSAMP,J,LRPSN),"^")=X
"RTN","LRPHSET2",109,0)
 S $P(^LRO(69,DT,1,LRSN,1),U,4)="M",XI=$P(^(1),U,7),XI=XI_X1_"/",$P(^LRO(69,DT,1,LRSN,1),U,7)=XI
"RTN","LRPHSET2",110,0)
 I '$G(MFLG) D OERR(TST)
"RTN","LRPHSET2",111,0)
 K T(LRSAMP,J,LRSN)
"RTN","LRPHSET2",112,0)
 Q
"RTN","LRPHSET2",113,0)
 ;
"RTN","LRPHSET2",114,0)
MER1 ;Merge if later order was on earlier collection list
"RTN","LRPHSET2",115,0)
 N SAVX,SAVJ
"RTN","LRPHSET2",116,0)
 S SAVX=X,SAVJ=J
"RTN","LRPHSET2",117,0)
 I $D(T(LRSAMP,J,LRSN)) D
"RTN","LRPHSET2",118,0)
 . S X1=^LRO(69,DT,1,LRSN,.1)
"RTN","LRPHSET2",119,0)
 . D OERR(J)
"RTN","LRPHSET2",120,0)
 S LRSWAP=LRSN,LRSN=LRPSN
"RTN","LRPHSET2",121,0)
 S T(LRSAMP,J,LRSN)=""
"RTN","LRPHSET2",122,0)
 S LRTJ=$P(^LRO(69,DT,1,LRPSN,0),U,3,4)_"^"_DT
"RTN","LRPHSET2",123,0)
 S LRCOUNT=$G(LRCOUNT)+1
"RTN","LRPHSET2",124,0)
 ;
"RTN","LRPHSET2",125,0)
 ;MFLG = tell LRTSTSET to not add "Added by" comments
"RTN","LRPHSET2",126,0)
 ;       and REUP1^LRPHSET2 whether previous entry should be killed
"RTN","LRPHSET2",127,0)
 ;       in collection list file 69.1
"RTN","LRPHSET2",128,0)
 S MFLG=1
"RTN","LRPHSET2",129,0)
 D REUP
"RTN","LRPHSET2",130,0)
 S LRSN=LRSWAP
"RTN","LRPHSET2",131,0)
 S X=SAVX,J=SAVJ
"RTN","LRPHSET2",132,0)
 N XSEQ
"RTN","LRPHSET2",133,0)
 S XSEQ=1+$S($D(^LRO(69,LRODT,1,LRPSN,2,X,1,0)):$P(^(0),"^",3),1:0),^(0)="^^"_X_"^"_DT,^(X,0)=" Added by "_$G(DUZ)_" on "_$$HTE^XLFDT($H,"M")
"RTN","LRPHSET2",134,0)
 S ^LRO(69,"AA",+$G(^LRO(69,LRODT,1,LRSN,.1)),LRODT_"|"_LRSN)=""
"RTN","LRPHSET2",135,0)
 Q
"RTN","LRPHSET2",136,0)
 ;
"RTN","LRPHSET2",137,0)
OEADD ;add test to previous order
"RTN","LRPHSET2",138,0)
 N LRADD,J
"RTN","LRPHSET2",139,0)
 S LRADD=$P(^LRO(69,DT,1,LRPSN,2,X,0),"^")
"RTN","LRPHSET2",140,0)
 S LRADD(LRADD)=""
"RTN","LRPHSET2",141,0)
 S DFN=$P(^LR(LRDFN,0),"^",3)
"RTN","LRPHSET2",142,0)
 S $P(^LRO(69,DT,1,LRPSN,2,X,0),"^",7)=""
"RTN","LRPHSET2",143,0)
 S $P(^LRO(69,DT,1,LRPSN,2,X,0),"^",14)=""
"RTN","LRPHSET2",144,0)
 N X
"RTN","LRPHSET2",145,0)
 S LRNATURE="^^^6^SERVICE CORRECTION^99ORR"
"RTN","LRPHSET2",146,0)
 D NEW^LR7OB1(DT,LRPSN,"SN",LRNATURE,.LRADD,6)
"RTN","LRPHSET2",147,0)
 Q
"RTN","LRPHSET2",148,0)
 ;
"RTN","LRPHSET2",149,0)
SWAP S LRSWAP=LRSN,LRSN=LRPSN,LRPSN=LRSWAP K LRSWAP
"RTN","LRPHSET2",150,0)
 Q
"RTN","LRPHSET2",151,0)
 ;
"RTN","LRPHSET2",152,0)
SWAP1 S LRSWAP=J,J=T,T=LRSWAP
"RTN","LRPHSET2",153,0)
 Q
"RTN","LRPHSET2",154,0)
 ;
"RTN","LRPHSET2",155,0)
URGENCY S LRURG1=$P(T(LRSAMP,T,LRPSN),U,2),LRURG2=$P(T(LRSAMP,J,LRSN),U,2),LRURG=$S(LRURG1<LRURG2:LRURG1,1:LRURG2)
"RTN","LRPHSET2",156,0)
 K LRURG1,LRURG2
"RTN","LRPHSET2",157,0)
 Q
"RTN","LRPHSET2",158,0)
 ;
"RTN","LRPHSET2",159,0)
OERR(TSTNODE) ;OE/RR - CPRS calls
"RTN","LRPHSET2",160,0)
 N X,TTT,LRNATURE,LRSJ ;OE/RR 3.0
"RTN","LRPHSET2",161,0)
 S LRSJ=J,X=$O(^ORD(100.03,"C","LRDUP",0)),LRNATURE=$$DC1^LROR6(X,"Combined with LB #"_X1)
"RTN","LRPHSET2",162,0)
 S TTT(+TSTNODE)="",DIE="^LRO(69,DT,1,LRSN,2,",DA=+T(LRSAMP,LRSJ,LRSN),DA(1)=LRSN,DA(2)=DT,DR="99.1///DUPLICATE TEST: "_$S($P($G(LRNATURE),"^",5)'="":$P(LRNATURE,"^",5),1:"")
"RTN","LRPHSET2",163,0)
 D ^DIE
"RTN","LRPHSET2",164,0)
 D NEW^LR7OB1(DT,LRSN,"OC",$G(LRNATURE),.TTT)
"RTN","LRPHSET2",165,0)
 S $P(^LRO(69,DT,1,LRSN,2,+T(LRSAMP,LRSJ,LRSN),0),"^",3,5)="^^",$P(^(0),"^",9,11)="CA^L^"_DUZ,J=LRSJ
"RTN","LRPHSET2",166,0)
 I $D(^LRO(69,DT,1,LRSN,2,+T(LRSAMP,LRSJ,LRSN),.3)) D
"RTN","LRPHSET2",167,0)
 . S $P(^LRO(69,DT,1,LRSN,2,+T(LRSAMP,LRSJ,LRSN),.3),"^")=""
"RTN","LRPHSET2",168,0)
 Q
"RTN","LRTSTSET")
0^3^B12817102^B10120516
"RTN","LRTSTSET",1,0)
LRTSTSET ;DALOI/STAFF - JAM TESTS ONTO (OR OFF) ACCESSIONS ; 19 Jun 2017  12:20 PM
"RTN","LRTSTSET",2,0)
 ;;5.2;LAB SERVICE;**65,100,121,153,201,202,263,291,350,492**;Sep 27, 1994;Build 3
"RTN","LRTSTSET",3,0)
 ;
"RTN","LRTSTSET",4,0)
 ;Formerly apart of LRTSTJAM
"RTN","LRTSTSET",5,0)
 ;
"RTN","LRTSTSET",6,0)
EN ;
"RTN","LRTSTSET",7,0)
 ; Called from LRTSTJAM, LRPHSET2
"RTN","LRTSTSET",8,0)
 I '($D(^LRO(68,LRAA,1,LRAD,1,LRAN,0))#2) D  Q
"RTN","LRTSTSET",9,0)
 . W !?10,"Sorry  This accession "_LRAN_" No longer exist"
"RTN","LRTSTSET",10,0)
 . W !?10," Accession may have been deleted.",!,$C(7)
"RTN","LRTSTSET",11,0)
 ;
"RTN","LRTSTSET",12,0)
 S ^LRO(68,LRAA,1,LRAD,1,LRAN,4,LRTS,0)=LRTS_"^"_LRURG,$P(^(0),U,9)=+LRTS
"RTN","LRTSTSET",13,0)
 S ^LRO(68,LRAA,1,LRAD,1,LRAN,4,"B",LRTS,LRTS)="",$P(^LRO(68,LRAA,1,LRAD,1,LRAN,3),U,4)=""
"RTN","LRTSTSET",14,0)
 S $P(^LRO(68,LRAA,1,LRAD,1,LRAN,4,0),U,3)=LRTS,$P(^(0),U,4)=$P(^(0),U,4)+1
"RTN","LRTSTSET",15,0)
 ;
"RTN","LRTSTSET",16,0)
 I $P(LRPARAM,U,14),$P(^LRO(68,LRAA,0),U,16) D CAP^LRWLST12
"RTN","LRTSTSET",17,0)
 ;
"RTN","LRTSTSET",18,0)
 S LRACD=$P(^LRO(68,LRAA,1,LRAD,1,LRAN,0),"^",3),LRTSAD(1,LRTS)=""
"RTN","LRTSTSET",19,0)
 I LRACD,LRACD'=LRAD D
"RTN","LRTSTSET",20,0)
 . S ^LRO(68,LRAA,1,LRACD,1,LRAN,4,LRTS,0)=LRTS_"^"_LRURG,$P(^(0),U,9)=+LRTS
"RTN","LRTSTSET",21,0)
 . S ^LRO(68,LRAA,1,LRACD,1,LRAN,4,"B",LRTS,LRTS)="",$P(^LRO(68,LRAA,1,LRAD,1,LRAN,3),"^",4)=""
"RTN","LRTSTSET",22,0)
 . I $P(LRPARAM,U,14),$P(^LRO(68,LRAA,0),U,16) D CAP^LRWLST12
"RTN","LRTSTSET",23,0)
 ;
"RTN","LRTSTSET",24,0)
 ;In certain cases, the order number in file 68 may need to be updated.
"RTN","LRTSTSET",25,0)
 ;MFLG = set by LRPHSET2 for those cases
"RTN","LRTSTSET",26,0)
 ;
"RTN","LRTSTSET",27,0)
 I $G(MFLG) D
"RTN","LRTSTSET",28,0)
 . I LRODT=""!(LRSN="") Q
"RTN","LRTSTSET",29,0)
 . S ^LRO(68,LRAA,1,LRAD,1,LRAN,.1)=$G(^LRO(69,LRODT,1,LRSN,.1))
"RTN","LRTSTSET",30,0)
 ;
"RTN","LRTSTSET",31,0)
 D ORUT^LRTSTJM1(LRDFN,LRAA,LRAD,LRAN,LRTS,LRORDTYP,LRURG,LRODT,LRSN)
"RTN","LRTSTSET",32,0)
 ;
"RTN","LRTSTSET",33,0)
 S LRADL=1
"RTN","LRTSTSET",34,0)
 ;
"RTN","LRTSTSET",35,0)
 F  L +^LRO(69,LRODT,1,LRSN):DILOCKTM Q:$T  W !?7,"Someone else is editing this order",!,$C(7) H 20
"RTN","LRTSTSET",36,0)
 ;
"RTN","LRTSTSET",37,0)
 ; Add stub entry for new test.
"RTN","LRTSTSET",38,0)
 K DA,DIC,DIE,DINUM,DO,DR
"RTN","LRTSTSET",39,0)
 ;
"RTN","LRTSTSET",40,0)
 ;The stub may already exist.
"RTN","LRTSTSET",41,0)
 ;
"RTN","LRTSTSET",42,0)
 I $D(^LRO(69,LRODT,1,LRSN,2,"B",+LRTS)) S Y=$O(^LRO(69,LRODT,1,LRSN,2,"B",+LRTS,0))_"^"_+LRTS_"^1"
"RTN","LRTSTSET",43,0)
 ;
"RTN","LRTSTSET",44,0)
 I '$D(^LRO(69,LRODT,1,LRSN,2,"B",+LRTS)) D
"RTN","LRTSTSET",45,0)
 . S DIC="^LRO(69,"_LRODT_",1,"_LRSN_",2,",DA(2)=LRODT,DA(1)=LRSN
"RTN","LRTSTSET",46,0)
 . S DIC(0)="F",X=+LRTS
"RTN","LRTSTSET",47,0)
 . D FILE^DICN
"RTN","LRTSTSET",48,0)
 ;
"RTN","LRTSTSET",49,0)
69 ; Called by LR7OMERG
"RTN","LRTSTSET",50,0)
 I Y>0 D
"RTN","LRTSTSET",51,0)
 . N LRDIE,LRFDA,LRIENS,I
"RTN","LRTSTSET",52,0)
 . S LRXDA=+Y,LRIENS=LRXDA_","_LRSN_","_LRODT_","
"RTN","LRTSTSET",53,0)
 . S LRXDA(3)=$G(^LRO(68,LRAA,1,LRAD,1,LRAN,.3))
"RTN","LRTSTSET",54,0)
 . S LRFDA(1,69.03,LRIENS,1)=LRURG
"RTN","LRTSTSET",55,0)
 . S LRFDA(1,69.03,LRIENS,2)=LRAODT
"RTN","LRTSTSET",56,0)
 . S LRFDA(1,69.03,LRIENS,3)=LRAA
"RTN","LRTSTSET",57,0)
 . S LRFDA(1,69.03,LRIENS,4)=LRAN
"RTN","LRTSTSET",58,0)
 . S LRFDA(1,69.03,LRIENS,8)="IP"
"RTN","LRTSTSET",59,0)
 . S LRFDA(1,69.03,LRIENS,9)="L"
"RTN","LRTSTSET",60,0)
 . I $P(LRXDA(3),"^")'="" D
"RTN","LRTSTSET",61,0)
 . . S LRFDA(1,69.03,LRIENS,13)=$P(LRXDA(3),"^")
"RTN","LRTSTSET",62,0)
 . . I $P(LRXDA(3),"^",2) F I=2:1:5 S LRFDA(1,69.03,LRIENS,I+12)=$P(LRXDA(3),"^",I)
"RTN","LRTSTSET",63,0)
 . D FILE^DIE("","LRFDA(1)","LRDIE(1)")
"RTN","LRTSTSET",64,0)
 . D:$G(LRTSP)
"RTN","LRTSTSET",65,0)
 . . S LRBETN=$O(^LRO(69,LRODT,1,LRSN,2,"B",LRTSP,""))
"RTN","LRTSTSET",66,0)
 . . I LRBETN D DADD^LRBEBA31(LRODT,LRSN,LRBETN,LRXDA,LRTS,$G(LRBERF))
"RTN","LRTSTSET",67,0)
 . K LRBETN,LRBERF
"RTN","LRTSTSET",68,0)
 ;
"RTN","LRTSTSET",69,0)
 I $G(LRXDA),'$G(MFLG) D
"RTN","LRTSTSET",70,0)
 . ;MFLG = comments are added in LRPHSET2 instead
"RTN","LRTSTSET",71,0)
 . N X
"RTN","LRTSTSET",72,0)
 . S X=1+$S($D(^LRO(69,LRODT,1,LRSN,2,LRXDA,1,0)):$P(^(0),"^",3),1:0),^(0)="^^"_X_"^"_DT,^(X,0)=" Added by "_$G(DUZ)_" on "_$$HTE^XLFDT($H,"M")
"RTN","LRTSTSET",73,0)
 . S ^LRO(69,"AA",+$G(^LRO(69,LRODT,1,LRSN,.1)),LRODT_"|"_LRSN)=""
"RTN","LRTSTSET",74,0)
 ;
"RTN","LRTSTSET",75,0)
 I '$D(LRFLG) K DLAYGO,DA,DIC,DIE,DR,LRXDA L -^LRO(69,LRODT,1,LRSN) Q
"RTN","LRTSTSET",76,0)
 ;
"RTN","LRTSTSET",77,0)
SETOR ;
"RTN","LRTSTSET",78,0)
 N LTS S LTS(LRTS)=""
"RTN","LRTSTSET",79,0)
 D NEW^LR7OB1(LRODT,LRSN,"SN",$G(LRNATURE),.LTS,6)
"RTN","LRTSTSET",80,0)
 K DLAYGO,DA,DIC,DIE,DR,LRBERF,LRBEFN,LRBEX
"RTN","LRTSTSET",81,0)
 L -^LRO(69,LRODT,1,LRSN)
"RTN","LRTSTSET",82,0)
 ;
"RTN","LRTSTSET",83,0)
B Q:$D(LRPHSET)
"RTN","LRTSTSET",84,0)
 W !?5,$P(^LAB(60,LRTS,0),U,1)," ADDED" ;K DIC("B") Q:$D(LRTSAD(2))  G ADDTST^LRTSTJAM
"RTN","LRTSTSET",85,0)
 Q
"VER")
8.0^22.2
"BLD",10615,6)
^395
**END**
**END**

