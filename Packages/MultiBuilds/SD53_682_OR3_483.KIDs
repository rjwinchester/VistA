KIDS Distribution saved on Sep 20, 2018@18:29:30
SD682 and OR483 combined
**KIDS**:SD*5.3*682^OR*3.0*483^

**INSTALL NAME**
SD*5.3*682
"BLD",10372,0)
SD*5.3*682^SCHEDULING^0^3180920^y
"BLD",10372,4,0)
^9.64PA^^
"BLD",10372,6.3)
10
"BLD",10372,"KRN",0)
^9.67PA^779.2^20
"BLD",10372,"KRN",.4,0)
.4
"BLD",10372,"KRN",.401,0)
.401
"BLD",10372,"KRN",.402,0)
.402
"BLD",10372,"KRN",.403,0)
.403
"BLD",10372,"KRN",.5,0)
.5
"BLD",10372,"KRN",.84,0)
.84
"BLD",10372,"KRN",3.6,0)
3.6
"BLD",10372,"KRN",3.8,0)
3.8
"BLD",10372,"KRN",9.2,0)
9.2
"BLD",10372,"KRN",9.8,0)
9.8
"BLD",10372,"KRN",9.8,"NM",0)
^9.68A^6^5
"BLD",10372,"KRN",9.8,"NM",1,0)
SDC0^^0^B36239906
"BLD",10372,"KRN",9.8,"NM",2,0)
SDN^^0^B33353252
"BLD",10372,"KRN",9.8,"NM",3,0)
SDN0^^0^B12318284
"BLD",10372,"KRN",9.8,"NM",5,0)
SDCNP1^^0^B33715154
"BLD",10372,"KRN",9.8,"NM",6,0)
SDHL7^^0^B106155934
"BLD",10372,"KRN",9.8,"NM","B","SDC0",1)

"BLD",10372,"KRN",9.8,"NM","B","SDCNP1",5)

"BLD",10372,"KRN",9.8,"NM","B","SDHL7",6)

"BLD",10372,"KRN",9.8,"NM","B","SDN",2)

"BLD",10372,"KRN",9.8,"NM","B","SDN0",3)

"BLD",10372,"KRN",19,0)
19
"BLD",10372,"KRN",19.1,0)
19.1
"BLD",10372,"KRN",101,0)
101
"BLD",10372,"KRN",409.61,0)
409.61
"BLD",10372,"KRN",771,0)
771
"BLD",10372,"KRN",779.2,0)
779.2
"BLD",10372,"KRN",870,0)
870
"BLD",10372,"KRN",8989.51,0)
8989.51
"BLD",10372,"KRN",8989.52,0)
8989.52
"BLD",10372,"KRN",8994,0)
8994
"BLD",10372,"KRN","B",.4,.4)

"BLD",10372,"KRN","B",.401,.401)

"BLD",10372,"KRN","B",.402,.402)

"BLD",10372,"KRN","B",.403,.403)

"BLD",10372,"KRN","B",.5,.5)

"BLD",10372,"KRN","B",.84,.84)

"BLD",10372,"KRN","B",3.6,3.6)

"BLD",10372,"KRN","B",3.8,3.8)

"BLD",10372,"KRN","B",9.2,9.2)

"BLD",10372,"KRN","B",9.8,9.8)

"BLD",10372,"KRN","B",19,19)

"BLD",10372,"KRN","B",19.1,19.1)

"BLD",10372,"KRN","B",101,101)

"BLD",10372,"KRN","B",409.61,409.61)

"BLD",10372,"KRN","B",771,771)

"BLD",10372,"KRN","B",779.2,779.2)

"BLD",10372,"KRN","B",870,870)

"BLD",10372,"KRN","B",8989.51,8989.51)

"BLD",10372,"KRN","B",8989.52,8989.52)

"BLD",10372,"KRN","B",8994,8994)

"BLD",10372,"QUES",0)
^9.62^^
"BLD",10372,"REQB",0)
^9.611^^
"MBREQ")
0
"PKG",16,-1)
1^1
"PKG",16,0)
SCHEDULING^SD^APPOINTMENTS,PROFILES,LETTERS,AMIS REPORTS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
5.3^2930813^2930930^520736736
"PKG",16,22,1,"PAH",1,0)
682^3180920^520736675
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","SDC0")
0^1^B36239906
"RTN","SDC0",1,0)
SDC0 ;MAN/GRR,ALB/TMP/LDB - Continuation of SDC (cancel a clinic) ; 16 JUL 2003  1:27 pm
"RTN","SDC0",2,0)
 ;;5.3;Scheduling;**303,330,379,398,467,478,545,682**;Aug 13, 1993;Build 10
"RTN","SDC0",3,0)
 ;
"RTN","SDC0",4,0)
 ;SD/467 - open matched EWL entries with canceled appointments
"RTN","SDC0",5,0)
 ;
"RTN","SDC0",6,0)
CHKEND G:NOAP END
"RTN","SDC0",7,0)
 W !,"AUTO-REBOOK IS NO LONGER ALLOWED!" G ASKL ;Patch SD*5.3*682
"RTN","SDC0",8,0)
 S %=1,DTOUT=0 W !,"WANT TO AUTO-REBOOK APPOINTMENTS NOW" D YN^DICN I '% W !,"REPLY YES (Y) OR NO (N)" G CHKEND
"RTN","SDC0",9,0)
 S ANS=$S('(%-1):"Y",1:"N") I %<0 W " NO" Q:'DTOUT
"RTN","SDC0",10,0)
ASKL S ANS="N",SDLT1="",%=1,(SDLET,SDFORM)="" W !,"WANT LETTERS PRINTED NOW" D YN^DICN I '% W !,"REPLY YES (Y) OR NO (N)" G ASKL
"RTN","SDC0",11,0)
 W:%<0 " NO" S ALS=$S('(%-1):"Y",1:"N") G:ALS'["Y" AOR
"RTN","SDC0",12,0)
EN Q:($P(^SC(SC,0),"^",3)'="C")!($D(SDVAUTC(+SC)))  S SDIV=$P(^SC(SC,0),"^",15),SDIV=$S(SDIV:SDIV,1:$O(^DG(40.8,0))) I $D(SDLT),SDIV'=SDV1 Q
"RTN","SDC0",13,0)
 K SDRE,SDIN I $D(SDLT)&($D(^SC(SC,"I"))) S SDIN=+^("I"),SDRE=+$P(^("I"),"^",2) I $D(SDIN),SDIN,SDIN'>SDBD&('$D(SDRE)!('SDRE)!(SDRE>SDED)) Q
"RTN","SDC0",14,0)
 S:'SDLT1 SDLET=$S($D(^SC(SC,"LTR")):$P(^("LTR"),"^",3),1:"") S ALS=$S(SDLET:"Y",1:"N")
"RTN","SDC0",15,0)
 I ALS="N"!(ANS="Y") S SDFFFF=1
"RTN","SDC0",16,0)
 I ALS="N" W !,"NO LETTERS ARE ASSIGNED TO THE ",$P(^SC(SC,0),"^")," CLINIC" Q:$D(SDLT)
"RTN","SDC0",17,0)
 I SDFORM="",$D(^DG(40.8,SDIV,"LTR")),^("LTR") S SDFORM=^("LTR")
"RTN","SDC0",18,0)
 I $D(SDLT),(ALS'="N") D CHK Q
"RTN","SDC0",19,0)
 Q:$D(SDLT)
"RTN","SDC0",20,0)
AOR G:ANS'["Y"&(ALS'["Y") END
"RTN","SDC0",21,0)
 I '$D(SDLT) S DGPGM="START^SDC0",DGVAR="SC^SI^CDATE^ALS^ANS^SDLET^SDTIME"_$S($D(SDIN):"^SDIN^SDRE",1:"")_"^SDFORM^SDV1^SDFFFF^AUTO#"
"RTN","SDC0",22,0)
 I '$D(SDLT) D FZIS^DGUTQ G:POP END
"RTN","SDC0",23,0)
START U IO I ANS'["Y"&('$D(SDLT)) D:ALS["Y" APP D END Q
"RTN","SDC0",24,0)
BEG1 N SDFIRST
"RTN","SDC0",25,0)
 I $D(SDLT) S SDAR=$S('VAUTC:"VAUTC",1:"^SC"),ANS="N",ALS="Y" D
"RTN","SDC0",26,0)
 .F SC=0:0 S SC=$O(@(SDAR_"("_SC_")")) Q:SC'>0  D
"RTN","SDC0",27,0)
 ..K SDOK1 D EN I $D(SDOK1),SDLET D
"RTN","SDC0",28,0)
 ...F SD=(SDBD-.1):0 S SD=$O(^SC(SC,"S",SD)) S CDATE=SD Q:SD>(SDED+.999999)!(SD'>0)  D
"RTN","SDC0",29,0)
 ....D DUP
"RTN","SDC0",30,0)
 S SDFIRST=$S($G(SDFFFF)=1:0,1:1)
"RTN","SDC0",31,0)
 I $D(SDLT),$D(^UTILITY("SDLT",$J)) D PR^SDC3,END Q
"RTN","SDC0",32,0)
 Q:$D(SDLT)  D ^SDAUT1
"RTN","SDC0",33,0)
 I MAX=0 W !,"AUTO-REBOOKING NOT ALLOWED FOR THIS CLINIC" G APP:ALS["Y",END
"RTN","SDC0",34,0)
 F GDATE=CDATE:0 S GDATE=$O(^SC(SC,"S",GDATE)) Q:GDATE=""!(GDATE>(CDATE+1))  D
"RTN","SDC0",35,0)
 .F L=0:0 S L=$O(^SC(SC,"S",GDATE,1,L)) Q:L=""  D  Q:POP  S A=^SC(SC,"S",GDATE,1,L,0) I $D(^DPT(+A,"S",GDATE,0)),$P(^(0),"^",2)="C",$P(^(0),"^",14)=SDTIME D ^SDAUT2,^SDCCP
"RTN","SDC0",36,0)
 ..S POP=0
"RTN","SDC0",37,0)
 ..I '$D(^SC(SC,"S",GDATE,1,L,0)) I $D(^("C")) S J=GDATE,J2=L D DELETE^SDC1 K J,J2 S POP=1 Q  ;SD*545 delete corrupt record
"RTN","SDC0",38,0)
 ..I '+$G(^SC(SC,"S",GDATE,1,L,0)) S J=GDATE,J2=L D DELETE^SDC1 K J,J2 S POP=1 Q  ;SD*545 delete corrupt record
"RTN","SDC0",39,0)
 K POP
"RTN","SDC0",40,0)
 D:ALS["Y" APP
"RTN","SDC0",41,0)
END ;
"RTN","SDC0",42,0)
 D:$G(SC)>0&($G(CDATE)>0) RESOLVE
"RTN","SDC0",43,0)
 K %,%DT,%H,%I,%DT,%IS,%ZIS,A,ALS,ANS,BY,CDATE,CHAR,DA,DFN,DH,DHD,DIC,DIS,DO,DOW,FLDS,FR,GDATE,I,L,LET,MAX,NOAP,P,POP,SI,SL,SS,ST,SDSTRTDT,TO,X,Y,ADDR,B,CLIN,HX,L0,L1,L2,LL,PDAT,S,TIME,Z,D,ENDATE,J,SM,STIME,X1,X2,SDX1,SDX2,SDRE,SDRE1,SDIN,FSW
"RTN","SDC0",44,0)
 K ^TMP("SDC0",$J),SDAP,SDAPNUM
"RTN","SDC0",45,0)
 K SC,SD,Z0,Z5,DGPGM,DUPE,J2,MESS,NDATE,SDDIF,SDFORM,SDINP,SDFORM,SDLET,SDLT1,SDNODE,SDRT,SDSOH,SDST,SDV1,DGVAR,SD1,SD8,SD81,SDANS,SDCNT,SDERR,SDHTO,SDJ,SDTIME,SDZ,STARTDAY,SD82,SDOK,SDOK1,SDLE,SDZ,SDOK1,TST,W,^UTILITY("SD")
"RTN","SDC0",46,0)
 K SDFFFF,DIW,DIWF,DIWL,DIWR,DIWT,DN,DUPE,J2,MESS,NDATE,SDADD,SDC,SDCL,SDDAT,SDDIF,SDFORM,SDHX,SDINP,SDIV,SDLET,SDNODE,SDRT,SDSOH,SDST,SDT0,TST,SDV1,^TMP($J,"BADADD") D CLOSE^DGUTQ Q
"RTN","SDC0",47,0)
CHK K SDOK1 I $D(^SC(SC,"SL")) S SL=^("SL"),%=$P(SL,"^",6),SI=$S(%="":4,%<3:4,%:%,1:4) S SDOK1=1 K SL,% E  W $P(^SC(SC,0),"^")," does not have an appointment length indicated."
"RTN","SDC0",48,0)
 Q
"RTN","SDC0",49,0)
RESOLVE ;evaluate canceled and rebooked appointments with relation to EWL
"RTN","SDC0",50,0)
 S GDATE=CDATE K ^TMP("SDWLREB",$J),^TMP($J,"SDWLPL")
"RTN","SDC0",51,0)
 F  S GDATE=$O(^SC(SC,"S",GDATE)) Q:GDATE=""!(GDATE>(CDATE+1))  S L=0 F  S L=$O(^SC(SC,"S",GDATE,1,L)) Q:L=""  D
"RTN","SDC0",52,0)
 .I '$D(^SC(SC,"S",GDATE,1,L,0)) I $D(^("C")) S J=GDATE,J2=L D DELETE^SDC1 K J,J2 Q  ;SD*5.3*545 delete corrupt record
"RTN","SDC0",53,0)
 .I '+$G(^SC(SC,"S",GDATE,1,L,0)) S J=GDATE,J2=L D DELETE^SDC1 K J,J2 Q  ;SD*5.3*545 delete corrupt record with missing DFN
"RTN","SDC0",54,0)
 .S DFN=+^SC(SC,"S",GDATE,1,L,0)
"RTN","SDC0",55,0)
 .N RBFLG,SDTRB,SDCAN,SDREB S SDREB=0 D REBOOK^SDWLREB(DFN,GDATE,SC,.RBFLG,.SDTRB,.SDCAN) Q:SDCAN'=SDTIME
"RTN","SDC0",56,0)
 .I $E(RBFLG,1,2)'="CC" Q  ;not canceled by clinic
"RTN","SDC0",57,0)
 .I RBFLG="CCR" S SDREB=1 D DISREB^SDWLREB(DFN,SDTRB,SC)
"RTN","SDC0",58,0)
 .D OPENEWL^SDWLREB(DFN,GDATE,SC,SDREB) K ^TMP($J,"APPT"),^TMP($J,"SDWLPL")
"RTN","SDC0",59,0)
 I $D(^TMP("SDWLREB",$J)) D MESS^SDWLREB
"RTN","SDC0",60,0)
 Q
"RTN","SDC0",61,0)
 ;
"RTN","SDC0",62,0)
DUP ;SCREEN FOR DUPLICATE PATIENTS - SD*5.3*379
"RTN","SDC0",63,0)
 S SDAP="" F  S SDAP=$O(^SC(SC,"S",SD,SDAP)) Q:SDAP=""  D
"RTN","SDC0",64,0)
 .S SDAPNUM="" F  S SDAPNUM=$O(^SC(SC,"S",SD,SDAP,SDAPNUM)) Q:SDAPNUM=""  D
"RTN","SDC0",65,0)
 ..I '$D(^SC(SC,"S",SD,SDAP,SDAPNUM,0)) I $D(^("C")) S J=SD,J2=SDAPNUM D DELETE^SDC1 Q  ;SD*545 delete corrupt record
"RTN","SDC0",66,0)
 ..I '+$G(^SC(SC,"S",SD,SDAP,SDAPNUM,0)) S J=SD,J2=SDAPNUM D DELETE^SDC1 Q  ;SD*545 if DFN missing delete record
"RTN","SDC0",67,0)
 ..I $D(^SC(SC,"S",SD,SDAP,SDAPNUM,0)) D
"RTN","SDC0",68,0)
 ...S A=$P(^SC(SC,"S",SD,SDAP,SDAPNUM,0),"^",1)
"RTN","SDC0",69,0)
 ...I '$D(^TMP("SDC0",$J,SD,A)) S ^TMP("SDC0",$J,SD,A)="" D ^SDC3
"RTN","SDC0",70,0)
 Q
"RTN","SDC0",71,0)
APP I $G(SDFFFF)=1 S SDFIRST=0
"RTN","SDC0",72,0)
 F GDATE=CDATE:0 S GDATE=$O(^SC(+SC,"S",GDATE)) Q:GDATE=""!(GDATE>(CDATE+1))  F L=0:0 S L=$O(^SC(+SC,"S",GDATE,1,L)) Q:L=""  D  Q:POP  S A=^SC(+SC,"S",GDATE,1,L,0) D CHECK
"RTN","SDC0",73,0)
 .S POP=0
"RTN","SDC0",74,0)
 .I '$D(^SC(+SC,"S",GDATE,1,L,0)) I $D(^("C")) S J=GDATE,J2=L D DELETE^SDC1 K J,J2 S POP=1 Q  ;SD*545 delete corrupt record
"RTN","SDC0",75,0)
 .I '+$G(^SC(+SC,"S",GDATE,1,L,0)) S J=GDATE,J2=L D DELETE^SDC1 K J,J2 S POP=1 Q  ;SD*545 if DFN missing delete record
"RTN","SDC0",76,0)
 .Q
"RTN","SDC0",77,0)
 K POP
"RTN","SDC0",78,0)
 I $D(^TMP($J,"BADADD")) D BADADD^SDLT K ^TMP($J,"BADADD")
"RTN","SDC0",79,0)
 Q
"RTN","SDC0",80,0)
CHK1 S (SDX,X)=GDATE D WRAPP^SDLT
"RTN","SDC0",81,0)
 I $P(S,"^",2)'["A" D REST^SDLT Q
"RTN","SDC0",82,0)
 S SDX=$P(S,"^",10) I '$D(^DPT(+A,"S",SDX,0)) D REST^SDLT Q
"RTN","SDC0",83,0)
 W !!,"The cancelled appointment(s) were rescheduled as follows:",!
"RTN","SDC0",84,0)
 S S=^DPT(+A,"S",SDX,0) D WRAPP^SDLT,REST^SDLT
"RTN","SDC0",85,0)
 Q
"RTN","SDC0",86,0)
CHECK I $$BADADR^DGUTL3(+A) S ^TMP($J,"BADADD",$P(^DPT(+A,0),"^"),+A)="" Q
"RTN","SDC0",87,0)
 ;
"RTN","SDC0",88,0)
 ;SCREEN FOR DUPLICATES - SD*5.3*379
"RTN","SDC0",89,0)
 ;
"RTN","SDC0",90,0)
 I $D(^TMP("SDC0",$J,GDATE,A)) Q
"RTN","SDC0",91,0)
 S ^TMP("SDC0",$J,GDATE,A)=""
"RTN","SDC0",92,0)
 I $S('$D(^DPT(+A,.35)):1,$P(^DPT(+A,.35),"^",1)']"":1,1:0),$D(^DPT(+A,"S",GDATE)),$P(^DPT(+A,"S",GDATE,0),"^",2)["C",$P(^(0),"^",14)=SDTIME!(SDTIME="*") S S=^DPT(+A,"S",GDATE,0) D ^SDLT,CHK1
"RTN","SDCNP1")
0^5^B33715154
"RTN","SDCNP1",1,0)
SDCNP1 ;ALB/LDB - CANCEL APPOINTMENT (cont.) ; 5/25/12 11:42am
"RTN","SDCNP1",2,0)
 ;;5.3;Scheduling;**398,467,478,554,597,682**;Aug 13, 1993;Build 10
"RTN","SDCNP1",3,0)
 ;
"RTN","SDCNP1",4,0)
 ;SD/467 - EWL Open Matched Entry with rebook
"RTN","SDCNP1",5,0)
NOPE W !,*7,$S(CNT:CNT_" Appointment"_$S(CNT>1:"s",1:"")_" cancelled",1:"NOTHING CANCELLED")
"RTN","SDCNP1",6,0)
 N SDCLNK S SDCLNK=$G(SC) ; Hold value of SC for EWL Notification call
"RTN","SDCNP1",7,0)
 S SDCNT=CNT,SDA=1,SDCNT1=0 I CNT,$S('$D(^DPT(DFN,.35)):1,'$P(^(.35),U):1,1:0) S (SDA,X8)=0 D ASK G:X8="^" END
"RTN","SDCNP1",8,0)
 ;no rebooking to take place; open EWL entries only if applicable
"RTN","SDCNP1",9,0)
 I $D(DFN)>0 D EWL(DFN) ;SD/467
"RTN","SDCNP1",10,0)
 I SDA,SDCNT W !,*7,"NO AUTO-REBOOKING --Patient has died."
"RTN","SDCNP1",11,0)
 I 'SDA,SDCNT S A=DFN D LOOP1^SDCNP1A,LET,CANQ^SDAMC(DFN,$G(SDCLNK)) K SDCLNK
"RTN","SDCNP1",12,0)
 ;Calls subroutine CANQ to display wait list message if applicable. - PATCH SD*5.3*597
"RTN","SDCNP1",13,0)
END K:'$D(DIROUT) DFN D END^SDCNP Q:$D(DIROUT)  G RD^SDCNP
"RTN","SDCNP1",14,0)
 ;Remove AUTO-REBOOK quit at ASK line, SD*5.3*682
"RTN","SDCNP1",15,0)
ASK Q
"RTN","SDCNP1",16,0)
 S (SDCTR,SDCTRL)=0,%=2 W !!,"DO YOU WISH TO REBOOK ANY APPOINTMENT(S) THAT YOU HAVE CANCELLED" D YN^DICN S ALS=% D:'% REASK G:'% ASK I %-1 S CNT=0 S:%<0 X8="^" D  Q
"RTN","SDCNP1",17,0)
 .W !,"OK"
"RTN","SDCNP1",18,0)
 W !!,"PLEASE NOTE THAT YOU MUST ENTER A DEVICE TO AUTO-REBOOK",!
"RTN","SDCNP1",19,0)
ZIS S %ZIS("A")="DEVICE TO OUTPUT REBOOKED APPT(S). :",%ZIS="QN" D ^%ZIS I POP S X8="^" Q
"RTN","SDCNP1",20,0)
 S L=0 F  S L=$O(^UTILITY($J,"SDCNP",L)) Q:'L  I $P(^(L),U,4)="*** JUST CANCELLED ***" S ^UTILITY($J,"SDCNP1",DFN,$P(^(L),"^",2),$P(^(L),"^"))=^(L)
"RTN","SDCNP1",21,0)
 D SDLST
"RTN","SDCNP1",22,0)
LST S B=0 F  S B=$O(^UTILITY($J,"SDCNP2",DFN,B)) Q:'B  W !!,$J($S(B\1=B:"("_$J(B,2)_") ",1:""),5) S AT=$S($P(^(B),"^",2)'?.N:1,1:0),Y=$P($P(^(B),"^"),".") D DT^SDM0 S X=$P(^(B),"^") X ^DD("FUNC",2,1) W " ",$J(X,8) S Z1(B)="" D MORE Q:SDCTRL
"RTN","SDCNP1",23,0)
 D WH
"RTN","SDCNP1",24,0)
 I B>0 G:SDCTRL&(A8']"") NOPE1 G:SDCTRL DEL
"RTN","SDCNP1",25,0)
 Q
"RTN","SDCNP1",26,0)
SDLST S L1=0 S Z5=0 F  S Z5=$O(^UTILITY($J,"SDCNP1",DFN,Z5)) Q:'Z5  F Z6=0:0 S Z7=Z6,Z6=$O(^UTILITY($J,"SDCNP1",DFN,Z5,Z6)) I Z6="" S L1=L1+1,^UTILITY($J,"SDCNP2",DFN,L1)=Z7_"^"_Z5_"^"_$P(^(Z7),"^",3,6) Q
"RTN","SDCNP1",27,0)
 Q
"RTN","SDCNP1",28,0)
MORE S SDCTR=SDCTR+2 I AT W ?41,$P(^UTILITY($J,"SDCNP2",B),"^",2) G OVR
"RTN","SDCNP1",29,0)
 S S5=^UTILITY($J,"SDCNP2",DFN,B) W " (",$P(S5,"^",6)," MINUTES)  ",$S($D(^SC($P(S5,"^",2),0)):$P(^(0),"^",1),1:"DELETED CLINIC"),$P(S5,"^",3) S M1=$P(^SC($P(S5,"^",2),"SDP"),"^",4) W !,?41,"Max days for rebooking= ",M1
"RTN","SDCNP1",30,0)
OVR I SDCTR>20,$O(^UTILITY($J,"SDCNP2",B))>0 S (SDCTRL,SDCTR)=0 W *7 D WH W:'SDCTRL @IOF
"RTN","SDCNP1",31,0)
 Q
"RTN","SDCNP1",32,0)
WH W !!,"SELECT APPOINTMENT(S) TO BE REBOOKED" W:B>0 " OR HIT RETURN TO CONTINUE DISPLAY" R ": ",A8:DTIME I '$T!(A8="^") S SDCTRL=1,A8="",X8="^" Q
"RTN","SDCNP1",33,0)
 I A8["?" X SDMSG G WH
"RTN","SDCNP1",34,0)
DEL S SDERR=0 F J=1:1 S SDDH=$P(A8,",",J) Q:SDDH']""  D MTCH
"RTN","SDCNP1",35,0)
 I SDERR G LST
"RTN","SDCNP1",36,0)
DEL1 S SDERR=0 F J=1:1 S SDDH=$P(A8,",",J) Q:SDDH']""  S SDDI=$P(SDDH,"-"),SDDM=$P(SDDH,"-",2) D CKK^SDCNP1A Q:SDERR  D CKK2^SDCNP1A Q:SDERR  F Z9=SDDI:1:$S(SDDM:SDDM,1:SDDI) D:SDDI REBK I 'SDDI S SDERR=1 Q
"RTN","SDCNP1",37,0)
 G:SDERR LST Q:A8["^"!(A8="")  S SDERR=0 D ^SDCNP1A Q:X8="^"
"RTN","SDCNP1",38,0)
 D:MAX QUE
"RTN","SDCNP1",39,0)
 D NOPE1
"RTN","SDCNP1",40,0)
 Q 
"RTN","SDCNP1",41,0)
LET ;
"RTN","SDCNP1",42,0)
 S %=2 W !!,"DO YOU WISH TO PRINT LETTERS FOR THE CANCELLED APPOINTMENT(S)" D YN^DICN S ANS="Y" D:'% REASK G:'% LET Q:(%-1)
"RTN","SDCNP1",43,0)
 I $$BADADR^DGUTL3(+DFN) D  Q  ;display, don't print BAI list
"RTN","SDCNP1",44,0)
 . W *7,!,"** THIS PATIENT HAS BEEN FLAGGED WITH A BAD ADDRESS INDICATOR, NO LETTER"
"RTN","SDCNP1",45,0)
 . W !,"WILL BE PRINTED."
"RTN","SDCNP1",46,0)
 . S DIR(0)="E" D ^DIR K DIR(0)
"RTN","SDCNP1",47,0)
QUE2 ;S DGPGM="SDLET^SDCNP1A",DGVAR="SDCL#^DUZ^DFN^DT^A^SDWH" D ZIS^DGUTQ D:POP CLOSE^DGUTQ Q:POP  D SDLET^SDCNP1A Q
"RTN","SDCNP1",48,0)
 S %ZIS="MQ" K IO("Q") D ^%ZIS Q:POP  ;SD/478
"RTN","SDCNP1",49,0)
 I $D(IO("Q")) D  D:IO'=IO(0) NOTELTR D ^%ZISC W @IOF Q  ;SD/478
"RTN","SDCNP1",50,0)
 .S ZTRTN="SDLET^SDCNP1A" F ZTS="SDCL(","DUZ","DFN","DT","A","SDWH","AUTO(" S ZTSAVE(ZTS)=""  ;SD/478
"RTN","SDCNP1",51,0)
 .K ZTS D ^%ZTLOAD  ;SD/478
"RTN","SDCNP1",52,0)
 D:IO'=IO(0) NOTELTR D SDLET^SDCNP1A,^%ZISC W @IOF  ;SD/478
"RTN","SDCNP1",53,0)
 Q  ;SD/478
"RTN","SDCNP1",54,0)
NOTELTR I ANS["Y",ALS=1 S:$D(CNDIE) @(CNDIE_CNDA_",1,CNINDX,0)")="CANCEL APPOINTMENT AUTO REBOOK letter printed." K CNDIE,CNDA,CNINDX ;SD/478 CANCEL APPT AUTO REBOOK LETTER PRINTED.
"RTN","SDCNP1",55,0)
 I ANS["Y" S:$D(CNDIE) @(CNDIE_CNDA_",1,CNINDX,0)")="CANCEL APPOINTMENT letter printed." K CNDIE,CNDA,CNINDX ;SD/478 CANCEL APPT LETTER IS PRINTED.
"RTN","SDCNP1",56,0)
 Q
"RTN","SDCNP1",57,0)
QUE I IO'=IO(0) S DGPGM="^SDCNP2",DGVAR="SDCL#^NDATE^A^GDATE^DT^DUZ",IOP=IO,X="NOW" D Q1^DGUTQ Q
"RTN","SDCNP1",58,0)
 U IO I IO=IO(0),$E(IOST,1,2)="C-" S SDIO=1 D ^SDCNP2 Q
"RTN","SDCNP1",59,0)
NOPE1 W @IOF,!,*7,$S(SDCNT1:SDCNT1_" Appointment"_$S(SDCNT1>1:"s",1:"")_" rebooked",1:"NOTHING REBOOKED") Q
"RTN","SDCNP1",60,0)
REBK K ^UTILITY($J,"SDCNP") S ^UTILITY($J,"SDCNP2","REBK",DFN,Z9)=^UTILITY($J,"SDCNP2",DFN,Z9)
"RTN","SDCNP1",61,0)
 Q
"RTN","SDCNP1",62,0)
 F A9=SDDI,SDDM Q:'SDDM&(SDDI-A9)  I '$D(Z1(A9)) S SDERR=1 W !,*7,"There is no appointment number ",A9
"RTN","SDCNP1",63,0)
 Q
"RTN","SDCNP1",64,0)
REASK W !,"ANSWER (Y)ES OR (N)O" Q
"RTN","SDCNP1",65,0)
CLRK S $P(^DPT(DFN,"S",S,0),"^",19)=$P(SDNODE,"^",7),$P(^DPT(DFN,"S",S,0),"^",18)=$P(SDNODE,"^",6) Q
"RTN","SDCNP1",66,0)
MTCH Q:SDDH?1N.N!(SDDH?1.N1"-".N)  S SDERR=1 X SDMSG
"RTN","SDCNP1",67,0)
 Q
"RTN","SDCNP1",68,0)
EWL(DFN) ;
"RTN","SDCNP1",69,0)
 I '$D(^UTILITY($J,"SDCNP1")) I '$D(^UTILITY($J,"SDCNP")) Q
"RTN","SDCNP1",70,0)
 ;call to EWL to open and optionally close EWL entry with rebooked appointment
"RTN","SDCNP1",71,0)
 N SDFRB,SDT,SC,SDREB K ^TMP("SDWLREB",$J),^TMP($J,"SDWPL"),^TMP($J,"APPT")
"RTN","SDCNP1",72,0)
 I $D(^UTILITY($J,"SDCNP1")) S SDFRB="^UTILITY($J,""SDCNP1"")"  D REB I $D(^TMP("SDWLREB",$J)) D MESS^SDWLREB Q
"RTN","SDCNP1",73,0)
 E  S SDFRB="^UTILITY($J,""SDCNP"")" D CAN I $D(^TMP("SDWLREB",$J)) D MESS^SDWLREB
"RTN","SDCNP1",74,0)
 Q
"RTN","SDCNP1",75,0)
REB I $D(^UTILITY($J,"SDCNP1")) F  S SDFRB=$Q(@SDFRB) Q:SDFRB'["SDCNP1"  S SDT=$P(@SDFRB,U),SC=$P(@SDFRB,U,2),SDREB=0 D
"RTN","SDCNP1",76,0)
 .;N NN F NN=1:1 Q:'$D(^UTILITY($J,"SDCNP","REBK",DFN,NN))  I $P($G(^UTILITY($J,"SDCNP2","REBK",DFN,NN)),U)=SDT S SDREB=1 Q
"RTN","SDCNP1",77,0)
 .N RBFLG,SDTRB D REBOOK^SDWLREB(DFN,SDT,SC,.RBFLG,.SDTRB)
"RTN","SDCNP1",78,0)
 .I $E(RBFLG,1,2)'="CC" Q  ;not canceled by clinic
"RTN","SDCNP1",79,0)
 .I RBFLG="CCR" S SDREB=1 D DISREB^SDWLREB(DFN,SDTRB,SC)
"RTN","SDCNP1",80,0)
 .D OPENEWL^SDWLREB(DFN,SDT,SC,SDREB) K ^TMP($J,"APPT"),^TMP($J,"SDWLPL")
"RTN","SDCNP1",81,0)
 Q
"RTN","SDCNP1",82,0)
CAN I $D(^UTILITY($J,"SDCNP")) F  S SDFRB=$Q(@SDFRB) Q:SDFRB'["SDCNP"  I @SDFRB["CANCELLED" S SDT=$P(@SDFRB,U),SC=$P(@SDFRB,U,2),SDREB=0 D
"RTN","SDCNP1",83,0)
 .N RBFLG,SDTRB D REBOOK^SDWLREB(DFN,SDT,SC,.RBFLG,.SDTRB)
"RTN","SDCNP1",84,0)
 .I $E(RBFLG,1,2)'="CC" Q  ;not canceled by clinic
"RTN","SDCNP1",85,0)
 .I RBFLG="CCR" S SDREB=1 D DISREB^SDWLREB(DFN,SDTRB,SC)
"RTN","SDCNP1",86,0)
 .D OPENEWL^SDWLREB(DFN,SDT,SC,SDREB) K ^TMP($J,"APPT"),^TMP($J,"SDWLPL")
"RTN","SDCNP1",87,0)
 Q
"RTN","SDHL7")
0^6^B106155934
"RTN","SDHL7",1,0)
SDHL7 ;SLC/AGP - RTC Order HL7 receiver;11:53 AM  19 Jun 2017
"RTN","SDHL7",2,0)
 ;;5.3;Scheduling;**671,682**;Aug 13, 1993;Build 10
"RTN","SDHL7",3,0)
 ;
"RTN","SDHL7",4,0)
 ;RESULT("REQ FILE IEN")=0 REQUEST IEN if defined then the user is trying to modify or discontinue the order before scheduling disposition it.
"RTN","SDHL7",5,0)
 ;RESULT("APPT TYPE")="followup" Generic HL7 type for appointment type.Should be modify in the future when VSE and CPRS have more time to work on it
"RTN","SDHL7",6,0)
 ;RESULT("CHANGE")=1 If defined the REQ IEN (REQ FILE IEN) should be defined the user change the order before scheduling disposition it.
"RTN","SDHL7",7,0)
 ;RESULT("CLINIC")="240^20 MINUTE" file 44 IEN^entry .01 field
"RTN","SDHL7",8,0)
 ;RESULT("COMMENT")="This is the new comment field"
"RTN","SDHL7",9,0)
 ;RESULT("DISCONTINUE")=1 If defined the REQ IEN (REQ FILE IEN) should be defined the user discontinue the order before scheduling disposition it.
"RTN","SDHL7",10,0)
 ;RESULT("ENTERED BY")="10000000195^PULEO,ANTHONY" the person who entere
"RTN","SDHL7",11,0)
 ;RESULT("INTERVAL")="Q7D" only defined if the number of appointments in greater then 1
"RTN","SDHL7",12,0)
 ;RESULT("MSG ID")="" ID to track rejection ORDER IEN^ACTION (S03, S05,S01)
"RTN","SDHL7",13,0)
 ;RESULT("NEW ORDER")=1 this is the request of a new RTC order being placed in CPRS.
"RTN","SDHL7",14,0)
 ;RESULT("NLT")=1 If this is a No Later Than appointment request
"RTN","SDHL7",15,0)
 ;RESULT("NUMBER APPT")=4 total number of appointment requested
"RTN","SDHL7",16,0)
 ;RESULT("ORDER IEN")=14524362 IEN from file 100
"RTN","SDHL7",17,0)
 ;RESULT("PATIENT")="346^RECORD, THREE"
"RTN","SDHL7",18,0)
 ;RESULT("PREREQ,1)="LAB" user can select prereq in CPRS. It is up to scheduling if they want to use this information
"RTN","SDHL7",19,0)
 ;RESULT("PREREQ",2)="XRAY"
"RTN","SDHL7",20,0)
 ;RESULT("PREREQ",3)="VITALS"
"RTN","SDHL7",21,0)
 ;RESULT("RTC DATE")=20170524 Requested date for the Return To Clinic appointment
"RTN","SDHL7",22,0)
 ;RESULT("SIGNED BY")="10000000195^PULEO,ANTHONY" the person who signedthe order, file 200 IEN^entry .01 field
"RTN","SDHL7",23,0)
 ;
"RTN","SDHL7",24,0)
 ;if RESULT("REJECTION ERROR") is defined. It means CPRS rejected the message update. The user should be aware of the error message
"RTN","SDHL7",25,0)
 ;so the data should cann be cleanup
"RTN","SDHL7",26,0)
 ;
"RTN","SDHL7",27,0)
 ;TODO: WIRE UP RESULT("REJECTION ERROR") TO REPORT BACK TO THE GUI
"RTN","SDHL7",28,0)
 ;
"RTN","SDHL7",29,0)
EN(MSG) ; -- main entry point for OR RECEIVE where MSG contains HL7 msg
"RTN","SDHL7",30,0)
 N ACTION,AIG,AIL,ARQ,DATE,ENTER,ERROR,FREQ,FAILMSA,HASMSA,INST,MSH,NODE,NUM,NXT,PAT,RESULT,SDMSG,X,PID,PV1,SEG,SIGN
"RTN","SDHL7",31,0)
 S ERROR=""
"RTN","SDHL7",32,0)
 S SDMSG=$S($L($G(MSG)):MSG,1:"MSG") ; MSG="NAME" or MSG(#)=message
"RTN","SDHL7",33,0)
 I '$O(@SDMSG@(0)) S ERROR="Missing HL7 message" Q
"RTN","SDHL7",34,0)
 S MSH=0 F  S MSH=$O(@SDMSG@(MSH)) Q:MSH'>0  Q:$E(@SDMSG@(MSH),1,3)="MSH"
"RTN","SDHL7",35,0)
 I 'MSH S ERROR="Missing or invalid MSH segment" Q
"RTN","SDHL7",36,0)
 S X=0,FAILMSA=0,HASMSA=0 F  S X=$O(@SDMSG@(X)) Q:X'>0!(ERROR'="")!(HASMSA=1)  D
"RTN","SDHL7",37,0)
 .S SEG=$P(@SDMSG@(X),"|"),NODE=$P(@SDMSG@(X),"|",2,99)
"RTN","SDHL7",38,0)
 .I SEG="MSA" S HASMSA=1
"RTN","SDHL7",39,0)
 .S SEG=SEG_"(.RESULT,X,NODE,.ERROR)"
"RTN","SDHL7",40,0)
 .D @SEG
"RTN","SDHL7",41,0)
 I FAILMSA=1 D REJECT(.RESULT) G ENX
"RTN","SDHL7",42,0)
 I HASMSA=1 G ENX
"RTN","SDHL7",43,0)
 I ERROR'="" D SENDFAIL(.ERROR,.RESULT) G ENX
"RTN","SDHL7",44,0)
 ;HANDLE REJECTION ERRORS
"RTN","SDHL7",45,0)
 I $D(RESULT("REJECTION ERROR")) S ^TMP($J,"REJECT",RESULT("REQ FILE IEN"))=RESULT("REJECTION ERROR") G ENX
"RTN","SDHL7",46,0)
 ;DISCONTINUE REQUEST
"RTN","SDHL7",47,0)
 I $G(RESULT("DISCONTINUE"))=1 D VALDDIS(.RESULT,.ERROR)
"RTN","SDHL7",48,0)
 I ERROR="" D DISCONT(.RESULT,.ERROR)
"RTN","SDHL7",49,0)
 I ERROR'=""  D SENDFAIL(.ERROR,.RESULT) G ENX
"RTN","SDHL7",50,0)
 ;NEW OR CHANGE REQUEST
"RTN","SDHL7",51,0)
 I $G(RESULT("DISCONTINUE"))'=1 D VALIDATE(.RESULT,.ERROR)
"RTN","SDHL7",52,0)
 I ERROR="" D SAVEREC(.RESULT,.ERROR)
"RTN","SDHL7",53,0)
 I ERROR'="" D SENDFAIL(.ERROR,.RESULT) G ENX
"RTN","SDHL7",54,0)
 D SENDOK(.RESULT)
"RTN","SDHL7",55,0)
ENX ;
"RTN","SDHL7",56,0)
 Q
"RTN","SDHL7",57,0)
 ;
"RTN","SDHL7",58,0)
MSA(RESULT,X,SEG,ERROR) ;
"RTN","SDHL7",59,0)
 I $P(SEG,"|")'="AR" Q
"RTN","SDHL7",60,0)
 S RESULT("REJECTION ERROR")=$P(SEG,"|",2) S FAILMSA=1
"RTN","SDHL7",61,0)
 Q
"RTN","SDHL7",62,0)
 ;
"RTN","SDHL7",63,0)
MSH(RESULT,X,SEG,ERROR) ;
"RTN","SDHL7",64,0)
 S RESULT("MSG ID")=$P(SEG,"|",9)
"RTN","SDHL7",65,0)
 S RESULT("MSG DATE/TIME")=$$HL7TFM^XLFDT($P(SEG,"|",6),"L")
"RTN","SDHL7",66,0)
 Q
"RTN","SDHL7",67,0)
 ;
"RTN","SDHL7",68,0)
ARQ(RESULT,X,SEG,ERROR) ;
"RTN","SDHL7",69,0)
 S RESULT("ORDER IEN")=+$P(SEG,"|"),RESULT("REQ FILE IEN")=+$P(SEG,"|",2)
"RTN","SDHL7",70,0)
 S RESULT("APPT TYPE")=$P($P(SEG,"|",5),U,2)
"RTN","SDHL7",71,0)
 S ACTION=$P(SEG,"|",6) S RESULT($S(ACTION="S05":"DISCONTINUE",ACTION="S03":"CHANGE",1:"NEW ORDER"))=1
"RTN","SDHL7",72,0)
 S DATE=$P(SEG,"|",8),TIME=$P(SEG,"|",9)
"RTN","SDHL7",73,0)
 I TIME="T" S RESULT("NLT")=1
"RTN","SDHL7",74,0)
 S RESULT("RTC DATE")=$$HL7TFM^XLFDT($S(TIME="T":$P(DATE,U,2),1:$P(DATE,U)),"L")
"RTN","SDHL7",75,0)
 S FREQ=$P(SEG,"|",10),NUM=$P(SEG,"|",11)
"RTN","SDHL7",76,0)
 S RESULT("NUMBER APPT")=NUM I NUM>0 S RESULT("INTERVAL")=+$E(FREQ,2,3)
"RTN","SDHL7",77,0)
 S RESULT("SIGNED BY")=$P(SEG,"|",12)
"RTN","SDHL7",78,0)
 S RESULT("ENTERED BY")=$P(SEG,"|",16)
"RTN","SDHL7",79,0)
 Q
"RTN","SDHL7",80,0)
 ;
"RTN","SDHL7",81,0)
AIL(RESULT,X,SEG,ERROR) ;
"RTN","SDHL7",82,0)
 S RESULT("CLINIC")=$P(SEG,"|",3)
"RTN","SDHL7",83,0)
 Q
"RTN","SDHL7",84,0)
AIG(RESULT,X,SEG,ERROR) ;
"RTN","SDHL7",85,0)
 N INST,NODE
"RTN","SDHL7",86,0)
 S RESULT("PREREQ",$P(SEG,"|"))=$P($P(SEG,"|",2),U,2)
"RTN","SDHL7",87,0)
 S INST=0 F  S INST=$O(@SDMSG@(X,INST)) Q:INST'>0  D
"RTN","SDHL7",88,0)
 .S NODE=$P(@SDMSG@(X,INST),"|",2,99)
"RTN","SDHL7",89,0)
 .S RESULT("PREREQ",$P(NODE,"|"))=$P($P(NODE,"|",2),U,2)
"RTN","SDHL7",90,0)
 Q
"RTN","SDHL7",91,0)
 ;
"RTN","SDHL7",92,0)
NTE(RESULT,X,SEG,ERROR) ;
"RTN","SDHL7",93,0)
 S RESULT("COMMENT")=$$UNESC($P(SEG,"|",3))
"RTN","SDHL7",94,0)
 Q
"RTN","SDHL7",95,0)
 ;
"RTN","SDHL7",96,0)
PID(RESULT,X,SEG,ERROR) ;
"RTN","SDHL7",97,0)
 S RESULT("PATIENT")=$P(SEG,"|",3)_U_$P(SEG,"|",5)
"RTN","SDHL7",98,0)
 Q
"RTN","SDHL7",99,0)
 ;
"RTN","SDHL7",100,0)
PV1(RESULT,X,SEG,ERROR) ; -- Gets Patient location info.
"RTN","SDHL7",101,0)
 ;    may not be needed for scheduling
"RTN","SDHL7",102,0)
 ;PV1="PV1||"_TYPE_"|"_LOC_$S($L(RB):U_RB,1:"")_"||||||||||||||||"_$G(VISIT)
"RTN","SDHL7",103,0)
 Q
"RTN","SDHL7",104,0)
 ;
"RTN","SDHL7",105,0)
FMDATE(Y) ; -- Convert HL7 date/time to FM format
"RTN","SDHL7",106,0)
 Q $$HL7TFM^XLFDT(Y)
"RTN","SDHL7",107,0)
 ;
"RTN","SDHL7",108,0)
 ;
"RTN","SDHL7",109,0)
REJECT(RESULT) ;
"RTN","SDHL7",110,0)
 ; SHOW TO USER
"RTN","SDHL7",111,0)
 ; RESULT("REJECTION ERROR")
"RTN","SDHL7",112,0)
 Q
"RTN","SDHL7",113,0)
 ;
"RTN","SDHL7",114,0)
VALIDATE(RESULT,ERROR) ;
"RTN","SDHL7",115,0)
 S (RTCD,SBIEN,PATIEN,ORDIEN,CLNIEN,NUMAPP,CHGREQ,EBIEN)=""
"RTN","SDHL7",116,0)
 ;RTC DATE VALIDATION
"RTN","SDHL7",117,0)
 S RTCD=$G(RESULT("RTC DATE"))
"RTN","SDHL7",118,0)
 I RTCD="" S ERROR="An RTC Date is requried" Q
"RTN","SDHL7",119,0)
 I (RTCD?7N)=0 S ERROR="RTC order date format error. Use calendar or format T+2W. Time not allowed." Q
"RTN","SDHL7",120,0)
 ;SIGNED BY VALIDATION
"RTN","SDHL7",121,0)
 S SBIEN=$P($G(RESULT("SIGNED BY")),"^",1)
"RTN","SDHL7",122,0)
 I SBIEN="" S ERROR="An IEN is required as the first piece of Signed By" Q
"RTN","SDHL7",123,0)
 I (SBIEN?1N.N)=0 S ERROR="The Signed By IEN is must be a number" Q
"RTN","SDHL7",124,0)
 ;ENTERED BY VALIDATION
"RTN","SDHL7",125,0)
 S EBIEN=$P($G(RESULT("ENTERED BY")),"^",1)
"RTN","SDHL7",126,0)
 I EBIEN="" S ERROR="An IEN is required as the first piece of Entered By" Q
"RTN","SDHL7",127,0)
 I (EBIEN?1N.N)=0 S ERROR="The Entered By IEN is must be a number" Q
"RTN","SDHL7",128,0)
 ;PATIENT VALIDATION
"RTN","SDHL7",129,0)
 S PATIEN=$P($G(RESULT("PATIENT")),"^",1)
"RTN","SDHL7",130,0)
 I PATIEN="" S ERROR="Contact Help desk for assistance with patient's account. RTC Error with patient's IEN(1)" Q
"RTN","SDHL7",131,0)
 I (PATIEN?1N.N)=0 S ERROR="Contact Help desk for assistance with patient's account. RTC Error with patient's IEN(2)" Q
"RTN","SDHL7",132,0)
 ;CLINIC VALIDATION
"RTN","SDHL7",133,0)
 S CLNIEN=$P($G(RESULT("CLINIC")),"^",1)
"RTN","SDHL7",134,0)
 I CLNIEN="" S ERROR="A RTC Clinic location is required." Q
"RTN","SDHL7",135,0)
 I (CLNIEN?1N.N)=0 S ERROR="An appropriate RTC Clinic location is required."
"RTN","SDHL7",136,0)
 ;ORDER IEN VALIDATION
"RTN","SDHL7",137,0)
 S ORDIEN=$P($G(RESULT("ORDER IEN")),"^",1)
"RTN","SDHL7",138,0)
 I ORDIEN="" S ERROR="An IEN is required as the first piece of Order" Q
"RTN","SDHL7",139,0)
 I (ORDIEN?1N.N)=0 S ERROR="An Order IEN must be a number" Q
"RTN","SDHL7",140,0)
 ;MULTIPLE APPOINTMENT VALIDATION
"RTN","SDHL7",141,0)
 S NUMAPP=$G(RESULT("NUMBER APPT"))
"RTN","SDHL7",142,0)
 S INTERV=$G(RESULT("INTERVAL"))
"RTN","SDHL7",143,0)
 I NUMAPP'="" D
"RTN","SDHL7",144,0)
 .I (NUMAPP?1N.N)=0 D
"RTN","SDHL7",145,0)
 ..S ERROR="Enter the numeric number of RTC appointment needed."
"RTN","SDHL7",146,0)
 .I +NUMAPP>1 D
"RTN","SDHL7",147,0)
 ..I +INTERV=0 D
"RTN","SDHL7",148,0)
 ...S ERROR="Enter a numeric interval in days for the multiple RTC appointments."
"RTN","SDHL7",149,0)
 I ERROR'="" Q
"RTN","SDHL7",150,0)
 ;NO LATER THAN VALIDATION
"RTN","SDHL7",151,0)
 I $G(RESULT("NLT"))'="" D
"RTN","SDHL7",152,0)
 .I $G(RESULT("NLT"))'=1&($G(RESULT("NLT"))'=0) S ERROR="If set, NLT must be a 1 or 0" Q
"RTN","SDHL7",153,0)
 ;COMMENT VALIDATION
"RTN","SDHL7",154,0)
 I $L($G(RESULT("COMMENT")))>75 S ERROR="Comment is greater than 75 characters" Q
"RTN","SDHL7",155,0)
 ;CHANGE VALIDATION
"RTN","SDHL7",156,0)
 S CHGREQ=$G(RESULT("CHANGE"))
"RTN","SDHL7",157,0)
 I CHGREQ'="",CHGREQ'=1,CHGREQ'=0 S ERROR="If set, Change must be a 1 or 0"
"RTN","SDHL7",158,0)
 I CHGREQ=1 D
"RTN","SDHL7",159,0)
 .;REQEUST IEN VALIDATION
"RTN","SDHL7",160,0)
 .S REQIEN=$G(RESULT("REQ FILE IEN"))
"RTN","SDHL7",161,0)
 .I REQIEN="" D
"RTN","SDHL7",162,0)
 ..S ERROR="If change is set to 1, then a Request IEN is required" Q
"RTN","SDHL7",163,0)
 .I (REQIEN?1N.N)=0 D
"RTN","SDHL7",164,0)
 ..S ERROR="Request IEN must be a number" Q
"RTN","SDHL7",165,0)
 I ERROR'="" Q
"RTN","SDHL7",166,0)
 Q
"RTN","SDHL7",167,0)
 ;
"RTN","SDHL7",168,0)
VALDDIS(RESULT,ERROR) ; VALIDATE A DISCONTINUE REQUEST
"RTN","SDHL7",169,0)
 ;REQEUST IEN VALIDATION
"RTN","SDHL7",170,0)
 S REQIEN=$G(RESULT("REQ FILE IEN"))
"RTN","SDHL7",171,0)
 I REQIEN="" S ERROR="If disconintue is set to 1, then a Request IEN isrequired" Q
"RTN","SDHL7",172,0)
 I (REQIEN?1N.N)=0 S ERROR="Request IEN must be a number" Q
"RTN","SDHL7",173,0)
 ;ENTERED BY VALIDATION
"RTN","SDHL7",174,0)
 S EBIEN=$P($G(RESULT("ENTERED BY")),"^",1)
"RTN","SDHL7",175,0)
 I EBIEN="" S ERROR="A Entered By IEN is required" Q
"RTN","SDHL7",176,0)
 I (EBIEN?1N.N)=0 S ERROR="The Entered By IEN must be a number" Q
"RTN","SDHL7",177,0)
 Q
"RTN","SDHL7",178,0)
 ;
"RTN","SDHL7",179,0)
DISCONT(RESULT,ERROR) ;
"RTN","SDHL7",180,0)
 ;SETUP
"RTN","SDHL7",181,0)
 S U="^"
"RTN","SDHL7",182,0)
 ;
"RTN","SDHL7",183,0)
 N ARCINP,ARCRET,APPTIEN,ARCLE
"RTN","SDHL7",184,0)
 ;;DISCONTINUE REQUEST
"RTN","SDHL7",185,0)
 S (APPTIEN,ARCRET,ARCLE)=""
"RTN","SDHL7",186,0)
 S APPTIEN=$G(RESULT("REQ FILE IEN"))
"RTN","SDHL7",187,0)
 I +APPTIEN>0 D
"RTN","SDHL7",188,0)
 .I $G(RESULT("DISCONTINUE"))=1 D
"RTN","SDHL7",189,0)
 ..S ARCINP(1)=APPTIEN
"RTN","SDHL7",190,0)
 ..S ARCINP(2)="REMOVED/NO LONGER NECESSARY"
"RTN","SDHL7",191,0)
 ..S ARCINP(3)=$P($G(RESULT("ENTERED BY")),U,1)
"RTN","SDHL7",192,0)
 ..S ARCINP(4)=DT
"RTN","SDHL7",193,0)
 ..D ARCLOSE^SDECAR(.ARCRET,.ARCINP)
"RTN","SDHL7",194,0)
 ;CHECK FOR ARCLOSE ERRORS
"RTN","SDHL7",195,0)
 S ARCLE=$P(ARCRET,$C(30),2)
"RTN","SDHL7",196,0)
 I $P(ARCLE,U,1)=-1 S ERROR=$P(ARCLE,U,2)
"RTN","SDHL7",197,0)
 Q
"RTN","SDHL7",198,0)
 ;
"RTN","SDHL7",199,0)
SAVEREC(RESULT,ERROR) ;
"RTN","SDHL7",200,0)
 ;SETUP
"RTN","SDHL7",201,0)
 S U="^"
"RTN","SDHL7",202,0)
 ;
"RTN","SDHL7",203,0)
 ;NEW/CHANGE REQUEST
"RTN","SDHL7",204,0)
 Q:$G(RESULT("NEW ORDER"))'=1&($G(RESULT("CHANGE"))'=1)
"RTN","SDHL7",205,0)
 N ARINP,APPTCHG,PTIEN,SDATE,DDDT,MARDDS,COUNT,ATYPIEN,STCREC,SCPER,SETRET,ARSETE
"RTN","SDHL7",206,0)
 S (APPTCHG,PTIEN,SDATE,DDDT,MARDDS,COUNT,ATYPIEN,STCREC,SCPER,SETRET,ARSETE)=""
"RTN","SDHL7",207,0)
 S APPTCHG=$G(RESULT("CHANGE"))
"RTN","SDHL7",208,0)
 I APPTCHG=1 D
"RTN","SDHL7",209,0)
 .S ARINP(1)=APPTIEN
"RTN","SDHL7",210,0)
 ;PATIENT
"RTN","SDHL7",211,0)
 S PTIEN=$P($G(RESULT("PATIENT")),U,1)
"RTN","SDHL7",212,0)
 S ARINP(2)=PTIEN
"RTN","SDHL7",213,0)
 ;ENTERED DATE TIME
"RTN","SDHL7",214,0)
 S Y=DT X ^DD("DD") S ARINP(3)=Y
"RTN","SDHL7",215,0)
 ;REQUEST TYPE
"RTN","SDHL7",216,0)
 S ARINP(5)="RTC"
"RTN","SDHL7",217,0)
 ;CLINIC
"RTN","SDHL7",218,0)
 S ARINP(6)=$P($G(RESULT("CLINIC")),U,1)
"RTN","SDHL7",219,0)
 ;ENTERED BY
"RTN","SDHL7",220,0)
 S ARINP(7)=$P($G(RESULT("ENTERED BY")),U,1)
"RTN","SDHL7",221,0)
 ;PRIORITY
"RTN","SDHL7",222,0)
 S ARINP(8)="FUTURE" I $G(RESULT("RTC DATE"))=DT D
"RTN","SDHL7",223,0)
 .S ARINP(8)="ASAP"
"RTN","SDHL7",224,0)
 ;REQUESTED BY
"RTN","SDHL7",225,0)
 S ARINP(9)="PROVIDER"
"RTN","SDHL7",226,0)
 ;PROVIDER
"RTN","SDHL7",227,0)
 S ARINP(10)=$P($G(RESULT("SIGNED BY")),U,1)
"RTN","SDHL7",228,0)
 ;RTC DATE
"RTN","SDHL7",229,0)
 S RTCDTI=$G(RESULT("RTC DATE"))
"RTN","SDHL7",230,0)
 S Y=RTCDTI X ^DD("DD") S ARINP(11)=Y
"RTN","SDHL7",231,0)
 ;COMMENTS
"RTN","SDHL7",232,0)
 S ARINP(12)=$G(RESULT("COMMENT"))
"RTN","SDHL7",233,0)
 I $G(RESULT("NLT"))=1 D
"RTN","SDHL7",234,0)
 .S ARINP(12)="#NLT#"_$G(RESULT("COMMENT"))
"RTN","SDHL7",235,0)
 ;ENROLLMENT GROUP
"RTN","SDHL7",236,0)
 S PCE="" S PCE=$P($G(^DPT(PTIEN,"ENR")),U,1) I PCE'="" D
"RTN","SDHL7",237,0)
 .S ARINP(13)=$$GET1^DIQ(27.11,PCE,.07,"E")
"RTN","SDHL7",238,0)
 ;MULTIPLE APPOINTMENT REQUEST
"RTN","SDHL7",239,0)
 S ARINP(14)="NO" ;DEFAULT
"RTN","SDHL7",240,0)
 S ARINP(20)=""   ;DEFAULT
"RTN","SDHL7",241,0)
 I $G(RESULT("NUMBER APPT"))'="" D
"RTN","SDHL7",242,0)
 .I $G(RESULT("NUMBER APPT"))>1 D
"RTN","SDHL7",243,0)
 ..S ARINP(14)="YES"
"RTN","SDHL7",244,0)
 ..S ARINP(15)=$G(RESULT("INTERVAL"))
"RTN","SDHL7",245,0)
 ..S ARINP(16)=$G(RESULT("NUMBER APPT"))
"RTN","SDHL7",246,0)
 ..S DDDT=$G(RESULT("RTC DATE"))
"RTN","SDHL7",247,0)
 ..F I=1:1:$G(RESULT("NUMBER APPT")) D
"RTN","SDHL7",248,0)
 ...S X1=DDDT,X2=RESULT("INTERVAL") D C^%DTC S SDATE=X
"RTN","SDHL7",249,0)
 ...S MARDDS=MARDDS_$S(MARDDS="":SDATE,1:"|"_SDATE)
"RTN","SDHL7",250,0)
 ...S ARINP(20)=MARDDS
"RTN","SDHL7",251,0)
 ;SERVICE CONNECTED
"RTN","SDHL7",252,0)
 S SCPER=$P($G(^DPT(PTIEN,.3)),"^",2)
"RTN","SDHL7",253,0)
 I SCPER'="" D
"RTN","SDHL7",254,0)
 .S ARINP(19)=SCPER
"RTN","SDHL7",255,0)
 .I SCPER>49 D
"RTN","SDHL7",256,0)
 ..S ARINP(18)="YES"
"RTN","SDHL7",257,0)
 ..S ATYPIEN=$O(^SD(409.1,"B","SERVICE CONNECTED",ATYPIEN))
"RTN","SDHL7",258,0)
 E  S ARINP(18)="NO" S ATYPIEN=$O(^SD(409.1,"B","REGULAR",ATYPIEN))
"RTN","SDHL7",259,0)
 I ATYPIEN'="" D
"RTN","SDHL7",260,0)
 .S ARINP(22)=ATYPIEN
"RTN","SDHL7",261,0)
 ;CLINIC STOP CODE
"RTN","SDHL7",262,0)
 D GETSTC^SDECCON(STCREC,$P($G(RESULT("CLINIC")),U,1))
"RTN","SDHL7",263,0)
 I STCREC'="" D
"RTN","SDHL7",264,0)
 .S ARINP(21)=$P($G(STCREC),U,1)
"RTN","SDHL7",265,0)
 ;ESTABLISHED PATIENT
"RTN","SDHL7",266,0)
 S ARINP(23)="E"
"RTN","SDHL7",267,0)
 ;NO LATER THAN
"RTN","SDHL7",268,0)
 I $G(RESULT("NLT"))'="" D
"RTN","SDHL7",269,0)
 .S ARINP(26)=$G(RESULT("NLT"))
"RTN","SDHL7",270,0)
 ;ORDER IEN
"RTN","SDHL7",271,0)
 I $G(RESULT("ORDER IEN"))'="" D
"RTN","SDHL7",272,0)
 .S ARINP(28)=RESULT("ORDER IEN")
"RTN","SDHL7",273,0)
 ;PREREQ
"RTN","SDHL7",274,0)
 I $D(RESULT("PREREQ")) D
"RTN","SDHL7",275,0)
 .N PR,CC
"RTN","SDHL7",276,0)
 .S PREREQ=""
"RTN","SDHL7",277,0)
 .S CC=0 F  S CC=$O(RESULT("PREREQ",CC)) Q:CC'>0  D
"RTN","SDHL7",278,0)
 ..S PR=$G(RESULT("PREREQ",CC)) Q:PR=""
"RTN","SDHL7",279,0)
 ..S PREREQ=$S(PREREQ'="":PREREQ_";"_PR,1:PR)
"RTN","SDHL7",280,0)
 .S ARINP(27)=PREREQ
"RTN","SDHL7",281,0)
 ;CREATE THE APPOINTMENT REQUEST
"RTN","SDHL7",282,0)
 D ARSET^SDECAR2(.SETRET,.ARINP)
"RTN","SDHL7",283,0)
 ;CHECK FOR ARSET ERRORS
"RTN","SDHL7",284,0)
 S ARSETE=$P(SETRET,$C(30),2)
"RTN","SDHL7",285,0)
 I $P(ARSETE,U,1)="-1" S ERROR=$P(ARSETE,U,2) Q
"RTN","SDHL7",286,0)
 ;GET ARIEN
"RTN","SDHL7",287,0)
 S RESULT("REQ FILE IEN")=+ARSETE
"RTN","SDHL7",288,0)
 Q
"RTN","SDHL7",289,0)
 ;
"RTN","SDHL7",290,0)
SENDFAIL(ERROR,RESULT) ;
"RTN","SDHL7",291,0)
 ;S ORV("XQY0")="" D ERROR^OERR(ERROR,.SDMSG,.ORV)
"RTN","SDHL7",292,0)
 ;Q:ORTYPE="ORR"  Q:'$L($G(ORNMSP))
"RTN","SDHL7",293,0)
 N SDEMSG
"RTN","SDHL7",294,0)
 ;N ORVP,ORTS S:'$G(ORDUZ) ORDUZ=PAT_";DPT(" D:'$G(ORVP) PID
"RTN","SDHL7",295,0)
 S SDEMSG(1)="MSH|^~\&|SCHEDULING|"_$G(DUZ(2))_"|ORDER ENTRY|"_DUZ(2)_"|"_$$FMTHL7^XLFDT($$NOW^XLFDT)_"||SRM|"_RESULT("MSG ID")
"RTN","SDHL7",296,0)
 S SDEMSG(2)="MSA|AR|"_$P(ERROR,$C(30,31))_"|||207^"_$P(ERROR,$C(30,31))
"RTN","SDHL7",297,0)
 S OREMSG(3)="ERR|^^^"
"RTN","SDHL7",298,0)
 D MSG^XQOR("SD EVSEND OR",.SDEMSG)
"RTN","SDHL7",299,0)
 Q
"RTN","SDHL7",300,0)
 ;
"RTN","SDHL7",301,0)
SENDOK(RESULT) ;
"RTN","SDHL7",302,0)
 N SDMSG
"RTN","SDHL7",303,0)
 S SDMSG(1)="MSH|^~\&|SCHEDULING|"_$G(DUZ(2))_"|ORDER ENTRY|"_DUZ(2)_"|"_$$FMTHL7^XLFDT($$NOW^XLFDT)_"||SRM|"_RESULT("MSG ID")
"RTN","SDHL7",304,0)
 S SDMSG(2)="MSA|AA|OK^"_$G(RESULT("REQ FILE IEN"))_"|||"
"RTN","SDHL7",305,0)
 D MSG^XQOR("SD EVSEND OR",.SDMSG)
"RTN","SDHL7",306,0)
 Q
"RTN","SDHL7",307,0)
 ;
"RTN","SDHL7",308,0)
 ;TODO: GET ANTHONY'S HELP TO FORMAT MESSAGE TO SEND STATUS (SCHEDULED,DISPOSITION,TRANSFERED,ETC...) UPDATE TO CPRS
"RTN","SDHL7",309,0)
UPSTAT(ORDIEN,STATUS) ;
"RTN","SDHL7",310,0)
 Q:ORDIEN=""
"RTN","SDHL7",311,0)
 Q:STATUS=""
"RTN","SDHL7",312,0)
 N SDMSG
"RTN","SDHL7",313,0)
 S SDMSG(1)="MSH|^~\&|SCHEDULING|"_$G(DUZ(2))_"|ORDER ENTRY|"_DUZ(2)_"|"_$$FMTHL7^XLFDT($$NOW^XLFDT)_"||SRM|"_RESULT("MSG ID")
"RTN","SDHL7",314,0)
 S SDMSG(2)="MSA|AA|OK^"_$G(RESULT("REQ FILE IEN"))_"|||"
"RTN","SDHL7",315,0)
 D MSG^XQOR("SD EVSEND OR",.SDMSG)
"RTN","SDHL7",316,0)
 Q
"RTN","SDHL7",317,0)
 ;
"RTN","SDHL7",318,0)
UNESC(STR) ;
"RTN","SDHL7",319,0)
 ;ICR 4922
"RTN","SDHL7",320,0)
 Q $$UNESC^ORHLESC(STR)
"RTN","SDN")
0^2^B33353252
"RTN","SDN",1,0)
SDN ;SF/GFT,ALB/LDB - RECORD NO SHOWS ;JUL 19, 2016
"RTN","SDN",2,0)
 ;;5.3;Scheduling;**32,79,398,478,627,651,682**;Aug 13, 1993;Build 10
"RTN","SDN",3,0)
 ;
"RTN","SDN",4,0)
 N SDATA ; for evt driver
"RTN","SDN",5,0)
 S U="^" D NOW^%DTC S SDTIME=%,SDLT1="" K ^UTILITY($J),SDCP,SDLT D LO^DGUTL
"RTN","SDN",6,0)
 S SDDT=DT,SDV1=$O(^DG(40.8,0)) D DIV^SDUTL I $T S DIC=40.8,DIC(0)="AEQM" S SDLT=1 D NSLET1^SDDIV K SDLT G:Y<0 END^SDN0 S SDV1=DIV
"RTN","SDN",7,0)
7 R !!,"NO-SHOWS FOR WHAT DATE: ",X:DTIME Q:U[X  S %DT="EP",%DT(0)=-DT D ^%DT G 7:Y<0 S SDT=Y,SDYES=""
"RTN","SDN",8,0)
 S SM="S SDCT=0 F I=SD1:0:SD2 S I=$N(^DPT(+Y,""S"",I)) S:I<0!(I'<SD2) I=9999999 I I\1=SDT,$D(^(I,0)),+^(0)=SC,$P(^(0),U,2)'[""C"",'$$CODT^SDCOU(+Y,I,SC) Q"
"RTN","SDN",9,0)
 S SM1="S SDCT=0 F I=SD1:0 S I=$N(^DPT(+Y,""S"",I)) Q:I<0!(I'<SD2)  I I\1=SDT,$D(^(I,0)),+^(0)=SC,$P(^(0),""^"",2)'[""C"",'$$CODT^SDCOU(+Y,I,SC) S SDCT=SDCT+1,SDT(SDCT)=I"
"RTN","SDN",10,0)
71 W ! K DIC S SC=0,DIC="^SC(",DIC(0)="AEMQ",DIC("A")="Select CLINIC NAME: ",DIC("S")="I $P(^(0),""^"",3)=""C"",'$G(^(""OOS"")),$S($P(^(0),""^"",15)=SDV1:1,'$P(^(0),""^"",15):1,'SDV1:1,1:0)"
"RTN","SDN",11,0)
 D ^DIC K DIC("A"),DIC("S") G 73:Y<0 S SC=+Y,SD1=SDT,SD2=SDT+1 S SDMSG=" DOES NOT HAVE A NO-SHOW LETTER ASSIGNED TO IT!"
"RTN","SDN",12,0)
72 Q:$D(SDNSACT)  S SD1=SDT,DIC="^DPT(",DIC(0)="AEMQ",DIC("S")=SM
"RTN","SDN",13,0)
 K SDT S SDT=SD1
"RTN","SDN",14,0)
 D ^DIC K DIC("S") G 71:"^"[X,72:Y<0 S DFN=+Y X SM1 D SDMLT Q:'SDCT  S I=SDT(SDCT)
"RTN","SDN",15,0)
EN1 ; -- entry pt for protocol action
"RTN","SDN",16,0)
 S SDSTAT=$P(^DPT(+DFN,"S",I,0),U,2) I SDSTAT="I" D NS^SDN2 G 72
"RTN","SDN",17,0)
 I SDSTAT=""!(SDSTAT="NT") D  G 72
"RTN","SDN",18,0)
 .N SDNSHDL,SDDA S SDNSHDL=$$HANDLE^SDAMEVT(1),SDDA=$$FIND^SDAM2(DFN,I,SC)
"RTN","SDN",19,0)
 .S SDDTM=I D BEFORE^SDAMEVT(.SDATA,DFN,SDDTM,SC,SDDA,SDNSHDL)
"RTN","SDN",20,0)
 .S $P(^DPT(+DFN,"S",I,0),U,2)="N",$P(^(0),"^",14)=SDTIME S:$D(DUZ) $P(^(0),"^",12)=DUZ
"RTN","SDN",21,0)
 .;update SDEC APPOINTMENT   ;alb/sat  SD/627
"RTN","SDN",22,0)
 .N SDECAPPT S SDECAPPT=$$APPTGET^SDECUTL(DFN,SDDTM,SC)
"RTN","SDN",23,0)
 .D SDECNOS^SDEC31(SDECAPPT,1,DUZ,SDTIME)
"RTN","SDN",24,0)
 .;end addition/modification  ;alb/sat SD/627
"RTN","SDN",25,0)
 .S:'SDYES SDYES=1
"RTN","SDN",26,0)
 .S:'$D(^UTILITY($J,"CL",DFN,SC,I))&(SDSTAT'="C") ^(I)=""
"RTN","SDN",27,0)
 .W "...OK   New Status: ",$P($$STATUS^SDAM1(DFN,I,SC,^DPT(DFN,"S",I,0),SDDA),";",3)
"RTN","SDN",28,0)
 .D EVT K SDATA
"RTN","SDN",29,0)
 W:$P(^DPT(+DFN,"S",I,0),U,2)["A" *7,!,"THIS APPOINTMENT ALREADY A NO-SHOW AND REBOOKED... ARE YOU SURE YOU"
"RTN","SDN",30,0)
ALNS S %=2 W:$P(^DPT(+DFN,"S",I,0),U,2)'["A" !,*7,"  ALREADY RECORDED AS NO-SHOW..." W " WANT TO ERASE" D YN^DICN I '% W !,"RESPOND YES OR NO" G ALNS
"RTN","SDN",31,0)
 I (%-1) G 72
"RTN","SDN",32,0)
 I '(%-1) W "...NO LONGER A NO-SHOW!" D
"RTN","SDN",33,0)
 .N SDNSHDL,SDDA S SDNSHDL=$$HANDLE^SDAMEVT(1),SDDA=$$FIND^SDAM2(DFN,I,SC)
"RTN","SDN",34,0)
 .S SDDTM=I D BEFORE^SDAMEVT(.SDATA,DFN,SDDTM,SC,SDDA,SDNSHDL)
"RTN","SDN",35,0)
 .S SDINP=$$INP^SDAM2(DFN,SDDTM),X=I,Y=DFN
"RTN","SDN",36,0)
 .S $P(^DPT(+Y,"S",SDDTM,0),U,2)=$S(SDINP["I":SDINP,1:""),$P(^(0),"^",14)="",$P(^(0),"^",12)=""
"RTN","SDN",37,0)
 .;update SDEC APPOINTMENT   ;alb/sat 651
"RTN","SDN",38,0)
 .N SDECAPPT S SDECAPPT=$$APPTGET^SDECUTL(DFN,SDDTM,SC)
"RTN","SDN",39,0)
 .D SDECNOS^SDEC31(SDECAPPT,0)
"RTN","SDN",40,0)
 .;end addition/modification  ;alb/sat 651
"RTN","SDN",41,0)
 .I SDINP="",$$CHK^SDM1A(SC,SDDTM),+$$STATUS^SDAM1(DFN,SDDTM,SC,^DPT(DFN,"S",SDDTM,0),SDDA)'=1 S $P(^DPT(DFN,"S",SDDTM,0),U,2)="NT" ; not inpt and not ci
"RTN","SDN",42,0)
 .D EVT K SDATA
"RTN","SDN",43,0)
 .K SDINP,^UTILITY($J,"CL",+Y,SC,SDDTM),SDDTM
"RTN","SDN",44,0)
 G 72
"RTN","SDN",45,0)
73 ;
"RTN","SDN",46,0)
 G:SDYES ASKA G END^SDN0
"RTN","SDN",47,0)
CK1 S SD1=I X SM I I<SD2,$P(^DPT(+Y,"S",I,0),U,2)["C" S POP=1
"RTN","SDN",48,0)
 S:I'<SD2 POP=1 Q:'POP  I I'<SD2 S POP=1 Q
"RTN","SDN",49,0)
 G CK1
"RTN","SDN",50,0)
ASKA G ASKL ;REMOVE AUTO-REBOOK SD*5.3*682
"RTN","SDN",51,0)
 ;S %=2,DTOUT=0 W !,"WANT TO AUTO-REBOOK NO-SHOW APPOINTMENTS NOW" D YN^DICN I '% W !,"RESPOND YES (Y) OR NO (N)" G ASKA
"RTN","SDN",52,0)
 ;W:DTOUT " NO" S ANS=$S(%=1:"Y",1:"N"),(SDED,DATEND)=SDT+.9
"RTN","SDN",53,0)
 ;I $D(SDNSACT),'SDNSACT,%=1 S SDNSACT=1 ;No-show action flag
"RTN","SDN",54,0)
ASKL S ANS="N",(SDED,DATEND)=SDT+.9
"RTN","SDN",55,0)
 S %=1,DTOUT=0,SDLET="" W !,"WANT LETTERS PRINTED NOW" D YN^DICN I '% W !,"RESPOND YES (Y) OR NO (N)" G ASKL
"RTN","SDN",56,0)
 W:DTOUT " NO" S ALS=$S(%=1:"Y",1:"N")
"RTN","SDN",57,0)
 I $D(SDNSACT),(ALS="Y"),$$BADADR^DGUTL3(+DFN) D  ;display, don't print BAI list
"RTN","SDN",58,0)
 . W *7,!,"** THIS PATIENT HAS BEEN FLAGGED WITH A BAD ADDRESS INDICATOR, NO LETTER"
"RTN","SDN",59,0)
 . W !,"WILL BE PRINTED."
"RTN","SDN",60,0)
 . S ALS="N"
"RTN","SDN",61,0)
 . S DIR(0)="E" D ^DIR K DIR(0)
"RTN","SDN",62,0)
 I ALS'["Y"&(ANS'["Y") D DIS^SDNDIS G END^SDN0
"RTN","SDN",63,0)
RD1 I $D(SDNSACT) S Y=SC G RD2
"RTN","SDN",64,0)
 R !!,"FOR CLINIC: ALL// ",X:DTIME K C,DIC Q:X="^"  S X=$$UP^XLFSTR(X) G AOR:X="ALL"!(X="") I X?.E1"?" W !,?3,"ENTER A CLINIC NAME, OR 'ALL' FOR ALL CLINICS" G RD1
"RTN","SDN",65,0)
 S DIC(0)="QEM",DIC=44,DIC("S")="I $P(^(0),""^"",3)=""C""" D ^DIC K DIC("S") G:Y<0 RD1
"RTN","SDN",66,0)
RD2 S C=+Y I '$D(^SC(C,"LTR")) W !,$P(^SC(C,0),"^")_SDMSG S ALS="N"
"RTN","SDN",67,0)
 I $D(^SC(C,"LTR")),'+^("LTR") W !,$P(^SC(C,0),"^")_SDMSG S ALS="N"
"RTN","SDN",68,0)
 I $D(^SC(C,"LTR")),+^("LTR") S SDLET=+^("LTR")
"RTN","SDN",69,0)
AOR S:'$D(C) C="ALL" I ANS'["Y"&(ALS'["Y") D DIS^SDNDIS G END^SDN0
"RTN","SDN",70,0)
 D DIS^SDNDIS
"RTN","SDN",71,0)
 ;S DGPGM="START^SDN0",DGVAR="SC^SDDT^ALS^ANS^SDLET^SDV1^SDT^C^DATEND^SDTIME^SDLT1"
"RTN","SDN",72,0)
 ;S POP=0 D ZIS^DGUTQ G:POP END^SDN0
"RTN","SDN",73,0)
 S %ZIS="MQ" K IO("Q") D ^%ZIS G:POP END^SDN0
"RTN","SDN",74,0)
 I $D(IO("Q")) D  D:IO'=IO(0) NSLTR W @IOF G END^SDN0
"RTN","SDN",75,0)
 .S ZTRTN="START^SDN0" F ZTS="SC","SDDT","ALS","ANS","SDLET","SDV1","SDT","C","DATEND","SDTIME","SDLT1","AUTO(" S ZTSAVE(ZTS)=""
"RTN","SDN",76,0)
 .K ZTS D ^%ZTLOAD
"RTN","SDN",77,0)
 D:IO'=IO(0) NSLTR D START^SDN0,^%ZISC W @IOF G END^SDN0
"RTN","SDN",78,0)
 ;G START^SDN0     ;???
"RTN","SDN",79,0)
 Q
"RTN","SDN",80,0)
NSLTR I ANS["Y",ALS["Y" S:$D(NSDIE) @(NSDIE_NSDA_",1,2,0)")="NO-SHOW AUTO-REBOOK letter printed." K NSDIE,NSDA ;SD/478 AT THIS POINT NO SHOW AUTO REBOOK LETTER IS PRINTED.
"RTN","SDN",81,0)
 I ALS["Y" S:$D(NSDIE) @(NSDIE_NSDA_",1,2,0)")="NO-SHOW letter printed." K NSDIE,NSDA ;SD/478 AT THIS POINT NO SHOW LETTER IS PRINTED.
"RTN","SDN",82,0)
 Q
"RTN","SDN",83,0)
SDMLT ;
"RTN","SDN",84,0)
 N SDCNT,SDSTAT
"RTN","SDN",85,0)
 S SDCNT=SDCT,SDCT=0
"RTN","SDN",86,0)
 F  S SDCT=$O(SDT(SDCT)) Q:'SDCT  D
"RTN","SDN",87,0)
 .S SDSTAT=$$STATUS^SDAM1(DFN,SDT(SDCT),SC,^DPT(DFN,"S",SDT(SDCT),0))
"RTN","SDN",88,0)
 .W !,SDCT,"). ",$$FTIME^VALM1(SDT(SDCT)),"   Status: ",$P(SDSTAT,";",3) W:$P(SDSTAT,";",4) *7
"RTN","SDN",89,0)
 S SDCT=SDCNT
"RTN","SDN",90,0)
ASK I SDCT>1!($P(SDSTAT,";",4)) R !!,"SELECT APPOINTMENT: ",SDCT:DTIME Q:'$T!(U[SDCT)  I SDCT["?"!('$D(SDT(SDCT))) W !,"Please enter one number to indicate which appointment." S SDCT=SDCNT G ASK
"RTN","SDN",91,0)
 W ! Q
"RTN","SDN",92,0)
 ;
"RTN","SDN",93,0)
EVT ; -- separate tag if need to NEW vars
"RTN","SDN",94,0)
 N I,SDINP,Y,SDSTAT,SDTIME,SDYES,SM,SM1,SD1,SD2,SDMSG,SDT,SDCT,CNSTLNK,CN,CNPAT
"RTN","SDN",95,0)
 D NOSHOW^SDAMEVT(.SDATA,DFN,SDDTM,SC,SDDA,0,SDNSHDL)
"RTN","SDN",96,0)
 S CNSTLNK="",CN=0 F  S CN=$O(^SC(SC,"S",SDDTM,1,CN)) Q:'+CN  S CNPAT=$P($G(^SC(SC,"S",SDDTM,1,CN,0)),U) I CNPAT=DFN S CNSTLNK=$P($G(^SC(SC,"S",SDDTM,1,CN,"CONS")),U) Q  ;SD/478
"RTN","SDN",97,0)
 D:+CNSTLNK NOSHOW^SDCNSLT(SC,SDDTM,CNPAT,CNSTLNK,CN,.AUTO,.NSDIE,.NSDA) ;SD/478
"RTN","SDN",98,0)
 Q
"RTN","SDN",99,0)
 ;
"RTN","SDN0")
0^3^B12318284
"RTN","SDN0",1,0)
SDN0 ;ALB/TMP - NO SHOW AUTO-REBOOK ; 6/21/04 2:09pm
"RTN","SDN0",2,0)
 ;;5.3;Scheduling;**381,682**;Aug 13, 1993;Build 10
"RTN","SDN0",3,0)
START U IO K ^UTILITY($J) I C="ALL" K C
"RTN","SDN0",4,0)
 ;G:ANS'["Y" PLET
"RTN","SDN0",5,0)
 I ANS'["Y" G PLET:$D(C),^SDN1
"RTN","SDN0",6,0)
 I $D(C),$P(^SC(C,0),"^",3)="C",$S($P(^(0),"^",15)="":1,$P(^(0),"^",15)=SDV1:1,1:0) S SC=C D OVR G PLET
"RTN","SDN0",7,0)
 G:$D(C) END
"RTN","SDN0",8,0)
 S SDQ=0
"RTN","SDN0",9,0)
 F  S SDQ=$O(^SC(SDQ)) Q:+SDQ=0  D
"RTN","SDN0",10,0)
 .I $P(^SC(SDQ,0),"^",3)="C",$S($P(^(0),"^",15)="":1,$P(^(0),"^",15)=SDV1:1,1:0),($O(^SC(SDQ,"S",SDT))\1)=SDT S SC=SDQ D OVR
"RTN","SDN0",11,0)
 ;G PLET
"RTN","SDN0",12,0)
 G END:ALS="N",^SDN1
"RTN","SDN0",13,0)
OVR S SL=$S($D(^SC(SC,"SL")):^("SL"),1:"") Q:'SL  S %=$P(SL,U,6),SI=$S(%="":4,%<3:4,%:%,1:4),%=$P(SL,U,3),STARTDAY=$S(%:%,1:8),SDSTRTDT=$S(DT>SDT:DT,1:SDT),STIME=$S($D(^SC(SC,"SDP")):$P(^("SDP"),U,3),1:"0800")
"RTN","SDN0",14,0)
 S CDATE=SDT,SDNOSH="" D ^SDAUT1
"RTN","SDN0",15,0)
 ;AUTO-REBOOK NOT ALLOWED SD*5.3*682
"RTN","SDN0",16,0)
 S MAX=0 W !,"AUTO-REBOOKING NOT ALLOWED FOR CLINIC ",$P(^SC(SC,0),"^",1) Q
"RTN","SDN0",17,0)
 K FSW
"RTN","SDN0",18,0)
 S GDATE=CDATE
"RTN","SDN0",19,0)
 F  S GDATE=$O(^SC(SC,"S",GDATE)) Q:GDATE=""!(GDATE>(CDATE+1))  D
"RTN","SDN0",20,0)
 .S L=0
"RTN","SDN0",21,0)
 .F  S L=$O(^SC(SC,"S",GDATE,1,L)) Q:L=""  S A=^(L,0) I $D(^DPT(+A,"S",GDATE,0)),$P(^(0),"^",2)="N",$P(^(0),"^",14)=SDTIME D MAXCK D:'POP EN1^SDAUT2 D ^SDNP
"RTN","SDN0",22,0)
 W:$G(ALS)="Y" @IOF
"RTN","SDN0",23,0)
 Q
"RTN","SDN0",24,0)
PLET S SDC=SC,SDFORM="" I $D(^DG(40.8,SDV1,"LTR")),^("LTR") S SDFORM=^("LTR")
"RTN","SDN0",25,0)
 S SDLET="" I $D(^SC(SC,"LTR")),^("LTR") S SDLET=+^("LTR")
"RTN","SDN0",26,0)
 I ALS["Y"&(SDLET) G ^SDN1
"RTN","SDN0",27,0)
 W:ALS="Y"&('SDLET) !,$P(^SC(SC,0),"^")," DOES NOT HAVE A NO-SHOW LETTER ASSIGNED TO IT" G END
"RTN","SDN0",28,0)
MAXCK S POP=0,SDC=SC,SDC=$S('$D(^SC(SC,"SL")):SC,$P(^("SL"),"^",5)']"":SC,1:$P(^("SL"),"^",5))
"RTN","SDN0",29,0)
 K SDIS
"RTN","SDN0",30,0)
 S I=0
"RTN","SDN0",31,0)
 F  S I=$O(^DPT(+A,"DE","B",SDC,I)) Q:I=""!($D(SDIS))  D
"RTN","SDN0",32,0)
 .I $D(^DPT(+A,"DE",I)) D
"RTN","SDN0",33,0)
 ..S I1=0
"RTN","SDN0",34,0)
 ..F  S I1=$O(^DPT(+A,"DE",I,1,I1)) Q:I1=""  S SDD=$P(^(I1,0),"^",3)\1 I '(SDD-SDDT),$P(^(0),"^",4)["Exceeded" D SETM Q
"RTN","SDN0",35,0)
 Q
"RTN","SDN0",36,0)
SETM S POP=1,(SDIS,NDATE,DUPE)="",MESS="No rebook - Max. # of consecutive no-shows ("_$S($D(^SC(SC,"SDP")):+^("SDP"),1:"")_") has been exceeded"
"RTN","SDN0",37,0)
 Q
"RTN","SDN0",38,0)
END K %,%DT,%I,%IS,A,A0,A1,A2,ALL,ALS,ANS,BY,CDATE,DA,DATEND,DFN,DH,DHD,DIC,DIS,DIV,DO,DOW,DUPE,F,F1,FLDS,FR,GDATE,I,I1,J,L,K,LET,MAX,MESS,NOAP,P,POP,S1,SC,SD,SD1,SD2,SDD,SDDT,SDMSG,SI,SL,SS,ST,SDSTRTDT,STARTDAY,TO,X,Y,ADDR,B,CLIN,HX,LL
"RTN","SDN0",39,0)
 K DGPGM,DGVAR,Z,D,ENDATE,NDATE,J,SM,SM1,SDTIME,STIME,X1,X2,SDC,SDCT,SDIS,SDRE,SDRE1,SDIN,SDYES,SDT,SDTADE,SDTADB,SDPRT,SDMDT,SDCTR,SDCMAX,SDCONS,SDDIF,SDED,SDFORM,SDLET,SDLT1,SDNOSH,SDQ,SDSOH,SDSTAT,SDZSC,VAUTC,SDV1
"RTN","SDN0",40,0)
 K %ZIS,PDAT,S,TIME,TST,Y1 D CLOSE^DGUTQ Q
"VER")
8.0^22.2
**INSTALL NAME**
OR*3.0*483
"BLD",10385,0)
OR*3.0*483^ORDER ENTRY/RESULTS REPORTING^0^3180920^y
"BLD",10385,4,0)
^9.64PA^^0
"BLD",10385,6)
1^
"BLD",10385,6.3)
45
"BLD",10385,"ABPKG")
n
"BLD",10385,"INID")
n
"BLD",10385,"INIT")

"BLD",10385,"KRN",0)
^9.67PA^779.2^20
"BLD",10385,"KRN",.4,0)
.4
"BLD",10385,"KRN",.4,"NM",0)
^9.68A^^
"BLD",10385,"KRN",.401,0)
.401
"BLD",10385,"KRN",.402,0)
.402
"BLD",10385,"KRN",.403,0)
.403
"BLD",10385,"KRN",.5,0)
.5
"BLD",10385,"KRN",.84,0)
.84
"BLD",10385,"KRN",3.6,0)
3.6
"BLD",10385,"KRN",3.8,0)
3.8
"BLD",10385,"KRN",9.2,0)
9.2
"BLD",10385,"KRN",9.8,0)
9.8
"BLD",10385,"KRN",9.8,"NM",0)
^9.68A^11^1
"BLD",10385,"KRN",9.8,"NM",11,0)
ORMSD^^0^B92940191
"BLD",10385,"KRN",9.8,"NM","B","ORMSD",11)

"BLD",10385,"KRN",19,0)
19
"BLD",10385,"KRN",19,"NM",0)
^9.68A^^0
"BLD",10385,"KRN",19.1,0)
19.1
"BLD",10385,"KRN",101,0)
101
"BLD",10385,"KRN",101,"NM",0)
^9.68A^^0
"BLD",10385,"KRN",409.61,0)
409.61
"BLD",10385,"KRN",771,0)
771
"BLD",10385,"KRN",779.2,0)
779.2
"BLD",10385,"KRN",870,0)
870
"BLD",10385,"KRN",8989.51,0)
8989.51
"BLD",10385,"KRN",8989.51,"NM",0)
^9.68A^^0
"BLD",10385,"KRN",8989.52,0)
8989.52
"BLD",10385,"KRN",8989.52,"NM",0)
^9.68A^^
"BLD",10385,"KRN",8994,0)
8994
"BLD",10385,"KRN",8994,"NM",0)
^9.68A^^0
"BLD",10385,"KRN","B",.4,.4)

"BLD",10385,"KRN","B",.401,.401)

"BLD",10385,"KRN","B",.402,.402)

"BLD",10385,"KRN","B",.403,.403)

"BLD",10385,"KRN","B",.5,.5)

"BLD",10385,"KRN","B",.84,.84)

"BLD",10385,"KRN","B",3.6,3.6)

"BLD",10385,"KRN","B",3.8,3.8)

"BLD",10385,"KRN","B",9.2,9.2)

"BLD",10385,"KRN","B",9.8,9.8)

"BLD",10385,"KRN","B",19,19)

"BLD",10385,"KRN","B",19.1,19.1)

"BLD",10385,"KRN","B",101,101)

"BLD",10385,"KRN","B",409.61,409.61)

"BLD",10385,"KRN","B",771,771)

"BLD",10385,"KRN","B",779.2,779.2)

"BLD",10385,"KRN","B",870,870)

"BLD",10385,"KRN","B",8989.51,8989.51)

"BLD",10385,"KRN","B",8989.52,8989.52)

"BLD",10385,"KRN","B",8994,8994)

"BLD",10385,"PRE")

"BLD",10385,"PRET")

"BLD",10385,"QUES",0)
^9.62^^
"BLD",10385,"REQB",0)
^9.611^1^1
"BLD",10385,"REQB",1,0)
OR*3.0*475^2
"BLD",10385,"REQB","B","OR*3.0*475",1)

"MBREQ")
0
"PKG",188,-1)
1^1
"PKG",188,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",188,22,0)
^9.49I^1^1
"PKG",188,22,1,0)
3.0^2971217^2981113^1
"PKG",188,22,1,"PAH",1,0)
483^3180920^520736675
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","ORMSD")
0^11^B92940191
"RTN","ORMSD",1,0)
ORMSD ; SLC/AGP - Process Scheduling ORM msgs ;04/05/18
"RTN","ORMSD",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**434,475,483**;Dec 17, 1997;Build 45
"RTN","ORMSD",3,0)
 ;
"RTN","ORMSD",4,0)
 ;EN builds an results array
"RTN","ORMSD",5,0)
 ;INPUTS("APPT IEN")=0
"RTN","ORMSD",6,0)
 ;INPUTS("APPT TYPE")="followup"
"RTN","ORMSD",7,0)
 ;INPUTS("CLINIC")="240^20 MINUTE"
"RTN","ORMSD",8,0)
 ;INPUTS("COMMENT")="This is the new comment field"
"RTN","ORMSD",9,0)
 ;INPUTS("ENTERED BY")="10000000195^PULEO,ANTHONY"
"RTN","ORMSD",10,0)
 ;INPUTS("INTERVAL")="Q7D"
"RTN","ORMSD",11,0)
 ;INPUTS("MSG ID")=""
"RTN","ORMSD",12,0)
 ;INPUTS("DISCONTINUE")=1
"RTN","ORMSD",13,0)
 ;INPUTS("ENTERED IN ERROR")=1
"RTN","ORMSD",14,0)
 ;INPUTS("NLT")=1
"RTN","ORMSD",15,0)
 ;INPUTS("NUMBER APPT")=4
"RTN","ORMSD",16,0)
 ;INPUTS("ORDER IEN")=14524362
"RTN","ORMSD",17,0)
 ;INPUTS("PATIENT")="346^"
"RTN","ORMSD",18,0)
 ;INPUTS("PREREQ",2)="XRAY"
"RTN","ORMSD",19,0)
 ;INPUTS("PREREQ",3)="VITALS"
"RTN","ORMSD",20,0)
 ;INPUTS("RTC DATE")=20170524
"RTN","ORMSD",21,0)
 ;INPUTS("SIGNED BY")=""
"RTN","ORMSD",22,0)
 ;
"RTN","ORMSD",23,0)
 ;
"RTN","ORMSD",24,0)
UNESC(STR) ;
"RTN","ORMSD",25,0)
 Q $$UNESC^ORHLESC(STR)
"RTN","ORMSD",26,0)
 ;
"RTN","ORMSD",27,0)
CREATACT(NATURE) ;
"RTN","ORMSD",28,0)
 N IEN
"RTN","ORMSD",29,0)
 S IEN=$O(^ORD(100.02,"C",NATURE,"")) I IEN'>0 Q 0
"RTN","ORMSD",30,0)
 I +$P($G(^ORD(100.02,IEN,1)),U)=1 Q 1
"RTN","ORMSD",31,0)
 Q 0
"RTN","ORMSD",32,0)
 ;
"RTN","ORMSD",33,0)
EN(MSG) ; -- main entry point for OR RECEIVE where MSG contains HL7 msg
"RTN","ORMSD",34,0)
 N ACTION,AIG,AIL,ARQ,DATE,ENTER,ERROR,FAILMSA,FREQ,HASMSA,INST,MSH,NODE,NUM,NXT,ORMSG,PAT,RESULT,X,PID,PV1,SEG,SIGN
"RTN","ORMSD",35,0)
 S ERROR=""
"RTN","ORMSD",36,0)
 S ORMSG=$S($L($G(MSG)):MSG,1:"MSG") ; MSG="NAME" or MSG(#)=message
"RTN","ORMSD",37,0)
 I '$O(@ORMSG@(0)) D EN^ORERR("Missing HL7 message",.MSG) Q
"RTN","ORMSD",38,0)
 S MSH=0 F  S MSH=$O(@ORMSG@(MSH)) Q:MSH'>0  Q:$E(@ORMSG@(MSH),1,3)="MSH"
"RTN","ORMSD",39,0)
 I 'MSH D EN^ORERR("Missing or invalid MSH segment",.MSG)
"RTN","ORMSD",40,0)
 S X=0,FAILMSA=0,HASMSA=0 F  S X=$O(@ORMSG@(X)) Q:X'>0!(ERROR'="")!(HASMSA=1)  D
"RTN","ORMSD",41,0)
 .S SEG=$P(@ORMSG@(X),"|"),NODE=$P(@ORMSG@(X),"|",2,99)
"RTN","ORMSD",42,0)
 .I SEG="MSA" S HASMSA=1
"RTN","ORMSD",43,0)
 .S SEG=SEG_"(.RESULT,X,NODE,.ERROR)"
"RTN","ORMSD",44,0)
 .D @SEG
"RTN","ORMSD",45,0)
 I FAILMSA=1 D REJECT(.RESULT) G ENX
"RTN","ORMSD",46,0)
 I HASMSA=1 D ACCEPT(.RESULT) G ENX
"RTN","ORMSD",47,0)
 I $G(ERROR)'="" D SENDFAIL(.ERROR,.RESULT) G ENX
"RTN","ORMSD",48,0)
 I '$$VALIDATE(.RESULT,.ERROR) D SENDFAIL(.ERROR,.RESULT) G ENX
"RTN","ORMSD",49,0)
 D SAVEREC(.RESULT)
"RTN","ORMSD",50,0)
 D SENDOK(.RESULT)
"RTN","ORMSD",51,0)
ENX ;
"RTN","ORMSD",52,0)
 Q
"RTN","ORMSD",53,0)
 ;
"RTN","ORMSD",54,0)
LASTACT(ORIFN) ;
"RTN","ORMSD",55,0)
 N RESULT
"RTN","ORMSD",56,0)
 I ORIFN[";" S RESULT=$P(ORIFN,";",2) G LASTACTX
"RTN","ORMSD",57,0)
 S RESULT=$O(^OR(100,ORIFN,8,""),-1)
"RTN","ORMSD",58,0)
 I RESULT="" S RESULT=1
"RTN","ORMSD",59,0)
LASTACTX ;
"RTN","ORMSD",60,0)
 Q RESULT
"RTN","ORMSD",61,0)
 ;
"RTN","ORMSD",62,0)
MSH(RESULT,X,SEG,ERROR) ;
"RTN","ORMSD",63,0)
 S RESULT("MSG ID")=$P(SEG,"|",9)
"RTN","ORMSD",64,0)
 S RESULT("MSG DATE/TIME")=$$HL7TFM^XLFDT($P(SEG,"|",6),"L")
"RTN","ORMSD",65,0)
 Q
"RTN","ORMSD",66,0)
 ;
"RTN","ORMSD",67,0)
MSA(RESULT,X,SEG,ERROR) ;
"RTN","ORMSD",68,0)
 N STATUS
"RTN","ORMSD",69,0)
 I $P(SEG,"|")'="AR" D  Q
"RTN","ORMSD",70,0)
 .S STATUS=$P(SEG,"|",2)
"RTN","ORMSD",71,0)
 .S RESULT("APPT IEN")=$P(STATUS,U,2)
"RTN","ORMSD",72,0)
 S RESULT("REJECTION ERROR")=$P(SEG,"|",2) S FAILMSA=1
"RTN","ORMSD",73,0)
 ;S OREASON=RESULT("REJECTION ERROR")
"RTN","ORMSD",74,0)
 Q
"RTN","ORMSD",75,0)
 ;
"RTN","ORMSD",76,0)
SCH(RESULT,X,SEG,ERROR) ;
"RTN","ORMSD",77,0)
 N TIME
"RTN","ORMSD",78,0)
 S RESULT("ORDER IEN")=$P(SEG,"|",2),RESULT("APPT IEN")=+$P(SEG,"|",1)
"RTN","ORMSD",79,0)
 S RESULT("APPT TYPE")=$P($P(SEG,"|",5),U,2)
"RTN","ORMSD",80,0)
 S ACTION=$P(SEG,"|",6) S RESULT($S($P(ACTION,U)="S15":"DISCONTINUE",1:"COMPLETE"))=1
"RTN","ORMSD",81,0)
 I $P(ACTION,U,2)="PARTIAL" S RESULT("PARTIAL")=1
"RTN","ORMSD",82,0)
 S DATE=$P(SEG,"|",8),TIME=$P(SEG,"|",9)
"RTN","ORMSD",83,0)
 I TIME="T" S RESULT("NLT")=1
"RTN","ORMSD",84,0)
 S RESULT("RTC DATE")=$$HL7TFM^XLFDT($S(TIME="T":$P(DATE,U,2),1:$P(DATE,U)),"L")
"RTN","ORMSD",85,0)
 S FREQ=$P(SEG,"|",10),NUM=+$P(SEG,"|",11)
"RTN","ORMSD",86,0)
 S RESULT("NUMBER APPT")=NUM I NUM>0 S RESULT("INTERVAL")=+$E(FREQ,2,3)
"RTN","ORMSD",87,0)
 S RESULT("SIGNED BY")=$P(SEG,"|",14)
"RTN","ORMSD",88,0)
 S RESULT("DISPOSITION BY")=$P(SEG,"|",16)
"RTN","ORMSD",89,0)
 Q
"RTN","ORMSD",90,0)
 ;
"RTN","ORMSD",91,0)
AIL(RESULT,X,SEG,ERROR) ;
"RTN","ORMSD",92,0)
 S RESULT("CLINIC")=$P(SEG,"|",3)
"RTN","ORMSD",93,0)
 Q
"RTN","ORMSD",94,0)
AIG(RESULT,X,SEG,ERROR) ;
"RTN","ORMSD",95,0)
 N INST,NODE
"RTN","ORMSD",96,0)
 S RESULT("PREREQ",$P(SEG,"|"))=$P($P(SEG,"|",2),U,2)
"RTN","ORMSD",97,0)
 S INST=0 F  S INST=$O(@ORMSG@(X,INST)) Q:INST'>0  D
"RTN","ORMSD",98,0)
 .S NODE=$P(@ORMSG@(X,INST),"|",2,99)
"RTN","ORMSD",99,0)
 .S RESULT("PREREQ",$P(NODE,"|"))=$P($P(NODE,"|",2),U,2)
"RTN","ORMSD",100,0)
 Q
"RTN","ORMSD",101,0)
 ;
"RTN","ORMSD",102,0)
NTE(RESULT,X,SEG,ERROR) ;
"RTN","ORMSD",103,0)
 S RESULT("COMMENT")=$$UNESC($P(SEG,"|",3))
"RTN","ORMSD",104,0)
 Q
"RTN","ORMSD",105,0)
 ;
"RTN","ORMSD",106,0)
 ;
"RTN","ORMSD",107,0)
PID(RESULT,X,SEG,ERROR) ;
"RTN","ORMSD",108,0)
 S RESULT("PATIENT")=$P(SEG,"|",3)_U_$P(SEG,"|",5)
"RTN","ORMSD",109,0)
 Q
"RTN","ORMSD",110,0)
 ;
"RTN","ORMSD",111,0)
PV1(RESULT,X,SEG,ERROR) ; -- Gets Patient location info.
"RTN","ORMSD",112,0)
 ;    may not be needed for scheduling
"RTN","ORMSD",113,0)
 Q
"RTN","ORMSD",114,0)
 ;
"RTN","ORMSD",115,0)
FMDATE(Y) ; -- Convert HL7 date/time to FM format
"RTN","ORMSD",116,0)
 Q $$HL7TFM^XLFDT(Y)
"RTN","ORMSD",117,0)
 ;
"RTN","ORMSD",118,0)
REJECT(RESULT) ;
"RTN","ORMSD",119,0)
 N ORIFN,ORNATR
"RTN","ORMSD",120,0)
 S ORIFN=$P($G(RESULT("MSG ID")),U) Q:+ORIFN'>0
"RTN","ORMSD",121,0)
 S:'$G(ORNATR) ORNATR="X" ;Rejected
"RTN","ORMSD",122,0)
 S ^OR(100,+ORIFN,6)=$O(^ORD(100.02,"C",ORNATR,0))_U_U_+$E($$NOW^XLFDT,1,12)_U_U_RESULT("REJECTION ERROR")
"RTN","ORMSD",123,0)
 I $P($G(^OR(100,+ORIFN,3)),U,11)=2 N ORIG S ORIG=$P(^(3),U,5) S:ORIG $P(^OR(100,ORIG,3),U,6)="" ;remove fwd ptr if pending renewal
"RTN","ORMSD",124,0)
 S ORERR=RESULT("REJECTION ERROR")
"RTN","ORMSD",125,0)
 N ORDA S ORDA=+$P(ORIFN,";",2) I ORDA D
"RTN","ORMSD",126,0)
 . S $P(^OR(100,+ORIFN,8,ORDA,0),U,15)=13 ;request rejected
"RTN","ORMSD",127,0)
 . S:$L(RESULT("REJECTION ERROR")) ^OR(100,+ORIFN,8,ORDA,1)=RESULT("REJECTION ERROR")
"RTN","ORMSD",128,0)
 D STATUS^ORCSAVE2(+ORIFN,13)
"RTN","ORMSD",129,0)
 Q
"RTN","ORMSD",130,0)
 ;
"RTN","ORMSD",131,0)
ACCEPT(RESULT) ;
"RTN","ORMSD",132,0)
 N ORIFN
"RTN","ORMSD",133,0)
 S ORIFN=$P($G(RESULT("MSG ID")),U)
"RTN","ORMSD",134,0)
 I $P(RESULT("MSG ID"),U,2)'="S05" D  Q
"RTN","ORMSD",135,0)
 .S ^OR(100,+ORIFN,4)=$G(RESULT("APPT IEN"))
"RTN","ORMSD",136,0)
 .D STATUS^ORCSAVE2(+ORIFN,5)
"RTN","ORMSD",137,0)
 .D DATES^ORCSAVE2(+ORIFN,DT,"")
"RTN","ORMSD",138,0)
 D DCACK(+ORIFN,.RESULT)
"RTN","ORMSD",139,0)
 Q
"RTN","ORMSD",140,0)
 ;
"RTN","ORMSD",141,0)
DCACK(ORIFN,RESULT) ;
"RTN","ORMSD",142,0)
 N ORSTS
"RTN","ORMSD",143,0)
 ;set status to discontinue used as a variable for future code changes
"RTN","ORMSD",144,0)
 S ORSTS=1
"RTN","ORMSD",145,0)
 D EXPDT(ORIFN)
"RTN","ORMSD",146,0)
 D STATUS^ORCSAVE2(+ORIFN,ORSTS)
"RTN","ORMSD",147,0)
 I $G(RESULT("APPT IEN"))'="" S ^OR(100,+ORIFN,4)=RESULT("APPT IEN")
"RTN","ORMSD",148,0)
 Q
"RTN","ORMSD",149,0)
 ;
"RTN","ORMSD",150,0)
GETSTAT(RESULT) ;
"RTN","ORMSD",151,0)
 I +$G(RESULT("DISCONTINUE")) Q $O(^ORD(100.01,"B","DISCONTINUED",""))
"RTN","ORMSD",152,0)
 I +$G(RESULT("PARTIAL")) Q $O(^ORD(100.01,"B","PARTIAL RESULTS",""))
"RTN","ORMSD",153,0)
 Q $O(^ORD(100.01,"B","COMPLETE",""))
"RTN","ORMSD",154,0)
 ;
"RTN","ORMSD",155,0)
EXPDT(ORIFN) ; -- save exp date when dc'd
"RTN","ORMSD",156,0)
 N STOP S STOP=$P($G(^OR(100,+ORIFN,0)),U,9)
"RTN","ORMSD",157,0)
 I STOP,STOP<$$NOW^XLFDT,'$P($G(^OR(100,+ORIFN,6)),U,6) S $P(^(6),U,6)=STOP
"RTN","ORMSD",158,0)
 Q
"RTN","ORMSD",159,0)
 ;
"RTN","ORMSD",160,0)
VALIDATE(RESULT,ERROR) ;
"RTN","ORMSD",161,0)
 N OK,ORIFN,OR3,STS
"RTN","ORMSD",162,0)
 S OK=1
"RTN","ORMSD",163,0)
 I +$G(RESULT("CLINIC"))'>0 S ERROR="Clinic location not defined" S OK=0 G VALIDATX
"RTN","ORMSD",164,0)
 I '$G(RESULT("COMPLETE")),'$G(RESULT("DISCONTINUE")) S ERROR="Status not defined" S OK=0 G VALIDATX
"RTN","ORMSD",165,0)
 I +$G(RESULT("PATIENT"))'>0 S ERROR="Patient is not defined" S OK=0 G VALIDATX
"RTN","ORMSD",166,0)
 I +$G(RESULT("PATIENT"))_";DPT("'=$P($G(^OR(100,RESULT("ORDER IEN"),0)),U,2) S ERROR="Patient doesn't match" S OK=0 G VALIDATX
"RTN","ORMSD",167,0)
 I '+$G(RESULT("DISPOSITION BY")) S ERROR="User who disposition the order not defined" S OK=0 G VALIDATX
"RTN","ORMSD",168,0)
 S ORIFN=RESULT("ORDER IEN") I +ORIFN'>0 S ERROR="Order number not defined" S OK=0 G VALIDATX
"RTN","ORMSD",169,0)
 S OR3=$G(^OR(100,+ORIFN,3)),STS=$P(OR3,U,3)
"RTN","ORMSD",170,0)
 I STS=1!(STS=2) S ERROR="Order with a status of "_$S(STS=1:"discontinued",1:"complete")_" cannot be changed" S OK=0 G VALIDATX
"RTN","ORMSD",171,0)
VALIDATX ;
"RTN","ORMSD",172,0)
 Q OK
"RTN","ORMSD",173,0)
 ;
"RTN","ORMSD",174,0)
SAVEREC(RESULT) ;
"RTN","ORMSD",175,0)
 N C,CREATACT,DISPBY,I,ID,ISTIME,OERR,ORDA,ORDG,ORDIALOG,ORIFN,ORNATR,ORNP,ORNOW,ORPKG,ORSTRT,ORVP,ORWHO,STATUS,TYPE,WHOSIGN,X0,X8
"RTN","ORMSD",176,0)
 N ORLEAD,ORTRAIL
"RTN","ORMSD",177,0)
 S ORWHO=+RESULT("DISPOSITION BY")
"RTN","ORMSD",178,0)
 S ORNP=ORWHO
"RTN","ORMSD",179,0)
 S ORNOW=+$E($$NOW^XLFDT,1,12)
"RTN","ORMSD",180,0)
 S ORDIALOG=+$O(^ORD(101.41,"AB","SD RTC",0))
"RTN","ORMSD",181,0)
 S ORDG=+$O(^ORD(100.98,"B","CLINIC SCHEDULING",0))
"RTN","ORMSD",182,0)
 S ORIFN=RESULT("ORDER IEN")
"RTN","ORMSD",183,0)
 S ORVP=+RESULT("PATIENT")_";DPT("
"RTN","ORMSD",184,0)
 S ORPKG=+$$PKG("SD") D GETDLG1^ORCD(ORDIALOG),GETORDER^ORCD(+ORIFN,"ORDIALOG")
"RTN","ORMSD",185,0)
 ;set ORDIALOG array to values returned from scheduling single instance
"RTN","ORMSD",186,0)
 S ORDA=$P(ORIFN,";",2) I ORDA="" S ORDA=1
"RTN","ORMSD",187,0)
 S X0=$G(^OR(100,+ORIFN,0)),X8=$G(^OR(100,ORIFN,8,ORDA,0))
"RTN","ORMSD",188,0)
 ;get whosigned and start date for later
"RTN","ORMSD",189,0)
 S WHOSIGN=$P(X8,U,5),ORSTRT=$P(X0,U,8)
"RTN","ORMSD",190,0)
 ;update package reference
"RTN","ORMSD",191,0)
 S ^OR(100,+ORIFN,4)=$G(RESULT("APPT IEN"))
"RTN","ORMSD",192,0)
 ;create new order action
"RTN","ORMSD",193,0)
 ;set to complete status until next iteration of VSE
"RTN","ORMSD",194,0)
 S STATUS=$$GETSTAT(.RESULT)
"RTN","ORMSD",195,0)
 S TYPE=$S(+$G(RESULT("DISCONTINUE")):"DC",1:"XX")
"RTN","ORMSD",196,0)
 D STATUS^ORCSAVE2(ORIFN,STATUS)
"RTN","ORMSD",197,0)
 S CREATACT=$$CREATACT("I")
"RTN","ORMSD",198,0)
 I CREATACT=1 S ORDA=$$ACTION^ORCSAVE(TYPE,ORIFN,WHOSIGN,$S(TYPE="DC":"Per Scheduling",1:""),ORNOW,ORWHO)
"RTN","ORMSD",199,0)
 I CREATACT=0 S ORDA=$$LASTACT(ORIFN)
"RTN","ORMSD",200,0)
 ;if order is not created how to get this to expert system
"RTN","ORMSD",201,0)
 I ORDA'>0 S ORERR="Cannot create new order action" Q
"RTN","ORMSD",202,0)
 ;update status to compete set indexes
"RTN","ORMSD",203,0)
 ;I TYPE'="DC" D SETALL^ORDD100(ORIFN)
"RTN","ORMSD",204,0)
 D SETALL^ORDD100(ORIFN)
"RTN","ORMSD",205,0)
 ;set the order as it has been release to scheduling with the update
"RTN","ORMSD",206,0)
 D RELEASE^ORCSAVE2(ORIFN,ORDA,ORNOW,ORWHO,"I")
"RTN","ORMSD",207,0)
 S ORNATR="I"
"RTN","ORMSD",208,0)
 D SIGSTS^ORCSAVE2(+ORIFN,ORDA)
"RTN","ORMSD",209,0)
 ;update dates
"RTN","ORMSD",210,0)
 D DATES^ORCSAVE2(ORIFN,ORSTRT,ORNOW)
"RTN","ORMSD",211,0)
 ;set disposition fields
"RTN","ORMSD",212,0)
 N DA,DR,DIE
"RTN","ORMSD",213,0)
 S DA(1)=ORIFN,DA=ORDA
"RTN","ORMSD",214,0)
 S DIE="^OR(100,"_DA(1)_",8,"
"RTN","ORMSD",215,0)
 S DR="40////"_ORWHO_";41////"_RESULT("MSG DATE/TIME")
"RTN","ORMSD",216,0)
 D ^DIE
"RTN","ORMSD",217,0)
 S $P(^OR(100,+ORIFN,8,ORDA,0),U,14)=ORDA
"RTN","ORMSD",218,0)
 S $P(^OR(100,+ORIFN,3),U,7)=ORDA
"RTN","ORMSD",219,0)
 I TYPE="DC" D
"RTN","ORMSD",220,0)
 .D CANCEL^ORCSEND(+ORIFN)
"RTN","ORMSD",221,0)
 .D EN^ORB3(91,+RESULT("PATIENT"),ORIFN,"","Appointment Request Cancelled in Scheduling","NEW,"_ORIFN) Q
"RTN","ORMSD",222,0)
 S ISTIME=+$G(ORDIALOG($$PTR("YES/NO"),1))
"RTN","ORMSD",223,0)
 S ORLEAD=$S(ISTIME=1:"no later than ",1:"on or around ("),ORTRAIL=$S(ISTIME=1:"",1:")")
"RTN","ORMSD",224,0)
 K ^OR(100,+ORIFN,4.5) D RESPONSE^ORCSAVE,ORDTEXT^ORCSAVE1(+ORIFN_";"_ORDA)
"RTN","ORMSD",225,0)
 ;update the dialog and package fiels. This may have value in future version of VSE
"RTN","ORMSD",226,0)
 S $P(^OR(100,ORIFN,0),U,5)=ORDIALOG_";ORD(101.41,",$P(^(0),U,14)=ORPKG
"RTN","ORMSD",227,0)
 ;validate display group and update if needed
"RTN","ORMSD",228,0)
 I $P(^OR(100,ORIFN,0),U,11)'=ORDG D
"RTN","ORMSD",229,0)
 . N DA,DR,DIE
"RTN","ORMSD",230,0)
 . S DA=ORIFN,DR="23////"_ORDG,DIE="^OR(100," D ^DIE
"RTN","ORMSD",231,0)
 ;S $P(^(8,ORDA,0),U,14)=ORDA
"RTN","ORMSD",232,0)
 ;send back ack back, because scheduling is using a SRM message this code is branched from
"RTN","ORMSD",233,0)
 ;the standard OR HL7 message. This handle in the EN line tag of this routine.
"RTN","ORMSD",234,0)
 ;S ORIFN=ORIFN_";"_ORDA,ORDCNTRL="SN" ;to send NA msg back
"RTN","ORMSD",235,0)
 Q
"RTN","ORMSD",236,0)
 ;
"RTN","ORMSD",237,0)
UPDRESP(ORIFN,ORDIALOG) ;
"RTN","ORMSD",238,0)
 N C,I,ID,TYPE
"RTN","ORMSD",239,0)
 F ID="LOCATION","CLINICALLY","YN","SDNUM","SDINT","SDCOMMENT" D
"RTN","ORMSD",240,0)
 .S TYPE=$$PMPTMAP(ID) I ID="" Q
"RTN","ORMSD",241,0)
 .I ID="SDINT",+$G(ORDIALOG($$PTR($P(TYPE,U)),1))=0,$P($G(RESULT($P(TYPE,U,2))),U)=0 Q
"RTN","ORMSD",242,0)
 .I $P($G(RESULT($P(TYPE,U,2))),U)'="" S ORDIALOG($$PTR($P(TYPE,U)),1)=$P($G(RESULT($P(TYPE,U,2))),U) Q
"RTN","ORMSD",243,0)
 .I $G(ORDIALOG($$PTR($P(TYPE,U)),1))'="" S ORDIALOG($$PTR($P(TYPE,U)),1)="@"
"RTN","ORMSD",244,0)
 Q
"RTN","ORMSD",245,0)
 ;
"RTN","ORMSD",246,0)
PMPTMAP(ID) ;
"RTN","ORMSD",247,0)
 I ID="CLINIC" Q "LOCATION"_U_"CLINIC"
"RTN","ORMSD",248,0)
 I ID="CLINICALLY" Q "CLINICALLY INDICATED DATE"_U_"RTC DATE"
"RTN","ORMSD",249,0)
 I ID="SDNUM" Q "APPT NUM"_U_"NUMBER APPT"
"RTN","ORMSD",250,0)
 I ID="SDINT" Q "SCH INTERVAL"_U_"INTERVAL"
"RTN","ORMSD",251,0)
 I ID="SDCOMMENT" Q "SD COMMENT"_U_"COMMENT"
"RTN","ORMSD",252,0)
 I ID="YN" Q "YES/NO"_U_"NLT"
"RTN","ORMSD",253,0)
 Q ""
"RTN","ORMSD",254,0)
 ;
"RTN","ORMSD",255,0)
SENDFAIL(ERROR,RESULT) ;
"RTN","ORMSD",256,0)
 N ORV
"RTN","ORMSD",257,0)
 S ORV("XQY0")="" D EN^ORERR(ERROR,.ORMSG,.ORV)
"RTN","ORMSD",258,0)
 ;Q:ORTYPE="ORR"  Q:'$L($G(ORNMSP))
"RTN","ORMSD",259,0)
 N OREMSG
"RTN","ORMSD",260,0)
 ;N ORVP,ORTS S:'$G(ORDUZ) ORDUZ=PAT_";DPT(" D:'$G(ORVP) PID
"RTN","ORMSD",261,0)
 S OREMSG(1)=$$MSH^ORMBLD("SRM","SD")_"|"_$G(RESULT("MSG ID"))
"RTN","ORMSD",262,0)
 S OREMSG(2)="MSA|AR|"_ERROR_"|||207^"_ERROR
"RTN","ORMSD",263,0)
 S OREMSG(3)="ERR|^^^"
"RTN","ORMSD",264,0)
 D MSG^XQOR("OR EVSEND SD",.OREMSG)
"RTN","ORMSD",265,0)
 Q
"RTN","ORMSD",266,0)
 ;
"RTN","ORMSD",267,0)
SENDOK(RESULT) ;
"RTN","ORMSD",268,0)
 N ORMSG
"RTN","ORMSD",269,0)
 S ORMSG(1)=$$MSH^ORMBLD("SRM","SD")_"|"_RESULT("MSG ID")
"RTN","ORMSD",270,0)
 S ORMSG(2)="MSA|AA|OK|||"
"RTN","ORMSD",271,0)
 D MSG^XQOR("OR EVSEND SD",.ORMSG)
"RTN","ORMSD",272,0)
 Q
"RTN","ORMSD",273,0)
 ;
"RTN","ORMSD",274,0)
PKG(NMSP) ; -- Return Package file ptr for NMSP
"RTN","ORMSD",275,0)
 N I S I=0
"RTN","ORMSD",276,0)
 F  S I=+$O(^DIC(9.4,"C",NMSP,I)) Q:I<1  Q:'$O(^(I,0))  ;no Addl Prefs
"RTN","ORMSD",277,0)
 Q I
"RTN","ORMSD",278,0)
 ;
"RTN","ORMSD",279,0)
PTR(X) ; -- Return ptr to prompt OR GTX X
"RTN","ORMSD",280,0)
 Q +$O(^ORD(101.41,"AB","OR GTX "_X,0))
"RTN","ORMSD",281,0)
 ;
"RTN","ORMSD",282,0)
VALUE(ID) ; -- Return value of ID in ^OR(100,+ORIFN,4.5,"ID")
"RTN","ORMSD",283,0)
 N I,Y I '$L($G(ID)) Q ""
"RTN","ORMSD",284,0)
 S I=+$O(^OR(100,+ORIFN,4.5,"ID",ID,0))
"RTN","ORMSD",285,0)
 S Y=$G(^OR(100,+ORIFN,4.5,I,1))
"RTN","ORMSD",286,0)
 Q Y
"VER")
8.0^22.2
**END**
**END**
