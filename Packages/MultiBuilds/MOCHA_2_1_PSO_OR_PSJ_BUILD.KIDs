KIDS Distribution saved on Aug 02, 2017@12:38:40
MOCHA 2.1 COMBINED BUILD 1.0 8/1/17
**KIDS**:MOCHA 2.1 COMBINED BUILD 1.0^PSO*7.0*402^OR*3.0*382^PSJ*5.0*256^

**INSTALL NAME**
MOCHA 2.1 COMBINED BUILD 1.0
"BLD",9613,0)
MOCHA 2.1 COMBINED BUILD 1.0^^1^3170802^y
"BLD",9613,6.3)
7
"BLD",9613,10,0)
^9.63^3^3
"BLD",9613,10,1,0)
PSO*7.0*402^1
"BLD",9613,10,2,0)
OR*3.0*382^1
"BLD",9613,10,3,0)
PSJ*5.0*256^1
"BLD",9613,10,"B","OR*3.0*382",2)

"BLD",9613,10,"B","PSJ*5.0*256",3)

"BLD",9613,10,"B","PSO*7.0*402",1)

"MBREQ")
0
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"VER")
8.0^22.2
**INSTALL NAME**
PSO*7.0*402
"BLD",9610,0)
PSO*7.0*402^OUTPATIENT PHARMACY^0^3170802^y
"BLD",9610,1,0)
^^1^1^3160728^
"BLD",9610,1,1,0)
Mocha 2.1, dosing only scope.
"BLD",9610,4,0)
^9.64PA^^
"BLD",9610,6.3)
8
"BLD",9610,"KRN",0)
^9.67PA^779.2^20
"BLD",9610,"KRN",.4,0)
.4
"BLD",9610,"KRN",.401,0)
.401
"BLD",9610,"KRN",.402,0)
.402
"BLD",9610,"KRN",.403,0)
.403
"BLD",9610,"KRN",.5,0)
.5
"BLD",9610,"KRN",.84,0)
.84
"BLD",9610,"KRN",3.6,0)
3.6
"BLD",9610,"KRN",3.8,0)
3.8
"BLD",9610,"KRN",9.2,0)
9.2
"BLD",9610,"KRN",9.8,0)
9.8
"BLD",9610,"KRN",9.8,"NM",0)
^9.68A^18^17
"BLD",9610,"KRN",9.8,"NM",1,0)
PSOBKDE1^^0^B8242878
"BLD",9610,"KRN",9.8,"NM",2,0)
PSOBKDED^^0^B88300937
"BLD",9610,"KRN",9.8,"NM",3,0)
PSODDPR2^^0^B139372771
"BLD",9610,"KRN",9.8,"NM",4,0)
PSODOSU2^^0^B142830151
"BLD",9610,"KRN",9.8,"NM",5,0)
PSODOSUN^^0^B100479276
"BLD",9610,"KRN",9.8,"NM",6,0)
PSODOSUT^^0^B149150710
"BLD",9610,"KRN",9.8,"NM",7,0)
PSOORED3^^0^B66487001
"BLD",9610,"KRN",9.8,"NM",8,0)
PSOORED5^^0^B72949792
"BLD",9610,"KRN",9.8,"NM",10,0)
PSOVER1^^0^B130702321
"BLD",9610,"KRN",9.8,"NM",11,0)
PSOORED4^^0^B57603808
"BLD",9610,"KRN",9.8,"NM",12,0)
PSO7P402^^0^B1937067
"BLD",9610,"KRN",9.8,"NM",13,0)
PSOORUT2^^0^B105731983
"BLD",9610,"KRN",9.8,"NM",14,0)
PSORXEDT^^0^B51616221
"BLD",9610,"KRN",9.8,"NM",15,0)
PSODEM^^0^B18875711
"BLD",9610,"KRN",9.8,"NM",16,0)
PSODOSU4^^0^B2907861
"BLD",9610,"KRN",9.8,"NM",17,0)
PSODOSCL^^0^B29898575
"BLD",9610,"KRN",9.8,"NM",18,0)
PSOSIG^^0^B70274708
"BLD",9610,"KRN",9.8,"NM","B","PSO7P402",12)

"BLD",9610,"KRN",9.8,"NM","B","PSOBKDE1",1)

"BLD",9610,"KRN",9.8,"NM","B","PSOBKDED",2)

"BLD",9610,"KRN",9.8,"NM","B","PSODDPR2",3)

"BLD",9610,"KRN",9.8,"NM","B","PSODEM",15)

"BLD",9610,"KRN",9.8,"NM","B","PSODOSCL",17)

"BLD",9610,"KRN",9.8,"NM","B","PSODOSU2",4)

"BLD",9610,"KRN",9.8,"NM","B","PSODOSU4",16)

"BLD",9610,"KRN",9.8,"NM","B","PSODOSUN",5)

"BLD",9610,"KRN",9.8,"NM","B","PSODOSUT",6)

"BLD",9610,"KRN",9.8,"NM","B","PSOORED3",7)

"BLD",9610,"KRN",9.8,"NM","B","PSOORED4",11)

"BLD",9610,"KRN",9.8,"NM","B","PSOORED5",8)

"BLD",9610,"KRN",9.8,"NM","B","PSOORUT2",13)

"BLD",9610,"KRN",9.8,"NM","B","PSORXEDT",14)

"BLD",9610,"KRN",9.8,"NM","B","PSOSIG",18)

"BLD",9610,"KRN",9.8,"NM","B","PSOVER1",10)

"BLD",9610,"KRN",19,0)
19
"BLD",9610,"KRN",19.1,0)
19.1
"BLD",9610,"KRN",101,0)
101
"BLD",9610,"KRN",409.61,0)
409.61
"BLD",9610,"KRN",409.61,"NM",0)
^9.68A^^0
"BLD",9610,"KRN",771,0)
771
"BLD",9610,"KRN",779.2,0)
779.2
"BLD",9610,"KRN",870,0)
870
"BLD",9610,"KRN",8989.51,0)
8989.51
"BLD",9610,"KRN",8989.52,0)
8989.52
"BLD",9610,"KRN",8994,0)
8994
"BLD",9610,"KRN","B",.4,.4)

"BLD",9610,"KRN","B",.401,.401)

"BLD",9610,"KRN","B",.402,.402)

"BLD",9610,"KRN","B",.403,.403)

"BLD",9610,"KRN","B",.5,.5)

"BLD",9610,"KRN","B",.84,.84)

"BLD",9610,"KRN","B",3.6,3.6)

"BLD",9610,"KRN","B",3.8,3.8)

"BLD",9610,"KRN","B",9.2,9.2)

"BLD",9610,"KRN","B",9.8,9.8)

"BLD",9610,"KRN","B",19,19)

"BLD",9610,"KRN","B",19.1,19.1)

"BLD",9610,"KRN","B",101,101)

"BLD",9610,"KRN","B",409.61,409.61)

"BLD",9610,"KRN","B",771,771)

"BLD",9610,"KRN","B",779.2,779.2)

"BLD",9610,"KRN","B",870,870)

"BLD",9610,"KRN","B",8989.51,8989.51)

"BLD",9610,"KRN","B",8989.52,8989.52)

"BLD",9610,"KRN","B",8994,8994)

"BLD",9610,"PRE")
PSO7P402
"BLD",9610,"QUES",0)
^9.62^^
"BLD",9610,"REQB",0)
^9.611^9^6
"BLD",9610,"REQB",3,0)
PSO*7.0*458^2
"BLD",9610,"REQB",4,0)
PSO*7.0*444^2
"BLD",9610,"REQB",5,0)
PSO*7.0*450^2
"BLD",9610,"REQB",7,0)
PSO*7.0*436^2
"BLD",9610,"REQB",8,0)
PSS*1.0*178^2
"BLD",9610,"REQB",9,0)
PSO*7.0*455^2
"BLD",9610,"REQB","B","PSO*7.0*436",7)

"BLD",9610,"REQB","B","PSO*7.0*444",4)

"BLD",9610,"REQB","B","PSO*7.0*450",5)

"BLD",9610,"REQB","B","PSO*7.0*455",9)

"BLD",9610,"REQB","B","PSO*7.0*458",3)

"BLD",9610,"REQB","B","PSS*1.0*178",8)

"MBREQ")
1
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
402^3170802^10000000070
"PKG",141,22,1,"PAH",1,1,0)
^^1^1^3170802
"PKG",141,22,1,"PAH",1,1,1,0)
Mocha 2.1, dosing only scope.
"PRE")
PSO7P402
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
17
"RTN","PSO7P402")
0^12^B1937067
"RTN","PSO7P402",1,0)
PSO7P402 ;BP/CMF - PATCH PSO*7*402 Pre/Post-Init Rtn ;04/20/2010
"RTN","PSO7P402",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**402**;DEC 1997;Build 8
"RTN","PSO7P402",3,0)
 ;
"RTN","PSO7P402",4,0)
ENV ;environment check
"RTN","PSO7P402",5,0)
 S XPDABORT=""
"RTN","PSO7P402",6,0)
 ;D PRODCHK(.XPDABORT) I XPDABORT=2 Q  ;comment this line out after sprint 3
"RTN","PSO7P402",7,0)
 D PROGCHK(.XPDABORT) ;checks programmer variables
"RTN","PSO7P402",8,0)
 I XPDABORT="" K XPDABORT
"RTN","PSO7P402",9,0)
 Q
"RTN","PSO7P402",10,0)
 ;
"RTN","PSO7P402",11,0)
PRODCHK(XPDABORT) ;checks for test/production account
"RTN","PSO7P402",12,0)
 I $$PROD^XUPROD DO
"RTN","PSO7P402",13,0)
 . D BMES^XPDUTL("******")
"RTN","PSO7P402",14,0)
 . D MES^XPDUTL("PSO*7*402 is not yet ready for production accounts.")
"RTN","PSO7P402",15,0)
 . D MES^XPDUTL("Installation aborted.")
"RTN","PSO7P402",16,0)
 . D MES^XPDUTL("******")
"RTN","PSO7P402",17,0)
 . S XPDABORT=2
"RTN","PSO7P402",18,0)
 Q
"RTN","PSO7P402",19,0)
 ;
"RTN","PSO7P402",20,0)
PROGCHK(XPDABORT) ;checks for necessary programmer variables
"RTN","PSO7P402",21,0)
 I '$G(DUZ)!($G(DUZ(0))'="@")!('$G(DT))!($G(U)'="^") DO
"RTN","PSO7P402",22,0)
 . D BMES^XPDUTL("******")
"RTN","PSO7P402",23,0)
 . D MES^XPDUTL("Your programming variables are not set up properly.")
"RTN","PSO7P402",24,0)
 . D MES^XPDUTL("Installation aborted.")
"RTN","PSO7P402",25,0)
 . D MES^XPDUTL("******")
"RTN","PSO7P402",26,0)
 . S XPDABORT=2
"RTN","PSO7P402",27,0)
 Q
"RTN","PSO7P402",28,0)
 ;
"RTN","PSO7P402",29,0)
PRE ;; hook for pre install actions
"RTN","PSO7P402",30,0)
 Q
"RTN","PSO7P402",31,0)
POST ;; hook for post install actions
"RTN","PSO7P402",32,0)
 Q
"RTN","PSOBKDE1")
0^1^B8242878
"RTN","PSOBKDE1",1,0)
PSOBKDE1 ;BIR/MR-Sub-routines for Backdoor Rx Order Edit ;11/25/02
"RTN","PSOBKDE1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**117,133,372,402**;DEC 1997;Build 8
"RTN","PSOBKDE1",3,0)
 ;
"RTN","PSOBKDE1",4,0)
LST1 ;
"RTN","PSOBKDE1",5,0)
 W @IOF
"RTN","PSOBKDE1",6,0)
 N PSOLCNT,DIRUT,DTOUT,DUOUT,I,PSODOSCT,PSODOSFL,PSOBKDF1
"RTN","PSOBKDE1",7,0)
 W !,"This is the amount of medication the patient is to receive as one dose"
"RTN","PSOBKDE1",8,0)
 W !,"for this order. This can be a numeric value, such as 325 or 650 or an"
"RTN","PSOBKDE1",9,0)
 W !,"amount with a unit of measure such as 325MG or 650MG. You may also enter"
"RTN","PSOBKDE1",10,0)
 W !,"a free text dosage, such as 1 Tablet or 2 Tablets",!
"RTN","PSOBKDE1",11,0)
 S PSOLCNT=5,PSOBKDF1=1
"RTN","PSOBKDE1",12,0)
 ;
"RTN","PSOBKDE1",13,0)
LST ;
"RTN","PSOBKDE1",14,0)
 I '$G(PSOBKDF1) W @IOF S PSOBKDF1=1
"RTN","PSOBKDE1",15,0)
 N DIR I '$D(DOSE("DD")) D  Q
"RTN","PSOBKDE1",16,0)
 . W !," No dosages are available"
"RTN","PSOBKDE1",17,0)
 . N X S X=$$GET1^DIQ(50,PSODRUG("IEN"),100,"I")
"RTN","PSOBKDE1",18,0)
 . W $S(X'=""&(DT>X):" because the Drug is now Inactive.",1:"!")
"RTN","PSOBKDE1",19,0)
 . W !," Please, enter a free text dosage, or You may select a New"
"RTN","PSOBKDE1",20,0)
 . W !," Orderable Item and Dispense Drug for this order, or you can"
"RTN","PSOBKDE1",21,0)
 . W !," enter a New Order with an Active Drug."
"RTN","PSOBKDE1",22,0)
 . S PSOLCNT=$G(PSOLCNT)+4
"RTN","PSOBKDE1",23,0)
 ;
"RTN","PSOBKDE1",24,0)
 I $P(DOSE("DD",PSODRUG("IEN")),"^",5)]"" D
"RTN","PSOBKDE1",25,0)
 .W !,"VERB: "_$P(DOSE("DD",PSODRUG("IEN")),"^",10)
"RTN","PSOBKDE1",26,0)
 .S PSOLCNT=$G(PSOLCNT)+1
"RTN","PSOBKDE1",27,0)
 ;
"RTN","PSOBKDE1",28,0)
LST2 ;
"RTN","PSOBKDE1",29,0)
 I '$G(PSOBKDF1) W @IOF S PSOBKDF1=1
"RTN","PSOBKDE1",30,0)
 S (PSODOSFL,PSODOSCT)=0
"RTN","PSOBKDE1",31,0)
 F I=0:0 S I=$O(DOSE(I)) Q:'I!('$D(DOSE(I)))  S PSODOSCT=I
"RTN","PSOBKDE1",32,0)
 I PSODOSCT=1,$P(DOSE(1),"^")=""&($P(DOSE(1),"^",3)="") S PSODOSFL=1
"RTN","PSOBKDE1",33,0)
 W !!,"There "_$S(PSODOSFL:"are NO",PSODOSCT=1&('PSODOSFL):"is ",1:"are ")_$S(PSODOSFL:"",1:PSODOSCT)_" Available Dosage(s)."
"RTN","PSOBKDE1",34,0)
 F I=0:0 S I=$O(DOSE(I)) Q:'I!('$D(DOSE(I)))  D
"RTN","PSOBKDE1",35,0)
 .S PSOLCNT=$G(PSOLCNT)+1
"RTN","PSOBKDE1",36,0)
 .W:'$G(PSODOSFL) !?5,$J(I,3)_". "_$S($P(DOSE(I),"^"):$P(DOSE(I),"^")_$S($P(DOSE("DD",PSODRUG("IEN")),"^",6)]"":$P(DOSE("DD",PSODRUG("IEN")),"^",6),1:""),$P(DOSE(I),"^",3)'="":$P(DOSE(I),"^",3),1:"Please Enter a Free Text Dosage.")
"RTN","PSOBKDE1",37,0)
 .;Q:(PSOLCNT+2)>PSODOSFL
"RTN","PSOBKDE1",38,0)
 .I PSOLCNT>16&(I>2) D PAUSE S PSOLCNT=0 W !
"RTN","PSOBKDE1",39,0)
 K DIRUT,DIR
"RTN","PSOBKDE1",40,0)
 Q
"RTN","PSOBKDE1",41,0)
 ;
"RTN","PSOBKDE1",42,0)
PAUSE ;
"RTN","PSOBKDE1",43,0)
 Q:PSODOSCT=I
"RTN","PSOBKDE1",44,0)
 N DIR
"RTN","PSOBKDE1",45,0)
 S DIR("A")="Enter RETURN to view additional dosages or '^' to exit the list of dosages"
"RTN","PSOBKDE1",46,0)
 S DIR(0)="E" W !
"RTN","PSOBKDE1",47,0)
 D ^DIR
"RTN","PSOBKDE1",48,0)
 I $D(DTOUT)!($D(DUOUT)) S I=9999 Q
"RTN","PSOBKDE1",49,0)
 Q
"RTN","PSOBKDED")
0^2^B88300937
"RTN","PSOBKDED",1,0)
PSOBKDED ;BIR/SAB - Edit backdoor Rx Order entry ;04/17/95
"RTN","PSOBKDED",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,46,91,78,99,117,133,143,268,378,416,282,450,402**;DEC 1997;Build 8
"RTN","PSOBKDED",3,0)
 ;Ref PS(50.607 IA 2221
"RTN","PSOBKDED",4,0)
 ;Ref PS(50.7 IA 2223
"RTN","PSOBKDED",5,0)
 ;Ref PS(51.2 IA 2226
"RTN","PSOBKDED",6,0)
 ;Ref PSDRUG( IA 221
"RTN","PSOBKDED",7,0)
 ;Ref DOSE^PSSORPH IA 3234
"RTN","PSOBKDED",8,0)
 ;Ref PS(55 IA 2228
"RTN","PSOBKDED",9,0)
1 S %DT="AEX",%DT(0)=-PSONEW("FILL DATE"),Y=PSONEW("ISSUE DATE") X ^DD("DD") S %DT("A")="ISSUE DATE: ",%DT("B")=Y D ^%DT
"RTN","PSOBKDED",10,0)
 I "^"[$E(X) D KX K %DT Q
"RTN","PSOBKDED",11,0)
 G:Y=-1 1 S (PSOID,PSONEW("ISSUE DATE"))=Y D KX K %DT
"RTN","PSOBKDED",12,0)
 Q
"RTN","PSOBKDED",13,0)
2 S PSONEW("FLD")=2 D FILLDT^PSODIR2(.PSONEW) ;Fdt
"RTN","PSOBKDED",14,0)
 Q
"RTN","PSOBKDED",15,0)
3 S:$G(POERR) PSONEW("ISSUE DATE")=PSOID
"RTN","PSOBKDED",16,0)
 S PSONEW("FLD")=3 D PTSTAT^PSODIR1(.PSONEW) ;Sta
"RTN","PSOBKDED",17,0)
 Q
"RTN","PSOBKDED",18,0)
4 S PSONEW("FLD")=4 D PROV^PSODIR(.PSONEW) ;Pro
"RTN","PSOBKDED",19,0)
 Q
"RTN","PSOBKDED",20,0)
5 S PSONEW("FLD")=5 D CLINIC^PSODIR2(.PSONEW) ;Cli
"RTN","PSOBKDED",21,0)
 Q
"RTN","PSOBKDED",22,0)
6 S PSONEW("FLD")=6 D ^PSODRG,EN^PSODIAG ;Drg/ICD
"RTN","PSOBKDED",23,0)
 D 6^PSODRGN
"RTN","PSOBKDED",24,0)
 Q
"RTN","PSOBKDED",25,0)
7 S PSONEW("FLD")=7 D QTY^PSODIR1(.PSONEW) ;Qty
"RTN","PSOBKDED",26,0)
 Q
"RTN","PSOBKDED",27,0)
8 S PSONEW("FLD")=8 D DAYS^PSODIR1(.PSONEW) ;Day
"RTN","PSOBKDED",28,0)
 K PSMAX,PSTMAX D REF^PSOORNEW S PSONEW("N# REF")=PSONEW("# OF REFILLS")
"RTN","PSOBKDED",29,0)
 Q
"RTN","PSOBKDED",30,0)
9 S PSONEW("FLD")=9 D REFILL^PSODIR1(.PSONEW) ;Ref
"RTN","PSOBKDED",31,0)
 K PSMAX,PSTMAX
"RTN","PSOBKDED",32,0)
 Q
"RTN","PSOBKDED",33,0)
10 S PSONEW("FLD")="3A" N PSOEDDOS S PSOEDDOS=1 D DOSE^PSODIR(.PSONEW) ;Dose
"RTN","PSOBKDED",34,0)
 Q
"RTN","PSOBKDED",35,0)
 ;
"RTN","PSOBKDED",36,0)
 Q  I $G(COPY),$G(SIGOK) S PSOFDR=1 K PSONEW("SIG")
"RTN","PSOBKDED",37,0)
 S PSONEW("FLD")=10 D SIG^PSODIR1(.PSONEW) ;Sig
"RTN","PSOBKDED",38,0)
 I $G(COPY) K PSOFDR
"RTN","PSOBKDED",39,0)
 S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR D KV
"RTN","PSOBKDED",40,0)
 Q
"RTN","PSOBKDED",41,0)
INS S PSONEW("FLD")="3B" D INS^PSODIR(.PSONEW) ;Ins
"RTN","PSOBKDED",42,0)
 Q
"RTN","PSOBKDED",43,0)
11 S PSONEW("FLD")=11 D COPIES^PSODIR1(.PSONEW) ;Cop
"RTN","PSOBKDED",44,0)
 Q
"RTN","PSOBKDED",45,0)
12 S PSONEW("FLD")=12 D MW^PSODIR2(.PSONEW) ;M/W
"RTN","PSOBKDED",46,0)
 Q
"RTN","PSOBKDED",47,0)
13 S PSONEW("FLD")=13 D RMK^PSODIR2(.PSONEW) ;Rem
"RTN","PSOBKDED",48,0)
 Q
"RTN","PSOBKDED",49,0)
DOSE ;backdoor
"RTN","PSOBKDED",50,0)
 I '$G(PSONEW("ENT")) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (5) Dosage Ordered: " G INS1
"RTN","PSOBKDED",51,0)
 S SD=1 F I=1:1:PSONEW("ENT") D 
"RTN","PSOBKDED",52,0)
 .I '$G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOBKDED",53,0)
 .S:$G(SD)=1 IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (5)",DS=1 K SD
"RTN","PSOBKDED",54,0)
 .D DOSE1
"RTN","PSOBKDED",55,0)
INS1 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (6)Pat Instruction:"
"RTN","PSOBKDED",56,0)
INS2 I $O(PSONEW("SIG",0)) F D=0:0 S D=$O(PSONEW("SIG",D)) Q:'D  D
"RTN","PSOBKDED",57,0)
 .F SG=1:1:$L(PSONEW("SIG",D)) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("SIG",D)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " D
"RTN","PSOBKDED",58,0)
 ..S:$P(PSONEW("SIG",D)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("SIG",D)," ",SG)
"RTN","PSOBKDED",59,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") D  Q
"RTN","PSOBKDED",60,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" Other Patient Inst.: "
"RTN","PSOBKDED",61,0)
 .I $G(^PSRX(+$G(PSONEW("OIRXN")),"INSS"))]"" S PSONEW("SINS")=^PSRX(PSONEW("OIRXN"),"INSS")
"RTN","PSOBKDED",62,0)
 .S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_$G(PSONEW("SINS"))
"RTN","PSOBKDED",63,0)
 Q
"RTN","PSOBKDED",64,0)
 ;
"RTN","PSOBKDED",65,0)
DOSE1 I $G(DS)=1 D  K DS G DU
"RTN","PSOBKDED",66,0)
 .S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_" Dosage Ordered: "_$S($E(PSONEW("DOSE",I),1)="."&($G(PSONEW("DOSE ORDERED",I))):"0",1:"")_PSONEW("DOSE",I)_$S($G(PSONEW("UNITS",I))'="":" ("_$P(^PS(50.607,PSONEW("UNITS",I),0),"^")_")",1:"")
"RTN","PSOBKDED",67,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Dosage Ordered: "_$S($E(PSONEW("DOSE",I),1)="."&($G(PSONEW("DOSE ORDERED",I))):"0",1:"")_PSONEW("DOSE",I)_$S($G(PSONEW("UNITS",I))'="":" ("_$P(^PS(50.607,PSONEW("UNITS",I),0),"^")_")",1:"")
"RTN","PSOBKDED",68,0)
DU I '$G(PSONEW("DOSE ORDERED",I)),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Oth. Lang. Dosage: "_$G(PSONEW("ODOSE",I))
"RTN","PSOBKDED",69,0)
 I $G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOBKDED",70,0)
 S:$G(PSONEW("DOSE ORDERED",I)) IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Dispense Units: "_$S($E($G(PSONEW("DOSE ORDERED",I)),1)=".":"0",1:"")_$G(PSONEW("DOSE ORDERED",I))
"RTN","PSOBKDED",71,0)
 I $G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("NOUN",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Noun: "_PSONEW("NOUN",I)
"RTN","PSOBKDED",72,0)
 I $G(PSONEW("ROUTE",I)) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Route: "_$P(^PS(51.2,PSONEW("ROUTE",I),0),"^")
"RTN","PSOBKDED",73,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="            Schedule: "_$G(PSONEW("SCHEDULE",I))
"RTN","PSOBKDED",74,0)
 I $G(PSONEW("DURATION",I))]"" D
"RTN","PSOBKDED",75,0)
 .S IEN=IEN+1
"RTN","PSOBKDED",76,0)
 .S ^TMP("PSOPO",$J,IEN,0)="           *Duration: "_PSONEW("DURATION",I)_" ("_$S(PSONEW("DURATION",I)["M":"MINUTES",PSONEW("DURATION",I)["W":"WEEKS",PSONEW("DURATION",I)["L":"MONTHS",PSONEW("DURATION",I)["H":"HOURS",1:"DAYS")_")"
"RTN","PSOBKDED",77,0)
 I $G(PSONEW("CONJUNCTION",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="         Conjunction: "_$S($G(PSONEW("CONJUNCTION",I))="A":"AND",$G(PSONEW("CONJUNCTION",I))="T":"THEN",$G(PSONEW("CONJUNCTION",I))="X":"EXCEPT",1:"")
"RTN","PSOBKDED",78,0)
 Q
"RTN","PSOBKDED",79,0)
RTE I $G(DRET) S PSORXED("ROUTE",ENT)=""
"RTN","PSOBKDED",80,0)
 I $G(RTE) K RTE
"RTN","PSOBKDED",81,0)
 K DIR,DIRUT S DIR(0)="FO^2:45",DIR("A")="ROUTE",DIR("?")="^D HLP^PSOORED4"
"RTN","PSOBKDED",82,0)
 S DIR("B")=$S($G(PSORXED("ROUTE",ENT)):$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),$G(RTE)]"":RTE,$G(DRET):"",1:"PO") K:DIR("B")="" DIR("B")
"RTN","PSOBKDED",83,0)
 ;I '$G(PSORXED("ROUTE",ENT)),$G(PSOREEDT) K DIR("B")
"RTN","PSOBKDED",84,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="RTE",JUMP=1 K DIRUT,DTOUT Q
"RTN","PSOBKDED",85,0)
 Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOBKDED",86,0)
 I X="@"!(X="") K RTE,ERTE S DRET=1,PSORXED("ROUTE",ENT)="" Q
"RTN","PSOBKDED",87,0)
 K DRET I X=$P($G(^PS(51.2,+$G(PSORXED("ROUTE",ENT)),0)),"^") S RTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),ERTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^",2) W X_" "_$G(ERTE) Q
"RTN","PSOBKDED",88,0)
 S DIC=51.2,DIC(0)="QEZM",DIC("S")="I $P(^(0),""^"",4)" D ^DIC Q:X[U  G:Y=-1 RTE W "  "_$P(Y(0),"^",2)
"RTN","PSOBKDED",89,0)
 S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2)
"RTN","PSOBKDED",90,0)
 Q
"RTN","PSOBKDED",91,0)
ASK K JUMP,UNITN,DOSE D KV D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN)
"RTN","PSOBKDED",92,0)
 N PSODOSCT,PSODOSFL,PSODOSWT D FULL^VALM1  ;402
"RTN","PSOBKDED",93,0)
 I $D(DOSE("DD")) I $G(PSOFROM)="PENDING"!($G(PSOREEDQ)) D LST2^PSOBKDE1 G ASK1
"RTN","PSOBKDED",94,0)
 D:$G(PSOFROM)="NEW"&($G(PSORX("EDIT"))']"")!($G(PSOFROM1))!($G(COPY)) LST^PSOBKDE1:$O(DOSE(0))
"RTN","PSOBKDED",95,0)
ASK1 S STRE=$P($G(DOSE("DD",PSODRUG("IEN"))),"^",5),UNITN=$P($G(DOSE("DD",PSODRUG("IEN"))),"^",6),DOSE("LD")=$P($G(DOSE("DD",PSODRUG("IEN"))),"^",11)
"RTN","PSOBKDED",96,0)
 W ! S DIR(0)="F^1:60"
"RTN","PSOBKDED",97,0)
 I '$G(PSODOSCT) D
"RTN","PSOBKDED",98,0)
 .F I=0:0 S I=$O(DOSE(I)) Q:'I!('$D(DOSE(I)))  S PSODOSCT=I
"RTN","PSOBKDED",99,0)
 .I PSODOSCT=1,$P(DOSE(1),"^")=""&($P(DOSE("DD",PSODRUG("IEN")),"^",6)="") S PSODOSFL=1
"RTN","PSOBKDED",100,0)
 S PSODOSWT="",PSODOSWT=$S($G(PSODOSCT)<1:"",$G(PSODOSCT)=1&($G(PSODOSFL)):"",1:" (1-"_$G(PSODOSCT)_")")
"RTN","PSOBKDED",101,0)
 ;S DIR("A",1)="Select from list of Available Dosages"_PSODOSWT_", Enter Free Text Dose",DIR("?")="^D LST1^PSOBKDE1",DIR("A")="or Enter a Question Mark (?) to view list"
"RTN","PSOBKDED",102,0)
 ; next 2 lines 402
"RTN","PSOBKDED",103,0)
 S:$G(PSODOSFL) DIR("A")="     Please Enter a Free Text Dose"
"RTN","PSOBKDED",104,0)
 S:'$G(PSODOSFL) DIR("A",1)="Select from list of Available Dosages"_PSODOSWT_", Enter Free Text Dose",DIR("?")="^D LST1^PSOBKDE1",DIR("A")="or Enter a Question Mark (?) to view list"
"RTN","PSOBKDED",105,0)
 I $G(PSORXED("DOSE",ENT))]"" S DIR("B")=PSORXED("DOSE",ENT) D
"RTN","PSOBKDED",106,0)
 .I $G(PSORXED("UNITS",ENT))]"",DIR("B")'[($P($G(^PS(50.607,PSORXED("UNITS",ENT),0)),"^")) S DIR("B")=DIR("B")_$P($G(^PS(50.607,PSORXED("UNITS",ENT),0)),"^")
"RTN","PSOBKDED",107,0)
 K:$G(PSOREEDQ)!($G(PSOBDRG)) DIR("B")
"RTN","PSOBKDED",108,0)
 D ^DIR
"RTN","PSOBKDED",109,0)
 I X[U,$L(X)>1 S FIELD="ASK",JUMP=1 K DIRUT,DTOUT Q
"RTN","PSOBKDED",110,0)
 I $D(DIRUT) S:$G(ORD) PSODSPL=1 Q
"RTN","PSOBKDED",111,0)
 I X=$G(PSORXED("DOSE",ENT)),$D(DOSE(Y)) G GD1
"RTN","PSOBKDED",112,0)
 I X=$G(PSORXED("DOSE",ENT)) D  G DOS
"RTN","PSOBKDED",113,0)
 .S DOSE=X,UNITS=$G(PSORXED("UNITS",ENT))
"RTN","PSOBKDED",114,0)
 .I DOSE'?.N&(DOSE'?.N1".".N)!'DOSE("LD") S (UNITN,UNITS,PSORXED("UNITS",ENT))="" K PSORXED("DOSE ORDERED",ENT),DUPD,PSORXED("NOUN",ENT)
"RTN","PSOBKDED",115,0)
GD1 N PSORXTE
"RTN","PSOBKDED",116,0)
 I $D(DOSE(Y)) D  G DOS ;from list
"RTN","PSOBKDED",117,0)
 .S DOSE=$S($P(DOSE(Y),"^"):$P(DOSE(Y),"^"),$P(DOSE(Y),"^",3)]"":$P(DOSE(Y),"^",3),1:1),DOLST=Y
"RTN","PSOBKDED",118,0)
 .I $P(DOSE(Y),"^") S UNITS=$P(DOSE(Y),"^",2),DUPD=$P(DOSE(Y),"^",3),UNITN=$P(DOSE("DD",PSODRUG("IEN")),"^",6),PSORXTE("DOSE ORDERED",ENT)=DUPD
"RTN","PSOBKDED",119,0)
 .S PSORXTE("NOUN",ENT)=$P(DOSE(Y),"^",6),PSORXTE("VERB",ENT)=$P(DOSE(Y),"^",8)
"RTN","PSOBKDED",120,0)
 .I DOSE'?.N&(DOSE'?.N1".".N)!'DOSE("LD") D  Q
"RTN","PSOBKDED",121,0)
 ..S (UNITN,UNITS,PSORXED("UNITS",ENT))="" K PSORXED("DOSE ORDERED",ENT),DUPD,PSORXED("NOUN",ENT)
"RTN","PSOBKDED",122,0)
 ..I $P($G(^PS(55,PSODFN,"LAN")),"^"),$G(PSOFROM)="PENDING" D LAN^PSOORED5 Q
"RTN","PSOBKDED",123,0)
 ..I $P($G(^PS(55,PSODFN,"LAN")),"^"),$G(PSOFROM)="NEW" D LAN^PSOORED5
"RTN","PSOBKDED",124,0)
 .S PSORXTE("UNITS",ENT)=$G(UNITS)
"RTN","PSOBKDED",125,0)
 S DOSE=Y,DOLST=0 ;non-numeric and numeric not in list
"RTN","PSOBKDED",126,0)
 I DOSE("LD") D
"RTN","PSOBKDED",127,0)
 .F I=1:1:$L(DOSE)  I $E(DOSE,I)'?.N&($E(DOSE,I)'?1" ")&($E(DOSE,I)'?1".") S DCHK=$G(DCHK)_$E(DOSE,I)
"RTN","PSOBKDED",128,0)
 .I $G(DCHK)]"" D
"RTN","PSOBKDED",129,0)
 ..S DCHK=$TR(DCHK,"qwertyuioplkjhgfdsazxcvbnm","QWERTYUIOPLKJHGFDSAZXCVBNM")
"RTN","PSOBKDED",130,0)
 ..I DCHK=UNITN S DOSE=+DOSE
"RTN","PSOBKDED",131,0)
 K I,DCHK
"RTN","PSOBKDED",132,0)
 S PSOINDT=$$GET1^DIQ(50,PSODRUG("IEN"),100,"I") I PSOINDT,DT>PSOINDT G DOS
"RTN","PSOBKDED",133,0)
 S PSORXTE("NOUN",ENT)=$P(DOSE("DD",PSODRUG("IEN")),"^",9),PSORXTE("VERB",ENT)=$P(DOSE("DD",PSODRUG("IEN")),"^",10)
"RTN","PSOBKDED",134,0)
 I DOSE'?.N&(DOSE'?.N1".".N)!'DOSE("LD") S (UNITN,UNITS,PSORXED("UNITS",ENT))="" K PSORXED("NOUN",ENT),PSORXED("ODOSE",ENT) G DOS
"RTN","PSOBKDED",135,0)
 S:$P(DOSE("DD",PSODRUG("IEN")),"^",6)]"" (PSORXTE("UNITS",ENT),UNITS)=$O(^PS(50.607,"B",$P(DOSE("DD",PSODRUG("IEN")),"^",6),0)),UNITN=$P(DOSE("DD",PSODRUG("IEN")),"^",6)
"RTN","PSOBKDED",136,0)
 S:$P(DOSE("DD",PSODRUG("IEN")),"^",5) DUPD=DOSE/$P(DOSE("DD",PSODRUG("IEN")),"^",5),PSORXTE("DOSE ORDERED",ENT)=DUPD
"RTN","PSOBKDED",137,0)
DOS W " "_$S($E(DOSE,1)="."&($G(UNITN)'=""):"0",1:"")_DOSE W:$G(UNITN)'="" UNITN
"RTN","PSOBKDED",138,0)
 W ! K DIR,DIRUT S DIR(0)="Y",DIR("A")="You entered "_$S($E(DOSE,1)="."&($G(UNITN)'=""):"0",1:"")_DOSE_$S($G(UNITN)'="":UNITN,1:"")_" is this correct",DIR("B")="Yes"
"RTN","PSOBKDED",139,0)
 D ^DIR I 'Y D KX K DOSE,UNITS,PSORXTE,PSOINDT G ASK
"RTN","PSOBKDED",140,0)
 S PSORXED("DOSE",ENT)=DOSE
"RTN","PSOBKDED",141,0)
 S:$G(PSORXTE("DOSE ORDERED",ENT))]"" PSORXED("DOSE ORDERED",ENT)=PSORXTE("DOSE ORDERED",ENT)
"RTN","PSOBKDED",142,0)
 S:$G(PSORXTE("NOUN",ENT))]"" PSORXED("NOUN",ENT)=PSORXTE("NOUN",ENT)
"RTN","PSOBKDED",143,0)
 I $G(PSORX("EDIT"))']"" D  ;PSO*7.0*450
"RTN","PSOBKDED",144,0)
 .S:$G(PSORXTE("VERB",ENT))]"" PSORXED("VERB",ENT)=PSORXTE("VERB",ENT)
"RTN","PSOBKDED",145,0)
 S:$G(PSORXTE("UNITS",ENT))]"" PSORXED("UNITS",ENT)=PSORXTE("UNITS",ENT)
"RTN","PSOBKDED",146,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD"),$P($G(^PS(55,PSODFN,"LAN")),"^") D
"RTN","PSOBKDED",147,0)
 .K OTHDOS(ENT) D KX S DIR(0)="52.0113,9"
"RTN","PSOBKDED",148,0)
 .I '$G(OTHDOS(ENT)),$G(PSORXED("ODOSE",ENT))']"" D LAN^PSOORED5
"RTN","PSOBKDED",149,0)
 .I $G(PSORXED("ODOSE",ENT))]"" S DIR("B")=PSORXED("ODOSE",ENT) K:DIR("B")="" DIR("B")
"RTN","PSOBKDED",150,0)
 .K DTOUT,DUOUT,DIRUT,Y,X D ^DIR K DIR K:$G(X)="@"!($G(X)="") DIRUT I $D(DIRUT) Q
"RTN","PSOBKDED",151,0)
 .I X="@" S OTHDOS(ENT)=1 D KX K PSORXED("ODOSE",ENT) Q
"RTN","PSOBKDED",152,0)
 .S:X'="" PSORXED("ODOSE",ENT)=X
"RTN","PSOBKDED",153,0)
 Q
"RTN","PSOBKDED",154,0)
 ;
"RTN","PSOBKDED",155,0)
SCH D KX
"RTN","PSOBKDED",156,0)
 ;*282 Allow multi-word schedules
"RTN","PSOBKDED",157,0)
 S DIR("?")="^D SCHLP^PSOORED4",DIR("A")="Schedule: ",DIR(0)="FA^1:20^I X[""""""""!(X?.E1C.E)!($A(X)=45)!($L(X,"" "")>$S(X[""PRN"":4,1:3))!($L(X)>20)!($L(X)<1) K X"
"RTN","PSOBKDED",158,0)
 I '$D(PSOSCH),'$D(PSORXED("SCHEDULE",ENT)),$P(^PS(50.7,PSODRUG("OI"),0),"^",8)]"" S PSOSCH=$P(^PS(50.7,PSODRUG("OI"),0),"^",8)
"RTN","PSOBKDED",159,0)
 S DIR("B")=$S($D(PSOSCH)&('$D(PSORXED("SCHEDULE",ENT))):PSOSCH,$G(PSORXED("SCHEDULE",ENT))]"":PSORXED("SCHEDULE",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOBKDED",160,0)
 I $G(PSORXED("SCHEDULE",ENT))']"",$G(PSOREEDT) K DIR("B")
"RTN","PSOBKDED",161,0)
 D ^DIR
"RTN","PSOBKDED",162,0)
 Q
"RTN","PSOBKDED",163,0)
KX K X,Y
"RTN","PSOBKDED",164,0)
KV K DTOUT,DUOUT,DIR,DIRUT
"RTN","PSOBKDED",165,0)
 Q
"RTN","PSODDPR2")
0^3^B139372771
"RTN","PSODDPR2",1,0)
PSODDPR2 ;BIR/SAB - display enhanced order checks ;11 May 2010  9:06 AM
"RTN","PSODDPR2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,379,390,372,416,411,458,402**;DEC 1997;Build 8
"RTN","PSODDPR2",3,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPR2",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPR2",5,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSODDPR2",6,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSODDPR2",7,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789 
"RTN","PSODDPR2",8,0)
 K ^UTILITY($J),PSODRUG("BAD"),THER,THERO,^TMP($J,"PSODCOR"),PSOINTV,PSOVAG,PSODD,PSI,PSORDIT,DRGNM,PDODCNT
"RTN","PSODDPR2",9,0)
 I $O(^TMP($J,LIST,"OUT","EXCEPTIONS",""))]"" D EXC^PSODDPR5 G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",10,0)
 N COUNT,DRG,ON,CT,DRGI,PDRG,SEV,STX,INT,CLI,PSONULN,PSONULN1,LST,LSI,DGI,SER,SERS,DUPT,SV,PSOLINES,OLDDRG,PSOOLDD,PSOTSUB,PSODSEQ,ZST,ZHDR,ZSUB,ZZDGDGC,PSOCLNS
"RTN","PSODDPR2",11,0)
 N PSOSEVER,PSODDSEQ,ZMED,COUNT2
"RTN","PSODDPR2",12,0)
 S (ON,DRG,SV,LSI,DGI,SER,SERS,PSOOLDD,PSOSEVER)="",(ZZDGDGC,CT,COUNT)=0,$P(PSONULN,"-",79)="-",$P(PSONULN1,"=",79)="=",ZHDR=1
"RTN","PSODDPR2",13,0)
 D NSRT^PSODDPR5 K ^TMP("PSODGI",$J),^TMP("PSOSER",$J),^TMP("PSOSERS",$J),^TMP("PSODGS",$J),^TMP("PSOTDD",$J,1)
"RTN","PSODDPR2",14,0)
 S (ON,DRG,SV,DGI,SER,SERS,ZVA)="",(ZST,ZORS,CT,COUNT)=0 N ZZOC S ZZOC=0,PSODDSEQ=0 ; PSO*7*411 
"RTN","PSODDPR2",15,0)
 F  S SV=$O(ZZDGDG(SV)) Q:SV=""!$G(PSODLQT)  F  S ZST=$O(ZZDGDG(SV,ZST)) Q:'ZST!$G(PSODLQT)  F  S ZORS=$O(ZZDGDG(SV,ZST,ZORS)) Q:'ZORS!$G(PSODLQT)  D
"RTN","PSODDPR2",16,0)
 .F  S ZVA=$O(ZZDGDG(SV,ZST,ZORS,ZVA)) Q:ZVA=""!$G(PSODLQT)  F  S DRG=$O(ZZDGDG(SV,ZST,ZORS,ZVA,DRG)) Q:DRG=""!$G(PSODLQT)  S COUNT=COUNT+1 D DUP^PSODDPR8,BLD2^PSODGDGP
"RTN","PSODDPR2",17,0)
 K HZVA,ZVA,ZORS,ZZDGDG,PSOCLNS,COUNT,ON,DRG,SV,DGI,PSORX("INTERVENE"),DIR,CDDT D HD() G EXIT:$G(PSODLQT) ;PSO*7*411
"RTN","PSODDPR2",18,0)
 Q:$D(PSSDIUTL)
"RTN","PSODDPR2",19,0)
 I +$G(PSOINTV) D INT G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",20,0)
 I $G(PSORX("DFLG")) W:$G(COPY) !,$C(7),"RX DELETED",! S PSORX("DFLG")=1,POERR("DFLG")=1,VALMBCK="R" G EXIT  Q
"RTN","PSODDPR2",21,0)
 I '$D(^XUSEC("PSORPH",DUZ)) K PSORX("INTERVENE")
"RTN","PSODDPR2",22,0)
 ;
"RTN","PSODDPR2",23,0)
 I $G(PSORX("INTERVENE"))]"" D
"RTN","PSODDPR2",24,0)
 .K PSODAL("DA") D FULL^VALM1,^PSORXI S:'$G(POERR) VALMBCK="R" W !
"RTN","PSODDPR2",25,0)
 ;
"RTN","PSODDPR2",26,0)
 I $G(PSORX("DFLG")) G EXIT
"RTN","PSODDPR2",27,0)
 I $O(^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",""))]"" D  G EXIT:PSODLQT  I ($Y+5)>IOSL W @IOF
"RTN","PSODDPR2",28,0)
 .S NODDERR=1 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR
"RTN","PSODDPR2",29,0)
 .I ($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT Q
"RTN","PSODDPR2",30,0)
 .D HD() Q:$G(PSODLQT)  W !,"Drug Interaction Error(s):",! S CT=0,ON=""
"RTN","PSODDPR2",31,0)
 .F  S ON=$O(^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON)) Q:ON=""  F  S CT=$O(^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON,CT)) Q:'CT  D
"RTN","PSODDPR2",32,0)
 ..Q:$G(NODDERR)&($P(ON,";")'="Z")
"RTN","PSODDPR2",33,0)
 ..W ?5,$S($P(ON,";")="N":"",$P(ON,";")="R":"Remote Rx for ",$P(ON,";")="O":"Local Rx for ",1:"Prospective Rx for ")
"RTN","PSODDPR2",34,0)
 ..W " "_^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON,CT,"MSG"),!,"   "_^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON,CT,"TEXT"),!
"RTN","PSODDPR2",35,0)
 ..D HD() Q:$G(PSODLQT)
"RTN","PSODDPR2",36,0)
 ;therapy
"RTN","PSODDPR2",37,0)
THER I '$O(^TMP($J,LIST,"OUT","THERAPY",0)) G EXIT
"RTN","PSODDPR2",38,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$P(PSOPAR,"^",2),$G(PSOTECCK) G EXIT
"RTN","PSODDPR2",39,0)
 D NSRT1^PSODDPR5 K ZPSODCTH ;PSO*7*411
"RTN","PSODDPR2",40,0)
 N ON,DDTH,CLASS,QTHER,ZDRG,ZTHER K DUPT,THER,THERO,SUB,ZOT,ZCLASS,CDDT,ZPSODCTH I '$P(PSOPAR,"^",10) D NOCAN^PSODDPR7 G ERR ;PSO*7*411
"RTN","PSODDPR2",41,0)
 W @IOF,PSONULN1,! S (SUB,CT,LST,PSOZZ)=0 S (CDDT,THER)=1,THERO=0,QTHER=1 K RXDT ;PSO*7*411
"RTN","PSODDPR2",42,0)
 F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY",CT)) Q:'CT!$G(PSODLQT)  F  S SUB=$O(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB)) Q:'SUB!$G(PSODLQT)  S ON=$P(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB),"^") D
"RTN","PSODDPR2",43,0)
 .I $G(PSODCTH(ON)) Q
"RTN","PSODDPR2",44,0)
 .S RXREC=$P(ON,";",2)
"RTN","PSODDPR2",45,0)
 .I $P(ON,";")="Z" Q
"RTN","PSODDPR2",46,0)
 .I $P(ON,";")="N",$G(^TMP($J,"PSONVADD",RXREC,0)) Q
"RTN","PSODDPR2",47,0)
 .I $P(ON,";")="R",$G(^TMP($J,"PSORMDD",RXREC,0)) Q
"RTN","PSODDPR2",48,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR2",49,0)
 .I $P(ON,";")="P",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR2",50,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDD",$J,RXREC,0)) Q
"RTN","PSODDPR2",51,0)
 .S ZOT=$S($P(ON,";")["C":1,$P(ON,";")="O":2,$P(ON,";")="R":3,$P(ON,";")="P":4,1:5)
"RTN","PSODDPR2",52,0)
 .I $P(ON,";")="P" D  ;PSO*7*411
"RTN","PSODDPR2",53,0)
 ..I $G(ZPSODCTH($P(ON,";",2))) Q
"RTN","PSODDPR2",54,0)
 ..I '$P(^PS(52.41,$P(ON,";",2),0),"^",9) S ZDRG=$P(^PS(50.7,$P(^PS(52.41,$P(ON,";",2),0),"^",8),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR2",55,0)
 ..E  S ZDRG=$P(^PSDRUG($P(^PS(52.41,$P(ON,";",2),0),"^",9),0),"^")
"RTN","PSODDPR2",56,0)
 ..S ZPSODCTH(ON)=$P(ON,";",2)_";PS(52.41"
"RTN","PSODDPR2",57,0)
 .I $P(ON,";")="O" D
"RTN","PSODDPR2",58,0)
 ..I $G(ZPSODCTH($P(ON,";",2))) Q  ;PSO*7*411
"RTN","PSODDPR2",59,0)
 ..S ZDRG=$P(^PSDRUG($P(^PSRX($P(ON,";",2),0),"^",6),0),"^")
"RTN","PSODDPR2",60,0)
 .I $P(ON,";")="N" D
"RTN","PSODDPR2",61,0)
 ..I $G(ZPSODCTH($P(ON,";",2))) Q  ;PSO*7*411
"RTN","PSODDPR2",62,0)
 ..S DUPRX0=^PS(55,PSODFN,"NVA",$P(ON,";",2),0)
"RTN","PSODDPR2",63,0)
 ..S ZPSODCTH(ON)="N;"_$P(ON,";",2)
"RTN","PSODDPR2",64,0)
 ..I '$P(DUPRX0,"^",2) S ZDRG=$P(^PS(50.7,$P(DUPRX0,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^") Q
"RTN","PSODDPR2",65,0)
 ..S ZDRG=$P(^PSDRUG($P(DUPRX0,"^",2),0),"^")
"RTN","PSODDPR2",66,0)
 .I $P(ON,";")="R" D
"RTN","PSODDPR2",67,0)
 ..Q:'$D(^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2)))
"RTN","PSODDPR2",68,0)
 ..I $G(ZPSODCTH($P(ON,";",2))) Q  ;PSO*7*411
"RTN","PSODDPR2",69,0)
 ..S RXREC=^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2)),ZDRG=$P(RXREC,"^",3)
"RTN","PSODDPR2",70,0)
 ..S ZPSODCTH(ON)="R;"_$P(RXREC,"^",5)_";"_$P(RXREC,"^")_"^"_$P(RXREC,"^",3)_"^"_$P(RXREC,"^",2)
"RTN","PSODDPR2",71,0)
 .I $E($P(ON,";"))["C" D  ;PSO*7*411; PIECE 1 of ON can be C1 for IV file 55, C2 for UD file 55, C3 for IV file 53.1 or C4 for UD file 53.1
"RTN","PSODDPR2",72,0)
 ..S ZPSODCTH(ON)=1,RXREC=^TMP($J,LIST,"IN","PROFILE",ON),ZMED=$P(RXREC,U,3),ZDRG=$P(RXREC,U,4) Q:$D(ZTHER(ZOT_"^"_ZDRG_"^"_ON))  ; clinic order
"RTN","PSODDPR2",73,0)
 ..S ZPSODCTH(ON)=$S($P(ON,";")[1!$P(ON,";")[4:"V",1:"U")_";"_$P(ON,";",2)
"RTN","PSODDPR2",74,0)
 .S:$D(ZDRG) ZTHER(ZOT_"^"_ZDRG_"^"_ON,SUB)=ON K ZDRG
"RTN","PSODDPR2",75,0)
THER2 ;
"RTN","PSODDPR2",76,0)
 G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",77,0)
 N PSOTHND1,PSOTHND2,PSOTHND3 S PSOTHND2=1,(PSOTHND1,PSOTHND3)=0
"RTN","PSODDPR2",78,0)
 I $O(ZTHER(""))]"" D
"RTN","PSODDPR2",79,0)
 .S (PSODUPF,PSODUPC,PSODUPC1,PSOTSUB)="" F  S PSODUPF=$O(ZTHER(PSODUPF)) Q:PSODUPF=""  F  S PSOTSUB=$O(ZTHER(PSODUPF,PSOTSUB)) Q:PSOTSUB=""  S PSODUPC1=PSODUPC1+1
"RTN","PSODDPR2",80,0)
 .;get line counts for each duplicate therapy by setting PSODUPF=1 and calling DUPCL to execute therapy code without actually displaying info. ; no breaks in the middle of displaying individual dup therapies.
"RTN","PSODDPR2",81,0)
 .S PSODUPF=1,PSODUPC=0,PSODUPC("CLASS")="" D DUPCL S PSODUPF=0
"RTN","PSODDPR2",82,0)
 .;set PSODUPF=0 then call DUPCL to actually print the duplicate therapies.
"RTN","PSODDPR2",83,0)
 .D DUPCL K DDTH,PSODUPC,PSODUPF,PSODUPC1,PSODUPC2
"RTN","PSODDPR2",84,0)
 G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",85,0)
 K PSODCTH,RXDT,PSOZZ
"RTN","PSODDPR2",86,0)
 I $P(PSOPAR,"^",10),$O(^TMP($J,"PSODCOR",0)),'$G(PSODGCK) D DCOR^PSODDPR3 K ^TMP($J,"PSODCOR") S PSOTHND1=1 D HD() G EXIT:$G(PSODLQT) ;W !,PSONULN1,!
"RTN","PSODDPR2",87,0)
 E  D HD() ;I $D(^XUSEC("PSORPH",DUZ)) S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR W @IOF I '$G(PSODUPF),Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR2",88,0)
 I 'PSOTHND1,'$G(PSODLQT),$D(^XUSEC("PSORPH",DUZ)) S PSOTHND3=1 D RTC
"RTN","PSODDPR2",89,0)
 I PSOTHND3>1,'$G(PSODLQT),$D(^XUSEC("PSORPH",DUZ)) D RTC
"RTN","PSODDPR2",90,0)
ERR I $O(^TMP($J,LIST,"OUT","THERAPY","ERROR",""))]"" D  S NODTERR=1 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR
"RTN","PSODDPR2",91,0)
 .D HD() Q:$G(PSODLQT)  W !,"Drug Therapy Error(s):",! S CT=0,ON=""
"RTN","PSODDPR2",92,0)
 .F  S ON=$O(^TMP($J,LIST,"OUT","THERAPY","ERROR",ON)) Q:ON=""!$G(PSODLQT)  F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY","ERROR",ON,CT)) Q:'CT!$G(PSODLQT)  D
"RTN","PSODDPR2",93,0)
 ..Q:$G(NODTERR)&($P(ON,";")'="Z")!$G(PSODLQT)
"RTN","PSODDPR2",94,0)
 ..D HD() Q:$G(PSODLQT)  W ?5,$S($P(ON,";")="P":"Pending Order: ",$P(ON,";")="N":"Non-VA Med Order: ",$P(ON,";")="R":"Remote Rx: ",$P(ON,";")="O":"Rx: ",1:"Prospective Rx: ")
"RTN","PSODDPR2",95,0)
 ..D HD() Q:$G(PSODLQT)  W " "_^TMP($J,LIST,"OUT","THERAPY","ERROR",ON,CT,"MSG"),!,"   "_^TMP($J,LIST,"OUT","THERAPY","ERROR",ON,CT,"TEXT"),!
"RTN","PSODDPR2",96,0)
 K ZON,ZPSOCTH,ZDDT
"RTN","PSODDPR2",97,0)
 I $O(^TMP($J,LIST,"OUT","THERAPY","ERROR",""))]"" S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT Q:$G(PSODLQT)
"RTN","PSODDPR2",98,0)
 D HD()
"RTN","PSODDPR2",99,0)
EXIT ;
"RTN","PSODDPR2",100,0)
 D ^PSOBUILD
"RTN","PSODDPR2",101,0)
 K DSPL,CAN,DA,DIR,DNM,DUPRX0,ISSD,J,LSTFL,MSG,PHYS,PSOCLC,PSONULN,REA,RFLS,RX0,RX2,RXN,RXREC,ST,Y,ZZ,ACT,PSOCLOZ,PSOLR,PSOLDT,PSOCD,SIG,ZCT,ZZCT,ZZZCT,CDDT ;PSO*7*411
"RTN","PSODDPR2",102,0)
 K IT,LST,THER,THERO,^UTILITY($J),DGI,SER,SEV,SERS,BSIG,I,NODDERR,NODTERR,PDRG,DRGI,STATUS,^UTILITY($J,"W"),X,ZX,DIWL,DIWR,DIWF,THER,THERO,PSOINTV,ZTHER,PSOVORD,PSODCTH,ZZDGDG,ZZDGDG2,ZZHDR
"RTN","PSODDPR2",103,0)
 Q
"RTN","PSODDPR2",104,0)
 ;
"RTN","PSODDPR2",105,0)
RX D HD() Q:$G(PSODLQT)  W ! S RXREC=$P(ON,";",2)
"RTN","PSODDPR2",106,0)
 S DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),STATUS=+$G(^PSRX(RXREC,"STA"))
"RTN","PSODDPR2",107,0)
 S RXRECLOC=$G(RXREC)
"RTN","PSODDPR2",108,0)
 S J=RXREC D STAT^PSOFUNC K RX0,RX2
"RTN","PSODDPR2",109,0)
 I $P($G(^PS(53,+$P($G(PSORX("PATIENT STATUS")),"^"),0)),"^")["AUTH ABS"!($G(PSORX("PATIENT STATUS"))["AUTH ABS")&'$P(PSOPAR,"^",5) W !,"PATIENT ON AUTHORIZED ABSENCE!" K RXRECLOC Q
"RTN","PSODDPR2",110,0)
 I STATUS>10,STATUS'=16 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR W @IOF S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT,DIRUT,RXRECLOC Q
"RTN","PSODDPR2",111,0)
 I '$P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("DFLG")=1 K RXRECLOC Q
"RTN","PSODDPR2",112,0)
 I $P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("DFLG")=1 K RXRECLOC Q
"RTN","PSODDPR2",113,0)
 I STATUS=16 W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! K DUP,RXRECLOC S PSORX("DFLG")=1 Q
"RTN","PSODDPR2",114,0)
 D PSOL^PSSLOCK(RXRECLOC) I '$G(PSOMSG) D  K PSOMSG,DIR,DUP,RXRECLOC S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSODDPR2",115,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2),! Q
"RTN","PSODDPR2",116,0)
 .W !!,"Another person is editing Rx #"_$P($G(^PSRX(RXREC,0)),"^"),!
"RTN","PSODDPR2",117,0)
 K PSOMSG S DIR("A")=$S(STATUS=12:"Reinstate",1:"Discontinue")_" RX # "_$P(^PSRX(RXREC,0),"^"),DIR(0)="Y",DIR("?")="Enter Y to "_$S(STATUS=12:"reinstate",1:"discontinue")_" this RX."
"RTN","PSODDPR2",118,0)
 D ^DIR K DIR S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 Q:$G(PSODLQT)
"RTN","PSODDPR2",119,0)
 S DA=RXREC S ACT=$S($D(SPCANC):"Reinstated during Rx cancel.",1:$S(STATUS=12:"Reinstated",1:"Discontinued")_" while "_$S('$G(PSONV):"entering",1:"verifying")_" new RX")
"RTN","PSODDPR2",120,0)
 D CMOP^PSOUTL I $G(CMOP("S"))="L" W !,"A CMOP Rx cannot be discontinued during transmission!",! S Y=0 K CMOP
"RTN","PSODDPR2",121,0)
 I 'Y W $C(7)," -Prescription was not "_$S(STATUS=12:"reinstated",1:"discontinued")_"..." D  Q
"RTN","PSODDPR2",122,0)
 .S:'$D(PSOCLC) PSOCLC=DUZ S MSG=ACT,REA=$S(STATUS=12:"R",1:"C") S:$G(DUP) PSORX("DFLG")=1 K DUP
"RTN","PSODDPR2",123,0)
 .I $D(^TMP("PSORXDC",$J,RXREC,0)) K ^TMP("PSORXDC",$J,RXREC,0)
"RTN","PSODDPR2",124,0)
 S PSOCLC=DUZ,MSG=$S($G(MSG)]"":MSG,1:ACT_" During New RX "_$S('$G(PSONV):"Entry",1:"Verification")_" - Duplicate Rx"),REA=$S(STATUS=12:"R",1:"C")
"RTN","PSODDPR2",125,0)
 W !!,"THERAPEUTIC DUPLICATIONS will be discontinued after the acceptance of the new order.",!!
"RTN","PSODDPR2",126,0)
 S ^TMP("PSORXDC",$J,RXREC,0)="52^"_DA_"^"_MSG_"^"_REA_"^"_ACT_"^"_ST_"^"_DRG,PSONOOR="D"
"RTN","PSODDPR2",127,0)
 K RXRECLOC,DUP,CLS,PSONOOR,STATUS,ACT,PSONV,REA,SPCANC
"RTN","PSODDPR2",128,0)
 Q
"RTN","PSODDPR2",129,0)
 ;
"RTN","PSODDPR2",130,0)
DUPCL ;
"RTN","PSODDPR2",131,0)
 Q:$G(PSODLQT)
"RTN","PSODDPR2",132,0)
 S:$G(PSODUPF) PSODUPC=PSODUPC+1 ;W:'$G(PSODUPF) @IOF,PSONULN1,!
"RTN","PSODDPR2",133,0)
 I '$G(PSODUPF) W "*** THERAPEUTIC DUPLICATION(S) *** "_PSODRUG("NAME")_" with"
"RTN","PSODDPR2",134,0)
 S:$G(PSODUPF) PSODUPC=PSODUPC+1 N PSODUPCT,PSODUPC2,PSODUPCL
"RTN","PSODDPR2",135,0)
 S (PSODUPC2,PSODUPCT)=0 S:'$G(PSODUPF) PSODUPCT=2
"RTN","PSODDPR2",136,0)
 ;displays order and therapy
"RTN","PSODDPR2",137,0)
 K DDTH S (PSODUPCL,ZSUB,ZCT,PSODSEQ)=""
"RTN","PSODDPR2",138,0)
 F  S ZCT=$O(ZTHER(ZCT)) Q:ZCT=""!($G(PSODLQT))  F  S PSODSEQ=$O(ZTHER(ZCT,PSODSEQ)) Q:PSODSEQ=""!($G(PSODLQT))  S ON=ZTHER(ZCT,PSODSEQ) D
"RTN","PSODDPR2",139,0)
 .I '$G(PSODUPF) S PSOTHND3=PSOTHND3+1 I 'PSOTHND1,'$G(PSODLQT),$O(ZTHER(ZCT,PSODSEQ)),PSOTHND3>1 D RTC
"RTN","PSODDPR2",140,0)
 .S (PDODCNT,PSOTHND1)=0,PSODUPC2=PSODUPC2+1 I $G(PSODUPF) S PSODUPC(ZCT)=0
"RTN","PSODDPR2",141,0)
 .I PSODUPC2=PSODUPC2+1
"RTN","PSODDPR2",142,0)
 .I '$G(PSODUPF) D
"RTN","PSODDPR2",143,0)
 ..I PSODUPC2=PSODUPC1,(PSODUPCT+PSODUPC(ZCT)+PSODUPC("CLASS"))>22 D HD(15) Q:$G(PSODLQT)  S PSODUPCT=0
"RTN","PSODDPR2",144,0)
 ..I (PSODUPCT+PSODUPC(ZCT))>22 D HD(15) Q:$G(PSODLQT)  S PSODUPCT=0
"RTN","PSODDPR2",145,0)
 ..S PSODUPCT=PSODUPCT+PSODUPC(ZCT)
"RTN","PSODDPR2",146,0)
 .I $P(ON,";")="O" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! S THER=1 D DDRX^PSODDPR8 D
"RTN","PSODDPR2",147,0)
 ..Q:STATUS>5&(STATUS'=16)
"RTN","PSODDPR2",148,0)
 ..Q:$G(^TMP("PSORXDC",$J,RXREC,0))]""
"RTN","PSODDPR2",149,0)
 ..Q:$G(RXDT("O",RXREC))
"RTN","PSODDPR2",150,0)
 ..S RX0=^PSRX(RXREC,0),J=RXREC,RX2=^PSRX(RXREC,2) D STAT^PSOFUNC K RX0,RX2
"RTN","PSODDPR2",151,0)
 ..S PSOZZ=PSOZZ+1,^TMP($J,"PSODCOR",PSOZZ)="52"_"^"_RXREC_"^"_ST_"^"_DRGNM,RXDT("O",RXREC)=1
"RTN","PSODDPR2",152,0)
 .I $P(ON,";")="N" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! D ^PSODDPR3
"RTN","PSODDPR2",153,0)
 .I $P(ON,";")="P" D
"RTN","PSODDPR2",154,0)
 ..; PSO*7*411
"RTN","PSODDPR2",155,0)
 ..D HD(8) Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! S RXREC=$P(ON,";",2),THER=1 D PEND^PSODDPR8
"RTN","PSODDPR2",156,0)
 ..Q:$G(^TMP("PSORXDC",$J,RXREC,0))]""
"RTN","PSODDPR2",157,0)
 ..Q:$G(RXDT("P",RXREC))
"RTN","PSODDPR2",158,0)
 ..S PSOZZ=PSOZZ+1,DUPRX0=^PS(52.41,RXREC,0)
"RTN","PSODDPR2",159,0)
 ..S ^TMP($J,"PSODCOR",PSOZZ)="P"_"^"_RXREC_"^^"_$S($P(DUPRX0,"^",9):$P(^PSDRUG($P(DUPRX0,"^",9),0),"^"),1:$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^",2),0),"^"))
"RTN","PSODDPR2",160,0)
 ..S ^TMP($J,"PSODCOR",PSOZZ)=^TMP($J,"PSODCOR",PSOZZ)_"^"_$S('$P(DUPRX0,"^",9):$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^",2),0),"^"),1:$P(^PSDRUG($P(DUPRX0,"^",9),0),"^"))
"RTN","PSODDPR2",161,0)
 ..S RXDT("P",RXREC)=1
"RTN","PSODDPR2",162,0)
 .I $P(ON,";")="R" S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! D RDI^PSODDPR3 D HD() Q:$G(PSODLQT)
"RTN","PSODDPR2",163,0)
 .I $E($P(ON,";"))="C" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! D DUP^PSODDPR7  ; clinic order
"RTN","PSODDPR2",164,0)
 .I $O(ZTHER(ZCT,PSODSEQ))'="" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,PSONULN
"RTN","PSODDPR2",165,0)
 D CLASSES^PSODDPR3
"RTN","PSODDPR2",166,0)
 ;format therapy classes pso*7*411
"RTN","PSODDPR2",167,0)
 N X S (ZCT,ZZCT,ZZZCT)=0
"RTN","PSODDPR2",168,0)
 F  S ZZCT=$O(^TMP($J,LIST,"OUT","THERAPY",ZZCT)) Q:'ZZCT  S ZCT=0 F  S ZCT=$O(^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT)) Q:'ZCT  D
"RTN","PSODDPR2",169,0)
 .;S X=^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT,"CLASS")  ; ME2 - 1602256
"RTN","PSODDPR2",170,0)
 .S X=^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT,"CLASS")_$S($O(^TMP($J,LIST,"OUT","THERAPY",ZZCT))!($O(^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT))):", ",1:"")
"RTN","PSODDPR2",171,0)
 Q:$G(PSODLQT)!($D(^XUSEC("PSORPH",DUZ)))
"RTN","PSODDPR2",172,0)
 I '$G(PSODUPF),'$D(^XUSEC("PSORPH",DUZ)) D
"RTN","PSODDPR2",173,0)
 .S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR W @IOF
"RTN","PSODDPR2",174,0)
 .I '$G(PSODUPF),Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR2",175,0)
 .I '$G(PSODUPF),($Y+5)>IOSL W @IOF
"RTN","PSODDPR2",176,0)
 Q
"RTN","PSODDPR2",177,0)
INT ;
"RTN","PSODDPR2",178,0)
 Q:$D(PSSDIUTL)
"RTN","PSODDPR2",179,0)
 D INT^PSODDPR5
"RTN","PSODDPR2",180,0)
 Q
"RTN","PSODDPR2",181,0)
HD(PSOLINES,OVRRID) ;
"RTN","PSODDPR2",182,0)
 S:'$G(PSODLQT) PSODLQT=0  S:'$G(OVRRID) OVRRID=0 S:'$G(PSOLINES) PSOLINES=5
"RTN","PSODDPR2",183,0)
 I '$G(OVRRID),$G(PSODLQT)!(($Y+PSOLINES)'>IOSL) Q
"RTN","PSODDPR2",184,0)
 I $G(PSOTHND2) S PSOTHND1=1
"RTN","PSODDPR2",185,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODDPR2",186,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press return to continue" D ^DIR K DIR
"RTN","PSODDPR2",187,0)
 K PSOLINES,OVRRID
"RTN","PSODDPR2",188,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR2",189,0)
 W:'$G(PSODUPF) @IOF
"RTN","PSODDPR2",190,0)
 Q
"RTN","PSODDPR2",191,0)
 ;
"RTN","PSODDPR2",192,0)
DGSORT ;
"RTN","PSODDPR2",193,0)
 ;this sort is used in monograph and clinic effects display so that they are displayed once per VA generic drug
"RTN","PSODDPR2",194,0)
 S (SEV,TYP,PSOVAG,PSONAM)="" F  S SEV=$O(ZZDGDG3(SEV)) Q:SEV=""  F  S PSOVAG=$O(ZZDGDG3(SEV,PSOVAG)) Q:PSOVAG=""  D
"RTN","PSODDPR2",195,0)
 .S COUNT2=0 F  S PSONAM=$O(ZZDGDG3(SEV,PSOVAG,PSONAM)) Q:PSONAM=""  S COUNT2=COUNT2+1,ZZDGDG2(SEV,PSOVAG)=COUNT2
"RTN","PSODDPR2",196,0)
 K COUNT2,PSONAM
"RTN","PSODDPR2",197,0)
 Q
"RTN","PSODDPR2",198,0)
 ;
"RTN","PSODDPR2",199,0)
 ;
"RTN","PSODDPR2",200,0)
RTC ;Return to continue
"RTN","PSODDPR2",201,0)
 N DIR,X,Y,DTOUT,DUOUT,DIRUT,DIROUT S DIR(0)="EA",DIR("A")="Press Return to Continue: " D ^DIR K DIR W @IOF
"RTN","PSODDPR2",202,0)
 Q
"RTN","PSODEM")
0^15^B18875711
"RTN","PSODEM",1,0)
PSODEM ;BHAM ISC/SAB - PATIENT DEMOGRAPHICS ; 02/17/93 12:29
"RTN","PSODEM",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**5,19,233,258,326,390,411,402**;DEC 1997;Build 8
"RTN","PSODEM",3,0)
 ;External reference to ^GMRADPT supported by DBIA 10099
"RTN","PSODEM",4,0)
 ;External reference to ^DIC(31 supported by DBIA 658
"RTN","PSODEM",5,0)
 ;External reference to $$BSA^PSSDSAPI supported by DBIA 5425
"RTN","PSODEM",6,0)
 ;
"RTN","PSODEM",7,0)
GET S DFN=DA D 6^VADPT,PID^VADPT U IO W @IOF,!,VADM(1)
"RTN","PSODEM",8,0)
 I +VAPA(9) W !?5,"(TEMP ADDRESS from "_$P(VAPA(9),"^",2)_" till "_$S($P(VAPA(10),"^",2)]"":$P(VAPA(10),"^",2),1:"(no end date)")_")"
"RTN","PSODEM",9,0)
 W !,VAPA(1),?40,"DOB:   ",$S(+VADM(3):$P(VADM(3),"^",2),1:"UNKNOWN") W:VAPA(2)]"" !,VAPA(2) W:VAPA(3)]"" !,VAPA(3)
"RTN","PSODEM",10,0)
 W !,VAPA(4),?40,"PHONE: "_VAPA(8),!,$P(VAPA(5),"^",2)_"  "_$S(VAPA(11)]"":$P(VAPA(11),"^",2),1:VAPA(6)),?40,"ELIG:  "_$P(VAEL(1),"^",2) W:+VAEL(3) !?40,"SC%:   "_$P(VAEL(3),"^",2)
"RTN","PSODEM",11,0)
 I $D(^PS(55,DFN,0)) W:$P(^(0),"^",2) !,"CANNOT USE SAFETY CAPS." I +$P(^(0),"^",4) W ?40,"DIALYSIS PATIENT."
"RTN","PSODEM",12,0)
 I $G(^PS(55,DFN,1))]"" S X=^(1) W !!?5,"Pharmacy Narrative: " F I=1:1 Q:$P(X," ",I,99)=""  W:$X+$L($P(X," ",I))+$L(" ")>IOM ! W $P(X," ",I)," "
"RTN","PSODEM",13,0)
RE S (WT,HT)="",X="GMRVUTL" X ^%ZOSF("TEST") I $T D
"RTN","PSODEM",14,0)
 .F GMRVSTR="WT","HT" S VM=GMRVSTR D EN6^GMRVUTL S @VM=X,$P(@VM,"^")=$E($P(@VM,"^"),4,5)_"/"_$E($P(@VM,"^"),6,7)_"/"_($E($P(@VM,"^"),1,3)+1700)
"RTN","PSODEM",15,0)
 .S X=$P(WT,"^",8),Y=$J(X/2.2,0,2),$P(WT,"^",9)=Y,X=$P(HT,"^",8),Y=$J(2.54*X,0,2),$P(HT,"^",9)=Y
"RTN","PSODEM",16,0)
 Q:$G(POERR)
"RTN","PSODEM",17,0)
 W !!,"WEIGHT(Kg): " W:+$P(WT,"^",8) $P(WT,"^",9)_" ("_$P(WT,"^")_")" W ?41,"HEIGHT(cm): " W:$P(HT,"^",8) $P(HT,"^",9)_" ("_$P(HT,"^")_")" K VM,WT,HT
"RTN","PSODEM",18,0)
 ;
"RTN","PSODEM",19,0)
 ; Display CrCl/BSA - show serum creatinine if CrCl can't be calculated
"RTN","PSODEM",20,0)
CRCL S PSOBSA=$$BSA^PSSDSAPI(DFN),PSOBSA=$P(PSOBSA,"^",3),PSOBSA=$S(PSOBSA'>0:"_______",1:$J(PSOBSA,4,2))
"RTN","PSODEM",21,0)
 S RSLT=$$CRCL^PSOORUT2(DFN)
"RTN","PSODEM",22,0)
 ; RSLT -- DATE^CRCL^Serum Creatinine -- Ex.  11/25/11^68.7^1.1
"RTN","PSODEM",23,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)<.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_" (CREAT: Not Found)"
"RTN","PSODEM",24,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"  (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSODEM",25,0)
 I ($P($G(RSLT),"^",2)>0)&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"(est.)"_" (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSODEM",26,0)
 W !,ZDSPL,?40," BSA (m2): ",PSOBSA K PSOBSA,ZDSPL,RSLT
"RTN","PSODEM",27,0)
 ;
"RTN","PSODEM",28,0)
 S PSLC=0 G MA:$P($G(^DPT(DFN,.17)),"^",2)'="I"
"RTN","PSODEM",29,0)
 I '$D(VAEL(1)) D ELIG^VADPT W !!,"ELIGIBILITY: ",$P(VAEL(1),"^",2) W:+VAEL(3) ?$X+5,"SC%: "_$P(VAEL(3),"^",2) S PSLC=PSLC+2
"RTN","PSODEM",30,0)
MA K SC W !,"DISABILITIES: " S PSLC=PSLC+2
"RTN","PSODEM",31,0)
 F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  S I1=$S($D(^DPT(DFN,.372,I,0)):^(0),1:"") D:+I1
"RTN","PSODEM",32,0)
 .S PSDIS=$S($P($G(^DIC(31,+I1,0)),"^")]""&($P($G(^(0)),"^",4)']""):$P(^(0),"^"),$P($G(^DIC(31,+I1,0)),"^",4)]"":$P(^(0),"^",4),1:""),PSCNT=$P(I1,"^",2)
"RTN","PSODEM",33,0)
 .X:($X+$L(PSDIS)+7)>(IOM-8) "W !?14 S PSLC=PSLC+1" W PSDIS,"-",PSCNT,"% (",$S($P(I1,"^",3):"SC",1:"NSC"),"), "
"RTN","PSODEM",34,0)
 .I $E(IOST)="C",$Y+4>IOSL,$D(PSTYPE) K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DTOUT W @IOF,?13
"RTN","PSODEM",35,0)
 X "N X S X=""GMRADPT"" X ^%ZOSF(""TEST"") Q" I $T D:'$D(PSOPTPST) GMRA
"RTN","PSODEM",36,0)
Q K SC,I1,VAROOT,Y,AL,I,X,Y,PSCNT,PSLC,PSDIS D:$G(PSTYPE)']"" KVA^VADPT Q
"RTN","PSODEM",37,0)
GMRA K ^TMP($J,"AL") S GMRA="0^0^111" D ^GMRADPT I GMRAL D
"RTN","PSODEM",38,0)
 .F DR=0:0 S DR=$O(GMRAL(DR)) Q:'DR  S ^TMP($J,"AL",$S('$P(GMRAL(DR),"^",5):1,1:2),$P(GMRAL(DR),"^",7),$P(GMRAL(DR),"^",2))=""
"RTN","PSODEM",39,0)
 .W !!,"ALLERGIES: " S (DR,TY)="" F I=0:0 S TY=$O(^TMP($J,"AL",1,TY)) Q:TY=""  F D=0:0 S DR=$O(^TMP($J,"AL",1,TY,DR)) Q:DR=""  W:$X+$L(DR)+$L(", ")>IOM !?11 W DR_", " D
"RTN","PSODEM",40,0)
 ..I $E(IOST)="C",$Y+4>IOSL,$D(PSTYPE) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DTOUT W @IOF,?18
"RTN","PSODEM",41,0)
 .W !!,"ADVERSE REACTIONS: " S (DR,TY)="" F I=0:0 S TY=$O(^TMP($J,"AL",2,TY)) Q:TY=""  F D=0:0 S DR=$O(^TMP($J,"AL",2,TY,DR)) Q:DR=""  W:$X+$L(DR)+$L(", ")>IOM !?19 W DR_", " D
"RTN","PSODEM",42,0)
 ..I $E(IOST)="C",$Y+4>IOSL,$D(PSTYPE) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DTOUT W @IOF,?18
"RTN","PSODEM",43,0)
 I $G(GMRAL)']"" F AD="ALLERGIES:","ADVERSE REACTIONS:" W !!,AD I $G(PSOFROM)="" F ADL=1:1:IOM-($L(AD)+5) W "_"
"RTN","PSODEM",44,0)
 I GMRAL=0 W !!,"ALLERGIES: NKA",!!,"ADVERSE REACTIONS:"
"RTN","PSODEM",45,0)
 W ! K TY,D,I,GMRA,GMRAL,DR,AD,ADL,^TMP($J,"AL") Q
"RTN","PSODOSCL")
0^17^B29898575
"RTN","PSODOSCL",1,0)
PSODOSCL ;BIR/RTR-Dose Call Utility Routine ;10/07/08
"RTN","PSODOSCL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,402**;DEC 1997;Build 8
"RTN","PSODOSCL",3,0)
 ;
"RTN","PSODOSCL",4,0)
 ;Reference to ^PSDRUG( supported by DBIA 221
"RTN","PSODOSCL",5,0)
 ;Reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODOSCL",6,0)
 ;External reference to $$FRQ^PSSDSAPI supported by DBIA 5425
"RTN","PSODOSCL",7,0)
 ;External reference to $$MRT^PSSDSAPI supported by DBIA 5425
"RTN","PSODOSCL",8,0)
 ;External reference to $$UNIT^PSSDSAPI supported by DBIA 5425
"RTN","PSODOSCL",9,0)
 ;External reference to $$DOSE^PSSDSAPD supported by DBIA 5426
"RTN","PSODOSCL",10,0)
 ;PSODARTX = Literal Subscript
"RTN","PSODOSCL",11,0)
 ;PSODAR = Internal Prescription Number from Prescription (#52) File
"RTN","PSODOSCL",12,0)
 ;
"RTN","PSODOSCL",13,0)
RX(PSODARTX,PSODARX) ;
"RTN","PSODOSCL",14,0)
 ;use Psodar
"RTN","PSODOSCL",15,0)
 N PSODAR1,PSODAR2,PSODARZ,PSODARL,PSODARCT,PSODAR6
"RTN","PSODOSCL",16,0)
 S PSODARZ=$G(^PSRX(PSODARX,0))
"RTN","PSODOSCL",17,0)
 I '$P(PSODARZ,"^",2)!('$P(PSODARZ,"^",6)) Q
"RTN","PSODOSCL",18,0)
 S PSODAR1("PACKAGE")="O"
"RTN","PSODOSCL",19,0)
 S PSODAR1("OI")=$P($G(^PSDRUG($P(PSODARZ,"^",6),2)),"^")
"RTN","PSODOSCL",20,0)
 S PSODARCT=0
"RTN","PSODOSCL",21,0)
 F PSODARL=0:0 S PSODARL=$O(^PSRX(PSODARX,6,PSODARL)) Q:'PSODARL  D
"RTN","PSODOSCL",22,0)
 .S PSODAR1(PSODARL,"DRUG_IEN")=$P(PSODARZ,"^",6)
"RTN","PSODOSCL",23,0)
 .S PSODAR1(PSODARL,"DRUG_NM")=$P($G(^PSDRUG($P(PSODARZ,"^",6),0)),"^")
"RTN","PSODOSCL",24,0)
 .I PSODAR1(PSODARL,"DRUG_NM")="",PSODAR1("OI") S PSODAR1(PSODARL,"DRUG_NM")=$P($G(^PS(50.7,PSODAR1("OI"),0)),"^")
"RTN","PSODOSCL",25,0)
 .S PSODAR1(PSODARL,"RX_NUM")="O;"_PSODARX_";PROSPECTIVE;"_PSODARL
"RTN","PSODOSCL",26,0)
 .S PSODAR6=$G(^PSRX(PSODARX,6,PSODARL,0))
"RTN","PSODOSCL",27,0)
 .S PSODAR2(PSODARL,"CONJ")=$P(PSODAR6,"^",6)
"RTN","PSODOSCL",28,0)
 .S PSODAR2(PSODARL,"DRATE")=$P(PSODAR6,"^",5)
"RTN","PSODOSCL",29,0)
 .D DOSE
"RTN","PSODOSCL",30,0)
 .I $P(PSODAR6,"^",8)'="" S PSODAR2(PSODARL,"SCHEDULE")=$P(PSODAR6,"^",8)
"RTN","PSODOSCL",31,0)
 .;S PSODAR1(PSODARL,"DURATION")=1
"RTN","PSODOSCL",32,0)
 .;S PSODAR1(PSODARL,"DURATION_RT")="DAY"
"RTN","PSODOSCL",33,0)
 .I $P(PSODAR6,"^",7) S PSODAR1(PSODARL,"ROUTE")=$P($$MRT^PSSDSAPI($P(PSODAR6,"^",7)),"^",2)
"RTN","PSODOSCL",34,0)
 .S PSODARCT=1
"RTN","PSODOSCL",35,0)
 I 'PSODARCT Q
"RTN","PSODOSCL",36,0)
 S PSODAR2("CONTEXT")="OP-UD"  ;; cmf - Mocha 2.1/PSO*402 change
"RTN","PSODOSCL",37,0)
 D DOSE^PSSDSAPD(.PSODARTX,$P(PSODARZ,"^",2),.PSODAR2,.PSODAR1)
"RTN","PSODOSCL",38,0)
 Q
"RTN","PSODOSCL",39,0)
 ;
"RTN","PSODOSCL",40,0)
 ;
"RTN","PSODOSCL",41,0)
DOSE ;
"RTN","PSODOSCL",42,0)
 N PSODARUN,PSODARUX,PSODARFL
"RTN","PSODOSCL",43,0)
 S PSODARFL=0
"RTN","PSODOSCL",44,0)
 I $P(PSODAR6,"^"),$P(PSODAR6,"^",2),$P(PSODAR6,"^",3) D
"RTN","PSODOSCL",45,0)
 .S PSODARR(PSODARL,"DOSE_AMT")=$P(PSODAR6,"^")
"RTN","PSODOSCL",46,0)
 .S PSODARUN=$P($G(^PS(50.607,+$P(PSODAR6,"^",3),0)),"^")
"RTN","PSODOSCL",47,0)
 .Q:$G(PSODARUN)=""
"RTN","PSODOSCL",48,0)
 .S PSODARUX=$$UNIT^PSSDSAPI(PSODARUN)
"RTN","PSODOSCL",49,0)
 .Q:$G(PSODARUX)=""
"RTN","PSODOSCL",50,0)
 .S PSODAR1(PSODARL,"DOSE_AMT")=$P(PSODAR6,"^")
"RTN","PSODOSCL",51,0)
 .S PSODAR1(PSODARL,"DOSE_UNIT")=PSODARUX
"RTN","PSODOSCL",52,0)
 .S PSODARFL=1
"RTN","PSODOSCL",53,0)
 Q:PSODARFL
"RTN","PSODOSCL",54,0)
 S PSODAR2(PSODARL,"DO")=$P(PSODAR6,"^")
"RTN","PSODOSCL",55,0)
 Q
"RTN","PSODOSCL",56,0)
 ;
"RTN","PSODOSCL",57,0)
PEN(PSOSARTX,PSOSARX) ;Pending Order
"RTN","PSODOSCL",58,0)
 ;Use PSOSAR
"RTN","PSODOSCL",59,0)
 ;This is currently not being called, if ever called, DRUG_NM and OI and PACKAGE
"RTN","PSODOSCL",60,0)
 N PSOSAR1,PSOSAR2,PSOSARZ,PSOSARL,PSOSARCT,PSOSAR6,PSOSAR7
"RTN","PSODOSCL",61,0)
 S PSOSARZ=$G(^PS(52.41,PSOSARX,0))
"RTN","PSODOSCL",62,0)
 I '$P(PSOSARZ,"^",2)!('$P(PSOSARZ,"^",9)) Q
"RTN","PSODOSCL",63,0)
 S PSOSARCT=0
"RTN","PSODOSCL",64,0)
 F PSOSARL=0:0 S PSOSARL=$O(^PS(52.41,PSOSARX,1,PSOSARL))  Q:'PSOSARL!(PSOSARCT)  D
"RTN","PSODOSCL",65,0)
 .S PSOSAR1(PSOSARL,"RX_NUM")=PSOSARX
"RTN","PSODOSCL",66,0)
 .S PSOSAR1(PSOSARL,"DRUG_IEN")=$P(PSOSARZ,"^",9)
"RTN","PSODOSCL",67,0)
 .S PSOSAR6=$G(^PS(52.41,PSOSARX,1,PSOSARL,1))
"RTN","PSODOSCL",68,0)
 .S PSOSAR7=$G(^PS(52.41,PSOSARX,1,PSOSARL,2))
"RTN","PSODOSCL",69,0)
 .D PDOSE
"RTN","PSODOSCL",70,0)
 .I $P(PSOSAR6,"^")'="" S PSOSAR1(PSOSARL,"FREQ")=$$FRQ^PSSDSAPI($P(PSOSAR6,"^"),,"O")
"RTN","PSODOSCL",71,0)
 .S PSOSAR1(PSOSARL,"DURATION")=1
"RTN","PSODOSCL",72,0)
 .S PSOSAR1(PSOSARL,"DURATION_RT")="DAY"
"RTN","PSODOSCL",73,0)
 .I $P(PSOSAR6,"^",8) S PSOSAR1(PSOSARL,"ROUTE")=$P($$MRT^PSSDSAPI($P(PSOSAR6,"^",8)),"^",2)
"RTN","PSODOSCL",74,0)
 .S PSOSARCT=1
"RTN","PSODOSCL",75,0)
 I 'PSOSARCT Q
"RTN","PSODOSCL",76,0)
 S PSOSAR2("CONTEXT")="OP-UD"  ;; cmf - Mocha 2.1/PSO*402 change
"RTN","PSODOSCL",77,0)
 D DOSE^PSSDSAPD(PSOSARTX,$P(PSOSARZ,"^",2),.PSOSAR2,.PSOSAR1)
"RTN","PSODOSCL",78,0)
 Q
"RTN","PSODOSCL",79,0)
 ;
"RTN","PSODOSCL",80,0)
 ;
"RTN","PSODOSCL",81,0)
PDOSE ;
"RTN","PSODOSCL",82,0)
 N PSOSARUN,PSOSARUX,PSOSARFL
"RTN","PSODOSCL",83,0)
 S PSOSARFL=0
"RTN","PSODOSCL",84,0)
 I $P(PSOSAR7,"^"),$P(PSOSAR7,"^",2),$P(PSOSAR6,"^",9) D
"RTN","PSODOSCL",85,0)
 .S PSOSARR(PSOSARL,"DOSE_AMT")=$P(PSOSAR7,"^")
"RTN","PSODOSCL",86,0)
 .S PSOSARUN=$P($G(^PS(50.607,+$P(PSOSAR6,"^",9),0)),"^")
"RTN","PSODOSCL",87,0)
 .Q:$G(PSOSARUN)=""
"RTN","PSODOSCL",88,0)
 .S PSOSARUX=$$UNIT^PSSDSAPI(PSOSARUN)
"RTN","PSODOSCL",89,0)
 .Q:$G(PSOSARUX)=""
"RTN","PSODOSCL",90,0)
 .S PSOSAR1(PSOSARL,"DOSE_AMT")=$P(PSOSAR7,"^")
"RTN","PSODOSCL",91,0)
 .S PSOSAR1(PSOSARL,"DOSE_UNIT")=PSOSARUX
"RTN","PSODOSCL",92,0)
 .S PSOSARFL=1
"RTN","PSODOSCL",93,0)
 Q:PSOSARFL
"RTN","PSODOSCL",94,0)
 S PSOSAR2(PSOSARL,"DO")=$P(PSOSAR7,"^")
"RTN","PSODOSCL",95,0)
 Q
"RTN","PSODOSCL",96,0)
 ;
"RTN","PSODOSCL",97,0)
 ;
"RTN","PSODOSCL",98,0)
FIN(PSOXARTX,PSOXARX,PSOXARY) ;
"RTN","PSODOSCL",99,0)
 ;Set up variables and make Dose Call
"RTN","PSODOSCL",100,0)
 ;Assumes PSODFN is defined
"RTN","PSODOSCL",101,0)
 ;Don't set arrays that are passed in
"RTN","PSODOSCL",102,0)
 ;use PSOXAR
"RTN","PSODOSCL",103,0)
 N PSOXAR1,PSOXAR2,PSOXARL1,PSOXARL2
"RTN","PSODOSCL",104,0)
 I '$G(PSODFN)!('$G(PSOXARY("IEN"))) Q
"RTN","PSODOSCL",105,0)
 S PSOXAR1("PACKAGE")="O"
"RTN","PSODOSCL",106,0)
 S PSOXAR1("OI")=$P($G(^PSDRUG(PSOXARY("IEN"),2)),"^")
"RTN","PSODOSCL",107,0)
 F PSOXARL1=0:0 S PSOXARL1=$O(PSOXARX("DOSE",PSOXARL1)) Q:'PSOXARL1  D
"RTN","PSODOSCL",108,0)
 .S PSOXAR1(PSOXARL1,"RX_NUM")="O;1;PROSPECTIVE;"_PSOXARL1
"RTN","PSODOSCL",109,0)
 .S PSOXAR1(PSOXARL1,"DRUG_IEN")=PSOXARY("IEN")
"RTN","PSODOSCL",110,0)
 .S PSOXAR1(PSOXARL1,"DRUG_NM")=$P($G(^PSDRUG(PSOXARY("IEN"),0)),"^")
"RTN","PSODOSCL",111,0)
 .I PSOXAR1(PSOXARL1,"DRUG_NM")="",PSOXAR1("OI") S PSOXAR1(PSOXARL1,"DRUG_NM")=$P($G(^PS(50.7,PSOXAR1("OI"),0)),"^")
"RTN","PSODOSCL",112,0)
 .S PSOXAR2(PSOXARL1,"CONJ")=$G(PSOXARX("CONJUNCTION",PSOXARL1))
"RTN","PSODOSCL",113,0)
 .S PSOXAR2(PSOXARL1,"DRATE")=$G(PSOXARX("DURATION",PSOXARL1))
"RTN","PSODOSCL",114,0)
 .D FDOSE
"RTN","PSODOSCL",115,0)
 .I $G(PSOXARX("SCHEDULE",PSOXARL1))'="" S PSOXAR2(PSOXARL1,"SCHEDULE")=PSOXARX("SCHEDULE",PSOXARL1)
"RTN","PSODOSCL",116,0)
 .;S PSOXAR1(PSOXARL1,"DURATION")=1
"RTN","PSODOSCL",117,0)
 .;S PSOXAR1(PSOXARL1,"DURATION_RT")="DAY"
"RTN","PSODOSCL",118,0)
 .I $G(PSOXARX("ROUTE",PSOXARL1)) S PSOXAR1(PSOXARL1,"ROUTE")=$P($$MRT^PSSDSAPI(PSOXARX("ROUTE",PSOXARL1)),"^",2)
"RTN","PSODOSCL",119,0)
 S PSOXAR2("CONTEXT")="OP-UD"  ;; cmf - Mocha 2.1/PSO*402 change
"RTN","PSODOSCL",120,0)
 D DOSE^PSSDSAPD(.PSOXARTX,PSODFN,.PSOXAR2,.PSOXAR1)
"RTN","PSODOSCL",121,0)
 Q
"RTN","PSODOSCL",122,0)
 ;
"RTN","PSODOSCL",123,0)
FDOSE ;
"RTN","PSODOSCL",124,0)
 N PSOXARUN,PSOXARUX,PSOXARFL
"RTN","PSODOSCL",125,0)
 S PSOXARFL=0
"RTN","PSODOSCL",126,0)
 I $G(PSOXARX("DOSE",PSOXARL1)),$G(PSOXARX("UNITS",PSOXARL1)),$G(PSOXARX("DOSE ORDERED",PSOXARL1)) D
"RTN","PSODOSCL",127,0)
 .S PSOXARUN=$P($G(^PS(50.607,+$G(PSOXARX("UNITS",PSOXARL1)),0)),"^")
"RTN","PSODOSCL",128,0)
 .Q:PSOXARUN=""
"RTN","PSODOSCL",129,0)
 .S PSOXARUX=$$UNIT^PSSDSAPI(PSOXARUN)
"RTN","PSODOSCL",130,0)
 .Q:$G(PSOXARUX)=""
"RTN","PSODOSCL",131,0)
 .S PSOXAR1(PSOXARL1,"DOSE_AMT")=PSOXARX("DOSE",PSOXARL1)
"RTN","PSODOSCL",132,0)
 .S PSOXAR1(PSOXARL1,"DOSE_UNIT")=PSOXARUX
"RTN","PSODOSCL",133,0)
 .S PSOXARFL=1
"RTN","PSODOSCL",134,0)
 Q:PSOXARFL
"RTN","PSODOSCL",135,0)
 S PSOXAR2(PSOXARL1,"DO")=$G(PSOXARX("DOSE",PSOXARL1))
"RTN","PSODOSCL",136,0)
 Q
"RTN","PSODOSU2")
0^4^B142830151
"RTN","PSODOSU2",1,0)
PSODOSU2 ;BIR/RTR - Dose Check Utility routine continued ;11/18/08
"RTN","PSODOSU2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,372,436,402**;DEC 1997;Build 8
"RTN","PSODOSU2",3,0)
 ;
"RTN","PSODOSU2",4,0)
 ;Called from PSODOSUT.  The variable PSODTYPE is expected to be defined.
"RTN","PSODOSU2",5,0)
 ; PSODTYPE values can be N for dosing for new order, copy, and renews, E for edited and display of individual complex doses, and C for complex orders
"RTN","PSODOSU2",6,0)
 ;
"RTN","PSODOSU2",7,0)
EN ;new order, copy, renew, and verify orders
"RTN","PSODOSU2",8,0)
 N PSODLERW,PSODLERL,PSODLERS,PSODLERH,PSOCPXRR,PSODLWW,PSODOSER,PSONFRNF,PSOWMSG,PSODLQTC,PSOOFL
"RTN","PSODOSU2",9,0)
 S (PSODLERF,PSODSEQ,PSODLWW,PSOOFL)=""
"RTN","PSODOSU2",10,0)
 F  S PSODSEQ=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ)) Q:PSODSEQ=""!($G(PSORX("DFLG")))!($G(PSODLQTC))  S PSODLNN1=""  D  D HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",11,0)
 .S:PSODTYPE'="N" PSODLQT=0 S PSOLASTS=PSODSEQ
"RTN","PSODOSU2",12,0)
 .I PSODTYPE="C" K PSOCPXRR
"RTN","PSODOSU2",13,0)
 .F  S PSODLNN1=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) Q:PSODLNN1=""!($G(PSORX("DFLG")))!($G(PSODLQTC))  D
"RTN","PSODOSU2",14,0)
 ..S:PSODTYPE'="E" PSODLECT=0
"RTN","PSODOSU2",15,0)
 ..I PSODTYPE="E" Q:$P(PSODLNN1,";",4)'=PSODLXNT
"RTN","PSODOSU2",16,0)
 ..D ERROR Q:$G(PSODLQTC)
"RTN","PSODOSU2",17,0)
 ..D EXCEPT Q:$G(PSODLQTC)
"RTN","PSODOSU2",18,0)
 ..D MESSAGE Q:$G(PSODLQTC)
"RTN","PSODOSU2",19,0)
 .K PSODLWW
"RTN","PSODOSU2",20,0)
 Q
"RTN","PSODOSU2",21,0)
 ;
"RTN","PSODOSU2",22,0)
ERROR ;format and write dosing error
"RTN","PSODOSU2",23,0)
 I PSODTYPE'="E" S PSODLECT=0
"RTN","PSODOSU2",24,0)
 F PSODLERA=0:0 S PSODLERA=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"ERROR",PSODLERA)) Q:'PSODLERA!($G(PSORX("DFLG")))  D
"RTN","PSODOSU2",25,0)
 .S:PSODTYPE'="E" PSODLECT=PSODLECT+1
"RTN","PSODOSU2",26,0)
 .S:PSODTYPE'="N" PSODLQT=0
"RTN","PSODOSU2",27,0)
 .F PSODLERX="MSG","TEXT","TRAIL" S PSODLERB=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"ERROR",PSODLERA,PSODLERX)) D  K ^UTILITY($J,"W")
"RTN","PSODOSU2",28,0)
 ..S PSODLERZ=0 Q:PSODLERB=""
"RTN","PSODOSU2",29,0)
 ..I PSODLERX="TRAIL" S PSOTRAIL=1
"RTN","PSODOSU2",30,0)
 ..I PSODTYPE="C"&(PSOCPXB>3) D ERRCOM Q
"RTN","PSODOSU2",31,0)
 ..I PSODTYPE="E" D ERREDIT Q
"RTN","PSODOSU2",32,0)
 ..I PSODTYPE="N"&(PSOCPXB>3) D ERRNEW Q
"RTN","PSODOSU2",33,0)
 ..Q:PSODTYPE="C"&(PSOCPXB<4)
"RTN","PSODOSU2",34,0)
 ..D ERRNEW
"RTN","PSODOSU2",35,0)
 W:$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE","3_GENERAL"))&'PSOTRAIL ! S PSOTRAIL=0
"RTN","PSODOSU2",36,0)
 Q
"RTN","PSODOSU2",37,0)
 ;
"RTN","PSODOSU2",38,0)
ERRCOM ;write dosing errors for complex dose summary after accept of an order
"RTN","PSODOSU2",39,0)
 I PSOCPXC D HD Q:$G(PSODLQTC)  I PSODLERF,PSODLERX="MSG" W:'PSODLQT ! D HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",40,0)
 I 'PSODLERF,PSOCPXB<4 W:'PSODLQT&(PSOCPXC) !
"RTN","PSODOSU2",41,0)
 S PSODLERF=1 D:PSOCPXC HD I PSODLERZ W:'PSODLQT&(PSOCPXC) !
"RTN","PSODOSU2",42,0)
 D:PSOCPXC
"RTN","PSODOSU2",43,0)
 .D HD Q:$G(PSODLQTC)  W:'PSODLQT&(PSODLECT>1) !
"RTN","PSODOSU2",44,0)
 .N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF
"RTN","PSODOSU2",45,0)
 .D:PSOCPXC HD D:'PSOCPXF&(PSOCPXC) 
"RTN","PSODOSU2",46,0)
 ..Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",47,0)
 .D:PSOCPXC HD S PSOCPXG=$P(PSODLNN1,";",4) I PSOCPXC&('$G(PSOCPXRR(PSOCPXG))) D PSOORI,SUB^PSODOSUT W:'PSODLQT&('PSODLERZ) !
"RTN","PSODOSU2",48,0)
 .D:PSOCPXC HD W:'PSODLQT&(PSODLECT'>1)&(PSODLERX="TEXT")&(PSOCPXC) ! S X=PSODLERB,DIWL=1,DIWR=$S(PSODLERX="MSG":76,1:74) K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSU2",49,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D:PSOCPXC HD W:PSODELXF&('PSODLQT) ! D
"RTN","PSODOSU2",50,0)
 ..I PSODLERX="TRAIL" W !
"RTN","PSODOSU2",51,0)
 ..D:PSOCPXC HD W:'$G(PSODLQT) $S(PSODLERX="MSG"!(PSODLERX="TRAIL"):"   ",1:"     ")_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODLERR,PSODOSER,PSODLEXR,PSOERROR)=1 D SFD
"RTN","PSODOSU2",52,0)
 .S PSOLASTD(PSOLASTS)=1,PSONFRNF=1
"RTN","PSODOSU2",53,0)
 Q
"RTN","PSODOSU2",54,0)
 ;
"RTN","PSODOSU2",55,0)
ERREDIT ;write dosing errors for edits or display during complex dose entry
"RTN","PSODOSU2",56,0)
 I 'PSODLERF,PSOCPXB<4 W:'PSODLQT !
"RTN","PSODOSU2",57,0)
 D HD Q:$G(PSODLQTC)  I PSODLERF,PSODLERX="MSG" W:'PSODLQT ! D HD Q:$G(PSODLQTC)  I 'PSODLERF W:'PSODLQT !
"RTN","PSODOSU2",58,0)
 S PSODLERF=1 D HD Q:$G(PSODLQTC)  I PSODLERZ W:'PSODLQT !
"RTN","PSODOSU2",59,0)
 D HD Q:$G(PSODLQTC)  W:'PSODLQT !
"RTN","PSODOSU2",60,0)
 N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF S X=PSODLERB,DIWL=1,DIWR=$S(PSODLERX="MSG":76,1:74) K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSU2",61,0)
 S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD Q:$G(PSODLQTC)  W:PSODELXF&('PSODLQT) ! D HD Q:$G(PSODLQTC)  D
"RTN","PSODOSU2",62,0)
 .I PSODLERX="TRAIL",'PSODELXF,'PSODLQT W !
"RTN","PSODOSU2",63,0)
 .W:'PSODLQT $S(PSODLERX="MSG"!(PSODLERX="TRAIL"):"   ",1:"     ")_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODLERR,PSODOSER,PSODLEXR,PSOERROR)=1 D SFD
"RTN","PSODOSU2",64,0)
 .I 'PSODLQT,PSODLERX="TRAIL",'$O(^UTILITY($J,"W",DIWL,PSODELXR)) W !
"RTN","PSODOSU2",65,0)
 S PSOLASTD(PSOLASTS)=1,PSONFRNF=1
"RTN","PSODOSU2",66,0)
 Q
"RTN","PSODOSU2",67,0)
 ;
"RTN","PSODOSU2",68,0)
ERRNEW ;write dosing errors for finish, new, copy, renewal and verify
"RTN","PSODOSU2",69,0)
 D HD Q:$G(PSODLQTC)  I PSODLERF,PSODLERX="MSG" W:'PSODLQT ! D HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",70,0)
 I $L(PSODLERB)>76&(PSOCPXB>1)  S PSODLERL=1
"RTN","PSODOSU2",71,0)
 I 'PSODLERF,PSOCPXB<4 W:'PSODLQT !
"RTN","PSODOSU2",72,0)
 S PSODLERF=1 D HD Q:$G(PSODLQTC)  I PSODLERZ W:'PSODLQT !
"RTN","PSODOSU2",73,0)
 D HD Q:$G(PSODLQTC)  W:'PSODLQT&(PSODLECT>1) ! N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF
"RTN","PSODOSU2",74,0)
 D:PSOCPXC HD D:'PSOCPXF&(PSOCPXC)
"RTN","PSODOSU2",75,0)
 .Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",76,0)
 D HD Q:$G(PSODLQTC)  S PSOCPXG=$P(PSODLNN1,";",4) I '$G(PSOCPXRR(PSOCPXG))&(PSOCPXB>1) D PSOORI,SUB^PSODOSUT W:'PSODLQT&('PSODLERZ) !
"RTN","PSODOSU2",77,0)
 D HD Q:$G(PSODLQTC)  W:'PSODLQT&(PSODLECT'>1)&(PSODLERX="TEXT") ! S X=PSODLERB,DIWL=1,DIWR=$S(PSODLERX="MSG":76,1:74) K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSU2",78,0)
 S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD Q:$G(PSODLQTC)  W:PSODELXF&('PSODLQT) ! D HD Q:$G(PSODLQTC)  D
"RTN","PSODOSU2",79,0)
 .I PSODLERX="TRAIL",'PSODLQT,'PSODELXF W !!
"RTN","PSODOSU2",80,0)
 .W:'PSODLQT $S(PSODLERX="MSG"!(PSODLERX="TRAIL"):"   ",1:"     ")_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODLERR,PSODOSER,PSODLEXR,PSOERROR)=1 D SFD
"RTN","PSODOSU2",81,0)
 .I 'PSODLQT,PSODLERX="TRAIL",'$O(^UTILITY($J,"W",DIWL,PSODELXR)) W !
"RTN","PSODOSU2",82,0)
 S PSOLASTD(PSOLASTS)=1,PSONFRNF=1
"RTN","PSODOSU2",83,0)
 Q
"RTN","PSODOSU2",84,0)
 ;
"RTN","PSODOSU2",85,0)
SFD ;
"RTN","PSODOSU2",86,0)
 S PSODELXF=1 S:PSODLERX="TEXT" PSODLERZ=1
"RTN","PSODOSU2",87,0)
 Q
"RTN","PSODOSU2",88,0)
 ;
"RTN","PSODOSU2",89,0)
EXCEPT ;format and write exceptions
"RTN","PSODOSU2",90,0)
 I PSODTYPE="E" S (PSODLERZ)=0
"RTN","PSODOSU2",91,0)
 I $G(PSODOSER) K PSODOSER  ;line feed between error and exceptions
"RTN","PSODOSU2",92,0)
 D EXCEPT^PSODOSUT
"RTN","PSODOSU2",93,0)
 I PSODTYPE="N" D HD Q:$G(PSODLQTC)  W:PSODLERF&('PSODLQT)&('$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS")))&('$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE"))) ! S PSODLERZ=0
"RTN","PSODOSU2",94,0)
 I PSODTYPE="C"  D:PSOCPXC HD W:PSODLERF&(PSOCPXC)&('PSODLQT)&('$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS")))&('$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE")))&('$G(PSODLWW)) ! S (PSODLERZ,PSODLESM)=0
"RTN","PSODOSU2",95,0)
 F PSODLERA=0:0 S PSODLERA=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLERA)) Q:'PSODLERA  D
"RTN","PSODOSU2",96,0)
 .S PSODLERB=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLERA))
"RTN","PSODOSU2",97,0)
 .I PSODTYPE="N" D SBAD^PSODOSUT
"RTN","PSODOSU2",98,0)
 .I PSODTYPE="E"!(PSODTYPE="C") D SBAD^PSODOSUT:PSODLERB'=""
"RTN","PSODOSU2",99,0)
 .Q:PSODLERB=""  I PSODTYPE'="C" D HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",100,0)
 .S (PSODLERF,PSODLALZ)=1
"RTN","PSODOSU2",101,0)
 .;write exceptions for new, copy, renew, verify
"RTN","PSODOSU2",102,0)
 .I PSODTYPE="N" D  Q
"RTN","PSODOSU2",103,0)
 ..D HD Q:$G(PSODLQTC)  I 'PSOCPXF&(PSOCPXC) D
"RTN","PSODOSU2",104,0)
 ...Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",105,0)
 ..I 'PSODLERF W:'PSODLQT&('$G(PSODLWW)) ! D HD Q:$G(PSODLQTC)  S PSODLWW=0
"RTN","PSODOSU2",106,0)
 ..S PSOCPXG=$P(PSODLNN1,";",4)
"RTN","PSODOSU2",107,0)
 ..I '$G(PSOCPXRR(PSOCPXG)),PSOCPXB>1 W:'PSODLQT&(PSODLERZ) ! D PSOORI,SUB^PSODOSUT
"RTN","PSODOSU2",108,0)
 ..D HD Q:$G(PSODLQTC)  W:'PSODLQT&('$G(PSODLWW)) ! S PSODLWW=0
"RTN","PSODOSU2",109,0)
 ..D WRITEXC S PSODLERB=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLERA,"TRAIL")) I PSODLERB'="",'$G(PSODLQTC) W !! D WRITEXC
"RTN","PSODOSU2",110,0)
 .;write dosing exceptions for edits or display during complex dose entry
"RTN","PSODOSU2",111,0)
 .I PSODTYPE="E" D
"RTN","PSODOSU2",112,0)
 ..I PSODLERB["please complete a manual check for appropriate Dosing" S PSODCONT=1
"RTN","PSODOSU2",113,0)
 ..D HD Q:$G(PSODLQTC)  W:'PSODLQT&('$G(PSODLWW)) ! S PSODLWW=0
"RTN","PSODOSU2",114,0)
 ..D WRITEXC
"RTN","PSODOSU2",115,0)
 .;write exceptions for complex orders
"RTN","PSODOSU2",116,0)
 .I PSODTYPE="C"&(PSOCPXB>3) D
"RTN","PSODOSU2",117,0)
 ..D:PSOCPXC HD I 'PSODLERF&('$G(PSODLWW)) W:'PSODLQT&(PSOCPXC) !
"RTN","PSODOSU2",118,0)
 ..D:PSOCPXC
"RTN","PSODOSU2",119,0)
 ...D HD Q:$G(PSODLQTC)  I 'PSOCPXF&(PSOCPXC) D
"RTN","PSODOSU2",120,0)
 ....Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",121,0)
 ...S PSOCPXG=$P(PSODLNN1,";",4) I PSOCPXC&('$G(PSOCPXRR(PSOCPXG))) D HD Q:$G(PSODLQTC)  W:'PSODLQT&(PSOCPXC)&(PSODLESM)&('$G(PSODLWW)) ! D PSOORI,SUB^PSODOSUT
"RTN","PSODOSU2",122,0)
 ...S PSODLESM=1 D HD Q:$G(PSODLQTC)  W:'PSODLQT&('$G(PSODLWW)) !
"RTN","PSODOSU2",123,0)
 ...D:PSOCPXC WRITEXC
"RTN","PSODOSU2",124,0)
 .I $D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLERA,"TRAIL")) D
"RTN","PSODOSU2",125,0)
 ..S PSODLERB=^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLERA,"TRAIL")
"RTN","PSODOSU2",126,0)
 ..W !!
"RTN","PSODOSU2",127,0)
 ..D WRITEXC
"RTN","PSODOSU2",128,0)
 Q
"RTN","PSODOSU2",129,0)
 ;
"RTN","PSODOSU2",130,0)
WRITEXC ;format and write exception messages to the screen
"RTN","PSODOSU2",131,0)
 D WRITEXC^PSODOSU4 Q
"RTN","PSODOSU2",132,0)
 ;
"RTN","PSODOSU2",133,0)
MESSAGE ;format and write messages
"RTN","PSODOSU2",134,0)
 I PSODTYPE="N",$$FEED^PSODOSUT D HD Q:$G(PSODLQTC)  W:'PSODLQT !
"RTN","PSODOSU2",135,0)
 I $G(PSODLERZ)&('PSODLQT) W !  ;line feed for transition between exceptions to messages
"RTN","PSODOSU2",136,0)
 I PSODTYPE="C" I $$FEED^PSODOSUT&(PSOCPXC) D HD Q:$G(PSODLQTC)  W:'PSODLQT !
"RTN","PSODOSU2",137,0)
 S PSODLPL="" F  S PSODLPL=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL)) Q:PSODLPL=""  D
"RTN","PSODOSU2",138,0)
 .;Add a line feed if there are just Single and General dosing messages
"RTN","PSODOSU2",139,0)
 .I PSODLPL="3_GENERAL" D
"RTN","PSODOSU2",140,0)
 ..I '$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE","2_RANGE")),'$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE","1_SINGLE_RANGE")) W !
"RTN","PSODOSU2",141,0)
 .I PSODLPL=".1_INTRO" D
"RTN","PSODOSU2",142,0)
 ..S PSOINTRO="1^"_$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",".1_INTRO"))
"RTN","PSODOSU2",143,0)
 ..I $P(PSOINTRO,U,2)="" S PSOINTRO=0
"RTN","PSODOSU2",144,0)
 .F PSODLP1=0:0 S PSODLP1=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1)) Q:'PSODLP1  D
"RTN","PSODOSU2",145,0)
 ..I PSODTYPE'="C",PSODLPL="3_GENERAL" D GENERAL Q
"RTN","PSODOSU2",146,0)
 ..S PSODLMSG=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1))
"RTN","PSODOSU2",147,0)
 ..Q:PSODLMSG=""
"RTN","PSODOSU2",148,0)
 ..I 'PSODLERF W:'PSODLQT&('$G(PSODLWW)) ! D HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",149,0)
 ..S PSODLERF=1
"RTN","PSODOSU2",150,0)
 ..I PSODTYPE'="C" D HD Q:$G(PSODLQTC)  I '$G(PSODLFLG) W:'PSODLQT&('$G(PSODLWW)) !
"RTN","PSODOSU2",151,0)
 ..I PSODTYPE="C" D  Q:'PSODLQT&(PSOCPXC)&(PSODLESM)  I PSOCPXF&(PSOCPXC) K PSODAILY
"RTN","PSODOSU2",152,0)
 ...D:PSOCPXC HD I '$G(PSODLFLG) W:'PSODLQT&(PSOCPXC)&(PSOCPXF)&('$G(PSODLWW)) !
"RTN","PSODOSU2",153,0)
 ...S PSODLFLG=1 S PSODLEXR=0
"RTN","PSODOSU2",154,0)
 ..I PSODTYPE'="E" S PSODLEXR=0
"RTN","PSODOSU2",155,0)
 ..S PSODLFLG=1 S:PSODLPL="1_SINGLE" PSODLINS=1 S:PSODLPL="2_RANGE" PSODLINR=1 S:PSODLPL="1_SINGLE_RANGE" PSODLINX=1
"RTN","PSODOSU2",156,0)
 ..I PSODTYPE="N" S PSODLFLG=1 D MSGN
"RTN","PSODOSU2",157,0)
 ..I PSODTYPE="E" S PSODLFLG=1 D WRITMSG
"RTN","PSODOSU2",158,0)
 ..I PSODTYPE="C"&(PSOCPXB>3) D MSGC
"RTN","PSODOSU2",159,0)
 .I PSODLPL="2_TRAIL",PSODTYPE="E"!(PSODTYPE="N") D
"RTN","PSODOSU2",160,0)
 ..S PSODLMSG=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE","2_TRAIL"))
"RTN","PSODOSU2",161,0)
 ..D WRITMSG
"RTN","PSODOSU2",162,0)
 Q
"RTN","PSODOSU2",163,0)
 ;
"RTN","PSODOSU2",164,0)
MSGN ;write dosing message for new, copy, renew, and verify
"RTN","PSODOSU2",165,0)
 I 'PSOCPXF&(PSOCPXC)&($G(PSOCPXB)>3) S PSOCPXG=$P(PSODLNN1,";",4) D  K PSODAILY S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSU2",166,0)
 .Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",167,0)
 S PSOCPXG=$P(PSODLNN1,";",4) D HD Q:$G(PSODLQTC)  D:'$G(PSOCPXRR(PSOCPXG))&(PSOCPXB>1) PSOORI,SUB^PSODOSUT D
"RTN","PSODOSU2",168,0)
 .I $G(PSOCPXRR(PSOCPXG))&$P(PSODLNN1,";",5)'="" K PSODAILY
"RTN","PSODOSU2",169,0)
 .I PSODLPL="2_RANGE",'$G(PSODAILY) D DAILY^PSODOSUT I PSOCPXG'=PSOCPXB K PSODAILY
"RTN","PSODOSU2",170,0)
 .I PSODLPL="1_SINGLE_RANGE",'$G(PSODAILY) D DAILY^PSODOSUT I PSOCPXG'=PSOCPXB K PSODAILY
"RTN","PSODOSU2",171,0)
 .D HD Q:$G(PSODLQTC)  D WRITMSG,HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",172,0)
 Q
"RTN","PSODOSU2",173,0)
 ;
"RTN","PSODOSU2",174,0)
MSGC ;write dosing message for edits or display during complex dose entry
"RTN","PSODOSU2",175,0)
 Q:'PSODLQT&(PSOCPXC)&(PSODLESM)  I PSOCPXF&(PSOCPXC) K PSODAILY
"RTN","PSODOSU2",176,0)
 D:PSOCPXC HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",177,0)
 I 'PSOCPXF&(PSOCPXC) S PSOCPXG=$P(PSODLNN1,";",4) D  K PSODAILY S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSU2",178,0)
 .Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",179,0)
 I PSOCPXC S PSOCPXG=$P(PSODLNN1,";",4) D HD Q:$G(PSODLQTC)  D
"RTN","PSODOSU2",180,0)
 .I $G(PSOCPXRR(PSOCPXG))&$P(PSODLNN1,";",5)'="" K PSODAILY
"RTN","PSODOSU2",181,0)
 .I '$G(PSOCPXRR(PSOCPXG))&('$G(PSOCPXH)) D PSOORI,SUB^PSODOSUT I $G(PSOCOPY)!($G(PSORENW)) S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSU2",182,0)
 .I PSODLPL="2_RANGE"&PSODLINR&'$G(PSODAILY) D DAILY^PSODOSUT
"RTN","PSODOSU2",183,0)
 .I PSODLPL="1_SINGLE_RANGE"&PSODLINX&'$G(PSODAILY) D DAILY^PSODOSUT
"RTN","PSODOSU2",184,0)
 .D WRITMSG
"RTN","PSODOSU2",185,0)
 Q
"RTN","PSODOSU2",186,0)
 ;
"RTN","PSODOSU2",187,0)
WRITMSG ;
"RTN","PSODOSU2",188,0)
 W:'PSODLQT&('$G(PSODLWW)) ! S PSODLWW=0
"RTN","PSODOSU2",189,0)
 N X,DIWL,DIWR,DIWF
"RTN","PSODOSU2",190,0)
 IF +$G(PSOINTRO),'$G(PSOOFL) D
"RTN","PSODOSU2",191,0)
 .S X=$P(PSOINTRO,U,2),DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSU2",192,0)
 .D WRITMSG1
"RTN","PSODOSU2",193,0)
 .W !
"RTN","PSODOSU2",194,0)
 .S $P(PSOINTRO,U)=0
"RTN","PSODOSU2",195,0)
 S X=PSODLMSG,DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSU2",196,0)
 D WRITMSG1
"RTN","PSODOSU2",197,0)
 K ^UTILITY($J,"W") D HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",198,0)
 I PSODTYPE="E",'PSODLQT S PSODELNX=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) I '$P($G(PSODELNX),";",5) W !
"RTN","PSODOSU2",199,0)
 I PSODTYPE="C"!(PSODTYPE="N"),'PSODLQT D
"RTN","PSODOSU2",200,0)
 .D HD Q:$G(PSODLQTC)  S PSODELNX=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) I '$P($G(PSODELNX),";",5)!($P($G(PSODELNX),";",4)'=PSOCPXG) W ! S PSOLASTD(PSOLASTS)=3
"RTN","PSODOSU2",201,0)
 Q
"RTN","PSODOSU2",202,0)
 ;
"RTN","PSODOSU2",203,0)
WRITMSG1 ;
"RTN","PSODOSU2",204,0)
 N PSODELXR,PSODELXF,PSOSPACE
"RTN","PSODOSU2",205,0)
 S PSODELXF=0
"RTN","PSODOSU2",206,0)
 S PSOSPACE="   "
"RTN","PSODOSU2",207,0)
 I +$G(PSOINTRO),'$G(PSOOFL) S PSOSPACE=""
"RTN","PSODOSU2",208,0)
 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D
"RTN","PSODOSU2",209,0)
 .D HD Q:$G(PSODLQTC)  W:PSODELXF&('PSODLQT) ! W:'PSODLQT PSOSPACE_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODLFLG,PSODELXF,PSONFRNF,PSOWMSG,PSODLEXR)=1
"RTN","PSODOSU2",210,0)
 I $G(PSODLFLG)&($G(PSOCPXC))&($G(PSOCPXB)>3)!(PSODTYPE="C"&(PSOCPXB>3)) W !
"RTN","PSODOSU2",211,0)
 Q
"RTN","PSODOSU2",212,0)
 ;
"RTN","PSODOSU2",213,0)
WRTINTRO ;
"RTN","PSODOSU2",214,0)
 N PSODELXR
"RTN","PSODOSU2",215,0)
 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR!($G(PSODLQTC))  D
"RTN","PSODOSU2",216,0)
 .D HD Q:$G(PSODLQTC)  W $G(^UTILITY($J,"W",DIWL,PSODELXR,0))
"RTN","PSODOSU2",217,0)
 .I PSODLPL'="3_GENERAL" W !
"RTN","PSODOSU2",218,0)
 .S $P(PSOINTRO,U)=0
"RTN","PSODOSU2",219,0)
 Q
"RTN","PSODOSU2",220,0)
 ;
"RTN","PSODOSU2",221,0)
GENERAL ;general dosing range information
"RTN","PSODOSU2",222,0)
 N PSODLERC,PSODLP2
"RTN","PSODOSU2",223,0)
 I +$G(PSOINTRO) D
"RTN","PSODOSU2",224,0)
 .S X=$P(PSOINTRO,U,2),DIWL=4,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSU2",225,0)
 .D WRTINTRO
"RTN","PSODOSU2",226,0)
 F PSODLP2=0:0 S PSODLP2=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1,PSODLP2)) Q:'PSODLP2!($G(PSORX("DFLG")))  D
"RTN","PSODOSU2",227,0)
 .S PSODLERC="",PSODLERC=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1,PSODLP2))
"RTN","PSODOSU2",228,0)
 .Q:PSODLERC=""
"RTN","PSODOSU2",229,0)
 .D HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",230,0)
 .;I 'PSODLQT,'$G(PSOEDIT) W !
"RTN","PSODOSU2",231,0)
 .N X,DIWL,DIWR,DIWF,DIWL,PSODELXR,PSODELXF S PSODLEXR=1
"RTN","PSODOSU2",232,0)
 .S DIWL=4,DIWR=76 K ^UTILITY($J,"W")
"RTN","PSODOSU2",233,0)
 .S X=PSODLERC D ^DIWP
"RTN","PSODOSU2",234,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD Q:$G(PSODLQTC)  W:PSODELXF&('PSODLQT) ! D HD Q:$G(PSODLQTC)  W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODELXF,PSODLERZ,PSONFRNF)=1
"RTN","PSODOSU2",235,0)
 .W:$G(PSOEDIT) ! S PSOLASTD(PSOLASTS)=3
"RTN","PSODOSU2",236,0)
 .I '$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE","1_SINGLE")),'$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE","2_RANGE")),'$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE","1_SINGLE_RANGE")) D
"RTN","PSODOSU2",237,0)
 ..I +$G(PSOEXCPT)!(+$G(PSOERROR)) S PSOGENF=1
"RTN","PSODOSU2",238,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSU2",239,0)
 .W !
"RTN","PSODOSU2",240,0)
 Q
"RTN","PSODOSU2",241,0)
 ;
"RTN","PSODOSU2",242,0)
HD ;
"RTN","PSODOSU2",243,0)
 S:'$G(PSODLQT) PSODLQT=""
"RTN","PSODOSU2",244,0)
 I PSODLQT!(($Y+3)<IOSL)!($G(PSORX("DFLG"))) Q
"RTN","PSODOSU2",245,0)
 W:$G(PSORENWD) !
"RTN","PSODOSU2",246,0)
HD2 ;
"RTN","PSODOSU2",247,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODOSU2",248,0)
 K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue,'^' to exit" D ^DIR K DIR
"RTN","PSODOSU2",249,0)
 I $G(PSOCPXC)&($D(DIRUT)!($D(DUOUT))) S PSODLQTC=1 W @IOF W ! Q  ;user ^'s
"RTN","PSODOSU2",250,0)
 I 'Y!($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODOSU2",251,0)
 W @IOF W !
"RTN","PSODOSU2",252,0)
 S PSOOFL="" D:$G(PSODELXR) PSOORI W:$G(PSOOFL) !
"RTN","PSODOSU2",253,0)
 Q
"RTN","PSODOSU2",254,0)
 ;
"RTN","PSODOSU2",255,0)
PSOORI ;**writes per orifice intro text to the screen for dosing check summary**
"RTN","PSODOSU2",256,0)
 I +$G(PSOINTRO),'$G(PSOOFL) D
"RTN","PSODOSU2",257,0)
 .W ?3,$P(PSOINTRO,U,2)
"RTN","PSODOSU2",258,0)
 .S $P(PSOINTRO,U)=0,PSOOFL=1
"RTN","PSODOSU2",259,0)
 Q
"RTN","PSODOSU2",260,0)
 ;
"RTN","PSODOSU4")
0^16^B2907861
"RTN","PSODOSU4",1,0)
PSODOSU4 ;BIR/cmf - Dose Check Utility routine continued ;11/18/08
"RTN","PSODOSU4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**402**;DEC 1997;Build 8
"RTN","PSODOSU4",3,0)
 ;
"RTN","PSODOSU4",4,0)
 ;Called from PSODOSUT*.  The variable PSODTYPE is expected to be defined.
"RTN","PSODOSU4",5,0)
 ; PSODTYPE values can be N for dosing for new order, copy, and renews, E for edited and display of individual complex doses, and C for complex orders
"RTN","PSODOSU4",6,0)
 ;
"RTN","PSODOSU4",7,0)
WRITEXC ;format and write exception messages to the screen
"RTN","PSODOSU4",8,0)
 S PSODLWW=0,DIWL=4,DIWR=76 K ^UTILITY($J,"W")
"RTN","PSODOSU4",9,0)
 I PSODLERB["Range Check Error Summary" S PSODLERS=1 I PSODLERZ W:'PSODLQT ! D HD Q:$G(PSODLQTC)
"RTN","PSODOSU4",10,0)
 I $G(PSODLERS),$L(PSODLERB)>76&($G(PSOCPXB)>1)  S PSODLERB=$E(PSODLERB,14,999),DIWR=76,DIWL=17,DIWF="W" S PSODLERW=1
"RTN","PSODOSU4",11,0)
 S X=PSODLERB D:'PSODLQT ^DIWP D HD Q:$G(PSODLQTC)
"RTN","PSODOSU4",12,0)
 I '$G(PSODLERW) S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D
"RTN","PSODOSU4",13,0)
 .W:PSODELXF&('PSODLQT) ! D HD Q:$G(PSODLQTC)  W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSONFRNF,PSODELXF,PSODLERZ,PSODLEXR,PSOEXCPT)=1
"RTN","PSODOSU4",14,0)
 I $G(PSODLERW)&('PSODLQT) D ^DIWW K PSODLERW,PSODLERL S PSODLWW=1 S PSOLASTD(PSOLASTS)=2
"RTN","PSODOSU4",15,0)
 K ^UTILITY($J,"W")
"RTN","PSODOSU4",16,0)
 Q
"RTN","PSODOSU4",17,0)
 ;
"RTN","PSODOSU4",18,0)
HD ;
"RTN","PSODOSU4",19,0)
 D HD^PSODOSU2 Q
"RTN","PSODOSU4",20,0)
 ;;
"RTN","PSODOSUN")
0^5^B100479276
"RTN","PSODOSUN",1,0)
PSODOSUN ;BIR/RTR - Dose Check Utility routine ;11/18/08
"RTN","PSODOSUN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,379,372,416,436,402**;DEC 1997;Build 8
"RTN","PSODOSUN",3,0)
 ;
"RTN","PSODOSUN",4,0)
DOSE() ;Write Dose output for renew, finish, copy, etc.
"RTN","PSODOSUN",5,0)
 N PSODLINS,PSODLINR,PSODLINX,PSODLERA,PSODLERB,PSODLERF,PSODLERZ,PSODLPL,PSODLP1,PSODLMSG,PSODLFLG,PSODLALZ,DIR,DUOUT,DTOUT,DIROUT,DIRUT,X,Y,X1,PSODLOFF
"RTN","PSODOSUN",6,0)
 N PSODLNN1,PSODLERR,PSODLERX,PSODLQT,PSOCPXG,PSOCPXRR,PSODLEXR,PSODELNX,PSODLECT,PSOCPXF,PSODTYPE,PSOCPXC,PSOLASTS,PSOQTOUT,PSOEDOUT,PSODSEQ
"RTN","PSODOSUN",7,0)
 N PSOSIGC,PSOINTRO,PSOTRAIL,PSOEXCPT,PSOERROR
"RTN","PSODOSUN",8,0)
 S (PSODLERF,PSODLERZ,PSODLALZ,PSODLINS,PSODLINR,PSODLINX,PSODLERR,PSODLQT,PSOCPXG,PSOCPXF,PSOLASTS,PSOQTOUT,PSOEDOUT,PSODLOFF,PSOINTRO,PSOTRAIL,PSOEXCPT,PSOERROR)=0,PSODTYPE="N",PSOCPXC=1
"RTN","PSODOSUN",9,0)
 I $G(PSORXED)&$G(PSOEDDOS) S PSOCPXC=0  ;don't show summary before accept of order if edit
"RTN","PSODOSUN",10,0)
 I $G(PSOCPXB)<4 S PSOCPXC=0
"RTN","PSODOSUN",11,0)
 W:$G(PSOEDIT)!$G(PSOCOPY)!($G(PSOFOERR)) @IOF I $P($G(^TMP($J,"PSOPDOSN","OUT",0)),"^")=-1 D  S PSODLFLG=0,PSODLOFF=1 G END
"RTN","PSODOSUN",12,0)
 .D HD N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF D MESG
"RTN","PSODOSUN",13,0)
 .S X="Reason(s): "_$P(^TMP($J,"PSOPDOSN","OUT",0),"^",2),DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUN",14,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUN",15,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUN",16,0)
 ;PSOCPXB = Number of Dosing Seq
"RTN","PSODOSUN",17,0)
 S PSODLQT=0 K PSOCPXRR
"RTN","PSODOSUN",18,0)
 D EN^PSODOSU2
"RTN","PSODOSUN",19,0)
END ;
"RTN","PSODOSUN",20,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",21,0)
 I '$G(PSODLALZ),'$G(PSODLFLG),'$G(PSODLERR),'$G(PSODLOFF) Q 0
"RTN","PSODOSUN",22,0)
 I '$G(PSODLFLG) W !
"RTN","PSODOSUN",23,0)
 K PSODAILY,DIR,Y,PSODOSEX
"RTN","PSODOSUN",24,0)
 D PROMPT Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 1
"RTN","PSODOSUN",25,0)
 I '$G(PSODLINS)&('$G(PSODLINR))&('$G(PSODLINX)) Q 0
"RTN","PSODOSUN",26,0)
 I $D(^XUSEC("PSORPH",DUZ)) D  I Y'=1!($D(DTOUT))!($D(DUOUT))!($G(PSRX("DFLG"))) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",27,0)
 .S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR
"RTN","PSODOSUN",28,0)
 I '$G(PSODLINS)&'$G(PSODLINR)&('$G(PSODLINX)) Q 0
"RTN","PSODOSUN",29,0)
 I '$D(^XUSEC("PSORPH",DUZ)) Q 2_"^"_$$EVAL(PSODLINS,PSODLINR,PSODLINX)
"RTN","PSODOSUN",30,0)
 W !!,"Do you want to Process or Cancel medication?" K DIR,Y S DIR("B")="P",DIR(0)="SA^1:PROCESS MEDICATION;0:CANCEL MEDICATION"
"RTN","PSODOSUN",31,0)
 S DIR("A")=$$GETGN^PSODOSUN(PSODRUG("IEN"))_": "  K ^TMP($J,"PSODOSUN GN")
"RTN","PSODOSUN",32,0)
 S DIR("?",1)="Enter '1' or 'P' to Process medication",DIR("?")="      '^' to EXIT",DIR("?",2)="      '0' or 'C' to Cancel Medication"
"RTN","PSODOSUN",33,0)
 D ^DIR K DIR
"RTN","PSODOSUN",34,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",35,0)
 ;need to know if user cancelled or not
"RTN","PSODOSUN",36,0)
 I Y=0 Q 3_"^"_$S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & MAX DAILY DOSE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"MAX DAILY DOSE",$G(PSODLINX):"MAX SINGLE DOSE & MAX DAILY DOSE",1:"UNKNOWN")
"RTN","PSODOSUN",37,0)
 K PSODOSEX
"RTN","PSODOSUN",38,0)
 S PSOSIGC=0
"RTN","PSODOSUN",39,0)
SIG1 ;
"RTN","PSODOSUN",40,0)
 D SIG^XUSESIG
"RTN","PSODOSUN",41,0)
 I 'PSOSIGC&($G(X1)="") D MSG1 S PSOSIGC=PSOSIGC+1 G SIG1
"RTN","PSODOSUN",42,0)
 I $G(X1)="" D MSG2 Q 1
"RTN","PSODOSUN",43,0)
END2 ;
"RTN","PSODOSUN",44,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",45,0)
 Q 2_"^"_$S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & MAX DAILY DOSE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"MAX DAILY DOSE",$G(PSODLINX):"MAX SINGLE DOSE & MAX DAILY DOSE",1:"UNKNOWN")
"RTN","PSODOSUN",46,0)
 ;
"RTN","PSODOSUN",47,0)
EVAL(PSODLINS,PSODLINR,PSODLINX) ;
"RTN","PSODOSUN",48,0)
 Q $S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & MAX DAILY DOSE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"MAX DAILY DOSE",$G(PSODLINX):"MAX SINGLE DOSE & MAX DAILY DOSE",1:"UNKNOWN")
"RTN","PSODOSUN",49,0)
 ;
"RTN","PSODOSUN",50,0)
DOSEX(PSODLXNT) ;Write Dose exceptions for order entry/edit
"RTN","PSODOSUN",51,0)
 N PSODLINS,PSODLINR,PSODLINX,PSODLERA,PSODLERB,PSODLERF,PSODLERZ,PSODLPL,PSODLP1,PSODLMSG,DIR,DUOUT,DTOUT,DIROUT,DIRUT,X,Y,X1
"RTN","PSODOSUN",52,0)
 N PSODLNN1,PSODLERX,PSODLQT,PSODELNX,PSODTYPE,PSODCONT,PSODSEQ,PSODOSX,PSODLOFF,PSOINTRO,PSOTRAIL,PSOEXCPT,PSOERROR
"RTN","PSODOSUN",53,0)
 W @IOF S (PSODLERF,PSODLERZ,PSODLINS,PSODLINR,PSODLINX,PSODLQT,PSODCONT,PSODLOFF,PSOINTRO,PSOTRAIL,PSOEXCPT,PSOERROR)=0,PSODTYPE="E"
"RTN","PSODOSUN",54,0)
 I $G(PSOEDDOS) Q:$G(PSORXED("CONJUNCTION",1))="" 0  ;don't show messages when simple order before accept of order during edits
"RTN","PSODOSUN",55,0)
 I PSOCPXB>3,$G(PSORXED)&$G(PSOEDDOS) S PSOCPXC=0  ;don't show summary before accept of order if edit
"RTN","PSODOSUN",56,0)
 I $P($G(^TMP($J,"PSOPDOSN","OUT",0)),"^")=-1 D  S PSODLFLG=0,PSODLOFF=1 G ENDX
"RTN","PSODOSUN",57,0)
 .D HD N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF D MESG
"RTN","PSODOSUN",58,0)
 .S X="Reason(s): "_$P(^TMP($J,"PSOPDOSN","OUT",0),"^",2),DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUN",59,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUN",60,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUN",61,0)
 D EN^PSODOSU2
"RTN","PSODOSUN",62,0)
ENDX ;
"RTN","PSODOSUN",63,0)
 S PSODOSX=1
"RTN","PSODOSUN",64,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",65,0)
 K PSOCPXRR
"RTN","PSODOSUN",66,0)
 I '$G(PSODLALZ),'$G(PSODLFLG),'$G(PSODLERR),'$G(PSODLOFF) Q 0
"RTN","PSODOSUN",67,0)
 ;
"RTN","PSODOSUN",68,0)
 ;This "return to continue" occurs after the last dosing sequence for a complex order with 4 or more dosing sequences during an edit when finishing, placing a new order, copy or edit
"RTN","PSODOSUN",69,0)
 ;
"RTN","PSODOSUN",70,0)
 I '$G(PSOCKCON)&($G(PSOFOERR)) D  I $G(PSOQTOUT) Q 0
"RTN","PSODOSUN",71,0)
 .Q:($G(PSODLFLG))&$D(^XUSEC("PSORPH",DUZ))  ;messages need the "do you want to continue" prompt instead but need to evaluate here so that it doesn't show up for edits
"RTN","PSODOSUN",72,0)
 .D RETURN
"RTN","PSODOSUN",73,0)
 Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 1
"RTN","PSODOSUN",74,0)
 ;
"RTN","PSODOSUN",75,0)
 I '$G(PSOFOERR) D  I $G(PSOQTOUT) Q 0
"RTN","PSODOSUN",76,0)
 .Q:$G(PSODLFLG)&$D(^XUSEC("PSORPH",DUZ))
"RTN","PSODOSUN",77,0)
 .I '$G(PSOEDIT) Q:$G(PSODOSNW)&'$G(PSOCPXD)&'$G(PSOCOPY)
"RTN","PSODOSUN",78,0)
 .Q:($G(PSOCOPY)!$G(PSOEDIT))&'$G(PSOCPXV)
"RTN","PSODOSUN",79,0)
 .Q:PSOCPXB>3&$G(PSOCPXV)
"RTN","PSODOSUN",80,0)
 .D RETURN
"RTN","PSODOSUN",81,0)
 Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 1
"RTN","PSODOSUN",82,0)
 ;
"RTN","PSODOSUN",83,0)
 I '$G(PSODLFLG) W !
"RTN","PSODOSUN",84,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(PSODLINS)!($G(PSODLINR))!($G(PSODLINX)),$G(PSODLFLG) Q 2_"^"_$$EVAL(PSODLINS,PSODLINR,PSODLINX)
"RTN","PSODOSUN",85,0)
 I 'PSODCONT Q:$G(PSOCPXV) 0
"RTN","PSODOSUN",86,0)
 I $G(PSODLBD4)&'$G(PSODLINS)&'$G(PSODLINR)&'$G(PSODLINX)&('$G(PSODLALZ)) S Y=1 G ENDX2
"RTN","PSODOSUN",87,0)
 K DIR,Y I $D(^XUSEC("PSORPH",DUZ)) S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",88,0)
ENDX2 ;
"RTN","PSODOSUN",89,0)
 K PSODOSEX
"RTN","PSODOSUN",90,0)
 W !
"RTN","PSODOSUN",91,0)
 Q 0
"RTN","PSODOSUN",92,0)
DOSEZ() ;Write Dose output summary for complex orders
"RTN","PSODOSUN",93,0)
 I $G(PSOEDDOS) Q:$G(PSORXED("CONJUNCTION",1))="" 0  ;don't show messages when simple order before accept of order during edits
"RTN","PSODOSUN",94,0)
 N PSOCPXF,PSOCPXC,PSOCPXRR,PSOCPXG,PSODLESM,PSODELNX,PSOCPXH,PSODTYPE,PSOLASTS,PSOLASTD,PSOQTOUT,PSOEDOUT,PSODSEQ
"RTN","PSODOSUN",95,0)
 N PSODLINS,PSODLINR,PSODLINX,PSODLERA,PSODLERB,PSODLERF,PSODLERZ,PSODLPL,PSODLP1,PSODLMSG,DIR,DUOUT,DTOUT,DIROUT,DIRUT,X,Y,X1
"RTN","PSODOSUN",96,0)
 N PSODLNN1,PSODLERX,PSODLQT,PSODLEXR,PSODLECT,PSODLOFF,PSOINTRO,PSOTRAIL,PSOEXCPT,PSOERROR
"RTN","PSODOSUN",97,0)
 I '$G(PSOTOF) W @IOF
"RTN","PSODOSUN",98,0)
 S (PSODLERF,PSODLERZ,PSODLINS,PSODLINR,PSODLINX,PSOCPXF,PSODLQT,PSOCPXH,PSOLASTS,PSOLASTD,PSOQTOUT,PSOEDOUT,PSODLOFF,PSOINTRO,PSOTRAIL,PSOEXCPT,PSOERROR)=0,PSODTYPE="C",PSOCPXC=1
"RTN","PSODOSUN",99,0)
 I $G(PSORX("EDIT"))!($G(PSORXED)&$G(PSOEDDOS))!($G(PSOCOPY)&$G(PSODLBD4)) S PSOEDOUT=1
"RTN","PSODOSUN",100,0)
 I PSOCPXB>3,$G(PSOEDOUT) S PSOCPXC=0
"RTN","PSODOSUN",101,0)
 ;I PSOCPXB>3,$G(PSOEDDOS) S PSOCPXC=0  ;don't show summary before accept of order if edit
"RTN","PSODOSUN",102,0)
 I $G(PSOCPXB)<4 S PSOCPXC=0
"RTN","PSODOSUN",103,0)
 Q:$G(PSOCPXB)<4&'$G(PSOFOERR)&('$G(PSODLFLG)) 0
"RTN","PSODOSUN",104,0)
 I $P($G(^TMP($J,"PSOPDOSN","OUT",0)),"^")=-1 S PSODLQT=1 D  S PSODLFLG=0,PSODLOFF=1 G ENDZ
"RTN","PSODOSUN",105,0)
 .D:PSOCPXC HD W:'PSODLQT&(PSOCPXC) !! N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF D MESG
"RTN","PSODOSUN",106,0)
 .S X="Reason(s): "_$P(^TMP($J,"PSOPDOSN","OUT",0),"^",2),DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUN",107,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D:PSOCPXC HD W:PSODELXF&('PSODLQT)&(PSOCPXC) ! D:PSOCPXC HD W:'PSODLQT&(PSOCPXC) "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUN",108,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUN",109,0)
 D EN^PSODOSU2
"RTN","PSODOSUN",110,0)
ENDZ ;
"RTN","PSODOSUN",111,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",112,0)
 K PSODAILY
"RTN","PSODOSUN",113,0)
 I '$G(PSODLALZ),'$G(PSODLFLG),'$G(PSODLERR),'$G(PSODLOFF) Q 0
"RTN","PSODOSUN",114,0)
 D PROMPT Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 0
"RTN","PSODOSUN",115,0)
 I '$G(PSODLINS)&('$G(PSODLINR))&('$G(PSODLINX)) Q 0
"RTN","PSODOSUN",116,0)
 I '$G(PSOCPXF)&(PSOLASTS'=PSOCPXB),PSOEDOUT Q 0
"RTN","PSODOSUN",117,0)
 K PSODOSEX
"RTN","PSODOSUN",118,0)
 I $D(^XUSEC("PSORPH",DUZ)) D  I Y'=1!($D(DTOUT))!($D(DUOUT))!($G(PSRX("DFLG"))) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",119,0)
 .K DIR,Y S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR
"RTN","PSODOSUN",120,0)
ENDZC ;
"RTN","PSODOSUN",121,0)
 I '$G(PSODLINS)&('$G(PSODLINR))&('$G(PSODLINX)) Q 0
"RTN","PSODOSUN",122,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(PSODLINS)!($G(PSODLINR))!($G(PSODLINX)) Q 2_"^"_$$EVAL(PSODLINS,PSODLINR,PSODLINX)
"RTN","PSODOSUN",123,0)
 G ENDZ2:$G(PSORX("EDIT"))!($G(PSORXED)&$G(PSOEDDOS))!($G(PSOCOPY)&$G(PSODLBD4))
"RTN","PSODOSUN",124,0)
 W !!,"Do you want to Process or Cancel medication?" K DIR,Y S DIR("B")="P",DIR(0)="SA^1:PROCESS MEDICATION;0:CANCEL MEDICATION"
"RTN","PSODOSUN",125,0)
 S DIR("A")=$$GETGN(PSODRUG("IEN"))_": "  K ^TMP($J,"PSODOSUN GN")
"RTN","PSODOSUN",126,0)
 S DIR("?",1)="Enter '1' or 'P' to Process medication",DIR("?")="      '^' to EXIT",DIR("?",2)="      '0' or 'C' to Cancel Medication"
"RTN","PSODOSUN",127,0)
 D ^DIR K DIR,PSODOSEX
"RTN","PSODOSUN",128,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",129,0)
 S PSOSIGC=0
"RTN","PSODOSUN",130,0)
SIG2 ;
"RTN","PSODOSUN",131,0)
 D SIG^XUSESIG
"RTN","PSODOSUN",132,0)
 I 'PSOSIGC&($G(X1)="") D MSG1 S PSOSIGC=PSOSIGC+1 G SIG2
"RTN","PSODOSUN",133,0)
 I $G(X1)="" D MSG2 Q 1
"RTN","PSODOSUN",134,0)
ENDZ2 ;
"RTN","PSODOSUN",135,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",136,0)
 Q 2_"^"_$S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & MAX DAILY DOSE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"MAX DAILY DOSE",$G(PSODLINX):"MAX SINGLE DOSE & MAX DAILY DOSE",1:"UNKNOWN")
"RTN","PSODOSUN",137,0)
HD ;
"RTN","PSODOSUN",138,0)
 I PSODLQT!(($Y+5)'>IOSL) Q
"RTN","PSODOSUN",139,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODOSUN",140,0)
 I $D(^XUSEC("PSORPH",DUZ)) D  I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1,PSORX("DFLG")=1 Q 1
"RTN","PSODOSUN",141,0)
 .K DIR,Y S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR
"RTN","PSODOSUN",142,0)
 W @IOF W !
"RTN","PSODOSUN",143,0)
 Q
"RTN","PSODOSUN",144,0)
MESG ;Write out System error heading
"RTN","PSODOSUN",145,0)
 I 'PSODLQT D HD W !,"Maximum Single Dose Check could not be performed:",!
"RTN","PSODOSUN",146,0)
 Q
"RTN","PSODOSUN",147,0)
GETGN(PSODRIEN) ;get generic name
"RTN","PSODOSUN",148,0)
 K ^TMP($J,"PSODOSUN GN")
"RTN","PSODOSUN",149,0)
 D DATA^PSS50(PSODRIEN,,,,,"PSODOSUN GN")
"RTN","PSODOSUN",150,0)
 Q $S($D(^TMP($J,"PSODOSUN GN",PSODRIEN,.01)):^TMP($J,"PSODOSUN GN",PSODRIEN,.01),1:"")
"RTN","PSODOSUN",151,0)
 ;
"RTN","PSODOSUN",152,0)
PROMPT ;
"RTN","PSODOSUN",153,0)
 ;assumes that a previous check was made to verify that errors, exceptions or messages are present
"RTN","PSODOSUN",154,0)
 ;if only warnings (exceptions/errors) then display "Press return to continue"; otherwise display "Do you want to continue" prompt.
"RTN","PSODOSUN",155,0)
 ;FINISH and BACKDOOR are separated below in order keep to a mininum the vast number of scenarios to be tested
"RTN","PSODOSUN",156,0)
 I $G(PSODLOFF)&(($Y+5)>IOSL) D RETURN Q
"RTN","PSODOSUN",157,0)
 I $G(PSOFOERR) D  ;FINISH
"RTN","PSODOSUN",158,0)
 .Q:$D(^XUSEC("PSORPH",DUZ))&('$G(PSORENWD))
"RTN","PSODOSUN",159,0)
 .I '$G(PSODLFLG) D
"RTN","PSODOSUN",160,0)
 ..Q:'$G(PSOEDOUT)&$D(^XUSEC("PSORPH",DUZ))&('$G(PSORENWD))  ;messages need the "do you want to continue" prompt instead but need to evaluate here so that it doesn't show up for edits
"RTN","PSODOSUN",161,0)
 ..I '$G(PSORENWD) Q:PSOCPXB<4&('$G(PSODOSX))
"RTN","PSODOSUN",162,0)
 ..D RETURN
"RTN","PSODOSUN",163,0)
 ;
"RTN","PSODOSUN",164,0)
 I '$G(PSOFOERR)&'$G(PSODLFLG) D  ;BACKDOOR
"RTN","PSODOSUN",165,0)
 .Q:'$G(PSOEDOUT)&$D(^XUSEC("PSORPH",DUZ))&('$G(PSORENWD))  ;messages need the "do you want to continue" prompt instead but need to evaluate here so that it doesn't show up for edits
"RTN","PSODOSUN",166,0)
 .I '$G(PSORENWD),('$D(^XUSEC("PSORPH",DUZ))&'$G(PSODCAN)) Q:PSOCPXB<4&('$G(PSODOSX))
"RTN","PSODOSUN",167,0)
 .D RETURN
"RTN","PSODOSUN",168,0)
 ;
"RTN","PSODOSUN",169,0)
 I $G(PSODLFLG)&'$D(^XUSEC("PSORPH",DUZ)) D
"RTN","PSODOSUN",170,0)
 .I '$G(PSORENWD),('$D(^XUSEC("PSORPH",DUZ))&'$G(PSODCAN)) Q:PSOCPXB<4&('$G(PSODOSX))
"RTN","PSODOSUN",171,0)
 .D RETURN
"RTN","PSODOSUN",172,0)
 Q
"RTN","PSODOSUN",173,0)
 ;
"RTN","PSODOSUN",174,0)
RETURN ;
"RTN","PSODOSUN",175,0)
 Q:'$D(^XUSEC("PSORPH",DUZ))&($Y<10)
"RTN","PSODOSUN",176,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue,'^' to exit" D ^DIR K DIR  S:'Y PSODLQT=1,PSOQTOUT=1,PSORX("DFLG")=1 W @IOF
"RTN","PSODOSUN",177,0)
 Q
"RTN","PSODOSUN",178,0)
 ;
"RTN","PSODOSUN",179,0)
HD3(PSOLINES,OVRRID) ;
"RTN","PSODOSUN",180,0)
 N X,Y,DTOUT,DUOUT,DIR
"RTN","PSODOSUN",181,0)
 S:'$G(PSODLQT) PSODLQT=0  S:'$G(OVRRID) OVRRID=0 S:'$G(PSOLINES) PSOLINES=5
"RTN","PSODOSUN",182,0)
 I '$G(OVRRID),$G(PSODLQT)!(($Y+PSOLINES)<IOSL) Q
"RTN","PSODOSUN",183,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y W ! K DIR,Y S DIR(0)="E",DIR("A")="Press return to continue" D ^DIR K DIR,PSOLINES,OVRRID
"RTN","PSODOSUN",184,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODOSUN",185,0)
 W @IOF
"RTN","PSODOSUN",186,0)
 Q
"RTN","PSODOSUN",187,0)
 ;
"RTN","PSODOSUN",188,0)
MSG1 ;
"RTN","PSODOSUN",189,0)
 W !!,"  *** You must enter your Current Signature Code. ***"
"RTN","PSODOSUN",190,0)
 Q
"RTN","PSODOSUN",191,0)
MSG2 ;
"RTN","PSODOSUN",192,0)
 W !!,"  *** A Signature Code must be entered to continue with this order. ***",!
"RTN","PSODOSUN",193,0)
MSG3 ;
"RTN","PSODOSUN",194,0)
 N MSGX,DIR
"RTN","PSODOSUN",195,0)
 W ! K DIR S DIR(0)="E",DIR("A")="Press <Enter> to return to the order..." D ^DIR
"RTN","PSODOSUN",196,0)
 S PSODLQT=1,PSOQTOUT=1,PSORX("DFLG")=1
"RTN","PSODOSUN",197,0)
 Q
"RTN","PSODOSUN",198,0)
 ;
"RTN","PSODOSUT")
0^6^B149150710
"RTN","PSODOSUT",1,0)
PSODOSUT ;BIR/RTR - PRE Dose Check Utility routine ;11/18/08
"RTN","PSODOSUT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,372,416,436,402**;DEC 1997;Build 8
"RTN","PSODOSUT",3,0)
 ;External reference to ^PSSDSAPI supported by DBIA 5425
"RTN","PSODOSUT",4,0)
 ;
"RTN","PSODOSUT",5,0)
 ;DOSE expect PSODLQT to be defined prior to calling it.
"RTN","PSODOSUT",6,0)
 ; PSODLQT=1 means no data will be written to the screen, but a value will be returned.
"RTN","PSODOSUT",7,0)
 ; PSODLQT=0 means data will be written to the screen and a value is returned 
"RTN","PSODOSUT",8,0)
 ;
"RTN","PSODOSUT",9,0)
 ;EVAL(PSODLINS,PSODLINR) ;
"RTN","PSODOSUT",10,0)
 ;Q $S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & DAILY DOSE RANGE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"DAILY DOSE RANGE",1:"UNKNOWN")
"RTN","PSODOSUT",11,0)
 ;
"RTN","PSODOSUT",12,0)
SUMM ;
"RTN","PSODOSUT",13,0)
 I 'PSODLQT W !,"   DOSING CHECK SUMMARY:",!!
"RTN","PSODOSUT",14,0)
 S PSOCPXF=1
"RTN","PSODOSUT",15,0)
 Q
"RTN","PSODOSUT",16,0)
 ;
"RTN","PSODOSUT",17,0)
SUB ;Write sub header; called from PSODOSUN
"RTN","PSODOSUT",18,0)
 D HD^PSODOSU2 Q:$G(PSODLQTC)  I 'PSODLQT,'$G(PSODLEXR),'$G(PSOINTRO) W ! S PSODLEXR=0
"RTN","PSODOSUT",19,0)
 D HD^PSODOSU2 Q:$G(PSODLQTC)
"RTN","PSODOSUT",20,0)
 I 'PSODLQT W "   DOSE SEQ "_PSOCPXG_":"
"RTN","PSODOSUT",21,0)
 S PSOCPXRR(PSOCPXG)=1
"RTN","PSODOSUT",22,0)
 Q
"RTN","PSODOSUT",23,0)
 ;
"RTN","PSODOSUT",24,0)
DAILY ;
"RTN","PSODOSUT",25,0)
 Q   ;;removed for Mocha 2.1, might add back for 2.2
"RTN","PSODOSUT",26,0)
 Q:'$G(PSOCPXC)
"RTN","PSODOSUT",27,0)
 I 'PSODLQT W:'$G(PSORENW)!($G(PSOCOPY))!($G(PSORXED)) ! W "   DAILY DOSE RANGE WARNING:"
"RTN","PSODOSUT",28,0)
 S PSODAILY=1
"RTN","PSODOSUT",29,0)
 Q
"RTN","PSODOSUT",30,0)
 ;
"RTN","PSODOSUT",31,0)
COMPLEX ;called from DOSEZ^PSODOSUN
"RTN","PSODOSUT",32,0)
 I 'PSOCPXF&(PSOCPXC) S PSOCPXG=$P(PSODLNN1,";",4) D SUMM K PSODAILY S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSUT",33,0)
 I PSOCPXC S PSOCPXG=$P(PSODLNN1,";",4) D HD D
"RTN","PSODOSUT",34,0)
 .I $G(PSOCPXRR(PSOCPXG))&$P(PSODLNN1,";",5)'="" K PSODAILY
"RTN","PSODOSUT",35,0)
 .I '$G(PSOCPXRR(PSOCPXG))&('$G(PSOCPXH)) D SUB I $G(PSOCOPY)!($G(PSORENW)) S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSUT",36,0)
 .;I PSODLPL="2_RANGE"&PSODLINR&'$G(PSODAILY) D DAILY          ;removed for Mocha 2.1, might add back for 2.2
"RTN","PSODOSUT",37,0)
 .;I PSODLPL="1_SINGLE_RANGE"&PSODLINX&'$G(PSODAILY) D DAILY   ;removed for Mocha 2.1, might add back for 2.2
"RTN","PSODOSUT",38,0)
 .D HD W:'PSODLQT ! N X,DIWL,DIWR,DIWF S X=PSODLMSG,DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUT",39,0)
 .N PSODELXF,PSODELXR S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUT",40,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUT",41,0)
 .D HD I 'PSODLQT S PSODELNX=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) I '$P($G(PSODELNX),";",5)!($P($G(PSODELNX),";",4)'=PSOCPXG) W !
"RTN","PSODOSUT",42,0)
 Q
"RTN","PSODOSUT",43,0)
 ;
"RTN","PSODOSUT",44,0)
HD ;
"RTN","PSODOSUT",45,0)
 I $G(PSODLQT)!(($Y+5)<IOSL)!($G(PSORX("DFLG"))) Q
"RTN","PSODOSUT",46,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODOSUT",47,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue,'^' to exit" D ^DIR K DIR I 'Y!($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) S PSODLQT=1,PSONEW("DFLG")=1,PSORX("DFLG")=1 Q
"RTN","PSODOSUT",48,0)
 W @IOF
"RTN","PSODOSUT",49,0)
 Q
"RTN","PSODOSUT",50,0)
 ;
"RTN","PSODOSUT",51,0)
SFD ;
"RTN","PSODOSUT",52,0)
 S PSODELXF=1 S:PSODLERX="TEXT" PSODLERZ=1
"RTN","PSODOSUT",53,0)
 Q
"RTN","PSODOSUT",54,0)
 ;
"RTN","PSODOSUT",55,0)
SBAD ;Set Bad Drug flag just in case not set in enhanced check, possibly because Dosage edits are done first
"RTN","PSODOSUT",56,0)
 N PSODLBD1,PSODLBD3
"RTN","PSODOSUT",57,0)
 I PSODLERB["GCNSEQNO"!(PSODLERB["Drug not matched to NDF") D
"RTN","PSODOSUT",58,0)
 .S PSODLBD1=$O(^TMP($J,"PSOPDOSA","OUT","EXCEPTIONS","DOSE",PSODSEQ,PSODLNN1,"")) I PSODLBD1 D
"RTN","PSODOSUT",59,0)
 ..S PSODLBD3=$P($G(^TMP($J,"PSOPDOSA","OUT","EXCEPTIONS","DOSE",PSODSEQ,PSODLNN1,PSODLBD1)),"^",3) I PSODLBD3 S PSODRUG("BAD",PSODLBD3)=1
"RTN","PSODOSUT",60,0)
 Q
"RTN","PSODOSUT",61,0)
 ;
"RTN","PSODOSUT",62,0)
EXCEPT ;don't show "not matched to NDF" or "no GCNSEQNO" errors for dosing - when dosage is edited enhanced order checks are performed again so we don't want to display these type messages for dosing.
"RTN","PSODOSUT",63,0)
 N PSODLER1,PSODLER2
"RTN","PSODOSUT",64,0)
 F PSODLER1=0:0 S PSODLER1=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLER1)) Q:'PSODLER1  D
"RTN","PSODOSUT",65,0)
 .S PSODLER2=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLER1))
"RTN","PSODOSUT",66,0)
 .I PSODLER2["Drug not matched to NDF"!(PSODLER2["GCNSEQNO") D
"RTN","PSODOSUT",67,0)
 .. S PSODLER3="" F PSODLER3=PSODLER1-1:1:PSODLER1 K ^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLER3)
"RTN","PSODOSUT",68,0)
 Q
"RTN","PSODOSUT",69,0)
 ;
"RTN","PSODOSUT",70,0)
FEED() ; Write Line feed after Exceptions if no message globals follow, and next order has no errors or exceptions, only a message
"RTN","PSODOSUT",71,0)
 I PSODLQT Q 0
"RTN","PSODOSUT",72,0)
 N PSODLNN2
"RTN","PSODOSUT",73,0)
 I $D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE")) Q 0
"RTN","PSODOSUT",74,0)
 S PSODLNN2=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1))
"RTN","PSODOSUT",75,0)
 I PSODLNN2="" Q 0
"RTN","PSODOSUT",76,0)
 I $D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN2,"ERROR")) Q 0
"RTN","PSODOSUT",77,0)
 I $D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN2,"EXCEPTIONS")) Q 0
"RTN","PSODOSUT",78,0)
 Q 1
"RTN","PSODOSUT",79,0)
 ;
"RTN","PSODOSUT",80,0)
DCHKN ;Called from PSOORNEW, PSOORNE1 & PSOORNEW; Dose Check for Copying an Order
"RTN","PSODOSUT",81,0)
 N PSOGENF
"RTN","PSODOSUT",82,0)
 S PSOGENF=0
"RTN","PSODOSUT",83,0)
 F PSOCPXA=0:0 S PSOCPXA=$O(PSONEW("DOSE",PSOCPXA)) Q:'PSOCPXA  S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",84,0)
 D FIN^PSODOSCL(.PSODLBS1,.PSONEW,.PSODRUG)
"RTN","PSODOSUT",85,0)
 S PSODLNVL=$$DOSE^PSODOSUN K ^TMP($J,"PSOPDOSN") K ^TMP($J,"PSOPDOSA")
"RTN","PSODOSUT",86,0)
 I $P($G(PSODLNVL),"^")=1 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",87,0)
 I '$G(PSODLNVL) Q
"RTN","PSODOSUT",88,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^") ^TMP("PSODOSF",$J,0)=1 Q
"RTN","PSODOSUT",89,0)
 S PSODLNVT=$P(PSODLNVL,"^",2)
"RTN","PSODOSUT",90,0)
 I +PSODLNVL=3 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",91,0)
 ;I +PSODLNVL=3 D CANCEL(PSONEW("OIRXN")) Q  ;CR2724
"RTN","PSODOSUT",92,0)
 I +$G(PSOGENF) Q  ;Do not do intervention on a single General Dose message.
"RTN","PSODOSUT",93,0)
 I $$EN3^PSORXI(PSODLNVT) W !!,"Unable to log intervention, cannot find intervention type.",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODOSUT",94,0)
 Q
"RTN","PSODOSUT",95,0)
 ;
"RTN","PSODOSUT",96,0)
DCHKR ;Renewal Dose Check; Called from PSORENW0
"RTN","PSODOSUT",97,0)
 N PSOGENF
"RTN","PSODOSUT",98,0)
 S PSOGENF=0
"RTN","PSODOSUT",99,0)
 F PSOCPXA=0:0 S PSOCPXA=$O(PSORENW("DOSE",PSOCPXA)) Q:'PSOCPXA  S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",100,0)
 D FIN^PSODOSCL(.PSODLBS1,.PSORENW,.PSODRUG)
"RTN","PSODOSUT",101,0)
 S PSODLNVL=$$DOSE^PSODOSUN
"RTN","PSODOSUT",102,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^") ^TMP("PSODOSF",$J,0)=1
"RTN","PSODOSUT",103,0)
 K ^TMP($J,"PSOPDOSN") K ^TMP($J,"PSOPDOSA") I $P($G(PSODLNVL),"^")=1 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",104,0)
 D DOSIV
"RTN","PSODOSUT",105,0)
 Q
"RTN","PSODOSUT",106,0)
 ;
"RTN","PSODOSUT",107,0)
DCHKC ;Dose Check on reinstate; Called from PSOCAN2
"RTN","PSODOSUT",108,0)
 N PSODCAN,PSOGENF
"RTN","PSODOSUT",109,0)
 S PSOGENF=0
"RTN","PSODOSUT",110,0)
 I '$D(PSODRUG("IEN")) S:$D(PSORENW("OIRXN")) PSODRUG("IEN")=$$GET1^DIQ(52,PSORENW("OIRXN"),6,"I")
"RTN","PSODOSUT",111,0)
 S PSOCPXB=0 F PSOCPXA=0:0 S PSOCPXA=$O(^PSRX(PSORENW("OIRXN"),6,PSOCPXA)) Q:'PSOCPXA  I $P($G(^PSRX(PSORENW("OIRXN"),6,PSOCPXA,0)),"^")'="" S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",112,0)
 D RX^PSODOSCL(.PSODLBS1,PSORENW("OIRXN"))
"RTN","PSODOSUT",113,0)
 S PSODLNNN=PSORENW("OIRXN"),PSODCAN=1
"RTN","PSODOSUT",114,0)
 S PSODLNVL=$$DOSE^PSODOSUN K ^TMP($J,"PSOPDOSN"),^TMP($J,"PSOPDOSA")
"RTN","PSODOSUT",115,0)
 I $P($G(PSODLNVL),"^")=1 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",116,0)
 D DOSIV
"RTN","PSODOSUT",117,0)
 I +PSODLNVL=3 S PSORX("DFLG")=1
"RTN","PSODOSUT",118,0)
 Q
"RTN","PSODOSUT",119,0)
 ;
"RTN","PSODOSUT",120,0)
DCHK() ;Dose check after entering Null at the conjunction prompt
"RTN","PSODOSUT",121,0)
 ;For complex Dosing, they will eventually enter null too, so change to call if it was not a complex order, and null was entered
"RTN","PSODOSUT",122,0)
 N PSODONOF S PSODONOF="" D DOSEOFF Q:'+PSODONOF 0
"RTN","PSODOSUT",123,0)
 Q:$G(PSORX("DFLG")) 0
"RTN","PSODOSUT",124,0)
 ;D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG")) 0
"RTN","PSODOSUT",125,0)
 N PSODLNNN,PSODLENT,PSODLNVL,PSODLNVT,X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT,PSODLBS1,PSODLENT,PSOCPXA,PSOCPXV,PSOTOF,PSOCPXB,PSOGENF,PSOEDDOS
"RTN","PSODOSUT",126,0)
 S PSOGENF=0
"RTN","PSODOSUT",127,0)
 I $G(PSOEDIT) S PSOEDDOS=1
"RTN","PSODOSUT",128,0)
 ;Need to make sure Drug Name is what you set in the API
"RTN","PSODOSUT",129,0)
 ;Either pass in name here, or set in PSODOSCL to array name that PSSDSAPD uses, which is still the .01 of File 50
"RTN","PSODOSUT",130,0)
 I $$EXMT^PSSDSAPI(PSODRUG("IEN")) Q 0
"RTN","PSODOSUT",131,0)
 I $G(PSODRUG("BAD",PSODRUG("IEN"))) Q 0
"RTN","PSODOSUT",132,0)
 ;Currently only one prospective drug at a time for Outpatient Dose Check
"RTN","PSODOSUT",133,0)
 ;S PSODLNNN="O;1;PROSPECTIVE;1"
"RTN","PSODOSUT",134,0)
 K ^TMP("PSODOSF",$J)
"RTN","PSODOSUT",135,0)
 K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN") S PSODLBS1(1)="PSOPDOSA",PSODLBS1(3)="PSOPDOSN"
"RTN","PSODOSUT",136,0)
 D FIN^PSODOSCL(.PSODLBS1,.PSORXED,.PSODRUG)
"RTN","PSODOSUT",137,0)
 S PSODLENT=ENT,PSOCPXV=1,PSOCPXB=0
"RTN","PSODOSUT",138,0)
 S PSOCPXB=0 F PSOCPXA=0:0 S PSOCPXA=$O(PSORXED("DOSE",PSOCPXA)) Q:'PSOCPXA  S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",139,0)
 S PSODLNVL=$$DOSEX^PSODOSUN(PSODLENT) S PSOTOF=1 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^") ^TMP("PSODOSF",$J,0)=1
"RTN","PSODOSUT",140,0)
 I $G(PSOEDDOS) D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG")) 0
"RTN","PSODOSUT",141,0)
 I $P($G(PSODLNVL),"^")=1 K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN") Q 1   ;turn of general dosing flag because Intervention is needed
"RTN","PSODOSUT",142,0)
DCHK2 ;Finishing of a complex order
"RTN","PSODOSUT",143,0)
 N PSOCPXC,PSOCPXD
"RTN","PSODOSUT",144,0)
 K PSODLNVL
"RTN","PSODOSUT",145,0)
 S PSOCPXD=1 ;flag for MOCHA 2.0, used to not display enter to continue prompt after errors/exceptions list which displays just after last dose sequence.  MOCHA 2.0 does not display errors or exceptions.
"RTN","PSODOSUT",146,0)
 ;S (PSOCPXB)=0 ;setting PSOCPXB=0 makes dosing summery not display when cycling through individual doses of a complex order.  Dose summary should only show after accept of order.
"RTN","PSODOSUT",147,0)
 S PSODLNVL=$$DOSEZ^PSODOSUN K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN")
"RTN","PSODOSUT",148,0)
 I $G(PSOEDDOS) D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG")) 0
"RTN","PSODOSUT",149,0)
 I $P($G(PSODLNVL),"^")=1 Q 1
"RTN","PSODOSUT",150,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^")=2 ^TMP("PSODOSF",$J,0)=$$CONVMSG($P(PSODLNVL,"^",2)) W ! Q 0
"RTN","PSODOSUT",151,0)
 I '$G(PSODLNVL) Q 0
"RTN","PSODOSUT",152,0)
 S PSODLNVT=$P(PSODLNVL,"^",2)
"RTN","PSODOSUT",153,0)
 I $D(PSORX("EDIT"))!($G(PSORXED)&$G(PSORXED)&$G(PSOEDDOS))!($G(PSOCOPY)&$G(PSODLBD4)) Q 0
"RTN","PSODOSUT",154,0)
 I +$G(PSOGENF) Q 0  ;Do not do intervention on a single General Dose message.
"RTN","PSODOSUT",155,0)
 I $$EN3^PSORXI(PSODLNVT) W !!,"Unable to log intervention, cannot find intervention type.",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODOSUT",156,0)
 W !
"RTN","PSODOSUT",157,0)
 Q 0
"RTN","PSODOSUT",158,0)
 ;
"RTN","PSODOSUT",159,0)
DCHK1 ;Dose check after entering a value at the Conjunction prompt
"RTN","PSODOSUT",160,0)
 Q:$G(PSORX("DFLG"))!($G(PSODLQT))
"RTN","PSODOSUT",161,0)
 N PSODONOF S PSODONOF="" D DOSEOFF Q:'+PSODONOF
"RTN","PSODOSUT",162,0)
 ;D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG"))
"RTN","PSODOSUT",163,0)
 N PSODLNNN,PSODLNVL,PSODLNVT,X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT,PSODLBS1,PSODLENT,PSOCPXB,PSOGENF
"RTN","PSODOSUT",164,0)
 S PSOGENF=0
"RTN","PSODOSUT",165,0)
 ;Need to make sure Drug Name is what you set in the API
"RTN","PSODOSUT",166,0)
 ;Either pass in name here, or set in PSODOSCL to array name that PSSDSAPD uses, which is still the .01 of File 50
"RTN","PSODOSUT",167,0)
 I $$EXMT^PSSDSAPI(PSODRUG("IEN")) Q
"RTN","PSODOSUT",168,0)
 I $G(PSODRUG("BAD",PSODRUG("IEN"))) Q
"RTN","PSODOSUT",169,0)
 ;Currently only one prospective drug at a time for Outpatient Dose Check
"RTN","PSODOSUT",170,0)
 ;S PSODLNNN="O;1;PROSPECTIVE;1"
"RTN","PSODOSUT",171,0)
 K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN") S PSODLBS1(1)="PSOPDOSA",PSODLBS1(3)="PSOPDOSN"
"RTN","PSODOSUT",172,0)
 D FIN^PSODOSCL(.PSODLBS1,.PSORXED,.PSODRUG)
"RTN","PSODOSUT",173,0)
 S PSODLENT=ENT,PSOCPXB=0
"RTN","PSODOSUT",174,0)
 F PSOCPXA=0:0 S PSOCPXA=$O(PSORXED("DOSE",PSOCPXA)) Q:'PSOCPXA  S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",175,0)
 S PSODLNVL=$$DOSEX^PSODOSUN(PSODLENT)
"RTN","PSODOSUT",176,0)
 D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG"))
"RTN","PSODOSUT",177,0)
 K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN") I $P($G(PSODLNVL),"^")=1 S PSORXED("DFLG")=1 Q
"RTN","PSODOSUT",178,0)
 I '$G(PSODLNVL) Q
"RTN","PSODOSUT",179,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^")=2 ^TMP("PSODOSF",$J,0)=$$CONVMSG($P(PSODLNVL,"^",2)) W ! Q
"RTN","PSODOSUT",180,0)
 S PSODLNVT=$P(PSODLNVL,"^",2)
"RTN","PSODOSUT",181,0)
 I +$G(PSOGENF) Q  ;Do not do intervention on a single General Dose message.
"RTN","PSODOSUT",182,0)
 I $$EN3^PSORXI(PSODLNVT) W !!,"Unable to log intervention, cannot find intervention type.",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODOSUT",183,0)
 W !
"RTN","PSODOSUT",184,0)
 Q
"RTN","PSODOSUT",185,0)
 ;
"RTN","PSODOSUT",186,0)
CONVMSG(MESS) ;Convert DOSE CHECK message to numeric value for field 8 of ^PS(52.4
"RTN","PSODOSUT",187,0)
 ;For MOCHA 2.0, only returning "DOSAGE EXCEEDS MAX SINGLE DOSE" when a dosing error is present.
"RTN","PSODOSUT",188,0)
 N PSODOSF
"RTN","PSODOSUT",189,0)
 S MESS="DOSAGE EXCEEDS MAX SINGLE DOSE AND/OR MAX DAILY DOSE"
"RTN","PSODOSUT",190,0)
 S PSODOSF=$S(MESS="DOSAGE EXCEEDS MAX SINGLE DOSE AND/OR MAX DAILY DOSE":4,MESS="MAX SINGLE DOSE & MAX DAILY DOSE":3,MESS="MAX SINGLE DOSE":2,MESS="MAX DAILY DOSE":1,1:"")
"RTN","PSODOSUT",191,0)
 Q PSODOSF
"RTN","PSODOSUT",192,0)
 ;
"RTN","PSODOSUT",193,0)
DCHKV ;Dose check when verifying an order
"RTN","PSODOSUT",194,0)
 N PSODOSF,PSOLINE,PSOVERFL,PSOVCAN,PSOGENF
"RTN","PSODOSUT",195,0)
 S PSOVERFL=1
"RTN","PSODOSUT",196,0)
 S PSOGENF=0
"RTN","PSODOSUT",197,0)
 F PSOCPXA=0:0 S PSOCPXA=$O(^PSRX(PSONV,6,PSOCPXA)) Q:'PSOCPXA  I $P($G(^PSRX(PSONV,6,PSOCPXA,0)),"^")'="" S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",198,0)
 D RX^PSODOSCL(.PSODLBS1,PSONV)
"RTN","PSODOSUT",199,0)
 S $P(PSOLINE,"-",79)="-"
"RTN","PSODOSUT",200,0)
 S PSODLNNN=PSONV
"RTN","PSODOSUT",201,0)
 S PSODLNVL=$$DOSE^PSODOSUN K ^TMP($J,"PSOPDOSN") K ^TMP($J,"PSOPDOSA") I $P($G(PSODLNVL),"^")=1 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",202,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^")=2 ^TMP("PSODOSF",$J,0)=$$CONVMSG($P(PSODLNVL,"^",2))
"RTN","PSODOSUT",203,0)
 I '$G(PSODLNVL) Q
"RTN","PSODOSUT",204,0)
 I +PSODLNVL=3 D  Q:PSOVCAN
"RTN","PSODOSUT",205,0)
 . D SIG^XUSESIG I X1="" S (PSORX("DFLG"),PSVERFLG)=1 Q
"RTN","PSODOSUT",206,0)
 . D NOOR^PSOCAN4
"RTN","PSODOSUT",207,0)
 . I $G(DIRUT) D UPOUT^PSODGDG1,KILL^PSODGDG1 K PSONORR,PSORX("INTERVENE") Q
"RTN","PSODOSUT",208,0)
 . S PSOVCAN=1
"RTN","PSODOSUT",209,0)
 . S DA=PSONV D RXV^PSODGDG1 S DA=PSONV D INV^PSODGDG1 S DA=PSONV D PSDEL^PSODGDG1,DEL^PSODGDG1
"RTN","PSODOSUT",210,0)
 . K DIK,LST,PSONOOR S PSVERFLG=1
"RTN","PSODOSUT",211,0)
 S PSODLNVT=$P(PSODLNVL,"^",2),PSODOSF=1
"RTN","PSODOSUT",212,0)
 I +PSODLNVL=3 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",213,0)
 S DA=PSONV,RX=$G(^PSRX(PSONV,0)) D DOSIV  ;CRI^PSODGDG1
"RTN","PSODOSUT",214,0)
 Q
"RTN","PSODOSUT",215,0)
 ;
"RTN","PSODOSUT",216,0)
DOSIV ;DOSE INTERVENTION
"RTN","PSODOSUT",217,0)
 I PSOFROM="C",'$D(^XUSEC("PSORPH",DUZ)) Q
"RTN","PSODOSUT",218,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^")=2 ^TMP("PSODOSF",$J,0)=$$CONVMSG($P(PSODLNVL,"^",2)) Q
"RTN","PSODOSUT",219,0)
 I '$G(PSODLNVL) Q
"RTN","PSODOSUT",220,0)
 S PSODLNVT=$P(PSODLNVL,"^",2)
"RTN","PSODOSUT",221,0)
DOSIV1 ;
"RTN","PSODOSUT",222,0)
 I +$G(PSOGENF) Q  ;Do not do intervention on a single General Dose message.
"RTN","PSODOSUT",223,0)
 I $$EN3^PSORXI(PSODLNVT) D
"RTN","PSODOSUT",224,0)
 . W !!,"Unable to log intervention, cannot find intervention type.",!
"RTN","PSODOSUT",225,0)
 . K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODOSUT",226,0)
 Q
"RTN","PSODOSUT",227,0)
 ;
"RTN","PSODOSUT",228,0)
CANCEL(PSONV) ;CR2724 -  where PSONV = RXIEN 
"RTN","PSODOSUT",229,0)
 D SIG^XUSESIG I X1="" S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",230,0)
 D NOOR^PSOCAN4
"RTN","PSODOSUT",231,0)
 I $G(DIRUT) D UPOUT^PSODGDG1,KILL^PSODGDG1 K PSONORR,PSORX("INTERVENE") Q
"RTN","PSODOSUT",232,0)
 S DA=PSONV D INV^PSODGDG1 S DA=PSONV D PSDEL^PSODGDG1,DEL^PSODGDG1
"RTN","PSODOSUT",233,0)
 K DIK,LST,PSONOOR
"RTN","PSODOSUT",234,0)
 Q
"RTN","PSODOSUT",235,0)
 ;
"RTN","PSODOSUT",236,0)
DOSCK(PSOFROM,MSG) ;
"RTN","PSODOSUT",237,0)
 ;D HD
"RTN","PSODOSUT",238,0)
 N PSODONOF S PSODONOF="" D DOSEOFF Q:'+PSODONOF
"RTN","PSODOSUT",239,0)
 I $G(PSORX("DFLG"))!($G(PSODOSD)) S PSORX("DFLG")=1 K PSODOSD Q
"RTN","PSODOSUT",240,0)
 N PSODLNNN,PSODLNVL,PSODLNVT,X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT,PSODLBS1,PSOCPXA,PSOCPXB,PSOCPXC
"RTN","PSODOSUT",241,0)
 Q:$$EXMT^PSSDSAPI(PSODRUG("IEN"))
"RTN","PSODOSUT",242,0)
 Q:$G(PSODRUG("BAD",PSODRUG("IEN")))
"RTN","PSODOSUT",243,0)
 K ^TMP($J,"PSOPDOSN"),^TMP($J,"PSOPDOSA"),^TMP("PSODOSF",$J) S PSODLBS1(1)="PSOPDOSA",PSODLBS1(3)="PSOPDOSN"
"RTN","PSODOSUT",244,0)
 I ($D(DTOUT))!($D(DUOUT))!($G(DIRUT))!($G(PSODLQT)) K PSODLQT,DTOUT,DUOUT,DIRUT,PSORX("DFLG") Q
"RTN","PSODOSUT",245,0)
 ;D CLEAR^VALM1
"RTN","PSODOSUT",246,0)
 S PSOCPXB=0
"RTN","PSODOSUT",247,0)
 I PSOFROM="V" D DCHKV Q  ;PSOVER1 - verification 
"RTN","PSODOSUT",248,0)
 I PSOFROM="N" D DCHKN Q  ;PSOORNE1 & PSOORNEW - new & copy
"RTN","PSODOSUT",249,0)
 I PSOFROM="R" D DCHKR Q  ;PSORENW0 - renewal
"RTN","PSODOSUT",250,0)
 I PSOFROM="C" D DCHKC Q  ;PSOCAN2 - cancel
"RTN","PSODOSUT",251,0)
 Q
"RTN","PSODOSUT",252,0)
 ;
"RTN","PSODOSUT",253,0)
RCONVMS(MESS) ;Convert DOSE CHECK from numeric to alpha
"RTN","PSODOSUT",254,0)
 N PSODOSF
"RTN","PSODOSUT",255,0)
 S MESS=4  ;For MOCHA 2.0, only returning "DOSAGE EXCEEDS MAX SINGLE DOSE" when a dosing error is present.
"RTN","PSODOSUT",256,0)
 S PSODOSF=$S(MESS=4:"DOSAGE EXCEEDS MAX SINGLE DOSE AND/OR MAX DAILY DOSE",MESS=3:"MAX SINGLE DOSE & DAILY DOSE RANGE",MESS=2:"MAX SINGLE DOSE",MESS=1:"DAILY DOSE RANGE",1:"")
"RTN","PSODOSUT",257,0)
 Q PSODOSF
"RTN","PSODOSUT",258,0)
 ;
"RTN","PSODOSUT",259,0)
DOSEOFF ;
"RTN","PSODOSUT",260,0)
 S PSODONOF=$$DS^PSSDSAPI
"RTN","PSODOSUT",261,0)
DOSEOFF2 ;
"RTN","PSODOSUT",262,0)
 I $G(PSORX("DOSING OFF")),+PSODONOF K PSORX("DOSING OFF"),PSOREINF,PSOONOFC Q
"RTN","PSODOSUT",263,0)
 Q:+PSODONOF
"RTN","PSODOSUT",264,0)
 I ($G(PSOONOFC)!$G(PSOREINF)),'+PSODONOF S PSORX("DOSING OFF")=1  ;Reinstate news PSORX array so have to work around it
"RTN","PSODOSUT",265,0)
 Q:$G(PSORX("DOSING OFF"))  ;only display 'dosing off' message once per patient 
"RTN","PSODOSUT",266,0)
 N PSODOFFC
"RTN","PSODOSUT",267,0)
 I '+PSODONOF&($P(PSODONOF,"^",2)'="") D
"RTN","PSODOSUT",268,0)
 .S X=$P(PSODONOF,"^",2),DIWL=1,DIWR=73 K ^UTILITY($J,"W") D ^DIWP W !
"RTN","PSODOSUT",269,0)
 .S PSODOFFC=0 F PSODOFFC=0:0 S PSODOFFC=$O(^UTILITY($J,"W",DIWL,PSODOFFC)) Q:'PSODOFFC  W !?5,$G(^UTILITY($J,"W",DIWL,PSODOFFC,0))
"RTN","PSODOSUT",270,0)
 .N DIR,DIRUT,DUOUT,X,Y S DIR(0)="E"
"RTN","PSODOSUT",271,0)
 .S DIR("A")="Press Return to continue...",DIR("?")="Press Return to continue"
"RTN","PSODOSUT",272,0)
 .W ! D ^DIR K DIRUT,DUOUT,DIR,X,Y W !
"RTN","PSODOSUT",273,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUT",274,0)
 .S PSORX("DOSING OFF")=1 S:$G(PSOREINS) (PSOREINF,PSOONOFC)=1  ;set this flag to only display 'dosing off' message once per session. 
"RTN","PSODOSUT",275,0)
 Q
"RTN","PSOORED3")
0^7^B66487001
"RTN","PSOORED3",1,0)
PSOORED3 ;BIR/SAB-edit finished orders through backdoor ;10/20/06 11:09am
"RTN","PSOORED3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,78,99,117,133,148,249,251,379,378,372,416,313,444,402**;DEC 1997;Build 8
"RTN","PSOORED3",3,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOORED3",4,0)
 ;External reference to PS(51.2 supported by DBIA 2226 
"RTN","PSOORED3",5,0)
 ;called from psoored2
"RTN","PSOORED3",6,0)
 D DOLST
"RTN","PSOORED3",7,0)
 ;
"RTN","PSOORED3",8,0)
DOSE ;adds dosing info
"RTN","PSOORED3",9,0)
 I '$G(PSORXED("ENT")) F  S I=$O(PSORXED("DOSE",I)) Q:'I  S PSORXED("ENT")=$G(PSORXED("ENT"))+1
"RTN","PSOORED3",10,0)
 K ROU,UNITN,STRE,PSODOSE,RTE,NOUN,VERB M PSODOSE=PSORXED
"RTN","PSOORED3",11,0)
 D KV K FIELD,DOSEOR,DOOR,X,Y,UNITS S ENT=1
"RTN","PSOORED3",12,0)
ASK S ROU="PSOORED3" D ASK^PSOBKDED K ROU I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED3",13,0)
 G:$D(DIRUT) EXQ
"RTN","PSOORED3",14,0)
 I $G(QUIT)]"" K QUIT,ROU Q
"RTN","PSOORED3",15,0)
 ;
"RTN","PSOORED3",16,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED3",17,0)
VER D VER^PSOOREDX I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED3",18,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",19,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED3",20,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED3",21,0)
DUPD ;
"RTN","PSOORED3",22,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED3",23,0)
 D DUPD^PSOOREDX
"RTN","PSOORED3",24,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:"") S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED3",25,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED3",26,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",27,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED3",28,0)
 D STR^PSOOREDX
"RTN","PSOORED3",29,0)
NOU1 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOORED3",30,0)
 D CNON
"RTN","PSOORED3",31,0)
 N PSONDEF
"RTN","PSOORED3",32,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOORED3",33,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED3",34,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",35,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED3",36,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED3",37,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED3",38,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED3",39,0)
RTE S:$G(PSORXED("ROUTE",ENT))']"" DRET=1
"RTN","PSOORED3",40,0)
 K JUMP S ROU="PSOORED3" D RTE^PSOBKDED K ROU
"RTN","PSOORED3",41,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED3",42,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",43,0)
 I $G(QUIT) K QUIT,ROU Q
"RTN","PSOORED3",44,0)
 ;
"RTN","PSOORED3",45,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED3",46,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",47,0)
 S SCH=$$SCHASL^PSOORED5(Y) D SCH^PSOSIG I $G(SCH)']""!($D(DTOUT))!($D(DUOUT)) G SCH
"RTN","PSOORED3",48,0)
 S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED3",49,0)
 S:$G(PSORXED("ENT"))<ENT PSORXED("ENT")=ENT
"RTN","PSOORED3",50,0)
 ;
"RTN","PSOORED3",51,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN MONTHS, WEEKS, DAYS, HOURS OR MINUTES)"
"RTN","PSOORED3",52,0)
 S DIR("B")=$S($G(DUR)]"":DUR,$G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED3",53,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED3",54,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",55,0)
 D DUR1^PSOOREDX
"RTN","PSOORED3",56,0)
 ;
"RTN","PSOORED3",57,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED3",58,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",59,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED3",60,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED3",61,0)
 I X="@" D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOORED3",62,0)
 ;
"RTN","PSOORED3",63,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED3",64,0)
 I '$$DUROK(.PSORXED,ENT) D  G DUR
"RTN","PSOORED3",65,0)
 . W !!,"Duration is required for the dosage entered prior to the THEN conjunction.",$C(7),!
"RTN","PSOORED3",66,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSORXED("DFLG"))!($G(PSORX("DFLG"))) EXQ S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED3",67,0)
 E  K PSOCKCON I $$DCHK^PSODOSUT S PSOQUIT=1 G EXQ
"RTN","PSOORED3",68,0)
 I PSOSAVX="",$G(PSORXED)!$D(PSOEDDOS) K PSOCKCON
"RTN","PSOORED3",69,0)
 K PSOSAVX
"RTN","PSOORED3",70,0)
 ;
"RTN","PSOORED3",71,0)
 S DENT=$O(PSORXED("DOSE",ENT)) I DENT,(ENT+1)'=DENT D
"RTN","PSOORED3",72,0)
 .K PSORXED("DOSE",DENT),PSORXED("NOUN",DENT),PSORXED("VERB",DENT),PSORXED("DOSE ORDERED",DENT),PSORXED("ROUTE",DENT),PSORXED("ODOSE",DENT)
"RTN","PSOORED3",73,0)
 .K PSORXED("SCHEDULE",DENT),PSORXED("DURATION",DENT),PSORXED("CONJUNCTION",DENT),DENT
"RTN","PSOORED3",74,0)
 I $G(FIELD)]"" K FIELD S QUIT=1
"RTN","PSOORED3",75,0)
 I $O(^PSRX(PSORXED("IRXN"),"INS1",0)) D
"RTN","PSOORED3",76,0)
 .F D=0:0 S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORED3",77,0)
 D EN^PSOFSIG(.PSORXED) D VER^PSOORED7:'$G(PSOVER) I $G(CKX),'$G(PSOSIGFL) D M1 K CKX
"RTN","PSOORED3",78,0)
 S:'$D(PSORXED("DAYS SUPPLY")) PSORXED("DAYS SUPPLY")=$P(PSORXED("RX0"),"^",8)
"RTN","PSOORED3",79,0)
 ; Checks if the current Days Supply value is greater than the Maximum Days Supply for the Drug, if so, reset
"RTN","PSOORED3",80,0)
 D DAYSUP^PSOUTIL(+$G(PSODRUG("IEN")),.PSORXED,0)
"RTN","PSOORED3",81,0)
 ;Needed to calculate QTY
"RTN","PSOORED3",82,0)
 K QTY,QTYHLD S QTYHLD=$P(PSORXED("RX0"),"^",7) D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED3",83,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED3",84,0)
 I $G(PSOSIGFL)=1 S PSORXED("ENT")=ENT,SIGOK=1 G EX1
"RTN","PSOORED3",85,0)
 K QTYHLD Q:$G(PSOVER)!($G(PSOREEDQ))
"RTN","PSOORED3",86,0)
UDSIG I $O(SIG(0)) D
"RTN","PSOORED3",87,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSOORED3",88,0)
 .S (A,I)=0 F  S I=$O(^PSRX(PSORXED("IRXN"),"A",I)) Q:'I  S A=A+1
"RTN","PSOORED3",89,0)
 .D NOW^%DTC I $G(QTY) S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^Quantity Updated "_"("_$P(^PSRX(PSORXED("IRXN"),0),"^",7)_")",$P(^PSRX(PSORXED("IRXN"),0),"^",7)=$G(PSORXED("QTY")) K QTY
"RTN","PSOORED3",90,0)
 .S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^New Dosing Instructions Added",^PSRX(PSORXED("IRXN"),"A",A,1)="ORIGINAL SIG^" D
"RTN","PSOORED3",91,0)
 ..I '$P($G(^PSRX(PSORXED("IRXN"),"SIG")),"^",2) S $P(^PSRX(PSORXED("IRXN"),"A",A,1),"^",2)=$P($G(^PSRX(PSORXED("IRXN"),"SIG")),"^") Q
"RTN","PSOORED3",92,0)
 ..F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S ^PSRX(PSORXED("IRXN"),"A",A,2,I,0)=^PSRX(PSORXED("IRXN"),"SIG1",I,0),^PSRX(PSORXED("IRXN"),"A",A,2,0)="^52.34A^"_I_"^"_I
"RTN","PSOORED3",93,0)
 .S ^PSRX(PSORXED("IRXN"),"SIG")="^1"
"RTN","PSOORED3",94,0)
 .K SIG,A,I
"RTN","PSOORED3",95,0)
 S ^PSRX(PSORXED("IRXN"),6,0)="^52.0113^"_ENT_"^"_ENT
"RTN","PSOORED3",96,0)
 F I=1:1:ENT S ^PSRX(PSORXED("IRXN"),6,I,0)=PSORXED("DOSE",I)_"^"_$G(PSORXED("DOSE ORDERED",I))_"^"_$G(PSORXED("UNITS",I))_"^"_$G(PSORXED("NOUN",I))_"^" D
"RTN","PSOORED3",97,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,0)=^PSRX(PSORXED("IRXN"),6,I,0)_$G(PSORXED("DURATION",I))_"^"_$G(PSORXED("CONJUNCTION",I))_"^"_$G(PSORXED("ROUTE",I))_"^"_$G(PSORXED("SCHEDULE",I))_"^"_$G(PSORXED("VERB",I))
"RTN","PSOORED3",98,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,1)=$G(PSORXED("ODOSE",I))
"RTN","PSOORED3",99,0)
 S ^PSRX(PSORXED("IRXN"),"POE")=1
"RTN","PSOORED3",100,0)
 G EX
"RTN","PSOORED3",101,0)
 Q
"RTN","PSOORED3",102,0)
EX ;
"RTN","PSOORED3",103,0)
 K PSORXED("DOSE"),DOSE,DUPD,SCH,PSORXED("NOUN"),PSORXED("VERB"),VERB,NOUN,PSORXED("DOSE ORDERED"),DOSEOR,PSORXED("ROUTE"),ENT,PSORTE,SIG,PSODOSE
"RTN","PSOORED3",104,0)
 K PSORXED("SCHEDULE"),PSORXED("DURATION"),PSORXED("CONJUNCTION"),DURA,X,Y,PSORXED("ODOSE")
"RTN","PSOORED3",105,0)
EX1 K STRE,UNITN,DOSE,DUPD,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSOSCH,ERTE,ROU
"RTN","PSOORED3",106,0)
KV K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOORED3",107,0)
 Q
"RTN","PSOORED3",108,0)
EXQ K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) S PSORXED("DFLG")=1 D M1 G EX
"RTN","PSOORED3",109,0)
 Q
"RTN","PSOORED3",110,0)
M1 D M1^PSOOREDX
"RTN","PSOORED3",111,0)
 Q
"RTN","PSOORED3",112,0)
DOLST1(PSORXED) ;
"RTN","PSOORED3",113,0)
 ;
"RTN","PSOORED3",114,0)
DOLST F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),6,I)) Q:'I  S INST=^(I,0) D
"RTN","PSOORED3",115,0)
 .S PSORXED("DOSE",I)=$P(INST,"^"),PSORXED("DOSE ORDERED",I)=$P(INST,"^",2),PSORXED("UNITS",I)=$P(INST,"^",3),PSORXED("NOUN",I)=$P(INST,"^",4)
"RTN","PSOORED3",116,0)
 .I $P(INST,"^",5)]"" D
"RTN","PSOORED3",117,0)
 ..S PSORXED("DURATION",I)=$S($E($P(INST,"^",5),1)'?.N:$E($P(INST,"^",5),2,99)_$E($P(INST,"^",5),1),1:$P(INST,"^",5))
"RTN","PSOORED3",118,0)
 .S PSORXED("ROUTE",I)=$P(INST,"^",7),PSORXED("SCHEDULE",I)=$P(INST,"^",8)
"RTN","PSOORED3",119,0)
 .S PSORXED("CONJUNCTION",I)=$P(INST,"^",6),PSORXED("VERB",I)=$P(INST,"^",9),OLENT=I
"RTN","PSOORED3",120,0)
 .S PSORXED("ODOSE",I)=$G(^PSRX(PSORXED("IRXN"),6,I,1))
"RTN","PSOORED3",121,0)
 K:'$O(PSORXED("DOSE",0)) PSORXED("ENT"),OLENT
"RTN","PSOORED3",122,0)
 S PSORXED("INS")=$G(^PSRX(PSORXED("IRXN"),"INS"))
"RTN","PSOORED3",123,0)
 Q
"RTN","PSOORED3",124,0)
UPDSIG ;updates sig
"RTN","PSOORED3",125,0)
 K ^PSRX(PSORXED("IRXN"),"SIG1") S ^PSRX(PSORXED("IRXN"),"SIG1",0)="^52.04A^^"
"RTN","PSOORED3",126,0)
 S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1
"RTN","PSOORED3",127,0)
 S ^PSRX(PSORXED("IRXN"),"SIG")="^1"
"RTN","PSOORED3",128,0)
 Q
"RTN","PSOORED3",129,0)
JUMP ;jump to fields
"RTN","PSOORED3",130,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED3",131,0)
 D FNM^PSOOREDX
"RTN","PSOORED3",132,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED3",133,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED3",134,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED3",135,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED3",136,0)
 G EX
"RTN","PSOORED3",137,0)
 Q
"RTN","PSOORED3",138,0)
 ;
"RTN","PSOORED3",139,0)
CNON ;
"RTN","PSOORED3",140,0)
 I $G(NOUN)'="" Q
"RTN","PSOORED3",141,0)
 I '$G(PSORXED("DOSE ORDERED",ENT)) Q
"RTN","PSOORED3",142,0)
 N PSONLT,PSONLL,PSONLG
"RTN","PSOORED3",143,0)
 S PSONLL=$P($G(DOSE("DD",+$G(PSODRUG("IEN")))),"^",9) I PSONLL="" Q
"RTN","PSOORED3",144,0)
 S PSONLG=$L(PSONLL)
"RTN","PSOORED3",145,0)
 I PSONLG'>3 Q
"RTN","PSOORED3",146,0)
 S PSONLT=$E(PSONLL,(PSONLG-2),PSONLG)
"RTN","PSOORED3",147,0)
 I PSONLT'="(S)",PSONLT'="(s)" Q
"RTN","PSOORED3",148,0)
 ;test noun of (S)
"RTN","PSOORED3",149,0)
 K NOUN ; NOT SURE ABOUT THIS???
"RTN","PSOORED3",150,0)
 I $G(PSORXED("DOSE ORDERED",ENT))>1 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))_$E(PSONLT,2) Q
"RTN","PSOORED3",151,0)
 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))
"RTN","PSOORED3",152,0)
 Q
"RTN","PSOORED3",153,0)
 ;
"RTN","PSOORED3",154,0)
DUROK(DOSE,ENT) ; Duration OK? (Complex Doses only)
"RTN","PSOORED3",155,0)
 ;Input: PSORXED - array with doses
"RTN","PSOORED3",156,0)
 ;       ENT - dose entry in the PSORXED array
"RTN","PSOORED3",157,0)
 ;Output: 1: Duration OK / 0: Duration not OK (required, but missing)
"RTN","PSOORED3",158,0)
 N SCHIEN
"RTN","PSOORED3",159,0)
 I $G(DOSE("CONJUNCTION",ENT))'="T" Q 1
"RTN","PSOORED3",160,0)
 I $G(DOSE("DURATION",ENT)) Q 1
"RTN","PSOORED3",161,0)
 I $G(DOSE("SCHEDULE",ENT))="" Q 1
"RTN","PSOORED3",162,0)
 S SCHIEN=$O(^PS(51.1,"B",$G(DOSE("SCHEDULE",ENT)),0))
"RTN","PSOORED3",163,0)
 I $$GET1^DIQ(51.1,SCHIEN,5,"I")="O" Q 1
"RTN","PSOORED3",164,0)
 Q 0
"RTN","PSOORED4")
0^11^B57603808
"RTN","PSOORED4",1,0)
PSOORED4 ;BIR/SAB - Edit front door dosing ;07/13/00
"RTN","PSOORED4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,91,78,99,111,117,133,159,148,251,391,372,416,313,437,282,402**;DEC 1997;Build 8
"RTN","PSOORED4",3,0)
 ;External reference ^PS(51 supported by DBIA 2224
"RTN","PSOORED4",4,0)
 ;External reference to PS(51.2 supported by DBIA 2226
"RTN","PSOORED4",5,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOORED4",6,0)
 ;called from psoornew
"RTN","PSOORED4",7,0)
 ;
"RTN","PSOORED4",8,0)
DOSE(PSORXED) ;
"RTN","PSOORED4",9,0)
 I '$G(PSODRUG("IEN")) W !,"DRUG NAME REQUIRED!" D 2^PSOORNW1 I '$G(PSODRUG("IEN")) S VALMSG="No Dispense Drug Selected" Q
"RTN","PSOORED4",10,0)
 K ROU,STRE,UNITN,PSODOSE M PSODOSE=PSORXED
"RTN","PSOORED4",11,0)
 D KV K FIELD,DOSEOR,DUPD,X,Y,UNITS S ENT=1,OLENT=$G(PSORXED("ENT"))
"RTN","PSOORED4",12,0)
ASK I $G(ORD) W !!,"Possible SIG: " D
"RTN","PSOORED4",13,0)
 .;Coded only for outside orders with no Patient Instructions
"RTN","PSOORED4",14,0)
 .I $O(SIG(""))="",$G(ORD),$P($G(^PS(52.41,ORD,"EXT")),"^")'="" D SIGS^PSOHCPRS
"RTN","PSOORED4",15,0)
 .S INST=0 F  S INST=$O(SIG(INST)) Q:'INST  S MIG=SIG(INST) D
"RTN","PSOORED4",16,0)
 ..F SG=1:1:$L(MIG," ") W:$X+$L($P(MIG," ",SG)_" ")>IOM !?14 W $P(MIG," ",SG)_" "
"RTN","PSOORED4",17,0)
 K SG,INST,MIG
"RTN","PSOORED4",18,0)
 S ROU="PSOORED4",II=ENT D ASK^PSOBKDED K ROU,II I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED4",19,0)
 G:$D(DIRUT) EXQ
"RTN","PSOORED4",20,0)
 ;
"RTN","PSOORED4",21,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED4",22,0)
VER D VER^PSOOREDX I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED4",23,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",24,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED4",25,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED4",26,0)
DUPD ;
"RTN","PSOORED4",27,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED4",28,0)
 D DUPD^PSOOREDX
"RTN","PSOORED4",29,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:1) S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED4",30,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED4",31,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",32,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED4",33,0)
 D STR^PSOOREDX
"RTN","PSOORED4",34,0)
NOU1 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOORED4",35,0)
 D CNON^PSOORED3
"RTN","PSOORED4",36,0)
 N PSONDEF
"RTN","PSOORED4",37,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOORED4",38,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED4",39,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",40,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED4",41,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED4",42,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED4",43,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED4",44,0)
 ;
"RTN","PSOORED4",45,0)
RTE K JUMP S ROU="PSOORED4" D RTE^PSOBKDED K ROU
"RTN","PSOORED4",46,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED4",47,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",48,0)
 ;
"RTN","PSOORED4",49,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED4",50,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",51,0)
 S SCH=$$SCHASL^PSOORED5(Y) D SCH^PSOSIG I $G(SCH)']""!($D(DTOUT))!($D(DUOUT)) G SCH
"RTN","PSOORED4",52,0)
 S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED4",53,0)
 S:$G(PSORXED("ENT"))<ENT PSORXED("ENT")=ENT
"RTN","PSOORED4",54,0)
 ;
"RTN","PSOORED4",55,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN DAYS, HOURS OR MINUTES)"
"RTN","PSOORED4",56,0)
 S DIR("B")=$S($G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED4",57,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED4",58,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",59,0)
 D DUR1^PSOOREDX
"RTN","PSOORED4",60,0)
 ;
"RTN","PSOORED4",61,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED4",62,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",63,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED4",64,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED4",65,0)
 I X="@",$D(PSORXED("CONJUNCTION",ENT)) D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOORED4",66,0)
 ;
"RTN","PSOORED4",67,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED4",68,0)
 ;*437
"RTN","PSOORED4",69,0)
 I '$$DUROK^PSOORED3(.PSORXED,ENT) D  G DUR
"RTN","PSOORED4",70,0)
 . W !!,"Duration is required for the dosage entered prior to the THEN conjunction.",$C(7),!
"RTN","PSOORED4",71,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSONEW("DFLG")) EX S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED4",72,0)
 E  K PSOCKCON D DCHK1^PSODOSUT I $D(DTOUT)!($D(DUOUT)) S PSORX("DFLG")=1,PSONEW("DFLG")=1 G EX  ;don't need to print the full summary, just the last sequence. 
"RTN","PSOORED4",73,0)
 I PSOSAVX="",$G(PSORXED) K PSOCKCON,PSOEDDOS
"RTN","PSOORED4",74,0)
 K PSOSAVX
"RTN","PSOORED4",75,0)
 ;
"RTN","PSOORED4",76,0)
 S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOORED4",77,0)
 D EN^PSOFSIG(.PSORXED),VERI I $G(CKX),'$G(PSOSIGFL) D MP1 K CKX
"RTN","PSOORED4",78,0)
 I $G(PSOSIGFL)=1 D  I '$G(PSOSIGFL) Q
"RTN","PSOORED4",79,0)
 .I $D(OR0),$P(OR0,"^",24)=1 S VALMSG="Digitally Signed Order - No such changes allowed." K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D  Q
"RTN","PSOORED4",80,0)
 ..I $D(PSOBDR) K PSODRUG M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOORED4",81,0)
 .S PSORXED("ENT")=ENT,SIGOK=1,VALMSG="This change will create a new prescription!",NCPDPFLG=1
"RTN","PSOORED4",82,0)
 K QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED4",83,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED4",84,0)
 K QTYHLD
"RTN","PSOORED4",85,0)
 I '$G(PSORXED("QTY")),$P(OR0,"^",10) S PSORXED("QTY")=$P(OR0,"^",10)
"RTN","PSOORED4",86,0)
EX ;
"RTN","PSOORED4",87,0)
 K PSOBDR,PSOBDRG,PSOSCH,DUPD,STRE,UNITN,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSODOSE,OLENT,FIELD,FLDNM,AR,NM,ENT,STRE,UNITN,PSODOSE,ERTE,ROU
"RTN","PSOORED4",88,0)
KV K DTOUT,DUOUT,DIR,DIRUT
"RTN","PSOORED4",89,0)
 Q
"RTN","PSOORED4",90,0)
EXQ ;
"RTN","PSOORED4",91,0)
 K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D MP1
"RTN","PSOORED4",92,0)
 I $D(PSOBDR) M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOORED4",93,0)
 G EX Q
"RTN","PSOORED4",94,0)
MP1 D MP1^PSOOREDX
"RTN","PSOORED4",95,0)
 Q
"RTN","PSOORED4",96,0)
VERI ;checks for changes to dosing instructions
"RTN","PSOORED4",97,0)
 S ENTS=0
"RTN","PSOORED4",98,0)
 F I=0:0 S I=$O(PSORXED("DOSE",I)) Q:'I  S ENTS=$G(ENTS)+1
"RTN","PSOORED4",99,0)
 I ENTS<OLENT!(ENTS>OLENT) S PSOSIGFL=1 Q
"RTN","PSOORED4",100,0)
 F I=1:1:OLENT D
"RTN","PSOORED4",101,0)
 .I +PSODOSE("DOSE",I)'=$G(PSORXED("DOSE",I)) S PSOSIGFL=1
"RTN","PSOORED4",102,0)
 .I $G(PSODOSE("DURATION",I))]"" D
"RTN","PSOORED4",103,0)
 ..S DURATION=$S($E(PSODOSE("DURATION",I),1)'?.N:$E(PSODOSE("DURATION",I),2,99)_$E(PSODOSE("DURATION",I),1),1:PSODOSE("DURATION",I))
"RTN","PSOORED4",104,0)
 ..I +DURATION'=+$G(PSORXED("DURATION",I)) S PSOSIGFL=1
"RTN","PSOORED4",105,0)
 .I $G(PSODOSE("CONJUNCTION",I))'=$G(PSORXED("CONJUNCTION",I)) S PSOSIGFL=1
"RTN","PSOORED4",106,0)
 .I PSODOSE("ROUTE",I)'=$G(PSORXED("ROUTE",I)) S PSOSIGFL=1
"RTN","PSOORED4",107,0)
 .I PSODOSE("SCHEDULE",I)'=$G(PSORXED("SCHEDULE",I)) S PSOSIGFL=1
"RTN","PSOORED4",108,0)
 K DURATION Q
"RTN","PSOORED4",109,0)
JUMP ;jump to fields
"RTN","PSOORED4",110,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED4",111,0)
 D FNM^PSOOREDX
"RTN","PSOORED4",112,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED4",113,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED4",114,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED4",115,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED4",116,0)
 G EX
"RTN","PSOORED4",117,0)
 Q
"RTN","PSOORED4",118,0)
HLP ;help text for med route
"RTN","PSOORED4",119,0)
 D FULL^VALM1 W !,"Please enter how patient will use the medication!"
"RTN","PSOORED4",120,0)
 S DIC=51.2,X="??",DIC(0)="M",DIC("S")="I $P(^PS(51.2,+Y,0),""^"",4)" D ^DIC K DIC,X,Y
"RTN","PSOORED4",121,0)
 Q
"RTN","PSOORED4",122,0)
SCHLP ;
"RTN","PSOORED4",123,0)
 D FULL^VALM1 W !,"You can choose an entry from the Administration Schedule File (#51.1),",!,"Medication Instruction File (#51) or enter free text."
"RTN","PSOORED4",124,0)
 W !,"The free text entry cannot contain more than 2 spaces or be greater than 20",!,"characters in length."
"RTN","PSOORED4",125,0)
 W ! S DIR(0)="S^A:Administration Schedule File;M:Medication Instruction File;B:Both;F:Free Text",DIR("B")="Both"
"RTN","PSOORED4",126,0)
 S DIR("A")="Do you want to list from" D ^DIR I Y="F"!($G(DIRUT)) K X,Y G X
"RTN","PSOORED4",127,0)
 S LBL=Y G @LBL
"RTN","PSOORED4",128,0)
A ;display 51.1 entries only
"RTN","PSOORED4",129,0)
B K X,Y,DIC S X="??",DIC="^PS(51.1,",DIC(0)="QESMVZ",DIC("W")="D DICW^PSOORED4",D="APPSJ^D" W ! D MIX^DIC1
"RTN","PSOORED4",130,0)
 K DIC,X I LBL="A"!($G(DTOUT)) K LBL G X
"RTN","PSOORED4",131,0)
 I Y=-1!($G(DUOUT)) K DIR,DTOUT,DUOUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Do you want to continue with the Medication Instruction File"
"RTN","PSOORED4",132,0)
 D ^DIR I 'Y!($G(DTOUT)) K DIR,X,Y G X
"RTN","PSOORED4",133,0)
M K X,Y,DIC S DIC=51,X="??",DIC(0)="M" D ^DIC K DIC,X,Y,DTOUT,DUOUT,LBL
"RTN","PSOORED4",134,0)
 ;*282 Allow multi-word schedules
"RTN","PSOORED4",135,0)
X S DIR("?")="^D SCHLP^PSOORED4",DIR("A")="Schedule: ",DIR(0)="FA^1:20^I X[""""""""!(X?.E1C.E)!($A(X)=45)!($L(X,"" "")>$S(X[""PRN"":4,1:3))!($L(X)>20)!($L(X)<1) K X"
"RTN","PSOORED4",136,0)
 S DIR("B")=$S($D(PSOSCH)&('$D(PSORXED("SCHEDULE",ENT))):PSOSCH,$G(PSORXED("SCHEDULE",ENT))]"":PSORXED("SCHEDULE",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED4",137,0)
 Q
"RTN","PSOORED4",138,0)
DICW ;
"RTN","PSOORED4",139,0)
 S Z=$P(^PS(51.1,+Y,0),"^",5),Z=$S(Z="O":-1,Z="S":1,Z="R":-2,1:0) W:Z "  ",$S(Z>0:"SHIFT",Z=-2:"RANGE",1:"ONE-TIME")
"RTN","PSOORED4",140,0)
 I Z'<0,$D(PSJW),$D(^(PSJPP'="PSJ"+1,PSJW,0)),$P(^(0),"^",Z+2)]"" W "  ",$P(^(0),"^",Z+2)
"RTN","PSOORED4",141,0)
 ;Naked reference on DICW+2 is from DICW+1, ^PS(51.1,+Y,0)
"RTN","PSOORED4",142,0)
 Q
"RTN","PSOORED5")
0^8^B72949792
"RTN","PSOORED5",1,0)
PSOORED5 ;BIR/SAB-Rxs without dosing info ;07/20/00
"RTN","PSOORED5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,75,78,100,99,117,133,251,378,372,416,313,450,402**;DEC 1997;Build 8
"RTN","PSOORED5",3,0)
 ;^PS(51.2 - DBIA 2226
"RTN","PSOORED5",4,0)
 ;^PS(50.7 - DBIA 2223
"RTN","PSOORED5",5,0)
 ;^PSDRUG - DBIA 221
"RTN","PSOORED5",6,0)
 ;^PS(55 - DBIA 2228
"RTN","PSOORED5",7,0)
 ;called by psoored2 and psodir
"RTN","PSOORED5",8,0)
 ;pre-poe rxs and new backdoor rxs
"RTN","PSOORED5",9,0)
DOSE1(PSORXED) ;for new rxs
"RTN","PSOORED5",10,0)
DOSE ;pre-poe rx
"RTN","PSOORED5",11,0)
 D KV K ROU,STRE,FIELD,DOSEOR,DUPD,X,Y,UNITS S ENT=1,OLENT=ENT
"RTN","PSOORED5",12,0)
ASK S ROU="PSOORED5" D ASK^PSOBKDED K ROU G:$D(DIRUT) EX
"RTN","PSOORED5",13,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED5",14,0)
 I $G(QUIT)]"" K QUIT,ROU Q
"RTN","PSOORED5",15,0)
 ;
"RTN","PSOORED5",16,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED5",17,0)
 I $G(PSORX("EDIT"))']"" W:$G(PSORXED("VERB",ENT))]"" !,"VERB: "_PSORXED("VERB",ENT) G DUPD
"RTN","PSOORED5",18,0)
VER D VER^PSOOREDX
"RTN","PSOORED5",19,0)
 I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED5",20,0)
 G EX:$D(DTOUT),EXE:$D(DUOUT) I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED5",21,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED5",22,0)
DUPD ;
"RTN","PSOORED5",23,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED5",24,0)
 D KV S DIR(0)="52.0113,1",DIR("A")="DISPENSE UNITS PER DOSE"_$S($G(PSORXED("NOUN",ENT))]"":"("_PSORXED("NOUN",ENT)_")",1:"")
"RTN","PSOORED5",25,0)
 I '$G(PSORXED("DOSE",ENT)),$G(PSORXED("DOSE",ENT-1)) S PSORXED("DOSE",ENT)=PSORXED("DOSE",ENT-1)
"RTN","PSOORED5",26,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),$G(DUPD)]"":DUPD,1:"") S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED5",27,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED5",28,0)
 G EX:$D(DTOUT),EXE:$D(DUOUT)
"RTN","PSOORED5",29,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED5",30,0)
 D STR^PSOOREDX
"RTN","PSOORED5",31,0)
 ;
"RTN","PSOORED5",32,0)
NOU1 G:'$D(DUPD) RTE D CNON^PSOORED3 N PSONDEF
"RTN","PSOORED5",33,0)
 I $G(NOUN)]"",$G(PSORX("EDIT"))']"" S PSORXED("NOUN",ENT)=NOUN W !,"NOUN: "_$G(NOUN) G RTE
"RTN","PSOORED5",34,0)
 I $G(PSORX("EDIT"))']"",$G(PSORXED("NOUN",ENT))]"" W !,"NOUN: "_PSORXED("NOUN",ENT) G RTE
"RTN","PSOORED5",35,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED5",36,0)
 G EXE:$D(DTOUT)!$D(DUOUT) I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED5",37,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED5",38,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED5",39,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED5",40,0)
 ;
"RTN","PSOORED5",41,0)
RTE I $G(ENT)>1,$G(PSORX("EDIT"))']"",$G(PSORXED("ROUTE",ENT-1)),$G(PSORXED("ROUTE",ENT))']"" S PSORXED("ROUTE",ENT)=PSORXED("ROUTE",ENT-1) G SCH
"RTN","PSOORED5",42,0)
 I '$G(DRET),'$G(PSORXED("ROUTE",ENT)),$P(^PS(50.7,PSODRUG("OI"),0),"^",6) S PSORXED("ROUTE",ENT)=$P(^PS(50.7,PSODRUG("OI"),0),"^",6)
"RTN","PSOORED5",43,0)
 I $G(DRET) S PSORXED("ROUTE",ENT)=""
"RTN","PSOORED5",44,0)
 I $G(RTE) K RTE
"RTN","PSOORED5",45,0)
 D KV S DIR(0)="FO^2:45",DIR("A")="ROUTE",DIR("?")="^D HLP^PSOORED4"
"RTN","PSOORED5",46,0)
 S DIR("B")=$S($G(PSORXED("ROUTE",ENT)):$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),$G(RTE)]"":RTE,$G(DRET):"",1:"PO") K:DIR("B")="" DIR("B")
"RTN","PSOORED5",47,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="RTE" G JUMP
"RTN","PSOORED5",48,0)
 S:($D(DTOUT))!($D(DUOUT)) PSODIR("DFLG")=1 G EX:$D(DTOUT),EXE:$D(DUOUT)
"RTN","PSOORED5",49,0)
 I X="@"!(X="") K RTE,ERTE S DRET=1,PSORXED("ROUTE",ENT)="" G SCH
"RTN","PSOORED5",50,0)
 K DRET I X=$P($G(^PS(51.2,+$G(PSORXED("ROUTE",ENT)),0)),"^") S RTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),ERTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^",2) W X_" "_$G(ERTE) G SCH
"RTN","PSOORED5",51,0)
 S DIC=51.2,DIC(0)="QEZM",DIC("S")="I $P(^(0),""^"",4)" D ^DIC Q:X[U  G:Y=-1 RTE W "  "_$P(Y(0),"^",2)
"RTN","PSOORED5",52,0)
 S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2)
"RTN","PSOORED5",53,0)
 ;
"RTN","PSOORED5",54,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED5",55,0)
 G EX:$D(DTOUT),EXE:$D(DUOUT)
"RTN","PSOORED5",56,0)
 S SCH=$$SCHASL(Y) D SCH^PSOSIG I $G(SCH)']""!($D(DTOUT))!($D(DUOUT)) G SCH
"RTN","PSOORED5",57,0)
 S PSORXED("SCHEDULE",ENT)=SCH W " ("_$G(SCHEX)_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED5",58,0)
 S:$G(PSORXED("ENT"))<ENT PSORXED("ENT")=ENT
"RTN","PSOORED5",59,0)
 ;
"RTN","PSOORED5",60,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN DAYS, HOURS OR MINUTES)"
"RTN","PSOORED5",61,0)
 S DIR("B")=$S($D(DUR):DUR,$G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED5",62,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED5",63,0)
 G EX:$D(DTOUT),EXE:$D(DUOUT)
"RTN","PSOORED5",64,0)
 D DUR1^PSOOREDX
"RTN","PSOORED5",65,0)
 ;
"RTN","PSOORED5",66,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED5",67,0)
 G EX:$D(DTOUT),EXE:$D(DUOUT)
"RTN","PSOORED5",68,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED5",69,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED5",70,0)
 I X="@" D CON1^PSOOREDX G:$D(DIRUT) EX G:'Y CON S:'$G(COPY) PSOSIGFL=1 D UPD^PSOOREDX G CON
"RTN","PSOORED5",71,0)
 ;
"RTN","PSOORED5",72,0)
 I '$$DUROK^PSOORED3(.PSORXED,ENT) D  G DUR
"RTN","PSOORED5",73,0)
 . W !!,"Duration is required for the dosage entered prior to the THEN conjunction.",$C(7),!
"RTN","PSOORED5",74,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED5",75,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSORXED("DFLG"))!($G(PSORX("DFLG"))) EX S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED5",76,0)
 E  K PSOCKCON I $$DCHK^PSODOSUT S PSORXED("DFLG")=1,PSORX("DFLG")=1 G EX
"RTN","PSOORED5",77,0)
 I PSOSAVX="",$G(PSORXED)!($D(PSOEDDOS)) K PSOCKCON
"RTN","PSOORED5",78,0)
 K PSOSAVX
"RTN","PSOORED5",79,0)
 ;
"RTN","PSOORED5",80,0)
EXS ;Entry point for EXE to rebuild SIG  PSO*7.0*450
"RTN","PSOORED5",81,0)
 S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOORED5",82,0)
 D EN^PSOFSIG(.PSORXED) I $O(SIG(0)) S PSORXED("ENT")=ENT,SIGOK=1
"RTN","PSOORED5",83,0)
 Q:$G(PSOREEDT)!($G(PSOORRNW))
"RTN","PSOORED5",84,0)
 K QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED5",85,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED5",86,0)
 K QTYHLD Q:$G(PSOFROM)="NEW"!($G(COPY))!($G(PSOFROM))!($G(PSOREEDT))
"RTN","PSOORED5",87,0)
 Q:$G(PSOSIGFL)  D
"RTN","PSOORED5",88,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSOORED5",89,0)
 .S (A,I)=0 F  S I=$O(^PSRX(PSORXED("IRXN"),"A",I)) Q:'I  S A=A+1
"RTN","PSOORED5",90,0)
 .S:'$D(^PSRX(PSORXED("IRXN"),"A",0)) ^PSRX(PSORXED("IRXN"),"A",0)="^52.3DA^"
"RTN","PSOORED5",91,0)
 .S $P(^PSRX(PSORXED("IRXN"),"A",0),"^",3)=$P($G(^PSRX(PSORXED("IRXN"),"A",0)),"^",3)+1,$P(^(0),"^",4)=$P($G(^(0)),"^",4)+1
"RTN","PSOORED5",92,0)
 .D NOW^%DTC S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^New Dosing Instructions Added",^PSRX(PSORXED("IRXN"),"A",A,1)="ORIGINAL SIG^" D
"RTN","PSOORED5",93,0)
 ..I '$P(^PSRX(PSORXED("IRXN"),"SIG"),"^",2) S $P(^PSRX(PSORXED("IRXN"),"A",A,1),"^",2)=$P(^PSRX(PSORXED("IRXN"),"SIG"),"^") Q
"RTN","PSOORED5",94,0)
 ..F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S ^PSRX(PSORXED("IRXN"),"A",A,2,I,0)=^PSRX(PSORXED("IRXN"),"SIG1",I,0),^PSRX(PSORXED("IRXN"),"A",A,2,0)="^52.34A^"_I_"^"_I
"RTN","PSOORED5",95,0)
 .S ^PSRX(PSORXED("IRXN"),"SIG")="^1" K SIG,A,I
"RTN","PSOORED5",96,0)
 S ^PSRX(PSORXED("IRXN"),6,0)="^52.0113^"_ENT_"^"_ENT
"RTN","PSOORED5",97,0)
 F I=1:1:ENT S ^PSRX(PSORXED("IRXN"),6,I,0)=PSORXED("DOSE",I)_"^"_$G(PSORXED("DOSE ORDERED",I))_"^"_$G(PSORXED("UNITS",I))_"^"_$G(PSORXED("NOUN",I))_"^" D
"RTN","PSOORED5",98,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,0)=^PSRX(PSORXED("IRXN"),6,I,0)_$G(PSORXED("DURATION",I))_"^"_$G(PSORXED("CONJUNCTION",I))_"^"_$G(PSORXED("ROUTE",I))_"^"_$G(PSORXED("SCHEDULE",I))_"^"_$G(PSORXED("VERB",I))
"RTN","PSOORED5",99,0)
 .I $G(PSORXED("DOSE",I))]"" S ^PSRX(PSORXED("IRXN"),6,I,1)=PSORXED("DOSE",I)
"RTN","PSOORED5",100,0)
 S ^PSRX(PSORXED("IRXN"),"POE")=1 G EX
"RTN","PSOORED5",101,0)
 Q
"RTN","PSOORED5",102,0)
EX I $D(DUOUT)!($D(DTOUT)) S PSONEW("DFLG")=1
"RTN","PSOORED5",103,0)
 ;I $D(DUOUT)!($D(DTOUT)) S:'$G(PSORX("EDIT")) PSONEW("DFLG")=1
"RTN","PSOORED5",104,0)
 G:$G(PSOSIGFL)!($G(PSORX("EDIT")))!($G(PSORXED))!($G(PSOREEDT)) EX1
"RTN","PSOORED5",105,0)
 K PSORXED("DOSE"),PSORXED("NOUN"),PSORXED("VERB"),PSORXED("DOSE ORDERED"),PSORXED("ROUTE"),SIG,PSORXED("SCHEDULE"),PSORXED("DURATION"),PSORXED("CONJUNCTION"),PSORXED("ODOSE")
"RTN","PSOORED5",106,0)
EX1 K UNITN,STRE,DOSE,DUPD,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSOSCH,ENT,PSORTE,DURA,ERTE,ROU
"RTN","PSOORED5",107,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOORED5",108,0)
 Q
"RTN","PSOORED5",109,0)
 ;This line tag was added to check if EXit is being performed while EDITing.  If it is,
"RTN","PSOORED5",110,0)
 ;process SIG and do not delete order.  Previous calls to EX when due to $D(DUOUT) were
"RTN","PSOORED5",111,0)
 ;changed to go to this line tag instead.
"RTN","PSOORED5",112,0)
EXE I $G(PSORX("EDIT"))]"" K DUOUT G EXS  ;*PSO*7.0*450
"RTN","PSOORED5",113,0)
 G EX
"RTN","PSOORED5",114,0)
 ;
"RTN","PSOORED5",115,0)
UPD ;updates dosing array
"RTN","PSOORED5",116,0)
 D UPD^PSOORED6
"RTN","PSOORED5",117,0)
 Q
"RTN","PSOORED5",118,0)
JUMP ;
"RTN","PSOORED5",119,0)
 I $G(PSORXED("SCHEDULE",1))']"" W $C(7),!!,"All Dosing Instructions must be entered before Jumping to other Fields!",!! G @FIELD
"RTN","PSOORED5",120,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED5",121,0)
 D FNM^PSOOREDX
"RTN","PSOORED5",122,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED5",123,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED5",124,0)
 D KV
"RTN","PSOORED5",125,0)
 I $G(PSOFROM)'="NEW",'$G(COPY) S DIR("A",1)="* Indicates which fields will create a New Order"
"RTN","PSOORED5",126,0)
 S DIR("A")="Select Field by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED5",127,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED5",128,0)
 G EX
"RTN","PSOORED5",129,0)
 Q
"RTN","PSOORED5",130,0)
LAN ;
"RTN","PSOORED5",131,0)
 Q:'$G(PSODRUG("IEN"))
"RTN","PSOORED5",132,0)
 I $G(OR0),'$G(PSONEW("DOSE ORDERED",II)),$P($G(^PS(55,PSODFN,"LAN")),"^") D  K QI,QII Q
"RTN","PSOORED5",133,0)
 .Q:$G(OTHDOS(II))
"RTN","PSOORED5",134,0)
 .F QI=0:0 S QI=$O(^PSDRUG(PSODRUG("IEN"),"DOS2",QI)) Q:'QI  D  Q:$G(QII)
"RTN","PSOORED5",135,0)
 ..Q:$G(PSONEW("DOSE",II))']""
"RTN","PSOORED5",136,0)
 ..I PSONEW("DOSE",II)=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",QI,0),"^") S PSONEW("ODOSE",II)=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",QI,0),"^",4),QII=1
"RTN","PSOORED5",137,0)
 I $G(Y),$P($G(DOSE(Y)),"^",13)]"" S PSORXED("ODOSE",ENT)=$P(DOSE(Y),"^",13) Q
"RTN","PSOORED5",138,0)
 K QII F I=0:0 S I=$O(^PSDRUG(PSODRUG("IEN"),"DOS2",I)) Q:'I  I DOSE=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",I,0),"^") D  Q:$G(QII)
"RTN","PSOORED5",139,0)
 .S PSORXED("ODOSE",ENT)=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",I,0),"^",4),QII=1
"RTN","PSOORED5",140,0)
 K QII,I
"RTN","PSOORED5",141,0)
 Q
"RTN","PSOORED5",142,0)
 ;
"RTN","PSOORED5",143,0)
SCHASL(SCHA) ;
"RTN","PSOORED5",144,0)
 N SCHEA,SCHFL1 S SCHEA="",SCHFL1=0
"RTN","PSOORED5",145,0)
 ;**Lookup into the ADMINISTRATION SCHEDULE (#51.1) file 
"RTN","PSOORED5",146,0)
 K X,Y,DIC,D SET X=$G(SCHA),DIC="^PS(51.1,",DIC(0)="CEMOV",DIC("W")="W ""  ""_$G(X)_""  ""_$P(^PS(51.1,+Y,0),U,8)",D="APPSJ^D" W !,"Now searching ADMINISTRATION SCHEDULE (#51.1) file...",! D MIX^DIC1
"RTN","PSOORED5",147,0)
 K DIC,D S:Y'>0 SCHFL1=1 IF '$G(SCHFL1),'$D(DTOUT),'$D(DUOUT) SET SCHEA=$P(Y,U,2) Q SCHEA
"RTN","PSOORED5",148,0)
 I $D(DTOUT)!($D(DUOUT)) Q ""
"RTN","PSOORED5",149,0)
 I $G(SCHFL1)=1 S SCHEA=$$SCHMI(SCHA) Q SCHEA
"RTN","PSOORED5",150,0)
 Q ""
"RTN","PSOORED5",151,0)
 ;
"RTN","PSOORED5",152,0)
SCHMI(SCHM) ;
"RTN","PSOORED5",153,0)
 N SCHEM,SCHFL2 S SCHEM="",SCHFL2=0
"RTN","PSOORED5",154,0)
 ;**Lookup into the MEDICATION INSRUCTION (#51) file
"RTN","PSOORED5",155,0)
 K X,Y,DIC,D SET X=$G(SCHM),DIC="^PS(51,",DIC(0)="CEMOV",DIC("W")="W ""  ""_$G(X)_""  ""_$P(^PS(51,+Y,0),U,2)",D="A^B^D" W !,"Now searching MEDICATION INSTRUCTION (#51) file...",! D MIX^DIC1
"RTN","PSOORED5",156,0)
 K DIC,D S:Y'>0 SCHFL2=1 IF '$G(SCHFL2),'$D(DTOUT),'$D(DUOUT) SET SCHEM=$P(Y,U,2) Q SCHEM
"RTN","PSOORED5",157,0)
 ;
"RTN","PSOORED5",158,0)
 I $D(DTOUT)!($D(DUOUT)) Q ""
"RTN","PSOORED5",159,0)
 I $G(SCHFL2)=1 Q SCHM
"RTN","PSOORED5",160,0)
 Q ""
"RTN","PSOORUT2")
0^13^B105731983
"RTN","PSOORUT2",1,0)
PSOORUT2 ;ISC BHAM/SAB - build listman screen ; 3/20/07 9:47am
"RTN","PSOORUT2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,146,132,182,233,243,261,268,264,305,390,411,402**;DEC 1997;Build 8
"RTN","PSOORUT2",3,0)
 ;External reference to $$PRIAPT^SDPHARM1 supported by DBIA 4196
"RTN","PSOORUT2",4,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORUT2",5,0)
 ;External reference to ^DIC(31 supported by DBIA 658
"RTN","PSOORUT2",6,0)
 ;External reference to ^ORRDI1 supported by DBIA 4659
"RTN","PSOORUT2",7,0)
 ;External reference to ^DPT(DFN,.372 supported by DBIA 1476
"RTN","PSOORUT2",8,0)
 ;External reference to ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOORUT2",9,0)
 ;External reference to ^GMRADPT supported by DBIA 10099
"RTN","PSOORUT2",10,0)
 ;External reference to $$TERMLKUP^ORB31 supported by DBIA 5140
"RTN","PSOORUT2",11,0)
 ;External reference to $$BSA^PSSDSAPI supported by DBIA 5425
"RTN","PSOORUT2",12,0)
 ;External reference to ^ORQQVI supported by DBIA 5770
"RTN","PSOORUT2",13,0)
 ;External reference to ^ORQQLR1 supported by DBIA 5787
"RTN","PSOORUT2",14,0)
 ;External reference to ^VADPT supported by DBIA 10061
"RTN","PSOORUT2",15,0)
 ;
"RTN","PSOORUT2",16,0)
 K ^TMP("PSOHDR",$J),^TMP("PSOPI",$J) S DFN=PSODFN D ^VADPT,ADD^VADPT
"RTN","PSOORUT2",17,0)
 N I1,PSCNT,PSDIS,PSON,PSOTEL,PSOTMP
"RTN","PSOORUT2",18,0)
 S ^TMP("PSOHDR",$J,1,0)=VADM(1),^TMP("PSOHDR",$J,2,0)=$P(VADM(2),"^",2)
"RTN","PSOORUT2",19,0)
 S ^TMP("PSOHDR",$J,3,0)=$P(VADM(3),"^",2),^TMP("PSOHDR",$J,4,0)=VADM(4),^TMP("PSOHDR",$J,5,0)=$P(VADM(5),"^",2)
"RTN","PSOORUT2",20,0)
 D NVA
"RTN","PSOORUT2",21,0)
 S POERR=1 D RE^PSODEM K POERR
"RTN","PSOORUT2",22,0)
 S ^TMP("PSOHDR",$J,6,0)=$S($P(WT,"^",8):$P(WT,"^",9)_" ("_$P(WT,"^")_")",1:"_______ (______)")
"RTN","PSOORUT2",23,0)
 S ^TMP("PSOHDR",$J,7,0)=$S($P(HT,"^",8):$P(HT,"^",9)_" ("_$P(HT,"^")_")",1:"_______ (______)") K VM,WT,HT S PSOHD=7
"RTN","PSOORUT2",24,0)
 S GMRA="0^0^111" D ^GMRADPT S ^TMP("PSOHDR",$J,8,0)=+$G(GMRAL)
"RTN","PSOORUT2",25,0)
 S $P(^TMP("PSOHDR",$J,9,0)," ",62)="ISSUE  LAST REF DAY"
"RTN","PSOORUT2",26,0)
 S ^TMP("PSOHDR",$J,10,0)=" #  RX #         DRUG                                 QTY ST  DATE  "_$S($G(PSORFG):"RELD",1:"FILL")_" REM SUP"
"RTN","PSOORUT2",27,0)
 ;
"RTN","PSOORUT2",28,0)
 ;  Display CrCl/BSA - show serum creatinine if CrCl can't be calculated 
"RTN","PSOORUT2",29,0)
 S PSOBSA=$$BSA^PSSDSAPI(DFN),PSOBSA=$P(PSOBSA,"^",3),PSOBSA=$S(PSOBSA'>0:"_______",1:$J(PSOBSA,4,2)) S ^TMP("PSOHDR",$J,12,0)=PSOBSA
"RTN","PSOORUT2",30,0)
 S RSLT=$$CRCL(DFN)
"RTN","PSOORUT2",31,0)
 ; RSLT -- DATE^CRCL^Serum Creatinine -- Ex.  11/25/11^68.7^1.1
"RTN","PSOORUT2",32,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)<.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_" (CREAT: Not Found)"
"RTN","PSOORUT2",33,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"  (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSOORUT2",34,0)
 I ($P($G(RSLT),"^",2)>0)&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"(est.)"_" (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSOORUT2",35,0)
 S ^TMP("PSOHDR",$J,13,0)=ZDSPL
"RTN","PSOORUT2",36,0)
 ;
"RTN","PSOORUT2",37,0)
 D ELIG^VADPT S IEN=1,^TMP("PSOPI",$J,IEN,0)="Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:""),IEN=IEN+1
"RTN","PSOORUT2",38,0)
 S N=0 F  S N=$O(VAEL(1,N)) Q:'N  S $P(^TMP("PSOPI",$J,IEN,0)," ",14)=$P(VAEL(1,N),"^",2),IEN=IEN+1
"RTN","PSOORUT2",39,0)
 S ^TMP("PSOPI",$J,IEN,0)="",^TMP("PSOPI",$J,IEN,0)="RX PATIENT STATUS: "_$$GET1^DIQ(55,PSODFN,3),IEN=IEN+1
"RTN","PSOORUT2",40,0)
 S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Disabilities: "
"RTN","PSOORUT2",41,0)
 F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  S I1=$S($D(^DPT(DFN,.372,I,0)):^(0),1:"") D:+I1
"RTN","PSOORUT2",42,0)
 .S PSDIS=$S($P($G(^DIC(31,+I1,0)),"^")]""&($P($G(^(0)),"^",4)']""):$P(^(0),"^"),$P($G(^DIC(31,+I1,0)),"^",4)]"":$P(^(0),"^",4),1:""),PSCNT=$P(I1,"^",2)
"RTN","PSOORUT2",43,0)
 .S:$L(^TMP("PSOPI",$J,IEN,0)_PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), ")>80 IEN=IEN+1,$P(^TMP("PSOPI",$J,IEN,0)," ",14)=" "
"RTN","PSOORUT2",44,0)
 .S ^TMP("PSOPI",$J,IEN,0)=$G(^TMP("PSOPI",$J,IEN,0))_PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), "
"RTN","PSOORUT2",45,0)
 S IEN=IEN+1 S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1
"RTN","PSOORUT2",46,0)
 I +VAPA(9) S ^TMP("PSOPI",$J,IEN,0)="      (Temp Address from "_$P(VAPA(9),"^",2)_" till "_$S($P(VAPA(10),"^",2)]"":$P(VAPA(10),"^",2),1:"(no end date)")_")",IEN=IEN+1
"RTN","PSOORUT2",47,0)
 S ^TMP("PSOPI",$J,IEN,0)=VAPA(1) S:VAPA(2)]"" IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(2) S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(3)
"RTN","PSOORUT2",48,0)
 S ^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_$J("",50-$L(VAPA(3)))_"HOME PHONE: "_VAPA(8)
"RTN","PSOORUT2",49,0)
 S PSOTEL=$G(^DPT(DFN,.13))
"RTN","PSOORUT2",50,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(4),^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_$J("",50-$L(VAPA(4)))_"CELL PHONE: "_$P(PSOTEL,"^",4)
"RTN","PSOORUT2",51,0)
 S PSOTMP=$P(VAPA(5),"^",2)_"  "_$S(VAPA(11)]"":$P(VAPA(11),"^",2),1:VAPA(6)),IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=PSOTMP
"RTN","PSOORUT2",52,0)
 S ^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_$J("",50-$L(PSOTMP))_"WORK PHONE: "_$P(PSOTEL,"^",2)
"RTN","PSOORUT2",53,0)
 S MAILD=+$P($G(^PS(55,DFN,0)),"^",3) D  K MAILD
"RTN","PSOORUT2",54,0)
 .S PSOTMP="Prescription Mail Delivery: "_$S(MAILD=1:"Certified Mail",MAILD=2:"DO NOT MAIL",MAILD=3:"Local - Regular Mail",MAILD=4:"Local - Certified Mail",1:"Regular Mail") S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=PSOTMP
"RTN","PSOORUT2",55,0)
 .I MAILD<2!(MAILD>4) Q  ;ONLY FOR MAIL DELIVERIES 2,3,4
"RTN","PSOORUT2",56,0)
 .N PSOMDEXP,Y
"RTN","PSOORUT2",57,0)
 .S Y=$P($G(^PS(55,DFN,0)),"^",5)
"RTN","PSOORUT2",58,0)
 .I Y,Y'>DT D
"RTN","PSOORUT2",59,0)
 ..D DD^%DT S PSOMDEXP=Y
"RTN","PSOORUT2",60,0)
 ..S ^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_" Expire Date: "_PSOMDEXP
"RTN","PSOORUT2",61,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=$S($P($G(^PS(55,DFN,0)),"^",2):"Cannot use safety caps.",1:"") S $P(^TMP("PSOPI",$J,IEN,0)," ",40)=$S($P($G(^PS(55,DFN,0)),"^",4):"Dialysis Patient.",1:"")
"RTN","PSOORUT2",62,0)
 I $G(^PS(55,DFN,1))]"" S PSON=^(1),IEN=IEN+1 D
"RTN","PSOORUT2",63,0)
 .S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="     Outpatient Narrative: "
"RTN","PSOORUT2",64,0)
 .F I=1:1 Q:$P(PSON," ",I,99)=""  S:$L(^TMP("PSOPI",$J,IEN,0)_$P(PSON," ",I)_" ")>80 IEN=IEN+1 S ^TMP("PSOPI",$J,IEN,0)=$G(^TMP("PSOPI",$J,IEN,0))_$P(PSON," ",I)_" "
"RTN","PSOORUT2",65,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",66,0)
 I $D(^PS(52.91,DFN,0)) I '$P(^(0),"^",3)!($P(^(0),"^",3)>DT) D
"RTN","PSOORUT2",67,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Primary Care Appointment: "_$$PRIAPT^SDPHARM1(DFN)
"RTN","PSOORUT2",68,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",69,0)
 I 'GMRAL D
"RTN","PSOORUT2",70,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Allergies: "_$S(GMRAL=0:"NKA",1:"")
"RTN","PSOORUT2",71,0)
 .I GMRAL'=0 S PSONOAL="" D ALLERGY I PSONOAL'="" S ^TMP("PSOPI",$J,IEN,0)="Allergies: "_PSONOAL K PSONOAL
"RTN","PSOORUT2",72,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",73,0)
 .D REMOTE
"RTN","PSOORUT2",74,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Adverse Reactions:"
"RTN","PSOORUT2",75,0)
 D:$G(GMRAL) ^PSOORUT3
"RTN","PSOORUT2",76,0)
 K ^UTILITY("VASD",$J),VASD S DFN=PSODFN,VASD("F")=DT,VASD("T")=9999999,VASD("W")="123456789" D SDA^VADPT K VASD I $D(^UTILITY("VASD",$J)) D
"RTN","PSOORUT2",77,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Pending Clinic Appointments:"
"RTN","PSOORUT2",78,0)
 .F PSOAPP=0:0 S PSOAPP=$O(^UTILITY("VASD",$J,PSOAPP)) Q:'PSOAPP  S PSOAPPE=$G(^UTILITY("VASD",$J,PSOAPP,"E")),PSOAPPI=$G(^("I")) D
"RTN","PSOORUT2",79,0)
 ..K X S X2=DT,X1=$P($P($G(PSOAPPI),"^"),".") I $G(X1) D ^%DTC
"RTN","PSOORUT2",80,0)
 ..S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="    "_$P(PSOAPPE,"^")_"  "_$P(PSOAPPE,"^",2)_$S($P(PSOAPPI,"^",3)["C":"   *** Canceled ***",1:" ("_$G(X)_" days)")
"RTN","PSOORUT2",81,0)
 K ^UTILITY("VASD",$J),X,PSOAPPI,PSOAPPE,PSOAPP,N,PSOBSA,ZDSPL,RSLT
"RTN","PSOORUT2",82,0)
 S PSOPI=IEN K IEN
"RTN","PSOORUT2",83,0)
 Q
"RTN","PSOORUT2",84,0)
NVA ;
"RTN","PSOORUT2",85,0)
 Q:'$O(^PS(55,PSODFN,"NVA",0))
"RTN","PSOORUT2",86,0)
 K LSTDT F I=0:0 S I=$O(^PS(55,PSODFN,"NVA",I)) Q:'I  D
"RTN","PSOORUT2",87,0)
 .Q:$P(^PS(55,PSODFN,"NVA",I,0),"^",7)  Q:'$P(^PS(55,PSODFN,"NVA",I,0),"^")
"RTN","PSOORUT2",88,0)
 .I $P(^PS(55,PSODFN,"NVA",I,0),"^",10)>+$G(LSTDT) S LSTDT=$P(^(0),"^",10)
"RTN","PSOORUT2",89,0)
 I $G(LSTDT)]"" D
"RTN","PSOORUT2",90,0)
 .S LSTDT="Non-VA Meds on File - Last entry on "_$E(LSTDT,4,5)_"/"_$E(LSTDT,6,7)_"/"_$E(LSTDT,2,3)
"RTN","PSOORUT2",91,0)
 .I $G(^TMP("PSOHDR",$J,5,0))="MALE" S $P(^TMP("PSOHDR",$J,5,0)," ",22)=LSTDT K LSTDT Q
"RTN","PSOORUT2",92,0)
 .S $P(^TMP("PSOHDR",$J,5,0)," ",20)=LSTDT K LSTDT
"RTN","PSOORUT2",93,0)
 K I
"RTN","PSOORUT2",94,0)
 Q
"RTN","PSOORUT2",95,0)
REMOTE ;
"RTN","PSOORUT2",96,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOORUT2",97,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOORUT2",98,0)
 N PSORALG,REAC,S1,A,FILE,LEN,I
"RTN","PSOORUT2",99,0)
 K ^TMP($J,"PSOART")
"RTN","PSOORUT2",100,0)
 S PSORALG=1,PSORALG(1)="No remote data available"
"RTN","PSOORUT2",101,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) G REMOTE2
"RTN","PSOORUT2",102,0)
 I $T(GET^ORRDI1)]"" S PSOSIEN=$G(IEN) D GET^ORRDI1(DFN,"ART") S IEN=PSOSIEN K PSOSIEN D
"RTN","PSOORUT2",103,0)
 .I $P($G(^XTMP("ORRDI","ART",DFN,0)),"^",3)=0 S PSORALG(1)="No remote allergies"
"RTN","PSOORUT2",104,0)
 .S S1=0,LEN=65,PSORALG=1,PSORALG(1)="" F  S S1=$O(^XTMP("ORRDI","ART",DFN,S1)) Q:'S1  D
"RTN","PSOORUT2",105,0)
 ..S A=$G(^XTMP("ORRDI","ART",DFN,S1,"GMRALLERGY",0))
"RTN","PSOORUT2",106,0)
 ..S REAC=$P(A,"^",2) Q:REAC=""
"RTN","PSOORUT2",107,0)
 ..S FILE=$P($P(A,"^",3),"99VA",2)
"RTN","PSOORUT2",108,0)
 ..I FILE'=50.6,FILE'=120.82,FILE'=50.605,FILE'=50.416 Q
"RTN","PSOORUT2",109,0)
 ..S ^TMP($J,"PSOART",REAC)=""
"RTN","PSOORUT2",110,0)
 .S REAC="" F  S REAC=$O(^TMP($J,"PSOART",REAC)) Q:REAC=""  D
"RTN","PSOORUT2",111,0)
 ..I $L(PSORALG(PSORALG))+$L(REAC)<LEN S PSORALG(PSORALG)=PSORALG(PSORALG)_REAC_", " Q
"RTN","PSOORUT2",112,0)
 ..S PSORALG=PSORALG+1,PSORALG(PSORALG)="              "_REAC_", ",LEN=76
"RTN","PSOORUT2",113,0)
 .I PSORALG(PSORALG)]"",$E(PSORALG(PSORALG),$L(PSORALG(PSORALG)))="," S PSORALG(PSORALG)=$E(PSORALG(PSORALG),1,$L(PSORALG(PSORALG))-1)
"RTN","PSOORUT2",114,0)
REMOTE2 ;
"RTN","PSOORUT2",115,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="      Remote: "_$G(PSORALG(1)) D
"RTN","PSOORUT2",116,0)
 .F I=2:1:PSORALG S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=PSORALG(I)
"RTN","PSOORUT2",117,0)
 K ^TMP($J,"PSOART")
"RTN","PSOORUT2",118,0)
 Q
"RTN","PSOORUT2",119,0)
  ;
"RTN","PSOORUT2",120,0)
ALLERGY ;ALLERGIES & REACTIONS
"RTN","PSOORUT2",121,0)
 N GMRA,GMRAL,PSORY,ALCNT,EEE,PSOLG,PSOLGA,TEXT,CCC,CCC2,LENGTH
"RTN","PSOORUT2",122,0)
 K ^TMP($J,"PSOALWA")
"RTN","PSOORUT2",123,0)
 I '$D(DFN) S DFN=PSODFN
"RTN","PSOORUT2",124,0)
 S GMRA="0^0^111" D ^GMRADPT
"RTN","PSOORUT2",125,0)
 I $G(GMRAL) S PSORY=0 F  S PSORY=$O(GMRAL(PSORY)) Q:'PSORY  S ^TMP($J,"PSOALWA",$S($P(GMRAL(PSORY),"^",4):1,1:2),$S('$P(GMRAL(PSORY),"^",5):1,1:2),$P(GMRAL(PSORY),"^",7),$P(GMRAL(PSORY),"^",2))=""
"RTN","PSOORUT2",126,0)
 S ^TMP($J,"PSOAPT",1)=$G(PNM)_"  "_$G(SSNP),^(2)="Verified Allergies"
"RTN","PSOORUT2",127,0)
 S ALCNT=0,EEE=0,(PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",1,1,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",1,1,PSOLG,PSOLGA)) Q:PSOLGA=""  S EEE=1,ALCNT=ALCNT+1,^TMP($J,"PSOAPT",2,ALCNT)=PSOLGA
"RTN","PSOORUT2",128,0)
 I 'EEE,$G(GMRAL)=0 S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",2,ALCNT)="NKA"
"RTN","PSOORUT2",129,0)
 S ALCNT=0,^TMP($J,"PSOAPT",3)="Non-Verified Allergies"
"RTN","PSOORUT2",130,0)
 S EEE=0,(PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",2,1,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",2,1,PSOLG,PSOLGA)) Q:PSOLGA=""  S EEE=EEE+1,ALCNT=ALCNT+1,^TMP($J,"PSOAPT",3,ALCNT)=PSOLGA
"RTN","PSOORUT2",131,0)
 I 'EEE,$G(GMRAL)=0 S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",3,ALCNT)="NKA"
"RTN","PSOORUT2",132,0)
 S ALCNT=0,^TMP($J,"PSOAPT",4)="Verified Adverse Reactions"
"RTN","PSOORUT2",133,0)
 S (PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",1,2,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",1,2,PSOLG,PSOLGA)) Q:PSOLGA=""  S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",4,ALCNT)=PSOLGA
"RTN","PSOORUT2",134,0)
 S ALCNT=0,^TMP($J,"PSOAPT",5)="Non-Verified Adverse Reactions"
"RTN","PSOORUT2",135,0)
 S (PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",2,2,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",2,2,PSOLG,PSOLGA)) Q:PSOLGA=""  S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",5,ALCNT)=PSOLGA
"RTN","PSOORUT2",136,0)
 S TEXT=^TMP($J,"PSOAPT",1) D CHKNO(TEXT)
"RTN","PSOORUT2",137,0)
 F CCC=3,4,5 I '$O(^TMP($J,"PSOAPT",CCC,0)) K ^TMP($J,"PSOAPT",CCC)
"RTN","PSOORUT2",138,0)
 D PSONOAL
"RTN","PSOORUT2",139,0)
 I CCC="NKA" S ^TMP($J,"PSOAPT",2,1)="No Known Allergies" K ^TMP($J,"PSOAPT",3)
"RTN","PSOORUT2",140,0)
 N OUT S CCC=1,OUT=0
"RTN","PSOORUT2",141,0)
 F  S CCC=$O(^TMP($J,"PSOAPT",CCC)) Q:CCC=""  D  Q:OUT
"RTN","PSOORUT2",142,0)
 .S TEXT=$G(^TMP($J,"PSOAPT",CCC))
"RTN","PSOORUT2",143,0)
 .I TEXT="No Allergy Assessment" S PSONOAL=TEXT Q
"RTN","PSOORUT2",144,0)
 .S (TEXT,CCC2)="",LENGTH=0
"RTN","PSOORUT2",145,0)
 .F  S CCC2=$O(^TMP($J,"PSOAPT",CCC,CCC2)) Q:CCC2=""  S TEXT=^(CCC2) D CHKNO(TEXT)
"RTN","PSOORUT2",146,0)
 K ^TMP($J,"PSOALWA"),^TMP($J,"PSOAPT")
"RTN","PSOORUT2",147,0)
 Q
"RTN","PSOORUT2",148,0)
CHKNO(T) ;
"RTN","PSOORUT2",149,0)
 I T="No Allergy Assessment" S PSONOAL=T
"RTN","PSOORUT2",150,0)
 Q
"RTN","PSOORUT2",151,0)
PSONOAL ;
"RTN","PSOORUT2",152,0)
 N FLG3,FLG4,FLG5
"RTN","PSOORUT2",153,0)
 S CCC=$G(^TMP($J,"PSOAPT",2,1))
"RTN","PSOORUT2",154,0)
 S FLG3=$G(^TMP($J,"PSOAPT",3,1))
"RTN","PSOORUT2",155,0)
 S FLG4=$G(^TMP($J,"PSOAPT",4,1))
"RTN","PSOORUT2",156,0)
 S FLG5=$G(^TMP($J,"PSOAPT",5,1))
"RTN","PSOORUT2",157,0)
 I CCC="",FLG3="",FLG4="",FLG5="" S ^TMP($J,"PSOAPT",2,1)="No Allergy Assessment" K ^TMP($J,"PSOAPT",3)
"RTN","PSOORUT2",158,0)
 Q
"RTN","PSOORUT2",159,0)
CRCL(DFN) ;
"RTN","PSOORUT2",160,0)
 N HTGT60,ABW,IBW,BWRATIO,BWDIFF,LOWBW,ADJBW,X1,X2,RSLT,PSCR,PSRW,ABW,ZHT,PSRH,PSCXTL,PSCXTLS,SCR,SCRD,OCXT,OCXTS,SCRV,ZAGE,ZSERUM,SEX
"RTN","PSOORUT2",161,0)
 S RSLT="0^<Not Found>"
"RTN","PSOORUT2",162,0)
 S PSCR="^^^^^^0"
"RTN","PSOORUT2",163,0)
 S PSCXTL="" Q:'$$TERMLKUP^ORB31(.PSCXTL,"SERUM CREATININE") RSLT
"RTN","PSOORUT2",164,0)
 S PSCXTLS="" Q:'$$TERMLKUP^ORB31(.PSCXTLS,"SERUM SPECIMEN") RSLT
"RTN","PSOORUT2",165,0)
 S SCR="",OCXT=0 F  S OCXT=$O(PSCXTL(OCXT)) Q:'OCXT  D
"RTN","PSOORUT2",166,0)
 .S OCXTS=0 F  S OCXTS=$O(PSCXTLS(OCXTS)) Q:'OCXTS  D
"RTN","PSOORUT2",167,0)
 ..S SCR=$$LOCL^ORQQLR1(DFN,$P(PSCXTL(OCXT),U),$P(PSCXTLS(OCXTS),U))
"RTN","PSOORUT2",168,0)
 ..I $P(SCR,U,7)>$P(PSCR,U,7) S PSCR=SCR
"RTN","PSOORUT2",169,0)
 S SCR=PSCR,SCRV=$P(SCR,U,3) Q:+$G(SCRV)<.01 RSLT
"RTN","PSOORUT2",170,0)
 S SCRD=$P(SCR,U,7) Q:'$L(SCRD) RSLT
"RTN","PSOORUT2",171,0)
 S RSLT=SCRD_"^<Not Found>^"_$P($G(SCR),"^",3)
"RTN","PSOORUT2",172,0)
 S X1=$P(RSLT,"^"),X2=$$FMTE^XLFDT(X1,"2M"),$P(RSLT,"^")=$P(X2,"@") K X1,X2
"RTN","PSOORUT2",173,0)
 D VITAL^ORQQVI("WEIGHT","WT",DFN,.PSRW,0,"",$$NOW^XLFDT)
"RTN","PSOORUT2",174,0)
 Q:'$D(PSRW) RSLT
"RTN","PSOORUT2",175,0)
 S ABW=$P(PSRW(1),U,3) Q:+$G(ABW)<1 RSLT
"RTN","PSOORUT2",176,0)
 S ABW=ABW/2.20462262  ;ABW (actual body weight) in kg; changed 2.2 to 2.20462262 per CQ 10637 ; PSO 402
"RTN","PSOORUT2",177,0)
 D VITAL^ORQQVI("HEIGHT","HT",DFN,.PSRH,0,"",$$NOW^XLFDT)
"RTN","PSOORUT2",178,0)
 Q:'$D(PSRH) RSLT
"RTN","PSOORUT2",179,0)
 S ZHT=$P(PSRH(1),U,3) Q:+$G(ZHT)<1 RSLT
"RTN","PSOORUT2",180,0)
 N VADM D DEM^VADPT S ZAGE=$G(VADM(4)) Q:'$L(ZAGE) RSLT
"RTN","PSOORUT2",181,0)
 ;S ZAGE=$$AGE^ORQPTQ4(DFN) Q:'ZAGE RSLT
"RTN","PSOORUT2",182,0)
 S SEX=$P($G(VADM(5)),"^") Q:'$L(SEX) RSLT
"RTN","PSOORUT2",183,0)
 ;S SEX=$P($$SEX^ORQPTQ4(DFN),U,1) Q:'$L(SEX) RSLT
"RTN","PSOORUT2",184,0)
 I '$G(ABW)!($G(ZHT)<1)!'$G(ZAGE)!'$D(SEX) Q RSLT
"RTN","PSOORUT2",185,0)
 S SCRD=$P(SCR,U,7) Q:'$L(SCRD) RSLT
"RTN","PSOORUT2",186,0)
 S HTGT60=$S(ZHT>60:(ZHT-60)*2.3,1:0)  ;if ht > 60 inches
"RTN","PSOORUT2",187,0)
 I HTGT60>0 D
"RTN","PSOORUT2",188,0)
 .S IBW=$S(SEX="M":50+HTGT60,1:45.5+HTGT60)  ;Ideal Body Weight
"RTN","PSOORUT2",189,0)
 .S BWRATIO=(ABW/IBW)  ;body weight ratio
"RTN","PSOORUT2",190,0)
 .S BWDIFF=$S(ABW>IBW:ABW-IBW,1:0)
"RTN","PSOORUT2",191,0)
 .S LOWBW=$S(IBW<ABW:IBW,1:ABW)
"RTN","PSOORUT2",192,0)
 .I BWRATIO>1.3,(BWDIFF>0) S ADJBW=((0.3*BWDIFF)+IBW)
"RTN","PSOORUT2",193,0)
 .E  S ADJBW=LOWBW
"RTN","PSOORUT2",194,0)
 I +$G(ADJBW)<1 D
"RTN","PSOORUT2",195,0)
 .S ADJBW=ABW
"RTN","PSOORUT2",196,0)
 S CRCL=(((140-ZAGE)*ADJBW)/(SCRV*72))
"RTN","PSOORUT2",197,0)
 S:SEX="M" RSLT=SCRD_U_$J(CRCL,1,1)
"RTN","PSOORUT2",198,0)
 S:SEX="F" RSLT=SCRD_U_$J((CRCL*.85),1,1)
"RTN","PSOORUT2",199,0)
 S X1=$P(RSLT,"^"),X2=$$FMTE^XLFDT(X1,"2M"),$P(RSLT,"^")=$P(X2,"@") K X1,X2
"RTN","PSOORUT2",200,0)
 S $P(RSLT,"^",3)=$P($G(SCR),"^",3)
"RTN","PSOORUT2",201,0)
 K HTGT60,ABW,IBW,BWRATIO,BWDIFF,LOWBW,ADJBW,X1,X2,PSCR,PSRW,ABW,ZHT,PSRH,ZAGE,PSCXTL,PSCXTLS,SCR,OCXT,OCXTS,SCRV,CRCL,ZSERUM
"RTN","PSOORUT2",202,0)
 Q RSLT
"RTN","PSORXEDT")
0^14^B51616221
"RTN","PSORXEDT",1,0)
PSORXEDT ;BIR/SAB - edit rx routine ;10/21/98
"RTN","PSORXEDT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**21,23,44,71,146,185,148,253,390,372,416,313,427,402**;DEC 1997;Build 8
"RTN","PSORXEDT",3,0)
 ;Internal Reference to ^PS(55 supported by DBIA 2228
"RTN","PSORXEDT",4,0)
 ;External reference to $$BSA^PSSDSAPI supported by DBIA 5425
"RTN","PSORXEDT",5,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) G EOJ Q
"RTN","PSORXEDT",6,0)
 K PSODRUG,PSOLIST,DIR,DIRUT,DUOUT,X,Y,PSOFROM,^TMP("PSOBEDT",$J),NOPP,CLOZPST,PSOTITRX,PSOMTFLG
"RTN","PSORXEDT",7,0)
 N PSOODOSP
"RTN","PSORXEDT",8,0)
 W !! S DIR(0)="FAO^1:245",DIR("A")="Edit Rx(s) => ",DIR("?",1)="Enter Rx Number or A List of numbers Separated",DIR("?")="by Commas, e.g. 1234A,345,937002Q."
"RTN","PSORXEDT",9,0)
 D ^DIR K DIR G:$D(DIRUT) EOJ
"RTN","PSORXEDT",10,0)
 S END=$L(X,","),BAD=0
"RTN","PSORXEDT",11,0)
 F I=1:1:END S RXM=$P(X,",",I) I +RXM F J=I+1:1:END S DUP=$P(X,",",J) I DUP=RXM S $P(X,",",J)="" W !?5,$C(7),"Duplicate Rx # "_RXM_"  was found in your list, ignoring it!",! S BAD=1
"RTN","PSORXEDT",12,0)
 S PSORLST=$P(X,",") F I=2:1:END S RXM=$P(X,",",I) S:RXM'?1.N.A BAD=1 I RXM?1.N.A S PSORLST=PSORLST_","_RXM
"RTN","PSORXEDT",13,0)
 F I=1:1:$L(PSORLST) S RXM=$P(PSORLST,",",I) I +RXM F J=I+1:1:END S DUP=$P(PSORLST,",",J) I DUP=RXM S $P(PSORLST,",",J)=""
"RTN","PSORXEDT",14,0)
BAD I PSORLST D  I 'Y K Y G PSORXEDT
"RTN","PSORXEDT",15,0)
 .W !?15,"=> "_PSORLST
"RTN","PSORXEDT",16,0)
 .K DIR,DIRUT S DIR(0)="Y",DIR("A")="Is this OKAY ",DIR("B")="Yes"
"RTN","PSORXEDT",17,0)
 .D ^DIR K DIR
"RTN","PSORXEDT",18,0)
 .I 'Y!$D(DIRUT) K X,PSORLST,BAD
"RTN","PSORXEDT",19,0)
 K BAD I 'PSORLST K PSORLST G PSORXEDT
"RTN","PSORXEDT",20,0)
 F I=1:1:$L(PSORLST,",") S RXM=$P(PSORLST,",",I) S GOOD=$D(^PSRX("B",RXM)) D
"RTN","PSORXEDT",21,0)
 .I 'GOOD W !!?5,"Couldn't Find RX # "_RXM H 3 Q
"RTN","PSORXEDT",22,0)
 .S RXN=$O(^PSRX("B",RXM,0)) D  I $P(^PSRX(RXN,"STA"),"^")=13 W !!?5,"Rx # "_RXM_" is marked for Deletion." H 3 Q
"RTN","PSORXEDT",23,0)
 ..I $G(RXN),$P($G(^PS(55,+$P($G(^PSRX(RXN,0)),"^",2),0)),"^",6)'=2 S PSOLOUD=1 D EN^PSOHLUP(+$P($G(^PSRX(RXN,0)),"^",2)) K PSOLOUD
"RTN","PSORXEDT",24,0)
 .D LIST K GOOD
"RTN","PSORXEDT",25,0)
 K GOOD,END
"RTN","PSORXEDT",26,0)
EPH ; - Entry for Epharmacy Rx Edit (PSOREJP1)
"RTN","PSORXEDT",27,0)
 F PSOT1=1:1 Q:'$D(PSOLIST(PSOT1))  F PSOLST2=1:1:$L(PSOLIST(PSOT1),",") S ORN=$P(PSOLIST(PSOT1),",",PSOLST2) D:+ORN PT
"RTN","PSORXEDT",28,0)
 ;
"RTN","PSORXEDT",29,0)
 ; If variable PSOREJCT is set, this means the EPH entry point was called by the EDIT action in the ePharmacy
"RTN","PSORXEDT",30,0)
 ;   Reject Info Screen. The variable will hold the RX IEN. If the Fill Date is the current date or in the
"RTN","PSORXEDT",31,0)
 ;   future (whether it has been edited or not) and the RX is not already suspended, put the Rx on the list
"RTN","PSORXEDT",32,0)
 ;   to get the QUEUE prompt. Since the EDIT action only sends one RX, we can just set the array and not
"RTN","PSORXEDT",33,0)
 ;   worry about appending to an exiting list.
"RTN","PSORXEDT",34,0)
 I $G(PSOREJCT),$$RXFLDT^PSOBPSUT(+PSOREJCT,$P(PSOREJCT,U,2))'<$$DT^XLFDT,$$GET1^DIQ(52,+PSOREJCT_",",100,"I")'=5 S PSORX("PSOL",1)=+PSOREJCT
"RTN","PSORXEDT",35,0)
 ;call to add bingo board data to file 52.11
"RTN","PSORXEDT",36,0)
 K POP,PSOLIST,TM,TM1 G:'$O(PSORX("PSOL",0)) NX
"RTN","PSORXEDT",37,0)
 D:$G(PSORX("PSOL",1))]"" ^PSORXL K PSORX G:$G(NOBG) NX
"RTN","PSORXEDT",38,0)
PRF G:'$P(PSOPAR,"^",8)!($G(NOPP)="H")!($G(NOPP)="S")!('$D(^TMP("PSOBEDT",$J))) BBG
"RTN","PSORXEDT",39,0)
 I $O(^TMP("PSOBEDT",$J,0)),$P(PSOPAR,"^",8) S PSOFROM="NEW",PSOION=ION K RXRS
"RTN","PSORXEDT",40,0)
 G:$D(PSOPROP)&($G(PSOPROP)'=ION) QUP
"RTN","PSORXEDT",41,0)
 I '$D(PSOPROP)!($G(PSOPROP)=ION) D  G:$G(POP)!($E(IOST)["C")!(PSOION=ION) BBG
"RTN","PSORXEDT",42,0)
 .S PSOION=ION W !,"Profiles must be sent to Printer !!",! K IOP,%ZIS,IO("Q"),POP
"RTN","PSORXEDT",43,0)
 .S %ZIS="MNQ",%ZIS("A")="Select Profile Device: " D ^%ZIS K %ZIS("A")
"RTN","PSORXEDT",44,0)
 .Q:$G(POP)!($E(IOST)["C")!(PSOION=ION)  S PSOPROP=ION
"RTN","PSORXEDT",45,0)
QUP S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X,HOLDRPAS=$G(PSOPRPAS),PSOPRPAS=$P(PSOPAR,"^",13)
"RTN","PSORXEDT",46,0)
 F DFN=0:0 S DFN=$O(^TMP("PSOBEDT",$J,DFN)) Q:'DFN  S PPL=^TMP("PSOBEDT",$J,DFN,0) D
"RTN","PSORXEDT",47,0)
 .S ZTRTN="DQ^PSOPRF",ZTIO=PSOPROP,ZTDESC="Outpatient Pharmacy Patient Profiles",ZTDTH=$H
"RTN","PSORXEDT",48,0)
 .F G="PSOPAR","PSODTCUT","PSOPRPAS","DFN","PSOSITE","NEW1","NEW11","PSOBMST","PFIO","PPL" S:$D(@G) ZTSAVE(G)=""
"RTN","PSORXEDT",49,0)
 .D ^%ZTLOAD
"RTN","PSORXEDT",50,0)
 W:$D(ZTSK) !,"PROFILE(S) QUEUED to PRINT",!! K G,ZTSK D ^%ZISC
"RTN","PSORXEDT",51,0)
 S PSOPRPAS=$G(HOLDRPAS) K:PSOPRPAS']"" PSOPRPAS K HOLDRPAS
"RTN","PSORXEDT",52,0)
BBG K DFN F PSODFN=0:0 S PSODFN=$O(^TMP("PSOBEDT",$J,PSODFN)) Q:'PSODFN  I $G(^TMP("PSOBEDT",$J,PSODFN,1)),$D(DISGROUP) S TM=$P($G(^TMP("PSOBB",$J)),"^"),TM1=$P($G(^($J)),"^",2),PPL=^TMP("PSOBEDT",$J,PSODFN,0) D ^PSOBING1
"RTN","PSORXEDT",53,0)
NX ;
"RTN","PSORXEDT",54,0)
 K %X,%Y,ACTREF,ACTREN,D,D0,DAT,DFN,DIC,DIQ,DQ,DRG,END,FDR,PSOBEDT,TM,TM1,PSOT1,PSOLST2,NOBG,BBFLG,BINGCRT,BINGRTE,C,CC,CMOP,COM,CT,D1,DI,DREN,BBRX,PSOFROM,POP,PSORX("QFLG"),IT,PSOERR,PSOBCK,PSOBM,PPL
"RTN","PSORXEDT",55,0)
 K ^TMP("PSOBEDT",$J),^TMP("PSOBB",$J),ZTSK,NOPP,VALMSG,VALMBCK D EOJ
"RTN","PSORXEDT",56,0)
END Q
"RTN","PSORXEDT",57,0)
 ;---------------------------------------------------------
"RTN","PSORXEDT",58,0)
PT ;
"RTN","PSORXEDT",59,0)
 N PSOTXEDT,PSOTPEXT S PSOTXEDT=$P($G(^PSRX(ORN,0)),"^",2) I PSOTXEDT I $D(^PS(52.91,PSOTXEDT,0)) I '$P(^PS(52.91,PSOTXEDT,0),"^",3)!($P(^(0),"^",3)>DT) D PDIR^PSOTPCAN(PSOTXEDT) I $G(PSOTPEXT) K PSOTPEXT,PSOTXEDT D EOJ Q
"RTN","PSORXEDT",60,0)
 K PSOTXEDT,PSOTPEXT
"RTN","PSORXEDT",61,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSORXEDT",62,0)
 S $P(PSOLST(ORN),"^",2)=ORN,(PSOBEDT)=1
"RTN","PSORXEDT",63,0)
 S (DFN,PSODFN)=+$P(^PSRX(ORN,0),"^",2),PSORX("NAME")=$P(^DPT(DFN,0),"^") I PSODFN'=$G(PSOODOSP) K PSORX("DOSING OFF") S PSOODOSP=PSODFN
"RTN","PSORXEDT",64,0)
 D ICN^PSODPT(DFN)
"RTN","PSORXEDT",65,0)
 S RX0=^PSRX(ORN,0),RX2=$G(^(2)),RX3=$G(^(3))
"RTN","PSORXEDT",66,0)
 D:$G(DUZ("AG"))="V" COPAY^PSOPTPST ; Deals with copay
"RTN","PSORXEDT",67,0)
 K ^TMP("PSOHDR",$J),^TMP("PSOPI",$J) D ^VADPT,ADD^VADPT
"RTN","PSORXEDT",68,0)
 S ^TMP("PSOHDR",$J,1,0)=VADM(1),^TMP("PSOHDR",$J,2,0)=$P(VADM(2),"^",2)
"RTN","PSORXEDT",69,0)
 S ^TMP("PSOHDR",$J,3,0)=$P(VADM(3),"^",2)
"RTN","PSORXEDT",70,0)
 S ^TMP("PSOHDR",$J,4,0)=VADM(4),^TMP("PSOHDR",$J,5,0)=$P(VADM(5),"^",2)
"RTN","PSORXEDT",71,0)
 S POERR=1 D RE^PSODEM K POERR,VALMBCK
"RTN","PSORXEDT",72,0)
 S ^TMP("PSOHDR",$J,6,0)=$S($P(WT,"^",8):$P(WT,"^",9)_" ("_$P(WT,"^")_")",1:"_______ (______)")
"RTN","PSORXEDT",73,0)
 S ^TMP("PSOHDR",$J,7,0)=$S($P(HT,"^",8):$P(HT,"^",9)_" ("_$P(HT,"^")_")",1:"_______ (______)") K VM,WT,HT S PSOHD=7
"RTN","PSORXEDT",74,0)
 S ^TMP("PSOHDR",$J,9,0)="",^TMP("PSOHDR",$J,10,0)=""
"RTN","PSORXEDT",75,0)
 S GMRA="0^0^111" D ^GMRADPT S ^TMP("PSOHDR",$J,8,0)=+$G(GMRAL)
"RTN","PSORXEDT",76,0)
 ;
"RTN","PSORXEDT",77,0)
 ; Display CrCl/BSA - show serum creatinine if CrCl can't be calculated
"RTN","PSORXEDT",78,0)
 S PSOBSA=$$BSA^PSSDSAPI(DFN),PSOBSA=$P(PSOBSA,"^",3),PSOBSA=$S(PSOBSA'>0:"_______",1:$J(PSOBSA,4,2)) S ^TMP("PSOHDR",$J,12,0)=PSOBSA
"RTN","PSORXEDT",79,0)
 S RSLT=$$CRCL^PSOORUT2(DFN)
"RTN","PSORXEDT",80,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)<.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_" (CREAT: Not Found)"
"RTN","PSORXEDT",81,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"  (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSORXEDT",82,0)
 I ($P($G(RSLT),"^",2)>0)&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"(est.)"_" (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSORXEDT",83,0)
 S ^TMP("PSOHDR",$J,13,0)=ZDSPL
"RTN","PSORXEDT",84,0)
 K PSOBSA,RSLT,ZDSPL
"RTN","PSORXEDT",85,0)
 ;
"RTN","PSORXEDT",86,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSORXEDT",87,0)
 S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSORXEDT",88,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^")
"RTN","PSORXEDT",89,0)
 D CLEAR^VALM1
"RTN","PSORXEDT",90,0)
 S STA="ACTIVE^NON-VERIFIED^REFILL^HOLD^NON-VERIFIED^SUSPENDED^^^^^^EXPIRED^DISCONTINUED^^DISCONTINUED^DISCONTINUED^HOLD"
"RTN","PSORXEDT",91,0)
 S $P(PSOLST(ORN),"^",3)=$P(STA,"^",$P(^PSRX(ORN,"STA"),"^")+1),PSLST=ORN,ORD=1
"RTN","PSORXEDT",92,0)
 D ACT^PSOORNE2
"RTN","PSORXEDT",93,0)
EOJ ;
"RTN","PSORXEDT",94,0)
 K INS1,HDR,IK,INDT,LOG,NODE,ORN,P1,PSI,PSL,PSOLION,PSNP,PSOACT,PSOBM,PSOCLC,PSOCNT,PSODD,PSODFN,PSOHD,PSOJ,PSOLST,PSOOI,PSOPF,PSLST
"RTN","PSORXEDT",95,0)
 K PSOIBQS,PSORLST,PSOSD,PSOSIG,PSPRXN,PSORX0,PSORX1,PTST,REFL,RF,RFD,RIFN,RLD,RPH,RTS,RX0,RX1,RX2,RX3,RXM,RXOR,SIG,SIGOK
"RTN","PSORXEDT",96,0)
 D KVA^VADPT K SLPPL,ST,STA,^TMP("PS",$J),PSOQFLG,PSORXED,PSOEDIT,DIR,DIRUT,DUOUT,DTOUT,PSOLOUD,GMRAL,GG,FEV,ACNT
"RTN","PSORXEDT",97,0)
 D FULL^VALM1 K ^TMP("PSOAL",$J),^TMP("PSOAO",$J),^TMP("PSOSF",$J),^TMP("PSOPF",$J),^TMP("PSOPI",$J),^TMP("PSOPO",$J),^TMP("PSOHDR",$J),PAT
"RTN","PSORXEDT",98,0)
 K JJ,K,MM,PSDAYS,PSOAC,PSOAL,PSOCOU,PSOCOUU,PSONEW,PSODRUG,PSONOOR,PSRX0,QTY,REA,RFCNT,RFDT,RXDA,RXFL,RXREF,SUB,X,Z,ZII
"RTN","PSORXEDT",99,0)
 K ACOM,CRIT,DA,DDH,DGI,DGS,PSONEW3,SER,SERS,ZONE,RN,RXN,PSOX,PSOERR,ORD,PSOBCK,PSOBILL,SURX,PSORX("QFLG"),PSORX("FN"),CLOZPAT
"RTN","PSORXEDT",100,0)
 Q
"RTN","PSORXEDT",101,0)
LIST ;
"RTN","PSORXEDT",102,0)
 I $G(^PSRX(RXN,0))']"" W !,$C(7),"Rx data is not on file !",! G LISTX
"RTN","PSORXEDT",103,0)
 I $P(^PSRX(RXN,0),"^",15)=13 S PSVD=1 W !,$C(7),"Rx # "_RXM_" has been deleted."
"RTN","PSORXEDT",104,0)
 S RXN1=RXN,RXM1=RXM D:'$G(PSVD) LST1 W "." S RXN=RXN1,RXM=RXM1 K RXN1,RXM1
"RTN","PSORXEDT",105,0)
 F  S RXN=$O(^PSRX("B",RXM,RXN)) Q:'RXN  D
"RTN","PSORXEDT",106,0)
 .I $G(^PSRX(RXN,0))']"" Q
"RTN","PSORXEDT",107,0)
 .I $P(^PSRX(RXN,0),"^",15)=13 Q
"RTN","PSORXEDT",108,0)
 .D LST1
"RTN","PSORXEDT",109,0)
 K RXN1 G LISTX
"RTN","PSORXEDT",110,0)
 Q
"RTN","PSORXEDT",111,0)
LST1 I $G(PSOLIST(1))']"" S PSOLIST(1)=RXN_"," G LISTX
"RTN","PSORXEDT",112,0)
 F PSOX1=0:0 S PSOX1=$O(PSOLIST(PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSORXEDT",113,0)
 I $L(PSOLIST(PSOX2))+$L(RXN)<220 S:RXN_","'[PSOLIST(PSOX2) PSOLIST(PSOX2)=PSOLIST(PSOX2)_RXN_","
"RTN","PSORXEDT",114,0)
 E  S:RXN_","'[PSOLIST(PSOX2+1) PSOLIST(PSOX2+1)=RXN_","
"RTN","PSORXEDT",115,0)
LISTX K PSOX1,PSOX2,RXN,PSVD
"RTN","PSORXEDT",116,0)
 Q
"RTN","PSOSIG")
0^18^B70274708
"RTN","PSOSIG",1,0)
PSOSIG ;BIR/RTR-Utility to create SIG ;6/04/00
"RTN","PSOSIG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,99,114,391,313,282,455,402**;DEC 1997;Build 8
"RTN","PSOSIG",3,0)
 ;External reference to PS(51 supported by DBIA 2224
"RTN","PSOSIG",4,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOSIG",5,0)
 ;External reference to PSDRUG( supported by DBIA 221
"RTN","PSOSIG",6,0)
 ;
"RTN","PSOSIG",7,0)
EN(PSOSIGX) ;
"RTN","PSOSIG",8,0)
 N VARIABLE
"RTN","PSOSIG",9,0)
 Q
"RTN","PSOSIG",10,0)
SCH ;*282 Preserve old functionality
"RTN","PSOSIG",11,0)
 I $D(DTOUT)!($D(DUOUT)) Q
"RTN","PSOSIG",12,0)
 I Y'>0 W !,?2,"Free text '"_$G(SCH)_"' entered for schedule"
"RTN","PSOSIG",13,0)
 S SCHEX=$$SCHE(SCH)
"RTN","PSOSIG",14,0)
 Q
"RTN","PSOSIG",15,0)
 ;
"RTN","PSOSIG",16,0)
 ;SCHE is the new schedule expander
"RTN","PSOSIG",17,0)
SCHE(SCH) ;
"RTN","PSOSIG",18,0)
 ;SCH = Schedule entered
"RTN","PSOSIG",19,0)
 ;Returns Expanded Schedule, or ""
"RTN","PSOSIG",20,0)
 N SCHEX,SPCT
"RTN","PSOSIG",21,0)
 I SCH[""""!($A(SCH)=45)!(SCH?.E1C.E)!($L(SCH," ")>$S(SCH["PRN":4,1:3))!($L(SCH)>20)!($L(SCH)<1) K SCH Q ""
"RTN","PSOSIG",22,0)
 S SCH=$$UPPER(SCH)
"RTN","PSOSIG",23,0)
 S SPCT=0 F I=1:1:$L(SCH) I $E(SCH,I)=" " S SPCT=SPCT+1
"RTN","PSOSIG",24,0)
 S SCHEX=$$EXP(SCH) I SCHEX]"" Q SCHEX
"RTN","PSOSIG",25,0)
 Q:SPCT=0 SCH
"RTN","PSOSIG",26,0)
 Q $$SCHE($P(SCH," ",1,SPCT))_" "_$$SCHE($P(SCH," ",SPCT+1))
"RTN","PSOSIG",27,0)
EXP(X) ; expand based on 51.1 and 51
"RTN","PSOSIG",28,0)
 N PSIN,SCFLG,SCHEX
"RTN","PSOSIG",29,0)
 S PSIN=0 F  S PSIN=$O(^PS(51.1,"APPSJ",X,PSIN)) Q:'PSIN!$G(SCFLG)  I $P(^PS(51.1,PSIN,0),"^",8)'="" S SCHEX=$P($G(^(0)),"^",8),SCFLG=1
"RTN","PSOSIG",30,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",31,0)
 S PSIN=0 F  S PSIN=$O(^PS(51.1,"D",X,PSIN)) Q:'PSIN!$G(SCFLG)  I $P(^PS(51.1,PSIN,0),"^",1)'="" S SCHEX=$P($G(^(0)),"^",1),SCFLG=1
"RTN","PSOSIG",32,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",33,0)
 S PSIN=0 F  S PSIN=$O(^PS(51,"B",X,PSIN)) Q:'PSIN!$G(SCLFL)  I PSIN,($P(^PS(51,PSIN,0),"^",4)<2)&($P($G(^PS(51,"A",X)),"^")'="") S SCHEX=$P(^(X),"^"),SCFLG=1
"RTN","PSOSIG",34,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",35,0)
 S PSIN=0 F  S PSIN=$O(^PS(51,"D",X,PSIN)) Q:'PSIN!$G(SCLFL)  I $P(^PS(51,PSIN,0),"^",1)'="" S SCHEX=$P($G(^(0)),"^",1),SCFLG=1
"RTN","PSOSIG",36,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",37,0)
 Q ""
"RTN","PSOSIG",38,0)
 ;
"RTN","PSOSIG",39,0)
QTY(PSOQX) ;
"RTN","PSOSIG",40,0)
 N QDOSE
"RTN","PSOSIG",41,0)
 K PSOQX("QTY")
"RTN","PSOSIG",42,0)
 I $G(PSOFDR),'$G(CPRN) N PSOQTYQT,PSOLPSD S PSOQTYQT=0 D  I $G(PSOQTYQT) Q
"RTN","PSOSIG",43,0)
 .S PSOLPSD="" F  S PSOLPSD=$O(PSONEW("SCHEDULE",PSOLPSD)) Q:PSOLPSD=""!(PSOQTYQT)  I $G(PSONEW("SCHEDULE",PSOLPSD))["PRN"!($G(PSONEW("SCHEDULE",PSOLPSD))["prn")!($G(PSONEW("SCHEDULE",PSOLPSD))["Prn") S PSOQTYQT=1 Q
"RTN","PSOSIG",44,0)
 N PSOOUTQT S PSOOUTQT=1
"RTN","PSOSIG",45,0)
QTYCP ;CPRS qty call comes through here
"RTN","PSOSIG",46,0)
 N PSQQUIT,QTSH,PSQ,PSQMIN,PSQMINZ,PSOQRND,PSOLOWER,PSOLOWX,PSOLOWXL,PSOLOWST
"RTN","PSOSIG",47,0)
 K PSOFRQ S PSQQUIT=0
"RTN","PSOSIG",48,0)
 I '$G(PSOCPRQT) S QDOSE=0 F PSQ=0:0 S PSQ=$O(PSOQX("DOSE",PSQ)) Q:'PSQ  S QDOSE=PSQ S:'$G(PSOQX("DOSE ORDERED",PSQ)) PSQQUIT=1
"RTN","PSOSIG",49,0)
 ;Q:PSQQUIT!('QDOSE)
"RTN","PSOSIG",50,0)
 I '$G(PSOCPRQT) Q:PSQQUIT
"RTN","PSOSIG",51,0)
 Q:'$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",52,0)
 Q:'$G(QDOSE)
"RTN","PSOSIG",53,0)
 G:QDOSE>1 COMP
"RTN","PSOSIG",54,0)
 Q:'$G(PSOQX("DOSE ORDERED",1))
"RTN","PSOSIG",55,0)
 Q:'$G(PSOQX("DAYS SUPPLY"))&('$G(PSOQX("DURATION",1)))
"RTN","PSOSIG",56,0)
 S PSOLOWER=0
"RTN","PSOSIG",57,0)
 I $G(PSOQX("DURATION",1)) D
"RTN","PSOSIG",58,0)
 .S PSOLOWX=$L(PSOQX("DURATION",1))
"RTN","PSOSIG",59,0)
 .S PSOLOWXL=$S($E(PSOQX("DURATION",1),PSOLOWX)="M":1,$E(PSOQX("DURATION",1),PSOLOWX)="H":60,$E(PSOQX("DURATION",1),PSOLOWX)="S":.01666,$E(PSOQX("DURATION",1),PSOLOWX)="W":10080,$E(PSOQX("DURATION",1),PSOLOWX)="L":43200,1:1440)
"RTN","PSOSIG",60,0)
 .S PSOLOWER=PSOLOWXL*(+$G(PSOQX("DURATION",1)))
"RTN","PSOSIG",61,0)
 S PSOLOWX=0 I +$G(PSOQX("DAYS SUPPLY")) S PSOLOWX=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",62,0)
 Q:'$G(PSOLOWER)&('$G(PSOLOWX))
"RTN","PSOSIG",63,0)
 S QTSH=$G(PSOQX("SCHEDULE",1)) D QTS Q:PSQQUIT!('$G(PSOFRQ))
"RTN","PSOSIG",64,0)
 S PSOLOWST=$S('$G(PSOLOWER):$G(PSOLOWX),'$G(PSOLOWX):$G(PSOLOWER),$G(PSOLOWER)>$G(PSOLOWX):$G(PSOLOWX),$G(PSOLOWX)>$G(PSOLOWER):$G(PSOLOWER),$G(PSOLOWX)=$G(PSOLOWER):$G(PSOLOWER),1:0)
"RTN","PSOSIG",65,0)
 Q:'$G(PSOLOWST)
"RTN","PSOSIG",66,0)
 S PSQMIN=+$G(PSOLOWST)
"RTN","PSOSIG",67,0)
 S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIG",68,0)
 S PSOQRND=PSQMINZ*+$G(PSOQX("DOSE ORDERED",1)) Q:'PSOQRND
"RTN","PSOSIG",69,0)
 D ROUND G QEND
"RTN","PSOSIG",70,0)
 Q
"RTN","PSOSIG",71,0)
COMP ;COMPLEX DOSE HERE
"RTN","PSOSIG",72,0)
 N PSOQEXC,PSOQAND,PSOQTHEN,PSQL,PSQMNL,PSQMNLX,PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSQ1,PSODUX,PSODUXX,PSODSMIN
"RTN","PSOSIG",73,0)
 ;PSODUTOT = TOTAL OF ALL DURATIONS
"RTN","PSOSIG",74,0)
 ;PSODUDIF = DIFF. OF DURATION VS DAYS SUPPLY
"RTN","PSOSIG",75,0)
 ;PSODUMIS = # OF SEQUENCES MISSING A DURATION IF >1 CAN'T DEFAULT
"RTN","PSOSIG",76,0)
 ;PSODUREP = SEQUENCE # THAT IS MISSING DURATION
"RTN","PSOSIG",77,0)
 ;PSODSMIN = MINUTES OF DAYS SUPPLY
"RTN","PSOSIG",78,0)
 S (PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSODSMIN,PSOQAND,PSOQTHEN,PSOQEXC)=0
"RTN","PSOSIG",79,0)
 F PSQL=1:1:QDOSE S:$G(PSOQX("CONJUNCTION",PSQL))["A" PSOQAND=1 S:$G(PSOQX("CONJUNCTION",PSQL))["T" PSOQTHEN=1 S:$G(PSOQX("CONJUNCTION",PSQL))["X" PSOQEXC=1
"RTN","PSOSIG",80,0)
 I $G(PSOQEXC) G QEND
"RTN","PSOSIG",81,0)
 I $G(PSOQAND) G COMP^PSOSIGCX
"RTN","PSOSIG",82,0)
 F PSQ1=1:1:QDOSE D  Q:PSODUMIS>1
"RTN","PSOSIG",83,0)
 .I '$G(PSOQX("DURATION",PSQ1)) S PSODUMIS=PSODUMIS+1,PSODUREP=PSQ1 Q
"RTN","PSOSIG",84,0)
 .S PSODUX=$L(PSOQX("DURATION",PSQ1))
"RTN","PSOSIG",85,0)
 .S PSODUXX=$S($E(PSOQX("DURATION",PSQ1),PSODUX)="M":1,$E(PSOQX("DURATION",PSQ1),PSODUX)="H":60,$E(PSOQX("DURATION",PSQ1),PSODUX)="S":.01666,$E(PSOQX("DURATION",PSQ1),PSODUX)="W":10080,$E(PSOQX("DURATION",PSQ1),PSODUX)="L":43200,1:1440)
"RTN","PSOSIG",86,0)
 .S PSODUTOT=PSODUTOT+(PSODUXX*(+$G(PSOQX("DURATION",PSQ1))))
"RTN","PSOSIG",87,0)
 G:PSODUMIS>1 QEND ; More than 1 sequence missing a duration
"RTN","PSOSIG",88,0)
 I $G(PSODUMIS),'$G(PSOQX("DAYS SUPPLY")) G QEND ; missing 1 duration, no days supply
"RTN","PSOSIG",89,0)
 S PSODSMIN=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",90,0)
 I $G(PSODSMIN),$G(PSODSMIN)<$G(PSODUTOT) G QEND
"RTN","PSOSIG",91,0)
 I '$G(PSODUMIS),$G(PSODSMIN),$G(PSODUTOT)>$G(PSODSMIN) G QEND ; no missing durations, but total durations are greater than days supply
"RTN","PSOSIG",92,0)
 I $G(PSODUMIS),$G(PSODSMIN),$G(PSODSMIN)'>$G(PSODUTOT) G QEND ; 1 missing duration, and total of other durations are not less than days supply
"RTN","PSOSIG",93,0)
 I '$G(PSODSMIN),$G(PSODUMIS) G QEND ; no days supply, missing a duration
"RTN","PSOSIG",94,0)
 I $G(PSODUREP) S PSODUDIF=$G(PSODSMIN)-$G(PSODUTOT)
"RTN","PSOSIG",95,0)
 F PSQ=1:1:QDOSE D  Q:$G(PSQQUIT)
"RTN","PSOSIG",96,0)
 .I '$G(PSOQX("DOSE ORDERED",PSQ))!($G(PSOQX("SCHEDULE",PSQ))="") S PSQQUIT=1 Q
"RTN","PSOSIG",97,0)
 .S QTSH=$G(PSOQX("SCHEDULE",PSQ)) D QTS S:'$G(PSOFRQ) PSQQUIT=1 Q:$G(PSQQUIT)
"RTN","PSOSIG",98,0)
 .I $G(PSOQX("DURATION",PSQ)) S PSQMNL=$L(PSOQX("DURATION",PSQ)) D
"RTN","PSOSIG",99,0)
 ..S PSQMNLX=$S($E(PSOQX("DURATION",PSQ),PSQMNL)="M":1,$E(PSOQX("DURATION",PSQ),PSQMNL)="H":60,$E(PSOQX("DURATION",PSQ),PSQMNL)="S":.01666,$E(PSOQX("DURATION",PSQ),PSQMNL)="W":10080,$E(PSOQX("DURATION",PSQ),PSQMNL)="L":43200,1:1440)
"RTN","PSOSIG",100,0)
 ..S PSQMIN=PSQMNLX*(+$G(PSOQX("DURATION",PSQ)))
"RTN","PSOSIG",101,0)
 .I '$G(PSOQX("DURATION",PSQ)) S PSQMIN=$G(PSODUDIF)
"RTN","PSOSIG",102,0)
 .S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIG",103,0)
 .S PSOQRND=$S('$G(PSOQRND):PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ)),1:$G(PSOQRND)+(PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ))))
"RTN","PSOSIG",104,0)
 I $G(PSQQUIT) G QEND
"RTN","PSOSIG",105,0)
 I $G(PSOQRND) D ROUND
"RTN","PSOSIG",106,0)
 G QEND
"RTN","PSOSIG",107,0)
QTS ;*282 Preserve Old Functionality
"RTN","PSOSIG",108,0)
 S PSOFRQ=$$QTSCH(QTSH)
"RTN","PSOSIG",109,0)
 I '$G(PSOFRQ) S PSQQUIT=1
"RTN","PSOSIG",110,0)
 Q
"RTN","PSOSIG",111,0)
 ;
"RTN","PSOSIG",112,0)
QTSCH(QTSH) ; 
"RTN","PSOSIG",113,0)
 ; Return Frequency for Schedule QTSH
"RTN","PSOSIG",114,0)
 ; Otherwise return ""
"RTN","PSOSIG",115,0)
 N PSOFRQ,SPCT,FOUND
"RTN","PSOSIG",116,0)
 Q:$G(QTSH)="" ""
"RTN","PSOSIG",117,0)
 Q:$E(QTSH,1)=" " ""
"RTN","PSOSIG",118,0)
 S QTSH=$$UPPER(QTSH)
"RTN","PSOSIG",119,0)
 S SPCT=1,PSOFRQ=0 F I=1:1:$L(QTSH) I $E(QTSH,I)=" " S SPCT=SPCT+1
"RTN","PSOSIG",120,0)
 F I=0:1:SPCT-1 S SCHTMP=$P(QTSH," ",1,SPCT-I) Q:PSOFRQ  D
"RTN","PSOSIG",121,0)
 . F II=0:0 S II=$O(^PS(51.1,"APPSJ",SCHTMP,II)) Q:'II!PSOFRQ  S PSOFRQ=$P(^PS(51.1,II,0),"^",3)
"RTN","PSOSIG",122,0)
 Q:PSOFRQ PSOFRQ
"RTN","PSOSIG",123,0)
  F I=0:1:SPCT-1 S SCHTMP=$P(QTSH," ",1,SPCT-I) Q:PSOFRQ  D
"RTN","PSOSIG",124,0)
 . F II=0:0 S II=$O(^PS(51,"B",SCHTMP,II)) Q:'II!PSOFRQ  I $P(^PS(51,II,0),"^",4)<2 S PSOFRQ=$P(^PS(51,II,0),"^",8)
"RTN","PSOSIG",125,0)
 Q:PSOFRQ PSOFRQ
"RTN","PSOSIG",126,0)
 Q ""
"RTN","PSOSIG",127,0)
 ;
"RTN","PSOSIG",128,0)
QEND ;
"RTN","PSOSIG",129,0)
 ; PSOMTFLG variable indicates a Maintenance Rx (Titration/Maintenance)
"RTN","PSOSIG",130,0)
 K PSOFRQ
"RTN","PSOSIG",131,0)
 I $G(PSOOUTQT),$G(QTYHLD),$G(PSOQX("QTY")),$G(QTYHLD)'=$G(PSOQX("QTY")) W !!!,"Quantity has been changed from "_QTYHLD_" to "_PSOQX("QTY") D  I '$G(PSOMTFLG) W ! N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOSIG",132,0)
 .I $G(PSONEW("FLD"))=8,$P($G(OR0),"^",24),$G(PSODRUG("IEN")),$D(^PSDRUG(+$G(PSODRUG("IEN")),0)) D
"RTN","PSOSIG",133,0)
 ..I $P(^PSDRUG(PSODRUG("IEN"),0),"^",3)[2!($P(^PSDRUG(PSODRUG("IEN"),0),"^",3)["F") Q
"RTN","PSOSIG",134,0)
 ..N ZRFA S ZRFA=$S($G(CLOZPAT)=2&(PSOQX("DAYS SUPPLY")=14):1,$G(CLOZPAT)=2&(PSOQX("DAYS SUPPLY")=7):3,$G(CLOZPAT)=1&(PSOQX("DAYS SUPPLY")=7):1,$D(CLOZPAT):0,1:5)
"RTN","PSOSIG",135,0)
 ..N ZREF,ZTQ S ZREF=QTYHLD\PSOQX("QTY") I ZREF>0 D
"RTN","PSOSIG",136,0)
 ...S ZTQ=QTYHLD*(PSOQX("# OF REFILLS")+1),ZTQ=ZTQ-PSOQX("QTY"),ZREF=ZTQ\PSOQX("QTY") S:ZREF>ZRFA ZREF=ZRFA
"RTN","PSOSIG",137,0)
 ...I ZREF'=PSOQX("# OF REFILLS") W !,"# of Refills has been changed from "_PSOQX("# OF REFILLS")_" to "_ZREF S PSOQX("# OF REFILLS")=ZREF
"RTN","PSOSIG",138,0)
 Q
"RTN","PSOSIG",139,0)
ROUND ;
"RTN","PSOSIG",140,0)
 Q:'$G(PSOQRND)
"RTN","PSOSIG",141,0)
 I PSOQRND'["." S PSOQX("QTY")=PSOQRND Q
"RTN","PSOSIG",142,0)
 S PSOQX("QTY")=$P(PSOQRND,".")+1
"RTN","PSOSIG",143,0)
 Q
"RTN","PSOSIG",144,0)
DAY(DATE) ;First 5 digits of FileMan date
"RTN","PSOSIG",145,0)
 N X
"RTN","PSOSIG",146,0)
 I DATE'?5N Q -1
"RTN","PSOSIG",147,0)
 S X=$E(DATE,4,5) I X<1!(X>12) Q -1
"RTN","PSOSIG",148,0)
 S X=DATE+1+(X=12*88)_"01"
"RTN","PSOSIG",149,0)
 Q $E($$FMADD^XLFDT(X,-1),6,7)
"RTN","PSOSIG",150,0)
 ;
"RTN","PSOSIG",151,0)
QTYX(PSOQX) ;
"RTN","PSOSIG",152,0)
 N PSOQLP,PSOQLN,PSOQAR,PSOCPRQT,QDOSE,QDOSEX S PSOCPRQT=1 F PSOQLP=0:0 S PSOQLP=$O(PSOQX("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIG",153,0)
 .S PSOQAR("DURATION",PSOQLP)=$G(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIG",154,0)
 .I $E(PSOQX("DURATION",PSOQLP))?1A S PSOQLN=$L(PSOQX("DURATION",PSOQLP)) S PSOQX("DURATION",PSOQLP)=$E(PSOQX("DURATION",PSOQLP),2,PSOQLN)_$E(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIG",155,0)
 S QDOSE=0 F QDOSEX=0:0 S QDOSEX=$O(PSOQX("DOSE ORDERED",QDOSEX)) Q:'QDOSEX  S QDOSE=QDOSE+1
"RTN","PSOSIG",156,0)
 I '$G(PSOQX("QTY")) D QTYCP G QPASS
"RTN","PSOSIG",157,0)
 D QTYCP^PSOSIGDS
"RTN","PSOSIG",158,0)
QPASS F PSOQLP=0:0 S PSOQLP=$O(PSOQAR("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIG",159,0)
 .S PSOQX("DURATION",PSOQLP)=$G(PSOQAR("DURATION",PSOQLP))
"RTN","PSOSIG",160,0)
 K PSOCPRQT
"RTN","PSOSIG",161,0)
 Q
"RTN","PSOSIG",162,0)
DAYS(PSOQX) ;Entry point for Days Supply calc for PSO
"RTN","PSOSIG",163,0)
 ;Kill days supply here
"RTN","PSOSIG",164,0)
 Q:'$G(PSOQX("QTY"))
"RTN","PSOSIG",165,0)
 D QTYOPS^PSOSIGDS
"RTN","PSOSIG",166,0)
 Q
"RTN","PSOSIG",167,0)
 ;
"RTN","PSOSIG",168,0)
UPPER(PSOSCUP) ;
"RTN","PSOSIG",169,0)
 Q $TR(PSOSCUP,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSOVER1")
0^10^B130702321
"RTN","PSOVER1",1,0)
PSOVER1 ;BHAM ISC/SAB - verify one rx ;3/9/05 12:53pm
"RTN","PSOVER1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**32,46,90,131,202,207,148,243,268,281,324,358,251,375,387,379,390,372,416,411,402**;DEC 1997;Build 8
"RTN","PSOVER1",3,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSOVER1",4,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOVER1",5,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOVER1",6,0)
 ;External reference to DOSE^PSSORPH is supported by DBIA 3234
"RTN","PSOVER1",7,0)
 ;External reference to ^ORRDI1 supported by DBIA 4659
"RTN","PSOVER1",8,0)
 ;External reference to ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOVER1",9,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSOVER1",10,0)
 ;External reference to $$GETNDC^PSSNDCUT supported by DBIA 4707
"RTN","PSOVER1",11,0)
 ;External reference to ^DPT( supported by DBIA 3097
"RTN","PSOVER1",12,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOVER1",13,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOVER1",14,0)
 ;External reference to ^PS(56 supported by DBIA 2229
"RTN","PSOVER1",15,0)
REDO ;
"RTN","PSOVER1",16,0)
 I '$G(PSOCLK) Q:$G(PSVERFLG)
"RTN","PSOVER1",17,0)
 S (DRG,PSODRUG("NAME"))=$P(^PSDRUG(+$P(^PSRX(PSONV,0),"^",6),0),"^"),PSODRUG("VA CLASS")=$P(^(0),"^",2)
"RTN","PSOVER1",18,0)
 S PSOVQUIT=0,PSODRUG("IEN")=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",19,0)
 S PSOY(0)=^PSDRUG(PSODRUG("IEN"),0),PSOY=PSODRUG("IEN")_"^"_$P(PSOY(0),"^")
"RTN","PSOVER1",20,0)
 D SET^PSODRG
"RTN","PSOVER1",21,0)
 I '$D(PSODFN) S PSODFN=$P(^PSRX(PSONV,0),"^",2)
"RTN","PSOVER1",22,0)
 ;
"RTN","PSOVER1",23,0)
EDIT ;
"RTN","PSOVER1",24,0)
 N PSDNEW,PSDOLD
"RTN","PSOVER1",25,0)
 S (PSDNEW,PSDOLD)="",PSDOLD=$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^")_"^"_PSONV
"RTN","PSOVER1",26,0)
 S DA=PSONV D ^PSORXPR
"RTN","PSOVER1",27,0)
 I $G(PKI1)=2 D DCV1^PSOPKIV1 G OUT
"RTN","PSOVER1",28,0)
 K PSDTSTOP S DIR("A")="EDIT",DIR("B")="N",DIR(0)="SB^Y:YES;N:NO;P:PROFILE",DIR("?")="Enter Y to change this RX, P to see a profile, or N to proceed with verification and order checks."
"RTN","PSOVER1",29,0)
 D ^DIR K DIR W ! I $G(DIRUT)!($G(DTOUT)) S PSOVBCK=1 G OUT
"RTN","PSOVER1",30,0)
 ;PSOPOCK=1 called from Process Order Check option; PSOCLK=1 means initiated from Rx verify by clerk.
"RTN","PSOVER1",31,0)
 I Y="Y",($G(PSOCLK)!($G(PSOPOCK))) D FULLEDT S VALMBCK="R" G KILL:$$CHECK(PSONV) G EDIT
"RTN","PSOVER1",32,0)
 I Y="Y",$G(PSOACT)]"" S VALMBCK="R",PSVERFLG=1 G OUT  ;this pops the user back to the med profile screen when verify is called from Patient Prescription Processing
"RTN","PSOVER1",33,0)
 I $D(DIRUT),$G(PSOCLK) S PSOCQ=1 G OUT
"RTN","PSOVER1",34,0)
 I $D(DIRUT),$G(PSOACT)]"" S VALMBCK="R" G OUT
"RTN","PSOVER1",35,0)
 G ORDCHK:Y="N",PROF:Y="P",OUT:"YNP"'[$E(Y)
"RTN","PSOVER1",36,0)
 ;
"RTN","PSOVER1",37,0)
 D EXPIRE K DIE,DR,DEA1,DEA2,P(5),PSRX1,PSRX2
"RTN","PSOVER1",38,0)
 K PSD(PSDOLD) S PSDNEW="",PSDNEW=$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^")_"^"_PSONV,PSD(PSDNEW)=PSONV_"^*^1^"_$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^",2)
"RTN","PSOVER1",39,0)
 ;
"RTN","PSOVER1",40,0)
 S DA=$S($D(PSORXED("IRXN")):PSORXED("IRXN"),1:PSONV) D ^PSORXPR G OUT:$G(DIRUT)
"RTN","PSOVER1",41,0)
 G OUT:$D(DIRUT)!($D(DTOUT))
"RTN","PSOVER1",42,0)
 I '$G(PSOCLK) S DA=$S($D(PSORXED("IRXN")):PSORXED("IRXN"),1:PSONV) W !,"CHANGE",! D ^PSORXPR G OUT:$D(DIRUT)!($D(DTOUT)) G EDIT
"RTN","PSOVER1",43,0)
 G EDIT:PSDNEW=PSDOLD,REDO
"RTN","PSOVER1",44,0)
PROF I '$D(PSOSD) W !,$C(7),"This patient has no other prescriptions on file",!! G EDIT Q
"RTN","PSOVER1",45,0)
 W !!,$P(^DPT(DFN,0),"^"),?40,"ID#:"_VA("PID") W:$D(INT)!$D(PSONV) "  RX#: "_$S($D(INT):$P(INT,"^"),$D(^PSRX(PSONV)):$P(^PSRX(PSONV,0),"^"),1:"")
"RTN","PSOVER1",46,0)
 D HD^PSODDPR2() D ^PSODSPL D SHOW2^PSOVER G EDIT Q
"RTN","PSOVER1",47,0)
 ;
"RTN","PSOVER1",48,0)
EXPIRE S RX0=^PSRX(DA,0),X1=$P($P(RX0,"^",13),"."),X2=$P(RX0,"^",9)+1*$P(RX0,"^",8),X2=$S($P(RX0,"^",8)=X2:X2,X2<181:184,X2=360:366,1:X2),X=X1 D:X1&X2 C^%DTC
"RTN","PSOVER1",49,0)
 K ^PS(55,PSDFN,"P","A",+$P(^PSRX(DA,2),"^",6),DA) S ^PS(55,PSDFN,"P","A",X,DA)="",$P(^PSRX(DA,2),"^",6)=X,$P(^PS(52.4,DA,0),"^",7)=X Q
"RTN","PSOVER1",50,0)
 ;
"RTN","PSOVER1",51,0)
ORDCHK ;
"RTN","PSOVER1",52,0)
 S PSOVER1=1
"RTN","PSOVER1",53,0)
 S RX0=^PSRX(PSONV,0)
"RTN","PSOVER1",54,0)
 D ORDCK
"RTN","PSOVER1",55,0)
 I $G(PSOQUIT) S:$G(PSOCLK) PSOQUIT=0 S:'$G(PSOCLK) PSORX("DFLG")=1  ;if verify by clerk continue on with the next Rx; if not exit
"RTN","PSOVER1",56,0)
 I $G(PSOVQUIT)!$G(PSORX("DFLG")) G OUT
"RTN","PSOVER1",57,0)
 ;------
"RTN","PSOVER1",58,0)
VERIFY ;
"RTN","PSOVER1",59,0)
 D FULL^VALM1 G:'$P(PSOPAR,"^",2) VERY
"RTN","PSOVER1",60,0)
 W !,$P(^DPT(DFN,0),"^"),?40,"ID#:"_VA("PID") W:$D(INT)!$D(PSONV) "  RX#: "_$S($D(INT):$P(INT,"^"),$D(^PSRX(PSONV)):$P(^PSRX(PSONV,0),"^"),1:"") W:$D(PSODRUG("NAME")) !,PSODRUG("NAME"),!
"RTN","PSOVER1",61,0)
 I $G(PSONAM)="" S PSONAM=$P(^DPT(PSDFN,0),"^")
"RTN","PSOVER1",62,0)
 S DIR("A")="VERIFY FOR "_PSONAM_"? (Y/N/Delete/Quit): ",DIR("B")="Y",DIR(0)="SA^Y:YES;N:NO;D:DELETE;Q:QUIT"
"RTN","PSOVER1",63,0)
 S DIR("?",1)="Enter Y (or return) to verify this prescription",DIR("?",2)="N to leave this prescription non-verified and to end this session of verification",DIR("?")="D to delete this prescription"
"RTN","PSOVER1",64,0)
 D ^DIR K DIR
"RTN","PSOVER1",65,0)
 I Y="N"!("Q^"[$E(Y)) D  G OUT
"RTN","PSOVER1",66,0)
 .S (PSVERFLG,PSOVBCK)=1,PSORX("DFLG")=1
"RTN","PSOVER1",67,0)
 .S:$D(PSOOVNOD) ^PS(52.4,PSONV,0)=PSOOVNOD S:$G(PSOOVSTA) $P(^PSRX(PSONV,"STA"),"^")=PSOOVSTA
"RTN","PSOVER1",68,0)
 .S:PSOOVSTA=4 ^PS(52.4,"ADI",PSONV,1)=""
"RTN","PSOVER1",69,0)
 G DELETE:Y="D"
"RTN","PSOVER1",70,0)
VERY I $G(PKI1)=1 D REA^PSOPKIV1 G:'$D(PKIR) VERIFY
"RTN","PSOVER1",71,0)
 K ^PSRX(PSONV,"DAI") S $P(^PSRX(PSONV,3),"^",6)=""
"RTN","PSOVER1",72,0)
 K ^PSRX(PSONV,"DRI"),SPFL
"RTN","PSOVER1",73,0)
 I '$O(^PSRX(PSONV,6,0)) D  I $D(DUOUT)!($D(DTOUT)) W !!,"Rx: "_$P(^PSRX(DA,0),"^")_" not Verified!!",! H 2 G OUT
"RTN","PSOVER1",74,0)
 .W !!,"Dosing Instructions Missing. Please add!",!
"RTN","PSOVER1",75,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^")]"",'$P($G(^("SIG")),"^",2) W "SIG: "_$P(^PSRX(PSONV,"SIG"),"^"),!
"RTN","PSOVER1",76,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^",2),$O(^PSRX(PSONV,"SIG1",0)) D  K I
"RTN","PSOVER1",77,0)
 ..W "SIG: " F I=0:0 S I=$O(^PSRX(PSONV,"SIG1",I)) Q:'I  W ^PSRX(PSONV,"SIG1",I,0),!
"RTN","PSOVER1",78,0)
 .S DA=PSONV,PSOVER=1 K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOVER1",79,0)
 .S PSODRUG("IEN")=$P(^PSRX(DA,0),"^",6),PSODFN=$P(^(0),"^",2),PSORXED("IRXN")=DA,PSODRUG("OI")=$P(^PSRX(DA,"OR1"),"^")
"RTN","PSOVER1",80,0)
 .D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN),^PSOORED3
"RTN","PSOVER1",81,0)
 .K PSODFN,PSODRUG("IEN"),DOSE,PSOVER
"RTN","PSOVER1",82,0)
 .I '$G(ENT) S DUOUT=1
"RTN","PSOVER1",83,0)
 .Q:$D(DUOUT)!($D(DTOUT))
"RTN","PSOVER1",84,0)
 .K DIR,DIRUT,DUOUT,DTOUT S DIE=52,DR=114 D ^DIE K DIE,DR,DTOUT
"RTN","PSOVER1",85,0)
 .I X'="" D SIG^PSOHELP D:$G(INS1)]"" EN^DDIOL($E(INS1,2,9999999)) S PSORXED("SIG",1)=$E(INS1,2,9999999)
"RTN","PSOVER1",86,0)
 .D EN^PSOFSIG(.PSORXED,1),UDSIG^PSOORED3 H 2
"RTN","PSOVER1",87,0)
 S DA=PSONV,$P(^PSRX(DA,2),"^",10)=DUZ,DRG=$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^")
"RTN","PSOVER1",88,0)
 I $P(^PSRX(DA,2),"^",2)>DT,$P(PSOPAR,"^",6) D  G KILL
"RTN","PSOVER1",89,0)
 .S (SPFL1,PSOVER)="",PSORX("FILL DATE")=$P(^PSRX(DA,2),"^",2),RXF=0
"RTN","PSOVER1",90,0)
 .D UPSUS S PSTRIVER=1 D SUS^PSORXL
"RTN","PSOVER1",91,0)
 .K PSORX("FILL DATE"),PSTRIVER
"RTN","PSOVER1",92,0)
 .I $D(^TMP("PSODAOC",$J)) D ^PSONEWOC K ^TMP("PSODAOC",$J)
"RTN","PSOVER1",93,0)
 S PSOVER(PSONV)="" S $P(^PSRX(PSONV,"STA"),"^")=0,DRG=$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^")
"RTN","PSOVER1",94,0)
 S $P(PSOSD("NON-VERIFIED",DRG),"^",2)=0,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG)
"RTN","PSOVER1",95,0)
 I $D(^TMP("PSODAOC",$J)) D ^PSONEWOC K ^TMP("PSODAOC",$J)
"RTN","PSOVER1",96,0)
 I $G(PKI1)=1,$G(PKIR)]"" D ACT^PSOPKIV1(DA)
"RTN","PSOVER1",97,0)
 K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","") ;S VALMBCK=""
"RTN","PSOVER1",98,0)
 ;saves drug allergy order chks pso*7*390
"RTN","PSOVER1",99,0)
 I +$G(^TMP("PSODAOC",$J,1,0)) D
"RTN","PSOVER1",100,0)
 .I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSOVER1",101,0)
 .N RXN,PSODAOC S RXN=PSONV,PSODAOC="Rx Backdoor VERIFIED NEW Order Acceptance_OP"
"RTN","PSOVER1",102,0)
 .D DAOC^PSONEW
"RTN","PSOVER1",103,0)
 .K ^TMP("PSODAOC",$J),RET
"RTN","PSOVER1",104,0)
 ;
"RTN","PSOVER1",105,0)
 ; - Calling ECME for claims generation and transmission / REJECT handling
"RTN","PSOVER1",106,0)
 N ACTION
"RTN","PSOVER1",107,0)
 I $$SUBMIT^PSOBPSUT(PSONV) D  I ACTION="Q"!(ACTION="^") Q
"RTN","PSOVER1",108,0)
 . S ACTION="" D ECMESND^PSOBPSU1(PSONV,,,$S($O(^PSRX(PSONV,1,0)):"RF",1:"OF"))
"RTN","PSOVER1",109,0)
 . ; Quit if there is an unresolved Tricare non-billable reject code, PSO*7*358
"RTN","PSOVER1",110,0)
 . I $$PSOET^PSOREJP3(PSONV) S ACTION="Q" Q
"RTN","PSOVER1",111,0)
 . I $$FIND^PSOREJUT(PSONV) D
"RTN","PSOVER1",112,0)
 . . S ACTION=$$HDLG^PSOREJU1(PSONV,0,"79,88","OF","IOQ","Q")
"RTN","PSOVER1",113,0)
 ;
"RTN","PSOVER1",114,0)
KILL S DA=PSONV,DIK="^PS(52.4," D ^DIK K DA,DIK D DCORD^PSONEW2
"RTN","PSOVER1",115,0)
OUT ;
"RTN","PSOVER1",116,0)
 K PSOVER1
"RTN","PSOVER1",117,0)
 I '$G(PSOCLK) S:$G(DIRUT)!($G(DTOUT)) PSORX("DFLG")=1 K DIRUT,DTOUT,DUOUT,UPFLAGX D CLEAN S VALMBCK="Q" Q
"RTN","PSOVER1",118,0)
 I $G(PSOCLK) S PSORX("DFLG")=0 K UPFLAGX D CLEAN Q
"RTN","PSOVER1",119,0)
DELETE K UPFLAGX D DELETE^PSOVER2 G:$G(UPFLAGX) OUT K PSOSD("NON-VERIFIED",$G(DRG)) Q
"RTN","PSOVER1",120,0)
QUIT S PSOQUIT="" D CLEAN Q
"RTN","PSOVER1",121,0)
UPSUS S $P(PSOSD("NON-VERIFIED",DRG),"^",2)=5,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG) K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","")
"RTN","PSOVER1",122,0)
 Q
"RTN","PSOVER1",123,0)
CLEAN ;cleans up tmp("psorxdc") global
"RTN","PSOVER1",124,0)
 I $G(PSODOSEX) K PSODOSEX Q
"RTN","PSOVER1",125,0)
 N PSOWRITE
"RTN","PSOVER1",126,0)
 I $O(^TMP("PSORXDC",$J,0)) F RORD=0:0 S RORD=$O(^TMP("PSORXDC",$J,RORD)) Q:'RORD  D
"RTN","PSOVER1",127,0)
 .D PSOUL^PSSLOCK(RORD_$S($P(^TMP("PSORXDC",$J,RORD,0),"^")="P":"S",1:""))
"RTN","PSOVER1",128,0)
 .I $P(^TMP("PSORXDC",$J,RORD,0),"^")="P" D  Q
"RTN","PSOVER1",129,0)
 ..S PSOR=^PS(52.41,RORD,0)
"RTN","PSOVER1",130,0)
 ..S DNM=$S($P(PSOR,"^",9):$P($G(^PSDRUG($P(PSOR,"^",9),0)),"^"),1:$P(^PS(50.7,$P(PSOR,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(PSOR,"^",8),0),"^",2),0),"^"))
"RTN","PSOVER1",131,0)
 ..W $C(7),!," Duplicate "_$S($P(^TMP("PSORXDC",$J,RORD,0),"^",10):"Therapy",1:"Drug")_" Pending Order "_DNM_" NOT Discontinued." S PSOWRITE=1
"RTN","PSOVER1",132,0)
 .W !," Duplicate "_$S($P(^TMP("PSORXDC",$J,RORD,0),"^",10):"Therapy",1:"Drug")_" Rx #"_$P(^PSRX(RORD,0),"^")_" "_$P(^TMP("PSORXDC",$J,RORD,0),"^",7)_" NOT Discontinued." S PSOWRITE=1
"RTN","PSOVER1",133,0)
 I $G(PSOWRITE)&('$G(PSOWRIT)) W ! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR S:($D(DTOUT))!($D(DUOUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,X,Y I ($Y+5)>IOSL W @IOF
"RTN","PSOVER1",134,0)
 K ^TMP("PSORXDC",$J),RORD,PRNXZ,ORNZZ,PSOR
"RTN","PSOVER1",135,0)
 Q
"RTN","PSOVER1",136,0)
KV1 ;
"RTN","PSOVER1",137,0)
 K PSOANSQD,DRET,LST,PSOQUIT,PSODRUG,PSONEW,SIG,PSODIR,PHI,PRC,ORCHK,ORDRG,PSOSIGFL,PSORX("ISSUE DATE"),PSORX("FILL DATE"),CLOZPAT
"RTN","PSOVER1",138,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOVER1",139,0)
 Q
"RTN","PSOVER1",140,0)
NVA ;
"RTN","PSOVER1",141,0)
 I $P(PSOSD(STA,DNM),"^",11) D NVA^PSODRDU1 Q
"RTN","PSOVER1",142,0)
 N PSOOI,CLASS,FLG,X,Y,RXREC,IFN
"RTN","PSOVER1",143,0)
 S (Y,FLG)=""
"RTN","PSOVER1",144,0)
 S RXREC=$P(PSOSD(STA,DNM),"^",10),PSOOI=+$G(^PS(55,DFN,"NVA",RXREC,0)),IFN=RXREC N DNM
"RTN","PSOVER1",145,0)
 F  S Y=$O(^PSDRUG("ASP",PSOOI,Y)) Q:Y=""!(FLG)  S DNM=$P(^PSDRUG(Y,0),"^"),CLASS=$P(^PSDRUG(Y,0),"^",2) I PSODRUG("NAME")=DNM!(CLASS=PSODRUG("VA CLASS")) D DSP^PSODRDU1 S FLG=1 Q
"RTN","PSOVER1",146,0)
 Q
"RTN","PSOVER1",147,0)
REMOTE ; 
"RTN","PSOVER1",148,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN) D
"RTN","PSOVER1",149,0)
 .I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOVER1",150,0)
 .I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOVER1",151,0)
 .D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSOVER1",152,0)
 .I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) D  Q
"RTN","PSOVER1",153,0)
 ..I $T(REMOTE^PSORX1)]"" Q
"RTN","PSOVER1",154,0)
 ..W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)>IOSL)
"RTN","PSOVER1",155,0)
 .W !!,"Now doing remote order checks. Please wait..."
"RTN","PSOVER1",156,0)
 .D REMOTE^PSOORRDI(PSODFN,+$P($G(^PSRX(PSONV,0)),"^",6))
"RTN","PSOVER1",157,0)
 .I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)>IOSL) ;D PAUSE^PSOORRD2 Q
"RTN","PSOVER1",158,0)
 .I $D(^TMP($J,"DD")) D DUP^PSOORRD2
"RTN","PSOVER1",159,0)
 .I $D(^TMP($J,"DC")) D CLS^PSOORRD2
"RTN","PSOVER1",160,0)
 .I $D(^TMP($J,"DI"_PSODFN)) K ^TMP($J,"DI") M ^TMP($J,"DI")=^TMP($J,"DI"_PSODFN) D DRGINT^PSOORRD2
"RTN","PSOVER1",161,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN)
"RTN","PSOVER1",162,0)
 Q
"RTN","PSOVER1",163,0)
NOALRGY ;
"RTN","PSOVER1",164,0)
 N PSODFN,PSODRUG
"RTN","PSOVER1",165,0)
 S PSODFN=$P(^PSRX(PSONV,0),"^",2),PSODRUG("IEN")=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",166,0)
 D NOALRGY^PSODRG
"RTN","PSOVER1",167,0)
 Q
"RTN","PSOVER1",168,0)
 ;
"RTN","PSOVER1",169,0)
ORDCK ;
"RTN","PSOVER1",170,0)
 N ORN,ORNZZ,PSOLST,Y,PSOODFN S ORN=PSONV,PSOLST(PSONV)=PSONV_"^"_PSONV,PSOVORD=1
"RTN","PSOVER1",171,0)
 N DRG,ON,CT,DRGI,PDRG,SEV,STX,INT,CLI,PSONULN,PSONULN1,LST,LSI,DGI,SER,SERS,DUPT,SV
"RTN","PSOVER1",172,0)
 S ORNZZ=ORN,PRNXZ(ORN)=PSOLST(ORN),PSORENW("OIRXN")=PSONV,PSOODFN=DFN
"RTN","PSOVER1",173,0)
 I '$D(PSODFN) S PSODFN=$P(^PSRX(PSONV,0),"^",2)
"RTN","PSOVER1",174,0)
 D SHOW^PSOVER D HD^PSODDPR2():(($Y+5)>IOSL)
"RTN","PSOVER1",175,0)
 S (PSODRUG("IEN"),PSDRUG("IEN"))=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",176,0)
 N PSOVINF S PSOVINF=^PSDRUG(PSDRUG("IEN"),0),PSODRUG("VA CLASS")=$P(^(0),"^",2)
"RTN","PSOVER1",177,0)
 S PSODRUG("VA CLASS")=$P(PSOVINF,"^",2),(DRG,PSODRUG("NAME"))=$P(^PSDRUG(PSDRUG("IEN"),0),"^")
"RTN","PSOVER1",178,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(PSDRUG("IEN"),"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOVER1",179,0)
 S PSODRUG("MAXDOSE")=$P(PSOVINF,"^",4),PSODRUG("DEA")=$P(PSOVINF,"^",3),PSODRUG("CLN")=$S($D(^PSDRUG(PSDRUG("IEN"),"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSOVER1",180,0)
 S PSODRUG("SIG")=$P(PSOVINF,"^",5),PSODRUG("NDC")=$$GETNDC^PSSNDCUT(PSDRUG("IEN"),$G(PSOSITE)),PSODRUG("STKLVL")=$G(^PSDRUG(PSDRUG("IEN"),660.1))
"RTN","PSOVER1",181,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,PSONV,81)
"RTN","PSOVER1",182,0)
 K PSOVINF
"RTN","PSOVER1",183,0)
 D POST^PSODRG S DFN=PSOODFN
"RTN","PSOVER1",184,0)
 I $$GET1^DIQ(52,PSONV,100,"I")=13 S PSORX("DFLG")=1 Q
"RTN","PSOVER1",185,0)
 I $G(PSVERFLG),$G(PSOCLK) S PSVERFLG=0
"RTN","PSOVER1",186,0)
 I $G(PSOCLK),$G(PSORX("DFLG")) S PSOVQUIT=1 K PSORX("DFLG"),DIRUT,DTOUT Q
"RTN","PSOVER1",187,0)
 Q:PSORX("DFLG")
"RTN","PSOVER1",188,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("V")
"RTN","PSOVER1",189,0)
 I $$GET1^DIQ(52,PSONV,100,"I")=13 S PSORX("DFLG")=1 Q
"RTN","PSOVER1",190,0)
 I $G(PSOCLK),$G(PSORX("DFLG")) S PSOVQUIT=1 K PSORX("DFLG"),DIRUT,DTOUT Q
"RTN","PSOVER1",191,0)
 Q:PSORX("DFLG")!($G(PSOQUIT))
"RTN","PSOVER1",192,0)
 S PSOLST(ORNZZ)=PRNXZ(ORNZZ),ORN=ORNZZ K PSORENW("OIRXN")
"RTN","PSOVER1",193,0)
 Q
"RTN","PSOVER1",194,0)
 ;
"RTN","PSOVER1",195,0)
FULLEDT  ;
"RTN","PSOVER1",196,0)
 D FULL^VALM1
"RTN","PSOVER1",197,0)
 N RX,FILL,OPSOLST,OPSLST,OLDDA,PSODRUG,REJ
"RTN","PSOVER1",198,0)
 S (RX,PSORXED("IRXN"))=PSONV
"RTN","PSOVER1",199,0)
 M OPSOLST=PSOLST,OPSLST=PSLST,ODA=DA
"RTN","PSOVER1",200,0)
 N PSOSITE,ORN,PSOPAR,PSOLIST,PSOSD
"RTN","PSOVER1",201,0)
 S PSOSITE=$$RXSITE^PSOBPSUT(RX,""),ORN=RX
"RTN","PSOVER1",202,0)
 S PSOPAR=$G(^PS(59,PSOSITE,1)),PSOLIST(1)=ORN_","
"RTN","PSOVER1",203,0)
 D EPH^PSORXEDT
"RTN","PSOVER1",204,0)
 M PSOLST=OPSOLST,PSLST=OPSLST S VALMBCK="R" S:$D(OLDDA) DA=OLDDA
"RTN","PSOVER1",205,0)
 Q
"RTN","PSOVER1",206,0)
 ;
"RTN","PSOVER1",207,0)
DRIDOSE(DA,RX0) ;where DA is RXIEN and RX0 is zero node of file 52 for the RXIEN
"RTN","PSOVER1",208,0)
 N T,RXN,RXX,SCRIPT,SEV,X,SER,PSOSERV,PSOSCPT,PSODOSF,RX
"RTN","PSOVER1",209,0)
 S RX=RX0
"RTN","PSOVER1",210,0)
 S RXN=$P(RX0,"^")
"RTN","PSOVER1",211,0)
 I $D(^PS(52.4,RX,0))!($D(^PSRX(RX,"DRI"))) D
"RTN","PSOVER1",212,0)
 . Q:'$P($G(^PS(52.4,RX,0)),"^",8)&('$D(^PSRX(RX,"DRI")))
"RTN","PSOVER1",213,0)
 .W !!,"*** During order, there were DRUG-DRUG INTERACTION for the following RX(s):"
"RTN","PSOVER1",214,0)
 I $P($G(^PS(52.4,RX,0)),"^",8) S SCRIPT=$P(^PS(52.4,RX,0),"^",10),SEV=$P(^PS(52.4,RX,0),"^",9) F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOVER1",215,0)
 . S SER=$P(^PS(56,SEV(X),0),"^",4) S:$G(SER)=1 PSOSERV=1
"RTN","PSOVER1",216,0)
 . S PSOSCPT(RXX(X))="     "_$S(SER=1:"CRITICAL",SER=2:"SIGNIFICANT",1:"UNKNOWN")_" INTERACTION    "_$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^")
"RTN","PSOVER1",217,0)
 I $D(^PSRX(RX,"DRI")) S SCRIPT=$P(^PSRX(RX,"DRI"),"^",2),SEV=$P(^PSRX(RX,"DRI"),"^") F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOVER1",218,0)
 .S SER=$P(^PS(56,SEV(X),0),"^",4)
"RTN","PSOVER1",219,0)
 .S PSOSCPT(RXX(X))="     "_$P($G(^PSRX(RXX(X),0)),"^")_"  "_$S(SER=1:"CRITICAL",SER=2:"SIGNIFICANT",1:"UNKNOWN")_" INTERACTION  "_$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^")
"RTN","PSOVER1",220,0)
 S SCRIPT="" F  S SCRIPT=$O(PSOSCPT(SCRIPT)) Q:SCRIPT=""  W !,PSOSCPT(SCRIPT)
"RTN","PSOVER1",221,0)
 I $$DS^PSSDSAPI,$D(^PS(52.4,RX,1)) S T=$P(^PS(52.4,RX,1),"^") D  W:PSODOSF'="" !,"*** Dose Warning: ",PSODOSF
"RTN","PSOVER1",222,0)
 . S PSODOSF="",PSODOSF=$S(T=4:"DOSAGE EXCEEDS MAX SINGLE DOSE AND/OR MAX DAILY DOSE",T=3:"MAX SINGLE DOSE & DAILY DOSE RANGE",T=2:"MAX SINGLE DOSE",T=1:"DAILY DOSE RANGE",1:"")
"RTN","PSOVER1",223,0)
 W !
"RTN","PSOVER1",224,0)
 Q
"RTN","PSOVER1",225,0)
CHECK(PSONV) ;
"RTN","PSOVER1",226,0)
 N PSOSTAT S PSOSTAT=$$GET1^DIQ(52,PSONV,100,"I")
"RTN","PSOVER1",227,0)
 I ",11,12,13,14,15,"[(","_PSOSTAT_",") Q 1
"RTN","PSOVER1",228,0)
 Q 0
"VER")
8.0^22.2
**INSTALL NAME**
OR*3.0*382
"BLD",9611,0)
OR*3.0*382^ORDER ENTRY/RESULTS REPORTING^0^3170802^y
"BLD",9611,4,0)
^9.64PA^^
"BLD",9611,6)
7^
"BLD",9611,6.3)
15
"BLD",9611,"ABPKG")
n
"BLD",9611,"KRN",0)
^9.67PA^779.2^20
"BLD",9611,"KRN",.4,0)
.4
"BLD",9611,"KRN",.401,0)
.401
"BLD",9611,"KRN",.402,0)
.402
"BLD",9611,"KRN",.403,0)
.403
"BLD",9611,"KRN",.5,0)
.5
"BLD",9611,"KRN",.84,0)
.84
"BLD",9611,"KRN",3.6,0)
3.6
"BLD",9611,"KRN",3.8,0)
3.8
"BLD",9611,"KRN",9.2,0)
9.2
"BLD",9611,"KRN",9.8,0)
9.8
"BLD",9611,"KRN",9.8,"NM",0)
^9.68A^8^8
"BLD",9611,"KRN",9.8,"NM",1,0)
ORCHECK^^0^B130208555
"BLD",9611,"KRN",9.8,"NM",2,0)
ORCSAVE^^0^B127544119
"BLD",9611,"KRN",9.8,"NM",3,0)
ORCSAVE2^^0^B113061054
"BLD",9611,"KRN",9.8,"NM",4,0)
ORDSGCHK^^0^B98387224
"BLD",9611,"KRN",9.8,"NM",5,0)
ORKCHK5^^0^B90858156
"BLD",9611,"KRN",9.8,"NM",6,0)
ORKPS^^0^B115111476
"BLD",9611,"KRN",9.8,"NM",7,0)
ORMPS1^^0^B71534901
"BLD",9611,"KRN",9.8,"NM",8,0)
ORUQO^^0^B19420199
"BLD",9611,"KRN",9.8,"NM","B","ORCHECK",1)

"BLD",9611,"KRN",9.8,"NM","B","ORCSAVE",2)

"BLD",9611,"KRN",9.8,"NM","B","ORCSAVE2",3)

"BLD",9611,"KRN",9.8,"NM","B","ORDSGCHK",4)

"BLD",9611,"KRN",9.8,"NM","B","ORKCHK5",5)

"BLD",9611,"KRN",9.8,"NM","B","ORKPS",6)

"BLD",9611,"KRN",9.8,"NM","B","ORMPS1",7)

"BLD",9611,"KRN",9.8,"NM","B","ORUQO",8)

"BLD",9611,"KRN",19,0)
19
"BLD",9611,"KRN",19.1,0)
19.1
"BLD",9611,"KRN",101,0)
101
"BLD",9611,"KRN",409.61,0)
409.61
"BLD",9611,"KRN",771,0)
771
"BLD",9611,"KRN",779.2,0)
779.2
"BLD",9611,"KRN",870,0)
870
"BLD",9611,"KRN",8989.51,0)
8989.51
"BLD",9611,"KRN",8989.52,0)
8989.52
"BLD",9611,"KRN",8994,0)
8994
"BLD",9611,"KRN","B",.4,.4)

"BLD",9611,"KRN","B",.401,.401)

"BLD",9611,"KRN","B",.402,.402)

"BLD",9611,"KRN","B",.403,.403)

"BLD",9611,"KRN","B",.5,.5)

"BLD",9611,"KRN","B",.84,.84)

"BLD",9611,"KRN","B",3.6,3.6)

"BLD",9611,"KRN","B",3.8,3.8)

"BLD",9611,"KRN","B",9.2,9.2)

"BLD",9611,"KRN","B",9.8,9.8)

"BLD",9611,"KRN","B",19,19)

"BLD",9611,"KRN","B",19.1,19.1)

"BLD",9611,"KRN","B",101,101)

"BLD",9611,"KRN","B",409.61,409.61)

"BLD",9611,"KRN","B",771,771)

"BLD",9611,"KRN","B",779.2,779.2)

"BLD",9611,"KRN","B",870,870)

"BLD",9611,"KRN","B",8989.51,8989.51)

"BLD",9611,"KRN","B",8989.52,8989.52)

"BLD",9611,"KRN","B",8994,8994)

"BLD",9611,"QUES",0)
^9.62^^
"BLD",9611,"REQB",0)
^9.611^4^3
"BLD",9611,"REQB",1,0)
OR*3.0*269^2
"BLD",9611,"REQB",2,0)
OR*3.0*350^2
"BLD",9611,"REQB",4,0)
OR*3.0*421^2
"BLD",9611,"REQB","B","OR*3.0*269",1)

"BLD",9611,"REQB","B","OR*3.0*350",2)

"BLD",9611,"REQB","B","OR*3.0*421",4)

"MBREQ")
1
"PKG",170,-1)
1^1
"PKG",170,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",170,22,0)
^9.49I^1^1
"PKG",170,22,1,0)
3.0^2971217^2980917^11712
"PKG",170,22,1,"PAH",1,0)
382^3170802^11931
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
8
"RTN","ORCHECK")
0^1^B130208555
"RTN","ORCHECK",1,0)
ORCHECK ;SLC/MKB-Order checking calls ;06/20/16  05:50
"RTN","ORCHECK",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**7,56,70,94,141,215,243,293,280,346,357,352,345,311,269,382**;Dec 17, 1997;Build 15
"RTN","ORCHECK",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORCHECK",4,0)
DISPLAY ; -- DISPLAY event [called from ORCDLG,ORCACT4,ORCMED]
"RTN","ORCHECK",5,0)
 ;    Expects ORVP, ORNMSP, ORTAB, [ORWARD]
"RTN","ORCHECK",6,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",7,0)
 N ORX,ORY,I
"RTN","ORCHECK",8,0)
 I ORNMSP="PS" D  ;reset to PSJ, PSJI, or PSO
"RTN","ORCHECK",9,0)
 . I $G(ORDG) S I=$P($G(^ORD(100.98,+ORDG,0)),U,3),I=$P(I," ") Q:'$L(I)  S ORNMSP="PS"_$S(I="UD":"I",1:I) Q
"RTN","ORCHECK",10,0)
 . I $G(ORXFER) S I=$P($P(^TMP("OR",$J,ORTAB,0),U,3),";",3) S:I="" I=$G(ORWARD) S ORNMSP="PS"_$S(I:"O",1:"I") ;opposite of list
"RTN","ORCHECK",11,0)
 S ORX(1)="|"_ORNMSP,ORX=1
"RTN","ORCHECK",12,0)
 D EN^ORKCHK(.ORY,+ORVP,.ORX,"DISPLAY") Q:'$D(ORY)
"RTN","ORCHECK",13,0)
 S I=0 F  S I=$O(ORY(I)) Q:I'>0  W !,$P(ORY(I),U,4) ; display only
"RTN","ORCHECK",14,0)
 Q
"RTN","ORCHECK",15,0)
 ;
"RTN","ORCHECK",16,0)
SELECT ; -- SELECT event
"RTN","ORCHECK",17,0)
 ;    Expects ORVP, ORDAILOG(PROMPT,ORI), ORNMSP
"RTN","ORCHECK",18,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",19,0)
 N ORX,ORY,OI,ORDODSG
"RTN","ORCHECK",20,0)
 S OI=+$G(ORDIALOG(PROMPT,ORI)),ORDODSG=0
"RTN","ORCHECK",21,0)
 S ORX=1,ORX(1)=OI_"|"_ORNMSP_"|"_$$USID^ORMBLD(OI)
"RTN","ORCHECK",22,0)
 D EN^ORKCHK(.ORY,+ORVP,.ORX,"SELECT",,.ORDODSG),RETURN:$D(ORY)
"RTN","ORCHECK",23,0)
 Q
"RTN","ORCHECK",24,0)
 ;
"RTN","ORCHECK",25,0)
ACCEPT(MODE) ; -- ACCEPT event [called from ORCDLG,ORCACT4,ORCMED]
"RTN","ORCHECK",26,0)
 ;    Expects ORVP, ORDIALOG(), ORNMSP
"RTN","ORCHECK",27,0)
 K ^TMP($J,"ORK XTRA TXT")
"RTN","ORCHECK",28,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",29,0)
 N ORX,ORY,ORZ,OI,ORSTRT,ORI,ORIT,ORID,ORSP,ORDODSG
"RTN","ORCHECK",30,0)
 S:'$L($G(MODE)) MODE="ACCEPT"
"RTN","ORCHECK",31,0)
 S OI=$$PTR^ORCD("OR GTX ORDERABLE ITEM"),ORSTRT=$$START,ORX=0,ORDODSG=0
"RTN","ORCHECK",32,0)
 S ORI=0 F  S ORI=$O(ORDIALOG(OI,ORI)) Q:ORI'>0  D STUF
"RTN","ORCHECK",33,0)
 I $G(ORDG)=+$O(^ORD(100.98,"B","IV RX",0)) S OI=$$PTR^ORCD("OR GTX ADDITIVE"),ORI=0 F  S ORI=$O(ORDIALOG(OI,ORI)) Q:ORI'>0  D STUF
"RTN","ORCHECK",34,0)
 D EN^ORKCHK(.ORY,+ORVP,.ORX,MODE,,.ORDODSG),RETURN:$D(ORY),FDBDOWN(0)
"RTN","ORCHECK",35,0)
 Q
"RTN","ORCHECK",36,0)
STUF S ORIT=ORDIALOG(OI,ORI),ORSP=""
"RTN","ORCHECK",37,0)
 S:ORNMSP="LR" ORSP=+$G(ORDIALOG($$PTR^ORCD("OR GTX SPECIMEN"),ORI))
"RTN","ORCHECK",38,0)
 S ORID=$S($E(ORNMSP,1,2)="PS":$$DRUG(ORIT,OI),1:$$USID^ORMBLD(ORIT))
"RTN","ORCHECK",39,0)
 S ORZ=1,ORZ(1)=ORIT_"|"_ORNMSP_"|"_ORID
"RTN","ORCHECK",40,0)
 I MODE'="ALL" D EN^ORKCHK(.ORY,+ORVP,.ORZ,"SELECT",,.ORDODSG),RETURN:$D(ORY)
"RTN","ORCHECK",41,0)
 S ORX=ORX+1,ORX(ORX)=ORZ(1)_"|"_ORSTRT_"||"_ORSP K ORY,ORZ
"RTN","ORCHECK",42,0)
 Q
"RTN","ORCHECK",43,0)
 ;
"RTN","ORCHECK",44,0)
DELAY(MODE) ; -- Delayed ACCEPT event [called from ORMEVNT]
"RTN","ORCHECK",45,0)
 ;    Expects ORVP, ORIFN
"RTN","ORCHECK",46,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",47,0)
 N ORX,ORY,ORCHECK,ORDODSG S:'$L($G(MODE)) MODE="NOTIF"
"RTN","ORCHECK",48,0)
 S ORDODSG=0
"RTN","ORCHECK",49,0)
 D BLD(+ORIFN),EN^ORKCHK(.ORY,+ORVP,.ORX,MODE,,.ORDODSG) Q:'$D(ORY)
"RTN","ORCHECK",50,0)
 D RETURN I MODE="NOTIF" S ORCHECK("OK")="Notification sent to provider" D OC^ORCSAVE2 Q  ; silent
"RTN","ORCHECK",51,0)
 Q
"RTN","ORCHECK",52,0)
 ;
"RTN","ORCHECK",53,0)
BLD(ORDER) ; -- Build new ORX(#) for ORDER
"RTN","ORCHECK",54,0)
 Q:'$G(ORDER)  Q:'$D(^OR(100,ORDER,0))  ;Q:$P($G(^(3)),U,11)  ;edit/renew
"RTN","ORCHECK",55,0)
 N PKG,START,ORI,ITEM,USID,SPEC,ORDG,PTR,INST,ORXSETIV
"RTN","ORCHECK",56,0)
 S ORXSETIV=0
"RTN","ORCHECK",57,0)
 S ORDG=$P(^OR(100,ORDER,0),U,11),PKG=$$GET1^DIQ(9.4,$P(^(0),U,14)_",",1)
"RTN","ORCHECK",58,0)
 I PKG="PS",$G(ORDG) S ORI=$P($G(^ORD(100.98,+ORDG,0)),U,3),ORI=$P(ORI," "),PKG=PKG_$S(ORI="UD":"I",1:ORI)
"RTN","ORCHECK",59,0)
 S START=$$START(ORDER),ORI=0
"RTN","ORCHECK",60,0)
 I PKG="PSJ" D
"RTN","ORCHECK",61,0)
 .N ORITEMS,IDX
"RTN","ORCHECK",62,0)
 .D MAYBEIV^ORWDXR01(.ORITEMS,ORDER)
"RTN","ORCHECK",63,0)
 .Q:$G(ORITEMS)=""
"RTN","ORCHECK",64,0)
 .F IDX=1:1:$L(ORITEMS,U) D
"RTN","ORCHECK",65,0)
 ..S ORX=+$G(ORX)+1,ORX(ORX)=$P(ORITEMS,U,IDX),$P(ORX(ORX),"|",3)=$$DRUG(+ORX(ORX),$P(ORX(ORX),"|",3),ORDER)
"RTN","ORCHECK",66,0)
 ..S $P(ORX(ORX),"|",4)=START
"RTN","ORCHECK",67,0)
 ..S ORXSETIV=1
"RTN","ORCHECK",68,0)
 Q:ORXSETIV
"RTN","ORCHECK",69,0)
 F  S ORI=$O(^OR(100,ORDER,4.5,"ID","ORDERABLE",ORI)) Q:ORI'>0  D
"RTN","ORCHECK",70,0)
 . S INST=$P($G(^OR(100,ORDER,4.5,ORI,0)),U,3),PTR=$P($G(^(0)),U,2),ITEM=+$G(^(1))
"RTN","ORCHECK",71,0)
 . S USID=$S(PKG?1"PS".E:$$DRUG(ITEM,PTR,ORDER),1:$$USID^ORMBLD(ITEM))
"RTN","ORCHECK",72,0)
 . S SPEC=$S(PKG="LR":$$VALUE^ORCSAVE2(ORDER,"SPECIMEN",INST),1:"")
"RTN","ORCHECK",73,0)
 . S ORX=+$G(ORX)+1,ORX(ORX)=ITEM_"|"_PKG_"|"_USID_"|"_START_"|"_ORDER_"|"_SPEC
"RTN","ORCHECK",74,0)
 Q
"RTN","ORCHECK",75,0)
 ;
"RTN","ORCHECK",76,0)
REMDUPS ;
"RTN","ORCHECK",77,0)
 N IFN,CDL,I,J,CDL2
"RTN","ORCHECK",78,0)
 S IFN=0 F  S IFN=$O(ORCHECK(IFN)) Q:'IFN  D
"RTN","ORCHECK",79,0)
 . S CDL=0 F  S CDL=$O(ORCHECK(IFN,CDL)) Q:'CDL  D
"RTN","ORCHECK",80,0)
 .. S I=0 F  S I=$O(ORCHECK(IFN,CDL,I)) Q:'I  D
"RTN","ORCHECK",81,0)
 ... S CDL2=0 F  S CDL2=$O(ORCHECK(IFN,CDL2)) Q:'CDL2  D
"RTN","ORCHECK",82,0)
 .... S J=I F  S J=$O(ORCHECK(IFN,CDL2,J)) Q:'J  I $TR($P($G(ORCHECK(IFN,CDL,I)),U,3),";",",")=$TR($P($G(ORCHECK(IFN,CDL2,J)),U,3),";",",") D
"RTN","ORCHECK",83,0)
 ..... I CDL2<=CDL K ORCHECK(IFN,CDL2,J) S ORCHECK=$G(ORCHECK)-1
"RTN","ORCHECK",84,0)
 ..... I CDL2>CDL S $P(ORCHECK(IFN,CDL,I),U,7)="X"
"RTN","ORCHECK",85,0)
 ... I $P(ORCHECK(IFN,CDL,I),U,7)="X" K ORCHECK(IFN,CDL,I) S ORCHECK=$G(ORCHECK)-1
"RTN","ORCHECK",86,0)
 Q
"RTN","ORCHECK",87,0)
 ;
"RTN","ORCHECK",88,0)
START(DA) ; -- Returns start date/time
"RTN","ORCHECK",89,0)
 N I,X,Y,%DT S Y=""
"RTN","ORCHECK",90,0)
 I $G(DA) S X=$O(^OR(100,DA,4.5,"ID","START",0)),X=$G(^OR(100,DA,4.5,+X,1))
"RTN","ORCHECK",91,0)
 E  D  ; look in ORDIALOG instead
"RTN","ORCHECK",92,0)
 . S I=0 F  S I=$O(ORDIALOG(I)) Q:I'>0  Q:$P(ORDIALOG(I),U,2)="START"
"RTN","ORCHECK",93,0)
 . S X=$S(I:$G(ORDIALOG(I,1)),1:"")
"RTN","ORCHECK",94,0)
 D AM^ORCSAVE2:X="AM",NEXT^ORCSAVE2:X="NEXT"
"RTN","ORCHECK",95,0)
 D ADMIN^ORCSAVE2("NEXT"):X="NEXTA",ADMIN^ORCSAVE2("CLOSEST"):X="CLOSEST"
"RTN","ORCHECK",96,0)
 I $L(X) S %DT="TX" D ^%DT S:Y'>0 Y=""
"RTN","ORCHECK",97,0)
 Q Y
"RTN","ORCHECK",98,0)
 ;
"RTN","ORCHECK",99,0)
DRUG(OI,PTR,IFN) ; -- Returns 6 ^-piece identifier for Dispense Drug
"RTN","ORCHECK",100,0)
 N ORDD,ORNDF,Y
"RTN","ORCHECK",101,0)
 I ORDG=+$O(^ORD(100.98,"B","IV RX",0)) S ORDD=$$IV G D1
"RTN","ORCHECK",102,0)
 I $G(IFN) S ORDD=$O(^OR(100,IFN,4.5,"ID","DRUG",0)),ORDD=+$G(^OR(100,IFN,4.5,+ORDD,1))
"RTN","ORCHECK",103,0)
 E  S ORDD=+$G(ORDIALOG($$PTR^ORCD("OR GTX DISPENSE DRUG"),1))
"RTN","ORCHECK",104,0)
D1 Q:'ORDD "" S ORNDF=$$ENDCM^PSJORUTL(ORDD)
"RTN","ORCHECK",105,0)
 S Y=$P(ORNDF,U,3)_"^^99NDF^"_ORDD_U_$$NAME50^ORPEAPI(ORDD)_"^99PSD"
"RTN","ORCHECK",106,0)
 Q Y
"RTN","ORCHECK",107,0)
 ;
"RTN","ORCHECK",108,0)
IV() ; -- Get Dispense Drug for IV orderable
"RTN","ORCHECK",109,0)
 N PSOI,TYPE,VOL,ORY
"RTN","ORCHECK",110,0)
 S PSOI=+$P($G(^ORD(101.43,+OI,0)),U,2),VOL=""
"RTN","ORCHECK",111,0)
 S TYPE=$S(PTR=$$PTR^ORCD("OR GTX ADDITIVE"):"A",1:"B")
"RTN","ORCHECK",112,0)
 S:TYPE="B" VOL=$S($G(IFN):$$VALUE^ORCSAVE2(IFN,"VOLUME"),1:+$G(ORDIALOG($$PTR^ORCD("OR GTX VOLUME"),1)))
"RTN","ORCHECK",113,0)
 D ENDDIV^PSJORUTL(PSOI,TYPE,VOL,.ORY)
"RTN","ORCHECK",114,0)
 Q +$G(ORY)
"RTN","ORCHECK",115,0)
 ;
"RTN","ORCHECK",116,0)
LIST(IFN) ; -- Displays list of ORCHECK(IFN) checks
"RTN","ORCHECK",117,0)
 N ORI,ORJ,ORZ,ORMAX,ORTX,ON,OFF
"RTN","ORCHECK",118,0)
 S ORZ=0 F  S ORZ=$O(ORCHECK(IFN,ORZ)) Q:ORZ'>0  D
"RTN","ORCHECK",119,0)
 . S:ORZ=1 ON=IOINHI,OFF=IOINORM S:ORZ'=1 (ON,OFF)="" ; use bold if High
"RTN","ORCHECK",120,0)
 . S ORI=0 F  S ORI=$O(ORCHECK(IFN,ORZ,ORI)) Q:ORI'>0  D
"RTN","ORCHECK",121,0)
 . . S X=$P(ORCHECK(IFN,ORZ,ORI),U,3) I $L(X)<75 W !,ON_">>>  "_X_OFF Q
"RTN","ORCHECK",122,0)
 . . S ORMAX=74 K ORTX D TXT^ORCHTAB Q:'$G(ORTX)  ; wrap
"RTN","ORCHECK",123,0)
 . . F ORJ=1:1:ORTX W !,ON_$S(ORJ=1:">>>  ",1:"      ")_ORTX(ORJ)_OFF
"RTN","ORCHECK",124,0)
 W !
"RTN","ORCHECK",125,0)
 Q
"RTN","ORCHECK",126,0)
 ;
"RTN","ORCHECK",127,0)
CANCEL() ; -- Returns 1 or 0: Cancel order(s)?
"RTN","ORCHECK",128,0)
 N X,Y,DIR,NUM
"RTN","ORCHECK",129,0)
 S NUM=+$G(ORCHECK("IFN")),DIR(0)="YA"
"RTN","ORCHECK",130,0)
 S DIR("A")="Do you want to cancel "_$S(NUM>1:"any of the new orders? ",1:"the new order? ")
"RTN","ORCHECK",131,0)
 S DIR("?",1)="Enter YES to cancel "_$S(NUM>1:"an",1:"the")_" order.  If you wish to override these order checks"
"RTN","ORCHECK",132,0)
 S DIR("?",2)="and release "_$S(NUM>1:"these orders",1:"this order")_", enter NO; you will be prompted for a justification",DIR("?")="if there are any highlighted critical order checks."
"RTN","ORCHECK",133,0)
 D ^DIR
"RTN","ORCHECK",134,0)
 Q +Y
"RTN","ORCHECK",135,0)
 ;
"RTN","ORCHECK",136,0)
REASON() ; -- Reason for overriding order checks
"RTN","ORCHECK",137,0)
 ; I '$D(^XUSEC("ORES",DUZ)),'$D(^XUSEC("ORELSE",DUZ)) Q  ??
"RTN","ORCHECK",138,0)
 N X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","ORCHECK",139,0)
 S DIR(0)="FA^2:80^K:X?1."" "" X",DIR("A")="REASON FOR OVERRIDE: "
"RTN","ORCHECK",140,0)
 S DIR("?")="Enter a justification for overriding these order checks, up to 80 characters"
"RTN","ORCHECK",141,0)
 D ^DIR I $D(DTOUT)!$D(DUOUT) S Y="^"
"RTN","ORCHECK",142,0)
 Q Y
"RTN","ORCHECK",143,0)
 ;
"RTN","ORCHECK",144,0)
SESSION ; -- SESSION event [called from ORCSIGN]
"RTN","ORCHECK",145,0)
 ;    Expects ORVP, ORES()
"RTN","ORCHECK",146,0)
 K ^TMP($J,"ORK XTRA TXT")
"RTN","ORCHECK",147,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",148,0)
 N ORX,ORY,ORIFN,I,X,Y,ORGLOB
"RTN","ORCHECK",149,0)
 S ORGLOB=$H
"RTN","ORCHECK",150,0)
 K ^TMP($J,ORGLOB)
"RTN","ORCHECK",151,0)
 S ORIFN=0 F  S ORIFN=$O(ORES(ORIFN)) Q:ORIFN'>0  I +$P(ORIFN,";",2)'>1 D
"RTN","ORCHECK",152,0)
 . I "^14^13^11^10^"'[(U_$P($G(^OR(100,+ORIFN,3)),U,3)_U) Q  ;unreleased
"RTN","ORCHECK",153,0)
 . D BLD(+ORIFN) K ^TMP($J,"OCDATA") Q:'$$OCAPI^ORCHECK(+ORIFN,"OCDATA")
"RTN","ORCHECK",154,0)
 . S ORCHECK("IFN")=+$G(ORCHECK("IFN"))+1
"RTN","ORCHECK",155,0)
 . S I=0 F  S I=$O(^TMP($J,"OCDATA",I)) Q:'I  D
"RTN","ORCHECK",156,0)
 . . I $G(^TMP($J,"OCDATA",I,"OC NUMBER"))=32,$$ALGASS(+ORIFN)=1 Q
"RTN","ORCHECK",157,0)
 . . I $G(^TMP($J,"OCDATA",I,"OC NUMBER"))=3 Q
"RTN","ORCHECK",158,0)
 . . I $G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))["Drug-Drug order checks (Duplicate Therapy, Duplicate Drug, Drug Interaction) were not able to be performed." Q
"RTN","ORCHECK",159,0)
 . . S ORCHECK=+$G(ORCHECK)+1,ORCHECK(+ORIFN,$S($G(^TMP($J,"OCDATA",I,"OC LEVEL")):^TMP($J,"OCDATA",I,"OC LEVEL"),1:99),ORCHECK)=$G(^TMP($J,"OCDATA",I,"OC NUMBER"))_U_$G(^TMP($J,"OCDATA",I,"OC LEVEL"))_U_$G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))_U_1
"RTN","ORCHECK",160,0)
 . . I $O(^TMP($J,"OCDATA",I,"OC TEXT",1)) D
"RTN","ORCHECK",161,0)
 . . . S ORCHECK(+ORIFN,$S($G(^TMP($J,"OCDATA",I,"OC LEVEL")):^TMP($J,"OCDATA",I,"OC LEVEL"),1:99),ORCHECK)=$G(^TMP($J,"OCDATA",I,"OC NUMBER"))_U_$G(^TMP($J,"OCDATA",I,"OC LEVEL"))_U_"||"_ORGLOB_"&"_$G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))_U_1
"RTN","ORCHECK",162,0)
 . . . N ORI S ORI=0 F  S ORI=$O(^TMP($J,"OCDATA",I,"OC TEXT",ORI)) Q:'ORI  S ^TMP($J,"ORK XTRA TXT",ORGLOB,^TMP($J,"OCDATA",I,"OC TEXT",1,0),ORI)=^TMP($J,"OCDATA",I,"OC TEXT",ORI,0)
"RTN","ORCHECK",163,0)
 . . . I ($G(^TMP($J,"OCDATA",I,"OC NUMBER"))=35)!($G(^TMP($J,"OCDATA",I,"OC NUMBER"))=36) D
"RTN","ORCHECK",164,0)
 . . . . N ORCROC1,ORCROC2,ORPIECE1,ORPIECE2
"RTN","ORCHECK",165,0)
 . . . . S ORCROC1=$P($G(^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),12)),U)
"RTN","ORCHECK",166,0)
 . . . . S ORCROC2=$P($G(^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),12)),U,2)
"RTN","ORCHECK",167,0)
 . . . . S ORPIECE1=$G(^TMP($J,"OCDATA",I,"OC NUMBER"))
"RTN","ORCHECK",168,0)
 . . . . S ORPIECE2=$G(^TMP($J,"OCDATA",I,"OC LEVEL"))_U_"||"_ORGLOB_"&"_$G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))_"&"_ORCROC1_"&"_ORCROC2_U_1
"RTN","ORCHECK",169,0)
 . . . . S ORCHECK(+ORIFN,$S($G(^TMP($J,"OCDATA",I,"OC LEVEL")):^TMP($J,"OCDATA",I,"OC LEVEL"),1:99),ORCHECK)=ORPIECE1_U_ORPIECE2
"RTN","ORCHECK",170,0)
 . . I $D(^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),16)) D
"RTN","ORCHECK",171,0)
 . . . N ORMONOI S ORMONOI=$O(^TMP($J,"ORMONOGRAPH",""),-1)+1
"RTN","ORCHECK",172,0)
 . . . M ^TMP($J,"ORMONOGRAPH",ORMONOI,"DATA")=^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),16)
"RTN","ORCHECK",173,0)
 . . . S ^TMP($J,"ORMONOGRAPH",ORMONOI,"INT")=^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),17)
"RTN","ORCHECK",174,0)
 . . . S ^TMP($J,"ORMONOGRAPH",ORMONOI,"OC")=$G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))
"RTN","ORCHECK",175,0)
 . K ^TMP($J,"OCDATA")
"RTN","ORCHECK",176,0)
 I $D(ORX) D EN^ORKCHK(.ORY,+ORVP,.ORX,"SESSION"),RETURN:$D(ORY),FDBDOWN(1),REMDUPS
"RTN","ORCHECK",177,0)
 Q
"RTN","ORCHECK",178,0)
 ;
"RTN","ORCHECK",179,0)
FDBDOWN(ORX) ; -- Checks to see if the FDB was down and if so set appropriate OC
"RTN","ORCHECK",180,0)
 ; expects ORCHECK array of order checks
"RTN","ORCHECK",181,0)
 ; if ORX is 1 then this is getting called from SESSION order checks
"RTN","ORCHECK",182,0)
 Q:'$D(ORCHECK)
"RTN","ORCHECK",183,0)
 ;look for the "not able to be performed" OCs for each type (DSG and ENH), set flag for each to 1 if found and remove them from ORCHECK
"RTN","ORCHECK",184,0)
 N I S I="" F  S I=$O(ORCHECK(I)) Q:'$L(I)  D
"RTN","ORCHECK",185,0)
 .N ORNEXT,ORDSG,ORENH,ORTHERE
"RTN","ORCHECK",186,0)
 .S ORDSG=0,ORENH=0,ORTHERE=0,ORNEXT=1
"RTN","ORCHECK",187,0)
 .N J S J=0 F  S J=$O(ORCHECK(I,J)) Q:'J  D
"RTN","ORCHECK",188,0)
 ..N K S K=0 F  S K=$O(ORCHECK(I,J,K)) Q:'K  D
"RTN","ORCHECK",189,0)
 ...I (K+1)>ORNEXT S ORNEXT=K+1
"RTN","ORCHECK",190,0)
 ...I $G(ORCHECK(I,J,K))[$$DSDWNMSG^ORDSGCHK K ORCHECK(I,J,K) S ORDSG=1
"RTN","ORCHECK",191,0)
 ...I $G(ORCHECK(I,J,K))["Drug-Drug order checks (Duplicate Therapy, Duplicate Drug, Drug Interaction) were not able to be performed." K ORCHECK(I,J,K) S ORENH=1
"RTN","ORCHECK",192,0)
 ...I $G(ORCHECK(I,J,K))["These checks could not be completed for this patient:" S ORTHERE=1
"RTN","ORCHECK",193,0)
 .;if DSG or ENH flag is set then add to ORY
"RTN","ORCHECK",194,0)
 .I ORDSG!(ORENH) D
"RTN","ORCHECK",195,0)
 ..;look to see if message already exists
"RTN","ORCHECK",196,0)
 ..I ORTHERE Q
"RTN","ORCHECK",197,0)
 ..N ORKGLOB S ORKGLOB=$H_","_I
"RTN","ORCHECK",198,0)
 ..N ORMAIN S ORMAIN="These checks could not be completed for this patient:"
"RTN","ORCHECK",199,0)
 ..S ORCHECK(I,2,ORNEXT)="25^2^||"_ORKGLOB_"&"_ORMAIN
"RTN","ORCHECK",200,0)
 ..I $G(ORX) S ^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,0)=ORMAIN
"RTN","ORCHECK",201,0)
 ..N ORCNT S ORCNT=1
"RTN","ORCHECK",202,0)
 ..I ORENH S ORCNT=ORCNT+1,^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,ORCNT)="      Drug Interactions"
"RTN","ORCHECK",203,0)
 ..I ORENH S ORCNT=ORCNT+1,^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,ORCNT)="      Duplicate Therapy"
"RTN","ORCHECK",204,0)
 ..I '$G(ORX),ORDSG S ORCNT=ORCNT+1,^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,ORCNT)="      Dosing"
"RTN","ORCHECK",205,0)
 Q
"RTN","ORCHECK",206,0)
 ;
"RTN","ORCHECK",207,0)
RETURN ; -- Return checks in ORCHECK(ORIFN,CDL,#)
"RTN","ORCHECK",208,0)
 N I,IFN,CDL S I=0 F  S I=$O(ORY(I)) Q:I'>0  D
"RTN","ORCHECK",209,0)
 . S IFN=+$P(ORY(I),U) S:'IFN IFN="NEW"
"RTN","ORCHECK",210,0)
 . S CDL=+$P(ORY(I),U,3) S:'CDL CDL=99
"RTN","ORCHECK",211,0)
 . S:'$D(ORCHECK(IFN)) ORCHECK("IFN")=+$G(ORCHECK("IFN"))+1 ; count
"RTN","ORCHECK",212,0)
 . S ORCHECK=+$G(ORCHECK)+1,ORCHECK(IFN,CDL,ORCHECK)=$P(ORY(I),U,2,4)
"RTN","ORCHECK",213,0)
 Q
"RTN","ORCHECK",214,0)
 ;
"RTN","ORCHECK",215,0)
ALGASS(ORIFN) ;see if patient from order has an allergy assessment
"RTN","ORCHECK",216,0)
 N ORDFN S ORDFN=+$P(^OR(100,ORIFN,0),U,2)
"RTN","ORCHECK",217,0)
 K ORARRAY D EN1^GMRAOR1(ORDFN,"ORARRAY")
"RTN","ORCHECK",218,0)
 I ORARRAY'="" Q 1
"RTN","ORCHECK",219,0)
 Q 0
"RTN","ORCHECK",220,0)
OCAPI(IFN,ORPLACE) ;IA #4859
"RTN","ORCHECK",221,0)
 ;LOOK AT ROUTINE OROCAPI1 FOR MORE DETAILED APIS
"RTN","ORCHECK",222,0)
 ;API to get the order checking info for a specific order (IFN)
"RTN","ORCHECK",223,0)
 ;info is stored in ^TMP($J,ORPLACE)
"RTN","ORCHECK",224,0)
 ;               ^TMP($J,ORPLACE,D0,"OC LEVEL")="order check level"
"RTN","ORCHECK",225,0)
 ;                                                 ,"OC NUMBER")="file 100.8 ien"
"RTN","ORCHECK",226,0)
 ;                                                 ,"OC TEXT")="order check text"
"RTN","ORCHECK",227,0)
 ;                                                 ,"OR REASON")="over ride reason text"
"RTN","ORCHECK",228,0)
 ;                                                 ,"OR PROVIDER")="provider DUZ who entered over ride reason"
"RTN","ORCHECK",229,0)
 ;                                                 ,"OR DT")="date/time over ride reason was entered"
"RTN","ORCHECK",230,0)
 ; NOTE on OC LEVEL: 1 is HIGH, 2 is MODERATE, 3 is LOW
"RTN","ORCHECK",231,0)
 N RET,ORN,CNT,I,ORFLAG
"RTN","ORCHECK",232,0)
 S ORN=+IFN,CNT=0,ORFLAG=0
"RTN","ORCHECK",233,0)
 ;if the order is not released then show ACCEPTANCE_CPRS ocs
"RTN","ORCHECK",234,0)
 I "^14^13^11^10^"[(U_$P($G(^OR(100,ORN,3)),U,3)_U) D GETOC5^OROCAPI1(ORN,"ACCEPTANCE_CPRS",.RET) S ORFLAG=1
"RTN","ORCHECK",235,0)
 ;if it has been signed then show SIGNATURE_CPRS ocs
"RTN","ORCHECK",236,0)
 I 'ORFLAG D GETOC5^OROCAPI1(ORN,"SIGNATURE_CPRS",.RET)
"RTN","ORCHECK",237,0)
 I $D(RET) S I=0 F  S I=$O(RET(ORN,"DATA",I)) Q:'I  S CNT=CNT+1 D
"RTN","ORCHECK",238,0)
 .S ^TMP($J,ORPLACE,CNT,"OC NUMBER")=$P($P($G(RET(ORN,"DATA",I,1)),U),";",2)
"RTN","ORCHECK",239,0)
 .S ^TMP($J,ORPLACE,CNT,"OC LEVEL")=$P($G(RET(ORN,"DATA",I,1)),U,2)
"RTN","ORCHECK",240,0)
 .M ^TMP($J,ORPLACE,CNT,"OC TEXT")=RET(ORN,"DATA",I,"OC")
"RTN","ORCHECK",241,0)
 .S ^TMP($J,ORPLACE,CNT,"OR REASON")=$G(RET(ORN,"DATA",I,"OR",1,0))
"RTN","ORCHECK",242,0)
 .S ^TMP($J,ORPLACE,CNT,"OR PROVIDER")=$S($L(^TMP($J,ORPLACE,CNT,"OR REASON")):$P($G(RET(ORN,"DATA",I,0)),U,4),1:"")
"RTN","ORCHECK",243,0)
 .S ^TMP($J,ORPLACE,CNT,"OR DT")=$S($L(^TMP($J,ORPLACE,CNT,"OR REASON")):$P($G(RET(ORN,"DATA",I,0)),U,5),1:"")
"RTN","ORCHECK",244,0)
 .S ^TMP($J,ORPLACE,CNT,"OR STATUS")=$P($G(RET(ORN,"DATA",I,0)),U,2)
"RTN","ORCHECK",245,0)
 .S ^TMP($J,ORPLACE,CNT,"OC INSTANCE")=I
"RTN","ORCHECK",246,0)
 Q CNT
"RTN","ORCHECK",247,0)
 ;
"RTN","ORCHECK",248,0)
ISMONO(ORY) ;returns 1 if there is monograph data for the orderchecks being presented to the user
"RTN","ORCHECK",249,0)
 S ORY=0
"RTN","ORCHECK",250,0)
 Q:'$$PATCH^XPDUTL("OR*3.0*272")
"RTN","ORCHECK",251,0)
 I $D(^TMP($J,"ORMONOGRAPH")) S ORY=1
"RTN","ORCHECK",252,0)
 Q
"RTN","ORCHECK",253,0)
GETMONOL(ORY) ;returns a list of monographs available for the orderchecks being presented to the user
"RTN","ORCHECK",254,0)
 Q:'$D(^TMP($J,"ORMONOGRAPH"))
"RTN","ORCHECK",255,0)
 N I S I=0
"RTN","ORCHECK",256,0)
 F  S I=$O(^TMP($J,"ORMONOGRAPH",I)) Q:'I  D
"RTN","ORCHECK",257,0)
 .S ORY($G(^TMP($J,"ORMONOGRAPH",I,"INT")))=I_U_$G(^TMP($J,"ORMONOGRAPH",I,"INT"))
"RTN","ORCHECK",258,0)
 Q
"RTN","ORCHECK",259,0)
GETMONO(ORY,ORMONO) ;return a monograph
"RTN","ORCHECK",260,0)
 Q:'$D(^TMP($J,"ORMONOGRAPH",ORMONO))
"RTN","ORCHECK",261,0)
 K ^TMP($J,"ORMONORPC")
"RTN","ORCHECK",262,0)
 M ^TMP($J,"ORMONORPC")=^TMP($J,"ORMONOGRAPH",ORMONO,"DATA")
"RTN","ORCHECK",263,0)
 K ^TMP($J,"ORMONORPC",0)
"RTN","ORCHECK",264,0)
 S ORY=$NA(^TMP($J,"ORMONORPC")),@ORY=""
"RTN","ORCHECK",265,0)
 Q
"RTN","ORCHECK",266,0)
DELMONO(ORY) ;delete monograph data
"RTN","ORCHECK",267,0)
 K ^TMP($J,"ORMONOGRAPH"),^TMP($J,"ORMONORPC")
"RTN","ORCHECK",268,0)
 Q
"RTN","ORCHECK",269,0)
GETXTRA(ORY,ORGL,ORRULE) ;get extra text for an order check
"RTN","ORCHECK",270,0)
 ;^TMP($J,"ORK XTRA TXT") stores the text of order checks that are longer than a single line (reminder order checks)
"RTN","ORCHECK",271,0)
 Q:'$D(^TMP($J,"ORK XTRA TXT",ORGL,ORRULE))
"RTN","ORCHECK",272,0)
 M ORY=^TMP($J,"ORK XTRA TXT",ORGL,ORRULE)
"RTN","ORCHECK",273,0)
 Q
"RTN","ORCSAVE")
0^2^B127544119
"RTN","ORCSAVE",1,0)
ORCSAVE ;SLC/MKB/JDL-Save ;01/05/17  13:55
"RTN","ORCSAVE",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**7,56,70,73,92,94,116,141,163,187,190,195,243,303,293,280,306,286,269,423,421,382**;Dec 17, 1997;Build 15
"RTN","ORCSAVE",3,0)
 ;Per VA Directive 6402, this routine should not be modified.
"RTN","ORCSAVE",4,0)
 ;
"RTN","ORCSAVE",5,0)
 ; DBIA 10103   ^XLFDT
"RTN","ORCSAVE",6,0)
 ;
"RTN","ORCSAVE",7,0)
NEW(ORDIALOG,ORDG,ORPKG,ORCAT,OREVENT,ORDUZ,ORLOG) ; -- New order
"RTN","ORCSAVE",8,0)
 ; Returns ORIFN = [new] order number, if created/saved
"RTN","ORCSAVE",9,0)
 D EN
"RTN","ORCSAVE",10,0)
 Q
"RTN","ORCSAVE",11,0)
 ;
"RTN","ORCSAVE",12,0)
XX ; -- save new/unreleased edited order into Orders file
"RTN","ORCSAVE",13,0)
 ;    Requires: ORDIALOG() = array of dialog values
"RTN","ORCSAVE",14,0)
 ;              ORIFN      = IFN of original order that was edited
"RTN","ORCSAVE",15,0)
 ;
"RTN","ORCSAVE",16,0)
 N OLDIFN S ORIFN=+ORIFN,OLDIFN=0
"RTN","ORCSAVE",17,0)
 I $S($P(^OR(100,ORIFN,3),U,3)=11:0,$P(^(3),U,3)'=10:1,$P(^(8,1,0),U,4)=2:0,1:1) S OLDIFN=ORIFN K ORIFN ; create new order if released or delayed&signed
"RTN","ORCSAVE",18,0)
 D EN Q:'ORIFN  S:'$G(ORDA) ORDA=1
"RTN","ORCSAVE",19,0)
 I $G(OLDIFN) D  ;save links between orders
"RTN","ORCSAVE",20,0)
 . S $P(^OR(100,ORIFN,3),U,5)=OLDIFN,$P(^(3),U,11)=1
"RTN","ORCSAVE",21,0)
 . S $P(^OR(100,OLDIFN,3),U,6)=ORIFN S:$D(^(5)) ^OR(100,ORIFN,5)=^OR(100,OLDIFN,5)
"RTN","ORCSAVE",22,0)
 I $D(^OR(100,+OLDIFN,0)) D
"RTN","ORCSAVE",23,0)
 . Q:'$G(OREVTDF)
"RTN","ORCSAVE",24,0)
 . N OLDEVT,OLDSTS,LSTACT,PATID,NOW,WHEN
"RTN","ORCSAVE",25,0)
 . S (OLDEVT,OLDSTS,LSTACT)=0
"RTN","ORCSAVE",26,0)
 . S NOW=$$NOW^XLFDT
"RTN","ORCSAVE",27,0)
 . S OLDEVT=$P(^OR(100,+OLDIFN,0),U,17),OLDSTS=$P(^OR(100,+OLDIFN,3),U,3)
"RTN","ORCSAVE",28,0)
 . ; Active status = 6 from #100.01
"RTN","ORCSAVE",29,0)
 . I (OLDEVT>0),OLDSTS=6 D
"RTN","ORCSAVE",30,0)
 . . S $P(^OR(100,+ORIFN,0),U,17)=OLDEVT
"RTN","ORCSAVE",31,0)
 . . S $P(^OR(100,+ORIFN,3),U,3)=11
"RTN","ORCSAVE",32,0)
 . . S LSTACT=$P($G(^OR(100,+ORIFN,3)),U,7)
"RTN","ORCSAVE",33,0)
 . . I $D(^OR(100,+ORIFN,8,LSTACT,0)) D
"RTN","ORCSAVE",34,0)
 . . . S $P(^OR(100,+ORIFN,8,LSTACT,0),U,15)=11
"RTN","ORCSAVE",35,0)
 . . . S PATID=$P(^OR(100,+ORIFN,0),U,2)
"RTN","ORCSAVE",36,0)
 . . . S WHEN=$P(^OR(100,+ORIFN,8,LSTACT,0),U)
"RTN","ORCSAVE",37,0)
 . . . S ^OR(100,"AC",PATID,9999999-WHEN,+ORIFN,LSTACT)=""
"RTN","ORCSAVE",38,0)
 Q
"RTN","ORCSAVE",39,0)
 ;
"RTN","ORCSAVE",40,0)
RN ; -- save new/unreleased renewal order into Orders file
"RTN","ORCSAVE",41,0)
 ;    Requires: ORDIALOG() = array of new dialog values
"RTN","ORCSAVE",42,0)
 ;              ORIFN      = IFN of original order that was renewed
"RTN","ORCSAVE",43,0)
 ;
"RTN","ORCSAVE",44,0)
 N OLDIFN S OLDIFN=+ORIFN K ORIFN
"RTN","ORCSAVE",45,0)
 D EN Q:'ORIFN  S:'$G(ORDA) ORDA=1
"RTN","ORCSAVE",46,0)
 S $P(^OR(100,ORIFN,3),U,5)=OLDIFN,$P(^(3),U,11)=2
"RTN","ORCSAVE",47,0)
 S $P(^OR(100,OLDIFN,3),U,6)=ORIFN S:$D(^(5)) ^OR(100,ORIFN,5)=^OR(100,OLDIFN,5)
"RTN","ORCSAVE",48,0)
 Q
"RTN","ORCSAVE",49,0)
 ;
"RTN","ORCSAVE",50,0)
EN ; -- save new/unreleased order in ORDIALOG() into Orders file
"RTN","ORCSAVE",51,0)
 ;    Requires: ORVP, ORNP [and ORL, ORTS, ORAPPT if available]
"RTN","ORCSAVE",52,0)
 ;    If defined: ORCAT,ORPKG,ORDG,ORLOG,ORDUZ,OREVENT,ORDCNTRL,ORSRC
"RTN","ORCSAVE",53,0)
 ;     (else use values from ORDIALOG and current state)
"RTN","ORCSAVE",54,0)
 ;
"RTN","ORCSAVE",55,0)
 N PKG,NOW,NODE,CNT,CDL,I,X,STS,SIGNREQD,LOC,TRSPEC,NATR,CATG,DG,LOG,USR,TYPE,ORK
"RTN","ORCSAVE",56,0)
 Q:'$G(ORVP)  Q:'$G(ORDIALOG)  Q:'$D(^ORD(101.41,+ORDIALOG,0))
"RTN","ORCSAVE",57,0)
 S NOW=$$NOW^XLFDT,SIGNREQD=+$P(^ORD(101.41,+ORDIALOG,0),U,6)
"RTN","ORCSAVE",58,0)
 S CATG=$S($L($G(ORCAT)):ORCAT,1:$S($$INPT^ORCD:"I",1:"O"))
"RTN","ORCSAVE",59,0)
 S PKG=$S($G(ORPKG):ORPKG,1:$P(^ORD(101.41,+ORDIALOG,0),U,7))
"RTN","ORCSAVE",60,0)
 S LOG=$S($G(ORLOG):ORLOG,1:+$E(NOW,1,12)),USR=$S($G(ORDUZ):ORDUZ,1:DUZ)
"RTN","ORCSAVE",61,0)
 I $G(ORIFN),$D(^OR(100,ORIFN,0)) S STS=$P(^(3),U,3) G EN2 ; unrel order
"RTN","ORCSAVE",62,0)
 S DG=$S($G(ORDG):+ORDG,1:$P(^ORD(101.41,+ORDIALOG,0),U,5))
"RTN","ORCSAVE",63,0)
 I $G(OREVENT),"^PSO^RA^"'["^"_$$GET1^DIQ(9.4,+PKG_",",1)_"^",'$G(DGPMT) S LOC="",TRSPEC="" ; p286 added radiology package
"RTN","ORCSAVE",64,0)
 E  S LOC=$G(ORL),TRSPEC=$G(ORTS)
"RTN","ORCSAVE",65,0)
 S TYPE=$S("^B^C^X^P^0^"[(U_$G(ORSRC)_U):ORSRC,$G(ORDCNTRL)="SN":"P",1:0)
"RTN","ORCSAVE",66,0)
 ;S LOG=$S($G(ORLOG):ORLOG,1:+$E(NOW,1,12)),USR=$S($G(ORDUZ):ORDUZ,1:DUZ) moved up before EN2 call
"RTN","ORCSAVE",67,0)
 S NATR=+$O(^ORD(100.02,"C","E",0)) ;assume Elec Entered until changed
"RTN","ORCSAVE",68,0)
 S STS=$S($G(OREVENT):10,1:11),ORIFN=$$NEXTIFN Q:'ORIFN
"RTN","ORCSAVE",69,0)
EN1 S ^OR(100,ORIFN,0)=ORIFN_U_ORVP_U_U_$G(ORNP)_U_+ORDIALOG_";ORD(101.41,^"_USR_U_LOG_U_U_U_LOC_U_DG_U_CATG_U_TRSPEC_U_PKG_U_U_SIGNREQD_U_$G(OREVENT)_U_$G(ORAPPT)
"RTN","ORCSAVE",70,0)
 S ^OR(100,ORIFN,3)=LOG_"^90^"_STS_U_$S($G(ORIT):ORIT_";ORD(101.41,",1:"")_U_$G(ORDIALOG("PREV"))_"^^1^^^^"_TYPE
"RTN","ORCSAVE",71,0)
 S ^OR(100,ORIFN,8,0)="^100.008DA^1^1",^OR(100,ORIFN,8,1,0)=LOG_"^NW^"_$G(ORNP)_U_$S(SIGNREQD:2,1:3)_"^^^^^^^^"_NATR_U_USR_"^1^"_STS,^OR(100,ORIFN,8,"C","NW",1)=""
"RTN","ORCSAVE",72,0)
 S ^OR(100,"AF",LOG,ORIFN,1)=""
"RTN","ORCSAVE",73,0)
 S ^OR(100,"C",+ORDIALOG_";ORD(101.41,",ORIFN)=""  ;patch 423
"RTN","ORCSAVE",74,0)
 S ^OR(100,"D",+ORDIALOG_";ORD(101.41,",ORIFN)=""  ;patch 423
"RTN","ORCSAVE",75,0)
 S ^OR(100,"ACT",ORVP,9999999-LOG,+DG,ORIFN,1)=""
"RTN","ORCSAVE",76,0)
 ;US10045 - PB - Nov 19, 2015 modification to capture the order create date/time with seconds in HMP(800000 orders multiple to track seconds
"RTN","ORCSAVE",77,0)
 D:$P(ORVP,";",2)="DPT("
"RTN","ORCSAVE",78,0)
 . N RSLT,VALS
"RTN","ORCSAVE",79,0)
 . S VALS(.02)=$$NOW^XLFDT
"RTN","ORCSAVE",80,0)
 . D ADDORDR^HMPOR(.RSLT,.VALS,ORIFN,+ORVP)  ;ORVP is variable pointer
"RTN","ORCSAVE",81,0)
 . Q:RSLT<0  ; sub-file entry not created
"RTN","ORCSAVE",82,0)
 . D COMP^ORMBLDOR(+$G(ORIFN)) ;Nov 12, 2015 - PB - trigger unsolicited sync action when order is saved
"RTN","ORCSAVE",83,0)
 ;
"RTN","ORCSAVE",84,0)
 S:STS'=10 ^OR(100,"AC",ORVP,9999999-LOG,ORIFN,1)=""
"RTN","ORCSAVE",85,0)
 S:SIGNREQD ^OR(100,"AS",ORVP,9999999-LOG,ORIFN,1)=""
"RTN","ORCSAVE",86,0)
 S:$G(OREVENT) ^OR(100,"AEVNT",ORVP,OREVENT,ORIFN)=""
"RTN","ORCSAVE",87,0)
 ;check if OR GTX STUDY REASON is in ORDIALOG and strip out control characters
"RTN","ORCSAVE",88,0)
 N ORRFSID
"RTN","ORCSAVE",89,0)
 S ORRFSID=$O(^ORD(101.41,"B","OR GTX STUDY REASON",""))
"RTN","ORCSAVE",90,0)
 I ORRFSID,$D(ORDIALOG(ORRFSID,1)) D
"RTN","ORCSAVE",91,0)
 .N X,I
"RTN","ORCSAVE",92,0)
 .S X=ORDIALOG(ORRFSID,1)
"RTN","ORCSAVE",93,0)
 .F I=1:1:31 S X=$TR(X,$C(I))
"RTN","ORCSAVE",94,0)
 .S ORDIALOG(ORRFSID,1)=X
"RTN","ORCSAVE",95,0)
EN2 S ORIFN=+ORIFN D RESPONSE ; save responses
"RTN","ORCSAVE",96,0)
 I $P(^OR(100,ORIFN,0),"^",5) D  ;Copy orders PKI fix
"RTN","ORCSAVE",97,0)
 . N OI,ORPKIU
"RTN","ORCSAVE",98,0)
 . S OI=+$O(^OR(100,ORIFN,4.5,"ID","ORDERABLE",0)),OI=+$G(^OR(100,ORIFN,4.5,OI,1)) Q:'OI
"RTN","ORCSAVE",99,0)
 . I PKG'=$O(^DIC(9.4,"B","OUTPATIENT PHARMACY",0)) Q
"RTN","ORCSAVE",100,0)
 . S ORPKIU=0 I $D(^ORD(100.7,"C",DUZ)) S ORPKIU=1
"RTN","ORCSAVE",101,0)
 . D PKI^ORWDPS1(.ORY,OI,CATG,+ORVP,ORPKIU)
"RTN","ORCSAVE",102,0)
 . I $E($G(ORY))=2 S ORDEA=ORY
"RTN","ORCSAVE",103,0)
 K ^OR(100,ORIFN,8,1,.1) D ORDTEXT^ORCSAVE1(ORIFN_";1") ; order text
"RTN","ORCSAVE",104,0)
 S NODE=$G(^OR(100,ORIFN,8,1,0)) D  S ^OR(100,ORIFN,8,1,0)=NODE
"RTN","ORCSAVE",105,0)
 . S $P(NODE,U,3)=$G(ORNP)
"RTN","ORCSAVE",106,0)
 . S $P(NODE,U,13)=USR
"RTN","ORCSAVE",107,0)
 S NODE=$G(^OR(100,ORIFN,0)) D  S ^OR(100,ORIFN,0)=NODE
"RTN","ORCSAVE",108,0)
 . S $P(NODE,U,4)=$G(ORNP)
"RTN","ORCSAVE",109,0)
 . S I=$O(^OR(100,ORIFN,4.5,"ID","LOCATION",0))
"RTN","ORCSAVE",110,0)
 . I I,$P(NODE,U,10) S X=+$G(^OR(100,ORIFN,4.5,+I,1)) S:X $P(NODE,U,10)=X_";SC(" ;reset Loc if prev value
"RTN","ORCSAVE",111,0)
 . S I=$O(^OR(100,ORIFN,4.5,"ID","CLASS",0))
"RTN","ORCSAVE",112,0)
 . I I S X=$G(^OR(100,ORIFN,4.5,+I,1)) S:"^I^O^"[(U_X_U) $P(NODE,U,12)=X
"RTN","ORCSAVE",113,0)
 S $P(^OR(100,ORIFN,3),U)=NOW
"RTN","ORCSAVE",114,0)
 D DELOCC^OROCAPI1(ORIFN,"ACCEPTANCE_CPRS")
"RTN","ORCSAVE",115,0)
 I $G(ORCHECK) D  ; save order checks
"RTN","ORCSAVE",116,0)
 . N ORCROC
"RTN","ORCSAVE",117,0)
 . S (CNT,CDL)=0 F  S CDL=$O(ORCHECK("NEW",CDL)) Q:CDL'>0  S I=0 D
"RTN","ORCSAVE",118,0)
 . . F  S I=$O(ORCHECK("NEW",CDL,I)) Q:I'>0  D
"RTN","ORCSAVE",119,0)
 . . . I $D(ORCHECK("NEW",CDL,I,0)) D
"RTN","ORCSAVE",120,0)
 . . . . N J S J=0,ORCHECK("NEW",CDL,I)=ORCHECK("NEW",CDL,I,J) F  S J=$O(ORCHECK("NEW",CDL,I,J)) Q:'J  S ORCHECK("NEW",CDL,I)=ORCHECK("NEW",CDL,I)_ORCHECK("NEW",CDL,I,J)
"RTN","ORCSAVE",121,0)
 . . . S X=ORCHECK("NEW",CDL,I)
"RTN","ORCSAVE",122,0)
 . . . S ORK(I,1)=+ORIFN_U_"ACCEPTANCE_CPRS"_U_DUZ_U_$$NOW^XLFDT_U_$P(X,U)_U_CDL
"RTN","ORCSAVE",123,0)
 . . . S ORK(I,2,1)=$P(X,U,3)
"RTN","ORCSAVE",124,0)
 . . . I $E(ORK(I,2,1),0,2)="||" D
"RTN","ORCSAVE",125,0)
 . . . . N ORGLOB,ORRULE,ORI,ORLINE
"RTN","ORCSAVE",126,0)
 . . . . S ORGLOB=$P($P(ORK(I,2,1),"||",2),"&"),ORRULE=$P($P(ORK(I,2,1),"||",2),"&",2)
"RTN","ORCSAVE",127,0)
 . . . . S ORCROC(I)=$P($P(ORK(I,2,1),"||",2),"&",3)_U_$P($P(ORK(I,2,1),"||",2),"&",4)
"RTN","ORCSAVE",128,0)
 . . . . S ORK(I,2,1)=ORRULE,ORI=0,ORLINE=2
"RTN","ORCSAVE",129,0)
 . . . . F  S ORI=$O(^TMP($J,"ORK XTRA TXT",ORGLOB,ORRULE,ORI)) Q:'ORI  S ORK(I,2,ORLINE)=^TMP($J,"ORK XTRA TXT",ORGLOB,ORRULE,ORI),ORLINE=ORLINE+1
"RTN","ORCSAVE",130,0)
 . I $D(ORK) D
"RTN","ORCSAVE",131,0)
 . . N OCRET,ORKI
"RTN","ORCSAVE",132,0)
 . . D SAVEOC^OROCAPI1(.ORK,.OCRET)
"RTN","ORCSAVE",133,0)
 . . I $D(ORCROC) D
"RTN","ORCSAVE",134,0)
 . . . N ORCROCI S ORCROCI=0 F  S ORCROCI=$O(ORCROC(ORCROCI)) Q:'ORCROCI  D
"RTN","ORCSAVE",135,0)
 . . . . N OCINST S OCINST=$O(OCRET(ORCROCI,"")) Q:'OCINST  D
"RTN","ORCSAVE",136,0)
 . . . . . S ^ORD(100.05,OCINST,12)=ORCROC(ORCROCI)
"RTN","ORCSAVE",137,0)
 . . S ORKI=0 F  S ORKI=$O(ORK(ORKI)) Q:'ORKI  D
"RTN","ORCSAVE",138,0)
 . . . N OCINST,OCTXT S OCTXT=$G(ORK(ORKI,2,1))
"RTN","ORCSAVE",139,0)
 . . . S OCINST=$O(OCRET(ORKI,0))
"RTN","ORCSAVE",140,0)
 . . . N ORMONOI,ORMONOQ S ORMONOI=0,ORMONOQ=0 F  Q:ORMONOQ=1  S ORMONOI=$O(^TMP($J,"ORMONOGRAPH",ORMONOI)) Q:'ORMONOI  D
"RTN","ORCSAVE",141,0)
 . . . . I OCTXT[$G(^TMP($J,"ORMONOGRAPH",ORMONOI,"OC")) D
"RTN","ORCSAVE",142,0)
 . . . . . S ORMONOQ=1
"RTN","ORCSAVE",143,0)
 . . . . . S ^ORD(100.05,OCINST,17)=^TMP($J,"ORMONOGRAPH",ORMONOI,"INT")
"RTN","ORCSAVE",144,0)
 . . . . . M ^ORD(100.05,OCINST,16)=^TMP($J,"ORMONOGRAPH",ORMONOI,"DATA")
"RTN","ORCSAVE",145,0)
 . . . . . S ^ORD(100.05,OCINST,16,0)="^^"_$O(^ORD(100.05,OCINST,16,""),-1)_U_$O(^ORD(100.05,OCINST,16,""),-1)_U_+$$NOW^XLFDT_U
"RTN","ORCSAVE",146,0)
 . . K ^TMP($J,"ORMONOGRAPH")
"RTN","ORCSAVE",147,0)
 . . K ^TMP($J,"ORK XTRA TXT")
"RTN","ORCSAVE",148,0)
 K ORDEA
"RTN","ORCSAVE",149,0)
ENQ Q
"RTN","ORCSAVE",150,0)
 ;
"RTN","ORCSAVE",151,0)
NEXTIFN() ; -- Returns next available ORIFN
"RTN","ORCSAVE",152,0)
 N I,HDR,LAST,TOTAL,DA
"RTN","ORCSAVE",153,0)
 L +^OR(100,0):$S($G(DILOCKTM)>0:DILOCKTM,1:5)
"RTN","ORCSAVE",154,0)
 I '$T Q "^"
"RTN","ORCSAVE",155,0)
 S HDR=$G(^OR(100,0)),TOTAL=+$P(HDR,U,4),LAST=$O(^OR(100,"?"),-1)
"RTN","ORCSAVE",156,0)
 S I=LAST\1 F I=(I+1):1 Q:'$D(^OR(100,I,0))
"RTN","ORCSAVE",157,0)
 S DA=I,^OR(100,DA,0)=DA,$P(HDR,U,3,4)=DA_U_(TOTAL+1)
"RTN","ORCSAVE",158,0)
 S ^OR(100,0)=HDR L -^OR(100,0)
"RTN","ORCSAVE",159,0)
 Q DA
"RTN","ORCSAVE",160,0)
 ;
"RTN","ORCSAVE",161,0)
RESPONSE ; -- Save responses in ORDIALOG() into ^OR(100,ORIFN,4.5)
"RTN","ORCSAVE",162,0)
 N PROMPT,CNT,ITM,TYPE,INST,VALUE,I,START,PAT,X
"RTN","ORCSAVE",163,0)
 S PAT=$P(^OR(100,ORIFN,0),U,2),START=$P(^(0),U,8) K ^(4.5)
"RTN","ORCSAVE",164,0)
 S (PROMPT,CNT)=0 F  S PROMPT=$O(ORDIALOG(PROMPT)) Q:PROMPT'>0  D
"RTN","ORCSAVE",165,0)
 . S ITM=$G(ORDIALOG(PROMPT)) Q:'ITM
"RTN","ORCSAVE",166,0)
 . S TYPE=$E($G(ORDIALOG(PROMPT,0))) Q:'$L(TYPE)
"RTN","ORCSAVE",167,0)
 . S INST=0 F  S INST=$O(ORDIALOG(PROMPT,INST)) Q:INST'>0  D
"RTN","ORCSAVE",168,0)
 . . S VALUE=$G(ORDIALOG(PROMPT,INST)) Q:VALUE=""  S CNT=CNT+1
"RTN","ORCSAVE",169,0)
 . . S ^OR(100,ORIFN,4.5,CNT,0)=+ITM_U_PROMPT_U_INST_U_$P(ITM,U,2)
"RTN","ORCSAVE",170,0)
 . . S:$L($P(ITM,U,2)) ^OR(100,ORIFN,4.5,"ID",$P(ITM,U,2),CNT)=""
"RTN","ORCSAVE",171,0)
 . . I VALUE<1,TYPE="N" S VALUE=0_+VALUE I VALUE="00" S VALUE=0
"RTN","ORCSAVE",172,0)
 . . S:TYPE'="W" ^OR(100,ORIFN,4.5,CNT,1)=VALUE
"RTN","ORCSAVE",173,0)
 . . M:TYPE="W" ^OR(100,ORIFN,4.5,CNT,2)=@VALUE ; array root
"RTN","ORCSAVE",174,0)
 S ^OR(100,ORIFN,4.5,0)="^100.045A^"_CNT_U_CNT
"RTN","ORCSAVE",175,0)
R1 ; [Reset] Orderables
"RTN","ORCSAVE",176,0)
 I $D(^OR(100,ORIFN,.1)) S I=0 F  S I=$O(^OR(100,ORIFN,.1,I)) Q:I'>0  S X=$G(^(I,0)) I X,PAT,START K ^OR(100,"AOI",X,PAT,9999999-START,ORIFN) ; kill xref
"RTN","ORCSAVE",177,0)
 K ^OR(100,ORIFN,.1) I $D(^OR(100,ORIFN,4.5,"ID","ORDERABLE")) D
"RTN","ORCSAVE",178,0)
 . S (I,CNT)=0
"RTN","ORCSAVE",179,0)
 . F  S I=$O(^OR(100,ORIFN,4.5,"ID","ORDERABLE",I)) Q:I'>0  D
"RTN","ORCSAVE",180,0)
 . . S X=$G(^OR(100,ORIFN,4.5,I,1)) Q:'X
"RTN","ORCSAVE",181,0)
 . . S CNT=CNT+1,^OR(100,ORIFN,.1,CNT,0)=X,^OR(100,ORIFN,.1,"B",X,CNT)=""
"RTN","ORCSAVE",182,0)
 . . I PAT,START S ^OR(100,"AOI",X,PAT,9999999-START,ORIFN)=""
"RTN","ORCSAVE",183,0)
 . S ^OR(100,ORIFN,.1,0)="^100.001PA^"_CNT_U_CNT
"RTN","ORCSAVE",184,0)
 Q
"RTN","ORCSAVE",185,0)
 ;
"RTN","ORCSAVE",186,0)
RESUME(IFN) ; -- add Response nodes for RESUME tray service
"RTN","ORCSAVE",187,0)
 ; S ^OR(100,+IFN,4.5,<next>,0)=DT_"^^^RESUME",^(1)=1
"RTN","ORCSAVE",188,0)
 ;
"RTN","ORCSAVE",189,0)
 N X,Y,DA,DIC,DLAYGO
"RTN","ORCSAVE",190,0)
 S DIC="^OR(100,"_+IFN_",4.5,",DIC(0)="LX",DA(1)=+IFN,X=DT
"RTN","ORCSAVE",191,0)
 S DIC("DR")=".04///RESUME",DIC("P")=$P(^DD(100,4.5,0),U,2),DLAYGO=100
"RTN","ORCSAVE",192,0)
 D ^DIC S:Y ^OR(100,+IFN,4.5,+Y,1)=1
"RTN","ORCSAVE",193,0)
 Q
"RTN","ORCSAVE",194,0)
 ;
"RTN","ORCSAVE",195,0)
PROVIDER(ORDER,PROV) ; -- Change PROVider assigned to ORDER
"RTN","ORCSAVE",196,0)
 Q:'$G(ORDER)  Q:'$G(PROV)
"RTN","ORCSAVE",197,0)
 N ORACT S ORACT=+$P(ORDER,";",2) S:'ORACT ORACT=1
"RTN","ORCSAVE",198,0)
 S $P(^OR(100,+ORDER,8,ORACT,0),U,3)=PROV
"RTN","ORCSAVE",199,0)
 S:ORACT=1 $P(^OR(100,+ORDER,0),U,4)=PROV
"RTN","ORCSAVE",200,0)
 Q
"RTN","ORCSAVE",201,0)
 ;
"RTN","ORCSAVE",202,0)
ACTION(CODE,DA,PROV,REASON,WHEN,WHO) ; -- save new action
"RTN","ORCSAVE",203,0)
 N NEXT,TOTAL,HDR,LAST,X,PAT,DGRP,SIG,NATR,TXT S DA=+DA
"RTN","ORCSAVE",204,0)
 Q:'$D(^OR(100,DA,0)) 0 Q:$G(CODE)'?2U 0
"RTN","ORCSAVE",205,0)
 S:'$G(WHEN) WHEN=+$E($$NOW^XLFDT,1,12) S:'$G(WHO) WHO=DUZ
"RTN","ORCSAVE",206,0)
 S NATR=+$O(^ORD(100.02,"C","E",0)) ;assume Elec Entered until changed
"RTN","ORCSAVE",207,0)
 S PAT=$P(^OR(100,DA,0),U,2),DGRP=$P(^(0),U,11),SIG=$P(^(0),U,16),X=+$P($G(^(3)),U,7),HDR=$G(^(8,0))
"RTN","ORCSAVE",208,0)
 S:X'>0 X=1 S TXT=$P($G(^OR(100,DA,8,X,0)),U,14) ;current actn's txt ptr
"RTN","ORCSAVE",209,0)
 S:HDR="" HDR="^100.008DA^^" S TOTAL=+$P(HDR,U,4)
"RTN","ORCSAVE",210,0)
 S LAST=$O(^OR(100,DA,8,"C",CODE,"?"),-1) I LAST D
"RTN","ORCSAVE",211,0)
 . S X=$G(^OR(100,DA,8,LAST,0)) Q:$P(X,U,15)'=11  Q:$P(X,U,4)'=2
"RTN","ORCSAVE",212,0)
 . S NEXT=LAST I PAT,$P(X,U) D  ; kill old xref entries
"RTN","ORCSAVE",213,0)
 . . K:DGRP ^OR(100,"ACT",PAT,(9999999-$P(X,U)),DGRP,DA,NEXT)
"RTN","ORCSAVE",214,0)
 . . K ^OR(100,"AC",PAT,(9999999-$P(X,U)),DA,NEXT),^OR(100,"AS",PAT,(9999999-$P(X,U)),DA,NEXT),^OR(100,"AF",$P(X,U),DA,NEXT)
"RTN","ORCSAVE",215,0)
 S:'$G(NEXT) NEXT=$O(^OR(100,DA,8,"?"),-1)+1,TOTAL=TOTAL+1
"RTN","ORCSAVE",216,0)
 S ^OR(100,DA,8,NEXT,0)=WHEN_U_CODE_U_$G(PROV)_U_$S(SIG:2,1:3)_"^^^^^^^^"_NATR_U_WHO_U_TXT_"^11",^OR(100,DA,8,"C",CODE,NEXT)=""
"RTN","ORCSAVE",217,0)
 S ^OR(100,"AF",WHEN,DA,NEXT)=""
"RTN","ORCSAVE",218,0)
 I PAT,DGRP S ^OR(100,"ACT",PAT,9999999-WHEN,DGRP,DA,NEXT)=""
"RTN","ORCSAVE",219,0)
 I PAT S ^OR(100,"AC",PAT,9999999-WHEN,DA,NEXT)=""
"RTN","ORCSAVE",220,0)
 I SIG S ^OR(100,"AS",PAT,9999999-WHEN,DA,NEXT)=""
"RTN","ORCSAVE",221,0)
 S:$L($G(REASON)) ^OR(100,DA,8,NEXT,1)=REASON
"RTN","ORCSAVE",222,0)
 S $P(HDR,U,3,4)=NEXT_U_TOTAL,^OR(100,DA,8,0)=HDR
"RTN","ORCSAVE",223,0)
 ;
"RTN","ORCSAVE",224,0)
 D   ; DE3504 - Jan 19, 2016 ,US10045 - PB capture the DC of an order not signed in HMP(800000)
"RTN","ORCSAVE",225,0)
 . N FLD,HMDFN,HMORIS,JDSNOW,RSLT,SRVRNUM,VALS
"RTN","ORCSAVE",226,0)
 . S ORIFN=DA,HMDFN=+$P(^OR(100,+ORIFN,0),U,2),SRVRNUM=$$SRVRNO^HMPOR(HMDFN)
"RTN","ORCSAVE",227,0)
 . Q:'SRVRNUM  ; patient not in the HMP(800000 file
"RTN","ORCSAVE",228,0)
 . S HMORIS=$$ORDRCHK^HMPOR(+ORIFN,HMDFN)  ; does order exist?  ; Jan 26, 2016 - DE3584
"RTN","ORCSAVE",229,0)
 . S JDSNOW=$$NOW^XLFDT
"RTN","ORCSAVE",230,0)
 . ;^(#.03)SIGNED BY^(#.04)SIGNED DATE/TIME^(#.14)ORDER ACTION^(#.15)ACTION DATE/TIME
"RTN","ORCSAVE",231,0)
 . S VALS(.03)=$G(WHO),VALS(.14)=$G(CODE),VALS(.15)=JDSNOW  ; SIGNED BY updated to reflect action user
"RTN","ORCSAVE",232,0)
 . S:$G(SIG)'=2 VALS(.04)=JDSNOW  ; SIG=2 means NOT SIGNED, don't update SIGNED DATE/TIME
"RTN","ORCSAVE",233,0)
 . D:HMORIS UPDTORDR^HMPOR(.RSLT,.VALS,+ORIFN,HMDFN)  ; order exists update it
"RTN","ORCSAVE",234,0)
 . D:'HMORIS ADDORDR^HMPOR(.RSLT,.VALS,+ORIFN,HMDFN)  ; create new order in HMP(800000)
"RTN","ORCSAVE",235,0)
 . D COMP^ORMBLDOR(+$G(ORIFN))  ; send message for completed orders
"RTN","ORCSAVE",236,0)
 ; end DE3504
"RTN","ORCSAVE",237,0)
 Q NEXT
"RTN","ORCSAVE",238,0)
 ;
"RTN","ORCSAVE",239,0)
SET(DLG) ; -- Create new parent for order set ORDIALOG
"RTN","ORCSAVE",240,0)
 ; Returns ORPIFN = ifn of new parent order for set
"RTN","ORCSAVE",241,0)
 ;
"RTN","ORCSAVE",242,0)
 Q:'$G(ORVP)  Q:'$G(DLG)  N OR0,PKG,NOW,CATG,STS,ORLOC,TRSPEC,X
"RTN","ORCSAVE",243,0)
 S OR0=$G(^ORD(101.41,DLG,0)) Q:OR0=""  S ORPIFN=$$NEXTIFN Q:'ORPIFN
"RTN","ORCSAVE",244,0)
 S PKG=$O(^DIC(9.4,"C","OR",0)),CATG=$S($$INPT^ORCD:"I",1:"O"),STS=$S($G(OREVENT):10,1:11),NOW=$S($G(ORSLOG):ORSLOG,1:+$E($$NOW^XLFDT,1,12))
"RTN","ORCSAVE",245,0)
 I $G(OREVENT) S ORLOC="",TRSPEC=""
"RTN","ORCSAVE",246,0)
 S ^OR(100,ORPIFN,0)=ORPIFN_U_ORVP_U_U_$G(ORNP)_U_DLG_";ORD(101.41,^"_DUZ_U_NOW_U_U_U_ORLOC_U_U_CATG_U_TRSPEC_U_PKG_"^^^"_$G(OREVENT),^(3)=NOW_"^90^"_STS_U_$S($G(ORIT):ORIT_"ORD(101.41,",1:"")_"^^^1^^^^0^^"_+$P(OR0,U,6)
"RTN","ORCSAVE",247,0)
 S ^OR(100,ORPIFN,8,0)="^100.008DA^1^1",^(1,0)=NOW_"^NW^"_$G(ORNP)_"^^^^^^^^^^"_DUZ_"^^"_STS,^OR(100,ORPIFN,8,"C","NW",1)="",^OR(100,"AF",NOW,ORPIFN,1)=""
"RTN","ORCSAVE",248,0)
 S ^OR(100,"ACT",ORVP,9999999-NOW,ORPIFN,1)=""
"RTN","ORCSAVE",249,0)
 S:STS=11 ^OR(100,"AC",ORVP,9999999-NOW,ORPIFN,1)=""
"RTN","ORCSAVE",250,0)
 ; AEVNT ??
"RTN","ORCSAVE",251,0)
 S ^OR(100,ORPIFN,1,0)="^100.011^1^1",^(1,0)=$P(OR0,U,2) ; Order text
"RTN","ORCSAVE",252,0)
 Q
"RTN","ORCSAVE2")
0^3^B113061054
"RTN","ORCSAVE2",1,0)
ORCSAVE2 ;SLC/MKB-Utilities to update an order ;01/05/17  14:00
"RTN","ORCSAVE2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**4,27,56,70,94,116,190,157,215,265,243,293,280,346,269,421,382**;Dec 17, 1997;Build 15
"RTN","ORCSAVE2",3,0)
 ;Per VA Directive 6402, this routine should not be modified.
"RTN","ORCSAVE2",4,0)
 ;
"RTN","ORCSAVE2",5,0)
 ;Nov 12, 2015 PB - modified to do a sync for a saved order
"RTN","ORCSAVE2",6,0)
 ;
"RTN","ORCSAVE2",7,0)
STATUS(IFN,ST) ; -- Update status of order
"RTN","ORCSAVE2",8,0)
 Q:'$G(IFN)  Q:'$D(^OR(100,+IFN,0))  Q:$P($G(^(3)),U,3)=$G(ST)  ;no change
"RTN","ORCSAVE2",9,0)
 Q:'$G(ST)  Q:'$D(^ORD(100.01,+ST,0))
"RTN","ORCSAVE2",10,0)
 N NODE0,NODE3,ORNOW,DA,XACT,PROV,ORVP
"RTN","ORCSAVE2",11,0)
 S NODE3=$G(^OR(100,+IFN,3)),ORVP=$P($G(^(0)),U,2),ORNOW=$$NOW^XLFDT
"RTN","ORCSAVE2",12,0)
 S $P(NODE3,U)=ORNOW,$P(NODE3,U,3)=ST,^OR(100,+IFN,3)=NODE3
"RTN","ORCSAVE2",13,0)
 I (ST<3)!(ST=12)!(ST=13),$G(ORDCNTRL)'="ZC" D DATES(+IFN,,+$E(ORNOW,1,12))
"RTN","ORCSAVE2",14,0)
 I "^1^2^7^12^13^15^"[(U_ST_U) D CANCEL^ORCSEND(+IFN),UNOTIF^ORCSIGN
"RTN","ORCSAVE2",15,0)
 I $P(NODE3,U,9) D CKPARENT($P(NODE3,U,9)) ; ck siblings to update parent
"RTN","ORCSAVE2",16,0)
 D SETALL^ORDD100(+IFN)
"RTN","ORCSAVE2",17,0)
 Q
"RTN","ORCSAVE2",18,0)
 ;
"RTN","ORCSAVE2",19,0)
CKPARENT(ORIFN) ; -- Update status of parent order, if appropriate
"RTN","ORCSAVE2",20,0)
 N ORSTS,ALLRELSD,ALLDONE,DC,COMP,CH,CHSTS,ACTIVE,LAPS
"RTN","ORCSAVE2",21,0)
 Q:'$D(^OR(100,ORIFN,0))  S ORSTS=$P($G(^(3)),U,3)
"RTN","ORCSAVE2",22,0)
 I (ORSTS=11)!(ORSTS=10) S ALLRELSD=1 D  Q  ;Parent unrel'd - ck children
"RTN","ORCSAVE2",23,0)
 . F CH=0:0 S CH=$O(^OR(100,ORIFN,2,CH)) Q:CH'>0  D  Q:'ALLRELSD
"RTN","ORCSAVE2",24,0)
 . . I '$D(^OR(100,CH)) K ^OR(100,ORIFN,2,CH) Q
"RTN","ORCSAVE2",25,0)
 . . S CHSTS=$P($G(^OR(100,CH,3)),U,3) S:CHSTS=11 ALLRELSD=0
"RTN","ORCSAVE2",26,0)
 . I ALLRELSD D STATUS(ORIFN,5) ; update Parent order to pending
"RTN","ORCSAVE2",27,0)
 S ALLDONE=1,(DC,COMP,LAPS,ACTIVE)=0
"RTN","ORCSAVE2",28,0)
 F CH=0:0 S CH=$O(^OR(100,ORIFN,2,CH)) Q:CH'>0  D  Q:'ALLDONE
"RTN","ORCSAVE2",29,0)
 . I '$D(^OR(100,CH)) K ^OR(100,ORIFN,2,CH) Q
"RTN","ORCSAVE2",30,0)
 . S CHSTS=$P($G(^OR(100,CH,3)),U,3) I CHSTS=14 S LAPS=1 Q
"RTN","ORCSAVE2",31,0)
 . I "^1^12^13^"[(U_CHSTS_U) S DC=1 Q
"RTN","ORCSAVE2",32,0)
 . I "^2^7^"[(U_CHSTS_U) S COMP=1 Q
"RTN","ORCSAVE2",33,0)
 . S ALLDONE=0 S:CHSTS=6 ACTIVE=1
"RTN","ORCSAVE2",34,0)
 I ALLDONE S ORSTS=$S(COMP:2,DC:1,LAPS:14,1:"") D:ORSTS STATUS(ORIFN,ORSTS) Q
"RTN","ORCSAVE2",35,0)
 I ACTIVE,ORSTS'=6 D STATUS(ORIFN,6) ;at least child active
"RTN","ORCSAVE2",36,0)
 Q
"RTN","ORCSAVE2",37,0)
 ;
"RTN","ORCSAVE2",38,0)
RELEASE(ORDER,ACTION,WHEN,WHO,NATURE) ; -- Mark order as released to service
"RTN","ORCSAVE2",39,0)
 S:'$G(ACTION) ACTION=1 S:'$G(WHEN) WHEN=+$E($$NOW^XLFDT,1,12) S:'$G(WHO) WHO=DUZ
"RTN","ORCSAVE2",40,0)
 Q:'$G(ORDER)  N OR0 S OR0=$G(^OR(100,ORDER,8,ACTION,0))
"RTN","ORCSAVE2",41,0)
 S:$L($G(NATURE)) $P(OR0,U,12)=$S(NATURE:NATURE,1:+$O(^ORD(100.02,"C",NATURE,0)))
"RTN","ORCSAVE2",42,0)
 S:($P(OR0,U,15)=10)!($P(OR0,U,15)=11) $P(OR0,U,15)=""
"RTN","ORCSAVE2",43,0)
 ;S $P(OR0,U,16,17)=WHEN_U_WHO,^OR(100,"AR",ORVP,9999999-WHEN,ORDER,ACTION)=""
"RTN","ORCSAVE2",44,0)
 S $P(OR0,U,16,17)=WHEN_U_WHO
"RTN","ORCSAVE2",45,0)
 S ^OR(100,ORDER,8,ACTION,0)=OR0
"RTN","ORCSAVE2",46,0)
 I $P(OR0,U,2)="NW",'$P(^OR(100,ORDER,0),U,8) D STARTDT(ORDER)
"RTN","ORCSAVE2",47,0)
 ;Set the "AR" index.
"RTN","ORCSAVE2",48,0)
 D RS^ORDD100(ORDER,ACTION,ORVP,WHEN)
"RTN","ORCSAVE2",49,0)
 Q
"RTN","ORCSAVE2",50,0)
 ;
"RTN","ORCSAVE2",51,0)
STARTDT(DA) ; -- resolve Start and Stop dates from Responses
"RTN","ORCSAVE2",52,0)
 N X,Y,%DT,ORDG,ORT,ORLAB
"RTN","ORCSAVE2",53,0)
 S ORDG=$P($G(^ORD(100.98,+$P(^OR(100,DA,0),U,11),0)),U,3)
"RTN","ORCSAVE2",54,0)
 S ORLAB="^LAB^CH^HEMA^MI^AP^AU^EM^SP^CY^BB^"[(U_ORDG_U),ORT=""
"RTN","ORCSAVE2",55,0)
 S:ORDG="E/L T" ORT=$$VALUE(DA,"TIME") S:ORDG="MEAL" ORT=$$MEALTIME^ORCDFHO(DA)
"RTN","ORCSAVE2",56,0)
STRT S X=$$VALUE(DA,"START") I '$L(X) D WS^ORDD100 Q  S:$L(ORT) X=X_"@"_ORT
"RTN","ORCSAVE2",57,0)
 D AM:X="AM",NEXT:X="NEXT",ADMIN("NEXT"):X="NEXTA",ADMIN("CLOSEST"):X="CLOSEST"
"RTN","ORCSAVE2",58,0)
 S %DT="T" D ^%DT Q:Y'>0  S:$E($P(Y,".",2),1,2)=24 Y=$P(Y,".")_".2359"
"RTN","ORCSAVE2",59,0)
 S $P(^OR(100,DA,0),U,8)=Y D SS^ORDD100,WS^ORDD100,OI1^ORDD100A(DA)
"RTN","ORCSAVE2",60,0)
STOP I ORLAB S X=$$VALUE(DA,"DAYS") Q:X'>1  S X=$$FMADD^XLFDT(Y,(X-1))
"RTN","ORCSAVE2",61,0)
 I 'ORLAB S X=$$VALUE(DA,"STOP") Q:'$L(X)  S:$L(ORT) X=X_"@"_ORT
"RTN","ORCSAVE2",62,0)
 S %DT="T" D ^%DT Q:Y'>0  S:$E($P(Y,".",2),1,2)=24 Y=$P(Y,".")_".2359"
"RTN","ORCSAVE2",63,0)
 S $P(^OR(100,DA,0),U,9)=Y D ES^ORDD100A
"RTN","ORCSAVE2",64,0)
 Q
"RTN","ORCSAVE2",65,0)
 ;
"RTN","ORCSAVE2",66,0)
NEXT ; -- Resolve next lab collection to FM date/time
"RTN","ORCSAVE2",67,0)
 N ORTIME,ORDAY,NOW,NEXT,ENT
"RTN","ORCSAVE2",68,0)
 ;is referenced by DBIA #964
"RTN","ORCSAVE2",69,0)
 S ENT=$S($P($G(^SC(+$G(ORL),0)),U,4):+$P(^(0),U,4),1:+$G(DUZ(2)))_";DIC(4," S:ENT'>0 ENT="ALL"
"RTN","ORCSAVE2",70,0)
 D GETLST^XPAR(.ORTIME,ENT,"LR PHLEBOTOMY COLLECTION","N")
"RTN","ORCSAVE2",71,0)
 S NOW=$P($H,",",2),ORDAY=$S($O(ORTIME(NOW)):"T",1:"T+1")
"RTN","ORCSAVE2",72,0)
 S ORDAY=$$NEXTCOLL^ORCDLR1(ORDAY) S:ORDAY["+" NOW=0
"RTN","ORCSAVE2",73,0)
 S NEXT=$O(ORTIME(NOW)),X=ORDAY_"@"_$P($G(ORTIME(+NEXT)),U)
"RTN","ORCSAVE2",74,0)
 Q
"RTN","ORCSAVE2",75,0)
 ;
"RTN","ORCSAVE2",76,0)
AM ; -- Resolve AM lab collection to FM date/time
"RTN","ORCSAVE2",77,0)
 N ORTIME,ORDAY,AM,NOW,ENT
"RTN","ORCSAVE2",78,0)
 ;is referenced by DBIA #964
"RTN","ORCSAVE2",79,0)
 S ENT=$S($P($G(^SC(+$G(ORL),0)),U,4):+$P(^(0),U,4),1:+$G(DUZ(2)))_";DIC(4," S:ENT'>0 ENT="ALL"
"RTN","ORCSAVE2",80,0)
 D GETLST^XPAR(.ORTIME,ENT,"LR PHLEBOTOMY COLLECTION","N")
"RTN","ORCSAVE2",81,0)
 S AM=$O(ORTIME(0)),NOW=$P($H,",",2)
"RTN","ORCSAVE2",82,0)
 S ORDAY=$S(AM=$O(ORTIME(NOW)):"T",1:"T+1")
"RTN","ORCSAVE2",83,0)
 S X=$$NEXTCOLL^ORCDLR1(ORDAY)_"@"_$P($G(ORTIME(+AM)),U)
"RTN","ORCSAVE2",84,0)
 Q
"RTN","ORCSAVE2",85,0)
 ;
"RTN","ORCSAVE2",86,0)
ADMIN(START) ; -- Resolve next/closest administration times to FM date/time
"RTN","ORCSAVE2",87,0)
 N PAT,SCH,OI,LOC,Y,I
"RTN","ORCSAVE2",88,0)
 I $G(DA) D  ;get data from order DA
"RTN","ORCSAVE2",89,0)
 . S PAT=+$P($G(^OR(100,DA,0)),U,2),LOC=""
"RTN","ORCSAVE2",90,0)
 . S I=+$O(^OR(100,DA,4.5,"ID","INSTR",0)),I=+$P($G(^OR(100,DA,4.5,I,0)),U,3) ;first
"RTN","ORCSAVE2",91,0)
 . S SCH=$$VALUE(DA,"SCHEDULE",I),OI=$$VALUE(DA,"ORDERABLE")
"RTN","ORCSAVE2",92,0)
 I '$G(DA) D  ;or look in ORDIALOG() instead
"RTN","ORCSAVE2",93,0)
 . S I=+$O(ORDIALOG($$PTR^ORCD("OR GTX INSTRUCTIONS"),0))
"RTN","ORCSAVE2",94,0)
 . S PAT=$G(ORVP),SCH=$G(ORDIALOG($$PTR^ORCD("OR GTX SCHEDULE"),I))
"RTN","ORCSAVE2",95,0)
 . S OI=$G(ORDIALOG($$PTR^ORCD("OR GTX ORDERABLE ITEM"),1)),LOC=""
"RTN","ORCSAVE2",96,0)
 S OI=+$P($G(^ORD(101.43,+OI,0)),U,2) ;PSOI
"RTN","ORCSAVE2",97,0)
 ;is referenced by DBIA #3167
"RTN","ORCSAVE2",98,0)
 S Y=$$RESOLVE^PSJORPOE(PAT,SCH,OI,START,LOC),X=$P(Y,U,2)
"RTN","ORCSAVE2",99,0)
 Q
"RTN","ORCSAVE2",100,0)
 ;
"RTN","ORCSAVE2",101,0)
SIGN(DA,WHO,WHEN,HOW,WHAT) ; -- affix ES to order
"RTN","ORCSAVE2",102,0)
 Q:'$G(DA)  S:'$G(WHAT) WHAT=1
"RTN","ORCSAVE2",103,0)
 N X S X=$G(^OR(100,DA,8,WHAT,0)) D S2^ORDD100(DA,WHAT) ; kill AS xref
"RTN","ORCSAVE2",104,0)
 S $P(X,U,4,7)=$G(HOW)_U_$G(WHO)_U_$E($G(WHEN),1,12)_U_$S(HOW=0:DUZ,1:"")
"RTN","ORCSAVE2",105,0)
 ; S:$G(WHO) $P(X,U,3)=WHO ; reset provider to signer
"RTN","ORCSAVE2",106,0)
 S ^OR(100,DA,8,WHAT,0)=X
"RTN","ORCSAVE2",107,0)
 D  ; DE3504 Jan 19, 2016, US10045 - PB - Nov 2, 2015 modification to capture order create date/time with seconds in HMP(800000 orders multiple
"RTN","ORCSAVE2",108,0)
 . N HMDFN,HMORIFN,HMORIS,HMSTATUS,NOW,RSLT,VALS
"RTN","ORCSAVE2",109,0)
 . S HMDFN=+$P(^OR(100,DA,0),U,2),HMORIFN=+DA
"RTN","ORCSAVE2",110,0)
 . S HMSTATUS=$P($G(^OR(100,DA,8,WHAT,0)),U,2),NOW=$$NOW^XLFDT
"RTN","ORCSAVE2",111,0)
 . S:$G(WHO)]"" VALS(.03)=WHO
"RTN","ORCSAVE2",112,0)
 . S:HMSTATUS'=2 VALS(.04)=NOW  ; if=2 order not signed  ; SIGNED DATE/TIME only updated when order is signed
"RTN","ORCSAVE2",113,0)
 . S:$L(HMSTATUS) VALS(.14)=HMSTATUS,VALS(.15)=NOW
"RTN","ORCSAVE2",114,0)
 . S HMORIS=$$ORDRCHK^HMPOR(HMORIFN,HMDFN)  ; does order exist?  ; Jan 26, 2016 - DE3584
"RTN","ORCSAVE2",115,0)
 . D:HMORIS UPDTORDR^HMPOR(.RSLT,.VALS,HMORIFN,HMDFN)  ; order exists update it
"RTN","ORCSAVE2",116,0)
 . D:'HMORIS ADDORDR^HMPOR(.RSLT,.VALS,HMORIFN,HMDFN)  ; create new order in HMP(800000)
"RTN","ORCSAVE2",117,0)
 ;
"RTN","ORCSAVE2",118,0)
 D:$G(HOW)=2 S1^ORDD100(DA,WHAT) ; reset AS xref
"RTN","ORCSAVE2",119,0)
 Q
"RTN","ORCSAVE2",120,0)
 ;
"RTN","ORCSAVE2",121,0)
SIGSTS(IFN,ACT) ; -- Set SigSts for backdoor orders [Called from ^ORM* rtns]
"RTN","ORCSAVE2",122,0)
 ; Expects ORNATR, ORVP, ORNP to be defined
"RTN","ORCSAVE2",123,0)
 Q:'$G(IFN)  Q:'$G(ACT)  N X,OR0 S OR0=+$P($G(^OR(100,+IFN,8,ACT,0)),U)
"RTN","ORCSAVE2",124,0)
 S X=$S($$SIGNREQD^ORCACT1(+IFN):$$SIGSTS^ORX1(ORNATR),1:3)
"RTN","ORCSAVE2",125,0)
 K ^OR(100,"AS",ORVP,9999999-OR0,+IFN,ACT)
"RTN","ORCSAVE2",126,0)
 S $P(^OR(100,+IFN,8,ACT,0),U,4)=X
"RTN","ORCSAVE2",127,0)
 I X=2 S ^OR(100,"AS",ORVP,9999999-OR0,+IFN,ACT)="" D NOTIF^ORCSIGN
"RTN","ORCSAVE2",128,0)
 Q
"RTN","ORCSAVE2",129,0)
 ;
"RTN","ORCSAVE2",130,0)
UNVEIL(IFN) ; -- unveil new order
"RTN","ORCSAVE2",131,0)
 S $P(^OR(100,IFN,3),U,8)=""
"RTN","ORCSAVE2",132,0)
 Q
"RTN","ORCSAVE2",133,0)
 ;
"RTN","ORCSAVE2",134,0)
DELETE(ORDER) ; -- delete order [action]
"RTN","ORCSAVE2",135,0)
 N DIK,DA,DAD
"RTN","ORCSAVE2",136,0)
 I $P(ORDER,";",2)>1 S DA=+$P(ORDER,";",2),DA(1)=+ORDER,DIK="^OR(100,"_DA(1)_",8," D:DA ^DIK Q
"RTN","ORCSAVE2",137,0)
 S DAD=+$P($G(^OR(100,+ORDER,3)),U,9) I DAD S DIK="^OR(100,"_DAD_",2,",DA(1)=DAD,DA=+ORDER D ^DIK ; remove link to child from parent
"RTN","ORCSAVE2",138,0)
 K DA S DA=+ORDER,DIK="^OR(100," D ^DIK ;remove order, text
"RTN","ORCSAVE2",139,0)
 D DELETE^OROCAPI1(+ORDER)
"RTN","ORCSAVE2",140,0)
 Q
"RTN","ORCSAVE2",141,0)
 ;
"RTN","ORCSAVE2",142,0)
VERIFY(IFN,DA,TYPE,WHO,WHEN) ; -- order verified
"RTN","ORCSAVE2",143,0)
 Q:'$G(IFN)  Q:'$G(DA)  Q:"^N^C^R^"'[(U_$G(TYPE)_U)
"RTN","ORCSAVE2",144,0)
 I $G(^TMP($J,"OR MOB APP"))="CPRS" Q
"RTN","ORCSAVE2",145,0)
 N FLD S FLD=$S(TYPE="N":8,TYPE="C":10,1:18)
"RTN","ORCSAVE2",146,0)
 S:'$G(WHO) WHO=DUZ S:'$G(WHEN) WHEN=+$E($$NOW^XLFDT,1,12)
"RTN","ORCSAVE2",147,0)
 S $P(^OR(100,IFN,8,DA,0),U,FLD,FLD+1)=WHO_U_WHEN
"RTN","ORCSAVE2",148,0)
 D  ; US10045 - PB - Jan 7, 2016 capture the order verify or review date/time with seconds in HMP(800000 orders multiple
"RTN","ORCSAVE2",149,0)
 . N FLD,ORDFN,SRVRNUM,RSLT,VALS
"RTN","ORCSAVE2",150,0)
 . S ORDFN=+$P(^OR(100,+ORIFN,0),U,2),SRVRNUM=$$SRVRNO^HMPOR(ORDFN)
"RTN","ORCSAVE2",151,0)
 . Q:'SRVRNUM  ; patient not in the HMP(800000 file
"RTN","ORCSAVE2",152,0)
 . S FLD=$S(TYPE="N":.05,TYPE="C":.07,1:.09)
"RTN","ORCSAVE2",153,0)
 . ;^(#.05)VERIFYING NURSE^(#.06)NURSE VERIFY DATE/TIME^(#.07)VERIFYING CLERK^(#.08)CLERK VERIFY DATE/TIME^(#.09)REVIEWED BY^(#.1)REVIEWED DATE/TIME
"RTN","ORCSAVE2",154,0)
 . S VALS(FLD)=$G(WHO),VALS(FLD+.01)=$$NOW^XLFDT D UPDTORDR^HMPOR(.RSLT,.VALS,+ORIFN,ORDFN) Q:RSLT<0  ; quit if order not found
"RTN","ORCSAVE2",155,0)
 D:$L($T(VER^EDPFMON)) VER^EDPFMON(IFN)
"RTN","ORCSAVE2",156,0)
 Q
"RTN","ORCSAVE2",157,0)
 ;
"RTN","ORCSAVE2",158,0)
COMP(IFN,WHO,WHEN) ; -- order completed
"RTN","ORCSAVE2",159,0)
 Q:'$G(IFN)  S:'$G(WHO) WHO=DUZ S:'$G(WHEN) WHEN=+$E($$NOW^XLFDT,1,12)
"RTN","ORCSAVE2",160,0)
 D DATES(+IFN,,WHEN),STATUS(+IFN,2)
"RTN","ORCSAVE2",161,0)
 S $P(^OR(100,+IFN,6),U,6,7)=WHEN_U_WHO
"RTN","ORCSAVE2",162,0)
 D:$L($T(COMP^EDPFMON)) COMP^EDPFMON(IFN)
"RTN","ORCSAVE2",163,0)
 Q
"RTN","ORCSAVE2",164,0)
 ;
"RTN","ORCSAVE2",165,0)
DATES(DA,START,STOP) ; -- Update start/stop dates for order DA
"RTN","ORCSAVE2",166,0)
 Q:'$G(DA)  I $G(START) D
"RTN","ORCSAVE2",167,0)
 . Q:START=$P(^OR(100,DA,0),U,8)
"RTN","ORCSAVE2",168,0)
 . D SK^ORDD100,WK^ORDD100,OI2^ORDD100A(DA)
"RTN","ORCSAVE2",169,0)
 . S $P(^OR(100,DA,0),U,8)=START
"RTN","ORCSAVE2",170,0)
 . D SS^ORDD100,WS^ORDD100,OI1^ORDD100A(DA)
"RTN","ORCSAVE2",171,0)
 I $G(STOP) D
"RTN","ORCSAVE2",172,0)
 . ;Q:STOP=$P(^OR(100,DA,0),U,9)  ;ck xref anyway
"RTN","ORCSAVE2",173,0)
 . D EK^ORDD100A S $P(^OR(100,DA,0),U,9)=STOP D ES^ORDD100A
"RTN","ORCSAVE2",174,0)
 Q
"RTN","ORCSAVE2",175,0)
 ;
"RTN","ORCSAVE2",176,0)
OC ; -- Save order checks in ORCHECK() in ^OR(100,+ORIFN,9) ON SIGNATURE IN CPRS
"RTN","ORCSAVE2",177,0)
 Q:'$G(ORIFN)  Q:'$D(^OR(100,+ORIFN,0))
"RTN","ORCSAVE2",178,0)
 D DELOCC^OROCAPI1(+ORIFN,"SIGNATURE_CPRS")
"RTN","ORCSAVE2",179,0)
 N I,J,ORK,CNT,OC,OROCRET,ORKI,ORCROC
"RTN","ORCSAVE2",180,0)
 S CNT=0
"RTN","ORCSAVE2",181,0)
 S I=0 F  S I=$O(ORCHECK(+ORIFN,I)) Q:'I  D
"RTN","ORCSAVE2",182,0)
 . S J=0 F  S J=$O(ORCHECK(+ORIFN,I,J)) Q:'J  D
"RTN","ORCSAVE2",183,0)
 . . S OC=ORCHECK(+ORIFN,I,J)
"RTN","ORCSAVE2",184,0)
 . . S CNT=CNT+1
"RTN","ORCSAVE2",185,0)
 . . S ORK(CNT,1)=+ORIFN_U_"SIGNATURE_CPRS"_U_DUZ_U_$$NOW^XLFDT_U_+OC_U_I
"RTN","ORCSAVE2",186,0)
 . . S ORK(CNT,2,1)=$P(OC,U,3)
"RTN","ORCSAVE2",187,0)
 . . S ORK(CNT,3)=$S(I=1:$G(ORCHECK("OK")),1:"")
"RTN","ORCSAVE2",188,0)
 . . I $E(ORK(CNT,2,1),0,2)="||" D
"RTN","ORCSAVE2",189,0)
 . . . N ORGLOB,ORRULE,ORI,ORICNT
"RTN","ORCSAVE2",190,0)
 . . . S ORGLOB=$P($P(ORK(CNT,2,1),"||",2),"&"),ORRULE=$P($P(ORK(CNT,2,1),"||",2),"&",2)
"RTN","ORCSAVE2",191,0)
 . . . S ORCROC(CNT)=$P($P(ORK(CNT,2,1),"||",2),"&",3)_U_$P($P(ORK(CNT,2,1),"||",2),"&",4)
"RTN","ORCSAVE2",192,0)
 . . . S ORK(CNT,2,1)=ORRULE,ORICNT=2,ORI=1
"RTN","ORCSAVE2",193,0)
 . . . F  S ORI=$O(^TMP($J,"ORK XTRA TXT",ORGLOB,ORRULE,ORI)) Q:'ORI  S ORK(CNT,2,ORICNT)=^TMP($J,"ORK XTRA TXT",ORGLOB,ORRULE,ORI),ORICNT=ORICNT+1
"RTN","ORCSAVE2",194,0)
 I $D(ORK) D
"RTN","ORCSAVE2",195,0)
 . D SAVEOC^OROCAPI1(.ORK,.OROCRET)
"RTN","ORCSAVE2",196,0)
 . I $D(ORCROC) D
"RTN","ORCSAVE2",197,0)
 . . N ORCROCI S ORCROCI=0 F  S ORCROCI=$O(ORCROC(ORCROCI)) Q:'ORCROCI  D
"RTN","ORCSAVE2",198,0)
 . . . N OCINST S OCINST=$O(OROCRET(ORCROCI,"")) Q:'OCINST  D
"RTN","ORCSAVE2",199,0)
 . . . . S ^ORD(100.05,OCINST,12)=ORCROC(ORCROCI)
"RTN","ORCSAVE2",200,0)
 S ORKI=0 F  S ORKI=$O(ORK(ORKI)) Q:'ORKI  D
"RTN","ORCSAVE2",201,0)
 . N OCINST,OCTXT S OCTXT=$G(ORK(ORKI,2,1))
"RTN","ORCSAVE2",202,0)
 . S OCINST=$O(OROCRET(ORKI,0))
"RTN","ORCSAVE2",203,0)
 . N ORMONOI,ORMONOQ S ORMONOI=0,ORMONOQ=0 F  Q:ORMONOQ=1  S ORMONOI=$O(^TMP($J,"ORMONOGRAPH",ORMONOI)) Q:'ORMONOI  D
"RTN","ORCSAVE2",204,0)
 . . I OCTXT[$G(^TMP($J,"ORMONOGRAPH",ORMONOI,"OC")) D
"RTN","ORCSAVE2",205,0)
 . . . S ORMONOQ=1
"RTN","ORCSAVE2",206,0)
 . . . S ^ORD(100.05,OCINST,17)=^TMP($J,"ORMONOGRAPH",ORMONOI,"INT")
"RTN","ORCSAVE2",207,0)
 . . . M ^ORD(100.05,OCINST,16)=^TMP($J,"ORMONOGRAPH",ORMONOI,"DATA")
"RTN","ORCSAVE2",208,0)
 . . . S ^ORD(100.05,OCINST,16,0)="^^"_$O(^ORD(100.05,OCINST,16,""),-1)_U_$O(^ORD(100.05,OCINST,16,""),-1)_U_+$$NOW^XLFDT_U
"RTN","ORCSAVE2",209,0)
 K ^TMP($J,"ORMONOGRAPH")
"RTN","ORCSAVE2",210,0)
 Q
"RTN","ORCSAVE2",211,0)
 ;
"RTN","ORCSAVE2",212,0)
VALUE(IFN,ID,INST) ; -- Returns value of prompt by identifier ID
"RTN","ORCSAVE2",213,0)
 I '$G(IFN)!('$D(^OR(100,+$G(IFN),0)))!($G(ID)="") Q ""
"RTN","ORCSAVE2",214,0)
 N I,Y S I=0,Y="" S:'$G(INST) INST=1
"RTN","ORCSAVE2",215,0)
 F  S I=$O(^OR(100,IFN,4.5,"ID",ID,I)) Q:I'>0  I $P($G(^OR(100,IFN,4.5,+I,0)),U,3)=INST S Y=$G(^(1)) Q
"RTN","ORCSAVE2",216,0)
 Q Y
"RTN","ORCSAVE2",217,0)
 ;
"RTN","ORCSAVE2",218,0)
SC(ORX,ORIFN) ; -- save responses to SC questions
"RTN","ORCSAVE2",219,0)
 Q:'$G(ORIFN)  Q:'$D(^OR(100,+ORIFN,0))  ;invalid order number
"RTN","ORCSAVE2",220,0)
 N OR5,I,P S OR5=$G(^OR(100,+ORIFN,5)),P=0
"RTN","ORCSAVE2",221,0)
 F I="SC","MST","AO","IR","EC","HNC","CV","SHD" S P=P+1 S:$D(ORX(I)) $P(OR5,U,P)=ORX(I)
"RTN","ORCSAVE2",222,0)
 S ^OR(100,+ORIFN,5)=OR5
"RTN","ORCSAVE2",223,0)
 Q
"RTN","ORCSAVE2",224,0)
 ;
"RTN","ORCSAVE2",225,0)
CANCEL(ORDER) ; -- cancel order [action]
"RTN","ORCSAVE2",226,0)
 N ORA,DIE,DA,DR,ORX
"RTN","ORCSAVE2",227,0)
 S ORDER=$G(ORDER),ORA=+$P(ORDER,";",2) Q:'ORA!('ORDER)
"RTN","ORCSAVE2",228,0)
 I $D(^OR(100,+ORDER,8,ORA)) D
"RTN","ORCSAVE2",229,0)
 .S ORX="Unsigned/unreleased order cancelled by provider"
"RTN","ORCSAVE2",230,0)
 .S DIE="^OR(100,"_+ORDER_",8,",DA=ORA,DA(1)=+ORDER
"RTN","ORCSAVE2",231,0)
 .S DR="4////5;15////13;1////^S X=ORX" D ^DIE
"RTN","ORCSAVE2",232,0)
 I ORA=1 D
"RTN","ORCSAVE2",233,0)
 .K DA S DIE="^OR(100,",DA=+ORDER,DR="5////13" D ^DIE
"RTN","ORCSAVE2",234,0)
 Q
"RTN","ORCSAVE2",235,0)
 ;
"RTN","ORCSAVE2",236,0)
LAPSE(ORDER) ; -- lapse order [action]
"RTN","ORCSAVE2",237,0)
 N ORA S ORA=+$P(ORDER,";",2)
"RTN","ORCSAVE2",238,0)
 Q:'$D(^OR(100,+ORDER,0))  Q:'ORA!('ORDER)
"RTN","ORCSAVE2",239,0)
 I $D(^OR(100,+ORDER,8,ORA)) D
"RTN","ORCSAVE2",240,0)
 .N DIE,DA,DR
"RTN","ORCSAVE2",241,0)
 .S DIE="^OR(100,"_+ORDER_",8,",DA=ORA,DA(1)=+ORDER
"RTN","ORCSAVE2",242,0)
 .S DR="4////5;15////14" D ^DIE,DELALRT^ORCSAVE1(ORDER) ; DELALRT call added to fix CQ #17536 (TC). [v28.1]
"RTN","ORCSAVE2",243,0)
 I ORA=1 D
"RTN","ORCSAVE2",244,0)
 .N DIE,DA,DR
"RTN","ORCSAVE2",245,0)
 .S DIE="^OR(100,",DA=+ORDER,DR="5////14"
"RTN","ORCSAVE2",246,0)
 .D ^DIE,ALPS(DA,ORA)
"RTN","ORCSAVE2",247,0)
 Q
"RTN","ORCSAVE2",248,0)
ALPS(DA,ORACT,TYPE) ;set the lapse index ^OR(100,"ALPS")
"RTN","ORCSAVE2",249,0)
 N ORVP,X,OR0,ORLOG
"RTN","ORCSAVE2",250,0)
 S OR0=$G(^OR(100,DA,8,ORACT,0))
"RTN","ORCSAVE2",251,0)
 S ORLOG=$P(OR0,U),ORVP=$P($G(^OR(100,DA,0)),U,2)
"RTN","ORCSAVE2",252,0)
 I ORVP,ORLOG S ^OR(100,"ALPS",ORVP,9999999-ORLOG,DA,ORACT)=$G(TYPE)
"RTN","ORCSAVE2",253,0)
 S ^OR(100,DA,10)=$$NOW^XLFDT
"RTN","ORCSAVE2",254,0)
 Q
"RTN","ORCSAVE2",255,0)
 ;
"RTN","ORCSAVE2",256,0)
RESP(IFN,PRMT,VAL,INST) ; -- update a single Response VALue
"RTN","ORCSAVE2",257,0)
 S IFN=+$G(IFN),VAL=$G(VAL),PRMT=+$O(^ORD(101.41,"AB",PRMT,0))
"RTN","ORCSAVE2",258,0)
 N ID,DA,DIK S:'$G(INST) INST=1
"RTN","ORCSAVE2",259,0)
 S ID=$P($G(^ORD(101.41,PRMT,1)),U,3) Q:'$L(ID)
"RTN","ORCSAVE2",260,0)
 S DA=0 F  S DA=$O(^OR(100,IFN,4.5,"ID",ID,DA)) Q:DA<1  Q:$P($G(^OR(100,IFN,4.5,DA,0)),U,3)=INST
"RTN","ORCSAVE2",261,0)
 I 'DA D:$L(VAL)  Q  ;add
"RTN","ORCSAVE2",262,0)
 . N DO,DIC,DLG,X
"RTN","ORCSAVE2",263,0)
 . S DIC="^OR(100,"_IFN_",4.5,",DA(1)=IFN,DIC(0)="FL"
"RTN","ORCSAVE2",264,0)
 . S DIC("DR")=".02///"_PRMT_";.03///"_INST_";.04///"_ID
"RTN","ORCSAVE2",265,0)
 . S DLG=+$P($G(^OR(100,IFN,0)),U,5)
"RTN","ORCSAVE2",266,0)
 . S X=+$O(^ORD(101.41,DLG,10,"D",PRMT,0))
"RTN","ORCSAVE2",267,0)
 . D FILE^DICN S:Y ^OR(100,IFN,4.5,+Y,1)=VAL
"RTN","ORCSAVE2",268,0)
 I $L(VAL) S ^OR(100,IFN,4.5,DA,1)=VAL Q  ;change
"RTN","ORCSAVE2",269,0)
 S DIK="^OR(100,"_IFN_",4.5,",DA(1)=IFN D ^DIK ;delete
"RTN","ORCSAVE2",270,0)
 Q
"RTN","ORDSGCHK")
0^4^B98387224
"RTN","ORDSGCHK",1,0)
ORDSGCHK ;SLC/AGP - PRE 0.5 DOSE ORDER CHECKS;07/31/2017  09:58
"RTN","ORDSGCHK",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**280,352,345,311,384,395,382**;Dec 17, 1997;Build 15
"RTN","ORDSGCHK",3,0)
 ;
"RTN","ORDSGCHK",4,0)
EN(ORY,DFN,TYPE,OIL) ;
"RTN","ORDSGCHK",5,0)
 N ARRAY,CNT,NAME
"RTN","ORDSGCHK",6,0)
 ;if renewed order build OIL array
"RTN","ORDSGCHK",7,0)
 I $G(ORREN)=1,+$G(ORIFN)>0 D
"RTN","ORDSGCHK",8,0)
 .;IV orders should only have a null type
"RTN","ORDSGCHK",9,0)
 .I TYPE="" S TYPE="PSIV"
"RTN","ORDSGCHK",10,0)
 .D BLDREN(TYPE,ORIFN,.OIL)
"RTN","ORDSGCHK",11,0)
 ;Build easy array to work with
"RTN","ORDSGCHK",12,0)
 S CNT=0 F  S CNT=$O(OIL(CNT)) Q:CNT'>0  D
"RTN","ORDSGCHK",13,0)
 .S NODE=$G(OIL(CNT)) Q:$P(NODE,U,2)="PSIV"
"RTN","ORDSGCHK",14,0)
 .S NAME=$P(NODE,U,2)
"RTN","ORDSGCHK",15,0)
 .Q:'$P(NODE,U,3)
"RTN","ORDSGCHK",16,0)
 .S ARRAY(NAME,$P(NODE,U,3))=NODE
"RTN","ORDSGCHK",17,0)
 I TYPE="PSH" Q
"RTN","ORDSGCHK",18,0)
 I TYPE="PSIV" D IV(.ORY,DFN,.ARRAY)
"RTN","ORDSGCHK",19,0)
 I TYPE'="PSIV" D NONIV(.ORY,DFN,.ARRAY)
"RTN","ORDSGCHK",20,0)
 Q
"RTN","ORDSGCHK",21,0)
 ;
"RTN","ORDSGCHK",22,0)
BLDREN(TYPE,ORIFN,OUT) ;
"RTN","ORDSGCHK",23,0)
 N CNT,EXTVALUE,ISOI,ITEM,LOC,NAME,NUM,NODE,ORDIALOG,TEXT,VALUE,X0,ORDSGSET
"RTN","ORDSGCHK",24,0)
 S ORDSGSET=0
"RTN","ORDSGCHK",25,0)
 S CNT=$O(OUT(""),-1)
"RTN","ORDSGCHK",26,0)
 S X0=$G(^OR(100,+ORIFN,0))
"RTN","ORDSGCHK",27,0)
 S ORDIALOG=+$P(X0,U,5)
"RTN","ORDSGCHK",28,0)
 D GETDLG^ORCD(ORDIALOG)
"RTN","ORDSGCHK",29,0)
 D GETORDER^ORCD(+ORIFN)
"RTN","ORDSGCHK",30,0)
 S LOC=0 F  S LOC=$O(ORDIALOG(LOC)) Q:LOC'>0  D
"RTN","ORDSGCHK",31,0)
 .S ITEM=$P($G(ORDIALOG(LOC)),U,2)
"RTN","ORDSGCHK",32,0)
 .I ITEM="" Q
"RTN","ORDSGCHK",33,0)
 .I ITEM="COMMENT" Q
"RTN","ORDSGCHK",34,0)
 .S ISOI=$S($G(ORDIALOG(LOC,0))[101.43:1,1:0)
"RTN","ORDSGCHK",35,0)
 .S NUM=0 F  S NUM=$O(ORDIALOG(LOC,NUM)) Q:NUM'>0  D
"RTN","ORDSGCHK",36,0)
 ..I NUM<1 Q
"RTN","ORDSGCHK",37,0)
 ..S VALUE=$G(ORDIALOG(LOC,NUM)),EXTVALUE=""
"RTN","ORDSGCHK",38,0)
 ..I ISOI=1 D
"RTN","ORDSGCHK",39,0)
 ...S EXTVALUE=$P($G(^ORD(101.43,VALUE,0)),U)
"RTN","ORDSGCHK",40,0)
 ...I $P($G(^ORD(101.41,LOC,0)),U)="OR GTX ADDITIVE" S ITEM="ADDITIVE"
"RTN","ORDSGCHK",41,0)
 ..I ITEM="RATE" S EXTVALUE=VALUE
"RTN","ORDSGCHK",42,0)
 ..I ITEM="DOSE" S ORDSGSET=1
"RTN","ORDSGCHK",43,0)
 ..S TEXT=TYPE_U_ITEM_U_NUM_U_VALUE_U_EXTVALUE
"RTN","ORDSGCHK",44,0)
 ..S CNT=CNT+1,OUT(CNT)=TEXT
"RTN","ORDSGCHK",45,0)
 ;SET THE DOSE AS BLANK IN THE OUTPUT ARRAY IF IT WASN'T SET ALREADY
"RTN","ORDSGCHK",46,0)
 I 'ORDSGSET S CNT=CNT+1,OUT(CNT)=TYPE_U_"DOSE^1^^"
"RTN","ORDSGCHK",47,0)
 Q
"RTN","ORDSGCHK",48,0)
 ;
"RTN","ORDSGCHK",49,0)
DURATION(STR) ;
"RTN","ORDSGCHK",50,0)
 N LEN,VAL,UNIT,IVLMT,TVAL
"RTN","ORDSGCHK",51,0)
 S (UNIT,IVLMT)="",VAL=0
"RTN","ORDSGCHK",52,0)
 I $E($$LOW^XLFSTR(STR))="f" D
"RTN","ORDSGCHK",53,0)
 . I STR["for a total of" D  Q
"RTN","ORDSGCHK",54,0)
 . .S VAL=$P(STR," ",5)
"RTN","ORDSGCHK",55,0)
 . .S UNIT=$P(STR," ",6)
"RTN","ORDSGCHK",56,0)
 . .S STR=""
"RTN","ORDSGCHK",57,0)
 . S VAL=$P(STR," ",2)
"RTN","ORDSGCHK",58,0)
 . S UNIT=$E($P(STR," ",3))
"RTN","ORDSGCHK",59,0)
 . S STR=""
"RTN","ORDSGCHK",60,0)
 I $E($$LOW^XLFSTR(STR))="w" D
"RTN","ORDSGCHK",61,0)
 . S TVAL=$P(STR," ",4)
"RTN","ORDSGCHK",62,0)
 . S VAL=+TVAL
"RTN","ORDSGCHK",63,0)
 . S LEN=$F(TVAL,VAL)
"RTN","ORDSGCHK",64,0)
 . I $P(VAL,".")="" S VAL=0_VAL
"RTN","ORDSGCHK",65,0)
 . F  S UNIT=$E(TVAL,LEN) Q:((UNIT'=0)&(UNIT'="."))  D
"RTN","ORDSGCHK",66,0)
 . . S LEN=LEN+1
"RTN","ORDSGCHK",67,0)
 . S STR=""
"RTN","ORDSGCHK",68,0)
 I $L(UNIT),$L(VAL) S IVLMT=VAL_$$UP^XLFSTR(UNIT)
"RTN","ORDSGCHK",69,0)
 I STR'="",IVLMT="" D
"RTN","ORDSGCHK",70,0)
 .I STR["ML" S IVLMT=$P(STR,"M")_"M" Q
"RTN","ORDSGCHK",71,0)
 .I STR["CC" S IVLMT=$P(STR,"C")_"M" Q
"RTN","ORDSGCHK",72,0)
 .S IVLMT=STR
"RTN","ORDSGCHK",73,0)
 Q IVLMT
"RTN","ORDSGCHK",74,0)
 ;
"RTN","ORDSGCHK",75,0)
IV(ORY,DFN,ARRAY) ;
"RTN","ORDSGCHK",76,0)
 N CNT,DRUG,DRUGIEN,DRUGNAME,NAME,NUM,OI,ORBASE,ORPSJARR,STR,STRENGTH,NODE
"RTN","ORDSGCHK",77,0)
 ;
"RTN","ORDSGCHK",78,0)
 I '$D(ARRAY) D  Q
"RTN","ORDSGCHK",79,0)
 . S ORY=$G(ORY)+1,ORY(ORY)="ERR^Incomplete data.  Dosage check could not be performed."
"RTN","ORDSGCHK",80,0)
 ;populate single values from order
"RTN","ORDSGCHK",81,0)
 S ORPSJARR("TVOL_DUR")="",ORPSJARR("SCHEDULE")=""
"RTN","ORDSGCHK",82,0)
 I $D(ARRAY("DAYS")) S ORPSJARR("TVOL_DUR")=$$DURATION($P(ARRAY("DAYS",1),U,4))
"RTN","ORDSGCHK",83,0)
 ;S RATE=$P(ARRAY(NAME,1),U,4)
"RTN","ORDSGCHK",84,0)
 S ORPSJARR("MR_IEN")=$P(ARRAY("ROUTE",1),U,4)
"RTN","ORDSGCHK",85,0)
 I $D(ARRAY("SCHEDULE")) S ORPSJARR("SCHEDULE")=$P(ARRAY("SCHEDULE",1),U,4)
"RTN","ORDSGCHK",86,0)
 S ORPSJARR("IV_TYPE")=$S($P(ARRAY("TYPE",1),U,4)="I":1,1:2)
"RTN","ORDSGCHK",87,0)
 I ORPSJARR("IV_TYPE")=2 S ORPSJARR("INF_RATE")=$P(ARRAY("RATE",1),U,5)
"RTN","ORDSGCHK",88,0)
 ;
"RTN","ORDSGCHK",89,0)
 ;build additive first, Drug, Strength/unit, bag
"RTN","ORDSGCHK",90,0)
 F NAME="ADDITIVE","ORDERABLE" D
"RTN","ORDSGCHK",91,0)
 .K DRUG
"RTN","ORDSGCHK",92,0)
 .S CNT=0,NUM=0
"RTN","ORDSGCHK",93,0)
 .F  S NUM=$O(ARRAY(NAME,NUM)) Q:NUM'>0  D
"RTN","ORDSGCHK",94,0)
 ..S CNT=CNT+1
"RTN","ORDSGCHK",95,0)
 ..S NODE=$G(ARRAY(NAME,NUM)),OI=$P(NODE,U,4)
"RTN","ORDSGCHK",96,0)
 ..;
"RTN","ORDSGCHK",97,0)
 ..S DRUGIEN=+$P(^ORD(101.43,OI,0),U,2) I DRUGIEN="" Q  ;PHARMACY OI FROM 101.43
"RTN","ORDSGCHK",98,0)
 ..S DRUGNAME=$P($G(ARRAY(NAME,NUM)),U,5) ;OI NAME
"RTN","ORDSGCHK",99,0)
 ..;
"RTN","ORDSGCHK",100,0)
 ..I NAME="ADDITIVE" D  Q
"RTN","ORDSGCHK",101,0)
 ...S STRENGTH=$P($G(ARRAY("STRENGTH",NUM)),U,4)_" "_$P($G(ARRAY("UNITS",NUM)),U,4)
"RTN","ORDSGCHK",102,0)
 ...S STR=+DRUGIEN_U_DRUGNAME_U_STRENGTH_U_$P($G(ARRAY("ADDFREQ",NUM)),U,4)
"RTN","ORDSGCHK",103,0)
 ...S ORPSJARR("AD",CNT)=STR_U_0
"RTN","ORDSGCHK",104,0)
 ...;check if enhanced order checks were done for this drug order and if so set ORDRUG(CNT,"ENH")=1
"RTN","ORDSGCHK",105,0)
 ...I $G(^TMP($J,"ORENHCHK"))=1 S ORPSJARR("AD",CNT)=STR_U_1
"RTN","ORDSGCHK",106,0)
 ..;
"RTN","ORDSGCHK",107,0)
 ..;Solution information
"RTN","ORDSGCHK",108,0)
 ..S STR=+DRUGIEN_U_DRUGNAME_U_$P($G(ARRAY("VOLUME",NUM)),U,4)_" ML"
"RTN","ORDSGCHK",109,0)
 ..S ORPSJARR("SOL",CNT)=STR,$P(ORPSJARR("SOL",CNT),U,5)=0
"RTN","ORDSGCHK",110,0)
 ..;check if enhanced order checks were done for this drug order and if so set ORDRUG(CNT,"ENH")=1
"RTN","ORDSGCHK",111,0)
 ..I $G(^TMP($J,"ORENHCHK"))=1 S ORPSJARR("SOL",CNT)=STR,$P(ORPSJARR("SOL",CNT),U,5)=1
"RTN","ORDSGCHK",112,0)
 ;
"RTN","ORDSGCHK",113,0)
 I $D(^TMP($J,"ORDSGCHK_CACHE")) M ^TMP($J,"ORDSGCHK2")=^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORDSGCHK",114,0)
 I '$D(^TMP($J,"ORDSGCHK_CACHE")) D
"RTN","ORDSGCHK",115,0)
 .S ORBASE(1)="ORDSGCHK1"
"RTN","ORDSGCHK",116,0)
 .S ORBASE(2)="ORDSGCHK2"
"RTN","ORDSGCHK",117,0)
 .D DOSE^PSJAPIDS(.ORBASE,DFN,.ORPSJARR)
"RTN","ORDSGCHK",118,0)
 .M ^TMP($J,"ORDSGCHK_CACHE")=^TMP($J,"ORDSGCHK2")
"RTN","ORDSGCHK",119,0)
 D PARSEOUT
"RTN","ORDSGCHK",120,0)
 K ^TMP($J,"ORDSGCHK1"),^TMP($J,"ORDSGCHK2")
"RTN","ORDSGCHK",121,0)
 Q
"RTN","ORDSGCHK",122,0)
 ;
"RTN","ORDSGCHK",123,0)
NONIV(ORY,DFN,ARRAY) ;
"RTN","ORDSGCHK",124,0)
 N CNT,DOSESTR,DRUG,DRUGARR,DRUGIEN,DRUGNAME,DUR,NAME,NODE
"RTN","ORDSGCHK",125,0)
 N OIIEN,ORBASE,ORDRUG,ORPSARR,PACK,PSNODE,SUB,TYPE,ADMIN
"RTN","ORDSGCHK",126,0)
 ;
"RTN","ORDSGCHK",127,0)
 ;assume same drug type used throughout the order dialog
"RTN","ORDSGCHK",128,0)
 ;new free-text dose orders do not have a drug, all other free-text orders do
"RTN","ORDSGCHK",129,0)
 S DRUGIEN=+$P($G(ARRAY("DRUG",1)),U,4)
"RTN","ORDSGCHK",130,0)
 I DRUGIEN>0,$$EXMT^PSSDSAPI(DRUGIEN)=1 Q
"RTN","ORDSGCHK",131,0)
 ;if no ARRAY(DOSE) node set it to null to force free text evaluation
"RTN","ORDSGCHK",132,0)
 N I S I=0 F  S I=$O(ARRAY("INSTR",I)) Q:'I  I '$D(ARRAY("DOSE",I))  S ARRAY("DOSE",I)=$P(ARRAY("INSTR",I),U)_"^DOSE^"_I_"^"
"RTN","ORDSGCHK",133,0)
 ;
"RTN","ORDSGCHK",134,0)
 S ADMIN="",ADMIN("SAVE")=1
"RTN","ORDSGCHK",135,0)
 S NAME="" F  S NAME=$O(ARRAY(NAME)) Q:NAME=""  D
"RTN","ORDSGCHK",136,0)
 .S SUB=$$GETSUB(NAME) I SUB="" Q
"RTN","ORDSGCHK",137,0)
 .S CNT=0 F  S CNT=$O(ARRAY(NAME,CNT)) Q:CNT'>0  D
"RTN","ORDSGCHK",138,0)
 ..S NODE=$G(ARRAY(NAME,CNT))
"RTN","ORDSGCHK",139,0)
 ..;
"RTN","ORDSGCHK",140,0)
 ..;get dose information and drug information from Dose Prompt
"RTN","ORDSGCHK",141,0)
 ..I SUB="DOSE" D
"RTN","ORDSGCHK",142,0)
 ...S PACK=$P(NODE,U)
"RTN","ORDSGCHK",143,0)
 ...S TYPE=$S($P(NODE,U)="PSO":"O",1:"I")
"RTN","ORDSGCHK",144,0)
 ...S DOSESTR=$P(NODE,U,4)
"RTN","ORDSGCHK",145,0)
 ...;free text dose
"RTN","ORDSGCHK",146,0)
 ...I DOSESTR="" D
"RTN","ORDSGCHK",147,0)
 ....S ORDRUG(CNT,"RX_NUM")=TYPE_";1;PROSPECTIVE;"_CNT
"RTN","ORDSGCHK",148,0)
 ....I DRUGIEN>0 D  Q
"RTN","ORDSGCHK",149,0)
 .....S ORPSARR(CNT,"DO")=$P($G(ARRAY("INSTR",CNT)),U,4)
"RTN","ORDSGCHK",150,0)
 .....S ORDRUG(CNT,"DRUG_IEN")=DRUGIEN
"RTN","ORDSGCHK",151,0)
 .....S ORDRUG(CNT,"DRUG_NM")=$$GETPSNM^ORKPS(DRUGIEN) ;DRUGNAME
"RTN","ORDSGCHK",152,0)
 ....N ORTDOSE,ORTDNAME
"RTN","ORDSGCHK",153,0)
 ....S ARRAY("ORPSA",CNT)=$$OI2DD^ORKPS($P(ARRAY("ORDERABLE",1),U,4),$E($P(ARRAY("ORDERABLE",1),U,1),3),2)
"RTN","ORDSGCHK",154,0)
 ....Q:'$P(ARRAY("ORPSA",CNT),";",1)
"RTN","ORDSGCHK",155,0)
 ....K ^TMP($J,"DRUGARR") D ZERO^PSS50($P(ARRAY("ORPSA",CNT),";",1),,,,,"DRUGARR")
"RTN","ORDSGCHK",156,0)
 ....N ORDRGNM S ORDRGNM=$G(^TMP($J,"DRUGARR",$P(ARRAY("ORPSA",CNT),";",1),.01))
"RTN","ORDSGCHK",157,0)
 ....S ORPSARR(CNT,"DO")=$$TRIM^ORBCMA32($P($P($G(ARRAY("INSTR",CNT)),U,4),ORDRGNM))
"RTN","ORDSGCHK",158,0)
 ....S OIIEN=$P($G(ARRAY("ORDERABLE",1)),U,4) ;orderable only exists for first item (in complex order)
"RTN","ORDSGCHK",159,0)
 ....S ORDRUG("OI")=+$P($G(^ORD(101.43,OIIEN,0)),U,2)
"RTN","ORDSGCHK",160,0)
 ....S ORDRUG("PACKAGE")=$S(PACK="PSO":"O",PACK="PSH":"X",1:"I")
"RTN","ORDSGCHK",161,0)
 ....S PSNODE=$G(^ORD(101.43,OIIEN,"PS"))
"RTN","ORDSGCHK",162,0)
 ....S ORDRUG("OI_USAGE")=$S($P(PSNODE,U,4)=1:"A",1:"")_$S($P(PSNODE,U,3)=1:"B",1:"")
"RTN","ORDSGCHK",163,0)
 ....S ORDRUG(CNT,"DRUG_NM")=$$TRIM^ORBCMA32($P($G(ARRAY("ORDERABLE",1)),U,5))
"RTN","ORDSGCHK",164,0)
 ...;
"RTN","ORDSGCHK",165,0)
 ...;check if enhanced order checks were done for this drug order and if so set ORDRUG(CNT,"ENH")=1
"RTN","ORDSGCHK",166,0)
 ...I $G(^TMP($J,"ORENHCHK"))=1,((DOSESTR=""&$D(ORDRUG))!(DOSESTR'="")) S ORDRUG(CNT,"ENH")=1
"RTN","ORDSGCHK",167,0)
 ...Q:DOSESTR=""
"RTN","ORDSGCHK",168,0)
 ...S DRUGIEN=$P(DOSESTR,"&",6)
"RTN","ORDSGCHK",169,0)
 ...K ^TMP($J,"DRUGARR")
"RTN","ORDSGCHK",170,0)
 ...D ZERO^PSS50(DRUGIEN,,,,,"DRUGARR")
"RTN","ORDSGCHK",171,0)
 ...S DRUGNAME=$G(^TMP($J,"DRUGARR",DRUGIEN,.01))
"RTN","ORDSGCHK",172,0)
 ...K ^TMP($J,"DRUGARR")
"RTN","ORDSGCHK",173,0)
 ...;
"RTN","ORDSGCHK",174,0)
 ...;Local Possible Dose
"RTN","ORDSGCHK",175,0)
 ...I $P(DOSESTR,"&")="" D  Q
"RTN","ORDSGCHK",176,0)
 ....S ORPSARR(CNT,"DO")=$P($G(ARRAY("INSTR",CNT)),U,4)
"RTN","ORDSGCHK",177,0)
 ....S ORDRUG(CNT,"RX_NUM")=TYPE_";1;PROSPECTIVE;"_CNT
"RTN","ORDSGCHK",178,0)
 ....S ORDRUG(CNT,"DRUG_IEN")=DRUGIEN
"RTN","ORDSGCHK",179,0)
 ....S ORDRUG(CNT,"DRUG_NM")=$$GETPSNM^ORKPS(DRUGIEN) ;DRUGNAME
"RTN","ORDSGCHK",180,0)
 ...;
"RTN","ORDSGCHK",181,0)
 ...;Possible Dose
"RTN","ORDSGCHK",182,0)
 ...S ORPSARR(CNT,"DRG_AMT")=$P(DOSESTR,"&")
"RTN","ORDSGCHK",183,0)
 ...S ORPSARR(CNT,"DRG_UNIT")=$P(DOSESTR,"&",2)
"RTN","ORDSGCHK",184,0)
 ...S ORDRUG(CNT,"RX_NUM")=TYPE_";1;PROSPECTIVE;"_CNT
"RTN","ORDSGCHK",185,0)
 ...S ORDRUG(CNT,"DRUG_IEN")=DRUGIEN
"RTN","ORDSGCHK",186,0)
 ...S ORDRUG(CNT,"DRUG_NM")=$$GETPSNM^ORKPS(DRUGIEN) ;DRUGNAME
"RTN","ORDSGCHK",187,0)
 ..;
"RTN","ORDSGCHK",188,0)
 ..;Additional Order Data
"RTN","ORDSGCHK",189,0)
 ..I SUB="DRATE" D  Q
"RTN","ORDSGCHK",190,0)
 ...S DUR=$P($P(NODE,U,4)," ")
"RTN","ORDSGCHK",191,0)
 ...S ORPSARR(CNT,SUB)=DUR_$$DRATESTR($P($P(NODE,U,4)," ",2))
"RTN","ORDSGCHK",192,0)
 ..I SUB="CONJ",$P(NODE,U)="PSI",ADMIN("SAVE") D
"RTN","ORDSGCHK",193,0)
 ...S:$D(ARRAY("SCHEDULE",CNT))=1 ADMIN=ADMIN_";"_$P(ARRAY("SCHEDULE",CNT),U,4)
"RTN","ORDSGCHK",194,0)
 ...I $P($G(ARRAY(SUB,CNT)),U,4)'="A" S ADMIN("SAVE")=0
"RTN","ORDSGCHK",195,0)
 ..S ORPSARR(CNT,SUB)=$P(NODE,U,4)
"RTN","ORDSGCHK",196,0)
 ;
"RTN","ORDSGCHK",197,0)
 ;Get rid of any preceeding or trailing spaces on the dose
"RTN","ORDSGCHK",198,0)
 N ORSPI S ORSPI=0 F  S ORSPI=$O(ORPSARR(ORSPI)) Q:'ORSPI  D
"RTN","ORDSGCHK",199,0)
 .I $D(ORPSARR(ORSPI,"DO")) S ORPSARR(ORSPI,"DO")=$$TRIM^XLFSTR(ORPSARR(ORSPI,"DO"))
"RTN","ORDSGCHK",200,0)
 ;
"RTN","ORDSGCHK",201,0)
 I ADMIN'="" D
"RTN","ORDSGCHK",202,0)
 .N ORAT
"RTN","ORDSGCHK",203,0)
 .D ADMIN^ORWDPS2(.ORAT,DFN,ADMIN,$P($G(ARRAY("ORDERABLE",1)),U,4),+ORL,$P($G(ARRAY("ADMIN",1)),U,4))
"RTN","ORDSGCHK",204,0)
 .I $P(ORAT,U,4)'="" S ORPSARR(1,"EFD")=$P(ORAT,U,4)
"RTN","ORDSGCHK",205,0)
 ;
"RTN","ORDSGCHK",206,0)
 I $D(ORDRUG) D
"RTN","ORDSGCHK",207,0)
 .S ORBASE(1)="ORDSGCHK1",ORBASE(2)="ORDSGCHK2"
"RTN","ORDSGCHK",208,0)
 .S ORPSARR("CONTEXT")="CPRS-UD"
"RTN","ORDSGCHK",209,0)
 .D DOSE^PSSDSAPD(.ORBASE,DFN,.ORPSARR,.ORDRUG),PARSEOUT
"RTN","ORDSGCHK",210,0)
 .K ^TMP($J,"ORDSGCHK1"),^TMP($J,"ORDSGCHK2")
"RTN","ORDSGCHK",211,0)
 Q
"RTN","ORDSGCHK",212,0)
 ;
"RTN","ORDSGCHK",213,0)
PARSEOUT ;PARSE OUTPUT GLOBAL
"RTN","ORDSGCHK",214,0)
 N ORNBP S ORNBP=""
"RTN","ORDSGCHK",215,0)
 I $D(^TMP($J,"ORDSGCHK2")) D
"RTN","ORDSGCHK",216,0)
 .I $P($G(^TMP($J,"ORDSGCHK2","OUT",0)),U)=-1 S ORNBP=$$DSDWNMSG^ORDSGCHK Q
"RTN","ORDSGCHK",217,0)
 .I $D(^TMP($J,"ORDSGCHK2","OUT","ERROR")) D
"RTN","ORDSGCHK",218,0)
 ..N I S I="" F  S I=$O(^TMP($J,"ORDSGCHK2","OUT","ERROR",I)) Q:'$L(I)  D
"RTN","ORDSGCHK",219,0)
 ...N J S J="" F  S J=$O(^TMP($J,"ORDSGCHK2","OUT","ERROR",I,J)) Q:'$L(J)  D
"RTN","ORDSGCHK",220,0)
 ....N K S K="" F  S K=$O(^TMP($J,"ORDSGCHK2","OUT","ERROR",I,J,K)) Q:'$L(K)  D
"RTN","ORDSGCHK",221,0)
 .....I $L($G(^TMP($J,"ORDSGCHK2","OUT","ERROR",I,J,K,"MSG"))) S ORY=$G(ORY)+1,ORY(ORY)="ERR^"_^TMP($J,"ORDSGCHK2","OUT","ERROR",I,J,K,"MSG") D
"RTN","ORDSGCHK",222,0)
 ......I $L($G(^TMP($J,"ORDSGCHK2","OUT","ERROR",I,J,K,"TEXT"))) S ORY(ORY)=ORY(ORY)_"  "_$G(^TMP($J,"ORDSGCHK2","OUT","ERROR",I,J,K,"TEXT"))
"RTN","ORDSGCHK",223,0)
 .I $D(^TMP($J,"ORDSGCHK2","OUT","CHECK")) D
"RTN","ORDSGCHK",224,0)
 .N ORI S ORI=0 F  S ORI=$O(^TMP($J,"ORDSGCHK2","OUT","CHECK",ORI)) Q:'ORI  D
"RTN","ORDSGCHK",225,0)
 ..N ORJ S ORJ="" F  S ORJ=$O(^TMP($J,"ORDSGCHK2","OUT","CHECK",ORI,ORJ)) Q:'$L(ORJ)  D
"RTN","ORDSGCHK",226,0)
 ...N ORK S ORK=0 F  S ORK=$O(^TMP($J,"ORDSGCHK2","OUT","CHECK",ORI,ORJ,ORK)) Q:'ORK  D
"RTN","ORDSGCHK",227,0)
 ....N ORDGTYPE S ORDGTYPE="DS"
"RTN","ORDSGCHK",228,0)
 ....N ORRTTYPE S ORRTTYPE=$P($G(^TMP($J,"ORDSGCHK2","OUT","CHECK",ORI,ORJ,ORK,"ATYPE")),U,2)
"RTN","ORDSGCHK",229,0)
 ....I ORRTTYPE="INFORMATIONAL" S ORDGTYPE="INFO"
"RTN","ORDSGCHK",230,0)
 ....I ORRTTYPE="GENERAL" S ORDGTYPE="INFO"
"RTN","ORDSGCHK",231,0)
 ....I ORRTTYPE="EXCEPTION" S ORDGTYPE="INFO"
"RTN","ORDSGCHK",232,0)
 ....S ORY=$G(ORY)+1,ORY(ORY)=ORDGTYPE_U
"RTN","ORDSGCHK",233,0)
 ....N ORL S ORL=0 F  S ORL=$O(^TMP($J,"ORDSGCHK2","OUT","CHECK",ORI,ORJ,ORK,"MSG",ORL)) Q:'ORL  D
"RTN","ORDSGCHK",234,0)
 .....S ORY(ORY)=ORY(ORY)_^TMP($J,"ORDSGCHK2","OUT","CHECK",ORI,ORJ,ORK,"MSG",ORL)_" "
"RTN","ORDSGCHK",235,0)
 I $L(ORNBP)>1 S ORY=$G(ORY)+1,ORY(ORY)="ERR^"_ORNBP,ORNBP=""
"RTN","ORDSGCHK",236,0)
 Q
"RTN","ORDSGCHK",237,0)
 ;
"RTN","ORDSGCHK",238,0)
GETSUB(NAME) ;
"RTN","ORDSGCHK",239,0)
 I NAME="DAYS" Q "DRATE"
"RTN","ORDSGCHK",240,0)
 I NAME="ROUTE" Q "MR_IEN"
"RTN","ORDSGCHK",241,0)
 I "^CONJ^DOSE^SCHEDULE^"[(U_NAME_U) Q NAME
"RTN","ORDSGCHK",242,0)
 Q ""
"RTN","ORDSGCHK",243,0)
 ;
"RTN","ORDSGCHK",244,0)
DRATESTR(ORIN) ;change the form of the DURATION
"RTN","ORDSGCHK",245,0)
 ;DAYS=D,WEEKS=W,MONTHS=L,HOURS=H,MINUTES=M
"RTN","ORDSGCHK",246,0)
 I $$UP^XLFSTR(ORIN)="MONTHS" Q "L"
"RTN","ORDSGCHK",247,0)
 Q $E($$UP^XLFSTR(ORIN))
"RTN","ORDSGCHK",248,0)
 ;
"RTN","ORDSGCHK",249,0)
DSDWNMSG() ;dosage down message (not displayed to user)
"RTN","ORDSGCHK",250,0)
 Q "Drug Dosage checks were not able to be performed."
"RTN","ORKCHK5")
0^5^B90858156
"RTN","ORKCHK5",1,0)
ORKCHK5 ;SLC/CLA - SUPPORT ROUTINE FOR ACCEPT MODE ORDER CHECKS ; 6/26/17 10:27am
"RTN","ORKCHK5",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,94,123,190,280,357,345,269,382**;Dec 17, 1997;Build 15
"RTN","ORKCHK5",3,0)
 Q
"RTN","ORKCHK5",4,0)
EN(ORKS,ORKDFN,ORKA,ORENT,ORKTMODE,OROIL,ORDODSG) ;perform order checking for orderable item acceptance
"RTN","ORKCHK5",5,0)
 ;ORDODSG: FLAG THAT DENOTES IF DOSAGE CHECKS SHOULD BE PERFORMED
"RTN","ORKCHK5",6,0)
 ;         1 FOR PERFORM DOSAGE CHECKS
"RTN","ORKCHK5",7,0)
 ;         0 FOR DO NOT PERFORM DOSAGE CHECKS
"RTN","ORKCHK5",8,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE",1,"I")="D"
"RTN","ORKCHK5",9,0)
 ;
"RTN","ORKCHK5",10,0)
 N OI,ORKDG,HL7,ODT,ORNUM,HL7NPTR,HL7NTXT,HL7NCOD,HL7LPTR,HL7LTXT,HL7LCOD
"RTN","ORKCHK5",11,0)
 N OCN,DNGR,ORKMSG,ORKPDATA,ORKOCNUM
"RTN","ORKCHK5",12,0)
 ;
"RTN","ORKCHK5",13,0)
 S OI=$P(ORKA,"|"),ORKDG=$P(ORKA,"|",2),HL7=$P(ORKA,"|",3)
"RTN","ORKCHK5",14,0)
 S ODT=$P(ORKA,"|",4),ORNUM=$P(ORKA,"|",5),ORKPDATA=$P(ORKA,"|",6)
"RTN","ORKCHK5",15,0)
 S HL7NPTR=$P(HL7,U),HL7NTXT=$P(HL7,U,2),HL7NCOD=$P(HL7,U,3)
"RTN","ORKCHK5",16,0)
 S HL7LPTR=$P(HL7,U,4),HL7LTXT=$P(HL7,U,5),HL7LCOD=$P(HL7,U,6)
"RTN","ORKCHK5",17,0)
 I ORKDG="GMRC",'$L(ODT) S ODT=$$NOW^XLFDT  ;def consult order d/t is now
"RTN","ORKCHK5",18,0)
 ;
"RTN","ORKCHK5",19,0)
 I $E(ORKDG,1,2)="PS" D PHARM
"RTN","ORKCHK5",20,0)
 I $E(ORKDG,1,2)'="PS",($E(ORKDG,1,2)'="LR"),($L($G(OI))),($L($G(ODT))),(ORKTMODE'="ALL") D DUPOR
"RTN","ORKCHK5",21,0)
 I $E(ORKDG,1,2)="LR",($L($G(OI))),($L($G(ODT))),(ORKTMODE'="ALL") D
"RTN","ORKCHK5",22,0)
 .D DUPLAB
"RTN","ORKCHK5",23,0)
 .D LABFREQ
"RTN","ORKCHK5",24,0)
 I $E(ORKDG,1,2)'="PS" D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"ACCEPT")
"RTN","ORKCHK5",25,0)
 D REMCHK(.ORKS,OI,ORKDFN) ;do reminder order checks
"RTN","ORKCHK5",26,0)
 Q
"RTN","ORKCHK5",27,0)
 ;
"RTN","ORKCHK5",28,0)
PHARM ;process pharmacy order checks:
"RTN","ORKCHK5",29,0)
 N ORPSPKG,ORPSA,ORKDD
"RTN","ORKCHK5",30,0)
 N ORALLRN,ORALLRF,ORALLRD
"RTN","ORKCHK5",31,0)
 D PARAMS("ALLERGY-DRUG INTERACTION",.ORALLRN,.ORALLRF,.ORALLRD)
"RTN","ORKCHK5",32,0)
 ;
"RTN","ORKCHK5",33,0)
 D:+ORDODSG DSGCHK(.ORKS,ORKDFN,.OROIL,ORKA) ;do pharmacy dosage checks
"RTN","ORKCHK5",34,0)
 ;dispense drug selected:
"RTN","ORKCHK5",35,0)
 I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK5",36,0)
 .D RXOCS
"RTN","ORKCHK5",37,0)
 .D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"ACCEPT")
"RTN","ORKCHK5",38,0)
 ;
"RTN","ORKCHK5",39,0)
 ;dispense drug NOT selected, split OI into dispense drugs:
"RTN","ORKCHK5",40,0)
 I '$L($G(HL7LPTR)) D
"RTN","ORKCHK5",41,0)
 .S ORPSPKG=$E(ORKDG,3)
"RTN","ORKCHK5",42,0)
 .I ORPSPKG="H" S ORPSPKG="X"  ;change to "X" if "H"erbal/non-VA med
"RTN","ORKCHK5",43,0)
 .I "IOX"[ORPSPKG D OI2DD(.ORPSA,OI,ORPSPKG)
"RTN","ORKCHK5",44,0)
 .S ORKDD=0 F  S ORKDD=$O(ORPSA(ORKDD)) Q:'ORKDD  D
"RTN","ORKCHK5",45,0)
 ..S HL7LTXT=ORPSA(ORKDD)
"RTN","ORKCHK5",46,0)
 ..S HL7NPTR=$P(ORKDD,";",2)
"RTN","ORKCHK5",47,0)
 ..S HL7LPTR=+ORKDD
"RTN","ORKCHK5",48,0)
 ..S HL7LCOD="99PSD",HL7NCOD="99NDF"
"RTN","ORKCHK5",49,0)
 ..S $P(HL7,U)=HL7NPTR,$P(HL7,U,3)=HL7NCOD
"RTN","ORKCHK5",50,0)
 ..S $P(HL7,U,4)=HL7LPTR,$P(HL7,U,5)=HL7LTXT,$P(HL7,U,6)=HL7LCOD
"RTN","ORKCHK5",51,0)
 ..S $P(ORKA,"|",3)=HL7  ;set these for MLM OCX call
"RTN","ORKCHK5",52,0)
 ..D RXOCS
"RTN","ORKCHK5",53,0)
 ..D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"ACCEPT")
"RTN","ORKCHK5",54,0)
 Q
"RTN","ORKCHK5",55,0)
 ;
"RTN","ORKCHK5",56,0)
RXOCS ;drug-allergy interaction
"RTN","ORKCHK5",57,0)
 Q:ORALLRF="D"
"RTN","ORKCHK5",58,0)
 N DATA,J,DELIMIT,CRC16,FCOUNT,NUM
"RTN","ORKCHK5",59,0)
 Q:$$ORCHK2^GMRAOR(ORKDFN,"DR",$G(HL7NPTR)_$S($G(HL7NPTR)'[".":".",1:"")_"."_$G(HL7LPTR),,"DATA")<1
"RTN","ORKCHK5",60,0)
 F J=1:1:DATA  D
"RTN","ORKCHK5",61,0)
 .N SIGN,GMRALLER,REACTANT,TEXT,ITM,ITEMS,NODE,COUNT,SEVERE,K,SITE
"RTN","ORKCHK5",62,0)
 .S FCOUNT=2,GMRALLER=$P(DATA(J,"MESSAGE",2),U,3),REACTANT=$P(DATA(J,"MESSAGE",2),U,2)
"RTN","ORKCHK5",63,0)
 .;Previous [SEVERITY] adverse reaction
"RTN","ORKCHK5",64,0)
 .S K="" F  S K=$O(DATA(J,K)) Q:K=""!(K'="MESSAGE")
"RTN","ORKCHK5",65,0)
 .I K'="" D
"RTN","ORKCHK5",66,0)
 ..S SITE=$P(DATA(J,K),U),SEVERE=$P(DATA(J,K),U,4)
"RTN","ORKCHK5",67,0)
 ..I SEVERE'="" F ITM=1:1:$L(SEVERE,"~")  I $P($P(SEVERE,"~",ITM),"|",2)>$G(SEVERE("MSG")) S SEVERE("MSG")=$P($P(SEVERE,"~",ITM),"|",2),SEVERE("MSG","NODE")=ITM
"RTN","ORKCHK5",68,0)
 .S ORKMSG="Previous "_$S($G(SEVERE("MSG","NODE"))'="":$P(DATA(J,"MESSAGE",1,SITE,1,SEVERE("MSG","NODE")),U,2)_" ",1:"")_"adverse reaction "
"RTN","ORKCHK5",69,0)
 .;to [GMR ALLERGY]
"RTN","ORKCHK5",70,0)
 .I GMRALLER="",(REACTANT'="") S GMRALLER=REACTANT
"RTN","ORKCHK5",71,0)
 .I GMRALLER'="" S ORKMSG=ORKMSG_"to "_GMRALLER_" "
"RTN","ORKCHK5",72,0)
 .;[[REACTANT]]
"RTN","ORKCHK5",73,0)
 .S ORKMSG=ORKMSG_$S(GMRALLER'=REACTANT:"["_REACTANT_"] ",1:"")
"RTN","ORKCHK5",74,0)
 .S ORKMSG=$P(ORKMSG,"[] ")
"RTN","ORKCHK5",75,0)
 .;(based on {INGREDIENT [DRUG_INGREDIENT]|DRUG CLASS [DRUG CLASS]|REACTANT [REACTANT]})
"RTN","ORKCHK5",76,0)
 .F NODE="ING","CLS","REC"  I $D(DATA(J,"MESSAGE","OFFENDERS",NODE)) D
"RTN","ORKCHK5",77,0)
 ..S DELIMIT=", ",TEXT=""
"RTN","ORKCHK5",78,0)
 ..F ITM=1:1:$L(DATA(J,"MESSAGE","OFFENDERS",NODE),"~") D
"RTN","ORKCHK5",79,0)
 ...S:ITM=$L(DATA(J,"MESSAGE","OFFENDERS",NODE),"~") DELIMIT=" and "
"RTN","ORKCHK5",80,0)
 ...S TEXT=$S($G(TEXT)'="":TEXT_DELIMIT,1:"")_$P(DATA(J,"MESSAGE","OFFENDERS",NODE),"~",ITM)
"RTN","ORKCHK5",81,0)
 ..S TEXT(1)=$S(NODE="ING":"DRUG INGREDIENT",NODE="CLS":"DRUG CLASS",NODE="REC":"REACTANT",1:"")
"RTN","ORKCHK5",82,0)
 ..I TEXT[" and " S TEXT(1)=TEXT(1)_$S(NODE="CLS":"ES",1:"S")
"RTN","ORKCHK5",83,0)
 ..S TEXT("OUT")=$S($G(TEXT("OUT"))'="":TEXT("OUT")_"~",1:"")_TEXT(1)_" "_TEXT
"RTN","ORKCHK5",84,0)
 .S DELIMIT=", ",TEXT=""
"RTN","ORKCHK5",85,0)
 .F ITM=1:1:$L(TEXT("OUT"),"~")  D
"RTN","ORKCHK5",86,0)
 ..S:ITM=$L(TEXT("OUT"),"~") DELIMIT=" and "
"RTN","ORKCHK5",87,0)
 ..S TEXT=$S($G(TEXT)'="":TEXT_DELIMIT,1:"")_$P(TEXT("OUT"),"~",ITM)
"RTN","ORKCHK5",88,0)
 .S:$G(TEXT)'="" ORKMSG=ORKMSG_"(based on "_TEXT_") "
"RTN","ORKCHK5",89,0)
 .;resulted in [SIGNS/SYMPTOMS]
"RTN","ORKCHK5",90,0)
 .I $P(DATA(J,"MESSAGE",2),U)'="" S ORKMSG=ORKMSG_"resulted in "_$P(DATA(J,"MESSAGE",2),U)_" "
"RTN","ORKCHK5",91,0)
 .;([STATION NAME] entered on [DOCUMENTATION DATE/TIME]).
"RTN","ORKCHK5",92,0)
 .K TEXT
"RTN","ORKCHK5",93,0)
 .S DELIMIT=", ",COUNT=1,COUNT("TOTAL")=DATA(J,"MESSAGE",1)
"RTN","ORKCHK5",94,0)
 .S ITM=0 F  S ITM=$O(DATA(J,"MESSAGE",1,ITM)) Q:ITM=""  D
"RTN","ORKCHK5",95,0)
 ..S:COUNT=COUNT("TOTAL") DELIMIT=" and "
"RTN","ORKCHK5",96,0)
 ..S TEXT=$S($G(TEXT)'="":TEXT_DELIMIT,1:"")_$P(DATA(J,"MESSAGE",1,ITM),U)_" entered on "_$P(DATA(J,"MESSAGE",1,ITM),U,3)
"RTN","ORKCHK5",97,0)
 ..S COUNT=1+COUNT
"RTN","ORKCHK5",98,0)
 .S ORKMSG=ORKMSG_"("_TEXT_")."
"RTN","ORKCHK5",99,0)
 .S ORKS("ORK",ORALLRD_","_$G(ORNUM)_","_$E(ORKMSG,1,225))=ORNUM_U_ORALLRN_U_ORALLRD_U_ORKMSG
"RTN","ORKCHK5",100,0)
 .;SAVE DATA FOR ORDER CHECK INSTANCES FILE ENTRY
"RTN","ORKCHK5",101,0)
 .S CRC16=$$CRC16^XLFCRC(ORKMSG),NUM=0
"RTN","ORKCHK5",102,0)
 .S ITM="" F  S ITM=$O(DATA(J,ITM)) Q:ITM=""  D
"RTN","ORKCHK5",103,0)
 ..Q:ITM="MESSAGE"
"RTN","ORKCHK5",104,0)
 ..S NUM=1+$G(NUM)
"RTN","ORKCHK5",105,0)
 ..K:NUM=1 ^TMP("OROCIDATA",$J,CRC16)
"RTN","ORKCHK5",106,0)
 ..S ^TMP("OROCIDATA",$J,CRC16,100.517,NUM,.01)=$P(DATA(J,ITM),U,6)
"RTN","ORKCHK5",107,0)
 ..S:$P(DATA(J,ITM),U,7)'="" ^TMP("OROCIDATA",$J,CRC16,100.517,NUM,2)=$P(DATA(J,ITM),U,7)
"RTN","ORKCHK5",108,0)
 ..S ^TMP("OROCIDATA",$J,CRC16,100.517,NUM,6)=$P(DATA(J,ITM),U,2)
"RTN","ORKCHK5",109,0)
 ..S:$P(DATA(J,ITM),U,2)="R" ^TMP("OROCIDATA",$J,CRC16,100.517,NUM,7)=$P(DATA(J,ITM),U)
"RTN","ORKCHK5",110,0)
 ..S ^TMP("OROCIDATA",$J,CRC16,100.517,NUM,8)=$P(DATA(J,ITM),U,3)
"RTN","ORKCHK5",111,0)
 ..S ^TMP("OROCIDATA",$J,CRC16,100.517,NUM,9)=$$UP^XLFSTR($P(DATA(J,ITM),U,8))
"RTN","ORKCHK5",112,0)
 ..S:$G(SEVERE("MSG"))'="" ^TMP("OROCIDATA",$J,CRC16,100.517,NUM,10)=SEVERE("MSG")
"RTN","ORKCHK5",113,0)
 ..F ITM(1)=1:1:$L($P(DATA(J,ITM),U,5),"~") S ^TMP("OROCIDATA",$J,CRC16,"SIGN",NUM,"+"_ITM(1)_",")=$P($P(DATA(J,ITM),U,5),"~",ITM(1))
"RTN","ORKCHK5",114,0)
 ..S FCOUNT=ITM(1)+1
"RTN","ORKCHK5",115,0)
 ..S ^TMP("OROCIDATA",$J,CRC16,100.05,84)=$P(DATA(J,ITM),U,9)
"RTN","ORKCHK5",116,0)
 ..F NODE="ING","CLS"  I $D(DATA(J,ITM,NODE)) F ITM(1)=1:1:$L(DATA(J,ITM,NODE),"~")  D
"RTN","ORKCHK5",117,0)
 ...S ^TMP("OROCIDATA",$J,CRC16,$S(NODE="ING":"INGREDIENT",NODE="CLS":"CLASS",1:""),NUM,"+"_FCOUNT_",")=$P(DATA(J,ITM,NODE),"~",ITM(1)),FCOUNT=FCOUNT+1
"RTN","ORKCHK5",118,0)
 Q
"RTN","ORKCHK5",119,0)
 ;
"RTN","ORKCHK5",120,0)
OI2DD(ORPSA,OROI,ORPSPKG)       ;rtn dispense drugs for a PS OI
"RTN","ORKCHK5",121,0)
 N PSOI
"RTN","ORKCHK5",122,0)
 Q:'$D(^ORD(101.43,OROI,0))
"RTN","ORKCHK5",123,0)
 S PSOI=$P($P(^ORD(101.43,OROI,0),U,2),";")
"RTN","ORKCHK5",124,0)
 Q:+$G(PSOI)<1
"RTN","ORKCHK5",125,0)
 D DRG^PSSUTIL1(.ORPSA,PSOI,ORPSPKG)
"RTN","ORKCHK5",126,0)
 Q
"RTN","ORKCHK5",127,0)
 ;
"RTN","ORKCHK5",128,0)
DUPOR ;duplicate orders for non-pharmacy and non-lab:
"RTN","ORKCHK5",129,0)
 S OCN=0,OCN=$O(^ORD(100.8,"B","DUPLICATE ORDER",OCN))
"RTN","ORKCHK5",130,0)
 Q:+$G(OCN)<1
"RTN","ORKCHK5",131,0)
 Q:$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",OCN,"I")="D"
"RTN","ORKCHK5",132,0)
 N ORKOR S ORKOR=0
"RTN","ORKCHK5",133,0)
 D DUP^ORKOR(.ORKOR,ORKDFN,OI,ODT,ORKDG) I (ORKOR>0) D
"RTN","ORKCHK5",134,0)
 .S ORKOCNUM=+$P(ORKOR,U)
"RTN","ORKCHK5",135,0)
 .S DNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",OCN,"I")
"RTN","ORKCHK5",136,0)
 .S ORKMSG="Duplicate order: "_$P(ORKOR,U,2)
"RTN","ORKCHK5",137,0)
 .S ORKS("ORK",DNGR_","_$G(ORNUM)_","_ORKOCNUM_","_$E(ORKMSG,1,225))=ORNUM_U_OCN_U_DNGR_U_ORKMSG_U_ORKOCNUM
"RTN","ORKCHK5",138,0)
 Q
"RTN","ORKCHK5",139,0)
 ;
"RTN","ORKCHK5",140,0)
DUPLAB ;duplicate laboratory orders:
"RTN","ORKCHK5",141,0)
 N ORKLR,OCI
"RTN","ORKCHK5",142,0)
 S ORKLR=0,OCI=""
"RTN","ORKCHK5",143,0)
 S OCN=0,OCN=$O(^ORD(100.8,"B","DUPLICATE ORDER",OCN))
"RTN","ORKCHK5",144,0)
 Q:+$G(OCN)<1
"RTN","ORKCHK5",145,0)
 Q:$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",OCN,"I")="D"
"RTN","ORKCHK5",146,0)
 S DNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",OCN,"I")
"RTN","ORKCHK5",147,0)
 D DUP^ORKLR(.ORKLR,OI,ORKDFN,ODT,ORKPDATA)
"RTN","ORKCHK5",148,0)
 F  S OCI=$O(ORKLR(OCI)) Q:OCI=""  D
"RTN","ORKCHK5",149,0)
 .S ORKOCNUM=+$P(ORKLR(OCI),U)
"RTN","ORKCHK5",150,0)
 .S ORKMSG="Duplicate order: "_$P(ORKLR(OCI),U,2)
"RTN","ORKCHK5",151,0)
 .S ORKS("ORK",DNGR_","_$G(ORNUM)_","_ORKOCNUM_","_$E(ORKMSG,1,225))=ORNUM_U_OCN_U_DNGR_U_ORKMSG_U_ORKOCNUM
"RTN","ORKCHK5",152,0)
 Q
"RTN","ORKCHK5",153,0)
 ;
"RTN","ORKCHK5",154,0)
LABFREQ ;lab order frequency restrictions:
"RTN","ORKCHK5",155,0)
 N ORKLR,OCI
"RTN","ORKCHK5",156,0)
 S ORKLR=0,OCI=""
"RTN","ORKCHK5",157,0)
 S OCN=0,OCN=$O(^ORD(100.8,"B","LAB ORDER FREQ RESTRICTIONS",OCN))
"RTN","ORKCHK5",158,0)
 Q:+$G(OCN)<1
"RTN","ORKCHK5",159,0)
 Q:$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",OCN,"I")="D"
"RTN","ORKCHK5",160,0)
 S DNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",OCN,"I")
"RTN","ORKCHK5",161,0)
 D ORFREQ^ORKLR2(.ORKLR,OI,ORKDFN_";DPT(",ODT,ORKPDATA)
"RTN","ORKCHK5",162,0)
 S OCI="" F  S OCI=$O(ORKLR(OCI)) Q:OCI=""  D
"RTN","ORKCHK5",163,0)
 .S ORKMSG=$P(ORKLR(OCI),U,2)
"RTN","ORKCHK5",164,0)
 .S ORKS("ORK",DNGR_","_$G(ORNUM)_","_$E(ORKMSG,1,225))=ORNUM_U_OCN_U_DNGR_U_ORKMSG
"RTN","ORKCHK5",165,0)
 Q
"RTN","ORKCHK5",166,0)
 ;
"RTN","ORKCHK5",167,0)
PARAMS(ORKNAME,ORKNUM,ORKFLAG,ORKDNGR) ; get parameter values for an order chk
"RTN","ORKCHK5",168,0)
 S ORKNUM=0,ORKNUM=$O(^ORD(100.8,"B",ORKNAME,ORKNUM))
"RTN","ORKCHK5",169,0)
 S ORKFLAG=$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",ORKNUM,"I")
"RTN","ORKCHK5",170,0)
 S ORKDNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",ORKNUM,"I")
"RTN","ORKCHK5",171,0)
 Q
"RTN","ORKCHK5",172,0)
REMCHK(ORRET,OROI,ORDFN) ; DO REMINDER ORDER CHECKS
"RTN","ORKCHK5",173,0)
 ;
"RTN","ORKCHK5",174,0)
 N ORKGLOB S ORKGLOB=$H
"RTN","ORKCHK5",175,0)
 ;order check for TEST OC for this OI
"RTN","ORKCHK5",176,0)
 N ORKNUM,ORKFLAG,ORKDNGR
"RTN","ORKCHK5",177,0)
 D PARAMS("CLINICAL REMINDER TEST",.ORKNUM,.ORKFLAG,.ORKDNGR)
"RTN","ORKCHK5",178,0)
 I ORKFLAG'="D" D
"RTN","ORKCHK5",179,0)
 .D ORDERCHK^PXRMORCH(ORDFN,OROI,1,0,0)
"RTN","ORKCHK5",180,0)
 .Q:'$D(^TMP($J,OROI))
"RTN","ORKCHK5",181,0)
 .N ORCDL S ORCDL="" F  S ORCDL=$O(^TMP($J,OROI,ORCDL)) Q:'$L(ORCDL)  S ORKDNGR=$S(ORCDL="H":1,ORCDL="M":2,1:3) D
"RTN","ORKCHK5",182,0)
 ..N ORRULE S ORRULE="" F  S ORRULE=$O(^TMP($J,OROI,ORCDL,ORRULE)) Q:'$L(ORRULE)  D
"RTN","ORKCHK5",183,0)
 ...S ORRET("ORK",ORCDL_","_$G(ORNUM)_","_ORKNUM_","_ORRULE)=ORNUM_U_ORKNUM_U_ORCDL_U_"||"_ORKGLOB_"&"_ORRULE
"RTN","ORKCHK5",184,0)
 ...M ^TMP($J,"ORK XTRA TXT",ORKGLOB,ORRULE)=^TMP($J,OROI,ORCDL,ORRULE)
"RTN","ORKCHK5",185,0)
 .K ^TMP($J,OROI)
"RTN","ORKCHK5",186,0)
 ;order checks for LIVE OC for this OI
"RTN","ORKCHK5",187,0)
 K ORKNUM,ORKFLAG,ORKDNGR
"RTN","ORKCHK5",188,0)
 D PARAMS("CLINICAL REMINDER LIVE",.ORKNUM,.ORKFLAG,.ORKDNGR)
"RTN","ORKCHK5",189,0)
 Q:ORKFLAG="D"
"RTN","ORKCHK5",190,0)
 D ORDERCHK^PXRMORCH(ORDFN,OROI,0,0,0)
"RTN","ORKCHK5",191,0)
 Q:'$D(^TMP($J,OROI))
"RTN","ORKCHK5",192,0)
 N ORCDL S ORCDL="" F  S ORCDL=$O(^TMP($J,OROI,ORCDL)) Q:'$L(ORCDL)  S ORKDNGR=$S(ORCDL="H":1,ORCDL="M":2,1:3) D
"RTN","ORKCHK5",193,0)
 .N ORRULE S ORRULE="" F  S ORRULE=$O(^TMP($J,OROI,ORCDL,ORRULE)) Q:'$L(ORRULE)  D
"RTN","ORKCHK5",194,0)
 ..S ORRET("ORK",ORCDL_","_$G(ORNUM)_","_ORKNUM_","_ORRULE)=ORNUM_U_ORKNUM_U_ORCDL_U_"||"_ORKGLOB_"&"_ORRULE
"RTN","ORKCHK5",195,0)
 ..M ^TMP($J,"ORK XTRA TXT",ORKGLOB,ORRULE)=^TMP($J,OROI,ORCDL,ORRULE)
"RTN","ORKCHK5",196,0)
 K ^TMP($J,OROI)
"RTN","ORKCHK5",197,0)
 Q
"RTN","ORKCHK5",198,0)
 ;
"RTN","ORKCHK5",199,0)
DSGCHK(ORRET,ORDFN,OROIL,ORKA) ;DO DOSAGE ORDER CHECKS
"RTN","ORKCHK5",200,0)
 Q:'$$PATCH^XPDUTL("PSS*1.0*117")
"RTN","ORKCHK5",201,0)
 Q:$G(XQY0)="OR BCMA ORDER COM"
"RTN","ORKCHK5",202,0)
 N ORTYPE,ORY,ORI,ORKNUM,ORKFLAG,ORKDNGR
"RTN","ORKCHK5",203,0)
 D PARAMS("DRUG DOSAGE",.ORKNUM,.ORKFLAG,.ORKDNGR)
"RTN","ORKCHK5",204,0)
 Q:ORKFLAG="D"  ;this checks if the order check is turned on or not
"RTN","ORKCHK5",205,0)
 I '$$DS^PSSDSAPI D  Q
"RTN","ORKCHK5",206,0)
 .N ORDWNMSG S ORDWNMSG=$$DSDWNMSG^ORDSGCHK
"RTN","ORKCHK5",207,0)
 .S ORRET("ORK",ORKDNGR_","_$G(ORNUM)_","_ORDWNMSG)=ORNUM_U_25_U_2_ORDWNMSG
"RTN","ORKCHK5",208,0)
 S ORTYPE=$P(ORKA,"|",2)
"RTN","ORKCHK5",209,0)
 D EN^ORDSGCHK(.ORY,ORDFN,ORTYPE,.OROIL)
"RTN","ORKCHK5",210,0)
 N ORI S ORI=0 F  S ORI=$O(ORY(ORI)) Q:'ORI  D
"RTN","ORKCHK5",211,0)
 .N ORIPAD S ORIPAD=$$PAD^ORUTL(ORI,3)_ORI
"RTN","ORKCHK5",212,0)
 .I $P(ORY(ORI),U)="ERR" S ORRET("ORK",ORKDNGR_","_$G(ORNUM)_","_ORIPAD_","_$E($P(ORY(ORI),U,2),1,225))=ORNUM_U_25_U_3_U_$P(ORY(ORI),U,2)
"RTN","ORKCHK5",213,0)
 .I $P(ORY(ORI),U)="DS" S ORRET("ORK",ORKDNGR_","_$G(ORNUM)_","_ORIPAD_","_$E($P(ORY(ORI),U,2),1,225))=ORNUM_U_ORKNUM_U_ORKDNGR_U_$P(ORY(ORI),U,2)
"RTN","ORKCHK5",214,0)
 .I $P(ORY(ORI),U)="INFO" S ORRET("ORK",ORKDNGR_","_$G(ORNUM)_","_ORIPAD_","_$E($P(ORY(ORI),U,2),1,225))=ORNUM_U_ORKNUM_U_3_U_$P(ORY(ORI),U,2)
"RTN","ORKCHK5",215,0)
 Q
"RTN","ORKPS")
0^6^B115111476
"RTN","ORKPS",1,0)
ORKPS ; slc/CLA - Order checking support procedures for medications ;06/20/16  05:52
"RTN","ORKPS",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,94,123,141,190,232,316,272,346,345,382**;Dec 17, 1997;Build 15
"RTN","ORKPS",3,0)
 Q
"RTN","ORKPS",4,0)
CHECK(YY,DFN,MED,OI,ORKDG,OROIL,ORSUPPLY,ORIVTYPE,ORIVRAN,ORDODSG) ; return drug order checks
"RTN","ORKPS",5,0)
 ;YY:    returned array of data
"RTN","ORKPS",6,0)
 ;DFN:   patient id
"RTN","ORKPS",7,0)
 ;MED:   drug ien [file #50] ^ generic name [file #50]
"RTN","ORKPS",8,0)
 ;OI:    orderable item ien [file #101.43]
"RTN","ORKPS",9,0)
 ;ORKDG: display group (should be PSI, PSIV, PSO or PSH)
"RTN","ORKPS",10,0)
 ;OROIL: list of items ordered
"RTN","ORKPS",11,0)
 ;ORSUPPLY: pharmacy orderable item ien [file #50.7] if it resolves to one or more supply items
"RTN","ORKPS",12,0)
 ;          0 if the pharmacy orderable item does not resolve to any supply items
"RTN","ORKPS",13,0)
 ;ORIVTYPE: the MED type as sent from Infusion Order Dialog
"RTN","ORKPS",14,0)
 ;          A for additive
"RTN","ORKPS",15,0)
 ;          B for base
"RTN","ORKPS",16,0)
 ;ORIVRAN: FLAG THAT DENOTES IF ALL COMPONENTS OF INFUSION ORDER HAVE ALREADY BEEN PROCESSED
"RTN","ORKPS",17,0)
 ;         1 FOR ALREADY PROCESSED
"RTN","ORKPS",18,0)
 ;         EMPTY STRING FOR NOT YET PROCESSED
"RTN","ORKPS",19,0)
 ;ORDODSG: FLAG THAT DENOTES IF DOSAGE CHECKS SHOULD BE PERFORMED
"RTN","ORKPS",20,0)
 ;         1 FOR PERFORM DOSAGE CHECKS
"RTN","ORKPS",21,0)
 ;         0 FOR DO NOT PERFORM DOSAGE CHECKS
"RTN","ORKPS",22,0)
 ; returned info: varies for ^TMP($J x-ref - refer to listings below
"RTN","ORKPS",23,0)
 N OR2CRITN,OR2CRITF,OR2CRITD,OR2SIGN,OR2SIGF,OR2SIGD,OR2DUPN,OR2DUPF,OR2DUPD,OR2DUPCN,OR2DUPCF,OR2DUPCD
"RTN","ORKPS",24,0)
 N ORPHDG,ORKSOIA,ORDOCHKS
"RTN","ORKPS",25,0)
 D PARAMS^ORKCHK6("CRITICAL DRUG INTERACTION",.OR2CRITN,.OR2CRITF,.OR2CRITD)
"RTN","ORKPS",26,0)
 D PARAMS^ORKCHK6("SIGNIFICANT DRUG INTERACTION",.OR2SIGN,.OR2SIGF,.OR2SIGD)
"RTN","ORKPS",27,0)
 D PARAMS^ORKCHK6("DUPLICATE DRUG THERAPY",.OR2DUPCN,.OR2DUPCF,.OR2DUPCD)
"RTN","ORKPS",28,0)
 N ORDFN,ORKA,ORPTY,ORPHOI,OROILI,ORKAI S ORDFN=DFN
"RTN","ORKPS",29,0)
 S ORPHOI=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORKPS",30,0)
 S ORPTY=$S($G(ORKDG)="PSI":"I;",$G(ORKDG)="PSIV":"I;",$G(ORKDG)="PSO":"O;",$G(ORKDG)="PSH":"O;",1:"O;")
"RTN","ORKPS",31,0)
 S ORPHDG=$S(ORKDG="PSI":"U",ORKDG="PSIV":"I",ORKDG="PSO":"O",ORKDG="PSH":"N",1:"")
"RTN","ORKPS",32,0)
 I $G(ORIVTYPE)'="A" D  Q:'ORDOCHKS  ; Don't do checks if pharmacy does not want us to
"RTN","ORKPS",33,0)
 .S ORDOCHKS=$$PRE^PSSDSAPK(ORPHOI,ORPHDG)
"RTN","ORKPS",34,0)
 .S:'ORDODSG ORDODSG=ORDOCHKS
"RTN","ORKPS",35,0)
 S:$G(ORIVTYPE)="A" ORDODSG=1
"RTN","ORKPS",36,0)
 I +MED,('ORIVRAN) S ORKA(1)=MED_U_$$GETPSNM(+MED),ORKAI=1
"RTN","ORKPS",37,0)
 ;ADD ALL COMPONENTS OF IV ORDER SO WE ONLY HAVE TO DO A SINGLE PRE CALL
"RTN","ORKPS",38,0)
 I ORKDG="PSIV",('ORIVRAN) D
"RTN","ORKPS",39,0)
 .S ORIVRAN=1,OROILI=0 F  S OROILI=$O(OROIL(OROILI)) Q:'OROILI  D
"RTN","ORKPS",40,0)
 ..N OR2OI,OR2PSOI,OR2PHDG
"RTN","ORKPS",41,0)
 ..I 'OROIL(OROILI) Q
"RTN","ORKPS",42,0)
 ..I +OROIL(OROILI)=OI Q
"RTN","ORKPS",43,0)
 ..S OR2OI=+OROIL(OROILI)
"RTN","ORKPS",44,0)
 ..S OR2PSOI=+$P($G(^ORD(101.43,+OR2OI,0)),U,2)
"RTN","ORKPS",45,0)
 ..S OR2PHDG=$P(OROIL(OROILI),U,2)
"RTN","ORKPS",46,0)
 ..S OR2PHDG=$S(OR2PHDG="PSI":"U",OR2PHDG="PSIV":"I",OR2PHDG="PSO":"O",OR2PHDG="PSH":"N",1:"")
"RTN","ORKPS",47,0)
 ..Q:OR2PHDG'="I"
"RTN","ORKPS",48,0)
 ..I $P($P(OROIL(OROILI),U,3),";")="B",$$PRE^PSSDSAPK(OR2PSOI,OR2PHDG)=0 Q
"RTN","ORKPS",49,0)
 ..I $P($P(OROIL(OROILI),U,3),";")="B",$P($P(OROIL(OROILI),U,3),";",2)="",$G(ORREN)=1 D
"RTN","ORKPS",50,0)
 ...N ORVOLID,ORVOLVAL S ORVOLVAL="",ORVOLID=$O(^OR(100,+$G(ORIFN),4.5,"ID","VOLUME",""))
"RTN","ORKPS",51,0)
 ...I ORVOLID>0 S ORVOLVAL=$G(^OR(100,+$G(ORIFN),4.5,ORVOLID,1))
"RTN","ORKPS",52,0)
 ...S OROIL(OROILI)=OROIL(OROILI)_ORVOLVAL
"RTN","ORKPS",53,0)
 ..N ORUSID
"RTN","ORKPS",54,0)
 ..S ORUSID=$$USID^ORWDXC(OROIL(OROILI))
"RTN","ORKPS",55,0)
 ..S ORKAI=ORKAI+1,ORKA(ORKAI)=$P(ORUSID,U,4)_U_$$GETPSNM($P(ORUSID,U,4))
"RTN","ORKPS",56,0)
 D:$D(ORKA) CPRS^PSODDPR4(ORDFN,"OROCOUT"_ORPTY,.ORKA,ORPTY_+$G(^OR(100,+$G(ORIFN),4)))
"RTN","ORKPS",57,0)
 I +ORSUPPLY D
"RTN","ORKPS",58,0)
 .S ORKSOIA(+ORSUPPLY)=""
"RTN","ORKPS",59,0)
 .D CPRS^PSODDPR8(ORDFN,"OROCOUT"_ORPTY,.ORKSOIA,ORPHDG_";"_+$G(^OR(100,+$G(ORNUM),4)),$S($D(ORKA):1,1:""))
"RTN","ORKPS",60,0)
 I $D(ORKA)!($D(ORKSOIA))!(ORIVRAN) D
"RTN","ORKPS",61,0)
 .S:OR2CRITF_OR2SIGF_OR2DUPCF["E" ^TMP($J,"ORENHCHK")=1
"RTN","ORKPS",62,0)
 .D PROCESS^ORKPS1(OI,ORDFN,ORKDG,+ORSUPPLY_U_+MED,"OROCOUT"_ORPTY)
"RTN","ORKPS",63,0)
 Q
"RTN","ORKPS",64,0)
CHKSESS(YY,DFN,MED,OI,ORKPDATA,ORKDG,ORSUPPLY,ORIVTYPE) ; return drug order checks for session
"RTN","ORKPS",65,0)
 ;ORSUPPLY: pharmacy orderable item ien [file #50.7] if it resolves to one or more supply items
"RTN","ORKPS",66,0)
 ;          0 if the pharmacy orderable item does not resolve to any supply items
"RTN","ORKPS",67,0)
 ;ORIVTYPE: the MED type as sent from Infusion Order Dialog
"RTN","ORKPS",68,0)
 ;          A for additive
"RTN","ORKPS",69,0)
 ;          B for base
"RTN","ORKPS",70,0)
 N ORKDGI,ORKDRUG,ORKDRUGA,ORKORN,HOR,SEQ,CNT,CNTX,ORKOI,ORPHOI
"RTN","ORKPS",71,0)
 N ORKFLG,ORSESS,ORPSPKG,ORPSA,ORSNUM,ORNUM,DUPX,DUPORN,ORPTY
"RTN","ORKPS",72,0)
 N ORKSOIA,ORRET,ORDFN,ORPHDG S ORDFN=DFN
"RTN","ORKPS",73,0)
 S ORPTY=$S($G(ORKDG)="PSI":"I;",$G(ORKDG)="PSIV":"I;",$G(ORKDG)="PSO":"O;",$G(ORKDG)="PSH":"O;",1:"O;")
"RTN","ORKPS",74,0)
 S ORPHDG=$S(ORKDG="PSI":"U",ORKDG="PSIV":"I",ORKDG="PSO":"O",ORKDG="PSH":"N",1:"")
"RTN","ORKPS",75,0)
 I '$D(^TMP($J,"OROCOUT"_ORPTY)) D
"RTN","ORKPS",76,0)
 .S ORKFLG=0
"RTN","ORKPS",77,0)
 .S ORNUM=$P(ORKA,"|",5)
"RTN","ORKPS",78,0)
 .S ORPHOI=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORKPS",79,0)
 .I $G(ORIVTYPE)'="A",'$$PRE^PSSDSAPK(ORPHOI,ORPHDG) Q  ; Don't do checks if pharmacy does not want us to
"RTN","ORKPS",80,0)
 .;get other session med orders:
"RTN","ORKPS",81,0)
 .I $D(^TMP("ORKA",$J)) D
"RTN","ORKPS",82,0)
 ..S CNT=^TMP("ORKA",$J) F CNTX=1:1:CNT D
"RTN","ORKPS",83,0)
 ...N ORPHOI2,ORPHDG2
"RTN","ORKPS",84,0)
 ...S ORSESS=$G(^TMP("ORKA",$J,CNTX))
"RTN","ORKPS",85,0)
 ...Q:'$L(ORSESS)
"RTN","ORKPS",86,0)
 ...S ORPSPKG=$P(ORSESS,"|",2)
"RTN","ORKPS",87,0)
 ...Q:'$L(ORPSPKG)
"RTN","ORKPS",88,0)
 ...Q:$E(ORPSPKG,1,2)'="PS"
"RTN","ORKPS",89,0)
 ...S ORSNUM=$P(ORSESS,"|",5)
"RTN","ORKPS",90,0)
 ...S ORKOI=$P(ORSESS,"|")
"RTN","ORKPS",91,0)
 ...S ORPHOI2=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORKPS",92,0)
 ...S ORPHDG2=$S(ORPSPKG="PSI":"U",ORPSPKG="PSIV":"I",ORPSPKG="PSO":"O",ORPSPKG="PSH":"N",1:"")
"RTN","ORKPS",93,0)
 ...I ORPSPKG="PSIV",$P($P(ORSESS,U,6),"|",5)="B",'$$PRE^PSSDSAPK(ORPHOI2,ORPHDG2) Q
"RTN","ORKPS",94,0)
 ...;quit if same order/oi:
"RTN","ORKPS",95,0)
 ...Q:((+$G(ORNUM)=+$G(ORSNUM))&(+$G(OI)=+$G(ORKOI)))
"RTN","ORKPS",96,0)
 ...S:ORPSPKG="PSJ" ORPSPKG="PSI"
"RTN","ORKPS",97,0)
 ...S ORKDRUG=$P($P(ORSESS,"|",3),U,4)
"RTN","ORKPS",98,0)
 ...;if no disp drug selected get disp drug(s) from OI:
"RTN","ORKPS",99,0)
 ...I +$G(ORKDRUG)<1,$L(ORKOI),"IOH"[$E(ORPSPKG,3) D
"RTN","ORKPS",100,0)
 ....S ORRET=$$OI2DD(ORKOI,$E(ORPSPKG,3),1)
"RTN","ORKPS",101,0)
 ....I +$P(ORRET,";",4) S ORKSOIA(+$P(ORRET,";",4))=""
"RTN","ORKPS",102,0)
 ....I +ORRET S ORKDRUG=+ORRET
"RTN","ORKPS",103,0)
 ...Q:+$G(ORKDRUG)<1
"RTN","ORKPS",104,0)
 ...;if dispense drug selected add to array:
"RTN","ORKPS",105,0)
 ...S ORKDRUGA(ORKDRUG_";"_ORPSPKG_";"_ORSNUM)=ORSNUM_U_$$GETPSNM(+ORKDRUG)
"RTN","ORKPS",106,0)
 .;get unsigned medication orders:
"RTN","ORKPS",107,0)
 .S HOR=0,SEQ=0
"RTN","ORKPS",108,0)
 .S HOR=$O(^TMP("ORR",$J,HOR))
"RTN","ORKPS",109,0)
 .I +$G(HOR)>0 D
"RTN","ORKPS",110,0)
 ..F  S SEQ=$O(^TMP("ORR",$J,HOR,SEQ)) Q:+SEQ<1  D
"RTN","ORKPS",111,0)
 ...S ORKORN=+$P(^TMP("ORR",$J,HOR,SEQ),U),DUPORN=0
"RTN","ORKPS",112,0)
 ...Q:+$G(ORKORN)<1
"RTN","ORKPS",113,0)
 ...Q:+ORKORN=+ORNUM
"RTN","ORKPS",114,0)
 ...Q:$P(^OR(100,+ORKORN,8,$P(^OR(100,+ORKORN,8,0),U,3),0),U,2)="DC"
"RTN","ORKPS",115,0)
 ...Q:$P(^ORD(100.01,$P(^OR(100,+ORKORN,3),U,3),0),U)="DISCONTINUED"
"RTN","ORKPS",116,0)
 ...S ORKDRUG=$$VALUE^ORCSAVE2(+ORKORN,"DRUG") ;get disp drug for order
"RTN","ORKPS",117,0)
 ...S ORPSPKG=$$DGRX^ORQOR2(+ORKORN)
"RTN","ORKPS",118,0)
 ...S ORPSPKG=$S(ORPSPKG="UNIT DOSE MEDICATIONS":"PSI",ORPSPKG="OUTPATIENT MEDICATIONS":"PSO",ORPSPKG="IV MEDICATIONS":"PSIV",ORPSPKG="NON-VA MEDICATIONS":"PSH",1:"")
"RTN","ORKPS",119,0)
 ...S DUPX="" F  S DUPX=$O(ORKDRUGA(DUPX)) Q:'DUPX!(DUPORN=1)  D
"RTN","ORKPS",120,0)
 ....S:ORKORN=ORKDRUGA(DUPX) DUPORN=1
"RTN","ORKPS",121,0)
 ...Q:DUPORN=1  ;quit if already processed drug order
"RTN","ORKPS",122,0)
 ...I +$G(ORKDRUG)<1,$L(ORPSPKG)>0 D
"RTN","ORKPS",123,0)
 ....N OROI S OROI=$$OI^ORX8(+ORKORN)
"RTN","ORKPS",124,0)
 ....S ORRET=$$OI2DD(+OROI,$S($G(ORKDG)="PSI":"I",$G(ORKDG)="PSIV":"I",$G(ORKDG)="PSO":"O",$G(ORKDG)="PSH":"O",1:"O"),1)
"RTN","ORKPS",125,0)
 ....I +$P(ORRET,";",4) S ORKSOIA(+$P(ORRET,";",4))=""
"RTN","ORKPS",126,0)
 ....I +ORRET S ORKDRUG=+ORRET
"RTN","ORKPS",127,0)
 ...;only process vs. unsigned med order if disp drug is assoc w/order:
"RTN","ORKPS",128,0)
 ...Q:+$G(ORKDRUG)<1
"RTN","ORKPS",129,0)
 ...I ORPSPKG="PSIV" D
"RTN","ORKPS",130,0)
 ....;loop through each OI in the IV order
"RTN","ORKPS",131,0)
 ....N OR2I
"RTN","ORKPS",132,0)
 ....S OR2I=0 F  S OR2I=$O(^OR(100,+ORKORN,4.5,"ID","ORDERABLE",OR2I)) Q:'OR2I  D
"RTN","ORKPS",133,0)
 .....N OR2OI,OR2DRUG
"RTN","ORKPS",134,0)
 .....S OR2OI=$G(^OR(100,+ORKORN,4.5,OR2I,1))
"RTN","ORKPS",135,0)
 .....Q:'OR2OI
"RTN","ORKPS",136,0)
 .....;get the drug for each OI
"RTN","ORKPS",137,0)
 .....S OR2DRUG=$$OI2DD(+OR2OI,"I",1)
"RTN","ORKPS",138,0)
 .....;check if drug should be add it and add it if so
"RTN","ORKPS",139,0)
 .....I $$IVADD(OR2DRUG,OR2OI) S ORKDRUGA(+OR2DRUG_";"_ORPSPKG_";"_ORKORN)=ORKORN_U_$$GETPSNM(+OR2DRUG)
"RTN","ORKPS",140,0)
 ...I ORPSPKG'="PSIV" S ORKDRUGA(+ORKDRUG_";"_ORPSPKG_";"_ORKORN)=ORKORN_U_$$GETPSNM(+ORKDRUG)
"RTN","ORKPS",141,0)
 .N ORPROSP,CNT
"RTN","ORKPS",142,0)
 .S CNT=1
"RTN","ORKPS",143,0)
 .S:+MED ORPROSP(CNT)=MED_U_$$GETPSNM(+MED)_U_+$G(ORNUM),CNT=CNT+1
"RTN","ORKPS",144,0)
 .N I S I="" F  S I=$O(ORKDRUGA(I)) Q:'I  S ORPROSP(CNT)=+I_U_$P(ORKDRUGA(I),U,2)_U_$P(ORKDRUGA(I),U,1),CNT=CNT+1
"RTN","ORKPS",145,0)
 .D SHRNKPR
"RTN","ORKPS",146,0)
 .D CPRS^PSODDPR4(DFN,"OROCOUT"_ORPTY,.ORPROSP,ORPTY_+$G(^OR(100,+$G(ORNUM),4)))
"RTN","ORKPS",147,0)
 .S:+ORSUPPLY ORKSOIA(+ORSUPPLY)=""
"RTN","ORKPS",148,0)
 .D:$D(ORKSOIA)>9 CPRS^PSODDPR8(DFN,"OROCOUT"_ORPTY,.ORKSOIA,ORPHDG_";"_+$G(^OR(100,+$G(ORNUM),4)),1)
"RTN","ORKPS",149,0)
 D PROCESS^ORKPS1(OI,ORDFN,ORKDG,+ORSUPPLY_U_+MED,"OROCOUT"_ORPTY)
"RTN","ORKPS",150,0)
 Q
"RTN","ORKPS",151,0)
IVADD(ORDRUG,OROI) ;RETURN YES OR NO IF SHOULD ADD THE IV ITEM
"RTN","ORKPS",152,0)
 N ORRET
"RTN","ORKPS",153,0)
 ;default is yes to add it, will always be 1 for an additive
"RTN","ORKPS",154,0)
 S ORRET=1
"RTN","ORKPS",155,0)
 ;check if drug is a base
"RTN","ORKPS",156,0)
 K ^TMP($J,"ORBASECHECK")
"RTN","ORKPS",157,0)
 D DRGIEN^PSS52P7(ORDRUG,,"ORBASECHECK")
"RTN","ORKPS",158,0)
 I $P($G(^TMP($J,"ORBASECHECK",0),0),U)>0 D  ;GOT A BASE HERE
"RTN","ORKPS",159,0)
 .;if drug is a base, check if pharmacy says we can add it or not
"RTN","ORKPS",160,0)
 .N ORPHOI
"RTN","ORKPS",161,0)
 .S ORPHOI=+$P($G(^ORD(101.43,+OROI,0)),U,2)
"RTN","ORKPS",162,0)
 .S ORRET=$$PRE^PSSDSAPK(ORPHOI,"I")
"RTN","ORKPS",163,0)
 K ^TMP($J,"ORBASECHECK")
"RTN","ORKPS",164,0)
 Q ORRET
"RTN","ORKPS",165,0)
SHRNKPR ;REMOVE DUPLICATS FROM PROSPECTIVE LIST
"RTN","ORKPS",166,0)
 Q:'$D(ORPROSP)
"RTN","ORKPS",167,0)
 N ORX,ORI S ORI=0 F  S ORI=$O(ORPROSP(ORI)) Q:'ORI  S ORX=ORPROSP(ORI) D
"RTN","ORKPS",168,0)
 .N ORJ S ORJ=ORI F  S ORJ=$O(ORPROSP(ORJ)) Q:'ORJ  I ORX=ORPROSP(ORJ) K ORPROSP(ORJ)
"RTN","ORKPS",169,0)
 Q
"RTN","ORKPS",170,0)
GETPSNM(ORIEN) ;GET THE FILE 50 .01 FIELD FROM A FILE 50 IEN
"RTN","ORKPS",171,0)
 N RET K ^TMP($J,"ORRETNM")
"RTN","ORKPS",172,0)
 D NDF^PSS50(ORIEN,,,,,"ORRETNM") S RET=$G(^TMP($J,"ORRETNM",ORIEN,.01))
"RTN","ORKPS",173,0)
 K ^TMP($J,"ORRETNM")
"RTN","ORKPS",174,0)
 Q RET
"RTN","ORKPS",175,0)
TAKEMED(ORKDFN,ORKMED) ;extrinsic function returns med orderable item if any
"RTN","ORKPS",176,0)
 ;active med patient is taking contains any piece of ORKMED
"RTN","ORKPS",177,0)
 ;ORKDFN   patient DFN
"RTN","ORKPS",178,0)
 ;ORKMED   meds to check vs. active med list in format MED1^MED2^MED3...
"RTN","ORKPS",179,0)
 Q:'$L($G(ORKDFN)) "0^Patient not identified."
"RTN","ORKPS",180,0)
 Q:'$L($G(ORKMED)) "0^Medication not identified."
"RTN","ORKPS",181,0)
 N ORKARX,ORKY,ORI,ORJ,ORCNT,ORKMEDP,ORKRSLT
"RTN","ORKPS",182,0)
 D LIST^ORQQPS(.ORKY,ORKDFN,"","")
"RTN","ORKPS",183,0)
 Q:$P(ORKY(1),U)="" "0^No active meds found."
"RTN","ORKPS",184,0)
 S ORKRSLT="0^No matching meds found."
"RTN","ORKPS",185,0)
 S ORCNT=$L(ORKMED,U)
"RTN","ORKPS",186,0)
 S ORI=0 F  S ORI=$O(ORKY(ORI)) Q:ORI<1  D
"RTN","ORKPS",187,0)
 .S ORKARX=$P(ORKY(ORI),U,2)
"RTN","ORKPS",188,0)
 .F ORJ=1:1:ORCNT S ORKMEDP=$P(ORKMED,U,ORJ) D
"RTN","ORKPS",189,0)
 ..I $L(ORKMEDP),($$UP^XLFSTR(ORKARX)[ORKMEDP) S ORKRSLT="1^"_ORKARX ;DJE/VM *316 use uppercase in comparison
"RTN","ORKPS",190,0)
 Q ORKRSLT
"RTN","ORKPS",191,0)
POLYRX(DFN) ;extrins funct rtns 1 if patient exceeds polypharmacy, 0 if not
"RTN","ORKPS",192,0)
 N ORSLT,ORENT,ORLOC,ORPAR,ORMEDS
"RTN","ORKPS",193,0)
 S ORSLT=0
"RTN","ORKPS",194,0)
 Q:'$L(DFN) ORSLT
"RTN","ORKPS",195,0)
 S VA200="" D OERR^VADPT
"RTN","ORKPS",196,0)
 S ORLOC=+$G(^DIC(42,+VAIN(4),44))
"RTN","ORKPS",197,0)
 K VA200,VAIN
"RTN","ORKPS",198,0)
 S ORENT=+$G(ORLOC)_";SC(^DIV^SYS^PKG"
"RTN","ORKPS",199,0)
 S ORPAR=$$GET^XPAR(ORENT,"ORK POLYPHARMACY",1,"I")
"RTN","ORKPS",200,0)
 S ORMEDS=$$NUMRX(DFN)
"RTN","ORKPS",201,0)
 I $G(ORMEDS)>$G(ORPAR) S ORSLT=1
"RTN","ORKPS",202,0)
 Q ORSLT
"RTN","ORKPS",203,0)
GLCREAT(DFN) ;extrinsic function returns patient's (DFN) most recent serum
"RTN","ORKPS",204,0)
 ; creatinine within # of days from parameter ORK GLUCOPHAGE CREATININE
"RTN","ORKPS",205,0)
 ; results format: test id^result units flag ref range collect d/t^result
"RTN","ORKPS",206,0)
 ; used by order check GLUCOPHAGE-LAB RESULTS
"RTN","ORKPS",207,0)
 N ORLOC,ORPAR,ORDAYS
"RTN","ORKPS",208,0)
 N BDT,CDT,ORY,ORX,ORZ,TEST,ORI,ORJ,CREARSLT,LABFILE,SPECFILE,SPECIMEN,VAIN,VADM,RSLTS
"RTN","ORKPS",209,0)
 Q:'$L(DFN) "0^"
"RTN","ORKPS",210,0)
 S ORDAYS=$$GCDAYS(DFN)
"RTN","ORKPS",211,0)
 Q:'$L(ORDAYS) "0^"
"RTN","ORKPS",212,0)
 D NOW^%DTC
"RTN","ORKPS",213,0)
 S BDT=$$FMADD^XLFDT(%,"-"_ORDAYS,"","","")
"RTN","ORKPS",214,0)
 K %
"RTN","ORKPS",215,0)
 Q:'$L($G(BDT)) "0^"
"RTN","ORKPS",216,0)
 S LABFILE=$$TERMLKUP^ORB31(.ORY,"SERUM CREATININE")
"RTN","ORKPS",217,0)
 Q:'$D(ORY) "0^" ;no link between SERUM CREATININE and local lab test
"RTN","ORKPS",218,0)
 Q:$G(LABFILE)'=60 "0^"
"RTN","ORKPS",219,0)
 S SPECFILE=$$TERMLKUP^ORB31(.ORX,"SERUM SPECIMEN")
"RTN","ORKPS",220,0)
 Q:'$D(ORX) "0^" ;no link between SERUM SPECIMEN and local specimen
"RTN","ORKPS",221,0)
 Q:$G(SPECFILE)'=61 "0^"
"RTN","ORKPS",222,0)
 F ORI=1:1:ORY D
"RTN","ORKPS",223,0)
 .S TEST=$P(ORY(ORI),U)
"RTN","ORKPS",224,0)
 .Q:+$G(TEST)<1
"RTN","ORKPS",225,0)
 .F ORJ=1:1:ORX D
"RTN","ORKPS",226,0)
 ..S SPECIMEN=$P(ORX(ORJ),U)
"RTN","ORKPS",227,0)
 ..Q:+$G(SPECIMEN)<1
"RTN","ORKPS",228,0)
 ..S ORZ=$$LOCL^ORQQLR1(DFN,TEST,SPECIMEN)
"RTN","ORKPS",229,0)
 ..Q:'$L($G(ORZ))
"RTN","ORKPS",230,0)
 ..S CDT=$P(ORZ,U,7)
"RTN","ORKPS",231,0)
 ..I CDT'<BDT S RSLTS(CDT)=ORZ,CREARSLT=1  ;*SMT Use RSLTS as array.
"RTN","ORKPS",232,0)
 Q:+$G(CREARSLT)<1 "0^"
"RTN","ORKPS",233,0)
 S CDT=$O(RSLTS(0)),ORZ=RSLTS(CDT)  ;*SMT
"RTN","ORKPS",234,0)
 Q $P(ORZ,U)_U_$P(ORZ,U,3)_" "_$P(ORZ,U,4)_" "_$P(ORZ,U,5)_" ("_$P(ORZ,U,6)_")  "_$$FMTE^XLFDT(CDT,"2P")_U_$P(ORZ,U,3)
"RTN","ORKPS",235,0)
GCDAYS(DFN) ;extrinsic function to return number of days to look for
"RTN","ORKPS",236,0)
 ; glucophage serum creatinine result
"RTN","ORKPS",237,0)
 Q:'$L(DFN) ""
"RTN","ORKPS",238,0)
 N ORLOC,ORENT,ORDAYS
"RTN","ORKPS",239,0)
 ;get patient's location flag (INPATIENT ONLY - outpt locations cannot be
"RTN","ORKPS",240,0)
 ;reliably determined, and many simultaneous outpt locations can occur):
"RTN","ORKPS",241,0)
 S VA200="" D OERR^VADPT
"RTN","ORKPS",242,0)
 S ORLOC=+$G(^DIC(42,+VAIN(4),44))
"RTN","ORKPS",243,0)
 K VA200,VAIN
"RTN","ORKPS",244,0)
 S ORENT=+$G(ORLOC)_";SC(^DIV^SYS^PKG"
"RTN","ORKPS",245,0)
 S ORDAYS=$$GET^XPAR(ORENT,"ORK GLUCOPHAGE CREATININE",1,"I")
"RTN","ORKPS",246,0)
 Q:$L(ORDAYS) ORDAYS
"RTN","ORKPS",247,0)
 Q ""
"RTN","ORKPS",248,0)
SUPPLY(OI) ;extrinsic function returns 1 (true) if the orderable item is
"RTN","ORKPS",249,0)
 ; a supply
"RTN","ORKPS",250,0)
 Q:+$G(OI)<1 ""
"RTN","ORKPS",251,0)
 N OITEXT
"RTN","ORKPS",252,0)
 S OITEXT=$G(^ORD(101.43,OI,0))
"RTN","ORKPS",253,0)
 Q:'$L(OITEXT) ""
"RTN","ORKPS",254,0)
 S OITEXT=$P(OITEXT,U)
"RTN","ORKPS",255,0)
 Q:$D(^ORD(101.43,"S.SPLY",OITEXT)) 1
"RTN","ORKPS",256,0)
 Q ""
"RTN","ORKPS",257,0)
NUMRX(DFN) ;extrinsic funct returns number of active meds patient is taking
"RTN","ORKPS",258,0)
 N NUMRX,ORPTYPE,ORX,ORY,ORS,ORNUM,ORPRENEW,VADMVT
"RTN","ORKPS",259,0)
 S NUMRX=0
"RTN","ORKPS",260,0)
 Q:+$G(DFN)<1 NUMRX
"RTN","ORKPS",261,0)
 ;check to determine if inpatient or outpatient:
"RTN","ORKPS",262,0)
 D ADM^VADPT2
"RTN","ORKPS",263,0)
 S ORPTYPE=$S(+$G(VADMVT)>0:"I",1:"O")
"RTN","ORKPS",264,0)
 K ^TMP("PS",$J)
"RTN","ORKPS",265,0)
 D OCL^PSOORRL(DFN,"","")  ;if no date range, returns active meds for pt
"RTN","ORKPS",266,0)
 N X
"RTN","ORKPS",267,0)
 S X=0
"RTN","ORKPS",268,0)
 F  S X=$O(^TMP("PS",$J,X)) Q:X<1  D
"RTN","ORKPS",269,0)
 .S ORX=$G(^TMP("PS",$J,X,0))
"RTN","ORKPS",270,0)
 .S ORY=$P(ORX,U)
"RTN","ORKPS",271,0)
 .S ORNUM=$P(ORX,U,8) ;order entry order number
"RTN","ORKPS",272,0)
 .S ORS=$P(ORX,U,9) ;medication status from pharmacy
"RTN","ORKPS",273,0)
 .S ORPRENEW=$P(ORX,U,14)  ;pending renewal flag (1: pending renewal)
"RTN","ORKPS",274,0)
 .Q:+ORX<1
"RTN","ORKPS",275,0)
 .Q:$P(ORY,";",2)'=ORPTYPE  ;quit if med is not pt type (inpt/outpt)
"RTN","ORKPS",276,0)
 .;quit if status is a non-active type:
"RTN","ORKPS",277,0)
 .Q:$G(ORS)="EXPIRED"
"RTN","ORKPS",278,0)
 .Q:$G(ORS)["DISCONTINUE"
"RTN","ORKPS",279,0)
 .Q:$G(ORS)="DELETED"
"RTN","ORKPS",280,0)
 .Q:+$G(ORPRENEW)>0
"RTN","ORKPS",281,0)
 .Q:$$SUPPLY($$OI^ORQOR2(ORNUM))=1  ;quit if a supply
"RTN","ORKPS",282,0)
 .S NUMRX=NUMRX+1
"RTN","ORKPS",283,0)
 K ^TMP("PS",$J)
"RTN","ORKPS",284,0)
 Q NUMRX
"RTN","ORKPS",285,0)
OI2DD(OROI,ORPSPKG,ORCHKTYP)       ;rtn dispense drugs for a PS OI
"RTN","ORKPS",286,0)
 ;ORCHKTYP: TYPE OF ORDER CHECK SYSTEM IS PERFORMING
"RTN","ORKPS",287,0)
 ;          1 FOR ENHANCED ORDER CHECKS
"RTN","ORKPS",288,0)
 ;          2 FOR DOSAGE ORDER CHECK
"RTN","ORKPS",289,0)
 N PSOI,ORRET
"RTN","ORKPS",290,0)
 Q:'$D(^ORD(101.43,OROI,0)) ""
"RTN","ORKPS",291,0)
 S PSOI=+$P(^ORD(101.43,OROI,0),U,2)
"RTN","ORKPS",292,0)
 Q:PSOI<1 ""
"RTN","ORKPS",293,0)
 S:ORPSPKG="H" ORPSPKG="X"  ;if non-va med need to pass api "X"
"RTN","ORKPS",294,0)
 S ORRET=$$DRG^PSSDSAPM(PSOI,ORPSPKG,ORCHKTYP)
"RTN","ORKPS",295,0)
 I ORCHKTYP=1,(+$P(ORRET,";",4)) S $P(ORRET,";",4)=PSOI
"RTN","ORKPS",296,0)
 Q ORRET
"RTN","ORMPS1")
0^7^B71534901
"RTN","ORMPS1",1,0)
ORMPS1 ;SLC/MKB - Process Pharmacy ORM msgs cont ;06/20/16  05:55
"RTN","ORMPS1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**86,92,94,116,134,152,158,149,190,195,215,265,275,243,280,350,382**;Dec 17, 1997;Build 15
"RTN","ORMPS1",3,0)
 ;;Per VA Directive 6402, this routine should not be modified.
"RTN","ORMPS1",4,0)
 ;
"RTN","ORMPS1",5,0)
 ;
"RTN","ORMPS1",6,0)
UDOSE ; -- new Unit Dose order
"RTN","ORMPS1",7,0)
 N ADMIN,QT,DRUG,INSTR,DOSE,RTE,SCH,OI,URG,WP,DUR,STR,DRGNM,X,PSOI,PSDD,S0,ID,LDOSE,XC,NTE,S0,RXR
"RTN","ORMPS1",8,0)
 S ORDIALOG=+$O(^ORD(101.41,"AB","PSJ OR PAT OE",0))
"RTN","ORMPS1",9,0)
 I $G(ORAPPT)>0 S ORDG=+$O(^ORD(100.98,"B","CLINIC MEDICATIONS",0))
"RTN","ORMPS1",10,0)
 E  S ORDG=+$O(^ORD(100.98,"B","UNIT DOSE MEDICATIONS",0))
"RTN","ORMPS1",11,0)
 S ORPKG=+$$PKG("PSJ")
"RTN","ORMPS1",12,0)
 D GETDLG1^ORCD(ORDIALOG) S QT=$G(ORQT(1))
"RTN","ORMPS1",13,0)
 S DRUG=$$PTR("DISPENSE DRUG"),INSTR=$$PTR("INSTRUCTIONS")
"RTN","ORMPS1",14,0)
 S DOSE=$$PTR("DOSE"),RTE=$$PTR("ROUTE")
"RTN","ORMPS1",15,0)
 S SCH=$$PTR("SCHEDULE"),ADMIN=$$PTR("ADMIN TIMES")
"RTN","ORMPS1",16,0)
 S OI=$$PTR("ORDERABLE ITEM"),URG=$$PTR("URGENCY")
"RTN","ORMPS1",17,0)
 S WP=$$PTR("WORD PROCESSING 1"),DUR=$$PTR("DURATION")
"RTN","ORMPS1",18,0)
 S STR=$$PTR("STRENGTH"),DRGNM=$$PTR("DRUG NAME")
"RTN","ORMPS1",19,0)
UD1 S:RXO X=$P(RXO,"|",2),ORDIALOG(OI,1)=$$ORDITEM^ORM(X),PSOI=$P(X,U,4,5)
"RTN","ORMPS1",20,0)
 I '$G(ORDIALOG(OI,1)) S ORERR="Missing or invalid orderable item" Q
"RTN","ORMPS1",21,0)
 S PSDD=$P($$FIND^ORM(+RXE,3),U,4,5),ORDIALOG(DRUG,1)=+PSDD
"RTN","ORMPS1",22,0)
 S S0=$$FIND^ORM(+RXE,26)_"&"_$P($$FIND^ORM(+RXE,27),U,5)
"RTN","ORMPS1",23,0)
 S ID=$P(QT,U),LDOSE=$P(QT,U,8) I 'ID,S0 D
"RTN","ORMPS1",24,0)
 . N UNT,PTRN S UNT=$P(S0,"&",2),PTRN="1.N1"""_UNT_""""
"RTN","ORMPS1",25,0)
 . I LDOSE?@PTRN S $P(ID,"&",1,2)=+LDOSE_"&"_UNT_"&&" Q  ;pre-POE orders
"RTN","ORMPS1",26,0)
 . S:$P(PSOI,U,2)'[S0 ORDIALOG(STR,1)=$TR(S0,"&")
"RTN","ORMPS1",27,0)
 I 'ID,'S0 S ORDIALOG(DRGNM,1)=$$UNESC^ORMPS2($P(PSDD,U,2))
"RTN","ORMPS1",28,0)
 S:$L(ID) ORDIALOG(DOSE,1)=$$UNESC^ORMPS2($P(ID,"&",1,4)_"&"_LDOSE_"&"_+PSDD_"&"_S0)
"RTN","ORMPS1",29,0)
 I LDOSE="" D  I LDOSE="" S ORERR="Unable to determine instructions" Q
"RTN","ORMPS1",30,0)
 . I $G(RXC)'>0 D  Q  ;look for units/dose
"RTN","ORMPS1",31,0)
 .. S LDOSE=$P(ID,"&",3),X=$P(ID,"&",4) I 'LDOSE S LDOSE="" Q
"RTN","ORMPS1",32,0)
 .. S:'$L(X) X=$$UNESC^ORMPS2($P($$FIND^ORM(+RXE,7),U,5)) S:$L(X) LDOSE=LDOSE_" "_X
"RTN","ORMPS1",33,0)
 .. S ORDIALOG(DRGNM,1)=$$UNESC^ORMPS2($P(PSDD,U,2)) ;force use of DD
"RTN","ORMPS1",34,0)
 . F  D  Q:LDOSE'=""  S RXC=$O(@ORMSG@(RXC)) Q:'RXC  Q:$E(@ORMSG@(RXC),1,3)'="RXC"
"RTN","ORMPS1",35,0)
 .. S XC=@ORMSG@(RXC) Q:+$P($P(XC,"|",3),U,4)'=+PSOI
"RTN","ORMPS1",36,0)
 .. S LDOSE=$P(XC,"|",4)_$P($P(XC,"|",5),U,5) ;strength_units
"RTN","ORMPS1",37,0)
 S ORDIALOG(INSTR,1)=$$UNESC^ORMPS2(LDOSE)
"RTN","ORMPS1",38,0)
UD2 S NTE=$$NTE^ORMPS3(21) I NTE D
"RTN","ORMPS1",39,0)
 . N CNT,I S CNT=1,^TMP("ORWORD",$J,WP,1,CNT,0)=$$UNESC^ORMPS2($P(@ORMSG@(NTE),"|",4))
"RTN","ORMPS1",40,0)
 . I $O(@ORMSG@(NTE,0)) S I=0 F  S I=$O(@ORMSG@(NTE,I)) Q:I'>0  S CNT=CNT+1,^TMP("ORWORD",$J,WP,1,CNT,0)=$$UNESC^ORMPS2(@ORMSG@(NTE,I))
"RTN","ORMPS1",41,0)
 . S ^TMP("ORWORD",$J,WP,1,0)="^^"_CNT_U_CNT_U_DT_U
"RTN","ORMPS1",42,0)
 . S ORDIALOG(WP,1)="^TMP(""ORWORD"",$J,"_WP_",1)"
"RTN","ORMPS1",43,0)
 S RXR=$$RXR^ORMPS I 'RXR S ORERR="Missing or invalid RXR segment" Q
"RTN","ORMPS1",44,0)
 S ORDIALOG(RTE,1)=$P($P(RXR,"|",2),U,4),ORDIALOG(URG,1)=ORURG
"RTN","ORMPS1",45,0)
 S X=$P(QT,U,2)
"RTN","ORMPS1",46,0)
 S ORDIALOG(SCH,1)=$$UNESC^ORMPS2($P(X,"&"))
"RTN","ORMPS1",47,0)
 S:$L($P(X,"&",2)) ORDIALOG(ADMIN,1)=$P(X,"&",2)
"RTN","ORMPS1",48,0)
 S X=$P(QT,U,3) I $L(X) D  ;set only if previous order had duration
"RTN","ORMPS1",49,0)
 . N IFN S IFN=$S($G(ORIFN):+ORIFN,$P(ZRX,"|",2):+$P(ZRX,"|",2),1:0)
"RTN","ORMPS1",50,0)
 . S:$O(^OR(100,+IFN,4.5,"ID","DAYS",0)) ORDIALOG(DUR,1)=$$DURATION^ORMPS3(X)
"RTN","ORMPS1",51,0)
 D DOSETEXT^ORCDPS2 ;reset Instructions text, SIG
"RTN","ORMPS1",52,0)
 D UNESCARR^ORMPS2("ORDIALOG")
"RTN","ORMPS1",53,0)
 Q
"RTN","ORMPS1",54,0)
OUT ; -- new Outpt order
"RTN","ORMPS1",55,0)
 N OI,SIG,INSTR,DOSE,RTE,SCH,DUR,SC,STR,DRUG,PI,CONJ,PSOI,PSDD,S0,X,I,RXR,J,NTE,ZSC,CNT,PC
"RTN","ORMPS1",56,0)
 S ORDIALOG=+$O(^ORD(101.41,"AB","PSO OERR",0))
"RTN","ORMPS1",57,0)
 S ORDG=+$O(^ORD(100.98,"B","OUTPATIENT MEDICATIONS",0))
"RTN","ORMPS1",58,0)
 S ORPKG=+$$PKG("PSO") D GETDLG1^ORCD(ORDIALOG)
"RTN","ORMPS1",59,0)
 S OI=$$PTR("ORDERABLE ITEM"),SIG=$$PTR("SIG")
"RTN","ORMPS1",60,0)
 S INSTR=$$PTR("INSTRUCTIONS"),DOSE=$$PTR("DOSE")
"RTN","ORMPS1",61,0)
 S SCH=$$PTR("SCHEDULE"),DUR=$$PTR("DURATION")
"RTN","ORMPS1",62,0)
 S RTE=$$PTR("ROUTE"),SC=$$PTR("SERVICE CONNECTED")
"RTN","ORMPS1",63,0)
 S STR=$$PTR("STRENGTH"),DRUG=$$PTR("DISPENSE DRUG")
"RTN","ORMPS1",64,0)
 S PI=$$PTR("PATIENT INSTRUCTIONS"),CONJ=$$PTR("AND/THEN")
"RTN","ORMPS1",65,0)
 S PC=$$PTR("WORD PROCESSING 1")
"RTN","ORMPS1",66,0)
 S:RXO X=$P(RXO,"|",2),ORDIALOG(OI,1)=$$ORDITEM^ORM(X),PSOI=$P(X,U,4,5)
"RTN","ORMPS1",67,0)
 I '$G(ORDIALOG(OI,1)) S ORERR="Missing or invalid orderable item" Q
"RTN","ORMPS1",68,0)
 S PSDD=$P($$FIND^ORM(+RXE,3),U,4,5),ORDIALOG(DRUG,1)=+PSDD
"RTN","ORMPS1",69,0)
 S S0=$$FIND^ORM(+RXE,26)_"&"_$P($$FIND^ORM(+RXE,27),U,5)
"RTN","ORMPS1",70,0)
 I S0,$P(PSOI,U,2)'[S0 S ORDIALOG(STR,1)=$TR(S0,"&")
"RTN","ORMPS1",71,0)
 I 'S0,'$G(ORQT(1)) S ORDIALOG($$PTR("DRUG NAME"),1)=$$UNESC^ORMPS2($P(PSDD,U,2))
"RTN","ORMPS1",72,0)
OUT1 S ORDIALOG($$PTR("QUANTITY"),1)=$$FIND^ORM(+RXE,11)
"RTN","ORMPS1",73,0)
 S ORDIALOG($$PTR("REFILLS"),1)=$$FIND^ORM(+RXE,13)
"RTN","ORMPS1",74,0)
 S X=$$FIND^ORM(+RXE,23) S:$E(X)="D" X=+$E(X,2,99)
"RTN","ORMPS1",75,0)
 S:X ORDIALOG($$PTR("DAYS SUPPLY"),1)=X
"RTN","ORMPS1",76,0)
 I ZRX S X=$P(ZRX,"|",5) S:$L(X) ORDIALOG($$PTR("ROUTING"),1)=X
"RTN","ORMPS1",77,0)
 S:ORURG ORDIALOG($$PTR("URGENCY"),1)=ORURG F I=1:1:ORQT D
"RTN","ORMPS1",78,0)
 . S ORDIALOG(INSTR,I)=$$UNESC^ORMPS2($P(ORQT(I),U,8)),X=$P(ORQT(I),U)
"RTN","ORMPS1",79,0)
 . S:$L(X) ORDIALOG(DOSE,I)=$$UNESC^ORMPS2($P(X,"&",1,4)_"&"_$P(ORQT(I),U,8)_"&"_+PSDD_"&"_S0)
"RTN","ORMPS1",80,0)
 . S X=$P(ORQT(I),U,2) S:$L(X) ORDIALOG(SCH,I)=$$UNESC^ORMPS2(X)
"RTN","ORMPS1",81,0)
 . S X=$P(ORQT(I),U,3) S:$L(X) ORDIALOG(DUR,I)=$$DURATION^ORMPS3(X)
"RTN","ORMPS1",82,0)
 . S X=$P(ORQT(I),U,9) S:$L(X) ORDIALOG(CONJ,I)=$S(X="S":"T",1:X)
"RTN","ORMPS1",83,0)
 S RXR=$$RXR^ORMPS I RXR S ORDIALOG(RTE,1)=$P($P(RXR,"|",2),U,4) D
"RTN","ORMPS1",84,0)
 . S I=1,J=+RXR ;look for multiple RXR's
"RTN","ORMPS1",85,0)
 . F  S J=$O(@ORMSG@(J)) Q:J'>0  S RXR=@ORMSG@(J) Q:$E(RXR,1,3)'="RXR"  S I=I+1,ORDIALOG(RTE,I)=$P($P(RXR,"|",2),U,4)
"RTN","ORMPS1",86,0)
OUT2 S NTE=$$NTE^ORMPS3(6) I NTE D  ;Prov Comm ;D:'NTE PCOMM^ORMPS2
"RTN","ORMPS1",87,0)
 . S CNT=1,^TMP("ORWORD",$J,PC,1,CNT,0)=$$UNESC^ORMPS2($P(@ORMSG@(NTE),"|",4))
"RTN","ORMPS1",88,0)
 . I $O(@ORMSG@(NTE,0)) S I=0 F  S I=$O(@ORMSG@(NTE,I)) Q:I'>0  S CNT=CNT+1,^TMP("ORWORD",$J,PC,1,CNT,0)=$$UNESC^ORMPS2(@ORMSG@(NTE,I))
"RTN","ORMPS1",89,0)
 . S ^TMP("ORWORD",$J,PC,1,0)="^^"_CNT_U_CNT_U_DT_U
"RTN","ORMPS1",90,0)
 . S ORDIALOG(PC,1)="^TMP(""ORWORD"",$J,"_PC_",1)",ORDIALOG(PC,"FORMAT")="@" ;keep, don't show
"RTN","ORMPS1",91,0)
 . N XCNT,XCOMM,XCOMMENT,XORCOMM,XXCNT,XORIFN
"RTN","ORMPS1",92,0)
 . S XORIFN=$G(ORIFN) S:XORIFN="" XORIFN=$P(RXR,"|",2) Q:XORIFN=""
"RTN","ORMPS1",93,0)
 . S XCOMM=$O(^OR(100,+XORIFN,4.5,"ID","COMMENT",0)) Q:XCOMM=""
"RTN","ORMPS1",94,0)
 . S XCNT=0 F  S XCNT=$O(^TMP("ORWORD",$J,PC,1,XCNT)) Q:XCNT=""  S XCOMMENT=^TMP("ORWORD",$J,PC,1,XCNT,0) D
"RTN","ORMPS1",95,0)
 .. S XORCOMM=$G(^OR(100,+XORIFN,4.5,XCOMM,2,XCNT,0)),XXCNT=0
"RTN","ORMPS1",96,0)
 .. I XORCOMM="" F  S XXCNT=$O(^OR(100,+XORIFN,4.5,XCOMM,2,XXCNT)) Q:XXCNT=""  S XORCOMM=$G(^(XXCNT,0)) Q:XORCOMM'=""
"RTN","ORMPS1",97,0)
 .. I $G(XCOMMENT)=$G(XORCOMM) S ORDIALOG(PC,"FORMAT")="@"
"RTN","ORMPS1",98,0)
 S NTE=$$NTE^ORMPS3(7) I NTE D  ;Pat Instr
"RTN","ORMPS1",99,0)
 . S CNT=1,^TMP("ORWORD",$J,PI,1,CNT,0)=$$UNESC^ORMPS2($P(@ORMSG@(NTE),"|",4))
"RTN","ORMPS1",100,0)
 . I $O(@ORMSG@(NTE,0)) S I=0 F  S I=$O(@ORMSG@(NTE,I)) Q:I'>0  S CNT=CNT+1,^TMP("ORWORD",$J,PI,1,CNT,0)=$$UNESC^ORMPS2(@ORMSG@(NTE,I))
"RTN","ORMPS1",101,0)
 . S ^TMP("ORWORD",$J,PI,1,0)="^^"_CNT_U_CNT_U_DT_U
"RTN","ORMPS1",102,0)
 . S ORDIALOG(PI,1)="^TMP(""ORWORD"",$J,"_PI_",1)"
"RTN","ORMPS1",103,0)
 S NTE=$$NTE^ORMPS3(21) I NTE D  ;Sig
"RTN","ORMPS1",104,0)
 . S CNT=1,^TMP("ORWORD",$J,SIG,1,CNT,0)=$$UNESC^ORMPS2($P(@ORMSG@(NTE),"|",4))
"RTN","ORMPS1",105,0)
 . I $O(@ORMSG@(NTE,0)) S I=0 F  S I=$O(@ORMSG@(NTE,I)) Q:I'>0  S CNT=CNT+1,^TMP("ORWORD",$J,SIG,1,CNT,0)=$$UNESC^ORMPS2(@ORMSG@(NTE,I))
"RTN","ORMPS1",106,0)
 . S ^TMP("ORWORD",$J,SIG,1,0)="^^"_CNT_U_CNT_U_DT_U
"RTN","ORMPS1",107,0)
 . S ORDIALOG(SIG,1)="^TMP(""ORWORD"",$J,"_SIG_",1)"
"RTN","ORMPS1",108,0)
 . S ORDIALOG(PI,"FORMAT")="@" ;PI already included in Sig
"RTN","ORMPS1",109,0)
OUT3 I '$G(ORQT(1))!('NTE) D DOSETEXT^ORCDPS2 ;reset Instructions text, Sig
"RTN","ORMPS1",110,0)
 S ZSC=$$ZSC^ORMPS3,X=$P(ZSC,"|",2) I X?2.3U S ORDIALOG(SC,1)=$S(X="SC":1,1:0)
"RTN","ORMPS1",111,0)
 Q
"RTN","ORMPS1",112,0)
IV ; -- new IV order
"RTN","ORMPS1",113,0)
 N IVTYP,IVTYPE S IVTYP=$P(ZRX,"|",7) I IVTYP="",$$NUMADDS^ORMPS3'>1 G UDOSE
"RTN","ORMPS1",114,0)
 N SOLN,VOL,ADDS,STR,UNITS,RATE,URG,X,X1,X2,X3,I,J,TYPE,OI,WP,NTE,SCH
"RTN","ORMPS1",115,0)
 N DAYS,ROUTE,ADMIN,RXR,ADDFREQ
"RTN","ORMPS1",116,0)
 S ORDIALOG=+$O(^ORD(101.41,"AB","PSJI OR PAT FLUID OE",0))
"RTN","ORMPS1",117,0)
 I +$G(ORAPPT)>0 S ORDG=+$O(^ORD(100.98,"B","CLINIC INFUSIONS",0))
"RTN","ORMPS1",118,0)
 E  S ORDG=+$O(^ORD(100.98,"B",$S($P(ZRX,"|",7)="TPN":"TPN",1:"IV RX"),0))
"RTN","ORMPS1",119,0)
 S ORPKG=+$$PKG("PSJ") D GETDLG1^ORCD(ORDIALOG)
"RTN","ORMPS1",120,0)
 S SOLN=$$PTR("ORDERABLE ITEM"),VOL=$$PTR("VOLUME"),SCH=$$PTR("SCHEDULE")
"RTN","ORMPS1",121,0)
 S RATE=$$PTR("INFUSION RATE") S:ORURG ORDIALOG($$PTR("URGENCY"),1)=ORURG
"RTN","ORMPS1",122,0)
 S WP=$$PTR("WORD PROCESSING 1"),ADDS=$$PTR("ADDITIVE")
"RTN","ORMPS1",123,0)
 S ADDFREQ=$$PTR("ADDITIVE FREQUENCY")
"RTN","ORMPS1",124,0)
 S STR=$$PTR("STRENGTH PSIV"),UNITS=$$PTR("UNITS")
"RTN","ORMPS1",125,0)
 S DAYS=$$PTR("DURATION"),IVTYPE=$$PTR("IV TYPE"),ADMIN=$$PTR("ADMIN TIMES")
"RTN","ORMPS1",126,0)
IV1 S NTE=$$NTE^ORMPS3(21) I NTE D
"RTN","ORMPS1",127,0)
 . N CNT,I S CNT=1,^TMP("ORWORD",$J,WP,1,CNT,0)=$$UNESC^ORMPS2($P(@ORMSG@(NTE),"|",4))
"RTN","ORMPS1",128,0)
 . I $O(@ORMSG@(NTE,0)) S I=0 F  S I=$O(@ORMSG@(NTE,I)) Q:I'>0  S CNT=CNT+1,^TMP("ORWORD",$J,WP,1,CNT,0)=$$UNESC^ORMPS2(@ORMSG@(NTE,I))
"RTN","ORMPS1",129,0)
 . S ^TMP("ORWORD",$J,WP,1,0)="^^"_CNT_U_CNT_U_DT_U
"RTN","ORMPS1",130,0)
 . S ORDIALOG(WP,1)="^TMP(""ORWORD"",$J,"_WP_",1)"
"RTN","ORMPS1",131,0)
 N ORDAYS S ORDAYS=""
"RTN","ORMPS1",132,0)
 S:$D(RXO) ORDAYS=$P($P(RXO,"|",2),"^",3)
"RTN","ORMPS1",133,0)
 S:$L(ORDAYS) ORDAYS=$$IVLIM^ORMPS2(ORDAYS)
"RTN","ORMPS1",134,0)
 S:$L(ORDAYS) ORDIALOG(DAYS,1)=ORDAYS
"RTN","ORMPS1",135,0)
 S ORDIALOG(IVTYPE,1)=IVTYP
"RTN","ORMPS1",136,0)
 S X=$P($$FIND^ORM(+RXE,25),U,5)
"RTN","ORMPS1",137,0)
 S ORDIALOG(RATE,1)=$$FIND^ORM(+RXE,24)_$S($L(X):" "_X,1:""),(I,J)=0
"RTN","ORMPS1",138,0)
 F  D  S RXC=$O(@ORMSG@(RXC)) Q:'RXC  Q:$E(@ORMSG@(RXC),1,3)'="RXC"
"RTN","ORMPS1",139,0)
 . S X=@ORMSG@(RXC),TYPE=$P(X,"|",2),OI=$$ORDITEM^ORM($P(X,"|",3)) Q:'OI
"RTN","ORMPS1",140,0)
 . S X1=$P(X,"|",4),X2=$P($P(X,"|",5),U,5),X3=$P(X,"|",6)
"RTN","ORMPS1",141,0)
 . I $E(TYPE)="B" S J=J+1,ORDIALOG(SOLN,J)=OI,ORDIALOG(VOL,J)=X1 Q
"RTN","ORMPS1",142,0)
 . S I=I+1,ORDIALOG(ADDS,I)=OI,ORDIALOG(STR,I)=X1,ORDIALOG(UNITS,I)=X2,ORDIALOG(ADDFREQ,I)=$$ADDFRQCV^ORMBLDP1(X3,"I")
"RTN","ORMPS1",143,0)
IV2 ;
"RTN","ORMPS1",144,0)
 S RXR=$$RXR^ORMPS
"RTN","ORMPS1",145,0)
 S ROUTE=$P(RXR,"|",2)
"RTN","ORMPS1",146,0)
 S ORDIALOG($$PTR("ROUTE"),1)=$P(ROUTE,U,4)
"RTN","ORMPS1",147,0)
 I IVTYP="I" S X=$P($G(ORQT(1)),U,2) D
"RTN","ORMPS1",148,0)
 .S:$L($P(X,"&")) ORDIALOG(SCH,1)=$P(X,"&")
"RTN","ORMPS1",149,0)
 .S:$L($P(X,"&",2)) ORDIALOG(ADMIN,1)=$P(X,"&",2)
"RTN","ORMPS1",150,0)
 D UNESCARR^ORMPS2("ORDIALOG")
"RTN","ORMPS1",151,0)
 Q
"RTN","ORMPS1",152,0)
PKG(NMSP) ; -- Return Package file ptr for NMSP
"RTN","ORMPS1",153,0)
 N I S I=0
"RTN","ORMPS1",154,0)
 F  S I=+$O(^DIC(9.4,"C",NMSP,I)) Q:I<1  Q:'$O(^(I,0))  ;no Addl Prefs
"RTN","ORMPS1",155,0)
 Q I
"RTN","ORMPS1",156,0)
PTR(NAME) ; -- Returns ien of prompt NAME in Order Dialog file #101.41
"RTN","ORMPS1",157,0)
 Q +$O(^ORD(101.41,"AB",$E("OR GTX "_NAME,1,63),0))
"RTN","ORMPS1",158,0)
QT ; -- Unpiece the Q/T field from RXE
"RTN","ORMPS1",159,0)
 I 'RXE S ORQT(1)=ORQT,ORQT=1 Q  ; nothing to reset
"RTN","ORMPS1",160,0)
 N X,Y,I,J,P,SEG,DONE K ORQT
"RTN","ORMPS1",161,0)
 S SEG=$G(@ORMSG@(+RXE)),X=$P(SEG,"|",2),(I,J,P,DONE)=0
"RTN","ORMPS1",162,0)
 F  D  Q:DONE
"RTN","ORMPS1",163,0)
 . S P=P+1,Y=$P(X,"~",P) I Y="" S DONE=1 Q
"RTN","ORMPS1",164,0)
 . I P<$L(X,"~") S I=I+1,ORQT(I)=Y Q
"RTN","ORMPS1",165,0)
 . I $L(SEG,"|")>2 S I=I+1,ORQT(I)=Y,DONE=1 Q
"RTN","ORMPS1",166,0)
 . S J=+$O(@ORMSG@(+RXE,J)) I J'>0 S I=I+1,ORQT(I)=Y,DONE=1 Q
"RTN","ORMPS1",167,0)
 . S SEG=$G(@ORMSG@(+RXE,J)),X=$P(SEG,"|"),P=1,I=I+1,ORQT(I)=Y_$P(X,"~")
"RTN","ORMPS1",168,0)
 S ORQT=I Q:'ORQT  ; else reset ORSTRT, ORSTOP, ORURG
"RTN","ORMPS1",169,0)
 S ORSTRT=$P(ORQT(1),U,4),ORSTOP=$P(ORQT(ORQT),U,5),ORURG=$P(ORQT(1),U,6)
"RTN","ORMPS1",170,0)
 S:ORSTRT ORSTRT=$$FMDATE^ORM(ORSTRT) S:ORSTOP ORSTOP=$$FMDATE^ORM(ORSTOP) S:$L(ORURG) ORURG=$$URGENCY^ORM(ORURG)
"RTN","ORMPS1",171,0)
 Q
"RTN","ORUQO")
0^8^B19420199
"RTN","ORUQO",1,0)
ORUQO ;SLC/JLC - SEARCH QOS FOR  ; 5/31/17 1:34pm
"RTN","ORUQO",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**315,395,382**;Dec 17,1997;Build 15
"RTN","ORUQO",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORUQO",4,0)
 ;
"RTN","ORUQO",5,0)
 ; Reference to PXRMD(801.41 is supported by IA #4097
"RTN","ORUQO",6,0)
 ; Reference to DIC(9.4 is supported by IA #2058
"RTN","ORUQO",7,0)
 Q
"RTN","ORUQO",8,0)
 ;
"RTN","ORUQO",9,0)
EN(PKG,OINU,OINA) ; check for quick orders
"RTN","ORUQO",10,0)
 N CREAT,EXPR,OROIP,ORDUO,S1,S2,A,B,%,ORDG,DIEN,AFIND,TEXT,TYPE,I,ORPKG
"RTN","ORUQO",11,0)
 D NOW^%DTC S CREAT=$E(%,1,7),EXPR=$$FMADD^XLFDT(CREAT,30,0,0,0) K ^XTMP("ORUQO",$J),^TMP($J)
"RTN","ORUQO",12,0)
 S OROI=$P(PKG,";"),ORPKG=$P(PKG,";",2)
"RTN","ORUQO",13,0)
 K ORDG
"RTN","ORUQO",14,0)
 I ORPKG="LR" F I="LAB","MI","BB","HEMA","CH","CY","EM" S ORDG=$O(^ORD(100.98,"B",I,"")) I ORDG]"" S ORDG(ORDG)=""
"RTN","ORUQO",15,0)
 I ORPKG="PS" F I="C RX","CI RX","I RX","IV RX","NV RX","O RX","SPLY","UD RX","RX","TPN" S ORDG=$O(^ORD(100.98,"B",I,"")) I ORDG]"" S ORDG(ORDG)=""
"RTN","ORUQO",16,0)
 F TYPE="G","E" D
"RTN","ORUQO",17,0)
 . S DIEN="" F  S DIEN=$O(^PXRMD(801.41,"TYPE",TYPE,DIEN)) Q:DIEN'>0  D
"RTN","ORUQO",18,0)
 .. S TEXT=$P($G(^PXRMD(801.41,DIEN,1)),"^",5)
"RTN","ORUQO",19,0)
 .. I TEXT[101.41 S ^TMP($J,$P(TEXT,";"))=""
"RTN","ORUQO",20,0)
 .. S AFIND="" F  S AFIND=$O(^PXRMD(801.41,DIEN,3,"B",AFIND)) Q:AFIND=""  D
"RTN","ORUQO",21,0)
 ... I AFIND'[101.41 Q
"RTN","ORUQO",22,0)
 ... S ^TMP($J,$P(AFIND,";"))=""
"RTN","ORUQO",23,0)
 F I="OR GTX ORDERABLE ITEM","OR GTX ADDITIVE" S OROIP(I)=$O(^ORD(101.41,"B",I,""))
"RTN","ORUQO",24,0)
 S ORD=0
"RTN","ORUQO",25,0)
 F  S ORD=$O(^ORD(101.41,ORD)) Q:'ORD  S A=$G(^(ORD,0)) I $P(A,"^",4)="Q" S B=$P(A,"^",5) I B]"" D
"RTN","ORUQO",26,0)
 . I '$D(ORDG(B)) Q
"RTN","ORUQO",27,0)
 . F I="OR GTX ORDERABLE ITEM","OR GTX ADDITIVE" S ORDUO="" D
"RTN","ORUQO",28,0)
 ..  F  S ORDUO=$O(^ORD(101.41,ORD,6,"D",OROIP(I),ORDUO)) Q:'ORDUO  D
"RTN","ORUQO",29,0)
 ...  I $G(^ORD(101.41,ORD,6,ORDUO,1))=OROI S ^XTMP("ORUQO",$J,ORD,ORDUO)=$P(A,"^")_"^"_$P(A,"^",3)
"RTN","ORUQO",30,0)
 I $D(^XTMP("ORUQO",$J)) S ^XTMP("ORUQO",$J,0)=EXPR_"^"_CREAT D SEND
"RTN","ORUQO",31,0)
 Q
"RTN","ORUQO",32,0)
SEND ;Send message
"RTN","ORUQO",33,0)
 K ORMSG,XMY N OCNT,ORD,A,S1,XMDUZ,XMSUB,XMTEXT,H1,H2,H3
"RTN","ORUQO",34,0)
 S XMDUZ="CPRS, SEARCH",XMSUB="QUICK ORDER SEARCH",XMTEXT="ORMSG(",XMY(DUZ)="",XMY("G.OR CACS")=""
"RTN","ORUQO",35,0)
 I ORPKG="LR" S ORMSG(1,0)="  The check of Lab Quick Orders that contain Lab Test",ORMSG(2,0)=" "_OINU_" ("_$G(OINA)_") is complete.",OCNT=1
"RTN","ORUQO",36,0)
 I ORPKG="PS" S ORMSG(1,0)="  The check of Pharmacy Quick Orders that contain Pharmacy",ORMSG(2,0)=" Orderable Item "_OINU_" ("_$G(OINA)_") is complete.",OCNT=1
"RTN","ORUQO",37,0)
 S OCNT=OCNT+2,ORMSG(OCNT,0)=" ",ORMSG(OCNT+1,0)="  Here is the list of all quick orders that should be reviewed by your "
"RTN","ORUQO",38,0)
 S OCNT=OCNT+2,ORMSG(OCNT,0)="Clinical Applications Coordinator or whoever manages CPRS Quick Orders"
"RTN","ORUQO",39,0)
 S OCNT=OCNT+1,ORMSG(OCNT,0)="at your site.",ORMSG(OCNT+1,0)=" "
"RTN","ORUQO",40,0)
 S ORD=0,OCNT=OCNT+2,ORMSG(OCNT,0)="Quick Order Name                       Disable Text     Text or Start Date/Time                 Ancestors/Menus or Reminders"
"RTN","ORUQO",41,0)
 S OCNT=OCNT+1,ORMSG(OCNT,0)="  "
"RTN","ORUQO",42,0)
 F  S ORD=$O(^XTMP("ORUQO",$J,ORD)) Q:ORD=""  S S1=$O(^XTMP("ORUQO",$J,ORD,0)) Q:S1=""  S A=^(S1) D
"RTN","ORUQO",43,0)
 . S OCNT=OCNT+1,ORMSG(OCNT,0)=$E($P(A,"^")_$J(" ",38),1,37)_"  "_$E($P(A,"^",2)_$J(" ",38),1,15)_"  ",(H1,H2,H3)=""
"RTN","ORUQO",44,0)
 . I $D(^TMP($J,ORD)) S H2="Used in Clinical Reminders Dialog"
"RTN","ORUQO",45,0)
 . I $D(^ORD(101.41,"AD",ORD)) S H3="On a menu or in an order set"
"RTN","ORUQO",46,0)
 . S S1=0 F  S S1=$O(^XTMP("ORUQO",$J,ORD,S1)) Q:S1=""  S A=^(S1) D
"RTN","ORUQO",47,0)
 .. S S2=0 F  S S2=$O(^XTMP("ORUQO",$J,ORD,S1,S2)) Q:S2=""  S A=^(S2) I $TR(A," ")]"" D
"RTN","ORUQO",48,0)
 ... I H1 S OCNT=OCNT+1,ORMSG(OCNT,0)=$J(" ",56)
"RTN","ORUQO",49,0)
 ... S ORMSG(OCNT,0)=ORMSG(OCNT,0)_$E($P(A,"^")_$J(" ",39),1,38)_"  ",H1=1
"RTN","ORUQO",50,0)
 ... I H2]"" S ORMSG(OCNT,0)=ORMSG(OCNT,0)_H2 S H2="" Q
"RTN","ORUQO",51,0)
 ... I H3]"" S ORMSG(OCNT,0)=ORMSG(OCNT,0)_H3 S H3=""
"RTN","ORUQO",52,0)
 . I H2]"" S ORMSG(OCNT,0)=ORMSG(OCNT,0)_H2
"RTN","ORUQO",53,0)
 . I H3]"" S:$L(ORMSG(OCNT,0))>97 OCNT=OCNT+1,ORMSG(OCNT,0)=$J(" ",97) S ORMSG(OCNT,0)=ORMSG(OCNT,0)_H3
"RTN","ORUQO",54,0)
 . S OCNT=OCNT+1,ORMSG(OCNT,0)=" "
"RTN","ORUQO",55,0)
 D ^XMD
"RTN","ORUQO",56,0)
 Q
"RTN","ORUQO",57,0)
CHECKLR(OR60,OR60N) ;
"RTN","ORUQO",58,0)
 ;OR60 is the file 60 IEN that needs to be checked
"RTN","ORUQO",59,0)
 N ORPT,OROI
"RTN","ORUQO",60,0)
 S OR60=$G(OR60) Q:OR60=""
"RTN","ORUQO",61,0)
 S ORPT=OR60_";99LRT" I '$D(^ORD(101.43,"ID",ORPT)) Q  ;test is not in a CPRS orderable item
"RTN","ORUQO",62,0)
 S OROI=$O(^ORD(101.43,"ID",ORPT,"")) Q:OROI=""
"RTN","ORUQO",63,0)
 D EN(OROI_";LR",OR60,OR60N) Q
"RTN","ORUQO",64,0)
CHECKPS(OR507,OR507N) ;
"RTN","ORUQO",65,0)
 ;OR507 is the file 50.7 IEN that needs to be checked
"RTN","ORUQO",66,0)
 N ORPT,OROI,ORP
"RTN","ORUQO",67,0)
 S OR507=$G(OR507) Q:OR507=""
"RTN","ORUQO",68,0)
 S ORPT=OR507_";99PSP" I '$D(^ORD(101.43,"ID",ORPT)) Q  ;drug is not in a CPRS orderable item
"RTN","ORUQO",69,0)
 S OROI=$O(^ORD(101.43,"ID",ORPT,"")) Q:OROI=""
"RTN","ORUQO",70,0)
 D EN(OROI_";PS",OR507,OR507N)
"RTN","ORUQO",71,0)
 Q
"VER")
8.0^22.2
**INSTALL NAME**
PSJ*5.0*256
"BLD",9612,0)
PSJ*5.0*256^INPATIENT MEDICATIONS^0^3170802^y
"BLD",9612,1,0)
^^1^1^3160809^
"BLD",9612,1,1,0)
MOCHA 2.1 Dosing Enhancements.
"BLD",9612,4,0)
^9.64PA^^
"BLD",9612,6.3)
34
"BLD",9612,"ABPKG")
n
"BLD",9612,"INID")
^n
"BLD",9612,"INIT")

"BLD",9612,"KRN",0)
^9.67PA^779.2^20
"BLD",9612,"KRN",.4,0)
.4
"BLD",9612,"KRN",.401,0)
.401
"BLD",9612,"KRN",.402,0)
.402
"BLD",9612,"KRN",.403,0)
.403
"BLD",9612,"KRN",.5,0)
.5
"BLD",9612,"KRN",.84,0)
.84
"BLD",9612,"KRN",3.6,0)
3.6
"BLD",9612,"KRN",3.8,0)
3.8
"BLD",9612,"KRN",9.2,0)
9.2
"BLD",9612,"KRN",9.8,0)
9.8
"BLD",9612,"KRN",9.8,"NM",0)
^9.68A^34^29
"BLD",9612,"KRN",9.8,"NM",1,0)
PSGS0^^0^B78819959
"BLD",9612,"KRN",9.8,"NM",3,0)
PSJAPIDS^^0^B34167201
"BLD",9612,"KRN",9.8,"NM",4,0)
PSJOC^^0^B61350664
"BLD",9612,"KRN",9.8,"NM",5,0)
PSJOCDS^^0^B89631244
"BLD",9612,"KRN",9.8,"NM",6,0)
PSJOCDSD^^0^B35364232
"BLD",9612,"KRN",9.8,"NM",7,0)
PSJLIACT^^0^B58941977
"BLD",9612,"KRN",9.8,"NM",9,0)
PSGOEF^^0^B125998243
"BLD",9612,"KRN",9.8,"NM",10,0)
PSJLMGUD^^0^B31538493
"BLD",9612,"KRN",9.8,"NM",11,0)
PSGOD^^0^B27720964
"BLD",9612,"KRN",9.8,"NM",13,0)
PSJLIFN^^0^B58490722
"BLD",9612,"KRN",9.8,"NM",15,0)
PSGOES^^0^B24088682
"BLD",9612,"KRN",9.8,"NM",17,0)
PSGOEV^^0^B95475344
"BLD",9612,"KRN",9.8,"NM",18,0)
PSJLIFNI^^0^B12733374
"BLD",9612,"KRN",9.8,"NM",19,0)
PSGOER^^0^B90452395
"BLD",9612,"KRN",9.8,"NM",20,0)
PSJLMHED^^0^B63213228
"BLD",9612,"KRN",9.8,"NM",21,0)
PSJHEAD^^0^B32768134
"BLD",9612,"KRN",9.8,"NM",22,0)
PSGCAPP0^^0^B14274534
"BLD",9612,"KRN",9.8,"NM",23,0)
PSJCLOR2^^0^B129355642
"BLD",9612,"KRN",9.8,"NM",24,0)
PSJOE^^0^B107308183
"BLD",9612,"KRN",9.8,"NM",25,0)
PSIV^^0^B31216203
"BLD",9612,"KRN",9.8,"NM",26,0)
PSIVOCDS^^0^B137929887
"BLD",9612,"KRN",9.8,"NM",27,0)
PSIVOD^^0^B15601975
"BLD",9612,"KRN",9.8,"NM",28,0)
PSIVSP^^0^B44907043
"BLD",9612,"KRN",9.8,"NM",29,0)
PSIVQUI^^0^B21879458
"BLD",9612,"KRN",9.8,"NM",30,0)
PSJLIVFD^^0^B63243242
"BLD",9612,"KRN",9.8,"NM",31,0)
PSJMISC^^0^B83581332
"BLD",9612,"KRN",9.8,"NM",32,0)
PSJMISC2^^0^B25685230
"BLD",9612,"KRN",9.8,"NM",33,0)
PSJORUTL^^0^B21381210
"BLD",9612,"KRN",9.8,"NM",34,0)
PSGSICHK^^0^B81963876
"BLD",9612,"KRN",9.8,"NM","B","PSGCAPP0",22)

"BLD",9612,"KRN",9.8,"NM","B","PSGOD",11)

"BLD",9612,"KRN",9.8,"NM","B","PSGOEF",9)

"BLD",9612,"KRN",9.8,"NM","B","PSGOER",19)

"BLD",9612,"KRN",9.8,"NM","B","PSGOES",15)

"BLD",9612,"KRN",9.8,"NM","B","PSGOEV",17)

"BLD",9612,"KRN",9.8,"NM","B","PSGS0",1)

"BLD",9612,"KRN",9.8,"NM","B","PSGSICHK",34)

"BLD",9612,"KRN",9.8,"NM","B","PSIV",25)

"BLD",9612,"KRN",9.8,"NM","B","PSIVOCDS",26)

"BLD",9612,"KRN",9.8,"NM","B","PSIVOD",27)

"BLD",9612,"KRN",9.8,"NM","B","PSIVQUI",29)

"BLD",9612,"KRN",9.8,"NM","B","PSIVSP",28)

"BLD",9612,"KRN",9.8,"NM","B","PSJAPIDS",3)

"BLD",9612,"KRN",9.8,"NM","B","PSJCLOR2",23)

"BLD",9612,"KRN",9.8,"NM","B","PSJHEAD",21)

"BLD",9612,"KRN",9.8,"NM","B","PSJLIACT",7)

"BLD",9612,"KRN",9.8,"NM","B","PSJLIFN",13)

"BLD",9612,"KRN",9.8,"NM","B","PSJLIFNI",18)

"BLD",9612,"KRN",9.8,"NM","B","PSJLIVFD",30)

"BLD",9612,"KRN",9.8,"NM","B","PSJLMGUD",10)

"BLD",9612,"KRN",9.8,"NM","B","PSJLMHED",20)

"BLD",9612,"KRN",9.8,"NM","B","PSJMISC",31)

"BLD",9612,"KRN",9.8,"NM","B","PSJMISC2",32)

"BLD",9612,"KRN",9.8,"NM","B","PSJOC",4)

"BLD",9612,"KRN",9.8,"NM","B","PSJOCDS",5)

"BLD",9612,"KRN",9.8,"NM","B","PSJOCDSD",6)

"BLD",9612,"KRN",9.8,"NM","B","PSJOE",24)

"BLD",9612,"KRN",9.8,"NM","B","PSJORUTL",33)

"BLD",9612,"KRN",19,0)
19
"BLD",9612,"KRN",19.1,0)
19.1
"BLD",9612,"KRN",101,0)
101
"BLD",9612,"KRN",409.61,0)
409.61
"BLD",9612,"KRN",409.61,"NM",0)
^9.68A^^0
"BLD",9612,"KRN",771,0)
771
"BLD",9612,"KRN",779.2,0)
779.2
"BLD",9612,"KRN",870,0)
870
"BLD",9612,"KRN",8989.51,0)
8989.51
"BLD",9612,"KRN",8989.52,0)
8989.52
"BLD",9612,"KRN",8994,0)
8994
"BLD",9612,"KRN","B",.4,.4)

"BLD",9612,"KRN","B",.401,.401)

"BLD",9612,"KRN","B",.402,.402)

"BLD",9612,"KRN","B",.403,.403)

"BLD",9612,"KRN","B",.5,.5)

"BLD",9612,"KRN","B",.84,.84)

"BLD",9612,"KRN","B",3.6,3.6)

"BLD",9612,"KRN","B",3.8,3.8)

"BLD",9612,"KRN","B",9.2,9.2)

"BLD",9612,"KRN","B",9.8,9.8)

"BLD",9612,"KRN","B",19,19)

"BLD",9612,"KRN","B",19.1,19.1)

"BLD",9612,"KRN","B",101,101)

"BLD",9612,"KRN","B",409.61,409.61)

"BLD",9612,"KRN","B",771,771)

"BLD",9612,"KRN","B",779.2,779.2)

"BLD",9612,"KRN","B",870,870)

"BLD",9612,"KRN","B",8989.51,8989.51)

"BLD",9612,"KRN","B",8989.52,8989.52)

"BLD",9612,"KRN","B",8994,8994)

"BLD",9612,"QUES",0)
^9.62^^
"BLD",9612,"REQB",0)
^9.611^4^4
"BLD",9612,"REQB",1,0)
PSJ*5.0*227^2
"BLD",9612,"REQB",2,0)
PSJ*5.0*315^2
"BLD",9612,"REQB",3,0)
PSJ*5.0*331^2
"BLD",9612,"REQB",4,0)
PSJ*5.0*333^2
"BLD",9612,"REQB","B","PSJ*5.0*227",1)

"BLD",9612,"REQB","B","PSJ*5.0*315",2)

"BLD",9612,"REQB","B","PSJ*5.0*331",3)

"BLD",9612,"REQB","B","PSJ*5.0*333",4)

"MBREQ")
1
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
256^3170802^10000000070
"PKG",197,22,1,"PAH",1,1,0)
^^1^1^3170802
"PKG",197,22,1,"PAH",1,1,1,0)
MOCHA 2.1 Dosing Enhancements.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
29
"RTN","PSGCAPP0")
0^22^B14274534
"RTN","PSGCAPP0",1,0)
PSGCAPP0 ;BIR/CML3-PRINT DATA FOR ACTION PROFILE CONT. ; 4/1/08 3:05pm
"RTN","PSGCAPP0",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**8,20,85,169,203,256**;16 DEC 97;Build 34
"RTN","PSGCAPP0",3,0)
 ; Reference to BSA^PSSDSAPI supported by DBIA #5425
"RTN","PSGCAPP0",4,0)
H1 ; first header for patient
"RTN","PSGCAPP0",5,0)
 I $E(IOST,1)="C" K DIR S DIR(0)="E" D ^DIR K DIR S:$D(DTOUT)!$D(DUOUT) PSJDLW=1 I $D(DTOUT)!$D(DUOUT) Q
"RTN","PSGCAPP0",6,0)
 S (N,DF)=0,PSEX=$P(PI,"^"),PDOB=$P(PI,"^",2),PID=$P(PI,"^",3),RB=$P(PI,"^",5),AD=$P(PI,"^",6),TD=$P(PI,"^",7),WT=$P(PI,"^",8),WTD=$P(PI,"^",9),HT=$P(PI,"^",10),HTD=$P(PI,"^",11),PPN=$P(PI,"^",12),PI=$P(PI,"^",4),PSGP=$P(PN,"^",2)
"RTN","PSGCAPP0",7,0)
 S PAGE=$P(PDOB,";",2),PDOB=$P(PDOB,";"),PG=1
"RTN","PSGCAPP0",8,0)
 W:$Y @IOF W !?26,"UNIT DOSE ACTION PROFILE #2",?62,PSGPDT,!?+PSGVAMC,$P(PSGVAMC,U,2),!?23,"(Continuation of VA FORM 10-1158)",?72,"Page: 1",!,LINE
"RTN","PSGCAPP0",9,0)
 W !,"   A new order must be written for any new medication or to make any changes",!," in dosage or directions on an existing order.",!,LINE
"RTN","PSGCAPP0",10,0)
 W !?32-(PSGAPS="P"*13),$S(PSGAPS="T":"Team: ",1:"Treating Provider: "),PS1,!?1,PPN,?32,"Ward: "_WD,!?4,"PID: "_PID W:'PSJPDD ?28 W:PSJPDD ?23,"Last " W "Room-Bed: ",RB,?53,"Ht(cm): ",HT," ",HTD
"RTN","PSGCAPP0",11,0)
 W !?4,"DOB: "_PDOB_"  ("_PAGE_")",?53,"Wt(kg): "_WT," ",WTD
"RTN","PSGCAPP0",12,0)
 W !?4,"Sex: "_PSEX,?51,"Admitted: "_AD
"RTN","PSGCAPP0",13,0)
 ;
"RTN","PSGCAPP0",14,0)
 W !?5,"Dx: "_PI W:TD ?43,"Last Transferred: "_TD
"RTN","PSGCAPP0",15,0)
 ;   Display serum creatinine if CrCl can't be calculated
"RTN","PSGCAPP0",16,0)
 S PSJBSA=$$BSA^PSSDSAPI(DFN),PSJBSA=$P(PSJBSA,"^",3),PSJBSA=$S(PSJBSA'>0:"_________",1:$J(PSJBSA,4,2))
"RTN","PSGCAPP0",17,0)
 S RSLT=$$CRCL^PSJLMHED(DFN)
"RTN","PSGCAPP0",18,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)<.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_" (CREAT: Not Found)"
"RTN","PSGCAPP0",19,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"  (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSGCAPP0",20,0)
 I ($P($G(RSLT),"^",2)>0)&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"(est.)"_" (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSGCAPP0",21,0)
 W !?2,ZDSPL,?51,"BSA (m2): ",$G(PSJBSA) K ZDSPL,RSLT,PSJBSA
"RTN","PSGCAPP0",22,0)
 ;  
"RTN","PSGCAPP0",23,0)
 S PSGP=$P(PN,U,2) S:PSGP=$G(PSGPTMP) PPAGE=PPAGE+1 I PSGP'=$G(PSGPTMP) S PSGPTMP=PSGP,PPAGE=1
"RTN","PSGCAPP0",24,0)
 S ALFLG=0 D ATS^PSJMUTL(68,68,2)
"RTN","PSGCAPP0",25,0)
 ; PSJ*5*169 Make the allergy/ADR algorithm consistent with one used in PSJHEAD for AP-1 report.
"RTN","PSGCAPP0",26,0)
 W !?1,"Allergies: " D:PSGALG+PSGVALG+PSGADR+PSGVADR=0 NONE I PSGALG+PSGVALG+PSGADR+PSGVADR>0 D ALG^PSJHEAD,ADR^PSJHEAD I ALFLG D
"RTN","PSGCAPP0",27,0)
 .W "See patient's first ",$S($E(IOST)="C":"screen",1:"page")," for Allergies/Adverse Reactions"
"RTN","PSGCAPP0",28,0)
 W !,LINE,!,"No. Action",?16,"Drug",?46,"ST Start Stop  Status/Info",!,ALN
"RTN","PSGCAPP0",29,0)
 Q
"RTN","PSGCAPP0",30,0)
NONE ;    
"RTN","PSGCAPP0",31,0)
 ;W:$E(IOST)="P" "______________________________" W !?7,"ADR: " W:$E(IOST)="P" "____________________________________"
"RTN","PSGCAPP0",32,0)
 W "No Allergy Assessment" W !?7,"ADR: " W:$E(IOST)="P" "____________________________________"
"RTN","PSGCAPP0",33,0)
 Q
"RTN","PSGCAPP0",34,0)
ALG ; NOT USED ANYMORE, ALG^PSJHEAD    
"RTN","PSGCAPP0",35,0)
 I PPAGE>1&((PSGALG'<68)!(PSGADR'<63)) S ALFLG=1 Q
"RTN","PSGCAPP0",36,0)
 S KKA=0 F  S KKA=$O(PSGALG(KKA)) Q:'KKA  W:KKA>1 !?12 W PSGALG(KKA)
"RTN","PSGCAPP0",37,0)
 Q
"RTN","PSGCAPP0",38,0)
ADR ; NOT USED ANYMORE, ADR^PSJHEAD 
"RTN","PSGCAPP0",39,0)
 Q:ALFLG
"RTN","PSGCAPP0",40,0)
 W !?7,"ADR: "
"RTN","PSGCAPP0",41,0)
 S KKA=0 F  S KKA=$O(PSGADR(KKA)) Q:'KKA  W:KKA>1 !?12 W PSGADR(KKA)
"RTN","PSGCAPP0",42,0)
 Q
"RTN","PSGCAPP0",43,0)
 ;
"RTN","PSGCAPP0",44,0)
ENRCT ;
"RTN","PSGCAPP0",45,0)
 N DFN,GMRA,GMRAL,RCT,X S DFN=PSGP,GMRA="0^0^111" D ^GMRADPT
"RTN","PSGCAPP0",46,0)
 S X=0 F  S X=$O(GMRAL(X)) Q:'X  I $P(GMRAL(X),U,2)]"" S RCT($P(GMRAL(X),U,2))=""
"RTN","PSGCAPP0",47,0)
 ;W:'$D(RCT) "____________________" S RCT="" F X=1:1 S RCT=$O(RCT(RCT)) Q:RCT=""  W:X>1 "," W:$X+$L(RCT)>77 ! W " ",RCT
"RTN","PSGCAPP0",48,0)
 W:'$D(RCT) "No Allergy Assessment" S RCT="" F X=1:1 S RCT=$O(RCT(RCT)) Q:RCT=""  W:X>1 "," W:$X+$L(RCT)>77 ! W " ",RCT
"RTN","PSGCAPP0",49,0)
 W !,LINE,!," No.",?11,"Drug",?46,"ST Start Stop  Status/Info",!,ALN
"RTN","PSGCAPP0",50,0)
 Q
"RTN","PSGOD")
0^11^B27720964
"RTN","PSGOD",1,0)
PSGOD ;BIR/CML3-CREATES NEW ORDER FROM OLD ONE ;22 SEP 97 / 2:56 PM 
"RTN","PSGOD",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**67,58,111,133,181,286,281,315,256**;16 DEC 97;Build 34
"RTN","PSGOD",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSGOD",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSGOD",5,0)
 ;
"RTN","PSGOD",6,0)
 ;*286 - Do not allow copied Unit Dose orders for outpatients
"RTN","PSGOD",7,0)
 D INP^VADPT I 'VAIN(4) W !,"You cannot copy Unit Dose orders for this patient!" H 2 Q
"RTN","PSGOD",8,0)
 I $P($G(^PS(55,PSGP,5,+PSJORD,0)),"^",22) D  Q
"RTN","PSGOD",9,0)
 .W !,"This order is marked 'Not To Be Given' and can't be copied!" H 2
"RTN","PSGOD",10,0)
 F  W !!,"Do you want to copy this order" S %=2 D YN^DICN Q:%  D CH
"RTN","PSGOD",11,0)
 G:%'=1 DONE
"RTN","PSGOD",12,0)
 ;
"RTN","PSGOD",13,0)
 W !!,"...copying..." N OLDON
"RTN","PSGOD",14,0)
 K PSGORQF
"RTN","PSGOD",15,0)
 N PSGPDRG,Q
"RTN","PSGOD",16,0)
 NEW PSJOLDNM
"RTN","PSGOD",17,0)
 S PSGOEPR=$P($G(^PS(55,PSGP,5.1)),"^",2),OLDON=PSGORD,Q=""
"RTN","PSGOD",18,0)
 K PSGODN S F=$S(PSGORD["P":"^PS(53.1,"_+PSGORD_",",1:"^PS(55,"_PSGP_",5,"_+PSGORD_",") F N=0,.2,2,2.1,6 S PSGODN(N)=$G(@(F_N_")"))
"RTN","PSGOD",19,0)
 S PSGPR=$P(PSGODN(0),"^",2),PSGMR=$P(PSGODN(0),"^",3),PSGSM=$P(PSGODN(0),"^",5),PSGHSM=$P(PSGODN(0),"^",6),PSGST=$P(PSGODN(0),"^",7)
"RTN","PSGOD",20,0)
 S PSGPDRG=+PSGODN(.2),PSGDO=$P(PSGODN(.2),"^",2)
"RTN","PSGOD",21,0)
 ;*315
"RTN","PSGOD",22,0)
 S:$G(PSGODN(2.1))]"" PSGDUR=+PSGODN(2.1),PSGRMVT=$P(PSGODN(2.1),U,2),PSGRMV=$P(PSGODN(2.1),U,3),PSGRF=$P(PSGODN(2.1),U,4)
"RTN","PSGOD",23,0)
 S PSGSI=PSGODN(6)
"RTN","PSGOD",24,0)
 ; The naked reference below refers to the full reference inside indirection to ^PS(55,PSGP,5,+PSGORD, or ^PS(55,PSGP,"IV",+PSGORD, or ^PS(53.1,+PSGORD
"RTN","PSGOD",25,0)
 S PSGODN(3)=0 F Q=0:0 S Q=$O(@(F_"3,"_Q_")")) Q:'Q  I $D(^(Q,0)) S PSGODN(3,Q)=^(0),PSGODN(3)=PSGODN(3)+1 S ^PS(53.45,PSJSYSP,1,Q,0)=^(0)
"RTN","PSGOD",26,0)
 ;S:PSGODN(12)>0 ^PS(53.45,PSJSYSP,4,0)="^53.4504" S:PSGODN(3)>0 ^PS(53.45,PSJSYSP,1,0)="^53.4501"
"RTN","PSGOD",27,0)
 S:PSGODN(3)>0 ^PS(53.45,PSJSYSP,1,0)="^53.4501"
"RTN","PSGOD",28,0)
 ; The naked reference below refers to the full reference inside indirection to ^PS(55,PSGP,5,+PSGORD, or ^PS(55,PSGP,"IV",+PSGORD, or ^PS(53.1,+PSGORD  
"RTN","PSGOD",29,0)
 S (PSGODN(1),Q)=0 F  S Q=$O(@(F_"1,"_Q_")")) Q:'Q  S ND=$G(^(Q,0)) I ND,'$P(ND,"^",3) D
"RTN","PSGOD",30,0)
 . S PSGODN(1)=PSGODN(1)+1,PSGODN(1,PSGODN(1))=$P(ND,"^",1,2)
"RTN","PSGOD",31,0)
 . S ^PS(53.45,PSJSYSP,2,PSGODN(1),0)=^(0),^PS(53.45,PSJSYSP,2,0)="^53.4502P^"_+PSGODN(1)_U_+PSGODN(1)
"RTN","PSGOD",32,0)
 S PSGS0Y=$P(PSGODN(2),"^",5),PSGS0XT=$P(PSGODN(2),"^",6),PSGNESD="",PSGSCH=$P(PSGODN(2),U)
"RTN","PSGOD",33,0)
 ;PSJ*5*256
"RTN","PSGOD",34,0)
 S PSJOLDNM("ORD_SCHD")=PSGSCH
"RTN","PSGOD",35,0)
 I $$CHKSCHD^PSJMISC2(.PSJOLDNM) W !!,"Order not copied." D PAUSE^VALM1 K PSJOLDNM G ORIG
"RTN","PSGOD",36,0)
 S:$G(PSJOLDNM("NEW_SCHD"))]"" PSGSCH=PSJOLDNM("NEW_SCHD") K PSJOLDNM
"RTN","PSGOD",37,0)
 S PSGODF=1,PSGNEDFD=$P($$GTNEDFD^PSGOE7("U",+PSGPDRG),U)_"^^"_PSGST_"^"_PSGSCH
"RTN","PSGOD",38,0)
 W "." D ^PSGNE3
"RTN","PSGOD",39,0)
 K PSGEFN,PSGOEEF,PSGOEE,PSGOEOS S PSGEFN="1:13" F X=1:1:13 S PSGEFN(X)=""
"RTN","PSGOD",40,0)
 S PSGPDN=$$OINAME^PSJLMUTL(PSGPDRG),PSGOINST="",PSGSDN=$$ENDD^PSGMI(PSGNESD)_U_$$ENDTC^PSGMI(PSGNESD),PSGFDN=$$ENDD^PSGMI(PSGNEFD)_U_$$ENDTC^PSGMI(PSGNEFD)
"RTN","PSGOD",41,0)
 S PSGAT=PSGS0Y,PSGEBN=DUZ,PSGLIN=$$ENDD^PSGMI(PSGDT)_U_$$ENDTC^PSGMI(PSGDT),PSGEBN=$$ENNPN^PSGMI(DUZ),PSGSTAT=$S(PSGOEAV:"ACTIVE",1:"NON-VERIFIED")
"RTN","PSGOD",42,0)
 W "." D CHK^PSGOEV("^^"_PSGMR_"^^^^"_PSGST,PSGPDRG_U_PSGDO,PSGSCH_U_PSGNESD_"^^"_PSGNEFD)
"RTN","PSGOD",43,0)
 I $G(PSGSCH)]"" D
"RTN","PSGOD",44,0)
 .N X S X=PSGSCH N SWD,SDW,XABB,QX D ENOS^PSGS0 I $G(X)=""!$G(PSJNSS) S CHK=1 K PSJNSS Q
"RTN","PSGOD",45,0)
 .I $G(PSGAT)="",$G(PSGS0Y) S PSGAT=PSGS0Y
"RTN","PSGOD",46,0)
 .I $G(PSGAT),($G(PSGS0Y)="") S PSGS0Y=PSGAT
"RTN","PSGOD",47,0)
 .I $G(PSGS0XT)="D",$G(PSGS0Y)="" S CHK=1 D  K PSJNSS
"RTN","PSGOD",48,0)
 ..W ! K DIR S DIR(0)="FOA",DIR("A")="   WARNING - Admin times are required for DAY OF WEEK schedules    " D ^DIR K DIR
"RTN","PSGOD",49,0)
 S PSGSD=PSGNESD,PSGFD=PSGNEFD
"RTN","PSGOD",50,0)
 K PSJACEPT S VALMBCK="Q" D:$D(Y) EN^VALM("PSJU LM ACCEPT")
"RTN","PSGOD",51,0)
 I $G(PSJACEPT)=1 D OC S:$D(PSGORQF) PSJACEPT=0 S:$G(PSJACEPT)=1 VALMBCK="",PSJNOO=$$ENNOO^PSJUTL5("N")
"RTN","PSGOD",52,0)
 I '$G(PSJACEPT)!($G(PSJNOO)<0) W:'$G(PSJCOFLG) !!,"Order not copied." D PAUSE^VALM1:'$G(PSJCOFLG) G ORIG    ;PSJCOFLG set in PSODGAL1 for allergies
"RTN","PSGOD",53,0)
 S PSGNESD=PSGSD,PSGNEFD=PSGFD
"RTN","PSGOD",54,0)
 K PSGOEE D ^PSGOETO S PSJORD=PSGORD I PSGOEAV D
"RTN","PSGOD",55,0)
 .I '$D(PSGOEE),+PSJSYSU=3 D EN^PSGPEN(PSGORD)
"RTN","PSGOD",56,0)
 .D SETOC^PSJNEWOC(PSGORD) ;RTC 178789 Store allergy if auto vf is on
"RTN","PSGOD",57,0)
 D GETUD^PSJLMGUD(PSGP,PSGORD),ENSFE^PSGOEE0(PSGP,PSGORD),^PSGOE1,EN^VALM("PSJ LM UD ACTION")
"RTN","PSGOD",58,0)
 ;RTC 178789 - store allery if not verified the newly copied order
"RTN","PSGOD",59,0)
 I ($G(PSGORD)["P"),($P($G(^PS(53.1,+PSGORD,0)),U,9)="N"),($G(PSJOCFG)="COPY UD") D SETOC^PSJNEWOC(PSGORD)
"RTN","PSGOD",60,0)
 ;
"RTN","PSGOD",61,0)
 S PSGCANFL=0,(PSGORD,PSJORD)=OLDON W !!,"You are finished with the new order.",!,"The following ACTION prompt is for the original order."
"RTN","PSGOD",62,0)
 K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","PSGOD",63,0)
ORIG ;Redisplay original order
"RTN","PSGOD",64,0)
 D GETUD^PSJLMGUD(PSGP,OLDON),INIT^PSJLMUDE(PSGP,OLDON)
"RTN","PSGOD",65,0)
DONE ;
"RTN","PSGOD",66,0)
 K %,%H,%I,DA,F,N,PSGODN,PSGODF,PSGS0XT,PSGS0Y,PSGNESD,PSGTOL,PSGTOO,PSGUOW,X,Y,^PS(53.45,PSJSYSP,1),^PS(53.45,PSJSYSP,2)
"RTN","PSGOD",67,0)
 K PSGPR,PSGMR,PSGSM,PSGHSM,PSGST,PSGPDRG,PSGDO,PSGNEDFD,PSGSCH,PSGNEFD
"RTN","PSGOD",68,0)
 Q
"RTN","PSGOD",69,0)
 ;
"RTN","PSGOD",70,0)
CH ;
"RTN","PSGOD",71,0)
 W !!?2,"Answer 'YES' to have a new, non-verified order created for this patient,",!,"using the information from this order.  (The START and STOP dates will be",!,"recalculated.)  Enter 'NO' (or '^') to stop now." Q
"RTN","PSGOD",72,0)
 ;
"RTN","PSGOD",73,0)
WH ;
"RTN","PSGOD",74,0)
 W !!?2,"Answer 'YES' to take action on this new order.  Enter 'NO' (or '^') to return",!,"to the original order now." Q
"RTN","PSGOD",75,0)
 ;
"RTN","PSGOD",76,0)
OC ;Perform order checks
"RTN","PSGOD",77,0)
 NEW PSJDD,X,PSJALLGY
"RTN","PSGOD",78,0)
 ;*286 - Order checks on current dispense drugs
"RTN","PSGOD",79,0)
 F X=0:0 S X=$O(^PS(53.45,PSJSYSP,2,X)) Q:'X  D
"RTN","PSGOD",80,0)
 . S PSJDD=$G(^PS(53.45,PSJSYSP,2,X,0))
"RTN","PSGOD",81,0)
 . I +PSJDD S PSJALLGY(+PSJDD)=""
"RTN","PSGOD",82,0)
 ;S X=+$O(PSGODN(1,0)) Q:'X  S PSJDD=+$G(PSGODN(1,X)) Q:'PSJDD
"RTN","PSGOD",83,0)
 S PSJDD=+$O(PSJALLGY(0)) Q:'PSJDD
"RTN","PSGOD",84,0)
 D FULL^VALM1
"RTN","PSGOD",85,0)
 D ENDDC^PSGSICHK($G(PSGP),PSJDD) Q:$D(PSGORQF)
"RTN","PSGOD",86,0)
 D IN^PSJOCDS($G(PSGORD),"UD",PSJDD)
"RTN","PSGOD",87,0)
 Q
"RTN","PSGOEF")
0^9^B125998243
"RTN","PSGOEF",1,0)
PSGOEF ;BIR/CML3 - FINISH ORDERS ENTERED THROUGH OE/RR ;14 May 98  2:17 PM
"RTN","PSGOEF",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**7,30,29,35,39,47,50,56,80,116,110,111,133,153,134,222,113,181,260,199,281,315,256**;16 DEC 97;Build 34
"RTN","PSGOEF",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSGOEF",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSGOEF",5,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192
"RTN","PSGOEF",6,0)
 ; Reference to DOSE^PSSORPH is supported by DBIA 3234.
"RTN","PSGOEF",7,0)
 ; Reference to ^TMP("PSODAOC",$J is supported by DBIA 6071.
"RTN","PSGOEF",8,0)
 ; Reference to FULL^VALM1 is supported by DBIA 10116.
"RTN","PSGOEF",9,0)
 ; Reference to ^PS(50.7 is supported by DBIA# 2180
"RTN","PSGOEF",10,0)
 ;
"RTN","PSGOEF",11,0)
START ;
"RTN","PSGOEF",12,0)
 I '$D(^PS(53.1,+PSGORD)) W $C(7),!?3,"Cannot find this pending order (#",+PSGORD,")." Q
"RTN","PSGOEF",13,0)
 D NOW^%DTC S PSGDT=+$E(%,1,12) K PSGFDX,PSGEFN,PSGOEEF,PSGOES,PSGONF,PSGRDTX S PSGOES=1,(PSGOEF,PSGOEEF)=0,PSGOEEG=3
"RTN","PSGOEF",14,0)
 I $D(PSJTUD) S PSGDO=$P($G(^PS(53.1,+PSGORD,.3)),U),(PSGPDRG,PSGPD)=PSJCOI,(PSGPDRGN,PSGPDN)=$$OINAME^PSJLMUTL(PSGPD)
"RTN","PSGOEF",15,0)
 I $P($G(^PS(53.1,+PSGORD,0)),U,24)'="R" S X=PSGSCH D EN^PSGORS0 D
"RTN","PSGOEF",16,0)
 . S:($D(X)&($P($G(^PS(53.1,+PSGORD,2)),"^",5)="")&($P($G(^PS(53.1,+PSGORD,0)),"^",24)="N")) PSGAT=PSGS0Y
"RTN","PSGOEF",17,0)
 . NEW PSJDOX,PSJDOSE,PSJPIECE,PSJUNIT,PSJX,X
"RTN","PSGOEF",18,0)
 . S X=$G(^PS(53.1,+PSGORD,1,1,0)) Q:'+X
"RTN","PSGOEF",19,0)
 . D DOSE^PSSORPH(.PSJDOX,+X,"U")
"RTN","PSGOEF",20,0)
 . I $S('$D(PSJDOX):1,1:+PSJDOX(1)=-1) Q
"RTN","PSGOEF",21,0)
 . S PSJPIECE=$S($P(PSJDOX(1),U)="":3,1:1)
"RTN","PSGOEF",22,0)
 . S X=^PS(53.1,+PSGORD,.2)
"RTN","PSGOEF",23,0)
 . S:PSJPIECE=3 PSJDOSE=$P(X,U,2)
"RTN","PSGOEF",24,0)
 . S:PSJPIECE=1 PSJDOSE=$P(X,U,5),PSJUNIT=$P(X,U,6)
"RTN","PSGOEF",25,0)
 . F X=0:0 S X=$O(PSJDOX(X)) Q:+$G(PSJX)!'X  D
"RTN","PSGOEF",26,0)
 .. I PSJPIECE=3,($P(PSJDOX(X),U,3)'=PSJDOSE) Q
"RTN","PSGOEF",27,0)
 .. I PSJPIECE=1,($P(PSJDOX(X),U,1)_$P(PSJDOX(X),U,2)'=(PSJDOSE_PSJUNIT)) Q
"RTN","PSGOEF",28,0)
 .. S:+$P(PSJDOX(X),U,12) $P(^PS(53.45,PSJSYSP,2,1,0),U,2)=+$P(PSJDOX(X),U,12),PSJX=1
"RTN","PSGOEF",29,0)
 I PSGEB'=PSGOPR F X=7,11 S Y=$T(@(3_X)),@("PSGEFN("_X_")="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))="",PSGOEEF=PSGOEEF+1
"RTN","PSGOEF",30,0)
 D GTST^PSGOE6(+PSGORD)
"RTN","PSGOEF",31,0)
 I $P($G(^PS(53.1,+PSGORD,0)),U,24)'="R" S PSGSD="" D:PSGS0Y]""
"RTN","PSGOEF",32,0)
 .N PSJX S PSJX=$P($G(^PS(53.1,+PSGORD,0)),U,25) I PSJX="" Q
"RTN","PSGOEF",33,0)
 .I PSJX["U" S PSGSD=$P($G(^PS(55,DFN,5,+PSJX,2)),U,2) Q
"RTN","PSGOEF",34,0)
 .I PSJX["V" S PSGSD=$P($G(^PS(55,DFN,"IV",+PSJX,0)),U,2) Q
"RTN","PSGOEF",35,0)
 .I PSJX["P" S PSGSD=$P($G(^PS(53.1,+PSJX,2)),U,2)
"RTN","PSGOEF",36,0)
 S:PSGSD="" PSGSD=PSGLI
"RTN","PSGOEF",37,0)
 S PSGNEDFD=$$GTNEDFD^PSGOE7("U",+PSGPD)
"RTN","PSGOEF",38,0)
 S:$P($G(PSGNEDFD),U,3)="" $P(PSGNEDFD,U,3)=PSGST  ; N PSGOEA S PSGOEA="R"
"RTN","PSGOEF",39,0)
 S (PSGNESD,PSGSD)=$$ENSD^PSGNE3(PSGSCH,PSGS0Y,PSGLI,PSGSD)
"RTN","PSGOEF",40,0)
 ;if this is a renewal order, ignore any 'requested start date' received.  Use the system calculated start date.
"RTN","PSGOEF",41,0)
 I $P($G(^PS(53.1,+PSGORD,0)),U,24)'="R" D
"RTN","PSGOEF",42,0)
 . D REQDT^PSJLIVMD(PSGORD)
"RTN","PSGOEF",43,0)
 E  D
"RTN","PSGOEF",44,0)
 . S X=$$DSTART^PSJDCU(DFN,$P(^PS(53.1,+PSGORD,0),U,25)) I X]"" S (PSGNESD,PSGSD)=X K PSGRSD
"RTN","PSGOEF",45,0)
 D   ; Extend the Default Stop Date if needed for the first renewed order.
"RTN","PSGOEF",46,0)
 .N PSGOEAO,PSGWALLO
"RTN","PSGOEF",47,0)
 .I $P($G(^PS(53.1,+PSGORD,0)),U,24)="R" S PSGOEAO=PSGOEA,PSGOEA="R",PSGWALLO=$P(^PS(55,DFN,5.1),U)
"RTN","PSGOEF",48,0)
 .D ENFD^PSGNE3(PSGLI) S PSGFD=$S($G(PSGRDTX(+PSGORD,"PSGFD")):PSGRDTX(+PSGORD,"PSGFD"),1:PSGNEFD)
"RTN","PSGOEF",49,0)
 .I $P($G(^PS(53.1,+PSGORD,0)),U,24)="R" S PSGOEA=PSGOEAO,$P(^PS(55,DFN,5.1),U)=PSGWALLO
"RTN","PSGOEF",50,0)
 N DUR,PSGRNSD S PSGRNSD=+$$LASTREN^PSJLMPRI(DFN,PSGORD) I PSGRNSD S DUR=$$GETDUR^PSJLIVMD(DFN,PSGORD,"P",1) I DUR]"" D
"RTN","PSGOEF",51,0)
 . N DURMIN S DURMIN=$$DURMIN^PSJLIVMD(DUR) I DURMIN S PSGFD=$$FMADD^XLFDT(PSGRNSD,,,DURMIN)
"RTN","PSGOEF",52,0)
 S PSGOFD="",PSGSDN=$$ENDD^PSGMI(PSGSD)_U_$$ENDTC^PSGMI(PSGSD),PSGFDN=$$ENDD^PSGMI(PSGFD)_U_$$ENDTC^PSGMI(PSGFD)
"RTN","PSGOEF",53,0)
 S PSGLIN=$$ENDD^PSGMI(PSGLI)_U_$$ENDTC^PSGMI(PSGLI)
"RTN","PSGOEF",54,0)
 I '$O(^PS(53.45,PSJSYSP,2,0)) N DRG,DRGCNT S DRGCNT=0 D
"RTN","PSGOEF",55,0)
 .F X=0:0 S X=$O(^PSDRUG("ASP",+PSGPD,X)) Q:'X!(DRGCNT>1)  S:$P($G(^PSDRUG(+X,2)),U,3)["U" DRGCNT=DRGCNT+1,DRG=+X
"RTN","PSGOEF",56,0)
 .I DRGCNT=1 K ^PS(53.45,PSJSYSP,2) S ^PS(53.45,PSJSYSP,2,1,0)=DRG_U_1,^PS(53.45,PSJSYSP,2,0)="^53.4502^1^1",PS(53.45,PSJSYSP,2,"B",+DRG,1)=""
"RTN","PSGOEF",57,0)
 Q
"RTN","PSGOEF",58,0)
FINISH ;
"RTN","PSGOEF",59,0)
 ; force display of second screen if CPRS order checks exist
"RTN","PSGOEF",60,0)
 N NSFF,PSGOEF39,PSGEDTOI S NSFF=1 K PSJNSS,PSGEDTOI,PSGOEER,ZZND
"RTN","PSGOEF",61,0)
 N PSJRMABT,PSJOLDNM
"RTN","PSGOEF",62,0)
 I $G(PSGORD),$D(PSGRDTX(+PSGORD)) D  K PSGRDTX
"RTN","PSGOEF",63,0)
 . ;PSJOCDSC stores the default start & stop date ^ cal start & stop date (use in dosing calculation for duration)
"RTN","PSGOEF",64,0)
 . ;for some reasons PSGSD & PSGFD are reset to the cal dates if order has duration defined
"RTN","PSGOEF",65,0)
 . S PSJOCDSC("CX","PSGSD",+PSGORD)=$G(PSGSD)_U_$G(PSGRDTX(+PSGORD,"PSGRSD"))
"RTN","PSGOEF",66,0)
 . S PSJOCDSC("CX","PSGFD",+PSGORD)=$G(PSGFD)_U_$G(PSGRDTX(+PSGORD,"PSGRFD"))
"RTN","PSGOEF",67,0)
 . S:$G(PSGRDTX(+PSGORD,"PSGRSD")) PSGSD=PSGRDTX(+PSGORD,"PSGRSD")
"RTN","PSGOEF",68,0)
 . S:$G(PSGRDTX(+PSGORD,"PSGRFD")) PSGFD=$S($G(PSGRDTX(+PSGORD,"PSGRFD")):PSGRDTX(+PSGORD,"PSGRFD"),1:$G(PSGNEFD))
"RTN","PSGOEF",69,0)
 N PSJCOM S PSJCOM=+$P($G(^PS(53.1,+PSGORD,.2)),"^",8)
"RTN","PSGOEF",70,0)
 ; 
"RTN","PSGOEF",71,0)
 ; PSJ*5*222
"RTN","PSGOEF",72,0)
 ; PSJCT1 is a counter variable.  Every piece of a complex order calls PSGOEF.
"RTN","PSGOEF",73,0)
 ; The only time this code is to look for overlapping admin times is when the
"RTN","PSGOEF",74,0)
 ; first part of a complex order is being finished.  This variable will keep track
"RTN","PSGOEF",75,0)
 ; of how many "parts" of the complex order have been checked.
"RTN","PSGOEF",76,0)
 ; 
"RTN","PSGOEF",77,0)
 ; Also, since the user can select multiple complex orders to finish, like selecting
"RTN","PSGOEF",78,0)
 ; orders 1-2 or 1-3 from the profile, PSJCT1A will keep track of whether the parent
"RTN","PSGOEF",79,0)
 ; order number is the same as the first parent order number selected for finishing.
"RTN","PSGOEF",80,0)
 ; Since the PSJCT1 counter variable will still be set if multiple complex orders
"RTN","PSGOEF",81,0)
 ; are selected, PSJCT1 will be re-set to 1 if the parent complex order number (PSJCT1A) is
"RTN","PSGOEF",82,0)
 ; not equal to the original parent order number (PSJCOM).
"RTN","PSGOEF",83,0)
 ; 
"RTN","PSGOEF",84,0)
 S PSJCT1=$G(PSJCT1)+1
"RTN","PSGOEF",85,0)
 I PSJCT1=1 S PSJCT1A=PSJCOM
"RTN","PSGOEF",86,0)
 I $G(PSJCT1A)'=PSJCOM S PSJCT1=1,PSJCT1A=PSJCOM
"RTN","PSGOEF",87,0)
 ; End of flag setting for PSJ*5*222
"RTN","PSGOEF",88,0)
 D FULL^VALM1
"RTN","PSGOEF",89,0)
 I '$D(IOINORM)!('$D(IOINHI)) S X="IORVOFF;IORVON;IOINHI;IOINORM" D ENDR^%ZISS
"RTN","PSGOEF",90,0)
 I $G(PSJCOM)'="",$G(PSJCT1)=1 D
"RTN","PSGOEF",91,0)
 . D OVERLAP^PSGOEF2 I $G(PSJOVRLP)=1 D
"RTN","PSGOEF",92,0)
 . . N X,X1,DIR
"RTN","PSGOEF",93,0)
 . . W !!,"**WARNING**"
"RTN","PSGOEF",94,0)
 . . W !,"The highlighted admin times for these portions of this complex order overlap.",!!
"RTN","PSGOEF",95,0)
 . . S (X,X1)="" F  S X=$O(^TMP("PSJATOVR",$J,X)) Q:X=""  D
"RTN","PSGOEF",96,0)
 . . . S X1=$G(^TMP("PSJATOVR",$J,X))
"RTN","PSGOEF",97,0)
 . . . W $S($P(X1,"^",4)=1:IORVON,1:""),"Part "_X,IORVOFF," has a schedule of "_$P(X1,"^",2)_" and admin time(s) of "
"RTN","PSGOEF",98,0)
 . . . W $S($P(X1,"^",4)=1:IORVON,1:""),$P(X1,"^",3),IORVOFF
"RTN","PSGOEF",99,0)
 . . . W !
"RTN","PSGOEF",100,0)
 . . . W $S($G(PSJOVR("CONJ",X))="A":"AND",$G(PSJOVR("CONJ",X))="T":"THEN",1:""),!
"RTN","PSGOEF",101,0)
 . . W !,"Please ensure the schedules and administration times are appropriate.",!
"RTN","PSGOEF",102,0)
 . . S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR W !
"RTN","PSGOEF",103,0)
 K ^TMP("PSJATOVR",$J)
"RTN","PSGOEF",104,0)
 I $G(PSJPROT)=3,'$D(PSJTUD),'$$ENIVUD^PSGOEF1(PSGORD) Q
"RTN","PSGOEF",105,0)
 ;*** PSJ*5*256
"RTN","PSGOEF",106,0)
 S PSJOLDNM("ORD_SCHD")=PSGOSCH
"RTN","PSGOEF",107,0)
 I $$CHKSCHD^PSJMISC2(.PSJOLDNM,$S($P($G(^PS(53.1,+PSGORD,0)),U,24)="R":"R",1:"")) S PSGORQF=1,VALMBCK="R" D DONE Q
"RTN","PSGOEF",108,0)
 S:$G(PSJOLDNM("NEW_SCHD"))]"" PSGSCH=PSJOLDNM("NEW_SCHD")
"RTN","PSGOEF",109,0)
 I $G(PSGOSCH)]"" D  S:$G(PSGS0XT)'="" $P(^PS(53.1,+PSGORD,2),"^",6)=PSGS0XT
"RTN","PSGOEF",110,0)
 .N PSGOES,PSGS0Y,PSGSCH S X=$S($G(PSJOLDNM("NEW_SCHD"))]"":PSJOLDNM("NEW_SCHD"),1:PSGOSCH) K:$G(PSJTUD) NSFF D ENOS^PSGS0
"RTN","PSGOEF",111,0)
 .I '($G(PSGORD)["P"&($P($G(^PS(53.1,+PSGORD,0)),"^",24)="R")) I $G(X)]""&$G(PSGS0Y) S:$G(PSGAT)="" PSGAT=PSGS0Y
"RTN","PSGOEF",112,0)
 .I $G(PSJNSS) S PSGOSCH="" K PSJNSS
"RTN","PSGOEF",113,0)
 .I $G(PSGORD)["P",$G(PSGAT),$G(PSGS0Y),($G(PSGOSCH)]"") I PSGAT'=PSGS0Y D
"RTN","PSGOEF",114,0)
 ..S PSGNSTAT=1 W $C(7),!!,"PLEASE NOTE:  This order's admin times (",PSGAT,")"
"RTN","PSGOEF",115,0)
 ..W !?13," do not match the ward times (",PSGS0Y,")"
"RTN","PSGOEF",116,0)
 ..W !?13," for this administration schedule (",$S($G(PSJOLDNM("NEW_SCHD"))]"":PSJOLDNM("NEW_SCHD"),1:PSGOSCH),")",!
"RTN","PSGOEF",117,0)
 ..S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR K DIR  W !
"RTN","PSGOEF",118,0)
 I $G(PSGS0XT)="" S $P(^PS(53.1,+PSGORD,2),"^",6)=$S($P($G(ZZND),"^",3)'="":$P(ZZND,"^",3),1:"")
"RTN","PSGOEF",119,0)
 S CHK=0 S:$P($G(^PS(53.1,+PSGORD,0)),U,24)'="R" PSGSI=$$ENPC^PSJUTL("U",+PSJSYSP,180,PSGSI)
"RTN","PSGOEF",120,0)
 I '$G(PSJTUD),$G(PSJNSS),($G(PSGOSCH)]"") D NSSCONT^PSGS0(PSGOSCH,PSGS0XT) K PSJNSS S PSGOSCH=""
"RTN","PSGOEF",121,0)
 S PSGOEFF=PSGOSCH=""+('$O(^PS(53.45,PSJSYSP,2,0))*10)
"RTN","PSGOEF",122,0)
 I PSGOEFF S X=$S(PSGOEFF#2:" a SCHEDULE",1:"")_$S(PSGOEFF=11:" and",1:"")_$S(PSGOEFF>9:" at least one DISPENSE DRUG",1:"")
"RTN","PSGOEF",123,0)
 I 'PSGOEFF I (($G(PSGS0XT)="D")&($G(PSGAT)="")) S X=" Admin Times",PSGOEFF=1,PSGOEF39=1
"RTN","PSGOEF",124,0)
 ; *315 DRP If removal flag in 50.7 is a 2 or a 3 then order must be reviewed and removal times entered if required.
"RTN","PSGOEF",125,0)
 S PSGRF=$P($G(^PS(50.7,$G(PSGPDRG),4),0),U,1)
"RTN","PSGOEF",126,0)
 I +$G(PSGRF),$G(PSGDUR)="",'$G(PSGRMV),$D(^PS(51.1,"AC","PSJ",$G(PSGOSCH))) S PSJRMABT=0 D  I $G(PSJRMABT) D ABORTACC Q  ; Abort Finish process if no Stop Date entered ($G(PSJRMABT)) 
"RTN","PSGOEF",127,0)
 . N PSGTMPST S PSGTMPST=$S($G(PSGST)="R":$P($G(^PS(51.1,$O(^PS(51.1,"AC","PSJ",PSGOSCH,"")),0)),"^",5),1:$G(PSGST)) ;Handle "Fill on Request"
"RTN","PSGOEF",128,0)
 . I ($G(PSGTMPST)'="O"),($G(PSGTMPST)'="P"),($G(PSGTMPST)'="OC"),+$G(PSGRF)>1 S X="",PSGOEFF=1,PSGOEF39=1
"RTN","PSGOEF",129,0)
 . I $G(PSGTMPST)="O" S (PSGFDN,PSGFD)="" D 
"RTN","PSGOEF",130,0)
 .. S F1=53.1,MSG=0,Y=$T(35),@("PSGFN(35)="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))=1,(PSGOEE,PSGOEEF)=1 W ! D @$P($T(35),";",3) S CHK=0 I 'PSGOEE S PSJRMABT=1
"RTN","PSGOEF",131,0)
 .. W:PSJRMABT $C(7),!!,"INVALID STOP DATE"  S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR K DIR  W !
"RTN","PSGOEF",132,0)
 ..Q
"RTN","PSGOEF",133,0)
 .Q
"RTN","PSGOEF",134,0)
 ;
"RTN","PSGOEF",135,0)
 I PSGOEFF,X]"" S X=X_" before it can be finished."
"RTN","PSGOEF",136,0)
 I PSGOEFF,X]"" S CHK=1 W $C(7),!!,"PLEASE NOTE: This order must have" F Q=1:1:$L(X," ") S Y=$P(X," ",Q) W:$L(Y)+$X>78 ! W Y," "
"RTN","PSGOEF",137,0)
 I $G(PSGOEF39) S PSGOEE=0,PSGOEFF=0 D  I 'PSGOEE D REFRESH^VALM G DONE
"RTN","PSGOEF",138,0)
 .S F1=53.1,MSG=0,Y=$T(39),@("PSGFN(39)="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))=1,(PSGOEEF,PSGOEE)=1 W ! D @$P($T(39),";",3) S CHK=0
"RTN","PSGOEF",139,0)
 .I $G(PSGRMVT),'PSGOEE D INIT^PSJLMUDE($G(PSGP),$G(PSGORD)) ;*315 IF REMOVE TIME SET THEN REDISPLAY DETAIL
"RTN","PSGOEF",140,0)
 .Q
"RTN","PSGOEF",141,0)
 I PSGOEFF=1 S F1=53.1,MSG=0,Y=$T(38),@("PSGFN(38)="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))=1,(PSGOEE,PSGOEEF)=1 W ! D @$P($T(38),";",3) S CHK=0 G:'PSGOEE DONE
"RTN","PSGOEF",142,0)
 I PSGOEFF=11 S F1=53.1,MSG=0,Y=$T(32),@("PSGFN(32)="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))=1,(PSGOEE,PSGOEEF)=1 W ! D @$P($T(32),";",3) D  G:'PSGOEE DONE
"RTN","PSGOEF",143,0)
 .S F1=53.1,MSG=0,Y=$T(38),@("PSGFN(38)="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))=1,(PSGOEE,PSGOEEF)=1 W ! D @$P($T(38),";",3) S CHK=0
"RTN","PSGOEF",144,0)
 I PSGOEFF>9 S CHK=7 D ENDRG^PSGOEF1(+PSGPD,0) I CHK D ABORTACC Q
"RTN","PSGOEF",145,0)
 I 'PSGOEFF D OC531^PSGOESF ; check every dispense drug from CPRS
"RTN","PSGOEF",146,0)
 S VALMBG=1
"RTN","PSGOEF",147,0)
 I 'PSGOEFF&($D(PSGORQF)) D RE^VALM4 Q
"RTN","PSGOEF",148,0)
 I $G(MSG) K DIR S DIR(0)="E" W !! D ^DIR
"RTN","PSGOEF",149,0)
 I PSGOEFF D:PSGST="" GTST^PSGOE6(+PSGORD)
"RTN","PSGOEF",150,0)
 S PSJLMFIN=1
"RTN","PSGOEF",151,0)
 K PSJACEPT I $O(^PS(53.1,+PSGORD,12,0)) S PSJLMP2=1
"RTN","PSGOEF",152,0)
 S PSGOEENO=0,PSGSTAT=$S($P(PSJSYSP0,U,9):"ACTIVE",1:"NON-VERIFIED")
"RTN","PSGOEF",153,0)
 NEW PSJDOSE,PSJDOX,PSJDSFLG
"RTN","PSGOEF",154,0)
 D DOSECHK^PSJDOSE
"RTN","PSGOEF",155,0)
 S:+$G(PSJDSFLG) VALMSG="Dosage Ordered & Dispense Drug are not compatible"
"RTN","PSGOEF",156,0)
 I PSGODO=PSGDO S PSGOEEF(109)=""
"RTN","PSGOEF",157,0)
 I PSGODO'=PSGDO S PSGOEENO=1,VALMSG="This change will cause a new order to be created  "
"RTN","PSGOEF",158,0)
 D EN^VALM("PSJU LM ACCEPT")
"RTN","PSGOEF",159,0)
 I $G(PSJNSS) D  S PSGOEEF(26)="" K PSJACEPT,PSJNSS
"RTN","PSGOEF",160,0)
 .K DIR S DIR(0)="FOA",DIR("A")="Invalid Schedule" D ^DIR K DIR
"RTN","PSGOEF",161,0)
 I $G(PSGS0XT)="D",'$G(PSGS0Y),'$G(PSGAT),((",P,R,")'[(","_$G(PSGST)_",")) D  S PSGOEEF(39)="" K PSJACEPT
"RTN","PSGOEF",162,0)
 .K DIR S DIR(0)="FOA",DIR("A")="   WARNING - Admin times are required for DAY OF WEEK schedules  " D ^DIR K DIR
"RTN","PSGOEF",163,0)
 ;***PSJ*5*113
"RTN","PSGOEF",164,0)
 I $G(PSGAT)="",(PSGST="C"!(PSGST="R")) D
"RTN","PSGOEF",165,0)
 .I $G(PSGS0XT) Q:$$ODD^PSGS0(PSGS0XT)
"RTN","PSGOEF",166,0)
 .Q:$$PRNOK^PSGS0($G(PSGSCH))
"RTN","PSGOEF",167,0)
 .Q:($P($G(ZZND),"^",5)'="C")
"RTN","PSGOEF",168,0)
 .K PSJACEPT
"RTN","PSGOEF",169,0)
 .K DIR S DIR(0)="FOA",DIR("A")="  WARNING - Admin times are required for CONTINUOUS orders " D ^DIR K DIR
"RTN","PSGOEF",170,0)
 ;***
"RTN","PSGOEF",171,0)
 I '$G(PSJACEPT) D ABORTACC Q
"RTN","PSGOEF",172,0)
 I $G(PSJRNF),$G(^PS(53.1,+PSGORD,4)) D
"RTN","PSGOEF",173,0)
 . W $C(7),!!,"ACCEPTING THIS ORDER WILL CHANGE THE STATUS TO ACTIVE."
"RTN","PSGOEF",174,0)
 . S DIR(0)="Y",DIR("A")="Do you wish to make this order Active",DIR("?",1)="Enter ""N"" if you wish to exit without Activating this order,"
"RTN","PSGOEF",175,0)
 . S DIR("?")="or ""Y"" to continue with the Activation process." D ^DIR S:'Y Y=-1 K DIR
"RTN","PSGOEF",176,0)
 I $G(PSJRNF),$G(Y)=-1 S PSJACEPT=0 D ABORTACC Q
"RTN","PSGOEF",177,0)
 I $G(PSJRNF),$G(Y)=1 S PSGOEAV=1
"RTN","PSGOEF",178,0)
 I $G(PSGEDTOI) D OC^PSJOE1
"RTN","PSGOEF",179,0)
 I $S($G(PSGORQF):0,$G(PSGEDTOI):0,$G(PSGOEER)["109^PSGOE8":1,$G(PSGOEER)["3^PSGOE8":1,$G(PSGOEER)["26^PSGOE8":1,$G(PSGOEER)["10^PSGOE81":1,$G(PSGOEER)["25^PSGOE81":1,1:0) D
"RTN","PSGOEF",180,0)
 . NEW PSJDD S PSJDD=+$$DD53P45^PSJMISC()
"RTN","PSGOEF",181,0)
 . D:$G(PSJDD) IN^PSJOCDS($G(PSGORD),"UD",PSJDD)
"RTN","PSGOEF",182,0)
 I $G(PSGORQF) S PSGOEENO=0,PSJACEPT=0
"RTN","PSGOEF",183,0)
 I PSGOEENO S PSJNOO=$$ENNOO^PSJUTL5("E"),PSJACEPT=$S(PSJNOO<0:0,1:1)
"RTN","PSGOEF",184,0)
ACCEPT ;
"RTN","PSGOEF",185,0)
 N PSGUDFIN S PSGUDFIN=1
"RTN","PSGOEF",186,0)
 S VALMBCK=$S($G(PSJACEPT):"Q",1:"R")
"RTN","PSGOEF",187,0)
 I '$G(PSJACEPT) D ABORTACC Q
"RTN","PSGOEF",188,0)
 ;*** PSJ*5*256
"RTN","PSGOEF",189,0)
 I $G(PSJOLDNM("NEW_SCHD"))]"" S PSGSCH=$G(PSJOLDNM("NEW_SCHD")),PSGOEENO=1,PSGOEEF(26)=1,PSJNOO="S"
"RTN","PSGOEF",190,0)
 K PSGOES,PSGRSD,PSGRSDN D:PSGOEENO NEW3^PSGOEE D:'PSGOEENO UPD^PSGOEF1 I $D(PSGOEF)!PSGOEENO S PSGCANFL=-1
"RTN","PSGOEF",191,0)
 ;saves drug allergy signs/symptoms PSJ*5*260
"RTN","PSGOEF",192,0)
 I $D(^TMP("PSODAOC",$J,"ALLERGY")) D
"RTN","PSGOEF",193,0)
 .N DA,OCCDT,ORN,ORL,Z,RET,PSJDAOC
"RTN","PSGOEF",194,0)
 .S PSJDAOC="IP "_$S($G(PSGORD)["P":"Pending/Non-Verified",$G(PSGORD)["U":"Unit Dose",$G(PSGORD)["V":"IV",1:"")_" Allergy",OCCDT=$$NOW^XLFDT
"RTN","PSGOEF",195,0)
 .I PSGORD["P" S ORN=$P(^PS(53.1,+PSGORD,0),U,21)
"RTN","PSGOEF",196,0)
 .I PSGORD["U" S ORN=$P(^PS(55,DFN,5,+PSGORD,0),U,21)
"RTN","PSGOEF",197,0)
 .I PSGORD["V" S ORN=$P(^PS(55,DFN,"IV",+PSGORD,0),U,21)
"RTN","PSGOEF",198,0)
 .Q:'$G(ORN)
"RTN","PSGOEF",199,0)
 . S PSJAGYSV=1 ;use in ^PSJOE to store allergy (also clean up this var)
"RTN","PSGOEF",200,0)
 .;D SETOC^PSJNEWOC(PSGORD) ;set order checks in 100.05
"RTN","PSGOEF",201,0)
 .;K ^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J)
"RTN","PSGOEF",202,0)
 D DONE1^PSGOEE
"RTN","PSGOEF",203,0)
 D DONE
"RTN","PSGOEF",204,0)
 Q
"RTN","PSGOEF",205,0)
BYPASS ;
"RTN","PSGOEF",206,0)
 S PSGCANFL=1
"RTN","PSGOEF",207,0)
 ;
"RTN","PSGOEF",208,0)
DONE ;
"RTN","PSGOEF",209,0)
 K CHK,DA,DIE,DR,DRG,MSG,Q1,Q2,PSGNSTAT,PSGEDTOI,PSGOEER,ZZND
"RTN","PSGOEF",210,0)
 K PSJOVR
"RTN","PSGOEF",211,0)
 Q
"RTN","PSGOEF",212,0)
ABORTACC ; Abort Accept process.
"RTN","PSGOEF",213,0)
 ;*315
"RTN","PSGOEF",214,0)
 K PSGDUR,PSGRMVT,PSGRMV,PSGRF
"RTN","PSGOEF",215,0)
 K PSJCT1,PSJOVR,PSJOVRLP,PSJCT1A K ^TMP("PSODAOC",$J)
"RTN","PSGOEF",216,0)
 D ABORT^PSGOEE K PSGOEEF D GETUD^PSJLMGUD(PSGP,PSGORD),^PSGOEF,ENSFE^PSGOEE0(PSGP,PSGORD),INIT^PSJLMUDE(PSGP,PSGORD) S VALMBCK="R",PSGSD=PSGNESD,PSGFD=PSGNEFD Q
"RTN","PSGOEF",217,0)
 ;
"RTN","PSGOEF",218,0)
 ;
"RTN","PSGOEF",219,0)
31 ;;101^PSGOE8;PSGOPD;PSGPD;101;1
"RTN","PSGOEF",220,0)
32 ;;109^PSGOE8;PSGODO;PSGDO;109;PSGODO]""
"RTN","PSGOEF",221,0)
33 ;;10^PSGOE81;PSGOSD;PSGSD;10;0
"RTN","PSGOEF",222,0)
34 ;;3^PSGOE8;PSGOMR;PSGMR;3;1
"RTN","PSGOEF",223,0)
35 ;;25^PSGOE81;PSGOFD;PSGFD;25;0
"RTN","PSGOEF",224,0)
36 ;;7^PSGOE8;PSGOST;PSGST;7;0
"RTN","PSGOEF",225,0)
37 ;;5^PSGOE82;PSGOSM;PSGSM;5;0
"RTN","PSGOEF",226,0)
38 ;;26^PSGOE8;PSGOSCH;PSGSCH;26;1      
"RTN","PSGOEF",227,0)
39 ;;39^PSGOE81;PSGOAT;PSGAT;39;0
"RTN","PSGOEF",228,0)
310 ;;1^PSGOE82;PSGOPR;PSGPR;1;1
"RTN","PSGOEF",229,0)
311 ;;8^PSGOE81;PSGOSI;PSGSI;8;0
"RTN","PSGOEF",230,0)
312 ;;2^PSGOE82;;;2;0
"RTN","PSGOEF",231,0)
313 ;;40^PSGOE82;;;40;0
"RTN","PSGOEF",232,0)
 ;
"RTN","PSGOEF",233,0)
AH ;
"RTN","PSGOEF",234,0)
 W !!?2,"Answer 'YES' to accept this order as a NON-VERIFIED UNIT DOSE order.  Answer",!,"'NO' to edit this order now.  Enter '^' to BYPASS this order, leaving it as",!,"a PENDING INPATIENT order."
"RTN","PSGOEF",235,0)
 Q
"RTN","PSGOER")
0^19^B90452395
"RTN","PSGOER",1,0)
PSGOER ;BIR/CML3 - RENEW A SINGLE ORDER ;4/27/11 9:54am
"RTN","PSGOER",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**11,30,29,35,70,58,95,110,111,133,141,198,181,246,278,281,315,256**;16 DEC 97;Build 34
"RTN","PSGOER",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSGOER",4,0)
 ;
"RTN","PSGOER",5,0)
 ; Reference to ^PS(51.1 supported by DBIA 2177.
"RTN","PSGOER",6,0)
 ; Reference to ^PS(55 supported by DBIA 2191.
"RTN","PSGOER",7,0)
 ; Reference to ^PSSLOCK is supported by DBIA 2789.
"RTN","PSGOER",8,0)
 ; Reference to ^PSBAPIPM is supported by DBIA 3564.
"RTN","PSGOER",9,0)
 ; Reference to ^PS(59.7 is supported by DBIA 2181.
"RTN","PSGOER",10,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192.
"RTN","PSGOER",11,0)
 ; Reference to ^TMP("PSODAOC",$J is supported by DBIA 6071.
"RTN","PSGOER",12,0)
 ;
"RTN","PSGOER",13,0)
 ; renew a single order
"RTN","PSGOER",14,0)
 I $G(PSJCOM) D ^PSJCOMR Q
"RTN","PSGOER",15,0)
 N PSJEXPIR S PSJEXPIR=$$EXPIRED(PSGP,PSGORD) I PSJEXPIR D  Q
"RTN","PSGOER",16,0)
 .W !!?3,"  THIS ORDER" W:PSJEXPIR'=2 " HAS BEEN INACTIVE FOR ONE OR MORE SCHEDULED",!?8," ADMINISTRATIONS AND"
"RTN","PSGOER",17,0)
 .W " CANNOT BE RENEWED!" D PAUSE^VALM1
"RTN","PSGOER",18,0)
 I $G(PSGSCH)]"",($G(PSGS0XT)="D"),($G(PSGAT)="") D  Q
"RTN","PSGOER",19,0)
 .N SWD,SDW,XABB,X,QX S X=$G(PSGSCH) D DW^PSGS0 Q:($G(X)="")  I $G(PSGS0XT)="" S PSGS0XT="D"
"RTN","PSGOER",20,0)
 .Q:((",P,R,")[(","_$G(PSGST)_","))
"RTN","PSGOER",21,0)
 .I $G(PSGS0XT)="D",$G(PSGAT)="" S CHK=1 W !!?3,"This order contains a 'DAY OF THE WEEK' schedule without admin times"
"RTN","PSGOER",22,0)
 .W !?11," and CANNOT be renewed!" D PAUSE^VALM1
"RTN","PSGOER",23,0)
 I $G(PSGSCH)]"",'$$DOW^PSIVUTL(PSGSCH),'$$PRNOK^PSGS0(PSGSCH) I '$D(^PS(51.1,"AC","PSJ",PSGSCH)) D  Q
"RTN","PSGOER",24,0)
 .;PSJ*5*256
"RTN","PSGOER",25,0)
 .NEW PSJOLDNM
"RTN","PSGOER",26,0)
 .S PSJOLDNM("ORD_SCHD")=PSGSCH
"RTN","PSGOER",27,0)
 .I (PSGSCH]""),$$CHKSCHD^PSJMISC2(.PSJOLDNM,"R") K PSJOLDNM Q
"RTN","PSGOER",28,0)
 .K PSJOLDNM
"RTN","PSGOER",29,0)
 .W !!?3,"This order contains an invalid schedule and CANNOT be renewed!" D PAUSE^VALM1
"RTN","PSGOER",30,0)
 W !! K DIR S DIR(0)="Y",DIR("A")=$S($P(PSJSYSP0,"^",3):"RENEW THIS ORDER",1:"MARK THIS ORDER FOR RENEWAL"),DIR("B")="YES"
"RTN","PSGOER",31,0)
 S DIR("?")="Answer 'YES' to "_$S($P(PSJSYSP0,"^",3):"renew this order",1:"mark this order for renewal")_".  Answer 'NO' (or '^') to stop now." D ^DIR
"RTN","PSGOER",32,0)
 I '$D(DIRUT),Y D NEW S PSGCANFL=1 D DONE Q
"RTN","PSGOER",33,0)
 I '$D(DIRUT),PSJSYSU S PSGND4=$G(^PS(55,PSGP,5,+PSGORD,4)) I $P(PSGND4,"^",15),$P(PSGND4,"^",16) D UNMARK,DONE Q
"RTN","PSGOER",34,0)
 D DONE,ABORT^PSGOEE
"RTN","PSGOER",35,0)
 Q
"RTN","PSGOER",36,0)
 ;
"RTN","PSGOER",37,0)
UNMARK ;  
"RTN","PSGOER",38,0)
 W !!,"THIS ORDER HAS BEEN 'MARKED FOR RENEWAL'.",! K DIR S DIR(0)="Y",DIR("A")="DO YOU WANT TO 'UNMARK IT'",DIR("B")="NO"
"RTN","PSGOER",39,0)
 S DIR("?",1)="  Answer 'YES' to unmark this order.  Answer 'NO' (or '^') to leave the order",DIR("?")="marked.  (An answer is required.)" D ^DIR
"RTN","PSGOER",40,0)
 I 'Y D ABORT^PSGOEE G DONE
"RTN","PSGOER",41,0)
 S DA(1)=PSGP,DA=+PSGORD,PSGAL("C")=21180+PSJSYSU D ^PSGAL5 S $P(PSGND4,"^",15,17)="^^",^PS(55,PSGP,5,DA,4)=PSGND4 W "...DONE!"
"RTN","PSGOER",42,0)
 ;
"RTN","PSGOER",43,0)
DONE ;
"RTN","PSGOER",44,0)
 K %DT,DA,DIE,DIR,DR,FDSD,PSGAL,PSGALR,PSGDL,PSGDLS,PSGFD,PSGFOK,PSGND4,PSGOEE,PSGOER0,PSGOER1,PSGOER2,PSGOERDP,PSGPOSA,PSGPOSD,PSGPR,PSGPX,PSGRD,PSGSD,PSGTOL,PSGTOO,PSGUOW,PSGWLL,RF Q
"RTN","PSGOER",45,0)
 ;
"RTN","PSGOER",46,0)
NEW ; get info, write record
"RTN","PSGOER",47,0)
EXTEND ; extend stop date on renewal order
"RTN","PSGOER",48,0)
 N DUOUT,PSJABT,PSGDRG,PSJREN,PSGOREAS S PSGDRG=$P($G(^PS(55,PSGP,5,+PSGORD,1,1,0)),"^"),PSJREN=1
"RTN","PSGOER",49,0)
 I $G(PSGST)="O" N ACT S ACT=$$EN^PSBAPIPM(PSGP,PSGORD) I $P(ACT,"^",2),($P(ACT,"^",3)="G") I $P(ACT,"^",2)>$P($G(^PS(55,PSGP,5,+PSGORD,2)),"^",2) D  Q
"RTN","PSGOER",50,0)
 . W !!?5,"THIS ONE-TIME ORDER HAS ALREADY BEEN GIVEN AND CANNOT BE RENEWED",! S (DIRUT,PSGORQF)=1 D READ
"RTN","PSGOER",51,0)
 ;D OC55
"RTN","PSGOER",52,0)
 ;Q:$D(PSGORQF)  ; quit if not to continue
"RTN","PSGOER",53,0)
 D NOW^%DTC S PSGDT=%,PSGND4=$G(^PS(55,PSGP,5,+PSGORD,4)) I '$P(PSJSYSP0,"^",3) D MARK Q
"RTN","PSGOER",54,0)
 S PSGWLL=$S('$P(PSJSYSW0,"^",4):0,1:+$G(^PS(55,PSGP,5.1))),PSGOEE="R" K PSGOEOS
"RTN","PSGOER",55,0)
 K ^PS(53.45,PSJSYSP,1),^(2) D MOVE(3,1),MOVE(1,2)
"RTN","PSGOER",56,0)
 D DATE^PSGOER0(PSGP,PSGORD,PSGDT) I ($G(X)="^")!'$D(PSGFOK(106))!$G(DUOUT) D DONE,ABORT^PSGOEE S VALMBCK="R",COMQUIT=1 Q
"RTN","PSGOER",57,0)
 ;D OC55
"RTN","PSGOER",58,0)
 ;I $G(PSGORQF) D DONE,ABORT^PSGOEE S VALMBCK="R",COMQUIT=1 Q
"RTN","PSGOER",59,0)
SPEED ;
"RTN","PSGOER",60,0)
 I +$G(PSJSYSU)=3 D EN^PSGPEN(PSGORD)
"RTN","PSGOER",61,0)
 Q:$G(DUOUT)
"RTN","PSGOER",62,0)
 N PSGOEAV S PSGOEAV=+PSJSYSU
"RTN","PSGOER",63,0)
 W !!,"...updating order..." K DA S DA(1)=PSGP,DA=+PSGORD,PSGAL("C")=PSJSYSU*10+18000 D ^PSGAL5 W "."
"RTN","PSGOER",64,0)
 I $$LS^PSSLOCK(PSGP,PSGORD) D UPDREN(PSGORD,PSGDT,PSGOEPR,PSGOFD,PSJNOO),UPDRENOE(PSGP,PSGORD,PSGDT) D UNL^PSSLOCK(PSGP,PSGORD)
"RTN","PSGOER",65,0)
 S ^TMP("PSODAOC",$J,"IP IEN")=PSGORD   ;set up which IEN will be used to store order checks
"RTN","PSGOER",66,0)
 D SETOC^PSJNEWOC(PSGORD) ;PSJ*5*281 stores order checks
"RTN","PSGOER",67,0)
 K ^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J)
"RTN","PSGOER",68,0)
 ;
"RTN","PSGOER",69,0)
 I 'PSGOERDP,$P(PSJSYSW0,"^",4),PSGFD'<PSGWLL S $P(^PS(55,PSGP,5.1),"^")=+PSGFD
"RTN","PSGOER",70,0)
 W ".DONE!" S VALMBCK="Q" Q
"RTN","PSGOER",71,0)
 ;
"RTN","PSGOER",72,0)
MARK ;
"RTN","PSGOER",73,0)
 I $P(PSGND4,"^",15),$P(PSGND4,"^",16) W $C(7),!!?3,"...THIS ORDER IS ALREADY MARKED FOR RENEWAL!..." Q
"RTN","PSGOER",74,0)
 K DA S $P(PSGND4,"^",15,17)="1^"_DUZ_"^"_PSGDT,^PS(55,PSGP,5,+PSGORD,4)=PSGND4,PSGAL("C")=13180,DA(1)=PSGP,DA=+PSGORD W "." D ^PSGAL5
"RTN","PSGOER",75,0)
 I $D(PSJSYSO) S PSGORD=+PSGORD_"A",PSGPOSA="R",PSGPOSD=PSGDT D ENPOS^PSGVDS
"RTN","PSGOER",76,0)
 Q
"RTN","PSGOER",77,0)
MOVE(X,Y) ; Move comments/dispense drugs from 55 to 53.45.
"RTN","PSGOER",78,0)
 S Q=0 F  S Q=$O(^PS(55,PSGP,5,+PSGORD,X,Q)) Q:'Q  S ^PS(53.45,PSJSYSP,Y,Q,0)=$G(^(Q,0))
"RTN","PSGOER",79,0)
 S:Q ^PS(53.45,Y,0)="^53.450"_Y_"P^"_Q_U_Q
"RTN","PSGOER",80,0)
 Q
"RTN","PSGOER",81,0)
OC55 ;* Order checks for Speed finish and regular finish
"RTN","PSGOER",82,0)
 ;PSJ*5*181 - no longer use (OC will be triggered from OC^PSGOER0)
"RTN","PSGOER",83,0)
 Q
"RTN","PSGOER",84,0)
NEWOC55 ;
"RTN","PSGOER",85,0)
 N INTERVEN,PSJDDI,PSJIREQ,PSJRXREQ,PSJPDRG,PSJDD,PSJDD0,PSJALLGY
"RTN","PSGOER",86,0)
 S Y=1,(PSJIREQ,PSJRXREQ,INTERVEN,X)=""
"RTN","PSGOER",87,0)
 F PSGDDI=0:0 S PSGDDI=$O(^PS(55,PSGP,5,+PSGORD,1,PSGDDI)) Q:'+PSGDDI  D
"RTN","PSGOER",88,0)
 . S PSJDD0=$G(^PS(55,PSGP,5,+PSGORD,1,PSGDDI,0))
"RTN","PSGOER",89,0)
 . S PSJX=$P(PSJDD0,U,3) I PSJX]"",(PSJX'>$G(PSGDT)) Q
"RTN","PSGOER",90,0)
 . S PSJDD=+PSJDD0
"RTN","PSGOER",91,0)
 . S PSJX=$S('$D(^PSDRUG(+PSJDD,0)):1,$P($G(^(2)),U,3)'["U":1,$G(^("I"))="":0,1:^("I")'>$G(PSGDT))
"RTN","PSGOER",92,0)
 . Q:PSJX
"RTN","PSGOER",93,0)
 . S PSJALLGY(PSJDD)=""
"RTN","PSGOER",94,0)
 S PSJDD=$O(PSJALLGY(0))
"RTN","PSGOER",95,0)
 I '+PSJDD W !!,"No active dispense drug was found" D PAUSE^PSJLMUT1 Q
"RTN","PSGOER",96,0)
 K PSGORQF D ENDDC^PSGSICHK(PSGP,PSJDD)
"RTN","PSGOER",97,0)
 D:'$G(PSGORQF) IN^PSJOCDS(PSGORD,"UD",PSJDD) Q:$G(PSGORQF)
"RTN","PSGOER",98,0)
 Q
"RTN","PSGOER",99,0)
UPDREN(PSGORD,RNWDT,PSGOEPR,PSGOFD,PSJNOO,RDUZ) ; update renewed order
"RTN","PSGOER",100,0)
 N DR,DA,DIC,DIE,DD,DO,PSGRZERO,PSGRFOUR,PSGOORD
"RTN","PSGOER",101,0)
 S DR="",PSGOEENO=0,PSGOORD=PSGORD,PSGNESD=PSGSD Q:'PSGORD!'RNWDT!'PSGOEPR!'PSGOFD  S PSJNOO=$S($G(PSJNOO)]"":$G(PSJNOO),1:"E")
"RTN","PSGOER",102,0)
 S PSGRZERO="^PS(55,"_PSGP_",5,"_+PSGORD_",0)",PSGOEORD=$P(@PSGRZERO,"^",21)
"RTN","PSGOER",103,0)
 ; PSJ*5*141 - changed PSGOEPR to PSGPR for field 1 of the DR string below.
"RTN","PSGOER",104,0)
 S DA(1)=PSGP,DA=+PSGORD,DIE="^PS(55,"_PSGP_",5," S DR="34////^S X=PSGFD" S:$G(PSGPR) DR=DR_";1////"_PSGPR_";110////"_PSJNOO D ^DIE
"RTN","PSGOER",105,0)
 K DR,DA,DIC,DIE,DD,DO S DIC="^PS(55,"_PSGP_",5,"_+PSGORD_",14,",DIC(0)="L",DIC("P")="55.6114DA",ND14=$G(@(DIC_"0)")),DINUM=$P(ND14,"^",3)+1,DA(2)=PSGP,DA(1)=+PSGORD D
"RTN","PSGOER",106,0)
 . S DIC("DR")=".01////"_$G(RNWDT)_";1////"_$S($G(RDUZ):RDUZ,1:$G(DUZ))_";2////"_$G(PSGOEPR)_";3////"_$G(PSGOFD)_";4////"_+PSGOEORD,X=$G(RNWDT) D FILE^DICN
"RTN","PSGOER",107,0)
 K DR,DA,DIC,DIE,DD,DO S DA(1)=PSGP,DA=+PSGORD,DIE="^PS(55,"_PSGP_",5,",DR="28////A;105////@;107////@"
"RTN","PSGOER",108,0)
 ;PSJ*5*198
"RTN","PSGOER",109,0)
 S PSGRFOUR="^PS(55,"_PSGP_",5,"_+PSGORD_",4)",PSGRFOUR=@PSGRFOUR I $P(PSGRFOUR,"^",2)<RNWDT S DR=DR_";16////@;17////@" I $G(PSJORD)["P",+PSJSYSU=1 S DR=DR_";18////@;19////@"
"RTN","PSGOER",110,0)
 I '$G(PSJSPEED) I $G(PSGAT)]"",$G(PSGAT)'=$P($G(@(DIE_+PSGORD_",2)")),"^",5) S DR=DR_";41////"_PSGAT
"RTN","PSGOER",111,0)
 D ^DIE
"RTN","PSGOER",112,0)
 ; PSJ*5*278 - Check to re-assign orderable item
"RTN","PSGOER",113,0)
 N PSGPOI S PSGPOI=$$ACTIVE^PSJORREN(PSGP,PSGORD) Q:+PSGPOI=1  ;Quit if no change to OI
"RTN","PSGOER",114,0)
 I +PSGPOI>1,$P(PSGPOI,U,2) D  ;replace OI
"RTN","PSGOER",115,0)
 . N DR,DA,DIE S DA(1)=PSGP,DA=+PSGORD,DIE="^PS(55,"_PSGP_",5,",DR="108///^S X=$P(PSGPOI,U,2)" D ^DIE
"RTN","PSGOER",116,0)
 Q
"RTN","PSGOER",117,0)
UPDRENOE(PSGP,PSGORD,RDATE) ;
"RTN","PSGOER",118,0)
 D EXPOE(PSGP,PSGORD,$G(RDATE)) ; expire original Orders File order
"RTN","PSGOER",119,0)
 I PSGORD'["P" K DA,DR,DIE S DA(1)=DFN,DA=+PSGORD,DIE="^PS(55,"_DFN_$S(PSGORD="U":",5,",1:",""IV"","),DR=$S(DIE["IV":110,1:66)_"////@" D ^DIE
"RTN","PSGOER",120,0)
 D ENUDTX^PSJOREN(PSGP,PSGORD,"NR")
"RTN","PSGOER",121,0)
 D EN1^PSJHL2(PSGP,"SN",PSGORD,"ORDER RENEWED")
"RTN","PSGOER",122,0)
 Q
"RTN","PSGOER",123,0)
READ ; hold screen
"RTN","PSGOER",124,0)
 I $D(IOST) Q:$E(IOST)'="C"
"RTN","PSGOER",125,0)
 W !?5,"Press return to continue  " R X:$S($D(DTIME):DTIME,1:300)
"RTN","PSGOER",126,0)
 Q
"RTN","PSGOER",127,0)
EXPOE(DFN,PSJORDER,EXPDT) ; expire old Orders File entry
"RTN","PSGOER",128,0)
 I PSJORDER["P" S FILE="^PS(53.1,"_+PSJORDER_",0)",PSJORDER=$P(@FILE,"^",25)
"RTN","PSGOER",129,0)
 I (PSJORDER'["U"),(PSJORDER'["V") Q
"RTN","PSGOER",130,0)
 N CURDAT D NOW^%DTC S CURDAT=$$DATE2^PSJUTL2(%)
"RTN","PSGOER",131,0)
 S PSJEXPOE=$S($G(EXPDT):EXPDT,1:CURDAT) D EN1^PSJHL2(DFN,"SC",PSJORDER) K PSJEXPOE
"RTN","PSGOER",132,0)
 Q
"RTN","PSGOER",133,0)
EXPIRED(PSJX,PSJY) ;
"RTN","PSGOER",134,0)
 ; INPUT 
"RTN","PSGOER",135,0)
 ;       PSJX - Pharmacy Patient, pointer to ^PS(55
"RTN","PSGOER",136,0)
 ;       PSJY - Inpatient Order Number(appended with "V" or "U")
"RTN","PSGOER",137,0)
 ; OUTPUT
"RTN","PSGOER",138,0)
 ;   0  -  Order has not exceeded the Expired Time Limit 
"RTN","PSGOER",139,0)
 ;   1  -  Order has exceeded the Expired Time Limit
"RTN","PSGOER",140,0)
 N STOP,STATUS,NOW,CUTOFF,FREQ,LAST,ST,X,DFN,U,PSGDT,SD,WD,PSJPSTO,PSGDW,PSGOC,ZZND,LASTAT,LSTSTR,PSBCNT S DFN=PSJX,U="^",CUTOFF=0
"RTN","PSGOER",141,0)
 S STATUS=$S(PSJY["U":$P($G(^PS(55,PSJX,5,+PSJY,0)),"^",9),PSJY["V":$P($G(^PS(55,PSJX,"IV",+PSJY,0)),"^",17),1:"")
"RTN","PSGOER",142,0)
 S NOW=$S($G(PSGDT):PSGDT,1:$$DATE^PSJUTL2())
"RTN","PSGOER",143,0)
 S STOP=$S(PSJY["U":$P($G(^PS(55,PSJX,5,+PSJY,2)),U,4),1:$P($G(^PS(55,PSJX,"IV",+PSJY,0)),"^",3))
"RTN","PSGOER",144,0)
 I NOW<STOP Q 0
"RTN","PSGOER",145,0)
 ;*315 ND2P1 ON NEXT LINE
"RTN","PSGOER",146,0)
 I PSJY["U" N ND2,ND0 S ND0=$G(^PS(55,PSJX,5,+PSJY,0)),ND2=$G(^PS(55,PSJX,5,+PSJY,2)),ND2P1=$G(^PS(55,PSJX,5,+PSJY,2.1)),FREQ=$P(ND2,"^",6) D
"RTN","PSGOER",147,0)
 .N SCHED S SCHED=$P($G(^PS(55,PSJX,5,+PSJY,2)),"^") I SCHED["PRN" S FREQ=$$PRNFREQ(SCHED)
"RTN","PSGOER",148,0)
 .S LSTSTR=$P(ND2,"^",2)_"^"_$P(ND2,"^",4)_"^"_SCHED_"^"_$P(ND0,"^",7)_"^^"_$P(ND2,"^",5)
"RTN","PSGOER",149,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I LAST,($P(ND0,"^",7)="O"),($P(LAST,"^",3)="G") I LAST>$P(ND2,"^",2) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",150,0)
 .I 'LAST!(LAST>$P(ND2,"^",4)) S LAST=$$LASTAT^PSJORP2(DFN,LSTSTR) S:LAST CUTOFF=$$FMADD^XLFDT(LAST,,,FREQ) Q
"RTN","PSGOER",151,0)
 .I SCHED["PRN",($P(LSTSTR,"^",6)="") S CUTOFF=$$FMADD^XLFDT(LAST,,,FREQ) Q
"RTN","PSGOER",152,0)
 .I $$DOW^PSIVUTL(SCHED) S CUTOFF=$$NXTDOW(DFN,$P(LSTSTR,"^"),$P(LSTSTR,"^",2),$P(LSTSTR,"^",3),$P(LSTSTR,"^",6)) Q
"RTN","PSGOER",153,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I 'LAST!(LAST>$P(ND2,"^",4)) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",154,0)
 .S $P(LSTSTR,"^")=$$FMADD^XLFDT(LAST,,,,1),$P(LSTSTR,"^",2)=$$FMADD^XLFDT(PSGDT,,,FREQ) S CUTOFF=$$ENQ^PSJORP2(PSJX,LSTSTR)
"RTN","PSGOER",155,0)
 I PSJY["V" N LIMIT S LIMIT=$P($G(^PS(59.7,1,31)),"^",4) S LIMIT=$S((LIMIT]""):+LIMIT,1:24) S CUTOFF=$$FMADD^XLFDT(STOP,,LIMIT) D
"RTN","PSGOER",156,0)
 .I '($G(P(4))]"") N P,YP,XP S YP=$G(^PS(55,DFN,"IV",+PSJY,0)) F XP=1:1:23 S P(XP)=$P(YP,U,XP)
"RTN","PSGOER",157,0)
 .Q:'($G(P(4))]"")
"RTN","PSGOER",158,0)
 .Q:'$$SCHREQ^PSJLIVFD(.P)
"RTN","PSGOER",159,0)
 .N INTERVAL,LSTSTR,ND0,SCHED,IVSTYP S ND0=$G(^PS(55,PSJX,"IV",+PSJY,0)),INTERVAL=$P(ND0,"^",15),SCHED=$P(ND0,"^",9) Q:SCHED=""
"RTN","PSGOER",160,0)
 .S IVSTYP=$S($$DOW^PSIVUTL(SCHED):"D",INTERVAL="O":"O",1:"C"),LSTSTR=$P(ND0,"^",2)_"^"_$P(ND0,"^",3)_"^"_SCHED_"^"_IVSTYP_"^^"_$P(ND0,"^",11)
"RTN","PSGOER",161,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I LAST,IVSTYP="O",LAST>$P(ND0,"^",2),($P(LAST,"^",3)="G") S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",162,0)
 .I 'LAST!(LAST>$P(ND0,"^",3))!(LAST&(IVSTYP="O")) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",163,0)
 .I IVSTYP="D" S CUTOFF=$$NXTDOW(LAST,SCHED,$G(P(2)),$P($G(P(9)),"@"),$G(P(11))) Q
"RTN","PSGOER",164,0)
 .I SCHED["PRN" S FREQ=$$PRNFREQ(SCHED) S CUTOFF=$$FMADD^XLFDT(LAST,,,FREQ) Q
"RTN","PSGOER",165,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I 'LAST!(LAST>$P(ND0,"^",3)) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",166,0)
 .S $P(LSTSTR,"^")=$$FMADD^XLFDT(LAST,,,,1),$P(LSTSTR,"^",2)=$$FMADD^XLFDT(PSGDT,31) S CUTOFF=$$ENQ^PSJORP2(PSJX,LSTSTR)
"RTN","PSGOER",167,0)
 K LYN,PSBDT,PSBFLAG,PSBSTR
"RTN","PSGOER",168,0)
 Q $S(CUTOFF<NOW:1,1:0)
"RTN","PSGOER",169,0)
 ;
"RTN","PSGOER",170,0)
NXTDOW(DOWDFN,DOWSD,DOWFD,DOWSCH,DOWAT) ;
"RTN","PSGOER",171,0)
 N NXTADM,DOWSTR S DOWSTR=$$FMADD^XLFDT(DOWFD,,,,1)_"^"_$$FMADD^XLFDT(DOWFD,7)_"^"_DOWSCH_"^D^^"_DOWAT S NXTADM=$$ENQ^PSJORP2(DOWDFN,DOWSTR)
"RTN","PSGOER",172,0)
 Q $S(NXTADM:NXTADM,1:DOWSD)
"RTN","PSGOER",173,0)
 ;
"RTN","PSGOER",174,0)
PRNFREQ(SCHED) ;
"RTN","PSGOER",175,0)
 N ZZND,D,DA,X,PSGAT,PSGOES,PSGST,PSJNSS,PSJPWD,TEST,VALMBCK,PSGS0XT,PSGS0Y,PSGDT
"RTN","PSGOER",176,0)
 F X=$P(SCHED,"PRN"),$P(SCHED,"PRN",2),$P(SCHED," PRN"),$P(SCHED,"PRN ",2) Q:$P($G(ZZND),"^",4)  D ADMIN^PSJORPOE
"RTN","PSGOER",177,0)
 Q $S($G(PSGS0XT):PSGS0XT,1:1440)
"RTN","PSGOES")
0^15^B24088682
"RTN","PSGOES",1,0)
PSGOES ;BIR/CML3-CREATE ORDERS USING ORDER SET ;19 Feb 99 / 12:53 PM
"RTN","PSGOES",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**12,22,30,34,50,58,111,181,263,309,281,256**;16 DEC 97;Build 34
"RTN","PSGOES",3,0)
 ;
"RTN","PSGOES",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180.
"RTN","PSGOES",5,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSGOES",6,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192.
"RTN","PSGOES",7,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071
"RTN","PSGOES",8,0)
 ;
"RTN","PSGOES",9,0)
 NEW PSJNOOSV
"RTN","PSGOES",10,0)
 K DIC,PSGOEOS S X=$P(X,"S.",2),DIC="^PS(53.2,",DIC(0)="QEM" D ^DIC K DIC G:Y'>0 DONE W "  (ORDER SET)" S PSGOESDA=+Y,PSGOES=1
"RTN","PSGOES",11,0)
 I '$D(^PS(53.2,+Y,2)) W "    Invalid Order Set" Q
"RTN","PSGOES",12,0)
 I $P(PSJSYSU,";",2) S PSGOESPR=DUZ
"RTN","PSGOES",13,0)
 E  D  G:Y'>0 DONE
"RTN","PSGOES",14,0)
 .S DIC="^VA(200,",DIC(0)="QEAM",DIC("A")="Select PROVIDER: ",X=$P($G(^PS(55,PSGP,5.1)),"^",2) I X S X=$P($G(^VA(200,X,0)),"^") I X]"" S Y=^("PS") I Y,$S('$P(Y,"^",4):1,1:$P(Y,"^",4)>DT) S DIC("B")=X
"RTN","PSGOES",15,0)
 .S DIC("S")="S X(1)=$G(^(""PS"")) I X(1),$S('$P(X(1),""^"",4):1,1:$P(X(1),""^"",4)>DT)" W ! D ^DIC K DIC I Y'>0 W $C(7),!!,"Provider is required for order sets." Q
"RTN","PSGOES",16,0)
 .S PSGOESPR=+Y S:$P($G(^PS(55,PSGP,5.1)),"^",2)'=+Y $P(^(5.1),"^",2)=+Y
"RTN","PSGOES",17,0)
 S (PSJNOO,PSJNOOSV)=$$ENNOO^PSJUTL5("N")
"RTN","PSGOES",18,0)
 I $G(PSJNOO)<0 W !,$C(7),"...order set not entered..." G DONE
"RTN","PSGOES",19,0)
 F PSGOESN=0:0 S PSGOESN=$O(^PS(53.2,PSGOESDA,2,PSGOESN)) Q:'PSGOESN  I $D(^(PSGOESN,0)) S OSND=^(0) I $S($P(OSND,"^",3)="":0,$P(OSND,"^",4)="":0,$P(OSND,"^",4)="OC":1,1:$P(OSND,"^",5)]"") S PSGSI=$P($G(^(1)),"^") D GND Q:PSGQUIT
"RTN","PSGOES",20,0)
 ;
"RTN","PSGOES",21,0)
DONE ;
"RTN","PSGOES",22,0)
 K PSJNOON,PSJNOO,PSJNOOSV
"RTN","PSGOES",23,0)
 S X="S.X" K %DT,N,OSND,PSGOESDA,PSGDDRG,PSGOESI,PSGOES,PSGOEOS,PSGOESN,PSGOESPR,PSGQUIT,PSGX,SDT,STDAY,X1,X2 Q
"RTN","PSGOES",24,0)
 ;
"RTN","PSGOES",25,0)
GND ;
"RTN","PSGOES",26,0)
 NEW PSJOCDS,PSJALLGY,PSJMULDD,PSJOLDNM
"RTN","PSGOES",27,0)
 K PSGOEE,PSGSCH,PSGORD
"RTN","PSGOES",28,0)
 K ^TMP("PSODAOC",$J)
"RTN","PSGOES",29,0)
 S:'$D(PSJNOO) PSJNOO=$G(PSJNOOSV)
"RTN","PSGOES",30,0)
 S (PSGPDRG,PSGX)=+OSND,PSGPDRGN=$P($G(^PS(50.7,PSGPDRG,0)),"^") S:PSGPDRGN="" PSGPDRGN=PSGPDRG W !!,"...entering ",$S(PSGPDRGN'=PSGPDRG:PSGPDRGN,1:"** UNKNOWN **"),"..." K Y,DIRUT D END^PSGSICHK S PSGQUIT=$D(DIRUT) Q:$G(Y)<0
"RTN","PSGOES",31,0)
 S PSGNEDFD=$P(OSND,"^",2,5),PSGMR=$P(OSND,"^",3),PSGST=$P(OSND,"^",4),PSGDO=$P(OSND,"^",9),PSGMRN=$$ENMRN^PSGMI(PSGMR)
"RTN","PSGOES",32,0)
 ;PSJ*5*256
"RTN","PSGOES",33,0)
 I '+$P(OSND,"^",5) S PSJOLDNM("ORD_SCHD")=$P(OSND,"^",5) I $$CHKSCHD^PSJMISC2(.PSJOLDNM) Q
"RTN","PSGOES",34,0)
 S:PSGMRN="" PSGMRN=PSGMR D NOW^%DTC S PSGDT=+$E(%,1,12) I PSGST="OC" S PSGSCH="ON CALL",(PSGS0XT,PSGS0Y)=""
"RTN","PSGOES",35,0)
 E  S X=$P(OSND,"^",5) W "." S:X X="`"_X S:$G(PSJOLDNM("NEW_SCHD"))]"" X=PSJOLDNM("NEW_SCHD") D ENOS^PSGS0 S:$D(X) PSGSCH=X I '$D(X) S (PSGSCH,PSGS0XT,PSGS0Y)=""
"RTN","PSGOES",36,0)
 S (PSGNESD,PSGNEFD)="" W "." I $P(OSND,"^",11)]"" S %DT="T",X=$P(OSND,"^",11) D ^%DT S PSGNESD=Y D ENFD^PSGNE3(PSGDT)
"RTN","PSGOES",37,0)
 D:$P(OSND,"^",11)="" ^PSGNE3 K PSGDRG,PSGORQF,^PS(53.45,PSJSYSP,1),^(2) S (N,Q)=0
"RTN","PSGOES",38,0)
 K PSJALLGY
"RTN","PSGOES",39,0)
 ;If PSJMULDD >1 then the order has mutliple DD and it will flag ENDDC^PSGSICHK to display the OI name instead of DD name
"RTN","PSGOES",40,0)
 S PSJMULDD=0
"RTN","PSGOES",41,0)
 F  S Q=$O(^PS(53.2,PSGOESDA,2,PSGOESN,2,Q)) Q:'Q!$D(PSGORQF)  S PSGDRG=$G(^(Q,0)) I PSGDRG D
"RTN","PSGOES",42,0)
 .S PSJALLGY(+PSGDRG)="",PSJMULDD=PSJMULDD+1
"RTN","PSGOES",43,0)
 .;D ENDDC^PSGSICHK(PSGP,+PSGDRG) Q:$D(PSGORQF)
"RTN","PSGOES",44,0)
 .;D IN^PSJOCDS($G(PSGORD),"UD",+PSGDRG) Q:$D(PSGORQF)
"RTN","PSGOES",45,0)
 .;D CONT^PSJOCDT Q:$D(PSGORQF)
"RTN","PSGOES",46,0)
 .S:$P(PSGDRG,U,2)="" $P(PSGDRG,U,2)=1
"RTN","PSGOES",47,0)
 .S N=N+1,^PS(53.45,PSJSYSP,2,N,0)=PSGDRG,^PS(53.45,PSJSYSP,2,"B",+PSGDRG,N)="" W "."
"RTN","PSGOES",48,0)
 .I $P(^PSDRUG(+PSGDRG,2),U,3)'["U"!($S('+$G(^PSDRUG(+PSGDRG,"I")):0,^("I")'>DT:1,1:0)) S PSGOEAV="0^1" W:PSJSYSU $C(7),!?5,"...AS NON-VERIFIED - DATA INCOMPLETE..."
"RTN","PSGOES",49,0)
 S PSGDRG=$O(PSJALLGY(0)) Q:'+PSGDRG
"RTN","PSGOES",50,0)
 D FULL^VALM1
"RTN","PSGOES",51,0)
 D ENDDC^PSGSICHK(PSGP,+PSGDRG) Q:$D(PSGORQF)
"RTN","PSGOES",52,0)
 D IN^PSJOCDS($G(PSGORD),"UD",+PSGDRG) Q:$D(PSGORQF)
"RTN","PSGOES",53,0)
 ;*309 - Remove second continue prompt
"RTN","PSGOES",54,0)
 ;D CONT^PSJOCDT Q:$D(PSGORQF)
"RTN","PSGOES",55,0)
 I N S ^PS(53.45,PSJSYSP,2,0)="^53.4502P^"_N_"^"_N
"RTN","PSGOES",56,0)
 I $G(PSGORQF) W !,?5,"...ORDER FOR ",PSGPDRGN," NOT ENTERED...",! Q
"RTN","PSGOES",57,0)
 ;I PSGOEAV,$S($D(PSGOEOS):1,'PSGPDRG:1,PSGPDRG=PSGPDRGN:1,'PSGMR:1,PSGMR=PSGMRN:1,PSGSCH="":1,PSGST="":1,'PSGNESD:1,'PSGNEFD:1,+PSJSYSU=3:'N,1:0) S PSGOEAV="0^1" W:('$D(PSGOEOS)&PSJSYSU) $C(7),!?5,"...AS NON-VERIFIED - DATA INCOMPLETE..."
"RTN","PSGOES",58,0)
 I PSGOEAV,$S('PSGPDRG:1,PSGPDRG=PSGPDRGN:1,'PSGMR:1,PSGMR=PSGMRN:1,PSGSCH="":1,PSGST="":1,'PSGNESD:1,'PSGNEFD:1,+PSJSYSU=3:'N,1:0) S PSGOEAV="0^1" W:('$D(PSGOES)&PSJSYSU) $C(7),!?5,"...AS NON-VERIFIED - DATA INCOMPLETE..."
"RTN","PSGOES",59,0)
 S (PSGHSM,PSGSM)="",PSGPR=PSGOESPR D ^PSGOETO S PSGOEAV=$P(PSJSYSP0,"^",9)&PSJSYSU
"RTN","PSGOES",60,0)
 ; pharmacist label check, build label for order set only if auto verify turned on
"RTN","PSGOES",61,0)
 I PSJSYSL>0,(PSGOEAV),($P($G(^PS(55,PSGP,5,$S($D(DA):DA,1:+PSGORD),0)),U,9)="A") D
"RTN","PSGOES",62,0)
 .S $P(^PS(55,PSGP,5,$S($D(DA):DA,1:+PSGORD),7),U)=PSGDT S:$P(^(7),U,2)="" $P(^(7),U,2)="N" S PSGTOL=2,PSGUOW=DUZ,PSGTOO=1,DA=+PSGORD D ENL^PSGVDS
"RTN","PSGOES",63,0)
 ; ward clerk label check 
"RTN","PSGOES",64,0)
 I PSJSYSL>0,$P(PSJSYSU,";",3)<3,"12"[$P(PSJSYSW0,"^",12),'(PSGOEAV) D
"RTN","PSGOES",65,0)
 .I PSGORD["P" S $P(^PS(53.1,$S($D(DA):DA,1:+PSGORD),7),U)=PSGDT S:$P(^(7),U,2)="" $P(^(7),U,2)="N"
"RTN","PSGOES",66,0)
 .I PSGORD'["P" S $P(^PS(55,PSGP,5,$S($D(DA):DA,1:+PSGORD),7),U)=PSGDT S:$P(^(7),U,2)="" $P(^(7),U,2)="N"
"RTN","PSGOES",67,0)
 .S PSGTOL=2,PSGUOW=DUZ,PSGTOO=2,DA=+PSGORD D ENL^PSGVDS
"RTN","PSGOES",68,0)
 Q
"RTN","PSGOEV")
0^17^B95475344
"RTN","PSGOEV",1,0)
PSGOEV ;BIR/CML3 - VERIFY (MAKE ACTIVE) ORDERS ;4/16/10 9:18am
"RTN","PSGOEV",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**5,7,15,28,33,50,64,58,77,78,80,110,111,133,171,207,241,267,268,260,288,199,281,256**;16 DEC 97;Build 34
"RTN","PSGOEV",3,0)
 ;
"RTN","PSGOEV",4,0)
 ; Reference to ^ORD(101 supported by DBIA #872.
"RTN","PSGOEV",5,0)
 ; Reference to ^PS(50.7 supported by DBIA #2180.
"RTN","PSGOEV",6,0)
 ; Reference to ^PS(55 supported by DBIA #2191.
"RTN","PSGOEV",7,0)
 ; Reference to ^PSSLOCK supported by DBIA #2789.
"RTN","PSGOEV",8,0)
 ; Reference to ^PSDRUG( supported by DBIA# 2192.
"RTN","PSGOEV",9,0)
 ; Reference to MAIN^TIUEDIT is supported by DBIA #2410.
"RTN","PSGOEV",10,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071
"RTN","PSGOEV",11,0)
 ;
"RTN","PSGOEV",12,0)
EN(PSGORD) ;
"RTN","PSGOEV",13,0)
ENSF ; This entry point is used by Speed finish only.
"RTN","PSGOEV",14,0)
 ; Send SN update to CPRS if auto-verify off and from Order Set entry
"RTN","PSGOEV",15,0)
 NEW PSJOLDNM,PSJOLDX
"RTN","PSGOEV",16,0)
 S:'$D(PSGOEAV) PSGOEAV=$P($G(PSJSYSP0),"^",9)&$G(PSJSYSU)
"RTN","PSGOEV",17,0)
 I $D(PSGOES),'PSGOEAV,PSGORD["P",$P($G(^PS(53.1,+PSGORD,0)),"^",21)']"" D ORSET^PSGOETO1
"RTN","PSGOEV",18,0)
 D FULL^VALM1 I 'PSJSYSU W $C(7),$C(7),!!," THIS FUNCTION NOT AVAILABLE TO WARD STAFF." Q
"RTN","PSGOEV",19,0)
 S CHK=0 I PSGORD["P" S X=$P($G(^PS(53.1,+PSGORD,0)),"^",19) I X,$D(^PS(55,PSGP,5,$P(^(0),"^",19))) S CHK=+PSGORD,PSGORD=X_"U" L -^PS(53.1,CHK) L +^PS(55,PSGP,5,+PSGORD):1 E  W !!,"Another terminal is editing this order." G DONE
"RTN","PSGOEV",20,0)
 I +PSJSYSU=3 D DDCHK G:CHK DONE
"RTN","PSGOEV",21,0)
 ;PSJ*5*256 - inform user of old schedule name and quit
"RTN","PSGOEV",22,0)
 I $S((PSGORD["P"):$P($G(^PS(53.1,+PSGORD,0)),U,24)'="R",(PSGORD["U"):$P($G(^PS(55,+PSGP,5,+PSGORD,0)),U,24)'="R",1:0) S PSJOLDX="R"
"RTN","PSGOEV",23,0)
 S PSJOLDNM("ORD_SCHD")=$G(PSGSCH)
"RTN","PSGOEV",24,0)
 I $$CHKSCHD^PSJMISC2(.PSJOLDNM,$S($G(PSJOLDX)="R":"R",1:"V")) S CHK=1 G DONE
"RTN","PSGOEV",25,0)
 I PSGORD["P" D CHK($G(^PS(53.1,+PSGORD,0)),$G(^(.2)),$G(^(2)))
"RTN","PSGOEV",26,0)
 I $G(PSGSCH)]"" D
"RTN","PSGOEV",27,0)
 .N X,Y,PSGS0Y,PSGS0XT,PSGOES S PSGOES=1 S X=PSGSCH D ENOS^PSGS0 I $G(X)="" S CHK=4
"RTN","PSGOEV",28,0)
 I $G(CHK) Q:$D(PSJSPEED)  D EN^VALM("PSJU LM ACCEPT") G:'$G(PSJACEPT) DONE ;G VFY
"RTN","PSGOEV",29,0)
 I PSGORD["U" G:'$D(^PS(55,PSGP,5,+PSGORD,4)) VFY I +PSJSYSU=3,$P(^(4),"^",3) W $C(7),!!,"THIS ORDER HAS ALREADY BEEN VERIFIED BY A PHARMACIST." S PSGACT=$P(PSGACT,"V")_$P(PSGACT,"V",2) G DONE
"RTN","PSGOEV",30,0)
 I PSGORD["U" I +PSJSYSU=1,+^PS(55,PSGP,5,+PSGORD,4) W $C(7),!!,"THIS ORDER HAS ALREADY BEEN VERIFIED BY A NURSE." S PSGACT=$P(PSGACT,"V")_$P(PSGACT,"V",2) G DONE
"RTN","PSGOEV",31,0)
 ;
"RTN","PSGOEV",32,0)
VFY ; change status, move to 55, and change label record **ENHANCEMENTS MADE IN PSJ*5.0*260 **CCR 6214 **CCR 6244
"RTN","PSGOEV",33,0)
 I PSGORD["P" S PSJCOM=+$P($G(^PS(53.1,+PSGORD,.2)),"^",8) I PSJCOM D VFY^PSJCOM Q
"RTN","PSGOEV",34,0)
 NEW PSJDOSE,PSJDSFLG,PSJDIS,PSGORQF,PSJCNT,PSJCNT1,PSJCNT2,LIST,PSJFLG,PSGDN SET PSJDIS="",PSJCNT=0,PSJCNT1="",PSJCNT2="",LIST="PSGPRE",PSJFLG="",PSGDN=""
"RTN","PSGOEV",35,0)
 D DOSECHK^PSJDOSE
"RTN","PSGOEV",36,0)
 SET PSJFLG=+$G(PSGORD)
"RTN","PSGOEV",37,0)
 FOR  SET PSJCNT=$O(^PS(53.1,PSJFLG,1,PSJCNT)) Q:'+PSJCNT  D
"RTN","PSGOEV",38,0)
 .IF $D(^PS(53.1,PSJFLG,1,PSJCNT,0)) SET PSGDN=$P($G(^PS(53.1,PSJFLG,1,PSJCNT,0)),U,1)
"RTN","PSGOEV",39,0)
 .IF +$G(PSGDN),($P($G(^PSDRUG(PSGDN,0)),U,3)'["S")&($E($P($G(^PSDRUG(PSGDN,0)),U,2),1,2)'="XA")  D
"RTN","PSGOEV",40,0)
 ..D PROFILE^PSJBLDOC($G(DFN),LIST,"I;"_$G(PSGORD))
"RTN","PSGOEV",41,0)
 ..FOR  SET PSJCNT1=$O(^TMP($J,LIST,"IN","PROFILE",PSJCNT1)) Q:(PSJCNT1="")!(PSJDIS'="")  D
"RTN","PSGOEV",42,0)
 ...SET PSJCNT2=$P(PSJCNT1,";",2)
"RTN","PSGOEV",43,0)
 ...IF PSJCNT2=$G(PSGORD) SET PSJDIS=$P(^TMP($J,LIST,"IN","PROFILE",PSJCNT1),U,3)
"RTN","PSGOEV",44,0)
 ..;**Do order checks if PSJDIS (Dispense drug IEN) has a value
"RTN","PSGOEV",45,0)
 ..;IF $G(PSJNEWOE)=0,'$G(PSJLMFIN),'$G(PSJSTARI),'$G(PSGCOPY),$G(PSJDIS),'$G(PSJSPEED)  D
"RTN","PSGOEV",46,0)
 ..IF '+$G(PSJNEWOE),'$G(PSJLMFIN),'$G(PSJSTARI),'$G(PSGCOPY),$G(PSJDIS),'$G(PSJSPEED)  D
"RTN","PSGOEV",47,0)
 ...D ALLERGY($G(PSJORD),.PSJALLGY),ENDDC^PSGSICHK($G(PSGP),PSJDIS) D:('$G(PSGORQF)&'$G(PSJDSVFY)&'$G(PSJSTARI)) IN^PSJOCDS($G(PSGORD),"UD",PSJDIS) IF $G(PSGORQF) K ^TMP($J,LIST) D:$G(PSJORD)]"" EN^VALM("PSJ LM UD ACTION") QUIT
"RTN","PSGOEV",48,0)
 IF $G(PSGORQF) QUIT
"RTN","PSGOEV",49,0)
 D FULL^VALM1 ;PSJ*5*241
"RTN","PSGOEV",50,0)
 I +$G(PSJDSFLG) D SETVAR^PSJDOSE W !!,PSJDOSE("WARN"),!,PSJDOSE("WARN1") I '$$CONT() W !,"...order was not verified..." D PAUSE^VALM1 D  Q:'$G(PSJACEPT)
"RTN","PSGOEV",51,0)
 . S PSGOEEF(109)=1
"RTN","PSGOEV",52,0)
 . S PSJACEPT=0
"RTN","PSGOEV",53,0)
 . ;D EN^VALM("PSJU LM ACCEPT")
"RTN","PSGOEV",54,0)
 D DDCHK G:CHK DONE
"RTN","PSGOEV",55,0)
 I $G(PSGSCH)]"",((",P,R,")'[(","_PSGST_",")) D  I CHK G DONE
"RTN","PSGOEV",56,0)
 .N SWD,SDW,XABB,X,QX S X=$G(PSGSCH) D DW^PSGS0 Q:($G(X)="")  I $G(PSGS0XT)="" S PSGS0XT="D"
"RTN","PSGOEV",57,0)
 .I $G(PSGS0XT)="D",$G(PSGAT)="" S CHK=1 W !!,"This is a 'DAY OF WEEK' schedule and MUST have admin times.",! D PAUSE^VALM1
"RTN","PSGOEV",58,0)
 I $G(PSGSCH)]"" D  I CHK G DONE
"RTN","PSGOEV",59,0)
 .N X,Y,PSGS0XT,PSGS0Y,PSGOES S PSGOES=2,X=PSGSCH D ENOS^PSGS0 I $G(X)="" S CHK=4
"RTN","PSGOEV",60,0)
 W !,"...a few moments, please..."
"RTN","PSGOEV",61,0)
 I PSGORD["P" D
"RTN","PSGOEV",62,0)
 . N PND0,PSGORDR,PSJPRIO,PSJSCHED S PND0=^PS(53.1,+PSGORD,0) I $P(PND0,U,24)="R" S PSGORDR=$P(PND0,U,25) D  Q
"RTN","PSGOEV",63,0)
 .. N OEORD,OOEORD,FILE55,FILE55N0 S FILE55="^PS(55,"_DFN_$S($P(PND0,U,4)="U":",5,",1:",""IV"","),FILE55N0=FILE55_+PSGORDR_",0)"
"RTN","PSGOEV",64,0)
 .. S OEORD=$P(PND0,U,21) I PSGORDR S OOEORD=$P(@FILE55N0,"^",21) I OEORD'=OOEORD D EXPOE^PSGOER(DFN,PSGORD,+$$LASTREN^PSJLMPRI(DFN,PSGORD))
"RTN","PSGOEV",65,0)
 .. S PSGORDP=PSGORD,DIE="^PS(53.1,",DA=+PSGORD,DR="28////A;104////@" W "." D ^DIE
"RTN","PSGOEV",66,0)
 .. D START^PSGOTR(PSGORD,+PSGORDR) I OEORD D
"RTN","PSGOEV",67,0)
 ... K DA,DR,DIE S DA(1)=DFN,DA=+PSGORDR,DIE=FILE55,DR=$S(DIE["IV":110,1:66)_"////"_+OEORD D ^DIE S DIE=FILE55_+PSGORDR_",0)",$P(@DIE,U,21)=OEORD
"RTN","PSGOEV",68,0)
 ... D EN1^PSJHL2(DFN,"SC",PSGORDR),EN^PSGPEN(PSGORDR),UNL^PSSLOCK(PSGP,PSGORDR)
"RTN","PSGOEV",69,0)
 . S PSGORDP=PSGORD ;Used in ACTLOG to update activity log in 55
"RTN","PSGOEV",70,0)
 . D REQDT^PSJLIVMD(PSGORD)
"RTN","PSGOEV",71,0)
 . S DIE="^PS(53.1,",DA=+PSGORD,DR="28////A" W "." D ^DIE,^PSGOT
"RTN","PSGOEV",72,0)
 . S PSJPRIO=$S(PSGORD["P":$P($G(^PS(53.1,+PSGORD,.2)),"^",4),PSGORD["U":$P($G(^PS(55,DFN,5,+PSGORD,.2)),"^",4),1:$P($G(^PS(55,PSJHLDFN,"IV",+PSGORD,.2)),"^",4))
"RTN","PSGOEV",73,0)
 . S PSJSCHED=$S(PSGORD["P":$P($G(^PS(53.1,+PSGORD,2)),"^"),PSGORD["U":$P($G(^PS(55,DFN,5,+PSGORD,2)),"^"),1:$P($G(^PS(55,PSJHLDFN,"IV",+PSGORD,0)),"^",15))
"RTN","PSGOEV",74,0)
 . I (",S,A,")[(","_$G(PSJPRIO)_",")!($G(PSJSCHED)="NOW")!($G(PSJSCHED)["STAT") D NOTIFY^PSJHL4(PSGORD,DFN,$G(PSJPRIO),$G(PSJSCHED))
"RTN","PSGOEV",75,0)
 . I $G(PSGRDTX)="" S PSGRDTX=$G(^PS(53.1,+PSGORDP,2.5))
"RTN","PSGOEV",76,0)
 S DA=+PSGORD,DA(1)=PSGP,PSGAL("C")=PSJSYSU*10+22000 D ^PSGAL5 W "." S VND4=$G(^PS(55,PSGP,5,DA,4))
"RTN","PSGOEV",77,0)
 I $G(PSGRDTX) D NEWUDAL^PSGAL5(PSGP,PSGORD,6090,"Requested Start Date",+$G(PSGRDTX))
"RTN","PSGOEV",78,0)
 I $P($G(PSGRDTX),U,3) D NEWUDAL^PSGAL5(PSGP,PSGORD,6090,"Requested Stop Date",+$P($G(PSGRDTX),U,3))
"RTN","PSGOEV",79,0)
 N DUR,DURON S DURON=$S($G(PSGORD):$G(PSGORD),1:"") I DURON D
"RTN","PSGOEV",80,0)
 . S DUR=$S($P($G(PSGRDTX),U,2)]"":$P($G(PSGRDTX),U,2),1:$$GETDUR^PSJLIVMD(PSGP,+DURON,$S($G(DURON)["P":"P",1:5),1),1:"")
"RTN","PSGOEV",81,0)
 I $G(DUR)]"" S $P(^PS(55,PSGP,5,+PSGORD,2.5),"^",2)=DUR
"RTN","PSGOEV",82,0)
 D:$D(PSGORDP) ACTLOG(PSGORDP,PSGP,PSGORD)
"RTN","PSGOEV",83,0)
 K PSGRSD,PSGRFD,PSGALFN
"RTN","PSGOEV",84,0)
 NEW X S X=0 I $G(PSGONF),(+$G(PSGODDD(1))'<+$G(PSGONF)) S X=1
"RTN","PSGOEV",85,0)
 I +PSJSYSU=3,PSGORD'["O",$S(X:0,'$P(VND4,"^",9):1,1:$P(VND4,"^",15)) D EN^PSGPEN(+PSGORD)
"RTN","PSGOEV",86,0)
 S $P(VND4,"^",+PSJSYSU=1+9)=1 S:'$P(VND4,U,+PSJSYSU=3+9) $P(VND4,U,+PSJSYSU=3+9)=+$P(VND4,U,+PSJSYSU=3+9)
"RTN","PSGOEV",87,0)
 I PSJSYSL>1 S $P(^PS(55,PSGP,5,+PSGORD,7),U)=PSGDT S:$P(^(7),U,2)="" $P(^(7),U,2)="N"_$S($P(^PS(55,PSGP,5,+PSGORD,0),"^",24)="E":"E",1:"") S PSGTOL=2,PSGUOW=DUZ,PSGTOO=1,DA=+PSGORD D ENL^PSGVDS
"RTN","PSGOEV",88,0)
 S:$P(VND4,"^",15)&'$P(VND4,"^",16) $P(VND4,"^",15)="" S:$P(VND4,"^",18)&'$P(VND4,"^",19) $P(VND4,"^",18)="" S:$P(VND4,"^",22)&'$P(VND4,"^",23) $P(VND4,"^",22)="" S $P(VND4,"^",PSJSYSU,PSJSYSU+1)=DUZ_"^"_PSGDT,^PS(55,PSGP,5,+PSGORD,4)=VND4
"RTN","PSGOEV",89,0)
 I '$P(VND4,U,9) S ^PS(55,"APV",PSGP,+PSGORD)=""
"RTN","PSGOEV",90,0)
 I '$P(VND4,U,10) S ^PS(55,"ANV",PSGP,+PSGORD)=""
"RTN","PSGOEV",91,0)
 I $P(VND4,U,9) K ^PS(55,"APV",PSGP,+PSGORD)
"RTN","PSGOEV",92,0)
 I $P(VND4,U,10) K ^PS(55,"ANV",PSGP,+PSGORD)
"RTN","PSGOEV",93,0)
 W:'$D(PSJSPEED) ! W !,"ORDER VERIFIED.",!
"RTN","PSGOEV",94,0)
 I '$D(PSJSPEED) K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","PSGOEV",95,0)
 S:+PSJSYSU=3 ^PS(55,"AUE",PSGP,+PSGORD)="" S PSGACT="C"_$S('$D(^PS(55,PSGP,5,+PSGORD,4)):"E",$P(^(4),"^",16):"",1:"E")_"RS",PSGCANFL=2
"RTN","PSGOEV",96,0)
 S VALMBCK="Q" D EN1^PSJHL2(PSGP,$S(+PSJSYSU=3:"SC",+PSJSYSU=1:"SC",1:"XX"),+PSGORD_"U")     ; allow status change to be sent for pharmacists & nurses
"RTN","PSGOEV",97,0)
 S ^TMP("PSODAOC",$J,"IP IEN")=$G(PSJORD),^TMP("PSODAOC",$J,"IP NEW IEN")=$G(PSGORD)
"RTN","PSGOEV",98,0)
 ; -- RTC 198753 - clean-up variable - K PSJAGYSV
"RTN","PSGOEV",99,0)
 D SETOC^PSJNEWOC(PSGORD) K PSJAGYSV
"RTN","PSGOEV",100,0)
  ; **This is where the Automated Dispensing Machine hook is called. Do NOT DELETE or change this location **
"RTN","PSGOEV",101,0)
 D NEWJ^PSJADM
"RTN","PSGOEV",102,0)
  ; **END of Interface hook **
"RTN","PSGOEV",103,0)
 D:+PSJSYSU=1 EN1^PSJHL2(PSGP,"ZV",+PSGORD_"U")
"RTN","PSGOEV",104,0)
DONE ;
"RTN","PSGOEV",105,0)
 W:CHK !!,"...order NOT verified..."
"RTN","PSGOEV",106,0)
 I '$D(PSJSPEED),'CHK,+PSJSYSU=3,$G(PSJPRI)="D" D
"RTN","PSGOEV",107,0)
 .N DIR W ! S DIR(0)="S^Y:Yes;N:No",DIR("A")="Do you want to enter a Progress Note",DIR("B")="No" D ^DIR
"RTN","PSGOEV",108,0)
 .Q:Y="N"
"RTN","PSGOEV",109,0)
 .D MAIN^TIUEDIT(3,.TIUDA,PSGP,"","","","",1)
"RTN","PSGOEV",110,0)
 S VALMBCK="Q" K CHK,DA,DIE,F,DP,DR,ND,PSGAL,PSGODA,PSGTOL,PSGTOO,PSGUOW,PSJDOSE,PSJVAR,VND4,X,ZZND Q
"RTN","PSGOEV",111,0)
 ;
"RTN","PSGOEV",112,0)
LBL ;
"RTN","PSGOEV",113,0)
 Q
"RTN","PSGOEV",114,0)
 ;
"RTN","PSGOEV",115,0)
ALLERGY(PSGORD,PSJALLGY) ;setup PSJALLGY when non-vf was selected to verify
"RTN","PSGOEV",116,0)
 NEW PSGDDI,PSJDD,PSJX
"RTN","PSGOEV",117,0)
 I '+$G(PSGORD),($G(PSGORD)'["P") Q
"RTN","PSGOEV",118,0)
 F PSGDDI=0:0 S PSGDDI=$O(^PS(53.1,+PSGORD,1,PSGDDI)) Q:'PSGDDI  D
"RTN","PSGOEV",119,0)
 . S PSJDD=+$G(^PS(53.1,+PSGORD,1,PSGDDI,0))
"RTN","PSGOEV",120,0)
 . S PSJX=$S('$D(^PSDRUG(+PSJDD,0)):1,$P($G(^(2)),U,3)'["U":1,$G(^("I"))="":0,1:^("I")'>$G(DT))
"RTN","PSGOEV",121,0)
 . Q:PSJX
"RTN","PSGOEV",122,0)
 . S PSJALLGY(PSJDD)=""
"RTN","PSGOEV",123,0)
 Q
"RTN","PSGOEV",124,0)
CHK(ND,DRG,ND2) ; checks for data in required fields
"RTN","PSGOEV",125,0)
 ; Input: ND  - ^(PS(53.1,PSGORD,0)
"RTN","PSGOEV",126,0)
 ;        DRG - ^(.2)
"RTN","PSGOEV",127,0)
 ;        ND2 - ^(2)
"RTN","PSGOEV",128,0)
 S Y=$G(Y)
"RTN","PSGOEV",129,0)
 S CHK="" I DRG,$D(^PS(50.7,+DRG,0))
"RTN","PSGOEV",130,0)
 E  S CHK=1
"RTN","PSGOEV",131,0)
 I ND="" S CHK=CHK_23
"RTN","PSGOEV",132,0)
 E  S CHK=CHK_$S($P(ND,"^",3):"",1:2)_$S($P(ND,"^",7)]"":"",1:3)
"RTN","PSGOEV",133,0)
 ;The naked reference on the line below refers to the variable ND which is ^PS(53.1,PSGORD,0).
"RTN","PSGOEV",134,0)
 I ND2="" S CHK=CHK_$S('$D(^(0)):4,$P(^(0),"^",7)="OC":"",1:4)_56
"RTN","PSGOEV",135,0)
 E  S CHK=CHK_$S($P(ND2,"^")]"":"",ND="":4,$P(ND,"^",7)="OC":"",1:4)_$S($P(ND2,"^",2):"",1:5)_$S($P(ND2,"^",4):"",1:6)
"RTN","PSGOEV",136,0)
 I $$CHECK^PSGOE8(PSJSYSP),$P(DRG,U,2)="" S CHK=CHK_8
"RTN","PSGOEV",137,0)
 K PSGDFLG,PSGPFLG S PSGDI=0
"RTN","PSGOEV",138,0)
 S:'$$DDOK^PSGOE2("^PS(53.45,"_PSJSYSP_",2,",+DRG) CHK=CHK_7,(PSGDFLG,PSGDI)=1
"RTN","PSGOEV",139,0)
 S:'$$OIOK^PSGOE2(+DRG) PSGPFLG=1
"RTN","PSGOEV",140,0)
 I 'CHK,$G(PSGSCH)]"" D
"RTN","PSGOEV",141,0)
 .N X,Y,PSGS0Y,PSGS0XT,PSGOES S PSGOES=2,X=PSGSCH D ENOS^PSGS0 I $G(X)="" S CHK=4
"RTN","PSGOEV",142,0)
 Q:'CHK
"RTN","PSGOEV",143,0)
 W $C(7)
"RTN","PSGOEV",144,0)
 ;
"RTN","PSGOEV",145,0)
CHKM ;
"RTN","PSGOEV",146,0)
 D FULL^VALM1 K:CHK Y
"RTN","PSGOEV",147,0)
 ; changed to remove ^DD ref
"RTN","PSGOEV",148,0)
 ; PSJ*5*267 VMP Add the 8th condition
"RTN","PSGOEV",149,0)
 W !!,"THE FOLLOWING ",$S($L(CHK)>1:"ARE",1:"IS")," EITHER INVALID OR MISSING FROM THIS ORDER:" F X=1:1:8 W:CHK[X !?5,$P("ORDERABLE ITEM^MED ROUTE^SCHEDULE TYPE^SCHEDULE^START DATE/TIME^STOP DATE/TIME^DISPENSE DRUG^DOSAGE ORDERED","^",X)
"RTN","PSGOEV",150,0)
 I CHK=7 W !,"Orders with no dispense drugs or multiple dispense drugs",!,"require dosage ordered"
"RTN","PSGOEV",151,0)
 W:CHK]"" !!,$S($L(CHK)>1:"THESE FIELDS ARE",1:"THIS FIELD IS")," NECESSARY FOR VERIFICATION."
"RTN","PSGOEV",152,0)
 N DIR,DUOUT,DTOUT S DIR(0)="E" D ^DIR I $D(DUOUT)!$D(DTOUT) S CHK=1 Q
"RTN","PSGOEV",153,0)
 Q
"RTN","PSGOEV",154,0)
 ;
"RTN","PSGOEV",155,0)
CONT() ;
"RTN","PSGOEV",156,0)
 NEW DIR,DIRUT,Y
"RTN","PSGOEV",157,0)
 W ! K DIR,DIRUT
"RTN","PSGOEV",158,0)
 S DIR(0)="Y",DIR("A")="Would you like to continue verifying the order",DIR("B")="No"
"RTN","PSGOEV",159,0)
 D ^DIR
"RTN","PSGOEV",160,0)
 Q Y
"RTN","PSGOEV",161,0)
 ;
"RTN","PSGOEV",162,0)
DDCHK ; dispense drug check
"RTN","PSGOEV",163,0)
 S DRGF="^PS("_$S(PSGORD["P":"53.1,"_+PSGORD,1:"55,"_PSGP_",5,"_+PSGORD)_",",CHK=$S('$O(@(DRGF_"1,0)")):7,1:0)
"RTN","PSGOEV",164,0)
 S PSGPD=$G(@(DRGF_".2)"))
"RTN","PSGOEV",165,0)
 S CHK=$S('$$DDOK^PSGOE2(DRGF_"1,",PSGPD):7,1:0)
"RTN","PSGOEV",166,0)
 Q:CHK=0
"RTN","PSGOEV",167,0)
 W $C(7),!!,"This order must have at least one valid, active dispense drug to be verified."
"RTN","PSGOEV",168,0)
 ;
"RTN","PSGOEV",169,0)
DDEDIT ;
"RTN","PSGOEV",170,0)
 ;*** Remove all dispense drug for this order
"RTN","PSGOEV",171,0)
 K @(DRGF_"1)")
"RTN","PSGOEV",172,0)
 ; The naked reference below refers to the indirect full reference in DRGF_"1,"_Q_")", which is either ^PS(53.1,+PSGORD,Q) or ^PS(55,DFN,5,+PSGORD,Q)
"RTN","PSGOEV",173,0)
 K ^PS(53.45,PSJSYSP,2) S (X,Q)=0 F  S Q=$O(@(DRGF_"1,"_Q_")")) Q:'Q  S Y=$G(^(Q,0)),X=Q S ^PS(53.45,PSJSYSP,2,Q,0)=Y I Y S ^PS(53.45,PSJSYSP,2,"B",+Y,Q)=""
"RTN","PSGOEV",174,0)
 I X S ^PS(53.45,PSJSYSP,2,0)="^53.4502P^"_X_"^"_X
"RTN","PSGOEV",175,0)
 D ENDRG^PSGOEF1(PSGPD,X)
"RTN","PSGOEV",176,0)
 I 'CHK S %X="^PS(53.45,"_PSJSYSP_",2,",%Y=DRGF_"1," D %XY^%RCR S $P(@(DRGF_"1,0)"),"^",2)=$S(DRGF[53.1:"53.11P",1:"55.07P")
"RTN","PSGOEV",177,0)
 K DRG,DRGF,%X,%Y,PSGPD Q
"RTN","PSGOEV",178,0)
 ;
"RTN","PSGOEV",179,0)
AESCREEN() ;
"RTN","PSGOEV",180,0)
 ; Output: 0 - Required fields missing and DON'T allow accept
"RTN","PSGOEV",181,0)
 ;         1 - Required fields found.
"RTN","PSGOEV",182,0)
 Q:'$G(CHK) 1
"RTN","PSGOEV",183,0)
 S Y=$P($G(^ORD(101,+$G(^ORD(101,DA(1),10,DA,0)),0)),U) I Y="" Q 0
"RTN","PSGOEV",184,0)
 I Y="PSJU LM ACCEPT EDIT" Q 1
"RTN","PSGOEV",185,0)
 Q 0
"RTN","PSGOEV",186,0)
ACTLOG(PSGORDP,DFN,PSGORD)  ;Store 53.1 activity log in local array to be moved to 55
"RTN","PSGOEV",187,0)
 ;PSGORDP: IEN from 53.1
"RTN","PSGOEV",188,0)
 ;PSGORD : IEN from 55
"RTN","PSGOEV",189,0)
 NEW PSGX,PSGXDA,PSGAL531,Q,QQ
"RTN","PSGOEV",190,0)
 F PSGX=0:0 S PSGX=$O(^PS(53.1,+PSGORDP,"A",PSGX)) Q:'PSGX  D
"RTN","PSGOEV",191,0)
 . S PSGAL531=$G(^PS(53.1,+PSGORDP,"A",PSGX,0))
"RTN","PSGOEV",192,0)
 . S QQ=$G(^PS(55,DFN,5,+PSGORD,9,0)) S:QQ="" QQ="^55.09D" F Q=$P(QQ,U,3)+1:1 I '$D(^(Q)) S $P(QQ,U,3,4)=Q_U_Q,^(0)=QQ,PSGXDA=Q Q
"RTN","PSGOEV",193,0)
 . S ^PS(55,DFN,5,+PSGORD,9,PSGXDA,0)=PSGAL531
"RTN","PSGOEV",194,0)
 . N TXTLN S TXTLN="" F  S TXTLN=$O(^PS(53.1,+PSGORDP,"A",PSGX,1,TXTLN)) Q:TXTLN=""  D
"RTN","PSGOEV",195,0)
 .. I TXTLN=0 S ^PS(55,DFN,5,+PSGORD,9,PSGXDA,1,TXTLN)=^PS(53.1,+PSGORDP,"A",PSGX,1,TXTLN) Q
"RTN","PSGOEV",196,0)
 .. S ^PS(55,DFN,5,+PSGORD,9,PSGXDA,1,TXTLN,0)=^PS(53.1,+PSGORDP,"A",PSGX,1,TXTLN,0)
"RTN","PSGOEV",197,0)
 Q
"RTN","PSGS0")
0^1^B78819959
"RTN","PSGS0",1,0)
PSGS0 ;BIR/CML3 - SCHEDULE PROCESSOR ;06/22/09 7:12 PM
"RTN","PSGS0",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**12,25,26,50,63,74,83,116,110,111,133,138,174,134,213,207,190,113,245,227,256**;16 DEC 97;Build 34
"RTN","PSGS0",3,0)
 ;
"RTN","PSGS0",4,0)
 ; Reference to ^PS(51.1 is supported by DBIA 2177.
"RTN","PSGS0",5,0)
 ; Reference to ^PS(55   is supported by DBIA 2191.
"RTN","PSGS0",6,0)
 ;
"RTN","PSGS0",7,0)
ENA ; entry point for train option
"RTN","PSGS0",8,0)
 D ENCV^PSGSETU Q:$D(XQUIT)
"RTN","PSGS0",9,0)
 F  S (PSGS0Y,PSGS0XT)="" R !!,"Select STANDARD SCHEDULE: ",X:DTIME W:'$T $C(7) S:'$T X="^" Q:"^"[X  D:X?1."?" ENQ^PSGSH I X'?1."?" D EN W:$D(X)[0 $C(7),"  ??" I $D(X)#2,'PSGS0Y,PSGS0XT W "  Every ",PSGS0XT," minutes"
"RTN","PSGS0",10,0)
 K DIC,DIE,PSGS0XT,PSGS0Y,Q,X,Y,PSGDT Q
"RTN","PSGS0",11,0)
 ;
"RTN","PSGS0",12,0)
EN3 ;
"RTN","PSGS0",13,0)
 S PSGST=$P($G(^PS(53.1,DA,0)),"^",7) G EN
"RTN","PSGS0",14,0)
 ;
"RTN","PSGS0",15,0)
EN5 ;
"RTN","PSGS0",16,0)
 S PSGST=$P($G(^PS(55,DA(1),5,DA,0)),"^",7)
"RTN","PSGS0",17,0)
 ;
"RTN","PSGS0",18,0)
EN ; validate
"RTN","PSGS0",19,0)
 K PSGS0Y
"RTN","PSGS0",20,0)
 I X[""""!($A(X)=45)!(X?.E1C.E)!($L(X)>70)!($L(X)<1) K X Q
"RTN","PSGS0",21,0)
 S:X'=" " X=$$TRIM^XLFSTR(X,"R"," ") ;PSJ*5*227 - Prevent schedule crash
"RTN","PSGS0",22,0)
 I X?.E1L.E S X=$$ENLU^PSGMI(X) I '$D(PSGOES) D EN^DDIOL("  ("_X_")")
"RTN","PSGS0",23,0)
 ;
"RTN","PSGS0",24,0)
ENOS ; order set entry
"RTN","PSGS0",25,0)
 N X0,Y0,PSJXI,PSJDIC2,TMPAT
"RTN","PSGS0",26,0)
 I $G(X)="",$G(P(2)),$G(P(3)) S X=$G(P(9))
"RTN","PSGS0",27,0)
 I $G(X)="" Q
"RTN","PSGS0",28,0)
 S PSGXT=$G(PSGS0XT),(PSGS0XT,PSGS0Y,XT,Y,PSJNSS)=""
"RTN","PSGS0",29,0)
 S X0=X I X?2.4N1"-".E!(X?2.4N) D ENCHK S:$D(X) Y=X G Q
"RTN","PSGS0",30,0)
 ; * GUI 27 CHANGES * Check for admin times to be derived from 'base' schedule
"RTN","PSGS0",31,0)
 I X["@" S TMPAT=$P(X,"@",2) I TMPAT]"" D
"RTN","PSGS0",32,0)
 .I '$D(^PS(51.1,"AC","PSJ",TMPAT)) K TMPAT Q
"RTN","PSGS0",33,0)
 .I '$$DOW^PSIVUTL($P(X,"@")) K TMPAT Q
"RTN","PSGS0",34,0)
 .N LYN,ZZND,PSGS0XT,PSGS0Y,X S (PSGS0Y,PSGS0XT,X)=""
"RTN","PSGS0",35,0)
 .S X=TMPAT D DIC I $G(Y0)>0 S TMPAT=Y0
"RTN","PSGS0",36,0)
 I $G(TMPAT) S (PSGS0Y,$P(X,"@",2))=TMPAT,PSGS0XT="D"
"RTN","PSGS0",37,0)
 ; * GUI 27 CHANGES *
"RTN","PSGS0",38,0)
 I X["PRN",$$PRNOK(X),'$D(^PS(51.1,"AC","PSJ",X)) D  G Q
"RTN","PSGS0",39,0)
 .;PSJ*5*190 Check for One-time PRN
"RTN","PSGS0",40,0)
 .I $$ONE^PSJBCMA($G(DFN),$G(ON),X)="O" S XT="O" Q
"RTN","PSGS0",41,0)
 .I X["@"!$$DOW^PSIVUTL($P(X," PRN")) N DOW D  I $G(DOW) S (Y0,Y,PSGS0Y)=$P($P(X,"@",2)," ")
"RTN","PSGS0",42,0)
 ..N TMP S TMP=X N X S X=$P(TMP," PRN") D DW I $G(X)]"" S DOW=1
"RTN","PSGS0",43,0)
 ..I $G(DOW),$G(PSGST)]"" I ",P,R,"'[(","_PSGST_",") S (XT,PSGS0XT)="D"
"RTN","PSGS0",44,0)
 D DIC I $G(XT)]""!$G(Y0)!($G(X)]""&$G(PSJXI)) D  Q:'$D(X)  I $G(X)]"",PSGS0XT'="D" G:$D(^PS(51.1,"AC","PSJ",X)) Q3 I $P(X,"@")]"" G:$D(^PS(51.1,"AC","PSJ",$P(X,"@"))) Q3
"RTN","PSGS0",45,0)
 .S PSGS0XT=XT S:$G(Y0) (Y,PSGS0Y)=Y0 S:'PSGS0Y&((PSGS0XT)="D")&(X["@") PSGS0Y=$P(X,"@",2)
"RTN","PSGS0",46,0)
 .S PSGS0Y=$P(PSGS0Y," ")
"RTN","PSGS0",47,0)
 .; If entering from Verify action, and schedule exists in schedule file, and order's schedule is continuous,
"RTN","PSGS0",48,0)
 .; OR the order's schedule type is fill on request and the order's schedule is defined as continuous in schedule file,
"RTN","PSGS0",49,0)
 .; AND the order's schedule is not a PRN schedule, the order must have admin times.
"RTN","PSGS0",50,0)
 .Q:$G(PSGOES)'=2  Q:'$D(^PS(51.1,"AC","PSJ",X))
"RTN","PSGS0",51,0)
 .I $G(PSGST)="C"!($G(PSGST)="R"&($P($G(ZZND),"^",3))) I ($G(PSGST)'="P"),($G(PSGSCH)'[" PRN"),('$G(PSGAT)&'$G(PSGS0Y)),'$$ODD^PSGS0($G(PSGS0XT)) Q:($P($G(ZZND),"^",5)="O")  Q:$$ODD^PSGS0($P(ZZND,"^",3))  K X Q
"RTN","PSGS0",52,0)
 N TMPSCHX S TMPSCHX=X I $L(X,"@")<3 S TMPX=X D DW I $G(X)]"" K PSJNSS S (PSGS0XT,XT)="D" D  G Q
"RTN","PSGS0",53,0)
 .S Y=$S(($G(TMPSCHX)["@"):$P(TMPSCHX,"@",2),1:"")
"RTN","PSGS0",54,0)
 .I Y,(X'["@"),(TMPSCHX["@") S X=TMPSCHX
"RTN","PSGS0",55,0)
 S X=TMPSCHX
"RTN","PSGS0",56,0)
 I X'="" I $D(^PS(51.1,"AC","PSJ",X)) K PSJNSS G Q
"RTN","PSGS0",57,0)
 ;
"RTN","PSGS0",58,0)
NS I ($G(X)="^")!($G(X)="") K X S Y="" Q
"RTN","PSGS0",59,0)
 N NS S NS=0,PSJNSS=0
"RTN","PSGS0",60,0)
 I $G(Y)'>0 S X=X0,Y="",NS=1,PSJNSS=1
"RTN","PSGS0",61,0)
Q ;
"RTN","PSGS0",62,0)
 S PSGS0XT=$S(XT]"":XT,1:$G(PSGS0XT)),PSGS0Y=$S($G(Y):Y,$G(PSGS0Y):PSGS0Y,1:"") S:PSGS0XT<0 PSGS0XT=""
"RTN","PSGS0",63,0)
 I ('$G(PSGS0Y)&'$G(PSJDIC2)&$G(PSGAT))&'$G(PSJNEWOE)&$G(PSGS0XT) I PSGS0XT<1441 I ($L($G(PSGAT),"-")=PSGS0XT/1440)!($G(X)]""&($G(PSGSCH)=$G(X))) S PSGS0Y=$G(PSGAT)
"RTN","PSGS0",64,0)
Q2 K YY
"RTN","PSGS0",65,0)
 I '$G(PSJNSS),'$G(PSGS0Y),$G(YY) S PSGS0Y=YY
"RTN","PSGS0",66,0)
 I $G(X)]"",$$SCHREQ^PSJLIVFD(.P) D
"RTN","PSGS0",67,0)
 .I $$DOW^PSIVUTL(X)!$$PRNOK(X)!$D(^PS(51.1,"AC","PSJ",X)) S PSJNSS=0 Q
"RTN","PSGS0",68,0)
 .I $G(P(2))&$G(P(3)) D NSSCONT(X,PSGS0XT) S TMPX="" K X
"RTN","PSGS0",69,0)
 I ($G(PSJNSS)&($G(VALMBCK)'="Q"))!($G(PSJNSS)&$G(PSJLIFNI))!($G(PSJNSS)&$G(PSJTUD)) D
"RTN","PSGS0",70,0)
 .I $G(P(2))&$G(P(3)) Q
"RTN","PSGS0",71,0)
 .I ($G(X)]"") I ($G(PSGS0XT)'="D") D NSSCONT(X,PSGS0XT) S TMPX="" K X
"RTN","PSGS0",72,0)
Q3 I $G(X)]"" I $D(^PS(51.1,"AC","PSJ",X)) K PSJNSS
"RTN","PSGS0",73,0)
 K QX,SDW,SWD,X0,XT,Z Q
"RTN","PSGS0",74,0)
 ;
"RTN","PSGS0",75,0)
NSSCONT(SCH,FREQ) ;
"RTN","PSGS0",76,0)
 Q:SCH=""!($G(VALMBCK)]"")!$G(PSGMARSD)!$G(PSIVFN1)
"RTN","PSGS0",77,0)
 I $G(PSGOES),'$G(NSFF) Q
"RTN","PSGS0",78,0)
 N PSGS0XT,PSGSCH,DIR,X,Y S PSGSCH=SCH,PSGS0XT=FREQ,PSJNSS=1
"RTN","PSGS0",79,0)
 D NSSMSG I ($L(PSJNSS)>2),'$G(PSJXI) W !!,PSJNSS,! S PSJNSS=1
"RTN","PSGS0",80,0)
 S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR
"RTN","PSGS0",81,0)
 K NSFF Q
"RTN","PSGS0",82,0)
 ;
"RTN","PSGS0",83,0)
NSSMSG ;
"RTN","PSGS0",84,0)
 Q:$G(PSJXI)
"RTN","PSGS0",85,0)
 I '(",O,"[(","_$G(PSGST)_",")),$G(PSJNSS),$G(PSGSCH)]"" D
"RTN","PSGS0",86,0)
 .S PSJNSS=" WARNING - "_PSGSCH_" is an invalid schedule."
"RTN","PSGS0",87,0)
 S PSGSCH="",PSGS0XT=""
"RTN","PSGS0",88,0)
 Q
"RTN","PSGS0",89,0)
 ;
"RTN","PSGS0",90,0)
NSO(FQ) ;
"RTN","PSGS0",91,0)
 Q:'FQ!(FQ<0)!(",D,O,"[(","_$G(PSGST)_",")) ""
"RTN","PSGS0",92,0)
 K FRQOUT S FRQOUT=$S(FQ<60:(FQ_"minute"),(FQ<1440)&(FQ#60):(FQ_" minute"),(FQ<1440)!(FQ#1440):(FQ/60_" hour"),1:(FQ/1440_" day")) D
"RTN","PSGS0",93,0)
 . S:(+FRQOUT'=1) FRQOUT=FRQOUT_"s"
"RTN","PSGS0",94,0)
 Q FRQOUT
"RTN","PSGS0",95,0)
 ;
"RTN","PSGS0",96,0)
ENCHK ;
"RTN","PSGS0",97,0)
 N H,I
"RTN","PSGS0",98,0)
 I $S($L($P(X,"-"))>4:1,$L(X)>119:1,$L(X)<2:1,X'>0:1,1:X'?.ANP) K X Q
"RTN","PSGS0",99,0)
 S X(1)=$P(X,"-") I X(1)'?2N,X(1)'?4N K X Q
"RTN","PSGS0",100,0)
 S X(1)=$L(X(1)) I X'["-"&((X>$E(2400,1,X(1))!($E(X,3,4)>59))) K X Q
"RTN","PSGS0",101,0)
 F X(2)=2:1:$L(X,"-") S X(3)=$P(X,"-",X(2)) I $S($L(X(3))'=X(1):1,X(3)>$E(2400,1,X(1)):1,$E(X(3),3,4)>59:1,1:X(3)'>$P(X,"-",X(2)-1)) K X Q
"RTN","PSGS0",102,0)
 Q:'$D(X)
"RTN","PSGS0",103,0)
 F X(2)=1:1:$L(X,"-") S X(3)=$P(X,"-",X(2)) I $E(X(3),3,4)>59 K X Q
"RTN","PSGS0",104,0)
 Q:'$D(X)
"RTN","PSGS0",105,0)
 S X(1)=$L(X,"-"),X(2)=$G(PSGS0XT),PSGSCH=$S($G(PSGSCH)]"":PSGSCH,1:$G(P(9)))
"RTN","PSGS0",106,0)
 I $G(PSGSCH)="" Q  ;No schedule info, so just validate the numbers and quit.
"RTN","PSGS0",107,0)
 I $D(^PS(51.1,"AC","PSJ",PSGSCH)) S H=+$O(^PS(51.1,"AC","PSJ",PSGSCH,0)) S I=$P($G(^PS(51.1,H,0)),"^",5)
"RTN","PSGS0",108,0)
 I $G(I)="" S I=$S(PSGSCH["PRN":"P",1:"C")
"RTN","PSGS0",109,0)
 I I="D",$L(X,"-")>0 K:$D(X) X(1),X(2),X(3) S I="C" Q  ;DOW schedules require at least one admin time
"RTN","PSGS0",110,0)
 I $G(I)="O" D  Q  ;One Time schedules
"RTN","PSGS0",111,0)
 . I $L(X,"-")>1 K X Q  ;One Time schedules allow one admin time
"RTN","PSGS0",112,0)
 I X(2)="" Q  ;No frequency - cannot validate admin times to frequency
"RTN","PSGS0",113,0)
 I X(2)>1439,$L(X,"-")>1 K X Q  ;PSJ*5*113 Schedules with frequency greater than 1 day can only have one admin time.
"RTN","PSGS0",114,0)
 I X(2)>0,X(2)<1440,X(1)>(1440/X(2)) K X Q  ;PSJ*5*113 Admin times must match frequency or fewer
"RTN","PSGS0",115,0)
 I X(2)>0,X(2)<1440,1440#X(2)'=0,X(1)>0 K X Q  ;PSJ*5*113 Odd schedules cannot have admin times
"RTN","PSGS0",116,0)
 I X(2)>0,X(2)>1440,X(2)#1440'=0,X(1)>1 K X Q  ;PSJ*5*113 Odd schedules cannot have admin times
"RTN","PSGS0",117,0)
 K:$D(X) X(1),X(2),X(3)
"RTN","PSGS0",118,0)
 Q
"RTN","PSGS0",119,0)
 ;
"RTN","PSGS0",120,0)
DIC ; Check for schedule's existence in ADMINISTRATION SCHEDULE file (#51.1)
"RTN","PSGS0",121,0)
 ; Input:    
"RTN","PSGS0",122,0)
 ;           X = Schedule Name
"RTN","PSGS0",123,0)
 ;     PSJSLUP = If $G(PSJSLUP), perform interactive fileman lookup (optional).
"RTN","PSGS0",124,0)
 ;     PSGSFLG = If $G(PSGSFLG), return schedule IEN in PSGSCIEN variable (optional)
"RTN","PSGS0",125,0)
 ;    PSJLIFNI = Flag indicating a U/D order is being finished as an IV (optional).
"RTN","PSGS0",126,0)
 ;      PSGOES = If PSGOES=1, IX^DIC is called silently. If PSGOES=2, IX^DIC is not called (optional).
"RTN","PSGS0",127,0)
 ;      PSJPWD = IEN of Inpatient Ward associated with the patient/order/schedule combination (optional).
"RTN","PSGS0",128,0)
 ; Output:
"RTN","PSGS0",129,0)
 ;           X = Schedule Name if valid Input Schedule X, undefined if invalid Input Schedule X.
"RTN","PSGS0",130,0)
 ;     PSGS0XT = Frequency of validated schedule.
"RTN","PSGS0",131,0)
 ;     PSGS0Y  = Default Admin Times of validated schedule.
"RTN","PSGS0",132,0)
 ;    PSGSCIEN = IEN of validated schedule, if PSGSLFG is passed in and is evaluated to TRUE.
"RTN","PSGS0",133,0)
 ;
"RTN","PSGS0",134,0)
 K Y0,PSJXI N Y,PSGS0ST
"RTN","PSGS0",135,0)
 S Z=0 F PSJXI=0:1 S Z=$O(^PS(51.1,"AC","PSJ",X,Z)) Q:'Z
"RTN","PSGS0",136,0)
 I $G(X)]"",'$G(PSJSLUP) D
"RTN","PSGS0",137,0)
 .I $D(^PS(51.1,"AC","PSJ",X)) D  Q:$G(PSGS0Y)&($G(PSGS0XT)]"")
"RTN","PSGS0",138,0)
 ..;*** PSJ*5*256
"RTN","PSGS0",139,0)
 ..NEW PSGIEN,PSGSCHX
"RTN","PSGS0",140,0)
 ..S PSGIEN=$O(^PS(51.1,"AC","PSJ",X,0)) I +PSGIEN S PSGSCHX=$G(^PS(51.1,+PSGIEN,0)) I $P(PSGSCHX,U,5)="D" S PSGS0XT="D",PSJNSS=0,PSGS0Y=$P(PSGSCHX,U,2) Q
"RTN","PSGS0",141,0)
 ..I $$DOW^PSIVUTL(X) S PSGS0XT="D",PSJNSS=0 S:X["@" (Y0,PSGS0Y)=$P(X,"@",2) Q
"RTN","PSGS0",142,0)
 ..I $G(NSFF) S Y0=$S($G(PSGS0Y):PSGS0Y,$G(PSGAT)&'$G(PSJNEWOE):PSGAT,1:"") S:Y0 PSGS0Y=Y0
"RTN","PSGS0",143,0)
 .; Check for duplicate schedules - force selection
"RTN","PSGS0",144,0)
 .Q:PSJXI>1&('$G(PSGOES))&($G(PSGS0XT)]"")
"RTN","PSGS0",145,0)
 .I $D(^PS(51.1,"AC","PSJ",X)) N FREQ,ADMATCH S FREQ=$G(PSGS0XT) D
"RTN","PSGS0",146,0)
 ..N PSGS0XT,PSGS0Y,PSGST D ADMIN^PSJORPOE S:$G(PSGS0XT) XT=PSGS0XT S:$G(PSGS0Y) (Y0,Y)=PSGS0Y I $G(PSGST)'="" S PSGS0ST=PSGST
"RTN","PSGS0",147,0)
 ..;Check flag PSGSFLG to determine whether to return the schedule IEN in PSGSCIEN.
"RTN","PSGS0",148,0)
 .S:$G(XT)]"" PSGS0XT=XT S:$G(Y) PSGS0Y=Y
"RTN","PSGS0",149,0)
 .I $$DOW^PSIVUTL(X) S:PSGS0XT="" (XT,PSGS0XT)="D" S:PSGS0Y="" (Y0,PSGS0Y)=$S($P(X,"@",2):$P(X,"@",2),1:"")
"RTN","PSGS0",150,0)
 ;I $G(PSJLIFNI)!($G(P(4))]""&($G(P(2))]"")) I '$D(^PS(51.1,"AC","PSJ",X))!($G(PSJXI)>1) S PSJSLUP=1
"RTN","PSGS0",151,0)
 I $G(P(4))]"" I '$D(^PS(51.1,"AC","PSJ",X))!($G(PSJXI)>1) S PSJSLUP=1
"RTN","PSGS0",152,0)
 I $G(NSFF),$G(PSJXI)>1 D
"RTN","PSGS0",153,0)
 .I $G(PSGS0XT)="",$G(NSFF),$G(PSGXT)]"" S PSGS0XT=PSGXT Q
"RTN","PSGS0",154,0)
 .I $G(PSGS0XT)=""!($G(PSGS0Y)="") S PSJSLUP=1
"RTN","PSGS0",155,0)
 I '$G(PSJSLUP) Q:$G(PSGS0XT)]""&($G(PSGS0Y)]"")  Q:($G(PSGS0XT)="D"&('$D(^PS(51.1,"AC","PSJ",X))))
"RTN","PSGS0",156,0)
 Q:$G(PSGOES)=2
"RTN","PSGS0",157,0)
 Q:$G(PSGS0XT)]""&(PSJXI=1)
"RTN","PSGS0",158,0)
 I $G(PSGS0ST)="O",PSJXI=1 Q  ;one-time order,exact match (PSJ*5*207)
"RTN","PSGS0",159,0)
 K PSJSLUP
"RTN","PSGS0",160,0)
 ;*** PSJ*5*256
"RTN","PSGS0",161,0)
 K DIC S DIC="^PS(51.1,",DIC(0)=$S($D(PSGOES):"MZVK",$D(PSJOLDNM):"MZVK",1:"CEMVZK")
"RTN","PSGS0",162,0)
 S DIC("W")="W ""  "","_$S('$D(PSJPWD):"$P(^(0),""^"",2)",'PSJPWD:"$P(^(0),""^"",2)",1:"$S($D(^PS(51.1,+Y,1,+PSJPWD,0)):$P(^(0),""^"",2),1:$P(^PS(51.1,+Y,0),""^"",2))"),D="APPSJ^D"
"RTN","PSGS0",163,0)
 S PSJDIC2=1
"RTN","PSGS0",164,0)
 ;D IX^DIC K DIC S:$D(DIE)#2 DIC=DIE I Y'>0 D  Q
"RTN","PSGS0",165,0)
 D MIX^DIC1 K DIC S:$D(DIE)#2 DIC=DIE I Y'>0 D  Q
"RTN","PSGS0",166,0)
 .I '$$DOW^PSIVUTL(X),'$$PRNOK(X),'$$ODD($G(PSGS0XT)),'$$ODD($P($G(ZZND),"^",3)),($P($G(ZZND),"^",5)'="O") S X="",PSJNSS=1,XT="",PSJXI=""
"RTN","PSGS0",167,0)
 S XT=$S("C"[$P(Y(0),"^",5):$P(Y(0),"^",3),1:$P(Y(0),"^",5))
"RTN","PSGS0",168,0)
 S X=+Y,Y="" I $D(PSJPWD),$D(^PS(51.1,+X,1,+PSJPWD,0)) S Y=$P(^(0),"^",2)
"RTN","PSGS0",169,0)
 ;Check flag PSGSFLG to determine whether to return the schedule IEN in PSGSCIEN.
"RTN","PSGS0",170,0)
 I $G(PSGSFLG) S PSGSCIEN=X
"RTN","PSGS0",171,0)
 S (X,X0)=Y(0,0) S:$G(Y)="" Y=$P(Y(0),"^",2)
"RTN","PSGS0",172,0)
 S (PSGS0Y,Y0)=$G(Y),Y0(0)=Y(0) I $P(Y(0),"^",3) S XT=$P(Y(0),"^",3)
"RTN","PSGS0",173,0)
 I $G(PSGS0XT)="",$$DOW^PSIVUTL(X) S (XT,PSGS0XT)="D"
"RTN","PSGS0",174,0)
 Q
"RTN","PSGS0",175,0)
 ;
"RTN","PSGS0",176,0)
DW ;
"RTN","PSGS0",177,0)
 N Y
"RTN","PSGS0",178,0)
 Q:($L(X,"@")>2)
"RTN","PSGS0",179,0)
 N AT I X["@" S AT=$P(X,"@",2)
"RTN","PSGS0",180,0)
 S SWD="SUNDAYS^MONDAYS^TUESDAYS^WEDNESDAYS^THURSDAYS^FRIDAYS^SATURDAYS",SDW=X,X=$P(X,"@",2) N XABB S XABB=""
"RTN","PSGS0",181,0)
 I X]"" D ENCHK Q:'$D(X)
"RTN","PSGS0",182,0)
 S X=$P(SDW,"@"),X(1)="-" I X?.E1P.E,X'["-"  ;F QX=1:1:$L(X) I $E(X,QX)?1P S X(1)=$E(X,QX) Q
"RTN","PSGS0",183,0)
 F Q=1:1:$L(X,X(1)) K:SWD="" X Q:SWD=""  S Z=$P(X,X(1),Q) D DWC Q:'$D(X)
"RTN","PSGS0",184,0)
 I $D(X) F II=1:1:$L(X,X(1)) S XABB=$G(XABB)_$E($P(X,X(1),II),1,2)_"-"
"RTN","PSGS0",185,0)
 K X(1) S:$D(X) X=SDW I $G(X)]"" I $TR(XABB,"-")]"" S X=$E($G(XABB),1,$L(XABB)-1)
"RTN","PSGS0",186,0)
 I $G(AT) S PSGS0Y=AT
"RTN","PSGS0",187,0)
 Q
"RTN","PSGS0",188,0)
DWC I $L(Z)<2 K X Q
"RTN","PSGS0",189,0)
 F QX=1:1:$L(SWD,"^") S Y=$P(SWD,"^",QX) I $P(Y,Z)="" S SWD=$P(SWD,Y,2) S:$L(SWD) SWD=$E(SWD,2,50) Q
"RTN","PSGS0",190,0)
 E  K X
"RTN","PSGS0",191,0)
 Q
"RTN","PSGS0",192,0)
 ;
"RTN","PSGS0",193,0)
PRNOK(PSCH) ;
"RTN","PSGS0",194,0)
 Q:PSCH'["PRN" 0
"RTN","PSGS0",195,0)
 I $TR(PSCH," ")="PRN" Q 1
"RTN","PSGS0",196,0)
 N BASE,I,OK S OK=0 S I=$P(PSCH," PRN") I I]"",$D(^PS(51.1,"AC","PSJ",I)) S OK=1
"RTN","PSGS0",197,0)
 I 'OK D
"RTN","PSGS0",198,0)
 .I PSCH["@" I $D(^PS(51.1,"AC","PSJ",$P(PSCH,"@")))!$$DOW^PSIVUTL($P(PSCH,"@")) S OK=1 Q
"RTN","PSGS0",199,0)
 .I $$DOW^PSIVUTL($P(PSCH," PRN")) S OK=1
"RTN","PSGS0",200,0)
 Q OK
"RTN","PSGS0",201,0)
ODD(PSF) ;determine if this is an odd schedule
"RTN","PSGS0",202,0)
 I PSF>1439,PSF#1440 Q 1
"RTN","PSGS0",203,0)
 I PSF,PSF<1440,1440#PSF Q 1
"RTN","PSGS0",204,0)
 Q 0
"RTN","PSGSICHK")
0^34^B81963876
"RTN","PSGSICHK",1,0)
PSGSICHK ;BIR/CML3-CHECKS SPECIAL INSTRUCTIONS ;17 Aug 98 / 8:33 AM
"RTN","PSGSICHK",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**3,9,26,29,44,49,59,110,139,146,160,175,201,185,181,256**;16 DEC 97;Build 34
"RTN","PSGSICHK",3,0)
 ;
"RTN","PSGSICHK",4,0)
 ; Reference to ^PS(50.605 is supported by DBIA 696.
"RTN","PSGSICHK",5,0)
 ; Reference to EN^PSOORDRG is supported by DBIA 2190.
"RTN","PSGSICHK",6,0)
 ; Reference to ^PSI(58.1 is supported by DBIA 2284.
"RTN","PSGSICHK",7,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192.
"RTN","PSGSICHK",8,0)
 ; Reference to ^PSD(58.8 is supported by DBIA 2283.
"RTN","PSGSICHK",9,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSGSICHK",10,0)
 ; Reference to ^PS(51.2 is supported by DBIA 2178.
"RTN","PSGSICHK",11,0)
 ; Reference to ^PS(51 is supported by DBIA 2176.
"RTN","PSGSICHK",12,0)
 ; Reference to ^ORRDI1 is supported by DBIA 4659.
"RTN","PSGSICHK",13,0)
 ; Reference to ^XTMP("ORRDI" is supported by DBIA 4660.
"RTN","PSGSICHK",14,0)
 ; Reference to GETDATA^GMRAOR supported by DBIA 4847.
"RTN","PSGSICHK",15,0)
 ; Reference to ^TMP("GMRAOC" supported by DBIA 4848.
"RTN","PSGSICHK",16,0)
 ;
"RTN","PSGSICHK",17,0)
START ;
"RTN","PSGSICHK",18,0)
 I $S(X'?.ANP:1,X["^":1,1:$L(X)>180) K X Q
"RTN","PSGSICHK",19,0)
 S Y="" F Y(1)=1:1:$L(X," ") S Y(2)=$P(X," ",Y(1)) I Y(2)]"" D CHK Q:'$D(X)
"RTN","PSGSICHK",20,0)
 I $D(X),Y]"",X'=$E(Y,1,$L(Y)-1) D EN^DDIOL("EXPANDS TO: ") W Y F Y(1)=1:1 S Y(2)=$P(Y," ",Y(1)) Q:Y(2)=""  D:$L(Y(2))+$X>78 EN^DDIOL(Y(2)_" ")
"RTN","PSGSICHK",21,0)
 Q
"RTN","PSGSICHK",22,0)
 ;
"RTN","PSGSICHK",23,0)
CHK ;
"RTN","PSGSICHK",24,0)
 I $L(Y(2))<31,$D(^PS(51,+$O(^PS(51,"B",Y(2),0)),0)),$P(^(0),"^",2)]"",$P(^(0),"^",4) S Y(2)=$P(^(0),"^",2)
"RTN","PSGSICHK",25,0)
 I $L(Y)+$L(Y(2))>180 K X Q
"RTN","PSGSICHK",26,0)
 S Y=Y_Y(2)_" " Q
"RTN","PSGSICHK",27,0)
 ;
"RTN","PSGSICHK",28,0)
ENSET(X) ; expands the SPECIAL INSTRUCTIONS field contained in X into Y
"RTN","PSGSICHK",29,0)
 N X1,X2,Y S Y=""
"RTN","PSGSICHK",30,0)
 ;BHW;PSJ*5*185;Modified Logic below to NOT strip spaces and allow existing logic to flow.
"RTN","PSGSICHK",31,0)
 ;             ;Removed code I X2]"" Before Set of Y and created argumentless DO structure.
"RTN","PSGSICHK",32,0)
 F X1=1:1:$L(X," ") S X2=$P(X," ",X1) D
"RTN","PSGSICHK",33,0)
 . I X2']"" S Y=Y_" " Q  ;if multiple spaces in text and were $P'ing through text, X2 will="" so just add space and continue
"RTN","PSGSICHK",34,0)
 . S Y=Y_$S($L(X2)>30:X2,'$D(^PS(51,+$O(^PS(51,"B",X2,0)),0)):X2,$P(^(0),"^",2)]""&$P(^(0),"^",4):$P(^(0),"^",2),1:X2)_" "
"RTN","PSGSICHK",35,0)
 . Q
"RTN","PSGSICHK",36,0)
 ;BHW;Modified stripping of spaces at end of string
"RTN","PSGSICHK",37,0)
 F X1=$L(Y):-1:0 Q:$E(Y,X1,X1)'=" "  S Y=$E(Y,1,X1-1)
"RTN","PSGSICHK",38,0)
 Q Y
"RTN","PSGSICHK",39,0)
 ;
"RTN","PSGSICHK",40,0)
END ; used by DRUG (55.06,101 & 53.1,101) x-refs to warn user if patient is receiving or about to receive the drug just ordered
"RTN","PSGSICHK",41,0)
 Q:$D(PSJHLSKP)
"RTN","PSGSICHK",42,0)
 ;
"RTN","PSGSICHK",43,0)
 ;***This module is no longer used after PSJ*5*181***
"RTN","PSGSICHK",44,0)
 Q
"RTN","PSGSICHK",45,0)
 ;
"RTN","PSGSICHK",46,0)
 N Z,ZZ,STATUSNP I $G(PSJPWD)&($P($G(PSJSYSU),";")=3)&($G(PSGDRG)) I ($D(^PSI(58.1,"D",PSGDRG,PSJPWD)))!($D(^PSD(58.8,"D",PSGDRG,PSJPWD))) D EN^DDIOL("                         *** A WARD STOCK ITEM ***")
"RTN","PSGSICHK",47,0)
 D NOW^%DTC
"RTN","PSGSICHK",48,0)
 N PSJDCHK F Z=%:0 S Z=$O(^PS(55,+PSGP,5,"AUS",Z)) Q:'Z!$D(DUOUT)  F ZZ=0:0 S ZZ=$O(^PS(55,+PSGP,5,"AUS",Z,ZZ)) Q:'ZZ!$D(DUOUT)  I +$G(^PS(55,+PSGP,5,ZZ,.2))=PSGX D PDWCHK(+PSGP,ZZ_"U") S PSJDCHK=1
"RTN","PSGSICHK",49,0)
 F STATUSNP="N","P" F Z=0:0 S Z=$O(^PS(53.1,"AS",STATUSNP,+PSGP,Z)) Q:'Z!$D(DUOUT)  I +$G(^PS(53.1,+Z,.2))=PSGX D PDWCHK(+PSGP,Z_"P") S PSJDCHK=1
"RTN","PSGSICHK",50,0)
 I $D(PSJDCHK) N DIR D
"RTN","PSGSICHK",51,0)
 .S DIR(0)="Y",DIR("A")="Do you wish to continue entering this order",DIR("?",1)="Enter ""N"" if you wish to exit without creating a new order,"
"RTN","PSGSICHK",52,0)
 .S DIR("?")="or ""Y"" to continue with the order entry process." D ^DIR S:'Y Y=-1,X="^"
"RTN","PSGSICHK",53,0)
 K Z,ZZ
"RTN","PSGSICHK",54,0)
 Q
"RTN","PSGSICHK",55,0)
 ;
"RTN","PSGSICHK",56,0)
ENDDC(PSGP,PSJDD) ; Perform Duplicate Drug, Duplicate Class
"RTN","PSGSICHK",57,0)
 ;Using FDB OC
"RTN","PSGSICHK",58,0)
 NEW PSPDRG,PSJDSPNM,X
"RTN","PSGSICHK",59,0)
 K ^TMP($J,"PSJPRE")
"RTN","PSGSICHK",60,0)
 S PSJDSPNM=""
"RTN","PSGSICHK",61,0)
 ;If it is an active or pending order then check for multiple dispense drugs.
"RTN","PSGSICHK",62,0)
 I $G(PSJMULDD)>1!($G(PSGORD)]"") S PSJDSPNM=$$DRGNM()
"RTN","PSGSICHK",63,0)
 S PSPDRG(1)=PSJDD_U_$S(PSJDSPNM]"":PSJDSPNM,1:$$DN^PSJMISC(+PSJDD))
"RTN","PSGSICHK",64,0)
 I $$SUP^PSSDSAPI(+PSJDD) D DISPLAY^PSJOC Q
"RTN","PSGSICHK",65,0)
 D OC^PSJOC(.PSPDRG,"I;"_$G(PSGORD))
"RTN","PSGSICHK",66,0)
 Q 
"RTN","PSGSICHK",67,0)
DRGNM() ;
"RTN","PSGSICHK",68,0)
 ;Return the OI name + Dosage form if more than one DD in the order
"RTN","PSGSICHK",69,0)
 NEW PSJCNT,PSJDSPNM,X
"RTN","PSGSICHK",70,0)
 ;If it's speed finish then get the drug name from 53.1 (^PS(53.45 is not set to the current order yet)
"RTN","PSGSICHK",71,0)
 I $G(PSJSPEED),($G(PSGORD)["P") S PSJDSPNM=$$OINM^PSJOCDS(PSGORD) Q PSJDSPNM
"RTN","PSGSICHK",72,0)
 S PSJCNT=0,PSJDSPNM=""
"RTN","PSGSICHK",73,0)
 F X=0:0 S X=$O(^PS(53.45,+$G(PSJSYSP),2,X)) Q:'X  S PSJCNT=PSJCNT+1
"RTN","PSGSICHK",74,0)
 I PSJCNT>1,+$G(PSGPDRG) S PSJDSPNM=$$OIDF^PSJLMUT1(+PSGPDRG)
"RTN","PSGSICHK",75,0)
 Q PSJDSPNM
"RTN","PSGSICHK",76,0)
 ;
"RTN","PSGSICHK",77,0)
ENDDCOLD(PSGP,PSJDD) ; Perform Duplicate Drug, Duplicate Class,
"RTN","PSGSICHK",78,0)
 ;*** The following codes are no longer used after PSJ*5*181 ***
"RTN","PSGSICHK",79,0)
 ; Drug-Drug interaction check, Drug-Allergy interaction check.
"RTN","PSGSICHK",80,0)
 Q
"RTN","PSGSICHK",81,0)
 N PSJLINE,Z,ZZ,PSJFST
"RTN","PSGSICHK",82,0)
 S (PSJLINE,PSJFST)=0
"RTN","PSGSICHK",83,0)
 I $G(PSJPWD)&($P($G(PSJSYSU),";")=3)&($G(PSJDD)) I ($D(^PSI(58.1,"D",PSJDD,PSJPWD)))!($D(^PSD(58.8,"D",PSJDD,PSJPWD))) W !?25,"*** A WARD STOCK ITEM ***"
"RTN","PSGSICHK",84,0)
 D EN^PSOORDRG(PSGP,PSJDD) K PSJPDRG N INTERVEN,PSJIREQ,PSJRXREQ S Y=1,(PSJIREQ,PSJRXREQ,INTERVEN,X)="" S DFN=PSGP
"RTN","PSGSICHK",85,0)
 I $T(HAVEHDR^ORRDI1)]"",$$HAVEHDR^ORRDI1,'$D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) D
"RTN","PSGSICHK",86,0)
 . I $P($G(^XTMP("ORRDI","PSOO",PSGP,0)),"^",3)<0 W !,"Remote data not available - Only local order checks processed." D PAUSE^PSJLMUT1
"RTN","PSGSICHK",87,0)
 I $D(^TMP($J,"DD")) D ORDCHK^PSJLMUT1(PSGP,"DD",4)
"RTN","PSGSICHK",88,0)
 I $D(^TMP($J,"DC")) D ORDCHK^PSJLMUT1(PSGP,"DC",6)
"RTN","PSGSICHK",89,0)
IVSOL ;*** Start order check for IV solution at this point.
"RTN","PSGSICHK",90,0)
 I '$D(PSJFST) N PSJFST S PSJFST=0
"RTN","PSGSICHK",91,0)
 I $D(^TMP($J,"DI")) S INTERVEN=1 D ORDCHK^PSJLMUT1(PSGP,"DI",8)
"RTN","PSGSICHK",92,0)
 ;*** Allergy/adverse reaction check.
"RTN","PSGSICHK",93,0)
 N PTR,X
"RTN","PSGSICHK",94,0)
 S PTR=$P($G(^PSDRUG(PSJDD,"ND")),U)_"."_$P($G(^PSDRUG(PSJDD,"ND")),U,3)
"RTN","PSGSICHK",95,0)
 K ^TMP("PSJDAI",$J) S PSJACK=$$ORCHK^GMRAOR(DFN,"DR",PTR) D:$G(PSJACK)=1
"RTN","PSGSICHK",96,0)
 .S ^TMP("PSJDAI",$J,0)=1
"RTN","PSGSICHK",97,0)
 .S I=0 F  S I=$O(GMRAING(I)) Q:'I  S ^TMP("PSJDAI",$J,I,0)=GMRAING(I)
"RTN","PSGSICHK",98,0)
 I $D(^TMP("PSJDAI",$J)) S PSJPDRG=1 D
"RTN","PSGSICHK",99,0)
 .W $C(7),!!,"A Drug-Allergy Reaction exists for this medication!",!!
"RTN","PSGSICHK",100,0)
 .W !?7,"Drug: "_$P($G(^PSDRUG(PSJDD,0)),"^") I $O(^TMP("PSJDAI",$J)) W !,"Ingredients: " D
"RTN","PSGSICHK",101,0)
 ..S I=0 F  S I=$O(^TMP("PSJDAI",$J,I)) Q:'I  W:$X+$L($G(^(I,0)))+2>IOM !?19 W:I=1 $G(^TMP("PSJDAI",$J,I,0)) W:I>1 ", ",$G(^TMP("PSJDAI",$J,I,0))
"RTN","PSGSICHK",102,0)
 .W !!
"RTN","PSGSICHK",103,0)
 K PSJACK,GMRAING,I,^TMP($J)
"RTN","PSGSICHK",104,0)
 D ALGCLASS
"RTN","PSGSICHK",105,0)
CONT ; Ask user if they wish to continue in spite of an order check.
"RTN","PSGSICHK",106,0)
 Q:'$D(PSJPDRG)  N DIR S DIR(0)="Y",DIR("A")="Do you wish to continue entering this order",DIR("?",1)="Enter ""N"" if you wish to exit without creating a new order,"
"RTN","PSGSICHK",107,0)
 S DIR("?")="or ""Y"" to continue with the order entry process.",DIR("B")="NO" D ^DIR I 'Y S PSGORQF=1,X="^",COMQUIT=1 Q
"RTN","PSGSICHK",108,0)
 I 'INTERVEN!($P(PSJSYSU,";")'=3) Q
"RTN","PSGSICHK",109,0)
 NEW PSJY
"RTN","PSGSICHK",110,0)
 W:PSJIREQ !!,"This is a CRITICAL interaction, you must enter an intervention log to continue"
"RTN","PSGSICHK",111,0)
 S DIR(0)="Y",DIR("A")="Do you wish to log an intervention",DIR("?",1)="Enter ""N"" if you do not wish to log an intervention,",DIR("?")="or ""Y"" to log an intervention." D ^DIR S PSJY=Y D:Y ^PSJRXI
"RTN","PSGSICHK",112,0)
 I 'PSJY,PSJIREQ S PSGORQF=1,COMQUIT=1
"RTN","PSGSICHK",113,0)
 Q
"RTN","PSGSICHK",114,0)
 ;
"RTN","PSGSICHK",115,0)
ENDL ; used by PSGTRAIN DRUG LOOK-UP option
"RTN","PSGSICHK",116,0)
 D ENCV^PSGSETU Q:$D(XQUIT)
"RTN","PSGSICHK",117,0)
 F  S DIC="^PSDRUG(",DIC(0)="AEIMOQZ",DIC("A")="Select DRUG: " W ! D ^DIC K DIC Q:+Y'>0  D SF
"RTN","PSGSICHK",118,0)
 D ENKV^PSGSETU K N5,ND,Q,Y Q
"RTN","PSGSICHK",119,0)
 ;
"RTN","PSGSICHK",120,0)
SF ;
"RTN","PSGSICHK",121,0)
 S Y=+Y,ND=$G(^PSDRUG(Y,0)),PSGID=+$G(^("I")) I PSGID W !!,"THIS DRUG IS INACTIVE AS OF ",$E($$ENDTC^PSGMI(PSGID),1,8)
"RTN","PSGSICHK",122,0)
 W !!,$S($P(ND,"^",9):"NON-",1:""),"FORMULARY ITEM" W:$P(ND,"^",10)]"" !,$P(ND,"^",10)
"RTN","PSGSICHK",123,0)
 S ND=$P($G(^PSDRUG(Y,2)),"^",3)["U" W !,$P("NOT^","^",ND+1)," A UNIT DOSE DRUG" W ! S ND=$G(^(8)),N5=$G(^(8.5)) W !?2,"DAY (nD) or DOSE (nL) LIMIT: " I ND W $P(ND,"^")
"RTN","PSGSICHK",124,0)
 W !?10,"UNIT DOSE MED ROUTE: " I $P(ND,"^",2) W $S($D(^PS(51.2,$P(ND,"^",2),0)):$P(^(0),"^"),1:$P(ND,"^",2))
"RTN","PSGSICHK",125,0)
 ; NAKED REF below refers to ^PS(51.2, on line above.
"RTN","PSGSICHK",126,0)
 W !?6,"UNIT DOSE SCHEDULE TYPE: " I $P(ND,"^",3)]"" W $P($P(";"_$P(^(0),"^",3),";"_$P(ND,"^",3)_":",2),";")
"RTN","PSGSICHK",127,0)
 W !?11,"UNIT DOSE SCHEDULE: " I $P(ND,"^",4)]"" W $P(ND,"^",4)
"RTN","PSGSICHK",128,0)
 W !,"CORRESPONDING OUTPATIENT DRUG: " I $P(ND,"^",5) W $S('$D(^PSDRUG(+$P(ND,"^",5),0)):$P(ND,"^",5),$P(^(0),"^")]"":$P(^(0),"^"),1:$P(ND,"^",5))
"RTN","PSGSICHK",129,0)
 W !?17,"ATC MNEMONIC: " I $P(N5,"^",2)]"" W $P(N5,"^",2)
"RTN","PSGSICHK",130,0)
 W !?17,"ATC CANISTER: " F Q=0:0 S Q=$O(^PSDRUG(Y,212,Q)) Q:'Q  S ND=$G(^(Q,0)) I ND,$P(ND,"^",2) W ?31,$S('$D(^PS(57.5,+ND,0)):+ND_";PS(57.5,",$P(^(0),"^")]"":$P(^(0),"^"),1:+ND_";PS(57.5,"),?56,$P(ND,"^",2),!
"RTN","PSGSICHK",131,0)
 Q
"RTN","PSGSICHK",132,0)
 ;
"RTN","PSGSICHK",133,0)
OCHK ; Add drugs in current order to ^TMP("ORDERS" and call order checker.
"RTN","PSGSICHK",134,0)
 ; Set PSJOCHK=1 so OP order check doesn't Kill array.
"RTN","PSGSICHK",135,0)
 ;
"RTN","PSGSICHK",136,0)
 K ^TMP($J,"ORDERS")
"RTN","PSGSICHK",137,0)
 N PSJOCHK S PSJOCHK=1
"RTN","PSGSICHK",138,0)
PDWCHK(DFN,ON) ; Print Dup Drug order.
"RTN","PSGSICHK",139,0)
 N ND,ND0,ND2,X
"RTN","PSGSICHK",140,0)
 W:'$D(PSJDCHK) $C(7),$C(7),!!,"WARNING! THIS PATIENT HAS THE FOLLOWING ORDER(S) FOR THIS MEDICATION:",!!
"RTN","PSGSICHK",141,0)
 S ND=$$DRUGNAME^PSJLMUTL(DFN,ON)
"RTN","PSGSICHK",142,0)
 S F=$S(ON["P":"^PS(53.1,",1:"^PS(55,"_DFN_",5,"),ND0=$G(@(F_+ON_",0)")),ND2=$G(^(2)),X=$P(ND,U,2),X=$S(X=.2:$P($G(^(.2)),U,2),1:$G(^(.3)))
"RTN","PSGSICHK",143,0)
 W ?10,$P(ND,U),!,?13,"Give: ",X," ",$$ENMRN^PSGMI(+$P(ND0,U,3))," ",$P(ND2,U),!!
"RTN","PSGSICHK",144,0)
 Q
"RTN","PSGSICHK",145,0)
ALGCLASS ; checks any Drug allergies or reactions to see if
"RTN","PSGSICHK",146,0)
 ;         the new drug is the same class
"RTN","PSGSICHK",147,0)
 ; this call can be removed by commenting out the call on IVSOL+16
"RTN","PSGSICHK",148,0)
 N PSJLIST,CT,CLS,CLCHK,CNT,PSJL,LIST,DCCNT,PSCLASS,LEN
"RTN","PSGSICHK",149,0)
 S PSCLASS=$P($G(^PSDRUG(PSJDD,0)),"^",2),LEN=4 I $E(PSCLASS,1,4)="CN10" S LEN=5 ;look at 5 chars if ANALGESICS
"RTN","PSGSICHK",150,0)
 I $T(GETDATA^GMRAOR)]"" G ALGC2
"RTN","PSGSICHK",151,0)
 S GMRA="0^0^111" D EN1^GMRADPT
"RTN","PSGSICHK",152,0)
 F PSJLIST=0:0 S PSJLIST=$O(GMRAL(PSJLIST)) Q:'PSJLIST  D
"RTN","PSGSICHK",153,0)
 .K PSJAGL D EN1^GMRAOR2(PSJLIST,"PSJAGL")
"RTN","PSGSICHK",154,0)
 .; is the allergy/reaction drug class first four digits the same as the
"RTN","PSGSICHK",155,0)
 .; class for the drug being entered?
"RTN","PSGSICHK",156,0)
 .S (CT,CLS)="",DCCNT=0
"RTN","PSGSICHK",157,0)
 .I $D(PSJAGL("V")) D
"RTN","PSGSICHK",158,0)
 ..F  S DCCNT=$O(PSJAGL("V",DCCNT)) Q:'DCCNT  S:$E($P($G(PSJAGL("V",DCCNT)),"^"),1,LEN)=$E(PSCLASS,1,LEN) (PSJPDRG,CLCHK)=1,CNT=$S('$D(CNT):1,1:CNT+1),LIST(CNT)=$P($G(PSJAGL),"^")_"^"_$P($G(PSJAGL("V",DCCNT)),"^",2)
"RTN","PSGSICHK",159,0)
 D:$G(CLCHK)
"RTN","PSGSICHK",160,0)
 .W !!,$C(7),"A Drug-Allergy Reaction exists for this medication and/or class!"
"RTN","PSGSICHK",161,0)
 .F PSJL=0:0 S PSJL=$O(LIST(PSJL)) Q:'PSJL  D
"RTN","PSGSICHK",162,0)
 ..W !?6,"Drug: "_$P(LIST(PSJL),"^"),!,"Drug Class: "_$P(LIST(PSJL),"^",2),!
"RTN","PSGSICHK",163,0)
 Q
"RTN","PSGSICHK",164,0)
ALGC2 ;
"RTN","PSGSICHK",165,0)
 K GMRADRCL
"RTN","PSGSICHK",166,0)
 D GETDATA^GMRAOR(DFN) Q:'$D(^TMP("GMRAOC",$J,"APC"))
"RTN","PSGSICHK",167,0)
 N GMRACL,RET
"RTN","PSGSICHK",168,0)
 S RET=0,GMRACL="" F  S GMRACL=$O(^TMP("GMRAOC",$J,"APC",GMRACL)) Q:'$L(GMRACL)  D
"RTN","PSGSICHK",169,0)
 .N GMRANM,GMRALOC
"RTN","PSGSICHK",170,0)
 .S GMRALOC=^TMP("GMRAOC",$J,"APC",GMRACL)
"RTN","PSGSICHK",171,0)
 .S GMRANM=$P(^PS(50.605,+$O(^PS(50.605,"B",GMRACL,0)),0),U,2)
"RTN","PSGSICHK",172,0)
 .S GMRADRCL(GMRACL)=GMRACL_U_GMRANM_" ("_GMRALOC_")"
"RTN","PSGSICHK",173,0)
 .S RET=RET+1
"RTN","PSGSICHK",174,0)
 Q:'RET  K ^TMP("GMRAOC",$J)
"RTN","PSGSICHK",175,0)
 S CLCHK="",CT="" F  S CT=$O(GMRADRCL(CT)) Q:CT=""  D
"RTN","PSGSICHK",176,0)
 .I $E(PSCLASS,1,LEN)=$E(CT,1,LEN) S CLCHK=$G(CLCHK)+1,^TMP($J,"PSJDRCLS",CLCHK)=CT_" "_$P(GMRADRCL(CT),"^",2)
"RTN","PSGSICHK",177,0)
CLASSDSP ;
"RTN","PSGSICHK",178,0)
 I '$D(^TMP($J,"PSJDRCLS")) Q
"RTN","PSGSICHK",179,0)
 W $C(7),!,"A Drug-Allergy Reaction exists for this medication and/or class!",!
"RTN","PSGSICHK",180,0)
 W !,"Drug: "_$P($G(^PSDRUG(PSJDD,0)),"^")
"RTN","PSGSICHK",181,0)
 S CT="" F  S CT=$O(^TMP($J,"PSJDRCLS",CT)) Q:CT=""  W !,"Drug Class: "_^TMP($J,"PSJDRCLS",CT)
"RTN","PSGSICHK",182,0)
 K ^TMP($J,"PSJDRCLS")
"RTN","PSGSICHK",183,0)
 S DIR("?",1)="Answer 'YES' if you DO want to enter a reaction for this medication,"
"RTN","PSGSICHK",184,0)
 S DIR("?")="       'NO' if you DON'T want to enter a reaction for this medication,"
"RTN","PSGSICHK",185,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Intervene? ",DIR("B")="Y" W ! D ^DIR
"RTN","PSGSICHK",186,0)
 I Y D ^PSJRXI
"RTN","PSGSICHK",187,0)
 I '$G(Y) K DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y Q
"RTN","PSGSICHK",188,0)
 Q
"RTN","PSIV")
0^25^B31216203
"RTN","PSIV",1,0)
PSIV ;BIR/PR,MLM - MISC UTILITIES ;3/19/99 9:45 AM
"RTN","PSIV",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**7,16,29,38,53,56,72,58,110,181,267,275,281,256**;16 DEC 97;Build 34
"RTN","PSIV",3,0)
 ;
"RTN","PSIV",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSIV",5,0)
 ; Reference to ^PSSLOCK is supported by DBIA 2789
"RTN","PSIV",6,0)
 ; Reference to ^%DTC is supported by DBIA 10000
"RTN","PSIV",7,0)
 ; Reference to ^DIC is supported by DBIA 10006
"RTN","PSIV",8,0)
 ; Reference to ^DIE is supported by DBIA 10018
"RTN","PSIV",9,0)
 ; Reference to ^DIR is supported by DBIA 10026
"RTN","PSIV",10,0)
 ; Reference to ^VALM is supported by DBIA 10118
"RTN","PSIV",11,0)
 ; Reference to ^VALM1 is supported by DBIA 10116
"RTN","PSIV",12,0)
 ;
"RTN","PSIV",13,0)
ENGETP ;Enter here to select patient.
"RTN","PSIV",14,0)
 K DIC S DIC("W")="W ""  "",$P(^(0),""^"",9) W:$D(^(.1)) ""  "",^(.1)",DIC="^DPT(",DIC(0)="QEM"
"RTN","PSIV",15,0)
 D FULL^VALM1
"RTN","PSIV",16,0)
GETP1 ;
"RTN","PSIV",17,0)
 ;NEW arrays use in order checks
"RTN","PSIV",18,0)
 NEW PSJEXCPT,PSJOCER
"RTN","PSIV",19,0)
 S PSGPTMP=0,PPAGE=1,DFN=-1,X="Select PATIENT:^^^^1" D ENQ Q:"^"[X
"RTN","PSIV",20,0)
 D EN^PSJDPT
"RTN","PSIV",21,0)
 I Y<0 G ENGETP
"RTN","PSIV",22,0)
 N PSGP,PSJACNWP S (PSGP,DFN)=+Y D ENBOTH^PSJAC S PSJORL=$$ENORL^PSJUTL($G(VAIN(4)))
"RTN","PSIV",23,0)
 Q
"RTN","PSIV",24,0)
 ;
"RTN","PSIV",25,0)
ENYN ;Enter here for yes/no responses. This is a general reader that I have
"RTN","PSIV",26,0)
 ;been phasing out with ^DICN
"RTN","PSIV",27,0)
 S X=X_"^Y:YES;N:NO^YES,NO"
"RTN","PSIV",28,0)
 ;
"RTN","PSIV",29,0)
ENQ ;Enter here to read X. This is the general reader that I have
"RTN","PSIV",30,0)
 ;been slowly phasing out
"RTN","PSIV",31,0)
 S QUD=$P(X,"^",2) W !!,$P(X,"^")," " W:QUD]"" QUD,"// " R QUX:DTIME W:'$T $C(7) S:'$T QUX="^" S:QUX="" QUX=QUD I QUX["^"!(QUX["?") G KILL
"RTN","PSIV",32,0)
 I $L(QUX)>500 W "    ??" G ENQ
"RTN","PSIV",33,0)
 S:QUX?1L QUX=$C($A(QUX)-32)
"RTN","PSIV",34,0)
 S QUD=";"_$P(X,"^",3)_";" G:QUD'[(";"_QUX_":") VAR S QUX1=$E(QUD,$F(QUD,QUX_":"),($F(QUD,";",$F(QUD,QUX_":"))-2)) G:QUX1[":" VAR W "    ",QUX1 G KILL
"RTN","PSIV",35,0)
VAR F QUX1=1:1 S QUD=$P($P(X,"^",4),",",QUX1) Q:QUD=""  I $P(QUD,QUX)="" W $S($P(X,"^",2)=QUX:"    "_QUX,1:"")_$P(QUD,QUX,2,99) S QUX=QUD G KILL
"RTN","PSIV",36,0)
PAT I $P(X,"^",5)]"",@$P(X,"^",5,999) G KILL
"RTN","PSIV",37,0)
 W $C(7)," ???" G ENQ
"RTN","PSIV",38,0)
KILL S X=QUX K QUX,QUX1,QUD,PSJDCEXP Q
"RTN","PSIV",39,0)
 ;
"RTN","PSIV",40,0)
ENADM ;Edit administration schedules.
"RTN","PSIV",41,0)
 ; reference to ^PS(51.1 is supported by DBIA #2177
"RTN","PSIV",42,0)
 S DIC="^PS(51.1,",DIC(0)="QEAML",DLAYGO=51.1 D ^DIC K:+Y<0 %,DA,D0,DIC,DIE,DLAYGO,DR,Z,Y Q:'$D(Y)  S DIE=DIC,DR=".01;1",DA=+Y K DIC D ^DIE G ENADM
"RTN","PSIV",43,0)
 ;
"RTN","PSIV",44,0)
ENOW D NOW^%DTC S Y=% K %,%H,%I
"RTN","PSIV",45,0)
 Q
"RTN","PSIV",46,0)
 ;
"RTN","PSIV",47,0)
ENC ;Get unit of measure for drug selected.
"RTN","PSIV",48,0)
 S X=$P($P(";"_$P(Y,U,3),";"_X_":",2),";")
"RTN","PSIV",49,0)
 Q
"RTN","PSIV",50,0)
 ;
"RTN","PSIV",51,0)
ENCHS ;Needs PSIVBR (Branch point)
"RTN","PSIV",52,0)
 D ENGETP G:DFN<0 Q
"RTN","PSIV",53,0)
 ;* Lock patient if calling FROM PSJI DELETE ORDER.
"RTN","PSIV",54,0)
 I PSIVBR="D ENT^PSIVPGE",('$$L^PSSLOCK(DFN,1)) Q
"RTN","PSIV",55,0)
OE N CONT S CONT=0
"RTN","PSIV",56,0)
 F  Q:CONT  D ENCHS1
"RTN","PSIV",57,0)
 Q:$D(ORVP)
"RTN","PSIV",58,0)
 G ENCHS
"RTN","PSIV",59,0)
ENCHS1 ;
"RTN","PSIV",60,0)
 I '($$AA^PSJDPT(DFN)>0) S CONT=1 Q
"RTN","PSIV",61,0)
 S PSJORQF=0,CONT=0
"RTN","PSIV",62,0)
 S PSJPROT=2,PSJOL="",(PSGOP,PSGP)=DFN
"RTN","PSIV",63,0)
 K PSJLMPRO D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSIV",64,0)
 S VALMCNT=30
"RTN","PSIV",65,0)
 I PSIVBR="D PROCESS^PSIVRD",(PSJOL="N") D ORDNO^PSIVRD Q
"RTN","PSIV",66,0)
 I $G(PSJNEWOE) S PSJOL="S"
"RTN","PSIV",67,0)
 I PSJOL="S"!(PSJOL="L") F  Q:CONT  S P("PT")=PSJOL D
"RTN","PSIV",68,0)
 . S PSJORQF=0,PSJNEWOE=0
"RTN","PSIV",69,0)
 . D ENNB^PSIVACT
"RTN","PSIV",70,0)
 . I '$D(^TMP("PSIV",$J)) D FULL^VALM1 W !!,?30,"NO ORDERS FOUND",! K DIR S DIR(0)="E" D ^DIR W @IOF S CONT=0
"RTN","PSIV",71,0)
 . NEW PSJIVPRF S PSJIVPRF=1
"RTN","PSIV",72,0)
 . S PSJOL=$S(",S,L,"[(","_$G(PSJOL)_","):PSJOL,1:"S")
"RTN","PSIV",73,0)
 . D EN^VALM("PSJ LM IV OE")
"RTN","PSIV",74,0)
 . I $G(VALMBCK)="Q" Q
"RTN","PSIV",75,0)
 . S CONT=1
"RTN","PSIV",76,0)
 ;* Unlock patient if come from PSJI DELETE ORDER
"RTN","PSIV",77,0)
 I '$G(PSJORQF) S CONT=1
"RTN","PSIV",78,0)
 I PSIVBR="D ENT^PSIVPGE" D UL^PSSLOCK(DFN)
"RTN","PSIV",79,0)
 K PSJLMPRO
"RTN","PSIV",80,0)
 Q
"RTN","PSIV",81,0)
SELSO ;SELECT ORDER USING "SO" OPTION
"RTN","PSIV",82,0)
 S PSGLMT=^TMP("PSJPRO",$J,0) D ENASR^PSGON,OV
"RTN","PSIV",83,0)
 Q
"RTN","PSIV",84,0)
SELNUM ;SELECT ORDERS WITH NUMBERS
"RTN","PSIV",85,0)
 S PSGLMT=^TMP("PSJPRO",$J,0),X=$P(XQORNOD(0),"=",2) D ENCHK^PSGON,OV
"RTN","PSIV",86,0)
 Q
"RTN","PSIV",87,0)
OV ;
"RTN","PSIV",88,0)
 I '$D(PSGODDD) S VALMBCK="R" Q
"RTN","PSIV",89,0)
 N DONE
"RTN","PSIV",90,0)
 F PSIVOV1=1:1:PSGODDD F PSIVOV2=1:1:$L(PSGODDD(PSIVOV1),",")-1 D
"RTN","PSIV",91,0)
 .S ON=+$P(PSGODDD(PSIVOV1),",",PSIVOV2)
"RTN","PSIV",92,0)
 .S ON=$$GTON(ON)
"RTN","PSIV",93,0)
 .Q:'ON!$G(DONE)
"RTN","PSIV",94,0)
 .D OV1
"RTN","PSIV",95,0)
 S VALMBCK="Q"
"RTN","PSIV",96,0)
 Q
"RTN","PSIV",97,0)
GTON(X) ;
"RTN","PSIV",98,0)
 ;Return the ON node from ^Tmp
"RTN","PSIV",99,0)
 I $G(X)="" Q ""
"RTN","PSIV",100,0)
 I $D(^TMP("PSIV",$J,"AB",X)) Q ^(X)
"RTN","PSIV",101,0)
 I $D(^TMP("PSIV",$J,"NB",X)) Q ^(X)
"RTN","PSIV",102,0)
 I $D(^TMP("PSIV",$J,"PB",X)) Q ^(X)
"RTN","PSIV",103,0)
 I $D(^TMP("PSIV",$J,"XB",X)) Q ^(X)
"RTN","PSIV",104,0)
 I $D(^TMP("PSIV",$J,"NDB",X)) Q ^(X)
"RTN","PSIV",105,0)
 I $D(^TMP("PSIV",$J,"PDB",X)) Q ^(X)
"RTN","PSIV",106,0)
 I $D(^TMP("PSIV",$J,"RDB",X)) Q ^(X)
"RTN","PSIV",107,0)
 ; clinic orders
"RTN","PSIV",108,0)
 N REF,REF2,PSJCLND S (REF,REF2,PSJCLND)="" F  S PSJCLND=$O(^TMP("PSIV",$J,PSJCLND)) Q:($G(REF)]"")  D
"RTN","PSIV",109,0)
 .I $P(PSJCLND,"^",4)="AB" I $D(^TMP("PSIV",$J,PSJCLND,X)) S REF=^(X) Q
"RTN","PSIV",110,0)
 .I $P(PSJCLND,"^",4)="NB" I $D(^TMP("PSIV",$J,PSJCLND,X)) S REF=^(X) Q
"RTN","PSIV",111,0)
 .I $P(PSJCLND,"^",4)="PB" I $D(^TMP("PSIV",$J,PSJCLND,X)) S REF=^(X) Q
"RTN","PSIV",112,0)
 .I $P(PSJCLND,"^",4)="XB" I $D(^TMP("PSIV",$J,PSJCLND,X)) S REF=^(X) Q
"RTN","PSIV",113,0)
 .I $P(PSJCLND,"^",4)="NDB" I $D(^TMP("PSIV",$J,PSJCLND,X)) S REF=^(X) Q
"RTN","PSIV",114,0)
 .I $P(PSJCLND,"^",4)="PDB" I $D(^TMP("PSIV",$J,PSJCLND,X)) S REF=^(X) Q
"RTN","PSIV",115,0)
 .I $P(PSJCLND,"^",4)="RDB" I $D(^TMP("PSIV",$J,PSJCLND,X)) S REF=^(X) Q
"RTN","PSIV",116,0)
 I ($G(REF)]"") Q REF
"RTN","PSIV",117,0)
 Q ""
"RTN","PSIV",118,0)
OV1 ;
"RTN","PSIV",119,0)
 ;PSJENHOC=1 if DI,DT were displayed. This will be used by dosing OC to check if error messages should display or not
"RTN","PSIV",120,0)
 NEW PSJDSVFY,PSJENHOC
"RTN","PSIV",121,0)
 K PSJEXCPT("PROSPECTIVE") ;*256
"RTN","PSIV",122,0)
 S (ON,ON55,P("PON"))=9999999999-ON_$S(ON["V":"V",1:"P")
"RTN","PSIV",123,0)
 I PSIVBR["D ^PSIVVW1" D
"RTN","PSIV",124,0)
 . S VALMSG="Select either ""AL"" , ""LL"" or ""AL,LL"" for both"
"RTN","PSIV",125,0)
 . S PSJORD=ON D EN^PSJLIPRF
"RTN","PSIV",126,0)
 E  D
"RTN","PSIV",127,0)
 . I PSIVBR="D ^PSIVOPT",'($$LS^PSSLOCK(PSGP,ON)) Q
"RTN","PSIV",128,0)
 . X PSIVBR
"RTN","PSIV",129,0)
 . D:PSIVBR="D ^PSIVOPT" UNL^PSSLOCK(PSGP,ON)
"RTN","PSIV",130,0)
 K:'$D(DUOUT)&($G(Y)'=-1) DONE
"RTN","PSIV",131,0)
 Q
"RTN","PSIV",132,0)
 ;
"RTN","PSIV",133,0)
 ;
"RTN","PSIV",134,0)
ENU ;Get IV additive strength. Called from templates.
"RTN","PSIV",135,0)
 N Y S Y=+^PS(55,DA(2),"IV",DA(1),"AD",DA,0),PSIVSTR=$$ENU^PSIVUTL(Y)
"RTN","PSIV",136,0)
 Q
"RTN","PSIV",137,0)
Q ;
"RTN","PSIV",138,0)
 K ^TMP($J,"PSJPRE")
"RTN","PSIV",139,0)
 K ^TMP("PSIV",$J),^TMP("PSJ",$J),^TMP("PSJPRO",$J),^TMP("PSJALL",$J),^TMP("PSJI",$J),^TMP("PSJON",$J)
"RTN","PSIV",140,0)
 K DRG,DRGI,DRGN,DRGT,ERR,I,JJ,MI,N,N2,ON,ON55,P,P1,P3,P16,P17,PNOW,PS,PSGODD,PSGODDD,PSIV,PSIVAAT,PSIVACT,PSIVADM,PSIVAT
"RTN","PSIV",141,0)
 K PSIVC,PSIVDT,PSIVFLAG,PSIVLN,PSIVNOW,PSIVNU,PSIVON,PSIVOV1,PSIVOV2,PSIVREA,PSIVSTR,PSIVSTRT,PSIVNOL,PSIVTYPE,PSJNKF
"RTN","PSIV",142,0)
 K PSJORF,PSJORIFN,RDWARD,START,STOP,SCHED,USER,V,XT,DUOUT,DTOUT
"RTN","PSIV",143,0)
 K %,%I,DIC,PSIVC,PSIVNU,PSIVON,PSIVREA,PSIVOV1,PSIVOV2,RDWARD,V,VAERR,VW,X,X2,Y,Y1,Z,Z1,Z2
"RTN","PSIV",144,0)
 Q
"RTN","PSIVOCDS")
0^26^B137929887
"RTN","PSIVOCDS",1,0)
PSIVOCDS ;BIR/MV - PROCESS DOSING ORDER CHECKS FOR IV ;6 Jun 07 / 3:37 PM
"RTN","PSIVOCDS",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,252,257,256**;16 DEC 97;Build 34
"RTN","PSIVOCDS",3,0)
 ;
"RTN","PSIVOCDS",4,0)
 ; Reference to ^PS(51.1 is supported by DBIA #2177
"RTN","PSIVOCDS",5,0)
 ; Reference to ^PSDRUG is supported by DBIA #2192.
"RTN","PSIVOCDS",6,0)
 ; Reference to ^PSSDSAPI is supported by DBIA #5425.
"RTN","PSIVOCDS",7,0)
 ; Reference to ^PSSFDBRT is supported by DBIA #5496.
"RTN","PSIVOCDS",8,0)
 ; Reference to $$CONV^PSSDSAPK is supported by DBIA #5497.
"RTN","PSIVOCDS",9,0)
 ;
"RTN","PSIVOCDS",10,0)
IN(PSJBASE) ;
"RTN","PSIVOCDS",11,0)
 ;PSJBASE - Base(Literal value for TMP global)- Required
"RTN","PSIVOCDS",12,0)
 ;PSIVDDSV(AD/SOL,CNT)=P1..P9
"RTN","PSIVOCDS",13,0)
 ; P1=Drug IEN; P2=Dspl name(add/sol or CPRS OI; P3=Numeric dose & unit; P4=Bottle #
"RTN","PSIVOCDS",14,0)
 ; P5=""; P6=""; P7=""; P8=Strength/Vol; P9=Unit
"RTN","PSIVOCDS",15,0)
 ;
"RTN","PSIVOCDS",16,0)
 ;These two flags below are set when stuff freq, duration to 1 & Duration rate = dose rate
"RTN","PSIVOCDS",17,0)
 ;They are used by the output routine to generate the appropriate output messages.
"RTN","PSIVOCDS",18,0)
 ;PSJFDB(PSJCNT,"INF_ERROR")="" & PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",19,0)
 ;
"RTN","PSIVOCDS",20,0)
 NEW ON,PSJCNT,PSJCNTX,PSJONEFG,PSJRT,PSIVAS,PSIVAS0,PSIVDDSV,PSPDRG,PSJALLGY,X,PSJP8,PSJP8NUM,PSJP8UNT,PSJP8TME,PSJOIX
"RTN","PSIVOCDS",21,0)
 K PSJOCDS,PSJFDB,PSIVDDSV,PSPDRG,PSJALLGY
"RTN","PSIVOCDS",22,0)
 S PSJCNT=0
"RTN","PSIVOCDS",23,0)
 ;PSJRT - FDB Route
"RTN","PSIVOCDS",24,0)
 S PSJRT=$P($$MRT^PSSDSAPI(+P("MR")),U,2)
"RTN","PSIVOCDS",25,0)
 ;Set Flag to indicate CPRS OI had no active AD/SOL.
"RTN","PSIVOCDS",26,0)
 S PSJOIX="" F  S PSJOIX=$O(PSJIV("OI_ERROR",PSJOIX)) Q:PSJOIX=""  D
"RTN","PSIVOCDS",27,0)
 . S PSJCNT=PSJCNT+1
"RTN","PSIVOCDS",28,0)
 . S PSJFDB(PSJCNT,"RX_NUM")="I;;PROSPECTIVE;"_PSJCNT
"RTN","PSIVOCDS",29,0)
 . S PSJFDB(PSJCNT,"DRUG_NM")=PSJOIX
"RTN","PSIVOCDS",30,0)
 . S PSJFDB(PSJCNT,"OI")=$P(PSJIV("OI_ERROR",PSJOIX),U,2)
"RTN","PSIVOCDS",31,0)
 . S PSJFDB(PSJCNT,"OI_ERROR",PSJOIX)=$P(PSJIV("OI_ERROR",PSJOIX),U)_U_"I;;PROSPECTIVE;"_PSJCNT
"RTN","PSIVOCDS",32,0)
 D SETDD^PSIVOC(1)
"RTN","PSIVOCDS",33,0)
 I ($G(PSIVDDSV("TOT_VOL"))=""),($G(PSJIV("TOT_VOL"))]"") S PSIVDDSV("TOT_VOL")=PSJIV("TOT_VOL")
"RTN","PSIVOCDS",34,0)
 F PSIVAS="AD","SOL" F PSJCNTX=0:0 S PSJCNTX=$O(PSIVDDSV(PSIVAS,PSJCNTX)) Q:'PSJCNTX  D
"RTN","PSIVOCDS",35,0)
 . S PSIVAS0=$G(PSIVDDSV(PSIVAS,PSJCNTX))
"RTN","PSIVOCDS",36,0)
 .;PSJ*5*252 (6/29/11) - No longer need to convert "ML" to "L" now FDB handles both units for this drug.
"RTN","PSIVOCDS",37,0)
 .;I PSIVAS="SOL" S X=$$LITER($P(PSIVAS0,U,8)) I X]"" D
"RTN","PSIVOCDS",38,0)
 .;. S $P(PSIVAS0,U,8)=$P(X,U)
"RTN","PSIVOCDS",39,0)
 .;. S $P(PSIVAS0,U,9)=$P(X,U,2)
"RTN","PSIVOCDS",40,0)
 . S PSJCNT=PSJCNT+1
"RTN","PSIVOCDS",41,0)
 . D COMMON
"RTN","PSIVOCDS",42,0)
 . I P("DTYP")=1 S PSJOCDS("CONTEXT")="IP-IV-I" D IVPB
"RTN","PSIVOCDS",43,0)
 . I P("DTYP")>1 S PSJOCDS("CONTEXT")="IP-IV-C" D IV
"RTN","PSIVOCDS",44,0)
 Q
"RTN","PSIVOCDS",45,0)
IV ;Setup input data for Continuous IV (admixture, hyperal)
"RTN","PSIVOCDS",46,0)
 NEW PSJXRT,PSJP8ERR
"RTN","PSIVOCDS",47,0)
 S PSJP8=$$P8^PSJMISC2(P(8))
"RTN","PSIVOCDS",48,0)
 D BASIC
"RTN","PSIVOCDS",49,0)
 S PSJP8NUM=+$P(PSJP8,U)
"RTN","PSIVOCDS",50,0)
 S PSJP8UNT=$P(PSJP8,U,2)
"RTN","PSIVOCDS",51,0)
 S PSJP8TME=$P(PSJP8,U,3)
"RTN","PSIVOCDS",52,0)
 ;All premix are using the "Continuous Infusion" Route logic. This is so Potassium gets both single
"RTN","PSIVOCDS",53,0)
 ;and max dosing checks.  Cisplatin premix won't work since FDB can't process as "Continuous Infusion"
"RTN","PSIVOCDS",54,0)
 I PSIVAS="SOL" D PREMIX Q
"RTN","PSIVOCDS",55,0)
 S PSJXRT=$$RTESCRN($P($$MRT^PSSDSAPI(+P("MR")),U,1))
"RTN","PSIVOCDS",56,0)
 I $$ISONEAD(),$$ISALLBAG(),('$$CLASS(PSJFDB(PSJCNT,"DRUG_IEN"))),(PSJXRT'=0),$$FDBRT(PSJFDB(PSJCNT,"DRUG_IEN"),PSJXRT) D ONEAD(PSJXRT) Q
"RTN","PSIVOCDS",57,0)
 I PSJP8="" D FREEDOSE Q
"RTN","PSIVOCDS",58,0)
 D CONTIV
"RTN","PSIVOCDS",59,0)
 Q
"RTN","PSIVOCDS",60,0)
IVPB ;Setup input data for Schedule IV
"RTN","PSIVOCDS",61,0)
 NEW X,PSJP9,PSJP15,PSJX
"RTN","PSIVOCDS",62,0)
 S PSJOCDS(PSJCNT,"DRUG_AMT")=$P(PSIVAS0,U,8)
"RTN","PSIVOCDS",63,0)
 S PSJOCDS(PSJCNT,"DRUG_UNIT")=$P(PSIVAS0,U,9)
"RTN","PSIVOCDS",64,0)
 I '+$G(PSJIV("DUR")) D
"RTN","PSIVOCDS",65,0)
 . S X=$$DURATION()
"RTN","PSIVOCDS",66,0)
 . S PSJOCDS(PSJCNT,"DRATE")=$S(+X:X_"M",1:"")
"RTN","PSIVOCDS",67,0)
 I +$G(PSJIV("DUR"))<1440,(+$G(PSJIV("DUR"))>0) S PSJOCDS(PSJCNT,"DRATE")=PSJIV("DUR")
"RTN","PSIVOCDS",68,0)
 S PSJOCDS(PSJCNT,"MR_IEN")=+P("MR")
"RTN","PSIVOCDS",69,0)
 S PSJOCDS(PSJCNT,"DO")=""
"RTN","PSIVOCDS",70,0)
 S PSJOCDS(PSJCNT,"SCHEDULE")=P(9)
"RTN","PSIVOCDS",71,0)
 ;
"RTN","PSIVOCDS",72,0)
 S PSJFDB(PSJCNT,"DOSE_AMT")=$S('+$P(PSIVAS0,U,8):"",1:$P(PSIVAS0,U,8))
"RTN","PSIVOCDS",73,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSIVOCDS",74,0)
 S PSJFDB(PSJCNT,"DOSE_UNIT")=$P(PSIVAS0,U,9)
"RTN","PSIVOCDS",75,0)
 ;
"RTN","PSIVOCDS",76,0)
 S PSJONEFG=0
"RTN","PSIVOCDS",77,0)
 I $$ONE^PSJORPOE(P(9))!$$ONCALL^PSJMISC(P(9)) S PSJONEFG=1 D SINGLE Q
"RTN","PSIVOCDS",78,0)
 I +$G(PSJIV("DOSE_CNT")) S PSJFDB(PSJCNT,"FREQ")=$G(PSJIV("DOSE_CNT")) Q
"RTN","PSIVOCDS",79,0)
 I +$G(PSJOCDS(PSJCNT,"DRATE")) D UND24HRS^PSJOCDS(+PSJOCDS(PSJCNT,"DRATE"),$G(P(11)),$G(P(15)),$G(P(2)),$G(P(3)),$G(P(9))) Q
"RTN","PSIVOCDS",80,0)
 I 'PSJONEFG D
"RTN","PSIVOCDS",81,0)
 . S X="",PSJP9=P(9)
"RTN","PSIVOCDS",82,0)
 . S PSJX=+$O(^PS(51.1,"AC","PSJ",P(9),0))
"RTN","PSIVOCDS",83,0)
 . S PSJP15=P(15)
"RTN","PSIVOCDS",84,0)
 . I (P(9)["PRN"),'PSJX S PSJP15=""
"RTN","PSIVOCDS",85,0)
 . ;I (P(9)["PRN"),'$O(^PS(51.1,"AC","PSJ",P(9),0)) S PSJP15=""
"RTN","PSIVOCDS",86,0)
 . ;I P(15)="D",(P(11)]"") S $P(PSJP9,"@",2)=P(11)
"RTN","PSIVOCDS",87,0)
 . I 'PSJX&(P(15)="D")&(P(11)]"") S $P(PSJP9,"@",2)=P(11)
"RTN","PSIVOCDS",88,0)
 . ;Check for DOW schedule
"RTN","PSIVOCDS",89,0)
 . I PSJP15="",PSJX S PSJP15=$P($G(^PS(51.1,PSJX,0)),U,5)
"RTN","PSIVOCDS",90,0)
 . I P(9)]"" S X=$P($$FRQ^PSSDSAPI(PSJP9,PSJP15,"I",,PSJFDB(PSJCNT,"DRUG_IEN")),U)
"RTN","PSIVOCDS",91,0)
 . I X="" S X=1 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",92,0)
 . S PSJFDB(PSJCNT,"FREQ")=X
"RTN","PSIVOCDS",93,0)
 . S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",94,0)
 . S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSIVOCDS",95,0)
 Q
"RTN","PSIVOCDS",96,0)
SINGLE ;Set fields needed for Single Dose type
"RTN","PSIVOCDS",97,0)
 ; Can't get FDB to return correct data for Continuous Infusion /w Single dose so all Continuous will be sent in as Maintenance.
"RTN","PSIVOCDS",98,0)
 I PSJFDB(PSJCNT,"ROUTE")=("CONTINUOUS INFUSION") Q
"RTN","PSIVOCDS",99,0)
 S PSJFDB(PSJCNT,"DOSE_TYPE")="SINGLE DOSE"
"RTN","PSIVOCDS",100,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",101,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",102,0)
 S PSJFDB(PSJCNT,"DURATION_RT")=PSJFDB(PSJCNT,"DOSE_RATE")
"RTN","PSIVOCDS",103,0)
 Q
"RTN","PSIVOCDS",104,0)
COMMON ;Set common data for all IV types
"RTN","PSIVOCDS",105,0)
 S PSJFDB(PSJCNT,"RX_NUM")="I;"_$G(PSJPON)_";PROSPECTIVE;"_PSJCNT
"RTN","PSIVOCDS",106,0)
 S PSJFDB(PSJCNT,"DRUG_IEN")=$P(PSIVAS0,U)
"RTN","PSIVOCDS",107,0)
 S PSJFDB(PSJCNT,"DRUG_NM")=$P(PSIVAS0,U,2)_" "_$P(PSIVAS0,U,3)
"RTN","PSIVOCDS",108,0)
 S PSJFDB(PSJCNT,"DOSE_UNIT")=$P(PSIVAS0,U,9)
"RTN","PSIVOCDS",109,0)
 S PSJFDB(PSJCNT,"ROUTE")=PSJRT
"RTN","PSIVOCDS",110,0)
 S PSJFDB(PSJCNT,"DOSE_TYPE")="MAINTENANCE"
"RTN","PSIVOCDS",111,0)
 S PSJFDB(PSJCNT,"SPECIFIC")=1
"RTN","PSIVOCDS",112,0)
 ;This is set when CPRS sends Duration without entering a solution.
"RTN","PSIVOCDS",113,0)
 I $D(PSJIV("FRQ_ERROR")) S PSJFDB(PSJCNT,"FRQ_ERROR")="",PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",114,0)
 Q
"RTN","PSIVOCDS",115,0)
BASIC ;Set basic data for non schedule IVs
"RTN","PSIVOCDS",116,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSIVOCDS",117,0)
 S PSJFDB(PSJCNT,"FREQ")=""
"RTN","PSIVOCDS",118,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",119,0)
 S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSIVOCDS",120,0)
 ; SDA is set to the additive strength or volume of the solution.
"RTN","PSIVOCDS",121,0)
 S PSJFDB(PSJCNT,"DOSE_AMT")=$P(PSIVAS0,U,8)
"RTN","PSIVOCDS",122,0)
 Q
"RTN","PSIVOCDS",123,0)
FREEDOSE ;Set data for free text dose
"RTN","PSIVOCDS",124,0)
 ;"GENERAL" info only needed to pass in Dose Route and Dose Type.
"RTN","PSIVOCDS",125,0)
 ;"Exception" node sets here to get the specified error back for free text dosing.
"RTN","PSIVOCDS",126,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",127,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",128,0)
 S PSJFDB(PSJCNT,"DURATION_RT")=PSJFDB(PSJCNT,"DOSE_RATE")
"RTN","PSIVOCDS",129,0)
 S PSJFDB(PSJCNT,"INF_ERROR")=""
"RTN","PSIVOCDS",130,0)
 I $G(PSJP8ERR)=2!($G(PSJP8ERR)=4) S PSJFDB(PSJCNT,"WT_ERROR")=""
"RTN","PSIVOCDS",131,0)
 I $G(PSJP8ERR)=3!($G(PSJP8ERR)=4) S PSJFDB(PSJCNT,"HT_ERROR")=""
"RTN","PSIVOCDS",132,0)
 Q
"RTN","PSIVOCDS",133,0)
ONEAD(PSJRT) ;Setup data for 'Continuous Infusion' IV type
"RTN","PSIVOCDS",134,0)
 NEW PSJCLASS,PSJX
"RTN","PSIVOCDS",135,0)
 I $G(PSJRT)=0!($G(PSJRT)="") Q
"RTN","PSIVOCDS",136,0)
 ;Check to make sure the infusion rate is in form of "ml/hr" before applying the calculation
"RTN","PSIVOCDS",137,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",138,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",139,0)
 S PSJFDB(PSJCNT,"ROUTE")=PSJRT
"RTN","PSIVOCDS",140,0)
 I PSJP8="" D FREEDOSE Q
"RTN","PSIVOCDS",141,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")=PSJP8TME
"RTN","PSIVOCDS",142,0)
 S PSJFDB(PSJCNT,"DURATION_RT")=PSJP8TME
"RTN","PSIVOCDS",143,0)
 I PSJP8UNT="MILLILITERS",(PSJP8TME="HOUR") D
"RTN","PSIVOCDS",144,0)
 . S PSJFDB(PSJCNT,"DOSE_AMT")=$$SDACI()
"RTN","PSIVOCDS",145,0)
 . S PSJFDB(PSJCNT,"DOSE_UNIT")=$P(PSIVAS0,U,9)
"RTN","PSIVOCDS",146,0)
 I PSJP8UNT'="MILLILITERS" D
"RTN","PSIVOCDS",147,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",148,0)
 . S PSJFDB(PSJCNT,"DOSE_AMT")=PSJP8NUM
"RTN","PSIVOCDS",149,0)
 . S PSJFDB(PSJCNT,"DOSE_UNIT")=PSJP8UNT
"RTN","PSIVOCDS",150,0)
 . S PSJFDB(PSJCNT,"DOSE_RATE")=PSJP8TME
"RTN","PSIVOCDS",151,0)
 . S PSJFDB(PSJCNT,"DURATION_RT")=PSJP8TME
"RTN","PSIVOCDS",152,0)
 Q
"RTN","PSIVOCDS",153,0)
CONTIV ;Set data needed for continuous IV with multiple drugs
"RTN","PSIVOCDS",154,0)
 NEW PSJFREQ,PSJDIFF
"RTN","PSIVOCDS",155,0)
 S PSJDIFF=+$$DURATION()
"RTN","PSIVOCDS",156,0)
 ; Order has duration <24 hrs
"RTN","PSIVOCDS",157,0)
 I PSJDIFF D UND24HRS
"RTN","PSIVOCDS",158,0)
 ; Order has duration >= 24 hrs
"RTN","PSIVOCDS",159,0)
 I 'PSJDIFF S PSJFDB(PSJCNT,"FREQ")=$$IVFREQ
"RTN","PSIVOCDS",160,0)
 ;
"RTN","PSIVOCDS",161,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",162,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSIVOCDS",163,0)
 S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSIVOCDS",164,0)
 Q
"RTN","PSIVOCDS",165,0)
ISONEAD() ;Return 1 if there's only one additive
"RTN","PSIVOCDS",166,0)
 NEW X,PSJX
"RTN","PSIVOCDS",167,0)
 I $D(PSIVDDSV("AD")),$D(PSIVDDSV("SOL")) Q 0
"RTN","PSIVOCDS",168,0)
 I $O(PSIVDDSV("SOL",0)) Q 0
"RTN","PSIVOCDS",169,0)
 S PSJX=0
"RTN","PSIVOCDS",170,0)
 F X=0:0 S X=$O(PSIVDDSV("AD",X)) Q:'X  S PSJX=PSJX+1 Q:PSJX>1
"RTN","PSIVOCDS",171,0)
 I PSJX>1 Q 0
"RTN","PSIVOCDS",172,0)
 Q 1
"RTN","PSIVOCDS",173,0)
ISALLBAG() ;Return 1 if not additive not in all bags
"RTN","PSIVOCDS",174,0)
 ;***this call assuming only 1 additive entered in the order
"RTN","PSIVOCDS",175,0)
 NEW X,PSIVAS0
"RTN","PSIVOCDS",176,0)
 S X=$O(PSIVDDSV("AD",0))
"RTN","PSIVOCDS",177,0)
 S PSIVAS0=$G(PSIVDDSV("AD",X))
"RTN","PSIVOCDS",178,0)
 I $P(PSIVAS0,U,4)]"" Q 0
"RTN","PSIVOCDS",179,0)
 Q 1
"RTN","PSIVOCDS",180,0)
ISNOADD() ;Return 1 if there's no additives
"RTN","PSIVOCDS",181,0)
 NEW X,PSJX
"RTN","PSIVOCDS",182,0)
 I $O(PSIVDDSV("AD",0)) Q 0
"RTN","PSIVOCDS",183,0)
 I $D(PSIVDDSV("SOL")) Q 1
"RTN","PSIVOCDS",184,0)
 Q 0
"RTN","PSIVOCDS",185,0)
PREMIX ;The route is always set to "Continuous Infusion" & the FREQUENCY must set to 1
"RTN","PSIVOCDS",186,0)
 NEW X
"RTN","PSIVOCDS",187,0)
 S PSJFDB(PSJCNT,"ROUTE")=$$RTESCRN(PSJRT)
"RTN","PSIVOCDS",188,0)
 I PSJFDB(PSJCNT,"ROUTE")=0 S PSJFDB(PSJCNT,"ROUTE")=PSJRT
"RTN","PSIVOCDS",189,0)
 I PSJP8="" D FREEDOSE Q
"RTN","PSIVOCDS",190,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",191,0)
 S PSJFDB(PSJCNT,"DOSE_AMT")=PSJP8NUM
"RTN","PSIVOCDS",192,0)
 S PSJFDB(PSJCNT,"DOSE_UNIT")=PSJP8UNT
"RTN","PSIVOCDS",193,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")=PSJP8TME
"RTN","PSIVOCDS",194,0)
 S PSJFDB(PSJCNT,"DURATION_RT")=PSJP8TME
"RTN","PSIVOCDS",195,0)
 ;PSJ*5*252 (6/29/11) - No longer need to convert "ML" to "L" now FDB handles both units for this drug.
"RTN","PSIVOCDS",196,0)
 ;S PSJFDB(PSJCNT,"ROUTE")="CONTINUOUS INFUSION"
"RTN","PSIVOCDS",197,0)
 ;I PSJP8UNT="MILLILITERS" S X=$$LITER(PSJP8NUM) I X]"" D
"RTN","PSIVOCDS",198,0)
 ;. S PSJFDB(PSJCNT,"DOSE_AMT")=$P(X,U)
"RTN","PSIVOCDS",199,0)
 ;. S PSJFDB(PSJCNT,"DOSE_UNIT")=$P(X,U,2)
"RTN","PSIVOCDS",200,0)
 Q
"RTN","PSIVOCDS",201,0)
SDACI() ;Return Single Dose Amount for ad for 'CONTINUOUS INFUSION' FDB Route (Not classed at "VT" or "TN")
"RTN","PSIVOCDS",202,0)
 ;Single Dose Amount(PSJSDA):
"RTN","PSIVOCDS",203,0)
 ; For Additive - PSJSDA=(Strength/Tot vol)*Infusion Rate
"RTN","PSIVOCDS",204,0)
 ; If can't calculate then return null
"RTN","PSIVOCDS",205,0)
 NEW PSJSDA,X
"RTN","PSIVOCDS",206,0)
 S PSJSDA=""
"RTN","PSIVOCDS",207,0)
 I $D(PSIVDDSV("AD")) D
"RTN","PSIVOCDS",208,0)
 . S X=+$G(PSIVDDSV("TOT_VOL")) Q:'X
"RTN","PSIVOCDS",209,0)
 . S PSJSDA=($P(PSIVAS0,U,8)/X)*PSJP8NUM
"RTN","PSIVOCDS",210,0)
 I '+PSJSDA S PSJSDA=$P(PSIVAS0,U,8),PSJFDB(PSJCNT,"INF_ERROR")=""
"RTN","PSIVOCDS",211,0)
 Q PSJSDA
"RTN","PSIVOCDS",212,0)
CLASS(PSJDD) ;Check if the Drug contains "VT" & "TN" classes
"RTN","PSIVOCDS",213,0)
 ;Return 1 if "VT" or "TN"
"RTN","PSIVOCDS",214,0)
 ;Return 0 if not
"RTN","PSIVOCDS",215,0)
 Q:'+$G(PSJDD) 0
"RTN","PSIVOCDS",216,0)
 NEW PSJCLASS
"RTN","PSIVOCDS",217,0)
 S PSJCLASS=$P($G(^PSDRUG(+PSJDD,0)),U,2)
"RTN","PSIVOCDS",218,0)
 ;I (PSJCLASS["TN")!(PSJCLASS["VT") Q 1
"RTN","PSIVOCDS",219,0)
 I PSJCLASS["VT" Q 1
"RTN","PSIVOCDS",220,0)
 Q 0
"RTN","PSIVOCDS",221,0)
IVFREQ() ;Return the frequency for an continuous IV
"RTN","PSIVOCDS",222,0)
 ; Hours needed to run a bag is defined as: Total Volume / Infusion rate
"RTN","PSIVOCDS",223,0)
 ; # of bags needed for a day is defined as: 24 / Hours need to run a bag
"RTN","PSIVOCDS",224,0)
 ; PSJFREQ is either in Q#H or N for # of admin per day
"RTN","PSIVOCDS",225,0)
 NEW PSJFREQ,PSJBOT,PSJX,X,PSJTOTBG,PSJTOTBT,PSJTOTV,PSJBAGX
"RTN","PSIVOCDS",226,0)
 S (PSJFREQ,PSJTOTBG,PSJTOTBT)=0
"RTN","PSIVOCDS",227,0)
 S PSJTOTV=+$G(PSIVDDSV("TOT_VOL"))
"RTN","PSIVOCDS",228,0)
 ;CONV^PSSDSAPK converts # of hours to run a bag to either Q#H or n for number of admin per day
"RTN","PSIVOCDS",229,0)
 I +PSJTOTV,PSJP8NUM D
"RTN","PSIVOCDS",230,0)
 . I +PSJTOTV#PSJP8NUM D
"RTN","PSIVOCDS",231,0)
 .. S PSJFDB(PSJCNT,"DOSE_AMT")=$$ADJSDA(+PSJTOTV,PSJP8NUM,+PSJFDB(PSJCNT,"DOSE_AMT"),1)
"RTN","PSIVOCDS",232,0)
 . S PSJBAGX=PSJTOTV/PSJP8NUM
"RTN","PSIVOCDS",233,0)
 . I PSJBAGX<1 S PSJFREQ="Q1H"
"RTN","PSIVOCDS",234,0)
 . S:PSJBAGX'<1 PSJFREQ=$$CONV^PSSDSAPK(PSJTOTV/PSJP8NUM)
"RTN","PSIVOCDS",235,0)
 . S PSJTOTBG=24/(+PSJTOTV/PSJP8NUM)
"RTN","PSIVOCDS",236,0)
 I PSIVAS="AD" D BOTTLE(PSJTOTBG,$P(PSIVAS0,U,4)) D
"RTN","PSIVOCDS",237,0)
 . I PSJTOTBG<1,'(+PSJTOTV#PSJP8NUM) S PSJFDB(PSJCNT,"DOSE_AMT")=$$ADJSDA(+PSJTOTV,PSJP8NUM,+PSJFDB(PSJCNT,"DOSE_AMT"),0)
"RTN","PSIVOCDS",238,0)
 I PSJFREQ=""!(PSJFREQ=0) S PSJFREQ=1 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",239,0)
 Q PSJFREQ
"RTN","PSIVOCDS",240,0)
ADJSDA(PSJTOTV,PSJINFRT,PSJSDA,PSJNOTE) ;Adjust SDA
"RTN","PSIVOCDS",241,0)
 NEW PSJBAGX,X,PSJNOTEV
"RTN","PSIVOCDS",242,0)
 I '+$G(PSJTOTV) Q ""
"RTN","PSIVOCDS",243,0)
 I '+$G(PSJINFRT) Q ""
"RTN","PSIVOCDS",244,0)
 I '+$G(PSJSDA) Q ""
"RTN","PSIVOCDS",245,0)
 S (PSJBAGX,X)=+PSJTOTV/PSJINFRT
"RTN","PSIVOCDS",246,0)
 ;**  Removed for MOCHA 2.0 When it takes < 1 hour to run a bag. May need to bring back for MOCHA 2.1 (Daily dose check).
"RTN","PSIVOCDS",247,0)
 ;I PSJBAGX<1 S PSJSDA=PSJSDA/PSJBAGX
"RTN","PSIVOCDS",248,0)
 I PSJBAGX<1 D
"RTN","PSIVOCDS",249,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",250,0)
 . S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",251,0)
 . S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSIVOCDS",252,0)
 . S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSIVOCDS",253,0)
 I PSJBAGX'<1 D
"RTN","PSIVOCDS",254,0)
 . S X=$J(PSJBAGX,"",0)
"RTN","PSIVOCDS",255,0)
 . S PSJSDA=PSJSDA/(+PSJTOTV)*PSJINFRT*($S(X<24:X,1:24))
"RTN","PSIVOCDS",256,0)
 . S PSJNOTEV=($S(X<24:X,1:24)*PSJINFRT)_" ML over "_$S(X<24:X,1:24)_" hours)."
"RTN","PSIVOCDS",257,0)
 . I $G(PSJNOTE) D
"RTN","PSIVOCDS",258,0)
 .. S PSJFDB(PSJCNT,"ADJ_MSG")="PLEASE NOTE: The single dose of the IV Additive has been adjusted to reflect the amount of drug infused over the nearest whole number of hours ("_PSJNOTEV
"RTN","PSIVOCDS",259,0)
 . I '$G(PSJNOTE) D
"RTN","PSIVOCDS",260,0)
 .. S PSJFDB(PSJCNT,"ADJ_MSG")="PLEASE NOTE:  The single dose of the IV Additive has been adjusted to reflect the amount of drug infused over the duration of the order or 24 hours; whichever is less ("_PSJNOTEV
"RTN","PSIVOCDS",261,0)
 Q PSJSDA
"RTN","PSIVOCDS",262,0)
UND24HRS ;Calculate freq for order <24 hrs
"RTN","PSIVOCDS",263,0)
 NEW PSJTOTV,PSJBAG,PSJMNBAG,PSJTOTBG,PSJFREQ,PSJHRS,X
"RTN","PSIVOCDS",264,0)
 S (PSJFREQ,PSJBAG,PSJMNBAG)=0
"RTN","PSIVOCDS",265,0)
 S PSJTOTV=+$G(PSIVDDSV("TOT_VOL"))
"RTN","PSIVOCDS",266,0)
 I +PSJTOTV,PSJP8NUM D
"RTN","PSIVOCDS",267,0)
 . S PSJHRS=PSJTOTV/PSJP8NUM
"RTN","PSIVOCDS",268,0)
 . S PSJMNBAG=PSJHRS*60
"RTN","PSIVOCDS",269,0)
 . S PSJTOTBG=24/PSJHRS
"RTN","PSIVOCDS",270,0)
 I '+PSJMNBAG D  Q
"RTN","PSIVOCDS",271,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",272,0)
 . S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",273,0)
 S:+PSJMNBAG PSJBAG=PSJDIFF/PSJMNBAG
"RTN","PSIVOCDS",274,0)
 ; If the order is for < 24 hrs & Freq < 1 then adjust the SDA & Freq set to 1
"RTN","PSIVOCDS",275,0)
 I PSJBAG<1 D  Q
"RTN","PSIVOCDS",276,0)
 . S X=$J((PSJDIFF/60),"",0)
"RTN","PSIVOCDS",277,0)
 . S PSJNOTEV=($S(X<24:X,1:24)*PSJP8NUM)_" ML over "_$S(X<24:X,1:24)_" hours)."
"RTN","PSIVOCDS",278,0)
 . S PSJFDB(PSJCNT,"ADJ_MSG")="PLEASE NOTE:  The single dose of the IV Additive has been adjusted to reflect the amount of drug infused over the duration of the order or 24 hours; whichever is less ("_PSJNOTEV
"RTN","PSIVOCDS",279,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",280,0)
 . S PSJFDB(PSJCNT,"DOSE_AMT")=PSJBAG*(PSJFDB(PSJCNT,"DOSE_AMT"))
"RTN","PSIVOCDS",281,0)
 ;
"RTN","PSIVOCDS",282,0)
 S PSJFREQ=$J(PSJBAG,"",0)
"RTN","PSIVOCDS",283,0)
 I PSIVAS="AD" D BOTTLE(PSJFREQ,$P(PSIVAS0,U,4))
"RTN","PSIVOCDS",284,0)
 S PSJFDB(PSJCNT,"FREQ")=PSJFREQ
"RTN","PSIVOCDS",285,0)
 Q
"RTN","PSIVOCDS",286,0)
 ;
"RTN","PSIVOCDS",287,0)
BOTTLE(PSJTOTBG,PSJBOT) ;Set freq to either specified bottle or # needed for the duration/24hrs of the order
"RTN","PSIVOCDS",288,0)
 NEW PSJTOTBT,X,PSJX
"RTN","PSIVOCDS",289,0)
 I $$UP^XLFSTR($G(PSJBOT))="ALL BAGS" Q
"RTN","PSIVOCDS",290,0)
 I $$UP^XLFSTR($G(PSJBOT))="SEE COMMENTS" Q
"RTN","PSIVOCDS",291,0)
 Q:'+$G(PSJTOTBG)
"RTN","PSIVOCDS",292,0)
 ;
"RTN","PSIVOCDS",293,0)
 ;PSJ*5*252 - ADJSDA already adjusted the SDA so recal SDA is not needed
"RTN","PSIVOCDS",294,0)
 I PSJTOTBG<1 S PSJFREQ=1 Q
"RTN","PSIVOCDS",295,0)
 Q:$G(PSJBOT)=""
"RTN","PSIVOCDS",296,0)
 S PSJTOTBT=0
"RTN","PSIVOCDS",297,0)
 F X=1:1:$L(PSJBOT,",") S PSJX=$P(PSJBOT,",",X) S:+PSJX PSJTOTBT=PSJTOTBT+1
"RTN","PSIVOCDS",298,0)
 S PSJFREQ=$S(PSJTOTBT>PSJTOTBG:PSJTOTBG,1:PSJTOTBT)
"RTN","PSIVOCDS",299,0)
 I PSJTOTV#PSJP8NUM,(PSJTOTBT>PSJTOTBG) D
"RTN","PSIVOCDS",300,0)
 . S PSJFREQ=$$CONV^PSSDSAPK(PSJTOTV/PSJP8NUM)
"RTN","PSIVOCDS",301,0)
 I PSJFREQ=0 S PSJFREQ=1 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",302,0)
 Q
"RTN","PSIVOCDS",303,0)
DURATION() ;
"RTN","PSIVOCDS",304,0)
 ;If PSJIV("DUR") is passed in from CPRS then return the minutes if <1440 otherwise return ""
"RTN","PSIVOCDS",305,0)
 ;If not call from CPRS then calculate from start, stop date
"RTN","PSIVOCDS",306,0)
 NEW PSJX,X,PSJP8X
"RTN","PSIVOCDS",307,0)
 S PSJX=""
"RTN","PSIVOCDS",308,0)
 I +$G(PSJIV("DUR")) D  Q X
"RTN","PSIVOCDS",309,0)
 .S PSJX=+$G(PSJIV("DUR"))
"RTN","PSIVOCDS",310,0)
 .S X=$S(PSJX<1440:PSJX,1:"")
"RTN","PSIVOCDS",311,0)
 I +$G(PSJIV("TOT_VOL")) D  Q X
"RTN","PSIVOCDS",312,0)
 . S PSJP8X=$S(+$G(PSJP8NUM):PSJP8NUM,+P(8):+P(8),1:0)
"RTN","PSIVOCDS",313,0)
 . S:PSJP8X PSJX=(+PSJIV("TOT_VOL")/PSJP8X)*60
"RTN","PSIVOCDS",314,0)
 . S X=$S(PSJX<1440:PSJX,1:"")
"RTN","PSIVOCDS",315,0)
 S X=$$DURATION^PSJOCDS($G(P(2)),$G(P(3)))
"RTN","PSIVOCDS",316,0)
 Q X
"RTN","PSIVOCDS",317,0)
FDBRT(PSJDD,PSJRT) ;Check if the ordered route can be admin by FDB for this drug
"RTN","PSIVOCDS",318,0)
 ;PSJDD = Drug IEN
"RTN","PSIVOCDS",319,0)
 ;PSJRT = FDB continuous dose route (ordered MR -> Standard RT ->FDB cont. Rt)
"RTN","PSIVOCDS",320,0)
 ;Return 1 if the route can admin by FDB; 0 if this route is not specify for this drug
"RTN","PSIVOCDS",321,0)
 NEW PSJFDBRT
"RTN","PSIVOCDS",322,0)
 I '+$G(PSJDD)!$G(PSJRT)="" Q 0
"RTN","PSIVOCDS",323,0)
 D GROUTE^PSSFDBRT(PSJDD,.PSJFDBRT)
"RTN","PSIVOCDS",324,0)
 I +$G(PSJFDBRT(0))=-1 Q 1
"RTN","PSIVOCDS",325,0)
 I $D(PSJFDBRT(PSJRT)) Q 1
"RTN","PSIVOCDS",326,0)
 Q 0
"RTN","PSIVOCDS",327,0)
RTESCRN(PSJRT) ; Screen routes for none "VT or "TN"
"RTN","PSIVOCDS",328,0)
 ;Return 0 or FDB continuous dose route if the standard route(mapped to the ordered MR) is one of the six below.
"RTN","PSIVOCDS",329,0)
 ;PSJRT - standard route
"RTN","PSIVOCDS",330,0)
 I $G(PSJRT)="" Q 0
"RTN","PSIVOCDS",331,0)
 I PSJRT="EPIDURAL" Q "CONTINUOUS EPIDURAL"
"RTN","PSIVOCDS",332,0)
 I PSJRT="INTRA-ARTERIAL" Q "CONT INTRAARTER INF"
"RTN","PSIVOCDS",333,0)
 I PSJRT="INFILTRATION" Q "CONTINUOUS INFILTRAT"
"RTN","PSIVOCDS",334,0)
 I PSJRT="INTRACAUDAL" Q "CONT CAUDAL INFUSION"
"RTN","PSIVOCDS",335,0)
 I PSJRT="INTRAOSSEOUS" Q "CONT INTRAOSSEOUS"
"RTN","PSIVOCDS",336,0)
 I PSJRT="INTRATHECAL" Q "CONT INTRATHECAL INF"
"RTN","PSIVOCDS",337,0)
 I PSJRT="INTRAVENOUS" Q "CONTINUOUS INFUSION"
"RTN","PSIVOCDS",338,0)
 I PSJRT="NEBULIZATION" Q "CONT NEBULIZATION"
"RTN","PSIVOCDS",339,0)
 I PSJRT="SUBCUTANEOUS" Q "CONT SUBCUTAN INFUSI"
"RTN","PSIVOCDS",340,0)
 Q 0
"RTN","PSIVOCDS",341,0)
LITER(PSJVOLP8) ; Convert the unit from ML to L for premix contains potassium
"RTN","PSIVOCDS",342,0)
 ; PSJ*5*252 (6/29/11) - No longer need to convert "ML" to "L" for this drug now that FDB handles both units.
"RTN","PSIVOCDS",343,0)
 ; FDB only accept Liter for this type for drug
"RTN","PSIVOCDS",344,0)
 ; PSJVOLP8 - Either = volume or the infusion rate
"RTN","PSIVOCDS",345,0)
 NEW PSJVAGEN,PSJSDA,PSJUNIT
"RTN","PSIVOCDS",346,0)
 Q:$G(PSJVOLP8)=""
"RTN","PSIVOCDS",347,0)
 S PSJVAGEN=$$VAGEN^PSJMISC($P(PSIVAS0,U))
"RTN","PSIVOCDS",348,0)
 I PSJVAGEN["POTASSIUM" D
"RTN","PSIVOCDS",349,0)
 . S PSJSDA=+(PSJVOLP8/1000)
"RTN","PSIVOCDS",350,0)
 . S PSJUNIT="L"
"RTN","PSIVOCDS",351,0)
 I '+$G(PSJSDA)!($G(PSJUNIT)="") Q ""
"RTN","PSIVOCDS",352,0)
 Q PSJSDA_U_PSJUNIT
"RTN","PSIVOD")
0^27^B15601975
"RTN","PSIVOD",1,0)
PSIVOD ;BIR/JCH-CREATE NEW IV ORDER FROM OLD ONE ;25 Nov 98 / 3:34 PM
"RTN","PSIVOD",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**110,127,181,281,256**;16 DEC 97;Build 34
"RTN","PSIVOD",3,0)
 ;
"RTN","PSIVOD",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSIVOD",5,0)
 ; Reference to ^ORX2 is supported by DBIA 867.
"RTN","PSIVOD",6,0)
 ;
"RTN","PSIVOD",7,0)
COPY(DFN,OLDON) ;Ask to enter new order.
"RTN","PSIVOD",8,0)
 N PSIVOORD,OLDP,PSIVCOPY,PSGCOPY,I,% M OLDP=P
"RTN","PSIVOD",9,0)
 Q:'$$HIDDEN^PSJLMUTL("COPY")  D ^PSJHVARS
"RTN","PSIVOD",10,0)
 I $P($G(^PS(55,PSGP,"IV",+PSGORD,.2)),U,4)="D",'$P($G(^(4)),"^",3) D  G Q
"RTN","PSIVOD",11,0)
 .W !!,"Nurse verified orders with a priority of DONE may not be Copied." D PAUSE^VALM1 Q
"RTN","PSIVOD",12,0)
 S PSGOEAV=$P(PSJSYSP0,U,9)&PSJSYSU S PSIVOORD=PSJORD
"RTN","PSIVOD",13,0)
 D FULL^VALM1
"RTN","PSIVOD",14,0)
 F  W !!,"Do you want to copy this order" S %=2 D YN^DICN Q:%  D CH
"RTN","PSIVOD",15,0)
 G:%'=1 Q
"RTN","PSIVOD",16,0)
 S P("RES")="N",PSIVAC="PN",P("PON")=ON55,PSIVUP=+$$GTPCI^PSIVUTL,PSJORD=ON55,PSGORD=PSJORD
"RTN","PSIVOD",17,0)
 N OLDACT,PSIVCHG S OLDACT=PSGACT S PSGACT=PSGACT_"E",P(17)="N",(P("LOG"),P("LF"))="",P(21)="" K P("NAT")
"RTN","PSIVOD",18,0)
 S:'$G(PSGDT) PSGDT=$$DATE^PSJUTL2() S P("LOG")=PSGDT,P("PRNTON")=""
"RTN","PSIVOD",19,0)
 ;PSJ*5*256
"RTN","PSIVOD",20,0)
 NEW PSJOLDNM
"RTN","PSIVOD",21,0)
 S PSJOLDNM("ORD_SCHD")=$G(P(9))
"RTN","PSIVOD",22,0)
 I $$CHKSCHD^PSJMISC2(.PSJOLDNM) W !!,"Order not copied." D PAUSE^VALM1 K PSJOLDNM G Q
"RTN","PSIVOD",23,0)
 S:$G(PSJOLDNM("NEW_SCHD"))]"" P(9)=PSJOLDNM("NEW_SCHD") K PSJOLDNM
"RTN","PSIVOD",24,0)
 D ENT^PSIVCAL,ENSTOP^PSIVCAL S ND4="^^^^" F I=5,6,8,9 S $P(ND2,"^",I)=""
"RTN","PSIVOD",25,0)
 S P(17)=$S($G(PSGOEAV):"A",1:"N") S P("CLRK")=DUZ_"^"_$P($G(^VA(200,+DUZ,0)),"^")
"RTN","PSIVOD",26,0)
 S PSIVCHG=0,PSJNEWOE=0,PSIVCOPY=1,VALMBCK="Q" K PSIVACEP
"RTN","PSIVOD",27,0)
 NEW PSGORQF K PSGORQF D OC^PSIVOC G:$G(PSGORQF) Q
"RTN","PSIVOD",28,0)
 N PSGORD,ON,ON55,PSJORD D NEW55^PSIVORFB S (PSJORD,ON)=ON55,PSIVCOPY=2
"RTN","PSIVOD",29,0)
 D EN^VALM("PSJ LM IV AC/EDIT")
"RTN","PSIVOD",30,0)
 I $G(P("NAT"))=""&($G(PSJORNAT)="") D  G Q
"RTN","PSIVOD",31,0)
 .D FULL^VALM1 W !!,"Order not copied" D PAUSE^VALM1
"RTN","PSIVOD",32,0)
 W !!,"...copying..."
"RTN","PSIVOD",33,0)
 ;RTC 178789 - not to store allergy OC until either verify or quit as non-vf order
"RTN","PSIVOD",34,0)
 ;D SETOC^PSJNEWOC(ON55)
"RTN","PSIVOD",35,0)
 ;
"RTN","PSIVOD",36,0)
 I '$G(PSGOEAV) D INMED
"RTN","PSIVOD",37,0)
 ;
"RTN","PSIVOD",38,0)
 D FULL^VALM1 W !!?5,"You are finished with the new order.",!,"The following ACTION prompt is for the original order." D PAUSE^VALM1
"RTN","PSIVOD",39,0)
Q ; Kill and exit.
"RTN","PSIVOD",40,0)
 L:'$D(PSJOE) -^PS(53.45,DUZ) S PSJNKF=1 D Q^PSIV
"RTN","PSIVOD",41,0)
 K FIL,I1,ND,PC,PDM,PSGDT,PSGID,PSGLMT,PSGSI,PSJNARC,PSIVAC,PSIVCHG,PSIVUP,PSIVX,PSJOPC,PSJAGYSV
"RTN","PSIVOD",42,0)
 S VALMBCK="R"
"RTN","PSIVOD",43,0)
 I '$G(PSGDT) S PSGDT=$$DATE^PSJUTL2
"RTN","PSIVOD",44,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSIVOORD) ; resets PSGACT after copy
"RTN","PSIVOD",45,0)
 D RESTORE^PSJHVARS
"RTN","PSIVOD",46,0)
 K P M P=OLDP
"RTN","PSIVOD",47,0)
 Q
"RTN","PSIVOD",48,0)
 ;
"RTN","PSIVOD",49,0)
INMED ;
"RTN","PSIVOD",50,0)
 K PSJACEPT S VALMBCK="Q",PSIVCOPY=2,PSIVCHG=0 ;D ACEDIT^PSJLIACT
"RTN","PSIVOD",51,0)
 N ON55TMP,P21TMP S ON55TMP=ON55,P21TMP=$G(P(21)) S P(21)="" I $G(ON55)["P",($G(PSJORD)["V") S ON55=PSJORD
"RTN","PSIVOD",52,0)
 D DEL55^PSIVORE2 I $G(ON55TMP)]"" S ON55=ON55TMP,P(21)=P21TMP
"RTN","PSIVOD",53,0)
 ;S (PSJORNAT,P("NAT"))="W"
"RTN","PSIVOD",54,0)
 ;D OK^PSIVORE
"RTN","PSIVOD",55,0)
 D EN^VALM("PSJ LM IV INPT ACTIVE")
"RTN","PSIVOD",56,0)
 ;RTC 178789 - Store allergy OC as non-vf order
"RTN","PSIVOD",57,0)
 D:$G(ON55)["P" SETOC^PSJNEWOC($G(ON55))
"RTN","PSIVOD",58,0)
 L -^PS(55,DFN,"IV",+ON55) D ULK
"RTN","PSIVOD",59,0)
 I $G(P("NAT"))="" D  G Q
"RTN","PSIVOD",60,0)
 .D FULL^VALM1 W !!,"Order not copied" D PAUSE^VALM1
"RTN","PSIVOD",61,0)
 Q
"RTN","PSIVOD",62,0)
ULK ;
"RTN","PSIVOD",63,0)
 Q:'$G(PSJLSORX)  ;If NEW^PSIVORE did not lock, don't kill it here.
"RTN","PSIVOD",64,0)
 NEW X S X=DFN_";DPT(" D ULK^ORX2 K PSJLSORX
"RTN","PSIVOD",65,0)
 Q
"RTN","PSIVOD",66,0)
HK ;Queue job to print MAR labels generated for this patient.
"RTN","PSIVOD",67,0)
 I PSGOP,PSGOP'=DFN D
"RTN","PSIVOD",68,0)
 .N PSJACPF,PSJACNWP,PSJPWD,PSJSYSL,PSJSYSW,PSJSYSW0,DFN,VAIN,VAERR S DFN=PSGOP
"RTN","PSIVOD",69,0)
 .D INP^VADPT S PSJPWD=+VAIN(4) I PSJPWD S PSJACPF=10 S PSJACPF=10 D WP^PSJAC D:$P(PSJSYSL,U,2)]"" ENQL^PSGLW
"RTN","PSIVOD",70,0)
 S PSGOP=DFN
"RTN","PSIVOD",71,0)
 Q
"RTN","PSIVOD",72,0)
 ;
"RTN","PSIVOD",73,0)
SPSOL S SPSOL=0 F XXX=0:0 S XXX=$O(^PS(55,DFN,"IV",+ON55,"SOL",XXX)) Q:'XXX  S SPSOL=SPSOL+$P(^(XXX,0),U,2)
"RTN","PSIVOD",74,0)
 K XXX Q
"RTN","PSIVOD",75,0)
CH ;
"RTN","PSIVOD",76,0)
 W !!?2,"Answer 'YES' to have a new, non-verified order created for this patient,"
"RTN","PSIVOD",77,0)
 W !,"using the information from this order.  (The START and STOP dates will be",!,"recalculated.)  Enter 'NO' (or '^') to stop now."
"RTN","PSIVOD",78,0)
 Q
"RTN","PSIVQUI")
0^29^B21879458
"RTN","PSIVQUI",1,0)
PSIVQUI ;BIR/RGY,MLM-HANDLE QUICK CODE ENTRIES ;15 Dec 98 / 8:29 AM
"RTN","PSIVQUI",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**21,50,65,73,76,93,104,110,275,256**;16 DEC 97;Build 34
"RTN","PSIVQUI",3,0)
 ;
"RTN","PSIVQUI",4,0)
 ;Reference to ^PS(51.1 is supported by DBIA 2177
"RTN","PSIVQUI",5,0)
 ;Reference to ^PS(51.2 is supported by DBIA 2178
"RTN","PSIVQUI",6,0)
 ;Reference to ^PS(52.6 is supported by DBIA 1231
"RTN","PSIVQUI",7,0)
 ;Reference to ^PS(52.7 is supported by DBIA 2173
"RTN","PSIVQUI",8,0)
 ;
"RTN","PSIVQUI",9,0)
 N X,PSIVSC1 S (PSIVAT,PSIVAAT,PSIVWAT)="",PSIVQUIY=Y,(X,PSIVQUIX)=PSIVX
"RTN","PSIVQUI",10,0)
 Q:'Y!(PSIVQUIX="")  S PSIVX0=$O(^PS(52.6,"C",X,+Y,0)),PSIVX0=$G(^PS(52.6,+Y,1,PSIVX0,0))
"RTN","PSIVQUI",11,0)
 I $P(PSIVX0,"^",5)]""!$P(PSIVX0,"^",6)!(P(5)) S PSIVAAT=$P(PSIVX0,"^",6)
"RTN","PSIVQUI",12,0)
 K PSIVX0 S Y=PSIVQUIY,Y(0)=$G(^PS(52.6,+Y,0)),X=PSIVQUIX
"RTN","PSIVQUI",13,0)
 Q:$S('$D(X):1,'$D(^PS(52.6,"C",X)):1,1:0)!'$D(P(4))
"RTN","PSIVQUI",14,0)
SET K DRG S PSIVX0=$S($D(^PS(52.6,+Y,1,+$O(^PS(52.6,"C",X,+Y,0)),0)):^(0),1:""),(DRGI,DRG("AD",0))=1,TDRG("AD",+Y,DRGI)="",DRG("AD",DRGI)=+Y_U_$P(Y(0),U)_U_$P(PSIVX0,"^",2)_U_U_$P(Y(0),U,13)_U_$P(Y(0),U,11)
"RTN","PSIVQUI",15,0)
 N PSIVQZ,PSIVADD0,PSIVSZ,PSIVAZ,PSIVXAT,PSIVSIEN,PSIVXW S PSIVSIEN=0
"RTN","PSIVQUI",16,0)
 ;*** PSJ*5*256
"RTN","PSIVQUI",17,0)
 I $P(PSIVX0,"^",5)]"" D  Q:$G(PSGORQF)
"RTN","PSIVQUI",18,0)
 . NEW PSJOLDNM
"RTN","PSIVQUI",19,0)
 . S PSJOLDNM("ORD_SCHD")=$P(PSIVX0,"^",5)
"RTN","PSIVQUI",20,0)
 . I $$CHKSCHD^PSJMISC2(.PSJOLDNM) S PSGORQF=1,DONE=1 Q
"RTN","PSIVQUI",21,0)
 . S:$G(PSJOLDNM("NEW_SCHD"))]"" $P(PSIVX0,"^",5)=PSJOLDNM("NEW_SCHD"),$P(PSIVX0,"^",6)=""
"RTN","PSIVQUI",22,0)
 I $P(PSIVX0,U,4)]"" S P("OPI")=$P(PSIVX0,U,4) K ^PS(53.45,+$G(PSJSYSP),6) S ^PS(53.45,+$G(PSJSYSP),6,0)="^^1^1^",^(1,0)=P("OPI")
"RTN","PSIVQUI",23,0)
 I $P(PSIVX0,U,7)?1N.N D  Q:$G(PSGORQF)
"RTN","PSIVQUI",24,0)
 . S ND=$G(^PS(52.7,$P(PSIVX0,U,7),0))
"RTN","PSIVQUI",25,0)
 . W !!,"SOLUTION: ",$P(ND,U),!
"RTN","PSIVQUI",26,0)
 . N FIL S FIL="52.7",DRGTMP=$P(PSIVX0,U,7) D ORDERCHK^PSIVEDRG(DFN,ON55,1)
"RTN","PSIVQUI",27,0)
 . I $G(PSGORQF) S X="^",DONE=1 Q
"RTN","PSIVQUI",28,0)
 . S DRG("SOL",0)=1,DRG("SOL",1)=$P(PSIVX0,U,7)_U_$P(ND,U)_U_$P(ND,U,3)_U_U_$P(ND,U,13)_U_$P(ND,U,11),TDRG("SOL",$P(PSIVX0,U,7),1)=""
"RTN","PSIVQUI",29,0)
 I $P(PSIVX0,U,5)]""!P(5) S X=$P(PSIVX0,U,5)
"RTN","PSIVQUI",30,0)
 S PSIVQZ=$P(PSIVX0,U,5),PSIVQAZ=$P(PSIVX0,U,6),PSIVADD0=$G(^PS(52.6,+PSIVQUIY,0)),X=PSIVQZ
"RTN","PSIVQUI",31,0)
 S PSIVSZ=$P(PSIVADD0,"^",5),PSIVAZ=$P(PSIVADD0,"^",6)
"RTN","PSIVQUI",32,0)
 S PSIVAAT=$S(PSIVQZ]""&(PSIVQAZ]""):PSIVQAZ,PSIVQZ=""&(PSIVSZ]""):PSIVAZ,PSIVQZ=PSIVSZ:PSIVAZ,1:"")
"RTN","PSIVQUI",33,0)
 I $P(PSIVX0,U,5)']""!P(5) S X=$S(X]"":X,1:$P($G(^PS(52.6,+PSIVQUIY,0)),"^",5))
"RTN","PSIVQUI",34,0)
 ;
"RTN","PSIVQUI",35,0)
 ; If a sched was found, check all matching schedules 
"RTN","PSIVQUI",36,0)
 ; in 51.1 against $P(PSIVX0,"^",5), PSIVAAT, PSIVWAT
"RTN","PSIVQUI",37,0)
 I PSIVQZ]"",$G(X)'="" S ZZ=0 D
"RTN","PSIVQUI",38,0)
 .;if ZZ sched/times matches quick code sched/times, use the schedule
"RTN","PSIVQUI",39,0)
 .F  S ZZ=$O(^PS(51.1,"AC","PSJ",X,ZZ)) Q:'ZZ!PSIVSIEN  D  Q:PSIVSIEN
"RTN","PSIVQUI",40,0)
 ..N PSIVXAT S PSIVXAT=$P(^PS(51.1,ZZ,0),"^",2) Q:PSIVXAT=""
"RTN","PSIVQUI",41,0)
 ..I PSIVXAT=$P(PSIVX0,"^",6) S PSIVAT=$P(PSIVX0,"^",6),PSIVSIEN=ZZ
"RTN","PSIVQUI",42,0)
 ;
"RTN","PSIVQUI",43,0)
 ; If quick code has no schedule, check IV additive
"RTN","PSIVQUI",44,0)
 I PSIVAT="",$P(PSIVX0,"^",5)="",$G(X)'="" S ZZ=0 D 
"RTN","PSIVQUI",45,0)
 .F  S ZZ=$O(^PS(51.1,"AC","PSJ",X,ZZ)) Q:'ZZ!PSIVSIEN  D  Q:PSIVSIEN
"RTN","PSIVQUI",46,0)
 ..N PSIVXAT S PSIVXAT=$P(^PS(51.1,ZZ,0),"^",2) Q:PSIVXAT=""
"RTN","PSIVQUI",47,0)
 ..I PSIVAAT=PSIVXAT,(X=PSIVSZ) S PSIVAT=PSIVAAT,PSIVSIEN=ZZ
"RTN","PSIVQUI",48,0)
 .I PSIVAT="",PSIVAAT]"" S PSIVAT=PSIVAAT,$P(PSIVX0,"^",6)=PSIVAAT,$P(PSIVX0,"^",5)=PSIVSZ,PSIVSIEN=-1
"RTN","PSIVQUI",49,0)
 ;
"RTN","PSIVQUI",50,0)
 ; If quick code has schedule, no admin times, use ward times
"RTN","PSIVQUI",51,0)
 I PSIVAT="",PSIVQZ]"",$G(X)'="" D
"RTN","PSIVQUI",52,0)
 .S PSIVXW=$S($G(WSCHADM):WSCHADM,$G(VAIN(4)):+VAIN(4),1:"") Q:'PSIVXW
"RTN","PSIVQUI",53,0)
 .S ZZ=0 F  S ZZ=$O(^PS(51.1,"AC","PSJ",X,ZZ)) Q:'ZZ!PSIVSIEN  D  Q:PSIVSIEN
"RTN","PSIVQUI",54,0)
 ..N PSIVXAT S PSIVXAT=$P(^PS(51.1,ZZ,0),"^",2) Q:PSIVXAT=""
"RTN","PSIVQUI",55,0)
 ..S PSIVWAT=$P($G(^PS(51.1,ZZ,1,+PSIVXW,0)),"^",2)
"RTN","PSIVQUI",56,0)
 ..I PSIVWAT]"" S PSIVAT=PSIVWAT,PSIVSIEN=ZZ
"RTN","PSIVQUI",57,0)
 ;
"RTN","PSIVQUI",58,0)
 ; No ward times; go back to IV additive. If quick code has schedule,
"RTN","PSIVQUI",59,0)
 ; make sure it matches IV additive
"RTN","PSIVQUI",60,0)
 I PSIVAT="",PSIVAAT]"",PSIVWAT="",$G(X) D
"RTN","PSIVQUI",61,0)
 .S ZZ=0 F  S ZZ=$O(^PS(51.1,"AC","PSJ",X,ZZ)) Q:'ZZ!PSIVSIEN  D  Q:PSIVSIEN
"RTN","PSIVQUI",62,0)
 ..N PSIVXAT S PSIVXAT=$P(^PS(51.1,ZZ,0),"^",2) Q:PSIVXAT=""
"RTN","PSIVQUI",63,0)
 ..I (PSIVQZ=X&(PSIVQZ=PSIVSZ))!(PSIVQZ=""&(PSIVSZ]"")) I PSIVXAT=PSIVAAT D  Q
"RTN","PSIVQUI",64,0)
 ...S PSIVAT=PSIVAAT,PSIVSIEN=ZZ
"RTN","PSIVQUI",65,0)
 .I PSIVAT="" S PSIVAT=PSIVAAT,$P(PSIVX0,"^",6)=PSIVAAT,$P(PSIVX0,"^",5)=X,PSIVSIEN=-1
"RTN","PSIVQUI",66,0)
 I $G(PSIVSIEN) S Y=$S(PSIVSIEN>0:PSIVSIEN,1:"") N PSGOES S PSGOES=1
"RTN","PSIVQUI",67,0)
 I X="" S (Y,PSIVQUIY)=""
"RTN","PSIVQUI",68,0)
 S PSIVSPQF=1 D EN^PSIVSP K PSIVSPQF
"RTN","PSIVQUI",69,0)
 S P(11)=$S($G(PSGS0Y)]"":PSGS0Y,$P(PSIVX0,"^",6)]"":$P(PSIVX0,"^",6),(PSIVQZ]""&(PSIVWAT]"")):PSIVWAT,PSIVAAT]"":PSIVAAT,$G(P(11))]"":$G(P(11)),1:PSIVAT)
"RTN","PSIVQUI",70,0)
 S X=$P(PSIVX0,"^",3)
"RTN","PSIVQUI",71,0)
 I $P(PSIVX0,U,8) D
"RTN","PSIVQUI",72,0)
 .S P("MR")=+$P(PSIVX0,U,8)_U_$S($P($G(^PS(51.2,+$P(PSIVX0,U,8),0)),U,3):$P($G(^PS(51.2,+$P(PSIVX0,U,8),0)),U,3),1:$E($P($G(^PS(51.2,+$P(PSIVX0,U,8),0)),U),1,5))
"RTN","PSIVQUI",73,0)
 W " ",X D ENI^PSIVSP I '$D(X) W $C(7),"  --> Invalid infusion rate !!" I '$$SCHREQ^PSJLIVFD(.P) S P(15)=0
"RTN","PSIVQUI",74,0)
 I $$SCHREQ^PSJLIVFD(.P),'$$DOW^PSIVUTL($G(P(9))),'(P(15)>0) S P(15)=$$INTERVAL^PSIVUTL(.P)
"RTN","PSIVQUI",75,0)
 S PSIVOK="57^58^59^3^26^39^63^64^"_$S($E(P("OT"))="I":"101^109^",1:"")_"10^25^1"
"RTN","PSIVQUI",76,0)
 S P(17)="A",P(8)=$S($D(X):X,1:""),PSIVE=0,PSIVSTR="QUICK CODE",(DRG(2),Y)="",EDIT=$S(+P("MR"):"",1:"3^")_$P(EDIT,"64^",2) K ND,PSIVX0,PSIVSC,PSIVX
"RTN","PSIVQUI",77,0)
 Q
"RTN","PSIVSP")
0^28^B44907043
"RTN","PSIVSP",1,0)
PSIVSP ;BIR/RGY,PR,CML3 - DOSE PROCESSOR ;1/3/12 3:36pm
"RTN","PSIVSP",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**30,37,41,50,56,74,83,111,133,138,134,213,229,279,305,331,256**;16 DEC 97;Build 34
"RTN","PSIVSP",3,0)
 ;
"RTN","PSIVSP",4,0)
 ; Reference to ^PS(51.1 is supported by DBIA #2177
"RTN","PSIVSP",5,0)
 ;
"RTN","PSIVSP",6,0)
EN ;
"RTN","PSIVSP",7,0)
 NEW PSJORGX
"RTN","PSIVSP",8,0)
 Q:'$D(X)
"RTN","PSIVSP",9,0)
 S ATZERO=0 I X["@",$P(X,"@",2)=0 S ATZERO=1,X=$P(X,"@")
"RTN","PSIVSP",10,0)
 ;D EN^PSGS0 S (P(9),PSIVSC1)=$S($G(X)]"":X,1:$G(P(9))),P(11)=$S($G(PSGS0Y):PSGS0Y,1:$G(P(11))),(XT,P(15))=$S(($G(PSGS0XT)!($G(PSGS0XT)="O")!($G(PSGS0XT)="D")):$G(PSGS0XT),1:$G(P(15)))
"RTN","PSIVSP",11,0)
 ;PSJ*5*256 - not set P(9) when FN order so the Old schedule name is not auto replaced with .01 value
"RTN","PSIVSP",12,0)
 S PSJORGX=X
"RTN","PSIVSP",13,0)
 D EN^PSGS0 S:$S($G(PSJOCFG)="FN IV":0,(($G(X)]"")&($G(X)'=PSJORGX)):1,$G(PSJOCFG)="":0,1:1) P(9)=$S($G(X)]"":X,1:$G(P(9)))
"RTN","PSIVSP",14,0)
 S P(11)=$S($G(PSGS0Y):PSGS0Y,1:$G(P(11))),(XT,P(15))=$S(($G(PSGS0XT)!($G(PSGS0XT)="O")!($G(PSGS0XT)="D")):$G(PSGS0XT),1:$G(P(15)))
"RTN","PSIVSP",15,0)
 I $G(ATZERO) S P(7)=1
"RTN","PSIVSP",16,0)
 K ATZERO Q
"RTN","PSIVSP",17,0)
EN1 ;
"RTN","PSIVSP",18,0)
 S (PSIVAT,PSIVWAT,Y)="",XT=-1,X0=X,X=$S(X="ON CALL":X,X="ONCALL":X,X="ON-CALL":X,X="ONETIME":X,X="ONE-TIME":X,X="ONE TIME":X,X="1TIME":X,X="1 TIME":X,X="1-TIME":X,$L(X," ")<3:$P(X," "),1:$P(X," ",1,2))
"RTN","PSIVSP",19,0)
 S:$E(X)="^" X=$E(X,2,999) G:X="" Q S:(X["@0")&($$SCHREQ^PSJLIVFD(.P)) ATZERO=1 S X=$S(X["@0":$P(X,"@"),1:X),P(7)=$S($G(ATZERO):1,1:"") K ATZERO
"RTN","PSIVSP",20,0)
 I $S($D(^PS(51.1,"AC","PSJ",X)):1,1:$E($O(^(X)),1,$L(X))=X) D DIC I Y'<0 G SH
"RTN","PSIVSP",21,0)
NS0 S Y=""
"RTN","PSIVSP",22,0)
 I $E(X,1,2)="AD" S XT=-1 Q
"RTN","PSIVSP",23,0)
 I $E(X,1,3)="BID"!($E(X,1,3)="TID")!($E(X,1,3)="QID") S XT=1440\$F("BTQ",$E(X))
"RTN","PSIVSP",24,0)
 E  S:$E(X)="Q" X=$E(X,2,99) S:'X X=$E(X)["O"+1_X S I=+X,X=$P(X,I,2),XT=I*$S(X["'":1,(X["D"&(X'["AD"))!(X["AM")!(X["PM")!(X["HS"&(X'["THS")):1440,X["H"&(X'["TH"):60,X["AC"!(X["PC"):480,X["W":10080,X["M":40320,1:0),X=X0 D 
"RTN","PSIVSP",25,0)
 . I 'XT,X'="NOW",X'="STAT",X'="ONCE",X'="ONE-TIME",X'="ONE TIME",X'="ONETIME",X'="1-TIME",X'="1 TIME",X'="1TIME",Y="" S XT=-1
"RTN","PSIVSP",26,0)
SH ;
"RTN","PSIVSP",27,0)
 I +Y<1,$E(X0)'="^" W:$G(ON)'["P" "  ",$S(XT=0&($S("^NOW^STAT^ONCE^ONE-TIME^ONETIME^1TIME^1-TIME^"[(U_$P(X," ")_U):1,X["1 TIME":1,1:X["ONE TIME")):"(ONCE ONLY)",XT>0:"Nonstandard schedule",XT<0:"",1:"(??)") W:XT>0 " (",XT," MINUTES)"
"RTN","PSIVSP",28,0)
Q Q:X="ONE TIME"
"RTN","PSIVSP",29,0)
 N I S X0=$P(X," ")_$S($L(X0," ")-1:" ",1:"")_$P(X0," ",2,99) K:XT<0!($L(X0)>22) X S:$D(X) X=X0 K X0 S:$G(P(7)) XT="" Q
"RTN","PSIVSP",30,0)
NEWQ ;N I S X0=$P(X," ")_$S($L(X0," ")-1:" ",1:"")_$P(X0," ",2,99) K:XT<0!($L(X0)>22) X S:$D(X) X=X0 S:P(7) X=X0 K X0 K:XT>0&('P(7)) X Q
"RTN","PSIVSP",31,0)
 Q
"RTN","PSIVSP",32,0)
 ;
"RTN","PSIVSP",33,0)
 ;*229 Add Temp val for dose limit in IOE
"RTN","PSIVSP",34,0)
ENDL N PSIVLIMT W "   Dose limit ....  " S PSIVLIMT="a"_X,PSIVMIN=P(15)*X,PSIVSD=+P(2)
"RTN","PSIVSP",35,0)
 I PSIVMIN<0 W !!," --- There is something wrong with this order !!",!,"     Call inpatient supervisor ....." S Y=-1 K PSIVMIN Q
"RTN","PSIVSP",36,0)
 I P(15)'["D",P(4)="P"!(P(5))!(P(23)="P"),PSIVMIN=0,"^NOW^STAT^ONCE^ONE-TIME^ONE TIME^ON CALL^ONETIME^1TIME^1 TIME^1-TIME^"'[(U_P(9)_U) D DLP G QDL
"RTN","PSIVSP",37,0)
 ;*229 DOW Calc and dose lim should match CPRS, if it's vol limit, we leave old functionality
"RTN","PSIVSP",38,0)
 I $G(P(9))]"",$G(P(11))]"" D ENSTOP^PSIVCAL S Y=X I 1 ;*229 ENSTOP^PSIVCAL returns X, we wanted Y.
"RTN","PSIVSP",39,0)
 E  D ENT^PSIVWL
"RTN","PSIVSP",40,0)
QDL I $D(X) S X=Y X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2) S Y=X
"RTN","PSIVSP",41,0)
 Q
"RTN","PSIVSP",42,0)
DLP ;
"RTN","PSIVSP",43,0)
 S X=X+1,$P(PSIVSD,".",2)=$P(PSIVSD,".",2)_$E("0000",1,4-$L($P(PSIVSD,".",2))) D CHK S X2=0,Y=1 I X<2 S Y=+PSIVSD G QDLP
"RTN","PSIVSP",44,0)
 I $P(PSIVSD,".",2)>$P(P(11),"-",$L(P(11),"-")) S X2=1 G OV
"RTN","PSIVSP",45,0)
 G:$P(P(11),"-")>$P(PSIVSD,".",2) OV
"RTN","PSIVSP",46,0)
 F Y=1:1 S X1=$P(P(11),"-",Y) I X1=$P(PSIVSD,".",2)!($P(PSIVSD,".",2)<X1) Q
"RTN","PSIVSP",47,0)
OV I P(11)="" W $C(7)," ???",!?15,"*** You have not defined any administration times !!" K X Q
"RTN","PSIVSP",48,0)
 F Y=Y:1 S:$P(P(11),"-",Y)="" X2=X2+1,Y=0,X=X+1 S X=X-1 Q:X<1
"RTN","PSIVSP",49,0)
 S X=PSIVSD\1 I X2>0 S X1=PSIVSD D C^%DTC S X=$P(X,".") ; install with version 17.3 of fileman
"RTN","PSIVSP",50,0)
 S Y=+(X_"."_$P(P(11),"-",Y))
"RTN","PSIVSP",51,0)
QDLP K X1,X2 Q
"RTN","PSIVSP",52,0)
 ;
"RTN","PSIVSP",53,0)
ENI ;
"RTN","PSIVSP",54,0)
 N PSIZEROX S PSIZEROX=0_+X
"RTN","PSIVSP",55,0)
 K:$L(X)<1!($L(X)>30)!(X["""")!($A(X)=45) X I '$D(X)!'$D(P(4)) Q
"RTN","PSIVSP",56,0)
 ;*229 Reset ATZERO flag.
"RTN","PSIVSP",57,0)
 I $P(X,"@",2)'=0!'$$SCHREQ^PSJLIVFD(.P) S P(7)=""
"RTN","PSIVSP",58,0)
 I P(4)="P"!(P(5))!(P(23)="P") Q:'X  S X="INFUSE OVER "_X_" MINUTE"_$S(X>1:"S",1:"") W "   ",X Q
"RTN","PSIVSP",59,0)
 I $E(X)="." K X Q  ;Enforce leading zero.
"RTN","PSIVSP",60,0)
 I X'=+X!(X'=0_+X),X["@",($P(X,"@",2,999)'=+$P(X,"@",2,999)!(+$P(X,"@",2,999)<0)) K X Q
"RTN","PSIVSP",61,0)
 S SPSOL=$O(DRG("SOL",0)) I 'SPSOL K SPSOL,X W "  You must define at least one solution !!" Q
"RTN","PSIVSP",62,0)
 I (X=+X)!(X=PSIZEROX) I X'["@" S X=X_" ml/hr" W " ml/hr" D SPSOL S P(15)=$S('X:0,1:SPSOL\X*60+(SPSOL#X/X*60+.5)\1) K SPSOL Q
"RTN","PSIVSP",63,0)
 S SPSOL=$S(($P(X,"@",2)?1.N):$P(X,"@",2),1:$G(P("NUMLBL"))) I SPSOL S P("NUMLBL")=+SPSOL
"RTN","PSIVSP",64,0)
 S:$P(X,"@")=+X!($P(X,"@")=PSIZEROX) $P(X,"@")=$P(X,"@")_" ml/hr" W "   ",+SPSOL," Label",$S(SPSOL'=1:"s",1:"")," per day",!?15,"at an infusion rate of: ",$P(X,"@") S P(15)=$S('SPSOL:0,1:1440/SPSOL\1) K SPSOL
"RTN","PSIVSP",65,0)
 I X["@",$P(X,"@",2)=0,$$SCHREQ^PSJLIVFD(.P) S P(7)=1  ; Set ATZERO flag
"RTN","PSIVSP",66,0)
 ;*305
"RTN","PSIVSP",67,0)
 I '$G(PSJEXMSG) D EXPINF^PSIVEDT1(.X)
"RTN","PSIVSP",68,0)
 Q
"RTN","PSIVSP",69,0)
SPSOL S SPSOL=0 F XXX=0:0 S XXX=$O(DRG("SOL",XXX)) Q:'XXX  S SPSOL=SPSOL+$P(DRG("SOL",XXX),U,3)
"RTN","PSIVSP",70,0)
 K XXX Q
"RTN","PSIVSP",71,0)
CHK F Y=1:1 Q:$L(P(11))>240!($P(P(11),"-",Y)="")  S $P(P(11),"-",Y)=$P(P(11),"-",Y)_$E("0000",1,4-$L($P(P(11),"-",Y)))
"RTN","PSIVSP",72,0)
 Q
"RTN","PSIVSP",73,0)
 ;
"RTN","PSIVSP",74,0)
DIC ; 51.1 look-up
"RTN","PSIVSP",75,0)
 N PSJSCH S PSJSCH=X I '$D(WSCHADM) N VAIP D IN5^VADPT S WSCHADM=VAIP(5),X=PSJSCH
"RTN","PSIVSP",76,0)
 K DIC S DIC="^PS(51.1,",DIC(0)=$E("E",'$D(NOECH))_"ISZ"
"RTN","PSIVSP",77,0)
 S DIC("W")="W ""  "","_$S('$D(WSCHADM):"$P(^(0),""^"",2)",'+WSCHADM:"$P(^(0),""^"",2)",1:"$S($D(^PS(51.1,+Y,1,+WSCHADM,0)):$P(^(0),""^"",2),1:$P(^PS(51.1,+Y,0),""^"",2))"),D="APPSJ" S:$D(PSIVSPQF) DIC(0)=DIC(0)_"O"
"RTN","PSIVSP",78,0)
 D IX^DIC K DIC
"RTN","PSIVSP",79,0)
 S:$D(DIE)#2 DIC=DIE Q:Y<0
"RTN","PSIVSP",80,0)
 S X=Y(0,0),ZZY=Y,(XT,Y)="" I $D(WSCHADM),$D(^PS(51.1,+ZZY,1,+WSCHADM,0)),$P(^(0),"^",2)]"" S (PSIVWAT,Y)=$P(^(0),"^",2)
"RTN","PSIVSP",81,0)
 K ZZY,WSCHADM S:Y="" (X,PSIVSC1)=$P(Y(0),U),(PSIVAT,Y)=$P(Y(0),"^",2) S XT=$P(Y(0),"^",3) Q
"RTN","PSIVSP",82,0)
 ;
"RTN","PSIVSP",83,0)
ORINF ;  OERR input transform for Infusion Rate
"RTN","PSIVSP",84,0)
 ;  X=data
"RTN","PSIVSP",85,0)
 N INFUSE
"RTN","PSIVSP",86,0)
 K:$L(X)<1!($L(X)>30)!(X["""")!($A(X)=45) X I '$D(X) Q
"RTN","PSIVSP",87,0)
 I X?.E1L.E S INFUSE=$$ENLU^PSGMI(X) Q:(INFUSE="TITRATE")!(INFUSE="BOLUS")!($P(INFUSE," ")="INFUSE")!($P(INFUSE," ")="Infuse")
"RTN","PSIVSP",88,0)
 Q:(X="TITRATE")!(X="BOLUS")!($P(X," ")="INFUSE")!($P(X," ")="Infuse")
"RTN","PSIVSP",89,0)
 I X["=" D  Q   ; NOIS LOU-0501-42191
"RTN","PSIVSP",90,0)
 .N X2,X1 S X1=$P(X,"="),X2=$P(X,"=",2)
"RTN","PSIVSP",91,0)
 .I X1["ML/HR",(+X1=$P(X1,"ML/HR"))!(+X1=$P(X1," ML/HR")) D
"RTN","PSIVSP",92,0)
 ..S X1=$TR(X1,"ML/HR","ml/hr")
"RTN","PSIVSP",93,0)
 .I X2["ML/HR",(+X2=$P(X2,"ML/HR"))!(+X2=$P(X2," ML/HR")) D
"RTN","PSIVSP",94,0)
 ..S X2=$TR(X2,"ML/HR","ml/hr")
"RTN","PSIVSP",95,0)
 .I X1[" ml/hr",(+X1=$P(X1," ml/hr")) D
"RTN","PSIVSP",96,0)
 ..S X1=$P(X1," ml/hr")_$P(X1," ml/hr",2,9999)
"RTN","PSIVSP",97,0)
 .I X2[" ml/hr",(+X2=$P(X2," ml/hr")) D
"RTN","PSIVSP",98,0)
 ..S X2=$P(X2," ml/hr")_$P(X2," ml/hr",2,9999)
"RTN","PSIVSP",99,0)
 .I X1["ml/hr",(+X1=$P(X1,"ml/hr")) D
"RTN","PSIVSP",100,0)
 ..S X1=$P(X1,"ml/hr")_$P(X1,"ml/hr",2,9999)
"RTN","PSIVSP",101,0)
 .I X2["ml/hr",(+X2=$P(X2,"ml/hr")) D
"RTN","PSIVSP",102,0)
 ..S X2=$P(X2,"ml/hr")_$P(X2,"ml/hr",2,9999)
"RTN","PSIVSP",103,0)
 .I X2'=+X2 D
"RTN","PSIVSP",104,0)
 ..I X2>0&(X2<1) Q
"RTN","PSIVSP",105,0)
 ..I ($P(X2,"@",2,999)'=+$P(X2,"@",2,999)!(+$P(X2,"@",2,999)<0)) K X Q
"RTN","PSIVSP",106,0)
 .I X1>0&(X1<1) I +X1="."_$P(X1,".",2) S X1=X1_" ml/hr"
"RTN","PSIVSP",107,0)
 .I X2>0&(X2<1) I +X2="."_$P(X2,".",2) S X2=X2_" ml/hr"
"RTN","PSIVSP",108,0)
 .I X1=+X1 S X1=X1_" ml/hr"
"RTN","PSIVSP",109,0)
 .I X2=+X2 S X2=X2_" ml/hr"
"RTN","PSIVSP",110,0)
 .S:$P(X2,"@")=+X2 $P(X2,"@")=$P(X2,"@")_" ml/hr"
"RTN","PSIVSP",111,0)
 .S X=X1_"="_X2
"RTN","PSIVSP",112,0)
 I X["ML/HR",(+X=$P(X,"ML/HR"))!(+X=$P(X," ML/HR")) S X=$TR(X,"ML/HR","ml/hr")
"RTN","PSIVSP",113,0)
 I X[" ml/hr",+X=$P(X," ml/hr") S X=$P(X," ml/hr")_$P(X," ml/hr",2,9999)
"RTN","PSIVSP",114,0)
 I X["ml/hr",+X=$P(X,"ml/hr") S X=$P(X,"ml/hr")_$P(X,"ml/hr",2,9999)
"RTN","PSIVSP",115,0)
 I X>0,X<1 D  Q
"RTN","PSIVSP",116,0)
 .I X["ML/HR",(+X=$P($P(X,"ML/HR"),".",2))!(+X=$P($P(X," ML/HR"),".",2)) S X=$TR(X,"ML/HR","ml/hr")
"RTN","PSIVSP",117,0)
 .I X[" ml/hr",(+X=$P($P(X," ml/hr"),".",2)) S X=$P(X," ml/hr")_$P(X," ml/hr",2,9999)
"RTN","PSIVSP",118,0)
 .I X["ml/hr",+X=$P(X,"ml/hr") S X=$P(X,"ml/hr")_$P(X,"ml/hr",2,9999)
"RTN","PSIVSP",119,0)
 .I +X=X S X=X_" ml/hr"
"RTN","PSIVSP",120,0)
 .I $P(X,0,2)=+X S X=X_" ml/hr"
"RTN","PSIVSP",121,0)
 .S X=0_+X_$P(X,+X,2)
"RTN","PSIVSP",122,0)
 I '(X>0&X<1) I X'=+X,($P(X,"@",2,999)'=+$P(X,"@",2,999)!(+$P(X,"@",2,999)<0)) K X Q
"RTN","PSIVSP",123,0)
 I X=+X S X=X_" ml/hr" Q
"RTN","PSIVSP",124,0)
 S:$P(X,"@")=+X $P(X,"@")=$P(X,"@")_" ml/hr"
"RTN","PSIVSP",125,0)
 Q
"RTN","PSJAPIDS")
0^3^B34167201
"RTN","PSJAPIDS",1,0)
PSJAPIDS ;BIR/MV - API TO PROCESS DOSING ORDER CHECKS FOR IV ;6 Jun 07 / 3:37 PM
"RTN","PSJAPIDS",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,252,256**;16 DEC 97;Build 34
"RTN","PSJAPIDS",3,0)
 ;
"RTN","PSJAPIDS",4,0)
 ; Reference to ^PSDRUG is supported by DBIA #2192.
"RTN","PSJAPIDS",5,0)
 ; Reference to ^PS(51.1 is supported by DBIA# 2177.
"RTN","PSJAPIDS",6,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231.
"RTN","PSJAPIDS",7,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173.
"RTN","PSJAPIDS",8,0)
 ; Reference to ^PSSDSAPI is supported by DBIA# 5425.
"RTN","PSJAPIDS",9,0)
 ; Reference to DRT^PSSDSAPD is supported by DBIA# 5617.
"RTN","PSJAPIDS",10,0)
 ; Reference to DOSE^PSSDSAPD is supported by DBIA# 5426.
"RTN","PSJAPIDS",11,0)
 ; Reference to IN^PSSHRQ2 is supported by DBIA# 5369.
"RTN","PSJAPIDS",12,0)
 ;
"RTN","PSJAPIDS",13,0)
DOSE(PSJBASE,DFN,PSJIV) ;
"RTN","PSJAPIDS",14,0)
 ;PSJBASE(1)=PSJBASE - Base1(Literal value for TMP global)- Required
"RTN","PSJAPIDS",15,0)
 ;PSJBASE(2)=PSJBASE1 - Base2(Literal value for Screened display TMP global)- Required
"RTN","PSJAPIDS",16,0)
 ;PSJDFN - Patient Internal Entry Number
"RTN","PSJAPIDS",17,0)
 ;PSJIV(Px) - See DBIA #5385...P4 can be "ALL", "See Comments", or bottle number(s)
"RTN","PSJAPIDS",18,0)
 ;PSJIV("TVOL_VOL") - Contains nUnit where n is # & Unit is either H,D,L,M, or DOSES
"RTN","PSJAPIDS",19,0)
 ;PSJIV(X,"OI_ERROR",OI Name) - OI ien ^ Pharm # ^ Enhance flag(use in ENHFLG sub routine)
"RTN","PSJAPIDS",20,0)
 NEW DRG,P,PSIVAS,PSIVNM,PSJDD,PSJFDB,PSJOCDS,PSIVTDUR,PSJTOTVL,X
"RTN","PSJAPIDS",21,0)
 I $$PING()=-1 D  Q
"RTN","PSJAPIDS",22,0)
 . F X=0:0 S X=$O(PSJBASE(X)) Q:'X  D
"RTN","PSJAPIDS",23,0)
 .. M ^TMP($J,PSJBASE(X),"OUT")=^TMP($J,"PSJPRE","OUT")
"RTN","PSJAPIDS",24,0)
 Q:$G(PSJIV("IV_TYPE"))=""
"RTN","PSJAPIDS",25,0)
 Q:'+$G(DFN)
"RTN","PSJAPIDS",26,0)
 S PSJTOTVL=0
"RTN","PSJAPIDS",27,0)
 F X=0:0 S X=$O(PSJBASE(X)) Q:'X  K:PSJBASE(X)]"" ^TMP($J,PSJBASE(1))
"RTN","PSJAPIDS",28,0)
 S P("DTYP")=+PSJIV("IV_TYPE")
"RTN","PSJAPIDS",29,0)
 S P("MR")=$G(PSJIV("MR_IEN"))
"RTN","PSJAPIDS",30,0)
 S P(8)=$G(PSJIV("INF_RATE"))
"RTN","PSJAPIDS",31,0)
 S P(9)=$G(PSJIV("SCHEDULE"))
"RTN","PSJAPIDS",32,0)
 ;Admin times and Freq are not available from CPRS
"RTN","PSJAPIDS",33,0)
 S P(11)=""
"RTN","PSJAPIDS",34,0)
 S P(15)=""
"RTN","PSJAPIDS",35,0)
 D SETDRG
"RTN","PSJAPIDS",36,0)
 S PSJIV("DUR")="",PSJIV("TOT_VOL")=""
"RTN","PSJAPIDS",37,0)
 I PSJIV("TVOL_DUR")]"" D
"RTN","PSJAPIDS",38,0)
 . S PSIVTDUR=$$UP^XLFSTR(PSJIV("TVOL_DUR"))
"RTN","PSJAPIDS",39,0)
 . I PSIVTDUR["M" S PSJIV("TOT_VOL")=+PSIVTDUR
"RTN","PSJAPIDS",40,0)
 . I PSIVTDUR["L" S PSJIV("TOT_VOL")=+PSIVTDUR*1000,PSIVTDUR=PSJIV("TOT_VOL")_"M"
"RTN","PSJAPIDS",41,0)
 . ;get dose count for intermittent
"RTN","PSJAPIDS",42,0)
 . I P("DTYP")=1 D DURATION(PSIVTDUR,P(9)) Q
"RTN","PSJAPIDS",43,0)
 . ;Convert PSJIV("DUR") to minutes
"RTN","PSJAPIDS",44,0)
 . I P("DTYP")=2,$S(PSIVTDUR["H":1,PSIVTDUR["D":1,1:0) S PSJIV("DUR")=$$DRT^PSSDSAPD(PSIVTDUR)
"RTN","PSJAPIDS",45,0)
 D IN^PSIVOCDS(PSJBASE(1))
"RTN","PSJAPIDS",46,0)
 D ENHFLG
"RTN","PSJAPIDS",47,0)
 S PSJOCDS("CONTEXT")="CPRS-IV-"_$S($G(PSJIV("IV_TYPE"))=1:"I",1:"C")
"RTN","PSJAPIDS",48,0)
 I $$CHKDS() S PSJFDB("PACKAGE")="I" D DOSE^PSSDSAPD(.PSJBASE,DFN,.PSJOCDS,.PSJFDB)
"RTN","PSJAPIDS",49,0)
 K ^TMP($J,"PSJPRE")
"RTN","PSJAPIDS",50,0)
 Q
"RTN","PSJAPIDS",51,0)
CHKDS() ;Check if dosing check should be performed
"RTN","PSJAPIDS",52,0)
 ;PSJFLG=1 means dosing check should be performed
"RTN","PSJAPIDS",53,0)
 NEW PSJX,PSJFLG
"RTN","PSJAPIDS",54,0)
 I $G(PSJFDB(1,"ENH"))=0 Q 1
"RTN","PSJAPIDS",55,0)
 S PSJFLG=0
"RTN","PSJAPIDS",56,0)
 F PSJX=0:0 S PSJX=$O(PSJFDB(PSJX)) Q:'PSJX  Q:PSJFLG  D
"RTN","PSJAPIDS",57,0)
 . I '$D(PSJFDB(PSJX,"OI_ERROR")) S PSJFLG=1 Q
"RTN","PSJAPIDS",58,0)
 . I +$G(PSJFDB(PSJX,"OI")),$$SETENH(1,+PSJFDB(PSJX,"OI")) S PSJFLG=1
"RTN","PSJAPIDS",59,0)
 Q PSJFLG
"RTN","PSJAPIDS",60,0)
SETDRG ;
"RTN","PSJAPIDS",61,0)
 NEW PSIVX,PSIVX0,PSJDD,PSGDT,PSJCNT,%
"RTN","PSJAPIDS",62,0)
 D NOW^%DTC S PSGDT=%
"RTN","PSJAPIDS",63,0)
 F PSIVAS="AD","SOL" S PSJCNT=0 F PSIVX=0:0 S PSIVX=$O(PSJIV(PSIVAS,PSIVX)) Q:'PSIVX  D
"RTN","PSJAPIDS",64,0)
 .S PSIVX0=$G(PSJIV(PSIVAS,PSIVX))
"RTN","PSJAPIDS",65,0)
 .D:PSIVAS="AD" SETAD(+PSIVX0,$P(PSIVX0,U,2),$P(PSIVX0,U,5))
"RTN","PSJAPIDS",66,0)
 .D:PSIVAS="SOL" SETSOL(+PSIVX0,$P(PSIVX0,U,2),$P(PSIVX0,U,5))
"RTN","PSJAPIDS",67,0)
 Q
"RTN","PSJAPIDS",68,0)
SETAD(PSJOI,PSJOINM,PSJFLG) ;Check if additive is active then set the DRG array
"RTN","PSJAPIDS",69,0)
 ;PSJOI - 50.7 ien
"RTN","PSJAPIDS",70,0)
 ;PSJOINM - CPRS OI name
"RTN","PSJAPIDS",71,0)
 ;PSJFLG - 1 if the Enhanced order checks were done.  0 if not.
"RTN","PSJAPIDS",72,0)
 ;PSJADDD - 50 ien ^ 52.6 ien or null
"RTN","PSJAPIDS",73,0)
 Q:'+$G(PSJOI)
"RTN","PSJAPIDS",74,0)
 Q:'$D(PSIVX0)
"RTN","PSJAPIDS",75,0)
 NEW PSJADDD,PSIVIEN
"RTN","PSJAPIDS",76,0)
 S PSJADDD=$$ADDD^PSJMISC(PSJOI)
"RTN","PSJAPIDS",77,0)
 I PSJADDD="" S PSJIV("OI_ERROR",$S($G(PSJOINM)]"":PSJOINM,1:"NOT FOUND"))=4_U_PSJOI_U_1 Q
"RTN","PSJAPIDS",78,0)
 S PSIVIEN=$P(PSJADDD,U,2)
"RTN","PSJAPIDS",79,0)
 S PSJCNT=$G(PSJCNT)+1
"RTN","PSJAPIDS",80,0)
 S DRG("AD",PSJCNT)=PSIVIEN_U_$P(PSIVX0,U,2)_U_$P(PSIVX0,U,3)_U_$S($P(PSIVX0,U,4)]"":$P(PSIVX0,U,4),1:"")
"RTN","PSJAPIDS",81,0)
 S PSJIV("DRG",+PSJADDD)=+$G(PSJFLG)
"RTN","PSJAPIDS",82,0)
 Q
"RTN","PSJAPIDS",83,0)
SETSOL(PSJOI,PSJOINM,PSJFLG) ;Check if solution is active then set then DRG array
"RTN","PSJAPIDS",84,0)
 ;PSJOI - 50.7 ien
"RTN","PSJAPIDS",85,0)
 ;PSJOINM - CPRS OI name
"RTN","PSJAPIDS",86,0)
 ;PSJFLG - 1 if the Enhanced order checks were done.  0 if not.
"RTN","PSJAPIDS",87,0)
 ;PSJSOLDD - 50 ien ^ 52.7 ien or null
"RTN","PSJAPIDS",88,0)
 Q:'+$G(PSJOI)
"RTN","PSJAPIDS",89,0)
 Q:'$D(PSIVX0)
"RTN","PSJAPIDS",90,0)
 NEW PSJSOLDD,PSIVIEN
"RTN","PSJAPIDS",91,0)
 S PSJSOLDD=$$SOLDD^PSJMISC(PSJOI,+$P(PSIVX0,U,3))
"RTN","PSJAPIDS",92,0)
 I PSJSOLDD="" S PSJIV("OI_ERROR",$S($G(PSJOINM)]"":PSJOINM,1:"NOT FOUND"))=4_U_PSJOI_U_1 Q
"RTN","PSJAPIDS",93,0)
 S PSIVIEN=$P(PSJSOLDD,U,2)
"RTN","PSJAPIDS",94,0)
 S PSJCNT=$G(PSJCNT)+1
"RTN","PSJAPIDS",95,0)
 S DRG("SOL",PSJCNT)=PSIVIEN_U_$P(PSIVX0,U,2)_U_$P(PSIVX0,U,3)
"RTN","PSJAPIDS",96,0)
 S PSJIV("DRG",+PSJSOLDD)=+$G(PSJFLG)
"RTN","PSJAPIDS",97,0)
 S PSJTOTVL=$G(PSJTOTVL)+(+$P(PSIVX0,U,3))
"RTN","PSJAPIDS",98,0)
 Q
"RTN","PSJAPIDS",99,0)
SETENH(PSJFLG,PSJOI) ;Reset PSJFLG to 0 only if GCN message is needed for the dosing check
"RTN","PSJAPIDS",100,0)
 NEW PSJDD,PSJDDFLG
"RTN","PSJAPIDS",101,0)
 I '+$D(PSJFLG) Q 0
"RTN","PSJAPIDS",102,0)
 I PSJFLG=0 Q 0
"RTN","PSJAPIDS",103,0)
 I '+$G(PSJOI) Q PSJFLG
"RTN","PSJAPIDS",104,0)
 ;If PSJFLG=1 (CPRS did DI & DT) then check if no GCN for any of the DDs tie to OI then reset PSJFLG=0 to signal PDM
"RTN","PSJAPIDS",105,0)
 ; to get the check done for the OI error.
"RTN","PSJAPIDS",106,0)
 S PSJDDFLG=0
"RTN","PSJAPIDS",107,0)
 F PSJDD=0:0 S PSJDD=$O(^PSDRUG("ASP",PSJOI,PSJDD)) Q:'PSJDD  Q:PSJDDFLG  D
"RTN","PSJAPIDS",108,0)
 . I +$$GCN^PSJMISC(PSJDD) S PSJDDFLG=1 Q
"RTN","PSJAPIDS",109,0)
 Q PSJDDFLG
"RTN","PSJAPIDS",110,0)
ENHFLG ;Set the enhance flag so dosing error message won't display if enhance OC already displayed.
"RTN","PSJAPIDS",111,0)
 NEW PSJX,PSJOINM
"RTN","PSJAPIDS",112,0)
 F PSJX=0:0 S PSJX=$O(PSJFDB(PSJX)) Q:'PSJX  D
"RTN","PSJAPIDS",113,0)
 . ;If "OI_ERROR" existed than set the "ENH" flag for that PSJX set
"RTN","PSJAPIDS",114,0)
 . S PSJOINM=$O(PSJFDB(PSJX,"OI_ERROR",""))
"RTN","PSJAPIDS",115,0)
 . I PSJOINM]"" D  Q
"RTN","PSJAPIDS",116,0)
 .. S PSJFDB(PSJX,"ENH")=$P($G(PSJIV("OI_ERROR",PSJOINM)),U,3)
"RTN","PSJAPIDS",117,0)
 . I '$D(PSJFDB(PSJX,"DRUG_IEN")) Q
"RTN","PSJAPIDS",118,0)
 . S PSJFDB(PSJX,"ENH")=+$G(PSJIV("DRG",+PSJFDB(PSJX,"DRUG_IEN")))
"RTN","PSJAPIDS",119,0)
 Q
"RTN","PSJAPIDS",120,0)
DURATION(PSJDUR,PSJSCH) ;Figure out date dose limit send by CPRS
"RTN","PSJAPIDS",121,0)
 ;Set PSJIV("DOSE_CNT") only for duration < 24 hrs & set PSJIV("DUR") to # minutes specified in the duration field
"RTN","PSJAPIDS",122,0)
 NEW PSJDOW,PSJCNT,PSJDUR1,PSJCNT1,PSJCNTP1,PSJCNTP2
"RTN","PSJAPIDS",123,0)
 I $G(PSJDUR)="" Q
"RTN","PSJAPIDS",124,0)
 I $G(PSJSCH)="" Q
"RTN","PSJAPIDS",125,0)
 S PSJDUR1=0,PSJCNT1=""
"RTN","PSJAPIDS",126,0)
 S PSJDOW=$$DOW(PSJSCH)
"RTN","PSJAPIDS",127,0)
 ; PSJDUR1 - Duration in minutes (#_M)
"RTN","PSJAPIDS",128,0)
 I $S(PSJDUR["DOSES":0,PSJDUR["H":1,PSJDUR["D":1,1:0) S PSJDUR1=$$DRT^PSSDSAPD(PSJDUR)_"M" S PSJIV("DUR")=+PSJDUR1
"RTN","PSJAPIDS",129,0)
 ;
"RTN","PSJAPIDS",130,0)
 S PSJCNT=$$FRQ^PSSDSAPI(PSJSCH,PSJDOW,"I",PSJDUR1,$G(PSJDD))
"RTN","PSJAPIDS",131,0)
 ; PSJCNT1 - Dose count from Duration
"RTN","PSJAPIDS",132,0)
 I PSJDUR["DOSES" D
"RTN","PSJAPIDS",133,0)
 . S PSJCNT1=+PSJDUR
"RTN","PSJAPIDS",134,0)
 . S PSJCNTP1=$P(PSJCNT,U),PSJCNTP2=$P(PSJCNT,U,2)
"RTN","PSJAPIDS",135,0)
 . I '+PSJCNT D
"RTN","PSJAPIDS",136,0)
 .. I PSJCNTP2?1"Q"1N.N1"H" S PSJCNTP1=$J((24/+$P(PSJCNTP2,"Q",2))+.5,0,0)
"RTN","PSJAPIDS",137,0)
 .. I PSJCNTP2?1"X"1N.N1"D" S PSJCNTP1=+$P(PSJCNTP2,"X",2)
"RTN","PSJAPIDS",138,0)
 . I PSJDUR<PSJCNTP1 S $P(PSJCNT,U,1)=PSJCNTP1
"RTN","PSJAPIDS",139,0)
 I PSJDUR["M" D
"RTN","PSJAPIDS",140,0)
 . I '+$G(PSJTOTVL) S PSJIV("FRQ_ERROR")="" Q
"RTN","PSJAPIDS",141,0)
 . I +PSJDUR>(PSJTOTVL*(+$P(PSJCNT,U,2))) S PSJIV("DUR")=""
"RTN","PSJAPIDS",142,0)
 . S PSJCNT1=(+PSJDUR)/PSJTOTVL
"RTN","PSJAPIDS",143,0)
 ; Set dose count to the less between Duration or schedule
"RTN","PSJAPIDS",144,0)
 I PSJCNT1,(PSJCNT1<+PSJCNT) D
"RTN","PSJAPIDS",145,0)
 . I PSJCNT1'=$J(PSJCNT1,"",0) S PSJIV("FRQ_ERROR")="" Q
"RTN","PSJAPIDS",146,0)
 . S PSJIV("DOSE_CNT")=PSJCNT1
"RTN","PSJAPIDS",147,0)
 . S:+$P(PSJCNT,U,2) PSJIV("DUR")=(1440/$P(PSJCNT,U,2))*PSJCNT1
"RTN","PSJAPIDS",148,0)
 ; Set dose count for duration in day/hour
"RTN","PSJAPIDS",149,0)
 I +PSJDUR1,($P(PSJCNT,U)<$P(PSJCNT,U,2)) S PSJIV("DOSE_CNT")=+PSJCNT
"RTN","PSJAPIDS",150,0)
 Q
"RTN","PSJAPIDS",151,0)
DOW(PSJSCH) ;Check if Schedule is a date of week
"RTN","PSJAPIDS",152,0)
 ;Return "D" if date of week
"RTN","PSJAPIDS",153,0)
 NEW PSJSCHNO,PSJDOW,PSJFOUND
"RTN","PSJAPIDS",154,0)
 I $G(PSJSCH)="" Q ""
"RTN","PSJAPIDS",155,0)
 S PSJDOW=0,PSJFOUND=0
"RTN","PSJAPIDS",156,0)
 F PSJSCHNO=0:0 S PSJSCHNO=$O(^PS(51.1,"APPSJ",PSJSCH,PSJSCHNO)) Q:'PSJSCHNO!(PSJDOW)  D
"RTN","PSJAPIDS",157,0)
 .I $P($G(^PS(51.1,PSJSCHNO,0)),"^",5)="D" S PSJDOW=1
"RTN","PSJAPIDS",158,0)
 .I $D(^PS(51.1,PSJSCHNO,0)) S PSJFOUND=1
"RTN","PSJAPIDS",159,0)
 I PSJDOW Q "D"
"RTN","PSJAPIDS",160,0)
 I PSJFOUND Q ""
"RTN","PSJAPIDS",161,0)
 I PSJSCH["@" Q "D"
"RTN","PSJAPIDS",162,0)
 Q ""
"RTN","PSJAPIDS",163,0)
PING() ;Return -1 if the system is down.
"RTN","PSJAPIDS",164,0)
 S ^TMP($J,"PSJPRE","IN","PING")=""
"RTN","PSJAPIDS",165,0)
 D IN^PSSHRQ2("PSJPRE")
"RTN","PSJAPIDS",166,0)
 Q +$G(^TMP($J,"PSJPRE","OUT",0))
"RTN","PSJCLOR2")
0^23^B129355642
"RTN","PSJCLOR2",1,0)
PSJCLOR2 ;BIR/JCH - BUILD CLINIC ORDER LM HEADERS ; 2/28/12 9:11am
"RTN","PSJCLOR2",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**275,279,315,256**;16 DEC 97;Build 34
"RTN","PSJCLOR2",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSJCLOR2",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSJCLOR2",5,0)
 ; Reference to CWAD^ORQPT2 is supported by DBIA 2831
"RTN","PSJCLOR2",6,0)
 ; Reference to ^SC( is supported by DBIA 10040
"RTN","PSJCLOR2",7,0)
 ; Reference to BSA^PSSDSAPI supported by DBIA #5425
"RTN","PSJCLOR2",8,0)
 ; Reference to LS^PSSLOCK supported by DBIA #2789
"RTN","PSJCLOR2",9,0)
 ; Reference to UNL^PSSLOCK supported by DBIA #2789
"RTN","PSJCLOR2",10,0)
 ;
"RTN","PSJCLOR2",11,0)
HDR(DFN) ; -- list screen header
"RTN","PSJCLOR2",12,0)
 ;   input:       DFN := ifn of pat
"RTN","PSJCLOR2",13,0)
 ;  output:  VALMHDR() := hdr array
"RTN","PSJCLOR2",14,0)
 ;
"RTN","PSJCLOR2",15,0)
 K VAIN,VADM,GMRA,PSJACNWP,PSJ,VAERR,VA,X
"RTN","PSJCLOR2",16,0)
 S PSJACNWP=1 D ENBOTH^PSJAC
"RTN","PSJCLOR2",17,0)
 D HDRO(DFN)
"RTN","PSJCLOR2",18,0)
 S PSJ="   Sex: "_$P(PSJPSEX,U,2),VALMHDR(4)=$$SETSTR^VALM1($S(PSJPDD:"Last ",1:"     ")_"Admitted: "_$P($G(PSJPAD),U,2),PSJ,45,23)
"RTN","PSJCLOR2",19,0)
 S PSJ="    Dx: "_$G(PSJPDX)
"RTN","PSJCLOR2",20,0)
 S:PSJPDD VALMHDR(5)=$$SETSTR^VALM1("Discharged: "_$E($P(PSJPDD,U,2),1,8),PSJ,48,26)
"RTN","PSJCLOR2",21,0)
 S:'PSJPDD VALMHDR(5)=$$SETSTR^VALM1("Last transferred: "_$$ENDTC^PSGMI(PSJPTD),PSJ,42,26)
"RTN","PSJCLOR2",22,0)
 ;
"RTN","PSJCLOR2",23,0)
 ;  Display CrCl/BSA - show serum creatinine if CrCl can't be calculated
"RTN","PSJCLOR2",24,0)
 S PSJBSA=$$BSA^PSSDSAPI(DFN),PSJBSA=$P(PSJBSA,"^",3),PSJBSA=$S(PSJBSA'>0:"__________",1:$J(PSJBSA,4,2))
"RTN","PSJCLOR2",25,0)
 ; RSLT -- DATE^CRCL^Serum Creatinine -- Ex.  11/25/11^68.7^1.1
"RTN","PSJCLOR2",26,0)
 S RSLT=$$CRCL^PSJLMHED(DFN)
"RTN","PSJCLOR2",27,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)<.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_" (CREAT: Not Found)"
"RTN","PSJCLOR2",28,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"  (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSJCLOR2",29,0)
 I ($P($G(RSLT),"^",2)>0)&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"(est.)"_" (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSJCLOR2",30,0)
 S PSJDB=$G(ZDSPL),VALMHDR(6)=$$SETSTR^VALM1("BSA (m2): "_$G(PSJBSA),PSJDB,50,23) K PSJBSA,ZDSPL,RSLT
"RTN","PSJCLOR2",31,0)
 Q
"RTN","PSJCLOR2",32,0)
 ;
"RTN","PSJCLOR2",33,0)
HDRO(DFN) ; Standardized part of profile header.
"RTN","PSJCLOR2",34,0)
 N PSJCLIN,PSJAPPT,PSJCLINN,RMORDT S (PSJCLIN,PSJAPPT)=0,(RMORDT,PSJCLINN)="" I $G(PSJORD) D
"RTN","PSJCLOR2",35,0)
 . S PSJCLIN=$S($G(PSJORD)["V":$G(^PS(55,DFN,"IV",+PSJORD,"DSS")),$G(PSJORD)["U":$G(^PS(55,DFN,5,+PSJORD,8)),$G(PSJORD)["P":$G(^PS(53.1,+PSJORD,"DSS")),1:"")
"RTN","PSJCLOR2",36,0)
 . S:PSJCLIN PSJAPPT=$P($G(PSJCLIN),U,2) I PSJCLIN,PSJAPPT S PSJCLINN=$P($G(^SC(+PSJCLIN,0)),U)
"RTN","PSJCLOR2",37,0)
 K VALMHDR I PSJCLINN]"" S PSJ=VADM(1),PSJ=$$SETSTR^VALM1("   Clinic: "_PSJCLINN,PSJ,28,26)
"RTN","PSJCLOR2",38,0)
 I PSJCLINN="" S PSJ=VADM(1),PSJ=$$SETSTR^VALM1($S('PSJPDD:"     ",1:"Last ")_"Ward: "_PSJPWDN,PSJ,30,18)
"RTN","PSJCLOR2",39,0)
 S X=$$CWAD^ORQPT2(DFN)
"RTN","PSJCLOR2",40,0)
 S:X]"" X=$G(IORVON)_X_$G(IORVOFF),PSJ=$$SETSTR^VALM1(X,PSJ,80-$L(X),80) S VALMHDR(1)=PSJ
"RTN","PSJCLOR2",41,0)
 S PSJ="   PID: "_$P(PSJPSSN,U,2)
"RTN","PSJCLOR2",42,0)
 S RMORDT=$S($G(PSJPDD):"Last ",1:"     ")_"Room-Bed: "_$G(PSJPRB)
"RTN","PSJCLOR2",43,0)
 I PSJCLINN]"",PSJAPPT S RMORDT="Clinic Date: "_$$ENDTC^PSGMI(PSJAPPT),RMORDT=$P(RMORDT,"  ")_" "_$P(RMORDT,"  ",2)
"RTN","PSJCLOR2",44,0)
 S PSJ=$$SETSTR^VALM1(RMORDT,PSJ,26,28),VALMHDR(2)=$$SETSTR^VALM1("Ht(cm): "_PSJPHT_" "_PSJPHTD,PSJ,55,25)
"RTN","PSJCLOR2",45,0)
 S PSJ="   DOB: "_$P($P(PSJPDOB,U,2)," ")_" ("_PSJPAGE_")",VALMHDR(3)=$$SETSTR^VALM1("Wt(kg): "_PSJPWT_" "_PSJPWTD,PSJ,55,25)
"RTN","PSJCLOR2",46,0)
 Q
"RTN","PSJCLOR2",47,0)
 ;
"RTN","PSJCLOR2",48,0)
INIT(PSJPROT) ; -- init bld vars
"RTN","PSJCLOR2",49,0)
 ; PSJPROT=1:UD ONLY; 2:IV ONLY; 3:BOTH
"RTN","PSJCLOR2",50,0)
 K PSJUDPRF,^TMP("PSJ",$J),^TMP("PSJON",$J),^TMP("PSJPRO",$J),^TMP("PSJCLOR",$J) D FULL^VALM1
"RTN","PSJCLOR2",51,0)
 N TMPCLIN,DFN,UDU S PSJVALQ=0,TMPCLIN="",DFN=PSGP,PSGSSAV=PSGSS,UDU=$S($P(PSJSYSU,";",3)>1:3,1:1)
"RTN","PSJCLOR2",52,0)
 S:PSJPROT=1 PSJUDPRF=1
"RTN","PSJCLOR2",53,0)
 D KILL^VALM10(),EN^PSJCLOR3(PSJPROT)
"RTN","PSJCLOR2",54,0)
 I '$D(^TMP("PSJ",$J)) W !!,?22,"NO CLINIC ORDERS FOUND." S VALMQUIT=1,PSJVALQ=1 D PAUSE^PSJLMUTL Q
"RTN","PSJCLOR2",55,0)
 S PSJLN=1,PSJEN=1 S PSJCLIN="" F  S PSJCLIN=$O(^TMP("PSJ",$J,PSJCLIN)) Q:PSJCLIN=""  S PSJTF=0,PSJC="" F  S PSJC=$O(^TMP("PSJ",$J,PSJCLIN,PSJC)) Q:PSJC=""  D
"RTN","PSJCLOR2",56,0)
 .N PSJF S PSJF="^PS("_$S("AO"[PSJC:"55,"_PSGP_",5,",PSJC="DF":"55,"_PSGP_",5,",1:"53.1,")
"RTN","PSJCLOR2",57,0)
 .I TMPCLIN'=PSJCLIN D TF S PSJTF=$E(PSJC,1),TMPCLIN=PSJCLIN    ;DAM 8-29-07 Added Q:PSJC="CB"  Q:PSJC="O"
"RTN","PSJCLOR2",58,0)
 .S PSJST="" F  S PSJST=$O(^TMP("PSJ",$J,PSJCLIN,PSJC,PSJST)) Q:PSJST=""  D
"RTN","PSJCLOR2",59,0)
 ..S PSJS="" F  S PSJS=$O(^TMP("PSJ",$J,PSJCLIN,PSJC,PSJST,PSJS)) Q:PSJS=""  Q:PSJC="CB"  Q:PSJC="O"  Q:PSJC="DF"  D ON      ;DAM 8-29-07  Added Q:PSJC="CB"  Q:PSJC="O"
"RTN","PSJCLOR2",60,0)
 .;
"RTN","PSJCLOR2",61,0)
 .;DAM 8-29-07   New code to place Pending Orders after Pending Renewal Orders on the roll and scroll display.  Non-Active Orders appear last.
"RTN","PSJCLOR2",62,0)
 S PSJCLIN="" F  S PSJCLIN=$O(^TMP("PSJ",$J,PSJCLIN)) Q:PSJCLIN=""  S PSJTF=0,PSJC="" F  S PSJC=$O(^TMP("PSJ",$J,PSJCLIN,PSJC)) Q:PSJC=""  D
"RTN","PSJCLOR2",63,0)
 . N PSJF S PSJF="^PS("_$S("AO"[PSJC:"55,"_PSGP_",5,",PSJC="DF":"55,"_PSGP_",5,",1:"53.1,")
"RTN","PSJCLOR2",64,0)
 . I PSJC="CB" I TMPCLIN'=PSJCLIN D TF S PSJTF=$E(PSJC,1),TMPCLIN=PSJCLIN                            ;These are Pending Orders
"RTN","PSJCLOR2",65,0)
 . I PSJC="CB" S PSJST="" F  S PSJST=$O(^TMP("PSJ",$J,PSJCLIN,PSJC,PSJST)) Q:PSJST=""  D
"RTN","PSJCLOR2",66,0)
 . . S PSJS="" F  S PSJS=$O(^TMP("PSJ",$J,PSJCLIN,PSJC,PSJST,PSJS)) Q:PSJS=""   D ON
"RTN","PSJCLOR2",67,0)
 . I PSJC="DF" I TMPCLIN'=PSJCLIN D TF S PSJTF=$E(PSJC,1),TMPCLIN=PSJCLIN                              ;These are recently DC Orders (mv)
"RTN","PSJCLOR2",68,0)
 . I PSJC="DF" S PSJST="" F  S PSJST=$O(^TMP("PSJ",$J,PSJCLIN,PSJC,PSJST)) Q:PSJST=""  D
"RTN","PSJCLOR2",69,0)
 . . S PSJS="" F  S PSJS=$O(^TMP("PSJ",$J,PSJCLIN,PSJC,PSJST,PSJS)) Q:PSJS=""   D ON
"RTN","PSJCLOR2",70,0)
 . I PSJC="O" I TMPCLIN'=PSJCLIN D TF S PSJTF=$E(PSJC,1),TMPCLIN=PSJCLIN                              ;These are Non-Active Orders
"RTN","PSJCLOR2",71,0)
 . I PSJC="O" S PSJST="" F  S PSJST=$O(^TMP("PSJ",$J,PSJCLIN,PSJC,PSJST)) Q:PSJST=""  D
"RTN","PSJCLOR2",72,0)
 . . S PSJS="" F  S PSJS=$O(^TMP("PSJ",$J,PSJCLIN,PSJC,PSJST,PSJS)) Q:PSJS=""   D ON
"RTN","PSJCLOR2",73,0)
 .; END DAM changes
"RTN","PSJCLOR2",74,0)
 .;
"RTN","PSJCLOR2",75,0)
 S VALMCNT=PSJLN-1
"RTN","PSJCLOR2",76,0)
DONE ;
"RTN","PSJCLOR2",77,0)
 K ^TMP("PSJCLOR",$J) M ^TMP("PSJCLOR",$J)=^TMP("PSJON",$J)
"RTN","PSJCLOR2",78,0)
 K PSJC,PSJEN,PSJLN,PSJST,PSJS,CNT,PSJPRI,^TMP("PSJ",$J),PSGSSAV,PSJDCEXP,PSJL,PSJON,PSJOS,PSJTF
"RTN","PSJCLOR2",79,0)
 Q
"RTN","PSJCLOR2",80,0)
ON ; Set order number into ^TMP
"RTN","PSJCLOR2",81,0)
 N PSJCLORD S PSJCLORD=1
"RTN","PSJCLOR2",82,0)
 S PSJSCHT=$S(PSJOS:PSJS,1:PSJST)
"RTN","PSJCLOR2",83,0)
 S PSJO="" F FQ=0:0 S PSJO=$O(^TMP("PSJ",$J,PSJCLIN,PSJC,PSJST,PSJS,PSJO)) Q:PSJO=""  S DN=^(PSJO) D
"RTN","PSJCLOR2",84,0)
 .N PRJPRI S PSJPRI=$S(PSJO["V":$P($G(^PS(55,PSGP,"IV",+PSJO,.2)),"^",4),PSJO["U":$P($G(^PS(55,PSGP,5,+PSJO,.2)),"^",4),1:$P($G(^PS(53.1,+PSJO,.2)),"^",4))
"RTN","PSJCLOR2",85,0)
 .S ^TMP("PSJON",$J,PSJEN)=PSJO,PSJL=$J(PSJEN,4) D @$S(PSJO["V":"PIV^PSJLMPRI(PSGP,PSJO,PSJF,DN)",PSJO["U":"PUD^PSJLMPRU(PSGP,PSJO,PSJF,DN)",1:"PIV^PSJLMPRI(PSGP,PSJO,PSJF,DN)") S ^TMP("PSJPRO",$J,0)=PSJEN,PSJEN=PSJEN+1
"RTN","PSJCLOR2",86,0)
 .S ^TMP("PSJON",$J)=+$O(^TMP("PSJON",$J,""),-1)
"RTN","PSJCLOR2",87,0)
 K DN,FQ,PSJSCHT
"RTN","PSJCLOR2",88,0)
 Q
"RTN","PSJCLOR2",89,0)
TF ; Set up order type header
"RTN","PSJCLOR2",90,0)
 NEW PSJDFHDR
"RTN","PSJCLOR2",91,0)
 I $D(^TMP("PSJ",$J,PSJCLIN)) D
"RTN","PSJCLOR2",92,0)
 .S PSJDCEXP=$$RECDCEXP^PSJP()
"RTN","PSJCLOR2",93,0)
 .S PSJDFHDR="RECENTLY DISCONTINUED/EXPIRED (LAST "_+$G(PSJDCEXP)_" HOURS)"
"RTN","PSJCLOR2",94,0)
 .N C,X,Y S C=PSJC,Y="",$P(Y," -",40)=""
"RTN","PSJCLOR2",95,0)
 .S X=PSJCLIN
"RTN","PSJCLOR2",96,0)
 .I $G(PSJCLIN)]"" S X=PSJCLIN
"RTN","PSJCLOR2",97,0)
 .S ^TMP("PSJPRO",$J,PSJLN,0)=$E($E(Y,1,(80-$L(X))/2)_" "_X_$E(Y,1,(80-$L(X))/2),1,80),PSJLN=PSJLN+1
"RTN","PSJCLOR2",98,0)
 Q
"RTN","PSJCLOR2",99,0)
TEST ; Headers
"RTN","PSJCLOR2",100,0)
 N X,Y S Y="",$P(Y," -",40)=""
"RTN","PSJCLOR2",101,0)
 F X="A C T I V E","P E N D I N G   R E N E W A L S","P E N D I N G ","N O N - V E R I F I E D","N O N - A C T I V E" W !,$E($E(Y,1,(80-$L(X))/2)_" "_X_$E(Y,1,(80-$L(X))/2),1,80)
"RTN","PSJCLOR2",102,0)
 Q
"RTN","PSJCLOR2",103,0)
VWDETAIL(PSGP) ;
"RTN","PSJCLOR2",104,0)
 N VAIN,VADM,PSJLM,PSGPRF,PSJPRP,PSJSYSL,DFN D ENCV^PSGSETU
"RTN","PSJCLOR2",105,0)
 S DFN=PSGP D ^PSJAC D INIT^PSJCLOR2(3)
"RTN","PSJCLOR2",106,0)
 S PSGPRF="",PSJPRP="P",PSJPR=0,PSJON=+$G(^TMP("PSJON",$J)) D FULL^VALM1,ENVW
"RTN","PSJCLOR2",107,0)
 D DONEVD
"RTN","PSJCLOR2",108,0)
 Q
"RTN","PSJCLOR2",109,0)
ENVW ; ask user to select or view any of the orders shown
"RTN","PSJCLOR2",110,0)
 S (PSGONC,PSGONR,PSGONV)=0,PSGLMT=PSJON S:$D(PSJPRF) PSGPRF=1
"RTN","PSJCLOR2",111,0)
 N PSJXDIR S PSJXDIR=$P($G(XQORNOD(0)),"=",2) I PSJXDIR S X=$E(PSJXDIR,1,$L(PSJXDIR)-1) D ENCHK^PSGON
"RTN","PSJCLOR2",112,0)
 I '$G(PSJXDIR) D ENASR^PSGON
"RTN","PSJCLOR2",113,0)
 K PSGPRF
"RTN","PSJCLOR2",114,0)
 G:X["^" DONEVD I X]"" S PSGOEA=""
"RTN","PSJCLOR2",115,0)
 K PSJDLW
"RTN","PSJCLOR2",116,0)
 I  F PSJOE=1:1:PSGODDD S PSGOE=PSJOE F PSJOE1=1:1:$L(PSGODDD(PSJOE),",")-1 S PSJOE2=$P(PSGODDD(PSJOE),",",PSJOE1),(PSGORD,PSJORD)=^TMP("PSJON",$J,PSJOE2) G:$D(PSJDLW) DONEVD D
"RTN","PSJCLOR2",117,0)
 .I PSJORD=+PSJORD N PSJO,PSJO1 S PSJO=PSJORD,PSJO1=0 F  S PSJO1=$O(^PS(53.1,"ACX",PSJO,PSJO1)) Q:'PSJO1  Q:$D(PSJDLW)  S PSJORD=PSJO1_"P",PSGOEA="" D GODO(PSJORD) S PSJORD=""
"RTN","PSJCLOR2",118,0)
 .Q:PSJORD=""  S PSGOEA="" D GODO(PSJORD)
"RTN","PSJCLOR2",119,0)
 Q
"RTN","PSJCLOR2",120,0)
 ;
"RTN","PSJCLOR2",121,0)
GODO(PSJORD) ; 
"RTN","PSJCLOR2",122,0)
 D GODO^PSJOE0
"RTN","PSJCLOR2",123,0)
 Q
"RTN","PSJCLOR2",124,0)
DONEVD ; Kill variables
"RTN","PSJCLOR2",125,0)
 K DTOUT,PSGONC,PSGONR,PSGONV,PSGODDD,PSGOE,PSGOEA,PSJL,PSJOE,PSJOE1,PSJOE2,PSJON,PSJPR,PSJPRF
"RTN","PSJCLOR2",126,0)
 Q
"RTN","PSJCLOR2",127,0)
 ;
"RTN","PSJCLOR2",128,0)
NEWORDER(PSGP,PSGORD,PSGNWSD,PSGOEAV) ;
"RTN","PSJCLOR2",129,0)
 N PSGSD,PSGOEEF,PSGOFD,PSGNEFD,PSGOSD,PSGFD,PSGAT,PSGFDN S PSGOEEF(10)=1,PSJNOLOK=0
"RTN","PSJCLOR2",130,0)
 K DIR I '$$LS^PSSLOCK(DFN,PSGORD) W !,"NO ACTION TAKEN ON ORDER",! D CONT^PSJOE0 S PSJNOLOK=1 Q
"RTN","PSJCLOR2",131,0)
 I $D(^PS(53.45,+$G(PSJSYSP),5)) N PSJFSI S PSJFSI=1 D FILESI^PSJBCMA5(DFN,PSGORD) N SIARRAY S SIARRAY="" D
"RTN","PSJCLOR2",132,0)
 .I PSGORD["P" M SIARRAY=^PS(53.1,+PSGORD,15) D NEWNVAL^PSGAL5(PSGORD,6000,"SPECIAL INSTRUCTIONS",,.SIARRAY)
"RTN","PSJCLOR2",133,0)
 .I PSGORD["U" M SIARRAY=^PS(55,DFN,5,+PSGORD,15) D NEWUDAL^PSGAL5(DFN,PSGORD,6000,"SPECIAL INSTRUCTIONS",,.SIARRAY)
"RTN","PSJCLOR2",134,0)
 I PSGORD["P" S PSJCOM=+$P($G(^PS(53.1,+PSGORD,.2)),"^",8) I PSJCOM D NEW^PSJCOM1 Q
"RTN","PSJCLOR2",135,0)
 ;
"RTN","PSJCLOR2",136,0)
 I PSGORD["P"!(PSGORD["U") D
"RTN","PSJCLOR2",137,0)
 .N PSGST,PSGSCH,PSGNESD,ND,ND2,ND2P1,PSJEDFLD,I ;*315
"RTN","PSJCLOR2",138,0)
 .F I=0,2 S ND(I)=$S($G(PSGORD)["P":$G(^PS(53.1,+PSGORD,I)),$G(PSGORD)["U":$G(^PS(55,+$G(PSGP),5,+PSGORD,I)),$G(PSJTMPON)["V":$G(^PS(55,+$G(PSGP),"IV",+PSGORD,I)),1:"")
"RTN","PSJCLOR2",139,0)
 .S PSGNESD=PSGNWSD,PSGSCH=$S(PSGORD["P"!(PSGORD["U"):$P(ND(2),"^"),PSGORD["V":$P(ND(0),"^",9),1:"")
"RTN","PSJCLOR2",140,0)
 .S PSGST=$S(PSGORD["P"!(PSGORD["U"):$P(ND(0),"^",7),1:""),(PSGFD,PSGOFD)=$S(PSGORD["V":$P(ND(0),"^",3),1:$P(ND(2),"^",4)),(PSGSD,PSGOSD)=$S(PSGORD["V":$P(ND(0),"^",2),1:$P(ND(2),"^",2))
"RTN","PSJCLOR2",141,0)
 .S PSGNEFD="" D ENFD^PSGNE3(PSGNWSD) S PSGFD=$S($G(PSGRDTX(+PSGORD,"PSGFD")):PSGRDTX(+PSGORD,"PSGFD"),1:PSGNEFD)
"RTN","PSJCLOR2",142,0)
 .I $G(PSGNEFD),(PSGNEFD<PSGNWSD) W $C(7),!?5,"*** THE START DATE CANNOT BE AFTER THE STOP DATE! ***" S PSJQMSG=1 Q
"RTN","PSJCLOR2",143,0)
 .S PSJEDFLD=$S(PSGORD["P":25,1:34) S PSGOEEF(PSJEDFLD)=1
"RTN","PSJCLOR2",144,0)
 ;
"RTN","PSJCLOR2",145,0)
 I PSGORD["U" D  Q
"RTN","PSJCLOR2",146,0)
 .N TMPNEFD S TMPNEFD=$G(PSGNEFD) S PSGOEEWF="^PS(55,"_PSGP_",5,"_+PSGORD_"," S (ND,ND0)=$G(@(PSGOEEWF_"0)")),ND2=$G(^(2)),ND2P1=$G(^(2.1)) ;*315
"RTN","PSJCLOR2",147,0)
 .D EN2^PSGOEEW
"RTN","PSJCLOR2",148,0)
 .S PSGOORD=PSGORD S (PSGNESD,SD,PSGSD)=PSGNWSD I ($G(TMPNEFD)'="") S (PSGNEFD,PSGFD)=TMPNEFD,PSGFDN=$$ENDD^PSGMI(PSGNEFD)_U_$$ENDTC^PSGMI(PSGNEFD)
"RTN","PSJCLOR2",149,0)
 .S PSGOFD=$P(^PS(55,PSGP,5,+PSGORD,2),"^",4),PSGOEENO=1,PSJOCL=+$G(^PS(55,PSGP,5,+PSGORD,8))
"RTN","PSJCLOR2",150,0)
 .W !,"START DATE/TIME: ",$$ENDD^PSGMI(PSGSD) D A34^PSJCLOR4
"RTN","PSJCLOR2",151,0)
 .S PSJNOO=$$ENNOO^PSJUTL5("E") I PSJNOO<0 W "    No changes made to this order!" D CONT^PSJOE0 Q
"RTN","PSJCLOR2",152,0)
 .N PSJOCL,PSGOEENO S PSGOEENO=1,PSJOCL=+$G(^PS(55,PSGP,5,+PSGORD,8))
"RTN","PSJCLOR2",153,0)
 .D NEW^PSGOEE
"RTN","PSJCLOR2",154,0)
 .Q
"RTN","PSJCLOR2",155,0)
 ;
"RTN","PSJCLOR2",156,0)
 I PSGORD["P"  D
"RTN","PSJCLOR2",157,0)
 .N DR,PSJTMPFD,P S DR="10////^S X=PSGSD;" S:$G(PSGOEEF(25)) DR=DR_"25////^S X=PSGFD;" S DR=DR_"W ""."";"
"RTN","PSJCLOR2",158,0)
 .S PSJTMPFD=PSGFD
"RTN","PSJCLOR2",159,0)
 .D GETUD^PSJLMGUD(PSGP,PSGORD) N PSGNESD,PSGPDRG,PSJOCL S PSGPDRG=PSGPD,PSJOCL=+$G(^PS(53.1,+PSGORD,"DSS")) S:$G(PSGOEEF(25)) (PSGNEFD,PSGFD)=PSJTMPFD,PSGFDN=$$ENDD^PSGMI(PSGNEFD)_U_$$ENDTC^PSGMI(PSGNEFD)
"RTN","PSJCLOR2",160,0)
 .Q:'$G(PSJOCL)  S PSGS0Y=PSGAT,(PSGNESD,PSGSD)=PSGNWSD,PSGPDRG=PSGPD,PSGPDRGN=PSGPDN,PSGOEE="E"
"RTN","PSJCLOR2",161,0)
 .W !,"START DATE/TIME: ",$$ENDD^PSGMI(PSGSD) D A25NV^PSJCLOR4
"RTN","PSJCLOR2",162,0)
 .N PSGOEENO S PSGOEENO=0 D UPD^PSGOEE
"RTN","PSJCLOR2",163,0)
 .D EN1^PSJHL2(PSGP,"XX",PSGORD)
"RTN","PSJCLOR2",164,0)
 ;
"RTN","PSJCLOR2",165,0)
 I PSGORD["V" D
"RTN","PSJCLOR2",166,0)
 .N ON55,ND,ND2,ND0,PSIVCHG,PSIVSYSP,P,PSJSTRDF,PSJSTPDF,PSJINIV S PSGOEEWF="^PS(55,"_PSGP_",""IV"","_+PSGORD_",",PSIVCHG=1
"RTN","PSJCLOR2",167,0)
 .I '$G(XQORNOD),$G(PSJTMPXQ) N XQORNOD S XQORNOD=PSJTMPXQ
"RTN","PSJCLOR2",168,0)
 .S XQORNOD(0)="^^E"
"RTN","PSJCLOR2",169,0)
 .S PSJSYSW0=$G(PSJSYSW0) ; Initialize/restore PSJSYSW0 ward parameters. Killed at exit in ENKV^PSGSETU.
"RTN","PSJCLOR2",170,0)
 .I $G(PSGOEAV),'$P(PSJSYSP0,U,9) S PSIVSYSP=PSJSYSP0 N PSJSYSP0 S PSJSYSP0=PSIVSYSP,$P(PSJSYSP0,"^",9)=1
"RTN","PSJCLOR2",171,0)
 .S (ND,ND0)=$G(@(PSGOEEWF_"0)")),ND2=$G(^(2)),ON55=PSGORD
"RTN","PSJCLOR2",172,0)
 .D GT55^PSIVORFB S P(2)=PSGNWSD D ENSTOP^PSIVCAL
"RTN","PSJCLOR2",173,0)
 .W !,"START DATE/TIME: ",$$ENDD^PSGMI(P(2))
"RTN","PSJCLOR2",174,0)
 .D A25V^PSJCLOR4(PSGP,PSGORD)
"RTN","PSJCLOR2",175,0)
 .D NEWORD^PSIVOPT1
"RTN","PSJCLOR2",176,0)
 .S PSJORL=$$ENORL^PSJUTL($G(VAIN(4))) S ON=ON55,OD=P(2) D:ON["V" EN^PSIVORE D EN1^PSJHL2(DFN,"SN",ON55,"NEW ORDER")
"RTN","PSJCLOR2",177,0)
 .N TMPOLD S TMPOLD=$S(ON55["P":$P($G(^PS(53.1,+ON55,0)),"^",25),ON55["V":$P($G(^PS(55,PSGP,"IV",+ON55,2)),"^",5),1:"") I TMPOLD D
"RTN","PSJCLOR2",178,0)
 ..I TMPOLD["V",$D(^PS(55,PSGP,"IV",+TMPOLD,10,1)) N LN S LN=+$O(^PS(55,PSGP,"IV",+TMPOLD,10,""),-1) D
"RTN","PSJCLOR2",179,0)
 ...S:ON55["P" ^PS(53.1,+ON55,16,0)="^53.1136^"_LN_"^"_LN S:ON55["V" ^PS(55,PSGP,"IV",+ON55,10,0)="^55.1154^"_LN_"^"_LN
"RTN","PSJCLOR2",180,0)
 ...S LN=0 F  S LN=$O(^PS(55,PSGP,"IV",+TMPOLD,10,LN)) Q:'LN  S:ON55["P" ^PS(53.1,+ON55,16,LN,0)=^PS(55,PSGP,"IV",+TMPOLD,10,LN,0) S:ON55["V" ^PS(55,PSGP,"IV",+ON55,10,LN,0)=^PS(55,PSGP,"IV",+TMPOLD,10,LN,0)
"RTN","PSJCLOR2",181,0)
 .;
"RTN","PSJCLOR2",182,0)
 I $G(PSJFSI)=1 I $$GETSI^PSJBCMA5(DFN,PSGORD) D FILESI^PSJBCMA5(DFN,$S($G(PSGOORD):PSGOORD,1:PSGORD))
"RTN","PSJCLOR2",183,0)
 I 'PSGOEAV,($G(PSGORD)["P"),'$G(^PS(53.1,+PSGORD,2.5)),$G(^PS(53.1,+PSGORD,0)) D
"RTN","PSJCLOR2",184,0)
 . N DUR S DUR=$$GETDUR^PSJLIVMD(PSGP,PSGORD,$S(PSGORD["P":"P",1:5),1) I DUR]"" K DA,DR,DIE S DIE="^PS(53.1,",DA=+PSGORD,DR="116////"_DUR D ^DIE
"RTN","PSJCLOR2",185,0)
 D NEWCLN^PSJCLOR5
"RTN","PSJCLOR2",186,0)
 D UNL^PSSLOCK(PSGP,PSGORD) I $G(PSGOORD) D UNL^PSSLOCK(PSGP,PSGOORD)
"RTN","PSJCLOR2",187,0)
 Q
"RTN","PSJCLOR2",188,0)
 ;
"RTN","PSJCLOR2",189,0)
DSPORD(PSGP,TMPORDER,PSJORDAR) ; Display order summary
"RTN","PSJCLOR2",190,0)
 D DSPORD^PSJCLOR5(PSGP,TMPORDER,.PSJORDAR)
"RTN","PSJCLOR2",191,0)
 Q
"RTN","PSJCLOR2",192,0)
 ;
"RTN","PSJCLOR2",193,0)
HDRDT ; Header Date Range
"RTN","PSJCLOR2",194,0)
 Q:'$G(PSJBEG)!'($G(PSJEND))  I $G(PSJTMPED),$P(PSJTMPED,"^",2) S PSJEND=$S($P(PSJTMPED,"^",2)'=$G(PSGP):+PSJTMPED,1:+PSJEND)
"RTN","PSJCLOR2",195,0)
 S VALMHDR(6)="          CLINIC ORDERS: "_$$FMTE^XLFDT(+$G(PSJBEG))_" to "_$$FMTE^XLFDT(+$G(PSJEND))
"RTN","PSJCLOR2",196,0)
 Q
"RTN","PSJCLOR2",197,0)
 ;
"RTN","PSJCLOR2",198,0)
CHGDT ; Change date range
"RTN","PSJCLOR2",199,0)
 N TMPBEG,TMPEND S TMPBEG=+PSJBEG,TMPEND=+PSJEND
"RTN","PSJCLOR2",200,0)
 D BEGDT I '$G(PSJBEG) S PSJBEG=+TMPBEG
"RTN","PSJCLOR2",201,0)
 D ENDDT(PSJBEG) I '$G(PSJEND) S PSJEND=+TMPEND
"RTN","PSJCLOR2",202,0)
 D INIT^PSJCLOR2(3) S VALMBCK="R" D HDR^PSJLMHED($S($G(DFN):DFN,1:$G(PSGP))) D HDRDT^PSJCLOR2
"RTN","PSJCLOR2",203,0)
 Q
"RTN","PSJCLOR2",204,0)
BEGDT ; begin date
"RTN","PSJCLOR2",205,0)
 I '$G(PSJTMPBG) S PSJTMPBG=+PSJBEG_"^"_PSGP
"RTN","PSJCLOR2",206,0)
 W !!?5,"Search for CLINIC Medication Orders with a Start Date/Time"
"RTN","PSJCLOR2",207,0)
 W !?5,"within the date range selected below: "
"RTN","PSJCLOR2",208,0)
 W ! K %DT S %DT("A")="Begin Search Date: ",%DT="TAE",%DT("B")=$P($$FMTE^XLFDT(PSJBEG,1),"@")
"RTN","PSJCLOR2",209,0)
 D ^%DT Q:Y<0!($D(DTOUT))  S (%DT(0),PSJBEG)=Y
"RTN","PSJCLOR2",210,0)
 Q
"RTN","PSJCLOR2",211,0)
ENDDT(BEG) ; end date
"RTN","PSJCLOR2",212,0)
 I $G(BEG) S $P(BEG,".",2)=24
"RTN","PSJCLOR2",213,0)
 I '$G(PSJTMPED) S PSJTMPED=+PSJEND_"^"_PSGP
"RTN","PSJCLOR2",214,0)
 W ! K DIR S DIR(0)="DA^"_BEG_"::TAE",DIR("A")="End Search Date: ",DIR("B")=$$FMTE^XLFDT(BEG) D ^DIR
"RTN","PSJCLOR2",215,0)
 S PSJEND=$S($G(Y):Y,1:BEG) I '$P(PSJEND,".",2) S PSJEND=Y_".24"
"RTN","PSJCLOR2",216,0)
 Q
"RTN","PSJHEAD")
0^21^B32768134
"RTN","PSJHEAD",1,0)
PSJHEAD ;BIR/KKA-PROFILE HEADER ; 4/1/08 4:29pm
"RTN","PSJHEAD",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**8,20,85,95,203,260,256**;16 DEC 97;Build 34
"RTN","PSJHEAD",3,0)
 ;
"RTN","PSJHEAD",4,0)
 ; Reference to ^PS(55 supported by DBIA #2191.
"RTN","PSJHEAD",5,0)
 ;External reference to $$BSA^PSSDSAPI supported by DBIA 5425.
"RTN","PSJHEAD",6,0)
 ;
"RTN","PSJHEAD",7,0)
ENTRY(DFN,PSJOPC,PG,PSJNARC,PSJTEAM,PSJY2K)   ;
"RTN","PSJHEAD",8,0)
 ;DFN=patient internal entry number
"RTN","PSJHEAD",9,0)
 ;PSJOPC=a code showing what type of option is printing the header
"RTN","PSJHEAD",10,0)
 ;PG=page number
"RTN","PSJHEAD",11,0)
 ;PSJNARC=code telling whether or not to print narrative
"RTN","PSJHEAD",12,0)
 ;PSJTEAM=code telling whether or not to print team
"RTN","PSJHEAD",13,0)
 ;PSJY2K=code telling whether or not to print 4 digit year
"RTN","PSJHEAD",14,0)
STUFF ;
"RTN","PSJHEAD",15,0)
 N %,ALFLG,GONE,HDT,KKA,LEN,LENCHK,PSGALG,PSGADR,PSGDT,PSGVWA,PSJPAD,PSJPAGE,PSJPDD,PSJPDOB,PSJPDX,PSJPHT,PSJPHTD,PSJPPID,PSJPR,PSJPRB,PSJPSEX,PSJPTD,PSJPWD,PSJPWDN,PSJPWT,PSJWTD,RB,SI,TEAM,WCNT,WRD,X
"RTN","PSJHEAD",16,0)
 ;
"RTN","PSJHEAD",17,0)
 ;PPAGE=the page of the individual we are now printing. This is needed to keep track of how we print the Allergy/ADR info
"RTN","PSJHEAD",18,0)
 ;PSJNEW is set at the top of all options which call this header, if this is the first time the option has called the routine, PSJNEW will exist
"RTN","PSJHEAD",19,0)
 ;
"RTN","PSJHEAD",20,0)
 I $D(PSJNEW) S PSGPTMP=0,PPAGE=1 K PSJNEW
"RTN","PSJHEAD",21,0)
 S PSGP=DFN S:PSGP=$G(PSGPTMP) PPAGE=PPAGE+1 I PSGP'=$G(PSGPTMP) S PSGPTMP=PSGP,PPAGE=1
"RTN","PSJHEAD",22,0)
 D NOW^%DTC S PSGDT=%,HDT=$$ENDTC^PSGMI(PSGDT)
"RTN","PSJHEAD",23,0)
 S VA200=1 D INP^VADPT
"RTN","PSJHEAD",24,0)
 I VAIN(4) S PSJPWD=+VAIN(4),PSJPWDN=$P(VAIN(4),"^",2),(PSJPRB,RB)=VAIN(5),PSJPAD=+VAIN(7),PSJPDX=VAIN(9),PSJPDD="",PSJPTD=$S($D(^PS(55,DFN,5.1)):$P(^(5.1),"^",4),1:"")
"RTN","PSJHEAD",25,0)
 I 'VAIN(4) S VAIP("D")="L" D IN5^VADPT S PSJPWD=+VAIP(5),PSJPWDN=$P(VAIP(5),"^",2),(PSJPRB,RB)=$P(VAIP(6),"^",2),PSJPAD=+VAIP(13,1),PSJPDX=VAIP(9) D
"RTN","PSJHEAD",26,0)
 .S PSGID=+VAIP(3),X=+VAIP(4)=12!(+VAIP(4)=38),PSJPTD="",PSJPDD=PSGID_"^"_$$ENDTC^PSGMI(PSGID) S:X PSJPDD=PSJPDD_"^1"
"RTN","PSJHEAD",27,0)
 D DEM^VADPT,HTWT^PSJAC(DFN)
"RTN","PSJHEAD",28,0)
 S PSGP(0)=VADM(1),PSJPDOB=+VADM(3),PSJPAGE=VADM(4),PSJPSEX=$S(VADM(5)]"":VADM(5),1:"?^____"),PSJPPID=VA("PID")
"RTN","PSJHEAD",29,0)
 F X="PSJPAD","PSJPDOB","PSJPTD" I $G(@X) S $P(@X,"^",2)=$S($D(PSJY2K):$$ENDTC2^PSGMI(+@X),1:$$ENDTC^PSGMI(+@X))
"RTN","PSJHEAD",30,0)
ENHEAD ; print new page, name, ssn, dob, and ward
"RTN","PSJHEAD",31,0)
 I $D(ENGET) S RB=$S($G(PSJPRB)]"":PSJPRB,1:"* NF *")
"RTN","PSJHEAD",32,0)
 S SLS="",$P(SLS," -",15)=""
"RTN","PSJHEAD",33,0)
 ;* I PSJOPC]"" W:$Y @IOF W ! W:PSJOPC="ALL" ?16,"I N P A T I E N T   M E D I C A T I O N S" W:PSJOPC="UD" ?19,"U N I T   D O S E   P R O F I L E" W:PSJOPC="IV" !,?19,"I V  P A T I E N T  P R O F I L E" W ?64,HDT,!,SLS,SLS,$E(SLS,1,24),!
"RTN","PSJHEAD",34,0)
 I PSJOPC]"" D
"RTN","PSJHEAD",35,0)
 . W:$Y @IOF
"RTN","PSJHEAD",36,0)
 . W ! W:PSJOPC="ALL" ?16,"I N P A T I E N T   M E D I C A T I O N S" W:PSJOPC="UD" ?19,"U N I T   D O S E   P R O F I L E" W:PSJOPC="IV" !,?19,"I V  P A T I E N T  P R O F I L E" W ?64,HDT
"RTN","PSJHEAD",37,0)
 . NEW X S X=$$SITE^PSGMMAR2(80)
"RTN","PSJHEAD",38,0)
 . W !?+X,$P(X,U,2),!,SLS,SLS,$E(SLS,1,24),!
"RTN","PSJHEAD",39,0)
 W ?1,$P(PSGP(0),"^"),?34,"  ",$S('PSJPDD:"",$G(PSJIVOF):"",1:"Last "),"Ward: ",$S(PSJPDD&($G(PSJIVOF)):"OUTPATIENT",PSJPWDN]"":PSJPWDN,1:"* NF *") W:$D(PSJPR) ?75-$L(PG),"Pg: ",PG-$D(PSGVWA)
"RTN","PSJHEAD",40,0)
 W !?4,"PID: ",PSJPPID W:'PSJPDD ?26 W:PSJPDD ?21,"Last " W "Room-Bed: ",$S(RB="":"* NF *",1:RB),?53,"Ht(cm): ",?61 W:PSJPHT["_" PSJPHT W:PSJPHT'["_" $J(PSJPHT,6,2) W ?68,PSJPHTD
"RTN","PSJHEAD",41,0)
 W !?4,"DOB: ",$S($D(PSJY2K):$E($P(PSJPDOB,"^",2),1,10),1:$E($P(PSJPDOB,"^",2),1,8))_"  ("_PSJPAGE_")"
"RTN","PSJHEAD",42,0)
 I (PSJTEAM=1)&(RB]"") S TEAM=$S($O(^PS(57.7,"AWRT",$G(PSJPWD),$G(RB),0)):$O(^(0)),1:"") S:TEAM]"" TEAM=$G(^PS(57.7,$G(PSJPWD),1,TEAM,0))
"RTN","PSJHEAD",43,0)
 I $D(TEAM) W ?30,"Team: ",$S(TEAM]"":TEAM,1:"* NF *")
"RTN","PSJHEAD",44,0)
 W ?53,"Wt(kg): ",?61 W:PSJPWT["_" PSJPWT W:PSJPWT'["_" $J(PSJPWT,6,2) W ?68,PSJPWTD
"RTN","PSJHEAD",45,0)
 W !?4,"Sex: ",$P(PSJPSEX,"^",2),?'PSJPDD*5+46,$S(PSJPDD:"Last ",1:""),"Admitted: ",$S($D(PSJY2K):$E($P(PSJPAD,"^",2),1,10),1:$E($P(PSJPAD,"^",2),1,8))
"RTN","PSJHEAD",46,0)
 W !?5,"Dx: ",$S(PSJPDX]"":PSJPDX,1:"* NF *") S X=$S(PSJPDD:PSJPDD,1:$G(PSJPTD)) I X W ?PSJPDD>0*6+43,$S(PSJPDD:"Discharged: ",1:"Last transferred: "),$S($D(PSJY2K):$E($P(X,"^",2),1,10),1:$E($P(X,"^",2),1,8))
"RTN","PSJHEAD",47,0)
 ;
"RTN","PSJHEAD",48,0)
 ; Display CrCl/BSA - show serum creatinine if CrCl can't be calculated
"RTN","PSJHEAD",49,0)
 S PSJBSA=$$BSA^PSSDSAPI(DFN),PSJBSA=$P(PSJBSA,"^",3),PSJBSA=$S(PSJBSA'>0:"_________",1:$J(PSJBSA,4,2))
"RTN","PSJHEAD",50,0)
 S RSLT=$$CRCL^PSJLMHED(DFN)
"RTN","PSJHEAD",51,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)<.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_" (CREAT: Not Found)"
"RTN","PSJHEAD",52,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"  (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSJHEAD",53,0)
 I ($P($G(RSLT),"^",2)>0)&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"(est.)"_" (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSJHEAD",54,0)
 W !?2,ZDSPL,?51,"BSA (m2): ",$G(PSJBSA) K ZDSPL,RSLT,PSJBSA
"RTN","PSJHEAD",55,0)
 ;
"RTN","PSJHEAD",56,0)
 I PSJNARC=1 W !?1,"Pharmacy Narrative: " S WCNT=1,SI=$G(^PS(55,DFN,1)) W:SI=""&($E(IOST)="P") " ____________________" I SI]"" D
"RTN","PSJHEAD",57,0)
 .S LENCHK=0,LEN=$L(SI)
"RTN","PSJHEAD",58,0)
 .F  S WRD=$P(SI," ",WCNT) Q:$L(WRD)=0&(LENCHK'<LEN)  S WCNT=WCNT+1 W:$X+$L(WRD)>79 !,?21 W " ",WRD S LENCHK=LENCHK+$L(WRD)+1
"RTN","PSJHEAD",59,0)
 S PSGP=DFN,ALFLG=0 D ATS^PSJMUTL(68,68,2)
"RTN","PSJHEAD",60,0)
 W !?1,"Allergies: " D:PSGALG+PSGVALG+PSGADR+PSGVADR=0 NONE I PSGALG+PSGVALG+PSGADR+PSGVADR>0 D ALG,ADR I ALFLG D
"RTN","PSJHEAD",61,0)
 .W "See patient's first ",$S($E(IOST)="C":"screen",1:"page")," for Allergies/Adverse Reactions"
"RTN","PSJHEAD",62,0)
 I $D(^PS(55,DFN,5.1)),$P(^(5.1),"^",7) S X=$P(^(5.1),"^",10),X="* ALL "_$S($P(^(5.1),"^",7)=1:"UNIT DOSE ",1:"")_"ORDERS PLACED ON HOLD "_$E("(",X]"")_X_$E(")",X]"")_" *" W $C(7),!!?80-$L(X)\2,X
"RTN","PSJHEAD",63,0)
 Q
"RTN","PSJHEAD",64,0)
NONE ;
"RTN","PSJHEAD",65,0)
 ;W:$E(IOST)="P" "______________________________" W !?7,"ADR: " W:$E(IOST)="P" "____________________________________"
"RTN","PSJHEAD",66,0)
 W "No Allergy Assessment" W !?7,"ADR: " W:$E(IOST)="P" "____________________________________"
"RTN","PSJHEAD",67,0)
 Q
"RTN","PSJHEAD",68,0)
ALG ;
"RTN","PSJHEAD",69,0)
 I PPAGE>1&((PSGALG'<68)!(PSGADR'<63)) S ALFLG=1 Q
"RTN","PSJHEAD",70,0)
 I PSGVALG(1)["NKA",(PSGALG(1)["NKA") S PSGALG(1)=""
"RTN","PSJHEAD",71,0)
 I PSGALG=20,(PSGALG(1)["__________") D
"RTN","PSJHEAD",72,0)
 . I PSGVADR=20,(PSGVADR(1)["__________") S PSGALG(1)="" S:PSGVALG(1)["__________" PSGVALG(1)="No Allergy Assessment"
"RTN","PSJHEAD",73,0)
 S KKA=0 F  S KKA=$O(PSGVALG(KKA)) Q:'KKA  W:KKA>1 !?12 W PSGVALG(KKA)
"RTN","PSJHEAD",74,0)
 I PSGALG(1)]"",(PSGALG(1)'["__________") W !," NV Aller.: " D
"RTN","PSJHEAD",75,0)
 . S KKA=0 F  S KKA=$O(PSGALG(KKA)) Q:'KKA  W:KKA>1 !?12 W PSGALG(KKA)
"RTN","PSJHEAD",76,0)
 Q
"RTN","PSJHEAD",77,0)
ADR ;
"RTN","PSJHEAD",78,0)
 Q:ALFLG
"RTN","PSJHEAD",79,0)
 W !?7,"ADR: "
"RTN","PSJHEAD",80,0)
 I PSGVADR(1)["NKA",(PSGADR(1)["NKA") S PSGADR(1)=""
"RTN","PSJHEAD",81,0)
 I PSGADR=20,(PSGADR(1)["__________") S PSGADR(1)=""
"RTN","PSJHEAD",82,0)
 S KKA=0 F  S KKA=$O(PSGVADR(KKA)) Q:'KKA  W:KKA>1 !?12 W PSGVADR(KKA)
"RTN","PSJHEAD",83,0)
 I PSGADR(1)]"" W !?4,"NV ADR: " D
"RTN","PSJHEAD",84,0)
 . S KKA=0 F  S KKA=$O(PSGADR(KKA)) Q:'KKA  W:KKA>1 !?12 W PSGADR(KKA)
"RTN","PSJHEAD",85,0)
 Q
"RTN","PSJLIACT")
0^7^B58941977
"RTN","PSJLIACT",1,0)
PSJLIACT ;BIR/MV - IV ACTION ;28 Jul 98  8:50 AM
"RTN","PSJLIACT",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**15,47,62,58,82,97,80,110,111,134,181,247,260,275,257,299,281,256**;16 DEC 97;Build 34
"RTN","PSJLIACT",3,0)
 ;
"RTN","PSJLIACT",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJLIACT",5,0)
 ; Reference to MAIN^TIUEDIT is supported by DBIA 2410.
"RTN","PSJLIACT",6,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071.
"RTN","PSJLIACT",7,0)
 ;
"RTN","PSJLIACT",8,0)
DC ; Discontinue order
"RTN","PSJLIACT",9,0)
 K PSGORQF
"RTN","PSJLIACT",10,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",11,0)
 S PSJCOM=+$S(PSJORD["V":$P($G(^PS(55,DFN,"IV",+PSJORD,.2)),"^",8),1:$P($G(^PS(53.1,+PSJORD,.2)),"^",8))
"RTN","PSJLIACT",12,0)
 I PSJCOM W !!,"This order is part of a complex order. If you discontinue this order the",!,"following orders will be discontinued too (unless the stop date has already",!,"been reached)." D CMPLX^PSJCOM1(PSGP,PSJCOM,PSJORD)
"RTN","PSJLIACT",13,0)
 I PSJCOM F  W !!,"Do you want to discontinue this order" S %=1 D YN^DICN Q:%  D ENCOM^PSGOEM
"RTN","PSJLIACT",14,0)
 I PSJCOM,%'=1 S VALMBK="" Q
"RTN","PSJLIACT",15,0)
 I $G(ON55)["P",$G(PSIVOORD) S PSJORD=ON55 ;*247 - Correct DCing newly copied orders
"RTN","PSJLIACT",16,0)
 I PSJORD["V" D DC^PSIVORA D:'$G(PSJOCFLG) EN^PSJLIORD(DFN,ON) Q
"RTN","PSJLIACT",17,0)
 I PSJORD["P" N ON S ON=PSJORD D DISCONT^PSIVORC
"RTN","PSJLIACT",18,0)
 S VALMBCK="Q"
"RTN","PSJLIACT",19,0)
 Q
"RTN","PSJLIACT",20,0)
ACEDIT ; Display LM screen and AC and EDit actions
"RTN","PSJLIACT",21,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",22,0)
 S VALMBCK=$S($G(PSIVACEP):"Q",1:"R")
"RTN","PSJLIACT",23,0)
 Q
"RTN","PSJLIACT",24,0)
AEEXIT ; Call for EXIT CODE in PSJ LM IV AC/EDIT
"RTN","PSJLIACT",25,0)
 I ON["V" K PSGORQF D GT55^PSIVORFB ;RTC 340818
"RTN","PSJLIACT",26,0)
 I ON["P" D GT531^PSIVORFA(DFN,ON) D:P("OT")'="I" GTDATA^PSJLIFN
"RTN","PSJLIACT",27,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",28,0)
 K PSIVENO
"RTN","PSJLIACT",29,0)
 Q
"RTN","PSJLIACT",30,0)
EDIT ; Edit order
"RTN","PSJLIACT",31,0)
 K PSIVFN1
"RTN","PSJLIACT",32,0)
 I $D(PSGACT),PSGACT'["E" W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJLIACT",33,0)
 D EDIT1
"RTN","PSJLIACT",34,0)
 Q:$D(PSIVNBD)!($G(PSIVCOPY)&'$G(PSIVENO))
"RTN","PSJLIACT",35,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",36,0)
 S VALMBCK=$S($G(PSIVFN1):"Q",1:"R")
"RTN","PSJLIACT",37,0)
 I $G(PSGORQF) S VALMBCK="Q" K PSIVENO,PSJOCCHK ;RTC 340818
"RTN","PSJLIACT",38,0)
 Q
"RTN","PSJLIACT",39,0)
EDIT1 ;
"RTN","PSJLIACT",40,0)
 K PSGORQF ;RTC 340818
"RTN","PSJLIACT",41,0)
 ;Ensure P() is defined
"RTN","PSJLIACT",42,0)
 I $D(P)<10 S XQORQUIT=1,P("PON")="",PSIVNBD=1 D  Q
"RTN","PSJLIACT",43,0)
 .W !,"WARNING: An error has occurred. Changes will not be saved"
"RTN","PSJLIACT",44,0)
 .D PAUSE^VALM1
"RTN","PSJLIACT",45,0)
 .S VALMBCK="Q"
"RTN","PSJLIACT",46,0)
 I "ANP"'[P(17) W !,"You cannot edit an inactive order" D PAUSE^VALM1 Q
"RTN","PSJLIACT",47,0)
 S:$G(ON55)="" ON55=$G(PSJORD)
"RTN","PSJLIACT",48,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",49,0)
 N PSIEDITO S PSIEDITO=1
"RTN","PSJLIACT",50,0)
 ;* Edit a new back door order
"RTN","PSJLIACT",51,0)
 I ($G(ON55)["V"&($G(P("21FLG"))="")) D  Q
"RTN","PSJLIACT",52,0)
 . D GSTRING^PSIVORE1,GTFLDS^PSIVORFE
"RTN","PSJLIACT",53,0)
 . I $G(ON55)["V",'$G(DONE) D OK^PSIVORE
"RTN","PSJLIACT",54,0)
 . S VALMBCK="Q",PSIVNBD=1
"RTN","PSJLIACT",55,0)
 ;* Edit an active order
"RTN","PSJLIACT",56,0)
 I $G(ON55)["V" NEW PSJEDIT1 D E^PSIVOPT1 D  Q
"RTN","PSJLIACT",57,0)
 . I $G(PSJIVBD) K PSJIVBD D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",58,0)
 . I $G(PSGORQF) K PSIVENO,PSJOCCHK ;RTC 340818
"RTN","PSJLIACT",59,0)
 I $G(ON55)["P" D EDIT^PSIVORC ;Edit incomplete order.
"RTN","PSJLIACT",60,0)
 K P("OVRIDE")
"RTN","PSJLIACT",61,0)
 Q
"RTN","PSJLIACT",62,0)
ACCEPT ; Accept order
"RTN","PSJLIACT",63,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",64,0)
 ;Accept IV from back door.
"RTN","PSJLIACT",65,0)
 I $G(PSJIVBD) K PSJIVBD D OK^PSIVORE S VALMBCK="Q" Q
"RTN","PSJLIACT",66,0)
 ;D:'$G(PSGORQF) IN^PSJOCDS($G(ON),"IV","") Q:$G(PSGORQF)
"RTN","PSJLIACT",67,0)
 I ON["V" D ACCEPT^PSIVOPT1 S:'$G(PSGORQF) PSJDSVFY=1 Q
"RTN","PSJLIACT",68,0)
 S PSIVFN1=1
"RTN","PSJLIACT",69,0)
 D COMPLTE^PSIVORC1
"RTN","PSJLIACT",70,0)
 K ^TMP("PSODAOC",$J)
"RTN","PSJLIACT",71,0)
 S VALMBCK="Q"
"RTN","PSJLIACT",72,0)
 Q
"RTN","PSJLIACT",73,0)
R ; Renewal
"RTN","PSJLIACT",74,0)
 K PSGORQF,PSJOCCHK,PSIVENO
"RTN","PSJLIACT",75,0)
 S PSJREN=1
"RTN","PSJLIACT",76,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",77,0)
 NEW PSIVAC,PSJOLDNM S PSIVAC="PR" K PSGFDX
"RTN","PSJLIACT",78,0)
 S PSJOLDNM("ORD_SCHD")=$P($G(^PS(55,DFN,"IV",+ON,0)),U,9)
"RTN","PSJLIACT",79,0)
 I PSJOLDNM("ORD_SCHD")]"",$$CHKSCHD^PSJMISC2(.PSJOLDNM,"R") K PSJOLDNM Q
"RTN","PSJLIACT",80,0)
 K PSJOLDNM
"RTN","PSJLIACT",81,0)
 D R^PSIVOPT
"RTN","PSJLIACT",82,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",83,0)
 K PSJREN,^TMP("PSODAOC",$J)
"RTN","PSJLIACT",84,0)
 Q
"RTN","PSJLIACT",85,0)
H ; Hold
"RTN","PSJLIACT",86,0)
 K PSGORQF
"RTN","PSJLIACT",87,0)
 NEW TEX S TEX="Active order ***"
"RTN","PSJLIACT",88,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",89,0)
 D H^PSIVOPT(DFN,ON,P(17),P(3))
"RTN","PSJLIACT",90,0)
 D:P(17)="A" PAUSE^VALM1
"RTN","PSJLIACT",91,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",92,0)
 Q
"RTN","PSJLIACT",93,0)
L ; Activity Log
"RTN","PSJLIACT",94,0)
 NEW PSIVLAB,PSIVLOG,PSJHIS S (PSIVLAB,PSIVLOG)=1
"RTN","PSJLIACT",95,0)
 D EN^PSIVVW1
"RTN","PSJLIACT",96,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",97,0)
 S VALMBCK="R"
"RTN","PSJLIACT",98,0)
 Q
"RTN","PSJLIACT",99,0)
O ; On Call
"RTN","PSJLIACT",100,0)
 K PSGORQF
"RTN","PSJLIACT",101,0)
 NEW TEX S TEX="Active order ***"
"RTN","PSJLIACT",102,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",103,0)
 D O^PSIVOPT(DFN,ON,P(17),P(3))
"RTN","PSJLIACT",104,0)
 D:P(17)="A" PAUSE^VALM1
"RTN","PSJLIACT",105,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",106,0)
 Q
"RTN","PSJLIACT",107,0)
VF ; Make the order active **ENHANCEMENTS MADE IN PSJ*5.0*260
"RTN","PSJLIACT",108,0)
 NEW PSIVCHG,PSGORQF,PSJVFF,PSJOLDNM S PSIVCHG=0
"RTN","PSJLIACT",109,0)
 ;PSJ*5*256 - inform user of old schedule name and quit
"RTN","PSJLIACT",110,0)
 I $S((ON["P"):$P($G(^PS(53.1,+ON,0)),U,24)'="R",(ON["V"):$P($G(^PS(55,+PSGP,"IV",+ON,2)),U,8)'="R",1:0) D  Q:$G(PSGORQF)
"RTN","PSJLIACT",111,0)
 .D FULL^VALM1
"RTN","PSJLIACT",112,0)
 .S PSJOLDNM("ORD_SCHD")=$G(PSGSCH)
"RTN","PSJLIACT",113,0)
 .S PSGORQF=$$CHKSCHD^PSJMISC2(.PSJOLDNM,"V")
"RTN","PSJLIACT",114,0)
 ;IF VALM("TITLE")="ACTIVE IV " W !!,">>>  Verify may not be selected at this point." D PAUSE^VALM1 S VALMBCK="R" Q  ;PSJ*5*281 CCR 6995 Remedy ticket 861870
"RTN","PSJLIACT",115,0)
 ;ELSE  IF $G(PSGSTAT)="NON-VERIFIED",$G(PSJNEWOE)=0 S PSJVFF=1 D EN^PSJGMRA($G(DFN),$G(PSGPD)),IN^PSJOCDS($G(PSGORD),"IV",""),OC^PSIVOC K PSJVFF Q:$G(PSGORQF)
"RTN","PSJLIACT",116,0)
 ;PSGSTAT may not set for IV orders. Checking PSJOCFG so DI,DT is not displayed again for FN, CO, RN...
"RTN","PSJLIACT",117,0)
 IF (($G(PSGSTAT)="NON-VERIFIED")!($G(P(17))="N")&($G(PSJOCFG)="")),'+$G(PSJNEWOE) D
"RTN","PSJLIACT",118,0)
 .S PSJVFF=1 D:'$G(PSJENHOC)&'$G(PSGORQF) OC^PSIVOC D:('$G(PSGORQF)&'$G(PSJDSVFY)) IN^PSJOCDS($G(PSGORD),"IV","") K PSJVFF Q:$G(PSGORQF)
"RTN","PSJLIACT",119,0)
 Q:$G(PSGORQF)
"RTN","PSJLIACT",120,0)
 ELSE  IF '$G(PSGORQF),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",121,0)
 ELSE  IF $G(PSIVFN1),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",122,0)
 ELSE  IF $G(PSGDEF),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",123,0)
 ELSE  IF $G(PSIVCOPY),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",124,0)
 D ACTIVE^PSIVORC2
"RTN","PSJLIACT",125,0)
 Q
"RTN","PSJLIACT",126,0)
VF1(PSIVREA,PSIVAL,PSIVLOG) ;
"RTN","PSJLIACT",127,0)
 ;Update 4 node and set activity log.
"RTN","PSJLIACT",128,0)
 ;PSIVREA: the reason use by LOG^PSIVORAL
"RTN","PSJLIACT",129,0)
 ;PSIVAL : the description reason
"RTN","PSJLIACT",130,0)
 ;PSIVLOG: Log an activity if = 1
"RTN","PSJLIACT",131,0)
 K PSGORQF
"RTN","PSJLIACT",132,0)
 I '+$G(OD)!($L($G(OD))>16) K OD
"RTN","PSJLIACT",133,0)
 D:+PSJSYSU=3 ^PSIVORE1
"RTN","PSJLIACT",134,0)
 NEW DIE,DA,DR,PSJX,XX,PSIVACT,PSJRQND
"RTN","PSJLIACT",135,0)
 S PSIVACT=1
"RTN","PSJLIACT",136,0)
 S PSJX=$G(^PS(55,DFN,"IV",+ON55,4)),XX=""
"RTN","PSJLIACT",137,0)
 I $P(PSJX,U)="" S XX=";143////0"
"RTN","PSJLIACT",138,0)
 I $P(PSJX,U,4)="" S XX=XX_U_";142////0"
"RTN","PSJLIACT",139,0)
 D NOW^%DTC
"RTN","PSJLIACT",140,0)
 S DIE="^PS(55,"_DFN_",""IV"",",DA=+ON55,DA(1)=DFN
"RTN","PSJLIACT",141,0)
 I +PSJSYSU=3 S DR="140////"_DUZ_";141////"_$E(%,1,12)_";142////1"_$P(XX,U)
"RTN","PSJLIACT",142,0)
 I +PSJSYSU=1 S DR="16////"_DUZ_";17////"_$E(%,1,12)_";143////1"_$P(XX,U,2)
"RTN","PSJLIACT",143,0)
 I $G(P("PRY"))="D" S DR=DR_";.22////"_+P("IVRM")
"RTN","PSJLIACT",144,0)
 D ^DIE
"RTN","PSJLIACT",145,0)
 ; If pending IV renew is edited during finish, go back and DE the original active order left in RENEWED status
"RTN","PSJLIACT",146,0)
 S PREREN=$S(ON55["V":$G(@(DIE_"+ON55,2)")),1:""),PREREN=$P(PREREN,"^",5) I PREREN D  K PREREN
"RTN","PSJLIACT",147,0)
 . I PREREN["P" S PREREN=$G(@("^PS(53.1,+PREREN,0)")),PREREN=$P(PREREN,"^",25)
"RTN","PSJLIACT",148,0)
 . I PREREN["V" N PRERENOD S PRERENOD=$G(@("^PS(55,DFN,""IV"",+PREREN,0)")) I $P(PRERENOD,"^",17)="R",($G(P("RES"))="E") D
"RTN","PSJLIACT",149,0)
 ..  S DIE="^PS(55,"_DFN_",""IV"",",DA=+PREREN,DA(1)=DFN
"RTN","PSJLIACT",150,0)
 ..  S DR="100////D;.03////"_PSGDT S ORIGSTOP=$P($G(@("^PS(55,DFN,""IV"",+PREREN,2)")),"^",3) I ORIGSTOP S DR=DR_";116////"_ORIGSTOP
"RTN","PSJLIACT",151,0)
 ..  D ^DIE D EN1^PSJHL2(DFN,"SC",PREREN)
"RTN","PSJLIACT",152,0)
 K DR,DIE,DA
"RTN","PSJLIACT",153,0)
 I (+PSJSYSU=3)&($G(P("PRY"))="D") D
"RTN","PSJLIACT",154,0)
 .N DIR W ! S DIR(0)="S^Y:Yes;N:No",DIR("A")="Do you want to enter a Progress Note",DIR("B")="No" D ^DIR
"RTN","PSJLIACT",155,0)
 .Q:Y="N"
"RTN","PSJLIACT",156,0)
 .D MAIN^TIUEDIT(3,.TIUDA,DFN,"","","","",1)
"RTN","PSJLIACT",157,0)
 Q:'$G(PSIVLOG)
"RTN","PSJLIACT",158,0)
 I $G(P("PACT"))]"",+$P(P("PACT"),U,2),+$P(P("PACT"),U,3) D
"RTN","PSJLIACT",159,0)
 . NEW DIC,DA,X,Y,XX,DO D NAME^PSJBCMA1($P(P("PACT"),U,2),.XX)
"RTN","PSJLIACT",160,0)
 . S DIC(0)="L",DA(1)=DFN,DA(2)=+ON55,X=1
"RTN","PSJLIACT",161,0)
 . S DIC="^PS(55,"_DA(1)_",""IV"","_DA(2)_",""A"","
"RTN","PSJLIACT",162,0)
 . S DIC("DR")=".02////F;.03////"_XX_";.04////"_$P($G(^PS(53.3,+$P(P("PACT"),U,3),0)),U)_";.05////"_$P(P("PACT"),U)_";.06////"_$P(P("PACT"),U,2)
"RTN","PSJLIACT",163,0)
 . D FILE^DICN
"RTN","PSJLIACT",164,0)
 NEW PSIVALCK
"RTN","PSJLIACT",165,0)
 S PSIVREA="V",PSIVALT=""
"RTN","PSJLIACT",166,0)
 S PSIVAL=PSIVAL_$S(+PSJSYSU=3:"PHARMACIST",1:"NURSE")
"RTN","PSJLIACT",167,0)
 D LOG^PSIVORAL K PSIVAL,PSIVREA,PSIVLN
"RTN","PSJLIACT",168,0)
 I $G(PSJORD)["P" S PSIVREA="V",PSIVALT="",PSGRDTX=$G(^PS(53.1,+PSJORD,2.5)) D
"RTN","PSJLIACT",169,0)
 . I $G(PSGRDTX) S PSIVAL="Requested Start Date: "_$$ENDTC^PSGMI($$DATE2^PSJUTL2($P(PSGRDTX,U))) D LOG^PSIVORAL
"RTN","PSJLIACT",170,0)
 . I $P(PSGRDTX,U,3) S PSIVREA="V",PSIVALT="" S PSIVAL="Requested Stop Date: "_$$ENDTC^PSGMI($$DATE2^PSJUTL2($P(PSGRDTX,U,3))) D LOG^PSIVORAL
"RTN","PSJLIACT",171,0)
 N DUR I $G(PSJORD) S DUR=$$GETDUR^PSJLIVMD(DFN,+PSJORD,$S(PSJORD["P":"P",1:"IV"),1) I DUR]""  D
"RTN","PSJLIACT",172,0)
 . K DR S DIE="^PS(55,"_DFN_",""IV"",",DA=+ON55,DA(1)=DFN
"RTN","PSJLIACT",173,0)
 . S DR=$S($G(IVLIMIT):"152////"_DUR,1:"151////"_DUR) K IVLIMIT
"RTN","PSJLIACT",174,0)
 . D ^DIE
"RTN","PSJLIACT",175,0)
 S ^TMP("PSODAOC",$J,"IP NEW IEN")=ON55
"RTN","PSJLIACT",176,0)
 D EN1^PSJHL2(DFN,"SC",ON55),SETOC^PSJNEWOC(ON55)
"RTN","PSJLIACT",177,0)
 D:+PSJSYSU=1 EN1^PSJHL2(DFN,"ZV",ON55)
"RTN","PSJLIACT",178,0)
 I '$D(^PS(55,DFN,"IV","CIMOI",+ON55)) D CIMOI^PSJIMO1(DFN,ON55,"",$G(PSJORD))
"RTN","PSJLIACT",179,0)
 E  I +$G(PSJORD) D KILL531^PSJIMO1(DFN,"",PSJORD)
"RTN","PSJLIACT",180,0)
 D GT55^PSIVORFB S OLDON=$P($G(^PS(55,DFN,"IV",+ON55,2)),"^",5),P("OLDON")=OLDON
"RTN","PSJLIACT",181,0)
 N PSJPRIO,PSJSCH,NODE0,NODEP2 S NODE0=$G(^PS(55,DFN,"IV",+ON55,0)),NODEP2=$G(^PS(55,DFN,"IV",+ON55,.2))
"RTN","PSJLIACT",182,0)
 S PSJPRIO=$P(NODEP2,"^",4),PSJSCH=$P(NODE0,"^",9)
"RTN","PSJLIACT",183,0)
 I (",S,A,")[(","_$G(PSJPRIO)_",")!($G(PSJSCH)="NOW")!($G(PSJSCH)["STAT") D NOTIFY^PSJHL4(ON55,DFN,$G(PSJPRIO),$G(PSJSCH))
"RTN","PSJLIACT",184,0)
 Q
"RTN","PSJLIFN")
0^13^B58490722
"RTN","PSJLIFN",1,0)
PSJLIFN ;BIR/MV-IV FINISH USING LM ;13 Jan 98 / 11:32 AM
"RTN","PSJLIFN",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**1,29,34,37,42,47,50,56,94,80,116,110,181,261,252,313,333,256**;16 DEC 97;Build 34
"RTN","PSJLIFN",3,0)
 ;
"RTN","PSJLIFN",4,0)
 ; Reference to ^PS(51.2 is supported by DBIA #2178.
"RTN","PSJLIFN",5,0)
 ; Reference to ^PS(52.6 supported by DBIA #1231.
"RTN","PSJLIFN",6,0)
 ; Reference to ^PS(52.7 supported by DBIA #2173.
"RTN","PSJLIFN",7,0)
 ; Reference to ^PSDRUG( is supported by DBIA #2192.
"RTN","PSJLIFN",8,0)
 ; Reference to ^PSOORDRG is supported by DBIA #2190.
"RTN","PSJLIFN",9,0)
 ; Reference to ^%DT is supported by DBIA #10003.
"RTN","PSJLIFN",10,0)
 ; Reference to ^VALM is supported by DBIA #10118.
"RTN","PSJLIFN",11,0)
 ; Reference to ^VALM1 is supported by DBIA #10116.
"RTN","PSJLIFN",12,0)
 ; Reference to RE^VALM4 is supported by DBIA #10120.
"RTN","PSJLIFN",13,0)
 ;
"RTN","PSJLIFN",14,0)
EN ; Display order with numbers.
"RTN","PSJLIFN",15,0)
 L +^PS(53.1,+PSJORD):1 I '$T W !,$C(7),$C(7),"This order is being edited by another user. Try later." D PAUSE^VALM1 Q
"RTN","PSJLIFN",16,0)
 NEW PSJOCFG
"RTN","PSJLIFN",17,0)
 S PSJOCFG="FN IV"
"RTN","PSJLIFN",18,0)
 D PENDING K PSJREN,PSJOCFG
"RTN","PSJLIFN",19,0)
 L -^PS(53.1,+PSJORD)
"RTN","PSJLIFN",20,0)
 Q
"RTN","PSJLIFN",21,0)
PENDING ; Process pending order.
"RTN","PSJLIFN",22,0)
 ;* PSIVFN1 is used so it will display the AC/Edit screen
"RTN","PSJLIFN",23,0)
 ;* instead of go to the "IS this O.K." prompt
"RTN","PSJLIFN",24,0)
 ;* PSIVACEP only when accept the order. Original screen won't redisp.
"RTN","PSJLIFN",25,0)
 ;* PSJLMX is defined in WRTDRG^PSIVUTL and it was being call in PSJLIVMD & PSJLIVFD
"RTN","PSJLIFN",26,0)
 ;*        to count # of AD/SOL 
"RTN","PSJLIFN",27,0)
 NEW PSIVFN1,PSIVACEP,PSJLMX,PSIVOI,PSJOCCHK,PSJFNDS
"RTN","PSJLIFN",28,0)
 K PSJIVBD ;This variable was left over from the new backdoor order entry.
"RTN","PSJLIFN",29,0)
 ; PSJOCCHK is set so if EDIT was use instead of FN to finish order the OC is triggered
"RTN","PSJLIFN",30,0)
 S PSJOCCHK=1
"RTN","PSJLIFN",31,0)
 ;* PSJFNDS is set so dosing is trigger during finishing without changes to the add/sol
"RTN","PSJLIFN",32,0)
 S PSJFNDS=1
"RTN","PSJLIFN",33,0)
 S PSIVAC="CF" S (P("PON"),ON)=+PSJORD_"P",DFN=PSGP
"RTN","PSJLIFN",34,0)
 S PSIVUP=+$$GTPCI^PSIVUTL D GT531^PSIVORFA(DFN,ON)
"RTN","PSJLIFN",35,0)
 D:'$D(P("OT")) GTOT^PSIVUTL(P(4))
"RTN","PSJLIFN",36,0)
 NEW PSJL
"RTN","PSJLIFN",37,0)
 N PSIVNUM,PSJSTAR S PSIVNUM=1
"RTN","PSJLIFN",38,0)
 Q:ON'=PSJORD
"RTN","PSJLIFN",39,0)
 I $G(PSJLYN)]"" Q:ON'=PSJLYN
"RTN","PSJLIFN",40,0)
 S PSJMAI=ON
"RTN","PSJLIFN",41,0)
 I P("OT")="I" D  Q
"RTN","PSJLIFN",42,0)
 . S PSJSTAR="(5)^(7)^(9)^(10)"
"RTN","PSJLIFN",43,0)
 . D EN^VALM("PSJ LM IV INPT PENDING") ;; ^PSJLIVMD
"RTN","PSJLIFN",44,0)
 S PSJSTAR="(1)^(2)^(3)^(5)^(7)^(9)"
"RTN","PSJLIFN",45,0)
 D GTDATA D EN^VALM("PSJ LM IV PENDING") ;; ^PSJLIVFD
"RTN","PSJLIFN",46,0)
 K PSJMAI Q
"RTN","PSJLIFN",47,0)
 ;
"RTN","PSJLIFN",48,0)
DISPLAY ;
"RTN","PSJLIFN",49,0)
 S PSGACT=""
"RTN","PSJLIFN",50,0)
 S VALMSG="Press Return to continue"
"RTN","PSJLIFN",51,0)
 D:$E(P("OT"))="I" EN^VALM("PSJ LM IV INPT DISPLAY")
"RTN","PSJLIFN",52,0)
 D:$E(P("OT"))'="I" EN^VALM("PSJ LM IV DISPLAY")
"RTN","PSJLIFN",53,0)
 K PSJDISP
"RTN","PSJLIFN",54,0)
 S:'$G(PSJHIS) VALMBCK=""
"RTN","PSJLIFN",55,0)
 Q
"RTN","PSJLIFN",56,0)
GTDATA ;
"RTN","PSJLIFN",57,0)
 ;* D:P(4)="" 53^PSIVORC1 Q:P(4)=""  S P("DTYP")=$S(P(4)="":0,P(4)="P"!(P(23)="P")!(P(5)):1,P(4)="H":2,1:3)
"RTN","PSJLIFN",58,0)
 S P("DTYP")=$S(P(4)="":0,P(4)="P"!(P(23)="P")!(P(5)):1,P(4)="H":2,1:3)
"RTN","PSJLIFN",59,0)
 I 'P(2) D
"RTN","PSJLIFN",60,0)
 .I P("RES")="R" S PSJREN=1
"RTN","PSJLIFN",61,0)
 .D ENT^PSIVCAL K %DT S X=P(2),%DT="RTX" D ^%DT S P(2)=+Y
"RTN","PSJLIFN",62,0)
 I 'P(3) D ENSTOP^PSIVCAL K %DT S X=P(3),%DT="RTX" D ^%DT S P(3)=+Y
"RTN","PSJLIFN",63,0)
 I 'P("MR") S P("MR")=$O(^PS(51.2,"B","INTRAVENOUS",0))_"^IV"
"RTN","PSJLIFN",64,0)
 Q
"RTN","PSJLIFN",65,0)
FINISH ; Prompt for missing data
"RTN","PSJLIFN",66,0)
 ;* Ord chk for Inpat. pending only. Pend renew should not be checked.
"RTN","PSJLIFN",67,0)
 ;* PSIVOCON needed so this order will be excluded from the order
"RTN","PSJLIFN",68,0)
 ;*          list(ORDCHK^PSJLMUT1)
"RTN","PSJLIFN",69,0)
 ;* PSGORQF defined means cancel the order due to order check.
"RTN","PSJLIFN",70,0)
 ;Q:'$$LS^PSSLOCK(DFN,PSJORD)
"RTN","PSJLIFN",71,0)
 N PSJCOM,PSIVEDIT,PSJOLDNM
"RTN","PSJLIFN",72,0)
 S PSJCOM=+$P($G(^PS(53.1,+PSJORD,.2)),"^",8)
"RTN","PSJLIFN",73,0)
 K PSJIVBD,PSGRDTX,PSIVEDIT
"RTN","PSJLIFN",74,0)
 N FIL,PSIVS,DRGOC,PSIVXD,DRGTMP,PSIVOCON,PSGORQF,ON55,NSFF K PSGORQF S NSFF=1
"RTN","PSJLIFN",75,0)
 S (ON,PSIVOCON,ON55,PSGORD)=PSJORD D GTDRG^PSIVORFA Q:PSJORD'=PSJMAI  I $G(PSJLYN)]"" Q:PSJORD'=PSJLYN
"RTN","PSJLIFN",76,0)
 D UDVARS^PSJLIORD
"RTN","PSJLIFN",77,0)
 I $G(PSJPROT)=3,'$$ENIVUD^PSGOEF1(PSJORD) K NSFF Q
"RTN","PSJLIFN",78,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIFN",79,0)
 ;PRE UAT group requested to not show the second screen since FDB OC has more text and provider override reason appears after 2nd screen 
"RTN","PSJLIFN",80,0)
 ; force the display of the second screen if CPRS order checks exist
"RTN","PSJLIFN",81,0)
 ;I $O(^PS(53.1,+PSJORD,12,0))!$O(^PS(53.1,+PSJORD,10,0)) D
"RTN","PSJLIFN",82,0)
 ;.Q:$G(PSJLMX)=1   ;no second screen to display
"RTN","PSJLIFN",83,0)
 ;.S VALMBG=16 D RE^VALM4,PAUSE^VALM1 S VALMBG=1
"RTN","PSJLIFN",84,0)
 S P("OPI")=$$ENPC^PSJUTL("V",+PSIVUP,60,P("OPI"))
"RTN","PSJLIFN",85,0)
 ;I $E(P("OT"))="I" D GTDATA Q:P(4)=""
"RTN","PSJLIFN",86,0)
 ;I $E(P("OT"))="I",'$D(DRG("AD")),('$D(DRG("SOL"))) D
"RTN","PSJLIFN",87,0)
 I $G(P("RES"))'="R" D 53^PSIVORC1
"RTN","PSJLIFN",88,0)
 I $G(P(4))]"",$G(P(15))]"",$G(P(9))]"",$$SCHREQ^PSJLIVFD(.P) D  Q:$G(PSGORQF)
"RTN","PSJLIFN",89,0)
 . ;*** PSJ*5*256
"RTN","PSJLIFN",90,0)
 . S PSJOLDNM("ORD_SCHD")=P(9)
"RTN","PSJLIFN",91,0)
 . I $$CHKSCHD^PSJMISC2(.PSJOLDNM,$S($G(P("RES"))="R":"R",1:"")) S PSGORQF=1,VALMBCK="R" Q
"RTN","PSJLIFN",92,0)
 . S:$G(PSJOLDNM("NEW_SCHD"))]"" P(9)=PSJOLDNM("NEW_SCHD")
"RTN","PSJLIFN",93,0)
 . N PSGS0XT,X,PSJNSS S PSJNSS=1,X=P(9),PSGS0XT=P(15) D Q2^PSGS0
"RTN","PSJLIFN",94,0)
 . I ON["P",$G(PSJOLDNM("NEW_SCHD"))]"" D
"RTN","PSJLIFN",95,0)
 ..I $G(PSGS0Y)]"",$G(P(11))]"",(PSGS0Y'=PSJOLDNM("NEW_SCHD")) D 
"RTN","PSJLIFN",96,0)
 ...W $C(7),!!,"PLEASE NOTE:  This order's admin times (",P(11),") do not match the times"
"RTN","PSJLIFN",97,0)
 ...W !?13," for this administration schedule (",PSJOLDNM("NEW_SCHD"),")",!
"RTN","PSJLIFN",98,0)
 ...D PAUSE^VALM1
"RTN","PSJLIFN",99,0)
 I P(4)="" D RE^VALM4 Q
"RTN","PSJLIFN",100,0)
 I $E(P("OT"))="I" D GTDATA  D
"RTN","PSJLIFN",101,0)
 . I '$D(DRG("AD")),('$D(DRG("SOL"))) S DNE=0 D GTIVDRG^PSIVORC2 S P(3)="" D ENSTOP^PSIVCAL
"RTN","PSJLIFN",102,0)
 S VALMBG=1
"RTN","PSJLIFN",103,0)
 I $E(P("OT"))="F" S DNE=0 I $G(PSGORQF) D RE^VALM4 Q
"RTN","PSJLIFN",104,0)
 I $G(PSGORQF) S VALMBCK="R",P(4)="" K DRG Q
"RTN","PSJLIFN",105,0)
 ; Will prompt users to choose Dispense IV Additive when more than one are available for the Orderable Item
"RTN","PSJLIFN",106,0)
 N PSJQUIT S PSJQUIT=0 D MULTADDS I $G(PSJQUIT) S VALMBCK="R" Q
"RTN","PSJLIFN",107,0)
 S PSIVEDIT=""
"RTN","PSJLIFN",108,0)
 S PSIVOK="1^3^10^25^26^39^57^58^59^63^64" D CKFLDS^PSIVORC1 I EDIT]"" D EDIT^PSIVEDT
"RTN","PSJLIFN",109,0)
 ;S PSIVOK="1^3^10^25^26^39^57^58^59^63^64" D CKFLDS^PSIVORC1 I EDIT]"" S PSIVEDIT=EDIT D EDIT^PSIVEDT
"RTN","PSJLIFN",110,0)
 ;I $G(EDIT)="" D OC^PSIVOC D:'$G(PSGORQF) IN^PSJOCDS($G(ON),"IV","") Q:$G(PSGORQF)
"RTN","PSJLIFN",111,0)
 I $D(PSIVEDIT) D OC^PSIVOC
"RTN","PSJLIFN",112,0)
 ;PSJ*5*261 - Remedy #490875 PSPO 2040 
"RTN","PSJLIFN",113,0)
 D ENSTOP^PSIVCAL
"RTN","PSJLIFN",114,0)
 ;D:'$G(PSGORQF) IN^PSJOCDS($G(ON),"IV","")
"RTN","PSJLIFN",115,0)
  ;If quit then restore DRG( to pre-edit state
"RTN","PSJLIFN",116,0)
 I $G(PSGORQF) D GT531^PSIVORFA(DFN,ON) Q
"RTN","PSJLIFN",117,0)
 I $G(DONE) S VALMBCK="R" Q
"RTN","PSJLIFN",118,0)
 ;* PSJFNDS is set so dosing is trigger during finishing without changes to the add/sol
"RTN","PSJLIFN",119,0)
 ;S PSJFNDS=1
"RTN","PSJLIFN",120,0)
 D COMPLTE^PSIVORC1
"RTN","PSJLIFN",121,0)
 S:$G(PSIVACEP) VALMBCK="Q"
"RTN","PSJLIFN",122,0)
 ;Reset PSJFNDS so if FN again, the dosing check is triggered.
"RTN","PSJLIFN",123,0)
 S:'$G(PSIVACEP) PSJFNDS=1
"RTN","PSJLIFN",124,0)
 I $G(PSGORQF) S VALMBG=1 D RE^VALM4
"RTN","PSJLIFN",125,0)
 K NSFF
"RTN","PSJLIFN",126,0)
 Q
"RTN","PSJLIFN",127,0)
 ;
"RTN","PSJLIFN",128,0)
MULTADDS ; If there are multiple IV Additives per Orderable Item, it will prompt for selection
"RTN","PSJLIFN",129,0)
 N TMPDRG
"RTN","PSJLIFN",130,0)
 S PSJQUIT=0
"RTN","PSJLIFN",131,0)
 I $O(DRG("AD",0)) D  I PSJQUIT D SAVEDRG^PSIVEDRG(.DRG,.TMPDRG) Q
"RTN","PSJLIFN",132,0)
 . D SAVEDRG^PSIVEDRG(.TMPDRG,.DRG)
"RTN","PSJLIFN",133,0)
 . N PSIDX,OI,IVLIST
"RTN","PSJLIFN",134,0)
 . F PSIDX=1:1 Q:'$D(DRG("AD",PSIDX))  D  I PSJQUIT Q
"RTN","PSJLIFN",135,0)
 . . S OI=$P(DRG("AD",PSIDX),"^",6) I 'OI Q
"RTN","PSJLIFN",136,0)
 . . K IVLIST D IVADDCNT(OI,.IVLIST) I $O(IVLIST(""),-1)'>1 Q
"RTN","PSJLIFN",137,0)
 . . W !!,"More than one dispense IV Additives are available for:"
"RTN","PSJLIFN",138,0)
 . . W !,"Orderable Item: ",$$GET1^DIQ(50.7,OI,.01)
"RTN","PSJLIFN",139,0)
 . . W !,"  Ordered Dose: ",$P(DRG("AD",PSIDX),"^",3)
"RTN","PSJLIFN",140,0)
 . . W !!,"Please select the correct dispense IV Additive below for this order:"
"RTN","PSJLIFN",141,0)
 . . N DIR,IVADD,IVCNT,X,Y,DIRUT,DUOUT
"RTN","PSJLIFN",142,0)
 . . S DIR("?")="Please select the correct dispense IV Additive below for this order:"
"RTN","PSJLIFN",143,0)
 . . F IVCNT=1:1 Q:'$D(IVLIST(IVCNT))  D  I PSJQUIT Q
"RTN","PSJLIFN",144,0)
 . . . S IVADD=IVLIST(IVCNT)
"RTN","PSJLIFN",145,0)
 . . . S X="  "_IVCNT_"  "_$$GET1^DIQ(52.6,IVADD,.01)
"RTN","PSJLIFN",146,0)
 . . . S $E(X,45)="Additive Strength: "_$S($$GET1^DIQ(52.6,IVADD,19)'="":$$GET1^DIQ(52.6,IVADD,19)_" "_$$GET1^DIQ(52.6,IVADD,2),1:"N/A")
"RTN","PSJLIFN",147,0)
 . . . S DIR("A",IVCNT)=X
"RTN","PSJLIFN",148,0)
 . . S DIR("A")="Select (1 - "_(IVCNT-1)_"): "
"RTN","PSJLIFN",149,0)
 . . S DIR(0)="LA^1:"_(IVCNT-1) D ^DIR I $D(DUOUT)!$D(DIRUT) S PSJQUIT=1 Q
"RTN","PSJLIFN",150,0)
 . . I (Y>0) D
"RTN","PSJLIFN",151,0)
 . . . S $P(DRG("AD",PSIDX),"^",1,2)=+IVLIST(+Y)_"^"_$$GET1^DIQ(52.6,+IVLIST(+Y),.01)
"RTN","PSJLIFN",152,0)
 . W !
"RTN","PSJLIFN",153,0)
 Q
"RTN","PSJLIFN",154,0)
 ;
"RTN","PSJLIFN",155,0)
ORDCHK ;* Do order check for Inpatient Meds IV.
"RTN","PSJLIFN",156,0)
 ; PSGORQF is defined (CONT^PSGSICHK) if not log an intervention
"RTN","PSJLIFN",157,0)
 ; No longer use after PSJ*5*181
"RTN","PSJLIFN",158,0)
 K PSGORQF
"RTN","PSJLIFN",159,0)
 Q
"RTN","PSJLIFN",160,0)
 ;NEW DRGOC
"RTN","PSJLIFN",161,0)
 ;D OCORD Q:$G(PSGORQF) 
"RTN","PSJLIFN",162,0)
 ;D GTIVDRG^PSIVORC2 S P(3)="" D ENSTOP^PSIVCAL
"RTN","PSJLIFN",163,0)
ORDCHKA ;* Do order check against existing orders on the profile
"RTN","PSJLIFN",164,0)
 ;No longer use as of PSJ*5*181
"RTN","PSJLIFN",165,0)
 Q
"RTN","PSJLIFN",166,0)
 F PSIVAS="AD","SOL" Q:$G(PSGORQF)  S FIL=$S(PSIVAS="AD":52.6,1:52.7) D
"RTN","PSJLIFN",167,0)
 . F PSIVX=0:0 S PSIVX=$O(DRG(PSIVAS,PSIVX)) Q:'PSIVX!($G(PSGORQF))  D
"RTN","PSJLIFN",168,0)
 .. S DRGTMP=DRG(PSIVAS,PSIVX)
"RTN","PSJLIFN",169,0)
 .. ;* Do only 1 duplicate warning when order has >1 of the same additive
"RTN","PSJLIFN",170,0)
 .. Q:$D(PSJADTMP(+DRGTMP))
"RTN","PSJLIFN",171,0)
 .. D ORDERCHK^PSIVEDRG(PSGP,ON,$D(DRGOC(ON)))
"RTN","PSJLIFN",172,0)
 .. S DRGOC(ON,PSIVAS,PSIVX)=DRG(PSIVAS,PSIVX)
"RTN","PSJLIFN",173,0)
 .. S PSJADTMP(+DRGTMP)=""
"RTN","PSJLIFN",174,0)
 K PSJADTMP
"RTN","PSJLIFN",175,0)
 Q
"RTN","PSJLIFN",176,0)
OCORD ;* Do order check for each drug against the drugs within the order.
"RTN","PSJLIFN",177,0)
 ;OCORD was called by ORDCHK.  This entry point is no longer use as of PSJ*5*181
"RTN","PSJLIFN",178,0)
 Q
"RTN","PSJLIFN",179,0)
 NEW X,Y,DDRUG,PSIVX,PSJAD,PSJSOL,TMPDRG
"RTN","PSJLIFN",180,0)
 D SAVEDRG^PSIVEDRG(.TMPDRG,.DRG)
"RTN","PSJLIFN",181,0)
 ; Find the corresponding DD for the additive within the order
"RTN","PSJLIFN",182,0)
 F X=0:0 S X=$O(DRG("AD",X)) Q:'X  D
"RTN","PSJLIFN",183,0)
 . S DDRUG=$P($G(^PS(52.6,+DRG("AD",X),0)),U,2)
"RTN","PSJLIFN",184,0)
 . S:+DDRUG (DDRUG(DDRUG),PSJAD(DDRUG))=$D(DDRUG(DDRUG))+1
"RTN","PSJLIFN",185,0)
 ;
"RTN","PSJLIFN",186,0)
 ; Find the corresponding DD for the solution
"RTN","PSJLIFN",187,0)
 ;
"RTN","PSJLIFN",188,0)
 F X=0:0 S X=$O(DRG("SOL",X)) Q:'X  D
"RTN","PSJLIFN",189,0)
 . S DDRUG=$P($G(^PS(52.7,+DRG("SOL",X),0)),U,2)
"RTN","PSJLIFN",190,0)
 . S:+DDRUG (DDRUG(DDRUG),PSJSOL(DDRUG))=$D(DDRUG(DDRUG))+1
"RTN","PSJLIFN",191,0)
 ;
"RTN","PSJLIFN",192,0)
 ; Loop thru each additive to check for DD,DI & DC against the
"RTN","PSJLIFN",193,0)
 ; order's dispense drugs
"RTN","PSJLIFN",194,0)
 ;
"RTN","PSJLIFN",195,0)
 NEW PSJDFN,INTERVEN S INTERVEN=""
"RTN","PSJLIFN",196,0)
 S PSJDFN=DFN ;DFN will be killed when call ^PSOORDRG
"RTN","PSJLIFN",197,0)
 F PSIVX=0:0 S PSIVX=$O(PSJAD(PSIVX)) Q:'PSIVX  D
"RTN","PSJLIFN",198,0)
 . K DDRUG(PSIVX) D DRGCHK^PSOORDRG(PSJDFN,PSIVX,.DDRUG)
"RTN","PSJLIFN",199,0)
 . I PSJAD(PSIVX)>1 S ^TMP($J,"DD",1,0)=PSIVX_U_$P($G(^PSDRUG(PSIVX,0)),U)_"^^"_ON_";I"
"RTN","PSJLIFN",200,0)
 . NEW TYPE F TYPE="DD","DI","DC" D ORDCHK^PSJLIFNI(PSJDFN,TYPE)
"RTN","PSJLIFN",201,0)
 F PSIVX=0:0 S PSIVX=$O(PSJSOL(PSIVX)) Q:'PSIVX  D
"RTN","PSJLIFN",202,0)
 . K DDRUG(PSIVX) D DRGCHK^PSOORDRG(PSJDFN,PSIVX,.DDRUG)
"RTN","PSJLIFN",203,0)
 . NEW TYPE F TYPE="DI" D ORDCHK^PSJLIFNI(PSJDFN,TYPE)
"RTN","PSJLIFN",204,0)
 S DFN=PSJDFN
"RTN","PSJLIFN",205,0)
 D SAVEDRG^PSIVEDRG(.DRG,.TMPDRG)
"RTN","PSJLIFN",206,0)
 Q
"RTN","PSJLIFN",207,0)
 ;
"RTN","PSJLIFN",208,0)
IVADDCNT(OI,IVLIST) ; Returns the number of IV Addtives Associated to the OI and Marked for IV Order Dialog
"RTN","PSJLIFN",209,0)
 ;Input: OI - PHARMACY ORDERABLE ITEM file (#50.7) IEN
"RTN","PSJLIFN",210,0)
 ;Output: $$IVADDCNT - Number of IV Additives linked to the Orderable Item
"RTN","PSJLIFN",211,0)
 ;        IVLIST(IV_IEN) - List of IV Additives linked to the Orderable Item
"RTN","PSJLIFN",212,0)
 N IVADD,IVADDCNT
"RTN","PSJLIFN",213,0)
 S IVADDCNT=0,IVADD=""
"RTN","PSJLIFN",214,0)
 F  S IVADD=$O(^PS(52.6,"AOI",OI,IVADD)) Q:'IVADD  D
"RTN","PSJLIFN",215,0)
 . ; Not Used in the IV Order Dialog
"RTN","PSJLIFN",216,0)
 . I '$$GET1^DIQ(52.6,IVADD,17,"I") Q
"RTN","PSJLIFN",217,0)
 . ; Other IV Solution is INACTIVE
"RTN","PSJLIFN",218,0)
 . I $$GET1^DIQ(52.6,IVADD,12,"I"),($$GET1^DIQ(52.6,IVADD,12,"I")'>DT) Q
"RTN","PSJLIFN",219,0)
 . ; Other IV Dispense Drug
"RTN","PSJLIFN",220,0)
 . S IVADDCNT=IVADDCNT+1,IVLIST(IVADDCNT)=IVADD
"RTN","PSJLIFN",221,0)
 Q
"RTN","PSJLIFNI")
0^18^B12733374
"RTN","PSJLIFNI",1,0)
PSJLIFNI ;BIR/MV-U/D ORDER FINISHES AS IV ;13 Jan 98 / 11:32 AM
"RTN","PSJLIFNI",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**1,29,34,37,50,94,116,110,111,181,261,256**;16 DEC 97;Build 34
"RTN","PSJLIFNI",3,0)
 ;
"RTN","PSJLIFNI",4,0)
IV(PSJORD,OI) ; Prompt for missing data to be finished as IV.
"RTN","PSJLIFNI",5,0)
 L +^PS(53.1,+PSJORD):1 I '$T W !,$C(7),$C(7),"This order is being edited by another user. Try later." D PAUSE^VALM1 Q
"RTN","PSJLIFNI",6,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIFNI",7,0)
 ;** PSIVFN1 is used so it will display the AC/Edit screen
"RTN","PSJLIFNI",8,0)
 ;** instead of go to the "IS this O.K." prompt
"RTN","PSJLIFNI",9,0)
 ;** PSJLIFNI is a flag to indicate U/D finishes as IV.
"RTN","PSJLIFNI",10,0)
 K PSJIVBD
"RTN","PSJLIFNI",11,0)
 NEW PSIVFN1,ON55,PSGORQF,PSIVACEP,DRGOC,PSJLIFNI,PSIVOI,PSJOLDNM
"RTN","PSJLIFNI",12,0)
 K PSGORQF
"RTN","PSJLIFNI",13,0)
 S PSJLIFNI=1
"RTN","PSJLIFNI",14,0)
 S PSIVAC="CF" S (P("PON"),ON,ON55)=+PSJORD_"P",DFN=PSGP
"RTN","PSJLIFNI",15,0)
 S PSIVUP=+$$GTPCI^PSIVUTL D GT531^PSIVORFA(DFN,ON) S P("PD")=OI_U_$$OIDF^PSJLMUT1(+OI)
"RTN","PSJLIFNI",16,0)
 D:'$D(P("OT")) GTOT^PSIVUTL(P(4))
"RTN","PSJLIFNI",17,0)
 S P("OPI")=$$ENPC^PSJUTL("V",+PSIVUP,60,P("OPI"))
"RTN","PSJLIFNI",18,0)
 D 53^PSIVORC1
"RTN","PSJLIFNI",19,0)
 I $E(P("OT"))="I" D GTDATA^PSJLIFN Q:P(4)=""
"RTN","PSJLIFNI",20,0)
 ;I $$SCHREQ^PSJLIVFD(.P),(P(9))]"",'$$PRNOK^PSGS0(P(9)) N PSGOES,X,PSGS0XT,PSJNSS S PSJNSS=1,PSGOES=1,X=P(9),PSGS0XT=P(15) D Q2^PSGS0
"RTN","PSJLIFNI",21,0)
 I $$SCHREQ^PSJLIVFD(.P),(P(9))]"",'$$PRNOK^PSGS0(P(9)) N PSJNSS,PSGOES,PSGS0XT,PSGS0Y,PSGAT S X=P(9),PSGS0XT=P(15),PSGAT=P(11) D
"RTN","PSJLIFNI",22,0)
 .;
"RTN","PSJLIFNI",23,0)
 .;PSJ*5*256
"RTN","PSJLIFNI",24,0)
 . S PSJOLDNM("ORD_SCHD")=P(9)
"RTN","PSJLIFNI",25,0)
 . I ($G(P("RES"))'="R"),$$CHKSCHD^PSJMISC2(.PSJOLDNM) S PSGORQF=1,VALMBCK="R" Q
"RTN","PSJLIFNI",26,0)
 . S:$G(PSJOLDNM("NEW_SCHD"))]"" P(9)=PSJOLDNM("NEW_SCHD")
"RTN","PSJLIFNI",27,0)
 .;
"RTN","PSJLIFNI",28,0)
 .D EN^PSGS0 I $G(X)="" S PSGORQF=1 Q
"RTN","PSJLIFNI",29,0)
 .I $G(PSGS0Y)>1 S P(11)=PSGS0Y
"RTN","PSJLIFNI",30,0)
 I $E(P("OT"))="I",'$D(DRG("AD")),('$D(DRG("SOL"))) S DNE=0 D GTIVDRG^PSIVORC2 S P(3)="" D ENSTOP^PSIVCAL
"RTN","PSJLIFNI",31,0)
 I $D(PSGORQF) S VALMBCK="R",P(4)="" K DRG Q
"RTN","PSJLIFNI",32,0)
 S ^TMP("PSJI",$J,0)=""
"RTN","PSJLIFNI",33,0)
 S PSIVOK="1^3^10^25^26^39^57^58^59^63^64" D CKFLDS^PSIVORC1 I EDIT]"" D EDIT^PSIVEDT
"RTN","PSJLIFNI",34,0)
 ;I $G(EDIT)="" D OC^PSIVOC
"RTN","PSJLIFNI",35,0)
 I $G(DONE) S VALMBCK="R" D EXIT Q
"RTN","PSJLIFNI",36,0)
 ;PSJ*5*261 - Remedy #490875 PSPO 2040
"RTN","PSJLIFNI",37,0)
 D ENSTOP^PSIVCAL
"RTN","PSJLIFNI",38,0)
 D COMPLTE^PSIVORC1
"RTN","PSJLIFNI",39,0)
 S:$D(PSIVACEP) VALMBCK="Q"
"RTN","PSJLIFNI",40,0)
EXIT ;
"RTN","PSJLIFNI",41,0)
 L -^PS(53.1,+PSJORD)
"RTN","PSJLIFNI",42,0)
 Q
"RTN","PSJLIFNI",43,0)
ORDCHK(DFN,TYPE) ;
"RTN","PSJLIFNI",44,0)
 ;TYPE ="DD" - Duplicate drug
"RTN","PSJLIFNI",45,0)
 ;     ="DC" - Duplicate class
"RTN","PSJLIFNI",46,0)
 ;     -"DI" - Drug Interaction
"RTN","PSJLIFNI",47,0)
 ;
"RTN","PSJLIFNI",48,0)
 NEW ON,PSJL,PSIVX,PSJOC,PSJORIEN,PSJPACK,PSJLINE
"RTN","PSJLIFNI",49,0)
 S PSJOC=0,PSJLINE=1
"RTN","PSJLIFNI",50,0)
 F PSIVX=0:0 S PSIVX=$O(^TMP($J,TYPE,PSIVX)) Q:'PSIVX  D
"RTN","PSJLIFNI",51,0)
 . I TYPE="DI",($P(^TMP($J,TYPE,PSIVX,0),U,4)="CRITICAL") S PSJIREQ=1
"RTN","PSJLIFNI",52,0)
 . D WRITE(TYPE),CONT^PSGSICHK
"RTN","PSJLIFNI",53,0)
 .; I ON["V" D
"RTN","PSJLIFNI",54,0)
 .;. I '$O(^PS(55,DFN,"IV",+ON,0)) D SETPSJOC Q
"RTN","PSJLIFNI",55,0)
 .;. D DSPLORDV(DFN,ON) S PSJOC=PSJOC+1
"RTN","PSJLIFNI",56,0)
 .; I ON'["V" D DSPLORDU(DFN,ON) S PSJOC=PSJOC+1
"RTN","PSJLIFNI",57,0)
 .; S PSJOC(ON,PSJLINE)="",PSJLINE=PSJLINE+1
"RTN","PSJLIFNI",58,0)
 ;D:PSJOC WRITE(TYPE)
"RTN","PSJLIFNI",59,0)
 ;S ON="" F  S ON=$O(PSJOC(ON)) Q:ON=""  W ! S PSJLINE=PSJLINE+1 D
"RTN","PSJLIFNI",60,0)
 ;. F PSIVX=0:0 S PSIVX=$O(PSJOC(ON,PSIVX)) Q:'PSIVX  W !,PSJOC(ON,PSIVX)  S PSJLINE=PSJLINE+1 D:'(PSIVX#6) PAUSE
"RTN","PSJLIFNI",61,0)
 ;W !
"RTN","PSJLIFNI",62,0)
 Q
"RTN","PSJLIFNI",63,0)
WRITE(TYPE) ;Display order check description
"RTN","PSJLIFNI",64,0)
 S PSJPDRG=1
"RTN","PSJLIFNI",65,0)
 I TYPE="DD" W !!,"There are duplicate ",$P(^TMP($J,TYPE,PSIVX,0),U,2),!,"medications prescribed for this order.",! Q
"RTN","PSJLIFNI",66,0)
 I TYPE="DC" W !!,"This medication: ",$P(^TMP($J,TYPE,PSIVX,0),U,4),!,"is in the same class as the following medication(s) within this order: "
"RTN","PSJLIFNI",67,0)
 I TYPE="DI" W !!,"This medication: ",$P(^TMP($J,TYPE,PSIVX,0),U,2),!,"has an interaction with the following medication(s) within this order: "
"RTN","PSJLIFNI",68,0)
 F X=0:0 S X=$O(^TMP($J,TYPE,X)) Q:'X  W !,$S(TYPE="DC":$P(^TMP($J,TYPE,X,0),U,4),TYPE="DI":$P(^TMP($J,TYPE,X,0),U,6),1:$P(^TMP($J,TYPE,X,0),U,2)),!
"RTN","PSJLIFNI",69,0)
 Q
"RTN","PSJLIVFD")
0^30^B63243242
"RTN","PSJLIVFD",1,0)
PSJLIVFD ;BIR/MV-SETUP LM TEMPLATE FOR IV FLUID ;4 Aug 00 / 2:37 PM
"RTN","PSJLIVFD",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**7,50,63,64,58,81,91,80,116,110,111,180,134,181,254,267,228,279,305,256**;16 DEC 97;Build 34
"RTN","PSJLIVFD",3,0)
 ;
"RTN","PSJLIVFD",4,0)
 ; External Reference to ^VALM0 is supported by DBIA #2615.
"RTN","PSJLIVFD",5,0)
 ; External Referece to ^PS(53.47 is supported by DBIA #5884
"RTN","PSJLIVFD",6,0)
 ;
"RTN","PSJLIVFD",7,0)
 ;NFI changes for FR# 3@AD+4
"RTN","PSJLIVFD",8,0)
 ;
"RTN","PSJLIVFD",9,0)
EN ; Build LM template to display IV order.
"RTN","PSJLIVFD",10,0)
 K ^TMP("PSJI",$J) N SCHMSG
"RTN","PSJLIVFD",11,0)
 S UL80="",$P(UL80,"=",80)=""
"RTN","PSJLIVFD",12,0)
 S PSJLN=1
"RTN","PSJLIVFD",13,0)
AD ;
"RTN","PSJLIVFD",14,0)
 NEW VALMEVL S VALMEVL=1
"RTN","PSJLIVFD",15,0)
 S PSJL="" D FLDNO^PSJLIUTL("(1)",1)
"RTN","PSJLIVFD",16,0)
 S PSJL=PSJL_"Additives:"
"RTN","PSJLIVFD",17,0)
 S:$G(P("PON"))["V"&(P(17)'="N") PSJL=$$SETSTR^VALM1("Order number:",PSJL,30,14)_+P("PON")
"RTN","PSJLIVFD",18,0)
 S PSJL=$$SETSTR^VALM1("Type:",PSJL,54,6)_$$TYPE^PSJLIUTL
"RTN","PSJLIVFD",19,0)
 NEW PSJVD S PSJVD=$$DINFLIV^PSJDIN(.DRG) S PSJVD=$TR(PSJVD," ")
"RTN","PSJLIVFD",20,0)
 I $D(^TMP("PSJINTER",$J))!$$OVRCHK^PSGSICH1(PSGP,$G(PSJORD)) S PSJVD=$S($G(PSJVD)["DIN":"<OCI><DIN>",1:"<OCI>")
"RTN","PSJLIVFD",21,0)
 S PSJL=$$SETSTR^VALM1(PSJVD,PSJL,(80-$L(PSJVD)),$L(PSJVD))
"RTN","PSJLIVFD",22,0)
 I $D(IORVON),($G(PSJVD)]"") D CNTRL^VALM10(1,(80-$L(PSJVD)),$L(PSJVD),IORVON,IORVOFF,0) K PSJVD
"RTN","PSJLIVFD",23,0)
 I '$D(IORVON),$D(IOST(0)) D ENS^%ZISS,TERM^VALM0
"RTN","PSJLIVFD",24,0)
 D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",25,0)
 D:+$G(PSJLMX) CLRDSPL^PSJLIVMD
"RTN","PSJLIVFD",26,0)
 ;PSJLMX count number of lines needed to display the add/sol
"RTN","PSJLIVFD",27,0)
 S PSJLMX=0 D WRTDRG^PSJLIUTL("AD")
"RTN","PSJLIVFD",28,0)
SOL ;
"RTN","PSJLIVFD",29,0)
 S PSJL="" D FLDNO^PSJLIUTL("(2)",1)
"RTN","PSJLIVFD",30,0)
 S PSJL=PSJL_"Solutions:"
"RTN","PSJLIVFD",31,0)
 I P("SYRS")]"" D
"RTN","PSJLIVFD",32,0)
 . S PSJL=$$SETSTR^VALM1("Syr. Size:",PSJL,52,10)_$E(P("SYRS"),1,13)
"RTN","PSJLIVFD",33,0)
 . S:$L(P("SYRS"))>13 PSJL=PSJL_"..."
"RTN","PSJLIVFD",34,0)
 D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",35,0)
 D WRTDRG^PSJLIUTL("SOL")
"RTN","PSJLIVFD",36,0)
DUR ;
"RTN","PSJLIVFD",37,0)
 S PSJL=""
"RTN","PSJLIVFD",38,0)
 N DUROUT,IVLIMIT S DUROUT=$$GETDUR^PSJLIVMD(PSGP,+PSJORD,$S(PSJORD["P":"P",1:"IV"))
"RTN","PSJLIVFD",39,0)
 I $G(PSJORD)["P" N ND25 S ND25=$G(^PS(53.1,+PSJORD,2.5)),IVLIMIT=$P(ND25,"^",4) D
"RTN","PSJLIVFD",40,0)
 .S IVLIMIT=$S(IVLIMIT]"":$$FMTDUR^PSJLIVMD(IVLIMIT),1:"") S:IVLIMIT]"" DUROUT=IVLIMIT
"RTN","PSJLIVFD",41,0)
 S LABEL=$S($G(IVLIMIT):"IV Limit: ",1:"Duration: ") K IVLIMIT
"RTN","PSJLIVFD",42,0)
 S PSJL=$$SETSTR^VALM1(LABEL,PSJL,12,10)
"RTN","PSJLIVFD",43,0)
 S PSJL=PSJL_DUROUT
"RTN","PSJLIVFD",44,0)
START ;
"RTN","PSJLIVFD",45,0)
 D FLDNO^PSJLIUTL("(4)",47)
"RTN","PSJLIVFD",46,0)
 S PSJL=$$SETSTR^VALM1("Start:",PSJL,56,7)_$$STARTDT^PSJLIUTL
"RTN","PSJLIVFD",47,0)
 D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",48,0)
 NEW PSGRSD,PSGRSDN,PSGRFD,PSGRFDN
"RTN","PSJLIVFD",49,0)
 S PSJL="" I $G(PSJORD)["P",$G(PSGRDTX) D
"RTN","PSJLIVFD",50,0)
 . N RSDLABL,PSJRQB,PSJRQL,PSGRSD,PSGSRSDN
"RTN","PSJLIVFD",51,0)
 . S RSDLABL="     REQUESTED START: ",PSJRQB=41,PSJRQL=39,PSGRSD="",PSGRSDN=""
"RTN","PSJLIVFD",52,0)
 . I $G(PSGRDTX(+$G(PSJORD),"PSGRSD")),$G(P(2)) S PSJRQB=51,PSJRQL=29 D
"RTN","PSJLIVFD",53,0)
 .. S PSGRSD=PSGRDTX(+$G(PSJORD),"PSGRSD"),PSGRSDN=$$ENDTC^PSGMI(+PSGRSD),RSDLABL="Calc Start: "
"RTN","PSJLIVFD",54,0)
 . I '$G(P(2)),'$P(PSGRDTX,U,3) S PSGRSD=+PSGRDTX,PSGRSDN=$$ENDTC^PSGMI(PSGRSD)
"RTN","PSJLIVFD",55,0)
 . I $G(PSGRSD),($G(PSGRSDN)]"") D DSPLYDT^PSJLIVMD(PSJLMX+5,.PSGRSD,.PSGRSDN,RSDLABL,1,PSJRQB,PSJRQL),SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",56,0)
INFRATE ;
"RTN","PSJLIVFD",57,0)
 N INFLBL,INFLBL1,INFLBL2 S INFLBL="",INFLBL1="",$P(INFLBL2," ",20)=""
"RTN","PSJLIVFD",58,0)
 S PSJL="" D FLDNO^PSJLIUTL("(3)",1)
"RTN","PSJLIVFD",59,0)
 S PSJL=$$SETSTR^VALM1("Infusion Rate:",PSJL,7,15)
"RTN","PSJLIVFD",60,0)
 I ($G(P("NUMLBL"))?1.N) S INFLBL1=" ("_P("NUMLBL")_" label"_$S(P("NUMLBL")=1:"",1:"s")_" per day)" I $L(P(8))>13 S INFLBL1=$E(INFLBL2,1,(24-$L(P(8))))_INFLBL1
"RTN","PSJLIVFD",61,0)
 S INFLBL=$S('($G(P("NUMLBL"))?1.N):$P(P(8),"@"),1:$P(P(8),"@")_INFLBL1)
"RTN","PSJLIVFD",62,0)
 D LONG^PSJLIUTL(INFLBL,22,24)
"RTN","PSJLIVFD",63,0)
LASTREN ;
"RTN","PSJLIVFD",64,0)
 N PSGRNDT S PSGRNDT=$$LASTREN^PSJLMPRI(DFN,$S($G(PSJORD):PSJORD,1:$G(ON))) I PSGRNDT D
"RTN","PSJLIVFD",65,0)
 . S PSGRNDT=$$ENDTC^PSGMI(+PSGRNDT),PSJL=$$SETSTR^VALM1("Renewed: "_PSGRNDT,PSJL,54,32)
"RTN","PSJLIVFD",66,0)
 D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",67,0)
MR ;
"RTN","PSJLIVFD",68,0)
 S PSJL="" D FLDNO^PSJLIUTL("(5)",1)
"RTN","PSJLIVFD",69,0)
 S PSJL=$$SETSTR^VALM1("Med Route:",PSJL,11,11)
"RTN","PSJLIVFD",70,0)
 S PSJL=PSJL_$P(P("MR"),U,2)
"RTN","PSJLIVFD",71,0)
STOP ;
"RTN","PSJLIVFD",72,0)
 D FLDNO^PSJLIUTL("(6)",47)
"RTN","PSJLIVFD",73,0)
 ;PSJ*5*180 - If Invalid Duration/Limit - Cannot Calculate Stop Date
"RTN","PSJLIVFD",74,0)
 S PSJL=$$SETSTR^VALM1("Stop:",PSJL,57,6)_$S($G(PSJBADD)=1:"CANNOT CALCULATE",1:$$STOPDT^PSJLIUTL)
"RTN","PSJLIVFD",75,0)
 D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",76,0)
 S PSJL=""
"RTN","PSJLIVFD",77,0)
 N PSJBCMA S PSJBCMA=$$BCMALG^PSJUTL2(DFN,PSJORD)
"RTN","PSJLIVFD",78,0)
 I $G(PSJBCMA)]"" S PSJL=$$SETSTR^VALM1(PSJBCMA,PSJL,1,52)
"RTN","PSJLIVFD",79,0)
 I $G(PSGRDTX(+PSJORD,"PSGRFD")) S PSGRFD=PSGRDTX(+PSJORD,"PSGRFD"),PSGRFDN=$$ENDTC^PSGMI(PSGRFD) D
"RTN","PSJLIVFD",80,0)
 . D DSPLYDT^PSJLIVMD(PSJLMX+7,.PSGRFD,.PSGRFDN," Calc Stop: ",0,51,29)
"RTN","PSJLIVFD",81,0)
 D:($G(PSJBCMA)]"")!($G(PSGRFD)]"") SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",82,0)
SCH ;
"RTN","PSJLIVFD",83,0)
 S PSJL="" D FLDNO^PSJLIUTL("(7)",1)
"RTN","PSJLIVFD",84,0)
 S PSJL=$$SETSTR^VALM1("Schedule:",PSJL,12,11)
"RTN","PSJLIVFD",85,0)
 D LONG^PSJLIUTL(P(9)_$S(P(7):"@0 labels a day",1:"")_$G(SCHMSG),22,35)
"RTN","PSJLIVFD",86,0)
LASTFL ;
"RTN","PSJLIVFD",87,0)
 S PSJL=$$SETSTR^VALM1("Last Fill:",PSJL,52,11)
"RTN","PSJLIVFD",88,0)
 S PSJL=PSJL_$$ENDTC^PSGMI(P("LF"))
"RTN","PSJLIVFD",89,0)
 D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",90,0)
ADM ;
"RTN","PSJLIVFD",91,0)
 S PSJL="" D FLDNO^PSJLIUTL("(8)",1)
"RTN","PSJLIVFD",92,0)
 S PSJL=$$SETSTR^VALM1("Admin Times:",PSJL,9,14)
"RTN","PSJLIVFD",93,0)
 D LONG^PSJLIUTL(P(11),22,30)
"RTN","PSJLIVFD",94,0)
QTY ;
"RTN","PSJLIVFD",95,0)
 S PSJL=$$SETSTR^VALM1("Quantity:",PSJL,53,10)_+P("LFA")
"RTN","PSJLIVFD",96,0)
 D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",97,0)
PROVIDER ;
"RTN","PSJLIVFD",98,0)
 S PSJL="" D FLDNO^PSJLIUTL("(9)",1)
"RTN","PSJLIVFD",99,0)
 S PSJL=$$SETSTR^VALM1("Provider:",PSJL,12,10)_$$PROVIDER^PSJLIUTL
"RTN","PSJLIVFD",100,0)
CUMDOSES ;
"RTN","PSJLIVFD",101,0)
 S PSJL=$$SETSTR^VALM1("Cum. Doses:",PSJL,51,12)_P("CUM")
"RTN","PSJLIVFD",102,0)
 D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",103,0)
OPI ;
"RTN","PSJLIVFD",104,0)
 N PSJOPILN,PSJOPCNT
"RTN","PSJLIVFD",105,0)
 S PSJL="" D FLDNO^PSJLIUTL("(10)",1)
"RTN","PSJLIVFD",106,0)
 I $G(PSIVBR)["PSIVVW" D
"RTN","PSJLIVFD",107,0)
 .S PSJOPILN=$$GETSIOPI^PSJBCMA5(DFN,PSJORD,1)
"RTN","PSJLIVFD",108,0)
 .I PSJOPILN=1,($TR($G(^TMP("PSJBCMA5",$J,DFN,PSJORD,1))," ")="") K ^TMP("PSJBCMA5",$J,DFN,PSJORD) S PSJOPILN=""
"RTN","PSJLIVFD",109,0)
 .S PSJL=$$SETSTR^VALM1("Other Print"_$S($P(P("OPI"),"^",2)=1:"!: ",1:": "),PSJL,9,13)
"RTN","PSJLIVFD",110,0)
 .S PSJL=PSJL_" "_$S(($G(PSJOPILN)>0):"(see below)",1:"")
"RTN","PSJLIVFD",111,0)
 .D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",112,0)
 .I (PSJOPILN>0) N PSJOPCNT S PSJOPCNT=0 F PSJOPCNT=1:1:PSJOPILN S PSJL="     "_$G(^TMP("PSJBCMA5",$J,DFN,PSJORD,PSJOPCNT)) D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",113,0)
 I $G(PSIVBR)'["PSIVVW" D
"RTN","PSJLIVFD",114,0)
 .I $G(ON55)["P",$G(PSJORD)["V",$P($G(^PS(53.1,+ON55,0)),"^",25)=PSJORD S PSJOPILN=$$GETSIOPI^PSJBCMA5(DFN,ON55)
"RTN","PSJLIVFD",115,0)
 .S PSJOPILN=$P($G(^PS(53.45,PSJSYSP,6,0)),"^",3) I 'PSJOPILN S PSJOPILN=$$GETSIOPI^PSJBCMA5(DFN,PSJORD)
"RTN","PSJLIVFD",116,0)
 .I PSJOPILN=1,($TR($G(^PS(53.45,PSJSYSP,6,1,0))," ")="") I '($G(^PS(53.45,PSJSYSP,6,0))<0) K ^PS(53.45,PSJSYSP,6) S PSJOPILN=""
"RTN","PSJLIVFD",117,0)
 .S PSJL=$$SETSTR^VALM1("Other Print"_$S($P(P("OPI"),"^",2)=1:"!: ",1:": "),PSJL,9,13)
"RTN","PSJLIVFD",118,0)
 .S PSJL=PSJL_$S((PSJOPILN>0)&'($G(^PS(53.45,PSJSYSP,6,0))<0):"(see below)",1:"")
"RTN","PSJLIVFD",119,0)
 .D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",120,0)
 .I PSJOPILN>0 N PSJOPCNT S PSJOPCNT=0 F PSJOPCNT=1:1:PSJOPILN S PSJL="     "_$G(^PS(53.45,PSJSYSP,6,PSJOPCNT,0)) D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",121,0)
 K PSJOPILN,PSJOPCNT K PSJOPILN,PSJOPCNT
"RTN","PSJLIVFD",122,0)
PC ;
"RTN","PSJLIVFD",123,0)
 S PSJL=""
"RTN","PSJLIVFD",124,0)
 S PSJL=$$SETSTR^VALM1("Provider Comments:",PSJL,3,18) D WTPC^PSJLIUTL
"RTN","PSJLIVFD",125,0)
REMARK ;
"RTN","PSJLIVFD",126,0)
 D SETTMP^PSJLMPRU("PSJI","")
"RTN","PSJLIVFD",127,0)
 S PSJL="" D FLDNO^PSJLIUTL("(11)",1)
"RTN","PSJLIVFD",128,0)
 S PSJL=$$SETSTR^VALM1("Remarks :",PSJL,8,10)
"RTN","PSJLIVFD",129,0)
 D LONG^PSJLIUTL(P("REM"),18,62)
"RTN","PSJLIVFD",130,0)
 D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",131,0)
IVROOM ;
"RTN","PSJLIVFD",132,0)
 S PSJL=""
"RTN","PSJLIVFD",133,0)
 S PSJL=$$SETSTR^VALM1("IV Room:",PSJL,9,9)_$P(P("IVRM"),U,2)
"RTN","PSJLIVFD",134,0)
 D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",135,0)
ENTRY ;
"RTN","PSJLIVFD",136,0)
 S PSJL="",PSJL=$$SETSTR^VALM1("Entry By:",PSJL,8,10)
"RTN","PSJLIVFD",137,0)
 S PSJL=PSJL_$S($P(P("CLRK"),U,2)]"":$E($P(P("CLRK"),U,2),1,18),1:"*** Undefined")
"RTN","PSJLIVFD",138,0)
 S PSJL=$$SETSTR^VALM1("Entry Date:",PSJL,51,12)_$$ENDTC^PSGMI(P("LOG"))
"RTN","PSJLIVFD",139,0)
 D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",140,0)
 S PSJL="" S PSGLRN=$$LASTRNBY^PSJLMPRI(DFN,$S($G(PSJORD):PSJORD,1:$G(ON))) I PSGLRN D
"RTN","PSJLIVFD",141,0)
 . S PSJL=$$SETSTR^VALM1("Renewed By: ",PSJL,6,12)_$$ENNPN^PSGMI(PSGLRN) D SETTMP^PSJLMPRU("PSJI",PSJL) K PSGLRN
"RTN","PSJLIVFD",142,0)
 S VALM("TITLE")=$$CODES^PSIVUTL(P(17),$S($G(ON)["P":53.1,1:55.01),$S(ON["P":28,1:100))_" IV "
"RTN","PSJLIVFD",143,0)
 I $G(P("PRY"))="D"!($G(P("PON"))["P") S VALM("TITLE")=VALM("TITLE")_$S($G(P("PRY"))="":"",1:"("_$$CODES^PSIVUTL(P("PRY"),53.1,.24)_")")
"RTN","PSJLIVFD",144,0)
 I $G(P("PON"))["P" D ORDCHK
"RTN","PSJLIVFD",145,0)
 S VALMCNT=PSJLN-1,^TMP("PSJI",$J,0)=VALMCNT
"RTN","PSJLIVFD",146,0)
 Q
"RTN","PSJLIVFD",147,0)
 ;
"RTN","PSJLIVFD",148,0)
ORDCHK ;Display order check for pending order
"RTN","PSJLIVFD",149,0)
 Q:'$O(^PS(53.1,+ON,10,0))
"RTN","PSJLIVFD",150,0)
 NEW PSJIVX,PSJIVXX
"RTN","PSJLIVFD",151,0)
 F PSJIVX=0:0 S PSJIVX=$O(^PS(53.1,+ON,10,PSJIVX)) Q:'PSJIVX  D
"RTN","PSJLIVFD",152,0)
 . D SETTMP^PSJLMPRU("PSJI","")
"RTN","PSJLIVFD",153,0)
 . S PSJL="CPRS Order Checks  :" D LONG^PSJLIUTL($G(^PS(53.1,+ON,10,PSJIVX,0)),22,58)
"RTN","PSJLIVFD",154,0)
 . D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",155,0)
 . S PSJL="Overriding Provider: "_$P($G(^PS(53.1,+ON,10,PSJIVX,1)),U)
"RTN","PSJLIVFD",156,0)
 . D SETTMP^PSJLMPRU("PSJI",PSJL)
"RTN","PSJLIVFD",157,0)
 . S PSJL="Overriding Reason  : "
"RTN","PSJLIVFD",158,0)
 . F PSJIVXX=0:0 S PSJIVXX=$O(^PS(53.1,+ON,10,PSJIVX,2,PSJIVXX)) Q:'PSJIVXX  D
"RTN","PSJLIVFD",159,0)
 .. D LONG^PSJLIUTL($G(^PS(53.1,+ON,10,PSJIVX,2,PSJIVXX,0)),22,58)
"RTN","PSJLIVFD",160,0)
 .. D SETTMP^PSJLMPRU("PSJI",PSJL) S PSJL=""
"RTN","PSJLIVFD",161,0)
 Q
"RTN","PSJLIVFD",162,0)
 ;
"RTN","PSJLIVFD",163,0)
SCHREQ(IVAR) ; Intermittent IV's require a schedule
"RTN","PSJLIVFD",164,0)
 I $G(IVAR(4))="P"!($G(IVAR(23))="P")!($G(IVAR(5))) Q 1
"RTN","PSJLIVFD",165,0)
 Q 0
"RTN","PSJLIVFD",166,0)
 ;
"RTN","PSJLIVFD",167,0)
INFCHK(INFFULL,INFEXP) ; Parse and expand infusion rate
"RTN","PSJLIVFD",168,0)
 ;*305
"RTN","PSJLIVFD",169,0)
 Q:INFFULL=""
"RTN","PSJLIVFD",170,0)
 S INFEXP=INFFULL
"RTN","PSJLIVFD",171,0)
 N I S I=$O(^PS(53.47,"B",INFFULL,0)) Q:'I  S:$P($G(^PS(53.47,I,0)),"^",2)]"" INFEXP=$P(^(0),"^",2)
"RTN","PSJLIVFD",172,0)
 Q
"RTN","PSJLIVFD",173,0)
INFEXP(INF) ; Expand Infusion Rate 
"RTN","PSJLIVFD",174,0)
 I $L(INF)<1!($L(INF)>30) Q INF
"RTN","PSJLIVFD",175,0)
 N INFIEN,ARRAY
"RTN","PSJLIVFD",176,0)
 S (INFIEN,ARRAY)=""
"RTN","PSJLIVFD",177,0)
 N X,Y,DIC,DR,DA,DIQ
"RTN","PSJLIVFD",178,0)
 S X=INF,DIC(0)="XO",DIC="^PS(53.47," D ^DIC I '($G(Y)>0) Q INF
"RTN","PSJLIVFD",179,0)
 S INFIEN=+$G(Y)
"RTN","PSJLIVFD",180,0)
 D GETS^DIQ(53.47,INFIEN_",",".01;1","E","ARRAY")
"RTN","PSJLIVFD",181,0)
 I $G(ARRAY("53.47",INFIEN_",","1","E"))]"" Q ARRAY("53.47",INFIEN_",","1","E")
"RTN","PSJLIVFD",182,0)
 Q INF
"RTN","PSJLMGUD")
0^10^B31538493
"RTN","PSJLMGUD",1,0)
PSJLMGUD ;BIR/MLM-INITIALIZE UNIT DOSE ORDER FIELDS FOR DISPLAY ;05 Feb 99 / 9:46 AM
"RTN","PSJLMGUD",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**25,58,85,116,110,111,267,275,315,256**;16 DEC 97;Build 34
"RTN","PSJLMGUD",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSJLMGUD",4,0)
 ; Reference to ^PS(51.2 is supported by DBIA 2178
"RTN","PSJLMGUD",5,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192 
"RTN","PSJLMGUD",6,0)
 ; Reference to ^PS(55   is supported by DBIA 2191
"RTN","PSJLMGUD",7,0)
 ; Reference to ES^ORX8 is supported by DBIA 3632
"RTN","PSJLMGUD",8,0)
 ;
"RTN","PSJLMGUD",9,0)
GETUD(DFN,PSGORD) ;
"RTN","PSJLMGUD",10,0)
 ;
"RTN","PSJLMGUD",11,0)
EN2 ;
"RTN","PSJLMGUD",12,0)
 N %X,%Y,ND2,ND2P1,DO,DRGI,FD,FL,FQC,NF,ND,PRI,SD,SIG,ST,STD,X,Y,ESIG ;*315
"RTN","PSJLMGUD",13,0)
 K GMRAL,P
"RTN","PSJLMGUD",14,0)
 S NF=$S(PSGORD["U":0,PSGORD["A":0,PSGORD["O":0,1:1) I NF,$D(^PS(53.1,+PSGORD,0)),$P(^(0),"^",19),$D(^PS(55,DFN,5,$P(^(0),"^",19))),(+$P(^(0),"^",19)'=+$P(^(0),"^",25)) S PSGORD=+$P(^PS(53.1,+PSGORD,0),"^",19)_"U",NF=0
"RTN","PSJLMGUD",15,0)
 S (FL,Y)="",$P(FL,"-",71)="",PSGOEEWF="^PS("_$S(NF:"53.1,",1:"55,"_DFN_",5,")_+PSGORD_","
"RTN","PSJLMGUD",16,0)
 ; The naked reference on the line below refers to the full reference created by indirect reference to F, where F may refer to ^PS(53.1 or the IV or UD multiple ^PS(55
"RTN","PSJLMGUD",17,0)
 S ND=$G(@(PSGOEEWF_"0)")),ND2=$G(^(2)),ND2P1=$G(^(2.1)),PSGEB=$P($G(^(4)),"^",7),PSGOSI=$G(^(6)),SIG=$G(^(6.5)),DO=$G(^(.2)),PSGOINST=$G(^(.3)),ESIG=$P(DO,U,3),PSG14=$P($G(^(14,0)),"^",3) ;*315
"RTN","PSJLMGUD",18,0)
 I PSG14 S PSGLRN=$G(@(PSGOEEWF_"14,"_PSG14_",0)"))
"RTN","PSJLMGUD",19,0)
 S PSGOPD=+DO,PSGODO=$P(DO,U,2),PSGOPDN=$$OINAME^PSJLMUTL(+DO),X=$P(DO,U,4),PSGPRIO=$P("STAT^ASAP^ROUTINE^PREOP^TIME CRITICAL^DONE",U,$F("SARPTD",X)-1),PSJPRI=X
"RTN","PSJLMGUD",20,0)
 S PSGOPR=$P(ND,"^",2),PSGOMR=$P(ND,"^",3),PSGOSM=$P(ND,"^",5),PSGOHSM=$P(ND,"^",6),(PSGOST,ST)=$P(ND,"^",7),STT=$P(ND,"^",9),PSGOMRN=$S('PSGOMR:"",1:$P($G(^PS(51.2,PSGOMR,0)),"^")) S:PSGOMRN="" PSGOMRN=PSGOMR
"RTN","PSJLMGUD",21,0)
 S PSGLI=$P(ND,U,16),PSGOSCH=$P(ND2,"^"),(PSGOSD,SD)=$P(ND2,"^",2),(FD,PSGOFD)=$P(ND2,"^",4),(FQC,PSGS0XT)=$P(ND2,"^",6),(PSGOAT,PSGS0Y)=$P(ND2,"^",5)
"RTN","PSJLMGUD",22,0)
 S:ND2P1]"" PSGDUR=$P(ND2P1,U,1),PSGRMVT=$P(ND2P1,U,2),PSGRMV=$P(ND2P1,U,3),PSGRF=$P(ND2P1,U,4) ;*315
"RTN","PSJLMGUD",23,0)
 S PSGLIN=$$ENDD^PSGMI(PSGLI)_U_$$ENDTC^PSGMI(PSGLI)
"RTN","PSJLMGUD",24,0)
 S PRI=$S('PSGOPR:0,1:$P($G(^VA(200,PSGOPR,"PS")),"^",4)),DRGI=$S(PSGOPD'=+PSGOPD:0,1:+$G(^PSDRUG(+PSGOPD,"I"))) S:PRI PRI=DT'<PRI S:DRGI DRGI=DT'<DRGI
"RTN","PSJLMGUD",25,0)
 S PSGOPRN=$S('PSGOPR:"",1:$P($G(^VA(200,PSGOPR,0)),"^")) S:PSGOPRN="" PSGOPRN=PSGOPR I PSGOSI]"" S PSGOSI=$$ENSET^PSGSICHK(PSGOSI)
"RTN","PSJLMGUD",26,0)
 I $L($T(ES^ORX8)) N ESIG1 S ESIG1=$$ES^ORX8(+$P(ND,U,21)_";1") S:ESIG1=1 ESIG="ES"
"RTN","PSJLMGUD",27,0)
 S PSGOPRN=PSGOPRN_$S(ESIG]"":" ["_$$LOW^XLFSTR(ESIG)_"]",1:"")
"RTN","PSJLMGUD",28,0)
 S PSGEBN=$$ENNPN^PSGMI(PSGEB) S:$P(ND,U,27)="R" STT="R"
"RTN","PSJLMGUD",29,0)
 S X=STT,PSGSTAT=$S(X="":"NOT FOUND",X="DE":"DISCONTINUED (EDIT)",X="DR":"DISCONTINUED (RENEWAL)",X="RE":"REINSTATED",1:$P(X_"^ACTIVE^DISCONTINUED^EXPIRED^HOLD^INCOMPLETE^NON-VERIFIED^PENDING^RENEWED^UNRELEASED","^",$F("ADEHINPRU",X)))
"RTN","PSJLMGUD",30,0)
 ;
"RTN","PSJLMGUD",31,0)
SET ;
"RTN","PSJLMGUD",32,0)
 I STT="P" S (FD,SD,ST)=""
"RTN","PSJLMGUD",33,0)
 S PSGOSTN=$$ENSTN^PSGMI(ST),(PSGOFDN,PSGOSDN)="" I SD S PSGOSDN=$$ENDD^PSGMI(SD)_"^"_$$ENDTC^PSGMI(SD)
"RTN","PSJLMGUD",34,0)
 I FD S PSGOFDN=$$ENDD^PSGMI(FD)_"^"_$$ENDTC^PSGMI(FD)
"RTN","PSJLMGUD",35,0)
 F X="PD","PDN","MR","MRN","ST","STN","SCH","SI","SD","SDN","FD","FDN","SM","HSM","PR","PRN","DO","AT" S @("PSG"_X)=@("PSGO"_X)
"RTN","PSJLMGUD",36,0)
 K ^PS(53.45,PSJSYSP,1),^(2),^(5),^(6) S %X=PSGOEEWF_"3,",%Y="^PS(53.45,"_PSJSYSP_",1," D %XY^%RCR S %X=PSGOEEWF_"1,",%Y="^PS(53.45,"_PSJSYSP_",2," D %XY^%RCR
"RTN","PSJLMGUD",37,0)
 S $P(^PS(53.45,PSJSYSP,2,0),"^",2)="53.4502P"
"RTN","PSJLMGUD",38,0)
 K PSJNSS I $G(PSGSCH)'="" D  K PSJNSS
"RTN","PSJLMGUD",39,0)
 . N PSGS0XTO,Y,PSGOES S X=PSGSCH S PSGS0XTO=PSGS0XT N PSGOSCH S PSGOSCH=PSGSCH S PSGSCH="",PSGOES=1
"RTN","PSJLMGUD",40,0)
 . ;D ENOS^PSGS0 S:$G(X)="" PSGS0XT=PSGS0XTO S PSGSCH=$S($G(X)]""&($G(PSGS0XT)="D"):X,1:PSGOSCH) ;PSJ*5*256
"RTN","PSJLMGUD",41,0)
 . D ENOS^PSGS0 S:$G(X)="" PSGS0XT=PSGS0XTO S PSGSCH=PSGOSCH
"RTN","PSJLMGUD",42,0)
 Q
"RTN","PSJLMGUD",43,0)
 ;
"RTN","PSJLMGUD",44,0)
FINISH ;
"RTN","PSJLMGUD",45,0)
 I '$G(PSGS0XT),PSGOSCH]"" D  S $P(^PS(53.1,+PSGORD,2),"^",6)=PSGS0XT
"RTN","PSJLMGUD",46,0)
 .N PSGOES,PSGS0Y S X=PSGOSCH,PSGOES=1 D ENOS^PSGS0
"RTN","PSJLMGUD",47,0)
 S PSGOEFF=PSGOSCH=""+('$O(^PS(53.45,PSJSYSP,2,0))*10) I PSGOEFF S X=$S(PSGOEFF#2:" a SCHEDULE",1:"")_$S(PSGOEFF=11:" and",1:"")_$S(PSGOEFF>9:" at least one DISPENSE DRUG",1:"")_" before it can be finished."
"RTN","PSJLMGUD",48,0)
 I PSGOEFF W $C(7),!!,"PLEASE NOTE: This order must have" F Q=1:1:$L(X," ") S Y=$P(X," ",Q) W:$L(Y)+$X>78 ! W Y," "
"RTN","PSJLMGUD",49,0)
 I PSGOEFF#2 S F1=53.1,MSG=0,Y=$T(35),@("PSGFN(35)="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))=1,(PSGOEE,PSGOEEF)=1 W ! D @$P($T(35),";",3) G:'PSGOEE DONE
"RTN","PSJLMGUD",50,0)
 I PSGOEFF>9 S CHK=7 D ENDRG^PSGOEF1(PSGOPD,0) G:CHK DONE
"RTN","PSJLMGUD",51,0)
 I $G(MSG) K DIR S DIR(0)="E" W !! D ^DIR
"RTN","PSJLMGUD",52,0)
 I PSGOEFF D:PSGST="" GTST^PSGOE6(+PSGORD) N XQORM D EN^VALM("PSJ LM OE DISPLAY") G DONE ;D ENW^PSGOEEW
"RTN","PSJLMGUD",53,0)
 ;
"RTN","PSJLMGUD",54,0)
ACCEPT ;
"RTN","PSJLMGUD",55,0)
 D UPD^PSGOEF1 G DONE
"RTN","PSJLMGUD",56,0)
BYPASS ;
"RTN","PSJLMGUD",57,0)
 S PSGCANFL=1 G DONE
"RTN","PSJLMGUD",58,0)
 ;
"RTN","PSJLMGUD",59,0)
EDIT ;    
"RTN","PSJLMGUD",60,0)
 S PSGPDRG=PSGOPD,PSGPDRGN=PSGOPDN K PSGOEEND D ENF^PSGOEE I PSGCANFL=-1 D UPD^PSGOEF1
"RTN","PSJLMGUD",61,0)
 ;
"RTN","PSJLMGUD",62,0)
DONE ;
"RTN","PSJLMGUD",63,0)
 K CHK,DA,DIE,DR,DRG,MSG,ORETURN,ORIFN,PSGEB,PSGEFN,PSGND,PSGOEE,PSGOEEF,PSGOEEND,PSGOEEG,PSGOEF,PSGOEFF,PSGOES,PSGOPD,PSGOPDN,PSGOPR,PSGOSCH,PSGPDRG,PSGDRGN,PSG0XT,PSGS0Y,OSGSD,Q1,Q2
"RTN","PSJLMGUD",64,0)
 K PSGDUR,PSGRMV,PSGRMVT ;*315
"RTN","PSJLMGUD",65,0)
 Q
"RTN","PSJLMGUD",66,0)
 ;
"RTN","PSJLMGUD",67,0)
 ;
"RTN","PSJLMGUD",68,0)
31 ;;101^PSGOE8;PSGOPD;PSGPD;101;1
"RTN","PSJLMGUD",69,0)
32 ;;109^PSGOE8;PSGODO;PSGDO;102;PSGODO]""
"RTN","PSJLMGUD",70,0)
33 ;;3^PSGOE8;PSGOMR;PSGMR;3;1
"RTN","PSJLMGUD",71,0)
34 ;;7^PSGOE8;PSGOST;PSGST;7;0
"RTN","PSJLMGUD",72,0)
35 ;;26^PSGOE8;PSGOSCH;PSGSCH;26;1
"RTN","PSJLMGUD",73,0)
36 ;;39^PSGOE81;PSGOAT;PSGAT;39;0
"RTN","PSJLMGUD",74,0)
37 ;;1^PSGOE82;PSGOPR;PSGPR;1;1
"RTN","PSJLMGUD",75,0)
38 ;;8^PSGOE81;PSGOSI;PSGSI;8;0
"RTN","PSJLMGUD",76,0)
39 ;;2^PSGOE82;;;2;0
"RTN","PSJLMGUD",77,0)
310 ;;40^PSGOE82;;;40;0
"RTN","PSJLMGUD",78,0)
311 ;;66^PSGOE82;;;66;1
"RTN","PSJLMGUD",79,0)
312 ;;10^PSGOE81;PSGOSD;PSGSD;10;0
"RTN","PSJLMGUD",80,0)
313 ;;25^PSGOE81;PSGOFD;PSGFD;25;0
"RTN","PSJLMGUD",81,0)
314 ;;5^PSGOE82;PSGOSM;PSGSM;5;0
"RTN","PSJLMGUD",82,0)
 ;
"RTN","PSJLMGUD",83,0)
AH ;
"RTN","PSJLMGUD",84,0)
 W !!?2,"Answer 'YES' to accept this order as a NON-VERIFIED UNIT DOSE order.  Answer",!,"'NO' to edit this order now.  Enter '^' to BYPASS this order, leaving it as",!,"a PENDING INPATIENT order."
"RTN","PSJLMGUD",85,0)
 Q
"RTN","PSJLMHED")
0^20^B63213228
"RTN","PSJLMHED",1,0)
PSJLMHED ;BIR/MLM - BUILD LM HEADERS ; 8/6/14 11:00am
"RTN","PSJLMHED",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**4,58,85,110,148,181,260,275,331,256**;16 DEC 97;Build 34
"RTN","PSJLMHED",3,0)
 ;
"RTN","PSJLMHED",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJLMHED",5,0)
 ; Reference to $$CWAD^ORQPT2 is supported by DBIA 2831.
"RTN","PSJLMHED",6,0)
 ; Reference to ^SC( is supported by DBIA 10040.
"RTN","PSJLMHED",7,0)
 ; External reference to $$BSA^PSSDSAPI supported by DBIA 5425.
"RTN","PSJLMHED",8,0)
 ; External reference to ^ORQQVI supported by DBIA 5770.
"RTN","PSJLMHED",9,0)
 ; External reference to ^ORB31 supported by DBIA 5140.
"RTN","PSJLMHED",10,0)
 ; External reference to ^ORQQLR1 supported by DBIA 5787.
"RTN","PSJLMHED",11,0)
 ;
"RTN","PSJLMHED",12,0)
HDR(DFN) ; -- list screen header
"RTN","PSJLMHED",13,0)
 ;   input:       DFN := ifn of pat
"RTN","PSJLMHED",14,0)
 ;  output:  VALMHDR() := hdr array
"RTN","PSJLMHED",15,0)
 ;
"RTN","PSJLMHED",16,0)
 K VAIN,VADM,GMRA,PSJACNWP,PSJ,VAERR,VA,X
"RTN","PSJLMHED",17,0)
 S PSJACNWP=1 D ENBOTH^PSJAC
"RTN","PSJLMHED",18,0)
 D HDRO(DFN)
"RTN","PSJLMHED",19,0)
 S PSJ="   Sex: "_$P(PSJPSEX,U,2),VALMHDR(4)=$$SETSTR^VALM1($S(PSJPDD:"Last ",1:"     ")_"Admitted: "_$P(PSJPAD,U,2),PSJ,45,23)
"RTN","PSJLMHED",20,0)
 S PSJ="    Dx: "_PSJPDX
"RTN","PSJLMHED",21,0)
 S:PSJPDD VALMHDR(5)=$$SETSTR^VALM1("Discharged: "_$E($P(PSJPDD,U,2),1,8),PSJ,48,26)
"RTN","PSJLMHED",22,0)
 S:'PSJPDD VALMHDR(5)=$$SETSTR^VALM1("Last transferred: "_$$ENDTC^PSGMI(PSJPTD),PSJ,42,26)
"RTN","PSJLMHED",23,0)
 ;
"RTN","PSJLMHED",24,0)
 ;  Display CrCl/BSA - show serum creatinine if CrCl can't be calculated
"RTN","PSJLMHED",25,0)
 S PSJBSA=$$BSA^PSSDSAPI(DFN),PSJBSA=$P(PSJBSA,"^",3),PSJBSA=$S(PSJBSA'>0:"__________",1:$J(PSJBSA,4,2))
"RTN","PSJLMHED",26,0)
 ; RSLT -- DATE^CRCL^Serum Creatinine -- Ex.  11/25/11^68.7^1.1
"RTN","PSJLMHED",27,0)
 S RSLT=$$CRCL(DFN)
"RTN","PSJLMHED",28,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)<.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_" (CREAT: Not Found)"
"RTN","PSJLMHED",29,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"  (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSJLMHED",30,0)
 I ($P($G(RSLT),"^",2)>0)&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"(est.)"_" (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSJLMHED",31,0)
 S PSJDB=$G(ZDSPL),VALMHDR(6)=$$SETSTR^VALM1("BSA (m2): "_$G(PSJBSA),PSJDB,50,23) K PSJBSA,RSLT,ZDSPL
"RTN","PSJLMHED",32,0)
 Q
"RTN","PSJLMHED",33,0)
 ; 
"RTN","PSJLMHED",34,0)
HDRO(DFN) ; Standardized part of profile header.
"RTN","PSJLMHED",35,0)
 N PSJCLIN,PSJAPPT,PSJCLINN,RMORDT S (PSJCLIN,PSJAPPT)=0,(RMORDAT,PSJCLINN)="" I $G(PSJORD) D
"RTN","PSJLMHED",36,0)
 . S PSJCLIN=$S($G(PSJORD)["V":$G(^PS(55,DFN,"IV",+PSJORD,"DSS")),$G(PSJORD)["U":$G(^PS(55,DFN,5,+PSJORD,8)),$G(PSJORD)["P":$G(^PS(53.1,+PSJORD,"DSS")),1:"")
"RTN","PSJLMHED",37,0)
 . S:PSJCLIN PSJAPPT=$P($G(PSJCLIN),U,2) S:'PSJAPPT PSJCLIN="" I PSJCLIN,PSJAPPT S PSJCLINN=$P($G(^SC(+PSJCLIN,0)),U)
"RTN","PSJLMHED",38,0)
 K VALMHDR I PSJCLINN]"" S PSJ=VADM(1),PSJ=$$SETSTR^VALM1("   Clinic: "_PSJCLINN,PSJ,28,26)
"RTN","PSJLMHED",39,0)
 I PSJCLINN="" S PSJ=VADM(1),PSJ=$$SETSTR^VALM1($S('PSJPDD:"     ",1:"Last ")_"Ward: "_PSJPWDN,PSJ,30,18)
"RTN","PSJLMHED",40,0)
 S X=$$CWAD^ORQPT2(DFN)
"RTN","PSJLMHED",41,0)
 S:X]"" X=IORVON_X_IORVOFF,PSJ=$$SETSTR^VALM1(X,PSJ,80-$L(X),80) S VALMHDR(1)=PSJ
"RTN","PSJLMHED",42,0)
 S PSJ="   PID: "_$P(PSJPSSN,U,2)
"RTN","PSJLMHED",43,0)
 S RMORDT=$S($G(PSJPDD):"Last ",1:"     ")_"Room-Bed: "_$G(PSJPRB)
"RTN","PSJLMHED",44,0)
 I PSJCLINN]"",PSJAPPT S RMORDT="Clinic Date: "_$$ENDTC^PSGMI(PSJAPPT),RMORDT=$P(RMORDT,"  ")_" "_$P(RMORDT,"  ",2)
"RTN","PSJLMHED",45,0)
 S PSJ=$$SETSTR^VALM1(RMORDT,PSJ,26,28),VALMHDR(2)=$$SETSTR^VALM1("Ht(cm): "_PSJPHT_" "_PSJPHTD,PSJ,55,25)
"RTN","PSJLMHED",46,0)
 S PSJ="   DOB: "_$P($P(PSJPDOB,U,2)," ")_" ("_PSJPAGE_")",VALMHDR(3)=$$SETSTR^VALM1("Wt(kg): "_PSJPWT_" "_PSJPWTD,PSJ,55,25)
"RTN","PSJLMHED",47,0)
 Q
"RTN","PSJLMHED",48,0)
 ;
"RTN","PSJLMHED",49,0)
INIT(PSJPROT) ; -- init bld vars
"RTN","PSJLMHED",50,0)
 ; PSJPROT=1:UD ONLY; 2:IV ONLY; 3:BOTH
"RTN","PSJLMHED",51,0)
 K PSJUDPRF,^TMP("PSJ",$J),^TMP("PSJON",$J),^TMP("PSJPRO",$J)
"RTN","PSJLMHED",52,0)
 S:PSJPROT=1 PSJUDPRF=1
"RTN","PSJLMHED",53,0)
 D KILL^VALM10(),EN^PSJO1(PSJPROT)
"RTN","PSJLMHED",54,0)
 I '$D(^TMP("PSJ",$J)) W !!,?22,"NO ORDERS FOUND FOR "_$S(PSJOL="S":"SHORT",1:"LONG")_" PROFILE." S VALMQUIT=1 D PAUSE^PSJLMUTL Q
"RTN","PSJLMHED",55,0)
 S PSJTF=0,PSJLN=1,PSJEN=1,PSJC="" F  S PSJC=$O(^TMP("PSJ",$J,PSJC)) Q:PSJC=""!(PSJC["^")  D
"RTN","PSJLMHED",56,0)
 .S PSJF="^PS("_$S("AO"[PSJC:"55,"_PSGP_",5,",PSJC="DF":"55,"_PSGP_",5,",1:"53.1,")
"RTN","PSJLMHED",57,0)
 .I PSJTF'=$E(PSJC,1)!(PSJC="CC")!(PSJC="CD")!(PSJC="BD") Q:PSJC="CB"  Q:PSJC="O"  Q:PSJC="DF"  D TF S PSJTF=$E(PSJC,1)    ;DAM 8-29-07 Added Q:PSJC="CB"  Q:PSJC="O"
"RTN","PSJLMHED",58,0)
 .S PSJST="" F  S PSJST=$O(^TMP("PSJ",$J,PSJC,PSJST)) Q:PSJST=""  D
"RTN","PSJLMHED",59,0)
 ..S PSJS="" F  S PSJS=$O(^TMP("PSJ",$J,PSJC,PSJST,PSJS)) Q:PSJS=""  Q:PSJC="CB"  Q:PSJC="O"  Q:PSJC="DF"  D ON      ;DAM 8-29-07  Added Q:PSJC="CB"  Q:PSJC="O"
"RTN","PSJLMHED",60,0)
 .;
"RTN","PSJLMHED",61,0)
 .;DAM 8-29-07   New code to place Pending Orders after Pending Renewal Orders on the roll and scroll display.  Non-Active Orders appear last.
"RTN","PSJLMHED",62,0)
 S PSJTF=0,PSJC="" F  S PSJC=$O(^TMP("PSJ",$J,PSJC)) Q:PSJC=""  D
"RTN","PSJLMHED",63,0)
 . S PSJF="^PS("_$S("AO"[PSJC:"55,"_PSGP_",5,",PSJC="DF":"55,"_PSGP_",5,",1:"53.1,")
"RTN","PSJLMHED",64,0)
 . I PSJC="CB" D TF S PSJTF=$E(PSJC,1)                            ;These are Pending Orders
"RTN","PSJLMHED",65,0)
 . I PSJC="CB" S PSJST="" F  S PSJST=$O(^TMP("PSJ",$J,PSJC,PSJST)) Q:PSJST=""  D
"RTN","PSJLMHED",66,0)
 . . S PSJS="" F  S PSJS=$O(^TMP("PSJ",$J,PSJC,PSJST,PSJS)) Q:PSJS=""   D ON
"RTN","PSJLMHED",67,0)
 . ;
"RTN","PSJLMHED",68,0)
 . I PSJC["Cz" D
"RTN","PSJLMHED",69,0)
 . . N PSJCLIN
"RTN","PSJLMHED",70,0)
 . . S PSJF="^PS("_$S("AO"[$P(PSJC,"^",4):"55,"_PSGP_",5,",$P(PSJC,"^",4)="DF":"55,"_PSGP_",5,",1:"53.1,")
"RTN","PSJLMHED",71,0)
 . . S PSJCLIN=$P(PSJC,"^",2) Q:PSJCLIN=""
"RTN","PSJLMHED",72,0)
 . . I ($P(PSJTF,"^",2)'=$P(PSJC,"^",2)) D TF S PSJTF=PSJC
"RTN","PSJLMHED",73,0)
 . . S PSJST="" F  S PSJST=$O(^TMP("PSJ",$J,PSJC,PSJST)) Q:PSJST=""  D
"RTN","PSJLMHED",74,0)
 . . . S PSJS="" F  S PSJS=$O(^TMP("PSJ",$J,PSJC,PSJST,PSJS)) Q:PSJS=""  D ON      ;DAM 8-29-07  Added Q:PSJC="CB"  Q:PSJC="O"
"RTN","PSJLMHED",75,0)
 . ;
"RTN","PSJLMHED",76,0)
 . I PSJC="DF" D TF S PSJTF=$E(PSJC,1)                              ;These are recently DC Orders (mv)
"RTN","PSJLMHED",77,0)
 . I PSJC="DF" S PSJST="" F  S PSJST=$O(^TMP("PSJ",$J,PSJC,PSJST)) Q:PSJST=""  D
"RTN","PSJLMHED",78,0)
 . . S PSJS="" F  S PSJS=$O(^TMP("PSJ",$J,PSJC,PSJST,PSJS)) Q:PSJS=""   D ON
"RTN","PSJLMHED",79,0)
 . I PSJC="O" D TF S PSJTF=$E(PSJC,1)                              ;These are Non-Active Orders
"RTN","PSJLMHED",80,0)
 . I PSJC="O" S PSJST="" F  S PSJST=$O(^TMP("PSJ",$J,PSJC,PSJST)) Q:PSJST=""  D
"RTN","PSJLMHED",81,0)
 . . S PSJS="" F  S PSJS=$O(^TMP("PSJ",$J,PSJC,PSJST,PSJS)) Q:PSJS=""   D ON
"RTN","PSJLMHED",82,0)
 .; END DAM changes
"RTN","PSJLMHED",83,0)
 .;
"RTN","PSJLMHED",84,0)
 S VALMCNT=PSJLN-1
"RTN","PSJLMHED",85,0)
DONE ;
"RTN","PSJLMHED",86,0)
 K PSJC,PSJEN,PSJLN,PSJST,PSJS,CNT,PSJPRI,PSJORD
"RTN","PSJLMHED",87,0)
 Q
"RTN","PSJLMHED",88,0)
 ;
"RTN","PSJLMHED",89,0)
ON ;
"RTN","PSJLMHED",90,0)
 S PSJSCHT=$S(PSJOS:PSJS,1:PSJST)
"RTN","PSJLMHED",91,0)
 S PSJO="" F FQ=0:0 S PSJO=$O(^TMP("PSJ",$J,PSJC,PSJST,PSJS,PSJO)) Q:PSJO=""  S DN=^(PSJO)   D
"RTN","PSJLMHED",92,0)
 .N PRJPRI S PSJPRI=$S(PSJO["V":$P($G(^PS(55,PSGP,"IV",+PSJO,.2)),"^",4),PSJO["U":$P($G(^PS(55,PSGP,5,+PSJO,.2)),"^",4),1:$P($G(^PS(53.1,+PSJO,.2)),"^",4))
"RTN","PSJLMHED",93,0)
 .S ^TMP("PSJON",$J,PSJEN)=PSJO,PSJL=$J(PSJEN,4) I ($P(PSJC,"^")="Cz") N PSJTMPJC S PSJTMPJC=PSJC N PSJC S PSJC=$P(PSJTMPJC,"^",4)
"RTN","PSJLMHED",94,0)
 .D @$S(PSJO["V":"PIV^PSJLMPRI(PSGP,PSJO,PSJF,DN)",PSJO["U":"PUD^PSJLMPRU(PSGP,PSJO,PSJF,DN)",1:"PIV^PSJLMPRI(PSGP,PSJO,PSJF,DN)") S ^TMP("PSJPRO",$J,0)=PSJEN,PSJEN=PSJEN+1
"RTN","PSJLMHED",95,0)
 Q
"RTN","PSJLMHED",96,0)
 ;
"RTN","PSJLMHED",97,0)
TF ; Set up order type header
"RTN","PSJLMHED",98,0)
 NEW PSJDFHDR
"RTN","PSJLMHED",99,0)
 I $D(^TMP("PSJ",$J,PSJC)) D
"RTN","PSJLMHED",100,0)
 .S PSJDCEXP=$$RECDCEXP^PSJP()
"RTN","PSJLMHED",101,0)
 .S PSJDFHDR="RECENTLY DISCONTINUED/EXPIRED (LAST "_+$G(PSJDCEXP)_" HOURS)"
"RTN","PSJLMHED",102,0)
 .N C,X,Y S C=PSJC,Y="",$P(Y," -",40)=""
"RTN","PSJLMHED",103,0)
 .S X=$S(($G(PSJCLIN)]""):$G(PSJCLIN),C="A":$$TXT^PSJO("A"),C["CC":$$TXT^PSJO("PR"),C["CD":$$TXT^PSJO("PC"),C["C":$$TXT^PSJO("P"),C["BD":$$TXT^PSJO("NC"),C["B":$$TXT^PSJO("N"),C["DF":PSJDFHDR,1:$$TXT^PSJO("NA"))
"RTN","PSJLMHED",104,0)
 .S ^TMP("PSJPRO",$J,PSJLN,0)=$E($E(Y,1,(80-$L(X))/2)_" "_X_$E(Y,1,(80-$L(X))/2),1,80),PSJLN=PSJLN+1
"RTN","PSJLMHED",105,0)
 Q
"RTN","PSJLMHED",106,0)
TEST ;
"RTN","PSJLMHED",107,0)
 N X,Y S Y="",$P(Y," -",40)=""
"RTN","PSJLMHED",108,0)
 F X="A C T I V E","P E N D I N G   R E N E W A L S","P E N D I N G ","N O N - V E R I F I E D","N O N - A C T I V E" W !,$E($E(Y,1,(80-$L(X))/2)_" "_X_$E(Y,1,(80-$L(X))/2),1,80)
"RTN","PSJLMHED",109,0)
 Q
"RTN","PSJLMHED",110,0)
CRCL(DFN) ;
"RTN","PSJLMHED",111,0)
 N HTGT60,ABW,IBW,BWRATIO,BWDIFF,LOWBW,ADJBW,X1,X2,RSLT,PSCR,PSRW,ABW,ZHT,PSRH,PSCXTL,PSCXTLS,SCR,SCRD,OCXT,OCXTS,SCRV,ZAGE,ZSERUM,SEX
"RTN","PSJLMHED",112,0)
 S RSLT="0^<Not Found>"
"RTN","PSJLMHED",113,0)
 S PSCR="^^^^^^0"
"RTN","PSJLMHED",114,0)
 S PSCXTL="" Q:'$$TERMLKUP^ORB31(.PSCXTL,"SERUM CREATININE") RSLT
"RTN","PSJLMHED",115,0)
 S PSCXTLS="" Q:'$$TERMLKUP^ORB31(.PSCXTLS,"SERUM SPECIMEN") RSLT
"RTN","PSJLMHED",116,0)
 S SCR="",OCXT=0 F  S OCXT=$O(PSCXTL(OCXT)) Q:'OCXT  D
"RTN","PSJLMHED",117,0)
 .S OCXTS=0 F  S OCXTS=$O(PSCXTLS(OCXTS)) Q:'OCXTS  D
"RTN","PSJLMHED",118,0)
 ..S SCR=$$LOCL^ORQQLR1(DFN,$P(PSCXTL(OCXT),U),$P(PSCXTLS(OCXTS),U))
"RTN","PSJLMHED",119,0)
 ..I $P(SCR,U,7)>$P(PSCR,U,7) S PSCR=SCR
"RTN","PSJLMHED",120,0)
 S SCR=PSCR,SCRV=$P(SCR,U,3) Q:+$G(SCRV)<.01 RSLT
"RTN","PSJLMHED",121,0)
 S SCRD=$P(SCR,U,7) Q:'$L(SCRD) RSLT
"RTN","PSJLMHED",122,0)
 S RSLT=SCRD_"^<Not Found>^"_$P($G(SCR),"^",3)
"RTN","PSJLMHED",123,0)
 S X1=$P(RSLT,"^"),X2=$$FMTE^XLFDT(X1,"2M"),$P(RSLT,"^")=$P(X2,"@") K X1,X2
"RTN","PSJLMHED",124,0)
 D VITAL^ORQQVI("WEIGHT","WT",DFN,.PSRW,0,"",$$NOW^XLFDT)
"RTN","PSJLMHED",125,0)
 Q:'$D(PSRW) RSLT
"RTN","PSJLMHED",126,0)
 S ABW=$P(PSRW(1),U,3) Q:+$G(ABW)<1 RSLT
"RTN","PSJLMHED",127,0)
 S ABW=ABW/2.20462262  ;ABW (actual body weight) in kg; changed 2.2 to 2.20462262 per CQ 10637 ; PSO 402
"RTN","PSJLMHED",128,0)
 D VITAL^ORQQVI("HEIGHT","HT",DFN,.PSRH,0,"",$$NOW^XLFDT)
"RTN","PSJLMHED",129,0)
 Q:'$D(PSRH) RSLT
"RTN","PSJLMHED",130,0)
 S ZHT=$P(PSRH(1),U,3) Q:+$G(ZHT)<1 RSLT
"RTN","PSJLMHED",131,0)
 N VADM D DEM^VADPT S ZAGE=$G(VADM(4)) Q:'$L(ZAGE) RSLT
"RTN","PSJLMHED",132,0)
 ;S ZAGE=$$AGE^ORQPTQ4(DFN) Q:'ZAGE RSLT
"RTN","PSJLMHED",133,0)
 S SEX=$P($G(VADM(5)),"^") Q:'$L(SEX) RSLT
"RTN","PSJLMHED",134,0)
 ;S SEX=$P($$SEX^ORQPTQ4(DFN),U,1) Q:'$L(SEX) RSLT
"RTN","PSJLMHED",135,0)
 I '$G(ABW)!($G(ZHT)<1)!'$G(ZAGE)!'$D(SEX) Q RSLT
"RTN","PSJLMHED",136,0)
 S SCRD=$P(SCR,U,7) Q:'$L(SCRD) RSLT
"RTN","PSJLMHED",137,0)
 S HTGT60=$S(ZHT>60:(ZHT-60)*2.3,1:0)  ;if ht > 60 inches
"RTN","PSJLMHED",138,0)
 I HTGT60>0 D
"RTN","PSJLMHED",139,0)
 .S IBW=$S(SEX="M":50+HTGT60,1:45.5+HTGT60)  ;Ideal Body Weight
"RTN","PSJLMHED",140,0)
 .S BWRATIO=(ABW/IBW)  ;body weight ratio
"RTN","PSJLMHED",141,0)
 .S BWDIFF=$S(ABW>IBW:ABW-IBW,1:0)
"RTN","PSJLMHED",142,0)
 .S LOWBW=$S(IBW<ABW:IBW,1:ABW)
"RTN","PSJLMHED",143,0)
 .I BWRATIO>1.3,(BWDIFF>0) S ADJBW=((0.3*BWDIFF)+IBW)
"RTN","PSJLMHED",144,0)
 .E  S ADJBW=LOWBW
"RTN","PSJLMHED",145,0)
 I +$G(ADJBW)<1 D
"RTN","PSJLMHED",146,0)
 .S ADJBW=ABW
"RTN","PSJLMHED",147,0)
 S CRCL=(((140-ZAGE)*ADJBW)/(SCRV*72))
"RTN","PSJLMHED",148,0)
 S:SEX="M" RSLT=SCRD_U_$J(CRCL,1,1)
"RTN","PSJLMHED",149,0)
 S:SEX="F" RSLT=SCRD_U_$J((CRCL*.85),1,1)
"RTN","PSJLMHED",150,0)
 S X1=$P(RSLT,"^"),X2=$$FMTE^XLFDT(X1,"2M"),$P(RSLT,"^")=$P(X2,"@") K X1,X2
"RTN","PSJLMHED",151,0)
 S $P(RSLT,"^",3)=$P($G(SCR),"^",3)
"RTN","PSJLMHED",152,0)
 K HTGT60,ABW,IBW,BWRATIO,BWDIFF,LOWBW,ADJBW,X1,X2,PSCR,PSRW,ABW,ZHT,PSRH,ZAGE,PSCXTL,PSCXTLS,SCR,OCXT,OCXTS,SCRV,CRCL,ZSERUM
"RTN","PSJLMHED",153,0)
 Q RSLT
"RTN","PSJMISC")
0^31^B83581332
"RTN","PSJMISC",1,0)
PSJMISC ;BIR/MV - MISC. SUB-ROUTINES ;03 Aug 98 / 8:42 AM
"RTN","PSJMISC",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**181,256**;16 DEC 97;Build 34
"RTN","PSJMISC",3,0)
 ;
"RTN","PSJMISC",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA# 2180.
"RTN","PSJMISC",5,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231.
"RTN","PSJMISC",6,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173.
"RTN","PSJMISC",7,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJMISC",8,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192.
"RTN","PSJMISC",9,0)
 ;
"RTN","PSJMISC",10,0)
GCN(PSJDD) ;Return GCNSEQNO for a dispense drug
"RTN","PSJMISC",11,0)
 ;PSJDD - IEN (file #50)
"RTN","PSJMISC",12,0)
 NEW PSJDDND,X
"RTN","PSJMISC",13,0)
 I '+$G(PSJDD) Q ""
"RTN","PSJMISC",14,0)
 S PSJDDND=$G(^PSDRUG(+PSJDD,"ND"))
"RTN","PSJMISC",15,0)
 I PSJDDND="" Q ""
"RTN","PSJMISC",16,0)
 S X=$$PROD0^PSNAPIS($P(PSJDDND,U),$P(PSJDDND,U,3))
"RTN","PSJMISC",17,0)
 Q $P(X,U,7)
"RTN","PSJMISC",18,0)
GTVUID(PSJDD) ;Return the VUID for a dispense drug
"RTN","PSJMISC",19,0)
 ;PSJDD - IEN (file #50)
"RTN","PSJMISC",20,0)
 NEW PSJND,PSJVUID,DIC
"RTN","PSJMISC",21,0)
 I '+$G(PSJDD) Q ""
"RTN","PSJMISC",22,0)
 S PSJVUID=""
"RTN","PSJMISC",23,0)
 S PSJND=$P($G(^PSDRUG(+PSJDD,"ND")),U,3)
"RTN","PSJMISC",24,0)
 I +PSJND S PSJVUID=$$GETVUID^XTID(50.68,,PSJND_",")
"RTN","PSJMISC",25,0)
 Q PSJVUID
"RTN","PSJMISC",26,0)
VAGEN(PSJDD) ;Return the VA GENERIC name
"RTN","PSJMISC",27,0)
 ;PSJDD - IEN (file #50)
"RTN","PSJMISC",28,0)
 NEW PSJIEN,PSJVAGEN
"RTN","PSJMISC",29,0)
 I '+$G(PSJDD) Q ""
"RTN","PSJMISC",30,0)
 S PSJIEN=+$G(^PSDRUG(PSJDD,"ND"))
"RTN","PSJMISC",31,0)
 D ZERO^PSN50P6(PSJIEN,,,,"PSJVAGEN")
"RTN","PSJMISC",32,0)
 S PSJVAGEN=$G(^TMP($J,"PSJVAGEN",PSJIEN,.01))
"RTN","PSJMISC",33,0)
 K ^TMP($J,"PSJVAGEN")
"RTN","PSJMISC",34,0)
 Q PSJVAGEN
"RTN","PSJMISC",35,0)
 ;
"RTN","PSJMISC",36,0)
GENVUID(PSJVUID) ;Return the VA GENERIC name
"RTN","PSJMISC",37,0)
 ;PSJVUID - #50.68
"RTN","PSJMISC",38,0)
 ;PSJRDIID - Array returning from ^XTID call
"RTN","PSJMISC",39,0)
 ;PSJNDF - #50.68 ien
"RTN","PSJMISC",40,0)
 ;GETIREF^XTID - will not return the .01 name if DIC is defined. 
"RTN","PSJMISC",41,0)
 I '+$G(PSJVUID) Q ""
"RTN","PSJMISC",42,0)
 NEW PSJNDF,PSJVAGEN,DIC
"RTN","PSJMISC",43,0)
 K PSJRDIID
"RTN","PSJMISC",44,0)
 S PSJVAGEN=""
"RTN","PSJMISC",45,0)
 D GETIREF^XTID("50.68",".01",PSJVUID,"PSJRDIID")
"RTN","PSJMISC",46,0)
 S PSJNDF=$O(PSJRDIID(50.68,.01,""))
"RTN","PSJMISC",47,0)
 K PSJRDIID
"RTN","PSJMISC",48,0)
 I +PSJNDF D
"RTN","PSJMISC",49,0)
 . D DATA^PSN50P68(+PSJNDF,,"PSJNDF")
"RTN","PSJMISC",50,0)
 . S PSJVAGEN=$P($G(^TMP($J,"PSJNDF",+PSJNDF,.05)),U,2)
"RTN","PSJMISC",51,0)
 K ^TMP($J,"PSJNDF")
"RTN","PSJMISC",52,0)
 Q PSJVAGEN
"RTN","PSJMISC",53,0)
 ;
"RTN","PSJMISC",54,0)
CLASS(PSJDD) ;Return the VA CLASS
"RTN","PSJMISC",55,0)
 Q:'+$G(PSJDD) ""
"RTN","PSJMISC",56,0)
 NEW PSJCLASS
"RTN","PSJMISC",57,0)
 S PSJCLASS=$P($G(^PSDRUG(+PSJDD,0)),U,2)
"RTN","PSJMISC",58,0)
 Q PSJCLASS
"RTN","PSJMISC",59,0)
 ;
"RTN","PSJMISC",60,0)
PREMIX(X) ;Check if the solution is flag as a Pre-mix
"RTN","PSJMISC",61,0)
 ;X - ien from 52.7
"RTN","PSJMISC",62,0)
 ;Return 0 if not flag as premix.
"RTN","PSJMISC",63,0)
 I '+$G(X) Q 0
"RTN","PSJMISC",64,0)
 Q +$P($G(^PS(52.7,+X,0)),U,14)
"RTN","PSJMISC",65,0)
 ;
"RTN","PSJMISC",66,0)
IVDDRG(PSIVAS,PSJIEN) ;Return corresponding dispense drug IEN for ad/sol
"RTN","PSJMISC",67,0)
 ;PSJIEN - ien from 52.6 or 52.7
"RTN","PSJMISC",68,0)
 ;PSIVAS - "AD" or "SOL"
"RTN","PSJMISC",69,0)
 NEW DDRUG
"RTN","PSJMISC",70,0)
 I PSIVAS="AD" S DDRUG=$P($G(^PS(52.6,+PSJIEN,0)),U,2)
"RTN","PSJMISC",71,0)
 I PSIVAS="SOL" S DDRUG=$P($G(^PS(52.7,+PSJIEN,0)),U,2)
"RTN","PSJMISC",72,0)
 Q DDRUG
"RTN","PSJMISC",73,0)
 ;
"RTN","PSJMISC",74,0)
WRITE(X,DIWL,DIWR) ;Start a new line before writing
"RTN","PSJMISC",75,0)
 NEW DN
"RTN","PSJMISC",76,0)
 I '$G(DIWL) S DIWL=1
"RTN","PSJMISC",77,0)
 I '$G(DIWR) S DIWR=75
"RTN","PSJMISC",78,0)
 K ^UTILITY($J,"W") D ^DIWP D ^DIWW
"RTN","PSJMISC",79,0)
 Q
"RTN","PSJMISC",80,0)
 ;
"RTN","PSJMISC",81,0)
MYWRITE(X,DIWL,DIWR) ;Continue writing on the same line
"RTN","PSJMISC",82,0)
 NEW DN,PSJCNT
"RTN","PSJMISC",83,0)
 I '$G(DIWL) S DIWL=1
"RTN","PSJMISC",84,0)
 I '$G(DIWR) S DIWR=75
"RTN","PSJMISC",85,0)
 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSJMISC",86,0)
 F PSJCNT=0:0 S PSJCNT=$O(^UTILITY($J,"W",DIWL,PSJCNT)) Q:'PSJCNT  W:PSJCNT'=1 ! W ?DIWL,^UTILITY($J,"W",DIWL,PSJCNT,0)
"RTN","PSJMISC",87,0)
 Q
"RTN","PSJMISC",88,0)
 ;
"RTN","PSJMISC",89,0)
COMPARE(DRG,TMPDRG,PSJNPRMX) ;
"RTN","PSJMISC",90,0)
 ;PSJNPRMX is set to consider non-premix solution.
"RTN","PSJMISC",91,0)
 ;Compare the DRG array if it has changed
"RTN","PSJMISC",92,0)
 ;Returning 1 will cause OC to be performed due to add/sol changes or new OE
"RTN","PSJMISC",93,0)
 I '$D(DRG) Q 0
"RTN","PSJMISC",94,0)
 I $D(DRG),('$D(TMPDRG)) Q 1
"RTN","PSJMISC",95,0)
 NEW PSJDIFF,PSJX,X
"RTN","PSJMISC",96,0)
 S PSJDIFF=0
"RTN","PSJMISC",97,0)
 F X=0:0 S X=$O(DRG("AD",X)) Q:'X!PSJDIFF  S PSJX=DRG("AD",X) D
"RTN","PSJMISC",98,0)
 . I DRG("AD",X)'=$G(TMPDRG("AD",X)) S PSJDIFF=1 Q
"RTN","PSJMISC",99,0)
 I PSJDIFF Q 1
"RTN","PSJMISC",100,0)
 F X=0:0 S X=$O(DRG("SOL",X)) Q:'X!PSJDIFF  S PSJX=DRG("SOL",X) D
"RTN","PSJMISC",101,0)
 . I '+$G(PSJNPRMX),'$$PREMIX(+PSJX) Q
"RTN","PSJMISC",102,0)
 . I DRG("SOL",X)'=$G(TMPDRG("SOL",X)) S PSJDIFF=1 Q
"RTN","PSJMISC",103,0)
 I PSJDIFF Q 1
"RTN","PSJMISC",104,0)
 F X=0:0 S X=$O(TMPDRG("AD",X)) Q:'X!PSJDIFF  S PSJX=TMPDRG("AD",X) D
"RTN","PSJMISC",105,0)
 . I TMPDRG("AD",X)'=$G(DRG("AD",X)) S PSJDIFF=1 Q
"RTN","PSJMISC",106,0)
 I PSJDIFF Q 1
"RTN","PSJMISC",107,0)
 F X=0:0 S X=$O(TMPDRG("SOL",X)) Q:'X!PSJDIFF  S PSJX=TMPDRG("SOL",X) D
"RTN","PSJMISC",108,0)
 . I '+$G(PSJNPRMX),'$$PREMIX(+PSJX) Q
"RTN","PSJMISC",109,0)
 . I TMPDRG("SOL",X)'=$G(DRG("SOL",X)) S PSJDIFF=1 Q
"RTN","PSJMISC",110,0)
 Q PSJDIFF
"RTN","PSJMISC",111,0)
DN(X) ;
"RTN","PSJMISC",112,0)
 ;Return the drug name from file 50
"RTN","PSJMISC",113,0)
 Q $P($G(^PSDRUG(+X,0)),U)
"RTN","PSJMISC",114,0)
OI(X) ;
"RTN","PSJMISC",115,0)
 ;Return the Orderable name from file 50.7
"RTN","PSJMISC",116,0)
 NEW PSJX
"RTN","PSJMISC",117,0)
 S PSJX=$P($G(^PS(50.7,+X,0)),U)
"RTN","PSJMISC",118,0)
 Q $S(PSJX="":"Invalid Orderable Item",1:PSJX)
"RTN","PSJMISC",119,0)
LINE(PSJLINE,PSJLEN) ;Display a line
"RTN","PSJMISC",120,0)
 ;PSJLINE - type of line (ex: '-', '=")
"RTN","PSJMISC",121,0)
 ;PSJLEN - the length of line
"RTN","PSJMISC",122,0)
 S X="",$P(X,PSJLINE,PSJLEN)=""
"RTN","PSJMISC",123,0)
 W X
"RTN","PSJMISC",124,0)
 Q
"RTN","PSJMISC",125,0)
DD53P45() ;Return the zero node of the first dispense drug found in 53.45
"RTN","PSJMISC",126,0)
 ;Calling routine needs to clean up PSJALLGY array.
"RTN","PSJMISC",127,0)
 NEW PSJDD,PSJDD1,PSJDD0,X,PSJX,PSGDT,%
"RTN","PSJMISC",128,0)
 D NOW^%DTC S PSGDT=%
"RTN","PSJMISC",129,0)
 S PSJDD="",PSJDD1=""
"RTN","PSJMISC",130,0)
 I '+$G(PSJSYSP) Q ""
"RTN","PSJMISC",131,0)
 F X=0:0 S X=$O(^PS(53.45,+PSJSYSP,2,X)) Q:'+X  D
"RTN","PSJMISC",132,0)
 . S PSJDD0=$G(^PS(53.45,PSJSYSP,2,X,0))
"RTN","PSJMISC",133,0)
 . S PSJX=$P(PSJDD0,U,3) I PSJX]"",(PSJX'>$G(PSGDT)) S PSJDD0="" Q
"RTN","PSJMISC",134,0)
 . S PSJDD=+PSJDD0
"RTN","PSJMISC",135,0)
 . S PSJX=$S('$D(^PSDRUG(+PSJDD,0)):1,$P($G(^(2)),U,3)'["U":1,$G(^("I"))="":0,1:^("I")'>$G(PSGDT))
"RTN","PSJMISC",136,0)
 . I PSJX S PSJDD0="",PSJDD="" Q
"RTN","PSJMISC",137,0)
 . S PSJALLGY(PSJDD)=""
"RTN","PSJMISC",138,0)
 . S:PSJDD1="" PSJDD1=PSJDD0
"RTN","PSJMISC",139,0)
 Q $G(PSJDD1)
"RTN","PSJMISC",140,0)
RETQUIT() ;
"RTN","PSJMISC",141,0)
 ;Return 1 If enter "^"
"RTN","PSJMISC",142,0)
 NEW DIR,DIROUT,DTOUT,DUOUT,PSJQUIT
"RTN","PSJMISC",143,0)
 S PSJQUIT=0
"RTN","PSJMISC",144,0)
 S DIR(0)="FO^1:1",DIR("A")="Press RETURN to continue or '^' to exit"
"RTN","PSJMISC",145,0)
 S DIR("?")="Enter '^' to quit or any keys to continue"
"RTN","PSJMISC",146,0)
 D ^DIR
"RTN","PSJMISC",147,0)
 I $S($D(DIROUT):1,$D(DUOUT):1,$D(DTOUT):1,1:0) S PSJQUIT=1
"RTN","PSJMISC",148,0)
 Q PSJQUIT
"RTN","PSJMISC",149,0)
PAUSE(PSJFIRST,PSJLAST) ;
"RTN","PSJMISC",150,0)
 ;PSJFIRST - Print a blank line before the pause prompt
"RTN","PSJMISC",151,0)
 ;PSJLAST - Print a blank line after the pause prompt
"RTN","PSJMISC",152,0)
 K DIR W:+$G(PSJFIRST) ! S DIR(0)="EA",DIR("A")="Press Return to continue...",DIR("?")="Press Return to continue..." D ^DIR W:+$G(PSJLAST) !
"RTN","PSJMISC",153,0)
 Q
"RTN","PSJMISC",154,0)
PAUSE1() ;Allow "^"
"RTN","PSJMISC",155,0)
 ;Return 0 if X=""
"RTN","PSJMISC",156,0)
 ;Return 1 if X="^"
"RTN","PSJMISC",157,0)
 ;Return 2 if Not null or "^"
"RTN","PSJMISC",158,0)
 NEW DIR,DIRUT,DUOUT,X
"RTN","PSJMISC",159,0)
 K DIR S DIR("A")="Press RETURN to continue or ""^"" to display the next Monograph or ""^^"" to Exit"
"RTN","PSJMISC",160,0)
 S DIR("?")="Enter ""^"" to go to next Monograph, ""^^"" to exit the Monograph display."
"RTN","PSJMISC",161,0)
 S DIR(0)="FOU^^K:(X'="""")!(X'[""^"") X"
"RTN","PSJMISC",162,0)
 D ^DIR
"RTN","PSJMISC",163,0)
 I X="" Q 0
"RTN","PSJMISC",164,0)
 I X="^" Q 1
"RTN","PSJMISC",165,0)
 Q 2
"RTN","PSJMISC",166,0)
ONCALL(PSJSCH,PSJSTYPE) ;
"RTN","PSJMISC",167,0)
 ; PSJSCH = Admin Schedule
"RTN","PSJMISC",168,0)
 ; PSJSTYPE = schedule type (optional)
"RTN","PSJMISC",169,0)
 ; Returns 0 = Not an "ON CALL" schedule.
"RTN","PSJMISC",170,0)
 ;         1 = For schedule ="ON CALL" or schedule type = "OC".
"RTN","PSJMISC",171,0)
 Q:$G(PSJSTYPE)="OC" 1
"RTN","PSJMISC",172,0)
 Q:$G(PSJSCH)="" 0
"RTN","PSJMISC",173,0)
 I PSJSCH="ON CALL"!(PSJSCH="ONCALL")!(PSJSCH="ON-CALL") Q 1
"RTN","PSJMISC",174,0)
 Q 0
"RTN","PSJMISC",175,0)
TMPDRG(DFN,ON,TMPDRG) ;Set TMPDRG array from the order in 55
"RTN","PSJMISC",176,0)
 ;ON - IV order #
"RTN","PSJMISC",177,0)
 NEW DRGT,FIL,Y,ND,DRG,DRGI
"RTN","PSJMISC",178,0)
 Q:'+$G(ON)
"RTN","PSJMISC",179,0)
 F DRGT="AD","SOL" S FIL=$S(DRGT="AD":52.6,1:52.7) F Y=0:0 S Y=$O(^PS(55,DFN,"IV",+ON,DRGT,Y)) Q:'Y  D
"RTN","PSJMISC",180,0)
 .; naked ref below refers to line above
"RTN","PSJMISC",181,0)
 .S DRG=$G(^(Y,0)),ND=$G(^PS(FIL,+DRG,0)),(DRGI,TMPDRG(DRGT,0))=$G(TMPDRG(DRGT,0))+1
"RTN","PSJMISC",182,0)
 .S TMPDRG(DRGT,+DRGI)=+DRG_U_$P(ND,U)_U_$P(DRG,U,2)_U_$P(DRG,U,3)_U_$P(ND,U,13)_U_$P(ND,U,11)
"RTN","PSJMISC",183,0)
 Q
"RTN","PSJMISC",184,0)
TMPDRG1(DFN,ON,TMPDRG) ;Set TMPDRG array from the order in 53.1
"RTN","PSJMISC",185,0)
 ;ON - IV order #
"RTN","PSJMISC",186,0)
 NEW DRGT,FIL,Y,ND,DRG,DRGI
"RTN","PSJMISC",187,0)
 Q:'+$G(ON)
"RTN","PSJMISC",188,0)
 I $P(^PS(53.1,+ON,0),U,15)'=DFN Q
"RTN","PSJMISC",189,0)
 F DRGT="AD","SOL" S FIL=$S(DRGT="AD":52.6,1:52.7) F Y=0:0 S Y=$O(^PS(53.1,+ON,DRGT,Y)) Q:'Y  D
"RTN","PSJMISC",190,0)
 .; naked ref below refers to line above
"RTN","PSJMISC",191,0)
 .S DRG=$G(^(Y,0)),ND=$G(^PS(FIL,+DRG,0)),(DRGI,TMPDRG(DRGT,0))=$G(TMPDRG(DRGT,0))+1
"RTN","PSJMISC",192,0)
 .S TMPDRG(DRGT,+DRGI)=+DRG_U_$P(ND,U)_U_$P(DRG,U,2)_U_$P(DRG,U,3)_U_$P(ND,U,13)_U_$P(ND,U,11)
"RTN","PSJMISC",193,0)
 Q
"RTN","PSJMISC",194,0)
INFRATE(DFN,ON,PSJIR,PSJDTYP) ;Check if the infusion rate has changed
"RTN","PSJMISC",195,0)
 ;ON - ON_P/V
"RTN","PSJMISC",196,0)
 ;PSJIR - infusion rate
"RTN","PSJMISC",197,0)
 ;PSJDTYP - IV type.  Only check infusion rate on continuous IV type
"RTN","PSJMISC",198,0)
 NEW X,PSJONIR
"RTN","PSJMISC",199,0)
 I '$D(PSJDTYP)!(+$G(PSJDTYP)=1) Q 0
"RTN","PSJMISC",200,0)
 I '+$G(ON) Q 0
"RTN","PSJMISC",201,0)
 I $G(PSJIR)="" Q 0
"RTN","PSJMISC",202,0)
 I ON["V" S X=$G(^PS(55,DFN,"IV",+ON,0)) S PSJONIR=$P(X,U,8)
"RTN","PSJMISC",203,0)
 I ON["P" S X=$G(^PS(53.1,+ON,8)) S PSJONIR=$P(X,U,5)
"RTN","PSJMISC",204,0)
 I PSJONIR="" Q 0
"RTN","PSJMISC",205,0)
 I PSJIR'=PSJONIR Q 1
"RTN","PSJMISC",206,0)
 Q 0
"RTN","PSJMISC",207,0)
ADDD(PSJOI) ;Return the best dispense drug IEN for giving OI from the additive file
"RTN","PSJMISC",208,0)
 ;PSJOI - 50.7 ien
"RTN","PSJMISC",209,0)
 ;Output - 50 ien^52.6 ien or null
"RTN","PSJMISC",210,0)
 ;PSJLIST(S1,S2) - sort by Use for IV fluid first
"RTN","PSJMISC",211,0)
 ;  S1=1 for active DD & has GCN; 2=active DD; 3=inactive DD;
"RTN","PSJMISC",212,0)
 ;  4=active DD & has GCN; 5=active DD;6=inactive DD; S2 - DDIEN
"RTN","PSJMISC",213,0)
 Q:'+$G(PSJOI)
"RTN","PSJMISC",214,0)
 NEW PSJOK,PSIVIEN,PSIVIEN0,PSJINACT,PSJDDX,PSJACTDD,PSJGCN,PSJLIST,PSJFLUID
"RTN","PSJMISC",215,0)
 S PSJOK=0
"RTN","PSJMISC",216,0)
 F PSIVIEN=0:0 S PSIVIEN=$O(^PS(52.6,"AOI",PSJOI,PSIVIEN)) Q:'PSIVIEN  Q:PSJOK  D
"RTN","PSJMISC",217,0)
 . S PSJACTDD=1,PSJGCN=0,PSJFLUID=0
"RTN","PSJMISC",218,0)
 . S PSJINACT=$G(^PS(52.6,PSIVIEN,"I"))
"RTN","PSJMISC",219,0)
 . I PSJINACT]"",(PSJINACT'>DT) Q
"RTN","PSJMISC",220,0)
 . S PSIVIEN0=$G(^PS(52.6,PSIVIEN,0))
"RTN","PSJMISC",221,0)
 . I PSIVIEN0]"" D
"RTN","PSJMISC",222,0)
 .. S PSJDD=+$P(PSIVIEN0,U,2)
"RTN","PSJMISC",223,0)
 .. S PSJINACT=$G(^PSDRUG(PSJDD,"I"))
"RTN","PSJMISC",224,0)
 .. I PSJINACT]"",(PSJINACT'>DT) S PSJACTDD=0
"RTN","PSJMISC",225,0)
 .. I $P(PSIVIEN0,U,13) S PSJFLUID=1
"RTN","PSJMISC",226,0)
 .. I +$$GCN^PSJMISC(PSJDD) S PSJGCN=1
"RTN","PSJMISC",227,0)
 . I PSJFLUID D
"RTN","PSJMISC",228,0)
 .. I PSJACTDD,PSJGCN S PSJLIST(1,PSJDD)=PSIVIEN S PSJOK=1 Q
"RTN","PSJMISC",229,0)
 .. I PSJACTDD S PSJLIST(2,PSJDD)=PSIVIEN Q
"RTN","PSJMISC",230,0)
 .. I PSJDD S PSJLIST(3,PSJDD)=PSIVIEN
"RTN","PSJMISC",231,0)
 . I 'PSJFLUID D
"RTN","PSJMISC",232,0)
 .. I PSJACTDD,PSJGCN S PSJLIST(4,PSJDD)=PSIVIEN Q
"RTN","PSJMISC",233,0)
 .. I PSJACTDD S PSJLIST(5,PSJDD)=PSIVIEN Q
"RTN","PSJMISC",234,0)
 .. I PSJDD S PSJLIST(6,PSJDD)=PSIVIEN
"RTN","PSJMISC",235,0)
 I '$D(PSJLIST) Q ""
"RTN","PSJMISC",236,0)
 S (PSJDD,PSSIEN)=0,PSJDDX=$O(PSJLIST(0))
"RTN","PSJMISC",237,0)
 I +PSJDDX S PSJDD=$O(PSJLIST(PSJDDX,0)),PSIVIEN=PSJLIST(PSJDDX,PSJDD) Q PSJDD_U_PSIVIEN
"RTN","PSJMISC",238,0)
 Q ""
"RTN","PSJMISC",239,0)
SOLDD(PSJOI,PSJVOL) ;Return the best dispense drug IEN for giving OI from the solution file
"RTN","PSJMISC",240,0)
 ;PSJOI - 50.7 ien
"RTN","PSJMISC",241,0)
 ;Output - 50 ien^52.7 ien or null
"RTN","PSJMISC",242,0)
 ;PSJLIST(s1,s2) - Set the list for the drugs in specific criteria for a best drug to use for dosing check
"RTN","PSJMISC",243,0)
 ;          sort by Use for IV fluid first
"RTN","PSJMISC",244,0)
 ; IV fluid: s1: 1 - premix, active dd & matche; 2 - premix & active dd; 3 - premix ; 4 - inactive dd
"RTN","PSJMISC",245,0)
 ; Not IV fluid: 5 - premix, active dd & matche; 6 - premix & active dd; 7 - premix ; 8 - inactive dd; s2 - Sol ien
"RTN","PSJMISC",246,0)
 ;note - Only select sol entries with the exact volume.
"RTN","PSJMISC",247,0)
 Q:'+$G(PSJOI)
"RTN","PSJMISC",248,0)
 NEW PSJOK,PSIVIEN,PSJINACT,PSJDDX,PSJACTDD,PSJGCN,PSJLIST,PSJPREMX,PSJSOL,PSJFLUID
"RTN","PSJMISC",249,0)
 S PSJOK=0,PSJFLUID=0
"RTN","PSJMISC",250,0)
 F PSIVIEN=0:0 S PSIVIEN=$O(^PS(52.7,"AOI",PSJOI,PSIVIEN)) Q:'PSIVIEN  Q:PSJOK  D
"RTN","PSJMISC",251,0)
 . S PSJACTDD=1,PSJGCN=0,PSJPREMX=0
"RTN","PSJMISC",252,0)
 . S PSJINACT=$G(^PS(52.7,PSIVIEN,"I"))
"RTN","PSJMISC",253,0)
 . I PSJINACT]"",(PSJINACT'>DT) Q
"RTN","PSJMISC",254,0)
 . ;Q if volume isn't matched
"RTN","PSJMISC",255,0)
 . S PSJSOL=$G(^PS(52.7,PSIVIEN,0))
"RTN","PSJMISC",256,0)
 . I +$P(PSJSOL,U,3)'=+PSJVOL Q
"RTN","PSJMISC",257,0)
 . S PSJDD=+$P($G(^PS(52.7,+PSIVIEN,0)),U,2)
"RTN","PSJMISC",258,0)
 . S PSJINACT=$G(^PSDRUG(PSJDD,"I"))
"RTN","PSJMISC",259,0)
 . I PSJINACT]"",(PSJINACT'>DT) S PSJACTDD=0
"RTN","PSJMISC",260,0)
 . I +$$GCN^PSJMISC(PSJDD) S PSJGCN=1
"RTN","PSJMISC",261,0)
 . I +$$PREMIX^PSJMISC(PSJDD) S PSJPREMX=1
"RTN","PSJMISC",262,0)
 . I +$P(PSJSOL,U,13) S PSJFLUID=1
"RTN","PSJMISC",263,0)
 . I PSJFLUID D
"RTN","PSJMISC",264,0)
 .. I PSJPREMX,PSJACTDD,PSJGCN S PSJLIST(1,PSJDD)=PSIVIEN S PSJOK=1 Q
"RTN","PSJMISC",265,0)
 .. I PSJPREMX,PSJACTDD S PSJLIST(2,PSJDD)=PSIVIEN Q
"RTN","PSJMISC",266,0)
 .. I PSJPREMX S PSJLIST(3,PSJDD)=PSIVIEN Q
"RTN","PSJMISC",267,0)
 .. I PSJDD S PSJLIST(4,PSJDD)=PSIVIEN
"RTN","PSJMISC",268,0)
 . I 'PSJFLUID D
"RTN","PSJMISC",269,0)
 .. I PSJPREMX,PSJACTDD,PSJGCN S PSJLIST(5,PSJDD)=PSIVIEN Q
"RTN","PSJMISC",270,0)
 .. I PSJPREMX,PSJACTDD S PSJLIST(6,PSJDD)=PSIVIEN Q
"RTN","PSJMISC",271,0)
 .. I PSJPREMX S PSJLIST(7,PSJDD)=PSIVIEN Q
"RTN","PSJMISC",272,0)
 .. I PSJDD S PSJLIST(8,PSJDD)=PSIVIEN
"RTN","PSJMISC",273,0)
 I '$D(PSJLIST) Q ""
"RTN","PSJMISC",274,0)
 S (PSJDD,PSSIEN)=0,PSJDDX=$O(PSJLIST(0))
"RTN","PSJMISC",275,0)
 I +PSJDDX S PSJDD=$O(PSJLIST(PSJDDX,0)),PSIVIEN=PSJLIST(PSJDDX,PSJDD) Q PSJDD_U_PSIVIEN
"RTN","PSJMISC",276,0)
 Q ""
"RTN","PSJMISC2")
0^32^B25685230
"RTN","PSJMISC2",1,0)
PSJMISC2 ;BIR/MV - MISC. CALLS FOR IV DOSING CHECKS;6 Jun 07 / 3:37 PM
"RTN","PSJMISC2",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,252,256**;16 DEC 97;Build 34
"RTN","PSJMISC2",3,0)
 ; Reference to ^PS(51.1 is supported by DBIA #2177
"RTN","PSJMISC2",4,0)
 ; Reference to ^PSSDSAPI is supported by DBIA #5425
"RTN","PSJMISC2",5,0)
 ;
"RTN","PSJMISC2",6,0)
P8(PSJINFRT) ;Set infusion rate in term of numeric, dose unit over time unit
"RTN","PSJMISC2",7,0)
 ;PSJINFRT - Infusion Rate
"RTN","PSJMISC2",8,0)
 ;Return either Null or numeric^doseUnit^timeUnit
"RTN","PSJMISC2",9,0)
 ;PWJP8ERR - Must be clean up by calling routine.
"RTN","PSJMISC2",10,0)
 ;PSJP8ERR = 1 - "FRQ_ERROR"
"RTN","PSJMISC2",11,0)
 ;PSJP8ERR = 2 - "WT_ERROR"
"RTN","PSJMISC2",12,0)
 ;PSJP8ERR = 3 - "HT_ERROR"
"RTN","PSJMISC2",13,0)
 ;PSJP8ERR = 4 - Set both WT & HT error
"RTN","PSJMISC2",14,0)
 ;
"RTN","PSJMISC2",15,0)
 I $G(PSJINFRT)="" Q ""
"RTN","PSJMISC2",16,0)
 NEW X,PSJBSA,PSJBSAFG,PSJHT,PSJWT,PSJWTFG,PSJTIME,PSJUNIT,PSJP1,PSJP2,PSJNUT,PSJUP8
"RTN","PSJMISC2",17,0)
 K PSJP8ERR
"RTN","PSJMISC2",18,0)
 S PSJUP8=$$UP^XLFSTR(PSJINFRT)
"RTN","PSJMISC2",19,0)
 I $S(PSJUP8["TITRATE AT ":0,PSJUP8["TITRATE":1,1:0) S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",20,0)
 I PSJUP8["BOLUS" S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",21,0)
 S PSJP1=$P(PSJUP8,"@")
"RTN","PSJMISC2",22,0)
 S:PSJP1["INFUSE OVER " PSJP1=$P(PSJP1,"INFUSE OVER ",2)
"RTN","PSJMISC2",23,0)
 S:PSJP1["INFUSE AT " PSJP1=$P(PSJP1,"INFUSE AT ",2)
"RTN","PSJMISC2",24,0)
 S:PSJP1["INFUSE " PSJP1=$P(PSJP1,"INFUSE ",2)
"RTN","PSJMISC2",25,0)
 S:PSJP1["OVER " PSJP1=$P(PSJP1,"OVER ",2)
"RTN","PSJMISC2",26,0)
 S:PSJP1["START AT " PSJP1=$P(PSJP1,"START AT ",2)
"RTN","PSJMISC2",27,0)
 S:PSJP1["TITRATE AT " PSJP1=$P(PSJP1,"TITRATE AT ",2)
"RTN","PSJMISC2",28,0)
 I PSJP1[" TO " S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",29,0)
 S:PSJP1["," PSJP1=$TR(PSJP1,",","")
"RTN","PSJMISC2",30,0)
 S PSJP1=$TR(PSJP1," ")
"RTN","PSJMISC2",31,0)
 I '+PSJP1 S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",32,0)
 ;
"RTN","PSJMISC2",33,0)
 S PSJP2=$P(PSJUP8,"@",2)
"RTN","PSJMISC2",34,0)
 I PSJUP8["@",$S(PSJP2=0:0,'+PSJP2:1,1:0) S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",35,0)
 ;
"RTN","PSJMISC2",36,0)
 I PSJP1'["/" S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",37,0)
 ;Process ml/hr, mg/day... types
"RTN","PSJMISC2",38,0)
 NEW PSJUOTME
"RTN","PSJMISC2",39,0)
 I $S(PSJP1["/KG/":0,PSJP1["/M2/":0,1:1) S PSJUOTME=$$UNTOTME(PSJP1) Q PSJUOTME
"RTN","PSJMISC2",40,0)
 ;
"RTN","PSJMISC2",41,0)
 ;If Infusion rate contains /KG/, /M2/ and also contains ML/HR
"RTN","PSJMISC2",42,0)
 I PSJP1["ML/HR" S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",43,0)
 ;
"RTN","PSJMISC2",44,0)
 ;Set patient parameter
"RTN","PSJMISC2",45,0)
 S X=$$BSA^PSSDSAPI($G(DFN))
"RTN","PSJMISC2",46,0)
 S PSJHT=+$P(X,U),PSJWT=+$P(X,U,2),PSJBSA=+$P(X,U,3)
"RTN","PSJMISC2",47,0)
 S PSJTIME=$P(PSJP1,"/",3)
"RTN","PSJMISC2",48,0)
 S PSJTIME=$$TIME(PSJTIME)
"RTN","PSJMISC2",49,0)
 S X=$P(PSJP1,"/"),PSJUNIT=$P(X,+X,2)
"RTN","PSJMISC2",50,0)
 I PSJP1["." S PSJUNIT=$$UNIT(PSJUNIT)
"RTN","PSJMISC2",51,0)
 S PSJUNIT=$$UNIT^PSSDSAPI(PSJUNIT)
"RTN","PSJMISC2",52,0)
 ;
"RTN","PSJMISC2",53,0)
 ;Calculate SDA using weight
"RTN","PSJMISC2",54,0)
 I PSJP1["/KG/" S PSJWTFG=$$WT() Q PSJWTFG
"RTN","PSJMISC2",55,0)
 ;
"RTN","PSJMISC2",56,0)
 ;Calculate SDA using  BSA
"RTN","PSJMISC2",57,0)
 I PSJP1["/M2/" S PSJBSAFG=$$BSA() Q PSJBSAFG
"RTN","PSJMISC2",58,0)
 ;
"RTN","PSJMISC2",59,0)
 Q ""
"RTN","PSJMISC2",60,0)
WT() ;
"RTN","PSJMISC2",61,0)
 NEW X
"RTN","PSJMISC2",62,0)
 I $S(PSJUNIT="":1,PSJTIME="":1,'PSJWT:1,'+PSJP1:1,1:0) S PSJP8ERR=2 Q ""
"RTN","PSJMISC2",63,0)
 S X=(+PSJP1*PSJWT)_U_PSJUNIT_U_PSJTIME
"RTN","PSJMISC2",64,0)
 Q X
"RTN","PSJMISC2",65,0)
BSA() ;
"RTN","PSJMISC2",66,0)
 NEW X
"RTN","PSJMISC2",67,0)
 I $S(PSJUNIT="":1,PSJTIME="":1,'PSJBSA:1,'+PSJP1:1,1:0) D  Q ""
"RTN","PSJMISC2",68,0)
 . I $G(PSJHT)=0,($G(PSJWT)=0) S PSJP8ERR=4 Q
"RTN","PSJMISC2",69,0)
 . I $G(PSJHT)=0 S PSJP8ERR=3 Q
"RTN","PSJMISC2",70,0)
 . I $G(PSJWT)=0 S PSJP8ERR=2
"RTN","PSJMISC2",71,0)
 S X=(+PSJP1*PSJBSA)_U_PSJUNIT_U_PSJTIME
"RTN","PSJMISC2",72,0)
 Q X
"RTN","PSJMISC2",73,0)
UNTOTME(PSJINF) ;Process Infusion rate for format of Num Unit/time. Ex: 8MG/HR, 125ML/HR, 1000UNITS/HR@TITRATE
"RTN","PSJMISC2",74,0)
 ;Return n^unit^time if infusion rate contain numeric + Unit over time (8MG/HR;125ML/HR) format in p1^p2^p3
"RTN","PSJMISC2",75,0)
 ;Otherwise return null
"RTN","PSJMISC2",76,0)
 ;PSJINF is already have "OVER" and whatever from "@" removed
"RTN","PSJMISC2",77,0)
 NEW PSJNUM,PSJP1S1,PSJP1S2,PSJUNIT,PSJTIME
"RTN","PSJMISC2",78,0)
 I $G(PSJINF)="" S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",79,0)
 S PSJNUM=+PSJINF
"RTN","PSJMISC2",80,0)
 I 'PSJNUM S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",81,0)
 S PSJP1S1=$P(PSJINF,"/")
"RTN","PSJMISC2",82,0)
 S PSJP1S2=$P(PSJINF,"/",2)
"RTN","PSJMISC2",83,0)
 ; Should be free text if in format: "8MG/HRML/HR" PSJP1S2="HRML/HR"
"RTN","PSJMISC2",84,0)
 I PSJP1S2["ML/HR" S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",85,0)
 S PSJUNIT=$P(PSJP1S1,PSJNUM,2)
"RTN","PSJMISC2",86,0)
 S PSJUNIT=$$UNIT^PSSDSAPI(PSJUNIT)
"RTN","PSJMISC2",87,0)
 I PSJUNIT="" S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",88,0)
 S PSJTIME=$$TIME(PSJP1S2)
"RTN","PSJMISC2",89,0)
 I PSJTIME="" S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",90,0)
 Q PSJNUM_U_PSJUNIT_U_PSJTIME
"RTN","PSJMISC2",91,0)
TIME(PSJTIME) ;
"RTN","PSJMISC2",92,0)
 Q:$G(PSJTIME)="" ""
"RTN","PSJMISC2",93,0)
 I PSJTIME="MIN" Q "MINUTE"
"RTN","PSJMISC2",94,0)
 I PSJTIME="MINUTE" Q "MINUTE"
"RTN","PSJMISC2",95,0)
 I PSJTIME="MINUTES" Q "MINUTE"
"RTN","PSJMISC2",96,0)
 I PSJTIME="HR" Q "HOUR"
"RTN","PSJMISC2",97,0)
 I PSJTIME="HOUR" Q "HOUR"
"RTN","PSJMISC2",98,0)
 I PSJTIME="HOURS" Q "HOUR"
"RTN","PSJMISC2",99,0)
 I PSJTIME="DAY" Q "DAY"
"RTN","PSJMISC2",100,0)
 I PSJTIME="DAYS" Q "DAY"
"RTN","PSJMISC2",101,0)
 Q ""
"RTN","PSJMISC2",102,0)
UNIT(PSJUNIT) ;Remove extra zero after decimal point
"RTN","PSJMISC2",103,0)
 NEW PSJX
"RTN","PSJMISC2",104,0)
 I $G(PSJUNIT)=""!($G(PSJUNIT)=0) Q ""
"RTN","PSJMISC2",105,0)
 F  S PSJX=$E(PSJUNIT,1,1) Q:PSJX'=0  S:PSJX=0 PSJUNIT=$E(PSJUNIT,2,$L(PSJUNIT))
"RTN","PSJMISC2",106,0)
 Q PSJUNIT
"RTN","PSJMISC2",107,0)
OLDSCHD(PSJOLDNM) ;checking if the schedule in the order is an old schedule name
"RTN","PSJMISC2",108,0)
 ;PSJOLDNM(ORD_SCHD) - the schedule as entered in the order
"RTN","PSJMISC2",109,0)
 ;PSJOLDNM(OLD_SCHD) - found an old schedule name
"RTN","PSJMISC2",110,0)
 ;PSJOLDNM(NEW_SCHD) - new schedule name
"RTN","PSJMISC2",111,0)
 ;Note - if schedule is DOW or in DOW format, don't check for Old Schedule Name
"RTN","PSJMISC2",112,0)
 NEW PSJSCH,PSJNSCH,PSJNSCH0,PSJIEN
"RTN","PSJMISC2",113,0)
 S PSJSCH=$G(PSJOLDNM("ORD_SCHD"))
"RTN","PSJMISC2",114,0)
 Q:PSJSCH=""
"RTN","PSJMISC2",115,0)
 I $D(^PS(51.1,"APPSJ",PSJSCH)) Q
"RTN","PSJMISC2",116,0)
 S PSJIEN=$O(^PS(51.1,"D",PSJSCH,0))
"RTN","PSJMISC2",117,0)
 I +PSJIEN D  Q
"RTN","PSJMISC2",118,0)
 . S PSJNSCH0=$G(^PS(51.1,PSJIEN,0))
"RTN","PSJMISC2",119,0)
 . Q:$P(PSJNSCH0,U,5)="D"
"RTN","PSJMISC2",120,0)
 . S PSJNSCH=$P(PSJNSCH0,U,1)
"RTN","PSJMISC2",121,0)
 . Q:$$DOW^PSIVUTL(PSJNSCH)
"RTN","PSJMISC2",122,0)
 . I PSJNSCH]"" S PSJOLDNM("NEW_SCHD")=PSJNSCH,PSJOLDNM("OLD_SCHD")=PSJSCH
"RTN","PSJMISC2",123,0)
 Q
"RTN","PSJMISC2",124,0)
PROMPT(PSJOLDNM,PSJMSGFL) ;display the replaced schedule name and prompt if the user want to continue with the order
"RTN","PSJMISC2",125,0)
 NEW PSJMSG,VALMBCK,PSGORQF
"RTN","PSJMISC2",126,0)
 I $G(PSJOLDNM("ORD_SCHD"))=""!$G(PSJOLDNM("ORD_SCHD"))="" Q
"RTN","PSJMISC2",127,0)
 S PSJMSG="The schedule "_PSJOLDNM("ORD_SCHD")_" has been replaced with "_PSJOLDNM("NEW_SCHD")_" by the system administrator after this order was "_$S($G(PSJMSGFL)="R":"renewed.",1:"entered.")
"RTN","PSJMISC2",128,0)
 W !!!
"RTN","PSJMISC2",129,0)
 D WRITE^PSJMISC(PSJMSG)
"RTN","PSJMISC2",130,0)
 ;PSGORQF=1 if the user said No from the prompt below, VALMBCK="R" from this call. Newed to keep the orig value.
"RTN","PSJMISC2",131,0)
 I $G(PSJMSGFL)]"" S PSGORQF=1 D  D PAUSE^PSJLMUT1
"RTN","PSJMISC2",132,0)
 . I $G(PSJMSGFL)="V" W !,"Please correct the schedule before verifying this order."
"RTN","PSJMISC2",133,0)
 . I $G(PSJMSGFL)="R" W !,"WARNING - Renewed RXs cannot be edited. Please enter new order."
"RTN","PSJMISC2",134,0)
 D:$G(PSJMSGFL)="" CONT^PSJOCDT
"RTN","PSJMISC2",135,0)
 Q $G(PSGORQF)
"RTN","PSJMISC2",136,0)
CHKSCHD(PSJOLDNM,PSJMSGFL) ;
"RTN","PSJMISC2",137,0)
 ;PSJMSGFL = "V" if calling during verification; "R" - renew; null - otherwise
"RTN","PSJMISC2",138,0)
 NEW PSGORQF
"RTN","PSJMISC2",139,0)
 I $G(PSJOLDNM("ORD_SCHD"))]"" D OLDSCHD(.PSJOLDNM)
"RTN","PSJMISC2",140,0)
 I $G(PSJOLDNM("NEW_SCHD"))]"" S PSGORQF=$$PROMPT(.PSJOLDNM,$G(PSJMSGFL))
"RTN","PSJMISC2",141,0)
 Q $G(PSGORQF)
"RTN","PSJOC")
0^4^B61350664
"RTN","PSJOC",1,0)
PSJOC ;BIR/MV - NEW ORDER CHECKS DRIVER ; 9/10/14 10:53pm
"RTN","PSJOC",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**181,260,252,257,281,256**;16 DEC 97;Build 34
"RTN","PSJOC",3,0)
 ;
"RTN","PSJOC",4,0)
 ; Reference to ^PSODDPR4 is supported by DBIA# 5366.
"RTN","PSJOC",5,0)
 ; Reference to ^PSSHRQ2 is supported by DBIA# 5369.
"RTN","PSJOC",6,0)
 ;
"RTN","PSJOC",7,0)
OC(PSPDRG,PSJPTYP) ;
"RTN","PSJOC",8,0)
 ;PSPDRG - Drug array in format of PDRG(n)=IEN (#50) ^ Drug Name
"RTN","PSJOC",9,0)
 ;Where n is a sequential number.  The Drug Name can be OI, Generic name from #50, or Add/Sol name
"RTN","PSJOC",10,0)
 ;PSJPTYP - P1 ; P2
"RTN","PSJOC",11,0)
 ; Where P1 is "I" for Inpatient, "O" for Outpatient
"RTN","PSJOC",12,0)
 ;       P2 is the Inpatient Order Number (for PSJ use only)
"RTN","PSJOC",13,0)
 ;PSJOCERR(DRUG NAME)="Reason text". Where Drug Name can be either OI name or AD/SOL name.
"RTN","PSJOC",14,0)
 NEW PSJOCERR
"RTN","PSJOC",15,0)
 ;Quit OC if FDB link is down.  PSGORQF is defined if user wish to stop the order process
"RTN","PSJOC",16,0)
 I $$SYS^PSJOCERR() Q
"RTN","PSJOC",17,0)
 ;
"RTN","PSJOC",18,0)
 I $D(PSJDGCK) W !!,"Building MEDS profile please wait...",!
"RTN","PSJOC",19,0)
 D BLD^PSODDPR4(DFN,"PSJPRE",.PSPDRG,PSJPTYP)
"RTN","PSJOC",20,0)
 D DISPLAY
"RTN","PSJOC",21,0)
 K ^TMP($J,"PSJPRE")
"RTN","PSJOC",22,0)
 Q
"RTN","PSJOC",23,0)
DISPLAY ;
"RTN","PSJOC",24,0)
 NEW PSJPAUSE,PSJOLDSV,PSJDNM,PSJMON,PSJOC,PSJOCDT,PSJOCDTL,PSJOCLST,PSJP,PSJS,PSJPON,PSJDN,PSJSEV,PSJECNT
"RTN","PSJOC",25,0)
 N CROCLN,CROCLN2,PSJTOFFL,PSJCROCF,PSJDRGIF,PSJDERF2,PSJDUPTF
"RTN","PSJOC",26,0)
 D FULL^VALM1 W @IOF
"RTN","PSJOC",27,0)
 D GMRAOC Q:$G(PSGORQF)
"RTN","PSJOC",28,0)
 S $P(CROCLN,"=",75)="=",$P(CROCLN2,"-",75)="-",CROCNR=1
"RTN","PSJOC",29,0)
 I '$D(PSJDGCKX) D
"RTN","PSJOC",30,0)
 .I '$D(TMPDRG1("AD",0))&('$D(TMPDRG1("SOL",0)))&($G(PSPDRG(1))) D CK^PSJCROC($P(PSPDRG(1),"^")) I $G(PSGORQF) Q
"RTN","PSJOC",31,0)
 .I $G(TMPDRG1("AD",0))>0!$G(TMPDRG1("SOL",0))>0 W "Now processing Clinical Reminder Order Checks. Please wait ..."
"RTN","PSJOC",32,0)
 .I $G(TMPDRG1("AD",0))>0 F CRIV=0:0 S CRIV=$O(TMPDRG1("AD",CRIV)) Q:'CRIV  D CKIV^PSJCROC($P(TMPDRG1("AD",CRIV),"^",1),"A")
"RTN","PSJOC",33,0)
 .I $G(TMPDRG1("SOL",0))>0 F CRIV=0:0 S CRIV=$O(TMPDRG1("SOL",CRIV)) Q:'CRIV  D CKIV^PSJCROC($P(TMPDRG1("SOL",CRIV),"^",1),"S")
"RTN","PSJOC",34,0)
 .I $G(TMPDRG1("AD",0))>0!$G(TMPDRG1("SOL",0))>0 D CKIVD^PSJCROC I $G(PSGORQF) S VALMBCK="R" Q
"RTN","PSJOC",35,0)
 K CRIV,CROCPFLG,CROCNR,PSJDGCKX
"RTN","PSJOC",36,0)
 I $G(PSGORQF) Q
"RTN","PSJOC",37,0)
 Q:'$$DSPSERR()
"RTN","PSJOC",38,0)
 W !!,"Now Processing Enhanced Order Checks! Please wait...",! S PSJTOFFL=1
"RTN","PSJOC",39,0)
 ; If there are no OC or errors to display, this var will trigger a pause before continue /w the order
"RTN","PSJOC",40,0)
 S PSJPAUSE=1
"RTN","PSJOC",41,0)
 D DRUGERR
"RTN","PSJOC",42,0)
 I $D(PSJDGCK) W:'$D(^TMP($J,"PSJPRE","OUT","DRUGDRUG"))&'$D(^TMP($J,"PSJPRE","OUT","THERAPY",1)) !,"No Order Check Warnings Found",!
"RTN","PSJOC",43,0)
 ;Process drug interaction & drug interception
"RTN","PSJOC",44,0)
 D DI^PSJOCDI
"RTN","PSJOC",45,0)
 Q:$G(PSGORQF)
"RTN","PSJOC",46,0)
 D DSPERR^PSJOCERR("DRUGDRUG")
"RTN","PSJOC",47,0)
 ;Process duplicate therapy order checks
"RTN","PSJOC",48,0)
 D:'$D(PSJDGCK) DT^PSJOCDT
"RTN","PSJOC",49,0)
 I $D(PSJDGCK) D:$D(^TMP($J,"PSJPRE","OUT","THERAPY")) DTDGCK^PSJOCDT
"RTN","PSJOC",50,0)
 D:'$G(PSGORQF) DSPERR^PSJOCERR("THERAPY")
"RTN","PSJOC",51,0)
 I '$G(PSJTOFFL) W !!,"Now Processing Enhanced Order Checks! Please wait...",! I $G(PSIVCOPY)&('$D(PSJDGCK)) D PAUSE^PSJLMUT1
"RTN","PSJOC",52,0)
 I $D(PSJDGCK),'$D(^TMP($J,"PSJPRE","OUT","THERAPY")) D PAUSE^PSJLMUT1 Q  ;DX action
"RTN","PSJOC",53,0)
 Q:$G(PSGORQF)
"RTN","PSJOC",54,0)
 I '$G(PSJDERF2)&('$G(PSJDRGIF))&('$G(PSJDUPTF)) K PSJPAUSE H 2
"RTN","PSJOC",55,0)
 I $G(PSJDERF2)&('$G(PSJDRGIF))&('$G(PSJDUPTF))&(($Y+3)<IOSL) S PSJPAUSE=1 ;error but no drug interaction or dup therapy
"RTN","PSJOC",56,0)
 ;I ($G(PSGCOPY)!($G(PSIVCOPY))) S PSJPAUSE=1
"RTN","PSJOC",57,0)
 I '$D(PSJDGCK) D:$G(PSJPAUSE) PAUSE^PSJLMUT1
"RTN","PSJOC",58,0)
 Q
"RTN","PSJOC",59,0)
 ;
"RTN","PSJOC",60,0)
GMRAOC ;Display allergy & CPRS OC regardless if FDB is connected
"RTN","PSJOC",61,0)
 D ALLERGY Q:$G(PSGORQF)
"RTN","PSJOC",62,0)
 D CPRS^PSJOCOR(.PSPDRG)
"RTN","PSJOC",63,0)
 Q
"RTN","PSJOC",64,0)
ALLERGY ;Do allergy order check
"RTN","PSJOC",65,0)
 ;The allergy check will be processed for each of the dispense drug stores in the PSJALLGY array
"RTN","PSJOC",66,0)
 ;PSJALLGY(X)="" Where X is the disp drug IEN.  PSJALLGY array store all dispense drugs use in an order
"RTN","PSJOC",67,0)
 ;
"RTN","PSJOC",68,0)
 D FULL^VALM1
"RTN","PSJOC",69,0)
 I $G(PSIALLFL) K PSIALLFL Q
"RTN","PSJOC",70,0)
 W !!,"Now doing allergy checks.  Please wait..."
"RTN","PSJOC",71,0)
 N PSJAOC,DACNT,PSJDGFLG,PSJDGDRG S PSJAOC=1
"RTN","PSJOC",72,0)
 I '$D(PSJDGCK) D   ;sort by generic dispensed drug name
"RTN","PSJOC",73,0)
 .NEW PSJDD,PSJGDDN,PSJALGCT,PSJALLGS S PSJDD=""
"RTN","PSJOC",74,0)
 .F  S PSJDD=$O(PSJALLGY(PSJDD)) Q:'PSJDD!(PSJDD'?1N.N)  S PSJGDDN="",PSJGDDN=$$GET1^DIQ(50,PSJDD,.01) D
"RTN","PSJOC",75,0)
 ..I PSJGDDN="" S PSJALLGY("AA",PSJDD_"Z",PSJDD)="" Q
"RTN","PSJOC",76,0)
 ..S PSJALLGY("AA",PSJGDDN,PSJDD)=""
"RTN","PSJOC",77,0)
 .S (PSJDD,PSJGGDN)=""
"RTN","PSJOC",78,0)
 .F  S PSJGGDN=$O(PSJALLGY("AA",PSJGGDN)) Q:PSJGGDN=""!($G(PSGORQF))  F  S PSJDD=$O(PSJALLGY("AA",PSJGGDN,PSJDD)) Q:PSJDD=""!($G(PSGORQF))  D
"RTN","PSJOC",79,0)
 ..S PSJALGCT=$G(PSJALGCT)+1 D EN^PSJGMRA(DFN,PSJDD)
"RTN","PSJOC",80,0)
 K PSJALLGY("AA")
"RTN","PSJOC",81,0)
 I $D(PSJDGCK) D  ;CK ACTION
"RTN","PSJOC",82,0)
 .S PSJXX="" F  S PSJXX=$O(PSJALLGY(PSJXX)) Q:PSJXX=""!(PSJXX'?1N.N)  D
"RTN","PSJOC",83,0)
 ..S PSJGDDN="",PSJGDDN=$$GET1^DIQ(50,PSJXX,.01)
"RTN","PSJOC",84,0)
 ..I PSJGDDN="" S PSJALLGY($S(PSJALLGY(PSJXX)="P":"A",1:"Z"),PSJDD_"Z",PSJGDDN,PSJXX)="" Q
"RTN","PSJOC",85,0)
 ..S PSJALLGY($S(PSJALLGY(PSJXX)="P":"A",1:"Z"),PSJGDDN,PSJXX)=""
"RTN","PSJOC",86,0)
 .S (PSJALLGS,PSJXX,PSJGDDN)="",(PSJDGFLG,PSJYY)=1
"RTN","PSJOC",87,0)
 .F  S PSJXX=$O(^TMP($J,"PSJPRE","IN","PROSPECTIVE",PSJXX)) Q:PSJXX=""  D
"RTN","PSJOC",88,0)
 ..S PSJCKDRG=$P(^TMP($J,"PSJPRE","IN","PROSPECTIVE",PSJXX),U,3)
"RTN","PSJOC",89,0)
 ..S PSJGDDN=$$GET1^DIQ(50,PSJCKDRG,.01)
"RTN","PSJOC",90,0)
 ..S PSJALLGY($S($G(PSJALLGY(PSJCKDRG))="P":"A",1:"Z"),PSJGDDN_"Z",PSJCKDRG)=""
"RTN","PSJOC",91,0)
 ..I $G(PSJALLGY(PSJCKDRG))="P",$D(PSJALLGY("A",PSJGDDN,PSJCKDRG)) K PSJALLGY("A",PSJGDDN,PSJCKDRG)
"RTN","PSJOC",92,0)
 ..I $D(PSJALLGY(PSJCKDRG)) K PSJALLGY(PSJCKDRG)
"RTN","PSJOC",93,0)
 .S (PSJCC,PSJDD)=""
"RTN","PSJOC",94,0)
 .;CK action - If the manually entered drug is same as a profile drug, display as a profile drug.
"RTN","PSJOC",95,0)
 .F  S PSJDD=$O(PSJALLGY("A",PSJDD)) Q:PSJDD=""  F  S PSJCC=$O(PSJALLGY("A",PSJDD,PSJCC)) Q:PSJCC=""  D
"RTN","PSJOC",96,0)
 ..I $D(PSJALLGY("Z",PSJDD,PSJCC)) K PSJALLGY("A",PSJDD,PSJCC)
"RTN","PSJOC",97,0)
 .S (PSJALLGS,PSJDD,PSJCC)=""
"RTN","PSJOC",98,0)
 .F  S PSJALLGS=$O(PSJALLGY(PSJALLGS)) Q:PSJALLGS=""  F  S PSJCC=$O(PSJALLGY(PSJALLGS,PSJCC)) Q:PSJCC=""!($G(PSGORQF))  D
"RTN","PSJOC",99,0)
 ..F  S PSJDD=$O(PSJALLGY(PSJALLGS,PSJCC,PSJDD)) Q:PSJDD=""!($G(PSGORQF))  S:PSJALLGS="A" PSJDGFLG=0 D EN^PSJGMRA(DFN,PSJDD) S PSJDGFLG=1
"RTN","PSJOC",100,0)
 K PSJXX,PSJYY,PSJDD,PSJCC,PSJALLGY,DACNT,PSJGGDN
"RTN","PSJOC",101,0)
 Q
"RTN","PSJOC",102,0)
DSPORD(ON,PSJNLST,PSJCLINF) ;Display the order data
"RTN","PSJOC",103,0)
 ;ON - ON_U/V/P ex: 21V
"RTN","PSJOC",104,0)
 ;PSJNLST - It's number list and also use to trigger pg break, line break
"RTN","PSJOC",105,0)
 NEW PSJCOL,PSJX,PSJOC,PSJLINE,X
"RTN","PSJOC",106,0)
 Q:ON=""
"RTN","PSJOC",107,0)
 S:'$D(PSJCLINF) PSJCLINF=";0"
"RTN","PSJOC",108,0)
 S PSJLINE=1,PSJCOL=1
"RTN","PSJOC",109,0)
 I $P(PSJCLINF,";",2) D CLNDISP^PSJCLNOC(.PSJCLINF) D  Q
"RTN","PSJOC",110,0)
 .I $G(PSJNLST)="",(($Y+6)>IOSL) D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",111,0)
 I ON'["V" D DSPLORDU^PSJLMUT1(DFN,ON)
"RTN","PSJOC",112,0)
 I ON["V" D DSPLORDV^PSJLMUT1(DFN,ON)
"RTN","PSJOC",113,0)
 F PSJX=0:0 S PSJX=$O(PSJOC(ON,PSJX)) Q:'PSJX  D
"RTN","PSJOC",114,0)
 . I $G(PSJNLST)="",(($Y+6)>IOSL) D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",115,0)
 . W !
"RTN","PSJOC",116,0)
 . I $G(PSJNLST) W:(PSJX=1) PSJNLST W:(PSJX>1) ?$L(PSJNLST)
"RTN","PSJOC",117,0)
 . S X=PSJOC(ON,PSJX)
"RTN","PSJOC",118,0)
 . W $E(X,9,$L(X))
"RTN","PSJOC",119,0)
 W !
"RTN","PSJOC",120,0)
 Q
"RTN","PSJOC",121,0)
 ;
"RTN","PSJOC",122,0)
DRUGERR ;Display drug level errors
"RTN","PSJOC",123,0)
 NEW PSJPON,PSJN,PSJNV,PSJDSPFG,PSJPERR,PSJX,PSJLINEF
"RTN","PSJOC",124,0)
 ;Only display the exceptions once per patient. Use the exception from prospective drug if exception(s) existed for the 
"RTN","PSJOC",125,0)
 ; same drug on the profile.
"RTN","PSJOC",126,0)
 ;PSJEXCPT(PSJDNM_REASON) - Array for invalid drugs that already display to once within a pt selection
"RTN","PSJOC",127,0)
 S PSJDSPFG=0
"RTN","PSJOC",128,0)
 S PSJPERR=$$PROSPERR()
"RTN","PSJOC",129,0)
 I PSJPERR D  Q
"RTN","PSJOC",130,0)
 . I PSJDSPFG&(($Y+4)>IOSL) D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",131,0)
 I $D(PSJEXCPT("PROFILE")),'$G(PSJDGCK) Q
"RTN","PSJOC",132,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON)) Q:PSJPON=""  D
"RTN","PSJOC",133,0)
 . F PSJN=0:0 S PSJN=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN)) Q:'PSJN  D
"RTN","PSJOC",134,0)
 .. I '$G(PSJLINEF) W ! S PSJLINEF=1
"RTN","PSJOC",135,0)
 .. S PSJNV=$G(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN))
"RTN","PSJOC",136,0)
 .. ;I ($P(PSJPON,";",3)="PROSPECTIVE") S PSJX='$$ERRCHK("PROSPECTIVE",$P(PSJNV,U,3)_$P(PSJNV,U,10))
"RTN","PSJOC",137,0)
 .. I ($P(PSJPON,";",3)'="PROFILE") Q
"RTN","PSJOC",138,0)
 .. I '$$ERRCHK("PROFILE",$P(PSJNV,U,3)_$P(PSJNV,U,10)) Q
"RTN","PSJOC",139,0)
 .. D DSPDRGER()
"RTN","PSJOC",140,0)
 I PSJDSPFG&(($Y+4)>IOSL) D PAUSE^PSJLMUT1 W @IOF S PSJDERR2=1
"RTN","PSJOC",141,0)
 Q
"RTN","PSJOC",142,0)
DSPDRGER(PSJDSFLG) ;
"RTN","PSJOC",143,0)
 NEW PSJTXT
"RTN","PSJOC",144,0)
 S PSJTXT=$P(PSJNV,U,7)
"RTN","PSJOC",145,0)
 ;W:$G(PSGCOPY)!($G(PSIVCOPY)) !
"RTN","PSJOC",146,0)
 S X="Enhanced Order Checks cannot "
"RTN","PSJOC",147,0)
 I $G(PSJDSFLG),(PSJTXT[X) S PSJTXT="Dosing Checks could not "_$P(PSJTXT,X,2)
"RTN","PSJOC",148,0)
 S PSJDSPFG=1
"RTN","PSJOC",149,0)
 K PSJPAUSE
"RTN","PSJOC",150,0)
 I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",151,0)
 W !
"RTN","PSJOC",152,0)
 D WRITE^PSJMISC(PSJTXT,,79)
"RTN","PSJOC",153,0)
 I $P(PSJNV,U,10)]"" D WRITE^PSJMISC("Reason(s): "_$P(PSJNV,U,10),3,79) S PSJDERF2=1
"RTN","PSJOC",154,0)
 ;W !
"RTN","PSJOC",155,0)
 Q
"RTN","PSJOC",156,0)
ERRCHK(PSJTYPE,PSJX) ;
"RTN","PSJOC",157,0)
 ;PSJTYPE - Either "PROFILE" or "PROSPECTIVE"
"RTN","PSJOC",158,0)
 ;PSJX - Drug name_Error reason
"RTN","PSJOC",159,0)
 ;Return 1 if this error drug has not displayed to the user.
"RTN","PSJOC",160,0)
 I $G(PSJX)="" Q 0
"RTN","PSJOC",161,0)
 I $G(PSJTYPE)="" Q 0
"RTN","PSJOC",162,0)
 ;I PSJTYPE="PROFILE",'$D(PSJEXCPT(PSJTYPE,PSJX)) S PSJEXCPT(PSJTYPE,PSJX)="" Q 1
"RTN","PSJOC",163,0)
 I PSJTYPE="PROFILE" S PSJEXCPT(PSJTYPE,PSJX)="" Q 1
"RTN","PSJOC",164,0)
 I PSJTYPE="PROSPECTIVE",'$D(PSJEXCPT(PSJTYPE,PSJX)) S PSJEXCPT(PSJTYPE,PSJX)="" Q 1
"RTN","PSJOC",165,0)
 Q 0
"RTN","PSJOC",166,0)
PING(PSJMSG) ;Check if FDB is down.  Return 0 if it is
"RTN","PSJOC",167,0)
 ;pass in a message to customize the display
"RTN","PSJOC",168,0)
 S ^TMP($J,"PSJPRE","IN","PING")=""
"RTN","PSJOC",169,0)
 D IN^PSSHRQ2("PSJPRE")
"RTN","PSJOC",170,0)
 Q $$DSPSERR($G(PSJMSG))
"RTN","PSJOC",171,0)
DSPSERR(PSJMSG) ;Display system errors
"RTN","PSJOC",172,0)
 NEW X
"RTN","PSJOC",173,0)
 S X=$G(^TMP($J,"PSJPRE","OUT",0))
"RTN","PSJOC",174,0)
 I $P(X,U)=-1 D NOFDB($P(X,U,2),$G(PSJMSG))
"RTN","PSJOC",175,0)
 Q $S($P(X,U)=-1:0,1:1)
"RTN","PSJOC",176,0)
NOFDB(PSJX,PSJMSG) ;Display connection down message
"RTN","PSJOC",177,0)
 NEW X
"RTN","PSJOC",178,0)
 Q:$G(PSJX)=""
"RTN","PSJOC",179,0)
 I $G(PSJMSG)]"" W !!,PSJMSG
"RTN","PSJOC",180,0)
 I $G(PSJMSG)="" W !!,"No Enhanced Order Checks can be performed."
"RTN","PSJOC",181,0)
 W !,"   Reason(s): ",PSJX,!!
"RTN","PSJOC",182,0)
 K PSJX
"RTN","PSJOC",183,0)
 D:$G(PSJMSG)]"" PAUSE^PSJLMUT1
"RTN","PSJOC",184,0)
 Q
"RTN","PSJOC",185,0)
PROSPERR() ;Display exceptions for prospective drug
"RTN","PSJOC",186,0)
 NEW PSJPON,PSJN,PSJNV,PSJPERR
"RTN","PSJOC",187,0)
 ;If all prospectives are caught in the exception then display them only and omit the profile drugs
"RTN","PSJOC",188,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON)) Q:PSJPON=""  D
"RTN","PSJOC",189,0)
 . F PSJN=0:0 S PSJN=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN)) Q:'PSJN  D
"RTN","PSJOC",190,0)
 .. S PSJNV=$G(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN))
"RTN","PSJOC",191,0)
 .. I $P(PSJPON,";",3)="PROFILE" Q 
"RTN","PSJOC",192,0)
 .. I ($P(PSJPON,";",3)="PROSPECTIVE") S PSJX='$$ERRCHK("PROSPECTIVE",$P(PSJNV,U,3)_$P(PSJNV,U,10))
"RTN","PSJOC",193,0)
 .. D DSPDRGER() S PSJDSPFG=1
"RTN","PSJOC",194,0)
 ;If the prospective drug(s) is caught in the exception, the exception for profile drug(s) is not display.
"RTN","PSJOC",195,0)
 ;  The exception for the prospective is the only one need to display.
"RTN","PSJOC",196,0)
 S PSJPERR=1
"RTN","PSJOC",197,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","IN","PROSPECTIVE",PSJPON)) Q:PSJPON=""  D
"RTN","PSJOC",198,0)
 . I $D(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON)) Q
"RTN","PSJOC",199,0)
 . S (PSJDSPFG,PSJPERR)=0
"RTN","PSJOC",200,0)
 Q PSJPERR
"RTN","PSJOCDS")
0^5^B89631244
"RTN","PSJOCDS",1,0)
PSJOCDS ;BIR/MV - SET INPUT DATA FOR DOSING ORDER CHECKS ;6 Jun 07 / 3:37 PM
"RTN","PSJOCDS",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**181,252,257,256**;16 DEC 97;Build 34
"RTN","PSJOCDS",3,0)
 ;
"RTN","PSJOCDS",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJOCDS",5,0)
 ; Reference to ^PS(51.1 is supported by DBIA #2177.
"RTN","PSJOCDS",6,0)
 ; Reference to ^PSSORPH is supported by DBIA #3234.
"RTN","PSJOCDS",7,0)
 ; Reference to ^PSSDSAPI is supported by DBIA #5425.
"RTN","PSJOCDS",8,0)
 ; Reference to ^PSSDSAPD is supported by DBIA #5426.
"RTN","PSJOCDS",9,0)
 ; Reference to FULL^VALM1 and PAUSE^VALM1 is supported by DBIA #10116.
"RTN","PSJOCDS",10,0)
 ;
"RTN","PSJOCDS",11,0)
 ;The Dose API will be processed separately than the DD & DT order checks
"RTN","PSJOCDS",12,0)
 ;
"RTN","PSJOCDS",13,0)
IN(PSJPON,PSJTYPE,PSJDD) ;
"RTN","PSJOCDS",14,0)
 ;PSJPON - Order number
"RTN","PSJOCDS",15,0)
 ;PSJPTYPE - UD/IV
"RTN","PSJOCDS",16,0)
 ;PSJDD - Dispense drug IEN (for UD order only)
"RTN","PSJOCDS",17,0)
 ;
"RTN","PSJOCDS",18,0)
 ;PSJOVR array is defined when OVERLAP^PSGOEF2 is called.
"RTN","PSJOCDS",19,0)
 ;
"RTN","PSJOCDS",20,0)
 NEW PSJDSOFF,PSJCNT
"RTN","PSJOCDS",21,0)
 D FULL^VALM1
"RTN","PSJOCDS",22,0)
 S PSJDSOFF=$$DS^PSSDSAPI()
"RTN","PSJOCDS",23,0)
 I '+PSJDSOFF D DOSEOFF^PSJOCDSD($P(PSJDSOFF,U,2)) Q
"RTN","PSJOCDS",24,0)
 NEW PSJOCDS,PSJFDB,PSJBASE,PSJOVR,PSJOVRLP,PSJX
"RTN","PSJOCDS",25,0)
 K PSJOCDS,PSJFDB
"RTN","PSJOCDS",26,0)
 ;I '$$PING^PSJOC("Maximum Single Dose Check could not be performed") Q
"RTN","PSJOCDS",27,0)
 I '$$PING^PSJOC("Dosing Checks could not be performed.") Q
"RTN","PSJOCDS",28,0)
 K ^TMP($J,"PSJPRE"),^TMP($J,"PSJPRE1")
"RTN","PSJOCDS",29,0)
 S PSJBASE(1)="PSJPRE",PSJBASE(3)="PSJPRE1"
"RTN","PSJOCDS",30,0)
 ;
"RTN","PSJOCDS",31,0)
 ;;**** Commented out complex dosing
"RTN","PSJOCDS",32,0)
 ;;PSJOCDSC("CX","PSJCOM") is to flag if dosing checks needs to handle complex orders.
"RTN","PSJOCDS",33,0)
 ;;*I '$D(PSJOCDSC("CX","PSJCOM")) D
"RTN","PSJOCDS",34,0)
 ;;*. I $G(PSJCOM),$$CONJ^PSJOCDSC() S PSJOCDSC("CX","PSJCOM")=1
"RTN","PSJOCDS",35,0)
 ;;*I $G(PSJOCDSC("CX","PSJCOM")),'$D(PSJOCDSC("CX","ACX")) D SETLST^PSJOCDSC(PSJPON)
"RTN","PSJOCDS",36,0)
 ;;*I PSJTYPE="UD" D UD I $G(PSJOCDSC("CX","PSJCOM")) D COMPLEX^PSJOCDSC Q
"RTN","PSJOCDS",37,0)
 ;;*I PSJTYPE="IV" D IN^PSIVOCDS("PSJPRE") D:$G(PSJOCDSC("CX","PSJCOM")) IV^PSJOCDSC(PSJPON),UPDLST^PSJOCDSC(PSJPON,2)
"RTN","PSJOCDS",38,0)
 ;;**** End Complex dosing
"RTN","PSJOCDS",39,0)
 ;
"RTN","PSJOCDS",40,0)
 ;;****To be removed when complex dosing is ready
"RTN","PSJOCDS",41,0)
 I PSJTYPE="UD" D UD
"RTN","PSJOCDS",42,0)
 I PSJTYPE="IV" D IN^PSIVOCDS("PSJPRE")
"RTN","PSJOCDS",43,0)
 ;;****END
"RTN","PSJOCDS",44,0)
 ;
"RTN","PSJOCDS",45,0)
 I '$D(PSJFDB) Q
"RTN","PSJOCDS",46,0)
 ;;*If complex order then set conjunction to "Then" so low dose warning is screened out.
"RTN","PSJOCDS",47,0)
 ;;*I $G(PSJCOM),$$ALLTHEN^PSJOCDSC() D
"RTN","PSJOCDS",48,0)
 ;;*. F PSJX=0:0 S PSJX=$O(PSJOCDS(PSJX)) Q:'PSJX  S PSJOCDS(PSJX,"CONJ")="T"
"RTN","PSJOCDS",49,0)
 D DOSE^PSSDSAPD(.PSJBASE,DFN,.PSJOCDS,.PSJFDB)
"RTN","PSJOCDS",50,0)
 D DISPLAY^PSJOCDSD
"RTN","PSJOCDS",51,0)
 ;I '$G(PSGORQF),(PSJTYPE="IV"),$G(PSJOCDSC("CX","PSJCOM")) D NODAILY^PSJOCDSP(PSJPON)
"RTN","PSJOCDS",52,0)
 K ^TMP($J,"PSJPRE"),^TMP($J,"PSJPRE1")
"RTN","PSJOCDS",53,0)
 Q
"RTN","PSJOCDS",54,0)
UD ;Process data from a UD order
"RTN","PSJOCDS",55,0)
 NEW PSJDS,PSJFREQ,X
"RTN","PSJOCDS",56,0)
 ;At this state a dispense drug should be selected already.  But just incase...
"RTN","PSJOCDS",57,0)
 Q:'+PSJDD
"RTN","PSJOCDS",58,0)
 K PSJOCDS,PSJFDB
"RTN","PSJOCDS",59,0)
 ;If the drug is to be exempted then exclude it from the dose check
"RTN","PSJOCDS",60,0)
 Q:$$EXMT^PSSDSAPI(PSJDD)
"RTN","PSJOCDS",61,0)
 S PSJCNT=1
"RTN","PSJOCDS",62,0)
 S PSJDS=""
"RTN","PSJOCDS",63,0)
 ;
"RTN","PSJOCDS",64,0)
 S PSJOCDS("CONTEXT")="IP-UD"
"RTN","PSJOCDS",65,0)
 S X=$$DOSE()
"RTN","PSJOCDS",66,0)
 S PSJOCDS(PSJCNT,"DRG_AMT")=$P(X,U)
"RTN","PSJOCDS",67,0)
 S PSJOCDS(PSJCNT,"DRG_UNIT")=$P(X,U,2)
"RTN","PSJOCDS",68,0)
 S PSJOCDS(PSJCNT,"DO")=$P(X,U,3)
"RTN","PSJOCDS",69,0)
 ;
"RTN","PSJOCDS",70,0)
 S X=$$DATES(PSJPON)
"RTN","PSJOCDS",71,0)
 S X=$$DURATION($P(X,U),$P(X,U,2))
"RTN","PSJOCDS",72,0)
 ;S X=$$DURATION($G(PSGSD),$G(PSGFD))
"RTN","PSJOCDS",73,0)
 S PSJOCDS(PSJCNT,"DRATE")=$S(+X:X_"M",1:"")
"RTN","PSJOCDS",74,0)
 ;S PSJOCDS(PSJCNT,"DUR")=X
"RTN","PSJOCDS",75,0)
 ;S PSJOCDS(PSJCNT,"DUR_RT")=$S(+X:"MINUTE",1:"")
"RTN","PSJOCDS",76,0)
 S PSJOCDS(PSJCNT,"MR_IEN")=$G(PSGMR)
"RTN","PSJOCDS",77,0)
 S PSJOCDS(PSJCNT,"SCHEDULE")=$G(PSGSCH)
"RTN","PSJOCDS",78,0)
 D FDBDATA
"RTN","PSJOCDS",79,0)
 ;D LITER
"RTN","PSJOCDS",80,0)
 Q
"RTN","PSJOCDS",81,0)
FDBDATA ;Set data needed by FDB's Dose API
"RTN","PSJOCDS",82,0)
 ;Use the OI + Dosage form when display drug name.  If OI IEN doesn't exist, use DD name
"RTN","PSJOCDS",83,0)
 NEW PSJOINM,PSJXSCH,X,PSJSFFG
"RTN","PSJOCDS",84,0)
 S PSJFDB(PSJCNT,"RX_NUM")="I;"_PSJPON_";PROSPECTIVE;"_PSJCNT
"RTN","PSJOCDS",85,0)
 S PSJFDB(PSJCNT,"DRUG_IEN")=PSJDD
"RTN","PSJOCDS",86,0)
 S PSJOINM="",PSJSFFG=0
"RTN","PSJOCDS",87,0)
 ; ^PS(53.45 nodes are not set for speed renew at this point.
"RTN","PSJOCDS",88,0)
 I +$G(PSJSPEED),($G(PSGOEE)="R"),(PSJPON["P") S PSJOINM=$$OINM(PSJPON),PSJSFFG=1
"RTN","PSJOCDS",89,0)
 I 'PSJSFFG S PSJOINM=$$DRGNM^PSGSICHK()
"RTN","PSJOCDS",90,0)
 S PSJFDB(PSJCNT,"DRUG_NM")=$S(PSJOINM]"":PSJOINM,1:$$DN^PSJMISC(+PSJDD))
"RTN","PSJOCDS",91,0)
 I PSJOCDS(PSJCNT,"DO")=(PSJOCDS(PSJCNT,"DRG_AMT")_PSJOCDS(PSJCNT,"DRG_UNIT")) D
"RTN","PSJOCDS",92,0)
 . Q:PSJOCDS(PSJCNT,"DO")=""
"RTN","PSJOCDS",93,0)
 .;Strip off leading zero otherwise FDB triggers an "Invalid or Undefined Dose"
"RTN","PSJOCDS",94,0)
 . S X=PSJOCDS(PSJCNT,"DRG_AMT")
"RTN","PSJOCDS",95,0)
 . S PSJFDB(PSJCNT,"DOSE_AMT")=$S(+X=0:X,1:+X)
"RTN","PSJOCDS",96,0)
 . S PSJFDB(PSJCNT,"DOSE_UNIT")=$$UNIT^PSSDSAPI(PSJOCDS(PSJCNT,"DRG_UNIT"))
"RTN","PSJOCDS",97,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSJOCDS",98,0)
 ;
"RTN","PSJOCDS",99,0)
 S X="",PSJXSCH=PSGSCH
"RTN","PSJOCDS",100,0)
 I $G(PSGS0XT)="" S PSGS0XT=$$DOW^PSJAPIDS(PSGSCH)
"RTN","PSJOCDS",101,0)
 ;"I $G(PSGS0XT)="D,$G(PSGS0Y)]"" S $P(PSJXSCH,"@",2)=$G(PSGS0Y)
"RTN","PSJOCDS",102,0)
 I $G(PSGS0XT)="D" S PSJXSCH=$$DOWCHK(PSJXSCH,$G(PSGS0Y))
"RTN","PSJOCDS",103,0)
 I $G(PSGSCH)]"" S X=$P($$FRQ^PSSDSAPI(PSJXSCH,$G(PSGS0XT),"I",,PSJDD),U)
"RTN","PSJOCDS",104,0)
 I X="" S X=1 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSJOCDS",105,0)
 S PSJFDB(PSJCNT,"FREQ")=X
"RTN","PSJOCDS",106,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSJOCDS",107,0)
 S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSJOCDS",108,0)
 S PSJFDB(PSJCNT,"ROUTE")=$P($$MRT^PSSDSAPI($G(PSGMR)),U,2)
"RTN","PSJOCDS",109,0)
 S PSJFDB(PSJCNT,"DOSE_TYPE")="MAINTENANCE"
"RTN","PSJOCDS",110,0)
 S PSJFDB(PSJCNT,"SPECIFIC")=1
"RTN","PSJOCDS",111,0)
 ;Set data for onetime or <24 hours order
"RTN","PSJOCDS",112,0)
 S X=$$ONE^PSJORPOE($G(PSGSCH))
"RTN","PSJOCDS",113,0)
 I +X!($G(PSGST)="O")!+$$ONCALL^PSJMISC($G(PSGSCH),$G(PSGST)) D  Q
"RTN","PSJOCDS",114,0)
 . K PSJFDB(PSJCNT,"FRQ_ERROR")
"RTN","PSJOCDS",115,0)
 . S PSJFDB(PSJCNT,"DOSE_TYPE")="SINGLE DOSE"
"RTN","PSJOCDS",116,0)
 . S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSJOCDS",117,0)
 . S PSJFDB(PSJCNT,"DURATION_RT")=PSJFDB(PSJCNT,"DURATION_RT")
"RTN","PSJOCDS",118,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSJOCDS",119,0)
 I +PSJOCDS(PSJCNT,"DRATE") D UND24HRS(+PSJOCDS(PSJCNT,"DRATE"),$G(PSGAT),$G(PSGS0XT),PSGSD,PSGFD,PSGSCH)
"RTN","PSJOCDS",120,0)
 Q
"RTN","PSJOCDS",121,0)
DOWCHK(PSJSCHD,PSJADM) ;Append the admin times to the schedule if it's not defined in 51.1
"RTN","PSJOCDS",122,0)
 ;Assuming the shedule is day of the week
"RTN","PSJOCDS",123,0)
 ;PSJSCHD - the schedule from the order
"RTN","PSJOCDS",124,0)
 ;PSJADM - the admin times from the order
"RTN","PSJOCDS",125,0)
 ;Output - the schedule name (as entered or appended to the schedule)
"RTN","PSJOCDS",126,0)
 I $G(PSJSCHD)="" Q ""
"RTN","PSJOCDS",127,0)
 I $D(^PS(51.1,"B",PSJSCHD)) Q PSJSCHD
"RTN","PSJOCDS",128,0)
 I $G(PSJADM)]"" S $P(PSJSCHD,"@",2)=PSJADM Q PSJSCHD
"RTN","PSJOCDS",129,0)
 Q PSJSCHD
"RTN","PSJOCDS",130,0)
LITER ;FDB requires "L" instead of ML for the particular conditions below
"RTN","PSJOCDS",131,0)
 ;PSJ*5*252 (6/29/11)- This module is longer called since FDB handles either "ML" or "L" now.
"RTN","PSJOCDS",132,0)
 NEW PSJXDO
"RTN","PSJOCDS",133,0)
 Q:'$G(PSJDD)
"RTN","PSJOCDS",134,0)
 Q:$G(PSJFDB(1,"ROUTE"))'="INTRAVENOUS"
"RTN","PSJOCDS",135,0)
 Q:$G(PSGST)'="R"
"RTN","PSJOCDS",136,0)
 Q:$$VAGEN^PSJMISC(PSJDD)'["POTASSIUM"
"RTN","PSJOCDS",137,0)
 Q:$$CLASS^PSJMISC(PSJDD)'="TN102"
"RTN","PSJOCDS",138,0)
 S PSJXDO=PSJOCDS(PSJCNT,"DO")
"RTN","PSJOCDS",139,0)
 I PSJXDO["ML" D
"RTN","PSJOCDS",140,0)
 . Q:'+PSJXDO
"RTN","PSJOCDS",141,0)
 . S (PSJOCDS(PSJCNT,"DRG_AMT"),PSJFDB(PSJCNT,"DOSE_AMT"))=+(+PSJXDO/1000)
"RTN","PSJOCDS",142,0)
 . S (PSJOCDS(1,"DRG_UNIT"),PSJFDB(PSJCNT,"DOSE_UNIT"))="L"
"RTN","PSJOCDS",143,0)
 Q
"RTN","PSJOCDS",144,0)
UND24HRS(PSJDUR,PSGAT,PSGS0XT,PSGSD,PSGFD,PSGSCH) ;
"RTN","PSJOCDS",145,0)
 ;*** This line tag is called by ^PSIVOCDS also ***
"RTN","PSJOCDS",146,0)
 ;PSJDUR - order duration in minutes
"RTN","PSJOCDS",147,0)
 ;PSGAT - admin times
"RTN","PSJOCDS",148,0)
 ;PSGS0XT - Order Frequency
"RTN","PSJOCDS",149,0)
 NEW PSJNDOSE,PSJFRQ1,PSJFRQX,PSJX
"RTN","PSJOCDS",150,0)
 Q:'+$G(PSJDUR)
"RTN","PSJOCDS",151,0)
 ; Set frequency to # of amdin times
"RTN","PSJOCDS",152,0)
 I ($G(PSGAT)]"") D  Q
"RTN","PSJOCDS",153,0)
 . S PSJX=$$DATES(PSJPON)
"RTN","PSJOCDS",154,0)
 . S PSJNDOSE=$$CNTDOSE($P(PSJX,U),$P(PSJX,U,2))
"RTN","PSJOCDS",155,0)
 . I PSJNDOSE S PSJFDB(PSJCNT,"FREQ")=PSJNDOSE Q
"RTN","PSJOCDS",156,0)
 ; Set frequency based on frequency(51.1)
"RTN","PSJOCDS",157,0)
 ; NUMB^PSSDSAPI is removed for MOCHA 2.1. Need to make sure PSJFRQ1 is in numeric value
"RTN","PSJOCDS",158,0)
 ;;S PSJFRQ2=$P($$FRQ^PSSDSAPI($G(PSGSCH),$G(PSGS0XT),"I",PSJDUR_"M",PSJDD),U)
"RTN","PSJOCDS",159,0)
 S PSJFRQ1=$P($$FRQ^PSSDSAPI($G(PSGSCH),$G(PSGS0XT),"I",PSJDUR_"M",PSJDD),U)
"RTN","PSJOCDS",160,0)
 ;;I PSJFRQ2?1"Q"1N.N1"H" S PSJFRQ2=1440/(+$E(PSJFRQ2,2,$L(PSJFRQ2))*60)
"RTN","PSJOCDS",161,0)
 ;;I PSJFRQ2?1"X"1N.N1"D" S PSJFRQ2=+$E(PSJFRQ2,2,$L(PSJFRQ2))
"RTN","PSJOCDS",162,0)
 ;;I +PSJFRQ2 S PSJFRQ1=(PSJFRQ2/24)*(+PSJDUR/60)
"RTN","PSJOCDS",163,0)
 ; If no value returned from FRQ^PSSDSAPI and frequency is there then set freq = duration in min / freq in min
"RTN","PSJOCDS",164,0)
 I '+$G(PSJFRQ1),+$G(PSGS0XT) S PSJFRQ1=(+PSJDUR)/PSGS0XT
"RTN","PSJOCDS",165,0)
 ; Calculate freq from number of dose admin per day (round up)
"RTN","PSJOCDS",166,0)
 S PSJFDB(PSJCNT,"FREQ")=$S(PSJFRQ1?.N:PSJFRQ1,1:$J((+$G(PSJFRQ1)+.5),0,0))
"RTN","PSJOCDS",167,0)
 I PSJFDB(PSJCNT,"FREQ")'=0 Q
"RTN","PSJOCDS",168,0)
 ; If no admin times or frequency(51.1) set error
"RTN","PSJOCDS",169,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSJOCDS",170,0)
 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSJOCDS",171,0)
 Q
"RTN","PSJOCDS",172,0)
CNTDOSE(PSGSD,PSGFD) ;Count # of admins to set the Freq to
"RTN","PSJOCDS",173,0)
 ;only do this if the start & stop dates are within 24 hours.
"RTN","PSJOCDS",174,0)
 NEW PSJX,PSJADMIN,PSJCNT,PSJSTRTM,PSJSTPTM,PSJDTFLG
"RTN","PSJOCDS",175,0)
 I $G(PSGAT)="" Q 0
"RTN","PSJOCDS",176,0)
 I $G(PSGSD)="" Q 0
"RTN","PSJOCDS",177,0)
 I $G(PSGFD)="" Q 0
"RTN","PSJOCDS",178,0)
 I ($$FMDIFF^XLFDT(PSGFD,PSGSD,2)/60)>1440 Q 0
"RTN","PSJOCDS",179,0)
 S PSJCNT=0
"RTN","PSJOCDS",180,0)
 S PSJSTRTM=$E($P(PSGSD,".",2)_"0000",1,4)
"RTN","PSJOCDS",181,0)
 S PSJSTPTM=$E($P(PSGFD,".",2)_"0000",1,4)
"RTN","PSJOCDS",182,0)
 S PSJDTFLG=0
"RTN","PSJOCDS",183,0)
 I $P(PSGSD,".")=$P(PSGFD,".") S PSJDTFLG=1
"RTN","PSJOCDS",184,0)
 F PSJX=1:1 S PSJADMIN=$P(PSGAT,"-",PSJX) Q:PSJADMIN=""  D
"RTN","PSJOCDS",185,0)
 . S PSJADMIN=$E($P(PSGAT,"-",PSJX)_"0000",1,4)
"RTN","PSJOCDS",186,0)
 . I PSJDTFLG D  Q
"RTN","PSJOCDS",187,0)
 .. I (PSJSTRTM'>PSJADMIN),(PSJADMIN<PSJSTPTM) S PSJCNT=PSJCNT+1
"RTN","PSJOCDS",188,0)
 . I (PSJSTRTM'>PSJADMIN) S PSJCNT=PSJCNT+1
"RTN","PSJOCDS",189,0)
 . I (PSJSTPTM>PSJADMIN) S PSJCNT=PSJCNT+1
"RTN","PSJOCDS",190,0)
 Q PSJCNT
"RTN","PSJOCDS",191,0)
DURATION(PSGSD,PSGFD) ;Figure out the duration from the start, stop dates
"RTN","PSJOCDS",192,0)
 ;Return the diff between Stop - Start date in minutes.  If > 1 day then return null
"RTN","PSJOCDS",193,0)
 NEW PSJDIFF
"RTN","PSJOCDS",194,0)
 I '$D(PSGFD)!'$D(PSGSD) Q ""
"RTN","PSJOCDS",195,0)
 S PSJDIFF=$$FMDIFF^XLFDT(PSGFD,PSGSD,2)/60
"RTN","PSJOCDS",196,0)
 I (PSJDIFF<1440) Q PSJDIFF
"RTN","PSJOCDS",197,0)
 Q ""
"RTN","PSJOCDS",198,0)
DOSE() ;Figure out the dose, unit, & dosage Ordered
"RTN","PSJOCDS",199,0)
 ;Return 3 pieces: Numeric Dose ^ Unit ^ Dosage Ordered
"RTN","PSJOCDS",200,0)
 NEW PSJDS,PSJND0,PSJND2,X,PSJX,PSJXDOX,PSJNDS,PSJALLGY
"RTN","PSJOCDS",201,0)
 S PSJDS=""
"RTN","PSJOCDS",202,0)
 ;Subsequence orders in the Complex order has the PSGDO from the first order. Get new PSGDO
"RTN","PSJOCDS",203,0)
 I $G(PSJPON)["U",$S($G(PSJCOM):1,$G(PSGRENEW):1,1:0) S PSGDO=$P($G(^PS(55,DFN,5,+PSJPON,.2)),U,2)
"RTN","PSJOCDS",204,0)
 ;If the dose & unit exist use them
"RTN","PSJOCDS",205,0)
 I +$G(PSJDOSE("DO"))_$P($G(PSJDOSE("DO")),U,2)=$G(PSGDO) Q PSJDOSE("DO")_U_$G(PSGDO)
"RTN","PSJOCDS",206,0)
 ;Get dd, dose, unit from the order
"RTN","PSJOCDS",207,0)
 I $G(PSGORD)]"",'+$G(PSJDD) D
"RTN","PSJOCDS",208,0)
 . I PSGORD["P" S PSJND2=$G(^PS(53.1,+PSGORD,.2)),PSJDD=$O(^PS(53.1,+PSGORD,1,"B",0))
"RTN","PSJOCDS",209,0)
 . I PSGORD["U" S PSJND2=$G(^PS(55,DFN,5,+PSGORD,.2)),PSJDD=$O(^PS(55,+DFN,5,+PSGORD,1,"B",0))
"RTN","PSJOCDS",210,0)
 ;If no numeric dose and there is a dosage ordered then get dose & unit from the order
"RTN","PSJOCDS",211,0)
 I $D(PSGORD),$G(PSGDO)]"" D
"RTN","PSJOCDS",212,0)
 . S PSJDS=$P($G(PSJND2),U,5,6)
"RTN","PSJOCDS",213,0)
 Q:+PSJDS PSJDS_U_$G(PSGDO)
"RTN","PSJOCDS",214,0)
 ;Get dispense unit per dose and figure out numeric and unit
"RTN","PSJOCDS",215,0)
 I +$G(PSJDD),($G(PSGDO)]"") D
"RTN","PSJOCDS",216,0)
 . S PSJDS=$$DOSE1()
"RTN","PSJOCDS",217,0)
 . I $P($G(PSJXDOX(1)),U,11)=$$UP^XLFSTR(PSGDO) Q:+PSJDS
"RTN","PSJOCDS",218,0)
 . S PSJDS=""
"RTN","PSJOCDS",219,0)
 . S PSJX=$G(PSJXDOX(1))
"RTN","PSJOCDS",220,0)
 . I +PSJX S X=+PSGDO/+PSJX S PSJDS=$$DOSE1(X)
"RTN","PSJOCDS",221,0)
 . I $P($G(PSJXDOX(1)),U,11)=$$UP^XLFSTR(PSGDO) Q:+PSJDS
"RTN","PSJOCDS",222,0)
 . S PSJDS=""
"RTN","PSJOCDS",223,0)
 Q:+PSJDS PSJDS
"RTN","PSJOCDS",224,0)
 I +$G(PSJDD),($G(PSGDO)=""),($G(PSGORD)="") D
"RTN","PSJOCDS",225,0)
 . S PSJDS=$$DOSE1($S(+$G(PSGUD):PSGUD,1:1))
"RTN","PSJOCDS",226,0)
 Q:+PSJDS PSJDS
"RTN","PSJOCDS",227,0)
 ;Figure out dose & unit from the dispense drug.  Dosage Ordered is required for multiple dispense drugs
"RTN","PSJOCDS",228,0)
 I $G(PSGDO)="" D
"RTN","PSJOCDS",229,0)
 . S PSJND0=$$DD53P45^PSJMISC()
"RTN","PSJOCDS",230,0)
 . I PSJND0="" S PSJND0=$G(PSGDRG)
"RTN","PSJOCDS",231,0)
 . S X=+$P(PSJND0,U,2) S PSJDS=$$DOSE1($S(X:X,1:1))
"RTN","PSJOCDS",232,0)
 Q:+PSJDS PSJDS
"RTN","PSJOCDS",233,0)
 Q "^^"_$G(PSGDO)
"RTN","PSJOCDS",234,0)
DOSE1(PSJDUP) ;
"RTN","PSJOCDS",235,0)
 ;PSJDUP - Dispense unit per dose
"RTN","PSJOCDS",236,0)
 NEW PSJDS
"RTN","PSJOCDS",237,0)
 Q:'+$G(PSJDD)
"RTN","PSJOCDS",238,0)
 K PSJXDOX
"RTN","PSJOCDS",239,0)
 S PSJDS=""
"RTN","PSJOCDS",240,0)
 D DOSE^PSSORPH(.PSJXDOX,+PSJDD,"U",,$G(PSJDUP))
"RTN","PSJOCDS",241,0)
 S:$G(PSJXDOX(1)) PSJDS=$P(PSJXDOX(1),U,1,2)_U_$P(PSJXDOX(1),U)_$P(PSJXDOX(1),U,2)
"RTN","PSJOCDS",242,0)
 Q PSJDS
"RTN","PSJOCDS",243,0)
DATES(PSJPON) ;Check the correct Start, Stop dates to use
"RTN","PSJOCDS",244,0)
 ;PSJOCDSC("CX",PSGsd/PSGfd,on)=default PSGsd/PSGfd date _^_ PSGsd/PSGfd _^_PSJFLG
"RTN","PSJOCDS",245,0)
 ;PSJP1 = Start date; PSJP2 = Stop date; PSJFLG = 1 if start or stop date has changed.
"RTN","PSJOCDS",246,0)
 ;For some reasons, PSGSD redefined to cal start date for Complex order (one with duration),
"RTN","PSJOCDS",247,0)
 ; PSGFD redefined to cal stop date.  These 2 fields reflect the default start, stop dates if they
"RTN","PSJOCDS",248,0)
 ; were edited.
"RTN","PSJOCDS",249,0)
 ;
"RTN","PSJOCDS",250,0)
 NEW PSJXSD,PSJXFD,PSJP1,PSJP2,PSJFLG,X
"RTN","PSJOCDS",251,0)
 I '+$G(PSJPON) Q $G(PSGSD)_U_$G(PSGFD)_U_0
"RTN","PSJOCDS",252,0)
 S PSJFLG=0
"RTN","PSJOCDS",253,0)
 S PSJP1=$G(PSGSD),PSJP2=$G(PSGFD)
"RTN","PSJOCDS",254,0)
 I $D(PSJOCDSC("CX","PSGSD")) D
"RTN","PSJOCDS",255,0)
 . S PSJXSD=$G(PSJOCDSC("CX","PSGSD",+PSJPON))
"RTN","PSJOCDS",256,0)
 . S PSJXFD=$G(PSJOCDSC("CX","PSGFD",+PSJPON))
"RTN","PSJOCDS",257,0)
 . I PSGSD=$P(PSJXSD,U,2) S PSJP1=$P(PSJXSD,U)
"RTN","PSJOCDS",258,0)
 .;
"RTN","PSJOCDS",259,0)
 . I $P(PSJXFD,U,2)]"",(PSGFD=$P(PSJXFD,U,2)) S PSJP2=$P(PSJXFD,U)
"RTN","PSJOCDS",260,0)
 . I $P(PSJXFD,U,2)="" S $P(PSJXFD,U,2)=PSGFD,PSJP2=PSGFD
"RTN","PSJOCDS",261,0)
 .;
"RTN","PSJOCDS",262,0)
 .; I $P(PSJXFD,U,2)="" S $P(PSJXFD,U,2)=PSGFD
"RTN","PSJOCDS",263,0)
 .; I PSGFD=$P(PSJXFD,U,2) S PSJP2=$P(PSJXFD,U)
"RTN","PSJOCDS",264,0)
 . I (PSJXSD]"")!(PSJXFD]"") D
"RTN","PSJOCDS",265,0)
 .. I $S($G(PSGSD)'=$P(PSJXSD,U,2):1,$G(PSGFD)'=$P(PSJXFD,U,2):1,1:0) S PSJFLG=1
"RTN","PSJOCDS",266,0)
 . S X=$G(^PS(53.1,+PSJPON,2.5))
"RTN","PSJOCDS",267,0)
 . ;Reset PSJP1 & PSJP2 from the order is needed when complex order defaulted to IV but FN as UD,
"RTN","PSJOCDS",268,0)
 . ; the calc Start/stop dates were used therefore the duration was not considered.
"RTN","PSJOCDS",269,0)
 . I (PSJPON["P"),(PSJFLG=0),($P(X,U,2)]"") S PSJP1=$P(X,U,1),PSJP2=$P(X,U,3)
"RTN","PSJOCDS",270,0)
 Q PSJP1_U_PSJP2_U_PSJFLG
"RTN","PSJOCDS",271,0)
OINM(PSJPON) ;For speed renew, returns OI name if order has multiple DD else returns null
"RTN","PSJOCDS",272,0)
 NEW PSJCNT,PSJDD,PSJOINM,PSJOI
"RTN","PSJOCDS",273,0)
 I $G(PSJPON)'["P" Q
"RTN","PSJOCDS",274,0)
 S PSJCNT=0
"RTN","PSJOCDS",275,0)
 F PSJDD=0:0 S PSJDD=$O(^PS(53.1,+PSJPON,1,PSJDD)) Q:'PSJDD  S PSJCNT=PSJCNT+1
"RTN","PSJOCDS",276,0)
 I PSJCNT>1 S PSJOI=+$G(^PS(53.1,+PSJPON,.2)) S PSJOINM=$$OIDF^PSJLMUT1(+PSJOI)
"RTN","PSJOCDS",277,0)
 Q $G(PSJOINM)
"RTN","PSJOCDSD")
0^6^B35364232
"RTN","PSJOCDSD",1,0)
PSJOCDSD ; BIR/MV,RN - PROCESS DOSING ORDER CHECKS ;6 Jun 07  3:37 PM
"RTN","PSJOCDSD",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**181,252,281,256**;DEC 16, 1997;Build 34
"RTN","PSJOCDSD",3,0)
 ;
"RTN","PSJOCDSD",4,0)
DISPLAY ;Display dose checks
"RTN","PSJOCDSD",5,0)
 NEW PSJPON,PSJDSPFG,PSJCNT0,DR,PSJONLST
"RTN","PSJOCDSD",6,0)
 D FULL^VALM1
"RTN","PSJOCDSD",7,0)
 I $D(^TMP($J,"PSJPRE1","OUT")),'$D(PSJEXCPT("PROSPECTIVE")) W @IOF
"RTN","PSJOCDSD",8,0)
 Q:'$$DSPSERR^PSJOC("Dosing Checks could not be performed.")
"RTN","PSJOCDSD",9,0)
 D EXCEPTN2
"RTN","PSJOCDSD",10,0)
 F PSJCNT0=0:0 S PSJCNT0=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0)) Q:'PSJCNT0  Q:$G(PSGORQF)  D
"RTN","PSJOCDSD",11,0)
 . S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON)) Q:PSJPON=""  Q:$G(PSGORQF)  D
"RTN","PSJOCDSD",12,0)
 .. Q:PSJPON=0
"RTN","PSJOCDSD",13,0)
 .. D ERROR,PGBRK("ERROR",PSJCNT0,PSJPON)
"RTN","PSJOCDSD",14,0)
 .. D EXCEPTN,PGBRK("EXCEPTIONS",PSJCNT0,PSJPON)
"RTN","PSJOCDSD",15,0)
 .. D WARNING,PGBRK("WARNING",PSJCNT0,PSJPON)
"RTN","PSJOCDSD",16,0)
 I $D(^TMP($J,"PSJPRE1","OUT")),'$D(PSJEXCPT("PROSPECTIVE")) D PAUSE^PSJLMUT1
"RTN","PSJOCDSD",17,0)
 K PSJDSPFG,PSJEXCPT("PROSPECTIVE")
"RTN","PSJOCDSD",18,0)
 Q
"RTN","PSJOCDSD",19,0)
DOSEOFF(PSJMSG) ;
"RTN","PSJOCDSD",20,0)
 ;Display message if dosing had turned off (once per patient session)
"RTN","PSJOCDSD",21,0)
 Q:$D(PSJEXCPT("DOSE",0))
"RTN","PSJOCDSD",22,0)
 S PSJEXCPT("DOSE",0)=""
"RTN","PSJOCDSD",23,0)
 W !!,$G(PSJMSG),!
"RTN","PSJOCDSD",24,0)
 D PAUSE^PSJLMUT1
"RTN","PSJOCDSD",25,0)
 Q
"RTN","PSJOCDSD",26,0)
WARNING ;Display warning messages
"RTN","PSJOCDSD",27,0)
 NEW PSJSGLE,PSJRNGE,PSJMSG,PSJDD,PSJTYPE,PSJORI
"RTN","PSJOCDSD",28,0)
 I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",29,0)
 S PSJMSG="",PSJORI=""
"RTN","PSJOCDSD",30,0)
 S (PSJSGLE,PSJRNGE)=0
"RTN","PSJOCDSD",31,0)
 I '$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",0)),'$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",0)) D
"RTN","PSJOCDSD",32,0)
 . I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",33,0)
 S PSJTYPE="" F  S PSJTYPE=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE)) Q:PSJTYPE=""  D
"RTN","PSJOCDSD",34,0)
 .IF PSJTYPE=".1_INTRO" SET PSJORI=^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE) D  Q
"RTN","PSJOCDSD",35,0)
 ..I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",36,0)
 ..W !
"RTN","PSJOCDSD",37,0)
 ..D WRITE^PSJMISC(PSJORI,1)
"RTN","PSJOCDSD",38,0)
 .I PSJTYPE="2_TRAIL" S PSJMSG=^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE) D  Q
"RTN","PSJOCDSD",39,0)
 ..I ($Y+4)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",40,0)
 ..E  W !
"RTN","PSJOCDSD",41,0)
 ..D WRITE^PSJMISC(PSJMSG,3)
"RTN","PSJOCDSD",42,0)
 . I ($Y+4)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",43,0)
 . ;Don't display a blank line after Per Orifice text
"RTN","PSJOCDSD",44,0)
 . I $G(PSJORI)=""  W !
"RTN","PSJOCDSD",45,0)
 . K PSJORI
"RTN","PSJOCDSD",46,0)
 . F PSJDD=0:0 S PSJDD=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE,PSJDD)) Q:'PSJDD  D
"RTN","PSJOCDSD",47,0)
 .. Q:$G(PSGORQF)
"RTN","PSJOCDSD",48,0)
 .. S PSJMSG=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE,PSJDD))
"RTN","PSJOCDSD",49,0)
 .. I PSJTYPE="3_GENERAL" D GENERAL
"RTN","PSJOCDSD",50,0)
 .. I PSJTYPE'="3_GENERAL" D
"RTN","PSJOCDSD",51,0)
 ... S PSJMSG=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE,PSJDD))
"RTN","PSJOCDSD",52,0)
 ... D WRITE^PSJMISC(PSJMSG,3)
"RTN","PSJOCDSD",53,0)
 .. I PSJTYPE["1_SINGLE_RANGE" S (PSJSGLE,PSJRNGE)=1_U_PSJDD Q
"RTN","PSJOCDSD",54,0)
 .. S:PSJTYPE["1_SINGLE" PSJSGLE=1_U_PSJDD
"RTN","PSJOCDSD",55,0)
 .. S:PSJTYPE["2_RANGE" PSJRNGE=1_U_PSJDD
"RTN","PSJOCDSD",56,0)
 Q:$G(PSGORQF)
"RTN","PSJOCDSD",57,0)
 D INTERV
"RTN","PSJOCDSD",58,0)
 Q
"RTN","PSJOCDSD",59,0)
INTERV ;Process intervention for dosing check
"RTN","PSJOCDSD",60,0)
 NEW PSJDD
"RTN","PSJOCDSD",61,0)
 S PSJDD=$S(+PSJSGLE:$P(PSJSGLE,U,2),1:$P(PSJRNGE,U,2))
"RTN","PSJOCDSD",62,0)
 I 'PSJDD,'$D(PSJOCFG) Q
"RTN","PSJOCDSD",63,0)
 K PSJDSPFG
"RTN","PSJOCDSD",64,0)
 I +PSJSGLE!+PSJRNGE W ! S PSJDSPFG=1
"RTN","PSJOCDSD",65,0)
 I +PSJSGLE,+PSJRNGE D RINTERV^PSJGMRA("MAX SINGLE DOSE & Max Daily Dose") Q
"RTN","PSJOCDSD",66,0)
 I +PSJRNGE D RINTERV^PSJGMRA("Max Daily Dose") Q
"RTN","PSJOCDSD",67,0)
 I +PSJSGLE D RINTERV^PSJGMRA("MAX SINGLE DOSE") Q
"RTN","PSJOCDSD",68,0)
 Q
"RTN","PSJOCDSD",69,0)
ERROR ; Process errors
"RTN","PSJOCDSD",70,0)
 NEW PSJCNT,PSJNV
"RTN","PSJOCDSD",71,0)
 ;Check for system error one more time.
"RTN","PSJOCDSD",72,0)
 F PSJCNT=0:0 S PSJCNT=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",PSJCNT)) Q:'PSJCNT  D
"RTN","PSJOCDSD",73,0)
 .I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",74,0)
 . E  W !
"RTN","PSJOCDSD",75,0)
 . S PSJNV=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",PSJCNT,"MSG"))
"RTN","PSJOCDSD",76,0)
 . I PSJNV]"" D WRITE^PSJMISC(PSJNV,3)
"RTN","PSJOCDSD",77,0)
 . S PSJNV=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",PSJCNT,"TEXT"))
"RTN","PSJOCDSD",78,0)
 . I PSJNV]"" D WRITE^PSJMISC(PSJNV,5)
"RTN","PSJOCDSD",79,0)
 . S PSJNV=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",PSJCNT,"TRAIL"))
"RTN","PSJOCDSD",80,0)
 . I PSJNV]"" W ! D WRITE^PSJMISC(PSJNV,3)
"RTN","PSJOCDSD",81,0)
 Q
"RTN","PSJOCDSD",82,0)
EXCEPTN ; Process exceptions
"RTN","PSJOCDSD",83,0)
 NEW PSJCNT,PSJNV,PSJSPACE,PSJQFLG1,PSJDSDRG,PSJXDRG,PSJQUIT
"RTN","PSJOCDSD",84,0)
 ;Check for system error one more time.
"RTN","PSJOCDSD",85,0)
 ;PSJOCFG - flag when order is Renew, Copy or New OE
"RTN","PSJOCDSD",86,0)
 S PSJSPACE=0
"RTN","PSJOCDSD",87,0)
 I $O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",0)) D
"RTN","PSJOCDSD",88,0)
 .I ($Y+4)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",89,0)
 F PSJCNT=0:0 S PSJCNT=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT)) Q:'PSJCNT  D
"RTN","PSJOCDSD",90,0)
 . S PSJQFLG1=0,PSJDSDRG=""
"RTN","PSJOCDSD",91,0)
 . S PSJDSDRG=$P($G(^TMP($J,"PSJPRE","IN","DOSE",PSJPON)),U,3)
"RTN","PSJOCDSD",92,0)
 . S PSJQUIT=0,PSJXDRG="" F  S PSJXDRG=$O(PSJEXCPT("PROSPECTIVE",PSJXDRG)) Q:PSJXDRG=""  I +PSJXDRG=+PSJDSDRG S PSJQUIT=1 Q
"RTN","PSJOCDSD",93,0)
 . Q:PSJQUIT
"RTN","PSJOCDSD",94,0)
 . S PSJNV=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT))
"RTN","PSJOCDSD",95,0)
 . I PSJNV]"" D
"RTN","PSJOCDSD",96,0)
 .. I $E(PSJNV,1,13)="             " S PSJSPACE=13,PSJNV=$P(PSJNV,"             ",2)
"RTN","PSJOCDSD",97,0)
 .. I (PSJNV'["Reason(s):"),+'$G(PSJSPACE) W !
"RTN","PSJOCDSD",98,0)
 .. D WRITE^PSJMISC(PSJNV,PSJSPACE+3)
"RTN","PSJOCDSD",99,0)
 . S PSJNV=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT,"TRAIL"))
"RTN","PSJOCDSD",100,0)
 . I PSJNV]"" W ! D WRITE^PSJMISC(PSJNV,PSJSPACE+3)
"RTN","PSJOCDSD",101,0)
 Q
"RTN","PSJOCDSD",102,0)
EXCEPTN2 ; Process exceptions on prospective drug
"RTN","PSJOCDSD",103,0)
 NEW PSJPON,PSJN,PSJNV
"RTN","PSJOCDSD",104,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE1","OUT","EXCEPTIONS",PSJPON)) Q:PSJPON=""  D
"RTN","PSJOCDSD",105,0)
 . F PSJN=0:0 S PSJN=$O(^TMP($J,"PSJPRE1","OUT","EXCEPTIONS",PSJPON,PSJN)) Q:'PSJN  D
"RTN","PSJOCDSD",106,0)
 .. S PSJNV=$G(^TMP($J,"PSJPRE1","OUT","EXCEPTIONS",PSJPON,PSJN))
"RTN","PSJOCDSD",107,0)
 .. I $P(PSJPON,";",3)="PROFILE" Q
"RTN","PSJOCDSD",108,0)
 .. I '$$ERRCHK^PSJOC("PROSPECTIVE",$P(PSJNV,U,3)_$P(PSJNV,U,10)) Q
"RTN","PSJOCDSD",109,0)
 .. Q:'$D(PSJOCFG)
"RTN","PSJOCDSD",110,0)
 .. W !
"RTN","PSJOCDSD",111,0)
 .. D DSPDRGER^PSJOC(1)
"RTN","PSJOCDSD",112,0)
 Q
"RTN","PSJOCDSD",113,0)
GENERAL ;
"RTN","PSJOCDSD",114,0)
 NEW PSJGCNT
"RTN","PSJOCDSD",115,0)
 F PSJGCNT=0:0 S PSJGCNT=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE,PSJDD,PSJGCNT)) Q:'PSJGCNT  D
"RTN","PSJOCDSD",116,0)
 . S PSJMSG=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE,PSJDD,PSJGCNT))
"RTN","PSJOCDSD",117,0)
 .I ($Y+3)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",118,0)
 . D WRITE^PSJMISC(PSJMSG,3)
"RTN","PSJOCDSD",119,0)
 Q
"RTN","PSJOCDSD",120,0)
PGBRK(PSJTYPE,PSJCNT0,PSJPON) ;Chedk if the last group of dosing messages have displayed. if intervention is needed, no press return is needed.
"RTN","PSJOCDSD",121,0)
 Q  ;PSJ*5*256
"RTN","PSJOCDSD",122,0)
 NEW PSJERR,PSJEXCPT,PSJWARN,PSJMSG
"RTN","PSJOCDSD",123,0)
 Q:'+PSJCNT0
"RTN","PSJOCDSD",124,0)
 Q:$G(PSJPON)=""
"RTN","PSJOCDSD",125,0)
 Q:+$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0))
"RTN","PSJOCDSD",126,0)
 S (PSJERR,PSJEXCPT,PSJWARN)=0
"RTN","PSJOCDSD",127,0)
 ;
"RTN","PSJOCDSD",128,0)
 I $O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",0)) S PSJERR=1
"RTN","PSJOCDSD",129,0)
 I $D(PSJONLST(PSJPON)),$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",0)) S PSJEXCPT=1
"RTN","PSJOCDSD",130,0)
 S PSJMSG=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE","")) S:PSJMSG]"" PSJWARN=1
"RTN","PSJOCDSD",131,0)
 ;
"RTN","PSJOCDSD",132,0)
 I (PSJTYPE="ERROR"),PSJERR,('PSJEXCPT&'PSJWARN) D PAUSE^PSJLMUT1
"RTN","PSJOCDSD",133,0)
 I (PSJTYPE="EXCEPTIONS"),PSJEXCPT,'PSJWARN D PAUSE^PSJLMUT1
"RTN","PSJOCDSD",134,0)
 I (PSJTYPE="WARNING"),PSJWARN,($G(PSJMSG)="3_GENERAL") D PAUSE^PSJLMUT1
"RTN","PSJOCDSD",135,0)
 Q
"RTN","PSJOE")
0^24^B107308183
"RTN","PSJOE",1,0)
PSJOE ;BIR/MLM - INPATIENT ORDER ENTRY ;23 Jun 98  1:46 PM
"RTN","PSJOE",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**7,26,29,33,42,50,56,72,58,85,95,80,110,111,133,140,151,149,181,252,281,315,256**;16 DEC 97;Build 34
"RTN","PSJOE",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSJOE",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJOE",5,0)
 ; Reference to EN^VALM is supported by DBIA #10118.
"RTN","PSJOE",6,0)
 ; Reference to FULL^VALM1 is supported by DBIA #10116.
"RTN","PSJOE",7,0)
 ; Reference to PAUSE^VALM1 is supported by DBIA #10116.
"RTN","PSJOE",8,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSJOE",9,0)
 ; Reference to ^DPT( is supported by DBIA #10035.
"RTN","PSJOE",10,0)
 ; Reference to ^ORCFLAG is supported by DBIA #3620.
"RTN","PSJOE",11,0)
 ; Reference to ^SDAMA203 is supported by DBIA #4133.
"RTN","PSJOE",12,0)
 ; Reference to ^TMP("PSODAOC" is supported by DBIA #6071.
"RTN","PSJOE",13,0)
 ;
"RTN","PSJOE",14,0)
EN ; Start Inpatient LM OE
"RTN","PSJOE",15,0)
 N PSJLK,PSJNEWOE,PSJLMCON,PSJPROT,XQORS,VALMEVL D ENCV^PSGSETU,^PSIVXU
"RTN","PSJOE",16,0)
 I $D(XQUIT) K XQUIT G DONE
"RTN","PSJOE",17,0)
 K PSGVBY,PSJPR S (PSJOL,PSJACOK,PSGOP,PSGNEF,PSGOEAV,PSGPXN)="" L +^PS(53.45,PSJSYSP):1 E  D LOCKERR^PSJOE G DONE^PSJOE
"RTN","PSJOE",18,0)
 F  S (PSJLMCON,PSGPTMP)=0 D ^PSJP,HK Q:PSGP'>0  S PSJPROT=3,DFN=PSGP D ^PSJAC D  I PSJLK D UL^PSSLOCK(PSGP)
"RTN","PSJOE",19,0)
 .K ^TMP("PSJ",$J)
"RTN","PSJOE",20,0)
 .S PSJLK=$$L^PSSLOCK(PSGP,1) I 'PSJLK W !,$C(7),$P(PSJLK,U,2) Q
"RTN","PSJOE",21,0)
 .K PSJLMPRO D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSJOE",22,0)
 .N NXTPT S NXTPT=0 F  Q:$G(NXTPT)  D
"RTN","PSJOE",23,0)
 ..K PSGRDTX
"RTN","PSJOE",24,0)
 ..I $G(PSJLMCON)!$G(PSJNEWOE) D
"RTN","PSJOE",25,0)
 ...S PSJOL=$S(",S,L,"[(","_$G(PSJOL)_","):PSJOL,1:"S")
"RTN","PSJOE",26,0)
 ...S PSJLMPRO=1,PSJLMCON=1,PSJNEWOE=0 D EN^VALM("PSJ LM OE")
"RTN","PSJOE",27,0)
 ..I $G(PSJNEWOE)!($G(VALMBCK)="Q") S PSJNEWOE=0 Q
"RTN","PSJOE",28,0)
 ..I $G(PSJLMCON)&$G(PSJLMPRO)&'$D(^TMP("PSJ",$J)) D  Q
"RTN","PSJOE",29,0)
 ...S PSJLMCON=0,PSJLMPRO=0 D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSJOE",30,0)
 ...I $G(PSJNEWOE) S NXTPT=0 Q
"RTN","PSJOE",31,0)
 ...S NXTPT=1
"RTN","PSJOE",32,0)
 ..S NXTPT=1,PSJNEWOE=0
"RTN","PSJOE",33,0)
 .S PSJOL="S"
"RTN","PSJOE",34,0)
 .I $G(PSGPXN) I $P(PSJSYSW0,U,29)]""!($G(PSJCOM)) S PSGPXPT=PSGP D  K PSGPXPT S PSGPXN=0
"RTN","PSJOE",35,0)
 ..N DFN,PSGP,PSJPXDP
"RTN","PSJOE",36,0)
 ..I $P(PSJSYSW0,U,29)="" S PSJPDXP=1 D
"RTN","PSJOE",37,0)
 ...;N IO,ION,IOS D HOME^%ZIS S $P(PSJSYSW0,U,29)=+$G(IOS)
"RTN","PSJOE",38,0)
 ...D HOME^%ZIS S $P(PSJSYSW0,U,29)=+$G(IOS)
"RTN","PSJOE",39,0)
 ..S (PSGP,DFN)=PSGPXPT D ^PSGPER S:$G(PSJPDXP) $P(PSJSYSW0,U,29)="" K PSJPDXP
"RTN","PSJOE",40,0)
 .D ENCV^PSGSETU,^PSIVXU
"RTN","PSJOE",41,0)
 K PSJLMPRO,^TMP("PSJPRO",$J),^TMP("PSJ",$J),^TMP("PSJON",$J)
"RTN","PSJOE",42,0)
DONE ;
"RTN","PSJOE",43,0)
 ; -- RTC 198753 - correct typo - r PSJALGSV w PSJAGYSV
"RTN","PSJOE",44,0)
 K PSJAGYSV,PSJEXCPT,PSJOCER,^TMP($J,"PSJPRE"),^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J)
"RTN","PSJOE",45,0)
 K AC,ACTION,D1,D2,MI,N,ON,P3,PNOW,PSIVAT,PSIVLN,PSIVSTR L -^PS(53.45,PSJSYSP)
"RTN","PSJOE",46,0)
 K DA,DRG,NE,PSGCF,PSGCANFL,PSGNEDFD,PSGNEF,PSGNEFD,PSGNEPR,PSGNESD,PSJACOK,PSJOE,PSJOECNT,PSJOEPF,PSJORD,PSGOEA,PSGOEAV,PSGOL,PSGOS,PSGON,PSGOP,PSGORD,PSGS0XT,PSGS0Y,RCT,ST,WD,XREF,Z,PSJIVORF,PSJIVPCL
"RTN","PSJOE",47,0)
 K PSGOEORF,PSIVREA,PSJOPC,PSJORL,PSJORPCL,PSJORTOI,RF,WSCHADM,PSJLM,PSJCT
"RTN","PSJOE",48,0)
 K DIU,DRGI,FLAG,FQC,ND2,PRI,PSGOE,PSGPRI,PSGSDN,PSGOEDMR,PSGOEPR,PSGPTS,PSGTOL,PSGTOO,PSGUOW,PSJIVOF,PSJOCNT,PSJON,PSJORQF,PSJORTOU,PSJORVP
"RTN","PSJOE",49,0)
 K PSIVENO,PSGRMV,PSGRMVT,PSGDUR,PSGRF,ND2P1 ;*315
"RTN","PSJOE",50,0)
 G:$G(PSGPXN) ^PSGPER1 D ENIVKV^PSGSETU
"RTN","PSJOE",51,0)
 Q
"RTN","PSJOE",52,0)
HK ; Housekeeping (a nice COBOL term)
"RTN","PSJOE",53,0)
 I PSGOP,PSGOP'=PSGP D
"RTN","PSJOE",54,0)
 .N PSJACPF,PSJACNWP,PSJPWD,PSJSYSL,PSJSYSW,PSJSYSW0,DFN,VAIN,VAERR S DFN=PSGOP
"RTN","PSJOE",55,0)
 .D INP^VADPT S PSJPWD=+VAIN(4) I PSJPWD S PSJACPF=10 D WP^PSJAC D:$P(PSJSYSL,"^",2)]"" ENQL^PSGLW
"RTN","PSJOE",56,0)
 Q:PSGP<0
"RTN","PSJOE",57,0)
 S (DFN,PSGOP)=PSGP,X=""
"RTN","PSJOE",58,0)
 Q
"RTN","PSJOE",59,0)
SELECT ; Select order from list
"RTN","PSJOE",60,0)
 ;Variable PSJOCDSC is used in Complex order dosing checks
"RTN","PSJOE",61,0)
 N PSGLMT,PSGODDD,PSJLMQT,PSJLMFIN,PSJUDPRF,PSGRDTX,PSJOCDSC,PSJAGYSV K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J),PSJSTARI,^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J)
"RTN","PSJOE",62,0)
 K PSGDUR,PSGRMVT,PSGRMV,PSGRF,ND2P1 ;*315
"RTN","PSJOE",63,0)
 S PSGONC=1,PSGLMT=^TMP("PSJPRO",$J,0) D ENASR^PSGON
"RTN","PSJOE",64,0)
 I "^"[X S VALMQUIT=1 Q
"RTN","PSJOE",65,0)
 S PSJLM=1,PSJSEL=0 F  S PSJSEL=$O(PSGODDD(PSJSEL)) Q:'PSJSEL!($G(Y)<0)  F PSJSEL1=1:1:$L(PSGODDD(PSJSEL),",")-1 D
"RTN","PSJOE",66,0)
 .K PSJOCDSC
"RTN","PSJOE",67,0)
 .S PSJORD=$G(^TMP("PSJON",$J,+$P(PSGODDD(PSJSEL),",",PSJSEL1))) D:PSJORD=+PSJORD SELECT^PSJOEA Q:PSJORD=""!($G(Y)<0)  Q:PSJORD=+PSJORD  D
"RTN","PSJOE",68,0)
 ..Q:('$$LS^PSSLOCK(PSGP,PSJORD))
"RTN","PSJOE",69,0)
 ..Q:PSJORD=+PSJORD
"RTN","PSJOE",70,0)
 ..S PSGORD=""
"RTN","PSJOE",71,0)
 ..D DISACTIO(PSGP,PSJORD,"") S:PSJORD["V" PSJORD=ON
"RTN","PSJOE",72,0)
 ..D UNL^PSSLOCK(PSGP,PSJORD) Q:$G(Y)<0
"RTN","PSJOE",73,0)
 S VALMBCK="Q"
"RTN","PSJOE",74,0)
 K PSJLM,PSJOCDSC
"RTN","PSJOE",75,0)
 Q
"RTN","PSJOE",76,0)
DISACTIO(DFN,PSJORD,PSJPNV)       ; Display UD order and allow actions.
"RTN","PSJOE",77,0)
 ; PSJORD - Order #_location Code (P:53.1,V:55.01,U:55.06)
"RTN","PSJOE",78,0)
 ; PSJPNV - Invoked from Pending/NV option; (gets different hidden menu)
"RTN","PSJOE",79,0)
 ; PSJDSVFY - Flag if non-vf order was edited
"RTN","PSJOE",80,0)
 ; PSJENHOC=1 if DI,DT were display. This will be used by dosing OC to check if error messages should display or not
"RTN","PSJOE",81,0)
 ; PSJAGYSV=1 If UD was edited
"RTN","PSJOE",82,0)
 ;N PSGP,PSJIVFLG,PSGSDX,PSGFDX,PSJXX1,ON55,PSJDSVFY,PSJENHOC,PSJAGYSV
"RTN","PSJOE",83,0)
 N PSGP,PSJIVFLG,PSGSDX,PSGFDX,PSJXX1,ON55,PSJDSVFY,PSJENHOC,PSIVENO
"RTN","PSJOE",84,0)
 K PSGDUR,PSGRMVT,PSGRMV,PSGRF,ND2P1 ;*315
"RTN","PSJOE",85,0)
 K PSJEXCPT("PROSPECTIVE") ;*256
"RTN","PSJOE",86,0)
 D OLDCOM^PSJOE0(DFN,PSJORD)
"RTN","PSJOE",87,0)
 S PSGP=DFN D ENIV^PSJAC I PSJORD["V" D EN^PSJLIORD(DFN,PSJORD) Q
"RTN","PSJOE",88,0)
 D GETUD^PSJLMGUD(DFN,PSJORD)
"RTN","PSJOE",89,0)
 S PSGOEAV=$P(PSJSYSP0,"^",9)&PSJSYSU
"RTN","PSJOE",90,0)
 S:$G(PSJTUD) PSGPD=$G(PSJCOI),PSGPDN=$$OINAME^PSJLMUTL(+PSGPD)
"RTN","PSJOE",91,0)
 K PSGOENG I '$D(PSGPRF) D  Q:$G(PSGOENG)
"RTN","PSJOE",92,0)
 . I PSJORD["U" L +^PS(55,PSGP,5,+PSJORD):1 E  S PSGOENG=1
"RTN","PSJOE",93,0)
 . I PSJORD["P" L +^PS(53.1,+PSJORD):1 E  S PSGOENG=1
"RTN","PSJOE",94,0)
 . I $G(PSGOENG) W !,"This order is being edited by another terminal.",! S PSGOENG=1 K DIR S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSJOE",95,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSJORD)
"RTN","PSJOE",96,0)
 I PSJORD["P" S PSJXX1=$G(^PS(53.1,+PSJORD,0)) I PSGP'=$P(PSJXX1,U,15)!(DFN'=$P(PSJXX1,U,15)) L -^PS(53.1,+PSJORD) Q
"RTN","PSJOE",97,0)
 I PSJORD["P" D  S PSJXX1=$P($G(^PS(53.1,+PSJORD,0)),U,9) I $S($G(PSJIVFLG):1,$G(Y)<0:1,"PADE"[PSJXX1:1,1:0) L -^PS(53.1,+PSJORD) Q
"RTN","PSJOE",98,0)
 .I $P(PSJXX1,U,9)="N",($P(PSJXX1,U,4)'="U") D  Q
"RTN","PSJOE",99,0)
 .. S P("PON")=PSJORD,PSIVFLG=1
"RTN","PSJOE",100,0)
 .. N ON S ON=PSJORD D VF^PSIVORC2
"RTN","PSJOE",101,0)
 .I $P(PSJXX1,U,9)="P" D  Q
"RTN","PSJOE",102,0)
 ..S:$G(PSJTUD) $P(PSJXX1,U,4)="U"
"RTN","PSJOE",103,0)
 ..I $P(PSJXX1,U,4)="U" D  Q:$G(PSJIVFLG)
"RTN","PSJOE",104,0)
 ... N VAIP S CLINIC=$G(^PS(53.1,+PSJORD,"DSS")),APPT=$P(CLINIC,"^",2),CLINIC=$P(CLINIC,"^") I $$PATCH^XPDUTL("SD*5.3*285"),$$SDIMO^SDAMA203(CLINIC,DFN)>-1 Q
"RTN","PSJOE",105,0)
 ... Q:'PSJPDD  W !!,"Cannot process an Out-patient Unit Dose order for ",$P($G(^DPT(+PSGP,0)),U) D PAUSE^VALM1 S PSJIVFLG=1
"RTN","PSJOE",106,0)
 ..NEW PSGRSD,PSGRSDN,PSGRFD,PSGRFDN
"RTN","PSJOE",107,0)
 ..D REQDT^PSJLIVMD(PSJORD)
"RTN","PSJOE",108,0)
 ..I $P(PSJXX1,U,4)="U",($G(PSGSCH)="") W !!,"Invalid schedule, can't finish this order" D PAUSE^VALM1 Q
"RTN","PSJOE",109,0)
 ..I $P(PSJXX1,U,4)="U" N PSJLM,PSJOCFG S PSJLM=1,PSGORD=PSJORD,PSJOCFG="FN UD" D START^PSGOEF,ENSFE^PSGOEE0(PSGP,PSGORD) S:$G(PSJTUD) PSJOCFG="FN UD" D @$S($G(PSJTUD):"FINISH^PSGOEF",1:"EN^VALM(""PSJ LM PENDING EDIT"")") K PSJOCFG Q
"RTN","PSJOE",110,0)
 ..I $P(PSJXX1,U,4)'="U",PSGP=$P(PSJXX1,U,15),DFN=$P(PSJXX1,U,15) S PSJLYN=PSJORD,PSJOCFG="FN IV" D EN^PSJLIFN S PSJIVFLG=1 K PSJLYN,PSJMAI,PSJOCFG
"RTN","PSJOE",111,0)
 I $G(PSIVFLG) K PSIVFLG Q
"RTN","PSJOE",112,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSJORD),PSGOEEF=0 D GETUD^PSJLMGUD(PSGP,PSJORD),ENSFE^PSGOEE0(PSGP,PSJORD),EN^VALM("PSJ LM UD ACTION")
"RTN","PSJOE",113,0)
 I PSJORD["P" L -^PS(53.1,+PSJORD)
"RTN","PSJOE",114,0)
 I PSJORD["U" L -^PS(55,PSGP,5,+PSJORD)
"RTN","PSJOE",115,0)
 ;Send SN to CPRS if auto-verify OFF and Order Set Entry and no 21st piece
"RTN","PSJOE",116,0)
 S PSGOEAV=$P(PSJSYSP0,"^",9)&PSJSYSU
"RTN","PSJOE",117,0)
 I $D(PSGOES),'PSGOEAV,$D(PSGORD),PSGORD["P",$P($G(^PS(53.1,+PSGORD,0)),"^",21)']"" D ORSET^PSGOETO1
"RTN","PSJOE",118,0)
 I $G(PSGOEAV),($G(PSGOES)=1) D SETOC ;Store allergy for order set /w auto vf 
"RTN","PSJOE",119,0)
 I '$G(PSGOEAV),($G(PSJORD)["P"),$S($G(PSJAGYSV):1,($G(PSJOCFG)="NEW UD"):1,1:0) D SETOC
"RTN","PSJOE",120,0)
 ; -- RTC 236646
"RTN","PSJOE",121,0)
 K ^TMP("PSODAOC",$J,"ALLERGY")
"RTN","PSJOE",122,0)
 D UNL^PSSLOCK(PSGP,PSJORD)
"RTN","PSJOE",123,0)
 Q
"RTN","PSJOE",124,0)
SETOC ;
"RTN","PSJOE",125,0)
 ;RTC 178789 
"RTN","PSJOE",126,0)
 S ^TMP("PSODAOC",$J,"IP IEN")=PSJORD
"RTN","PSJOE",127,0)
 D SETOC^PSJNEWOC(PSJORD)
"RTN","PSJOE",128,0)
 K ^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J),PSJAGYSV,PSJOCFG
"RTN","PSJOE",129,0)
 Q
"RTN","PSJOE",130,0)
EDIT(PSGP,PSGORD,PROMPT) ;
"RTN","PSJOE",131,0)
 I "DE"[$$GTSTATUS(PSGP,PSGORD) W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJOE",132,0)
 I PSGACT'["E" W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJOE",133,0)
 N PSJEDITO S PSJEDITO=1
"RTN","PSJOE",134,0)
 S PSJAGYSV=1 ;Flag to store allergy data in 100.05.
"RTN","PSJOE",135,0)
 S PSGNEDFD="" D HOLDHDR,@$S('PROMPT:"ENEFA2^PSGON",1:"ENEFA^PSGON") I 'Y D ABORT^PSGOEE Q
"RTN","PSJOE",136,0)
 I PSGORD["P" D ENF^PSGOEE Q
"RTN","PSJOE",137,0)
 D ACT^PSGOEE
"RTN","PSJOE",138,0)
 Q
"RTN","PSJOE",139,0)
RENEW(PSGP,PSGORD) ;
"RTN","PSJOE",140,0)
 ;PSJOCFG - If defined, it's for new order, renew or copy. ^PSJOCDSD using this flag to not display drug error.
"RTN","PSJOE",141,0)
 NEW PSJOCFG
"RTN","PSJOE",142,0)
 S PSJOCFG="RENEW UD"
"RTN","PSJOE",143,0)
 D HOLDHDR
"RTN","PSJOE",144,0)
 I 'PSJSYSU,$P($G(^PS(55,PSGP,5,+PSGORD,4)),U,15),$P($G(^(4)),U,16) W !!,"This order is already marked for renewal!" D PAUSE^VALM1 S VALMBCK="R" Q
"RTN","PSJOE",145,0)
 I 'PSGRRF D ^PSGOER K PSJOCFG Q
"RTN","PSJOE",146,0)
 D ^PSGOERI
"RTN","PSJOE",147,0)
 K PSJOCFG
"RTN","PSJOE",148,0)
 Q
"RTN","PSJOE",149,0)
GTSTATUS(DFN,ON)   ;
"RTN","PSJOE",150,0)
 I ON["P" Q $P($G(^PS(53.1,+ON,0)),U,9)
"RTN","PSJOE",151,0)
 I ON["U" Q $P($G(^PS(55,DFN,5,+ON,0)),U,9)
"RTN","PSJOE",152,0)
 Q $P($G(^PS(55,DFN,"IV",+ON,0)),U,17)
"RTN","PSJOE",153,0)
DC(DFN,PSJORD) ; DC IV, UD, or pending orders.
"RTN","PSJOE",154,0)
 D HOLDHDR
"RTN","PSJOE",155,0)
 S X=$$GTSTATUS(DFN,PSJORD) I X="D"!(X="DE")!(X="R") W !,$S(X="R":"This order has a pending renewal and cannot be DISCONTINUED.",1:"This order has already been DISCONTINUED.") D PAUSE^VALM1 Q
"RTN","PSJOE",156,0)
 D ENO^PSGOEC(DFN,PSJORD) ;,GETUD^PSJLMGUD(DFN,PSJORD),INIT^PSJLMUDE(DFN,PSJORD) S VALMBCK="Q"
"RTN","PSJOE",157,0)
 S VALMBCK="Q"
"RTN","PSJOE",158,0)
 Q
"RTN","PSJOE",159,0)
HOLD(DFN,PSJORD) ; Change order's status from ACTIVE<->HOLD
"RTN","PSJOE",160,0)
 D HOLDHDR
"RTN","PSJOE",161,0)
 I PSJORD["V" D H^PSIVOPT(DFN,PSJORD,P(17),P(3))
"RTN","PSJOE",162,0)
 I PSJORD'["V" D H^PSGOE1(DFN,PSJORD)
"RTN","PSJOE",163,0)
 D GETUD^PSJLMGUD(DFN,PSJORD),INIT^PSJLMUDE(DFN,PSJORD) S PSGACT=$$ENACTION^PSGOE1(DFN,PSJORD),VALMBCK="R"
"RTN","PSJOE",164,0)
 Q
"RTN","PSJOE",165,0)
COPY(PSGP,PSGORD)  ; Copy an order (does not discontinue original order)
"RTN","PSJOE",166,0)
 NEW PSJOCFG
"RTN","PSJOE",167,0)
 I $D(PSGCOPY) W !!,"You cannot copy the order at this time" D PAUSE^VALM1 Q
"RTN","PSJOE",168,0)
 I PSGORD["P" W !!,"You cannot copy this "_$S($G(PSGSTAT)]"":PSGSTAT,1:"PENDING IV")_" order." D PAUSE^VALM1 Q
"RTN","PSJOE",169,0)
 I PSGORD["V" D  Q
"RTN","PSJOE",170,0)
 .I $G(PSIVCOPY) W !!,"You cannot copy the order at this time" D PAUSE^VALM1 Q
"RTN","PSJOE",171,0)
 .S PSJOCFG="COPY IV"
"RTN","PSJOE",172,0)
 .D COPY^PSIVOD(PSGP,PSGORD) K PSJOCFG Q
"RTN","PSJOE",173,0)
 Q:'$$HIDDEN^PSJLMUTL("COPY")
"RTN","PSJOE",174,0)
 D ^PSJHVARS
"RTN","PSJOE",175,0)
 I $P($G(^PS(55,PSGP,5,+PSGORD,.2)),U,4)="D",'$P($G(^(4)),"^",3) W !!,"Nurse verified orders with a priority of DONE may not be Copied." D PAUSE^VALM1 Q
"RTN","PSJOE",176,0)
 S PSJOCFG="COPY UD"
"RTN","PSJOE",177,0)
 S PSGOEAV=$P(PSJSYSP0,U,9)&PSJSYSU
"RTN","PSJOE",178,0)
 S PSGCOPY=1
"RTN","PSJOE",179,0)
 D FULL^VALM1,^PSGOD
"RTN","PSJOE",180,0)
 S VALMBCK="R"
"RTN","PSJOE",181,0)
 K PSGCOPY,PSJOCFG
"RTN","PSJOE",182,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSGORD) ; resets PSGACT after copy
"RTN","PSJOE",183,0)
 I $G(PSGPXN) N PSGTMPXN S PSGTMPXN=PSGPXN
"RTN","PSJOE",184,0)
 D RESTORE^PSJHVARS I $G(PSGTMPXN) S PSGPXN=PSGTMPXN
"RTN","PSJOE",185,0)
 Q
"RTN","PSJOE",186,0)
UPDATE ; Refresh array, actions, & display.
"RTN","PSJOE",187,0)
 D GETUD^PSJLMGUD(DFN,ON),INIT^PSJLMUDE(DFN,ON) S VALMBCK="R"
"RTN","PSJOE",188,0)
 Q
"RTN","PSJOE",189,0)
FINISH ;
"RTN","PSJOE",190,0)
 D FINISH^PSGOEF,PAUSE^VALM1
"RTN","PSJOE",191,0)
 Q
"RTN","PSJOE",192,0)
LOG(DFN,PSGORD)        ;
"RTN","PSJOE",193,0)
 D FULL^VALM1,ENLM^PSGOEL(DFN,PSGORD),PAUSE^VALM1 S VALMBCK="R"
"RTN","PSJOE",194,0)
 Q
"RTN","PSJOE",195,0)
NEWSEL ;
"RTN","PSJOE",196,0)
 N PSGLMT,PSGODDD,PSJLMQT,PSJLMFIN,PSJUDPRF,PSGRDTX,PSJOCDSC,PSJAGYSV K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J),^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J)
"RTN","PSJOE",197,0)
 K PSGRMVT,PSGRMV,PSGDUR,PSGRF,ND2P1 ;*315
"RTN","PSJOE",198,0)
 S X=$P(XQORNOD(0),"=",2)
"RTN","PSJOE",199,0)
 S PSGONC=1,PSGLMT=^TMP("PSJPRO",$J,0)
"RTN","PSJOE",200,0)
 D ENCHK^PSGON I '$O(PSGODDD(0)) S VALMQUIT=1 Q
"RTN","PSJOE",201,0)
 S PSJLM=1,PSJSEL=0 F  S PSJSEL=$O(PSGODDD(PSJSEL)) Q:'PSJSEL  F PSJSEL1=1:1:$L(PSGODDD(PSJSEL),",")-1 D
"RTN","PSJOE",202,0)
 .K PSJOCDSC
"RTN","PSJOE",203,0)
 .S PSJORD=$G(^TMP("PSJON",$J,+$P(PSGODDD(PSJSEL),",",PSJSEL1))) D:PSJORD=+PSJORD SELECT^PSJOEA
"RTN","PSJOE",204,0)
 .Q:PSJORD=+PSJORD 
"RTN","PSJOE",205,0)
 .Q:PSJORD=""!($G(Y)<0)  Q:('$$LS^PSSLOCK(PSGP,PSJORD))  D
"RTN","PSJOE",206,0)
 ..S PSGORD=""
"RTN","PSJOE",207,0)
 ..S ON=PSJORD
"RTN","PSJOE",208,0)
 ..D DISACTIO(PSGP,PSJORD,$G(PSJPNV)) S:PSJORD["V" PSJORD=ON
"RTN","PSJOE",209,0)
 ..D UNL^PSSLOCK(PSGP,PSJORD)
"RTN","PSJOE",210,0)
 ..I $G(PSJNOL) K PSJNOL I $D(ON),ON'=PSJORD D UNL^PSSLOCK(PSGP,ON)
"RTN","PSJOE",211,0)
 ..Q:$G(Y)<0
"RTN","PSJOE",212,0)
 I '$G(PSGOEAV),($G(PSJORD)["P"),$G(PSJAGYSV) D
"RTN","PSJOE",213,0)
 .;RTC 178789 
"RTN","PSJOE",214,0)
 .S ^TMP("PSODAOC",$J,"IP IEN")=PSJORD
"RTN","PSJOE",215,0)
 .D SETOC^PSJNEWOC(PSJORD)
"RTN","PSJOE",216,0)
 .K ^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J),PSJAGYSV
"RTN","PSJOE",217,0)
 S VALMBCK="Q"
"RTN","PSJOE",218,0)
 K PSJLM,PSJOCDSC
"RTN","PSJOE",219,0)
 Q
"RTN","PSJOE",220,0)
HOLDHDR ; Freeze header text while processing order actions
"RTN","PSJOE",221,0)
 I $D(VALM("TM")) S IOTM=VALM("TM"),IOBM=IOSL W IOSC W @IOSTBM W IORC
"RTN","PSJOE",222,0)
 Q
"RTN","PSJOE",223,0)
LOCKERR ;
"RTN","PSJOE",224,0)
 W !!,$C(7),"You are entering or editing an Inpatient Medication order in another session.",!,"Only one order entry/edit session is allowed for a user at a time.",!! N DIR S DIR(0)="E" D ^DIR
"RTN","PSJOE",225,0)
 Q
"RTN","PSJOE",226,0)
FLAG(DFN,PSJORD) ;Flag order through CPRS entry point.
"RTN","PSJOE",227,0)
 N ORIFN,NODE0
"RTN","PSJOE",228,0)
 S NODE0=$S(PSJORD["V":$G(^PS(55,DFN,"IV",+PSJORD,0)),PSJORD["U":$G(^PS(55,DFN,5,+PSJORD,0)),1:^PS(53.1,+PSJORD,0))
"RTN","PSJOE",229,0)
 S ORIFN=$P(NODE0,"^",21)
"RTN","PSJOE",230,0)
 D EN1^ORCFLAG(ORIFN)
"RTN","PSJOE",231,0)
 D PAUSE^VALM1
"RTN","PSJOE",232,0)
 Q
"RTN","PSJOE",233,0)
COMPLEX(DFN,ON) ;
"RTN","PSJOE",234,0)
 N NDP2,COM
"RTN","PSJOE",235,0)
 S NDP2=$S(ON["P":$G(^PS(53.1,+ON,.2)),ON["U":$G(^PS(55,DFN,5,+ON,.2)),ON["V":$G(^PS(55,DFN,"IV",+ON,.2)),1:"")
"RTN","PSJOE",236,0)
 S COM=$P(NDP2,"^",8) I COM Q 1
"RTN","PSJOE",237,0)
 Q 0
"RTN","PSJORUTL")
0^33^B21381210
"RTN","PSJORUTL",1,0)
PSJORUTL ;BIR/MLM-MISC. PROCEDURE CALLS FOR OE/RR 3.0 ;24 Feb 99 / 10:43 AM
"RTN","PSJORUTL",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**4,14,22,256**;16 DEC 97;Build 34
"RTN","PSJORUTL",3,0)
 ;
"RTN","PSJORUTL",4,0)
 ;Reference to ^PS(50.416 is supported by DBIA 2196
"RTN","PSJORUTL",5,0)
 ;Reference to ^PS(50.606 is supported by DBIA 2174
"RTN","PSJORUTL",6,0)
 ;Reference to ^PS(52.6 is supported by DBIA 1231
"RTN","PSJORUTL",7,0)
 ;Reference to ^PS(52.7 is supported by DBIA 2173
"RTN","PSJORUTL",8,0)
 ;Reference to ^PSDRUG is supported by DBIA 2192
"RTN","PSJORUTL",9,0)
 ;Reference to ^PSNDF( is supported by DBIA 2195
"RTN","PSJORUTL",10,0)
 ;Reference to ^YSCL(603.01 is supported by DBIA 2697
"RTN","PSJORUTL",11,0)
 ;
"RTN","PSJORUTL",12,0)
ENDD(PD,TYP,PSJ,DFN) ; Find all entries in DRUG file (50) for the passed primary/usage.
"RTN","PSJORUTL",13,0)
 ;Input: PD - NATIONAL DRUG FILE ENTRY (20).PSNDF VA PRODUCT NAME ENTRY
"RTN","PSJORUTL",14,0)
 ;            ^NDF ptr.NDF form ptr^NDF Name^Primary IEN^Primary
"RTN","PSJORUTL",15,0)
 ;            Name^"99PSP".
"RTN","PSJORUTL",16,0)
 ;       TYP- String identifying type of drug (O:OP; U:UD; I:IV etc).
"RTN","PSJORUTL",17,0)
 ;Output:PSJ- Array containing all entries in the DRUG file (50) tied
"RTN","PSJORUTL",18,0)
 ;            to the PD for the type(s) of drugs specified. Array is
"RTN","PSJORUTL",19,0)
 ;            returned: ARRAY(PSJ)=IEN^GENERIC NAME (.01)^PRICE PER
"RTN","PSJORUTL",20,0)
 ;            DISPENSE UNIT (16)^NON-FORMULARY (51)^DISPENSE UNIT (14.5)
"RTN","PSJORUTL",21,0)
 ;            ^MAX NUMBER OF REFILLS ;5.27.97/SAB
"RTN","PSJORUTL",22,0)
 ;            If no 50 entries found, PSJ=0; Else PSJ=# of entries.
"RTN","PSJORUTL",23,0)
 ;
"RTN","PSJORUTL",24,0)
 N MAX,DEA,DEAI,DDRG,INACT,ND,X,Y S PSJ=0,PD=+$P(PD,U,4)
"RTN","PSJORUTL",25,0)
 F DDRG=0:0 S DDRG=$O(^PSDRUG("ASP",PD,DDRG)) Q:'DDRG  S INACT=$G(^PSDRUG(DDRG,"I")) I ('INACT)!(INACT'<DT) S Y=$P($G(^PSDRUG(DDRG,2)),U,3) D
"RTN","PSJORUTL",26,0)
 .F X=1:1:$L(TYP) I Y[$E(TYP,X) S Y=1 Q
"RTN","PSJORUTL",27,0)
 .D:Y
"RTN","PSJORUTL",28,0)
 ..S ND=$G(^PSDRUG(DDRG,0)),Y=$G(^(660)),PSJ=PSJ+1,PSJ(PSJ)=DDRG_U_$P(ND,U)_U_$P(Y,U,6)_U_$P(ND,U,9)_U_$P(Y,U,8) D MAX S PSJ(PSJ)=PSJ(PSJ)_U_MAX K MAX
"RTN","PSJORUTL",29,0)
 Q
"RTN","PSJORUTL",30,0)
 ;
"RTN","PSJORUTL",31,0)
ENDDIV(PD,TYP,VOLUME,PSJ) ; Find all entries in DRUG file (50) for the passed Orderable item, IV additive/solution.
"RTN","PSJORUTL",32,0)
 ;Input: PD - Orderable item Pointer.
"RTN","PSJORUTL",33,0)
 ;       TYP- String identifying type of drug (A:ADDITIVE, B:BASE).
"RTN","PSJORUTL",34,0)
 ;    VOLUME- Volume used to uniquely identify a dispense drug.
"RTN","PSJORUTL",35,0)
 ;Output:PSJ- A string containing all entries in the DRUG file (50) tied
"RTN","PSJORUTL",36,0)
 ;            to the PD for the type(s) of drugs specified. This string
"RTN","PSJORUTL",37,0)
 ;            returned: PSJ=IEN^GENERIC NAME (.01)^PRICE PER DISPENSE
"RTN","PSJORUTL",38,0)
 ;            UNIT (16)^NON-FORMULARY (51)^DISPENSE UNIT (14.5)
"RTN","PSJORUTL",39,0)
 ;
"RTN","PSJORUTL",40,0)
 NEW PSJIENS,Y S PSJ=0
"RTN","PSJORUTL",41,0)
 Q:$G(PD)=""
"RTN","PSJORUTL",42,0)
 Q:$G(TYP)=""
"RTN","PSJORUTL",43,0)
 S:TYP="A" PSJIENS=$$ADDD^PSJMISC(PD)
"RTN","PSJORUTL",44,0)
 S:TYP="B" PSJIENS=$$SOLDD^PSJMISC(PD,$G(VOLUME))
"RTN","PSJORUTL",45,0)
 I PSJIENS="" Q
"RTN","PSJORUTL",46,0)
 S ND=$G(^PSDRUG(+PSJIENS,0)),Y=$G(^(660)),PSJ=+PSJIENS_U_$P(ND,U)_U_$P(Y,U,6)_U_$P(ND,U,9)_U_$P(Y,U,8)
"RTN","PSJORUTL",47,0)
 Q
"RTN","PSJORUTL",48,0)
 ;
"RTN","PSJORUTL",49,0)
ENDCM(DDRG)        ; Find Drug Cost, Message, and VA Product Name IEN
"RTN","PSJORUTL",50,0)
 ;Input:  DDRG - IEN of entry in DRUG file (50).
"RTN","PSJORUTL",51,0)
 ;Output: PRICE PER DISPENSE UNIT(16)^MESSAGE (101)^NATIONAL DRUG FILE
"RTN","PSJORUTL",52,0)
 ;        ENTRY(20).PSNDF VA PRODUCT NAME ENTRY (22)^QTY DISPENSE MESSAGE
"RTN","PSJORUTL",53,0)
 ; If either NDF ptr is not found 0 will be returned instead of 20.22.
"RTN","PSJORUTL",54,0)
 ;
"RTN","PSJORUTL",55,0)
 N X S X=$G(^PSDRUG(+DDRG,"ND"))
"RTN","PSJORUTL",56,0)
 Q $P($G(^PSDRUG(+DDRG,660)),U,3)_U_$P($G(^(0)),U,10)_U_$S('+X:0,'$P(X,U,3):0,1:+X_"."_$P(X,U,3))_U_$P($G(^PSDRUG(+DDRG,5)),"^")
"RTN","PSJORUTL",57,0)
 ;
"RTN","PSJORUTL",58,0)
ENRFA(DDRG,TYP,PSJ)        ; Returns formulary alternatives for a dispense drug.
"RTN","PSJORUTL",59,0)
 ;Input:  DDRG - IEN of entry in DRUG file (50).
"RTN","PSJORUTL",60,0)
 ;         TYP - String identifying type of drug (O:OP; U:UD; I:IV etc).
"RTN","PSJORUTL",61,0)
 ;Output: ARRAY(INDEX#)=IEN of Formulary alternative^Formulary
"RTN","PSJORUTL",62,0)
 ;        alternative name^Formulary alternative cost^Orderable Item
"RTN","PSJORUTL",63,0)
 ;        IEN^Orderable Item name^MAX NUMBER REFILLS.
"RTN","PSJORUTL",64,0)
 ;If no alternatives are found PSJ=0; Else PSJ=# of entries.
"RTN","PSJORUTL",65,0)
 ;
"RTN","PSJORUTL",66,0)
 K PSJ S PSJ=0 Q:'$O(^PSDRUG(+DDRG,65,0))
"RTN","PSJORUTL",67,0)
 N MAX,DEA,DEAI,X,XX,Y,YY S YY=0
"RTN","PSJORUTL",68,0)
 F X=0:0 S X=$O(^PSDRUG(+DDRG,65,X)) Q:'X  S Y=$G(^PSDRUG(+DDRG,65,X,0)) I X D
"RTN","PSJORUTL",69,0)
 .F XX=1:1:$L(TYP) I $P($G(^PSDRUG(+Y,2)),U,3)[$E(TYP,XX) S YY=1 Q
"RTN","PSJORUTL",70,0)
 .D:YY
"RTN","PSJORUTL",71,0)
 ..S YY=+$G(^PSDRUG(+Y,2)),PSJ=PSJ+1,PSJ(+Y)=+Y_U_$$ENDDN^PSGMI(+Y)_U_$P($G(^PSDRUG(+Y,660)),U,6)_U_YY_U_$$OIDF^PSJLMUT1(YY) D MAX S PSJ(+Y)=PSJ(+Y)_U_MAX K MAX
"RTN","PSJORUTL",72,0)
 Q
"RTN","PSJORUTL",73,0)
 ;
"RTN","PSJORUTL",74,0)
ENDF(PN) ; Returns dosage form for the specified VA Product Name.
"RTN","PSJORUTL",75,0)
 ;Input:  PN - NATIONAL DRUG FILE ENTRY (20).PSNDF VA PRODUCT NAME ENTRY
"RTN","PSJORUTL",76,0)
 ;Output: NDF Dosage Form IEN^NDF Dosage From IEN
"RTN","PSJORUTL",77,0)
 ;
"RTN","PSJORUTL",78,0)
 ; NEW NDF CALL
"RTN","PSJORUTL",79,0)
 N X S X="PSNAPIS" X ^%ZOSF("TEST") I  N PSJDF,X1,X2 S X1=+$P(PN,"."),X2=+$P(PN,".",2),PSJDF=$$PSJDF^PSNAPIS(X1,X2) Q $S(PSJDF="":0,1:PSJDF)
"RTN","PSJORUTL",80,0)
 ;
"RTN","PSJORUTL",81,0)
 N PSJNDF,X S X=$P($G(^PSNDF(+$P(PN,"."),5,+$P(PN,".",2),0)),U,2),X=+$G(^PSNDF(+$P(PN,"."),2,+X,0)),PSJDF=$P($G(^PS(50.606,+X,0)),U)
"RTN","PSJORUTL",82,0)
 Q $S(PSJDF="":0,'X:0,1:+X_U_PSJDF)
"RTN","PSJORUTL",83,0)
 ;
"RTN","PSJORUTL",84,0)
ENNDFS(PN) ; Returns STRENGTH from ^PSNDF for the specified VA Product Name.
"RTN","PSJORUTL",85,0)
 ; NEW NDF CALL 
"RTN","PSJORUTL",86,0)
 N X S X="PSNAPIS" X ^%ZOSF("TEST") I  N X1,X2,PNS S X1=+$P(PN,"."),X2=+$P(PN,".",2),PNS=$$PSJST^PSNAPIS(X1,X2) Q $S(PNS="":0,1:PNS)
"RTN","PSJORUTL",87,0)
 ;
"RTN","PSJORUTL",88,0)
 N PNS,X,Y S X=$P($G(^PSNDF(+$P(PN,"."),5,+$P(PN,".",2),0)),U,3),Y=+$P($G(^PSNDF(+$P(PN,"."),5,+$P(PN,".",2),0)),"^",2),PNS=$P($G(^PSNDF(+$P(PN,"."),2,+Y,3,+X,0)),U)
"RTN","PSJORUTL",89,0)
 Q $S(PNS="":0,'X:0,1:+X_U_PNS)
"RTN","PSJORUTL",90,0)
 ;
"RTN","PSJORUTL",91,0)
ENDI(PN,PSJ) ; Find all ingredients for the passed dispense drug.
"RTN","PSJORUTL",92,0)
 ;Input:  PN - VA Product Name IEN
"RTN","PSJORUTL",93,0)
 ;Output: PSJ - Array listing ingredients for the specified PN in the
"RTN","PSJORUTL",94,0)
 ;              form of PSJ(Ing. file ptr (50.416))=Ing IEN^Ing. name
"RTN","PSJORUTL",95,0)
 ;              ^Ing. amt./Ing. units
"RTN","PSJORUTL",96,0)
 ;If no ing. found, PSJ=0. If ing. found, PSJ=1
"RTN","PSJORUTL",97,0)
 ;  NEW NDF CALL 
"RTN","PSJORUTL",98,0)
 N X S X="PSNAPIS" X ^%ZOSF("TEST") I  N X1,X2 S X1=+$P(PN,"."),X2=+$P(PN,".",2),PSJ=$$PSJING^PSNAPIS(X1,X2,.PSJ) Q
"RTN","PSJORUTL",99,0)
 ;
"RTN","PSJORUTL",100,0)
 N GDP,ING,INGND,INGNME,INGPTR,PNP,X,Y
"RTN","PSJORUTL",101,0)
 S PSJ=0,GDP=$P(PN,"."),PNP=$P(PN,".",2)
"RTN","PSJORUTL",102,0)
 F X=1:1:3 S INGND=$G(^PSNDF(+GDP,5,+PNP,X)) F Y=1:1:$L(INGND,",") D
"RTN","PSJORUTL",103,0)
 .S ING=$P(INGND,",",Y),INGNME=$P($G(^PSNDF(+GDP,1,+ING,0)),U),INGPTR=$S(INGNME="":"Not Found",1:$O(^PS(50.416,"B",INGNME,0)))
"RTN","PSJORUTL",104,0)
 .S PSJ=1,PSJ(+INGPTR)=INGPTR_U_INGNME_U_$P(ING,"/",2,3)
"RTN","PSJORUTL",105,0)
 Q
"RTN","PSJORUTL",106,0)
 ;
"RTN","PSJORUTL",107,0)
ENSDC(PSGP) ; Add IV and UD orders to ^TMP global used for order checking.
"RTN","PSJORUTL",108,0)
 ; Input: PSGP - Patient IEN
"RTN","PSJORUTL",109,0)
 ; Output: ^TMP($J("ORDERS",DRUG NAME)=DRUG CLASS CODE^NDF POINTER*
"RTN","PSJORUTL",110,0)
 ;
"RTN","PSJORUTL",111,0)
MAX ;returns max number of refills for outpatient orders ;5.27.97/SAB
"RTN","PSJORUTL",112,0)
 K MAX S DEA=$P($G(^PSDRUG(DDRG,0)),"^",3)
"RTN","PSJORUTL",113,0)
 I $P($G(^PSDRUG(DDRG,"CLOZ1")),"^")="PSOCLO1",$G(DFN) D  Q
"RTN","PSJORUTL",114,0)
 .S CLOZPAT=$O(^YSCL(603.01,"C",DFN,0)) S MAX=$S($P($G(^YSCL(603.01,+CLOZPAT,0)),"^",3)="B":1,1:0) K CLOZPAT
"RTN","PSJORUTL",115,0)
 I DEA["A",DEA'["B" S MAX=0 K DEA Q
"RTN","PSJORUTL",116,0)
 F DEAI=1:1:$L(DEA) I $E(+DEA,DEAI)>1,$E(+DEA,DEAI)<6 S MAX=5
"RTN","PSJORUTL",117,0)
 K DEA,DEAI Q:$G(MAX)=5  S MAX=11
"RTN","PSJORUTL",118,0)
 Q
"VER")
8.0^22.2
**END**
**END**
