KIDS Distribution saved on Jan 04, 2018@13:48:28
PSO*500, PSJ*347, OR*469 from [dosp] ON 1/4/18
**KIDS**:MOCHA 2.1 COMBINED FOLLOW UP BUILD 1.0^PSO*7.0*500^PSJ*5.0*347^OR*3.0*469^

**INSTALL NAME**
MOCHA 2.1 COMBINED FOLLOW UP BUILD 1.0
"BLD",9992,0)
MOCHA 2.1 COMBINED FOLLOW UP BUILD 1.0^^1^3180104^y
"BLD",9992,1,0)
^^1^1^3180103^
"BLD",9992,1,1,0)
MOCHA 2.1B Follow On Patch bundle.
"BLD",9992,6.3)
2
"BLD",9992,10,0)
^9.63^3^3
"BLD",9992,10,1,0)
PSO*7.0*500^1
"BLD",9992,10,2,0)
PSJ*5.0*347^1
"BLD",9992,10,3,0)
OR*3.0*469^1
"BLD",9992,10,"B","OR*3.0*469",3)

"BLD",9992,10,"B","PSJ*5.0*347",2)

"BLD",9992,10,"B","PSO*7.0*500",1)

"BLD",9992,"KRN",0)
^9.67PA^779.2^20
"BLD",9992,"KRN",.4,0)
.4
"BLD",9992,"KRN",.401,0)
.401
"BLD",9992,"KRN",.402,0)
.402
"BLD",9992,"KRN",.403,0)
.403
"BLD",9992,"KRN",.5,0)
.5
"BLD",9992,"KRN",.84,0)
.84
"BLD",9992,"KRN",3.6,0)
3.6
"BLD",9992,"KRN",3.8,0)
3.8
"BLD",9992,"KRN",9.2,0)
9.2
"BLD",9992,"KRN",9.8,0)
9.8
"BLD",9992,"KRN",19,0)
19
"BLD",9992,"KRN",19.1,0)
19.1
"BLD",9992,"KRN",101,0)
101
"BLD",9992,"KRN",409.61,0)
409.61
"BLD",9992,"KRN",771,0)
771
"BLD",9992,"KRN",779.2,0)
779.2
"BLD",9992,"KRN",870,0)
870
"BLD",9992,"KRN",8989.51,0)
8989.51
"BLD",9992,"KRN",8989.52,0)
8989.52
"BLD",9992,"KRN",8994,0)
8994
"BLD",9992,"KRN","B",.4,.4)

"BLD",9992,"KRN","B",.401,.401)

"BLD",9992,"KRN","B",.402,.402)

"BLD",9992,"KRN","B",.403,.403)

"BLD",9992,"KRN","B",.5,.5)

"BLD",9992,"KRN","B",.84,.84)

"BLD",9992,"KRN","B",3.6,3.6)

"BLD",9992,"KRN","B",3.8,3.8)

"BLD",9992,"KRN","B",9.2,9.2)

"BLD",9992,"KRN","B",9.8,9.8)

"BLD",9992,"KRN","B",19,19)

"BLD",9992,"KRN","B",19.1,19.1)

"BLD",9992,"KRN","B",101,101)

"BLD",9992,"KRN","B",409.61,409.61)

"BLD",9992,"KRN","B",771,771)

"BLD",9992,"KRN","B",779.2,779.2)

"BLD",9992,"KRN","B",870,870)

"BLD",9992,"KRN","B",8989.51,8989.51)

"BLD",9992,"KRN","B",8989.52,8989.52)

"BLD",9992,"KRN","B",8994,8994)

"MBREQ")
0
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"VER")
8.0^22.2
**INSTALL NAME**
PSO*7.0*500
"BLD",9884,0)
PSO*7.0*500^OUTPATIENT PHARMACY^0^3180104^y
"BLD",9884,1,0)
^^6^6^3170817^^^
"BLD",9884,1,1,0)
THIS IS A FOLLOW UP PATCH.
"BLD",9884,1,2,0)
 
"BLD",9884,1,3,0)
This patch incorporates routine changes introduced into PSOORED5 in 
"BLD",9884,1,4,0)
PSO*7.0*486 and merges them with routine changes in PSO*7.0*402.
"BLD",9884,1,5,0)
 
"BLD",9884,1,6,0)
Refer to the install guide for installation instructions.
"BLD",9884,4,0)
^9.64PA^^
"BLD",9884,6.3)
9
"BLD",9884,"ABPKG")
n
"BLD",9884,"KRN",0)
^9.67PA^779.2^20
"BLD",9884,"KRN",.4,0)
.4
"BLD",9884,"KRN",.401,0)
.401
"BLD",9884,"KRN",.402,0)
.402
"BLD",9884,"KRN",.403,0)
.403
"BLD",9884,"KRN",.5,0)
.5
"BLD",9884,"KRN",.84,0)
.84
"BLD",9884,"KRN",3.6,0)
3.6
"BLD",9884,"KRN",3.8,0)
3.8
"BLD",9884,"KRN",9.2,0)
9.2
"BLD",9884,"KRN",9.8,0)
9.8
"BLD",9884,"KRN",9.8,"NM",0)
^9.68A^19^18
"BLD",9884,"KRN",9.8,"NM",1,0)
PSOORED5^^0^B73345856
"BLD",9884,"KRN",9.8,"NM",2,0)
PSOVER1^^0^B131717973
"BLD",9884,"KRN",9.8,"NM",3,0)
PSORXEDT^^0^B52436750
"BLD",9884,"KRN",9.8,"NM",5,0)
PSODGAL^^1^
"BLD",9884,"KRN",9.8,"NM",6,0)
PSODGAL1^^0^B111659050
"BLD",9884,"KRN",9.8,"NM",7,0)
PSOSIG^^0^B96478034
"BLD",9884,"KRN",9.8,"NM",8,0)
PSODDPR4^^0^B142687224
"BLD",9884,"KRN",9.8,"NM",9,0)
PSODDPR8^^0^B59640557
"BLD",9884,"KRN",9.8,"NM",10,0)
PSODEM^^0^B18912575
"BLD",9884,"KRN",9.8,"NM",11,0)
PSONVAVW^^0^B19324359
"BLD",9884,"KRN",9.8,"NM",12,0)
PSOORUT2^^0^B105702086
"BLD",9884,"KRN",9.8,"NM",13,0)
PSOPMP0^^0^B89710024
"BLD",9884,"KRN",9.8,"NM",14,0)
PSOSD1^^0^B48994823
"BLD",9884,"KRN",9.8,"NM",15,0)
PSOSD2^^0^B29770075
"BLD",9884,"KRN",9.8,"NM",16,0)
PSOSD3^^0^B38868653
"BLD",9884,"KRN",9.8,"NM",17,0)
PSOSDP^^0^B31171102
"BLD",9884,"KRN",9.8,"NM",18,0)
PSODOSUN^^0^B100248418
"BLD",9884,"KRN",9.8,"NM",19,0)
PSOBKDE1^^0^B8511547
"BLD",9884,"KRN",9.8,"NM","B","PSOBKDE1",19)

"BLD",9884,"KRN",9.8,"NM","B","PSODDPR4",8)

"BLD",9884,"KRN",9.8,"NM","B","PSODDPR8",9)

"BLD",9884,"KRN",9.8,"NM","B","PSODEM",10)

"BLD",9884,"KRN",9.8,"NM","B","PSODGAL",5)

"BLD",9884,"KRN",9.8,"NM","B","PSODGAL1",6)

"BLD",9884,"KRN",9.8,"NM","B","PSODOSUN",18)

"BLD",9884,"KRN",9.8,"NM","B","PSONVAVW",11)

"BLD",9884,"KRN",9.8,"NM","B","PSOORED5",1)

"BLD",9884,"KRN",9.8,"NM","B","PSOORUT2",12)

"BLD",9884,"KRN",9.8,"NM","B","PSOPMP0",13)

"BLD",9884,"KRN",9.8,"NM","B","PSORXEDT",3)

"BLD",9884,"KRN",9.8,"NM","B","PSOSD1",14)

"BLD",9884,"KRN",9.8,"NM","B","PSOSD2",15)

"BLD",9884,"KRN",9.8,"NM","B","PSOSD3",16)

"BLD",9884,"KRN",9.8,"NM","B","PSOSDP",17)

"BLD",9884,"KRN",9.8,"NM","B","PSOSIG",7)

"BLD",9884,"KRN",9.8,"NM","B","PSOVER1",2)

"BLD",9884,"KRN",19,0)
19
"BLD",9884,"KRN",19.1,0)
19.1
"BLD",9884,"KRN",101,0)
101
"BLD",9884,"KRN",409.61,0)
409.61
"BLD",9884,"KRN",771,0)
771
"BLD",9884,"KRN",779.2,0)
779.2
"BLD",9884,"KRN",870,0)
870
"BLD",9884,"KRN",8989.51,0)
8989.51
"BLD",9884,"KRN",8989.52,0)
8989.52
"BLD",9884,"KRN",8994,0)
8994
"BLD",9884,"KRN","B",.4,.4)

"BLD",9884,"KRN","B",.401,.401)

"BLD",9884,"KRN","B",.402,.402)

"BLD",9884,"KRN","B",.403,.403)

"BLD",9884,"KRN","B",.5,.5)

"BLD",9884,"KRN","B",.84,.84)

"BLD",9884,"KRN","B",3.6,3.6)

"BLD",9884,"KRN","B",3.8,3.8)

"BLD",9884,"KRN","B",9.2,9.2)

"BLD",9884,"KRN","B",9.8,9.8)

"BLD",9884,"KRN","B",19,19)

"BLD",9884,"KRN","B",19.1,19.1)

"BLD",9884,"KRN","B",101,101)

"BLD",9884,"KRN","B",409.61,409.61)

"BLD",9884,"KRN","B",771,771)

"BLD",9884,"KRN","B",779.2,779.2)

"BLD",9884,"KRN","B",870,870)

"BLD",9884,"KRN","B",8989.51,8989.51)

"BLD",9884,"KRN","B",8989.52,8989.52)

"BLD",9884,"KRN","B",8994,8994)

"BLD",9884,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9884,"QUES",0)
^9.62^^
"BLD",9884,"REQB",0)
^9.611^4^4
"BLD",9884,"REQB",1,0)
PSO*7.0*486^2
"BLD",9884,"REQB",2,0)
PSO*7.0*402^2
"BLD",9884,"REQB",3,0)
PSO*7.0*422^2
"BLD",9884,"REQB",4,0)
PSO*7.0*446^2
"BLD",9884,"REQB","B","PSO*7.0*402",2)

"BLD",9884,"REQB","B","PSO*7.0*422",3)

"BLD",9884,"REQB","B","PSO*7.0*446",4)

"BLD",9884,"REQB","B","PSO*7.0*486",1)

"MBREQ")
1
"ORD",0,9.8)
9.8;;1;RTNF^XPDTA;RTNE^XPDTA
"ORD",0,9.8,0)
ROUTINE
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
500^3180104
"PKG",141,22,1,"PAH",1,1,0)
^^6^6^3180104
"PKG",141,22,1,"PAH",1,1,1,0)
THIS IS A FOLLOW UP PATCH.
"PKG",141,22,1,"PAH",1,1,2,0)
 
"PKG",141,22,1,"PAH",1,1,3,0)
This patch incorporates routine changes introduced into PSOORED5 in 
"PKG",141,22,1,"PAH",1,1,4,0)
PSO*7.0*486 and merges them with routine changes in PSO*7.0*402.
"PKG",141,22,1,"PAH",1,1,5,0)
 
"PKG",141,22,1,"PAH",1,1,6,0)
Refer to the install guide for installation instructions.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
18
"RTN","PSOBKDE1")
0^19^B8511547
"RTN","PSOBKDE1",1,0)
PSOBKDE1 ;BIR/MR-Sub-routines for Backdoor Rx Order Edit ;11/25/02
"RTN","PSOBKDE1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**117,133,372,402,500**;DEC 1997;Build 9
"RTN","PSOBKDE1",3,0)
 ;
"RTN","PSOBKDE1",4,0)
LST1 ;
"RTN","PSOBKDE1",5,0)
 W @IOF
"RTN","PSOBKDE1",6,0)
 N PSOLCNT,DIRUT,DTOUT,DUOUT,I,PSODOSCT,PSODOSFL,PSOBKDF1
"RTN","PSOBKDE1",7,0)
 W !,"This is the amount of medication the patient is to receive as one dose"
"RTN","PSOBKDE1",8,0)
 W !,"for this order. This can be a numeric value, such as 325 or 650 or an"
"RTN","PSOBKDE1",9,0)
 W !,"amount with a unit of measure such as 325MG or 650MG. You may also enter"
"RTN","PSOBKDE1",10,0)
 W !,"a free text dosage, such as 1 Tablet or 2 Tablets",!
"RTN","PSOBKDE1",11,0)
 S PSOLCNT=5,PSOBKDF1=1
"RTN","PSOBKDE1",12,0)
 ;
"RTN","PSOBKDE1",13,0)
LST ;
"RTN","PSOBKDE1",14,0)
 I '$G(PSOBKDF1) W @IOF S PSOBKDF1=1
"RTN","PSOBKDE1",15,0)
 N DIR I '$D(DOSE("DD")) D  Q
"RTN","PSOBKDE1",16,0)
 . W !," No dosages are available"
"RTN","PSOBKDE1",17,0)
 . N X S X=$$GET1^DIQ(50,PSODRUG("IEN"),100,"I")
"RTN","PSOBKDE1",18,0)
 . W $S(X'=""&(DT>X):" because the Drug is now Inactive.",1:"!")
"RTN","PSOBKDE1",19,0)
 . W !," Please, enter a free text dosage, or You may select a New"
"RTN","PSOBKDE1",20,0)
 . W !," Orderable Item and Dispense Drug for this order, or you can"
"RTN","PSOBKDE1",21,0)
 . W !," enter a New Order with an Active Drug."
"RTN","PSOBKDE1",22,0)
 . S PSOLCNT=$G(PSOLCNT)+4
"RTN","PSOBKDE1",23,0)
 ;
"RTN","PSOBKDE1",24,0)
 I $P(DOSE("DD",PSODRUG("IEN")),"^",5)]"" D
"RTN","PSOBKDE1",25,0)
 .W !,"VERB: "_$P(DOSE("DD",PSODRUG("IEN")),"^",10)
"RTN","PSOBKDE1",26,0)
 .S PSOLCNT=$G(PSOLCNT)+1
"RTN","PSOBKDE1",27,0)
 ;
"RTN","PSOBKDE1",28,0)
LST2 ;
"RTN","PSOBKDE1",29,0)
 I '$G(PSOBKDF1) W @IOF S PSOBKDF1=1
"RTN","PSOBKDE1",30,0)
 N PSOEND
"RTN","PSOBKDE1",31,0)
 S (PSODOSFL,PSODOSCT)=0
"RTN","PSOBKDE1",32,0)
 F I=0:0 S I=$O(DOSE(I)) Q:'I!('$D(DOSE(I)))  S PSODOSCT=I
"RTN","PSOBKDE1",33,0)
 I PSODOSCT=1,$P(DOSE(1),"^")=""&($P(DOSE(1),"^",3)="") S PSODOSFL=1
"RTN","PSOBKDE1",34,0)
 W !!,"There "_$S(PSODOSFL:"are NO",PSODOSCT=1&('PSODOSFL):"is ",1:"are ")_$S(PSODOSFL:"",1:PSODOSCT)_" Available Dosage(s)."
"RTN","PSOBKDE1",35,0)
 F I=0:0 S I=$O(DOSE(I)) Q:'I!('$D(DOSE(I)))  D
"RTN","PSOBKDE1",36,0)
 .S PSOLCNT=$G(PSOLCNT)+1
"RTN","PSOBKDE1",37,0)
 .W:'$G(PSODOSFL) !?5,$J(I,3)_". "_$S($P(DOSE(I),"^"):$P(DOSE(I),"^")_$S($P(DOSE("DD",PSODRUG("IEN")),"^",6)]"":$P(DOSE("DD",PSODRUG("IEN")),"^",6),1:""),$P(DOSE(I),"^",3)'="":$P(DOSE(I),"^",3),1:"Please Enter a Free Text Dosage.")
"RTN","PSOBKDE1",38,0)
 .;Q:(PSOLCNT+2)>PSODOSFL
"RTN","PSOBKDE1",39,0)
 .I (($Y+5)>IOSL) D PAUSE S PSOLCNT=0 W !
"RTN","PSOBKDE1",40,0)
 .;I PSOLCNT>16&(I>2) D PAUSE S PSOLCNT=0 W !
"RTN","PSOBKDE1",41,0)
 K DIRUT,DIR
"RTN","PSOBKDE1",42,0)
 Q
"RTN","PSOBKDE1",43,0)
 ;
"RTN","PSOBKDE1",44,0)
PAUSE ;
"RTN","PSOBKDE1",45,0)
 Q:PSODOSCT=I
"RTN","PSOBKDE1",46,0)
 N DIR
"RTN","PSOBKDE1",47,0)
 S DIR("A")="Enter RETURN to view additional dosages or '^' to exit the list of dosages"
"RTN","PSOBKDE1",48,0)
 S DIR(0)="E" W !
"RTN","PSOBKDE1",49,0)
 D ^DIR
"RTN","PSOBKDE1",50,0)
 I $D(DTOUT)!($D(DUOUT)) S I=9999 Q
"RTN","PSOBKDE1",51,0)
 W @IOF
"RTN","PSOBKDE1",52,0)
 Q
"RTN","PSODDPR4")
0^8^B142687224
"RTN","PSODDPR4",1,0)
PSODDPR4 ;BHAM - ISC/EJW,SAB - build local OP  & RDI profiles ;07/19/07
"RTN","PSODDPR4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,387,379,390,372,416,484,500**;DEC 1997;Build 9
"RTN","PSODDPR4",3,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSODDPR4",4,0)
 ;External references to ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSODDPR4",5,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSODDPR4",6,0)
 ;External reference to IN^PSJBLDOC supported by DBIA 5306
"RTN","PSODDPR4",7,0)
 ;External references to ^PSSDSAPM supported by DBIA 5570
"RTN","PSODDPR4",8,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSODDPR4",9,0)
 ;External reference to ENCHK^PSJORUT2 supported by DBIA 2376
"RTN","PSODDPR4",10,0)
 ;External reference to IN^PSSHRQ2 supported by DBIA 5369
"RTN","PSODDPR4",11,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPR4",12,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPR4",13,0)
 ;External reference to SUP^PSSDSAPI supported by DBIA 5425
"RTN","PSODDPR4",14,0)
 ;
"RTN","PSODDPR4",15,0)
BLD(PSODFN,LIST,PDRG,PTY) ;
"RTN","PSODDPR4",16,0)
 ;build OP, RDI, INP MEDS profiles
"RTN","PSODDPR4",17,0)
 ;PTY - P1;P2 where P1="I" for IP & "O" for OP (required), P2=Pharm order# (optional)
"RTN","PSODDPR4",18,0)
 I '$D(PSODFN) W !,"Patient UNDEFINED!",! Q
"RTN","PSODDPR4",19,0)
 I '$D(LIST) W !,"Input Base UNDEFINED!",! Q
"RTN","PSODDPR4",20,0)
 K ^TMP($J,LIST)
"RTN","PSODDPR4",21,0)
ORD N PSODTCUT,X1,X2,ODRG,ORTYP,ORN,DO,IEN,NAME,PROF,PSOON,PSOFRMNM S (PROF,CNT)=0
"RTN","PSODDPR4",22,0)
 F ZI=0:0 S ZI=$O(PDRG(ZI)) Q:'ZI  S IEN=$P(PDRG(ZI),"^"),NAME=$P(PDRG(ZI),"^",2) K PSOFRMNM S:$G(PSOFRMOR) PSOFRMNM=$P(PDRG(ZI),"^",4) D DRG
"RTN","PSODDPR4",23,0)
 I $D(PSJDGCK),'$D(PSGDGCKF) Q:$O(^TMP($J,LIST,"IN","PROSPECTIVE",""))=""   ;no prospective drugs to pass in
"RTN","PSODDPR4",24,0)
 I '$D(PSJDGCK),$O(^TMP($J,LIST,"IN","PROSPECTIVE",""))="" D:$O(PSODUPSP(0)) DRGSUP Q  ;no prospective drugs to pass in and drug is supply, create supply nodes
"RTN","PSODDPR4",25,0)
 S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X D ^PSOBUILD,PROFILE
"RTN","PSODDPR4",26,0)
 K PSOSD D REMOTE D:$P($G(PTY),";")="I" IN^PSJBLDOC(PSODFN,LIST,.PDRG,$G(PTY))
"RTN","PSODDPR4",27,0)
 S ^TMP($J,LIST,"IN","IEN")=PSODFN,^TMP($J,LIST,"IN","DRUGDRUG")="",^TMP($J,LIST,"IN","THERAPY")=""
"RTN","PSODDPR4",28,0)
 S ^TMP($J,LIST,"IN","SOURCE")=$P($G(PTY),";")
"RTN","PSODDPR4",29,0)
 I $P($G(PTY),";")="O" D IMO^PSODDPR7(PSODFN)
"RTN","PSODDPR4",30,0)
 N PSOICT,PSODRUG,PSOY,CNT,ZI
"RTN","PSODDPR4",31,0)
 D IN^PSSHRQ2(LIST) D:$O(PSODUPSP(0)) DRGSUP
"RTN","PSODDPR4",32,0)
 Q
"RTN","PSODDPR4",33,0)
PROFILE ;build profile drug input
"RTN","PSODDPR4",34,0)
 N ID,ORTYP,DD,PSOI,ORN,RECTYP S (STA,DNM)="",DO=0
"RTN","PSODDPR4",35,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""  D
"RTN","PSODDPR4",36,0)
 .I STA="PENDING" D  Q
"RTN","PSODDPR4",37,0)
 ..Q:$P(^PS(52.41,$P(PSOSD(STA,DNM),"^",10),0),"^",3)="RF"
"RTN","PSODDPR4",38,0)
 ..S RXREC=$P(PSOSD(STA,DNM),"^",10),ORN=$P(^PS(52.41,RXREC,0),"^"),ODRG=$P(^(0),"^",9),ORTYP="P"
"RTN","PSODDPR4",39,0)
 ..I ODRG D  K ODRG Q
"RTN","PSODDPR4",40,0)
 ...I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",41,0)
 ...S DRNM=$P(^PSDRUG(ODRG,0),"^"),DO=DO+1 D ID
"RTN","PSODDPR4",42,0)
 ..E  N PSOI,DDRG,ODRG,SEQN,DDRG S PSOI=$P(^PS(52.41,RXREC,0),"^",8) D
"RTN","PSODDPR4",43,0)
 ...S DRNM=$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR4",44,0)
 ...S DDRG=$$DRG^PSSDSAPM(PSOI,"O") I '$P(DDRG,";") D OIX Q
"RTN","PSODDPR4",45,0)
 ...I $P($G(^PSDRUG($P(DDRG,";"),0)),"^",3)["S"!($E($P($G(^PSDRUG($P(DDRG,";"),0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",46,0)
 ...S ODRG=$P(DDRG,";"),SEQN=+$P(DDRG,";",3) K PSOI
"RTN","PSODDPR4",47,0)
 ...N ID S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPR4",48,0)
 ...D ID1
"RTN","PSODDPR4",49,0)
 .I STA="ZNONVA" D  Q
"RTN","PSODDPR4",50,0)
 ..S RXREC=$P(PSOSD(STA,DNM),"^",10),ODRG=$P(^PS(55,PSODFN,"NVA",RXREC,0),"^",2),ORN=$P($G(^(0)),"^",8),ORTYP="N"
"RTN","PSODDPR4",51,0)
 ..I ODRG D  K ODRG Q
"RTN","PSODDPR4",52,0)
 ...I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",53,0)
 ...S DRNM=$P(^PSDRUG(ODRG,0),"^"),DO=DO+1 D ID
"RTN","PSODDPR4",54,0)
  ..E  N PSOI,DDRG,ODRG,SEQN,DDRG,DRNM S PSOI=$P(^PS(55,PSODFN,"NVA",RXREC,0),"^") D
"RTN","PSODDPR4",55,0)
 ...S DRNM=$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR4",56,0)
 ...S DDRG=$$DRG^PSSDSAPM(PSOI,"X") I '$P(DDRG,";") D:'$$NVATST^PSODDPRE(PSOI) OIX Q
"RTN","PSODDPR4",57,0)
 ...I $P($G(^PSDRUG($P(DDRG,";"),0)),"^",3)["S"!($E($P($G(^PSDRUG($P(DDRG,";"),0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",58,0)
 ...S ODRG=$P(DDRG,";"),SEQN=+$P(DDRG,";",3),DO=DO+1 K PSOI
"RTN","PSODDPR4",59,0)
 ...N ID S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPR4",60,0)
 ...D ID1
"RTN","PSODDPR4",61,0)
 .S RXREC=+PSOSD(STA,DNM)
"RTN","PSODDPR4",62,0)
 .I $P($G(PTY),";")="O",$P($G(PTY),";",2)=RXREC Q
"RTN","PSODDPR4",63,0)
 .I $P($G(^PSRX(RXREC,0)),"^",6) S ODRG=$P(^PSRX(RXREC,0),"^",6) D
"RTN","PSODDPR4",64,0)
 ..I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",65,0)
 ..I STA="DISCONTINUED" Q:$$DUPTHER^PSODDPRE(RXREC)  ;screen out duplicate therapy for local orders
"RTN","PSODDPR4",66,0)
 ..S ORN=$P($G(^PSRX(RXREC,"OR1")),"^",2),ORTYP="O",DRNM=$P(^PSDRUG(ODRG,0),"^"),DO=DO+1 D ID
"RTN","PSODDPR4",67,0)
 K RXREC,ID,STA,DNM,SEQN,PSOI,PSODD,P1,P3,OR1,P2,PSODRUG,DD,DRNM,DDRG
"RTN","PSODDPR4",68,0)
 Q
"RTN","PSODDPR4",69,0)
ID N ID S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPR4",70,0)
 S P1=$P($G(^PSDRUG(ODRG,"ND")),"^"),P2=$P($G(^("ND")),"^",3),X=$$PROD0^PSNAPIS(P1,P2),SEQN=+$P(X,"^",7)
"RTN","PSODDPR4",71,0)
ID1 I '$D(PSJDGCK) S ^TMP($J,LIST,"IN","PROFILE",ORTYP_";"_RXREC_";PROFILE;"_DO)=SEQN_"^"_ID_"^"_ODRG_"^"_DRNM_"^"_ORN_"^O" K ID
"RTN","PSODDPR4",72,0)
 I $D(PSJDGCK) S ^TMP($J,LIST,"IN","PROSPECTIVE",ORTYP_";"_RXREC_";PROSPECTIVE;"_DO)=SEQN_"^"_ID_"^"_ODRG_"^"_DRNM_"^"_ORN_"^O" K ID
"RTN","PSODDPR4",73,0)
 Q
"RTN","PSODDPR4",74,0)
OIX S ^TMP($J,LIST,"IN","EXCEPTIONS","OI",DRNM)=1_"^"_ORTYP_";"_RXREC_";PROFILE;"_DO
"RTN","PSODDPR4",75,0)
 K TU
"RTN","PSODDPR4",76,0)
 Q
"RTN","PSODDPR4",77,0)
REMOTE ;
"RTN","PSODDPR4",78,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSODDPR4",79,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSODDPR4",80,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) D  Q
"RTN","PSODDPR4",81,0)
 .I $T(REMOTE^PSORX1)]"" Q
"RTN","PSODDPR4",82,0)
 .D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODDPR4",83,0)
 .W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODDPR4",84,0)
 I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !!,"Remote data not available - Only local order checks processed." D HD^PSODDPR2():(($Y+5)'>IOSL) Q
"RTN","PSODDPR4",85,0)
 N PSORDI,RDIINST,RDIVUID,RDIRX,RDIDNAM,RDISTA,RDISIG,RDIDAYS,RDIQTY,RDIFILL,RDIEXP,RDIISS,RDIFILL,ZI
"RTN","PSODDPR4",86,0)
 N RDIREF,RDIPHYS,PSOPROD,PSOCLASS,DRNM,RDITMP,PSODC,IT,PSOICT,NDF,RDIDI,PSOPRODA,PSOFILE,PSOSIG,PSOSEQN,X
"RTN","PSODDPR4",87,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSODDPR4",88,0)
 S PSORDI=0
"RTN","PSODDPR4",89,0)
 I $T(GET^ORRDI1)]"" S PSORDI=$$GET^ORRDI1(PSODFN,"PSOO")
"RTN","PSODDPR4",90,0)
 I PSORDI<1 Q
"RTN","PSODDPR4",91,0)
 I '$D(^XTMP("ORRDI","PSOO",PSODFN)) Q
"RTN","PSODDPR4",92,0)
 K ^TMP($J,LIST,"OUT","REMOTE")
"RTN","PSODDPR4",93,0)
 D PARSE,FILTER
"RTN","PSODDPR4",94,0)
 I '$D(^TMP($J,LIST,"OUT","REMOTE")) Q
"RTN","PSODDPR4",95,0)
 N DIC D REMO
"RTN","PSODDPR4",96,0)
 Q
"RTN","PSODDPR4",97,0)
REMO ;
"RTN","PSODDPR4",98,0)
  S (PSOON,PSORDI)=0 F  S PSORDI=$O(^TMP($J,LIST,"OUT","REMOTE",PSORDI)) Q:'PSORDI  S RDITMP=^(PSORDI) D  K PSOSEQN
"RTN","PSODDPR4",99,0)
 .Q:$P(RDITMP,"^",2)=""
"RTN","PSODDPR4",100,0)
 .;screen out dc'd remotes
"RTN","PSODDPR4",101,0)
 .I $P($G(^TMP($J,LIST,"OUT","REMOTE",PSORDI)),"^",4)["DISC" D  I $G(PSOON) K PSOON Q
"RTN","PSODDPR4",102,0)
 ..K X,Y,X1,X2
"RTN","PSODDPR4",103,0)
 ..S X=$P(^TMP($J,LIST,"OUT","REMOTE",PSORDI),"^",6) D ^%DT S X1=Y,X2=(+$P(^TMP($J,LIST,"OUT","REMOTE",PSORDI),"^",7)+7)
"RTN","PSODDPR4",104,0)
 ..D C^%DTC I X<DT S PSOON=1 K X,Y,X1,X2
"RTN","PSODDPR4",105,0)
 .;
"RTN","PSODDPR4",106,0)
 .S RDIVUID=$P(RDITMP,"^",2),RDIDNAM=$P(RDITMP,"^",3)
"RTN","PSODDPR4",107,0)
 .I $O(PDRG(0)) F ZI=0:0 S ZI=$O(PDRG(ZI)) Q:'ZI  I $P(^PSDRUG($P(PDRG(ZI),"^"),0),"^")=RDIDNAM S INDD=+$G(INDD)+1,^TMP($J,"DD",INDD,0)=$P(PDRG(ZI),"^")_"^"_RDIDNAM_"^^"_PSORDI_"Z;O"
"RTN","PSODDPR4",108,0)
 .S DO=$G(DO)+1 D GETIREF^XTID(50.68,.01,RDIVUID,"PSOSEQN",1) I 'PSOSEQN S ^TMP($J,LIST,"IN","PROFILE","R;"_PSORDI_";PROFILE;"_DO)=0_"^"_RDIVUID_"^0^"_RDIDNAM_"^^" Q
"RTN","PSODDPR4",109,0)
 .S SEQN="" S SEQN=$O(PSOSEQN(50.68,.01,SEQN)) Q:SEQN=""
"RTN","PSODDPR4",110,0)
 .S P3=+SEQN,SEQN=$P($$PROD0^PSNAPIS(,P3),"^",7)
"RTN","PSODDPR4",111,0)
 .S ^TMP($J,LIST,"IN","PROFILE","R;"_PSORDI_";PROFILE;"_DO)=SEQN_"^"_RDIVUID_"^0^"_RDIDNAM_"^^"
"RTN","PSODDPR4",112,0)
 Q
"RTN","PSODDPR4",113,0)
 ;
"RTN","PSODDPR4",114,0)
PARSE ; PULL INFORMATION FROM ^XTMP
"RTN","PSODDPR4",115,0)
 N PSORDI,LOCAL,NEWISS,BADEXP,PSOPRE,PSO30,NEWDC,NEWEXP
"RTN","PSODDPR4",116,0)
 S PSORDI=0 F  S PSORDI=$O(^XTMP("ORRDI","PSOO",PSODFN,PSORDI)) Q:'PSORDI  D
"RTN","PSODDPR4",117,0)
 .S RDISTA=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,5,0))
"RTN","PSODDPR4",118,0)
 .I RDISTA="DELETED" Q
"RTN","PSODDPR4",119,0)
 .S RDIINST=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,1,0))
"RTN","PSODDPR4",120,0)
 .S RDIDNAM=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,2,0))
"RTN","PSODDPR4",121,0)
 .S RDIVUID=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,3,0))
"RTN","PSODDPR4",122,0)
 .I RDIVUID="" Q
"RTN","PSODDPR4",123,0)
 .D GETPROD^PSOORRDI
"RTN","PSODDPR4",124,0)
 .Q:$E($G(PSOCLASS),1,2)="XA"
"RTN","PSODDPR4",125,0)
 .S RDIRX=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,4,0))
"RTN","PSODDPR4",126,0)
 .S RDIQTY=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,6,0))
"RTN","PSODDPR4",127,0)
 .S RDIDAYS=$P(RDIQTY,";",2),RDIQTY=$P(RDIQTY,";")
"RTN","PSODDPR4",128,0)
 .I $E(RDIDAYS)="D" S RDIDAYS=$P(RDIDAYS,"D",2)
"RTN","PSODDPR4",129,0)
 .S RDIEXP=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,7,0))
"RTN","PSODDPR4",130,0)
 .S RDIISS=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,8,0))
"RTN","PSODDPR4",131,0)
 .I RDIEXP?."/" S BADEXP=1 D  I BADEXP Q
"RTN","PSODDPR4",132,0)
 ..I RDIISS?."/" Q
"RTN","PSODDPR4",133,0)
 ..S PSOPRE=$E(DT) I $P(RDIISS,"/",3)>($E(DT,2,3)+1) S PSOPRE=PSOPRE-1
"RTN","PSODDPR4",134,0)
 ..S NEWISS=PSOPRE_$P(RDIISS,"/",3)_$P(RDIISS,"/")_$P(RDIISS,"/",2) I NEWISS>(DT-10000) S RDIEXP=RDIISS,BADEXP=0
"RTN","PSODDPR4",135,0)
 .I RDISTA["EXPIRE" S PSO30=0 D  I PSO30 Q
"RTN","PSODDPR4",136,0)
 ..S PSOPRE=$E(DT) I $P(RDIEXP,"/",3)>($E(DT,2,3)+1) S PSO30=1 Q
"RTN","PSODDPR4",137,0)
 ..S NEWEXP=PSOPRE_$P(RDIEXP,"/",3)_$P(RDIEXP,"/")_$P(RDIEXP,"/",2)
"RTN","PSODDPR4",138,0)
 ..S X1=NEWEXP,X2=30 D C^%DTC I X<DT S PSO30=1
"RTN","PSODDPR4",139,0)
 .I RDIRX'="" S LOCAL=0 D CHKLOCAL I LOCAL Q
"RTN","PSODDPR4",140,0)
 .S RDIFILL=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,9,0))
"RTN","PSODDPR4",141,0)
 .I RDISTA["DISCONT" S PSO30=0 D  I PSO30 Q
"RTN","PSODDPR4",142,0)
 ..S PSOPRE=$E(DT) I $P(RDIFILL,"/",3)>($E(DT,2,3)+1) S PSO30=1 Q
"RTN","PSODDPR4",143,0)
 ..S NEWDC=PSOPRE_$P(RDIFILL,"/",3)_$P(RDIFILL,"/")_$P(RDIFILL,"/",2)
"RTN","PSODDPR4",144,0)
 ..S X1=NEWDC,X2=30+RDIDAYS D C^%DTC I X<DT S PSO30=1
"RTN","PSODDPR4",145,0)
 .I RDISTA["DRUG INTERACTION" S RDISTA="NON-VERIFIED"
"RTN","PSODDPR4",146,0)
 .S RDIREF=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,10,0))
"RTN","PSODDPR4",147,0)
 .S RDIPHYS=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,11,0))
"RTN","PSODDPR4",148,0)
 .S PSOSIG="" F  S PSOSIG=$O(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,14,PSOSIG)) Q:PSOSIG=""  S PSOSIG(PSOSIG)=^(PSOSIG)
"RTN","PSODDPR4",149,0)
 .S ^TMP($J,LIST,"OUT","REMOTE",PSORDI)=RDIINST_"^"_RDIVUID_"^"_RDIDNAM_"^"_RDISTA_"^"_RDIRX_"^"_RDIFILL_"^"_RDIDAYS_"^"_RDIQTY_"^"_RDIREF_"^"_RDIEXP_"^"_RDIPHYS_"^"_RDIISS
"RTN","PSODDPR4",150,0)
 .S PSOSIG="" F  S PSOSIG=$O(PSOSIG(PSOSIG)) Q:PSOSIG=""  S ^TMP($J,LIST,"OUT","REMOTE",PSORDI,"SIG",PSOSIG)=PSOSIG(PSOSIG)
"RTN","PSODDPR4",151,0)
 Q
"RTN","PSODDPR4",152,0)
 ;
"RTN","PSODDPR4",153,0)
CHKLOCAL ; IF SAME RX NUMBER AND ISSUE DATE - LOCAL RX
"RTN","PSODDPR4",154,0)
 N PSOISS
"RTN","PSODDPR4",155,0)
 I $D(^PSRX("B",RDIRX)) D
"RTN","PSODDPR4",156,0)
 .N PSORX
"RTN","PSODDPR4",157,0)
 .S PSORX=$O(^PSRX("B",RDIRX,"")) I 'PSORX Q
"RTN","PSODDPR4",158,0)
 .S PSOISS=$P($G(^PSRX(PSORX,0)),"^",13)
"RTN","PSODDPR4",159,0)
 .S PSOISS=$E(PSOISS,4,5)_"/"_$E(PSOISS,6,7)_"/"_$E(PSOISS,2,3)
"RTN","PSODDPR4",160,0)
 .I PSOISS=RDIISS S LOCAL=1 Q
"RTN","PSODDPR4",161,0)
 Q
"RTN","PSODDPR4",162,0)
 ;
"RTN","PSODDPR4",163,0)
FILTER ; FOR SAME DRUG VUID FOR SAME SITE, KEEP 1 ENTRY - CHECK BY ACTIVE STATUS FIRST THEN BY GREATEST EXPIRATION DATE
"RTN","PSODDPR4",164,0)
 N XX,RDI,OLDEXP,RDIEXP,RDIEXP2,OLDEXP2,PSORDI,RDISTA,OLDSTA,OLDRDI,ZZ
"RTN","PSODDPR4",165,0)
 S PSORDI=0
"RTN","PSODDPR4",166,0)
 F  S PSORDI=$O(^TMP($J,LIST,"OUT","REMOTE",PSORDI)) Q:'PSORDI  D
"RTN","PSODDPR4",167,0)
 .S XX=$G(^TMP($J,LIST,"OUT","REMOTE",PSORDI)),RDIINST=$P(XX,"^"),RDIVUID=$P(XX,"^",2),RDISTA=$P(XX,"^",4),RDIEXP=$P(XX,"^",10) Q:RDIINST=""  Q:RDIVUID=""  I RDIEXP="" Q
"RTN","PSODDPR4",168,0)
 .I $D(RDI(RDIINST,RDIVUID)) S ZZ=RDI(RDIINST,RDIVUID) D  Q
"RTN","PSODDPR4",169,0)
 ..I RDISTA="ACTIVE"!(RDISTA["SUSPEN") D  Q
"RTN","PSODDPR4",170,0)
 ...S OLDSTA=$P(ZZ,"^",2) I OLDSTA["ACTIVE"!(OLDSTA["SUSPEN") D CHKEXP Q
"RTN","PSODDPR4",171,0)
 ...S OLDRDI=$P(ZZ,"^") K ^TMP($J,LIST,"OUT","REMOTE",OLDRDI) D SETRDI
"RTN","PSODDPR4",172,0)
 ..S OLDSTA=$P(ZZ,"^",2) I OLDSTA["ACTIVE"!(OLDSTA["SUSPEN") K ^TMP($J,LIST,"OUT","REMOTE",PSORDI) Q
"RTN","PSODDPR4",173,0)
 ..D CHKEXP ; ALL OTHER STATUSES - KEEP BY GREATER EXPIRATION DATE
"RTN","PSODDPR4",174,0)
 .D SETRDI
"RTN","PSODDPR4",175,0)
 Q
"RTN","PSODDPR4",176,0)
 ;
"RTN","PSODDPR4",177,0)
CHKEXP ; 
"RTN","PSODDPR4",178,0)
 N PSOPRE
"RTN","PSODDPR4",179,0)
 S OLDEXP=$P(ZZ,"^",3) D  I OLDEXP2>RDIEXP2 K ^TMP($J,"OUT","REMOTE",PSORDI) Q
"RTN","PSODDPR4",180,0)
 .S PSOPRE=$E(DT) I $P(RDIEXP,"/",3)>($E(DT,2,3)+1) S PSOPRE=PSOPRE-1
"RTN","PSODDPR4",181,0)
 .S RDIEXP2=PSOPRE_$P(RDIEXP,"/",3)_$P(RDIEXP,"/")_$P(RDIEXP,"/",2)
"RTN","PSODDPR4",182,0)
 .S PSOPRE=$E(DT) I $P(OLDEXP,"/",3)>($E(DT,2,3)+1) S PSOPRE=PSOPRE-1
"RTN","PSODDPR4",183,0)
 .S OLDEXP2=PSOPRE_$P(OLDEXP,"/",3)_$P(OLDEXP,"/")_$P(OLDEXP,"/",2)
"RTN","PSODDPR4",184,0)
 S OLDRDI=$P(ZZ,"^") K ^TMP($J,LIST,"OUT","REMOTE",OLDRDI) D SETRDI
"RTN","PSODDPR4",185,0)
 Q
"RTN","PSODDPR4",186,0)
 ;
"RTN","PSODDPR4",187,0)
SETRDI ;
"RTN","PSODDPR4",188,0)
 S RDI(RDIINST,RDIVUID)=PSORDI_"^"_RDISTA_"^"_RDIEXP
"RTN","PSODDPR4",189,0)
 Q
"RTN","PSODDPR4",190,0)
CPRS(PSODFN,LIST,PDRG,PTY) ;
"RTN","PSODDPR4",191,0)
 ;PDRG - Drug array in format of PDRG(n)=IEN (#50) ^ Drug name
"RTN","PSODDPR4",192,0)
 ;PTY - P1;P2 where P1="I" for IP & "O" for OP (required), P2=Pharm order# (optional)
"RTN","PSODDPR4",193,0)
 I '$G(PSODFN) W !,"Patient UNDEFINED!",! Q
"RTN","PSODDPR4",194,0)
 I '$O(PDRG(0)) W !,"Dispense Drug(s) UNDEFINED!",! Q
"RTN","PSODDPR4",195,0)
 I '$D(LIST) W !,"Input Base UNDEFINED!",! Q
"RTN","PSODDPR4",196,0)
 S ^TMP($J,LIST,"IN","PING")="" D IN^PSSHRQ2(LIST) I $P(^TMP($J,LIST,"OUT",0),"^")=-1 Q
"RTN","PSODDPR4",197,0)
 K ^TMP($J,"ORDERS"),^TMP($J,"DD"),^TMP($J,LIST) N ZII,INDX,INDD,PSODUPSP,PSODUPSY,PSODUPLS,PSOFRMOR,PSOSUPNN S (INDX,INDD)=0,PSODUPSY=$G(PTY),PSODUPLS=LIST,PSOFRMOR=1
"RTN","PSODDPR4",198,0)
 ;build patient's drug profile outpat/inpat/non-va
"RTN","PSODDPR4",199,0)
 D BLD^PSOORDRG,ENCHK^PSJORUT2(PSODFN,.INDX),NVA^PSOORDRG
"RTN","PSODDPR4",200,0)
 ;dup drug check CPRS ONLY
"RTN","PSODDPR4",201,0)
 S PSOICT="",CNT=0 F ZII=0:0 S ZII=$O(PDRG(ZII)) Q:'ZII  D:$$SUP^PSSDSAPI(+$P(PDRG(ZII),"^"))
"RTN","PSODDPR4",202,0)
 .S PSOY=$P(PDRG(ZII),"^")_"^"_$P($G(^PSDRUG($P(PDRG(ZII),"^"),0)),"^"),PSOY(0)=$G(^PSDRUG(PDRG(ZII),0)),PSOSUPNN=$P(PDRG(ZII),"^",4)
"RTN","PSODDPR4",203,0)
 .S IEN=+PSOY,NAME=$P(PSOY,"^",2),DNM=0 K PSOX1,PSOY
"RTN","PSODDPR4",204,0)
 .F  S DNM=$O(^TMP($J,"ORDERS",DNM)) Q:'DNM  I NAME=$P(^TMP($J,"ORDERS",DNM),"^",3) D
"RTN","PSODDPR4",205,0)
 ..S INDD=$G(INDD)+1,^TMP($J,"DD",INDD,0)=IEN_"^"_NAME_"^"_$P(^TMP($J,"ORDERS",DNM),"^",4)_"^"_$P(^(DNM),"^",5),PSODUPSP(IEN,$S(PSOSUPNN:PSOSUPNN,1:"ACCEPT"))=PSODUPSY,PSODUPSP(IEN,"NAME")=NAME
"RTN","PSODDPR4",206,0)
 K ^TMP($J,"ORDERS")
"RTN","PSODDPR4",207,0)
 D ORD
"RTN","PSODDPR4",208,0)
 Q
"RTN","PSODDPR4",209,0)
DRG ;
"RTN","PSODDPR4",210,0)
 I $$SUP^PSSDSAPI(IEN) Q
"RTN","PSODDPR4",211,0)
 N ID,SEQN S PSODRUG("NDF")=$S($G(^PSDRUG(IEN,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSODDPR4",212,0)
 S ID=$$GETVUID^XTID(50.68,,+$P($G(PSODRUG("NDF")),"A",2)_",")
"RTN","PSODDPR4",213,0)
 S P1=$P($G(^PSDRUG(IEN,"ND")),"^"),P2=$P($G(^("ND")),"^",3),X=$$PROD0^PSNAPIS(P1,P2),SEQN=$P(X,"^",7)
"RTN","PSODDPR4",214,0)
 I '$D(PSJDGCK) S CNT=$G(CNT)+1,^TMP($J,LIST,"IN","PROSPECTIVE",$P(PTY,";")_";"_$P(PTY,";",2)_";PROSPECTIVE;"_CNT)=SEQN_"^"_+ID_"^"_IEN_"^"_NAME_$S($G(PSOFRMOR):"^"_PSOFRMNM,1:"")
"RTN","PSODDPR4",215,0)
 I $D(PSJDGCK),'$D(PSGDGCKF) S CNT=$G(CNT)+1,^TMP($J,LIST,"IN","PROSPECTIVE",$P(PTY,";")_";"_$P(PTY,";",2)_";PROSPECTIVE;"_CNT)=SEQN_"^"_+ID_"^"_IEN_"^"_NAME
"RTN","PSODDPR4",216,0)
 K ID,SEQN,P1,P2,X,DNM
"RTN","PSODDPR4",217,0)
 Q
"RTN","PSODDPR4",218,0)
 ;
"RTN","PSODDPR4",219,0)
DRGSUP ;Create "prospective" nodes for duplicate supply entries 
"RTN","PSODDPR4",220,0)
 N PSODPSID,PSODPSQN,PSODPSP1,PSODPSP2,PSODPSP3,PSODPSXX,PSODPSLP,PSODPSNF,PSODPSCT,PSODPSC1,PSODPSNM,PSODPSOR
"RTN","PSODDPR4",221,0)
 S PSODPSCT=0
"RTN","PSODDPR4",222,0)
 S PSODPSC1="" F  S PSODPSC1=$O(^TMP($J,PSODUPLS,"IN","PROSPECTIVE",PSODPSC1)) Q:PSODPSC1=""  S PSODPSP3=$P(PSODPSC1,";",4) I PSODPSP3>PSODPSCT S PSODPSCT=PSODPSP3
"RTN","PSODDPR4",223,0)
 S PSODPSLP="" F  S PSODPSLP=$O(PSODUPSP(PSODPSLP)) Q:PSODPSLP=""  D
"RTN","PSODDPR4",224,0)
 .S PSODPSOR="" F  S PSODPSOR=$O(PSODUPSP(PSODPSLP,PSODPSOR)) Q:PSODPSOR=""  D:PSODPSOR'="NAME"
"RTN","PSODDPR4",225,0)
 ..S PSODPSNM=$G(PSODUPSP(PSODPSLP,"NAME"))
"RTN","PSODDPR4",226,0)
 ..S PSODPSNF=$S($G(^PSDRUG(PSODPSLP,"ND"))]"":+^PSDRUG(PSODPSLP,"ND")_"A"_$P(^PSDRUG(PSODPSLP,"ND"),"^",3),1:0)
"RTN","PSODDPR4",227,0)
 ..S PSODPSID=$$GETVUID^XTID(50.68,,+$P($G(PSODPSNF),"A",2)_",")
"RTN","PSODDPR4",228,0)
 ..S PSODPSP1=$P($G(^PSDRUG(PSODPSLP,"ND")),"^"),PSODPSP2=$P($G(^PSDRUG(PSODPSLP,"ND")),"^",3),PSODPSXX=$$PROD0^PSNAPIS(PSODPSP1,PSODPSP2),PSODPSQN=$P(PSODPSXX,"^",7)
"RTN","PSODDPR4",229,0)
 ..S PSODPSCT=$G(PSODPSCT)+1,^TMP($J,PSODUPLS,"IN","PROSPECTIVE",$P(PSODUPSY,";")_";"_$P(PSODUPSY,";",2)_";PROSPECTIVE;"_PSODPSCT)=PSODPSQN_"^"_+PSODPSID_"^"_PSODPSLP_"^"_$G(PSODPSNM)_$S(PSODPSOR="ACCEPT":"",1:"^"_PSODPSOR)
"RTN","PSODDPR4",230,0)
 Q
"RTN","PSODDPR4",231,0)
 ;
"RTN","PSODDPR4",232,0)
RVAGEN ;va generic for remote drugs
"RTN","PSODDPR4",233,0)
 N PSOVUID,PSONDF,PSOVAG,DIC
"RTN","PSODDPR4",234,0)
 S PSOVUID=$P(^TMP($J,"PSOPEPS","OUT","REMOTE",$P(ON,";",2)),"^",2) Q:'$G(PSOVUID)
"RTN","PSODDPR4",235,0)
 K PSORDIID S PSOVAGEN="" D GETIREF^XTID("50.68",".01",PSOVUID,"PSORDIID")
"RTN","PSODDPR4",236,0)
 S PSONDF=$O(PSORDIID(50.68,.01,"")) K PSORDIID
"RTN","PSODDPR4",237,0)
 I +PSONDF D DATA^PSN50P68(+PSONDF,,"PSONDF") D
"RTN","PSODDPR4",238,0)
 .S PSOVAG=$P($G(^TMP($J,"PSONDF",+PSONDF,.05)),U,2) ;*484
"RTN","PSODDPR4",239,0)
 .N ZOT ;*484
"RTN","PSODDPR4",240,0)
 .S ZOT=$S($P(ON,";")["C":1,$P(ON,";")="O":2,$P(ON,";")="R":3,$P(ON,";")="P":4,1:5) ;*484
"RTN","PSODDPR4",241,0)
 .S ZDGDG(SV,ZOT,PSOVAG,DRG)=ON_"^"_CT,ZZDGDG3(SV,PSOVAG,DRG)="" ;*484
"RTN","PSODDPR4",242,0)
 .I '$D(NSRT(SV,PSOVAG)) S NSRT(SV,PSOVAG)=3
"RTN","PSODDPR4",243,0)
 .E  S $P(NSRT(SV,PSOVAG),"^",1)=$P(NSRT(SV,PSOVAG),"^",1)_",3"
"RTN","PSODDPR4",244,0)
 K ^TMP($J,"PSONDF")
"RTN","PSODDPR4",245,0)
 Q
"RTN","PSODDPR8")
0^9^B59640557
"RTN","PSODDPR8",1,0)
PSODDPR8 ;BIR/SAB - display enhanced order checks ;11 May 2010  9:06 AM
"RTN","PSODDPR8",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**390,372,416,500**;DEC 1997;Build 9
"RTN","PSODDPR8",3,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPR8",4,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPR8",5,0)
 ;External reference to ^PS(52.41 supported by DBIA 2844
"RTN","PSODDPR8",6,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSODDPR8",7,0)
 ;External reference to ENCHK^PSJORUT2 supported by DBIA 2376
"RTN","PSODDPR8",8,0)
 ;
"RTN","PSODDPR8",9,0)
DUP ;display drug interaction, clinical effects, and call to display monograph
"RTN","PSODDPR8",10,0)
 Q:$G(PSODLQT)
"RTN","PSODDPR8",11,0)
 S ZZDGDGC=ZZDGDGC+1,ON=$P(ZZDGDG(SV,ZST,ZORS,ZVA,DRG),"^"),CT=$P(ZZDGDG(SV,ZST,ZORS,ZVA,DRG),"^",2),SEV=$G(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT,"SEV")) K ISTX
"RTN","PSODDPR8",12,0)
 S IT=$S(SEV="Critical":1,SEV="Significant":2,1:0),PDRG=$P(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT),"^",4),DRGI=$P(^(CT),"^",2)
"RTN","PSODDPR8",13,0)
 D HD() Q:$G(PSODLQT)
"RTN","PSODDPR8",14,0)
 I $G(ZHDR) W @IOF,PSONULN,!,"***"_SEV_"*** Drug Interaction with Prospective Drug:",!?20,PDRG_" and",! S ZHDR=0
"RTN","PSODDPR8",15,0)
 E  W !
"RTN","PSODDPR8",16,0)
 I $P(ON,";")["C" D ^PSODDPR7
"RTN","PSODDPR8",17,0)
 I $P(ON,";")="N" D ^PSODDPR3 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",18,0)
 I $P(ON,";")="P" D PEND D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",19,0)
 I $P(ON,";")="O" D DDRX D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",20,0)
 I $P(ON,";")="Z" D DDRX1 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",21,0)
 I $P(ON,";")="R" D RDI^PSODDPR3 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",22,0)
 I '+$G(PSOINTV),IT=2 S PSOINTV=2_"^"_ON
"RTN","PSODDPR8",23,0)
 I IT=1 S PSOINTV=1_"^"_ON
"RTN","PSODDPR8",24,0)
 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)  I COUNT=ZZDGDG2(SV,ZVA) S COUNT=0 W ! D CL D HD():(($Y+5)'>IOSL)
"RTN","PSODDPR8",25,0)
 Q
"RTN","PSODDPR8",26,0)
 ;
"RTN","PSODDPR8",27,0)
PEND N DUPRX0,RFLS,ISSD,DNM,RXREC,Y
"RTN","PSODDPR8",28,0)
 D HD() Q:$G(PSODLQT)  S RXREC=$P(ON,";",2),DNM=$P(^PS(52.41,RXREC,0),"^",9)
"RTN","PSODDPR8",29,0)
 S DUPRX0=^PS(52.41,RXREC,0),RFLS=$P(DUPRX0,"^",11),ISSD=$P(DUPRX0,"^",6)
"RTN","PSODDPR8",30,0)
 I '$P(DUPRX0,"^",9) D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Pending Order: ",20)_$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR8",31,0)
 E  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Pending Drug: ",20)_$S($P(DUPRX0,"^",9):$P(^PSDRUG($P(DUPRX0,"^",9),0),"^"),1:"No Dispense Drug Selected")
"RTN","PSODDPR8",32,0)
 D FSIG^PSOUTLA("P",RXREC,50)
"RTN","PSODDPR8",33,0)
 S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("SIG: ",20) F I=0:0 S I=$O(FSIG(I)) Q:'I  W:'$G(PSODUPF) FSIG(I) I $O(FSIG(I)) S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("      ",20)
"RTN","PSODDPR8",34,0)
 Q
"RTN","PSODDPR8",35,0)
 ;
"RTN","PSODDPR8",36,0)
DDRX ;
"RTN","PSODDPR8",37,0)
 S RXREC=$P(ON,";",2),DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),($P(RX0,"^",15),STATUS)=+$G(^PSRX(RXREC,"STA"))
"RTN","PSODDPR8",38,0)
 S J=RXREC D STAT^PSOFUNC K RX0,RX2,LSTFD S RXRECLOC=$G(RXREC),DRGNM=$P(^PSDRUG($P(DUPRX0,"^",6),0),"^")
"RTN","PSODDPR8",39,0)
 D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Local RX#: ",20)_$P(DUPRX0,"^"),!,$J("Drug: ",20)_DRGNM_" ("_ST_")"
"RTN","PSODDPR8",40,0)
 K FSIG,BSIG I $P($G(^PSRX(RXREC,"SIG")),"^",2) D FSIG^PSOUTLA("R",RXREC,50) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSODDPR8",41,0)
 K FSIG,PSREV I '$P($G(^PSRX(RXREC,"SIG")),"^",2) D EN2^PSOUTLA1(RXREC,50)
"RTN","PSODDPR8",42,0)
 D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("SIG: ",20),$G(BSIG(1))
"RTN","PSODDPR8",43,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("     ",20)_$G(BSIG(PSREV)) D HD()
"RTN","PSODDPR8",44,0)
 K BSIG,PSREV
"RTN","PSODDPR8",45,0)
 I $G(QTHER) D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("QTY: ",20)_$P(DUPRX0,"^",7),?44,$J("Days Supply: ",20)_$P(DUPRX0,"^",8)
"RTN","PSODDPR8",46,0)
 D PRSTAT^PSODDPRE(RXREC) S LSTFD=+^PSRX(RXREC,3) S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Last Filled On: ",20)_$E(LSTFD,4,5)_"/"_$E(LSTFD,6,7)_"/"_$E(LSTFD,2,3)
"RTN","PSODDPR8",47,0)
 Q
"RTN","PSODDPR8",48,0)
 ;
"RTN","PSODDPR8",49,0)
DDRX1 ;
"RTN","PSODDPR8",50,0)
 W:SV="C" !,$J("Drug: ",21)_$S($D(PSSDIUTL):PDRG,1:DRG)
"RTN","PSODDPR8",51,0)
 W:SV="S" !,$J("Drug: ",24)_$S($D(PSSDIUTL):PDRG,1:DRG)
"RTN","PSODDPR8",52,0)
 Q
"RTN","PSODDPR8",53,0)
 ;
"RTN","PSODDPR8",54,0)
CL Q:$G(PSODLQT)  N CLI,LT,STX,I,BSIG S ZHDR=1 N CLECNT
"RTN","PSODDPR8",55,0)
 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",56,0)
 I IT=2 W !?2,"*** Refer to MONOGRAPH for SIGNIFICANT INTERACTION CLINICAL EFFECTS",!
"RTN","PSODDPR8",57,0)
 I IT=1 W ! D
"RTN","PSODDPR8",58,0)
 .S CLECNT=0 F  S CLECNT=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CLECNT)) Q:CLECNT=""  I $D(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CLECNT,"CLIN")) D
"RTN","PSODDPR8",59,0)
 ..S CLI="",CLI=$P($G(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CLECNT,"CLIN")),"CLINICAL EFFECTS: ",2)
"RTN","PSODDPR8",60,0)
 ..S LT=75,STX=CLI D FT Q:$G(PSODLQT)  F I=0:0 S I=$O(BSIG(I)) Q:'I  W ?2,BSIG(I),! D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",61,0)
 ..W !
"RTN","PSODDPR8",62,0)
 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)  I $O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT,"PMON",0)) D MON^PSODDPR3 K X,Y
"RTN","PSODDPR8",63,0)
 D HD():(($Y+5)>IOSL)
"RTN","PSODDPR8",64,0)
 Q
"RTN","PSODDPR8",65,0)
 ;
"RTN","PSODDPR8",66,0)
FT ;format text
"RTN","PSODDPR8",67,0)
 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)  K BSIG N BBSIG,BVAR,BVAR1,III,ZNT,NNN,BLIM S BBSIG=STX S (BVAR,BVAR1)="",III=1
"RTN","PSODDPR8",68,0)
 S ZNT=0 F NNN=1:1:$L(BBSIG) I $E(BBSIG,NNN)=" "!($L(BBSIG)=NNN) S ZNT=ZNT+1 D  I $L(BVAR)>LT S BSIG(III)=BLIM_" ",III=III+1,BVAR=BVAR1
"RTN","PSODDPR8",69,0)
 .S BVAR1=$P(BBSIG," ",(ZNT)),BLIM=BVAR,BVAR=$S(BVAR="":BVAR1,1:BVAR_" "_BVAR1) D HD(6):(($Y+6)>IOSL)
"RTN","PSODDPR8",70,0)
 I $G(BVAR)'="" S BSIG(III)=BVAR
"RTN","PSODDPR8",71,0)
 I $G(BSIG(1))=""!($G(BSIG(1))=" ") S BSIG(1)=$G(BSIG(2)) K BSIG(2)
"RTN","PSODDPR8",72,0)
 K LT D HD():(($Y+5)>IOSL)
"RTN","PSODDPR8",73,0)
 Q
"RTN","PSODDPR8",74,0)
 ;
"RTN","PSODDPR8",75,0)
HD(PSOLINES,OVRRID) ;
"RTN","PSODDPR8",76,0)
 S:'$G(PSODLQT) PSODLQT=0  S:'$G(OVRRID) OVRRID=0 S:'$G(PSOLINES) PSOLINES=5
"RTN","PSODDPR8",77,0)
 I '$G(OVRRID),$G(PSODLQT)!(($Y+PSOLINES)'>IOSL) Q
"RTN","PSODDPR8",78,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODDPR8",79,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press return to continue" D ^DIR K DIR
"RTN","PSODDPR8",80,0)
 K PSOLINES,OVRRID
"RTN","PSODDPR8",81,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR8",82,0)
 W:'$G(PSODUPF) @IOF
"RTN","PSODDPR8",83,0)
 Q
"RTN","PSODDPR8",84,0)
 ;
"RTN","PSODDPR8",85,0)
 ;
"RTN","PSODDPR8",86,0)
CPRS(PSODFN,PSODSULS,PSODSUOI,PSODSUTY,PSODSUAG) ;
"RTN","PSODDPR8",87,0)
 ;Duplicate supply check for CPRS
"RTN","PSODDPR8",88,0)
 ;PSODFN - Patient
"RTN","PSODDPR8",89,0)
 ;PSODSULS - Literal
"RTN","PSODDPR8",90,0)
 ;PSODSUOI - Orderable Item array in format of PSODSUOI(n)=IEN (#50.7) ^ Orderable Name name
"RTN","PSODDPR8",91,0)
 ;PSODSUTY - P1;P2 where P1 is dialogue ("I" for IV, U for Unit Dose, "O" for Outpatient, "N" for Non-VA Meds (required)), P2=Pharm order# (optional)
"RTN","PSODDPR8",92,0)
 ;PSODSUAG - If 1, indicates TMP global from CPRS^PSODDPR4 call still exists, and add to it
"RTN","PSODDPR8",93,0)
 I '$G(PSODFN) Q
"RTN","PSODDPR8",94,0)
 I '$O(PSODSUOI(0)) Q
"RTN","PSODDPR8",95,0)
 I '$D(PSODSULS) Q
"RTN","PSODDPR8",96,0)
 N INDX,PSODSUDL,PSODSUPK,PSODSURG,PSODSUA1,PSODSUA2,PSODSUNM,PSODSUAP,PSODSUIN,PSODSUII,PSODSUNN,PSODSUDM,PSODSUDC,PSODSUST,PSODSUCC,PSODSULP,PSODSUBB,PSODSUB4,PSODSONM,PSODSOP2
"RTN","PSODDPR8",97,0)
 S PSODSUDL=$P($G(PSODSUTY),";") I PSODSUDL'="I",PSODSUDL'="U",PSODSUDL'="O",PSODSUDL'="N" Q
"RTN","PSODDPR8",98,0)
 S PSODSUPK=$S(PSODSUDL="I":1,PSODSUDL="U":1,1:0),PSODSUCC=0
"RTN","PSODDPR8",99,0)
 S PSODSUA1="" F  S PSODSUA1=$O(PSODSUOI(PSODSUA1)) Q:PSODSUA1=""  S PSODSONM=PSODSUOI(PSODSUA1) D
"RTN","PSODDPR8",100,0)
 .S PSODSUA2="" F  S PSODSUA2=$O(^PSDRUG("ASP",PSODSUA1,PSODSUA2)) Q:PSODSUA2=""  D
"RTN","PSODDPR8",101,0)
 ..S PSODSUNM=$P($G(^PSDRUG(PSODSUA2,0)),"^") Q:PSODSUNM=""
"RTN","PSODDPR8",102,0)
 ..S PSODSUAP=$P($G(^PSDRUG(PSODSUA2,2)),"^",3)
"RTN","PSODDPR8",103,0)
 ..I PSODSUPK,PSODSUAP'["I",PSODSUAP'["U" Q
"RTN","PSODDPR8",104,0)
 ..I PSODSUDL="O",PSODSUAP'["O" Q
"RTN","PSODDPR8",105,0)
 ..I PSODSUDL="N",PSODSUAP'["X" Q
"RTN","PSODDPR8",106,0)
 ..I '$$SUP^PSSDSAPI(PSODSUA2) Q
"RTN","PSODDPR8",107,0)
 ..S PSODSUIN=$P($G(^PSDRUG(PSODSUA2,"I")),"^")
"RTN","PSODDPR8",108,0)
 ..I PSODSUIN,PSODSUIN<DT Q
"RTN","PSODDPR8",109,0)
 ..S PSODSURG(PSODSUA2)=PSODSUNM_$S($G(PSODSONM):"^"_PSODSONM,1:"")
"RTN","PSODDPR8",110,0)
 I $O(PSODSURG(""))="" Q
"RTN","PSODDPR8",111,0)
 S INDX=0 K ^TMP($J,"ORDERS") I '$G(PSODSUAG) K ^TMP($J,"DD"),^TMP($J,PSODSULS)
"RTN","PSODDPR8",112,0)
 D BLD^PSOORDRG,ENCHK^PSJORUT2(PSODFN,.INDX),NVA^PSOORDRG I '$D(^TMP($J,"ORDERS")) Q
"RTN","PSODDPR8",113,0)
 S PSODSUDC=0,PSODSUII=""
"RTN","PSODDPR8",114,0)
 I $G(PSODSUAG) D 
"RTN","PSODDPR8",115,0)
 .S PSODSULP="" F  S PSODSULP=$O(^TMP($J,"DD",PSODSULP)) Q:PSODSULP=""  S PSODSUDC=PSODSULP
"RTN","PSODDPR8",116,0)
 .S PSODSUBB="" F  S PSODSUBB=$O(^TMP($J,PSODSULS,"IN","PROSPECTIVE",PSODSUBB)) Q:PSODSUBB=""  I $G(PSODSUTY)=$P(PSODSUBB,";",1,2) S PSODSUB4=$P(PSODSUBB,";",4) I PSODSUB4>PSODSUCC S PSODSUCC=PSODSUB4
"RTN","PSODDPR8",117,0)
 F  S PSODSUII=$O(PSODSURG(PSODSUII)) Q:PSODSUII=""  D
"RTN","PSODDPR8",118,0)
 .S PSODSUNN=$P(PSODSURG(PSODSUII),"^"),PSODSOP2=$P(PSODSURG(PSODSUII),"^",2),PSODSUDM=""
"RTN","PSODDPR8",119,0)
 .F  S PSODSUDM=$O(^TMP($J,"ORDERS",PSODSUDM)) Q:PSODSUDM=""  I PSODSUNN=$P(^TMP($J,"ORDERS",PSODSUDM),"^",3) D
"RTN","PSODDPR8",120,0)
 ..S PSODSUDC=PSODSUDC+1,^TMP($J,"DD",PSODSUDC,0)=PSODSUII_"^"_PSODSUNN_"^"_$P(^TMP($J,"ORDERS",PSODSUDM),"^",4)_"^"_$P(^TMP($J,"ORDERS",PSODSUDM),"^",5) D:'$D(PSODSUST(PSODSUII)) PNODE
"RTN","PSODDPR8",121,0)
 K ^TMP($J,"ORDERS")
"RTN","PSODDPR8",122,0)
 Q
"RTN","PSODDPR8",123,0)
 ;
"RTN","PSODDPR8",124,0)
PNODE ;Set prospective node for duplicate supply check for CPRS
"RTN","PSODDPR8",125,0)
 N PSOSPRID,PSOSPRQN,PSOSPRNF,PSOSPRN1,PSOSPRN2,PSOSPRXX
"RTN","PSODDPR8",126,0)
 S PSOSPRNF=$S($G(^PSDRUG(PSODSUII,"ND"))]"":+^PSDRUG(PSODSUII,"ND")_"A"_$P(^PSDRUG(PSODSUII,"ND"),"^",3),1:0)
"RTN","PSODDPR8",127,0)
 S PSOSPRID=$$GETVUID^XTID(50.68,,+$P($G(PSOSPRNF),"A",2)_",")
"RTN","PSODDPR8",128,0)
 S PSOSPRN1=$P($G(^PSDRUG(PSODSUII,"ND")),"^"),PSOSPRN2=$P($G(^PSDRUG(PSODSUII,"ND")),"^",3),PSOSPRXX=$$PROD0^PSNAPIS(PSOSPRN1,PSOSPRN2),PSOSPRQN=$P(PSOSPRXX,"^",7)
"RTN","PSODDPR8",129,0)
 S PSODSUCC=$G(PSODSUCC)+1,^TMP($J,PSODSULS,"IN","PROSPECTIVE",$P(PSODSUTY,";")_";"_$P(PSODSUTY,";",2)_";PROSPECTIVE;"_PSODSUCC)=PSOSPRQN_"^"_+PSOSPRID_"^"_PSODSUII_"^"_$G(PSODSUNN)_$S($G(PSODSOP2):"^"_PSODSOP2,1:"")
"RTN","PSODDPR8",130,0)
 S PSODSUST(PSODSUII)=""
"RTN","PSODDPR8",131,0)
 Q
"RTN","PSODEM")
0^10^B18912575
"RTN","PSODEM",1,0)
PSODEM ;BHAM ISC/SAB - PATIENT DEMOGRAPHICS ; 02/17/93 12:29
"RTN","PSODEM",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**5,19,233,258,326,390,411,402,500**;DEC 1997;Build 9
"RTN","PSODEM",3,0)
 ;External reference to ^GMRADPT supported by DBIA 10099
"RTN","PSODEM",4,0)
 ;External reference to ^DIC(31 supported by DBIA 658
"RTN","PSODEM",5,0)
 ;External reference to $$BSA^PSSDSAPI supported by DBIA 5425
"RTN","PSODEM",6,0)
 ;
"RTN","PSODEM",7,0)
GET S DFN=DA D 6^VADPT,PID^VADPT U IO W @IOF,!,VADM(1)
"RTN","PSODEM",8,0)
 I +VAPA(9) W !?5,"(TEMP ADDRESS from "_$P(VAPA(9),"^",2)_" till "_$S($P(VAPA(10),"^",2)]"":$P(VAPA(10),"^",2),1:"(no end date)")_")"
"RTN","PSODEM",9,0)
 W !,VAPA(1),?40,"DOB:   ",$S(+VADM(3):$P(VADM(3),"^",2),1:"UNKNOWN") W:VAPA(2)]"" !,VAPA(2) W:VAPA(3)]"" !,VAPA(3)
"RTN","PSODEM",10,0)
 W !,VAPA(4),?40,"PHONE: "_VAPA(8),!,$P(VAPA(5),"^",2)_"  "_$S(VAPA(11)]"":$P(VAPA(11),"^",2),1:VAPA(6)),?40,"ELIG:  "_$P(VAEL(1),"^",2) W:+VAEL(3) !?40,"SC%:   "_$P(VAEL(3),"^",2)
"RTN","PSODEM",11,0)
 I $D(^PS(55,DFN,0)) W:$P(^(0),"^",2) !,"CANNOT USE SAFETY CAPS." I +$P(^(0),"^",4) W ?40,"DIALYSIS PATIENT."
"RTN","PSODEM",12,0)
 I $G(^PS(55,DFN,1))]"" S X=^(1) W !!?5,"Pharmacy Narrative: " F I=1:1 Q:$P(X," ",I,99)=""  W:$X+$L($P(X," ",I))+$L(" ")>IOM ! W $P(X," ",I)," "
"RTN","PSODEM",13,0)
RE S (WT,HT)="",X="GMRVUTL" X ^%ZOSF("TEST") I $T D
"RTN","PSODEM",14,0)
 .F GMRVSTR="WT","HT" S VM=GMRVSTR D EN6^GMRVUTL S @VM=X,$P(@VM,"^")=$E($P(@VM,"^"),4,5)_"/"_$E($P(@VM,"^"),6,7)_"/"_($E($P(@VM,"^"),1,3)+1700)
"RTN","PSODEM",15,0)
 .S X=$P(WT,"^",8),Y=$J(X/2.2046226,0,2),$P(WT,"^",9)=Y,X=$P(HT,"^",8),Y=$J(2.54*X,0,2),$P(HT,"^",9)=Y
"RTN","PSODEM",16,0)
 Q:$G(POERR)
"RTN","PSODEM",17,0)
 W !!,"WEIGHT(Kg): " W:+$P(WT,"^",8) $P(WT,"^",9)_" ("_$P(WT,"^")_")" W ?41,"HEIGHT(cm): " W:$P(HT,"^",8) $P(HT,"^",9)_" ("_$P(HT,"^")_")" K VM,WT,HT
"RTN","PSODEM",18,0)
 ;
"RTN","PSODEM",19,0)
 ; Display CrCl/BSA - show serum creatinine if CrCl can't be calculated
"RTN","PSODEM",20,0)
CRCL S PSOBSA=$$BSA^PSSDSAPI(DFN),PSOBSA=$P(PSOBSA,"^",3),PSOBSA=$S(PSOBSA'>0:"_______",1:$J(PSOBSA,4,2))
"RTN","PSODEM",21,0)
 S RSLT=$$CRCL^PSOORUT2(DFN)
"RTN","PSODEM",22,0)
 ; RSLT -- DATE^CRCL^Serum Creatinine -- Ex.  11/25/11^68.7^1.1
"RTN","PSODEM",23,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)<.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_" (CREAT: Not Found)"
"RTN","PSODEM",24,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"  (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSODEM",25,0)
 I ($P($G(RSLT),"^",2)>0)&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"(est.)"_" (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSODEM",26,0)
 W !,ZDSPL,?40," BSA (m2): ",PSOBSA K PSOBSA,ZDSPL,RSLT
"RTN","PSODEM",27,0)
 ;
"RTN","PSODEM",28,0)
 S PSLC=0 G MA:$P($G(^DPT(DFN,.17)),"^",2)'="I"
"RTN","PSODEM",29,0)
 I '$D(VAEL(1)) D ELIG^VADPT W !!,"ELIGIBILITY: ",$P(VAEL(1),"^",2) W:+VAEL(3) ?$X+5,"SC%: "_$P(VAEL(3),"^",2) S PSLC=PSLC+2
"RTN","PSODEM",30,0)
MA K SC W !,"DISABILITIES: " S PSLC=PSLC+2
"RTN","PSODEM",31,0)
 F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  S I1=$S($D(^DPT(DFN,.372,I,0)):^(0),1:"") D:+I1
"RTN","PSODEM",32,0)
 .S PSDIS=$S($P($G(^DIC(31,+I1,0)),"^")]""&($P($G(^(0)),"^",4)']""):$P(^(0),"^"),$P($G(^DIC(31,+I1,0)),"^",4)]"":$P(^(0),"^",4),1:""),PSCNT=$P(I1,"^",2)
"RTN","PSODEM",33,0)
 .X:($X+$L(PSDIS)+7)>(IOM-8) "W !?14 S PSLC=PSLC+1" W PSDIS,"-",PSCNT,"% (",$S($P(I1,"^",3):"SC",1:"NSC"),"), "
"RTN","PSODEM",34,0)
 .I $E(IOST)="C",$Y+4>IOSL,$D(PSTYPE) K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DTOUT W @IOF,?13
"RTN","PSODEM",35,0)
 X "N X S X=""GMRADPT"" X ^%ZOSF(""TEST"") Q" I $T D:'$D(PSOPTPST) GMRA
"RTN","PSODEM",36,0)
Q K SC,I1,VAROOT,Y,AL,I,X,Y,PSCNT,PSLC,PSDIS D:$G(PSTYPE)']"" KVA^VADPT Q
"RTN","PSODEM",37,0)
GMRA K ^TMP($J,"AL") S GMRA="0^0^111" D ^GMRADPT I GMRAL D
"RTN","PSODEM",38,0)
 .F DR=0:0 S DR=$O(GMRAL(DR)) Q:'DR  S ^TMP($J,"AL",$S('$P(GMRAL(DR),"^",5):1,1:2),$P(GMRAL(DR),"^",7),$P(GMRAL(DR),"^",2))=""
"RTN","PSODEM",39,0)
 .W !!,"ALLERGIES: " S (DR,TY)="" F I=0:0 S TY=$O(^TMP($J,"AL",1,TY)) Q:TY=""  F D=0:0 S DR=$O(^TMP($J,"AL",1,TY,DR)) Q:DR=""  W:$X+$L(DR)+$L(", ")>IOM !?11 W DR_", " D
"RTN","PSODEM",40,0)
 ..I $E(IOST)="C",$Y+4>IOSL,$D(PSTYPE) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DTOUT W @IOF,?18
"RTN","PSODEM",41,0)
 .W !!,"ADVERSE REACTIONS: " S (DR,TY)="" F I=0:0 S TY=$O(^TMP($J,"AL",2,TY)) Q:TY=""  F D=0:0 S DR=$O(^TMP($J,"AL",2,TY,DR)) Q:DR=""  W:$X+$L(DR)+$L(", ")>IOM !?19 W DR_", " D
"RTN","PSODEM",42,0)
 ..I $E(IOST)="C",$Y+4>IOSL,$D(PSTYPE) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DTOUT W @IOF,?18
"RTN","PSODEM",43,0)
 I $G(GMRAL)']"" F AD="ALLERGIES:","ADVERSE REACTIONS:" W !!,AD I $G(PSOFROM)="" F ADL=1:1:IOM-($L(AD)+5) W "_"
"RTN","PSODEM",44,0)
 I GMRAL=0 W !!,"ALLERGIES: NKA",!!,"ADVERSE REACTIONS:"
"RTN","PSODEM",45,0)
 W ! K TY,D,I,GMRA,GMRAL,DR,AD,ADL,^TMP($J,"AL") Q
"RTN","PSODGAL")
1^5
"RTN","PSODGAL1")
0^6^B111659050
"RTN","PSODGAL1",1,0)
PSODGAL1 ;BIR/LC,SAB - enhanced DRUG ALLERGY REACTION CHECKING ;12/09/07  02:22
"RTN","PSODGAL1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,401,390,424,429,411,500**;DEC 1997;Build 9
"RTN","PSODGAL1",3,0)
 ;External reference to $$ORCHK2^GMRAOR supported by DBIA 2378
"RTN","PSODGAL1",4,0)
 ;External reference to ^PS(50.605 supported by DBIA 696
"RTN","PSODGAL1",5,0)
 ;External reference to ^XUSEC("PSORPH" supported by DBIA 10076
"RTN","PSODGAL1",6,0)
 ;External reference to GETOC4^OROCAPI1 supported by DBIA 5729
"RTN","PSODGAL1",7,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSODGAL1",8,0)
 ;External reference to ^PS(53.1 supported by DBIA 5793
"RTN","PSODGAL1",9,0)
 ;External reference to ^PSJRXI supported by DBIA 6076
"RTN","PSODGAL1",10,0)
 ;External reference to SIG^XUSESIG supported by DBIA 10050
"RTN","PSODGAL1",11,0)
 ;External reference to $$FINDC^PSJDGAL2 supportedby DBIA 6140
"RTN","PSODGAL1",12,0)
 ;
"RTN","PSODGAL1",13,0)
EN ; Called from both inpatient and outpatient pharmacy
"RTN","PSODGAL1",14,0)
 N PSOACK,DFN,PSODAL,RXN,LPTR,PSOSEVT,PSOSEVT1,NDF,PSOSYMS,PSOINGRE,PSOSORT,PSOGIEN,PSODGCL,PSODGCL1,I,II,PSOADA,PSOADAT,PSOASEV,PSOASITE,PSODRCL1,PSODRCL
"RTN","PSODGAL1",15,0)
 N PSOINGR,PSOGMRA,PSOGMRA2,PSOIADAT,PSOLCLAS,PSOLOC,PSOOINGR,PSOSEV,PSOSNAM,PTR,TYP,ZPOP,ZPOP2,ZSITE,ZZSITE,PSOCAGNT,PSORXORD
"RTN","PSODGAL1",16,0)
 K ^TMP($J,"PSODRCLS"),DSPLQ,PSOMDC,ZGMRA,GMRAING,GMRADRCL,GMRAREAC,PSOALGYF,PSOASORT,GMRARSLT
"RTN","PSODGAL1",17,0)
 S DFN=PSODFN
"RTN","PSODGAL1",18,0)
 S (NDF,TYP,PTR,PSOALGYF)=""
"RTN","PSODGAL1",19,0)
 I $D(PSODRUG("NDF")),PSODRUG("NDF")'=0 S NDF=$P(PSODRUG("NDF"),"A"),TYP=$P(PSODRUG("NDF"),"A",2),PTR=$S(NDF=0:"",1:NDF)_"."_TYP
"RTN","PSODGAL1",20,0)
 S $P(PTR,".",3)=PSODRUG("IEN")
"RTN","PSODGAL1",21,0)
 ;
"RTN","PSODGAL1",22,0)
CHK ;matched to ndf
"RTN","PSODGAL1",23,0)
 S:'$G(PSJALGCT) PSJALGCT=1  ;counter for inpatient; OP will always be 1
"RTN","PSODGAL1",24,0)
 K ZMED,ZMEDLCL S PSOACK=$$ORCHK2^GMRAOR(DFN,"DR",PTR,"","GMRARSLT") D:+$G(PSOACK)>0
"RTN","PSODGAL1",25,0)
 .D DSPLY Q:$G(PSORX("DFLG"))!($G(PSGORQF))
"RTN","PSODGAL1",26,0)
 .Q:$D(^XUSEC("PSORPH",DUZ))!($G(PSODGCK))
"RTN","PSODGAL1",27,0)
 .I +$G(PSOACK)=1 D
"RTN","PSODGAL1",28,0)
 ..N ZMSG,ZLOCAL,ZINGREDS,ZI,ZINGRED
"RTN","PSODGAL1",29,0)
 ..S ^TMP("PSODAI",$J,0)=1,(PSOSEV,PSOLOC,PSODRG)=""
"RTN","PSODGAL1",30,0)
 ..S ZMSG="" F  S ZMSG=$O(GMRARSLT(ZMSG)) Q:'ZMSG  D 
"RTN","PSODGAL1",31,0)
 ...S PSOGIEN=$$GMSGPTR(ZMSG)
"RTN","PSODGAL1",32,0)
 ...Q:PSOGIEN=""
"RTN","PSODGAL1",33,0)
 ...S ZLOCAL=$S($P(GMRARSLT(ZMSG,PSOGIEN),U,2)="L":" (local)",1:" (remote)")
"RTN","PSODGAL1",34,0)
 ...S ZINGREDS=$G(GMRARSLT(ZMSG,"MESSAGE","OFFENDERS","ING"))
"RTN","PSODGAL1",35,0)
 ...Q:ZINGREDS=""
"RTN","PSODGAL1",36,0)
 ...S:$E(ZINGREDS,1)="~" ZINGREDS=$E(ZINGREDS,2,9999)
"RTN","PSODGAL1",37,0)
 ...F ZI=1:1:$L(ZINGREDS,"~") S ZINGRED=$P(ZINGREDS,"~",ZI) Q:ZINGRED=""  D
"RTN","PSODGAL1",38,0)
 ....S ^TMP("PSODAI",$J,ZI,0)=ZINGRED_ZLOCAL
"RTN","PSODGAL1",39,0)
 ....Q
"RTN","PSODGAL1",40,0)
 Q:$G(PSORX("DFLG"))!($G(PSGORQF))
"RTN","PSODGAL1",41,0)
 S NDF=$P(PSODRUG("NDF"),"A")
"RTN","PSODGAL1",42,0)
 I +$G(PSOACK)>0!$G(^TMP($J,"PSODRCLS",0)) D
"RTN","PSODGAL1",43,0)
 .I '$D(^XUSEC("PSORPH",DUZ)),'$D(PSOMDC) K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR,DUOUT,DIRUT Q
"RTN","PSODGAL1",44,0)
 .I $D(PSJDGCK)!$D(PSODGCK) K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR,DUOUT,DIRUT W @IOF Q
"RTN","PSODGAL1",45,0)
 .S DIR("?",1)="Answer 'YES' if you DO want to enter a intervention for this medication,",DIR("?")="       'NO' if you DON'T want to enter a intervention for this medication,"
"RTN","PSODGAL1",46,0)
 .S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Intervene? ",DIR("B")="YES" D ^DIR I '$G(PSJAOC) W !
"RTN","PSODGAL1",47,0)
 .I ($D(DTOUT))!($D(DUOUT)) S:'$G(PSJAOC) (PSODLQT,PSORX("DFLG"))=1 S:$G(PSJAOC) PSGORQF=1 Q
"RTN","PSODGAL1",48,0)
 .I 'Y D:$G(PSOSEVT1("S"))=1  Q
"RTN","PSODGAL1",49,0)
 ..S:$G(PSJAOC) PSGORQF=1
"RTN","PSODGAL1",50,0)
 ..S:'$G(PSJAOC) (PSORX("DFLG"),PSOQUIT)=1
"RTN","PSODGAL1",51,0)
 ..W !!,"With a SEVERE reaction, an intervention is required!",! S VALMBCK="R"
"RTN","PSODGAL1",52,0)
 ..I $G(PSGCOPY)=1!($G(PSIVCOPY)=1) W !,"Order not copied!",! S PSJCOFLG=1  ;set flag if COPY  to not repeat this message in PSGOD
"RTN","PSODGAL1",53,0)
 ..I $G(PSJREN)=1 W !,"No changes made to this order!",! S PSJRNFLG=1       ;set flag if RENEW to not repeat this message in PSGOEE
"RTN","PSODGAL1",54,0)
 ..I '$G(PSOSPRNW) K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR
"RTN","PSODGAL1",55,0)
 ..S:$G(PSOSPRNW) PSORENW("DFLG")=1,PSORX("DFLG")=0,PSOQUIT=1
"RTN","PSODGAL1",56,0)
 ..I $D(DTOUT)!($D(DUOUT)) D  K DIR,DUOUT,DIRUT W !
"RTN","PSODGAL1",57,0)
 ...I $G(PSJAOC) S PSGORQF=1 Q  ;inpatient
"RTN","PSODGAL1",58,0)
 ...S (PSODLQT,PSOQUIT,PSORX("DFLG"))=1
"RTN","PSODGAL1",59,0)
 .D CRI:$G(PSOSEVT1("S"))=1
"RTN","PSODGAL1",60,0)
 .Q:$G(PSORX("DFLG"))!($G(PSGORQF))
"RTN","PSODGAL1",61,0)
 .I $G(PSJAOC) S PSJDAL=1 D ^PSJRXI I $G(PSJDAL("DA")) S $P(^TMP("PSODAOC",$J,"ALLERGY",PSJALGCT,"INTERVENTION"),"^")=PSJDAL("DA") K PSJDAL("DA")
"RTN","PSODGAL1",62,0)
 .I '$G(PSJAOC) S PSODAL=1 D ^PSORXI I $G(PSODAL("DA")) S $P(^TMP("PSODAOC",$J,"ALLERGY",PSJALGCT,"INTERVENTION"),"^")=PSODAL("DA") K PSODAL("DA")
"RTN","PSODGAL1",63,0)
 .K PSJRXI("DA"),PSODAL("DA")
"RTN","PSODGAL1",64,0)
EX K DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y,DSPLQ,PSOMDC,AGNL,SEV,SEV,ZGMRA,LPTR,ALTOT
"RTN","PSODGAL1",65,0)
 K PSOACK,GMRAING,GMRADRCL,GMRAREAC,GMRARSLT,I,APTR,GMRA,LP,^TMP($J,"PSODRCLS"),ZCLA,ZCNT,ZINSTL,ZSAT
"RTN","PSODGAL1",66,0)
 I $D(PSJDGCK)!$D(PSODGCK)!$G(PSORX("DFLG"))!$G(PSGORQF) K ^TMP("PSODAOC",$J)
"RTN","PSODGAL1",67,0)
 I '$G(PSJAOC) K PSGORQF
"RTN","PSODGAL1",68,0)
 Q
"RTN","PSODGAL1",69,0)
 ;
"RTN","PSODGAL1",70,0)
DSPLY ;
"RTN","PSODGAL1",71,0)
 K PSOSYMS,PSOCAGNT
"RTN","PSODGAL1",72,0)
 D SORTN^PSODGAL3,FULL^VALM1
"RTN","PSODGAL1",73,0)
 K AGNL,SEV,SEVN,PSOHIS N INGLOC,ZINGLOC,ZMEDL,DACNT,DACNT2,ZSTA,ZDATE
"RTN","PSODGAL1",74,0)
 N ZZING,ZZLOC,ZZALL,PSOACNT,PSOLOCAL,PSOPTR,PSOSITT,PSOCA,ZLOC,PSOATYPE S (ALTOT,DACNT,DACNT2,ZLOC,ZCLA,PSOACNT,PSOATYPE)=0,ZMEDL=""
"RTN","PSODGAL1",75,0)
 S (ZZLOC,PSOCA,ZZALL,ZZING,PSOSEV,PSOINGR,PSOASITE,PSOIADAT,PSOGIEN,PSOADA)=""
"RTN","PSODGAL1",76,0)
 F  S PSOSEV=$O(PSOCAGNT(PSOSEV)) Q:PSOSEV=""  F  S PSOCA=$O(PSOCAGNT(PSOSEV,PSOCA)) Q:PSOCA=""  F  S PSOATYPE=$O(PSOCAGNT(PSOSEV,PSOCA,PSOATYPE)) Q:PSOATYPE=""  S ALTOT=ALTOT+1
"RTN","PSODGAL1",77,0)
 F  S PSOSEV=$O(PSOCAGNT(PSOSEV)) Q:PSOSEV=""!($G(PSORX("DFLG")))!($G(PSGORQF))  F  S PSOCA=$O(PSOCAGNT(PSOSEV,PSOCA)) Q:PSOCA=""!($G(PSORX("DFLG")))!($G(PSGORQF))  D
"RTN","PSODGAL1",78,0)
 .F  S PSOATYPE=$O(PSOCAGNT(PSOSEV,PSOCA,PSOATYPE)) Q:PSOATYPE=""!($G(PSORX("DFLG")))!($G(PSGORQF))  D
"RTN","PSODGAL1",79,0)
 ..S PSOGMRA2=""
"RTN","PSODGAL1",80,0)
 ..S PSOGMRA2=PSOCAGNT(PSOSEV,PSOCA,PSOATYPE)
"RTN","PSODGAL1",81,0)
 ..S (PSOPTR,ZZALL,PSODRCL)=""
"RTN","PSODGAL1",82,0)
 ..S PSOPTR=$P($P(PSOGMRA2,"^",1),"|")
"RTN","PSODGAL1",83,0)
 ..S PSOSITT=$P($P(PSOGMRA2,"^",1),"|",4)
"RTN","PSODGAL1",84,0)
 ..S ZZALL=$$GMSGPTR(PSOPTR)
"RTN","PSODGAL1",85,0)
 ..Q:ZZALL=""
"RTN","PSODGAL1",86,0)
 ..D DSPLY1
"RTN","PSODGAL1",87,0)
 Q
"RTN","PSODGAL1",88,0)
DSPLY1 ;
"RTN","PSODGAL1",89,0)
 ;                        1          2       3             4                          5         6          7               8                        9          10 
"RTN","PSODGAL1",90,0)
 N ZINDATE,ZSIGN,PSOINSTL,PSOSTA,PSOHIS,PSOSTYP,PSOMEDL,PSOLOCAL,PSODATA,PSOWCA,PSOCAR,PSOSTYPI,PSOLOCI,PSOMEDLI,PSOHISI,PSOSEVI,DRCLIEN,DRCLIENE,PSODCLAS,ZALL,ZMSG
"RTN","PSODGAL1",91,0)
 S PSOHISI=$P(GMRARSLT(PSOPTR,ZZALL),U,8)
"RTN","PSODGAL1",92,0)
 S PSOHIS=$S(PSOHISI="o":"OBSERVED",1:"HISTORICAL")
"RTN","PSODGAL1",93,0)
 S PSOASEV=$$GETSEV^PSODGAL3(PSOSITT,PSOPTR,.GMRARSLT)
"RTN","PSODGAL1",94,0)
 S PSOSEVT=PSOSEV
"RTN","PSODGAL1",95,0)
 S DACNT=DACNT+1
"RTN","PSODGAL1",96,0)
 S DACNT2=DACNT2+1
"RTN","PSODGAL1",97,0)
 S:PSOSEV=1 PSOSEVT1("S")=1
"RTN","PSODGAL1",98,0)
 W $C(7),!!,"A Drug-Allergy Reaction exists for this medication and/or class!",!
"RTN","PSODGAL1",99,0)
 W !,$S($G(PSODGCKF)!($G(PSJDGFLG)):"        Profile Drug: ",1:"    Prospective Drug: ")
"RTN","PSODGAL1",100,0)
 ;
"RTN","PSODGAL1",101,0)
 S PSORXORD=""
"RTN","PSODGAL1",102,0)
 N PSJCPROS,PSJNCOM,PROSPECT S (PSJCPROS,PSJNCOM,PROPSECT)=""
"RTN","PSODGAL1",103,0)
 I $G(PSJAOC) D
"RTN","PSODGAL1",104,0)
 .S PSORXORD=$S($G(PSJORD):PSJORD,$G(ON55):ON55,$G(ON):ON,$G(PSJNORD):PSJNORD,1:"")
"RTN","PSODGAL1",105,0)
 .I '$G(PSORXORD) S PSORXORD=$G(PSGORD)
"RTN","PSODGAL1",106,0)
 .;for complex UD orders display format:  orderable item doseform (units) ex: MORPHINE TAB,SA (100MG)
"RTN","PSODGAL1",107,0)
 .I $G(PSJCOM) S PSJNCOM=$$FINDC^PSJDGAL2($G(PSORXORD)),PSJCPROS=$P(PSJNCOM,"^",2)
"RTN","PSODGAL1",108,0)
 .I '$G(PSJDGCK)&('$G(PSODGCK)) W $S($G(PSORXORD)["V":PSODRUG("OIN"),$G(PSORXORD)["P"&($D(^PS(53.1,+$G(PSORXORD),"AD"))):PSODRUG("OIN"),$G(PSJCOM):PSJCPROS,1:PSODRUG("NAME"))
"RTN","PSODGAL1",109,0)
 .I $G(PSJDGCK)!($G(PSODGCK)) W PSODRUG("NAME")
"RTN","PSODGAL1",110,0)
 E  W PSODRUG("NAME")
"RTN","PSODGAL1",111,0)
 ;
"RTN","PSODGAL1",112,0)
 W !,"     Causative Agent: "
"RTN","PSODGAL1",113,0)
 S (PSOWCA,PSOCAR)="",PSOALGYF=1
"RTN","PSODGAL1",114,0)
 I PSOCA["/" D  S PSOCAR=$E(PSOCAR,3,$L(PSOCAR))
"RTN","PSODGAL1",115,0)
 . F I=1:1 S PSOWCA=$P(PSOCA,"/",I) Q:PSOWCA=""  S PSOCAR=PSOCAR_"/ "_PSOWCA
"RTN","PSODGAL1",116,0)
 I PSOCAR="" S PSOCAR=PSOCA
"RTN","PSODGAL1",117,0)
 ;
"RTN","PSODGAL1",118,0)
 K ^UTILITY($J,"W"),X S DIWL=1,DIWR=55,(X,DIWF)=""
"RTN","PSODGAL1",119,0)
 N CAUSAGNT S (X,PSODCLAS,CAUSAGNT,ZSITE)="",CAUSAGNT=PSOCAGNT(PSOSEV,PSOCA,PSOATYPE)
"RTN","PSODGAL1",120,0)
 ;
"RTN","PSODGAL1",121,0)
SITE ;
"RTN","PSODGAL1",122,0)
 S X=""
"RTN","PSODGAL1",123,0)
 F II=1:1 S ZSITE=$P(CAUSAGNT,"^",II)  Q:ZSITE=""  D
"RTN","PSODGAL1",124,0)
 .S (ZDATE,PSOSNAM,ZZSITE,PSOLOCAL)=""
"RTN","PSODGAL1",125,0)
 .S ZZSITE=$P(ZSITE,"|",4),ZDATE=$P(ZSITE,"|",2),PSOLOCAL=$P(ZSITE,"|",3),ZMSG=$P(ZSITE,"|")
"RTN","PSODGAL1",126,0)
 .S PSOSNAM=$P(GMRARSLT(ZMSG,"MESSAGE",1,ZZSITE),U)
"RTN","PSODGAL1",127,0)
 .;;S PSOSNAM=$$GET1^DIQ(4,ZZSITE,.01)
"RTN","PSODGAL1",128,0)
 .S X=X_", "_PSOSNAM_" - "_$P(ZDATE,"@")
"RTN","PSODGAL1",129,0)
 S X=$S(X'="":PSOCAR_" ("_$E(X,3,9999)_")",1:PSOCAR)
"RTN","PSODGAL1",130,0)
 D ^DIWP,UTIL
"RTN","PSODGAL1",131,0)
 ;
"RTN","PSODGAL1",132,0)
 W " Historical/Observed: "_$P(PSOHIS,";")
"RTN","PSODGAL1",133,0)
 W !,"            Severity: "_$S(PSOASEV="":"Not Entered",1:PSOASEV)
"RTN","PSODGAL1",134,0)
 S (PSOOINGR,ZPOP)="" N Z,ZI,ZX,ZOV,PSOWINGR,PSOWIN,REMSITE,REMTMP
"RTN","PSODGAL1",135,0)
 S DIWL=1,DIWR=55,(X,DIWF)=""
"RTN","PSODGAL1",136,0)
 F  S PSOINGR=$O(PSOCAGNT(PSOSEV,PSOCA,PSOATYPE,PSOINGR)) Q:PSOINGR=""!(PSOINGR="ZZZSYMPTOMS")  D
"RTN","PSODGAL1",137,0)
 .I '$G(ZPOP) S ZPOP=1 W !?7,"  Ingredients: "
"RTN","PSODGAL1",138,0)
 .S X=X_", "_PSOINGR
"RTN","PSODGAL1",139,0)
 D ^DIWP,UTIL
"RTN","PSODGAL1",140,0)
 K ^UTILITY($J,"W"),DIWL,DIWR,DIWF,I,ZX,X,^TMP("PSN",$J),PSNDA,PSNID
"RTN","PSODGAL1",141,0)
 I $P(GMRARSLT(PSOPTR,"MESSAGE",2),U)]"" D SYM1 S ZSIGN=1
"RTN","PSODGAL1",142,0)
 I '$G(ZSIGN) W ?3,"   Signs/Symptoms: None Entered",!
"RTN","PSODGAL1",143,0)
 S PSOLOCAL="",PSOLOCAL=$P($P(ZZALL,"^",3),"|",2)
"RTN","PSODGAL1",144,0)
 ;
"RTN","PSODGAL1",145,0)
DRCL ;PSODRCL1(99,"AMPICILLIN/SULBACTAM","PENICILLINS,AMINO DERIVATIVES")=1
"RTN","PSODGAL1",146,0)
 I $D(PSODRCL1(PSOSEV,PSOCA,PSOATYPE)) D
"RTN","PSODGAL1",147,0)
 .W ?8,"  Drug Class: "
"RTN","PSODGAL1",148,0)
 .N III,XX,X K ^UTILITY($J,"W") S DIWL=1,DIWR=55,(X,XX,DIWF)=""
"RTN","PSODGAL1",149,0)
 .F  S XX=$O(PSODRCL1(PSOSEV,PSOCA,PSOATYPE,XX)) Q:XX=""  D
"RTN","PSODGAL1",150,0)
 ..S DRCLIEN=PSODRCL1(PSOSEV,PSOCA,PSOATYPE,XX),DRCLIENE=$$GET1^DIQ(50.605,DRCLIEN,.01,"E")
"RTN","PSODGAL1",151,0)
 ..S X=X_", "_$S(DRCLIENE'="":DRCLIENE_" ",1:"")_XX
"RTN","PSODGAL1",152,0)
 .S X=$E(X,3,999) D ^DIWP
"RTN","PSODGAL1",153,0)
 .D UTIL
"RTN","PSODGAL1",154,0)
 D OVRD   ;Override Reason
"RTN","PSODGAL1",155,0)
 S PSOACNT=PSOACNT+1
"RTN","PSODGAL1",156,0)
 I ALTOT>PSOACNT K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR
"RTN","PSODGAL1",157,0)
 I $D(DTOUT)!($D(DUOUT)) S:$G(PSJAOC) PSGORQF=1 S:'$G(PSJAOC) (PSODLQT,PSORX("DFLG"))=1 K DIR,DUOUT,DIRUT W @IOF
"RTN","PSODGAL1",158,0)
 Q
"RTN","PSODGAL1",159,0)
 ;
"RTN","PSODGAL1",160,0)
OVRD ;  Override Reason
"RTN","PSODGAL1",161,0)
 N Z,ZI,ZX,ZOV,ZORN,X,PSOPRET,PSOOVRDR K ^UTILITY($J,"W") S DIWL=1,DIWR=50,(ZOV,ZORN,DIWF)=""
"RTN","PSODGAL1",162,0)
 I '+$G(PSJORD) D  G OVRDX
"RTN","PSODGAL1",163,0)
 .I $G(PSOFOERR) D  Q
"RTN","PSODGAL1",164,0)
 ..S PSOOVRDR=+$P($G(^PS(52.41,ORD,0)),"^") S:PSOOVRDR ZORN=PSOOVRDR
"RTN","PSODGAL1",165,0)
 .I $G(PSOREINS) D  Q
"RTN","PSODGAL1",166,0)
 ..I $G(ZRXN) S ZORN=$P(^PSRX(ZRXN,"OR1"),"^",2)
"RTN","PSODGAL1",167,0)
 .I $G(PSOVER1),$G(PSONV) S PSOOVRDR=+$P($G(^PSRX(PSONV,"OR1")),"^",2) S:PSOOVRDR ZORN=PSOOVRDR
"RTN","PSODGAL1",168,0)
 ;
"RTN","PSODGAL1",169,0)
 I '$G(PSJINFIN) G OVRDX
"RTN","PSODGAL1",170,0)
 I PSJORD["P" S ZORN=+$P($G(^PS(53.1,+PSJORD,0)),U,21) G OVRDX
"RTN","PSODGAL1",171,0)
 I PSJORD["U" S ZORN=+$P($G(^PS(55,DFN,5,+PSJORD,0)),U,21) G OVRDX
"RTN","PSODGAL1",172,0)
 I PSJORD["V" S ZORN=+$P($G(^PS(55,DFN,"IV",+PSJORD,0)),U,21)
"RTN","PSODGAL1",173,0)
OVRDX ;
"RTN","PSODGAL1",174,0)
 G:'$G(ZORN) NF
"RTN","PSODGAL1",175,0)
 D GETOC4^OROCAPI1(ZORN,.PSOPRET)
"RTN","PSODGAL1",176,0)
 F ZI=0:0 S ZI=$O(PSOPRET(ZORN,"DATA",ZI)) Q:'ZI  I $P($P(PSOPRET(ZORN,"DATA",ZI,1),"^"),";",2)=3,$G(PSOPRET(ZORN,"DATA",ZI,"OR",1,0))]"" S ZOV=$G(PSOPRET(ZORN,"DATA",ZI,"OR",1,0))
"RTN","PSODGAL1",177,0)
 S ^TMP("PSODAOC",$J,"ALLERGY","PROVR")=ZOV
"RTN","PSODGAL1",178,0)
NF ;
"RTN","PSODGAL1",179,0)
 I '$G(PSODGCK)&('$G(PSJDGCK)) D
"RTN","PSODGAL1",180,0)
 .W !?3,"Provider Override Reason: " S X=$S($G(ZOV)]"":ZOV,1:"N/A - Order Check Not Evaluated by Provider") D ^DIWP
"RTN","PSODGAL1",181,0)
 .F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W ?29,^UTILITY($J,"W",1,ZX,0),!
"RTN","PSODGAL1",182,0)
 .K ^UTILITY($J,"W"),DIWL,DIWR,DIWF,ZORN,RET
"RTN","PSODGAL1",183,0)
 ; pso*7*401
"RTN","PSODGAL1",184,0)
 I $D(PSOMDC) D
"RTN","PSODGAL1",185,0)
 .W !,"Warning: The following drug class does not exist in the VA DRUG CLASS"
"RTN","PSODGAL1",186,0)
 .W !,"file (#50.605). Please do a manual Drug-Allergy order check and notify"
"RTN","PSODGAL1",187,0)
 .W !,"the pharmacy ADPAC for follow up.",!
"RTN","PSODGAL1",188,0)
 .S PSOMDC="" F  S PSOMDC=$O(PSOMDC(PSOMDC)) Q:PSOMDC=""  W !,"VA Drug Class: "_PSOMDC,!
"RTN","PSODGAL1",189,0)
 .W ! S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue"
"RTN","PSODGAL1",190,0)
 .D ^DIR K DIR W !
"RTN","PSODGAL1",191,0)
 Q
"RTN","PSODGAL1",192,0)
SYM1 ;format signs/symptoms
"RTN","PSODGAL1",193,0)
 N PSOSYMX,QX,ZSYM
"RTN","PSODGAL1",194,0)
 K ^UTILITY($J,"W"),X S DIWL=1,DIWR=55,DIWF=""
"RTN","PSODGAL1",195,0)
 S (ZSYM,PSOSYMX)="",QX=0
"RTN","PSODGAL1",196,0)
 F  S ZSYM=$O(PSOSYMS(PSOSEV,PSOCA,PSOATYPE,"ZZZSYMPTOMS",ZSYM)) Q:ZSYM=""  S QX=QX+1,PSOSYMX=PSOSYMX_", "_$P(ZSYM,";",1)
"RTN","PSODGAL1",197,0)
 S PSOSYMX=$E(PSOSYMX,3,999),X=PSOSYMX D ^DIWP
"RTN","PSODGAL1",198,0)
 W ?4,"  Signs/Symptoms: "
"RTN","PSODGAL1",199,0)
 N ZNODE F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  D
"RTN","PSODGAL1",200,0)
 .S ZNODE="",ZNODE=^UTILITY($J,"W",1,ZX,0)
"RTN","PSODGAL1",201,0)
 .I $E(ZNODE,1,2)=", " S ZNODE=$E(ZNODE,3,999)
"RTN","PSODGAL1",202,0)
 .W ?22,ZNODE,!
"RTN","PSODGAL1",203,0)
 K ^UTILITY($J,"W"),DIWL,DIWR,DIWF,I,ZX
"RTN","PSODGAL1",204,0)
 Q
"RTN","PSODGAL1",205,0)
 ;
"RTN","PSODGAL1",206,0)
CRI ;input electronic sig
"RTN","PSODGAL1",207,0)
 N X1 D SIG^XUSESIG I X1="" D  Q
"RTN","PSODGAL1",208,0)
 .K PSORX("INTERVENE"),DIR
"RTN","PSODGAL1",209,0)
 .I $G(PSJAOC) S PSGORQF=1
"RTN","PSODGAL1",210,0)
 .E  S PSORX("DFLG")=1,VALMBCK="R"
"RTN","PSODGAL1",211,0)
 .S:$D(PSORENW) PSORENW("DFLG")=1
"RTN","PSODGAL1",212,0)
 .W !!,"With a SEVERE reaction, an Electronic Signature is required!",!
"RTN","PSODGAL1",213,0)
 .I $G(PSGCOPY)=1!($G(PSIVCOPY)=1) W !,"Order not copied!",!
"RTN","PSODGAL1",214,0)
 .I $G(PSJREN)=1 W !,"No changes made to this order!",!
"RTN","PSODGAL1",215,0)
 .S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR W !
"RTN","PSODGAL1",216,0)
 S PSORX("INTERVENE")=1
"RTN","PSODGAL1",217,0)
 Q
"RTN","PSODGAL1",218,0)
DIR ;
"RTN","PSODGAL1",219,0)
 S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue"
"RTN","PSODGAL1",220,0)
 D ^DIR K DIR W !
"RTN","PSODGAL1",221,0)
 Q
"RTN","PSODGAL1",222,0)
 ;
"RTN","PSODGAL1",223,0)
UTIL ;
"RTN","PSODGAL1",224,0)
 N ZNODE F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  D
"RTN","PSODGAL1",225,0)
 .S ZNODE="",ZNODE=^UTILITY($J,"W",1,ZX,0)
"RTN","PSODGAL1",226,0)
 .I $E(ZNODE,1,2)=", " S ZNODE=$E(ZNODE,3,999)
"RTN","PSODGAL1",227,0)
 .W ?22,ZNODE,!
"RTN","PSODGAL1",228,0)
 K ^UTILITY($J,"W"),DIWL,DIWR,DIWF,I,ZX
"RTN","PSODGAL1",229,0)
 Q
"RTN","PSODGAL1",230,0)
 ;
"RTN","PSODGAL1",231,0)
GMSGPTR(MSG,NODE) ; retrieve second level pointer from new allergy array
"RTN","PSODGAL1",232,0)
 N RESULT
"RTN","PSODGAL1",233,0)
 S RESULT=$O(GMRARSLT(MSG,$G(NODE)))
"RTN","PSODGAL1",234,0)
 Q:+RESULT>0 RESULT
"RTN","PSODGAL1",235,0)
 S:RESULT="MESSAGE" RESULT=$O(GMRARSLT(MSG,RESULT))
"RTN","PSODGAL1",236,0)
 Q:$E(RESULT,1)="R" RESULT
"RTN","PSODGAL1",237,0)
 S RESULT=""
"RTN","PSODGAL1",238,0)
 Q RESULT
"RTN","PSODGAL1",239,0)
 ;
"RTN","PSODOSUN")
0^18^B100248418
"RTN","PSODOSUN",1,0)
PSODOSUN ;BIR/RTR - Dose Check Utility routine ;11/18/08
"RTN","PSODOSUN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,379,372,416,436,402,500**;DEC 1997;Build 9
"RTN","PSODOSUN",3,0)
 ;
"RTN","PSODOSUN",4,0)
DOSE() ;Write Dose output for renew, finish, copy, etc.
"RTN","PSODOSUN",5,0)
 N PSODLINS,PSODLINR,PSODLINX,PSODLERA,PSODLERB,PSODLERF,PSODLERZ,PSODLPL,PSODLP1,PSODLMSG,PSODLFLG,PSODLALZ,DIR,DUOUT,DTOUT,DIROUT,DIRUT,X,Y,X1,PSODLOFF
"RTN","PSODOSUN",6,0)
 N PSODLNN1,PSODLERR,PSODLERX,PSODLQT,PSOCPXG,PSOCPXRR,PSODLEXR,PSODELNX,PSODLECT,PSOCPXF,PSODTYPE,PSOCPXC,PSOLASTS,PSOQTOUT,PSOEDOUT,PSODSEQ
"RTN","PSODOSUN",7,0)
 N PSOSIGC,PSOINTRO,PSOTRAIL,PSOEXCPT,PSOERROR
"RTN","PSODOSUN",8,0)
 S (PSODLERF,PSODLERZ,PSODLALZ,PSODLINS,PSODLINR,PSODLINX,PSODLERR,PSODLQT,PSOCPXG,PSOCPXF,PSOLASTS,PSOQTOUT,PSOEDOUT,PSODLOFF,PSOINTRO,PSOTRAIL,PSOEXCPT,PSOERROR)=0,PSODTYPE="N",PSOCPXC=1
"RTN","PSODOSUN",9,0)
 I $G(PSORXED)&$G(PSOEDDOS) S PSOCPXC=0  ;don't show summary before accept of order if edit
"RTN","PSODOSUN",10,0)
 I $G(PSOCPXB)<4 S PSOCPXC=0
"RTN","PSODOSUN",11,0)
 W:$G(PSOEDIT)!$G(PSOCOPY)!($G(PSOFOERR)) @IOF I $P($G(^TMP($J,"PSOPDOSN","OUT",0)),"^")=-1 D  S PSODLFLG=0,PSODLOFF=1 G END
"RTN","PSODOSUN",12,0)
 .D HD N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF D MESG
"RTN","PSODOSUN",13,0)
 .S X="Reason(s): "_$P(^TMP($J,"PSOPDOSN","OUT",0),"^",2),DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUN",14,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUN",15,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUN",16,0)
 ;PSOCPXB = Number of Dosing Seq
"RTN","PSODOSUN",17,0)
 S PSODLQT=0 K PSOCPXRR
"RTN","PSODOSUN",18,0)
 D EN^PSODOSU2
"RTN","PSODOSUN",19,0)
END ;
"RTN","PSODOSUN",20,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",21,0)
 I '$G(PSODLALZ),'$G(PSODLFLG),'$G(PSODLERR),'$G(PSODLOFF) Q 0
"RTN","PSODOSUN",22,0)
 I '$G(PSODLFLG) W !
"RTN","PSODOSUN",23,0)
 K PSODAILY,DIR,Y,PSODOSEX
"RTN","PSODOSUN",24,0)
 D PROMPT Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 1
"RTN","PSODOSUN",25,0)
 I '$G(PSODLINS)&('$G(PSODLINR))&('$G(PSODLINX)) Q 0
"RTN","PSODOSUN",26,0)
 I $D(^XUSEC("PSORPH",DUZ)) D  I Y'=1!($D(DTOUT))!($D(DUOUT))!($G(PSRX("DFLG"))) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",27,0)
 .S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR
"RTN","PSODOSUN",28,0)
 I '$G(PSODLINS)&'$G(PSODLINR)&('$G(PSODLINX)) Q 0
"RTN","PSODOSUN",29,0)
 I '$D(^XUSEC("PSORPH",DUZ)) Q 2_"^"_$$EVAL(PSODLINS,PSODLINR,PSODLINX)
"RTN","PSODOSUN",30,0)
 W !!,"Do you want to Process or Cancel medication?" K DIR,Y S DIR("B")="P",DIR(0)="SA^1:PROCESS MEDICATION;0:CANCEL MEDICATION"
"RTN","PSODOSUN",31,0)
 S DIR("A")=$$GETGN^PSODOSUN(PSODRUG("IEN"))_": "  K ^TMP($J,"PSODOSUN GN")
"RTN","PSODOSUN",32,0)
 S DIR("?",1)="Enter '1' or 'P' to Process medication",DIR("?")="      '^' to EXIT",DIR("?",2)="      '0' or 'C' to Cancel Medication"
"RTN","PSODOSUN",33,0)
 D ^DIR K DIR
"RTN","PSODOSUN",34,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",35,0)
 ;need to know if user cancelled or not
"RTN","PSODOSUN",36,0)
 I Y=0 Q 3_"^"_$S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & MAX DAILY DOSE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"MAX DAILY DOSE",$G(PSODLINX):"MAX SINGLE DOSE & MAX DAILY DOSE",1:"UNKNOWN")
"RTN","PSODOSUN",37,0)
 K PSODOSEX
"RTN","PSODOSUN",38,0)
 S PSOSIGC=0
"RTN","PSODOSUN",39,0)
SIG1 ;
"RTN","PSODOSUN",40,0)
 D SIG^XUSESIG
"RTN","PSODOSUN",41,0)
 I 'PSOSIGC&($G(X1)="") D MSG1 S PSOSIGC=PSOSIGC+1 G SIG1
"RTN","PSODOSUN",42,0)
 I $G(X1)="" D MSG2 Q 1
"RTN","PSODOSUN",43,0)
END2 ;
"RTN","PSODOSUN",44,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",45,0)
 Q 2_"^"_$S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & MAX DAILY DOSE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"MAX DAILY DOSE",$G(PSODLINX):"MAX SINGLE DOSE & MAX DAILY DOSE",1:"UNKNOWN")
"RTN","PSODOSUN",46,0)
 ;
"RTN","PSODOSUN",47,0)
EVAL(PSODLINS,PSODLINR,PSODLINX) ;
"RTN","PSODOSUN",48,0)
 Q $S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & MAX DAILY DOSE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"MAX DAILY DOSE",$G(PSODLINX):"MAX SINGLE DOSE & MAX DAILY DOSE",1:"UNKNOWN")
"RTN","PSODOSUN",49,0)
 ;
"RTN","PSODOSUN",50,0)
DOSEX(PSODLXNT) ;Write Dose exceptions for order entry/edit
"RTN","PSODOSUN",51,0)
 N PSODLINS,PSODLINR,PSODLINX,PSODLERA,PSODLERB,PSODLERF,PSODLERZ,PSODLPL,PSODLP1,PSODLMSG,DIR,DUOUT,DTOUT,DIROUT,DIRUT,X,Y,X1
"RTN","PSODOSUN",52,0)
 N PSODLNN1,PSODLERX,PSODLQT,PSODELNX,PSODTYPE,PSODCONT,PSODSEQ,PSODOSX,PSODLOFF,PSOINTRO,PSOTRAIL,PSOEXCPT,PSOERROR
"RTN","PSODOSUN",53,0)
 W @IOF S (PSODLERF,PSODLERZ,PSODLINS,PSODLINR,PSODLINX,PSODLQT,PSODCONT,PSODLOFF,PSOINTRO,PSOTRAIL,PSOEXCPT,PSOERROR)=0,PSODTYPE="E"
"RTN","PSODOSUN",54,0)
 I $G(PSOEDDOS) Q:$G(PSORXED("CONJUNCTION",1))="" 0  ;don't show messages when simple order before accept of order during edits
"RTN","PSODOSUN",55,0)
 I PSOCPXB>3,$G(PSORXED)&$G(PSOEDDOS) S PSOCPXC=0  ;don't show summary before accept of order if edit
"RTN","PSODOSUN",56,0)
 I $P($G(^TMP($J,"PSOPDOSN","OUT",0)),"^")=-1 D  S PSODLFLG=0,PSODLOFF=1 G ENDX
"RTN","PSODOSUN",57,0)
 .D HD N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF D MESG
"RTN","PSODOSUN",58,0)
 .S X="Reason(s): "_$P(^TMP($J,"PSOPDOSN","OUT",0),"^",2),DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUN",59,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUN",60,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUN",61,0)
 D EN^PSODOSU2
"RTN","PSODOSUN",62,0)
ENDX ;
"RTN","PSODOSUN",63,0)
 S PSODOSX=1
"RTN","PSODOSUN",64,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",65,0)
 K PSOCPXRR
"RTN","PSODOSUN",66,0)
 I '$G(PSODLALZ),'$G(PSODLFLG),'$G(PSODLERR),'$G(PSODLOFF) Q 0
"RTN","PSODOSUN",67,0)
 ;
"RTN","PSODOSUN",68,0)
 ;This "return to continue" occurs after the last dosing sequence for a complex order with 4 or more dosing sequences during an edit when finishing, placing a new order, copy or edit
"RTN","PSODOSUN",69,0)
 ;
"RTN","PSODOSUN",70,0)
 I '$G(PSOCKCON)&($G(PSOFOERR)) D  I $G(PSOQTOUT) Q 0
"RTN","PSODOSUN",71,0)
 .Q:($G(PSODLFLG))&$D(^XUSEC("PSORPH",DUZ))  ;messages need the "do you want to continue" prompt instead but need to evaluate here so that it doesn't show up for edits
"RTN","PSODOSUN",72,0)
 .D RETURN
"RTN","PSODOSUN",73,0)
 Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 1
"RTN","PSODOSUN",74,0)
 ;
"RTN","PSODOSUN",75,0)
 I '$G(PSOFOERR) D  I $G(PSOQTOUT) Q 0
"RTN","PSODOSUN",76,0)
 .Q:$G(PSODLFLG)&$D(^XUSEC("PSORPH",DUZ))
"RTN","PSODOSUN",77,0)
 .I '$G(PSOEDIT) Q:$G(PSODOSNW)&'$G(PSOCPXD)&'$G(PSOCOPY)
"RTN","PSODOSUN",78,0)
 .Q:($G(PSOCOPY)!$G(PSOEDIT))&'$G(PSOCPXV)
"RTN","PSODOSUN",79,0)
 .Q:PSOCPXB>3&$G(PSOCPXV)
"RTN","PSODOSUN",80,0)
 .D RETURN
"RTN","PSODOSUN",81,0)
 Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 1
"RTN","PSODOSUN",82,0)
 ;
"RTN","PSODOSUN",83,0)
 I '$G(PSODLFLG) W !
"RTN","PSODOSUN",84,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(PSODLINS)!($G(PSODLINR))!($G(PSODLINX)),$G(PSODLFLG) Q 2_"^"_$$EVAL(PSODLINS,PSODLINR,PSODLINX)
"RTN","PSODOSUN",85,0)
 I 'PSODCONT Q:$G(PSOCPXV) 0
"RTN","PSODOSUN",86,0)
 I $G(PSODLBD4)&'$G(PSODLINS)&'$G(PSODLINR)&'$G(PSODLINX)&('$G(PSODLALZ)) S Y=1 G ENDX2
"RTN","PSODOSUN",87,0)
 K DIR,Y I $D(^XUSEC("PSORPH",DUZ)) S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",88,0)
ENDX2 ;
"RTN","PSODOSUN",89,0)
 K PSODOSEX
"RTN","PSODOSUN",90,0)
 W !
"RTN","PSODOSUN",91,0)
 Q 0
"RTN","PSODOSUN",92,0)
DOSEZ() ;Write Dose output summary for complex orders
"RTN","PSODOSUN",93,0)
 I $G(PSOEDDOS) Q:$G(PSORXED("CONJUNCTION",1))="" 0  ;don't show messages when simple order before accept of order during edits
"RTN","PSODOSUN",94,0)
 N PSOCPXF,PSOCPXC,PSOCPXRR,PSOCPXG,PSODLESM,PSODELNX,PSOCPXH,PSODTYPE,PSOLASTS,PSOLASTD,PSOQTOUT,PSOEDOUT,PSODSEQ
"RTN","PSODOSUN",95,0)
 N PSODLINS,PSODLINR,PSODLINX,PSODLERA,PSODLERB,PSODLERF,PSODLERZ,PSODLPL,PSODLP1,PSODLMSG,DIR,DUOUT,DTOUT,DIROUT,DIRUT,X,Y,X1
"RTN","PSODOSUN",96,0)
 N PSODLNN1,PSODLERX,PSODLQT,PSODLEXR,PSODLECT,PSODLOFF,PSOINTRO,PSOTRAIL,PSOEXCPT,PSOERROR
"RTN","PSODOSUN",97,0)
 I '$G(PSOTOF) W @IOF
"RTN","PSODOSUN",98,0)
 S (PSODLERF,PSODLERZ,PSODLINS,PSODLINR,PSODLINX,PSOCPXF,PSODLQT,PSOCPXH,PSOLASTS,PSOLASTD,PSOQTOUT,PSOEDOUT,PSODLOFF,PSOINTRO,PSOTRAIL,PSOEXCPT,PSOERROR)=0,PSODTYPE="C",PSOCPXC=1
"RTN","PSODOSUN",99,0)
 I $G(PSORX("EDIT"))!($G(PSORXED)&$G(PSOEDDOS))!($G(PSOCOPY)&$G(PSODLBD4)) S PSOEDOUT=1
"RTN","PSODOSUN",100,0)
 I PSOCPXB>3,$G(PSOEDOUT) S PSOCPXC=0
"RTN","PSODOSUN",101,0)
 ;I PSOCPXB>3,$G(PSOEDDOS) S PSOCPXC=0  ;don't show summary before accept of order if edit
"RTN","PSODOSUN",102,0)
 I $G(PSOCPXB)<4 S PSOCPXC=0
"RTN","PSODOSUN",103,0)
 Q:$G(PSOCPXB)<4&'$G(PSOFOERR)&('$G(PSODLFLG)) 0
"RTN","PSODOSUN",104,0)
 I $P($G(^TMP($J,"PSOPDOSN","OUT",0)),"^")=-1 S PSODLQT=1 D  S PSODLFLG=0,PSODLOFF=1 G ENDZ
"RTN","PSODOSUN",105,0)
 .D:PSOCPXC HD W:'PSODLQT&(PSOCPXC) !! N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF D MESG
"RTN","PSODOSUN",106,0)
 .S X="Reason(s): "_$P(^TMP($J,"PSOPDOSN","OUT",0),"^",2),DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUN",107,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D:PSOCPXC HD W:PSODELXF&('PSODLQT)&(PSOCPXC) ! D:PSOCPXC HD W:'PSODLQT&(PSOCPXC) "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUN",108,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUN",109,0)
 D EN^PSODOSU2
"RTN","PSODOSUN",110,0)
ENDZ ;
"RTN","PSODOSUN",111,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",112,0)
 K PSODAILY
"RTN","PSODOSUN",113,0)
 I '$G(PSODLALZ),'$G(PSODLFLG),'$G(PSODLERR),'$G(PSODLOFF) Q 0
"RTN","PSODOSUN",114,0)
 D PROMPT Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 0
"RTN","PSODOSUN",115,0)
 I '$G(PSODLINS)&('$G(PSODLINR))&('$G(PSODLINX)) Q 0
"RTN","PSODOSUN",116,0)
 I '$G(PSOCPXF)&(PSOLASTS'=PSOCPXB),PSOEDOUT Q 0
"RTN","PSODOSUN",117,0)
 K PSODOSEX
"RTN","PSODOSUN",118,0)
 I $D(^XUSEC("PSORPH",DUZ)) D  I Y'=1!($D(DTOUT))!($D(DUOUT))!($G(PSRX("DFLG"))) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",119,0)
 .K DIR,Y S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR
"RTN","PSODOSUN",120,0)
ENDZC ;
"RTN","PSODOSUN",121,0)
 I '$G(PSODLINS)&('$G(PSODLINR))&('$G(PSODLINX)) Q 0
"RTN","PSODOSUN",122,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(PSODLINS)!($G(PSODLINR))!($G(PSODLINX)) Q 2_"^"_$$EVAL(PSODLINS,PSODLINR,PSODLINX)
"RTN","PSODOSUN",123,0)
 G ENDZ2:$G(PSORX("EDIT"))!($G(PSORXED)&$G(PSOEDDOS))!($G(PSOCOPY)&$G(PSODLBD4))
"RTN","PSODOSUN",124,0)
 W !!,"Do you want to Process or Cancel medication?" K DIR,Y S DIR("B")="P",DIR(0)="SA^1:PROCESS MEDICATION;0:CANCEL MEDICATION"
"RTN","PSODOSUN",125,0)
 S DIR("A")=$$GETGN(PSODRUG("IEN"))_": "  K ^TMP($J,"PSODOSUN GN")
"RTN","PSODOSUN",126,0)
 S DIR("?",1)="Enter '1' or 'P' to Process medication",DIR("?")="      '^' to EXIT",DIR("?",2)="      '0' or 'C' to Cancel Medication"
"RTN","PSODOSUN",127,0)
 D ^DIR K DIR,PSODOSEX
"RTN","PSODOSUN",128,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",129,0)
 S PSOSIGC=0
"RTN","PSODOSUN",130,0)
SIG2 ;
"RTN","PSODOSUN",131,0)
 D SIG^XUSESIG
"RTN","PSODOSUN",132,0)
 I 'PSOSIGC&($G(X1)="") D MSG1 S PSOSIGC=PSOSIGC+1 G SIG2
"RTN","PSODOSUN",133,0)
 I $G(X1)="" D MSG2 Q 1
"RTN","PSODOSUN",134,0)
ENDZ2 ;
"RTN","PSODOSUN",135,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",136,0)
 Q 2_"^"_$S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & MAX DAILY DOSE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"MAX DAILY DOSE",$G(PSODLINX):"MAX SINGLE DOSE & MAX DAILY DOSE",1:"UNKNOWN")
"RTN","PSODOSUN",137,0)
HD ;
"RTN","PSODOSUN",138,0)
 I PSODLQT!(($Y+5)'>IOSL) Q
"RTN","PSODOSUN",139,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODOSUN",140,0)
 I $D(^XUSEC("PSORPH",DUZ)) D  I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1,PSORX("DFLG")=1 Q 1
"RTN","PSODOSUN",141,0)
 .K DIR,Y S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR
"RTN","PSODOSUN",142,0)
 W @IOF W !
"RTN","PSODOSUN",143,0)
 Q
"RTN","PSODOSUN",144,0)
MESG ;Write out System error heading
"RTN","PSODOSUN",145,0)
 I 'PSODLQT D HD W !,"Dosing Checks could not be performed.",!
"RTN","PSODOSUN",146,0)
 Q
"RTN","PSODOSUN",147,0)
GETGN(PSODRIEN) ;get generic name
"RTN","PSODOSUN",148,0)
 K ^TMP($J,"PSODOSUN GN")
"RTN","PSODOSUN",149,0)
 D DATA^PSS50(PSODRIEN,,,,,"PSODOSUN GN")
"RTN","PSODOSUN",150,0)
 Q $S($D(^TMP($J,"PSODOSUN GN",PSODRIEN,.01)):^TMP($J,"PSODOSUN GN",PSODRIEN,.01),1:"")
"RTN","PSODOSUN",151,0)
 ;
"RTN","PSODOSUN",152,0)
PROMPT ;
"RTN","PSODOSUN",153,0)
 ;assumes that a previous check was made to verify that errors, exceptions or messages are present
"RTN","PSODOSUN",154,0)
 ;if only warnings (exceptions/errors) then display "Press return to continue"; otherwise display "Do you want to continue" prompt.
"RTN","PSODOSUN",155,0)
 ;FINISH and BACKDOOR are separated below in order keep to a mininum the vast number of scenarios to be tested
"RTN","PSODOSUN",156,0)
 I $G(PSODLOFF)&(($Y+5)>IOSL) D RETURN Q
"RTN","PSODOSUN",157,0)
 I $G(PSOFOERR) D  ;FINISH
"RTN","PSODOSUN",158,0)
 .Q:$D(^XUSEC("PSORPH",DUZ))&('$G(PSORENWD))
"RTN","PSODOSUN",159,0)
 .I '$G(PSODLFLG) D
"RTN","PSODOSUN",160,0)
 ..Q:'$G(PSOEDOUT)&$D(^XUSEC("PSORPH",DUZ))&('$G(PSORENWD))  ;messages need the "do you want to continue" prompt instead but need to evaluate here so that it doesn't show up for edits
"RTN","PSODOSUN",161,0)
 ..I '$G(PSORENWD) Q:PSOCPXB<4&('$G(PSODOSX))
"RTN","PSODOSUN",162,0)
 ..D RETURN
"RTN","PSODOSUN",163,0)
 ;
"RTN","PSODOSUN",164,0)
 I '$G(PSOFOERR)&'$G(PSODLFLG) D  ;BACKDOOR
"RTN","PSODOSUN",165,0)
 .Q:'$G(PSOEDOUT)&$D(^XUSEC("PSORPH",DUZ))&('$G(PSORENWD))  ;messages need the "do you want to continue" prompt instead but need to evaluate here so that it doesn't show up for edits
"RTN","PSODOSUN",166,0)
 .I '$G(PSORENWD),('$D(^XUSEC("PSORPH",DUZ))&'$G(PSODCAN)) Q:PSOCPXB<4&('$G(PSODOSX))
"RTN","PSODOSUN",167,0)
 .D RETURN
"RTN","PSODOSUN",168,0)
 ;
"RTN","PSODOSUN",169,0)
 I $G(PSODLFLG)&'$D(^XUSEC("PSORPH",DUZ)) D
"RTN","PSODOSUN",170,0)
 .I '$G(PSORENWD),('$D(^XUSEC("PSORPH",DUZ))&'$G(PSODCAN)) Q:PSOCPXB<4&('$G(PSODOSX))
"RTN","PSODOSUN",171,0)
 .D RETURN
"RTN","PSODOSUN",172,0)
 Q
"RTN","PSODOSUN",173,0)
 ;
"RTN","PSODOSUN",174,0)
RETURN ;
"RTN","PSODOSUN",175,0)
 Q:'$D(^XUSEC("PSORPH",DUZ))&($Y<10)
"RTN","PSODOSUN",176,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue,'^' to exit" D ^DIR K DIR  S:'Y PSODLQT=1,PSOQTOUT=1,PSORX("DFLG")=1 W @IOF
"RTN","PSODOSUN",177,0)
 Q
"RTN","PSODOSUN",178,0)
 ;
"RTN","PSODOSUN",179,0)
HD3(PSOLINES,OVRRID) ;
"RTN","PSODOSUN",180,0)
 N X,Y,DTOUT,DUOUT,DIR
"RTN","PSODOSUN",181,0)
 S:'$G(PSODLQT) PSODLQT=0  S:'$G(OVRRID) OVRRID=0 S:'$G(PSOLINES) PSOLINES=5
"RTN","PSODOSUN",182,0)
 I '$G(OVRRID),$G(PSODLQT)!(($Y+PSOLINES)<IOSL) Q
"RTN","PSODOSUN",183,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y W ! K DIR,Y S DIR(0)="E",DIR("A")="Press return to continue" D ^DIR K DIR,PSOLINES,OVRRID
"RTN","PSODOSUN",184,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODOSUN",185,0)
 W @IOF
"RTN","PSODOSUN",186,0)
 Q
"RTN","PSODOSUN",187,0)
 ;
"RTN","PSODOSUN",188,0)
MSG1 ;
"RTN","PSODOSUN",189,0)
 W !!,"  *** You must enter your Current Signature Code. ***"
"RTN","PSODOSUN",190,0)
 Q
"RTN","PSODOSUN",191,0)
MSG2 ;
"RTN","PSODOSUN",192,0)
 W !!,"  *** A Signature Code must be entered to continue with this order. ***",!
"RTN","PSODOSUN",193,0)
MSG3 ;
"RTN","PSODOSUN",194,0)
 N MSGX,DIR
"RTN","PSODOSUN",195,0)
 W ! K DIR S DIR(0)="E",DIR("A")="Press <Enter> to return to the order..." D ^DIR
"RTN","PSODOSUN",196,0)
 S PSODLQT=1,PSOQTOUT=1,PSORX("DFLG")=1
"RTN","PSODOSUN",197,0)
 Q
"RTN","PSODOSUN",198,0)
 ;
"RTN","PSONVAVW")
0^11^B19324359
"RTN","PSONVAVW",1,0)
PSONVAVW ;BHM/MFR - View Non-VA Med - Listmanager ;10/20/06
"RTN","PSONVAVW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**260,500**;13 Feb 97;Build 9
"RTN","PSONVAVW",3,0)
 ;Reference to File ^PS(55 supported by DBIA 2228
"RTN","PSONVAVW",4,0)
 ;Reference to $$GET1^DIQ is supported by DBIA 2056
"RTN","PSONVAVW",5,0)
 ;Reference to DEM^VADPT is supported by DBIA 10061
"RTN","PSONVAVW",6,0)
 ;Reference to EN6^GMRVUTL is supported by DBIA 1120
"RTN","PSONVAVW",7,0)
 ;
"RTN","PSONVAVW",8,0)
EN(PSODFN,PSORD) ; - Entry point
"RTN","PSONVAVW",9,0)
 N VALMCNT,VALMHDR
"RTN","PSONVAVW",10,0)
 D EN^VALM("PSO NON-VA MEDS VIEW")
"RTN","PSONVAVW",11,0)
 Q
"RTN","PSONVAVW",12,0)
 ;
"RTN","PSONVAVW",13,0)
HDR      ; - Header
"RTN","PSONVAVW",14,0)
 N LINE1,LINE2,LINE3,WT,WTDT,HT,HTDT,VADM,DFN,PNAME,DOB,SEX,X,VADM,WT,HT,GMRVST,GMRVSTR,DOB,PNAME,SEX
"RTN","PSONVAVW",15,0)
 ;
"RTN","PSONVAVW",16,0)
 K VADM S DFN=PSODFN D DEM^VADPT
"RTN","PSONVAVW",17,0)
 S PNAME=VADM(1)
"RTN","PSONVAVW",18,0)
 S DOB=$S(+VADM(3):$P(VADM(3),"^",2)_" ("_$G(VADM(4))_")",1:"UNKNOWN")
"RTN","PSONVAVW",19,0)
 S SEX=$P(VADM(5),"^",2)
"RTN","PSONVAVW",20,0)
 S (WT,X)="",GMRVSTR="WT" D EN6^GMRVUTL I X'="" S WT=$J($P(X,"^",8)/2.2046226,6,2),WTDT=$$DT($P(X,"^")\1)
"RTN","PSONVAVW",21,0)
 S (HT,X)="",GMRVSTR="HT" D EN6^GMRVUTL I X'="" S HT=$J($P(X,"^",8)*2.54,6,2),HTDT=$$DT($P(X,"^")\1)
"RTN","PSONVAVW",22,0)
 S LINE1=PNAME S LINE1=$$ALLERGY^PSOPMP1(LINE1,DFN,"")
"RTN","PSONVAVW",23,0)
 S LINE2="  PID: "_$P(VADM(2),"^",2),$E(LINE2,50)="HEIGHT(cm): "_$S(HT'="":HT_" ("_HTDT_")",1:"NOT AVAILABLE")
"RTN","PSONVAVW",24,0)
 S LINE3="  DOB: "_DOB,$E(LINE3,30)="SEX: "_SEX,$E(LINE3,50)="WEIGHT(kg): "_$S(WT'="":WT_" ("_WTDT_")",1:"NOT AVAILABLE")
"RTN","PSONVAVW",25,0)
 ;
"RTN","PSONVAVW",26,0)
 K VALMHDR S VALMHDR(1)=LINE1,VALMHDR(2)=LINE2,VALMHDR(3)=LINE3
"RTN","PSONVAVW",27,0)
 ;
"RTN","PSONVAVW",28,0)
 Q
"RTN","PSONVAVW",29,0)
 ;
"RTN","PSONVAVW",30,0)
INIT ;
"RTN","PSONVAVW",31,0)
 N OINAM,DGNAM,CLNAM,LINE,NMSPC,L,DIWL,DIWR,X,I,OCK,PRV,STR,TXT,K,TXT,XX
"RTN","PSONVAVW",32,0)
 S XX=^PS(55,PSODFN,"NVA",PSORD,0),OINAM=$$GET1^DIQ(50.7,+$P(XX,"^"),.01)
"RTN","PSONVAVW",33,0)
 S DGNAM="" I $P(XX,"^",2) S DGNAM=$$GET1^DIQ(50,+$P(XX,"^",2),.01)
"RTN","PSONVAVW",34,0)
 ;
"RTN","PSONVAVW",35,0)
 S LINE=0,NMSPC="PSONVAVW" K ^TMP(NMSPC,$J)
"RTN","PSONVAVW",36,0)
 S LINE=LINE+1,^TMP(NMSPC,$J,LINE,0)=$J("Non-VA Med: ",23)_OINAM
"RTN","PSONVAVW",37,0)
 S LINE=LINE+1,^TMP(NMSPC,$J,LINE,0)=$J("Dispense Drug: ",23)_DGNAM
"RTN","PSONVAVW",38,0)
 S LINE=LINE+1,^TMP(NMSPC,$J,LINE,0)=$J("Dosage: ",23)_$P(XX,"^",3)
"RTN","PSONVAVW",39,0)
 ;
"RTN","PSONVAVW",40,0)
 K ^UTILITY($J,"W")
"RTN","PSONVAVW",41,0)
 S X=$$SCHED^PSONVNEW($$GET1^DIQ(55.05,PSORD_","_PSODFN,4)),DIWL=1,DIWR=60 D ^DIWP
"RTN","PSONVAVW",42,0)
 F L=1:1 Q:'$D(^UTILITY($J,"W",1,L))  D
"RTN","PSONVAVW",43,0)
 . S X="" S:L=1 X=$J("Schedule: ",23) S $E(X,24)=^UTILITY($J,"W",1,L,0)
"RTN","PSONVAVW",44,0)
 . S LINE=LINE+1,^TMP(NMSPC,$J,LINE,0)=X
"RTN","PSONVAVW",45,0)
 ;
"RTN","PSONVAVW",46,0)
 S LINE=LINE+1,^TMP(NMSPC,$J,LINE,0)=$J("Med Route: ",23)_$P(XX,"^",4)
"RTN","PSONVAVW",47,0)
 S LINE=LINE+1,^TMP(NMSPC,$J,LINE,0)=$J("Status: ",23)_$S('$P(XX,"^",6):"ACTIVE",1:"DISCONTINUED on "_$$DT($P(XX,"^",7)))
"RTN","PSONVAVW",48,0)
 S LINE=LINE+1,^TMP(NMSPC,$J,LINE,0)=$J("CPRS Order #: ",23)_$P(XX,"^",8)
"RTN","PSONVAVW",49,0)
 S LINE=LINE+1,^TMP(NMSPC,$J,LINE,0)=$J("Documented By: ",23)_$$GET1^DIQ(200,+$P(XX,"^",11),.01)
"RTN","PSONVAVW",50,0)
 S LINE=LINE+1,^TMP(NMSPC,$J,LINE,0)=$J("Documented Date: ",23)_$$DT($P(XX,"^",10))
"RTN","PSONVAVW",51,0)
 S CLNAM=$$GET1^DIQ(44,+$P(XX,"^",12),.01)
"RTN","PSONVAVW",52,0)
 S LINE=LINE+1,^TMP(NMSPC,$J,LINE,0)=$J("Clinic: ",23)_$S($P(XX,"^",12):$P(XX,"^",12)_" - "_CLNAM,1:"")
"RTN","PSONVAVW",53,0)
 S LINE=LINE+1,^TMP(NMSPC,$J,LINE,0)=$J("Start Date: ",23)_$$DT($P(XX,"^",9))
"RTN","PSONVAVW",54,0)
 ;
"RTN","PSONVAVW",55,0)
 ; - "Order Checks" fields
"RTN","PSONVAVW",56,0)
 W:$D(^PS(55,PSODFN,"NVA",PSORD,"OCK")) !
"RTN","PSONVAVW",57,0)
 F I=0:0 S I=$O(^PS(55,PSODFN,"NVA",PSORD,"OCK",I)) Q:'I  D
"RTN","PSONVAVW",58,0)
 . S OCK=^PS(55,PSODFN,"NVA",PSORD,"OCK",I,0),STR=$P(OCK,"^"),PRV=+$P(OCK,"^",2)
"RTN","PSONVAVW",59,0)
 . K TXT D TEXT(.TXT,STR,61)
"RTN","PSONVAVW",60,0)
 . D STXT("       Order Check #"_I_": ",.TXT)
"RTN","PSONVAVW",61,0)
 . K TXT
"RTN","PSONVAVW",62,0)
 . F J=0:0 S J=$O(^PS(55,PSODFN,"NVA",PSORD,"OCK",I,"OVR",J)) Q:'J  D
"RTN","PSONVAVW",63,0)
 . . S STR=^PS(55,PSODFN,"NVA",PSORD,"OCK",I,"OVR",J,0)
"RTN","PSONVAVW",64,0)
 . . D TEXT(.TXT,STR,57)
"RTN","PSONVAVW",65,0)
 . D STXT("      Override Reason: ",.TXT)
"RTN","PSONVAVW",66,0)
 . S LINE=LINE+1,^TMP(NMSPC,$J,LINE,0)="    Override Provider: "_$S(PRV:$$GET1^DIQ(200,+PRV,.01),1:"")
"RTN","PSONVAVW",67,0)
 ;
"RTN","PSONVAVW",68,0)
 ; - "Statement/Explanation" field
"RTN","PSONVAVW",69,0)
 I $D(^PS(55,PSODFN,"NVA",PSORD,"DSC")) D
"RTN","PSONVAVW",70,0)
 . K TXT
"RTN","PSONVAVW",71,0)
 . F I=0:0 S I=$O(^PS(55,PSODFN,"NVA",PSORD,"DSC",I)) Q:'I  D
"RTN","PSONVAVW",72,0)
 . . S STR=^PS(55,PSODFN,"NVA",PSORD,"DSC",I,0)
"RTN","PSONVAVW",73,0)
 . . D TEXT(.TXT,STR,57)
"RTN","PSONVAVW",74,0)
 . D STXT("Statement/Explanation: ",.TXT)
"RTN","PSONVAVW",75,0)
 ;
"RTN","PSONVAVW",76,0)
 ; - "Comments" field
"RTN","PSONVAVW",77,0)
 I $D(^PS(55,PSODFN,"NVA",PSORD,1)) D
"RTN","PSONVAVW",78,0)
 . K TXT
"RTN","PSONVAVW",79,0)
 . F I=0:0 S I=$O(^PS(55,PSODFN,"NVA",PSORD,1,I)) Q:'I  D
"RTN","PSONVAVW",80,0)
 . . S STR=^PS(55,PSODFN,"NVA",PSORD,1,I,0)
"RTN","PSONVAVW",81,0)
 . . D TEXT(.TXT,STR,57)
"RTN","PSONVAVW",82,0)
 . D STXT("             Comments: ",.TXT)
"RTN","PSONVAVW",83,0)
 ;
"RTN","PSONVAVW",84,0)
 S VALMCNT=LINE
"RTN","PSONVAVW",85,0)
 Q
"RTN","PSONVAVW",86,0)
 ;
"RTN","PSONVAVW",87,0)
TEXT(TEXT,STR,L) ; Formats STR into TEXT array, lines lenght = L
"RTN","PSONVAVW",88,0)
 N J,WORD,K S K=+$O(TEXT(""),-1) S:'K K=1
"RTN","PSONVAVW",89,0)
 F J=1:1:$L(STR," ") D
"RTN","PSONVAVW",90,0)
 . S WORD=$P(STR," ",J) I ($L($G(TEXT(K))_WORD))>L S K=K+1
"RTN","PSONVAVW",91,0)
 . S TEXT(K)=$G(TEXT(K))_WORD_" "
"RTN","PSONVAVW",92,0)
 Q
"RTN","PSONVAVW",93,0)
 ;
"RTN","PSONVAVW",94,0)
STXT(LABEL,TXT) ; Sets text lines
"RTN","PSONVAVW",95,0)
 N K,X
"RTN","PSONVAVW",96,0)
 F K=1:1 Q:'$D(TXT(K))  D
"RTN","PSONVAVW",97,0)
 . S X="" S:K=1 X=LABEL S $E(X,24)=TXT(K)
"RTN","PSONVAVW",98,0)
 . S LINE=LINE+1,^TMP(NMSPC,$J,LINE,0)=X
"RTN","PSONVAVW",99,0)
 Q
"RTN","PSONVAVW",100,0)
 ;
"RTN","PSONVAVW",101,0)
DT(DT) ; - Convert FM Date to MM/DD/YYYY
"RTN","PSONVAVW",102,0)
 I 'DT Q ""
"RTN","PSONVAVW",103,0)
 I '(DT#10000) Q (1700+$E(DT,1,3))
"RTN","PSONVAVW",104,0)
 I '(DT#100) Q $E(DT,4,5)_"/"_(1700+$E(DT,1,3))
"RTN","PSONVAVW",105,0)
 Q $E(DT,4,5)_"/"_$E(DT,6,7)_"/"_(1700+$E(DT,1,3))
"RTN","PSONVAVW",106,0)
 ;
"RTN","PSONVAVW",107,0)
EXIT Q
"RTN","PSONVAVW",108,0)
 ;
"RTN","PSONVAVW",109,0)
HELP Q
"RTN","PSOORED5")
0^1^B73345856
"RTN","PSOORED5",1,0)
PSOORED5 ;BIR/SAB-Rxs without dosing info ;07/20/00
"RTN","PSOORED5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,75,78,100,99,117,133,251,378,372,416,313,450,486,402,500**;DEC 1997;Build 9
"RTN","PSOORED5",3,0)
 ;Reference to ^PS(51.2 supported by DBIA 2226
"RTN","PSOORED5",4,0)
 ;Reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORED5",5,0)
 ;Reference to ^PSDRUG( supported by DBIA 221
"RTN","PSOORED5",6,0)
 ;Reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORED5",7,0)
 ;called by psoored2 and psodir
"RTN","PSOORED5",8,0)
 ;pre-poe rxs and new backdoor rxs
"RTN","PSOORED5",9,0)
DOSE1(PSORXED) ;for new rxs
"RTN","PSOORED5",10,0)
DOSE ;pre-poe rx
"RTN","PSOORED5",11,0)
 D KV K ROU,STRE,FIELD,DOSEOR,DUPD,X,Y,UNITS S ENT=1,OLENT=ENT
"RTN","PSOORED5",12,0)
ASK S ROU="PSOORED5" D ASK^PSOBKDED K ROU G:$D(DIRUT) EXE  ;486
"RTN","PSOORED5",13,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED5",14,0)
 I $G(QUIT)]"" K QUIT,ROU Q
"RTN","PSOORED5",15,0)
 ;
"RTN","PSOORED5",16,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED5",17,0)
 I $G(PSORX("EDIT"))']"" W:$G(PSORXED("VERB",ENT))]"" !,"VERB: "_PSORXED("VERB",ENT) G DUPD
"RTN","PSOORED5",18,0)
VER D VER^PSOOREDX
"RTN","PSOORED5",19,0)
 I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED5",20,0)
 G EX:$D(DTOUT),EXE:$D(DUOUT) I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED5",21,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED5",22,0)
DUPD ;
"RTN","PSOORED5",23,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED5",24,0)
 D KV S DIR(0)="52.0113,1",DIR("A")="DISPENSE UNITS PER DOSE"_$S($G(PSORXED("NOUN",ENT))]"":"("_PSORXED("NOUN",ENT)_")",1:"")
"RTN","PSOORED5",25,0)
 I '$G(PSORXED("DOSE",ENT)),$G(PSORXED("DOSE",ENT-1)) S PSORXED("DOSE",ENT)=PSORXED("DOSE",ENT-1)
"RTN","PSOORED5",26,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),$G(DUPD)]"":DUPD,1:"") S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED5",27,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED5",28,0)
 G EX:$D(DTOUT),EXE:$D(DUOUT)
"RTN","PSOORED5",29,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED5",30,0)
 D STR^PSOOREDX
"RTN","PSOORED5",31,0)
 ;
"RTN","PSOORED5",32,0)
NOU1 G:'$D(DUPD) RTE D CNON^PSOORED3 N PSONDEF
"RTN","PSOORED5",33,0)
 I $G(NOUN)]"",$G(PSORX("EDIT"))']"" S PSORXED("NOUN",ENT)=NOUN W !,"NOUN: "_$G(NOUN) G RTE
"RTN","PSOORED5",34,0)
 I $G(PSORX("EDIT"))']"",$G(PSORXED("NOUN",ENT))]"" W !,"NOUN: "_PSORXED("NOUN",ENT) G RTE
"RTN","PSOORED5",35,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED5",36,0)
 G EXE:$D(DTOUT)!$D(DUOUT) I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED5",37,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED5",38,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED5",39,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED5",40,0)
 ;
"RTN","PSOORED5",41,0)
RTE I $G(ENT)>1,$G(PSORX("EDIT"))']"",$G(PSORXED("ROUTE",ENT-1)),$G(PSORXED("ROUTE",ENT))']"" S PSORXED("ROUTE",ENT)=PSORXED("ROUTE",ENT-1) G SCH
"RTN","PSOORED5",42,0)
 I '$G(DRET),'$G(PSORXED("ROUTE",ENT)),$P(^PS(50.7,PSODRUG("OI"),0),"^",6) S PSORXED("ROUTE",ENT)=$P(^PS(50.7,PSODRUG("OI"),0),"^",6)
"RTN","PSOORED5",43,0)
 I $G(DRET) S PSORXED("ROUTE",ENT)=""
"RTN","PSOORED5",44,0)
 I $G(RTE) K RTE
"RTN","PSOORED5",45,0)
 D KV S DIR(0)="FO^2:45",DIR("A")="ROUTE",DIR("?")="^D HLP^PSOORED4"
"RTN","PSOORED5",46,0)
 S DIR("B")=$S($G(PSORXED("ROUTE",ENT)):$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),$G(RTE)]"":RTE,$G(DRET):"",1:"PO") K:DIR("B")="" DIR("B")
"RTN","PSOORED5",47,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="RTE" G JUMP
"RTN","PSOORED5",48,0)
 S:($D(DTOUT))!($D(DUOUT)) PSODIR("DFLG")=1 G EX:$D(DTOUT),EXE:$D(DUOUT)
"RTN","PSOORED5",49,0)
 I X="@"!(X="") K RTE,ERTE S DRET=1,PSORXED("ROUTE",ENT)="" G SCH
"RTN","PSOORED5",50,0)
 K DRET I X=$P($G(^PS(51.2,+$G(PSORXED("ROUTE",ENT)),0)),"^") S RTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),ERTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^",2) W X_" "_$G(ERTE) G SCH
"RTN","PSOORED5",51,0)
 S DIC=51.2,DIC(0)="QEZM",DIC("S")="I $P(^(0),""^"",4)" D ^DIC Q:X[U  G:Y=-1 RTE W "  "_$P(Y(0),"^",2)
"RTN","PSOORED5",52,0)
 S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2)
"RTN","PSOORED5",53,0)
 ;
"RTN","PSOORED5",54,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED5",55,0)
 G EX:$D(DTOUT),EXE:$D(DUOUT)
"RTN","PSOORED5",56,0)
 S SCH=$$SCHASL(Y) D SCH^PSOSIG I $G(SCH)']""!($D(DTOUT))!($D(DUOUT)) G SCH
"RTN","PSOORED5",57,0)
 S PSORXED("SCHEDULE",ENT)=SCH IF $G(SCHEX)'="" W " ("_SCHEX_")"
"RTN","PSOORED5",58,0)
 K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED5",59,0)
 S:$G(PSORXED("ENT"))<ENT PSORXED("ENT")=ENT
"RTN","PSOORED5",60,0)
 ;
"RTN","PSOORED5",61,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN DAYS, HOURS OR MINUTES)"
"RTN","PSOORED5",62,0)
 S DIR("B")=$S($D(DUR):DUR,$G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED5",63,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED5",64,0)
 G EX:$D(DTOUT),EXE:$D(DUOUT)
"RTN","PSOORED5",65,0)
 D DUR1^PSOOREDX
"RTN","PSOORED5",66,0)
 ;
"RTN","PSOORED5",67,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED5",68,0)
 G EX:$D(DTOUT),EXE:$D(DUOUT)
"RTN","PSOORED5",69,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED5",70,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED5",71,0)
 I X="@" D CON1^PSOOREDX G:$D(DIRUT) EX G:'Y CON S:'$G(COPY) PSOSIGFL=1 D UPD^PSOOREDX G CON
"RTN","PSOORED5",72,0)
 ;
"RTN","PSOORED5",73,0)
 I '$$DUROK^PSOORED3(.PSORXED,ENT) D  G DUR
"RTN","PSOORED5",74,0)
 . W !!,"Duration is required for the dosage entered prior to the THEN conjunction.",$C(7),!
"RTN","PSOORED5",75,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED5",76,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSORXED("DFLG"))!($G(PSORX("DFLG"))) EX S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED5",77,0)
 E  K PSOCKCON I $$DCHK^PSODOSUT S PSORXED("DFLG")=1,PSORX("DFLG")=1 G EX
"RTN","PSOORED5",78,0)
 I PSOSAVX="",$G(PSORXED)!($D(PSOEDDOS)) K PSOCKCON
"RTN","PSOORED5",79,0)
 K PSOSAVX
"RTN","PSOORED5",80,0)
 ;
"RTN","PSOORED5",81,0)
EXS ;Entry point for EXE to rebuild SIG  PSO*7.0*450
"RTN","PSOORED5",82,0)
 S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOORED5",83,0)
 D EN^PSOFSIG(.PSORXED) I $O(SIG(0)) S PSORXED("ENT")=ENT,SIGOK=1
"RTN","PSOORED5",84,0)
 Q:$G(PSOREEDT)!($G(PSOORRNW))
"RTN","PSOORED5",85,0)
 K QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED5",86,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED5",87,0)
 K QTYHLD Q:$G(PSOFROM)="NEW"!($G(COPY))!($G(PSOFROM))!($G(PSOREEDT))
"RTN","PSOORED5",88,0)
 Q:$G(PSOSIGFL)  D
"RTN","PSOORED5",89,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSOORED5",90,0)
 .S (A,I)=0 F  S I=$O(^PSRX(PSORXED("IRXN"),"A",I)) Q:'I  S A=A+1
"RTN","PSOORED5",91,0)
 .S:'$D(^PSRX(PSORXED("IRXN"),"A",0)) ^PSRX(PSORXED("IRXN"),"A",0)="^52.3DA^"
"RTN","PSOORED5",92,0)
 .S $P(^PSRX(PSORXED("IRXN"),"A",0),"^",3)=$P($G(^PSRX(PSORXED("IRXN"),"A",0)),"^",3)+1,$P(^(0),"^",4)=$P($G(^(0)),"^",4)+1
"RTN","PSOORED5",93,0)
 .D NOW^%DTC S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^New Dosing Instructions Added",^PSRX(PSORXED("IRXN"),"A",A,1)="ORIGINAL SIG^" D
"RTN","PSOORED5",94,0)
 ..I '$P(^PSRX(PSORXED("IRXN"),"SIG"),"^",2) S $P(^PSRX(PSORXED("IRXN"),"A",A,1),"^",2)=$P(^PSRX(PSORXED("IRXN"),"SIG"),"^") Q
"RTN","PSOORED5",95,0)
 ..F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S ^PSRX(PSORXED("IRXN"),"A",A,2,I,0)=^PSRX(PSORXED("IRXN"),"SIG1",I,0),^PSRX(PSORXED("IRXN"),"A",A,2,0)="^52.34A^"_I_"^"_I
"RTN","PSOORED5",96,0)
 .S ^PSRX(PSORXED("IRXN"),"SIG")="^1" K SIG,A,I
"RTN","PSOORED5",97,0)
 S ^PSRX(PSORXED("IRXN"),6,0)="^52.0113^"_ENT_"^"_ENT
"RTN","PSOORED5",98,0)
 F I=1:1:ENT S ^PSRX(PSORXED("IRXN"),6,I,0)=PSORXED("DOSE",I)_"^"_$G(PSORXED("DOSE ORDERED",I))_"^"_$G(PSORXED("UNITS",I))_"^"_$G(PSORXED("NOUN",I))_"^" D
"RTN","PSOORED5",99,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,0)=^PSRX(PSORXED("IRXN"),6,I,0)_$G(PSORXED("DURATION",I))_"^"_$G(PSORXED("CONJUNCTION",I))_"^"_$G(PSORXED("ROUTE",I))_"^"_$G(PSORXED("SCHEDULE",I))_"^"_$G(PSORXED("VERB",I))
"RTN","PSOORED5",100,0)
 .I $G(PSORXED("DOSE",I))]"" S ^PSRX(PSORXED("IRXN"),6,I,1)=PSORXED("DOSE",I)
"RTN","PSOORED5",101,0)
 S ^PSRX(PSORXED("IRXN"),"POE")=1 G EX
"RTN","PSOORED5",102,0)
 Q
"RTN","PSOORED5",103,0)
EX I $D(DUOUT)!($D(DTOUT)) S PSONEW("DFLG")=1
"RTN","PSOORED5",104,0)
 ;I $D(DUOUT)!($D(DTOUT)) S:'$G(PSORX("EDIT")) PSONEW("DFLG")=1
"RTN","PSOORED5",105,0)
 G:$G(PSOSIGFL)!($G(PSORX("EDIT")))!($G(PSORXED))!($G(PSOREEDT)) EX1
"RTN","PSOORED5",106,0)
 K PSORXED("DOSE"),PSORXED("NOUN"),PSORXED("VERB"),PSORXED("DOSE ORDERED"),PSORXED("ROUTE"),SIG,PSORXED("SCHEDULE"),PSORXED("DURATION"),PSORXED("CONJUNCTION"),PSORXED("ODOSE")
"RTN","PSOORED5",107,0)
EX1 K UNITN,STRE,DOSE,DUPD,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSOSCH,ENT,PSORTE,DURA,ERTE,ROU
"RTN","PSOORED5",108,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOORED5",109,0)
 Q
"RTN","PSOORED5",110,0)
 ;This line tag was added to check if EXit is being performed while EDITing.  If it is,
"RTN","PSOORED5",111,0)
 ;process SIG and do not delete order.  Previous calls to EX when due to $D(DUOUT) were
"RTN","PSOORED5",112,0)
 ;changed to go to this line tag instead.
"RTN","PSOORED5",113,0)
EXE I $G(PSORX("EDIT"))]"" K DUOUT G EXS  ;*PSO*7.0*450
"RTN","PSOORED5",114,0)
 G EX
"RTN","PSOORED5",115,0)
 ;
"RTN","PSOORED5",116,0)
UPD ;updates dosing array
"RTN","PSOORED5",117,0)
 D UPD^PSOORED6
"RTN","PSOORED5",118,0)
 Q
"RTN","PSOORED5",119,0)
JUMP ;
"RTN","PSOORED5",120,0)
 I $G(PSORXED("SCHEDULE",1))']"" W $C(7),!!,"All Dosing Instructions must be entered before Jumping to other Fields!",!! G @FIELD
"RTN","PSOORED5",121,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED5",122,0)
 D FNM^PSOOREDX
"RTN","PSOORED5",123,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED5",124,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED5",125,0)
 D KV
"RTN","PSOORED5",126,0)
 I $G(PSOFROM)'="NEW",'$G(COPY) S DIR("A",1)="* Indicates which fields will create a New Order"
"RTN","PSOORED5",127,0)
 S DIR("A")="Select Field by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED5",128,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED5",129,0)
 G EX
"RTN","PSOORED5",130,0)
 Q
"RTN","PSOORED5",131,0)
LAN ;
"RTN","PSOORED5",132,0)
 Q:'$G(PSODRUG("IEN"))
"RTN","PSOORED5",133,0)
 I $G(OR0),'$G(PSONEW("DOSE ORDERED",II)),$P($G(^PS(55,PSODFN,"LAN")),"^") D  K QI,QII Q
"RTN","PSOORED5",134,0)
 .Q:$G(OTHDOS(II))
"RTN","PSOORED5",135,0)
 .F QI=0:0 S QI=$O(^PSDRUG(PSODRUG("IEN"),"DOS2",QI)) Q:'QI  D  Q:$G(QII)
"RTN","PSOORED5",136,0)
 ..Q:$G(PSONEW("DOSE",II))']""
"RTN","PSOORED5",137,0)
 ..I PSONEW("DOSE",II)=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",QI,0),"^") S PSONEW("ODOSE",II)=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",QI,0),"^",4),QII=1
"RTN","PSOORED5",138,0)
 I $G(Y),$P($G(DOSE(Y)),"^",13)]"" S PSORXED("ODOSE",ENT)=$P(DOSE(Y),"^",13) Q
"RTN","PSOORED5",139,0)
 K QII F I=0:0 S I=$O(^PSDRUG(PSODRUG("IEN"),"DOS2",I)) Q:'I  I DOSE=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",I,0),"^") D  Q:$G(QII)
"RTN","PSOORED5",140,0)
 .S PSORXED("ODOSE",ENT)=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",I,0),"^",4),QII=1
"RTN","PSOORED5",141,0)
 K QII,I
"RTN","PSOORED5",142,0)
 Q
"RTN","PSOORED5",143,0)
 ;
"RTN","PSOORED5",144,0)
SCHASL(SCHA) ;
"RTN","PSOORED5",145,0)
 N SCHEA,SCHFL1 S SCHEA="",SCHFL1=0
"RTN","PSOORED5",146,0)
 ;**Lookup into the ADMINISTRATION SCHEDULE (#51.1) file 
"RTN","PSOORED5",147,0)
 K X,Y,DIC,D SET X=$G(SCHA),DIC="^PS(51.1,",DIC(0)="CEMOV",DIC("W")="W ""  ""_$G(X)_""  ""_$P(^PS(51.1,+Y,0),U,8)",D="APPSJ^D" W !,"Now searching ADMINISTRATION SCHEDULE (#51.1) file...",! D MIX^DIC1
"RTN","PSOORED5",148,0)
 K DIC,D S:Y'>0 SCHFL1=1 IF '$G(SCHFL1),'$D(DTOUT),'$D(DUOUT) SET SCHEA=$P(Y,U,2) Q SCHEA
"RTN","PSOORED5",149,0)
 I $D(DTOUT)!($D(DUOUT)) Q ""
"RTN","PSOORED5",150,0)
 I $G(SCHFL1)=1 S SCHEA=$$SCHMI(SCHA) Q SCHEA
"RTN","PSOORED5",151,0)
 Q ""
"RTN","PSOORED5",152,0)
 ;
"RTN","PSOORED5",153,0)
SCHMI(SCHM) ;
"RTN","PSOORED5",154,0)
 N SCHEM,SCHFL2 S SCHEM="",SCHFL2=0
"RTN","PSOORED5",155,0)
 ;**Lookup into the MEDICATION INSRUCTION (#51) file
"RTN","PSOORED5",156,0)
 K X,Y,DIC,D SET X=$G(SCHM),DIC="^PS(51,",DIC(0)="CEMOV",DIC("W")="W ""  ""_$G(X)_""  ""_$P(^PS(51,+Y,0),U,2)",D="A^B^D" W !,"Now searching MEDICATION INSTRUCTION (#51) file...",! D MIX^DIC1
"RTN","PSOORED5",157,0)
 K DIC,D S:Y'>0 SCHFL2=1 IF '$G(SCHFL2),'$D(DTOUT),'$D(DUOUT) SET SCHEM=$P(Y,U,2) Q SCHEM
"RTN","PSOORED5",158,0)
 ;
"RTN","PSOORED5",159,0)
 I $D(DTOUT)!($D(DUOUT)) Q ""
"RTN","PSOORED5",160,0)
 I $G(SCHFL2)=1 Q SCHM
"RTN","PSOORED5",161,0)
 Q ""
"RTN","PSOORUT2")
0^12^B105702086
"RTN","PSOORUT2",1,0)
PSOORUT2 ;ISC BHAM/SAB - build listman screen ; 3/20/07 9:47am
"RTN","PSOORUT2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,146,132,182,233,243,261,268,264,305,390,411,402,500**;DEC 1997;Build 9
"RTN","PSOORUT2",3,0)
 ;External reference to $$PRIAPT^SDPHARM1 supported by DBIA 4196
"RTN","PSOORUT2",4,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORUT2",5,0)
 ;External reference to ^DIC(31 supported by DBIA 658
"RTN","PSOORUT2",6,0)
 ;External reference to ^ORRDI1 supported by DBIA 4659
"RTN","PSOORUT2",7,0)
 ;External reference to ^DPT(DFN,.372 supported by DBIA 1476
"RTN","PSOORUT2",8,0)
 ;External reference to ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOORUT2",9,0)
 ;External reference to ^GMRADPT supported by DBIA 10099
"RTN","PSOORUT2",10,0)
 ;External reference to $$TERMLKUP^ORB31 supported by DBIA 5140
"RTN","PSOORUT2",11,0)
 ;External reference to $$BSA^PSSDSAPI supported by DBIA 5425
"RTN","PSOORUT2",12,0)
 ;External reference to ^ORQQVI supported by DBIA 5770
"RTN","PSOORUT2",13,0)
 ;External reference to ^ORQQLR1 supported by DBIA 5787
"RTN","PSOORUT2",14,0)
 ;External reference to ^VADPT supported by DBIA 10061
"RTN","PSOORUT2",15,0)
 ;
"RTN","PSOORUT2",16,0)
 K ^TMP("PSOHDR",$J),^TMP("PSOPI",$J) S DFN=PSODFN D ^VADPT,ADD^VADPT
"RTN","PSOORUT2",17,0)
 N I1,PSCNT,PSDIS,PSON,PSOTEL,PSOTMP
"RTN","PSOORUT2",18,0)
 S ^TMP("PSOHDR",$J,1,0)=VADM(1),^TMP("PSOHDR",$J,2,0)=$P(VADM(2),"^",2)
"RTN","PSOORUT2",19,0)
 S ^TMP("PSOHDR",$J,3,0)=$P(VADM(3),"^",2),^TMP("PSOHDR",$J,4,0)=VADM(4),^TMP("PSOHDR",$J,5,0)=$P(VADM(5),"^",2)
"RTN","PSOORUT2",20,0)
 D NVA
"RTN","PSOORUT2",21,0)
 S POERR=1 D RE^PSODEM K POERR
"RTN","PSOORUT2",22,0)
 S ^TMP("PSOHDR",$J,6,0)=$S($P(WT,"^",8):$P(WT,"^",9)_" ("_$P(WT,"^")_")",1:"_______ (______)")
"RTN","PSOORUT2",23,0)
 S ^TMP("PSOHDR",$J,7,0)=$S($P(HT,"^",8):$P(HT,"^",9)_" ("_$P(HT,"^")_")",1:"_______ (______)") K VM,WT,HT S PSOHD=7
"RTN","PSOORUT2",24,0)
 S GMRA="0^0^111" D ^GMRADPT S ^TMP("PSOHDR",$J,8,0)=+$G(GMRAL)
"RTN","PSOORUT2",25,0)
 S $P(^TMP("PSOHDR",$J,9,0)," ",62)="ISSUE  LAST REF DAY"
"RTN","PSOORUT2",26,0)
 S ^TMP("PSOHDR",$J,10,0)=" #  RX #         DRUG                                 QTY ST  DATE  "_$S($G(PSORFG):"RELD",1:"FILL")_" REM SUP"
"RTN","PSOORUT2",27,0)
 ;
"RTN","PSOORUT2",28,0)
 ;  Display CrCl/BSA - show serum creatinine if CrCl can't be calculated 
"RTN","PSOORUT2",29,0)
 S PSOBSA=$$BSA^PSSDSAPI(DFN),PSOBSA=$P(PSOBSA,"^",3),PSOBSA=$S(PSOBSA'>0:"_______",1:$J(PSOBSA,4,2)) S ^TMP("PSOHDR",$J,12,0)=PSOBSA
"RTN","PSOORUT2",30,0)
 S RSLT=$$CRCL(DFN)
"RTN","PSOORUT2",31,0)
 ; RSLT -- DATE^CRCL^Serum Creatinine -- Ex.  11/25/11^68.7^1.1
"RTN","PSOORUT2",32,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)<.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_" (CREAT: Not Found)"
"RTN","PSOORUT2",33,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"  (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSOORUT2",34,0)
 I ($P($G(RSLT),"^",2)>0)&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"(est.)"_" (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSOORUT2",35,0)
 S ^TMP("PSOHDR",$J,13,0)=ZDSPL
"RTN","PSOORUT2",36,0)
 ;
"RTN","PSOORUT2",37,0)
 D ELIG^VADPT S IEN=1,^TMP("PSOPI",$J,IEN,0)="Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:""),IEN=IEN+1
"RTN","PSOORUT2",38,0)
 S N=0 F  S N=$O(VAEL(1,N)) Q:'N  S $P(^TMP("PSOPI",$J,IEN,0)," ",14)=$P(VAEL(1,N),"^",2),IEN=IEN+1
"RTN","PSOORUT2",39,0)
 S ^TMP("PSOPI",$J,IEN,0)="",^TMP("PSOPI",$J,IEN,0)="RX PATIENT STATUS: "_$$GET1^DIQ(55,PSODFN,3),IEN=IEN+1
"RTN","PSOORUT2",40,0)
 S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Disabilities: "
"RTN","PSOORUT2",41,0)
 F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  S I1=$S($D(^DPT(DFN,.372,I,0)):^(0),1:"") D:+I1
"RTN","PSOORUT2",42,0)
 .S PSDIS=$S($P($G(^DIC(31,+I1,0)),"^")]""&($P($G(^(0)),"^",4)']""):$P(^(0),"^"),$P($G(^DIC(31,+I1,0)),"^",4)]"":$P(^(0),"^",4),1:""),PSCNT=$P(I1,"^",2)
"RTN","PSOORUT2",43,0)
 .S:$L(^TMP("PSOPI",$J,IEN,0)_PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), ")>80 IEN=IEN+1,$P(^TMP("PSOPI",$J,IEN,0)," ",14)=" "
"RTN","PSOORUT2",44,0)
 .S ^TMP("PSOPI",$J,IEN,0)=$G(^TMP("PSOPI",$J,IEN,0))_PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), "
"RTN","PSOORUT2",45,0)
 S IEN=IEN+1 S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1
"RTN","PSOORUT2",46,0)
 I +VAPA(9) S ^TMP("PSOPI",$J,IEN,0)="      (Temp Address from "_$P(VAPA(9),"^",2)_" till "_$S($P(VAPA(10),"^",2)]"":$P(VAPA(10),"^",2),1:"(no end date)")_")",IEN=IEN+1
"RTN","PSOORUT2",47,0)
 S ^TMP("PSOPI",$J,IEN,0)=VAPA(1) S:VAPA(2)]"" IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(2) S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(3)
"RTN","PSOORUT2",48,0)
 S ^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_$J("",50-$L(VAPA(3)))_"HOME PHONE: "_VAPA(8)
"RTN","PSOORUT2",49,0)
 S PSOTEL=$G(^DPT(DFN,.13))
"RTN","PSOORUT2",50,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(4),^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_$J("",50-$L(VAPA(4)))_"CELL PHONE: "_$P(PSOTEL,"^",4)
"RTN","PSOORUT2",51,0)
 S PSOTMP=$P(VAPA(5),"^",2)_"  "_$S(VAPA(11)]"":$P(VAPA(11),"^",2),1:VAPA(6)),IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=PSOTMP
"RTN","PSOORUT2",52,0)
 S ^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_$J("",50-$L(PSOTMP))_"WORK PHONE: "_$P(PSOTEL,"^",2)
"RTN","PSOORUT2",53,0)
 S MAILD=+$P($G(^PS(55,DFN,0)),"^",3) D  K MAILD
"RTN","PSOORUT2",54,0)
 .S PSOTMP="Prescription Mail Delivery: "_$S(MAILD=1:"Certified Mail",MAILD=2:"DO NOT MAIL",MAILD=3:"Local - Regular Mail",MAILD=4:"Local - Certified Mail",1:"Regular Mail") S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=PSOTMP
"RTN","PSOORUT2",55,0)
 .I MAILD<2!(MAILD>4) Q  ;ONLY FOR MAIL DELIVERIES 2,3,4
"RTN","PSOORUT2",56,0)
 .N PSOMDEXP,Y
"RTN","PSOORUT2",57,0)
 .S Y=$P($G(^PS(55,DFN,0)),"^",5)
"RTN","PSOORUT2",58,0)
 .I Y,Y'>DT D
"RTN","PSOORUT2",59,0)
 ..D DD^%DT S PSOMDEXP=Y
"RTN","PSOORUT2",60,0)
 ..S ^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_" Expire Date: "_PSOMDEXP
"RTN","PSOORUT2",61,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=$S($P($G(^PS(55,DFN,0)),"^",2):"Cannot use safety caps.",1:"") S $P(^TMP("PSOPI",$J,IEN,0)," ",40)=$S($P($G(^PS(55,DFN,0)),"^",4):"Dialysis Patient.",1:"")
"RTN","PSOORUT2",62,0)
 I $G(^PS(55,DFN,1))]"" S PSON=^(1),IEN=IEN+1 D
"RTN","PSOORUT2",63,0)
 .S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="     Outpatient Narrative: "
"RTN","PSOORUT2",64,0)
 .F I=1:1 Q:$P(PSON," ",I,99)=""  S:$L(^TMP("PSOPI",$J,IEN,0)_$P(PSON," ",I)_" ")>80 IEN=IEN+1 S ^TMP("PSOPI",$J,IEN,0)=$G(^TMP("PSOPI",$J,IEN,0))_$P(PSON," ",I)_" "
"RTN","PSOORUT2",65,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",66,0)
 I $D(^PS(52.91,DFN,0)) I '$P(^(0),"^",3)!($P(^(0),"^",3)>DT) D
"RTN","PSOORUT2",67,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Primary Care Appointment: "_$$PRIAPT^SDPHARM1(DFN)
"RTN","PSOORUT2",68,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",69,0)
 I 'GMRAL D
"RTN","PSOORUT2",70,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Allergies: "_$S(GMRAL=0:"NKA",1:"")
"RTN","PSOORUT2",71,0)
 .I GMRAL'=0 S PSONOAL="" D ALLERGY I PSONOAL'="" S ^TMP("PSOPI",$J,IEN,0)="Allergies: "_PSONOAL K PSONOAL
"RTN","PSOORUT2",72,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",73,0)
 .D REMOTE
"RTN","PSOORUT2",74,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Adverse Reactions:"
"RTN","PSOORUT2",75,0)
 D:$G(GMRAL) ^PSOORUT3
"RTN","PSOORUT2",76,0)
 K ^UTILITY("VASD",$J),VASD S DFN=PSODFN,VASD("F")=DT,VASD("T")=9999999,VASD("W")="123456789" D SDA^VADPT K VASD I $D(^UTILITY("VASD",$J)) D
"RTN","PSOORUT2",77,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Pending Clinic Appointments:"
"RTN","PSOORUT2",78,0)
 .F PSOAPP=0:0 S PSOAPP=$O(^UTILITY("VASD",$J,PSOAPP)) Q:'PSOAPP  S PSOAPPE=$G(^UTILITY("VASD",$J,PSOAPP,"E")),PSOAPPI=$G(^("I")) D
"RTN","PSOORUT2",79,0)
 ..K X S X2=DT,X1=$P($P($G(PSOAPPI),"^"),".") I $G(X1) D ^%DTC
"RTN","PSOORUT2",80,0)
 ..S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="    "_$P(PSOAPPE,"^")_"  "_$P(PSOAPPE,"^",2)_$S($P(PSOAPPI,"^",3)["C":"   *** Canceled ***",1:" ("_$G(X)_" days)")
"RTN","PSOORUT2",81,0)
 K ^UTILITY("VASD",$J),X,PSOAPPI,PSOAPPE,PSOAPP,N,PSOBSA,ZDSPL,RSLT
"RTN","PSOORUT2",82,0)
 S PSOPI=IEN K IEN
"RTN","PSOORUT2",83,0)
 Q
"RTN","PSOORUT2",84,0)
NVA ;
"RTN","PSOORUT2",85,0)
 Q:'$O(^PS(55,PSODFN,"NVA",0))
"RTN","PSOORUT2",86,0)
 K LSTDT F I=0:0 S I=$O(^PS(55,PSODFN,"NVA",I)) Q:'I  D
"RTN","PSOORUT2",87,0)
 .Q:$P(^PS(55,PSODFN,"NVA",I,0),"^",7)  Q:'$P(^PS(55,PSODFN,"NVA",I,0),"^")
"RTN","PSOORUT2",88,0)
 .I $P(^PS(55,PSODFN,"NVA",I,0),"^",10)>+$G(LSTDT) S LSTDT=$P(^(0),"^",10)
"RTN","PSOORUT2",89,0)
 I $G(LSTDT)]"" D
"RTN","PSOORUT2",90,0)
 .S LSTDT="Non-VA Meds on File - Last entry on "_$E(LSTDT,4,5)_"/"_$E(LSTDT,6,7)_"/"_$E(LSTDT,2,3)
"RTN","PSOORUT2",91,0)
 .I $G(^TMP("PSOHDR",$J,5,0))="MALE" S $P(^TMP("PSOHDR",$J,5,0)," ",22)=LSTDT K LSTDT Q
"RTN","PSOORUT2",92,0)
 .S $P(^TMP("PSOHDR",$J,5,0)," ",20)=LSTDT K LSTDT
"RTN","PSOORUT2",93,0)
 K I
"RTN","PSOORUT2",94,0)
 Q
"RTN","PSOORUT2",95,0)
REMOTE ;
"RTN","PSOORUT2",96,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOORUT2",97,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOORUT2",98,0)
 N PSORALG,REAC,S1,A,FILE,LEN,I
"RTN","PSOORUT2",99,0)
 K ^TMP($J,"PSOART")
"RTN","PSOORUT2",100,0)
 S PSORALG=1,PSORALG(1)="No remote data available"
"RTN","PSOORUT2",101,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) G REMOTE2
"RTN","PSOORUT2",102,0)
 I $T(GET^ORRDI1)]"" S PSOSIEN=$G(IEN) D GET^ORRDI1(DFN,"ART") S IEN=PSOSIEN K PSOSIEN D
"RTN","PSOORUT2",103,0)
 .I $P($G(^XTMP("ORRDI","ART",DFN,0)),"^",3)=0 S PSORALG(1)="No remote allergies"
"RTN","PSOORUT2",104,0)
 .S S1=0,LEN=65,PSORALG=1,PSORALG(1)="" F  S S1=$O(^XTMP("ORRDI","ART",DFN,S1)) Q:'S1  D
"RTN","PSOORUT2",105,0)
 ..S A=$G(^XTMP("ORRDI","ART",DFN,S1,"GMRALLERGY",0))
"RTN","PSOORUT2",106,0)
 ..S REAC=$P(A,"^",2) Q:REAC=""
"RTN","PSOORUT2",107,0)
 ..S FILE=$P($P(A,"^",3),"99VA",2)
"RTN","PSOORUT2",108,0)
 ..I FILE'=50.6,FILE'=120.82,FILE'=50.605,FILE'=50.416 Q
"RTN","PSOORUT2",109,0)
 ..S ^TMP($J,"PSOART",REAC)=""
"RTN","PSOORUT2",110,0)
 .S REAC="" F  S REAC=$O(^TMP($J,"PSOART",REAC)) Q:REAC=""  D
"RTN","PSOORUT2",111,0)
 ..I $L(PSORALG(PSORALG))+$L(REAC)<LEN S PSORALG(PSORALG)=PSORALG(PSORALG)_REAC_", " Q
"RTN","PSOORUT2",112,0)
 ..S PSORALG=PSORALG+1,PSORALG(PSORALG)="              "_REAC_", ",LEN=76
"RTN","PSOORUT2",113,0)
 .I PSORALG(PSORALG)]"",$E(PSORALG(PSORALG),$L(PSORALG(PSORALG)))="," S PSORALG(PSORALG)=$E(PSORALG(PSORALG),1,$L(PSORALG(PSORALG))-1)
"RTN","PSOORUT2",114,0)
REMOTE2 ;
"RTN","PSOORUT2",115,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="      Remote: "_$G(PSORALG(1)) D
"RTN","PSOORUT2",116,0)
 .F I=2:1:PSORALG S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=PSORALG(I)
"RTN","PSOORUT2",117,0)
 K ^TMP($J,"PSOART")
"RTN","PSOORUT2",118,0)
 Q
"RTN","PSOORUT2",119,0)
  ;
"RTN","PSOORUT2",120,0)
ALLERGY ;ALLERGIES & REACTIONS
"RTN","PSOORUT2",121,0)
 N GMRA,GMRAL,PSORY,ALCNT,EEE,PSOLG,PSOLGA,TEXT,CCC,CCC2,LENGTH
"RTN","PSOORUT2",122,0)
 K ^TMP($J,"PSOALWA")
"RTN","PSOORUT2",123,0)
 I '$D(DFN) S DFN=PSODFN
"RTN","PSOORUT2",124,0)
 S GMRA="0^0^111" D ^GMRADPT
"RTN","PSOORUT2",125,0)
 I $G(GMRAL) S PSORY=0 F  S PSORY=$O(GMRAL(PSORY)) Q:'PSORY  S ^TMP($J,"PSOALWA",$S($P(GMRAL(PSORY),"^",4):1,1:2),$S('$P(GMRAL(PSORY),"^",5):1,1:2),$P(GMRAL(PSORY),"^",7),$P(GMRAL(PSORY),"^",2))=""
"RTN","PSOORUT2",126,0)
 S ^TMP($J,"PSOAPT",1)=$G(PNM)_"  "_$G(SSNP),^(2)="Verified Allergies"
"RTN","PSOORUT2",127,0)
 S ALCNT=0,EEE=0,(PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",1,1,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",1,1,PSOLG,PSOLGA)) Q:PSOLGA=""  S EEE=1,ALCNT=ALCNT+1,^TMP($J,"PSOAPT",2,ALCNT)=PSOLGA
"RTN","PSOORUT2",128,0)
 I 'EEE,$G(GMRAL)=0 S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",2,ALCNT)="NKA"
"RTN","PSOORUT2",129,0)
 S ALCNT=0,^TMP($J,"PSOAPT",3)="Non-Verified Allergies"
"RTN","PSOORUT2",130,0)
 S EEE=0,(PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",2,1,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",2,1,PSOLG,PSOLGA)) Q:PSOLGA=""  S EEE=EEE+1,ALCNT=ALCNT+1,^TMP($J,"PSOAPT",3,ALCNT)=PSOLGA
"RTN","PSOORUT2",131,0)
 I 'EEE,$G(GMRAL)=0 S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",3,ALCNT)="NKA"
"RTN","PSOORUT2",132,0)
 S ALCNT=0,^TMP($J,"PSOAPT",4)="Verified Adverse Reactions"
"RTN","PSOORUT2",133,0)
 S (PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",1,2,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",1,2,PSOLG,PSOLGA)) Q:PSOLGA=""  S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",4,ALCNT)=PSOLGA
"RTN","PSOORUT2",134,0)
 S ALCNT=0,^TMP($J,"PSOAPT",5)="Non-Verified Adverse Reactions"
"RTN","PSOORUT2",135,0)
 S (PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",2,2,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",2,2,PSOLG,PSOLGA)) Q:PSOLGA=""  S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",5,ALCNT)=PSOLGA
"RTN","PSOORUT2",136,0)
 S TEXT=^TMP($J,"PSOAPT",1) D CHKNO(TEXT)
"RTN","PSOORUT2",137,0)
 F CCC=3,4,5 I '$O(^TMP($J,"PSOAPT",CCC,0)) K ^TMP($J,"PSOAPT",CCC)
"RTN","PSOORUT2",138,0)
 D PSONOAL
"RTN","PSOORUT2",139,0)
 I CCC="NKA" S ^TMP($J,"PSOAPT",2,1)="No Known Allergies" K ^TMP($J,"PSOAPT",3)
"RTN","PSOORUT2",140,0)
 N OUT S CCC=1,OUT=0
"RTN","PSOORUT2",141,0)
 F  S CCC=$O(^TMP($J,"PSOAPT",CCC)) Q:CCC=""  D  Q:OUT
"RTN","PSOORUT2",142,0)
 .S TEXT=$G(^TMP($J,"PSOAPT",CCC))
"RTN","PSOORUT2",143,0)
 .I TEXT="No Allergy Assessment" S PSONOAL=TEXT Q
"RTN","PSOORUT2",144,0)
 .S (TEXT,CCC2)="",LENGTH=0
"RTN","PSOORUT2",145,0)
 .F  S CCC2=$O(^TMP($J,"PSOAPT",CCC,CCC2)) Q:CCC2=""  S TEXT=^(CCC2) D CHKNO(TEXT)
"RTN","PSOORUT2",146,0)
 K ^TMP($J,"PSOALWA"),^TMP($J,"PSOAPT")
"RTN","PSOORUT2",147,0)
 Q
"RTN","PSOORUT2",148,0)
CHKNO(T) ;
"RTN","PSOORUT2",149,0)
 I T="No Allergy Assessment" S PSONOAL=T
"RTN","PSOORUT2",150,0)
 Q
"RTN","PSOORUT2",151,0)
PSONOAL ;
"RTN","PSOORUT2",152,0)
 N FLG3,FLG4,FLG5
"RTN","PSOORUT2",153,0)
 S CCC=$G(^TMP($J,"PSOAPT",2,1))
"RTN","PSOORUT2",154,0)
 S FLG3=$G(^TMP($J,"PSOAPT",3,1))
"RTN","PSOORUT2",155,0)
 S FLG4=$G(^TMP($J,"PSOAPT",4,1))
"RTN","PSOORUT2",156,0)
 S FLG5=$G(^TMP($J,"PSOAPT",5,1))
"RTN","PSOORUT2",157,0)
 I CCC="",FLG3="",FLG4="",FLG5="" S ^TMP($J,"PSOAPT",2,1)="No Allergy Assessment" K ^TMP($J,"PSOAPT",3)
"RTN","PSOORUT2",158,0)
 Q
"RTN","PSOORUT2",159,0)
CRCL(DFN) ;
"RTN","PSOORUT2",160,0)
 N HTGT60,ABW,IBW,BWRATIO,BWDIFF,LOWBW,ADJBW,X1,X2,RSLT,PSCR,PSRW,ABW,ZHT,PSRH,PSCXTL,PSCXTLS,SCR,SCRD,OCXT,OCXTS,SCRV,ZAGE,ZSERUM,SEX
"RTN","PSOORUT2",161,0)
 S RSLT="0^<Not Found>"
"RTN","PSOORUT2",162,0)
 S PSCR="^^^^^^0"
"RTN","PSOORUT2",163,0)
 S PSCXTL="" Q:'$$TERMLKUP^ORB31(.PSCXTL,"SERUM CREATININE") RSLT
"RTN","PSOORUT2",164,0)
 S PSCXTLS="" Q:'$$TERMLKUP^ORB31(.PSCXTLS,"SERUM SPECIMEN") RSLT
"RTN","PSOORUT2",165,0)
 S SCR="",OCXT=0 F  S OCXT=$O(PSCXTL(OCXT)) Q:'OCXT  D
"RTN","PSOORUT2",166,0)
 .S OCXTS=0 F  S OCXTS=$O(PSCXTLS(OCXTS)) Q:'OCXTS  D
"RTN","PSOORUT2",167,0)
 ..S SCR=$$LOCL^ORQQLR1(DFN,$P(PSCXTL(OCXT),U),$P(PSCXTLS(OCXTS),U))
"RTN","PSOORUT2",168,0)
 ..I $P(SCR,U,7)>$P(PSCR,U,7) S PSCR=SCR
"RTN","PSOORUT2",169,0)
 S SCR=PSCR,SCRV=$P(SCR,U,3) Q:+$G(SCRV)<.01 RSLT
"RTN","PSOORUT2",170,0)
 S SCRD=$P(SCR,U,7) Q:'$L(SCRD) RSLT
"RTN","PSOORUT2",171,0)
 S RSLT=SCRD_"^<Not Found>^"_$P($G(SCR),"^",3)
"RTN","PSOORUT2",172,0)
 S X1=$P(RSLT,"^"),X2=$$FMTE^XLFDT(X1,"2M"),$P(RSLT,"^")=$P(X2,"@") K X1,X2
"RTN","PSOORUT2",173,0)
 D VITAL^ORQQVI("WEIGHT","WT",DFN,.PSRW,0,"",$$NOW^XLFDT)
"RTN","PSOORUT2",174,0)
 Q:'$D(PSRW) RSLT
"RTN","PSOORUT2",175,0)
 S ABW=$P(PSRW(1),U,3) Q:+$G(ABW)<1 RSLT
"RTN","PSOORUT2",176,0)
 S ABW=ABW/2.2046226  ;ABW (actual body weight) in kg; changed 2.2 to 2.2046226 per CQ 10637 ; PSO 402
"RTN","PSOORUT2",177,0)
 D VITAL^ORQQVI("HEIGHT","HT",DFN,.PSRH,0,"",$$NOW^XLFDT)
"RTN","PSOORUT2",178,0)
 Q:'$D(PSRH) RSLT
"RTN","PSOORUT2",179,0)
 S ZHT=$P(PSRH(1),U,3) Q:+$G(ZHT)<1 RSLT
"RTN","PSOORUT2",180,0)
 N VADM D DEM^VADPT S ZAGE=$G(VADM(4)) Q:'$L(ZAGE) RSLT
"RTN","PSOORUT2",181,0)
 ;S ZAGE=$$AGE^ORQPTQ4(DFN) Q:'ZAGE RSLT
"RTN","PSOORUT2",182,0)
 S SEX=$P($G(VADM(5)),"^") Q:'$L(SEX) RSLT
"RTN","PSOORUT2",183,0)
 ;S SEX=$P($$SEX^ORQPTQ4(DFN),U,1) Q:'$L(SEX) RSLT
"RTN","PSOORUT2",184,0)
 I '$G(ABW)!($G(ZHT)<1)!'$G(ZAGE)!'$D(SEX) Q RSLT
"RTN","PSOORUT2",185,0)
 S SCRD=$P(SCR,U,7) Q:'$L(SCRD) RSLT
"RTN","PSOORUT2",186,0)
 S HTGT60=$S(ZHT>60:(ZHT-60)*2.3,1:0)  ;if ht > 60 inches
"RTN","PSOORUT2",187,0)
 I HTGT60>0 D
"RTN","PSOORUT2",188,0)
 .S IBW=$S(SEX="M":50+HTGT60,1:45.5+HTGT60)  ;Ideal Body Weight
"RTN","PSOORUT2",189,0)
 .S BWRATIO=(ABW/IBW)  ;body weight ratio
"RTN","PSOORUT2",190,0)
 .S BWDIFF=$S(ABW>IBW:ABW-IBW,1:0)
"RTN","PSOORUT2",191,0)
 .S LOWBW=$S(IBW<ABW:IBW,1:ABW)
"RTN","PSOORUT2",192,0)
 .I BWRATIO>1.3,(BWDIFF>0) S ADJBW=((0.3*BWDIFF)+IBW)
"RTN","PSOORUT2",193,0)
 .E  S ADJBW=LOWBW
"RTN","PSOORUT2",194,0)
 I +$G(ADJBW)<1 D
"RTN","PSOORUT2",195,0)
 .S ADJBW=ABW
"RTN","PSOORUT2",196,0)
 S CRCL=(((140-ZAGE)*ADJBW)/(SCRV*72))
"RTN","PSOORUT2",197,0)
 S:SEX="M" RSLT=SCRD_U_$J(CRCL,1,1)
"RTN","PSOORUT2",198,0)
 S:SEX="F" RSLT=SCRD_U_$J((CRCL*.85),1,1)
"RTN","PSOORUT2",199,0)
 S X1=$P(RSLT,"^"),X2=$$FMTE^XLFDT(X1,"2M"),$P(RSLT,"^")=$P(X2,"@") K X1,X2
"RTN","PSOORUT2",200,0)
 S $P(RSLT,"^",3)=$P($G(SCR),"^",3)
"RTN","PSOORUT2",201,0)
 K HTGT60,ABW,IBW,BWRATIO,BWDIFF,LOWBW,ADJBW,X1,X2,PSCR,PSRW,ABW,ZHT,PSRH,ZAGE,PSCXTL,PSCXTLS,SCR,OCXT,OCXTS,SCRV,CRCL,ZSERUM
"RTN","PSOORUT2",202,0)
 Q RSLT
"RTN","PSOPMP0")
0^13^B89710024
"RTN","PSOPMP0",1,0)
PSOPMP0 ;BIRM/MFR - Patient Medication Profile - Listmanager ;10/28/06
"RTN","PSOPMP0",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**260,281,303,289,382,313,427,500**;DEC 1997;Build 9
"RTN","PSOPMP0",3,0)
 ;Reference to EN1^GMRADPT supported by IA #10099
"RTN","PSOPMP0",4,0)
 ;Reference to EN6^GMRVUTL supported by IA #1120
"RTN","PSOPMP0",5,0)
 ;Reference to ^PS(55 supported by DBIA 2228
"RTN","PSOPMP0",6,0)
 ;
"RTN","PSOPMP0",7,0)
EN ;Menu option entry point
"RTN","PSOPMP0",8,0)
 N PSOEXPDC,PSOEXDCE,PSOSRTBY,PSORDER,PSOSIGDP,PSOSTSGP,PSOSTORD,PSORDCNT,PSOSTSEQ,PSORDSEQ,PSOCHNG
"RTN","PSOPMP0",9,0)
 N GRPLN,DIC,Y,DFN,GRPLN,HIGHLN,LASTLINE,VALMCNT
"RTN","PSOPMP0",10,0)
 ;
"RTN","PSOPMP0",11,0)
 ;Division selection
"RTN","PSOPMP0",12,0)
 I '$G(PSOSITE) D ^PSOLSET I '$D(PSOPAR) W $C(7),!!,"Pharmacy Division Must be Selected!",! G EXIT
"RTN","PSOPMP0",13,0)
 ;
"RTN","PSOPMP0",14,0)
 ;Patient selection
"RTN","PSOPMP0",15,0)
 W !! S DIC=2,DIC(0)="QEAM" D ^DIC G EXIT:Y<0  S DFN=+Y
"RTN","PSOPMP0",16,0)
 S PSODFN=DFN D CHKADDR^PSOBAI(DFN,1,1)  ;bad address flag/update
"RTN","PSOPMP0",17,0)
 D LST(PSOSITE,DFN)
"RTN","PSOPMP0",18,0)
 Q
"RTN","PSOPMP0",19,0)
 ;
"RTN","PSOPMP0",20,0)
LST(SITE,PSODFN) ;ListManager entry point
"RTN","PSOPMP0",21,0)
 ; Loading Division/User preferences
"RTN","PSOPMP0",22,0)
 D LOAD^PSOPMPPF(SITE,DUZ)
"RTN","PSOPMP0",23,0)
 W !,"Please wait..."
"RTN","PSOPMP0",24,0)
 D EN^VALM("PSO PMP MAIN")
"RTN","PSOPMP0",25,0)
 D FULL^VALM1
"RTN","PSOPMP0",26,0)
 G EXIT
"RTN","PSOPMP0",27,0)
 ;
"RTN","PSOPMP0",28,0)
HDR      ;Header
"RTN","PSOPMP0",29,0)
 N LINE,POS,LINE1,LINE2,LINE3,LINE4,WT,WTDT,HT,HTDT,VADM,DFN,PNAME,DOB,SEX,X,GMRAL,ADVREA
"RTN","PSOPMP0",30,0)
 K VADM S DFN=PSODFN D DEM^VADPT
"RTN","PSOPMP0",31,0)
 S PNAME=VADM(1)
"RTN","PSOPMP0",32,0)
 S DOB=$S(+VADM(3):$P(VADM(3),"^",2)_" ("_$G(VADM(4))_")",1:"UNKNOWN")
"RTN","PSOPMP0",33,0)
 S SEX=$P(VADM(5),"^",2)
"RTN","PSOPMP0",34,0)
 S (WT,X)="",GMRVSTR="WT" D EN6^GMRVUTL I X'="" S WT=$J($P(X,"^",8)/2.2046226,6,2),WTDT=$$DAT^PSOPMP1($P(X,"^")\1,"/",1)
"RTN","PSOPMP0",35,0)
 S (HT,X)="",GMRVSTR="HT" D EN6^GMRVUTL I X'="" S HT=$J($P(X,"^",8)*2.54,6,2),HTDT=$$DAT^PSOPMP1($P(X,"^")\1,"/",1)
"RTN","PSOPMP0",36,0)
 S LINE1=PNAME
"RTN","PSOPMP0",37,0)
 S LINE1=$$ALLERGY^PSOPMP1(LINE1,DFN)
"RTN","PSOPMP0",38,0)
 S LINE2="  PID: "_$P(VADM(2),"^",2),$E(LINE2,50)="HEIGHT(cm): "_$S(HT'="":HT_" ("_HTDT_")",1:"NOT AVAILABLE")
"RTN","PSOPMP0",39,0)
 S LINE3="  DOB: "_DOB,$E(LINE3,50)="WEIGHT(kg): "_$S(WT'="":WT_" ("_WTDT_")",1:"NOT AVAILABLE")
"RTN","PSOPMP0",40,0)
 S LINE4="  SEX: "_SEX,$E(LINE4,43)="EXP/CANCEL CUTOFF: "_PSOEXDCE_" DAYS"
"RTN","PSOPMP0",41,0)
 ;
"RTN","PSOPMP0",42,0)
 K VALMHDR S VALMHDR(1)=LINE1,VALMHDR(2)=LINE2,VALMHDR(3)=LINE3,VALMHDR(4)=LINE4
"RTN","PSOPMP0",43,0)
 D SETHDR^PSOPMP1()
"RTN","PSOPMP0",44,0)
 Q
"RTN","PSOPMP0",45,0)
 ;
"RTN","PSOPMP0",46,0)
INIT ;Populates the Body section for ListMan
"RTN","PSOPMP0",47,0)
 K ^TMP("PSOPMP0",$J),^TMP("PSOPMPSR",$J)
"RTN","PSOPMP0",48,0)
 D SETSORT(PSOSRTBY),SETLINE
"RTN","PSOPMP0",49,0)
 S VALMSG="Select the entry # to view or ?? for more actions"
"RTN","PSOPMP0",50,0)
 Q
"RTN","PSOPMP0",51,0)
 ;
"RTN","PSOPMP0",52,0)
SETLINE ;Sets the line to be displayed in ListMan
"RTN","PSOPMP0",53,0)
 N TYPE,STS,SUB,SEQ,LINE,Z,TOTAL,I,X,X1,ORDCNT,LBL,LN,IENSUB,GROUP,GRP,QTYL
"RTN","PSOPMP0",54,0)
 I '$D(^TMP("PSOPMPSR",$J)) D  Q
"RTN","PSOPMP0",55,0)
 . F I=1:1:6 S ^TMP("PSOPMP0",$J,I,0)=""
"RTN","PSOPMP0",56,0)
 . S ^TMP("PSOPMP0",$J,7,0)="                    No prescriptions found for this patient."
"RTN","PSOPMP0",57,0)
 . S VALMCNT=1
"RTN","PSOPMP0",58,0)
 ;
"RTN","PSOPMP0",59,0)
 ;Resetting list to NORMAL video attributes
"RTN","PSOPMP0",60,0)
 F I=1:1:$G(LASTLINE) D RESTORE^VALM10(I)
"RTN","PSOPMP0",61,0)
 K GRPLN,HIGHLN
"RTN","PSOPMP0",62,0)
 ;Building the list (line by line)
"RTN","PSOPMP0",63,0)
 S (GROUP,STS,SUB)="",LINE=0 K ^TMP("PSOPMP0",$J)
"RTN","PSOPMP0",64,0)
 F  S GROUP=$O(^TMP("PSOPMPSR",$J,GROUP)) Q:GROUP=""  D
"RTN","PSOPMP0",65,0)
 . S GRP=$P(GROUP,"^")
"RTN","PSOPMP0",66,0)
 . I GRP'["R"!('PSOSTSGP&($O(^TMP("PSOPMPSR",$J,GROUP),-1)'="")) D
"RTN","PSOPMP0",67,0)
 . . D GROUP^PSOPMP1($P(GROUP,"^",2),+$G(^TMP("PSOPMPSR",$J,GROUP)),.LINE)
"RTN","PSOPMP0",68,0)
 . F  S STS=$O(^TMP("PSOPMPSR",$J,GROUP,STS)) Q:STS=""  D
"RTN","PSOPMP0",69,0)
 . . I STS'="<NULL>" D
"RTN","PSOPMP0",70,0)
 . . . D GROUP^PSOPMP1($P(STS,"^",2),+$G(^TMP("PSOPMPSR",$J,GROUP,STS)),.LINE)
"RTN","PSOPMP0",71,0)
 . . F  S SUB=$O(^TMP("PSOPMPSR",$J,GROUP,STS,SUB),$S(PSORDER="A":1,1:-1)) Q:SUB=""  D
"RTN","PSOPMP0",72,0)
 . . . S Z=$G(^TMP("PSOPMPSR",$J,GROUP,STS,SUB))
"RTN","PSOPMP0",73,0)
 . . . S X1="",SEQ=$G(SEQ)+1,X1=$J(SEQ,3)
"RTN","PSOPMP0",74,0)
 . . . S QTYL=$L($P(Z,"^",4)) S:QTYL<5 QTYL=5
"RTN","PSOPMP0",75,0)
 . . . I GRP["R"!(GRP["T")!(GRP["H") S $E(X1,5)=$P(Z,"^",2),$E(X1,19)=$E($P(Z,"^",3),1,(32-QTYL))
"RTN","PSOPMP0",76,0)
 . . . I GRP["P"!(GRP["N") S $E(X1,5)=$P(Z,"^",3)
"RTN","PSOPMP0",77,0)
 . . . I GRP["N" S $E(X1,49)="Date Documented:"
"RTN","PSOPMP0",78,0)
 . . . I GRP'["N" S $E(X1,52-QTYL)=$J($P(Z,"^",4),QTYL),$E(X1,53)=$P(Z,"^",5),$E(X1,57)=$P(Z,"^",6)
"RTN","PSOPMP0",79,0)
 . . . S $E(X1,66)=$P(Z,"^",7)
"RTN","PSOPMP0",80,0)
 . . . S $E(X1,74)=$J($P(Z,"^",8),3),$E(X1,78)=$J($P(Z,"^",9),3)
"RTN","PSOPMP0",81,0)
 . . . S LINE=LINE+1,^TMP("PSOPMP0",$J,LINE,0)=X1,HIGHLN(LINE)=""
"RTN","PSOPMP0",82,0)
 . . . S IENSUB=$S(GRP["R"!(GRP["T")!(GRP["H"):"RX",GRP["P":"PEN",1:"NVA")
"RTN","PSOPMP0",83,0)
 . . . S ^TMP("PSOPMP0",$J,SEQ,IENSUB)=$P(Z,"^")
"RTN","PSOPMP0",84,0)
 . . . I IENSUB="PEN"&($P($G(^PS(52.41,+$P(Z,"^"),0)),"^",23)=1) S ^TMP("PSOPMP0",$J,LINE,"RV")=1
"RTN","PSOPMP0",85,0)
 . . . I $G(PSOSIGDP) D SETSIG^PSOPMP1($S(GRP["R"!(GRP["T")!(GRP["H"):"R",GRP["P":"P",1:"N"),+Z,.LINE,PSODFN)
"RTN","PSOPMP0",86,0)
 ;
"RTN","PSOPMP0",87,0)
 ;Saving NORMAL video attributes to be reset later
"RTN","PSOPMP0",88,0)
 I LINE>$G(LASTLINE) D
"RTN","PSOPMP0",89,0)
 . F I=($G(LASTLINE)+1):1:LINE D SAVE^VALM10(I)
"RTN","PSOPMP0",90,0)
 . S LASTLINE=LINE
"RTN","PSOPMP0",91,0)
 D VIDEO^PSOPMP1()
"RTN","PSOPMP0",92,0)
 S VALMCNT=+$G(LINE) D RV^PSOPMP1
"RTN","PSOPMP0",93,0)
 Q
"RTN","PSOPMP0",94,0)
 ;
"RTN","PSOPMP0",95,0)
SETSORT(FIELD) ;Sets the data sorted by the FIELD specified
"RTN","PSOPMP0",96,0)
 N SEQ,RX,RXNUM,DRUG,DRNAME,QTY,STATUS,STS,ISSDT,DOCDAT,LSTFD,REFREM,DAYSUP,SIG,Z,ORD,GRPCNT,GROUP,RFRX,OI,PSOBADR,RDREJ
"RTN","PSOPMP0",97,0)
 K ^TMP("PSOPMPSR",$J)
"RTN","PSOPMP0",98,0)
 ;Loading prescription (file #55)
"RTN","PSOPMP0",99,0)
 S SEQ=0
"RTN","PSOPMP0",100,0)
 F  S SEQ=$O(^PS(55,PSODFN,"P",SEQ)) Q:'SEQ  D
"RTN","PSOPMP0",101,0)
 . S RX=+$G(^PS(55,PSODFN,"P",SEQ,0)) I 'RX!($G(^PSRX(RX,0))="") Q
"RTN","PSOPMP0",102,0)
 . I $$FILTER^PSOPMP1(RX) Q
"RTN","PSOPMP0",103,0)
 . S RXNUM=$$GET1^DIQ(52,RX,.01)
"RTN","PSOPMP0",104,0)
 . S DRUG=$$GET1^DIQ(52,RX,6,"I")
"RTN","PSOPMP0",105,0)
 . S DRNAME=$$GET1^DIQ(50,DRUG,.01)
"RTN","PSOPMP0",106,0)
 . S QTY=$$GET1^DIQ(52,RX,7)
"RTN","PSOPMP0",107,0)
 . S STATUS=$$STSINFO^PSOPMP1(RX)
"RTN","PSOPMP0",108,0)
 . S ISSDT=$$ISSDT^PSOPMP1(RX,"R")
"RTN","PSOPMP0",109,0)
 . S LSTFD=$$LSTFD^PSOPMP1(RX)
"RTN","PSOPMP0",110,0)
 . S REFREM=$$REFREM^PSOPMP1(RX)
"RTN","PSOPMP0",111,0)
 . S DAYSUP=$$GET1^DIQ(52,RX,8)
"RTN","PSOPMP0",112,0)
 . S PSOBADR=$O(^PSRX(RX,"L",9999),-1)
"RTN","PSOPMP0",113,0)
 . I PSOBADR'="" S PSOBADR=$G(^PSRX(RX,"L",PSOBADR,0)) I PSOBADR["(BAD ADDRESS)" S PSOBADR="B"
"RTN","PSOPMP0",114,0)
 . I PSOBADR'="B" S PSOBADR=""
"RTN","PSOPMP0",115,0)
 . S Z="",$P(Z,"^")=RX,$P(Z,"^",2)=RXNUM_$$COPAY^PSOPMP1(RX)_$$ECME^PSOBPSUT(RX)_$$TITRX^PSOUTL(RX),$P(Z,"^",3)=$E(DRNAME,1,30)
"RTN","PSOPMP0",116,0)
 . S $P(Z,"^",4)=QTY,$P(Z,"^",5)=$P(STATUS,"^",3)_$$CMOP^PSOPMP1(DRUG,RX)_PSOBADR,$P(Z,"^",6)=$P(ISSDT,"^",2)
"RTN","PSOPMP0",117,0)
 . S $P(Z,"^",7)=$P(LSTFD,"^",2),$P(Z,"^",8)=REFREM,$P(Z,"^",9)=DAYSUP
"RTN","PSOPMP0",118,0)
 . S SORT=$S(FIELD="RX":RXNUM_" ",FIELD="DR":DRNAME_RXNUM,FIELD="ID":+ISSDT_RXNUM_" ",FIELD="LF":+LSTFD_RXNUM_" ")
"RTN","PSOPMP0",119,0)
 . S STS="<NULL>" I $G(PSOSTSGP) S STS=$P(STATUS,"^")_"^"_$P(STATUS,"^",2)
"RTN","PSOPMP0",120,0)
 . S GROUP=$P(PSORDSEQ("R"),"^")_"R^"_$P(PSORDSEQ("R"),"^",2)
"RTN","PSOPMP0",121,0)
 . ; PSO*427 changes for RRR/TRI/CVA reject display
"RTN","PSOPMP0",122,0)
 . S RDREJ=0  ; initialize RTS/DUR reject flag to 0
"RTN","PSOPMP0",123,0)
 . I $$FIND^PSOREJUT(RX,,,"79,88") S GROUP=$P(PSORDSEQ("T"),"^")_"T^"_$P(PSORDSEQ("T"),"^",2),STS="<NULL>",RDREJ=1
"RTN","PSOPMP0",124,0)
 . ; next look for any unresolved TRI/CVA rejects  *427
"RTN","PSOPMP0",125,0)
 . I 'RDREJ,$$TRIC^PSOREJP1(RX),$$FIND^PSOREJUT(RX,,,,1) S GROUP=$P(PSORDSEQ("H"),U,1)_"H^"_$P(PSORDSEQ("H"),U,2),STS="<NULL>"
"RTN","PSOPMP0",126,0)
 . ; next look for any unresolved RRR rejects  *427
"RTN","PSOPMP0",127,0)
 . I 'RDREJ,'$$TRIC^PSOREJP1(RX),$$FIND^PSOREJUT(RX,,,,,1) S GROUP=$P(PSORDSEQ("H"),U,1)_"H^"_$P(PSORDSEQ("H"),U,2),STS="<NULL>"
"RTN","PSOPMP0",128,0)
 . S ^TMP("PSOPMPSR",$J,GROUP,STS,SORT)=Z
"RTN","PSOPMP0",129,0)
 . S GRPCNT(GROUP)=$G(GRPCNT(GROUP))+1,GRPCNT(GROUP,STS)=$G(GRPCNT(GROUP,STS))+1
"RTN","PSOPMP0",130,0)
 ;
"RTN","PSOPMP0",131,0)
 S GROUP=""
"RTN","PSOPMP0",132,0)
 F  S GROUP=$O(GRPCNT(GROUP)) Q:GROUP=""  D
"RTN","PSOPMP0",133,0)
 . S ^TMP("PSOPMPSR",$J,GROUP)=$G(GRPCNT(GROUP))
"RTN","PSOPMP0",134,0)
 . S STS="" F  S STS=$O(GRPCNT(GROUP,STS)) Q:STS=""  D
"RTN","PSOPMP0",135,0)
 . . S ^TMP("PSOPMPSR",$J,GROUP,STS)=GRPCNT(GROUP,STS)
"RTN","PSOPMP0",136,0)
 ;
"RTN","PSOPMP0",137,0)
 ;Loading pending orders (file #52.41)
"RTN","PSOPMP0",138,0)
 S ORD=0,GROUP=$P(PSORDSEQ("P"),"^")_"P^"_$P(PSORDSEQ("P"),"^",2)
"RTN","PSOPMP0",139,0)
 F  S ORD=$O(^PS(52.41,"P",PSODFN,ORD)) Q:'ORD  D
"RTN","PSOPMP0",140,0)
 . S TYPE=$$GET1^DIQ(52.41,ORD,2,"I")
"RTN","PSOPMP0",141,0)
 . I TYPE="DC"!(TYPE="DE")!(TYPE="HD") Q
"RTN","PSOPMP0",142,0)
 . S DRNAME="",DRUG=+$$GET1^DIQ(52.41,ORD,11,"I") I DRUG S DRNAME=$$GET1^DIQ(50,DRUG,.01)
"RTN","PSOPMP0",143,0)
 . I DRNAME="" D  Q:DRNAME=""
"RTN","PSOPMP0",144,0)
 . . S OI=$$GET1^DIQ(52.41,ORD,8,"I") I 'OI Q
"RTN","PSOPMP0",145,0)
 . . S DRNAME=$$GET1^DIQ(50.7,OI,.01)_" "_$$GET1^DIQ(50.7,OI,.02)
"RTN","PSOPMP0",146,0)
 . S QTY=$$GET1^DIQ(52.41,ORD,12)
"RTN","PSOPMP0",147,0)
 . S STATUS=$$GET1^DIQ(52.41,ORD,2,"I")
"RTN","PSOPMP0",148,0)
 . S ISSDT=$$ISSDT^PSOPMP1(ORD,"P")
"RTN","PSOPMP0",149,0)
 . S REFREM=$$GET1^DIQ(52.41,ORD,13)
"RTN","PSOPMP0",150,0)
 . S DAYSUP=$$GET1^DIQ(52.41,ORD,101)
"RTN","PSOPMP0",151,0)
 . S RFRX="" I STATUS="RF" S RFRX=$$GET1^DIQ(52.41,ORD,21,"I") I RFRX S RFRX=$$GET1^DIQ(52,RFRX,.01)
"RTN","PSOPMP0",152,0)
 . S Z="",$P(Z,"^")=ORD,$P(Z,"^",3)=$E(DRNAME,1,45),$P(Z,"^",4)=QTY,$P(Z,"^",5)=$E(STATUS,1,2)_$$CMOP^PSOPMP1(DRUG)
"RTN","PSOPMP0",153,0)
 . S $P(Z,"^",6)=$S(RFRX'="":"Rx#: "_RFRX,1:$P(ISSDT,"^",2)),$P(Z,"^",8)=REFREM,$P(Z,"^",9)=DAYSUP
"RTN","PSOPMP0",154,0)
 . S SORT=$S(FIELD="RX":DRNAME_ORD,FIELD="DR":DRNAME_ORD,FIELD="ID":+ISSDT_ORD,FIELD="LF":+ISSDT_ORD)
"RTN","PSOPMP0",155,0)
 . S ^TMP("PSOPMPSR",$J,GROUP,"<NULL>",SORT)=Z
"RTN","PSOPMP0",156,0)
 . S GRPCNT(GROUP)=$G(GRPCNT(GROUP))+1
"RTN","PSOPMP0",157,0)
 S:$G(GRPCNT(GROUP)) ^TMP("PSOPMPSR",$J,GROUP)=$G(GRPCNT(GROUP))
"RTN","PSOPMP0",158,0)
 ;
"RTN","PSOPMP0",159,0)
 ;Loading Non-VA Med orders (file #55, sub-file #55.05)
"RTN","PSOPMP0",160,0)
 S ORD=0,GROUP=$P(PSORDSEQ("N"),"^")_"N^"_$P(PSORDSEQ("N"),"^",2)
"RTN","PSOPMP0",161,0)
 F  S ORD=$O(^PS(55,PSODFN,"NVA",ORD)) Q:'ORD  D
"RTN","PSOPMP0",162,0)
 . I $$GET1^DIQ(55.05,ORD_","_PSODFN,5,"I") Q
"RTN","PSOPMP0",163,0)
 . S DRNAME=$$GET1^DIQ(55.05,ORD_","_PSODFN,1)
"RTN","PSOPMP0",164,0)
 . I DRNAME="" D  Q:DRNAME=""
"RTN","PSOPMP0",165,0)
 . . S OI=$$GET1^DIQ(55.05,ORD_","_PSODFN,.01,"I") I 'OI Q
"RTN","PSOPMP0",166,0)
 . . S DRNAME=$$GET1^DIQ(50.7,OI,.01)_" "_$$GET1^DIQ(50.7,OI,.02)
"RTN","PSOPMP0",167,0)
 . S DOCDAT=$P($$GET1^DIQ(55.05,ORD_","_PSODFN_",",11,"I"),".")
"RTN","PSOPMP0",168,0)
 . S Z="",$P(Z,"^")=ORD,$P(Z,"^",3)=$E(DRNAME,1,38),$P(Z,"^",7)=$$DAT^PSOPMP1(DOCDAT,"-")
"RTN","PSOPMP0",169,0)
 . S SORT=$S(FIELD="RX":DRNAME_ORD,FIELD="DR":DRNAME_ORD,FIELD="ID":DOCDAT_ORD,FIELD="LF":DOCDAT_ORD)
"RTN","PSOPMP0",170,0)
 . S ^TMP("PSOPMPSR",$J,GROUP,"<NULL>",SORT)=Z
"RTN","PSOPMP0",171,0)
 . S GRPCNT(GROUP)=$G(GRPCNT(GROUP))+1
"RTN","PSOPMP0",172,0)
 ;
"RTN","PSOPMP0",173,0)
 S:$G(GRPCNT(GROUP)) ^TMP("PSOPMPSR",$J,GROUP)=$G(GRPCNT(GROUP))
"RTN","PSOPMP0",174,0)
 Q
"RTN","PSOPMP0",175,0)
 ;
"RTN","PSOPMP0",176,0)
RX ;Sort by Rx
"RTN","PSOPMP0",177,0)
 D SORT("RX")
"RTN","PSOPMP0",178,0)
 Q
"RTN","PSOPMP0",179,0)
DR ;Sort by Drug
"RTN","PSOPMP0",180,0)
 D SORT("DR")
"RTN","PSOPMP0",181,0)
 Q
"RTN","PSOPMP0",182,0)
ID ;Sort by Issue Date
"RTN","PSOPMP0",183,0)
 D SORT("ID")
"RTN","PSOPMP0",184,0)
 Q
"RTN","PSOPMP0",185,0)
LF ;Sort by Last Fill Date
"RTN","PSOPMP0",186,0)
 D SORT("LF")
"RTN","PSOPMP0",187,0)
 Q
"RTN","PSOPMP0",188,0)
 ;
"RTN","PSOPMP0",189,0)
SORT(FIELD) ;Sort entries by FIELD
"RTN","PSOPMP0",190,0)
 I PSOSRTBY=FIELD S PSORDER=$S(PSORDER="A":"D",1:"A")
"RTN","PSOPMP0",191,0)
 E  S PSOSRTBY=FIELD,PSORDER="A"
"RTN","PSOPMP0",192,0)
 D REF
"RTN","PSOPMP0",193,0)
 Q
"RTN","PSOPMP0",194,0)
 ;
"RTN","PSOPMP0",195,0)
REF ;Screen Refresh
"RTN","PSOPMP0",196,0)
 W ?52,"Please wait..." D INIT,HDR S VALMBCK="R"
"RTN","PSOPMP0",197,0)
 Q
"RTN","PSOPMP0",198,0)
GS ;Group by Status
"RTN","PSOPMP0",199,0)
 W ?52,"Please wait..." S PSOSTSGP=$S($G(PSOSTSGP):0,1:1) D INIT,HDR S VALMBCK="R"
"RTN","PSOPMP0",200,0)
 Q
"RTN","PSOPMP0",201,0)
SIG ;Display SIG
"RTN","PSOPMP0",202,0)
 W ?52,"Please wait..." S PSOSIGDP=$S($G(PSOSIGDP):0,1:1) D INIT,HDR S VALMBCK="R"
"RTN","PSOPMP0",203,0)
 I 'PSOSIGDP S VALMBG=VALMBG\2
"RTN","PSOPMP0",204,0)
 I PSOSIGDP S VALMBG=VALMBG*2-1
"RTN","PSOPMP0",205,0)
 S:VALMBG>(VALMCNT-10) VALMBG=VALMCNT-10 S:VALMBG<1 VALMBG=1
"RTN","PSOPMP0",206,0)
 Q
"RTN","PSOPMP0",207,0)
PI ;Patient Information
"RTN","PSOPMP0",208,0)
 D EN^PSOLMPI S VALMBCK="R"
"RTN","PSOPMP0",209,0)
 Q
"RTN","PSOPMP0",210,0)
CV ;Change View
"RTN","PSOPMP0",211,0)
 D LST^PSOPMPPF(SITE,DUZ) W !?52,"Please wait..." D INIT,HDR
"RTN","PSOPMP0",212,0)
 S VALMBG=1,VALMBCK="R"
"RTN","PSOPMP0",213,0)
 Q
"RTN","PSOPMP0",214,0)
 ;
"RTN","PSOPMP0",215,0)
SEL ;Process selection of one entry
"RTN","PSOPMP0",216,0)
 N PSOSEL,TYPE,XQORM,ORD,TITLE,PSOLIS,XX
"RTN","PSOPMP0",217,0)
 S PSOLIS=$P(XQORNOD(0),"=",2) I 'PSOLIS S VALMSG="Invalid selection!",VALMBCK="R" Q
"RTN","PSOPMP0",218,0)
 F XX=1:1:$L(PSOLIS,",") Q:$P(PSOLIS,",",XX)']""  D
"RTN","PSOPMP0",219,0)
 .S PSOSEL=+$P(PSOLIS,",",XX) I 'PSOSEL S VALMSG="Invalid selection!",VALMBCK="R" Q
"RTN","PSOPMP0",220,0)
 .S TYPE=$O(^TMP("PSOPMP0",$J,PSOSEL,0)) I TYPE="" S VALMSG="Invalid selection!",VALMBCK="R" Q
"RTN","PSOPMP0",221,0)
 .S ORD=$G(^TMP("PSOPMP0",$J,PSOSEL,TYPE))
"RTN","PSOPMP0",222,0)
 .I 'ORD S VALMSG="Invalid selection!",VALMBCK="R" Q
"RTN","PSOPMP0",223,0)
 .S TITLE=VALM("TITLE")
"RTN","PSOPMP0",224,0)
 .;
"RTN","PSOPMP0",225,0)
 .;Regular prescription
"RTN","PSOPMP0",226,0)
 .I TYPE="RX" D  S VALMBCK="R" D REF
"RTN","PSOPMP0",227,0)
 .. N PSOVDA,PSOSAVE,DA,PS
"RTN","PSOPMP0",228,0)
 .. S (PSOVDA,DA)=ORD,PS="REJECTMP"
"RTN","PSOPMP0",229,0)
 .. N LINE,TITLE,PSODFN D DP^PSORXVW
"RTN","PSOPMP0",230,0)
 .;
"RTN","PSOPMP0",231,0)
 .;Pending Order
"RTN","PSOPMP0",232,0)
 .I TYPE="PEN" D  S VALMBCK="R" D REF
"RTN","PSOPMP0",233,0)
 .. N PSOACTOV,OR0
"RTN","PSOPMP0",234,0)
 .. S OR0=^PS(52.41,ORD,0),PSOACTOV=""
"RTN","PSOPMP0",235,0)
 .. N LINE,TITLE D PENHDR^PSOPMP1(PSODFN),DSPL^PSOORFI1
"RTN","PSOPMP0",236,0)
 .;
"RTN","PSOPMP0",237,0)
 .;Pending Order
"RTN","PSOPMP0",238,0)
 .I TYPE="NVA" D
"RTN","PSOPMP0",239,0)
 .. N LINE,TITLE D EN^PSONVAVW(PSODFN,ORD)
"RTN","PSOPMP0",240,0)
 .;
"RTN","PSOPMP0",241,0)
 S VALMBCK="R",VALM("TITLE")=TITLE
"RTN","PSOPMP0",242,0)
 Q
"RTN","PSOPMP0",243,0)
 ;
"RTN","PSOPMP0",244,0)
EXIT ;
"RTN","PSOPMP0",245,0)
 K ^TMP("PSOPMP0",$J),^TMP("PSOPMPSR",$J)
"RTN","PSOPMP0",246,0)
 Q
"RTN","PSOPMP0",247,0)
 ;
"RTN","PSOPMP0",248,0)
HELP Q
"RTN","PSORXEDT")
0^3^B52436750
"RTN","PSORXEDT",1,0)
PSORXEDT ;BIR/SAB - edit rx routine ;10/21/98
"RTN","PSORXEDT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**21,23,44,71,146,185,148,253,390,372,416,313,427,422,402,500**;DEC 1997;Build 9
"RTN","PSORXEDT",3,0)
 ;External Reference to ^PS(55 supported by DBIA 2228
"RTN","PSORXEDT",4,0)
 ;External reference to $$BSA^PSSDSAPI supported by DBIA 5425
"RTN","PSORXEDT",5,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) G EOJ Q
"RTN","PSORXEDT",6,0)
 K PSODRUG,PSOLIST,DIR,DIRUT,DUOUT,X,Y,PSOFROM,^TMP("PSOBEDT",$J),NOPP,CLOZPST,PSOTITRX,PSOMTFLG
"RTN","PSORXEDT",7,0)
 N PSOODOSP
"RTN","PSORXEDT",8,0)
 W !! S DIR(0)="FAO^1:245",DIR("A")="Edit Rx(s) => ",DIR("?",1)="Enter Rx Number or A List of numbers Separated",DIR("?")="by Commas, e.g. 1234A,345,937002Q."
"RTN","PSORXEDT",9,0)
 D ^DIR K DIR G:$D(DIRUT) EOJ
"RTN","PSORXEDT",10,0)
 S END=$L(X,","),BAD=0
"RTN","PSORXEDT",11,0)
 F I=1:1:END S RXM=$P(X,",",I) I +RXM F J=I+1:1:END S DUP=$P(X,",",J) I DUP=RXM S $P(X,",",J)="" W !?5,$C(7),"Duplicate Rx # "_RXM_"  was found in your list, ignoring it!",! S BAD=1
"RTN","PSORXEDT",12,0)
 S PSORLST=$P(X,",") F I=2:1:END S RXM=$P(X,",",I) S:RXM'?1.N.A BAD=1 I RXM?1.N.A S PSORLST=PSORLST_","_RXM
"RTN","PSORXEDT",13,0)
 F I=1:1:$L(PSORLST) S RXM=$P(PSORLST,",",I) I +RXM F J=I+1:1:END S DUP=$P(PSORLST,",",J) I DUP=RXM S $P(PSORLST,",",J)=""
"RTN","PSORXEDT",14,0)
BAD I PSORLST D  I 'Y K Y G PSORXEDT
"RTN","PSORXEDT",15,0)
 .W !?15,"=> "_PSORLST
"RTN","PSORXEDT",16,0)
 .K DIR,DIRUT S DIR(0)="Y",DIR("A")="Is this OKAY ",DIR("B")="Yes"
"RTN","PSORXEDT",17,0)
 .D ^DIR K DIR
"RTN","PSORXEDT",18,0)
 .I 'Y!$D(DIRUT) K X,PSORLST,BAD
"RTN","PSORXEDT",19,0)
 K BAD I 'PSORLST K PSORLST G PSORXEDT
"RTN","PSORXEDT",20,0)
 F I=1:1:$L(PSORLST,",") S RXM=$P(PSORLST,",",I) S GOOD=$D(^PSRX("B",RXM)) D
"RTN","PSORXEDT",21,0)
 .I 'GOOD W !!?5,"Couldn't Find RX # "_RXM H 3 Q
"RTN","PSORXEDT",22,0)
 .S RXN=$O(^PSRX("B",RXM,0)) D  I $P(^PSRX(RXN,"STA"),"^")=13 W !!?5,"Rx # "_RXM_" is marked for Deletion." H 3 Q
"RTN","PSORXEDT",23,0)
 ..I $G(RXN),$P($G(^PS(55,+$P($G(^PSRX(RXN,0)),"^",2),0)),"^",6)'=2 S PSOLOUD=1 D EN^PSOHLUP(+$P($G(^PSRX(RXN,0)),"^",2)) K PSOLOUD
"RTN","PSORXEDT",24,0)
 .D LIST K GOOD
"RTN","PSORXEDT",25,0)
 K GOOD,END
"RTN","PSORXEDT",26,0)
EPH ; - Entry for Epharmacy Rx Edit (PSOREJP1)
"RTN","PSORXEDT",27,0)
 F PSOT1=1:1 Q:'$D(PSOLIST(PSOT1))  F PSOLST2=1:1:$L(PSOLIST(PSOT1),",") S ORN=$P(PSOLIST(PSOT1),",",PSOLST2) D:+ORN PT
"RTN","PSORXEDT",28,0)
 ;
"RTN","PSORXEDT",29,0)
 ; If variable PSOREJCT is set, this means the EPH entry point was called by the EDIT action in the ePharmacy
"RTN","PSORXEDT",30,0)
 ;   Reject Info Screen. The variable will hold the RX IEN. If the Fill Date is the current date or in the
"RTN","PSORXEDT",31,0)
 ;   future (whether it has been edited or not) and the RX is not already suspended, put the Rx on the list
"RTN","PSORXEDT",32,0)
 ;   to get the QUEUE prompt. Since the EDIT action only sends one RX, we can just set the array and not
"RTN","PSORXEDT",33,0)
 ;   worry about appending to an exiting list.
"RTN","PSORXEDT",34,0)
 I $G(PSOREJCT),$$RXFLDT^PSOBPSUT(+PSOREJCT,$P(PSOREJCT,U,2))'<$$DT^XLFDT,$$GET1^DIQ(52,+PSOREJCT_",",100,"I")'=5 S PSORX("PSOL",1)=+PSOREJCT
"RTN","PSORXEDT",35,0)
 ;call to add bingo board data to file 52.11
"RTN","PSORXEDT",36,0)
 K POP,PSOLIST,TM,TM1 G:'$O(PSORX("PSOL",0)) NX
"RTN","PSORXEDT",37,0)
 D:$G(PSORX("PSOL",1))]"" ^PSORXL K PSORX G:$G(NOBG) NX
"RTN","PSORXEDT",38,0)
PRF G:'$P(PSOPAR,"^",8)!($G(NOPP)="H")!($G(NOPP)="S")!('$D(^TMP("PSOBEDT",$J))) BBG
"RTN","PSORXEDT",39,0)
 I $O(^TMP("PSOBEDT",$J,0)),$P(PSOPAR,"^",8) S PSOFROM="NEW",PSOION=ION K RXRS
"RTN","PSORXEDT",40,0)
 G:$D(PSOPROP)&($G(PSOPROP)'=ION) QUP
"RTN","PSORXEDT",41,0)
 I '$D(PSOPROP)!($G(PSOPROP)=ION) D  G:$G(POP)!($E(IOST)["C")!(PSOION=ION) BBG
"RTN","PSORXEDT",42,0)
 .S PSOION=ION W !,"Profiles must be sent to Printer !!",! K IOP,%ZIS,IO("Q"),POP
"RTN","PSORXEDT",43,0)
 .S %ZIS="MNQ",%ZIS("A")="Select Profile Device: " D ^%ZIS K %ZIS("A")
"RTN","PSORXEDT",44,0)
 .Q:$G(POP)!($E(IOST)["C")!(PSOION=ION)  S PSOPROP=ION
"RTN","PSORXEDT",45,0)
QUP S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X,HOLDRPAS=$G(PSOPRPAS),PSOPRPAS=$P(PSOPAR,"^",13)
"RTN","PSORXEDT",46,0)
 F DFN=0:0 S DFN=$O(^TMP("PSOBEDT",$J,DFN)) Q:'DFN  S PPL=^TMP("PSOBEDT",$J,DFN,0) D
"RTN","PSORXEDT",47,0)
 .S ZTRTN="DQ^PSOPRF",ZTIO=PSOPROP,ZTDESC="Outpatient Pharmacy Patient Profiles",ZTDTH=$H
"RTN","PSORXEDT",48,0)
 .F G="PSOPAR","PSODTCUT","PSOPRPAS","DFN","PSOSITE","NEW1","NEW11","PSOBMST","PFIO","PPL" S:$D(@G) ZTSAVE(G)=""
"RTN","PSORXEDT",49,0)
 .D ^%ZTLOAD
"RTN","PSORXEDT",50,0)
 W:$D(ZTSK) !,"PROFILE(S) QUEUED to PRINT",!! K G,ZTSK D ^%ZISC
"RTN","PSORXEDT",51,0)
 S PSOPRPAS=$G(HOLDRPAS) K:PSOPRPAS']"" PSOPRPAS K HOLDRPAS
"RTN","PSORXEDT",52,0)
BBG K DFN F PSODFN=0:0 S PSODFN=$O(^TMP("PSOBEDT",$J,PSODFN)) Q:'PSODFN  I $G(^TMP("PSOBEDT",$J,PSODFN,1)),$D(DISGROUP) S TM=$P($G(^TMP("PSOBB",$J)),"^"),TM1=$P($G(^($J)),"^",2),PPL=^TMP("PSOBEDT",$J,PSODFN,0) D ^PSOBING1
"RTN","PSORXEDT",53,0)
NX ;
"RTN","PSORXEDT",54,0)
 K %X,%Y,ACTREF,ACTREN,D,D0,DAT,DFN,DIC,DIQ,DQ,DRG,END,FDR,PSOBEDT,TM,TM1,PSOT1,PSOLST2,NOBG,BBFLG,BINGCRT,BINGRTE,C,CC,CMOP,COM,CT,D1,DI,DREN,BBRX,PSOFROM,POP,PSORX("QFLG"),IT,PSOERR,PSOBCK,PSOBM,PPL
"RTN","PSORXEDT",55,0)
 K ^TMP("PSOBEDT",$J),^TMP("PSOBB",$J),ZTSK,NOPP,VALMSG,VALMBCK D EOJ
"RTN","PSORXEDT",56,0)
END Q
"RTN","PSORXEDT",57,0)
 ;---------------------------------------------------------
"RTN","PSORXEDT",58,0)
PT ;
"RTN","PSORXEDT",59,0)
 N PSOTXEDT,PSOTPEXT S PSOTXEDT=$P($G(^PSRX(ORN,0)),"^",2) I PSOTXEDT I $D(^PS(52.91,PSOTXEDT,0)) I '$P(^PS(52.91,PSOTXEDT,0),"^",3)!($P(^(0),"^",3)>DT) D PDIR^PSOTPCAN(PSOTXEDT) I $G(PSOTPEXT) K PSOTPEXT,PSOTXEDT D EOJ Q
"RTN","PSORXEDT",60,0)
 K PSOTXEDT,PSOTPEXT
"RTN","PSORXEDT",61,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSORXEDT",62,0)
 S $P(PSOLST(ORN),"^",2)=ORN,(PSOBEDT)=1
"RTN","PSORXEDT",63,0)
 S (DFN,PSODFN)=+$P(^PSRX(ORN,0),"^",2),PSORX("NAME")=$P(^DPT(DFN,0),"^") I PSODFN'=$G(PSOODOSP) K PSORX("DOSING OFF") S PSOODOSP=PSODFN
"RTN","PSORXEDT",64,0)
 D ICN^PSODPT(DFN)
"RTN","PSORXEDT",65,0)
 S RX0=^PSRX(ORN,0),RX2=$G(^(2)),RX3=$G(^(3))
"RTN","PSORXEDT",66,0)
 N PSOCHK S PSOCHK=$$CHK^PSODPT(PSODFN,1,1)  ;*422
"RTN","PSORXEDT",67,0)
 I PSOCHK=-1 D EOJ Q  ;*422
"RTN","PSORXEDT",68,0)
 D:$G(DUZ("AG"))="V" COPAY^PSOPTPST ; Deals with copay
"RTN","PSORXEDT",69,0)
 K ^TMP("PSOHDR",$J),^TMP("PSOPI",$J) D ^VADPT,ADD^VADPT
"RTN","PSORXEDT",70,0)
 S ^TMP("PSOHDR",$J,1,0)=VADM(1),^TMP("PSOHDR",$J,2,0)=$P(VADM(2),"^",2)
"RTN","PSORXEDT",71,0)
 S ^TMP("PSOHDR",$J,3,0)=$P(VADM(3),"^",2)
"RTN","PSORXEDT",72,0)
 S ^TMP("PSOHDR",$J,4,0)=VADM(4),^TMP("PSOHDR",$J,5,0)=$P(VADM(5),"^",2)
"RTN","PSORXEDT",73,0)
 S POERR=1 D RE^PSODEM K POERR,VALMBCK
"RTN","PSORXEDT",74,0)
 S ^TMP("PSOHDR",$J,6,0)=$S($P(WT,"^",8):$P(WT,"^",9)_" ("_$P(WT,"^")_")",1:"_______ (______)")
"RTN","PSORXEDT",75,0)
 S ^TMP("PSOHDR",$J,7,0)=$S($P(HT,"^",8):$P(HT,"^",9)_" ("_$P(HT,"^")_")",1:"_______ (______)") K VM,WT,HT S PSOHD=7
"RTN","PSORXEDT",76,0)
 S ^TMP("PSOHDR",$J,9,0)="",^TMP("PSOHDR",$J,10,0)=""
"RTN","PSORXEDT",77,0)
 S GMRA="0^0^111" D ^GMRADPT S ^TMP("PSOHDR",$J,8,0)=+$G(GMRAL)
"RTN","PSORXEDT",78,0)
 ;
"RTN","PSORXEDT",79,0)
 ; Display CrCl/BSA - show serum creatinine if CrCl can't be calculated
"RTN","PSORXEDT",80,0)
 S PSOBSA=$$BSA^PSSDSAPI(DFN),PSOBSA=$P(PSOBSA,"^",3),PSOBSA=$S(PSOBSA'>0:"_______",1:$J(PSOBSA,4,2)) S ^TMP("PSOHDR",$J,12,0)=PSOBSA
"RTN","PSORXEDT",81,0)
 S RSLT=$$CRCL^PSOORUT2(DFN)
"RTN","PSORXEDT",82,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)<.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_" (CREAT: Not Found)"
"RTN","PSORXEDT",83,0)
 I ($P($G(RSLT),"^",2)["Not Found")&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"  (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSORXEDT",84,0)
 I ($P($G(RSLT),"^",2)>0)&($P($G(RSLT),"^",3)>.01) S ZDSPL="  CrCL: "_$P(RSLT,"^",2)_"(est.)"_" (CREAT: "_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSORXEDT",85,0)
 S ^TMP("PSOHDR",$J,13,0)=ZDSPL
"RTN","PSORXEDT",86,0)
 K PSOBSA,RSLT,ZDSPL
"RTN","PSORXEDT",87,0)
 ;
"RTN","PSORXEDT",88,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSORXEDT",89,0)
 S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSORXEDT",90,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^")
"RTN","PSORXEDT",91,0)
 D CLEAR^VALM1
"RTN","PSORXEDT",92,0)
 S STA="ACTIVE^NON-VERIFIED^REFILL^HOLD^NON-VERIFIED^SUSPENDED^^^^^^EXPIRED^DISCONTINUED^^DISCONTINUED^DISCONTINUED^HOLD"
"RTN","PSORXEDT",93,0)
 S $P(PSOLST(ORN),"^",3)=$P(STA,"^",$P(^PSRX(ORN,"STA"),"^")+1),PSLST=ORN,ORD=1
"RTN","PSORXEDT",94,0)
 D ACT^PSOORNE2
"RTN","PSORXEDT",95,0)
EOJ ;
"RTN","PSORXEDT",96,0)
 K INS1,HDR,IK,INDT,LOG,NODE,ORN,P1,PSI,PSL,PSOLION,PSNP,PSOACT,PSOBM,PSOCLC,PSOCNT,PSODD,PSODFN,PSOHD,PSOJ,PSOLST,PSOOI,PSOPF,PSLST
"RTN","PSORXEDT",97,0)
 K PSOIBQS,PSORLST,PSOSD,PSOSIG,PSPRXN,PSORX0,PSORX1,PTST,REFL,RF,RFD,RIFN,RLD,RPH,RTS,RX0,RX1,RX2,RX3,RXM,RXOR,SIG,SIGOK
"RTN","PSORXEDT",98,0)
 D KVA^VADPT K SLPPL,ST,STA,^TMP("PS",$J),PSOQFLG,PSORXED,PSOEDIT,DIR,DIRUT,DUOUT,DTOUT,PSOLOUD,GMRAL,GG,FEV,ACNT
"RTN","PSORXEDT",99,0)
 D FULL^VALM1 K ^TMP("PSOAL",$J),^TMP("PSOAO",$J),^TMP("PSOSF",$J),^TMP("PSOPF",$J),^TMP("PSOPI",$J),^TMP("PSOPO",$J),^TMP("PSOHDR",$J),PAT
"RTN","PSORXEDT",100,0)
 K JJ,K,MM,PSDAYS,PSOAC,PSOAL,PSOCOU,PSOCOUU,PSONEW,PSODRUG,PSONOOR,PSRX0,QTY,REA,RFCNT,RFDT,RXDA,RXFL,RXREF,SUB,X,Z,ZII
"RTN","PSORXEDT",101,0)
 K ACOM,CRIT,DA,DDH,DGI,DGS,PSONEW3,SER,SERS,ZONE,RN,RXN,PSOX,PSOERR,ORD,PSOBCK,PSOBILL,SURX,PSORX("QFLG"),PSORX("FN"),CLOZPAT
"RTN","PSORXEDT",102,0)
 Q
"RTN","PSORXEDT",103,0)
LIST ;
"RTN","PSORXEDT",104,0)
 I $G(^PSRX(RXN,0))']"" W !,$C(7),"Rx data is not on file !",! G LISTX
"RTN","PSORXEDT",105,0)
 I $P(^PSRX(RXN,0),"^",15)=13 S PSVD=1 W !,$C(7),"Rx # "_RXM_" has been deleted."
"RTN","PSORXEDT",106,0)
 S RXN1=RXN,RXM1=RXM D:'$G(PSVD) LST1 W "." S RXN=RXN1,RXM=RXM1 K RXN1,RXM1
"RTN","PSORXEDT",107,0)
 F  S RXN=$O(^PSRX("B",RXM,RXN)) Q:'RXN  D
"RTN","PSORXEDT",108,0)
 .I $G(^PSRX(RXN,0))']"" Q
"RTN","PSORXEDT",109,0)
 .I $P(^PSRX(RXN,0),"^",15)=13 Q
"RTN","PSORXEDT",110,0)
 .D LST1
"RTN","PSORXEDT",111,0)
 K RXN1 G LISTX
"RTN","PSORXEDT",112,0)
 Q
"RTN","PSORXEDT",113,0)
LST1 I $G(PSOLIST(1))']"" S PSOLIST(1)=RXN_"," G LISTX
"RTN","PSORXEDT",114,0)
 F PSOX1=0:0 S PSOX1=$O(PSOLIST(PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSORXEDT",115,0)
 I $L(PSOLIST(PSOX2))+$L(RXN)<220 S:RXN_","'[PSOLIST(PSOX2) PSOLIST(PSOX2)=PSOLIST(PSOX2)_RXN_","
"RTN","PSORXEDT",116,0)
 E  S:RXN_","'[PSOLIST(PSOX2+1) PSOLIST(PSOX2+1)=RXN_","
"RTN","PSORXEDT",117,0)
LISTX K PSOX1,PSOX2,RXN,PSVD
"RTN","PSORXEDT",118,0)
 Q
"RTN","PSOSD1")
0^14^B48994823
"RTN","PSOSD1",1,0)
PSOSD1 ;BHAM ISC/SAB/JMB - action or informational profile cont. ; 10/30/07 10:39am
"RTN","PSOSD1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**2,17,19,22,40,49,66,107,110,132,233,258,240,320,326,360,500**;DEC 1997;Build 9
"RTN","PSOSD1",3,0)
 ;External reference to ^PS(59.7 is supported by DBIA 694
"RTN","PSOSD1",4,0)
 ;
"RTN","PSOSD1",5,0)
INIT N PSOPTLK
"RTN","PSOSD1",6,0)
 S PRF="" F PSOI=0:0 S DIC(0)="QEAM" D EN^PSOPATLK S Y=PSOPTLK Q:Y<1  D
"RTN","PSOSD1",7,0)
 .S PRF=PRF_+Y_",",DFN=+Y D DEM^VADPT I +VADM(6) W !,"Patient Expired on "_$P(VADM(6),"^",2),! S DOD(DFN)=$P(VADM(6),"^",2) K DFN
"RTN","PSOSD1",8,0)
 .I $L(PRF)>240 W !,$C(7),"MAX NUMBER OF PATIENTS HAS BEEN REACHED" Q
"RTN","PSOSD1",9,0)
 Q:'$L(PRF)  D DAYS G:$D(DUOUT)!($D(DTOUT)) EXIT^PSOSD
"RTN","PSOSD1",10,0)
DEV N PSOBARS,PSOBAR0,PSOBAR1 K %ZIS,IOP,ZTSK,ZTQUEUED S PSOION=ION,%ZIS="QM",%ZIS("B")="",%ZIS("A")=$S(PSTYPE:"Select a Printer: ",1:"DEVICE: ") D ^%ZIS K %ZIS I POP S IOP=PSOION D ^%ZIS K IOP,PSOION G EXIT
"RTN","PSOSD1",11,0)
 I $E(IOST)["C",PSTYPE D ^%ZISC W $C(7),!!,"Action Profiles MUST BE SENT TO A PRINTER !!",!,"ONLY INFORMATIONAL PROFILES ARE ALLOWED TO PRINT TO SCREEN !!",! G DEV
"RTN","PSOSD1",12,0)
 S PSOIOS=IOS D DEVBAR^PSOBMST S PSOBAR2=PSOBAR0,PSOBAR3=PSOBAR1
"RTN","PSOSD1",13,0)
 S PSOBAR4=$G(PSOBAR3)]""&($G(PSOBAR2)]"")&(+$P($G(PSOPAR),"^"))
"RTN","PSOSD1",14,0)
 K PSOION I $D(IO("Q")) S ZTDESC="Outpatient Pharmacy Action Profile",ZTRTN="START^PSOSD1",ZTSAVE("ZTREQ")="@" D  D EXIT Q:$G(LM)  G ^PSOSD
"RTN","PSOSD1",15,0)
 .F G="PSORM","PSOPOL","PSONUM","PSOSYS","PSOINST","PSOBAR3","PSOBAR4","PSOBAR2","PSOPAR","PSOPAR7","PRF","PSDAYS","PSDATE","PSTYPE","PSOSITE","PSDATE","PSDAY" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOSD1",16,0)
 .S ZTSAVE("DOD*")="",ZTSAVE("PSOBAR*")="" D ^%ZTLOAD W:$D(ZTSK) !,"Report Queued to Print !!",! K:'$G(LM) ZTSK,IO("Q")
"RTN","PSOSD1",17,0)
 D START G:'$G(LM) ^PSOSD
"RTN","PSOSD1",18,0)
 Q
"RTN","PSOSD1",19,0)
START U IO S PSTYPE=$S($D(PSTYPE):PSTYPE,1:0),LINE="",$P(LINE,"-",132)="-"
"RTN","PSOSD1",20,0)
 F PSIX=1:1 S DFN=$P(PRF,",",PSIX) G:DFN']"" EXIT D ELIG S PAGE=1 D  G:$G(PSQFLG)!($D(DTOUT))!($D(DUOUT)) EXIT
"RTN","PSOSD1",21,0)
 .D PAT^PSOSD Q:$D(DTOUT)!($D(DUOUT))  D  Q:PSQFLG  D RXPAD:PSTYPE D ENSTUFF^PSODACT
"RTN","PSOSD1",22,0)
 ..Q:$D(DUOUT)!($D(DTOUT))  S PSQFLG=0 D ^PSOSD3,NVA^PSOSD3,EN^PSORMRXP(DFN)
"RTN","PSOSD1",23,0)
EXIT I '$D(PSONOPG) W ! D ^%ZISC K DFN
"RTN","PSOSD1",24,0)
 W:$D(PSONOPG)&('$D(ORVP)) @IOF
"RTN","PSOSD1",25,0)
 K ^TMP($J,"PRF"),^("ACT"),ADDR,ADDRFL,CLASS,CNDT,CNT,DRUG,CLAPP,HDFL,I,II,J,L,LINE,P,PAGE,PSDOB,PSIIX,PSNAME,PSOI,PSQFLG,PSSN,DFN,PSIX,PAGE,PGM,LINE,PRF,PSTYPE,PSDATE,PSDAYS,VAL,VAR,RX,RX0,RX3,RX2,ST,ST0,PSDAY,RF,RFS,PSOBAR3,PSOBAR4,PSOBAR2
"RTN","PSOSD1",26,0)
 D KVA^VADPT K DOD,FILL,DIC,PSCNT,PSDT,PCLASS,PHYS,ZCLASS,PSOPRINT,RXNODE,DIR,X1,X2,PSONUM,PSOPOLP,PSSN4
"RTN","PSOSD1",27,0)
 Q
"RTN","PSOSD1",28,0)
 ; 
"RTN","PSOSD1",29,0)
DAYS K DIR S DIR("A")="Profile Expiration/Discontinued Cutoff",DIR("B")=120,DIR(0)="N^0:9999:0",DIR("?",1)="Enter the number of days which will cut discontinued and expired Rx's from",DIR("?")="the profile."
"RTN","PSOSD1",30,0)
 D ^DIR Q:$D(DTOUT)!($D(DUOUT))  S PSDAYS=X K DIR S X1=DT,X2=-PSDAYS D C^%DTC S (PSDATE,PSDAY)=X
"RTN","PSOSD1",31,0)
 Q
"RTN","PSOSD1",32,0)
 ;
"RTN","PSOSD1",33,0)
DFN S:'$D(PSORM) PSORM=1
"RTN","PSOSD1",34,0)
 S PSOIOS=IOS D DEVBAR^PSOBMST S PSOBAR2=PSOBAR0,PSOBAR3=PSOBAR1
"RTN","PSOSD1",35,0)
 S PSOBAR4=$G(PSOBAR3)]""&($G(PSOBAR2)]"")&(+$P($G(PSOPAR),"^"))
"RTN","PSOSD1",36,0)
 W:$D(PSONOPG)&($G(PSONOPG)'=2) @IOF I '$G(PSOSITE) S PSOSITE=$O(^PS(59,0))
"RTN","PSOSD1",37,0)
 S PRF=DFN_"," D:'$G(PSDAYS)  G START
"RTN","PSOSD1",38,0)
 .S PSDAYS=120,X1=DT,X2=-PSDAYS D C^%DTC S (PSDATE,PSDAY)=X
"RTN","PSOSD1",39,0)
 Q
"RTN","PSOSD1",40,0)
 ;
"RTN","PSOSD1",41,0)
ELIG S PSOPRINT=""
"RTN","PSOSD1",42,0)
 D ELIG^VADPT
"RTN","PSOSD1",43,0)
 Q:'$D(VAEL(4))
"RTN","PSOSD1",44,0)
 Q:+VAEL(4)'=1
"RTN","PSOSD1",45,0)
 I $D(VAEL(3)),+VAEL(3)=1,($P(VAEL(3),"^",2)<50) S PSOPRINT="SC NSC"
"RTN","PSOSD1",46,0)
 D KVAR^VADPT
"RTN","PSOSD1",47,0)
 Q
"RTN","PSOSD1",48,0)
 ;
"RTN","PSOSD1",49,0)
RXPAD N K Q:$G(DOD(DFN))]""  D HD F CNT=1:1:4 S LF="!?45" D  Q:$Y+14>IOSL
"RTN","PSOSD1",50,0)
 .W !?4,"Name: "_PSNAME,?58,"DOB: "_PSDOB
"RTN","PSOSD1",51,0)
 .W !!,CNT,?4,"Medication: ",LN,$E(LN,1,11),!!?4,"Outpatient Directions: ",LN,!?4
"RTN","PSOSD1",52,0)
 .W $E(LN,1,3),"SC",$E(LN,1,3),"NSC","  Quantity: _____    Days Supply _____   "
"RTN","PSOSD1",53,0)
 .W:'$G(PSORM) @LF W "Refills: 0 1 2 3 4 5 6 7 8 9 10 11"
"RTN","PSOSD1",54,0)
 .W !!?4,$E(LN,1,35)," ",$E(LN,1,14)," ",$E(LN,1,24)
"RTN","PSOSD1",55,0)
 .W !?4,"Provider's Signature",?40,"DEA #",?55,"Date/Time",!!,$E(LINE,1,$S('PSORM:80,1:IOM))
"RTN","PSOSD1",56,0)
 K LF Q
"RTN","PSOSD1",57,0)
 ;
"RTN","PSOSD1",58,0)
HD S FN=DFN S:'$D(PSORM) PSORM=1
"RTN","PSOSD1",59,0)
 D ELIG^PSOSD1,DEM^VADPT,INP^VADPT,ADD^VADPT,PID^VADPT S PSSN=VA("PID"),PSSN4="",ADDRFL=$S(+VAPA(9):"Temporary ",1:"")
"RTN","PSOSD1",60,0)
 I +VADM(6) S DOD(DFN)=$P(VADM(6),"^",2)
"RTN","PSOSD1",61,0)
 S PSNAME=$E(VADM(1),1,28),PSDOB=$P(VADM(3),"^",2) I $D(IOF),$G(PAGE)'=1 W @IOF
"RTN","PSOSD1",62,0)
 W "Action Rx Profile",?47,"Run Date: " S Y=DT D DT^DIO2 W ?71,"Page: "_PAGE S PAGE=PAGE+1,X=$$SITE^VASITE
"RTN","PSOSD1",63,0)
 W !,"Sorted by drug classification for Rx's currently active"_$S('PSDAYS:" only.",1:"") W:PSDAYS !,"and for those Rx's that have been inactive less than "_PSDAYS_" days."
"RTN","PSOSD1",64,0)
 W @$S(PSORM:"?70",1:"!"),"Site: VAMC "_$P(X,"^",2)_" ("_$P(X,"^",3)_")",!,$E(LINE,1,$S('PSORM:80,1:IOM)-1)
"RTN","PSOSD1",65,0)
 I $P(VAIN(4),"^",2)]"",+$P($G(^PS(59.7,1,40.1)),"^") W !,"Outpatient prescriptions are discontinued 72 hours after admission.",!
"RTN","PSOSD1",66,0)
 W !?1,"Name  : ",PSNAME W ?58,"Action Date: ________" W !?1,"DOB   : "_PSDOB
"RTN","PSOSD1",67,0)
 W:ADDRFL]"" ?30,ADDRFL,! W ?30,"Address  :"
"RTN","PSOSD1",68,0)
 I $G(ADDRFL)="" D CHECKBAI
"RTN","PSOSD1",69,0)
 W ?41,VAPA(1) W:VAPA(2)]"" !?41,VAPA(2) W:VAPA(3)]"" !?41,VAPA(3) W !?41,VAPA(4)_", "_$P(VAPA(5),"^",2)_"  "_$S(VAPA(11)]"":$P(VAPA(11),"^",2),1:VAPA(6)),!?30,"Phone    : "_VAPA(8)
"RTN","PSOSD1",70,0)
 I PSOBAR4 S X="S",X2=PSSN W @$S('PSORM:"!?30",1:"?$X+5") S X1=$X W @PSOBAR3,X2,@PSOBAR2,$C(13) S $X=0
"RTN","PSOSD1",71,0)
 S (WT,HT)="",X="GMRVUTL" X ^%ZOSF("TEST") I $T D
"RTN","PSOSD1",72,0)
 .F GMRVSTR="WT","HT" S VM=GMRVSTR D EN6^GMRVUTL S @VM=X,$P(@VM,"^")=$E($P(@VM,"^"),4,5)_"/"_$E($P(@VM,"^"),6,7)_"/"_($E($P(@VM,"^"),1,3)+1700)
"RTN","PSOSD1",73,0)
 .S X=$P(WT,"^",8),Y=$J(X/2.2046226,0,2),$P(WT,"^",9)=Y,X=$P(HT,"^",8),Y=$J(2.54*X,0,2),$P(HT,"^",9)=Y
"RTN","PSOSD1",74,0)
 W !!,"WEIGHT(Kg): " W:+$P(WT,"^",8) $P(WT,"^",9)_" ("_$P(WT,"^")_")" W ?41,"HEIGHT(cm): " W:$P(HT,"^",8) $P(HT,"^",9)_" ("_$P(HT,"^")_")" K VM,WT,HT
"RTN","PSOSD1",75,0)
 D GMRA^PSODEM W !,$E(LINE,1,$S('PSORM:80,1:IOM)-1),!,"Instructions to the provider:",!,"A prescription blank (VA FORM 10-2577f) must be used for All Class II NARCOTICS."
"RTN","PSOSD1",76,0)
 S (ELN,LN,LINE)="",$P(LN,"_",53)="",$P(LINE,"-",132)=""
"RTN","PSOSD1",77,0)
 W !,$E(LINE,1,$S('PSORM:80,1:IOM)-1),!?4,"OTHER MEDICATIONS:",!
"RTN","PSOSD1",78,0)
 Q
"RTN","PSOSD1",79,0)
LM ;prints AP from listamn action
"RTN","PSOSD1",80,0)
 S X=$$SITE^VASITE,PSOINST=$P(X,"^",3) K X
"RTN","PSOSD1",81,0)
 K DIR S DIR("A")="Action or Informational (A or I): ",DIR("?",1)="Enter 'A' for action profile",DIR("?",2)="      'I' for informational profile",DIR("?")="      'E' to EXIT process",DIR("B")="A",DIR(0)="SAM^1:Action;0:Informational;E:Exit"
"RTN","PSOSD1",82,0)
 D ^DIR K DIR Q:Y="E"!($D(DIRUT))  S PSTYPE=Y,LM=1
"RTN","PSOSD1",83,0)
 I '$P($G(PSOSYS),"^",6) S PSOPOL=0 G ASK
"RTN","PSOSD1",84,0)
 K DIR S DIR("A")="Do you want generate a Polypharmacy report?: ",DIR("?",1)="Enter 'Y' to generate report",DIR("?",2)="      'N' if you do not want the report",DIR("?")="      'E' to EXIT process",DIR("B")="NO",DIR(0)="SA^1:YES;0:NO;E:Exit"
"RTN","PSOSD1",85,0)
 D ^DIR S PSOPOL=$S(Y:1,1:0) G:Y="E"!($D(DIRUT)) EXIT G:'PSOPOL ASK
"RTN","PSOSD1",86,0)
 K DIR S DIR("A")="Minimum Number of Active Prescriptions",DIR("B")=7,DIR(0)="N^1:100:0" D ^DIR S PSONUM=Y G:$D(DIRUT) EXIT
"RTN","PSOSD1",87,0)
 K DIR,DTOUT,DIRUT,DUOUT S DIR("A")="Do you want this Profile to print in 132 columns or 80 columns: ",DIR("B")="132",DIR(0)="SAM^1:132;8:80;E:Exit"
"RTN","PSOSD1",88,0)
 D ^DIR G:Y="E"!($D(DUOUT))!($D(DIRUT)) EXIT S PSORM=$S(Y=1:1,1:0) K DIR,X,Y
"RTN","PSOSD1",89,0)
 ;PSO*7*240 Go to exit if DUOUT or DTOUT
"RTN","PSOSD1",90,0)
ASK D DAYS G:($D(DUOUT))!($D(DTOUT)) EXIT S PRF=PSODFN_"," D DEV I $D(ZTSK) S VALMSG="Action Profile Queued to Printer."
"RTN","PSOSD1",91,0)
 D EXIT K LM
"RTN","PSOSD1",92,0)
 Q
"RTN","PSOSD1",93,0)
 ;
"RTN","PSOSD1",94,0)
CHECKBAI ;
"RTN","PSOSD1",95,0)
 N PSOBADR
"RTN","PSOSD1",96,0)
 S PSOBADR=$$BADADR^DGUTL3(DFN)
"RTN","PSOSD1",97,0)
 I 'PSOBADR W " " Q
"RTN","PSOSD1",98,0)
 W ?40,"** BAD ADDRESS INDICATED **",!
"RTN","PSOSD1",99,0)
 Q
"RTN","PSOSD1",100,0)
 ;
"RTN","PSOSD2")
0^15^B29770075
"RTN","PSOSD2",1,0)
PSOSD2 ;BHAM ISC/SAB - action or informational profile cont. ;3/24/93
"RTN","PSOSD2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**2,19,107,110,176,233,258,326,500**;DEC 1997;Build 9
"RTN","PSOSD2",3,0)
 ;External reference to ^PS(59.7 is supported by DBIA 694
"RTN","PSOSD2",4,0)
 ;
"RTN","PSOSD2",5,0)
1 W !,$E(LINE,1,$S('PSORM:80,1:IOM)-1),!
"RTN","PSOSD2",6,0)
 W !,"Instructions to the provider:"
"RTN","PSOSD2",7,0)
 W !,"   A. A prescription blank (VA FORM 10-2577f) must be used for the"
"RTN","PSOSD2",8,0)
 W !,"      following: 1) any new medication"
"RTN","PSOSD2",9,0)
 W !,"                 2) any changes in dosage, direction or quantity"
"RTN","PSOSD2",10,0)
 W !,"                 3) all class II narcotics."
"RTN","PSOSD2",11,0)
 W !,"   B. To continue a medication as printed:"
"RTN","PSOSD2",12,0)
 W !,"      1.  If ""Remaining Refills"" are sufficient to complete"
"RTN","PSOSD2",13,0)
 W !,"          therapy or last until next scheduled clinic appointment,"
"RTN","PSOSD2",14,0)
 W !,"          no action is required."
"RTN","PSOSD2",15,0)
 W !,"      2.  If ""Remaining Refills"" are not sufficient to complete"
"RTN","PSOSD2",16,0)
 W !,"          therapy or last until next scheduled clinic appointment,"
"RTN","PSOSD2",17,0)
 W !,"          sign ""RENEW/MD"" line, enter VA# and date, and circle"
"RTN","PSOSD2",18,0)
 W !,"          total number of refills needed.  This action creates a"
"RTN","PSOSD2",19,0)
 W !,"          new prescription with refills as indicated."
"RTN","PSOSD2",20,0)
 W !,"   C. To discontinue a medication, sign DISCONTINUE/MD line and enter VA# and",@$S(PSORM:"?$X+1",1:"!?6"),"date."
"RTN","PSOSD2",21,0)
 W !,"   D. Any medications not acted upon will continue to be available"
"RTN","PSOSD2",22,0)
 W !,"      to the patient until all refills are used or until expiration."
"RTN","PSOSD2",23,0)
 W !!,"  NOTE: '(R)' indicates a fill was returned to stock."
"RTN","PSOSD2",24,0)
 Q
"RTN","PSOSD2",25,0)
 ;
"RTN","PSOSD2",26,0)
HD S:'$D(PSORM) PSORM=1 N K S FN=DFN
"RTN","PSOSD2",27,0)
 D ELIG^PSOSD1,DEM^VADPT,INP^VADPT,ADD^VADPT,PID^VADPT S PSSN=VA("PID"),ADDRFL=$S(+VAPA(9):"Temporary ",1:"")
"RTN","PSOSD2",28,0)
 I $G(^TMP($J,DFN)),$D(CLINICX) D ^PSOSDP
"RTN","PSOSD2",29,0)
 S PSNAME=$E(VADM(1),1,28),PSDOB=$P(VADM(3),"^",2)
"RTN","PSOSD2",30,0)
 I '$D(PSOBAR0)!('$D(PSOBAR1)) S PSOIOS=IOS D DEVBAR^PSOBMST
"RTN","PSOSD2",31,0)
 S PSOBAR2=PSOBAR0,PSOBAR3=PSOBAR1
"RTN","PSOSD2",32,0)
 S PSOBAR4=$G(PSOBAR3)]""&($G(PSOBAR2)]"")&(+$P($G(PSOPAR),"^"))
"RTN","PSOSD2",33,0)
HD1 S RXCNT=0 I $E(IOST)="C",'PSTYPE K DIR S DIR(0)="E",DIR("A")="Press Return to Continue or ""^"" to Exit" D ^DIR Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOSD2",34,0)
 I $D(IOF) W @IOF
"RTN","PSOSD2",35,0)
 U IO
"RTN","PSOSD2",36,0)
 W $S(PSTYPE:"Action",1:"Informational")_" Rx Profile",?47,"Run Date: " S Y=DT D DT^DIO2 W ?71,"Page: "_PAGE
"RTN","PSOSD2",37,0)
 W !,"Sorted by drug classification for Rx's currently active"_$S('PSDAYS:" only.",1:"") W:PSDAYS !,"and for those Rx's that have been inactive less than "_PSDAYS_" days."
"RTN","PSOSD2",38,0)
 S X=$$SITE^VASITE
"RTN","PSOSD2",39,0)
 W @$S(PSORM:"?70",1:"!"),"Site: VAMC "_$P(X,"^",2)_" ("_$P(X,"^",3)_")",!,$E(LINE,1,$S('PSORM:80,1:IOM)-1)
"RTN","PSOSD2",40,0)
 I $P(VAIN(4),"^",2)]"",+$P($G(^PS(59.7,1,40.1)),"^") W !,"Outpatient prescriptions are discontinued 72 hours after admission.",!
"RTN","PSOSD2",41,0)
 I $D(CLINICX) W !?1,"Clinic: ",$E(CLINICX,1,28),?45,"Date/Time: " S Y=CLDT D DT^DIO2
"RTN","PSOSD2",42,0)
 W !?1,"Name  : ",PSNAME W:PSTYPE ?58,"Action Date: ________" W !?1,"DOB   : "_PSDOB
"RTN","PSOSD2",43,0)
 W:ADDRFL]"" ?30,ADDRFL,! W ?30,"Address  :"
"RTN","PSOSD2",44,0)
 I $G(ADDRFL)="" D CHECKBAI^PSOSD1
"RTN","PSOSD2",45,0)
 W ?41,VAPA(1) W:VAPA(2)]"" !?41,VAPA(2) W:VAPA(3)]"" !?41,VAPA(3)
"RTN","PSOSD2",46,0)
 W !?41,VAPA(4)_", "_$P(VAPA(5),"^",2)_"  "_$S(VAPA(11)]"":$P(VAPA(11),"^",2),1:VAPA(6)),!?30,"Phone    : "_VAPA(8)
"RTN","PSOSD2",47,0)
 I PSOBAR4 S X="S",X2=PSSN W @$S('PSORM:"!?30",1:"?$X+5") S X1=$X W @PSOBAR3,X2,@PSOBAR2,$C(13) S $X=0
"RTN","PSOSD2",48,0)
 W:$G(DOD(DFN))]"" ?1,"**** Date of Death: "_DOD(DFN)_" ****",!
"RTN","PSOSD2",49,0)
 D:'$D(HDFL)
"RTN","PSOSD2",50,0)
 .K DIRUT,DIR,DUOUT,DTOUT D:'$G(CLAPP) RE^PSODEM Q:$D(DIRUT)
"RTN","PSOSD2",51,0)
 .I $Y+15>IOSL,$E(IOST)="C" K DIR S DIR(0)="E" D ^DIR K DIR,DUOUT,DTOUT
"RTN","PSOSD2",52,0)
 .Q:$D(DIRUT)
"RTN","PSOSD2",53,0)
 .K ^UTILITY("VASD",$J),VASD S VASD("F")=DT,VASD("T")=9999999,VASD("W")="123456789" D:$G(DFN)&('$G(CLAPP)) SDA^VADPT K VASD I '$G(CLAPP)&($D(^UTILITY("VASD",$J))) D  S CLAPP=1 D HD:$G(^TMP($J,DFN))'<$G(PSONUM)&($G(PSOPOL))
"RTN","PSOSD2",54,0)
 ..W:$E(IOST)="C" @IOF
"RTN","PSOSD2",55,0)
 ..W !,$E(LINE,1,$S('PSORM:80,1:IOM)-1)
"RTN","PSOSD2",56,0)
 ..S FA=DT W !!,"Pending Outpatient Clinic Appointments:"
"RTN","PSOSD2",57,0)
 ..F PSOACPP=0:0 S PSOACPP=$O(^UTILITY("VASD",$J,PSOACPP)) Q:'PSOACPP  S PSOACPPE=$G(^UTILITY("VASD",$J,PSOACPP,"E")),PSOACPPI=$G(^("I")) W !?11,$P(PSOACPPE,"^"),?35,$P(PSOACPPE,"^",2) D CAPP
"RTN","PSOSD2",58,0)
 ..I $E(IOST)="C" K DIR,DIRUT,DTOUT S DIR(0)="E" D ^DIR K DIR
"RTN","PSOSD2",59,0)
 .E  D:$G(PAGE)>1&('$G(PSOPOL))
"RTN","PSOSD2",60,0)
 ..S (WT,HT)="",X="GMRVUTL" X ^%ZOSF("TEST") I $T D
"RTN","PSOSD2",61,0)
 ...F GMRVSTR="WT","HT" S VM=GMRVSTR D EN6^GMRVUTL S @VM=X,$P(@VM,"^")=$E($P(@VM,"^"),4,5)_"/"_$E($P(@VM,"^"),6,7)_"/"_($E($P(@VM,"^"),1,3)+1700)
"RTN","PSOSD2",62,0)
 ...S X=$P(WT,"^",8),Y=$J(X/2.2046226,0,2),$P(WT,"^",9)=Y,X=$P(HT,"^",8),Y=$J(2.54*X,0,2),$P(HT,"^",9)=Y
"RTN","PSOSD2",63,0)
 ..W !!,"WEIGHT(Kg): " W:+$P(WT,"^",8) $P(WT,"^",9)_" ("_$P(WT,"^")_")" W ?41,"HEIGHT(cm): " W:$P(HT,"^",8) $P(HT,"^",9)_" ("_$P(HT,"^")_")" K VM,WT,HT
"RTN","PSOSD2",64,0)
 D:$D(DIRUT) KLCL Q:$D(DIRUT)  S PAGE=PAGE+1 I $D(^UTILITY("VASD",$J)),PAGE=2!($G(PSOPOLP)) D KLCL S PSOPOLP=0 D HD Q
"RTN","PSOSD2",65,0)
 D KLCL I PSTYPE,'$D(HDFL) D 1 S HDFL=""
"RTN","PSOSD2",66,0)
 W !,$E(LINE,1,$S('PSORM:80,1:IOM)-1),!,"Medication/Supply" Q:'PSORM
"RTN","PSOSD2",67,0)
 W ?74,"Rx#",?85,"Status",?98,"Expiration",?110,"Provider",!,?101,"Date"
"RTN","PSOSD2",68,0)
 Q
"RTN","PSOSD2",69,0)
 ;
"RTN","PSOSD2",70,0)
CAPP ;
"RTN","PSOSD2",71,0)
 K X S X2=DT,X1=$P($P($G(PSOACPPI),"^"),".") I $G(X1) D ^%DTC
"RTN","PSOSD2",72,0)
 W $S($P(PSOACPPI,"^",3)["C":"   *** Canceled ***",1:" ("_$G(X)_" days)")
"RTN","PSOSD2",73,0)
 Q
"RTN","PSOSD2",74,0)
PSRENW D:'$G(PSODTCUT) CUTDATE^PSOFUNC I $P(RX2,"^",6)<PSODTCUT S PSRENW=0 G LN
"RTN","PSOSD2",75,0)
 I $E($P(RX0,"^",15))="D",$P(RX3,"^",5)<PSODTCUT,$P(^PSRX(RXNO,"STA"),"^")=12 S PSRENW=0 G LN
"RTN","PSOSD2",76,0)
 I $E($P(RX0,"^",15))="D",$P(^PSRX(RXNO,"STA"),"^")'=12 S PSRENW=0
"RTN","PSOSD2",77,0)
LN S CS=0 F DEA=1:1 Q:$E(PSODEA,DEA)=""  I $E(+PSODEA,DEA)>2,$E(+PSODEA,DEA)<6 S CS=1
"RTN","PSOSD2",78,0)
 K DEA,PSODEA Q
"RTN","PSOSD2",79,0)
KLCL K ^UTILITY("VASD",$J),PSOACPPI,PSOACPPE,PSOACPP Q
"RTN","PSOSD3")
0^16^B38868653
"RTN","PSOSD3",1,0)
PSOSD3 ;BHAM ISC/RTR - Prints pending orders on action profile ;11/20/95
"RTN","PSOSD3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**2,19,107,110,132,233,258,326,500**;DEC 1997;Build 9
"RTN","PSOSD3",3,0)
 ;External reference ^PS(50.7 - 2223
"RTN","PSOSD3",4,0)
 ;External reference ^PS(50.606 - 2174
"RTN","PSOSD3",5,0)
 ;External reference ^PSDRUG( - 221
"RTN","PSOSD3",6,0)
 ;External reference ^PS(59.7 - 694
"RTN","PSOSD3",7,0)
 ;External reference to ^PS(55 - 2228
"RTN","PSOSD3",8,0)
 ;
"RTN","PSOSD3",9,0)
START Q:$D(DUOUT)!($D(DTOUT))!('$G(DFN))
"RTN","PSOSD3",10,0)
 N MMM,PNDIS,PNDLINE,PNDREX,PNPOI,PPPP,PSOPRVD,PSCONT,PSOEFF,PSOQTY,PSOREFLS,PZSTAT,WWW
"RTN","PSOSD3",11,0)
 D ELIG^PSOSD1,DEM^VADPT,INP^VADPT,ADD^VADPT,PID^VADPT S PSSN=VA("PID"),ADDRFL=$S(+VAPA(9):"Temporary ",1:"")
"RTN","PSOSD3",12,0)
 S PSNAME=$E(VADM(1),1,28),PSDOB=$P(VADM(3),"^",2)
"RTN","PSOSD3",13,0)
 K ^TMP($J,"PSOPEND") S $P(PNDLINE,"-",33)=""
"RTN","PSOSD3",14,0)
 S PSCONT=1 F MMM=0:0 S MMM=$O(^PS(52.41,"P",DFN,MMM)) Q:'MMM  S PZSTAT=$P($G(^PS(52.41,MMM,0)),"^",3) I PZSTAT="NW"!(PZSTAT="HD")!(PZSTAT="RNW") D
"RTN","PSOSD3",15,0)
 .S ^TMP($J,"PSOPEND",PSCONT)=MMM_"^"_$S(+$P($G(^PS(52.41,MMM,0)),"^",9):"DD",1:"OI") S PSCONT=PSCONT+1
"RTN","PSOSD3",16,0)
 I $Y+6>IOSL D HD1 S:$D(DTOUT)!($D(DUOUT)) PSQFLG=1 G:$G(PSQFLG) END
"RTN","PSOSD3",17,0)
 D HD
"RTN","PSOSD3",18,0)
 I PSCONT=1 W !?10,"No pending orders for this patient!",! G END
"RTN","PSOSD3",19,0)
 F WWW=0:0 S WWW=$O(^TMP($J,"PSOPEND",WWW)) Q:'WWW!($G(PSQFLG))  D
"RTN","PSOSD3",20,0)
 .S PNDREX=$P(^TMP($J,"PSOPEND",WWW),"^"),PNDIS=$P($G(^PS(52.41,PNDREX,0)),"^",9),PNPOI=$P($G(^(0)),"^",8),PSOEFF=$P($G(^(0)),"^",6),PSOQTY=$P($G(^(0)),"^",10),PSOREFLS=$P($G(^(0)),"^",11),PSOPRVD=$P($G(^(0)),"^",5)
"RTN","PSOSD3",21,0)
 .W !,"Drug: ",$S($P(^TMP($J,"PSOPEND",WWW),"^",2)="DD":$P($G(^PSDRUG(+PNDIS,0)),"^"),1:$P($G(^PS(50.7,+PNPOI,0)),"^")_" "_$P($G(^PS(50.606,+$P($G(^(0)),"^",2),0)),"^")),!
"RTN","PSOSD3",22,0)
 .W ?1,"Eff. Date: ",$E(PSOEFF,4,5)_"-"_$E(PSOEFF,6,7)_"-"_($E(PSOEFF,1,3)+1700),?22,"Qty: ",PSOQTY,?40,"Refills: ",PSOREFLS,?52,"Prov: ",$E($P($G(^VA(200,+PSOPRVD,0)),"^"),1,21)
"RTN","PSOSD3",23,0)
 .S PSCONT=1 W !?1,"Sig: " F PPPP=0:0 S PPPP=$O(^PS(52.41,PNDREX,"SIG",PPPP)) Q:'PPPP!($G(PSQFLG))  W:PSCONT>1 ! W ?6,$G(^PS(52.41,PNDREX,"SIG",PPPP,0)) S PSCONT=PSCONT+1
"RTN","PSOSD3",24,0)
 .I $E(IOST)'="C" W !
"RTN","PSOSD3",25,0)
 .I $E(IOST)="C" D HD1 S:$D(DUOUT)!($D(DTOUT)) PSQFLG=1 Q:$G(PSQFLG)  D HD
"RTN","PSOSD3",26,0)
 .I $E(IOST)'="C" I $Y+9>IOSL D HD1 S:$D(DUOUT)!($D(DTOUT)) PSQFLG=1 Q:$G(PSQFLG)  D HD
"RTN","PSOSD3",27,0)
END K ^TMP($J,"PSOPEND") Q
"RTN","PSOSD3",28,0)
HD W !,PNDLINE,"PENDING ORDERS",PNDLINE,! Q
"RTN","PSOSD3",29,0)
 ;
"RTN","PSOSD3",30,0)
HD1 S FN=DFN
"RTN","PSOSD3",31,0)
 I $E(IOST)="C" K DIR S DIR(0)="E",DIR("A")="Press Return to Continue or ""^"" to Exit" D ^DIR Q:$D(DUOUT)!($D(DTOUT))
"RTN","PSOSD3",32,0)
 D ELIG^PSOSD1,DEM^VADPT,INP^VADPT,ADD^VADPT,PID^VADPT S PSSN=VA("PID"),ADDRFL=$S(+VAPA(9):"Temporary ",1:"")
"RTN","PSOSD3",33,0)
 S PSNAME=$E(VADM(1),1,28),PSDOB=$P(VADM(3),"^",2)
"RTN","PSOSD3",34,0)
 I $D(IOF) W @IOF
"RTN","PSOSD3",35,0)
 W $S(PSTYPE:"Action",1:"Informational")_" Rx Profile",?47,"Run Date: " S Y=DT D DT^DIO2 W ?71,"Page: "_PAGE
"RTN","PSOSD3",36,0)
 W !,"Sorted by drug classification for Rx's currently active"_$S('PSDAYS:" only.",1:"") W:PSDAYS !,"and for those Rx's that have been inactive less than "_PSDAYS_" days."
"RTN","PSOSD3",37,0)
 S X=$$SITE^VASITE
"RTN","PSOSD3",38,0)
 W @$S(PSORM:"?70",1:"!"),"Site: VAMC "_$P(X,"^",2)_" ("_$P(X,"^",3)_")",!,$E(LINE,1,$S('PSORM:80,1:IOM)-1)
"RTN","PSOSD3",39,0)
 I $P(VAIN(4),"^",2)]"",+$P($G(^PS(59.7,1,40.1)),"^") W !,"Outpatient prescriptions are discontinued 72 hours after admission.",!
"RTN","PSOSD3",40,0)
 I $D(CLINICX) W !?1,"Clinic: "_$E(CLINICX,1,28),?45,"Date/Time: " S Y=CLDT D DT^DIO2
"RTN","PSOSD3",41,0)
 W !?1,"Name  : ",PSNAME W:PSTYPE ?58,"Action Date: ________" W !?1,"DOB   : "_PSDOB
"RTN","PSOSD3",42,0)
 W:ADDRFL]"" ?30,ADDRFL,! W ?30,"Address  :"
"RTN","PSOSD3",43,0)
 I $G(ADDRFL)="" D CHECKBAI^PSOSD1
"RTN","PSOSD3",44,0)
 W ?41,VAPA(1) W:VAPA(2)]"" !?41,VAPA(2) W:VAPA(3)]"" !?41,VAPA(3)
"RTN","PSOSD3",45,0)
 W !?41,VAPA(4)_", "_$P(VAPA(5),"^",2)_"  "_$S(VAPA(11)]"":$P(VAPA(11),"^",2),1:VAPA(6)),!?30,"Phone    : "_VAPA(8)
"RTN","PSOSD3",46,0)
 I PSOBAR4 S X="S",X2=PSSN W @$S('PSORM:"!?30",1:"?$X+5") S X1=$X W @PSOBAR3,X2,@PSOBAR2,$C(13) S $X=0
"RTN","PSOSD3",47,0)
 W:$G(DOD(DFN))]"" ?1,"**** Date of Death: "_DOD(DFN)_" ****",!
"RTN","PSOSD3",48,0)
 S (WT,HT)="",X="GMRVUTL" X ^%ZOSF("TEST") I $T D
"RTN","PSOSD3",49,0)
 .F GMRVSTR="WT","HT" S VM=GMRVSTR D EN6^GMRVUTL S @VM=X,$P(@VM,"^")=$E($P(@VM,"^"),4,5)_"/"_$E($P(@VM,"^"),6,7)_"/"_($E($P(@VM,"^"),1,3)+1700)
"RTN","PSOSD3",50,0)
 .S X=$P(WT,"^",8),Y=$J(X/2.2046226,0,2),WT=WT_"^"_Y,X=$P(HT,"^",8),Y=$J(2.54*X,0,2),HT=HT_"^"_Y
"RTN","PSOSD3",51,0)
 W !!,"WEIGHT(Kg): " W:+$P(WT,"^",8) $P(WT,"^",9)_" ("_$P(WT,"^")_")" W ?41,"HEIGHT(cm): " W:$P(HT,"^",8) $P(HT,"^",9)_" ("_$P(HT,"^")_")" K VM,WT,HT
"RTN","PSOSD3",52,0)
 S PAGE=PAGE+1 W !,$E(LINE,1,$S('PSORM:80,1:IOM)-1)
"RTN","PSOSD3",53,0)
 Q
"RTN","PSOSD3",54,0)
NVA ;displays non-va meds
"RTN","PSOSD3",55,0)
 Q:'$O(^PS(55,DFN,"NVA",0))
"RTN","PSOSD3",56,0)
 Q:$D(DUOUT)!($D(DTOUT))!('$G(DFN))
"RTN","PSOSD3",57,0)
 D HD1 S $P(PNDLINE,"-",IOM)="",PSODFN=DFN
"RTN","PSOSD3",58,0)
 W !,PNDLINE,!?25,"Non-VA Meds (Not dispensed by VA)",!,PNDLINE,!
"RTN","PSOSD3",59,0)
 F NVA=0:0 S NVA=$O(^PS(55,DFN,"NVA",NVA)) Q:'NVA  D  Q:$G(PSQFLG)
"RTN","PSOSD3",60,0)
 .I $Y+6>IOSL D HD1 S:$D(DTOUT)!($D(DUOUT)) PSQFLG=1 Q:$G(PSQFLG)
"RTN","PSOSD3",61,0)
 .Q:'$P(^PS(55,PSODFN,"NVA",NVA,0),"^")
"RTN","PSOSD3",62,0)
 .S DUPRX0=^PS(55,PSODFN,"NVA",NVA,0)
"RTN","PSOSD3",63,0)
 .W !,"Orderable Item: "_$P(^PS(50.7,$P(DUPRX0,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSOSD3",64,0)
 .W !,"Drug: "_$S($P(DUPRX0,"^",2):$P(^PSDRUG($P(DUPRX0,"^",2),0),"^"),1:"No Dispense Drug Selected")
"RTN","PSOSD3",65,0)
 .W !,"Status: "_$S($P(DUPRX0,"^",7):"Discontinued ("_$$FMTE^XLFDT($P($P(DUPRX0,"^",7),"."))_")",1:"Active")
"RTN","PSOSD3",66,0)
 .W !,"Dosage: "_$P(DUPRX0,"^",3)
"RTN","PSOSD3",67,0)
 .W !,"Schedule: "_$P(DUPRX0,"^",5),!,"Route: "_$P(DUPRX0,"^",4)
"RTN","PSOSD3",68,0)
 .W !,"Start Date: "_$$FMTE^XLFDT($P(DUPRX0,"^",9)),?40,"CPRS Oder #: "_$P(DUPRX0,"^",8)
"RTN","PSOSD3",69,0)
 .W !,"Documented By: "_$P(^VA(200,$P(DUPRX0,"^",11),0),"^")_" on "_$$FMTE^XLFDT($P(DUPRX0,"^",10))
"RTN","PSOSD3",70,0)
 .S RMLEN=$S('PSORM:75,1:IOM-5)
"RTN","PSOSD3",71,0)
 .F I=0:0 S I=$O(^PS(55,PSODFN,"NVA",NVA,"OCK",I)) Q:'I  D  W !
"RTN","PSOSD3",72,0)
 ..S ORD=$P(^PS(55,PSODFN,"NVA",NVA,"OCK",I,0),"^"),ORP=$P(^(0),"^",2)
"RTN","PSOSD3",73,0)
 ..W !,"Order Check #"_I_": "
"RTN","PSOSD3",74,0)
 ..K OCK,LEN I $L(ORD)>RMLEN S (LEN,IEN)=1 D
"RTN","PSOSD3",75,0)
 ...F SG=1:1:$L(ORD) S:$L($G(OCK(IEN))_" "_$P(ORD," ",SG))>RMLEN&($P(ORD," ",SG)]"") IEN=IEN+1 S:$P(ORD," ",SG)'="" OCK(IEN)=$G(OCK(IEN))_" "_$P(ORD," ",SG)
"RTN","PSOSD3",76,0)
 ...F II=0:0 S II=$O(OCK(II)) Q:'II  W !?5,OCK(II)
"RTN","PSOSD3",77,0)
 ..W:'$G(LEN) ORD K LEN,SG,IEN,II,OCK,ORD
"RTN","PSOSD3",78,0)
 ..W !,"Overriding Provider: "_$S($G(ORP):$P(^VA(200,ORP,0),"^"),1:"")
"RTN","PSOSD3",79,0)
 ..K ORP,OCK,REA W !,"Reason:" F SS=0:0 S SS=$O(^PS(55,PSODFN,"NVA",NVA,"OCK",I,"OVR",SS)) Q:'SS  S REA(SS)=^PS(55,PSODFN,"NVA",NVA,"OCK",I,"OVR",SS,0)
"RTN","PSOSD3",80,0)
 ..S IEN=1 F II=0:0 S II=$O(REA(II)) Q:'II  D
"RTN","PSOSD3",81,0)
 ...F SG=1:1:$L(REA(II)) S:$L($G(OCK(IEN))_" "_$P(REA(II)," ",SG))>RMLEN&($P(REA(II)," ",SG)]"") IEN=IEN+1 S:$P(REA(II)," ",SG)'="" OCK(IEN)=$G(OCK(IEN))_" "_$P(REA(II)," ",SG)
"RTN","PSOSD3",82,0)
 ...K REA,IEN,SG F II=0:0 S II=$O(OCK(II)) Q:'II  W OCK(II) I $O(OCK(II)) W !?5
"RTN","PSOSD3",83,0)
 .K OCK W !,"Statement/Explanation/Comments:" F SS=0:0 S SS=$O(^PS(55,PSODFN,"NVA",NVA,"DSC",SS)) Q:'SS  S DSC(SS)=^PS(55,PSODFN,"NVA",NVA,"DSC",SS,0)
"RTN","PSOSD3",84,0)
 .S IEN=1 F II=0:0 S II=$O(DSC(II)) Q:'II  D
"RTN","PSOSD3",85,0)
 ..F SG=1:1:$L(DSC(II)) S:$L($G(OCK(IEN))_" "_$P(DSC(II)," ",SG))>RMLEN&($P(DSC(II)," ",SG)]"") IEN=IEN+1 S:$P(DSC(II)," ",SG)'="" OCK(IEN)=$G(OCK(IEN))_" "_$P(DSC(II)," ",SG)
"RTN","PSOSD3",86,0)
 .K IEN,DSC,SG F II=0:0 S II=$O(OCK(II)) Q:'II  W !?5,OCK(II)
"RTN","PSOSD3",87,0)
 .W !! I $E(IOST)'="C" W !
"RTN","PSOSD3",88,0)
 K RMLEN
"RTN","PSOSD3",89,0)
 Q
"RTN","PSOSDP")
0^17^B31171102
"RTN","PSOSDP",1,0)
PSOSDP ;BHAM ISC/SAB - poly pharmacy report attached to action/info profile ;12/13/93 8:24
"RTN","PSOSDP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**2,17,19,107,110,155,176,233,258,326,500**;DEC 1997;Build 9
"RTN","PSOSDP",3,0)
 ;called from PSOSD
"RTN","PSOSDP",4,0)
 Q:+$G(^TMP($J,DFN))<PSONUM!($G(DOD(DFN))]"")  S DRG="",P=0,PSOPOLP=0 D HD K SGY
"RTN","PSOSDP",5,0)
 F  S DRG=$O(^TMP($J,DFN,DRG)) Q:DRG=""  F  S P=$O(^TMP($J,DFN,DRG,P)) Q:'P  I $G(^PSRX(P,0))]"" S RX0=^PSRX(P,0),RX2=$G(^(2)),RX3=$G(^(3)) D  K SGY
"RTN","PSOSDP",6,0)
 .I $Y+6>IOSL D FT,HD
"RTN","PSOSDP",7,0)
 .S SIG=$P($G(^PSRX(P,"SIG")),"^") W !?10,"* "_$E(DRG,1,40),?52 D SIG W $G(BSIG(1)),?79,"*"
"RTN","PSOSDP",8,0)
 .I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?10,"*",?52,$G(BSIG(PSREV)),?79,"*" I $Y+4>IOSL,$O(BSIG(PSREV)) D FT,HD
"RTN","PSOSDP",9,0)
 .K BSIG,PSREV
"RTN","PSOSDP",10,0)
 D FT K PSOGY
"RTN","PSOSDP",11,0)
 Q
"RTN","PSOSDP",12,0)
SIG K FSIG,BSIG I $P($G(^PSRX(P,"SIG")),"^",2) D FSIG^PSOUTLA("R",P,26) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSOSDP",13,0)
 K FSIG,PSREV I '$P($G(^PSRX(P,"SIG")),"^",2) D EN3^PSOUTLA1(P,26)
"RTN","PSOSDP",14,0)
 Q
"RTN","PSOSDP",15,0)
HD S FN=DFN
"RTN","PSOSDP",16,0)
 D ELIG^PSOSD1,DEM^VADPT,INP^VADPT,ADD^VADPT,PID^VADPT S PSSN=VA("PID"),ADDRFL=$S(+VAPA(9):"Temporary ",1:"")
"RTN","PSOSDP",17,0)
 S PSNAME=$E(VADM(1),1,28),PSDOB=$P(VADM(3),"^",2)
"RTN","PSOSDP",18,0)
 W @IOF,!,"Polypharmacy Rx Profile Review",?47,"Run Date: " S Y=DT D DT^DIO2 W ?71,"Page: "_PAGE S PAGE=PAGE+1,X=$$SITE^VASITE
"RTN","PSOSDP",19,0)
 W !,"Sorted by drug name for Rx's currently active",@$S(PSORM:"?70",1:"!"),"Site: VAMC "_$P(X,"^",2)_"( "_$P(X,"^",3)_")",!,$E(LINE,1,$S('PSORM:80,1:IOM)-1)
"RTN","PSOSDP",20,0)
 I $D(CLINICX) W !?1,"Clinic: ",$E(CLINICX,1,28),?45,"Date/Time: " S Y=CLDT D DT^DIO2
"RTN","PSOSDP",21,0)
 W !?1,"Name  : ",PSNAME,?30 W ?58,"Review Date: ________" W !?1,"DOB   : "_PSDOB
"RTN","PSOSDP",22,0)
 W:ADDRFL]"" ?30,ADDRFL,! W ?30,"Address  :"
"RTN","PSOSDP",23,0)
 I ADDRFL="" D CHECKBAI^PSOSD1
"RTN","PSOSDP",24,0)
 W ?41,VAPA(1) W:VAPA(2)]"" !?41,VAPA(2) W:VAPA(3)]"" !?41,VAPA(3) W !?41,VAPA(4)_", "_$P(VAPA(5),"^",2)_"  "_VAPA(6),!?30,"Phone    : "_VAPA(8)
"RTN","PSOSDP",25,0)
 S PSOBAR2=PSOBAR0,PSOBAR3=PSOBAR1
"RTN","PSOSDP",26,0)
 S PSOBAR4=$G(PSOBAR3)]""&($G(PSOBAR2)]"")&(+$P($G(PSOPAR),"^"))
"RTN","PSOSDP",27,0)
 I PSOBAR4 S X="S",X2=PSSN W @$S('PSORM:"!?30",1:"?$X+5") S X1=$X W @PSOBAR3,X2,@PSOBAR2,$C(13) S $X=0
"RTN","PSOSDP",28,0)
 F GMRVSTR="WT","HT" S VM=GMRVSTR D EN6^GMRVUTL S @VM=X,$P(@VM,"^")=$E($P(@VM,"^"),4,5)_"/"_$E($P(@VM,"^"),6,7)_"/"_($E($P(@VM,"^"),1,3)+1700)
"RTN","PSOSDP",29,0)
 S X=$P(WT,"^",8),Y=$J(X/2.2046226,0,2),WT=WT_"^"_Y,X=$P(HT,"^",8),Y=$J(2.54*X,0,2),HT=HT_"^"_Y
"RTN","PSOSDP",30,0)
 W !?1,"WEIGHT(Kg): " W:+$P(WT,"^",8) $P(WT,"^",9)_" ("_$P(WT,"^")_")" W ?41,"HEIGHT(cm): " W:$P(HT,"^",8) $P(HT,"^",9)_" ("_$P(HT,"^")_")" K VM,WT,HT
"RTN","PSOSDP",31,0)
 W !,$E(LINE,1,$S('PSORM:80,1:IOM)-1),!!!?10 F I=1:1:70 W "*"
"RTN","PSOSDP",32,0)
 W !?10,"*",?35,"POLYPHARMACY REVIEW",?79,"*",!?10,"*",?79,"*",!?10,"* Patient:  "_PSNAME,?50,"(ID#: "_VA("BID")_")",?79,"*"
"RTN","PSOSDP",33,0)
 W !?10,"* is identified as having "_PSONUM_" or more active prescriptions",?79,"*",!?10,"* for drugs (excluding supplies).  To avoid unnecessary",?79,"*"
"RTN","PSOSDP",34,0)
 W !?10,"* medications, please review these to ensure that each one",?79,"*",!?10,"* is essential.  Unnecessary medications may be discontinued on",?79,"*"
"RTN","PSOSDP",35,0)
 W !?10,"* the attached Action Profile.",?79,"*",!?10,"*",?79,"*",!?10,"* I have reviewed the medications below and have taken",?79,"*",!?10,"* actions to discontinue those that are no longer required.",?79,"*"
"RTN","PSOSDP",36,0)
 F I=1:1:3 W !?10,"*",?79,"*"
"RTN","PSOSDP",37,0)
 W !?10,"*",?25 F I=1:1:35 W "_"
"RTN","PSOSDP",38,0)
 W ?79,"*",!?10,"*",?25,"(Signature)",?79,"*" F I=1:1:2 W !?10,"*",?79,"*"
"RTN","PSOSDP",39,0)
 W !?10,"*",?25,"Drugs ("_^TMP($J,DFN)_")",?60,"SIG",?79,"*"
"RTN","PSOSDP",40,0)
 W !?10,"* " F I=1:1:30 W "-"
"RTN","PSOSDP",41,0)
 W ?52 F I=1:1:20 W "-"
"RTN","PSOSDP",42,0)
 W ?79,"*"
"RTN","PSOSDP",43,0)
 Q
"RTN","PSOSDP",44,0)
FT W !?10 F I=1:1:70 W "*"
"RTN","PSOSDP",45,0)
 Q
"RTN","PSOSDP",46,0)
CLSG ;clinic group sort and print
"RTN","PSOSDP",47,0)
 S CLSP=1,DIC("A")="Select Clinic Sort Group: "
"RTN","PSOSDP",48,0)
 S DIC="^PS(59.8,",DIC(0)="AEQM" D ^DIC G:"^"[X EXIT^PSOSD G:Y<0 CLSG
"RTN","PSOSDP",49,0)
 S CLSG=+Y
"RTN","PSOSDP",50,0)
 I '$O(^PS(59.8,CLSG,1,0)) W !!,$C(7),"There are no clinics defined for this Clinic Group!",!,$C(7) G CLSG
"RTN","PSOSDP",51,0)
 S %DT="AEFX",%DT("A")="FOR DATE: " D ^%DT G:"^"[X EXIT^PSOSD G CLSG:Y<0 S (APCLDT,CLDT)=Y,$P(LINE,"-",132)="-"
"RTN","PSOSDP",52,0)
 D DAYS^PSOSD1 G:$D(DIRUT) EXIT S X1=DT,X2=-PSDAYS D C^%DTC S PSDATE=X S PSTYPE=$S($D(PSTYPE):PSTYPE,1:0)
"RTN","PSOSDP",53,0)
 K %DT,%ZIS,IOP,ZTSK,ZTQUEUED S PSOION=ION,%ZIS="QM",%ZIS("B")="",%ZIS("A")=$S(PSTYPE:"Select a Printer: ",1:"DEVICE: ")
"RTN","PSOSDP",54,0)
 S %ZIS("S")=$S(PSTYPE:"I $E($G(^%ZIS(2,+$G(^(""SUBTYPE"")),0)),1)=""P""",1:"")
"RTN","PSOSDP",55,0)
 N PSOBARS,PSOBAR0,PSOBAR1
"RTN","PSOSDP",56,0)
 D ^%ZIS I POP S IOP=PSOION K PSOION G EXIT
"RTN","PSOSDP",57,0)
 S APRT=ION ;D ^%ZISC
"RTN","PSOSDP",58,0)
 K DTOUT,DIR,DIRUT
"RTN","PSOSDP",59,0)
 W ! I $G(IO("Q")) D  W:$D(ZTSK) !,"Report Queued to Print !!",!! G EXIT
"RTN","PSOSDP",60,0)
 .S %DT="ERXAFS",%DT("A")="Request Start Time: ",%DT("B")="NOW",%DT(0)="NOW" D ^%DT W ! Q:$D(DIRUT)!(X["^")  S APTM=Y
"RTN","PSOSDP",61,0)
 .F G="LINE","CLDT","CLSG","PSOPOL","PSOSYS","PSOINST","PSOBAR3","PSOBAR4","PSOBAR2","PSOPAR","PSOPAR7","PRF","PSDAYS","PSDATE","PSTYPE","PSOSITE","PSDATE","PSDAY","PSONUM","PSORM" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOSDP",62,0)
 .S ZTSAVE("APCLDT")="",ZTDTH=APTM,ZTDESC="Clinic Sort Group Action Profile (Outpatient Pharmacy).",ZTSAVE("ZTREQ")="@",ZTSAVE("APRT")="",ZTIO=APRT,ZTRTN="EN^PSOSDP" D ^%ZTLOAD
"RTN","PSOSDP",63,0)
 ;
"RTN","PSOSDP",64,0)
EN ;
"RTN","PSOSDP",65,0)
 S APIFLDS="1;2;3;4;5;6;7;8;9;10;11;12",ALL=1
"RTN","PSOSDP",66,0)
 S CLN=0 ;S PSOIOS=IOS D DEVBAR^PSOBMST
"RTN","PSOSDP",67,0)
 F  S CLN=$O(^PS(59.8,CLSG,1,CLN)) Q:'CLN  S FR=CLN_","_CLDT,PSOT=CLDT,TO=CLN_","_CLDT_".2359" D CLIN1^PSOSDRAP S CLDT=APCLDT
"RTN","PSOSDP",68,0)
 D ^%ZISC
"RTN","PSOSDP",69,0)
 ;
"RTN","PSOSDP",70,0)
EXIT K ADDRFL,CAN,CLDT,CLINICX,CLSG,CLSP,CNT,CS,DFN,G,PAGE,PCLASS,PRF,PSDATE
"RTN","PSOSDP",71,0)
 K PSDAY,PSDAYS,PSDT,PIIX,PSNAME,PSONUM,PSOT,PSSN,PSTYPE,RF,RFS,RXNO
"RTN","PSOSDP",72,0)
 K RXNODE,PSORM,PSOUT,PSOION,ZTDESC,DQTIME,F,O,W,CLN,APQUE,APTM,APRT
"RTN","PSOSDP",73,0)
 K APCLDT D KVA^VADPT,EXIT^PSOSD
"RTN","PSOSDP",74,0)
 G:'$D(ZTQUEUED) ^PSOSD
"RTN","PSOSDP",75,0)
 Q
"RTN","PSOSDP",76,0)
 ;
"RTN","PSOSDP",77,0)
COS I $P($G(^PSRX(J,3)),"^",3),$D(^VA(200,+$P($G(^(3)),"^",3),0)) W !?99,"COSIGNER: "_$P($G(^VA(200,$P(^PSRX(J,3),"^",3),0)),"^")
"RTN","PSOSDP",78,0)
 Q
"RTN","PSOSIG")
0^7^B96478034
"RTN","PSOSIG",1,0)
PSOSIG ;BIR/RTR-Utility to create SIG ;6/04/00
"RTN","PSOSIG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,99,114,391,313,282,455,446,402,500**;DEC 1997;Build 9
"RTN","PSOSIG",3,0)
 ;External reference to PS(51 supported by DBIA 2224
"RTN","PSOSIG",4,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOSIG",5,0)
 ;External reference to PSDRUG( supported by DBIA 221
"RTN","PSOSIG",6,0)
 ;
"RTN","PSOSIG",7,0)
EN(PSOSIGX) ;
"RTN","PSOSIG",8,0)
 N VARIABLE
"RTN","PSOSIG",9,0)
 Q
"RTN","PSOSIG",10,0)
SCH ;*282 Preserve old functionality
"RTN","PSOSIG",11,0)
 ;N SCHFL S SCHFL=0
"RTN","PSOSIG",12,0)
 I $D(DTOUT)!($D(DUOUT)) Q
"RTN","PSOSIG",13,0)
 I Y'>0 W !,?2,"Free text '"_$G(SCH)_"' entered for schedule"
"RTN","PSOSIG",14,0)
 I Y>0 S SCHEX=$$SCHE(SCH)
"RTN","PSOSIG",15,0)
 Q
"RTN","PSOSIG",16,0)
 ;
"RTN","PSOSIG",17,0)
 ;SCHE is the new schedule expander
"RTN","PSOSIG",18,0)
SCHE(SCH) ;
"RTN","PSOSIG",19,0)
 ;SCH = Schedule entered
"RTN","PSOSIG",20,0)
 ;Returns Expanded Schedule, or ""
"RTN","PSOSIG",21,0)
 N SCHEX,SPCT
"RTN","PSOSIG",22,0)
 I SCH[""""!($A(SCH)=45)!(SCH?.E1C.E)!($L(SCH," ")>$S(SCH["PRN":4,1:3))!($L(SCH)>20)!($L(SCH)<1) K SCH Q ""
"RTN","PSOSIG",23,0)
 S SCH=$$UPPER(SCH)
"RTN","PSOSIG",24,0)
 S SPCT=0 F I=1:1:$L(SCH) I $E(SCH,I)=" " S SPCT=SPCT+1
"RTN","PSOSIG",25,0)
 S SCHEX=$$EXP(SCH) I SCHEX]"" Q SCHEX
"RTN","PSOSIG",26,0)
 Q:SPCT=0 SCH
"RTN","PSOSIG",27,0)
 Q $$SCHE($P(SCH," ",1,SPCT))_" "_$$SCHE($P(SCH," ",SPCT+1))
"RTN","PSOSIG",28,0)
EXP(X) ; expand based on 51.1 and 51
"RTN","PSOSIG",29,0)
 N PSIN,SCFLG,SCHEX
"RTN","PSOSIG",30,0)
 S PSIN=0 F  S PSIN=$O(^PS(51.1,"APPSJ",X,PSIN)) Q:'PSIN!$G(SCFLG)  I $P(^PS(51.1,PSIN,0),"^",8)'="" S SCHEX=$P($G(^(0)),"^",8),SCFLG=1
"RTN","PSOSIG",31,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",32,0)
 S PSIN=0 F  S PSIN=$O(^PS(51.1,"D",X,PSIN)) Q:'PSIN!$G(SCFLG)  I $P(^PS(51.1,PSIN,0),"^",8)'="" S SCHEX=$P($G(^(0)),"^",8),SCFLG=1
"RTN","PSOSIG",33,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",34,0)
 S PSIN=0 F  S PSIN=$O(^PS(51,"B",X,PSIN)) Q:'PSIN!$G(SCLFL)  I PSIN,($P(^PS(51,PSIN,0),"^",4)<2)&($P($G(^PS(51,"A",X)),"^")'="") S SCHEX=$P(^(X),"^"),SCFLG=1
"RTN","PSOSIG",35,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",36,0)
 S PSIN=0 F  S PSIN=$O(^PS(51,"D",X,PSIN)) Q:'PSIN!$G(SCLFL)  I PSIN,($P(^PS(51,PSIN,0),"^",4)<2)&($P($G(^PS(51,"A",X)),"^")'="") S SCHEX=$P(^(X),"^"),SCFLG=1
"RTN","PSOSIG",37,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",38,0)
 Q ""
"RTN","PSOSIG",39,0)
 ;
"RTN","PSOSIG",40,0)
QTY(PSOQX) ; PSOQX - Array containing Rx information
"RTN","PSOSIG",41,0)
 N QDOSE,PSORXIEN,PSODSEDT,PSOOUTQT
"RTN","PSOSIG",42,0)
 K PSOQX("QTY")
"RTN","PSOSIG",43,0)
 S PSORXIEN=$S($G(PSOQX("IRXN")):+PSOQX("IRXN"),1:0)
"RTN","PSOSIG",44,0)
 S PSODSEDT=$S(PSORXIEN&$D(PSOQX(52,PSORXIEN,8)):1,'PSORXIEN&($G(PSOQX("FLD"))=8):1,1:0)  ; DAYS SUPPLY field edited
"RTN","PSOSIG",45,0)
 I 'PSORXIEN,$G(PSOQX("FLD"))=7 Q   ; QTY field being edite for Pending Order (do not ajust current QTY)
"RTN","PSOSIG",46,0)
 S PSOOUTQT=1
"RTN","PSOSIG",47,0)
QTYCP ;CPRS qty call comes through here
"RTN","PSOSIG",48,0)
 N PSQQUIT,QTSH,PSQ,PSQMIN,PSQMINZ,PSOQRND,PSOLOWER,PSOLOWX,PSOLOWXL,PSOLOWST
"RTN","PSOSIG",49,0)
 K PSOFRQ S PSQQUIT=0
"RTN","PSOSIG",50,0)
 I '$G(PSOCPRQT) S QDOSE=0 F PSQ=0:0 S PSQ=$O(PSOQX("DOSE",PSQ)) Q:'PSQ  S QDOSE=PSQ S:'$G(PSOQX("DOSE ORDERED",PSQ)) PSQQUIT=1
"RTN","PSOSIG",51,0)
 I '$G(PSOCPRQT) Q:PSQQUIT
"RTN","PSOSIG",52,0)
 Q:'$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",53,0)
 Q:'$G(QDOSE)
"RTN","PSOSIG",54,0)
 G:QDOSE>1 COMP
"RTN","PSOSIG",55,0)
 Q:'$G(PSOQX("DOSE ORDERED",1))
"RTN","PSOSIG",56,0)
 Q:'$G(PSOQX("DAYS SUPPLY"))&('$G(PSOQX("DURATION",1)))
"RTN","PSOSIG",57,0)
 S PSOLOWER=0
"RTN","PSOSIG",58,0)
 I $G(PSOQX("DURATION",1)) D
"RTN","PSOSIG",59,0)
 .S PSOLOWX=$L(PSOQX("DURATION",1))
"RTN","PSOSIG",60,0)
 .S PSOLOWXL=$S($E(PSOQX("DURATION",1),PSOLOWX)="M":1,$E(PSOQX("DURATION",1),PSOLOWX)="H":60,$E(PSOQX("DURATION",1),PSOLOWX)="S":.01666,$E(PSOQX("DURATION",1),PSOLOWX)="W":10080,$E(PSOQX("DURATION",1),PSOLOWX)="L":43200,1:1440)
"RTN","PSOSIG",61,0)
 .S PSOLOWER=PSOLOWXL*(+$G(PSOQX("DURATION",1)))
"RTN","PSOSIG",62,0)
 S PSOLOWX=0 I +$G(PSOQX("DAYS SUPPLY")) S PSOLOWX=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",63,0)
 Q:'$G(PSOLOWER)&('$G(PSOLOWX))
"RTN","PSOSIG",64,0)
 S QTSH=$G(PSOQX("SCHEDULE",1)) D QTS Q:PSQQUIT!('$G(PSOFRQ))
"RTN","PSOSIG",65,0)
 S PSOLOWST=$S('$G(PSOLOWER):$G(PSOLOWX),'$G(PSOLOWX):$G(PSOLOWER),$G(PSOLOWER)>$G(PSOLOWX):$G(PSOLOWX),$G(PSOLOWX)>$G(PSOLOWER):$G(PSOLOWER),$G(PSOLOWX)=$G(PSOLOWER):$G(PSOLOWER),1:0)
"RTN","PSOSIG",66,0)
 Q:'$G(PSOLOWST)
"RTN","PSOSIG",67,0)
 S PSQMIN=+$G(PSOLOWST)
"RTN","PSOSIG",68,0)
 S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIG",69,0)
 S PSOQRND=PSQMINZ*+$G(PSOQX("DOSE ORDERED",1)) Q:'PSOQRND
"RTN","PSOSIG",70,0)
 ;If DAYS SUPPLY was edited by Pharmacy and previous quantity was calculated, don't calculate/update quantity automatically
"RTN","PSOSIG",71,0)
 I $G(PSODSEDT),'$$UPDQTY(PSOQRND+.9999\1) Q
"RTN","PSOSIG",72,0)
 D ROUND G QEND
"RTN","PSOSIG",73,0)
 Q
"RTN","PSOSIG",74,0)
COMP ;COMPLEX DOSE HERE
"RTN","PSOSIG",75,0)
 N PSOQEXC,PSOQAND,PSOQTHEN,PSQL,PSQMNL,PSQMNLX,PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSQ1,PSODUX,PSODUXX,PSODSMIN
"RTN","PSOSIG",76,0)
 ;PSODUTOT = TOTAL OF ALL DURATIONS
"RTN","PSOSIG",77,0)
 ;PSODUDIF = DIFF. OF DURATION VS DAYS SUPPLY
"RTN","PSOSIG",78,0)
 ;PSODUMIS = # OF SEQUENCES MISSING A DURATION IF >1 CAN'T DEFAULT
"RTN","PSOSIG",79,0)
 ;PSODUREP = SEQUENCE # THAT IS MISSING DURATION
"RTN","PSOSIG",80,0)
 ;PSODSMIN = MINUTES OF DAYS SUPPLY
"RTN","PSOSIG",81,0)
 S (PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSODSMIN,PSOQAND,PSOQTHEN,PSOQEXC)=0
"RTN","PSOSIG",82,0)
 F PSQL=1:1:QDOSE S:$G(PSOQX("CONJUNCTION",PSQL))["A" PSOQAND=1 S:$G(PSOQX("CONJUNCTION",PSQL))["T" PSOQTHEN=1 S:$G(PSOQX("CONJUNCTION",PSQL))["X" PSOQEXC=1
"RTN","PSOSIG",83,0)
 I $G(PSOQEXC) G QEND
"RTN","PSOSIG",84,0)
 I $G(PSOQAND) G COMP^PSOSIGCX
"RTN","PSOSIG",85,0)
 F PSQ1=1:1:QDOSE D  Q:PSODUMIS>1
"RTN","PSOSIG",86,0)
 .I '$G(PSOQX("DURATION",PSQ1)) S PSODUMIS=PSODUMIS+1,PSODUREP=PSQ1 Q
"RTN","PSOSIG",87,0)
 .S PSODUX=$L(PSOQX("DURATION",PSQ1))
"RTN","PSOSIG",88,0)
 .S PSODUXX=$S($E(PSOQX("DURATION",PSQ1),PSODUX)="M":1,$E(PSOQX("DURATION",PSQ1),PSODUX)="H":60,$E(PSOQX("DURATION",PSQ1),PSODUX)="S":.01666,$E(PSOQX("DURATION",PSQ1),PSODUX)="W":10080,$E(PSOQX("DURATION",PSQ1),PSODUX)="L":43200,1:1440)
"RTN","PSOSIG",89,0)
 .S PSODUTOT=PSODUTOT+(PSODUXX*(+$G(PSOQX("DURATION",PSQ1))))
"RTN","PSOSIG",90,0)
 G:PSODUMIS>1 QEND ; More than 1 sequence missing a duration
"RTN","PSOSIG",91,0)
 I $G(PSODUMIS),'$G(PSOQX("DAYS SUPPLY")) G QEND ; missing 1 duration, no days supply
"RTN","PSOSIG",92,0)
 S PSODSMIN=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",93,0)
 I $G(PSODSMIN),$G(PSODSMIN)<$G(PSODUTOT) G QEND
"RTN","PSOSIG",94,0)
 I '$G(PSODUMIS),$G(PSODSMIN),$G(PSODUTOT)>$G(PSODSMIN) G QEND ; no missing durations, but total durations are greater than days supply
"RTN","PSOSIG",95,0)
 I $G(PSODUMIS),$G(PSODSMIN),$G(PSODSMIN)'>$G(PSODUTOT) G QEND ; 1 missing duration, and total of other durations are not less than days supply
"RTN","PSOSIG",96,0)
 I '$G(PSODSMIN),$G(PSODUMIS) G QEND ; no days supply, missing a duration
"RTN","PSOSIG",97,0)
 I $G(PSODUREP) S PSODUDIF=$G(PSODSMIN)-$G(PSODUTOT)
"RTN","PSOSIG",98,0)
 F PSQ=1:1:QDOSE D  Q:$G(PSQQUIT)
"RTN","PSOSIG",99,0)
 .I '$G(PSOQX("DOSE ORDERED",PSQ))!($G(PSOQX("SCHEDULE",PSQ))="") S PSQQUIT=1 Q
"RTN","PSOSIG",100,0)
 .S QTSH=$G(PSOQX("SCHEDULE",PSQ)) D QTS S:'$G(PSOFRQ) PSQQUIT=1 Q:$G(PSQQUIT)
"RTN","PSOSIG",101,0)
 .I $G(PSOQX("DURATION",PSQ)) S PSQMNL=$L(PSOQX("DURATION",PSQ)) D
"RTN","PSOSIG",102,0)
 ..S PSQMNLX=$S($E(PSOQX("DURATION",PSQ),PSQMNL)="M":1,$E(PSOQX("DURATION",PSQ),PSQMNL)="H":60,$E(PSOQX("DURATION",PSQ),PSQMNL)="S":.01666,$E(PSOQX("DURATION",PSQ),PSQMNL)="W":10080,$E(PSOQX("DURATION",PSQ),PSQMNL)="L":43200,1:1440)
"RTN","PSOSIG",103,0)
 ..S PSQMIN=PSQMNLX*(+$G(PSOQX("DURATION",PSQ)))
"RTN","PSOSIG",104,0)
 .I '$G(PSOQX("DURATION",PSQ)) S PSQMIN=$G(PSODUDIF)
"RTN","PSOSIG",105,0)
 .S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIG",106,0)
 .S PSOQRND=$S('$G(PSOQRND):PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ)),1:$G(PSOQRND)+(PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ))))
"RTN","PSOSIG",107,0)
 I $G(PSQQUIT) G QEND
"RTN","PSOSIG",108,0)
 ;If DAYS SUPPLY was edited by Pharmacy, don't re-calculate QTY automatically for Digitally Signed Pending Orders
"RTN","PSOSIG",109,0)
 I $G(PSODSEDT),$G(QTYHLD),$G(PSOFDR),$P($G(OR0),"^",24) D  Q
"RTN","PSOSIG",110,0)
 . W !!,"The Quantity (",QTYHLD,") has not been changed."
"RTN","PSOSIG",111,0)
 . W !,"Please review and update it if necessary.",!,$C(7)
"RTN","PSOSIG",112,0)
 . N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOSIG",113,0)
 I $G(PSOQRND) D ROUND
"RTN","PSOSIG",114,0)
 G QEND
"RTN","PSOSIG",115,0)
QTS ;*282 Preserve Old Functionality
"RTN","PSOSIG",116,0)
 S PSOFRQ=$$QTSCH(QTSH)
"RTN","PSOSIG",117,0)
 I '$G(PSOFRQ) S PSQQUIT=1
"RTN","PSOSIG",118,0)
 Q
"RTN","PSOSIG",119,0)
 ;
"RTN","PSOSIG",120,0)
QTSCH(QTSH) ; 
"RTN","PSOSIG",121,0)
 ; Return Frequency for Schedule QTSH
"RTN","PSOSIG",122,0)
 ; Otherwise return ""
"RTN","PSOSIG",123,0)
 N PSOFRQ,SPCT,FOUND
"RTN","PSOSIG",124,0)
 Q:$G(QTSH)="" ""
"RTN","PSOSIG",125,0)
 Q:$E(QTSH,1)=" " ""
"RTN","PSOSIG",126,0)
 S QTSH=$$UPPER(QTSH)
"RTN","PSOSIG",127,0)
 S SPCT=1,PSOFRQ=0 F I=1:1:$L(QTSH) I $E(QTSH,I)=" " S SPCT=SPCT+1
"RTN","PSOSIG",128,0)
 F I=0:1:SPCT-1 S SCHTMP=$P(QTSH," ",1,SPCT-I) Q:PSOFRQ  D
"RTN","PSOSIG",129,0)
 . F II=0:0 S II=$O(^PS(51.1,"APPSJ",SCHTMP,II)) Q:'II!PSOFRQ  S PSOFRQ=$P(^PS(51.1,II,0),"^",3)
"RTN","PSOSIG",130,0)
 Q:PSOFRQ PSOFRQ
"RTN","PSOSIG",131,0)
  F I=0:1:SPCT-1 S SCHTMP=$P(QTSH," ",1,SPCT-I) Q:PSOFRQ  D
"RTN","PSOSIG",132,0)
 . F II=0:0 S II=$O(^PS(51,"B",SCHTMP,II)) Q:'II!PSOFRQ  I $P(^PS(51,II,0),"^",4)<2 S PSOFRQ=$P(^PS(51,II,0),"^",8)
"RTN","PSOSIG",133,0)
 Q:PSOFRQ PSOFRQ
"RTN","PSOSIG",134,0)
 Q ""
"RTN","PSOSIG",135,0)
 ;
"RTN","PSOSIG",136,0)
QEND ;
"RTN","PSOSIG",137,0)
 ; PSOMTFLG variable indicates a Maintenance Rx (Titration/Maintenance)
"RTN","PSOSIG",138,0)
 K PSOFRQ
"RTN","PSOSIG",139,0)
 I $G(PSOOUTQT),$G(QTYHLD),$G(PSOQX("QTY")),$G(QTYHLD)'=$G(PSOQX("QTY")) W !!,"Quantity has been changed from "_QTYHLD_" to "_PSOQX("QTY") D  I '$G(PSOMTFLG) W ! N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOSIG",140,0)
 .I $G(PSONEW("FLD"))=8,$P($G(OR0),"^",24),$G(PSODRUG("IEN")),$D(^PSDRUG(+$G(PSODRUG("IEN")),0)) D
"RTN","PSOSIG",141,0)
 ..I $P(^PSDRUG(PSODRUG("IEN"),0),"^",3)[2!($P(^PSDRUG(PSODRUG("IEN"),0),"^",3)["F") Q
"RTN","PSOSIG",142,0)
 ..N ZRFA S ZRFA=$S($G(CLOZPAT)=2&(PSOQX("DAYS SUPPLY")=14):1,$G(CLOZPAT)=2&(PSOQX("DAYS SUPPLY")=7):3,$G(CLOZPAT)=1&(PSOQX("DAYS SUPPLY")=7):1,$D(CLOZPAT):0,1:5)
"RTN","PSOSIG",143,0)
 ..N ZREF,ZTQ S ZREF=QTYHLD\PSOQX("QTY") I ZREF>0 D
"RTN","PSOSIG",144,0)
 ...S ZTQ=QTYHLD*(PSOQX("# OF REFILLS")+1),ZTQ=ZTQ-PSOQX("QTY"),ZREF=ZTQ\PSOQX("QTY") S:ZREF>ZRFA ZREF=ZRFA
"RTN","PSOSIG",145,0)
 ...I ZREF'=PSOQX("# OF REFILLS") W !,"# of Refills has been changed from "_PSOQX("# OF REFILLS")_" to "_ZREF S PSOQX("# OF REFILLS")=ZREF
"RTN","PSOSIG",146,0)
 Q
"RTN","PSOSIG",147,0)
ROUND ;
"RTN","PSOSIG",148,0)
 Q:'$G(PSOQRND)
"RTN","PSOSIG",149,0)
 I PSOQRND'["." S PSOQX("QTY")=PSOQRND Q
"RTN","PSOSIG",150,0)
 S PSOQX("QTY")=$P(PSOQRND,".")+1
"RTN","PSOSIG",151,0)
 Q
"RTN","PSOSIG",152,0)
DAY(DATE) ;First 5 digits of FileMan date
"RTN","PSOSIG",153,0)
 N X
"RTN","PSOSIG",154,0)
 I DATE'?5N Q -1
"RTN","PSOSIG",155,0)
 S X=$E(DATE,4,5) I X<1!(X>12) Q -1
"RTN","PSOSIG",156,0)
 S X=DATE+1+(X=12*88)_"01"
"RTN","PSOSIG",157,0)
 Q $E($$FMADD^XLFDT(X,-1),6,7)
"RTN","PSOSIG",158,0)
 ;
"RTN","PSOSIG",159,0)
QTYX(PSOQX) ;
"RTN","PSOSIG",160,0)
 N PSOQLP,PSOQLN,PSOQAR,PSOCPRQT,QDOSE,QDOSEX S PSOCPRQT=1 F PSOQLP=0:0 S PSOQLP=$O(PSOQX("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIG",161,0)
 .S PSOQAR("DURATION",PSOQLP)=$G(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIG",162,0)
 .I $E(PSOQX("DURATION",PSOQLP))?1A S PSOQLN=$L(PSOQX("DURATION",PSOQLP)) S PSOQX("DURATION",PSOQLP)=$E(PSOQX("DURATION",PSOQLP),2,PSOQLN)_$E(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIG",163,0)
 S QDOSE=0 F QDOSEX=0:0 S QDOSEX=$O(PSOQX("DOSE ORDERED",QDOSEX)) Q:'QDOSEX  S QDOSE=QDOSE+1
"RTN","PSOSIG",164,0)
 I '$G(PSOQX("QTY")) D QTYCP G QPASS
"RTN","PSOSIG",165,0)
 D QTYCP^PSOSIGDS
"RTN","PSOSIG",166,0)
QPASS F PSOQLP=0:0 S PSOQLP=$O(PSOQAR("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIG",167,0)
 .S PSOQX("DURATION",PSOQLP)=$G(PSOQAR("DURATION",PSOQLP))
"RTN","PSOSIG",168,0)
 K PSOCPRQT
"RTN","PSOSIG",169,0)
 Q
"RTN","PSOSIG",170,0)
DAYS(PSOQX) ;Entry point for Days Supply calc for PSO
"RTN","PSOSIG",171,0)
 ;Kill days supply here
"RTN","PSOSIG",172,0)
 Q:'$G(PSOQX("QTY"))
"RTN","PSOSIG",173,0)
 D QTYOPS^PSOSIGDS
"RTN","PSOSIG",174,0)
 Q
"RTN","PSOSIG",175,0)
 ;
"RTN","PSOSIG",176,0)
UPDQTY(NEWQTY) ; If DAYS SUPPLY is being edited and previous QTY was not calculated, don't calculate and update QTY
"RTN","PSOSIG",177,0)
 ; Also, if digitally signed, do not automatically calculate and update quantity if QTY increases
"RTN","PSOSIG",178,0)
 ; Input: NEWQTY - Newly Calculated Quantity
"RTN","PSOSIG",179,0)
 ;Output: 1: YES - Update Rx with re-calculated QTY / 0: NO - Don't update Rx with re-calculated QTY
"RTN","PSOSIG",180,0)
 N UPDQTY,PSOFREQ,PSOOLDDS,PSONEWDS,PSOOLDQT,PSODOSOR,PSODUR
"RTN","PSOSIG",181,0)
 S UPDQTY=1 I 'NEWQTY Q UPDQTY
"RTN","PSOSIG",182,0)
 S PSOOLDDS=$G(PSOQX("OLD DAYS SUPPLY")) I 'PSOOLDDS Q UPDQTY ; DAYS SUPPLY value prior to edit
"RTN","PSOSIG",183,0)
 S PSONEWDS=$G(PSOQX("DAYS SUPPLY")) I 'PSONEWDS Q UPDQTY ; New DAYS SUPPLY value
"RTN","PSOSIG",184,0)
 S PSOOLDQT=$G(QTYHLD) I 'PSOOLDQT Q UPDQTY ; QTY on file, possibly calculated
"RTN","PSOSIG",185,0)
 S PSOFREQ=$$SCHFREQ(),PSODOSOR=$G(PSOQX("DOSE ORDERED",1))
"RTN","PSOSIG",186,0)
 S PSODUR=$G(PSOQX("DURATION",1)) I PSODUR,PSODUR<PSOOLDDS S PSOOLDDS=PSODUR
"RTN","PSOSIG",187,0)
 ;
"RTN","PSOSIG",188,0)
 ;Checking whether current QTY was previously calculated, if not don't update with new QTY
"RTN","PSOSIG",189,0)
 I (PSODOSOR<1)!(PSOFREQ>1440) D
"RTN","PSOSIG",190,0)
 . ;Different calculation for doses of less than one QTY (e.g., 1/2 tablet) OR frequency lower than every 24hrs
"RTN","PSOSIG",191,0)
 . I PSOFREQ,(((PSOOLDDS*(1440/PSOFREQ))*PSODOSOR)+.9\1)'=PSOOLDQT S UPDQTY=0
"RTN","PSOSIG",192,0)
 E  D
"RTN","PSOSIG",193,0)
 . ;Checking whether current QTY was previously calculated
"RTN","PSOSIG",194,0)
 . I ((NEWQTY/PSONEWDS)'=(PSOOLDQT/PSOOLDDS)) S UPDQTY=0
"RTN","PSOSIG",195,0)
 ;
"RTN","PSOSIG",196,0)
 ;QTY is increasing for a CS Rx/Order, so don't update with new QTY
"RTN","PSOSIG",197,0)
 I ($G(PSOFDR)&$P($G(OR0),"^",24)&(NEWQTY>PSOOLDQT)) S UPDQTY=0
"RTN","PSOSIG",198,0)
 ;
"RTN","PSOSIG",199,0)
 I 'UPDQTY D
"RTN","PSOSIG",200,0)
 . W !!,"The Quantity (",PSOOLDQT,") has not been changed."
"RTN","PSOSIG",201,0)
 . W !,"Please review and update it if necessary.",!,$C(7)
"RTN","PSOSIG",202,0)
 . N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOSIG",203,0)
 Q UPDQTY
"RTN","PSOSIG",204,0)
 ;
"RTN","PSOSIG",205,0)
SCHFREQ() ; Returns the Frequency (in minutes) for the schedule
"RTN","PSOSIG",206,0)
 ; Output: SCHFREQ - Schedule Frequency (in minutes)
"RTN","PSOSIG",207,0)
 N SCHED,SCHEDIEN
"RTN","PSOSIG",208,0)
 S SCHED=$G(PSOQX("SCHEDULE",1)) I SCHED="" Q 0
"RTN","PSOSIG",209,0)
 S SCHEDIEN=$O(^PS(51.1,"B",SCHED,0)) I SCHEDIEN Q $$GET1^DIQ(51.1,SCHEDIEN,2)
"RTN","PSOSIG",210,0)
 S SCHEDIEN=$O(^PS(51,"B",SCHED,0)) I SCHEDIEN Q $$GET1^DIQ(51,SCHEDIEN,31)
"RTN","PSOSIG",211,0)
 Q 0
"RTN","PSOSIG",212,0)
 ;
"RTN","PSOSIG",213,0)
UPPER(PSOSCUP) ;
"RTN","PSOSIG",214,0)
 Q $TR(PSOSCUP,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSOVER1")
0^2^B131717973
"RTN","PSOVER1",1,0)
PSOVER1 ;BHAM ISC/SAB - verify one rx ;3/9/05 12:53pm
"RTN","PSOVER1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**32,46,90,131,202,207,148,243,268,281,324,358,251,375,387,379,390,372,416,411,422,402,500**;DEC 1997;Build 9
"RTN","PSOVER1",3,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOVER1",4,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOVER1",5,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOVER1",6,0)
 ;External reference to DOSE^PSSORPH is supported by DBIA 3234
"RTN","PSOVER1",7,0)
 ;External reference to ^ORRDI1 supported by DBIA 4659
"RTN","PSOVER1",8,0)
 ;External reference to ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOVER1",9,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSOVER1",10,0)
 ;External reference to $$GETNDC^PSSNDCUT supported by DBIA 4707
"RTN","PSOVER1",11,0)
 ;External reference to ^DPT( supported by DBIA 3097
"RTN","PSOVER1",12,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOVER1",13,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOVER1",14,0)
 ;External reference to ^PS(56 supported by DBIA 2229
"RTN","PSOVER1",15,0)
REDO ;
"RTN","PSOVER1",16,0)
 I '$G(PSOCLK) Q:$G(PSVERFLG)
"RTN","PSOVER1",17,0)
 S (DRG,PSODRUG("NAME"))=$P(^PSDRUG(+$P(^PSRX(PSONV,0),"^",6),0),"^"),PSODRUG("VA CLASS")=$P(^(0),"^",2)
"RTN","PSOVER1",18,0)
 S PSOVQUIT=0,PSODRUG("IEN")=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",19,0)
 S PSOY(0)=^PSDRUG(PSODRUG("IEN"),0),PSOY=PSODRUG("IEN")_"^"_$P(PSOY(0),"^")
"RTN","PSOVER1",20,0)
 D SET^PSODRG
"RTN","PSOVER1",21,0)
 I '$D(PSODFN) S PSODFN=$P(^PSRX(PSONV,0),"^",2)
"RTN","PSOVER1",22,0)
 ;
"RTN","PSOVER1",23,0)
EDIT ;
"RTN","PSOVER1",24,0)
 N PSDNEW,PSDOLD
"RTN","PSOVER1",25,0)
 S (PSDNEW,PSDOLD)="",PSDOLD=$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^")_"^"_PSONV
"RTN","PSOVER1",26,0)
 S DA=PSONV D ^PSORXPR
"RTN","PSOVER1",27,0)
 I $G(PSORX("DFLG")) G OUT  ;*422
"RTN","PSOVER1",28,0)
 I $G(PKI1)=2 D DCV1^PSOPKIV1 G OUT
"RTN","PSOVER1",29,0)
 K PSDTSTOP S DIR("A")="EDIT",DIR("B")="N",DIR(0)="SB^Y:YES;N:NO;P:PROFILE",DIR("?")="Enter Y to change this RX, P to see a profile, or N to proceed with verification and order checks."
"RTN","PSOVER1",30,0)
 D ^DIR K DIR W ! I $G(DIRUT)!($G(DTOUT)) S PSOVBCK=1 G OUT
"RTN","PSOVER1",31,0)
 ;PSOPOCK=1 called from Process Order Check option; PSOCLK=1 means initiated from Rx verify by clerk.
"RTN","PSOVER1",32,0)
 I Y="Y",($G(PSOCLK)!($G(PSOPOCK))) D FULLEDT S VALMBCK="R" G KILL:$$CHECK(PSONV) G EDIT
"RTN","PSOVER1",33,0)
 I Y="Y",$G(PSOACT)]"" S VALMBCK="R",PSVERFLG=1 G OUT  ;this pops the user back to the med profile screen when verify is called from Patient Prescription Processing
"RTN","PSOVER1",34,0)
 I $D(DIRUT),$G(PSOCLK) S PSOCQ=1 G OUT
"RTN","PSOVER1",35,0)
 I $D(DIRUT),$G(PSOACT)]"" S VALMBCK="R" G OUT
"RTN","PSOVER1",36,0)
 G ORDCHK:Y="N",PROF:Y="P",OUT:"YNP"'[$E(Y)
"RTN","PSOVER1",37,0)
 ;
"RTN","PSOVER1",38,0)
 D EXPIRE K DIE,DR,DEA1,DEA2,P(5),PSRX1,PSRX2
"RTN","PSOVER1",39,0)
 K PSD(PSDOLD) S PSDNEW="",PSDNEW=$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^")_"^"_PSONV,PSD(PSDNEW)=PSONV_"^*^1^"_$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^",2)
"RTN","PSOVER1",40,0)
 ;
"RTN","PSOVER1",41,0)
 S DA=$S($D(PSORXED("IRXN")):PSORXED("IRXN"),1:PSONV) D ^PSORXPR G OUT:$G(DIRUT)
"RTN","PSOVER1",42,0)
 G OUT:$D(DIRUT)!($D(DTOUT))
"RTN","PSOVER1",43,0)
 I '$G(PSOCLK) S DA=$S($D(PSORXED("IRXN")):PSORXED("IRXN"),1:PSONV) W !,"CHANGE",! D ^PSORXPR G OUT:$D(DIRUT)!($D(DTOUT)) G EDIT
"RTN","PSOVER1",44,0)
 G EDIT:PSDNEW=PSDOLD,REDO
"RTN","PSOVER1",45,0)
PROF I '$D(PSOSD) W !,$C(7),"This patient has no other prescriptions on file",!! G EDIT Q
"RTN","PSOVER1",46,0)
 W !!,$P(^DPT(DFN,0),"^"),?40,"ID#:"_VA("PID") W:$D(INT)!$D(PSONV) "  RX#: "_$S($D(INT):$P(INT,"^"),$D(^PSRX(PSONV)):$P(^PSRX(PSONV,0),"^"),1:"")
"RTN","PSOVER1",47,0)
 D HD^PSODDPR2() D ^PSODSPL D SHOW2^PSOVER G EDIT Q
"RTN","PSOVER1",48,0)
 ;
"RTN","PSOVER1",49,0)
EXPIRE S RX0=^PSRX(DA,0),X1=$P($P(RX0,"^",13),"."),X2=$P(RX0,"^",9)+1*$P(RX0,"^",8),X2=$S($P(RX0,"^",8)=X2:X2,X2<181:184,X2=360:366,1:X2),X=X1 D:X1&X2 C^%DTC
"RTN","PSOVER1",50,0)
 K ^PS(55,PSDFN,"P","A",+$P(^PSRX(DA,2),"^",6),DA) S ^PS(55,PSDFN,"P","A",X,DA)="",$P(^PSRX(DA,2),"^",6)=X,$P(^PS(52.4,DA,0),"^",7)=X K X1,X2 Q
"RTN","PSOVER1",51,0)
 ;
"RTN","PSOVER1",52,0)
ORDCHK ;
"RTN","PSOVER1",53,0)
 S PSOVER1=1
"RTN","PSOVER1",54,0)
 S RX0=^PSRX(PSONV,0)
"RTN","PSOVER1",55,0)
 D ORDCK
"RTN","PSOVER1",56,0)
 I $G(PSOQUIT) S:$G(PSOCLK) PSOQUIT=0 S:'$G(PSOCLK) PSORX("DFLG")=1  ;if verify by clerk continue on with the next Rx; if not exit
"RTN","PSOVER1",57,0)
 I $G(PSOVQUIT)!$G(PSORX("DFLG")) G OUT
"RTN","PSOVER1",58,0)
 ;------
"RTN","PSOVER1",59,0)
VERIFY ;
"RTN","PSOVER1",60,0)
 D FULL^VALM1 G:'$P(PSOPAR,"^",2) VERY
"RTN","PSOVER1",61,0)
 W !,$P(^DPT(DFN,0),"^"),?40,"ID#:"_VA("PID") W:$D(INT)!$D(PSONV) "  RX#: "_$S($D(INT):$P(INT,"^"),$D(^PSRX(PSONV)):$P(^PSRX(PSONV,0),"^"),1:"") W:$D(PSODRUG("NAME")) !,PSODRUG("NAME"),!
"RTN","PSOVER1",62,0)
 I $G(PSONAM)="" S PSONAM=$P(^DPT(PSDFN,0),"^")
"RTN","PSOVER1",63,0)
 S DIR("A")="VERIFY FOR "_PSONAM_"? (Y/N/Delete/Quit): ",DIR("B")="Y",DIR(0)="SA^Y:YES;N:NO;D:DELETE;Q:QUIT"
"RTN","PSOVER1",64,0)
 S DIR("?",1)="Enter Y (or return) to verify this prescription",DIR("?",2)="N to leave this prescription non-verified and to end this session of verification",DIR("?")="D to delete this prescription"
"RTN","PSOVER1",65,0)
 D ^DIR K DIR
"RTN","PSOVER1",66,0)
 I Y="N"!("Q^"[$E(Y)) D  G OUT
"RTN","PSOVER1",67,0)
 .S (PSVERFLG,PSOVBCK)=1,PSORX("DFLG")=1
"RTN","PSOVER1",68,0)
 .S:$D(PSOOVNOD) ^PS(52.4,PSONV,0)=PSOOVNOD S:$G(PSOOVSTA) $P(^PSRX(PSONV,"STA"),"^")=PSOOVSTA
"RTN","PSOVER1",69,0)
 .S:PSOOVSTA=4 ^PS(52.4,"ADI",PSONV,1)=""
"RTN","PSOVER1",70,0)
 G DELETE:Y="D"
"RTN","PSOVER1",71,0)
VERY I $G(PKI1)=1 D REA^PSOPKIV1 G:'$D(PKIR) VERIFY
"RTN","PSOVER1",72,0)
 K ^PSRX(PSONV,"DAI") S $P(^PSRX(PSONV,3),"^",6)=""
"RTN","PSOVER1",73,0)
 K ^PSRX(PSONV,"DRI"),SPFL1
"RTN","PSOVER1",74,0)
 I '$O(^PSRX(PSONV,6,0)) D  I $D(DUOUT)!($D(DTOUT)) W !!,"Rx: "_$P(^PSRX(DA,0),"^")_" not Verified!!",! H 2 G OUT
"RTN","PSOVER1",75,0)
 .W !!,"Dosing Instructions Missing. Please add!",!
"RTN","PSOVER1",76,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^")]"",'$P($G(^("SIG")),"^",2) W "SIG: "_$P(^PSRX(PSONV,"SIG"),"^"),!
"RTN","PSOVER1",77,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^",2),$O(^PSRX(PSONV,"SIG1",0)) D  K I
"RTN","PSOVER1",78,0)
 ..W "SIG: " F I=0:0 S I=$O(^PSRX(PSONV,"SIG1",I)) Q:'I  W ^PSRX(PSONV,"SIG1",I,0),!
"RTN","PSOVER1",79,0)
 .S DA=PSONV,PSOVER=1 K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOVER1",80,0)
 .S PSODRUG("IEN")=$P(^PSRX(DA,0),"^",6),PSODFN=$P(^(0),"^",2),PSORXED("IRXN")=DA,PSODRUG("OI")=$P(^PSRX(DA,"OR1"),"^")
"RTN","PSOVER1",81,0)
 .D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN),^PSOORED3
"RTN","PSOVER1",82,0)
 .K PSODFN,PSODRUG("IEN"),DOSE,PSOVER
"RTN","PSOVER1",83,0)
 .I '$G(ENT) S DUOUT=1
"RTN","PSOVER1",84,0)
 .Q:$D(DUOUT)!($D(DTOUT))
"RTN","PSOVER1",85,0)
 .K DIR,DIRUT,DUOUT,DTOUT S DIE=52,DR=114 D ^DIE K DIE,DR,DTOUT
"RTN","PSOVER1",86,0)
 .I X'="" D SIG^PSOHELP D:$G(INS1)]"" EN^DDIOL($E(INS1,2,9999999)) S PSORXED("SIG",1)=$E(INS1,2,9999999)
"RTN","PSOVER1",87,0)
 .D EN^PSOFSIG(.PSORXED,1),UDSIG^PSOORED3 H 2
"RTN","PSOVER1",88,0)
 S DA=PSONV,$P(^PSRX(DA,2),"^",10)=DUZ,DRG=$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^")
"RTN","PSOVER1",89,0)
 I $P(^PSRX(DA,2),"^",2)>DT,$P(PSOPAR,"^",6) D  G KILL
"RTN","PSOVER1",90,0)
 .S (SPFL1,PSOVER)="",PSORX("FILL DATE")=$P(^PSRX(DA,2),"^",2),RXF=0
"RTN","PSOVER1",91,0)
 .D UPSUS S PSTRIVER=1 D SUS^PSORXL
"RTN","PSOVER1",92,0)
 .K PSORX("FILL DATE"),PSTRIVER
"RTN","PSOVER1",93,0)
 .I $D(^TMP("PSODAOC",$J)) D ^PSONEWOC K ^TMP("PSODAOC",$J)
"RTN","PSOVER1",94,0)
 S PSOVER(PSONV)="" S $P(^PSRX(PSONV,"STA"),"^")=0,DRG=$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^")
"RTN","PSOVER1",95,0)
 S $P(PSOSD("NON-VERIFIED",DRG),"^",2)=0,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG)
"RTN","PSOVER1",96,0)
 I $D(^TMP("PSODAOC",$J)) D ^PSONEWOC K ^TMP("PSODAOC",$J)
"RTN","PSOVER1",97,0)
 I $G(PKI1)=1,$G(PKIR)]"" D ACT^PSOPKIV1(DA)
"RTN","PSOVER1",98,0)
 K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","") ;S VALMBCK=""
"RTN","PSOVER1",99,0)
 ;saves drug allergy order chks pso*7*390
"RTN","PSOVER1",100,0)
 I +$G(^TMP("PSODAOC",$J,1,0)) D
"RTN","PSOVER1",101,0)
 .I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSOVER1",102,0)
 .N RXN,PSODAOC S RXN=PSONV,PSODAOC="Rx Backdoor VERIFIED NEW Order Acceptance_OP"
"RTN","PSOVER1",103,0)
 .D DAOC^PSONEW
"RTN","PSOVER1",104,0)
 .K ^TMP("PSODAOC",$J),RET
"RTN","PSOVER1",105,0)
 ;
"RTN","PSOVER1",106,0)
 ; - Calling ECME for claims generation and transmission / REJECT handling
"RTN","PSOVER1",107,0)
 N ACTION
"RTN","PSOVER1",108,0)
 I $$SUBMIT^PSOBPSUT(PSONV) D  I ACTION="Q"!(ACTION="^") Q
"RTN","PSOVER1",109,0)
 . S ACTION="" D ECMESND^PSOBPSU1(PSONV,,,$S($O(^PSRX(PSONV,1,0)):"RF",1:"OF"))
"RTN","PSOVER1",110,0)
 . ; Quit if there is an unresolved Tricare non-billable reject code, PSO*7*358
"RTN","PSOVER1",111,0)
 . I $$PSOET^PSOREJP3(PSONV) S ACTION="Q" Q
"RTN","PSOVER1",112,0)
 . I $$FIND^PSOREJUT(PSONV) D
"RTN","PSOVER1",113,0)
 . . S ACTION=$$HDLG^PSOREJU1(PSONV,0,"79,88","OF","IOQ","Q")
"RTN","PSOVER1",114,0)
 ;
"RTN","PSOVER1",115,0)
KILL S DA=PSONV,DIK="^PS(52.4," D ^DIK K DA,DIK D DCORD^PSONEW2
"RTN","PSOVER1",116,0)
OUT ;
"RTN","PSOVER1",117,0)
 K PSOVER1
"RTN","PSOVER1",118,0)
 I '$G(PSOCLK) S:$G(DIRUT)!($G(DTOUT)) PSORX("DFLG")=1 K DIRUT,DTOUT,DUOUT,UPFLAGX D CLEAN S VALMBCK="Q" Q
"RTN","PSOVER1",119,0)
 I $G(PSOCLK) S PSORX("DFLG")=0 K UPFLAGX D CLEAN Q
"RTN","PSOVER1",120,0)
DELETE K UPFLAGX D DELETE^PSOVER2 G:$G(UPFLAGX) OUT K PSOSD("NON-VERIFIED",$G(DRG)) Q
"RTN","PSOVER1",121,0)
QUIT S PSOQUIT="" D CLEAN K PSOVER1 Q
"RTN","PSOVER1",122,0)
UPSUS S $P(PSOSD("NON-VERIFIED",DRG),"^",2)=5,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG) K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","")
"RTN","PSOVER1",123,0)
 Q
"RTN","PSOVER1",124,0)
CLEAN ;cleans up tmp("psorxdc") global
"RTN","PSOVER1",125,0)
 I $G(PSODOSEX) K PSODOSEX Q
"RTN","PSOVER1",126,0)
 N PSOWRITE
"RTN","PSOVER1",127,0)
 I $O(^TMP("PSORXDC",$J,0)) F RORD=0:0 S RORD=$O(^TMP("PSORXDC",$J,RORD)) Q:'RORD  D
"RTN","PSOVER1",128,0)
 .D PSOUL^PSSLOCK(RORD_$S($P(^TMP("PSORXDC",$J,RORD,0),"^")="P":"S",1:""))
"RTN","PSOVER1",129,0)
 .I $P(^TMP("PSORXDC",$J,RORD,0),"^")="P" D  Q
"RTN","PSOVER1",130,0)
 ..S PSOR=^PS(52.41,RORD,0)
"RTN","PSOVER1",131,0)
 ..S DNM=$S($P(PSOR,"^",9):$P($G(^PSDRUG($P(PSOR,"^",9),0)),"^"),1:$P(^PS(50.7,$P(PSOR,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(PSOR,"^",8),0),"^",2),0),"^"))
"RTN","PSOVER1",132,0)
 ..W $C(7),!," Duplicate "_$S($P(^TMP("PSORXDC",$J,RORD,0),"^",10):"Therapy",1:"Drug")_" Pending Order "_DNM_" NOT Discontinued." S PSOWRITE=1
"RTN","PSOVER1",133,0)
 .W !," Duplicate "_$S($P(^TMP("PSORXDC",$J,RORD,0),"^",10):"Therapy",1:"Drug")_" Rx #"_$P(^PSRX(RORD,0),"^")_" "_$P(^TMP("PSORXDC",$J,RORD,0),"^",7)_" NOT Discontinued." S PSOWRITE=1
"RTN","PSOVER1",134,0)
 I $G(PSOWRITE)&('$G(PSOWRIT)) W ! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR S:($D(DTOUT))!($D(DUOUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,X,Y I ($Y+5)>IOSL W @IOF
"RTN","PSOVER1",135,0)
 K ^TMP("PSORXDC",$J),RORD,PRNXZ,ORNZZ,PSOR
"RTN","PSOVER1",136,0)
 Q
"RTN","PSOVER1",137,0)
KV1 ;
"RTN","PSOVER1",138,0)
 K PSOANSQD,DRET,LST,PSOQUIT,PSODRUG,PSONEW,SIG,PSODIR,PHI,PRC,ORCHK,ORDRG,PSOSIGFL,PSORX("ISSUE DATE"),PSORX("FILL DATE"),CLOZPAT
"RTN","PSOVER1",139,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOVER1",140,0)
 Q
"RTN","PSOVER1",141,0)
NVA ;
"RTN","PSOVER1",142,0)
 I $P(PSOSD(STA,DNM),"^",11) D NVA^PSODRDU1 Q
"RTN","PSOVER1",143,0)
 N PSOOI,CLASS,FLG,X,Y,RXREC,IFN
"RTN","PSOVER1",144,0)
 S (Y,FLG)=""
"RTN","PSOVER1",145,0)
 S RXREC=$P(PSOSD(STA,DNM),"^",10),PSOOI=+$G(^PS(55,DFN,"NVA",RXREC,0)),IFN=RXREC N DNM
"RTN","PSOVER1",146,0)
 F  S Y=$O(^PSDRUG("ASP",PSOOI,Y)) Q:Y=""!(FLG)  S DNM=$P(^PSDRUG(Y,0),"^"),CLASS=$P(^PSDRUG(Y,0),"^",2) I PSODRUG("NAME")=DNM!(CLASS=PSODRUG("VA CLASS")) D DSP^PSODRDU1 S FLG=1 Q
"RTN","PSOVER1",147,0)
 Q
"RTN","PSOVER1",148,0)
REMOTE ; 
"RTN","PSOVER1",149,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN) D
"RTN","PSOVER1",150,0)
 .I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOVER1",151,0)
 .I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOVER1",152,0)
 .D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSOVER1",153,0)
 .I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) D  Q
"RTN","PSOVER1",154,0)
 ..I $T(REMOTE^PSORX1)]"" Q
"RTN","PSOVER1",155,0)
 ..W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)>IOSL)
"RTN","PSOVER1",156,0)
 .W !!,"Now doing remote order checks. Please wait..."
"RTN","PSOVER1",157,0)
 .D REMOTE^PSOORRDI(PSODFN,+$P($G(^PSRX(PSONV,0)),"^",6))
"RTN","PSOVER1",158,0)
 .I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)>IOSL) ;D PAUSE^PSOORRD2 Q
"RTN","PSOVER1",159,0)
 .I $D(^TMP($J,"DD")) D DUP^PSOORRD2
"RTN","PSOVER1",160,0)
 .I $D(^TMP($J,"DC")) D CLS^PSOORRD2
"RTN","PSOVER1",161,0)
 .I $D(^TMP($J,"DI"_PSODFN)) K ^TMP($J,"DI") M ^TMP($J,"DI")=^TMP($J,"DI"_PSODFN) D DRGINT^PSOORRD2
"RTN","PSOVER1",162,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN)
"RTN","PSOVER1",163,0)
 Q
"RTN","PSOVER1",164,0)
NOALRGY ;
"RTN","PSOVER1",165,0)
 N PSODFN,PSODRUG
"RTN","PSOVER1",166,0)
 S PSODFN=$P(^PSRX(PSONV,0),"^",2),PSODRUG("IEN")=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",167,0)
 D NOALRGY^PSODRG
"RTN","PSOVER1",168,0)
 Q
"RTN","PSOVER1",169,0)
 ;
"RTN","PSOVER1",170,0)
ORDCK ;
"RTN","PSOVER1",171,0)
 N ORN,ORNZZ,PSOLST,Y,PSOODFN S ORN=PSONV,PSOLST(PSONV)=PSONV_"^"_PSONV,PSOVORD=1
"RTN","PSOVER1",172,0)
 N DRG,ON,CT,DRGI,PDRG,SEV,STX,INT,CLI,PSONULN,PSONULN1,LST,LSI,DGI,SER,SERS,DUPT,SV
"RTN","PSOVER1",173,0)
 S ORNZZ=ORN,PRNXZ(ORN)=PSOLST(ORN),PSORENW("OIRXN")=PSONV,PSOODFN=DFN
"RTN","PSOVER1",174,0)
 I '$D(PSODFN) S PSODFN=$P(^PSRX(PSONV,0),"^",2)
"RTN","PSOVER1",175,0)
 D SHOW^PSOVER D HD^PSODDPR2():(($Y+5)>IOSL)
"RTN","PSOVER1",176,0)
 S (PSODRUG("IEN"),PSDRUG("IEN"))=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",177,0)
 N PSOVINF S PSOVINF=^PSDRUG(PSDRUG("IEN"),0),PSODRUG("VA CLASS")=$P(^(0),"^",2)
"RTN","PSOVER1",178,0)
 S PSODRUG("VA CLASS")=$P(PSOVINF,"^",2),(DRG,PSODRUG("NAME"))=$P(^PSDRUG(PSDRUG("IEN"),0),"^")
"RTN","PSOVER1",179,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(PSDRUG("IEN"),"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOVER1",180,0)
 S PSODRUG("MAXDOSE")=$P(PSOVINF,"^",4),PSODRUG("DEA")=$P(PSOVINF,"^",3),PSODRUG("CLN")=$S($D(^PSDRUG(PSDRUG("IEN"),"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSOVER1",181,0)
 S PSODRUG("SIG")=$P(PSOVINF,"^",5),PSODRUG("NDC")=$$GETNDC^PSSNDCUT(PSDRUG("IEN"),$G(PSOSITE)),PSODRUG("STKLVL")=$G(^PSDRUG(PSDRUG("IEN"),660.1))
"RTN","PSOVER1",182,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,PSONV,81)
"RTN","PSOVER1",183,0)
 K PSOVINF
"RTN","PSOVER1",184,0)
 D POST^PSODRG S DFN=PSOODFN
"RTN","PSOVER1",185,0)
 I $$GET1^DIQ(52,PSONV,100,"I")=13 S PSORX("DFLG")=1 Q
"RTN","PSOVER1",186,0)
 I $G(PSVERFLG),$G(PSOCLK) S PSVERFLG=0
"RTN","PSOVER1",187,0)
 I $G(PSOCLK),$G(PSORX("DFLG")) S PSOVQUIT=1 K PSORX("DFLG"),DIRUT,DTOUT Q
"RTN","PSOVER1",188,0)
 Q:PSORX("DFLG")
"RTN","PSOVER1",189,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("V")
"RTN","PSOVER1",190,0)
 I $$GET1^DIQ(52,PSONV,100,"I")=13 S PSORX("DFLG")=1 Q
"RTN","PSOVER1",191,0)
 I $G(PSOCLK),$G(PSORX("DFLG")) S PSOVQUIT=1 K PSORX("DFLG"),DIRUT,DTOUT Q
"RTN","PSOVER1",192,0)
 Q:PSORX("DFLG")!($G(PSOQUIT))
"RTN","PSOVER1",193,0)
 S PSOLST(ORNZZ)=PRNXZ(ORNZZ),ORN=ORNZZ K PSORENW("OIRXN")
"RTN","PSOVER1",194,0)
 Q
"RTN","PSOVER1",195,0)
 ;
"RTN","PSOVER1",196,0)
FULLEDT  ;
"RTN","PSOVER1",197,0)
 D FULL^VALM1
"RTN","PSOVER1",198,0)
 N RX,FILL,OPSOLST,OPSLST,OLDDA,PSODRUG,REJ
"RTN","PSOVER1",199,0)
 S (RX,PSORXED("IRXN"))=PSONV
"RTN","PSOVER1",200,0)
 M OPSOLST=PSOLST,OPSLST=PSLST,ODA=DA
"RTN","PSOVER1",201,0)
 N PSOSITE,ORN,PSOPAR,PSOLIST,PSOSD
"RTN","PSOVER1",202,0)
 S PSOSITE=$$RXSITE^PSOBPSUT(RX,""),ORN=RX
"RTN","PSOVER1",203,0)
 S PSOPAR=$G(^PS(59,PSOSITE,1)),PSOLIST(1)=ORN_","
"RTN","PSOVER1",204,0)
 D EPH^PSORXEDT
"RTN","PSOVER1",205,0)
 M PSOLST=OPSOLST,PSLST=OPSLST S VALMBCK="R" S:$D(OLDDA) DA=OLDDA
"RTN","PSOVER1",206,0)
 Q
"RTN","PSOVER1",207,0)
 ;
"RTN","PSOVER1",208,0)
DRIDOSE(DA,RX0) ;where DA is RXIEN and RX0 is zero node of file 52 for the RXIEN
"RTN","PSOVER1",209,0)
 N T,RXN,RXX,SCRIPT,SEV,X,SER,PSOSERV,PSOSCPT,PSODOSF,RX
"RTN","PSOVER1",210,0)
 S RX=RX0
"RTN","PSOVER1",211,0)
 S RXN=$P(RX0,"^")
"RTN","PSOVER1",212,0)
 I $D(^PS(52.4,RX,0))!($D(^PSRX(RX,"DRI"))) D
"RTN","PSOVER1",213,0)
 . Q:'$P($G(^PS(52.4,RX,0)),"^",8)&('$D(^PSRX(RX,"DRI")))
"RTN","PSOVER1",214,0)
 .W !!,"*** During order, there were DRUG-DRUG INTERACTION for the following RX(s):"
"RTN","PSOVER1",215,0)
 I $P($G(^PS(52.4,RX,0)),"^",8) S SCRIPT=$P(^PS(52.4,RX,0),"^",10),SEV=$P(^PS(52.4,RX,0),"^",9) F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOVER1",216,0)
 . S SER=$P(^PS(56,SEV(X),0),"^",4) S:$G(SER)=1 PSOSERV=1
"RTN","PSOVER1",217,0)
 . S PSOSCPT(RXX(X))="     "_$S(SER=1:"CRITICAL",SER=2:"SIGNIFICANT",1:"UNKNOWN")_" INTERACTION    "_$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^")
"RTN","PSOVER1",218,0)
 I $D(^PSRX(RX,"DRI")) S SCRIPT=$P(^PSRX(RX,"DRI"),"^",2),SEV=$P(^PSRX(RX,"DRI"),"^") F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOVER1",219,0)
 .S SER=$P(^PS(56,SEV(X),0),"^",4)
"RTN","PSOVER1",220,0)
 .S PSOSCPT(RXX(X))="     "_$P($G(^PSRX(RXX(X),0)),"^")_"  "_$S(SER=1:"CRITICAL",SER=2:"SIGNIFICANT",1:"UNKNOWN")_" INTERACTION  "_$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^")
"RTN","PSOVER1",221,0)
 S SCRIPT="" F  S SCRIPT=$O(PSOSCPT(SCRIPT)) Q:SCRIPT=""  W !,PSOSCPT(SCRIPT)
"RTN","PSOVER1",222,0)
 I $$DS^PSSDSAPI,$D(^PS(52.4,RX,1)) S T=$P(^PS(52.4,RX,1),"^") D  W:PSODOSF'="" !,"*** Dose Warning: ",PSODOSF
"RTN","PSOVER1",223,0)
 . S PSODOSF="",PSODOSF=$S(T=4:"DOSAGE EXCEEDS MAX SINGLE DOSE AND/OR MAX DAILY DOSE",T=3:"MAX SINGLE DOSE & DAILY DOSE RANGE",T=2:"MAX SINGLE DOSE",T=1:"DAILY DOSE RANGE",1:"")
"RTN","PSOVER1",224,0)
 W !
"RTN","PSOVER1",225,0)
 Q
"RTN","PSOVER1",226,0)
CHECK(PSONV) ;
"RTN","PSOVER1",227,0)
 N PSOSTAT S PSOSTAT=$$GET1^DIQ(52,PSONV,100,"I")
"RTN","PSOVER1",228,0)
 I ",11,12,13,14,15,"[(","_PSOSTAT_",") Q 1
"RTN","PSOVER1",229,0)
 Q 0
"VER")
8.0^22.2
**INSTALL NAME**
PSJ*5.0*347
"BLD",9883,0)
PSJ*5.0*347^INPATIENT MEDICATIONS^0^3180104^y
"BLD",9883,1,0)
^^1^1^3170816^
"BLD",9883,1,1,0)
Follow up build to MOCHA 2.1b
"BLD",9883,4,0)
^9.64PA^^
"BLD",9883,6.3)
6
"BLD",9883,"ABPKG")
n
"BLD",9883,"KRN",0)
^9.67PA^779.2^20
"BLD",9883,"KRN",.4,0)
.4
"BLD",9883,"KRN",.4,"NM",0)
^9.68A^^
"BLD",9883,"KRN",.401,0)
.401
"BLD",9883,"KRN",.402,0)
.402
"BLD",9883,"KRN",.403,0)
.403
"BLD",9883,"KRN",.5,0)
.5
"BLD",9883,"KRN",.84,0)
.84
"BLD",9883,"KRN",3.6,0)
3.6
"BLD",9883,"KRN",3.8,0)
3.8
"BLD",9883,"KRN",9.2,0)
9.2
"BLD",9883,"KRN",9.8,0)
9.8
"BLD",9883,"KRN",9.8,"NM",0)
^9.68A^15^15
"BLD",9883,"KRN",9.8,"NM",1,0)
PSIVOCDS^^0^B140874598
"BLD",9883,"KRN",9.8,"NM",2,0)
PSGOD^^0^B30203742
"BLD",9883,"KRN",9.8,"NM",3,0)
PSGOER^^0^B90786181
"BLD",9883,"KRN",9.8,"NM",4,0)
PSJOCDSD^^0^B35960175
"BLD",9883,"KRN",9.8,"NM",5,0)
PSGOEV^^0^B95461290
"BLD",9883,"KRN",9.8,"NM",6,0)
PSJLIFNI^^0^B13554613
"BLD",9883,"KRN",9.8,"NM",7,0)
PSIVSP^^0^B45290793
"BLD",9883,"KRN",9.8,"NM",8,0)
PSGS0^^0^B79536208
"BLD",9883,"KRN",9.8,"NM",9,0)
PSJGMRA^^0^B19012302
"BLD",9883,"KRN",9.8,"NM",10,0)
PSGSICHK^^0^B36513168
"BLD",9883,"KRN",9.8,"NM",11,0)
PSJDGAL^^1^
"BLD",9883,"KRN",9.8,"NM",12,0)
PSJBLDOC^^0^B59663394
"BLD",9883,"KRN",9.8,"NM",13,0)
PSJBCMA3^^0^B4491132
"BLD",9883,"KRN",9.8,"NM",14,0)
PSJPDCL^^0^B59283748
"BLD",9883,"KRN",9.8,"NM",15,0)
PSJLIACT^^0^B59558968
"BLD",9883,"KRN",9.8,"NM","B","PSGOD",2)

"BLD",9883,"KRN",9.8,"NM","B","PSGOER",3)

"BLD",9883,"KRN",9.8,"NM","B","PSGOEV",5)

"BLD",9883,"KRN",9.8,"NM","B","PSGS0",8)

"BLD",9883,"KRN",9.8,"NM","B","PSGSICHK",10)

"BLD",9883,"KRN",9.8,"NM","B","PSIVOCDS",1)

"BLD",9883,"KRN",9.8,"NM","B","PSIVSP",7)

"BLD",9883,"KRN",9.8,"NM","B","PSJBCMA3",13)

"BLD",9883,"KRN",9.8,"NM","B","PSJBLDOC",12)

"BLD",9883,"KRN",9.8,"NM","B","PSJDGAL",11)

"BLD",9883,"KRN",9.8,"NM","B","PSJGMRA",9)

"BLD",9883,"KRN",9.8,"NM","B","PSJLIACT",15)

"BLD",9883,"KRN",9.8,"NM","B","PSJLIFNI",6)

"BLD",9883,"KRN",9.8,"NM","B","PSJOCDSD",4)

"BLD",9883,"KRN",9.8,"NM","B","PSJPDCL",14)

"BLD",9883,"KRN",19,0)
19
"BLD",9883,"KRN",19,"NM",0)
^9.68A^^
"BLD",9883,"KRN",19.1,0)
19.1
"BLD",9883,"KRN",101,0)
101
"BLD",9883,"KRN",409.61,0)
409.61
"BLD",9883,"KRN",771,0)
771
"BLD",9883,"KRN",779.2,0)
779.2
"BLD",9883,"KRN",870,0)
870
"BLD",9883,"KRN",8989.51,0)
8989.51
"BLD",9883,"KRN",8989.52,0)
8989.52
"BLD",9883,"KRN",8994,0)
8994
"BLD",9883,"KRN","B",.4,.4)

"BLD",9883,"KRN","B",.401,.401)

"BLD",9883,"KRN","B",.402,.402)

"BLD",9883,"KRN","B",.403,.403)

"BLD",9883,"KRN","B",.5,.5)

"BLD",9883,"KRN","B",.84,.84)

"BLD",9883,"KRN","B",3.6,3.6)

"BLD",9883,"KRN","B",3.8,3.8)

"BLD",9883,"KRN","B",9.2,9.2)

"BLD",9883,"KRN","B",9.8,9.8)

"BLD",9883,"KRN","B",19,19)

"BLD",9883,"KRN","B",19.1,19.1)

"BLD",9883,"KRN","B",101,101)

"BLD",9883,"KRN","B",409.61,409.61)

"BLD",9883,"KRN","B",771,771)

"BLD",9883,"KRN","B",779.2,779.2)

"BLD",9883,"KRN","B",870,870)

"BLD",9883,"KRN","B",8989.51,8989.51)

"BLD",9883,"KRN","B",8989.52,8989.52)

"BLD",9883,"KRN","B",8994,8994)

"BLD",9883,"QUES",0)
^9.62^^
"BLD",9883,"REQB",0)
^9.611^4^4
"BLD",9883,"REQB",1,0)
PSJ*5.0*256^2
"BLD",9883,"REQB",2,0)
PSJ*5.0*338^2
"BLD",9883,"REQB",3,0)
PSJ*5.0*337^2
"BLD",9883,"REQB",4,0)
PSJ*5.0*346^2
"BLD",9883,"REQB","B","PSJ*5.0*256",1)

"BLD",9883,"REQB","B","PSJ*5.0*337",3)

"BLD",9883,"REQB","B","PSJ*5.0*338",2)

"BLD",9883,"REQB","B","PSJ*5.0*346",4)

"MBREQ")
1
"ORD",0,9.8)
9.8;;1;RTNF^XPDTA;RTNE^XPDTA
"ORD",0,9.8,0)
ROUTINE
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
347^3180104
"PKG",197,22,1,"PAH",1,1,0)
^^1^1^3180104
"PKG",197,22,1,"PAH",1,1,1,0)
Follow up build to MOCHA 2.1b
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
15
"RTN","PSGOD")
0^2^B30203742
"RTN","PSGOD",1,0)
PSGOD ;BIR/CML3 - CREATES NEW ORDER FROM OLD ONE ;22 SEP 97 / 2:56 PM 
"RTN","PSGOD",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**67,58,111,133,181,286,281,315,338,256,347**;16 DEC 97;Build 6
"RTN","PSGOD",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSGOD",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSGOD",5,0)
 ;
"RTN","PSGOD",6,0)
 ;*286 - Do not allow copied Unit Dose orders for outpatients
"RTN","PSGOD",7,0)
 D INP^VADPT I 'VAIN(4) W !,"You cannot copy Unit Dose orders for this patient!" H 2 Q
"RTN","PSGOD",8,0)
 I $P($G(^PS(55,PSGP,5,+PSJORD,0)),"^",22) D  Q
"RTN","PSGOD",9,0)
 .W !,"This order is marked 'Not To Be Given' and can't be copied!" H 2
"RTN","PSGOD",10,0)
 F  W !!,"Do you want to copy this order" S %=2 D YN^DICN Q:%  D CH
"RTN","PSGOD",11,0)
 G:%'=1 DONE
"RTN","PSGOD",12,0)
 ;
"RTN","PSGOD",13,0)
 W !!,"...copying..." N OLDON
"RTN","PSGOD",14,0)
 K PSGORQF
"RTN","PSGOD",15,0)
 N PSGPDRG,Q
"RTN","PSGOD",16,0)
 NEW PSJOLDNM
"RTN","PSGOD",17,0)
 S PSGOEPR=$P($G(^PS(55,PSGP,5.1)),"^",2),OLDON=PSGORD,Q=""
"RTN","PSGOD",18,0)
 K PSGODN S F=$S(PSGORD["P":"^PS(53.1,"_+PSGORD_",",1:"^PS(55,"_PSGP_",5,"_+PSGORD_",") F N=0,.2,2,2.1,6 S PSGODN(N)=$G(@(F_N_")"))
"RTN","PSGOD",19,0)
 S PSGPR=$P(PSGODN(0),"^",2),PSGMR=$P(PSGODN(0),"^",3),PSGSM=$P(PSGODN(0),"^",5),PSGHSM=$P(PSGODN(0),"^",6),PSGST=$P(PSGODN(0),"^",7)
"RTN","PSGOD",20,0)
 S PSGPDRG=+PSGODN(.2),PSGDO=$P(PSGODN(.2),"^",2)
"RTN","PSGOD",21,0)
 ;*315
"RTN","PSGOD",22,0)
 S:$G(PSGODN(2.1))]"" PSGDUR=+PSGODN(2.1),PSGRMVT=$P(PSGODN(2.1),U,2),PSGRMV=$P(PSGODN(2.1),U,3),PSGRF=$P(PSGODN(2.1),U,4)
"RTN","PSGOD",23,0)
 S PSGSI=PSGODN(6)
"RTN","PSGOD",24,0)
 ; The naked reference below refers to the full reference inside indirection to ^PS(55,PSGP,5,+PSGORD, or ^PS(55,PSGP,"IV",+PSGORD, or ^PS(53.1,+PSGORD
"RTN","PSGOD",25,0)
 S PSGODN(3)=0 F Q=0:0 S Q=$O(@(F_"3,"_Q_")")) Q:'Q  I $D(^(Q,0)) S PSGODN(3,Q)=^(0),PSGODN(3)=PSGODN(3)+1 S ^PS(53.45,PSJSYSP,1,Q,0)=^(0)
"RTN","PSGOD",26,0)
 ;S:PSGODN(12)>0 ^PS(53.45,PSJSYSP,4,0)="^53.4504" S:PSGODN(3)>0 ^PS(53.45,PSJSYSP,1,0)="^53.4501"
"RTN","PSGOD",27,0)
 S:PSGODN(3)>0 ^PS(53.45,PSJSYSP,1,0)="^53.4501"
"RTN","PSGOD",28,0)
 ; The naked reference below refers to the full reference inside indirection to ^PS(55,PSGP,5,+PSGORD, or ^PS(55,PSGP,"IV",+PSGORD, or ^PS(53.1,+PSGORD  
"RTN","PSGOD",29,0)
 ;338
"RTN","PSGOD",30,0)
 N PSGK5345 S PSGK5345=0
"RTN","PSGOD",31,0)
 S (PSGODN(1),Q)=0 F  S Q=$O(@(F_"1,"_Q_")")) Q:'Q  S ND=$G(^(Q,0)) I ND D
"RTN","PSGOD",32,0)
 .I '$P(ND,"^",3),'PSGK5345 S PSGODN(1)=PSGODN(1)+1,PSGODN(1,PSGODN(1))=$P(ND,"^",1,2) S ^PS(53.45,PSJSYSP,2,PSGODN(1),0)=^(0)
"RTN","PSGOD",33,0)
 .I '$P(ND,"^",3),PSGK5345 S PSGODN(1,PSGODN(1))=$P(ND,"^",1,2) S ^PS(53.45,PSJSYSP,2,PSGODN(1),0)=^(0) S PSGODN(1)=PSGODN(1)+1,PSGK5345=0 K ^PS(53.45,PSJSYSP,2,PSGODN(1),0)
"RTN","PSGOD",34,0)
 .I $P(ND,"^",3) S PSGODN(1)=PSGODN(1)+1 K ^PS(53.45,PSJSYSP,2,PSGODN(1),0) S PSGK5345=1
"RTN","PSGOD",35,0)
 K PSGK5345
"RTN","PSGOD",36,0)
 S PSGS0Y=$P(PSGODN(2),"^",5),PSGS0XT=$P(PSGODN(2),"^",6),PSGNESD="",PSGSCH=$P(PSGODN(2),U)
"RTN","PSGOD",37,0)
 ;PSJ*5*256
"RTN","PSGOD",38,0)
 S PSJOLDNM("ORD_SCHD")=PSGSCH
"RTN","PSGOD",39,0)
 I $$CHKSCHD^PSJMISC2(.PSJOLDNM) W !!,"Order not copied." D PAUSE^VALM1 K PSJOLDNM G ORIG
"RTN","PSGOD",40,0)
 S:$G(PSJOLDNM("NEW_SCHD"))]"" PSGSCH=PSJOLDNM("NEW_SCHD") K PSJOLDNM
"RTN","PSGOD",41,0)
 S PSGODF=1,PSGNEDFD=$P($$GTNEDFD^PSGOE7("U",+PSGPDRG),U)_"^^"_PSGST_"^"_PSGSCH
"RTN","PSGOD",42,0)
 W "." D ^PSGNE3
"RTN","PSGOD",43,0)
 K PSGEFN,PSGOEEF,PSGOEE,PSGOEOS S PSGEFN="1:13" F X=1:1:13 S PSGEFN(X)=""
"RTN","PSGOD",44,0)
 S PSGPDN=$$OINAME^PSJLMUTL(PSGPDRG),PSGOINST="",PSGSDN=$$ENDD^PSGMI(PSGNESD)_U_$$ENDTC^PSGMI(PSGNESD),PSGFDN=$$ENDD^PSGMI(PSGNEFD)_U_$$ENDTC^PSGMI(PSGNEFD)
"RTN","PSGOD",45,0)
 S PSGAT=PSGS0Y,PSGEBN=DUZ,PSGLIN=$$ENDD^PSGMI(PSGDT)_U_$$ENDTC^PSGMI(PSGDT),PSGEBN=$$ENNPN^PSGMI(DUZ),PSGSTAT=$S(PSGOEAV:"ACTIVE",1:"NON-VERIFIED")
"RTN","PSGOD",46,0)
 W "." D CHK^PSGOEV("^^"_PSGMR_"^^^^"_PSGST,PSGPDRG_U_PSGDO,PSGSCH_U_PSGNESD_"^^"_PSGNEFD)
"RTN","PSGOD",47,0)
 I $G(PSGSCH)]"" D
"RTN","PSGOD",48,0)
 .N X S X=PSGSCH N SWD,SDW,XABB,QX D ENOS^PSGS0 I $G(X)=""!$G(PSJNSS) S CHK=1 K PSJNSS Q
"RTN","PSGOD",49,0)
 .I $G(PSGAT)="",$G(PSGS0Y) S PSGAT=PSGS0Y
"RTN","PSGOD",50,0)
 .I $G(PSGAT),($G(PSGS0Y)="") S PSGS0Y=PSGAT
"RTN","PSGOD",51,0)
 .I $G(PSGS0XT)="D",$G(PSGS0Y)="" S CHK=1 D  K PSJNSS
"RTN","PSGOD",52,0)
 ..W ! K DIR S DIR(0)="FOA",DIR("A")="   WARNING - Admin times are required for DAY OF WEEK schedules    " D ^DIR K DIR
"RTN","PSGOD",53,0)
 S PSGSD=PSGNESD,PSGFD=PSGNEFD
"RTN","PSGOD",54,0)
 K PSJACEPT S VALMBCK="Q" D:$D(Y) EN^VALM("PSJU LM ACCEPT")
"RTN","PSGOD",55,0)
 I $G(PSJACEPT)=1 D OC S:$D(PSGORQF) PSJACEPT=0 S:$G(PSJACEPT)=1 VALMBCK="",PSJNOO=$$ENNOO^PSJUTL5("N")
"RTN","PSGOD",56,0)
 I '$G(PSJACEPT)!($G(PSJNOO)<0) W:'$G(PSJCOFLG) !!,"Order not copied." D PAUSE^VALM1:'$G(PSJCOFLG) G ORIG    ;PSJCOFLG set in PSODGAL1 for allergies
"RTN","PSGOD",57,0)
 S PSGNESD=PSGSD,PSGNEFD=PSGFD
"RTN","PSGOD",58,0)
 K PSGOEE D ^PSGOETO S PSJORD=PSGORD I PSGOEAV D
"RTN","PSGOD",59,0)
 .I '$D(PSGOEE),+PSJSYSU=3 D EN^PSGPEN(PSGORD)
"RTN","PSGOD",60,0)
 .D SETOC^PSJNEWOC(PSGORD) ;RTC 178789 Store allergy if auto vf is on
"RTN","PSGOD",61,0)
 D GETUD^PSJLMGUD(PSGP,PSGORD),ENSFE^PSGOEE0(PSGP,PSGORD),^PSGOE1,EN^VALM("PSJ LM UD ACTION")
"RTN","PSGOD",62,0)
 ;RTC 178789 - store allery if not verified the newly copied order
"RTN","PSGOD",63,0)
 I ($G(PSGORD)["P"),($P($G(^PS(53.1,+PSGORD,0)),U,9)="N"),($G(PSJOCFG)="COPY UD") D SETOC^PSJNEWOC(PSGORD)
"RTN","PSGOD",64,0)
 ;
"RTN","PSGOD",65,0)
 S PSGCANFL=0,(PSGORD,PSJORD)=OLDON W !!,"You are finished with the new order.",!,"The following ACTION prompt is for the original order."
"RTN","PSGOD",66,0)
 K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","PSGOD",67,0)
ORIG ;Redisplay original order
"RTN","PSGOD",68,0)
 D GETUD^PSJLMGUD(PSGP,OLDON),INIT^PSJLMUDE(PSGP,OLDON)
"RTN","PSGOD",69,0)
DONE ;
"RTN","PSGOD",70,0)
 K %,%H,%I,DA,F,N,PSGODN,PSGODF,PSGS0XT,PSGS0Y,PSGNESD,PSGTOL,PSGTOO,PSGUOW,X,Y,^PS(53.45,PSJSYSP,1),^PS(53.45,PSJSYSP,2)
"RTN","PSGOD",71,0)
 K PSGPR,PSGMR,PSGSM,PSGHSM,PSGST,PSGPDRG,PSGDO,PSGNEDFD,PSGSCH,PSGNEFD
"RTN","PSGOD",72,0)
 Q
"RTN","PSGOD",73,0)
 ;
"RTN","PSGOD",74,0)
CH ;
"RTN","PSGOD",75,0)
 W !!?2,"Answer 'YES' to have a new, non-verified order created for this patient,",!,"using the information from this order.  (The START and STOP dates will be",!,"recalculated.)  Enter 'NO' (or '^') to stop now." Q
"RTN","PSGOD",76,0)
 ;
"RTN","PSGOD",77,0)
WH ;
"RTN","PSGOD",78,0)
 W !!?2,"Answer 'YES' to take action on this new order.  Enter 'NO' (or '^') to return",!,"to the original order now." Q
"RTN","PSGOD",79,0)
 ;
"RTN","PSGOD",80,0)
OC ;Perform order checks
"RTN","PSGOD",81,0)
 NEW PSJDD,X,PSJALLGY
"RTN","PSGOD",82,0)
 ;*286 - Order checks on current dispense drugs
"RTN","PSGOD",83,0)
 F X=0:0 S X=$O(^PS(53.45,PSJSYSP,2,X)) Q:'X  D
"RTN","PSGOD",84,0)
 . S PSJDD=$G(^PS(53.45,PSJSYSP,2,X,0))
"RTN","PSGOD",85,0)
 . I +PSJDD S PSJALLGY(+PSJDD)=""
"RTN","PSGOD",86,0)
 ;S X=+$O(PSGODN(1,0)) Q:'X  S PSJDD=+$G(PSGODN(1,X)) Q:'PSJDD
"RTN","PSGOD",87,0)
 S PSJDD=+$O(PSJALLGY(0)) Q:'PSJDD
"RTN","PSGOD",88,0)
 D FULL^VALM1
"RTN","PSGOD",89,0)
 D ENDDC^PSGSICHK($G(PSGP),PSJDD) Q:$D(PSGORQF)
"RTN","PSGOD",90,0)
 D IN^PSJOCDS($G(PSGORD),"UD",PSJDD)
"RTN","PSGOD",91,0)
 Q
"RTN","PSGOER")
0^3^B90786181
"RTN","PSGOER",1,0)
PSGOER ;BIR/CML3 - RENEW A SINGLE ORDER ;4/27/11 9:54am
"RTN","PSGOER",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**11,30,29,35,70,58,95,110,111,133,141,198,181,246,278,281,315,338,256,347**;16 DEC 97;Build 6
"RTN","PSGOER",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSGOER",4,0)
 ;
"RTN","PSGOER",5,0)
 ; Reference to ^PS(51.1 supported by DBIA 2177.
"RTN","PSGOER",6,0)
 ; Reference to ^PS(55 supported by DBIA 2191.
"RTN","PSGOER",7,0)
 ; Reference to ^PSSLOCK is supported by DBIA 2789.
"RTN","PSGOER",8,0)
 ; Reference to ^PSBAPIPM is supported by DBIA 3564.
"RTN","PSGOER",9,0)
 ; Reference to ^PS(59.7 is supported by DBIA 2181.
"RTN","PSGOER",10,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192.
"RTN","PSGOER",11,0)
 ; Reference to ^TMP("PSODAOC",$J is supported by DBIA 6071.
"RTN","PSGOER",12,0)
 ;
"RTN","PSGOER",13,0)
 ; renew a single order
"RTN","PSGOER",14,0)
 I $G(PSJCOM) D ^PSJCOMR Q
"RTN","PSGOER",15,0)
 N PSJEXPIR S PSJEXPIR=$$EXPIRED(PSGP,PSGORD) I PSJEXPIR D  Q
"RTN","PSGOER",16,0)
 .W !!?3,"  THIS ORDER" W:PSJEXPIR'=2 " HAS BEEN INACTIVE FOR ONE OR MORE SCHEDULED",!?8," ADMINISTRATIONS AND"
"RTN","PSGOER",17,0)
 .W " CANNOT BE RENEWED!" D PAUSE^VALM1
"RTN","PSGOER",18,0)
 I $G(PSGSCH)]"",($G(PSGS0XT)="D"),($G(PSGAT)="") D  Q
"RTN","PSGOER",19,0)
 .N SWD,SDW,XABB,X,QX S X=$G(PSGSCH) D DW^PSGS0 Q:($G(X)="")  I $G(PSGS0XT)="" S PSGS0XT="D"
"RTN","PSGOER",20,0)
 .Q:((",P,R,")[(","_$G(PSGST)_","))
"RTN","PSGOER",21,0)
 .I $G(PSGS0XT)="D",$G(PSGAT)="" S CHK=1 W !!?3,"This order contains a 'DAY OF THE WEEK' schedule without admin times"
"RTN","PSGOER",22,0)
 .W !?11," and CANNOT be renewed!" D PAUSE^VALM1
"RTN","PSGOER",23,0)
 I $G(PSGSCH)]"",'$$DOW^PSIVUTL(PSGSCH),'$$PRNOK^PSGS0(PSGSCH) I '$D(^PS(51.1,"AC","PSJ",PSGSCH)) D  Q
"RTN","PSGOER",24,0)
  .;PSJ*5*256
"RTN","PSGOER",25,0)
 .NEW PSJOLDNM
"RTN","PSGOER",26,0)
 .S PSJOLDNM("ORD_SCHD")=PSGSCH
"RTN","PSGOER",27,0)
 .I (PSGSCH]""),$$CHKSCHD^PSJMISC2(.PSJOLDNM,"R") K PSJOLDNM Q
"RTN","PSGOER",28,0)
 .K PSJOLDNM
"RTN","PSGOER",29,0)
 .W !!?3,"This order contains an invalid schedule and CANNOT be renewed!" D PAUSE^VALM1
"RTN","PSGOER",30,0)
 W !! K DIR S DIR(0)="Y",DIR("A")=$S($P(PSJSYSP0,"^",3):"RENEW THIS ORDER",1:"MARK THIS ORDER FOR RENEWAL"),DIR("B")="YES"
"RTN","PSGOER",31,0)
 S DIR("?")="Answer 'YES' to "_$S($P(PSJSYSP0,"^",3):"renew this order",1:"mark this order for renewal")_".  Answer 'NO' (or '^') to stop now." D ^DIR
"RTN","PSGOER",32,0)
 I '$D(DIRUT),Y D NEW S PSGCANFL=1 D DONE Q
"RTN","PSGOER",33,0)
 I '$D(DIRUT),PSJSYSU S PSGND4=$G(^PS(55,PSGP,5,+PSGORD,4)) I $P(PSGND4,"^",15),$P(PSGND4,"^",16) D UNMARK,DONE Q
"RTN","PSGOER",34,0)
 D DONE,ABORT^PSGOEE
"RTN","PSGOER",35,0)
 Q
"RTN","PSGOER",36,0)
 ;
"RTN","PSGOER",37,0)
UNMARK ;  
"RTN","PSGOER",38,0)
 W !!,"THIS ORDER HAS BEEN 'MARKED FOR RENEWAL'.",! K DIR S DIR(0)="Y",DIR("A")="DO YOU WANT TO 'UNMARK IT'",DIR("B")="NO"
"RTN","PSGOER",39,0)
 S DIR("?",1)="  Answer 'YES' to unmark this order.  Answer 'NO' (or '^') to leave the order",DIR("?")="marked.  (An answer is required.)" D ^DIR
"RTN","PSGOER",40,0)
 I 'Y D ABORT^PSGOEE G DONE
"RTN","PSGOER",41,0)
 S DA(1)=PSGP,DA=+PSGORD,PSGAL("C")=21180+PSJSYSU D ^PSGAL5 S $P(PSGND4,"^",15,17)="^^",^PS(55,PSGP,5,DA,4)=PSGND4 W "...DONE!"
"RTN","PSGOER",42,0)
 ;
"RTN","PSGOER",43,0)
DONE ;
"RTN","PSGOER",44,0)
 K %DT,DA,DIE,DIR,DR,FDSD,PSGAL,PSGALR,PSGDL,PSGDLS,PSGFD,PSGFOK,PSGND4,PSGOEE,PSGOER0,PSGOER1,PSGOER2,PSGOERDP,PSGPOSA,PSGPOSD,PSGPR,PSGPX,PSGRD,PSGSD,PSGTOL,PSGTOO,PSGUOW,PSGWLL,RF Q
"RTN","PSGOER",45,0)
 ;
"RTN","PSGOER",46,0)
NEW ; get info, write record
"RTN","PSGOER",47,0)
EXTEND ; extend stop date on renewal order
"RTN","PSGOER",48,0)
 N DUOUT,PSJABT,PSGDRG,PSJREN,PSGOREAS S PSGDRG=$P($G(^PS(55,PSGP,5,+PSGORD,1,1,0)),"^"),PSJREN=1
"RTN","PSGOER",49,0)
 I $G(PSGST)="O" N ACT S ACT=$$EN^PSBAPIPM(PSGP,PSGORD) I $P(ACT,"^",2),($P(ACT,"^",3)="G") I $P(ACT,"^",2)>$P($G(^PS(55,PSGP,5,+PSGORD,2)),"^",2) D  Q
"RTN","PSGOER",50,0)
 . W !!?5,"THIS ONE-TIME ORDER HAS ALREADY BEEN GIVEN AND CANNOT BE RENEWED",! S (DIRUT,PSGORQF)=1 D READ
"RTN","PSGOER",51,0)
 ;D OC55
"RTN","PSGOER",52,0)
 ;Q:$D(PSGORQF)  ; quit if not to continue
"RTN","PSGOER",53,0)
 D NOW^%DTC S PSGDT=%,PSGND4=$G(^PS(55,PSGP,5,+PSGORD,4)) I '$P(PSJSYSP0,"^",3) D MARK Q
"RTN","PSGOER",54,0)
 S PSGWLL=$S('$P(PSJSYSW0,"^",4):0,1:+$G(^PS(55,PSGP,5.1))),PSGOEE="R" K PSGOEOS
"RTN","PSGOER",55,0)
 K ^PS(53.45,PSJSYSP,1),^(2) D MOVE(3,1),MOVE(1,2)
"RTN","PSGOER",56,0)
 D DATE^PSGOER0(PSGP,PSGORD,PSGDT) I ($G(X)="^")!'$D(PSGFOK(106))!$G(DUOUT) D DONE,ABORT^PSGOEE S VALMBCK="R",COMQUIT=1 Q
"RTN","PSGOER",57,0)
 ;D OC55
"RTN","PSGOER",58,0)
 ;I $G(PSGORQF) D DONE,ABORT^PSGOEE S VALMBCK="R",COMQUIT=1 Q
"RTN","PSGOER",59,0)
SPEED ;
"RTN","PSGOER",60,0)
 I +$G(PSJSYSU)=3 D EN^PSGPEN(PSGORD)
"RTN","PSGOER",61,0)
 Q:$G(DUOUT)
"RTN","PSGOER",62,0)
 N PSGOEAV S PSGOEAV=+PSJSYSU
"RTN","PSGOER",63,0)
 W !!,"...updating order..." K DA S DA(1)=PSGP,DA=+PSGORD,PSGAL("C")=PSJSYSU*10+18000 D ^PSGAL5 W "."
"RTN","PSGOER",64,0)
 I $$LS^PSSLOCK(PSGP,PSGORD) D UPDREN(PSGORD,PSGDT,PSGOEPR,PSGOFD,PSJNOO),UPDRENOE(PSGP,PSGORD,PSGDT) D UNL^PSSLOCK(PSGP,PSGORD)
"RTN","PSGOER",65,0)
 S ^TMP("PSODAOC",$J,"IP IEN")=PSGORD   ;set up which IEN will be used to store order checks
"RTN","PSGOER",66,0)
 D SETOC^PSJNEWOC(PSGORD) ;PSJ*5*281 stores order checks
"RTN","PSGOER",67,0)
 K ^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J)
"RTN","PSGOER",68,0)
 ;
"RTN","PSGOER",69,0)
 I 'PSGOERDP,$P(PSJSYSW0,"^",4),PSGFD'<PSGWLL S $P(^PS(55,PSGP,5.1),"^")=+PSGFD
"RTN","PSGOER",70,0)
 W ".DONE!" S VALMBCK="Q" Q
"RTN","PSGOER",71,0)
 ;
"RTN","PSGOER",72,0)
MARK ;
"RTN","PSGOER",73,0)
 I $P(PSGND4,"^",15),$P(PSGND4,"^",16) W $C(7),!!?3,"...THIS ORDER IS ALREADY MARKED FOR RENEWAL!..." Q
"RTN","PSGOER",74,0)
 K DA S $P(PSGND4,"^",15,17)="1^"_DUZ_"^"_PSGDT,^PS(55,PSGP,5,+PSGORD,4)=PSGND4,PSGAL("C")=13180,DA(1)=PSGP,DA=+PSGORD W "." D ^PSGAL5
"RTN","PSGOER",75,0)
 I $D(PSJSYSO) S PSGORD=+PSGORD_"A",PSGPOSA="R",PSGPOSD=PSGDT D ENPOS^PSGVDS
"RTN","PSGOER",76,0)
 Q
"RTN","PSGOER",77,0)
MOVE(X,Y) ; Move comments/dispense drugs from 55 to 53.45.
"RTN","PSGOER",78,0)
 S Q=0 F  S Q=$O(^PS(55,PSGP,5,+PSGORD,X,Q)) Q:'Q  S ^PS(53.45,PSJSYSP,Y,Q,0)=$G(^(Q,0)) S ^PS(53.45,PSJSYSP,Y,0)="^53.450"_Y_"P^"_Q_U_Q
"RTN","PSGOER",79,0)
 ;S:Q ^PS(53.45,Y,0)="^53.450"_Y_"P^"_Q_U_Q
"RTN","PSGOER",80,0)
 Q
"RTN","PSGOER",81,0)
OC55 ;* Order checks for Speed finish and regular finish
"RTN","PSGOER",82,0)
 ;PSJ*5*181 - no longer use (OC will be triggered from OC^PSGOER0)
"RTN","PSGOER",83,0)
 Q
"RTN","PSGOER",84,0)
NEWOC55 ;
"RTN","PSGOER",85,0)
 N INTERVEN,PSJDDI,PSJIREQ,PSJRXREQ,PSJPDRG,PSJDD,PSJDD0,PSJALLGY
"RTN","PSGOER",86,0)
 S Y=1,(PSJIREQ,PSJRXREQ,INTERVEN,X)=""
"RTN","PSGOER",87,0)
 F PSGDDI=0:0 S PSGDDI=$O(^PS(55,PSGP,5,+PSGORD,1,PSGDDI)) Q:'+PSGDDI  D
"RTN","PSGOER",88,0)
 . S PSJDD0=$G(^PS(55,PSGP,5,+PSGORD,1,PSGDDI,0))
"RTN","PSGOER",89,0)
 . S PSJX=$P(PSJDD0,U,3) I PSJX]"",(PSJX'>$G(PSGDT)) Q
"RTN","PSGOER",90,0)
 . S PSJDD=+PSJDD0
"RTN","PSGOER",91,0)
 . S PSJX=$S('$D(^PSDRUG(+PSJDD,0)):1,$P($G(^(2)),U,3)'["U":1,$G(^("I"))="":0,1:^("I")'>$G(PSGDT))
"RTN","PSGOER",92,0)
 . Q:PSJX
"RTN","PSGOER",93,0)
 . S PSJALLGY(PSJDD)=""
"RTN","PSGOER",94,0)
 S PSJDD=$O(PSJALLGY(0))
"RTN","PSGOER",95,0)
 I '+PSJDD W !!,"No active dispense drug was found" D PAUSE^PSJLMUT1 Q
"RTN","PSGOER",96,0)
 K PSGORQF D ENDDC^PSGSICHK(PSGP,PSJDD)
"RTN","PSGOER",97,0)
 D:'$G(PSGORQF) IN^PSJOCDS(PSGORD,"UD",PSJDD) Q:$G(PSGORQF)
"RTN","PSGOER",98,0)
 Q
"RTN","PSGOER",99,0)
UPDREN(PSGORD,RNWDT,PSGOEPR,PSGOFD,PSJNOO,RDUZ) ; update renewed order
"RTN","PSGOER",100,0)
 N DR,DA,DIC,DIE,DD,DO,PSGRZERO,PSGRFOUR,PSGOORD
"RTN","PSGOER",101,0)
 S DR="",PSGOEENO=0,PSGOORD=PSGORD,PSGNESD=PSGSD Q:'PSGORD!'RNWDT!'PSGOEPR!'PSGOFD  S PSJNOO=$S($G(PSJNOO)]"":$G(PSJNOO),1:"E")
"RTN","PSGOER",102,0)
 S PSGRZERO="^PS(55,"_PSGP_",5,"_+PSGORD_",0)",PSGOEORD=$P(@PSGRZERO,"^",21)
"RTN","PSGOER",103,0)
 ; PSJ*5*141 - changed PSGOEPR to PSGPR for field 1 of the DR string below.
"RTN","PSGOER",104,0)
 S DA(1)=PSGP,DA=+PSGORD,DIE="^PS(55,"_PSGP_",5," S DR="34////^S X=PSGFD" S:$G(PSGPR) DR=DR_";1////"_PSGPR_";110////"_PSJNOO D ^DIE
"RTN","PSGOER",105,0)
 K DR,DA,DIC,DIE,DD,DO S DIC="^PS(55,"_PSGP_",5,"_+PSGORD_",14,",DIC(0)="L",DIC("P")="55.6114DA",ND14=$G(@(DIC_"0)")),DINUM=$P(ND14,"^",3)+1,DA(2)=PSGP,DA(1)=+PSGORD D
"RTN","PSGOER",106,0)
 . S DIC("DR")=".01////"_$G(RNWDT)_";1////"_$S($G(RDUZ):RDUZ,1:$G(DUZ))_";2////"_$G(PSGOEPR)_";3////"_$G(PSGOFD)_";4////"_+PSGOEORD,X=$G(RNWDT) D FILE^DICN
"RTN","PSGOER",107,0)
 K DR,DA,DIC,DIE,DD,DO S DA(1)=PSGP,DA=+PSGORD,DIE="^PS(55,"_PSGP_",5,",DR="28////A;105////@;107////@"
"RTN","PSGOER",108,0)
 ;PSJ*5*198
"RTN","PSGOER",109,0)
 S PSGRFOUR="^PS(55,"_PSGP_",5,"_+PSGORD_",4)",PSGRFOUR=@PSGRFOUR I $P(PSGRFOUR,"^",2)<RNWDT S DR=DR_";16////@;17////@" I $G(PSJORD)["P",+PSJSYSU=1 S DR=DR_";18////@;19////@"
"RTN","PSGOER",110,0)
 I '$G(PSJSPEED) I $G(PSGAT)]"",$G(PSGAT)'=$P($G(@(DIE_+PSGORD_",2)")),"^",5) S DR=DR_";41////"_PSGAT
"RTN","PSGOER",111,0)
 D ^DIE
"RTN","PSGOER",112,0)
 ; PSJ*5*278 - Check to re-assign orderable item
"RTN","PSGOER",113,0)
 N PSGPOI S PSGPOI=$$ACTIVE^PSJORREN(PSGP,PSGORD) Q:+PSGPOI=1  ;Quit if no change to OI
"RTN","PSGOER",114,0)
 I +PSGPOI>1,$P(PSGPOI,U,2) D  ;replace OI
"RTN","PSGOER",115,0)
 . N DR,DA,DIE S DA(1)=PSGP,DA=+PSGORD,DIE="^PS(55,"_PSGP_",5,",DR="108///^S X=$P(PSGPOI,U,2)" D ^DIE
"RTN","PSGOER",116,0)
 Q
"RTN","PSGOER",117,0)
UPDRENOE(PSGP,PSGORD,RDATE) ;
"RTN","PSGOER",118,0)
 D EXPOE(PSGP,PSGORD,$G(RDATE)) ; expire original Orders File order
"RTN","PSGOER",119,0)
 I PSGORD'["P" K DA,DR,DIE S DA(1)=DFN,DA=+PSGORD,DIE="^PS(55,"_DFN_$S(PSGORD="U":",5,",1:",""IV"","),DR=$S(DIE["IV":110,1:66)_"////@" D ^DIE
"RTN","PSGOER",120,0)
 D ENUDTX^PSJOREN(PSGP,PSGORD,"NR")
"RTN","PSGOER",121,0)
 D EN1^PSJHL2(PSGP,"SN",PSGORD,"ORDER RENEWED")
"RTN","PSGOER",122,0)
 Q
"RTN","PSGOER",123,0)
READ ; hold screen
"RTN","PSGOER",124,0)
 I $D(IOST) Q:$E(IOST)'="C"
"RTN","PSGOER",125,0)
 W !?5,"Press return to continue  " R X:$S($D(DTIME):DTIME,1:300)
"RTN","PSGOER",126,0)
 Q
"RTN","PSGOER",127,0)
EXPOE(DFN,PSJORDER,EXPDT) ; expire old Orders File entry
"RTN","PSGOER",128,0)
 I PSJORDER["P" S FILE="^PS(53.1,"_+PSJORDER_",0)",PSJORDER=$P(@FILE,"^",25)
"RTN","PSGOER",129,0)
 I (PSJORDER'["U"),(PSJORDER'["V") Q
"RTN","PSGOER",130,0)
 N CURDAT D NOW^%DTC S CURDAT=$$DATE2^PSJUTL2(%)
"RTN","PSGOER",131,0)
 S PSJEXPOE=$S($G(EXPDT):EXPDT,1:CURDAT) D EN1^PSJHL2(DFN,"SC",PSJORDER) K PSJEXPOE
"RTN","PSGOER",132,0)
 Q
"RTN","PSGOER",133,0)
EXPIRED(PSJX,PSJY) ;
"RTN","PSGOER",134,0)
 ; INPUT 
"RTN","PSGOER",135,0)
 ;       PSJX - Pharmacy Patient, pointer to ^PS(55
"RTN","PSGOER",136,0)
 ;       PSJY - Inpatient Order Number(appended with "V" or "U")
"RTN","PSGOER",137,0)
 ; OUTPUT
"RTN","PSGOER",138,0)
 ;   0  -  Order has not exceeded the Expired Time Limit 
"RTN","PSGOER",139,0)
 ;   1  -  Order has exceeded the Expired Time Limit
"RTN","PSGOER",140,0)
 N STOP,STATUS,NOW,CUTOFF,FREQ,LAST,ST,X,DFN,U,PSGDT,SD,WD,PSJPSTO,PSGDW,PSGOC,ZZND,LASTAT,LSTSTR,PSBCNT S DFN=PSJX,U="^",CUTOFF=0
"RTN","PSGOER",141,0)
 S STATUS=$S(PSJY["U":$P($G(^PS(55,PSJX,5,+PSJY,0)),"^",9),PSJY["V":$P($G(^PS(55,PSJX,"IV",+PSJY,0)),"^",17),1:"")
"RTN","PSGOER",142,0)
 S NOW=$S($G(PSGDT):PSGDT,1:$$DATE^PSJUTL2())
"RTN","PSGOER",143,0)
 S STOP=$S(PSJY["U":$P($G(^PS(55,PSJX,5,+PSJY,2)),U,4),1:$P($G(^PS(55,PSJX,"IV",+PSJY,0)),"^",3))
"RTN","PSGOER",144,0)
 I NOW<STOP Q 0
"RTN","PSGOER",145,0)
 ;*315 ND2P1 ON NEXT LINE
"RTN","PSGOER",146,0)
 I PSJY["U" N ND2,ND0 S ND0=$G(^PS(55,PSJX,5,+PSJY,0)),ND2=$G(^PS(55,PSJX,5,+PSJY,2)),ND2P1=$G(^PS(55,PSJX,5,+PSJY,2.1)),FREQ=$P(ND2,"^",6) D
"RTN","PSGOER",147,0)
 .N SCHED S SCHED=$P($G(^PS(55,PSJX,5,+PSJY,2)),"^") I SCHED["PRN" S FREQ=$$PRNFREQ(SCHED)
"RTN","PSGOER",148,0)
 .S LSTSTR=$P(ND2,"^",2)_"^"_$P(ND2,"^",4)_"^"_SCHED_"^"_$P(ND0,"^",7)_"^^"_$P(ND2,"^",5)
"RTN","PSGOER",149,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I LAST,($P(ND0,"^",7)="O"),($P(LAST,"^",3)="G") I LAST>$P(ND2,"^",2) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",150,0)
 .I 'LAST!(LAST>$P(ND2,"^",4)) S LAST=$$LASTAT^PSJORP2(DFN,LSTSTR) S:LAST CUTOFF=$$FMADD^XLFDT(LAST,,,FREQ) Q
"RTN","PSGOER",151,0)
 .I SCHED["PRN",($P(LSTSTR,"^",6)="") S CUTOFF=$$FMADD^XLFDT(LAST,,,FREQ) Q
"RTN","PSGOER",152,0)
 .I $$DOW^PSIVUTL(SCHED) S CUTOFF=$$NXTDOW(DFN,$P(LSTSTR,"^"),$P(LSTSTR,"^",2),$P(LSTSTR,"^",3),$P(LSTSTR,"^",6)) Q
"RTN","PSGOER",153,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I 'LAST!(LAST>$P(ND2,"^",4)) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",154,0)
 .S $P(LSTSTR,"^")=$$FMADD^XLFDT(LAST,,,,1),$P(LSTSTR,"^",2)=$$FMADD^XLFDT(PSGDT,,,FREQ) S CUTOFF=$$ENQ^PSJORP2(PSJX,LSTSTR)
"RTN","PSGOER",155,0)
 I PSJY["V" N LIMIT S LIMIT=$P($G(^PS(59.7,1,31)),"^",4) S LIMIT=$S((LIMIT]""):+LIMIT,1:24) S CUTOFF=$$FMADD^XLFDT(STOP,,LIMIT) D
"RTN","PSGOER",156,0)
 .I '($G(P(4))]"") N P,YP,XP S YP=$G(^PS(55,DFN,"IV",+PSJY,0)) F XP=1:1:23 S P(XP)=$P(YP,U,XP)
"RTN","PSGOER",157,0)
 .Q:'($G(P(4))]"")
"RTN","PSGOER",158,0)
 .Q:'$$SCHREQ^PSJLIVFD(.P)
"RTN","PSGOER",159,0)
 .N INTERVAL,LSTSTR,ND0,SCHED,IVSTYP S ND0=$G(^PS(55,PSJX,"IV",+PSJY,0)),INTERVAL=$P(ND0,"^",15),SCHED=$P(ND0,"^",9) Q:SCHED=""
"RTN","PSGOER",160,0)
 .S IVSTYP=$S($$DOW^PSIVUTL(SCHED):"D",INTERVAL="O":"O",1:"C"),LSTSTR=$P(ND0,"^",2)_"^"_$P(ND0,"^",3)_"^"_SCHED_"^"_IVSTYP_"^^"_$P(ND0,"^",11)
"RTN","PSGOER",161,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I LAST,IVSTYP="O",LAST>$P(ND0,"^",2),($P(LAST,"^",3)="G") S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",162,0)
 .I 'LAST!(LAST>$P(ND0,"^",3))!(LAST&(IVSTYP="O")) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",163,0)
 .I IVSTYP="D" S CUTOFF=$$NXTDOW(LAST,SCHED,$G(P(2)),$P($G(P(9)),"@"),$G(P(11))) Q
"RTN","PSGOER",164,0)
 .I SCHED["PRN" S FREQ=$$PRNFREQ(SCHED) S CUTOFF=$$FMADD^XLFDT(LAST,,,FREQ) Q
"RTN","PSGOER",165,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I 'LAST!(LAST>$P(ND0,"^",3)) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",166,0)
 .S $P(LSTSTR,"^")=$$FMADD^XLFDT(LAST,,,,1),$P(LSTSTR,"^",2)=$$FMADD^XLFDT(PSGDT,31) S CUTOFF=$$ENQ^PSJORP2(PSJX,LSTSTR)
"RTN","PSGOER",167,0)
 K LYN,PSBDT,PSBFLAG,PSBSTR
"RTN","PSGOER",168,0)
 Q $S(CUTOFF<NOW:1,1:0)
"RTN","PSGOER",169,0)
 ;
"RTN","PSGOER",170,0)
NXTDOW(DOWDFN,DOWSD,DOWFD,DOWSCH,DOWAT) ;
"RTN","PSGOER",171,0)
 N NXTADM,DOWSTR S DOWSTR=$$FMADD^XLFDT(DOWFD,,,,1)_"^"_$$FMADD^XLFDT(DOWFD,7)_"^"_DOWSCH_"^D^^"_DOWAT S NXTADM=$$ENQ^PSJORP2(DOWDFN,DOWSTR)
"RTN","PSGOER",172,0)
 Q $S(NXTADM:NXTADM,1:DOWSD)
"RTN","PSGOER",173,0)
 ;
"RTN","PSGOER",174,0)
PRNFREQ(SCHED) ;
"RTN","PSGOER",175,0)
 N ZZND,D,DA,X,PSGAT,PSGOES,PSGST,PSJNSS,PSJPWD,TEST,VALMBCK,PSGS0XT,PSGS0Y,PSGDT
"RTN","PSGOER",176,0)
 F X=$P(SCHED,"PRN"),$P(SCHED,"PRN",2),$P(SCHED," PRN"),$P(SCHED,"PRN ",2) Q:$P($G(ZZND),"^",4)  D ADMIN^PSJORPOE
"RTN","PSGOER",177,0)
 Q $S($G(PSGS0XT):PSGS0XT,1:1440)
"RTN","PSGOEV")
0^5^B95461290
"RTN","PSGOEV",1,0)
PSGOEV ;BIR/CML3 - VERIFY (MAKE ACTIVE) ORDERS ;4/16/10 9:18am
"RTN","PSGOEV",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**5,7,15,28,33,50,64,58,77,78,80,110,111,133,171,207,241,267,268,260,288,199,281,256,347**;16 DEC 97;Build 6
"RTN","PSGOEV",3,0)
 ;
"RTN","PSGOEV",4,0)
 ; Reference to ^ORD(101 supported by DBIA #872.
"RTN","PSGOEV",5,0)
 ; Reference to ^PS(50.7 supported by DBIA #2180.
"RTN","PSGOEV",6,0)
 ; Reference to ^PS(55 supported by DBIA #2191.
"RTN","PSGOEV",7,0)
 ; Reference to ^PSSLOCK supported by DBIA #2789.
"RTN","PSGOEV",8,0)
 ; Reference to ^PSDRUG( supported by DBIA# 2192.
"RTN","PSGOEV",9,0)
 ; Reference to MAIN^TIUEDIT is supported by DBIA #2410.
"RTN","PSGOEV",10,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071
"RTN","PSGOEV",11,0)
 ;
"RTN","PSGOEV",12,0)
EN(PSGORD) ;
"RTN","PSGOEV",13,0)
ENSF ; This entry point is used by Speed finish only.
"RTN","PSGOEV",14,0)
 ; Send SN update to CPRS if auto-verify off and from Order Set entry
"RTN","PSGOEV",15,0)
 NEW PSJOLDNM,PSJOLDX
"RTN","PSGOEV",16,0)
 S:'$D(PSGOEAV) PSGOEAV=$P($G(PSJSYSP0),"^",9)&$G(PSJSYSU)
"RTN","PSGOEV",17,0)
 I $D(PSGOES),'PSGOEAV,PSGORD["P",$P($G(^PS(53.1,+PSGORD,0)),"^",21)']"" D ORSET^PSGOETO1
"RTN","PSGOEV",18,0)
 D FULL^VALM1 I 'PSJSYSU W $C(7),$C(7),!!," THIS FUNCTION NOT AVAILABLE TO WARD STAFF." Q
"RTN","PSGOEV",19,0)
 S CHK=0 I PSGORD["P" S X=$P($G(^PS(53.1,+PSGORD,0)),"^",19) I X,$D(^PS(55,PSGP,5,$P(^(0),"^",19))) S CHK=+PSGORD,PSGORD=X_"U" L -^PS(53.1,CHK) L +^PS(55,PSGP,5,+PSGORD):1 E  W !!,"Another terminal is editing this order." G DONE
"RTN","PSGOEV",20,0)
 I +PSJSYSU=3 D DDCHK G:CHK DONE
"RTN","PSGOEV",21,0)
 ;PSJ*5*256 - inform user of old schedule name and quit
"RTN","PSGOEV",22,0)
 I $S((PSGORD["P"):$P($G(^PS(53.1,+PSGORD,0)),U,24)="R",(PSGORD["U"):$P($G(^PS(55,+PSGP,5,+PSGORD,0)),U,24)="R",1:0) S PSJOLDX="R"
"RTN","PSGOEV",23,0)
 S PSJOLDNM("ORD_SCHD")=$G(PSGSCH)
"RTN","PSGOEV",24,0)
 I $$CHKSCHD^PSJMISC2(.PSJOLDNM,$S($G(PSJOLDX)="R":"R",1:"V")) S CHK=1 G DONE
"RTN","PSGOEV",25,0)
 I PSGORD["P" D CHK($G(^PS(53.1,+PSGORD,0)),$G(^(.2)),$G(^(2)))
"RTN","PSGOEV",26,0)
 I $G(PSGSCH)]"" D
"RTN","PSGOEV",27,0)
 .N X,Y,PSGS0Y,PSGS0XT,PSGOES S PSGOES=1 S X=PSGSCH D ENOS^PSGS0 I $G(X)="" S CHK=4
"RTN","PSGOEV",28,0)
 I $G(CHK) Q:$D(PSJSPEED)  D EN^VALM("PSJU LM ACCEPT") G:'$G(PSJACEPT) DONE ;G VFY
"RTN","PSGOEV",29,0)
 I PSGORD["U" G:'$D(^PS(55,PSGP,5,+PSGORD,4)) VFY I +PSJSYSU=3,$P(^(4),"^",3) W $C(7),!!,"THIS ORDER HAS ALREADY BEEN VERIFIED BY A PHARMACIST." S PSGACT=$P(PSGACT,"V")_$P(PSGACT,"V",2) G DONE
"RTN","PSGOEV",30,0)
 I PSGORD["U" I +PSJSYSU=1,+^PS(55,PSGP,5,+PSGORD,4) W $C(7),!!,"THIS ORDER HAS ALREADY BEEN VERIFIED BY A NURSE." S PSGACT=$P(PSGACT,"V")_$P(PSGACT,"V",2) G DONE
"RTN","PSGOEV",31,0)
 ;
"RTN","PSGOEV",32,0)
VFY ; change status, move to 55, and change label record **ENHANCEMENTS MADE IN PSJ*5.0*260 **CCR 6214 **CCR 6244
"RTN","PSGOEV",33,0)
 I PSGORD["P" S PSJCOM=+$P($G(^PS(53.1,+PSGORD,.2)),"^",8) I PSJCOM D VFY^PSJCOM Q
"RTN","PSGOEV",34,0)
 NEW PSJDOSE,PSJDSFLG,PSJDIS,PSGORQF,PSJCNT,PSJCNT1,PSJCNT2,LIST,PSJFLG,PSGDN SET PSJDIS="",PSJCNT=0,PSJCNT1="",PSJCNT2="",LIST="PSGPRE",PSJFLG="",PSGDN=""
"RTN","PSGOEV",35,0)
 D DOSECHK^PSJDOSE
"RTN","PSGOEV",36,0)
 SET PSJFLG=+$G(PSGORD)
"RTN","PSGOEV",37,0)
 FOR  SET PSJCNT=$O(^PS(53.1,PSJFLG,1,PSJCNT)) Q:'+PSJCNT  D
"RTN","PSGOEV",38,0)
 .IF $D(^PS(53.1,PSJFLG,1,PSJCNT,0)) SET PSGDN=$P($G(^PS(53.1,PSJFLG,1,PSJCNT,0)),U,1)
"RTN","PSGOEV",39,0)
 .IF +$G(PSGDN),($P($G(^PSDRUG(PSGDN,0)),U,3)'["S")&($E($P($G(^PSDRUG(PSGDN,0)),U,2),1,2)'="XA")  D
"RTN","PSGOEV",40,0)
 ..D PROFILE^PSJBLDOC($G(DFN),LIST,"I;"_$G(PSGORD))
"RTN","PSGOEV",41,0)
 ..FOR  SET PSJCNT1=$O(^TMP($J,LIST,"IN","PROFILE",PSJCNT1)) Q:(PSJCNT1="")!(PSJDIS'="")  D
"RTN","PSGOEV",42,0)
 ...SET PSJCNT2=$P(PSJCNT1,";",2)
"RTN","PSGOEV",43,0)
 ...IF PSJCNT2=$G(PSGORD) SET PSJDIS=$P(^TMP($J,LIST,"IN","PROFILE",PSJCNT1),U,3)
"RTN","PSGOEV",44,0)
 ..;**Do order checks if PSJDIS (Dispense drug IEN) has a value
"RTN","PSGOEV",45,0)
 ..;IF $G(PSJNEWOE)=0,'$G(PSJLMFIN),'$G(PSJSTARI),'$G(PSGCOPY),$G(PSJDIS),'$G(PSJSPEED)  D
"RTN","PSGOEV",46,0)
 ..IF '+$G(PSJNEWOE),'$G(PSJLMFIN),'$G(PSJSTARI),'$G(PSGCOPY),$G(PSJDIS),'$G(PSJSPEED)  D
"RTN","PSGOEV",47,0)
 ...D ALLERGY($G(PSJORD),.PSJALLGY),ENDDC^PSGSICHK($G(PSGP),PSJDIS) D:('$G(PSGORQF)&'$G(PSJDSVFY)&'$G(PSJSTARI)) IN^PSJOCDS($G(PSGORD),"UD",PSJDIS) IF $G(PSGORQF) K ^TMP($J,LIST) D:$G(PSJORD)]"" EN^VALM("PSJ LM UD ACTION") QUIT
"RTN","PSGOEV",48,0)
 IF $G(PSGORQF) QUIT
"RTN","PSGOEV",49,0)
 D FULL^VALM1 ;PSJ*5*241
"RTN","PSGOEV",50,0)
 I +$G(PSJDSFLG) D SETVAR^PSJDOSE W !!,PSJDOSE("WARN"),!,PSJDOSE("WARN1") I '$$CONT() W !,"...order was not verified..." D PAUSE^VALM1 D  Q:'$G(PSJACEPT)
"RTN","PSGOEV",51,0)
 . S PSGOEEF(109)=1
"RTN","PSGOEV",52,0)
 . S PSJACEPT=0
"RTN","PSGOEV",53,0)
 . ;D EN^VALM("PSJU LM ACCEPT")
"RTN","PSGOEV",54,0)
 D DDCHK G:CHK DONE
"RTN","PSGOEV",55,0)
 I $G(PSGSCH)]"",((",P,R,")'[(","_PSGST_",")) D  I CHK G DONE
"RTN","PSGOEV",56,0)
 .N SWD,SDW,XABB,X,QX S X=$G(PSGSCH) D DW^PSGS0 Q:($G(X)="")  I $G(PSGS0XT)="" S PSGS0XT="D"
"RTN","PSGOEV",57,0)
 .I $G(PSGS0XT)="D",$G(PSGAT)="" S CHK=1 W !!,"This is a 'DAY OF WEEK' schedule and MUST have admin times.",! D PAUSE^VALM1
"RTN","PSGOEV",58,0)
 I $G(PSGSCH)]"" D  I CHK G DONE
"RTN","PSGOEV",59,0)
 .N X,Y,PSGS0XT,PSGS0Y,PSGOES S PSGOES=2,X=PSGSCH D ENOS^PSGS0 I $G(X)="" S CHK=4
"RTN","PSGOEV",60,0)
 W !,"...a few moments, please..."
"RTN","PSGOEV",61,0)
 I PSGORD["P" D
"RTN","PSGOEV",62,0)
 . N PND0,PSGORDR,PSJPRIO,PSJSCHED S PND0=^PS(53.1,+PSGORD,0) I $P(PND0,U,24)="R" S PSGORDR=$P(PND0,U,25) D  Q
"RTN","PSGOEV",63,0)
 .. N OEORD,OOEORD,FILE55,FILE55N0 S FILE55="^PS(55,"_DFN_$S($P(PND0,U,4)="U":",5,",1:",""IV"","),FILE55N0=FILE55_+PSGORDR_",0)"
"RTN","PSGOEV",64,0)
 .. S OEORD=$P(PND0,U,21) I PSGORDR S OOEORD=$P(@FILE55N0,"^",21) I OEORD'=OOEORD D EXPOE^PSGOER(DFN,PSGORD,+$$LASTREN^PSJLMPRI(DFN,PSGORD))
"RTN","PSGOEV",65,0)
 .. S PSGORDP=PSGORD,DIE="^PS(53.1,",DA=+PSGORD,DR="28////A;104////@" W "." D ^DIE
"RTN","PSGOEV",66,0)
 .. D START^PSGOTR(PSGORD,+PSGORDR) I OEORD D
"RTN","PSGOEV",67,0)
 ... K DA,DR,DIE S DA(1)=DFN,DA=+PSGORDR,DIE=FILE55,DR=$S(DIE["IV":110,1:66)_"////"_+OEORD D ^DIE S DIE=FILE55_+PSGORDR_",0)",$P(@DIE,U,21)=OEORD
"RTN","PSGOEV",68,0)
 ... D EN1^PSJHL2(DFN,"SC",PSGORDR),EN^PSGPEN(PSGORDR),UNL^PSSLOCK(PSGP,PSGORDR)
"RTN","PSGOEV",69,0)
 . S PSGORDP=PSGORD ;Used in ACTLOG to update activity log in 55
"RTN","PSGOEV",70,0)
 . D REQDT^PSJLIVMD(PSGORD)
"RTN","PSGOEV",71,0)
 . S DIE="^PS(53.1,",DA=+PSGORD,DR="28////A" W "." D ^DIE,^PSGOT
"RTN","PSGOEV",72,0)
 . S PSJPRIO=$S(PSGORD["P":$P($G(^PS(53.1,+PSGORD,.2)),"^",4),PSGORD["U":$P($G(^PS(55,DFN,5,+PSGORD,.2)),"^",4),1:$P($G(^PS(55,PSJHLDFN,"IV",+PSGORD,.2)),"^",4))
"RTN","PSGOEV",73,0)
 . S PSJSCHED=$S(PSGORD["P":$P($G(^PS(53.1,+PSGORD,2)),"^"),PSGORD["U":$P($G(^PS(55,DFN,5,+PSGORD,2)),"^"),1:$P($G(^PS(55,PSJHLDFN,"IV",+PSGORD,0)),"^",15))
"RTN","PSGOEV",74,0)
 . I (",S,A,")[(","_$G(PSJPRIO)_",")!($G(PSJSCHED)="NOW")!($G(PSJSCHED)["STAT") D NOTIFY^PSJHL4(PSGORD,DFN,$G(PSJPRIO),$G(PSJSCHED))
"RTN","PSGOEV",75,0)
 . I $G(PSGRDTX)="" S PSGRDTX=$G(^PS(53.1,+PSGORDP,2.5))
"RTN","PSGOEV",76,0)
 S DA=+PSGORD,DA(1)=PSGP,PSGAL("C")=PSJSYSU*10+22000 D ^PSGAL5 W "." S VND4=$G(^PS(55,PSGP,5,DA,4))
"RTN","PSGOEV",77,0)
 I $G(PSGRDTX) D NEWUDAL^PSGAL5(PSGP,PSGORD,6090,"Requested Start Date",+$G(PSGRDTX))
"RTN","PSGOEV",78,0)
 I $P($G(PSGRDTX),U,3) D NEWUDAL^PSGAL5(PSGP,PSGORD,6090,"Requested Stop Date",+$P($G(PSGRDTX),U,3))
"RTN","PSGOEV",79,0)
 N DUR,DURON S DURON=$S($G(PSGORD):$G(PSGORD),1:"") I DURON D
"RTN","PSGOEV",80,0)
 . S DUR=$S($P($G(PSGRDTX),U,2)]"":$P($G(PSGRDTX),U,2),1:$$GETDUR^PSJLIVMD(PSGP,+DURON,$S($G(DURON)["P":"P",1:5),1),1:"")
"RTN","PSGOEV",81,0)
 I $G(DUR)]"" S $P(^PS(55,PSGP,5,+PSGORD,2.5),"^",2)=DUR
"RTN","PSGOEV",82,0)
 D:$D(PSGORDP) ACTLOG(PSGORDP,PSGP,PSGORD)
"RTN","PSGOEV",83,0)
 K PSGRSD,PSGRFD,PSGALFN
"RTN","PSGOEV",84,0)
 NEW X S X=0 I $G(PSGONF),(+$G(PSGODDD(1))'<+$G(PSGONF)) S X=1
"RTN","PSGOEV",85,0)
 I +PSJSYSU=3,PSGORD'["O",$S(X:0,'$P(VND4,"^",9):1,1:$P(VND4,"^",15)) D EN^PSGPEN(+PSGORD)
"RTN","PSGOEV",86,0)
 S $P(VND4,"^",+PSJSYSU=1+9)=1 S:'$P(VND4,U,+PSJSYSU=3+9) $P(VND4,U,+PSJSYSU=3+9)=+$P(VND4,U,+PSJSYSU=3+9)
"RTN","PSGOEV",87,0)
 I PSJSYSL>1 S $P(^PS(55,PSGP,5,+PSGORD,7),U)=PSGDT S:$P(^(7),U,2)="" $P(^(7),U,2)="N"_$S($P(^PS(55,PSGP,5,+PSGORD,0),"^",24)="E":"E",1:"") S PSGTOL=2,PSGUOW=DUZ,PSGTOO=1,DA=+PSGORD D ENL^PSGVDS
"RTN","PSGOEV",88,0)
 S:$P(VND4,"^",15)&'$P(VND4,"^",16) $P(VND4,"^",15)="" S:$P(VND4,"^",18)&'$P(VND4,"^",19) $P(VND4,"^",18)="" S:$P(VND4,"^",22)&'$P(VND4,"^",23) $P(VND4,"^",22)="" S $P(VND4,"^",PSJSYSU,PSJSYSU+1)=DUZ_"^"_PSGDT,^PS(55,PSGP,5,+PSGORD,4)=VND4
"RTN","PSGOEV",89,0)
 I '$P(VND4,U,9) S ^PS(55,"APV",PSGP,+PSGORD)=""
"RTN","PSGOEV",90,0)
 I '$P(VND4,U,10) S ^PS(55,"ANV",PSGP,+PSGORD)=""
"RTN","PSGOEV",91,0)
 I $P(VND4,U,9) K ^PS(55,"APV",PSGP,+PSGORD)
"RTN","PSGOEV",92,0)
 I $P(VND4,U,10) K ^PS(55,"ANV",PSGP,+PSGORD)
"RTN","PSGOEV",93,0)
 W:'$D(PSJSPEED) ! W !,"ORDER VERIFIED.",!
"RTN","PSGOEV",94,0)
 I '$D(PSJSPEED) K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","PSGOEV",95,0)
 S:+PSJSYSU=3 ^PS(55,"AUE",PSGP,+PSGORD)="" S PSGACT="C"_$S('$D(^PS(55,PSGP,5,+PSGORD,4)):"E",$P(^(4),"^",16):"",1:"E")_"RS",PSGCANFL=2
"RTN","PSGOEV",96,0)
 S VALMBCK="Q" D EN1^PSJHL2(PSGP,$S(+PSJSYSU=3:"SC",+PSJSYSU=1:"SC",1:"XX"),+PSGORD_"U")     ; allow status change to be sent for pharmacists & nurses
"RTN","PSGOEV",97,0)
 S ^TMP("PSODAOC",$J,"IP IEN")=$G(PSJORD),^TMP("PSODAOC",$J,"IP NEW IEN")=$G(PSGORD)
"RTN","PSGOEV",98,0)
 ; -- RTC 198753 - clean-up variable - K PSJAGYSV
"RTN","PSGOEV",99,0)
 D SETOC^PSJNEWOC(PSGORD) K PSJAGYSV
"RTN","PSGOEV",100,0)
  ; **This is where the Automated Dispensing Machine hook is called. Do NOT DELETE or change this location **
"RTN","PSGOEV",101,0)
 D NEWJ^PSJADM
"RTN","PSGOEV",102,0)
  ; **END of Interface hook **
"RTN","PSGOEV",103,0)
 D:+PSJSYSU=1 EN1^PSJHL2(PSGP,"ZV",+PSGORD_"U")
"RTN","PSGOEV",104,0)
DONE ;
"RTN","PSGOEV",105,0)
 W:CHK !!,"...order NOT verified..."
"RTN","PSGOEV",106,0)
 I '$D(PSJSPEED),'CHK,+PSJSYSU=3,$G(PSJPRI)="D" D
"RTN","PSGOEV",107,0)
 .N DIR W ! S DIR(0)="S^Y:Yes;N:No",DIR("A")="Do you want to enter a Progress Note",DIR("B")="No" D ^DIR
"RTN","PSGOEV",108,0)
 .Q:Y="N"
"RTN","PSGOEV",109,0)
 .D MAIN^TIUEDIT(3,.TIUDA,PSGP,"","","","",1)
"RTN","PSGOEV",110,0)
 S VALMBCK="Q" K CHK,DA,DIE,F,DP,DR,ND,PSGAL,PSGODA,PSGTOL,PSGTOO,PSGUOW,PSJDOSE,PSJVAR,VND4,X,ZZND Q
"RTN","PSGOEV",111,0)
 ;
"RTN","PSGOEV",112,0)
LBL ;
"RTN","PSGOEV",113,0)
 Q
"RTN","PSGOEV",114,0)
 ;
"RTN","PSGOEV",115,0)
ALLERGY(PSGORD,PSJALLGY) ;setup PSJALLGY when non-vf was selected to verify
"RTN","PSGOEV",116,0)
 NEW PSGDDI,PSJDD,PSJX
"RTN","PSGOEV",117,0)
 I '+$G(PSGORD),($G(PSGORD)'["P") Q
"RTN","PSGOEV",118,0)
 F PSGDDI=0:0 S PSGDDI=$O(^PS(53.1,+PSGORD,1,PSGDDI)) Q:'PSGDDI  D
"RTN","PSGOEV",119,0)
 . S PSJDD=+$G(^PS(53.1,+PSGORD,1,PSGDDI,0))
"RTN","PSGOEV",120,0)
 . S PSJX=$S('$D(^PSDRUG(+PSJDD,0)):1,$P($G(^(2)),U,3)'["U":1,$G(^("I"))="":0,1:^("I")'>$G(DT))
"RTN","PSGOEV",121,0)
 . Q:PSJX
"RTN","PSGOEV",122,0)
 . S PSJALLGY(PSJDD)=""
"RTN","PSGOEV",123,0)
 Q
"RTN","PSGOEV",124,0)
CHK(ND,DRG,ND2) ; checks for data in required fields
"RTN","PSGOEV",125,0)
 ; Input: ND  - ^(PS(53.1,PSGORD,0)
"RTN","PSGOEV",126,0)
 ;        DRG - ^(.2)
"RTN","PSGOEV",127,0)
 ;        ND2 - ^(2)
"RTN","PSGOEV",128,0)
 S Y=$G(Y)
"RTN","PSGOEV",129,0)
 S CHK="" I DRG,$D(^PS(50.7,+DRG,0))
"RTN","PSGOEV",130,0)
 E  S CHK=1
"RTN","PSGOEV",131,0)
 I ND="" S CHK=CHK_23
"RTN","PSGOEV",132,0)
 E  S CHK=CHK_$S($P(ND,"^",3):"",1:2)_$S($P(ND,"^",7)]"":"",1:3)
"RTN","PSGOEV",133,0)
 ;The naked reference on the line below refers to the variable ND which is ^PS(53.1,PSGORD,0).
"RTN","PSGOEV",134,0)
 I ND2="" S CHK=CHK_$S('$D(^(0)):4,$P(^(0),"^",7)="OC":"",1:4)_56
"RTN","PSGOEV",135,0)
 E  S CHK=CHK_$S($P(ND2,"^")]"":"",ND="":4,$P(ND,"^",7)="OC":"",1:4)_$S($P(ND2,"^",2):"",1:5)_$S($P(ND2,"^",4):"",1:6)
"RTN","PSGOEV",136,0)
 I $$CHECK^PSGOE8(PSJSYSP),$P(DRG,U,2)="" S CHK=CHK_8
"RTN","PSGOEV",137,0)
 K PSGDFLG,PSGPFLG S PSGDI=0
"RTN","PSGOEV",138,0)
 S:'$$DDOK^PSGOE2("^PS(53.45,"_PSJSYSP_",2,",+DRG) CHK=CHK_7,(PSGDFLG,PSGDI)=1
"RTN","PSGOEV",139,0)
 S:'$$OIOK^PSGOE2(+DRG) PSGPFLG=1
"RTN","PSGOEV",140,0)
 I 'CHK,$G(PSGSCH)]"" D
"RTN","PSGOEV",141,0)
 .N X,Y,PSGS0Y,PSGS0XT,PSGOES S PSGOES=2,X=PSGSCH D ENOS^PSGS0 I $G(X)="" S CHK=4
"RTN","PSGOEV",142,0)
 Q:'CHK
"RTN","PSGOEV",143,0)
 W $C(7)
"RTN","PSGOEV",144,0)
 ;
"RTN","PSGOEV",145,0)
CHKM ;
"RTN","PSGOEV",146,0)
 D FULL^VALM1 K:CHK Y
"RTN","PSGOEV",147,0)
 ; changed to remove ^DD ref
"RTN","PSGOEV",148,0)
 ; PSJ*5*267 VMP Add the 8th condition
"RTN","PSGOEV",149,0)
 W !!,"THE FOLLOWING ",$S($L(CHK)>1:"ARE",1:"IS")," EITHER INVALID OR MISSING FROM THIS ORDER:" F X=1:1:8 W:CHK[X !?5,$P("ORDERABLE ITEM^MED ROUTE^SCHEDULE TYPE^SCHEDULE^START DATE/TIME^STOP DATE/TIME^DISPENSE DRUG^DOSAGE ORDERED","^",X)
"RTN","PSGOEV",150,0)
 I CHK=7 W !,"Orders with no dispense drugs or multiple dispense drugs",!,"require dosage ordered"
"RTN","PSGOEV",151,0)
 W:CHK]"" !!,$S($L(CHK)>1:"THESE FIELDS ARE",1:"THIS FIELD IS")," NECESSARY FOR VERIFICATION."
"RTN","PSGOEV",152,0)
 N DIR,DUOUT,DTOUT S DIR(0)="E" D ^DIR I $D(DUOUT)!$D(DTOUT) S CHK=1 Q
"RTN","PSGOEV",153,0)
 Q
"RTN","PSGOEV",154,0)
 ;
"RTN","PSGOEV",155,0)
CONT() ;
"RTN","PSGOEV",156,0)
 NEW DIR,DIRUT,Y
"RTN","PSGOEV",157,0)
 W ! K DIR,DIRUT
"RTN","PSGOEV",158,0)
 S DIR(0)="Y",DIR("A")="Would you like to continue verifying the order",DIR("B")="No"
"RTN","PSGOEV",159,0)
 D ^DIR
"RTN","PSGOEV",160,0)
 Q Y
"RTN","PSGOEV",161,0)
 ;
"RTN","PSGOEV",162,0)
DDCHK ; dispense drug check
"RTN","PSGOEV",163,0)
 S DRGF="^PS("_$S(PSGORD["P":"53.1,"_+PSGORD,1:"55,"_PSGP_",5,"_+PSGORD)_",",CHK=$S('$O(@(DRGF_"1,0)")):7,1:0)
"RTN","PSGOEV",164,0)
 S PSGPD=$G(@(DRGF_".2)"))
"RTN","PSGOEV",165,0)
 S CHK=$S('$$DDOK^PSGOE2(DRGF_"1,",PSGPD):7,1:0)
"RTN","PSGOEV",166,0)
 Q:CHK=0
"RTN","PSGOEV",167,0)
 W $C(7),!!,"This order must have at least one valid, active dispense drug to be verified."
"RTN","PSGOEV",168,0)
 ;
"RTN","PSGOEV",169,0)
DDEDIT ;
"RTN","PSGOEV",170,0)
 ;*** Remove all dispense drug for this order
"RTN","PSGOEV",171,0)
 K @(DRGF_"1)")
"RTN","PSGOEV",172,0)
 ; The naked reference below refers to the indirect full reference in DRGF_"1,"_Q_")", which is either ^PS(53.1,+PSGORD,Q) or ^PS(55,DFN,5,+PSGORD,Q)
"RTN","PSGOEV",173,0)
 K ^PS(53.45,PSJSYSP,2) S (X,Q)=0 F  S Q=$O(@(DRGF_"1,"_Q_")")) Q:'Q  S Y=$G(^(Q,0)),X=Q S ^PS(53.45,PSJSYSP,2,Q,0)=Y I Y S ^PS(53.45,PSJSYSP,2,"B",+Y,Q)=""
"RTN","PSGOEV",174,0)
 I X S ^PS(53.45,PSJSYSP,2,0)="^53.4502P^"_X_"^"_X
"RTN","PSGOEV",175,0)
 D ENDRG^PSGOEF1(PSGPD,X)
"RTN","PSGOEV",176,0)
 I 'CHK S %X="^PS(53.45,"_PSJSYSP_",2,",%Y=DRGF_"1," D %XY^%RCR S $P(@(DRGF_"1,0)"),"^",2)=$S(DRGF[53.1:"53.11P",1:"55.07P")
"RTN","PSGOEV",177,0)
 K DRG,DRGF,%X,%Y,PSGPD Q
"RTN","PSGOEV",178,0)
 ;
"RTN","PSGOEV",179,0)
AESCREEN() ;
"RTN","PSGOEV",180,0)
 ; Output: 0 - Required fields missing and DON'T allow accept
"RTN","PSGOEV",181,0)
 ;         1 - Required fields found.
"RTN","PSGOEV",182,0)
 Q:'$G(CHK) 1
"RTN","PSGOEV",183,0)
 S Y=$P($G(^ORD(101,+$G(^ORD(101,DA(1),10,DA,0)),0)),U) I Y="" Q 0
"RTN","PSGOEV",184,0)
 I Y="PSJU LM ACCEPT EDIT" Q 1
"RTN","PSGOEV",185,0)
 Q 0
"RTN","PSGOEV",186,0)
ACTLOG(PSGORDP,DFN,PSGORD)  ;Store 53.1 activity log in local array to be moved to 55
"RTN","PSGOEV",187,0)
 ;PSGORDP: IEN from 53.1
"RTN","PSGOEV",188,0)
 ;PSGORD : IEN from 55
"RTN","PSGOEV",189,0)
 NEW PSGX,PSGXDA,PSGAL531,Q,QQ
"RTN","PSGOEV",190,0)
 F PSGX=0:0 S PSGX=$O(^PS(53.1,+PSGORDP,"A",PSGX)) Q:'PSGX  D
"RTN","PSGOEV",191,0)
 . S PSGAL531=$G(^PS(53.1,+PSGORDP,"A",PSGX,0))
"RTN","PSGOEV",192,0)
 . S QQ=$G(^PS(55,DFN,5,+PSGORD,9,0)) S:QQ="" QQ="^55.09D" F Q=$P(QQ,U,3)+1:1 I '$D(^(Q)) S $P(QQ,U,3,4)=Q_U_Q,^(0)=QQ,PSGXDA=Q Q
"RTN","PSGOEV",193,0)
 . S ^PS(55,DFN,5,+PSGORD,9,PSGXDA,0)=PSGAL531
"RTN","PSGOEV",194,0)
 . N TXTLN S TXTLN="" F  S TXTLN=$O(^PS(53.1,+PSGORDP,"A",PSGX,1,TXTLN)) Q:TXTLN=""  D
"RTN","PSGOEV",195,0)
 .. I TXTLN=0 S ^PS(55,DFN,5,+PSGORD,9,PSGXDA,1,TXTLN)=^PS(53.1,+PSGORDP,"A",PSGX,1,TXTLN) Q
"RTN","PSGOEV",196,0)
 .. S ^PS(55,DFN,5,+PSGORD,9,PSGXDA,1,TXTLN,0)=^PS(53.1,+PSGORDP,"A",PSGX,1,TXTLN,0)
"RTN","PSGOEV",197,0)
 Q
"RTN","PSGS0")
0^8^B79536208
"RTN","PSGS0",1,0)
PSGS0 ;BIR/CML3 - SCHEDULE PROCESSOR ;06/22/09 7:12 PM
"RTN","PSGS0",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**12,25,26,50,63,74,83,116,110,111,133,138,174,134,213,207,190,113,245,227,256,347**;16 DEC 97;Build 6
"RTN","PSGS0",3,0)
 ;
"RTN","PSGS0",4,0)
 ; Reference to ^PS(51.1 is supported by DBIA 2177.
"RTN","PSGS0",5,0)
 ; Reference to ^PS(55   is supported by DBIA 2191.
"RTN","PSGS0",6,0)
 ;
"RTN","PSGS0",7,0)
ENA ; entry point for train option
"RTN","PSGS0",8,0)
 D ENCV^PSGSETU Q:$D(XQUIT)
"RTN","PSGS0",9,0)
 F  S (PSGS0Y,PSGS0XT)="" R !!,"Select STANDARD SCHEDULE: ",X:DTIME W:'$T $C(7) S:'$T X="^" Q:"^"[X  D:X?1."?" ENQ^PSGSH I X'?1."?" D EN W:$D(X)[0 $C(7),"  ??" I $D(X)#2,'PSGS0Y,PSGS0XT W "  Every ",PSGS0XT," minutes"
"RTN","PSGS0",10,0)
 K DIC,DIE,PSGS0XT,PSGS0Y,Q,X,Y,PSGDT Q
"RTN","PSGS0",11,0)
 ;
"RTN","PSGS0",12,0)
EN3 ;
"RTN","PSGS0",13,0)
 S PSGST=$P($G(^PS(53.1,DA,0)),"^",7) G EN
"RTN","PSGS0",14,0)
 ;
"RTN","PSGS0",15,0)
EN5 ;
"RTN","PSGS0",16,0)
 S PSGST=$P($G(^PS(55,DA(1),5,DA,0)),"^",7)
"RTN","PSGS0",17,0)
 ;
"RTN","PSGS0",18,0)
EN ; validate
"RTN","PSGS0",19,0)
 K PSGS0Y
"RTN","PSGS0",20,0)
 I X[""""!($A(X)=45)!(X?.E1C.E)!($L(X)>70)!($L(X)<1) K X Q
"RTN","PSGS0",21,0)
 S:X'=" " X=$$TRIM^XLFSTR(X,"R"," ") ;PSJ*5*227 - Prevent schedule crash
"RTN","PSGS0",22,0)
 I X?.E1L.E S X=$$ENLU^PSGMI(X) I '$D(PSGOES) D EN^DDIOL("  ("_X_")")
"RTN","PSGS0",23,0)
 ;
"RTN","PSGS0",24,0)
ENOS ; order set entry
"RTN","PSGS0",25,0)
 N X0,Y0,PSJXI,PSJDIC2,TMPAT
"RTN","PSGS0",26,0)
 I $G(X)="",$G(P(2)),$G(P(3)) S X=$G(P(9))
"RTN","PSGS0",27,0)
 I $G(X)="" Q
"RTN","PSGS0",28,0)
 S PSGXT=$G(PSGS0XT),(PSGS0XT,PSGS0Y,XT,Y,PSJNSS)=""
"RTN","PSGS0",29,0)
 S X0=X I X?2.4N1"-".E!(X?2.4N) D ENCHK S:$D(X) Y=X G Q
"RTN","PSGS0",30,0)
 ; * GUI 27 CHANGES * Check for admin times to be derived from 'base' schedule
"RTN","PSGS0",31,0)
 I X["@" S TMPAT=$P(X,"@",2) I TMPAT]"" D
"RTN","PSGS0",32,0)
 .I '$D(^PS(51.1,"AC","PSJ",TMPAT)) K TMPAT Q
"RTN","PSGS0",33,0)
 .I '$$DOW^PSIVUTL($P(X,"@")) K TMPAT Q
"RTN","PSGS0",34,0)
 .N LYN,ZZND,PSGS0XT,PSGS0Y,X S (PSGS0Y,PSGS0XT,X)=""
"RTN","PSGS0",35,0)
 .S X=TMPAT D DIC I $G(Y0)>0 S TMPAT=Y0
"RTN","PSGS0",36,0)
 I $G(TMPAT) S (PSGS0Y,$P(X,"@",2))=TMPAT,PSGS0XT="D"
"RTN","PSGS0",37,0)
 ; * GUI 27 CHANGES *
"RTN","PSGS0",38,0)
 I X["PRN",$$PRNOK(X),'$D(^PS(51.1,"AC","PSJ",X)) D  G Q
"RTN","PSGS0",39,0)
 .;PSJ*5*190 Check for One-time PRN
"RTN","PSGS0",40,0)
 .I $$ONE^PSJBCMA($G(DFN),$G(ON),X)="O" S XT="O" Q
"RTN","PSGS0",41,0)
 .I X["@"!$$DOW^PSIVUTL($P(X," PRN")) N DOW D  I $G(DOW) S (Y0,Y,PSGS0Y)=$P($P(X,"@",2)," ")
"RTN","PSGS0",42,0)
 ..N TMP S TMP=X N X S X=$P(TMP," PRN") D DW I $G(X)]"" S DOW=1
"RTN","PSGS0",43,0)
 ..I $G(DOW),$G(PSGST)]"" I ",P,R,"'[(","_PSGST_",") S (XT,PSGS0XT)="D"
"RTN","PSGS0",44,0)
 D DIC I $G(XT)]""!$G(Y0)!($G(X)]""&$G(PSJXI)) D  Q:'$D(X)  I $G(X)]"",PSGS0XT'="D" G:$D(^PS(51.1,"AC","PSJ",X)) Q3 I $P(X,"@")]"" G:$D(^PS(51.1,"AC","PSJ",$P(X,"@"))) Q3
"RTN","PSGS0",45,0)
 .S PSGS0XT=XT S:$G(Y0) (Y,PSGS0Y)=Y0 S:'PSGS0Y&((PSGS0XT)="D")&(X["@") PSGS0Y=$P(X,"@",2)
"RTN","PSGS0",46,0)
 .S PSGS0Y=$P(PSGS0Y," ")
"RTN","PSGS0",47,0)
 .; If entering from Verify action, and schedule exists in schedule file, and order's schedule is continuous,
"RTN","PSGS0",48,0)
 .; OR the order's schedule type is fill on request and the order's schedule is defined as continuous in schedule file,
"RTN","PSGS0",49,0)
 .; AND the order's schedule is not a PRN schedule, the order must have admin times.
"RTN","PSGS0",50,0)
 .Q:$G(PSGOES)'=2  Q:'$D(^PS(51.1,"AC","PSJ",X))
"RTN","PSGS0",51,0)
 .I $G(PSGST)="C"!($G(PSGST)="R"&($P($G(ZZND),"^",3))) I ($G(PSGST)'="P"),($G(PSGSCH)'[" PRN"),('$G(PSGAT)&'$G(PSGS0Y)),'$$ODD^PSGS0($G(PSGS0XT)) Q:($P($G(ZZND),"^",5)="O")  Q:$$ODD^PSGS0($P(ZZND,"^",3))  K X Q
"RTN","PSGS0",52,0)
 N TMPSCHX S TMPSCHX=X I $L(X,"@")<3 S TMPX=X D DW I $G(X)]"" K PSJNSS S (PSGS0XT,XT)="D" D  G Q
"RTN","PSGS0",53,0)
 .S Y=$S(($G(TMPSCHX)["@"):$P(TMPSCHX,"@",2),1:"")
"RTN","PSGS0",54,0)
 .I Y,(X'["@"),(TMPSCHX["@") S X=TMPSCHX
"RTN","PSGS0",55,0)
 S X=TMPSCHX
"RTN","PSGS0",56,0)
 I X'="" I $D(^PS(51.1,"AC","PSJ",X)) K PSJNSS G Q
"RTN","PSGS0",57,0)
 ;
"RTN","PSGS0",58,0)
NS I ($G(X)="^")!($G(X)="") K X S Y="" Q
"RTN","PSGS0",59,0)
 N NS S NS=0,PSJNSS=0
"RTN","PSGS0",60,0)
 I $G(Y)'>0 S X=X0,Y="",NS=1,PSJNSS=1
"RTN","PSGS0",61,0)
Q ;
"RTN","PSGS0",62,0)
 S PSGS0XT=$S(XT]"":XT,1:$G(PSGS0XT)),PSGS0Y=$S($G(Y):Y,$G(PSGS0Y):PSGS0Y,1:"") S:PSGS0XT<0 PSGS0XT=""
"RTN","PSGS0",63,0)
 I ('$G(PSGS0Y)&'$G(PSJDIC2)&$G(PSGAT))&'$G(PSJNEWOE)&$G(PSGS0XT) I PSGS0XT<1441 I ($L($G(PSGAT),"-")=PSGS0XT/1440)!($G(X)]""&($G(PSGSCH)=$G(X))) S PSGS0Y=$G(PSGAT)
"RTN","PSGS0",64,0)
Q2 K YY
"RTN","PSGS0",65,0)
 I '$G(PSJNSS),'$G(PSGS0Y),$G(YY) S PSGS0Y=YY
"RTN","PSGS0",66,0)
 I $G(X)]"",$$SCHREQ^PSJLIVFD(.P) D
"RTN","PSGS0",67,0)
 .I $$DOW^PSIVUTL(X)!$$PRNOK(X)!$D(^PS(51.1,"AC","PSJ",X)) S PSJNSS=0 Q
"RTN","PSGS0",68,0)
 .I $G(P(2))&$G(P(3)) D NSSCONT(X,PSGS0XT) S TMPX="" K X
"RTN","PSGS0",69,0)
 I ($G(PSJNSS)&($G(VALMBCK)'="Q"))!($G(PSJNSS)&$G(PSJLIFNI))!($G(PSJNSS)&$G(PSJTUD)) D
"RTN","PSGS0",70,0)
 .I $G(P(2))&$G(P(3)) Q
"RTN","PSGS0",71,0)
 .I ($G(X)]"") I ($G(PSGS0XT)'="D") D NSSCONT(X,PSGS0XT) S TMPX="" K X
"RTN","PSGS0",72,0)
Q3 I $G(X)]"" I $D(^PS(51.1,"AC","PSJ",X)) K PSJNSS
"RTN","PSGS0",73,0)
 K QX,SDW,SWD,X0,XT,Z Q
"RTN","PSGS0",74,0)
 ;
"RTN","PSGS0",75,0)
NSSCONT(SCH,FREQ) ;
"RTN","PSGS0",76,0)
 Q:SCH=""!($G(VALMBCK)]"")!$G(PSGMARSD)!$G(PSIVFN1)
"RTN","PSGS0",77,0)
 I $G(PSGOES),'$G(NSFF) Q
"RTN","PSGS0",78,0)
 N PSGS0XT,PSGSCH,DIR,X,Y S PSGSCH=SCH,PSGS0XT=FREQ,PSJNSS=1
"RTN","PSGS0",79,0)
 D NSSMSG I ($L(PSJNSS)>2),'$G(PSJXI) W !!,PSJNSS,! S PSJNSS=1
"RTN","PSGS0",80,0)
 S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR
"RTN","PSGS0",81,0)
 K NSFF Q
"RTN","PSGS0",82,0)
 ;
"RTN","PSGS0",83,0)
NSSMSG ;
"RTN","PSGS0",84,0)
 Q:$G(PSJXI)
"RTN","PSGS0",85,0)
 I '(",O,"[(","_$G(PSGST)_",")),$G(PSJNSS),$G(PSGSCH)]"" D
"RTN","PSGS0",86,0)
 .S PSJNSS=" WARNING - "_PSGSCH_" is an invalid schedule."
"RTN","PSGS0",87,0)
 S PSGSCH="",PSGS0XT=""
"RTN","PSGS0",88,0)
 Q
"RTN","PSGS0",89,0)
 ;
"RTN","PSGS0",90,0)
NSO(FQ) ;
"RTN","PSGS0",91,0)
 Q:'FQ!(FQ<0)!(",D,O,"[(","_$G(PSGST)_",")) ""
"RTN","PSGS0",92,0)
 K FRQOUT S FRQOUT=$S(FQ<60:(FQ_"minute"),(FQ<1440)&(FQ#60):(FQ_" minute"),(FQ<1440)!(FQ#1440):(FQ/60_" hour"),1:(FQ/1440_" day")) D
"RTN","PSGS0",93,0)
 . S:(+FRQOUT'=1) FRQOUT=FRQOUT_"s"
"RTN","PSGS0",94,0)
 Q FRQOUT
"RTN","PSGS0",95,0)
 ;
"RTN","PSGS0",96,0)
ENCHK ;
"RTN","PSGS0",97,0)
 N H,I
"RTN","PSGS0",98,0)
 I $S($L($P(X,"-"))>4:1,$L(X)>119:1,$L(X)<2:1,X'>0:1,1:X'?.ANP) K X Q
"RTN","PSGS0",99,0)
 S X(1)=$P(X,"-") I X(1)'?2N,X(1)'?4N K X Q
"RTN","PSGS0",100,0)
 S X(1)=$L(X(1)) I X'["-"&((X>$E(2400,1,X(1))!($E(X,3,4)>59))) K X Q
"RTN","PSGS0",101,0)
 F X(2)=2:1:$L(X,"-") S X(3)=$P(X,"-",X(2)) I $S($L(X(3))'=X(1):1,X(3)>$E(2400,1,X(1)):1,$E(X(3),3,4)>59:1,1:X(3)'>$P(X,"-",X(2)-1)) K X Q
"RTN","PSGS0",102,0)
 Q:'$D(X)
"RTN","PSGS0",103,0)
 F X(2)=1:1:$L(X,"-") S X(3)=$P(X,"-",X(2)) I $E(X(3),3,4)>59 K X Q
"RTN","PSGS0",104,0)
 Q:'$D(X)
"RTN","PSGS0",105,0)
 S X(1)=$L(X,"-"),X(2)=$G(PSGS0XT),PSGSCH=$S($G(PSGSCH)]"":PSGSCH,1:$G(P(9)))
"RTN","PSGS0",106,0)
 I $G(PSGSCH)="" Q  ;No schedule info, so just validate the numbers and quit.
"RTN","PSGS0",107,0)
 I $D(^PS(51.1,"AC","PSJ",PSGSCH)) S H=+$O(^PS(51.1,"AC","PSJ",PSGSCH,0)) S I=$P($G(^PS(51.1,H,0)),"^",5)
"RTN","PSGS0",108,0)
 I $G(I)="" S I=$S(PSGSCH["PRN":"P",1:"C")
"RTN","PSGS0",109,0)
 I I="D",$L(X,"-")>0 K:$D(X) X(1),X(2),X(3) S I="C" Q  ;DOW schedules require at least one admin time
"RTN","PSGS0",110,0)
 I $G(I)="O" D  Q  ;One Time schedules
"RTN","PSGS0",111,0)
 . I $L(X,"-")>1 K X Q  ;One Time schedules allow one admin time
"RTN","PSGS0",112,0)
 I X(2)="" Q  ;No frequency - cannot validate admin times to frequency
"RTN","PSGS0",113,0)
 I X(2)>1439,$L(X,"-")>1 K X Q  ;PSJ*5*113 Schedules with frequency greater than 1 day can only have one admin time.
"RTN","PSGS0",114,0)
 I X(2)>0,X(2)<1440,X(1)>(1440/X(2)) K X Q  ;PSJ*5*113 Admin times must match frequency or fewer
"RTN","PSGS0",115,0)
 I X(2)>0,X(2)<1440,1440#X(2)'=0,X(1)>0 K X Q  ;PSJ*5*113 Odd schedules cannot have admin times
"RTN","PSGS0",116,0)
 I X(2)>0,X(2)>1440,X(2)#1440'=0,X(1)>1 K X Q  ;PSJ*5*113 Odd schedules cannot have admin times
"RTN","PSGS0",117,0)
 K:$D(X) X(1),X(2),X(3)
"RTN","PSGS0",118,0)
 Q
"RTN","PSGS0",119,0)
 ;
"RTN","PSGS0",120,0)
DIC ; Check for schedule's existence in ADMINISTRATION SCHEDULE file (#51.1)
"RTN","PSGS0",121,0)
 ; Input:    
"RTN","PSGS0",122,0)
 ;           X = Schedule Name
"RTN","PSGS0",123,0)
 ;     PSJSLUP = If $G(PSJSLUP), perform interactive fileman lookup (optional).
"RTN","PSGS0",124,0)
 ;     PSGSFLG = If $G(PSGSFLG), return schedule IEN in PSGSCIEN variable (optional)
"RTN","PSGS0",125,0)
 ;    PSJLIFNI = Flag indicating a U/D order is being finished as an IV (optional).
"RTN","PSGS0",126,0)
 ;      PSGOES = If PSGOES=1, IX^DIC is called silently. If PSGOES=2, IX^DIC is not called (optional).
"RTN","PSGS0",127,0)
 ;      PSJPWD = IEN of Inpatient Ward associated with the patient/order/schedule combination (optional).
"RTN","PSGS0",128,0)
 ; Output:
"RTN","PSGS0",129,0)
 ;           X = Schedule Name if valid Input Schedule X, undefined if invalid Input Schedule X.
"RTN","PSGS0",130,0)
 ;     PSGS0XT = Frequency of validated schedule.
"RTN","PSGS0",131,0)
 ;     PSGS0Y  = Default Admin Times of validated schedule.
"RTN","PSGS0",132,0)
 ;    PSGSCIEN = IEN of validated schedule, if PSGSLFG is passed in and is evaluated to TRUE.
"RTN","PSGS0",133,0)
 ;
"RTN","PSGS0",134,0)
 K Y0,PSJXI N Y,PSGS0ST
"RTN","PSGS0",135,0)
 S Z=0 F PSJXI=0:1 S Z=$O(^PS(51.1,"AC","PSJ",X,Z)) Q:'Z
"RTN","PSGS0",136,0)
 I $G(X)]"",'$G(PSJSLUP) D
"RTN","PSGS0",137,0)
 .I $D(^PS(51.1,"AC","PSJ",X)) D  Q:$G(PSGS0Y)&($G(PSGS0XT)]"")
"RTN","PSGS0",138,0)
 ..;*** PSJ*5*256
"RTN","PSGS0",139,0)
 ..NEW PSGIEN,PSGSCHX
"RTN","PSGS0",140,0)
 ..S PSGIEN=$O(^PS(51.1,"AC","PSJ",X,0)) I +PSGIEN S PSGSCHX=$G(^PS(51.1,+PSGIEN,0)) I $P(PSGSCHX,U,5)="D" S PSGS0XT="D",PSJNSS=0,PSGS0Y=$P(PSGSCHX,U,2) Q
"RTN","PSGS0",141,0)
 ..I $$DOW^PSIVUTL(X) S PSGS0XT="D",PSJNSS=0 S:X["@" (Y0,PSGS0Y)=$P(X,"@",2) Q
"RTN","PSGS0",142,0)
 ..I $G(NSFF) S Y0=$S($G(PSGS0Y):PSGS0Y,$G(PSGAT)&'$G(PSJNEWOE):PSGAT,1:"") S:Y0 PSGS0Y=Y0
"RTN","PSGS0",143,0)
 .; Check for duplicate schedules - force selection
"RTN","PSGS0",144,0)
 .Q:PSJXI>1&('$G(PSGOES))&($G(PSGS0XT)]"")
"RTN","PSGS0",145,0)
 .I $D(^PS(51.1,"AC","PSJ",X)) N FREQ,ADMATCH S FREQ=$G(PSGS0XT) D
"RTN","PSGS0",146,0)
 ..N PSGS0XT,PSGS0Y,PSGST D ADMIN^PSJORPOE S:$G(PSGS0XT) XT=PSGS0XT S:$G(PSGS0Y) (Y0,Y)=PSGS0Y I $G(PSGST)'="" S PSGS0ST=PSGST
"RTN","PSGS0",147,0)
 ..;Check flag PSGSFLG to determine whether to return the schedule IEN in PSGSCIEN.
"RTN","PSGS0",148,0)
 .S:$G(XT)]"" PSGS0XT=XT S:$G(Y) PSGS0Y=Y
"RTN","PSGS0",149,0)
 .I $$DOW^PSIVUTL(X) S:PSGS0XT="" (XT,PSGS0XT)="D" S:PSGS0Y="" (Y0,PSGS0Y)=$S($P(X,"@",2):$P(X,"@",2),1:"")
"RTN","PSGS0",150,0)
 ;I $G(PSJLIFNI)!($G(P(4))]""&($G(P(2))]"")) I '$D(^PS(51.1,"AC","PSJ",X))!($G(PSJXI)>1) S PSJSLUP=1
"RTN","PSGS0",151,0)
 I $G(P(4))]"" I '$D(^PS(51.1,"AC","PSJ",X))!($G(PSJXI)>1) S PSJSLUP=1
"RTN","PSGS0",152,0)
 I $G(NSFF),$G(PSJXI)>1 D
"RTN","PSGS0",153,0)
 .I $G(PSGS0XT)="",$G(NSFF),$G(PSGXT)]"" S PSGS0XT=PSGXT Q
"RTN","PSGS0",154,0)
 .I $G(PSGS0XT)=""!($G(PSGS0Y)="") S PSJSLUP=1
"RTN","PSGS0",155,0)
 I '$G(PSJSLUP) Q:$G(PSGS0XT)]""&($G(PSGS0Y)]"")  Q:($G(PSGS0XT)="D"&('$D(^PS(51.1,"AC","PSJ",X))))
"RTN","PSGS0",156,0)
 Q:$G(PSGOES)=2
"RTN","PSGS0",157,0)
 Q:$G(PSGS0XT)]""&(PSJXI=1)
"RTN","PSGS0",158,0)
 I $G(PSGS0ST)="O",PSJXI=1 Q  ;one-time order,exact match (PSJ*5*207)
"RTN","PSGS0",159,0)
 K PSJSLUP
"RTN","PSGS0",160,0)
 ;*** PSJ*5*256; "E" is needed FN as IV when multiple entries with same schedule name so the user can select a schedule from it. chk pending so vf not prompt for the schedule again
"RTN","PSGS0",161,0)
 K DIC S DIC="^PS(51.1,",DIC(0)=$S($D(PSGOES):"MZVK",$D(PSJOLDNM):"MZVK",1:"CEMVZK")_$S((+$G(PSJLIFNI)&($G(ON)["P")):"E",1:"")
"RTN","PSGS0",162,0)
 ; The naked reference below refers to the full reference inside indirection to ^PS(51.1
"RTN","PSGS0",163,0)
 S DIC("W")="W ""  "","_$S('$D(PSJPWD):"$P(^(0),""^"",2)",'PSJPWD:"$P(^(0),""^"",2)",1:"$S($D(^PS(51.1,+Y,1,+PSJPWD,0)):$P(^(0),""^"",2),1:$P(^PS(51.1,+Y,0),""^"",2))"),D="APPSJ^D"
"RTN","PSGS0",164,0)
 S PSJDIC2=1
"RTN","PSGS0",165,0)
 ;D IX^DIC K DIC S:$D(DIE)#2 DIC=DIE I Y'>0 D  Q
"RTN","PSGS0",166,0)
 D MIX^DIC1 K DIC S:$D(DIE)#2 DIC=DIE I Y'>0 D  Q
"RTN","PSGS0",167,0)
 .I '$$DOW^PSIVUTL(X),'$$PRNOK(X),'$$ODD($G(PSGS0XT)),'$$ODD($P($G(ZZND),"^",3)),($P($G(ZZND),"^",5)'="O") S X="",PSJNSS=1,XT="",PSJXI=""
"RTN","PSGS0",168,0)
 S XT=$S("C"[$P(Y(0),"^",5):$P(Y(0),"^",3),1:$P(Y(0),"^",5))
"RTN","PSGS0",169,0)
 S X=+Y,Y="" I $D(PSJPWD),$D(^PS(51.1,+X,1,+PSJPWD,0)) S Y=$P(^(0),"^",2)
"RTN","PSGS0",170,0)
 ;Check flag PSGSFLG to determine whether to return the schedule IEN in PSGSCIEN.
"RTN","PSGS0",171,0)
 I $G(PSGSFLG) S PSGSCIEN=X
"RTN","PSGS0",172,0)
 S (X,X0)=Y(0,0) S:$G(Y)="" Y=$P(Y(0),"^",2)
"RTN","PSGS0",173,0)
 S (PSGS0Y,Y0)=$G(Y),Y0(0)=Y(0) I $P(Y(0),"^",3) S XT=$P(Y(0),"^",3)
"RTN","PSGS0",174,0)
 I $G(PSGS0XT)="",$$DOW^PSIVUTL(X) S (XT,PSGS0XT)="D"
"RTN","PSGS0",175,0)
 Q
"RTN","PSGS0",176,0)
 ;
"RTN","PSGS0",177,0)
DW ;
"RTN","PSGS0",178,0)
 N Y
"RTN","PSGS0",179,0)
 Q:($L(X,"@")>2)
"RTN","PSGS0",180,0)
 N AT I X["@" S AT=$P(X,"@",2)
"RTN","PSGS0",181,0)
 S SWD="SUNDAYS^MONDAYS^TUESDAYS^WEDNESDAYS^THURSDAYS^FRIDAYS^SATURDAYS",SDW=X,X=$P(X,"@",2) N XABB S XABB=""
"RTN","PSGS0",182,0)
 I X]"" D ENCHK Q:'$D(X)
"RTN","PSGS0",183,0)
 S X=$P(SDW,"@"),X(1)="-" I X?.E1P.E,X'["-"  ;F QX=1:1:$L(X) I $E(X,QX)?1P S X(1)=$E(X,QX) Q
"RTN","PSGS0",184,0)
 F Q=1:1:$L(X,X(1)) K:SWD="" X Q:SWD=""  S Z=$P(X,X(1),Q) D DWC Q:'$D(X)
"RTN","PSGS0",185,0)
 I $D(X) F II=1:1:$L(X,X(1)) S XABB=$G(XABB)_$E($P(X,X(1),II),1,2)_"-"
"RTN","PSGS0",186,0)
 K X(1) S:$D(X) X=SDW I $G(X)]"" I $TR(XABB,"-")]"" S X=$E($G(XABB),1,$L(XABB)-1)
"RTN","PSGS0",187,0)
 I $G(AT) S PSGS0Y=AT
"RTN","PSGS0",188,0)
 Q
"RTN","PSGS0",189,0)
DWC I $L(Z)<2 K X Q
"RTN","PSGS0",190,0)
 F QX=1:1:$L(SWD,"^") S Y=$P(SWD,"^",QX) I $P(Y,Z)="" S SWD=$P(SWD,Y,2) S:$L(SWD) SWD=$E(SWD,2,50) Q
"RTN","PSGS0",191,0)
 E  K X
"RTN","PSGS0",192,0)
 Q
"RTN","PSGS0",193,0)
 ;
"RTN","PSGS0",194,0)
PRNOK(PSCH) ;
"RTN","PSGS0",195,0)
 Q:PSCH'["PRN" 0
"RTN","PSGS0",196,0)
 I $TR(PSCH," ")="PRN" Q 1
"RTN","PSGS0",197,0)
 N BASE,I,OK S OK=0 S I=$P(PSCH," PRN") I I]"",$D(^PS(51.1,"AC","PSJ",I)) S OK=1
"RTN","PSGS0",198,0)
 I 'OK D
"RTN","PSGS0",199,0)
 .I PSCH["@" I $D(^PS(51.1,"AC","PSJ",$P(PSCH,"@")))!$$DOW^PSIVUTL($P(PSCH,"@")) S OK=1 Q
"RTN","PSGS0",200,0)
 .I $$DOW^PSIVUTL($P(PSCH," PRN")) S OK=1
"RTN","PSGS0",201,0)
 Q OK
"RTN","PSGS0",202,0)
ODD(PSF) ;determine if this is an odd schedule
"RTN","PSGS0",203,0)
 I PSF>1439,PSF#1440 Q 1
"RTN","PSGS0",204,0)
 I PSF,PSF<1440,1440#PSF Q 1
"RTN","PSGS0",205,0)
 Q 0
"RTN","PSGSICHK")
0^10^B36513168
"RTN","PSGSICHK",1,0)
PSGSICHK ;BIR/CML3-CHECKS SPECIAL INSTRUCTIONS ;17 Aug 98 / 8:33 AM
"RTN","PSGSICHK",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**3,9,26,29,44,49,59,110,139,146,160,175,201,185,181,256,347**;16 DEC 97;Build 6
"RTN","PSGSICHK",3,0)
 ;
"RTN","PSGSICHK",4,0)
 ; Reference to ^PS(50.605 is supported by DBIA 696.
"RTN","PSGSICHK",5,0)
 ; Reference to EN^PSOORDRG is supported by DBIA 2190.
"RTN","PSGSICHK",6,0)
 ; Reference to ^PSI(58.1 is supported by DBIA 2284.
"RTN","PSGSICHK",7,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192.
"RTN","PSGSICHK",8,0)
 ; Reference to ^PSD(58.8 is supported by DBIA 2283.
"RTN","PSGSICHK",9,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSGSICHK",10,0)
 ; Reference to ^PS(51.2 is supported by DBIA 2178.
"RTN","PSGSICHK",11,0)
 ; Reference to ^PS(51 is supported by DBIA 2176.
"RTN","PSGSICHK",12,0)
 ; Reference to ^ORRDI1 is supported by DBIA 4659.
"RTN","PSGSICHK",13,0)
 ; Reference to ^XTMP("ORRDI" is supported by DBIA 4660.
"RTN","PSGSICHK",14,0)
 ; Reference to ^PSSDSAPI is supported by DBIA 5425.
"RTN","PSGSICHK",15,0)
 ;
"RTN","PSGSICHK",16,0)
START ;
"RTN","PSGSICHK",17,0)
 I $S(X'?.ANP:1,X["^":1,1:$L(X)>180) K X Q
"RTN","PSGSICHK",18,0)
 S Y="" F Y(1)=1:1:$L(X," ") S Y(2)=$P(X," ",Y(1)) I Y(2)]"" D CHK Q:'$D(X)
"RTN","PSGSICHK",19,0)
 I $D(X),Y]"",X'=$E(Y,1,$L(Y)-1) D EN^DDIOL("EXPANDS TO: ") W Y F Y(1)=1:1 S Y(2)=$P(Y," ",Y(1)) Q:Y(2)=""  D:$L(Y(2))+$X>78 EN^DDIOL(Y(2)_" ")
"RTN","PSGSICHK",20,0)
 Q
"RTN","PSGSICHK",21,0)
 ;
"RTN","PSGSICHK",22,0)
CHK ;
"RTN","PSGSICHK",23,0)
 I $L(Y(2))<31,$D(^PS(51,+$O(^PS(51,"B",Y(2),0)),0)),$P(^(0),"^",2)]"",$P(^(0),"^",4) S Y(2)=$P(^(0),"^",2)
"RTN","PSGSICHK",24,0)
 I $L(Y)+$L(Y(2))>180 K X Q
"RTN","PSGSICHK",25,0)
 S Y=Y_Y(2)_" " Q
"RTN","PSGSICHK",26,0)
 ;
"RTN","PSGSICHK",27,0)
ENSET(X) ; expands the SPECIAL INSTRUCTIONS field contained in X into Y
"RTN","PSGSICHK",28,0)
 N X1,X2,Y S Y=""
"RTN","PSGSICHK",29,0)
 ;BHW;PSJ*5*185;Modified Logic below to NOT strip spaces and allow existing logic to flow.
"RTN","PSGSICHK",30,0)
 ;             ;Removed code I X2]"" Before Set of Y and created argumentless DO structure.
"RTN","PSGSICHK",31,0)
 F X1=1:1:$L(X," ") S X2=$P(X," ",X1) D
"RTN","PSGSICHK",32,0)
 . I X2']"" S Y=Y_" " Q  ;if multiple spaces in text and were $P'ing through text, X2 will="" so just add space and continue
"RTN","PSGSICHK",33,0)
 . S Y=Y_$S($L(X2)>30:X2,'$D(^PS(51,+$O(^PS(51,"B",X2,0)),0)):X2,$P(^(0),"^",2)]""&$P(^(0),"^",4):$P(^(0),"^",2),1:X2)_" "
"RTN","PSGSICHK",34,0)
 . Q
"RTN","PSGSICHK",35,0)
 ;BHW;Modified stripping of spaces at end of string
"RTN","PSGSICHK",36,0)
 F X1=$L(Y):-1:0 Q:$E(Y,X1,X1)'=" "  S Y=$E(Y,1,X1-1)
"RTN","PSGSICHK",37,0)
 Q Y
"RTN","PSGSICHK",38,0)
 ;
"RTN","PSGSICHK",39,0)
END ; used by DRUG (55.06,101 & 53.1,101) x-refs to warn user if patient is receiving or about to receive the drug just ordered
"RTN","PSGSICHK",40,0)
 Q:$D(PSJHLSKP)
"RTN","PSGSICHK",41,0)
 ;
"RTN","PSGSICHK",42,0)
 ;***This module is no longer used after PSJ*5*181***
"RTN","PSGSICHK",43,0)
 Q
"RTN","PSGSICHK",44,0)
 ;
"RTN","PSGSICHK",45,0)
 N Z,ZZ,STATUSNP I $G(PSJPWD)&($P($G(PSJSYSU),";")=3)&($G(PSGDRG)) I ($D(^PSI(58.1,"D",PSGDRG,PSJPWD)))!($D(^PSD(58.8,"D",PSGDRG,PSJPWD))) D EN^DDIOL("                         *** A WARD STOCK ITEM ***")
"RTN","PSGSICHK",46,0)
 D NOW^%DTC
"RTN","PSGSICHK",47,0)
 N PSJDCHK F Z=%:0 S Z=$O(^PS(55,+PSGP,5,"AUS",Z)) Q:'Z!$D(DUOUT)  F ZZ=0:0 S ZZ=$O(^PS(55,+PSGP,5,"AUS",Z,ZZ)) Q:'ZZ!$D(DUOUT)  I +$G(^PS(55,+PSGP,5,ZZ,.2))=PSGX D PDWCHK(+PSGP,ZZ_"U") S PSJDCHK=1
"RTN","PSGSICHK",48,0)
 F STATUSNP="N","P" F Z=0:0 S Z=$O(^PS(53.1,"AS",STATUSNP,+PSGP,Z)) Q:'Z!$D(DUOUT)  I +$G(^PS(53.1,+Z,.2))=PSGX D PDWCHK(+PSGP,Z_"P") S PSJDCHK=1
"RTN","PSGSICHK",49,0)
 I $D(PSJDCHK) N DIR D
"RTN","PSGSICHK",50,0)
 .S DIR(0)="Y",DIR("A")="Do you wish to continue entering this order",DIR("?",1)="Enter ""N"" if you wish to exit without creating a new order,"
"RTN","PSGSICHK",51,0)
 .S DIR("?")="or ""Y"" to continue with the order entry process." D ^DIR S:'Y Y=-1,X="^"
"RTN","PSGSICHK",52,0)
 K Z,ZZ
"RTN","PSGSICHK",53,0)
 Q
"RTN","PSGSICHK",54,0)
 ;
"RTN","PSGSICHK",55,0)
ENDDC(PSGP,PSJDD) ; Perform Duplicate Drug, Duplicate Class
"RTN","PSGSICHK",56,0)
 ;Using FDB OC
"RTN","PSGSICHK",57,0)
 NEW PSPDRG,PSJDSPNM,X
"RTN","PSGSICHK",58,0)
 K ^TMP($J,"PSJPRE")
"RTN","PSGSICHK",59,0)
 S PSJDSPNM=""
"RTN","PSGSICHK",60,0)
 ;If it is an active or pending order then check for multiple dispense drugs.
"RTN","PSGSICHK",61,0)
 I $G(PSJMULDD)>1!($G(PSGORD)]"") S PSJDSPNM=$$DRGNM()
"RTN","PSGSICHK",62,0)
 S PSPDRG(1)=PSJDD_U_$S(PSJDSPNM]"":PSJDSPNM,1:$$DN^PSJMISC(+PSJDD))
"RTN","PSGSICHK",63,0)
 I $$SUP^PSSDSAPI(+PSJDD) D DISPLAY^PSJOC Q
"RTN","PSGSICHK",64,0)
 D OC^PSJOC(.PSPDRG,"I;"_$G(PSGORD))
"RTN","PSGSICHK",65,0)
 Q 
"RTN","PSGSICHK",66,0)
DRGNM() ;
"RTN","PSGSICHK",67,0)
 ;Return the OI name + Dosage form if more than one DD in the order
"RTN","PSGSICHK",68,0)
 NEW PSJCNT,PSJDSPNM,X
"RTN","PSGSICHK",69,0)
 ;If it's speed finish then get the drug name from 53.1 (^PS(53.45 is not set to the current order yet)
"RTN","PSGSICHK",70,0)
 I $G(PSJSPEED),($G(PSGORD)["P") S PSJDSPNM=$$OINM^PSJOCDS(PSGORD) Q PSJDSPNM
"RTN","PSGSICHK",71,0)
 S PSJCNT=0,PSJDSPNM=""
"RTN","PSGSICHK",72,0)
 F X=0:0 S X=$O(^PS(53.45,+$G(PSJSYSP),2,X)) Q:'X  S PSJCNT=PSJCNT+1
"RTN","PSGSICHK",73,0)
 I PSJCNT>1,+$G(PSGPDRG) S PSJDSPNM=$$OIDF^PSJLMUT1(+PSGPDRG)
"RTN","PSGSICHK",74,0)
 Q PSJDSPNM
"RTN","PSGSICHK",75,0)
 ;
"RTN","PSGSICHK",76,0)
CONT ; Ask user if they wish to continue in spite of an order check.
"RTN","PSGSICHK",77,0)
 Q:'$D(PSJPDRG)  N DIR S DIR(0)="Y",DIR("A")="Do you wish to continue entering this order",DIR("?",1)="Enter ""N"" if you wish to exit without creating a new order,"
"RTN","PSGSICHK",78,0)
 S DIR("?")="or ""Y"" to continue with the order entry process.",DIR("B")="NO" D ^DIR I 'Y S PSGORQF=1,X="^",COMQUIT=1 Q
"RTN","PSGSICHK",79,0)
 I 'INTERVEN!($P(PSJSYSU,";")'=3) Q
"RTN","PSGSICHK",80,0)
 NEW PSJY
"RTN","PSGSICHK",81,0)
 W:PSJIREQ !!,"This is a CRITICAL interaction, you must enter an intervention log to continue"
"RTN","PSGSICHK",82,0)
 S DIR(0)="Y",DIR("A")="Do you wish to log an intervention",DIR("?",1)="Enter ""N"" if you do not wish to log an intervention,",DIR("?")="or ""Y"" to log an intervention." D ^DIR S PSJY=Y D:Y ^PSJRXI
"RTN","PSGSICHK",83,0)
 I 'PSJY,PSJIREQ S PSGORQF=1,COMQUIT=1
"RTN","PSGSICHK",84,0)
 Q
"RTN","PSGSICHK",85,0)
 ;
"RTN","PSGSICHK",86,0)
ENDL ; used by PSGTRAIN DRUG LOOK-UP option
"RTN","PSGSICHK",87,0)
 D ENCV^PSGSETU Q:$D(XQUIT)
"RTN","PSGSICHK",88,0)
 F  S DIC="^PSDRUG(",DIC(0)="AEIMOQZ",DIC("A")="Select DRUG: " W ! D ^DIC K DIC Q:+Y'>0  D SF
"RTN","PSGSICHK",89,0)
 D ENKV^PSGSETU K N5,ND,Q,Y Q
"RTN","PSGSICHK",90,0)
 ;
"RTN","PSGSICHK",91,0)
SF ;
"RTN","PSGSICHK",92,0)
 S Y=+Y,ND=$G(^PSDRUG(Y,0)),PSGID=+$G(^("I")) I PSGID W !!,"THIS DRUG IS INACTIVE AS OF ",$E($$ENDTC^PSGMI(PSGID),1,8)
"RTN","PSGSICHK",93,0)
 W !!,$S($P(ND,"^",9):"NON-",1:""),"FORMULARY ITEM" W:$P(ND,"^",10)]"" !,$P(ND,"^",10)
"RTN","PSGSICHK",94,0)
 S ND=$P($G(^PSDRUG(Y,2)),"^",3)["U" W !,$P("NOT^","^",ND+1)," A UNIT DOSE DRUG" W ! S ND=$G(^(8)),N5=$G(^(8.5)) W !?2,"DAY (nD) or DOSE (nL) LIMIT: " I ND W $P(ND,"^")
"RTN","PSGSICHK",95,0)
 W !?10,"UNIT DOSE MED ROUTE: " I $P(ND,"^",2) W $S($D(^PS(51.2,$P(ND,"^",2),0)):$P(^(0),"^"),1:$P(ND,"^",2))
"RTN","PSGSICHK",96,0)
 ; NAKED REF below refers to ^PS(51.2, on line above.
"RTN","PSGSICHK",97,0)
 W !?6,"UNIT DOSE SCHEDULE TYPE: " I $P(ND,"^",3)]"" W $P($P(";"_$P(^(0),"^",3),";"_$P(ND,"^",3)_":",2),";")
"RTN","PSGSICHK",98,0)
 W !?11,"UNIT DOSE SCHEDULE: " I $P(ND,"^",4)]"" W $P(ND,"^",4)
"RTN","PSGSICHK",99,0)
 W !,"CORRESPONDING OUTPATIENT DRUG: " I $P(ND,"^",5) W $S('$D(^PSDRUG(+$P(ND,"^",5),0)):$P(ND,"^",5),$P(^(0),"^")]"":$P(^(0),"^"),1:$P(ND,"^",5))
"RTN","PSGSICHK",100,0)
 W !?17,"ATC MNEMONIC: " I $P(N5,"^",2)]"" W $P(N5,"^",2)
"RTN","PSGSICHK",101,0)
 W !?17,"ATC CANISTER: " F Q=0:0 S Q=$O(^PSDRUG(Y,212,Q)) Q:'Q  S ND=$G(^(Q,0)) I ND,$P(ND,"^",2) W ?31,$S('$D(^PS(57.5,+ND,0)):+ND_";PS(57.5,",$P(^(0),"^")]"":$P(^(0),"^"),1:+ND_";PS(57.5,"),?56,$P(ND,"^",2),!
"RTN","PSGSICHK",102,0)
 Q
"RTN","PSGSICHK",103,0)
 ;
"RTN","PSGSICHK",104,0)
OCHK ; Add drugs in current order to ^TMP("ORDERS" and call order checker.
"RTN","PSGSICHK",105,0)
 ; Set PSJOCHK=1 so OP order check doesn't Kill array.
"RTN","PSGSICHK",106,0)
 ;
"RTN","PSGSICHK",107,0)
 K ^TMP($J,"ORDERS")
"RTN","PSGSICHK",108,0)
 N PSJOCHK S PSJOCHK=1
"RTN","PSGSICHK",109,0)
PDWCHK(DFN,ON) ; Print Dup Drug order.
"RTN","PSGSICHK",110,0)
 N ND,ND0,ND2,X
"RTN","PSGSICHK",111,0)
 W:'$D(PSJDCHK) $C(7),$C(7),!!,"WARNING! THIS PATIENT HAS THE FOLLOWING ORDER(S) FOR THIS MEDICATION:",!!
"RTN","PSGSICHK",112,0)
 S ND=$$DRUGNAME^PSJLMUTL(DFN,ON)
"RTN","PSGSICHK",113,0)
 S F=$S(ON["P":"^PS(53.1,",1:"^PS(55,"_DFN_",5,"),ND0=$G(@(F_+ON_",0)")),ND2=$G(^(2)),X=$P(ND,U,2),X=$S(X=.2:$P($G(^(.2)),U,2),1:$G(^(.3)))
"RTN","PSGSICHK",114,0)
 W ?10,$P(ND,U),!,?13,"Give: ",X," ",$$ENMRN^PSGMI(+$P(ND0,U,3))," ",$P(ND2,U),!!
"RTN","PSGSICHK",115,0)
 Q
"RTN","PSIVOCDS")
0^1^B140874598
"RTN","PSIVOCDS",1,0)
PSIVOCDS ;BIR/MV - PROCESS DOSING ORDER CHECKS FOR IV ;6 Jun 07 / 3:37 PM
"RTN","PSIVOCDS",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,252,257,256,347**;16 DEC 97;Build 6
"RTN","PSIVOCDS",3,0)
 ;
"RTN","PSIVOCDS",4,0)
 ; Reference to ^PS(51.1 is supported by DBIA #2177
"RTN","PSIVOCDS",5,0)
 ; Reference to ^PSDRUG( is supported by DBIA #2192.
"RTN","PSIVOCDS",6,0)
 ; Reference to ^PSSDSAPI is supported by DBIA #5425.
"RTN","PSIVOCDS",7,0)
 ; Reference to ^PSSFDBRT is supported by DBIA #5496.
"RTN","PSIVOCDS",8,0)
 ; Reference to $$CONV^PSSDSAPK is supported by DBIA #5497.
"RTN","PSIVOCDS",9,0)
 ;
"RTN","PSIVOCDS",10,0)
IN(PSJBASE) ;
"RTN","PSIVOCDS",11,0)
 ;PSJBASE - Base(Literal value for TMP global)- Required
"RTN","PSIVOCDS",12,0)
 ;PSIVDDSV(AD/SOL,CNT)=P1..P9
"RTN","PSIVOCDS",13,0)
 ; P1=Drug IEN; P2=Dspl name(add/sol or CPRS OI; P3=Numeric dose & unit; P4=Bottle #
"RTN","PSIVOCDS",14,0)
 ; P5=""; P6=""; P7=""; P8=Strength/Vol; P9=Unit
"RTN","PSIVOCDS",15,0)
 ;
"RTN","PSIVOCDS",16,0)
 ;These two flags below are set when stuff freq, duration to 1 & Duration rate = dose rate
"RTN","PSIVOCDS",17,0)
 ;They are used by the output routine to generate the appropriate output messages.
"RTN","PSIVOCDS",18,0)
 ;PSJFDB(PSJCNT,"INF_ERROR")="" & PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",19,0)
 ;
"RTN","PSIVOCDS",20,0)
 NEW ON,PSJCNT,PSJCNTX,PSJONEFG,PSJRT,PSIVAS,PSIVAS0,PSIVDDSV,PSPDRG,PSJALLGY,X,PSJP8,PSJP8NUM,PSJP8UNT,PSJP8TME,PSJOIX
"RTN","PSIVOCDS",21,0)
 K PSJOCDS,PSJFDB,PSIVDDSV,PSPDRG,PSJALLGY
"RTN","PSIVOCDS",22,0)
 S PSJCNT=0
"RTN","PSIVOCDS",23,0)
 ;PSJRT - FDB Route
"RTN","PSIVOCDS",24,0)
 S PSJRT=$P($$MRT^PSSDSAPI(+P("MR")),U,2)
"RTN","PSIVOCDS",25,0)
 ;Set Flag to indicate CPRS OI had no active AD/SOL.
"RTN","PSIVOCDS",26,0)
 S PSJOIX="" F  S PSJOIX=$O(PSJIV("OI_ERROR",PSJOIX)) Q:PSJOIX=""  D
"RTN","PSIVOCDS",27,0)
 . S PSJCNT=PSJCNT+1
"RTN","PSIVOCDS",28,0)
 . S PSJFDB(PSJCNT,"RX_NUM")="I;;PROSPECTIVE;"_PSJCNT
"RTN","PSIVOCDS",29,0)
 . S PSJFDB(PSJCNT,"DRUG_NM")=PSJOIX
"RTN","PSIVOCDS",30,0)
 . S PSJFDB(PSJCNT,"OI")=$P(PSJIV("OI_ERROR",PSJOIX),U,2)
"RTN","PSIVOCDS",31,0)
 . S PSJFDB(PSJCNT,"OI_ERROR",PSJOIX)=$P(PSJIV("OI_ERROR",PSJOIX),U)_U_"I;;PROSPECTIVE;"_PSJCNT
"RTN","PSIVOCDS",32,0)
 D SETDD^PSIVOC(1)
"RTN","PSIVOCDS",33,0)
 I ($G(PSIVDDSV("TOT_VOL"))=""),($G(PSJIV("TOT_VOL"))]"") S PSIVDDSV("TOT_VOL")=PSJIV("TOT_VOL")
"RTN","PSIVOCDS",34,0)
 F PSIVAS="AD","SOL" F PSJCNTX=0:0 S PSJCNTX=$O(PSIVDDSV(PSIVAS,PSJCNTX)) Q:'PSJCNTX  D
"RTN","PSIVOCDS",35,0)
 . S PSIVAS0=$G(PSIVDDSV(PSIVAS,PSJCNTX))
"RTN","PSIVOCDS",36,0)
 .;PSJ*5*252 (6/29/11) - No longer need to convert "ML" to "L" now FDB handles both units for this drug.
"RTN","PSIVOCDS",37,0)
 .;I PSIVAS="SOL" S X=$$LITER($P(PSIVAS0,U,8)) I X]"" D
"RTN","PSIVOCDS",38,0)
 .;. S $P(PSIVAS0,U,8)=$P(X,U)
"RTN","PSIVOCDS",39,0)
 .;. S $P(PSIVAS0,U,9)=$P(X,U,2)
"RTN","PSIVOCDS",40,0)
 . S PSJCNT=PSJCNT+1
"RTN","PSIVOCDS",41,0)
 . D COMMON
"RTN","PSIVOCDS",42,0)
 . I P("DTYP")=1 S PSJOCDS("CONTEXT")="IP-IV-I" D IVPB
"RTN","PSIVOCDS",43,0)
 . I P("DTYP")>1 S PSJOCDS("CONTEXT")="IP-IV-C" D IV
"RTN","PSIVOCDS",44,0)
 Q
"RTN","PSIVOCDS",45,0)
IV ;Setup input data for Continuous IV (admixture, hyperal)
"RTN","PSIVOCDS",46,0)
 NEW PSJXRT,PSJP8ERR
"RTN","PSIVOCDS",47,0)
 S PSJP8=$$P8^PSJMISC2(P(8))
"RTN","PSIVOCDS",48,0)
 D BASIC
"RTN","PSIVOCDS",49,0)
 S PSJP8NUM=+$P(PSJP8,U)
"RTN","PSIVOCDS",50,0)
 S PSJP8UNT=$P(PSJP8,U,2)
"RTN","PSIVOCDS",51,0)
 S PSJP8TME=$P(PSJP8,U,3)
"RTN","PSIVOCDS",52,0)
 ;All premix are using the "Continuous Infusion" Route logic. This is so Potassium gets both single
"RTN","PSIVOCDS",53,0)
 ;and max dosing checks.  Cisplatin premix won't work since FDB can't process as "Continuous Infusion"
"RTN","PSIVOCDS",54,0)
 I PSIVAS="SOL" D PREMIX Q
"RTN","PSIVOCDS",55,0)
 S PSJXRT=$$RTESCRN($P($$MRT^PSSDSAPI(+P("MR")),U,1))
"RTN","PSIVOCDS",56,0)
 I $$ISONEAD(),$$ISALLBAG(),('$$CLASS(PSJFDB(PSJCNT,"DRUG_IEN"))),(PSJXRT'=0),$$FDBRT(PSJFDB(PSJCNT,"DRUG_IEN"),PSJXRT) D ONEAD(PSJXRT) Q
"RTN","PSIVOCDS",57,0)
 I PSJP8="" D FREEDOSE Q
"RTN","PSIVOCDS",58,0)
 D CONTIV
"RTN","PSIVOCDS",59,0)
 Q
"RTN","PSIVOCDS",60,0)
IVPB ;Setup input data for Schedule IV
"RTN","PSIVOCDS",61,0)
 NEW X,PSJP9,PSJP15,PSJX
"RTN","PSIVOCDS",62,0)
 S PSJOCDS(PSJCNT,"DRUG_AMT")=$P(PSIVAS0,U,8)
"RTN","PSIVOCDS",63,0)
 S PSJOCDS(PSJCNT,"DRUG_UNIT")=$P(PSIVAS0,U,9)
"RTN","PSIVOCDS",64,0)
 I '+$G(PSJIV("DUR")) D
"RTN","PSIVOCDS",65,0)
 . S X=$$DURATION()
"RTN","PSIVOCDS",66,0)
 . S PSJOCDS(PSJCNT,"DRATE")=$S(+X:X_"M",1:"")
"RTN","PSIVOCDS",67,0)
 I +$G(PSJIV("DUR"))<1440,(+$G(PSJIV("DUR"))>0) S PSJOCDS(PSJCNT,"DRATE")=PSJIV("DUR")
"RTN","PSIVOCDS",68,0)
 S PSJOCDS(PSJCNT,"MR_IEN")=+P("MR")
"RTN","PSIVOCDS",69,0)
 S PSJOCDS(PSJCNT,"DO")=""
"RTN","PSIVOCDS",70,0)
 S PSJOCDS(PSJCNT,"SCHEDULE")=P(9)
"RTN","PSIVOCDS",71,0)
 ;
"RTN","PSIVOCDS",72,0)
 S PSJFDB(PSJCNT,"DOSE_AMT")=$S('+$P(PSIVAS0,U,8):"",1:$P(PSIVAS0,U,8))
"RTN","PSIVOCDS",73,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSIVOCDS",74,0)
 S PSJFDB(PSJCNT,"DOSE_UNIT")=$P(PSIVAS0,U,9)
"RTN","PSIVOCDS",75,0)
 ;
"RTN","PSIVOCDS",76,0)
 S PSJONEFG=0
"RTN","PSIVOCDS",77,0)
 ;PSJ*5*347 - P(9) contains " PRN"
"RTN","PSIVOCDS",78,0)
 S PSJP9=P(9)
"RTN","PSIVOCDS",79,0)
 I (P(9)[" PRN"),'$D(^PS(51.1,"APPSJ",P(9))) S PSJP9=$P(P(9)," PRN",1)
"RTN","PSIVOCDS",80,0)
 I $$ONE^PSJORPOE(PSJP9)!$$ONCALL^PSJMISC(PSJP9) S PSJONEFG=1 D SINGLE Q
"RTN","PSIVOCDS",81,0)
 ;I $$ONE^PSJORPOE(P(9))!$$ONCALL^PSJMISC(P(9)) S PSJONEFG=1 D SINGLE Q
"RTN","PSIVOCDS",82,0)
 I +$G(PSJIV("DOSE_CNT")) S PSJFDB(PSJCNT,"FREQ")=$G(PSJIV("DOSE_CNT")) Q
"RTN","PSIVOCDS",83,0)
 I +$G(PSJOCDS(PSJCNT,"DRATE")) D UND24HRS^PSJOCDS(+PSJOCDS(PSJCNT,"DRATE"),$G(P(11)),$G(P(15)),$G(P(2)),$G(P(3)),$G(P(9))) Q
"RTN","PSIVOCDS",84,0)
 I 'PSJONEFG D
"RTN","PSIVOCDS",85,0)
 . S X="",PSJP9=P(9)
"RTN","PSIVOCDS",86,0)
 . S PSJX=+$O(^PS(51.1,"AC","PSJ",P(9),0))
"RTN","PSIVOCDS",87,0)
 . S PSJP15=P(15)
"RTN","PSIVOCDS",88,0)
 . I (P(9)["PRN"),'PSJX S PSJP15=""
"RTN","PSIVOCDS",89,0)
 . ;I (P(9)["PRN"),'$O(^PS(51.1,"AC","PSJ",P(9),0)) S PSJP15=""
"RTN","PSIVOCDS",90,0)
 . ;I P(15)="D",(P(11)]"") S $P(PSJP9,"@",2)=P(11)
"RTN","PSIVOCDS",91,0)
 . I 'PSJX&(P(15)="D")&(P(11)]"") S $P(PSJP9,"@",2)=P(11)
"RTN","PSIVOCDS",92,0)
 . ;Check for DOW schedule
"RTN","PSIVOCDS",93,0)
 . I PSJP15="",PSJX S PSJP15=$P($G(^PS(51.1,PSJX,0)),U,5)
"RTN","PSIVOCDS",94,0)
 . I P(9)]"" S X=$P($$FRQ^PSSDSAPI(PSJP9,PSJP15,"I",,PSJFDB(PSJCNT,"DRUG_IEN")),U)
"RTN","PSIVOCDS",95,0)
 . I X="" S X=1 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",96,0)
 . S PSJFDB(PSJCNT,"FREQ")=X
"RTN","PSIVOCDS",97,0)
 . S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",98,0)
 . S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSIVOCDS",99,0)
 Q
"RTN","PSIVOCDS",100,0)
SINGLE ;Set fields needed for Single Dose type
"RTN","PSIVOCDS",101,0)
 ; Can't get FDB to return correct data for Continuous Infusion /w Single dose so all Continuous will be sent in as Maintenance.
"RTN","PSIVOCDS",102,0)
 I PSJFDB(PSJCNT,"ROUTE")=("CONTINUOUS INFUSION") Q
"RTN","PSIVOCDS",103,0)
 S PSJFDB(PSJCNT,"DOSE_TYPE")="SINGLE DOSE"
"RTN","PSIVOCDS",104,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",105,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",106,0)
 S PSJFDB(PSJCNT,"DURATION_RT")=PSJFDB(PSJCNT,"DOSE_RATE")
"RTN","PSIVOCDS",107,0)
 Q
"RTN","PSIVOCDS",108,0)
COMMON ;Set common data for all IV types
"RTN","PSIVOCDS",109,0)
 S PSJFDB(PSJCNT,"RX_NUM")="I;"_$G(PSJPON)_";PROSPECTIVE;"_PSJCNT
"RTN","PSIVOCDS",110,0)
 S PSJFDB(PSJCNT,"DRUG_IEN")=$P(PSIVAS0,U)
"RTN","PSIVOCDS",111,0)
 S PSJFDB(PSJCNT,"DRUG_NM")=$P(PSIVAS0,U,2)_" "_$P(PSIVAS0,U,3)
"RTN","PSIVOCDS",112,0)
 S PSJFDB(PSJCNT,"DOSE_UNIT")=$P(PSIVAS0,U,9)
"RTN","PSIVOCDS",113,0)
 S PSJFDB(PSJCNT,"ROUTE")=PSJRT
"RTN","PSIVOCDS",114,0)
 S PSJFDB(PSJCNT,"DOSE_TYPE")="MAINTENANCE"
"RTN","PSIVOCDS",115,0)
 S PSJFDB(PSJCNT,"SPECIFIC")=1
"RTN","PSIVOCDS",116,0)
 ;This is set when CPRS sends Duration without entering a solution.
"RTN","PSIVOCDS",117,0)
 I $D(PSJIV("FRQ_ERROR")) S PSJFDB(PSJCNT,"FRQ_ERROR")="",PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",118,0)
 Q
"RTN","PSIVOCDS",119,0)
BASIC ;Set basic data for non schedule IVs
"RTN","PSIVOCDS",120,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSIVOCDS",121,0)
 S PSJFDB(PSJCNT,"FREQ")=""
"RTN","PSIVOCDS",122,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",123,0)
 S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSIVOCDS",124,0)
 ; SDA is set to the additive strength or volume of the solution.
"RTN","PSIVOCDS",125,0)
 S PSJFDB(PSJCNT,"DOSE_AMT")=$P(PSIVAS0,U,8)
"RTN","PSIVOCDS",126,0)
 Q
"RTN","PSIVOCDS",127,0)
FREEDOSE ;Set data for free text dose
"RTN","PSIVOCDS",128,0)
 ;"GENERAL" info only needed to pass in Dose Route and Dose Type.
"RTN","PSIVOCDS",129,0)
 ;"Exception" node sets here to get the specified error back for free text dosing.
"RTN","PSIVOCDS",130,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",131,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",132,0)
 S PSJFDB(PSJCNT,"DURATION_RT")=PSJFDB(PSJCNT,"DOSE_RATE")
"RTN","PSIVOCDS",133,0)
 S PSJFDB(PSJCNT,"INF_ERROR")=""
"RTN","PSIVOCDS",134,0)
 I $G(PSJP8ERR)=2!($G(PSJP8ERR)=4) S PSJFDB(PSJCNT,"WT_ERROR")=""
"RTN","PSIVOCDS",135,0)
 I $G(PSJP8ERR)=3!($G(PSJP8ERR)=4) S PSJFDB(PSJCNT,"HT_ERROR")=""
"RTN","PSIVOCDS",136,0)
 Q
"RTN","PSIVOCDS",137,0)
ONEAD(PSJRT) ;Setup data for 'Continuous Infusion' IV type
"RTN","PSIVOCDS",138,0)
 NEW PSJCLASS,PSJX
"RTN","PSIVOCDS",139,0)
 I $G(PSJRT)=0!($G(PSJRT)="") Q
"RTN","PSIVOCDS",140,0)
 ;Check to make sure the infusion rate is in form of "ml/hr" before applying the calculation
"RTN","PSIVOCDS",141,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",142,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",143,0)
 S PSJFDB(PSJCNT,"ROUTE")=PSJRT
"RTN","PSIVOCDS",144,0)
 I PSJP8="" D FREEDOSE Q
"RTN","PSIVOCDS",145,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")=PSJP8TME
"RTN","PSIVOCDS",146,0)
 S PSJFDB(PSJCNT,"DURATION_RT")=PSJP8TME
"RTN","PSIVOCDS",147,0)
 I PSJP8UNT="MILLILITERS",(PSJP8TME="HOUR") D
"RTN","PSIVOCDS",148,0)
 . S PSJFDB(PSJCNT,"DOSE_AMT")=$$SDACI()
"RTN","PSIVOCDS",149,0)
 . S PSJFDB(PSJCNT,"DOSE_UNIT")=$P(PSIVAS0,U,9)
"RTN","PSIVOCDS",150,0)
 I PSJP8UNT'="MILLILITERS" D
"RTN","PSIVOCDS",151,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",152,0)
 . S PSJFDB(PSJCNT,"DOSE_AMT")=PSJP8NUM
"RTN","PSIVOCDS",153,0)
 . S PSJFDB(PSJCNT,"DOSE_UNIT")=PSJP8UNT
"RTN","PSIVOCDS",154,0)
 . S PSJFDB(PSJCNT,"DOSE_RATE")=PSJP8TME
"RTN","PSIVOCDS",155,0)
 . S PSJFDB(PSJCNT,"DURATION_RT")=PSJP8TME
"RTN","PSIVOCDS",156,0)
 Q
"RTN","PSIVOCDS",157,0)
CONTIV ;Set data needed for continuous IV with multiple drugs
"RTN","PSIVOCDS",158,0)
 NEW PSJFREQ,PSJDIFF
"RTN","PSIVOCDS",159,0)
 S PSJDIFF=+$$DURATION()
"RTN","PSIVOCDS",160,0)
 ; Order has duration <24 hrs
"RTN","PSIVOCDS",161,0)
 I PSJDIFF D UND24HRS
"RTN","PSIVOCDS",162,0)
 ; Order has duration >= 24 hrs
"RTN","PSIVOCDS",163,0)
 I 'PSJDIFF S PSJFDB(PSJCNT,"FREQ")=$$IVFREQ
"RTN","PSIVOCDS",164,0)
 ;
"RTN","PSIVOCDS",165,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",166,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSIVOCDS",167,0)
 S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSIVOCDS",168,0)
 Q
"RTN","PSIVOCDS",169,0)
ISONEAD() ;Return 1 if there's only one additive
"RTN","PSIVOCDS",170,0)
 NEW X,PSJX
"RTN","PSIVOCDS",171,0)
 I $D(PSIVDDSV("AD")),$D(PSIVDDSV("SOL")) Q 0
"RTN","PSIVOCDS",172,0)
 I $O(PSIVDDSV("SOL",0)) Q 0
"RTN","PSIVOCDS",173,0)
 S PSJX=0
"RTN","PSIVOCDS",174,0)
 F X=0:0 S X=$O(PSIVDDSV("AD",X)) Q:'X  S PSJX=PSJX+1 Q:PSJX>1
"RTN","PSIVOCDS",175,0)
 I PSJX>1 Q 0
"RTN","PSIVOCDS",176,0)
 Q 1
"RTN","PSIVOCDS",177,0)
ISALLBAG() ;Return 1 if not additive not in all bags
"RTN","PSIVOCDS",178,0)
 ;***this call assuming only 1 additive entered in the order
"RTN","PSIVOCDS",179,0)
 ;The bottle field can be either See comments, all bags, null or a numeric value (ex 1,3...)
"RTN","PSIVOCDS",180,0)
 NEW X,PSIVAS0
"RTN","PSIVOCDS",181,0)
 S X=$O(PSIVDDSV("AD",0))
"RTN","PSIVOCDS",182,0)
 S PSIVAS0=$G(PSIVDDSV("AD",X))
"RTN","PSIVOCDS",183,0)
 I +$P(PSIVAS0,U,4) Q 0
"RTN","PSIVOCDS",184,0)
 Q 1
"RTN","PSIVOCDS",185,0)
ISNOADD() ;Return 1 if there's no additives
"RTN","PSIVOCDS",186,0)
 NEW X,PSJX
"RTN","PSIVOCDS",187,0)
 I $O(PSIVDDSV("AD",0)) Q 0
"RTN","PSIVOCDS",188,0)
 I $D(PSIVDDSV("SOL")) Q 1
"RTN","PSIVOCDS",189,0)
 Q 0
"RTN","PSIVOCDS",190,0)
PREMIX ;The route is always set to "Continuous Infusion" & the FREQUENCY must set to 1
"RTN","PSIVOCDS",191,0)
 NEW X
"RTN","PSIVOCDS",192,0)
 S PSJFDB(PSJCNT,"ROUTE")=$$RTESCRN(PSJRT)
"RTN","PSIVOCDS",193,0)
 I PSJFDB(PSJCNT,"ROUTE")=0 S PSJFDB(PSJCNT,"ROUTE")=PSJRT
"RTN","PSIVOCDS",194,0)
 I PSJP8="" D FREEDOSE Q
"RTN","PSIVOCDS",195,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",196,0)
 S PSJFDB(PSJCNT,"DOSE_AMT")=PSJP8NUM
"RTN","PSIVOCDS",197,0)
 S PSJFDB(PSJCNT,"DOSE_UNIT")=PSJP8UNT
"RTN","PSIVOCDS",198,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")=PSJP8TME
"RTN","PSIVOCDS",199,0)
 S PSJFDB(PSJCNT,"DURATION_RT")=PSJP8TME
"RTN","PSIVOCDS",200,0)
 ;PSJ*5*252 (6/29/11) - No longer need to convert "ML" to "L" now FDB handles both units for this drug.
"RTN","PSIVOCDS",201,0)
 ;S PSJFDB(PSJCNT,"ROUTE")="CONTINUOUS INFUSION"
"RTN","PSIVOCDS",202,0)
 ;I PSJP8UNT="MILLILITERS" S X=$$LITER(PSJP8NUM) I X]"" D
"RTN","PSIVOCDS",203,0)
 ;. S PSJFDB(PSJCNT,"DOSE_AMT")=$P(X,U)
"RTN","PSIVOCDS",204,0)
 ;. S PSJFDB(PSJCNT,"DOSE_UNIT")=$P(X,U,2)
"RTN","PSIVOCDS",205,0)
 Q
"RTN","PSIVOCDS",206,0)
SDACI() ;Return Single Dose Amount for ad for 'CONTINUOUS INFUSION' FDB Route (Not classed at "VT" or "TN")
"RTN","PSIVOCDS",207,0)
 ;Single Dose Amount(PSJSDA):
"RTN","PSIVOCDS",208,0)
 ; For Additive - PSJSDA=(Strength/Tot vol)*Infusion Rate
"RTN","PSIVOCDS",209,0)
 ; If can't calculate then return null
"RTN","PSIVOCDS",210,0)
 NEW PSJSDA,X
"RTN","PSIVOCDS",211,0)
 S PSJSDA=""
"RTN","PSIVOCDS",212,0)
 I $D(PSIVDDSV("AD")) D
"RTN","PSIVOCDS",213,0)
 . S X=+$G(PSIVDDSV("TOT_VOL")) Q:'X
"RTN","PSIVOCDS",214,0)
 . S PSJSDA=($P(PSIVAS0,U,8)/X)*PSJP8NUM
"RTN","PSIVOCDS",215,0)
 I '+PSJSDA S PSJSDA=$P(PSIVAS0,U,8),PSJFDB(PSJCNT,"INF_ERROR")=""
"RTN","PSIVOCDS",216,0)
 Q PSJSDA
"RTN","PSIVOCDS",217,0)
CLASS(PSJDD) ;Check if the Drug contains "VT" & "TN" classes
"RTN","PSIVOCDS",218,0)
 ;Return 1 if "VT" or "TN"
"RTN","PSIVOCDS",219,0)
 ;Return 0 if not
"RTN","PSIVOCDS",220,0)
 Q:'+$G(PSJDD) 0
"RTN","PSIVOCDS",221,0)
 NEW PSJCLASS
"RTN","PSIVOCDS",222,0)
 S PSJCLASS=$P($G(^PSDRUG(+PSJDD,0)),U,2)
"RTN","PSIVOCDS",223,0)
 ;I (PSJCLASS["TN")!(PSJCLASS["VT") Q 1
"RTN","PSIVOCDS",224,0)
 I PSJCLASS["VT" Q 1
"RTN","PSIVOCDS",225,0)
 Q 0
"RTN","PSIVOCDS",226,0)
IVFREQ() ;Return the frequency for an continuous IV
"RTN","PSIVOCDS",227,0)
 ; Hours needed to run a bag is defined as: Total Volume / Infusion rate
"RTN","PSIVOCDS",228,0)
 ; # of bags needed for a day is defined as: 24 / Hours need to run a bag
"RTN","PSIVOCDS",229,0)
 ; PSJFREQ is either in Q#H or N for # of admin per day
"RTN","PSIVOCDS",230,0)
 NEW PSJFREQ,PSJBOT,PSJX,X,PSJTOTBG,PSJTOTBT,PSJTOTV,PSJBAGX
"RTN","PSIVOCDS",231,0)
 S (PSJFREQ,PSJTOTBG,PSJTOTBT)=0
"RTN","PSIVOCDS",232,0)
 S PSJTOTV=+$G(PSIVDDSV("TOT_VOL"))
"RTN","PSIVOCDS",233,0)
 ;CONV^PSSDSAPK converts # of hours to run a bag to either Q#H or n for number of admin per day
"RTN","PSIVOCDS",234,0)
 I +PSJTOTV,PSJP8NUM D
"RTN","PSIVOCDS",235,0)
 . I +PSJTOTV#PSJP8NUM D
"RTN","PSIVOCDS",236,0)
 .. S PSJFDB(PSJCNT,"DOSE_AMT")=$$ADJSDA(+PSJTOTV,PSJP8NUM,+PSJFDB(PSJCNT,"DOSE_AMT"),1)
"RTN","PSIVOCDS",237,0)
 . S PSJBAGX=PSJTOTV/PSJP8NUM
"RTN","PSIVOCDS",238,0)
 . I PSJBAGX<1 S PSJFREQ="Q1H"
"RTN","PSIVOCDS",239,0)
 . S:PSJBAGX'<1 PSJFREQ=$$CONV^PSSDSAPK(PSJTOTV/PSJP8NUM)
"RTN","PSIVOCDS",240,0)
 . S PSJTOTBG=24/(+PSJTOTV/PSJP8NUM)
"RTN","PSIVOCDS",241,0)
 I PSIVAS="AD" D BOTTLE(PSJTOTBG,$P(PSIVAS0,U,4)) D
"RTN","PSIVOCDS",242,0)
 . I PSJTOTBG<1,'(+PSJTOTV#PSJP8NUM) S PSJFDB(PSJCNT,"DOSE_AMT")=$$ADJSDA(+PSJTOTV,PSJP8NUM,+PSJFDB(PSJCNT,"DOSE_AMT"),0)
"RTN","PSIVOCDS",243,0)
 I PSJFREQ=""!(PSJFREQ=0) S PSJFREQ=1 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",244,0)
 Q PSJFREQ
"RTN","PSIVOCDS",245,0)
ADJSDA(PSJTOTV,PSJINFRT,PSJSDA,PSJNOTE) ;Adjust SDA
"RTN","PSIVOCDS",246,0)
 NEW PSJBAGX,X,PSJNOTEV
"RTN","PSIVOCDS",247,0)
 I '+$G(PSJTOTV) Q ""
"RTN","PSIVOCDS",248,0)
 I '+$G(PSJINFRT) Q ""
"RTN","PSIVOCDS",249,0)
 I '+$G(PSJSDA) Q ""
"RTN","PSIVOCDS",250,0)
 S (PSJBAGX,X)=+PSJTOTV/PSJINFRT
"RTN","PSIVOCDS",251,0)
 ;**  Removed for MOCHA 2.0 When it takes < 1 hour to run a bag. May need to bring back for MOCHA 2.1 (Daily dose check).
"RTN","PSIVOCDS",252,0)
 ;I PSJBAGX<1 S PSJSDA=PSJSDA/PSJBAGX
"RTN","PSIVOCDS",253,0)
 I PSJBAGX<1 D
"RTN","PSIVOCDS",254,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",255,0)
 . S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",256,0)
 . S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSIVOCDS",257,0)
 . S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSIVOCDS",258,0)
 I PSJBAGX'<1 D
"RTN","PSIVOCDS",259,0)
 . S X=$J(PSJBAGX,"",0)
"RTN","PSIVOCDS",260,0)
 . S PSJSDA=PSJSDA/(+PSJTOTV)*PSJINFRT*($S(X<24:X,1:24))
"RTN","PSIVOCDS",261,0)
 . S PSJNOTEV=($S(X<24:X,1:24)*PSJINFRT)_" ML over "_$S(X<24:X,1:24)_" hours)."
"RTN","PSIVOCDS",262,0)
 . I $G(PSJNOTE) D
"RTN","PSIVOCDS",263,0)
 .. S PSJFDB(PSJCNT,"ADJ_MSG")="PLEASE NOTE: The single dose of the IV Additive has been adjusted to reflect the amount of drug infused over the nearest whole number of hours ("_PSJNOTEV
"RTN","PSIVOCDS",264,0)
 . I '$G(PSJNOTE) D
"RTN","PSIVOCDS",265,0)
 .. S PSJFDB(PSJCNT,"ADJ_MSG")="PLEASE NOTE:  The single dose of the IV Additive has been adjusted to reflect the amount of drug infused over the duration of the order or 24 hours; whichever is less ("_PSJNOTEV
"RTN","PSIVOCDS",266,0)
 Q PSJSDA
"RTN","PSIVOCDS",267,0)
UND24HRS ;Calculate freq for order <24 hrs
"RTN","PSIVOCDS",268,0)
 NEW PSJTOTV,PSJBAG,PSJMNBAG,PSJTOTBG,PSJFREQ,PSJHRS,X
"RTN","PSIVOCDS",269,0)
 S (PSJFREQ,PSJBAG,PSJMNBAG)=0
"RTN","PSIVOCDS",270,0)
 S PSJTOTV=+$G(PSIVDDSV("TOT_VOL"))
"RTN","PSIVOCDS",271,0)
 I +PSJTOTV,PSJP8NUM D
"RTN","PSIVOCDS",272,0)
 . S PSJHRS=PSJTOTV/PSJP8NUM
"RTN","PSIVOCDS",273,0)
 . S PSJMNBAG=PSJHRS*60
"RTN","PSIVOCDS",274,0)
 . S PSJTOTBG=24/PSJHRS
"RTN","PSIVOCDS",275,0)
 I '+PSJMNBAG D  Q
"RTN","PSIVOCDS",276,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",277,0)
 . S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",278,0)
 S:+PSJMNBAG PSJBAG=PSJDIFF/PSJMNBAG
"RTN","PSIVOCDS",279,0)
 ; If the order is for < 24 hrs & Freq < 1 then adjust the SDA & Freq set to 1
"RTN","PSIVOCDS",280,0)
 I PSJBAG<1 D  Q
"RTN","PSIVOCDS",281,0)
 . S X=$J((PSJDIFF/60),"",0)
"RTN","PSIVOCDS",282,0)
 . S PSJNOTEV=($S(X<24:X,1:24)*PSJP8NUM)_" ML over "_$S(X<24:X,1:24)_" hours)."
"RTN","PSIVOCDS",283,0)
 . S PSJFDB(PSJCNT,"ADJ_MSG")="PLEASE NOTE:  The single dose of the IV Additive has been adjusted to reflect the amount of drug infused over the duration of the order or 24 hours; whichever is less ("_PSJNOTEV
"RTN","PSIVOCDS",284,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",285,0)
 . S PSJFDB(PSJCNT,"DOSE_AMT")=PSJBAG*(PSJFDB(PSJCNT,"DOSE_AMT"))
"RTN","PSIVOCDS",286,0)
 ;
"RTN","PSIVOCDS",287,0)
 S PSJFREQ=$J(PSJBAG,"",0)
"RTN","PSIVOCDS",288,0)
 I PSIVAS="AD" D BOTTLE(PSJFREQ,$P(PSIVAS0,U,4))
"RTN","PSIVOCDS",289,0)
 S PSJFDB(PSJCNT,"FREQ")=PSJFREQ
"RTN","PSIVOCDS",290,0)
 Q
"RTN","PSIVOCDS",291,0)
 ;
"RTN","PSIVOCDS",292,0)
BOTTLE(PSJTOTBG,PSJBOT) ;Set freq to either specified bottle or # needed for the duration/24hrs of the order
"RTN","PSIVOCDS",293,0)
 NEW PSJTOTBT,X,PSJX
"RTN","PSIVOCDS",294,0)
 I $$UP^XLFSTR($G(PSJBOT))="ALL BAGS" Q
"RTN","PSIVOCDS",295,0)
 I $$UP^XLFSTR($G(PSJBOT))="SEE COMMENTS" Q
"RTN","PSIVOCDS",296,0)
 Q:'+$G(PSJTOTBG)
"RTN","PSIVOCDS",297,0)
 ;
"RTN","PSIVOCDS",298,0)
 ;PSJ*5*252 - ADJSDA already adjusted the SDA so recal SDA is not needed
"RTN","PSIVOCDS",299,0)
 I PSJTOTBG<1 S PSJFREQ=1 Q
"RTN","PSIVOCDS",300,0)
 Q:$G(PSJBOT)=""
"RTN","PSIVOCDS",301,0)
 S PSJTOTBT=0
"RTN","PSIVOCDS",302,0)
 F X=1:1:$L(PSJBOT,",") S PSJX=$P(PSJBOT,",",X) S:+PSJX PSJTOTBT=PSJTOTBT+1
"RTN","PSIVOCDS",303,0)
 S PSJFREQ=$S(PSJTOTBT>PSJTOTBG:PSJTOTBG,1:PSJTOTBT)
"RTN","PSIVOCDS",304,0)
 I PSJTOTV#PSJP8NUM,(PSJTOTBT>PSJTOTBG) D
"RTN","PSIVOCDS",305,0)
 . S PSJFREQ=$$CONV^PSSDSAPK(PSJTOTV/PSJP8NUM)
"RTN","PSIVOCDS",306,0)
 I PSJFREQ=0 S PSJFREQ=1 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",307,0)
 Q
"RTN","PSIVOCDS",308,0)
DURATION() ;
"RTN","PSIVOCDS",309,0)
 ;If PSJIV("DUR") is passed in from CPRS then return the minutes if <1440 otherwise return ""
"RTN","PSIVOCDS",310,0)
 ;If not call from CPRS then calculate from start, stop date
"RTN","PSIVOCDS",311,0)
 NEW PSJX,X,PSJP8X
"RTN","PSIVOCDS",312,0)
 S PSJX=""
"RTN","PSIVOCDS",313,0)
 I +$G(PSJIV("DUR")) D  Q X
"RTN","PSIVOCDS",314,0)
 .S PSJX=+$G(PSJIV("DUR"))
"RTN","PSIVOCDS",315,0)
 .S X=$S(PSJX<1440:PSJX,1:"")
"RTN","PSIVOCDS",316,0)
 I +$G(PSJIV("TOT_VOL")) D  Q X
"RTN","PSIVOCDS",317,0)
 . S PSJP8X=$S(+$G(PSJP8NUM):PSJP8NUM,+P(8):+P(8),1:0)
"RTN","PSIVOCDS",318,0)
 . S:PSJP8X PSJX=(+PSJIV("TOT_VOL")/PSJP8X)*60
"RTN","PSIVOCDS",319,0)
 . S X=$S(PSJX<1440:PSJX,1:"")
"RTN","PSIVOCDS",320,0)
 S X=$$DURATION^PSJOCDS($G(P(2)),$G(P(3)))
"RTN","PSIVOCDS",321,0)
 Q X
"RTN","PSIVOCDS",322,0)
FDBRT(PSJDD,PSJRT) ;Check if the ordered route can be admin by FDB for this drug
"RTN","PSIVOCDS",323,0)
 ;PSJDD = Drug IEN
"RTN","PSIVOCDS",324,0)
 ;PSJRT = FDB continuous dose route (ordered MR -> Standard RT ->FDB cont. Rt)
"RTN","PSIVOCDS",325,0)
 ;Return 1 if the route can admin by FDB; 0 if this route is not specify for this drug
"RTN","PSIVOCDS",326,0)
 NEW PSJFDBRT
"RTN","PSIVOCDS",327,0)
 I '+$G(PSJDD)!$G(PSJRT)="" Q 0
"RTN","PSIVOCDS",328,0)
 D GROUTE^PSSFDBRT(PSJDD,.PSJFDBRT)
"RTN","PSIVOCDS",329,0)
 I +$G(PSJFDBRT(0))=-1 Q 1
"RTN","PSIVOCDS",330,0)
 I $D(PSJFDBRT(PSJRT)) Q 1
"RTN","PSIVOCDS",331,0)
 Q 0
"RTN","PSIVOCDS",332,0)
RTESCRN(PSJRT) ; Screen routes for none "VT or "TN"
"RTN","PSIVOCDS",333,0)
 ;Return 0 or FDB continuous dose route if the standard route(mapped to the ordered MR) is one of the six below.
"RTN","PSIVOCDS",334,0)
 ;PSJRT - standard route
"RTN","PSIVOCDS",335,0)
 I $G(PSJRT)="" Q 0
"RTN","PSIVOCDS",336,0)
 I PSJRT="EPIDURAL" Q "CONTINUOUS EPIDURAL"
"RTN","PSIVOCDS",337,0)
 I PSJRT="INTRA-ARTERIAL" Q "CONT INTRAARTER INF"
"RTN","PSIVOCDS",338,0)
 I PSJRT="INFILTRATION" Q "CONTINUOUS INFILTRAT"
"RTN","PSIVOCDS",339,0)
 I PSJRT="INTRACAUDAL" Q "CONT CAUDAL INFUSION"
"RTN","PSIVOCDS",340,0)
 I PSJRT="INTRAOSSEOUS" Q "CONT INTRAOSSEOUS"
"RTN","PSIVOCDS",341,0)
 I PSJRT="INTRATHECAL" Q "CONT INTRATHECAL INF"
"RTN","PSIVOCDS",342,0)
 I PSJRT="INTRAVENOUS" Q "CONTINUOUS INFUSION"
"RTN","PSIVOCDS",343,0)
 I PSJRT="NEBULIZATION" Q "CONT NEBULIZATION"
"RTN","PSIVOCDS",344,0)
 I PSJRT="SUBCUTANEOUS" Q "CONT SUBCUTAN INFUSI"
"RTN","PSIVOCDS",345,0)
 Q 0
"RTN","PSIVOCDS",346,0)
LITER(PSJVOLP8) ; Convert the unit from ML to L for premix contains potassium
"RTN","PSIVOCDS",347,0)
 ; PSJ*5*252 (6/29/11) - No longer need to convert "ML" to "L" for this drug now that FDB handles both units.
"RTN","PSIVOCDS",348,0)
 ; FDB only accept Liter for this type for drug
"RTN","PSIVOCDS",349,0)
 ; PSJVOLP8 - Either = volume or the infusion rate
"RTN","PSIVOCDS",350,0)
 NEW PSJVAGEN,PSJSDA,PSJUNIT
"RTN","PSIVOCDS",351,0)
 Q:$G(PSJVOLP8)=""
"RTN","PSIVOCDS",352,0)
 S PSJVAGEN=$$VAGEN^PSJMISC($P(PSIVAS0,U))
"RTN","PSIVOCDS",353,0)
 I PSJVAGEN["POTASSIUM" D
"RTN","PSIVOCDS",354,0)
 . S PSJSDA=+(PSJVOLP8/1000)
"RTN","PSIVOCDS",355,0)
 . S PSJUNIT="L"
"RTN","PSIVOCDS",356,0)
 I '+$G(PSJSDA)!($G(PSJUNIT)="") Q ""
"RTN","PSIVOCDS",357,0)
 Q PSJSDA_U_PSJUNIT
"RTN","PSIVSP")
0^7^B45290793
"RTN","PSIVSP",1,0)
PSIVSP ;BIR/RGY,PR,CML3 - DOSE PROCESSOR ;1/3/12 3:36pm
"RTN","PSIVSP",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**30,37,41,50,56,74,83,111,133,138,134,213,229,279,305,331,256,347**;16 DEC 97;Build 6
"RTN","PSIVSP",3,0)
 ;
"RTN","PSIVSP",4,0)
 ; Reference to ^PS(51.1 is supported by DBIA #2177
"RTN","PSIVSP",5,0)
 ;
"RTN","PSIVSP",6,0)
EN ;
"RTN","PSIVSP",7,0)
 NEW PSJORGX
"RTN","PSIVSP",8,0)
 Q:'$D(X)
"RTN","PSIVSP",9,0)
 S ATZERO=0 I X["@",$P(X,"@",2)=0 S ATZERO=1,X=$P(X,"@")
"RTN","PSIVSP",10,0)
 ;D EN^PSGS0 S (P(9),PSIVSC1)=$S($G(X)]"":X,1:$G(P(9))),P(11)=$S($G(PSGS0Y):PSGS0Y,1:$G(P(11))),(XT,P(15))=$S(($G(PSGS0XT)!($G(PSGS0XT)="O")!($G(PSGS0XT)="D")):$G(PSGS0XT),1:$G(P(15)))
"RTN","PSIVSP",11,0)
 ;PSJ*5*256 - not set P(9) when FN order so the Old schedule name is not auto replaced with .01 value
"RTN","PSIVSP",12,0)
 S PSJORGX=X
"RTN","PSIVSP",13,0)
 D EN^PSGS0 S:$S((($G(PSJOCFG)="FN IV")&(($G(P(9))="")&($G(X)]""))):1,(($G(X)]"")&($G(X)'=PSJORGX)):1,$G(PSJOCFG)="":0,1:1) P(9)=$S($G(X)]"":X,1:$G(P(9)))
"RTN","PSIVSP",14,0)
 S P(11)=$S($G(PSGS0Y):PSGS0Y,1:$G(P(11))),(XT,P(15))=$S(($G(PSGS0XT)!($G(PSGS0XT)="O")!($G(PSGS0XT)="D")):$G(PSGS0XT),1:$G(P(15)))
"RTN","PSIVSP",15,0)
 I $G(ATZERO) S P(7)=1
"RTN","PSIVSP",16,0)
 K ATZERO Q
"RTN","PSIVSP",17,0)
EN1 ;
"RTN","PSIVSP",18,0)
 S (PSIVAT,PSIVWAT,Y)="",XT=-1,X0=X,X=$S(X="ON CALL":X,X="ONCALL":X,X="ON-CALL":X,X="ONETIME":X,X="ONE-TIME":X,X="ONE TIME":X,X="1TIME":X,X="1 TIME":X,X="1-TIME":X,$L(X," ")<3:$P(X," "),1:$P(X," ",1,2))
"RTN","PSIVSP",19,0)
 S:$E(X)="^" X=$E(X,2,999) G:X="" Q S:(X["@0")&($$SCHREQ^PSJLIVFD(.P)) ATZERO=1 S X=$S(X["@0":$P(X,"@"),1:X),P(7)=$S($G(ATZERO):1,1:"") K ATZERO
"RTN","PSIVSP",20,0)
 I $S($D(^PS(51.1,"AC","PSJ",X)):1,1:$E($O(^(X)),1,$L(X))=X) D DIC I Y'<0 G SH
"RTN","PSIVSP",21,0)
NS0 S Y=""
"RTN","PSIVSP",22,0)
 I $E(X,1,2)="AD" S XT=-1 Q
"RTN","PSIVSP",23,0)
 I $E(X,1,3)="BID"!($E(X,1,3)="TID")!($E(X,1,3)="QID") S XT=1440\$F("BTQ",$E(X))
"RTN","PSIVSP",24,0)
 E  S:$E(X)="Q" X=$E(X,2,99) S:'X X=$E(X)["O"+1_X S I=+X,X=$P(X,I,2),XT=I*$S(X["'":1,(X["D"&(X'["AD"))!(X["AM")!(X["PM")!(X["HS"&(X'["THS")):1440,X["H"&(X'["TH"):60,X["AC"!(X["PC"):480,X["W":10080,X["M":40320,1:0),X=X0 D 
"RTN","PSIVSP",25,0)
 . I 'XT,X'="NOW",X'="STAT",X'="ONCE",X'="ONE-TIME",X'="ONE TIME",X'="ONETIME",X'="1-TIME",X'="1 TIME",X'="1TIME",Y="" S XT=-1
"RTN","PSIVSP",26,0)
SH ;
"RTN","PSIVSP",27,0)
 I +Y<1,$E(X0)'="^" W:$G(ON)'["P" "  ",$S(XT=0&($S("^NOW^STAT^ONCE^ONE-TIME^ONETIME^1TIME^1-TIME^"[(U_$P(X," ")_U):1,X["1 TIME":1,1:X["ONE TIME")):"(ONCE ONLY)",XT>0:"Nonstandard schedule",XT<0:"",1:"(??)") W:XT>0 " (",XT," MINUTES)"
"RTN","PSIVSP",28,0)
Q Q:X="ONE TIME"
"RTN","PSIVSP",29,0)
 N I S X0=$P(X," ")_$S($L(X0," ")-1:" ",1:"")_$P(X0," ",2,99) K:XT<0!($L(X0)>22) X S:$D(X) X=X0 K X0 S:$G(P(7)) XT="" Q
"RTN","PSIVSP",30,0)
NEWQ ;N I S X0=$P(X," ")_$S($L(X0," ")-1:" ",1:"")_$P(X0," ",2,99) K:XT<0!($L(X0)>22) X S:$D(X) X=X0 S:P(7) X=X0 K X0 K:XT>0&('P(7)) X Q
"RTN","PSIVSP",31,0)
 Q
"RTN","PSIVSP",32,0)
 ;
"RTN","PSIVSP",33,0)
 ;*229 Add Temp val for dose limit in IOE
"RTN","PSIVSP",34,0)
ENDL N PSIVLIMT W "   Dose limit ....  " S PSIVLIMT="a"_X,PSIVMIN=P(15)*X,PSIVSD=+P(2)
"RTN","PSIVSP",35,0)
 I PSIVMIN<0 W !!," --- There is something wrong with this order !!",!,"     Call inpatient supervisor ....." S Y=-1 K PSIVMIN Q
"RTN","PSIVSP",36,0)
 I P(15)'["D",P(4)="P"!(P(5))!(P(23)="P"),PSIVMIN=0,"^NOW^STAT^ONCE^ONE-TIME^ONE TIME^ON CALL^ONETIME^1TIME^1 TIME^1-TIME^"'[(U_P(9)_U) D DLP G QDL
"RTN","PSIVSP",37,0)
 ;*229 DOW Calc and dose lim should match CPRS, if it's vol limit, we leave old functionality
"RTN","PSIVSP",38,0)
 I $G(P(9))]"",$G(P(11))]"" D ENSTOP^PSIVCAL S Y=X I 1 ;*229 ENSTOP^PSIVCAL returns X, we wanted Y.
"RTN","PSIVSP",39,0)
 E  D ENT^PSIVWL
"RTN","PSIVSP",40,0)
QDL I $D(X) S X=Y X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2) S Y=X
"RTN","PSIVSP",41,0)
 Q
"RTN","PSIVSP",42,0)
DLP ;
"RTN","PSIVSP",43,0)
 S X=X+1,$P(PSIVSD,".",2)=$P(PSIVSD,".",2)_$E("0000",1,4-$L($P(PSIVSD,".",2))) D CHK S X2=0,Y=1 I X<2 S Y=+PSIVSD G QDLP
"RTN","PSIVSP",44,0)
 I $P(PSIVSD,".",2)>$P(P(11),"-",$L(P(11),"-")) S X2=1 G OV
"RTN","PSIVSP",45,0)
 G:$P(P(11),"-")>$P(PSIVSD,".",2) OV
"RTN","PSIVSP",46,0)
 F Y=1:1 S X1=$P(P(11),"-",Y) I X1=$P(PSIVSD,".",2)!($P(PSIVSD,".",2)<X1) Q
"RTN","PSIVSP",47,0)
OV I P(11)="" W $C(7)," ???",!?15,"*** You have not defined any administration times !!" K X Q
"RTN","PSIVSP",48,0)
 F Y=Y:1 S:$P(P(11),"-",Y)="" X2=X2+1,Y=0,X=X+1 S X=X-1 Q:X<1
"RTN","PSIVSP",49,0)
 S X=PSIVSD\1 I X2>0 S X1=PSIVSD D C^%DTC S X=$P(X,".") ; install with version 17.3 of fileman
"RTN","PSIVSP",50,0)
 S Y=+(X_"."_$P(P(11),"-",Y))
"RTN","PSIVSP",51,0)
QDLP K X1,X2 Q
"RTN","PSIVSP",52,0)
 ;
"RTN","PSIVSP",53,0)
ENI ;
"RTN","PSIVSP",54,0)
 N PSIZEROX S PSIZEROX=0_+X
"RTN","PSIVSP",55,0)
 K:$L(X)<1!($L(X)>30)!(X["""")!($A(X)=45) X I '$D(X)!'$D(P(4)) Q
"RTN","PSIVSP",56,0)
 ;*229 Reset ATZERO flag.
"RTN","PSIVSP",57,0)
 I $P(X,"@",2)'=0!'$$SCHREQ^PSJLIVFD(.P) S P(7)=""
"RTN","PSIVSP",58,0)
 I P(4)="P"!(P(5))!(P(23)="P") Q:'X  S X="INFUSE OVER "_X_" MINUTE"_$S(X>1:"S",1:"") W "   ",X Q
"RTN","PSIVSP",59,0)
 I $E(X)="." K X Q  ;Enforce leading zero.
"RTN","PSIVSP",60,0)
 I X'=+X!(X'=0_+X),X["@",($P(X,"@",2,999)'=+$P(X,"@",2,999)!(+$P(X,"@",2,999)<0)) K X Q
"RTN","PSIVSP",61,0)
 S SPSOL=$O(DRG("SOL",0)) I 'SPSOL K SPSOL,X W "  You must define at least one solution !!" Q
"RTN","PSIVSP",62,0)
 I (X=+X)!(X=PSIZEROX) I X'["@" S X=X_" ml/hr" W " ml/hr" D SPSOL S P(15)=$S('X:0,1:SPSOL\X*60+(SPSOL#X/X*60+.5)\1) K SPSOL Q
"RTN","PSIVSP",63,0)
 S SPSOL=$S(($P(X,"@",2)?1.N):$P(X,"@",2),1:$G(P("NUMLBL"))) I SPSOL S P("NUMLBL")=+SPSOL
"RTN","PSIVSP",64,0)
 S:$P(X,"@")=+X!($P(X,"@")=PSIZEROX) $P(X,"@")=$P(X,"@")_" ml/hr" W "   ",+SPSOL," Label",$S(SPSOL'=1:"s",1:"")," per day",!?15,"at an infusion rate of: ",$P(X,"@") S P(15)=$S('SPSOL:0,1:1440/SPSOL\1) K SPSOL
"RTN","PSIVSP",65,0)
 I X["@",$P(X,"@",2)=0,$$SCHREQ^PSJLIVFD(.P) S P(7)=1  ; Set ATZERO flag
"RTN","PSIVSP",66,0)
 ;*305
"RTN","PSIVSP",67,0)
 I '$G(PSJEXMSG) D EXPINF^PSIVEDT1(.X)
"RTN","PSIVSP",68,0)
 Q
"RTN","PSIVSP",69,0)
SPSOL S SPSOL=0 F XXX=0:0 S XXX=$O(DRG("SOL",XXX)) Q:'XXX  S SPSOL=SPSOL+$P(DRG("SOL",XXX),U,3)
"RTN","PSIVSP",70,0)
 K XXX Q
"RTN","PSIVSP",71,0)
CHK F Y=1:1 Q:$L(P(11))>240!($P(P(11),"-",Y)="")  S $P(P(11),"-",Y)=$P(P(11),"-",Y)_$E("0000",1,4-$L($P(P(11),"-",Y)))
"RTN","PSIVSP",72,0)
 Q
"RTN","PSIVSP",73,0)
 ;
"RTN","PSIVSP",74,0)
DIC ; 51.1 look-up
"RTN","PSIVSP",75,0)
 N PSJSCH S PSJSCH=X I '$D(WSCHADM) N VAIP D IN5^VADPT S WSCHADM=VAIP(5),X=PSJSCH
"RTN","PSIVSP",76,0)
 K DIC S DIC="^PS(51.1,",DIC(0)=$E("E",'$D(NOECH))_"ISZ"
"RTN","PSIVSP",77,0)
 ; The naked reference below refers to the full reference inside indirection to ^PS(51.1
"RTN","PSIVSP",78,0)
 S DIC("W")="W ""  "","_$S('$D(WSCHADM):"$P(^(0),""^"",2)",'+WSCHADM:"$P(^(0),""^"",2)",1:"$S($D(^PS(51.1,+Y,1,+WSCHADM,0)):$P(^(0),""^"",2),1:$P(^PS(51.1,+Y,0),""^"",2))"),D="APPSJ" S:$D(PSIVSPQF) DIC(0)=DIC(0)_"O"
"RTN","PSIVSP",79,0)
 D IX^DIC K DIC
"RTN","PSIVSP",80,0)
 S:$D(DIE)#2 DIC=DIE Q:Y<0
"RTN","PSIVSP",81,0)
 S X=Y(0,0),ZZY=Y,(XT,Y)="" I $D(WSCHADM),$D(^PS(51.1,+ZZY,1,+WSCHADM,0)),$P(^(0),"^",2)]"" S (PSIVWAT,Y)=$P(^(0),"^",2)
"RTN","PSIVSP",82,0)
 K ZZY,WSCHADM S:Y="" (X,PSIVSC1)=$P(Y(0),U),(PSIVAT,Y)=$P(Y(0),"^",2) S XT=$P(Y(0),"^",3) Q
"RTN","PSIVSP",83,0)
 ;
"RTN","PSIVSP",84,0)
ORINF ;  OERR input transform for Infusion Rate
"RTN","PSIVSP",85,0)
 ;  X=data
"RTN","PSIVSP",86,0)
 N INFUSE
"RTN","PSIVSP",87,0)
 K:$L(X)<1!($L(X)>30)!(X["""")!($A(X)=45) X I '$D(X) Q
"RTN","PSIVSP",88,0)
 I X?.E1L.E S INFUSE=$$ENLU^PSGMI(X) Q:(INFUSE="TITRATE")!(INFUSE="BOLUS")!($P(INFUSE," ")="INFUSE")!($P(INFUSE," ")="Infuse")
"RTN","PSIVSP",89,0)
 Q:(X="TITRATE")!(X="BOLUS")!($P(X," ")="INFUSE")!($P(X," ")="Infuse")
"RTN","PSIVSP",90,0)
 I X["=" D  Q   ; NOIS LOU-0501-42191
"RTN","PSIVSP",91,0)
 .N X2,X1 S X1=$P(X,"="),X2=$P(X,"=",2)
"RTN","PSIVSP",92,0)
 .I X1["ML/HR",(+X1=$P(X1,"ML/HR"))!(+X1=$P(X1," ML/HR")) D
"RTN","PSIVSP",93,0)
 ..S X1=$TR(X1,"ML/HR","ml/hr")
"RTN","PSIVSP",94,0)
 .I X2["ML/HR",(+X2=$P(X2,"ML/HR"))!(+X2=$P(X2," ML/HR")) D
"RTN","PSIVSP",95,0)
 ..S X2=$TR(X2,"ML/HR","ml/hr")
"RTN","PSIVSP",96,0)
 .I X1[" ml/hr",(+X1=$P(X1," ml/hr")) D
"RTN","PSIVSP",97,0)
 ..S X1=$P(X1," ml/hr")_$P(X1," ml/hr",2,9999)
"RTN","PSIVSP",98,0)
 .I X2[" ml/hr",(+X2=$P(X2," ml/hr")) D
"RTN","PSIVSP",99,0)
 ..S X2=$P(X2," ml/hr")_$P(X2," ml/hr",2,9999)
"RTN","PSIVSP",100,0)
 .I X1["ml/hr",(+X1=$P(X1,"ml/hr")) D
"RTN","PSIVSP",101,0)
 ..S X1=$P(X1,"ml/hr")_$P(X1,"ml/hr",2,9999)
"RTN","PSIVSP",102,0)
 .I X2["ml/hr",(+X2=$P(X2,"ml/hr")) D
"RTN","PSIVSP",103,0)
 ..S X2=$P(X2,"ml/hr")_$P(X2,"ml/hr",2,9999)
"RTN","PSIVSP",104,0)
 .I X2'=+X2 D
"RTN","PSIVSP",105,0)
 ..I X2>0&(X2<1) Q
"RTN","PSIVSP",106,0)
 ..I ($P(X2,"@",2,999)'=+$P(X2,"@",2,999)!(+$P(X2,"@",2,999)<0)) K X Q
"RTN","PSIVSP",107,0)
 .I X1>0&(X1<1) I +X1="."_$P(X1,".",2) S X1=X1_" ml/hr"
"RTN","PSIVSP",108,0)
 .I X2>0&(X2<1) I +X2="."_$P(X2,".",2) S X2=X2_" ml/hr"
"RTN","PSIVSP",109,0)
 .I X1=+X1 S X1=X1_" ml/hr"
"RTN","PSIVSP",110,0)
 .I X2=+X2 S X2=X2_" ml/hr"
"RTN","PSIVSP",111,0)
 .S:$P(X2,"@")=+X2 $P(X2,"@")=$P(X2,"@")_" ml/hr"
"RTN","PSIVSP",112,0)
 .S X=X1_"="_X2
"RTN","PSIVSP",113,0)
 I X["ML/HR",(+X=$P(X,"ML/HR"))!(+X=$P(X," ML/HR")) S X=$TR(X,"ML/HR","ml/hr")
"RTN","PSIVSP",114,0)
 I X[" ml/hr",+X=$P(X," ml/hr") S X=$P(X," ml/hr")_$P(X," ml/hr",2,9999)
"RTN","PSIVSP",115,0)
 I X["ml/hr",+X=$P(X,"ml/hr") S X=$P(X,"ml/hr")_$P(X,"ml/hr",2,9999)
"RTN","PSIVSP",116,0)
 I X>0,X<1 D  Q
"RTN","PSIVSP",117,0)
 .I X["ML/HR",(+X=$P($P(X,"ML/HR"),".",2))!(+X=$P($P(X," ML/HR"),".",2)) S X=$TR(X,"ML/HR","ml/hr")
"RTN","PSIVSP",118,0)
 .I X[" ml/hr",(+X=$P($P(X," ml/hr"),".",2)) S X=$P(X," ml/hr")_$P(X," ml/hr",2,9999)
"RTN","PSIVSP",119,0)
 .I X["ml/hr",+X=$P(X,"ml/hr") S X=$P(X,"ml/hr")_$P(X,"ml/hr",2,9999)
"RTN","PSIVSP",120,0)
 .I +X=X S X=X_" ml/hr"
"RTN","PSIVSP",121,0)
 .I $P(X,0,2)=+X S X=X_" ml/hr"
"RTN","PSIVSP",122,0)
 .S X=0_+X_$P(X,+X,2)
"RTN","PSIVSP",123,0)
 I '(X>0&X<1) I X'=+X,($P(X,"@",2,999)'=+$P(X,"@",2,999)!(+$P(X,"@",2,999)<0)) K X Q
"RTN","PSIVSP",124,0)
 I X=+X S X=X_" ml/hr" Q
"RTN","PSIVSP",125,0)
 S:$P(X,"@")=+X $P(X,"@")=$P(X,"@")_" ml/hr"
"RTN","PSIVSP",126,0)
 Q
"RTN","PSJBCMA3")
0^13^B4491132
"RTN","PSJBCMA3",1,0)
PSJBCMA3 ;BIR/JLC-ADD BCMA STATUS UPDATE TO PS(55 ;21 FEB 01
"RTN","PSJBCMA3",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**58,91,190,347**;16 DEC 97;Build 6
"RTN","PSJBCMA3",3,0)
 ;Reference to ^PS(51.1 is supported by DBIA #2177.
"RTN","PSJBCMA3",4,0)
 ;Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSJBCMA3",5,0)
 ;
"RTN","PSJBCMA3",6,0)
EN(DFN,ON,BCID,STATUS,DATE)         ;
"RTN","PSJBCMA3",7,0)
 I '$D(DFN)!'$D(ON)!'$D(BCID)!'$D(STATUS)!'$D(DATE) Q
"RTN","PSJBCMA3",8,0)
 I '$D(^PS(55,DFN,"IV",ON)) Q
"RTN","PSJBCMA3",9,0)
 N PSJBLN,UON
"RTN","PSJBCMA3",10,0)
 D SEARCH(ON)
"RTN","PSJBCMA3",11,0)
 I $D(PSJBLN) S UON=ON G UPDATE
"RTN","PSJBCMA3",12,0)
 S (PON,OPON)=ON F  S PON=$P(^PS(55,DFN,"IV",PON,2),"^",5) S:PON["P" PON=$$PNDV(PON) S PON=+PON Q:'PON  Q:PON=OPON  D SEARCH(PON) Q:$D(PSJBLN)  S OPON=PON
"RTN","PSJBCMA3",13,0)
 I $D(PSJBLN) S UON=PON G UPDATE
"RTN","PSJBCMA3",14,0)
 Q
"RTN","PSJBCMA3",15,0)
SEARCH(ON) S X1=0 F  S X1=$O(^PS(55,DFN,"IV",ON,"BCMA",X1)) Q:X1=""!(X1'?1.N)  I $D(^PS(55,DFN,"IVBCMA",X1)),$P(^(X1,0),"^")=BCID S PSJBLN=X1 Q
"RTN","PSJBCMA3",16,0)
 Q
"RTN","PSJBCMA3",17,0)
UPDATE K DA,DR,DIE S DIE="^PS(55,"_DFN_",""IVBCMA"",",DA=PSJBLN,DA(1)=DFN,DR="1////"_DATE_";2////"_STATUS
"RTN","PSJBCMA3",18,0)
 I STATUS="" S DR="1///@;2///@"
"RTN","PSJBCMA3",19,0)
 D ^DIE
"RTN","PSJBCMA3",20,0)
 K DA,DR,DIE S DIE="^PS(55,"_DFN_",""IV"",",DA=UON,DA(1)=DFN,DR="144////"_STATUS_";145////"_BCID
"RTN","PSJBCMA3",21,0)
 I STATUS="" S DR="144///@;145///@"
"RTN","PSJBCMA3",22,0)
 D ^DIE
"RTN","PSJBCMA3",23,0)
 Q
"RTN","PSJBCMA3",24,0)
 ;
"RTN","PSJBCMA3",25,0)
PNDV(PNDON) ;
"RTN","PSJBCMA3",26,0)
 Q:PNDON'["P" ""
"RTN","PSJBCMA3",27,0)
 N PRV S PRV=""
"RTN","PSJBCMA3",28,0)
 F  S PRV=$P($G(^PS(53.1,+PNDON,0)),"^",25) Q:PRV=""!(PRV["V")  S PNDON=PRV
"RTN","PSJBCMA3",29,0)
 Q $S(PRV["V":PRV,1:"")
"RTN","PSJBCMA3",30,0)
 ;
"RTN","PSJBCMA3",31,0)
OTPRN(SCH1) ; Determine if this order is a one-time PRN  PSJ*5*190
"RTN","PSJBCMA3",32,0)
 N SCH2 S TYP=""
"RTN","PSJBCMA3",33,0)
 ;actual schedule of "x PRN" exists in schedule file. Don't remove PRN from it.
"RTN","PSJBCMA3",34,0)
 I $D(^PS(51.1,"AC","PSJ",SCH1)) D  Q $G(TYP)
"RTN","PSJBCMA3",35,0)
 .S SCH2=$O(^PS(51.1,"AC","PSJ",SCH1,"")) Q:'$D(^PS(53.1,SCH2))
"RTN","PSJBCMA3",36,0)
 .S TYP=$P($G(^PS(51.1,SCH2,0)),"^",5)
"RTN","PSJBCMA3",37,0)
 S SCH1=$P(SCH1," PRN",1)
"RTN","PSJBCMA3",38,0)
 I SCH1="" Q ""
"RTN","PSJBCMA3",39,0)
 I '$D(^PS(51.1,"AC","PSJ",SCH1)) Q ""
"RTN","PSJBCMA3",40,0)
 S SCH2=$O(^PS(51.1,"AC","PSJ",SCH1,""))
"RTN","PSJBCMA3",41,0)
 I '$D(^PS(51.1,SCH2)) Q ""
"RTN","PSJBCMA3",42,0)
 Q $P($G(^PS(51.1,SCH2,0)),"^",5)
"RTN","PSJBLDOC")
0^12^B59663394
"RTN","PSJBLDOC",1,0)
PSJBLDOC ;BIR/MV - API to build ^TMP for prospective and PSJ profile drugs ;03 Aug 98 / 8:42 AM
"RTN","PSJBLDOC",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,263,260,295,252,257,299,281,347**;16 DEC 97;Build 6
"RTN","PSJBLDOC",3,0)
 ;
"RTN","PSJBLDOC",4,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231.
"RTN","PSJBLDOC",5,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173.
"RTN","PSJBLDOC",6,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJBLDOC",7,0)
 ; Reference to ^PSDRUG( is supported by DBIA# 2192.
"RTN","PSJBLDOC",8,0)
 ; Reference to ^PSSDSAPI is supported by DBIA# 5425.
"RTN","PSJBLDOC",9,0)
 ; Reference to ^PSSDSAPM is supported by DBIA# 5570.
"RTN","PSJBLDOC",10,0)
 ;
"RTN","PSJBLDOC",11,0)
IN(DFN,LIST,PDRG,PTYP) ;
"RTN","PSJBLDOC",12,0)
 ;Build the IPM profiles and the prospective drugs list for both PSO & PSJ if PDRG is passed in.
"RTN","PSJBLDOC",13,0)
 ;DFN - PATIENT DFN
"RTN","PSJBLDOC",14,0)
 ;LIST - BASE
"RTN","PSJBLDOC",15,0)
 ;PDRG - Drug array in format of PDRG(n)=IEN (#50) ^ Drug name
"RTN","PSJBLDOC",16,0)
 ;       Where n is a sequential number.  Drug name can be OI, Generic name from #50 or Additive/sol name
"RTN","PSJBLDOC",17,0)
 ;PTYP - P1;P2 where P1="I" for Inpatient & "O" for Outpatient, P2= PSJ order#
"RTN","PSJBLDOC",18,0)
 NEW PSJONCNT,PSJDCNT,PSJDRGND,PSJWON
"RTN","PSJBLDOC",19,0)
 S PSJONCNT=0
"RTN","PSJBLDOC",20,0)
 S PSJWON=$P($G(PTYP),";",2)
"RTN","PSJBLDOC",21,0)
 D PROFILE(DFN,PSJWON,PTYP)
"RTN","PSJBLDOC",22,0)
 K ^TMP($J,"PSJPRE","CLINIC")
"RTN","PSJBLDOC",23,0)
 Q
"RTN","PSJBLDOC",24,0)
PROFILE(DFN,PSJWON,PTYP)     ;Setup ^TMP for the active meds to be on the OC profile list.
"RTN","PSJBLDOC",25,0)
 ;DFN:    Patient internal entry number
"RTN","PSJBLDOC",26,0)
 ;PSJWON: The current order number being working on.  It can be null.
"RTN","PSJBLDOC",27,0)
 ;        It is the order being work on (RN, FN..) and should be on the prospective list.
"RTN","PSJBLDOC",28,0)
 ;Output: ^TMP($J,"ORDERS",PSJINX)=DRUG CLASS^NATIONAL DRUG FILE ENTRY
"RTN","PSJBLDOC",29,0)
 ;        _"A"_PSNDFA PRODUCT NAME ENTRY_DISPENSE DRUG NAME^OE/RR #
"RTN","PSJBLDOC",30,0)
 ;        _ORDER NUMBER(P/I/V)_";I"
"RTN","PSJBLDOC",31,0)
 ;
"RTN","PSJBLDOC",32,0)
 NEW BDT,COD,DDRUG,DDRUGND,EDT,F,ON,ON1,PST,WBDT,X,PSJORIEN,%,PSJCLCOD,PSJCLINF,PSJCLIND,PSJTYPCL
"RTN","PSJBLDOC",33,0)
 S PSJWON=$G(PSJWON),PSJCLCOD=""
"RTN","PSJBLDOC",34,0)
 ;
"RTN","PSJBLDOC",35,0)
 ;Must display any DC/Expired clinic orders within largest number of days defined for whichever clinic has the oldest date defined for ORDER CHECK DC/EXPIRED DAYS field
"RTN","PSJBLDOC",36,0)
 ;under the CLINIC DEFINITION file (#53.46)
"RTN","PSJBLDOC",37,0)
 ;Active, non-verified, pending, hold clinic orders must be displayed in the clinic display format.
"RTN","PSJBLDOC",38,0)
 D CLINICS^PSJCLNOC(DFN)  ;get clinic orders for this patient and set ^TMP($J,"PSJPRE","CLINIC",IEN,FILE_TYPE)=""
"RTN","PSJBLDOC",39,0)
 I $D(^TMP($J,"PSJPRE","CLINIC")) D
"RTN","PSJBLDOC",40,0)
 .S (PSJTYPCL,ON)="" F  S ON=$O(^TMP($J,"PSJPRE","CLINIC",ON)) Q:ON=""  F  S PSJTYPCL=$O(^TMP($J,"PSJPRE","CLINIC",ON,PSJTYPCL)) Q:PSJTYPCL=""  D
"RTN","PSJBLDOC",41,0)
 ..S F="^PS(55,DFN,5,"
"RTN","PSJBLDOC",42,0)
 ..I PSJTYPCL["55U" S COD=ON_"U",PSJCLCOD=2 D:COD'=PSJWON UD Q
"RTN","PSJBLDOC",43,0)
 ..I PSJTYPCL["55I" S COD=ON_"V" S PSJCLCOD=1 D:COD'=PSJWON IV Q
"RTN","PSJBLDOC",44,0)
 ..S F="^PS(53.1,"
"RTN","PSJBLDOC",45,0)
 ..S COD=ON_"P" Q:COD=PSJWON!($D(PSJVFF)&(COD=$G(PSJORD)))
"RTN","PSJBLDOC",46,0)
 ..I $G(PSJCOM),($G(PSJWON)["P") Q:$D(^PS(53.1,"ACX",PSJCOM,+ON))
"RTN","PSJBLDOC",47,0)
 ..I $O(^PS(53.1,+ON,"AD",0))!$O(^PS(53.1,+ON,"SOL",0)) S PSJCLCOD=3 D PIV Q
"RTN","PSJBLDOC",48,0)
 ..;PSJ*5*347
"RTN","PSJBLDOC",49,0)
 ..S PSJCLCOD=4
"RTN","PSJBLDOC",50,0)
 ..I $$GET1^DIQ(53.1,+ON,4,"I")="I" S PSJCLCOD=5
"RTN","PSJBLDOC",51,0)
 ..;S PSJCLCOD=4 D UD
"RTN","PSJBLDOC",52,0)
 ..D UD
"RTN","PSJBLDOC",53,0)
 ;
"RTN","PSJBLDOC",54,0)
 D NOW^%DTC S (BDT,WBDT)=%,EDT=9999999  ; WBDT SET THIS WAY BEFORE CLINIC OC DISPLAY ADDED
"RTN","PSJBLDOC",55,0)
 S F="^PS(55,DFN,5," F  S WBDT=$O(^PS(55,DFN,5,"AUS",WBDT)) Q:'WBDT  F ON=0:0 S ON=$O(^PS(55,DFN,5,"AUS",WBDT,ON)) Q:'ON  I '$D(^TMP($J,"PSJPRE","CLINIC",ON)) S COD=ON_"U",PSJCLCOD=2 D:COD'=PSJWON UD
"RTN","PSJBLDOC",56,0)
 S WBDT=BDT,F="^PS(53.1,",PSJCLCOD="" F PST="P","N" F ON=0:0 S ON=$O(^PS(53.1,"AS",PST,DFN,ON)) Q:'ON  I '$D(^TMP($J,"PSJPRE","CLINIC",ON)) D
"RTN","PSJBLDOC",57,0)
 . S COD=ON_"P" Q:COD=PSJWON!($D(PSJVFF)&(COD=$G(PSJORD)))
"RTN","PSJBLDOC",58,0)
 . I $G(PSJCOM),($G(PSJWON)["P") Q:$D(^PS(53.1,"ACX",PSJCOM,+ON))
"RTN","PSJBLDOC",59,0)
 . I $O(^PS(53.1,+ON,"AD",0))!$O(^PS(53.1,+ON,"SOL",0)) S PSJCLCOD=3 D PIV Q
"RTN","PSJBLDOC",60,0)
 . S PSJCLCOD=4
"RTN","PSJBLDOC",61,0)
 . I $$GET1^DIQ(53.1,+ON,4,"I")="I" S PSJCLCOD=5
"RTN","PSJBLDOC",62,0)
 . D UD
"RTN","PSJBLDOC",63,0)
 S WBDT=BDT F  S WBDT=$O(^PS(55,DFN,"IV","AIS",WBDT)) Q:'WBDT  F ON=0:0 S ON=$O(^PS(55,DFN,"IV","AIS",WBDT,ON)) Q:'ON  I '$D(^TMP($J,"PSJPRE","CLINIC",ON)) S COD=ON_"V" S PSJCLCOD=1 D:COD'=PSJWON IV
"RTN","PSJBLDOC",64,0)
 K PSJWON
"RTN","PSJBLDOC",65,0)
 Q
"RTN","PSJBLDOC",66,0)
UD ;Get the dispense drugs for the Unit Dose orders.
"RTN","PSJBLDOC",67,0)
 NEW X,PSJQUIT,PSJCNT,DDRUG,DDRUGN,PSJX,PSJOI,PSJEXPDD,PSJUTMP,PSJEDOVR,PSJCLNX,PSJCLDAT,PSJCLDAY,PSJSTOP
"RTN","PSJBLDOC",68,0)
 S X=@(F_ON_",0)")
"RTN","PSJBLDOC",69,0)
 Q:$P(X,U,9)="R"
"RTN","PSJBLDOC",70,0)
 S (PSJEDOVR,PSJCLINF,PSJCLNX,PSJCLDAY,PSJSTOP)=0,PSJCLDAT="",PSJCLNX=$P(X,U,9)
"RTN","PSJBLDOC",71,0)
 I $D(^TMP($J,"PSJPRE","CLINIC",+ON,$S(PSJCLCOD=5:"531I",PSJCLCOD=2:"55U",1:"531U"))) S PSJCLINF=1
"RTN","PSJBLDOC",72,0)
 I PSJCLCOD=4!(PSJCLCOD=5) Q:PSJCLINF&($P(X,U,9)'="P"&($P(X,U,9)'="N"))
"RTN","PSJBLDOC",73,0)
 Q:$P($G(PTYP),";",1)="O"&('$G(PSJCLINF))
"RTN","PSJBLDOC",74,0)
 Q:$P(X,U,9)["D"&('PSJCLINF)
"RTN","PSJBLDOC",75,0)
 Q:$P(X,U,9)="E"&('PSJCLINF)
"RTN","PSJBLDOC",76,0)
 S PSJORIEN=$P(X,U,21),DDRUG=0
"RTN","PSJBLDOC",77,0)
 ;
"RTN","PSJBLDOC",78,0)
 ;Use the first active DD within the order. If >1 DD, use OI_Dosage form for display name
"RTN","PSJBLDOC",79,0)
 S ON1=0,PSJCNT=0 F  S ON1=$O(@(F_ON_",1,"_ON1_")")) Q:'ON1  S PSJCNT=PSJCNT+1
"RTN","PSJBLDOC",80,0)
 S PSJOI=+$G(@(F_ON_",.2)"))
"RTN","PSJBLDOC",81,0)
 S ON1=0,PSJQUIT=0 F  S ON1=$O(@(F_ON_",1,"_ON1_")")) Q:'+ON1!PSJQUIT  S DDRUG=@(F_ON_",1,"_ON1_",0)") D
"RTN","PSJBLDOC",82,0)
 . Q:'+DDRUG
"RTN","PSJBLDOC",83,0)
 . S PSJX=$P(DDRUG,U,3)
"RTN","PSJBLDOC",84,0)
 . I 'PSJCLINF,PSJX]"",(PSJX'>BDT) Q
"RTN","PSJBLDOC",85,0)
 . D SETIN("PROFILE",$S(PSJCNT>1:$$OIDF^PSJLMUT1(+$G(PSJOI)),1:$P($G(^PSDRUG(DDRUG,0)),U)),+DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF) S PSJQUIT=1
"RTN","PSJBLDOC",86,0)
 ;Quit when an active DD within the order if found
"RTN","PSJBLDOC",87,0)
 Q:+$G(PSJQUIT)
"RTN","PSJBLDOC",88,0)
 ;
"RTN","PSJBLDOC",89,0)
 ;No DD found from the order. Get one from the OI
"RTN","PSJBLDOC",90,0)
 I '+PSJOI D SETIN("PROFILE","NOT FOUND: "_COD,"",COD,1,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",91,0)
 S DDRUG=$P($$DRG^PSSDSAPM(+PSJOI,"I"),U)
"RTN","PSJBLDOC",92,0)
 I +DDRUG D SETIN("PROFILE",$S(PSJCNT>1:$$OIDF^PSJLMUT1(+$G(PSJOI)),1:$P($G(^PSDRUG(DDRUG,0)),U)),+DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",93,0)
 ;
"RTN","PSJBLDOC",94,0)
 ;Get the first DD from OI (CCR5665 - set exception if pending order has no DD assigned and none is active. PSJ*5*252 t9)
"RTN","PSJBLDOC",95,0)
 I ($G(COD)'["P"),('+DDRUG) S DDRUG=$O(^PSDRUG("ASP",PSJOI,0)) I +DDRUG D SETIN("PROFILE",$S(PSJCNT>1:$$OIDF^PSJLMUT1(+$G(PSJOI)),1:$P($G(^PSDRUG(DDRUG,0)),U)),+DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",96,0)
 ;
"RTN","PSJBLDOC",97,0)
 ;Set exception when no DD found
"RTN","PSJBLDOC",98,0)
 I '+DDRUG D SETIN("PROFILE",$$OIDF^PSJLMUT1(+$G(PSJOI)),"",COD,1,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",99,0)
 Q
"RTN","PSJBLDOC",100,0)
PIV ;Get the dispense drugs for the Pending IV orders.
"RTN","PSJBLDOC",101,0)
 NEW PSJ0,PSJX,DDRUG,PSJNM,PSJCLNTY,PSJDDNM
"RTN","PSJBLDOC",102,0)
 S PSJX=^PS(53.1,+ON,0),PSJORIEN=$P(PSJX,U,21) Q:$P(PSJX,U,27)="R"
"RTN","PSJBLDOC",103,0)
 S (PSJEDOVR,PSJCLINF,PSJCLNTY)=0,PSJCLNTY=$$GET1^DIQ(53.1,+ON,4,"I")
"RTN","PSJBLDOC",104,0)
 S:$D(^TMP($J,"PSJPRE","CLINIC",+ON,531_PSJCLNTY)) PSJCLINF=1
"RTN","PSJBLDOC",105,0)
 Q:$P($G(PTYP),";",1)="O"&('$G(PSJCLINF))
"RTN","PSJBLDOC",106,0)
 S ON1=0 F  S ON1=$O(^PS(53.1,+ON,"AD",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",107,0)
 . S PSJX=^PS(53.1,+ON,"AD",ON1,0),PSJ0=$$IV0("AD",+PSJX)
"RTN","PSJBLDOC",108,0)
 . S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",109,0)
 . I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",110,0)
 . D SETIN("PROFILE",$P(PSJ0,U)_" "_$P(PSJX,U,2),$P(PSJ0,U,2),COD,PTYP,PSJCLCOD,PSJCLINF)
"RTN","PSJBLDOC",111,0)
 S ON1=0 F  S ON1=$O(^PS(53.1,+ON,"SOL",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",112,0)
 . S PSJX=^PS(53.1,+ON,"SOL",ON1,0)
"RTN","PSJBLDOC",113,0)
 . S PSJ0=$$IV0("",+PSJX)
"RTN","PSJBLDOC",114,0)
 . S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",115,0)
 . I $$PREMIX^PSJMISC(+PSJX) D  Q
"RTN","PSJBLDOC",116,0)
 .. I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",117,0)
 .. D SETIN("PROFILE",$P(PSJ0,U)_" "_$P(PSJX,U,2),$P(PSJ0,U,2),COD,PTYP,PSJCLCOD,PSJCLINF)
"RTN","PSJBLDOC",118,0)
 . ;Do allergy check for non-premix as well
"RTN","PSJBLDOC",119,0)
 . I $G(PSJDGCK) D
"RTN","PSJBLDOC",120,0)
 .. S PSJDDNM=$P($G(^PSDRUG(+DDRUG,0)),U)
"RTN","PSJBLDOC",121,0)
 .. S:$G(PSJDDNM)]"" PSJALLGY("Z",PSJDDNM,DDRUG)=""
"RTN","PSJBLDOC",122,0)
 Q
"RTN","PSJBLDOC",123,0)
IV ;Get the dispense drugs for the IV orders.
"RTN","PSJBLDOC",124,0)
 NEW PSJ0,PSJX,DDRUG,PSJNM,PSJCLNX,PSJSTOP,PSJDDNM
"RTN","PSJBLDOC",125,0)
 S PSJX=^PS(55,DFN,"IV",ON,0),PSJORIEN=$P(PSJX,U,21),(PSJCLINF,PSJCLNX)=0,PSJCLNX=$P(PSJX,U,17)
"RTN","PSJBLDOC",126,0)
 Q:$P(PSJX,U,17)="R"
"RTN","PSJBLDOC",127,0)
 I $D(^TMP($J,"PSJPRE","CLINIC",+ON,"55I")) S PSJCLINF=1
"RTN","PSJBLDOC",128,0)
 I PSJCLCOD=4!(PSJCLCOD=5) Q:PSJCLINF&($P(PSJX,U,17)'="P"&($P(PSJX,U,17)'="N"))
"RTN","PSJBLDOC",129,0)
 Q:$P($G(PTYP),";",1)="O"&('$G(PSJCLINF))
"RTN","PSJBLDOC",130,0)
 Q:$P(PSJX,U,17)["D"&('PSJCLINF)
"RTN","PSJBLDOC",131,0)
 Q:$P(PSJX,U,17)="E"&('PSJCLINF)
"RTN","PSJBLDOC",132,0)
 S ON1=0 F  S ON1=$O(^PS(55,DFN,"IV",ON,"AD",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",133,0)
 . S PSJX=^PS(55,DFN,"IV",ON,"AD",ON1,0),PSJ0=$$IV0("AD",+PSJX)
"RTN","PSJBLDOC",134,0)
 . S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",135,0)
 . I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",136,0)
 . D SETIN("PROFILE",PSJNM,DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF)
"RTN","PSJBLDOC",137,0)
 ; Only include Pre-mix in the OC.
"RTN","PSJBLDOC",138,0)
 S ON1=0 F  S ON1=$O(^PS(55,DFN,"IV",ON,"SOL",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",139,0)
 . S PSJX=^PS(55,DFN,"IV",ON,"SOL",ON1,0)
"RTN","PSJBLDOC",140,0)
 . S PSJ0=$$IV0("",+PSJX)
"RTN","PSJBLDOC",141,0)
 . S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",142,0)
 . I $$PREMIX^PSJMISC(+PSJX) D  Q
"RTN","PSJBLDOC",143,0)
 .. I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",144,0)
 .. D SETIN("PROFILE",PSJNM,DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF)
"RTN","PSJBLDOC",145,0)
 . ;Do allergy check for non-premix as well
"RTN","PSJBLDOC",146,0)
 . I $G(PSJDGCK) D
"RTN","PSJBLDOC",147,0)
 .. S PSJDDNM=$P($G(^PSDRUG(+DDRUG,0)),U)
"RTN","PSJBLDOC",148,0)
 .. S:$G(PSJDDNM)]"" PSJALLGY("Z",PSJDDNM,DDRUG)=""
"RTN","PSJBLDOC",149,0)
 Q
"RTN","PSJBLDOC",150,0)
SETIN(PSJFLG,PSJNM,DDRUG,ON,PSJCODE,PSJCLCOD,PSJCLINF) ;Set ^TMP($J,"PSJPRE,"IN" arrays.
"RTN","PSJBLDOC",151,0)
 ;ON = ON with "U/V/P"
"RTN","PSJBLDOC",152,0)
 ;PSJFLG = "PROSPECTIVE" or "PROFILE"
"RTN","PSJBLDOC",153,0)
 ;PSJNM = This should be the AD/SOL print name or IV order.  Use Dispense drug name if U/D order
"RTN","PSJBLDOC",154,0)
 ;PSJPON = 4 piece pharmacy order #
"RTN","PSJBLDOC",155,0)
 NEW PSJPON
"RTN","PSJBLDOC",156,0)
 Q:$G(PSJFLG)=""
"RTN","PSJBLDOC",157,0)
 ;S:$G(PSJDGCK) PSJFLG="PROSPECTIVE" ;when using CK hidden action
"RTN","PSJBLDOC",158,0)
 S PSJONCNT=$G(PSJONCNT)+1
"RTN","PSJBLDOC",159,0)
 S PSJPON=$S(PSJCLINF:"C"_PSJCLCOD_";",1:"I;")_ON_";"_PSJFLG_";"_PSJONCNT
"RTN","PSJBLDOC",160,0)
 I $P(PSJCODE,";")="O" S PSJPON="C"_PSJCLCOD_";"_+ON_";"_PSJFLG_";"_PSJONCNT
"RTN","PSJBLDOC",161,0)
 I '+$G(DDRUG) D  Q
"RTN","PSJBLDOC",162,0)
 . I +$G(PSJCODE) D NODD($G(PSJCODE),PSJNM,PSJPON,LIST)
"RTN","PSJBLDOC",163,0)
 Q:$$SUP^PSSDSAPI(+DDRUG)
"RTN","PSJBLDOC",164,0)
 I $G(PSJNM)="" S PSJNM=$P($G(^PSDRUG(+DDRUG,0)),U)
"RTN","PSJBLDOC",165,0)
 S PSJFLG=$S($G(PSJDGCK):"PROSPECTIVE",1:"PROFILE") ;when using CK hidden action
"RTN","PSJBLDOC",166,0)
 S ^TMP($J,LIST,"IN",PSJFLG,PSJPON)=+$$GCN^PSJMISC(+DDRUG)_U_$$GTVUID^PSJMISC(+DDRUG)_U_+DDRUG_U_PSJNM_U_$G(PSJORIEN)_U_"I"_U_PSJCLCOD_";"_PSJCLINF
"RTN","PSJBLDOC",167,0)
 Q
"RTN","PSJBLDOC",168,0)
IV0(PSJAD,PSIVIEN) ;Return ad/sol zero node
"RTN","PSJBLDOC",169,0)
 ;PSJAD = "AD" is passed in if it additive, otherwise it's null
"RTN","PSJBLDOC",170,0)
 I PSJAD="AD" Q $G(^PS(52.6,+$G(PSIVIEN),0))
"RTN","PSJBLDOC",171,0)
 I $G(PSJAD)="" Q $G(^PS(52.7,+$G(PSIVIEN),0))
"RTN","PSJBLDOC",172,0)
 Q ""
"RTN","PSJBLDOC",173,0)
NODD(PSJCODE,PSJOIDF,PSJPON,PSJBASE) ;Set ^TMP for OI without a dispense drug
"RTN","PSJBLDOC",174,0)
 ;PSJCODE - A numeric code to trigger the appropriate exception message 
"RTN","PSJBLDOC",175,0)
 ;PSJOIDF - Orderable Item name_Dose form (can be CPRS OI)
"RTN","PSJBLDOC",176,0)
 ;PSJPON - Pharmacy order #
"RTN","PSJBLDOC",177,0)
 ;PSJBASE - Base subscript
"RTN","PSJBLDOC",178,0)
 Q:$G(PSJOIDF)=""
"RTN","PSJBLDOC",179,0)
 Q:$G(PSJBASE)=""
"RTN","PSJBLDOC",180,0)
 Q:'+$G(PSJCODE)
"RTN","PSJBLDOC",181,0)
 ;S PSJIV("OI_ERROR",PSJOIDF)=$G(PSJCODE)_U_$G(PSJPON)
"RTN","PSJBLDOC",182,0)
 S ^TMP($J,PSJBASE,"IN","EXCEPTIONS","OI",PSJOIDF)=PSJCODE_U_$G(PSJPON)
"RTN","PSJBLDOC",183,0)
 Q
"RTN","PSJDGAL")
1^11
"RTN","PSJGMRA")
0^9^B19012302
"RTN","PSJGMRA",1,0)
PSJGMRA ;BIR/MV - Retrieve and display Allergy data ;6 Jun 07  3:37 PM
"RTN","PSJGMRA",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**181,270,260,252,257,281,347**;16 DEC 97;Build 6
"RTN","PSJGMRA",3,0)
 ;
"RTN","PSJGMRA",4,0)
 ; Reference to ^PS(50.605 is supported by DBIA 696.
"RTN","PSJGMRA",5,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192.
"RTN","PSJGMRA",6,0)
 ; Reference to ^PSODGAL1 supported by DBIA 5764.
"RTN","PSJGMRA",7,0)
 ; Reference to ^PS(50.7 supported by DBIA 2180.
"RTN","PSJGMRA",8,0)
 ; Reference to ^PS(55 supported by DBIA #2191.
"RTN","PSJGMRA",9,0)
 ;
"RTN","PSJGMRA",10,0)
EN(DFN,PSJDD) ;
"RTN","PSJGMRA",11,0)
 ;DFN - Patient IEN
"RTN","PSJGMRA",12,0)
 ;PSJDD - ^PSDRUG IEN
"RTN","PSJGMRA",13,0)
 Q:'+$G(DFN)
"RTN","PSJGMRA",14,0)
 Q:'+$G(PSJDD)
"RTN","PSJGMRA",15,0)
 ;N PTR,GMRAING,PSJACK,PSJCLCNT,PSJFLG,PSJVACL,DIW,DIWF,DIWI,DIWL,DIWR,DIWT,DIWTC,DIWX,PSJNEW,X,Y,PSODRUG,PSODFN,PSJAOC
"RTN","PSJGMRA",16,0)
 N DIW,DIWF,DIWI,DIWL,DIWR,DIWT,DIWTC,DIWX,X,Y,PSODRUG,PSODFN,PSJAOC
"RTN","PSJGMRA",17,0)
 ;*347
"RTN","PSJGMRA",18,0)
 ;K DIC,PSJVACL,^TMP("GMRAOC",$J),^TMP($J,"PSJCLS"),^TMP("PSJDAI",$J)
"RTN","PSJGMRA",19,0)
 K DIC,^TMP($J,"PSJCLS"),^TMP("PSJDAI",$J)
"RTN","PSJGMRA",20,0)
 S DIC=50,DIC(0)="MQZV",X=PSJDD D ^DIC K DIC Q:Y=-1
"RTN","PSJGMRA",21,0)
 S PSODRUG("IEN")=PSJDD,PSODRUG("VA CLASS")=$P(Y(0),"^",2),PSODRUG("NAME")=$P(Y(0),"^")
"RTN","PSJGMRA",22,0)
 S:+$G(^PSDRUG(+Y,2)) PSODRUG("OI")=+$G(^(2)),PSODRUG("OIN")=$P(^PS(50.7,+$G(^(2)),0),"^")
"RTN","PSJGMRA",23,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(PSJDD,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSJGMRA",24,0)
 ;changed in psj*5*260
"RTN","PSJGMRA",25,0)
 S PSJAOC=1,PSODFN=DFN D ^PSODGAL1
"RTN","PSJGMRA",26,0)
 S:$G(PSGORQF) VALMBCK="R"
"RTN","PSJGMRA",27,0)
 ;*347
"RTN","PSJGMRA",28,0)
 ;K ^TMP("GMRAOC",$J),^TMP($J,"PSJCLS")
"RTN","PSJGMRA",29,0)
 K ^TMP($J,"PSJCLS")
"RTN","PSJGMRA",30,0)
 Q
"RTN","PSJGMRA",31,0)
INTERV(PSJRXREQ,PSJDD1) ;Prompt if user to log an intervention for significant interaction
"RTN","PSJGMRA",32,0)
 ;PSPRXREQ - intervention type
"RTN","PSJGMRA",33,0)
 ;PSJDD1 - Prospective drug name
"RTN","PSJGMRA",34,0)
 NEW DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y,X
"RTN","PSJGMRA",35,0)
 I $G(PSGORQF)=1 Q
"RTN","PSJGMRA",36,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Intervene? ",DIR("B")=$S($G(PSJRXREQ)="ALLERGY":"YES",1:"NO")
"RTN","PSJGMRA",37,0)
 I $G(PSJDD1)]"" S DIR("A")="Do you want to Intervene with "_PSJDD1_"? "
"RTN","PSJGMRA",38,0)
 W ! D ^DIR
"RTN","PSJGMRA",39,0)
 S DIR("?",1)="Answer 'YES' if you DO want to enter an intervention for this medication,"
"RTN","PSJGMRA",40,0)
 S DIR("?")="       'NO' if you DON'T want to enter an intervention for this medication,"
"RTN","PSJGMRA",41,0)
 I Y S PSGP=DFN D ^PSJRXI W !
"RTN","PSJGMRA",42,0)
 Q 
"RTN","PSJGMRA",43,0)
RINTERV(PSJRXREQ,PSJDD1) ;Prompt user to log an intervention for critical interaction
"RTN","PSJGMRA",44,0)
 ;PSPRXREQ - intervention type
"RTN","PSJGMRA",45,0)
 ;PSJDD1 - Prospective drug name
"RTN","PSJGMRA",46,0)
 NEW DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y,X
"RTN","PSJGMRA",47,0)
 K PSGORQF
"RTN","PSJGMRA",48,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Continue? ",DIR("B")="NO"
"RTN","PSJGMRA",49,0)
 I $G(PSJDD1)]"" S DIR("A")="Do you want to Continue with "_PSJDD1_"? "
"RTN","PSJGMRA",50,0)
 S DIR("?",1)="Enter 'NO' if you wish to exit without continuing with the order,",DIR("?")="or 'YES' to continue with the order entry process."
"RTN","PSJGMRA",51,0)
 D ^DIR
"RTN","PSJGMRA",52,0)
 I 'Y S PSGORQF=1 S VALMBCK="R" Q
"RTN","PSJGMRA",53,0)
 I Y S PSGP=DFN D ^PSJRXI W !
"RTN","PSJGMRA",54,0)
 Q
"RTN","PSJGMRA",55,0)
 ;
"RTN","PSJGMRA",56,0)
INST(PSJALCO) ;Find Institution for order
"RTN","PSJGMRA",57,0)
 N PSJALCR,PSJALCMC,PSJALCCL,PSJALCWA,PSJALCIV,PSJALCIN,PSJALCND,PSJALCP1,PSJALCP2
"RTN","PSJGMRA",58,0)
 I PSJALCO="" Q +$$SITE^VASITE(DT)
"RTN","PSJGMRA",59,0)
 S PSJALCR=""
"RTN","PSJGMRA",60,0)
 ;
"RTN","PSJGMRA",61,0)
 I PSJALCO["P" D  G INSTM
"RTN","PSJGMRA",62,0)
 .S PSJALCCL=$P($G(^PS(53.1,+PSJALCO,"DSS")),"^") I PSJALCCL S PSJALCND=$G(^SC(PSJALCCL,0)) D  Q
"RTN","PSJGMRA",63,0)
 ..S PSJALCIN=$P(PSJALCND,"^",4) I PSJALCIN S PSJALCR=PSJALCIN Q
"RTN","PSJGMRA",64,0)
 ..S PSJALCMC=$P(PSJALCND,"^",15)
"RTN","PSJGMRA",65,0)
 .S PSJALCIV=$P($G(^PS(53.1,+PSJALCO,8)),"^",8) I PSJALCIV D  Q
"RTN","PSJGMRA",66,0)
 ..S PSJALCMC=$P($G(^PS(59.5,+PSJALCIV,0)),"^",4) Q
"RTN","PSJGMRA",67,0)
 .D INSTW
"RTN","PSJGMRA",68,0)
 ;
"RTN","PSJGMRA",69,0)
 I PSJALCO["U" S PSJALCP1=$P(PSJALCO,"U"),PSJALCP2=$P(PSJALCO,"U",2) D  G INSTM
"RTN","PSJGMRA",70,0)
 .S PSJALCCL=$P($G(^PS(55,PSJALCP1,5,PSJALCP2,8)),"^") I PSJALCCL S PSJALCND=$G(^SC(PSJALCCL,0)) D  Q
"RTN","PSJGMRA",71,0)
 ..S PSJALCIN=$P(PSJALCND,"^",4) I PSJALCIN S PSJALCR=PSJALCIN Q
"RTN","PSJGMRA",72,0)
 ..S PSJALCMC=$P(PSJALCND,"^",15)
"RTN","PSJGMRA",73,0)
 .D INSTW
"RTN","PSJGMRA",74,0)
 ;
"RTN","PSJGMRA",75,0)
 I PSJALCO["V" S PSJALCP1=$P(PSJALCO,"V"),PSJALCP2=$P(PSJALCO,"V",2) D  G INSTM
"RTN","PSJGMRA",76,0)
 .S PSJALCCL=$P($G(^PS(55,PSJALCP1,"IV",PSJALCP2,"DSS")),"^") I PSJALCCL S PSJALCND=$G(^SC(PSJALCCL,0)) D  Q
"RTN","PSJGMRA",77,0)
 ..S PSJALCIN=$P(PSJALCND,"^",4) I PSJALCIN S PSJALCR=PSJALCIN Q
"RTN","PSJGMRA",78,0)
 ..S PSJALCMC=$P(PSJALCND,"^",15)
"RTN","PSJGMRA",79,0)
 .S PSJALCIV=$P($G(^PS(55,PSJALCP1,"IV",PSJALCP2,2)),"^",2) I PSJALCIV D  Q
"RTN","PSJGMRA",80,0)
 ..S PSJALCMC=$P($G(^PS(59.5,+PSJALCIV,0)),"^",4) Q
"RTN","PSJGMRA",81,0)
 .D INSTW
"RTN","PSJGMRA",82,0)
 ;
"RTN","PSJGMRA",83,0)
 Q +$$SITE^VASITE(DT)
"RTN","PSJGMRA",84,0)
INSTM ;
"RTN","PSJGMRA",85,0)
 I PSJALCR Q PSJALCR
"RTN","PSJGMRA",86,0)
 I $G(PSJALCMC) Q +$$SITE^VASITE(DT,PSJALCMC)
"RTN","PSJGMRA",87,0)
 Q +$$SITE^VASITE(DT)
"RTN","PSJGMRA",88,0)
 ;
"RTN","PSJGMRA",89,0)
INSTW ;
"RTN","PSJGMRA",90,0)
 S PSJALCWA=$$INSTV I PSJALCWA D
"RTN","PSJGMRA",91,0)
 .S PSJALCCL=$P($G(^DIC(42,+PSJALCWA,44)),"^") I PSJALCCL D  Q:PSJALCR
"RTN","PSJGMRA",92,0)
 ..S PSJALCND=$G(^SC(PSJALCCL,0)) S PSJALCIN=$P(PSJALCND,"^",4) I PSJALCIN S PSJALCR=PSJALCIN Q
"RTN","PSJGMRA",93,0)
 ..S PSJALCMC=$P(PSJALCND,"^",15)
"RTN","PSJGMRA",94,0)
 .I '$G(PSJALCMC) S PSJALCMC=$P($G(^DIC(42,+PSJALCWA,0)),"^",11)
"RTN","PSJGMRA",95,0)
 Q
"RTN","PSJGMRA",96,0)
 ;
"RTN","PSJGMRA",97,0)
INSTV() ;Retrieve Ward
"RTN","PSJGMRA",98,0)
 I '$G(DFN) Q 0
"RTN","PSJGMRA",99,0)
 N VAHOW,VAROOT,VAINDT,VAIN,VAERR
"RTN","PSJGMRA",100,0)
 D INP^VADPT
"RTN","PSJGMRA",101,0)
 Q +$G(VAIN(4))
"RTN","PSJLIACT")
0^15^B59558968
"RTN","PSJLIACT",1,0)
PSJLIACT ;BIR/MV - IV ACTION ;28 Jul 98  8:50 AM
"RTN","PSJLIACT",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**15,47,62,58,82,97,80,110,111,134,181,247,260,275,257,299,281,346,256,347**;16 DEC 97;Build 6
"RTN","PSJLIACT",3,0)
 ;
"RTN","PSJLIACT",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJLIACT",5,0)
 ; Reference to MAIN^TIUEDIT is supported by DBIA 2410.
"RTN","PSJLIACT",6,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071.
"RTN","PSJLIACT",7,0)
 ;
"RTN","PSJLIACT",8,0)
DC ; Discontinue order
"RTN","PSJLIACT",9,0)
 K PSGORQF
"RTN","PSJLIACT",10,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",11,0)
 S PSJCOM=+$S(PSJORD["V":$P($G(^PS(55,DFN,"IV",+PSJORD,.2)),"^",8),1:$P($G(^PS(53.1,+PSJORD,.2)),"^",8))
"RTN","PSJLIACT",12,0)
 I PSJCOM W !!,"This order is part of a complex order. If you discontinue this order the",!,"following orders will be discontinued too (unless the stop date has already",!,"been reached)." D CMPLX^PSJCOM1(PSGP,PSJCOM,PSJORD)
"RTN","PSJLIACT",13,0)
 I PSJCOM F  W !!,"Do you want to discontinue this order" S %=1 D YN^DICN Q:%  D ENCOM^PSGOEM
"RTN","PSJLIACT",14,0)
 I PSJCOM,%'=1 S VALMBK="" Q
"RTN","PSJLIACT",15,0)
 I $G(ON55)["P",$G(PSIVOORD) S PSJORD=ON55 ;*247 - Correct DCing newly copied orders
"RTN","PSJLIACT",16,0)
 I PSJORD["V" D DC^PSIVORA D:'$G(PSJOCFLG) EN^PSJLIORD(DFN,ON) Q
"RTN","PSJLIACT",17,0)
 I PSJORD["P" N ON S ON=PSJORD D DISCONT^PSIVORC
"RTN","PSJLIACT",18,0)
 S VALMBCK="Q"
"RTN","PSJLIACT",19,0)
 Q
"RTN","PSJLIACT",20,0)
ACEDIT ; Display LM screen and AC and EDit actions
"RTN","PSJLIACT",21,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",22,0)
 S VALMBCK=$S($G(PSIVACEP):"Q",1:"R")
"RTN","PSJLIACT",23,0)
 Q
"RTN","PSJLIACT",24,0)
AEEXIT ; Call for EXIT CODE in PSJ LM IV AC/EDIT
"RTN","PSJLIACT",25,0)
 I ON["V" K PSGORQF D GT55^PSIVORFB ;RTC 340818
"RTN","PSJLIACT",26,0)
 I ON["P" D GT531^PSIVORFA(DFN,ON) D:P("OT")'="I" GTDATA^PSJLIFN
"RTN","PSJLIACT",27,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",28,0)
 K PSIVENO
"RTN","PSJLIACT",29,0)
 Q
"RTN","PSJLIACT",30,0)
EDIT ; Edit order
"RTN","PSJLIACT",31,0)
 K PSIVFN1
"RTN","PSJLIACT",32,0)
 I $D(PSGACT),PSGACT'["E" W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJLIACT",33,0)
 D EDIT1
"RTN","PSJLIACT",34,0)
 Q:$D(PSIVNBD)!($G(PSIVCOPY)&'$G(PSIVENO))
"RTN","PSJLIACT",35,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",36,0)
 S VALMBCK=$S($G(PSIVFN1):"Q",1:"R")
"RTN","PSJLIACT",37,0)
 S PSJEDFLG=1 ;PSJ*346  Prevent double order display
"RTN","PSJLIACT",38,0)
 I $G(PSGORQF) S VALMBCK="Q" K PSIVENO,PSJOCCHK ;RTC 340818
"RTN","PSJLIACT",39,0)
 Q
"RTN","PSJLIACT",40,0)
EDIT1 ;
"RTN","PSJLIACT",41,0)
 K PSGORQF ;RTC 340818
"RTN","PSJLIACT",42,0)
 ;Ensure P() is defined
"RTN","PSJLIACT",43,0)
 I $D(P)<10 S XQORQUIT=1,P("PON")="",PSIVNBD=1 D  Q
"RTN","PSJLIACT",44,0)
 .W !,"WARNING: An error has occurred. Changes will not be saved"
"RTN","PSJLIACT",45,0)
 .D PAUSE^VALM1
"RTN","PSJLIACT",46,0)
 .S VALMBCK="Q"
"RTN","PSJLIACT",47,0)
 I "ANP"'[P(17) W !,"You cannot edit an inactive order" D PAUSE^VALM1 Q
"RTN","PSJLIACT",48,0)
 S:$G(ON55)="" ON55=$G(PSJORD)
"RTN","PSJLIACT",49,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",50,0)
 N PSIEDITO S PSIEDITO=1
"RTN","PSJLIACT",51,0)
 ;* Edit a new back door order
"RTN","PSJLIACT",52,0)
 I ($G(ON55)["V"&($G(P("21FLG"))="")) D  Q
"RTN","PSJLIACT",53,0)
 . D GSTRING^PSIVORE1,GTFLDS^PSIVORFE
"RTN","PSJLIACT",54,0)
 . I $G(ON55)["V",'$G(DONE) D OK^PSIVORE
"RTN","PSJLIACT",55,0)
 . S VALMBCK="Q",PSIVNBD=1
"RTN","PSJLIACT",56,0)
 ;* Edit an active order
"RTN","PSJLIACT",57,0)
 I $G(ON55)["V" NEW PSJEDIT1 D E^PSIVOPT1 D  Q
"RTN","PSJLIACT",58,0)
 . I $G(PSJIVBD) K PSJIVBD D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",59,0)
 . I $G(PSGORQF) K PSIVENO,PSJOCCHK ;RTC 340818
"RTN","PSJLIACT",60,0)
 I $G(ON55)["P" D EDIT^PSIVORC ;Edit incomplete order.
"RTN","PSJLIACT",61,0)
 K P("OVRIDE")
"RTN","PSJLIACT",62,0)
 Q
"RTN","PSJLIACT",63,0)
ACCEPT ; Accept order
"RTN","PSJLIACT",64,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",65,0)
 ;Accept IV from back door.
"RTN","PSJLIACT",66,0)
 I $G(PSJIVBD) K PSJIVBD D OK^PSIVORE S VALMBCK="Q" Q
"RTN","PSJLIACT",67,0)
 ;D:'$G(PSGORQF) IN^PSJOCDS($G(ON),"IV","") Q:$G(PSGORQF)
"RTN","PSJLIACT",68,0)
 I ON["V" D ACCEPT^PSIVOPT1 S:'$G(PSGORQF) PSJDSVFY=1 Q
"RTN","PSJLIACT",69,0)
 S PSIVFN1=1
"RTN","PSJLIACT",70,0)
 D COMPLTE^PSIVORC1
"RTN","PSJLIACT",71,0)
 K ^TMP("PSODAOC",$J)
"RTN","PSJLIACT",72,0)
 S VALMBCK="Q"
"RTN","PSJLIACT",73,0)
 Q
"RTN","PSJLIACT",74,0)
R ; Renewal
"RTN","PSJLIACT",75,0)
 K PSGORQF,PSJOCCHK,PSIVENO
"RTN","PSJLIACT",76,0)
 S PSJREN=1
"RTN","PSJLIACT",77,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",78,0)
 NEW PSIVAC,PSJOLDNM S PSIVAC="PR" K PSGFDX
"RTN","PSJLIACT",79,0)
 S PSJOLDNM("ORD_SCHD")=$P($G(^PS(55,DFN,"IV",+ON,0)),U,9)
"RTN","PSJLIACT",80,0)
 I PSJOLDNM("ORD_SCHD")]"",$$CHKSCHD^PSJMISC2(.PSJOLDNM,"R") K PSJOLDNM Q
"RTN","PSJLIACT",81,0)
 K PSJOLDNM
"RTN","PSJLIACT",82,0)
 D R^PSIVOPT
"RTN","PSJLIACT",83,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",84,0)
 K PSJREN,^TMP("PSODAOC",$J)
"RTN","PSJLIACT",85,0)
 Q
"RTN","PSJLIACT",86,0)
H ; Hold
"RTN","PSJLIACT",87,0)
 K PSGORQF
"RTN","PSJLIACT",88,0)
 NEW TEX S TEX="Active order ***"
"RTN","PSJLIACT",89,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",90,0)
 D H^PSIVOPT(DFN,ON,P(17),P(3))
"RTN","PSJLIACT",91,0)
 D:P(17)="A" PAUSE^VALM1
"RTN","PSJLIACT",92,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",93,0)
 Q
"RTN","PSJLIACT",94,0)
L ; Activity Log
"RTN","PSJLIACT",95,0)
 NEW PSIVLAB,PSIVLOG,PSJHIS S (PSIVLAB,PSIVLOG)=1
"RTN","PSJLIACT",96,0)
 D EN^PSIVVW1
"RTN","PSJLIACT",97,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",98,0)
 S VALMBCK="R"
"RTN","PSJLIACT",99,0)
 Q
"RTN","PSJLIACT",100,0)
O ; On Call
"RTN","PSJLIACT",101,0)
 K PSGORQF
"RTN","PSJLIACT",102,0)
 NEW TEX S TEX="Active order ***"
"RTN","PSJLIACT",103,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",104,0)
 D O^PSIVOPT(DFN,ON,P(17),P(3))
"RTN","PSJLIACT",105,0)
 D:P(17)="A" PAUSE^VALM1
"RTN","PSJLIACT",106,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",107,0)
 Q
"RTN","PSJLIACT",108,0)
VF ; Make the order active **ENHANCEMENTS MADE IN PSJ*5.0*260
"RTN","PSJLIACT",109,0)
 NEW PSIVCHG,PSGORQF,PSJVFF,PSJOLDNM S PSIVCHG=0
"RTN","PSJLIACT",110,0)
 ;PSJ*5*256 - inform user of old schedule name and quit
"RTN","PSJLIACT",111,0)
 I $S((ON["P"):$P($G(^PS(53.1,+ON,0)),U,24)'="R",(ON["V"):$P($G(^PS(55,+PSGP,"IV",+ON,2)),U,8)'="R",1:0) D  Q:$G(PSGORQF)
"RTN","PSJLIACT",112,0)
 .D FULL^VALM1
"RTN","PSJLIACT",113,0)
 .S PSJOLDNM("ORD_SCHD")=$G(PSGSCH)
"RTN","PSJLIACT",114,0)
 .S PSGORQF=$$CHKSCHD^PSJMISC2(.PSJOLDNM,"V")
"RTN","PSJLIACT",115,0)
 ;IF VALM("TITLE")="ACTIVE IV " W !!,">>>  Verify may not be selected at this point." D PAUSE^VALM1 S VALMBCK="R" Q  ;PSJ*5*281 CCR 6995 Remedy ticket 861870
"RTN","PSJLIACT",116,0)
 ;ELSE  IF $G(PSGSTAT)="NON-VERIFIED",$G(PSJNEWOE)=0 S PSJVFF=1 D EN^PSJGMRA($G(DFN),$G(PSGPD)),IN^PSJOCDS($G(PSGORD),"IV",""),OC^PSIVOC K PSJVFF Q:$G(PSGORQF)
"RTN","PSJLIACT",117,0)
 ;PSGSTAT may not set for IV orders. Checking PSJOCFG so DI,DT is not displayed again for FN, CO, RN...
"RTN","PSJLIACT",118,0)
 IF (($G(PSGSTAT)="NON-VERIFIED")!($G(P(17))="N")&($G(PSJOCFG)="")),'+$G(PSJNEWOE) D
"RTN","PSJLIACT",119,0)
 .S PSJVFF=1 D:'$G(PSJENHOC)&'$G(PSGORQF) OC^PSIVOC D:('$G(PSGORQF)&'$G(PSJDSVFY)) IN^PSJOCDS($G(PSGORD),"IV","") K PSJVFF Q:$G(PSGORQF)
"RTN","PSJLIACT",120,0)
 Q:$G(PSGORQF)
"RTN","PSJLIACT",121,0)
 ELSE  IF '$G(PSGORQF),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",122,0)
 ELSE  IF $G(PSIVFN1),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",123,0)
 ELSE  IF $G(PSGDEF),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",124,0)
 ELSE  IF $G(PSIVCOPY),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",125,0)
 D ACTIVE^PSIVORC2
"RTN","PSJLIACT",126,0)
 Q
"RTN","PSJLIACT",127,0)
VF1(PSIVREA,PSIVAL,PSIVLOG) ;
"RTN","PSJLIACT",128,0)
 ;Update 4 node and set activity log.
"RTN","PSJLIACT",129,0)
 ;PSIVREA: the reason use by LOG^PSIVORAL
"RTN","PSJLIACT",130,0)
 ;PSIVAL : the description reason
"RTN","PSJLIACT",131,0)
 ;PSIVLOG: Log an activity if = 1
"RTN","PSJLIACT",132,0)
 K PSGORQF
"RTN","PSJLIACT",133,0)
 I '+$G(OD)!($L($G(OD))>16) K OD
"RTN","PSJLIACT",134,0)
 D:+PSJSYSU=3 ^PSIVORE1
"RTN","PSJLIACT",135,0)
 NEW DIE,DA,DR,PSJX,XX,PSIVACT,PSJRQND
"RTN","PSJLIACT",136,0)
 S PSIVACT=1
"RTN","PSJLIACT",137,0)
 S PSJX=$G(^PS(55,DFN,"IV",+ON55,4)),XX=""
"RTN","PSJLIACT",138,0)
 I $P(PSJX,U)="" S XX=";143////0"
"RTN","PSJLIACT",139,0)
 I $P(PSJX,U,4)="" S XX=XX_U_";142////0"
"RTN","PSJLIACT",140,0)
 D NOW^%DTC
"RTN","PSJLIACT",141,0)
 S DIE="^PS(55,"_DFN_",""IV"",",DA=+ON55,DA(1)=DFN
"RTN","PSJLIACT",142,0)
 I +PSJSYSU=3 S DR="140////"_DUZ_";141////"_$E(%,1,12)_";142////1"_$P(XX,U)
"RTN","PSJLIACT",143,0)
 I +PSJSYSU=1 S DR="16////"_DUZ_";17////"_$E(%,1,12)_";143////1"_$P(XX,U,2)
"RTN","PSJLIACT",144,0)
 I $G(P("PRY"))="D" S DR=DR_";.22////"_+P("IVRM")
"RTN","PSJLIACT",145,0)
 D ^DIE
"RTN","PSJLIACT",146,0)
 ; If pending IV renew is edited during finish, go back and DE the original active order left in RENEWED status
"RTN","PSJLIACT",147,0)
 S PREREN=$S(ON55["V":$G(@(DIE_"+ON55,2)")),1:""),PREREN=$P(PREREN,"^",5) I PREREN D  K PREREN
"RTN","PSJLIACT",148,0)
 . I PREREN["P" S PREREN=$G(@("^PS(53.1,+PREREN,0)")),PREREN=$P(PREREN,"^",25)
"RTN","PSJLIACT",149,0)
 . I PREREN["V" N PRERENOD S PRERENOD=$G(@("^PS(55,DFN,""IV"",+PREREN,0)")) I $P(PRERENOD,"^",17)="R",($G(P("RES"))="E") D
"RTN","PSJLIACT",150,0)
 ..  S DIE="^PS(55,"_DFN_",""IV"",",DA=+PREREN,DA(1)=DFN
"RTN","PSJLIACT",151,0)
 ..  S DR="100////D;.03////"_PSGDT S ORIGSTOP=$P($G(@("^PS(55,DFN,""IV"",+PREREN,2)")),"^",3) I ORIGSTOP S DR=DR_";116////"_ORIGSTOP
"RTN","PSJLIACT",152,0)
 ..  D ^DIE D EN1^PSJHL2(DFN,"SC",PREREN)
"RTN","PSJLIACT",153,0)
 K DR,DIE,DA
"RTN","PSJLIACT",154,0)
 I (+PSJSYSU=3)&($G(P("PRY"))="D") D
"RTN","PSJLIACT",155,0)
 .N DIR W ! S DIR(0)="S^Y:Yes;N:No",DIR("A")="Do you want to enter a Progress Note",DIR("B")="No" D ^DIR
"RTN","PSJLIACT",156,0)
 .Q:Y="N"
"RTN","PSJLIACT",157,0)
 .D MAIN^TIUEDIT(3,.TIUDA,DFN,"","","","",1)
"RTN","PSJLIACT",158,0)
 Q:'$G(PSIVLOG)
"RTN","PSJLIACT",159,0)
 I $G(P("PACT"))]"",+$P(P("PACT"),U,2),+$P(P("PACT"),U,3) D
"RTN","PSJLIACT",160,0)
 . NEW DIC,DA,X,Y,XX,DO D NAME^PSJBCMA1($P(P("PACT"),U,2),.XX)
"RTN","PSJLIACT",161,0)
 . S DIC(0)="L",DA(1)=DFN,DA(2)=+ON55,X=1
"RTN","PSJLIACT",162,0)
 . S DIC="^PS(55,"_DA(1)_",""IV"","_DA(2)_",""A"","
"RTN","PSJLIACT",163,0)
 . S DIC("DR")=".02////F;.03////"_XX_";.04////"_$P($G(^PS(53.3,+$P(P("PACT"),U,3),0)),U)_";.05////"_$P(P("PACT"),U)_";.06////"_$P(P("PACT"),U,2)
"RTN","PSJLIACT",164,0)
 . D FILE^DICN
"RTN","PSJLIACT",165,0)
 NEW PSIVALCK
"RTN","PSJLIACT",166,0)
 S PSIVREA="V",PSIVALT=""
"RTN","PSJLIACT",167,0)
 S PSIVAL=PSIVAL_$S(+PSJSYSU=3:"PHARMACIST",1:"NURSE")
"RTN","PSJLIACT",168,0)
 D LOG^PSIVORAL K PSIVAL,PSIVREA,PSIVLN
"RTN","PSJLIACT",169,0)
 I $G(PSJORD)["P" S PSIVREA="V",PSIVALT="",PSGRDTX=$G(^PS(53.1,+PSJORD,2.5)) D
"RTN","PSJLIACT",170,0)
 . I $G(PSGRDTX) S PSIVAL="Requested Start Date: "_$$ENDTC^PSGMI($$DATE2^PSJUTL2($P(PSGRDTX,U))) D LOG^PSIVORAL
"RTN","PSJLIACT",171,0)
 . I $P(PSGRDTX,U,3) S PSIVREA="V",PSIVALT="" S PSIVAL="Requested Stop Date: "_$$ENDTC^PSGMI($$DATE2^PSJUTL2($P(PSGRDTX,U,3))) D LOG^PSIVORAL
"RTN","PSJLIACT",172,0)
 N DUR I $G(PSJORD) S DUR=$$GETDUR^PSJLIVMD(DFN,+PSJORD,$S(PSJORD["P":"P",1:"IV"),1) I DUR]""  D
"RTN","PSJLIACT",173,0)
 . K DR S DIE="^PS(55,"_DFN_",""IV"",",DA=+ON55,DA(1)=DFN
"RTN","PSJLIACT",174,0)
 . S DR=$S($G(IVLIMIT):"152////"_DUR,1:"151////"_DUR) K IVLIMIT
"RTN","PSJLIACT",175,0)
 . D ^DIE
"RTN","PSJLIACT",176,0)
 S ^TMP("PSODAOC",$J,"IP NEW IEN")=ON55
"RTN","PSJLIACT",177,0)
 D EN1^PSJHL2(DFN,"SC",ON55),SETOC^PSJNEWOC(ON55)
"RTN","PSJLIACT",178,0)
 D:+PSJSYSU=1 EN1^PSJHL2(DFN,"ZV",ON55)
"RTN","PSJLIACT",179,0)
 I '$D(^PS(55,DFN,"IV","CIMOI",+ON55)) D CIMOI^PSJIMO1(DFN,ON55,"",$G(PSJORD))
"RTN","PSJLIACT",180,0)
 E  I +$G(PSJORD) D KILL531^PSJIMO1(DFN,"",PSJORD)
"RTN","PSJLIACT",181,0)
 D GT55^PSIVORFB S OLDON=$P($G(^PS(55,DFN,"IV",+ON55,2)),"^",5),P("OLDON")=OLDON
"RTN","PSJLIACT",182,0)
 N PSJPRIO,PSJSCH,NODE0,NODEP2 S NODE0=$G(^PS(55,DFN,"IV",+ON55,0)),NODEP2=$G(^PS(55,DFN,"IV",+ON55,.2))
"RTN","PSJLIACT",183,0)
 S PSJPRIO=$P(NODEP2,"^",4),PSJSCH=$P(NODE0,"^",9)
"RTN","PSJLIACT",184,0)
 I (",S,A,")[(","_$G(PSJPRIO)_",")!($G(PSJSCH)="NOW")!($G(PSJSCH)["STAT") D NOTIFY^PSJHL4(ON55,DFN,$G(PSJPRIO),$G(PSJSCH))
"RTN","PSJLIACT",185,0)
 Q
"RTN","PSJLIFNI")
0^6^B13554613
"RTN","PSJLIFNI",1,0)
PSJLIFNI ;BIR/MV-U/D ORDER FINISHES AS IV ;13 Jan 98 / 11:32 AM
"RTN","PSJLIFNI",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**1,29,34,37,50,94,116,110,111,181,261,256,347**;16 DEC 97;Build 6
"RTN","PSJLIFNI",3,0)
 ;
"RTN","PSJLIFNI",4,0)
IV(PSJORD,OI) ; Prompt for missing data to be finished as IV.
"RTN","PSJLIFNI",5,0)
 L +^PS(53.1,+PSJORD):1 I '$T W !,$C(7),$C(7),"This order is being edited by another user. Try later." D PAUSE^VALM1 Q
"RTN","PSJLIFNI",6,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIFNI",7,0)
 ;** PSIVFN1 is used so it will display the AC/Edit screen
"RTN","PSJLIFNI",8,0)
 ;** instead of go to the "IS this O.K." prompt
"RTN","PSJLIFNI",9,0)
 ;** PSJLIFNI is a flag to indicate U/D finishes as IV.
"RTN","PSJLIFNI",10,0)
 K PSJIVBD
"RTN","PSJLIFNI",11,0)
 NEW PSIVFN1,ON55,PSGORQF,PSIVACEP,DRGOC,PSJLIFNI,PSIVOI,PSJOLDNM
"RTN","PSJLIFNI",12,0)
 K PSGORQF
"RTN","PSJLIFNI",13,0)
 S PSJLIFNI=1
"RTN","PSJLIFNI",14,0)
 S PSIVAC="CF" S (P("PON"),ON,ON55)=+PSJORD_"P",DFN=PSGP
"RTN","PSJLIFNI",15,0)
 S PSIVUP=+$$GTPCI^PSIVUTL D GT531^PSIVORFA(DFN,ON) S P("PD")=OI_U_$$OIDF^PSJLMUT1(+OI)
"RTN","PSJLIFNI",16,0)
 D:'$D(P("OT")) GTOT^PSIVUTL(P(4))
"RTN","PSJLIFNI",17,0)
 S P("OPI")=$$ENPC^PSJUTL("V",+PSIVUP,60,P("OPI"))
"RTN","PSJLIFNI",18,0)
 D 53^PSIVORC1
"RTN","PSJLIFNI",19,0)
 I $E(P("OT"))="I" D GTDATA^PSJLIFN Q:P(4)=""
"RTN","PSJLIFNI",20,0)
 ;I $$SCHREQ^PSJLIVFD(.P),(P(9))]"",'$$PRNOK^PSGS0(P(9)) N PSGOES,X,PSGS0XT,PSJNSS S PSJNSS=1,PSGOES=1,X=P(9),PSGS0XT=P(15) D Q2^PSGS0
"RTN","PSJLIFNI",21,0)
 I $$SCHREQ^PSJLIVFD(.P),(P(9))]"",'$$PRNOK^PSGS0(P(9)) N PSJNSS,PSGOES,PSGS0XT,PSGS0Y,PSGAT S X=P(9),PSGS0XT=P(15),PSGAT=P(11) D
"RTN","PSJLIFNI",22,0)
 .;
"RTN","PSJLIFNI",23,0)
 .;PSJ*5*256
"RTN","PSJLIFNI",24,0)
 . S PSJOLDNM("ORD_SCHD")=P(9)
"RTN","PSJLIFNI",25,0)
 . I ($G(P("RES"))'="R"),$$CHKSCHD^PSJMISC2(.PSJOLDNM) S PSGORQF=1,VALMBCK="R" Q
"RTN","PSJLIFNI",26,0)
 . S:$G(PSJOLDNM("NEW_SCHD"))]"" P(9)=PSJOLDNM("NEW_SCHD")
"RTN","PSJLIFNI",27,0)
 .;
"RTN","PSJLIFNI",28,0)
 .;D EN^PSGS0 I $G(X)="" D  S PSGORQF=1 Q
"RTN","PSJLIFNI",29,0)
 .D EN^PSGS0
"RTN","PSJLIFNI",30,0)
 .I $G(X)="" S PSGORQF=1 Q
"RTN","PSJLIFNI",31,0)
 .;Update the schedule if diff value enttered.
"RTN","PSJLIFNI",32,0)
 .I ($G(X)]""),($G(P(9))]"") S P(9)=X
"RTN","PSJLIFNI",33,0)
 .I $G(PSGS0Y)>1 S P(11)=PSGS0Y
"RTN","PSJLIFNI",34,0)
 I $E(P("OT"))="I",'$D(DRG("AD")),('$D(DRG("SOL"))) S DNE=0 D GTIVDRG^PSIVORC2 S P(3)="" D ENSTOP^PSIVCAL
"RTN","PSJLIFNI",35,0)
 I $D(PSGORQF) S VALMBCK="R",P(4)="" K DRG Q
"RTN","PSJLIFNI",36,0)
 S ^TMP("PSJI",$J,0)=""
"RTN","PSJLIFNI",37,0)
 S PSIVOK="1^3^10^25^26^39^57^58^59^63^64" D CKFLDS^PSIVORC1 I EDIT]"" D EDIT^PSIVEDT
"RTN","PSJLIFNI",38,0)
 ;I $G(EDIT)="" D OC^PSIVOC
"RTN","PSJLIFNI",39,0)
 I $G(DONE) S VALMBCK="R" D EXIT Q
"RTN","PSJLIFNI",40,0)
 ;PSJ*5*261 - Remedy #490875 PSPO 2040
"RTN","PSJLIFNI",41,0)
 D ENSTOP^PSIVCAL
"RTN","PSJLIFNI",42,0)
 D COMPLTE^PSIVORC1
"RTN","PSJLIFNI",43,0)
 S:$D(PSIVACEP) VALMBCK="Q"
"RTN","PSJLIFNI",44,0)
EXIT ;
"RTN","PSJLIFNI",45,0)
 L -^PS(53.1,+PSJORD)
"RTN","PSJLIFNI",46,0)
 Q
"RTN","PSJLIFNI",47,0)
ORDCHK(DFN,TYPE) ;
"RTN","PSJLIFNI",48,0)
 ;TYPE ="DD" - Duplicate drug
"RTN","PSJLIFNI",49,0)
 ;     ="DC" - Duplicate class
"RTN","PSJLIFNI",50,0)
 ;     -"DI" - Drug Interaction
"RTN","PSJLIFNI",51,0)
 ;
"RTN","PSJLIFNI",52,0)
 NEW ON,PSJL,PSIVX,PSJOC,PSJORIEN,PSJPACK,PSJLINE
"RTN","PSJLIFNI",53,0)
 S PSJOC=0,PSJLINE=1
"RTN","PSJLIFNI",54,0)
 F PSIVX=0:0 S PSIVX=$O(^TMP($J,TYPE,PSIVX)) Q:'PSIVX  D
"RTN","PSJLIFNI",55,0)
 . I TYPE="DI",($P(^TMP($J,TYPE,PSIVX,0),U,4)="CRITICAL") S PSJIREQ=1
"RTN","PSJLIFNI",56,0)
 . D WRITE(TYPE),CONT^PSGSICHK
"RTN","PSJLIFNI",57,0)
 .; I ON["V" D
"RTN","PSJLIFNI",58,0)
 .;. I '$O(^PS(55,DFN,"IV",+ON,0)) D SETPSJOC Q
"RTN","PSJLIFNI",59,0)
 .;. D DSPLORDV(DFN,ON) S PSJOC=PSJOC+1
"RTN","PSJLIFNI",60,0)
 .; I ON'["V" D DSPLORDU(DFN,ON) S PSJOC=PSJOC+1
"RTN","PSJLIFNI",61,0)
 .; S PSJOC(ON,PSJLINE)="",PSJLINE=PSJLINE+1
"RTN","PSJLIFNI",62,0)
 ;D:PSJOC WRITE(TYPE)
"RTN","PSJLIFNI",63,0)
 ;S ON="" F  S ON=$O(PSJOC(ON)) Q:ON=""  W ! S PSJLINE=PSJLINE+1 D
"RTN","PSJLIFNI",64,0)
 ;. F PSIVX=0:0 S PSIVX=$O(PSJOC(ON,PSIVX)) Q:'PSIVX  W !,PSJOC(ON,PSIVX)  S PSJLINE=PSJLINE+1 D:'(PSIVX#6) PAUSE
"RTN","PSJLIFNI",65,0)
 ;W !
"RTN","PSJLIFNI",66,0)
 Q
"RTN","PSJLIFNI",67,0)
WRITE(TYPE) ;Display order check description
"RTN","PSJLIFNI",68,0)
 S PSJPDRG=1
"RTN","PSJLIFNI",69,0)
 I TYPE="DD" W !!,"There are duplicate ",$P(^TMP($J,TYPE,PSIVX,0),U,2),!,"medications prescribed for this order.",! Q
"RTN","PSJLIFNI",70,0)
 I TYPE="DC" W !!,"This medication: ",$P(^TMP($J,TYPE,PSIVX,0),U,4),!,"is in the same class as the following medication(s) within this order: "
"RTN","PSJLIFNI",71,0)
 I TYPE="DI" W !!,"This medication: ",$P(^TMP($J,TYPE,PSIVX,0),U,2),!,"has an interaction with the following medication(s) within this order: "
"RTN","PSJLIFNI",72,0)
 F X=0:0 S X=$O(^TMP($J,TYPE,X)) Q:'X  W !,$S(TYPE="DC":$P(^TMP($J,TYPE,X,0),U,4),TYPE="DI":$P(^TMP($J,TYPE,X,0),U,6),1:$P(^TMP($J,TYPE,X,0),U,2)),!
"RTN","PSJLIFNI",73,0)
 Q
"RTN","PSJOCDSD")
0^4^B35960175
"RTN","PSJOCDSD",1,0)
PSJOCDSD ; BIR/MV,RN - PROCESS DOSING ORDER CHECKS ;6 Jun 07  3:37 PM
"RTN","PSJOCDSD",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**181,252,281,256,347**;16 DEC 97;Build 6
"RTN","PSJOCDSD",3,0)
 ;
"RTN","PSJOCDSD",4,0)
DISPLAY ;Display dose checks
"RTN","PSJOCDSD",5,0)
 NEW PSJPON,PSJDSPFG,PSJCNT0,DR,PSJONLST
"RTN","PSJOCDSD",6,0)
 D FULL^VALM1
"RTN","PSJOCDSD",7,0)
 I $D(^TMP($J,"PSJPRE1","OUT")),'$D(PSJEXCPT("PROSPECTIVE")) W @IOF
"RTN","PSJOCDSD",8,0)
 Q:'$$DSPSERR^PSJOC("Dosing Checks could not be performed.")
"RTN","PSJOCDSD",9,0)
 D EXCEPTN2
"RTN","PSJOCDSD",10,0)
 F PSJCNT0=0:0 S PSJCNT0=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0)) Q:'PSJCNT0  Q:$G(PSGORQF)  D
"RTN","PSJOCDSD",11,0)
 . S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON)) Q:PSJPON=""  Q:$G(PSGORQF)  D
"RTN","PSJOCDSD",12,0)
 .. Q:PSJPON=0
"RTN","PSJOCDSD",13,0)
 .. D ERROR,PGBRK("ERROR",PSJCNT0,PSJPON)
"RTN","PSJOCDSD",14,0)
 .. D EXCEPTN,PGBRK("EXCEPTIONS",PSJCNT0,PSJPON)
"RTN","PSJOCDSD",15,0)
 .. D WARNING,PGBRK("WARNING",PSJCNT0,PSJPON)
"RTN","PSJOCDSD",16,0)
 I $D(^TMP($J,"PSJPRE1","OUT")),'$D(PSJEXCPT("PROSPECTIVE")) D PAUSE^PSJLMUT1
"RTN","PSJOCDSD",17,0)
 K PSJDSPFG,PSJEXCPT("PROSPECTIVE")
"RTN","PSJOCDSD",18,0)
 Q
"RTN","PSJOCDSD",19,0)
DOSEOFF(PSJMSG) ;
"RTN","PSJOCDSD",20,0)
 ;Display message if dosing had turned off (once per patient session)
"RTN","PSJOCDSD",21,0)
 Q:$D(PSJEXCPT("DOSE",0))
"RTN","PSJOCDSD",22,0)
 S PSJEXCPT("DOSE",0)=""
"RTN","PSJOCDSD",23,0)
 W !!,$G(PSJMSG),!
"RTN","PSJOCDSD",24,0)
 D PAUSE^PSJLMUT1
"RTN","PSJOCDSD",25,0)
 Q
"RTN","PSJOCDSD",26,0)
WARNING ;Display warning messages
"RTN","PSJOCDSD",27,0)
 NEW PSJSGLE,PSJRNGE,PSJMSG,PSJDD,PSJTYPE,PSJORI
"RTN","PSJOCDSD",28,0)
 I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",29,0)
 S PSJMSG="",PSJORI=""
"RTN","PSJOCDSD",30,0)
 S (PSJSGLE,PSJRNGE)=0
"RTN","PSJOCDSD",31,0)
 I '$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",0)),'$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",0)) D
"RTN","PSJOCDSD",32,0)
 . I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",33,0)
 S PSJTYPE="" F  S PSJTYPE=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE)) Q:PSJTYPE=""  D
"RTN","PSJOCDSD",34,0)
 .IF PSJTYPE=".1_INTRO" SET PSJORI=^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE) D  Q
"RTN","PSJOCDSD",35,0)
 ..I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",36,0)
 ..W !
"RTN","PSJOCDSD",37,0)
 ..D WRITE^PSJMISC(PSJORI,1)
"RTN","PSJOCDSD",38,0)
 .I PSJTYPE="2_TRAIL" S PSJMSG=^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE) D  Q
"RTN","PSJOCDSD",39,0)
 ..I ($Y+4)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",40,0)
 ..E  W !
"RTN","PSJOCDSD",41,0)
 ..D WRITE^PSJMISC(PSJMSG,3)
"RTN","PSJOCDSD",42,0)
 . I ($Y+4)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",43,0)
 . ;Don't display a blank line after Per Orifice text
"RTN","PSJOCDSD",44,0)
 . I $G(PSJORI)=""  W !
"RTN","PSJOCDSD",45,0)
 . K PSJORI
"RTN","PSJOCDSD",46,0)
 . F PSJDD=0:0 S PSJDD=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE,PSJDD)) Q:'PSJDD  D
"RTN","PSJOCDSD",47,0)
 .. Q:$G(PSGORQF)
"RTN","PSJOCDSD",48,0)
 .. S PSJMSG=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE,PSJDD))
"RTN","PSJOCDSD",49,0)
 .. I PSJTYPE="3_GENERAL" D GENERAL
"RTN","PSJOCDSD",50,0)
 .. I PSJTYPE'="3_GENERAL" D
"RTN","PSJOCDSD",51,0)
 ... S PSJMSG=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE,PSJDD))
"RTN","PSJOCDSD",52,0)
 ... D WRITE^PSJMISC(PSJMSG,3)
"RTN","PSJOCDSD",53,0)
 .. I PSJTYPE["1_SINGLE_RANGE" S (PSJSGLE,PSJRNGE)=1_U_PSJDD Q
"RTN","PSJOCDSD",54,0)
 .. S:PSJTYPE["1_SINGLE" PSJSGLE=1_U_PSJDD
"RTN","PSJOCDSD",55,0)
 .. S:PSJTYPE["2_RANGE" PSJRNGE=1_U_PSJDD
"RTN","PSJOCDSD",56,0)
 Q:$G(PSGORQF)
"RTN","PSJOCDSD",57,0)
 D INTERV
"RTN","PSJOCDSD",58,0)
 Q
"RTN","PSJOCDSD",59,0)
INTERV ;Process intervention for dosing check
"RTN","PSJOCDSD",60,0)
 NEW PSJDD
"RTN","PSJOCDSD",61,0)
 S PSJDD=$S(+PSJSGLE:$P(PSJSGLE,U,2),1:$P(PSJRNGE,U,2))
"RTN","PSJOCDSD",62,0)
 I 'PSJDD,'$D(PSJOCFG) Q
"RTN","PSJOCDSD",63,0)
 K PSJDSPFG
"RTN","PSJOCDSD",64,0)
 I +PSJSGLE!+PSJRNGE W ! S PSJDSPFG=1
"RTN","PSJOCDSD",65,0)
 I +PSJSGLE,+PSJRNGE D RINTERV^PSJGMRA("MAX SINGLE DOSE & Max Daily Dose") Q
"RTN","PSJOCDSD",66,0)
 I +PSJRNGE D RINTERV^PSJGMRA("Max Daily Dose") Q
"RTN","PSJOCDSD",67,0)
 I +PSJSGLE D RINTERV^PSJGMRA("MAX SINGLE DOSE") Q
"RTN","PSJOCDSD",68,0)
 Q
"RTN","PSJOCDSD",69,0)
ERROR ; Process errors
"RTN","PSJOCDSD",70,0)
 NEW PSJCNT,PSJNV
"RTN","PSJOCDSD",71,0)
 ;Check for system error one more time.
"RTN","PSJOCDSD",72,0)
 F PSJCNT=0:0 S PSJCNT=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",PSJCNT)) Q:'PSJCNT  D
"RTN","PSJOCDSD",73,0)
 .I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",74,0)
 . E  W !
"RTN","PSJOCDSD",75,0)
 . S PSJNV=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",PSJCNT,"MSG"))
"RTN","PSJOCDSD",76,0)
 . I PSJNV]"" D WRITE^PSJMISC(PSJNV,3)
"RTN","PSJOCDSD",77,0)
 . S PSJNV=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",PSJCNT,"TEXT"))
"RTN","PSJOCDSD",78,0)
 . I PSJNV]"" D WRITE^PSJMISC(PSJNV,5)
"RTN","PSJOCDSD",79,0)
 . S PSJNV=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",PSJCNT,"TRAIL"))
"RTN","PSJOCDSD",80,0)
 . I PSJNV]"" W ! D WRITE^PSJMISC(PSJNV,3)
"RTN","PSJOCDSD",81,0)
 Q
"RTN","PSJOCDSD",82,0)
EXCEPTN ; Process exceptions
"RTN","PSJOCDSD",83,0)
 NEW PSJCNT,PSJNV,PSJSPACE,PSJQFLG1,PSJDSDRG,PSJXDRG,PSJQUIT
"RTN","PSJOCDSD",84,0)
 ;Check for system error one more time.
"RTN","PSJOCDSD",85,0)
 ;PSJOCFG - flag when order is Renew, Copy or New OE
"RTN","PSJOCDSD",86,0)
 S PSJSPACE=0
"RTN","PSJOCDSD",87,0)
 I $O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",0)) D
"RTN","PSJOCDSD",88,0)
 .I ($Y+4)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",89,0)
 F PSJCNT=0:0 S PSJCNT=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT)) Q:'PSJCNT  D
"RTN","PSJOCDSD",90,0)
 . S PSJQFLG1=0,PSJDSDRG=""
"RTN","PSJOCDSD",91,0)
 . S PSJDSDRG=$P($G(^TMP($J,"PSJPRE","IN","DOSE",PSJPON)),U,3)
"RTN","PSJOCDSD",92,0)
 . S PSJQUIT=0,PSJXDRG="" F  S PSJXDRG=$O(PSJEXCPT("PROSPECTIVE",PSJXDRG)) Q:PSJXDRG=""  I +PSJXDRG=+PSJDSDRG S PSJQUIT=1 Q
"RTN","PSJOCDSD",93,0)
 . Q:PSJQUIT
"RTN","PSJOCDSD",94,0)
 . S PSJNV=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT))
"RTN","PSJOCDSD",95,0)
 . I PSJNV]"" D
"RTN","PSJOCDSD",96,0)
 .. I $E(PSJNV,1,13)="             " S PSJSPACE=13,PSJNV=$P(PSJNV,"             ",2)
"RTN","PSJOCDSD",97,0)
 .. I (PSJNV'["Reason(s)"),+'$G(PSJSPACE) W !
"RTN","PSJOCDSD",98,0)
 .. I PSJNV["  Reason(s)" S PSJNV=$P(PSJNV,"  ",2),PSJSPACE=2
"RTN","PSJOCDSD",99,0)
 .. D WRITE^PSJMISC(PSJNV,PSJSPACE+3)
"RTN","PSJOCDSD",100,0)
 . S PSJNV=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT,"TRAIL"))
"RTN","PSJOCDSD",101,0)
 . I PSJNV]"" W ! D WRITE^PSJMISC(PSJNV,PSJSPACE+3)
"RTN","PSJOCDSD",102,0)
 Q
"RTN","PSJOCDSD",103,0)
EXCEPTN2 ; Process exceptions on prospective drug
"RTN","PSJOCDSD",104,0)
 NEW PSJPON,PSJN,PSJNV
"RTN","PSJOCDSD",105,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE1","OUT","EXCEPTIONS",PSJPON)) Q:PSJPON=""  D
"RTN","PSJOCDSD",106,0)
 . F PSJN=0:0 S PSJN=$O(^TMP($J,"PSJPRE1","OUT","EXCEPTIONS",PSJPON,PSJN)) Q:'PSJN  D
"RTN","PSJOCDSD",107,0)
 .. S PSJNV=$G(^TMP($J,"PSJPRE1","OUT","EXCEPTIONS",PSJPON,PSJN))
"RTN","PSJOCDSD",108,0)
 .. I $P(PSJPON,";",3)="PROFILE" Q
"RTN","PSJOCDSD",109,0)
 .. I '$$ERRCHK^PSJOC("PROSPECTIVE",$P(PSJNV,U,3)_$P(PSJNV,U,10)) Q
"RTN","PSJOCDSD",110,0)
 .. Q:'$D(PSJOCFG)
"RTN","PSJOCDSD",111,0)
 .. W !
"RTN","PSJOCDSD",112,0)
 .. D DSPDRGER^PSJOC(1)
"RTN","PSJOCDSD",113,0)
 Q
"RTN","PSJOCDSD",114,0)
GENERAL ;
"RTN","PSJOCDSD",115,0)
 NEW PSJGCNT
"RTN","PSJOCDSD",116,0)
 F PSJGCNT=0:0 S PSJGCNT=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE,PSJDD,PSJGCNT)) Q:'PSJGCNT  D
"RTN","PSJOCDSD",117,0)
 . S PSJMSG=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE,PSJDD,PSJGCNT))
"RTN","PSJOCDSD",118,0)
 .I ($Y+3)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",119,0)
 . D WRITE^PSJMISC(PSJMSG,3)
"RTN","PSJOCDSD",120,0)
 Q
"RTN","PSJOCDSD",121,0)
PGBRK(PSJTYPE,PSJCNT0,PSJPON) ;Chedk if the last group of dosing messages have displayed. if intervention is needed, no press return is needed.
"RTN","PSJOCDSD",122,0)
 Q  ;PSJ*5*256
"RTN","PSJOCDSD",123,0)
 NEW PSJERR,PSJEXCPT,PSJWARN,PSJMSG
"RTN","PSJOCDSD",124,0)
 Q:'+PSJCNT0
"RTN","PSJOCDSD",125,0)
 Q:$G(PSJPON)=""
"RTN","PSJOCDSD",126,0)
 Q:+$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0))
"RTN","PSJOCDSD",127,0)
 S (PSJERR,PSJEXCPT,PSJWARN)=0
"RTN","PSJOCDSD",128,0)
 ;
"RTN","PSJOCDSD",129,0)
 I $O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",0)) S PSJERR=1
"RTN","PSJOCDSD",130,0)
 I $D(PSJONLST(PSJPON)),$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",0)) S PSJEXCPT=1
"RTN","PSJOCDSD",131,0)
 S PSJMSG=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE","")) S:PSJMSG]"" PSJWARN=1
"RTN","PSJOCDSD",132,0)
 ;
"RTN","PSJOCDSD",133,0)
 I (PSJTYPE="ERROR"),PSJERR,('PSJEXCPT&'PSJWARN) D PAUSE^PSJLMUT1
"RTN","PSJOCDSD",134,0)
 I (PSJTYPE="EXCEPTIONS"),PSJEXCPT,'PSJWARN D PAUSE^PSJLMUT1
"RTN","PSJOCDSD",135,0)
 I (PSJTYPE="WARNING"),PSJWARN,($G(PSJMSG)="3_GENERAL") D PAUSE^PSJLMUT1
"RTN","PSJOCDSD",136,0)
 Q
"RTN","PSJPDCL")
0^14^B59283748
"RTN","PSJPDCL",1,0)
PSJPDCL ;BIR/MHA - PADE HL7 ADT MESSAGE CLIENT TO VAFC ADT SERVER ;07/08/15
"RTN","PSJPDCL",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**317,337,347**;16 DEC 97;Build 6
"RTN","PSJPDCL",3,0)
 ;Reference to ^SC supported by DBIA 10040
"RTN","PSJPDCL",4,0)
 ;Reference to ^DIC(42 supported by DBIA 10039
"RTN","PSJPDCL",5,0)
 ;Reference to ^ORD(101 supported by DBIA 872
"RTN","PSJPDCL",6,0)
 ;Reference to ^DG(405.4 supported by DBIA 1380
"RTN","PSJPDCL",7,0)
 ;Reference to ^GMRADPT supported by DBIA 10099
"RTN","PSJPDCL",8,0)
 ;Reference to ^GMRVUTL supported by DBIA 1120
"RTN","PSJPDCL",9,0)
 ;Reference to ^GMRAOR2 supported by DBIA 2422
"RTN","PSJPDCL",10,0)
 ;
"RTN","PSJPDCL",11,0)
 Q
"RTN","PSJPDCL",12,0)
 ;
"RTN","PSJPDCL",13,0)
EN ; Get ADT Message and send to PADE.
"RTN","PSJPDCL",14,0)
 Q:$O(^PS(58.7,"B",""))=""
"RTN","PSJPDCL",15,0)
 Q:'$G(HLEID)
"RTN","PSJPDCL",16,0)
 N PSJAP
"RTN","PSJPDCL",17,0)
 S PSJAP=0
"RTN","PSJPDCL",18,0)
 N I,J S I=0
"RTN","PSJPDCL",19,0)
 F  S I=$O(^PS(58.7,I)) Q:'I  S J=$$PDACT^PSJPDCLA(I)
"RTN","PSJPDCL",20,0)
 Q:'PSJAP
"RTN","PSJPDCL",21,0)
 I $G(HL("ETN"))="" D INIT^HLFNC2(HLEID,.HL) Q:$D(HL)=1
"RTN","PSJPDCL",22,0)
 N FS,ECH S FS=HL("FS"),ECH=$E(HL("ECH"),1)
"RTN","PSJPDCL",23,0)
 N SNM,SID,NHL S SNM="PSJ ADT-"_HL("ETN")_" SERVER"
"RTN","PSJPDCL",24,0)
 S SID=$O(^ORD(101,"B",SNM,0))
"RTN","PSJPDCL",25,0)
 Q:'SID
"RTN","PSJPDCL",26,0)
 D INIT^HLFNC2(SID,.NHL) Q:$D(NHL)=1
"RTN","PSJPDCL",27,0)
 N NFS,NECH S NFS=NHL("FS"),NECH=$E(NHL("ECH"),1)
"RTN","PSJPDCL",28,0)
 N NSEG,PSJQ,PSJLOC,PSJWARD,PSJRBD,SEQ,PSJX,VAIP,X,FTS
"RTN","PSJPDCL",29,0)
 S VAIP("D")="L" D IN5^VADPT S PSJRBD=$P(VAIP(6),"^",2),FTS=$S($P(VAIP(8),"^")]"":$P(VAIP(8),"^")_NECH_$P(VAIP(8),"^",2),1:"")
"RTN","PSJPDCL",30,0)
 S SEQ=0,PSJQ=0,PSJX=1 S:HL("ETN")="A11" FTS=""
"RTN","PSJPDCL",31,0)
 F I=1:1 X HLNEXT Q:HLQUIT'>0!('PSJX)  D
"RTN","PSJPDCL",32,0)
 . Q:$E(HLNODE,1,3)="MSH"
"RTN","PSJPDCL",33,0)
 . Q:$E(HLNODE,1,3)="OBX"
"RTN","PSJPDCL",34,0)
 . Q:$E(HLNODE,1,3)="ROL"
"RTN","PSJPDCL",35,0)
 . Q:$E(HLNODE,1)="Z"
"RTN","PSJPDCL",36,0)
 . S SEQ=SEQ+1
"RTN","PSJPDCL",37,0)
 . S NSEG(SEQ)=$$TR(HLNODE)
"RTN","PSJPDCL",38,0)
 . S J=0 F  S J=$O(HLNODE(J)) Q:'J  S NSEG(SEQ,J)=$$TR(HLNODE(J))
"RTN","PSJPDCL",39,0)
 . I $E(HLNODE,1,3)="PV1" D
"RTN","PSJPDCL",40,0)
 .. S PSJLOC=$P(HLNODE,FS,4)
"RTN","PSJPDCL",41,0)
 .. S PSJWARD=$P(PSJLOC,ECH) Q:PSJWARD=""
"RTN","PSJPDCL",42,0)
 .. S PSJQ=$$CHKPD(PSJWARD,PSJRBD)
"RTN","PSJPDCL",43,0)
 .. I 'PSJQ S PSJX=0 Q
"RTN","PSJPDCL",44,0)
 .. D AGY
"RTN","PSJPDCL",45,0)
 Q:'PSJQ
"RTN","PSJPDCL",46,0)
 N XX,HL,HLFS,HLECH M HL=NHL
"RTN","PSJPDCL",47,0)
 S HLFS=NHL("FS")
"RTN","PSJPDCL",48,0)
 S HLECH=NHL("ECH")
"RTN","PSJPDCL",49,0)
 N ZTIO,ZTRTN,ZTSAVE,ZTDESC,ZTDTH
"RTN","PSJPDCL",50,0)
 S ZTIO=""
"RTN","PSJPDCL",51,0)
 S ZTRTN="SEND^PSJPDCL"
"RTN","PSJPDCL",52,0)
 F XX="PSJQ(","NSEG(","HLFS","HLECH","HL(","SNM","SID","FTS" S ZTSAVE(XX)=""
"RTN","PSJPDCL",53,0)
 S ZTDESC="PADE HL7 ADT Message Router"
"RTN","PSJPDCL",54,0)
 S ZTDTH=$H
"RTN","PSJPDCL",55,0)
 D ^%ZTLOAD
"RTN","PSJPDCL",56,0)
 Q
"RTN","PSJPDCL",57,0)
 ;
"RTN","PSJPDCL",58,0)
SEND ;
"RTN","PSJPDCL",59,0)
 N XX,CT,PSJND,PSJVNM,PSJDNS,PSJVP,VR,HLA,CNM,PSJSND
"RTN","PSJPDCL",60,0)
 M HLA("HLS")=NSEG
"RTN","PSJPDCL",61,0)
 Q:$G(SNM)=""
"RTN","PSJPDCL",62,0)
 I $G(HL("ETN"))="" D INIT^HLFNC2(SNM,.HL) Q:$D(HL)=1
"RTN","PSJPDCL",63,0)
 S CNM="PSJ ADT-"_HL("ETN")_" CLIENT"
"RTN","PSJPDCL",64,0)
 S XX=0,CT=0 F  S XX=$O(PSJQ(XX)) Q:'XX  D   ;sends HL7 message for each PADE SERVER
"RTN","PSJPDCL",65,0)
 .S PSJND=$G(^PS(58.7,XX,0))
"RTN","PSJPDCL",66,0)
 .Q:PSJND=""
"RTN","PSJPDCL",67,0)
 .S PSJVNM=$P(PSJND,"^"),PSJDNS=$P(PSJND,"^",2),PSJVP=$P(PSJND,"^",3)
"RTN","PSJPDCL",68,0)
 .Q:PSJVNM=""!(PSJDNS="")!('PSJVP)
"RTN","PSJPDCL",69,0)
 .N HLP,PSJSND,ZZ1,ZZ2 S (HLP,ZZ1,ZZ2)=""
"RTN","PSJPDCL",70,0)
 .I $G(HL("ETN"))="" D INIT^HLFNC2(SNM,.HL) Q:$D(HL)=1
"RTN","PSJPDCL",71,0)
 .K HLA,HLL M HLA("HLS")=NSEG
"RTN","PSJPDCL",72,0)
 .S HLP("SUBSCRIBER")="^^^^~"_PSJDNS_":"_PSJVP_"~DNS"
"RTN","PSJPDCL",73,0)
 .S HLL("LINKS",1)=CNM_"^"_"PSJ PADE",ZZ1=$P(PSJQ(XX),"^",2)
"RTN","PSJPDCL",74,0)
 .S CT=$O(HLA("HLS",9999),-1)+1 S:CT>1 HLA("HLS",CT)="ZZZ"_HL("FS")_ZZ1_HL("FS")_HL("FS")_FTS
"RTN","PSJPDCL",75,0)
 .D PV19^PSJPDAPP
"RTN","PSJPDCL",76,0)
 .D GENERATE^HLMA(SNM,"LM",1,.PSJSND,"",.HLP)
"RTN","PSJPDCL",77,0)
 .S:$G(PSJSND(1)) PSJSND=PSJSND(1)
"RTN","PSJPDCL",78,0)
 .D LOG^PSJPADE
"RTN","PSJPDCL",79,0)
 Q
"RTN","PSJPDCL",80,0)
 ;
"RTN","PSJPDCL",81,0)
TR(SEG) ; Translate the VAFC message delimiters to HL7 delimiters for PADE
"RTN","PSJPDCL",82,0)
 N CSEG
"RTN","PSJPDCL",83,0)
 S CSEG=$TR(SEG,HL("FS")_HL("ECH"),NHL("FS")_NHL("ECH"))
"RTN","PSJPDCL",84,0)
 S CSEG=$TR(CSEG,"""","")
"RTN","PSJPDCL",85,0)
 Q CSEG
"RTN","PSJPDCL",86,0)
 ;
"RTN","PSJPDCL",87,0)
CHKPD(PSJWD,PSJRB) ;
"RTN","PSJPDCL",88,0)
 N PSJWDI S PSJWDI=$O(^DIC(42,"B",PSJWD,"")) K PSJQ
"RTN","PSJPDCL",89,0)
 Q:'PSJWDI 0
"RTN","PSJPDCL",90,0)
 N PSJDIV,PSJDIVI S PSJDIV=+$P($G(^DIC(42,PSJWDI,0)),"^",11)
"RTN","PSJPDCL",91,0)
 Q:'PSJDIV 0
"RTN","PSJPDCL",92,0)
 N PSJPD,PSJSAR,PSJX S (PSJQ,PSJPD)=0
"RTN","PSJPDCL",93,0)
 F  S PSJPD=$O(^PS(58.7,"AD",PSJDIV,PSJPD)) Q:'PSJPD  D
"RTN","PSJPDCL",94,0)
 . Q:'$D(PSJAP(PSJPD)) 
"RTN","PSJPDCL",95,0)
 . S PSJDIVI=$O(^PS(58.7,PSJPD,"DIV","B",PSJDIV,0))
"RTN","PSJPDCL",96,0)
 . Q:'PSJDIVI
"RTN","PSJPDCL",97,0)
 . N DN S DN=$G(^PS(58.7,PSJPD,"DIV",PSJDIVI,0))
"RTN","PSJPDCL",98,0)
 . S PSJACT=$P(DN,"^",2)
"RTN","PSJPDCL",99,0)
 . I PSJACT,PSJACT<DT Q
"RTN","PSJPDCL",100,0)
 . I $G(PSJPDO)=1 N I S I=0 D  Q:I 
"RTN","PSJPDCL",101,0)
 .. I ($P($G(^PS(58.7,PSJPD,"DIV",PSJDIVI,2)),"^"))'="Y" S I=1 Q  ;DON'T SEND ORDER MESSAGES
"RTN","PSJPDCL",102,0)
 .. I $G(RXO)["V",$P(DN,"^",5)'="Y" S I=1 Q  ;DON'T SEND IP IV
"RTN","PSJPDCL",103,0)
 .. I "UV"[$E(RXO,$L(RXO)),($P($G(^(3)),"^")="Y"),'($S(RXO["V":$$CSIV^PSJPDCLA,1:$$CSUD^PSJPDCLA)) S I=1 Q  ;CS ONLY
"RTN","PSJPDCL",104,0)
 . S PSJX=0
"RTN","PSJPDCL",105,0)
 . I $G(PSJRB)]"" D:$O(^DG(405.4,"B",PSJRB,0)) 
"RTN","PSJPDCL",106,0)
 .. N PSJRBI S PSJRBI=$O(^DG(405.4,"B",PSJRB,0))
"RTN","PSJPDCL",107,0)
 .. S PSJSAR=$O(^PS(58.7,PSJPD,"DIV",PSJDIVI,"BG","C",PSJRBI,0))
"RTN","PSJPDCL",108,0)
 .. I PSJSAR D
"RTN","PSJPDCL",109,0)
 ... S PSJSAR=$G(^PS(58.7,PSJPD,"DIV",PSJDIVI,"BG",PSJSAR,2))
"RTN","PSJPDCL",110,0)
 ... I PSJSAR S PSJSAR=$P($G(^PS(58.71,PSJSAR,0)),"^") S:PSJSAR]"" PSJQ(PSJPD)="1^"_PSJSAR,(PSJX,PSJQ)=1
"RTN","PSJPDCL",111,0)
 . Q:PSJX 
"RTN","PSJPDCL",112,0)
 . S PSJSAR=$O(^PS(58.7,PSJPD,"DIV",PSJDIVI,"WD","B",PSJWDI,0))
"RTN","PSJPDCL",113,0)
 . I PSJSAR D
"RTN","PSJPDCL",114,0)
 .. S PSJSAR=$P($G(^PS(58.7,PSJPD,"DIV",PSJDIVI,"WD",PSJSAR,0)),"^",2)
"RTN","PSJPDCL",115,0)
 .. S:PSJSAR PSJSAR=$P($G(^PS(58.71,PSJSAR,0)),"^")
"RTN","PSJPDCL",116,0)
 .. S PSJQ(PSJPD)=1_$S(PSJSAR]"":"^"_PSJSAR,1:""),(PSJX,PSJQ)=1
"RTN","PSJPDCL",117,0)
 . Q:PSJX
"RTN","PSJPDCL",118,0)
 . I $O(^PS(57.5,"AB",PSJWDI,0)) D
"RTN","PSJPDCL",119,0)
 .. S PSJSAR=$O(^PS(57.5,"AB",PSJWDI,0)) Q:'PSJSAR
"RTN","PSJPDCL",120,0)
 .. S PSJSAR=$O(^PS(58.7,PSJPD,"DIV",PSJDIVI,"WG","B",PSJSAR,0))
"RTN","PSJPDCL",121,0)
 .. I PSJSAR S PSJSAR=$P($G(^PS(58.7,PSJPD,"DIV",PSJDIVI,"WG",PSJSAR,0)),"^",2) D
"RTN","PSJPDCL",122,0)
 ... S:PSJSAR PSJSAR=$P($G(^PS(58.71,PSJSAR,0)),"^")
"RTN","PSJPDCL",123,0)
 ... S PSJQ(PSJPD)="1"_$S(PSJSAR]"":"^"_PSJSAR,1:""),(PSJQ,PSJX)=1
"RTN","PSJPDCL",124,0)
 . K:'PSJX PSJAP(PSJPD)
"RTN","PSJPDCL",125,0)
 Q PSJQ
"RTN","PSJPDCL",126,0)
 ;
"RTN","PSJPDCL",127,0)
REACT ;
"RTN","PSJPDCL",128,0)
 N REAC S REAC="",IDX=0
"RTN","PSJPDCL",129,0)
 F  S IDX=$O(ADTL("S",IDX)) Q:IDX=""  D
"RTN","PSJPDCL",130,0)
 . I IDX>1 S REAC=REAC_NECH_$G(ADTL("S",IDX))
"RTN","PSJPDCL",131,0)
 . E  S REAC=$G(ADTL("S",IDX))
"RTN","PSJPDCL",132,0)
 S:REAC]"" $P(SEG,NFS,6)=REAC
"RTN","PSJPDCL",133,0)
 Q
"RTN","PSJPDCL",134,0)
 ;
"RTN","PSJPDCL",135,0)
AGY ;
"RTN","PSJPDCL",136,0)
 N SEG,GMRA,GMRAL
"RTN","PSJPDCL",137,0)
 S GMRA="0^0^111" D ^GMRADPT
"RTN","PSJPDCL",138,0)
 I GMRAL="" G OBX
"RTN","PSJPDCL",139,0)
 ;No known
"RTN","PSJPDCL",140,0)
 I GMRAL=0 D
"RTN","PSJPDCL",141,0)
 .S $P(SEG,NFS,1)="AL1"
"RTN","PSJPDCL",142,0)
 .S $P(SEG,NFS,2)=1
"RTN","PSJPDCL",143,0)
 .S $P(SEG,NFS,3)="OA"
"RTN","PSJPDCL",144,0)
 .S $P(SEG,NFS,4)="0;GMRD(120.82,"_NECH_"NO KNOWN ALLERGIES"
"RTN","PSJPDCL",145,0)
 .S $P(SEG,NFS,6)=""
"RTN","PSJPDCL",146,0)
 .S $P(SEG,NFS,7)=$$FMTHL7^XLFDT($$GET1^DIQ(120.86,DFN,3,"I"))
"RTN","PSJPDCL",147,0)
 .S SEQ=SEQ+1
"RTN","PSJPDCL",148,0)
 .S NSEG(SEQ)=SEG
"RTN","PSJPDCL",149,0)
 ;
"RTN","PSJPDCL",150,0)
 ;Yes, allergies
"RTN","PSJPDCL",151,0)
 I GMRAL=1 N KK,ACT,AEXT,ND D
"RTN","PSJPDCL",152,0)
 .S KK=0,ACT=0
"RTN","PSJPDCL",153,0)
 .F  S KK=$O(GMRAL(KK)) Q:'KK  D
"RTN","PSJPDCL",154,0)
 ..S ND=GMRAL(KK)
"RTN","PSJPDCL",155,0)
 ..S AEXT=$P(ND,U,2)
"RTN","PSJPDCL",156,0)
 ..S ACT=ACT+1
"RTN","PSJPDCL",157,0)
 ..S $P(SEG,NFS,1)="AL1"
"RTN","PSJPDCL",158,0)
 ..S $P(SEG,NFS,2)=ACT
"RTN","PSJPDCL",159,0)
 ..S $P(SEG,NFS,3)=$S($P(ND,U,3)="D":"DA",$P(ND,U,3)="F":"FA",1:"OA")
"RTN","PSJPDCL",160,0)
 ..S $P(SEG,NFS,4)=$P(ND,U,9)_NECH_AEXT
"RTN","PSJPDCL",161,0)
 ..N ADTL D EN1^GMRAOR2(KK,"ADTL") D:$O(ADTL("O",""))
"RTN","PSJPDCL",162,0)
 ... N IDX,SEV
"RTN","PSJPDCL",163,0)
 ... S IDX=$O(ADTL("O","")),SEV=$P($G(ADTL("O",IDX)),"^",2)
"RTN","PSJPDCL",164,0)
 ... S SEV=$S(SEV="MILD":"MI",SEV="MODERATE":"MO",SEV="SEVERE":"SV",1:"U")
"RTN","PSJPDCL",165,0)
 ... S $P(SEG,NFS,5)=SEV
"RTN","PSJPDCL",166,0)
 ..D:$O(ADTL("S","")) REACT
"RTN","PSJPDCL",167,0)
 ..S $P(SEG,NFS,7)=$$FMTHL7^XLFDT($$GET1^DIQ(120.8,KK,4,"I"))
"RTN","PSJPDCL",168,0)
 ..S SEQ=SEQ+1
"RTN","PSJPDCL",169,0)
 ..S NSEG(SEQ)=SEG,SEG=""
"RTN","PSJPDCL",170,0)
OBX ;HT,WT
"RTN","PSJPDCL",171,0)
 N GMRVSTR
"RTN","PSJPDCL",172,0)
 S GMRVSTR="HT" D EN6^GMRVUTL
"RTN","PSJPDCL",173,0)
 I X]"" S $P(SEG,NFS,1)="OBX",$P(SEG,NFS,2)=1,$P(SEG,NFS,3)="CE",$P(SEG,NFS,4)="1010.3"_NECH_"HEIGHT" D
"RTN","PSJPDCL",174,0)
 .S $P(SEG,NFS,6)=$J($P(X,U,8)*2.54,0,2),$P(SEG,NFS,7)="cm"
"RTN","PSJPDCL",175,0)
 .S $P(SEG,NFS,15)=$$HLDATE^HLFNC($P(X,U))
"RTN","PSJPDCL",176,0)
 .S SEQ=SEQ+1
"RTN","PSJPDCL",177,0)
 .S NSEG(SEQ)=SEG,SEG=""
"RTN","PSJPDCL",178,0)
 S GMRVSTR="WT" D EN6^GMRVUTL
"RTN","PSJPDCL",179,0)
 I X]"" S $P(SEG,NFS,1)="OBX",$P(SEG,NFS,2)=2,$P(SEG,NFS,3)="CE",$P(SEG,NFS,4)="1010.1"_NECH_"WEIGHT" D
"RTN","PSJPDCL",180,0)
 .S $P(SEG,NFS,6)=$J($P(X,U,8)/2.2046226,0,2),$P(SEG,NFS,7)="kg"
"RTN","PSJPDCL",181,0)
 .S $P(SEG,NFS,15)=$$HLDATE^HLFNC($P(X,"^"))
"RTN","PSJPDCL",182,0)
 .S SEQ=SEQ+1
"RTN","PSJPDCL",183,0)
 .S NSEG(SEQ)=SEG,SEG=""
"RTN","PSJPDCL",184,0)
 Q
"RTN","PSJPDCL",185,0)
 ;
"RTN","PSJPDCL",186,0)
A08 ;
"RTN","PSJPDCL",187,0)
 K ^TMP("A08")
"RTN","PSJPDCL",188,0)
 M ^TMP("A08","HLS")=^TMP("HLS",$J)
"RTN","PSJPDCL",189,0)
 M ^TMP("A08","HL")=HL
"RTN","PSJPDCL",190,0)
 Q:$O(^PS(58.7,"B",""))=""
"RTN","PSJPDCL",191,0)
 Q:$D(HL)=1
"RTN","PSJPDCL",192,0)
 Q:'$D(^TMP("HLS",$J))
"RTN","PSJPDCL",193,0)
 N XX,HLN,PSJND,PSJCLN,PSJCLNI,PSJDIV,PSJX S (PSJX,XX)=0
"RTN","PSJPDCL",194,0)
 F  S XX=$O(^TMP("HLS",$J,XX)) Q:'XX!(PSJX)  D
"RTN","PSJPDCL",195,0)
 . S HLN=^TMP("HLS",$J,XX)
"RTN","PSJPDCL",196,0)
 . I $E(HLN,1,3)="PV1" D
"RTN","PSJPDCL",197,0)
 .. S PSJCLN=$P(HLN,FS,4)
"RTN","PSJPDCL",198,0)
 .. S PSJCLNI=$O(^SC("B",PSJCLN,0))
"RTN","PSJPDCL",199,0)
 .. I 'PSJCLNI S PSJX=1 Q
"RTN","PSJPDCL",200,0)
 .. S PSJDIV=$P($G(^SC(PSJCLNI,0)),"^",15)
"RTN","PSJPDCL",201,0)
 .. I 'PSJDIV S PSJX=1 Q
"RTN","PSJPDCL",202,0)
 .. N PSJPD,PSJSAR,PSJQ S (PSJQ,PSJPD)=0
"RTN","PSJPDCL",203,0)
 .. F  S PSJPD=$O(^PS(58.7,"AD",PSJDIV,PSJPD)) Q:'PSJPD  D
"RTN","PSJPDCL",204,0)
 ... I '$D(^PS(58.7,PSJPD,0)) Q
"RTN","PSJPDCL",205,0)
 ... N PSJVNM,PSJDNS,PSJVP,PSJACT S PSJND=$G(^PS(58.7,PSJPD,0))
"RTN","PSJPDCL",206,0)
 ... S PSJVNM=$P(PSJND,"^"),PSJDNS=$P(PSJND,"^",2),PSJVP=$P(PSJND,"^",3)
"RTN","PSJPDCL",207,0)
 ... I PSJVNM=""!(PSJDNS="")!('PSJVP) Q
"RTN","PSJPDCL",208,0)
 ... S PSJACT=$P(PSJND,"^",4)
"RTN","PSJPDCL",209,0)
 ... I PSJACT&(PSJACT<DT) Q
"RTN","PSJPDCL",210,0)
 ... S PSJDIVI=$O(^PS(58.7,PSJPD,"DIV","B",PSJDIV,0))
"RTN","PSJPDCL",211,0)
 ... S PSJACT=$G(^PS(58.7,PSJPD,"DIV",PSJDIVI,0))
"RTN","PSJPDCL",212,0)
 ... S PSJACT=$P(PSJACT,"^",2)
"RTN","PSJPDCL",213,0)
 ... I PSJACT,PSJACT<DT Q
"RTN","PSJPDCL",214,0)
 ... S PSJQ=1,PSJQ(PSJPD)=1
"RTN","PSJPDCL",215,0)
 Q:'PSJQ 
"RTN","PSJPDCL",216,0)
 N SNM,SID S SNM="PSJ ADT-A08 SERVER"
"RTN","PSJPDCL",217,0)
 S SID=$O(^ORD(101,"B",SNM,0))
"RTN","PSJPDCL",218,0)
 Q:'SID
"RTN","PSJPDCL",219,0)
 D INIT^HLFNC2(SID,.NHL) Q:$D(NHL)=1
"RTN","PSJPDCL",220,0)
 N NFS,NECH S NFS=NHL("FS"),NECH=$E(NHL("ECH"),1)
"RTN","PSJPDCL",221,0)
 Q
"RTN","PSJPDCL",222,0)
 ;
"VER")
8.0^22.2
**INSTALL NAME**
OR*3.0*469
"BLD",9891,0)
OR*3.0*469^ORDER ENTRY/RESULTS REPORTING^0^3180104^y
"BLD",9891,1,0)
^^1^1^3170919^
"BLD",9891,1,1,0)
MOCHA 2.1 follow-up
"BLD",9891,4,0)
^9.64PA^^
"BLD",9891,6.3)
3
"BLD",9891,"KRN",0)
^9.67PA^779.2^20
"BLD",9891,"KRN",.4,0)
.4
"BLD",9891,"KRN",.401,0)
.401
"BLD",9891,"KRN",.402,0)
.402
"BLD",9891,"KRN",.403,0)
.403
"BLD",9891,"KRN",.5,0)
.5
"BLD",9891,"KRN",.84,0)
.84
"BLD",9891,"KRN",3.6,0)
3.6
"BLD",9891,"KRN",3.8,0)
3.8
"BLD",9891,"KRN",9.2,0)
9.2
"BLD",9891,"KRN",9.8,0)
9.8
"BLD",9891,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",9891,"KRN",9.8,"NM",1,0)
ORKPS^^0^B104632974
"BLD",9891,"KRN",9.8,"NM",2,0)
ORKPS1^^0^B108794510
"BLD",9891,"KRN",9.8,"NM",3,0)
ORKCHK6^^0^B28136818
"BLD",9891,"KRN",9.8,"NM",4,0)
ORWDXC^^0^B77488724
"BLD",9891,"KRN",9.8,"NM","B","ORKCHK6",3)

"BLD",9891,"KRN",9.8,"NM","B","ORKPS",1)

"BLD",9891,"KRN",9.8,"NM","B","ORKPS1",2)

"BLD",9891,"KRN",9.8,"NM","B","ORWDXC",4)

"BLD",9891,"KRN",19,0)
19
"BLD",9891,"KRN",19.1,0)
19.1
"BLD",9891,"KRN",101,0)
101
"BLD",9891,"KRN",409.61,0)
409.61
"BLD",9891,"KRN",771,0)
771
"BLD",9891,"KRN",779.2,0)
779.2
"BLD",9891,"KRN",870,0)
870
"BLD",9891,"KRN",8989.51,0)
8989.51
"BLD",9891,"KRN",8989.52,0)
8989.52
"BLD",9891,"KRN",8994,0)
8994
"BLD",9891,"KRN","B",.4,.4)

"BLD",9891,"KRN","B",.401,.401)

"BLD",9891,"KRN","B",.402,.402)

"BLD",9891,"KRN","B",.403,.403)

"BLD",9891,"KRN","B",.5,.5)

"BLD",9891,"KRN","B",.84,.84)

"BLD",9891,"KRN","B",3.6,3.6)

"BLD",9891,"KRN","B",3.8,3.8)

"BLD",9891,"KRN","B",9.2,9.2)

"BLD",9891,"KRN","B",9.8,9.8)

"BLD",9891,"KRN","B",19,19)

"BLD",9891,"KRN","B",19.1,19.1)

"BLD",9891,"KRN","B",101,101)

"BLD",9891,"KRN","B",409.61,409.61)

"BLD",9891,"KRN","B",771,771)

"BLD",9891,"KRN","B",779.2,779.2)

"BLD",9891,"KRN","B",870,870)

"BLD",9891,"KRN","B",8989.51,8989.51)

"BLD",9891,"KRN","B",8989.52,8989.52)

"BLD",9891,"KRN","B",8994,8994)

"BLD",9891,"QUES",0)
^9.62^^
"BLD",9891,"REQB",0)
^9.611^3^3
"BLD",9891,"REQB",1,0)
OR*3.0*382^2
"BLD",9891,"REQB",2,0)
OR*3.0*269^2
"BLD",9891,"REQB",3,0)
OR*3.0*457^2
"BLD",9891,"REQB","B","OR*3.0*269",2)

"BLD",9891,"REQB","B","OR*3.0*382",1)

"BLD",9891,"REQB","B","OR*3.0*457",3)

"MBREQ")
1
"PKG",170,-1)
1^1
"PKG",170,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",170,22,0)
^9.49I^1^1
"PKG",170,22,1,0)
3.0^2971217^2980917^11712
"PKG",170,22,1,"PAH",1,0)
469^3180104
"PKG",170,22,1,"PAH",1,1,0)
^^1^1^3180104
"PKG",170,22,1,"PAH",1,1,1,0)
MOCHA 2.1 follow-up
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","ORKCHK6")
0^3^B28136818
"RTN","ORKCHK6",1,0)
ORKCHK6 ; SLC/CLA - Support routine called by ORKCHK to do SESSION mode order checks ;12/14/17  09:01
"RTN","ORKCHK6",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,87,94,123,162,190,249,280,272,346,345,269,469**;Dec 17, 1997;Build 3
"RTN","ORKCHK6",3,0)
 Q
"RTN","ORKCHK6",4,0)
 ;
"RTN","ORKCHK6",5,0)
EN(ORKS,ORKDFN,ORKA,ORENT,ORKTMODE) ;perform order checking for entire ordering session
"RTN","ORKCHK6",6,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE",1,"I")="D"
"RTN","ORKCHK6",7,0)
 ;
"RTN","ORKCHK6",8,0)
 N OI,ORKDG,HL7,ODT,ORNUM,HL7NPTR,HL7NTXT,HL7NCOD,HL7LPTR,HL7LTXT,HL7LCOD
"RTN","ORKCHK6",9,0)
 N ORKMSG,ORKDGI,ORKTXT,ORKPDATA,ORIFN
"RTN","ORKCHK6",10,0)
 ;
"RTN","ORKCHK6",11,0)
 S OI=$P(ORKA,"|"),ORKDG=$P(ORKA,"|",2),HL7=$P(ORKA,"|",3)
"RTN","ORKCHK6",12,0)
 S ODT=$P(ORKA,"|",4),ORNUM=$P(ORKA,"|",5),ORKPDATA=$P(ORKA,"|",6)
"RTN","ORKCHK6",13,0)
 S HL7NPTR=$P(HL7,U),HL7NTXT=$P(HL7,U,2),HL7NCOD=$P(HL7,U,3)
"RTN","ORKCHK6",14,0)
 S HL7LPTR=$P(HL7,U,4),HL7LTXT=$P(HL7,U,5),HL7LCOD=$P(HL7,U,6)
"RTN","ORKCHK6",15,0)
 S ORIFN=ORNUM
"RTN","ORKCHK6",16,0)
 ;
"RTN","ORKCHK6",17,0)
 S:ORKDG="PSJ" ORKDG="PSI"
"RTN","ORKCHK6",18,0)
 I $E(ORKDG,1,2)="PS" D PHARM
"RTN","ORKCHK6",19,0)
 I $E(ORKDG,1,2)'="PS" D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",20,0)
 Q
"RTN","ORKCHK6",21,0)
 ;
"RTN","ORKCHK6",22,0)
PHARM ;process pharmacy order checks:
"RTN","ORKCHK6",23,0)
 N ORPSPKG,ORPSA,ORRXDONE
"RTN","ORKCHK6",24,0)
 N ORCRITN,ORCRITF,ORCRITD,ORSIGN,ORSIGF,ORSIGD,ORDUPN,ORDUPF,ORDUPD,ORDUPC,ORDUPCF,ORDUPCD,ORALLRN,ORALLRF,ORALLRD,ORDUPCN
"RTN","ORKCHK6",25,0)
 ;
"RTN","ORKCHK6",26,0)
 D PARAMS("ALLERGY-DRUG INTERACTION",.ORALLRN,.ORALLRF,.ORALLRD)
"RTN","ORKCHK6",27,0)
 D PARAMS("CRITICAL DRUG INTERACTION",.ORCRITN,.ORCRITF,.ORCRITD)
"RTN","ORKCHK6",28,0)
 D PARAMS("SIGNIFICANT DRUG INTERACTION",.ORSIGN,.ORSIGF,.ORSIGD)
"RTN","ORKCHK6",29,0)
 D PARAMS("DUPLICATE DRUG ORDER",.ORDUPN,.ORDUPF,.ORDUPD)
"RTN","ORKCHK6",30,0)
 D PARAMS("DUPLICATE DRUG THERAPY",.ORDUPCN,.ORDUPCF,.ORDUPCD)
"RTN","ORKCHK6",31,0)
 ;
"RTN","ORKCHK6",32,0)
 S ORRXDONE=0 ;flag to set if RXOCS gets called
"RTN","ORKCHK6",33,0)
 ;dispense drug selected:
"RTN","ORKCHK6",34,0)
 I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK6",35,0)
 .D RXOCS
"RTN","ORKCHK6",36,0)
 .S:$P(ORKA,"|",7)'="" $P(ORKA,"|",7)=""
"RTN","ORKCHK6",37,0)
 .S ORRXDONE=1
"RTN","ORKCHK6",38,0)
 .D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",39,0)
 ;
"RTN","ORKCHK6",40,0)
 ;dispense drug NOT selected, split OI into dispense drugs:
"RTN","ORKCHK6",41,0)
 I '$L($G(HL7LPTR)) D
"RTN","ORKCHK6",42,0)
 .S ORPSPKG=$E(ORKDG,3)
"RTN","ORKCHK6",43,0)
 .I "IOH"[ORPSPKG D
"RTN","ORKCHK6",44,0)
 ..S ORPSA=$$OI2DD^ORKPS(OI,ORPSPKG,1)
"RTN","ORKCHK6",45,0)
 ..I +ORPSA D
"RTN","ORKCHK6",46,0)
 ...S HL7LTXT=$P($G(^ORD(101.43,OI,0)),U)
"RTN","ORKCHK6",47,0)
 ...S HL7NPTR=$P(ORPSA,";",2)
"RTN","ORKCHK6",48,0)
 ...S HL7LPTR=+ORPSA
"RTN","ORKCHK6",49,0)
 ...S HL7LCOD="99PSD",HL7NCOD="99NDF"
"RTN","ORKCHK6",50,0)
 ...S $P(HL7,U)=HL7NPTR,$P(HL7,U,3)=HL7NCOD
"RTN","ORKCHK6",51,0)
 ...S $P(HL7,U,4)=HL7LPTR,$P(HL7,U,5)=HL7LTXT,$P(HL7,U,6)=HL7LCOD
"RTN","ORKCHK6",52,0)
 ...S $P(ORKA,"|",3)=HL7  ;set these for MLM OCX call
"RTN","ORKCHK6",53,0)
 ..D RXOCS
"RTN","ORKCHK6",54,0)
 ..S:$P(ORKA,"|",7)'="" $P(ORKA,"|",7)=""
"RTN","ORKCHK6",55,0)
 ..S ORRXDONE=1
"RTN","ORKCHK6",56,0)
 ..Q:HL7LTXT=""
"RTN","ORKCHK6",57,0)
 ..D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",58,0)
 I ORRXDONE=0 D
"RTN","ORKCHK6",59,0)
 .N ORKSMSG,OROITXT
"RTN","ORKCHK6",60,0)
 .S OROITXT=$P($G(^ORD(101.43,OI,0)),U)
"RTN","ORKCHK6",61,0)
 .I $L(OROITXT)>0 S OROITXT=" for "_$$TRIM^XLFSTR(OROITXT)
"RTN","ORKCHK6",62,0)
 .S ORKMSG="Enhanced order checks cannot be done"_OROITXT_". Please perform a manual check for Drug-Interactions, Duplicate Therapy"
"RTN","ORKCHK6",63,0)
 .I $$DS^PSSDSAPI S ORKMSG=ORKMSG_" and Dosing"
"RTN","ORKCHK6",64,0)
 .S ORKS("ORK",2_$E(ORKMSG,1,225))=ORNUM_U_25_U_3_U_ORKMSG
"RTN","ORKCHK6",65,0)
 Q
"RTN","ORKCHK6",66,0)
 ;
"RTN","ORKCHK6",67,0)
RXOCS ;drug-drug interaction, duplicate drug order, duplicate drug class
"RTN","ORKCHK6",68,0)
 Q:ORCRITF_ORSIGF_ORDUPF_ORDUPCF_ORALLRF'["E"  ;quit if none are "E"nabled
"RTN","ORKCHK6",69,0)
 N ORKRX,ORPSNUM,ORY,CHK,XX
"RTN","ORKCHK6",70,0)
 ;I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK6",71,0)
 I 1 D
"RTN","ORKCHK6",72,0)
 .D CHKSESS^ORKPS(.ORKRX,ORKDFN,HL7LPTR_U_HL7LTXT,OI,ORKPDATA,ORKDG,+$P($G(ORPSA),";",4),$P(ORKA,"|",7))
"RTN","ORKCHK6",73,0)
 .S CHK=0,XX="" F  S CHK=$O(ORKRX(CHK)) Q:'CHK  D
"RTN","ORKCHK6",74,0)
 ..S XX=ORKRX(CHK)
"RTN","ORKCHK6",75,0)
 ..;
"RTN","ORKCHK6",76,0)
 ..;get errors/exceptions/checks not done
"RTN","ORKCHK6",77,0)
 ..I $P(XX,U)="ERR" S ORKS("ORK",2_$E($P(XX,U,2),1,225)_","_$G(ORNUM))=ORNUM_U_25_U_3_U_$P(XX,U,2)
"RTN","ORKCHK6",78,0)
 ..;
"RTN","ORKCHK6",79,0)
 ..;critical drug interaction:
"RTN","ORKCHK6",80,0)
 ..I $P(XX,U)="DI",$P(XX,U,2)="CRITICAL" D
"RTN","ORKCHK6",81,0)
 ...Q:ORCRITF="D"
"RTN","ORKCHK6",82,0)
 ...S ORPSNUM=$P(XX,U,3)
"RTN","ORKCHK6",83,0)
 ...S ORKTXT=$P(XX,U,2)_" drug-drug interaction: "_$P(XX,U,5)
"RTN","ORKCHK6",84,0)
 ...S ORKS("ORK",ORCRITD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKTXT,1,225))=ORNUM_U_ORCRITN_U_ORCRITD_U_ORKTXT
"RTN","ORKCHK6",85,0)
 ..;
"RTN","ORKCHK6",86,0)
 ..;significant drug interaction:
"RTN","ORKCHK6",87,0)
 ..I $P(XX,U)="DI",$P(XX,U,2)="SIGNIFICANT" D
"RTN","ORKCHK6",88,0)
 ...Q:ORSIGF="D"
"RTN","ORKCHK6",89,0)
 ...S ORPSNUM=$P(XX,U,3)
"RTN","ORKCHK6",90,0)
 ...S ORKTXT=$P(XX,U,2)_" drug-drug interaction: "_$P(XX,U,5)
"RTN","ORKCHK6",91,0)
 ...S ORKS("ORK",ORSIGD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKTXT,1,225))=ORNUM_U_ORSIGN_U_ORSIGD_U_ORKTXT
"RTN","ORKCHK6",92,0)
 ..;
"RTN","ORKCHK6",93,0)
 ..;duplicate drug:
"RTN","ORKCHK6",94,0)
 ..I $P(XX,U)="DD" D
"RTN","ORKCHK6",95,0)
 ...Q:ORDUPF="D"
"RTN","ORKCHK6",96,0)
 ...S ORPSNUM=$P(XX,U,4)  ;get the associated order number
"RTN","ORKCHK6",97,0)
 ...S ORKTXT=$P(XX,U,3)
"RTN","ORKCHK6",98,0)
 ...I $L(ORPSNUM),$G(^OR(100,+ORPSNUM,0)) D
"RTN","ORKCHK6",99,0)
 ....D TEXT^ORQ12(.ORY,ORPSNUM,"")
"RTN","ORKCHK6",100,0)
 ....S ORKTXT=ORKTXT_$S($D(ORY(2))=1:" "_$$TRIM^XLFSTR(ORY(2)),1:"")_" ["_$P($G(^ORD(100.01,+$P(^OR(100,+ORPSNUM,3),U,3),0)),U,1)_"]"
"RTN","ORKCHK6",101,0)
 ...S ORKMSG="Duplicate drug order: "_ORKTXT
"RTN","ORKCHK6",102,0)
 ...S ORKS("ORK",ORDUPD_","_$G(ORNUM)_","_ORPSNUM_",Duplicate drug order: "_$E($P(XX,U,3),1,200))=ORNUM_U_ORDUPN_U_ORDUPD_U_ORKMSG_U_$G(ORPSNUM)
"RTN","ORKCHK6",103,0)
 ..;
"RTN","ORKCHK6",104,0)
 ..;duplicate class: NOW DRUG THERAPY
"RTN","ORKCHK6",105,0)
 ..I $P(XX,U)="DC" D
"RTN","ORKCHK6",106,0)
 ...Q:ORDUPCF="D"
"RTN","ORKCHK6",107,0)
 ...S ORPSNUM=$P(XX,U,2)  ;get the associated order number
"RTN","ORKCHK6",108,0)
 ...S ORKMSG=$P(XX,U,4)
"RTN","ORKCHK6",109,0)
 ...S ORKS("ORK",ORDUPCD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKMSG,1,225))=ORNUM_U_ORDUPCN_U_ORDUPCD_U_ORKMSG
"RTN","ORKCHK6",110,0)
 D RXOCS^ORKCHK5
"RTN","ORKCHK6",111,0)
 Q
"RTN","ORKCHK6",112,0)
 ;
"RTN","ORKCHK6",113,0)
PARAMS(ORKNAME,ORKNUM,ORKFLAG,ORKDNGR) ; get parameter values for an order chk
"RTN","ORKCHK6",114,0)
 S ORKNUM=0,ORKNUM=$O(^ORD(100.8,"B",ORKNAME,ORKNUM))
"RTN","ORKCHK6",115,0)
 S ORKFLAG=$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",ORKNUM,"I")
"RTN","ORKCHK6",116,0)
 S ORKDNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",ORKNUM,"I")
"RTN","ORKCHK6",117,0)
 Q
"RTN","ORKPS")
0^1^B104632974
"RTN","ORKPS",1,0)
ORKPS ; slc/CLA - Order checking support procedures for medications ;12/29/17  11:58
"RTN","ORKPS",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,94,123,141,190,232,316,272,346,345,382,469**;Dec 17, 1997;Build 3
"RTN","ORKPS",3,0)
 Q
"RTN","ORKPS",4,0)
CHECK(YY,DFN,MED,OI,ORKDG,OROIL,ORSUPPLY,ORIVTYPE,ORIVRAN,ORDODSG) ; return drug order checks
"RTN","ORKPS",5,0)
 ;YY:    returned array of data
"RTN","ORKPS",6,0)
 ;DFN:   patient id
"RTN","ORKPS",7,0)
 ;MED:   drug ien [file #50] ^ generic name [file #50]
"RTN","ORKPS",8,0)
 ;OI:    orderable item ien [file #101.43]
"RTN","ORKPS",9,0)
 ;ORKDG: display group (should be PSI, PSIV, PSO or PSH)
"RTN","ORKPS",10,0)
 ;OROIL: list of items ordered
"RTN","ORKPS",11,0)
 ;ORSUPPLY: pharmacy orderable item ien [file #50.7] if it resolves to one or more supply items
"RTN","ORKPS",12,0)
 ;          0 if the pharmacy orderable item does not resolve to any supply items
"RTN","ORKPS",13,0)
 ;ORIVTYPE: the MED type as sent from Infusion Order Dialog
"RTN","ORKPS",14,0)
 ;          A for additive
"RTN","ORKPS",15,0)
 ;          B for base
"RTN","ORKPS",16,0)
 ;ORIVRAN: FLAG THAT DENOTES IF ALL COMPONENTS OF INFUSION ORDER HAVE ALREADY BEEN PROCESSED
"RTN","ORKPS",17,0)
 ;         1 FOR ALREADY PROCESSED
"RTN","ORKPS",18,0)
 ;         EMPTY STRING FOR NOT YET PROCESSED
"RTN","ORKPS",19,0)
 ;ORDODSG: FLAG THAT DENOTES IF DOSAGE CHECKS SHOULD BE PERFORMED
"RTN","ORKPS",20,0)
 ;         1 FOR PERFORM DOSAGE CHECKS
"RTN","ORKPS",21,0)
 ;         0 FOR DO NOT PERFORM DOSAGE CHECKS
"RTN","ORKPS",22,0)
 ; returned info: varies for ^TMP($J x-ref - refer to listings below
"RTN","ORKPS",23,0)
 N OR2CRITN,OR2CRITF,OR2CRITD,OR2SIGN,OR2SIGF,OR2SIGD,OR2DUPN,OR2DUPF,OR2DUPD,OR2DUPCN,OR2DUPCF,OR2DUPCD
"RTN","ORKPS",24,0)
 N ORPHDG,ORKSOIA,ORDOCHKS
"RTN","ORKPS",25,0)
 D PARAMS^ORKCHK6("CRITICAL DRUG INTERACTION",.OR2CRITN,.OR2CRITF,.OR2CRITD)
"RTN","ORKPS",26,0)
 D PARAMS^ORKCHK6("SIGNIFICANT DRUG INTERACTION",.OR2SIGN,.OR2SIGF,.OR2SIGD)
"RTN","ORKPS",27,0)
 D PARAMS^ORKCHK6("DUPLICATE DRUG THERAPY",.OR2DUPCN,.OR2DUPCF,.OR2DUPCD)
"RTN","ORKPS",28,0)
 N ORDFN,ORKA,ORPTY,ORPHOI,OROILI,ORKAI S ORDFN=DFN
"RTN","ORKPS",29,0)
 S ORPHOI=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORKPS",30,0)
 S ORPTY=$S($G(ORKDG)="PSI":"I;",$G(ORKDG)="PSIV":"I;",$G(ORKDG)="PSO":"O;",$G(ORKDG)="PSH":"O;",1:"O;")
"RTN","ORKPS",31,0)
 S ORPHDG=$S(ORKDG="PSI":"U",ORKDG="PSIV":"I",ORKDG="PSO":"O",ORKDG="PSH":"N",1:"")
"RTN","ORKPS",32,0)
 I $G(ORIVTYPE)'="A" D  Q:'ORDOCHKS  ; Don't do checks if pharmacy does not want us to
"RTN","ORKPS",33,0)
 .S ORDOCHKS=$$PRE^PSSDSAPK(ORPHOI,ORPHDG)
"RTN","ORKPS",34,0)
 .S:'ORDODSG ORDODSG=ORDOCHKS
"RTN","ORKPS",35,0)
 S:$G(ORIVTYPE)="A" ORDODSG=1
"RTN","ORKPS",36,0)
 I +MED,('ORIVRAN) S ORKA(1)=MED_U_$$GETPSNM(+MED),ORKAI=1
"RTN","ORKPS",37,0)
 ;ADD ALL COMPONENTS OF IV ORDER SO WE ONLY HAVE TO DO A SINGLE PRE CALL
"RTN","ORKPS",38,0)
 I ORKDG="PSIV",('ORIVRAN) D
"RTN","ORKPS",39,0)
 .S ORIVRAN=1,OROILI=0 F  S OROILI=$O(OROIL(OROILI)) Q:'OROILI  D
"RTN","ORKPS",40,0)
 ..N OR2OI,OR2PSOI,OR2PHDG
"RTN","ORKPS",41,0)
 ..I 'OROIL(OROILI) Q
"RTN","ORKPS",42,0)
 ..I +OROIL(OROILI)=OI Q
"RTN","ORKPS",43,0)
 ..S OR2OI=+OROIL(OROILI)
"RTN","ORKPS",44,0)
 ..S OR2PSOI=+$P($G(^ORD(101.43,+OR2OI,0)),U,2)
"RTN","ORKPS",45,0)
 ..S OR2PHDG=$P(OROIL(OROILI),U,2)
"RTN","ORKPS",46,0)
 ..S OR2PHDG=$S(OR2PHDG="PSI":"U",OR2PHDG="PSIV":"I",OR2PHDG="PSO":"O",OR2PHDG="PSH":"N",1:"")
"RTN","ORKPS",47,0)
 ..Q:OR2PHDG'="I"
"RTN","ORKPS",48,0)
 ..I $P($P(OROIL(OROILI),U,3),";")="B",$$PRE^PSSDSAPK(OR2PSOI,OR2PHDG)=0 Q
"RTN","ORKPS",49,0)
 ..I $P($P(OROIL(OROILI),U,3),";")="B",$P($P(OROIL(OROILI),U,3),";",2)="",$G(ORREN)=1 D
"RTN","ORKPS",50,0)
 ...N ORVOLID,ORVOLVAL S ORVOLVAL="",ORVOLID=$O(^OR(100,+$G(ORIFN),4.5,"ID","VOLUME",""))
"RTN","ORKPS",51,0)
 ...I ORVOLID>0 S ORVOLVAL=$G(^OR(100,+$G(ORIFN),4.5,ORVOLID,1))
"RTN","ORKPS",52,0)
 ...S OROIL(OROILI)=OROIL(OROILI)_ORVOLVAL
"RTN","ORKPS",53,0)
 ..N ORUSID
"RTN","ORKPS",54,0)
 ..S ORUSID=$$USID^ORWDXC(OROIL(OROILI))
"RTN","ORKPS",55,0)
 ..S ORKAI=ORKAI+1,ORKA(ORKAI)=$P(ORUSID,U,4)_U_$$GETPSNM($P(ORUSID,U,4))
"RTN","ORKPS",56,0)
 D:$D(ORKA) CPRS^PSODDPR4(ORDFN,"OROCOUT"_ORPTY,.ORKA,ORPTY_+$G(^OR(100,+$G(ORIFN),4)))
"RTN","ORKPS",57,0)
 I +ORSUPPLY D
"RTN","ORKPS",58,0)
 .S ORKSOIA(+ORSUPPLY)=$G(ORIFN)
"RTN","ORKPS",59,0)
 .D CPRS^PSODDPR8(ORDFN,"OROCOUT"_ORPTY,.ORKSOIA,ORPHDG_";"_+$G(^OR(100,+$G(ORNUM),4)),$S($D(ORKA):1,1:""))
"RTN","ORKPS",60,0)
 I $D(ORKA)!($D(ORKSOIA))!(ORIVRAN) D
"RTN","ORKPS",61,0)
 .S:OR2CRITF_OR2SIGF_OR2DUPCF["E" ^TMP($J,"ORENHCHK")=1
"RTN","ORKPS",62,0)
 .D PROCESS^ORKPS1(OI,ORDFN,ORKDG,+ORSUPPLY_U_+MED,"OROCOUT"_ORPTY)
"RTN","ORKPS",63,0)
 Q
"RTN","ORKPS",64,0)
CHKSESS(YY,DFN,MED,OI,ORKPDATA,ORKDG,ORSUPPLY,ORIVTYPE) ; return drug order checks for session
"RTN","ORKPS",65,0)
 ;ORSUPPLY: pharmacy orderable item ien [file #50.7] if it resolves to one or more supply items
"RTN","ORKPS",66,0)
 ;          0 if the pharmacy orderable item does not resolve to any supply items
"RTN","ORKPS",67,0)
 ;ORIVTYPE: the MED type as sent from Infusion Order Dialog
"RTN","ORKPS",68,0)
 ;          A for additive
"RTN","ORKPS",69,0)
 ;          B for base
"RTN","ORKPS",70,0)
 N ORKDGI,ORKDRUG,ORKDRUGA,ORKORN,HOR,SEQ,CNT,CNTX,ORKOI,ORPHOI
"RTN","ORKPS",71,0)
 N ORKFLG,ORSESS,ORPSPKG,ORPSA,ORSNUM,ORNUM,DUPX,DUPORN,ORPTY
"RTN","ORKPS",72,0)
 N ORKSOIA,ORRET,ORDFN,ORPHDG S ORDFN=DFN
"RTN","ORKPS",73,0)
 S ORPTY=$S($G(ORKDG)="PSI":"I;",$G(ORKDG)="PSIV":"I;",$G(ORKDG)="PSO":"O;",$G(ORKDG)="PSH":"O;",1:"O;")
"RTN","ORKPS",74,0)
 S ORPHDG=$S(ORKDG="PSI":"U",ORKDG="PSIV":"I",ORKDG="PSO":"O",ORKDG="PSH":"N",1:"")
"RTN","ORKPS",75,0)
 I '$D(^TMP($J,"OROCOUT"_ORPTY)) D
"RTN","ORKPS",76,0)
 .S ORKFLG=0
"RTN","ORKPS",77,0)
 .S ORNUM=$P(ORKA,"|",5)
"RTN","ORKPS",78,0)
 .S ORPHOI=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORKPS",79,0)
 .I $G(ORIVTYPE)'="A",'$$PRE^PSSDSAPK(ORPHOI,ORPHDG) Q  ; Don't do checks if pharmacy does not want us to
"RTN","ORKPS",80,0)
 .;get unsigned medication orders:
"RTN","ORKPS",81,0)
 .S HOR=0,SEQ=0
"RTN","ORKPS",82,0)
 .S HOR=$O(^TMP("ORR",$J,HOR))
"RTN","ORKPS",83,0)
 .I +$G(HOR)>0 D
"RTN","ORKPS",84,0)
 ..F  S SEQ=$O(^TMP("ORR",$J,HOR,SEQ)) Q:+SEQ<1  D
"RTN","ORKPS",85,0)
 ...S ORKORN=+$P(^TMP("ORR",$J,HOR,SEQ),U),DUPORN=0
"RTN","ORKPS",86,0)
 ...Q:+$G(ORKORN)<1
"RTN","ORKPS",87,0)
 ...Q:+ORKORN=+ORNUM
"RTN","ORKPS",88,0)
 ...Q:$P(^OR(100,+ORKORN,8,$P(^OR(100,+ORKORN,8,0),U,3),0),U,2)="DC"
"RTN","ORKPS",89,0)
 ...Q:$P(^ORD(100.01,$P(^OR(100,+ORKORN,3),U,3),0),U)="DISCONTINUED"
"RTN","ORKPS",90,0)
 ...S ORKDRUG=$$VALUE^ORCSAVE2(+ORKORN,"DRUG") ;get disp drug for order
"RTN","ORKPS",91,0)
 ...S ORPSPKG=$$DGRX^ORQOR2(+ORKORN)
"RTN","ORKPS",92,0)
 ...S:ORPSPKG="CLINIC INFUSIONS" ORPSPKG="IV MEDICATIONS" ; OR*3*430
"RTN","ORKPS",93,0)
 ...S ORPSPKG=$S(ORPSPKG="UNIT DOSE MEDICATIONS":"PSI",ORPSPKG="OUTPATIENT MEDICATIONS":"PSO",ORPSPKG="IV MEDICATIONS":"PSIV",ORPSPKG="NON-VA MEDICATIONS":"PSH",1:"")
"RTN","ORKPS",94,0)
 ...S DUPX="" F  S DUPX=$O(ORKDRUGA(DUPX)) Q:'DUPX!(DUPORN=1)  D
"RTN","ORKPS",95,0)
 ....S:ORKORN=ORKDRUGA(DUPX) DUPORN=1
"RTN","ORKPS",96,0)
 ...Q:DUPORN=1  ;quit if already processed drug order
"RTN","ORKPS",97,0)
 ...I +$G(ORKDRUG)<1,$L(ORPSPKG)>0 D
"RTN","ORKPS",98,0)
 ....N OROI S OROI=$$OI^ORX8(+ORKORN)
"RTN","ORKPS",99,0)
 ....S ORRET=$$OI2DD(+OROI,$S($G(ORKDG)="PSI":"I",$G(ORKDG)="PSIV":"I",$G(ORKDG)="PSO":"O",$G(ORKDG)="PSH":"O",1:"O"),1)
"RTN","ORKPS",100,0)
 ....I +$P(ORRET,";",4) S ORKSOIA(+$P(ORRET,";",4))=ORKORN
"RTN","ORKPS",101,0)
 ....I +ORRET S ORKDRUG=+ORRET
"RTN","ORKPS",102,0)
 ...;only process vs. unsigned med order if disp drug is assoc w/order:
"RTN","ORKPS",103,0)
 ...Q:+$G(ORKDRUG)<1
"RTN","ORKPS",104,0)
 ...I ORPSPKG="PSIV" D
"RTN","ORKPS",105,0)
 ....;loop through each OI in the IV order
"RTN","ORKPS",106,0)
 ....N OR2I
"RTN","ORKPS",107,0)
 ....S OR2I=0 F  S OR2I=$O(^OR(100,+ORKORN,4.5,"ID","ORDERABLE",OR2I)) Q:'OR2I  D
"RTN","ORKPS",108,0)
 .....N OR2OI,OR2DRUG
"RTN","ORKPS",109,0)
 .....S OR2OI=$G(^OR(100,+ORKORN,4.5,OR2I,1))
"RTN","ORKPS",110,0)
 .....Q:'OR2OI
"RTN","ORKPS",111,0)
 .....;get the drug for each OI
"RTN","ORKPS",112,0)
 .....S OR2DRUG=$$OI2DD(+OR2OI,"I",1)
"RTN","ORKPS",113,0)
 .....;check if drug should be add it and add it if so
"RTN","ORKPS",114,0)
 .....I $$IVADD(OR2DRUG,OR2OI) S ORKDRUGA(+OR2DRUG_";"_ORPSPKG_";"_ORKORN)=ORKORN_U_$$GETPSNM(+OR2DRUG)
"RTN","ORKPS",115,0)
 ...I ORPSPKG'="PSIV" S ORKDRUGA(+ORKDRUG_";"_ORPSPKG_";"_ORKORN)=ORKORN_U_$$GETPSNM(+ORKDRUG)
"RTN","ORKPS",116,0)
 ...; OR*3*469 - Load all components (solution and additive) of IV for order checking
"RTN","ORKPS",117,0)
 ... I ORPSPKG="PSIV" D
"RTN","ORKPS",118,0)
 .... N ORX,ORRET S ORX=0 F  S ORX=+$O(^OR(100,ORKORN,4.5,"ID","ORDERABLE",ORX)) Q:'ORX   D
"RTN","ORKPS",119,0)
 ..... S ORRET=$$OI2DD(+$G(^OR(100,ORKORN,4.5,ORX,1)),"I",1) Q:'ORRET
"RTN","ORKPS",120,0)
 ..... I +$P(ORRET,";",4) S ORKSOIA(+$P(ORRET,";",4))=ORKORN
"RTN","ORKPS",121,0)
 ..... I '$D(ORKDRUGA(+ORRET_";PSIV;"_ORKORN)) S ORKDRUGA(+ORRET_";PSIV;"_ORKORN)=ORKORN_U_$$GETPSNM(+ORRET)
"RTN","ORKPS",122,0)
 .... Q  ; end of OR*3*469 change
"RTN","ORKPS",123,0)
 .N ORPROSP,CNT
"RTN","ORKPS",124,0)
 .S CNT=1
"RTN","ORKPS",125,0)
 .S:+MED ORPROSP(CNT)=MED_U_$$GETPSNM(+MED)_U_+$G(ORNUM),CNT=CNT+1
"RTN","ORKPS",126,0)
 .N I S I="" F  S I=$O(ORKDRUGA(I)) Q:'I  S ORPROSP(CNT)=+I_U_$P(ORKDRUGA(I),U,2)_U_U_$P(ORKDRUGA(I),U,1),CNT=CNT+1
"RTN","ORKPS",127,0)
 .D SHRNKPR
"RTN","ORKPS",128,0)
 .D CPRS^PSODDPR4(DFN,"OROCOUT"_ORPTY,.ORPROSP,ORPTY_+$G(^OR(100,+$G(ORNUM),4)))
"RTN","ORKPS",129,0)
 .I +ORSUPPLY D
"RTN","ORKPS",130,0)
 ..S ORKSOIA(+ORSUPPLY)=$G(ORNUM)
"RTN","ORKPS",131,0)
 ..D:$D(ORKSOIA)>9 CPRS^PSODDPR8(DFN,"OROCOUT"_ORPTY,.ORKSOIA,ORPHDG_";"_+$G(^OR(100,+$G(ORNUM),4)),1)
"RTN","ORKPS",132,0)
 D PROCESS^ORKPS1(OI,ORDFN,ORKDG,+ORSUPPLY_U_+MED,"OROCOUT"_ORPTY)
"RTN","ORKPS",133,0)
 Q
"RTN","ORKPS",134,0)
IVADD(ORDRUG,OROI) ;RETURN YES OR NO IF SHOULD ADD THE IV ITEM
"RTN","ORKPS",135,0)
 N ORRET
"RTN","ORKPS",136,0)
 ;default is yes to add it, will always be 1 for an additive
"RTN","ORKPS",137,0)
 S ORRET=1
"RTN","ORKPS",138,0)
 ;check if drug is a base
"RTN","ORKPS",139,0)
 K ^TMP($J,"ORBASECHECK")
"RTN","ORKPS",140,0)
 D DRGIEN^PSS52P7(ORDRUG,,"ORBASECHECK")
"RTN","ORKPS",141,0)
 I $P($G(^TMP($J,"ORBASECHECK",0),0),U)>0 D  ;GOT A BASE HERE
"RTN","ORKPS",142,0)
 .;if drug is a base, check if pharmacy says we can add it or not
"RTN","ORKPS",143,0)
 .N ORPHOI
"RTN","ORKPS",144,0)
 .S ORPHOI=+$P($G(^ORD(101.43,+OROI,0)),U,2)
"RTN","ORKPS",145,0)
 .S ORRET=$$PRE^PSSDSAPK(ORPHOI,"I")
"RTN","ORKPS",146,0)
 K ^TMP($J,"ORBASECHECK")
"RTN","ORKPS",147,0)
 Q ORRET
"RTN","ORKPS",148,0)
SHRNKPR ;REMOVE DUPLICATS FROM PROSPECTIVE LIST
"RTN","ORKPS",149,0)
 Q:'$D(ORPROSP)
"RTN","ORKPS",150,0)
 N ORX,ORI S ORI=0 F  S ORI=$O(ORPROSP(ORI)) Q:'ORI  S ORX=ORPROSP(ORI) D
"RTN","ORKPS",151,0)
 .N ORJ S ORJ=ORI F  S ORJ=$O(ORPROSP(ORJ)) Q:'ORJ  I ORX=ORPROSP(ORJ) K ORPROSP(ORJ)
"RTN","ORKPS",152,0)
 Q
"RTN","ORKPS",153,0)
GETPSNM(ORIEN) ;GET THE FILE 50 .01 FIELD FROM A FILE 50 IEN
"RTN","ORKPS",154,0)
 N RET K ^TMP($J,"ORRETNM")
"RTN","ORKPS",155,0)
 D NDF^PSS50(ORIEN,,,,,"ORRETNM") S RET=$G(^TMP($J,"ORRETNM",ORIEN,.01))
"RTN","ORKPS",156,0)
 K ^TMP($J,"ORRETNM")
"RTN","ORKPS",157,0)
 Q RET
"RTN","ORKPS",158,0)
TAKEMED(ORKDFN,ORKMED) ;extrinsic function returns med orderable item if any
"RTN","ORKPS",159,0)
 ;active med patient is taking contains any piece of ORKMED
"RTN","ORKPS",160,0)
 ;ORKDFN   patient DFN
"RTN","ORKPS",161,0)
 ;ORKMED   meds to check vs. active med list in format MED1^MED2^MED3...
"RTN","ORKPS",162,0)
 Q:'$L($G(ORKDFN)) "0^Patient not identified."
"RTN","ORKPS",163,0)
 Q:'$L($G(ORKMED)) "0^Medication not identified."
"RTN","ORKPS",164,0)
 N ORKARX,ORKY,ORI,ORJ,ORCNT,ORKMEDP,ORKRSLT
"RTN","ORKPS",165,0)
 D LIST^ORQQPS(.ORKY,ORKDFN,"","")
"RTN","ORKPS",166,0)
 Q:$P(ORKY(1),U)="" "0^No active meds found."
"RTN","ORKPS",167,0)
 S ORKRSLT="0^No matching meds found."
"RTN","ORKPS",168,0)
 S ORCNT=$L(ORKMED,U)
"RTN","ORKPS",169,0)
 S ORI=0 F  S ORI=$O(ORKY(ORI)) Q:ORI<1  D
"RTN","ORKPS",170,0)
 .S ORKARX=$P(ORKY(ORI),U,2)
"RTN","ORKPS",171,0)
 .F ORJ=1:1:ORCNT S ORKMEDP=$P(ORKMED,U,ORJ) D
"RTN","ORKPS",172,0)
 ..I $L(ORKMEDP),($$UP^XLFSTR(ORKARX)[ORKMEDP) S ORKRSLT="1^"_ORKARX ;DJE/VM *316 use uppercase in comparison
"RTN","ORKPS",173,0)
 Q ORKRSLT
"RTN","ORKPS",174,0)
POLYRX(DFN) ;extrins funct rtns 1 if patient exceeds polypharmacy, 0 if not
"RTN","ORKPS",175,0)
 N ORSLT,ORENT,ORLOC,ORPAR,ORMEDS
"RTN","ORKPS",176,0)
 S ORSLT=0
"RTN","ORKPS",177,0)
 Q:'$L(DFN) ORSLT
"RTN","ORKPS",178,0)
 S VA200="" D OERR^VADPT
"RTN","ORKPS",179,0)
 S ORLOC=+$G(^DIC(42,+VAIN(4),44))
"RTN","ORKPS",180,0)
 K VA200,VAIN
"RTN","ORKPS",181,0)
 S ORENT=+$G(ORLOC)_";SC(^DIV^SYS^PKG"
"RTN","ORKPS",182,0)
 S ORPAR=$$GET^XPAR(ORENT,"ORK POLYPHARMACY",1,"I")
"RTN","ORKPS",183,0)
 S ORMEDS=$$NUMRX(DFN)
"RTN","ORKPS",184,0)
 I $G(ORMEDS)>$G(ORPAR) S ORSLT=1
"RTN","ORKPS",185,0)
 Q ORSLT
"RTN","ORKPS",186,0)
GLCREAT(DFN) ;extrinsic function returns patient's (DFN) most recent serum
"RTN","ORKPS",187,0)
 ; creatinine within # of days from parameter ORK GLUCOPHAGE CREATININE
"RTN","ORKPS",188,0)
 ; results format: test id^result units flag ref range collect d/t^result
"RTN","ORKPS",189,0)
 ; used by order check GLUCOPHAGE-LAB RESULTS
"RTN","ORKPS",190,0)
 N ORLOC,ORPAR,ORDAYS
"RTN","ORKPS",191,0)
 N BDT,CDT,ORY,ORX,ORZ,TEST,ORI,ORJ,CREARSLT,LABFILE,SPECFILE,SPECIMEN,VAIN,VADM,RSLTS
"RTN","ORKPS",192,0)
 Q:'$L(DFN) "0^"
"RTN","ORKPS",193,0)
 S ORDAYS=$$GCDAYS(DFN)
"RTN","ORKPS",194,0)
 Q:'$L(ORDAYS) "0^"
"RTN","ORKPS",195,0)
 D NOW^%DTC
"RTN","ORKPS",196,0)
 S BDT=$$FMADD^XLFDT(%,"-"_ORDAYS,"","","")
"RTN","ORKPS",197,0)
 K %
"RTN","ORKPS",198,0)
 Q:'$L($G(BDT)) "0^"
"RTN","ORKPS",199,0)
 S LABFILE=$$TERMLKUP^ORB31(.ORY,"SERUM CREATININE")
"RTN","ORKPS",200,0)
 Q:'$D(ORY) "0^" ;no link between SERUM CREATININE and local lab test
"RTN","ORKPS",201,0)
 Q:$G(LABFILE)'=60 "0^"
"RTN","ORKPS",202,0)
 S SPECFILE=$$TERMLKUP^ORB31(.ORX,"SERUM SPECIMEN")
"RTN","ORKPS",203,0)
 Q:'$D(ORX) "0^" ;no link between SERUM SPECIMEN and local specimen
"RTN","ORKPS",204,0)
 Q:$G(SPECFILE)'=61 "0^"
"RTN","ORKPS",205,0)
 F ORI=1:1:ORY D
"RTN","ORKPS",206,0)
 .S TEST=$P(ORY(ORI),U)
"RTN","ORKPS",207,0)
 .Q:+$G(TEST)<1
"RTN","ORKPS",208,0)
 .F ORJ=1:1:ORX D
"RTN","ORKPS",209,0)
 ..S SPECIMEN=$P(ORX(ORJ),U)
"RTN","ORKPS",210,0)
 ..Q:+$G(SPECIMEN)<1
"RTN","ORKPS",211,0)
 ..S ORZ=$$LOCL^ORQQLR1(DFN,TEST,SPECIMEN)
"RTN","ORKPS",212,0)
 ..Q:'$L($G(ORZ))
"RTN","ORKPS",213,0)
 ..S CDT=$P(ORZ,U,7)
"RTN","ORKPS",214,0)
 ..I CDT'<BDT S RSLTS(CDT)=ORZ,CREARSLT=1  ;*SMT Use RSLTS as array.
"RTN","ORKPS",215,0)
 Q:+$G(CREARSLT)<1 "0^"
"RTN","ORKPS",216,0)
 S CDT=$O(RSLTS(0)),ORZ=RSLTS(CDT)  ;*SMT
"RTN","ORKPS",217,0)
 Q $P(ORZ,U)_U_$P(ORZ,U,3)_" "_$P(ORZ,U,4)_" "_$P(ORZ,U,5)_" ("_$P(ORZ,U,6)_")  "_$$FMTE^XLFDT(CDT,"2P")_U_$P(ORZ,U,3)
"RTN","ORKPS",218,0)
GCDAYS(DFN) ;extrinsic function to return number of days to look for
"RTN","ORKPS",219,0)
 ; glucophage serum creatinine result
"RTN","ORKPS",220,0)
 Q:'$L(DFN) ""
"RTN","ORKPS",221,0)
 N ORLOC,ORENT,ORDAYS
"RTN","ORKPS",222,0)
 ;get patient's location flag (INPATIENT ONLY - outpt locations cannot be
"RTN","ORKPS",223,0)
 ;reliably determined, and many simultaneous outpt locations can occur):
"RTN","ORKPS",224,0)
 S VA200="" D OERR^VADPT
"RTN","ORKPS",225,0)
 S ORLOC=+$G(^DIC(42,+VAIN(4),44))
"RTN","ORKPS",226,0)
 K VA200,VAIN
"RTN","ORKPS",227,0)
 S ORENT=+$G(ORLOC)_";SC(^DIV^SYS^PKG"
"RTN","ORKPS",228,0)
 S ORDAYS=$$GET^XPAR(ORENT,"ORK GLUCOPHAGE CREATININE",1,"I")
"RTN","ORKPS",229,0)
 Q:$L(ORDAYS) ORDAYS
"RTN","ORKPS",230,0)
 Q ""
"RTN","ORKPS",231,0)
SUPPLY(OI) ;extrinsic function returns 1 (true) if the orderable item is
"RTN","ORKPS",232,0)
 ; a supply
"RTN","ORKPS",233,0)
 Q:+$G(OI)<1 ""
"RTN","ORKPS",234,0)
 N OITEXT
"RTN","ORKPS",235,0)
 S OITEXT=$G(^ORD(101.43,OI,0))
"RTN","ORKPS",236,0)
 Q:'$L(OITEXT) ""
"RTN","ORKPS",237,0)
 S OITEXT=$P(OITEXT,U)
"RTN","ORKPS",238,0)
 Q:$D(^ORD(101.43,"S.SPLY",OITEXT)) 1
"RTN","ORKPS",239,0)
 Q ""
"RTN","ORKPS",240,0)
NUMRX(DFN) ;extrinsic funct returns number of active meds patient is taking
"RTN","ORKPS",241,0)
 N NUMRX,ORPTYPE,ORX,ORY,ORS,ORNUM,ORPRENEW,VADMVT
"RTN","ORKPS",242,0)
 S NUMRX=0
"RTN","ORKPS",243,0)
 Q:+$G(DFN)<1 NUMRX
"RTN","ORKPS",244,0)
 ;check to determine if inpatient or outpatient:
"RTN","ORKPS",245,0)
 D ADM^VADPT2
"RTN","ORKPS",246,0)
 S ORPTYPE=$S(+$G(VADMVT)>0:"I",1:"O")
"RTN","ORKPS",247,0)
 K ^TMP("PS",$J)
"RTN","ORKPS",248,0)
 D OCL^PSOORRL(DFN,"","")  ;if no date range, returns active meds for pt
"RTN","ORKPS",249,0)
 N X
"RTN","ORKPS",250,0)
 S X=0
"RTN","ORKPS",251,0)
 F  S X=$O(^TMP("PS",$J,X)) Q:X<1  D
"RTN","ORKPS",252,0)
 .S ORX=$G(^TMP("PS",$J,X,0))
"RTN","ORKPS",253,0)
 .S ORY=$P(ORX,U)
"RTN","ORKPS",254,0)
 .S ORNUM=$P(ORX,U,8) ;order entry order number
"RTN","ORKPS",255,0)
 .S ORS=$P(ORX,U,9) ;medication status from pharmacy
"RTN","ORKPS",256,0)
 .S ORPRENEW=$P(ORX,U,14)  ;pending renewal flag (1: pending renewal)
"RTN","ORKPS",257,0)
 .Q:+ORX<1
"RTN","ORKPS",258,0)
 .Q:$P(ORY,";",2)'=ORPTYPE  ;quit if med is not pt type (inpt/outpt)
"RTN","ORKPS",259,0)
 .;quit if status is a non-active type:
"RTN","ORKPS",260,0)
 .Q:$G(ORS)="EXPIRED"
"RTN","ORKPS",261,0)
 .Q:$G(ORS)["DISCONTINUE"
"RTN","ORKPS",262,0)
 .Q:$G(ORS)="DELETED"
"RTN","ORKPS",263,0)
 .Q:+$G(ORPRENEW)>0
"RTN","ORKPS",264,0)
 .Q:$$SUPPLY($$OI^ORQOR2(ORNUM))=1  ;quit if a supply
"RTN","ORKPS",265,0)
 .S NUMRX=NUMRX+1
"RTN","ORKPS",266,0)
 K ^TMP("PS",$J)
"RTN","ORKPS",267,0)
 Q NUMRX
"RTN","ORKPS",268,0)
OI2DD(OROI,ORPSPKG,ORCHKTYP)       ;rtn dispense drugs for a PS OI
"RTN","ORKPS",269,0)
 ;ORCHKTYP: TYPE OF ORDER CHECK SYSTEM IS PERFORMING
"RTN","ORKPS",270,0)
 ;          1 FOR ENHANCED ORDER CHECKS
"RTN","ORKPS",271,0)
 ;          2 FOR DOSAGE ORDER CHECK
"RTN","ORKPS",272,0)
 N PSOI,ORRET
"RTN","ORKPS",273,0)
 Q:'$D(^ORD(101.43,OROI,0)) ""
"RTN","ORKPS",274,0)
 S PSOI=+$P(^ORD(101.43,OROI,0),U,2)
"RTN","ORKPS",275,0)
 Q:PSOI<1 ""
"RTN","ORKPS",276,0)
 S:ORPSPKG="H" ORPSPKG="X"  ;if non-va med need to pass api "X"
"RTN","ORKPS",277,0)
 S ORRET=$$DRG^PSSDSAPM(PSOI,ORPSPKG,ORCHKTYP)
"RTN","ORKPS",278,0)
 I ORCHKTYP=1,(+$P(ORRET,";",4)) S $P(ORRET,";",4)=PSOI
"RTN","ORKPS",279,0)
 Q ORRET
"RTN","ORKPS1")
0^2^B108794510
"RTN","ORKPS1",1,0)
ORKPS1 ; SLC/CLA - Order checking support procedures for medications ;01/04/18  11:26
"RTN","ORKPS1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**232,272,346,352,345,311,402,457,469**;Dec 17, 1997;Build 3
"RTN","ORKPS1",3,0)
 Q
"RTN","ORKPS1",4,0)
PROCESS(OI,DFN,ORKDG,ORPROSP,ORGLOBL) ;process data from pharmacy order check API
"RTN","ORKPS1",5,0)
 ;ORPROSP = pharmacy orderable item ien [file #50.7] ^ drug ien [file #50]
"RTN","ORKPS1",6,0)
 ;          NOTE: PIECE 1 WILL ONLY BE FILLED IN FOR ORDERABLE ITEMS THAT RESOLVE TO SUPPLY ITEMS
"RTN","ORKPS1",7,0)
 Q:'$D(^TMP($J))
"RTN","ORKPS1",8,0)
 N II,XX,ZZ,ZZD,ORMTYPE,ORN,ORZ,RCNT,GL,I,J,K,L,M,TDATA,VADMVT,ORX,ORY
"RTN","ORKPS1",9,0)
 S II=1,XX=0,ZZ="",ZZD="",RCNT=0
"RTN","ORKPS1",10,0)
 I $G(^TMP($J,ORGLOBL,"OUT",0))<0 D  Q
"RTN","ORKPS1",11,0)
 .S YY(II)="ERR^Drug-Drug order checks (Duplicate Therapy, Duplicate Drug, Drug Interaction) were not able to be performed. "_$P($G(^TMP($J,ORGLOBL,"OUT",0)),U,2)
"RTN","ORKPS1",12,0)
 .S II=II+1
"RTN","ORKPS1",13,0)
 I $D(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS")) D
"RTN","ORKPS1",14,0)
 .S ORX="" F  S ORX=$O(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX)) Q:'$L(ORX)  D
"RTN","ORKPS1",15,0)
 ..S ORY=0 F  S ORY=$O(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)) Q:'ORY  D
"RTN","ORKPS1",16,0)
 ...I $L($G(ORIFN))>0,$G(ORIFN)=$P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,5) Q
"RTN","ORKPS1",17,0)
 ...S YY(II)="ERR^"_$P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,7)
"RTN","ORKPS1",18,0)
 ...I $L($P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,10))>0 S YY(II)=YY(II)_"("_$P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,10)_")"
"RTN","ORKPS1",19,0)
 ...S II=II+1
"RTN","ORKPS1",20,0)
 S ORX="" F ORX="DRUGDRUG","THERAPY" D
"RTN","ORKPS1",21,0)
 .Q:'$D(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR"))
"RTN","ORKPS1",22,0)
 .S ORY="" F  S ORY=$O(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY)) Q:'$L(ORY)  D
"RTN","ORKPS1",23,0)
 ..S ORZ=0 F  S ORZ=$O(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ)) Q:'ORZ  D
"RTN","ORKPS1",24,0)
 ...S YY(II)="ERR^"_$$UPPER^ORWDPS32($G(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ,"SEV")))_": "_$P($G(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ,0)),U)_" - "_$G(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ,"TEXT"))
"RTN","ORKPS1",25,0)
 ...S II=II+1
"RTN","ORKPS1",26,0)
 I +$P(ORPROSP,U,2) D
"RTN","ORKPS1",27,0)
 .;set info about the drug being ordered
"RTN","ORKPS1",28,0)
 .S TDATA("NEW","TXT")=""
"RTN","ORKPS1",29,0)
 .S I="" F  S I=$O(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)) Q:'$L(I)  D
"RTN","ORKPS1",30,0)
 ..I $P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,5)=+$G(ORIFN),$P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,3)=(+$P(ORPROSP,U,2)) D
"RTN","ORKPS1",31,0)
 ...S TDATA("NEW","TXT")=$P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,4)
"RTN","ORKPS1",32,0)
 ...S TDATA("NEW","PROSP")=$P(I,";",3,4)
"RTN","ORKPS1",33,0)
 .;if we get here and we don't have anything in TDATA("NEW","PROSP") then we need to set to the first PROSPECTIVE
"RTN","ORKPS1",34,0)
 .I '$L($G(TDATA("NEW","PROSP"))) D
"RTN","ORKPS1",35,0)
 ..S I="" F  S I=$O(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)) Q:'$L(I)  I $P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,3)=(+$P(ORPROSP,U,2)) D
"RTN","ORKPS1",36,0)
 ...S TDATA("NEW","TXT")=$P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,4)
"RTN","ORKPS1",37,0)
 ...S TDATA("NEW","PROSP")=$P(I,";",3,4)
"RTN","ORKPS1",38,0)
 .;/////////////////GET PTYPE RIGHT///////////////////
"RTN","ORKPS1",39,0)
 .S TDATA("NEW","OTYPE")=$S($G(ORKDG)="PSI":"UD",$G(ORKDG)="PSO":"OP",$G(ORKDG)="PSIV":"IV",$G(ORKDG)="PSH":"NV",1:"")
"RTN","ORKPS1",40,0)
 .;initially base PTYPE on display group
"RTN","ORKPS1",41,0)
 .S TDATA("NEW","PTYPE")=$S($G(ORKDG)="PSI":"I",$G(ORKDG)="PSO":"O",$G(ORKDG)="PSIV":"I",$G(ORKDG)="PSH":"O",1:"")
"RTN","ORKPS1",42,0)
 .;if we have an order number then we can accurately determine if it is a Clinic med or not
"RTN","ORKPS1",43,0)
 .I +$G(ORIFN) D
"RTN","ORKPS1",44,0)
 ..I $$ISCLIN(+$G(ORIFN)) S TDATA("NEW","PTYPE")="C" Q
"RTN","ORKPS1",45,0)
 .;if we don't have an order number then if the patient is an outpatient and the OTYPE is UD or IV we assume Clinic med
"RTN","ORKPS1",46,0)
 .I '(+$G(ORIFN)) D
"RTN","ORKPS1",47,0)
 ..I ($G(TDATA("NEW","OTYPE"))="UD")!($G(TDATA("NEW","OTYPE"))="IV") D
"RTN","ORKPS1",48,0)
 ...I $$PATTYPE(DFN)="O" S TDATA("NEW","PTYPE")="C"
"RTN","ORKPS1",49,0)
 .;if PTYPE not set at this point, set it to patient type (catch all for safety)
"RTN","ORKPS1",50,0)
 .I '$L(TDATA("NEW","PTYPE")) D
"RTN","ORKPS1",51,0)
 ..S TDATA("NEW","PTYPE")=$$PATTYPE(DFN)
"RTN","ORKPS1",52,0)
 .;/////////////////END GET PTYPE RIGHT///////////////////
"RTN","ORKPS1",53,0)
 D DD(.TDATA,$S(+ORPROSP>0:0,1:1))
"RTN","ORKPS1",54,0)
 Q:'$L($G(TDATA("NEW","PROSP")))
"RTN","ORKPS1",55,0)
 D DI(.TDATA)
"RTN","ORKPS1",56,0)
 D DT(.TDATA)
"RTN","ORKPS1",57,0)
 Q
"RTN","ORKPS1",58,0)
 ;
"RTN","ORKPS1",59,0)
DI(TDATA) ;add drug interaction checks
"RTN","ORKPS1",60,0)
 N GL,ORSEV,ORDRUG,ORTXT,ORIEN
"RTN","ORKPS1",61,0)
 S GL=$NA(^TMP($J,ORGLOBL,"OUT","DRUGDRUG"))
"RTN","ORKPS1",62,0)
 S J="" F  S J=$O(@GL@(J)) Q:'$L(J)  D
"RTN","ORKPS1",63,0)
 .S K="" F  S K=$O(@GL@(J,K)) Q:'$L(K)  D
"RTN","ORKPS1",64,0)
 ..S L=0 F  S L=$O(@GL@(J,K,L)) Q:'$L(L)  D
"RTN","ORKPS1",65,0)
 ...S M=0 F  S M=$O(@GL@(J,K,L,M)) Q:'M  D
"RTN","ORKPS1",66,0)
 ....N ORNUM,ORSEV,ORDNAME,ORZ,CNT,ORSTAT,ORMON,ORWHICH,ORLINE,ORIDX
"RTN","ORKPS1",67,0)
 ....;get the associated order number
"RTN","ORKPS1",68,0)
 ....S ORNUM=$P(L,";",1,2)
"RTN","ORKPS1",69,0)
 ....;if the status of the associated order is DISCONTINUED then don't add
"RTN","ORKPS1",70,0)
 ....S ORSTAT=$$PHSTAT(DFN,ORNUM)
"RTN","ORKPS1",71,0)
 ....Q:ORSTAT="DISCONTINUED"
"RTN","ORKPS1",72,0)
 ....S ORWHICH=""
"RTN","ORKPS1",73,0)
 ....I $P($P(@GL@(J,K,L,M),U),";",3,4)=TDATA("NEW","PROSP") D
"RTN","ORKPS1",74,0)
 .....S ORWHICH=K_" ["_$S($P(L,";",3)="PROSPECTIVE":"UNRELEASED",1:ORSTAT)_"]"
"RTN","ORKPS1",75,0)
 ....I $P(L,";",3,4)=TDATA("NEW","PROSP") D
"RTN","ORKPS1",76,0)
 .....S ORWHICH=$P(@GL@(J,K,L,M),U,4)_" ["
"RTN","ORKPS1",77,0)
 .....S ORWHICH=ORWHICH_$S($P($P(@GL@(J,K,L,M),U),";",3)="PROSPECTIVE":"UNRELEASED",1:$$PHSTAT(DFN,$P($P(@GL@(J,K,L,M),U),";",1,2)))
"RTN","ORKPS1",78,0)
 .....S ORWHICH=ORWHICH_"]"
"RTN","ORKPS1",79,0)
 ....Q:$L(ORWHICH)<2
"RTN","ORKPS1",80,0)
 ....;get text
"RTN","ORKPS1",81,0)
 ....S ORTXT(J,K_";"_ORNUM)=$S($G(ORTXT(J,K))'="":ORTXT(J,K)_" ",1:"")_$P($G(@GL@(J,K,L,M,"CLIN")),"CLINICAL EFFECTS:  ",2),ORTXT(J,K_";"_ORNUM,"ORWHICH")=ORWHICH ;*457
"RTN","ORKPS1",82,0)
 ....;set the monograph into the temp global
"RTN","ORKPS1",83,0)
 ....I $D(@GL@(J,K,L,M,"PMON")) D
"RTN","ORKPS1",84,0)
 .....S ^TMP($J,"ORMONOGRAPH")=1+$G(^TMP($J,"ORMONOGRAPH"))
"RTN","ORKPS1",85,0)
 .....S ORMON=^TMP($J,"ORMONOGRAPH")
"RTN","ORKPS1",86,0)
 .....S ^TMP($J,"ORMONOGRAPH",ORMON,"INT")=@GL@(J,K,L,M,"INT")
"RTN","ORKPS1",87,0)
 .....S ORIDX="",ORLINE=1 F  S ORIDX=$O(@GL@(J,K,L,M,"PMON",ORIDX)) Q:+$G(ORIDX)=0  D
"RTN","ORKPS1",88,0)
 ......S ^TMP($J,"ORMONOGRAPH",ORMON,"DATA",ORLINE,0)=@GL@(J,K,L,M,"PMON",ORIDX,0),ORLINE=ORLINE+1
"RTN","ORKPS1",89,0)
 .....S ORTXT(J,K_";"_ORNUM,"MONOGRAPH")=1,ORTXT(J,K_";"_ORNUM,"ORMON",ORMON)="" ;*457
"RTN","ORKPS1",90,0)
 ....;get the severity
"RTN","ORKPS1",91,0)
 ....S ORSEV=$$UPPER^ORU($G(@GL@(J,K,L,M,"SEV")))
"RTN","ORKPS1",92,0)
 ....;get the drug name
"RTN","ORKPS1",93,0)
 ....S ORDNAME=K
"RTN","ORKPS1",94,0)
 ....S ORTXT(J,K_";"_ORNUM,"YY")="DI^"_ORSEV_U_ORNUM_U_ORDNAME_U_U_$G(@GL@(J,K,L,M,"INT")) ;*457
"RTN","ORKPS1",95,0)
 ;RETURN DATA IN EXPECTED FORMAT
"RTN","ORKPS1",96,0)
 S ORSEV="" F  S ORSEV=$O(ORTXT(ORSEV)) Q:$G(ORSEV)=""  D
"RTN","ORKPS1",97,0)
 .S ORDRUG="" F  S ORDRUG=$O(ORTXT(ORSEV,ORDRUG)) Q:$G(ORDRUG)=""  D
"RTN","ORKPS1",98,0)
 ..S YY(II)=ORTXT(ORSEV,ORDRUG,"YY")
"RTN","ORKPS1",99,0)
 ..S $P(YY(II),U,5)=TDATA("NEW","TXT")_" and "_ORTXT(ORSEV,ORDRUG,"ORWHICH")_" - "_ORTXT(ORSEV,ORDRUG)
"RTN","ORKPS1",100,0)
 ..S ORIEN=0 F  S ORIEN=$O(ORTXT(ORSEV,ORDRUG,"ORMON",ORIEN)) Q:+$G(ORIEN)=0  D
"RTN","ORKPS1",101,0)
 ...S ^TMP($J,"ORMONOGRAPH",ORIEN,"OC")=$P(YY(II),U,5)
"RTN","ORKPS1",102,0)
 ..S:$G(ORTXT(ORSEV,ORDRUG,"MONOGRAPH")) $P(YY(II),U,5)=$P(YY(II),U,5)_" - Monograph Available"
"RTN","ORKPS1",103,0)
 ..S II=II+1
"RTN","ORKPS1",104,0)
 Q
"RTN","ORKPS1",105,0)
 ;
"RTN","ORKPS1",106,0)
DD(TDATA,ORDPROSP) ;add duplicate drug checks
"RTN","ORKPS1",107,0)
 ;ORDPROSP: PERFORM PROSPECTIVE DRUG CHECK
"RTN","ORKPS1",108,0)
 ;          1 FOR YES
"RTN","ORKPS1",109,0)
 ;          0 FOR NO
"RTN","ORKPS1",110,0)
 S XX=0,ZZ=""
"RTN","ORKPS1",111,0)
 F  S XX=$O(^TMP($J,"DD",XX)) Q:XX<1  D
"RTN","ORKPS1",112,0)
 .N ORREM
"RTN","ORKPS1",113,0)
 .S ZZ=$G(^TMP($J,"DD",XX,0)),ORMTYPE=$P($P(ZZ,U,4),";",2)
"RTN","ORKPS1",114,0)
 .S ORREM=$P($P(ZZ,U,4),";") I (ORREM["Z"),$D(^TMP($J,ORGLOBL,"OUT","REMOTE",+ORREM)) D
"RTN","ORKPS1",115,0)
 ..N ORTXT,ORREM1,ORREMSIG
"RTN","ORKPS1",116,0)
 ..S ORREM1=$G(^TMP($J,ORGLOBL,"OUT","REMOTE",+ORREM))
"RTN","ORKPS1",117,0)
 ..S ORREMSIG=$G(^TMP($J,ORGLOBL,"OUT","REMOTE",+ORREM,"SIG",0))
"RTN","ORKPS1",118,0)
 ..S ORTXT=" "_ORREMSIG_" ["_$P(ORREM1,U,4)_" -  Last Fill: "_$P(ORREM1,U,6)_"  Quantity Dispensed: "_$P(ORREM1,U,8)_"] >>"_$P(ORREM1,U)
"RTN","ORKPS1",119,0)
 ..S $P(ZZ,U,2)=$P(ZZ,U,2)_ORTXT
"RTN","ORKPS1",120,0)
 .I +ORDPROSP,$G(TDATA("NEW","PTYPE"))'=$G(ORMTYPE) Q
"RTN","ORKPS1",121,0)
 .S ORN=$P($P(ZZ,U,3),";"),ORZ=""
"RTN","ORKPS1",122,0)
 .I $L($G(ORN))>0,+$G(ORN)=+$G(ORIFN) Q  ;QUIT if dup med ord # = current ord #
"RTN","ORKPS1",123,0)
 .I +$G(ORIFN),+$G(ORN)=$P(^OR(100,+ORIFN,3),U,5) Q  ;QUIT if dup med ord # = the current order #'s REPLACED ORDER (changing an order)
"RTN","ORKPS1",124,0)
 .I +ORDPROSP,+$P(ORPROSP,U,2)'=+ZZ Q
"RTN","ORKPS1",125,0)
 .I $L(ORN),$D(^OR(100,ORN,8,0)) S ORZ=^OR(100,ORN,8,0)
"RTN","ORKPS1",126,0)
 .I $L($G(ORZ)),($P(^OR(100,ORN,8,$P(ORZ,U,3),0),U,2)="DC") Q
"RTN","ORKPS1",127,0)
 .I $L(ORN),$P(^ORD(100.01,$P(^OR(100,ORN,3),U,3),0),U)="DISCONTINUED" Q
"RTN","ORKPS1",128,0)
 .I ZZ'="" S YY(II)="DD^"_ZZ,II=II+1
"RTN","ORKPS1",129,0)
 .S ^TMP($J,"DD",XX,"OC")="" ;set this if this DD entry turned into an OC
"RTN","ORKPS1",130,0)
 Q
"RTN","ORKPS1",131,0)
 ;
"RTN","ORKPS1",132,0)
DT(TDATA) ;add duplicate therapy checks
"RTN","ORKPS1",133,0)
 N I,GL
"RTN","ORKPS1",134,0)
 S GL=$NA(^TMP($J,ORGLOBL,"OUT","THERAPY"))
"RTN","ORKPS1",135,0)
 S I=0 F  S I=$O(@GL@(I)) Q:'I  D
"RTN","ORKPS1",136,0)
 .N ORDRUGS,J,ORCLASS,ORNUM,ORRETSTR,ORPROSIN S ORPROSIN=0,ORDRUGS="",ORCLASS=""
"RTN","ORKPS1",137,0)
 .S J=0 F  S J=$O(@GL@(I,"DRUGS",J)) Q:'J  D
"RTN","ORKPS1",138,0)
 ..;get the type of the item checked against
"RTN","ORKPS1",139,0)
 ..N ORPTYPE S ORPTYPE=$P($G(@GL@(I,"DRUGS",J)),U,5)
"RTN","ORKPS1",140,0)
 ..;get if the item checked against is PROSPECTIVE or PROFILE
"RTN","ORKPS1",141,0)
 ..N ORDTYPE S ORDTYPE=$P($G(@GL@(I,"DRUGS",J)),";",3)
"RTN","ORKPS1",142,0)
 ..;if the item checked against is a PROSPECTIVE then get its type from file 100
"RTN","ORKPS1",143,0)
 ..I ORDTYPE="PROSPECTIVE" D
"RTN","ORKPS1",144,0)
 ...N ORXNUM S ORXNUM=+$P($G(@GL@(I,"DRUGS",J)),U,4)
"RTN","ORKPS1",145,0)
 ...I ORXNUM D
"RTN","ORKPS1",146,0)
 ....N ORKDGIEN S ORKDGIEN=$P($G(^OR(100,ORXNUM,0)),U,11)
"RTN","ORKPS1",147,0)
 ....N ORKDG S ORKDG=$P($G(^ORD(100.98,ORKDGIEN,0)),U,3)
"RTN","ORKPS1",148,0)
 ....S ORPTYPE=$S($G(ORKDG)="UD RX":"I",$G(ORKDG)="I RX":"I",$G(ORKDG)="IV RX":"I",$G(ORKDG)="CI RX":"C",$G(ORKDG)="CL OR":"C",$G(ORKDG)="C RX":"C",$G(ORKDG)="C RX":"C",1:"O")
"RTN","ORKPS1",149,0)
 ..;consider Remote orders in the DRUGS array to be outpatient orders
"RTN","ORKPS1",150,0)
 ..I ORPTYPE="R" S ORPTYPE="O"
"RTN","ORKPS1",151,0)
 ..;if this is the prospective we are checking, set ORPROSIN=1 to indicate the one we are looking at is in this OC from the API
"RTN","ORKPS1",152,0)
 ..I $G(TDATA("NEW","PROSP"))=$P($P($G(@GL@(I,"DRUGS",J)),U),";",3,4) S ORPROSIN=1
"RTN","ORKPS1",153,0)
 ..;if neither the item being checked and the item checked against are not Clinic meds and they do not match in type, don't use it
"RTN","ORKPS1",154,0)
 ..I ($G(TDATA("NEW","PTYPE"))'=ORPTYPE),(ORPTYPE'="C"),($G(TDATA("NEW","PTYPE"))'="C") Q
"RTN","ORKPS1",155,0)
 ..;if this matches the replacement order of the item being checked against, don't use it
"RTN","ORKPS1",156,0)
 ..I $L($P($G(@GL@(I,"DRUGS",J)),U,4))>0,(+$P($G(@GL@(I,"DRUGS",J)),U,4)=$P($G(^OR(100,+$G(ORIFN),3)),U,5)) Q
"RTN","ORKPS1",157,0)
 ..;if this matches the order number of the item being checked against, don't use it
"RTN","ORKPS1",158,0)
 ..I $L($P($G(@GL@(I,"DRUGS",J)),U,4))>0,(+$P($G(@GL@(I,"DRUGS",J)),U,4)=+$G(ORIFN)) Q
"RTN","ORKPS1",159,0)
 ..;if this is the prospective we are checking, don't use it
"RTN","ORKPS1",160,0)
 ..I $G(TDATA("NEW","PROSP"))=$P($P($G(@GL@(I,"DRUGS",J)),U),";",3,4)  Q
"RTN","ORKPS1",161,0)
 ..;if we got here then this order from the DRUGS array should be in the output message
"RTN","ORKPS1",162,0)
 ..S ORNUM=$P($P($G(@GL@(I,"DRUGS",J)),U),";",1,2)
"RTN","ORKPS1",163,0)
 ..S ORDRUGS=ORDRUGS_$S($L(ORDRUGS):", ",1:"")_$P($G(@GL@(I,"DRUGS",J)),U,3)_" ["_$$PHSTAT(DFN,ORNUM)_"]"
"RTN","ORKPS1",164,0)
 .;quit if no drugs have been set into ORDRUGS
"RTN","ORKPS1",165,0)
 .Q:('$L(ORDRUGS))
"RTN","ORKPS1",166,0)
 .;quit if ORPROSIN is still 0 which means the prospective we are looking at was not part of this OC returned from the API
"RTN","ORKPS1",167,0)
 .Q:'ORPROSIN
"RTN","ORKPS1",168,0)
 .;get all classes
"RTN","ORKPS1",169,0)
 .S J=0 F  S J=$O(@GL@(I,J)) Q:'J  D
"RTN","ORKPS1",170,0)
 ..S ORCLASS=ORCLASS_$S($L(ORCLASS):", ",1:"")_$G(@GL@(I,J,"CLASS"))
"RTN","ORKPS1",171,0)
 .;assemble return string ("DC"+ORNUM_U_Classes_U_Classes (drugs))
"RTN","ORKPS1",172,0)
 .S ORRETSTR="Duplicate Therapy: Order(s) exist for {"_ORDRUGS_"} in the same therapeutic categor(ies): "_ORCLASS
"RTN","ORKPS1",173,0)
 .S YY(II)="DC"_U_$G(ORNUM)_U_ORCLASS_U_ORRETSTR,II=II+1
"RTN","ORKPS1",174,0)
 Q
"RTN","ORKPS1",175,0)
 ;
"RTN","ORKPS1",176,0)
PHSTAT(DFN,ORNUM) ;get the status of the order
"RTN","ORKPS1",177,0)
 N RET,J,I
"RTN","ORKPS1",178,0)
 S RET=""
"RTN","ORKPS1",179,0)
 I $P(ORNUM,";")="P" S RET="PENDING"
"RTN","ORKPS1",180,0)
 I $P(ORNUM,";")="N" S RET="ACTIVE NON-VA"
"RTN","ORKPS1",181,0)
 I $P(ORNUM,";")="O" D
"RTN","ORKPS1",182,0)
 .N ORLAST
"RTN","ORKPS1",183,0)
 .I $E($P(ORNUM,";"),1)="C" S ORLAST=$S($E($P(ORNUM,";"),2)=1:"V",$E($P(ORNUM,";"),2)=2:"U",1:"NV")
"RTN","ORKPS1",184,0)
 .E  S ORLAST=$E(ORNUM,$L(ORNUM))
"RTN","ORKPS1",185,0)
 .I ORLAST="0" S RET="UNRELEASED" Q
"RTN","ORKPS1",186,0)
 .I ORLAST="P" S RET="PENDING" Q
"RTN","ORKPS1",187,0)
 .K ^TMP($J,"OROCLST") D RX^PSO52API(DFN,"OROCLST",$P(ORNUM,";",2),,"ST")
"RTN","ORKPS1",188,0)
 .S RET=$P($G(^TMP($J,"OROCLST",DFN,$P(ORNUM,";",2),100)),U,2)
"RTN","ORKPS1",189,0)
 .K ^TMP($J,"OROCLST")
"RTN","ORKPS1",190,0)
 I $P(ORNUM,";")="I"!($E($P(ORNUM,";"),1)="C") D
"RTN","ORKPS1",191,0)
 .N ORLAST,ORPHNUM
"RTN","ORKPS1",192,0)
 .I $E($P(ORNUM,";"),1)="C" S ORLAST=$S($E($P(ORNUM,";"),2)=1:"V",$E($P(ORNUM,";"),2)=2:"U",1:"NV")
"RTN","ORKPS1",193,0)
 .E  S ORLAST=$E(ORNUM,$L(ORNUM))
"RTN","ORKPS1",194,0)
 .I ORLAST="0" S RET="UNRELEASED" Q
"RTN","ORKPS1",195,0)
 .I ORLAST="P" S RET="PENDING" Q
"RTN","ORKPS1",196,0)
 .S ORPHNUM=+$P(ORNUM,";",2)
"RTN","ORKPS1",197,0)
 .I ORLAST="U" D
"RTN","ORKPS1",198,0)
 ..K ^TMP($J,"OR GET STATUS") D PSS431^PSS55(DFN,ORPHNUM,"","","OR GET STATUS")
"RTN","ORKPS1",199,0)
 ..S RET=$P($G(^TMP($J,"OR GET STATUS",ORPHNUM,28)),U,2)
"RTN","ORKPS1",200,0)
 .I ORLAST="V" D
"RTN","ORKPS1",201,0)
 ..K ^TMP($J,"OR GET STATUS") D PSS436^PSS55(DFN,ORPHNUM,"OR GET STATUS")
"RTN","ORKPS1",202,0)
 ..S RET=$P($G(^TMP($J,"OR GET STATUS",ORPHNUM,100)),U,2)
"RTN","ORKPS1",203,0)
 .I ORLAST="NV" D
"RTN","ORKPS1",204,0)
 ..K ^TMP($J,"OR GET STATUS") D PSJ^PSJ53P1(ORPHNUM,"OR GET STATUS")
"RTN","ORKPS1",205,0)
 ..S RET=$P($G(^TMP($J,"OR GET STATUS",ORPHNUM,28)),U,2)
"RTN","ORKPS1",206,0)
 .S:$E($P(ORNUM,";"),1)="C" RET=RET_" CLINIC ORDER"
"RTN","ORKPS1",207,0)
 I $P(ORNUM,";")="R" D
"RTN","ORKPS1",208,0)
 .N ORREMOTE S ORREMOTE=$G(^TMP($J,ORGLOBL,"OUT","REMOTE",$P(ORNUM,";",2)))
"RTN","ORKPS1",209,0)
 .S RET=$P(ORREMOTE,U,4)_" >> "_$P(ORREMOTE,U)
"RTN","ORKPS1",210,0)
 I "^PENDING^NON-VERIFIED^NON VERIFIED^INCOMPLETE^DRUG INTERACTIONS^"[(U_RET_U) S RET="PENDING"
"RTN","ORKPS1",211,0)
 Q RET
"RTN","ORKPS1",212,0)
 ;
"RTN","ORKPS1",213,0)
ISCLIN(ORNUM) ;check if the order number is a clinic order
"RTN","ORKPS1",214,0)
 N ORRET
"RTN","ORKPS1",215,0)
 D IMOOD^ORIMO(.ORRET,+ORNUM)
"RTN","ORKPS1",216,0)
 Q ORRET
"RTN","ORKPS1",217,0)
 ;
"RTN","ORKPS1",218,0)
PATTYPE(DFN) ;return if patient is Inpatient "I" or Outpatient "O"
"RTN","ORKPS1",219,0)
 N ORRET
"RTN","ORKPS1",220,0)
 D ADM^VADPT2
"RTN","ORKPS1",221,0)
 S ORRET=$S(+$G(VADMVT)>0:"I",1:"O")
"RTN","ORKPS1",222,0)
 K VADMVT
"RTN","ORKPS1",223,0)
 Q ORRET
"RTN","ORKPS1",224,0)
 ;
"RTN","ORWDXC")
0^4^B77488724
"RTN","ORWDXC",1,0)
ORWDXC ; SLC/KCM - Utilities for Order Checking ;01/04/18  13:10
"RTN","ORWDXC",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,141,221,243,280,346,345,311,395,269,469**;Dec 17, 1997;Build 3
"RTN","ORWDXC",3,0)
 ;
"RTN","ORWDXC",4,0)
ON(VAL) ; returns E if order checking enabled, otherwise D
"RTN","ORWDXC",5,0)
 S VAL=$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")
"RTN","ORWDXC",6,0)
 Q
"RTN","ORWDXC",7,0)
FILLID(VAL,DLG) ; Return the FillerID (namespace) for a dialog
"RTN","ORWDXC",8,0)
 N DGRP
"RTN","ORWDXC",9,0)
 S VAL="",DGRP=$P($G(^ORD(101.41,DLG,0)),U,5) Q:'DGRP
"RTN","ORWDXC",10,0)
 S DLG=$$DEFDLG^ORWDXQ(DGRP)
"RTN","ORWDXC",11,0)
 S VAL=$P($G(^ORD(101.41,DLG,0)),U,7),VAL=$$NMSP^ORCD(VAL)
"RTN","ORWDXC",12,0)
 I VAL="PS" D
"RTN","ORWDXC",13,0)
 . N X
"RTN","ORWDXC",14,0)
 . S X=$P($P($G(^ORD(100.98,DGRP,0)),U,3)," ")
"RTN","ORWDXC",15,0)
 . I $L(X) S VAL="PS"_$S(X="UD":"I",1:X)
"RTN","ORWDXC",16,0)
 Q
"RTN","ORWDXC",17,0)
DISPLAY(LST,DFN,FID) ; Return list of Order Checks for a FillerID (namespace)
"RTN","ORWDXC",18,0)
 N I,ORX,ORY
"RTN","ORWDXC",19,0)
 S ORX=1,ORX(1)="|"_FID
"RTN","ORWDXC",20,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"DISPLAY")
"RTN","ORWDXC",21,0)
 S I=0 F  S I=$O(ORY(I)) Q:I'>0  S LST(I)=$P(ORY(I),U,4)
"RTN","ORWDXC",22,0)
 Q
"RTN","ORWDXC",23,0)
ACCEPT(LST,DFN,FID,STRT,ORL,OIL,ORIFN,ORREN)    ; Return list of Order Checks on Accept Order
"RTN","ORWDXC",24,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",25,0)
 ; OIL(n)=OIptr^PS|PSIV|LR^PkgInfo
"RTN","ORWDXC",26,0)
 ; ORREN - IF ORREN IS SET TO 1 THEN ORIFN IS THE ORDER GETTING RENEWED
"RTN","ORWDXC",27,0)
 K ^TMP($J,"ORENHCHK")
"RTN","ORWDXC",28,0)
 N X,Y,USID,ORCHECK,ORI,ORX,ORY,%DT,ORDODSG
"RTN","ORWDXC",29,0)
 ; convert relative start date to real start date
"RTN","ORWDXC",30,0)
 S ORL=ORL_";SC(",X=STRT,STRT="",ORDODSG=0
"RTN","ORWDXC",31,0)
 D:X="AM" AM^ORCSAVE2 D:X="NEXT" NEXT^ORCSAVE2
"RTN","ORWDXC",32,0)
 I $L(X) S %DT="FTX" D ^%DT S:Y'>0 Y="" S STRT=Y
"RTN","ORWDXC",33,0)
 ; do the SELECT order checks
"RTN","ORWDXC",34,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",35,0)
 . Q:'OIL(ORI)
"RTN","ORWDXC",36,0)
 . S USID=$$USID(OIL(ORI))
"RTN","ORWDXC",37,0)
 . S OIL(ORI,"USID")=USID
"RTN","ORWDXC",38,0)
 . S ORX=ORX+1,ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_USID
"RTN","ORWDXC",39,0)
 . S:$P(OIL(ORI),U,2)="PSIV" $P(ORX(ORX),"|",7)=$P($P(OIL(ORI),U,3),";")
"RTN","ORWDXC",40,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"SELECT",.OIL,.ORDODSG)
"RTN","ORWDXC",41,0)
 I $D(ORY) D RETURN^ORCHECK ; expects ORY, ORCHECK
"RTN","ORWDXC",42,0)
 K ORX,ORY
"RTN","ORWDXC",43,0)
 ; do the ACCEPT order checks
"RTN","ORWDXC",44,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",45,0)
 . Q:'OIL(ORI)
"RTN","ORWDXC",46,0)
 . S ORX=ORX+1
"RTN","ORWDXC",47,0)
 . S ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_OIL(ORI,"USID")_"|"_STRT
"RTN","ORWDXC",48,0)
 . S:$P(OIL(ORI),U,2)="LR" $P(ORX(ORX),"|",6)=$P(OIL(ORI),U,3)
"RTN","ORWDXC",49,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"ACCEPT",.OIL,.ORDODSG)
"RTN","ORWDXC",50,0)
 I $D(ORY) D RETURN^ORCHECK   ; expects ORY, ORCHECK
"RTN","ORWDXC",51,0)
 ; return ORCHECK as 1 dimensional list
"RTN","ORWDXC",52,0)
 D FDBDOWN^ORCHECK(0)
"RTN","ORWDXC",53,0)
 D OPOS(DFN)
"RTN","ORWDXC",54,0)
 D CHK2LST
"RTN","ORWDXC",55,0)
 D CHECKIT(.LST)
"RTN","ORWDXC",56,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",57,0)
 Q
"RTN","ORWDXC",58,0)
DELAY(LST,DFN,FID,STRT,ORL,OIL) ; Return list of Order Checks on Accept Delayed
"RTN","ORWDXC",59,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",60,0)
 ; OIL(n)=OIptr^PS|PSIV|LR^PkgInfo
"RTN","ORWDXC",61,0)
 N X,Y,ORCHECK,ORI,ORX,ORY,%DT
"RTN","ORWDXC",62,0)
 ; convert relative start date to real start date
"RTN","ORWDXC",63,0)
 S ORL=ORL_";SC(",X=STRT,STRT=""
"RTN","ORWDXC",64,0)
 D:X="AM" AM^ORCSAVE2 D:X="NEXT" NEXT^ORCSAVE2
"RTN","ORWDXC",65,0)
 I $L(X) S %DT="FTX" D ^%DT S:Y'>0 Y="" S STRT=Y
"RTN","ORWDXC",66,0)
 ; do the ACCEPT order checks
"RTN","ORWDXC",67,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",68,0)
 . S ORX=ORX+1
"RTN","ORWDXC",69,0)
 . S ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_$$USID(OIL(ORI))_"|"_STRT
"RTN","ORWDXC",70,0)
 . I $P(OIL(ORI),U,2)="LR" S $P(ORX(ORX),"|",6)=$P(OIL(ORI),U,3)
"RTN","ORWDXC",71,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"ALL",.OIL)
"RTN","ORWDXC",72,0)
 I $D(ORY) D RETURN^ORCHECK   ; expects ORY, ORCHECK
"RTN","ORWDXC",73,0)
 ; return ORCHECK as 1 dimensional list
"RTN","ORWDXC",74,0)
 D CHK2LST
"RTN","ORWDXC",75,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",76,0)
 Q
"RTN","ORWDXC",77,0)
SESSION(LST,ORVP,ORLST) ; Return list of Order Checks on Release Order
"RTN","ORWDXC",78,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD")
"RTN","ORWDXC",79,0)
 N ORES,ORCHECK
"RTN","ORWDXC",80,0)
 S ORVP=+ORVP_";DPT("
"RTN","ORWDXC",81,0)
 S I=0 F  S I=$O(ORLST(I)) Q:'I  D
"RTN","ORWDXC",82,0)
 . I +$P(ORLST(I),";",2)'=1 Q  ; order not new
"RTN","ORWDXC",83,0)
 . I $P(ORLST(I),U,3)="0" Q    ; order not being released
"RTN","ORWDXC",84,0)
 . S ORES($P(ORLST(I),U))=""
"RTN","ORWDXC",85,0)
 D SESSION^ORCHECK
"RTN","ORWDXC",86,0)
 D OPOS(+ORVP)
"RTN","ORWDXC",87,0)
 D CHK2LST
"RTN","ORWDXC",88,0)
 D CHECKIT(.LST)
"RTN","ORWDXC",89,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD")
"RTN","ORWDXC",90,0)
 Q
"RTN","ORWDXC",91,0)
SAVECHK(OK,ORVP,RSN,LST)    ; Save order checks for session
"RTN","ORWDXC",92,0)
 N ORCHECK,ORIFN S OK=1
"RTN","ORWDXC",93,0)
 D LST2CHK
"RTN","ORWDXC",94,0)
 I $L(RSN)>0 S ORCHECK("OK")=RSN
"RTN","ORWDXC",95,0)
 S ORIFN=0 F  S ORIFN=$O(ORCHECK(ORIFN)) Q:'ORIFN  D OC^ORCSAVE2
"RTN","ORWDXC",96,0)
 Q
"RTN","ORWDXC",97,0)
DELORD(OK,ORIFN)      ; Delete order
"RTN","ORWDXC",98,0)
 N STS,DIK,DA
"RTN","ORWDXC",99,0)
 S STS=$P(^OR(100,+ORIFN,8,1,0),U,15),OK=0
"RTN","ORWDXC",100,0)
 I (STS=10)!(STS=11) D  Q  ; makes sure it's an unreleased order
"RTN","ORWDXC",101,0)
 . ;*400 - Delete unused replacement order
"RTN","ORWDXC",102,0)
 . N OLDIFN,DA,DIE,DR S OLDIFN=$P(^OR(100,+ORIFN,3),U,5) I $G(OLDIFN) D
"RTN","ORWDXC",103,0)
 . . S DA=+OLDIFN,DIE="^OR(100,",DR="9.1///@"
"RTN","ORWDXC",104,0)
 . . D ^DIE K DA,DIE,DR
"RTN","ORWDXC",105,0)
 . S DA=+ORIFN,DIK="^OR(100," Q:'DA
"RTN","ORWDXC",106,0)
 . D ^DIK
"RTN","ORWDXC",107,0)
 . S OK=1
"RTN","ORWDXC",108,0)
 . D DELETE^OROCAPI1(+ORIFN)
"RTN","ORWDXC",109,0)
 Q
"RTN","ORWDXC",110,0)
USID(ORITMX) ; Return universal svc ID for an orderable item
"RTN","ORWDXC",111,0)
 ; ORITMX = OI^NMSP^PKGINFO
"RTN","ORWDXC",112,0)
 N RSLT,ORDRUG S RSLT=""
"RTN","ORWDXC",113,0)
 I $E($P(ORITMX,U,2),1,2)="PS" D
"RTN","ORWDXC",114,0)
 . I $P(ORITMX,U,2)="PSIV" D
"RTN","ORWDXC",115,0)
 . . N PSOI,TYPE,VOL S VOL=""
"RTN","ORWDXC",116,0)
 . . S PSOI=+$P($G(^ORD(101.43,+ORITMX,0)),U,2)
"RTN","ORWDXC",117,0)
 . . S TYPE=$P($P(ORITMX,U,3),";")
"RTN","ORWDXC",118,0)
 . . I TYPE="B" S VOL=$P($P(ORITMX,U,3),";",2)
"RTN","ORWDXC",119,0)
 . . D ENDDIV^PSJORUTL(PSOI,TYPE,VOL,.ORDRUG)
"RTN","ORWDXC",120,0)
 . . S ORDRUG=+ORDRUG
"RTN","ORWDXC",121,0)
 . E  S ORDRUG=+$P(ORITMX,U,3)
"RTN","ORWDXC",122,0)
 . S RSLT=$$ENDCM^PSJORUTL(ORDRUG)
"RTN","ORWDXC",123,0)
 . S RSLT=$P(RSLT,U,3)_"^^99NDF^"_ORDRUG_U_$$NAME50^ORPEAPI(ORDRUG)_"^99PSD"
"RTN","ORWDXC",124,0)
 E  S RSLT=$$USID^ORMBLD(+ORITMX)
"RTN","ORWDXC",125,0)
 I +$P(RSLT,U)=0,+($P(RSLT,U,4)=0) S RSLT="" ; has to be null (why?)
"RTN","ORWDXC",126,0)
 Q RSLT
"RTN","ORWDXC",127,0)
 ;
"RTN","ORWDXC",128,0)
CHK2LST ; creates list that can be passed to broker from ORCHECK array
"RTN","ORWDXC",129,0)
 ; expects ORCHECK to be present and populates LST
"RTN","ORWDXC",130,0)
 D REMDUPS ;similar to REMDUPS^ORCHECK
"RTN","ORWDXC",131,0)
 N ORIFN,ORID,CDL,I,ILST,LASTIFN,RESERVED,ORCHECK2,ORNUM,OLIST,SORT
"RTN","ORWDXC",132,0)
 S ILST=0,LASTIFN=0,RESERVED=0,OLIST=0,SORT=""
"RTN","ORWDXC",133,0)
 S ORIFN="" F  S ORIFN=$O(ORCHECK(ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",134,0)
 . S CDL=0 F  S CDL=$O(ORCHECK(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",135,0)
 . . S SORT=$S(+SORT=0:CDL,CDL<+SORT:CDL,1:+SORT)
"RTN","ORWDXC",136,0)
 . . S I=0 F  S I=$O(ORCHECK(ORIFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",137,0)
 . . . S ORCHECK2(ORIFN,CDL,+ORCHECK(ORIFN,CDL,I),I)=ORCHECK(ORIFN,CDL,I)
"RTN","ORWDXC",138,0)
 . S:SORT'="" SORT(SORT,ORIFN)="",SORT=""
"RTN","ORWDXC",139,0)
 K ORCHECK
"RTN","ORWDXC",140,0)
 S ORIFN="" F  S ORIFN=$O(ORCHECK2(ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",141,0)
 . S CDL=0 F  S CDL=$O(ORCHECK2(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",142,0)
 . . S ORNUM=0 F  S ORNUM=$O(ORCHECK2(ORIFN,CDL,ORNUM)) Q:'ORNUM  D
"RTN","ORWDXC",143,0)
 . . . S I=0 F  S I=$O(ORCHECK2(ORIFN,CDL,ORNUM,I)) Q:'I  D
"RTN","ORWDXC",144,0)
 . . . . S OLIST=OLIST+1,ORCHECK(ORIFN,CDL,OLIST)=ORCHECK2(ORIFN,CDL,ORNUM,I)
"RTN","ORWDXC",145,0)
 S SORT=0 F  S SORT=$O(SORT(SORT)) Q:'SORT  D
"RTN","ORWDXC",146,0)
 . S ORIFN="" F  S ORIFN=$O(SORT(SORT,ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",147,0)
 . . S CDL=0 F  S CDL=$O(ORCHECK(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",148,0)
 . . . S I=0 F  S I=$O(ORCHECK(ORIFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",149,0)
 . . . . I LASTIFN'=ORIFN S LASTIFN=ORIFN,RESERVED=ILST+1,ILST=ILST+1 ; saves a spot for the RDI warning at the top of each order's checks
"RTN","ORWDXC",150,0)
 . . . . S ORID=ORIFN I +ORID,(+ORID=ORID) S ORID=ORID_";1"
"RTN","ORWDXC",151,0)
 . . . . I '$P(ORCHECK(ORIFN,CDL,I),U,2) Q  ; CDL="" means don't show
"RTN","ORWDXC",152,0)
 . . . . I $P(ORCHECK(ORIFN,CDL,I),U,1)=99 S LST(RESERVED)=ORID_U_ORCHECK(ORIFN,CDL,I) Q  ;Put RDI warning at the top of each order's checks
"RTN","ORWDXC",153,0)
 . . . . S ILST=ILST+1,LST(ILST)=ORID_U_ORCHECK(ORIFN,CDL,I)
"RTN","ORWDXC",154,0)
 Q
"RTN","ORWDXC",155,0)
LST2CHK ; create ORCHECK array from list passed by broker
"RTN","ORWDXC",156,0)
 N ORIFN,CDL,I,ILST S I=0
"RTN","ORWDXC",157,0)
 S ILST="" F  S ILST=$O(LST("ORCHECKS",ILST)) Q:$L(ILST)'>0  D
"RTN","ORWDXC",158,0)
 . I $D(LST("ORCHECKS",ILST,0)) D
"RTN","ORWDXC",159,0)
 . . N J S J=0 S X=LST("ORCHECKS",ILST,J) F  S J=$O(LST("ORCHECKS",ILST,J)) Q:'J  S X=X_LST("ORCHECKS",ILST,J)
"RTN","ORWDXC",160,0)
 . I '$D(LST("ORCHECKS",ILST,0)) S X=LST("ORCHECKS",ILST)
"RTN","ORWDXC",161,0)
 . S ORIFN=$P(X,U),CDL=$P(X,U,3)
"RTN","ORWDXC",162,0)
 . I +$G(ORIFN)>0,+$G(CDL)>0 D  ;cla 12/16/03
"RTN","ORWDXC",163,0)
 . . S I=I+1,ORCHECK(+ORIFN,CDL,I)=$P(X,U,2,4)
"RTN","ORWDXC",164,0)
 Q
"RTN","ORWDXC",165,0)
CHECKIT(X) ;remove uncessesary duplication of Duplicate Therapy checks
"RTN","ORWDXC",166,0)
 N I,J,Y,Z
"RTN","ORWDXC",167,0)
 S I=0 F  S I=$O(X(I)) Q:'I  I $P(X(I),U,2)=17 D
"RTN","ORWDXC",168,0)
 .Q:$P($G(^ORD(100.8,17,0)),U)'="DUPLICATE DRUG THERAPY"
"RTN","ORWDXC",169,0)
 .N STR S STR=$P($P(X(I),"{",2),"}")
"RTN","ORWDXC",170,0)
 .N CLASS S CLASS=$P(X(I),"in the same therapeutic categor(ies): ",2)
"RTN","ORWDXC",171,0)
 .S Z(+X(I),I)=CLASS
"RTN","ORWDXC",172,0)
 .S J=0 F  S J=J+1 Q:J>$L(STR,", ")  D
"RTN","ORWDXC",173,0)
 ..S Y(+X(I),I,J)=$P(STR,", ",J)
"RTN","ORWDXC",174,0)
 S I="" F  S I=$O(Y(I)) Q:'$L(I)  D
"RTN","ORWDXC",175,0)
 .S J=0 F  S J=$O(Y(I,J)) Q:'J  D
"RTN","ORWDXC",176,0)
 ..S K=J F  S K=$O(Y(I,K)) Q:'K!('$D(Y(I,J)))  D
"RTN","ORWDXC",177,0)
 ...N A,B M A=Y(I,J),B=Y(I,K)
"RTN","ORWDXC",178,0)
 ...I $$AINB(.A,.B) D
"RTN","ORWDXC",179,0)
 ....N ADDCLASS S ADDCLASS=$P(Z(I,J),U)
"RTN","ORWDXC",180,0)
 ....K X(J),Y(I,J)
"RTN","ORWDXC",181,0)
 ....I X(K)'[ADDCLASS S X(K)=X(K)_", "_ADDCLASS
"RTN","ORWDXC",182,0)
 ...Q:'$D(Y(I,J))
"RTN","ORWDXC",183,0)
 ...I $$AINB(.B,.A) D
"RTN","ORWDXC",184,0)
 ....N ADDCLASS S ADDCLASS=$P(Z(I,K),U)
"RTN","ORWDXC",185,0)
 ....K X(K),Y(I,K)
"RTN","ORWDXC",186,0)
 ....I X(J)'[ADDCLASS S X(J)=X(J)_", "_ADDCLASS
"RTN","ORWDXC",187,0)
 Q
"RTN","ORWDXC",188,0)
AINB(A,B) ;if array A is a subset of array B then return 1, else return 0
"RTN","ORWDXC",189,0)
 N I,RET
"RTN","ORWDXC",190,0)
 S RET=1
"RTN","ORWDXC",191,0)
 S I=0 F  S I=$O(A(I)) Q:'I  I '$$XINA(A(I),.B) S RET=0 Q
"RTN","ORWDXC",192,0)
 Q RET
"RTN","ORWDXC",193,0)
XINA(X,A) ;if string X is an entry in array A then return 1, else return 0
"RTN","ORWDXC",194,0)
 N I,RET
"RTN","ORWDXC",195,0)
 S RET=0
"RTN","ORWDXC",196,0)
 S I=0 F  S I=$O(A(I)) Q:'I  I X=A(I) S RET=1 Q
"RTN","ORWDXC",197,0)
 Q RET
"RTN","ORWDXC",198,0)
REMDUPS ;
"RTN","ORWDXC",199,0)
 N IFN,CDL,I,J,CDL2 S IFN="NEW"
"RTN","ORWDXC",200,0)
 S CDL=0 F  S CDL=$O(ORCHECK(IFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",201,0)
 . S I=0 F  S I=$O(ORCHECK(IFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",202,0)
 .. S CDL2=0 F  S CDL2=$O(ORCHECK(IFN,CDL2)) Q:'CDL2  D
"RTN","ORWDXC",203,0)
 ... S J=I F  S J=$O(ORCHECK(IFN,CDL2,J)) Q:'J  I $TR($P($G(ORCHECK(IFN,CDL,I)),U,3),";",",")=$TR($P($G(ORCHECK(IFN,CDL2,J)),U,3),";",",") D
"RTN","ORWDXC",204,0)
 .... I CDL2<=CDL K ORCHECK(IFN,CDL2,J) S ORCHECK=$G(ORCHECK)-1
"RTN","ORWDXC",205,0)
 .... I CDL2>CDL S $P(ORCHECK(IFN,CDL,I),U,7)="X"
"RTN","ORWDXC",206,0)
 .. I $P(ORCHECK(IFN,CDL,I),U,7)="X" K ORCHECK(IFN,CDL,I) S ORCHECK=$G(ORCHECK)-1
"RTN","ORWDXC",207,0)
 Q
"RTN","ORWDXC",208,0)
REMDUPSX ;similar to REMDUPS^ORCHECK
"RTN","ORWDXC",209,0)
 N IFN,CDL,I S IFN="NEW"
"RTN","ORWDXC",210,0)
 S CDL=0 F  S CDL=$O(ORCHECK(IFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",211,0)
 . S I=0 F  S I=$O(ORCHECK(IFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",212,0)
 . . S J=I F  S J=$O(ORCHECK(IFN,CDL,J)) Q:'J  I $G(ORCHECK(IFN,CDL,I))=$G(ORCHECK(IFN,CDL,J)) K ORCHECK(IFN,CDL,J) S ORCHECK=$G(ORCHECK)-1
"RTN","ORWDXC",213,0)
 Q
"RTN","ORWDXC",214,0)
OPOS(DFN) ;handles saving and removing order checks that should only be displayed once per cprs session
"RTN","ORWDXC",215,0)
 ; expects ORCHECK
"RTN","ORWDXC",216,0)
 ; sets these order checks into the "Once Per cprs Session" global ^TMP($J,"OC-OPOS",DFN)
"RTN","ORWDXC",217,0)
 N I,J,K
"RTN","ORWDXC",218,0)
 S I="" F  S I=$O(ORCHECK(I)) Q:'$L(I)  D
"RTN","ORWDXC",219,0)
 .S J=0 F  S J=$O(ORCHECK(I,J)) Q:'J  D
"RTN","ORWDXC",220,0)
 ..S K=0 F  S K=$O(ORCHECK(I,J,K)) Q:'K  D
"RTN","ORWDXC",221,0)
 ...N ORTXT,ORTXTO,ORTXT0,ORTXTI,ORXTRAI
"RTN","ORWDXC",222,0)
 ...S ORTXTO="These checks could not be completed for this patient:"
"RTN","ORWDXC",223,0)
 ...Q:(ORCHECK(I,J,K)'[ORTXTO)
"RTN","ORWDXC",224,0)
 ...S ORTXT=ORTXTO
"RTN","ORWDXC",225,0)
 ...S ORXTRAI=$P($P(ORCHECK(I,J,K),"||",2),"&")
"RTN","ORWDXC",226,0)
 ...S ORTXTI=0 F  S ORTXTI=$O(^TMP($J,"ORK XTRA TXT",ORXTRAI,ORTXTO,ORTXTI))  Q:'ORTXTI  D
"RTN","ORWDXC",227,0)
 ....S ORTXT=ORTXT_$G(^TMP($J,"ORK XTRA TXT",ORXTRAI,ORTXTO,ORTXTI))
"RTN","ORWDXC",228,0)
 ...I $D(^TMP($J,"OC-OPOS",DFN,$E(ORTXT,1,225))) K ORCHECK(I,J,K) Q
"RTN","ORWDXC",229,0)
 ...S ^TMP($J,"OC-OPOS",DFN,$E(ORTXT,1,225))="" Q
"RTN","ORWDXC",230,0)
 Q
"VER")
8.0^22.2
**END**
**END**
