KIDS Distribution saved on Jul 16, 2015@15:38:07
PSO*7.0*282 & PSJ*5.0*194
**KIDS**:PSO*7.0*282^PSJ*5.0*194^

**INSTALL NAME**
PSO*7.0*282
"BLD",9742,0)
PSO*7.0*282^OUTPATIENT PHARMACY^0^3150716^y
"BLD",9742,4,0)
^9.64PA^^
"BLD",9742,6.3)
18
"BLD",9742,"ABPKG")
n
"BLD",9742,"KRN",0)
^9.67PA^779.2^20
"BLD",9742,"KRN",.4,0)
.4
"BLD",9742,"KRN",.401,0)
.401
"BLD",9742,"KRN",.402,0)
.402
"BLD",9742,"KRN",.403,0)
.403
"BLD",9742,"KRN",.5,0)
.5
"BLD",9742,"KRN",.84,0)
.84
"BLD",9742,"KRN",3.6,0)
3.6
"BLD",9742,"KRN",3.8,0)
3.8
"BLD",9742,"KRN",9.2,0)
9.2
"BLD",9742,"KRN",9.8,0)
9.8
"BLD",9742,"KRN",9.8,"NM",0)
^9.68A^20^20
"BLD",9742,"KRN",9.8,"NM",1,0)
PSOBKDED^^0^B82028505
"BLD",9742,"KRN",9.8,"NM",2,0)
PSOFSIG^^0^B52820017
"BLD",9742,"KRN",9.8,"NM",3,0)
PSOHELP^^0^B53907821
"BLD",9742,"KRN",9.8,"NM",4,0)
PSOHELP2^^0^B8274673
"BLD",9742,"KRN",9.8,"NM",5,0)
PSOHLDS2^^0^B94193549
"BLD",9742,"KRN",9.8,"NM",6,0)
PSOHLPIS^^0^B56723490
"BLD",9742,"KRN",9.8,"NM",7,0)
PSOHLSIG^^0^B24372866
"BLD",9742,"KRN",9.8,"NM",8,0)
PSOLBL2^^0^B36920595
"BLD",9742,"KRN",9.8,"NM",9,0)
PSONVNEW^^0^B22533044
"BLD",9742,"KRN",9.8,"NM",10,0)
PSOORED4^^0^B57161028
"BLD",9742,"KRN",9.8,"NM",11,0)
PSOORNE2^^0^B68999201
"BLD",9742,"KRN",9.8,"NM",12,0)
PSOQUTIL^^0^B2614810
"BLD",9742,"KRN",9.8,"NM",13,0)
PSOSIG^^0^B65537760
"BLD",9742,"KRN",9.8,"NM",14,0)
PSOSIGCX^^0^B33594823
"BLD",9742,"KRN",9.8,"NM",15,0)
PSOSIGDS^^0^B46304418
"BLD",9742,"KRN",9.8,"NM",16,0)
PSOSIGNO^^0^B19149557
"BLD",9742,"KRN",9.8,"NM",17,0)
PSOSIGTX^^0^B53937250
"BLD",9742,"KRN",9.8,"NM",18,0)
PSOSPSIG^^0^B53180136
"BLD",9742,"KRN",9.8,"NM",19,0)
PSOTALK1^^0^B5110576
"BLD",9742,"KRN",9.8,"NM",20,0)
PSOSTART^^1^
"BLD",9742,"KRN",9.8,"NM","B","PSOBKDED",1)

"BLD",9742,"KRN",9.8,"NM","B","PSOFSIG",2)

"BLD",9742,"KRN",9.8,"NM","B","PSOHELP",3)

"BLD",9742,"KRN",9.8,"NM","B","PSOHELP2",4)

"BLD",9742,"KRN",9.8,"NM","B","PSOHLDS2",5)

"BLD",9742,"KRN",9.8,"NM","B","PSOHLPIS",6)

"BLD",9742,"KRN",9.8,"NM","B","PSOHLSIG",7)

"BLD",9742,"KRN",9.8,"NM","B","PSOLBL2",8)

"BLD",9742,"KRN",9.8,"NM","B","PSONVNEW",9)

"BLD",9742,"KRN",9.8,"NM","B","PSOORED4",10)

"BLD",9742,"KRN",9.8,"NM","B","PSOORNE2",11)

"BLD",9742,"KRN",9.8,"NM","B","PSOQUTIL",12)

"BLD",9742,"KRN",9.8,"NM","B","PSOSIG",13)

"BLD",9742,"KRN",9.8,"NM","B","PSOSIGCX",14)

"BLD",9742,"KRN",9.8,"NM","B","PSOSIGDS",15)

"BLD",9742,"KRN",9.8,"NM","B","PSOSIGNO",16)

"BLD",9742,"KRN",9.8,"NM","B","PSOSIGTX",17)

"BLD",9742,"KRN",9.8,"NM","B","PSOSPSIG",18)

"BLD",9742,"KRN",9.8,"NM","B","PSOSTART",20)

"BLD",9742,"KRN",9.8,"NM","B","PSOTALK1",19)

"BLD",9742,"KRN",19,0)
19
"BLD",9742,"KRN",19.1,0)
19.1
"BLD",9742,"KRN",101,0)
101
"BLD",9742,"KRN",409.61,0)
409.61
"BLD",9742,"KRN",771,0)
771
"BLD",9742,"KRN",779.2,0)
779.2
"BLD",9742,"KRN",870,0)
870
"BLD",9742,"KRN",8989.51,0)
8989.51
"BLD",9742,"KRN",8989.52,0)
8989.52
"BLD",9742,"KRN",8994,0)
8994
"BLD",9742,"KRN","B",.4,.4)

"BLD",9742,"KRN","B",.401,.401)

"BLD",9742,"KRN","B",.402,.402)

"BLD",9742,"KRN","B",.403,.403)

"BLD",9742,"KRN","B",.5,.5)

"BLD",9742,"KRN","B",.84,.84)

"BLD",9742,"KRN","B",3.6,3.6)

"BLD",9742,"KRN","B",3.8,3.8)

"BLD",9742,"KRN","B",9.2,9.2)

"BLD",9742,"KRN","B",9.8,9.8)

"BLD",9742,"KRN","B",19,19)

"BLD",9742,"KRN","B",19.1,19.1)

"BLD",9742,"KRN","B",101,101)

"BLD",9742,"KRN","B",409.61,409.61)

"BLD",9742,"KRN","B",771,771)

"BLD",9742,"KRN","B",779.2,779.2)

"BLD",9742,"KRN","B",870,870)

"BLD",9742,"KRN","B",8989.51,8989.51)

"BLD",9742,"KRN","B",8989.52,8989.52)

"BLD",9742,"KRN","B",8994,8994)

"BLD",9742,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9742,"QUES",0)
^9.62^^
"BLD",9742,"REQB",0)
^9.611^10^10
"BLD",9742,"REQB",1,0)
PSO*7.0*60^2
"BLD",9742,"REQB",2,0)
PSO*7.0*225^2
"BLD",9742,"REQB",3,0)
PSO*7.0*265^2
"BLD",9742,"REQB",4,0)
PSO*7.0*276^2
"BLD",9742,"REQB",5,0)
PSO*7.0*294^2
"BLD",9742,"REQB",6,0)
PSO*7.0*313^2
"BLD",9742,"REQB",7,0)
PSO*7.0*318^2
"BLD",9742,"REQB",8,0)
PSO*7.0*333^2
"BLD",9742,"REQB",9,0)
PSO*7.0*383^2
"BLD",9742,"REQB",10,0)
PSO*7.0*434^2
"BLD",9742,"REQB","B","PSO*7.0*225",2)

"BLD",9742,"REQB","B","PSO*7.0*265",3)

"BLD",9742,"REQB","B","PSO*7.0*276",4)

"BLD",9742,"REQB","B","PSO*7.0*294",5)

"BLD",9742,"REQB","B","PSO*7.0*313",6)

"BLD",9742,"REQB","B","PSO*7.0*318",7)

"BLD",9742,"REQB","B","PSO*7.0*333",8)

"BLD",9742,"REQB","B","PSO*7.0*383",9)

"BLD",9742,"REQB","B","PSO*7.0*434",10)

"BLD",9742,"REQB","B","PSO*7.0*60",1)

"MBREQ")
0
"ORD",0,9.8)
9.8;;1;RTNF^XPDTA;RTNE^XPDTA
"ORD",0,9.8,0)
ROUTINE
"PKG",206,-1)
1^1
"PKG",206,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",206,20,0)
^9.402P^^
"PKG",206,22,0)
^9.49I^1^1
"PKG",206,22,1,0)
7.0^3021122^3021202^66481
"PKG",206,22,1,"PAH",1,0)
282^3150716^1231
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
20
"RTN","PSOBKDED")
0^1^B82028505
"RTN","PSOBKDED",1,0)
PSOBKDED ;BIR/SAB - Edit backdoor Rx Order entry ;04/17/95
"RTN","PSOBKDED",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,46,91,78,99,117,133,143,268,378,416,282**;DEC 1997;Build 18
"RTN","PSOBKDED",3,0)
 ;Ref PS(50.607 IA 2221
"RTN","PSOBKDED",4,0)
 ;Ref PS(50.7 IA 2223
"RTN","PSOBKDED",5,0)
 ;Ref PS(51.2 IA 2226
"RTN","PSOBKDED",6,0)
 ;Ref PSDRUG( IA 221
"RTN","PSOBKDED",7,0)
 ;Ref DOSE^PSSORPH IA 3234
"RTN","PSOBKDED",8,0)
 ;Ref PS(55 IA 2228
"RTN","PSOBKDED",9,0)
1 S %DT="AEX",%DT(0)=-PSONEW("FILL DATE"),Y=PSONEW("ISSUE DATE") X ^DD("DD") S %DT("A")="ISSUE DATE: ",%DT("B")=Y D ^%DT
"RTN","PSOBKDED",10,0)
 I "^"[$E(X) D KX K %DT Q
"RTN","PSOBKDED",11,0)
 G:Y=-1 1 S (PSOID,PSONEW("ISSUE DATE"))=Y D KX K %DT
"RTN","PSOBKDED",12,0)
 Q
"RTN","PSOBKDED",13,0)
2 S PSONEW("FLD")=2 D FILLDT^PSODIR2(.PSONEW) ;Fdt
"RTN","PSOBKDED",14,0)
 Q
"RTN","PSOBKDED",15,0)
3 S:$G(POERR) PSONEW("ISSUE DATE")=PSOID
"RTN","PSOBKDED",16,0)
 S PSONEW("FLD")=3 D PTSTAT^PSODIR1(.PSONEW) ;Sta
"RTN","PSOBKDED",17,0)
 Q
"RTN","PSOBKDED",18,0)
4 S PSONEW("FLD")=4 D PROV^PSODIR(.PSONEW) ;Pro
"RTN","PSOBKDED",19,0)
 Q
"RTN","PSOBKDED",20,0)
5 S PSONEW("FLD")=5 D CLINIC^PSODIR2(.PSONEW) ;Cli
"RTN","PSOBKDED",21,0)
 Q
"RTN","PSOBKDED",22,0)
6 S PSONEW("FLD")=6 D ^PSODRG,EN^PSODIAG ;Drg/ICD
"RTN","PSOBKDED",23,0)
 D 6^PSODRGN
"RTN","PSOBKDED",24,0)
 Q
"RTN","PSOBKDED",25,0)
7 S PSONEW("FLD")=7 D QTY^PSODIR1(.PSONEW) ;Qty
"RTN","PSOBKDED",26,0)
 Q
"RTN","PSOBKDED",27,0)
8 S PSONEW("FLD")=8 D DAYS^PSODIR1(.PSONEW) ;Day
"RTN","PSOBKDED",28,0)
 K PSMAX,PSTMAX D REF^PSOORNEW S PSONEW("N# REF")=PSONEW("# OF REFILLS")
"RTN","PSOBKDED",29,0)
 Q
"RTN","PSOBKDED",30,0)
9 S PSONEW("FLD")=9 D REFILL^PSODIR1(.PSONEW) ;Ref
"RTN","PSOBKDED",31,0)
 K PSMAX,PSTMAX
"RTN","PSOBKDED",32,0)
 Q
"RTN","PSOBKDED",33,0)
10 S PSONEW("FLD")="3A" N PSOEDDOS S PSOEDDOS=1 D DOSE^PSODIR(.PSONEW) ;Dose
"RTN","PSOBKDED",34,0)
 Q
"RTN","PSOBKDED",35,0)
 ;
"RTN","PSOBKDED",36,0)
 Q  I $G(COPY),$G(SIGOK) S PSOFDR=1 K PSONEW("SIG")
"RTN","PSOBKDED",37,0)
 S PSONEW("FLD")=10 D SIG^PSODIR1(.PSONEW) ;Sig
"RTN","PSOBKDED",38,0)
 I $G(COPY) K PSOFDR
"RTN","PSOBKDED",39,0)
 S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR D KV
"RTN","PSOBKDED",40,0)
 Q
"RTN","PSOBKDED",41,0)
INS S PSONEW("FLD")="3B" D INS^PSODIR(.PSONEW) ;Ins
"RTN","PSOBKDED",42,0)
 Q
"RTN","PSOBKDED",43,0)
11 S PSONEW("FLD")=11 D COPIES^PSODIR1(.PSONEW) ;Cop
"RTN","PSOBKDED",44,0)
 Q
"RTN","PSOBKDED",45,0)
12 S PSONEW("FLD")=12 D MW^PSODIR2(.PSONEW) ;M/W
"RTN","PSOBKDED",46,0)
 Q
"RTN","PSOBKDED",47,0)
13 S PSONEW("FLD")=13 D RMK^PSODIR2(.PSONEW) ;Rem
"RTN","PSOBKDED",48,0)
 Q
"RTN","PSOBKDED",49,0)
DOSE ;backdoor
"RTN","PSOBKDED",50,0)
 I '$G(PSONEW("ENT")) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (5) Dosage Ordered: " G INS1
"RTN","PSOBKDED",51,0)
 S SD=1 F I=1:1:PSONEW("ENT") D 
"RTN","PSOBKDED",52,0)
 .I '$G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOBKDED",53,0)
 .S:$G(SD)=1 IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (5)",DS=1 K SD
"RTN","PSOBKDED",54,0)
 .D DOSE1
"RTN","PSOBKDED",55,0)
INS1 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (6)Pat Instruction:"
"RTN","PSOBKDED",56,0)
INS2 I $O(PSONEW("SIG",0)) F D=0:0 S D=$O(PSONEW("SIG",D)) Q:'D  D
"RTN","PSOBKDED",57,0)
 .F SG=1:1:$L(PSONEW("SIG",D)) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("SIG",D)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " D
"RTN","PSOBKDED",58,0)
 ..S:$P(PSONEW("SIG",D)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("SIG",D)," ",SG)
"RTN","PSOBKDED",59,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") D  Q
"RTN","PSOBKDED",60,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" Other Patient Inst.: "
"RTN","PSOBKDED",61,0)
 .I $G(^PSRX(+$G(PSONEW("OIRXN")),"INSS"))]"" S PSONEW("SINS")=^PSRX(PSONEW("OIRXN"),"INSS")
"RTN","PSOBKDED",62,0)
 .S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_$G(PSONEW("SINS"))
"RTN","PSOBKDED",63,0)
 Q
"RTN","PSOBKDED",64,0)
 ;
"RTN","PSOBKDED",65,0)
DOSE1 I $G(DS)=1 D  K DS G DU
"RTN","PSOBKDED",66,0)
 .S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_" Dosage Ordered: "_$S($E(PSONEW("DOSE",I),1)="."&($G(PSONEW("DOSE ORDERED",I))):"0",1:"")_PSONEW("DOSE",I)_$S($G(PSONEW("UNITS",I))'="":" ("_$P(^PS(50.607,PSONEW("UNITS",I),0),"^")_")",1:"")
"RTN","PSOBKDED",67,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Dosage Ordered: "_$S($E(PSONEW("DOSE",I),1)="."&($G(PSONEW("DOSE ORDERED",I))):"0",1:"")_PSONEW("DOSE",I)_$S($G(PSONEW("UNITS",I))'="":" ("_$P(^PS(50.607,PSONEW("UNITS",I),0),"^")_")",1:"")
"RTN","PSOBKDED",68,0)
DU I '$G(PSONEW("DOSE ORDERED",I)),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Oth. Lang. Dosage: "_$G(PSONEW("ODOSE",I))
"RTN","PSOBKDED",69,0)
 I $G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOBKDED",70,0)
 S:$G(PSONEW("DOSE ORDERED",I)) IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Dispense Units: "_$S($E($G(PSONEW("DOSE ORDERED",I)),1)=".":"0",1:"")_$G(PSONEW("DOSE ORDERED",I))
"RTN","PSOBKDED",71,0)
 I $G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("NOUN",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Noun: "_PSONEW("NOUN",I)
"RTN","PSOBKDED",72,0)
 I $G(PSONEW("ROUTE",I)) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Route: "_$P(^PS(51.2,PSONEW("ROUTE",I),0),"^")
"RTN","PSOBKDED",73,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="            Schedule: "_PSONEW("SCHEDULE",I)
"RTN","PSOBKDED",74,0)
 I $G(PSONEW("DURATION",I))]"" D
"RTN","PSOBKDED",75,0)
 .S IEN=IEN+1
"RTN","PSOBKDED",76,0)
 .S ^TMP("PSOPO",$J,IEN,0)="           *Duration: "_PSONEW("DURATION",I)_" ("_$S(PSONEW("DURATION",I)["M":"MINUTES",PSONEW("DURATION",I)["W":"WEEKS",PSONEW("DURATION",I)["L":"MONTHS",PSONEW("DURATION",I)["H":"HOURS",1:"DAYS")_")"
"RTN","PSOBKDED",77,0)
 I $G(PSONEW("CONJUNCTION",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="         Conjunction: "_$S($G(PSONEW("CONJUNCTION",I))="A":"AND",$G(PSONEW("CONJUNCTION",I))="T":"THEN",$G(PSONEW("CONJUNCTION",I))="X":"EXCEPT",1:"")
"RTN","PSOBKDED",78,0)
 Q
"RTN","PSOBKDED",79,0)
RTE I $G(DRET) S PSORXED("ROUTE",ENT)=""
"RTN","PSOBKDED",80,0)
 I $G(RTE) K RTE
"RTN","PSOBKDED",81,0)
 K DIR,DIRUT S DIR(0)="FO^2:45",DIR("A")="ROUTE",DIR("?")="^D HLP^PSOORED4"
"RTN","PSOBKDED",82,0)
 S DIR("B")=$S($G(PSORXED("ROUTE",ENT)):$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),$G(RTE)]"":RTE,$G(DRET):"",1:"PO") K:DIR("B")="" DIR("B")
"RTN","PSOBKDED",83,0)
 ;I '$G(PSORXED("ROUTE",ENT)),$G(PSOREEDT) K DIR("B")
"RTN","PSOBKDED",84,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="RTE",JUMP=1 K DIRUT,DTOUT Q
"RTN","PSOBKDED",85,0)
 Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOBKDED",86,0)
 I X="@"!(X="") K RTE,ERTE S DRET=1,PSORXED("ROUTE",ENT)="" Q
"RTN","PSOBKDED",87,0)
 K DRET I X=$P($G(^PS(51.2,+$G(PSORXED("ROUTE",ENT)),0)),"^") S RTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),ERTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^",2) W X_" "_$G(ERTE) Q
"RTN","PSOBKDED",88,0)
 S DIC=51.2,DIC(0)="QEZM",DIC("S")="I $P(^(0),""^"",4)" D ^DIC Q:X[U  G:Y=-1 RTE W "  "_$P(Y(0),"^",2)
"RTN","PSOBKDED",89,0)
 S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2)
"RTN","PSOBKDED",90,0)
 Q
"RTN","PSOBKDED",91,0)
ASK K JUMP,UNITN,DOSE D KV D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN)
"RTN","PSOBKDED",92,0)
 I $D(DOSE("DD")) I $G(PSOFROM)="PENDING"!($G(PSOREEDQ)) D LST2^PSOBKDE1 G ASK1
"RTN","PSOBKDED",93,0)
 D:$G(PSOFROM)="NEW"&($G(PSORX("EDIT"))']"")!($G(PSOFROM1))!($G(COPY)) LST^PSOBKDE1:$O(DOSE(0))
"RTN","PSOBKDED",94,0)
ASK1 S STRE=$P($G(DOSE("DD",PSODRUG("IEN"))),"^",5),UNITN=$P($G(DOSE("DD",PSODRUG("IEN"))),"^",6),DOSE("LD")=$P($G(DOSE("DD",PSODRUG("IEN"))),"^",11)
"RTN","PSOBKDED",95,0)
 W ! S DIR(0)="F^1:60",DIR("A",1)="Select from list of Available Dosages, Enter Free Text Dose",DIR("?")="^D LST1^PSOBKDE1",DIR("A")="or Enter a Question Mark (?) to view list"
"RTN","PSOBKDED",96,0)
 I $G(PSORXED("DOSE",ENT))]"" S DIR("B")=PSORXED("DOSE",ENT) D
"RTN","PSOBKDED",97,0)
 .I $G(PSORXED("UNITS",ENT))]"",DIR("B")'[($P($G(^PS(50.607,PSORXED("UNITS",ENT),0)),"^")) S DIR("B")=DIR("B")_$P($G(^PS(50.607,PSORXED("UNITS",ENT),0)),"^")
"RTN","PSOBKDED",98,0)
 K:$G(PSOREEDQ)!($G(PSOBDRG)) DIR("B")
"RTN","PSOBKDED",99,0)
 D ^DIR
"RTN","PSOBKDED",100,0)
 I X[U,$L(X)>1 S FIELD="ASK",JUMP=1 K DIRUT,DTOUT Q
"RTN","PSOBKDED",101,0)
 I $D(DIRUT) S:$G(ORD) PSODSPL=1 Q
"RTN","PSOBKDED",102,0)
 I X=$G(PSORXED("DOSE",ENT)),$D(DOSE(Y)) G GD1
"RTN","PSOBKDED",103,0)
 I X=$G(PSORXED("DOSE",ENT)) D  G DOS
"RTN","PSOBKDED",104,0)
 .S DOSE=X,UNITS=$G(PSORXED("UNITS",ENT))
"RTN","PSOBKDED",105,0)
 .I DOSE'?.N&(DOSE'?.N1".".N)!'DOSE("LD") S (UNITN,UNITS,PSORXED("UNITS",ENT))="" K PSORXED("DOSE ORDERED",ENT),DUPD,PSORXED("NOUN",ENT)
"RTN","PSOBKDED",106,0)
GD1 N PSORXTE
"RTN","PSOBKDED",107,0)
 I $D(DOSE(Y)) D  G DOS ;from list
"RTN","PSOBKDED",108,0)
 .S DOSE=$S($P(DOSE(Y),"^"):$P(DOSE(Y),"^"),$P(DOSE(Y),"^",3)]"":$P(DOSE(Y),"^",3),1:1),DOLST=Y
"RTN","PSOBKDED",109,0)
 .I $P(DOSE(Y),"^") S UNITS=$P(DOSE(Y),"^",2),DUPD=$P(DOSE(Y),"^",3),UNITN=$P(DOSE("DD",PSODRUG("IEN")),"^",6),PSORXTE("DOSE ORDERED",ENT)=DUPD
"RTN","PSOBKDED",110,0)
 .S PSORXTE("NOUN",ENT)=$P(DOSE(Y),"^",6),PSORXTE("VERB",ENT)=$P(DOSE(Y),"^",8)
"RTN","PSOBKDED",111,0)
 .I DOSE'?.N&(DOSE'?.N1".".N)!'DOSE("LD") D  Q
"RTN","PSOBKDED",112,0)
 ..S (UNITN,UNITS,PSORXED("UNITS",ENT))="" K PSORXED("DOSE ORDERED",ENT),DUPD,PSORXED("NOUN",ENT)
"RTN","PSOBKDED",113,0)
 ..I $P($G(^PS(55,PSODFN,"LAN")),"^"),$G(PSOFROM)="PENDING" D LAN^PSOORED5 Q
"RTN","PSOBKDED",114,0)
 ..I $P($G(^PS(55,PSODFN,"LAN")),"^"),$G(PSOFROM)="NEW" D LAN^PSOORED5
"RTN","PSOBKDED",115,0)
 .S PSORXTE("UNITS",ENT)=$G(UNITS)
"RTN","PSOBKDED",116,0)
 S DOSE=Y,DOLST=0 ;non-numeric and numeric not in list
"RTN","PSOBKDED",117,0)
 I DOSE("LD") D
"RTN","PSOBKDED",118,0)
 .F I=1:1:$L(DOSE)  I $E(DOSE,I)'?.N&($E(DOSE,I)'?1" ")&($E(DOSE,I)'?1".") S DCHK=$G(DCHK)_$E(DOSE,I)
"RTN","PSOBKDED",119,0)
 .I $G(DCHK)]"" D
"RTN","PSOBKDED",120,0)
 ..S DCHK=$TR(DCHK,"qwertyuioplkjhgfdsazxcvbnm","QWERTYUIOPLKJHGFDSAZXCVBNM")
"RTN","PSOBKDED",121,0)
 ..I DCHK=UNITN S DOSE=+DOSE
"RTN","PSOBKDED",122,0)
 K I,DCHK
"RTN","PSOBKDED",123,0)
 S PSOINDT=$$GET1^DIQ(50,PSODRUG("IEN"),100,"I") I PSOINDT,DT>PSOINDT G DOS
"RTN","PSOBKDED",124,0)
 S PSORXTE("NOUN",ENT)=$P(DOSE("DD",PSODRUG("IEN")),"^",9),PSORXTE("VERB",ENT)=$P(DOSE("DD",PSODRUG("IEN")),"^",10)
"RTN","PSOBKDED",125,0)
 I DOSE'?.N&(DOSE'?.N1".".N)!'DOSE("LD") S (UNITN,UNITS,PSORXED("UNITS",ENT))="" K PSORXED("NOUN",ENT),PSORXED("ODOSE",ENT) G DOS
"RTN","PSOBKDED",126,0)
 S:$P(DOSE("DD",PSODRUG("IEN")),"^",6)]"" (PSORXTE("UNITS",ENT),UNITS)=$O(^PS(50.607,"B",$P(DOSE("DD",PSODRUG("IEN")),"^",6),0)),UNITN=$P(DOSE("DD",PSODRUG("IEN")),"^",6)
"RTN","PSOBKDED",127,0)
 S:$P(DOSE("DD",PSODRUG("IEN")),"^",5) DUPD=DOSE/$P(DOSE("DD",PSODRUG("IEN")),"^",5),PSORXTE("DOSE ORDERED",ENT)=DUPD
"RTN","PSOBKDED",128,0)
DOS W " "_$S($E(DOSE,1)="."&($G(UNITN)'=""):"0",1:"")_DOSE W:$G(UNITN)'="" UNITN
"RTN","PSOBKDED",129,0)
 W ! K DIR,DIRUT S DIR(0)="Y",DIR("A")="You entered "_$S($E(DOSE,1)="."&($G(UNITN)'=""):"0",1:"")_DOSE_$S($G(UNITN)'="":UNITN,1:"")_" is this correct",DIR("B")="Yes"
"RTN","PSOBKDED",130,0)
 D ^DIR I 'Y D KX K DOSE,UNITS,PSORXTE,PSOINDT G ASK
"RTN","PSOBKDED",131,0)
 S PSORXED("DOSE",ENT)=DOSE
"RTN","PSOBKDED",132,0)
 S:$G(PSORXTE("DOSE ORDERED",ENT))]"" PSORXED("DOSE ORDERED",ENT)=PSORXTE("DOSE ORDERED",ENT)
"RTN","PSOBKDED",133,0)
 S:$G(PSORXTE("NOUN",ENT))]"" PSORXED("NOUN",ENT)=PSORXTE("NOUN",ENT)
"RTN","PSOBKDED",134,0)
 S:$G(PSORXTE("VERB",ENT))]"" PSORXED("VERB",ENT)=PSORXTE("VERB",ENT)
"RTN","PSOBKDED",135,0)
 S:$G(PSORXTE("UNITS",ENT))]"" PSORXED("UNITS",ENT)=PSORXTE("UNITS",ENT)
"RTN","PSOBKDED",136,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD"),$P($G(^PS(55,PSODFN,"LAN")),"^") D
"RTN","PSOBKDED",137,0)
 .K OTHDOS(ENT) D KX S DIR(0)="52.0113,9"
"RTN","PSOBKDED",138,0)
 .I '$G(OTHDOS(ENT)),$G(PSORXED("ODOSE",ENT))']"" D LAN^PSOORED5
"RTN","PSOBKDED",139,0)
 .I $G(PSORXED("ODOSE",ENT))]"" S DIR("B")=PSORXED("ODOSE",ENT) K:DIR("B")="" DIR("B")
"RTN","PSOBKDED",140,0)
 .K DTOUT,DUOUT,DIRUT,Y,X D ^DIR K DIR K:$G(X)="@"!($G(X)="") DIRUT I $D(DIRUT) Q
"RTN","PSOBKDED",141,0)
 .I X="@" S OTHDOS(ENT)=1 D KX K PSORXED("ODOSE",ENT) Q
"RTN","PSOBKDED",142,0)
 .S:X'="" PSORXED("ODOSE",ENT)=X
"RTN","PSOBKDED",143,0)
 Q
"RTN","PSOBKDED",144,0)
 ;
"RTN","PSOBKDED",145,0)
SCH D KX
"RTN","PSOBKDED",146,0)
 ;*282 Allow multi-word schedules
"RTN","PSOBKDED",147,0)
 S DIR("?")="^D SCHLP^PSOORED4",DIR("A")="Schedule: ",DIR(0)="FA^1:20^I X[""""""""!(X?.E1C.E)!($A(X)=45)!($L(X,"" "")>$S(X[""PRN"":4,1:3))!($L(X)>20)!($L(X)<1) K X"
"RTN","PSOBKDED",148,0)
 I '$D(PSOSCH),'$D(PSORXED("SCHEDULE",ENT)),$P(^PS(50.7,PSODRUG("OI"),0),"^",8)]"" S PSOSCH=$P(^PS(50.7,PSODRUG("OI"),0),"^",8)
"RTN","PSOBKDED",149,0)
 S DIR("B")=$S($D(PSOSCH)&('$D(PSORXED("SCHEDULE",ENT))):PSOSCH,$G(PSORXED("SCHEDULE",ENT))]"":PSORXED("SCHEDULE",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOBKDED",150,0)
 I $G(PSORXED("SCHEDULE",ENT))']"",$G(PSOREEDT) K DIR("B")
"RTN","PSOBKDED",151,0)
 D ^DIR
"RTN","PSOBKDED",152,0)
 Q
"RTN","PSOBKDED",153,0)
KX K X,Y
"RTN","PSOBKDED",154,0)
KV K DTOUT,DUOUT,DIR,DIRUT
"RTN","PSOBKDED",155,0)
 Q
"RTN","PSOFSIG")
0^2^B52820017
"RTN","PSOFSIG",1,0)
PSOFSIG ;BIR/RTR-Parse out and create Pharmacy Sig ;7/21/96
"RTN","PSOFSIG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,282**;DEC 1997;Build 18
"RTN","PSOFSIG",3,0)
 ;External reference to File #50.7 supported by DBIA 2223
"RTN","PSOFSIG",4,0)
 ;External reference to File #51 supported by DBIA 2224
"RTN","PSOFSIG",5,0)
 ;External reference to File #51.1 supported by DBIA 2225
"RTN","PSOFSIG",6,0)
 ;External reference to File #51.2 supported by DBIA 2226
"RTN","PSOFSIG",7,0)
 ;External reference to File #50.606 supported by DBIA 2174
"RTN","PSOFSIG",8,0)
EN(PSOFX,PSOPTSIG) ;
"RTN","PSOFSIG",9,0)
 N LIM,VAR,VAR1
"RTN","PSOFSIG",10,0)
 N SDF,SZZ,ZZS,ZZSB,SSZZ,SCHHOLD,GGGZ,SGLFLAG,SGLOOP,ZSCHED,SPFG,PSNOUN,MEDEXP,PSDUR,NOUN,SCHED,INTERVAL,SIG0,SIG2,SIG3,SDL,WW,TODOSE,PDAYS,WWFL,PSOCJ
"RTN","PSOFSIG",11,0)
 N VERBX,SSS,TT,DCOUNT,PREP,VERB,FFF,GGG,SIGDS,SIGRT,PSOROUTE,PSOSG1,PSOSG2,RTC,RTCA,RTCF,RTCNT,PSODCT,PSOBDCT
"RTN","PSOFSIG",12,0)
 K SIG
"RTN","PSOFSIG",13,0)
 S TODOSE=0 F WW=0:0 S WW=$O(PSOFX("DOSE",WW)) Q:'WW  S TODOSE=WW
"RTN","PSOFSIG",14,0)
 Q:'TODOSE
"RTN","PSOFSIG",15,0)
 S SIGDS=+$P($G(^PS(50.7,+$G(PSODRUG("OI")),0)),"^",2),PREP=$P($G(^PS(50.606,SIGDS,"MISC")),"^",3)
"RTN","PSOFSIG",16,0)
 S RTCNT=0 K RTC,RTCA,RTCF F SSS=1:1:TODOSE D
"RTN","PSOFSIG",17,0)
 .S SIG0(SSS)=$S($G(PSOFX("DOSE ORDERED",SSS))'="":$G(PSOFX("DOSE ORDERED",SSS)),1:$G(PSOFX("DOSE",SSS)))
"RTN","PSOFSIG",18,0)
 .S VERBX(SSS)=$S($G(PSOFX("VERB",SSS))'="":$G(PSOFX("VERB",SSS)),1:"")
"RTN","PSOFSIG",19,0)
 .S PSNOUN(SSS)=$G(PSOFX("NOUN",SSS))
"RTN","PSOFSIG",20,0)
 .S RTC=+$G(PSOFX("ROUTE",SSS)) I RTC S:'RTCNT RTCA=RTC S RTCNT=RTCNT+1
"RTN","PSOFSIG",21,0)
 .I RTCNT>1,$G(RTC),$G(RTC)'=$G(RTCA) S RTCF=1
"RTN","PSOFSIG",22,0)
 .S PSOROUTE(SSS)=$S($P($G(^PS(51.2,+$G(PSOFX("ROUTE",SSS)),0)),"^",2)'="":$P(^(0),"^",2),$P($G(^(0)),"^",3)'="":$P(^(0),"^",3),1:$P($G(^(0)),"^")) S MEDEXP(SSS)=$S($P($G(^PS(51.2,+$G(PSOFX("ROUTE",SSS)),0)),"^",2)="":0,1:1)
"RTN","PSOFSIG",23,0)
 .S PDAYS(SSS)=$G(PSOFX("DURATION",SSS))
"RTN","PSOFSIG",24,0)
 .I $G(PSOFX("DURATION",SSS))'="",($E(PSOFX("DURATION",SSS),$L(PSOFX("DURATION",SSS)))'?1A) S PDAYS(SSS)=PDAYS(SSS)_"D"
"RTN","PSOFSIG",25,0)
 .S PSDUR(SSS)=$S($G(PDAYS(SSS))="":"NULL",1:"FOR "_$E($G(PDAYS(SSS)),1,($L($G(PDAYS(SSS)))-1))) D  I PSDUR(SSS)'="NULL" S PSDUR(SSS)=PSDUR(SSS)_" "_INTERVAL
"RTN","PSOFSIG",26,0)
 ..I PSDUR(SSS)'="NULL" S INTERVAL=$E(PDAYS(SSS),$L(PDAYS(SSS))),INTERVAL=$S(INTERVAL="D":"DAYS",INTERVAL="W":"WEEKS",INTERVAL="H":"HOURS",INTERVAL="L":"MONTHS",INTERVAL="M":"MINUTES",INTERVAL="S":"SECONDS",1:"") D
"RTN","PSOFSIG",27,0)
 ...I $G(INTERVAL)'="",$G(PSOFX("DURATION",SSS)),$G(PSOFX("DURATION",SSS))'>1 S INTERVAL=$E(INTERVAL,1,($L(INTERVAL)-1))
"RTN","PSOFSIG",28,0)
 ;282 Schedule Expander Changed
"RTN","PSOFSIG",29,0)
 F GGG=1:1:TODOSE S SCHED(GGG)=$$SCHE^PSOSIG($G(PSOFX("SCHEDULE",GGG)))
"RTN","PSOFSIG",30,0)
 ;282 End Change
"RTN","PSOFSIG",31,0)
 S (RTC,RTCA,PSOBDCT)=0 F FFF=0:0 S FFF=$O(SIG0(FFF)) Q:'FFF  D
"RTN","PSOFSIG",32,0)
 .K PSOSG1,PSOSG2 S VERB=$G(VERBX(FFF)) D VERB D:$G(PSNOUN(FFF))'=""&('$G(PSOSG1)) SSS
"RTN","PSOFSIG",33,0)
 .D FRAC
"RTN","PSOFSIG",34,0)
 .S SIG2(FFF)=$S($G(VERB)'=""&('$G(PSOSG1)):$G(VERB)_" ",1:"")_$S($G(PSOFX("DOSE ORDERED",FFF))'="":$S($G(PSOFRAC)'="":$G(PSOFRAC),1:$G(PSOFX("DOSE ORDERED",FFF)))_" ",1:$G(PSOFX("DOSE",FFF))_" ")
"RTN","PSOFSIG",35,0)
 .S PSOBDCT=PSOBDCT+1
"RTN","PSOFSIG",36,0)
 .K PSOFRAC,PSOFRACX
"RTN","PSOFSIG",37,0)
 .I RTC>0,$G(PSOROUTE(FFF))'="",'$G(RTCF) S RTCA=1
"RTN","PSOFSIG",38,0)
 .I $G(PSOROUTE(FFF))'="" S RTC=RTC+1
"RTN","PSOFSIG",39,0)
 .S SIG2(FFF)=SIG2(FFF)_$S($G(PSNOUN(FFF))'=""&('$G(PSOSG2)):$G(PSNOUN(FFF))_" ",1:"")_$S(PREP'=""&($G(MEDEXP(FFF)))&('RTCA):PREP_" ",1:"")
"RTN","PSOFSIG",40,0)
 .S SIG2(FFF)=SIG2(FFF)_$S(PSOROUTE(FFF)'=""&('RTCA):PSOROUTE(FFF)_" ",1:"")
"RTN","PSOFSIG",41,0)
 .;S SIG2(FFF)=SIG2(FFF)_$S(SCHED(FFF)'="":SCHED(FFF)_" ",1:"")_$S(PSDUR(FFF)'="NULL":PSDUR(FFF)_" ",1:"")_$S($G(PSOFX("CONJUNCTION",FFF))="A":"AND",$G(PSOFX("CONJUNCTION",FFF))="T":"THEN",$G(PSOFX("CONJUNCTION",FFF))="S":"THEN",1:"")
"RTN","PSOFSIG",42,0)
 .S SIG2(FFF)=SIG2(FFF)_$S(SCHED(FFF)'="":SCHED(FFF)_$S($G(PSDUR(FFF))="NULL"&($G(PSOFX("CONJUNCTION",FFF))="")&('$O(SIG0(FFF))):"",1:" "),1:"")
"RTN","PSOFSIG",43,0)
 .S PSOCJ=$E($G(PSOFX("CONJUNCTION",FFF)))
"RTN","PSOFSIG",44,0)
 .S SIG2(FFF)=SIG2(FFF)_$S(PSDUR(FFF)'="NULL":PSDUR(FFF)_$S($G(PSOFX("CONJUNCTION",FFF))=""&('$O(SIG0(FFF))):"",1:", "),1:"")_$S($G(PSOCJ)="A":"AND",$G(PSOCJ)="T":"THEN",$G(PSOCJ)="S":"THEN",$G(PSOCJ)="X":"EXCEPT",1:"")
"RTN","PSOFSIG",45,0)
 .K PSOSG1,PSOSG2
"RTN","PSOFSIG",46,0)
 .K PSOUCS S SIG2(FFF)=$$UPPER(SIG2(FFF)) K PSOUCS
"RTN","PSOFSIG",47,0)
 ;I $G(PSOFX("SIG"))'="" S TODOSE=TODOSE+1,SIG2(TODOSE)=$G(PSOFX("SIG")) K PSOUCS S SIG2(TODOSE)=$$UPPER(SIG2(TODOSE)) K PSOUCS
"RTN","PSOFSIG",48,0)
 S PSODCT="" F  S PSODCT=$O(PSOFX("SIG",PSODCT)) Q:PSODCT=""  S PSOBDCT=PSOBDCT+1 S SIG2(PSOBDCT)=$G(PSOFX("SIG",PSODCT)) K PSOUCS S SIG2(PSOBDCT)=$$UPPER(SIG2(PSOBDCT)) K PSOUCS
"RTN","PSOFSIG",49,0)
STUFF ;
"RTN","PSOFSIG",50,0)
 S DCOUNT=0
"RTN","PSOFSIG",51,0)
 I '$D(SIG2(1)) G QUIT
"RTN","PSOFSIG",52,0)
 I '$O(SIG2(1)),$L(SIG2(1))<71 S SIG(1)=SIG2(1) G PTSIG
"RTN","PSOFSIG",53,0)
 S (VAR,VAR1)="",II=1
"RTN","PSOFSIG",54,0)
 F FF=0:0 S FF=$O(SIG2(FF)) Q:'FF  S CT=0 F NN=1:1:$L(SIG2(FF)) I $E(SIG2(FF),NN)=" "!($L(SIG2(FF))=NN) S CT=CT+1 D  I $L(VAR)>70 S SIG(II)=LIM_" ",II=II+1,VAR=VAR1
"RTN","PSOFSIG",55,0)
 .S VAR1=$P(SIG2(FF)," ",(CT))
"RTN","PSOFSIG",56,0)
 .S LIM=VAR
"RTN","PSOFSIG",57,0)
 .S VAR=$S(VAR="":VAR1,1:VAR_" "_VAR1)
"RTN","PSOFSIG",58,0)
 I $G(VAR)'="" S SIG(II)=VAR
"RTN","PSOFSIG",59,0)
 ;F II=0:0 S II=$O(SIG3(II)) Q:'II  S DCOUNT=DCOUNT+1 S ^PS(52.41,PENDING,"SIG",DCOUNT,0)=SIG3(II)
"RTN","PSOFSIG",60,0)
 ;I DCOUNT S ^PS(52.41,PENDING,"SIG",0)="^52.4124A^"_DCOUNT_"^"_DCOUNT
"RTN","PSOFSIG",61,0)
PTSIG ;
"RTN","PSOFSIG",62,0)
 I '$G(PSOPTSIG) G QUIT
"RTN","PSOFSIG",63,0)
 I $O(SIG(0)) W ! S WWFL=0 F WW=0:0 S WW=$O(SIG(WW)) Q:'WW  D
"RTN","PSOFSIG",64,0)
 .W ! I 'WWFL W "("
"RTN","PSOFSIG",65,0)
 .W $G(SIG(WW)) S WWFL=1
"RTN","PSOFSIG",66,0)
 I $O(SIG(0)) W ")",!
"RTN","PSOFSIG",67,0)
QUIT K SSS,TT,DCOUNT,PREP,VERB,FFF,GGG,SIGDS,SIGRT,PSOROUTE,PSOSG1,PSOSG2 Q
"RTN","PSOFSIG",68,0)
SIG1 ;
"RTN","PSOFSIG",69,0)
 F FFF=0:0 S FFF=$O(SIG0(FFF)) Q:'FFF  S SIG2(FFF)=SIG0(FFF)
"RTN","PSOFSIG",70,0)
 Q
"RTN","PSOFSIG",71,0)
DAYS I +$E($P(SIG1(TT),"^",2))!($E($P(SIG1(TT),"^",2))=0) S $P(SIG1(TT),"^",2)="D"_$P(SIG1(TT),"^",2)
"RTN","PSOFSIG",72,0)
 Q
"RTN","PSOFSIG",73,0)
NON ;
"RTN","PSOFSIG",74,0)
 I $P($G(SIG0(SSS)),"&",2)'="" S PSNOUN(SSS)=$P($G(SIG0(SSS)),"&",2) Q
"RTN","PSOFSIG",75,0)
 Q
"RTN","PSOFSIG",76,0)
 F NOUN=0:0 S NOUN=$O(^PS(50.606,SIGDS,"NOUN",NOUN)) Q:'NOUN!($G(PSNOUN(SSS))'="")  I $P($G(^PS(50.606,SIGDS,"NOUN",NOUN,0)),"^")'="" S PSNOUN(SSS)=$P(^(0),"^")
"RTN","PSOFSIG",77,0)
 Q
"RTN","PSOFSIG",78,0)
VERB ;Check if verb and noun need to be added to SIG
"RTN","PSOFSIG",79,0)
 K PSOLCS,PSOUCS,PSOISL,PSOVL
"RTN","PSOFSIG",80,0)
 I $G(VERB)'="" S PSOVL=$L(VERB),PSOISL=$E($G(SIG0(FFF)),1,$G(PSOVL)) I $G(PSOISL)'="" D
"RTN","PSOFSIG",81,0)
 .S PSOUCS=VERB
"RTN","PSOFSIG",82,0)
 .S PSOUCS=$$UPPER(PSOUCS) I PSOUCS=PSOISL S PSOSG1=1 Q
"RTN","PSOFSIG",83,0)
 .S PSOUCS=$$LOWER(PSOUCS) I PSOUCS=PSOISL S PSOSG1=1 Q
"RTN","PSOFSIG",84,0)
 .S PSOUCS=$$UPPER($E(PSOUCS,1))_$$LOWER($E(PSOUCS,2,99)) I PSOUCS=PSOISL S PSOSG1=1 Q
"RTN","PSOFSIG",85,0)
 I $G(PSNOUN(FFF))="" G VERBEX
"RTN","PSOFSIG",86,0)
 S PSOISL=$G(SIG0(FFF)) I $G(PSOISL)="" G VERBEX
"RTN","PSOFSIG",87,0)
 S PSOVL=$F(PSNOUN(FFF),"(")
"RTN","PSOFSIG",88,0)
 I $G(PSOVL)>2 S PSOUCS=$E(PSNOUN(FFF),1,(PSOVL-2))
"RTN","PSOFSIG",89,0)
 I $G(PSOVL)'>2 S PSOUCS=PSNOUN(FFF)
"RTN","PSOFSIG",90,0)
 I $G(PSOISL)'="" D
"RTN","PSOFSIG",91,0)
 .S PSOUCS=$$UPPER(PSOUCS) I PSOISL[PSOUCS S PSOSG2=1 Q
"RTN","PSOFSIG",92,0)
 .S PSOUCS=$$LOWER(PSOUCS) I PSOISL[PSOUCS S PSOSG2=1 Q
"RTN","PSOFSIG",93,0)
 .S PSOUCS=$$UPPER($E(PSOUCS,1))_$$LOWER($E(PSOUCS,2,99)) I PSOISL[PSOUCS S PSOSG2=1
"RTN","PSOFSIG",94,0)
VERBEX K PSOLCS,PSOUCS,PSOISL,PSOVL Q
"RTN","PSOFSIG",95,0)
 ;
"RTN","PSOFSIG",96,0)
UPPER(PSOUCS) ;
"RTN","PSOFSIG",97,0)
 Q $TR(PSOUCS,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSOFSIG",98,0)
 ;
"RTN","PSOFSIG",99,0)
LOWER(PSOLCS) ;
"RTN","PSOFSIG",100,0)
 Q $TR(PSOLCS,"ABCDEFGHIJKLMNOPQRSTUVWXYZ","abcdefghijklmnopqrstuvwxyz")
"RTN","PSOFSIG",101,0)
 Q
"RTN","PSOFSIG",102,0)
 ;
"RTN","PSOFSIG",103,0)
SSS ;
"RTN","PSOFSIG",104,0)
 K PSOFNL,PSOFNLF,PSOFNLX
"RTN","PSOFSIG",105,0)
 Q:$G(PSNOUN(FFF))=""
"RTN","PSOFSIG",106,0)
 Q:$L(PSNOUN(FFF))'>3
"RTN","PSOFSIG",107,0)
 Q:'$G(PSOFX("DOSE ORDERED",FFF))
"RTN","PSOFSIG",108,0)
 ;Q:$G(PSOFX("DOSE ORDERED",FFF))>1
"RTN","PSOFSIG",109,0)
 S PSOFNL=$E(PSNOUN(FFF),($L(PSNOUN(FFF))-2),$L(PSNOUN(FFF)))
"RTN","PSOFSIG",110,0)
 I $G(PSOFNL)="(S)"!($G(PSOFNL)="(s)") D
"RTN","PSOFSIG",111,0)
 .I $G(PSOFX("DOSE ORDERED",FFF))'>1 S PSNOUN(FFF)=$E(PSNOUN(FFF),1,($L(PSNOUN(FFF))-3))
"RTN","PSOFSIG",112,0)
 .I $G(PSOFX("DOSE ORDERED",FFF))>1 S PSNOUN(FFF)=$E(PSNOUN(FFF),1,($L(PSNOUN(FFF))-3))_$E(PSOFNL,2)
"RTN","PSOFSIG",113,0)
 Q
"RTN","PSOFSIG",114,0)
FRAC ;
"RTN","PSOFSIG",115,0)
 K PSOFRAC,PSOFRACX,PSOFRAC1,PSOFRAC2
"RTN","PSOFSIG",116,0)
 I $G(PSOFX("DOSE ORDERED",FFF))="" Q
"RTN","PSOFSIG",117,0)
 I $G(PSOFX("DOSE ORDERED",FFF))'["." S (PSOFRAC1,PSOFRAC)=$G(PSOFX("DOSE ORDERED",FFF)) D NUM D  G FRACQ
"RTN","PSOFSIG",118,0)
 .I $G(PSOFRAC1)=$G(PSOFRAC) K PSOFRAC,PSOFRAC1 Q
"RTN","PSOFSIG",119,0)
 .S PSOFRAC=$G(PSOFRAC1)
"RTN","PSOFSIG",120,0)
 S PSOFRAC1=$P(PSOFX("DOSE ORDERED",FFF),"."),PSOFRAC2=$P(PSOFX("DOSE ORDERED",FFF),".",2)
"RTN","PSOFSIG",121,0)
 S PSOFRACX="."_$G(PSOFRAC2)
"RTN","PSOFSIG",122,0)
 S PSOFRAC=$S(PSOFRACX=".5":"ONE-HALF",PSOFRACX=".25":"ONE-FOURTH",PSOFRACX=".33":"ONE-THIRD",PSOFRACX=".34":"ONE-THIRD",PSOFRACX=".50":"ONE-HALF",PSOFRACX=".66":"TWO-THIRDS",PSOFRACX=".67":"TWO-THIRDS",PSOFRACX=".75":"THREE-FOURTHS",1:"")
"RTN","PSOFSIG",123,0)
 I $G(PSOFRAC)="" K PSOFRAC G FRACQ
"RTN","PSOFSIG",124,0)
 I $G(PSOFRAC1)'="",+$G(PSOFRAC1) D NUM S PSOFRAC=$G(PSOFRAC1)_" AND "_$G(PSOFRAC)
"RTN","PSOFSIG",125,0)
FRACQ K PSOFRAC1,PSOFRAC2
"RTN","PSOFSIG",126,0)
 Q
"RTN","PSOFSIG",127,0)
NUM ;
"RTN","PSOFSIG",128,0)
 Q:$G(PSOFRAC1)=""
"RTN","PSOFSIG",129,0)
 S PSOFRAC1=$S(PSOFRAC1="1":"ONE",PSOFRAC1="2":"TWO",PSOFRAC1="3":"THREE",PSOFRAC1="4":"FOUR",PSOFRAC1="5":"FIVE",PSOFRAC1="6":"SIX",PSOFRAC1="7":"SEVEN",PSOFRAC1="8":"EIGHT",PSOFRAC1="9":"NINE",PSOFRAC1="10":"TEN",1:PSOFRAC1)
"RTN","PSOFSIG",130,0)
 Q
"RTN","PSOFSIG",131,0)
SET ;Set duration to proper format for storage
"RTN","PSOFSIG",132,0)
 Q
"RTN","PSOFSIG",133,0)
KILL ;kills duration data field
"RTN","PSOFSIG",134,0)
 Q
"RTN","PSOFSIG",135,0)
DUR ;Input Transform for duration
"RTN","PSOFSIG",136,0)
 K:X'?.N&(X'?.N1".".N)&(X'?.N1"D")&(X'?.N1".".N1"D")&(X'?.N1"M")&(X'?.N1".".N1"M")&(X'?.N1"H")&(X'?.N1".".N1"H")&(X'?.N1"W")&(X'?.N1".".N1"W")&(X'?.N1"L")&(X'?.N1".".N1"L") X
"RTN","PSOFSIG",137,0)
 K:'$G(X) X
"RTN","PSOFSIG",138,0)
 Q
"RTN","PSOHELP")
0^3^B53907821
"RTN","PSOHELP",1,0)
PSOHELP ;BHAM ISC/SAB-outpatient utility routine ; 10/17/07 7:41am
"RTN","PSOHELP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**3,23,29,48,46,117,131,222,268,206,276,282**;DEC 1997;Build 18
"RTN","PSOHELP",3,0)
 ;External reference ^PS(51 supported by DBIA 2224
"RTN","PSOHELP",4,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOHELP",5,0)
 ;External reference ^PS(56 supported by DBIA 2229
"RTN","PSOHELP",6,0)
 ;External reference ^PSNPPIP supported by DBIA 2261
"RTN","PSOHELP",7,0)
 ;
"RTN","PSOHELP",8,0)
XREF D XREF^PSOHELP3
"RTN","PSOHELP",9,0)
 Q
"RTN","PSOHELP",10,0)
SIG ;checks PI for RXs
"RTN","PSOHELP",11,0)
 K VALMSG
"RTN","PSOHELP",12,0)
 I $E(X)=" " D EN^DDIOL("Leading spaces should not entered in the Patient Instructions! ","","$C(7),!") S VALMSG="There are leading spaces in Patient Instructions!"
"RTN","PSOHELP",13,0)
SIGONE K INS1 Q:$L(X)<1  F Z0=1:1:$L(X," ") G:Z0="" EN S Z1=$P(X," ",Z0) D  G:'$D(X) EN
"RTN","PSOHELP",14,0)
 .I $L(Z1)>32 W $C(7),!?5,"MAX OF 32 CHARACTERS ALLOWED BETWEEN SPACES.",! K X Q
"RTN","PSOHELP",15,0)
 .D:$D(X)&($G(Z1)]"")  S INS1=$G(INS1)_" "_Z1
"RTN","PSOHELP",16,0)
 ..S Z1=$$UPPER^PSOSIG(Z1) ;*282 Provider Comments
"RTN","PSOHELP",17,0)
 ..S Y=$O(^PS(51,"B",Z1,0)) Q:'Y!($P($G(^PS(51,+Y,0)),"^",4)>1)  S Z1=$P(^PS(51,Y,0),"^",2)
"RTN","PSOHELP",18,0)
 ..I $G(^PS(51,+Y,9))]"" S Y=$P(X," ",Z0-1),Y=$E(Y,$L(Y)) S:Y>1 Z1=^(9)
"RTN","PSOHELP",19,0)
EN K Z1,Z0
"RTN","PSOHELP",20,0)
 Q
"RTN","PSOHELP",21,0)
SSIG ;other lang. mods
"RTN","PSOHELP",22,0)
 K VALMSG
"RTN","PSOHELP",23,0)
 I $E(X)=" " D EN^DDIOL("Leading spaces should not entered in the Patient Instructions! ","","$C(7),!") S VALMSG="There are leading spaces in Patient Instructions!"
"RTN","PSOHELP",24,0)
 K SINS1 Q:$L(X)<1  F Z0=1:1:$L(X," ") G:Z0="" EX S Z1=$P(X," ",Z0) D  G:'$D(X) EX
"RTN","PSOHELP",25,0)
 .I $L(Z1)>32 W $C(7),!?5,"MAX OF 32 CHARACTERS ALLOWED BETWEEN SPACES.",! K X Q
"RTN","PSOHELP",26,0)
 .D:$D(X)&($G(Z1)]"")  S SINS1=$G(SINS1)_" "_Z1
"RTN","PSOHELP",27,0)
 ..S Z1=$$UPPER^PSOSIG(Z1) ;*282 Provider Comments
"RTN","PSOHELP",28,0)
 ..S Y=$O(^PS(51,"B",Z1,0)) Q:'Y!($P($G(^PS(51,+Y,0)),"^",4)>1)  S Z1=$P(^PS(51,Y,0),"^",2)
"RTN","PSOHELP",29,0)
 ..I $G(^PS(51,+Y,4))]"" S Z1=^PS(51,+Y,4) ;,Y=$P(X," ",Z0-1),Y=$E(Y,$L(Y)) S:Y>1 Z1=^(9)
"RTN","PSOHELP",30,0)
EX K Z1,Z0
"RTN","PSOHELP",31,0)
 Q
"RTN","PSOHELP",32,0)
QTY ;Check quantity dispensed against inventory
"RTN","PSOHELP",33,0)
 Q:'$G(PSODRUG("IEN"))
"RTN","PSOHELP",34,0)
 S Z0=$S($G(PSODRUG("IEN"))]"":PSODRUG("IEN"),$G(PSXYES):$P(^PSRX(ZRX,0),"^",6),$D(^PSRX(DA,0)):+$P(^(0),"^",6),1:0)
"RTN","PSOHELP",35,0)
 I $D(^PSDRUG("AQ",Z0)),(+X'=X) K X,Z0 Q
"RTN","PSOHELP",36,0)
 S Z1=$S($D(^PSDRUG(Z0,660.1)):^(660.1),1:0)+(+X) D:X>Z1 EN^DDIOL("  Greater Than Current Inventory!","","$C(7)") K Z1
"RTN","PSOHELP",37,0)
 S ZX=X,ZZ0=$G(D0),D0=Z0
"RTN","PSOHELP",38,0)
 S Y(18,2)=$S($D(^PSDRUG(D0,660)):^(660),1:""),Y(18,1)=$S($D(^(660.1)):^(660.1),1:"")
"RTN","PSOHELP",39,0)
 S X=$P(Y(18,1),"^",1),X=$S($P(Y(18,2),"^",5):X/$P(Y(18,2),"^",5),1:"*******")
"RTN","PSOHELP",40,0)
 S X=$J(X,0,2)
"RTN","PSOHELP",41,0)
 D:X<$S($D(^PSDRUG(Z0,660)):+^(660),1:1) EN^DDIOL("  Below Reorder Level.","","$C(7)") S X=ZX,D0=$G(ZZ0) K ZZ0,Z0,ZX
"RTN","PSOHELP",42,0)
 Q
"RTN","PSOHELP",43,0)
HELP ;qty help
"RTN","PSOHELP",44,0)
 G:$G(PSOFDR) HLP
"RTN","PSOHELP",45,0)
 S Z0=$S($G(PSODRUG("IEN"))]"":PSODRUG("IEN"),$G(PSXYES):$P(^PSRX(ZRX,0),"^",6),$D(^PSRX(DA,0)):$P(^PSRX(DA,0),"^",6),1:0)
"RTN","PSOHELP",46,0)
HLP S Z0=+$G(PSODRUG("IEN"))  I $D(^PSDRUG("AQ",Z0)) D EN^DDIOL("This is a CMOP drug. The quantity may not contain alpha characters (i.e.; ML)","","!!") D EN^DDIOL("or more than two fractional decimal places (i.e.; .01).","","!") D  K Z0 Q
"RTN","PSOHELP",47,0)
 .D EN^DDIOL("Enter a number between 0 and 99999999 inclusive. The total entry cannot","","!") D EN^DDIOL("exceed 11 characters.","","!")
"RTN","PSOHELP",48,0)
 D EN^DDIOL("Enter a whole number between 0 and 99999999 inclusive.  Alpha characters are","","!!")
"RTN","PSOHELP",49,0)
 D EN^DDIOL("not allowed, and the entry cannot exceed 11 characters, or contain more than","","!") D EN^DDIOL("two fractional decimal places (i.e.; .01).","","!")
"RTN","PSOHELP",50,0)
 K Z0
"RTN","PSOHELP",51,0)
 Q
"RTN","PSOHELP",52,0)
ADD ;add/edited local drug/drug interactions
"RTN","PSOHELP",53,0)
 W ! S DIC("A")="Select Drug Interaction: ",DIC(0)="AEMQL",DLAYGO=56
"RTN","PSOHELP",54,0)
 S (DIC,DIE)="^PS(56,",DIC("S")="I '$P(^(0),""^"",5)" D ^DIC G:"^"[X QU G:Y<0 ADD S DA=+Y,DR="[PSO INTERACT]" L +^PS(56,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !,"Entry is being edited by another user. Try Later!",! G ADD
"RTN","PSOHELP",55,0)
 D ^DIE L:$G(DA) -^PS(56,DA) K DA G ADD
"RTN","PSOHELP",56,0)
QU L -^PS(56,DA) K X,DIC,DIE,DA
"RTN","PSOHELP",57,0)
 Q
"RTN","PSOHELP",58,0)
CRI ;change drug interaction severity to critical from significant
"RTN","PSOHELP",59,0)
 W ! S DIC("A")="Select Drug Interaction: ",DIC(0)="AEQM",(DIC,DIE)="^PS(56,",DIC("S")="I $P(^(0),""^"",4)=2" D ^DIC G:"^"[X QU G:Y<0 CRI S DA=+Y,DR=3
"RTN","PSOHELP",60,0)
 L +^PS(56,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !,"Entry is being edited by another user. Try Later!",! G CRI
"RTN","PSOHELP",61,0)
 D ^DIE L -^PS(56,DA) K DA G CRI
"RTN","PSOHELP",62,0)
 G QU
"RTN","PSOHELP",63,0)
 Q
"RTN","PSOHELP",64,0)
MAX S:$G(EXH) P(7)=$P(^PSRX(DA,0),"^",8),P(5)=$P(^(0),"^",6),P(2)=+$P(^(0),"^",3) S:P(2) PTST=$G(^PS(53,P(2),0)),PTDY=$P($G(^(0)),"^",3),PTRF=$P($G(^(0)),"^",4)
"RTN","PSOHELP",65,0)
 S PSODEA=$P(^PSDRUG(P(5),0),"^",3),CS=0
"RTN","PSOHELP",66,0)
 I $D(CLOZPAT) S MAX=$S(CLOZPAT=2&($P(^PSRX(DA,0),"^",8)=14):1,CLOZPAT=2&($P(^PSRX(DA,0),"^",8)=7):3,CLOZPAT=1&($P(^PSRX(DA,0),"^",8)=7):1,1:0),MIN=0 Q
"RTN","PSOHELP",67,0)
 I PSODEA["A"&(PSODEA'["B")!(PSODEA["F")!(PSODEA[1)!(PSODEA[2) D EN^DDIOL("No refills allowed on "_$S(PSODEA["A":"this narcotic drug.",1:"this drug."),"","!") D EN^DDIOL(" ","","!") S $P(^PSRX(DA,0),"^",9)=0 K X,Y,PSODEA,CS,PTST Q
"RTN","PSOHELP",68,0)
 F DEA=1:1 Q:$E(PSODEA,DEA)=""  I $E(+PSODEA,DEA)>1,$E(+PSODEA,DEA)<6 S CS=1
"RTN","PSOHELP",69,0)
 S PSOELSE=CS I PSOELSE D
"RTN","PSOHELP",70,0)
 .S PSOX1=$S(PTRF>5:5,1:PTRF),PSOT=$S(PSOX1=5:5,1:PSOX1)
"RTN","PSOHELP",71,0)
 .S PSOT=$S('PSOT:0,P(7)=90:1,1:PSOT),PSDY1=$S(P(7)<60:5,P(7)'<60&(P(7)'>89):2,P(7)=90:1,1:0) S MAX=$S(PSOT'>PSDY1:PSOT,1:PSDY1)
"RTN","PSOHELP",72,0)
 I 'PSOELSE D
"RTN","PSOHELP",73,0)
 .S PSOX1=PTRF,PSOT=$S(PSOX1=11:11,1:PSOX1),PSOT=$S('PSOT:0,P(7)=90:3,1:PSOT)
"RTN","PSOHELP",74,0)
 .S PSDY1=$S(P(7)<60:11,P(7)'<60&(P(7)'>89):5,P(7)=90:3,1:0) S MAX=$S(PSOT'>PSDY1:PSOT,1:PSDY1)
"RTN","PSOHELP",75,0)
 K PSODEA,PSOELSE,PSOT,PSOX1,PSDY,PSDY1,DEA,CS
"RTN","PSOHELP",76,0)
 I $D(X) S MIN=0 I $D(DA) F REF=0:0 S REF=$O(^PSRX(DA,1,REF)) Q:'REF  I $D(^(REF,0)) S MIN=MIN+1
"RTN","PSOHELP",77,0)
 I $G(EXH) D EN^DDIOL("Enter a number Between "_MIN_" AND "_MAX_".","","!?10") K P(2),P(5),P(7),MAX,MAX1,MIN,REF
"RTN","PSOHELP",78,0)
 Q
"RTN","PSOHELP",79,0)
 ;
"RTN","PSOHELP",80,0)
REF S PSRF=X,P(7)=$P(^PSRX(DA,0),"^",8),P(5)=$P(^(0),"^",6),P(2)=+$P(^(0),"^",3) S:P(2) PTST=$G(^PS(53,P(2),0)) S PTDY=$P(^(0),"^",3),PTRF=$P(^(0),"^",4)
"RTN","PSOHELP",81,0)
 D MAX Q:'$D(X)  I (+X'=X)!(X<0)!(X>MAX)!(X?.E1"."1N.N) D EN^DDIOL(" ** MAX REFILLS ALLOWED ARE "_MAX_" ** ","","$C(7)") K X
"RTN","PSOHELP",82,0)
 I $D(X),X<MIN D EN^DDIOL(" ** PATIENT HAS ALREADY RECEIVED "_MIN_" REFILLS ** ","","$C(7)") K X
"RTN","PSOHELP",83,0)
 D DAYS^PSOUTLA
"RTN","PSOHELP",84,0)
 K PTDY,PTRF,MAX,DAYS,PSDAYS,PSODEA,PSOX,PSOX1,PSDY,PSDY1,DEA,CS,PTST,PSRF,MIN,REF,P(2),P(7),P(5),MAX1
"RTN","PSOHELP",85,0)
 Q
"RTN","PSOHELP",86,0)
PAT ;patient field screen in file 52
"RTN","PSOHELP",87,0)
 N DIC,DIE S DFN=X D INP^VADPT,DEM^VADPT
"RTN","PSOHELP",88,0)
 I $P(VADM(6),"^") D EN^DDIOL("PATIENT DIED "_$P(VADM(6),"^",2),"","$C(7),!?10") D EN^DDIOL(" ","","!") K X,DFN Q
"RTN","PSOHELP",89,0)
 I $P(VAIN(4),"^") D EN^DDIOL("PATIENT IS AN INPATIENT ON WARD "_$P(VAIN(4),"^",2)_" !!","","$C(7),!?10") K DIR D DIR K VA,VADN,VAIN Q
"RTN","PSOHELP",90,0)
 E  S X=DFN K DFN,DIRUT,DTOUT,DUOUT
"RTN","PSOHELP",91,0)
 Q
"RTN","PSOHELP",92,0)
DIR S DIR(0)="Y",DIR("B")="YES",DIR("A")="DO YOU WISH TO CONTINUE" D ^DIR K DIR
"RTN","PSOHELP",93,0)
 K:'Y X S:Y X=DFN K DFN,DIRUT,DTOUT,DUOUT,VA,VADM,VAIN
"RTN","PSOHELP",94,0)
 Q
"RTN","PSOHELP",95,0)
BG ;prevents editing of display groups with patients from name to ticket
"RTN","PSOHELP",96,0)
 S $P(^PS(59.3,DA,0),"^",2)=PDP W !,$C(7),"The display cannot be changed from NAME to TICKET when patients are",!,"already in the Display Group.  All patients must be purged and re-entered.",!,"Ticket numbers must be issued !!",! K Y,PDP
"RTN","PSOHELP",97,0)
 Q
"RTN","PSOHELP",98,0)
CLNAP ;quits action profile
"RTN","PSOHELP",99,0)
 Q
"RTN","PSOHELP",100,0)
PRMI ;prints medication instruction sheets.  select drug.
"RTN","PSOHELP",101,0)
 S X="PSNPPIP" X ^%ZOSF("TEST") I '$T S VALMBCK="",VALMSG="Medication Instruction Sheets Not Installed!" Q
"RTN","PSOHELP",102,0)
 I $G(PSODFN) N PSNDFN S PSNDFN=PSODFN
"RTN","PSOHELP",103,0)
 W !! K PSNPPI("MESSAGE") D FULL^VALM1,^PSNPPIP S VALMBCK="R"
"RTN","PSOHELP",104,0)
 I $G(PSNPPI("MESSAGE"))]"" D
"RTN","PSOHELP",105,0)
 .K DIR W PSNPPI("MESSAGE"),! S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DIRUT,PSNPPI("MESSGAE")
"RTN","PSOHELP",106,0)
 Q
"RTN","PSOHELP",107,0)
PRMID ;prints medication instruction sheets.  pass in drug.
"RTN","PSOHELP",108,0)
 N RX0,RXN  ;*276
"RTN","PSOHELP",109,0)
 S RXN=$P($G(PSOLST(ORN)),"^",2) Q:RXN=""  ;*276
"RTN","PSOHELP",110,0)
 I $T(ENOP^PSNPPIP)']"" S VALMBCK="",VALMSG="Medication Instruction Sheets Not Installed!" Q
"RTN","PSOHELP",111,0)
 K PSNPPI("MESSAGE") D FULL^VALM1
"RTN","PSOHELP",112,0)
 S RX0=$G(^PSRX(RXN,0))  ;*276
"RTN","PSOHELP",113,0)
 W !! D ENOP^PSNPPIP($P(RX0,"^",6),$G(^PSRX(RXN,"TN")),$P(RX0,"^"),PSODFN)
"RTN","PSOHELP",114,0)
 S VALMBCK="R" I $G(PSNPPI("MESSAGE"))]"" D
"RTN","PSOHELP",115,0)
 .K DIR W PSNPPI("MESSAGE"),! S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DIRUT,PSNPPI("MESSGAE")
"RTN","PSOHELP",116,0)
 Q
"RTN","PSOHELP2")
0^4^B8274673
"RTN","PSOHELP2",1,0)
PSOHELP2 ;B'ham ISC/SAB - utility routine #3 ; 3/23/11 8:17am
"RTN","PSOHELP2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**282**;DEC 1997;Build 18
"RTN","PSOHELP2",3,0)
EN ; validate 
"RTN","PSOHELP2",4,0)
 ;*282 Allow multi-word schedules
"RTN","PSOHELP2",5,0)
 I X[""""!($A(X)=45)!(X?.E1C.E)!($L(X," ")>$S(X["PRN":4,1:3))!($L(X)>70)!($L(X)<1)!(X["P RN")!(X["PR N") K X Q
"RTN","PSOHELP2",6,0)
 I X?.E1L.E S X=$$ENLU^PSGMI(X) W "  (",X,")"
"RTN","PSOHELP2",7,0)
 ;
"RTN","PSOHELP2",8,0)
ENOS ; order set entry
"RTN","PSOHELP2",9,0)
 S (PSGS0XT,PSGS0Y,XT,Y)="" I X["PRN"!(X="ON CALL") G Q
"RTN","PSOHELP2",10,0)
 S X0=X I X,X'["X" D ENCHK S:$D(X) Y=X G Q
"RTN","PSOHELP2",11,0)
 I X["@" D DW S:$D(X) Y=$P(X,"@",2) G Q
"RTN","PSOHELP2",12,0)
 I $E(X)="?" S Y="?" D DIC K X Q
"RTN","PSOHELP2",13,0)
 I Y'>0,$S(X="NOW":1,X="ONCE":1,X="STAT":1,X="ONE TIME":1,1:X="ONE-TIME") W:'$D(PSGOES) "  (ONCE ONLY)" S Y="",XT="O" G Q
"RTN","PSOHELP2",14,0)
 ;
"RTN","PSOHELP2",15,0)
NS I Y'>0 W:'$D(PSGOES) "  (Nonstandard schedule)" S X=X0,Y=""
"RTN","PSOHELP2",16,0)
 I X="BID"!(X="TID")!(X="QID") S XT=1440/$F("BTQ",$E(X)) G Q
"RTN","PSOHELP2",17,0)
 S:$E(X)="Q" X=$E(X,2,99) S:'X X="1"_X S X1=+X,X=$P(X,+X,2),X2=0 S:X1<0 X1=-X1 S:$E(X)="X" X2=1,X=$E(X,2,99)
"RTN","PSOHELP2",18,0)
 S XT=$S(X["'":1,X["AC"!(X["PC"):480,X["D"!(X["AM")!(X["PM")!(X["HS"):1440,X["H":60,X["W":10080,X["M":40320,1:-1) I XT<0,Y'>0 K X G Q
"RTN","PSOHELP2",19,0)
 S X=X0 I XT S:X2 XT=XT\X1 I 'X2 S:X["O" XT=XT*2 S XT=XT*X1
"RTN","PSOHELP2",20,0)
 ;
"RTN","PSOHELP2",21,0)
Q ;
"RTN","PSOHELP2",22,0)
 S PSGS0XT=$S(XT]"":XT,1:""),PSGS0Y=$S(Y:Y,1:"") K QX,SDW,SWD,X0,XT,Z Q
"RTN","PSOHELP2",23,0)
 ;
"RTN","PSOHELP2",24,0)
ENCHK ;
"RTN","PSOHELP2",25,0)
 I $S($L($P(X,"-"))>4:1,$L(X)>119:1,$L(X)<2:1,X'>0:1,1:X'?.ANP) K X Q
"RTN","PSOHELP2",26,0)
 S X(1)=$P(X,"-") I X(1)'?2N,X(1)'?4N K X Q
"RTN","PSOHELP2",27,0)
 S X(1)=$L(X(1)) I X'["-",X>$E(2400,1,X(1)) K X Q
"RTN","PSOHELP2",28,0)
 F X(2)=2:1:$L(X,"-") S X(3)=$P(X,"-",X(2)) I $S($L(X(3))'=X(1):1,X(3)>$E(2400,1,X(1)):1,1:X(3)'>$P(X,"-",X(2)-1)) K X Q
"RTN","PSOHELP2",29,0)
 K:$D(X) X(1),X(2),X(3) Q
"RTN","PSOHELP2",30,0)
 ;
"RTN","PSOHELP2",31,0)
DW ;
"RTN","PSOHELP2",32,0)
 S SWD="SUNDAYS^MONDAYS^TUESDAYS^WEDNESDAYS^THURSDAYS^FRIDAYS^SATURDAYS",SDW=X,X=$P(X,"@",2) D ENCHK Q:'$D(X)  S X=$P(SDW,"@"),X(1)="-" I X?.E1P.E,X'["-" F QX=1:1:$L(X) I $E(X,QX)?1P S X(1)=$E(X,QX) Q
"RTN","PSOHELP2",33,0)
 F Q=1:1:$L(X,X(1)) K:SWD="" X Q:SWD=""  S Z=$P(X,X(1),Q) D DWC Q:'$D(X)
"RTN","PSOHELP2",34,0)
 K X(1) S:$D(X) X=SDW Q
"RTN","PSOHELP2",35,0)
DWC I $L(Z)<2 K X Q
"RTN","PSOHELP2",36,0)
 F QX=1:1:$L(SWD,"^") S Y=$P(SWD,"^",QX) I $P(Y,Z)="" S SWD=$P(SWD,Y,2) S:$L(SWD) SWD=$E(SWD,2,50) Q
"RTN","PSOHELP2",37,0)
 E  K X
"RTN","PSOHELP2",38,0)
 Q
"RTN","PSOHELP2",39,0)
DIC ;
"RTN","PSOHELP2",40,0)
 K DIC S DIC="^PS(51.1,",DIC(0)="EISZ",D="APPSJ"
"RTN","PSOHELP2",41,0)
 D IX^DIC K DIC S:$D(DIE)#2 DIC=DIE Q:Y'>0  S X=+Y
"RTN","PSOHELP2",42,0)
 S (X,X0)=Y(0,0) S:Y="" Y=$P(Y(0),"^",2)
"RTN","PSOHELP2",43,0)
 Q
"RTN","PSOHELP2",44,0)
ENLU(X) ; convert lower case to upper case
"RTN","PSOHELP2",45,0)
 Q $TR(X,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSOHELP2",46,0)
 ;
"RTN","PSOHELP2",47,0)
ENUL(X) ; convert upper case to lower case
"RTN","PSOHELP2",48,0)
 Q $TR(X,"ABCDEFGHIJKLMNOPQRSTUVWXYZ","abcdefghijklmnopqrstuvwxyz")
"RTN","PSOHLDS2")
0^5^B94193549
"RTN","PSOHLDS2",1,0)
PSOHLDS2 ;BHAM ISC/PWC,SAB-Build HL7 Segments for automated interface ;11/22/06 3:24pm
"RTN","PSOHLDS2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**156,198,255,200,268,305,336,434,282**;DEC 1997;Build 18
"RTN","PSOHLDS2",3,0)
 ;DIWP supported by DBIA 10011
"RTN","PSOHLDS2",4,0)
 ;^PS(50.606 supported by DBIA 2174
"RTN","PSOHLDS2",5,0)
 ;^PS(50.7 supported by DBIA #2223
"RTN","PSOHLDS2",6,0)
 ;^PS(51 supported by DBIA 2224
"RTN","PSOHLDS2",7,0)
 ;^PS(51.2 supported by DBIA 2226
"RTN","PSOHLDS2",8,0)
 ;^PS(55 supported by DBIA 2228
"RTN","PSOHLDS2",9,0)
 ;^PSDRUG supported by DBIA 221
"RTN","PSOHLDS2",10,0)
 ;^PS(54 supported by DBIA 2227
"RTN","PSOHLDS2",11,0)
 ;Cont'd build HL7 segments
"RTN","PSOHLDS2",12,0)
 ;
"RTN","PSOHLDS2",13,0)
 ;*198 add check to insert spaces into PMI segments
"RTN","PSOHLDS2",14,0)
 ;*255 add 2 new fields to RXE.21 (label name & VA PRINT NAME)
"RTN","PSOHLDS2",15,0)
 ;     and move NTEPMI tag to PSOHLDS4
"RTN","PSOHLDS2",16,0)
 ; *305 send  Notice of Privacy Practices in NTE9 - Modified to NTE9 as NTE8 already exist
"RTN","PSOHLDS2",17,0)
 ;
"RTN","PSOHLDS2",18,0)
RXE(PSI) ;pharmacy encoded order segment
"RTN","PSOHLDS2",19,0)
 Q:'$D(DFN)  N RXE S RXE="" S $P(RXE,"|",1)=""""""
"RTN","PSOHLDS2",20,0)
 S $P(RXE,"|",2)=$S($P($G(^PSDRUG(IDGN,"ND")),"^",10)'="":$P(^("ND"),"^",10),($G(PSND1)&$G(PSND3)):$P($G(PSOXN2),"^",2),1:"""""")_CS_$G(PSND2)_CS_"99PSNDF"_CS_PSND1_"."_PSND3_"."_$G(IDGN)_CS_$P($G(^PSDRUG(IDGN,0)),"^")_CS_"99PSD"
"RTN","PSOHLDS2",21,0)
 S $P(RXE,"|",3)="" I $G(PSOXN)="" S PSOXN=""""""
"RTN","PSOHLDS2",22,0)
 S $P(RXE,"|",5)=PSOXN_CS_$S($G(UNIT)'="":$G(UNIT),1:"""""")_CS_"99PSU"
"RTN","PSOHLDS2",23,0)
 S POIPTR=$P($G(^PSRX(IRXN,"OR1")),"^") I POIPTR S PODOSE=$P($G(^PS(50.7,POIPTR,0)),"^",2),PODOSENM=$P($G(^PS(50.606,PODOSE,0)),"^")
"RTN","PSOHLDS2",24,0)
 I '$G(POIPTR) S PODOSE=$P($G(^PS(50.7,$P($G(^PSDRUG(IDGN,2)),"^"),0)),"^",2),PODOSENM=$P($G(^PS(50.606,PODOSE,0)),"^")
"RTN","PSOHLDS2",25,0)
 S TRADENM=$G(^PSRX(IRXN,"TN")),$P(RXE,"|",6)=PODOSE_CS_PODOSENM_CS_"99PSF"
"RTN","PSOHLDS2",26,0)
 S $P(RXE,"|",8)=MP,$P(RXE,"|",9)=TRADENM,$P(RXE,"|",10)=QTY
"RTN","PSOHLDS2",27,0)
 S $P(RXE,"|",11)=CS_$P($G(^PSDRUG(IDGN,660)),"^",8),$P(RXE,"|",12)=NRFL
"RTN","PSOHLDS2",28,0)
 S $P(RXE,"|",13)=DEAID,$P(RXE,"|",14)=VPHARMID_CS_$P(VPHARM,",",1)_CS_$P(VPHARM,",",2)
"RTN","PSOHLDS2",29,0)
 S $P(RXE,"|",15)=$P(^PSRX(IRXN,0),"^"),$P(RXE,"|",16)=RFRM,$P(RXE,"|",17)=NFLD
"RTN","PSOHLDS2",30,0)
 S $P(RXE,"|",18)=PRIORDT,$P(RXE,"|",31)=CSUB_RS_SCTALK_RS_OTLAN
"RTN","PSOHLDS2",31,0)
 S $P(RXE,"|",21)=CS_DRUG_RS_CS_$G(VANAME)                       ;*255
"RTN","PSOHLDS2",32,0)
 S ^TMP("PSO",$J,PSI)="RXE|"_RXE,PSI=PSI+1
"RTN","PSOHLDS2",33,0)
 K PODOSE,PODOSENM,POIPTR,TRADENM,UU
"RTN","PSOHLDS2",34,0)
 Q
"RTN","PSOHLDS2",35,0)
RXD(PSI) ;pharmacy dispense segment
"RTN","PSOHLDS2",36,0)
 Q:'$D(DFN)  N RXD,I
"RTN","PSOHLDS2",37,0)
 S WNS="" I $G(WARN) F I=1:1 S WW=$P(WARN,",",I) Q:WW=""  S WNS=WNS_WW_CS_$S(WW'["N":^PS(54,WW,0),1:"")_RS
"RTN","PSOHLDS2",38,0)
 S RXD="RXD"_FS_$S($G(NFLD):NFLD,1:0)_FS_$S($P($G(^PSDRUG(IDGN,"ND")),"^",10)'="":$P(^("ND"),"^",10),($G(PSND1)&$G(PSND3)):$P($G(PSOXN2),"^",2),1:"""""")_CS_PSND2_CS_"99PSNDF"
"RTN","PSOHLDS2",39,0)
 S RXD=RXD_CS_PSND1_"."_PSND3_"."_$G(IDGN)_CS_$P($G(^PSDRUG(IDGN,0)),"^")_CS_"99PSD"
"RTN","PSOHLDS2",40,0)
 S RXD=RXD_FS_DISPDT_FS_FS_FS_FS_$P(^PSRX(IRXN,0),"^")_FS_NRFL
"RTN","PSOHLDS2",41,0)
 S RXD=RXD_FS_DEA_RS_PSONDC_FS_$S(FIN'="":FIN_CS_FIN1,1:"")_FS
"RTN","PSOHLDS2",42,0)
 S RXD=RXD_FS_DASPLY_FS_MW_FS_FS_CS_$S($G(CAP):"NON-SAFETY",1:"SAFETY")
"RTN","PSOHLDS2",43,0)
 S RXD=RXD_FS_FS_FS_FS_EXDT_FS_FS_FS_FS_FS_FS_WNS_FS_FS
"RTN","PSOHLDS2",44,0)
 S ^TMP("PSO",$J,PSI)=RXD,PSI=PSI+1
"RTN","PSOHLDS2",45,0)
 Q
"RTN","PSOHLDS2",46,0)
RXR(PSI) ;pharmacy route segment
"RTN","PSOHLDS2",47,0)
 Q:'$D(DFN)  N RXR S (PSROUTE,RTNAME)=""""""
"RTN","PSOHLDS2",48,0)
 F PSRTLP=0:0 S PSRTLP=$O(^PSRX(IRXN,6,PSRTLP)) Q:'PSRTLP  D
"RTN","PSOHLDS2",49,0)
 .S PSROUTE=$P($G(^PSRX(IRXN,6,PSRTLP,0)),"^",7)
"RTN","PSOHLDS2",50,0)
 .I PSROUTE,$D(^PS(51.2,PSROUTE,0))  S RTNAME=$P(^PS(51.2,PSROUTE,0),"^")
"RTN","PSOHLDS2",51,0)
 I RTNAME="" K PSROUTE,RTNAME,PSRTLP Q
"RTN","PSOHLDS2",52,0)
 S RXR="RXR"_FS_$G(PSROUTE)_CS_$G(RTNAME)_CS_"99PSR"_FS_FS_FS_FS
"RTN","PSOHLDS2",53,0)
 S ^TMP("PSO",$J,PSI)=RXR,PSI=PSI+1
"RTN","PSOHLDS2",54,0)
 K PSROUTE,RTNAME,PSRTLP
"RTN","PSOHLDS2",55,0)
 Q
"RTN","PSOHLDS2",56,0)
SIG K OT S SGY="" F P=1:1:$L(SIG," ") S X=$P(SIG," ",P) D:X]""
"RTN","PSOHLDS2",57,0)
 .I $D(^PS(51,"A",X)) D
"RTN","PSOHLDS2",58,0)
 ..;PSO*7*282 Intended Use
"RTN","PSOHLDS2",59,0)
 ..I $P($G(^PS(55,DFN,"LAN")),"^") S OT=$O(^PS(51,"B",X,0)) I OT,($P(^PS(51,OT,0),"^",4)<2)&($P($G(^PS(51,OT,4)),"^")]"") S X=$P(^PS(51,OT,4),"^") K OT Q
"RTN","PSOHLDS2",60,0)
 ..;S %=^PS(51,"A",X),X=$P(%,"^") I $P(%,"^",2)]"" S Y=$P(SIG," ",P-1),Y=$E(Y,$L(Y)) S:Y>1 X=$P(%,"^",2)
"RTN","PSOHLDS2",61,0)
 .S SGY=SGY_X_" "
"RTN","PSOHLDS2",62,0)
 S X="",SGC=1 F J=1:1 S Z=$P(SGY," ",J) S:Z="" SGY(SGC)=X Q:Z=""  S:$L(X)+$L(Z)'<$S($P(PSOPAR,"^",28):46,1:34) SGY(SGC)=X,SGC=SGC+1,X="" S X=X_Z_" "
"RTN","PSOHLDS2",63,0)
SIGOLD I '$P(PSOPAR,"^",28) D  K NHC
"RTN","PSOHLDS2",64,0)
 .K DIC,DR,DIQ,NHC S DIC=2,DA=DFN,DR=148,DIQ="NHC",DIQ(0)="I"
"RTN","PSOHLDS2",65,0)
 .D EN^DIQ1 K DIC,DR,DIQ
"RTN","PSOHLDS2",66,0)
 .I NHC(2,DFN,148,"I")="Y"!($P($G(^PS(55,DFN,40)),"^")) S SGC=SGC+1,SGY(SGC)="Expiration:________ Mfg:_________"
"RTN","PSOHLDS2",67,0)
 Q
"RTN","PSOHLDS2",68,0)
 ;
"RTN","PSOHLDS2",69,0)
PSOLBL3 ;RX must be defined (Internal), Check already done for OERR SIG
"RTN","PSOHLDS2",70,0)
 ;Format OERR Sig for New and Old label stock
"RTN","PSOHLDS2",71,0)
 N CTCT,FFFF,LLIM,LLLL,LVAR,LVAR1,PPP,PPPP,SGCT,SIG9,ZZZZ,PSLONG,PPPP
"RTN","PSOHLDS2",72,0)
 S RX=IRXN
"RTN","PSOHLDS2",73,0)
 I $P($G(^PS(55,DFN,"LAN")),"^") N II D OTHL^PSOLBL3 G:$G(FND) FMSIG
"RTN","PSOHLDS2",74,0)
 S PSLONG=$S($P(PSOPAR,"^",28):46,1:34)
"RTN","PSOHLDS2",75,0)
 ; NEXT LINE IF SIG IS MOVED BACK TO MULTIPLE
"RTN","PSOHLDS2",76,0)
 S PPPP=1 F PPP=0:0 S PPP=$O(^PSRX(RX,"SIG1",PPP)) Q:'PPP  I $G(^PSRX(RX,"SIG1",PPP,0))'="" S SIG9(PPPP)=^(0) S PPPP=PPPP+1
"RTN","PSOHLDS2",77,0)
 ;NEXT LINE IF 1ST FRONT DOOR SIG LINE LIVES IN BACK DOOR SPOT
"RTN","PSOHLDS2",78,0)
FMSIG S (LVAR,LVAR1)="",LLLL=1
"RTN","PSOHLDS2",79,0)
 F FFFF=0:0 S FFFF=$O(SIG9(FFFF)) Q:'FFFF  S SGCT=0 F ZZZZ=1:1:$L(SIG9(FFFF)) I $E(SIG9(FFFF),ZZZZ)=" "!($L(SIG9(FFFF))=ZZZZ) S SGCT=SGCT+1 D  I $L(LVAR)>PSLONG S SGY(LLLL)=LLIM_" ",LLLL=LLLL+1,LVAR=LVAR1
"RTN","PSOHLDS2",80,0)
 .S LVAR1=$P(SIG9(FFFF)," ",(SGCT)),LLIM=LVAR,LVAR=$S(LVAR="":LVAR1,1:LVAR_" "_LVAR1)
"RTN","PSOHLDS2",81,0)
 I $G(LVAR)'="" S SGY(LLLL)=LVAR
"RTN","PSOHLDS2",82,0)
 I '$P(PSOPAR,"^",28) S SGC=0 F CTCT=0:0 S CTCT=$O(SGY(CTCT)) Q:'CTCT  S SGC=SGC+1
"RTN","PSOHLDS2",83,0)
 I $O(OSGY(0)) D
"RTN","PSOHLDS2",84,0)
 .F I=0:0 S I=$O(SGY(I)) Q:'I  I $G(OSGY(I))']"" S OSGY(I)=" "
"RTN","PSOHLDS2",85,0)
 .F I=0:0 S I=$O(OSGY(I)) Q:'I  I $G(SGY(I))']"" S SGY(I)=" "
"RTN","PSOHLDS2",86,0)
 Q
"RTN","PSOHLDS2",87,0)
NTE ;build NTE segment for SIG
"RTN","PSOHLDS2",88,0)
 ;
"RTN","PSOHLDS2",89,0)
 Q:'$D(DFN)
"RTN","PSOHLDS2",90,0)
 ; 1 = SIG
"RTN","PSOHLDS2",91,0)
 ; 2 = PI Narrative
"RTN","PSOHLDS2",92,0)
 ; 3 = Drug Warning
"RTN","PSOHLDS2",93,0)
 ; 4 = Profile
"RTN","PSOHLDS2",94,0)
 ; 5 = Drug Interaction
"RTN","PSOHLDS2",95,0)
 ; 6 = Drug Allergy
"RTN","PSOHLDS2",96,0)
 ; 7 = PMI Sheet (NTEPMI in PSOHLDS4)
"RTN","PSOHLDS2",97,0)
 ; 8 = Medication Instructions
"RTN","PSOHLDS2",98,0)
 ; 9 = Privacy Notification
"RTN","PSOHLDS2",99,0)
 ;
"RTN","PSOHLDS2",100,0)
 K FLDX
"RTN","PSOHLDS2",101,0)
 D NTE1(.PSI) K FLDX D NTE2(.PSI) K FLDX D NTE3(.PSI) K FLDX
"RTN","PSOHLDS2",102,0)
 D NTE4(.PSI) K FLDX D NTE5(.PSI) K FLDX D NTE6(.PSI) K FLDX
"RTN","PSOHLDS2",103,0)
 Q
"RTN","PSOHLDS2",104,0)
 ;
"RTN","PSOHLDS2",105,0)
NTE1(PSI) ;SIG
"RTN","PSOHLDS2",106,0)
 S SIG=$P($G(^PSRX(IRXN,"SIG")),"^")
"RTN","PSOHLDS2",107,0)
 I $P($G(^PSRX(IRXN,"SIG")),"^",2) D PSOLBL3,SIGOLD
"RTN","PSOHLDS2",108,0)
 I '$P($G(^PSRX(IRXN,"SIG")),"^",2) D SIG
"RTN","PSOHLDS2",109,0)
 I $O(OSGY(0)) D  G KNTE
"RTN","PSOHLDS2",110,0)
 .K DRR F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",111,0)
 .S DRR=DRR+1,SGY(DRR)=FS_"Medication Instructions (LANGUAGE PREFERENCE)"
"RTN","PSOHLDS2",112,0)
 .K DRR F DR=0:0 S DR=$O(OSGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",113,0)
 .S DRR=DRR+1,OSGY(DRR)=FS_"Medication Instructions (ENGLISH)"
"RTN","PSOHLDS2",114,0)
 .K DRR S ^TMP("PSO",$J,PSI)="NTE"_FS_1_FS_FS
"RTN","PSOHLDS2",115,0)
 .S CLD=1 F DR=0:0 S DR=$O(OSGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",116,0)
 ..S:$L($G(^TMP("PSO",$J,PSI,CLD))_OSGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_OSGY(DR)
"RTN","PSOHLDS2",117,0)
 .S PSI=PSI+1,^TMP("PSO",$J,PSI)="NTE"_FS_8_FS_FS
"RTN","PSOHLDS2",118,0)
 .S CLD=1 F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",119,0)
 ..S:$L($G(^TMP("PSO",$J,PSI,CLD))_SGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_SGY(DR)
"RTN","PSOHLDS2",120,0)
 K DRR F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",121,0)
 S DRR=DRR+1,SGY(DRR)=FS_"Medication Instructions"
"RTN","PSOHLDS2",122,0)
 K DRR S ^TMP("PSO",$J,PSI)="NTE"_FS_1_FS_FS
"RTN","PSOHLDS2",123,0)
 S CLD=1 F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",124,0)
 .S:$L($G(^TMP("PSO",$J,PSI,CLD))_SGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_SGY(DR)
"RTN","PSOHLDS2",125,0)
KNTE S PSI=PSI+1 K DR,CLD,DRR,SIG,E,F,S,FLD1,X,Y,SGY,SGC,Z,DR,%,J,P,NT1,ST,EN,LTH
"RTN","PSOHLDS2",126,0)
 Q
"RTN","PSOHLDS2",127,0)
LENGTH(NT1) ; compensate for length > 245
"RTN","PSOHLDS2",128,0)
 I $L(NT1)>245 S LTH=$E($L(NT1)/245,1) S:$L(NT1)#245>0 LTH=LTH+1 F WW=1:1:LTH D
"RTN","PSOHLDS2",129,0)
 . S:WW=1 ST=1,EN=245 S:WW>1 ST=(ST+245),EN=(EN+245) S NT11=$E(NT1,ST,EN)
"RTN","PSOHLDS2",130,0)
 . S:WW=1 ^TMP("PSO",$J,PSI)=NT11 S:WW>1 ^TMP("PSO",$J,PSI,WW-1)=NT11
"RTN","PSOHLDS2",131,0)
 S:'$D(LTH) ^TMP("PSO",$J,PSI)=NT1 S PSI=PSI+1
"RTN","PSOHLDS2",132,0)
 Q
"RTN","PSOHLDS2",133,0)
NTE2(PSI) ; Patient Narrative
"RTN","PSOHLDS2",134,0)
 K ^UTILITY($J,"W") S (DIWL,PSNACNT)=1,DIWR=45,DIWF="",(PSSIXFL,PSSEVFL)=0 F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,6,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",135,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1,PSSIXFL=1
"RTN","PSOHLDS2",136,0)
 I PSSIXFL S ^TMP("PSO",$J,PSI)="NTE"_FS_2_FS_FS,^TMP("PSO",$J,PSI,PSNACNT)=" " S PSNACNT=PSNACNT+1,FLDX=1
"RTN","PSOHLDS2",137,0)
 S DIWL=1,DIWR=45,DIWF="" K ^UTILITY($J,"W") F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,7,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",138,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1,PSSEVFL=1
"RTN","PSOHLDS2",139,0)
 I PSSEVFL S ^TMP("PSO",$J,PSI,PSNACNT)=" " S PSNACNT=PSNACNT+1
"RTN","PSOHLDS2",140,0)
 S DIWL=1,DIWR=45,DIWF="" K ^UTILITY($J,"W") F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,4,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",141,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1
"RTN","PSOHLDS2",142,0)
 S:$D(FLDX) ^TMP("PSO",$J,PSI,PSNACNT-1)=^TMP("PSO",$J,PSI,PSNACNT-1)_FS_"Patient Narrative",PSI=PSI+1
"RTN","PSOHLDS2",143,0)
 K DIWF,DIWL,DIWR,LLL,PSNACNT,PSSEVFL,PSSIXFL,ZZ
"RTN","PSOHLDS2",144,0)
 Q
"RTN","PSOHLDS2",145,0)
NTE3(PSI) ;Drug Warning Narrative
"RTN","PSOHLDS2",146,0)
 N NTE3,J,TEXT,W,CNT,PSSWSITE
"RTN","PSOHLDS2",147,0)
 S WARN=$P($G(^PSDRUG(IDGN,0)),"^",8)
"RTN","PSOHLDS2",148,0)
 S PSSWSITE=+$O(^PS(59.7,0))
"RTN","PSOHLDS2",149,0)
 I $P($G(^PS(59.7,PSSWSITE,10)),"^",11)="N" D
"RTN","PSOHLDS2",150,0)
 .S WARN=$$DRUG^PSSWRNA(IDGN,DFN)
"RTN","PSOHLDS2",151,0)
 I WARN="" Q
"RTN","PSOHLDS2",152,0)
 S NTE3="NTE"_FS_3_FS_FS,^TMP("PSO",$J,PSI)=NTE3,CNT=1
"RTN","PSOHLDS2",153,0)
 F J=1:1 S W=$P(WARN,",",J) Q:W=""  D
"RTN","PSOHLDS2",154,0)
 . S:CNT>1 ^TMP("PSO",$J,PSI,CNT-1)=^TMP("PSO",$J,PSI,CNT-1)_"\.sp\"
"RTN","PSOHLDS2",155,0)
 . S TEXT=$$WTEXT^PSSWRNA(W,$G(OLAN)) I TEXT'="" S FLDX=1 D
"RTN","PSOHLDS2",156,0)
 . . I $L(TEXT)<245 S ^TMP("PSO",$J,PSI,CNT)=TEXT,CNT=CNT+1 Q
"RTN","PSOHLDS2",157,0)
 . . N LTH,ST,EN,TXT,WW
"RTN","PSOHLDS2",158,0)
 . . S LTH=$E($L(TEXT)/245,1) S:$L(TEXT)#245>0 LTH=LTH+1
"RTN","PSOHLDS2",159,0)
 . . F WW=1:1:LTH D
"RTN","PSOHLDS2",160,0)
 . . . S:WW=1 ST=1,EN=245 S:WW>1 ST=(ST+245),EN=(EN+245) S TXT=$E(TEXT,ST,EN)
"RTN","PSOHLDS2",161,0)
 . . . S ^TMP("PSO",$J,PSI,CNT)=TXT,CNT=CNT+1
"RTN","PSOHLDS2",162,0)
 I $G(FLDX) D  S PSI=PSI+1
"RTN","PSOHLDS2",163,0)
 . I $L(^TMP("PSO",$J,PSI,CNT-1)_FS_"Drug Warning Narrative")<245 S ^TMP("PSO",$J,PSI,CNT-1)=$G(^TMP("PSO",$J,PSI,CNT-1))_FS_"Drug Warning Narrative"
"RTN","PSOHLDS2",164,0)
 . E  S ^TMP("PSO",$J,PSI,CNT)=FS_"Drug Warning Narrative"
"RTN","PSOHLDS2",165,0)
 Q
"RTN","PSOHLDS2",166,0)
NTE4(PSI) ;Profile information
"RTN","PSOHLDS2",167,0)
 S PSODFN=DFN N NTE4
"RTN","PSOHLDS2",168,0)
 I $P(PSOPAR,"^",8) D START^PSOHLDS3
"RTN","PSOHLDS2",169,0)
 S:$D(NTE4) PSI=PSI+1
"RTN","PSOHLDS2",170,0)
 Q
"RTN","PSOHLDS2",171,0)
NTE5(PSI) ;Drug Interactions
"RTN","PSOHLDS2",172,0)
 N NTE5 D:$D(DRI) START2^PSOHLDS3
"RTN","PSOHLDS2",173,0)
 S:$D(NTE5) ^TMP("PSO",$J,PSI)=NTE5_FS_"Drug Interactions",PSI=PSI+1
"RTN","PSOHLDS2",174,0)
 Q
"RTN","PSOHLDS2",175,0)
NTE6(PSI) ;Drug Allergy Indications
"RTN","PSOHLDS2",176,0)
 N NTE6
"RTN","PSOHLDS2",177,0)
 Q:'$G(DAW)
"RTN","PSOHLDS2",178,0)
 D START3^PSOHLDS3
"RTN","PSOHLDS2",179,0)
 Q:NTE6=""
"RTN","PSOHLDS2",180,0)
 S ^TMP("PSO",$J,PSI)=NTE6_FS_"Drug Allergy Indications",PSI=PSI+1
"RTN","PSOHLDS2",181,0)
 Q
"RTN","PSOHLDS2",182,0)
NTE9(PSI) ;Privacy Notification
"RTN","PSOHLDS2",183,0)
 N NTE9,PSOLAN
"RTN","PSOHLDS2",184,0)
 S NTE9="NTE"_FS_9_FS_FS,^TMP("PSO",$J,PSI)=NTE9
"RTN","PSOHLDS2",185,0)
 S PSOLAN=$P($G(^PS(55,DFN,"LAN")),"^",2)
"RTN","PSOHLDS2",186,0)
 I PSOLAN'=2 D
"RTN","PSOHLDS2",187,0)
 . S ^TMP("PSO",$J,PSI,1)="The VA Notice of Privacy Practices, IB 10-163, which outlines your privacy rights, is available online at http://www1.domain.ext/Health/ or you may obtain a copy by writing the VHA Privacy Office (19F2),"
"RTN","PSOHLDS2",188,0)
 . S ^TMP("PSO",$J,PSI,2)="810 Vermont Avenue NW, Washington, DC 20420."_FS_"Privacy Notification"
"RTN","PSOHLDS2",189,0)
 I PSOLAN=2 D
"RTN","PSOHLDS2",190,0)
 . S ^TMP("PSO",$J,PSI,1)="La Notificacion relacionada con las Politicas de Privacidad del Departamento de Asuntos del Veterano, IB 10-163, contiene los detalles acerca de sus derechos de privacidad y esta disponsible electronicamente"
"RTN","PSOHLDS2",191,0)
 . S ^TMP("PSO",$J,PSI,2)=" en la siguiente direccion: http://www1.domain.ext/Health/.  Usted tambien puede conseguir una copia escribiendo a la Oficina de Privacidad del Departamento de Asuntos de Salud del Veterano, (19F2),"
"RTN","PSOHLDS2",192,0)
 . S ^TMP("PSO",$J,PSI,3)="810 Vermont Avenue NW, Washington, DC 20420."_FS_"Privacy Notification"
"RTN","PSOHLDS2",193,0)
 S PSI=PSI+1
"RTN","PSOHLDS2",194,0)
 Q
"RTN","PSOHLPIS")
0^6^B56723490
"RTN","PSOHLPIS",1,0)
PSOHLPIS ;BIR/RTR-Parse out and create CPRS Sig ;7/21/96
"RTN","PSOHLPIS",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,225,282**;DEC 1997;Build 18
"RTN","PSOHLPIS",3,0)
 ;External reference to File #50.7 supported by DBIA 2223
"RTN","PSOHLPIS",4,0)
 ;External reference to File #51 supported by DBIA 2224
"RTN","PSOHLPIS",5,0)
 ;External reference to File #51.1 supported by DBIA 2225
"RTN","PSOHLPIS",6,0)
 ;External reference to File #51.2 supported by DBIA 2226
"RTN","PSOHLPIS",7,0)
 ;External reference to File #50.606 supported by DBIA 2174
"RTN","PSOHLPIS",8,0)
EN ;
"RTN","PSOHLPIS",9,0)
 Q:'$D(^PS(52.41,PENDING,1,0))
"RTN","PSOHLPIS",10,0)
 N PISI,PSOFX,SDF,SZZ,ZZS,ZZSB,SSZZ,SCHHOLD,GGGZ,SGLFLAG,SGLOOP,ZSCHED,SPFG,PSNOUN,MEDEXP,PSDUR,NOUN,SCHED,INTERVAL,SIG0,SIG2,SIG3,SDL,WW,TODOSE,PDAYS,WWFL,PSOCJS,PSOFDCT,PSODCT
"RTN","PSOHLPIS",11,0)
 N SSS,TT,DCOUNT,PREP,VERB,FFF,GGG,SIGDS,SIGRT,PSOROUTE,PSOSG1,PSOSG2,FTC,FTCA,FTCF,FTCNT
"RTN","PSOHLPIS",12,0)
 N SIG
"RTN","PSOHLPIS",13,0)
 F PISI=0:0 S PISI=$O(^PS(52.41,PENDING,1,PISI)) Q:'PISI  D:$D(^(PISI,0))
"RTN","PSOHLPIS",14,0)
 .S PSOFX("DOSE",PISI)=$P($G(^PS(52.41,PENDING,1,PISI,2)),"^") I $P($G(^(2)),"^",2)'="" S PSOFX("DOSE ORDERED",PISI)=$P($G(^(2)),"^",2)
"RTN","PSOHLPIS",15,0)
 .S PSOFX("SCHEDULE",PISI)=$P($G(^PS(52.41,PENDING,1,PISI,1)),"^"),PSOFX("ROUTE",PISI)=$P($G(^(1)),"^",8),PSOFX("DURATION",PISI)=$P($G(^(1)),"^",2),PSOFX("NOUN",PISI)=$P($G(^(1)),"^",5),PSOFX("CONJUNCTION",PISI)=$P($G(^(1)),"^",6)
"RTN","PSOHLPIS",16,0)
 .I $G(PSOFX("DURATION",PISI)) S PSOFX("DURATION",PISI)="D"_$G(PSOFX("DURATION",PISI))
"RTN","PSOHLPIS",17,0)
 .I $G(PSOFX("DURATION",PISI))'="" S PSOFX("DURATION",PISI)=$E(PSOFX("DURATION",PISI),2,999)_$E(PSOFX("DURATION",PISI))
"RTN","PSOHLPIS",18,0)
 S TODOSE=0 F WW=0:0 S WW=$O(PSOFX("DOSE",WW)) Q:'WW  S TODOSE=WW
"RTN","PSOHLPIS",19,0)
 Q:'TODOSE
"RTN","PSOHLPIS",20,0)
 S SIGDS=+$P($G(^PS(50.7,+$G(PSORDITE),0)),"^",2),VERB=$P($G(^PS(50.606,SIGDS,"MISC")),"^"),PREP=$P($G(^("MISC")),"^",3)
"RTN","PSOHLPIS",21,0)
 S FTCNT=0 K FTC,FTCA,FTCF F SSS=1:1:TODOSE D
"RTN","PSOHLPIS",22,0)
 .S SIG0(SSS)=$S($G(PSOFX("DOSE ORDERED",SSS))'="":$G(PSOFX("DOSE ORDERED",SSS)),1:$G(PSOFX("DOSE",SSS)))
"RTN","PSOHLPIS",23,0)
 .S PSNOUN(SSS)=$G(PSOFX("NOUN",SSS))
"RTN","PSOHLPIS",24,0)
 .S FTC=+$G(PSOFX("ROUTE",SSS)) I FTC S:'FTCNT FTCA=FTC S FTCNT=FTCNT+1
"RTN","PSOHLPIS",25,0)
 .I FTCNT>1,$G(FTC),$G(FTC)'=$G(FTCA) S FTCF=1
"RTN","PSOHLPIS",26,0)
 .S PSOROUTE(SSS)=$S($P($G(^PS(51.2,+$G(PSOFX("ROUTE",SSS)),0)),"^",2)'="":$P(^(0),"^",2),$P($G(^(0)),"^",3)'="":$P(^(0),"^",3),1:$P($G(^(0)),"^")) S MEDEXP(SSS)=$S($P($G(^PS(51.2,+$G(PSOFX("ROUTE",SSS)),0)),"^",2)="":0,1:1)
"RTN","PSOHLPIS",27,0)
 .S PDAYS(SSS)=$G(PSOFX("DURATION",SSS))
"RTN","PSOHLPIS",28,0)
 .I $G(PSOFX("DURATION",SSS))'="",($E(PSOFX("DURATION",SSS),$L(PSOFX("DURATION",SSS)))'?1A) S PDAYS(SSS)=PDAYS(SSS)_"D"
"RTN","PSOHLPIS",29,0)
 .S PSDUR(SSS)=$S($G(PDAYS(SSS))="":"NULL",1:"FOR "_$E($G(PDAYS(SSS)),1,($L($G(PDAYS(SSS)))-1))) D  I PSDUR(SSS)'="NULL" S PSDUR(SSS)=PSDUR(SSS)_" "_INTERVAL
"RTN","PSOHLPIS",30,0)
 ..I PSDUR(SSS)'="NULL" S INTERVAL=$E(PDAYS(SSS),$L(PDAYS(SSS))),INTERVAL=$S(INTERVAL="D":"DAYS",INTERVAL="W":"WEEKS",INTERVAL="H":"HOURS",INTERVAL="L":"MONTHS",INTERVAL="M":"MINUTES",INTERVAL="S":"SECONDS",1:"") D
"RTN","PSOHLPIS",31,0)
 ...I $G(INTERVAL)'="",$G(PSOFX("DURATION",SSS)),$G(PSOFX("DURATION",SSS))'>1 S INTERVAL=$E(INTERVAL,1,($L(INTERVAL)-1))
"RTN","PSOHLPIS",32,0)
 ;282 Schedule Expander Changed
"RTN","PSOHLPIS",33,0)
 F GGG=1:1:TODOSE S SCHED(GGG)=$$SCHE^PSOSIG($G(PSOFX("SCHEDULE",GGG)))
"RTN","PSOHLPIS",34,0)
 ;282 End Change
"RTN","PSOHLPIS",35,0)
 S (FTC,FTCA,PSOFDCT)=0 F FFF=0:0 S FFF=$O(SIG0(FFF)) Q:'FFF  D
"RTN","PSOHLPIS",36,0)
 .K PSOSG1,PSOSG2 D VERB D:$G(PSNOUN(FFF))'=""&('$G(PSOSG1)) SSS
"RTN","PSOHLPIS",37,0)
 .D FRAC
"RTN","PSOHLPIS",38,0)
 .S SIG2(FFF)=$S(VERB'=""&('$G(PSOSG1)):VERB_" ",1:"")_$S($G(PSOFX("DOSE ORDERED",FFF))'="":$S($G(PSOFRAC)'="":$G(PSOFRAC),1:$G(PSOFX("DOSE ORDERED",FFF)))_" ",1:$G(PSOFX("DOSE",FFF))_" ")
"RTN","PSOHLPIS",39,0)
 .S PSOFDCT=PSOFDCT+1
"RTN","PSOHLPIS",40,0)
 .K PSOFRAC,PSOFRACX
"RTN","PSOHLPIS",41,0)
 .I FTC>0,$G(PSOROUTE(FFF))'="",'$G(FTCF) S FTCA=1
"RTN","PSOHLPIS",42,0)
 .I $G(PSOROUTE(FFF))'="" S FTC=FTC+1
"RTN","PSOHLPIS",43,0)
 .S SIG2(FFF)=SIG2(FFF)_$S($G(PSNOUN(FFF))'=""&('$G(PSOSG2)):$G(PSNOUN(FFF))_" ",1:"")_$S(PREP'=""&($G(MEDEXP(FFF)))&('FTCA):PREP_" ",1:"")
"RTN","PSOHLPIS",44,0)
 .S SIG2(FFF)=SIG2(FFF)_$S(PSOROUTE(FFF)'=""&('FTCA):PSOROUTE(FFF)_" ",1:"")
"RTN","PSOHLPIS",45,0)
 .;S SIG2(FFF)=SIG2(FFF)_$S(SCHED(FFF)'="":SCHED(FFF)_" ",1:"")_$S(PSDUR(FFF)'="NULL":PSDUR(FFF)_" ",1:"")_$S($G(PSOFX("CONJUNCTION",FFF))="A":"AND",$G(PSOFX("CONJUNCTION",FFF))="T":"THEN",$G(PSOFX("CONJUNCTION",FFF))="S":"THEN",1:"")
"RTN","PSOHLPIS",46,0)
 .S SIG2(FFF)=SIG2(FFF)_$S(SCHED(FFF)'="":SCHED(FFF)_$S($G(PSDUR(FFF))="NULL"&($G(PSOFX("CONJUNCTION",FFF))="")&('$O(SIG0(FFF))):"",1:" "),1:"")
"RTN","PSOHLPIS",47,0)
 .S PSOCJS=$G(PSOFX("CONJUNCTION",FFF))
"RTN","PSOHLPIS",48,0)
 .S SIG2(FFF)=SIG2(FFF)_$S(PSDUR(FFF)'="NULL":PSDUR(FFF)_$S($G(PSOFX("CONJUNCTION",FFF))=""&('$O(SIG0(FFF))):"",1:", "),1:"")_$S($G(PSOCJS)="A":"AND",$G(PSOCJS)="T":"THEN",$G(PSOCJS)="S":"THEN",$G(PSOCJS)="X":"EXCEPT",1:"")
"RTN","PSOHLPIS",49,0)
 .K PSOSG1,PSOSG2
"RTN","PSOHLPIS",50,0)
 .K PSOUCS S SIG2(FFF)=$$UPPER(SIG2(FFF)) K PSOUCS
"RTN","PSOHLPIS",51,0)
 ;I $G(PSOFX("INS"))'="" S TODOSE=TODOSE+1,SIG2(TODOSE)=$G(PSOFX("INS"))
"RTN","PSOHLPIS",52,0)
 S PSODCT="" F  S PSODCT=$O(^PS(52.41,PENDING,"INS1",PSODCT)) Q:PSODCT=""  I $D(^(PSODCT,0)) S PSOFDCT=PSOFDCT+1 S SIG2(PSOFDCT)=$G(^(0)) K PSOUCS S SIG2(PSOFDCT)=$$UPPER(SIG2(PSOFDCT)) K PSOUCS
"RTN","PSOHLPIS",53,0)
STUFF ;
"RTN","PSOHLPIS",54,0)
 S DCOUNT=0
"RTN","PSOHLPIS",55,0)
 I '$D(SIG2(1)) G QUIT
"RTN","PSOHLPIS",56,0)
 I '$O(SIG2(1)),$L(SIG2(1))<71 S ^PS(52.41,PENDING,"SIG",0)="^52.4124A^"_1_"^"_1 S ^PS(52.41,PENDING,"SIG",1,0)=$$UNESC^ORHLESC(SIG2(1)) S DCOUNT=1 G QUITIN
"RTN","PSOHLPIS",57,0)
 S (VAR,VAR1)="",II=1
"RTN","PSOHLPIS",58,0)
 F FF=0:0 S FF=$O(SIG2(FF)) Q:'FF  S CT=0 F NN=1:1:$L(SIG2(FF)) I $E(SIG2(FF),NN)=" "!($L(SIG2(FF))=NN) S CT=CT+1 D  I $L(VAR)>70 S SIG(II)=LIM_" ",II=II+1,VAR=VAR1
"RTN","PSOHLPIS",59,0)
 .S VAR1=$P(SIG2(FF)," ",(CT))
"RTN","PSOHLPIS",60,0)
 .S LIM=VAR
"RTN","PSOHLPIS",61,0)
 .S VAR=$S(VAR="":VAR1,1:VAR_" "_VAR1)
"RTN","PSOHLPIS",62,0)
 I $G(VAR)'="" S SIG(II)=VAR
"RTN","PSOHLPIS",63,0)
 F II=0:0 S II=$O(SIG(II)) Q:'II  S DCOUNT=DCOUNT+1 S ^PS(52.41,PENDING,"SIG",DCOUNT,0)=$$UNESC^ORHLESC(SIG(II))
"RTN","PSOHLPIS",64,0)
 I DCOUNT S ^PS(52.41,PENDING,"SIG",0)="^52.4124A^"_DCOUNT_"^"_DCOUNT
"RTN","PSOHLPIS",65,0)
QUITIN ;I $P($G(^PS(50.7,+$G(PSORDITE),"INS")),"^")'="",DCOUNT S DCOUNT=DCOUNT+1,^PS(52.41,PENDING,"SIG",0)="^52.4124A^"_DCOUNT_"^"_DCOUNT,^PS(52.41,PENDING,"SIG",DCOUNT,0)=$P($G(^PS(50.7,+$G(PSORDITE),"INS")),"^")
"RTN","PSOHLPIS",66,0)
 ;I $P($G(^PS(50.7,+$G(PSORDITE),"INS")),"^")'="" S $P(^PS(52.41,PENDING,"INS"),"^")=$P(^PS(50.7,+$G(PSORDITE),"INS"),"^")
"RTN","PSOHLPIS",67,0)
QUIT K SSS,TT,DCOUNT,PREP,VERB,FFF,GGG,SIGDS,SIGRT,PSOROUTE,PSOSG1,PSOSG2 Q
"RTN","PSOHLPIS",68,0)
SIG1 ;
"RTN","PSOHLPIS",69,0)
 F FFF=0:0 S FFF=$O(SIG0(FFF)) Q:'FFF  S SIG2(FFF)=SIG0(FFF)
"RTN","PSOHLPIS",70,0)
 Q
"RTN","PSOHLPIS",71,0)
DAYS I +$E($P(SIG1(TT),"^",2))!($E($P(SIG1(TT),"^",2))=0) S $P(SIG1(TT),"^",2)="D"_$P(SIG1(TT),"^",2)
"RTN","PSOHLPIS",72,0)
 Q
"RTN","PSOHLPIS",73,0)
NON ;
"RTN","PSOHLPIS",74,0)
 I $P($G(SIG0(SSS)),"&",2)'="" S PSNOUN(SSS)=$P($G(SIG0(SSS)),"&",2) Q
"RTN","PSOHLPIS",75,0)
 Q
"RTN","PSOHLPIS",76,0)
 F NOUN=0:0 S NOUN=$O(^PS(50.606,SIGDS,"NOUN",NOUN)) Q:'NOUN!($G(PSNOUN(SSS))'="")  I $P($G(^PS(50.606,SIGDS,"NOUN",NOUN,0)),"^")'="" S PSNOUN(SSS)=$P(^(0),"^")
"RTN","PSOHLPIS",77,0)
 Q
"RTN","PSOHLPIS",78,0)
VERB ;Check if verb and noun need to be added to SIG
"RTN","PSOHLPIS",79,0)
 K PSOLCS,PSOUCS,PSOISL,PSOVL
"RTN","PSOHLPIS",80,0)
 I $G(VERB)'="" S PSOVL=$L(VERB),PSOISL=$E($G(SIG0(FFF)),1,$G(PSOVL)) I $G(PSOISL)'="" D
"RTN","PSOHLPIS",81,0)
 .S PSOUCS=VERB
"RTN","PSOHLPIS",82,0)
 .S PSOUCS=$$UPPER(PSOUCS) I PSOUCS=PSOISL S PSOSG1=1 Q
"RTN","PSOHLPIS",83,0)
 .S PSOUCS=$$LOWER(PSOUCS) I PSOUCS=PSOISL S PSOSG1=1 Q
"RTN","PSOHLPIS",84,0)
 .S PSOUCS=$$UPPER($E(PSOUCS,1))_$$LOWER($E(PSOUCS,2,99)) I PSOUCS=PSOISL S PSOSG1=1 Q
"RTN","PSOHLPIS",85,0)
 I $G(PSNOUN(FFF))="" G VERBEX
"RTN","PSOHLPIS",86,0)
 S PSOISL=$G(SIG0(FFF)) I $G(PSOISL)="" G VERBEX
"RTN","PSOHLPIS",87,0)
 S PSOVL=$F(PSNOUN(FFF),"(")
"RTN","PSOHLPIS",88,0)
 I $G(PSOVL)>2 S PSOUCS=$E(PSNOUN(FFF),1,(PSOVL-2))
"RTN","PSOHLPIS",89,0)
 I $G(PSOVL)'>2 S PSOUCS=PSNOUN(FFF)
"RTN","PSOHLPIS",90,0)
 I $G(PSOISL)'="" D
"RTN","PSOHLPIS",91,0)
 .S PSOUCS=$$UPPER(PSOUCS) I PSOISL[PSOUCS S PSOSG2=1 Q
"RTN","PSOHLPIS",92,0)
 .S PSOUCS=$$LOWER(PSOUCS) I PSOISL[PSOUCS S PSOSG2=1 Q
"RTN","PSOHLPIS",93,0)
 .S PSOUCS=$$UPPER($E(PSOUCS,1))_$$LOWER($E(PSOUCS,2,99)) I PSOISL[PSOUCS S PSOSG2=1
"RTN","PSOHLPIS",94,0)
VERBEX K PSOLCS,PSOUCS,PSOISL,PSOVL Q
"RTN","PSOHLPIS",95,0)
 ;
"RTN","PSOHLPIS",96,0)
UPPER(PSOUCS) ;
"RTN","PSOHLPIS",97,0)
 Q $TR(PSOUCS,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSOHLPIS",98,0)
 ;
"RTN","PSOHLPIS",99,0)
LOWER(PSOLCS) ;
"RTN","PSOHLPIS",100,0)
 Q $TR(PSOLCS,"ABCDEFGHIJKLMNOPQRSTUVWXYZ","abcdefghijklmnopqrstuvwxyz")
"RTN","PSOHLPIS",101,0)
 Q
"RTN","PSOHLPIS",102,0)
 ;
"RTN","PSOHLPIS",103,0)
SSS ;
"RTN","PSOHLPIS",104,0)
 K PSOFNL,PSOFNLF,PSOFNLX
"RTN","PSOHLPIS",105,0)
 Q:$G(PSNOUN(FFF))=""
"RTN","PSOHLPIS",106,0)
 Q:$L(PSNOUN(FFF))'>3
"RTN","PSOHLPIS",107,0)
 Q:'$G(PSOFX("DOSE ORDERED",FFF))
"RTN","PSOHLPIS",108,0)
 ;Q:$G(PSOFX("DOSE ORDERED",FFF))>1
"RTN","PSOHLPIS",109,0)
 S PSOFNL=$E(PSNOUN(FFF),($L(PSNOUN(FFF))-2),$L(PSNOUN(FFF)))
"RTN","PSOHLPIS",110,0)
 I $G(PSOFNL)="(S)"!($G(PSOFNL)="(s)") D
"RTN","PSOHLPIS",111,0)
 .I $G(PSOFX("DOSE ORDERED",FFF))'>1 S PSNOUN(FFF)=$E(PSNOUN(FFF),1,($L(PSNOUN(FFF))-3))
"RTN","PSOHLPIS",112,0)
 .I $G(PSOFX("DOSE ORDERED",FFF))>1 S PSNOUN(FFF)=$E(PSNOUN(FFF),1,($L(PSNOUN(FFF))-3))_$E(PSOFNL,2)
"RTN","PSOHLPIS",113,0)
 Q
"RTN","PSOHLPIS",114,0)
FRAC ;
"RTN","PSOHLPIS",115,0)
 K PSOFRAC,PSOFRACX,PSOFRAC1,PSOFRAC2
"RTN","PSOHLPIS",116,0)
 I $G(PSOFX("DOSE ORDERED",FFF))="" Q
"RTN","PSOHLPIS",117,0)
 I $G(PSOFX("DOSE ORDERED",FFF))'["." S (PSOFRAC1,PSOFRAC)=$G(PSOFX("DOSE ORDERED",FFF)) D NUM D  G FRACQ
"RTN","PSOHLPIS",118,0)
 .I $G(PSOFRAC1)=$G(PSOFRAC) K PSOFRAC,PSOFRAC1 Q
"RTN","PSOHLPIS",119,0)
 .S PSOFRAC=$G(PSOFRAC1)
"RTN","PSOHLPIS",120,0)
 S PSOFRAC1=$P(PSOFX("DOSE ORDERED",FFF),"."),PSOFRAC2=$P(PSOFX("DOSE ORDERED",FFF),".",2)
"RTN","PSOHLPIS",121,0)
 S PSOFRACX="."_$G(PSOFRAC2)
"RTN","PSOHLPIS",122,0)
 S PSOFRAC=$S(PSOFRACX=".5":"ONE-HALF",PSOFRACX=".25":"ONE-FOURTH",PSOFRACX=".33":"ONE-THIRD",PSOFRACX=".34":"ONE-THIRD",PSOFRACX=".50":"ONE-HALF",PSOFRACX=".66":"TWO-THIRDS",PSOFRACX=".67":"TWO-THIRDS",PSOFRACX=".75":"THREE-FOURTHS",1:"")
"RTN","PSOHLPIS",123,0)
 I $G(PSOFRAC)="" K PSOFRAC G FRACQ
"RTN","PSOHLPIS",124,0)
 I $G(PSOFRAC1)'="",+$G(PSOFRAC1) D NUM S PSOFRAC=$G(PSOFRAC1)_" AND "_$G(PSOFRAC)
"RTN","PSOHLPIS",125,0)
FRACQ K PSOFRAC1,PSOFRAC2
"RTN","PSOHLPIS",126,0)
 Q
"RTN","PSOHLPIS",127,0)
NUM ;
"RTN","PSOHLPIS",128,0)
 Q:$G(PSOFRAC1)=""
"RTN","PSOHLPIS",129,0)
 S PSOFRAC1=$S(PSOFRAC1="1":"ONE",PSOFRAC1="2":"TWO",PSOFRAC1="3":"THREE",PSOFRAC1="4":"FOUR",PSOFRAC1="5":"FIVE",PSOFRAC1="6":"SIX",PSOFRAC1="7":"SEVEN",PSOFRAC1="8":"EIGHT",PSOFRAC1="9":"NINE",PSOFRAC1="10":"TEN",1:PSOFRAC1)
"RTN","PSOHLPIS",130,0)
 Q
"RTN","PSOHLSIG")
0^7^B24372866
"RTN","PSOHLSIG",1,0)
PSOHLSIG ;BIR/RTR-Parse out and create possible Sig ; 7/21/96
"RTN","PSOHLSIG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,18,41,60,282**;DEC 1997;Build 18
"RTN","PSOHLSIG",3,0)
 ;External reference to File #50.7 supported by DBIA 2223
"RTN","PSOHLSIG",4,0)
 ;External reference to File #51 supported by DBIA 2224
"RTN","PSOHLSIG",5,0)
 ;External reference to File #51.1 supported by DBIA 2225
"RTN","PSOHLSIG",6,0)
 ;External reference to File #51.2 supported by DBIA 2226
"RTN","PSOHLSIG",7,0)
 ;External reference to File #50.606 supported by DBIA 2174
"RTN","PSOHLSIG",8,0)
 Q:'$D(^PS(52.41,PENDING,1,0))
"RTN","PSOHLSIG",9,0)
 N SDF,SZZ,ZZS,ZZSB,SSZZ,SCHHOLD,GGGZ,SGLFLAG,SGLOOP,ZSCHED,SPFG,PSNOUN,MEDEXP,PSDUR,NOUN,SCHED,INTERVAL,SIG0,SIG2,SIG3,SDL,WW
"RTN","PSOHLSIG",10,0)
 S SIGRT=$P(^PS(52.41,PENDING,0),"^",15),SIGDS=$P(^PS(50.7,$P(^(0),"^",8),0),"^",2),VERB=$P($G(^PS(50.606,SIGDS,"MISC")),"^"),PREP=$P($G(^("MISC")),"^",3)
"RTN","PSOHLSIG",11,0)
 F SSS=0:0 S SSS=$O(^PS(52.41,PENDING,1,SSS)) Q:'SSS  S SIG0(SSS)=$G(^PS(52.41,PENDING,1,SSS,0)),SIG1(SSS)=$G(^(1)) D NON
"RTN","PSOHLSIG",12,0)
 ;I SIG0(1)'["&" D SIG1 G STUFF
"RTN","PSOHLSIG",13,0)
 S PSOROUTE=$S($P($G(^PS(51.2,+SIGRT,0)),"^",2)'="":$P(^(0),"^",2),$P($G(^(0)),"^",3)'="":$P(^(0),"^",3),1:$P($G(^(0)),"^")) S MEDEXP=$S($P($G(^PS(51.2,+SIGRT,0)),"^",2)="":0,1:1)
"RTN","PSOHLSIG",14,0)
 ;282 Schedule Expander Changed
"RTN","PSOHLSIG",15,0)
 F GGG=0:0 S GGG=$O(SIG1(GGG)) Q:'GGG  S SCHED(GGG)=$$SCHE^PSOSIG($P(SIG1(GGG),"^"))
"RTN","PSOHLSIG",16,0)
 ;282 End Change
"RTN","PSOHLSIG",17,0)
 F TT=0:0 S TT=$O(SIG1(TT)) Q:'TT  D DAYS S PSDUR(TT)=$S($P(SIG1(TT),"^",2)=""!($E($P(SIG1(TT),"^",2))="I"):"NULL",1:"FOR "_$E($P(SIG1(TT),"^",2),2,$L($P(SIG1(TT),"^",2)))) D  I PSDUR(TT)'="NULL" S PSDUR(TT)=PSDUR(TT)_" "_INTERVAL
"RTN","PSOHLSIG",18,0)
 .I PSDUR(TT)'="NULL" S INTERVAL=$P(SIG1(TT),"^",2),INTERVAL=$S($E(INTERVAL)="D":"DAY(S)",$E(INTERVAL)="W":"WEEK(S)",$E(INTERVAL)="H":"HOUR(S)",$E(INTERVAL)="L":"MONTH(S)",$E(INTERVAL)="M":"MINUTE(S)",$E(INTERVAL)="S":"SECOND(S)",1:"")
"RTN","PSOHLSIG",19,0)
 F FFF=0:0 S FFF=$O(SIG0(FFF)) Q:'FFF  D
"RTN","PSOHLSIG",20,0)
 .;I SIG0(FFF)'["&" S SIG2(FFF)=SIG0(FFF) Q
"RTN","PSOHLSIG",21,0)
 .;S SIG2(FFF)=VERB_" "_$P($P(SIG0(FFF),"^"),"&")_" "_$G(PSNOUN(FFF))_" "_PREP_" "_PSOROUTE_$S(SCHED(FFF)'="":" "_SCHED(FFF),1:"")_$S(PSDUR(FFF)'="NULL":PSDUR(FFF),1:"")_$S($P(SIG1(FFF),"^",6)="A":" AND",$P(SIG1(FFF),"^",6)="S":" THEN",1:"")
"RTN","PSOHLSIG",22,0)
 .K PSOSG1,PSOSG2 D VERB
"RTN","PSOHLSIG",23,0)
 .S SIG2(FFF)=$S(VERB'=""&('$G(PSOSG1)):VERB_" ",1:"")_$S($P($P(SIG0(FFF),"^"),"&")'="":$P($P(SIG0(FFF),"^"),"&")_" ",1:"")_$S($G(PSNOUN(FFF))'=""&('$G(PSOSG2)):$G(PSNOUN(FFF))_" ",1:"")_$S(PREP'=""&($G(MEDEXP)):PREP_" ",1:"")
"RTN","PSOHLSIG",24,0)
 .S SIG2(FFF)=SIG2(FFF)_$S(PSOROUTE'="":PSOROUTE_" ",1:"")
"RTN","PSOHLSIG",25,0)
 .S SIG2(FFF)=SIG2(FFF)_$S(SCHED(FFF)'="":SCHED(FFF)_" ",1:"")_$S(PSDUR(FFF)'="NULL":PSDUR(FFF)_" ",1:"")_$S($P(SIG1(FFF),"^",6)="A":"AND",$P(SIG1(FFF),"^",6)="S":"THEN",1:"")
"RTN","PSOHLSIG",26,0)
 .K PSOSG1,PSOSG2
"RTN","PSOHLSIG",27,0)
STUFF ;
"RTN","PSOHLSIG",28,0)
 S DCOUNT=0
"RTN","PSOHLSIG",29,0)
 I '$D(SIG2(1)) G QUIT
"RTN","PSOHLSIG",30,0)
 I '$O(SIG2(1)),$L(SIG2(1))<71 S ^PS(52.41,PENDING,"SIG",0)="^52.4124A^"_1_"^"_1 S ^PS(52.41,PENDING,"SIG",1,0)=SIG2(1) G QUIT
"RTN","PSOHLSIG",31,0)
 S (VAR,VAR1)="",II=1
"RTN","PSOHLSIG",32,0)
 F FF=0:0 S FF=$O(SIG2(FF)) Q:'FF  S CT=0 F NN=1:1:$L(SIG2(FF)) I $E(SIG2(FF),NN)=" "!($L(SIG2(FF))=NN) S CT=CT+1 D  I $L(VAR)>70 S SIG3(II)=LIM_" ",II=II+1,VAR=VAR1
"RTN","PSOHLSIG",33,0)
 .S VAR1=$P(SIG2(FF)," ",(CT))
"RTN","PSOHLSIG",34,0)
 .S LIM=VAR
"RTN","PSOHLSIG",35,0)
 .S VAR=$S(VAR="":VAR1,1:VAR_" "_VAR1)
"RTN","PSOHLSIG",36,0)
 I $G(VAR)'="" S SIG3(II)=VAR
"RTN","PSOHLSIG",37,0)
 F II=0:0 S II=$O(SIG3(II)) Q:'II  S DCOUNT=DCOUNT+1 S ^PS(52.41,PENDING,"SIG",DCOUNT,0)=SIG3(II)
"RTN","PSOHLSIG",38,0)
 I DCOUNT S ^PS(52.41,PENDING,"SIG",0)="^52.4124A^"_DCOUNT_"^"_DCOUNT
"RTN","PSOHLSIG",39,0)
QUIT K SSS,TT,DCOUNT,PREP,VERB,FFF,GGG,SIGDS,SIGRT,PSOROUTE,PSOSG1,PSOSG2 Q
"RTN","PSOHLSIG",40,0)
SIG1 ;
"RTN","PSOHLSIG",41,0)
 F FFF=0:0 S FFF=$O(SIG0(FFF)) Q:'FFF  S SIG2(FFF)=SIG0(FFF)
"RTN","PSOHLSIG",42,0)
 Q
"RTN","PSOHLSIG",43,0)
DAYS I +$E($P(SIG1(TT),"^",2))!($E($P(SIG1(TT),"^",2))=0) S $P(SIG1(TT),"^",2)="D"_$P(SIG1(TT),"^",2)
"RTN","PSOHLSIG",44,0)
 Q
"RTN","PSOHLSIG",45,0)
NON ;
"RTN","PSOHLSIG",46,0)
 I $P($G(SIG0(SSS)),"&",2)'="" S PSNOUN(SSS)=$P($G(SIG0(SSS)),"&",2) Q
"RTN","PSOHLSIG",47,0)
 F NOUN=0:0 S NOUN=$O(^PS(50.606,SIGDS,"NOUN",NOUN)) Q:'NOUN!($G(PSNOUN(SSS))'="")  I $P($G(^PS(50.606,SIGDS,"NOUN",NOUN,0)),"^")'="",$P($G(^(0)),"^",3) S PSNOUN(SSS)=$P(^(0),"^")
"RTN","PSOHLSIG",48,0)
 Q
"RTN","PSOHLSIG",49,0)
VERB ;Check if verb and noun need to be added to SIG
"RTN","PSOHLSIG",50,0)
 K PSOLCS,PSOUCS,PSOISL,PSOVL
"RTN","PSOHLSIG",51,0)
 I $G(VERB)'="" S PSOVL=$L(VERB),PSOISL=$E($P($P(SIG0(FFF),"^"),"&"),1,$G(PSOVL)) I $G(PSOISL)'="" D
"RTN","PSOHLSIG",52,0)
 .S PSOUCS=VERB
"RTN","PSOHLSIG",53,0)
 .S PSOUCS=$$UPPER(PSOUCS) I PSOUCS=PSOISL S PSOSG1=1 Q
"RTN","PSOHLSIG",54,0)
 .S PSOUCS=$$LOWER(PSOUCS) I PSOUCS=PSOISL S PSOSG1=1 Q
"RTN","PSOHLSIG",55,0)
 .S PSOUCS=$$UPPER($E(PSOUCS,1))_$$LOWER($E(PSOUCS,2,99)) I PSOUCS=PSOISL S PSOSG1=1 Q
"RTN","PSOHLSIG",56,0)
 I $G(PSNOUN(FFF))="" G VERBEX
"RTN","PSOHLSIG",57,0)
 S PSOISL=$P($P(SIG0(FFF),"^"),"&") I $G(PSOISL)="" G VERBEX
"RTN","PSOHLSIG",58,0)
 S PSOVL=$F(PSNOUN(FFF),"(")
"RTN","PSOHLSIG",59,0)
 I $G(PSOVL)>2 S PSOUCS=$E(PSNOUN(FFF),1,(PSOVL-2))
"RTN","PSOHLSIG",60,0)
 I $G(PSOVL)'>2 S PSOUCS=PSNOUN(FFF)
"RTN","PSOHLSIG",61,0)
 I $G(PSOISL)'="" D
"RTN","PSOHLSIG",62,0)
 .S PSOUCS=$$UPPER(PSOUCS) I PSOISL[PSOUCS S PSOSG2=1 Q
"RTN","PSOHLSIG",63,0)
 .S PSOUCS=$$LOWER(PSOUCS) I PSOISL[PSOUCS S PSOSG2=1 Q
"RTN","PSOHLSIG",64,0)
 .S PSOUCS=$$UPPER($E(PSOUCS,1))_$$LOWER($E(PSOUCS,2,99)) I PSOISL[PSOUCS S PSOSG2=1
"RTN","PSOHLSIG",65,0)
VERBEX K PSOLCS,PSOUCS,PSOISL,PSOVL Q
"RTN","PSOHLSIG",66,0)
 ;
"RTN","PSOHLSIG",67,0)
UPPER(PSOUCS) ;
"RTN","PSOHLSIG",68,0)
 Q $TR(PSOUCS,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSOHLSIG",69,0)
 ;
"RTN","PSOHLSIG",70,0)
LOWER(PSOLCS) ;
"RTN","PSOHLSIG",71,0)
 Q $TR(PSOLCS,"ABCDEFGHIJKLMNOPQRSTUVWXYZ","abcdefghijklmnopqrstuvwxyz")
"RTN","PSOLBL2")
0^8^B36920595
"RTN","PSOLBL2",1,0)
PSOLBL2 ;BIR/SAB-LABEL OUTPUT CONT. ;11/18/92 19:15
"RTN","PSOLBL2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**16,19,30,71,92,117,135,326,367,383,282**;DEC 1997;Build 18
"RTN","PSOLBL2",3,0)
 ;External reference to ^PS(51 supported by DBIA 2224
"RTN","PSOLBL2",4,0)
 ;External reference to ^PS(54 supported by DBIA 2227
"RTN","PSOLBL2",5,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOLBL2",6,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOLBL2",7,0)
 ;External reference to ^DPT supported by DBIA 3097
"RTN","PSOLBL2",8,0)
 ;External reference to GMRADPT supported by DBIA 10099
"RTN","PSOLBL2",9,0)
 I $P($G(^PSRX(RX,"SIG")),"^",2) K SGY D ^PSOLBL3 G SIGOLD
"RTN","PSOLBL2",10,0)
 D SIG
"RTN","PSOLBL2",11,0)
QUIT K SIG,E,F,S Q
"RTN","PSOLBL2",12,0)
SIG K OT S SGY="" F P=1:1:$L(SIG," ") S X=$P(SIG," ",P) D:X]""
"RTN","PSOLBL2",13,0)
 .I $D(^PS(51,"A",X)) D
"RTN","PSOLBL2",14,0)
 ..;PSO*7*282 Intended use
"RTN","PSOLBL2",15,0)
 ..I $P($G(^PS(55,DFN,"LAN")),"^") S OT=$O(^PS(51,"B",X,0)) I OT,$P($G(^PS(51,OT,0)),"^",4)<2,$P($G(^PS(51,OT,4)),"^")]"" S X=$P(^PS(51,OT,4),"^") K OT Q
"RTN","PSOLBL2",16,0)
 ..S %=^PS(51,"A",X),X=$P(%,"^") I $P(%,"^",2)]"" S Y=$P(SIG," ",P-1),Y=$E(Y,$L(Y)) S:Y>1 X=$P(%,"^",2)
"RTN","PSOLBL2",17,0)
 .S SGY=SGY_X_" "
"RTN","PSOLBL2",18,0)
 S X="",SGC=1 F J=1:1 S Z=$P(SGY," ",J) S:Z="" SGY(SGC)=X Q:Z=""  S:$L(X)+$L(Z)'<$S($P(PSOPAR,"^",28):46,1:34) SGY(SGC)=X,SGC=SGC+1,X="" S X=X_Z_" "
"RTN","PSOLBL2",19,0)
SIGOLD I '$P(PSOPAR,"^",28) D  K NHC
"RTN","PSOLBL2",20,0)
 .K DIC,DR,DIQ,NHC S DIC=2,DA=DFN,DR=148,DIQ="NHC",DIQ(0)="I"
"RTN","PSOLBL2",21,0)
 .D EN^DIQ1 K DIC,DR,DIQ
"RTN","PSOLBL2",22,0)
 .I NHC(2,DFN,148,"I")="Y"!($P($G(^PS(55,DFN,40)),"^")) S SGC=SGC+1,SGY(SGC)="Expiration:________ Mfg:_________"
"RTN","PSOLBL2",23,0)
 ;
"RTN","PSOLBL2",24,0)
DPT S X=$S($D(^DPT(DFN,0))#2:^(0),1:""),DOB=$P(X,"^",3),L=$E(X,1)
"RTN","PSOLBL2",25,0)
 S Y=$P(X,"^",9),PNM=$P(X,"^") D PID^VADPT S SS="",SSNP=""
"RTN","PSOLBL2",26,0)
 I $P(PSOPAR,"^",28) K SIG,E,F,S Q
"RTN","PSOLBL2",27,0)
GMRA X "N X S X=""GMRADPT"" X ^%ZOSF(""TEST"") Q" I '$T S (INT(1),INT(2),INT(3))="" Q
"RTN","PSOLBL2",28,0)
 S GMRA="0^1^111" D ^GMRADPT S I1=1,INT(1)="ALLERGIES: ",(INT(2),INT(3))="" F I=0:0 S I=$O(GMRAL(I)) Q:I'>0  S AL=$P(GMRAL(I),U,2) S:$L(INT(I1))+$L(AL)>42 I1=I1+1,INT(I1)="" S INT(I1)=INT(I1)_AL_", "
"RTN","PSOLBL2",29,0)
 ;K GMRA,GMRAL Q
"RTN","PSOLBL2",30,0)
 Q
"RTN","PSOLBL2",31,0)
SIGPH S SIGPH=SIG,X="",SGCPH=1 F J=1:1:100 S Z=$P(SIGPH," ",J) S:Z="" SIGPH(SGCPH)=X S:$L(X)+$L(Z)'<34 SIGPH(SGCPH)=X,SGCPH=SGCPH+1,X="" S X=X_Z_" "
"RTN","PSOLBL2",32,0)
 Q
"RTN","PSOLBL2",33,0)
WARN W:'$G(PSOBLALL) @IOF W ?54,PNM,!,?54,"Rx# ",RXN,!,?54,DRUG,!,?54,"DRUG WARNING:" S DIWL=55,DIWR=100,DIWF="W" F WW=1:1 Q:$P(WARN,",",WW,99)=""  S PSOWARN=$P(WARN,",",WW) D:$D(^PS(54,PSOWARN,0))
"RTN","PSOLBL2",34,0)
 .K ^UTILITY($J,"W") F AA=0:0 S AA=$O(^PS(54,PSOWARN,1,AA)) Q:'AA  S X=^(AA,0) D ^DIWP D ^DIWW
"RTN","PSOLBL2",35,0)
 K WW,PSOWARN,AA W:$G(PSOBLALL) @IOF Q
"RTN","PSOLBL2",36,0)
REP ;LEFT SIDE ONLY REPRINT FOR NEW LABEL STOCK
"RTN","PSOLBL2",37,0)
 K PSOSTLK,ZTKDRUG I $L($T(PSOSTALK^PSOTALK1)) D PSOSTALK^PSOTALK1 S PSOSTLK=1 ; PRINT SCRIPTALK LABEL IF APPLICABLE
"RTN","PSOLBL2",38,0)
 S ZTKDRUG="XXXXXX   SCRIPTALK RX   XXXXXX"
"RTN","PSOLBL2",39,0)
 S Y=DATE X ^DD("DD") S DATE=Y S TECH="("_$S($P($G(^PSRX(+$G(RX),"OR1")),"^",5):$P($G(^PSRX(+$G(RX),"OR1")),"^",5),1:$P(RXY,"^",16))_"/"_$S($G(VRPH)&($P(PSOPAR,"^",32)):VRPH,1:" ")_")"
"RTN","PSOLBL2",40,0)
 S PSZIP=$P(PS,"^",5) S PSOHZIP=$S(PSZIP["-":PSZIP,1:$E(PSZIP,1,5)_$S($E(PSZIP,6,9)]"":"-"_$E(PSZIP,6,9),1:""))
"RTN","PSOLBL2",41,0)
 W "VAMC ",$P(PS,"^",7),", ",STATE,"  ",$G(PSOHZIP),?102,"(REPRINT)" W:$G(RXP) "(PARTIAL)" W !,$P(PS2,"^",2),"  ",$P(PS,"^",3),"-",$P(PS,"^",4),"   ",TECH
"RTN","PSOLBL2",42,0)
 W !,"Rx# ",RXN,"  ",DATE,"  Fill ",RXF+1," of ",1+$P(RXY,"^",9),!,PNM
"RTN","PSOLBL2",43,0)
 F DR=1:1 Q:$G(SGY(DR))=""  D:DR=4!(DR=7)!(DR=10)!(DR=13)  W !,$G(SGY(DR))
"RTN","PSOLBL2",44,0)
 .F GG=1:1:27 W !
"RTN","PSOLBL2",45,0)
 I DR>4 S KK=$S(DR=5!(DR=8)!(DR=11):2,(DR=6)!(DR=9)!(DR=12):1,1:0) I KK F HH=1:1:KK W !
"RTN","PSOLBL2",46,0)
 I DR=2 W !!
"RTN","PSOLBL2",47,0)
 I DR=3 W !
"RTN","PSOLBL2",48,0)
 W ! S PSDU=$P($G(^PSDRUG($P($G(^PSRX(RX,0)),"^",6),660)),"^",8) W $G(PHYS),!,"Qty: "_$G(QTY),"  ",$G(PSDU),$S($G(PSDU)="":"      ",1:" "),$S($G(NURSE):"Mfg______Exp______",1:"")
"RTN","PSOLBL2",49,0)
 I $G(PSOSTLK) W !,$S($G(PSOTALK)&('$G(PSOTREP)):ZTKDRUG,1:DRUG)
"RTN","PSOLBL2",50,0)
 I '$G(PSOSTLK) W !,DRUG
"RTN","PSOLBL2",51,0)
 K PSDU W !!,$P(PS,"^",2),!,$P(PS,"^",7),", ",STATE,"  ",$G(PSOHZIP),!!!!,"ADDRESS SERVICE REQUESTED",!
"RTN","PSOLBL2",52,0)
 I "C"[$E(MW) W ?21,"CERTIFIED MAIL",!
"RTN","PSOLBL2",53,0)
 E  W !
"RTN","PSOLBL2",54,0)
 W !,$S($G(PS55)=2:"***DO NOT MAIL***",1:"***CRITICAL MEDICAL SHIPMENT***")
"RTN","PSOLBL2",55,0)
 ;
"RTN","PSOLBL2",56,0)
 ; Printing FDA Medication Guide (if there's one)
"RTN","PSOLBL2",57,0)
 I $$MGONFILE^PSOFDAUT(+$G(RX)) D
"RTN","PSOLBL2",58,0)
 . W ?83,"Read FDA Med Guide"
"RTN","PSOLBL2",59,0)
 . I $G(REPRINT),'$D(RXRP(RX,"MG")) Q 
"RTN","PSOLBL2",60,0)
 . N FDAMG S FDAMG=$$PRINTMG^PSOFDAMG(RX,$P($G(PSOFDAPT),"^",2))
"RTN","PSOLBL2",61,0)
 ;
"RTN","PSOLBL2",62,0)
 W !!!,PNM,!,$S($D(PSMP(1)):PSMP(1),1:VAPA(1)),!,$S($D(PSMP(2)):PSMP(2),$D(PSMP(1)):"",1:$G(ADDR(2))),!,$S($D(PSMP(3)):PSMP(3),$D(PSMP(1)):"",1:$G(ADDR(3))),!,$S($D(PSMP(4)):PSMP(4),$D(PSMP(1)):"",1:$G(ADDR(4)))
"RTN","PSOLBL2",63,0)
 W @IOF Q
"RTN","PSOLBL2",64,0)
MUL ;
"RTN","PSOLBL2",65,0)
 I $G(PSOBARS),$P($G(PSOPAR),"^",19) W:J=1 !!! W:J=2 !
"RTN","PSOLBL2",66,0)
 E  W:J=1 !!!!!!!!! W:J=2 !!!!!!!! W:J=3 !!!!!! W:J=4 !!!! W:J=5 !!
"RTN","PSOLBL2",67,0)
 W !,"Use the label above to mail the computer",!,"copies back to us. Apply enough postage",!,"to your envelope to ensure delivery."
"RTN","PSOLBL2",68,0)
 Q
"RTN","PSOLBL2",69,0)
MULT W !,"Use the label above to mail the computer",?54,"(",PSLN,")",!,"copies back to us. Apply enough postage",?60,"PATIENT'S SIGNATURE   "_$E(DT,4,5),"/",$E(DT,6,7),"/",($E(DT,1,3)+1700),!,"to your envelope to ensure delivery."
"RTN","PSOLBL2",70,0)
 Q
"RTN","PSOLBL2",71,0)
PRINT S (PSONOPR,PSOWSTOP,PSOASTOP)=0 F CCC=1:1 Q:$G(PSONOPR)  D
"RTN","PSOLBL2",72,0)
 .W ?54,$G(^TMP($J,"PSOWPT",CCC)) S:'$O(^(CCC)) PSOWSTOP=1
"RTN","PSOLBL2",73,0)
 .W ?102,$G(^TMP($J,"PSOAPT",CCC)),! S:'$O(^(CCC)) PSOASTOP=1
"RTN","PSOLBL2",74,0)
 .I PSOWSTOP,PSOASTOP S PSONOPR=1
"RTN","PSOLBL2",75,0)
 K ^TMP($J,"PSOWARN"),^TMP($J,"ALWA"),^TMP($J,"PSOWPT"),^TMP($J,"PSOAPT"),PSONKA,PSONULL,WWW,GMRA,GMRAL,PSOWARN,JJJ,WCNT,RRR,ALG,ALCNT,EEE,FFF,PSOLG,PSOLGA,PSORY,CCC,PSONOPR,PSOWSTOP,PSOASTOP W @IOF
"RTN","PSOLBL2",76,0)
 Q
"RTN","PSOLBL2",77,0)
KILL K PSCLN,DATE,DR,RXY,RFLMSG,COPIES,DRUG,LMI,LINE,INT,ISD,I1,MW,STATE,SIDE,SGY,PATST,PRTFL,PHYS,SGC,VRPH,NLWS,Y,TECH,LFLDT,EXPDT,COPAYVAR,NURSE,X,X1,X2,PSCAP,LOT,DIFF,DAYS,ZZ,GG,HH,KK,ULN,PSZIP,PSOHZIP,PSOPROV,PSMP,REPRINT,PS55,PS55X
"RTN","PSOLBL2",78,0)
 K PSOLBLDR,PSOLBLPS,OSIG,OSGY
"RTN","PSOLBL2",79,0)
 Q
"RTN","PSOLBL2",80,0)
TRAIL I $P(^PS(59,PSOSITE,1),"^",28) D ^PSOLBLN2
"RTN","PSOLBL2",81,0)
 D:'$P(^PS(59,PSOSITE,1),"^",28) ^PSOLBLS I $D(^TMP($J,"PSOCP",DFN)),'$P(^PS(59,PSOSITE,1),"^",28) D INV^PSOCPE
"RTN","PSOLBL2",82,0)
 K RXPI,PSORX,RXP,PSOIOS,PSOLAPPL,XXX,TECH,COPAYVAR,PHYS,MFG,NURSE,STATE,SIDE,COPIES,EXDT,ISD,PSOINST,RXN,RXY,VADT,DEA,WARN,FDT,QTY,PARST,PDA,PS,PS1,PS2,PSL,PSNP,INRX,RR,XTYPE,SSNP,PNM,ADDR,PSODBQ,PSOLASTF
"RTN","PSOLBL2",83,0)
 K ^TMP($J,"PSOCP",+$G(PSOCPN)),PSDFNFLG,PSOLAPPL
"RTN","PSOLBL2",84,0)
 I '$G(PSOBLALL) K PSOCPN,PSOLBLCP
"RTN","PSOLBL2",85,0)
 Q
"RTN","PSONVNEW")
0^9^B22533044
"RTN","PSONVNEW",1,0)
PSONVNEW ;BIR/SAB - Add Non-VA Med orders ;2/13/07 11:35am
"RTN","PSONVNEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**132,118,203,265,282**;DEC 1997;Build 18
"RTN","PSONVNEW",3,0)
 ;External reference ^PS(50.606 supported by DBIA 2174
"RTN","PSONVNEW",4,0)
 ;External reference ^PS(50.7 supported by DBIA 2223
"RTN","PSONVNEW",5,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSONVNEW",6,0)
 ;External reference to ^PS(51.2 supported by DBIA 2226
"RTN","PSONVNEW",7,0)
 ;adds new non-va med to #55
"RTN","PSONVNEW",8,0)
 ;
"RTN","PSONVNEW",9,0)
 ;*203 change 3 fields from "///" to "////" they can be larger than
"RTN","PSONVNEW",10,0)
 ;      defined and need to be put in as is to prevent hard crash.
"RTN","PSONVNEW",11,0)
 ;*265 change update of Dosage & Sched fields DR strings, can contain ;      free form char ";"
"RTN","PSONVNEW",12,0)
 ;
"RTN","PSONVNEW",13,0)
 I '$D(^PS(55,DFN,0)) D
"RTN","PSONVNEW",14,0)
 .K DD,DO S DIC(0)="L",(DINUM,X)=DFN,DIC("DR")="52.1////2" D FILE^DICN D:Y<1  K DIC,DA,DR,DD,DO
"RTN","PSONVNEW",15,0)
 ..S $P(^PS(55,DFN,0),"^")=DFN,$P(^(0),"^",6)=2
"RTN","PSONVNEW",16,0)
 ..K DIK S DA=DFN,DIK="^PS(55,",DIK(1)=.01 D EN^DIK K DIK
"RTN","PSONVNEW",17,0)
 ;
"RTN","PSONVNEW",18,0)
 N PSONVA,DSC K PCOM
"RTN","PSONVNEW",19,0)
 F I=0:0 S I=$O(MSG(I)) Q:'I  D
"RTN","PSONVNEW",20,0)
 .I $P(MSG(I),"|")="NTE",$P(MSG(I),"|",2)=6 S DSC=$G(DSC)+1 S PCOM(DSC)=$P(MSG(I),"|",4) F T=0:0 S T=$O(MSG(I,T)) Q:'T  S DSC=DSC+1,PCOM(DSC)=MSG(I,T)
"RTN","PSONVNEW",21,0)
 .I $P(MSG(I),"|")="ORC" S STDT=$P(MSG(I),"|",8),STRDT=$$HL7TFM^XLFDT($P(STDT,"^",4))
"RTN","PSONVNEW",22,0)
 ;
"RTN","PSONVNEW",23,0)
 ; - Files the Non-VA Med order into the "NVA" multiple in File #55
"RTN","PSONVNEW",24,0)
 K DR,DIC,DD,DA,DO,DINUM S DA(1)=DFN,X=PSORDITE
"RTN","PSONVNEW",25,0)
 ;*203,*265 fix DR & dose & sched fields
"RTN","PSONVNEW",26,0)
 S PSODOS=$G(PSOLQ1I(1)),PSOSCH=$$SCHED($P($G(QTARRAY(1)),"^"))
"RTN","PSONVNEW",27,0)
 S DR="1////"_PSODDRUG_";2////^S X=PSODOS;3////"_$$ROUTE($G(ROUTE(1)))
"RTN","PSONVNEW",28,0)
 S DR=DR_";4////^S X=PSOSCH;7////"_$G(PLACER)_";8///"_$G(STRDT)
"RTN","PSONVNEW",29,0)
 S DR=DR_";11///"_$G(PSOLOG)_";12////"_$G(ENTERED)_";13////"_$G(LOCATION)
"RTN","PSONVNEW",30,0)
 S DIC("DR")=DR,DIC(0)="L",DIC="^PS(55,"_DFN_",""NVA"",",DLAYGO=55.05
"RTN","PSONVNEW",31,0)
 D FILE^DICN S PSONVA=+Y K DR,DIC,DD,DA,DO,DINUM
"RTN","PSONVNEW",32,0)
 K PSODOS,PSOSCH
"RTN","PSONVNEW",33,0)
 ;
"RTN","PSONVNEW",34,0)
 K DSC,STDT
"RTN","PSONVNEW",35,0)
 I $P(PSODSC,"^",2)]"" D
"RTN","PSONVNEW",36,0)
 .S DSC=1,^PS(55,DFN,"NVA",PSONVA,"DSC",1,0)=$P(PSODSC,"^",2)
"RTN","PSONVNEW",37,0)
 .S ^PS(55,DFN,"NVA",PSONVA,"DSC",0)="^55.052^1^1^"_DT_"^^^^"
"RTN","PSONVNEW",38,0)
 I $O(PSODSC(0)) D
"RTN","PSONVNEW",39,0)
 .F T=0:0 S T=$O(PSODSC(T)) Q:'T  S DSC=$G(DSC)+1,^PS(55,DFN,"NVA",PSONVA,"DSC",DSC,0)=PSODSC(T)
"RTN","PSONVNEW",40,0)
 .S ^PS(55,DFN,"NVA",PSONVA,"DSC",0)="^55.052^"_DSC_"^"_DSC_"^"_DT_"^^^^"
"RTN","PSONVNEW",41,0)
 I $O(PCOM(0)) F T=0:0 S T=$O(PCOM(T)) Q:'T  D
"RTN","PSONVNEW",42,0)
 .S DSC=$G(DSC)+1,^PS(55,DFN,"NVA",PSONVA,"DSC",DSC,0)=PCOM(T)
"RTN","PSONVNEW",43,0)
 .S ^PS(55,DFN,"NVA",PSONVA,"DSC",0)="^55.052^"_DSC_"^"_DSC_"^"_DT_"^^^^"
"RTN","PSONVNEW",44,0)
 .S ^PS(55,DFN,"NVA",PSONVA,1,T,0)=PCOM(T)
"RTN","PSONVNEW",45,0)
 .S ^PS(55,DFN,"NVA",PSONVA,1,0)="^^"_T_"^"_T_"^"_DT_"^"
"RTN","PSONVNEW",46,0)
 I $G(OCOUNT) S ^PS(55,DFN,"NVA",PSONVA,"OCK",0)="^55.051^"_OCOUNT_"^"_OCOUNT F OCOUNT=1:1:OCOUNT D
"RTN","PSONVNEW",47,0)
 .S ^PS(55,DFN,"NVA",PSONVA,"OCK",OCOUNT,0)=$G(OBXAR(OCOUNT,1))_"^"_PROV
"RTN","PSONVNEW",48,0)
 .I $G(OBXAR(OCOUNT,1))]"" S ^PS(55,DFN,"NVA",PSONVA,"OCK","B",$E(OBXAR(OCOUNT,1),1,30),OCOUNT)=""
"RTN","PSONVNEW",49,0)
 .S PSOBCT=1 F LLL=2:1 Q:'$D(OBXAR(OCOUNT,LLL))  S ^PS(55,DFN,"NVA",PSONVA,"OCK",OCOUNT,"OVR",1,0)=OBXAR(OCOUNT,LLL)
"RTN","PSONVNEW",50,0)
 K HOLD,SCH,SCHED,SDL,SGL,A,W,WW,CHR,STRDT
"RTN","PSONVNEW",51,0)
 ;
"RTN","PSONVNEW",52,0)
 M PMSG=MSG
"RTN","PSONVNEW",53,0)
REIN K MSG S NULLFLDS="F JJ=0:1:LIMIT S FIELD(JJ)="""""
"RTN","PSONVNEW",54,0)
 K ^UTILITY("DIQ1",$J),DIQ S DA=$P($$SITE^VASITE(),"^")
"RTN","PSONVNEW",55,0)
 I $G(DA) S DIC=4,DIQ(0)="I",DR="99" D EN^DIQ1 S PSOHINST=$G(^UTILITY("DIQ1",$J,4,DA,99,"I")) K ^UTILITY("DIQ1",$J),DA,DR,DIQ,DIC
"RTN","PSONVNEW",56,0)
 S MSG(1)="MSH|^~\&|PHARMACY|"_$G(PSOHINST)_"|||||ORR"
"RTN","PSONVNEW",57,0)
 ;
"RTN","PSONVNEW",58,0)
 S COUNT=1,LIMIT=5 X NULLFLDS D DEM^VADPT S NAME=$G(VADM(1)) K VADM
"RTN","PSONVNEW",59,0)
 S FIELD(0)="PID",FIELD(3)=DFN,FIELD(5)=NAME
"RTN","PSONVNEW",60,0)
 D SEG^PSOHLSN1
"RTN","PSONVNEW",61,0)
 ;
"RTN","PSONVNEW",62,0)
 ;
"RTN","PSONVNEW",63,0)
 S LIMIT=19 X NULLFLDS
"RTN","PSONVNEW",64,0)
 S FIELD(0)="PV1",FIELD(2)="O",FIELD(3)=LOCATION
"RTN","PSONVNEW",65,0)
 D SEG^PSOHLSN1
"RTN","PSONVNEW",66,0)
 ;
"RTN","PSONVNEW",67,0)
 S LIMIT=15 X NULLFLDS
"RTN","PSONVNEW",68,0)
 S FIELD(0)="ORC",FIELD(1)=$S($G(REIN):"SC",1:"OK"),FIELD(2)=PLACER_"^OR",FIELD(3)=PSONVA_"N^PS",FIELD(5)="CM"
"RTN","PSONVNEW",69,0)
 S FIELD(10)=$P(^PS(55,DFN,"NVA",PSONVA,0),"^",11)_"^"_$P(^VA(200,$P(^PS(55,DFN,"NVA",PSONVA,0),"^",11),0),"^")
"RTN","PSONVNEW",70,0)
 D SEG^PSOHLSN1
"RTN","PSONVNEW",71,0)
 I $G(REIN) S MSG(COUNT)=MSG(COUNT)_"|^^^^DATE OF DEATH DELETED BY MAS.^"
"RTN","PSONVNEW",72,0)
 ;
"RTN","PSONVNEW",73,0)
 S LIMIT=1 X NULLFLDS
"RTN","PSONVNEW",74,0)
 S FIELD(0)="RXO",OI=$P(^PS(55,DFN,"NVA",PSONVA,0),"^")
"RTN","PSONVNEW",75,0)
 S FIELD(1)="^^^"_OI_"^"_$P($G(^PS(50.7,OI,0)),"^")_" "_$P($G(^PS(50.606,+$P($G(^(0)),"^",2),0)),"^")_"^99PSP"
"RTN","PSONVNEW",76,0)
 D SEG^PSOHLSN1
"RTN","PSONVNEW",77,0)
 ;
"RTN","PSONVNEW",78,0)
 S LIMIT=1 X NULLFLDS
"RTN","PSONVNEW",79,0)
 S FIELD(0)="RXE"
"RTN","PSONVNEW",80,0)
 S PSOPSTRT="",X=$P(^PS(55,DFN,"NVA",PSONVA,0),"^",9) I X S PSOPSTRT=$$FMTHL7^XLFDT(X)
"RTN","PSONVNEW",81,0)
 K X S FIELD(1)="^^^"_$G(PSOPSTRT)_"^"
"RTN","PSONVNEW",82,0)
 D SEG^PSOHLSN1
"RTN","PSONVNEW",83,0)
 ;
"RTN","PSONVNEW",84,0)
 D SEND^PSOHLSN1 K FIELDS,LIMIT,PSODSC,PSONVA,OI Q:$G(REIN)
"RTN","PSONVNEW",85,0)
 ;dc change order
"RTN","PSONVNEW",86,0)
DC F OO=0:0 S OO=$O(PMSG(OO)) Q:'OO  I $P(PMSG(OO),"|")="ORC",$P(PMSG(OO),"|",2)="XO" D  Q
"RTN","PSONVNEW",87,0)
 .F XO=0:0 S XO=$O(PMSG(XO)) Q:'XO  I $P(PMSG(XO),"|")="ZRX" S POERR("PSOFILNM")=$P(PMSG(XO),"|",2) Q
"RTN","PSONVNEW",88,0)
 I +$G(POERR("PSOFILNM")),$G(^PS(55,DFN,"NVA",+$G(POERR("PSOFILNM")),0)) S PDFN=DFN D XO^PSOORUTL
"RTN","PSONVNEW",89,0)
 K XO,OO,PMSG
"RTN","PSONVNEW",90,0)
 Q
"RTN","PSONVNEW",91,0)
SCHED(SCH) ; Returns the SCHEDULE description
"RTN","PSONVNEW",92,0)
 ; *282 Centralized call
"RTN","PSONVNEW",93,0)
 Q $$SCHE^PSOSIG(SCH)
"RTN","PSONVNEW",94,0)
 ;
"RTN","PSONVNEW",95,0)
ROUTE(RTIEN) ; Returns the ROUTE description
"RTN","PSONVNEW",96,0)
 N X
"RTN","PSONVNEW",97,0)
 Q:'$G(RTIEN) "" S X=$G(^PS(51.2,RTIEN,0))
"RTN","PSONVNEW",98,0)
 Q $S($P(X,"^",2)'="":$P(X,"^",2),1:$P(X,"^"))
"RTN","PSONVNEW",99,0)
 ;
"RTN","PSONVNEW",100,0)
APSOD ;dc non-va meds because of date of death entry called from psocan3
"RTN","PSONVNEW",101,0)
 N PDA,PDFN ;,POERR("PSOFILNM")
"RTN","PSONVNEW",102,0)
 F PDA=0:0 S PDA=$O(^PS(55,PSODFN,"NVA",PDA)) Q:'PDA  I '$P(^PS(55,PSODFN,"NVA",PDA,0),"^",6),'$P(^(0),"^",7) D
"RTN","PSONVNEW",103,0)
 .S POERR("PSOFILNM")=PDA,PDFN=PSODFN D XO^PSOORUTL
"RTN","PSONVNEW",104,0)
 Q
"RTN","PSOORED4")
0^10^B57161028
"RTN","PSOORED4",1,0)
PSOORED4 ;BIR/SAB - Edit front door dosing ;07/13/00
"RTN","PSOORED4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,91,78,99,111,117,133,159,148,251,391,372,416,313,437,282**;DEC 1997;Build 18
"RTN","PSOORED4",3,0)
 ;External reference ^PS(51 supported by DBIA 2224
"RTN","PSOORED4",4,0)
 ;External reference to PS(51.2 supported by DBIA 2226
"RTN","PSOORED4",5,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOORED4",6,0)
 ;called from psoornew
"RTN","PSOORED4",7,0)
 ;
"RTN","PSOORED4",8,0)
DOSE(PSORXED) ;
"RTN","PSOORED4",9,0)
 I '$G(PSODRUG("IEN")) W !,"DRUG NAME REQUIRED!" D 2^PSOORNW1 I '$G(PSODRUG("IEN")) S VALMSG="No Dispense Drug Selected" Q
"RTN","PSOORED4",10,0)
 K ROU,STRE,UNITN,PSODOSE M PSODOSE=PSORXED
"RTN","PSOORED4",11,0)
 D KV K FIELD,DOSEOR,DUPD,X,Y,UNITS S ENT=1,OLENT=$G(PSORXED("ENT"))
"RTN","PSOORED4",12,0)
ASK I $G(ORD) W !!,"Possible SIG: " D
"RTN","PSOORED4",13,0)
 .;Coded only for outside orders with no Patient Instructions
"RTN","PSOORED4",14,0)
 .I $O(SIG(""))="",$G(ORD),$P($G(^PS(52.41,ORD,"EXT")),"^")'="" D SIGS^PSOHCPRS
"RTN","PSOORED4",15,0)
 .S INST=0 F  S INST=$O(SIG(INST)) Q:'INST  S MIG=SIG(INST) D
"RTN","PSOORED4",16,0)
 ..F SG=1:1:$L(MIG," ") W:$X+$L($P(MIG," ",SG)_" ")>IOM !?14 W $P(MIG," ",SG)_" "
"RTN","PSOORED4",17,0)
 K SG,INST,MIG
"RTN","PSOORED4",18,0)
 S ROU="PSOORED4",II=ENT D ASK^PSOBKDED K ROU,II I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED4",19,0)
 G:$D(DIRUT) EXQ
"RTN","PSOORED4",20,0)
 ;
"RTN","PSOORED4",21,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED4",22,0)
VER D VER^PSOOREDX I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED4",23,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",24,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED4",25,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED4",26,0)
DUPD ;
"RTN","PSOORED4",27,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED4",28,0)
 D DUPD^PSOOREDX
"RTN","PSOORED4",29,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:1) S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED4",30,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED4",31,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",32,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED4",33,0)
 D STR^PSOOREDX
"RTN","PSOORED4",34,0)
NOU1 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOORED4",35,0)
 D CNON^PSOORED3
"RTN","PSOORED4",36,0)
 N PSONDEF
"RTN","PSOORED4",37,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOORED4",38,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED4",39,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",40,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED4",41,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED4",42,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED4",43,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED4",44,0)
 ;
"RTN","PSOORED4",45,0)
RTE K JUMP S ROU="PSOORED4" D RTE^PSOBKDED K ROU
"RTN","PSOORED4",46,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED4",47,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",48,0)
 ;
"RTN","PSOORED4",49,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED4",50,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",51,0)
 S SCH=Y D SCH^PSOSIG I $G(SCH)']"" G SCH
"RTN","PSOORED4",52,0)
 S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED4",53,0)
 S:PSORXED("ENT")<ENT PSORXED("ENT")=ENT
"RTN","PSOORED4",54,0)
 ;
"RTN","PSOORED4",55,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN DAYS, HOURS OR MINUTES)"
"RTN","PSOORED4",56,0)
 S DIR("B")=$S($G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED4",57,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED4",58,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",59,0)
 D DUR1^PSOOREDX
"RTN","PSOORED4",60,0)
 ;
"RTN","PSOORED4",61,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED4",62,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",63,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED4",64,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED4",65,0)
 I X="@",$D(PSORXED("CONJUNCTION",ENT)) D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOORED4",66,0)
 ;
"RTN","PSOORED4",67,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED4",68,0)
 ;*437
"RTN","PSOORED4",69,0)
 I '$$DUROK^PSOORED3(.PSORXED,ENT) D  G DUR
"RTN","PSOORED4",70,0)
 . W !!,"Duration is required for the dosage entered prior to the THEN conjunction.",$C(7),!
"RTN","PSOORED4",71,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSONEW("DFLG")) EX S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED4",72,0)
 E  K PSOCKCON D DCHK1^PSODOSUT I $D(DTOUT)!($D(DUOUT)) S PSORX("DFLG")=1,PSONEW("DFLG")=1 G EX  ;don't need to print the full summary, just the last sequence. 
"RTN","PSOORED4",73,0)
 I PSOSAVX="",$G(PSORXED) K PSOCKCON,PSOEDDOS
"RTN","PSOORED4",74,0)
 K PSOSAVX
"RTN","PSOORED4",75,0)
 ;
"RTN","PSOORED4",76,0)
 S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOORED4",77,0)
 D EN^PSOFSIG(.PSORXED),VERI I $G(CKX),'$G(PSOSIGFL) D MP1 K CKX
"RTN","PSOORED4",78,0)
 I $G(PSOSIGFL)=1 D  I '$G(PSOSIGFL) Q
"RTN","PSOORED4",79,0)
 .I $D(OR0),$P(OR0,"^",24)=1 S VALMSG="Digitally Signed Order - No such changes allowed." K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D  Q
"RTN","PSOORED4",80,0)
 ..I $D(PSOBDR) K PSODRUG M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOORED4",81,0)
 .S PSORXED("ENT")=ENT,SIGOK=1,VALMSG="This change will create a new prescription!",NCPDPFLG=1
"RTN","PSOORED4",82,0)
 K QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED4",83,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED4",84,0)
 K QTYHLD
"RTN","PSOORED4",85,0)
 I '$G(PSORXED("QTY")),$P(OR0,"^",10) S PSORXED("QTY")=$P(OR0,"^",10)
"RTN","PSOORED4",86,0)
EX ;
"RTN","PSOORED4",87,0)
 K PSOBDR,PSOBDRG,PSOSCH,DUPD,STRE,UNITN,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSODOSE,OLENT,FIELD,FLDNM,AR,NM,ENT,STRE,UNITN,PSODOSE,ERTE,ROU
"RTN","PSOORED4",88,0)
KV K DTOUT,DUOUT,DIR,DIRUT
"RTN","PSOORED4",89,0)
 Q
"RTN","PSOORED4",90,0)
EXQ ;
"RTN","PSOORED4",91,0)
 K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D MP1
"RTN","PSOORED4",92,0)
 I $D(PSOBDR) M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOORED4",93,0)
 G EX Q
"RTN","PSOORED4",94,0)
MP1 D MP1^PSOOREDX
"RTN","PSOORED4",95,0)
 Q
"RTN","PSOORED4",96,0)
VERI ;checks for changes to dosing instructions
"RTN","PSOORED4",97,0)
 S ENTS=0
"RTN","PSOORED4",98,0)
 F I=0:0 S I=$O(PSORXED("DOSE",I)) Q:'I  S ENTS=$G(ENTS)+1
"RTN","PSOORED4",99,0)
 I ENTS<OLENT!(ENTS>OLENT) S PSOSIGFL=1 Q
"RTN","PSOORED4",100,0)
 F I=1:1:OLENT D
"RTN","PSOORED4",101,0)
 .I +PSODOSE("DOSE",I)'=$G(PSORXED("DOSE",I)) S PSOSIGFL=1
"RTN","PSOORED4",102,0)
 .I $G(PSODOSE("DURATION",I))]"" D
"RTN","PSOORED4",103,0)
 ..S DURATION=$S($E(PSODOSE("DURATION",I),1)'?.N:$E(PSODOSE("DURATION",I),2,99)_$E(PSODOSE("DURATION",I),1),1:PSODOSE("DURATION",I))
"RTN","PSOORED4",104,0)
 ..I +DURATION'=+$G(PSORXED("DURATION",I)) S PSOSIGFL=1
"RTN","PSOORED4",105,0)
 .I $G(PSODOSE("CONJUNCTION",I))'=$G(PSORXED("CONJUNCTION",I)) S PSOSIGFL=1
"RTN","PSOORED4",106,0)
 .I PSODOSE("ROUTE",I)'=$G(PSORXED("ROUTE",I)) S PSOSIGFL=1
"RTN","PSOORED4",107,0)
 .I PSODOSE("SCHEDULE",I)'=$G(PSORXED("SCHEDULE",I)) S PSOSIGFL=1
"RTN","PSOORED4",108,0)
 K DURATION Q
"RTN","PSOORED4",109,0)
JUMP ;jump to fields
"RTN","PSOORED4",110,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED4",111,0)
 D FNM^PSOOREDX
"RTN","PSOORED4",112,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED4",113,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED4",114,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED4",115,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED4",116,0)
 G EX
"RTN","PSOORED4",117,0)
 Q
"RTN","PSOORED4",118,0)
HLP ;help text for med route
"RTN","PSOORED4",119,0)
 D FULL^VALM1 W !,"Please enter how patient will use the medication!"
"RTN","PSOORED4",120,0)
 S DIC=51.2,X="??",DIC(0)="M",DIC("S")="I $P(^PS(51.2,+Y,0),""^"",4)" D ^DIC K DIC,X,Y
"RTN","PSOORED4",121,0)
 Q
"RTN","PSOORED4",122,0)
SCHLP ;
"RTN","PSOORED4",123,0)
 D FULL^VALM1 W !,"You can choose an entry from the Administration Schedule File (#51.1),",!,"Medication Instruction File (#51) or enter free text."
"RTN","PSOORED4",124,0)
 W !,"The free text entry cannot contain more than 2 spaces or be greater than 20",!,"characters in length."
"RTN","PSOORED4",125,0)
 W ! S DIR(0)="S^A:Administration Schedule File;M:Medication Instruction File;B:Both;F:Free Text",DIR("B")="Both"
"RTN","PSOORED4",126,0)
 S DIR("A")="Do you want to list from" D ^DIR I Y="F"!($G(DIRUT)) K X,Y G X
"RTN","PSOORED4",127,0)
 S LBL=Y G @LBL
"RTN","PSOORED4",128,0)
A ;display 51.1 entries only
"RTN","PSOORED4",129,0)
B K X,Y,DIC S X="??",DIC="^PS(51.1,",DIC(0)="QES",DIC("W")="D DICW^PSOORED4",D="APPSJ" W ! D IX^DIC
"RTN","PSOORED4",130,0)
 K DIC,X I LBL="A"!($G(DTOUT)) K LBL G X
"RTN","PSOORED4",131,0)
 I Y=-1!($G(DUOUT)) K DIR,DTOUT,DUOUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Do you want to continue with the Medication Instruction File"
"RTN","PSOORED4",132,0)
 D ^DIR I 'Y!($G(DTOUT)) K DIR,X,Y G X
"RTN","PSOORED4",133,0)
M K X,Y,DIC S DIC=51,X="??",DIC(0)="M" D ^DIC K DIC,X,Y,DTOUT,DUOUT,LBL
"RTN","PSOORED4",134,0)
 ;*282 Allow multi-word schedules
"RTN","PSOORED4",135,0)
X S DIR("?")="^D SCHLP^PSOORED4",DIR("A")="Schedule: ",DIR(0)="FA^1:20^I X[""""""""!(X?.E1C.E)!($A(X)=45)!($L(X,"" "")>$S(X[""PRN"":4,1:3))!($L(X)>20)!($L(X)<1) K X"
"RTN","PSOORED4",136,0)
 S DIR("B")=$S($D(PSOSCH)&('$D(PSORXED("SCHEDULE",ENT))):PSOSCH,$G(PSORXED("SCHEDULE",ENT))]"":PSORXED("SCHEDULE",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED4",137,0)
 Q
"RTN","PSOORED4",138,0)
DICW ;
"RTN","PSOORED4",139,0)
 S Z=$P(^PS(51.1,+Y,0),"^",5),Z=$S(Z="O":-1,Z="S":1,Z="R":-2,1:0) W:Z "  ",$S(Z>0:"SHIFT",Z=-2:"RANGE",1:"ONE-TIME")
"RTN","PSOORED4",140,0)
 I Z'<0,$D(PSJW),$D(^(PSJPP'="PSJ"+1,PSJW,0)),$P(^(0),"^",Z+2)]"" W "  ",$P(^(0),"^",Z+2)
"RTN","PSOORED4",141,0)
 ;Naked reference on DICW+2 is from DICW+1, ^PS(51.1,+Y,0)
"RTN","PSOORED4",142,0)
 Q
"RTN","PSOORNE2")
0^11^B68999201
"RTN","PSOORNE2",1,0)
PSOORNE2 ;BIR/SAB-display finished orders from backdoor ;9/11/06 10:24am
"RTN","PSOORNE2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,21,23,27,32,37,46,84,103,117,131,146,156,210,148,222,238,264,281,289,251,379,391,313,282**;DEC 1997;Build 18
"RTN","PSOORNE2",3,0)
 ;^PSDRUG( -  221
"RTN","PSOORNE2",4,0)
 ;^YSCL(603.01 - 2697
"RTN","PSOORNE2",5,0)
 ;^PS(50.606 - 2174
"RTN","PSOORNE2",6,0)
 ;^PS(50.7 - 2223
"RTN","PSOORNE2",7,0)
 ;PSO*210 add call to WORDWRAP api
"RTN","PSOORNE2",8,0)
 ;$$DAWEXT^PSSDAWUT - 4708
"RTN","PSOORNE2",9,0)
 ;
"RTN","PSOORNE2",10,0)
SEL N ORN,ORD I '$G(PSOCNT) S VALMSG="This patient has no Prescriptions!" S VALMBCK="" Q
"RTN","PSOORNE2",11,0)
 D K1^PSOORNE6 S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR I $D(DIRUT) D KV^PSOVER1 S VALMBCK="" Q
"RTN","PSOORNE2",12,0)
NEWSEL N ORN,ORD D K2^PSOORNE6
"RTN","PSOORNE2",13,0)
 ;*282 Correct Patient Instructions Copy
"RTN","PSOORNE2",14,0)
 I +Y S PSOOELSE=1,PSLST=Y K PSOREEDT F ORD=1:1:$L(PSLST,",") Q:$P(PSLST,",",ORD)']""  D  D UL1 K ^TMP("PSORXPO",$J),PSORXED,PSONEW,PSOPINS I $G(PSOQUIT) K PSOQUIT Q
"RTN","PSOORNE2",15,0)
 .S ORN=+$P(PSLST,",",ORD) D @$S(+PSOLST(ORN)=52:"ACT",1:"PEN^PSOORNE5")
"RTN","PSOORNE2",16,0)
 .K PSOREEDT,PSOSIGFL,PSONACT,SIGOK,PSOFDR,DRET,SIG,INS1
"RTN","PSOORNE2",17,0)
 K PRC,PHI,RTE I '$G(PSOOELSE) S VALMBCK=""
"RTN","PSOORNE2",18,0)
 K PSONACT,PSOOELSE,CLOZPAT D ^PSOBUILD,BLD^PSOORUT1,K3^PSOORNE6
"RTN","PSOORNE2",19,0)
 Q
"RTN","PSOORNE2",20,0)
 ;
"RTN","PSOORNE2",21,0)
ACT N REF,RPHKEY,PKIND K ^TMP("PSOAO",$J),PCOMX,PDA,PHI,PRC,ACOM,ANS,PSOFDR,CLOZPAT,ANQREM,DUR,DRET
"RTN","PSOORNE2",22,0)
 S RXN=$P(PSOLST(ORN),"^",2),RX0=^PSRX(RXN,0),RX2=$G(^(2)),RX3=$G(^(3)),ST=+$G(^("STA")),RXOR=$G(^("OR1")),POE=$G(^("POE")),EXDT=$S($P($G(^(2)),"^",6)>DT:1,1:0)
"RTN","PSOORNE2",23,0)
 I 'RX3 S RX3=$P(RX2,"^",2),$P(^PSRX(RXN,3),"^")=$P(RX2,"^",2)
"RTN","PSOORNE2",24,0)
 S PSODRG=+$P(RX0,"^",6),PSODRUG0=^PSDRUG(PSODRG,0),INDT=$G(^("I"))
"RTN","PSOORNE2",25,0)
 ;PSO*7*238;SET PSODRUG ARRAY ; PSOY KILLED AT END OF SET^PSODRG
"RTN","PSOORNE2",26,0)
 K PSODRUG
"RTN","PSOORNE2",27,0)
 S PSOY=PSODRG,PSOY(0)=PSODRUG0 D SET^PSODRG
"RTN","PSOORNE2",28,0)
 I 'RXOR,$P(^PSDRUG(PSODRG,2),"^") S $P(^PSRX(RXN,"OR1"),"^")=$P(^PSDRUG(PSODRG,2),"^"),RXOR=$P(^PSDRUG(PSODRG,2),"^")
"RTN","PSOORNE2",29,0)
 I $P($G(^PSDRUG(PSODRG,"CLOZ1")),"^")="PSOCLO1" D
"RTN","PSOORNE2",30,0)
 .S CLOZPAT=$O(^YSCL(603.01,"C",PSODFN,0)) Q:'CLOZPAT
"RTN","PSOORNE2",31,0)
 .;S CLOZPAT=$S($P(^YSCL(603.01,CLOZPAT,0),"^",3)="B":1,1:0)
"RTN","PSOORNE2",32,0)
 .S CLOZPAT=$P(^YSCL(603.01,CLOZPAT,0),"^",3)
"RTN","PSOORNE2",33,0)
 .S CLOZPAT=$S(CLOZPAT="M":2,CLOZPAT="B":1,1:0)
"RTN","PSOORNE2",34,0)
 S PKIND=$D(^PSRX(RXN,"PKI")),RPHKEY=$S('PKIND&($D(^XUSEC("PSORPH",DUZ))):1,PKIND&($D(^XUSEC("PSDRPH",DUZ))):1,1:0)
"RTN","PSOORNE2",35,0)
 I RPHKEY S RPH=1 D
"RTN","PSOORNE2",36,0)
 .S PSOACT=$S('ST&($G(INDT)]"")&(DT>$G(INDT)):"DHPLATC",ST=1!(ST=4):"DVE",ST=3:"DU",ST=5:"ELTD",ST=11:"ETDPCL",ST=12&EXDT:"EDCL",ST=12&'EXDT:"ECL",(ST=14!(ST=15))&'EXDT:"ECL",ST=13:"L",ST=16:"DL",1:"DHPEATCL")
"RTN","PSOORNE2",37,0)
 .D GET^PSOORNE5 S PSOACT=PSOACT_$S(ACTREN:"N",1:""),PSOACT=PSOACT_$S(ACTREF:"R",1:"")
"RTN","PSOORNE2",38,0)
 .I ST=5 S SURX=$O(^PS(52.5,"B",RXN,0)) I SURX,$P($G(^PS(52.5,SURX,0)),"^",7)="L" S PSOACT="TL" K SURX Q
"RTN","PSOORNE2",39,0)
 .S:ST'=12&('$D(^PS(50.7,+$P(RXOR,"^"),0))) PSOACT="DL",VALMSG="No Pharmacy Orderable Item !",PSONACT=1
"RTN","PSOORNE2",40,0)
 .S:ST=12&('$D(^PS(50.7,+$P(RXOR,"^"),0))) PSOACT="L",VALMSG="No Pharmacy Orderable Item !",PSONACT=1
"RTN","PSOORNE2",41,0)
 .S:ST=16 VALMSG="Rx Placed on HOLD by Provider."
"RTN","PSOORNE2",42,0)
 E  D
"RTN","PSOORNE2",43,0)
 .I ST=5 S SURX=$O(^PS(52.5,"B",RXN,0)) I SURX,$P($G(^PS(52.5,SURX,0)),"^",7)="L" S PSOACT="TL" Q
"RTN","PSOORNE2",44,0)
 .S PSOACT=$S(ST'<1&(ST'>4)!(ST>12):"",ST=12&EXDT&($P($G(PSOPAR),"^",2)):"CDPLT",1:"CPLT")
"RTN","PSOORNE2",45,0)
 .D GET^PSOORNE5 S PSOACT=PSOACT_$S(ACTREN:"N",1:""),PSOACT=PSOACT_$S(ACTREF:"R",1:"")
"RTN","PSOORNE2",46,0)
 .S:'$D(^PS(50.7,+$P(RXOR,"^"),0)) PSOACT="L",PSONACT=1,VALMSG="No Pharmacy Orderable Item !"
"RTN","PSOORNE2",47,0)
 ;K PSOLKFL D PSOL^PSSLOCK(RXN) I '$G(PSOMSG) K PSOMSG S PSOLKFL=1 S PSOACT="",VALMSG="This Order is being edited by another user."
"RTN","PSOORNE2",48,0)
 K PSOMSG S IEN=0,$P(RN," ",12)=" "
"RTN","PSOORNE2",49,0)
 D DIN^PSONFI(+RXOR,$P(RX0,"^",6))
"RTN","PSOORNE2",50,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=$S($P($G(^PSRX(RXN,"TPB")),"^"):"            TPB Rx #: ",1:"                Rx #: ")
"RTN","PSOORNE2",51,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_$P(RX0,"^")_$S($G(^PSRX(RXN,"IB")):"$",1:"")_$$ECME^PSOBPSUT(RXN)_$$TITRX^PSOUTL(RXN)_$E(RN,$L($P(RX0,"^")_$S($G(^PSRX(RXN,"IB")):"$",1:"")_$$ECME^PSOBPSUT(RXN)_$$TITRX^PSOUTL(RXN))+1,12)
"RTN","PSOORNE2",52,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" ("_$S($P(PSOPAR,"^",3):1,1:"#")_")"_" *Orderable Item: "_$S($D(^PS(50.7,$P(+RXOR,"^"),0)):$P(^PS(50.7,$P(+RXOR,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^"),1:"")_NFIO
"RTN","PSOORNE2",53,0)
 S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOAO",$J,IEN,0))-4)
"RTN","PSOORNE2",54,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" ("_$S($P(PSOPAR,"^",3):2,1:"#")_")"_$S($D(^PSDRUG("AQ",$P(RX0,"^",6))):"       CMOP ",1:"            ")_"Drug: "_$P(^PSDRUG($P(RX0,"^",6),0),"^")_NFID
"RTN","PSOORNE2",55,0)
 S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOAO",$J,IEN,0))-4)
"RTN","PSOORNE2",56,0)
 I $$STATUS^PSOBPSUT(RXN,0)'="",$$RXRLDT^PSOBPSUT(RXN,0) D
"RTN","PSOORNE2",57,0)
 . S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" "_$S('$P(PSOPAR,"^",3):"(2)",1:"   ")_"             NDC: "_$$GETNDC^PSONDCUT(RXN,0)
"RTN","PSOORNE2",58,0)
 S:$G(^PSRX(RXN,"TN"))]"" IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="          Trade Name: "_$G(^PSRX(RXN,"TN"))
"RTN","PSOORNE2",59,0)
 D DOSE^PSOORNE5
"RTN","PSOORNE2",60,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" (4)Pat Instructions:" D INS^PSOORNE5
"RTN","PSOORNE2",61,0)
 D PC^PSOORNE5
"RTN","PSOORNE2",62,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                 SIG:"
"RTN","PSOORNE2",63,0)
 I '$P($G(^PSRX(RXN,"SIG")),"^",2) S SIGOK=0 D  G PTST
"RTN","PSOORNE2",64,0)
 .S X=$P($G(^PSRX(RXN,"SIG")),"^") D SIGONE^PSOHELP S SIG=$E($G(INS1),2,250)
"RTN","PSOORNE2",65,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOAO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOAO",$J,IEN,0)," ",21)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOAO",$J,IEN,0)=$G(^TMP("PSOAO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNE2",66,0)
 S SIGOK=1
"RTN","PSOORNE2",67,0)
 F I=0:0 S I=$O(^PSRX(RXN,"SIG1",I)) Q:'I  D                  ;PSO*210
"RTN","PSOORNE2",68,0)
 . S MIG=$P(^PSRX(RXN,"SIG1",I,0),"^")
"RTN","PSOORNE2",69,0)
 . D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAO",$J)),21)
"RTN","PSOORNE2",70,0)
 S SIGOK=1 K MIG,SG
"RTN","PSOORNE2",71,0)
PTST S $P(RN," ",25)=" ",PTST=$S($G(^PS(53,+$P(RX0,"^",3),0))]"":$P($G(^PS(53,+$P(RX0,"^",3),0)),"^"),1:""),IEN=IEN+1
"RTN","PSOORNE2",72,0)
 S ^TMP("PSOAO",$J,IEN,0)=" (5)  Patient Status: "_PTST_$E(RN,$L(PTST)+1,25)
"RTN","PSOORNE2",73,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" (6)      Issue Date: "_$E($P(RX0,"^",13),4,5)_"/"_$E($P(RX0,"^",13),6,7)_"/"_$E($P(RX0,"^",13),2,3)
"RTN","PSOORNE2",74,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"               (7)  Fill Date: "_$E($P(RX2,"^",2),4,5)_"/"_$E($P(RX2,"^",2),6,7)_"/"_$E($P(RX2,"^",2),2,3)
"RTN","PSOORNE2",75,0)
 S ROU=$S($P(RX0,"^",11)="W":"Window",1:"Mail")
"RTN","PSOORNE2",76,0)
 S REFL=$P(RX0,"^",9),I=0 F  S I=$O(^PSRX(RXN,1,I)) Q:'I  S REFL=REFL-1,ROU=$S($P(^PSRX(RXN,1,I,0),"^",2)="W":"Window",1:"Mail")
"RTN","PSOORNE2",77,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="      Last Fill Date: "_$E($P(RX3,"^"),4,5)_"/"_$E($P(RX3,"^"),6,7)_"/"_$E($P(RX3,"^"),2,3)
"RTN","PSOORNE2",78,0)
 D CMOP^PSOORNE3
"RTN","PSOORNE2",79,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_" ("_ROU_$S($G(PSOCMOP)]"":", "_PSOCMOP,1:"")_")" K ROU,PSOCMOP
"RTN","PSOORNE2",80,0)
 ;*282 Correct return to stock/release display
"RTN","PSOORNE2",81,0)
 S IEN=IEN+1 D
"RTN","PSOORNE2",82,0)
 .S RLD=$S($P(RX2,"^",13):$E($P(RX2,"^",13),4,5)_"/"_$E($P(RX2,"^",13),6,7)_"/"_$E($P(RX2,"^",13),2,3),1:"")
"RTN","PSOORNE2",83,0)
 .I $O(^PSRX(RXN,1,0)) F I=0:0 S I=$O(^PSRX(RXN,1,I)) Q:'I  D
"RTN","PSOORNE2",84,0)
 ..I $P(^PSRX(RXN,1,I,0),"^",18) S RLD=$E($P(^(0),"^",18),4,5)_"/"_$E($P(^(0),"^",18),6,7)_"/"_$E($P(^(0),"^",18),2,3)
"RTN","PSOORNE2",85,0)
 .I $P(RX2,"^",15)&'$G(RLD) S ^TMP("PSOAO",$J,IEN,0)="   Returned to Stock: "_$E($P(RX2,"^",15),4,5)_"/"_$E($P(RX2,"^",15),6,7)_"/"_$E($P(RX2,"^",15),2,3)_$S($P(RX2,"^",14):" (Reprinted)",1:"")
"RTN","PSOORNE2",86,0)
 .E  S ^TMP("PSOAO",$J,IEN,0)="   Last Release Date: "_$S($G(RLD)]"":RLD,1:"        ")
"RTN","PSOORNE2",87,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"               (8)      Lot #: "_$P($G(RX2),"^",4)
"RTN","PSOORNE2",88,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="             Expires: "_$E($P(RX2,"^",6),4,5)_"/"_$E($P(RX2,"^",6),6,7)_"/"_$E($P(RX2,"^",6),2,3)
"RTN","PSOORNE2",89,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"                          MFG: "_$P($G(RX2),"^",8)
"RTN","PSOORNE2",90,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(9)      Days Supply: "_$P(RX0,"^",8)_$S($L($P(RX0,"^",8))=1:" ",1:"")
"RTN","PSOORNE2",91,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"                    (10)  QTY"_$S($P($G(^PSDRUG($P(RX0,"^",6),660)),"^",8)]"":" ("_$P($G(^PSDRUG($P(RX0,"^",6),660)),"^",8)_")",1:" (  )")_": "_$P(RX0,"^",7)
"RTN","PSOORNE2",92,0)
 I $P($G(^PSDRUG($P(RX0,"^",6),5)),"^")]"" D
"RTN","PSOORNE2",93,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNE2",94,0)
 .S ^TMP("PSOAO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG($P(RX0,"^",6),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG($P(RX0,"^",6),5),"^") K RN
"RTN","PSOORNE2",95,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(11)    # of Refills: "_$P(RX0,"^",9)_$S($L($P(RX0,"^",9))=1:" ",1:"")_"                          Remaining: "_REFL
"RTN","PSOORNE2",96,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(12)        Provider: "_$S($D(^VA(200,$P(RX0,"^",4),0)):$P(^VA(200,$P(RX0,"^",4),0),"^"),1:"UNKNOWN")
"RTN","PSOORNE2",97,0)
 I +$P($G(^PSDRUG($P(RX0,"^",6),0)),"^",3)>1,+$P($G(^PSDRUG($P(RX0,"^",6),0)),"^",3)<6 D PRV^PSOORNE5
"RTN","PSOORNE2",98,0)
 I $P(RX3,"^",3) S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="        Cos-Provider: "_$P(^VA(200,$S($G(PSORX("COSIGNING PROVIDER")):PSORX("COSIGNING PROVIDER"),1:$P(RX3,"^",3)),0),"^")
"RTN","PSOORNE2",99,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(13)         Routing: "_$S($P(RX0,"^",11)="M":"MAIL",1:"WINDOW")_"                  (14)     Copies: "_$S($P(RX0,"^",18):$P(RX0,"^",18),1:1)
"RTN","PSOORNE2",100,0)
 S:$P(RX0,"^",11)="W"&($P(PSOPAR,"^",12)) IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="    Method of Pickup: "_$G(^PSRX(RXN,"MP"))
"RTN","PSOORNE2",101,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(15)          Clinic: "_$S($D(^SC(+$P(RX0,"^",5),0)):$P(^SC($P(RX0,"^",5),0),"^"),1:"Not on File")
"RTN","PSOORNE2",102,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(16)        Division: "_$S($G(^PS(59,+$P(RX2,"^",9),0))]"":$P(^PS(59,$P(RX2,"^",9),0),"^")_" ("_$P(^(0),"^",6)_")",1:"UNKNOWN")
"RTN","PSOORNE2",103,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(17)      Pharmacist: "_$S($P(RX2,"^",3):$P(^VA(200,$P(RX2,"^",3),0),"^"),1:"")
"RTN","PSOORNE2",104,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(18)         Remarks:" D RMK^PSOORNE3
"RTN","PSOORNE2",105,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(19)      Counseling: "_$S($P($G(^PSRX(RXN,"PC")),"^"):"YES",1:"NO")_"                      "_$S($P($G(^PSRX(RXN,"PC")),"^"):"Was Counseling Understood: "_$S($P($G(^PSRX(RXN,"PC")),"^",2):"YES",1:"NO"),1:"")
"RTN","PSOORNE2",106,0)
 S:$O(^PSRX(RXN,1,0)) REF=1,IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(20)     Refill Data"
"RTN","PSOORNE2",107,0)
 I $$STATUS^PSOBPSUT(RXN,0)'="" D
"RTN","PSOORNE2",108,0)
 . N DAW S IEN=IEN+1,DAW=$$GETDAW^PSODAWUT(RXN,0)
"RTN","PSOORNE2",109,0)
 . S ^TMP("PSOAO",$J,IEN,0)="(21)        DAW Code: "_DAW_" - "_$$DAWEXT^PSSDAWUT(DAW)
"RTN","PSOORNE2",110,0)
 D DISP^PSOORNE6
"RTN","PSOORNE2",111,0)
 I $G(PSOBEDT),PSOACT["E" S PSOACT="E"
"RTN","PSOORNE2",112,0)
 I $G(PSOBEDT),PSOACT'["E" S PSOACT=""
"RTN","PSOORNE2",113,0)
 Q:$G(PSORXED)!($G(COPY))!($G(UPMI))
"RTN","PSOORNE2",114,0)
 S:$G(PSOBEDT) (PSOEDIT,PSORXED)=1
"RTN","PSOORNE2",115,0)
RENERR S PSORERR=0 D ^PSOLMLST
"RTN","PSOORNE2",116,0)
 I PSORERR=1 S:$G(PSOBEDT) (PSOEDIT,PSORXED)=1 G RENERR
"RTN","PSOORNE2",117,0)
 K DRET,SIG
"RTN","PSOORNE2",118,0)
 Q
"RTN","PSOORNE2",119,0)
UL1 ;
"RTN","PSOORNE2",120,0)
 Q
"RTN","PSOQUTIL")
0^12^B2614810
"RTN","PSOQUTIL",1,0)
PSOQUTIL ;HINES/RMS - MISCELLANEOUS UTILITIES ; 30 Nov 2007  7:59 AM
"RTN","PSOQUTIL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**294,282**;DEC 1997;Build 18
"RTN","PSOQUTIL",3,0)
 ;
"RTN","PSOQUTIL",4,0)
LSIG(SIG) ;EXPAND A SIG
"RTN","PSOQUTIL",5,0)
 S SGY="" F P=1:1:$L(SIG," ") S X=$P(SIG," ",P) D:X]""  ;
"RTN","PSOQUTIL",6,0)
 .;PSO*7*282 Intended Use Check
"RTN","PSOQUTIL",7,0)
 .N PSOIN S PSOIN=$O(^PS(51,"B",X,0)) I PSOIN,($P(^PS(51,PSOIN,0),"^",4)<2)&($D(^PS(51,"A",X))) S %=^(X),X=$P(%,"^") I $P(%,"^",2)]"" S Y=$P(SIG,"",P-1),Y=$E(Y,$L(Y)) S:Y>1 X=$P(%,"^",2)
"RTN","PSOQUTIL",8,0)
 .S SGY=SGY_X_" "
"RTN","PSOQUTIL",9,0)
 Q SGY
"RTN","PSOQUTIL",10,0)
WRAPTEXT(TEXT,LIMIT,CSPACES) ;
"RTN","PSOQUTIL",11,0)
 ;;FUNCTION TO DISPLAY (WRITE) TEXT WRAPPED TO A CERTAIN COLUMN LENGTH
"RTN","PSOQUTIL",12,0)
 ;;DEFAULT=74 CHARACTERS WITH NO SPACES IN FRONT
"RTN","PSOQUTIL",13,0)
 N WORDS,COUNT,LINE,NEXTWORD
"RTN","PSOQUTIL",14,0)
 Q:$G(TEXT)']"" ""
"RTN","PSOQUTIL",15,0)
 S LIMIT=$G(LIMIT,74)
"RTN","PSOQUTIL",16,0)
 S CSPACES=$S($G(CSPACES):CSPACES,1:0)
"RTN","PSOQUTIL",17,0)
 S WORDS=$L(TEXT," ")
"RTN","PSOQUTIL",18,0)
 W !,$$REPEAT^XLFSTR(" ",CSPACES)
"RTN","PSOQUTIL",19,0)
 F COUNT=1:1:WORDS D
"RTN","PSOQUTIL",20,0)
 . S NEXTWORD=$P(TEXT," ",COUNT)
"RTN","PSOQUTIL",21,0)
 . Q:NEXTWORD=""  ;TO REMOVE LEADING OR DOUBLE SPACES
"RTN","PSOQUTIL",22,0)
 . S LINE=$G(LINE)_NEXTWORD_" "
"RTN","PSOQUTIL",23,0)
 . I $L($G(LINE))>LIMIT&(COUNT'=WORDS) W !,$$REPEAT^XLFSTR(" ",CSPACES) K LINE
"RTN","PSOQUTIL",24,0)
 . W NEXTWORD_" "
"RTN","PSOQUTIL",25,0)
 Q 
"RTN","PSOSIG")
0^13^B65537760
"RTN","PSOSIG",1,0)
PSOSIG ;BIR/RTR-Utility to create SIG ;6/04/00
"RTN","PSOSIG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,99,114,391,313,282**;DEC 1997;Build 18
"RTN","PSOSIG",3,0)
 ;External reference to PS(51 supported by DBIA 2224
"RTN","PSOSIG",4,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOSIG",5,0)
 ;External reference to PSDRUG( supported by DBIA 221
"RTN","PSOSIG",6,0)
 ;
"RTN","PSOSIG",7,0)
EN(PSOSIGX) ;
"RTN","PSOSIG",8,0)
 N VARIABLE
"RTN","PSOSIG",9,0)
 Q
"RTN","PSOSIG",10,0)
SCH ;*282 Preserve old functionality
"RTN","PSOSIG",11,0)
 S SCHEX=$$SCHE(SCH)
"RTN","PSOSIG",12,0)
 Q
"RTN","PSOSIG",13,0)
 ;
"RTN","PSOSIG",14,0)
 ;SCHE is the new schedule expander
"RTN","PSOSIG",15,0)
SCHE(SCH) ;
"RTN","PSOSIG",16,0)
 ;SCH = Schedule entered
"RTN","PSOSIG",17,0)
 ;Returns Expanded Schedule, or ""
"RTN","PSOSIG",18,0)
 N SCHEX,SPCT
"RTN","PSOSIG",19,0)
 I SCH[""""!($A(SCH)=45)!(SCH?.E1C.E)!($L(SCH," ")>$S(SCH["PRN":4,1:3))!($L(SCH)>20)!($L(SCH)<1) K SCH Q ""
"RTN","PSOSIG",20,0)
 S SCH=$$UPPER(SCH)
"RTN","PSOSIG",21,0)
 S SPCT=0 F I=1:1:$L(SCH) I $E(SCH,I)=" " S SPCT=SPCT+1
"RTN","PSOSIG",22,0)
 S SCHEX=$$EXP(SCH) I SCHEX]"" Q SCHEX
"RTN","PSOSIG",23,0)
 Q:SPCT=0 SCH
"RTN","PSOSIG",24,0)
 Q $$SCHE($P(SCH," ",1,SPCT))_" "_$$SCHE($P(SCH," ",SPCT+1))
"RTN","PSOSIG",25,0)
EXP(X) ; expand based on 51.1 and 51
"RTN","PSOSIG",26,0)
 N PSIN,SCFLG,SCHEX
"RTN","PSOSIG",27,0)
 S PSIN=0 F  S PSIN=$O(^PS(51.1,"APPSJ",X,PSIN)) Q:'PSIN!$G(SCFLG)  I $P(^PS(51.1,PSIN,0),"^",8)'="" S SCHEX=$P($G(^(0)),"^",8),SCFLG=1
"RTN","PSOSIG",28,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",29,0)
 S PSIN=0 F  S PSIN=$O(^PS(51,"B",X,PSIN)) Q:'PSIN!$G(SCLFL)  I PSIN,($P(^PS(51,PSIN,0),"^",4)<2)&($P($G(^PS(51,"A",X)),"^")'="") S SCHEX=$P(^(X),"^"),SCFLG=1
"RTN","PSOSIG",30,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",31,0)
 Q ""
"RTN","PSOSIG",32,0)
 ;
"RTN","PSOSIG",33,0)
QTY(PSOQX) ;
"RTN","PSOSIG",34,0)
 N QDOSE
"RTN","PSOSIG",35,0)
 K PSOQX("QTY")
"RTN","PSOSIG",36,0)
 I $G(PSOFDR),'$G(CPRN) N PSOQTYQT,PSOLPSD S PSOQTYQT=0 D  I $G(PSOQTYQT) Q
"RTN","PSOSIG",37,0)
 .S PSOLPSD="" F  S PSOLPSD=$O(PSONEW("SCHEDULE",PSOLPSD)) Q:PSOLPSD=""!(PSOQTYQT)  I $G(PSONEW("SCHEDULE",PSOLPSD))["PRN"!($G(PSONEW("SCHEDULE",PSOLPSD))["prn")!($G(PSONEW("SCHEDULE",PSOLPSD))["Prn") S PSOQTYQT=1 Q
"RTN","PSOSIG",38,0)
 N PSOOUTQT S PSOOUTQT=1
"RTN","PSOSIG",39,0)
QTYCP ;CPRS qty call comes through here
"RTN","PSOSIG",40,0)
 N PSQQUIT,QTSH,PSQ,PSQMIN,PSQMINZ,PSOQRND,PSOLOWER,PSOLOWX,PSOLOWXL,PSOLOWST
"RTN","PSOSIG",41,0)
 K PSOFRQ S PSQQUIT=0
"RTN","PSOSIG",42,0)
 I '$G(PSOCPRQT) S QDOSE=0 F PSQ=0:0 S PSQ=$O(PSOQX("DOSE",PSQ)) Q:'PSQ  S QDOSE=PSQ S:'$G(PSOQX("DOSE ORDERED",PSQ)) PSQQUIT=1
"RTN","PSOSIG",43,0)
 ;Q:PSQQUIT!('QDOSE)
"RTN","PSOSIG",44,0)
 I '$G(PSOCPRQT) Q:PSQQUIT
"RTN","PSOSIG",45,0)
 Q:'$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",46,0)
 Q:'$G(QDOSE)
"RTN","PSOSIG",47,0)
 G:QDOSE>1 COMP
"RTN","PSOSIG",48,0)
 Q:'$G(PSOQX("DOSE ORDERED",1))
"RTN","PSOSIG",49,0)
 Q:'$G(PSOQX("DAYS SUPPLY"))&('$G(PSOQX("DURATION",1)))
"RTN","PSOSIG",50,0)
 S PSOLOWER=0
"RTN","PSOSIG",51,0)
 I $G(PSOQX("DURATION",1)) D
"RTN","PSOSIG",52,0)
 .S PSOLOWX=$L(PSOQX("DURATION",1))
"RTN","PSOSIG",53,0)
 .S PSOLOWXL=$S($E(PSOQX("DURATION",1),PSOLOWX)="M":1,$E(PSOQX("DURATION",1),PSOLOWX)="H":60,$E(PSOQX("DURATION",1),PSOLOWX)="S":.01666,$E(PSOQX("DURATION",1),PSOLOWX)="W":10080,$E(PSOQX("DURATION",1),PSOLOWX)="L":43200,1:1440)
"RTN","PSOSIG",54,0)
 .S PSOLOWER=PSOLOWXL*(+$G(PSOQX("DURATION",1)))
"RTN","PSOSIG",55,0)
 S PSOLOWX=0 I +$G(PSOQX("DAYS SUPPLY")) S PSOLOWX=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",56,0)
 Q:'$G(PSOLOWER)&('$G(PSOLOWX))
"RTN","PSOSIG",57,0)
 S QTSH=$G(PSOQX("SCHEDULE",1)) D QTS Q:PSQQUIT!('$G(PSOFRQ))
"RTN","PSOSIG",58,0)
 S PSOLOWST=$S('$G(PSOLOWER):$G(PSOLOWX),'$G(PSOLOWX):$G(PSOLOWER),$G(PSOLOWER)>$G(PSOLOWX):$G(PSOLOWX),$G(PSOLOWX)>$G(PSOLOWER):$G(PSOLOWER),$G(PSOLOWX)=$G(PSOLOWER):$G(PSOLOWER),1:0)
"RTN","PSOSIG",59,0)
 Q:'$G(PSOLOWST)
"RTN","PSOSIG",60,0)
 S PSQMIN=+$G(PSOLOWST)
"RTN","PSOSIG",61,0)
 S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIG",62,0)
 S PSOQRND=PSQMINZ*+$G(PSOQX("DOSE ORDERED",1)) Q:'PSOQRND
"RTN","PSOSIG",63,0)
 D ROUND G QEND
"RTN","PSOSIG",64,0)
 Q
"RTN","PSOSIG",65,0)
COMP ;COMPLEX DOSE HERE
"RTN","PSOSIG",66,0)
 N PSOQEXC,PSOQAND,PSOQTHEN,PSQL,PSQMNL,PSQMNLX,PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSQ1,PSODUX,PSODUXX,PSODSMIN
"RTN","PSOSIG",67,0)
 ;PSODUTOT = TOTAL OF ALL DURATIONS
"RTN","PSOSIG",68,0)
 ;PSODUDIF = DIFF. OF DURATION VS DAYS SUPPLY
"RTN","PSOSIG",69,0)
 ;PSODUMIS = # OF SEQUENCES MISSING A DURATION IF >1 CAN'T DEFAULT
"RTN","PSOSIG",70,0)
 ;PSODUREP = SEQUENCE # THAT IS MISSING DURATION
"RTN","PSOSIG",71,0)
 ;PSODSMIN = MINUTES OF DAYS SUPPLY
"RTN","PSOSIG",72,0)
 S (PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSODSMIN,PSOQAND,PSOQTHEN,PSOQEXC)=0
"RTN","PSOSIG",73,0)
 F PSQL=1:1:QDOSE S:$G(PSOQX("CONJUNCTION",PSQL))["A" PSOQAND=1 S:$G(PSOQX("CONJUNCTION",PSQL))["T" PSOQTHEN=1 S:$G(PSOQX("CONJUNCTION",PSQL))["X" PSOQEXC=1
"RTN","PSOSIG",74,0)
 I $G(PSOQEXC) G QEND
"RTN","PSOSIG",75,0)
 I $G(PSOQAND) G COMP^PSOSIGCX
"RTN","PSOSIG",76,0)
 F PSQ1=1:1:QDOSE D  Q:PSODUMIS>1
"RTN","PSOSIG",77,0)
 .I '$G(PSOQX("DURATION",PSQ1)) S PSODUMIS=PSODUMIS+1,PSODUREP=PSQ1 Q
"RTN","PSOSIG",78,0)
 .S PSODUX=$L(PSOQX("DURATION",PSQ1))
"RTN","PSOSIG",79,0)
 .S PSODUXX=$S($E(PSOQX("DURATION",PSQ1),PSODUX)="M":1,$E(PSOQX("DURATION",PSQ1),PSODUX)="H":60,$E(PSOQX("DURATION",PSQ1),PSODUX)="S":.01666,$E(PSOQX("DURATION",PSQ1),PSODUX)="W":10080,$E(PSOQX("DURATION",PSQ1),PSODUX)="L":43200,1:1440)
"RTN","PSOSIG",80,0)
 .S PSODUTOT=PSODUTOT+(PSODUXX*(+$G(PSOQX("DURATION",PSQ1))))
"RTN","PSOSIG",81,0)
 G:PSODUMIS>1 QEND ; More than 1 sequence missing a duration
"RTN","PSOSIG",82,0)
 I $G(PSODUMIS),'$G(PSOQX("DAYS SUPPLY")) G QEND ; missing 1 duration, no days supply
"RTN","PSOSIG",83,0)
 S PSODSMIN=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",84,0)
 I $G(PSODSMIN),$G(PSODSMIN)<$G(PSODUTOT) G QEND
"RTN","PSOSIG",85,0)
 I '$G(PSODUMIS),$G(PSODSMIN),$G(PSODUTOT)>$G(PSODSMIN) G QEND ; no missing durations, but total durations are greater than days supply
"RTN","PSOSIG",86,0)
 I $G(PSODUMIS),$G(PSODSMIN),$G(PSODSMIN)'>$G(PSODUTOT) G QEND ; 1 missing duration, and total of other durations are not less than days supply
"RTN","PSOSIG",87,0)
 I '$G(PSODSMIN),$G(PSODUMIS) G QEND ; no days supply, missing a duration
"RTN","PSOSIG",88,0)
 I $G(PSODUREP) S PSODUDIF=$G(PSODSMIN)-$G(PSODUTOT)
"RTN","PSOSIG",89,0)
 F PSQ=1:1:QDOSE D  Q:$G(PSQQUIT)
"RTN","PSOSIG",90,0)
 .I '$G(PSOQX("DOSE ORDERED",PSQ))!($G(PSOQX("SCHEDULE",PSQ))="") S PSQQUIT=1 Q
"RTN","PSOSIG",91,0)
 .S QTSH=$G(PSOQX("SCHEDULE",PSQ)) D QTS S:'$G(PSOFRQ) PSQQUIT=1 Q:$G(PSQQUIT)
"RTN","PSOSIG",92,0)
 .I $G(PSOQX("DURATION",PSQ)) S PSQMNL=$L(PSOQX("DURATION",PSQ)) D
"RTN","PSOSIG",93,0)
 ..S PSQMNLX=$S($E(PSOQX("DURATION",PSQ),PSQMNL)="M":1,$E(PSOQX("DURATION",PSQ),PSQMNL)="H":60,$E(PSOQX("DURATION",PSQ),PSQMNL)="S":.01666,$E(PSOQX("DURATION",PSQ),PSQMNL)="W":10080,$E(PSOQX("DURATION",PSQ),PSQMNL)="L":43200,1:1440)
"RTN","PSOSIG",94,0)
 ..S PSQMIN=PSQMNLX*(+$G(PSOQX("DURATION",PSQ)))
"RTN","PSOSIG",95,0)
 .I '$G(PSOQX("DURATION",PSQ)) S PSQMIN=$G(PSODUDIF)
"RTN","PSOSIG",96,0)
 .S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIG",97,0)
 .S PSOQRND=$S('$G(PSOQRND):PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ)),1:$G(PSOQRND)+(PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ))))
"RTN","PSOSIG",98,0)
 I $G(PSQQUIT) G QEND
"RTN","PSOSIG",99,0)
 I $G(PSOQRND) D ROUND
"RTN","PSOSIG",100,0)
 G QEND
"RTN","PSOSIG",101,0)
QTS ;*282 Preserve Old Functionality
"RTN","PSOSIG",102,0)
 S PSOFRQ=$$QTSCH(QTSH)
"RTN","PSOSIG",103,0)
 I '$G(PSOFRQ) S PSQQUIT=1
"RTN","PSOSIG",104,0)
 Q
"RTN","PSOSIG",105,0)
 ;
"RTN","PSOSIG",106,0)
QTSCH(QTSH) ; 
"RTN","PSOSIG",107,0)
 ; Return Frequency for Schedule QTSH
"RTN","PSOSIG",108,0)
 ; Otherwise return ""
"RTN","PSOSIG",109,0)
 N PSOFRQ,SPCT,FOUND
"RTN","PSOSIG",110,0)
 Q:$G(QTSH)="" ""
"RTN","PSOSIG",111,0)
 Q:$E(QTSH,1)=" " ""
"RTN","PSOSIG",112,0)
 S SPCT=1,PSOFRQ=0 F I=1:1:$L(QTSH) I $E(QTSH,I)=" " S SPCT=SPCT+1
"RTN","PSOSIG",113,0)
 F I=0:1:SPCT-1 S SCHTMP=$P(QTSH," ",1,SPCT-I) Q:PSOFRQ  D
"RTN","PSOSIG",114,0)
 . F II=0:0 S II=$O(^PS(51.1,"APPSJ",SCHTMP,II)) Q:'II!PSOFRQ  S PSOFRQ=$P(^PS(51.1,II,0),"^",3)
"RTN","PSOSIG",115,0)
 Q:PSOFRQ PSOFRQ
"RTN","PSOSIG",116,0)
  F I=0:1:SPCT-1 S SCHTMP=$P(QTSH," ",1,SPCT-I) Q:PSOFRQ  D
"RTN","PSOSIG",117,0)
 . F II=0:0 S II=$O(^PS(51,"B",SCHTMP,II)) Q:'II!PSOFRQ  I $P(^PS(51,II,0),"^",4)<2 S PSOFRQ=$P(^PS(51,II,0),"^",8)
"RTN","PSOSIG",118,0)
 Q:PSOFRQ PSOFRQ
"RTN","PSOSIG",119,0)
 Q ""
"RTN","PSOSIG",120,0)
 ;
"RTN","PSOSIG",121,0)
QEND ;
"RTN","PSOSIG",122,0)
 ; PSOMTFLG variable indicates a Maintenance Rx (Titration/Maintenance)
"RTN","PSOSIG",123,0)
 K PSOFRQ
"RTN","PSOSIG",124,0)
 I $G(PSOOUTQT),$G(QTYHLD),$G(PSOQX("QTY")),$G(QTYHLD)'=$G(PSOQX("QTY")) W !!!,"Quantity has been changed from "_QTYHLD_" to "_PSOQX("QTY") D  I '$G(PSOMTFLG) W ! N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOSIG",125,0)
 .I $G(PSONEW("FLD"))=8,$P($G(OR0),"^",24),$G(PSODRUG("IEN")),$D(^PSDRUG(+$G(PSODRUG("IEN")),0)) D
"RTN","PSOSIG",126,0)
 ..I $P(^PSDRUG(PSODRUG("IEN"),0),"^",3)[2!($P(^PSDRUG(PSODRUG("IEN"),0),"^",3)["F") Q
"RTN","PSOSIG",127,0)
 ..N ZRFA S ZRFA=$S($G(CLOZPAT)=2&(PSOQX("DAYS SUPPLY")=14):1,$G(CLOZPAT)=2&(PSOQX("DAYS SUPPLY")=7):3,$G(CLOZPAT)=1&(PSOQX("DAYS SUPPLY")=7):1,$D(CLOZPAT):0,1:5)
"RTN","PSOSIG",128,0)
 ..N ZREF,ZTQ S ZREF=QTYHLD\PSOQX("QTY") I ZREF>0 D
"RTN","PSOSIG",129,0)
 ...S ZTQ=QTYHLD*(PSOQX("# OF REFILLS")+1),ZTQ=ZTQ-PSOQX("QTY"),ZREF=ZTQ\PSOQX("QTY") S:ZREF>ZRFA ZREF=ZRFA
"RTN","PSOSIG",130,0)
 ...I ZREF'=PSOQX("# OF REFILLS") W !,"# of Refills has been changed from "_PSOQX("# OF REFILLS")_" to "_ZREF S PSOQX("# OF REFILLS")=ZREF
"RTN","PSOSIG",131,0)
 Q
"RTN","PSOSIG",132,0)
ROUND ;
"RTN","PSOSIG",133,0)
 Q:'$G(PSOQRND)
"RTN","PSOSIG",134,0)
 I PSOQRND'["." S PSOQX("QTY")=PSOQRND Q
"RTN","PSOSIG",135,0)
 S PSOQX("QTY")=$P(PSOQRND,".")+1
"RTN","PSOSIG",136,0)
 Q
"RTN","PSOSIG",137,0)
DAY(DATE) ;First 5 digits of FileMan date
"RTN","PSOSIG",138,0)
 N X
"RTN","PSOSIG",139,0)
 I DATE'?5N Q -1
"RTN","PSOSIG",140,0)
 S X=$E(DATE,4,5) I X<1!(X>12) Q -1
"RTN","PSOSIG",141,0)
 S X=DATE+1+(X=12*88)_"01"
"RTN","PSOSIG",142,0)
 Q $E($$FMADD^XLFDT(X,-1),6,7)
"RTN","PSOSIG",143,0)
 ;
"RTN","PSOSIG",144,0)
QTYX(PSOQX) ;
"RTN","PSOSIG",145,0)
 N PSOQLP,PSOQLN,PSOQAR,PSOCPRQT,QDOSE,QDOSEX S PSOCPRQT=1 F PSOQLP=0:0 S PSOQLP=$O(PSOQX("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIG",146,0)
 .S PSOQAR("DURATION",PSOQLP)=$G(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIG",147,0)
 .I $E(PSOQX("DURATION",PSOQLP))?1A S PSOQLN=$L(PSOQX("DURATION",PSOQLP)) S PSOQX("DURATION",PSOQLP)=$E(PSOQX("DURATION",PSOQLP),2,PSOQLN)_$E(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIG",148,0)
 S QDOSE=0 F QDOSEX=0:0 S QDOSEX=$O(PSOQX("DOSE ORDERED",QDOSEX)) Q:'QDOSEX  S QDOSE=QDOSE+1
"RTN","PSOSIG",149,0)
 I '$G(PSOQX("QTY")) D QTYCP G QPASS
"RTN","PSOSIG",150,0)
 D QTYCP^PSOSIGDS
"RTN","PSOSIG",151,0)
QPASS F PSOQLP=0:0 S PSOQLP=$O(PSOQAR("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIG",152,0)
 .S PSOQX("DURATION",PSOQLP)=$G(PSOQAR("DURATION",PSOQLP))
"RTN","PSOSIG",153,0)
 K PSOCPRQT
"RTN","PSOSIG",154,0)
 Q
"RTN","PSOSIG",155,0)
DAYS(PSOQX) ;Entry point for Days Supply calc for PSO
"RTN","PSOSIG",156,0)
 ;Kill days supply here
"RTN","PSOSIG",157,0)
 Q:'$G(PSOQX("QTY"))
"RTN","PSOSIG",158,0)
 D QTYOPS^PSOSIGDS
"RTN","PSOSIG",159,0)
 Q
"RTN","PSOSIG",160,0)
 ;
"RTN","PSOSIG",161,0)
UPPER(PSOSCUP) ;
"RTN","PSOSIG",162,0)
 Q $TR(PSOSCUP,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSOSIGCX")
0^14^B33594823
"RTN","PSOSIGCX",1,0)
PSOSIGCX ;BIR/RTR-Utility to calculate quantity ; 3/23/11 8:24am
"RTN","PSOSIGCX",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,282**;DEC 1997;Build 18
"RTN","PSOSIGCX",3,0)
 ;External reference to PS(51 supported by DBIA 2224
"RTN","PSOSIGCX",4,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOSIGCX",5,0)
 ;
"RTN","PSOSIGCX",6,0)
EN(PSOSIGX) ;
"RTN","PSOSIGCX",7,0)
 N VARIABLE
"RTN","PSOSIGCX",8,0)
 Q
"RTN","PSOSIGCX",9,0)
SCH ;*282 Centralized
"RTN","PSOSIGCX",10,0)
 D SCH^PSOSIG
"RTN","PSOSIGCX",11,0)
 Q
"RTN","PSOSIGCX",12,0)
QTY(PSOQX) ;
"RTN","PSOSIGCX",13,0)
 N QDOSE
"RTN","PSOSIGCX",14,0)
QTYCP ;CPRS qty call comes through here
"RTN","PSOSIGCX",15,0)
 N PSQQUIT,QTSH,PSQ,PSQMIN,PSQMINZ,PSOQRND,PSOLOWER,PSOLOWX,PSOLOWXL,PSOLOWST
"RTN","PSOSIGCX",16,0)
 K PSOFRQ S PSQQUIT=0
"RTN","PSOSIGCX",17,0)
 I '$G(PSOCPRQT) S QDOSE=0 F PSQ=0:0 S PSQ=$O(PSOQX("DOSE",PSQ)) Q:'PSQ  S QDOSE=PSQ S:'$G(PSOQX("DOSE ORDERED",PSQ)) PSQQUIT=1
"RTN","PSOSIGCX",18,0)
 ;Q:PSQQUIT!('QDOSE)
"RTN","PSOSIGCX",19,0)
 I '$G(PSOCPRQT) Q:PSQQUIT
"RTN","PSOSIGCX",20,0)
 Q:'$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIGCX",21,0)
 Q:'$G(QDOSE)
"RTN","PSOSIGCX",22,0)
 G:QDOSE>1 COMP
"RTN","PSOSIGCX",23,0)
 Q:'$G(PSOQX("DOSE ORDERED",1))
"RTN","PSOSIGCX",24,0)
 Q:'$G(PSOQX("DAYS SUPPLY"))&('$G(PSOQX("DURATION",1)))
"RTN","PSOSIGCX",25,0)
 S PSOLOWER=0
"RTN","PSOSIGCX",26,0)
 I $G(PSOQX("DURATION",1)) D
"RTN","PSOSIGCX",27,0)
 .S PSOLOWX=$L(PSOQX("DURATION",1))
"RTN","PSOSIGCX",28,0)
 .S PSOLOWXL=$S($E(PSOQX("DURATION",1),PSOLOWX)="M":1,$E(PSOQX("DURATION",1),PSOLOWX)="H":60,$E(PSOQX("DURATION",1),PSOLOWX)="S":.01666,$E(PSOQX("DURATION",1),PSOLOWX)="W":10080,$E(PSOQX("DURATION",1),PSOLOWX)="L":43200,1:1440)
"RTN","PSOSIGCX",29,0)
 .S PSOLOWER=PSOLOWXL*(+$G(PSOQX("DURATION",1)))
"RTN","PSOSIGCX",30,0)
 S PSOLOWX=0 I +$G(PSOQX("DAYS SUPPLY")) S PSOLOWX=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIGCX",31,0)
 Q:'$G(PSOLOWER)&('$G(PSOLOWX))
"RTN","PSOSIGCX",32,0)
 S QTSH=$G(PSOQX("SCHEDULE",1)) D QTS Q:PSQQUIT!('$G(PSOFRQ))
"RTN","PSOSIGCX",33,0)
 S PSOLOWST=$S('$G(PSOLOWER):$G(PSOLOWX),'$G(PSOLOWX):$G(PSOLOWER),$G(PSOLOWER)>$G(PSOLOWX):$G(PSOLOWX),$G(PSOLOWX)>$G(PSOLOWER):$G(PSOLOWER),$G(PSOLOWX)=$G(PSOLOWER):$G(PSOLOWER),1:0)
"RTN","PSOSIGCX",34,0)
 Q:'$G(PSOLOWST)
"RTN","PSOSIGCX",35,0)
 S PSQMIN=+$G(PSOLOWST)
"RTN","PSOSIGCX",36,0)
 S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIGCX",37,0)
 S PSOQRND=PSQMINZ*+$G(PSOQX("DOSE ORDERED",1)) Q:'PSOQRND
"RTN","PSOSIGCX",38,0)
 D ROUND G QEND
"RTN","PSOSIGCX",39,0)
 Q
"RTN","PSOSIGCX",40,0)
COMP ;COMPLEX DOSE HERE - ALL ANDS
"RTN","PSOSIGCX",41,0)
 ;N PSOQAND,PSQL,PSQMNL,PSQMNLX,PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSQ1,PSODUX,PSODUXX,PSODSMIN
"RTN","PSOSIGCX",42,0)
 ;PSODUTOT = TOTAL OF ALL DURATIONS
"RTN","PSOSIGCX",43,0)
 ;PSODUDIF = DIFF. OF DURATION VS DAYS SUPPLY
"RTN","PSOSIGCX",44,0)
 ;PSODUMIS = # OF SEQUENCES MISSING A DURATION IF >1 CAN'T DEFAULT
"RTN","PSOSIGCX",45,0)
 ;PSODUREP = SEQUENCE # THAT IS MISSING DURATION
"RTN","PSOSIGCX",46,0)
 ;PSODSMIN = MINUTES OF DAYS SUPPLY
"RTN","PSOSIGCX",47,0)
 ;PSODSAME = FLAG THAT TELL IF DURATIONS ARE THE SAME
"RTN","PSOSIGCX",48,0)
 ;PSODURT = DURATION MINUTES FOR COMPARE
"RTN","PSOSIGCX",49,0)
 ;S (PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSODSMIN,PSOQAND)=0
"RTN","PSOSIGCX",50,0)
 ;F PSQL=1:1:QDOSE S:$G(PSOQX("CONJUNCTION",PSQL))["A" PSOQAND=1 Q:PSOQAND
"RTN","PSOSIGCX",51,0)
 I $G(PSOQTHEN) G COMP^PSOSIGTX
"RTN","PSOSIGCX",52,0)
 N PSODUMSS,PSODSAME,PSODURT S (PSODUMSS,PSODSAME,PSODURT)=0
"RTN","PSOSIGCX",53,0)
 F PSQ1=1:1:QDOSE D
"RTN","PSOSIGCX",54,0)
 .I '$G(PSOQX("DURATION",PSQ1)) S PSODUMIS=PSODUMIS+1,PSODUREP=PSQ1 Q
"RTN","PSOSIGCX",55,0)
 .S PSODUX=$L(PSOQX("DURATION",PSQ1))
"RTN","PSOSIGCX",56,0)
 .S PSODUMSS=1
"RTN","PSOSIGCX",57,0)
 .S PSODUXX=$S($E(PSOQX("DURATION",PSQ1),PSODUX)="M":1,$E(PSOQX("DURATION",PSQ1),PSODUX)="H":60,$E(PSOQX("DURATION",PSQ1),PSODUX)="S":.01666,$E(PSOQX("DURATION",PSQ1),PSODUX)="W":10080,$E(PSOQX("DURATION",PSQ1),PSODUX)="L":43200,1:1440)
"RTN","PSOSIGCX",58,0)
 .S PSODUTOT=PSODUTOT+(PSODUXX*(+$G(PSOQX("DURATION",PSQ1))))
"RTN","PSOSIGCX",59,0)
 .I '$G(PSODSAME),$G(PSODURT),PSODURT'=(PSODUXX*(+$G(PSOQX("DURATION",PSQ1)))) S PSODSAME=1
"RTN","PSOSIGCX",60,0)
 .S PSODURT=(PSODUXX*(+$G(PSOQX("DURATION",PSQ1))))
"RTN","PSOSIGCX",61,0)
 ;I PSODUMIS,PSODSAME G QEND ; missing durations, and other durations are all not the same
"RTN","PSOSIGCX",62,0)
 I '$G(PSOQX("DAYS SUPPLY")) G QEND ; missing Days Supply
"RTN","PSOSIGCX",63,0)
 S PSODSMIN=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIGCX",64,0)
 I PSODUMIS,PSODSAME G QEND ; Missing Durations, other are different
"RTN","PSOSIGCX",65,0)
 I 'PSODUMIS,PSODSAME,$G(PSODUTOT)>PSODSMIN G QEND ; Every sequence has a duration, some are different, and the total is greater than Days Supply
"RTN","PSOSIGCX",66,0)
 I 'PSODSAME,PSODURT>PSODSMIN G QEND ; All have a duration, and it's the same, but it's greater than Days Supply, or Missing Durations with other duration the same but greater than Days Supply
"RTN","PSOSIGCX",67,0)
 ;I $G(PSODSMIN),$G(PSODSMIN)<$G(PSODUTOT) G QEND
"RTN","PSOSIGCX",68,0)
 ;I '$G(PSODUMIS),$G(PSODSMIN),$G(PSODUTOT)>$G(PSODSMIN) G QEND ; no missing durations, but total durations are greater than days supply
"RTN","PSOSIGCX",69,0)
 ;I $G(PSODUMIS),$G(PSODSMIN),$G(PSODSMIN)'>$G(PSODUTOT) G QEND ; 1 missing duration, and total of other durations are not less than days supply
"RTN","PSOSIGCX",70,0)
 ;I '$G(PSODSMIN),$G(PSODUMIS) G QEND ; no days supply, m;issing a duration
"RTN","PSOSIGCX",71,0)
 ;I $G(PSODUMIS),PSODUMSS S PSODUDIF=$G(PSODSMIN)-$G(PSODUTOT)
"RTN","PSOSIGCX",72,0)
 F PSQ=1:1:QDOSE D  Q:$G(PSQQUIT)
"RTN","PSOSIGCX",73,0)
 .I '$G(PSOQX("DOSE ORDERED",PSQ))!($G(PSOQX("SCHEDULE",PSQ))="") S PSQQUIT=1 Q
"RTN","PSOSIGCX",74,0)
 .S QTSH=$G(PSOQX("SCHEDULE",PSQ)) D QTS S:'$G(PSOFRQ) PSQQUIT=1 Q:$G(PSQQUIT)
"RTN","PSOSIGCX",75,0)
 .I $G(PSOQX("DURATION",PSQ)) S PSQMNL=$L(PSOQX("DURATION",PSQ)) D
"RTN","PSOSIGCX",76,0)
 ..S PSQMNLX=$S($E(PSOQX("DURATION",PSQ),PSQMNL)="M":1,$E(PSOQX("DURATION",PSQ),PSQMNL)="H":60,$E(PSOQX("DURATION",PSQ),PSQMNL)="S":.01666,$E(PSOQX("DURATION",PSQ),PSQMNL)="W":10080,$E(PSOQX("DURATION",PSQ),PSQMNL)="L":43200,1:1440)
"RTN","PSOSIGCX",77,0)
 ..S PSQMIN=PSQMNLX*(+$G(PSOQX("DURATION",PSQ)))
"RTN","PSOSIGCX",78,0)
 .I '$G(PSOQX("DURATION",PSQ)) S PSQMIN=$S($G(PSODURT)&('$G(PSODSAME)):$G(PSODURT),1:$G(PSODSMIN))
"RTN","PSOSIGCX",79,0)
 .S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIGCX",80,0)
 .S PSOQRND=$S('$G(PSOQRND):PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ)),1:$G(PSOQRND)+(PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ))))
"RTN","PSOSIGCX",81,0)
 I $G(PSQQUIT) G QEND
"RTN","PSOSIGCX",82,0)
 I $G(PSOQRND) D ROUND
"RTN","PSOSIGCX",83,0)
 G QEND
"RTN","PSOSIGCX",84,0)
QTS ;*282 Centralized call
"RTN","PSOSIGCX",85,0)
 D QTS^PSOSIG
"RTN","PSOSIGCX",86,0)
 Q
"RTN","PSOSIGCX",87,0)
QEND ;
"RTN","PSOSIGCX",88,0)
 K PSOFRQ
"RTN","PSOSIGCX",89,0)
 Q
"RTN","PSOSIGCX",90,0)
ROUND ;
"RTN","PSOSIGCX",91,0)
 Q:'$G(PSOQRND)
"RTN","PSOSIGCX",92,0)
 I PSOQRND'["." S PSOQX("QTY")=PSOQRND Q
"RTN","PSOSIGCX",93,0)
 S PSOQX("QTY")=$P(PSOQRND,".")+1
"RTN","PSOSIGCX",94,0)
 Q
"RTN","PSOSIGCX",95,0)
DAY(DATE) ;First 5 digits of FileMan date
"RTN","PSOSIGCX",96,0)
 N X
"RTN","PSOSIGCX",97,0)
 I DATE'?5N Q -1
"RTN","PSOSIGCX",98,0)
 S X=$E(DATE,4,5) I X<1!(X>12) Q -1
"RTN","PSOSIGCX",99,0)
 S X=DATE+1+(X=12*88)_"01"
"RTN","PSOSIGCX",100,0)
 Q $E($$FMADD^XLFDT(X,-1),6,7)
"RTN","PSOSIGCX",101,0)
 ;
"RTN","PSOSIGCX",102,0)
QTYX(PSOQX) ;
"RTN","PSOSIGCX",103,0)
 N PSOQLP,PSOQLN,PSOQAR,PSOCPRQT,QDOSE,QDOSEX S PSOCPRQT=1 F PSOQLP=0:0 S PSOQLP=$O(PSOQX("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIGCX",104,0)
 .S PSOQAR("DURATION",PSOQLP)=$G(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIGCX",105,0)
 .I $E(PSOQX("DURATION",PSOQLP))?1A S PSOQLN=$L(PSOQX("DURATION",PSOQLP)) S PSOQX("DURATION",PSOQLP)=$E(PSOQX("DURATION",PSOQLP),2,PSOQLN)_$E(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIGCX",106,0)
 S QDOSE=0 F QDOSEX=0:0 S QDOSEX=$O(PSOQX("DOSE ORDERED",QDOSEX)) Q:'QDOSEX  S QDOSE=QDOSE+1
"RTN","PSOSIGCX",107,0)
 I '$G(PSOQX("QTY")) D QTYCP G QPASS
"RTN","PSOSIGCX",108,0)
 D QTYCP^PSOSIGDS
"RTN","PSOSIGCX",109,0)
QPASS F PSOQLP=0:0 S PSOQLP=$O(PSOQAR("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIGCX",110,0)
 .S PSOQX("DURATION",PSOQLP)=$G(PSOQAR("DURATION",PSOQLP))
"RTN","PSOSIGCX",111,0)
 K PSOCPRQT
"RTN","PSOSIGCX",112,0)
 Q
"RTN","PSOSIGCX",113,0)
DAYS(PSOQX) ;Entry point for Days Supply calc for PSO
"RTN","PSOSIGCX",114,0)
 ;Kill days supply here
"RTN","PSOSIGCX",115,0)
 Q:'$G(PSOQX("QTY"))
"RTN","PSOSIGCX",116,0)
 D QTYOPS^PSOSIGDS
"RTN","PSOSIGCX",117,0)
 Q
"RTN","PSOSIGDS")
0^15^B46304418
"RTN","PSOSIGDS",1,0)
PSOSIGDS ;BIR/RTR-Utility to calculate Days Supply ;6/04/00
"RTN","PSOSIGDS",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,222,391,282**;DEC 1997;Build 18
"RTN","PSOSIGDS",3,0)
 ;External reference to PS(51 supported by DBIA 2224
"RTN","PSOSIGDS",4,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOSIGDS",5,0)
 ;External reference to PS(55 supported by DBIA 2228
"RTN","PSOSIGDS",6,0)
 ;External reference to PSDRUG( supported by DBIA 221
"RTN","PSOSIGDS",7,0)
 ;External reference to YSCL(603.01 supported by DBIA 2697
"RTN","PSOSIGDS",8,0)
 ;
"RTN","PSOSIGDS",9,0)
EN(PSOSIGX) ;
"RTN","PSOSIGDS",10,0)
 N VARIABLE
"RTN","PSOSIGDS",11,0)
 Q
"RTN","PSOSIGDS",12,0)
SCH ;*282 Centralized Call
"RTN","PSOSIGDS",13,0)
 D SCH^PSOSIG
"RTN","PSOSIGDS",14,0)
 Q
"RTN","PSOSIGDS",15,0)
QTY(PSOQX) ;
"RTN","PSOSIGDS",16,0)
 Q
"RTN","PSOSIGDS",17,0)
QTYOPS ;
"RTN","PSOSIGDS",18,0)
 N QDOSE
"RTN","PSOSIGDS",19,0)
QTYCP ;CPRS days supply call comes through here
"RTN","PSOSIGDS",20,0)
 N PSOZMIN,PSQQUIT,QTSH,PSQ,PSQMIN,PSQMINZ,PSOQRND,PSOLOWER,PSOLOWX,PSOLOWXL,PSOLOWST
"RTN","PSOSIGDS",21,0)
 K PSOFRQ S PSQQUIT=0
"RTN","PSOSIGDS",22,0)
 I '$G(PSOCPRQT) S QDOSE=0 F PSQ=0:0 S PSQ=$O(PSOQX("DOSE",PSQ)) Q:'PSQ  S QDOSE=PSQ S:'$G(PSOQX("DOSE ORDERED",PSQ)) PSQQUIT=1
"RTN","PSOSIGDS",23,0)
 ;Q:PSQQUIT!('QDOSE)
"RTN","PSOSIGDS",24,0)
 I '$G(PSOCPRQT) Q:PSQQUIT
"RTN","PSOSIGDS",25,0)
 Q:'$G(QDOSE)
"RTN","PSOSIGDS",26,0)
 G:QDOSE>1 COMP
"RTN","PSOSIGDS",27,0)
 Q:'$G(PSOQX("DOSE ORDERED",1))
"RTN","PSOSIGDS",28,0)
 ;Q:'$G(PSOQX("DAYS SUPPLY"))&('$G(PSOQX("DURATION",1)))
"RTN","PSOSIGDS",29,0)
 S PSOLOWER=0
"RTN","PSOSIGDS",30,0)
 I $G(PSOQX("DURATION",1)) D
"RTN","PSOSIGDS",31,0)
 .S PSOLOWX=$L(PSOQX("DURATION",1))
"RTN","PSOSIGDS",32,0)
 .S PSOLOWXL=$S($E(PSOQX("DURATION",1),PSOLOWX)="M":1,$E(PSOQX("DURATION",1),PSOLOWX)="H":60,$E(PSOQX("DURATION",1),PSOLOWX)="S":.01666,$E(PSOQX("DURATION",1),PSOLOWX)="W":10080,$E(PSOQX("DURATION",1),PSOLOWX)="L":43200,1:1440)
"RTN","PSOSIGDS",33,0)
 .S PSOLOWER=PSOLOWXL*(+$G(PSOQX("DURATION",1)))
"RTN","PSOSIGDS",34,0)
 ;S PSOLOWX=0 I +$G(PSOQX("DAYS SUPPLY")) S PSOLOWX=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIGDS",35,0)
 ;Q:'$G(PSOLOWER)&('$G(PSOLOWX))
"RTN","PSOSIGDS",36,0)
 S QTSH=$G(PSOQX("SCHEDULE",1)) D QTS Q:PSQQUIT!('$G(PSOFRQ))
"RTN","PSOSIGDS",37,0)
 ;S PSOLOWST=$S('$G(PSOLOWER):$G(PSOLOWX),'$G(PSOLOWX):$G(PSOLOWER),$G(PSOLOWER)>$G(PSOLOWX):$G(PSOLOWX),$G(PSOLOWX)>$G(PSOLOWER):$G(PSOLOWER),$G(PSOLOWX)=$G(PSOLOWER):$G(PSOLOWER),1:0)
"RTN","PSOSIGDS",38,0)
 ;Q:'$G(PSOLOWST)
"RTN","PSOSIGDS",39,0)
 ;S PSQMIN=+$G(PSOLOWST)
"RTN","PSOSIGDS",40,0)
 S PSQMIN=$S($G(PSOLOWER):$G(PSOLOWER),1:0) ; PSQMIN=Minutes based in duration, or 0 if no duration
"RTN","PSOSIGDS",41,0)
 ;If Duration, determine using QTY how many days, regardless of duration, then use what is lower, that # of days or the duration, ROund that up, and check against Rx patient status
"RTN","PSOSIGDS",42,0)
 ;if no duration, just figure out using QTY # of days, then compare that against Rx patient status
"RTN","PSOSIGDS",43,0)
 S PSOZMIN=0
"RTN","PSOSIGDS",44,0)
 S PSOZMIN=PSOQX("QTY")/PSOQX("DOSE ORDERED",1)
"RTN","PSOSIGDS",45,0)
 S PSOZMIN=PSOZMIN*PSOFRQ
"RTN","PSOSIGDS",46,0)
 I $G(PSOLOWER) S PSOZMIN=$S(PSOLOWER<PSOZMIN:PSOLOWER,1:PSOZMIN)
"RTN","PSOSIGDS",47,0)
 S PSOZMIN=PSOZMIN/1440
"RTN","PSOSIGDS",48,0)
 ;S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIGDS",49,0)
 ;S PSOQRND=PSQMINZ*+$G(PSOQX("DOSE ORDERED",1)) Q:'PSOQRND
"RTN","PSOSIGDS",50,0)
 D ROUND G QEND
"RTN","PSOSIGDS",51,0)
 Q
"RTN","PSOSIGDS",52,0)
COMP ;COMPLEX DOSE HERE
"RTN","PSOSIGDS",53,0)
 N PSQMNL,PSQMNLX,PSODUTOT,PSOLEFT,PSOZMIN,PSODUPTT,PSODUDIF,PSODUMIS,PSODUREP,PSQ1,PSODUX,PSODUXX,PSODSMIN,PSOFRQZ,PSOQUTOT
"RTN","PSOSIGDS",54,0)
 N PSOQLD,PSOQLDA,PSOQLDT,PSOQLDX
"RTN","PSOSIGDS",55,0)
 ;PSODUTOT = TOTAL OF ALL DURATIONS
"RTN","PSOSIGDS",56,0)
 ;PSODUPTT = TOTAL OF DISPENSE UNITS PER DOSE
"RTN","PSOSIGDS",57,0)
 ;PSODUDIF = DIFF. OF DURATION VS DAYS SUPPLY
"RTN","PSOSIGDS",58,0)
 ;PSOQUTOT=QTY
"RTN","PSOSIGDS",59,0)
 ;PSODUMIS = # OF SEQUENCES MISSING A DURATION IF >1 CAN'T DEFAULT
"RTN","PSOSIGDS",60,0)
 ;PSODUREP = SEQUENCE # THAT IS MISSING DURATION
"RTN","PSOSIGDS",61,0)
 ;PSODSMIN = MINUTES OF DAYS SUPPLY
"RTN","PSOSIGDS",62,0)
 S (PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSODSMIN,PSOQLDA,PSOQLDT,PSOQLDX)=0
"RTN","PSOSIGDS",63,0)
 ;next lines, add complex dose days supply calculation with ANDs
"RTN","PSOSIGDS",64,0)
 F PSOQLD=1:1:QDOSE S:$G(PSOQX("CONJUNCTION",PSOQLD))["A" PSOQLDA=1 S:$G(PSOQX("CONJUNCTION",PSOQLD))["T" PSOQLDT=1 S:$G(PSOQX("CONJUNCTION",PSOQLD))["X" PSOQLDX=1
"RTN","PSOSIGDS",65,0)
 I $G(PSOQLDA)!($G(PSOQLDX)) G QEND
"RTN","PSOSIGDS",66,0)
 S PSOQUTOT=+$G(PSOQX("QTY"))
"RTN","PSOSIGDS",67,0)
 F PSQ1=1:1:QDOSE D  Q:PSODUMIS>1
"RTN","PSOSIGDS",68,0)
 .I '$G(PSOQX("DURATION",PSQ1)) S PSODUMIS=PSODUMIS+1,PSODUREP=PSQ1 Q
"RTN","PSOSIGDS",69,0)
 G:PSODUMIS>1 QEND ; More than 1 sequence missing a duration
"RTN","PSOSIGDS",70,0)
 F PSQ=1:1:QDOSE D  Q:$G(PSQQUIT)
"RTN","PSOSIGDS",71,0)
 .I '$G(PSOQX("DOSE ORDERED",PSQ))!($G(PSOQX("SCHEDULE",PSQ))="") S PSQQUIT=1 Q
"RTN","PSOSIGDS",72,0)
 .S QTSH=$G(PSOQX("SCHEDULE",PSQ)) D QTS S:'$G(PSOFRQ) PSQQUIT=1 Q:$G(PSQQUIT)
"RTN","PSOSIGDS",73,0)
 .I $G(PSOQX("DURATION",PSQ)) S PSQMNL=$L(PSOQX("DURATION",PSQ)) D
"RTN","PSOSIGDS",74,0)
 ..S PSQMNLX=$S($E(PSOQX("DURATION",PSQ),PSQMNL)="M":1,$E(PSOQX("DURATION",PSQ),PSQMNL)="H":60,$E(PSOQX("DURATION",PSQ),PSQMNL)="S":.01666,$E(PSOQX("DURATION",PSQ),PSQMNL)="W":10080,$E(PSOQX("DURATION",PSQ),PSQMNL)="L":43200,1:1440)
"RTN","PSOSIGDS",75,0)
 ..S PSQMIN=PSQMNLX*(+$G(PSOQX("DURATION",PSQ)))
"RTN","PSOSIGDS",76,0)
 ..S PSODUTOT=PSODUTOT+(PSQMNLX*(+$G(PSOQX("DURATION",PSQ))))
"RTN","PSOSIGDS",77,0)
 .I '$G(PSOQX("DURATION",PSQ)) S PSOFRQZ=PSOFRQ Q
"RTN","PSOSIGDS",78,0)
 .S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIGDS",79,0)
 .S PSODUPTT=$S($G(PSODUPTT):$G(PSODUPTT),1:0)+(PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ)))
"RTN","PSOSIGDS",80,0)
 I $G(PSQQUIT) G QEND
"RTN","PSOSIGDS",81,0)
 I $G(PSOQUTOT)<0 G QEND
"RTN","PSOSIGDS",82,0)
 I '$G(PSODUMIS),$G(PSODUPTT)>$G(PSOQUTOT) G QEND
"RTN","PSOSIGDS",83,0)
 I '$G(PSODUMIS) S PSOZMIN=+$G(PSODUTOT)/1440 D ROUND G QEND
"RTN","PSOSIGDS",84,0)
 I PSODUPTT'<PSOQUTOT!('$G(PSOFRQZ)) G QEND
"RTN","PSOSIGDS",85,0)
 S PSODUPTT=PSOQUTOT-PSODUPTT S PSOLEFT=(PSODUPTT/+$G(PSOQX("DOSE ORDERED",PSODUREP)))*(+$G(PSOFRQZ))
"RTN","PSOSIGDS",86,0)
 S PSODUTOT=PSODUTOT+PSOLEFT S PSOZMIN=PSODUTOT/1440 D ROUND
"RTN","PSOSIGDS",87,0)
 G QEND
"RTN","PSOSIGDS",88,0)
QTS ;*282 Centralized Call
"RTN","PSOSIGDS",89,0)
 D QTS^PSOSIG
"RTN","PSOSIGDS",90,0)
 Q
"RTN","PSOSIGDS",91,0)
QEND ;
"RTN","PSOSIGDS",92,0)
 K PSOFRQ
"RTN","PSOSIGDS",93,0)
 Q
"RTN","PSOSIGDS",94,0)
ROUND ;
"RTN","PSOSIGDS",95,0)
 Q:'$G(PSOZMIN)
"RTN","PSOSIGDS",96,0)
 I PSOZMIN'["." S PSOQX("DAYS SUPPLY")=PSOZMIN G RXP
"RTN","PSOSIGDS",97,0)
 S PSOQX("DAYS SUPPLY")=$P(PSOZMIN,".")+1
"RTN","PSOSIGDS",98,0)
RXP ;Compare against Rx Patient Status
"RTN","PSOSIGDS",99,0)
 Q:'$G(PSOQX("PATIENT"))
"RTN","PSOSIGDS",100,0)
 N PSO55,PSO553
"RTN","PSOSIGDS",101,0)
 S PSO55=$P($G(^PS(55,PSOQX("PATIENT"),"PS")),"^") I 'PSO55 G CLOZ
"RTN","PSOSIGDS",102,0)
 S PSO553=$P($G(^PS(53,PSO55,0)),"^",3) I 'PSO553 G CLOZ
"RTN","PSOSIGDS",103,0)
 I PSO553<$G(PSOQX("DAYS SUPPLY")) S PSOQX("DAYS SUPPLY")=PSO553
"RTN","PSOSIGDS",104,0)
CLOZ ;check for clozapine
"RTN","PSOSIGDS",105,0)
 N PSOCLPAT,PSOCLMAX
"RTN","PSOSIGDS",106,0)
 Q:'$G(PSOQX("DRUG"))
"RTN","PSOSIGDS",107,0)
 I $P($G(^PSDRUG(PSOQX("DRUG"),"CLOZ1")),"^")="PSOCLO1" D
"RTN","PSOSIGDS",108,0)
 .S PSOCLPAT=$O(^YSCL(603.01,"C",PSOQX("PATIENT"),0)) Q:'PSOCLPAT
"RTN","PSOSIGDS",109,0)
 .S PSOCLPAT=$P($G(^YSCL(603.01,PSOCLPAT,0)),"^",3)
"RTN","PSOSIGDS",110,0)
 .S PSOCLMAX=$S(PSOCLPAT="M":28,PSOCLPAT="B":14,PSOCLPAT="W":7,1:0)
"RTN","PSOSIGDS",111,0)
 .I PSOCLMAX,PSOCLMAX<$G(PSOQX("DAYS SUPPLY")) S PSOQX("DAYS SUPPLY")=PSOCLMAX
"RTN","PSOSIGDS",112,0)
 Q
"RTN","PSOSIGDS",113,0)
DAY(DATE) ;First 5 digits of FileMan date
"RTN","PSOSIGDS",114,0)
 N X
"RTN","PSOSIGDS",115,0)
 I DATE'?5N Q -1
"RTN","PSOSIGDS",116,0)
 S X=$E(DATE,4,5) I X<1!(X>12) Q -1
"RTN","PSOSIGDS",117,0)
 S X=DATE+1+(X=12*88)_"01"
"RTN","PSOSIGDS",118,0)
 Q $E($$FMADD^XLFDT(X,-1),6,7)
"RTN","PSOSIGDS",119,0)
 ;
"RTN","PSOSIGDS",120,0)
QTYX(PSOQX) ;
"RTN","PSOSIGDS",121,0)
 N PSOQLP,PSOQLN,PSOQAR,PSOCPRQT,QDOSE,QDOSEX S PSOCPRQT=1 F PSOQLP=0:0 S PSOQLP=$O(PSOQX("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIGDS",122,0)
 .S PSOQAR("DURATION",PSOQLP)=$G(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIGDS",123,0)
 .I $E(PSOQX("DURATION",PSOQLP))?1A S PSOQLN=$L(PSOQX("DURATION",PSOQLP)) S PSOQX("DURATION",PSOQLP)=$E(PSOQX("DURATION",PSOQLP),2,PSOQLN)_$E(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIGDS",124,0)
 S QDOSE=0 F QDOSEX=0:0 S QDOSEX=$O(PSOQX("DOSE ORDERED",QDOSEX)) Q:'QDOSEX  S QDOSE=QDOSE+1
"RTN","PSOSIGDS",125,0)
 D QTYCP
"RTN","PSOSIGDS",126,0)
 F PSOQLP=0:0 S PSOQLP=$O(PSOQAR("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIGDS",127,0)
 .S PSOQX("DURATION",PSOQLP)=$G(PSOQAR("DURATION",PSOQLP))
"RTN","PSOSIGDS",128,0)
 K PSOCPRQT
"RTN","PSOSIGDS",129,0)
 Q
"RTN","PSOSIGDS",130,0)
DSUP(PSOQX) ;Max Days Supply for CPRS, without QTY (just patient and drug)
"RTN","PSOSIGDS",131,0)
 ;Should we add to accept # of refills?
"RTN","PSOSIGDS",132,0)
 ;If no Drug, should we base on Orderable Item
"RTN","PSOSIGDS",133,0)
 N CS,DR,OI S CS=0,DR=$G(PSOQX("DRUG"))
"RTN","PSOSIGDS",134,0)
 I DR S CS=$$CSDS(DR)
"RTN","PSOSIGDS",135,0)
 I 'DR S OI=$G(PSOQX("OI")) D:OI
"RTN","PSOSIGDS",136,0)
 .N IDT,PAC S DR=0 F  S DR=$O(^PSDRUG("ASP",OI,DR)) Q:'DR!(CS)  D
"RTN","PSOSIGDS",137,0)
 ..S IDT=$P($G(^PSDRUG(DR,"I")),"^"),PAC=$P($G(^(2)),"^",3)
"RTN","PSOSIGDS",138,0)
 ..I IDT,IDT<DT Q
"RTN","PSOSIGDS",139,0)
 ..I PAC'["O" Q
"RTN","PSOSIGDS",140,0)
 ..S CS=$$CSDS(DR)
"RTN","PSOSIGDS",141,0)
 S PSOQX("DAYS SUPPLY")=$S(CS:30,1:90)
"RTN","PSOSIGDS",142,0)
 Q:'$G(PSOQX("PATIENT"))
"RTN","PSOSIGDS",143,0)
 N PSO55,PSO553
"RTN","PSOSIGDS",144,0)
 S PSO55=$P($G(^PS(55,PSOQX("PATIENT"),"PS")),"^") I 'PSO55 G DSUPDG
"RTN","PSOSIGDS",145,0)
 S PSO553=$P($G(^PS(53,PSO55,0)),"^",3) I 'PSO553 G DSUPDG
"RTN","PSOSIGDS",146,0)
 I PSO553<$G(PSOQX("DAYS SUPPLY")) S PSOQX("DAYS SUPPLY")=PSO553
"RTN","PSOSIGDS",147,0)
DSUPDG ;
"RTN","PSOSIGDS",148,0)
 N PSOCLPAT,PSOCLMAX
"RTN","PSOSIGDS",149,0)
 Q:'DR
"RTN","PSOSIGDS",150,0)
 I $P($G(^PSDRUG(DR,"CLOZ1")),"^")="PSOCLO1" D
"RTN","PSOSIGDS",151,0)
 .S PSOCLPAT=$O(^YSCL(603.01,"C",PSOQX("PATIENT"),0)) Q:'PSOCLPAT
"RTN","PSOSIGDS",152,0)
 .S PSOCLPAT=$P($G(^YSCL(603.01,PSOCLPAT,0)),"^",3)
"RTN","PSOSIGDS",153,0)
 .S PSOCLMAX=$S(PSOCLPAT="M":28,PSOCLPAT="B":14,$P($G(^(0)),"^",3)="W":7,1:0)
"RTN","PSOSIGDS",154,0)
 .I PSOCLMAX,PSOCLMAX<$G(PSOQX("DAYS SUPPLY")) S PSOQX("DAYS SUPPLY")=PSOCLMAX
"RTN","PSOSIGDS",155,0)
 Q
"RTN","PSOSIGDS",156,0)
MAX(PSOQX) ;
"RTN","PSOSIGDS",157,0)
 G EN^PSOSIGMX
"RTN","PSOSIGDS",158,0)
 Q
"RTN","PSOSIGDS",159,0)
 ;
"RTN","PSOSIGDS",160,0)
CSDS(DR) ;
"RTN","PSOSIGDS",161,0)
 Q:'DR 0
"RTN","PSOSIGDS",162,0)
 I $P($G(^PSDRUG(DR,"ND")),"^",3) S CS=+$P($G(^PSNDF(50.68,$P(^("ND"),"^",3),7)),"^")
"RTN","PSOSIGDS",163,0)
 E  S CS=$P($G(^PSDRUG(DR,0)),"^",3),CS=$S(CS[1:1,CS[2:2,CS[3:3,CS[4:4,CS[5:5,1:0)
"RTN","PSOSIGDS",164,0)
 I CS=1!(CS=2)!(CS=3)!(CS=4)!(CS=5) Q 1
"RTN","PSOSIGDS",165,0)
 Q 0
"RTN","PSOSIGDS",166,0)
 ;
"RTN","PSOSIGNO")
0^16^B19149557
"RTN","PSOSIGNO",1,0)
PSOSIGNO ;BHAM ISC/RTR-Check new Sig for Route and Schedule ; 10/10/96
"RTN","PSOSIGNO",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**282**;DEC 1997;Build 18
"RTN","PSOSIGNO",3,0)
 ;
"RTN","PSOSIGNO",4,0)
 ;Pass in IEN from Pending File, and New Sig
"RTN","PSOSIGNO",5,0)
 ;Returned   PSOSIGFL=0  no new order (common Routes and Schedules)
"RTN","PSOSIGNO",6,0)
 ;           PSOSIGFL=1  new order (no Route to having route) or
"RTN","PSOSIGNO",7,0)
 ;                                 (no Schedule to having schedule) or
"RTN","PSOSIGNO",8,0)
 ;                                 (visa versa, or discrepency)
"RTN","PSOSIGNO",9,0)
 ;
"RTN","PSOSIGNO",10,0)
 ;Also returned are arrays with Original and New Routes & Schedules:
"RTN","PSOSIGNO",11,0)
 ;
"RTN","PSOSIGNO",12,0)
 ; PSOMDRTE array (original route)      PSOMDRTE(1)="ORAL"
"RTN","PSOSIGNO",13,0)
 ;
"RTN","PSOSIGNO",14,0)
 ; PSONEWMD array (new routes)          PSONEWMD(1)="ORAL"
"RTN","PSOSIGNO",15,0)
 ;                                      PSONEWMD(22)="BOTH EYES"
"RTN","PSOSIGNO",16,0)
 ;
"RTN","PSOSIGNO",17,0)
 ; PSOSCH array (original schedules)    PSOSCH("Q12H")=""
"RTN","PSOSIGNO",18,0)
 ;                                      PSOSCH("Q4H")=""
"RTN","PSOSIGNO",19,0)
 ;
"RTN","PSOSIGNO",20,0)
 ; PSONEWSD array (new schedules)       PSONEWSD("Q4H")=""
"RTN","PSOSIGNO",21,0)
 ;                                      PSONEWSD("Q8H")=""
"RTN","PSOSIGNO",22,0)
 ;
"RTN","PSOSIGNO",23,0)
EN(PSPENIEN,PSPENSIG) ;
"RTN","PSOSIGNO",24,0)
 K PSONEWMD,PSOMDRTE,PSOSCH,PSONEWSD N AA,GGG,PSONULL,XXX,XXXX,ZZZZ
"RTN","PSOSIGNO",25,0)
 ;S PSOSIGFL=0
"RTN","PSOSIGNO",26,0)
 I $P($G(^PS(52.41,PSPENIEN,0)),"^",15),$P($G(^PS(51.2,+$P(^(0),"^",15),0)),"^")'="" S PSOMDRTE($P(^PS(52.41,PSPENIEN,0),"^",15))=$P(^PS(51.2,+$P(^(0),"^",15),0),"^")
"RTN","PSOSIGNO",27,0)
 F ZZZZ=0:0 S ZZZZ=$O(^PS(52.41,PSPENIEN,1,ZZZZ)) Q:'ZZZZ  I $P($G(^PS(52.41,PSPENIEN,1,ZZZZ,1)),"^")'="" S PSOSCH($P(^(1),"^"))=""
"RTN","PSOSIGNO",28,0)
 F GGG=1:1:$L(PSPENSIG," ") S XXX=$P(PSPENSIG," ",GGG) D:XXX]""
"RTN","PSOSIGNO",29,0)
 .I $D(^PS(51,"A",XXX)) D
"RTN","PSOSIGNO",30,0)
 ..;PSO*7*282 intended use
"RTN","PSOSIGNO",31,0)
 ..S XXXX=$O(^PS(51,"B",XXX,0)) D:XXXX&($P($G(^PS(51,XXXX,0)),"^",4)>1)
"RTN","PSOSIGNO",32,0)
 ...I $P($G(^PS(51,XXXX,0)),"^",5),$P($G(^PS(51.2,+$P(^(0),"^",5),0)),"^")'="" S PSONEWMD($P(^PS(51,XXXX,0),"^",5))=$P(^PS(51.2,$P(^(0),"^",5),0),"^")
"RTN","PSOSIGNO",33,0)
 ...I $P($G(^PS(51,XXXX,0)),"^",6)'="" S PSONEWSD($P(^(0),"^",6))=""
"RTN","PSOSIGNO",34,0)
NEW ;Check for new order
"RTN","PSOSIGNO",35,0)
 S PSONULL=""
"RTN","PSOSIGNO",36,0)
 I $O(PSOMDRTE(0)),'$O(PSONEWMD(0)) S PSOSIGFL=1
"RTN","PSOSIGNO",37,0)
 Q:$G(PSOSIGFL)  I $O(PSONEWMD(0)),'$O(PSOMDRTE(0)) S PSOSIGFL=1
"RTN","PSOSIGNO",38,0)
 Q:$G(PSOSIGFL)  I $O(PSOSCH(PSONULL))="",$O(PSONEWSD(PSONULL))'="" S PSOSIGFL=1
"RTN","PSOSIGNO",39,0)
 Q:$G(PSOSIGFL)  I $O(PSONEWSD(PSONULL))="",$O(PSOSCH(PSONULL))'="" S PSOSIGFL=1
"RTN","PSOSIGNO",40,0)
 Q:$G(PSOSIGFL)
"RTN","PSOSIGNO",41,0)
ERROR ;check for error
"RTN","PSOSIGNO",42,0)
 ;This is also a new order now
"RTN","PSOSIGNO",43,0)
 F AA=0:0 S AA=$O(PSOMDRTE(AA)) Q:'AA!($G(PSOSIGFL))  I '$D(PSONEWMD(AA)) S PSOSIGFL=1
"RTN","PSOSIGNO",44,0)
 Q:$G(PSOSIGFL)  F AA=0:0 S AA=$O(PSONEWMD(AA)) Q:'AA!($G(PSOSIGFL))  I '$D(PSOMDRTE(AA)) S PSOSIGFL=1
"RTN","PSOSIGNO",45,0)
 Q:$G(PSOSIGFL)  S AA="" F  S AA=$O(PSOSCH(AA)) Q:AA=""!($G(PSOSIGFL))  I '$D(PSONEWSD(AA)) S PSOSIGFL=1
"RTN","PSOSIGNO",46,0)
 Q:$G(PSOSIGFL)  S AA="" F  S AA=$O(PSONEWSD(AA)) Q:AA=""!($G(PSOSIGFL))  I '$D(PSOSCH(AA)) S PSOSIGFL=1
"RTN","PSOSIGNO",47,0)
 Q
"RTN","PSOSIGNO",48,0)
 ;
"RTN","PSOSIGNO",49,0)
EN1(PSRENIEN,PSRENSIG) ;
"RTN","PSOSIGNO",50,0)
 ;Same as above, only for a new Sig from File 52
"RTN","PSOSIGNO",51,0)
 ;Pass in IEN from 52, and new Sig
"RTN","PSOSIGNO",52,0)
 K PSONEWMD,PSOMDRTE,PSOSCH,PSONEWSD N AA,GGG,PSONULL,XXX,XXXX,ZZZZ
"RTN","PSOSIGNO",53,0)
 ;S PSOSIGFL=0
"RTN","PSOSIGNO",54,0)
 F GGG=0:0 S GGG=$O(^PSRX(PSRENIEN,"MEDR",GGG)) Q:'GGG  S ZZZZ=+$P(^(GGG,0),"^") I ZZZZ,$P($G(^PS(51.2,ZZZZ,0)),"^")'="" S PSOMDRTE(ZZZZ)=$P(^(0),"^")
"RTN","PSOSIGNO",55,0)
 F ZZZZ=0:0 S ZZZZ=$O(^PSRX(PSRENIEN,"SCH",ZZZZ)) Q:'ZZZZ  I $P(^(ZZZZ,0),"^")'="" S PSOSCH($P(^(0),"^"))=""
"RTN","PSOSIGNO",56,0)
 F GGG=1:1:$L(PSRENSIG," ") S XXX=$P(PSRENSIG," ",GGG) D:XXX]""
"RTN","PSOSIGNO",57,0)
 .I $D(^PS(51,"A",XXX)) D
"RTN","PSOSIGNO",58,0)
 ..;PSO*7*282 intended use
"RTN","PSOSIGNO",59,0)
 ..S XXXX=$O(^PS(51,"B",XXX,0)) D:XXXX&($P($G(^PS(51,XXXX,0)),"^",4)>1)
"RTN","PSOSIGNO",60,0)
 ...I $P($G(^PS(51,XXXX,0)),"^",5),$P($G(^PS(51.2,+$P(^(0),"^",5),0)),"^")'="" S PSONEWMD($P(^PS(51,XXXX,0),"^",5))=$P(^PS(51.2,$P(^(0),"^",5),0),"^")
"RTN","PSOSIGNO",61,0)
 ...I $P($G(^PS(51,XXXX,0)),"^",6)'="" S PSONEWSD($P(^(0),"^",6))=""
"RTN","PSOSIGNO",62,0)
NEWOR ;Check for new order
"RTN","PSOSIGNO",63,0)
 G NEW
"RTN","PSOSIGNO",64,0)
 ;
"RTN","PSOSIGNO",65,0)
POP(PSOPOPRX) ;Pass in Internal Rx number, will populate Med Route and
"RTN","PSOSIGNO",66,0)
 ;schedule fields from BACK door Sig
"RTN","PSOSIGNO",67,0)
 N BACKSIG,BBB,LLL,LLLL,POPMD,POPSC
"RTN","PSOSIGNO",68,0)
 Q:'$D(^PSRX(PSOPOPRX,0))
"RTN","PSOSIGNO",69,0)
 Q:$P($G(^PSRX(PSOPOPRX,"SIG")),"^")=""!($P($G(^("SIG")),"^",2))
"RTN","PSOSIGNO",70,0)
 S BACKSIG=$P(^PSRX(PSOPOPRX,"SIG"),"^")
"RTN","PSOSIGNO",71,0)
 F BBB=1:1:$L(BACKSIG," ") S LLL=$P(BACKSIG," ",BBB) D:LLL]""
"RTN","PSOSIGNO",72,0)
 .I $D(^PS(51,"A",LLL)) D
"RTN","PSOSIGNO",73,0)
 ..;PSO*7*282 intended use
"RTN","PSOSIGNO",74,0)
 ..S LLLL=$O(^PS(51,"B",LLL,0)) D:LLLL&($P($G(^PS(51,LLLL,0)),"^",4)>1)
"RTN","PSOSIGNO",75,0)
 ...I $P($G(^PS(51,LLLL,0)),"^",5),$P($G(^PS(51.2,+$P(^(0),"^",5),0)),"^")'="" S POPMD($P(^PS(51,LLLL,0),"^",5))=""
"RTN","PSOSIGNO",76,0)
 ...I $P($G(^PS(51,LLLL,0)),"^",6)'="" S POPSC($P(^(0),"^",6))=""
"RTN","PSOSIGNO",77,0)
 K ^PSRX(PSOPOPRX,"MEDR"),^PSRX(PSOPOPRX,"SCH")
"RTN","PSOSIGNO",78,0)
 S LLLL=1 F LLL=0:0 S LLL=$O(POPMD(LLL)) Q:'LLL  S ^PSRX(PSOPOPRX,"MEDR",LLLL,0)=LLL,^PSRX(PSOPOPRX,"MEDR",0)="^52.037PA^"_LLLL_"^"_LLLL S LLLL=LLLL+1
"RTN","PSOSIGNO",79,0)
 S LLLL=1,LLL="" F  S LLL=$O(POPSC(LLL)) Q:LLL=""  S ^PSRX(PSOPOPRX,"SCH",LLLL,0)=LLL,^PSRX(PSOPOPRX,"SCH",0)="^52.038A^"_LLLL_"^"_LLLL S LLLL=LLLL+1
"RTN","PSOSIGNO",80,0)
 K PSOPOPRX
"RTN","PSOSIGNO",81,0)
 Q
"RTN","PSOSIGTX")
0^17^B53937250
"RTN","PSOSIGTX",1,0)
PSOSIGTX ;BIR/RTR-Utility to calculate quantity ; 3/23/11 8:25am
"RTN","PSOSIGTX",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,282**;DEC 1997;Build 18
"RTN","PSOSIGTX",3,0)
 ;External reference to PS(51 supported by DBIA 2224
"RTN","PSOSIGTX",4,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOSIGTX",5,0)
 ;
"RTN","PSOSIGTX",6,0)
EN(PSOSIGX) ;
"RTN","PSOSIGTX",7,0)
 N VARIABLE
"RTN","PSOSIGTX",8,0)
 Q
"RTN","PSOSIGTX",9,0)
SCH ;*282 Centralized Call
"RTN","PSOSIGTX",10,0)
 D SCH^PSOSIG
"RTN","PSOSIGTX",11,0)
 Q
"RTN","PSOSIGTX",12,0)
QTY(PSOQX) ;
"RTN","PSOSIGTX",13,0)
 N QDOSE
"RTN","PSOSIGTX",14,0)
QTYCP ;CPRS qty call comes through here
"RTN","PSOSIGTX",15,0)
 N PSQQUIT,QTSH,PSQ,PSQMIN,PSQMINZ,PSOQRND,PSOLOWER,PSOLOWX,PSOLOWXL,PSOLOWST
"RTN","PSOSIGTX",16,0)
 K PSOFRQ S PSQQUIT=0
"RTN","PSOSIGTX",17,0)
 I '$G(PSOCPRQT) S QDOSE=0 F PSQ=0:0 S PSQ=$O(PSOQX("DOSE",PSQ)) Q:'PSQ  S QDOSE=PSQ S:'$G(PSOQX("DOSE ORDERED",PSQ)) PSQQUIT=1
"RTN","PSOSIGTX",18,0)
 ;Q:PSQQUIT!('QDOSE)
"RTN","PSOSIGTX",19,0)
 I '$G(PSOCPRQT) Q:PSQQUIT
"RTN","PSOSIGTX",20,0)
 Q:'$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIGTX",21,0)
 Q:'$G(QDOSE)
"RTN","PSOSIGTX",22,0)
 G:QDOSE>1 COMP
"RTN","PSOSIGTX",23,0)
TOP ;One Dose for complex and/then
"RTN","PSOSIGTX",24,0)
 N PSOQDUR
"RTN","PSOSIGTX",25,0)
 Q:'$G(PSOQX("DOSE ORDERED",PSQDOSE))
"RTN","PSOSIGTX",26,0)
 Q:'$G(PSOQX("DAYS SUPPLY"))&('$G(PSOQX("DURATION",PSQDOSE)))
"RTN","PSOSIGTX",27,0)
 S PSOLOWER=0
"RTN","PSOSIGTX",28,0)
 I $G(PSOQX("DURATION",PSQDOSE)) D
"RTN","PSOSIGTX",29,0)
 .S PSOLOWX=$L(PSOQX("DURATION",PSQDOSE))
"RTN","PSOSIGTX",30,0)
 .S PSOQDUR=$G(PSOQX("DURATION",PSQDOSE))
"RTN","PSOSIGTX",31,0)
 .S PSOLOWXL=$S($E(PSOQDUR,PSOLOWX)="M":1,$E(PSOQDUR,PSOLOWX)="H":60,$E(PSOQDUR,PSOLOWX)="S":.01666,$E(PSOQDUR,PSOLOWX)="W":10080,$E(PSOQDUR,PSOLOWX)="L":43200,1:1440)
"RTN","PSOSIGTX",32,0)
 .S PSOLOWER=PSOLOWXL*(+$G(PSOQX("DURATION",PSQDOSE)))
"RTN","PSOSIGTX",33,0)
 I $G(PSOLOWER),$G(PSOLOWER)>PSODSMXX Q
"RTN","PSOSIGTX",34,0)
 S PSOLOWX=$G(PSODSMXX)
"RTN","PSOSIGTX",35,0)
 Q:'$G(PSOLOWER)&('$G(PSOLOWX))
"RTN","PSOSIGTX",36,0)
 S QTSH=$G(PSOQX("SCHEDULE",PSQDOSE)) D QTS Q:PSQQUIT!('$G(PSOFRQ))
"RTN","PSOSIGTX",37,0)
 S PSOLOWST=$S('$G(PSOLOWER):$G(PSOLOWX),'$G(PSOLOWX):$G(PSOLOWER),$G(PSOLOWER)>$G(PSOLOWX):$G(PSOLOWX),$G(PSOLOWX)>$G(PSOLOWER):$G(PSOLOWER),$G(PSOLOWX)=$G(PSOLOWER):$G(PSOLOWER),1:0)
"RTN","PSOSIGTX",38,0)
 Q:'$G(PSOLOWST)
"RTN","PSOSIGTX",39,0)
 Q:PSOLOWST'>0
"RTN","PSOSIGTX",40,0)
 S PSQMIN=+$G(PSOLOWST)
"RTN","PSOSIGTX",41,0)
 S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIGTX",42,0)
 S PSOQRND=PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQDOSE)) Q:'PSOQRND
"RTN","PSOSIGTX",43,0)
 S PSODSMXX=PSODSMXX-PSQMIN
"RTN","PSOSIGTX",44,0)
 Q:PSODSMXX<0
"RTN","PSOSIGTX",45,0)
 D ROUND G QEND
"RTN","PSOSIGTX",46,0)
 Q
"RTN","PSOSIGTX",47,0)
COMP ;COMPLEX DOSE HERE - ANDS AND THENS
"RTN","PSOSIGTX",48,0)
 ;N PSOQAND,PSQL,PSQMNL,PSQMNLX,PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSQ1,PSODUX,PSODUXX,PSODSMIN
"RTN","PSOSIGTX",49,0)
 ;PSODUTOT = TOTAL OF ALL DURATIONS
"RTN","PSOSIGTX",50,0)
 ;PSODUDIF = DIFF. OF DURATION VS DAYS SUPPLY
"RTN","PSOSIGTX",51,0)
 ;PSODUMIS = # OF SEQUENCES MISSING A DURATION IF >1 CAN'T DEFAULT
"RTN","PSOSIGTX",52,0)
 ;PSODUREP = SEQUENCE # THAT IS MISSING DURATION
"RTN","PSOSIGTX",53,0)
 ;PSODSMIN = MINUTES OF DAYS SUPPLY
"RTN","PSOSIGTX",54,0)
 ;PSODSAME = FLAG THAT TELL IF DURATIONS ARE THE SAME
"RTN","PSOSIGTX",55,0)
 ;PSODURT = DURATION MINUTES FOR COMPARE
"RTN","PSOSIGTX",56,0)
 ;S (PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSODSMIN,PSOQAND)=0
"RTN","PSOSIGTX",57,0)
 ;F PSQL=1:1:QDOSE S:$G(PSOQX("CONJUNCTION",PSQL))["A" PSOQAND=1 Q:PSOQAND
"RTN","PSOSIGTX",58,0)
 ;I $G(PSOQTHEN) G COMP^PSOSIGTX
"RTN","PSOSIGTX",59,0)
 N PSQHOLDX,PSQFLAG,PSQMINLP,PSQMINAR,PSODSMXX,PSOTFLAG,PSODSDEC,PSORNDXX,PSOATQUT,PSQDOSE,PSQDOSEX,PSOQZ,PSOQZX S (PSORNDXX,PSOATQUT,PSODSDEC,PSOTFLAG)=0,PSQDOSE=0,PSQDOSEX=QDOSE
"RTN","PSOSIGTX",60,0)
 I '$D(PSOQX("CONJUNCTION",PSQDOSEX)) S PSOQX("CONJUNCTION",PSQDOSEX)="A",PSOTFLAG=1
"RTN","PSOSIGTX",61,0)
 S (PSODSMIN,PSODSMXX)=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIGTX",62,0)
 F  S PSQDOSE=$O(PSOQX("CONJUNCTION",PSQDOSE)) Q:$G(PSOATQUT)!($G(PSQDOSE)="")  I $G(PSOQX("CONJUNCTION",PSQDOSE))["T"!(PSQDOSE=PSQDOSEX) S PSOATQUT=1 D
"RTN","PSOSIGTX",63,0)
 .;I 1 DO TOP ELSE DO BELOW, SET BEGINNIG AND END COUNTERS, USE THOSE ON LOOPS BELOW, OR THE SINGLE NUMBER FOR UP TOP (CHANGE 1'S TO NUMBERS)
"RTN","PSOSIGTX",64,0)
 .I '$G(PSOQZ) S PSOQZ=1
"RTN","PSOSIGTX",65,0)
 .I PSQDOSE-PSOQZ=0 D TOP S PSOQZ=PSQDOSE+1 Q
"RTN","PSOSIGTX",66,0)
 .D BOT
"RTN","PSOSIGTX",67,0)
 .S PSOQZ=PSQDOSE+1
"RTN","PSOSIGTX",68,0)
 ;SET LAST CONJUNCTION, MAKE SURE IT'S NOT PASSED IN FROM cprs
"RTN","PSOSIGTX",69,0)
 I $G(PSOTFLAG) K PSOQX("CONJUNCTION",PSQDOSEX)
"RTN","PSOSIGTX",70,0)
 I PSOATQUT K PSOQX("QTY") Q
"RTN","PSOSIGTX",71,0)
 I $G(PSOQX("QTY")) D ROUNDF
"RTN","PSOSIGTX",72,0)
 Q
"RTN","PSOSIGTX",73,0)
BOT ;
"RTN","PSOSIGTX",74,0)
 N PSODUMSS,PSODSAME,PSODURT S (PSODUMSS,PSODSAME,PSODURT,PSODUMIS,PSOQRND,PSODUTOT)=0
"RTN","PSOSIGTX",75,0)
 F PSQ1=PSOQZ:1:PSQDOSE D
"RTN","PSOSIGTX",76,0)
 .I '$G(PSOQX("DURATION",PSQ1)) S PSODUMIS=PSODUMIS+1,PSODUREP=PSQ1 Q
"RTN","PSOSIGTX",77,0)
 .S PSODUX=$L(PSOQX("DURATION",PSQ1))
"RTN","PSOSIGTX",78,0)
 .S PSODUMSS=1
"RTN","PSOSIGTX",79,0)
 .S PSODUXX=$S($E(PSOQX("DURATION",PSQ1),PSODUX)="M":1,$E(PSOQX("DURATION",PSQ1),PSODUX)="H":60,$E(PSOQX("DURATION",PSQ1),PSODUX)="S":.01666,$E(PSOQX("DURATION",PSQ1),PSODUX)="W":10080,$E(PSOQX("DURATION",PSQ1),PSODUX)="L":43200,1:1440)
"RTN","PSOSIGTX",80,0)
 .S PSODUTOT=PSODUTOT+(PSODUXX*(+$G(PSOQX("DURATION",PSQ1))))
"RTN","PSOSIGTX",81,0)
 .I '$G(PSODSAME),$G(PSODURT),PSODURT'=(PSODUXX*(+$G(PSOQX("DURATION",PSQ1)))) S PSODSAME=1
"RTN","PSOSIGTX",82,0)
 .S PSODURT=(PSODUXX*(+$G(PSOQX("DURATION",PSQ1))))
"RTN","PSOSIGTX",83,0)
 ;I PSODUMIS,PSODSAME G QEND ; missing durations, and other durations are all not the same
"RTN","PSOSIGTX",84,0)
 I '$G(PSOQX("DAYS SUPPLY")) G QEND ; missing Days Supply
"RTN","PSOSIGTX",85,0)
 ;S PSODSMIN=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIGTX",86,0)
 I PSODUMIS,PSODSAME G QEND ; Missing Durations, other are different
"RTN","PSOSIGTX",87,0)
 I 'PSODUMIS,PSODSAME,$G(PSODUTOT)>PSODSMIN G QEND ; Every sequence has a duration, some are different, and the total is greater than Days Supply
"RTN","PSOSIGTX",88,0)
 I 'PSODSAME,PSODURT>PSODSMIN G QEND ; All have a duration, and it's the same, but it's greater than Days Supply, or Missing Durations with other duration the same but greater than Days Supply
"RTN","PSOSIGTX",89,0)
 ;I $G(PSODSMIN),$G(PSODSMIN)<$G(PSODUTOT) G QEND
"RTN","PSOSIGTX",90,0)
 ;I '$G(PSODUMIS),$G(PSODSMIN),$G(PSODUTOT)>$G(PSODSMIN) G QEND ; no missing durations, but total durations are greater than days supply
"RTN","PSOSIGTX",91,0)
 ;I $G(PSODUMIS),$G(PSODSMIN),$G(PSODSMIN)'>$G(PSODUTOT) G QEND ; 1 missing duration, and total of other durations are not less than days supply
"RTN","PSOSIGTX",92,0)
 ;I '$G(PSODSMIN),$G(PSODUMIS) G QEND ; no days supply, m;issing a duration
"RTN","PSOSIGTX",93,0)
 I $G(PSODUMIS),PSODUMSS S PSODUDIF=$G(PSODSMIN)-$G(PSODUTOT)
"RTN","PSOSIGTX",94,0)
 K PSQMINAR F PSQ=PSOQZ:1:PSQDOSE D  Q:$G(PSQQUIT)
"RTN","PSOSIGTX",95,0)
 .I '$G(PSOQX("DOSE ORDERED",PSQ))!($G(PSOQX("SCHEDULE",PSQ))="") S PSQQUIT=1 Q
"RTN","PSOSIGTX",96,0)
 .S QTSH=$G(PSOQX("SCHEDULE",PSQ)) D QTS S:'$G(PSOFRQ) PSQQUIT=1 Q:$G(PSQQUIT)
"RTN","PSOSIGTX",97,0)
 .I $G(PSOQX("DURATION",PSQ)) S PSQMNL=$L(PSOQX("DURATION",PSQ)) D
"RTN","PSOSIGTX",98,0)
 ..S PSQMNLX=$S($E(PSOQX("DURATION",PSQ),PSQMNL)="M":1,$E(PSOQX("DURATION",PSQ),PSQMNL)="H":60,$E(PSOQX("DURATION",PSQ),PSQMNL)="S":.01666,$E(PSOQX("DURATION",PSQ),PSQMNL)="W":10080,$E(PSOQX("DURATION",PSQ),PSQMNL)="L":43200,1:1440)
"RTN","PSOSIGTX",99,0)
 ..S PSQMIN=PSQMNLX*(+$G(PSOQX("DURATION",PSQ)))
"RTN","PSOSIGTX",100,0)
 ..I $G(PSQMIN) S PSQMINAR(PSQ)=PSQMIN
"RTN","PSOSIGTX",101,0)
 .I '$G(PSOQX("DURATION",PSQ)) S PSQMIN=$S($G(PSODURT)&('$G(PSODSAME)):$G(PSODURT),1:$G(PSODSMXX)) I PSQMIN S PSQMINAR(PSQ)=PSQMIN
"RTN","PSOSIGTX",102,0)
 .S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIGTX",103,0)
 .S PSOQRND=$S('$G(PSOQRND):PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ)),1:$G(PSOQRND)+(PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ))))
"RTN","PSOSIGTX",104,0)
 .;S PSODSMXX=PSODSMXX-PSQMIN
"RTN","PSOSIGTX",105,0)
 S (PSQFLAG,PSQHOLDX)=0 S PSQMINLP="" F  S PSQMINLP=$O(PSQMINAR(PSQMINLP)) Q:PSQMINLP=""  S:$G(PSQHOLDX)&($G(PSQHOLDX)'=$G(PSQMINAR(PSQMINLP))) PSQFLAG=1 S PSQHOLDX=$G(PSQMINAR(PSQMINLP))
"RTN","PSOSIGTX",106,0)
 I $G(PSQFLAG) S PSQMINLP="" F  S PSQMINLP=$O(PSQMINAR(PSQMINLP)) Q:PSQMINLP=""  I $G(PSQMINAR(PSQMINLP)) S PSODSMXX=PSODSMXX-PSQMINAR(PSQMINLP)
"RTN","PSOSIGTX",107,0)
 I '$G(PSQFLAG) S PSQMINLP="" F  S PSQMINLP=$O(PSQMINAR(PSQMINLP)) Q:PSQMINLP=""!($G(PSQFLAG))  I $G(PSQMINAR(PSQMINLP)) S PSODSMXX=PSODSMXX-PSQMINAR(PSQMINLP),PSQFLAG=1
"RTN","PSOSIGTX",108,0)
 K PSQMINAR,PSQFLAG
"RTN","PSOSIGTX",109,0)
 I PSODSMXX<0 G QEND
"RTN","PSOSIGTX",110,0)
 I $G(PSQQUIT) G QEND
"RTN","PSOSIGTX",111,0)
 I $G(PSOQRND) D ROUND
"RTN","PSOSIGTX",112,0)
 G QEND
"RTN","PSOSIGTX",113,0)
QTS ;*282 Centralized call
"RTN","PSOSIGTX",114,0)
 D QTS^PSOSIG
"RTN","PSOSIGTX",115,0)
 Q
"RTN","PSOSIGTX",116,0)
QEND ;
"RTN","PSOSIGTX",117,0)
 K PSOFRQ
"RTN","PSOSIGTX",118,0)
 Q
"RTN","PSOSIGTX",119,0)
ROUND ;
"RTN","PSOSIGTX",120,0)
 Q:'$G(PSOQRND)
"RTN","PSOSIGTX",121,0)
 S PSOQX("QTY")=$G(PSOQX("QTY"))+$G(PSOQRND)
"RTN","PSOSIGTX",122,0)
 S PSOATQUT=0
"RTN","PSOSIGTX",123,0)
 Q
"RTN","PSOSIGTX",124,0)
ROUNDF ;
"RTN","PSOSIGTX",125,0)
 I PSOQX("QTY")'["." Q
"RTN","PSOSIGTX",126,0)
 S PSOQX("QTY")=$P(PSOQX("QTY"),".")+1
"RTN","PSOSIGTX",127,0)
 Q
"RTN","PSOSIGTX",128,0)
DAY(DATE) ;First 5 digits of FileMan date
"RTN","PSOSIGTX",129,0)
 N X
"RTN","PSOSIGTX",130,0)
 I DATE'?5N Q -1
"RTN","PSOSIGTX",131,0)
 S X=$E(DATE,4,5) I X<1!(X>12) Q -1
"RTN","PSOSIGTX",132,0)
 S X=DATE+1+(X=12*88)_"01"
"RTN","PSOSIGTX",133,0)
 Q $E($$FMADD^XLFDT(X,-1),6,7)
"RTN","PSOSIGTX",134,0)
 ;
"RTN","PSOSIGTX",135,0)
QTYX(PSOQX) ;
"RTN","PSOSIGTX",136,0)
 N PSOQLP,PSOQLN,PSOQAR,PSOCPRQT,QDOSE,QDOSEX S PSOCPRQT=1 F PSOQLP=0:0 S PSOQLP=$O(PSOQX("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIGTX",137,0)
 .S PSOQAR("DURATION",PSOQLP)=$G(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIGTX",138,0)
 .I $E(PSOQX("DURATION",PSOQLP))?1A S PSOQLN=$L(PSOQX("DURATION",PSOQLP)) S PSOQX("DURATION",PSOQLP)=$E(PSOQX("DURATION",PSOQLP),2,PSOQLN)_$E(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIGTX",139,0)
 S QDOSE=0 F QDOSEX=0:0 S QDOSEX=$O(PSOQX("DOSE ORDERED",QDOSEX)) Q:'QDOSEX  S QDOSE=QDOSE+1
"RTN","PSOSIGTX",140,0)
 I '$G(PSOQX("QTY")) D QTYCP G QPASS
"RTN","PSOSIGTX",141,0)
 D QTYCP^PSOSIGDS
"RTN","PSOSIGTX",142,0)
QPASS F PSOQLP=0:0 S PSOQLP=$O(PSOQAR("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIGTX",143,0)
 .S PSOQX("DURATION",PSOQLP)=$G(PSOQAR("DURATION",PSOQLP))
"RTN","PSOSIGTX",144,0)
 K PSOCPRQT
"RTN","PSOSIGTX",145,0)
 Q
"RTN","PSOSIGTX",146,0)
DAYS(PSOQX) ;Entry point for Days Supply calc for PSO
"RTN","PSOSIGTX",147,0)
 ;Kill days supply here
"RTN","PSOSIGTX",148,0)
 Q:'$G(PSOQX("QTY"))
"RTN","PSOSIGTX",149,0)
 D QTYOPS^PSOSIGDS
"RTN","PSOSIGTX",150,0)
 Q
"RTN","PSOSPSIG")
0^18^B53180136
"RTN","PSOSPSIG",1,0)
PSOSPSIG ;BIR/RTR,SAB-Parse out and create other lang. Sig ;9/24/01
"RTN","PSOSPSIG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**117,333,282**;DEC 1997;Build 18
"RTN","PSOSPSIG",3,0)
 ;PSSORPH - DBIA 3234 ;^PS(50.606 - DBIA 2174 ;^PS(50.7 - DBIA 2223
"RTN","PSOSPSIG",4,0)
 ;^PS(51.2 - DBIA 2226 ;^PS(51 - DBIA 2224 ;^PSDRUG - DBIA 221
"RTN","PSOSPSIG",5,0)
 ;^PS(59.7 - DBIA 694 ;^PS(51.1 - DBIA 2225
"RTN","PSOSPSIG",6,0)
 ;
"RTN","PSOSPSIG",7,0)
EN(PSOFX) ;
"RTN","PSOSPSIG",8,0)
 K SIG9,PSNOUN,PSOROUTE,SIG0 S OI=$P($G(^PSRX(RX,"OR1")),"^") Q:'$G(OI)
"RTN","PSOSPSIG",9,0)
 S (FND,TODOSE)=0 F WW=0:0 S WW=$O(PSOFX("DOSE",WW)) Q:'WW  S TODOSE=WW
"RTN","PSOSPSIG",10,0)
 S:TODOSE FND=1 Q:'TODOSE  S SIGDS=+$P($G(^PS(50.7,OI,0)),"^",2)
"RTN","PSOSPSIG",11,0)
 S PREP=$S($P($G(^PS(50.606,SIGDS,"MISC1")),"^",2)]"":$P(^PS(50.606,SIGDS,"MISC1"),"^",2),1:$P($G(^PS(50.606,SIGDS,"MISC")),"^",3))
"RTN","PSOSPSIG",12,0)
 S RTCNT=0 K RTC,RTCA,RTCF F SSS=1:1:TODOSE D
"RTN","PSOSPSIG",13,0)
 .S SIG0(SSS)=$S($G(PSOFX("DOSE ORDERED",SSS))'="":$G(PSOFX("DOSE ORDERED",SSS)),1:$G(PSOFX("DOSE",SSS))) ;local dosage check
"RTN","PSOSPSIG",14,0)
 .I $G(PSOFX("DOSE ORDERED",SSS))="" S LODS=$O(^PSDRUG($P(^PSRX(RX,0),"^",6),"DOS2","B",SIG0(SSS),0)) I LODS D
"RTN","PSOSPSIG",15,0)
 ..S:$P(^PSDRUG($P(^PSRX(RX,0),"^",6),"DOS2",LODS,0),"^",4)]"" PSOFX("DOSE ORDERED",SSS)=$P(^PSDRUG($P(^PSRX(RX,0),"^",6),"DOS2",LODS,0),"^",4) K LODS
"RTN","PSOSPSIG",16,0)
 .S VERBX(SSS)=$S($G(PSOFX("VERB",SSS))]""&($P($G(^PS(50.606,SIGDS,"MISC1")),"^")]""):$P(^PS(50.606,SIGDS,"MISC1"),"^"),1:$G(PSOFX("VERB",SSS)))
"RTN","PSOSPSIG",17,0)
 .I $G(PSOFX("NOUN",SSS))]"" D NON
"RTN","PSOSPSIG",18,0)
 .S RTC=+$G(PSOFX("ROUTE",SSS)) I RTC S:'RTCNT RTCA=RTC S RTCNT=RTCNT+1
"RTN","PSOSPSIG",19,0)
 .I RTCNT>1,$G(RTC),$G(RTC)'=$G(RTCA) S RTCF=1
"RTN","PSOSPSIG",20,0)
 .S PSOROUTE(SSS)=$S($P($G(^PS(51.2,+$G(PSOFX("ROUTE",SSS)),0)),"^",7)]"":$P(^(0),"^",7),$P($G(^(0)),"^",2)]"":$P(^(0),"^",2),$P($G(^(0)),"^",3)]"":$P(^(0),"^",3),1:$P($G(^(0)),"^"))
"RTN","PSOSPSIG",21,0)
 .S MEDEXP(SSS)=$S($P($G(^PS(51.2,+$G(PSOFX("ROUTE",SSS)),0)),"^",2)="":0,1:1)
"RTN","PSOSPSIG",22,0)
 .S PDAYS(SSS)=$G(PSOFX("DURATION",SSS))
"RTN","PSOSPSIG",23,0)
 .I $G(PSOFX("DURATION",SSS))]"",($E(PSOFX("DURATION",SSS),$L(PSOFX("DURATION",SSS)))'?1A) S PDAYS(SSS)=PDAYS(SSS)_"D"
"RTN","PSOSPSIG",24,0)
 .S FOR=$O(^PS(59.7,"AOTH","FOR","")) S FOR=$S(FOR]"":FOR,1:"FOR")
"RTN","PSOSPSIG",25,0)
 .S PSDUR(SSS)=$S($G(PDAYS(SSS))']"":"NULL",1:FOR_" "_$E($G(PDAYS(SSS)),1,($L($G(PDAYS(SSS)))-1))) D  I PSDUR(SSS)'="NULL" S PSDUR(SSS)=PSDUR(SSS)_" "_INTERVAL
"RTN","PSOSPSIG",26,0)
 ..I PSDUR(SSS)'="NULL" S INTERVAL=$E(PDAYS(SSS),$L(PDAYS(SSS))),INTERVAL=$S(INTERVAL="D":"DAYS",INTERVAL="W":"WEEKS",INTERVAL="H":"HOURS",INTERVAL="L":"MONTHS",INTERVAL="M":"MINUTES",INTERVAL="S":"SECONDS",1:"") D
"RTN","PSOSPSIG",27,0)
 ...Q:$G(INTERVAL)']""  S INTERVAL=$O(^PS(59.7,"AOTH",INTERVAL,""))
"RTN","PSOSPSIG",28,0)
 ...I $G(PSOFX("DURATION",SSS)),$G(PSOFX("DURATION",SSS))'>1 S INTERVAL=$E(INTERVAL,1,($L(INTERVAL)-1))
"RTN","PSOSPSIG",29,0)
 ;282 Schedule Expander Changed
"RTN","PSOSPSIG",30,0)
 F GGG=1:1:TODOSE S SCHED(GGG)=$$SCHE^PSOSIG($G(PSOFX("SCHEDULE",GGG)))
"RTN","PSOSPSIG",31,0)
 ;282 End Change
"RTN","PSOSPSIG",32,0)
 S (RTC,RTCA,PSOBDCT)=0 F FFF=0:0 S FFF=$O(SIG0(FFF)) Q:'FFF  D
"RTN","PSOSPSIG",33,0)
 .K PSOSG1,PSOSG2 S VERB=$G(VERBX(FFF)) D VERB D:$G(PSNOUN(FFF))'=""&('$G(PSOSG1)) SSS
"RTN","PSOSPSIG",34,0)
 .D FRAC
"RTN","PSOSPSIG",35,0)
 .S SIG2(FFF)=$S($G(VERB)'=""&('$G(PSOSG1)):$G(VERB)_" ",1:"")_$S($G(PSOFX("DOSE ORDERED",FFF))'="":$S($G(PSOFRAC)'="":$G(PSOFRAC),1:$G(PSOFX("DOSE ORDERED",FFF)))_" ",1:$G(PSOFX("DOSE",FFF))_" ")
"RTN","PSOSPSIG",36,0)
 .S PSOBDCT=PSOBDCT+1
"RTN","PSOSPSIG",37,0)
 .K PSOFRAC,PSOFRACX
"RTN","PSOSPSIG",38,0)
 .I RTC>0,$G(PSOROUTE(FFF))'="",'$G(RTCF) S RTCA=1
"RTN","PSOSPSIG",39,0)
 .I $G(PSOROUTE(FFF))'="" S RTC=RTC+1
"RTN","PSOSPSIG",40,0)
 .S SIG2(FFF)=SIG2(FFF)_$S($G(PSNOUN(FFF))'=""&('$G(PSOSG2)):$G(PSNOUN(FFF))_" ",1:"")_$S(PREP'=""&($G(MEDEXP(FFF)))&('RTCA):PREP_" ",1:"")
"RTN","PSOSPSIG",41,0)
 .S SIG2(FFF)=SIG2(FFF)_$S(PSOROUTE(FFF)'=""&('RTCA):PSOROUTE(FFF)_" ",1:"")
"RTN","PSOSPSIG",42,0)
 .S SIG2(FFF)=SIG2(FFF)_$S(SCHED(FFF)'="":SCHED(FFF)_$S($G(PSDUR(FFF))="NULL"&($G(PSOFX("CONJUNCTION",FFF))="")&('$O(SIG0(FFF))):"",1:" "),1:"")
"RTN","PSOSPSIG",43,0)
 .S PSOCJ=$E($G(PSOFX("CONJUNCTION",FFF)))
"RTN","PSOSPSIG",44,0)
 .S CON=$S($G(PSOCJ)="A":"AND",$G(PSOCJ)="T":"THEN",$G(PSOCJ)="S":"THEN",$G(PSOCJ)="X":"EXCEPT",1:"") I CON]"" S CON=$O(^PS(59.7,"AOTH",CON,""))
"RTN","PSOSPSIG",45,0)
 .S SIG2(FFF)=SIG2(FFF)_$S(PSDUR(FFF)'="NULL":PSDUR(FFF)_$S($G(PSOFX("CONJUNCTION",FFF))=""&('$O(SIG0(FFF))):"",1:", "),1:"")_CON
"RTN","PSOSPSIG",46,0)
 .K PSOSG1,PSOSG2
"RTN","PSOSPSIG",47,0)
 .K PSOUCS S SIG2(FFF)=$$UPPER(SIG2(FFF)) K PSOUCS
"RTN","PSOSPSIG",48,0)
 S PSODCT="" F  S PSODCT=$O(PSOFX("SIG",PSODCT)) Q:PSODCT=""  S PSOBDCT=PSOBDCT+1 S SIG2(PSOBDCT)=$G(PSOFX("SIG",PSODCT)) K PSOUCS S SIG2(PSOBDCT)=$$UPPER(SIG2(PSOBDCT)) K PSOUCS
"RTN","PSOSPSIG",49,0)
STUFF ;
"RTN","PSOSPSIG",50,0)
 S DCOUNT=0
"RTN","PSOSPSIG",51,0)
 I '$D(SIG2(1)) G QUIT
"RTN","PSOSPSIG",52,0)
 I '$O(SIG2(1)),$L(SIG2(1))<71 S SIG9(1)=SIG2(1)
"RTN","PSOSPSIG",53,0)
 S (VAR,VAR1)="",II=1
"RTN","PSOSPSIG",54,0)
 F FF=0:0 S FF=$O(SIG2(FF)) Q:'FF  S CT=0 F NN=1:1:$L(SIG2(FF)) I $E(SIG2(FF),NN)=" "!($L(SIG2(FF))=NN) S CT=CT+1 D  I $L(VAR)>70 S SIG9(II)=LIM_" ",II=II+1,VAR=VAR1
"RTN","PSOSPSIG",55,0)
 .S VAR1=$P(SIG2(FF)," ",(CT))
"RTN","PSOSPSIG",56,0)
 .S LIM=VAR
"RTN","PSOSPSIG",57,0)
 .S VAR=$S(VAR="":VAR1,1:VAR_" "_VAR1)
"RTN","PSOSPSIG",58,0)
 I $G(VAR)'="" S SIG9(II)=VAR
"RTN","PSOSPSIG",59,0)
QUIT K SSS,TT,DCOUNT,PREP,VERB,FFF,GGG,SIGDS,SIGRT,PSOROUTE,PSOSG1,PSOSG2 Q
"RTN","PSOSPSIG",60,0)
SIG1 ;
"RTN","PSOSPSIG",61,0)
 F FFF=0:0 S FFF=$O(SIG0(FFF)) Q:'FFF  S SIG2(FFF)=SIG0(FFF)
"RTN","PSOSPSIG",62,0)
 Q
"RTN","PSOSPSIG",63,0)
DAYS I +$E($P(SIG1(TT),"^",2))!($E($P(SIG1(TT),"^",2))=0) S $P(SIG1(TT),"^",2)="D"_$P(SIG1(TT),"^",2)
"RTN","PSOSPSIG",64,0)
 Q
"RTN","PSOSPSIG",65,0)
NON ;
"RTN","PSOSPSIG",66,0)
 S NN=PSOFX("NOUN",SSS)
"RTN","PSOSPSIG",67,0)
 S NOUN=$O(^PS(50.606,SIGDS,"NOUN","B",NN,0)) I NOUN S PSNOUN(SSS)=$S($G(^PS(50.606,SIGDS,"NOUN",NOUN,1))]"":^PS(50.606,SIGDS,"NOUN",NOUN,1),1:NN) K NN Q
"RTN","PSOSPSIG",68,0)
 N PSONN S PSONN=NN K NN,NOUN D DOSE^PSSORPH(.XDOSE,$P(^PSRX(RX,0),"^",6),"O") I $P($G(XDOSE("DD",$P(^PSRX(RX,0),"^",6))),"^",9)="" S PSNOUN(SSS)=PSONN Q  ;*333
"RTN","PSOSPSIG",69,0)
 S NN=$P(XDOSE("DD",$P(^PSRX(RX,0),"^",6)),"^",9),NOUN=$O(^PS(50.606,SIGDS,"NOUN","B",NN,0))
"RTN","PSOSPSIG",70,0)
 I NOUN S PSNOUN(SSS)=$S($G(^PS(50.606,SIGDS,"NOUN",NOUN,1))]"":^PS(50.606,SIGDS,"NOUN",NOUN,1),1:NN)
"RTN","PSOSPSIG",71,0)
 K XDOSE,NN Q
"RTN","PSOSPSIG",72,0)
VERB ;Check if verb and noun need to be added to SIG
"RTN","PSOSPSIG",73,0)
 K PSOLCS,PSOUCS,PSOISL,PSOVL
"RTN","PSOSPSIG",74,0)
 I $G(VERB)'="" S PSOVL=$L(VERB),PSOISL=$E($G(SIG0(FFF)),1,$G(PSOVL)) I $G(PSOISL)'="" D
"RTN","PSOSPSIG",75,0)
 .S PSOUCS=VERB
"RTN","PSOSPSIG",76,0)
 .S PSOUCS=$$UPPER(PSOUCS) I PSOUCS=PSOISL S PSOSG1=1 Q
"RTN","PSOSPSIG",77,0)
 .S PSOUCS=$$LOWER(PSOUCS) I PSOUCS=PSOISL S PSOSG1=1 Q
"RTN","PSOSPSIG",78,0)
 .S PSOUCS=$$UPPER($E(PSOUCS,1))_$$LOWER($E(PSOUCS,2,99)) I PSOUCS=PSOISL S PSOSG1=1 Q
"RTN","PSOSPSIG",79,0)
 I $G(PSNOUN(FFF))="" G VERBEX
"RTN","PSOSPSIG",80,0)
 S PSOISL=$G(SIG0(FFF)) I $G(PSOISL)="" G VERBEX
"RTN","PSOSPSIG",81,0)
 S PSOVL=$F(PSNOUN(FFF),"(")
"RTN","PSOSPSIG",82,0)
 I $G(PSOVL)>2 S PSOUCS=$E(PSNOUN(FFF),1,(PSOVL-2))
"RTN","PSOSPSIG",83,0)
 I $G(PSOVL)'>2 S PSOUCS=PSNOUN(FFF)
"RTN","PSOSPSIG",84,0)
 I $G(PSOISL)'="" D
"RTN","PSOSPSIG",85,0)
 .S PSOUCS=$$UPPER(PSOUCS) I PSOISL[PSOUCS S PSOSG2=1 Q
"RTN","PSOSPSIG",86,0)
 .S PSOUCS=$$LOWER(PSOUCS) I PSOISL[PSOUCS S PSOSG2=1 Q
"RTN","PSOSPSIG",87,0)
 .S PSOUCS=$$UPPER($E(PSOUCS,1))_$$LOWER($E(PSOUCS,2,99)) I PSOISL[PSOUCS S PSOSG2=1
"RTN","PSOSPSIG",88,0)
VERBEX K PSOLCS,PSOUCS,PSOISL,PSOVL Q
"RTN","PSOSPSIG",89,0)
 ;
"RTN","PSOSPSIG",90,0)
UPPER(PSOUCS) ;
"RTN","PSOSPSIG",91,0)
 Q $TR(PSOUCS,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSOSPSIG",92,0)
 ;
"RTN","PSOSPSIG",93,0)
LOWER(PSOLCS) ;
"RTN","PSOSPSIG",94,0)
 Q $TR(PSOLCS,"ABCDEFGHIJKLMNOPQRSTUVWXYZ","abcdefghijklmnopqrstuvwxyz")
"RTN","PSOSPSIG",95,0)
 Q
"RTN","PSOSPSIG",96,0)
 ;
"RTN","PSOSPSIG",97,0)
SSS ;
"RTN","PSOSPSIG",98,0)
 K PSOFNL,PSOFNLF,PSOFNLX
"RTN","PSOSPSIG",99,0)
 Q:$G(PSNOUN(FFF))=""
"RTN","PSOSPSIG",100,0)
 Q:$L(PSNOUN(FFF))'>3
"RTN","PSOSPSIG",101,0)
 Q:'$G(PSOFX("DOSE ORDERED",FFF))
"RTN","PSOSPSIG",102,0)
 S PSOFNL=$E(PSNOUN(FFF),($L(PSNOUN(FFF))-2),$L(PSNOUN(FFF)))
"RTN","PSOSPSIG",103,0)
 I $G(PSOFNL)="(S)"!($G(PSOFNL)="(s)") D
"RTN","PSOSPSIG",104,0)
 .I $G(PSOFX("DOSE ORDERED",FFF))'>1 S PSNOUN(FFF)=$E(PSNOUN(FFF),1,($L(PSNOUN(FFF))-3))
"RTN","PSOSPSIG",105,0)
 .I $G(PSOFX("DOSE ORDERED",FFF))>1 S PSNOUN(FFF)=$E(PSNOUN(FFF),1,($L(PSNOUN(FFF))-3))_$E(PSOFNL,2)
"RTN","PSOSPSIG",106,0)
 Q
"RTN","PSOSPSIG",107,0)
FRAC ;
"RTN","PSOSPSIG",108,0)
 K PSOFRAC,PSOFRACX,PSOFRAC1,PSOFRAC2
"RTN","PSOSPSIG",109,0)
 I $G(PSOFX("DOSE ORDERED",FFF))="" Q
"RTN","PSOSPSIG",110,0)
 I $G(PSOFX("DOSE ORDERED",FFF))'["." S (PSOFRAC1,PSOFRAC)=$G(PSOFX("DOSE ORDERED",FFF)) D NUM D  G FRACQ
"RTN","PSOSPSIG",111,0)
 .I $G(PSOFRAC1)=$G(PSOFRAC) K PSOFRAC,PSOFRAC1 Q
"RTN","PSOSPSIG",112,0)
 .S PSOFRAC=$G(PSOFRAC1)
"RTN","PSOSPSIG",113,0)
 S PSOFRAC1=$P(PSOFX("DOSE ORDERED",FFF),"."),PSOFRAC2=$P(PSOFX("DOSE ORDERED",FFF),".",2)
"RTN","PSOSPSIG",114,0)
 S PSOFRACX="."_$G(PSOFRAC2)
"RTN","PSOSPSIG",115,0)
 S PSOFRAC=$S(PSOFRACX=".5":"ONE-HALF",PSOFRACX=".25":"ONE-FOURTH",PSOFRACX=".33":"ONE-THIRD",PSOFRACX=".34":"ONE-THIRD",PSOFRACX=".50":"ONE-HALF",PSOFRACX=".66":"TWO-THIRDS",PSOFRACX=".67":"TWO-THIRDS",PSOFRACX=".75":"THREE-FOURTHS",1:PSOFRACX)
"RTN","PSOSPSIG",116,0)
 S PSOFRAC9=$O(^PS(59.7,"AOTH",PSOFRAC,"")) I PSOFRAC9]"" S PSOFRAC=PSOFRAC9
"RTN","PSOSPSIG",117,0)
 K PSOFRAC9
"RTN","PSOSPSIG",118,0)
 I $G(PSOFRAC)="" K PSOFRAC G FRACQ
"RTN","PSOSPSIG",119,0)
 I $G(PSOFRAC1)'="",+$G(PSOFRAC1) D
"RTN","PSOSPSIG",120,0)
 .D NUM S AND=$O(^PS(59.7,"AOTH","AND",""))
"RTN","PSOSPSIG",121,0)
 .S PSOFRAC=$G(PSOFRAC1)_" "_$S(AND]"":AND,1:"AND")_" "_$S($E($G(PSOFRAC),1)=".":"0",1:"")_$G(PSOFRAC)
"RTN","PSOSPSIG",122,0)
 I $E($G(PSOFRAC),1)="." S PSOFRAC="0"_$G(PSOFRAC)
"RTN","PSOSPSIG",123,0)
FRACQ K PSOFRAC1,PSOFRAC2,AND
"RTN","PSOSPSIG",124,0)
 Q
"RTN","PSOSPSIG",125,0)
NUM ;
"RTN","PSOSPSIG",126,0)
 Q:$G(PSOFRAC1)=""
"RTN","PSOSPSIG",127,0)
 S PSOFRAC1=$S(PSOFRAC1="1":"ONE",PSOFRAC1="2":"TWO",PSOFRAC1="3":"THREE",PSOFRAC1="4":"FOUR",PSOFRAC1="5":"FIVE",PSOFRAC1="6":"SIX",PSOFRAC1="7":"SEVEN",PSOFRAC1="8":"EIGHT",PSOFRAC1="9":"NINE",PSOFRAC1="10":"TEN",1:PSOFRAC1)
"RTN","PSOSPSIG",128,0)
 S PSOFRAC9=$O(^PS(59.7,"AOTH",PSOFRAC1,"")) I PSOFRAC9]"" S PSOFRAC1=PSOFRAC9
"RTN","PSOSPSIG",129,0)
 K PSOFRAC9
"RTN","PSOSPSIG",130,0)
 Q
"RTN","PSOSTART")
1^20
"RTN","PSOTALK1")
0^19^B5110576
"RTN","PSOTALK1",1,0)
PSOTALK1 ;BIR/EJW - SCRIPTALK INTERFACE FROM VISTA (CONT'D) ; 7/16/15 3:32pm
"RTN","PSOTALK1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**135,318,282**;DEC 1997;Build 18
"RTN","PSOTALK1",3,0)
 ;External reference to File ^PS(51 supported by DBIA 2224
"RTN","PSOTALK1",4,0)
 ;ROB SILVERMAN-HINES DEVELOPED ORIGINAL VISTA CUSTOM SOFTWARE FOR SCRIPTALK
"RTN","PSOTALK1",5,0)
INST ;PARSE OUT PRINTED INSTRUCTIONS TO MAX 46 CHAR PER LINE
"RTN","PSOTALK1",6,0)
 K PSOLNE
"RTN","PSOTALK1",7,0)
 S PSOLEN=0,PSOLINE=1,PSOWDS=$L(SIG," ")
"RTN","PSOTALK1",8,0)
 F PSOWORD=1:1 Q:PSOWORD>PSOWDS  D  ;
"RTN","PSOTALK1",9,0)
 . S PSOLNE(PSOLINE)=$G(PSOLNE(PSOLINE))_$P(SIG," ",PSOWORD)_" "
"RTN","PSOTALK1",10,0)
 . S PSOLEN=$G(PSOLEN)+$L($P(SIG," ",PSOWORD))+1
"RTN","PSOTALK1",11,0)
 . I PSOLEN+$L($P(SIG," ",PSOWORD+1))>46 S PSOLINE=PSOLINE+1,PSOLEN=0
"RTN","PSOTALK1",12,0)
 Q
"RTN","PSOTALK1",13,0)
 ;
"RTN","PSOTALK1",14,0)
LSIG(SIG) ;EXPAND A SIG
"RTN","PSOTALK1",15,0)
 S SGY="" F P=1:1:$L(SIG," ") S X=$P(SIG," ",P) D:X]""  ;
"RTN","PSOTALK1",16,0)
 .;PSO*7*282 Intended Use Check
"RTN","PSOTALK1",17,0)
 .N PSOIN S PSOIN=$O(^PS(51,"B",X,0)) I PSOIN,($P(^PS(51,PSOIN,0),"^",4)<2)&($D(^PS(51,"A",X))) S %=^(X),X=$P(%,"^") I $P(%,"^",2)]"" S Y=$P(SIG,"",P-1),Y=$E(Y,$L(Y)) S:Y>1 X=$P(%,"^",2)
"RTN","PSOTALK1",18,0)
 .S SGY=SGY_X_" "
"RTN","PSOTALK1",19,0)
 Q SGY
"RTN","PSOTALK1",20,0)
 ;
"RTN","PSOTALK1",21,0)
READER(ZDIR0,ZDIRA,ZDIRB) ;BASIC SHELL FOR DIR READS
"RTN","PSOTALK1",22,0)
 N X,Y,DIRUT,DIROUT,DTOUT,DUOUT,DIR,ZREAD
"RTN","PSOTALK1",23,0)
 S DIR(0)=ZDIR0 S:$G(ZDIRA)]"" DIR("A")=ZDIRA S:$G(ZDIRB)]"" DIR("B")=ZDIRB
"RTN","PSOTALK1",24,0)
 D ^DIR K DIR
"RTN","PSOTALK1",25,0)
 S:Y]"" ZREAD=Y
"RTN","PSOTALK1",26,0)
 I $D(DTOUT)!($D(DIRUT)) K ZREAD
"RTN","PSOTALK1",27,0)
 Q $G(ZREAD,"")
"RTN","PSOTALK1",28,0)
 ;
"RTN","PSOTALK1",29,0)
PSOSTALK ; SEE IF SCRIPTALK PATIENT AND PRINTER EXISTS AND IS SET TO AUTO-PRINT
"RTN","PSOTALK1",30,0)
 S PSOSTALK=0
"RTN","PSOTALK1",31,0)
 D AUTO^PSOTALK
"RTN","PSOTALK1",32,0)
 I 'PSOSTALK Q
"RTN","PSOTALK1",33,0)
 D NOW^%DTC S NOW=% K %,%H,%I I $G(RXF)="" S RXF=0 F I=0:0 S I=$O(^PSRX(RX,1,I)) Q:'I  S RXF=I
"RTN","PSOTALK1",34,0)
 S IR=0 F FDA=0:0 S FDA=$O(^PSRX(RX,"L",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOTALK1",35,0)
 S IR=IR+1,^PSRX(RX,"L",0)="^52.032DA^"_IR_"^"_IR
"RTN","PSOTALK1",36,0)
 S ^PSRX(RX,"L",IR,0)=NOW_"^"_$S($G(RXP):99-RXPI,1:RXF)_"^"_"ScripTalk label printed"_$S($G(RXP):" (Partial)",1:"")_$S($G(REPRINT):" (Reprint)",1:"")_"^"_PDUZ_"^"_$G(%ZTIO)
"RTN","PSOTALK1",37,0)
 Q
"RTN","PSOTALK1",38,0)
 ;
"VER")
8.0^22.0
**INSTALL NAME**
PSJ*5.0*194
"BLD",8738,0)
PSJ*5.0*194^INPATIENT MEDICATIONS^0^3150716^y
"BLD",8738,4,0)
^9.64PA^55^1
"BLD",8738,4,55,0)
55
"BLD",8738,4,55,2,0)
^9.641^55.06^2
"BLD",8738,4,55,2,55.01,0)
IV  (sub-file)
"BLD",8738,4,55,2,55.01,1,0)
^9.6411^.09^1
"BLD",8738,4,55,2,55.01,1,.09,0)
SCHEDULE
"BLD",8738,4,55,2,55.06,0)
UNIT DOSE  (sub-file)
"BLD",8738,4,55,2,55.06,1,0)
^9.6411^26^1
"BLD",8738,4,55,2,55.06,1,26,0)
SCHEDULE
"BLD",8738,4,55,222)
y^y^p^^^^n^^n
"BLD",8738,4,55,224)

"BLD",8738,4,"APDD",55,55.01)

"BLD",8738,4,"APDD",55,55.01,.09)

"BLD",8738,4,"APDD",55,55.06)

"BLD",8738,4,"APDD",55,55.06,26)

"BLD",8738,4,"B",55,55)

"BLD",8738,6.3)
42
"BLD",8738,"ABPKG")
n
"BLD",8738,"KRN",0)
^9.67PA^8989.52^19
"BLD",8738,"KRN",.4,0)
.4
"BLD",8738,"KRN",.401,0)
.401
"BLD",8738,"KRN",.402,0)
.402
"BLD",8738,"KRN",.403,0)
.403
"BLD",8738,"KRN",.5,0)
.5
"BLD",8738,"KRN",.84,0)
.84
"BLD",8738,"KRN",3.6,0)
3.6
"BLD",8738,"KRN",3.8,0)
3.8
"BLD",8738,"KRN",9.2,0)
9.2
"BLD",8738,"KRN",9.8,0)
9.8
"BLD",8738,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",8738,"KRN",9.8,"NM",1,0)
PSGORS0^^0^B14383051
"BLD",8738,"KRN",9.8,"NM",2,0)
PSIVEDT1^^0^B113503135
"BLD",8738,"KRN",9.8,"NM",3,0)
PSJDDUT^^0^B78714673
"BLD",8738,"KRN",9.8,"NM",4,0)
PSJHL9^^0^B62691896
"BLD",8738,"KRN",9.8,"NM",5,0)
PSJSV^^0^B26193221
"BLD",8738,"KRN",9.8,"NM","B","PSGORS0",1)

"BLD",8738,"KRN",9.8,"NM","B","PSIVEDT1",2)

"BLD",8738,"KRN",9.8,"NM","B","PSJDDUT",3)

"BLD",8738,"KRN",9.8,"NM","B","PSJHL9",4)

"BLD",8738,"KRN",9.8,"NM","B","PSJSV",5)

"BLD",8738,"KRN",19,0)
19
"BLD",8738,"KRN",19.1,0)
19.1
"BLD",8738,"KRN",101,0)
101
"BLD",8738,"KRN",409.61,0)
409.61
"BLD",8738,"KRN",771,0)
771
"BLD",8738,"KRN",870,0)
870
"BLD",8738,"KRN",8989.51,0)
8989.51
"BLD",8738,"KRN",8989.52,0)
8989.52
"BLD",8738,"KRN",8994,0)
8994
"BLD",8738,"KRN","B",.4,.4)

"BLD",8738,"KRN","B",.401,.401)

"BLD",8738,"KRN","B",.402,.402)

"BLD",8738,"KRN","B",.403,.403)

"BLD",8738,"KRN","B",.5,.5)

"BLD",8738,"KRN","B",.84,.84)

"BLD",8738,"KRN","B",3.6,3.6)

"BLD",8738,"KRN","B",3.8,3.8)

"BLD",8738,"KRN","B",9.2,9.2)

"BLD",8738,"KRN","B",9.8,9.8)

"BLD",8738,"KRN","B",19,19)

"BLD",8738,"KRN","B",19.1,19.1)

"BLD",8738,"KRN","B",101,101)

"BLD",8738,"KRN","B",409.61,409.61)

"BLD",8738,"KRN","B",771,771)

"BLD",8738,"KRN","B",870,870)

"BLD",8738,"KRN","B",8989.51,8989.51)

"BLD",8738,"KRN","B",8989.52,8989.52)

"BLD",8738,"KRN","B",8994,8994)

"BLD",8738,"QDEF")
^^^^NO^^^^^^YES
"BLD",8738,"QUES",0)
^9.62^^
"BLD",8738,"REQB",0)
^9.611^2^2
"BLD",8738,"REQB",1,0)
PSJ*5.0*279^2
"BLD",8738,"REQB",2,0)
PSJ*5.0*83^2
"BLD",8738,"REQB","B","PSJ*5.0*279",1)

"BLD",8738,"REQB","B","PSJ*5.0*83",2)

"FIA",55)
PHARMACY PATIENT
"FIA",55,0)
^PS(55,
"FIA",55,0,0)
55P
"FIA",55,0,1)
y^y^p^^^^n^^n
"FIA",55,0,10)

"FIA",55,0,11)

"FIA",55,0,"RLRO")

"FIA",55,0,"VR")
5.0^PSJ
"FIA",55,55)
1
"FIA",55,55.01)
1
"FIA",55,55.01,.09)

"FIA",55,55.06)
1
"FIA",55,55.06,26)

"MBREQ")
0
"PKG",471,-1)
1^1
"PKG",471,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",471,20,0)
^9.402P^^
"PKG",471,22,0)
^9.49I^1^1
"PKG",471,22,1,0)
5.0^2971215^2990325^66481
"PKG",471,22,1,"PAH",1,0)
194^3150716^1231
"PKG",471,22,1,"PAH",1,1,0)
^^26^26^3150716
"PKG",471,22,1,"PAH",1,1,1,0)
This patch is part of a multi-package build which will remove the number 
"PKG",471,22,1,"PAH",1,1,2,0)
of words restriction in a medication administration schedule when a 
"PKG",471,22,1,"PAH",1,1,3,0)
medication is ordered.  Currently, the Inpatient Pharmacy software 
"PKG",471,22,1,"PAH",1,1,4,0)
allows a maximum of three words when creating a schedule, and Inpatient
"PKG",471,22,1,"PAH",1,1,5,0)
Order Entry is currently designed to accept a maximum of three words.
"PKG",471,22,1,"PAH",1,1,6,0)
This can prevent a medication from being ordered with the intended 
"PKG",471,22,1,"PAH",1,1,7,0)
schedule. If the administration schedule in the ADMINISTRATION SCHEDULE 
"PKG",471,22,1,"PAH",1,1,8,0)
file (#51.1) has a name such as EVERY OTHER DAY and the provider 
"PKG",471,22,1,"PAH",1,1,9,0)
subsequently checks the PRN box in CPRS, the schedule's full name now
"PKG",471,22,1,"PAH",1,1,10,0)
becomes EVERY OTHER DAY PRN.  The Inpatient Order Entry option [PSJ OE]
"PKG",471,22,1,"PAH",1,1,11,0)
will not allow this schedule to process because it now contains four
"PKG",471,22,1,"PAH",1,1,12,0)
words.  The patch will remove the number of words restriction for the
"PKG",471,22,1,"PAH",1,1,13,0)
schedule, but will keep the validation on the overall number of 
"PKG",471,22,1,"PAH",1,1,14,0)
characters allowed for a schedule by Inpatient Order Entry.
"PKG",471,22,1,"PAH",1,1,15,0)
 
"PKG",471,22,1,"PAH",1,1,16,0)
 
"PKG",471,22,1,"PAH",1,1,17,0)
The patch also includes a modification for an issue where an incorrect
"PKG",471,22,1,"PAH",1,1,18,0)
test frequency can be calculated for a Laboratory order.  JCAHO added 
"PKG",471,22,1,"PAH",1,1,19,0)
QOD and QD administration schedule abbreviations to their 
"PKG",471,22,1,"PAH",1,1,20,0)
DO NOT USE list.  Alternate schedules were suggested to replace those
"PKG",471,22,1,"PAH",1,1,21,0)
on the DO NOT USE list.  For example, EVERY OTHER DAY has replaced QOD.  
"PKG",471,22,1,"PAH",1,1,22,0)
The software which interprets Lab order schedules is not calculating a 
"PKG",471,22,1,"PAH",1,1,23,0)
correct schedule when these new alternate schedules are used when 
"PKG",471,22,1,"PAH",1,1,24,0)
ordering a test.  As a result, sites have reported that some tests have 
"PKG",471,22,1,"PAH",1,1,25,0)
been ordered at a different frequency than intended by the provider.
"PKG",471,22,1,"PAH",1,1,26,0)
This has resulted in patients receiving more tests than actually needed. 
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","PSGORS0")
0^1^B14383051
"RTN","PSGORS0",1,0)
PSGORS0 ;BIR/CML3-SCHEDULE PROCESSOR FOR FINISH ; 3/23/11 7:53am
"RTN","PSGORS0",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**25,50,83,116,111,194**;16 DEC 97;Build 42
"RTN","PSGORS0",3,0)
 ;
"RTN","PSGORS0",4,0)
 ; Reference to ^PS(51.1 is supported by DBIA 2177
"RTN","PSGORS0",5,0)
 ; Reference to ^PS(55   is supported by DBIA 2191
"RTN","PSGORS0",6,0)
 ;
"RTN","PSGORS0",7,0)
ENA ; entry point for train option
"RTN","PSGORS0",8,0)
 D ENCV^PSGSETU Q:$D(XQUIT)
"RTN","PSGORS0",9,0)
 F  S (PSGS0Y,PSGS0XT)="" R !!,"Select STANDARD SCHEDULE: ",X:DTIME W:'$T $C(7) S:'$T X="^" Q:"^"[X  D:X?1."?" ENQ^PSGSH I X'?1."?" D EN W:$D(X)[0 $C(7),"  ??" I $D(X)#2,'PSGS0Y,PSGS0XT ;W "  Every ",PSGS0XT," minutes"
"RTN","PSGORS0",10,0)
 K DIC,DIE,PSGS0XT,PSGS0Y,Q,X,Y,PSGDT Q
"RTN","PSGORS0",11,0)
 ;
"RTN","PSGORS0",12,0)
EN3 ;
"RTN","PSGORS0",13,0)
 S PSGST=$P($G(^PS(53.1,DA,0)),"^",7) G EN
"RTN","PSGORS0",14,0)
 ;
"RTN","PSGORS0",15,0)
EN5 ;
"RTN","PSGORS0",16,0)
 S PSGST=$P($G(^PS(55,DA(1),5,DA,0)),"^",7)
"RTN","PSGORS0",17,0)
 ;
"RTN","PSGORS0",18,0)
EN ; validate
"RTN","PSGORS0",19,0)
 ;/I X[""""!($A(X)=45)!(X?.E1C.E)!($L(X," ")>2)!($L(X)>70)!($L(X)<1)!(X["P RN")!(X["PR N") K X Q
"RTN","PSGORS0",20,0)
 ;*194 Allow multi-word schedules
"RTN","PSGORS0",21,0)
 I X[""""!($A(X)=45)!(X?.E1C.E)!($L(X," ")>$S(X["PRN":4,1:3))!($L(X)>70)!($L(X)<1)!(X["P RN")!(X["PR N") K X Q
"RTN","PSGORS0",22,0)
 I X?.E1L.E S X=$$ENLU^PSGMI(X) ; I '$D(PSGOES) W "  (",X,")"
"RTN","PSGORS0",23,0)
 I X["Q0" K X Q
"RTN","PSGORS0",24,0)
 ;
"RTN","PSGORS0",25,0)
ENOS ; order set entry
"RTN","PSGORS0",26,0)
 D ENOS^PSGS0 Q
"RTN","PSGORS0",27,0)
 ;
"RTN","PSGORS0",28,0)
 S (PSGS0XT,PSGS0Y,XT,Y)="" I X["PRN"!(X="ON CALL")!(X="ONCALL")!(X="ON-CALL") G Q
"RTN","PSGORS0",29,0)
 S X0=X I X,X'["X",(X?2.4N1"-".E!(X?2.4N)) D ENCHK S:$D(X) Y=X G Q
"RTN","PSGORS0",30,0)
 I X["@" D DW S:$D(X) Y=$P(X,"@",2) G Q
"RTN","PSGORS0",31,0)
 I $S($D(^PS(51.1,"AC","PSJ",X)):1,1:$E($O(^(X)),1,$L(X))=X) D DIC I XT]"" G Q
"RTN","PSGORS0",32,0)
 I Y'>0,$S(X="NOW":1,X="ONCE":1,X="STAT":1,X="ONE TIME":1,X="ONETIME":1,X="1TIME":1,X="1 TIME":1,X="1-TIME":1,1:X="ONE-TIME") W:'$D(PSGOES) "  (ONCE ONLY)" S Y="",XT="O" G Q
"RTN","PSGORS0",33,0)
 ;CHANGED LINE BELOW TO FIX THE NON-STANDARD SCHEDULES - RSB 2-10-97
"RTN","PSGORS0",34,0)
 ;THE FREQUENCY VARIABLE "PSGS0XT" WAS NOT GETTING SET
"RTN","PSGORS0",35,0)
 ;I $G(PSGSCH)=X S PSGS0Y=$G(PSGAT) Q
"RTN","PSGORS0",36,0)
 S PSGS0Y=$G(PSGAT)
"RTN","PSGORS0",37,0)
 ;
"RTN","PSGORS0",38,0)
NS ;I Y'>0 W:'$D(PSGOES) "  (Nonstandard schedule)" S X=X0,Y=""
"RTN","PSGORS0",39,0)
 ;I Y'>0 S X=X0,Y="",PSJNSS=1
"RTN","PSGORS0",40,0)
 ;I $E(X,1,2)="AD" K X G Q
"RTN","PSGORS0",41,0)
 ;I $E(X,1,3)="BID"!($E(X,1,3)="TID")!($E(X,1,3)="QID") S XT=1440/$F("BTQ",$E(X)) G Q
"RTN","PSGORS0",42,0)
 S:$E(X)="Q" X=$E(X,2,99) S:'X X="1"_X S X1=+X,X=$P(X,+X,2),X2=0 S:X1<0 X1=-X1 S:$E(X)="X" X2=1,X=$E(X,2,99)
"RTN","PSGORS0",43,0)
 ;S XT=$S(X["'":1,(X["D"&(X'["AD"))!(X["AM")!(X["PM")!(X["HS"&(X'["THS")):1440,X["H"&(X'["TH"):60,X["AC"!(X["PC"):480,X["W":10080,X["M":40320,1:-1) I XT<0,Y'>0 K X G Q
"RTN","PSGORS0",44,0)
 S X=X0 I XT S:X2 XT=XT\X1 I 'X2 S:X["QO" XT=XT*2 S XT=XT*X1
"RTN","PSGORS0",45,0)
 ;
"RTN","PSGORS0",46,0)
Q ;
"RTN","PSGORS0",47,0)
 S PSGS0XT=$S(XT]"":XT,1:""),PSGS0Y=$S(Y:Y,1:"")
"RTN","PSGORS0",48,0)
 I $G(PSJNSS),$G(PSGS0XT)>0,($G(VALMBCK)'="Q") D
"RTN","PSGORS0",49,0)
 . I $G(PSGOES),$G(PSGS0XT)>0,($G(VALMBCK)'="Q"),'$G(NSFF) D NSSCONT^PSGS0(X,PSGS0XT) Q
"RTN","PSGORS0",50,0)
 K QX,SDW,SWD,X0,XT,Z,NSFF Q
"RTN","PSGORS0",51,0)
 ;
"RTN","PSGORS0",52,0)
ENCHK ;
"RTN","PSGORS0",53,0)
 I $S($L($P(X,"-"))>4:1,$L(X)>119:1,$L(X)<2:1,X'>0:1,1:X'?.ANP) K X Q
"RTN","PSGORS0",54,0)
 S X(1)=$P(X,"-") I X(1)'?2N,X(1)'?4N K X Q
"RTN","PSGORS0",55,0)
 S X(1)=$L(X(1)) I X'["-",X>$E(2400,1,X(1)) K X Q
"RTN","PSGORS0",56,0)
 F X(2)=2:1:$L(X,"-") S X(3)=$P(X,"-",X(2)) I $S($L(X(3))'=X(1):1,X(3)>$E(2400,1,X(1)):1,1:X(3)'>$P(X,"-",X(2)-1)) K X Q
"RTN","PSGORS0",57,0)
 K:$D(X) X(1),X(2),X(3) Q
"RTN","PSGORS0",58,0)
 ;
"RTN","PSGORS0",59,0)
DIC ;
"RTN","PSGORS0",60,0)
 S Y="" F TEST=0:0 S TEST=$O(^PS(51.1,"APPSJ",X,TEST)) Q:'TEST!(Y]"")  D
"RTN","PSGORS0",61,0)
 .I $G(PSGST)="O",$P($G(^PS(51.1,TEST,0)),U,5)'="O" Q
"RTN","PSGORS0",62,0)
 .S:$D(^PS(51.1,TEST,0)) Y=TEST
"RTN","PSGORS0",63,0)
 Q:Y=""  K DIC S X="`"_Y,DIC="^PS(51.1,",DIC(0)="XISZ",D="APPSJ"
"RTN","PSGORS0",64,0)
 D IX^DIC K DIC S:$D(DIE)#2 DIC=DIE Q:Y'>0
"RTN","PSGORS0",65,0)
 S XT=$S("C"[$P(Y(0),"^",5):$P(Y(0),"^",3),1:$P(Y(0),"^",5)),X=+Y,Y="" I $D(PSJPWD),$D(^PS(51.1,X,1,+PSJPWD,0)) S Y=$P(^(0),"^",2)
"RTN","PSGORS0",66,0)
 S (X,X0)=Y(0,0) S:Y="" Y=$P(Y(0),"^",2) Q
"RTN","PSGORS0",67,0)
DW ;
"RTN","PSGORS0",68,0)
 S SWD="SUNDAYS^MONDAYS^TUESDAYS^WEDNESDAYS^THURSDAYS^FRIDAYS^SATURDAYS",SDW=X,X=$P(X,"@",2) D ENCHK Q:'$D(X)  S X=$P(SDW,"@"),X(1)="-" I X?.E1P.E,X'["-" F QX=1:1:$L(X) I $E(X,QX)?1P S X(1)=$E(X,QX) Q
"RTN","PSGORS0",69,0)
 F Q=1:1:$L(X,X(1)) K:SWD="" X Q:SWD=""  S Z=$P(X,X(1),Q) D DWC Q:'$D(X)
"RTN","PSGORS0",70,0)
 K X(1) S:$D(X) X=SDW Q
"RTN","PSGORS0",71,0)
DWC I $L(Z)<2 K X Q
"RTN","PSGORS0",72,0)
 F QX=1:1:$L(SWD,"^") S Y=$P(SWD,"^",QX) I $P(Y,Z)="" S SWD=$P(SWD,Y,2) S:$L(SWD) SWD=$E(SWD,2,50) Q
"RTN","PSGORS0",73,0)
 E  K X
"RTN","PSGORS0",74,0)
 Q
"RTN","PSIVEDT1")
0^2^B113503135
"RTN","PSIVEDT1",1,0)
PSIVEDT1 ;BIR/MLM-EDIT IV ORDER (CONT) ;2/14/12 7:20am
"RTN","PSIVEDT1",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**3,7,41,47,50,64,58,116,110,111,113,267,279,305,194**;16 DEC 97;Build 42
"RTN","PSIVEDT1",3,0)
 ;
"RTN","PSIVEDT1",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSIVEDT1",5,0)
 ; Reference to ^PS(51.1 is supported by DBIA# 2177.
"RTN","PSIVEDT1",6,0)
 ;
"RTN","PSIVEDT1",7,0)
10 ; Start Date
"RTN","PSIVEDT1",8,0)
 D:'P(2)&P("IVRM")!($G(PSJREN)) ENT^PSIVCAL
"RTN","PSIVEDT1",9,0)
A10 I $G(P("RES"))="R" I $G(ON)["P",$P($G(^PS(53.1,+ON,0)),"^",24)="R" D  Q
"RTN","PSIVEDT1",10,0)
 . Q:'$G(PSIVRENW)  W !!?5,"This is a Renewal Order. Start Date may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT1",11,0)
 I $G(ON)["V"!($G(ON)["U") I $$COMPLEX^PSJOE(DFN,ON) D  Q
"RTN","PSIVEDT1",12,0)
 .Q:$G(PSJBKDR)  W !!?5,"This is a Complex Order. Start Date may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT1",13,0)
 S Y=P(2) X ^DD("DD") W !,"START DATE/TIME: "_$S(Y]"":Y_"// ",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 I $E(X)=U!(P(2)&X="") Q
"RTN","PSIVEDT1",14,0)
 I X["???",($E(P("OT"))="I"),(PSIVAC["C") D ORFLDS G 10
"RTN","PSIVEDT1",15,0)
 I X="@"!(X?1."?") W:X="@" $C(7),"  (Required)" S F1=53.1,F2=10 S:X="@" X="?" D ENHLP^PSIVORC1 G A10
"RTN","PSIVEDT1",16,0)
 K %DT S:X="" X=P(2) S %DT="ERTX" D ^%DT K %DT G:Y'>0 A10
"RTN","PSIVEDT1",17,0)
 I $G(P("RES"))="R",(+Y<+$P($G(^PS(55,DFN,"IV",+$G(P("OLDON")),0)),U,2)) D  G 10
"RTN","PSIVEDT1",18,0)
 .; naked ref below refers to line above
"RTN","PSIVEDT1",19,0)
 .S Y=$P(^(0),U,2) X ^DD("DD") W $C(7),!!,"Start date of order being renewed is ",Y,".",!,"Start date of renewal order must be AFTER start date of order being renewed.",!
"RTN","PSIVEDT1",20,0)
 S X1=$G(P("LOG")),X2=-7 D C^%DTC I +Y<X W !!,"Start date/time may not be entered prior to 7 days from the order's LOGIN DATE.",! D A10
"RTN","PSIVEDT1",21,0)
 S P(2)=+Y,PSGSDX=1
"RTN","PSIVEDT1",22,0)
 Q
"RTN","PSIVEDT1",23,0)
 ;
"RTN","PSIVEDT1",24,0)
25 ; Stop Date
"RTN","PSIVEDT1",25,0)
 G:$D(PSGFDX) A25
"RTN","PSIVEDT1",26,0)
 I P("IVRM")]"",$S(P(3)<P(2):1,$G(PSIVAC)["E":0,1:1) S PSIVSITE=$G(^PS(59.5,+P("IVRM"),1)),$P(PSIVSITE,"^",20,21)=$G(^PS(59.5,+P("IVRM"),5)) D ENSTOP^PSIVCAL
"RTN","PSIVEDT1",27,0)
A25 I $G(ON)["V"!($G(ON)["U") I $$COMPLEX^PSJOE(DFN,ON) D  Q
"RTN","PSIVEDT1",28,0)
 .Q:$G(PSJBKDR)  W !!?5,"This is a Complex Order. Stop Date may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT1",29,0)
 S Y=P(3) X ^DD("DD") W !,"STOP DATE/TIME: "_$S(Y]"":Y_"// ",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 Q:X=""&P(2)  I $E(X)=U!(X=""&P(2)) Q
"RTN","PSIVEDT1",30,0)
 I X["???",($E(P("OT"))="I"),(PSIVAC["C") D ORFLDS G 25
"RTN","PSIVEDT1",31,0)
 I X="@"!(X["?") W $C(7),"  (Required)" S F1=53.1,F2=25,X="?" D ENHLP^PSIVORC1 G A25
"RTN","PSIVEDT1",32,0)
 K %DT S:X="" X=$G(Y) S:X="" X=P(3) S %DT="ERTX" D:X'=+X ^%DT
"RTN","PSIVEDT1",33,0)
 I X=+X,X>0,X'>2000000 G A25:'$$ENDL^PSGDL(P(9),X) D ENDL^PSIVSP
"RTN","PSIVEDT1",34,0)
 D DOSE
"RTN","PSIVEDT1",35,0)
 I $G(X)="" S X=Y
"RTN","PSIVEDT1",36,0)
 I $G(X)="" S X=P(3)
"RTN","PSIVEDT1",37,0)
 I $G(Z)]"",Z>X D  G A25
"RTN","PSIVEDT1",38,0)
 . W !,"There is no administration time that falls between the Start Date/Time"
"RTN","PSIVEDT1",39,0)
 . W !,"and Stop Date/Time.",!
"RTN","PSIVEDT1",40,0)
 S X=Y S:Y<1!Y'["." X="" G:Y'>0 A25 S P(3)=+Y,PSGFDX=1
"RTN","PSIVEDT1",41,0)
 Q
"RTN","PSIVEDT1",42,0)
 ;
"RTN","PSIVEDT1",43,0)
26 ; Schedule
"RTN","PSIVEDT1",44,0)
 I $G(P("RES"))="R" I $G(ON)["P",$P($G(^PS(53.1,+ON,0)),"^",24)="R" D  Q
"RTN","PSIVEDT1",45,0)
 . Q:'$G(PSIVRENW)  W !!?5,"This is a Renewal Order. Schedule may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT1",46,0)
 I $G(ON)["V"!($G(ON)["U") I $$COMPLEX^PSJOE(DFN,ON) D  Q
"RTN","PSIVEDT1",47,0)
 .Q:$G(PSJBKDR)  W !!?5,"This is a Complex Order. Schedule may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT1",48,0)
 W !,"SCHEDULE: ",$S(P(9)]"":P(9)_"// ",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 I $E(X)=U!(X="") Q
"RTN","PSIVEDT1",49,0)
 I X="@" D DEL^PSIVEDRG S:%=1 P(9)="" G 26
"RTN","PSIVEDT1",50,0)
 I '$$SCHREQ^PSJLIVFD(.P) S P(7)="" I $P(X,"@",2)=0 D  G 26
"RTN","PSIVEDT1",51,0)
 .W $C(7),!!?2,"'@0' is not permitted for Continuous IV's",!
"RTN","PSIVEDT1",52,0)
 I X["???",($E(P("OT"))="I"),(PSIVAC["C") D ORFLDS G 26
"RTN","PSIVEDT1",53,0)
 ;*194 Allow multi-word schedules
"RTN","PSIVEDT1",54,0)
 I X?1."?"!($L(X)>22)!($L(X," ")>$S(X["PRN":4,1:3)) S F1=55.01,F2=.09 D ENHLP^PSIVORC1 G 26
"RTN","PSIVEDT1",55,0)
 S CHG=0 I P(9)]"",X'=P(9) S CHG=1
"RTN","PSIVEDT1",56,0)
 S P(7)="" K PSGOES D EN^PSIVSP S:XT<0 X="" I $G(X)="" W $C(7),"??" G 26
"RTN","PSIVEDT1",57,0)
 I CHG D
"RTN","PSIVEDT1",58,0)
 . S P(9)=X,P(11)=Y,P(15)=XT
"RTN","PSIVEDT1",59,0)
 . I $$ODD^PSGS0(P(15)) S P(11)=""
"RTN","PSIVEDT1",60,0)
 . W !!?5,"This change in schedule also changes the Administration Times and Schedule Type of this order."
"RTN","PSIVEDT1",61,0)
 . S DIR("A")="Enter RETURN to continue or '^' to exit:"
"RTN","PSIVEDT1",62,0)
 . D PAUSE^VALM1
"RTN","PSIVEDT1",63,0)
 K CHG
"RTN","PSIVEDT1",64,0)
 Q
"RTN","PSIVEDT1",65,0)
 ;
"RTN","PSIVEDT1",66,0)
39 ; Admin Times
"RTN","PSIVEDT1",67,0)
 S ORIG=$G(P(11))
"RTN","PSIVEDT1",68,0)
A39 I $G(P("RES"))="R" I $G(ON)["P",($P($G(^PS(53.1,+ON,0)),"^",24)="R") D  Q
"RTN","PSIVEDT1",69,0)
 . Q:'$G(PSIVRENW)  W !!?5,"This is a Renewal Order. Administration times may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT1",70,0)
 I $G(ON)["V"!($G(ON)["U") I $$COMPLEX^PSJOE(DFN,ON) D  Q
"RTN","PSIVEDT1",71,0)
 .Q:$G(PSJBKDR)  W !!?5,"This is a Complex Order. Admin Times may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT1",72,0)
 I $G(P(9))=""!($G(P(9))[" PRN")!($G(P(9))="PRN") Q  ;No schedule or PRN schedule
"RTN","PSIVEDT1",73,0)
 I $$ODD^PSGS0(P(15)) S P(11)="" Q
"RTN","PSIVEDT1",74,0)
 W !,"ADMINISTRATION TIMES: ",$S(P(11)]"":P(11)_"//",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 I '($G(P(15))="D"&'DONE) I $E(X)=U S (X,P(11))=ORIG Q
"RTN","PSIVEDT1",75,0)
 I X="",P(11)]"" S X=P(11)
"RTN","PSIVEDT1",76,0)
 I ($G(P(15))="D"!($G(P(9))["@"))&('$G(X)!(X["@")) W $C(7),"  ??" S X="?" W:(P(15)="D"!(X["@")) !,"This is a 'DAY OF THE WEEK' schedule and MUST have admin times." G A39
"RTN","PSIVEDT1",77,0)
 I X="@" D DEL^PSIVEDRG S:%=1 P(11)="" G A39
"RTN","PSIVEDT1",78,0)
 I X?1."?" D ENHLP^PSGOEM(53.1,39) G A39
"RTN","PSIVEDT1",79,0)
 I X["???",($E(P("OT"))="I"),(PSIVAC["C") D ORFLDS G A39
"RTN","PSIVEDT1",80,0)
 I $G(P(15))'="D",$G(P(15))'="P",'$$ONCALL(P(9)) D TIMES I '$D(X) G A39
"RTN","PSIVEDT1",81,0)
 K:X[""""!($A(X)=45) X W:$G(X)="^"!('$D(X)) $C(7),"  ??" G:$G(X)="^"!('$D(X)) A39 S P(11)=X D:$G(PSIVCAL) ENT^PSIVCAL,ENSTOP^PSIVCAL K PSIVCAL
"RTN","PSIVEDT1",82,0)
 Q
"RTN","PSIVEDT1",83,0)
 ;
"RTN","PSIVEDT1",84,0)
59 ; Infusion Rate
"RTN","PSIVEDT1",85,0)
 ;*305
"RTN","PSIVEDT1",86,0)
 N P8BADDEF S P8BADDEF=0 K PSJEXMSG
"RTN","PSIVEDT1",87,0)
 I $G(P("RES"))="R" I $G(ON)["P",$P($G(^PS(53.1,+ON,0)),"^",24)="R" D  Q
"RTN","PSIVEDT1",88,0)
 . Q:'$G(PSIVRENW)  W !!?5,"This is a Renewal Order. Infusion Rate may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT1",89,0)
 W !,"INFUSION RATE: ",$S(P(8)]"":$P(P(8),"@")_"//",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 I $S($E(X)=U:1,X]"":0,1:P(8)]"") D:'$G(DONE) EXPINF(.X) D:'$G(DONE) NUMLAB(.P) G:$G(P8BADDEF) 59 Q
"RTN","PSIVEDT1",90,0)
 S X=$TR(X,$C(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,127)) ; Strip out control characters
"RTN","PSIVEDT1",91,0)
 I ((P(4)="P")!((P(4)="C")&(P(23)="P"))!(("C^S"[P(4))&(P(5)=1)))&(X["@") D  G 59
"RTN","PSIVEDT1",92,0)
 .W $C(7),!!?2,"'@' is not permitted for Intermittent IV's",!
"RTN","PSIVEDT1",93,0)
 I (X["^") D  G 59
"RTN","PSIVEDT1",94,0)
 .W $C(7),!!?2,"'^' is not permitted",!
"RTN","PSIVEDT1",95,0)
 I X=""&((P(4)="P")!((P(4)="C")&(P(23)="P"))!(("C^S"[P(4))&(P(5)=1))) Q
"RTN","PSIVEDT1",96,0)
 I X="@" D DEL^PSIVEDRG S:%=1 P(8)="" G 59
"RTN","PSIVEDT1",97,0)
 I X["???",($E(P("OT"))="I"),(PSIVAC["C") D ORFLDS G 59
"RTN","PSIVEDT1",98,0)
 I X["?" S F1=53.1,F2=59 D ENHLP^PSIVORC1 G 59
"RTN","PSIVEDT1",99,0)
 D EXPINF(.X)
"RTN","PSIVEDT1",100,0)
 I ($L(X)>30!($L(X)=1)),(X'?1N) D  G 59
"RTN","PSIVEDT1",101,0)
 .W $C(7),!!?3,"Free text entries must contain a minimum of 2 characters",!?3,"and a maximum of 30 characters",!
"RTN","PSIVEDT1",102,0)
 I X]"" D ENI^PSIVSP W:'$D(X) $C(7)," ??" G:'$D(X) 59 S P(8)=X
"RTN","PSIVEDT1",103,0)
 I P(8)="" W $C(7),!!,"An infusion rate must be entered!" G 59
"RTN","PSIVEDT1",104,0)
 D NUMLAB(.P)
"RTN","PSIVEDT1",105,0)
 Q
"RTN","PSIVEDT1",106,0)
 ;
"RTN","PSIVEDT1",107,0)
NUMLAB(P) ; Prompt for Number of Labels
"RTN","PSIVEDT1",108,0)
 N PSJILBS
"RTN","PSIVEDT1",109,0)
NUMLAB2 ; Loop ;*305
"RTN","PSIVEDT1",110,0)
 ; Quit if no Infusion Rate
"RTN","PSIVEDT1",111,0)
 Q:($G(P(8))="")
"RTN","PSIVEDT1",112,0)
 I ((P(4)="P")!((P(4)="C")&(P(23)="P"))!(("C^S"[P(4))&(P(5)=1))) D  Q
"RTN","PSIVEDT1",113,0)
 .I $G(X)="",$G(P(8))["@" S P(8)=$P(P(8),"@")
"RTN","PSIVEDT1",114,0)
 K DIR S PSJILBS=$P($G(P(8)),"@",2) S:'(PSJILBS?1.N) PSJILBS=$G(P("NUMLBL")) I $G(PSJILBS)?1.N S DIR("B")=PSJILBS
"RTN","PSIVEDT1",115,0)
 D NLBHLP(1)
"RTN","PSIVEDT1",116,0)
 S DIR(0)="FAO",DIR("A")="NUMBER OF LABELS PER DAY: " D ^DIR Q:X="^"
"RTN","PSIVEDT1",117,0)
 I X="@" D DEL^PSIVEDRG S:%=1 P("NUMLBL")="",P(8)=$P(P(8),"@") G NUMLAB2
"RTN","PSIVEDT1",118,0)
 I X?1."?" D NLBHLP G NUMLAB2
"RTN","PSIVEDT1",119,0)
 I X?1.2N S P("NUMLBL")=+X,P(8)=$P(P(8),"@")_"@"_P("NUMLBL") Q
"RTN","PSIVEDT1",120,0)
 I X="",(P(8)'?1N.N.1".".1N1" ml/hr") D  G NUMLAB2
"RTN","PSIVEDT1",121,0)
 .W $C(7),!!,"Number of Labels is required for continuous IV's with free text Infusion Rate.",!
"RTN","PSIVEDT1",122,0)
 Q:X=""
"RTN","PSIVEDT1",123,0)
 I X'?1.2N D  G NUMLAB2
"RTN","PSIVEDT1",124,0)
 .W $C(7),!!,"Type a number between 0 and 99, 0 decimal digits",!
"RTN","PSIVEDT1",125,0)
 Q
"RTN","PSIVEDT1",126,0)
 ;
"RTN","PSIVEDT1",127,0)
63 ; Remarks
"RTN","PSIVEDT1",128,0)
 N DIR S X="",DIR(0)="53.1,63" S:P("REM")]"" DIR("B")=P("REM") D ^DIR I X="^"!$D(DTOUT) S DONE=1 Q
"RTN","PSIVEDT1",129,0)
 I X="@" D DEL^PSIVEDRG S:%=1 P("REM")="" G 63
"RTN","PSIVEDT1",130,0)
 I X]"",$E(X)'="^" S P("REM")=X
"RTN","PSIVEDT1",131,0)
 Q
"RTN","PSIVEDT1",132,0)
 ;
"RTN","PSIVEDT1",133,0)
64 ; Other Print Info
"RTN","PSIVEDT1",134,0)
 N OPIMSG,PSJOPILN,PSJOPIT,PSJTMPTX,TMPLIN,PSJOVRMX
"RTN","PSIVEDT1",135,0)
 S PSJOPILN=$$EDITOPI^PSJBCMA5(DFN) S OPIMSG="Instructions too long. See Order View or BCMA for full text."
"RTN","PSIVEDT1",136,0)
 S PSJTMPTX="",PSJOVRMX=0
"RTN","PSIVEDT1",137,0)
 S TMPLIN=0 F  S TMPLIN=$O(^PS(53.45,$G(PSJSYSP),6,TMPLIN)) Q:'TMPLIN!PSJOVRMX  D
"RTN","PSIVEDT1",138,0)
 .S:($L(PSJTMPTX)+$L($G(^PS(53.45,$G(DUZ),6,TMPLIN,0))))>60 PSJOVRMX=1 Q:$G(PSJOVRMX)  D
"RTN","PSIVEDT1",139,0)
 ..S PSJTMPTX=$G(PSJTMPTX)_$S($L($G(PSJTMPTX)):" ",1:"")_$G(^PS(53.45,$G(DUZ),6,TMPLIN,0))
"RTN","PSIVEDT1",140,0)
 S PSJTMPTX=$S($G(PSJOVRMX):OPIMSG,1:$G(PSJTMPTX))
"RTN","PSIVEDT1",141,0)
 S P("OPI")=PSJTMPTX I (PSJOPILN>0) S P("OPI")=$$ENBCMA^PSJUTL("V")
"RTN","PSIVEDT1",142,0)
 Q
"RTN","PSIVEDT1",143,0)
 ;
"RTN","PSIVEDT1",144,0)
ORFLDS ; Display OE/RR fields during edit.
"RTN","PSIVEDT1",145,0)
 D FULL^VALM1
"RTN","PSIVEDT1",146,0)
 W !!,"Orderable Item: ",$P(P("PD"),U,2),!,"Give: ",$P(P("MR"),U,2)," ",P(9),!!
"RTN","PSIVEDT1",147,0)
 Q
"RTN","PSIVEDT1",148,0)
 ;
"RTN","PSIVEDT1",149,0)
TIMES ;At least one admin time, not more than interval allows.
"RTN","PSIVEDT1",150,0)
 I $G(P(15)) Q:$$ODD^PSGS0(P(15))
"RTN","PSIVEDT1",151,0)
 I $G(P(15))="C"!$$CONTIN($G(P(9))) I '$$ONCALL($G(P(9))),X="" W !,"This order requires at least one administration time." K X Q  ;No times
"RTN","PSIVEDT1",152,0)
 N H,I,MAX
"RTN","PSIVEDT1",153,0)
 I $G(P(15))="O"!$$ONETIME($G(P(9))) I $L(X,"-")>1 W !," This is a One Time Order - only one administration time is permitted." K X Q
"RTN","PSIVEDT1",154,0)
 I $G(P(15))="O"!$$ONETIME($G(P(9))) Q  ;Done validating One Time
"RTN","PSIVEDT1",155,0)
 I $G(P(9))]"" S H=+$O(^PS(51.1,"B",P(9),0)) S I=$P($G(^PS(51.1,H,0)),"^",3)
"RTN","PSIVEDT1",156,0)
 I +I=0 Q  ;No frequency - can not check frequency related items
"RTN","PSIVEDT1",157,0)
 S MAX=1440/I
"RTN","PSIVEDT1",158,0)
 I MAX<1,$L(X,"-")>1 W !,"This order requires one administration time." K X Q
"RTN","PSIVEDT1",159,0)
 I MAX'<1,$L(X,"-")>MAX W !,"The number of admin times entered is greater than indicated by the schedule." K X Q  ;Too many times
"RTN","PSIVEDT1",160,0)
 I MAX'<1,$L(X,"-")<MAX D  ;Too few times
"RTN","PSIVEDT1",161,0)
 . W !,"The number of admin times entered is fewer than indicated by the schedule."
"RTN","PSIVEDT1",162,0)
 . N X,DIR
"RTN","PSIVEDT1",163,0)
 . D PAUSE^VALM1
"RTN","PSIVEDT1",164,0)
 Q
"RTN","PSIVEDT1",165,0)
 ;
"RTN","PSIVEDT1",166,0)
DOSE ;Make certain at least one dose is given.
"RTN","PSIVEDT1",167,0)
 N INFO,Y,PNINE
"RTN","PSIVEDT1",168,0)
 S PNINE=P(9)
"RTN","PSIVEDT1",169,0)
 S INFO=$G(P(2))_U_$G(P(3))_U_$G(P(9))_U_$P($G(PSGZZND),"^",5)_U_$P($G(P("PD")),"^")_U_$G(P(11))
"RTN","PSIVEDT1",170,0)
 I '$L($G(PSGP)) N PSGP S PSGP=""
"RTN","PSIVEDT1",171,0)
 S Z=$$ENQ^PSJORP2(PSGP,INFO)  ;Expected first dose.
"RTN","PSIVEDT1",172,0)
 S P(9)=PNINE
"RTN","PSIVEDT1",173,0)
 Q
"RTN","PSIVEDT1",174,0)
 ;
"RTN","PSIVEDT1",175,0)
ONCALL(SCHD) ; Check if a schedule is type On Call (all schedules with a given name must have the same schedule type)
"RTN","PSIVEDT1",176,0)
 N NXT,SCHARR
"RTN","PSIVEDT1",177,0)
 S OCCHK=0
"RTN","PSIVEDT1",178,0)
 Q:$G(SCHD)="" OCCHK
"RTN","PSIVEDT1",179,0)
 Q:'$D(^PS(51.1,"APPSJ",SCHD)) OCCHK
"RTN","PSIVEDT1",180,0)
 S NXT=0 F  S NXT=$O(^PS(51.1,"APPSJ",SCHD,NXT)) Q:'NXT  S TYP=$P($G(^PS(51.1,+NXT,0)),"^",5) S:TYP]"" SCHARR(TYP)=""
"RTN","PSIVEDT1",181,0)
 I '$D(SCHARR("OC")) S OCCHK=0 Q OCCHK
"RTN","PSIVEDT1",182,0)
 I $O(SCHARR("OC"))]""!($O(SCHARR("OC"),-1)]"") S OCCHK=0 Q OCCHK
"RTN","PSIVEDT1",183,0)
 I $D(SCHARR("OC")) S OCCHK=1
"RTN","PSIVEDT1",184,0)
 Q OCCHK
"RTN","PSIVEDT1",185,0)
 ;
"RTN","PSIVEDT1",186,0)
ONETIME(SCHD) ; Check if a schedule is type On Call (all schedules with a given name must have the same schedule type)
"RTN","PSIVEDT1",187,0)
 N NXT,SCHARR
"RTN","PSIVEDT1",188,0)
 S OCCHK=0
"RTN","PSIVEDT1",189,0)
 Q:$G(SCHD)="" OCCHK
"RTN","PSIVEDT1",190,0)
 Q:'$D(^PS(51.1,"APPSJ",SCHD)) OCCHK
"RTN","PSIVEDT1",191,0)
 S NXT=0 F  S NXT=$O(^PS(51.1,"APPSJ",SCHD,NXT)) Q:'NXT  S TYP=$P($G(^PS(51.1,+NXT,0)),"^",5) S:TYP]"" SCHARR(TYP)=""
"RTN","PSIVEDT1",192,0)
 I '$D(SCHARR("O")) S OCCHK=0 Q OCCHK
"RTN","PSIVEDT1",193,0)
 I $O(SCHARR("O"))]""!($O(SCHARR("O"),-1)]"") S OCCHK=0 Q OCCHK
"RTN","PSIVEDT1",194,0)
 I $D(SCHARR("O")) S OCCHK=1
"RTN","PSIVEDT1",195,0)
 Q OCCHK
"RTN","PSIVEDT1",196,0)
 ;
"RTN","PSIVEDT1",197,0)
CONTIN(SCHD) ; Check if a schedule is type On Call (all schedules with a given name must have the same schedule type)
"RTN","PSIVEDT1",198,0)
 N NXT,SCHARR
"RTN","PSIVEDT1",199,0)
 S OCCHK=0
"RTN","PSIVEDT1",200,0)
 Q:$G(SCHD)="" OCCHK
"RTN","PSIVEDT1",201,0)
 Q:'$D(^PS(51.1,"APPSJ",SCHD)) OCCHK
"RTN","PSIVEDT1",202,0)
 S NXT=0 F  S NXT=$O(^PS(51.1,"APPSJ",SCHD,NXT)) Q:'NXT  S TYP=$P($G(^PS(51.1,+NXT,0)),"^",5) S:TYP]"" SCHARR(TYP)=""
"RTN","PSIVEDT1",203,0)
 I '$D(SCHARR("C")) S OCCHK=0 Q OCCHK
"RTN","PSIVEDT1",204,0)
 I $O(SCHARR("C"))]""!($O(SCHARR("C"),-1)]"") S OCCHK=0 Q OCCHK
"RTN","PSIVEDT1",205,0)
 I $D(SCHARR("C")) S OCCHK=1
"RTN","PSIVEDT1",206,0)
 Q OCCHK
"RTN","PSIVEDT1",207,0)
 ;
"RTN","PSIVEDT1",208,0)
NLBHLP(OUT) ; Help text for Number of Labels per day
"RTN","PSIVEDT1",209,0)
 I OUT=1 D  Q
"RTN","PSIVEDT1",210,0)
 .S DIR("?",1)="Enter the # of labels per day that will be needed."
"RTN","PSIVEDT1",211,0)
 .S DIR("?",2)=""
"RTN","PSIVEDT1",212,0)
 .S DIR("?",3)="Example:   0 = 0 labels per day."
"RTN","PSIVEDT1",213,0)
 .S DIR("?",4)="           2 = 2 labels per day."
"RTN","PSIVEDT1",214,0)
 .S DIR("?",5)="Note:  Number of Labels per day is required for continuous IV orders"
"RTN","PSIVEDT1",215,0)
 .S DIR("?",6)="       with free text Infusion Rate. Number of labels per day is not"
"RTN","PSIVEDT1",216,0)
 .S DIR("?",7)="       permitted for Intermittent (IVPB) type orders; for Intermittent"
"RTN","PSIVEDT1",217,0)
 .S DIR("?",8)="       orders, the schedule and administration time(s) will be used to"
"RTN","PSIVEDT1",218,0)
 .S DIR("?")="       determine the number of labels needed."
"RTN","PSIVEDT1",219,0)
 ;
"RTN","PSIVEDT1",220,0)
 W !,"Enter the # of labels per day that will be needed."
"RTN","PSIVEDT1",221,0)
 W !,"Example:   0 = 0 labels per day."
"RTN","PSIVEDT1",222,0)
 W !,"           2 = 2 labels per day."
"RTN","PSIVEDT1",223,0)
 W !!,"Note: Number of Labels per day is required for continuous IV orders"
"RTN","PSIVEDT1",224,0)
 W !,"       with free text Infusion Rate. Number of labels per day is not"
"RTN","PSIVEDT1",225,0)
 W !,"       permitted for Intermittent (IVPB) type orders; for Intermittent"
"RTN","PSIVEDT1",226,0)
 W !,"       orders, the schedule and administration time(s) will be used to"
"RTN","PSIVEDT1",227,0)
 W !,"       determine the number of labels needed."
"RTN","PSIVEDT1",228,0)
 Q
"RTN","PSIVEDT1",229,0)
 ;
"RTN","PSIVEDT1",230,0)
EXPINF(P8,SILENT) ; Expand Infusion Rate
"RTN","PSIVEDT1",231,0)
 ;*305
"RTN","PSIVEDT1",232,0)
 Q:$G(P8)!($G(PSJEXMSG))  N P8TMP S P8TMP=$$UP^XLFSTR($P(P8,"@"))
"RTN","PSIVEDT1",233,0)
 N EXPANDED S EXPANDED="" D INFCHK^PSJLIVFD(P8TMP,.EXPANDED)
"RTN","PSIVEDT1",234,0)
 I (EXPANDED=$P(P8,"@"))!(EXPANDED=P8TMP) Q
"RTN","PSIVEDT1",235,0)
 S PSJEXMSG=1 I '$G(SILENT) W "     Now expanding text"
"RTN","PSIVEDT1",236,0)
 I P8["@" S $P(P8,"@")=EXPANDED
"RTN","PSIVEDT1",237,0)
 I P8'["@" S P8=EXPANDED
"RTN","PSIVEDT1",238,0)
 I '$G(SILENT) W:$G(PSJEXMSG) !," Input expanded to ",EXPANDED
"RTN","PSIVEDT1",239,0)
 Q
"RTN","PSJDDUT")
0^3^B78714673
"RTN","PSJDDUT",1,0)
PSJDDUT ;BIR/LDT-INPATIENT MEDICATIONS DD UTILITY ; 3/23/11 7:55am
"RTN","PSJDDUT",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**40,44,50,83,116,111,113,194**;16 DEC 97;Build 42
"RTN","PSJDDUT",3,0)
 ;
"RTN","PSJDDUT",4,0)
 ; Reference to ^PS(51 is supported by DBIA# 2176.
"RTN","PSJDDUT",5,0)
 ; Reference to ^PS(51.1 is supported by DBIA# 2177.
"RTN","PSJDDUT",6,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJDDUT",7,0)
 ; 
"RTN","PSJDDUT",8,0)
SPCIN ;Called from Non-Verified Orders File (53.1), Special Instructions
"RTN","PSJDDUT",9,0)
 ;field 8
"RTN","PSJDDUT",10,0)
 S PSJHLP(1)="IF ABBREVIATIONS ARE USED, THE TOTAL LENGTH OF THE EXPANDED"
"RTN","PSJDDUT",11,0)
 S PSJHLP(2)="INSTRUCTIONS ALSO MAY NOT BE LONGER THAN 180 CHARACTERS."
"RTN","PSJDDUT",12,0)
 D WRITE
"RTN","PSJDDUT",13,0)
 Q
"RTN","PSJDDUT",14,0)
CHKSI ;Called from Non-Verified Orders File (53.1), Special Instructions
"RTN","PSJDDUT",15,0)
 ;field 8 (Replaces ^PSGSICHK)
"RTN","PSJDDUT",16,0)
 I $S(X'?.ANP:1,X["^":1,1:$L(X)>180) K X Q
"RTN","PSJDDUT",17,0)
 N Y S Y="" F Y(1)=1:1:$L(X," ") S Y(2)=$P(X," ",Y(1)) I Y(2)]"" D CHK1 Q:'$D(X)
"RTN","PSJDDUT",18,0)
 I $D(X),Y]"",X'=$E(Y,1,$L(Y)-1) D EN^DDIOL("EXPANDS TO:","","!?3") F Y(1)=1:1 S Y(2)=$P(Y," ",Y(1)) Q:Y(2)=""  D:$L(Y(2))+$X>78 EN^DDIOL("","","!") D EN^DDIOL(Y(2)_" ","","?0")
"RTN","PSJDDUT",19,0)
 K Y Q
"RTN","PSJDDUT",20,0)
CHK1 ;
"RTN","PSJDDUT",21,0)
 I $L(Y(2))<31,$D(^PS(51,+$O(^PS(51,"B",Y(2),0)),0)),$P(^(0),"^",2)]"",$P(^(0),"^",4) S Y(2)=$P(^(0),"^",2)
"RTN","PSJDDUT",22,0)
 I $L(Y)+$L(Y(2))>180 K X Q
"RTN","PSJDDUT",23,0)
 S Y=Y_Y(2)_" " Q
"RTN","PSJDDUT",24,0)
 ;
"RTN","PSJDDUT",25,0)
CHK F QQ=1:1:$L(SCH,"-") S WKD=$P(SCH,"-",QQ) I WKD=$E(X,1,$L(WKD)) D TS Q
"RTN","PSJDDUT",26,0)
 Q
"RTN","PSJDDUT",27,0)
TS F Q1=1:1:$L(TS,"-") S C=C+1 I C=PSGDL S X=X1_"."_$P(TS,"-",Q1) Q
"RTN","PSJDDUT",28,0)
 Q
"RTN","PSJDDUT",29,0)
STRDT ;Called from Non-Verified Orders File (53.1),Start Date/Time field 10
"RTN","PSJDDUT",30,0)
 ;(Replaces ENPREV^PSGDL)
"RTN","PSJDDUT",31,0)
 D EN^DDIOL("REVIOUS","","?0") S (X,Y)=0 I '$D(PSGP)!'$D(PSGPDRG) G:$D(DA)[0 POUT S PSGP=$P($G(^PS(53.1,DA,0)),"^",15),PSGPDRG=+$G(^(.2)),Y=1 I 'PSGP!'PSGPDRG D:'PSGPDRG EN^DDIOL("Must have drug from formulary list.","","!?17") G POUT
"RTN","PSJDDUT",32,0)
 F Q=0:0 S Q=$O(^PS(53.1,"AC",PSGP,Q)) Q:'Q  I +$G(^PS(53.1,Q,.2))=PSGPDRG,$D(^PS(53.1,Q,2)),$P(^(2),"^",4)>X S X=$P(^(2),"^",4)
"RTN","PSJDDUT",33,0)
 F Q=0:0 S Q=$O(^PS(55,PSGP,5,"C",PSGPDRG,Q)) Q:'Q  I $D(^PS(55,PSGP,5,Q,2)),$P(^(2),"^",4)>X S X=$P(^(2),"^",4)
"RTN","PSJDDUT",34,0)
 D:'X EN^DDIOL("No other order found with this drug.","","!?17")
"RTN","PSJDDUT",35,0)
 ;
"RTN","PSJDDUT",36,0)
POUT ;
"RTN","PSJDDUT",37,0)
 K:'X X K:Y PSGPDRG,PSGP,Q Q
"RTN","PSJDDUT",38,0)
 ;
"RTN","PSJDDUT",39,0)
UNPD ;Called from Non-Verified Orders File (53.1), Units Per Dose field 13
"RTN","PSJDDUT",40,0)
 S PSJHLP(1)="ONE (1) UNIT PER DOSE WILL BE ASSUMED IF THERE IS NO ENTRY (OR"
"RTN","PSJDDUT",41,0)
 S PSJHLP(2)="AN ENTRY OF ZERO (0)) INTO THIS FIELD."
"RTN","PSJDDUT",42,0)
 D WRITE
"RTN","PSJDDUT",43,0)
 Q
"RTN","PSJDDUT",44,0)
 ;
"RTN","PSJDDUT",45,0)
SCH ;Called from Non-Verified Orders File (53.1), Schedule field 26
"RTN","PSJDDUT",46,0)
 ;(Replaces EN^PSGS0)
"RTN","PSJDDUT",47,0)
 ;/I X[""""!($A(X)=45)!(X?.E1C.E)!($L(X," ")>2)!($L(X)>70)!($L(X)<1)!(X["P RN")!(X["PR N") K X Q
"RTN","PSJDDUT",48,0)
 ;*194 Allow multi-word schedules
"RTN","PSJDDUT",49,0)
 I X[""""!($A(X)=45)!(X?.E1C.E)!($L(X," ")>$S(X["PRN":4,1:3))!($L(X)>70)!($L(X)<1)!(X["P RN")!(X["PR N") K X Q
"RTN","PSJDDUT",50,0)
 I X?.E1L.E S X=$$ENLU^PSGMI(X) I '$D(PSGOES) D EN^DDIOL("  ("_X_")","","?0")
"RTN","PSJDDUT",51,0)
 I X["Q0" K X Q
"RTN","PSJDDUT",52,0)
 ;
"RTN","PSJDDUT",53,0)
ENOS ; order set entry
"RTN","PSJDDUT",54,0)
 S (PSGS0XT,PSGS0Y,XT,Y)="" I X["PRN"!(X="ON CALL")!(X="ONCALL")!(X="ON-CALL") G Q
"RTN","PSJDDUT",55,0)
 S X0=X I X,X'["X",(X?2.4N1"-".E!(X?2.4N)) D ENCHK^PSGS0 S:$D(X) Y=X G Q
"RTN","PSJDDUT",56,0)
 I $S($D(^PS(51.1,"AC","PSJ",X)):1,1:$E($O(^(X)),1,$L(X))=X) D DIC^PSGS0 I XT]"" G Q
"RTN","PSJDDUT",57,0)
 I X["@" D DW^PSGS0 S:$D(X) Y=$P(X,"@",2) G Q
"RTN","PSJDDUT",58,0)
 I Y'>0,$S(X="NOW":1,X="ONCE":1,X="STAT":1,X="ONE TIME":1,X="ONETIME":1,X="1TIME":1,X="1 TIME":1,X="T-TIME":1,1:X="ONE-TIME") D:'$D(PSGOES) EN^DDIOL("  (ONCE ONLY)","","?0") S Y="",XT="O" G Q
"RTN","PSJDDUT",59,0)
 I $G(PSGSCH)=X S PSGS0Y=$G(PSGAT) Q
"RTN","PSJDDUT",60,0)
 ;
"RTN","PSJDDUT",61,0)
NS K PSJNSS I Y'>0 D:'$D(PSGOES) EN^DDIOL("  (Nonstandard schedule)","","?0") S X=X0,Y="",PSJNSS=1
"RTN","PSJDDUT",62,0)
 I $E(X,1,2)="AD" K X Q
"RTN","PSJDDUT",63,0)
 I $E(X,1,3)="BID"!($E(X,1,3)="TID")!($E(X,1,3)="QID") S XT=1440/$F("BTQ",$E(X)) G Q
"RTN","PSJDDUT",64,0)
 S:$E(X)="Q" X=$E(X,2,99) S:'X X="1"_X S X1=+X,X=$P(X,+X,2),X2=0 S:X1<0 X1=-X1 S:$E(X)="X" X2=1,X=$E(X,2,99)
"RTN","PSJDDUT",65,0)
 S XT=$S(X["'":1,(X["D"&(X'["AD"))!(X["AM")!(X["PM")!(X["HS"&(X'["THS")):1440,X["H"&(X'["TH"):60,X["AC"!(X["PC"):480,X["W":10080,X["M":40320,1:-1) I XT<0,Y'>0 K X G Q
"RTN","PSJDDUT",66,0)
 S X=X0 I XT S:X2 XT=XT\X1 I 'X2 S:$E(X,1,2)="QO" XT=XT*2 S XT=XT*X1
"RTN","PSJDDUT",67,0)
 ;
"RTN","PSJDDUT",68,0)
Q ;
"RTN","PSJDDUT",69,0)
 S PSGS0XT=$S(XT]"":XT,1:""),PSGS0Y=$S(Y:Y,1:"") K QX,SDW,SWD,X0,XT,Z Q
"RTN","PSJDDUT",70,0)
 ;
"RTN","PSJDDUT",71,0)
SCH3 ;Called from Non-Verified Orders File (53.1), Schedule field 26
"RTN","PSJDDUT",72,0)
 ;(Replaces ENSH3^PSGSH)
"RTN","PSJDDUT",73,0)
 S:'$D(PSGST) PSGST=$P($G(^PS(53.1,DA,0)),"^",7),PSGDDFLG=1
"RTN","PSJDDUT",74,0)
 N D,DA,DIC,DIE,DZ,Y
"RTN","PSJDDUT",75,0)
 D EN^DDIOL("'STAT', 'ONCE', 'NOW', and 'DAILY' are acceptable schedules.") I X?1"???".E F Q=1:1 Q:$P($T(HT+Q),";",3)=""  S PSJHLP(Q)=$P($T(HT+Q),";",3)
"RTN","PSJDDUT",76,0)
 I X?1"???".E D EN^DDIOL(.PSJHLP) K PSJHLP
"RTN","PSJDDUT",77,0)
 I X?1"???".E R !,"(Press RETURN to continue.) ",Q:DTIME D:'$T EN^DDIOL("","","$C(7)") S:'$T Q="^" I Q="^" K:$D(PSGDDFLG) PSGDDFLG,PSGST Q
"RTN","PSJDDUT",78,0)
 K DIC S DIC="^PS(51.1,",DIC(0)="E",D="APPSJ",DIC("W")="W ""  ""," I $D(PSJPWD),PSJPWD S DIC("W")=DIC("W")_"$S($D(^PS(51.1,+Y,1,PSJPWD,0)):$P(^(0),""^"",2),1:$P(^PS(51.1,+Y,0),""^"",2))"
"RTN","PSJDDUT",79,0)
 ; Naked references on the following two lines refer to the full reference on the line above
"RTN","PSJDDUT",80,0)
 E  S DIC("W")=DIC("W")_"$P(^(0),""^"",2)"
"RTN","PSJDDUT",81,0)
 I $D(PSGST) S DIC("S")="I $P(^(0),""^"",5)"_$E("'",PSGST'="O")_"=""O"""
"RTN","PSJDDUT",82,0)
 S DIC("?N",51.1)=12
"RTN","PSJDDUT",83,0)
 D IX^DIC K DIC K:$D(PSGDDFLG) PSGDDFLG,PSGST Q
"RTN","PSJDDUT",84,0)
 ;
"RTN","PSJDDUT",85,0)
HT ;
"RTN","PSJDDUT",86,0)
 ;;  This is the frequency (ONLY) with which the doses are to be
"RTN","PSJDDUT",87,0)
 ;;administered.  Several forms of entry are acceptable, such as
"RTN","PSJDDUT",88,0)
 ;;Q6H, 09-12-15, STAT, QOD, and MO-WE-FR@AD (where MO-WE-FR are
"RTN","PSJDDUT",89,0)
 ;;days of the week, and AD is the admin times).  The schedule
"RTN","PSJDDUT",90,0)
 ;;will show on the MAR, labels, etc.  No more than ONE space
"RTN","PSJDDUT",91,0)
 ;;(Q3H 4 or Q4H PRN) in the schedule is acceptable.  If the
"RTN","PSJDDUT",92,0)
 ;;letters PRN ;;are found as part of the schedule, no admin
"RTN","PSJDDUT",93,0)
 ;;times will print on the MAR or labels, and the PICK LIST will
"RTN","PSJDDUT",94,0)
 ;;always show a count of zero (0).
"RTN","PSJDDUT",95,0)
 ;;Avoid using notation such as W/F (with food) or WM (with meals)
"RTN","PSJDDUT",96,0)
 ;;in the schedule as it may cause erroneous calculations.  That
"RTN","PSJDDUT",97,0)
 ;;information should be entered into the SPECIAL INSTRUCTIONS.
"RTN","PSJDDUT",98,0)
 ;;  When using the MO-WE-FR@AD schedule, please remember that
"RTN","PSJDDUT",99,0)
 ;;this type of schedule will not work properly without the "@"
"RTN","PSJDDUT",100,0)
 ;;character and at least one admin time, and that at least the
"RTN","PSJDDUT",101,0)
 ;;first two letters of each weekday entered is needed.
"RTN","PSJDDUT",102,0)
 ;
"RTN","PSJDDUT",103,0)
ADTM2 ;Called from Non-Verified Orders File (53.1), Admin Times field 39    
"RTN","PSJDDUT",104,0)
 S PSJHLP(1)="All times must be the same length (2 or 4 characters), must be"
"RTN","PSJDDUT",105,0)
 S PSJHLP(2)="separated by dashes ( - ), and be in ascending order"
"RTN","PSJDDUT",106,0)
 S PSJHLP(3)=" "
"RTN","PSJDDUT",107,0)
 S PSJHLP(4)="This is the set of administration times for this order."
"RTN","PSJDDUT",108,0)
 S PSJHLP(5)="If the Schedule Type is CONTINUOUS the number of administration"
"RTN","PSJDDUT",109,0)
 S PSJHLP(6)="times cannot exceed that indicated by the schedule.  There can"
"RTN","PSJDDUT",110,0)
 S PSJHLP(7)="be less administration times then indicated by the schedule."
"RTN","PSJDDUT",111,0)
 S PSJHLP(8)="There must be at least one administration time entered."
"RTN","PSJDDUT",112,0)
 S PSJHLP(9)=" "
"RTN","PSJDDUT",113,0)
 S PSJHLP(10)="If the Schedule Type is CONTINUOUS and is an Odd Schedule"
"RTN","PSJDDUT",114,0)
 S PSJHLP(11)="(A schedule whose frequency is not evenly divisible by or"
"RTN","PSJDDUT",115,0)
 S PSJHLP(12)="into 1440 minutes or 1 day), Administration Times are not allowed."
"RTN","PSJDDUT",116,0)
 S PSJHLP(13)="For example Q5H, Q17H - these are not evenly divisible by 1440."
"RTN","PSJDDUT",117,0)
 S PSJHLP(14)=" "
"RTN","PSJDDUT",118,0)
 S PSJHLP(15)="If the Schedule Type is CONTINUOUS with a non-odd frequency of"
"RTN","PSJDDUT",119,0)
 S PSJHLP(16)="greater than 1 day (1440 minutes) then more than one"
"RTN","PSJDDUT",120,0)
 S PSJHLP(17)="administration time is not allowed.  For example schedules of"
"RTN","PSJDDUT",121,0)
 S PSJHLP(18)="Q72H, Q3Day, Q5Day."
"RTN","PSJDDUT",122,0)
 S PSJHLP(19)=" "
"RTN","PSJDDUT",123,0)
 S PSJHLP(20)="If the Schedule Type is ONE TIME it cannot have more than one"
"RTN","PSJDDUT",124,0)
 S PSJHLP(21)="administration time."
"RTN","PSJDDUT",125,0)
 D WRITE
"RTN","PSJDDUT",126,0)
 Q
"RTN","PSJDDUT",127,0)
 ;
"RTN","PSJDDUT",128,0)
WRDGP ;Called from Ward Group File (57.5), Ward Group field .01   
"RTN","PSJDDUT",129,0)
 S PSJHLP(1)="There is at least one PICK LIST for this WARD GROUP.  This WARD"
"RTN","PSJDDUT",130,0)
 S PSJHLP(1,"F")="$C(7),!!?2"
"RTN","PSJDDUT",131,0)
 S PSJHLP(2)="GROUP cannot be deleted until the PICK LIST(s) is purged or deleted."
"RTN","PSJDDUT",132,0)
 D WRITE
"RTN","PSJDDUT",133,0)
 Q
"RTN","PSJDDUT",134,0)
 ;
"RTN","PSJDDUT",135,0)
LBLS ;Called from Inpatient Ward Parameters file (59.6), field .11
"RTN","PSJDDUT",136,0)
 S PSJHLP(1)="ANY NEW LABELS OLDER THAN THE NUMBER OF DAYS SPECIFIED HERE WILL"
"RTN","PSJDDUT",137,0)
 S PSJHLP(2)="AUTOMATICALLY BE PURGED."
"RTN","PSJDDUT",138,0)
 D WRITE
"RTN","PSJDDUT",139,0)
 Q
"RTN","PSJDDUT",140,0)
 ;
"RTN","PSJDDUT",141,0)
SCHTP ;Called from the Unit Dose Multiple of file 55, Schedule Type field 7
"RTN","PSJDDUT",142,0)
 S PSJHLP(1)="CHOOSE FROM:"
"RTN","PSJDDUT",143,0)
 S PSJHLP(1,"F")="!!"
"RTN","PSJDDUT",144,0)
 S PSJHLP(2)="C - CONTINUOUS"
"RTN","PSJDDUT",145,0)
 S PSJHLP(2,"F")="!?3"
"RTN","PSJDDUT",146,0)
 S PSJHLP(3)="O - ONE-TIME"
"RTN","PSJDDUT",147,0)
 S PSJHLP(3,"F")="!?3"
"RTN","PSJDDUT",148,0)
 S PSJHLP(4)="OC - ON CALL"
"RTN","PSJDDUT",149,0)
 S PSJHLP(4,"F")="!?3"
"RTN","PSJDDUT",150,0)
 S PSJHLP(5)="P - PRN"
"RTN","PSJDDUT",151,0)
 S PSJHLP(5,"F")="!?3"
"RTN","PSJDDUT",152,0)
 S PSJHLP(6)="R - FILL ON REQUEST"
"RTN","PSJDDUT",153,0)
 S PSJHLP(6,"F")="!?3"
"RTN","PSJDDUT",154,0)
 D WRITE
"RTN","PSJDDUT",155,0)
 Q
"RTN","PSJDDUT",156,0)
 ;
"RTN","PSJDDUT",157,0)
EN ;Called from Non-Verified Orders file 53.1, Start/Date Time field 10
"RTN","PSJDDUT",158,0)
 ;and Stop Date/Time field 25 (Replaces EN^PSGDL)
"RTN","PSJDDUT",159,0)
 K PSGDLS S ND2=^PS(53.1,DA,2) I $P(ND2,"^",5)!$P(ND2,"^",6) D EN^DDIOL(" ...Dose Limit... ","","?0") G ENGO
"RTN","PSJDDUT",160,0)
 G DONE
"RTN","PSJDDUT",161,0)
 ;
"RTN","PSJDDUT",162,0)
ENGO ;
"RTN","PSJDDUT",163,0)
 N FD
"RTN","PSJDDUT",164,0)
 S SCH=$P(ND2,"^")
"RTN","PSJDDUT",165,0)
 S ST=$S($D(PSGDLS):PSGDLS,1:$P(ND2,"^",2))
"RTN","PSJDDUT",166,0)
 S TS=$P(ND2,"^",5),MN=$P(ND2,"^",6)
"RTN","PSJDDUT",167,0)
 I $P(PSJSYSW0,U,5)=2 D
"RTN","PSJDDUT",168,0)
 . Q:'TS  S:TS'[$P(ST,".",2) $P(PSJSYSW0,U,5)=1 D
"RTN","PSJDDUT",169,0)
 .. N STRING,ND2,SCH,TS,MN S STRING=$G(PSGSD)_"^"_$G(PSGFD)_"^"_$G(PSGSCH)_"^"_$G(PSGST)_"^"_$G(PSGPDRG)_"^"_$G(PSGAT)
"RTN","PSJDDUT",170,0)
 .. S (FD,ST)=$$ENQ^PSJORP2(PSGP,STRING) S:'ST ST=$S($D(PSGDLS):PSGDLS,1:$P(ND2,"^",2))
"RTN","PSJDDUT",171,0)
 . S $P(PSJSYSW0,U,5)=2
"RTN","PSJDDUT",172,0)
 I $G(FD),$P(ND2,"^",4),FD>$P(ND2,"^",4) D  G DONE
"RTN","PSJDDUT",173,0)
 . W !,"There is no schedule and/or administration time that falls between the Start Date/Time"
"RTN","PSJDDUT",174,0)
 . W !,"and Stop Date/Time.  For the order to be valid the schedule and/or administration time"
"RTN","PSJDDUT",175,0)
 . W !,"must fall between the order's Start Date/Time and Stop Date/Time.",!
"RTN","PSJDDUT",176,0)
 S TS=$P(ND2,"^",5),MN=$P(ND2,"^",6)
"RTN","PSJDDUT",177,0)
 G MWF:SCH["@",DONE:'TS&'MN
"RTN","PSJDDUT",178,0)
 I 'TS S AM=MN*PSGDL,X=$$EN^PSGCT(ST,AM) G DONE
"RTN","PSJDDUT",179,0)
 S TM=$E(ST_"00000",9,8+$L($P(TS,"-")))
"RTN","PSJDDUT",180,0)
 F Q=1:1 Q:$P(TS,"-",Q)=""!(TM<$P(TS,"-",Q))
"RTN","PSJDDUT",181,0)
 S X=ST\1,C=0 F Q=Q:1 D:$P(TS,"-",Q)="" ADD S C=C+1 I C=PSGDL S X=X_"."_$P(TS,"-",Q) G DONE
"RTN","PSJDDUT",182,0)
 ;
"RTN","PSJDDUT",183,0)
MWF ; if schedule is similar to monday-wednesday-friday
"RTN","PSJDDUT",184,0)
 S TS=$P(SCH,"@",2),SCH=$P(SCH,"@"),X=$P(ST,"."),C=0 D SCHK G:C=PSGDL DONE F Q=1:1 S X1=$P(ST,"."),X2=Q D C^%DTC S X1=X D DW^%DTC D CHK G:C=PSGDL DONE
"RTN","PSJDDUT",185,0)
SCHK S X1=X D DW^%DTC F Q=1:1:$L(SCH,"-") S WKD=$P(SCH,"-",Q) I WKD=$E(X,1,$L(WKD)) Q
"RTN","PSJDDUT",186,0)
 E  Q
"RTN","PSJDDUT",187,0)
 S TM=$E(ST_"00000",9,8+$L($P(TS,"-"))) F Q=1:1:$L(TS,"-") I TM<$P(TS,"-",Q) S C=C+1 I C=PSGDL S X=X1_"."_$P(TS,"-",Q) Q
"RTN","PSJDDUT",188,0)
 Q
"RTN","PSJDDUT",189,0)
 ;
"RTN","PSJDDUT",190,0)
DONE ;
"RTN","PSJDDUT",191,0)
 K %H,%T,%Y,MN,ND2,ND4,PSGDLS,PSGDL,Q1,QQ,SCH,TM,WKD,TS,X1,X2 Q
"RTN","PSJDDUT",192,0)
 ;
"RTN","PSJDDUT",193,0)
ADD ;
"RTN","PSJDDUT",194,0)
 S X1=$P(X,"."),X2=$S(MN&'(MN#1440):MN\1440,1:1) D C^%DTC S Q=1 Q
"RTN","PSJDDUT",195,0)
 ;
"RTN","PSJDDUT",196,0)
WRITE ;Calls EN^DDIOL to write text
"RTN","PSJDDUT",197,0)
 D EN^DDIOL(.PSJHLP) K PSJHLP Q
"RTN","PSJHL9")
0^4^B62691896
"RTN","PSJHL9",1,0)
PSJHL9 ;BIR/LDT-VALIDATE INCOMING HL7 DATA/CREATE NEW ORDER ; 2/14/12 7:14am
"RTN","PSJHL9",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**1,18,31,42,47,50,63,72,75,58,80,110,111,134,267,279,194**;16 DEC 97;Build 42
"RTN","PSJHL9",3,0)
 ;
"RTN","PSJHL9",4,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192.
"RTN","PSJHL9",5,0)
 ; Reference to ^PS(50.7 is supported by DBIA# 2180.
"RTN","PSJHL9",6,0)
 ; Reference to ^PS(51.2 is supported by DBIA# 2178.
"RTN","PSJHL9",7,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJHL9",8,0)
 ; Reference to ^ORERR is supported by DBIA# 2187.
"RTN","PSJHL9",9,0)
 ; Reference to ^ORHLESC is supported by DBIA# 4922.
"RTN","PSJHL9",10,0)
 ;
"RTN","PSJHL9",11,0)
VALID ;
"RTN","PSJHL9",12,0)
 I APPL="",PSITEM="" S PSREASON="Missing or invalid Orderable Item" D ERROR Q
"RTN","PSJHL9",13,0)
 I PSITEM]"",'$D(^PS(50.7,+PSITEM,0)) S PSREASON="Missing or invalid Orderable Item" D ERROR Q
"RTN","PSJHL9",14,0)
 I $G(APPL)'["B",$G(APPL)'["A",+$G(ROUTE)'>0 S PSREASON="Missing or invalid Med Route" D ERROR Q
"RTN","PSJHL9",15,0)
 S APPL=$S($G(APPL)["B":"F",$G(APPL)["A":"F",$G(DISPENSE)]"":$$ORTYP(ROUTE,DISPENSE),1:$$TRYAGAIN(ROUTE,PSITEM))
"RTN","PSJHL9",16,0)
 S:APPL="" APPL="IP"
"RTN","PSJHL9",17,0)
 I APPL'="F" D
"RTN","PSJHL9",18,0)
 .I $G(SCHEDULE)]"" N X S X=SCHEDULE D  S SCHEDULE=X
"RTN","PSJHL9",19,0)
 ..;*194 Allow multi-word schedules
"RTN","PSJHL9",20,0)
 ..I X[""""!($A(X)=45)!(X?.E1C.E)!($L(X," ")>$S(X["PRN":4,1:3))!($L($P(X,"@"))>70)!($L($P(X,"@",2))>119)!($L(X)<1)!(X["P RN")!(X["PR N") S X="" Q
"RTN","PSJHL9",21,0)
 ..I X?.E1L.E S X=$$ENLU^PSGMI(X)
"RTN","PSJHL9",22,0)
 ..S X=$$TRIM^XLFSTR(X,"R"," ")
"RTN","PSJHL9",23,0)
 ..I X["Q0" S X="" Q
"RTN","PSJHL9",24,0)
 .I APPL["U",$G(SCHEDULE)="" S PSREASON="Missing or invalid schedule" D ERROR Q
"RTN","PSJHL9",25,0)
 .N DFN S DFN=PSJHLDFN D IN5^VADPT I 'VAIP(5) D:APPT=""  I APPL="UN",APPT="" S PSREASON="Cannot place Unit Dose orders for an Outpatient" D ERROR Q
"RTN","PSJHL9",26,0)
 .. I APPL="UP" S APPL="IN" Q
"RTN","PSJHL9",27,0)
 .. I APPL="IP" S APPL="IN" Q
"RTN","PSJHL9",28,0)
 .I $G(ROC)'="R",$G(ROUTE)'>0 S PSREASON="Missing or invalid Med Route" D ERROR Q
"RTN","PSJHL9",29,0)
 I APPL="F" D
"RTN","PSJHL9",30,0)
 .I '$O(^TMP("PSJNVO",$J,"SOL",0))&('$O(^TMP("PSJNVO",$J,"AD",0))) S PSREASON="IV Fluid orders must have at least one additive or solution" D ERROR Q
"RTN","PSJHL9",31,0)
 .I $G(IVCAT)="I",$G(INFRT)="" Q  ;Allow intermittent IV orders to have a null infusion rate.
"RTN","PSJHL9",32,0)
 .I $G(INFRT)="" S PSREASON="Invalid Infusion Rate" D ERROR Q
"RTN","PSJHL9",33,0)
 Q
"RTN","PSJHL9",34,0)
 ;
"RTN","PSJHL9",35,0)
ERROR ;Sends error msg to CPRS, logs error in OE/RR Errors file
"RTN","PSJHL9",36,0)
 S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(PSREASON,.PSJMSG)
"RTN","PSJHL9",37,0)
 D EN1^PSJHLERR(PSJHLDFN,$S(PSOC="XO":"UX",1:"OC"),$P(ORDER,U),PSREASON) S QFLG=1 K ^TMP("PSJNVO",$J)
"RTN","PSJHL9",38,0)
 Q
"RTN","PSJHL9",39,0)
 ;
"RTN","PSJHL9",40,0)
NVO ; put new orders in non-verified orders file
"RTN","PSJHL9",41,0)
 I '$D(ROUTE) S ROUTE=""
"RTN","PSJHL9",42,0)
 I $G(ROUTE)="" S:APPL="F" ROUTE=$O(^PS(51.2,"B","INTRAVENOUS",0))
"RTN","PSJHL9",43,0)
 N DA,DR,DIE D ENGNN^PSGOETO S DIE="^PS(53.1,"
"RTN","PSJHL9",44,0)
 S DR="1////"_PROVIDER_";3////"_$$ESC^ORHLESC(ROUTE)_";4////"_$E(APPL)_";28////P"_";108////"_PSITEM_";27.1////"_LOGIN_";27////"_LOGIN_";.5////"_PSJHLDFN_";.24////"_PRIORITY_";125////"_$G(PRNTON)
"RTN","PSJHL9",45,0)
 I $G(LOC)]"" S:$P($G(^SC(+LOC,0)),U,3)="C" DR=DR_";113////"_LOC_";126////"_$G(APPT)
"RTN","PSJHL9",46,0)
 I $G(IVCAT)]"" S DR=DR_";128////"_IVCAT S ADMINS=""
"RTN","PSJHL9",47,0)
 S:$G(SCHTYP)]"" DR=DR_";7////"_SCHTYP
"RTN","PSJHL9",48,0)
 D ^DIE K PSJHLSKP S NEWORDER=DA,PSJORDER=DA_"P"
"RTN","PSJHL9",49,0)
 S $P(^PS(55,PSJHLDFN,5.1),"^",2)=PROVIDER
"RTN","PSJHL9",50,0)
 S:$G(ORDER)]"" $P(^PS(53.1,DA,0),"^",21)=$P(ORDER,"^")
"RTN","PSJHL9",51,0)
 S:$G(APPL)["P" $P(^PS(53.1,DA,0),"^",13)=1
"RTN","PSJHL9",52,0)
 S $P(^PS(53.1,DA,0),"^",18)=DA
"RTN","PSJHL9",53,0)
 S:$G(ROC)]"" $P(^PS(53.1,DA,0),"^",24)=ROC
"RTN","PSJHL9",54,0)
 S:$G(PREON)]"" $P(^PS(53.1,DA,0),"^",25)=PREON
"RTN","PSJHL9",55,0)
 S:$G(ADMINS) $P(^PS(53.1,DA,2),"^",5)=ADMINS
"RTN","PSJHL9",56,0)
 S:$G(REQST)]"" $P(^PS(53.1,DA,2.5),"^")=REQST
"RTN","PSJHL9",57,0)
 ; Transform duration units of doses to a for administrations
"RTN","PSJHL9",58,0)
 S:$E(DURATION,1,5)="doses" DURATION=$TR(DURATION,"doses","a")
"RTN","PSJHL9",59,0)
 S:$G(DURATION)]"" $P(^PS(53.1,DA,2.5),"^",2)=DURATION
"RTN","PSJHL9",60,0)
 S:$G(IVLIMIT)]"" $P(^PS(53.1,DA,2.5),"^",4)=IVLIMIT
"RTN","PSJHL9",61,0)
 I $G(REQST)]"",$G(DURATION)]"" S $P(^PS(53.1,DA,2.5),"^",3)=$$STOP(REQST,DURATION)
"RTN","PSJHL9",62,0)
 S:$G(INSTR)]"" $P(^PS(53.1,DA,.3),"^")=INSTR
"RTN","PSJHL9",63,0)
 I $G(INFRT)]"" D
"RTN","PSJHL9",64,0)
 .I INFRT S:(INFRT["Minutes"!(INFRT["Hours")) INFRT="INFUSE OVER "_INFRT
"RTN","PSJHL9",65,0)
 .S ^PS(53.1,DA,8)=IVTYP_"^^^^"_INFRT
"RTN","PSJHL9",66,0)
 .I INFRT["@",($P(INFRT,"@",2)?1.N) S $P(^PS(53.1,DA,17),"^")=$P(INFRT,"@",2)
"RTN","PSJHL9",67,0)
 S:$G(FREQ)]"" $P(^PS(53.1,DA,2),"^",6)=FREQ
"RTN","PSJHL9",68,0)
 S:$G(SCHTYP)]"" $P(^PS(53.1,DA,0),"^",7)=SCHTYP
"RTN","PSJHL9",69,0)
 I $G(APPL)'="I" I $G(INSTR)]"" N X S X=INSTR D STRIP I $S(X?.E1C.E:0,$L(X)>60:0,X="":0,X["^":0,X?1.P:1,1:1) S $P(^PS(53.1,DA,.2),"^",2)=X,$P(^PS(53.1,DA,.2),"^",5,6)=$G(DOSE)_"^"_$$UNESC^ORHLESC($G(UNIT))
"RTN","PSJHL9",70,0)
 S $P(^PS(53.1,DA,.2),"^",3)=ORDCON
"RTN","PSJHL9",71,0)
 I $G(SCHEDULE)]"" S $P(^PS(53.1,DA,2),"^")=$$UNESC^ORHLESC(SCHEDULE)
"RTN","PSJHL9",72,0)
 I $G(APPL)="I" I $G(UNITS)]"" S $P(^PS(53.1,DA,.3),"^")=$$UNESC^ORHLESC(UNITS)
"RTN","PSJHL9",73,0)
 S ^PS(53.1,DA,4)="^^^^^^"_CLERK
"RTN","PSJHL9",74,0)
 I $G(DISPENSE) S ^PS(53.1,DA,1,0)="^53.11P^1^1",^PS(53.1,DA,1,1,0)=DISPENSE_"^"_$$UNESC^ORHLESC(UNITS),^PS(53.1,DA,1,"B",$E(DISPENSE,1,30),1)=""
"RTN","PSJHL9",75,0)
 I $D(PROCOM) D
"RTN","PSJHL9",76,0)
 .I '$D(^PS(53.1,DA,12,0)) S ^(0)="^53.1012^0^0"
"RTN","PSJHL9",77,0)
 .S JJ=0 F  S JJ=$O(PROCOM(JJ)) Q:'JJ  S $P(^PS(53.1,DA,12,0),"^",3,4)=JJ_"^"_JJ,^PS(53.1,DA,12,JJ,0)=$$UNESC^ORHLESC(PROCOM(JJ))
"RTN","PSJHL9",78,0)
 I $D(ADMINSTR) D
"RTN","PSJHL9",79,0)
 .I '$D(^PS(53.1,DA,3,0)) S ^(0)="^53.12^0^0"
"RTN","PSJHL9",80,0)
 .S JJ=0 F  S JJ=$O(ADMINSTR(JJ)) Q:'JJ  S $P(^PS(53.1,DA,3,0),"^",3,4)=JJ_"^"_JJ,^PS(53.1,DA,3,JJ,0)=ADMINSTR(JJ)
"RTN","PSJHL9",81,0)
 I $D(^TMP("PSJNVO",$J,"AD")) D
"RTN","PSJHL9",82,0)
 .S ^PS(53.1,DA,"AD",0)="^53.157PA^0^0"
"RTN","PSJHL9",83,0)
 .S JJ=0 F  S JJ=$O(^TMP("PSJNVO",$J,"AD",JJ)) Q:'JJ  S $P(^PS(53.1,DA,"AD",0),"^",3,4)=JJ_"^"_JJ,^PS(53.1,DA,"AD",JJ,0)=^TMP("PSJNVO",$J,"AD",JJ,0),^PS(53.1,DA,"AD","B",$$UNESC^ORHLESC($P(^TMP("PSJNVO",$J,"AD",JJ,0),"^")),JJ)=""
"RTN","PSJHL9",84,0)
 I $D(^TMP("PSJNVO",$J,"SOL")) D
"RTN","PSJHL9",85,0)
 .S ^PS(53.1,DA,"SOL",0)="^53.158PA^0^0"
"RTN","PSJHL9",86,0)
 .S JJ=0 F  S JJ=$O(^TMP("PSJNVO",$J,"SOL",JJ)) Q:'JJ  S $P(^PS(53.1,DA,"SOL",0),"^",3,4)=JJ_"^"_JJ,^PS(53.1,DA,"SOL",JJ,0)=^TMP("PSJNVO",$J,"SOL",JJ,0),^PS(53.1,DA,"SOL","B",$P(^TMP("PSJNVO",$J,"SOL",JJ,0),"^"),JJ)=""
"RTN","PSJHL9",87,0)
 I $O(^TMP("PSJNVO",$J,10,0)) D
"RTN","PSJHL9",88,0)
 .S ^PS(53.1,DA,10,0)="^53.1112A^0^0"
"RTN","PSJHL9",89,0)
 .S JJ=0 F  S JJ=$O(^TMP("PSJNVO",$J,10,JJ)) Q:'JJ  S $P(^PS(53.1,DA,10,0),"^",3,4)=JJ_"^"_JJ,^PS(53.1,DA,10,JJ,0)=$$UNESC^ORHLESC(^TMP("PSJNVO",$J,10,JJ,0)),^PS(53.1,DA,10,"B",$$UNESC^ORHLESC($E(^TMP("PSJNVO",$J,10,JJ,0),1,30)),JJ)="" D
"RTN","PSJHL9",90,0)
 ..S ^PS(53.1,DA,10,JJ,1)=$P($G(^VA(200,+CLERK,0)),"^")
"RTN","PSJHL9",91,0)
 ..I $O(^TMP("PSJNVO",$J,10,JJ,2,0)) S ^PS(53.1,DA,10,JJ,2,0)="^53.11122^0^0" D
"RTN","PSJHL9",92,0)
 ...S QQ=0 F  S QQ=$O(^TMP("PSJNVO",$J,10,JJ,2,QQ)) Q:'QQ  S $P(^PS(53.1,DA,10,JJ,2,0),"^",3,4)=QQ_"^"_QQ,^PS(53.1,DA,10,JJ,2,QQ,0)=$$UNESC^ORHLESC(^TMP("PSJNVO",$J,10,JJ,2,QQ,0))
"RTN","PSJHL9",93,0)
 Q
"RTN","PSJHL9",94,0)
STRIP ;Strips spaces off the end of instructions.
"RTN","PSJHL9",95,0)
 I $E(X,$L(X))=" " F  S X=$E(X,1,$L(X)-1) Q:$E(X,$L(X))'=" "
"RTN","PSJHL9",96,0)
 Q
"RTN","PSJHL9",97,0)
 ;
"RTN","PSJHL9",98,0)
ORTYP(MDRT,DDRG)        ;Entry point to determine order type for 53.1
"RTN","PSJHL9",99,0)
 ;MDRT=Med Route from 51.2, DDRG=Dispense Drug
"RTN","PSJHL9",100,0)
 I '$G(DDRG) S ORTYP="" Q ORTYP
"RTN","PSJHL9",101,0)
 I '$D(^PSDRUG(+DDRG,2)) S ORTYP="" Q ORTYP
"RTN","PSJHL9",102,0)
 I $P(^PSDRUG(DDRG,2),"^",3)'["I",$P(^PSDRUG(DDRG,2),"^",3)'["U" S ORTYP="" Q ORTYP
"RTN","PSJHL9",103,0)
 I '$G(MDRT) S ORTYP="" Q ORTYP
"RTN","PSJHL9",104,0)
 I '$D(^PS(51.2,+MDRT,0)) S ORTYP="" Q ORTYP
"RTN","PSJHL9",105,0)
 I $P(^PSDRUG(DDRG,2),"^",3)["I",$P(^PSDRUG(DDRG,2),"^",3)'["U",$P(^PS(51.2,MDRT,0),"^",6)=1 S ORTYP="IN" Q ORTYP
"RTN","PSJHL9",106,0)
 I $P(^PSDRUG(DDRG,2),"^",3)'["I",$P(^PS(51.2,MDRT,0),"^",6)=1 S ORTYP="UP" Q ORTYP
"RTN","PSJHL9",107,0)
 I $P(^PSDRUG(DDRG,2),"^",3)["I",$P(^PS(51.2,MDRT,0),"^",6)=1 S ORTYP="IP" Q ORTYP
"RTN","PSJHL9",108,0)
 I $P(^PSDRUG(DDRG,2),"^",3)["I",$P(^PSDRUG(DDRG,2),"^",3)'["U",$P(^PS(51.2,MDRT,0),"^",6)'=1 S ORTYP="IP" Q ORTYP
"RTN","PSJHL9",109,0)
 I $P(^PSDRUG(DDRG,2),"^",3)["U",$P(^PSDRUG(DDRG,2),"^",3)'["I",$P(^PS(51.2,MDRT,0),"^",6)'=1 S ORTYP="UN" Q ORTYP
"RTN","PSJHL9",110,0)
 I $P(^PSDRUG(DDRG,2),"^",3)["U",$P(^PS(51.2,MDRT,0),"^",6)'=1 S ORTYP="UP" Q ORTYP
"RTN","PSJHL9",111,0)
 S ORTYP="" Q ORTYP
"RTN","PSJHL9",112,0)
 ;
"RTN","PSJHL9",113,0)
TRYAGAIN(MDRT,OI)       ;
"RTN","PSJHL9",114,0)
 ;MDRT=Med Route from 51.2, OI=Orderable Item
"RTN","PSJHL9",115,0)
 N ORTYPI,ORTYPU,ORTYPP
"RTN","PSJHL9",116,0)
 S ORTYP="",ORTYPI=0,ORTYPU=0,ORTYPP=0
"RTN","PSJHL9",117,0)
 N DDRG S DDRG=0 F  S DDRG=$O(^PSDRUG("ASP",OI,DDRG)) Q:'DDRG  D 
"RTN","PSJHL9",118,0)
 .I $G(^PSDRUG(DDRG,"I"))]"" Q:^PSDRUG(DDRG,"I")'>DT
"RTN","PSJHL9",119,0)
 .S ORTYP=$$ORTYP(MDRT,DDRG)  D
"RTN","PSJHL9",120,0)
 ..I ORTYP["I" S ORTYPI=ORTYPI+1
"RTN","PSJHL9",121,0)
 ..I ORTYP["U" S ORTYPU=ORTYPU+1
"RTN","PSJHL9",122,0)
 ..I ORTYP["P" S ORTYPP=ORTYPP+1
"RTN","PSJHL9",123,0)
 S ORTYP=$S(ORTYPU>ORTYPI:"U",1:"I") S ORTYP=ORTYP_$S(ORTYPP>0:"P",1:"N")
"RTN","PSJHL9",124,0)
 Q ORTYP
"RTN","PSJHL9",125,0)
 ;
"RTN","PSJHL9",126,0)
STOP(REQST,DURA)   ;
"RTN","PSJHL9",127,0)
 ;REQST=Requested start date, DURA=Duration from CPRS
"RTN","PSJHL9",128,0)
 I DURA["L",DURA?1A1".".N S DAYS=$$DAY($E(REQST,1,5)),DURA="H"_((DAYS*$P(DURA,"L",2))*24)
"RTN","PSJHL9",129,0)
 I DURA["L",DURA?1A.1N.N1"."1N.N D  Q STOP
"RTN","PSJHL9",130,0)
 .S NUM=$E(REQST,4,5)+$P($P(DURA,"."),"L",2),NUM=$S(NUM<10:"0"_NUM,NUM<13:NUM,1:$S((NUM-12)<10:"0"_(NUM-12),1:(NUM-12))),DATE=$E(REQST,1,3)_NUM
"RTN","PSJHL9",131,0)
 .S DAYS=$$DAY(DATE),STOP=$$SCH^XLFDT($P($P(DURA,"."),"L",2)_"M",$P(REQST,"."))_"."_$P(REQST,".",2),DEL=$P($P(DURA,"L",2),"."),STOP=$$FMADD^XLFDT(STOP,"",((DAYS*$P(DURA,DEL,2))*24))
"RTN","PSJHL9",132,0)
 I DURA["L" S STOP=$P($$SCH^XLFDT($P(DURA,"L",2)_"M",$P(REQST,".")),".")_"."_$P(REQST,".",2) Q STOP
"RTN","PSJHL9",133,0)
 I DURA["W",DURA["." S DURA="H"_(($P(DURA,"W",2)*7)*24)
"RTN","PSJHL9",134,0)
 I DURA["D",DURA["." S DURA="H"_($P(DURA,"D",2)*24)
"RTN","PSJHL9",135,0)
 I +DURA=DURA,DURA["." S DURA="H"_(DURA*24)
"RTN","PSJHL9",136,0)
 S STOP=$$FMADD^XLFDT(REQST,$S(DURA["W":$P(DURA,"W",2)*7,DURA["D":$P(DURA,"D",2),+DURA=DURA:+DURA,1:""),$S(DURA["H":$P(DURA,"H",2),1:""),$S(DURA["M":$P(DURA,"M",2),1:""),$S(DURA["S":$P(DURA,"S",2),1:""))
"RTN","PSJHL9",137,0)
 Q STOP
"RTN","PSJHL9",138,0)
ZQDATE(DATE,MONTHS)  ;BUMP DATE BY A MONTH (OR SO)
"RTN","PSJHL9",139,0)
 ;;
"RTN","PSJHL9",140,0)
 S X=$E($P(DATE,"."),1,5)+($E($P(DATE,"."),4,5)>(12-MONTHS)*88+MONTHS)_$E($P(DATE,"."),6,7) F  D ^%DT Q:Y>0  S X=X-1
"RTN","PSJHL9",141,0)
 S NEWDATE=X_"."_$P(DATE,".",2)
"RTN","PSJHL9",142,0)
 Q NEWDATE
"RTN","PSJHL9",143,0)
DAY(DATE) ;DATE=FIRST FIVE DIGITS OF FM DATE
"RTN","PSJHL9",144,0)
 N X
"RTN","PSJHL9",145,0)
 I DATE'?5N Q -1
"RTN","PSJHL9",146,0)
 S X=$E(DATE,4,5) I X<1!(X>12) Q -1
"RTN","PSJHL9",147,0)
 S X=DATE+1+(X=12*88)_"01"
"RTN","PSJHL9",148,0)
 Q $E($$FMADD^XLFDT(X,-1),6,7)
"RTN","PSJSV")
0^5^B26193221
"RTN","PSJSV",1,0)
PSJSV ;BIR/CML3-SCHEDULE VALIDATION ; 3/23/11 7:57am
"RTN","PSJSV",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**3,50,73,83,194**;16 DEC 97;Build 42
"RTN","PSJSV",3,0)
 ;
"RTN","PSJSV",4,0)
 ; Reference to ^PS(51.1 is supported by DBIA# 2177.
"RTN","PSJSV",5,0)
 ;
"RTN","PSJSV",6,0)
EN ;
"RTN","PSJSV",7,0)
 ;/S X=PSJX,(PSJAT,PSJM,PSJTS,PSJY,PSJAX)="" I $S(X["""":1,$A(X)=45:1,X'?.ANP:1,$L(X," ")>2:1,$L(X)>70:1,$L(X)<1:1,X["P RN":1,1:X["PR N") K PSJX,X Q
"RTN","PSJSV",8,0)
 ;*194 Allow multi-word schedules.
"RTN","PSJSV",9,0)
 S X=PSJX,(PSJAT,PSJM,PSJTS,PSJY,PSJAX)="" I $S(X["""":1,$A(X)=45:1,X'?.ANP:1,$L(X," ")>$S(X["PRN":4,1:3):1,$L(X)>70:1,$L(X)<1:1,X["P RN":1,1:X["PR N") K PSJX,X Q
"RTN","PSJSV",10,0)
 I X["PRN"!(X="ON CALL")!(X="ONCALL")!(X="ON-CALL") G DONE
"RTN","PSJSV",11,0)
 I X?1."?" D:'$D(PSJNE) ENSVH^PSJSV0 Q
"RTN","PSJSV",12,0)
 S X0=X,(XT,Y)="" I X,X'["X",(X?2.4N1"-".E!(X?2.4N)) D ENCHK S:$D(X) PSJAT=X G DONE
"RTN","PSJSV",13,0)
 I X["@" D DW S:$D(X) PSJAT=$P(X,"@",2) G DONE
"RTN","PSJSV",14,0)
 I $S($D(^PS(51.1,"AC",PSJPP,X)):1,1:$E($O(^(X)),1,$L(X))=X) D DIC G:$S(PSJY:PSJTS'="C",1:PSJM) DONE
"RTN","PSJSV",15,0)
 I $S(X="NOW":1,X="ONCE":1,X="STAT":1,X="ONE TIME":1,X="1TIME":1,X="1 TIME":1,X="1-TIME":1,X="ONETIME":1,1:X="ONE-TIME") S PSJTS="O" W:'$D(PSJNE) "  (ONCE ONLY)" G DONE
"RTN","PSJSV",16,0)
 S:PSJTS="" PSJTS="C" I PSJAT="" W:'$D(PSJNE) "  (Non standard schedule)" S X=PSJX
"RTN","PSJSV",17,0)
 I $E(X,1,2)="AD" K X G DONE
"RTN","PSJSV",18,0)
 I $E(X,1,3)="BID"!($E(X,1,3)="TID")!($E(X,1,3)="QID") S PSJM=1440\$F("BTQ",$E(X)) G DONE
"RTN","PSJSV",19,0)
 S:$E(X)="Q" X=$E(X,2,99) S:'X X="1"_X S X1=+X,X=$P(X,+X,2),X2=0 S:X1<0 X1=-X1 S:$E(X)="X" X2=X1,X=$E(X,2,99) I 'X2,$E(X)="O" S X2=.5,X=$E(X,2,99)
"RTN","PSJSV",20,0)
 ;*194 Allow Lab to use frequency when setting orders
"RTN","PSJSV",21,0)
 I $G(PSJPP)="LR",PSJM'="" S XT=PSJM G DONE
"RTN","PSJSV",22,0)
 S XT=$S(X["'":1,(X["D"&(X'["AD"))!(X["AM")!(X["PM")!(X["HS"&(X'["THS")):1440,X["H"&(X'["TH"):60,X["AC"!(X["PC"):480,X["W":10080,X["M":40320,1:-1) I XT<0,PSJAT="" K X G DONE
"RTN","PSJSV",23,0)
 S X=PSJX I XT S:X2 XT=XT\X2 S:'X2 XT=XT*X1
"RTN","PSJSV",24,0)
 S PSJM=XT
"RTN","PSJSV",25,0)
 ;
"RTN","PSJSV",26,0)
DONE ;
"RTN","PSJSV",27,0)
 K:$D(X)[0 PSJX K D,DIC,Q,QX,SDW,SWD,X,X0,X1,X2,XT,Y,Z Q
"RTN","PSJSV",28,0)
 ;
"RTN","PSJSV",29,0)
ENCHK ; admin times
"RTN","PSJSV",30,0)
 I $S($L($P(X,"-"))>4:1,$L(X)>119:1,$L(X)<2:1,X'>0:1,1:X'?.ANP) K X Q
"RTN","PSJSV",31,0)
 S X(1)=$P(X,"-") I X(1)'?2N,X(1)'?4N K X Q
"RTN","PSJSV",32,0)
 S X(1)=$L(X(1)) F X(2)=2:1:$L(X,"-") S X(3)=$P(X,"-",X(2)) I $S($L(X(3))'=X(1):1,X(3)>$S(X(1)=2:24,1:2400):1,1:X(3)'>$P(X,"-",X(2)-1)) K X Q
"RTN","PSJSV",33,0)
 K:$D(X) X(1),X(2),X(3) Q
"RTN","PSJSV",34,0)
 ;
"RTN","PSJSV",35,0)
DIC ; 51.1 look-up
"RTN","PSJSV",36,0)
 S DIC="^PS(51.1,",DIC(0)=$E("E",'$D(PSJNE))_"ISZ",DIC("W")="I '$D(PSJNE) D DICW^PSJSV0",D="AP"_PSJPP
"RTN","PSJSV",37,0)
 D IX^DIC K DIC Q:Y'>0  S PSJY=+Y,(PSJX,X,X0)=Y(0,0),PSJM=$P(Y(0),"^",3),PSJTS=$P(Y(0),"^",5),PSJAX=$P(Y(0),U,7) S:PSJTS="" PSJTS="C" Q:PSJTS="O"!(PSJTS["R")  I $D(PSJW),$D(^PS(51.1,+Y,1,+PSJW,0)) S PSJAT=$P(^(0),"^",PSJTS="S"+2)
"RTN","PSJSV",38,0)
 E  S PSJAT=$P(Y(0),"^",PSJTS="S"*4+2)
"RTN","PSJSV",39,0)
 Q:PSJTS'="S"
"RTN","PSJSV",40,0)
 F Y=1:1:$L(PSJAT,"-") S Y(1)=$P(PSJAT,"-",Y),PSJAT(Y(1))="",Y(2)=$O(^PS(51.15,"ACP",PSJPP,Y(1),0)) I Y(2),$D(^PS(51.15,Y(2),0)) S PSJAT(Y(1))=$P(^(0),"^",3) I $D(PSJW),$D(^(1,PSJW,0)),$P(^(0),"^",2)]"" S PSJAT(Y(1))=$P(^(0),"^",2)
"RTN","PSJSV",41,0)
 Q
"RTN","PSJSV",42,0)
 ;
"RTN","PSJSV",43,0)
DW ;  week days
"RTN","PSJSV",44,0)
 S SWD="SUNDAYS^MONDAYS^TUESDAYS^WEDNESDAYS^THURSDAYS^FRIDAYS^SATURDAYS",SDW=X,X=$P(X,"@",2) D ENCHK Q:'$D(X)  S X=$P(SDW,"@"),X(1)="-" I X?.E1P.E,X'["-" F QX=1:1:$L(X) I $E(X,QX)?1P S X(1)=$E(X,QX) Q
"RTN","PSJSV",45,0)
 F Q=1:1:$L(X,X(1)) K:SWD="" X Q:SWD=""  S Z=$P(X,X(1),Q) D DWC Q:'$D(X)
"RTN","PSJSV",46,0)
 K X(1) S:$D(X) X=SDW Q
"RTN","PSJSV",47,0)
DWC I $L(Z)<2 K X Q
"RTN","PSJSV",48,0)
 F QX=1:1:$L(SWD,"^") S Y=$P(SWD,"^",QX) I $P(Y,Z)="" S SWD=$P(SWD,Y,2) S:$L(SWD) SWD=$E(SWD,2,50) Q
"RTN","PSJSV",49,0)
 E  K X
"RTN","PSJSV",50,0)
 Q
"RTN","PSJSV",51,0)
 ;
"RTN","PSJSV",52,0)
ENSNV ; schedule name
"RTN","PSJSV",53,0)
 I $S(X["""":1,$A(X)=45:1,X'?.ANP:1,$L(X)>20:1,$L(X)<2:1,1:X?1P.E) K X Q
"RTN","PSJSV",54,0)
 ;I $S('$D(PSJPP):0,PSJPP="":1,PSJPP'?.ANP:1,1:'$D(^DIC(9.4,"C",PSJPP))) K X
"RTN","PSJSV",55,0)
 ; changed to remove ref to 9.4,"C"
"RTN","PSJSV",56,0)
 N PSJRRF S PSJRRF=X
"RTN","PSJSV",57,0)
 K:$S('$D(PSJPP):0,PSJPP="":1,PSJPP'?.ANP:1,1:0) X I $D(X) N DA S X=PSJPP,DIC(0)="OX",DIC=9.4,D="C" D IX^DIC K:+Y'>0 X
"RTN","PSJSV",58,0)
 S X=PSJRRF
"RTN","PSJSV",59,0)
 I $D(DA),$D(^PS(51.1,DA,0)),$P(^(0),"^",5)["D" S ZX=X D DNVX S:$D(X) X=ZX K Z1,Z2,Z3,Z4,ZX
"RTN","PSJSV",60,0)
 Q
"RTN","PSJSV",61,0)
 ;
"RTN","PSJSV",62,0)
ENSHV ;  shift in 51.1
"RTN","PSJSV",63,0)
 ;I $S($L(X)>11:1,$L(X)<1:1,'$D(PSJPP):1,PSJPP="":1,PSJPP'?.ANP:1,1:'$D(^DIC(9.4,"C",PSJPP))) K X Q
"RTN","PSJSV",64,0)
 ; changed to remove ref to 9.4,"C"
"RTN","PSJSV",65,0)
 N PSJRRF S PSJRRF=X
"RTN","PSJSV",66,0)
 K:$S($L(X)>11:1,$L(X)<1:1,'$D(PSJPP):1,PSJPP="":1,PSJPP'?.ANP:1,1:0) X
"RTN","PSJSV",67,0)
 I $D(X) S X=PSJPP,DIC(0)="OX",DIC=9.4,D="C" D IX^DIC K:+Y'>0 X
"RTN","PSJSV",68,0)
 I '$D(X) Q
"RTN","PSJSV",69,0)
 S X=PSJRRF
"RTN","PSJSV",70,0)
 F X(1)=1:1:$L(X,"-") S X(2)=$P(X,"-",X(1)) I $S(X(2)="":1,X(2)'?.ANP:1,1:'$D(^PS(51.15,"ACP",PSJPP,X(2)))) K X Q
"RTN","PSJSV",71,0)
 K X(1),X(2) Q
"RTN","PSJSV",72,0)
 ;
"RTN","PSJSV",73,0)
ENVSST ;  shift start/stop times
"RTN","PSJSV",74,0)
 I X'?2N1"-"2N,X'?4N1"-"4N K X Q
"RTN","PSJSV",75,0)
 F X(1)=1,2 I $P(X,"-",X(1))>$S($L($P(X,"-",X(1)))<4:24,1:2400) K X Q
"RTN","PSJSV",76,0)
 K X(1) Q
"RTN","PSJSV",77,0)
 ;
"RTN","PSJSV",78,0)
ENFQD ; frequency default
"RTN","PSJSV",79,0)
 N X1,X2,Z S Z=$S($D(^PS(51.1,DA,0)):$P(^(0),"^"),1:""),X="" Q:Z=""
"RTN","PSJSV",80,0)
 I $E(Z,1,2)="AD" Q
"RTN","PSJSV",81,0)
 I $E(Z,1,3)="BID"!($E(Z,1,3)="TID")!($E(Z,1,3)="QID") S X=1440/$F("BTQ",$E(Z)) Q
"RTN","PSJSV",82,0)
 E  S:$E(Z)="Q" Z=$E(Z,2,99) S:'Z Z="1"_Z S X1=+Z,Z=$P(Z,+Z,2),X2=0 S:$E(Z)="X" X2=X1,Z=$E(Z,2,99) I 'X2,$E(Z)="O" S X2=.5,Z=$E(Z,2,99)
"RTN","PSJSV",83,0)
 S X=$S(Z["'":1,(Z["D"&(Z'["AD"))!(Z["AM")!(Z["PM")!(Z["HS"&(Z'["THS")):1440,Z["H"&(Z'["TH"):60,Z["AC"!(Z["PC"):480,Z["W":10080,Z["M":40320,1:"") Q:'X  S:X2 X=X\X2 S:'X2 X=X*X1 Q
"RTN","PSJSV",84,0)
 ;
"RTN","PSJSV",85,0)
ENDNV ; day of the week name
"RTN","PSJSV",86,0)
 N Z1,Z2,Z3,Z4 S X=$S($D(^PS(51.1,DA,0)):$P(^(0),"^"),1:"") I X="" K X Q
"RTN","PSJSV",87,0)
 ;
"RTN","PSJSV",88,0)
DNVX S Z2=1,Z4="-" I X'["-",X?.E1P.E F Z1=1:1:$L(X) I $E(X,Z1)?1P S Z4=$E(X,Z1) Q
"RTN","PSJSV",89,0)
 I X["@",X?.E1P.E S X=$P(X,"@")
"RTN","PSJSV",90,0)
 F Z1=1:1:$L(X,Z4) Q:'Z2  S Z2=0 I $L($P(X,Z4,Z1))>1 F Z3="MONDAYS","TUESDAYS","WEDNESDAYS","THURSDAYS","FRIDAYS","SATURDAYS","SUNDAYS" I $P(Z3,$P(X,Z4,Z1))="" S Z2=1 Q
"RTN","PSJSV",91,0)
 K:'Z2 X S:Z2 X="D" Q
"UP",55,55.01,-1)
55^IV
"UP",55,55.01,0)
55.01
"UP",55,55.06,-1)
55^5
"UP",55,55.06,0)
55.06
"VER")
8.0^22.0
"^DD",55,55.01,.09,0)
SCHEDULE^FXO^^0;9^K:X[""""!($A(X)=45)!($L(X," ")>$S(X["PRN":4,1:3)) X I $D(X) D EN^PSIVSP K:XT<0 X I $D(X) S PSIVSC=Y,$P(^PS(55,DA(1),"IV",DA,0),U,15)=+XT
"^DD",55,55.01,.09,1,0)
^.1
"^DD",55,55.01,.09,1,1,0)
55.01^AJ^MUMPS
"^DD",55,55.01,.09,1,1,1)
Q:$D(PSIVACT)  I '$D(DIU(0)) S PSIVF1=55.01,PSIVF2=.09 D ENTO^PSIVAL
"^DD",55,55.01,.09,1,1,2)
Q:$D(PSIVACT)  I '$D(DIU(0)) S PSIVF1=55.01,PSIVF2=.09 D ENFR^PSIVAL
"^DD",55,55.01,.09,1,1,"%D",0)
^^1^2920831^
"^DD",55,55.01,.09,1,1,"%D",1,0)
Used by IV Package.
"^DD",55,55.01,.09,2)
S Y(0)=Y S Y=$S($P(^PS(55,D0,"IV",D1,0),U,7):Y_"@0 labels a day.",1:Y)
"^DD",55,55.01,.09,2.1)
S Y=$S($P(^PS(55,D0,"IV",D1,0),U,7):Y_"@0 labels a day.",1:Y)
"^DD",55,55.01,.09,3)
Answer must be 1-70 characters in length.
"^DD",55,55.01,.09,4)

"^DD",55,55.01,.09,20,0)
^.3LA^1^1
"^DD",55,55.01,.09,20,1,0)
PSJI
"^DD",55,55.01,.09,21,0)
^^9^9^3001121^
"^DD",55,55.01,.09,21,1,0)
  You may enter a standard schedule here or non-standard schedule.  If a
"^DD",55,55.01,.09,21,2,0)
standard schedule is entered, the doses will be given at the administration
"^DD",55,55.01,.09,21,3,0)
time(s). If a non-standard schedule is entered, and no administration
"^DD",55,55.01,.09,21,4,0)
times are entered, the doses will be given at time intervals past the start
"^DD",55,55.01,.09,21,5,0)
date/time of the IV order.
"^DD",55,55.01,.09,21,6,0)
    TID = (09-17-21) doses will be given at admin. times.
"^DD",55,55.01,.09,21,7,0)
    Q5H = (300 minutes) doses will be given every 300 minutes.
"^DD",55,55.01,.09,21,8,0)
The format of this field is [SCHEDULEspaceFREETEXTspaceFREETEXT] and 1-70
"^DD",55,55.01,.09,21,9,0)
characters.
"^DD",55,55.01,.09,"DT")
3140924
"^DD",55,55.06,26,0)
SCHEDULE^RFX^^2;1^D SCH^PSSDDUT
"^DD",55,55.06,26,1,0)
^.1
"^DD",55,55.06,26,1,1,0)
55.06^AL43^MUMPS
"^DD",55,55.06,26,1,1,1)
I '$D(DIU(0)) D:$D(PSGAL(43))#2 KILL^PSGAL5:PSGAL(43)=X K PSGAL
"^DD",55,55.06,26,1,1,2)
I '$D(DIU(0)),'$D(PSGPO) S PSGAL(43)=X,PSGAL("C")=6000,PSGALFF=26 D ^PSGAL5
"^DD",55,55.06,26,1,1,3)
UNIT DOSE ACTIVITY LOG
"^DD",55,55.06,26,1,1,"%D",0)
^1^1^2920728
"^DD",55,55.06,26,1,1,"%D",1,0)
Used by Unit Dose to log any changes made to this field.
"^DD",55,55.06,26,1,2,0)
^^TRIGGER^55.06^41
"^DD",55,55.06,26,1,2,1)
I '$D(DIU(0)),$D(PSGS0Y) S DIU=$S($D(^PS(55,DA(1),5,DA,2)):$P(^(2),"^",5),1:"") I DIU'=PSGS0Y S $P(^(2),"^",5)=PSGS0Y I $O(^DD(55.06,41,1,0)) K DIV S (DIV(0),D0)=DA(1),(DIV(1),D1)=DA,DIV=PSGS0Y,DIH=55.06,DIG=41 D ^DICR
"^DD",55,55.06,26,1,2,2)
I '$D(DIU(0)),$D(PSGS0Y) S DIU=$S($D(^PS(55,DA(1),5,DA,2)):$P(^(2),"^",5),1:"") I DIU]"" S $P(^(2),"^",5)="" I $O(^DD(55.06,41,1,0)) K DIV S (DIV(0),D0)=DA(1),(DIV(1),D1)=DA,DIV="",DIH=55.06,DIG=41 D ^DICR
"^DD",55,55.06,26,1,2,"%D",0)
^^1^2920901^
"^DD",55,55.06,26,1,2,"%D",1,0)
Used to trigger data into field 41.
"^DD",55,55.06,26,1,2,"CREATE VALUE")
PSGS0Y
"^DD",55,55.06,26,1,2,"DELETE VALUE")
@
"^DD",55,55.06,26,1,2,"FIELD")
ADMIN. TIMES
"^DD",55,55.06,26,1,3,0)
^^TRIGGER^55.06^42
"^DD",55,55.06,26,1,3,1)
I $D(PSGS0XT) S DIU=$S($D(^PS(55,DA(1),5,DA,2)):$P(^(2),"^",6),1:"") I DIU'=PSGS0XT S $P(^(2),"^",6)=PSGS0XT I $O(^DD(55.06,42,1,0)) K DIV S (DIV(0),D0)=DA(1),(DIV(1),D1)=DA,DIV=PSGS0XT,DIH=55.06,DIG=42 D ^DICR
"^DD",55,55.06,26,1,3,2)
I $D(PSGS0XT) S DIU=$S($D(^PS(55,DA(1),5,DA,2)):$P(^(2),"^",6),1:"") I DIU]"" S $P(^(2),"^",6)="" I $O(^DD(55.06,42,1,0)) K DIV S (DIV(0),D0)=DA(1),(DIV(1),D1)=DA,DIV="",DIH=55.06,DIG=42 D ^DICR
"^DD",55,55.06,26,1,3,"%D",0)
^^1^2920901^
"^DD",55,55.06,26,1,3,"%D",1,0)
Used to trigger data into field 42.
"^DD",55,55.06,26,1,3,"CREATE VALUE")
PSGS0XT
"^DD",55,55.06,26,1,3,"DELETE VALUE")
@
"^DD",55,55.06,26,1,3,"FIELD")
FREQUENCY (in minutes)
"^DD",55,55.06,26,3)
Answer must be 1-70 characters in length.
"^DD",55,55.06,26,4)
D ENSH5^PSSDDUT
"^DD",55,55.06,26,9)
^
"^DD",55,55.06,26,20,0)
^.3LA^1^1
"^DD",55,55.06,26,20,1,0)
PSJU
"^DD",55,55.06,26,21,0)
^^12^12^3090601^
"^DD",55,55.06,26,21,1,0)
This is the frequency (ONLY) by which the doses are to be administered.  
"^DD",55,55.06,26,21,2,0)
Several forms of entry are acceptable, such as Q6H, 09-12-15, STAT, QOD, 
"^DD",55,55.06,26,21,3,0)
and MO-WE-FR@AD (where MO-WE-FR are days of the week, and AD is the admin 
"^DD",55,55.06,26,21,4,0)
times.) The schedule will show on the MAR, labels, etc. If the letters 
"^DD",55,55.06,26,21,5,0)
PRN are found as part of the schedule, no admin times will print on the 
"^DD",55,55.06,26,21,6,0)
MAR or labels, and the PICK LIST will always show a count of zero (0). 
"^DD",55,55.06,26,21,7,0)
Avoid using notation such as W/F (with food) or WM (with meals) in the 
"^DD",55,55.06,26,21,8,0)
schedule as it may cause erroneous calculations.  That information should 
"^DD",55,55.06,26,21,9,0)
be entered into the SPECIAL INSTRUCTIONS. When using the MO-WE-FR@AD 
"^DD",55,55.06,26,21,10,0)
schedule, please remember that this type of schedule will not work 
"^DD",55,55.06,26,21,11,0)
properly without the "@" character and at least one admin. time, and that 
"^DD",55,55.06,26,21,12,0)
at least the first two letters of each weekday entered is needed.
"^DD",55,55.06,26,"DT")
3090601
**END**
**END**
