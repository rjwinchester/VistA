KIDS Distribution saved on Jul 24, 2014@19:59:21
MOCHA 2.0 POST RELEASE FOLLOW UP PATCH V4
**KIDS**:MOCHA 2.0 POST RELEASE FOLLOW UP 1.0^PSJ*5.0*311^PSO*7.0*436^

**INSTALL NAME**
MOCHA 2.0 POST RELEASE FOLLOW UP 1.0
"BLD",8896,0)
MOCHA 2.0 POST RELEASE FOLLOW UP 1.0^^1^3140724^y
"BLD",8896,6.3)
3
"BLD",8896,10,0)
^9.63^2^2
"BLD",8896,10,1,0)
PSJ*5.0*311^1
"BLD",8896,10,2,0)
PSO*7.0*436^1
"BLD",8896,10,"B","PSJ*5.0*311",1)

"BLD",8896,10,"B","PSO*7.0*436",2)

"BLD",8896,"KRN",0)
^9.67PA^779.2^20
"BLD",8896,"KRN",.4,0)
.4
"BLD",8896,"KRN",.401,0)
.401
"BLD",8896,"KRN",.402,0)
.402
"BLD",8896,"KRN",.403,0)
.403
"BLD",8896,"KRN",.5,0)
.5
"BLD",8896,"KRN",.84,0)
.84
"BLD",8896,"KRN",3.6,0)
3.6
"BLD",8896,"KRN",3.8,0)
3.8
"BLD",8896,"KRN",9.2,0)
9.2
"BLD",8896,"KRN",9.8,0)
9.8
"BLD",8896,"KRN",19,0)
19
"BLD",8896,"KRN",19.1,0)
19.1
"BLD",8896,"KRN",101,0)
101
"BLD",8896,"KRN",409.61,0)
409.61
"BLD",8896,"KRN",771,0)
771
"BLD",8896,"KRN",779.2,0)
779.2
"BLD",8896,"KRN",870,0)
870
"BLD",8896,"KRN",8989.51,0)
8989.51
"BLD",8896,"KRN",8989.52,0)
8989.52
"BLD",8896,"KRN",8994,0)
8994
"BLD",8896,"KRN","B",.4,.4)

"BLD",8896,"KRN","B",.401,.401)

"BLD",8896,"KRN","B",.402,.402)

"BLD",8896,"KRN","B",.403,.403)

"BLD",8896,"KRN","B",.5,.5)

"BLD",8896,"KRN","B",.84,.84)

"BLD",8896,"KRN","B",3.6,3.6)

"BLD",8896,"KRN","B",3.8,3.8)

"BLD",8896,"KRN","B",9.2,9.2)

"BLD",8896,"KRN","B",9.8,9.8)

"BLD",8896,"KRN","B",19,19)

"BLD",8896,"KRN","B",19.1,19.1)

"BLD",8896,"KRN","B",101,101)

"BLD",8896,"KRN","B",409.61,409.61)

"BLD",8896,"KRN","B",771,771)

"BLD",8896,"KRN","B",779.2,779.2)

"BLD",8896,"KRN","B",870,870)

"BLD",8896,"KRN","B",8989.51,8989.51)

"BLD",8896,"KRN","B",8989.52,8989.52)

"BLD",8896,"KRN","B",8994,8994)

"MBREQ")
0
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"VER")
8.0^22.0
**INSTALL NAME**
PSJ*5.0*311
"BLD",8894,0)
PSJ*5.0*311^INPATIENT MEDICATIONS^0^3140724^y
"BLD",8894,4,0)
^9.64PA^^
"BLD",8894,6.3)
5
"BLD",8894,"ABPKG")
n
"BLD",8894,"INIT")
PSJ311PO
"BLD",8894,"KRN",0)
^9.67PA^779.2^20
"BLD",8894,"KRN",.4,0)
.4
"BLD",8894,"KRN",.401,0)
.401
"BLD",8894,"KRN",.402,0)
.402
"BLD",8894,"KRN",.403,0)
.403
"BLD",8894,"KRN",.5,0)
.5
"BLD",8894,"KRN",.84,0)
.84
"BLD",8894,"KRN",3.6,0)
3.6
"BLD",8894,"KRN",3.8,0)
3.8
"BLD",8894,"KRN",9.2,0)
9.2
"BLD",8894,"KRN",9.8,0)
9.8
"BLD",8894,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",8894,"KRN",9.8,"NM",1,0)
PSJIMO1^^0^B67864783
"BLD",8894,"KRN",9.8,"NM",2,0)
PSJ311PO^^0^B8179938
"BLD",8894,"KRN",9.8,"NM","B","PSJ311PO",2)

"BLD",8894,"KRN",9.8,"NM","B","PSJIMO1",1)

"BLD",8894,"KRN",19,0)
19
"BLD",8894,"KRN",19.1,0)
19.1
"BLD",8894,"KRN",101,0)
101
"BLD",8894,"KRN",409.61,0)
409.61
"BLD",8894,"KRN",771,0)
771
"BLD",8894,"KRN",779.2,0)
779.2
"BLD",8894,"KRN",870,0)
870
"BLD",8894,"KRN",8989.51,0)
8989.51
"BLD",8894,"KRN",8989.52,0)
8989.52
"BLD",8894,"KRN",8994,0)
8994
"BLD",8894,"KRN","B",.4,.4)

"BLD",8894,"KRN","B",.401,.401)

"BLD",8894,"KRN","B",.402,.402)

"BLD",8894,"KRN","B",.403,.403)

"BLD",8894,"KRN","B",.5,.5)

"BLD",8894,"KRN","B",.84,.84)

"BLD",8894,"KRN","B",3.6,3.6)

"BLD",8894,"KRN","B",3.8,3.8)

"BLD",8894,"KRN","B",9.2,9.2)

"BLD",8894,"KRN","B",9.8,9.8)

"BLD",8894,"KRN","B",19,19)

"BLD",8894,"KRN","B",19.1,19.1)

"BLD",8894,"KRN","B",101,101)

"BLD",8894,"KRN","B",409.61,409.61)

"BLD",8894,"KRN","B",771,771)

"BLD",8894,"KRN","B",779.2,779.2)

"BLD",8894,"KRN","B",870,870)

"BLD",8894,"KRN","B",8989.51,8989.51)

"BLD",8894,"KRN","B",8989.52,8989.52)

"BLD",8894,"KRN","B",8994,8994)

"BLD",8894,"QUES",0)
^9.62^^
"BLD",8894,"REQB",0)
^9.611^1^1
"BLD",8894,"REQB",1,0)
PSJ*5.0*299^2
"BLD",8894,"REQB","B","PSJ*5.0*299",1)

"INIT")
PSJ311PO
"MBREQ")
1
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
311^3140724^10000000068
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSJ311PO")
0^2^B8179938
"RTN","PSJ311PO",1,0)
PSJ311PO ;BIR/LE-Post Install routine for patch PSJ*5*311 ;06/12/14
"RTN","PSJ311PO",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**311**;9/30/97;Build 5
"RTN","PSJ311PO",3,0)
 ;
"RTN","PSJ311PO",4,0)
QUE ;
"RTN","PSJ311PO",5,0)
 N NAMSP,PATCH,JOBN,ZTSK,ZTRTN,ZTIO,ZTDTH,ZTDESC,Y,ZTQUEUED,ZTREQ,ZTSAVE,CNT,SBJM
"RTN","PSJ311PO",6,0)
 S NAMSP="PSJ311PO"
"RTN","PSJ311PO",7,0)
 S JOBN="PSJ*5*311 Post Install"
"RTN","PSJ311PO",8,0)
 S PATCH="PSJ*5*311"
"RTN","PSJ311PO",9,0)
 S Y=$$NOW^XLFDT S ZTDTH=$$FMTH^XLFDT(Y)
"RTN","PSJ311PO",10,0)
 ;
"RTN","PSJ311PO",11,0)
 D BMES^XPDUTL("=============================================================")
"RTN","PSJ311PO",12,0)
 D MES^XPDUTL("Queuing background job for "_JOBN_"...")
"RTN","PSJ311PO",13,0)
 D MES^XPDUTL("Start time: "_$$HTE^XLFDT(ZTDTH))
"RTN","PSJ311PO",14,0)
 D MES^XPDUTL("A MailMan message will be sent to the installer upon Post")
"RTN","PSJ311PO",15,0)
 D MES^XPDUTL("Install Completion.  This may take 2-3 hours.")
"RTN","PSJ311PO",16,0)
 D MES^XPDUTL("==============================================================")
"RTN","PSJ311PO",17,0)
 ;
"RTN","PSJ311PO",18,0)
 S ZTRTN="EN^"_NAMSP,ZTIO=""
"RTN","PSJ311PO",19,0)
 S (SBJM,ZTDESC)="Background job for "_JOBN
"RTN","PSJ311PO",20,0)
 S ZTSAVE("JOBN")="",ZTSAVE("ZTDTH")="",ZTSAVE("DUZ")="",ZTSAVE("SBJM")=""
"RTN","PSJ311PO",21,0)
 D ^%ZTLOAD
"RTN","PSJ311PO",22,0)
 D:$D(ZTSK)
"RTN","PSJ311PO",23,0)
 . D MES^XPDUTL("*** Task #"_ZTSK_" Queued! ***")
"RTN","PSJ311PO",24,0)
 . D BMES^XPDUTL("")
"RTN","PSJ311PO",25,0)
 . S ZTSAVE("ZTSK")=""
"RTN","PSJ311PO",26,0)
 D BMES^XPDUTL("")
"RTN","PSJ311PO",27,0)
 K XPDQUES
"RTN","PSJ311PO",28,0)
 Q
"RTN","PSJ311PO",29,0)
 ;
"RTN","PSJ311PO",30,0)
EN ;Do Mail Message
"RTN","PSJ311PO",31,0)
 N DFN,DA,STARTH,STOPH,SUBJ
"RTN","PSJ311PO",32,0)
 S STARTH=$$HTE^XLFDT(ZTDTH)
"RTN","PSJ311PO",33,0)
 K DIK S DIK="^PS(53.1,",DIK(1)="113^CIMO" D ENALL^DIK
"RTN","PSJ311PO",34,0)
 K DIK S DFN=0 F  S DFN=$O(^PS(55,DFN)) Q:'DFN  S DA(1)=DFN D
"RTN","PSJ311PO",35,0)
 .S DIK="^PS(55,"_DA(1)_",5,",DIK(1)="130^CIMOU" D ENALL^DIK
"RTN","PSJ311PO",36,0)
 .S DIK="^PS(55,"_DA(1)_",5,",DIK(1)="130^CIMOCLU" D ENALL^DIK
"RTN","PSJ311PO",37,0)
 .S DIK="^PS(55,"_DA(1)_","_"""IV"""_",",DIK(1)="136^CIMOI" D ENALL^DIK
"RTN","PSJ311PO",38,0)
 .S DIK="^PS(55,"_DA(1)_","_"""IV"""_",",DIK(1)="136^CIMOCLI" D ENALL^DIK
"RTN","PSJ311PO",39,0)
 K DIK
"RTN","PSJ311PO",40,0)
 ;
"RTN","PSJ311PO",41,0)
 ;Send message
"RTN","PSJ311PO",42,0)
 S CNT=1
"RTN","PSJ311PO",43,0)
 S Y=$$NOW^XLFDT S STOPH=$$FMTH^XLFDT(Y),STOPH=$$HTE^XLFDT(STOPH)
"RTN","PSJ311PO",44,0)
 S SUBJ="PSJ*5*311 POST INSTALL Complete"
"RTN","PSJ311PO",45,0)
 S MSG(CNT)="The new cross references for clinic orders have been created:",CNT=CNT+1
"RTN","PSJ311PO",46,0)
 S MSG(CNT)="     File 53.1 - CIMO",CNT=CNT+1
"RTN","PSJ311PO",47,0)
 S MSG(CNT)="      File 55  - CIMOU and CIMOCLU for Unit Dose Sub-file.",CNT=CNT+1
"RTN","PSJ311PO",48,0)
 S MSG(CNT)="      File 55  - CIMOI AND CIMOCLI for IV Sub-file.",CNT=CNT+1
"RTN","PSJ311PO",49,0)
 S MSG(CNT)=" ",CNT=CNT+1
"RTN","PSJ311PO",50,0)
 S MSG(CNT)="The background job "_ZTSK_" began "_STARTH_" and ",CNT=CNT+1
"RTN","PSJ311PO",51,0)
 S MSG(CNT)="ended "_STOPH_".",CNT=CNT+1
"RTN","PSJ311PO",52,0)
 D MAIL(.MSG,SUBJ)
"RTN","PSJ311PO",53,0)
 Q
"RTN","PSJ311PO",54,0)
 ;
"RTN","PSJ311PO",55,0)
MAIL(MSG,SBJ) ; Send out some mail!
"RTN","PSJ311PO",56,0)
 N DIFROM,XMDUZ,XMSUB,XMTEXT,XMY,I
"RTN","PSJ311PO",57,0)
 S XMDUZ="INPT PHARMACY",XMSUB=SBJM,XMTEXT="MSG("
"RTN","PSJ311PO",58,0)
 S XMY(DUZ)=""
"RTN","PSJ311PO",59,0)
 D ^XMD
"RTN","PSJ311PO",60,0)
 Q ""
"RTN","PSJ311PO",61,0)
 ;
"RTN","PSJIMO1")
0^1^B67864783
"RTN","PSJIMO1",1,0)
PSJIMO1 ;BIR/LE-IMO UTILITIES AND XREFS ;16 Mar 99 / 10:22 AM
"RTN","PSJIMO1",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**257,299,311**;16 DEC 97;Build 5
"RTN","PSJIMO1",3,0)
 ;External reference to ^PS(55 supported by DBIA 2191
"RTN","PSJIMO1",4,0)
 ;External reference to ^PSSDSAPI supported by DBIA 5425
"RTN","PSJIMO1",5,0)
 ;External Reference to ^DPTLK is supported by DBIA 3787
"RTN","PSJIMO1",6,0)
 ;
"RTN","PSJIMO1",7,0)
IMO(CLINICS) ;called from ENCD^PSGFILED WHICH IS CLINIC DEFINITION OPTION IN INPATIENT MEDS
"RTN","PSJIMO1",8,0)
 W !!,"Verifying IMO clinic cross references...",!
"RTN","PSJIMO1",9,0)
 N CLINFLG,IMOCLIEN,PSJIMOCL,PSJCLIN,FLAG S FLAG=""
"RTN","PSJIMO1",10,0)
 S (CLINFLG,CLINIC,PSJIMOCL,IMOCLIEN)=""
"RTN","PSJIMO1",11,0)
 F  S IMOCLIEN=$O(CLINICS(IMOCLIEN)) Q:IMOCLIEN=""  S PSJIMOCL=$$GET1^DIQ(53.46,IMOCLIEN,.01,"I"),CLINFLG=$$GET1^DIQ(44,PSJIMOCL,2802,"I") D
"RTN","PSJIMO1",12,0)
 .I 'CLINFLG D IMOKILL(PSJIMOCL,CLINFLG) Q  ;CLINFLG=ADIMINISTER INPATIENT MEDS? true means IMO clinic; false means not IMO
"RTN","PSJIMO1",13,0)
 .I CLINFLG D IMOSET(PSJIMOCL,CLINFLG)
"RTN","PSJIMO1",14,0)
 I FLAG W !,"IMO cross references have been updated.",!
"RTN","PSJIMO1",15,0)
 Q
"RTN","PSJIMO1",16,0)
 ;
"RTN","PSJIMO1",17,0)
IMOSET(PSJCLIN,PSJIMOF) ;
"RTN","PSJIMO1",18,0)
 ;Clinic order means Yes is answered to ADMINISTER INPATIENT MEDS field in file 44, a clinic and appointment date/time is defined.
"RTN","PSJIMO1",19,0)
 ;Q:$D(^PS("CIMOCLU",CLINIC))!($D(^PS("CIMOCLI",CLINIC)))
"RTN","PSJIMO1",20,0)
 N CLNDAYS,PSJAPTDT,PSJTODAY,X1,X2,PATIENT,PSJSTDT,PS55IEN,PS531IEN,PSJXREF,PSJTYPE,APPTDT,PSJUTMP,PSJSTART
"RTN","PSJIMO1",21,0)
 S CLNDAYS=$$GET1^DIQ(53.46,CLINIC,6)
"RTN","PSJIMO1",22,0)
 S:CLNDAYS="" CLNDAYS=30  ;default to 30 days if not defined
"RTN","PSJIMO1",23,0)
 D NOW^%DTC S (X1,PSJTODAY)=%,X2=-CLNDAYS D C^%DTC S PSJSTART=X
"RTN","PSJIMO1",24,0)
 ;FILE 55
"RTN","PSJIMO1",25,0)
 F PSJXREF="AUDC","AIVC" S PSJSTDT=PSJSTART F  S PSJSTDT=$O(^PS(55,PSJXREF,PSJSTDT)) Q:PSJSTDT=""  D
"RTN","PSJIMO1",26,0)
 .S PATIENT="" F  S PATIENT=$O(^PS(55,PSJXREF,PSJSTDT,PSJCLIN,PATIENT)) Q:PATIENT=""  S PS55IEN="" F  S PS55IEN=$O(^PS(55,PSJXREF,PSJSTDT,PSJCLIN,PATIENT,PS55IEN)) Q:PS55IEN=""  D
"RTN","PSJIMO1",27,0)
 ..I PSJXREF="AUDC" S PSJAPTDT=$$GET1^DIQ(55.06,PS55IEN_","_PATIENT_",",131) I PSJAPTDT'="" S ^PS(55,"CIMOU",PATIENT,PSJCLIN,PSJSTDT,PATIENT,PS55IEN)=""
"RTN","PSJIMO1",28,0)
 ..I PSJXREF="AIVC" S PSJAPTDT=$$GET1^DIQ(55.01,PS55IEN_","_PATIENT_",",139) I PSJAPTDT'="" S ^PS(55,PATIENT,"IV","CIMOI",PSJCLIN,PSJSTDT,PS55IEN)=""
"RTN","PSJIMO1",29,0)
 ..I PSJAPTDT'="" S FLAG=1
"RTN","PSJIMO1",30,0)
 ;
"RTN","PSJIMO1",31,0)
 ;FILE 53.1
"RTN","PSJIMO1",32,0)
 S (PATIENT,PS531IEN)=""
"RTN","PSJIMO1",33,0)
 F  S PATIENT=$O(^PS(53.1,"AD",PSJCLIN,PATIENT)) Q:PATIENT=""  F  S PS531IEN=$O(^PS(53.1,"AD",PSJCLIN,PATIENT,PS531IEN)) Q:PS531IEN=""  D
"RTN","PSJIMO1",34,0)
 .K PSJUTMP D GETS^DIQ(53.1,PS531IEN,"28;126","I","PSJUTMP")
"RTN","PSJIMO1",35,0)
 .S (APPTDT,PSJTYPE)=""
"RTN","PSJIMO1",36,0)
 .S:$D(PSJUTMP(53.1,PS531IEN_",",126,"I")) APPTDT=PSJUTMP(53.1,PS531IEN_",",126,"I")
"RTN","PSJIMO1",37,0)
 .S:$D(PSJUTMP(53.1,PS531IEN_",",28,"I")) PSJTYPE=PSJUTMP(53.1,PS531IEN_",",28,"I")
"RTN","PSJIMO1",38,0)
 .Q:PSJTYPE'="P"&(PSJTYPE'="N")
"RTN","PSJIMO1",39,0)
 .Q:APPTDT=""!'CLINFLG
"RTN","PSJIMO1",40,0)
 .S ^PS(53.1,"CIMO",PATIENT,PSJCLIN,PS531IEN)="",FLAG=1
"RTN","PSJIMO1",41,0)
 Q
"RTN","PSJIMO1",42,0)
 ;
"RTN","PSJIMO1",43,0)
IMOKILL(CLINIC,PSCLINIC) ;
"RTN","PSJIMO1",44,0)
 S:'$G(PSCLINIC) PSCLINIC=""
"RTN","PSJIMO1",45,0)
 I $D(^PS(55,"CIMOCLU",CLINIC)) S PATIENT="" F  S PATIENT=$O(^PS(55,"CIMOCLU",CLINIC,PATIENT)) Q:PATIENT=""  D
"RTN","PSJIMO1",46,0)
 .K ^PS(55,"CIMOU",PATIENT,CLINIC)
"RTN","PSJIMO1",47,0)
 I $D(^PS(55,"CIMOCLI",CLINIC)) S PATIENT="" F  S PATIENT=$O(^PS(55,"CIMOCLU",CLINIC,PATIENT)) Q:PATIENT=""  D
"RTN","PSJIMO1",48,0)
 .K ^PS(55,PATIENT,"IV","CIMOI",CLINIC)
"RTN","PSJIMO1",49,0)
 K ^PS(55,"CIMOCLU",CLINIC),^PS(55,"CIMOCLI",CLINIC)
"RTN","PSJIMO1",50,0)
 I $D(^PS(53.1,"AD",CLINIC)) S PATIENT="" F  S PATIENT=$O(^PS(53.1,"AD",CLINIC,PATIENT)) Q:PATIENT=""  D
"RTN","PSJIMO1",51,0)
 .I $D(^PS(53.1,"CIMO",PATIENT,CLINIC)) K ^PS(53.1,"CIMO",PATIENT,CLINIC)
"RTN","PSJIMO1",52,0)
 Q
"RTN","PSJIMO1",53,0)
 ;
"RTN","PSJIMO1",54,0)
CIMOU(PSGP,PSJDA55,PSCLINIC,PSJDA531) ;IMO UNIT DOSE FILE 55 CROSS REFERENCE SET
"RTN","PSJIMO1",55,0)
 N PSJCLINI,CLINFLG,PSJIVIEN,PSJSTAT
"RTN","PSJIMO1",56,0)
 S PSJSTAT=""
"RTN","PSJIMO1",57,0)
 I '$G(PSCLINIC) S PSCLINIC="",PSCLINIC=$$GET1^DIQ(55.06,+PSJDA55_","_PSGP_",",130,"I")
"RTN","PSJIMO1",58,0)
 Q:PSCLINIC=""
"RTN","PSJIMO1",59,0)
 S CLINFLG="",CLINFLG=$$GET1^DIQ(44,PSCLINIC,2802,"I")  ;Only set xref if IMO clinic
"RTN","PSJIMO1",60,0)
 Q:'CLINFLG
"RTN","PSJIMO1",61,0)
 D GETS^DIQ(55.06,+PSJDA55_","_PSGP_",","34;131","I","PSJCLINI")
"RTN","PSJIMO1",62,0)
 I CLINFLG&($G(PSJCLINI(55.06,+PSJDA55_","_PSGP_",","131","I"))) D
"RTN","PSJIMO1",63,0)
 .S ^PS(55,"CIMOU",PSGP,PSCLINIC,PSJCLINI(55.06,+PSJDA55_","_PSGP_",","34","I"),PSGP,+PSJDA55)=""
"RTN","PSJIMO1",64,0)
 .S ^PS(55,"CIMOCLU",PSCLINIC,PSGP,+PSJDA55)=""
"RTN","PSJIMO1",65,0)
 S PSJIVIEN=$$GET1^DIQ(55.06,+PSJDA55_","_DFN_",",104)  ;pick up ien from file 55 since PSJORD/PSGORD can't be trusted.
"RTN","PSJIMO1",66,0)
 S:PSJIVIEN="" PSJIVIEN=PSJDA531
"RTN","PSJIMO1",67,0)
 I '$D(^PS(53.1,"CIMO",PSGP,PSCLINIC,PSJIVIEN)) S PSJIVIEN=PSJDA531  ;for edits, if no CIMO entry, use the passed in IEN.  Non-edits will always have an entry.
"RTN","PSJIMO1",68,0)
 I +$G(PSJIVIEN) D KILL531(PSGP,PSCLINIC,+PSJIVIEN)
"RTN","PSJIMO1",69,0)
 Q
"RTN","PSJIMO1",70,0)
 ;
"RTN","PSJIMO1",71,0)
CIMOI(DFN,PSJDA55,PSCLINIC,PSJDA531) ;IMO IV FILE 55 CROSS REFERENCE SET
"RTN","PSJIMO1",72,0)
 N PSJCLINI,CLINFLG,PSJIVIEN,PSJSTAT
"RTN","PSJIMO1",73,0)
 S PSJSTAT=""
"RTN","PSJIMO1",74,0)
 I '$G(PSCLINIC) S PSCLINIC=$$GET1^DIQ(55.01,+PSJDA55_","_DFN_",",136,"I")
"RTN","PSJIMO1",75,0)
 Q:PSCLINIC=""
"RTN","PSJIMO1",76,0)
 S CLINFLG="",CLINFLG=$$GET1^DIQ(44,PSCLINIC,2802,"I")  ;Only set xref if IMO clinic
"RTN","PSJIMO1",77,0)
 Q:'CLINFLG
"RTN","PSJIMO1",78,0)
 D GETS^DIQ(55.01,+PSJDA55_","_DFN_",",".03","I","PSJCLINI")
"RTN","PSJIMO1",79,0)
 I $D(PSJCLINI(55.01,+PSJDA55_","_DFN_",",".03","I")) D
"RTN","PSJIMO1",80,0)
 .S ^PS(55,DFN,"IV","CIMOI",PSCLINIC,PSJCLINI(55.01,+PSJDA55_","_DFN_",",".03","I"),+PSJDA55)=""
"RTN","PSJIMO1",81,0)
 .S ^PS(55,"CIMOCLI",PSCLINIC,DFN,+PSJDA55)=""
"RTN","PSJIMO1",82,0)
 S PSJIVIEN=$$GET1^DIQ(55.01,+ON55_","_DFN_",",113)  ;if there, pick up ien from file 55 since PSJORD/PSGORD can't be trusted.
"RTN","PSJIMO1",83,0)
 I PSJIVIEN=""&(+$G(PSJDA531)) S PSJIVIEN=PSJDA531
"RTN","PSJIMO1",84,0)
 ;I '$D(^PS(53.1,"CIMO",PSGP,PSCLINIC,PSJIVIEN)) S PSJIVIEN=PSJDA531  ;for edits, if no CIMO entry, use the passed in IEN.  Non-edits will always have an entry.
"RTN","PSJIMO1",85,0)
 I +$G(PSJIVIEN) D KILL531(DFN,PSCLINIC,+PSJIVIEN)
"RTN","PSJIMO1",86,0)
 Q
"RTN","PSJIMO1",87,0)
 ;
"RTN","PSJIMO1",88,0)
KILL531(PSJCLPAT,PSCLINIC,PSJIVIEN) ;
"RTN","PSJIMO1",89,0)
 I '$G(PSCLINIC) S PSCLINIC=$$GET1^DIQ(53.1,+PSJIVIEN_","_PSJCLPAT_",",113,"I")
"RTN","PSJIMO1",90,0)
 Q:PSCLINIC=""
"RTN","PSJIMO1",91,0)
 I $D(^PS(53.1,"CIMO",PSJCLPAT,PSCLINIC,+PSJIVIEN)) K ^PS(53.1,"CIMO",PSJCLPAT,PSCLINIC,+PSJIVIEN)
"RTN","PSJIMO1",92,0)
 Q
"RTN","PSJIMO1",93,0)
 ;
"RTN","PSJIMO1",94,0)
GETCLN(PSGP,ORDER) ; Return Clinic IEN for a given patient/order combination
"RTN","PSJIMO1",95,0)
 I '$G(ORDER) Q ""
"RTN","PSJIMO1",96,0)
 N CLN S CLN=$S(ORDER["P":$G(^PS(53.1,+ORDER,"DSS")),ORDER["V":$G(^PS(55,PSGP,"IV",+ORDER,"DSS")),ORDER["U":$G(^PS(55,PSGP,5,+ORDER,8)),1:"")
"RTN","PSJIMO1",97,0)
 I 'CLN,(ORDER=+ORDER) D
"RTN","PSJIMO1",98,0)
 .I $D(^PS(53.1,"ACX",+ORDER)) N PSJORD S PSJORD=0 F  S PSJORD=$O(^PS(53.1,"ACX",+ORDER,PSJORD)) Q:'PSJORD!$G(CLN)  S CLN=$G(^PS(53.1,+PSJORD,"DSS"))
"RTN","PSJIMO1",99,0)
 .I $D(^PS(55,"ACX",+ORDER)) N ACX2,PSJORD S ACX2="" F  S ACX2=$O(^PS(55,"ACX",+ORDER,ACX2)) Q:'ACX2!$G(CLN)  S PSJORD=0 F  S PSJORD=$O(^PS(55,"ACX",+ORDER,ACX2,PSJORD)) Q:'PSJORD!$G(CLN)  D
"RTN","PSJIMO1",100,0)
 ..S CLN=$S(PSJORD["P":$G(^PS(53.1,+PSJORD,"DSS")),PSJORD["V":$G(^PS(55,PSGP,"IV",+PSJORD,"DSS")),ORDER["U":$G(^PS(55,PSGP,5,+PSJORD,8)),1:"")
"RTN","PSJIMO1",101,0)
 Q +CLN
"RTN","PSJIMO1",102,0)
 ;
"RTN","PSJIMO1",103,0)
CHECK() ;SET CONDITION FOR CIMOU XREF IN FILE 55
"RTN","PSJIMO1",104,0)
 ;UNIT DOSE - X2(1)=PATIENT, X2(2)=CLINIC, X2(3)=STOP DATE
"RTN","PSJIMO1",105,0)
 N PSJAPPTD,X S X=0
"RTN","PSJIMO1",106,0)
 Q:'$$IMOCHK(X2(2)) 0  ;don't set clinic x-refs where clinic isn't marked as IMO.
"RTN","PSJIMO1",107,0)
 S PSJAPPTD=$$GET1^DIQ(55.06,DA_","_X2(1)_",",131,"I")
"RTN","PSJIMO1",108,0)
 S:PSJAPPTD'="" X=1
"RTN","PSJIMO1",109,0)
 Q X
"RTN","PSJIMO1",110,0)
 ;
"RTN","PSJIMO1",111,0)
CHECK2() ;SET CONDITION FOR CIMOI XREF IN FILE 55
"RTN","PSJIMO1",112,0)
 ;IV - DA(1)=PATIENT, X2(1)=CLINIC, X2(2)=STOP DATE, DA=SUBFILE IEN
"RTN","PSJIMO1",113,0)
 N PSJAPPTD,X S X=0
"RTN","PSJIMO1",114,0)
 Q:'$$IMOCHK(X2(1)) 0  ;don't set clinic x-refs where clinic isn't marked as IMO.
"RTN","PSJIMO1",115,0)
 S PSJAPPTD=$$GET1^DIQ(55.01,DA_","_DA(1)_",",139,"I")
"RTN","PSJIMO1",116,0)
 S:PSJAPPTD'="" X=1
"RTN","PSJIMO1",117,0)
 Q X
"RTN","PSJIMO1",118,0)
 ;
"RTN","PSJIMO1",119,0)
IMOCHK(PSJIMOCL) ;determine if clinic is an IMO clinic; returns 1 if IMO or 0 not IMO
"RTN","PSJIMO1",120,0)
 Q:'$G(PSJIMOCL) 0
"RTN","PSJIMO1",121,0)
 N PSJCFLAG
"RTN","PSJIMO1",122,0)
 S PSJCFLAG=$$GET1^DIQ(44,PSJIMOCL,2802,"I")
"RTN","PSJIMO1",123,0)
 Q PSJCFLAG
"RTN","PSJIMO1",124,0)
 ;
"RTN","PSJIMO1",125,0)
CHECK3() ;SET CONDITION FOR CIMO XREF IN FILE 53.1
"RTN","PSJIMO1",126,0)
 ;  DA=IEN, X(1)=PATIENT, X(2)=CLINIC
"RTN","PSJIMO1",127,0)
 N PSJCFLAG,PSJAPPTD,X,PSJTYPE,PSJUTMP S X=0
"RTN","PSJIMO1",128,0)
 Q:'$$IMOCHK(X2(2)) 0  ;don't set clinic x-refs where clinic isn't marked as IMO.
"RTN","PSJIMO1",129,0)
 D GETS^DIQ(53.1,DA,"28;126","I","PSJUTMP")
"RTN","PSJIMO1",130,0)
 S X=0,(PSJAPPTD,PSJTYPE)=""
"RTN","PSJIMO1",131,0)
 S:$D(PSJUTMP(53.1,DA_",",126,"I")) PSJAPPTD=PSJUTMP(53.1,DA_",",126,"I")
"RTN","PSJIMO1",132,0)
 S:$D(PSJUTMP(53.1,DA_",",28,"I")) PSJTYPE=PSJUTMP(53.1,DA_",",28,"I")
"RTN","PSJIMO1",133,0)
 Q:PSJTYPE'="P"&(PSJTYPE'="N") 0  ;only pending and non-verified orders are allowed in the xref
"RTN","PSJIMO1",134,0)
 S:PSJAPPTD'="" X=1
"RTN","PSJIMO1",135,0)
 Q X
"RTN","PSJIMO1",136,0)
 ;
"RTN","PSJIMO1",137,0)
TEST ;KILL ALL IMO CROSS REFERENCES FOR A PARTICULAR CLINIC AND PATIENT
"RTN","PSJIMO1",138,0)
 N PSJTESCL,PSJTESPA
"RTN","PSJIMO1",139,0)
TEST2 ;
"RTN","PSJIMO1",140,0)
 K DIC S DIC="^PS(53.46,",DIC(0)="AELMQ",DIC("A")="Select CLINIC: ",DLAYGO=53.46 D ^DIC K DIC G DONE:Y=""!(Y<1)
"RTN","PSJIMO1",141,0)
 S PSJTESCL=$P(Y,"^",2)
"RTN","PSJIMO1",142,0)
 K DIC,PSGP,Y W !!,"Select "_$S($D(PSGDICA):PSGDICA_" ",1:"")_"PATIENT: " R X:DTIME S:'$T X="^" W:'$T $C(7) I "^"[X S (Y,PSGP)=-1 S QFLG=1 G DONE
"RTN","PSJIMO1",143,0)
 K DIC S DIC="^DPT(",DIC("W")="D DPT^PSJDPT",DIC(0)="QEMZ" D ^DPTLK K DIC
"RTN","PSJIMO1",144,0)
 S PSJTESPA=$P(Y,"^")
"RTN","PSJIMO1",145,0)
 ;
"RTN","PSJIMO1",146,0)
 K ^PS(55,PSJTESPA,"IV","CIMOI",PSJTESCL)
"RTN","PSJIMO1",147,0)
 K ^PS(55,"CIMOCLI",PSJTESCL)
"RTN","PSJIMO1",148,0)
 K ^PS(55,"CIMOU",PSJTESPA,PSJTESCL)
"RTN","PSJIMO1",149,0)
 K ^PS(55,"CIMOCLU",PSJTESCL)
"RTN","PSJIMO1",150,0)
 K ^PS(53.1,"CIMO",PSJTESPA,PSJTESCL)
"RTN","PSJIMO1",151,0)
 W !,"DELETED",!
"RTN","PSJIMO1",152,0)
DONE ;
"RTN","PSJIMO1",153,0)
 Q
"RTN","PSJIMO1",154,0)
 ;
"RTN","PSJIMO1",155,0)
CLEAN(DFN) ;Delete old entriers from clinic order xref; CALLED WHEN USER EXITS PATIENT IN IOE
"RTN","PSJIMO1",156,0)
 ;----get top of the range of dates stored for each clinic
"RTN","PSJIMO1",157,0)
 N PSCLINIC,PSTYPE,ENDDATE,RXDATE,CLNDAYS,CLNARRY,PSJIEN
"RTN","PSJIMO1",158,0)
 S (PSTYPE,PSCLINIC,CLNDAYS,CLNARRY)=""
"RTN","PSJIMO1",159,0)
 F PSTYPE="CIMOCLU","CIMOCLI" F  S PSCLINIC=$O(^PS(55,PSTYPE,PSCLINIC)) Q:PSCLINIC=""  D
"RTN","PSJIMO1",160,0)
 .S CLNDAYS=$$GET1^DIQ(53.46,PSCLINIC,6) S:CLNDAYS="" CLNDAYS=30  ;default to 30 days if not defined
"RTN","PSJIMO1",161,0)
 .D NOW^%DTC S X1=%,X2=-CLNDAYS D C^%DTC S CLNARRY($S(PSTYPE="CIMOCLU":"U",1:"V"),PSCLINIC)=X
"RTN","PSJIMO1",162,0)
 ;----kill x-refs for all unit dose entries older than the clinic begin date
"RTN","PSJIMO1",163,0)
 I $D(CLNARRY("U")) S PSCLINIC="" F  S PSCLINIC=$O(CLNARRY("U",PSCLINIC)) Q:PSCLINIC=""  D
"RTN","PSJIMO1",164,0)
 .S (RXDATE,ENDDATE)="",ENDDATE=CLNARRY("U",PSCLINIC)
"RTN","PSJIMO1",165,0)
 .F  S RXDATE=$O(^PS(55,"CIMOU",DFN,PSCLINIC,RXDATE)) Q:RXDATE=""  I RXDATE<ENDDATE K ^PS(55,"CIMOU",DFN,PSCLINIC,RXDATE) D
"RTN","PSJIMO1",166,0)
 ..S PSJIEN="" F  S PSJIEN=$O(^PS(55,"CIMOU",DFN,PSCLINIC,RXDATE,DFN,PSJIEN)) Q:PSJIEN=""  K ^PS(55,"CIMOU",DFN,PSCLINIC,RXDATE,DFN,PSJIEN)
"RTN","PSJIMO1",167,0)
 ;----kill x-refs for all IV entries older than the clinic begin date
"RTN","PSJIMO1",168,0)
 I $D(CLNARRY("V")) S PSCLINIC="" F  S PSCLINIC=$O(CLNARRY("V",PSCLINIC)) Q:PSCLINIC=""  D
"RTN","PSJIMO1",169,0)
 .S (RXDATE,ENDDATE)="",ENDDATE=CLNARRY("V",PSCLINIC)
"RTN","PSJIMO1",170,0)
 .F  S RXDATE=$O(^PS(55,DFN,"IV","CIMOI",PSCLINIC,RXDATE)) Q:RXDATE=""  I RXDATE<ENDDATE K ^PS(55,DFN,"IV","CIMOI",PSCLINIC,RXDATE) D
"RTN","PSJIMO1",171,0)
 ..S PSJIEN="" F  S PSJIEN=$O(^PS(55,DFN,"IV","CIMOI",PSCLINIC,RXDATE,PSJIEN)) Q:PSJIEN=""  K ^PS(55,DFN,"IV","CIMOI",PSCLINIC,RXDATE,PSJIEN)
"RTN","PSJIMO1",172,0)
 Q
"RTN","PSJIMO1",173,0)
 ;
"VER")
8.0^22.0
**INSTALL NAME**
PSO*7.0*436
"BLD",8895,0)
PSO*7.0*436^OUTPATIENT PHARMACY^0^3140724^y
"BLD",8895,4,0)
^9.64PA^52^1
"BLD",8895,4,52,0)
52
"BLD",8895,4,52,2,0)
^9.641^52.0725^1
"BLD",8895,4,52,2,52.0725,0)
NATIONAL DATA UTILITY CLEANUP  (sub-file)
"BLD",8895,4,52,2,52.0725,1,0)
^9.6411^^
"BLD",8895,4,52,222)
y^y^p^^^^n^^n
"BLD",8895,4,52,224)

"BLD",8895,4,"APDD",52,52.0725)

"BLD",8895,4,"B",52,52)

"BLD",8895,6.3)
5
"BLD",8895,"ABPKG")
n
"BLD",8895,"KRN",0)
^9.67PA^779.2^20
"BLD",8895,"KRN",.4,0)
.4
"BLD",8895,"KRN",.401,0)
.401
"BLD",8895,"KRN",.402,0)
.402
"BLD",8895,"KRN",.403,0)
.403
"BLD",8895,"KRN",.5,0)
.5
"BLD",8895,"KRN",.84,0)
.84
"BLD",8895,"KRN",3.6,0)
3.6
"BLD",8895,"KRN",3.8,0)
3.8
"BLD",8895,"KRN",9.2,0)
9.2
"BLD",8895,"KRN",9.8,0)
9.8
"BLD",8895,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",8895,"KRN",9.8,"NM",1,0)
PSOORNEW^^0^B93914156
"BLD",8895,"KRN",9.8,"NM",2,0)
PSOLMPO^^0^B1379839
"BLD",8895,"KRN",9.8,"NM",3,0)
PSODOSUT^^0^B130783308
"BLD",8895,"KRN",9.8,"NM",4,0)
PSODOSU2^^0^B115401790
"BLD",8895,"KRN",9.8,"NM",5,0)
PSODOSUN^^0^B93344191
"BLD",8895,"KRN",9.8,"NM","B","PSODOSU2",4)

"BLD",8895,"KRN",9.8,"NM","B","PSODOSUN",5)

"BLD",8895,"KRN",9.8,"NM","B","PSODOSUT",3)

"BLD",8895,"KRN",9.8,"NM","B","PSOLMPO",2)

"BLD",8895,"KRN",9.8,"NM","B","PSOORNEW",1)

"BLD",8895,"KRN",19,0)
19
"BLD",8895,"KRN",19.1,0)
19.1
"BLD",8895,"KRN",101,0)
101
"BLD",8895,"KRN",409.61,0)
409.61
"BLD",8895,"KRN",771,0)
771
"BLD",8895,"KRN",779.2,0)
779.2
"BLD",8895,"KRN",870,0)
870
"BLD",8895,"KRN",8989.51,0)
8989.51
"BLD",8895,"KRN",8989.52,0)
8989.52
"BLD",8895,"KRN",8994,0)
8994
"BLD",8895,"KRN","B",.4,.4)

"BLD",8895,"KRN","B",.401,.401)

"BLD",8895,"KRN","B",.402,.402)

"BLD",8895,"KRN","B",.403,.403)

"BLD",8895,"KRN","B",.5,.5)

"BLD",8895,"KRN","B",.84,.84)

"BLD",8895,"KRN","B",3.6,3.6)

"BLD",8895,"KRN","B",3.8,3.8)

"BLD",8895,"KRN","B",9.2,9.2)

"BLD",8895,"KRN","B",9.8,9.8)

"BLD",8895,"KRN","B",19,19)

"BLD",8895,"KRN","B",19.1,19.1)

"BLD",8895,"KRN","B",101,101)

"BLD",8895,"KRN","B",409.61,409.61)

"BLD",8895,"KRN","B",771,771)

"BLD",8895,"KRN","B",779.2,779.2)

"BLD",8895,"KRN","B",870,870)

"BLD",8895,"KRN","B",8989.51,8989.51)

"BLD",8895,"KRN","B",8989.52,8989.52)

"BLD",8895,"KRN","B",8994,8994)

"BLD",8895,"QUES",0)
^9.62^^
"BLD",8895,"REQB",0)
^9.611^1^1
"BLD",8895,"REQB",1,0)
PSO*7.0*408^2
"BLD",8895,"REQB","B","PSO*7.0*408",1)

"FIA",52)
PRESCRIPTION
"FIA",52,0)
^PSRX(
"FIA",52,0,0)
52Is
"FIA",52,0,1)
y^y^p^^^^n^^n
"FIA",52,0,10)

"FIA",52,0,11)

"FIA",52,0,"RLRO")

"FIA",52,0,"VR")
7.0^PSO
"FIA",52,52)
1
"FIA",52,52,725)

"FIA",52,52.0725)
0
"FIA",52,52.7252)
0
"FIA",52,52.72521)
0
"FIA",52,52.72522)
0
"FIA",52,52.7253)
0
"FIA",52,52.7254)
0
"IX",52,52,"NDUC",0)
52^NDUC^National Data Utility Clean-up cross reference^R^^F^IR^W^52.0725^^^^^LS
"IX",52,52,"NDUC",.1,0)
^^15^15^3131113^
"IX",52,52,"NDUC",.1,1,0)
NDUC cross reference which used by the Lookup National Clean-Up Utility
"IX",52,52,"NDUC",.1,2,0)
Data option.
"IX",52,52,"NDUC",.1,3,0)
 
"IX",52,52,"NDUC",.1,4,0)
PSRX(DATE/TIME,RX,SEQ)=""
"IX",52,52,"NDUC",.1,5,0)
 
"IX",52,52,"NDUC",.1,6,0)
Where:
"IX",52,52,"NDUC",.1,7,0)
   DATE/TIME = date and time National Data 
"IX",52,52,"NDUC",.1,8,0)
               Clean-up utility updated the
"IX",52,52,"NDUC",.1,9,0)
               prescription.
"IX",52,52,"NDUC",.1,10,0)
 
"IX",52,52,"NDUC",.1,11,0)
   RX = prescription IEN for PRESCRIPTION 
"IX",52,52,"NDUC",.1,12,0)
        file (#52)
"IX",52,52,"NDUC",.1,13,0)
 
"IX",52,52,"NDUC",.1,14,0)
   SEQ = subscript to the NATIONAL DATA 
"IX",52,52,"NDUC",.1,15,0)
         CLEANUP multiple for the prescription.
"IX",52,52,"NDUC",1)
S ^PSRX("NDUC",X,DA(1),DA)=""
"IX",52,52,"NDUC",2)
K ^PSRX("NDUC",X,DA(1),DA)
"IX",52,52,"NDUC",2.5)
K ^PSRX("NDUC")
"IX",52,52,"NDUC",11.1,0)
^.114IA^1^1
"IX",52,52,"NDUC",11.1,1,0)
1^F^52.0725^.01^^1^F
"MBREQ")
1
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
436^3140724^10000000068
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","PSODOSU2")
0^4^B115401790
"RTN","PSODOSU2",1,0)
PSODOSU2 ;BIR/RTR - Dose Check Utility routine continued ;11/18/08
"RTN","PSODOSU2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,372,436**;DEC 1997;Build 5
"RTN","PSODOSU2",3,0)
 ;
"RTN","PSODOSU2",4,0)
 ;Called from PSODOSUT.  The variable PSODTYPE is expected to be defined.
"RTN","PSODOSU2",5,0)
 ; PSODTYPE values can be N for dosing for new order, copy, and renews, E for edited and display of individual complex doses, and C for complex orders
"RTN","PSODOSU2",6,0)
 ;
"RTN","PSODOSU2",7,0)
EN ;new order, copy, renew, and verify orders
"RTN","PSODOSU2",8,0)
 N PSODLERW,PSODLERL,PSODLERS,PSODLERH,PSOCPXRR,PSODLWW,PSODOSER,PSONFRNF,PSOWMSG,PSODLQTC
"RTN","PSODOSU2",9,0)
 S (PSODLERF,PSODSEQ,PSODLWW)="" F  S PSODSEQ=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ)) Q:PSODSEQ=""!($G(PSORX("DFLG")))!($G(PSODLQTC))  S PSODLNN1=""  D  D HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",10,0)
 .S:PSODTYPE'="N" PSODLQT=0 S PSOLASTS=PSODSEQ
"RTN","PSODOSU2",11,0)
 .I PSODTYPE="C" K PSOCPXRR
"RTN","PSODOSU2",12,0)
 .F  S PSODLNN1=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) Q:PSODLNN1=""!($G(PSORX("DFLG")))!($G(PSODLQTC))  D
"RTN","PSODOSU2",13,0)
 ..S:PSODTYPE'="E" PSODLECT=0
"RTN","PSODOSU2",14,0)
 ..I PSODTYPE="E" Q:$P(PSODLNN1,";",4)'=PSODLXNT
"RTN","PSODOSU2",15,0)
 ..D ERROR Q:$G(PSODLQTC)
"RTN","PSODOSU2",16,0)
 ..D EXCEPT Q:$G(PSODLQTC)
"RTN","PSODOSU2",17,0)
 ..D MESSAGE Q:$G(PSODLQTC)
"RTN","PSODOSU2",18,0)
 .K PSODLWW
"RTN","PSODOSU2",19,0)
 Q
"RTN","PSODOSU2",20,0)
 ;
"RTN","PSODOSU2",21,0)
ERROR ;format and write dosing error
"RTN","PSODOSU2",22,0)
 I PSODTYPE'="E" S PSODLECT=0
"RTN","PSODOSU2",23,0)
 F PSODLERA=0:0 S PSODLERA=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"ERROR",PSODLERA)) Q:'PSODLERA!($G(PSORX("DFLG")))  D
"RTN","PSODOSU2",24,0)
 .S:PSODTYPE'="E" PSODLECT=PSODLECT+1
"RTN","PSODOSU2",25,0)
 .S:PSODTYPE'="N" PSODLQT=0
"RTN","PSODOSU2",26,0)
 .F PSODLERX="MSG","TEXT" S PSODLERB=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"ERROR",PSODLERA,PSODLERX)) D  K ^UTILITY($J,"W")
"RTN","PSODOSU2",27,0)
 ..S PSODLERZ=0 Q:PSODLERB=""
"RTN","PSODOSU2",28,0)
 ..I PSODTYPE="C"&(PSOCPXB>3) D ERRCOM Q
"RTN","PSODOSU2",29,0)
 ..I PSODTYPE="E" D ERREDIT Q
"RTN","PSODOSU2",30,0)
 ..I PSODTYPE="N"&(PSOCPXB>3) D ERRNEW Q
"RTN","PSODOSU2",31,0)
 ..Q:PSODTYPE="C"&(PSOCPXB<4)
"RTN","PSODOSU2",32,0)
 ..D ERRNEW
"RTN","PSODOSU2",33,0)
 Q
"RTN","PSODOSU2",34,0)
 ;
"RTN","PSODOSU2",35,0)
ERRCOM ;write dosing errors for complex dose summary after accept of an order
"RTN","PSODOSU2",36,0)
 I PSOCPXC D HD Q:$G(PSODLQTC)  I PSODLERF,PSODLERX="MSG" W:'PSODLQT ! D HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",37,0)
 I 'PSODLERF,PSOCPXB<4 W:'PSODLQT&(PSOCPXC) !
"RTN","PSODOSU2",38,0)
 S PSODLERF=1 D:PSOCPXC HD I PSODLERZ W:'PSODLQT&(PSOCPXC) !
"RTN","PSODOSU2",39,0)
 ;S PSODLERR=1
"RTN","PSODOSU2",40,0)
 D:PSOCPXC
"RTN","PSODOSU2",41,0)
 .D HD Q:$G(PSODLQTC)  W:'PSODLQT&(PSODLECT>1) !
"RTN","PSODOSU2",42,0)
 .N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF
"RTN","PSODOSU2",43,0)
 .D:PSOCPXC HD D:'PSOCPXF&(PSOCPXC) 
"RTN","PSODOSU2",44,0)
 ..Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",45,0)
 .D:PSOCPXC HD S PSOCPXG=$P(PSODLNN1,";",4) I PSOCPXC&('$G(PSOCPXRR(PSOCPXG))) D SUB^PSODOSUT W:'PSODLQT&('PSODLERZ) !
"RTN","PSODOSU2",46,0)
 .D:PSOCPXC HD W:'PSODLQT&(PSODLECT'>1)&(PSODLERX="TEXT")&(PSOCPXC) ! S X=PSODLERB,DIWL=1,DIWR=$S(PSODLERX="MSG":76,1:74) K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSU2",47,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D:PSOCPXC HD W:PSODELXF&('PSODLQT) ! D
"RTN","PSODOSU2",48,0)
 ..D:PSOCPXC HD W:'$G(PSODLQT) $S(PSODLERX="MSG":"   ",1:"     ")_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODLERR,PSODOSER,PSODLEXR)=1 D SFD
"RTN","PSODOSU2",49,0)
 .S PSOLASTD(PSOLASTS)=1,PSONFRNF=1
"RTN","PSODOSU2",50,0)
 Q
"RTN","PSODOSU2",51,0)
 ;
"RTN","PSODOSU2",52,0)
ERREDIT ;write dosing errors for edits or display during complex dose entry
"RTN","PSODOSU2",53,0)
 I 'PSODLERF,PSOCPXB<4 W:'PSODLQT !
"RTN","PSODOSU2",54,0)
 D HD Q:$G(PSODLQTC)  I PSODLERF,PSODLERX="MSG" W:'PSODLQT ! D HD Q:$G(PSODLQTC)  I 'PSODLERF W:'PSODLQT !
"RTN","PSODOSU2",55,0)
 S PSODLERF=1 D HD Q:$G(PSODLQTC)  I PSODLERZ W:'PSODLQT !
"RTN","PSODOSU2",56,0)
 ;S PSODLERR=1
"RTN","PSODOSU2",57,0)
 D HD Q:$G(PSODLQTC)  W:'PSODLQT !
"RTN","PSODOSU2",58,0)
 N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF S X=PSODLERB,DIWL=1,DIWR=$S(PSODLERX="MSG":76,1:74) K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSU2",59,0)
 S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD Q:$G(PSODLQTC)  W:PSODELXF&('PSODLQT) ! D HD Q:$G(PSODLQTC)  D
"RTN","PSODOSU2",60,0)
 .W:'PSODLQT $S(PSODLERX="MSG":"   ",1:"     ")_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODLERR,PSODOSER,PSODLEXR)=1 D SFD
"RTN","PSODOSU2",61,0)
 S PSOLASTD(PSOLASTS)=1,PSONFRNF=1
"RTN","PSODOSU2",62,0)
 Q
"RTN","PSODOSU2",63,0)
 ;
"RTN","PSODOSU2",64,0)
ERRNEW ;write dosing errors for finish, new, copy, renewal and verify
"RTN","PSODOSU2",65,0)
 D HD Q:$G(PSODLQTC)  I PSODLERF,PSODLERX="MSG" W:'PSODLQT ! D HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",66,0)
 I $L(PSODLERB)>76&(PSOCPXB>1)  S PSODLERL=1
"RTN","PSODOSU2",67,0)
 I 'PSODLERF,PSOCPXB<4 W:'PSODLQT !
"RTN","PSODOSU2",68,0)
 S PSODLERF=1 D HD Q:$G(PSODLQTC)  I PSODLERZ W:'PSODLQT !
"RTN","PSODOSU2",69,0)
 ;S PSODLERR=1
"RTN","PSODOSU2",70,0)
 D HD Q:$G(PSODLQTC)  W:'PSODLQT&(PSODLECT>1) ! N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF
"RTN","PSODOSU2",71,0)
 D:PSOCPXC HD D:'PSOCPXF&(PSOCPXC)
"RTN","PSODOSU2",72,0)
 .Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",73,0)
 D HD Q:$G(PSODLQTC)  S PSOCPXG=$P(PSODLNN1,";",4) I '$G(PSOCPXRR(PSOCPXG))&(PSOCPXB>1) D SUB^PSODOSUT W:'PSODLQT&('PSODLERZ) !
"RTN","PSODOSU2",74,0)
 D HD Q:$G(PSODLQTC)  W:'PSODLQT&(PSODLECT'>1)&(PSODLERX="TEXT") ! S X=PSODLERB,DIWL=1,DIWR=$S(PSODLERX="MSG":76,1:74) K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSU2",75,0)
 S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD Q:$G(PSODLQTC)  W:PSODELXF&('PSODLQT) ! D HD Q:$G(PSODLQTC)  D
"RTN","PSODOSU2",76,0)
 .W:'PSODLQT $S(PSODLERX="MSG":"   ",1:"     ")_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODLERR,PSODOSER,PSODLEXR)=1 D SFD
"RTN","PSODOSU2",77,0)
 S PSOLASTD(PSOLASTS)=1,PSONFRNF=1
"RTN","PSODOSU2",78,0)
 Q
"RTN","PSODOSU2",79,0)
 ;
"RTN","PSODOSU2",80,0)
SFD ;
"RTN","PSODOSU2",81,0)
 S PSODELXF=1 S:PSODLERX="TEXT" PSODLERZ=1
"RTN","PSODOSU2",82,0)
 Q
"RTN","PSODOSU2",83,0)
 ;
"RTN","PSODOSU2",84,0)
EXCEPT ;format and write exceptions
"RTN","PSODOSU2",85,0)
 I PSODTYPE="E" S (PSODLERZ)=0
"RTN","PSODOSU2",86,0)
 I $G(PSODOSER) K PSODOSER  ;line feed between error and exceptions
"RTN","PSODOSU2",87,0)
 D EXCEPT^PSODOSUT
"RTN","PSODOSU2",88,0)
 I PSODTYPE="N" D HD Q:$G(PSODLQTC)  W:PSODLERF&('PSODLQT)&('$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS")))&('$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE"))) ! S PSODLERZ=0
"RTN","PSODOSU2",89,0)
 I PSODTYPE="C"  D:PSOCPXC HD W:PSODLERF&(PSOCPXC)&('PSODLQT)&('$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS")))&('$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE")))&('$G(PSODLWW)) ! S (PSODLERZ,PSODLESM)=0
"RTN","PSODOSU2",90,0)
 F PSODLERA=0:0 S PSODLERA=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLERA)) Q:'PSODLERA  D
"RTN","PSODOSU2",91,0)
 .S PSODLERB=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLERA))
"RTN","PSODOSU2",92,0)
 .I PSODTYPE="N" D SBAD^PSODOSUT
"RTN","PSODOSU2",93,0)
 .I PSODTYPE="E"!(PSODTYPE="C") D SBAD^PSODOSUT:PSODLERB'=""
"RTN","PSODOSU2",94,0)
 .Q:PSODLERB=""  I PSODTYPE'="C" D HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",95,0)
 . N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF S PSODLEXR=0
"RTN","PSODOSU2",96,0)
 .S (PSODLERF,PSODLALZ)=1
"RTN","PSODOSU2",97,0)
 .;write exceptions for new, copy, renew, verify
"RTN","PSODOSU2",98,0)
 .I PSODTYPE="N" D  Q
"RTN","PSODOSU2",99,0)
 ..D HD Q:$G(PSODLQTC)  I 'PSOCPXF&(PSOCPXC) D
"RTN","PSODOSU2",100,0)
 ...Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",101,0)
 ..I 'PSODLERF W:'PSODLQT&('$G(PSODLWW)) ! D HD Q:$G(PSODLQTC)  S PSODLWW=0
"RTN","PSODOSU2",102,0)
 ..S PSOCPXG=$P(PSODLNN1,";",4)
"RTN","PSODOSU2",103,0)
 ..I '$G(PSOCPXRR(PSOCPXG)),PSOCPXB>1 W:'PSODLQT&(PSODLERZ) ! D SUB^PSODOSUT
"RTN","PSODOSU2",104,0)
 ..D HD Q:$G(PSODLQTC)  W:'PSODLQT&('$G(PSODLWW)) ! S PSODLWW=0
"RTN","PSODOSU2",105,0)
 ..D WRITEXC
"RTN","PSODOSU2",106,0)
 .;write dosing exceptions for edits or display during complex dose entry
"RTN","PSODOSU2",107,0)
 .I PSODTYPE="E" D
"RTN","PSODOSU2",108,0)
 ..I PSODLERB["please complete a manual check for appropriate Dosing" S PSODCONT=1
"RTN","PSODOSU2",109,0)
 ..D HD Q:$G(PSODLQTC)  W:'PSODLQT&('$G(PSODLWW)) ! S PSODLWW=0
"RTN","PSODOSU2",110,0)
 ..S DIWL=1,DIWR=76 K ^UTILITY($J,"W")
"RTN","PSODOSU2",111,0)
 ..D WRITEXC
"RTN","PSODOSU2",112,0)
 .;write exceptions for complex orders
"RTN","PSODOSU2",113,0)
 .I PSODTYPE="C"&(PSOCPXB>3) D
"RTN","PSODOSU2",114,0)
 ..D:PSOCPXC HD I 'PSODLERF&('$G(PSODLWW)) W:'PSODLQT&(PSOCPXC) !
"RTN","PSODOSU2",115,0)
 ..D:PSOCPXC
"RTN","PSODOSU2",116,0)
 ...D HD Q:$G(PSODLQTC)  I 'PSOCPXF&(PSOCPXC) D
"RTN","PSODOSU2",117,0)
 ....Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",118,0)
 ...S PSOCPXG=$P(PSODLNN1,";",4) I PSOCPXC&('$G(PSOCPXRR(PSOCPXG))) D HD Q:$G(PSODLQTC)  W:'PSODLQT&(PSOCPXC)&(PSODLESM)&('$G(PSODLWW)) ! D SUB^PSODOSUT
"RTN","PSODOSU2",119,0)
 ...S PSODLESM=1 D HD Q:$G(PSODLQTC)  W:'PSODLQT&('$G(PSODLWW)) !
"RTN","PSODOSU2",120,0)
 ...D:PSOCPXC WRITEXC
"RTN","PSODOSU2",121,0)
 Q
"RTN","PSODOSU2",122,0)
 ;
"RTN","PSODOSU2",123,0)
WRITEXC ;format and write exception messages to the screen
"RTN","PSODOSU2",124,0)
 S PSODLWW=0,DIWL=4,DIWR=76 K ^UTILITY($J,"W")
"RTN","PSODOSU2",125,0)
 I PSODLERB["Range Check Error Summary" S PSODLERS=1 I PSODLERZ W:'PSODLQT ! D HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",126,0)
 I $G(PSODLERS),$L(PSODLERB)>76&($G(PSOCPXB)>1)  S PSODLERB=$E(PSODLERB,14,999),DIWR=76,DIWL=17,DIWF="W" S PSODLERW=1
"RTN","PSODOSU2",127,0)
 S X=PSODLERB D:'PSODLQT ^DIWP D HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",128,0)
 I '$G(PSODLERW) S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D
"RTN","PSODOSU2",129,0)
 .W:PSODELXF&('PSODLQT) ! D HD Q:$G(PSODLQTC)  W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSONFRNF,PSODELXF,PSODLERZ,PSODLEXR)=1
"RTN","PSODOSU2",130,0)
 I $G(PSODLERW)&('PSODLQT) D ^DIWW K PSODLERW,PSODLERL S PSODLWW=1 S PSOLASTD(PSOLASTS)=2
"RTN","PSODOSU2",131,0)
 K ^UTILITY($J,"W")
"RTN","PSODOSU2",132,0)
 Q
"RTN","PSODOSU2",133,0)
  ;
"RTN","PSODOSU2",134,0)
MESSAGE ;format and write messages
"RTN","PSODOSU2",135,0)
 ;S PSODLFLG=0
"RTN","PSODOSU2",136,0)
 ;I $G(PSODLALZ)&$G(PSOFOERR)&'$G(PSORENWD) W !
"RTN","PSODOSU2",137,0)
 I PSODTYPE="N",$$FEED^PSODOSUT D HD Q:$G(PSODLQTC)  W:'PSODLQT !
"RTN","PSODOSU2",138,0)
 I $G(PSODLERZ)&('PSODLQT) W !  ;line feed for transition between exceptions to messages
"RTN","PSODOSU2",139,0)
 I PSODTYPE="C" I $$FEED^PSODOSUT&(PSOCPXC) D HD Q:$G(PSODLQTC)  W:'PSODLQT !
"RTN","PSODOSU2",140,0)
 S PSODLPL="" F  S PSODLPL=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL)) Q:PSODLPL=""  D
"RTN","PSODOSU2",141,0)
 .F PSODLP1=0:0 S PSODLP1=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1)) Q:'PSODLP1  D
"RTN","PSODOSU2",142,0)
 ..I PSODTYPE'="E",PSODLPL="3_GENERAL" S PSODLINS=1 D GENERAL Q
"RTN","PSODOSU2",143,0)
 ..S PSODLMSG=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1))
"RTN","PSODOSU2",144,0)
 ..Q:PSODLMSG=""
"RTN","PSODOSU2",145,0)
 ..I 'PSODLERF W:'PSODLQT&('$G(PSODLWW)) ! D HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",146,0)
 ..S PSODLERF=1
"RTN","PSODOSU2",147,0)
 ..I PSODTYPE'="C" D HD Q:$G(PSODLQTC)  I '$G(PSODLFLG) W:'PSODLQT&('$G(PSODLWW)) !
"RTN","PSODOSU2",148,0)
 ..I PSODTYPE="C" D  Q:'PSODLQT&(PSOCPXC)&(PSODLESM)  I PSOCPXF&(PSOCPXC) K PSODAILY
"RTN","PSODOSU2",149,0)
 ...D:PSOCPXC HD I '$G(PSODLFLG) W:'PSODLQT&(PSOCPXC)&(PSOCPXF)&('$G(PSODLWW)) !
"RTN","PSODOSU2",150,0)
 ...S PSODLFLG=1 S PSODLEXR=0
"RTN","PSODOSU2",151,0)
 ..I PSODTYPE'="E" S PSODLEXR=0
"RTN","PSODOSU2",152,0)
 ..S PSODLFLG=1 S:PSODLPL="1_SINGLE" PSODLINS=1 S:PSODLPL="2_RANGE" PSODLINR=1
"RTN","PSODOSU2",153,0)
 ..I PSODTYPE="N"  S PSODLFLG=1 D MSGN
"RTN","PSODOSU2",154,0)
 ..I PSODTYPE="E" S PSODLFLG=1 D WRITMSG
"RTN","PSODOSU2",155,0)
 ..I PSODTYPE="C"&(PSOCPXB>3) D MSGC
"RTN","PSODOSU2",156,0)
 Q
"RTN","PSODOSU2",157,0)
 ;
"RTN","PSODOSU2",158,0)
MSGN ;write dosing message for new, copy, renew, and verify
"RTN","PSODOSU2",159,0)
 I 'PSOCPXF&(PSOCPXC)&($G(PSOCPXB)>3) S PSOCPXG=$P(PSODLNN1,";",4) D  K PSODAILY S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSU2",160,0)
 .Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",161,0)
 S PSOCPXG=$P(PSODLNN1,";",4) D HD Q:$G(PSODLQTC)  D:'$G(PSOCPXRR(PSOCPXG))&(PSOCPXB>1) SUB^PSODOSUT D
"RTN","PSODOSU2",162,0)
 .I $G(PSOCPXRR(PSOCPXG))&$P(PSODLNN1,";",5)'="" K PSODAILY
"RTN","PSODOSU2",163,0)
 .I PSODLPL="2_RANGE",'$G(PSODAILY) D DAILY^PSODOSUT I PSOCPXG'=PSOCPXB K PSODAILY
"RTN","PSODOSU2",164,0)
 .D HD Q:$G(PSODLQTC)  D WRITMSG,HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",165,0)
 .;I 'PSODLQT S PSODELNX=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) I '$P($G(PSODELNX),";",5)!($P($G(PSODELNX),";",4)'=PSOCPXG) W !
"RTN","PSODOSU2",166,0)
 Q
"RTN","PSODOSU2",167,0)
 ;
"RTN","PSODOSU2",168,0)
MSGC ;write dosing message for edits  or display during complex dose entry
"RTN","PSODOSU2",169,0)
 Q:'PSODLQT&(PSOCPXC)&(PSODLESM)  I PSOCPXF&(PSOCPXC) K PSODAILY
"RTN","PSODOSU2",170,0)
 D:PSOCPXC HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",171,0)
 I 'PSOCPXF&(PSOCPXC) S PSOCPXG=$P(PSODLNN1,";",4) D  K PSODAILY S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSU2",172,0)
 .Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",173,0)
 I PSOCPXC S PSOCPXG=$P(PSODLNN1,";",4) D HD Q:$G(PSODLQTC)  D
"RTN","PSODOSU2",174,0)
 .I $G(PSOCPXRR(PSOCPXG))&$P(PSODLNN1,";",5)'="" K PSODAILY
"RTN","PSODOSU2",175,0)
 .I '$G(PSOCPXRR(PSOCPXG))&('$G(PSOCPXH)) D SUB^PSODOSUT I $G(PSOCOPY)!($G(PSORENW)) S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSU2",176,0)
 .I PSODLPL="2_RANGE"&PSODLINR&'$G(PSODAILY) D DAILY^PSODOSUT
"RTN","PSODOSU2",177,0)
 .D WRITMSG
"RTN","PSODOSU2",178,0)
 Q
"RTN","PSODOSU2",179,0)
 ;
"RTN","PSODOSU2",180,0)
WRITMSG ;
"RTN","PSODOSU2",181,0)
 W:'PSODLQT&('$G(PSODLWW)) ! S PSODLWW=0
"RTN","PSODOSU2",182,0)
 N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF S X=PSODLMSG,DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSU2",183,0)
 S PSODELXF=0
"RTN","PSODOSU2",184,0)
 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D
"RTN","PSODOSU2",185,0)
 .D HD Q:$G(PSODLQTC)  W:PSODELXF&('PSODLQT) ! W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODLFLG,PSODELXF,PSONFRNF,PSOWMSG,PSODLEXR)=1
"RTN","PSODOSU2",186,0)
 K ^UTILITY($J,"W") D HD Q:$G(PSODLQTC)
"RTN","PSODOSU2",187,0)
 I PSODTYPE="E",'PSODLQT S PSODELNX=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) I '$P($G(PSODELNX),";",5) W !
"RTN","PSODOSU2",188,0)
 I PSODTYPE="C"!(PSODTYPE="N"),'PSODLQT D
"RTN","PSODOSU2",189,0)
 .D HD Q:$G(PSODLQTC)  S PSODELNX=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) I '$P($G(PSODELNX),";",5)!($P($G(PSODELNX),";",4)'=PSOCPXG) W ! S PSOLASTD(PSOLASTS)=3
"RTN","PSODOSU2",190,0)
 Q
"RTN","PSODOSU2",191,0)
 ;
"RTN","PSODOSU2",192,0)
GENERAL ;general dosing range information
"RTN","PSODOSU2",193,0)
 N PSOGENF,PSODLERC,PSODLP2
"RTN","PSODOSU2",194,0)
 F PSODLP2=0:0 S PSODLP2=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1,PSODLP2)) Q:'PSODLP2!($G(PSORX("DFLG")))  D
"RTN","PSODOSU2",195,0)
 .S PSODLERC="",PSODLERC=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1,PSODLP2))
"RTN","PSODOSU2",196,0)
 .Q:PSODLERC=""
"RTN","PSODOSU2",197,0)
 .D HD Q:$G(PSODLQTC)  ;I 'PSODLQT&('$G(PSOEDIT))&('$G(PSONEW)) W ! S PSOGENF=1  ;copied order
"RTN","PSODOSU2",198,0)
 .I 'PSODLQT,'$G(PSOEDIT) W ! S PSOGENF=1
"RTN","PSODOSU2",199,0)
 .N X,DIWL,DIWR,DIWF,DIWL,PSODELXR,PSODELXF S PSODLEXR=1
"RTN","PSODOSU2",200,0)
 .S DIWL=4,DIWR=76 K ^UTILITY($J,"W")
"RTN","PSODOSU2",201,0)
 .S X=PSODLERC D ^DIWP
"RTN","PSODOSU2",202,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD Q:$G(PSODLQTC)  W:PSODELXF&('PSODLQT) ! D HD Q:$G(PSODLQTC)  W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODELXF,PSODLERZ,PSONFRNF)=1
"RTN","PSODOSU2",203,0)
 .W:$G(PSOEDIT) ! S PSOLASTD(PSOLASTS)=3
"RTN","PSODOSU2",204,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSU2",205,0)
 .W !
"RTN","PSODOSU2",206,0)
 Q
"RTN","PSODOSU2",207,0)
 ;
"RTN","PSODOSU2",208,0)
HD ;
"RTN","PSODOSU2",209,0)
 S:'$G(PSODLQT) PSODLQT=""
"RTN","PSODOSU2",210,0)
 I PSODLQT!(($Y+2)<IOSL)!($G(PSORX("DFLG"))) Q
"RTN","PSODOSU2",211,0)
 W:$G(PSORENWD) !
"RTN","PSODOSU2",212,0)
HD2 ;
"RTN","PSODOSU2",213,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODOSU2",214,0)
 K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue,'^' to exit" D ^DIR K DIR
"RTN","PSODOSU2",215,0)
 I $G(PSOCPXC)&($D(DIRUT)!($D(DUOUT))) S PSODLQTC=1 W @IOF W ! Q  ;user ^'s
"RTN","PSODOSU2",216,0)
 I 'Y!($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODOSU2",217,0)
 W @IOF W !
"RTN","PSODOSU2",218,0)
 Q
"RTN","PSODOSU2",219,0)
 ;
"RTN","PSODOSUN")
0^5^B93344191
"RTN","PSODOSUN",1,0)
PSODOSUN ;BIR/RTR - Dose Check Utility routine ;11/18/08
"RTN","PSODOSUN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,379,372,416,436**;DEC 1997;Build 5
"RTN","PSODOSUN",3,0)
 ;
"RTN","PSODOSUN",4,0)
DOSE() ;Write Dose output for renew, finish, copy, etc.
"RTN","PSODOSUN",5,0)
 N PSODLINS,PSODLINR,PSODLERA,PSODLERB,PSODLERF,PSODLERZ,PSODLPL,PSODLP1,PSODLMSG,PSODLFLG,PSODLALZ,DIR,DUOUT,DTOUT,DIROUT,DIRUT,X,Y,X1,PSODLOFF
"RTN","PSODOSUN",6,0)
 N PSODLNN1,PSODLERR,PSODLERX,PSODLQT,PSOCPXG,PSOCPXRR,PSODLEXR,PSODELNX,PSODLECT,PSOCPXF,PSODTYPE,PSOCPXC,PSOLASTS,PSOQTOUT,PSOEDOUT,PSODSEQ
"RTN","PSODOSUN",7,0)
 N PSOSIGC
"RTN","PSODOSUN",8,0)
 S (PSODLERF,PSODLERZ,PSODLALZ,PSODLINS,PSODLINR,PSODLERR,PSODLQT,PSOCPXG,PSOCPXF,PSOLASTS,PSOQTOUT,PSOEDOUT,PSODLOFF)=0,PSODTYPE="N",PSOCPXC=1
"RTN","PSODOSUN",9,0)
 I $G(PSORXED)&$G(PSOEDDOS) S PSOCPXC=0  ;don't show summary before accept of order if edit
"RTN","PSODOSUN",10,0)
 I $G(PSOCPXB)<4 S PSOCPXC=0
"RTN","PSODOSUN",11,0)
 W:$G(PSOEDIT)!$G(PSOCOPY)!($G(PSOFOERR)) @IOF I $P($G(^TMP($J,"PSOPDOSN","OUT",0)),"^")=-1 D  S PSODLFLG=0,PSODLOFF=1 G END
"RTN","PSODOSUN",12,0)
 .D HD N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF D MESG
"RTN","PSODOSUN",13,0)
 .S X="Reason(s): "_$P(^TMP($J,"PSOPDOSN","OUT",0),"^",2),DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUN",14,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUN",15,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUN",16,0)
 ;PSOCPXB = Number of Dosing Seq
"RTN","PSODOSUN",17,0)
 S PSODLQT=0 K PSOCPXRR
"RTN","PSODOSUN",18,0)
 D EN^PSODOSU2
"RTN","PSODOSUN",19,0)
END ;
"RTN","PSODOSUN",20,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",21,0)
 I '$G(PSODLALZ),'$G(PSODLFLG),'$G(PSODLERR),'$G(PSODLOFF) Q 0
"RTN","PSODOSUN",22,0)
 I '$G(PSODLFLG) W !
"RTN","PSODOSUN",23,0)
 K PSODAILY,DIR,Y,PSODOSEX
"RTN","PSODOSUN",24,0)
 D PROMPT Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 1
"RTN","PSODOSUN",25,0)
 I '$G(PSODLINS)&('$G(PSODLINR)) Q 0
"RTN","PSODOSUN",26,0)
 I $D(^XUSEC("PSORPH",DUZ)) D  I Y'=1!($D(DTOUT))!($D(DUOUT))!($G(PSRX("DFLG"))) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",27,0)
 .S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR
"RTN","PSODOSUN",28,0)
 I '$G(PSODLINS)&'$G(PSODLINR) Q 0
"RTN","PSODOSUN",29,0)
 I '$D(^XUSEC("PSORPH",DUZ)) Q 2_"^"_$$EVAL(PSODLINS,PSODLINR)
"RTN","PSODOSUN",30,0)
 W !!,"Do you want to Process or Cancel medication?" K DIR,Y S DIR("B")="P",DIR(0)="SA^1:PROCESS MEDICATION;0:CANCEL MEDICATION"
"RTN","PSODOSUN",31,0)
 S DIR("A")=$$GETGN^PSODOSUN(PSODRUG("IEN"))_": "  K ^TMP($J,"PSODOSUN GN")
"RTN","PSODOSUN",32,0)
 S DIR("?",1)="Enter '1' or 'P' to Process medication",DIR("?")="      '^' to EXIT",DIR("?",2)="      '0' or 'C' to Cancel Medication"
"RTN","PSODOSUN",33,0)
 D ^DIR K DIR
"RTN","PSODOSUN",34,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",35,0)
 I Y=0 Q 3_"^"_$S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & DAILY DOSE RANGE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"DAILY DOSE RANGE",1:"UNKNOWN")  ;need to know if user cancelled or not
"RTN","PSODOSUN",36,0)
 K PSODOSEX
"RTN","PSODOSUN",37,0)
 S PSOSIGC=0
"RTN","PSODOSUN",38,0)
SIG1 ;
"RTN","PSODOSUN",39,0)
 D SIG^XUSESIG
"RTN","PSODOSUN",40,0)
 I 'PSOSIGC&($G(X1)="") D MSG1 S PSOSIGC=PSOSIGC+1 G SIG1
"RTN","PSODOSUN",41,0)
 I $G(X1)="" D MSG2 Q 1
"RTN","PSODOSUN",42,0)
END2 ;
"RTN","PSODOSUN",43,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",44,0)
 Q 2_"^"_$S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & DAILY DOSE RANGE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"DAILY DOSE RANGE",1:"UNKNOWN")
"RTN","PSODOSUN",45,0)
 ;
"RTN","PSODOSUN",46,0)
EVAL(PSODLINS,PSODLINR) ;
"RTN","PSODOSUN",47,0)
 Q $S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & DAILY DOSE RANGE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"DAILY DOSE RANGE",1:"UNKNOWN")
"RTN","PSODOSUN",48,0)
 ;
"RTN","PSODOSUN",49,0)
DOSEX(PSODLXNT) ;Write Dose exceptions for order entry/edit
"RTN","PSODOSUN",50,0)
 N PSODLINS,PSODLINR,PSODLERA,PSODLERB,PSODLERF,PSODLERZ,PSODLPL,PSODLP1,PSODLMSG,DIR,DUOUT,DTOUT,DIROUT,DIRUT,X,Y,X1
"RTN","PSODOSUN",51,0)
 N PSODLNN1,PSODLERX,PSODLQT,PSODELNX,PSODTYPE,PSODCONT,PSODSEQ,PSODOSX,PSODLOFF
"RTN","PSODOSUN",52,0)
 W @IOF S (PSODLERF,PSODLERZ,PSODLINS,PSODLINR,PSODLQT,PSODCONT,PSODLOFF)=0,PSODTYPE="E"
"RTN","PSODOSUN",53,0)
 I $G(PSOEDDOS) Q:$G(PSORXED("CONJUNCTION",1))="" 0  ;don't show messages when simple order before accept of order during edits
"RTN","PSODOSUN",54,0)
 I PSOCPXB>3,$G(PSORXED)&$G(PSOEDDOS) S PSOCPXC=0  ;don't show summary before accept of order if edit
"RTN","PSODOSUN",55,0)
 I $P($G(^TMP($J,"PSOPDOSN","OUT",0)),"^")=-1 D  S PSODLFLG=0,PSODLOFF=1 G ENDX
"RTN","PSODOSUN",56,0)
 .D HD N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF D MESG
"RTN","PSODOSUN",57,0)
 .S X="Reason(s): "_$P(^TMP($J,"PSOPDOSN","OUT",0),"^",2),DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUN",58,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUN",59,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUN",60,0)
 D EN^PSODOSU2
"RTN","PSODOSUN",61,0)
ENDX ;
"RTN","PSODOSUN",62,0)
 S PSODOSX=1
"RTN","PSODOSUN",63,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",64,0)
 K PSOCPXRR
"RTN","PSODOSUN",65,0)
 I '$G(PSODLALZ),'$G(PSODLFLG),'$G(PSODLERR),'$G(PSODLOFF) Q 0
"RTN","PSODOSUN",66,0)
 ;
"RTN","PSODOSUN",67,0)
 ;This "return to continue" occurs after the last dosing sequence for a complex order with 4 or more dosing sequences during an edit when finishing, placing a new order, copy or edit
"RTN","PSODOSUN",68,0)
 ;
"RTN","PSODOSUN",69,0)
 I '$G(PSOCKCON)&($G(PSOFOERR)) D  I $G(PSOQTOUT) Q 0
"RTN","PSODOSUN",70,0)
 .Q:($G(PSODLFLG))&$D(^XUSEC("PSORPH",DUZ))  ;messages need the "do you want to continue" prompt instead but need to evaluate here so that it doesn't show up for edits
"RTN","PSODOSUN",71,0)
 .D RETURN
"RTN","PSODOSUN",72,0)
 Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 1
"RTN","PSODOSUN",73,0)
 ;
"RTN","PSODOSUN",74,0)
 I '$G(PSOFOERR) D  I $G(PSOQTOUT) Q 0
"RTN","PSODOSUN",75,0)
 .Q:$G(PSODLFLG)&$D(^XUSEC("PSORPH",DUZ))
"RTN","PSODOSUN",76,0)
 .I '$G(PSOEDIT) Q:$G(PSODOSNW)&'$G(PSOCPXD)&'$G(PSOCOPY)
"RTN","PSODOSUN",77,0)
 .Q:($G(PSOCOPY)!$G(PSOEDIT))&'$G(PSOCPXV)
"RTN","PSODOSUN",78,0)
 .Q:PSOCPXB>3&$G(PSOCPXV)
"RTN","PSODOSUN",79,0)
 .D RETURN
"RTN","PSODOSUN",80,0)
 Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 1
"RTN","PSODOSUN",81,0)
 ;
"RTN","PSODOSUN",82,0)
 I '$G(PSODLFLG) W !
"RTN","PSODOSUN",83,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(PSODLINS)!($G(PSODLINR)),$G(PSODLFLG) Q 2_"^"_$$EVAL(PSODLINS,PSODLINR)
"RTN","PSODOSUN",84,0)
 I 'PSODCONT Q:$G(PSOCPXV) 0
"RTN","PSODOSUN",85,0)
 I $G(PSODLBD4)&'$G(PSODLINS)&'$G(PSODLINR)&('$G(PSODLALZ)) S Y=1 G ENDX2
"RTN","PSODOSUN",86,0)
 K DIR,Y I $D(^XUSEC("PSORPH",DUZ)) S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",87,0)
ENDX2 ;
"RTN","PSODOSUN",88,0)
 K PSODOSEX
"RTN","PSODOSUN",89,0)
 W !
"RTN","PSODOSUN",90,0)
 Q 0
"RTN","PSODOSUN",91,0)
DOSEZ() ;Write Dose output summary for complex orders
"RTN","PSODOSUN",92,0)
 I $G(PSOEDDOS) Q:$G(PSORXED("CONJUNCTION",1))="" 0  ;don't show messages when simple order before accept of order during edits
"RTN","PSODOSUN",93,0)
 N PSOCPXF,PSOCPXC,PSOCPXRR,PSOCPXG,PSODLESM,PSODELNX,PSOCPXH,PSODTYPE,PSOLASTS,PSOLASTD,PSOQTOUT,PSOEDOUT,PSODSEQ
"RTN","PSODOSUN",94,0)
 N PSODLINS,PSODLINR,PSODLERA,PSODLERB,PSODLERF,PSODLERZ,PSODLPL,PSODLP1,PSODLMSG,DIR,DUOUT,DTOUT,DIROUT,DIRUT,X,Y,X1
"RTN","PSODOSUN",95,0)
 N PSODLNN1,PSODLERX,PSODLQT,PSODLEXR,PSODLECT,PSODLOFF
"RTN","PSODOSUN",96,0)
 I '$G(PSOTOF) W @IOF
"RTN","PSODOSUN",97,0)
 S (PSODLERF,PSODLERZ,PSODLINS,PSODLINR,PSOCPXF,PSODLQT,PSOCPXH,PSOLASTS,PSOLASTD,PSOQTOUT,PSOEDOUT,PSODLOFF)=0,PSODTYPE="C",PSOCPXC=1
"RTN","PSODOSUN",98,0)
 I $G(PSORX("EDIT"))!($G(PSORXED)&$G(PSOEDDOS))!($G(PSOCOPY)&$G(PSODLBD4)) S PSOEDOUT=1
"RTN","PSODOSUN",99,0)
 I PSOCPXB>3,$G(PSOEDOUT) S PSOCPXC=0
"RTN","PSODOSUN",100,0)
 ;I PSOCPXB>3,$G(PSOEDDOS) S PSOCPXC=0  ;don't show summary before accept of order if edit
"RTN","PSODOSUN",101,0)
 I $G(PSOCPXB)<4 S PSOCPXC=0
"RTN","PSODOSUN",102,0)
 Q:$G(PSOCPXB)<4&'$G(PSOFOERR)&('$G(PSODLFLG)) 0
"RTN","PSODOSUN",103,0)
 I $P($G(^TMP($J,"PSOPDOSN","OUT",0)),"^")=-1 S PSODLQT=1 D  S PSODLFLG=0,PSODLOFF=1 G ENDZ
"RTN","PSODOSUN",104,0)
 .D:PSOCPXC HD W:'PSODLQT&(PSOCPXC) !! N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF D MESG
"RTN","PSODOSUN",105,0)
 .S X="Reason(s): "_$P(^TMP($J,"PSOPDOSN","OUT",0),"^",2),DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUN",106,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D:PSOCPXC HD W:PSODELXF&('PSODLQT)&(PSOCPXC) ! D:PSOCPXC HD W:'PSODLQT&(PSOCPXC) "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUN",107,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUN",108,0)
 D EN^PSODOSU2
"RTN","PSODOSUN",109,0)
ENDZ ;
"RTN","PSODOSUN",110,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",111,0)
 K PSODAILY
"RTN","PSODOSUN",112,0)
 I '$G(PSODLALZ),'$G(PSODLFLG),'$G(PSODLERR),'$G(PSODLOFF) Q 0
"RTN","PSODOSUN",113,0)
 D PROMPT Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 0
"RTN","PSODOSUN",114,0)
 I '$G(PSODLINS)&('$G(PSODLINR)) Q 0
"RTN","PSODOSUN",115,0)
 I '$G(PSOCPXF)&(PSOLASTS'=PSOCPXB),PSOEDOUT Q 0
"RTN","PSODOSUN",116,0)
 K PSODOSEX
"RTN","PSODOSUN",117,0)
 I $D(^XUSEC("PSORPH",DUZ)) D  I Y'=1!($D(DTOUT))!($D(DUOUT))!($G(PSRX("DFLG"))) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",118,0)
 .K DIR,Y S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR
"RTN","PSODOSUN",119,0)
ENDZC ;
"RTN","PSODOSUN",120,0)
 I '$G(PSODLINS)&('$G(PSODLINR)) Q 0
"RTN","PSODOSUN",121,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(PSODLINS)!($G(PSODLINR))  Q 2_"^"_$$EVAL(PSODLINS,PSODLINR)
"RTN","PSODOSUN",122,0)
 G ENDZ2:$G(PSORX("EDIT"))!($G(PSORXED)&$G(PSOEDDOS))!($G(PSOCOPY)&$G(PSODLBD4))
"RTN","PSODOSUN",123,0)
 W !!,"Do you want to Process or Cancel medication?" K DIR,Y S DIR("B")="P",DIR(0)="SA^1:PROCESS MEDICATION;0:CANCEL MEDICATION"
"RTN","PSODOSUN",124,0)
 S DIR("A")=$$GETGN(PSODRUG("IEN"))_": "  K ^TMP($J,"PSODOSUN GN")
"RTN","PSODOSUN",125,0)
 S DIR("?",1)="Enter '1' or 'P' to Process medication",DIR("?")="      '^' to EXIT",DIR("?",2)="      '0' or 'C' to Cancel Medication"
"RTN","PSODOSUN",126,0)
 D ^DIR K DIR,PSODOSEX
"RTN","PSODOSUN",127,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",128,0)
 S PSOSIGC=0
"RTN","PSODOSUN",129,0)
SIG2 ;
"RTN","PSODOSUN",130,0)
 D SIG^XUSESIG
"RTN","PSODOSUN",131,0)
 I 'PSOSIGC&($G(X1)="") D MSG1 S PSOSIGC=PSOSIGC+1 G SIG2
"RTN","PSODOSUN",132,0)
 I $G(X1)="" D MSG2 Q 1
"RTN","PSODOSUN",133,0)
ENDZ2 ;
"RTN","PSODOSUN",134,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",135,0)
 Q 2_"^"_$S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & DAILY DOSE RANGE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"DAILY DOSE RANGE",1:"UNKNOWN")
"RTN","PSODOSUN",136,0)
HD ;
"RTN","PSODOSUN",137,0)
 I PSODLQT!(($Y+5)'>IOSL) Q
"RTN","PSODOSUN",138,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODOSUN",139,0)
 I $D(^XUSEC("PSORPH",DUZ)) D  I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1,PSORX("DFLG")=1 Q 1
"RTN","PSODOSUN",140,0)
 .K DIR,Y S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR
"RTN","PSODOSUN",141,0)
 W @IOF W !
"RTN","PSODOSUN",142,0)
 Q
"RTN","PSODOSUN",143,0)
MESG ;Write out System error heading
"RTN","PSODOSUN",144,0)
 I 'PSODLQT D HD W !,"Maximum Single Dose Check could not be performed:",!
"RTN","PSODOSUN",145,0)
 Q
"RTN","PSODOSUN",146,0)
GETGN(PSODRIEN) ;get generic name
"RTN","PSODOSUN",147,0)
 K ^TMP($J,"PSODOSUN GN")
"RTN","PSODOSUN",148,0)
 D DATA^PSS50(PSODRIEN,,,,,"PSODOSUN GN")
"RTN","PSODOSUN",149,0)
 Q $S($D(^TMP($J,"PSODOSUN GN",PSODRIEN,.01)):^TMP($J,"PSODOSUN GN",PSODRIEN,.01),1:"")
"RTN","PSODOSUN",150,0)
 ;
"RTN","PSODOSUN",151,0)
PROMPT ;
"RTN","PSODOSUN",152,0)
 ;assumes that a previous check was made to verify that errors, exceptions or messages are present
"RTN","PSODOSUN",153,0)
 ;if only warnings (exceptions/errors) then display "Press return to continue"; otherwise display "Do you want to continue" prompt.
"RTN","PSODOSUN",154,0)
 ;FINISH and BACKDOOR are separated below in order keep to a mininum the vast number of scenarios to be tested
"RTN","PSODOSUN",155,0)
 I $G(PSODLOFF)&(($Y+5)>IOSL) D RETURN Q
"RTN","PSODOSUN",156,0)
 I $G(PSOFOERR) D  ;FINISH
"RTN","PSODOSUN",157,0)
 .Q:$D(^XUSEC("PSORPH",DUZ))&('$G(PSORENWD))
"RTN","PSODOSUN",158,0)
 .I '$G(PSODLFLG) D
"RTN","PSODOSUN",159,0)
 ..Q:'$G(PSOEDOUT)&$D(^XUSEC("PSORPH",DUZ))&('$G(PSORENWD))  ;messages need the "do you want to continue" prompt instead but need to evaluate here so that it doesn't show up for edits
"RTN","PSODOSUN",160,0)
 ..I '$G(PSORENWD) Q:PSOCPXB<4&('$G(PSODOSX))
"RTN","PSODOSUN",161,0)
 ..D RETURN
"RTN","PSODOSUN",162,0)
 ;
"RTN","PSODOSUN",163,0)
 I '$G(PSOFOERR)&'$G(PSODLFLG) D  ;BACKDOOR
"RTN","PSODOSUN",164,0)
 .Q:'$G(PSOEDOUT)&$D(^XUSEC("PSORPH",DUZ))&('$G(PSORENWD))  ;messages need the "do you want to continue" prompt instead but need to evaluate here so that it doesn't show up for edits
"RTN","PSODOSUN",165,0)
 .I '$G(PSORENWD),('$D(^XUSEC("PSORPH",DUZ))&'$G(PSODCAN)) Q:PSOCPXB<4&('$G(PSODOSX))
"RTN","PSODOSUN",166,0)
 .D RETURN
"RTN","PSODOSUN",167,0)
 ;
"RTN","PSODOSUN",168,0)
 I $G(PSODLFLG)&'$D(^XUSEC("PSORPH",DUZ)) D
"RTN","PSODOSUN",169,0)
 .I '$G(PSORENWD),('$D(^XUSEC("PSORPH",DUZ))&'$G(PSODCAN)) Q:PSOCPXB<4&('$G(PSODOSX))
"RTN","PSODOSUN",170,0)
 .D RETURN
"RTN","PSODOSUN",171,0)
 Q
"RTN","PSODOSUN",172,0)
 ;
"RTN","PSODOSUN",173,0)
RETURN ;
"RTN","PSODOSUN",174,0)
 Q:'$D(^XUSEC("PSORPH",DUZ))&($Y<10)
"RTN","PSODOSUN",175,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue,'^' to exit" D ^DIR K DIR  S:'Y PSODLQT=1,PSOQTOUT=1,PSORX("DFLG")=1 W @IOF
"RTN","PSODOSUN",176,0)
 Q
"RTN","PSODOSUN",177,0)
 ;
"RTN","PSODOSUN",178,0)
HD3(PSOLINES,OVRRID) ;
"RTN","PSODOSUN",179,0)
 N X,Y,DTOUT,DUOUT,DIR
"RTN","PSODOSUN",180,0)
 S:'$G(PSODLQT) PSODLQT=0  S:'$G(OVRRID) OVRRID=0 S:'$G(PSOLINES) PSOLINES=5
"RTN","PSODOSUN",181,0)
 I '$G(OVRRID),$G(PSODLQT)!(($Y+PSOLINES)<IOSL) Q
"RTN","PSODOSUN",182,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y W ! K DIR,Y S DIR(0)="E",DIR("A")="Press return to continue" D ^DIR K DIR,PSOLINES,OVRRID
"RTN","PSODOSUN",183,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODOSUN",184,0)
 W @IOF
"RTN","PSODOSUN",185,0)
 Q
"RTN","PSODOSUN",186,0)
 ;
"RTN","PSODOSUN",187,0)
MSG1 ;
"RTN","PSODOSUN",188,0)
 W !!,"  *** You must enter your Current Signature Code. ***"
"RTN","PSODOSUN",189,0)
 Q
"RTN","PSODOSUN",190,0)
MSG2 ;
"RTN","PSODOSUN",191,0)
 W !!,"  *** A Signature Code must be entered to continue with this order. ***",!
"RTN","PSODOSUN",192,0)
MSG3 ;
"RTN","PSODOSUN",193,0)
 N MSGX,DIR
"RTN","PSODOSUN",194,0)
 W ! K DIR S DIR(0)="E",DIR("A")="Press <Enter> to return to the order..." D ^DIR 
"RTN","PSODOSUN",195,0)
 S PSODLQT=1,PSOQTOUT=1,PSORX("DFLG")=1
"RTN","PSODOSUN",196,0)
 Q
"RTN","PSODOSUN",197,0)
 ;
"RTN","PSODOSUT")
0^3^B130783308
"RTN","PSODOSUT",1,0)
PSODOSUT ;BIR/RTR - PRE Dose Check Utility routine ;11/18/08
"RTN","PSODOSUT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,372,416,436**;DEC 1997;Build 5
"RTN","PSODOSUT",3,0)
 ;External reference to ^PSSDSAPI supported by DBIA 5425
"RTN","PSODOSUT",4,0)
 ;
"RTN","PSODOSUT",5,0)
 ;DOSE expect PSODLQT to be defined prior to calling it.
"RTN","PSODOSUT",6,0)
 ; PSODLQT=1 means no data will be written to the screen, but a value will be returned.
"RTN","PSODOSUT",7,0)
 ; PSODLQT=0 means data will be written to the screen and a value is returned 
"RTN","PSODOSUT",8,0)
 ;
"RTN","PSODOSUT",9,0)
 ;EVAL(PSODLINS,PSODLINR) ;
"RTN","PSODOSUT",10,0)
 ;Q $S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & DAILY DOSE RANGE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"DAILY DOSE RANGE",1:"UNKNOWN")
"RTN","PSODOSUT",11,0)
 ;
"RTN","PSODOSUT",12,0)
SUMM ;
"RTN","PSODOSUT",13,0)
 I 'PSODLQT W !,"   DOSING CHECK SUMMARY:",!!
"RTN","PSODOSUT",14,0)
 S PSOCPXF=1
"RTN","PSODOSUT",15,0)
 Q
"RTN","PSODOSUT",16,0)
 ;
"RTN","PSODOSUT",17,0)
SUB ;Write sub header; called from PSODOSUN
"RTN","PSODOSUT",18,0)
 D HD^PSODOSU2 Q:$G(PSODLQTC)  I 'PSODLQT,'$G(PSODLEXR) W ! S PSODLEXR=0
"RTN","PSODOSUT",19,0)
 D HD^PSODOSU2 Q:$G(PSODLQTC)
"RTN","PSODOSUT",20,0)
 I 'PSODLQT W "   DOSE SEQ "_PSOCPXG_":"
"RTN","PSODOSUT",21,0)
 S PSOCPXRR(PSOCPXG)=1
"RTN","PSODOSUT",22,0)
 Q
"RTN","PSODOSUT",23,0)
 ;
"RTN","PSODOSUT",24,0)
DAILY ;
"RTN","PSODOSUT",25,0)
 I 'PSODLQT W:'$G(PSORENW)!($G(PSOCOPY))!($G(PSORXED)) ! W "   DAILY DOSE RANGE WARNING:"
"RTN","PSODOSUT",26,0)
 S PSODAILY=1
"RTN","PSODOSUT",27,0)
 Q
"RTN","PSODOSUT",28,0)
 ;
"RTN","PSODOSUT",29,0)
COMPLEX ;called from DOSEZ^PSODOSUN
"RTN","PSODOSUT",30,0)
 I 'PSOCPXF&(PSOCPXC) S PSOCPXG=$P(PSODLNN1,";",4) D SUMM K PSODAILY S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSUT",31,0)
 I PSOCPXC S PSOCPXG=$P(PSODLNN1,";",4) D HD D
"RTN","PSODOSUT",32,0)
 .I $G(PSOCPXRR(PSOCPXG))&$P(PSODLNN1,";",5)'="" K PSODAILY
"RTN","PSODOSUT",33,0)
 .I '$G(PSOCPXRR(PSOCPXG))&('$G(PSOCPXH)) D SUB I $G(PSOCOPY)!($G(PSORENW)) S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSUT",34,0)
 .I PSODLPL="2_RANGE"&PSODLINR&'$G(PSODAILY) D DAILY
"RTN","PSODOSUT",35,0)
 .D HD W:'PSODLQT ! N X,DIWL,DIWR,DIWF S X=PSODLMSG,DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUT",36,0)
 .N PSODELXF,PSODELXR S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUT",37,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUT",38,0)
 .D HD I 'PSODLQT S PSODELNX=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) I '$P($G(PSODELNX),";",5)!($P($G(PSODELNX),";",4)'=PSOCPXG) W !
"RTN","PSODOSUT",39,0)
 Q
"RTN","PSODOSUT",40,0)
 ;
"RTN","PSODOSUT",41,0)
HD ;
"RTN","PSODOSUT",42,0)
 I $G(PSODLQT)!(($Y+5)<IOSL)!($G(PSORX("DFLG"))) Q
"RTN","PSODOSUT",43,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODOSUT",44,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue,'^' to exit" D ^DIR K DIR I 'Y!($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) S PSODLQT=1,PSONEW("DFLG")=1,PSORX("DFLG")=1 Q
"RTN","PSODOSUT",45,0)
 W @IOF
"RTN","PSODOSUT",46,0)
 Q
"RTN","PSODOSUT",47,0)
 ;
"RTN","PSODOSUT",48,0)
SFD ;
"RTN","PSODOSUT",49,0)
 S PSODELXF=1 S:PSODLERX="TEXT" PSODLERZ=1
"RTN","PSODOSUT",50,0)
 Q
"RTN","PSODOSUT",51,0)
 ;
"RTN","PSODOSUT",52,0)
SBAD ;Set Bad Drug flag just in case not set in enhanced check, possibly because Dosage edits are done first
"RTN","PSODOSUT",53,0)
 N PSODLBD1,PSODLBD3
"RTN","PSODOSUT",54,0)
 I PSODLERB["GCNSEQNO"!(PSODLERB["Drug not matched to NDF") D
"RTN","PSODOSUT",55,0)
 .S PSODLBD1=$O(^TMP($J,"PSOPDOSA","OUT","EXCEPTIONS","DOSE",PSODSEQ,PSODLNN1,"")) I PSODLBD1 D
"RTN","PSODOSUT",56,0)
 ..S PSODLBD3=$P($G(^TMP($J,"PSOPDOSA","OUT","EXCEPTIONS","DOSE",PSODSEQ,PSODLNN1,PSODLBD1)),"^",3) I PSODLBD3 S PSODRUG("BAD",PSODLBD3)=1
"RTN","PSODOSUT",57,0)
 Q
"RTN","PSODOSUT",58,0)
 ;
"RTN","PSODOSUT",59,0)
EXCEPT ;don't show "not matched to NDF" or "no GCNSEQNO" errors for dosing - when dosage is edited enhanced order checks are performed again so we don't want to display these type messages for dosing.
"RTN","PSODOSUT",60,0)
 N PSODLER1,PSODLER2
"RTN","PSODOSUT",61,0)
 F PSODLER1=0:0 S PSODLER1=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLER1)) Q:'PSODLER1  D
"RTN","PSODOSUT",62,0)
 .S PSODLER2=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLER1))
"RTN","PSODOSUT",63,0)
 .I PSODLER2["Drug not matched to NDF"!(PSODLER2["GCNSEQNO") D
"RTN","PSODOSUT",64,0)
 .. S PSODLER3="" F PSODLER3=PSODLER1-1:1:PSODLER1 K ^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLER3)
"RTN","PSODOSUT",65,0)
 Q
"RTN","PSODOSUT",66,0)
 ;
"RTN","PSODOSUT",67,0)
FEED() ; Write Line feed after Exceptions if no message globals follow, and next order has no errors or exceptions, only a message
"RTN","PSODOSUT",68,0)
 I PSODLQT Q 0
"RTN","PSODOSUT",69,0)
 N PSODLNN2
"RTN","PSODOSUT",70,0)
 I $D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE")) Q 0
"RTN","PSODOSUT",71,0)
 S PSODLNN2=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1))
"RTN","PSODOSUT",72,0)
 I PSODLNN2="" Q 0
"RTN","PSODOSUT",73,0)
 I $D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN2,"ERROR")) Q 0
"RTN","PSODOSUT",74,0)
 I $D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN2,"EXCEPTIONS")) Q 0
"RTN","PSODOSUT",75,0)
 Q 1
"RTN","PSODOSUT",76,0)
 ;
"RTN","PSODOSUT",77,0)
DCHKN ;Called from PSOORNEW, PSOORNE1 & PSOORNEW; Dose Check for Copying an Order
"RTN","PSODOSUT",78,0)
 F PSOCPXA=0:0 S PSOCPXA=$O(PSONEW("DOSE",PSOCPXA)) Q:'PSOCPXA  S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",79,0)
 D FIN^PSODOSCL(.PSODLBS1,.PSONEW,.PSODRUG)
"RTN","PSODOSUT",80,0)
 S PSODLNVL=$$DOSE^PSODOSUN K ^TMP($J,"PSOPDOSN") K ^TMP($J,"PSOPDOSA")
"RTN","PSODOSUT",81,0)
 I $P($G(PSODLNVL),"^")=1 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",82,0)
 I '$G(PSODLNVL) Q
"RTN","PSODOSUT",83,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^") ^TMP("PSODOSF",$J,0)=1 Q
"RTN","PSODOSUT",84,0)
 S PSODLNVT=$P(PSODLNVL,"^",2)
"RTN","PSODOSUT",85,0)
 I +PSODLNVL=3 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",86,0)
 ;I +PSODLNVL=3 D CANCEL(PSONEW("OIRXN")) Q  ;CR2724
"RTN","PSODOSUT",87,0)
 I $$EN3^PSORXI(PSODLNVT) W !!,"Unable to log intervention, cannot find intervention type.",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODOSUT",88,0)
 Q
"RTN","PSODOSUT",89,0)
 ;
"RTN","PSODOSUT",90,0)
DCHKR ;Renewal Dose Check; Called from PSORENW0
"RTN","PSODOSUT",91,0)
 F PSOCPXA=0:0 S PSOCPXA=$O(PSORENW("DOSE",PSOCPXA)) Q:'PSOCPXA  S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",92,0)
 D FIN^PSODOSCL(.PSODLBS1,.PSORENW,.PSODRUG)
"RTN","PSODOSUT",93,0)
 S PSODLNVL=$$DOSE^PSODOSUN
"RTN","PSODOSUT",94,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^") ^TMP("PSODOSF",$J,0)=1
"RTN","PSODOSUT",95,0)
 K ^TMP($J,"PSOPDOSN") K ^TMP($J,"PSOPDOSA") I $P($G(PSODLNVL),"^")=1 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",96,0)
 D DOSIV
"RTN","PSODOSUT",97,0)
 Q
"RTN","PSODOSUT",98,0)
 ;
"RTN","PSODOSUT",99,0)
DCHKC ;Dose Check on reinstate; Called from PSOCAN2
"RTN","PSODOSUT",100,0)
 N PSODCAN
"RTN","PSODOSUT",101,0)
 I '$D(PSODRUG("IEN")) S:$D(PSORENW("OIRXN")) PSODRUG("IEN")=$$GET1^DIQ(52,PSORENW("OIRXN"),6,"I")
"RTN","PSODOSUT",102,0)
 S PSOCPXB=0 F PSOCPXA=0:0 S PSOCPXA=$O(^PSRX(PSORENW("OIRXN"),6,PSOCPXA)) Q:'PSOCPXA  I $P($G(^PSRX(PSORENW("OIRXN"),6,PSOCPXA,0)),"^")'="" S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",103,0)
 D RX^PSODOSCL(.PSODLBS1,PSORENW("OIRXN"))
"RTN","PSODOSUT",104,0)
 S PSODLNNN=PSORENW("OIRXN"),PSODCAN=1
"RTN","PSODOSUT",105,0)
 S PSODLNVL=$$DOSE^PSODOSUN K ^TMP($J,"PSOPDOSN"),^TMP($J,"PSOPDOSA")
"RTN","PSODOSUT",106,0)
 I $P($G(PSODLNVL),"^")=1 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",107,0)
 D DOSIV
"RTN","PSODOSUT",108,0)
 I +PSODLNVL=3 S PSORX("DFLG")=1
"RTN","PSODOSUT",109,0)
 Q
"RTN","PSODOSUT",110,0)
 ;
"RTN","PSODOSUT",111,0)
DCHK() ;Dose check after entering Null at the conjunction prompt
"RTN","PSODOSUT",112,0)
 ;For complex Dosing, they will eventually enter null too, so change to call if it was not a complex order, and null was entered
"RTN","PSODOSUT",113,0)
 N PSODONOF S PSODONOF="" D DOSEOFF Q:'+PSODONOF 0
"RTN","PSODOSUT",114,0)
 Q:$G(PSORX("DFLG")) 0
"RTN","PSODOSUT",115,0)
 ;D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG")) 0
"RTN","PSODOSUT",116,0)
 N PSODLNNN,PSODLENT,PSODLNVL,PSODLNVT,X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT,PSODLBS1,PSODLENT,PSOCPXA,PSOCPXV,PSOTOF,PSOCPXB
"RTN","PSODOSUT",117,0)
 ;Need to make sure Drug Name is what you set in the API
"RTN","PSODOSUT",118,0)
 ;Either pass in name here, or set in PSODOSCL to array name that PSSDSAPD uses, which is still the .01 of File 50
"RTN","PSODOSUT",119,0)
 I $$EXMT^PSSDSAPI(PSODRUG("IEN")) Q 0
"RTN","PSODOSUT",120,0)
 I $G(PSODRUG("BAD",PSODRUG("IEN"))) Q 0
"RTN","PSODOSUT",121,0)
 ;Currently only one prospective drug at a time for Outpatient Dose Check
"RTN","PSODOSUT",122,0)
 ;S PSODLNNN="O;1;PROSPECTIVE;1"
"RTN","PSODOSUT",123,0)
 K ^TMP("PSODOSF",$J)
"RTN","PSODOSUT",124,0)
 K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN") S PSODLBS1(1)="PSOPDOSA",PSODLBS1(3)="PSOPDOSN"
"RTN","PSODOSUT",125,0)
 D FIN^PSODOSCL(.PSODLBS1,.PSORXED,.PSODRUG)
"RTN","PSODOSUT",126,0)
 S PSODLENT=ENT,PSOCPXV=1,PSOCPXB=0
"RTN","PSODOSUT",127,0)
 S PSOCPXB=0 F PSOCPXA=0:0 S PSOCPXA=$O(PSORXED("DOSE",PSOCPXA)) Q:'PSOCPXA  S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",128,0)
 S PSODLNVL=$$DOSEX^PSODOSUN(PSODLENT) S PSOTOF=1 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^") ^TMP("PSODOSF",$J,0)=1
"RTN","PSODOSUT",129,0)
 I $G(PSOEDDOS) D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG")) 0
"RTN","PSODOSUT",130,0)
 I $P($G(PSODLNVL),"^")=1 K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN") Q 1
"RTN","PSODOSUT",131,0)
DCHK2 ;Finishing of a complex order
"RTN","PSODOSUT",132,0)
 N PSOCPXC,PSOCPXD
"RTN","PSODOSUT",133,0)
 K PSODLNVL
"RTN","PSODOSUT",134,0)
 S PSOCPXD=1 ;flag for MOCHA 2.0, used to not display enter to continue prompt after errors/exceptions list which displays just after last dose sequence.  MOCHA 2.0 does not display errors or exceptions.
"RTN","PSODOSUT",135,0)
 ;S (PSOCPXB)=0 ;setting PSOCPXB=0 makes dosing summery not display when cycling through individual doses of a complex order.  Dose summary should only show after accept of order.
"RTN","PSODOSUT",136,0)
 S PSODLNVL=$$DOSEZ^PSODOSUN K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN")
"RTN","PSODOSUT",137,0)
 I $G(PSOEDDOS) D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG")) 0
"RTN","PSODOSUT",138,0)
 I $P($G(PSODLNVL),"^")=1 Q 1
"RTN","PSODOSUT",139,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^")=2 ^TMP("PSODOSF",$J,0)=$$CONVMSG($P(PSODLNVL,"^",2)) W ! Q 0
"RTN","PSODOSUT",140,0)
 I '$G(PSODLNVL) Q 0
"RTN","PSODOSUT",141,0)
 S PSODLNVT=$P(PSODLNVL,"^",2)
"RTN","PSODOSUT",142,0)
 I $D(PSORX("EDIT"))!($G(PSORXED)&$G(PSORXED)&$G(PSOEDDOS))!($G(PSOCOPY)&$G(PSODLBD4)) Q 0
"RTN","PSODOSUT",143,0)
 I $$EN3^PSORXI(PSODLNVT) W !!,"Unable to log intervention, cannot find intervention type.",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODOSUT",144,0)
 W !
"RTN","PSODOSUT",145,0)
 Q 0
"RTN","PSODOSUT",146,0)
 ;
"RTN","PSODOSUT",147,0)
DCHK1 ;Dose check after entering a value at the Conjunction prompt
"RTN","PSODOSUT",148,0)
 Q:$G(PSORX("DFLG"))!($G(PSODLQT))
"RTN","PSODOSUT",149,0)
 N PSODONOF S PSODONOF="" D DOSEOFF Q:'+PSODONOF
"RTN","PSODOSUT",150,0)
 ;D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG"))
"RTN","PSODOSUT",151,0)
 N PSODLNNN,PSODLNVL,PSODLNVT,X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT,PSODLBS1,PSODLENT,PSOCPXB
"RTN","PSODOSUT",152,0)
 ;Need to make sure Drug Name is what you set in the API
"RTN","PSODOSUT",153,0)
 ;Either pass in name here, or set in PSODOSCL to array name that PSSDSAPD uses, which is still the .01 of File 50
"RTN","PSODOSUT",154,0)
 I $$EXMT^PSSDSAPI(PSODRUG("IEN")) Q
"RTN","PSODOSUT",155,0)
 I $G(PSODRUG("BAD",PSODRUG("IEN"))) Q
"RTN","PSODOSUT",156,0)
 ;Currently only one prospective drug at a time for Outpatient Dose Check
"RTN","PSODOSUT",157,0)
 ;S PSODLNNN="O;1;PROSPECTIVE;1"
"RTN","PSODOSUT",158,0)
 K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN") S PSODLBS1(1)="PSOPDOSA",PSODLBS1(3)="PSOPDOSN"
"RTN","PSODOSUT",159,0)
 D FIN^PSODOSCL(.PSODLBS1,.PSORXED,.PSODRUG)
"RTN","PSODOSUT",160,0)
 S PSODLENT=ENT,PSOCPXB=0
"RTN","PSODOSUT",161,0)
 F PSOCPXA=0:0 S PSOCPXA=$O(PSORXED("DOSE",PSOCPXA)) Q:'PSOCPXA  S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",162,0)
 S PSODLNVL=$$DOSEX^PSODOSUN(PSODLENT)
"RTN","PSODOSUT",163,0)
 D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG"))
"RTN","PSODOSUT",164,0)
 K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN") I $P($G(PSODLNVL),"^")=1 S PSORXED("DFLG")=1 Q
"RTN","PSODOSUT",165,0)
 I '$G(PSODLNVL) Q
"RTN","PSODOSUT",166,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^")=2 ^TMP("PSODOSF",$J,0)=$$CONVMSG($P(PSODLNVL,"^",2)) W ! Q
"RTN","PSODOSUT",167,0)
 S PSODLNVT=$P(PSODLNVL,"^",2)
"RTN","PSODOSUT",168,0)
 I $$EN3^PSORXI(PSODLNVT) W !!,"Unable to log intervention, cannot find intervention type.",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODOSUT",169,0)
 W !
"RTN","PSODOSUT",170,0)
 Q
"RTN","PSODOSUT",171,0)
 ;
"RTN","PSODOSUT",172,0)
CONVMSG(MESS) ;Convert DOSE CHECK message to numeric value for field 8 of ^PS(52.4
"RTN","PSODOSUT",173,0)
 ;For MOCHA 2.0, only returning "DOSAGE EXCEEDS MAX SINGLE DOSE" when a dosing error is present.
"RTN","PSODOSUT",174,0)
 N PSODOSF
"RTN","PSODOSUT",175,0)
 S MESS="DOSAGE EXCEEDS MAX SINGLE DOSE"
"RTN","PSODOSUT",176,0)
 S PSODOSF=$S(MESS="DOSAGE EXCEEDS MAX SINGLE DOSE":4,MESS="MAX SINGLE DOSE & DAILY DOSE RANGE":3,MESS="MAX SINGLE DOSE":2,MESS="DAILY DOSE RANGE":1,1:"")
"RTN","PSODOSUT",177,0)
 Q PSODOSF
"RTN","PSODOSUT",178,0)
 ;
"RTN","PSODOSUT",179,0)
DCHKV ;Dose check when verifying an order
"RTN","PSODOSUT",180,0)
 N PSODOSF,PSOLINE,PSOVERFL,PSOVCAN
"RTN","PSODOSUT",181,0)
 S PSOVERFL=1
"RTN","PSODOSUT",182,0)
 F PSOCPXA=0:0 S PSOCPXA=$O(^PSRX(PSONV,6,PSOCPXA)) Q:'PSOCPXA  I $P($G(^PSRX(PSONV,6,PSOCPXA,0)),"^")'="" S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",183,0)
 D RX^PSODOSCL(.PSODLBS1,PSONV)
"RTN","PSODOSUT",184,0)
 S $P(PSOLINE,"-",79)="-"
"RTN","PSODOSUT",185,0)
 S PSODLNNN=PSONV
"RTN","PSODOSUT",186,0)
 S PSODLNVL=$$DOSE^PSODOSUN K ^TMP($J,"PSOPDOSN") K ^TMP($J,"PSOPDOSA") I $P($G(PSODLNVL),"^")=1 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",187,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^")=2 ^TMP("PSODOSF",$J,0)=$$CONVMSG($P(PSODLNVL,"^",2))
"RTN","PSODOSUT",188,0)
 I '$G(PSODLNVL) Q
"RTN","PSODOSUT",189,0)
 I +PSODLNVL=3 D  Q:PSOVCAN
"RTN","PSODOSUT",190,0)
 . D SIG^XUSESIG I X1="" S (PSORX("DFLG"),PSVERFLG)=1 Q
"RTN","PSODOSUT",191,0)
 . D NOOR^PSOCAN4
"RTN","PSODOSUT",192,0)
 . I $G(DIRUT) D UPOUT^PSODGDG1,KILL^PSODGDG1 K PSONORR,PSORX("INTERVENE") Q
"RTN","PSODOSUT",193,0)
 . S PSOVCAN=1
"RTN","PSODOSUT",194,0)
 . S DA=PSONV D RXV^PSODGDG1 S DA=PSONV D INV^PSODGDG1 S DA=PSONV D PSDEL^PSODGDG1,DEL^PSODGDG1
"RTN","PSODOSUT",195,0)
 . K DIK,LST,PSONOOR S PSVERFLG=1
"RTN","PSODOSUT",196,0)
 S PSODLNVT=$P(PSODLNVL,"^",2),PSODOSF=1
"RTN","PSODOSUT",197,0)
 I +PSODLNVL=3 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",198,0)
 S DA=PSONV,RX=$G(^PSRX(PSONV,0)) D DOSIV  ;CRI^PSODGDG1
"RTN","PSODOSUT",199,0)
 Q
"RTN","PSODOSUT",200,0)
 ;
"RTN","PSODOSUT",201,0)
DOSIV ;DOSE INTERVENTION
"RTN","PSODOSUT",202,0)
 I PSOFROM="C",'$D(^XUSEC("PSORPH",DUZ)) Q
"RTN","PSODOSUT",203,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^")=2 ^TMP("PSODOSF",$J,0)=$$CONVMSG($P(PSODLNVL,"^",2)) Q
"RTN","PSODOSUT",204,0)
 I '$G(PSODLNVL) Q
"RTN","PSODOSUT",205,0)
 S PSODLNVT=$P(PSODLNVL,"^",2)
"RTN","PSODOSUT",206,0)
DOSIV1 ;
"RTN","PSODOSUT",207,0)
 I $$EN3^PSORXI(PSODLNVT) D
"RTN","PSODOSUT",208,0)
 . W !!,"Unable to log intervention, cannot find intervention type.",!
"RTN","PSODOSUT",209,0)
 . K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODOSUT",210,0)
 Q
"RTN","PSODOSUT",211,0)
 ;
"RTN","PSODOSUT",212,0)
CANCEL(PSONV) ;CR2724 -  where PSONV = RXIEN 
"RTN","PSODOSUT",213,0)
 D SIG^XUSESIG I X1="" S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",214,0)
 D NOOR^PSOCAN4
"RTN","PSODOSUT",215,0)
 I $G(DIRUT) D UPOUT^PSODGDG1,KILL^PSODGDG1 K PSONORR,PSORX("INTERVENE") Q
"RTN","PSODOSUT",216,0)
 S DA=PSONV D INV^PSODGDG1 S DA=PSONV D PSDEL^PSODGDG1,DEL^PSODGDG1
"RTN","PSODOSUT",217,0)
 K DIK,LST,PSONOOR
"RTN","PSODOSUT",218,0)
 Q
"RTN","PSODOSUT",219,0)
 ;
"RTN","PSODOSUT",220,0)
DOSCK(PSOFROM,MSG) ;
"RTN","PSODOSUT",221,0)
 ;D HD
"RTN","PSODOSUT",222,0)
 N PSODONOF S PSODONOF="" D DOSEOFF Q:'+PSODONOF
"RTN","PSODOSUT",223,0)
 I $G(PSORX("DFLG"))!($G(PSODOSD)) S PSORX("DFLG")=1 K PSODOSD Q
"RTN","PSODOSUT",224,0)
 N PSODLNNN,PSODLNVL,PSODLNVT,X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT,PSODLBS1,PSOCPXA,PSOCPXB,PSOCPXC
"RTN","PSODOSUT",225,0)
 Q:$$EXMT^PSSDSAPI(PSODRUG("IEN"))
"RTN","PSODOSUT",226,0)
 Q:$G(PSODRUG("BAD",PSODRUG("IEN")))
"RTN","PSODOSUT",227,0)
 K ^TMP($J,"PSOPDOSN"),^TMP($J,"PSOPDOSA"),^TMP("PSODOSF",$J) S PSODLBS1(1)="PSOPDOSA",PSODLBS1(3)="PSOPDOSN"
"RTN","PSODOSUT",228,0)
 I ($D(DTOUT))!($D(DUOUT))!($G(DIRUT))!($G(PSODLQT)) K PSODLQT,DTOUT,DUOUT,DIRUT,PSORX("DFLG") Q
"RTN","PSODOSUT",229,0)
 ;D CLEAR^VALM1
"RTN","PSODOSUT",230,0)
 S PSOCPXB=0
"RTN","PSODOSUT",231,0)
 I PSOFROM="V" D DCHKV Q  ;PSOVER1 - verification 
"RTN","PSODOSUT",232,0)
 I PSOFROM="N" D DCHKN Q  ;PSOORNE1 & PSOORNEW - new & copy
"RTN","PSODOSUT",233,0)
 I PSOFROM="R" D DCHKR Q  ;PSORENW0 - renewal
"RTN","PSODOSUT",234,0)
 I PSOFROM="C" D DCHKC Q  ;PSOCAN2 - cancel
"RTN","PSODOSUT",235,0)
 Q
"RTN","PSODOSUT",236,0)
 ;
"RTN","PSODOSUT",237,0)
RCONVMS(MESS) ;Convert DOSE CHECK from numeric to alpha
"RTN","PSODOSUT",238,0)
 N PSODOSF
"RTN","PSODOSUT",239,0)
 S MESS=4  ;For MOCHA 2.0, only returning "DOSAGE EXCEEDS MAX SINGLE DOSE" when a dosing error is present.
"RTN","PSODOSUT",240,0)
 S PSODOSF=$S(MESS=4:"DOSAGE EXCEEDS MAX SINGLE DOSE",MESS=3:"MAX SINGLE DOSE & DAILY DOSE RANGE",MESS=2:"MAX SINGLE DOSE",MESS=1:"DAILY DOSE RANGE",1:"")
"RTN","PSODOSUT",241,0)
 Q PSODOSF
"RTN","PSODOSUT",242,0)
 ;
"RTN","PSODOSUT",243,0)
DOSEOFF ;
"RTN","PSODOSUT",244,0)
 S PSODONOF=$$DS^PSSDSAPI
"RTN","PSODOSUT",245,0)
DOSEOFF2 ;
"RTN","PSODOSUT",246,0)
 I $G(PSORX("DOSING OFF")),+PSODONOF K PSORX("DOSING OFF"),PSOREINF,PSOONOFC Q
"RTN","PSODOSUT",247,0)
 Q:+PSODONOF
"RTN","PSODOSUT",248,0)
 I ($G(PSOONOFC)!$G(PSOREINF)),'+PSODONOF S PSORX("DOSING OFF")=1  ;Reinstate news PSORX array so have to work around it
"RTN","PSODOSUT",249,0)
 Q:$G(PSORX("DOSING OFF"))  ;only display 'dosing off' message once per patient 
"RTN","PSODOSUT",250,0)
 N PSODOFFC
"RTN","PSODOSUT",251,0)
 I '+PSODONOF&($P(PSODONOF,"^",2)'="") D
"RTN","PSODOSUT",252,0)
 .S X=$P(PSODONOF,"^",2),DIWL=1,DIWR=73 K ^UTILITY($J,"W") D ^DIWP W !
"RTN","PSODOSUT",253,0)
 .S PSODOFFC=0 F PSODOFFC=0:0 S PSODOFFC=$O(^UTILITY($J,"W",DIWL,PSODOFFC)) Q:'PSODOFFC  W !?5,$G(^UTILITY($J,"W",DIWL,PSODOFFC,0))
"RTN","PSODOSUT",254,0)
 .N DIR,DIRUT,DUOUT,X,Y S DIR(0)="E"
"RTN","PSODOSUT",255,0)
 .S DIR("A")="Press Return to continue...",DIR("?")="Press Return to continue"
"RTN","PSODOSUT",256,0)
 .W ! D ^DIR K DIRUT,DUOUT,DIR,X,Y W !
"RTN","PSODOSUT",257,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUT",258,0)
 .S PSORX("DOSING OFF")=1 S:$G(PSOREINS) (PSOREINF,PSOONOFC)=1  ;set this flag to only display 'dosing off' message once per session. 
"RTN","PSODOSUT",259,0)
 Q
"RTN","PSOLMPO")
0^2^B1379839
"RTN","PSOLMPO",1,0)
PSOLMPO ;ISC-BHAM/LC - pending orders ;03/13/95
"RTN","PSOLMPO",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,225,436**;DEC 1997;Build 5
"RTN","PSOLMPO",3,0)
 ;
"RTN","PSOLMPO",4,0)
EN ; -- main entry point for PSO LM PENDING ORDER
"RTN","PSOLMPO",5,0)
 S PSOLMC=0 D EN^VALM("PSO LM PENDING ORDER") K PSOLMC
"RTN","PSOLMPO",6,0)
 Q
"RTN","PSOLMPO",7,0)
 ;
"RTN","PSOLMPO",8,0)
HDR ; -- header code
"RTN","PSOLMPO",9,0)
 D HDR^PSOLMUTL
"RTN","PSOLMPO",10,0)
 Q
"RTN","PSOLMPO",11,0)
 ;
"RTN","PSOLMPO",12,0)
INIT ; -- init variables and list array
"RTN","PSOLMPO",13,0)
 ;F LINE=1:1:30 D SET^VALM10(LINE,LINE_"     Line number "_LINE)
"RTN","PSOLMPO",14,0)
 S VALMCNT=IEN,VALM("TITLE")=$S($P(OR0,"^",23):"FL-",1:"")_"Pending OP Orders ("_$S($P(OR0,"^",14)="S":"STAT",$P(OR0,"^",14)="E":"EMERGENCY",1:"ROUTINE")_")"
"RTN","PSOLMPO",15,0)
 D RV^PSONFI
"RTN","PSOLMPO",16,0)
 Q
"RTN","PSOLMPO",17,0)
 ;
"RTN","PSOLMPO",18,0)
HELP ; -- help code
"RTN","PSOLMPO",19,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOLMPO",20,0)
 Q
"RTN","PSOLMPO",21,0)
 ;
"RTN","PSOLMPO",22,0)
EXIT ; -- exit code
"RTN","PSOLMPO",23,0)
 I $D(^TMP("PSORXDC",$J)) D FULL^VALM1,CLEAN^PSOVER1
"RTN","PSOLMPO",24,0)
 K FLAGLINE D CLEAN^VALM10
"RTN","PSOLMPO",25,0)
 Q
"RTN","PSOLMPO",26,0)
 ;
"RTN","PSOLMPO",27,0)
EXPND ; -- expand code
"RTN","PSOLMPO",28,0)
 Q
"RTN","PSOLMPO",29,0)
 ;
"RTN","PSOORNEW")
0^1^B93914156
"RTN","PSOORNEW",1,0)
PSOORNEW ;BIR/SAB - display orders from oerr ;6/19/06 3:53pm
"RTN","PSOORNEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,55,46,71,90,94,106,131,133,143,237,222,258,206,225,251,386,390,391,372,416,431,313,408,436**;DEC 1997;Build 5
"RTN","PSOORNEW",3,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORNEW",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORNEW",5,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOORNEW",6,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORNEW",7,0)
 ;External reference to EN1^ORCFLAG supported by DBIA 3620
"RTN","PSOORNEW",8,0)
 ;
"RTN","PSOORNEW",9,0)
 ;PSO*237 quit Finish if Today > Issue date + 365
"RTN","PSOORNEW",10,0)
 ;
"RTN","PSOORNEW",11,0)
DSPL I $G(PSODSPL) S VALMBCK="Q" K PSODSPL,PSOANSQD Q
"RTN","PSOORNEW",12,0)
 Q:'$D(PSOLMC)  K ^TMP("PSOPO",$J) S PSOLMC=PSOLMC+1
"RTN","PSOORNEW",13,0)
 I $D(CLOZPAT) S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),1:7) G OI
"RTN","PSOORNEW",14,0)
 S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3))&('$G(PSONEW("DAYS SUPPLY"))):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:30)
"RTN","PSOORNEW",15,0)
OI I '$G(PSODRUG("OI")) D
"RTN","PSOORNEW",16,0)
 .S (OI,PSODRUG("OI"))=$P(OR0,"^",8),PSODRUG("OIN")=$P(^PS(50.7,$P(OR0,"^",8),0),"^"),OID=$P(OR0,"^",9)
"RTN","PSOORNEW",17,0)
 .I $P($G(OR0),"^",9) S POERR=1,DREN=$P(OR0,"^",9) D DRG^PSOORDRG K POERR
"RTN","PSOORNEW",18,0)
 I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A",$G(PSODRUG("DEA"))'["B"!($G(PSODRUG("DEA"))["F") S PSONEW("# OF REFILLS")=0
"RTN","PSOORNEW",19,0)
 I $D(CLOZPAT) S PSONEW("# OF REFILLS")=$S($D(PSONEW("# OF REFILLS")):PSONEW("# OF REFILLS"),$G(CLOZPAT)=2&($P(OR0,"^",11)>2):3,$G(CLOZPAT)&($P(OR0,"^",11)>1):1,1:0)
"RTN","PSOORNEW",20,0)
 S IEN=0 D OBX^PSOORFI1,DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:""))
"RTN","PSOORNEW",21,0)
 D LMDISP^PSOORFI5(+$G(ORD)) ; Display Flag/Unflag Information
"RTN","PSOORNEW",22,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="*(1) Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNEW",23,0)
 S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",24,0)
 K LST I $G(PSODRUG("NAME"))]"" D  G PT
"RTN","PSOORNEW",25,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)"_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORNEW",26,0)
 .S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",27,0)
 .I $P($G(^PSDRUG(PSODRUG("IEN"),0)),"^",10)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Drug Message:" D DRGMSG
"RTN","PSOORNEW",28,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)           Drug: No Dispense Drug Selected"
"RTN","PSOORNEW",29,0)
PT D DOSE2^PSOORFI4
"RTN","PSOORNEW",30,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (4)   Pat Instruct:" D:$O(PSONEW("SIG",0)) INST^PSOORFI4
"RTN","PSOORNEW",31,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Provider Comments:" S TY=3 D INST^PSOORFI1
"RTN","PSOORNEW",32,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Instructions:" S TY=2 D INST^PSOORFI1
"RTN","PSOORNEW",33,0)
 K PSOELSE S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                SIG:"
"RTN","PSOORNEW",34,0)
 F I=0:0 S I=$O(SIG(I)) Q:'I  S SIG=SIG(I) D
"RTN","PSOORNEW",35,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNEW",36,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (5) Patient Status: "_$P($G(^PS(53,+PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORNEW",37,0)
 K PSOELSE I $G(PSONEW("ISSUE DATE"))']"" S PSOELSE=1 S IEN=IEN+1,(PSOID,Y)=$E($P(OR0,"^",6),1,7) X ^DD("DD") S PSONEW("ISSUE DATE")=Y,^TMP("PSOPO",$J,IEN,0)=" (4)     Issue Date: "_Y
"RTN","PSOORNEW",38,0)
 I '$G(PSOELSE) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (6)     Issue Date: "_PSONEW("ISSUE DATE")
"RTN","PSOORNEW",39,0)
 K PSOELSE I $G(PSORX("FILL DATE"))']"" S PSOELSE=1 D
"RTN","PSOORNEW",40,0)
 .S (Y,PSORX("FILL DATE"))=$S($E($P(OR0,"^",6),1,7)<DT:DT,1:$E($P(OR0,"^",6),1,7)) X ^DD("DD") S PSONEW("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                  (5) Fill Date: "_Y
"RTN","PSOORNEW",41,0)
 I '$G(PSOELSE) S Y=PSORX("FILL DATE") X ^DD("DD") S PSORX("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"       (7) Fill Date: "_PSORX("FILL DATE")
"RTN","PSOORNEW",42,0)
 I $P(OR0,"^",18) S IEN=IEN+1,Y=$P(OR0,"^",18) X ^DD("DD") S $P(^TMP("PSOPO",$J,IEN,0)," ",39)="Effective Date: "_Y
"RTN","PSOORNEW",43,0)
 I $D(CLOZPAT) D ELIG^PSOORFI2 S:'$D(PSONEW("QTY")) PSONEW("QTY")=0
"RTN","PSOORNEW",44,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (8)    Days Supply: "_PSONEW("DAYS SUPPLY")
"RTN","PSOORNEW",45,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"               (9)   QTY"_$S($P($G(^PSDRUG(+$G(PSODRUG("IEN")),660)),"^",8)]"":" ("_$P($G(^PSDRUG(+PSODRUG("IEN"),660)),"^",8)_")",1:" (  )")
"RTN","PSOORNEW",46,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_": "_$S($G(PSONEW("QTY"))]"":PSONEW("QTY"),1:$P(OR0,"^",10))
"RTN","PSOORNEW",47,0)
 I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),5)),"^")]"" D
"RTN","PSOORNEW",48,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNEW",49,0)
 .S ^TMP("PSOPO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^") K RN
"RTN","PSOORNEW",50,0)
 S IEN=IEN+1
"RTN","PSOORNEW",51,0)
 I $P(OR0,"^",24) S ^TMP("PSOPO",$J,IEN,0)="   Provider ordered: days supply "_+$P(OR0,"^",22)_", quantity "_+$P(OR0,"^",10)_" & refills "_+$P(OR0,"^",11)
"RTN","PSOORNEW",52,0)
 E  S ^TMP("PSOPO",$J,IEN,0)="       Provider ordered "_+$P(OR0,"^",11)_" refills"
"RTN","PSOORNEW",53,0)
 D:$D(CLOZPAT) PQTY^PSOORFI4
"RTN","PSOORNEW",54,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(10)   # of Refills: "_$S($G(PSONEW("# OF REFILLS"))]"":PSONEW("# OF REFILLS"),1:$P(OR0,"^",11))_"               (11)   Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORNEW",55,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(12)         Clinic: "_PSORX("CLINIC")
"RTN","PSOORNEW",56,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(13)       Provider: "_PSONEW("PROVIDER NAME")
"RTN","PSOORNEW",57,0)
 D:$P(OR0,"^",24)!((+$G(PSODRUG("DEA"))>1)&(+$G(PSODRUG("DEA"))<6)) PRV^PSOORFI5($G(PSONEW("PROVIDER")),$G(PSODRUG("IEN")),$P(OR0,"^"))
"RTN","PSOORNEW",58,0)
 I $P($G(^VA(200,$S($G(PSONEW("PROVIDER")):PSONEW("PROVIDER"),1:$P(OR0,"^",5)),"PS")),"^",7)&($P($G(^("PS")),"^",8)) D
"RTN","PSOORNEW",59,0)
 .S IEN=IEN+1,PSONEW("COSIGNING PROVIDER")=$S($G(PSONEW("COSIGNING PROVIDER")):PSONEW("COSIGNING PROVIDER"),1:$P(^("PS"),"^",8))
"RTN","PSOORNEW",60,0)
 .S ^TMP("PSOPO",$J,IEN,0)="       Cos-Provider: "_$P(^VA(200,PSONEW("COSIGNING PROVIDER"),0),"^")
"RTN","PSOORNEW",61,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(14)         Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1)
"RTN","PSOORNEW",62,0)
 S PSONEW("REMARKS")=$S($G(PSONEW("REMARKS"))]"":PSONEW("REMARKS"),$P(OR0,"^",17)="C":"Administered in Clinic.",1:"")
"RTN","PSOORNEW",63,0)
 K PSONEW("ADMINCLINIC") S:$P(OR0,"^",17)="C" PSONEW("ADMINCLINIC")=1
"RTN","PSOORNEW",64,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(15)        Remarks:"
"RTN","PSOORNEW",65,0)
 I $G(PSONEW("REMARKS"))]"" D
"RTN","PSOORNEW",66,0)
 .F SG=1:1:$L(PSONEW("REMARKS")) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("REMARKS")," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",67,0)
 ..S:$P(PSONEW("REMARKS")," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("REMARKS")," ",SG)
"RTN","PSOORNEW",68,0)
 I $G(PSOSIGFL)!(PSODRUG("OI")'=$P(OR0,"^",8)) S PSONEW("CLERK CODE")=DUZ,PSORX("CLERK CODE")=$P(^VA(200,DUZ,0),"^"),VALMSG="This change will create a new prescription!"
"RTN","PSOORNEW",69,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,PSONEW("CLERK CODE"),0),"^")_$E(RN,$L($P(^VA(200,PSONEW("CLERK CODE"),0),"^"))+1,35)
"RTN","PSOORNEW",70,0)
 S Y=$P(OR0,"^",12) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$E($P(OR0,"^",12),4,5)_"/"_$E($P(OR0,"^",12),6,7)_"/"_$E($P(OR0,"^",12),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORNEW",71,0)
 I PSOLMC<2 D ^PSOLMPO1 S VALMBCK="Q",PSOLMC=0
"RTN","PSOORNEW",72,0)
 S:PSOLMC>1 VALMBCK="R"
"RTN","PSOORNEW",73,0)
 Q
"RTN","PSOORNEW",74,0)
ORCHK D PROVCOM^PSOORFI4,ORCHK^PSOORFI4
"RTN","PSOORNEW",75,0)
 Q
"RTN","PSOORNEW",76,0)
EDT D KV S DIR("A",1)="* Indicates which fields will create an new Order",DIR("A")="Select Field to Edit by number",DIR(0)="LO^1:15" D ^DIR Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOORNEW",77,0)
EDTSEL N LST,FLD,OUT D KV S OUT=0
"RTN","PSOORNEW",78,0)
 I +Y S LST=Y D FULL^VALM1 N PSODOSE M PSODOSE=PSONEW D  G DSPL
"RTN","PSOORNEW",79,0)
 .F FLD=1:1:$L(LST,",") Q:$P(LST,",",FLD)']""!(OUT)  D @(+$P(LST,",",FLD)) D:$P(LST,",",FLD)=8 REF D KV
"RTN","PSOORNEW",80,0)
 E  S VALMBCK="" Q
"RTN","PSOORNEW",81,0)
 Q
"RTN","PSOORNEW",82,0)
ACP ;
"RTN","PSOORNEW",83,0)
 N PSOORNEW,DIR,Y S Y=0,PSOORNEW=1
"RTN","PSOORNEW",84,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 D  Q:$D(DIRUT)!'Y  D EN1^ORCFLAG(+$P($G(^PS(52.41,ORD,0)),"^")) H 1
"RTN","PSOORNEW",85,0)
 . D FULL^VALM1
"RTN","PSOORNEW",86,0)
 . I '$D(^XUSEC("PSORPH",DUZ)) D  S Y=0 Q
"RTN","PSOORNEW",87,0)
 . . S DIR("A",1)="Order must be unflagged by a pharmacist before it can be finished."
"RTN","PSOORNEW",88,0)
 . . S DIR("A",2)=""
"RTN","PSOORNEW",89,0)
 . . S DIR(0)="E",DIR("A")="Enter RETURN to continue" W !,$C(7) D ^DIR
"RTN","PSOORNEW",90,0)
 . . S VALMBCK="R"
"RTN","PSOORNEW",91,0)
 . D KV
"RTN","PSOORNEW",92,0)
 . S DIR("A",1)="This Order is flagged. In order to finish it"
"RTN","PSOORNEW",93,0)
 . S DIR("A",2)="you must unflag it first."
"RTN","PSOORNEW",94,0)
 . S DIR("A",3)=""
"RTN","PSOORNEW",95,0)
 . S DIR(0)="Y",DIR("A")="Unflag Order",DIR("B")="NO"
"RTN","PSOORNEW",96,0)
 . W ! D ^DIR I $D(DIRUT)!'Y S VALMBCK="Q"
"RTN","PSOORNEW",97,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 Q
"RTN","PSOORNEW",98,0)
 ;
"RTN","PSOORNEW",99,0)
 I $D(CLOZPAT),+$G(PSONEW("QTY"))=0 S VALMSG="Unable to calculate the quantity, enter a quantity" G DSPL
"RTN","PSOORNEW",100,0)
 S (PSODIR("DFLG"),PSORX("DFLG"),PSODIR("QFLD"))=0,ACP=1 D ORCHK
"RTN","PSOORNEW",101,0)
 G:$G(PSONEW("QFLG")) DSPL
"RTN","PSOORNEW",102,0)
 I $G(PSODIR("DFLG"))!$G(PSORX("DFLG")) Q
"RTN","PSOORNEW",103,0)
 I $G(PSONEW("FLD"))!($G(PSODRUG("NAME"))']"")!('$O(SIG(0))) G DSPL
"RTN","PSOORNEW",104,0)
 I $G(PSODRUG("NAME"))]"",'$G(ORCHK)!($G(ORDRG)'=PSODRUG("NAME")) D  I $G(PSORX("DFLG")) D CLEAN^PSOVER1 G DSPL
"RTN","PSOORNEW",105,0)
 . D POST^PSODRG S:'$G(PSORX("DFLG")) ORCHK=1,ORDRG=PSODRUG("NAME")
"RTN","PSOORNEW",106,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("N") I $G(PSORX("DFLG")) G DSPL
"RTN","PSOORNEW",107,0)
 I '$D(PSONEW("RX #")) S PSOFROM="NEW",RTN=$S($P($G(PSOPAR),"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN") D @RTN Q:PSONEW("QFLG")  I '$P($G(PSOPAR),"^",7) S PSOX=PSONEW("RX #") D CHECK^PSONRXN
"RTN","PSOORNEW",108,0)
 D RXNCHK^PSOORNE1 I $G(PSONEW("QFLG")) S PSONEW("DFLG")=1 Q
"RTN","PSOORNEW",109,0)
 I DT>$$FMADD^XLFDT($P(OR0,"^",6),365) D EXPR^PSONEW2 G DSPL
"RTN","PSOORNEW",110,0)
 D STOP^PSONEW2,DISPLAY^PSONEW2,^PSONEWF
"RTN","PSOORNEW",111,0)
 I $G(PSOCPZ("DFLG")) W !!,"No action taken!",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR,KV K PSOCPZ("DFLG"),DRET,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",112,0)
 ;
"RTN","PSOORNEW",113,0)
 K PSOCPZ("DFLG") D KV S DIR(0)="Y",DIR("A")="Are you sure you want to Accept this Order",DIR("B")="NO" D ^DIR I $D(DIRUT) D KV K DRET,PSOANSQ,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",114,0)
 D KV I 'Y K PSOANSQ G DSPL
"RTN","PSOORNEW",115,0)
 I $G(PSONEW("MAIL/WINDOW"))["W" D:$P($G(PSOPAR),"^",12)  S BINGCRT="Y",BINGRTE="W",PSORX("MAIL/WINDOW")="WINDOW" K RTN
"RTN","PSOORNEW",116,0)
 .W ! K DIR,DIRUT S DIR(0)="52,35O"
"RTN","PSOORNEW",117,0)
 .S:$G(PSORX("METHOD OF PICK-UP"))]"" DIR("B")=PSORX("METHOD OF PICK-UP") D ^DIR I $D(DIRUT) K DIR,DIRUT Q
"RTN","PSOORNEW",118,0)
 .S (PSONEW("METHOD OF PICK-UP"),PSORX("METHOD OF PICK-UP"))=Y K X,Y
"RTN","PSOORNEW",119,0)
 S PSONEW("POE")=1 D EN^PSON52(.PSONEW) G:$G(PSONEW("DFLG")) ABORT D DCORD^PSONEW2 D:$G(PKI)=89802020 ALERT^PSOPKIV1
"RTN","PSOORNEW",120,0)
 ; - Possible Titration Rx?
"RTN","PSOORNEW",121,0)
 I $G(PSONEW("IRXN")) D MARK^PSOOTMRX(PSONEW("IRXN"),0)
"RTN","PSOORNEW",122,0)
 ;saves drug allergy order chks pso*7*390
"RTN","PSOORNEW",123,0)
 I +$G(^TMP("PSODAOC",$J,1,0)) D
"RTN","PSOORNEW",124,0)
 .I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSOORNEW",125,0)
 .S RXN=PSONEW("IRXN"),PSODAOC="Finished CPRS Rx "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"Order Acceptance_OP"
"RTN","PSOORNEW",126,0)
 .D DAOC^PSONEW
"RTN","PSOORNEW",127,0)
 D NPSOSD^PSOUTIL(.PSONEW),FULL^VALM1 K PSORX("MAIL/WINDOW")
"RTN","PSOORNEW",128,0)
 D EOJ^PSONEW
"RTN","PSOORNEW",129,0)
ABORT S VALMBCK="Q",DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR,CLEAN^PSOVER1,KV
"RTN","PSOORNEW",130,0)
 Q
"RTN","PSOORNEW",131,0)
KV K DIRUT,DUOUT,DTOUT,DIR,PSOEDDOS
"RTN","PSOORNEW",132,0)
 Q
"RTN","PSOORNEW",133,0)
REF D REF^PSOORFI4
"RTN","PSOORNEW",134,0)
 Q
"RTN","PSOORNEW",135,0)
1 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",136,0)
 . W !!,"Digitally Signed Order - Orderable Item cannot be changed",! D PZ
"RTN","PSOORNEW",137,0)
 N PSOBDR,PSOBDRG S PSOBDRG=1 D 1^PSOORNW2 Q  ;oi
"RTN","PSOORNEW",138,0)
 ;
"RTN","PSOORNEW",139,0)
4 D INS^PSOORNW2 Q
"RTN","PSOORNEW",140,0)
 ;
"RTN","PSOORNEW",141,0)
3 I $G(LST)["3,",$P(OR0,"^",24) D  Q 
"RTN","PSOORNEW",142,0)
 . W !!,"Digitally Signed Order - Dose cannot be changed",! D PZ
"RTN","PSOORNEW",143,0)
 N PSOEDDOS S PSOEDDOS=1 D DOSE^PSOORED4(.PSONEW) Q
"RTN","PSOORNEW",144,0)
 ;
"RTN","PSOORNEW",145,0)
6 D 4^PSOORNW2 Q  ;idt
"RTN","PSOORNEW",146,0)
 ;
"RTN","PSOORNEW",147,0)
7 D 5^PSOORNW2 Q  ;fdt
"RTN","PSOORNEW",148,0)
 ;
"RTN","PSOORNEW",149,0)
5 D 3^PSOORNW2 Q  ;pstat
"RTN","PSOORNEW",150,0)
 ;
"RTN","PSOORNEW",151,0)
13 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",152,0)
 . W !!,"Digitally Signed Order - Provider cannot be changed",! D PZ
"RTN","PSOORNEW",153,0)
 D 12^PSOORNW2 Q  ;doc
"RTN","PSOORNEW",154,0)
 ;
"RTN","PSOORNEW",155,0)
12 D 11^PSOORNW2 Q  ;cli
"RTN","PSOORNEW",156,0)
 ;
"RTN","PSOORNEW",157,0)
2 N PSOCSIG I '$G(PSOBDRG) N PSOBDR,PSOBDRG S PSOBDRG=1,PSOQFLG=0
"RTN","PSOORNEW",158,0)
 N CPRN S CPRN=+$P($G(OR0),"^",24) D 2^PSOORNW1 Q:$G(PSOQFLG)  D EN^PSODIAG  ;drg/ICD
"RTN","PSOORNEW",159,0)
 I $G(PSOCSIG) K PSOCSIG G 3
"RTN","PSOORNEW",160,0)
 Q
"RTN","PSOORNEW",161,0)
 ;
"RTN","PSOORNEW",162,0)
9 D 8^PSOORNW2 Q  ;qty
"RTN","PSOORNEW",163,0)
 ;
"RTN","PSOORNEW",164,0)
8 N CPRN S CPRN=+$P($G(OR0),"^",24) D 7^PSOORNW2 Q  ;ds
"RTN","PSOORNEW",165,0)
 ;
"RTN","PSOORNEW",166,0)
10 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",167,0)
 . W !!,"Digitally Signed Order - Refills cannot be changed",! D PZ
"RTN","PSOORNEW",168,0)
 D 9^PSOORNW2 Q  ;#rfs
"RTN","PSOORNEW",169,0)
 ;
"RTN","PSOORNEW",170,0)
14 D 13^PSOORNW2 Q  ;cop
"RTN","PSOORNEW",171,0)
 ;
"RTN","PSOORNEW",172,0)
11 D 10^PSOORNW2 Q  ;m/w
"RTN","PSOORNEW",173,0)
 ;
"RTN","PSOORNEW",174,0)
15 D 14^PSOORNW2 Q  ;rem
"RTN","PSOORNEW",175,0)
 ;
"RTN","PSOORNEW",176,0)
DRGMSG ;
"RTN","PSOORNEW",177,0)
 F SG=1:1:$L($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",178,0)
 .S:$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)
"RTN","PSOORNEW",179,0)
 K SG
"RTN","PSOORNEW",180,0)
 Q
"RTN","PSOORNEW",181,0)
 ;
"RTN","PSOORNEW",182,0)
PZ ;
"RTN","PSOORNEW",183,0)
 N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOORNEW",184,0)
 Q
"UP",52,52.0725,-1)
52^NDUC
"UP",52,52.0725,0)
52.0725
"UP",52,52.7252,-2)
52^NDUC
"UP",52,52.7252,-1)
52.0725^1
"UP",52,52.7252,0)
52.7252
"UP",52,52.72521,-3)
52^NDUC
"UP",52,52.72521,-2)
52.0725^1
"UP",52,52.72521,-1)
52.7252^1
"UP",52,52.72521,0)
52.72521
"UP",52,52.72522,-3)
52^NDUC
"UP",52,52.72522,-2)
52.0725^1
"UP",52,52.72522,-1)
52.7252^2
"UP",52,52.72522,0)
52.72522
"UP",52,52.7253,-2)
52^NDUC
"UP",52,52.7253,-1)
52.0725^2
"UP",52,52.7253,0)
52.7253
"UP",52,52.7254,-2)
52^NDUC
"UP",52,52.7254,-1)
52.0725^3
"UP",52,52.7254,0)
52.7254
"VER")
8.0^22.0
"^DD",52,52,725,0)
NATIONAL DATA UTILITY CLEANUP^52.0725DA^^NDUC;0
"^DD",52,52,725,21,0)
^.001^13^13^3140219^^
"^DD",52,52,725,21,1,0)
This NATIONAL DATA UTILITY CLEANUP multiple is defined to store 
"^DD",52,52,725,21,2,0)
modifications to a prescription for Dosage and SIG as a result of a
"^DD",52,52,725,21,3,0)
background clean-up utility.  It can be used by other projects in the
"^DD",52,52,725,21,4,0)
future.
"^DD",52,52,725,21,5,0)
 
"^DD",52,52,725,21,6,0)
For its first use, Outpatient Pharmacy patch PSO*7*433 and Computerized
"^DD",52,52,725,21,7,0)
Patient Record System (CPRS) Patch OR*3*378 addresses reported problems
"^DD",52,52,725,21,8,0)
where the Drug Name and/or the date in VA FileMan format can mistakenly
"^DD",52,52,725,21,9,0)
appear in the Dosage and Sig fields of an entry in PRESCRIPTION file
"^DD",52,52,725,21,10,0)
(#52).  The NATIONAL DATA UTILITY CLEANUP fields will only be defined when
"^DD",52,52,725,21,11,0)
corrections to the Dosage and Sig fields are completed or attempted.  For
"^DD",52,52,725,21,12,0)
those prescriptions where a correction was unsuccessful, an error or
"^DD",52,52,725,21,13,0)
comment will be stored in COMMENTS field (#5).
"^DD",52,52,725,23,0)
^.001^4^4^3140219^^^^
"^DD",52,52,725,23,1,0)
In Pharmacy the invalid data will first be removed from the appropriate
"^DD",52,52,725,23,2,0)
Dosage fields, and after that the Sig will be rebuilt. The old and new 
"^DD",52,52,725,23,3,0)
values will be stored in the associated fields within NATIONAL DATA 
"^DD",52,52,725,23,4,0)
UTILITY CLEANUP fields.
"^DD",52,52.0725,0)
NATIONAL DATA UTILITY CLEANUP SUB-FIELD^^5^6
"^DD",52,52.0725,0,"DIK")
PSOXZA
"^DD",52,52.0725,0,"DT")
3131114
"^DD",52,52.0725,0,"IX","B",52.0725,.01)

"^DD",52,52.0725,0,"NM","NATIONAL DATA UTILITY CLEANUP")

"^DD",52,52.0725,0,"UP")
52
"^DD",52,52.0725,.01,0)
DATE/TIME OF ACTIVITY^MD^^0;1^S %DT="ETX" D ^%DT S X=Y K:Y<1 X
"^DD",52,52.0725,.01,1,0)
^.1
"^DD",52,52.0725,.01,1,1,0)
52.0725^B
"^DD",52,52.0725,.01,1,1,1)
S ^PSRX(DA(1),"NDUC","B",$E(X,1,30),DA)=""
"^DD",52,52.0725,.01,1,1,2)
K ^PSRX(DA(1),"NDUC","B",$E(X,1,30),DA)
"^DD",52,52.0725,.01,3)
Enter the date/time that the National Data Utility Clean-up is initiated. 
"^DD",52,52.0725,.01,21,0)
^^2^2^3131113^
"^DD",52,52.0725,.01,21,1,0)
This field contains the date and time the prescription is updated by
"^DD",52,52.0725,.01,21,2,0)
the NATIONAL DATA UTILITY CLEAN-UP.
"^DD",52,52.0725,.01,"DT")
3131112
"^DD",52,52.0725,1,0)
INITIATED BY^F^^0;2^K:$L(X)>60!($L(X)<1) X
"^DD",52,52.0725,1,3)
Answer must be 1-60 characters indicating the process making the change.
"^DD",52,52.0725,1,21,0)
^.001^2^2^3131114^^^
"^DD",52,52.0725,1,21,1,0)
This field contains the process that initiated the changes for the Dosage
"^DD",52,52.0725,1,21,2,0)
and Sig fields.
"^DD",52,52.0725,1,23,0)
^^2^2^3131114^
"^DD",52,52.0725,1,23,1,0)
For the National Data Utility Cleanup process this field contains:
"^DD",52,52.0725,1,23,2,0)
National Clean-Up Utility - Patches OR*3*378 and PSO*7*433
"^DD",52,52.0725,1,"DT")
3131114
"^DD",52,52.0725,2,0)
CHANGED DOSAGE^52.7252^^1;0
"^DD",52,52.0725,2,21,0)
^.001^2^2^3131113^^^^
"^DD",52,52.0725,2,21,1,0)
The original and modified dosage text for each dosage sequence being 
"^DD",52,52.0725,2,21,2,0)
modified is stored in this multiple.
"^DD",52,52.0725,2,"DT")
3131107
"^DD",52,52.0725,3,0)
OLD SIG^52.7253^^2;0
"^DD",52,52.0725,3,21,0)
^.001^10^10^3131113^^^
"^DD",52,52.0725,3,21,1,0)
This field contains the original SIG text for the prescription.  The 
"^DD",52,52.0725,3,21,2,0)
following are examples of invalid data:
"^DD",52,52.0725,3,21,3,0)
 
"^DD",52,52.0725,3,21,4,0)
     1. TAKE 1 CAPSULE 20140402 BY MOUTH
"^DD",52,52.0725,3,21,5,0)
          EVERY 6 HOURS
"^DD",52,52.0725,3,21,6,0)
     2. TAKE 1 TABLET ACETAMINOPHEN 
"^DD",52,52.0725,3,21,7,0)
          325MG/OXYCODONE 5MG TABS 
"^DD",52,52.0725,3,21,8,0)
          ACETAMINOPHEN 325MG/OXYCODONE 5MG
"^DD",52,52.0725,3,21,9,0)
          TABS BY MOUTH EVERY 6 HOURS AS 
"^DD",52,52.0725,3,21,10,0)
          NEEDED
"^DD",52,52.0725,4,0)
NEW SIG^52.7254^^3;0
"^DD",52,52.0725,4,21,0)
^.001^11^11^3140219^^
"^DD",52,52.0725,4,21,1,0)
This field contains the modified Sig text after the removal of invalid 
"^DD",52,52.0725,4,21,2,0)
data. 
"^DD",52,52.0725,4,21,3,0)
 
"^DD",52,52.0725,4,21,4,0)
Using the examples shown under the OLD SIG field (#3), below are
"^DD",52,52.0725,4,21,5,0)
examples of the corrected SIGs:
"^DD",52,52.0725,4,21,6,0)
 
"^DD",52,52.0725,4,21,7,0)
     1. TAKE 1 CAPSULE BY MOUTH EVERY
"^DD",52,52.0725,4,21,8,0)
           6 HOURS
"^DD",52,52.0725,4,21,9,0)
 
"^DD",52,52.0725,4,21,10,0)
     2. TAKE 1 TABLET BY MOUTH EVERY
"^DD",52,52.0725,4,21,11,0)
           6 HOURS AS NEEDED
"^DD",52,52.0725,5,0)
COMMENT^F^^4;1^K:$L(X)>75!($L(X)<1) X
"^DD",52,52.0725,5,3)
If the dose sequence cannot be corrected, enter a reason or error message (1-75 characters).
"^DD",52,52.0725,5,21,0)
^.001^3^3^3131113^^^^
"^DD",52,52.0725,5,21,1,0)
This field contains comments or errors generated during processing such
"^DD",52,52.0725,5,21,2,0)
as:  the record was locked or the clean-up process cannot make
"^DD",52,52.0725,5,21,3,0)
corrections.
"^DD",52,52.0725,5,"DT")
3131107
"^DD",52,52.7252,0)
CHANGED DOSAGE SUB-FIELD^^2^3
"^DD",52,52.7252,0,"DT")
3131108
"^DD",52,52.7252,0,"NM","CHANGED DOSAGE")

"^DD",52,52.7252,0,"UP")
52.0725
"^DD",52,52.7252,.01,0)
DOSE SEQUENCE^NJ2,0^^0;1^K:+X'=X!(X>99)!(X<1)!(X?.E1"."1N.N) X
"^DD",52,52.7252,.01,3)
Enter the dose sequence which can be a number from 1-99.
"^DD",52,52.7252,.01,21,0)
^.001^3^3^3131113^^^^
"^DD",52,52.7252,.01,21,1,0)
This field indicates the dosage sequence that has been modified.  For 
"^DD",52,52.7252,.01,21,2,0)
simple orders, the dosage sequence is 1.  For complex orders, it is
"^DD",52,52.7252,.01,21,3,0)
the individual dose sequence and can be 1-99.
"^DD",52,52.7252,.01,"DT")
3131108
"^DD",52,52.7252,1,0)
OLD DOSAGE^52.72521^^1;0
"^DD",52,52.7252,1,21,0)
^.001^12^12^3131113^^
"^DD",52,52.7252,1,21,1,0)
This field contains the old dosage text.
"^DD",52,52.7252,1,21,2,0)
 
"^DD",52,52.7252,1,21,3,0)
Below are examples of invalid data in the Dosage field.  The first 
"^DD",52,52.7252,1,21,4,0)
example shows a FileMan date of 20140402 added to the dosage text and the 
"^DD",52,52.7252,1,21,5,0)
second example show the drug name appended twice to the dosage.
"^DD",52,52.7252,1,21,6,0)
Dosage:
"^DD",52,52.7252,1,21,7,0)
 
"^DD",52,52.7252,1,21,8,0)
     1.  1 CAPSULE 20140402
"^DD",52,52.7252,1,21,9,0)
     2.  1 TABLET ACETAMINOPHEN 
"^DD",52,52.7252,1,21,10,0)
            325MG/OXYCODONE 5MG TABS
"^DD",52,52.7252,1,21,11,0)
            ACETAMINOPHEN 325MG/OXYCODONE
"^DD",52,52.7252,1,21,12,0)
            5MG TABS
"^DD",52,52.7252,1,"DT")
3131113
"^DD",52,52.7252,2,0)
NEW DOSAGE^52.72522^^2;0
"^DD",52,52.7252,2,21,0)
^^7^7^3131113^
"^DD",52,52.7252,2,21,1,0)
This field contains the new dosage text.  
"^DD",52,52.7252,2,21,2,0)
 
"^DD",52,52.7252,2,21,3,0)
Using the examples shown in the OLD DOSAGE field (#1), the following is an
"^DD",52,52.7252,2,21,4,0)
example of the modified text stored by the cleanup process:
"^DD",52,52.7252,2,21,5,0)
 
"^DD",52,52.7252,2,21,6,0)
     1.  1 CAPSULE 
"^DD",52,52.7252,2,21,7,0)
     2.  1 TABLET
"^DD",52,52.7252,2,"DT")
3131113
"^DD",52,52.72521,0)
OLD DOSAGE SUB-FIELD^^.01^1
"^DD",52,52.72521,0,"DT")
3131107
"^DD",52,52.72521,0,"NM","OLD DOSAGE")

"^DD",52,52.72521,0,"UP")
52.7252
"^DD",52,52.72521,.01,0)
DOSAGE TEXT^W^^0;1^Q
"^DD",52,52.72521,.01,3)
Enter the original dosage text.
"^DD",52,52.72521,.01,"DT")
3131107
"^DD",52,52.72522,0)
NEW DOSAGE SUB-FIELD^^.01^1
"^DD",52,52.72522,0,"DT")
3131107
"^DD",52,52.72522,0,"NM","NEW DOSAGE")

"^DD",52,52.72522,0,"UP")
52.7252
"^DD",52,52.72522,.01,0)
NEW VALUE^Wx^^0;1^Q
"^DD",52,52.72522,.01,3)
Enter the new dosage text.
"^DD",52,52.72522,.01,"DT")
3131107
"^DD",52,52.7253,0)
OLD SIG SUB-FIELD^^.01^1
"^DD",52,52.7253,0,"DT")
3131107
"^DD",52,52.7253,0,"NM","OLD SIG")

"^DD",52,52.7253,0,"UP")
52.0725
"^DD",52,52.7253,.01,0)
OLD SIG^Wx^^0;1^Q
"^DD",52,52.7253,.01,3)
Enter the original SIG value.
"^DD",52,52.7253,.01,"DT")
3131107
"^DD",52,52.7254,0)
NEW SIG SUB-FIELD^^.01^1
"^DD",52,52.7254,0,"DT")
3131107
"^DD",52,52.7254,0,"NM","NEW SIG")

"^DD",52,52.7254,0,"UP")
52.0725
"^DD",52,52.7254,.01,0)
NEW SIG^Wx^^0;1^Q
"^DD",52,52.7254,.01,3)
Enter the new SIG value.
"^DD",52,52.7254,.01,"DT")
3131107
**END**
**END**
