Released YS*5.01*129 SEQ #101
Extracted from mail message
**KIDS**:YS*5.01*129^

**INSTALL NAME**
YS*5.01*129
"BLD",9463,0)
YS*5.01*129^MENTAL HEALTH^0^3170814^y
"BLD",9463,1,0)
^^21^21^3170515^
"BLD",9463,1,1,0)
See the patch description for more detailed information.  This build
"BLD",9463,1,2,0)
makes the following changes for the Mental Health Assistant (MHA).
"BLD",9463,1,3,0)
 
"BLD",9463,1,4,0)
The Two Factor Authentication is implemented.
"BLD",9463,1,5,0)
 
"BLD",9463,1,6,0)
The Global Assessment of Functioning Manager (GAF) functionality is 
"BLD",9463,1,7,0)
removed.
"BLD",9463,1,8,0)
 
"BLD",9463,1,9,0)
Modifications were made to the Delphi code to migrate MHA from Delphi 7 
"BLD",9463,1,10,0)
to XE8.
"BLD",9463,1,11,0)
  
"BLD",9463,1,12,0)
The following tests were retired:  AUIR, CESD5, DOM80, DOMG, ERS, HLOC,
"BLD",9463,1,13,0)
IEQ, RLOC, SAI, SDES, SMAST, VALD, WAS.
"BLD",9463,1,14,0)
 
"BLD",9463,1,15,0)
Data validation was implemented for the Instrument Date of Administration 
"BLD",9463,1,16,0)
to prevent dates more than 1 year in the past from being entered.
"BLD",9463,1,17,0)
 
"BLD",9463,1,18,0)
The PCL-5 was modified so that it can be used on the Special Results tab 
"BLD",9463,1,19,0)
in the Instrument Results module.
"BLD",9463,1,20,0)
 
"BLD",9463,1,21,0)
Several deficiencies and Remedy tickets were addressed.
"BLD",9463,4,0)
^9.64PA^^
"BLD",9463,6.3)
12
"BLD",9463,"ABPKG")
n
"BLD",9463,"INID")
^n
"BLD",9463,"INIT")
POST^YS129PST
"BLD",9463,"KRN",0)
^9.67PA^779.2^20
"BLD",9463,"KRN",.4,0)
.4
"BLD",9463,"KRN",.401,0)
.401
"BLD",9463,"KRN",.402,0)
.402
"BLD",9463,"KRN",.403,0)
.403
"BLD",9463,"KRN",.5,0)
.5
"BLD",9463,"KRN",.84,0)
.84
"BLD",9463,"KRN",3.6,0)
3.6
"BLD",9463,"KRN",3.8,0)
3.8
"BLD",9463,"KRN",9.2,0)
9.2
"BLD",9463,"KRN",9.8,0)
9.8
"BLD",9463,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",9463,"KRN",9.8,"NM",1,0)
YTQAPI7^^0^B23570402
"BLD",9463,"KRN",9.8,"NM","B","YTQAPI7",1)

"BLD",9463,"KRN",19,0)
19
"BLD",9463,"KRN",19,"NM",0)
^9.68A^4^3
"BLD",9463,"KRN",19,"NM",2,0)
YSGAF CLINIC ENTRY^^0
"BLD",9463,"KRN",19,"NM",3,0)
YSGAF SINGLE PT^^0
"BLD",9463,"KRN",19,"NM",4,0)
YSGAF ERROR^^0
"BLD",9463,"KRN",19,"NM","B","YSGAF CLINIC ENTRY",2)

"BLD",9463,"KRN",19,"NM","B","YSGAF ERROR",4)

"BLD",9463,"KRN",19,"NM","B","YSGAF SINGLE PT",3)

"BLD",9463,"KRN",19.1,0)
19.1
"BLD",9463,"KRN",101,0)
101
"BLD",9463,"KRN",409.61,0)
409.61
"BLD",9463,"KRN",771,0)
771
"BLD",9463,"KRN",779.2,0)
779.2
"BLD",9463,"KRN",870,0)
870
"BLD",9463,"KRN",8989.51,0)
8989.51
"BLD",9463,"KRN",8989.51,"NM",0)
^9.68A^1^1
"BLD",9463,"KRN",8989.51,"NM",1,0)
YS MHA_AUX DLL LOCATION^^0
"BLD",9463,"KRN",8989.51,"NM","B","YS MHA_AUX DLL LOCATION",1)

"BLD",9463,"KRN",8989.52,0)
8989.52
"BLD",9463,"KRN",8994,0)
8994
"BLD",9463,"KRN","B",.4,.4)

"BLD",9463,"KRN","B",.401,.401)

"BLD",9463,"KRN","B",.402,.402)

"BLD",9463,"KRN","B",.403,.403)

"BLD",9463,"KRN","B",.5,.5)

"BLD",9463,"KRN","B",.84,.84)

"BLD",9463,"KRN","B",3.6,3.6)

"BLD",9463,"KRN","B",3.8,3.8)

"BLD",9463,"KRN","B",9.2,9.2)

"BLD",9463,"KRN","B",9.8,9.8)

"BLD",9463,"KRN","B",19,19)

"BLD",9463,"KRN","B",19.1,19.1)

"BLD",9463,"KRN","B",101,101)

"BLD",9463,"KRN","B",409.61,409.61)

"BLD",9463,"KRN","B",771,771)

"BLD",9463,"KRN","B",779.2,779.2)

"BLD",9463,"KRN","B",870,870)

"BLD",9463,"KRN","B",8989.51,8989.51)

"BLD",9463,"KRN","B",8989.52,8989.52)

"BLD",9463,"KRN","B",8994,8994)

"BLD",9463,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9463,"QUES",0)
^9.62^^
"BLD",9463,"REQB",0)
^9.611^1^1
"BLD",9463,"REQB",1,0)
YS*5.01*119^1
"BLD",9463,"REQB","B","YS*5.01*119",1)

"INIT")
POST^YS129PST
"KRN",19,10609,-1)
0^3
"KRN",19,10609,0)
YSGAF SINGLE PT^Single Patient GAF Entry^discontinued^R^^^^^^^^
"KRN",19,10609,1,0)
^^1^1^2970927^^
"KRN",19,10609,1,1,0)
Enter a GAF (DSM Axis 5) for a patient.
"KRN",19,10609,25)
PTENT^YSGAF
"KRN",19,10609,"U")
SINGLE PATIENT GAF ENTRY
"KRN",19,10610,-1)
0^2
"KRN",19,10610,0)
YSGAF CLINIC ENTRY^Enter GAF by Clinic Visit^discontinued^R^^^^^^^^
"KRN",19,10610,1,0)
^^3^3^2970925^^
"KRN",19,10610,1,1,0)
Each patient having an outpatient visit in a specified location will
"KRN",19,10610,1,2,0)
be presented for GAF entry. Those with recent GAF scores may optionally
"KRN",19,10610,1,3,0)
be filtered out.
"KRN",19,10610,25)
CLENT^YSGAF
"KRN",19,10610,"U")
ENTER GAF BY CLINIC VISIT
"KRN",19,10613,-1)
0^4
"KRN",19,10613,0)
YSGAF ERROR^Edit/mark errors on GAF^discontinued^R^^^^^^^^
"KRN",19,10613,1,0)
^^3^3^2971107^^
"KRN",19,10613,1,1,0)
Allows the clinican who made the GAF diagnosis to edit it if within
"KRN",19,10613,1,2,0)
48 hours or to mark it as an error if diagnosis was made more than 48
"KRN",19,10613,1,3,0)
hours ago.
"KRN",19,10613,25)
EDENT^YSGAF2
"KRN",19,10613,"U")
EDIT/MARK ERRORS ON GAF
"KRN",8989.5,14711,0)
166;DIC(9.4,^YS MHA_AUX DLL LOCATION^1
"KRN",8989.5,14711,1)
\Vista\Common Files\YS_MHA_AUX.dll
"KRN",8989.51,819,-1)
0^1
"KRN",8989.51,819,0)
YS MHA_AUX DLL LOCATION^YS_MHA_AUX path and name^0^^AUX DLL^0
"KRN",8989.51,819,1)
F^^Specify the path and name for the YS_MHA_AUX dll.
"KRN",8989.51,819,2)
I X["/" K X W "  Use "\" for path",!
"KRN",8989.51,819,20,0)
^8989.512^20^20^3170807^^
"KRN",8989.51,819,20,1,0)
This parameter allow you to specify a name and location for the Mental
"KRN",8989.51,819,20,2,0)
Health Assistant AUX DLL.  There is no need to use this parameter if the
"KRN",8989.51,819,20,3,0)
AUX DLL is in the default location.  The default location is:
"KRN",8989.51,819,20,4,0)
 
"KRN",8989.51,819,20,5,0)
  %PROGRAMFILES%\Vista\Common Files\YS_MHA_AUX.dll
"KRN",8989.51,819,20,6,0)
 
"KRN",8989.51,819,20,7,0)
If you wish to specify a different location, or use a different name for 
"KRN",8989.51,819,20,8,0)
the DLL, you may specify it in this parameter.  For example, to specify 
"KRN",8989.51,819,20,9,0)
network drive "G:" in the Shared directory, you might enter something 
"KRN",8989.51,819,20,10,0)
like this:
"KRN",8989.51,819,20,11,0)
 
"KRN",8989.51,819,20,12,0)
  AUX DLL: G:\Shared\YS_MHA_AUX.dll
"KRN",8989.51,819,20,13,0)
 
"KRN",8989.51,819,20,14,0)
If you wish to specify a location relative to %PROGRAMFILES%, begin the 
"KRN",8989.51,819,20,15,0)
entry with a single "\".  For example, using a different directory and
"KRN",8989.51,819,20,16,0)
name, but  remaining in "C:\Program Files (x86)":
"KRN",8989.51,819,20,17,0)
 
"KRN",8989.51,819,20,18,0)
  AUX DLL: \Vista\TestMHA\YS_MHA_AUX_new.dll
"KRN",8989.51,819,20,19,0)
 
"KRN",8989.51,819,20,20,0)
Remember to use "\" and not "/" in the directory path.
"KRN",8989.51,819,30,0)
^8989.513I^4^4
"KRN",8989.51,819,30,1,0)
10^9.4
"KRN",8989.51,819,30,2,0)
8^4.2
"KRN",8989.51,819,30,3,0)
5^4
"KRN",8989.51,819,30,4,0)
2^200
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"ORD",20,8989.51)
8989.51;20;;;PAR1E1^XPDTA2;PAR1F1^XPDIA3;PAR1E1^XPDIA3;PAR1F2^XPDIA3;;PAR1DEL^XPDIA3(%)
"ORD",20,8989.51,0)
PARAMETER DEFINITION
"PKG",166,-1)
1^1
"PKG",166,0)
MENTAL HEALTH^YS^Version 5.01 of Mental Health
"PKG",166,20,0)
^9.402P^^
"PKG",166,22,0)
^9.49I^1^1
"PKG",166,22,1,0)
5.01^2941230^2950310
"PKG",166,22,1,"PAH",1,0)
129^3170814
"PKG",166,22,1,"PAH",1,1,0)
^^21^21^3170814
"PKG",166,22,1,"PAH",1,1,1,0)
See the patch description for more detailed information.  This build
"PKG",166,22,1,"PAH",1,1,2,0)
makes the following changes for the Mental Health Assistant (MHA).
"PKG",166,22,1,"PAH",1,1,3,0)
 
"PKG",166,22,1,"PAH",1,1,4,0)
The Two Factor Authentication is implemented.
"PKG",166,22,1,"PAH",1,1,5,0)
 
"PKG",166,22,1,"PAH",1,1,6,0)
The Global Assessment of Functioning Manager (GAF) functionality is 
"PKG",166,22,1,"PAH",1,1,7,0)
removed.
"PKG",166,22,1,"PAH",1,1,8,0)
 
"PKG",166,22,1,"PAH",1,1,9,0)
Modifications were made to the Delphi code to migrate MHA from Delphi 7 
"PKG",166,22,1,"PAH",1,1,10,0)
to XE8.
"PKG",166,22,1,"PAH",1,1,11,0)
  
"PKG",166,22,1,"PAH",1,1,12,0)
The following tests were retired:  AUIR, CESD5, DOM80, DOMG, ERS, HLOC,
"PKG",166,22,1,"PAH",1,1,13,0)
IEQ, RLOC, SAI, SDES, SMAST, VALD, WAS.
"PKG",166,22,1,"PAH",1,1,14,0)
 
"PKG",166,22,1,"PAH",1,1,15,0)
Data validation was implemented for the Instrument Date of Administration 
"PKG",166,22,1,"PAH",1,1,16,0)
to prevent dates more than 1 year in the past from being entered.
"PKG",166,22,1,"PAH",1,1,17,0)
 
"PKG",166,22,1,"PAH",1,1,18,0)
The PCL-5 was modified so that it can be used on the Special Results tab 
"PKG",166,22,1,"PAH",1,1,19,0)
in the Instrument Results module.
"PKG",166,22,1,"PAH",1,1,20,0)
 
"PKG",166,22,1,"PAH",1,1,21,0)
Several deficiencies and Remedy tickets were addressed.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","YS129PST")
0^^B10659983^n/a
"RTN","YS129PST",1,0)
YS129PST ;SLC/LLH - Patch 129 post-init ; 03/20/2017
"RTN","YS129PST",2,0)
 ;;5.01;MENTAL HEALTH;**129**;Dec 30, 1994;Build 12
"RTN","YS129PST",3,0)
 ;
"RTN","YS129PST",4,0)
 ; This patch moves 13 instruments to "dropped" and updates the Scale Group name for 2 instruments
"RTN","YS129PST",5,0)
 ; so charting works better (there were additional Scale Group updates but those instruments are in patch 121)
"RTN","YS129PST",6,0)
 Q
"RTN","YS129PST",7,0)
 ;
"RTN","YS129PST",8,0)
 ;
"RTN","YS129PST",9,0)
EDTDATE ; date used to update 601.71:18
"RTN","YS129PST",10,0)
 ;;3170322.1321
"RTN","YS129PST",11,0)
 Q
"RTN","YS129PST",12,0)
 ;  
"RTN","YS129PST",13,0)
POST ; Post-init calls for patch 129
"RTN","YS129PST",14,0)
 N NM
"RTN","YS129PST",15,0)
 D GETSG
"RTN","YS129PST",16,0)
 D ADDIDX ; add indices for CESD -- Center for Epidemiologic Studies Depression Scale
"RTN","YS129PST",17,0)
 D PHQ9CT ; switch choices in PHQ9 to be 0-3 instead of 1-4
"RTN","YS129PST",18,0)
 ; drop tests:  note CIWA-AR was in this list, can't do as CIWA-AR- not released
"RTN","YS129PST",19,0)
 F NM="AUIR","CESD5","DOM80","DOMG","ERS","HLOC" D DROPTST(NM)
"RTN","YS129PST",20,0)
 F NM="IEQ","RLOC","SAI","SDES","SMAST","VALD","WAS" D DROPTST(NM)
"RTN","YS129PST",21,0)
 D UPDVER^YTQAPI7(3,"1.0.3.72") ; set MHA client version
"RTN","YS129PST",22,0)
 Q
"RTN","YS129PST",23,0)
 ;
"RTN","YS129PST",24,0)
GETSG ; Update Scale Group name
"RTN","YS129PST",25,0)
 N IDX,SGIEN,SGNM,TSTIEN,TSTNM
"RTN","YS129PST",26,0)
 S IDX=0 F  S IDX=IDX+1,TSTNM=$P($T(TESTS+IDX),";;",2) Q:TSTNM="zzzzz"  D
"RTN","YS129PST",27,0)
 .S TSTIEN=$O(^YTT(601.71,"B",TSTNM,0)) Q:'TSTIEN
"RTN","YS129PST",28,0)
 .S SGIEN=$O(^YTT(601.86,"AD",TSTIEN,0)) Q:'SGIEN
"RTN","YS129PST",29,0)
 .S SGNM=$P($T(TESTS+IDX),";;",3)
"RTN","YS129PST",30,0)
 .D UPDSG(SGIEN,SGNM) ; update Scale Group Name
"RTN","YS129PST",31,0)
 Q
"RTN","YS129PST",32,0)
 ;
"RTN","YS129PST",33,0)
UPDSG(SGIEN,SGNM) ; update Scale Group Name
"RTN","YS129PST",34,0)
 N FDA,DIERR
"RTN","YS129PST",35,0)
 S FDA(601.86,SGIEN_",",2)=SGNM
"RTN","YS129PST",36,0)
 D FILE^DIE("","FDA")
"RTN","YS129PST",37,0)
 I $D(DIERR) D BMES^XPDUTL("ERROR: "_$G(^TMP("DIERR",$J,1,"TEXT",1)))
"RTN","YS129PST",38,0)
 D CLEAN^DILF
"RTN","YS129PST",39,0)
 Q
"RTN","YS129PST",40,0)
 ;
"RTN","YS129PST",41,0)
ADDIDX ; add indices for CESD 
"RTN","YS129PST",42,0)
 N TSTIEN,SGIEN
"RTN","YS129PST",43,0)
 S TSTIEN=$O(^YTT(601.71,"B","CESD",0))
"RTN","YS129PST",44,0)
 I 'TSTIEN D BMES^XPDUTL("ERROR: "_$G(^TMP("DIERR",$J,1,"TEXT",1))),CLEAN^DILF
"RTN","YS129PST",45,0)
 S SGIEN=$O(^YTT(601.86,"AD",TSTIEN,0))
"RTN","YS129PST",46,0)
 I 'SGIEN D BMES^XPDUTL("ERROR: "_$G(^TMP("DIERR",$J,1,"TEXT",1))),CLEAN^DILF
"RTN","YS129PST",47,0)
 S ^YTT(601.86,"B",SGIEN,SGIEN)=""
"RTN","YS129PST",48,0)
 S ^YTT(601.86,"AD",TSTIEN,SGIEN)=""
"RTN","YS129PST",49,0)
 S ^YTT(601.86,"AC",TSTIEN,1,SGIEN)=""
"RTN","YS129PST",50,0)
 Q
"RTN","YS129PST",51,0)
 ;
"RTN","YS129PST",52,0)
DROPTST(NAME) ; Change OPERATIONAL to dropped, update LAST EDIT DATE
"RTN","YS129PST",53,0)
 N IEN
"RTN","YS129PST",54,0)
 S IEN=$O(^YTT(601.71,"B",NAME,0)) Q:'IEN
"RTN","YS129PST",55,0)
 D FLD2DROP(IEN)
"RTN","YS129PST",56,0)
 Q
"RTN","YS129PST",57,0)
 ; 
"RTN","YS129PST",58,0)
FLD2DROP(IEN) ; update OPERATIONAL field to be "Dropped", LAST EDIT DATE
"RTN","YS129PST",59,0)
 N FDA,DIERR
"RTN","YS129PST",60,0)
 S FDA(601.71,IEN_",",10)="D"
"RTN","YS129PST",61,0)
 S FDA(601.71,IEN_",",18)=$P($T(EDTDATE+1),";;",2)
"RTN","YS129PST",62,0)
 D FILE^DIE("","FDA")
"RTN","YS129PST",63,0)
 I $D(DIERR) D MES^XPDUTL("ERROR: "_$G(^TMP("DIERR",$J,1,"TEXT",1)))
"RTN","YS129PST",64,0)
 D CLEAN^DILF
"RTN","YS129PST",65,0)
 Q
"RTN","YS129PST",66,0)
 ;
"RTN","YS129PST",67,0)
PHQ9CT ; update PHQ9 choice type
"RTN","YS129PST",68,0)
 N TEST,SEQ,CTNT,X0,X2,QSTN,CTYP,CID
"RTN","YS129PST",69,0)
 S TEST=$O(^YTT(601.71,"B","PHQ9",0))
"RTN","YS129PST",70,0)
 S SEQ=0 F  S SEQ=$O(^YTT(601.76,"AD",TEST,SEQ)) Q:'SEQ  D
"RTN","YS129PST",71,0)
 . S CTNT=0 F  S CTNT=$O(^YTT(601.76,"AD",TEST,SEQ,CTNT)) Q:'CTNT  D
"RTN","YS129PST",72,0)
 . . S X0=^YTT(601.76,CTNT,0),QSTN=$P(X0,U,4)
"RTN","YS129PST",73,0)
 . . S X2=^YTT(601.72,QSTN,2),CTYP=$P(X2,U,3)
"RTN","YS129PST",74,0)
 . . S CID=$O(^YTT(601.89,"B",CTYP,0)) Q:'CID
"RTN","YS129PST",75,0)
 . . N CHG S CHG(1)=0
"RTN","YS129PST",76,0)
 . . D UPDANY(601.89,CID,.CHG)
"RTN","YS129PST",77,0)
 . . K CHG S CHG(18)=$P($T(EDTDATE+1),";;",2)
"RTN","YS129PST",78,0)
 . . D UPDANY(601.71,TEST,.CHG)
"RTN","YS129PST",79,0)
 Q
"RTN","YS129PST",80,0)
UPDANY(FILEN,IEN,CHGS) ; update any MH record
"RTN","YS129PST",81,0)
 Q:FILEN<601  Q:FILEN>604  ; limit to MH files
"RTN","YS129PST",82,0)
 N FDA,DIERR
"RTN","YS129PST",83,0)
 M FDA(FILEN,IEN_",")=CHGS
"RTN","YS129PST",84,0)
 D FILE^DIE("","FDA")
"RTN","YS129PST",85,0)
 I $D(DIERR) D BMES^XPDUTL("ERROR: "_$G(^TMP("DIERR",$J,1,"TEXT",1)))
"RTN","YS129PST",86,0)
 D CLEAN^DILF
"RTN","YS129PST",87,0)
 K CHGS ; clean up for next call
"RTN","YS129PST",88,0)
 Q
"RTN","YS129PST",89,0)
 ;
"RTN","YS129PST",90,0)
TESTS ; Scale Group Names updated
"RTN","YS129PST",91,0)
 ;;AUDIT;;AUDIT Scale
"RTN","YS129PST",92,0)
 ;;PCL-5;;PCL-5 Scale
"RTN","YS129PST",93,0)
 ;;zzzzz
"RTN","YS129PST",94,0)
 ;
"RTN","YTQAPI7")
0^1^B23570402^B18902958
"RTN","YTQAPI7",1,0)
YTQAPI7 ;ALB/ASF- MHAX ANSWERS ; 5/24/07 10:12am
"RTN","YTQAPI7",2,0)
 ;;5.01;MENTAL HEALTH;**85,129**;Dec 30, 1994;Build 12
"RTN","YTQAPI7",3,0)
 Q
"RTN","YTQAPI7",4,0)
KEY(YSDATA,YS) ;get all keys for a test
"RTN","YTQAPI7",5,0)
 ; input: CODE as TEST name
"RTN","YTQAPI7",6,0)
 ; output:SCALE=ScaleName^scale Id
"RTN","YTQAPI7",7,0)
 ;        KEY=Question ID^Target^Value^Key Ien
"RTN","YTQAPI7",8,0)
 N G,YSKEYI,YSCODE,I,N,YSCALEI,YSCNAME,YSCODEN,YSQN,YSTARG,YSVAL
"RTN","YTQAPI7",9,0)
 K ^TMP($J,"YSKEY") S YSDATA=$NA(^TMP($J,"YSKEY"))
"RTN","YTQAPI7",10,0)
 S YSCODE=$G(YS("CODE")) S:YSCODE="" YSCODE=0
"RTN","YTQAPI7",11,0)
 I '$D(^YTT(601.71,"B",YSCODE)) S ^TMP($J,"YSKEY",1)="[ERROR]",^TMP($J,"YSKEY",2)="no ins" Q  ;-->out
"RTN","YTQAPI7",12,0)
 S YSCODEN=$O(^YTT(601.71,"B",YSCODE,0))
"RTN","YTQAPI7",13,0)
 I '$D(^YTT(601.86,"AC",YSCODEN)) S ^TMP($J,"YSKEY",1)="[ERROR]",^TMP($J,"YSKEY",2)="no scale grps found" Q  ;-->out
"RTN","YTQAPI7",14,0)
 D SCALEG^YTQAPI3(.YSDATA,.YS)
"RTN","YTQAPI7",15,0)
 S YSDATA=$NA(^TMP($J,"YSKEY"))
"RTN","YTQAPI7",16,0)
 S ^TMP($J,"YSKEY",1)="[DATA]",N=1
"RTN","YTQAPI7",17,0)
 F I=2:1 Q:'$D(^TMP($J,"YSG",I))  I ^TMP($J,"YSG",I)?1"Scale".E D
"RTN","YTQAPI7",18,0)
 . S YSCALEI=$P(^TMP($J,"YSG",I),U),YSCALEI=$P(YSCALEI,"=",2),YSCNAME=$P(^TMP($J,"YSG",I),U,4)
"RTN","YTQAPI7",19,0)
 . S N=N+1,^TMP($J,"YSKEY",N)="SCALE="_YSCNAME_U_YSCALEI_U
"RTN","YTQAPI7",20,0)
 . S YSKEYI=0 F  S YSKEYI=$O(^YTT(601.91,"AC",YSCALEI,YSKEYI)) Q:YSKEYI'>0  D
"RTN","YTQAPI7",21,0)
 .. S G=^YTT(601.91,YSKEYI,0)
"RTN","YTQAPI7",22,0)
 .. S YSQN=$P(G,U,3),YSTARG=$P(G,U,4),YSVAL=$P(G,U,5)
"RTN","YTQAPI7",23,0)
 .. S N=N+1
"RTN","YTQAPI7",24,0)
 .. S ^TMP($J,"YSKEY",N)="KEY="_YSQN_U_YSTARG_U_YSVAL_U_YSKEYI
"RTN","YTQAPI7",25,0)
 Q
"RTN","YTQAPI7",26,0)
ANSLIST(YSDATA,YS) ;simple answer list
"RTN","YTQAPI7",27,0)
 N D1,N1,YSQ,YSAI,G
"RTN","YTQAPI7",28,0)
 S YSAI=$G(YS("IEN")) I YSAI'?1N.N S YSDATA(1)="[ERROR]",YSDATA(2)="bad admin ien" Q  ;-->out
"RTN","YTQAPI7",29,0)
 S N=1,YSQ=0
"RTN","YTQAPI7",30,0)
 F  S YSQ=$O(^YTT(601.85,"AC",YSAI,YSQ)) Q:YSQ'>0  S DA=0 F  S DA=$O(^YTT(601.85,"AC",YSAI,YSQ,DA)) Q:DA'>0  D
"RTN","YTQAPI7",31,0)
 . S D1=0,N1=0,G=$G(^YTT(601.85,DA,0))
"RTN","YTQAPI7",32,0)
 . F  S D1=$O(^YTT(601.85,DA,1,D1)) Q:D1'>0  D
"RTN","YTQAPI7",33,0)
 .. S N=N+1,N1=N1+1
"RTN","YTQAPI7",34,0)
 .. S YSDATA(N)=$P(G,U,3)_";"_N1_U_$G(^YTT(601.85,DA,1,D1,0))
"RTN","YTQAPI7",35,0)
 Q
"RTN","YTQAPI7",36,0)
VERSRV(YSDATA,YS) ; Return server version stored in YS BROKER1
"RTN","YTQAPI7",37,0)
 ; input: YSB as option name
"RTN","YTQAPI7",38,0)
 ; output: 2:MHA3 version number
"RTN","YTQAPI7",39,0)
 ;         3: CR DLL VERSION
"RTN","YTQAPI7",40,0)
 ;         4:mh DLL VERSION
"RTN","YTQAPI7",41,0)
 N YSLST,YSB,YSVAL
"RTN","YTQAPI7",42,0)
 S YSB=$G(YS("YSB"))
"RTN","YTQAPI7",43,0)
 I YSB="" S YSDATA(1)="[ERROR]",YSDATA(2)="no opt" Q
"RTN","YTQAPI7",44,0)
 D FIND^DIC(19,"",1,"X",YSB,1,,,,"YSLST")
"RTN","YTQAPI7",45,0)
 I 'YSLST("DILIST",0) S YSDATA(1)="[ERROR]",YSDATA(2)="no version found" Q
"RTN","YTQAPI7",46,0)
 S YSVAL=YSLST("DILIST","ID",1,1)
"RTN","YTQAPI7",47,0)
 S YSVAL=$P(YSVAL,"version ",2)
"RTN","YTQAPI7",48,0)
 S YSDATA(1)="[DATA]"
"RTN","YTQAPI7",49,0)
 S YSDATA(2)=$P(YSVAL,"~",1)
"RTN","YTQAPI7",50,0)
 S YSDATA(3)=$P(YSVAL,"~",2)
"RTN","YTQAPI7",51,0)
 S YSDATA(4)=$P(YSVAL,"~",3)
"RTN","YTQAPI7",52,0)
 S YSDATA(5)=$$GET^XPAR("ALL","YS MHA_AUX DLL LOCATION")
"RTN","YTQAPI7",53,0)
 Q
"RTN","YTQAPI7",54,0)
UPDVER(WHICH,VER) ; update MHA version number in broker option
"RTN","YTQAPI7",55,0)
 ; WHICH: 1=server, 2="A" DLL, 3=MHA exe
"RTN","YTQAPI7",56,0)
 ; VER: version string for WHICH component
"RTN","YTQAPI7",57,0)
 N OPT,TXT,VERPART,FDA,DIERR
"RTN","YTQAPI7",58,0)
 S OPT=$$FIND1^DIC(19,"","X","YS BROKER1","B")
"RTN","YTQAPI7",59,0)
 I 'OPT D BMES^XPDUTL("ERROR: YS BROKER1 not found on this system.") QUIT
"RTN","YTQAPI7",60,0)
 I $D(DIERR) D BMES^XPDUTL("ERROR: "_$G(^TMP("DIERR",$J,1,"TEXT",1))) QUIT
"RTN","YTQAPI7",61,0)
 S TXT=$$GET1^DIQ(19,OPT_",",1),VERPART=$P(TXT,"version ",2)
"RTN","YTQAPI7",62,0)
 S $P(VERPART,"~",WHICH)=VER,$P(TXT,"version ",2)=VERPART
"RTN","YTQAPI7",63,0)
 S FDA(19,OPT_",",1)=TXT
"RTN","YTQAPI7",64,0)
 D FILE^DIE("","FDA")
"RTN","YTQAPI7",65,0)
 I $D(DIERR) D BMES^XPDUTL("ERROR: "_$G(^TMP("DIERR",$J,1,"TEXT",1)))
"RTN","YTQAPI7",66,0)
 D CLEAN^DILF
"RTN","YTQAPI7",67,0)
 Q
"RTN","YTQAPI7",68,0)
RULEDEL(YSDATA,YS) ; deletes a rule and all associated skips and instrument rules
"RTN","YTQAPI7",69,0)
 ;Input IEN as ien of file 601.82
"RTN","YTQAPI7",70,0)
 ;Output Data vs Error
"RTN","YTQAPI7",71,0)
 N YSRULE,YSIEN,DA,DIK
"RTN","YTQAPI7",72,0)
 S YSRULE=$G(YS("IEN"),-1)
"RTN","YTQAPI7",73,0)
 I '$D(^YTT(601.82,YSRULE)) S YSDATA(1)="[ERROR]",YSDATA(2)="bad rule id" Q  ;--> out
"RTN","YTQAPI7",74,0)
 ;delete rule
"RTN","YTQAPI7",75,0)
 S DA=YSRULE,DIK="^YTT(601.82," D ^DIK
"RTN","YTQAPI7",76,0)
 ;delete instrument rules
"RTN","YTQAPI7",77,0)
 S YSIEN=0 F  S YSIEN=$O(^YTT(601.83,"AC",YSRULE,YSIEN)) Q:YSIEN'>0  S DA=YSIEN,DIK="^YTT(601.83," D ^DIK
"RTN","YTQAPI7",78,0)
 ;delete skips
"RTN","YTQAPI7",79,0)
 S YSIEN=0 F  S YSIEN=$O(^YTT(601.79,"AE",YSRULE,YSIEN)) Q:YSIEN'>0  S DA=YSIEN,DIK="^YTT(601.79," D ^DIK
"RTN","YTQAPI7",80,0)
 S YSDATA(1)="[DATA]",YSDATA(2)="ok deleted"
"RTN","YTQAPI7",81,0)
 Q
"RTN","YTQAPI7",82,0)
BATDEL(YSDATA,YS) ;deletes a battery and associated users and content
"RTN","YTQAPI7",83,0)
 ;Input IEN as ien of file 601.77
"RTN","YTQAPI7",84,0)
 ;Output Data vs Error
"RTN","YTQAPI7",85,0)
 N YSBAT,YSIEN,DA,DIK
"RTN","YTQAPI7",86,0)
 S YSBAT=$G(YS("IEN"),-1)
"RTN","YTQAPI7",87,0)
 I '$D(^YTT(601.77,YSBAT)) S YSDATA(1)="[ERROR]",YSDATA(2)="bad BATTERY id" Q  ;--> out
"RTN","YTQAPI7",88,0)
 ;delete battery
"RTN","YTQAPI7",89,0)
 S DA=YSBAT,DIK="^YTT(601.77," D ^DIK
"RTN","YTQAPI7",90,0)
 ;delete battery Content
"RTN","YTQAPI7",91,0)
 S YSIEN=0 F  S YSIEN=$O(^YTT(601.78,"AD",YSBAT,YSIEN)) Q:YSIEN'>0  S DA=YSIEN,DIK="^YTT(601.78," D ^DIK
"RTN","YTQAPI7",92,0)
 ;delete batt Users
"RTN","YTQAPI7",93,0)
 S YSIEN=0 F  S YSIEN=$O(^YTT(601.781,"AD",YSBAT,YSIEN)) Q:YSIEN'>0  S DA=YSIEN,DIK="^YTT(601.781," D ^DIK
"RTN","YTQAPI7",94,0)
 S YSDATA(1)="[DATA]",YSDATA(2)="ok batt deleted"
"RTN","YTQAPI7",95,0)
 Q
"RTN","YTQAPI7",96,0)
SNDBUL(YSDATA,YS) ;send message to psych test ordering clinician
"RTN","YTQAPI7",97,0)
 ;Input: DFN as patient ien
"RTN","YTQAPI7",98,0)
 ;     : ORD as ordered for (in duz form)
"RTN","YTQAPI7",99,0)
 ;     : TEST1 as name of test ordered (required;string)
"RTN","YTQAPI7",100,0)
 ;     : TEST2-TEST10 as name of other tests ordered (optional but in order;string)
"RTN","YTQAPI7",101,0)
 ;Output: [DATA] VS [ERROR]
"RTN","YTQAPI7",102,0)
 N I,XMB,XMDUZ,XMY,X,DIC,YSORD,YSDFN,Y,YSDT
"RTN","YTQAPI7",103,0)
 S YSDFN=$G(YS("DFN")) I YSDFN="" S YSDATA(1)="[ERROR]",YSDATA(2)="NO DFN" Q  ;--> out
"RTN","YTQAPI7",104,0)
 S YSORD=$G(YS("ORD")) I YSORD="" S YSDATA(1)="[ERROR]",YSDATA(2)="NO ORD" Q  ;--> out
"RTN","YTQAPI7",105,0)
 F I=6:1:15 S XMB(I)=$G(YS("TEST"_(I-5)))
"RTN","YTQAPI7",106,0)
 I XMB(6)="" S YSDATA(1)="[ERROR]",YSDATA(2)="no tests" Q  ;--> out
"RTN","YTQAPI7",107,0)
 S Y=DT X ^DD("DD") S YSDT(1)=Y
"RTN","YTQAPI7",108,0)
 ;as in ENBUL^YSUTL
"RTN","YTQAPI7",109,0)
 S DIC=3.8,DIC(0)="MZ",X="YS PSYCHTEST" D ^DIC
"RTN","YTQAPI7",110,0)
 I Y'>0 S YSDATA(1)="[ERROR]",YSDATA(2)="no YS bulletin" Q  ;-->out
"RTN","YTQAPI7",111,0)
 S XMB="YS PSYCHTEST",XMB(1)=$P(^DPT(YSDFN,0),U),XMB(2)=$P(^VA(200,DUZ,0),U),XMB(3)=YSDT(1) S XMB(4)="" S:YSORD]"" XMB(4)=$P(^VA(200,YSORD,0),U),XMY(YSORD)="" S XMDUZ=DUZ D EN^XMB
"RTN","YTQAPI7",112,0)
 S YSDATA(1)="[DATA]",YSDATA(2)="OK"
"VER")
8.0^22.2
"BLD",9463,6)
^101
**END**
**END**

