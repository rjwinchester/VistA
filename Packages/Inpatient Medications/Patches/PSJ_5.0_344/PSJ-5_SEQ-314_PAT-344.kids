Released PSJ*5*344 SEQ #314
Extracted from mail message
**KIDS**:PSJ*5.0*344^

**INSTALL NAME**
PSJ*5.0*344
"BLD",10741,0)
PSJ*5.0*344^INPATIENT MEDICATIONS^0^3180703^y
"BLD",10741,1,0)
^^19^19^3180703^
"BLD",10741,1,1,0)
This patch addresses four (4) issues:
"BLD",10741,1,2,0)
 
"BLD",10741,1,3,0)
1.  An UNDEFINED error is happening when copying a UD order, the user
"BLD",10741,1,4,0)
    changes the Orderable Item but "^" out at the dispense drug selection
"BLD",10741,1,5,0)
    all the way back to the profile, then picks another order to copy.
"BLD",10741,1,6,0)
 
"BLD",10741,1,7,0)
2.  A Clinic IMO order could not be processed.  The site was turned off
"BLD",10741,1,8,0)
    for Inpatient Meds between the time the order was placed and when it
"BLD",10741,1,9,0)
    was processed by pharmacy.
"BLD",10741,1,10,0)
    
"BLD",10741,1,11,0)
3.  A Non-Verified IV order was modified, a non-starred field, then 
"BLD",10741,1,12,0)
    another non-starred field was selected but the user cancelled the
"BLD",10741,1,13,0)
    action (^). After the user Accepted the change the screen displayed
"BLD",10741,1,14,0)
    the patient profile and not the accepted order to be verified.
"BLD",10741,1,15,0)
 
"BLD",10741,1,16,0)
4.  The verify action is not enabled immediately when a user accepts a 
"BLD",10741,1,17,0)
    unit dose order after verifying an iv fluid order for a different 
"BLD",10741,1,18,0)
    patient. Instead, the profile screen is displayed without the verify
"BLD",10741,1,19,0)
    action.
"BLD",10741,4,0)
^9.64PA^^
"BLD",10741,6.3)
7
"BLD",10741,"ABPKG")
n
"BLD",10741,"KRN",0)
^9.67PA^779.2^20
"BLD",10741,"KRN",.4,0)
.4
"BLD",10741,"KRN",.401,0)
.401
"BLD",10741,"KRN",.402,0)
.402
"BLD",10741,"KRN",.403,0)
.403
"BLD",10741,"KRN",.5,0)
.5
"BLD",10741,"KRN",.84,0)
.84
"BLD",10741,"KRN",3.6,0)
3.6
"BLD",10741,"KRN",3.8,0)
3.8
"BLD",10741,"KRN",9.2,0)
9.2
"BLD",10741,"KRN",9.8,0)
9.8
"BLD",10741,"KRN",9.8,"NM",0)
^9.68A^3^2
"BLD",10741,"KRN",9.8,"NM",2,0)
PSJOE^^0^B108530036
"BLD",10741,"KRN",9.8,"NM",3,0)
PSJLIACT^^0^B59279356
"BLD",10741,"KRN",9.8,"NM","B","PSJLIACT",3)

"BLD",10741,"KRN",9.8,"NM","B","PSJOE",2)

"BLD",10741,"KRN",19,0)
19
"BLD",10741,"KRN",19.1,0)
19.1
"BLD",10741,"KRN",101,0)
101
"BLD",10741,"KRN",409.61,0)
409.61
"BLD",10741,"KRN",409.61,"NM",0)
^9.68A^^0
"BLD",10741,"KRN",771,0)
771
"BLD",10741,"KRN",779.2,0)
779.2
"BLD",10741,"KRN",870,0)
870
"BLD",10741,"KRN",8989.51,0)
8989.51
"BLD",10741,"KRN",8989.52,0)
8989.52
"BLD",10741,"KRN",8994,0)
8994
"BLD",10741,"KRN","B",.4,.4)

"BLD",10741,"KRN","B",.401,.401)

"BLD",10741,"KRN","B",.402,.402)

"BLD",10741,"KRN","B",.403,.403)

"BLD",10741,"KRN","B",.5,.5)

"BLD",10741,"KRN","B",.84,.84)

"BLD",10741,"KRN","B",3.6,3.6)

"BLD",10741,"KRN","B",3.8,3.8)

"BLD",10741,"KRN","B",9.2,9.2)

"BLD",10741,"KRN","B",9.8,9.8)

"BLD",10741,"KRN","B",19,19)

"BLD",10741,"KRN","B",19.1,19.1)

"BLD",10741,"KRN","B",101,101)

"BLD",10741,"KRN","B",409.61,409.61)

"BLD",10741,"KRN","B",771,771)

"BLD",10741,"KRN","B",779.2,779.2)

"BLD",10741,"KRN","B",870,870)

"BLD",10741,"KRN","B",8989.51,8989.51)

"BLD",10741,"KRN","B",8989.52,8989.52)

"BLD",10741,"KRN","B",8994,8994)

"BLD",10741,"QDEF")
^^^^NO^^^^^^NO
"BLD",10741,"QUES",0)
^9.62^^
"BLD",10741,"REQB",0)
^9.611^1^1
"BLD",10741,"REQB",1,0)
PSJ*5.0*347^2
"BLD",10741,"REQB","B","PSJ*5.0*347",1)

"MBREQ")
0
"PKG",471,-1)
1^1
"PKG",471,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",471,20,0)
^9.402P^^
"PKG",471,22,0)
^9.49I^1^1
"PKG",471,22,1,0)
5.0^2971215^2990325^66481
"PKG",471,22,1,"PAH",1,0)
344^3180703
"PKG",471,22,1,"PAH",1,1,0)
^^19^19^3180703
"PKG",471,22,1,"PAH",1,1,1,0)
This patch addresses four (4) issues:
"PKG",471,22,1,"PAH",1,1,2,0)
 
"PKG",471,22,1,"PAH",1,1,3,0)
1.  An UNDEFINED error is happening when copying a UD order, the user
"PKG",471,22,1,"PAH",1,1,4,0)
    changes the Orderable Item but "^" out at the dispense drug selection
"PKG",471,22,1,"PAH",1,1,5,0)
    all the way back to the profile, then picks another order to copy.
"PKG",471,22,1,"PAH",1,1,6,0)
 
"PKG",471,22,1,"PAH",1,1,7,0)
2.  A Clinic IMO order could not be processed.  The site was turned off
"PKG",471,22,1,"PAH",1,1,8,0)
    for Inpatient Meds between the time the order was placed and when it
"PKG",471,22,1,"PAH",1,1,9,0)
    was processed by pharmacy.
"PKG",471,22,1,"PAH",1,1,10,0)
    
"PKG",471,22,1,"PAH",1,1,11,0)
3.  A Non-Verified IV order was modified, a non-starred field, then 
"PKG",471,22,1,"PAH",1,1,12,0)
    another non-starred field was selected but the user cancelled the
"PKG",471,22,1,"PAH",1,1,13,0)
    action (^). After the user Accepted the change the screen displayed
"PKG",471,22,1,"PAH",1,1,14,0)
    the patient profile and not the accepted order to be verified.
"PKG",471,22,1,"PAH",1,1,15,0)
 
"PKG",471,22,1,"PAH",1,1,16,0)
4.  The verify action is not enabled immediately when a user accepts a 
"PKG",471,22,1,"PAH",1,1,17,0)
    unit dose order after verifying an iv fluid order for a different 
"PKG",471,22,1,"PAH",1,1,18,0)
    patient. Instead, the profile screen is displayed without the verify
"PKG",471,22,1,"PAH",1,1,19,0)
    action.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSJLIACT")
0^3^B59279356^B59558968
"RTN","PSJLIACT",1,0)
PSJLIACT ;BIR/MV - IV ACTION ;28 Jul 98  8:50 AM
"RTN","PSJLIACT",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**15,47,62,58,82,97,80,110,111,134,181,247,260,275,257,299,281,346,256,347,344**;16 DEC 97;Build 7
"RTN","PSJLIACT",3,0)
 ;
"RTN","PSJLIACT",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJLIACT",5,0)
 ; Reference to MAIN^TIUEDIT is supported by DBIA 2410.
"RTN","PSJLIACT",6,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071.
"RTN","PSJLIACT",7,0)
 ;
"RTN","PSJLIACT",8,0)
DC ; Discontinue order
"RTN","PSJLIACT",9,0)
 K PSGORQF
"RTN","PSJLIACT",10,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",11,0)
 S PSJCOM=+$S(PSJORD["V":$P($G(^PS(55,DFN,"IV",+PSJORD,.2)),"^",8),1:$P($G(^PS(53.1,+PSJORD,.2)),"^",8))
"RTN","PSJLIACT",12,0)
 I PSJCOM W !!,"This order is part of a complex order. If you discontinue this order the",!,"following orders will be discontinued too (unless the stop date has already",!,"been reached)." D CMPLX^PSJCOM1(PSGP,PSJCOM,PSJORD)
"RTN","PSJLIACT",13,0)
 I PSJCOM F  W !!,"Do you want to discontinue this order" S %=1 D YN^DICN Q:%  D ENCOM^PSGOEM
"RTN","PSJLIACT",14,0)
 I PSJCOM,%'=1 S VALMBK="" Q
"RTN","PSJLIACT",15,0)
 I $G(ON55)["P",$G(PSIVOORD) S PSJORD=ON55 ;*247 - Correct DCing newly copied orders
"RTN","PSJLIACT",16,0)
 I PSJORD["V" D DC^PSIVORA D:'$G(PSJOCFLG) EN^PSJLIORD(DFN,ON) Q
"RTN","PSJLIACT",17,0)
 I PSJORD["P" N ON S ON=PSJORD D DISCONT^PSIVORC
"RTN","PSJLIACT",18,0)
 S VALMBCK="Q"
"RTN","PSJLIACT",19,0)
 Q
"RTN","PSJLIACT",20,0)
ACEDIT ; Display LM screen and AC and EDit actions
"RTN","PSJLIACT",21,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",22,0)
 S VALMBCK=$S($G(PSIVACEP):"Q",1:"R")
"RTN","PSJLIACT",23,0)
 Q
"RTN","PSJLIACT",24,0)
AEEXIT ; Call for EXIT CODE in PSJ LM IV AC/EDIT
"RTN","PSJLIACT",25,0)
 I ON["V" K PSGORQF D GT55^PSIVORFB ;RTC 340818
"RTN","PSJLIACT",26,0)
 I ON["P" D GT531^PSIVORFA(DFN,ON) D:P("OT")'="I" GTDATA^PSJLIFN
"RTN","PSJLIACT",27,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",28,0)
 K PSIVENO
"RTN","PSJLIACT",29,0)
 Q
"RTN","PSJLIACT",30,0)
EDIT ; Edit order
"RTN","PSJLIACT",31,0)
 K PSIVFN1
"RTN","PSJLIACT",32,0)
 I $D(PSGACT),PSGACT'["E" W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJLIACT",33,0)
 D EDIT1
"RTN","PSJLIACT",34,0)
 Q:$D(PSIVNBD)!($G(PSIVCOPY)&'$G(PSIVENO))
"RTN","PSJLIACT",35,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",36,0)
 S VALMBCK=$S($G(PSIVFN1):"Q",1:"R")
"RTN","PSJLIACT",37,0)
 ;S PSJEDFLG=1 ;PSJ*346  Prevent double order display
"RTN","PSJLIACT",38,0)
 I $G(PSGORQF) S VALMBCK="Q" K PSIVENO,PSJOCCHK ;RTC 340818
"RTN","PSJLIACT",39,0)
 Q
"RTN","PSJLIACT",40,0)
EDIT1 ;
"RTN","PSJLIACT",41,0)
 K PSGORQF ;RTC 340818
"RTN","PSJLIACT",42,0)
 ;Ensure P() is defined
"RTN","PSJLIACT",43,0)
 I $D(P)<10 S XQORQUIT=1,P("PON")="",PSIVNBD=1 D  Q
"RTN","PSJLIACT",44,0)
 .W !,"WARNING: An error has occurred. Changes will not be saved"
"RTN","PSJLIACT",45,0)
 .D PAUSE^VALM1
"RTN","PSJLIACT",46,0)
 .S VALMBCK="Q"
"RTN","PSJLIACT",47,0)
 I "ANP"'[P(17) W !,"You cannot edit an inactive order" D PAUSE^VALM1 Q
"RTN","PSJLIACT",48,0)
 S:$G(ON55)="" ON55=$G(PSJORD)
"RTN","PSJLIACT",49,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",50,0)
 N PSIEDITO S PSIEDITO=1
"RTN","PSJLIACT",51,0)
 ;* Edit a new back door order
"RTN","PSJLIACT",52,0)
 I ($G(ON55)["V"&($G(P("21FLG"))="")) D  Q
"RTN","PSJLIACT",53,0)
 . D GSTRING^PSIVORE1,GTFLDS^PSIVORFE
"RTN","PSJLIACT",54,0)
 . I $G(ON55)["V",'$G(DONE) D OK^PSIVORE
"RTN","PSJLIACT",55,0)
 . S VALMBCK="Q",PSIVNBD=1
"RTN","PSJLIACT",56,0)
 ;* Edit an active order
"RTN","PSJLIACT",57,0)
 I $G(ON55)["V" NEW PSJEDIT1 D E^PSIVOPT1 D  Q
"RTN","PSJLIACT",58,0)
 . I $G(PSJIVBD) K PSJIVBD D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",59,0)
 . I $G(PSGORQF) K PSIVENO,PSJOCCHK ;RTC 340818
"RTN","PSJLIACT",60,0)
 I $G(ON55)["P" D EDIT^PSIVORC ;Edit incomplete order.
"RTN","PSJLIACT",61,0)
 K P("OVRIDE")
"RTN","PSJLIACT",62,0)
 Q
"RTN","PSJLIACT",63,0)
ACCEPT ; Accept order
"RTN","PSJLIACT",64,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",65,0)
 ;Accept IV from back door.
"RTN","PSJLIACT",66,0)
 I $G(PSJIVBD) K PSJIVBD D OK^PSIVORE S VALMBCK="Q" Q
"RTN","PSJLIACT",67,0)
 ;D:'$G(PSGORQF) IN^PSJOCDS($G(ON),"IV","") Q:$G(PSGORQF)
"RTN","PSJLIACT",68,0)
 I ON["V" D ACCEPT^PSIVOPT1 S:'$G(PSGORQF) PSJDSVFY=1 Q
"RTN","PSJLIACT",69,0)
 S PSIVFN1=1
"RTN","PSJLIACT",70,0)
 D COMPLTE^PSIVORC1
"RTN","PSJLIACT",71,0)
 K ^TMP("PSODAOC",$J)
"RTN","PSJLIACT",72,0)
 S VALMBCK="Q"
"RTN","PSJLIACT",73,0)
 Q
"RTN","PSJLIACT",74,0)
R ; Renewal
"RTN","PSJLIACT",75,0)
 K PSGORQF,PSJOCCHK,PSIVENO
"RTN","PSJLIACT",76,0)
 S PSJREN=1
"RTN","PSJLIACT",77,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",78,0)
 NEW PSIVAC,PSJOLDNM S PSIVAC="PR" K PSGFDX
"RTN","PSJLIACT",79,0)
 S PSJOLDNM("ORD_SCHD")=$P($G(^PS(55,DFN,"IV",+ON,0)),U,9)
"RTN","PSJLIACT",80,0)
 I PSJOLDNM("ORD_SCHD")]"",$$CHKSCHD^PSJMISC2(.PSJOLDNM,"R") K PSJOLDNM Q
"RTN","PSJLIACT",81,0)
 K PSJOLDNM
"RTN","PSJLIACT",82,0)
 D R^PSIVOPT
"RTN","PSJLIACT",83,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",84,0)
 K PSJREN,^TMP("PSODAOC",$J)
"RTN","PSJLIACT",85,0)
 Q
"RTN","PSJLIACT",86,0)
H ; Hold
"RTN","PSJLIACT",87,0)
 K PSGORQF
"RTN","PSJLIACT",88,0)
 NEW TEX S TEX="Active order ***"
"RTN","PSJLIACT",89,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",90,0)
 D H^PSIVOPT(DFN,ON,P(17),P(3))
"RTN","PSJLIACT",91,0)
 D:P(17)="A" PAUSE^VALM1
"RTN","PSJLIACT",92,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",93,0)
 Q
"RTN","PSJLIACT",94,0)
L ; Activity Log
"RTN","PSJLIACT",95,0)
 NEW PSIVLAB,PSIVLOG,PSJHIS S (PSIVLAB,PSIVLOG)=1
"RTN","PSJLIACT",96,0)
 D EN^PSIVVW1
"RTN","PSJLIACT",97,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",98,0)
 S VALMBCK="R"
"RTN","PSJLIACT",99,0)
 Q
"RTN","PSJLIACT",100,0)
O ; On Call
"RTN","PSJLIACT",101,0)
 K PSGORQF
"RTN","PSJLIACT",102,0)
 NEW TEX S TEX="Active order ***"
"RTN","PSJLIACT",103,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",104,0)
 D O^PSIVOPT(DFN,ON,P(17),P(3))
"RTN","PSJLIACT",105,0)
 D:P(17)="A" PAUSE^VALM1
"RTN","PSJLIACT",106,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",107,0)
 Q
"RTN","PSJLIACT",108,0)
VF ; Make the order active **ENHANCEMENTS MADE IN PSJ*5.0*260
"RTN","PSJLIACT",109,0)
 NEW PSIVCHG,PSGORQF,PSJVFF,PSJOLDNM S PSIVCHG=0
"RTN","PSJLIACT",110,0)
 ;PSJ*5*256 - inform user of old schedule name and quit
"RTN","PSJLIACT",111,0)
 I $S((ON["P"):$P($G(^PS(53.1,+ON,0)),U,24)'="R",(ON["V"):$P($G(^PS(55,+PSGP,"IV",+ON,2)),U,8)'="R",1:0) D  Q:$G(PSGORQF)
"RTN","PSJLIACT",112,0)
 .D FULL^VALM1
"RTN","PSJLIACT",113,0)
 .S PSJOLDNM("ORD_SCHD")=$G(PSGSCH)
"RTN","PSJLIACT",114,0)
 .S PSGORQF=$$CHKSCHD^PSJMISC2(.PSJOLDNM,"V")
"RTN","PSJLIACT",115,0)
 ;IF VALM("TITLE")="ACTIVE IV " W !!,">>>  Verify may not be selected at this point." D PAUSE^VALM1 S VALMBCK="R" Q  ;PSJ*5*281 CCR 6995 Remedy ticket 861870
"RTN","PSJLIACT",116,0)
 ;ELSE  IF $G(PSGSTAT)="NON-VERIFIED",$G(PSJNEWOE)=0 S PSJVFF=1 D EN^PSJGMRA($G(DFN),$G(PSGPD)),IN^PSJOCDS($G(PSGORD),"IV",""),OC^PSIVOC K PSJVFF Q:$G(PSGORQF)
"RTN","PSJLIACT",117,0)
 ;PSGSTAT may not set for IV orders. Checking PSJOCFG so DI,DT is not displayed again for FN, CO, RN...
"RTN","PSJLIACT",118,0)
 IF (($G(PSGSTAT)="NON-VERIFIED")!($G(P(17))="N")&($G(PSJOCFG)="")),'+$G(PSJNEWOE) D
"RTN","PSJLIACT",119,0)
 .S PSJVFF=1 D:'$G(PSJENHOC)&'$G(PSGORQF) OC^PSIVOC D:('$G(PSGORQF)&'$G(PSJDSVFY)) IN^PSJOCDS($G(PSGORD),"IV","") K PSJVFF Q:$G(PSGORQF)
"RTN","PSJLIACT",120,0)
 Q:$G(PSGORQF)
"RTN","PSJLIACT",121,0)
 ELSE  IF '$G(PSGORQF),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",122,0)
 ELSE  IF $G(PSIVFN1),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",123,0)
 ELSE  IF $G(PSGDEF),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",124,0)
 ELSE  IF $G(PSIVCOPY),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",125,0)
 D ACTIVE^PSIVORC2
"RTN","PSJLIACT",126,0)
 Q
"RTN","PSJLIACT",127,0)
VF1(PSIVREA,PSIVAL,PSIVLOG) ;
"RTN","PSJLIACT",128,0)
 ;Update 4 node and set activity log.
"RTN","PSJLIACT",129,0)
 ;PSIVREA: the reason use by LOG^PSIVORAL
"RTN","PSJLIACT",130,0)
 ;PSIVAL : the description reason
"RTN","PSJLIACT",131,0)
 ;PSIVLOG: Log an activity if = 1
"RTN","PSJLIACT",132,0)
 K PSGORQF
"RTN","PSJLIACT",133,0)
 I '+$G(OD)!($L($G(OD))>16) K OD
"RTN","PSJLIACT",134,0)
 D:+PSJSYSU=3 ^PSIVORE1
"RTN","PSJLIACT",135,0)
 NEW DIE,DA,DR,PSJX,XX,PSIVACT,PSJRQND
"RTN","PSJLIACT",136,0)
 S PSIVACT=1
"RTN","PSJLIACT",137,0)
 S PSJX=$G(^PS(55,DFN,"IV",+ON55,4)),XX=""
"RTN","PSJLIACT",138,0)
 I $P(PSJX,U)="" S XX=";143////0"
"RTN","PSJLIACT",139,0)
 I $P(PSJX,U,4)="" S XX=XX_U_";142////0"
"RTN","PSJLIACT",140,0)
 D NOW^%DTC
"RTN","PSJLIACT",141,0)
 S DIE="^PS(55,"_DFN_",""IV"",",DA=+ON55,DA(1)=DFN
"RTN","PSJLIACT",142,0)
 I +PSJSYSU=3 S DR="140////"_DUZ_";141////"_$E(%,1,12)_";142////1"_$P(XX,U)
"RTN","PSJLIACT",143,0)
 I +PSJSYSU=1 S DR="16////"_DUZ_";17////"_$E(%,1,12)_";143////1"_$P(XX,U,2)
"RTN","PSJLIACT",144,0)
 I $G(P("PRY"))="D" S DR=DR_";.22////"_+P("IVRM")
"RTN","PSJLIACT",145,0)
 D ^DIE
"RTN","PSJLIACT",146,0)
 ; If pending IV renew is edited during finish, go back and DE the original active order left in RENEWED status
"RTN","PSJLIACT",147,0)
 S PREREN=$S(ON55["V":$G(@(DIE_"+ON55,2)")),1:""),PREREN=$P(PREREN,"^",5) I PREREN D  K PREREN
"RTN","PSJLIACT",148,0)
 . I PREREN["P" S PREREN=$G(@("^PS(53.1,+PREREN,0)")),PREREN=$P(PREREN,"^",25)
"RTN","PSJLIACT",149,0)
 . I PREREN["V" N PRERENOD S PRERENOD=$G(@("^PS(55,DFN,""IV"",+PREREN,0)")) I $P(PRERENOD,"^",17)="R",($G(P("RES"))="E") D
"RTN","PSJLIACT",150,0)
 ..  S DIE="^PS(55,"_DFN_",""IV"",",DA=+PREREN,DA(1)=DFN
"RTN","PSJLIACT",151,0)
 ..  S DR="100////D;.03////"_PSGDT S ORIGSTOP=$P($G(@("^PS(55,DFN,""IV"",+PREREN,2)")),"^",3) I ORIGSTOP S DR=DR_";116////"_ORIGSTOP
"RTN","PSJLIACT",152,0)
 ..  D ^DIE D EN1^PSJHL2(DFN,"SC",PREREN)
"RTN","PSJLIACT",153,0)
 K DR,DIE,DA
"RTN","PSJLIACT",154,0)
 I (+PSJSYSU=3)&($G(P("PRY"))="D") D
"RTN","PSJLIACT",155,0)
 .N DIR W ! S DIR(0)="S^Y:Yes;N:No",DIR("A")="Do you want to enter a Progress Note",DIR("B")="No" D ^DIR
"RTN","PSJLIACT",156,0)
 .Q:Y="N"
"RTN","PSJLIACT",157,0)
 .D MAIN^TIUEDIT(3,.TIUDA,DFN,"","","","",1)
"RTN","PSJLIACT",158,0)
 Q:'$G(PSIVLOG)
"RTN","PSJLIACT",159,0)
 I $G(P("PACT"))]"",+$P(P("PACT"),U,2),+$P(P("PACT"),U,3) D
"RTN","PSJLIACT",160,0)
 . NEW DIC,DA,X,Y,XX,DO D NAME^PSJBCMA1($P(P("PACT"),U,2),.XX)
"RTN","PSJLIACT",161,0)
 . S DIC(0)="L",DA(1)=DFN,DA(2)=+ON55,X=1
"RTN","PSJLIACT",162,0)
 . S DIC="^PS(55,"_DA(1)_",""IV"","_DA(2)_",""A"","
"RTN","PSJLIACT",163,0)
 . S DIC("DR")=".02////F;.03////"_XX_";.04////"_$P($G(^PS(53.3,+$P(P("PACT"),U,3),0)),U)_";.05////"_$P(P("PACT"),U)_";.06////"_$P(P("PACT"),U,2)
"RTN","PSJLIACT",164,0)
 . D FILE^DICN
"RTN","PSJLIACT",165,0)
 NEW PSIVALCK
"RTN","PSJLIACT",166,0)
 S PSIVREA="V",PSIVALT=""
"RTN","PSJLIACT",167,0)
 S PSIVAL=PSIVAL_$S(+PSJSYSU=3:"PHARMACIST",1:"NURSE")
"RTN","PSJLIACT",168,0)
 D LOG^PSIVORAL K PSIVAL,PSIVREA,PSIVLN
"RTN","PSJLIACT",169,0)
 I $G(PSJORD)["P" S PSIVREA="V",PSIVALT="",PSGRDTX=$G(^PS(53.1,+PSJORD,2.5)) D
"RTN","PSJLIACT",170,0)
 . I $G(PSGRDTX) S PSIVAL="Requested Start Date: "_$$ENDTC^PSGMI($$DATE2^PSJUTL2($P(PSGRDTX,U))) D LOG^PSIVORAL
"RTN","PSJLIACT",171,0)
 . I $P(PSGRDTX,U,3) S PSIVREA="V",PSIVALT="" S PSIVAL="Requested Stop Date: "_$$ENDTC^PSGMI($$DATE2^PSJUTL2($P(PSGRDTX,U,3))) D LOG^PSIVORAL
"RTN","PSJLIACT",172,0)
 N DUR I $G(PSJORD) S DUR=$$GETDUR^PSJLIVMD(DFN,+PSJORD,$S(PSJORD["P":"P",1:"IV"),1) I DUR]""  D
"RTN","PSJLIACT",173,0)
 . K DR S DIE="^PS(55,"_DFN_",""IV"",",DA=+ON55,DA(1)=DFN
"RTN","PSJLIACT",174,0)
 . S DR=$S($G(IVLIMIT):"152////"_DUR,1:"151////"_DUR) K IVLIMIT
"RTN","PSJLIACT",175,0)
 . D ^DIE
"RTN","PSJLIACT",176,0)
 S ^TMP("PSODAOC",$J,"IP NEW IEN")=ON55
"RTN","PSJLIACT",177,0)
 D EN1^PSJHL2(DFN,"SC",ON55),SETOC^PSJNEWOC(ON55)
"RTN","PSJLIACT",178,0)
 D:+PSJSYSU=1 EN1^PSJHL2(DFN,"ZV",ON55)
"RTN","PSJLIACT",179,0)
 I '$D(^PS(55,DFN,"IV","CIMOI",+ON55)) D CIMOI^PSJIMO1(DFN,ON55,"",$G(PSJORD))
"RTN","PSJLIACT",180,0)
 E  I +$G(PSJORD) D KILL531^PSJIMO1(DFN,"",PSJORD)
"RTN","PSJLIACT",181,0)
 D GT55^PSIVORFB S OLDON=$P($G(^PS(55,DFN,"IV",+ON55,2)),"^",5),P("OLDON")=OLDON
"RTN","PSJLIACT",182,0)
 N PSJPRIO,PSJSCH,NODE0,NODEP2 S NODE0=$G(^PS(55,DFN,"IV",+ON55,0)),NODEP2=$G(^PS(55,DFN,"IV",+ON55,.2))
"RTN","PSJLIACT",183,0)
 S PSJPRIO=$P(NODEP2,"^",4),PSJSCH=$P(NODE0,"^",9)
"RTN","PSJLIACT",184,0)
 I (",S,A,")[(","_$G(PSJPRIO)_",")!($G(PSJSCH)="NOW")!($G(PSJSCH)["STAT") D NOTIFY^PSJHL4(ON55,DFN,$G(PSJPRIO),$G(PSJSCH))
"RTN","PSJLIACT",185,0)
 Q
"RTN","PSJOE")
0^2^B108530036^B107308183
"RTN","PSJOE",1,0)
PSJOE ;BIR/MLM - INPATIENT ORDER ENTRY ; 3/5/18 1:49pm
"RTN","PSJOE",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**7,26,29,33,42,50,56,72,58,85,95,80,110,111,133,140,151,149,181,252,281,315,256,344**;16 DEC 97;Build 7
"RTN","PSJOE",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSJOE",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJOE",5,0)
 ; Reference to EN^VALM is supported by DBIA #10118.
"RTN","PSJOE",6,0)
 ; Reference to FULL^VALM1 is supported by DBIA #10116.
"RTN","PSJOE",7,0)
 ; Reference to PAUSE^VALM1 is supported by DBIA #10116.
"RTN","PSJOE",8,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSJOE",9,0)
 ; Reference to ^DPT( is supported by DBIA #10035.
"RTN","PSJOE",10,0)
 ; Reference to ^ORCFLAG is supported by DBIA #3620.
"RTN","PSJOE",11,0)
 ; Reference to ^SDAMA203 is supported by DBIA #4133.
"RTN","PSJOE",12,0)
 ; Reference to ^TMP("PSODAOC" is supported by DBIA #6071.
"RTN","PSJOE",13,0)
 ;
"RTN","PSJOE",14,0)
EN ; Start Inpatient LM OE
"RTN","PSJOE",15,0)
 N PSJLK,PSJNEWOE,PSJLMCON,PSJPROT,XQORS,VALMEVL D ENCV^PSGSETU,^PSIVXU
"RTN","PSJOE",16,0)
 I $D(XQUIT) K XQUIT G DONE
"RTN","PSJOE",17,0)
 K PSGVBY,PSJPR S (PSJOL,PSJACOK,PSGOP,PSGNEF,PSGOEAV,PSGPXN)="" L +^PS(53.45,PSJSYSP):1 E  D LOCKERR^PSJOE G DONE^PSJOE
"RTN","PSJOE",18,0)
 F  S (PSJLMCON,PSGPTMP)=0 D ^PSJP,HK Q:PSGP'>0  S PSJPROT=3,DFN=PSGP D ^PSJAC D  I PSJLK D UL^PSSLOCK(PSGP)
"RTN","PSJOE",19,0)
 .K ^TMP("PSJ",$J)
"RTN","PSJOE",20,0)
 .S PSJLK=$$L^PSSLOCK(PSGP,1) I 'PSJLK W !,$C(7),$P(PSJLK,U,2) Q
"RTN","PSJOE",21,0)
 .K PSJLMPRO D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSJOE",22,0)
 .N NXTPT S NXTPT=0 F  Q:$G(NXTPT)  D
"RTN","PSJOE",23,0)
 ..K PSGRDTX
"RTN","PSJOE",24,0)
 ..I $G(PSJLMCON)!$G(PSJNEWOE) D
"RTN","PSJOE",25,0)
 ...S PSJOL=$S(",S,L,"[(","_$G(PSJOL)_","):PSJOL,1:"S")
"RTN","PSJOE",26,0)
 ...S PSJLMPRO=1,PSJLMCON=1,PSJNEWOE=0 D EN^VALM("PSJ LM OE")
"RTN","PSJOE",27,0)
 ..I $G(PSJNEWOE)!($G(VALMBCK)="Q") S PSJNEWOE=0 Q
"RTN","PSJOE",28,0)
 ..I $G(PSJLMCON)&$G(PSJLMPRO)&'$D(^TMP("PSJ",$J)) D  Q
"RTN","PSJOE",29,0)
 ...S PSJLMCON=0,PSJLMPRO=0 D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSJOE",30,0)
 ...I $G(PSJNEWOE) S NXTPT=0 Q
"RTN","PSJOE",31,0)
 ...S NXTPT=1
"RTN","PSJOE",32,0)
 ..S NXTPT=1,PSJNEWOE=0
"RTN","PSJOE",33,0)
 .S PSJOL="S"
"RTN","PSJOE",34,0)
 .I $G(PSGPXN) I $P(PSJSYSW0,U,29)]""!($G(PSJCOM)) S PSGPXPT=PSGP D  K PSGPXPT S PSGPXN=0
"RTN","PSJOE",35,0)
 ..N DFN,PSGP,PSJPXDP
"RTN","PSJOE",36,0)
 ..I $P(PSJSYSW0,U,29)="" S PSJPDXP=1 D
"RTN","PSJOE",37,0)
 ...;N IO,ION,IOS D HOME^%ZIS S $P(PSJSYSW0,U,29)=+$G(IOS)
"RTN","PSJOE",38,0)
 ...D HOME^%ZIS S $P(PSJSYSW0,U,29)=+$G(IOS)
"RTN","PSJOE",39,0)
 ..S (PSGP,DFN)=PSGPXPT D ^PSGPER S:$G(PSJPDXP) $P(PSJSYSW0,U,29)="" K PSJPDXP
"RTN","PSJOE",40,0)
 .D ENCV^PSGSETU,^PSIVXU
"RTN","PSJOE",41,0)
 K PSJLMPRO,^TMP("PSJPRO",$J),^TMP("PSJ",$J),^TMP("PSJON",$J)
"RTN","PSJOE",42,0)
DONE ;
"RTN","PSJOE",43,0)
 ; -- RTC 198753 - correct typo - r PSJALGSV w PSJAGYSV
"RTN","PSJOE",44,0)
 K PSJAGYSV,PSJEXCPT,PSJOCER,^TMP($J,"PSJPRE"),^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J)
"RTN","PSJOE",45,0)
 K AC,ACTION,D1,D2,MI,N,ON,P3,PNOW,PSIVAT,PSIVLN,PSIVSTR L -^PS(53.45,PSJSYSP)
"RTN","PSJOE",46,0)
 K DA,DRG,NE,PSGCF,PSGCANFL,PSGNEDFD,PSGNEF,PSGNEFD,PSGNEPR,PSGNESD,PSJACOK,PSJOE,PSJOECNT,PSJOEPF,PSJORD,PSGOEA,PSGOEAV,PSGOL,PSGOS,PSGON,PSGOP,PSGORD,PSGS0XT,PSGS0Y,RCT,ST,WD,XREF,Z,PSJIVORF,PSJIVPCL
"RTN","PSJOE",47,0)
 K PSGOEORF,PSIVREA,PSJOPC,PSJORL,PSJORPCL,PSJORTOI,RF,WSCHADM,PSJLM,PSJCT
"RTN","PSJOE",48,0)
 K DIU,DRGI,FLAG,FQC,ND2,PRI,PSGOE,PSGPRI,PSGSDN,PSGOEDMR,PSGOEPR,PSGPTS,PSGTOL,PSGTOO,PSGUOW,PSJIVOF,PSJOCNT,PSJON,PSJORQF,PSJORTOU,PSJORVP
"RTN","PSJOE",49,0)
 K PSIVENO,PSGRMV,PSGRMVT,PSGDUR,PSGRF,ND2P1 ;*315
"RTN","PSJOE",50,0)
 G:$G(PSGPXN) ^PSGPER1 D ENIVKV^PSGSETU
"RTN","PSJOE",51,0)
 Q
"RTN","PSJOE",52,0)
HK ; Housekeeping (a nice COBOL term)
"RTN","PSJOE",53,0)
 I PSGOP,PSGOP'=PSGP D
"RTN","PSJOE",54,0)
 .N PSJACPF,PSJACNWP,PSJPWD,PSJSYSL,PSJSYSW,PSJSYSW0,DFN,VAIN,VAERR S DFN=PSGOP
"RTN","PSJOE",55,0)
 .D INP^VADPT S PSJPWD=+VAIN(4) I PSJPWD S PSJACPF=10 D WP^PSJAC D:$P(PSJSYSL,"^",2)]"" ENQL^PSGLW
"RTN","PSJOE",56,0)
 Q:PSGP<0
"RTN","PSJOE",57,0)
 S (DFN,PSGOP)=PSGP,X=""
"RTN","PSJOE",58,0)
 Q
"RTN","PSJOE",59,0)
SELECT ; Select order from list
"RTN","PSJOE",60,0)
 ;Variable PSJOCDSC is used in Complex order dosing checks
"RTN","PSJOE",61,0)
 N PSGLMT,PSGODDD,PSJLMQT,PSJLMFIN,PSJUDPRF,PSGRDTX,PSJOCDSC,PSJAGYSV K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J),PSJSTARI,^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J)
"RTN","PSJOE",62,0)
 K PSGDUR,PSGRMVT,PSGRMV,PSGRF,ND2P1 ;*315
"RTN","PSJOE",63,0)
 S PSGONC=1,PSGLMT=^TMP("PSJPRO",$J,0) D ENASR^PSGON
"RTN","PSJOE",64,0)
 I "^"[X S VALMQUIT=1 Q
"RTN","PSJOE",65,0)
 S PSJLM=1,PSJSEL=0 F  S PSJSEL=$O(PSGODDD(PSJSEL)) Q:'PSJSEL!($G(Y)<0)  F PSJSEL1=1:1:$L(PSGODDD(PSJSEL),",")-1 D
"RTN","PSJOE",66,0)
 .K PSJOCDSC
"RTN","PSJOE",67,0)
 .S PSJORD=$G(^TMP("PSJON",$J,+$P(PSGODDD(PSJSEL),",",PSJSEL1))) D:PSJORD=+PSJORD SELECT^PSJOEA Q:PSJORD=""!($G(Y)<0)  Q:PSJORD=+PSJORD  D
"RTN","PSJOE",68,0)
 ..Q:('$$LS^PSSLOCK(PSGP,PSJORD))
"RTN","PSJOE",69,0)
 ..Q:PSJORD=+PSJORD
"RTN","PSJOE",70,0)
 ..S PSGORD=""
"RTN","PSJOE",71,0)
 ..D DISACTIO(PSGP,PSJORD,"") S:PSJORD["V" PSJORD=ON
"RTN","PSJOE",72,0)
 ..D UNL^PSSLOCK(PSGP,PSJORD) Q:$G(Y)<0
"RTN","PSJOE",73,0)
 S VALMBCK="Q"
"RTN","PSJOE",74,0)
 K PSJLM,PSJOCDSC
"RTN","PSJOE",75,0)
 Q
"RTN","PSJOE",76,0)
DISACTIO(DFN,PSJORD,PSJPNV)       ; Display UD order and allow actions.
"RTN","PSJOE",77,0)
 ; PSJORD - Order #_location Code (P:53.1,V:55.01,U:55.06)
"RTN","PSJOE",78,0)
 ; PSJPNV - Invoked from Pending/NV option; (gets different hidden menu)
"RTN","PSJOE",79,0)
 ; PSJDSVFY - Flag if non-vf order was edited
"RTN","PSJOE",80,0)
 ; PSJENHOC=1 if DI,DT were display. This will be used by dosing OC to check if error messages should display or not
"RTN","PSJOE",81,0)
 ; PSJAGYSV=1 If UD was edited
"RTN","PSJOE",82,0)
 ;N PSGP,PSJIVFLG,PSGSDX,PSGFDX,PSJXX1,ON55,PSJDSVFY,PSJENHOC,PSJAGYSV
"RTN","PSJOE",83,0)
 N PSGP,PSJIVFLG,PSGSDX,PSGFDX,PSJXX1,ON55,PSJDSVFY,PSJENHOC,PSIVENO,PSJBACK
"RTN","PSJOE",84,0)
 K PSGDUR,PSGRMVT,PSGRMV,PSGRF,ND2P1 ;*315
"RTN","PSJOE",85,0)
 K PSJEXCPT("PROSPECTIVE") ;*256
"RTN","PSJOE",86,0)
 D OLDCOM^PSJOE0(DFN,PSJORD)
"RTN","PSJOE",87,0)
 S PSGP=DFN D ENIV^PSJAC I PSJORD["V" D EN^PSJLIORD(DFN,PSJORD) Q
"RTN","PSJOE",88,0)
 D GETUD^PSJLMGUD(DFN,PSJORD)
"RTN","PSJOE",89,0)
 S PSGOEAV=$P(PSJSYSP0,"^",9)&PSJSYSU
"RTN","PSJOE",90,0)
 S:$G(PSJTUD) PSGPD=$G(PSJCOI),PSGPDN=$$OINAME^PSJLMUTL(+PSGPD)
"RTN","PSJOE",91,0)
 K PSGOENG I '$D(PSGPRF) D  Q:$G(PSGOENG)
"RTN","PSJOE",92,0)
 . I PSJORD["U" L +^PS(55,PSGP,5,+PSJORD):1 E  S PSGOENG=1
"RTN","PSJOE",93,0)
 . I PSJORD["P" L +^PS(53.1,+PSJORD):1 E  S PSGOENG=1
"RTN","PSJOE",94,0)
 . I $G(PSGOENG) W !,"This order is being edited by another terminal.",! S PSGOENG=1 K DIR S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSJOE",95,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSJORD)
"RTN","PSJOE",96,0)
 I PSJORD["P" S PSJXX1=$G(^PS(53.1,+PSJORD,0)) I PSGP'=$P(PSJXX1,U,15)!(DFN'=$P(PSJXX1,U,15)) L -^PS(53.1,+PSJORD) Q
"RTN","PSJOE",97,0)
 I PSJORD["P" D  S PSJXX1=$P($G(^PS(53.1,+PSJORD,0)),U,9) I $S($G(PSJIVFLG):1,$G(Y)<0:1,"PADE"[PSJXX1:1,1:0) L -^PS(53.1,+PSJORD) Q
"RTN","PSJOE",98,0)
 .K:$P($G(PSJXX1),U,4)="U" PSIVFLG ;p344
"RTN","PSJOE",99,0)
 .I $P(PSJXX1,U,9)="N",($P(PSJXX1,U,4)'="U") D  Q
"RTN","PSJOE",100,0)
 .. S P("PON")=PSJORD,PSIVFLG=1
"RTN","PSJOE",101,0)
 .. N ON S ON=PSJORD D VF^PSIVORC2
"RTN","PSJOE",102,0)
 .I $P(PSJXX1,U,9)="P" D  Q
"RTN","PSJOE",103,0)
 ..S:$G(PSJTUD) $P(PSJXX1,U,4)="U"
"RTN","PSJOE",104,0)
 ..I $P(PSJXX1,U,4)="U" D  Q:$G(PSJIVFLG)
"RTN","PSJOE",105,0)
 ... N VAIP S CLINIC=$G(^PS(53.1,+PSJORD,"DSS")),APPT=$P(CLINIC,"^",2),CLINIC=$P(CLINIC,"^") I $$PATCH^XPDUTL("SD*5.3*285") S PSJBACK=$$SDIMO^SDAMA203(CLINIC,DFN) I PSJBACK'<-1 Q
"RTN","PSJOE",106,0)
 ... Q:'PSJPDD  W !!,"Cannot process an Out-patient Unit Dose order for ",$P($G(^DPT(+PSGP,0)),U) D PAUSE^VALM1 S PSJIVFLG=1
"RTN","PSJOE",107,0)
 ..NEW PSGRSD,PSGRSDN,PSGRFD,PSGRFDN
"RTN","PSJOE",108,0)
 ..D REQDT^PSJLIVMD(PSJORD)
"RTN","PSJOE",109,0)
 ..I $P(PSJXX1,U,4)="U",($G(PSGSCH)="") W !!,"Invalid schedule, can't finish this order" D PAUSE^VALM1 Q
"RTN","PSJOE",110,0)
 ..I $P(PSJXX1,U,4)="U" N PSJLM,PSJOCFG S PSJLM=1,PSGORD=PSJORD,PSJOCFG="FN UD" D START^PSGOEF,ENSFE^PSGOEE0(PSGP,PSGORD) S:$G(PSJTUD) PSJOCFG="FN UD" D @$S($G(PSJTUD):"FINISH^PSGOEF",1:"EN^VALM(""PSJ LM PENDING EDIT"")") K PSJOCFG Q
"RTN","PSJOE",111,0)
 ..I $P(PSJXX1,U,4)'="U",PSGP=$P(PSJXX1,U,15),DFN=$P(PSJXX1,U,15) S PSJLYN=PSJORD,PSJOCFG="FN IV" D EN^PSJLIFN S PSJIVFLG=1 K PSJLYN,PSJMAI,PSJOCFG
"RTN","PSJOE",112,0)
 I $G(PSIVFLG) K PSIVFLG Q
"RTN","PSJOE",113,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSJORD),PSGOEEF=0 D GETUD^PSJLMGUD(PSGP,PSJORD),ENSFE^PSGOEE0(PSGP,PSJORD),EN^VALM("PSJ LM UD ACTION")
"RTN","PSJOE",114,0)
 I PSJORD["P" L -^PS(53.1,+PSJORD)
"RTN","PSJOE",115,0)
 I PSJORD["U" L -^PS(55,PSGP,5,+PSJORD)
"RTN","PSJOE",116,0)
 ;Send SN to CPRS if auto-verify OFF and Order Set Entry and no 21st piece
"RTN","PSJOE",117,0)
 S PSGOEAV=$P(PSJSYSP0,"^",9)&PSJSYSU
"RTN","PSJOE",118,0)
 I $D(PSGOES),'PSGOEAV,$D(PSGORD),PSGORD["P",$P($G(^PS(53.1,+PSGORD,0)),"^",21)']"" D ORSET^PSGOETO1
"RTN","PSJOE",119,0)
 I $G(PSGOEAV),($G(PSGOES)=1) D SETOC ;Store allergy for order set /w auto vf 
"RTN","PSJOE",120,0)
 I '$G(PSGOEAV),($G(PSJORD)["P"),$S($G(PSJAGYSV):1,($G(PSJOCFG)="NEW UD"):1,1:0) D SETOC
"RTN","PSJOE",121,0)
 ; -- RTC 236646
"RTN","PSJOE",122,0)
 K ^TMP("PSODAOC",$J,"ALLERGY")
"RTN","PSJOE",123,0)
 D UNL^PSSLOCK(PSGP,PSJORD)
"RTN","PSJOE",124,0)
 Q
"RTN","PSJOE",125,0)
SETOC ;
"RTN","PSJOE",126,0)
 ;RTC 178789 
"RTN","PSJOE",127,0)
 S ^TMP("PSODAOC",$J,"IP IEN")=PSJORD
"RTN","PSJOE",128,0)
 D SETOC^PSJNEWOC(PSJORD)
"RTN","PSJOE",129,0)
 K ^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J),PSJAGYSV,PSJOCFG
"RTN","PSJOE",130,0)
 Q
"RTN","PSJOE",131,0)
EDIT(PSGP,PSGORD,PROMPT) ;
"RTN","PSJOE",132,0)
 I "DE"[$$GTSTATUS(PSGP,PSGORD) W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJOE",133,0)
 I PSGACT'["E" W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJOE",134,0)
 N PSJEDITO S PSJEDITO=1
"RTN","PSJOE",135,0)
 S PSJAGYSV=1 ;Flag to store allergy data in 100.05.
"RTN","PSJOE",136,0)
 S PSGNEDFD="" D HOLDHDR,@$S('PROMPT:"ENEFA2^PSGON",1:"ENEFA^PSGON") I 'Y D ABORT^PSGOEE Q
"RTN","PSJOE",137,0)
 I PSGORD["P" D ENF^PSGOEE Q
"RTN","PSJOE",138,0)
 D ACT^PSGOEE
"RTN","PSJOE",139,0)
 Q
"RTN","PSJOE",140,0)
RENEW(PSGP,PSGORD) ;
"RTN","PSJOE",141,0)
 ;PSJOCFG - If defined, it's for new order, renew or copy. ^PSJOCDSD using this flag to not display drug error.
"RTN","PSJOE",142,0)
 NEW PSJOCFG
"RTN","PSJOE",143,0)
 S PSJOCFG="RENEW UD"
"RTN","PSJOE",144,0)
 D HOLDHDR
"RTN","PSJOE",145,0)
 I 'PSJSYSU,$P($G(^PS(55,PSGP,5,+PSGORD,4)),U,15),$P($G(^(4)),U,16) W !!,"This order is already marked for renewal!" D PAUSE^VALM1 S VALMBCK="R" Q
"RTN","PSJOE",146,0)
 I 'PSGRRF D ^PSGOER K PSJOCFG Q
"RTN","PSJOE",147,0)
 D ^PSGOERI
"RTN","PSJOE",148,0)
 K PSJOCFG
"RTN","PSJOE",149,0)
 Q
"RTN","PSJOE",150,0)
GTSTATUS(DFN,ON)   ;
"RTN","PSJOE",151,0)
 I ON["P" Q $P($G(^PS(53.1,+ON,0)),U,9)
"RTN","PSJOE",152,0)
 I ON["U" Q $P($G(^PS(55,DFN,5,+ON,0)),U,9)
"RTN","PSJOE",153,0)
 Q $P($G(^PS(55,DFN,"IV",+ON,0)),U,17)
"RTN","PSJOE",154,0)
DC(DFN,PSJORD) ; DC IV, UD, or pending orders.
"RTN","PSJOE",155,0)
 D HOLDHDR
"RTN","PSJOE",156,0)
 S X=$$GTSTATUS(DFN,PSJORD) I X="D"!(X="DE")!(X="R") W !,$S(X="R":"This order has a pending renewal and cannot be DISCONTINUED.",1:"This order has already been DISCONTINUED.") D PAUSE^VALM1 Q
"RTN","PSJOE",157,0)
 D ENO^PSGOEC(DFN,PSJORD) ;,GETUD^PSJLMGUD(DFN,PSJORD),INIT^PSJLMUDE(DFN,PSJORD) S VALMBCK="Q"
"RTN","PSJOE",158,0)
 S VALMBCK="Q"
"RTN","PSJOE",159,0)
 Q
"RTN","PSJOE",160,0)
HOLD(DFN,PSJORD) ; Change order's status from ACTIVE<->HOLD
"RTN","PSJOE",161,0)
 D HOLDHDR
"RTN","PSJOE",162,0)
 I PSJORD["V" D H^PSIVOPT(DFN,PSJORD,P(17),P(3))
"RTN","PSJOE",163,0)
 I PSJORD'["V" D H^PSGOE1(DFN,PSJORD)
"RTN","PSJOE",164,0)
 D GETUD^PSJLMGUD(DFN,PSJORD),INIT^PSJLMUDE(DFN,PSJORD) S PSGACT=$$ENACTION^PSGOE1(DFN,PSJORD),VALMBCK="R"
"RTN","PSJOE",165,0)
 Q
"RTN","PSJOE",166,0)
COPY(PSGP,PSGORD)  ; Copy an order (does not discontinue original order)
"RTN","PSJOE",167,0)
 NEW PSJOCFG
"RTN","PSJOE",168,0)
 I $D(PSGCOPY) W !!,"You cannot copy the order at this time" D PAUSE^VALM1 Q
"RTN","PSJOE",169,0)
 I PSGORD["P" W !!,"You cannot copy this "_$S($G(PSGSTAT)]"":PSGSTAT,1:"PENDING IV")_" order." D PAUSE^VALM1 Q
"RTN","PSJOE",170,0)
 I PSGORD["V" D  Q
"RTN","PSJOE",171,0)
 .I $G(PSIVCOPY) W !!,"You cannot copy the order at this time" D PAUSE^VALM1 Q
"RTN","PSJOE",172,0)
 .S PSJOCFG="COPY IV"
"RTN","PSJOE",173,0)
 .D COPY^PSIVOD(PSGP,PSGORD) K PSJOCFG Q
"RTN","PSJOE",174,0)
 Q:'$$HIDDEN^PSJLMUTL("COPY")
"RTN","PSJOE",175,0)
 D ^PSJHVARS
"RTN","PSJOE",176,0)
 I $P($G(^PS(55,PSGP,5,+PSGORD,.2)),U,4)="D",'$P($G(^(4)),"^",3) W !!,"Nurse verified orders with a priority of DONE may not be Copied." D PAUSE^VALM1 Q
"RTN","PSJOE",177,0)
 S PSJOCFG="COPY UD"
"RTN","PSJOE",178,0)
 S PSGOEAV=$P(PSJSYSP0,U,9)&PSJSYSU
"RTN","PSJOE",179,0)
 S PSGCOPY=1
"RTN","PSJOE",180,0)
 D FULL^VALM1,^PSGOD
"RTN","PSJOE",181,0)
 S VALMBCK="R"
"RTN","PSJOE",182,0)
 K PSGCOPY,PSJOCFG
"RTN","PSJOE",183,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSGORD) ; resets PSGACT after copy
"RTN","PSJOE",184,0)
 I $G(PSGPXN) N PSGTMPXN S PSGTMPXN=PSGPXN
"RTN","PSJOE",185,0)
 D RESTORE^PSJHVARS I $G(PSGTMPXN) S PSGPXN=PSGTMPXN
"RTN","PSJOE",186,0)
 Q
"RTN","PSJOE",187,0)
UPDATE ; Refresh array, actions, & display.
"RTN","PSJOE",188,0)
 D GETUD^PSJLMGUD(DFN,ON),INIT^PSJLMUDE(DFN,ON) S VALMBCK="R"
"RTN","PSJOE",189,0)
 Q
"RTN","PSJOE",190,0)
FINISH ;
"RTN","PSJOE",191,0)
 D FINISH^PSGOEF,PAUSE^VALM1
"RTN","PSJOE",192,0)
 Q
"RTN","PSJOE",193,0)
LOG(DFN,PSGORD)        ;
"RTN","PSJOE",194,0)
 D FULL^VALM1,ENLM^PSGOEL(DFN,PSGORD),PAUSE^VALM1 S VALMBCK="R"
"RTN","PSJOE",195,0)
 Q
"RTN","PSJOE",196,0)
NEWSEL ;
"RTN","PSJOE",197,0)
 N PSGLMT,PSGODDD,PSJLMQT,PSJLMFIN,PSJUDPRF,PSGRDTX,PSJOCDSC,PSJAGYSV K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J),^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J)
"RTN","PSJOE",198,0)
 K PSGRMVT,PSGRMV,PSGDUR,PSGRF,ND2P1,PSGOROE1
"RTN","PSJOE",199,0)
 S X=$P(XQORNOD(0),"=",2)
"RTN","PSJOE",200,0)
 S PSGONC=1,PSGLMT=^TMP("PSJPRO",$J,0)
"RTN","PSJOE",201,0)
 D ENCHK^PSGON I '$O(PSGODDD(0)) S VALMQUIT=1 Q
"RTN","PSJOE",202,0)
 S PSJLM=1,PSJSEL=0 F  S PSJSEL=$O(PSGODDD(PSJSEL)) Q:'PSJSEL  F PSJSEL1=1:1:$L(PSGODDD(PSJSEL),",")-1 D
"RTN","PSJOE",203,0)
 .K PSJOCDSC
"RTN","PSJOE",204,0)
 .S PSJORD=$G(^TMP("PSJON",$J,+$P(PSGODDD(PSJSEL),",",PSJSEL1))) D:PSJORD=+PSJORD SELECT^PSJOEA
"RTN","PSJOE",205,0)
 .Q:PSJORD=+PSJORD 
"RTN","PSJOE",206,0)
 .Q:PSJORD=""!($G(Y)<0)  Q:('$$LS^PSSLOCK(PSGP,PSJORD))  D
"RTN","PSJOE",207,0)
 ..S PSGORD=""
"RTN","PSJOE",208,0)
 ..S ON=PSJORD
"RTN","PSJOE",209,0)
 ..D DISACTIO(PSGP,PSJORD,$G(PSJPNV)) S:PSJORD["V" PSJORD=ON
"RTN","PSJOE",210,0)
 ..D UNL^PSSLOCK(PSGP,PSJORD)
"RTN","PSJOE",211,0)
 ..I $G(PSJNOL) K PSJNOL I $D(ON),ON'=PSJORD D UNL^PSSLOCK(PSGP,ON)
"RTN","PSJOE",212,0)
 ..Q:$G(Y)<0
"RTN","PSJOE",213,0)
 I '$G(PSGOEAV),($G(PSJORD)["P"),$G(PSJAGYSV) D
"RTN","PSJOE",214,0)
 .;RTC 178789 
"RTN","PSJOE",215,0)
 .S ^TMP("PSODAOC",$J,"IP IEN")=PSJORD
"RTN","PSJOE",216,0)
 .D SETOC^PSJNEWOC(PSJORD)
"RTN","PSJOE",217,0)
 .K ^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J),PSJAGYSV
"RTN","PSJOE",218,0)
 S VALMBCK="Q"
"RTN","PSJOE",219,0)
 K PSJLM,PSJOCDSC
"RTN","PSJOE",220,0)
 Q
"RTN","PSJOE",221,0)
HOLDHDR ; Freeze header text while processing order actions
"RTN","PSJOE",222,0)
 I $D(VALM("TM")) S IOTM=VALM("TM"),IOBM=IOSL W IOSC W @IOSTBM W IORC
"RTN","PSJOE",223,0)
 Q
"RTN","PSJOE",224,0)
LOCKERR ;
"RTN","PSJOE",225,0)
 W !!,$C(7),"You are entering or editing an Inpatient Medication order in another session.",!,"Only one order entry/edit session is allowed for a user at a time.",!! N DIR S DIR(0)="E" D ^DIR
"RTN","PSJOE",226,0)
 Q
"RTN","PSJOE",227,0)
FLAG(DFN,PSJORD) ;Flag order through CPRS entry point.
"RTN","PSJOE",228,0)
 N ORIFN,NODE0
"RTN","PSJOE",229,0)
 S NODE0=$S(PSJORD["V":$G(^PS(55,DFN,"IV",+PSJORD,0)),PSJORD["U":$G(^PS(55,DFN,5,+PSJORD,0)),1:^PS(53.1,+PSJORD,0))
"RTN","PSJOE",230,0)
 S ORIFN=$P(NODE0,"^",21)
"RTN","PSJOE",231,0)
 D EN1^ORCFLAG(ORIFN)
"RTN","PSJOE",232,0)
 D PAUSE^VALM1
"RTN","PSJOE",233,0)
 Q
"RTN","PSJOE",234,0)
COMPLEX(DFN,ON) ;
"RTN","PSJOE",235,0)
 N NDP2,COM
"RTN","PSJOE",236,0)
 S NDP2=$S(ON["P":$G(^PS(53.1,+ON,.2)),ON["U":$G(^PS(55,DFN,5,+ON,.2)),ON["V":$G(^PS(55,DFN,"IV",+ON,.2)),1:"")
"RTN","PSJOE",237,0)
 S COM=$P(NDP2,"^",8) I COM Q 1
"RTN","PSJOE",238,0)
 Q 0
"VER")
8.0^22.2
"BLD",10741,6)
^314
**END**
**END**

