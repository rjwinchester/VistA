Released PSJ*5*335 SEQ #294
Extracted from mail message
**KIDS**:PSJ*5.0*335^

**INSTALL NAME**
PSJ*5.0*335
"BLD",10378,0)
PSJ*5.0*335^INPATIENT MEDICATIONS^0^3170919^y
"BLD",10378,1,0)
^^7^7^3170712^^
"BLD",10378,1,1,0)
This patch will resolve the following issues:
"BLD",10378,1,2,0)
 
"BLD",10378,1,3,0)
1.  Pending renewal shows dose of original order
"BLD",10378,1,4,0)
2.  Clinic Order cross-references not being set correctly
"BLD",10378,1,5,0)
3.  Major latency when running PSJ EXP on Clinics
"BLD",10378,1,6,0)
4.  PADE TRANSACTION REPORTS WONT FIND CS DRUG TRANSACTIONS THAT ARE
"BLD",10378,1,7,0)
    UNMATCHED TO THE NDF
"BLD",10378,4,0)
^9.64PA^^
"BLD",10378,6.3)
6
"BLD",10378,"KRN",0)
^9.67PA^779.2^20
"BLD",10378,"KRN",.4,0)
.4
"BLD",10378,"KRN",.401,0)
.401
"BLD",10378,"KRN",.402,0)
.402
"BLD",10378,"KRN",.403,0)
.403
"BLD",10378,"KRN",.5,0)
.5
"BLD",10378,"KRN",.84,0)
.84
"BLD",10378,"KRN",3.6,0)
3.6
"BLD",10378,"KRN",3.8,0)
3.8
"BLD",10378,"KRN",9.2,0)
9.2
"BLD",10378,"KRN",9.8,0)
9.8
"BLD",10378,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",10378,"KRN",9.8,"NM",1,0)
PSIVORFB^^0^B87405033
"BLD",10378,"KRN",9.8,"NM",2,0)
PSJIMO1^^0^B68663618
"BLD",10378,"KRN",9.8,"NM",3,0)
PSJEXP^^0^B46184358
"BLD",10378,"KRN",9.8,"NM",4,0)
PSJPDRIN^^0^B224024675
"BLD",10378,"KRN",9.8,"NM","B","PSIVORFB",1)

"BLD",10378,"KRN",9.8,"NM","B","PSJEXP",3)

"BLD",10378,"KRN",9.8,"NM","B","PSJIMO1",2)

"BLD",10378,"KRN",9.8,"NM","B","PSJPDRIN",4)

"BLD",10378,"KRN",19,0)
19
"BLD",10378,"KRN",19.1,0)
19.1
"BLD",10378,"KRN",101,0)
101
"BLD",10378,"KRN",409.61,0)
409.61
"BLD",10378,"KRN",771,0)
771
"BLD",10378,"KRN",779.2,0)
779.2
"BLD",10378,"KRN",870,0)
870
"BLD",10378,"KRN",8989.51,0)
8989.51
"BLD",10378,"KRN",8989.52,0)
8989.52
"BLD",10378,"KRN",8994,0)
8994
"BLD",10378,"KRN","B",.4,.4)

"BLD",10378,"KRN","B",.401,.401)

"BLD",10378,"KRN","B",.402,.402)

"BLD",10378,"KRN","B",.403,.403)

"BLD",10378,"KRN","B",.5,.5)

"BLD",10378,"KRN","B",.84,.84)

"BLD",10378,"KRN","B",3.6,3.6)

"BLD",10378,"KRN","B",3.8,3.8)

"BLD",10378,"KRN","B",9.2,9.2)

"BLD",10378,"KRN","B",9.8,9.8)

"BLD",10378,"KRN","B",19,19)

"BLD",10378,"KRN","B",19.1,19.1)

"BLD",10378,"KRN","B",101,101)

"BLD",10378,"KRN","B",409.61,409.61)

"BLD",10378,"KRN","B",771,771)

"BLD",10378,"KRN","B",779.2,779.2)

"BLD",10378,"KRN","B",870,870)

"BLD",10378,"KRN","B",8989.51,8989.51)

"BLD",10378,"KRN","B",8989.52,8989.52)

"BLD",10378,"KRN","B",8994,8994)

"BLD",10378,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",10378,"QUES",0)
^9.62^^
"BLD",10378,"REQB",0)
^9.611^4^4
"BLD",10378,"REQB",1,0)
PSJ*5.0*307^2
"BLD",10378,"REQB",2,0)
PSJ*5.0*323^2
"BLD",10378,"REQB",3,0)
PSJ*5.0*328^2
"BLD",10378,"REQB",4,0)
PSJ*5.0*317^2
"BLD",10378,"REQB","B","PSJ*5.0*307",1)

"BLD",10378,"REQB","B","PSJ*5.0*317",4)

"BLD",10378,"REQB","B","PSJ*5.0*323",2)

"BLD",10378,"REQB","B","PSJ*5.0*328",3)

"MBREQ")
0
"PKG",471,-1)
1^1
"PKG",471,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",471,20,0)
^9.402P^^
"PKG",471,22,0)
^9.49I^1^1
"PKG",471,22,1,0)
5.0^2971215^2990325^66481
"PKG",471,22,1,"PAH",1,0)
335^3170919
"PKG",471,22,1,"PAH",1,1,0)
^^7^7^3170919
"PKG",471,22,1,"PAH",1,1,1,0)
This patch will resolve the following issues:
"PKG",471,22,1,"PAH",1,1,2,0)
 
"PKG",471,22,1,"PAH",1,1,3,0)
1.  Pending renewal shows dose of original order
"PKG",471,22,1,"PAH",1,1,4,0)
2.  Clinic Order cross-references not being set correctly
"PKG",471,22,1,"PAH",1,1,5,0)
3.  Major latency when running PSJ EXP on Clinics
"PKG",471,22,1,"PAH",1,1,6,0)
4.  PADE TRANSACTION REPORTS WONT FIND CS DRUG TRANSACTIONS THAT ARE
"PKG",471,22,1,"PAH",1,1,7,0)
    UNMATCHED TO THE NDF
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSIVORFB")
0^1^B87405033^B86884261
"RTN","PSIVORFB",1,0)
PSIVORFB ;BIR/MLM - FILE/RETRIEVE ORDERS IN ^PS(55 ;25 Sep 98 / 2:24 PM
"RTN","PSIVORFB",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**3,18,28,68,58,85,110,111,120,134,213,161,181,273,267,285,257,299,323,335**;16 DEC 97;Build 6
"RTN","PSIVORFB",3,0)
 ;
"RTN","PSIVORFB",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA #2180.
"RTN","PSIVORFB",5,0)
 ; Reference to ^PS(51.2 is supported by DBIA #2178.
"RTN","PSIVORFB",6,0)
 ; Reference to ^PS(52.6 is supported by DBIA #1231.
"RTN","PSIVORFB",7,0)
 ; Reference to ^PS(52.7 is supported by DBIA #2173.
"RTN","PSIVORFB",8,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSIVORFB",9,0)
 ; Reference to ^PS(51.1 is supported by DBIA #2177.
"RTN","PSIVORFB",10,0)
 ; Reference to ^PSUHL is supported by DBIA #4803.
"RTN","PSIVORFB",11,0)
 ; 
"RTN","PSIVORFB",12,0)
NEW55 ; Get new order number in 55.
"RTN","PSIVORFB",13,0)
 N DA,DD,DO,DIC,DLAYGO,X,Y,PSIVLIM,MINS,PSJDSTP1,PSJDSTP2,A,PSJCLIN,PSJDNM,PSJPROV,PSJWARD,PSJPAO,PSJALRT
"RTN","PSIVORFB",14,0)
 I ($G(PSIVAC)="PN"),$G(PSJSYSP) D KILL^PSJBCMA5(+$G(PSJSYSP))
"RTN","PSIVORFB",15,0)
 I $D(^PS(55,+DFN)),'$D(^PS(55,+DFN,0)) D ENSET0^PSGNE3(+DFN)
"RTN","PSIVORFB",16,0)
 ;*273 - Set PSIVSITE if not set.
"RTN","PSIVORFB",17,0)
 I $G(PSJORD)["V"!($G(PSJORD)["P"),$G(P(2))]"" D
"RTN","PSIVORFB",18,0)
 . I '$G(PSIVSITE) S PSIVSN=$P(P("IVRM"),"^") D ENCHK^PSIVSET
"RTN","PSIVORFB",19,0)
 . D LIMSTOP(.PSJDSTP1,.PSJDSTP2)
"RTN","PSIVORFB",20,0)
 I ($G(PSJORD)["P"!($G(PSJORD)["V"))&$G(PSIVLIM) I $$CMPLIM(PSJORD,PSJDSTP1,PSJDSTP2) D
"RTN","PSIVORFB",21,0)
 . D
"RTN","PSIVORFB",22,0)
 .. S PSJPROV=DUZ I PSJORD["P" S PSJPROV=$P($G(^PS(53.1,+PSJORD,0)),"^",2)
"RTN","PSIVORFB",23,0)
 .. I PSJORD["V" S PSJPROV=$P($G(^PS(55,DFN,"IV",+PSJORD,0)),"^",6)
"RTN","PSIVORFB",24,0)
 .. D NOW^%DTC S XQA(PSJPROV)="",XQAID="PSJ,"_DFN_";"_PSJPROV_";"_%,XQADATA=""
"RTN","PSIVORFB",25,0)
 .. D
"RTN","PSIVORFB",26,0)
 ... I PSJORD["P" S A=$G(^PS(53.1,+PSJORD,"DSS"))
"RTN","PSIVORFB",27,0)
 ... I PSJORD["V" S A=$G(^PS(55,PSGP,"IV",+PSJORD,"DSS"))
"RTN","PSIVORFB",28,0)
 ... S PSJCLIN=$P(A,"^") I PSJCLIN]"" S PSJCLIN=$P(^SC(PSJCLIN,0),"^")
"RTN","PSIVORFB",29,0)
 .. S A=$G(^DPT(DFN,0)),PSJWARD=$G(^(.1))
"RTN","PSIVORFB",30,0)
 .. S XQAMSG=$P(A,"^")_" ("_$E($P(A,"^"))_$E($P(A,"^",9),6,9)_"): ["_$S(PSJWARD]"":$E(PSJWARD,1,10),$G(PSJCLIN)]"":$E(PSJCLIN,1,10),1:"UNKNOWN")_"] "
"RTN","PSIVORFB",31,0)
 .. S A=$O(DRG("AD",0)) I A]"" S A=DRG("AD",A)
"RTN","PSIVORFB",32,0)
 .. I A="" S A=$O(DRG("SOL",0)) I A]"" S A=DRG("SOL",A)
"RTN","PSIVORFB",33,0)
 .. S PSJDNM=$P(^PS(50.7,+$P(A,"^",6),0),"^")
"RTN","PSIVORFB",34,0)
 .. S XQAMSG=XQAMSG_PSJDNM_" your DURATION not used for stop date/time"
"RTN","PSIVORFB",35,0)
 .. D SETUP^XQALERT
"RTN","PSIVORFB",36,0)
 .. S PSJALRT=$$FMTDUR^PSJLIVMD($S(PSJORD["P":$P($G(^PS(53.1,+PSJORD,2.5)),"^",4),PSJORD["IV":$P($G(^PS(55,DFN,"IV",+PSJORD,2.5)),"^",4),1:"UNK"))
"RTN","PSIVORFB",37,0)
 S DIC="^PS(55,",DIC(0)="LN",DLAYGO=55,(DINUM,X)=+DFN D ^DIC Q:Y<0
"RTN","PSIVORFB",38,0)
LOCK0 F  L +^PS(55,DFN,"IV",0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSIVORFB",39,0)
 S ND=$S($D(^PS(55,DFN,"IV",0)):^(0),1:"^55.01") F DA=$P(ND,"^",3)+1:1 W "." I '$D(^PS(55,DFN,"IV",DA)) S $P(ND,"^",3)=DA,$P(ND,"^",4)=$P(ND,"^",4)+1,^PS(55,DFN,"IV",0)=ND Q
"RTN","PSIVORFB",40,0)
 L +^PS(55,DFN,"IV",+DA):$S($G(DILOCKTM)>0:DILOCKTM,1:3) E  G LOCK0
"RTN","PSIVORFB",41,0)
 S ^PS(55,DFN,"IV",+DA,0)=+DA,^PS(55,DFN,"IV","B",+DA,+DA)=""
"RTN","PSIVORFB",42,0)
 L -^PS(55,DFN,"IV",0) S ON55=+DA_"V"
"RTN","PSIVORFB",43,0)
 I $G(PSJALRT)]"" S PSIVAL="IV LIMIT OVERRIDDEN ("_$G(PSJALRT)_"): ALERT SENT",PSIVALT="",PSIVREA="E" D
"RTN","PSIVORFB",44,0)
 .D LOG^PSIVORAL S P("LIMIT")="",P("OVRIDE")=1 K IVLIM,IVLIMIT
"RTN","PSIVORFB",45,0)
 .S $P(^PS(55,DFN,"IV",+ON55,2.5),"^",4)="" S:$G(PSJORD)["P" $P(^PS(53.1,+PSJORD,2.5),"^",4)=""
"RTN","PSIVORFB",46,0)
 .K PSIVAL,PSIVREA,PSIVALT
"RTN","PSIVORFB",47,0)
 I $G(PSIVCOPY)=1,$G(OLDON) I (OLDON["V")&(OLDON'=(+DA_"V")) D GETOPI^PSJBCMA5(DFN,OLDON)
"RTN","PSIVORFB",48,0)
 I $P($G(^PS(53.45,+$G(DUZ),6,0)),"^",3) D
"RTN","PSIVORFB",49,0)
 .N PSJTROPI,PSJNVO S PSJNVO=$G(P("NEWON")) I (PSJNVO["P") D FILEOPI^PSJBCMA5(DFN,PSJNVO) S PSJTROPI=$$GETOPI^PSJBCMA5(DFN,PSJNVO) Q
"RTN","PSIVORFB",50,0)
 .I ($G(P("PON"))["P"),($G(ON55)["V") S PSJNVO=P("PON") D FILEOPI^PSJBCMA5(DFN,PSJNVO) S PSJTROPI=$$GETOPI^PSJBCMA5(DFN,PSJNVO) Q
"RTN","PSIVORFB",51,0)
 .D FILEOPI^PSJBCMA5(DFN,ON55) S PSJTROPI=$$GETOPI^PSJBCMA5(DFN,ON55)
"RTN","PSIVORFB",52,0)
 Q
"RTN","PSIVORFB",53,0)
SET55 ; Move data from local variables to 55.
"RTN","PSIVORFB",54,0)
 I '$D(ON55) W !,"*** Can't create this order at this time ***" Q
"RTN","PSIVORFB",55,0)
 N DA,DIK,ND,PSIVACT,PSIVDUR,PSJTROPI,PSJTROPL
"RTN","PSIVORFB",56,0)
 I P(9)["PRN" S $P(ZZND,"^",3)="",PSGS0XT="",P(15)=""  ;*323 - If the schedule is changed to PRN, make sure the frequency of the original schedule is removed.
"RTN","PSIVORFB",57,0)
 I (($P($G(ZZND),"^",3))=""&($G(PSGS0XT)="")) S P(15)="" ;*285 - Prevent frequency hangover when changing from non-null to null
"RTN","PSIVORFB",58,0)
 S:'$D(P(21)) (P(21),P("21FLG"))="" S ND(0)=+ON55,P(22)=$S(VAIN(4):+VAIN(4),1:.5) F X=2:1:23 I $D(P(X)) S $P(ND(0),U,X)=P(X)
"RTN","PSIVORFB",59,0)
 S ND(.3)=$G(P("INS")),ND(2.5)="" N X S X=$S($G(PSGORD):PSGORD,1:$G(ON)) I X D
"RTN","PSIVORFB",60,0)
 .N PKG S PKG=$E(X,$L(X)) S PKG=$S(PKG="V":"""IV""",PKG="U":5,PKG="P":"P",1:"") Q:PKG=""
"RTN","PSIVORFB",61,0)
 .S PSIVDUR=$$GETDUR^PSJLIVMD(DFN,+X,$E(X,$L(X)),1) Q:PSIVDUR=""
"RTN","PSIVORFB",62,0)
 .I $G(IVLIMIT) S ND(2.5)="^^^"_PSIVDUR K IVLIMIT Q
"RTN","PSIVORFB",63,0)
 I P("DTYP")]"" S P("DO")=""
"RTN","PSIVORFB",64,0)
 S $P(ND(0),U,17)="A",ND(1)=P("REM"),ND(3)=P("OPI"),ND(.2)=$P($G(P("PD")),U)_U_$G(P("DO"))_U_+P("MR")_U_$G(P("PRY"))_U_$G(P("NAT"))_U_U_U_$G(P("PRNTON"))
"RTN","PSIVORFB",65,0)
 F X=0,1,2.5,3,.2,.3 S ^PS(55,DFN,"IV",+ON55,X)=ND(X)
"RTN","PSIVORFB",66,0)
 ; PSJ*5*213 - if Piggyback, intermittent syringe, or
"RTN","PSIVORFB",67,0)
 ; intermittent chemotherapy, and frequency is null, attempt to
"RTN","PSIVORFB",68,0)
 ; set frequency again based on P(15),PSGS0XT, and piece 3 of ZZND if they exist.
"RTN","PSIVORFB",69,0)
 ; If this still is null, attempt to re-set based upon the schedule name.
"RTN","PSIVORFB",70,0)
 I $G(P("IVCAT"))="I"!($P($G(ND(0)),U,4)?1(1"P",1"S",1"C"))&($P($G(ND(0)),U,15)="") D
"RTN","PSIVORFB",71,0)
 . I $P($G(ND(0)),U,4)="S",$P($G(ND(0)),U,5)'=1 Q  ;Not intermittent syringe
"RTN","PSIVORFB",72,0)
 . I $P($G(ND(0)),U,4)="C",$P($G(ND(0)),U,23)?1(1"A",1"H") Q  ;Not chemo piggyback or syringe
"RTN","PSIVORFB",73,0)
 . I $P($G(ND(0)),U,4)="C",$P($G(ND(0)),U,23)="S",$P($G(ND(0)),U,5)'=1 Q  ;Not intermitent chemo syringe
"RTN","PSIVORFB",74,0)
 . S $P(^PS(55,DFN,"IV",+ON55,0),U,15)=$S($G(P(15))'="":P(15),$G(PSGS0XT)'="":PSGS0XT,$P($G(ZZND),"^",3)'="":$P(ZZND,"^",3),1:$$GETFRQ($P($G(ND(0)),U,9))) K PSJFRQ,PSJSKED
"RTN","PSIVORFB",75,0)
 S $P(^PS(55,DFN,"IV",+ON55,2),U,1,4)=P("LOG")_U_+P("IVRM")_U_U_P("SYRS"),$P(^(2),U,8,10)=P("RES")_U_$G(P("FRES"))_U_$S($G(VAIN(4)):+VAIN(4),1:"")
"RTN","PSIVORFB",76,0)
 S X=^PS(55,DFN,0) I $P(X,"^",7)="" S $P(X,"^",7)=$P($P(P("LOG"),"^"),"."),$P(X,"^",8)="A",^(0)=X D LOGDFN^PSUHL(DFN)
"RTN","PSIVORFB",77,0)
 S $P(^PS(55,DFN,"IV",+ON55,2),U,11)=+P("CLRK")
"RTN","PSIVORFB",78,0)
 S:+$G(P("CLIN")) $P(^PS(55,DFN,"IV",+ON55,"DSS"),"^")=P("CLIN")
"RTN","PSIVORFB",79,0)
 S:+$G(P("APPT")) $P(^PS(55,DFN,"IV",+ON55,"DSS"),"^",2)=P("APPT")
"RTN","PSIVORFB",80,0)
 S:+$G(P("NINIT")) ^PS(55,DFN,"IV",+ON55,4)=P("NINIT")_U_P("NINITDT")
"RTN","PSIVORFB",81,0)
 I '$D(^PS(53.45,PSJSYSP,6)),($G(P("NEWON"))["P") S PSJTROPI=P("NEWON") S PSJTROPL=$$GETOPI^PSJBCMA5(DFN,PSJTROPI)
"RTN","PSIVORFB",82,0)
 I $G(^PS(53.45,PSJSYSP,6))!$P($G(^PS(53.45,PSJSYSP,6,0)),"^",3) D
"RTN","PSIVORFB",83,0)
 . I $G(PSJCOM),$G(PSJCOMSI),$G(PSJORD)["V" M ^TMP("PSJOPI",$J,6)=^PS(53.45,PSJSYSP,6)
"RTN","PSIVORFB",84,0)
 . D FILEOPI^PSJBCMA5(DFN,ON55) K ^TMP("PSJOPI",$J,6)
"RTN","PSIVORFB",85,0)
 I '$G(PSIVCHG)!($G(PSJREN)&($G(PSIVCHG)=2)) I $G(P("PON")),P("PON")'=ON55 D
"RTN","PSIVORFB",86,0)
 . N X S X=$S(P("PON")["P":"^PS(53.1,+P(""PON""),12,0)",P("PON")["V"&$G(PSJREN):"^PS(55,DFN,""IV"",+P(""PON""),5,0)",1:"") Q:X=""
"RTN","PSIVORFB",87,0)
 . I $O(@X) S %X=X,%Y="^PS(55,"_DFN_",""IV"","_+ON55_",5," D %XY^%RCR
"RTN","PSIVORFB",88,0)
 F DRGT="AD","SOL" D PUTD55
"RTN","PSIVORFB",89,0)
 K DA,DIK S DA(1)=DFN,DA=+ON55,DIK="^PS(55,"_DA(1)_",""IV"",",PSIVACT=1 D IX^DIK
"RTN","PSIVORFB",90,0)
 I $G(PSJCOM),$G(PSJCOMSI),$G(PSJORD)["V" K PSJCOMSI N PSJCHILD,PSJOEORD S PSJOEORD=0 F  S PSJOEORD=$O(^PS(55,"ACX",PSJCOM,PSJOEORD)) Q:'PSJOEORD  D
"RTN","PSIVORFB",91,0)
 . N PSJCHILD S PSJCHILD=0 F  S PSJCHILD=$O(^PS(55,"ACX",PSJCOM,PSJOEORD,PSJCHILD)) Q:'PSJCHILD  S PSJCHILD(+PSJCHILD)=PSJCOM
"RTN","PSIVORFB",92,0)
 . S PSJCHILD=0 F  S PSJCHILD=$O(PSJCHILD(PSJCHILD)) Q:'PSJCHILD  D
"RTN","PSIVORFB",93,0)
 .. Q:PSJCHILD=PSJORD  K DR,DA,DIE,ORD S DR="31////"_$P($G(P("OPI")),"^",1,2),DA(1)=DFN
"RTN","PSIVORFB",94,0)
 .. N ON,ON55 S (ON,ON55)=+PSJCHILD_"V" S:+$G(PSJPINIT)'>0 PSJPINIT=DUZ S PSIVALT=1,PSIVAL="COMPLEX ORDER" D ENTACT^PSIVAL D
"RTN","PSIVORFB",95,0)
 ... I $P($G(^PS(55,DFN,"IV",+ON55,3)),"^")'=$P(P("OPI"),"^") S P("FC")="OTHER PRINT INFO^"_$P($G(^(3)),"^")_U_$P(P("OPI"),"^") D GTFC^PSIVORAL
"RTN","PSIVORFB",96,0)
 ... I $D(^PS(55,DFN,"IV",+ON55,0)) S ^PS(55,DFN,"IV",+ON55,3)=P("OPI") D EN1^PSJHL2(DFN,"XX",ON55)
"RTN","PSIVORFB",97,0)
 ... M ^PS(55,DFN,"IV",+ON55,10)=^TMP("PSJOPI",$J,6)
"RTN","PSIVORFB",98,0)
 K ^TMP("PSJOPI",$J)
"RTN","PSIVORFB",99,0)
 Q
"RTN","PSIVORFB",100,0)
 ;
"RTN","PSIVORFB",101,0)
PUTD55 ; Move drug data from local array into 55
"RTN","PSIVORFB",102,0)
 K ^PS(55,DFN,"IV",+ON55,DRGT) S ^PS(55,DFN,"IV",+ON55,DRGT,0)=$S(DRGT="AD":"^55.02PA",1:"^55.11IPA")
"RTN","PSIVORFB",103,0)
 F X=0:0 S X=$O(DRG(DRGT,X)) Q:'X  D
"RTN","PSIVORFB",104,0)
 .S Y=^PS(55,DFN,"IV",+ON55,DRGT,0),$P(Y,U,3)=$P(Y,U,3)+1,DRG=$P(Y,U,3),$P(Y,U,4)=$P(Y,U,4)+1
"RTN","PSIVORFB",105,0)
 .S ^PS(55,DFN,"IV",+ON55,DRGT,0)=Y,Y=$P(DRG(DRGT,X),U)_U_$P(DRG(DRGT,X),U,3) S:DRGT="AD" $P(Y,U,3)=$P(DRG(DRGT,X),U,4) S ^PS(55,DFN,"IV",+ON55,DRGT,+DRG,0)=Y
"RTN","PSIVORFB",106,0)
 Q
"RTN","PSIVORFB",107,0)
GT55 ; Retrieve data from 55 into local array
"RTN","PSIVORFB",108,0)
 K DRG,DRGN,P S:'$D(ON55) ON55=ON S P("REN")="",Y=$G(^PS(55,DFN,"IV",+ON55,0)) F X=1:1:25 S P(X)=$P(Y,U,X)
"RTN","PSIVORFB",109,0)
 S P("21FLG")=P(21)
"RTN","PSIVORFB",110,0)
 S P("PON")=ON55,PSJORIFN=P(21),P(6)=P(6)_U_$P($G(^VA(200,+P(6),0)),U),(DRG,DRGN)="",P("REM")=$G(^PS(55,DFN,"IV",+ON55,1))
"RTN","PSIVORFB",111,0)
 S Y=$G(^PS(55,DFN,"IV",+ON55,2)),P("LOG")=$P(Y,U),P("IVRM")=$P(Y,U,2)_U_$P($G(^PS(59.5,+$P(Y,U,2),0)),U)
"RTN","PSIVORFB",112,0)
 S P("CLRK")=$P(Y,U,11)_U_$P($G(^VA(200,+$P(Y,U,11),0)),U),P("RES")=$P(Y,U,8),P("FRES")=$P(Y,U,9),P("SYRS")=$P(Y,U,4),P("OPI")=$G(^PS(55,DFN,"IV",+ON55,3))
"RTN","PSIVORFB",113,0)
 S P("INS")=$G(^PS(55,DFN,"IV",+ON55,.3))
"RTN","PSIVORFB",114,0)
 S P("CLIN")=$P($G(^PS(55,DFN,"IV",+ON55,"DSS")),"^"),P("APPT")=$P($G(^PS(55,DFN,"IV",+ON55,"DSS")),"^",2)
"RTN","PSIVORFB",115,0)
 S P("DTYP")=$S(P(4)="":0,P(4)="P"!(P(23)="P")!(P(5)):1,P(4)="H":2,1:3)
"RTN","PSIVORFB",116,0)
 D:'$D(PSJLABEL) GTPC(ON55) S ND=$G(^PS(55,DFN,"IV",+ON55,.2)),P("PD")=$S($P(ND,U):$P(ND,U)_U_$$OIDF^PSJLMUT1(+ND)_U_$P($G(^PS(50.7,+ND,0)),U),1:""),P("DO")=$P(ND,U,2),P("PRY")=$P(ND,U,4),P("NAT")=$P(ND,U,5),(PSJCOM,P("PRNTON"))=$P(ND,U,8)
"RTN","PSIVORFB",117,0)
 I P("PRY")="D",'+P("IVRM") S P("IVRM")=+$G(PSIVSN)_U_$P($G(^PS(59.5,+$G(PSIVSN),0)),U)
"RTN","PSIVORFB",118,0)
 S P("MR")=$P(ND,U,3),ND=$G(^PS(51.2,+P("MR"),0)),P("MR")=P("MR")_U_$S($P(ND,U,3)]"":$P(ND,U,3),1:$P(ND,U)) D GTCUM
"RTN","PSIVORFB",119,0)
 D GTDRG,GTOT^PSIVUTL(P(4))
"RTN","PSIVORFB",120,0)
 N ND2P5 S ND2P5=$G(^PS(55,DFN,"IV",+ON55,2.5)) D
"RTN","PSIVORFB",121,0)
 .S P("DUR")=$P(ND2P5,"^",2)
"RTN","PSIVORFB",122,0)
 .S P("LIMIT")=$P(ND2P5,"^",4)
"RTN","PSIVORFB",123,0)
 .S P("IVCAT")=$P(ND2P5,"^",5)
"RTN","PSIVORFB",124,0)
K ; Kill and exit.
"RTN","PSIVORFB",125,0)
 K FIL,ND
"RTN","PSIVORFB",126,0)
 Q
"RTN","PSIVORFB",127,0)
GTDRG ; Get drug info and place in DRG(.
"RTN","PSIVORFB",128,0)
 F DRGT="AD","SOL" S FIL=$S(DRGT="AD":52.6,1:52.7) F Y=0:0 S Y=$O(^PS(55,DFN,"IV",+ON55,DRGT,Y)) Q:'Y  D
"RTN","PSIVORFB",129,0)
 .; naked ref below refers to line above
"RTN","PSIVORFB",130,0)
 .S DRG=$G(^(Y,0)),ND=$G(^PS(FIL,+DRG,0)),(DRGI,DRG(DRGT,0))=$G(DRG(DRGT,0))+1
"RTN","PSIVORFB",131,0)
 .S DRG(DRGT,+DRGI)=+DRG_U_$P(ND,U)_U_$P(DRG,U,2)_U_$P(DRG,U,3)_U_$P(ND,U,13)_U_$P(ND,U,11)
"RTN","PSIVORFB",132,0)
 Q
"RTN","PSIVORFB",133,0)
 ;
"RTN","PSIVORFB",134,0)
GTCUM ; Retrieve dispensing info.
"RTN","PSIVORFB",135,0)
 S ND=$G(^PS(55,DFN,"IV",+ON55,9)),P("LF")=$P(ND,U),P("LFA")=$P(ND,U,2),P("CUM")=$P(ND,U,3)
"RTN","PSIVORFB",136,0)
 Q
"RTN","PSIVORFB",137,0)
 ;
"RTN","PSIVORFB",138,0)
GTPC(ON) ; Retrieve Provider Comments and create "scratch" fields to edit
"RTN","PSIVORFB",139,0)
 Q
"RTN","PSIVORFB",140,0)
 ;
"RTN","PSIVORFB",141,0)
SETNEW ; Create new order and set
"RTN","PSIVORFB",142,0)
 D NEW55,SET55
"RTN","PSIVORFB",143,0)
 Q
"RTN","PSIVORFB",144,0)
 ;
"RTN","PSIVORFB",145,0)
CMPLIM(PSJORD,PSJDSTP1,PSJDSTP2) ; Compare stop date of order against IV Limit
"RTN","PSIVORFB",146,0)
 I $P($G(^PS(53.1,+PSJORD,0)),"^",25)]"" D CHKD Q:PSJPAO 0
"RTN","PSIVORFB",147,0)
 I $G(PSJDSTP1),$E(+PSJDSTP1,1,11)'=$E(+P(3),1,11),+PSJDSTP2'=+P(3) Q 1
"RTN","PSIVORFB",148,0)
 Q 0
"RTN","PSIVORFB",149,0)
 ;
"RTN","PSIVORFB",150,0)
LIMSTOP(PSJDSTP1,PSJDSTP2) ; Calculate default stop date using IV Limit
"RTN","PSIVORFB",151,0)
 ;      Output: PSJDSTP1 - Default stop using duration only
"RTN","PSIVORFB",152,0)
 ;              PSJDSTP2 - Default stop using duration and IV parameters for time
"RTN","PSIVORFB",153,0)
 S PSIVLIM=$$GETLIM^PSIVCAL(DFN,PSJORD)
"RTN","PSIVORFB",154,0)
 I 'PSIVLIM,PSIVLIM]"" S PSIVLIM=$$GETMIN^PSIVCAL(PSIVLIM,DFN,PSJORD)
"RTN","PSIVORFB",155,0)
 I PSIVLIM]"" D
"RTN","PSIVORFB",156,0)
 . S MINS=$$GETMIN^PSIVCAL(PSIVLIM,DFN,PSJORD),PSJDSTP1=$$FMADD^XLFDT(P(2),,,MINS)
"RTN","PSIVORFB",157,0)
 . S X=$P(PSJDSTP1,"."),PSJDSTP2=X_$S($P($G(PSIVSITE),"^",14)="":.2359,1:"."_$P(PSIVSITE,"^",14))
"RTN","PSIVORFB",158,0)
 Q
"RTN","PSIVORFB",159,0)
 ;
"RTN","PSIVORFB",160,0)
GETFRQ(PSJSKED) ;Get frequency using name of schedule
"RTN","PSIVORFB",161,0)
 I PSJSKED="" K PSJSKED Q ""
"RTN","PSIVORFB",162,0)
 S (PSJCNTX,PSJFRQ)=""
"RTN","PSIVORFB",163,0)
 I $D(^PS(51.1,"APPSJ",PSJSKED)) F  S PSJCNTX=$O(^PS(51.1,"APPSJ",PSJSKED,PSJCNTX)) Q:PSJCNTX=""  D  Q:$G(PSJFRQ)'=""
"RTN","PSIVORFB",164,0)
 . I $P($G(^PS(51.1,PSJCNTX,0)),U,3)'="" S PSJFRQ=$P(^PS(51.1,PSJCNTX,0),U,3)
"RTN","PSIVORFB",165,0)
 K PSJCNTX
"RTN","PSIVORFB",166,0)
 Q PSJFRQ
"RTN","PSIVORFB",167,0)
 ;
"RTN","PSIVORFB",168,0)
CHKD ;Check for a previous active order and compare the duration
"RTN","PSIVORFB",169,0)
 N PSJPO,A,PSJDUR
"RTN","PSIVORFB",170,0)
 S PSJDUR=$$GETLIM^PSIVCAL(DFN,PSJORD)
"RTN","PSIVORFB",171,0)
 S PSJPAO=0,PSJPO=PSJORD
"RTN","PSIVORFB",172,0)
CHKDR S PSJPO=$P($G(^PS(53.1,+PSJPO,0)),"^",25) Q:PSJPO=""
"RTN","PSIVORFB",173,0)
 I PSJPO["P" G CHKDR
"RTN","PSIVORFB",174,0)
 I PSJPO["V" S PSIVLIM=$$GETLIM^PSIVCAL(DFN,PSJPO) I PSJDUR'=PSIVLIM S PSJPAO=1 Q
"RTN","PSIVORFB",175,0)
 G CHKDR
"RTN","PSIVORFB",176,0)
 ;
"RTN","PSIVORFB",177,0)
LOGOPI(DFN,ON55) ; Log OPI activity into activity log
"RTN","PSIVORFB",178,0)
 N PSJPICHK
"RTN","PSIVORFB",179,0)
 I ON55["V" D
"RTN","PSIVORFB",180,0)
 .I ($G(P("PON"))["V"),($G(ON55)["V"),(ON55'=P("PON")) D
"RTN","PSIVORFB",181,0)
 ..K PSJARRY1,PSJARRY2 M PSJARRY1=^PS(53.45,+$G(PSJSYSP),6),PSJARRY2=^PS(55,DFN,"IV",+P("PON"),10) S PSJPICHK='$$DIFFAR^PSJBCMA5(.PSJARRY1,.PSJARRY2)
"RTN","PSIVORFB",182,0)
 .Q:$G(PSJPICHK)
"RTN","PSIVORFB",183,0)
 .N PSIVALCK,PSIVRA,PSIVLN,PSIVLSTA S PSIVLN=$O(^PS(55,DFN,"IV",+ON55,"A",""),-1)+1
"RTN","PSIVORFB",184,0)
 .K PSJARRY1,PSJARRY2 S PSJARRY1="",PSJARRY2="" M PSJARRY1=^PS(53.45,+$G(PSJSYSP),6),PSJARRY2=^PS(55,DFN,"IV",+ON55,10) Q:'$$DIFFAR^PSJBCMA5(.PSJARRY1,.PSJARRY2)
"RTN","PSIVORFB",185,0)
 .S P("FC")="OTHER PRINT INFO^"_$P($G(^PS(55,DFN,"IV",+ON55,3)),"^")_U_$P($G(P("OPI")),"^"),PSIVALCK="OPI",PSIVREA="E" D LOG^PSIVORAL
"RTN","PSIVORFB",186,0)
 K PSJARRY1,PSJARRY2
"RTN","PSIVORFB",187,0)
 Q
"RTN","PSJEXP")
0^3^B46184358^B46163170
"RTN","PSJEXP",1,0)
PSJEXP ;BIR/CML3,KKA - MEDICATION EXPIRATION NOTICES ;13 FEB 96 / 10:04 AM
"RTN","PSJEXP",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**111,328,335**;16 DEC 97;Build 6
"RTN","PSJEXP",3,0)
 ;
"RTN","PSJEXP",4,0)
 ;Reference to ^PS(55 supported by DBIA #2191.
"RTN","PSJEXP",5,0)
 ;
"RTN","PSJEXP",6,0)
 N OUT,PSJNEW,PSGPTMP,PPAGE S PSJNEW=1
"RTN","PSJEXP",7,0)
 D ENCV^PSGSETU I $D(XQUIT) Q
"RTN","PSJEXP",8,0)
 K %DT,DIC S (PSGP,WD,WG)=0,PSGSSH="EXP" S PSGPTMP=0,PPAGE=1 D ^PSGSEL G:"^"[PSGSS DONE D @PSGSS G:+Y'>0 DONE
"RTN","PSJEXP",9,0)
 I PSGSS="W" S PSJSEL("W")=WD D ADMTM^PSJPDIR
"RTN","PSJEXP",10,0)
 I PSGSS="C" S PSJSEL("C")="C"
"RTN","PSJEXP",11,0)
 S %DT="ETX",D="start" D DT G:Y'>0 DONE S (%DT(0),PSGEXPS)=+Y,D="stop" D DT K %DT G:Y'>0 DONE S:'$P(PSGEXPS,".",2) PSGEXPS=PSGEXPS+.0001 S PSGEXPF=Y+$S($P(Y,".",2):0,1:.24)
"RTN","PSJEXP",12,0)
 D LIST^PSJEXP0 G:$D(OUT) DONE
"RTN","PSJEXP",13,0)
 K ZTDTH,ZTSAVE S PSGTIR="ENQ^PSJEXP",ZTDESC="INPATIENT STOP ORDER NOTICES" F X="PSJMSG","WG","WD","PSGP","PSGOP","PSGDT","PSGEXPS","PSGEXPF","PSGSS","CHOICE","PSGPTMP","PPAGE","PSJSEL(" S ZTSAVE(X)=""
"RTN","PSJEXP",14,0)
 D ENDEV^PSGTI I POP!$D(ZTSK) W:POP !?3,"No device selected for report run." G DONE
"RTN","PSJEXP",15,0)
 W:$E(IOST)'="P" !,"...this may take a few minutes...",!?25,"...you really should QUEUE this report, if possible..."
"RTN","PSJEXP",16,0)
ENQ D NOW^%DTC S PSGDT=%,SD=$$EN^PSGCT(PSGEXPS,-1),FD=PSGEXPF F X="PSGEXPS","PSGEXPF" S @X=$$ENDTC^PSGMI(@X)
"RTN","PSJEXP",17,0)
 K ^TMP("PSG",$J) D @("L"_PSGSS),^PSJEXP0
"RTN","PSJEXP",18,0)
DONE D ^%ZISC D ENKV^PSGSETU K %,^TMP("PSG",$J),ADCNT,AM,CHOICE,CNT,D,DFN,DO,DOB,DRG,DRGI,DRGN,DRGT,DTOUT,DUOUT,FD,FSTFLG,GMRAREC,IR,JJ,LNCNT,MR,PSJMSG,ND,ND3,ND4,NF,ON,OPI,PRIMD,P,PSIVUP,PSJORIFN
"RTN","PSJEXP",19,0)
 K PSJACNWP,PSJAD,PSJJORD,PSJPAD,PSJPAGE,PSJPDOB,PSJPDX,PSJPRB,PSJPSEX,PSJPTD,PSJPWD,PSJPWDN,PSJPWT,PSJSEL,PSJSOL,SLS,Y1
"RTN","PSJEXP",20,0)
 K POP,PPN,PR,PSGDT,PSGEXPF,PSGEXPS,PSGOD,PSGP,PSGSS,PSGSSH,PSGTIR,PSEX,PSJOPC,PST,Q,RF,SCH,SD,SD1,SD1IV,SEX,SI,SM,SNDFLG,SOLCNT,SSN,ST,STD,TEAM,TEMPTM,TM,VA,WCNT,WD,WDN,WG,WRD,WS,WT,X,XQUIT,Y
"RTN","PSJEXP",21,0)
 Q
"RTN","PSJEXP",22,0)
LC ;
"RTN","PSJEXP",23,0)
 S STDTE=SD F  S STDTE=$O(^PS(55,"AIVC",STDTE)) Q:'STDTE  S CLINIC=0 F  S CLINIC=$O(^PS(55,"AIVC",STDTE,CLINIC)) Q:'CLINIC  D
"RTN","PSJEXP",24,0)
 . S JDFN=0 F  S JDFN=$O(^PS(55,"AIVC",STDTE,CLINIC,JDFN)) Q:'JDFN  S PSGP=JDFN D LP
"RTN","PSJEXP",25,0)
 S STDTE=SD F  S STDTE=$O(^PS(55,"AUDC",STDTE)) Q:'STDTE  S CLINIC=0 F  S CLINIC=$O(^PS(55,"AUDC",STDTE,CLINIC)) Q:'CLINIC  D
"RTN","PSJEXP",26,0)
 . S JDFN=0 F  S JDFN=$O(^PS(55,"AUDC",STDTE,CLINIC,JDFN)) Q:'JDFN  S PSGP=JDFN D LP
"RTN","PSJEXP",27,0)
 Q
"RTN","PSJEXP",28,0)
 ;
"RTN","PSJEXP",29,0)
LG F WD=0:0 S WD=$O(^PS(57.5,"AC",WG,WD)) Q:'WD  D LW
"RTN","PSJEXP",30,0)
 Q
"RTN","PSJEXP",31,0)
LW I $D(^DIC(42,WD,0)),$P(^(0),"^")]"" S WDN=$P(^(0),"^")
"RTN","PSJEXP",32,0)
 E  Q
"RTN","PSJEXP",33,0)
 F PSGP=0:0 S PSGP=$O(^DPT("CN",WDN,PSGP)) Q:'PSGP  D LP
"RTN","PSJEXP",34,0)
 Q
"RTN","PSJEXP",35,0)
LL S CL="" F  S CL=$O(^PS(57.8,"AD",CG,CL)) Q:CL=""  D LC
"RTN","PSJEXP",36,0)
 Q
"RTN","PSJEXP",37,0)
C ;
"RTN","PSJEXP",38,0)
 K DIR S DIR(0)="FAO",DIR("A")="Select CLINIC: "
"RTN","PSJEXP",39,0)
 S DIR("?")="^D CDIC^PSGVBW" W ! D ^DIR
"RTN","PSJEXP",40,0)
CDIC ;
"RTN","PSJEXP",41,0)
 K DIC S DIC="^SC(",DIC(0)="QEMIZ" D ^DIC K DIC S:+Y>0 PSJMSG=Y(0,0),CL=+Y
"RTN","PSJEXP",42,0)
 W:X["?" !!,"Enter the clinic you want to use to select patients for processing.",!
"RTN","PSJEXP",43,0)
 Q
"RTN","PSJEXP",44,0)
L ;
"RTN","PSJEXP",45,0)
 K DIR S DIR(0)="FAO",DIR("A")="Select CLINIC GROUP: "
"RTN","PSJEXP",46,0)
 S DIR("?")="^D LDIC^PSGVBW" W ! D ^DIR
"RTN","PSJEXP",47,0)
LDIC ;
"RTN","PSJEXP",48,0)
 K DIC S DIC="^PS(57.8,",DIC(0)="QEMI" D ^DIC K DIC S:+Y>0 CG=+Y,PSJMSG=$P(Y,"^",2)
"RTN","PSJEXP",49,0)
 W:X["?" !!,"Enter the name of the clinic group you want to use to select patients for processing."
"RTN","PSJEXP",50,0)
 Q
"RTN","PSJEXP",51,0)
LP N PSJACNWP S PSJACNWP=1 D ^PSJAC,ENUNM^PSGOU Q:'$O(^PS(55,PSGP,5,"AUS",SD))
"RTN","PSJEXP",52,0)
 S PPN=$E($P(PSGP(0),"^"),1,12)_"^"_PSGP S:PSJPRB="" PSJPRB="zz"
"RTN","PSJEXP",53,0)
 S TM=$O(PSJSEL("TM","")),TM=$S(TM="":"ZZ",PSJPRB="":"zz",$D(^PS(57.7,+PSJPWD,1,+$O(^PS(57.7,"AWRT",+PSJPWD,PSJPRB,0)),0)):$P(^(0),"^"),1:"zz")
"RTN","PSJEXP",54,0)
 S TEMPTM=$O(^PS(57.7,+PSJPWD,1,"B",TM,0))
"RTN","PSJEXP",55,0)
 Q:$D(PSJSEL("TM"))&('$D(PSJSEL("TM","ALL")))&('$D(PSJSEL("TM",+TEMPTM)))
"RTN","PSJEXP",56,0)
 D:CHOICE'="IV" GS D:CHOICE'="UD" GSIV
"RTN","PSJEXP",57,0)
 Q
"RTN","PSJEXP",58,0)
GS F PST="C","P","R" F SD1=SD:0 S SD1=$O(^PS(55,PSGP,5,"AU",PST,SD1)) Q:'SD1!(SD1>FD)  F PSJJORD=0:0 S PSJJORD=$O(^PS(55,PSGP,5,"AU",PST,SD1,PSJJORD)) Q:'PSJJORD  D
"RTN","PSJEXP",59,0)
 .I $D(^PS(55,PSGP,5,PSJJORD,0)),$P(^(0),U,9)'["D",$P(^(0),U,27)'["R" D
"RTN","PSJEXP",60,0)
 ..I '$D(CL) D ARSET Q
"RTN","PSJEXP",61,0)
 ..I $D(CL),($P($G(^PS(55,PSGP,5,PSJJORD,8)),"^",2)'="") D ARSET Q
"RTN","PSJEXP",62,0)
 I $G(PSJPWDN)="" S PSJPWDN="UNKNOWN"
"RTN","PSJEXP",63,0)
 I $D(^TMP("PSG",$J,$E(TM,1,10),$E(PSJPWDN,1,10),$E(PSJPRB,1,12),PPN)) S ^(PPN)=TM_"^"_PSJPWDN_"^"_PSJPRB_"^"_$P(PSGP(0),"^")_"^"_$P(PSJPSEX,"^",2)_"^"_$P(PSJPDOB,"^",2)_";"_PSJPAGE_"^"_VA("PID")_"^"_PSJPDX_"^"_PSJPWT
"RTN","PSJEXP",64,0)
 ;naked reference below refers to the full global references to ^TMP on the line above
"RTN","PSJEXP",65,0)
 I  S ^(PPN)=^(PPN)_"^"_$P(PSJPAD,"^",2)_"^"_$P(PSJPTD,"^",2)
"RTN","PSJEXP",66,0)
 Q
"RTN","PSJEXP",67,0)
GSIV S PST="C"
"RTN","PSJEXP",68,0)
 S SD1IV=SD F  S SD1IV=$O(^PS(55,PSGP,"IV","AIS",SD1IV)) Q:'SD1IV!(SD1IV>FD)  F PSJJORD=0:0 S PSJJORD=$O(^PS(55,PSGP,"IV","AIS",SD1IV,PSJJORD)) Q:'PSJJORD  D
"RTN","PSJEXP",69,0)
 .I $D(^PS(55,PSGP,"IV",PSJJORD,0)),$P(^(0),U,17)'["D",$P(^PS(55,PSGP,"IV",PSJJORD,2),U,9)'["R" D
"RTN","PSJEXP",70,0)
 ..I '$D(CL) D ARSETIV Q
"RTN","PSJEXP",71,0)
 ..I $D(CL),($P($G(^PS(55,PSGP,"IV",PSJJORD,"DSS")),"^",2)'="") D ARSETIV Q
"RTN","PSJEXP",72,0)
  I $D(^TMP("PSG",$J,$E(TM,1,10),$E(PSJPWDN,1,10),$E(PSJPRB,1,12),PPN)) S ^(PPN)=TM_"^"_PSJPWDN_"^"_PSJPRB_"^"_$P(PSGP(0),"^")_"^"_$P(PSJPSEX,"^",2)_"^"_$P(PSJPDOB,"^",2)_";"_PSJPAGE_"^"_VA("PID")_"^"_PSJPDX_"^"_PSJPWT
"RTN","PSJEXP",73,0)
 ;naked reference below refers to the full global references to ^TMP on the line above
"RTN","PSJEXP",74,0)
 I  S ^(PPN)=^(PPN)_"^"_$P(PSJPAD,"^",2)_"^"_$P(PSJPTD,"^",2)
"RTN","PSJEXP",75,0)
 Q
"RTN","PSJEXP",76,0)
ARSET S ND=$G(^PS(55,PSGP,5,PSJJORD,0)),PR=$P(ND,"^",2),ST=$P(ND,"^",9),MR=$P(ND,"^",3),PR=$$ENNPN^PSGMI(PR)
"RTN","PSJEXP",77,0)
 S MR=$$ENMRN^PSGMI(MR) S X=$$NFWS^PSJUTL1(PSGP,PSJJORD_"U",PSJPWD),SM=$S('$P(X,U,3):0,$P(X,U,4):1,1:2)
"RTN","PSJEXP",78,0)
 S ND=$G(^PS(55,PSGP,5,PSJJORD,2)),DRG=$G(^(.2)),SCH=$P(ND,"^"),STD=$P(ND,"^",2)\1,DO=$P(DRG,"^",2) I DO]"",$E(DO,$L(DO))'=" " S DO=DO_" "
"RTN","PSJEXP",79,0)
 N X,PSG
"RTN","PSJEXP",80,0)
 D DRGDISP^PSJLMUT1(PSGP,PSJJORD_"U",15,0,.PSG,1)
"RTN","PSJEXP",81,0)
 S DRG=PSG(1) I $G(PSJPWDN)="" S PSJPWDN="UNKNOWN"
"RTN","PSJEXP",82,0)
 S ^TMP("PSG",$J,$E(TM,1,10),$E(PSJPWDN,1,10),$E(PSJPRB,1,12),PPN,SD1,PST,$S(DRG'="NOT FOUND":$E(DRG,1,15),1:"zz")_"^"_PSJJORD)=DRG_"^"_STD_"^"_DO_MR_" "_SCH_"^"_ST_"^"_PR_"^^^"_SM Q
"RTN","PSJEXP",83,0)
 ;
"RTN","PSJEXP",84,0)
ARSETIV N X,ON55 S DFN=PSGP,ON=PSJJORD D GT55^PSIVORFB
"RTN","PSJEXP",85,0)
 S DRG=$S($G(DRG("AD",1))]"":$P(DRG("AD",1),U,2),1:$P($G(DRG("SOL",1)),U,2)),STD=P(2)\1,MR=$P(P("MR"),U,2),SCH=P(9),IR=P(8),ST=P(17),PR=$P(P(6),U,2)
"RTN","PSJEXP",86,0)
 I $G(PSJPWDN)="" S PSJPWDN="UNKNOWN"
"RTN","PSJEXP",87,0)
 S ^TMP("PSG",$J,$E(TM,1,10),$E(PSJPWDN,1,10),$E(PSJPRB,1,12),PPN,SD1IV,PST,$S(DRG'="NOT FOUND":$E(DRG,1,15),1:"zz")_"^"_PSJJORD_"V")=DRG_"^"_STD_"^"_MR_" "_SCH_" "_IR_"^"_ST_"^"_PR Q
"RTN","PSJEXP",88,0)
 ;
"RTN","PSJEXP",89,0)
G S DIC="^PS(57.5,",DIC(0)="AEIMQZ" W ! D ^DIC K DIC W ! S:X="^OTHER" PSJMSG="^OTHER",PSGSS="C",Y(0,0)=2,Y=2 S WG=+Y S:+Y>0 PSJMSG=Y(0,0) Q
"RTN","PSJEXP",90,0)
W S DIC="^DIC(42,",DIC(0)="AEIMQZ",DIC("A")="Select WARD: " W ! D ^DIC K DIC S WD=+Y S:+Y>0 PSJMSG=Y(0,0) Q
"RTN","PSJEXP",91,0)
P D ENP^PSGGAO S Y=PSGP S:PSGP>0 PSJMSG=$P(PSGP(0),"^") Q
"RTN","PSJEXP",92,0)
DT S Y=-1 F  W !!,"Enter ",D," date: " R X:DTIME W:'$T $C(7) S:'$T X="^" D DTM:X?1."?",^%DT:"^"'[X I Y>0!("^"[X) W:Y<0 !,"No ",D," date chosen for notices run." Q
"RTN","PSJEXP",93,0)
 Q
"RTN","PSJEXP",94,0)
DTM W !!?2,"Enter the ",D," date of the range of dates to find orders about to expire.",!,"The start date and stop date may be the  same." W:D="stop" "  The stop date may not come before the start date." W ! Q
"RTN","PSJIMO1")
0^2^B68663618^B68607232
"RTN","PSJIMO1",1,0)
PSJIMO1 ;BIR/LE - IMO UTILITIES AND XREFS ;16 Mar 99 / 10:22 AM
"RTN","PSJIMO1",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**257,299,311,307,335**;16 DEC 97;Build 6
"RTN","PSJIMO1",3,0)
 ;External reference to ^PS(55 supported by DBIA 2191
"RTN","PSJIMO1",4,0)
 ;External reference to ^PSSDSAPI supported by DBIA 5425
"RTN","PSJIMO1",5,0)
 ;External Reference to ^DPTLK is supported by DBIA 3787
"RTN","PSJIMO1",6,0)
 ;
"RTN","PSJIMO1",7,0)
IMO(CLINICS) ;called from ENCD^PSGFILED WHICH IS CLINIC DEFINITION OPTION IN INPATIENT MEDS
"RTN","PSJIMO1",8,0)
 W !!,"Verifying IMO clinic cross references...",!
"RTN","PSJIMO1",9,0)
 N CLINFLG,IMOCLIEN,PSJIMOCL,PSJCLIN,FLAG S FLAG=""
"RTN","PSJIMO1",10,0)
 S (CLINFLG,CLINIC,PSJIMOCL,IMOCLIEN)=""
"RTN","PSJIMO1",11,0)
 F  S IMOCLIEN=$O(CLINICS(IMOCLIEN)) Q:IMOCLIEN=""  S PSJIMOCL=$$GET1^DIQ(53.46,IMOCLIEN,.01,"I"),CLINFLG=$$GET1^DIQ(44,PSJIMOCL,2802,"I") D
"RTN","PSJIMO1",12,0)
 .I 'CLINFLG D IMOKILL(PSJIMOCL,CLINFLG) Q  ;CLINFLG=ADIMINISTER INPATIENT MEDS? true means IMO clinic; false means not IMO
"RTN","PSJIMO1",13,0)
 .I CLINFLG D IMOSET(PSJIMOCL,CLINFLG,IMOCLIEN)
"RTN","PSJIMO1",14,0)
 I FLAG W !,"IMO cross references have been updated.",!
"RTN","PSJIMO1",15,0)
 Q
"RTN","PSJIMO1",16,0)
 ;
"RTN","PSJIMO1",17,0)
IMOSET(PSJCLIN,PSJIMOF,CLINIC) ;
"RTN","PSJIMO1",18,0)
 ;Clinic order means Yes is answered to ADMINISTER INPATIENT MEDS field in file 44, a clinic and appointment date/time is defined.
"RTN","PSJIMO1",19,0)
 ;Q:$D(^PS("CIMOCLU",CLINIC))!($D(^PS("CIMOCLI",CLINIC)))
"RTN","PSJIMO1",20,0)
 N CLNDAYS,PSJAPTDT,PSJTODAY,X1,X2,PATIENT,PSJSTDT,PS55IEN,PS531IEN,PSJXREF,PSJTYPE,APPTDT,PSJUTMP,PSJSTART
"RTN","PSJIMO1",21,0)
 S CLNDAYS=$$GET1^DIQ(53.46,CLINIC,6)
"RTN","PSJIMO1",22,0)
 S:CLNDAYS="" CLNDAYS=30  ;default to 30 days if not defined
"RTN","PSJIMO1",23,0)
 D NOW^%DTC S (X1,PSJTODAY)=%,X2=-CLNDAYS D C^%DTC S PSJSTART=X
"RTN","PSJIMO1",24,0)
 ;FILE 55
"RTN","PSJIMO1",25,0)
 F PSJXREF="AUDC","AIVC" S PSJSTDT=PSJSTART F  S PSJSTDT=$O(^PS(55,PSJXREF,PSJSTDT)) Q:PSJSTDT=""  D
"RTN","PSJIMO1",26,0)
 .S PATIENT="" F  S PATIENT=$O(^PS(55,PSJXREF,PSJSTDT,PSJCLIN,PATIENT)) Q:PATIENT=""  S PS55IEN="" F  S PS55IEN=$O(^PS(55,PSJXREF,PSJSTDT,PSJCLIN,PATIENT,PS55IEN)) Q:PS55IEN=""  D
"RTN","PSJIMO1",27,0)
 ..I PSJXREF="AUDC" S PSJAPTDT=$$GET1^DIQ(55.06,PS55IEN_","_PATIENT_",",131) I PSJAPTDT'="" S ^PS(55,"CIMOU",PATIENT,PSJCLIN,PSJSTDT,PATIENT,PS55IEN)=""
"RTN","PSJIMO1",28,0)
 ..I PSJXREF="AIVC" S PSJAPTDT=$$GET1^DIQ(55.01,PS55IEN_","_PATIENT_",",139) I PSJAPTDT'="" S ^PS(55,PATIENT,"IV","CIMOI",PSJCLIN,PSJSTDT,PS55IEN)=""
"RTN","PSJIMO1",29,0)
 ..I PSJAPTDT'="" S FLAG=1
"RTN","PSJIMO1",30,0)
 ;
"RTN","PSJIMO1",31,0)
 ;FILE 53.1
"RTN","PSJIMO1",32,0)
 S (PATIENT,PS531IEN)=""
"RTN","PSJIMO1",33,0)
 F  S PATIENT=$O(^PS(53.1,"AD",PSJCLIN,PATIENT)) Q:PATIENT=""  F  S PS531IEN=$O(^PS(53.1,"AD",PSJCLIN,PATIENT,PS531IEN)) Q:PS531IEN=""  D
"RTN","PSJIMO1",34,0)
 .K PSJUTMP D GETS^DIQ(53.1,PS531IEN,"28;126","I","PSJUTMP")
"RTN","PSJIMO1",35,0)
 .S (APPTDT,PSJTYPE)=""
"RTN","PSJIMO1",36,0)
 .S:$D(PSJUTMP(53.1,PS531IEN_",",126,"I")) APPTDT=PSJUTMP(53.1,PS531IEN_",",126,"I")
"RTN","PSJIMO1",37,0)
 .S:$D(PSJUTMP(53.1,PS531IEN_",",28,"I")) PSJTYPE=PSJUTMP(53.1,PS531IEN_",",28,"I")
"RTN","PSJIMO1",38,0)
 .Q:PSJTYPE'="P"&(PSJTYPE'="N")
"RTN","PSJIMO1",39,0)
 .Q:APPTDT=""!'CLINFLG
"RTN","PSJIMO1",40,0)
 .S ^PS(53.1,"CIMO",PATIENT,PSJCLIN,PS531IEN)="",FLAG=1
"RTN","PSJIMO1",41,0)
 Q
"RTN","PSJIMO1",42,0)
 ;
"RTN","PSJIMO1",43,0)
IMOKILL(CLINIC,PSCLINIC) ;
"RTN","PSJIMO1",44,0)
 S:'$G(PSCLINIC) PSCLINIC=""
"RTN","PSJIMO1",45,0)
 I $D(^PS(55,"CIMOCLU",CLINIC)) S PATIENT="" F  S PATIENT=$O(^PS(55,"CIMOCLU",CLINIC,PATIENT)) Q:PATIENT=""  D
"RTN","PSJIMO1",46,0)
 .K ^PS(55,"CIMOU",PATIENT,CLINIC)
"RTN","PSJIMO1",47,0)
 I $D(^PS(55,"CIMOCLI",CLINIC)) S PATIENT="" F  S PATIENT=$O(^PS(55,"CIMOCLU",CLINIC,PATIENT)) Q:PATIENT=""  D
"RTN","PSJIMO1",48,0)
 .K ^PS(55,PATIENT,"IV","CIMOI",CLINIC)
"RTN","PSJIMO1",49,0)
 K ^PS(55,"CIMOCLU",CLINIC),^PS(55,"CIMOCLI",CLINIC)
"RTN","PSJIMO1",50,0)
 I $D(^PS(53.1,"AD",CLINIC)) S PATIENT="" F  S PATIENT=$O(^PS(53.1,"AD",CLINIC,PATIENT)) Q:PATIENT=""  D
"RTN","PSJIMO1",51,0)
 .I $D(^PS(53.1,"CIMO",PATIENT,CLINIC)) K ^PS(53.1,"CIMO",PATIENT,CLINIC)
"RTN","PSJIMO1",52,0)
 Q
"RTN","PSJIMO1",53,0)
 ;
"RTN","PSJIMO1",54,0)
CIMOU(PSGP,PSJDA55,PSCLINIC,PSJDA531) ;IMO UNIT DOSE FILE 55 CROSS REFERENCE SET
"RTN","PSJIMO1",55,0)
 N PSJCLINI,CLINFLG,PSJIVIEN,PSJSTAT
"RTN","PSJIMO1",56,0)
 I $G(PSJDA531)="" S PSJDA531=""
"RTN","PSJIMO1",57,0)
 S PSJSTAT=""
"RTN","PSJIMO1",58,0)
 I '$G(PSCLINIC) S PSCLINIC="",PSCLINIC=$$GET1^DIQ(55.06,+PSJDA55_","_PSGP_",",130,"I")
"RTN","PSJIMO1",59,0)
 Q:PSCLINIC=""
"RTN","PSJIMO1",60,0)
 S CLINFLG="",CLINFLG=$$GET1^DIQ(44,PSCLINIC,2802,"I")  ;Only set xref if IMO clinic
"RTN","PSJIMO1",61,0)
 Q:'CLINFLG
"RTN","PSJIMO1",62,0)
 D GETS^DIQ(55.06,+PSJDA55_","_PSGP_",","34;131","I","PSJCLINI")
"RTN","PSJIMO1",63,0)
 I CLINFLG&($G(PSJCLINI(55.06,+PSJDA55_","_PSGP_",","131","I"))) D
"RTN","PSJIMO1",64,0)
 .S ^PS(55,"CIMOU",PSGP,PSCLINIC,PSJCLINI(55.06,+PSJDA55_","_PSGP_",","34","I"),PSGP,+PSJDA55)=""
"RTN","PSJIMO1",65,0)
 .S ^PS(55,"CIMOCLU",PSCLINIC,PSGP,+PSJDA55)=""
"RTN","PSJIMO1",66,0)
 S PSJIVIEN=$$GET1^DIQ(55.06,+PSJDA55_","_DFN_",",104)  ;pick up ien from file 55 since PSJORD/PSGORD can't be trusted.
"RTN","PSJIMO1",67,0)
 S:PSJIVIEN="" PSJIVIEN=PSJDA531
"RTN","PSJIMO1",68,0)
 I $G(PSJIVIEN)]"",'$D(^PS(53.1,"CIMO",PSGP,PSCLINIC,PSJIVIEN)) S PSJIVIEN=PSJDA531  ;for edits, if no CIMO entry, use the passed in IEN.  Non-edits will always have an entry.
"RTN","PSJIMO1",69,0)
 I +$G(PSJIVIEN) D KILL531(PSGP,PSCLINIC,+PSJIVIEN)
"RTN","PSJIMO1",70,0)
 Q
"RTN","PSJIMO1",71,0)
 ;
"RTN","PSJIMO1",72,0)
CIMOI(DFN,PSJDA55,PSCLINIC,PSJDA531) ;IMO IV FILE 55 CROSS REFERENCE SET
"RTN","PSJIMO1",73,0)
 N PSJCLINI,CLINFLG,PSJIVIEN,PSJSTAT
"RTN","PSJIMO1",74,0)
 S PSJSTAT=""
"RTN","PSJIMO1",75,0)
 I '$G(PSCLINIC) S PSCLINIC=$$GET1^DIQ(55.01,+PSJDA55_","_DFN_",",136,"I")
"RTN","PSJIMO1",76,0)
 Q:PSCLINIC=""
"RTN","PSJIMO1",77,0)
 S CLINFLG="",CLINFLG=$$GET1^DIQ(44,PSCLINIC,2802,"I")  ;Only set xref if IMO clinic
"RTN","PSJIMO1",78,0)
 Q:'CLINFLG
"RTN","PSJIMO1",79,0)
 D GETS^DIQ(55.01,+PSJDA55_","_DFN_",",".03","I","PSJCLINI")
"RTN","PSJIMO1",80,0)
 I $D(PSJCLINI(55.01,+PSJDA55_","_DFN_",",".03","I")) D
"RTN","PSJIMO1",81,0)
 .S ^PS(55,DFN,"IV","CIMOI",PSCLINIC,PSJCLINI(55.01,+PSJDA55_","_DFN_",",".03","I"),+PSJDA55)=""
"RTN","PSJIMO1",82,0)
 .S ^PS(55,"CIMOCLI",PSCLINIC,DFN,+PSJDA55)=""
"RTN","PSJIMO1",83,0)
 S PSJIVIEN=$$GET1^DIQ(55.01,+ON55_","_DFN_",",113)  ;if there, pick up ien from file 55 since PSJORD/PSGORD can't be trusted.
"RTN","PSJIMO1",84,0)
 I PSJIVIEN=""&(+$G(PSJDA531)) S PSJIVIEN=PSJDA531
"RTN","PSJIMO1",85,0)
 ;I '$D(^PS(53.1,"CIMO",PSGP,PSCLINIC,PSJIVIEN)) S PSJIVIEN=PSJDA531  ;for edits, if no CIMO entry, use the passed in IEN.  Non-edits will always have an entry.
"RTN","PSJIMO1",86,0)
 I +$G(PSJIVIEN) D KILL531(DFN,PSCLINIC,+PSJIVIEN)
"RTN","PSJIMO1",87,0)
 Q
"RTN","PSJIMO1",88,0)
 ;
"RTN","PSJIMO1",89,0)
KILL531(PSJCLPAT,PSCLINIC,PSJIVIEN) ;
"RTN","PSJIMO1",90,0)
 I '$G(PSCLINIC) S PSCLINIC=$$GET1^DIQ(53.1,+PSJIVIEN_","_PSJCLPAT_",",113,"I")
"RTN","PSJIMO1",91,0)
 Q:PSCLINIC=""
"RTN","PSJIMO1",92,0)
 I $D(^PS(53.1,"CIMO",PSJCLPAT,PSCLINIC,+PSJIVIEN)) K ^PS(53.1,"CIMO",PSJCLPAT,PSCLINIC,+PSJIVIEN)
"RTN","PSJIMO1",93,0)
 Q
"RTN","PSJIMO1",94,0)
 ;
"RTN","PSJIMO1",95,0)
GETCLN(PSGP,ORDER) ; Return Clinic IEN for a given patient/order combination
"RTN","PSJIMO1",96,0)
 I '$G(ORDER) Q ""
"RTN","PSJIMO1",97,0)
 N CLN S CLN=$S(ORDER["P":$G(^PS(53.1,+ORDER,"DSS")),ORDER["V":$G(^PS(55,PSGP,"IV",+ORDER,"DSS")),ORDER["U":$G(^PS(55,PSGP,5,+ORDER,8)),1:"")
"RTN","PSJIMO1",98,0)
 I 'CLN,(ORDER=+ORDER) D
"RTN","PSJIMO1",99,0)
 .I $D(^PS(53.1,"ACX",+ORDER)) N PSJORD S PSJORD=0 F  S PSJORD=$O(^PS(53.1,"ACX",+ORDER,PSJORD)) Q:'PSJORD!$G(CLN)  S CLN=$G(^PS(53.1,+PSJORD,"DSS"))
"RTN","PSJIMO1",100,0)
 .I $D(^PS(55,"ACX",+ORDER)) N ACX2,PSJORD S ACX2="" F  S ACX2=$O(^PS(55,"ACX",+ORDER,ACX2)) Q:'ACX2!$G(CLN)  S PSJORD=0 F  S PSJORD=$O(^PS(55,"ACX",+ORDER,ACX2,PSJORD)) Q:'PSJORD!$G(CLN)  D
"RTN","PSJIMO1",101,0)
 ..S CLN=$S(PSJORD["P":$G(^PS(53.1,+PSJORD,"DSS")),PSJORD["V":$G(^PS(55,PSGP,"IV",+PSJORD,"DSS")),ORDER["U":$G(^PS(55,PSGP,5,+PSJORD,8)),1:"")
"RTN","PSJIMO1",102,0)
 Q +CLN
"RTN","PSJIMO1",103,0)
 ;
"RTN","PSJIMO1",104,0)
CHECK() ;SET CONDITION FOR CIMOU XREF IN FILE 55
"RTN","PSJIMO1",105,0)
 ;UNIT DOSE - X2(1)=PATIENT, X2(2)=CLINIC, X2(3)=STOP DATE
"RTN","PSJIMO1",106,0)
 N PSJAPPTD,X S X=0
"RTN","PSJIMO1",107,0)
 Q:'$$IMOCHK(X2(2)) 0  ;don't set clinic x-refs where clinic isn't marked as IMO.
"RTN","PSJIMO1",108,0)
 S PSJAPPTD=$$GET1^DIQ(55.06,DA_","_X2(1)_",",131,"I")
"RTN","PSJIMO1",109,0)
 S:PSJAPPTD'="" X=1
"RTN","PSJIMO1",110,0)
 Q X
"RTN","PSJIMO1",111,0)
 ;
"RTN","PSJIMO1",112,0)
CHECK2() ;SET CONDITION FOR CIMOI XREF IN FILE 55
"RTN","PSJIMO1",113,0)
 ;IV - DA(1)=PATIENT, X2(1)=CLINIC, X2(2)=STOP DATE, DA=SUBFILE IEN
"RTN","PSJIMO1",114,0)
 N PSJAPPTD,X S X=0
"RTN","PSJIMO1",115,0)
 Q:'$$IMOCHK(X2(1)) 0  ;don't set clinic x-refs where clinic isn't marked as IMO.
"RTN","PSJIMO1",116,0)
 S PSJAPPTD=$$GET1^DIQ(55.01,DA_","_DA(1)_",",139,"I")
"RTN","PSJIMO1",117,0)
 S:PSJAPPTD'="" X=1
"RTN","PSJIMO1",118,0)
 Q X
"RTN","PSJIMO1",119,0)
 ;
"RTN","PSJIMO1",120,0)
IMOCHK(PSJIMOCL) ;determine if clinic is an IMO clinic; returns 1 if IMO or 0 not IMO
"RTN","PSJIMO1",121,0)
 Q:'$G(PSJIMOCL) 0
"RTN","PSJIMO1",122,0)
 N PSJCFLAG
"RTN","PSJIMO1",123,0)
 S PSJCFLAG=$$GET1^DIQ(44,PSJIMOCL,2802,"I")
"RTN","PSJIMO1",124,0)
 Q PSJCFLAG
"RTN","PSJIMO1",125,0)
 ;
"RTN","PSJIMO1",126,0)
CHECK3() ;SET CONDITION FOR CIMO XREF IN FILE 53.1
"RTN","PSJIMO1",127,0)
 ;  DA=IEN, X(1)=PATIENT, X(2)=CLINIC
"RTN","PSJIMO1",128,0)
 N PSJCFLAG,PSJAPPTD,X,PSJTYPE,PSJUTMP S X=0
"RTN","PSJIMO1",129,0)
 Q:'$$IMOCHK(X2(2)) 0  ;don't set clinic x-refs where clinic isn't marked as IMO.
"RTN","PSJIMO1",130,0)
 D GETS^DIQ(53.1,DA,"28;126","I","PSJUTMP")
"RTN","PSJIMO1",131,0)
 S X=0,(PSJAPPTD,PSJTYPE)=""
"RTN","PSJIMO1",132,0)
 S:$D(PSJUTMP(53.1,DA_",",126,"I")) PSJAPPTD=PSJUTMP(53.1,DA_",",126,"I")
"RTN","PSJIMO1",133,0)
 S:$D(PSJUTMP(53.1,DA_",",28,"I")) PSJTYPE=PSJUTMP(53.1,DA_",",28,"I")
"RTN","PSJIMO1",134,0)
 Q:PSJTYPE'="P"&(PSJTYPE'="N") 0  ;only pending and non-verified orders are allowed in the xref
"RTN","PSJIMO1",135,0)
 S:PSJAPPTD'="" X=1
"RTN","PSJIMO1",136,0)
 Q X
"RTN","PSJIMO1",137,0)
 ;
"RTN","PSJIMO1",138,0)
TEST ;KILL ALL IMO CROSS REFERENCES FOR A PARTICULAR CLINIC AND PATIENT
"RTN","PSJIMO1",139,0)
 N PSJTESCL,PSJTESPA
"RTN","PSJIMO1",140,0)
TEST2 ;
"RTN","PSJIMO1",141,0)
 K DIC S DIC="^PS(53.46,",DIC(0)="AELMQ",DIC("A")="Select CLINIC: ",DLAYGO=53.46 D ^DIC K DIC G DONE:Y=""!(Y<1)
"RTN","PSJIMO1",142,0)
 S PSJTESCL=$P(Y,"^",2)
"RTN","PSJIMO1",143,0)
 K DIC,PSGP,Y W !!,"Select "_$S($D(PSGDICA):PSGDICA_" ",1:"")_"PATIENT: " R X:DTIME S:'$T X="^" W:'$T $C(7) I "^"[X S (Y,PSGP)=-1 S QFLG=1 G DONE
"RTN","PSJIMO1",144,0)
 K DIC S DIC="^DPT(",DIC("W")="D DPT^PSJDPT",DIC(0)="QEMZ" D ^DPTLK K DIC
"RTN","PSJIMO1",145,0)
 S PSJTESPA=$P(Y,"^")
"RTN","PSJIMO1",146,0)
 ;
"RTN","PSJIMO1",147,0)
 K ^PS(55,PSJTESPA,"IV","CIMOI",PSJTESCL)
"RTN","PSJIMO1",148,0)
 K ^PS(55,"CIMOCLI",PSJTESCL)
"RTN","PSJIMO1",149,0)
 K ^PS(55,"CIMOU",PSJTESPA,PSJTESCL)
"RTN","PSJIMO1",150,0)
 K ^PS(55,"CIMOCLU",PSJTESCL)
"RTN","PSJIMO1",151,0)
 K ^PS(53.1,"CIMO",PSJTESPA,PSJTESCL)
"RTN","PSJIMO1",152,0)
 W !,"DELETED",!
"RTN","PSJIMO1",153,0)
DONE ;
"RTN","PSJIMO1",154,0)
 Q
"RTN","PSJIMO1",155,0)
 ;
"RTN","PSJIMO1",156,0)
CLEAN(DFN) ;Delete old entriers from clinic order xref; CALLED WHEN USER EXITS PATIENT IN IOE
"RTN","PSJIMO1",157,0)
 ;----get top of the range of dates stored for each clinic
"RTN","PSJIMO1",158,0)
 N PSCLINIC,PSTYPE,ENDDATE,RXDATE,CLNDAYS,CLNARRY,PSJIEN
"RTN","PSJIMO1",159,0)
 S (PSTYPE,PSCLINIC,CLNDAYS,CLNARRY)=""
"RTN","PSJIMO1",160,0)
 F PSTYPE="CIMOCLU","CIMOCLI" F  S PSCLINIC=$O(^PS(55,PSTYPE,PSCLINIC)) Q:PSCLINIC=""  D
"RTN","PSJIMO1",161,0)
 .S CLNDAYS=$$GET1^DIQ(53.46,PSCLINIC,6) S:CLNDAYS="" CLNDAYS=30  ;default to 30 days if not defined
"RTN","PSJIMO1",162,0)
 .D NOW^%DTC S X1=%,X2=-CLNDAYS D C^%DTC S CLNARRY($S(PSTYPE="CIMOCLU":"U",1:"V"),PSCLINIC)=X
"RTN","PSJIMO1",163,0)
 ;----kill x-refs for all unit dose entries older than the clinic begin date
"RTN","PSJIMO1",164,0)
 I $D(CLNARRY("U")) S PSCLINIC="" F  S PSCLINIC=$O(CLNARRY("U",PSCLINIC)) Q:PSCLINIC=""  D
"RTN","PSJIMO1",165,0)
 .S (RXDATE,ENDDATE)="",ENDDATE=CLNARRY("U",PSCLINIC)
"RTN","PSJIMO1",166,0)
 .F  S RXDATE=$O(^PS(55,"CIMOU",DFN,PSCLINIC,RXDATE)) Q:RXDATE=""  I RXDATE<ENDDATE K ^PS(55,"CIMOU",DFN,PSCLINIC,RXDATE) D
"RTN","PSJIMO1",167,0)
 ..S PSJIEN="" F  S PSJIEN=$O(^PS(55,"CIMOU",DFN,PSCLINIC,RXDATE,DFN,PSJIEN)) Q:PSJIEN=""  K ^PS(55,"CIMOU",DFN,PSCLINIC,RXDATE,DFN,PSJIEN)
"RTN","PSJIMO1",168,0)
 ;----kill x-refs for all IV entries older than the clinic begin date
"RTN","PSJIMO1",169,0)
 I $D(CLNARRY("V")) S PSCLINIC="" F  S PSCLINIC=$O(CLNARRY("V",PSCLINIC)) Q:PSCLINIC=""  D
"RTN","PSJIMO1",170,0)
 .S (RXDATE,ENDDATE)="",ENDDATE=CLNARRY("V",PSCLINIC)
"RTN","PSJIMO1",171,0)
 .F  S RXDATE=$O(^PS(55,DFN,"IV","CIMOI",PSCLINIC,RXDATE)) Q:RXDATE=""  I RXDATE<ENDDATE K ^PS(55,DFN,"IV","CIMOI",PSCLINIC,RXDATE) D
"RTN","PSJIMO1",172,0)
 ..S PSJIEN="" F  S PSJIEN=$O(^PS(55,DFN,"IV","CIMOI",PSCLINIC,RXDATE,PSJIEN)) Q:PSJIEN=""  K ^PS(55,DFN,"IV","CIMOI",PSCLINIC,RXDATE,PSJIEN)
"RTN","PSJIMO1",173,0)
 Q
"RTN","PSJIMO1",174,0)
 ;
"RTN","PSJPDRIN")
0^4^B224024675^B220627483
"RTN","PSJPDRIN",1,0)
PSJPDRIN ;BIR/MV-MAIN DRIVER PADE INVENTORY REPORT  ;11/15/2015
"RTN","PSJPDRIN",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**317,335**;16 DEC 97;Build 6
"RTN","PSJPDRIN",3,0)
 ;
"RTN","PSJPDRIN",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180.
"RTN","PSJPDRIN",5,0)
 ; Reference to DATA^PSN50P68 is supported by DBIA 4545.
"RTN","PSJPDRIN",6,0)
 ; Reference to DIC^PSSDI is supported by DBIA 4551.
"RTN","PSJPDRIN",7,0)
 ; Reference to ^%ZTLOAD is supported by DBIA 10063.
"RTN","PSJPDRIN",8,0)
 ; Reference to CLEAR^VALM1 is supported by DBIA 10116.
"RTN","PSJPDRIN",9,0)
 ; Reference to EN^DDIOL is supported by DBIA 10142.
"RTN","PSJPDRIN",10,0)
 ; Reference to ^%ZIS is supported by DBIA 10086.
"RTN","PSJPDRIN",11,0)
 ;
"RTN","PSJPDRIN",12,0)
 Q
"RTN","PSJPDRIN",13,0)
 ;
"RTN","PSJPDRIN",14,0)
EN ; Main Entry point
"RTN","PSJPDRIN",15,0)
 N PSJSTOP,PSDRG,PSJINP,DTOUT,DUOUT,DA,DIC,DR,DIR
"RTN","PSJPDRIN",16,0)
 S PSJSTOP=0
"RTN","PSJPDRIN",17,0)
 F  Q:$G(PSJSTOP)<0  D ENLOOP
"RTN","PSJPDRIN",18,0)
 Q
"RTN","PSJPDRIN",19,0)
 ;
"RTN","PSJPDRIN",20,0)
ENLOOP ; Prompt loop
"RTN","PSJPDRIN",21,0)
 N PSJINP,ZTSK,ZTDESC,ZTRTN,ZTSAVE
"RTN","PSJPDRIN",22,0)
 S PSJSTOP=0
"RTN","PSJPDRIN",23,0)
 D ASK(.PSJINP) G:PSJSTOP EXIT
"RTN","PSJPDRIN",24,0)
 Q:$G(PSJINP("PSJDEV"))="Q"
"RTN","PSJPDRIN",25,0)
START ; Queued entry
"RTN","PSJPDRIN",26,0)
 N PSJSTOP S PSJSTOP=0
"RTN","PSJPDRIN",27,0)
 K ^TMP("PSJPDRIN",$J)
"RTN","PSJPDRIN",28,0)
 D PROCESS(.PSJINP) G:PSJSTOP EXIT
"RTN","PSJPDRIN",29,0)
 D EN^PSJPDRIP(.PSJINP)
"RTN","PSJPDRIN",30,0)
 I $G(PSJINP("PSJDELM"))="D" D
"RTN","PSJPDRIN",31,0)
 .N DIR,X,Y S DIR(0)="EA"
"RTN","PSJPDRIN",32,0)
 .S DIR("A",1)=""
"RTN","PSJPDRIN",33,0)
 .S DIR("A",2)="The delimited report is complete."
"RTN","PSJPDRIN",34,0)
 .S DIR("A")="Please turn logging off, then press return to continue."
"RTN","PSJPDRIN",35,0)
 .D ^DIR
"RTN","PSJPDRIN",36,0)
 Q
"RTN","PSJPDRIN",37,0)
 ;
"RTN","PSJPDRIN",38,0)
EXIT ; Clean up
"RTN","PSJPDRIN",39,0)
 K ^TMP("PSJPDRIN",$J),ZTSK
"RTN","PSJPDRIN",40,0)
 Q
"RTN","PSJPDRIN",41,0)
 ;
"RTN","PSJPDRIN",42,0)
ASK(PSJINP) ;Prompt for selection criteria.  Quit when PSJSTOP is true
"RTN","PSJPDRIN",43,0)
 ;
"RTN","PSJPDRIN",44,0)
 N PSJCSUB,PSJSYS,PSJDEV,PSJDIV,PADEV,PSJSUMM,PSJDELIM,PSJDRG,PSDRG
"RTN","PSJPDRIN",45,0)
 D CLEAR^VALM1 W !!
"RTN","PSJPDRIN",46,0)
 S PSJSTOP=0
"RTN","PSJPDRIN",47,0)
 W ?20,"PADE On-Hand Inventory Report",!
"RTN","PSJPDRIN",48,0)
 S PSJINP("PSJPSYS")=$$PSYS Q:PSJSTOP
"RTN","PSJPDRIN",49,0)
 D DIV^PSJPDRIP(.PSJDIV,.PSJSTOP) Q:PSJSTOP  M PSJINP("PSJDIV")=PSJDIV
"RTN","PSJPDRIN",50,0)
 D PADEV(.PADEV,.PSJINP) Q:PSJSTOP  M PSJINP("PADEV")=PADEV
"RTN","PSJPDRIN",51,0)
 D PSJCSUB(.PSJINP,.PSJCSUB) Q:PSJSTOP  M PSJINP("PSJCSUB")=PSJCSUB
"RTN","PSJPDRIN",52,0)
 D DRUG(.PSDRG,.PSJINP) Q:PSJSTOP  M PSJINP("PSDRG")=PSDRG
"RTN","PSJPDRIN",53,0)
 S PSJINP("PSJSUM")=$$SUMM Q:PSJSTOP
"RTN","PSJPDRIN",54,0)
 S PSJINP("PSJDELM")=$$DELIM Q:PSJSTOP
"RTN","PSJPDRIN",55,0)
 S PSJINP("PSJDEV")=$$SELDEV(,.PSJINP) S:$G(DUOUT)!$G(DTOUT) PSJSTOP=1 Q:PSJSTOP
"RTN","PSJPDRIN",56,0)
 Q
"RTN","PSJPDRIN",57,0)
 ;
"RTN","PSJPDRIN",58,0)
PSYS() ; Get PADE Inventory System
"RTN","PSJPDRIN",59,0)
 N PSYS
"RTN","PSJPDRIN",60,0)
 S PSYS=$$PSYS^PSJPDRUT()
"RTN","PSJPDRIN",61,0)
 Q PSYS
"RTN","PSJPDRIN",62,0)
 ;
"RTN","PSJPDRIN",63,0)
DIV() ; Get Division
"RTN","PSJPDRIN",64,0)
 N PSDIV,DIC,X,Y
"RTN","PSJPDRIN",65,0)
 S DIC("S")="I $D(^PS(58.63,""D"",+Y))"
"RTN","PSJPDRIN",66,0)
 S DIC=40.8,DIC(0)="QAE",DIC("A")="Select Division: " D ^DIC
"RTN","PSJPDRIN",67,0)
 S PSDIV=$S(Y>0:+Y,1:"")
"RTN","PSJPDRIN",68,0)
 I $G(DUOUT)!$G(DTOUT)!(PSDIV="") S PSJSTOP=1
"RTN","PSJPDRIN",69,0)
 Q PSDIV
"RTN","PSJPDRIN",70,0)
 ;
"RTN","PSJPDRIN",71,0)
PADEV(PADEV,PSJINP) ; Get PADE dispensing device(s), screen for Division and PADE Inventory System
"RTN","PSJPDRIN",72,0)
 ;Requires PSJINP("PSJDIV"),PSJINP("PSJPSYS")
"RTN","PSJPDRIN",73,0)
 N PADNAM,PADIEN,PADTMP
"RTN","PSJPDRIN",74,0)
 D PADEV^PSJPDRTR(.PADEV,.PSJINP,1)
"RTN","PSJPDRIN",75,0)
 Q:($D(PADEV)<10)
"RTN","PSJPDRIN",76,0)
 M PADTMP=PADEV
"RTN","PSJPDRIN",77,0)
 K PADEV
"RTN","PSJPDRIN",78,0)
 S PADNAM=0 F  S PADNAM=$O(PADTMP(PADNAM)) Q:PADNAM=""  D
"RTN","PSJPDRIN",79,0)
 .Q:'$G(PADTMP(PADNAM))
"RTN","PSJPDRIN",80,0)
 .S PADEV(PADTMP(PADNAM))=PADNAM
"RTN","PSJPDRIN",81,0)
 Q
"RTN","PSJPDRIN",82,0)
 ;
"RTN","PSJPDRIN",83,0)
CAB(PSJINP,PADEV) ; Get PADE (cabinets) 
"RTN","PSJPDRIN",84,0)
 N PSCAB,DIC,X,Y,PSJDIV,PSJPSYS,PSJSCR,PSCABHLP,PSJX
"RTN","PSJPDRIN",85,0)
 S PSJDIV=$G(PSJINP("PSJDIV"))
"RTN","PSJPDRIN",86,0)
 S PSJPSYS=$G(PSJINP("PSJPSYS"))
"RTN","PSJPDRIN",87,0)
 S PSCABHLP="Select one or more PADE Dispensing Devices, or enter '^ALL' to select all."
"RTN","PSJPDRIN",88,0)
 S DIC("S")="I ($D(PSJINP(""PSJDIV"",+$G(^PS(58.63,+Y,2)))))&('$$EMPTY^PSJPADPT(+Y))"
"RTN","PSJPDRIN",89,0)
 S DIC=58.63,DIC(0)="QABE",DIC("A")="Select PADE Dispensing Device: "_$S($D(PADEV)<10:"^ALL// ",1:"")
"RTN","PSJPDRIN",90,0)
 S DIC("W")="N PSJPADST S PSJPADST=$P($G(^PS(58.63,+$G(Y),0)),""^"",4),PSJPADST=$S(PSJPADST=""I"":"" (INACTIVE)"",1:"""") W PSJPADST"
"RTN","PSJPDRIN",91,0)
 D ^DIC S PSJX=X
"RTN","PSJPDRIN",92,0)
 S:$E(PSJX)="^" Y=$$XALL^PSJPDRIP(PSJX)
"RTN","PSJPDRIN",93,0)
 I X="",$D(PADEV)<10 S Y="ALL"
"RTN","PSJPDRIN",94,0)
 S:Y=-1 Y=""
"RTN","PSJPDRIN",95,0)
 S PSCAB=Y
"RTN","PSJPDRIN",96,0)
 S:($G(DUOUT)&(PSCAB'="ALL"))!$G(DTOUT) PSJSTOP=1
"RTN","PSJPDRIN",97,0)
 Q PSCAB
"RTN","PSJPDRIN",98,0)
 ;
"RTN","PSJPDRIN",99,0)
PSJCSUB(PSJINP,PSJCSUB) ; Get Controlled Subs (CS) Schedules
"RTN","PSJPDRIN",100,0)
 N DIR,X,Y,PSJDONE,SCHED,SCHLST
"RTN","PSJPDRIN",101,0)
 K PSJCSUB
"RTN","PSJPDRIN",102,0)
 W ! D EN^DDIOL("  Enter '^ALL' to select all Controlled substance")
"RTN","PSJPDRIN",103,0)
 D EN^DDIOL("   schedules and all non-controlled substances.") W !
"RTN","PSJPDRIN",104,0)
 S DIR("A")="Enter (C)S or (N)on-CS: ^ALL//",DIR(0)="SAO^C:Controlled Substances;N:Non-Controlled Substances;ALL:All CS Schedules and Non-CS"
"RTN","PSJPDRIN",105,0)
 D ^DIR S:X="" Y="ALL"
"RTN","PSJPDRIN",106,0)
 I $E(X)="^" S Y=$$XALL^PSJPDRIP(X)
"RTN","PSJPDRIN",107,0)
 S PSJCSUB=Y
"RTN","PSJPDRIN",108,0)
 I PSJCSUB'="ALL"&($G(DUOUT)!$G(DTOUT)!(Y="")) S PSJSTOP=1 Q
"RTN","PSJPDRIN",109,0)
 S:PSJCSUB="N"!(PSJCSUB="ALL") PSJCSUB(0)="Unscheduled"
"RTN","PSJPDRIN",110,0)
 Q:PSJCSUB="N"
"RTN","PSJPDRIN",111,0)
 ; If YES to Controlled Subs, get CS Schedule
"RTN","PSJPDRIN",112,0)
 S SCHLST="1:Schedule I;2:Schedule II;2n:Schedule II Non-Narcotics;3:Schedule III;3n:Schedule III Non-Narcotics;4:Schedule IV;5:Schedule V"
"RTN","PSJPDRIN",113,0)
 I PSJCSUB="ALL" D ALLSCHED^PSJPDRIP(.PSJCSUB,SCHLST) S PSJCSUB="ALL" Q
"RTN","PSJPDRIN",114,0)
 K PSJDONE,PSJCSUB
"RTN","PSJPDRIN",115,0)
 N DIR,X,Y,SCNT
"RTN","PSJPDRIN",116,0)
 F  Q:$G(PSJSTOP)!$G(PSJDONE)  D SELCSUB^PSJPDRTR(.PSJCSUB)
"RTN","PSJPDRIN",117,0)
 Q
"RTN","PSJPDRIN",118,0)
 ;
"RTN","PSJPDRIN",119,0)
DRUG(DRUG,PSJINP) ; Allow user to select appropriate subset of drug items
"RTN","PSJPDRIN",120,0)
 N PSDONE,DIC,X,Y,GETDRG,LSTCNT,PSJCSUB,DRGARAY,PSJPSYS,PADEV,PSJDRC
"RTN","PSJPDRIN",121,0)
 S PSJCSUB=$G(PSJINP("PSJCSUB"))
"RTN","PSJPDRIN",122,0)
 S PSJPSYS=$G(PSJINP("PSJPSYS"))
"RTN","PSJPDRIN",123,0)
 M PADEV=PSJINP("PADEV")
"RTN","PSJPDRIN",124,0)
 D DRCAB(.PSJINP,.PSJDRC)         ; Get drugs linked to cabinet(s)
"RTN","PSJPDRIN",125,0)
 D DRUGSEL^PSJPDRTR(.PSJINP,.PSJDRC,.DRUG,,.PSJSTOP) ; Prompt for drug items
"RTN","PSJPDRIN",126,0)
 Q
"RTN","PSJPDRIN",127,0)
 ;
"RTN","PSJPDRIN",128,0)
SUMM() ; Prompt user for Detailed or Summary report
"RTN","PSJPDRIN",129,0)
 N SUMM,DIR,X,Y
"RTN","PSJPDRIN",130,0)
 S DIR(0)="S^D:Detailed Report;S:Summary Report"
"RTN","PSJPDRIN",131,0)
 S DIR("A")="Select (D)etail or (S)ummary Report "
"RTN","PSJPDRIN",132,0)
 S DIR("B")="S",DIR("?")="You may select 'D'  for a detailed report or 'S' for a Summary report."
"RTN","PSJPDRIN",133,0)
 D ^DIR S:$G(DUOUT)!$G(DTOUT) PSJSTOP=1
"RTN","PSJPDRIN",134,0)
 Q Y
"RTN","PSJPDRIN",135,0)
 ;
"RTN","PSJPDRIN",136,0)
DELIM() ; Prompt user for delimited output or formatted report.
"RTN","PSJPDRIN",137,0)
 N DELIM,DIR,X,Y
"RTN","PSJPDRIN",138,0)
 S DIR(0)="S^R:Report;D:Delimited Output"
"RTN","PSJPDRIN",139,0)
 S DIR("A")="Select (R)eport or (D)elimited output "
"RTN","PSJPDRIN",140,0)
 S DIR("B")="R",DIR("?")="You may select 'R' for a report or 'D' for CSV delimited output (for spreadsheet)"
"RTN","PSJPDRIN",141,0)
 D ^DIR S:$G(DUOUT)!$G(DTOUT) PSJSTOP=1
"RTN","PSJPDRIN",142,0)
 S DELIM=Y
"RTN","PSJPDRIN",143,0)
 Q DELIM
"RTN","PSJPDRIN",144,0)
 ;
"RTN","PSJPDRIN",145,0)
GETCLASS(DRGIEN) ; Get Controlled Substance Federal Schedule from VA PRODUCT FILE for DRUG FILE (#50) entry DRGIEN
"RTN","PSJPDRIN",146,0)
 ;  Input :  pointer to DRUG (#50) file
"RTN","PSJPDRIN",147,0)
 ; Output : Value from CS FEDERAL SCHEDULE field (#19) in VA PRODUCT (#50.68) file
"RTN","PSJPDRIN",148,0)
 N PSJDPROD,PSJCLASS,PSJNDF S PSJCLASS=0
"RTN","PSJPDRIN",149,0)
 Q:'$G(DRGIEN) "-1"
"RTN","PSJPDRIN",150,0)
 K ^TMP($J,"PSJCLASS")
"RTN","PSJPDRIN",151,0)
 S PSJNDF=$P($G(^PSDRUG(+DRGIEN,"ND")),"^",3) I '$G(PSJNDF) D  Q PSJCLASS
"RTN","PSJPDRIN",152,0)
 . N CS S CS=$P($G(^PSDRUG(+DRGIEN,0)),"^",3)
"RTN","PSJPDRIN",153,0)
 . S PSJCLASS=$S(+CS>1&(+CS<6):+CS,1:0) I ((PSJCLASS=2)!(PSJCLASS=3))&(CS["C") S PSJCLASS=PSJCLASS_"n"
"RTN","PSJPDRIN",154,0)
 D DATA^PSN50P68(PSJNDF,,"PSJCLASS")
"RTN","PSJPDRIN",155,0)
 S PSJCLASS=$P($G(^TMP($J,"PSJCLASS",+PSJNDF,19)),"^")
"RTN","PSJPDRIN",156,0)
 S PSJCLASS=$S(PSJCLASS]"":PSJCLASS,1:0)
"RTN","PSJPDRIN",157,0)
 K ^TMP($J,"PSJCLASS")
"RTN","PSJPDRIN",158,0)
 Q PSJCLASS
"RTN","PSJPDRIN",159,0)
 ;
"RTN","PSJPDRIN",160,0)
LISTDRG(SCREEN,DRGARAY) ; Get list of drugs from drug file screened by SCREEN, outpat DRGARAY
"RTN","PSJPDRIN",161,0)
 K DRGARAY
"RTN","PSJPDRIN",162,0)
 N DIC,X,Y
"RTN","PSJPDRIN",163,0)
 D LIST^DIC(50,,,"P",,,,,SCREEN,,"DRGARAY")
"RTN","PSJPDRIN",164,0)
 Q
"RTN","PSJPDRIN",165,0)
 ;
"RTN","PSJPDRIN",166,0)
PROCESS(PSJINP) ; Gather report data, store in ^TMP
"RTN","PSJPDRIN",167,0)
 I PSJINP("PSJSUM")="S" D PROCSUM(.PSJINP) Q
"RTN","PSJPDRIN",168,0)
 I PSJINP("PSJSUM")'="S" D PROCDET(.PSJINP)
"RTN","PSJPDRIN",169,0)
 Q
"RTN","PSJPDRIN",170,0)
 ;
"RTN","PSJPDRIN",171,0)
PROCSUM(PSJINP) ; Gather SUMMARY report data
"RTN","PSJPDRIN",172,0)
 N PSJCAB,PSJDRG,CC,LNCNT,TABMAR,PSJPSYS,PSJCABNM,PSJQTY,PSJDFORM,PSJII,PSJOI,PSJDFIEN,PSJCABST,PSJDRGX,PSJDNAM
"RTN","PSJPDRIN",173,0)
 S PSJINP("PSPGTOT")=1,LNCNT=1
"RTN","PSJPDRIN",174,0)
 S $P(TABMAR," ",40)=" "
"RTN","PSJPDRIN",175,0)
 S PSJPSYS=+PSJINP("PSJPSYS")
"RTN","PSJPDRIN",176,0)
 M PSJCAB=PSJINP("PADEV")
"RTN","PSJPDRIN",177,0)
 M PSJDRG=PSJINP("PSDRG")
"RTN","PSJPDRIN",178,0)
 S PSJCAB=0 F CC=0:1 S PSJCAB=$O(PSJCAB(PSJCAB)) Q:'PSJCAB  D
"RTN","PSJPDRIN",179,0)
 .S PSJCABNM=$P($G(^PS(58.63,PSJCAB,0)),"^"),PSJCABST=$P($G(^PS(58.63,PSJCAB,0)),"^",4),PSJCABST=$S(PSJCABST="I":"(I)",1:"")
"RTN","PSJPDRIN",180,0)
 .N PSJDRGX D ALPHADRG(PSJPSYS,PSJCAB,.PSJDRG,.PSJDRGX)
"RTN","PSJPDRIN",181,0)
 .I PSJINP("PSJDELM")="R" D
"RTN","PSJPDRIN",182,0)
 ..Q:'$D(PSJDRGX)
"RTN","PSJPDRIN",183,0)
 ..I $G(CC) S ^TMP("PSJPDRIN",$J,LNCNT)="^",LNCNT=LNCNT+1
"RTN","PSJPDRIN",184,0)
 ..S ^TMP("PSJPDRIN",$J,LNCNT)=PSJCABNM_PSJCABST,LNCNT=LNCNT+1
"RTN","PSJPDRIN",185,0)
 .S PSJDNAM="" F PSJII=1:1 S PSJDNAM=$O(PSJDRGX(PSJDNAM)) Q:PSJDNAM=""  S PSJDRG=0 S PSJDRG=$O(PSJDRGX(PSJDNAM,PSJDRG)) Q:'PSJDRG  D
"RTN","PSJPDRIN",186,0)
 ..S PSJCABNM=$S(PSJINP("PSJDELM")="D":PSJCABNM,1:"")
"RTN","PSJPDRIN",187,0)
 ..S PSJQTY=$$QTY(PSJPSYS,PSJCAB,PSJDRG)
"RTN","PSJPDRIN",188,0)
 ..S PSJOI=+$G(^PSDRUG(PSJDRG,2))
"RTN","PSJPDRIN",189,0)
 ..S PSJDFORM=$E($$DFORM(PSJPSYS,PSJCAB,PSJDRG),1,11)
"RTN","PSJPDRIN",190,0)
 ..I PSJDFORM="" S PSJDFIEN=$P($G(^PS(50.7,PSJOI,0)),"^",2) I PSJDFIEN D
"RTN","PSJPDRIN",191,0)
 ...N X,Y,DIC
"RTN","PSJPDRIN",192,0)
 ...S DIC(0)="XN",DIC="^PS(50.606,",X=+PSJDFIEN
"RTN","PSJPDRIN",193,0)
 ...D DIC^PSSDI(50.606,"PSJ",.DIC,.X)
"RTN","PSJPDRIN",194,0)
 ...S PSJDFORM=$P($G(Y),"^",2)
"RTN","PSJPDRIN",195,0)
 ..S ^TMP("PSJPDRIN",$J,LNCNT)=PSJCABNM_"^"_PSJDNAM_" ("_PSJDRG_")"_"^"_PSJDFORM_"^"_$S(PSJINP("PSJDELM")="R":$J(PSJQTY,4),1:PSJQTY),LNCNT=LNCNT+1
"RTN","PSJPDRIN",196,0)
 Q
"RTN","PSJPDRIN",197,0)
 ;
"RTN","PSJPDRIN",198,0)
PROCDET(PSJINP) ; Gather DETAIL report data
"RTN","PSJPDRIN",199,0)
 N PSJCAB,PSJDRG,CC,LNCNT,TABMAR,PSJPSYS,PSJCABNM,DRGTOT,QTY,PSJDFORM,PSJOI,PSJII,QTY,PSJCOL,PCKNAM
"RTN","PSJPDRIN",200,0)
 N PSJDFIEN,PSJDRNAM,PSJDRIEN,DRCNTOT
"RTN","PSJPDRIN",201,0)
 S PSJINP("PSPGTOT")=1,LNCNT=1
"RTN","PSJPDRIN",202,0)
 S $P(TABMAR," ",40)=" "
"RTN","PSJPDRIN",203,0)
 S PSJPSYS=+PSJINP("PSJPSYS")
"RTN","PSJPDRIN",204,0)
 M PSJCAB=PSJINP("PADEV")
"RTN","PSJPDRIN",205,0)
 M PSJDRG=PSJINP("PSDRG")
"RTN","PSJPDRIN",206,0)
 D SETCOLS^PSJPDRIP(.PSJINP,.PSJCOL)
"RTN","PSJPDRIN",207,0)
 S PSJDRIEN=0 F  S PSJDRIEN=$O(PSJDRG(PSJDRIEN)) Q:'PSJDRIEN  S PSJDRNAM=$P(PSJDRG(PSJDRIEN),"^") D
"RTN","PSJPDRIN",208,0)
 .S PSJDRNAM(PSJDRNAM_"^"_PSJDRIEN)=""
"RTN","PSJPDRIN",209,0)
 S PSJDRNAM="" F  S PSJDRNAM=$O(PSJDRNAM(PSJDRNAM)) Q:PSJDRNAM=""  D
"RTN","PSJPDRIN",210,0)
 .S PSJDRG=$P(PSJDRNAM,"^",2)
"RTN","PSJPDRIN",211,0)
 .N DRWPCK,PSBFLAG
"RTN","PSJPDRIN",212,0)
 .S:PSJINP("PSJDELM")="R" ^TMP("PSJPDRIN",$J,LNCNT)=" ^ ",LNCNT=LNCNT+1
"RTN","PSJPDRIN",213,0)
 .S DRGTOT=0,DRCNTOT=0
"RTN","PSJPDRIN",214,0)
 .S PSBFLAG=0     ; If a Patient Specific Bin is included in the list, set flag
"RTN","PSJPDRIN",215,0)
 .S PSJCAB=0 F  S PSJCAB=$O(PSJCAB(PSJCAB)) Q:'PSJCAB  I $D(^PS(58.601,"DEV",PSJCAB,PSJDRG)) D
"RTN","PSJPDRIN",216,0)
 ..N PSDRGLEN,PSJCABST,DRWPCK
"RTN","PSJPDRIN",217,0)
 ..S PSJCABST=$P($G(^PS(58.63,PSJCAB,0)),"^",4),PSJCABST=$S(PSJCABST="I":"(I)",1:"")
"RTN","PSJPDRIN",218,0)
 ..S PSJCABNM=$P($G(^PS(58.63,PSJCAB,0)),"^")_PSJCABST
"RTN","PSJPDRIN",219,0)
 ..S PSJQTY=$$QTY(PSJPSYS,PSJCAB,PSJDRG)
"RTN","PSJPDRIN",220,0)
 ..S DRGTOT=$G(DRGTOT)+PSJQTY
"RTN","PSJPDRIN",221,0)
 ..S PSJOI=+$G(^PSDRUG(PSJDRG,2))
"RTN","PSJPDRIN",222,0)
 ..S PSJDFIEN=$P($G(^PS(50.7,PSJOI,0)),"^",2)
"RTN","PSJPDRIN",223,0)
 ..S PSJDFORM=$$DFORM(PSJPSYS,PSJCAB,PSJDRG)
"RTN","PSJPDRIN",224,0)
 ..I PSJDFORM="" S PSJDFIEN=$P($G(^PS(50.7,PSJOI,0)),"^",2) I PSJDFIEN D
"RTN","PSJPDRIN",225,0)
 ...N X,Y,DIC
"RTN","PSJPDRIN",226,0)
 ...S DIC(0)="XN",DIC="^PS(50.606,",X=+PSJDFIEN
"RTN","PSJPDRIN",227,0)
 ...D DIC^PSSDI(50.606,"PSJ",.DIC,.X)
"RTN","PSJPDRIN",228,0)
 ...S PSJDFORM=$P($G(Y),"^",2)
"RTN","PSJPDRIN",229,0)
 ..D POCKDRG^PSJPDRIP(PSJPSYS,PSJCAB,PSJDRG,.DRWPCK)
"RTN","PSJPDRIN",230,0)
 ..N CC D  Q
"RTN","PSJPDRIN",231,0)
 ...S PCKNAM="" F CC=1:1 S PCKNAM=$O(DRWPCK(PSJDRG,PCKNAM)) Q:PCKNAM=""  D
"RTN","PSJPDRIN",232,0)
 ....N QTY,FMTQTY S QTY=+DRWPCK(PSJDRG,PCKNAM)
"RTN","PSJPDRIN",233,0)
 ....S DRCNTOT=$G(DRCNTOT)+QTY                           ; *Requires individual pocket balances for multi-pocket drugs*
"RTN","PSJPDRIN",234,0)
 ....N PSJDTRUN  ;  Handle max length drug names
"RTN","PSJPDRIN",235,0)
 ....S PSJDTRUN=$P($G(^PSDRUG(PSJDRG,0)),"^")
"RTN","PSJPDRIN",236,0)
 ....I $L(PSJDTRUN)>33 S PSJDTRUN=$E(PSJDTRUN,1,33)
"RTN","PSJPDRIN",237,0)
 ....S PSJDTRUN=PSJDTRUN_"("_PSJDRG_")"
"RTN","PSJPDRIN",238,0)
 ....S FMTQTY=$S(PCKNAM["PSB":"*"_QTY,$E(PCKNAM,$L(PCKNAM)-1,$L(PCKNAM))="RB":"*"_QTY,1:QTY)
"RTN","PSJPDRIN",239,0)
 ....I FMTQTY["*" D
"RTN","PSJPDRIN",240,0)
 .....S PSBFLAG("PSB")=$S($E(PCKNAM,$L(PCKNAM)-2,$L(PCKNAM))["PSB":1,1:$G(PSBFLAG("PSB")))
"RTN","PSJPDRIN",241,0)
 .....S PSBFLAG("RB")=$S($E(PCKNAM,$L(PCKNAM)-1,$L(PCKNAM))["RB":1,1:$G(PSBFLAG("RB")))
"RTN","PSJPDRIN",242,0)
 ....S ^TMP("PSJPDRIN",$J,LNCNT)=PSJDTRUN_"^"_PSJDFORM_"^"_$S(PSJINP("PSJDELM")="R":$J(FMTQTY,4),1:FMTQTY)_"^"_PSJCABNM_"^"_PCKNAM,LNCNT=LNCNT+1
"RTN","PSJPDRIN",243,0)
 ...I CC=1 N QTY,PSCABIEN,PSDRGIEN S PSCABIEN=$O(^PS(58.601,PSJPSYS,"DEVICE","B",PSJCAB,"")) D
"RTN","PSJPDRIN",244,0)
 ....S QTY="-" I PSCABIEN S PSDRGIEN=$O(^PS(58.601,PSJPSYS,"DEVICE",PSCABIEN,"DRUG","B",PSJDRG,""))
"RTN","PSJPDRIN",245,0)
 ....N PSJDTRUN  ;  Handle max length drug names
"RTN","PSJPDRIN",246,0)
 ....S PSJDTRUN=$P($G(^PSDRUG(PSJDRG,0)),"^")
"RTN","PSJPDRIN",247,0)
 ....I $L(PSJDTRUN)>33 S PSJDTRUN=$E(PSJDTRUN,1,33) S:$E(PSJDTRUN,$L(PSJDTRUN))=" " PSJDTRUN=$E(PSJDTRUN,1,$L(PSJDTRUN)-1)
"RTN","PSJPDRIN",248,0)
 ....S PSJDTRUN=PSJDTRUN_" ("_PSJDRG_")"
"RTN","PSJPDRIN",249,0)
 ....S ^TMP("PSJPDRIN",$J,LNCNT)=PSJDTRUN_"^"_PSJDFORM_"^"_$S(PSJINP("PSJDELM")="R":$J(QTY,4),1:QTY)_"^"_PSJCABNM_"^UNK",LNCNT=LNCNT+1
"RTN","PSJPDRIN",250,0)
 .I PSJINP("PSJDELM")="R" D
"RTN","PSJPDRIN",251,0)
 ..S ^TMP("PSJPDRIN",$J,LNCNT)=$E(TABMAR,1,34)_"^^----",LNCNT=LNCNT+1
"RTN","PSJPDRIN",252,0)
 ..S ^TMP("PSJPDRIN",$J,LNCNT)=$E(TABMAR,1,34)_"^SUB TOTAL:^"_$J(DRCNTOT,4),LNCNT=$G(LNCNT)+1
"RTN","PSJPDRIN",253,0)
 ..S ^TMP("PSJPDRIN",$J,LNCNT)=$E(TABMAR,1,24)_" REPORTED CABINET"_"^ TOTAL:^"_$J(DRGTOT,4),LNCNT=$G(LNCNT)+1
"RTN","PSJPDRIN",254,0)
 ..I $G(PSBFLAG("PSB")) S ^TMP("PSJPDRIN",$J,LNCNT)="* Patient Specific Bin counts not included in Reported Cabinet Total.",LNCNT=$G(LNCNT)+1
"RTN","PSJPDRIN",255,0)
 ..I $G(PSBFLAG("RB")) S ^TMP("PSJPDRIN",$J,LNCNT)="* Return Bin counts not included in Reported Cabinet Total.",LNCNT=$G(LNCNT)+1
"RTN","PSJPDRIN",256,0)
 Q
"RTN","PSJPDRIN",257,0)
 ;
"RTN","PSJPDRIN",258,0)
QTY(SYS,PSJCAB,PSJDRG) ; Return quantity of drug PSJDRG in cabinet PSJCAB
"RTN","PSJPDRIN",259,0)
 N QTY,PSYSIEN,PDEVIEN,PDRGIEN
"RTN","PSJPDRIN",260,0)
 S PSYSIEN=$O(^PS(58.601,"DEV",PSJCAB,PSJDRG,""))
"RTN","PSJPDRIN",261,0)
 S PDEVIEN=$O(^PS(58.601,"DEV",PSJCAB,PSJDRG,PSYSIEN,""))
"RTN","PSJPDRIN",262,0)
 S PDRGIEN=$O(^PS(58.601,"DEV",PSJCAB,PSJDRG,PSYSIEN,PDEVIEN,""))
"RTN","PSJPDRIN",263,0)
 S QTY=+$P($G(^PS(58.601,PSYSIEN,"DEVICE",PDEVIEN,"DRUG",PDRGIEN,0)),"^",3)
"RTN","PSJPDRIN",264,0)
 Q QTY
"RTN","PSJPDRIN",265,0)
 ;
"RTN","PSJPDRIN",266,0)
DFORM(SYS,PSJCAB,PSJDRG) ; Return Dose Form of drug PSJDRG in cabinet PSJCAB
"RTN","PSJPDRIN",267,0)
 N FORM,PSYSIEN,PDEVIEN,PDRGIEN
"RTN","PSJPDRIN",268,0)
 S PSYSIEN=$O(^PS(58.601,"DEV",PSJCAB,PSJDRG,""))
"RTN","PSJPDRIN",269,0)
 S PDEVIEN=$O(^PS(58.601,"DEV",PSJCAB,PSJDRG,PSYSIEN,""))
"RTN","PSJPDRIN",270,0)
 S PDRGIEN=$O(^PS(58.601,"DEV",PSJCAB,PSJDRG,PSYSIEN,PDEVIEN,""))
"RTN","PSJPDRIN",271,0)
 S FORM=$P($G(^PS(58.601,PSYSIEN,"DEVICE",PDEVIEN,"DRUG",PDRGIEN,0)),"^",5)
"RTN","PSJPDRIN",272,0)
 Q FORM
"RTN","PSJPDRIN",273,0)
 ;
"RTN","PSJPDRIN",274,0)
DRCAB(PSJINP,PSJDRCAB) ; Return list of drugs in each cabinet in PSJINP("PADEV")
"RTN","PSJPDRIN",275,0)
 ;   Input = PSJINP("PADEV",CABINET IEN) - Cabinet IEN points to PADE DISPENSING DEVICE file 58.63
"RTN","PSJPDRIN",276,0)
 ;  Output = PSJDRCAB(DRUG IEN)          - Drug IEN points to DRUG file 50
"RTN","PSJPDRIN",277,0)
 K PSJDRCAB
"RTN","PSJPDRIN",278,0)
 N CAB,CABDA,PSJPSYS,DRGDA,DRG
"RTN","PSJPDRIN",279,0)
 S PSJPSYS=$G(PSJINP("PSJPSYS"))
"RTN","PSJPDRIN",280,0)
 M CAB=PSJINP("PADEV")
"RTN","PSJPDRIN",281,0)
 S CAB=0 F  S CAB=$O(CAB(CAB)) Q:'CAB  S CABDA=$O(^PS(58.601,PSJPSYS,"DEVICE","B",CAB,0)) I CABDA D
"RTN","PSJPDRIN",282,0)
 .S DRGDA=0 F  S DRGDA=$O(^PS(58.601,PSJPSYS,"DEVICE",CABDA,"DRUG",DRGDA)) Q:'DRGDA  S DRG=+$G(^(DRGDA,0)) I DRG D
"RTN","PSJPDRIN",283,0)
 ..Q:$D(PSJDRCAB(DRG))
"RTN","PSJPDRIN",284,0)
 ..I '($G(PSJINP("PSJCSUB"))="ALL") Q:'$D(PSJINP("PSJCSUB",$$GETCLASS(DRG)))
"RTN","PSJPDRIN",285,0)
 ..S PSJDRCAB(DRG)=$P($G(^PSDRUG(+$G(DRG),0)),"^")
"RTN","PSJPDRIN",286,0)
 Q
"RTN","PSJPDRIN",287,0)
 ;
"RTN","PSJPDRIN",288,0)
LISTALL(DRGLIST) ; Write list of drugs in DRGLIST("IEN",DRUG IEN)
"RTN","PSJPDRIN",289,0)
 N II,DRGNAME,DRGIEN,TAB
"RTN","PSJPDRIN",290,0)
 S $P(TAB," ",80)=""
"RTN","PSJPDRIN",291,0)
 S DRGIEN=0 F  S DRGIEN=$O(DRGLIST("IEN",DRGIEN)) Q:'DRGIEN  D
"RTN","PSJPDRIN",292,0)
 .W !,$E(TAB,1,8-$L(DRGIEN))_DRGIEN_"  "_DRGLIST("IEN",DRGIEN)
"RTN","PSJPDRIN",293,0)
 Q
"RTN","PSJPDRIN",294,0)
 ;
"RTN","PSJPDRIN",295,0)
DRUGLIST(PSJINP,DRGLIST) ; Return DRGLIST array with "IEN" and "NAME" cross referenced
"RTN","PSJPDRIN",296,0)
 N I,DRG,DLST
"RTN","PSJPDRIN",297,0)
 S DRG=0 F I=1:1 S DRG=$O(DRGLIST(DRG)) Q:'DRG  D
"RTN","PSJPDRIN",298,0)
 .N DRGNAME S DRGNAME=$G(DRGLIST(DRG))
"RTN","PSJPDRIN",299,0)
 .S DRGLIST("IEN",DRG)=DRGNAME
"RTN","PSJPDRIN",300,0)
 .S DRGLIST("NAME",DRGNAME)=DRG
"RTN","PSJPDRIN",301,0)
 Q
"RTN","PSJPDRIN",302,0)
 ;
"RTN","PSJPDRIN",303,0)
SELDEV(RTN,PSJINP,PSJWIDE,ZTSK) ; Select Device
"RTN","PSJPDRIN",304,0)
 ;
"RTN","PSJPDRIN",305,0)
 N PSJDONE
"RTN","PSJPDRIN",306,0)
 ;
"RTN","PSJPDRIN",307,0)
 I $G(PSJINP("PSJDELM"))="D" D
"RTN","PSJPDRIN",308,0)
 .N DIR,X,Y
"RTN","PSJPDRIN",309,0)
 .S DIR("A",1)=""
"RTN","PSJPDRIN",310,0)
 .S DIR("A",2)="     ************************************************************"
"RTN","PSJPDRIN",311,0)
 .S DIR("A",3)="     **  You selected a Delimited report. Please verify you    **"
"RTN","PSJPDRIN",312,0)
 .S DIR("A",4)="     **  you have turned logging on to capture the output.     **"
"RTN","PSJPDRIN",313,0)
 .S DIR("A",5)="     **                                                        **"
"RTN","PSJPDRIN",314,0)
 .S DIR("A",6)="     **  To avoid undesired wrapping, please enter '0;512;999' **"
"RTN","PSJPDRIN",315,0)
 .S DIR("A",7)="     **  at the 'DEVICE:' prompt. You may need to set your     **"
"RTN","PSJPDRIN",316,0)
 .S DIR("A",8)="     **  Terminal Session display settings to 512 columns.     **"
"RTN","PSJPDRIN",317,0)
 .S DIR("A",9)="     ************************************************************"
"RTN","PSJPDRIN",318,0)
 .S DIR("A",10)=""
"RTN","PSJPDRIN",319,0)
 .S DIR("A",11)="",DIR("A",12)=""
"RTN","PSJPDRIN",320,0)
 .S DIR("A")=" Press return to continue"
"RTN","PSJPDRIN",321,0)
 .S DIR(0)="EA" D ^DIR W !
"RTN","PSJPDRIN",322,0)
 ;
"RTN","PSJPDRIN",323,0)
 W !,"This report is designed for a "_$S($G(PSJWIDE):132,1:80)_" column format."
"RTN","PSJPDRIN",324,0)
 W !,"You may queue this report to print at a later time.",!
"RTN","PSJPDRIN",325,0)
 F  Q:$G(PSJSTOP)!$G(PSJDONE)  D
"RTN","PSJPDRIN",326,0)
 .K %ZIS,IOP,POP,ZTSK N I S PSJION=$I,%ZIS="QM"
"RTN","PSJPDRIN",327,0)
 .D ^%ZIS K %ZIS
"RTN","PSJPDRIN",328,0)
 .I POP S IOP=PSJION D ^%ZIS K IOP,PSJION D  Q
"RTN","PSJPDRIN",329,0)
 ..N DIR,X,Y
"RTN","PSJPDRIN",330,0)
 ..S DIR(0)="YA",DIR("A",1)="  ** No Device Selected **",DIR("A")="Select a different device? (Y/N) " D ^DIR
"RTN","PSJPDRIN",331,0)
 ..S:'Y PSJSTOP=1
"RTN","PSJPDRIN",332,0)
 .S PSJDONE=1
"RTN","PSJPDRIN",333,0)
 ;
"RTN","PSJPDRIN",334,0)
 K PSJION I $D(IO("Q")) D  Q "Q"
"RTN","PSJPDRIN",335,0)
 .S ZTDESC="PADE Inventory Report",ZTRTN=$S($G(RTN)]"":$G(RTN),1:"START^PSJPDRIN")
"RTN","PSJPDRIN",336,0)
 .F I="PSJINP(","IO" S ZTSAVE(I)=""
"RTN","PSJPDRIN",337,0)
 .K IO("Q") D ^%ZTLOAD W:$D(ZTSK) !,"Report is Queued to print!"
"RTN","PSJPDRIN",338,0)
 Q ""
"RTN","PSJPDRIN",339,0)
 ;
"RTN","PSJPDRIN",340,0)
CONT(PGCNT,PSJQUIT,TMPLN) ; Press return to continue
"RTN","PSJPDRIN",341,0)
 N DIR
"RTN","PSJPDRIN",342,0)
 I ($E($G(IOST))="C") W ! D
"RTN","PSJPDRIN",343,0)
 .S:'$D(DIR("A")) DIR("A")="Press Return to continue or '^' to exit"
"RTN","PSJPDRIN",344,0)
 .S DIR(0)="FO"
"RTN","PSJPDRIN",345,0)
 .D ^DIR K DIR
"RTN","PSJPDRIN",346,0)
 .I $G(DTOUT)!$G(DUOUT) S PSJSTOP=1
"RTN","PSJPDRIN",347,0)
 Q
"RTN","PSJPDRIN",348,0)
 ;
"RTN","PSJPDRIN",349,0)
ALPHADRG(SYS,CAB,DRG,DRGX)  ; Alphabetize drug names DRGNAME in DRG(IEN)=DRGNAME, return in DRG(DRGNAME,IEN)=""
"RTN","PSJPDRIN",350,0)
 N DRGIEN,DRGNAME
"RTN","PSJPDRIN",351,0)
 S DRGIEN=0 F  S DRGIEN=$O(DRG(DRGIEN)) Q:'DRGIEN  S DRGNAME=$G(DRG(DRGIEN)) I DRGNAME]"" D
"RTN","PSJPDRIN",352,0)
 .Q:'$D(^PS(58.601,"DEV",CAB,DRGIEN))
"RTN","PSJPDRIN",353,0)
 .S DRGX(DRGNAME,DRGIEN)=""
"RTN","PSJPDRIN",354,0)
 Q
"RTN","PSJPDRIN",355,0)
 ;
"RTN","PSJPDRIN",356,0)
POCKET(PSJINP,PSDRG,OUTPOCK) ; Get pocket(s)
"RTN","PSJPDRIN",357,0)
 ;
"RTN","PSJPDRIN",358,0)
 N DRAWER,POCKET,DRGPCK,PSJPSYS,PADIEN,PADEV,DRGDEV,DRWIEN,DRGDRW,SUB,SUBID
"RTN","PSJPDRIN",359,0)
 S PSJPSYS=$G(PSJINP("PSJPSYS")),PADEV=$G(PSJINP("PADEV"))
"RTN","PSJPDRIN",360,0)
 S PADIEN=$O(^PS(58.601,+PSJPSYS,"DEVICE","B",+PADEV,""))
"RTN","PSJPDRIN",361,0)
 Q:'$G(PSDRG)!'$G(PSJPSYS)!'$G(PADIEN)
"RTN","PSJPDRIN",362,0)
 ;
"RTN","PSJPDRIN",363,0)
 S OUTPOCK=PSDRG
"RTN","PSJPDRIN",364,0)
 S DRWIEN=0 F  S DRWIEN=$O(^PS(58.601,+PSJPSYS,"DEVICE",+PADIEN,"DRAWER",DRWIEN)) Q:'DRWIEN  D
"RTN","PSJPDRIN",365,0)
 .S SUB=0 F  S SUB=$O(^PS(58.601,PSJPSYS,"DEVICE",PADIEN,"DRAWER",DRWIEN,"SUB",SUB)) Q:'SUB  D
"RTN","PSJPDRIN",366,0)
 ..S DRGPCK=$P(^PS(58.601,PSJPSYS,"DEVICE",PADIEN,"DRAWER",DRWIEN,"SUB",SUB,0),"^",5),POCKET=$P(^(0),"^",3),SUBID=$P($G(^(0)),"^",4)
"RTN","PSJPDRIN",367,0)
 ..Q:'(DRGPCK=$G(PSDRG))
"RTN","PSJPDRIN",368,0)
 ..S DRAWER=$G(^PS(58.601,+PSJPSYS,"DEVICE",+PADIEN,"DRAWER",DRWIEN,0))
"RTN","PSJPDRIN",369,0)
 ..S:DRAWER="" DRAWER="~~"
"RTN","PSJPDRIN",370,0)
 ..S POCKET=DRAWER_"_"_POCKET
"RTN","PSJPDRIN",371,0)
 ..S DRGDRW=$O(^PS(58.601,PSJPSYS,"DEVICE",PADIEN,"DRAWER",DRWIEN,"DRUG","B",PSDRG,""))
"RTN","PSJPDRIN",372,0)
 ..S OUTPOCK(DRGPCK,DRWIEN,SUB)=POCKET_"^"_DRGDRW_"^"_DRAWER_$S($L(SUBID):"^"_SUBID,1:"")
"RTN","PSJPDRIN",373,0)
 S DRGDEV=$O(^PS(58.601,PSJPSYS,"DEVICE",PADIEN,"DRUG","B",PSDRG,""))
"RTN","PSJPDRIN",374,0)
 S OUTPOCK(PSDRG,"DRGDEV")=DRGDEV
"RTN","PSJPDRIN",375,0)
 Q
"VER")
8.0^22.2
"BLD",10378,6)
^294
**END**
**END**

