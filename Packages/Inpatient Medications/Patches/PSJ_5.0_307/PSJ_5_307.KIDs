KIDS Distribution saved on Dec 22, 2015@14:43:01
PSJ*5*307
**KIDS**:PSJ*5.0*307^

**INSTALL NAME**
PSJ*5.0*307
"BLD",8920,0)
PSJ*5.0*307^INPATIENT MEDICATIONS^0^3151222^y
"BLD",8920,1,0)
^^1^1^3150909^^
"BLD",8920,1,1,0)
Inpatient Medications support for CPRS v30.
"BLD",8920,4,0)
^9.64PA^^
"BLD",8920,6.3)
18
"BLD",8920,"ABPKG")
n
"BLD",8920,"KRN",0)
^9.67PA^779.2^20
"BLD",8920,"KRN",.4,0)
.4
"BLD",8920,"KRN",.401,0)
.401
"BLD",8920,"KRN",.402,0)
.402
"BLD",8920,"KRN",.403,0)
.403
"BLD",8920,"KRN",.5,0)
.5
"BLD",8920,"KRN",.84,0)
.84
"BLD",8920,"KRN",3.6,0)
3.6
"BLD",8920,"KRN",3.8,0)
3.8
"BLD",8920,"KRN",9.2,0)
9.2
"BLD",8920,"KRN",9.8,0)
9.8
"BLD",8920,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",8920,"KRN",9.8,"NM",1,0)
PSJHL10^^0^B77000666
"BLD",8920,"KRN",9.8,"NM",2,0)
PSJIMO1^^0^B68607232
"BLD",8920,"KRN",9.8,"NM",3,0)
PSJ53P46^^0^B1789187
"BLD",8920,"KRN",9.8,"NM","B","PSJ53P46",3)

"BLD",8920,"KRN",9.8,"NM","B","PSJHL10",1)

"BLD",8920,"KRN",9.8,"NM","B","PSJIMO1",2)

"BLD",8920,"KRN",19,0)
19
"BLD",8920,"KRN",19.1,0)
19.1
"BLD",8920,"KRN",101,0)
101
"BLD",8920,"KRN",409.61,0)
409.61
"BLD",8920,"KRN",771,0)
771
"BLD",8920,"KRN",779.2,0)
779.2
"BLD",8920,"KRN",870,0)
870
"BLD",8920,"KRN",8989.51,0)
8989.51
"BLD",8920,"KRN",8989.52,0)
8989.52
"BLD",8920,"KRN",8994,0)
8994
"BLD",8920,"KRN","B",.4,.4)

"BLD",8920,"KRN","B",.401,.401)

"BLD",8920,"KRN","B",.402,.402)

"BLD",8920,"KRN","B",.403,.403)

"BLD",8920,"KRN","B",.5,.5)

"BLD",8920,"KRN","B",.84,.84)

"BLD",8920,"KRN","B",3.6,3.6)

"BLD",8920,"KRN","B",3.8,3.8)

"BLD",8920,"KRN","B",9.2,9.2)

"BLD",8920,"KRN","B",9.8,9.8)

"BLD",8920,"KRN","B",19,19)

"BLD",8920,"KRN","B",19.1,19.1)

"BLD",8920,"KRN","B",101,101)

"BLD",8920,"KRN","B",409.61,409.61)

"BLD",8920,"KRN","B",771,771)

"BLD",8920,"KRN","B",779.2,779.2)

"BLD",8920,"KRN","B",870,870)

"BLD",8920,"KRN","B",8989.51,8989.51)

"BLD",8920,"KRN","B",8989.52,8989.52)

"BLD",8920,"KRN","B",8994,8994)

"BLD",8920,"QUES",0)
^9.62^^
"BLD",8920,"REQB",0)
^9.611^2^1
"BLD",8920,"REQB",2,0)
PSJ*5.0*311^2
"BLD",8920,"REQB","B","PSJ*5.0*311",2)

"MBREQ")
0
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
307^3151222
"PKG",197,22,1,"PAH",1,1,0)
^^1^1^3151222
"PKG",197,22,1,"PAH",1,1,1,0)
Inpatient Medications support for CPRS v30.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSJ53P46")
0^3^B1789187
"RTN","PSJ53P46",1,0)
PSJ53P46 ;SLC/JLC - API FOR INFORMATION FROM FILE 53.46; ;12/21/15  12:14
"RTN","PSJ53P46",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**307**;16 DEC 97;Build 18
"RTN","PSJ53P46",3,0)
 ;
"RTN","PSJ53P46",4,0)
 ;
"RTN","PSJ53P46",5,0)
 ;
"RTN","PSJ53P46",6,0)
ALL(PSJIEN,LIST) ;
"RTN","PSJ53P46",7,0)
 ;PSJIEN - IEN of CLINIC from the HOSPITAL LOCATION file (#44).
"RTN","PSJ53P46",8,0)
 ;LIST - Subscript of ^TMP array in the form ^TMP($J,LIST,Field Number where Field Number is the
"RTN","PSJ53P46",9,0)
 ;       Field Number of the data piece being returned.
"RTN","PSJ53P46",10,0)
 ;Returns NUMBER OF DAYS UNTIL STOP (#1), AUTO-DC IMO ORDERS (#2), SEND TO BCMA? (#3)
"RTN","PSJ53P46",11,0)
 ;        IMO DC/EXPIRED DATE LIMIT (#6), PRE-EXCHANGE REPORT DEVICE (#5), MISSING DOSE PRINTER (#4)
"RTN","PSJ53P46",12,0)
 N PSJ53P46,PSJ,PSJIEN2,PSJIEN3
"RTN","PSJ53P46",13,0)
 I $G(LIST)="" Q
"RTN","PSJ53P46",14,0)
 K ^TMP($J,LIST)
"RTN","PSJ53P46",15,0)
 I $G(PSJIEN)="" S ^TMP($J,LIST,0)="-1^NO CLINIC SPECIFIED" Q
"RTN","PSJ53P46",16,0)
 I $G(PSJIEN)]"",+$G(PSJIEN)'>0 S ^TMP($J,LIST,0)="-1^NO DATA FOUND" Q
"RTN","PSJ53P46",17,0)
 I $G(PSJIEN)]"",'$D(^PS(53.46,"B",PSJIEN)) S ^TMP($J,LIST,0)="-1^NO DATA FOUND"
"RTN","PSJ53P46",18,0)
 S PSJIEN3=$O(^PS(53.46,"B",PSJIEN,""))
"RTN","PSJ53P46",19,0)
 I +$G(PSJIEN3)>0 D
"RTN","PSJ53P46",20,0)
 . S ^TMP($J,LIST,0)=1
"RTN","PSJ53P46",21,0)
 . D GETS^DIQ(53.46,+PSJIEN3,"1;2;3;4;5;6","IE","PSJ53P46")
"RTN","PSJ53P46",22,0)
 . S PSJ(1)=$O(PSJ53P46(53.46,"")) Q:'PSJ(1)  D SETALL
"RTN","PSJ53P46",23,0)
 K ^TMP("DILIST",$J)
"RTN","PSJ53P46",24,0)
 Q
"RTN","PSJ53P46",25,0)
 ;
"RTN","PSJ53P46",26,0)
SETALL ;
"RTN","PSJ53P46",27,0)
 N I
"RTN","PSJ53P46",28,0)
 F I=1:1:6 S ^TMP($J,LIST,1,I)=$G(PSJ53P46(53.46,PSJ(1),I,"I"))_"^"_$G(PSJ53P46(53.46,PSJ(1),I,"E"))
"RTN","PSJ53P46",29,0)
 Q
"RTN","PSJ53P46",30,0)
 ;
"RTN","PSJHL10")
0^1^B77000666
"RTN","PSJHL10",1,0)
PSJHL10 ;BIR/LDT,BSJ-VALIDATE INCOMING HL7 DATA/CREATE NEW ORDER ;30 MAY 07
"RTN","PSJHL10",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**58,78,91,109,110,195,257,307**;16 DEC 97;Build 18
"RTN","PSJHL10",3,0)
 ;
"RTN","PSJHL10",4,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192.
"RTN","PSJHL10",5,0)
 ; Reference to ^PS(51.2 is supported by DBIA# 2178.
"RTN","PSJHL10",6,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJHL10",7,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231.
"RTN","PSJHL10",8,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173.
"RTN","PSJHL10",9,0)
 ; Reference to ^PSBAPIPM is supported by DBIA# 3564.
"RTN","PSJHL10",10,0)
 ; Reference to ^ORERR is supported by DBIA# 2187.
"RTN","PSJHL10",11,0)
 ;
"RTN","PSJHL10",12,0)
VALID ;
"RTN","PSJHL10",13,0)
 ;Call BCMA for rest of data
"RTN","PSJHL10",14,0)
 D MOB^PSBAPIPM(PSJHLDFN,+PSJORDER)
"RTN","PSJHL10",15,0)
 N DATA0,CHK S DATA0=$G(^TMP("PSB",$J,0)) I DATA0=-1 S PSREASON="""YOUR ORDER WAS NOT SAVED. EXIT BCMA, SIGN BACK IN, THEN TRY AGAIN.""" D ERROR Q
"RTN","PSJHL10",16,0)
 I $P(DATA0,"^")'=PSJHLDFN S PSREASON="Patient does not match" D ERROR Q
"RTN","PSJHL10",17,0)
 I $P(DATA0,"^",2)'=+PSJORDER S PSREASON="Order number does not match" D ERROR Q
"RTN","PSJHL10",18,0)
 N VAIP S DFN=PSJHLDFN,VAIP("D")=$G(LOGIN) D IN5^VADPT
"RTN","PSJHL10",19,0)
 ;If UD do UD set/validate.
"RTN","PSJHL10",20,0)
 I $P(DATA0,"^",3)="" D UDSET
"RTN","PSJHL10",21,0)
 ;If IV do IV set/validate.
"RTN","PSJHL10",22,0)
 I $P(DATA0,"^",3)]"" D IVSET
"RTN","PSJHL10",23,0)
 D:'CHK EN1^PSJHL2(PSJHLDFN,"OK",PSGORD),EN1^PSJHL2(PSJHLDFN,"SC",PSGORD),EN1^PSJHL2(PSJHLDFN,"ZV",PSGORD),MOBR^PSBAPIPM(PSJHLDFN,+PSJORDER,PSGORD)
"RTN","PSJHL10",24,0)
 Q
"RTN","PSJHL10",25,0)
 ;
"RTN","PSJHL10",26,0)
ERROR ;Sends error msg to CPRS, logs error in OE/RR Errors file
"RTN","PSJHL10",27,0)
 S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(PSREASON,.PSJMSG),MOBR^PSBAPIPM(PSJHLDFN,+PSJORDER)
"RTN","PSJHL10",28,0)
 D EN1^PSJHLERR(PSJHLDFN,"OC",PSJORDER,PSREASON) S QFLG=1 K ^TMP("PSJNVO",$J),^TMP("PSB",$J)
"RTN","PSJHL10",29,0)
 Q
"RTN","PSJHL10",30,0)
 ;
"RTN","PSJHL10",31,0)
UDSET ;Set up UD variables
"RTN","PSJHL10",32,0)
 N PSGPR,PSGMR,PSGSM,PSGHSM,PSGST,PSGP,PSGSCH,PSGPDRG,PSGDO,PSGNESD,PSGNEFD,PSGOEAV,PSJSYSU,PSGS0XT,PSGS0Y
"RTN","PSJHL10",33,0)
 S PSGPR=PROVIDER,PSGMR=ROUTE,PSGSM=0,PSGHSM="",PSGST="O",PSGP=PSJHLDFN,PSGSCH=SCHEDULE,PSGPDRG=PSITEM
"RTN","PSJHL10",34,0)
 S (PSGNESD,PSGNEFD)=+$P(DATA0,"^",5),PSGOEAV=1,PSJSYSU=1,PSGS0XT="O",PSGS0Y=""
"RTN","PSJHL10",35,0)
 I $G(DOSE)]"",$G(UNIT)]"" S PSGDO=DOSE_UNIT
"RTN","PSJHL10",36,0)
 I $G(PSGDO)']"",$G(INSTR)]"" S PSGDO=$$TRIM^XLFSTR(INSTR,"R"," ")
"RTN","PSJHL10",37,0)
 S CHK=""
"RTN","PSJHL10",38,0)
 S ND=U_PSGPR_U_PSGMR_"^U^"_PSGSM_U_PSGHSM_U_PSGST_"^^"_"E"_"^^^^^"_LOGIN_U_PSGP_U_LOGIN
"RTN","PSJHL10",39,0)
 D CHK("^^"_PSGMR_"^^^^"_PSGST,PSGPDRG_U_PSGDO,PSGSCH_U_PSGNESD_"^^"_PSGNEFD)
"RTN","PSJHL10",40,0)
 I CHK D ERROR Q
"RTN","PSJHL10",41,0)
 I PSGSCH'="STAT",PSGSCH'="NOW" S PSREASON="Invalid Schedule" S CHK=1 D ERROR Q
"RTN","PSJHL10",42,0)
 I $D(^XUSEC("ORELSE",DUZ)),ORDCON'="V",ORDCON'="P" S PSREASON="Invalid Nature of Order" S CHK=1 D ERROR Q
"RTN","PSJHL10",43,0)
 D:'$D(^PS(55,PSGP,0)) ENSET0^PSGNE3(PSGP) S $P(^PS(55,PSGP,5.1),U,2)=PSGPR,PSGOEPR=PSGPR
"RTN","PSJHL10",44,0)
 S ND0=ND D ENGNA^PSGOETO
"RTN","PSJHL10",45,0)
 I $D(^PS(51.2,+PSGMR,0)),$P(^(0),U,3)]"" S PSGMRN=$P(^(0),U,3)
"RTN","PSJHL10",46,0)
 S ND0=DA_ND0
"RTN","PSJHL10",47,0)
 S $P(ND0,"^",21)=PSJORDER
"RTN","PSJHL10",48,0)
 S ND2=PSGSCH_U_PSGNESD_"^^"_PSGNEFD_U_PSGS0Y_U_PSGS0XT_"^^^^"_+VAIP(5)
"RTN","PSJHL10",49,0)
 S $P(ND4,U,7)=DUZ I PSGOEAV,PSJSYSU D
"RTN","PSJHL10",50,0)
 .S $P(ND4,U,PSJSYSU,PSJSYSU+1)=DUZ_U_+$P(DATA0,"^",5),$P(ND4,U,+PSJSYSU=1+9)=1,$P(ND4,U,+PSJSYSU=3+9)=0
"RTN","PSJHL10",51,0)
 .S $P(ND4,U,9,10)=+$P(ND4,U,9)_U_+$P(ND4,U,10)
"RTN","PSJHL10",52,0)
 .I '$P(ND4,U,9) S ^PS(55,"APV",PSGP,DA)=""
"RTN","PSJHL10",53,0)
 .I '$P(ND4,U,10) S ^PS(55,"NPV",PSGP,DA)=""
"RTN","PSJHL10",54,0)
 .I $P(ND4,U,9) K ^PS(55,"APV",PSGP,DA)
"RTN","PSJHL10",55,0)
 .I $P(ND4,U,10) K ^PS(55,"NPV",PSGP,DA)
"RTN","PSJHL10",56,0)
 S F="^PS(55,"_PSGP_",5,"_DA_",",@(F_"0)")=ND0
"RTN","PSJHL10",57,0)
 ;naked reference on the four (4) lines below refer to the full ref to ^PS(55,PSGP,5,DA created by indirection using variable F
"RTN","PSJHL10",58,0)
 I $G(INSTR)]"" S @(F_".3)")=INSTR
"RTN","PSJHL10",59,0)
 S @(F_".2)")=PSGPDRG_U_PSGDO S $P(^(.2),U,3,6)=$G(ORDCON)_"^"_$E(PRIORITY,2)_"^"_$G(DOSE)_"^"_$G(UNIT)
"RTN","PSJHL10",60,0)
 S @(F_"2)")=ND2,^(4)=ND4
"RTN","PSJHL10",61,0)
 S (C,X)=0 F  S X=$O(^TMP("PSB",$J,700,X)) Q:'X  S D=$G(^(X,0)) I D S C=C+1,@(F_"1,"_C_",0)")=$P(D,U,1,2),@(F_"1,""B"","_+D_","_C_")")=""
"RTN","PSJHL10",62,0)
 S:C @(F_"1,0)")=U_"55.07P^"_C_U_C
"RTN","PSJHL10",63,0)
 I $D(PROCOM) D
"RTN","PSJHL10",64,0)
 .;naked refs on the four lines below refer to the full ref to ^PS(55,PSGP,5,DA created by indrection using variable F
"RTN","PSJHL10",65,0)
 .I '$D(@(F_"12,0)")) S ^(0)=U_55.0612_U_0_U_0
"RTN","PSJHL10",66,0)
 .S JJ=0 F  S JJ=$O(PROCOM(JJ)) Q:'JJ  S $P(@(F_"12,0)"),"^",3,4)=JJ_"^"_JJ,@(F_"12,"_JJ_",0)")=PROCOM(JJ)
"RTN","PSJHL10",67,0)
 S @(F_"6)")=$$ENPC^PSJHL11("U",180)
"RTN","PSJHL10",68,0)
 I $G(APPT)]"" S @(F_"8)")=LOC_"^"_APPT
"RTN","PSJHL10",69,0)
 D CIMOU^PSJIMO1(PSGP,DA)
"RTN","PSJHL10",70,0)
 D CRA^PSGOETO
"RTN","PSJHL10",71,0)
 L -^PS(55,DFN,5,DA)
"RTN","PSJHL10",72,0)
 S PSGORD=DA_"U"
"RTN","PSJHL10",73,0)
OUT ;
"RTN","PSJHL10",74,0)
 Q
"RTN","PSJHL10",75,0)
 ;
"RTN","PSJHL10",76,0)
CHK(X,Y,Z)      ;Check for required fields
"RTN","PSJHL10",77,0)
 ; Input: X="^^"_MED ROUTE_"^^^^"_SCH TYPE
"RTN","PSJHL10",78,0)
 ;        Y=ORDERABLE ITEM_"^"_DOSAGE ORDERED
"RTN","PSJHL10",79,0)
 ;        Z=SCHEDULE_"^"_START DATE/TIME_"^^"_STOP DATE/TIME
"RTN","PSJHL10",80,0)
 D CHK^PSJHL7(X,Y,Z)
"RTN","PSJHL10",81,0)
 Q
"RTN","PSJHL10",82,0)
 ;
"RTN","PSJHL10",83,0)
DDOK(PSJF,OI) ;Check to be sure all dispense drugs that are active in the
"RTN","PSJHL10",84,0)
 ;order are valid.
"RTN","PSJHL10",85,0)
 ; Input: PSJF - File root of the order including all but the IEN of 
"RTN","PSJHL10",86,0)
 ;               the drug. (EX "^PS(53.45,X,2,")
"RTN","PSJHL10",87,0)
 ;        OI   - IEN of the order's orderable item
"RTN","PSJHL10",88,0)
 ; Output: 1 - all active DD's in the order are valid
"RTN","PSJHL10",89,0)
 ;         0 - no DD's active DD's or at least one active is invalid
"RTN","PSJHL10",90,0)
 N DDCNT,ND,PSJ,PSJ1 S (PSJ1,DDCNT)=0
"RTN","PSJHL10",91,0)
 I '$D(PSGDT) D NOW^%DTC S PSGDT=+$E(%,1,12)
"RTN","PSJHL10",92,0)
 I '$O(@(PSJF_"0)")) Q 1
"RTN","PSJHL10",93,0)
 ; Naked reference below refers to ^PS(53.45, created using indirection in variable PSJF
"RTN","PSJHL10",94,0)
 F PSJ=0:0 S PSJ=$O(@(PSJF_PSJ_")")) Q:'PSJ  S ND=$G(@(PSJF_PSJ_",0)"))  D
"RTN","PSJHL10",95,0)
 .S DDCNT=DDCNT+1
"RTN","PSJHL10",96,0)
 .S PSJ1=$S('$D(^PSDRUG(+ND,0)):1,$P($G(^(2)),U,3)'["U":1,+$G(^(2))'=+OI:1,$G(^("I"))="":0,1:^("I")'>PSGDT)
"RTN","PSJHL10",97,0)
 Q $S('DDCNT:0,PSJ1=1:0,1:1)
"RTN","PSJHL10",98,0)
 ;
"RTN","PSJHL10",99,0)
IVSET ;
"RTN","PSJHL10",100,0)
 N P,DFN S DFN=PSJHLDFN,CHK=""
"RTN","PSJHL10",101,0)
 F X=1:1:23 S P(X)=""
"RTN","PSJHL10",102,0)
 S (P(2),P(3),P("NINITDT"))=+$P(DATA0,"^",5),P("LOG")=LOGIN,P(4)=$P(DATA0,"^",3),P(5)=$S(P(4)="S":$P(DATA0,"^",4),1:""),P(6)=PROVIDER,P(8)=$G(INFRT),P(9)=$G(SCHEDULE),P(17)="E",P(21)=PSJORDER,P(22)=LOC
"RTN","PSJHL10",103,0)
 S:P(4)="P" P(9)=$P(DATA0,"^",6)
"RTN","PSJHL10",104,0)
 I P(4)="S",P(5)=1 S P(9)=$P(DATA0,"^",6)
"RTN","PSJHL10",105,0)
 S P("MR")=ROUTE
"RTN","PSJHL10",106,0)
 I P("MR")="" S P("MR")=$S(P(4)="P":$O(^PS(51.2,"B","IV PIGGYBACK",0)),1:$O(^PS(51.2,"B","INTRAVENOUS",0)))
"RTN","PSJHL10",107,0)
 S (P("CLRK"),P("NINIT"))=CLERK,P("PD")=PSITEM,(P("IVRM"),P("SYRS"),P("CLIN"),P("FRES"),P("OPI"))="",P("RES")=ROC,P("PRY")=$E(PRIORITY,2),P("REM")=""
"RTN","PSJHL10",108,0)
 I $$SCHREQ^PSJLIVFD(.P),P(15)'>0 N P15 S P15=$$INTERVAL^PSIVUTL(.P)
"RTN","PSJHL10",109,0)
 D CHKIV I CHK D ERROR Q
"RTN","PSJHL10",110,0)
 D SETN
"RTN","PSJHL10",111,0)
 D NEW55^PSIVORFB
"RTN","PSJHL10",112,0)
 N DA,DIK,ND,PSIVACT
"RTN","PSJHL10",113,0)
 S ND(0)=+ON55 F X=2:1:23 I $D(P(X)) S $P(ND(0),U,X)=P(X)
"RTN","PSJHL10",114,0)
 S ND(.3)=$G(P("INS"))
"RTN","PSJHL10",115,0)
 S $P(ND(0),U,17)="E",ND(1)=P("REM"),ND(3)=P("OPI"),ND(.2)=$P($G(P("PD")),U)_U_$G(P("DO"))_U_+P("MR")_U_$G(P("PRY"))_U_$G(ORDCON) F X=0,1,3,.2,.3 S ^PS(55,DFN,"IV",+ON55,X)=ND(X)
"RTN","PSJHL10",116,0)
 S $P(^PS(55,DFN,"IV",+ON55,2),U,1,4)=P("LOG")_U_P("IVRM")_U_U_P("SYRS"),$P(^(2),U,8,10)=P("RES")_U_$G(P("FRES"))_U_$S($G(VAIN(4)):+VAIN(4),1:"")
"RTN","PSJHL10",117,0)
 S $P(^PS(55,DFN,"IV",+ON55,2),U,11)=+P("CLRK")
"RTN","PSJHL10",118,0)
 I +$G(P(22)) S $P(^PS(55,DFN,"IV",+ON55,"DSS"),"^")=P(22)_"^"_$G(APPT) D:$P(P("CLIN"),"^")'="" CIMOI^PSJIMO1(DFN,ON55)
"RTN","PSJHL10",119,0)
 S:+$G(P("NINIT")) ^PS(55,DFN,"IV",+ON55,4)=P("NINIT")_U_P("NINITDT")_"^^^^^^^^"_"1"
"RTN","PSJHL10",120,0)
 S ^PS(55,"APIV",DFN,+ON55)=""
"RTN","PSJHL10",121,0)
 I $D(PROCOM) D
"RTN","PSJHL10",122,0)
 .I '$D(^PS(55,DFN,"IV",+ON55,5,0)) S ^(0)=U_55.1115_U_0_U_0
"RTN","PSJHL10",123,0)
 .S JJ=0 F  S JJ=$O(PROCOM(JJ)) Q:'JJ  S $P(^PS(55,DFN,"IV",+ON55,5,0),"^",3,4)=JJ_"^"_JJ,^PS(55,DFN,"IV",+ON55,5,JJ,0)=PROCOM(JJ)
"RTN","PSJHL10",124,0)
 S ^PS(55,DFN,"IV",+ON55,3)=$$ENPC^PSJHL11("V",60)
"RTN","PSJHL10",125,0)
 F DRGT="AD","SOL" D PUTD55
"RTN","PSJHL10",126,0)
 K DA,DIK S DA(1)=DFN,DA=+ON55,DIK="^PS(55,"_DA(1)_",""IV"",",PSIVACT=1 D IX^DIK
"RTN","PSJHL10",127,0)
 L -^PS(55,DFN,"IV",DA)
"RTN","PSJHL10",128,0)
 S PSGORD=ON55
"RTN","PSJHL10",129,0)
 Q
"RTN","PSJHL10",130,0)
 ;
"RTN","PSJHL10",131,0)
PUTD55 ; Move drug data from local array into 55
"RTN","PSJHL10",132,0)
 K ^PS(55,DFN,"IV",+ON55,DRGT) S ^PS(55,DFN,"IV",+ON55,DRGT,0)=$S(DRGT="AD":"^55.02PA",1:"^55.11IPA")
"RTN","PSJHL10",133,0)
 F X=0:0 S X=$O(^TMP("PSB",$J,$S(DRGT="AD":800,1:900),X)) Q:'X  D
"RTN","PSJHL10",134,0)
 .S Y=^PS(55,DFN,"IV",+ON55,DRGT,0),$P(Y,U,3)=$P(Y,U,3)+1,DRG=$P(Y,U,3),$P(Y,U,4)=$P(Y,U,4)+1
"RTN","PSJHL10",135,0)
 .S ^PS(55,DFN,"IV",+ON55,DRGT,0)=Y,^PS(55,DFN,"IV",+ON55,DRGT,+DRG,0)=$P(^TMP("PSB",$J,$S(DRGT="AD":800,1:900),X,0),"^")_"^"_$P(^TMP("PSJNVO",$J,DRGT,+DRG,0),"^",2)
"RTN","PSJHL10",136,0)
 Q
"RTN","PSJHL10",137,0)
 ;
"RTN","PSJHL10",138,0)
SETN ;Set up patient 0 node if needed.
"RTN","PSJHL10",139,0)
 I '$D(^PS(55,DFN,0)) K DO,DA,DD,DIC,PSIVFN S:$D(^(5.1)) PSIVFN=^(5.1) K:$D(PSIVFN) ^(5.1) S (DINUM,X)=DFN,DIC(0)="L",DIC="^PS(55," D FILE^DICN S:$D(PSIVFN) ^PS(55,DFN,5.1)=PSIVFN D  K DIC,PSIVFN,DO,DA,DD
"RTN","PSJHL10",140,0)
 .; Mark PSJ and PSO as converted
"RTN","PSJHL10",141,0)
 .S $P(^PS(55,DFN,5.1),"^",11)=2
"RTN","PSJHL10",142,0)
 Q
"RTN","PSJHL10",143,0)
 ;
"RTN","PSJHL10",144,0)
CHKIV ;Validate IV data
"RTN","PSJHL10",145,0)
 N OK S OK=0
"RTN","PSJHL10",146,0)
 I "APS"'[P(4) S CHK=1,PSREASON="Invalid IV Type" Q
"RTN","PSJHL10",147,0)
 I P(9)="",P(4)="P" S CHK=1,PSREASON="Piggyback IV Type requires a schedule" Q
"RTN","PSJHL10",148,0)
 I P(4)="S",P(5)=1,P(9)="" S CHK=1,PSREASON="Intermittent Syringe IV Type requires a schedule" Q
"RTN","PSJHL10",149,0)
 I P(9)'="STAT",(P(9)'="NOW"),P(9)'="" S CHK=1,PSREASON="Invalid Schedule" Q
"RTN","PSJHL10",150,0)
 I $D(^XUSEC("ORELSE",DUZ)),ORDCON'="V",ORDCON'="P" S CHK=1,PSREASON="Invalid Nature of Order" Q
"RTN","PSJHL10",151,0)
 I +$G(^TMP("PSB",$J,800,0))=0,+$G(^TMP("PSB",$J,900,0))=0 S CHK=1,PSREASON="IV orders must have at least one additive or solution" Q
"RTN","PSJHL10",152,0)
 I +$G(^TMP("PSB",$J,900,0))=0,P(4)'="P" S CHK=1,PSREASON="You must have at least one solution for this order." Q
"RTN","PSJHL10",153,0)
 I +$G(^TMP("PSB",$J,800,0))'=+$G(^TMP("PSJNVO",$J,"AD",0)) S CHK=1,PSREASON="Number of additives in BCMA & CPRS do not match." Q
"RTN","PSJHL10",154,0)
 I +$G(^TMP("PSB",$J,900,0))'=+$G(^TMP("PSJNVO",$J,"SOL",0)) S CHK=1,PSREASON="Number of solutions in BCMA & CPRS do not match." Q
"RTN","PSJHL10",155,0)
 F DRGT="AD","SOL" S FIL=$S(DRGT="AD":52.6,1:52.7) F DRGI=0:0 S DRGI=$O(^TMP("PSB",$J,$S(DRGT="AD":800,1:900),DRGI)) Q:'DRGI  S DRG=$G(^TMP("PSB",$J,$S(DRGT="AD":800,1:900),DRGI,0)) D DRG,@DRGT Q:CHK=1
"RTN","PSJHL10",156,0)
 I 'OK,'CHK S CHK=1,PSREASON="The Orderable Item does not match any of the additives or solutions in this order" Q
"RTN","PSJHL10",157,0)
 Q
"RTN","PSJHL10",158,0)
 ;
"RTN","PSJHL10",159,0)
AD ;Check additives
"RTN","PSJHL10",160,0)
 I '$D(^PS(FIL,+DRG,0)) S CHK=1,PSREASON="Additive "_+DRG_" does not exist in the additive file" Q
"RTN","PSJHL10",161,0)
 ;Naked reference below refers to ^PS(52.6,+DRG,0)
"RTN","PSJHL10",162,0)
 I $P(^(0),"^",11)=PSITEM S OK=1
"RTN","PSJHL10",163,0)
 I $$ENU^PSIVUTL(+DRG)'=$P($P(^TMP("PSJNVO",$J,DRGT,+DRGI,0),"^",2)," ",2,99)!(+$P(^TMP("PSJNVO",$J,DRGT,+DRGI,0),"^",2)'>0) S CHK=1,PSREASON="Invalid strength entered for additive "_+DRG Q
"RTN","PSJHL10",164,0)
 Q
"RTN","PSJHL10",165,0)
SOL ;Check solutions
"RTN","PSJHL10",166,0)
 I '$D(^PS(FIL,+DRG,0)) S CHK=1,PSREASON="Solution "_+DRG_" does not exist in the solution file" Q
"RTN","PSJHL10",167,0)
 ;Naked reference below refers to ^PS(52.7,+DRG,0)
"RTN","PSJHL10",168,0)
 I $P(^(0),"^",11)=PSITEM S OK=1
"RTN","PSJHL10",169,0)
 I +$P(^TMP("PSJNVO",$J,DRGT,+DRGI,0),"^",2)>9999!(+$P(^TMP("PSJNVO",$J,DRGT,+DRGI,0),"^",2)'>0) S CHK=1,PSREASON="Volume on "_+DRG_" is an invalid strength" Q
"RTN","PSJHL10",170,0)
 Q
"RTN","PSJHL10",171,0)
DRG ;Check to be sure additive/solutions are active
"RTN","PSJHL10",172,0)
 I $S('$G(^PS(FIL,+DRG,"I")):0,^("I")>DT:0,1:1) S CHK=1,PSREASON="An additive or solution is inactive" Q
"RTN","PSJHL10",173,0)
 Q
"RTN","PSJIMO1")
0^2^B68607232
"RTN","PSJIMO1",1,0)
PSJIMO1 ;BIR/LE-IMO UTILITIES AND XREFS ;16 Mar 99 / 10:22 AM
"RTN","PSJIMO1",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**257,299,311,307**;16 DEC 97;Build 18
"RTN","PSJIMO1",3,0)
 ;External reference to ^PS(55 supported by DBIA 2191
"RTN","PSJIMO1",4,0)
 ;External reference to ^PSSDSAPI supported by DBIA 5425
"RTN","PSJIMO1",5,0)
 ;External Reference to ^DPTLK is supported by DBIA 3787
"RTN","PSJIMO1",6,0)
 ;
"RTN","PSJIMO1",7,0)
IMO(CLINICS) ;called from ENCD^PSGFILED WHICH IS CLINIC DEFINITION OPTION IN INPATIENT MEDS
"RTN","PSJIMO1",8,0)
 W !!,"Verifying IMO clinic cross references...",!
"RTN","PSJIMO1",9,0)
 N CLINFLG,IMOCLIEN,PSJIMOCL,PSJCLIN,FLAG S FLAG=""
"RTN","PSJIMO1",10,0)
 S (CLINFLG,CLINIC,PSJIMOCL,IMOCLIEN)=""
"RTN","PSJIMO1",11,0)
 F  S IMOCLIEN=$O(CLINICS(IMOCLIEN)) Q:IMOCLIEN=""  S PSJIMOCL=$$GET1^DIQ(53.46,IMOCLIEN,.01,"I"),CLINFLG=$$GET1^DIQ(44,PSJIMOCL,2802,"I") D
"RTN","PSJIMO1",12,0)
 .I 'CLINFLG D IMOKILL(PSJIMOCL,CLINFLG) Q  ;CLINFLG=ADIMINISTER INPATIENT MEDS? true means IMO clinic; false means not IMO
"RTN","PSJIMO1",13,0)
 .I CLINFLG D IMOSET(PSJIMOCL,CLINFLG)
"RTN","PSJIMO1",14,0)
 I FLAG W !,"IMO cross references have been updated.",!
"RTN","PSJIMO1",15,0)
 Q
"RTN","PSJIMO1",16,0)
 ;
"RTN","PSJIMO1",17,0)
IMOSET(PSJCLIN,PSJIMOF) ;
"RTN","PSJIMO1",18,0)
 ;Clinic order means Yes is answered to ADMINISTER INPATIENT MEDS field in file 44, a clinic and appointment date/time is defined.
"RTN","PSJIMO1",19,0)
 ;Q:$D(^PS("CIMOCLU",CLINIC))!($D(^PS("CIMOCLI",CLINIC)))
"RTN","PSJIMO1",20,0)
 N CLNDAYS,PSJAPTDT,PSJTODAY,X1,X2,PATIENT,PSJSTDT,PS55IEN,PS531IEN,PSJXREF,PSJTYPE,APPTDT,PSJUTMP,PSJSTART
"RTN","PSJIMO1",21,0)
 S CLNDAYS=$$GET1^DIQ(53.46,CLINIC,6)
"RTN","PSJIMO1",22,0)
 S:CLNDAYS="" CLNDAYS=30  ;default to 30 days if not defined
"RTN","PSJIMO1",23,0)
 D NOW^%DTC S (X1,PSJTODAY)=%,X2=-CLNDAYS D C^%DTC S PSJSTART=X
"RTN","PSJIMO1",24,0)
 ;FILE 55
"RTN","PSJIMO1",25,0)
 F PSJXREF="AUDC","AIVC" S PSJSTDT=PSJSTART F  S PSJSTDT=$O(^PS(55,PSJXREF,PSJSTDT)) Q:PSJSTDT=""  D
"RTN","PSJIMO1",26,0)
 .S PATIENT="" F  S PATIENT=$O(^PS(55,PSJXREF,PSJSTDT,PSJCLIN,PATIENT)) Q:PATIENT=""  S PS55IEN="" F  S PS55IEN=$O(^PS(55,PSJXREF,PSJSTDT,PSJCLIN,PATIENT,PS55IEN)) Q:PS55IEN=""  D
"RTN","PSJIMO1",27,0)
 ..I PSJXREF="AUDC" S PSJAPTDT=$$GET1^DIQ(55.06,PS55IEN_","_PATIENT_",",131) I PSJAPTDT'="" S ^PS(55,"CIMOU",PATIENT,PSJCLIN,PSJSTDT,PATIENT,PS55IEN)=""
"RTN","PSJIMO1",28,0)
 ..I PSJXREF="AIVC" S PSJAPTDT=$$GET1^DIQ(55.01,PS55IEN_","_PATIENT_",",139) I PSJAPTDT'="" S ^PS(55,PATIENT,"IV","CIMOI",PSJCLIN,PSJSTDT,PS55IEN)=""
"RTN","PSJIMO1",29,0)
 ..I PSJAPTDT'="" S FLAG=1
"RTN","PSJIMO1",30,0)
 ;
"RTN","PSJIMO1",31,0)
 ;FILE 53.1
"RTN","PSJIMO1",32,0)
 S (PATIENT,PS531IEN)=""
"RTN","PSJIMO1",33,0)
 F  S PATIENT=$O(^PS(53.1,"AD",PSJCLIN,PATIENT)) Q:PATIENT=""  F  S PS531IEN=$O(^PS(53.1,"AD",PSJCLIN,PATIENT,PS531IEN)) Q:PS531IEN=""  D
"RTN","PSJIMO1",34,0)
 .K PSJUTMP D GETS^DIQ(53.1,PS531IEN,"28;126","I","PSJUTMP")
"RTN","PSJIMO1",35,0)
 .S (APPTDT,PSJTYPE)=""
"RTN","PSJIMO1",36,0)
 .S:$D(PSJUTMP(53.1,PS531IEN_",",126,"I")) APPTDT=PSJUTMP(53.1,PS531IEN_",",126,"I")
"RTN","PSJIMO1",37,0)
 .S:$D(PSJUTMP(53.1,PS531IEN_",",28,"I")) PSJTYPE=PSJUTMP(53.1,PS531IEN_",",28,"I")
"RTN","PSJIMO1",38,0)
 .Q:PSJTYPE'="P"&(PSJTYPE'="N")
"RTN","PSJIMO1",39,0)
 .Q:APPTDT=""!'CLINFLG
"RTN","PSJIMO1",40,0)
 .S ^PS(53.1,"CIMO",PATIENT,PSJCLIN,PS531IEN)="",FLAG=1
"RTN","PSJIMO1",41,0)
 Q
"RTN","PSJIMO1",42,0)
 ;
"RTN","PSJIMO1",43,0)
IMOKILL(CLINIC,PSCLINIC) ;
"RTN","PSJIMO1",44,0)
 S:'$G(PSCLINIC) PSCLINIC=""
"RTN","PSJIMO1",45,0)
 I $D(^PS(55,"CIMOCLU",CLINIC)) S PATIENT="" F  S PATIENT=$O(^PS(55,"CIMOCLU",CLINIC,PATIENT)) Q:PATIENT=""  D
"RTN","PSJIMO1",46,0)
 .K ^PS(55,"CIMOU",PATIENT,CLINIC)
"RTN","PSJIMO1",47,0)
 I $D(^PS(55,"CIMOCLI",CLINIC)) S PATIENT="" F  S PATIENT=$O(^PS(55,"CIMOCLU",CLINIC,PATIENT)) Q:PATIENT=""  D
"RTN","PSJIMO1",48,0)
 .K ^PS(55,PATIENT,"IV","CIMOI",CLINIC)
"RTN","PSJIMO1",49,0)
 K ^PS(55,"CIMOCLU",CLINIC),^PS(55,"CIMOCLI",CLINIC)
"RTN","PSJIMO1",50,0)
 I $D(^PS(53.1,"AD",CLINIC)) S PATIENT="" F  S PATIENT=$O(^PS(53.1,"AD",CLINIC,PATIENT)) Q:PATIENT=""  D
"RTN","PSJIMO1",51,0)
 .I $D(^PS(53.1,"CIMO",PATIENT,CLINIC)) K ^PS(53.1,"CIMO",PATIENT,CLINIC)
"RTN","PSJIMO1",52,0)
 Q
"RTN","PSJIMO1",53,0)
 ;
"RTN","PSJIMO1",54,0)
CIMOU(PSGP,PSJDA55,PSCLINIC,PSJDA531) ;IMO UNIT DOSE FILE 55 CROSS REFERENCE SET
"RTN","PSJIMO1",55,0)
 N PSJCLINI,CLINFLG,PSJIVIEN,PSJSTAT
"RTN","PSJIMO1",56,0)
 I $G(PSJDA531)="" S PSJDA531=""
"RTN","PSJIMO1",57,0)
 S PSJSTAT=""
"RTN","PSJIMO1",58,0)
 I '$G(PSCLINIC) S PSCLINIC="",PSCLINIC=$$GET1^DIQ(55.06,+PSJDA55_","_PSGP_",",130,"I")
"RTN","PSJIMO1",59,0)
 Q:PSCLINIC=""
"RTN","PSJIMO1",60,0)
 S CLINFLG="",CLINFLG=$$GET1^DIQ(44,PSCLINIC,2802,"I")  ;Only set xref if IMO clinic
"RTN","PSJIMO1",61,0)
 Q:'CLINFLG
"RTN","PSJIMO1",62,0)
 D GETS^DIQ(55.06,+PSJDA55_","_PSGP_",","34;131","I","PSJCLINI")
"RTN","PSJIMO1",63,0)
 I CLINFLG&($G(PSJCLINI(55.06,+PSJDA55_","_PSGP_",","131","I"))) D
"RTN","PSJIMO1",64,0)
 .S ^PS(55,"CIMOU",PSGP,PSCLINIC,PSJCLINI(55.06,+PSJDA55_","_PSGP_",","34","I"),PSGP,+PSJDA55)=""
"RTN","PSJIMO1",65,0)
 .S ^PS(55,"CIMOCLU",PSCLINIC,PSGP,+PSJDA55)=""
"RTN","PSJIMO1",66,0)
 S PSJIVIEN=$$GET1^DIQ(55.06,+PSJDA55_","_DFN_",",104)  ;pick up ien from file 55 since PSJORD/PSGORD can't be trusted.
"RTN","PSJIMO1",67,0)
 S:PSJIVIEN="" PSJIVIEN=PSJDA531
"RTN","PSJIMO1",68,0)
 I $G(PSJIVIEN)]"",'$D(^PS(53.1,"CIMO",PSGP,PSCLINIC,PSJIVIEN)) S PSJIVIEN=PSJDA531  ;for edits, if no CIMO entry, use the passed in IEN.  Non-edits will always have an entry.
"RTN","PSJIMO1",69,0)
 I +$G(PSJIVIEN) D KILL531(PSGP,PSCLINIC,+PSJIVIEN)
"RTN","PSJIMO1",70,0)
 Q
"RTN","PSJIMO1",71,0)
 ;
"RTN","PSJIMO1",72,0)
CIMOI(DFN,PSJDA55,PSCLINIC,PSJDA531) ;IMO IV FILE 55 CROSS REFERENCE SET
"RTN","PSJIMO1",73,0)
 N PSJCLINI,CLINFLG,PSJIVIEN,PSJSTAT
"RTN","PSJIMO1",74,0)
 S PSJSTAT=""
"RTN","PSJIMO1",75,0)
 I '$G(PSCLINIC) S PSCLINIC=$$GET1^DIQ(55.01,+PSJDA55_","_DFN_",",136,"I")
"RTN","PSJIMO1",76,0)
 Q:PSCLINIC=""
"RTN","PSJIMO1",77,0)
 S CLINFLG="",CLINFLG=$$GET1^DIQ(44,PSCLINIC,2802,"I")  ;Only set xref if IMO clinic
"RTN","PSJIMO1",78,0)
 Q:'CLINFLG
"RTN","PSJIMO1",79,0)
 D GETS^DIQ(55.01,+PSJDA55_","_DFN_",",".03","I","PSJCLINI")
"RTN","PSJIMO1",80,0)
 I $D(PSJCLINI(55.01,+PSJDA55_","_DFN_",",".03","I")) D
"RTN","PSJIMO1",81,0)
 .S ^PS(55,DFN,"IV","CIMOI",PSCLINIC,PSJCLINI(55.01,+PSJDA55_","_DFN_",",".03","I"),+PSJDA55)=""
"RTN","PSJIMO1",82,0)
 .S ^PS(55,"CIMOCLI",PSCLINIC,DFN,+PSJDA55)=""
"RTN","PSJIMO1",83,0)
 S PSJIVIEN=$$GET1^DIQ(55.01,+ON55_","_DFN_",",113)  ;if there, pick up ien from file 55 since PSJORD/PSGORD can't be trusted.
"RTN","PSJIMO1",84,0)
 I PSJIVIEN=""&(+$G(PSJDA531)) S PSJIVIEN=PSJDA531
"RTN","PSJIMO1",85,0)
 ;I '$D(^PS(53.1,"CIMO",PSGP,PSCLINIC,PSJIVIEN)) S PSJIVIEN=PSJDA531  ;for edits, if no CIMO entry, use the passed in IEN.  Non-edits will always have an entry.
"RTN","PSJIMO1",86,0)
 I +$G(PSJIVIEN) D KILL531(DFN,PSCLINIC,+PSJIVIEN)
"RTN","PSJIMO1",87,0)
 Q
"RTN","PSJIMO1",88,0)
 ;
"RTN","PSJIMO1",89,0)
KILL531(PSJCLPAT,PSCLINIC,PSJIVIEN) ;
"RTN","PSJIMO1",90,0)
 I '$G(PSCLINIC) S PSCLINIC=$$GET1^DIQ(53.1,+PSJIVIEN_","_PSJCLPAT_",",113,"I")
"RTN","PSJIMO1",91,0)
 Q:PSCLINIC=""
"RTN","PSJIMO1",92,0)
 I $D(^PS(53.1,"CIMO",PSJCLPAT,PSCLINIC,+PSJIVIEN)) K ^PS(53.1,"CIMO",PSJCLPAT,PSCLINIC,+PSJIVIEN)
"RTN","PSJIMO1",93,0)
 Q
"RTN","PSJIMO1",94,0)
 ;
"RTN","PSJIMO1",95,0)
GETCLN(PSGP,ORDER) ; Return Clinic IEN for a given patient/order combination
"RTN","PSJIMO1",96,0)
 I '$G(ORDER) Q ""
"RTN","PSJIMO1",97,0)
 N CLN S CLN=$S(ORDER["P":$G(^PS(53.1,+ORDER,"DSS")),ORDER["V":$G(^PS(55,PSGP,"IV",+ORDER,"DSS")),ORDER["U":$G(^PS(55,PSGP,5,+ORDER,8)),1:"")
"RTN","PSJIMO1",98,0)
 I 'CLN,(ORDER=+ORDER) D
"RTN","PSJIMO1",99,0)
 .I $D(^PS(53.1,"ACX",+ORDER)) N PSJORD S PSJORD=0 F  S PSJORD=$O(^PS(53.1,"ACX",+ORDER,PSJORD)) Q:'PSJORD!$G(CLN)  S CLN=$G(^PS(53.1,+PSJORD,"DSS"))
"RTN","PSJIMO1",100,0)
 .I $D(^PS(55,"ACX",+ORDER)) N ACX2,PSJORD S ACX2="" F  S ACX2=$O(^PS(55,"ACX",+ORDER,ACX2)) Q:'ACX2!$G(CLN)  S PSJORD=0 F  S PSJORD=$O(^PS(55,"ACX",+ORDER,ACX2,PSJORD)) Q:'PSJORD!$G(CLN)  D
"RTN","PSJIMO1",101,0)
 ..S CLN=$S(PSJORD["P":$G(^PS(53.1,+PSJORD,"DSS")),PSJORD["V":$G(^PS(55,PSGP,"IV",+PSJORD,"DSS")),ORDER["U":$G(^PS(55,PSGP,5,+PSJORD,8)),1:"")
"RTN","PSJIMO1",102,0)
 Q +CLN
"RTN","PSJIMO1",103,0)
 ;
"RTN","PSJIMO1",104,0)
CHECK() ;SET CONDITION FOR CIMOU XREF IN FILE 55
"RTN","PSJIMO1",105,0)
 ;UNIT DOSE - X2(1)=PATIENT, X2(2)=CLINIC, X2(3)=STOP DATE
"RTN","PSJIMO1",106,0)
 N PSJAPPTD,X S X=0
"RTN","PSJIMO1",107,0)
 Q:'$$IMOCHK(X2(2)) 0  ;don't set clinic x-refs where clinic isn't marked as IMO.
"RTN","PSJIMO1",108,0)
 S PSJAPPTD=$$GET1^DIQ(55.06,DA_","_X2(1)_",",131,"I")
"RTN","PSJIMO1",109,0)
 S:PSJAPPTD'="" X=1
"RTN","PSJIMO1",110,0)
 Q X
"RTN","PSJIMO1",111,0)
 ;
"RTN","PSJIMO1",112,0)
CHECK2() ;SET CONDITION FOR CIMOI XREF IN FILE 55
"RTN","PSJIMO1",113,0)
 ;IV - DA(1)=PATIENT, X2(1)=CLINIC, X2(2)=STOP DATE, DA=SUBFILE IEN
"RTN","PSJIMO1",114,0)
 N PSJAPPTD,X S X=0
"RTN","PSJIMO1",115,0)
 Q:'$$IMOCHK(X2(1)) 0  ;don't set clinic x-refs where clinic isn't marked as IMO.
"RTN","PSJIMO1",116,0)
 S PSJAPPTD=$$GET1^DIQ(55.01,DA_","_DA(1)_",",139,"I")
"RTN","PSJIMO1",117,0)
 S:PSJAPPTD'="" X=1
"RTN","PSJIMO1",118,0)
 Q X
"RTN","PSJIMO1",119,0)
 ;
"RTN","PSJIMO1",120,0)
IMOCHK(PSJIMOCL) ;determine if clinic is an IMO clinic; returns 1 if IMO or 0 not IMO
"RTN","PSJIMO1",121,0)
 Q:'$G(PSJIMOCL) 0
"RTN","PSJIMO1",122,0)
 N PSJCFLAG
"RTN","PSJIMO1",123,0)
 S PSJCFLAG=$$GET1^DIQ(44,PSJIMOCL,2802,"I")
"RTN","PSJIMO1",124,0)
 Q PSJCFLAG
"RTN","PSJIMO1",125,0)
 ;
"RTN","PSJIMO1",126,0)
CHECK3() ;SET CONDITION FOR CIMO XREF IN FILE 53.1
"RTN","PSJIMO1",127,0)
 ;  DA=IEN, X(1)=PATIENT, X(2)=CLINIC
"RTN","PSJIMO1",128,0)
 N PSJCFLAG,PSJAPPTD,X,PSJTYPE,PSJUTMP S X=0
"RTN","PSJIMO1",129,0)
 Q:'$$IMOCHK(X2(2)) 0  ;don't set clinic x-refs where clinic isn't marked as IMO.
"RTN","PSJIMO1",130,0)
 D GETS^DIQ(53.1,DA,"28;126","I","PSJUTMP")
"RTN","PSJIMO1",131,0)
 S X=0,(PSJAPPTD,PSJTYPE)=""
"RTN","PSJIMO1",132,0)
 S:$D(PSJUTMP(53.1,DA_",",126,"I")) PSJAPPTD=PSJUTMP(53.1,DA_",",126,"I")
"RTN","PSJIMO1",133,0)
 S:$D(PSJUTMP(53.1,DA_",",28,"I")) PSJTYPE=PSJUTMP(53.1,DA_",",28,"I")
"RTN","PSJIMO1",134,0)
 Q:PSJTYPE'="P"&(PSJTYPE'="N") 0  ;only pending and non-verified orders are allowed in the xref
"RTN","PSJIMO1",135,0)
 S:PSJAPPTD'="" X=1
"RTN","PSJIMO1",136,0)
 Q X
"RTN","PSJIMO1",137,0)
 ;
"RTN","PSJIMO1",138,0)
TEST ;KILL ALL IMO CROSS REFERENCES FOR A PARTICULAR CLINIC AND PATIENT
"RTN","PSJIMO1",139,0)
 N PSJTESCL,PSJTESPA
"RTN","PSJIMO1",140,0)
TEST2 ;
"RTN","PSJIMO1",141,0)
 K DIC S DIC="^PS(53.46,",DIC(0)="AELMQ",DIC("A")="Select CLINIC: ",DLAYGO=53.46 D ^DIC K DIC G DONE:Y=""!(Y<1)
"RTN","PSJIMO1",142,0)
 S PSJTESCL=$P(Y,"^",2)
"RTN","PSJIMO1",143,0)
 K DIC,PSGP,Y W !!,"Select "_$S($D(PSGDICA):PSGDICA_" ",1:"")_"PATIENT: " R X:DTIME S:'$T X="^" W:'$T $C(7) I "^"[X S (Y,PSGP)=-1 S QFLG=1 G DONE
"RTN","PSJIMO1",144,0)
 K DIC S DIC="^DPT(",DIC("W")="D DPT^PSJDPT",DIC(0)="QEMZ" D ^DPTLK K DIC
"RTN","PSJIMO1",145,0)
 S PSJTESPA=$P(Y,"^")
"RTN","PSJIMO1",146,0)
 ;
"RTN","PSJIMO1",147,0)
 K ^PS(55,PSJTESPA,"IV","CIMOI",PSJTESCL)
"RTN","PSJIMO1",148,0)
 K ^PS(55,"CIMOCLI",PSJTESCL)
"RTN","PSJIMO1",149,0)
 K ^PS(55,"CIMOU",PSJTESPA,PSJTESCL)
"RTN","PSJIMO1",150,0)
 K ^PS(55,"CIMOCLU",PSJTESCL)
"RTN","PSJIMO1",151,0)
 K ^PS(53.1,"CIMO",PSJTESPA,PSJTESCL)
"RTN","PSJIMO1",152,0)
 W !,"DELETED",!
"RTN","PSJIMO1",153,0)
DONE ;
"RTN","PSJIMO1",154,0)
 Q
"RTN","PSJIMO1",155,0)
 ;
"RTN","PSJIMO1",156,0)
CLEAN(DFN) ;Delete old entriers from clinic order xref; CALLED WHEN USER EXITS PATIENT IN IOE
"RTN","PSJIMO1",157,0)
 ;----get top of the range of dates stored for each clinic
"RTN","PSJIMO1",158,0)
 N PSCLINIC,PSTYPE,ENDDATE,RXDATE,CLNDAYS,CLNARRY,PSJIEN
"RTN","PSJIMO1",159,0)
 S (PSTYPE,PSCLINIC,CLNDAYS,CLNARRY)=""
"RTN","PSJIMO1",160,0)
 F PSTYPE="CIMOCLU","CIMOCLI" F  S PSCLINIC=$O(^PS(55,PSTYPE,PSCLINIC)) Q:PSCLINIC=""  D
"RTN","PSJIMO1",161,0)
 .S CLNDAYS=$$GET1^DIQ(53.46,PSCLINIC,6) S:CLNDAYS="" CLNDAYS=30  ;default to 30 days if not defined
"RTN","PSJIMO1",162,0)
 .D NOW^%DTC S X1=%,X2=-CLNDAYS D C^%DTC S CLNARRY($S(PSTYPE="CIMOCLU":"U",1:"V"),PSCLINIC)=X
"RTN","PSJIMO1",163,0)
 ;----kill x-refs for all unit dose entries older than the clinic begin date
"RTN","PSJIMO1",164,0)
 I $D(CLNARRY("U")) S PSCLINIC="" F  S PSCLINIC=$O(CLNARRY("U",PSCLINIC)) Q:PSCLINIC=""  D
"RTN","PSJIMO1",165,0)
 .S (RXDATE,ENDDATE)="",ENDDATE=CLNARRY("U",PSCLINIC)
"RTN","PSJIMO1",166,0)
 .F  S RXDATE=$O(^PS(55,"CIMOU",DFN,PSCLINIC,RXDATE)) Q:RXDATE=""  I RXDATE<ENDDATE K ^PS(55,"CIMOU",DFN,PSCLINIC,RXDATE) D
"RTN","PSJIMO1",167,0)
 ..S PSJIEN="" F  S PSJIEN=$O(^PS(55,"CIMOU",DFN,PSCLINIC,RXDATE,DFN,PSJIEN)) Q:PSJIEN=""  K ^PS(55,"CIMOU",DFN,PSCLINIC,RXDATE,DFN,PSJIEN)
"RTN","PSJIMO1",168,0)
 ;----kill x-refs for all IV entries older than the clinic begin date
"RTN","PSJIMO1",169,0)
 I $D(CLNARRY("V")) S PSCLINIC="" F  S PSCLINIC=$O(CLNARRY("V",PSCLINIC)) Q:PSCLINIC=""  D
"RTN","PSJIMO1",170,0)
 .S (RXDATE,ENDDATE)="",ENDDATE=CLNARRY("V",PSCLINIC)
"RTN","PSJIMO1",171,0)
 .F  S RXDATE=$O(^PS(55,DFN,"IV","CIMOI",PSCLINIC,RXDATE)) Q:RXDATE=""  I RXDATE<ENDDATE K ^PS(55,DFN,"IV","CIMOI",PSCLINIC,RXDATE) D
"RTN","PSJIMO1",172,0)
 ..S PSJIEN="" F  S PSJIEN=$O(^PS(55,DFN,"IV","CIMOI",PSCLINIC,RXDATE,PSJIEN)) Q:PSJIEN=""  K ^PS(55,DFN,"IV","CIMOI",PSCLINIC,RXDATE,PSJIEN)
"RTN","PSJIMO1",173,0)
 Q
"RTN","PSJIMO1",174,0)
 ;
"VER")
8.0^22.0
**END**
**END**
