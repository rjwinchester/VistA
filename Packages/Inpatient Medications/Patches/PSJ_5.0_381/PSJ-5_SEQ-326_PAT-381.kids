Released PSJ*5*381 SEQ #326
Extracted from mail message
**KIDS**:PSJ*5.0*381^

**INSTALL NAME**
PSJ*5.0*381
"BLD",11327,0)
PSJ*5.0*381^INPATIENT MEDICATIONS^0^3181219^y
"BLD",11327,1,0)
^^4^4^3181219^
"BLD",11327,1,1,0)
This patch addresses the following.
"BLD",11327,1,2,0)
 
"BLD",11327,1,3,0)
Results from LA7POC1 and LA7POC2 for iSTAT and 
"BLD",11327,1,4,0)
  Glucose testing are not going over to VISTA
"BLD",11327,4,0)
^9.64PA^^
"BLD",11327,6.3)
2
"BLD",11327,"ABPKG")
n
"BLD",11327,"KRN",0)
^9.67PA^1.61^23
"BLD",11327,"KRN",.4,0)
.4
"BLD",11327,"KRN",.401,0)
.401
"BLD",11327,"KRN",.402,0)
.402
"BLD",11327,"KRN",.403,0)
.403
"BLD",11327,"KRN",.5,0)
.5
"BLD",11327,"KRN",.84,0)
.84
"BLD",11327,"KRN",1.6,0)
1.6
"BLD",11327,"KRN",1.61,0)
1.61
"BLD",11327,"KRN",1.62,0)
1.62
"BLD",11327,"KRN",3.6,0)
3.6
"BLD",11327,"KRN",3.8,0)
3.8
"BLD",11327,"KRN",9.2,0)
9.2
"BLD",11327,"KRN",9.8,0)
9.8
"BLD",11327,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",11327,"KRN",9.8,"NM",1,0)
PSJPAD7I^^0^B93404669
"BLD",11327,"KRN",9.8,"NM","B","PSJPAD7I",1)

"BLD",11327,"KRN",19,0)
19
"BLD",11327,"KRN",19.1,0)
19.1
"BLD",11327,"KRN",101,0)
101
"BLD",11327,"KRN",409.61,0)
409.61
"BLD",11327,"KRN",771,0)
771
"BLD",11327,"KRN",779.2,0)
779.2
"BLD",11327,"KRN",870,0)
870
"BLD",11327,"KRN",8989.51,0)
8989.51
"BLD",11327,"KRN",8989.52,0)
8989.52
"BLD",11327,"KRN",8994,0)
8994
"BLD",11327,"KRN","B",.4,.4)

"BLD",11327,"KRN","B",.401,.401)

"BLD",11327,"KRN","B",.402,.402)

"BLD",11327,"KRN","B",.403,.403)

"BLD",11327,"KRN","B",.5,.5)

"BLD",11327,"KRN","B",.84,.84)

"BLD",11327,"KRN","B",1.6,1.6)

"BLD",11327,"KRN","B",1.61,1.61)

"BLD",11327,"KRN","B",1.62,1.62)

"BLD",11327,"KRN","B",3.6,3.6)

"BLD",11327,"KRN","B",3.8,3.8)

"BLD",11327,"KRN","B",9.2,9.2)

"BLD",11327,"KRN","B",9.8,9.8)

"BLD",11327,"KRN","B",19,19)

"BLD",11327,"KRN","B",19.1,19.1)

"BLD",11327,"KRN","B",101,101)

"BLD",11327,"KRN","B",409.61,409.61)

"BLD",11327,"KRN","B",771,771)

"BLD",11327,"KRN","B",779.2,779.2)

"BLD",11327,"KRN","B",870,870)

"BLD",11327,"KRN","B",8989.51,8989.51)

"BLD",11327,"KRN","B",8989.52,8989.52)

"BLD",11327,"KRN","B",8994,8994)

"BLD",11327,"QDEF")
^^^^NO^^^^^^NO
"BLD",11327,"QUES",0)
^9.62^^
"BLD",11327,"REQB",0)
^9.611^1^1
"BLD",11327,"REQB",1,0)
PSJ*5.0*362^2
"BLD",11327,"REQB","B","PSJ*5.0*362",1)

"MBREQ")
0
"PKG",471,-1)
1^1
"PKG",471,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",471,22,0)
^9.49I^1^1
"PKG",471,22,1,0)
5.0^2971215^2990325^66481
"PKG",471,22,1,"PAH",1,0)
381^3181219
"PKG",471,22,1,"PAH",1,1,0)
^^4^4^3181219
"PKG",471,22,1,"PAH",1,1,1,0)
This patch addresses the following.
"PKG",471,22,1,"PAH",1,1,2,0)
 
"PKG",471,22,1,"PAH",1,1,3,0)
Results from LA7POC1 and LA7POC2 for iSTAT and 
"PKG",471,22,1,"PAH",1,1,4,0)
  Glucose testing are not going over to VISTA
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","PSJPAD7I")
0^1^B93404669^B94847537
"RTN","PSJPAD7I",1,0)
PSJPAD7I ;BIR/JCH-HL7 RECEIVER FOR OMH PADE POCKET ACTIVITY ;9/3/15 1:34  PM
"RTN","PSJPAD7I",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**317,356,362,381**;16 DEC 97;Build 2
"RTN","PSJPAD7I",3,0)
 ;
"RTN","PSJPAD7I",4,0)
 ; Reference to $$HLDATE^HLFNC is supported by DBIA 10106
"RTN","PSJPAD7I",5,0)
 ; Reference to ^XMD is supported by DBIA 10070
"RTN","PSJPAD7I",6,0)
 ; Reference to ^XLFDT is supported by DBIA# 10103.
"RTN","PSJPAD7I",7,0)
 ;
"RTN","PSJPAD7I",8,0)
 Q
"RTN","PSJPAD7I",9,0)
 ;
"RTN","PSJPAD7I",10,0)
OMS(PSJMSH,PSJSEG) ;Process OMS^O05 messages from the PSJ PADE OMS_O05 SUB subscriber protocol
"RTN","PSJPAD7I",11,0)
 ;
"RTN","PSJPAD7I",12,0)
 ; This routine and subroutines assume that all VistA HL7 environment
"RTN","PSJPAD7I",13,0)
 ; variables are properly initialized.
"RTN","PSJPAD7I",14,0)
 ;
"RTN","PSJPAD7I",15,0)
 ; The message will be checked to see if it is valid;
"RTN","PSJPAD7I",16,0)
 ;
"RTN","PSJPAD7I",17,0)
 ;  Input:   HL7 environment variables
"RTN","PSJPAD7I",18,0)
 ; Output:   Processed message or negative acknowledgement
"RTN","PSJPAD7I",19,0)
 ;
"RTN","PSJPAD7I",20,0)
 N PSJERR,PSJHL,PSJOMS,PSJDT
"RTN","PSJPAD7I",21,0)
 S PSJERR="",PSJDT=$$NOW^XLFDT
"RTN","PSJPAD7I",22,0)
 ;
"RTN","PSJPAD7I",23,0)
 D LOADMSG^PSJPAD7U(.PSJOMS,PSJMSH,.PSJERR)   ;Load inbound HL7 message
"RTN","PSJPAD7I",24,0)
 ;
"RTN","PSJPAD7I",25,0)
 Q:'$$VALIDMSG(.PSJOMS,.PSJHL,.PSJERR)
"RTN","PSJPAD7I",26,0)
 ;
"RTN","PSJPAD7I",27,0)
 D FILETRAN(.PSJOMS)
"RTN","PSJPAD7I",28,0)
 Q
"RTN","PSJPAD7I",29,0)
 ;
"RTN","PSJPAD7I",30,0)
VALIDMSG(PSJOMS,XMT,PSJERR)   ;Validate message
"RTN","PSJPAD7I",31,0)
 ;
"RTN","PSJPAD7I",32,0)
 ;  Messages handled: OMS^O05
"RTN","PSJPAD7I",33,0)
 ;
"RTN","PSJPAD7I",34,0)
 ;  OMS messages must contain RQD,ORC,and ZPM segments                                    
"RTN","PSJPAD7I",35,0)
 ;  NTE comments segment will be processed if received
"RTN","PSJPAD7I",36,0)
 ;  PID and PV1 segments are conditional: Transaction Type of V or R in ZPM.1
"RTN","PSJPAD7I",37,0)
 ;  Any additional segments are ignored
"RTN","PSJPAD7I",38,0)
 ;
"RTN","PSJPAD7I",39,0)
 ;  Input:
"RTN","PSJPAD7I",40,0)
 ;    MSGROOT - Root of array holding message
"RTN","PSJPAD7I",41,0)
 ;        XMT - Transmission parameters
"RTN","PSJPAD7I",42,0)
 ;
"RTN","PSJPAD7I",43,0)
 ; Output:
"RTN","PSJPAD7I",44,0)
 ;        XMT - Transmission parameters
"RTN","PSJPAD7I",45,0)
 ;        ERR - segment^sequence^field^code^ACK type^error text
"RTN","PSJPAD7I",46,0)
 ;
"RTN","PSJPAD7I",47,0)
 N MSH,PID,PV1,RQD,ORC,ZPM,NTE,PSJERR,PSJMUMPS,PSJIEN,DIC,DR,PSJHLIDS,I,PSJERR2,PSJERR3
"RTN","PSJPAD7I",48,0)
 S PSJERR="",PSJERR2="",PSJERR3=""
"RTN","PSJPAD7I",49,0)
 ;
"RTN","PSJPAD7I",50,0)
 ; Validate message is a well-formed OMS^O05 message type
"RTN","PSJPAD7I",51,0)
 ;-----------------------------------------------------------
"RTN","PSJPAD7I",52,0)
 ; All messages must have MSH, followed by ZPM
"RTN","PSJPAD7I",53,0)
 ; PID, RQD, ORC, and PV1 are conditional: Transaction Type = V or R ; ZPM.1
"RTN","PSJPAD7I",54,0)
 ; NTE segment is optional.  
"RTN","PSJPAD7I",55,0)
 ; All other segments are ignored.
"RTN","PSJPAD7I",56,0)
 ; Start with CONFIG errors
"RTN","PSJPAD7I",57,0)
 I '$D(PSJOMS("RQD")) D  I $G(PSJERR)]"" Q 0
"RTN","PSJPAD7I",58,0)
 .I $$PATRANS(.PSJOMS)  S PSJERR="Missing RQD segment. " D ERROR^PSJPAD7U(PSJERR,1)
"RTN","PSJPAD7I",59,0)
 I '$D(PSJOMS("ORC")) D  I $G(PSJERR)]"" Q 0
"RTN","PSJPAD7I",60,0)
 .I $$PATRANS(.PSJOMS)  S PSJERR="Missing ORC segment. " D ERROR^PSJPAD7U(PSJERR,1)
"RTN","PSJPAD7I",61,0)
 I '$D(PSJOMS("ZPM")) S PSJERR="Missing ZPM segment. " D ERROR^PSJPAD7U(PSJERR,1) Q 0
"RTN","PSJPAD7I",62,0)
 I $$PATRANS(.PSJOMS) F I="PID","PV1" Q:PSJERR'=""  D
"RTN","PSJPAD7I",63,0)
 .I '$D(PSJOMS(I)) S PSJERR=I_" - Missing segment" D ERROR^PSJPAD7U(PSJERR,1)
"RTN","PSJPAD7I",64,0)
 ;
"RTN","PSJPAD7I",65,0)
 ; Validate required fields
"RTN","PSJPAD7I",66,0)
 ;------------------------------------------------------
"RTN","PSJPAD7I",67,0)
 ; Check for missing/invalid required DATA fields
"RTN","PSJPAD7I",68,0)
 ; Missing PADE system is CONFIG issue
"RTN","PSJPAD7I",69,0)
 S PSJMUMPS="'$$FINDIENS^PSJPAD7U(58.601,PSJOMS(""DISPSYS""))"
"RTN","PSJPAD7I",70,0)
 S PSJERR=$$CHKFLD^PSJPAD7U(PSJOMS("DISPSYS"),,,PSJMUMPS,"PADE SYSTEM -ZPM.2") I $G(PSJERR)]"" D ERROR^PSJPAD7U(PSJERR,1)
"RTN","PSJPAD7I",71,0)
 ; End of CONFIG errors, begin DATA errors
"RTN","PSJPAD7I",72,0)
 S PSJERR=$$CHKFLD^PSJPAD7U(PSJOMS("STYP"),,,"","TRANS CODE -ZPM.1") I $G(PSJERR)]"" D ERROR^PSJPAD7U(PSJERR,1)
"RTN","PSJPAD7I",73,0)
 I $G(PSJOMS("DFN")) S PSJMUMPS="$G(PSJOMS(""DFN""))&$G(PSJOMS(""SSN""))&($P($G(^DPT(+$G(PSJOMS(""DFN"")),0)),""^"",9)'=$G(PSJOMS(""SSN"")))" D
"RTN","PSJPAD7I",74,0)
 .S PSJERR=$$CHKFLD^PSJPAD7U(PSJOMS("DFN"),,,PSJMUMPS,"MISMATCHED PATIENT SSN -PID.3") I $G(PSJERR)]"" D ERROR^PSJPAD7U(PSJERR)
"RTN","PSJPAD7I",75,0)
 S PSJMUMPS="$G(PSJOMS(""TTYPE""))=""V""&($G(PSJOMS(""TRNSAMT"")))&($G(PSJOMS(""VAORD""))="""")"
"RTN","PSJPAD7I",76,0)
 S PSJERR=$$CHKFLD^PSJPAD7U(PSJOMS("TTYPE"),,,PSJMUMPS,"TRANSACTION TYPE -ZPM.1") I $G(PSJERR)]"" D DWO(.PSJOMS)
"RTN","PSJPAD7I",77,0)
 S PSJERR=$$CHKFLD^PSJPAD7U(PSJOMS("NUR1A"),,,"","USER ID -ZPM.11.1") I $G(PSJERR)]"" D ERROR^PSJPAD7U(PSJERR)
"RTN","PSJPAD7I",78,0)
 S PSJERR2=$$CHKFLD^PSJPAD7U(PSJOMS("NUR1B"),,,"","USER ID -ZPM.11.2")
"RTN","PSJPAD7I",79,0)
 S PSJERR3=$$CHKFLD^PSJPAD7U(PSJOMS("NUR1C"),,,"","USER ID -ZPM.11.3")
"RTN","PSJPAD7I",80,0)
 I $G(PSJERR2)]""&($G(PSJERR3)]"") S PSJERR=PSJERR2_" "_PSJERR3 D ERROR^PSJPAD7U(PSJERR)
"RTN","PSJPAD7I",81,0)
 S PSJMUMPS="'$G(PSJOMS(""PSJDT""))?12N.14N&($$HL7TFM^XLFDT($G(PSJOMS(""PSJDT"")))'?7N1"".""1.N)"
"RTN","PSJPAD7I",82,0)
 S PSJERR=$$CHKFLD^PSJPAD7U(PSJOMS("PSJDT"),,,PSJMUMPS,"DATE/TIME -ZPM.19") I $G(PSJERR)]"" D ERROR^PSJPAD7U(PSJERR)
"RTN","PSJPAD7I",83,0)
 ; Check "SEND 'PATIENT NOT ON FILE' MSG" parameter
"RTN","PSJPAD7I",84,0)
 I $$NOPTMSG(.PSJOMS) D
"RTN","PSJPAD7I",85,0)
 .S PSJMUMPS="("",W,V,R,""[("",""_$G(PSJOMS(""TTYPE""))_"",""))&'$G(PSJOMS(""DFN""))"
"RTN","PSJPAD7I",86,0)
 .S PSJERR=$$CHKFLD^PSJPAD7U(+$G(PSJOMS("DFN")),,,PSJMUMPS,"PATIENT NOT ON FILE -PID.3/PID.19")
"RTN","PSJPAD7I",87,0)
 .Q:$G(PSJERR)=""
"RTN","PSJPAD7I",88,0)
 .I PSJERR[">0<" S PSJERR=$P(PSJERR,">0<") D
"RTN","PSJPAD7I",89,0)
 ..S PSJERR=PSJERR_">"_$S($L($G(PSJOMS("SSN"))):$G(PSJOMS("SSN")),$L($G(PSJOMS("PTID"))):$G(PSJOMS("PTID")),1:"")_"<"
"RTN","PSJPAD7I",90,0)
 .D ERROR^PSJPAD7U(PSJERR)
"RTN","PSJPAD7I",91,0)
 ;
"RTN","PSJPAD7I",92,0)
 Q 1
"RTN","PSJPAD7I",93,0)
 ;
"RTN","PSJPAD7I",94,0)
FILETRAN(PSJOMS) ; File into PADE INBOUND TRANSACTION file
"RTN","PSJPAD7I",95,0)
 ; Input - PSJOMS() - All input into PADE INBOUND TRANSACTIONS (#58.6) fields
"RTN","PSJPAD7I",96,0)
 N FDA,PSJDIERR,PSJMSG,PARRAY,TSIGN,PSJ7DT,PSJNOW,PCKBAL
"RTN","PSJPAD7I",97,0)
 S PSJNOW=$$NOW^XLFDT
"RTN","PSJPAD7I",98,0)
 ; Transaction Date/Time
"RTN","PSJPAD7I",99,0)
 S PSJ7DT=$$HL7TFM^XLFDT($E($G(PSJOMS("PSJDT")),1,14))
"RTN","PSJPAD7I",100,0)
 I '$G(PSJ7DT)!($L(PSJ7DT)<7) S PSJ7DT=PSJNOW
"RTN","PSJPAD7I",101,0)
 ;*362 - in case of a transaction date >2 hours in the future then the date/time will be set to NOW Date/Time specially for a pocket load
"RTN","PSJPAD7I",102,0)
 I PSJ7DT>$$FMADD^XLFDT(PSJNOW,,2) S PSJ7DT=PSJNOW
"RTN","PSJPAD7I",103,0)
 S FDA(58.6,"+1,",.01)=PSJ7DT
"RTN","PSJPAD7I",104,0)
 ; Dispensing System (console for Integrated Facility)
"RTN","PSJPAD7I",105,0)
 S FDA(58.6,"+1,",1.1)=PSJOMS("DISPSYS")                              ; Dispensing System
"RTN","PSJPAD7I",106,0)
 S FDA(58.6,"+1,",1.2)=$S(PSJOMS("DRWR")]"":PSJOMS("DRWR"),1:"~~")    ; PADE Drawer
"RTN","PSJPAD7I",107,0)
 S FDA(58.6,"+1,",1)=PSJOMS("CABID")                                  ; Cabinet ID / Dispensing Device
"RTN","PSJPAD7I",108,0)
 I $L($G(PSJOMS("DRGITM"))) D                                         ; Drug ID
"RTN","PSJPAD7I",109,0)
 .I $D(^PSDRUG(PSJOMS("DRGITM"),2)) S FDA(58.6,"+1,",2)=PSJOMS("DRGITM") Q
"RTN","PSJPAD7I",110,0)
 .I '$D(^PSDRUG(PSJOMS("DRGITM"),2)) D
"RTN","PSJPAD7I",111,0)
 ..S FDA(58.6,"+1,",18)=PSJOMS("DRGTXT")
"RTN","PSJPAD7I",112,0)
 ..S FDA(58.6,"+1,",19)=PSJOMS("DRGITM")
"RTN","PSJPAD7I",113,0)
 ..S PSJOMS("DRGETXT")=PSJOMS("DRGTXT")
"RTN","PSJPAD7I",114,0)
 ..S PSJOMS("DRGEID")=PSJOMS("DRGITM")
"RTN","PSJPAD7I",115,0)
 S FDA(58.6,"+1,",3)=PSJOMS("TRNSAMT")                                ; Transaction Amount (Quantity)
"RTN","PSJPAD7I",116,0)
 S FDA(58.6,"+1,",4)=PSJOMS("TTYPE")                                  ; Transaction Type
"RTN","PSJPAD7I",117,0)
 S:$L($G(PSJOMS("NUR1A"))) FDA(58.6,"+1,",5)=$G(PSJOMS("DRGUNIT"))    ; Drug Unit
"RTN","PSJPAD7I",118,0)
 S:$L($G(PSJOMS("NUR1A"))) FDA(58.6,"+1,",6.1)=PSJOMS("NUR1A")        ; PADE User
"RTN","PSJPAD7I",119,0)
 S:$L($G(PSJOMS("NUR1B"))) FDA(58.6,"+1,",6.2)=PSJOMS("NUR1B")_","_$G(PSJOMS("NUR1C"))    ; PADE Witness
"RTN","PSJPAD7I",120,0)
 S:$L($G(PSJOMS("NUR2A"))) FDA(58.6,"+1,",7.1)=PSJOMS("NUR2A")
"RTN","PSJPAD7I",121,0)
 S:$L($G(PSJOMS("NUR2B"))) FDA(58.6,"+1,",7.2)=PSJOMS("NUR2B")_","_$G(PSJOMS("NUR2C"))
"RTN","PSJPAD7I",122,0)
 ; If User ID is pointer to NEW PERSON file (#200), update USER field (#6)
"RTN","PSJPAD7I",123,0)
 I $G(PSJOMS("NUR1")) S FDA(58.6,"+1,",6)=PSJOMS("NUR1")
"RTN","PSJPAD7I",124,0)
 ; If Witness ID is pointer to NEW PERSON file (#200), update WITNESS field (#7)
"RTN","PSJPAD7I",125,0)
 I $G(PSJOMS("NUR2")) S FDA(58.6,"+1,",7)=PSJOMS("NUR2")
"RTN","PSJPAD7I",126,0)
 S FDA(58.6,"+1,",10)=$S(PSJOMS("PKT")]"":PSJOMS("PKT"),1:"~~")      ; PADE Pocket
"RTN","PSJPAD7I",127,0)
 S FDA(58.6,"+1,",11)=PSJOMS("SBDRWR")                               ; PADE Subdrawer
"RTN","PSJPAD7I",128,0)
 S FDA(58.6,"+1,",12)=PSJOMS("EXBCNT")                               ; Expected Begin Count
"RTN","PSJPAD7I",129,0)
 S FDA(58.6,"+1,",13)=PSJOMS("ACBCNT")                               ; Actual Begin Count
"RTN","PSJPAD7I",130,0)
 ; Patient Data
"RTN","PSJPAD7I",131,0)
 N POCKET,PTRNSTYP S POCKET=$G(PSJOMS("PKT"))
"RTN","PSJPAD7I",132,0)
 ;I (PSJOMS("TTYPE")="V"!(PSJOMS("TTYPE")="R")!($E(PSJOMS("TTYPE"))="W")!($E(PSJOMS("TTYPE"))="N")!($E(PSJOMS("TTYPE")="A"))!($E(POCKET,$L(POCKET)-2,$L(POCKET))="PSB"))
"RTN","PSJPAD7I",133,0)
 S PTRNSTYP=$$PTRNSTYP(PSJOMS("TTYPE"),$G(POCKET))
"RTN","PSJPAD7I",134,0)
 I PTRNSTYP D SETPAT(.PSJOMS)
"RTN","PSJPAD7I",135,0)
 I (PSJOMS("TTYPE")="L")!(PSJOMS("TTYPE")="U")!(PSJOMS("TTYPE")="C") D
"RTN","PSJPAD7I",136,0)
 .N POCKBIN S POCKBIN=$G(PSJOMS("PKT"))
"RTN","PSJPAD7I",137,0)
 .I $E(POCKBIN,$L(POCKBIN)-2,$L(POCKBIN))="PSB"&($G(PSJOMS("COMMENT"))["PATIENT SPECIFIC BIN") D
"RTN","PSJPAD7I",138,0)
 ..D SETPAT(.PSJOMS)
"RTN","PSJPAD7I",139,0)
 S:$L($G(PSJOMS("VAORD"))) FDA(58.6,"+1,",15)=PSJOMS("VAORD")        ; Pharmacy Order
"RTN","PSJPAD7I",140,0)
 S PARRAY(5)=$G(PSJOMS("TTYPE")),PARRAY(6)=$G(PSJOMS("TRNSAMT"))
"RTN","PSJPAD7I",141,0)
 S TSIGN=$$TSIGN^PSJPADIT(.PARRAY)
"RTN","PSJPAD7I",142,0)
 S PSJOMS("TRNSAMT")=TSIGN_PSJOMS("PSDQ")
"RTN","PSJPAD7I",143,0)
 ; Pocket Balance Forward - If COUNT transaction, Actual Begin Count = Balance Forward (no change)
"RTN","PSJPAD7I",144,0)
 S PCKBAL=$S($E(PSJOMS("TTYPE"))="C":PSJOMS("ACBCNT"),$E(PSJOMS("TTYPE"))="A":PSJOMS("ACBCNT"),1:PSJOMS("EXBCNT")+PSJOMS("TRNSAMT"))
"RTN","PSJPAD7I",145,0)
 S PCKBAL=$S(PCKBAL<0:0,1:PCKBAL)
"RTN","PSJPAD7I",146,0)
 S FDA(58.6,"+1,",16)=PCKBAL
"RTN","PSJPAD7I",147,0)
 I $G(PSJOMS("TOTITMS"))]"" S FDA(58.6,"+1,",17)=PSJOMS("TOTITMS")   ; Total count of this drug in Cabinet
"RTN","PSJPAD7I",148,0)
 I ($G(PSJOMS("TOTITMS"))="") D
"RTN","PSJPAD7I",149,0)
 .S FDA(58.6,"+1,",17)=PSJOMS("ACBCNT")+PSJOMS("TRNSAMT")             ; Device balance not in ZPM.13, try to calculate
"RTN","PSJPAD7I",150,0)
 I $G(PSJOMS("TTYPE"))="B" K FDA(58.6,"+1,",17)
"RTN","PSJPAD7I",151,0)
 I '$L($G(FDA(58.6,"+1,",18))) S:$L($G(PSJOMS("DRGETXT"))) FDA(58.6,"+1,",18)=PSJOMS("DRGETXT") ; Drug Name
"RTN","PSJPAD7I",152,0)
 I '$L($G(FDA(58.6,"+1,",19))) S:$L($G(PSJOMS("DRGEID"))) FDA(58.6,"+1,",19)=PSJOMS("DRGEID")   ; Drug alternate ID
"RTN","PSJPAD7I",153,0)
 I $G(PSJOMS("LOTNUM"))?1.11ANP S FDA(58.6,"+1,",20)=PSJOMS("LOTNUM")  ; Drug Lot Number
"RTN","PSJPAD7I",154,0)
 S:$L($G(PSJOMS("COMMENT"))) FDA(58.6,"+1,",21)=PSJOMS("COMMENT")      ; Comment
"RTN","PSJPAD7I",155,0)
 I $G(PSJOMS("POREORD"))?1.4N S FDA(58.6,"+1,",23)=PSJOMS("POREORD")   ; Reorder level (PAR Qty)
"RTN","PSJPAD7I",156,0)
 I $G(PSJOMS("DRGEID"))?1.30ANP S FDA(58.6,"+1,",19)=PSJOMS("DRGEID")
"RTN","PSJPAD7I",157,0)
 I $G(PSJOMS("DRGETXT"))?1.40ANP S FDA(58.6,"+1,",18)=PSJOMS("DRGETXT")
"RTN","PSJPAD7I",158,0)
 ;
"RTN","PSJPAD7I",159,0)
 ; Set status to Pending
"RTN","PSJPAD7I",160,0)
 S FDA(58.6,"+1,",22)="P"
"RTN","PSJPAD7I",161,0)
 K PSJDIERR,DIERR D UPDATE^DIE(,"FDA","","PSJDIERR") K DIERR ;*356
"RTN","PSJPAD7I",162,0)
 S PSJDIERR=$G(PSJDIERR("DIERR")) I PSJDIERR D
"RTN","PSJPAD7I",163,0)
 .N PSJDIER2,PSJMSG S PSJDIER2=$P(PSJDIERR,"^",2)
"RTN","PSJPAD7I",164,0)
 .S PSJMSG=$G(PSJDIERR("DIERR",+PSJDIERR,"TEXT",$S(PSJDIER2:PSJDIER2,1:1)))
"RTN","PSJPAD7I",165,0)
 .S PSJMSG="FILEMAN ERROR: "_$G(PSJMSG)_"^"_" SYSTEM="_$G(PSJOMS("DISPSYS"))_" CABINET="_$G(PSJOMS("CABID"))
"RTN","PSJPAD7I",166,0)
 .D ERROR^PSJPAD7U(.PSJMSG)
"RTN","PSJPAD7I",167,0)
 Q
"RTN","PSJPAD7I",168,0)
 ;
"RTN","PSJPAD7I",169,0)
SETPAT(PSJOMS) ; Set patient data
"RTN","PSJPAD7I",170,0)
 N PSJMNAME ; Patient Missing from PATIENT (#2) file
"RTN","PSJPAD7I",171,0)
 S:$G(PSJOMS("DFN")) FDA(58.6,"+1,",14)=+$G(PSJOMS("DFN"))
"RTN","PSJPAD7I",172,0)
 S:$G(PSJOMS("PTNAMA"))]"" FDA(58.6,"+1,",14.1)=PSJOMS("PTNAMA")
"RTN","PSJPAD7I",173,0)
 S:$G(PSJOMS("PTNAMB"))]"" FDA(58.6,"+1,",14.2)=PSJOMS("PTNAMB")
"RTN","PSJPAD7I",174,0)
 S:$G(PSJOMS("PTID"))]"" FDA(58.6,"+1,",14.3)=PSJOMS("PTID")
"RTN","PSJPAD7I",175,0)
 S:$G(PSJOMS("VAORD"))]"" FDA(58.6,"+1,",15)=PSJOMS("VAORD")
"RTN","PSJPAD7I",176,0)
 S:$G(PSJOMS("MDFN"))]"" FDA(58.6,"+1,",24)=PSJOMS("MDFN")
"RTN","PSJPAD7I",177,0)
 I $G(PSJOMS("MPTNAMA"))]"" S FDA(58.6,"+1,",25)=PSJOMS("MPTNAMA")
"RTN","PSJPAD7I",178,0)
 I $G(PSJOMS("MPTNAMB"))]"" S FDA(58.6,"+1,",25)=$G(FDA(58.6,"+1,",25))_$S($G(FDA(58.6,"+1,",25))]"":",",1:"")_$G(PSJOMS("MPTNAMB"))
"RTN","PSJPAD7I",179,0)
 Q
"RTN","PSJPAD7I",180,0)
 ;
"RTN","PSJPAD7I",181,0)
DWO(PSJOMS) ; Send Dispensed Without Order (DWO) Alert
"RTN","PSJPAD7I",182,0)
 N GROUPS
"RTN","PSJPAD7I",183,0)
 S GROUPS=""
"RTN","PSJPAD7I",184,0)
 Q:'$$ACTDWO^PSJPAD70(.PSJOMS)
"RTN","PSJPAD7I",185,0)
 D GETGRPS^PSJPAD70(.PSJOMS,.GROUPS)
"RTN","PSJPAD7I",186,0)
 D DWOSEND^PSJPAD70(.PSJOMS,.GROUPS)
"RTN","PSJPAD7I",187,0)
 Q
"RTN","PSJPAD7I",188,0)
 ;
"RTN","PSJPAD7I",189,0)
NOPTMSG(PSJOMS)  ; Check "SEND 'NO PATIENT ON FILE' MSG' Parameter.
"RTN","PSJPAD7I",190,0)
 ; Input : PSJOMS("DISPSYS")        ; Dispensing System, ZPM-2, filed into Field #11 in PADE DISPENSING DEVICE (#58.63) file
"RTN","PSJPAD7I",191,0)
 ;         PSJOMS("PSJOMS("CABID")
"RTN","PSJPAD7I",192,0)
 N PADEVIEN,PSJPSYS,PSJERR2,PADPTMSG
"RTN","PSJPAD7I",193,0)
 S PADPTMSG=0
"RTN","PSJPAD7I",194,0)
 K DIERR,PSJERR2 S PSJPSYS=$$FIND1^DIC(58.601,,"BX",$G(PSJOMS("DISPSYS")),,,"PSJERR2") K DIERR  ;*356
"RTN","PSJPAD7I",195,0)
 I '$G(PSJERR2("DIERR")) K DIERR,PSJERR2 S PADEVIEN=$$FIND1^DIC(58.63,,"BX",$G(PSJOMS("CABID")),,,"PSJERR2") K DIERR  ;*356
"RTN","PSJPAD7I",196,0)
 I '$G(PSJERR2("DIERR")),$G(PADEVIEN) S PADPTMSG=+$G(^PS(58.63,+PADEVIEN,8))
"RTN","PSJPAD7I",197,0)
 Q $S($G(PADPTMSG):1,1:0)
"RTN","PSJPAD7I",198,0)
 ;
"RTN","PSJPAD7I",199,0)
GETDIV(PSJOMS) ; Get Division from DISPENSING CABINET file (#58.63)
"RTN","PSJPAD7I",200,0)
 N CABNAME,CABIEN,RESULT,PSJPSYS,PSJDIV
"RTN","PSJPAD7I",201,0)
 S CABNAME=$G(PSJOMS("CABID")) Q:(CABNAME="") ""
"RTN","PSJPAD7I",202,0)
 S PSJPSYS=$G(PSJOMS("DISPSYS")) Q:(PSJPSYS="") ""
"RTN","PSJPAD7I",203,0)
 K DIERR S PSJPSYS=$$FIND1^DIC(58.601,"","",PSJPSYS) K DIERR Q:'PSJPSYS ""  ;*356
"RTN","PSJPAD7I",204,0)
 K DIERR S CABIEN=$$FIND1^DIC(58.63,,,CABNAME,,,"RESULT") K DIERR Q:'CABIEN ""  ;*356
"RTN","PSJPAD7I",205,0)
 K RESULT
"RTN","PSJPAD7I",206,0)
 K DIERR D GETS^DIQ(58.63,CABIEN,2,"I","RESULT") K DIERR ;*356
"RTN","PSJPAD7I",207,0)
 S PSJDIV=$G(RESULT(58.63,CABIEN_",",2,"I"))
"RTN","PSJPAD7I",208,0)
 Q PSJDIV
"RTN","PSJPAD7I",209,0)
 ;
"RTN","PSJPAD7I",210,0)
PATRANS(PSJOMS) ; Return flag indicating whether or not transaction type REQUIRES PID and PV1 segments
"RTN","PSJPAD7I",211,0)
 I ($G(PSJOMS("TTYPE"))="V") Q 1
"RTN","PSJPAD7I",212,0)
 I ($G(PSJOMS("TTYPE"))="R") Q 1
"RTN","PSJPAD7I",213,0)
 Q 0
"RTN","PSJPAD7I",214,0)
 ;
"RTN","PSJPAD7I",215,0)
DRGXREF(DA,PSJOMS) ; Return Drug file (#50) IEN, if present in PSJOMS("DRGITM"). If no Drug IEN, return 0.
"RTN","PSJPAD7I",216,0)
 ; Called from 'AC' cross reference in PADE INBOUND TRANSACTION (#58.6) file
"RTN","PSJPAD7I",217,0)
 N DRUGIEN
"RTN","PSJPAD7I",218,0)
 S DRUGIEN=+$G(PSJOMS("DRGITM"))
"RTN","PSJPAD7I",219,0)
 ; If the drug id is not purely numeric, it's not an IEN
"RTN","PSJPAD7I",220,0)
 I DRUGIEN'=$G(PSJOMS("DRGITM")) S DRUGIEN=0
"RTN","PSJPAD7I",221,0)
 Q +$G(DRUGIEN)
"RTN","PSJPAD7I",222,0)
 ;
"RTN","PSJPAD7I",223,0)
GETPDMGR(XMY)  ; Return all users with PSJ PADE MGR key in XMY array
"RTN","PSJPAD7I",224,0)
 ;N X,PADMGR   381
"RTN","PSJPAD7I",225,0)
 ;D LIST^DIC(200,,.01,"PI",,,,,"I $D(^XUSEC(""PSJ PADE MGR"",+$G(Y)))",,"PADMGR")
"RTN","PSJPAD7I",226,0)
 ;S X=0 F  S X=$O(PADMGR("DILIST",X)) Q:'X  S PADMGR=+$G(PADMGR("DILIST",X,0)) I PADMGR S XMY(PADMGR)=""
"RTN","PSJPAD7I",227,0)
 N PADMGR   ;381
"RTN","PSJPAD7I",228,0)
 F PADMGR=0:0 S PADMGR=$O(^XUSEC("PSJ PADE MGR",PADMGR)) Q:'PADMGR  S XMY(PADMGR)=""
"RTN","PSJPAD7I",229,0)
 Q
"RTN","PSJPAD7I",230,0)
 ;
"RTN","PSJPAD7I",231,0)
PTRNSTYP(TTYPE,POCKET) ; Return 1 if TTYPE is a patient transaction type, return zero if TTYPE is NOT patient transaction type
"RTN","PSJPAD7I",232,0)
 N PTRNSTYP,PADEPCK
"RTN","PSJPAD7I",233,0)
 S PADEPCK=$G(POCKET)
"RTN","PSJPAD7I",234,0)
 ; 
"RTN","PSJPAD7I",235,0)
 ; Vend, Return, and Waste are always patient transactions
"RTN","PSJPAD7I",236,0)
 ; Null and Discrepancy may be patient transactions
"RTN","PSJPAD7I",237,0)
 S PTRNSTYP=$S(TTYPE="":0,",V,R,W,N,A,"[(","_TTYPE_","):1,($E(PADEPCK,$L(PADEPCK)-2,$L(PADEPCK))="PSB"):1,1:0)
"RTN","PSJPAD7I",238,0)
 Q PTRNSTYP
"VER")
8.0^22.2
"BLD",11327,6)
^326
**END**
**END**

