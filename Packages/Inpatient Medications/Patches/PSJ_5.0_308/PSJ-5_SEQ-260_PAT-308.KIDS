Released PSJ*5*308 SEQ #260
Extracted from mail message
**KIDS**:PSJ*5.0*308^

**INSTALL NAME**
PSJ*5.0*308
"BLD",9634,0)
PSJ*5.0*308^INPATIENT MEDICATIONS^0^3140320^y
"BLD",9634,1,0)
^^10^10^3140320^
"BLD",9634,1,1,0)
This Patch Addresses 4 issues:
"BLD",9634,1,2,0)
 
"BLD",9634,1,3,0)
1. Orders on the Medication Administrative History (MAH) report are 
"BLD",9634,1,4,0)
missing or not showing in BCMA or CPRS. 
"BLD",9634,1,5,0)
2. An undefined error occurs when trying to access the "Edit Med Log" 
"BLD",9634,1,6,0)
option in BCMA.
"BLD",9634,1,7,0)
3. An undefined error occurs when trying to view the Medication Admin 
"BLD",9634,1,8,0)
History (MAH) in BCMA.
"BLD",9634,1,9,0)
4. An undefined error occurs when accessing a patient who has a PRN order 
"BLD",9634,1,10,0)
which is tied to a clinic without an appointment. 
"BLD",9634,4,0)
^9.64PA^^
"BLD",9634,6.3)
12
"BLD",9634,"KRN",0)
^9.67PA^779.2^20
"BLD",9634,"KRN",.4,0)
.4
"BLD",9634,"KRN",.401,0)
.401
"BLD",9634,"KRN",.402,0)
.402
"BLD",9634,"KRN",.403,0)
.403
"BLD",9634,"KRN",.5,0)
.5
"BLD",9634,"KRN",.84,0)
.84
"BLD",9634,"KRN",3.6,0)
3.6
"BLD",9634,"KRN",3.8,0)
3.8
"BLD",9634,"KRN",9.2,0)
9.2
"BLD",9634,"KRN",9.8,0)
9.8
"BLD",9634,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",9634,"KRN",9.8,"NM",1,0)
PSJBCMA^^0^B122612748
"BLD",9634,"KRN",9.8,"NM","B","PSJBCMA",1)
 
"BLD",9634,"KRN",19,0)
19
"BLD",9634,"KRN",19.1,0)
19.1
"BLD",9634,"KRN",101,0)
101
"BLD",9634,"KRN",409.61,0)
409.61
"BLD",9634,"KRN",771,0)
771
"BLD",9634,"KRN",779.2,0)
779.2
"BLD",9634,"KRN",870,0)
870
"BLD",9634,"KRN",8989.51,0)
8989.51
"BLD",9634,"KRN",8989.52,0)
8989.52
"BLD",9634,"KRN",8994,0)
8994
"BLD",9634,"KRN","B",.4,.4)
 
"BLD",9634,"KRN","B",.401,.401)
 
"BLD",9634,"KRN","B",.402,.402)
 
"BLD",9634,"KRN","B",.403,.403)
 
"BLD",9634,"KRN","B",.5,.5)
 
"BLD",9634,"KRN","B",.84,.84)
 
"BLD",9634,"KRN","B",3.6,3.6)
 
"BLD",9634,"KRN","B",3.8,3.8)
 
"BLD",9634,"KRN","B",9.2,9.2)
 
"BLD",9634,"KRN","B",9.8,9.8)
 
"BLD",9634,"KRN","B",19,19)
 
"BLD",9634,"KRN","B",19.1,19.1)
 
"BLD",9634,"KRN","B",101,101)
 
"BLD",9634,"KRN","B",409.61,409.61)
 
"BLD",9634,"KRN","B",771,771)
 
"BLD",9634,"KRN","B",779.2,779.2)
 
"BLD",9634,"KRN","B",870,870)
 
"BLD",9634,"KRN","B",8989.51,8989.51)
 
"BLD",9634,"KRN","B",8989.52,8989.52)
 
"BLD",9634,"KRN","B",8994,8994)
 
"BLD",9634,"QUES",0)
^9.62^^
"BLD",9634,"REQB",0)
^9.611^1^1
"BLD",9634,"REQB",1,0)
PSJ*5.0*279^2
"BLD",9634,"REQB","B","PSJ*5.0*279",1)
 
"MBREQ")
0
"PKG",471,-1)
1^1
"PKG",471,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",471,20,0)
^9.402P^^
"PKG",471,22,0)
^9.49I^1^1
"PKG",471,22,1,0)
5.0^2971215^2990325^66481
"PKG",471,22,1,"PAH",1,0)
308^3140320
"PKG",471,22,1,"PAH",1,1,0)
^^10^10^3140320
"PKG",471,22,1,"PAH",1,1,1,0)
This Patch Addresses 4 issues:
"PKG",471,22,1,"PAH",1,1,2,0)
 
"PKG",471,22,1,"PAH",1,1,3,0)
1. Orders on the Medication Administrative History (MAH) report are 
"PKG",471,22,1,"PAH",1,1,4,0)
missing or not showing in BCMA or CPRS. 
"PKG",471,22,1,"PAH",1,1,5,0)
2. An undefined error occurs when trying to access the "Edit Med Log" 
"PKG",471,22,1,"PAH",1,1,6,0)
option in BCMA.
"PKG",471,22,1,"PAH",1,1,7,0)
3. An undefined error occurs when trying to view the Medication Admin 
"PKG",471,22,1,"PAH",1,1,8,0)
History (MAH) in BCMA.
"PKG",471,22,1,"PAH",1,1,9,0)
4. An undefined error occurs when accessing a patient who has a PRN order 
"PKG",471,22,1,"PAH",1,1,10,0)
which is tied to a clinic without an appointment. 
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")
 
"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","PSJBCMA")
0^1^B122612748^B104152395
"RTN","PSJBCMA",1,0)
PSJBCMA ;BIR/MV-RETURN INPATIENT ACTIVE MEDS (CONDENSED) ;1/23/13 1:23pm
"RTN","PSJBCMA",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**32,41,46,57,63,66,56,69,58,81,91,104,111,112,186,159,173,190,113,225,253,267,279,308**;16 DEC 97;Build 12
"RTN","PSJBCMA",3,0)
 ;
"RTN","PSJBCMA",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180.
"RTN","PSJBCMA",5,0)
 ; Reference to ^PS(51 is supported by DBIA 2176.
"RTN","PSJBCMA",6,0)
 ; Reference to ^PS(51.1 is supported by DBIA 2177.
"RTN","PSJBCMA",7,0)
 ; Reference to ^PS(51.2 is supported by DBIA 2178.
"RTN","PSJBCMA",8,0)
 ; Reference to ^PS(52.6 is supported by DBIA 1231.
"RTN","PSJBCMA",9,0)
 ; Reference to ^PS(52.7 is supported by DBIA 2173.
"RTN","PSJBCMA",10,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJBCMA",11,0)
 ; Reference to ^PSDRUG is supported by DBIA 2192.
"RTN","PSJBCMA",12,0)
 ; Reference to ^VADPT is supported by DBIA 10061.
"RTN","PSJBCMA",13,0)
 ; Reference to ^XLFDT is supported by DBIA 10103
"RTN","PSJBCMA",14,0)
 ; Usage of this routine by BCMA is supported by DBIA 2828.
"RTN","PSJBCMA",15,0)
 ;
"RTN","PSJBCMA",16,0)
 ;*267 - add new piece of info to return TMP global. Need the Med 
"RTN","PSJBCMA",17,0)
 ;       route IEN per each order.
"RTN","PSJBCMA",18,0)
 ;*279 - add Clinic name, IEN to pieces 11, 12 of TMP("PSJ",$J,0)
"RTN","PSJBCMA",19,0)
 ;     - add High Risk drug Witness indicator to Results 7th piece
"RTN","PSJBCMA",20,0)
 ;
"RTN","PSJBCMA",21,0)
EN(DFN,BDT,OTDATE)         ; return condensed list of inpatient meds
"RTN","PSJBCMA",22,0)
 NEW CNT,DN,F,FON,ON,PST,WBDT,X,X1,X2,Y,%
"RTN","PSJBCMA",23,0)
 D:+$G(DFN) ORDER
"RTN","PSJBCMA",24,0)
 I '$D(^TMP("PSJ",$J,1,0)) S ^(0)=-1
"RTN","PSJBCMA",25,0)
 K PSJINX
"RTN","PSJBCMA",26,0)
 Q
"RTN","PSJBCMA",27,0)
ORDER ;Loop thru orders.
"RTN","PSJBCMA",28,0)
 I '+$G(BDT) D NOW^%DTC S BDT=%
"RTN","PSJBCMA",29,0)
 I BDT'["." S BDT=BDT_".0001"
"RTN","PSJBCMA",30,0)
 S PSJINX=0
"RTN","PSJBCMA",31,0)
 ;U/D orders
"RTN","PSJBCMA",32,0)
 S F="^PS(55,DFN,5,",WBDT=BDT
"RTN","PSJBCMA",33,0)
 F  S WBDT=$O(^PS(55,DFN,5,"AUS",WBDT)) Q:'WBDT  D
"RTN","PSJBCMA",34,0)
 . F ON=0:0 S ON=$O(^PS(55,DFN,5,"AUS",WBDT,ON)) Q:'ON  S FON=ON_"U",PSJON(FON)="" D UDVAR
"RTN","PSJBCMA",35,0)
 ;IV orders
"RTN","PSJBCMA",36,0)
 S F="^PS(55,DFN,""IV"",",WBDT=BDT
"RTN","PSJBCMA",37,0)
 F  S WBDT=$O(^PS(55,DFN,"IV","AIS",WBDT)) Q:'WBDT  D
"RTN","PSJBCMA",38,0)
 . F ON=0:0 S ON=$O(^PS(55,DFN,"IV","AIS",WBDT,ON)) Q:'ON  S FON=ON_"V",PSJON(FON)="" D IVVAR
"RTN","PSJBCMA",39,0)
 ;Pending orders
"RTN","PSJBCMA",40,0)
 S F="^PS(53.1,"
"RTN","PSJBCMA",41,0)
 F PST="P","N" F ON=0:0 S ON=$O(^PS(53.1,"AS",PST,DFN,ON)) Q:'ON  D
"RTN","PSJBCMA",42,0)
 . S FON=ON_"P"
"RTN","PSJBCMA",43,0)
 . S X=$P($G(^PS(53.1,+ON,0)),U,4) D @$S(X="F":"IVVAR",1:"UDVAR")
"RTN","PSJBCMA",44,0)
 ;When a one-time order is found, check against PSJON(FON) array to
"RTN","PSJBCMA",45,0)
 ;make sure no duplicates return on ^TMP.
"RTN","PSJBCMA",46,0)
 I '+$G(OTDATE) D NOW^%DTC S X1=$E(%,1,12),X2=-30 D C^%DTC S OTDATE=X
"RTN","PSJBCMA",47,0)
 I OTDATE'["." S OTDATE=OTDATE_".0001"
"RTN","PSJBCMA",48,0)
 Q:BDT'>OTDATE
"RTN","PSJBCMA",49,0)
 S F="^PS(55,DFN,5,",WBDT=OTDATE
"RTN","PSJBCMA",50,0)
 F  S WBDT=$O(^PS(55,DFN,5,"AU","O",WBDT)) Q:'WBDT  D
"RTN","PSJBCMA",51,0)
 .  F ON=0:0 S ON=$O(^PS(55,DFN,5,"AU","O",WBDT,ON)) Q:'ON  D
"RTN","PSJBCMA",52,0)
 .. S FON=ON_"U" D:'$D(PSJON(FON)) UDVAR
"RTN","PSJBCMA",53,0)
 S F="^PS(55,DFN,""IV"",",WBDT=OTDATE
"RTN","PSJBCMA",54,0)
 F  S WBDT=$O(^PS(55,DFN,"IV","AIS",WBDT)) Q:'WBDT  D
"RTN","PSJBCMA",55,0)
 . F ON=0:0 S ON=$O(^PS(55,DFN,"IV","AIS",WBDT,ON)) Q:'ON  D
"RTN","PSJBCMA",56,0)
 .. S X=$P($G(^PS(55,DFN,"IV",ON,0)),U,9)
"RTN","PSJBCMA",57,0)
 .. I X]"",$$ONE(DFN,ON_"V",X,$P(X,"^",2),$P(X,"^",3))="O" D
"RTN","PSJBCMA",58,0)
 ... S FON=ON_"V" D:'$D(PSJON(FON)) IVVAR
"RTN","PSJBCMA",59,0)
 K PSJON,PSJBCID
"RTN","PSJBCMA",60,0)
 Q
"RTN","PSJBCMA",61,0)
UDVAR ;Set ^TMP for Unit dose & Pending orders
"RTN","PSJBCMA",62,0)
 N CLINIC
"RTN","PSJBCMA",63,0)
 D UDPEND I '$$CLINICS($G(CLINIC)) Q
"RTN","PSJBCMA",64,0)
 D TMP
"RTN","PSJBCMA",65,0)
 ;Setup Dispense drug for ^TMP
"RTN","PSJBCMA",66,0)
 S CNT=0 D NOW^%DTC
"RTN","PSJBCMA",67,0)
 F X=0:0 S X=$O(@(F_ON_",1,"_X_")")) Q:'X  D
"RTN","PSJBCMA",68,0)
 . S PSJDD=@(F_ON_",1,"_X_",0)") I $P(PSJDD,"^",3)]"",$P(PSJDD,"^",3)'>% Q
"RTN","PSJBCMA",69,0)
 .;*225 Don't allow 0
"RTN","PSJBCMA",70,0)
 . I +$P(PSJDD,"^",2)=0 S $P(PSJDD,"^",2)=1
"RTN","PSJBCMA",71,0)
 . S CNT=CNT+1
"RTN","PSJBCMA",72,0)
 . S ^TMP("PSJ",$J,PSJINX,700,CNT,0)=+PSJDD_U_$P($G(^PSDRUG(+PSJDD,0)),U)_U_$S((FON["U")&($P(PSJDD,U,2)=""):1,(FON["U")&($E($P(PSJDD,U,2))="."):"0"_$P(PSJDD,U,2),1:$P(PSJDD,U,2))_U_$P(PSJDD,U,3)
"RTN","PSJBCMA",73,0)
 . ;add High Risk field to 6th piece of 700 (disp drug)          ;*279
"RTN","PSJBCMA",74,0)
 . S $P(^TMP("PSJ",$J,PSJINX,700,CNT,0),U,6)=$$GET1^DIQ(50.7,PSJ("OI"),1,"I")
"RTN","PSJBCMA",75,0)
 S:CNT ^TMP("PSJ",$J,PSJINX,700,0)=CNT
"RTN","PSJBCMA",76,0)
 K PSJ,PSJDD
"RTN","PSJBCMA",77,0)
 Q
"RTN","PSJBCMA",78,0)
IVVAR ;Set variables for IV and pending orders
"RTN","PSJBCMA",79,0)
 NEW ND,X,Y,CLINIC
"RTN","PSJBCMA",80,0)
 I FON["P" D UDPEND Q:'$$CLINICS(CLINIC)  S PSJ("INFRATE")=$P($P($G(^PS(53.1,ON,8)),U,5),"@")
"RTN","PSJBCMA",81,0)
 I FON["V" D  Q:'$$CLINICS(CLINIC)
"RTN","PSJBCMA",82,0)
 . S X=$G(^PS(55,DFN,"IV",ON,0)),CLINIC=$G(^("DSS")) Q:'$$CLINICS(CLINIC)
"RTN","PSJBCMA",83,0)
 . S PSJ("STARTDT")=$P(X,U,2),PSJ("STOPDT")=$P(X,U,3)
"RTN","PSJBCMA",84,0)
 . S PSJ("INFRATE")=$P($P(X,U,8),"@"),PSJ("SCHD")=$P(X,U,9)
"RTN","PSJBCMA",85,0)
 . S PSJ("ADM")=$P(X,U,11),PSJ("AUTO")=$P(X,U,12),PSJ("STATUS")=$P(X,U,17)
"RTN","PSJBCMA",86,0)
 . S PSJ("IVTYPE")=$P(X,U,4),PSJ("INSYR")=$P(X,U,5)
"RTN","PSJBCMA",87,0)
 . S PSJ("CPRS")=$P(X,U,21),PSJ("CHEMO")=$P(X,U,23)
"RTN","PSJBCMA",88,0)
 . S X=$G(^PS(55,DFN,"IV",ON,.2))
"RTN","PSJBCMA",89,0)
 . S PSJ("DO")="",PSJ("MR")=$P(X,U,3),PSJ("PRI")=$P(X,U,4),PSJ("FLG")=$P(X,U,7),PSJ("COM")="",PSJ("SRC")=""
"RTN","PSJBCMA",90,0)
 . I PSJ("FLG") D
"RTN","PSJBCMA",91,0)
 .. N S1,A,B,C
"RTN","PSJBCMA",92,0)
 .. S S1="" F  S S1=$O(^PS(55,DFN,"IV",ON,"A",S1),-1) Q:'S1  S C=$G(^(S1,0)) S A=$P(C,U,2),B=$P(C,U,4) Q:A="UG"  D  I PSJ("SRC")]"" Q
"RTN","PSJBCMA",93,0)
 ... Q:A'="G"
"RTN","PSJBCMA",94,0)
 ... S PSJ("SRC")=$S(B["FLAGGED BY PHARM":"PHARMACIST",B["FLAGGED BY CPRS":"CPRS",1:"")
"RTN","PSJBCMA",95,0)
 ... S PSJ("COM")=$P(B," ",4,99)
"RTN","PSJBCMA",96,0)
 . S PSJ("OI")=+X
"RTN","PSJBCMA",97,0)
 . S X=$G(^PS(55,DFN,"IV",ON,2))
"RTN","PSJBCMA",98,0)
 . S PSJ("PREV")=$P(X,U,5) I PSJ("PREV")["V",(+PSJ("PREV")=+ON) S PSJ("PREV")=""
"RTN","PSJBCMA",99,0)
 . S PSJ("FOLLOW")=$P(X,U,6),PSJ("RFO")=$P(X,U,9) I PSJ("FOLLOW")["V",(+PSJ("FOLLOW")=+ON) S (PSJ("FOLLOW"),PSJ("RFO"))=""
"RTN","PSJBCMA",100,0)
 . S PSJ("SIOPI")=$S($P($G(^PS(55,DFN,"IV",+ON,3)),"^",2)&($P($G(^PS(55,DFN,"IV",+ON,3)),"^")'=""):"!",1:"")_$P($G(^(3)),"^")
"RTN","PSJBCMA",101,0)
 . N SCHD S SCHD=PSJ("SCHD")
"RTN","PSJBCMA",102,0)
 . S PSJ("STC")=$$ONE(DFN,ON_"V",SCHD,PSJ("STARTDT"),PSJ("STOPDT"))
"RTN","PSJBCMA",103,0)
 . I PSJ("STC")=""!(PSJ("STC")="C") S PSJ("STC")=$S(SCHD["PRN":"P",1:"C")
"RTN","PSJBCMA",104,0)
 . I PSJ("STC")="C" S PSJ("STC")=$S($$ONCALL(SCHD):"OC",1:"C")
"RTN","PSJBCMA",105,0)
 D TMP
"RTN","PSJBCMA",106,0)
 S CNT=0
"RTN","PSJBCMA",107,0)
 F X=0:0 S X=$O(@(F_ON_",""AD"","_X_")")) Q:'X  D
"RTN","PSJBCMA",108,0)
 . S ND=$G(@(F_ON_",""AD"","_X_",0)")),DN=$G(^PS(52.6,+ND,0))
"RTN","PSJBCMA",109,0)
 . S CNT=CNT+1,^TMP("PSJ",$J,PSJINX,850,CNT,0)=+ND_U_$P(DN,U)_U_$P(ND,U,2)_U_$P(ND,U,3)
"RTN","PSJBCMA",110,0)
 . ;add High Risk field to 6th piece of 850 (additv)             ;*279
"RTN","PSJBCMA",111,0)
 . S $P(^TMP("PSJ",$J,PSJINX,850,CNT,0),U,6)=$$HRFLG(+ND,"A")
"RTN","PSJBCMA",112,0)
 S:CNT ^TMP("PSJ",$J,PSJINX,850,0)=CNT,CNT=0
"RTN","PSJBCMA",113,0)
 F X=0:0 S X=$O(@(F_ON_",""SOL"","_X_")")) Q:'X  D
"RTN","PSJBCMA",114,0)
 . S ND=$G(@(F_ON_",""SOL"","_X_",0)")),DN=$G(^PS(52.7,+ND,0))
"RTN","PSJBCMA",115,0)
 . S CNT=CNT+1,^TMP("PSJ",$J,PSJINX,950,CNT,0)=+ND_U_$P(DN,U)_U_$P(ND,U,2)_U_$P(DN,U,4)
"RTN","PSJBCMA",116,0)
 . ;add High Risk field to 6th piece of 950 (sol)                ;*279
"RTN","PSJBCMA",117,0)
 . S $P(^TMP("PSJ",$J,PSJINX,950,CNT,0),U,6)=$$HRFLG(+ND,"S")
"RTN","PSJBCMA",118,0)
 S:CNT ^TMP("PSJ",$J,PSJINX,950,0)=CNT
"RTN","PSJBCMA",119,0)
 K PSJ
"RTN","PSJBCMA",120,0)
 S X1=0
"RTN","PSJBCMA",121,0)
 F  S X1=$O(^PS(55,DFN,"IVBCMA",X1)) Q:'X1  D
"RTN","PSJBCMA",122,0)
 . S XX=$G(^PS(55,DFN,"IVBCMA",X1,0)) Q:ON'=$P(XX,"^",2)  S PSJBCID=$P(XX,"^"),X2=0
"RTN","PSJBCMA",123,0)
 . F I=1:1 S X2=$O(^PS(55,DFN,"IVBCMA",X1,"AD",X2)) Q:'X2  D
"RTN","PSJBCMA",124,0)
 .. S X=^(X2,0),^TMP("PSJ",$J,PSJINX,800,PSJBCID,I)=+X_"^"_$S($D(^PS(52.6,+X,0)):$P(^(0),"^"),1:"*****")_"^"_$P(X,"^",2,99)
"RTN","PSJBCMA",125,0)
 .. ;add High Risk field to 6th piece of 800 (additv)            ;*279
"RTN","PSJBCMA",126,0)
 .. S $P(^TMP("PSJ",$J,PSJINX,800,PSJBCID,I),U,6)=$$HRFLG(+ND,"A")
"RTN","PSJBCMA",127,0)
 . I I>1 S ^TMP("PSJ",$J,PSJINX,800,PSJBCID,0)=I-1
"RTN","PSJBCMA",128,0)
 . S X2=0
"RTN","PSJBCMA",129,0)
 . F I=1:1 S X2=$O(^PS(55,DFN,"IVBCMA",X1,"SOL",X2)) Q:'X2  D
"RTN","PSJBCMA",130,0)
 .. S X=^(X2,0),^TMP("PSJ",$J,PSJINX,900,PSJBCID,I)=$P(X,"^")_"^"_$S($D(^PS(52.7,$P(X,"^"),0)):$P(^(0),"^"),1:"*****")_"^"_$P(X,"^",2,99)
"RTN","PSJBCMA",131,0)
 .. ;add High Risk field to 6th piece of 900 (sol)               ;*279
"RTN","PSJBCMA",132,0)
 .. S $P(^TMP("PSJ",$J,PSJINX,900,PSJBCID,I),U,6)=$$HRFLG(+X,"S")
"RTN","PSJBCMA",133,0)
 . I I>1 S ^TMP("PSJ",$J,PSJINX,900,PSJBCID,0)=I-1
"RTN","PSJBCMA",134,0)
 Q
"RTN","PSJBCMA",135,0)
UDPEND ;
"RTN","PSJBCMA",136,0)
 S X=$G(@(F_ON_",0)")) I $P(F,",")[53.1 S CLINIC=$G(@(F_ON_",""DSS"")")) Q:'$$CLINICS(CLINIC)
"RTN","PSJBCMA",137,0)
 I $P(F,",")[55 S CLINIC=$G(@(F_ON_",8)")) Q:'$$CLINICS(CLINIC)
"RTN","PSJBCMA",138,0)
 S PSJ("MR")=$P(X,U,3),PSJ("SM")=$P(X,U,5),PSJ("HSM")=$P(X,U,6)
"RTN","PSJBCMA",139,0)
 S PSJ("ST")=$P(X,U,7),PSJ("STATUS")=$P(X,U,9)
"RTN","PSJBCMA",140,0)
 S PSJ("CPRS")=$P(X,U,21),PSJ("PREV")=$P(X,U,25),PSJ("FOLLOW")=$P(X,U,26),PSJ("RFO")=$P(X,U,27)
"RTN","PSJBCMA",141,0)
 S:FON["U" PSJ("NGIVEN")=$P(X,U,22)
"RTN","PSJBCMA",142,0)
 S X=$G(@(F_ON_",.2)"))
"RTN","PSJBCMA",143,0)
 S PSJ("DO")=$P(X,U,2),PSJ("PRI")=$P(X,U,4),PSJ("FLG")=$P(X,U,7),PSJ("COM")="",PSJ("SRC")=""
"RTN","PSJBCMA",144,0)
 I PSJ("FLG") D
"RTN","PSJBCMA",145,0)
 . N S1,A,B,C
"RTN","PSJBCMA",146,0)
 . S S1="" F  S S1=$O(^PS(55,DFN,5,ON,9,S1),-1) Q:'S1  S C=$G(^(S1,0)) S A=$P(C,U,3),B=$P(C,U,4) Q:A=7010!(A=7030)  D  I PSJ("SRC")]"" Q
"RTN","PSJBCMA",147,0)
 .. Q:A'=7000&(A'=7020)
"RTN","PSJBCMA",148,0)
 .. S PSJ("SRC")=$S(A=7000:"PHARMACIST",A=7020:"CPRS",1:"")
"RTN","PSJBCMA",149,0)
 .. S PSJ("COM")=$G(@(F_ON_",13)"))
"RTN","PSJBCMA",150,0)
 S PSJ("OI")=+X
"RTN","PSJBCMA",151,0)
 S X=$G(@(F_ON_",2)"))
"RTN","PSJBCMA",152,0)
 S PSJ("SCHD")=$P(X,U),PSJ("STARTDT")=$P(X,U,2)
"RTN","PSJBCMA",153,0)
 S PSJ("STOPDT")=$P(X,U,4),PSJ("ADM")=$P(X,U,5)
"RTN","PSJBCMA",154,0)
 S X=$G(@(F_ON_",4)"))
"RTN","PSJBCMA",155,0)
 S PSJ("AUTO")=$P(X,U,11)
"RTN","PSJBCMA",156,0)
 ;naked reference on line below refers to  full reference created by indirect reference to F_ON, where F may refer to ^PS(53.1 or the IV or UD multiple ^PS(55
"RTN","PSJBCMA",157,0)
 S PSJ("SIOPI")=$S($P($G(@(F_ON_",6)")),"^",2)&($P($G(@(F_ON_",6)")),"^")'=""):"!",1:"")_$$ENSET($P($G(^(6)),"^"))
"RTN","PSJBCMA",158,0)
 D SIOPI
"RTN","PSJBCMA",159,0)
 S PSJ("STC")=PSJ("ST")
"RTN","PSJBCMA",160,0)
 I PSJ("ST")="R"!(PSJ("ST")="C") S PSJ("STC")=$S(PSJ("SCHD")["PRN":"P",$$ONCALL(PSJ("SCHD")):"OC",$$ONE(DFN,FON,PSJ("SCHD"))="O":"O",1:"C")
"RTN","PSJBCMA",161,0)
 Q
"RTN","PSJBCMA",162,0)
TMP ;Setup ^TMP that have common fields between IV and U/D
"RTN","PSJBCMA",163,0)
 N A,CLNAME,CLNAMPTR                                             ;*279
"RTN","PSJBCMA",164,0)
 S PSJINX=PSJINX+1
"RTN","PSJBCMA",165,0)
 S PSJ("OINAME")=$$OIDF^PSJLMUT1(+PSJ("OI")) I PSJ("OINAME")["NOT FOUND" S PSJ("OINAME")=""
"RTN","PSJBCMA",166,0)
 S PSJ("OIDF")=$$GET1^DIQ(50.7,+PSJ("OI"),.02)
"RTN","PSJBCMA",167,0)
 I PSJ("OINAME")="" S PSJ("OIDF")=""
"RTN","PSJBCMA",168,0)
 S A=$G(^PS(51.2,+PSJ("MR"),0)),PSJ("MRABB")=$P(A,U,3),PSJ("MRNM")=$P(A,U)
"RTN","PSJBCMA",169,0)
 S ^TMP("PSJ",$J,PSJINX,0)=DFN_U_+ON_U_FON_U_PSJ("PREV")_U_PSJ("FOLLOW")_U_$G(PSJ("IVTYPE"))_U_$G(PSJ("INSYR"))_U_$G(PSJ("CHEMO"))_U_PSJ("CPRS")_U_$G(PSJ("RFO"))
"RTN","PSJBCMA",170,0)
 ;add Clinic name & IEN ptr to TMP 0 node (pieces 11,12)          *279
"RTN","PSJBCMA",171,0)
 ;piece 11 determines if order is a CO or IM for BCMA VDL's       *279
"RTN","PSJBCMA",172,0)
 I +CLINIC,$$CLINIC(CLINIC) D           ;CL IEN & valid appt date *279
"RTN","PSJBCMA",173,0)
 . S CLNAMPTR=$O(^PS(53.46,"B",+CLINIC,""))
"RTN","PSJBCMA",174,0)
 . S CLNAME=$$GET1^DIQ(53.46,CLNAMPTR_",",.01)
"RTN","PSJBCMA",175,0)
 . S $P(^TMP("PSJ",$J,PSJINX,0),U,11)=CLNAME      ;CO ind, CO NAME
"RTN","PSJBCMA",176,0)
 . S $P(^TMP("PSJ",$J,PSJINX,0),U,12)=+CLINIC     ;IEN ptr to file 44
"RTN","PSJBCMA",177,0)
 ;
"RTN","PSJBCMA",178,0)
 S ^TMP("PSJ",$J,PSJINX,1)=PSJ("MRABB")_U_PSJ("STC")_U_$G(PSJ("SCHD"))_U_PSJ("STARTDT")_U_PSJ("STOPDT")_U_PSJ("ADM")_U_PSJ("STATUS")_U_$G(PSJ("NGIVEN"))_U_$G(PSJ("ST"))_U_$G(PSJ("AUTO"))
"RTN","PSJBCMA",179,0)
 S ^TMP("PSJ",$J,PSJINX,1,0)=$P(A,U,8)_U_PSJ("MRNM")_U_$P(A,U,9)_U_+PSJ("MR")   ;*267 append file 51.2 ien 
"RTN","PSJBCMA",180,0)
 S ^TMP("PSJ",$J,PSJINX,2)=PSJ("DO")_U_$P($G(PSJ("INFRATE")),"@")_U_$G(PSJ("SM"))_U_$G(PSJ("HSM"))
"RTN","PSJBCMA",181,0)
 S ^TMP("PSJ",$J,PSJINX,3)=PSJ("OI")_U_PSJ("OINAME")_U_PSJ("OIDF")
"RTN","PSJBCMA",182,0)
 S ^TMP("PSJ",$J,PSJINX,4)=PSJ("SIOPI")
"RTN","PSJBCMA",183,0)
 S A=$$SNDTSTA^PSJHL4A(PSJ("PRI"),PSJ("SCHD"))
"RTN","PSJBCMA",184,0)
 S ^TMP("PSJ",$J,PSJINX,5)=$S(A=1:0,1:1)_U_PSJ("FLG")_U_PSJ("SRC")_U_PSJ("COM")
"RTN","PSJBCMA",185,0)
 Q
"RTN","PSJBCMA",186,0)
SIOPI ; Use provider comments if order is pending and there is no SI
"RTN","PSJBCMA",187,0)
 NEW X,Y,Z
"RTN","PSJBCMA",188,0)
 I FON["P",(PSJ("SIOPI")=""),$O(^PS(53.1,+ON,12,0)) D
"RTN","PSJBCMA",189,0)
 . F X=0:0 S X=$O(^PS(53.1,+ON,12,X)) Q:'X  S Z=$G(^(X,0)) D
"RTN","PSJBCMA",190,0)
 .. S Y=$L(PSJ("SIOPI"))
"RTN","PSJBCMA",191,0)
 .. S:Y+$L(Z)'>179 PSJ("SIOPI")=PSJ("SIOPI")_Z_""
"RTN","PSJBCMA",192,0)
 . I Y+$L(Z)>179 S PSJ("SIOPI")="SEE PROVIDER COMMENTS"
"RTN","PSJBCMA",193,0)
 Q
"RTN","PSJBCMA",194,0)
ENSET(X) ; expands SPECIAL INSTRUCTIONS field contained in X into Y
"RTN","PSJBCMA",195,0)
 N X1,X2,Y S Y=""
"RTN","PSJBCMA",196,0)
 F X1=1:1:$L(X," ") S X2=$P(X," ",X1) I X2]"" S Y=Y_$S($L(X2)>30:X2,'$D(^PS(51,+$O(^PS(51,"B",X2,0)),0)):X2,$P(^(0),"^",2)]""&$P(^(0),"^",4):$P(^(0),"^",2),1:X2)_" "
"RTN","PSJBCMA",197,0)
 S Y=$E(Y,1,$L(Y)-1)
"RTN","PSJBCMA",198,0)
 Q Y
"RTN","PSJBCMA",199,0)
ONE(DFN,ORD,SCH,START,STOP) ;Determine if order is one-time, and return schedule type
"RTN","PSJBCMA",200,0)
 ; Input:  DFN - patient's IEN
"RTN","PSJBCMA",201,0)
 ;         ORD - order number
"RTN","PSJBCMA",202,0)
 ;         SCH - schedule text (required)
"RTN","PSJBCMA",203,0)
 ;         START - order start date (optional)
"RTN","PSJBCMA",204,0)
 ;         STOP - order stop date (optional)
"RTN","PSJBCMA",205,0)
 N X,ONEFRQ,TYP,T
"RTN","PSJBCMA",206,0)
 I $G(PSJ("PREV")),$G(PSJ("FOLLOW")) I +PSJ("PREV")=+PSJ("FOLLOW") S (PSJ("PREV"),PSJ("FOLLOW"))=""
"RTN","PSJBCMA",207,0)
 ; PSJ*5*190 One-Time PRN
"RTN","PSJBCMA",208,0)
 I $G(SCH)="",$G(DFN),$G(ORD) D
"RTN","PSJBCMA",209,0)
 .I ORD["U" S SCH=$P($G(^PS(55,DFN,5,+ORD,2)),"^")
"RTN","PSJBCMA",210,0)
 .I ORD["V" S SCH=$P($G(^PS(55,DFN,"IV",+ORD,0)),"^",9)
"RTN","PSJBCMA",211,0)
 I $G(SCH)]"",$$OTPRN^PSJBCMA3(SCH)="O" Q "O"
"RTN","PSJBCMA",212,0)
 I $G(DFN)]"",$G(ORD)]"",ORD["U",$P(^PS(55,DFN,5,+ORD,0),"^",7)'="R" Q $P(^PS(55,DFN,5,+ORD,0),"^",7)
"RTN","PSJBCMA",213,0)
 I $G(SCH)="" Q ""
"RTN","PSJBCMA",214,0)
 ; PSJ*5*113 Determine schedule type from ^PS(51.1, not from schedule name.
"RTN","PSJBCMA",215,0)
 I $D(^PS(51.1,"AC","PSJ",SCH)) S X=$O(^(SCH,"")) S X=$P(^PS(51.1,X,0),"^",5) Q $S(X="D":"C",1:X)
"RTN","PSJBCMA",216,0)
 I $G(START)]"",$G(STOP)]"",START=STOP Q "O"
"RTN","PSJBCMA",217,0)
 I $$DAY(SCH) Q "C"
"RTN","PSJBCMA",218,0)
 Q ""
"RTN","PSJBCMA",219,0)
 ;
"RTN","PSJBCMA",220,0)
CLINIC(CL) ; is a valid appointment date present?  1=yes 0 =no
"RTN","PSJBCMA",221,0)
 I $P(CL,"^",2)?7N!($P(CL,"^",2)?7N1".".N) Q 1
"RTN","PSJBCMA",222,0)
 Q 0
"RTN","PSJBCMA",223,0)
 ;
"RTN","PSJBCMA",224,0)
CLINICS(CL,IGNOSND) ;IM & CO order tests                                          *70
"RTN","PSJBCMA",225,0)
 ; Send IM orders always.  Send Clinic orders as CO order, if it
"RTN","PSJBCMA",226,0)
 ; meets below conditions, else send the order over as a IM order.
"RTN","PSJBCMA",227,0)
 ;
"RTN","PSJBCMA",228,0)
 ;   If CPRS sends the Clinic IEN and the appointment date when the
"RTN","PSJBCMA",229,0)
 ;   order is signed in CPRS, then this is a Clinic order and can be
"RTN","PSJBCMA",230,0)
 ;   sent to BCMA as a CO order, if it passes the 53.46 test as well.
"RTN","PSJBCMA",231,0)
 ;
"RTN","PSJBCMA",232,0)
 ; IGNOSND = Flag indicating the SEND TO BCMA parameter should be ignored.
"RTN","PSJBCMA",233,0)
 ; PSJHYBR = Hybrid order - contains reference to CLINIC, but no appointment date time
"RTN","PSJBCMA",234,0)
 ; Function Return values:   1 = Send order to BCMA
"RTN","PSJBCMA",235,0)
 ;                           0 = Do Not send order to BCMA
"RTN","PSJBCMA",236,0)
 ; * Orders with Clinic but no Appt should only be sent if patient is admitted or SEND TO BCMA flag set
"RTN","PSJBCMA",237,0)
 I '$G(CL)!$G(IGNOSND) Q 1
"RTN","PSJBCMA",238,0)
 N PSJVAIN4,X,PSJCNT,PSJSTRT,PSJSTOP,VAIP S PSJVAIN4=1 I $G(DFN) D
"RTN","PSJBCMA",239,0)
 .N VAIN,PSGP S PSGP=DFN D INP^VADPT I '$G(VAIN(4)) S PSJVAIN4=0 I $G(PSBRPT(".1"))'="" D  ;add code check for historical data when running BCMA
"RTN","PSJBCMA",240,0)
 ..S PSJSTOP=$P(PSBRPT(".1"),U,8),PSJSTRT=$P(PSBRPT(".1"),U,6) Q:'PSJSTOP!'(PSJSTRT)
"RTN","PSJBCMA",241,0)
 ..S PSJCNT=PSJSTRT F  Q:PSJCNT>PSJSTOP  S VAIP("D")=PSJCNT D IN5^VADPT S:+VAIP("3") PSJVAIN4=1 S PSJCNT=$$FMADD^XLFDT(PSJCNT,1) Q:$G(PSJVAIN4)  ;check to see if patient was admitted during time frame of report
"RTN","PSJBCMA",242,0)
 .I 'PSJVAIN4,$G(PSBREC(2)),$G(PSBREC(0))="ADMLKUP" S VAIP("D")=PSBREC(2) D IN5^VADPT S:+VAIP("3") PSJVAIN4=1 ;return patient data for Edit med log option if patient was admitted when med log entry was recorded
"RTN","PSJBCMA",243,0)
 .I 'PSJVAIN4,$G(PSBPRNDT) S VAIP("D")=$P(PSBSTRT,".") D IN5^VADPT S:+VAIP("3") PSJVAIN4=1
"RTN","PSJBCMA",244,0)
 I $G(PSJVAIN4) Q:'$$CLINIC(CL) 1                          ;no valid appt date
"RTN","PSJBCMA",245,0)
 N A
"RTN","PSJBCMA",246,0)
 S A=$O(^PS(53.46,"B",+CL,"")) Q:'A 0
"RTN","PSJBCMA",247,0)
 Q:'$D(^PS(53.46,"B",+CL)) 0
"RTN","PSJBCMA",248,0)
 Q $P(^PS(53.46,A,0),"^",4)                 ;send to bcma? flag
"RTN","PSJBCMA",249,0)
 ;
"RTN","PSJBCMA",250,0)
DAY(SCH) ;determine if this is a 'day of the week' schedule
"RTN","PSJBCMA",251,0)
 I $G(SCH)="" Q 0
"RTN","PSJBCMA",252,0)
 N D,DAY,DAYS,I,X
"RTN","PSJBCMA",253,0)
 S DAYS="SUNDAY,MONDAY,TUESDAY,WEDNESDAY,THURSDAY,FRIDAY,SATURDAY"
"RTN","PSJBCMA",254,0)
 F I=1:1 S D=$P(SCH,"-",I) Q:D=""  D  Q:X=0
"RTN","PSJBCMA",255,0)
 . S X=0 F J=1:1:7 S DAY=$P(DAYS,",",J) D  Q:X=1
"RTN","PSJBCMA",256,0)
 .. I D=$E(DAY,1,$L(D)) S X=1
"RTN","PSJBCMA",257,0)
 Q X
"RTN","PSJBCMA",258,0)
 ;
"RTN","PSJBCMA",259,0)
ONCALL(SCHD) ; Check if a schedule is type On Call (all "APPSJ" schedules with a given name must have the same schedule type)
"RTN","PSJBCMA",260,0)
 N NXT,SCHARR,OCCHK
"RTN","PSJBCMA",261,0)
 S OCCHK=0
"RTN","PSJBCMA",262,0)
 Q:$G(SCHD)="" OCCHK
"RTN","PSJBCMA",263,0)
 Q:'$D(^PS(51.1,"APPSJ",SCHD)) OCCHK
"RTN","PSJBCMA",264,0)
 S NXT=0 F  S NXT=$O(^PS(51.1,"APPSJ",SCHD,NXT)) Q:'NXT  S TYP=$P($G(^PS(51.1,+NXT,0)),"^",5) S:TYP]"" SCHARR(TYP)=""
"RTN","PSJBCMA",265,0)
 I '$D(SCHARR("OC")) S OCCHK=0 Q OCCHK
"RTN","PSJBCMA",266,0)
 I $O(SCHARR("OC"))]""!($O(SCHARR("OC"),-1)]"") S OCCHK=0 Q OCCHK
"RTN","PSJBCMA",267,0)
 I $D(SCHARR("OC")) S OCCHK=1
"RTN","PSJBCMA",268,0)
 Q OCCHK
"RTN","PSJBCMA",269,0)
 ;
"RTN","PSJBCMA",270,0)
HRFLG(IEN,ADDSOL) ;Get High Risk flag for this Orderable Item
"RTN","PSJBCMA",271,0)
 N OIIEN
"RTN","PSJBCMA",272,0)
 S:ADDSOL="A" OIIEN=+$$GET1^DIQ(52.6,IEN,15,"I")
"RTN","PSJBCMA",273,0)
 S:ADDSOL="S" OIIEN=+$$GET1^DIQ(52.7,IEN,9,"I")
"RTN","PSJBCMA",274,0)
 Q +$$GET1^DIQ(50.7,OIIEN,1,"I")
"VER")
8.0^22.0
"BLD",9634,6)
^260
**END**
**END**

