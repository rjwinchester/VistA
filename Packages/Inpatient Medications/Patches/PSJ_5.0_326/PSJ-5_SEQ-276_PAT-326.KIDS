Released PSJ*5*326 SEQ #276
Extracted from mail message
**KIDS**:PSJ*5.0*326^

**INSTALL NAME**
PSJ*5.0*326
"BLD",10075,0)
PSJ*5.0*326^INPATIENT MEDICATIONS^0^3151124^y
"BLD",10075,1,0)
^^2^2^3151124^
"BLD",10075,1,1,0)
1)       UNDEFINED EN2+4^PSJIBAG - Invalidated Labels Report
"BLD",10075,1,2,0)
2)       7 Day MAR not pulling all orders
"BLD",10075,4,0)
^9.64PA^^
"BLD",10075,6.3)
1
"BLD",10075,"KRN",0)
^9.67PA^779.2^20
"BLD",10075,"KRN",.4,0)
.4
"BLD",10075,"KRN",.401,0)
.401
"BLD",10075,"KRN",.402,0)
.402
"BLD",10075,"KRN",.403,0)
.403
"BLD",10075,"KRN",.5,0)
.5
"BLD",10075,"KRN",.84,0)
.84
"BLD",10075,"KRN",3.6,0)
3.6
"BLD",10075,"KRN",3.8,0)
3.8
"BLD",10075,"KRN",9.2,0)
9.2
"BLD",10075,"KRN",9.8,0)
9.8
"BLD",10075,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",10075,"KRN",9.8,"NM",1,0)
PSGMAR0^^0^B73287282
"BLD",10075,"KRN",9.8,"NM",2,0)
PSGMMAR0^^0^B70665522
"BLD",10075,"KRN",9.8,"NM",3,0)
PSGMMIV^^0^B49203096
"BLD",10075,"KRN",9.8,"NM",4,0)
PSJIBAG^^0^B44108809
"BLD",10075,"KRN",9.8,"NM","B","PSGMAR0",1)

"BLD",10075,"KRN",9.8,"NM","B","PSGMMAR0",2)

"BLD",10075,"KRN",9.8,"NM","B","PSGMMIV",3)

"BLD",10075,"KRN",9.8,"NM","B","PSJIBAG",4)

"BLD",10075,"KRN",19,0)
19
"BLD",10075,"KRN",19.1,0)
19.1
"BLD",10075,"KRN",101,0)
101
"BLD",10075,"KRN",409.61,0)
409.61
"BLD",10075,"KRN",771,0)
771
"BLD",10075,"KRN",779.2,0)
779.2
"BLD",10075,"KRN",870,0)
870
"BLD",10075,"KRN",8989.51,0)
8989.51
"BLD",10075,"KRN",8989.52,0)
8989.52
"BLD",10075,"KRN",8994,0)
8994
"BLD",10075,"KRN","B",.4,.4)

"BLD",10075,"KRN","B",.401,.401)

"BLD",10075,"KRN","B",.402,.402)

"BLD",10075,"KRN","B",.403,.403)

"BLD",10075,"KRN","B",.5,.5)

"BLD",10075,"KRN","B",.84,.84)

"BLD",10075,"KRN","B",3.6,3.6)

"BLD",10075,"KRN","B",3.8,3.8)

"BLD",10075,"KRN","B",9.2,9.2)

"BLD",10075,"KRN","B",9.8,9.8)

"BLD",10075,"KRN","B",19,19)

"BLD",10075,"KRN","B",19.1,19.1)

"BLD",10075,"KRN","B",101,101)

"BLD",10075,"KRN","B",409.61,409.61)

"BLD",10075,"KRN","B",771,771)

"BLD",10075,"KRN","B",779.2,779.2)

"BLD",10075,"KRN","B",870,870)

"BLD",10075,"KRN","B",8989.51,8989.51)

"BLD",10075,"KRN","B",8989.52,8989.52)

"BLD",10075,"KRN","B",8994,8994)

"BLD",10075,"QDEF")
^^^^NO^^^^^^NO
"BLD",10075,"QUES",0)
^9.62^^
"BLD",10075,"REQB",0)
^9.611^3^3
"BLD",10075,"REQB",1,0)
PSJ*5.0*196^2
"BLD",10075,"REQB",2,0)
PSJ*5.0*275^2
"BLD",10075,"REQB",3,0)
PSJ*5.0*279^2
"BLD",10075,"REQB","B","PSJ*5.0*196",1)

"BLD",10075,"REQB","B","PSJ*5.0*275",2)

"BLD",10075,"REQB","B","PSJ*5.0*279",3)

"MBREQ")
0
"PKG",471,-1)
1^1
"PKG",471,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",471,20,0)
^9.402P^^
"PKG",471,22,0)
^9.49I^1^1
"PKG",471,22,1,0)
5.0^2971215^2990325^66481
"PKG",471,22,1,"PAH",1,0)
326^3151124
"PKG",471,22,1,"PAH",1,1,0)
^^2^2^3151124
"PKG",471,22,1,"PAH",1,1,1,0)
1)       UNDEFINED EN2+4^PSJIBAG - Invalidated Labels Report
"PKG",471,22,1,"PAH",1,1,2,0)
2)       7 Day MAR not pulling all orders
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSGMAR0")
0^1^B73287282^B73008660
"RTN","PSGMAR0",1,0)
PSGMAR0 ;BIR/CML3-GATHERS INFO FOR 24 HOUR MAR ; 7/21/08 9:34am
"RTN","PSGMAR0",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**8,15,20,111,145,196,326**;16 DEC 97;Build 1
"RTN","PSGMAR0",3,0)
 ;
"RTN","PSGMAR0",4,0)
 ; Reference to ^PS(55 supported by DBIA #2191.
"RTN","PSGMAR0",5,0)
 ; Reference to ^PS(59.7 supported by DBIA #2181.
"RTN","PSGMAR0",6,0)
 ; Reference to CUR^FHORD7 supported by DBIA #2019.
"RTN","PSGMAR0",7,0)
ENQ ;
"RTN","PSGMAR0",8,0)
 S PSGMSORT=$P($G(^PS(59.7,1,26)),U,4)
"RTN","PSGMAR0",9,0)
 K ^TMP($J) D NOW^%DTC S PSGDT=%,PSGMARWN="",PSJACNWP=1 D @("G"_PSGSS) I $D(^TMP($J))<10 U IO W:$Y @IOF W !!,"(No data found for 24 hour MAR run.)"
"RTN","PSGMAR0",10,0)
 ;
"RTN","PSGMAR0",11,0)
 ;
"RTN","PSGMAR0",12,0)
DONE ;
"RTN","PSGMAR0",13,0)
 K PSGMFOR
"RTN","PSGMAR0",14,0)
 Q
"RTN","PSGMAR0",15,0)
 ;
"RTN","PSGMAR0",16,0)
GG ; find individual wards in this ward group
"RTN","PSGMAR0",17,0)
 F PSGMARWD=0:0 S PSGMARWD=$O(^PS(57.5,"AC",PSGMARWG,PSGMARWD)) Q:'PSGMARWD  D GW
"RTN","PSGMAR0",18,0)
 Q
"RTN","PSGMAR0",19,0)
 ;
"RTN","PSGMAR0",20,0)
GW ; find patients in each ward
"RTN","PSGMAR0",21,0)
 I $D(^DIC(42,PSGMARWD,0)),$P(^(0),"^")]"" S PSGMARWN=$P(^(0),"^")
"RTN","PSGMAR0",22,0)
 E  Q
"RTN","PSGMAR0",23,0)
 ;
"RTN","PSGMAR0",24,0)
 I 'PSGMARWG S PSGMARWG=+$O(^PS(57.5,"AB",PSGMARWD,0))
"RTN","PSGMAR0",25,0)
 F PSGP=0:0 S PSGP=$O(^DPT("CN",PSGMARWN,PSGP)) Q:'PSGP  D PSJAC2^PSJAC(1),DTSET:'$P(PSGMARDT,".",2) D GPI
"RTN","PSGMAR0",26,0)
 Q
"RTN","PSGMAR0",27,0)
 ;
"RTN","PSGMAR0",28,0)
GP ; go thru selected patients
"RTN","PSGMAR0",29,0)
 F PSGP=0:0 S PSGP=$O(PSGPAT(PSGP)) Q:'PSGP  D PSJAC2^PSJAC(1),DTSET:'$P(PSGMARDT,".",2) D GPI
"RTN","PSGMAR0",30,0)
 Q
"RTN","PSGMAR0",31,0)
 ;
"RTN","PSGMAR0",32,0)
GL S CL="" F  S CL=$O(^PS(57.8,"AD",CG,CL)) Q:CL=""  D GC
"RTN","PSGMAR0",33,0)
 Q
"RTN","PSGMAR0",34,0)
GC S PSGAPWDN=$S($D(^SC(CL,0)):$P(^(0),"^"),1:"")
"RTN","PSGMAR0",35,0)
 D DTSET:'$P(PSGMARDT,".",2)
"RTN","PSGMAR0",36,0)
 ;DEM 04/19/2006 - PSGCAD = User selected start date/time minus .0001
"RTN","PSGMAR0",37,0)
 S PSGCAD=PSGPLS-.0001
"RTN","PSGMAR0",38,0)
 F  S PSGCAD=$O(^PS(55,"AIVC",PSGCAD)) Q:PSGCAD=""  D  ;DEM 04/19/2006 - Index by order stop date/time.
"RTN","PSGMAR0",39,0)
 . S PSGP=0
"RTN","PSGMAR0",40,0)
 . F  S PSGP=$O(^PS(55,"AIVC",PSGCAD,CL,PSGP)) Q:PSGP=""  D PSJAC2^PSJAC(1),DTSET:'$P(PSGMARDT,".",2) D GPI  ;DEM 04/19/2006 - Removed S PSJPWDN="C!"_CL D GPI. Want to rollup patients non-clinic orders under patients location.
"RTN","PSGMAR0",41,0)
 ;DEM 04/19/2006 - PSGCAD = User selected start date/time minus .0001
"RTN","PSGMAR0",42,0)
 S PSGCAD=PSGPLS-.0001
"RTN","PSGMAR0",43,0)
 F  S PSGCAD=$O(^PS(55,"AUDC",PSGCAD)) Q:PSGCAD=""  D  ;DEM 04/19/2006 - Index by order stop date/time.
"RTN","PSGMAR0",44,0)
 . S PSGP=0
"RTN","PSGMAR0",45,0)
 . F  S PSGP=$O(^PS(55,"AUDC",PSGCAD,CL,PSGP)) Q:PSGP=""  D PSJAC2^PSJAC(1),DTSET:'$P(PSGMARDT,".",2) D GPI  ;DEM 04/19/2006 - Removed S PSJPWDN="C!"_CL D GPI. Want to rollup patients non-clinic orders under patients location.
"RTN","PSGMAR0",46,0)
 Q
"RTN","PSGMAR0",47,0)
GPI ; get patient info
"RTN","PSGMAR0",48,0)
 ; PSGTMALL=1(sort by all team), PSGTM=1(individual team(S) selected).
"RTN","PSGMAR0",49,0)
 S TM="" S:PSGSS="P"!(PSGSS="C")!(PSGSS="L") PSGMARWN=$S(PSJPWDN]"":PSJPWDN,1:"NOT FOUND")
"RTN","PSGMAR0",50,0)
 S:PSJPRB="" PSJPRB="zz"
"RTN","PSGMAR0",51,0)
 S:"GPCL"[PSGSS!('$G(PSGTM)&'$G(PSGTMALL)) TM="zz"
"RTN","PSGMAR0",52,0)
 S:$G(TM)="" TM=$S(PSJPRB="zz":0,1:+$O(^PS(57.7,"AWRT",PSGMARWD,PSJPRB,0))),TM=$S('TM:"zz",'$D(^PS(57.7,PSGMARWD,1,TM,0)):TM,$P(^(0),"^")]"":$P(^(0),"^"),1:TM)
"RTN","PSGMAR0",53,0)
 Q:'$G(PSGTMALL)&$G(PSGTM)&'$D(PSGTM(TM))
"RTN","PSGMAR0",54,0)
 S PPN=$E($P(PSGP(0),"^"),1,15)_"^"_PSGP
"RTN","PSGMAR0",55,0)
 N SUB1,SUB2 S:PSGRBPPN="P" SUB1=PPN,SUB2=PSJPRB S:PSGRBPPN="R" SUB1=PSJPRB,SUB2=PPN
"RTN","PSGMAR0",56,0)
 I PSGMARB=1 D SPN Q
"RTN","PSGMAR0",57,0)
 I PSGMTYPE[1 F XTYPE=2:1:6 D @XTYPE
"RTN","PSGMAR0",58,0)
 I PSGMTYPE'[1 F XTYPE=2:1:6 D:PSGMTYPE[XTYPE @XTYPE
"RTN","PSGMAR0",59,0)
 N PSGMAR24  ;DEM 04/19/2006 - 24 Hour MAR flag for call to shared routine ^PSGMMAR5 (24 Hour MAR Reports and 7 Day/14 Day MAR Reports both call ^PSGMMAR5).
"RTN","PSGMAR0",60,0)
 S PSGMAR24=1
"RTN","PSGMAR0",61,0)
 D ^PSGMMAR5
"RTN","PSGMAR0",62,0)
 K PSGMAR24
"RTN","PSGMAR0",63,0)
 D:$S(PSGSS["P"!(PSGSS="C")!(PSGSS="L"):$D(^TMP($J,PPN)),1:$D(^TMP($J,TM,PSGMARWN,SUB1,SUB2))) SPN
"RTN","PSGMAR0",64,0)
 Q
"RTN","PSGMAR0",65,0)
 ;
"RTN","PSGMAR0",66,0)
2 ;Loop thru UD orders
"RTN","PSGMAR0",67,0)
 ;DEM 04/19/2006
"RTN","PSGMAR0",68,0)
 ;       Location variable PSGMARWC added to correctly rollup orders
"RTN","PSGMAR0",69,0)
 ;       under location. The location can change if the UD order is
"RTN","PSGMAR0",70,0)
 ;       assoicated with a clinic location. If the location changes
"RTN","PSGMAR0",71,0)
 ;       under the aforementioned scenario, then PSGMARWC preserves
"RTN","PSGMAR0",72,0)
 ;       the original value and is used to restore location to it's
"RTN","PSGMAR0",73,0)
 ;       original value.
"RTN","PSGMAR0",74,0)
 ;
"RTN","PSGMAR0",75,0)
 N PSGMARWC
"RTN","PSGMAR0",76,0)
 S PSGMARWC=PSGMARWN    ;DEM 04/19/2006 - Preserve original value of patients location. If location is changed, then restore to original value after call to ORSET.
"RTN","PSGMAR0",77,0)
 F PST="C","O","OC","P","R" F PSGMARED=PSGPLS-.0001:0 S PSGMARED=$O(^PS(55,PSGP,5,"AU",PST,PSGMARED)) Q:'PSGMARED  F PSGMARO=0:0 S PSGMARO=$O(^PS(55,PSGP,5,"AU",PST,PSGMARED,PSGMARO)) Q:'PSGMARO  D ORSET S:PSGMARWN'=PSGMARWC PSGMARWN=PSGMARWC
"RTN","PSGMAR0",78,0)
 S PST="S" D ^PSGMIV
"RTN","PSGMAR0",79,0)
 Q
"RTN","PSGMAR0",80,0)
3 ;Loop thru IV orders that are Piggy back and Syringes types. 
"RTN","PSGMAR0",81,0)
 F PST="P","S" D ^PSGMIV
"RTN","PSGMAR0",82,0)
 Q
"RTN","PSGMAR0",83,0)
4 ;Loop thru IV orders(Additives).
"RTN","PSGMAR0",84,0)
 S PST="A" D ^PSGMIV
"RTN","PSGMAR0",85,0)
 Q
"RTN","PSGMAR0",86,0)
5 ;Loop thru IV orders(Hyperal).
"RTN","PSGMAR0",87,0)
 S PST="H" D ^PSGMIV
"RTN","PSGMAR0",88,0)
 Q
"RTN","PSGMAR0",89,0)
6 ;Loop thru IV order(Chemo).
"RTN","PSGMAR0",90,0)
 S PST="C" D ^PSGMIV
"RTN","PSGMAR0",91,0)
 Q
"RTN","PSGMAR0",92,0)
 ;
"RTN","PSGMAR0",93,0)
 ; PSGMFOR is set to bypass "fill on request" when call ^PSGPL0.
"RTN","PSGMAR0",94,0)
ORSET ; order record set
"RTN","PSGMAR0",95,0)
 S PSGMFOR="",ND2=$G(^PS(55,PSGP,5,PSGMARO,2)),(SD,X)=$P($P(ND2,"^",2),".") Q:X>PSGPLF  S FD=$P($P(ND2,"^",4),"."),T=$P(ND2,"^",6)
"RTN","PSGMAR0",96,0)
 ; 
"RTN","PSGMAR0",97,0)
 S A=$G(^PS(55,PSGP,5,PSGMARO,8)) I ($P(A,"^",1)]"")&($P(A,"^",2)]"") S PSGMARWN="C!"_$P(A,"^") I $G(SUB1)]"",$G(SUB2)]"",'$D(^TMP($J,TM,PSGMARWN,SUB1,SUB2)) D SPN
"RTN","PSGMAR0",98,0)
 ;
"RTN","PSGMAR0",99,0)
 NEW MARX D DRGDISP^PSJLMUT1(PSGP,+PSGMARO_"U",20,0,.MARX,1)
"RTN","PSGMAR0",100,0)
 S DRG=MARX(1)_U_PSGMARO_"U",QST=$S(PST="C"!(PST="O"):PST,PST="OC":"OA",PST="P":"OP",$P(ND2,"^")["PRN":"OR",1:"CR")
"RTN","PSGMAR0",101,0)
 ;
"RTN","PSGMAR0",102,0)
 S X="" I "OB"]QST,$P(ND2,U)'["@",$P(ND2,U,2)'>PSGPLS,$P(ND2,U,4)'<PSGPLF,$P(ND2,U,5),$P(ND2,U,6)<1441,$P(ND2,U,6)'="D" S X=$P(ND2,U,5),PSGPLC=1
"RTN","PSGMAR0",103,0)
 E  I "OB"]QST S PSGPLO=PSGMARO K PSGMAR D ^PSGPL0 S (Q,X)="" F QX=0:0 S Q=$O(PSGMAR(Q)) Q:Q=""  S X=X_$E("0",2-$L(Q))_Q_"-"
"RTN","PSGMAR0",104,0)
 S X=$S(QST["C"!(QST["O"):$P(ND2,"^",5),1:"")_"^"_X
"RTN","PSGMAR0",105,0)
 ;
"RTN","PSGMAR0",106,0)
 ;DAM 5-01-07 Add next line to include non-IV meds when printing by PATIENT and choosing to print "ALL MEDS"
"RTN","PSGMAR0",107,0)
 I PSGSS="P" S ^TMP($J,PPN,PSGMARWN,$S(+PSGMSORT:$E(QST,1),1:QST),DRG)=X Q
"RTN","PSGMAR0",108,0)
 ;
"RTN","PSGMAR0",109,0)
 ;DAM 5-01-07  Add check to see if user wants to include ward orders when printing by CLINIC GROUP
"RTN","PSGMAR0",110,0)
 I PSGSS="L" Q:((PSGINWDG="")&(PSGMARWN'["C!"))  S ^TMP($J,PPN,PSGMARWN,$S(+PSGMSORT:$E(QST,1),1:QST),DRG)=X Q
"RTN","PSGMAR0",111,0)
 ;
"RTN","PSGMAR0",112,0)
 ;DAM 5-01-07 Add check to see if user wants to include ward orders when printing by CLINIC  
"RTN","PSGMAR0",113,0)
 I PSGSS="C" Q:((PSGINWD="")&(PSGMARWN'["C!"))  I ((PSGMARWN[PSGCLNC)!(PSGMARWN'["C!")) D  Q
"RTN","PSGMAR0",114,0)
 . S ^TMP($J,PPN,PSGMARWN,$S(+PSGMSORT:$E(QST,1),1:QST),DRG)=X
"RTN","PSGMAR0",115,0)
 Q:(PSGSS="L")!(PSGSS="C")
"RTN","PSGMAR0",116,0)
 ;
"RTN","PSGMAR0",117,0)
 ; DAM 5-01-07 Add check to see if user wants to include clinic orders when printing by WARD GROUP
"RTN","PSGMAR0",118,0)
 I PSGSS="G" Q:((PSGINCLG="")&(PSGMARWN["C!"))  S ^TMP($J,TM,PSGMARWN,SUB1,SUB2,$S(+PSGMSORT:$E(QST,1),1:QST),DRG)=X
"RTN","PSGMAR0",119,0)
 ;
"RTN","PSGMAR0",120,0)
 ;DAM 5-01-07 Add check to see if user wants to include clinic orders when printing by WARD. 
"RTN","PSGMAR0",121,0)
 I (PSGSS="W") Q:((PSGINCL="")&(PSGMARWN["C!"))  S ^TMP($J,TM,PSGMARWN,SUB1,SUB2,$S(+PSGMSORT:$E(QST,1),1:QST),DRG)=X
"RTN","PSGMAR0",122,0)
 ;
"RTN","PSGMAR0",123,0)
 ;DAM 5-01-07  Add an XTMP global to swap location and patient name in the subscripts when printing MAR by WARD/PATIENT or WARD GROUP.
"RTN","PSGMAR0",124,0)
 N PSGDEM S PSGDEM=X    ;transfer contents of patient drug information contained in "X" above to  a new variable temporarily
"RTN","PSGMAR0",125,0)
 S PSGREP="PSGM_"_$J
"RTN","PSGMAR0",126,0)
 S X1=DT,X2=1 D C^%DTC K %,%H,%T
"RTN","PSGMAR0",127,0)
 S ^XTMP(PSGREP,0)=X_U_DT
"RTN","PSGMAR0",128,0)
 I PSGRBPPN="P",PSGSS="W" Q:((PSGINCL="")&(PSGMARWN["C!"))  D        ;Construct XTMP global for printing by WARD
"RTN","PSGMAR0",129,0)
 . S ^XTMP(PSGREP,TM,SUB1,PSGMARWN,SUB2,$S(+PSGMSORT:$E(QST,1),1:QST),DRG)=PSGDEM
"RTN","PSGMAR0",130,0)
 I PSGRBPPN="P",PSGSS="G" Q:((PSGINCLG="")&(PSGMARWN["C!"))  D       ;Construct XTMP global for printing by WARD GROUP
"RTN","PSGMAR0",131,0)
 . S ^XTMP(PSGREP,TM,SUB1,PSGMARWN,SUB2,$S(+PSGMSORT:$E(QST,1),1:QST),DRG)=PSGDEM
"RTN","PSGMAR0",132,0)
 S X=PSGDEM    ;transfer contents of patient drug information contained in PSGDEM back to X
"RTN","PSGMAR0",133,0)
 ;End DAM modifications 5-01-07
"RTN","PSGMAR0",134,0)
 Q
"RTN","PSGMAR0",135,0)
 ;
"RTN","PSGMAR0",136,0)
SPN ; set patient node
"RTN","PSGMAR0",137,0)
 D DIET
"RTN","PSGMAR0",138,0)
 S X=$P(PSGP(0),U)_U_$E($P(PSJPDOB,U,2),1,10)_";"_PSJPAGE_U_VA("PID")_U_PSJPDX_U_PSJPWT_U_PSJPWTD_U_PSJPHT_U_PSJPHTD_U_$P(PSJPAD,U,2)_U_$P(PSJPTD,U,2)_U_$P(PSJPSEX,U,2)_U_PSJPWD_U_PSGPLS_U_PSGPLF_U_PSGMARSD_U_PSGMARFD_U_PSGMARSP_U_PSGMARFP
"RTN","PSGMAR0",139,0)
 ;GMZ:PSJ*5*196;Set diet info for each patient.
"RTN","PSGMAR0",140,0)
 I PSGSS="P"!(PSGSS="C")!(PSGSS="L") S ^TMP($J,PPN)=X_U_PSGMARWN_U_PSJPRB_U_$G(PSJDIET) Q
"RTN","PSGMAR0",141,0)
 ;
"RTN","PSGMAR0",142,0)
 ;DAM 5-01-07  Add check to see if user wants to include clinic orders when printing by ward. 
"RTN","PSGMAR0",143,0)
 I PSGSS="W" Q:((PSGINCL="")&(PSGMARWN["C!"))  S ^TMP($J,TM,PSGMARWN,SUB1,SUB2)=X_U_U_U_$G(PSJDIET)
"RTN","PSGMAR0",144,0)
 ;
"RTN","PSGMAR0",145,0)
 ;DAM 5-01-07 Add check to see if user wants to include clinic orders when printing by ward group.
"RTN","PSGMAR0",146,0)
 I PSGSS="G" Q:((PSGINCLG="")&(PSGMARWN["C!"))  S ^TMP($J,TM,PSGMARWN,SUB1,SUB2)=X_U_U_U_$G(PSJDIET)
"RTN","PSGMAR0",147,0)
 ;
"RTN","PSGMAR0",148,0)
 ;DAM 5-01-07  Add an XTMP global to reverse location and patient name in the subscripts when printing MAR by WARD/PATIENT or WARD GROUP.
"RTN","PSGMAR0",149,0)
 N PSGDEM S PSGDEM=X_U_U_U_$G(PSJDIET) ;transfer contents of patient demographics contained in "X" above to  a new variable temporarily
"RTN","PSGMAR0",150,0)
 S PSGREP="PSGM_"_$J
"RTN","PSGMAR0",151,0)
 S X1=DT,X2=1 D C^%DTC K %,%H,%T
"RTN","PSGMAR0",152,0)
 S ^XTMP(PSGREP,0)=X_U_DT
"RTN","PSGMAR0",153,0)
 I PSGRBPPN="P",PSGSS="W" Q:((PSGINCL="")&(PSGMARWN["C!"))  D    ;Construct XTMP global for printing by WARD
"RTN","PSGMAR0",154,0)
 . S ^XTMP(PSGREP,TM,SUB1,PSGMARWN,SUB2)=PSGDEM
"RTN","PSGMAR0",155,0)
 I PSGRBPPN="P",PSGSS="G" Q:((PSGINCLG="")&(PSGMARWN["C!"))  D   ;Construct XTMP global for printing by WARD GROUP
"RTN","PSGMAR0",156,0)
 . S ^XTMP(PSGREP,TM,SUB1,PSGMARWN,SUB2)=PSGDEM
"RTN","PSGMAR0",157,0)
 S X=PSGDEM    ;transfer contents of patient demographics contained in PSGDEM back to X
"RTN","PSGMAR0",158,0)
 ;End DAM modifications 3-7-07
"RTN","PSGMAR0",159,0)
 Q
"RTN","PSGMAR0",160,0)
DIET ; Include abbr. diet label if indicated in the Site par.
"RTN","PSGMAR0",161,0)
 NEW ADM,DFN,PSJMPAR K PSJDIET
"RTN","PSGMAR0",162,0)
 S PSJMPAR=$G(^PS(59.7,1,26))
"RTN","PSGMAR0",163,0)
 Q:'$P(PSJMPAR,U,3)
"RTN","PSGMAR0",164,0)
 S DFN=PSGP,ADM=$G(^DPT("CN",PSGMARWN,DFN))
"RTN","PSGMAR0",165,0)
 I +ADM D CUR^FHORD7 S PSJDIET=Y
"RTN","PSGMAR0",166,0)
 Q
"RTN","PSGMAR0",167,0)
 ;
"RTN","PSGMAR0",168,0)
DTSET ;
"RTN","PSGMAR0",169,0)
 S (PSGPLS,PSGPLF)=PSGMARDT
"RTN","PSGMAR0",170,0)
 S PSJSYSW=$O(^PS(59.6,"B",+$G(PSJPWD),0))
"RTN","PSGMAR0",171,0)
 S:PSJSYSW PSJSYSW0=$G(^PS(59.6,PSJSYSW,0))
"RTN","PSGMAR0",172,0)
 I $D(PSJSYSW0),$P(PSJSYSW0,"^",8) S ST=$P(PSJSYSW0,"^",8),FT=$P(PSJSYSW0,"^",9)
"RTN","PSGMAR0",173,0)
 E  S ST="0001",FT=24
"RTN","PSGMAR0",174,0)
SET S PSGMARSD=$E(ST,1,2),PSGMARFD=$E(FT,1,2) S:'PSGMARSD PSGMARSD="01" S PSGMARFD=$S(+PSGMARSD=1:24,PSGMARSD=PSGMARFD:PSGMARSD-1,1:PSGMARFD) S:$L(PSGMARFD)<2 PSGMARFD=0_PSGMARFD
"RTN","PSGMAR0",175,0)
 I ST>1 S X1=$P(PSGPLF,"."),X2=1 D C^%DTC S PSGPLF=X
"RTN","PSGMAR0",176,0)
 S PSGPLS=+(PSGPLS_"."_ST),PSGPLF=+(PSGPLF_"."_FT)
"RTN","PSGMAR0",177,0)
 S PSGMARSP=$$ENDTC2^PSGMI(PSGPLS),PSGMARFP=$$ENDTC2^PSGMI(PSGPLF)
"RTN","PSGMAR0",178,0)
 Q
"RTN","PSGMMAR0")
0^2^B70665522^B70416578
"RTN","PSGMMAR0",1,0)
PSGMMAR0 ;BIR/CML3-GATHERS INFO FOR MD CMR ; 8/14/08 12:08pm
"RTN","PSGMMAR0",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**8,15,20,111,145,196,326**;16 DEC 97;Build 1
"RTN","PSGMMAR0",3,0)
 ;
"RTN","PSGMMAR0",4,0)
 ; Reference to ^PS(55 supported by DBIA #2191.
"RTN","PSGMMAR0",5,0)
 ; Reference to ^PS(59.7 supported by DBIA #2181.
"RTN","PSGMMAR0",6,0)
 ;
"RTN","PSGMMAR0",7,0)
ENQ ; start sort; where queue comes in at
"RTN","PSGMMAR0",8,0)
 N SUB1,SUB2 S (SUB1,SUB2)=""
"RTN","PSGMMAR0",9,0)
 S PSGMSORT=$P($G(^PS(59.7,1,26)),U,4)
"RTN","PSGMMAR0",10,0)
 K PSGD S X=$P(PSGMARSD,"."),PSGDW="" F Q=0:1:PSGMARDF-1 S X1=$P(PSGMARSD,"."),X2=Q D:Q C^%DTC S PSGD(X)=$E(X,4,5)_"/"_$E(X,6,7),HX=X D DW^%DTC S $P(PSGD(HX),U,2)=X
"RTN","PSGMMAR0",11,0)
 K ^TMP($J) D NOW^%DTC S PSGDT=%,PSGMARWN="",PSJACNWP=1 D @("G"_PSGSS)
"RTN","PSGMMAR0",12,0)
 ;* K ^TMP($J),PSJACNWP D NOW^%DTC S PSGDT=%,PSGMARWN="" D @("G"_PSGSS)
"RTN","PSGMMAR0",13,0)
 I $D(^TMP($J))<10 U IO W:$Y @IOF W !!,"(No data found for "_PSGMARDF_" day MAR run.)"
"RTN","PSGMMAR0",14,0)
 ;
"RTN","PSGMMAR0",15,0)
DONE ;
"RTN","PSGMMAR0",16,0)
 Q
"RTN","PSGMMAR0",17,0)
 ;
"RTN","PSGMMAR0",18,0)
GG ; find individual wards in this ward group
"RTN","PSGMMAR0",19,0)
 S ^TMP($J)=PSGMARWG F PSGMARWD=0:0 S PSGMARWD=$O(^PS(57.5,"AC",PSGMARWG,PSGMARWD)) Q:'PSGMARWD  D GW
"RTN","PSGMMAR0",20,0)
 Q
"RTN","PSGMMAR0",21,0)
 ;
"RTN","PSGMMAR0",22,0)
GW ; find patients in each ward
"RTN","PSGMMAR0",23,0)
 I $D(^DIC(42,PSGMARWD,0)),$P(^(0),U)]"" S PSGMARWN=$P(^(0),U)
"RTN","PSGMMAR0",24,0)
 E  Q
"RTN","PSGMMAR0",25,0)
 I 'PSGMARWG S PSGMARWG=+$O(^PS(57.5,"AB",PSGMARWD,0))
"RTN","PSGMMAR0",26,0)
 I $D(^TMP($J))[0,PSGMARWG S ^($J)=PSGMARWG
"RTN","PSGMMAR0",27,0)
 F PSGP=0:0 S PSGP=$O(^DPT("CN",PSGMARWN,PSGP)) Q:'PSGP  D PSJAC2^PSJAC(1) I PSGMARB!$O(^PS(55,PSGP,5,"AUS",PSGMARSD))!$O(^PS(55,PSGP,"IV","AIS",PSGMARSD)) D GPI
"RTN","PSGMMAR0",28,0)
 Q
"RTN","PSGMMAR0",29,0)
 ;
"RTN","PSGMMAR0",30,0)
GP ; go thru selected patients
"RTN","PSGMMAR0",31,0)
 F PSGP=0:0 S PSGP=$O(PSGPAT(PSGP)) Q:'PSGP  D PSJAC2^PSJAC(1) I PSGMARB!$O(^PS(55,PSGP,5,"AUS",PSGMARSD))!$O(^PS(55,PSGP,"IV","AIS",PSGMARSD)) D GPI
"RTN","PSGMMAR0",32,0)
 Q
"RTN","PSGMMAR0",33,0)
 ;
"RTN","PSGMMAR0",34,0)
GL S CL="" F  S CL=$O(^PS(57.8,"AD",CG,CL)) Q:CL=""  D GC
"RTN","PSGMMAR0",35,0)
 Q
"RTN","PSGMMAR0",36,0)
GC S PSGAPWDN=$S($D(^SC(CL,0)):$P(^(0),"^"),1:"")
"RTN","PSGMMAR0",37,0)
 S PSGP="" F  S PSGP=$O(^PS(53.1,"AD",CL,PSGP)) Q:PSGP=""  D PSJAC2^PSJAC(1)
"RTN","PSGMMAR0",38,0)
 S PSGCAD=PSGMARSD
"RTN","PSGMMAR0",39,0)
 F  S PSGCAD=$O(^PS(55,"AIVC",PSGCAD)) Q:PSGCAD=""  D
"RTN","PSGMMAR0",40,0)
 . S PSGP=0
"RTN","PSGMMAR0",41,0)
 . F  S PSGP=$O(^PS(55,"AIVC",PSGCAD,CL,PSGP)) Q:PSGP=""  D PSJAC2^PSJAC(1) D GPI
"RTN","PSGMMAR0",42,0)
 S PSGCAD=PSGMARSD
"RTN","PSGMMAR0",43,0)
 F  S PSGCAD=$O(^PS(55,"AUDC",PSGCAD)) Q:PSGCAD=""  D
"RTN","PSGMMAR0",44,0)
 . S PSGP=0
"RTN","PSGMMAR0",45,0)
 . F  S PSGP=$O(^PS(55,"AUDC",PSGCAD,CL,PSGP)) Q:PSGP=""  D PSJAC2^PSJAC(1) D GPI
"RTN","PSGMMAR0",46,0)
 Q
"RTN","PSGMMAR0",47,0)
 ;
"RTN","PSGMMAR0",48,0)
GPI ; get patient info
"RTN","PSGMMAR0",49,0)
 ; PSGTMALL=1(sort by all team), PSGTM=1(individual team(S) selected).
"RTN","PSGMMAR0",50,0)
 S TM="" S:PSGSS="P"!(PSGSS="C")!(PSGSS="L") PSGMARWN=$S(PSJPWDN]"":PSJPWDN,1:"NOT FOUND")
"RTN","PSGMMAR0",51,0)
 S:PSJPRB="" PSJPRB="zz"
"RTN","PSGMMAR0",52,0)
 S:"GPCL"[PSGSS!('$G(PSGTM)&'$G(PSGTMALL)) TM="zz"
"RTN","PSGMMAR0",53,0)
 S:$G(TM)="" TM=$S(PSJPRB="zz":0,1:+$O(^PS(57.7,"AWRT",PSGMARWD,PSJPRB,0))),TM=$S('TM:"zz",'$D(^PS(57.7,PSGMARWD,1,TM,0)):TM,$P(^(0),U)]"":$P(^(0),U),1:TM)
"RTN","PSGMMAR0",54,0)
 Q:'$G(PSGTMALL)&$G(PSGTM)&'$D(PSGTM(TM))  ; Elimin. none selected team
"RTN","PSGMMAR0",55,0)
 S PPN=$E($P(PSGP(0),U),1,15)_U_PSGP
"RTN","PSGMMAR0",56,0)
 S:PSGRBPPN="P" SUB1=PPN,SUB2=PSJPRB S:PSGRBPPN="R" SUB1=PSJPRB,SUB2=PPN
"RTN","PSGMMAR0",57,0)
 I PSGMARB=1 D SPN Q
"RTN","PSGMMAR0",58,0)
 I PSGMTYPE[1 F XTYPE=2:1:6 D @XTYPE
"RTN","PSGMMAR0",59,0)
 I PSGMTYPE'[1 F XTYPE=2:1:6 D:PSGMTYPE[XTYPE @XTYPE
"RTN","PSGMMAR0",60,0)
 D ^PSGMMAR5
"RTN","PSGMMAR0",61,0)
 D:$S(PSGSS["P"!(PSGSS="L")!(PSGSS="C"):$D(^TMP($J,PPN)),1:$D(^TMP($J,TM,PSGMARWN,SUB1,SUB2))) SPN
"RTN","PSGMMAR0",62,0)
 I $D(^TMP($J))'>10,(PSGMARB=3) D SPN
"RTN","PSGMMAR0",63,0)
 Q
"RTN","PSGMMAR0",64,0)
 ;
"RTN","PSGMMAR0",65,0)
2 ;Loop thru UD orders
"RTN","PSGMMAR0",66,0)
 ;DEM 04/19/2006
"RTN","PSGMMAR0",67,0)
 ;       Location variable PSGMARWC added to correctly rollup orders
"RTN","PSGMMAR0",68,0)
 ;       under location. The location can change if the UD order is
"RTN","PSGMMAR0",69,0)
 ;       assoicated with a clinic location. If the location changes
"RTN","PSGMMAR0",70,0)
 ;       under the aforementioned scenario, then PSGMARWC preserves
"RTN","PSGMMAR0",71,0)
 ;       the original value and is used to restore location to it's
"RTN","PSGMMAR0",72,0)
 ;       original value.
"RTN","PSGMMAR0",73,0)
 ;
"RTN","PSGMMAR0",74,0)
 N PSGMARWC
"RTN","PSGMMAR0",75,0)
 S PSGMARWC=PSGMARWN  ;DEM 04/19/2006 - Preserve original value of patients location. If location is changed, then restore to original value after call to OS.
"RTN","PSGMMAR0",76,0)
 I PSGMARS'=2 F PST="C" F PSGMARED=PSGMARSD:0 S PSGMARED=$O(^PS(55,PSGP,5,"AU",PST,PSGMARED)) Q:'PSGMARED  F ON=0:0 S ON=$O(^PS(55,PSGP,5,"AU",PST,PSGMARED,ON)) Q:'ON  D OS S:PSGMARWN'=PSGMARWC PSGMARWN=PSGMARWC
"RTN","PSGMMAR0",77,0)
 I PSGMARS'=1 F PST="O","OC","P" F PSGMARED=PSGMARSD:0 S PSGMARED=$O(^PS(55,PSGP,5,"AU",PST,PSGMARED)) Q:'PSGMARED  F ON=0:0 S ON=$O(^PS(55,PSGP,5,"AU",PST,PSGMARED,ON)) Q:'ON  D OS S:PSGMARWN'=PSGMARWC PSGMARWN=PSGMARWC
"RTN","PSGMMAR0",78,0)
 S PST="R" F PSGMARED=PSGMARSD:0 S PSGMARED=$O(^PS(55,PSGP,5,"AU",PST,PSGMARED)) Q:'PSGMARED  F ON=0:0 S ON=$O(^PS(55,PSGP,5,"AU",PST,PSGMARED,ON)) Q:'ON  D OS S:PSGMARWN'=PSGMARWC PSGMARWN=PSGMARWC
"RTN","PSGMMAR0",79,0)
 S PST="S" D ^PSGMMIV
"RTN","PSGMMAR0",80,0)
 Q
"RTN","PSGMMAR0",81,0)
3 ;Loop thru IV orders that are Piggy back and Syringes types.
"RTN","PSGMMAR0",82,0)
 F PST="P","S" D ^PSGMMIV
"RTN","PSGMMAR0",83,0)
 Q
"RTN","PSGMMAR0",84,0)
4 ;Loop thru IV orders(Admixtures).
"RTN","PSGMMAR0",85,0)
 S PST="A" D ^PSGMMIV
"RTN","PSGMMAR0",86,0)
 Q
"RTN","PSGMMAR0",87,0)
5 ;Loop thru IV orders(Hyperal).
"RTN","PSGMMAR0",88,0)
 S PST="H" D ^PSGMMIV
"RTN","PSGMMAR0",89,0)
 Q
"RTN","PSGMMAR0",90,0)
6 ;Loop thru IV order(Chemo).
"RTN","PSGMMAR0",91,0)
 S PST="C" D ^PSGMMIV
"RTN","PSGMMAR0",92,0)
 Q
"RTN","PSGMMAR0",93,0)
 ;
"RTN","PSGMMAR0",94,0)
OS ; order record set
"RTN","PSGMMAR0",95,0)
 N A
"RTN","PSGMMAR0",96,0)
 S ND2=$G(^PS(55,PSGP,5,ON,2)),SD=$P(ND2,U,2) I $S($P(SD,".")>PSGMARFD:1,PSGMARS=1:$P(ND2,U)["PRN",1:0) Q
"RTN","PSGMMAR0",97,0)
 S A=$G(^PS(55,PSGP,5,ON,8)) I ($P(A,"^",1)]"")&($P(A,"^",2)]"") S PSGMARWN="C!"_$P(A,"^") I $G(SUB1)]"",$G(SUB2)]"",'$D(^TMP($J,TM,PSGMARWN,SUB1,SUB2)) D SPN
"RTN","PSGMMAR0",98,0)
 S FD=$P($P(ND2,U,4),"."),T=$P(ND2,U,6)
"RTN","PSGMMAR0",99,0)
 NEW MARX D DRGDISP^PSJLMUT1(PSGP,+ON_"U",20,0,.MARX,1) S DRG=MARX(1)_$E(SD,2,7)_U_+ON_"U"
"RTN","PSGMMAR0",100,0)
 S QST=$S(PST="C"!(PST="O"):PST,PST="OC":"OA",PST="P":"OP",$P(ND2,U)["PRN":"OR",1:"CR")
"RTN","PSGMMAR0",101,0)
 S QQ="" I QST["C" D DTS($P(ND2,U)) S SD=$P(SD,"."),QQ="" F X=0:0 S X=$O(PSGD(X)) Q:'X  S QQ=QQ_$S(X<SD:"",X>FD:"",'S:$P(PSGD(X),U),$D(S(X)):$P(PSGD(X),U),1:"")
"RTN","PSGMMAR0",102,0)
 I $P(ND2,U,6)="D",$P(ND2,U,5)="" S $P(ND2,U,5)=$E($P($P(ND2,U,2),".",2)_"0000",1,4)
"RTN","PSGMMAR0",103,0)
 S X=$S(QST["C"!(QST="O"):$P(ND2,U,5),1:"")_U_QQ
"RTN","PSGMMAR0",104,0)
 ;
"RTN","PSGMMAR0",105,0)
 ;
"RTN","PSGMMAR0",106,0)
 ;DAM 5-01-07 Add next line to include non-IV meds when printing by PATIENT and choosing to print "ALL MEDS"
"RTN","PSGMMAR0",107,0)
 I PSGSS="P" S ^TMP($J,PPN,PSGMARWN,$S(+PSGMSORT:$E(QST,1),1:QST),DRG)=X Q
"RTN","PSGMMAR0",108,0)
 ;
"RTN","PSGMMAR0",109,0)
 ;DAM 5-01-07  Add check to see if user wants to include ward orders when printing by CLINIC GROUP
"RTN","PSGMMAR0",110,0)
 I PSGSS="L" Q:((PSGINWDG="")&(PSGMARWN'["C!"))  S ^TMP($J,PPN,PSGMARWN,$S(+PSGMSORT:$E(QST,1),1:QST),DRG)=X Q
"RTN","PSGMMAR0",111,0)
 ;
"RTN","PSGMMAR0",112,0)
 ;DAM 5-01-07 Add check to see if user wants to include ward orders when printing by CLINIC
"RTN","PSGMMAR0",113,0)
 I PSGSS="C" Q:((PSGINWD="")&(PSGMARWN'["C!"))  I ((PSGMARWN[PSGCLNC)!(PSGMARWN'["C!")) D  Q
"RTN","PSGMMAR0",114,0)
 . S ^TMP($J,PPN,PSGMARWN,$S(+PSGMSORT:$E(QST,1),1:QST),DRG)=X
"RTN","PSGMMAR0",115,0)
 ;
"RTN","PSGMMAR0",116,0)
 Q:(PSGSS="L")!(PSGSS="C")
"RTN","PSGMMAR0",117,0)
 ;
"RTN","PSGMMAR0",118,0)
 ;DAM 5-01-07 Add check to see if user wants to include clinic orders when printing by WARD GROUP
"RTN","PSGMMAR0",119,0)
 I PSGSS="G" Q:((PSGINCLG="")&(PSGMARWN["C!"))  S ^TMP($J,TM,PSGMARWN,SUB1,SUB2,$S(+PSGMSORT:$E(QST,1),1:QST),DRG)=X
"RTN","PSGMMAR0",120,0)
 ;
"RTN","PSGMMAR0",121,0)
 ;DAM 5-01-07 Add check to see if user wants to include clinic orders when printing by WARD.
"RTN","PSGMMAR0",122,0)
 I (PSGSS="W") Q:((PSGINCL="")&(PSGMARWN["C!"))  S ^TMP($J,TM,PSGMARWN,SUB1,SUB2,$S(+PSGMSORT:$E(QST,1),1:QST),DRG)=X
"RTN","PSGMMAR0",123,0)
 ;
"RTN","PSGMMAR0",124,0)
 ;DAM 5-01-07  Add an XTMP global to swap location and patient name in the subscripts when printing MAR by WARD/PATIENT or WARD GROUP.
"RTN","PSGMMAR0",125,0)
 N PSGDEM S PSGDEM=X    ;transfer contents of patient drug information contained in "X" above to  a new variable temporarily
"RTN","PSGMMAR0",126,0)
 S PSGREP="PSGM_"_$J
"RTN","PSGMMAR0",127,0)
 S X1=DT,X2=1 D C^%DTC K %,%H,%T
"RTN","PSGMMAR0",128,0)
 S ^XTMP(PSGREP,0)=X_U_DT
"RTN","PSGMMAR0",129,0)
 I PSGRBPPN="P",PSGSS="W" Q:((PSGINCL="")&(PSGMARWN["C!"))  D        ;Construct XTMP global for printing by WARD
"RTN","PSGMMAR0",130,0)
 . S ^XTMP(PSGREP,TM,SUB1,PSGMARWN,SUB2,$S(+PSGMSORT:$E(QST,1),1:QST),DRG)=PSGDEM
"RTN","PSGMMAR0",131,0)
 I PSGRBPPN="P",PSGSS="G" Q:((PSGINCLG="")&(PSGMARWN["C!"))  D       ;Construct XTMP global for printing by WARD GROUP
"RTN","PSGMMAR0",132,0)
 . S ^XTMP(PSGREP,TM,SUB1,PSGMARWN,SUB2,$S(+PSGMSORT:$E(QST,1),1:QST),DRG)=PSGDEM
"RTN","PSGMMAR0",133,0)
 S X=PSGDEM      ;transfer contents of patient drug information contained in PSGDEM back to X
"RTN","PSGMMAR0",134,0)
 ;End DAM modifications 5-01-07
"RTN","PSGMMAR0",135,0)
 Q
"RTN","PSGMMAR0",136,0)
 ;
"RTN","PSGMMAR0",137,0)
DTS(SCHEDULE) ;
"RTN","PSGMMAR0",138,0)
 K S S S=0 I SCHEDULE["@"!(T="D") S WD=$S(SCHEDULE["@":$P(SCHEDULE,"@"),1:SCHEDULE) F Q=0:0 S Q=$O(PSGD(Q)) Q:'Q  F QQ=1:1:$L(WD,"-") I $P($P(PSGD(Q),U,2),$P(WD,"-",QQ))="" S S(Q)="",S=S+1 Q
"RTN","PSGMMAR0",139,0)
 Q:SCHEDULE["@"!(T="D")  Q:T'>1440  S WD=$P(PSGMARSD,".") I '(T#1440) S (SD,X)=$P(SD,"."),PSGT=T\1440 F QQ=0:1 S X1=SD,X2=QQ*PSGT D:X2 C^%DTC I X'<WD S S=S+1 Q:X>PSGMARFD  Q:X>FD  S S(X)=""
"RTN","PSGMMAR0",140,0)
 K PSGT Q:'(T#1440)  S PSGT=T,X1=PSGMARSD,(ST,X2)=SD I PSGMARSD>SD D ^%DTC I X>1 S ST=$$EN^PSGCT(SD,X-1*1440\T*T)
"RTN","PSGMMAR0",141,0)
 S (PSGS,X)=ST F PSGX=0:1 S AM=PSGT*PSGX,ST=PSGS S:AM X=$$EN^PSGCT(ST,AM) S X=$P(X,".") I X'<WD Q:X>PSGMARFD  Q:X>FD  I '$D(S(X)) S S=S+1,S(X)=""
"RTN","PSGMMAR0",142,0)
 K AM,ST,PSGS,PSGT,PSGX Q
"RTN","PSGMMAR0",143,0)
 ;
"RTN","PSGMMAR0",144,0)
SPN ; set patient node
"RTN","PSGMMAR0",145,0)
 D DIET^PSGMAR0
"RTN","PSGMMAR0",146,0)
 S X=$P(PSGP(0),U)_U_$E($P(PSJPDOB,U,2),1,10)_";"_PSJPAGE_U_VA("PID")_U_PSJPDX_U_PSJPWT_U_PSJPWTD_U_PSJPHT_U_PSJPHTD_U_$P(PSJPAD,U,2)_U_$P(PSJPTD,U,2)_U_$P(PSJPSEX,U,2)_U_PSJPWD
"RTN","PSGMMAR0",147,0)
 ;GMZ:PSJ*5*196;Set diet info for each patient.
"RTN","PSGMMAR0",148,0)
 I (PSGSS="P")!(PSGSS="C")!(PSGSS="L") S ^TMP($J,PPN)=X_U_PSGMARWN_U_PSJPRB_U_$G(PSJDIET) Q
"RTN","PSGMMAR0",149,0)
 ;
"RTN","PSGMMAR0",150,0)
 ;DAM 5-01-07  Add check to see if user wants to include clinic orders when printing by ward.
"RTN","PSGMMAR0",151,0)
 I PSGSS="W" Q:((PSGINCL="")&(PSGMARWN["C!"))  S ^TMP($J,TM,PSGMARWN,SUB1,SUB2)=X_U_U_U_$G(PSJDIET)
"RTN","PSGMMAR0",152,0)
 ;
"RTN","PSGMMAR0",153,0)
 ;DAM 5-01-07 Add check to see if user wants to include clinic orders when printing by ward group.
"RTN","PSGMMAR0",154,0)
 I PSGSS="G" Q:((PSGINCLG="")&(PSGMARWN["C!"))  S ^TMP($J,TM,PSGMARWN,SUB1,SUB2)=X_U_U_U_$G(PSJDIET)
"RTN","PSGMMAR0",155,0)
 ;
"RTN","PSGMMAR0",156,0)
 ;PSJ*5.0*196 add diet information if sorted by patient.
"RTN","PSGMMAR0",157,0)
 I ($P(X,"^",15)']"") S $P(X,"^",15)=$G(PSJDIET)
"RTN","PSGMMAR0",158,0)
 ;
"RTN","PSGMMAR0",159,0)
 ;DAM 5-01-07  Add an XTMP global to reverse location and patient name in the subscripts when printing MAR by WARD/PATIENT or WARD GROUP. 
"RTN","PSGMMAR0",160,0)
 N PSGDEM S PSGDEM=X    ;transfer contents of patient demographics contained in "X" above to  a new variable temporarily
"RTN","PSGMMAR0",161,0)
 S PSGREP="PSGM_"_$J
"RTN","PSGMMAR0",162,0)
 S X1=DT,X2=1 D C^%DTC K %,%H,%T
"RTN","PSGMMAR0",163,0)
 S ^XTMP(PSGREP,0)=X_U_DT
"RTN","PSGMMAR0",164,0)
 I PSGRBPPN="P",PSGSS="W" Q:((PSGINCL="")&(PSGMARWN["C!"))  D    ;Construct XTMP global for printing by WARD
"RTN","PSGMMAR0",165,0)
 . S ^XTMP(PSGREP,TM,SUB1,PSGMARWN,SUB2)=PSGDEM
"RTN","PSGMMAR0",166,0)
 I PSGRBPPN="P",PSGSS="G" Q:((PSGINCLG="")&(PSGMARWN["C!"))  D   ;Construct XTMP global for printing by WARD GROUP
"RTN","PSGMMAR0",167,0)
 . S ^XTMP(PSGREP,TM,SUB1,PSGMARWN,SUB2)=PSGDEM
"RTN","PSGMMAR0",168,0)
 S X=PSGDEM    ;transfer contents of patient demographics contained in PSGDEM back to X
"RTN","PSGMMAR0",169,0)
 ;End DAM modifications 5-01-07
"RTN","PSGMMAR0",170,0)
 Q
"RTN","PSGMMIV")
0^3^B49203096^B48999295
"RTN","PSGMMIV",1,0)
PSGMMIV ;BIR/MV-IV ORDER FOR THE 7/14 DAY MAR. ;25 Nov 98 / 9:24 AM
"RTN","PSGMMIV",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**20,21,58,111,131,145,267,275,326**;16 DEC 97;Build 1
"RTN","PSGMMIV",3,0)
 ;
"RTN","PSGMMIV",4,0)
 ; Reference to ^PS(52.7 supported by DBIA #2173.
"RTN","PSGMMIV",5,0)
 ; Reference to ^PS(55 supported by DBIA #2191.
"RTN","PSGMMIV",6,0)
 ;
"RTN","PSGMMIV",7,0)
START ;*** Read IV orders
"RTN","PSGMMIV",8,0)
 NEW MULTIPG
"RTN","PSGMMIV",9,0)
 S ON=""
"RTN","PSGMMIV",10,0)
 F PSGMARED=PSGMARSD-.0001:0 S PSGMARED=$O(^PS(55,PSGP,"IV","AIT",PST,PSGMARED)) Q:'PSGMARED  F  S ON=$O(^PS(55,PSGP,"IV","AIT",PST,PSGMARED,ON)) Q:ON=""  D IV
"RTN","PSGMMIV",11,0)
 Q
"RTN","PSGMMIV",12,0)
IV ;*** Sort IV orders for 24 Hrs, 7/14 Day MAR.
"RTN","PSGMMIV",13,0)
 K DRG,P N X,ON55,PSJLABEL S DFN=PSGP,PSJLABEL=1 D GT55^PSIVORFB
"RTN","PSGMMIV",14,0)
 Q:P(2)>PSGMARFD
"RTN","PSGMMIV",15,0)
 S X=$P(P("MR"),U,2) Q:XTYPE=2&(X["IV")  Q:XTYPE=3&(PST="S")&'($S(X="IV":1,X="IVPB":1,1:0))
"RTN","PSGMMIV",16,0)
 S QST=$$ONE^PSJBCMA(DFN,ON,P(9),P(2),P(3))
"RTN","PSGMMIV",17,0)
 S QST=$S(P(9)["PRN":"OVP",QST="O":"OVO",1:"CV")_XTYPE
"RTN","PSGMMIV",18,0)
 Q:(PSGMARS=2&(QST["C"))
"RTN","PSGMMIV",19,0)
 Q:(PSGMARS=1&(QST["O"))
"RTN","PSGMMIV",20,0)
 N PSGMARWC  ;DEM (05/30/2006) - PSGMARWC is used to preserve original value of PSGMARWN (patient location) in case location is changed by an order with a clinic location.
"RTN","PSGMMIV",21,0)
 S PSGMARWC=PSGMARWN
"RTN","PSGMMIV",22,0)
 I $G(DRG) S X=$S($G(DRG("AD",1)):DRG("AD",1),1:$G(DRG("SOL",1))),X=$E($P(X,U,2),1,20)_U_+ON_"V" D
"RTN","PSGMMIV",23,0)
 . N A
"RTN","PSGMMIV",24,0)
 . S A=$G(^PS(55,PSGP,"IV",+ON,"DSS")) I ($P(A,"^",1)]"")&($P(A,"^",2)]"") S PSGMARWN="C!"_$P(A,"^") I $G(SUB1)]"",$G(SUB2)]"",'$D(^TMP($J,TM,PSGMARWN,SUB1,SUB2)) D
"RTN","PSGMMIV",25,0)
 . . N X,Y
"RTN","PSGMMIV",26,0)
 . . D SPN^PSGMMAR0
"RTN","PSGMMIV",27,0)
 . . Q
"RTN","PSGMMIV",28,0)
 . . ;
"RTN","PSGMMIV",29,0)
 . I PSGSS="P" S ^TMP($J,PPN,PSGMARWN,$S(+PSGMSORT:$E(QST,1),1:QST),X)="" Q                         ;DAM  5-01-07 Print by PATIENT
"RTN","PSGMMIV",30,0)
 . I PSGSS="L" Q:((PSGINWDG="")&(PSGMARWN'["C!"))  S ^TMP($J,PPN,PSGMARWN,$S(+PSGMSORT:$E(QST,1),1:QST),X)="" Q     ;DAM  5-01-07 Print by clinic group
"RTN","PSGMMIV",31,0)
 . I PSGSS="C" Q:((PSGINWD="")&(PSGMARWN'["C!"))  I ((PSGMARWN[PSGCLNC)!(PSGMARWN'["C!")) S ^TMP($J,PPN,PSGMARWN,$S(+PSGMSORT:$E(QST,1),1:QST),X)=""  Q    ;DAM 5-01-07 Print by Clinic
"RTN","PSGMMIV",32,0)
 . ;
"RTN","PSGMMIV",33,0)
 . ;DAM 5-01-07 Set up XTMP global where location and patient names are switched for printing by WARD/PATIENT or WARD GROUP/PATIENT
"RTN","PSGMMIV",34,0)
 . I '$G(PSGREP) N PSGDEM1 S PSGDEM1=X D    ;transfer contents of patient drug information contained in "X" above to  a new variable temporarily
"RTN","PSGMMIV",35,0)
 . . S PSGREP="PSGM_"_$J
"RTN","PSGMMIV",36,0)
 . . S X1=DT,X2=1 D C^%DTC K %,%H,%T
"RTN","PSGMMIV",37,0)
 . . S ^XTMP(PSGREP,0)=X_U_DT
"RTN","PSGMMIV",38,0)
 . I PSGRBPPN="P",PSGSS="W" Q:((PSGINCL="")&(PSGMARWN["C!"))  D         ;Construct XTMP global for printing by WARD and sort by PATIENT
"RTN","PSGMMIV",39,0)
 . . S ^XTMP(PSGREP,TM,PPN,PSGMARWN,PSJPRB,$S(+PSGMSORT:$E(QST,1),1:QST),PSGDEM1)=""
"RTN","PSGMMIV",40,0)
 . . D SPN^PSGMMAR0
"RTN","PSGMMIV",41,0)
 . I PSGRBPPN="P",PSGSS="G" Q:((PSGINCLG="")&(PSGMARWN["C!"))  D       ;Construct XTMP global for printing by WARD GROUP and sort by PATIENT
"RTN","PSGMMIV",42,0)
 . . S ^XTMP(PSGREP,TM,PPN,PSGMARWN,PSJPRB,$S(+PSGMSORT:$E(QST,1),1:QST),PSGDEM1)=""
"RTN","PSGMMIV",43,0)
 . . D SPN^PSGMMAR0
"RTN","PSGMMIV",44,0)
 . S X=$G(PSGDEM1)      ;Return value of X from PSGDEM1 back to X
"RTN","PSGMMIV",45,0)
 . ;
"RTN","PSGMMIV",46,0)
 . I PSGRBPPN="R",PSGSS="W" Q:((PSGINCL="")&(PSGMARWN["C!"))  D        ;Construct TMP global for printing by WARD and sort by ROOM/BED
"RTN","PSGMMIV",47,0)
 . . S ^TMP($J,TM,PSGMARWN,PSJPRB,PPN,$S(+PSGMSORT:$E(QST,1),1:QST),X)=""
"RTN","PSGMMIV",48,0)
 . I PSGRBPPN="R",PSGSS="G" Q:((PSGINCLG="")&(PSGMARWN["C!"))  D      ;Construct TMP global for printing by WARD GROUP and sort by ROOM/BED
"RTN","PSGMMIV",49,0)
 . . S ^TMP($J,TM,PSGMARWN,PSJPRB,PPN,$S(+PSGMSORT:$E(QST,1),1:QST),X)=""
"RTN","PSGMMIV",50,0)
  . ;End DAM modifications 5-01-07
"RTN","PSGMMIV",51,0)
  . ;
"RTN","PSGMMIV",52,0)
 S:PSGMARWN'=PSGMARWC PSGMARWN=PSGMARWC
"RTN","PSGMMIV",53,0)
 Q
"RTN","PSGMMIV",54,0)
IVPRN ;*** Set ^tmp to store IV orders that have schedule of PRN.
"RTN","PSGMMIV",55,0)
 K P,DRG NEW ON55,CHEMO,TXT,PSJLABEL,PSIVOPFL,PSIVOPIA
"RTN","PSGMMIV",56,0)
 S ON=$P(DAOO,U,2),DFN=$P(PN,U,2),PSJLABEL=1
"RTN","PSGMMIV",57,0)
 D:ON["V" GT55^PSIVORFB
"RTN","PSGMMIV",58,0)
 D:ON["P" GT531^PSIVORFA(DFN,ON)
"RTN","PSGMMIV",59,0)
 D SETVAR,SETLTRT
"RTN","PSGMMIV",60,0)
 ;the two naked references below refer to the full reference to the right of the = sign
"RTN","PSGMMIV",61,0)
 S ^(1)=$G(^TMP($J,"1PRN",PG,LAB,1))_UP_"      |            |"
"RTN","PSGMMIV",62,0)
 S ^(2)=$G(^TMP($J,"1PRN",PG,LAB,2))_UP_$E(P("LOG"),1,5)_" |",LN=3
"RTN","PSGMMIV",63,0)
 ;Naked reference below refers to ^TMP($J,"1PRN",PG,LAB,2)
"RTN","PSGMMIV",64,0)
 S:ON["P" ^(2)=^(2)_"P E N D I N G"
"RTN","PSGMMIV",65,0)
 ;Naked reference below refers to ^TMP($J,"1PRN",PG,LAB,2)
"RTN","PSGMMIV",66,0)
 S:ON["V" ^(2)=^(2)_$E(P(2),1,5)_$E(P(2),9,14)_" |"_P(3)
"RTN","PSGMMIV",67,0)
 ;Naked reference below refers to ^TMP($J,"1PRN",PG,LAB,2)
"RTN","PSGMMIV",68,0)
 S ^(2)=$$SETSTR^VALM1("("_$E(PSGP(0))_$E(PSSN,8,12)_")",^(2),40,7)
"RTN","PSGMMIV",69,0)
 F X=0:0 S X=$O(DRG("AD",X)) Q:'X  S TXT=$$WRTDRG^PSIVUTL(DRG("AD",X),47) S:LN=3 TXT=TXT_$$SP(47-$L(TXT))_PSGST,PSGST="" D CHK(.TXT)
"RTN","PSGMMIV",70,0)
 S TXT="in "
"RTN","PSGMMIV",71,0)
 F X=0:0 S X=$O(DRG("SOL",X)) Q:'X  D
"RTN","PSGMMIV",72,0)
 . S TXT=TXT_$$WRTDRG^PSIVUTL(DRG("SOL",X),47) S:LN=3 TXT=TXT_$$SP(47-$L(TXT))_PSGST,PSGST="" D CHK(.TXT) S TXT="   "
"RTN","PSGMMIV",73,0)
 . S PSJPRT2=$P(^PS(52.7,+DRG("SOL",X),0),U,4) I PSJPRT2]"" S TXT=TXT_"   "_PSJPRT2 S:LN=3 TXT=TXT_$$SP(47-$L(TXT))_PSGST,PSGST="" D CHK(.TXT) S TXT="   "
"RTN","PSGMMIV",74,0)
 S TXT=$P(P("MR"),U,2)_" "_P(9)_" "_P(8) D CHK(.TXT)
"RTN","PSGMMIV",75,0)
 I P(4)="C" S CHEMO="*CAUTION-CHEMOTHERAPY*" D:P("OPI")]"" CHK(CHEMO)
"RTN","PSGMMIV",76,0)
 S PSIVLOPI="",PSIVOPIA=1 S PSIVOPFL=$$OPI^PSGMIV(PSGP,ON55,.PSIVOPIA)
"RTN","PSGMMIV",77,0)
 S Y1="" I '$G(PSIVOPFL) D
"RTN","PSGMMIV",78,0)
 .F Y=1:1:$L($P(P("OPI"),"^")," ") S Y1=Y1_$P($P(P("OPI"),"^")," ",Y)_" " I $L(Y1)>47 D CHK(Y1) S Y1=""
"RTN","PSGMMIV",79,0)
 .I $L(Y1)>28 D CHK(Y1) S Y1=""
"RTN","PSGMMIV",80,0)
 .I $L(Y1)<29,'(LN#6) S TXT=$S((P("OPI")=""&$D(CHEMO)):CHEMO,1:Y1),X=29-$L(TXT),TXT=TXT_$$SP(X)_INIT
"RTN","PSGMMIV",81,0)
 .E  D  S TXT=$$SP(29)_INIT,LN=LN+1
"RTN","PSGMMIV",82,0)
 ..;the following three naked references below refer to the full references to the right of the = sign
"RTN","PSGMMIV",83,0)
 ..I LN=5 S ^(LN)=$G(^TMP($J,"1PRN",PG,LAB,LN))_UP_Y1
"RTN","PSGMMIV",84,0)
 ..E  D:$L(Y1) CHK(Y1) F LN=LN:1:5 S ^(LN)=$G(^TMP($J,"1PRN",PG,LAB,LN))_UP_""
"RTN","PSGMMIV",85,0)
 .S ^(LN)=$G(^TMP($J,"1PRN",PG,LAB,LN))_UP_TXT
"RTN","PSGMMIV",86,0)
 N POPI,YL S (POPI,YL,Y1,Y)="" I $G(PSIVOPFL) D
"RTN","PSGMMIV",87,0)
 .F YL=1:1:+$O(PSIVOPIA(""),-1) S POPI=PSIVOPIA(YL) D
"RTN","PSGMMIV",88,0)
 ..I $O(PSIVOPIA(YL)) D CHK(POPI) S POPI="" Q
"RTN","PSGMMIV",89,0)
 ..I $L(POPI)>28 D CHK(POPI) S POPI=""
"RTN","PSGMMIV",90,0)
 ..I $L(POPI)<29,'(LN#6) S TXT=$S((POPI=""&$D(CHEMO)):CHEMO,1:POPI),X=29-$L(TXT),TXT=TXT_$$SP(X)_INIT
"RTN","PSGMMIV",91,0)
 ..E  D  S TXT=$$SP(29)_INIT,LN=LN+1
"RTN","PSGMMIV",92,0)
 ...;the following three naked references below refer to the full references to the right of the = sign
"RTN","PSGMMIV",93,0)
 ...I LN=5 S ^(LN)=$G(^TMP($J,"1PRN",PG,LAB,LN))_UP_POPI
"RTN","PSGMMIV",94,0)
 ...E  D:$L(POPI) CHK(POPI) F LN=LN:1:5 S ^(LN)=$G(^TMP($J,"1PRN",PG,LAB,LN))_UP_""
"RTN","PSGMMIV",95,0)
 ..S ^(LN)=$G(^TMP($J,"1PRN",PG,LAB,LN))_UP_TXT
"RTN","PSGMMIV",96,0)
 Q
"RTN","PSGMMIV",97,0)
SETVAR ;***Initialize variables.
"RTN","PSGMMIV",98,0)
 NEW TMSTR
"RTN","PSGMMIV",99,0)
 F X="LOG",2,3 S:P(X) P(X)=$$ENDTC^PSGMI(P(X))
"RTN","PSGMMIV",100,0)
 S PSGST=$S(P(9)["PRN":"P",P(2)=P(3):"O",1:"C"),TMSTR=P(11),PSGLFFD=PSGMARFD
"RTN","PSGMMIV",101,0)
 D INITOPI^PSGMMIVC
"RTN","PSGMMIV",102,0)
 S INIT="RPH: "_PSGLRPH,INIT=INIT_$$SP(38-($L(INIT)+29))_"RN: "_PSGLRN
"RTN","PSGMMIV",103,0)
 ;*** If OPI<29 char, it is ok to put INITs in the same line.
"RTN","PSGMMIV",104,0)
 ;*** If OPI=""&it's a Chemo order, warning & Inits prt on same line.
"RTN","PSGMMIV",105,0)
 ;*** Add number lines needed for additives and solutions and 1 line
"RTN","PSGMMIV",106,0)
 ;*** for infusion rate and 1 line for start/stop date.
"RTN","PSGMMIV",107,0)
 ;*** Multiple labels can have up to 5 lines per label and the last
"RTN","PSGMMIV",108,0)
 ;*** label can have up to 6 lines..
"RTN","PSGMMIV",109,0)
 ;
"RTN","PSGMMIV",110,0)
 NEW X S NAMENEED=0
"RTN","PSGMMIV",111,0)
 F X="AD","SOL" D NAMENEED^PSJMUTL(X,47,.NEED) S NAMENEED=NAMENEED+NEED
"RTN","PSGMMIV",112,0)
 S MULTIPG=0,NEED=1
"RTN","PSGMMIV",113,0)
 ;* Find # of lines needed for OPI -- (($L(P("OPI"))\47)
"RTN","PSGMMIV",114,0)
 ;* If the last line in OPI < 29 --(($L(P("OPI")#47)>28) include init.
"RTN","PSGMMIV",115,0)
 S X=($L($P(P("OPI"),"^"))\47)+(($L($P(P("OPI"),"^"))#47)>28)+1+($P(P("OPI"),"^")]""&(P(4)="C"))
"RTN","PSGMMIV",116,0)
 S X=(NAMENEED+X+2) S:X>5 NEED=((X-6)\5)+2
"RTN","PSGMMIV",117,0)
 S:NEED>BL MULTIPG=1
"RTN","PSGMMIV",118,0)
 Q
"RTN","PSGMMIV",119,0)
CHK(TXT) ;
"RTN","PSGMMIV",120,0)
 ;naked reference below refers to the full reference to the right of the = sign
"RTN","PSGMMIV",121,0)
 I '(LN#6) S ^(LN)=$G(^TMP($J,"1PRN",PG,LAB,LN))_UP_"See next label for continuation",LN=1 D
"RTN","PSGMMIV",122,0)
 . I PSGMAROC+1>(BL/2) D
"RTN","PSGMMIV",123,0)
 . . I PSGMAROC=BL-1,MULTIPG D
"RTN","PSGMMIV",124,0)
 . . .;naked reference below refers to the full reference to the right of the = sign
"RTN","PSGMMIV",125,0)
 . . .F LN=LN:1:6 S ^(LN)=$G(^TMP($J,"1PRN",PG,LAB,LN))_UP_"" S:LN=3 ^(LN)=UP_"*** CONTINUE ON NEXT PAGE ***"
"RTN","PSGMMIV",126,0)
 . . .S PG=PG+1,(LN,LT,RT)=1,(PSGMAROC,MULTIPG)=0 D LTRT^PSGMMAR3(.LT,"")
"RTN","PSGMMIV",127,0)
 . . E  D LTRT^PSGMMAR3(.RT,"^")
"RTN","PSGMMIV",128,0)
 . E  D LTRT^PSGMMAR3(.LT,"")
"RTN","PSGMMIV",129,0)
 ;naked reference below refers to the full reference to the right of the = sign
"RTN","PSGMMIV",130,0)
 S ^(LN)=$G(^TMP($J,"1PRN",PG,LAB,LN))_UP_TXT,LN=LN+1,TXT=""
"RTN","PSGMMIV",131,0)
 Q
"RTN","PSGMMIV",132,0)
SETLTRT ;*** Increment line number for left or right label on PRN sheet.
"RTN","PSGMMIV",133,0)
 I (NEED+PSGMAROC)>BL S:PSGMAROC PG=PG+1,(LT,RT)=1,PSGMAROC=0
"RTN","PSGMMIV",134,0)
 I NEED+PSGMAROC=BL D  Q
"RTN","PSGMMIV",135,0)
 . I PSGMAROC<(BL/2) D LTRT^PSGMMAR3(.LT,"")
"RTN","PSGMMIV",136,0)
 . E  D LTRT^PSGMMAR3(.RT,"^")
"RTN","PSGMMIV",137,0)
 I PSGMAROC,((NEED+PSGMAROC)>(BL/2)) S PSGMAROC=$S(PSGMAROC>(BL/2):PSGMAROC,1:(BL/2)) D LTRT^PSGMMAR3(.RT,"^")
"RTN","PSGMMIV",138,0)
 E  D LTRT^PSGMMAR3(.LT,"")
"RTN","PSGMMIV",139,0)
 Q
"RTN","PSGMMIV",140,0)
SP(X) ;***Set up spaces need between info on TXT for the label.
"RTN","PSGMMIV",141,0)
 N Y S $P(Y," ",X)=" "
"RTN","PSGMMIV",142,0)
 Q $G(Y)
"RTN","PSJIBAG")
0^4^B44108809^B43933390
"RTN","PSJIBAG",1,0)
PSJIBAG ;BIR/JCH - IV PARAMETER VALIDATION ; 08/10/12 12:26pm
"RTN","PSJIBAG",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**279,326**;16 DEC 97;Build 1
"RTN","PSJIBAG",3,0)
 ;;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSJIBAG",4,0)
 ;
"RTN","PSJIBAG",5,0)
 ; Reference to ^PSBPOIV is supported by DBIA #5434
"RTN","PSJIBAG",6,0)
 ;
"RTN","PSJIBAG",7,0)
PSBPOIV(DFN,ORDER,PSJQT,PSJINIV) ; Check BCMA IV Parameters, invalidate labels
"RTN","PSJIBAG",8,0)
 ; DFN - Patient IEN
"RTN","PSJIBAG",9,0)
 ; ORDER - Inpatient IV order
"RTN","PSJIBAG",10,0)
 ; PSJQT - Quiet (no display) 
"RTN","PSJIBAG",11,0)
 ;       - 100 = called from Label Log
"RTN","PSJIBAG",12,0)
 ; PSJINIV - Were any labels invalidated? 
"RTN","PSJIBAG",13,0)
 ;           0=NO, 1=YES
"RTN","PSJIBAG",14,0)
 ;
"RTN","PSJIBAG",15,0)
 Q:'$G(DFN)!'$G(ORDER)!'($G(ORDER)["V")
"RTN","PSJIBAG",16,0)
 K ^TMP("PSBAR",$J),^TMP("PSJINBAG",$J,DFN,+ORDER)
"RTN","PSJIBAG",17,0)
 I '$G(PSJQT) W !,"Checking IV Labels..."
"RTN","PSJIBAG",18,0)
 D EN^PSBPOIV(DFN,ORDER)
"RTN","PSJIBAG",19,0)
 N INVDT,PSJAVAIL,Y,COU,PSJDOLJ D NOW^%DTC S INVDT=%,PSJAVAIL=0,PSJDOLJ=$J
"RTN","PSJIBAG",20,0)
 N LBLID S LBLID=0 F  S LBLID=$O(^TMP("PSBAR",$J,LBLID)) Q:'LBLID  D
"RTN","PSJIBAG",21,0)
 .N LBLNUM,INVBCMA S INVBCMA=$P($G(^TMP("PSBAR",$J,LBLID)),"^")
"RTN","PSJIBAG",22,0)
 .I (INVBCMA'="I"),'$G(PSJAVAIL) K ^TMP("PSJINBAG",$J),^TMP("PSBAR",$J,"I") S PSJAVAIL=1,INVDT=""
"RTN","PSJIBAG",23,0)
 .S LBLNUM=$P(LBLID,"V",2) Q:'LBLNUM
"RTN","PSJIBAG",24,0)
 .N INVIPM S INVIPM=$P($G(^PS(55,DFN,"IVBCMA",LBLNUM,0)),"^",9) Q:INVIPM
"RTN","PSJIBAG",25,0)
 .S ^TMP("PSJINBAG",$J,DFN,ORDER,LBLID)=INVDT
"RTN","PSJIBAG",26,0)
 I $D(^TMP("PSJINBAG",$J,DFN,ORDER)) D
"RTN","PSJIBAG",27,0)
 .I ($G(PSJQT)) D DATA(DFN,+ORDER,,,$G(PSJAVAIL),,1),EXIT Q
"RTN","PSJIBAG",28,0)
 .D VFY(DFN,ORDER,INVDT,$G(PSJAVAIL)),EXIT
"RTN","PSJIBAG",29,0)
 Q
"RTN","PSJIBAG",30,0)
 ;
"RTN","PSJIBAG",31,0)
VFY(DFN,PSIVON55,INVDT,PSJAVAIL) ; If AUTO-VERIFY turned off, veryifying pharmacist needs to be reminded about invalidated labels before being prompted to print labels
"RTN","PSJIBAG",32,0)
 N PSJIAL,PSJIACT,PSJBLN,PSJDNE,PSIVTMP,Y S PSJBLN=0,PSJDNE=0,PSJINIV="",PSJDOLJ=$J
"RTN","PSJIBAG",33,0)
 N BCINVF S BCINVF=$G(^TMP("PSBAR",$J,"I")) I BCINVF]"" D
"RTN","PSJIBAG",34,0)
 .N TMPINFLD S TMPINFLD=$P(BCINVF,"invalid",2) S TMPINFLD=$TR(TMPINFLD,".") I $E(TMPINFLD)=" " S TMPINFLD=$E(TMPINFLD,2,99)
"RTN","PSJIBAG",35,0)
 .S BCINVF=TMPINFLD
"RTN","PSJIBAG",36,0)
 I '$G(PSJAVAIL)&(BCINVF="") Q
"RTN","PSJIBAG",37,0)
 D FULL^VALM1
"RTN","PSJIBAG",38,0)
 I '$G(PSJAVAIL),($G(BCINVF)]"") W !!!?6,"**  Edit to ",BCINVF," has invalidated the following IV labels  **" D
"RTN","PSJIBAG",39,0)
 .W !?4,"(Invalid IV labels cannot be reprinted or marked as Infusing in BCMA)"
"RTN","PSJIBAG",40,0)
 I $G(PSJAVAIL) W !!!?12,"**  The following labels are available  **"
"RTN","PSJIBAG",41,0)
 D DATA(DFN,PSIVON55,,$S($G(PSJAVAIL):"",1:INVDT),$S($G(PSJAVAIL):PSJAVAIL,1:""),.PSJINIV)
"RTN","PSJIBAG",42,0)
 I '$G(PSJAVAIL) D
"RTN","PSJIBAG",43,0)
 .N DIR,DA S DIR(0)="SAO^P:PRINT",DIR("A")="Enter 'P' to print list of Invalidated Labels or RETURN to continue: " D ^DIR
"RTN","PSJIBAG",44,0)
 .I '($G(Y)="P") K ^TMP("PSJINBAG",$J) Q
"RTN","PSJIBAG",45,0)
 .D DEV(DFN,PSIVON55,INVDT)
"RTN","PSJIBAG",46,0)
 I $G(PSJAVAIL) D CONT^PSJOE0 K ^TMP("PSJINBAG",$J)
"RTN","PSJIBAG",47,0)
 Q
"RTN","PSJIBAG",48,0)
 ;
"RTN","PSJIBAG",49,0)
DATA(DFN,ON,PSJIPRNT,PSJIINV,PSJAVAIL,PSJINIV,PSJQT) ;Get the Information
"RTN","PSJIBAG",50,0)
 N PSJINVDT
"RTN","PSJIBAG",51,0)
EN2 ; Queued entry point
"RTN","PSJIBAG",52,0)
 N TMPON55,PSJBLN,PSJD1,X,DA,DR,DIQ,DIC,PSJD2,LLCNT,PSJBLNL,TMPON,PSIVSCR,PSGP
"RTN","PSJIBAG",53,0)
 K PSJDNE S PSIVSCR=$E(IOST)="C",COU=0,LLCNT=0
"RTN","PSJIBAG",54,0)
 I ($G(ON)["P") S TMPON=ON N HDR531 S HDR531=$G(^PS(53.1,+ON,0)) S HDR531=$P(HDR531,"^",25) I HDR531["V" S ON=HDR531
"RTN","PSJIBAG",55,0)
 S ON=+ON
"RTN","PSJIBAG",56,0)
 S ^TMP("PSJINBAG",PSJDOLJ,DFN,ON_"V")=$S($G(PSJAVAIL):"AVAILABLE",1:"INVALID")
"RTN","PSJIBAG",57,0)
 I $G(PSJIPRNT) D ENIV^PSJAC D
"RTN","PSJIBAG",58,0)
 .N LOC,PN,AI,ADCNT,SOLCNT S LOC=$P($G(VAIN(4)),"^",2) I LOC="" S LOC=+$G(^PS(55,DFN,"IV",+ON,"DSS")) D
"RTN","PSJIBAG",59,0)
 ..S LOC=$S($G(LOC):$P($G(^SC(+LOC,0)),"^"),1:"NOT FOUND")
"RTN","PSJIBAG",60,0)
 .S PN=$S(($G(PSGP(0))]""):PSGP(0),1:$P($G(^DPT(DFN,0)),"^"))
"RTN","PSJIBAG",61,0)
 .U IO W !!?23,"* Invalidated IV Labels *",!!?5,"Patient: ",PN,?50,"Location: ",LOC
"RTN","PSJIBAG",62,0)
 .S ADCNT=0 F AI=1:1 S ADCNT=$O(^PS(55,DFN,"IV",+ON,"AD",ADCNT)) Q:'ADCNT  D
"RTN","PSJIBAG",63,0)
 ..N IVND0,IVSTR S IVND0=$G(^PS(55,DFN,"IV",+ON,"AD",ADCNT,0)),IVSTR=$P(IVND0,"^",2)
"RTN","PSJIBAG",64,0)
 ..I AI=1 W !?1,"Additive(s) (current order): ",?14,$P($G(^PS(52.6,+IVND0,0)),"^") Q
"RTN","PSJIBAG",65,0)
 ..W !?14,$P($G(^PS(52.6,+IVND0,0)),"^")
"RTN","PSJIBAG",66,0)
 .S SOLCNT=0 F AI=1:1 S SOLCNT=$O(^PS(55,DFN,"IV",+ON,"SOL",SOLCNT)) Q:'SOLCNT  D
"RTN","PSJIBAG",67,0)
 ..N IVND0,IVOL S IVND0=$G(^PS(55,DFN,"IV",+ON,"SOL",SOLCNT,0)),IVOL=$P(IVND0,"^",2)
"RTN","PSJIBAG",68,0)
 ..I AI=1 W !?1,"Solution(s) (current order): ",?14,$P($G(^PS(52.7,+IVND0,0)),"^") Q
"RTN","PSJIBAG",69,0)
 ..W !?14,$P($G(^PS(52.6,+$G(^PS(55,DFN,"IV",+ON,"SOL",SOLCNT,0)),0)),"^")
"RTN","PSJIBAG",70,0)
 I '$G(PSJQT) U IO W ! D H2 S PSJBLN=0,LLCNT=1
"RTN","PSJIBAG",71,0)
 I $G(PSJIINV) D NOW^%DTC S (PSJIINV,PSJINVDT)=$S($G(PSJIINV)>200000:PSJIINV,1:%) D UPD(DFN,ON,PSJINVDT,.PSJINIV)
"RTN","PSJIBAG",72,0)
 I '$G(PSJQT) S ON=ON_"V" S PSJBLNL=0 F  S PSJBLNL=$O(^TMP("PSJINBAG",PSJDOLJ,DFN,ON,PSJBLNL)) Q:'PSJBLNL  D DISPLAY
"RTN","PSJIBAG",73,0)
 ;
"RTN","PSJIBAG",74,0)
K ;
"RTN","PSJIBAG",75,0)
 K NUMLAB,TRA,CD,DATE,DIR,DIC,%
"RTN","PSJIBAG",76,0)
 Q
"RTN","PSJIBAG",77,0)
 ;
"RTN","PSJIBAG",78,0)
DISPLAY ; Display or Print labels 
"RTN","PSJIBAG",79,0)
 K DA,DR,DIQ,DIC,PSJD2 N IVALID,LBST,BCST,LSTAT,PSJBLN
"RTN","PSJIBAG",80,0)
 S PSJBLN=$P(PSJBLNL,"V",2)
"RTN","PSJIBAG",81,0)
 S DIC="^PS(55,"_DFN_",""IVBCMA"",",DA=PSJBLN,DR=".01;.02;1;2;3;4;5;9",DIQ="PSJD2",DIQ(0)="IE" D EN^DIQ1
"RTN","PSJIBAG",82,0)
 S BCST=$G(PSJD2(55.0105,PSJBLN,2,"E")) Q:(BCST="COMPLETED")!(BCST="GIVEN")
"RTN","PSJIBAG",83,0)
 Q:($G(PSJD2(55.0105,PSJBLN,5,"E"))]"")
"RTN","PSJIBAG",84,0)
 S IVALID=$P($G(^PS(55,DFN,"IVBCMA",+PSJBLN,0)),"^",9)
"RTN","PSJIBAG",85,0)
 I IVALID Q:($G(PSJIINV))&(IVALID'=$G(PSJIINV))
"RTN","PSJIBAG",86,0)
 I PSIVSCR,($Y#IOSL)>23 D PAUSE,H2 S LLCNT=$G(LLCNT)+3
"RTN","PSJIBAG",87,0)
 W $$ENDTC1^PSGMI($G(PSJD2(55.0105,PSJBLN,4,"I"))),?17,$G(PSJD2(55.0105,PSJBLN,.01,"I")) S LLCNT=$G(LLCNT)+1 I $X>39 W ! S LLCNT=$G(LLCNT)+1
"RTN","PSJIBAG",88,0)
 S LBST=$G(PSJD2(55.0105,PSJBLN,5,"E"))
"RTN","PSJIBAG",89,0)
 W ?39,LBST S LLCNT=$G(LLCNT)+1
"RTN","PSJIBAG",90,0)
 S X=$G(PSJD2(55.0105,PSJBLN,3,"I")) W ?51,$S(X:"YES",1:"NO")
"RTN","PSJIBAG",91,0)
 W ?57,$G(PSJD2(55.0105,PSJBLN,2,"E")) S LLCNT=$G(LLCNT)+1
"RTN","PSJIBAG",92,0)
 I $G(PSJD2(55.0105,PSJBLN,1,"I"))]"" W ?66,$$ENDTC1^PSGMI($G(PSJD2(55.0105,PSJBLN,1,"I"))) S LLCNT=$G(LLCNT)+1
"RTN","PSJIBAG",93,0)
 W ! S LLCNT=$G(LLCNT)
"RTN","PSJIBAG",94,0)
 I $G(LLCNT)>40 D PAUSE W !! S LLCNT=2
"RTN","PSJIBAG",95,0)
 Q
"RTN","PSJIBAG",96,0)
PAUSE ;
"RTN","PSJIBAG",97,0)
 Q:'($E(IOST)="C")
"RTN","PSJIBAG",98,0)
 N DIR S DIR(0)="E" D ^DIR S:$D(DTOUT)!($D(DUOUT)) PSJDNE=1
"RTN","PSJIBAG",99,0)
 Q
"RTN","PSJIBAG",100,0)
H ;Header
"RTN","PSJIBAG",101,0)
 N I
"RTN","PSJIBAG",102,0)
 W !!,"LABEL LOG:",!!,"#",?3,"DATE/TIME",?18,"ACTION",?32,"USER",?47,"#LABELS",?60,"TRACK",?75,"COUNT",! F I=1:1:80 W "=" W:I=80 !
"RTN","PSJIBAG",103,0)
 Q
"RTN","PSJIBAG",104,0)
H2 ;Header for Unique ID #s
"RTN","PSJIBAG",105,0)
 W !,"Label Date/Time",?17,"Unique ID",?39,"Status",?51,"Count",?57,"BCMA Action-Date/Time"
"RTN","PSJIBAG",106,0)
 W !,"---------------",?17,"--------",?39,"---------",?51,"-----",?57,"-----------------------",!
"RTN","PSJIBAG",107,0)
 Q
"RTN","PSJIBAG",108,0)
DEV(DFN,ON55,INVDT) ;Device
"RTN","PSJIBAG",109,0)
 K %ZIS,IOP,POP,ZTSK,IO("Q") S PSJION=$I,%ZIS="QM"
"RTN","PSJIBAG",110,0)
 N ZTDESC,ZTRTN,ZTSAVE,G
"RTN","PSJIBAG",111,0)
 D ^%ZIS K %ZIS S PSJIPRNT=1,PSJIINV=""
"RTN","PSJIBAG",112,0)
 I POP S IOP=PSJION S %ZIS("A")="Select DEVICE:" D ^%ZIS K IOP,PSJION W !,"Please try later!" G EXIT
"RTN","PSJIBAG",113,0)
 K PSJION I $D(IO("Q")) D  G EXIT
"RTN","PSJIBAG",114,0)
 .S ZTDESC="Invalidated IV Labels Report",ZTRTN="EN2^PSJIBAG"
"RTN","PSJIBAG",115,0)
 .F G="DFN","ON55","PSJIPRNT","INVDT","PSJDOLJ","ON","PSJSYSU" S:$D(@G) ZTSAVE(G)=""
"RTN","PSJIBAG",116,0)
 .K IO("Q") D ^%ZTLOAD W:$D(ZTSK) !,"Report is Queued to print!" K ZTSK
"RTN","PSJIBAG",117,0)
 D EN2 W ! D PAUSE^PSJLMUT1
"RTN","PSJIBAG",118,0)
EXIT ;
"RTN","PSJIBAG",119,0)
 W ! D ^%ZISC K DIR,DTOUT,DUOUT,DIROUT,DIRUT
"RTN","PSJIBAG",120,0)
 K ^TMP("PSBAR",$J)
"RTN","PSJIBAG",121,0)
 Q
"RTN","PSJIBAG",122,0)
UPD(DFN,ON,PSJINVDT,PSJINIV) ; Go through labels, invalidate each
"RTN","PSJIBAG",123,0)
 S ON=ON_"V"
"RTN","PSJIBAG",124,0)
 N PSJBLN S PSJBLN=0 F  S PSJBLN=$O(^TMP("PSJINBAG",$J,DFN,ON,PSJBLN)) Q:'PSJBLN  D
"RTN","PSJIBAG",125,0)
 .K DA,DR,DIQ,DIC,PSJD2 N IVALID,LBST,BCST
"RTN","PSJIBAG",126,0)
 .S DIC="^PS(55,"_DFN_",""IVBCMA"",",DA=PSJBLN,DR=".01;.02;1;2;3;4;5",DIQ="PSJD2",DIQ(0)="IE" D EN^DIQ1
"RTN","PSJIBAG",127,0)
 .Q:$P($G(^PS(55,DFN,"IVBCMA",+PSJBLN,0)),"^",9)
"RTN","PSJIBAG",128,0)
 .S BCST=$G(PSJD2(55.0105,PSJBLN,2,"E")) Q:(BCST="COMPLETED")!(BCST="GIVEN")
"RTN","PSJIBAG",129,0)
 .D UP1(DFN,ON,$P(PSJBLN,"V",2),PSJINVDT,.PSJINIV)
"RTN","PSJIBAG",130,0)
 S ^TMP("PSJINBAG",$J,DFN,ON)=PSJINVDT
"RTN","PSJIBAG",131,0)
 Q
"RTN","PSJIBAG",132,0)
UP1(DFN,ON,PSJBLN,PSJINVDT,PSJINIV) ; invalidate one label
"RTN","PSJIBAG",133,0)
 ;Input:  DFN     - patient's IEN
"RTN","PSJIBAG",134,0)
 ;        ON      - Order number for this bar code ID
"RTN","PSJIBAG",135,0)
 ;        PSJBLN  - Label index number from PS(55,DFN,"IVBCMA".
"RTN","PSJIBAG",136,0)
 ;        PSJINVDT- Invalidation Date
"RTN","PSJIBAG",137,0)
 ;
"RTN","PSJIBAG",138,0)
 Q:'$G(PSJBLN)!'$G(DFN)!'$G(ON)
"RTN","PSJIBAG",139,0)
 Q:'$G(^PS(55,DFN,"IVBCMA",+PSJBLN,0))
"RTN","PSJIBAG",140,0)
 N PSJBCID,NOW S PSJBCID=DFN_"V"_PSJBLN
"RTN","PSJIBAG",141,0)
 S DA(1)=DFN,X=PSJBCID,DIC="^PS(55,"_DA(1)_",""IVBCMA"","
"RTN","PSJIBAG",142,0)
 K DA,DR,DIE S DIE=DIC,DA=PSJBLN,DA(1)=DFN D NOW^%DTC S NOW=$S($G(PSJINVDT):PSJINVDT,1:%)
"RTN","PSJIBAG",143,0)
 S DR="9////"_+PSJINVDT D ^DIE
"RTN","PSJIBAG",144,0)
 K DIC,DIE,D0,DA,DR
"RTN","PSJIBAG",145,0)
 I '$G(PSJINIV) S PSJINIV=1
"RTN","PSJIBAG",146,0)
 Q
"VER")
8.0^22.0
"BLD",10075,6)
^276
**END**
**END**

