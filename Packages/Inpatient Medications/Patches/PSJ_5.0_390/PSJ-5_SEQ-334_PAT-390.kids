Released PSJ*5*390 SEQ #334
Extracted from mail message
**KIDS**:PSJ*5.0*390^

**INSTALL NAME**
PSJ*5.0*390
"BLD",11162,0)
PSJ*5.0*390^INPATIENT MEDICATIONS^0^3190823^y
"BLD",11162,1,0)
^^4^4^3190723^
"BLD",11162,1,1,0)
This patch addresses 2 issues. 1) An issue with the Pre-Exchange
"BLD",11162,1,2,0)
DOSES for a clinic order when the clinic and the medication are tied to a
"BLD",11162,1,3,0)
PADE device. 2) Upon the entry of a date of death for a patient 
"BLD",11162,1,4,0)
the patient's active clinical orders (IMO) are not discontinued.
"BLD",11162,4,0)
^9.64PA^^
"BLD",11162,6)
1^
"BLD",11162,6.3)
7
"BLD",11162,"ABPKG")
n
"BLD",11162,"KRN",0)
^9.67PA^1.5^24
"BLD",11162,"KRN",.4,0)
.4
"BLD",11162,"KRN",.401,0)
.401
"BLD",11162,"KRN",.402,0)
.402
"BLD",11162,"KRN",.403,0)
.403
"BLD",11162,"KRN",.5,0)
.5
"BLD",11162,"KRN",.84,0)
.84
"BLD",11162,"KRN",1.5,0)
1.5
"BLD",11162,"KRN",1.6,0)
1.6
"BLD",11162,"KRN",1.61,0)
1.61
"BLD",11162,"KRN",1.62,0)
1.62
"BLD",11162,"KRN",3.6,0)
3.6
"BLD",11162,"KRN",3.8,0)
3.8
"BLD",11162,"KRN",9.2,0)
9.2
"BLD",11162,"KRN",9.8,0)
9.8
"BLD",11162,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",11162,"KRN",9.8,"NM",1,0)
PSGPEN^^0^B60242312
"BLD",11162,"KRN",9.8,"NM",2,0)
PSJADT0^^0^B33746201
"BLD",11162,"KRN",9.8,"NM","B","PSGPEN",1)

"BLD",11162,"KRN",9.8,"NM","B","PSJADT0",2)

"BLD",11162,"KRN",19,0)
19
"BLD",11162,"KRN",19.1,0)
19.1
"BLD",11162,"KRN",101,0)
101
"BLD",11162,"KRN",409.61,0)
409.61
"BLD",11162,"KRN",771,0)
771
"BLD",11162,"KRN",779.2,0)
779.2
"BLD",11162,"KRN",870,0)
870
"BLD",11162,"KRN",8989.51,0)
8989.51
"BLD",11162,"KRN",8989.52,0)
8989.52
"BLD",11162,"KRN",8994,0)
8994
"BLD",11162,"KRN","B",.4,.4)

"BLD",11162,"KRN","B",.401,.401)

"BLD",11162,"KRN","B",.402,.402)

"BLD",11162,"KRN","B",.403,.403)

"BLD",11162,"KRN","B",.5,.5)

"BLD",11162,"KRN","B",.84,.84)

"BLD",11162,"KRN","B",1.5,1.5)

"BLD",11162,"KRN","B",1.6,1.6)

"BLD",11162,"KRN","B",1.61,1.61)

"BLD",11162,"KRN","B",1.62,1.62)

"BLD",11162,"KRN","B",3.6,3.6)

"BLD",11162,"KRN","B",3.8,3.8)

"BLD",11162,"KRN","B",9.2,9.2)

"BLD",11162,"KRN","B",9.8,9.8)

"BLD",11162,"KRN","B",19,19)

"BLD",11162,"KRN","B",19.1,19.1)

"BLD",11162,"KRN","B",101,101)

"BLD",11162,"KRN","B",409.61,409.61)

"BLD",11162,"KRN","B",771,771)

"BLD",11162,"KRN","B",779.2,779.2)

"BLD",11162,"KRN","B",870,870)

"BLD",11162,"KRN","B",8989.51,8989.51)

"BLD",11162,"KRN","B",8989.52,8989.52)

"BLD",11162,"KRN","B",8994,8994)

"BLD",11162,"QDEF")
^^^^NO^^^^^^NO
"BLD",11162,"QUES",0)
^9.62^^
"BLD",11162,"REQB",0)
^9.611^2^2
"BLD",11162,"REQB",1,0)
PSJ*5.0*327^2
"BLD",11162,"REQB",2,0)
PSJ*5.0*274^2
"BLD",11162,"REQB","B","PSJ*5.0*274",2)

"BLD",11162,"REQB","B","PSJ*5.0*327",1)

"MBREQ")
0
"PKG",221,-1)
1^1
"PKG",221,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",221,22,0)
^9.49I^1^1
"PKG",221,22,1,0)
5.0^2971215^2981113^1
"PKG",221,22,1,"PAH",1,0)
390^3190823^520824686
"PKG",221,22,1,"PAH",1,1,0)
^^4^4^3190823
"PKG",221,22,1,"PAH",1,1,1,0)
This patch addresses 2 issues. 1) An issue with the Pre-Exchange
"PKG",221,22,1,"PAH",1,1,2,0)
DOSES for a clinic order when the clinic and the medication are tied to a
"PKG",221,22,1,"PAH",1,1,3,0)
PADE device. 2) Upon the entry of a date of death for a patient 
"PKG",221,22,1,"PAH",1,1,4,0)
the patient's active clinical orders (IMO) are not discontinued.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSGPEN")
0^1^B60242312^B58080181
"RTN","PSGPEN",1,0)
PSGPEN ;BIR/CML3 - FIND DEFAULT FOR PRE-EXCHANGE NEEDS ;15 May 2019 16:15:59
"RTN","PSGPEN",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**30,37,50,58,115,110,127,129,323,317,357,386,327,390**;16 DEC 97;Build 7
"RTN","PSGPEN",3,0)
 ;
"RTN","PSGPEN",4,0)
 ; References to ^PSD(58.8 supported by DBIA #2283.
"RTN","PSGPEN",5,0)
 ; References to ^PSI(58.1 supported by DBIA #2284.
"RTN","PSGPEN",6,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSGPEN",7,0)
 ; Reference to ^PSDRUG is supported by DBIA #2192.
"RTN","PSGPEN",8,0)
 ; Reference to ^PS(59.7 is supported by DBIA #2181.
"RTN","PSGPEN",9,0)
 ;
"RTN","PSGPEN",10,0)
EN(PSGPENO) ;
"RTN","PSGPEN",11,0)
 S PSGPENO=+PSGPENO
"RTN","PSGPEN",12,0)
 N PSJPADE
"RTN","PSGPEN",13,0)
 S PSJPADE=$$PADE($G(PSJPWD),PSGP,PSGPENO_"U")  ; PADE check - PSJ*5*317
"RTN","PSGPEN",14,0)
 N PSJSITE,PSJPRN,PSJCLO,ND8 S PSJCLO=0,ND8=0 S PSJSITE=0,PSJSITE=$O(^PS(59.7,PSJSITE)) I $P($G(^(PSJSITE,26)),U,5)=1 S PSJPRN=1
"RTN","PSGPEN",15,0)
 D NOW^%DTC S PSGDT=%,DT=$$DT^XLFDT,PSGPEN="" S ND=$G(^PS(55,PSGP,5,PSGPENO,0)),ND8=$G(^PS(55,PSGP,5,PSGPENO,8))
"RTN","PSGPEN",16,0)
 S:$P(ND8,"^",2) PSJCLO=1
"RTN","PSGPEN",17,0)
 S PSGPENWS=0 I PSJPWD,'PSJCLO F Q=0:0 S Q=$O(^PS(55,PSGP,5,PSGPENO,1,Q)) Q:'Q  S ND=$G(^(Q,0)) I ND,'$P(ND,"^",3),($D(^PSI(58.1,"D",+ND,PSJPWD))!$D(^PSD(58.8,"D",+ND,PSJPWD))) S PSGPENWS=1 Q
"RTN","PSGPEN",18,0)
 I PSGPENWS F Q=0:0 S Q=$O(^PS(55,PSGP,5,PSGPENO,1,Q)) Q:'Q  S ND=$G(^(Q,0)) I ND,'$P(ND,"^",3) S:'$D(^PSI(58.1,"D",+ND,PSJPWD))&'$D(^PSD(58.8,"D",+ND,PSJPWD)) PSGPENWS=0 Q:'PSGPENWS  S $P(PSGPENWS,"^",2)=1
"RTN","PSGPEN",19,0)
 I PSJPADE&'PSGPENWS W !!,"The dispense drug",$S(PSJPADE>1:"s",1:"")," for this order ",$S(PSJPADE>1:"are",1:"is a")," PADE item",$S(PSJPADE>1:"s",1:""),"." S PSGPEN=0
"RTN","PSGPEN",20,0)
 I PSJPADE&PSGPENWS W !!,"The dispense drug",$S(PSJPADE>1:"s",1:"")," for this order ",$S(PSJPADE>1:"are",1:"is a")," WARD STOCK/PADE item",$S(PSJPADE>1:"s",1:""),"." S PSGPEN=0
"RTN","PSGPEN",21,0)
 I PSGPENWS&'PSJPADE W !!,"The dispense drug",$E("s",$P(PSGPENWS,"^",2))," for this order ",$S($P(PSGPENWS,"^",2):"are",1:"is a")," WARD STOCK item",$E("s",$P(PSGPENWS,"^",2)),"." S PSGPEN=0
"RTN","PSGPEN",22,0)
 I '$G(PSJCLO),'PSGPENWS,PSJPWD,'PSJPADE S WG=+$O(^PS(57.5,"AB",PSJPWD,0)),PSGPLS=$P($G(^PS(55,PSGP,5,PSGPENO,2)),"^",2) I PSGPLS D
"RTN","PSGPEN",23,0)
 .S PSGPLF=$O(^PS(53.5,"AB",WG,PSGDT))
"RTN","PSGPEN",24,0)
 .N RNDT,PSJRNOS S RNDT=$$LASTREN^PSJLMPRI(PSGP,$S($G(PSJORD)["P":PSJORD,1:"")),PSJRNOS=$P(RNDT,"^",4) I PSJRNOS,'$G(PSJREN) S PSGPLS=PSJRNOS
"RTN","PSGPEN",25,0)
 .I $G(PSJREN),$G(PSJORD)["U" S PSJRNOS=$P(^PS(55,PSGP,5,+PSJORD,2),"^",4) S PSGPLS=$S(PSJRNOS>PSGDT:PSJRNOS,1:$$DATE2^PSJUTL2(PSGDT))
"RTN","PSGPEN",26,0)
 .D:'PSGPLF GF I PSGPLF S PSGPLO=PSGPENO D NCE,^PSGPL0 S:PSGPLC'<0 PSGPEN=PSGPLC
"RTN","PSGPEN",27,0)
 I $G(PSGPRIO)="DONE" S PSGPEN=0
"RTN","PSGPEN",28,0)
 ;
"RTN","PSGPEN",29,0)
UPDD ;
"RTN","PSGPEN",30,0)
 N DIR S DIR(0)="NOA^0:9999:0",DIR("A")="Pre-Exchange DOSES: ",DIR("?")="^D DH^PSGPEN" S:PSGPEN]"" DIR("B")=PSGPEN W ! D ^DIR G:'Y DONE S PSGY=+Y W !!,"...updating dispense drug(s)..."
"RTN","PSGPEN",31,0)
 F FQ=0:0 S FQ=$O(^PS(55,PSGP,5,PSGPENO,1,FQ)) Q:'FQ  S ND=$G(^(FQ,0)),$P(^(0),"^",9)="" I ND,'$P(ND,"^",3) D DD
"RTN","PSGPEN",32,0)
 ;
"RTN","PSGPEN",33,0)
DONE ;
"RTN","PSGPEN",34,0)
 I $P(PSJSYSW0,"^",29)="",$$DEFON^PSGPER1 S $P(PSJSYSW0,"^",29)=0
"RTN","PSGPEN",35,0)
 K PSGID,PSGMAR,PSGOD,PSGPLC,PSGPLF,PSGPLO,PSGPLS,PSGPLUD,WG S:$G(PSJREN) DUOUT=0 Q
"RTN","PSGPEN",36,0)
 ;
"RTN","PSGPEN",37,0)
NCE ;
"RTN","PSGPEN",38,0)
 W !!,"The next cart exchange is ",$$ENDTC^PSGMI(PSGPLF),! Q
"RTN","PSGPEN",39,0)
 ;
"RTN","PSGPEN",40,0)
GF ;
"RTN","PSGPEN",41,0)
 S QQ=0 F Q=0:0 S Q=$O(^PS(53.5,"AB",WG,Q)) Q:'Q  S QQ=Q
"RTN","PSGPEN",42,0)
 I QQ S QQ=$O(^PS(53.5,"AB",WG,QQ,0)) I QQ,$D(^PS(53.5,QQ,0)) S QQ=$P(^(0),"^",4) I QQ>PSGDT S PSGPLF=QQ
"RTN","PSGPEN",43,0)
 Q
"RTN","PSGPEN",44,0)
 ;
"RTN","PSGPEN",45,0)
DD ;
"RTN","PSGPEN",46,0)
 N DA S DRG=$S($P(ND,"^")="":"NOT FOUND",'$D(^PSDRUG(+ND,0)):"NOT FOUND ("_$P(ND,"^")_")",$P(^(0),"^")]"":$P(^(0),"^"),1:$P(ND,"^")_";PSDRUG("),UD=$S('$P(ND,"^",2):1,1:$P(ND,"^",2))
"RTN","PSGPEN",47,0)
 W !,"...",DRG,?45,"U/D: ",UD,"..."
"RTN","PSGPEN",48,0)
 S PSGDA=PSGY I 'PSGPENWS,'$G(PSJCLO),ND,PSJPWD,($D(^PSI(58.1,"D",+ND,PSJPWD))!$D(^PSD(58.8,"D",+ND,PSJPWD))) D PSGPENWS Q:'PSGDA
"RTN","PSGPEN",49,0)
 K DA,DR S PSGDA=$S(UD#1:(PSGDA*((UD\1)+1)),1:PSGDA*UD)
"RTN","PSGPEN",50,0)
 S DIE="^PS(55,"_PSGP_",5,"_PSGPENO_",1,",DA(2)=PSGP,DA(1)=PSGPENO,DA=FQ,DR=".09////"_PSGDA D ^DIE
"RTN","PSGPEN",51,0)
 S PSGPXN=$G(PSGPXN)
"RTN","PSGPEN",52,0)
 D:'PSGPXN
"RTN","PSGPEN",53,0)
 .D NOW^%DTC L +^PS(53.4,0):0 S ND=$G(^PS(53.4,0)) S:ND="" ND="PRE-EXCHANGE NEEDS^53.4P" F PSGPXN=$P(ND,"^",3)+1:1 I '$D(^PS(53.4,PSGPXN)) L +^PS(53.4,PSGPXN):0 I  S ^PS(53.4,0)=$P(ND,"^",1,2)_"^"_PSGPXN_"^"_($P(ND,"^",4)+1) L -^PS(53.4,0) Q
"RTN","PSGPEN",54,0)
 .S ^PS(53.4,PSGPXN,0)=DUZ_"^"_%,^PS(53.4,"B",DUZ,PSGPXN)="",^PS(53.4,"AUD",DUZ,%,PSGPXN)="" L -^PS(53.4,PSGPXN) Q
"RTN","PSGPEN",55,0)
 I $D(^PS(53.4,PSGPXN,1,PSGP,1,PSGPENO,1,FQ,0)) S $P(^(0),"^",2)=$P(^(0),"^",2)+PSGDA Q
"RTN","PSGPEN",56,0)
 ; naked reference below refers to line above
"RTN","PSGPEN",57,0)
 S ^(0)=FQ_"^"_PSGDA I $D(^PS(53.4,PSGPXN,1,PSGP,1,PSGPENO,1,0)) S $P(^(0),"^",3,4)=FQ_"^"_($P(^(0),"^",4)+1) Q
"RTN","PSGPEN",58,0)
 ; naked reference below refers to line above
"RTN","PSGPEN",59,0)
 S ^(0)="^53.401101A^"_FQ_"^1" Q:$D(^PS(53.4,PSGPXN,1,PSGP,1,PSGPENO,0))  S ^(0)=PSGPENO
"RTN","PSGPEN",60,0)
 I $D(^PS(53.4,PSGPXN,1,PSGP,1,0)) S $P(^(0),"^",3,4)=PSGPENO_"^"_($P(^(0),"^",4)+1) Q
"RTN","PSGPEN",61,0)
 ; naked reference below is from line above
"RTN","PSGPEN",62,0)
 S ^(0)="^53.4011A^"_PSGPENO_"^1" Q:$D(^PS(53.4,PSGPXN,1,PSGP,0))  S ^(0)=PSGP
"RTN","PSGPEN",63,0)
 I $D(^PS(53.4,PSGPXN,1,0)) S $P(^(0),"^",3,4)=PSGP_"^"_($P(^(0),"^",4)+1) Q
"RTN","PSGPEN",64,0)
 ; naked reference below is from line above
"RTN","PSGPEN",65,0)
 S ^(0)="^53.401PA^"_PSGP_"^1" Q
"RTN","PSGPEN",66,0)
 ;
"RTN","PSGPEN",67,0)
DH ;
"RTN","PSGPEN",68,0)
 W !!?2,"Enter a number from 0 to 9999, 0 decimal digits."
"RTN","PSGPEN",69,0)
 W !!?2,"Enter the number of DOSES needed for this order until the next cart exchange.",!,"This will be the number of times the order will be administered to the patient",!,"from the start of the order until the next cart exchange."
"RTN","PSGPEN",70,0)
 W !!?2,"PLEASE NOTE that this is DOSES, and NOT UNITS.  The doses entered will be",!,"converted to units for each dispense drug of this order, as each dispense drug",!,"may have different units per dose." Q
"RTN","PSGPEN",71,0)
 ;
"RTN","PSGPEN",72,0)
PSGPENWS ;
"RTN","PSGPEN",73,0)
 W !,"This dispense drug is a WARD STOCK item."
"RTN","PSGPEN",74,0)
 W !,"Would you like to:",!?3,"1 - Enter 0 (no) doses needed for this dispense drug.",!?3,"2 - Enter ",PSGDA," doses needed for this dispense drug.",!?3,"3 - Enter another amount as the doses needed for this dispense drug."
"RTN","PSGPEN",75,0)
 K DIR S DIR(0)="SA^1:0 (no) doses;2:"_PSGDA_" doses;3:another amount",DIR("A")="Select ACTION: ",DIR("?")="^D WH^PSGPEN" W ! D ^DIR I Y=1!'Y S PSGDA=0 Q
"RTN","PSGPEN",76,0)
 Q:Y=2  K DIR S DIR(0)="NA^0:9999:0",DIR("A")="Pre-Exchange DOSES for this dispense drug: ",DIR("?")="^D WDH^PSGPEN" W ! D ^DIR S PSGDA=+Y Q
"RTN","PSGPEN",77,0)
 ;
"RTN","PSGPEN",78,0)
WH ;
"RTN","PSGPEN",79,0)
 S Q="This dispense drug ("_DRG_") is a ward stock item.  Select:"
"RTN","PSGPEN",80,0)
 W !! F Q1=1:1:$L(Q," ") S Q2=$P(Q," ",Q1) W:$X+$L(Q2)>78 ! W Q2," "
"RTN","PSGPEN",81,0)
 W !?3,"1 to enter 0 (no) pre-exchange doses for this dispense drug.",!?3,"2 to enter ",PSGDA," doses for this dispense drug.",!?3,"3 to enter another amount for this dispense drug." Q
"RTN","PSGPEN",82,0)
 ;
"RTN","PSGPEN",83,0)
WDH ;
"RTN","PSGPEN",84,0)
 W !!?2,"Enter a number from 0 to 9999, 0 decimal digits.  If you enter an '^' to exit",!,"NO pre-exchange doses will be entered for this dispense drug." Q
"RTN","PSGPEN",85,0)
 ;
"RTN","PSGPEN",86,0)
PADE(PSJPWD,PSGP,PSGORD)  ; Pharmacy Automation Dispensing Equipment (PADE) check - PSJ*5*317
"RTN","PSGPEN",87,0)
 ; INPUT: PSJPWD = Ward location
"RTN","PSGPEN",88,0)
 ;        PSGP   = Patient DFN
"RTN","PSGPEN",89,0)
 ;        PSGORD = Order number
"RTN","PSGPEN",90,0)
 ; OUTPUT: PADE = Can this order be dispensed via PADE?
"RTN","PSGPEN",91,0)
 ;
"RTN","PSGPEN",92,0)
 N PADE,DFN,PSJDDND,PSJWDFLG,PSJORCL
"RTN","PSGPEN",93,0)
 ;I '$G(PSJPWD)!'$G(PSGP)!'$G(PSGORD) Q ""
"RTN","PSGPEN",94,0)
 I '$G(PSGP)!'$G(PSGORD) Q ""
"RTN","PSGPEN",95,0)
 S PADE="",DFN=$G(PSGP)
"RTN","PSGPEN",96,0)
 ; Check DEFAULT 0 ON PADE PRE-EXCHANGE parameter
"RTN","PSGPEN",97,0)
 D GETS^DIQ(59.6,+$G(PSJSYSW),8,"I","PSJWDFLG")
"RTN","PSGPEN",98,0)
 S PSJORCL=$S($G(PSGORD)["P":$G(^PS(53.1,+$G(PSGORD),"DSS")),$G(PSGORD)["U":$G(^PS(55,+$G(PSGP),5,+$G(PSGORD),8)),$G(PSGORD)["V":$G(^PS(55,+$G(PSGP),"IV",+$G(PSGORD),"DSS")),1:"")
"RTN","PSGPEN",99,0)
 I $G(PSJWDFLG("59.6",+$G(PSJSYSW)_",",8,"I"))!(+PSJORCL) D
"RTN","PSGPEN",100,0)
 .N PSJPDLOC,PSJCLNK
"RTN","PSGPEN",101,0)
 .; If clinic order, quit if clinic location is not linked to PADE
"RTN","PSGPEN",102,0)
 .;S PSJORCL=$S($G(PSGORD)["P":$G(^PS(53.1,+$G(PSGORD),"DSS")),$G(PSGORD)["U":$G(^PS(55,+$G(PSGP),5,+$G(PSGORD),8)),$G(PSGORD)["V":$G(^PS(55,+$G(PSGP),"IV",+$G(PSGORD),"DSS")),1:"")
"RTN","PSGPEN",103,0)
 .I PSJORCL,$P(PSJORCL,"^",2) S PSJCLNK=$$PADECL^PSJPAD50(+$G(PSJORCL)) Q:'PSJCLNK
"RTN","PSGPEN",104,0)
 .I '$G(PSJCLNK) Q:'$$PADEWD^PSJPAD50(PSJPWD)   ; Quit if patient location not linked to PADE
"RTN","PSGPEN",105,0)
 .S PSJPDLOC=$S($G(PSGORD)["P":+$G(^PS(53.1,+PSGORD,"DSS"))_"C",$G(PSGORD)["U":+$G(^PS(55,+$G(DFN),5,+$G(PSGORD),8))_"C",1:"")
"RTN","PSGPEN",106,0)
 .S:'PSJPDLOC PSJPDLOC=+$G(PSJPWD)
"RTN","PSGPEN",107,0)
 .N PADEFLAG,DDCNT S PADEFLAG=1
"RTN","PSGPEN",108,0)
 .I $G(PSGORD)["U" S Q=0 F DDCNT=0:1 S Q=$O(^PS(55,+$G(PSGP),5,+PSGORD,1,Q)) Q:'Q!'PADEFLAG  S PSJDDND=$G(^(Q,0)) D
"RTN","PSGPEN",109,0)
 ..S PADEFLAG=+$$DRGQTY^PSJPADSI(+PSJDDND,$S(PSJPDLOC["C":"CL",1:"WD"),+PSJPDLOC)
"RTN","PSGPEN",110,0)
 .I $G(PSGORD)'["U" S Q=0 F DDCNT=0:1 S Q=$O(^PS(53.45,+$G(PSJSYSP),2,Q)) Q:'Q!'PADEFLAG  S PSJDDND=$G(^(Q,0)) D
"RTN","PSGPEN",111,0)
 ..S PADEFLAG=+$$DRGQTY^PSJPADSI(+PSJDDND,$S(PSJPDLOC["C":"CL",1:"WD"),+PSJPDLOC)
"RTN","PSGPEN",112,0)
 .I DDCNT,PADEFLAG S PADE=DDCNT
"RTN","PSGPEN",113,0)
 Q PADE
"RTN","PSGPEN",114,0)
 ;
"RTN","PSJADT0")
0^2^B33746201^B33182966
"RTN","PSJADT0",1,0)
PSJADT0 ;BIR/CML3,PR,MLM-AUTO DC/HOLD CANCEL ;11 Aug 98 / 8:25 AM
"RTN","PSJADT0",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**17,111,112,135,181,274,390**;16 DEC 97;Build 7
"RTN","PSJADT0",3,0)
 ;
"RTN","PSJADT0",4,0)
 ;Reference to ^PS(55 supported by DBIA #2191.
"RTN","PSJADT0",5,0)
 ;
"RTN","PSJADT0",6,0)
ENDC ; dc active orders first, then non-verified orders
"RTN","PSJADT0",7,0)
 W:'$D(PSJQUIET)&'$D(DGQUIET) !,"...discontinuing Inpatient Medication orders..."
"RTN","PSJADT0",8,0)
 S $P(PSJPIND,"^")=""
"RTN","PSJADT0",9,0)
 D NOW^%DTC N PSJDCDT S (PSJDCDT,PSGDT)=+%,PSJSYSW0="" I PSJFW S PSJSYSW=$O(^PS(59.6,"B",PSJFW,0)) S:PSJSYSW PSJSYSW0=$G(^PS(59.6,PSJSYSW,0))
"RTN","PSJADT0",10,0)
 I PSGALO=1010!(PSGALO=1030)!(PSGALO=1050) D AUDDD
"RTN","PSJADT0",11,0)
 D ENUNM^PSGOU S PSGALR=10,DIE="^PS(55,"_PSGP_",5," S:PSJFW PSGTOL=1,PSGUOW=PSJFW,PSGTOO=1
"RTN","PSJADT0",12,0)
 F PSJS=PSGDT:0 S PSJS=$O(^PS(55,PSGP,5,"AUS",PSJS)) Q:'PSJS  F PSJDA=0:0 S PSJDA=$O(^PS(55,PSGP,5,"AUS",PSJS,PSJDA)) Q:'PSJDA  D
"RTN","PSJADT0",13,0)
 .Q:'$$DCIMO(PSGP,PSJDA,"U") 
"RTN","PSJADT0",14,0)
 .;first naked reference below refers to the full global reference to the right of the = sign (inside the $S)
"RTN","PSJADT0",15,0)
 .K DA S DA(1)=PSGP,DA=PSJDA,PSGAL("C")=0,$P(^(2),"^",3)=$S($D(^PS(55,PSGP,5,DA,2)):$P(^(2),"^",4),1:"")
"RTN","PSJADT0",16,0)
 .D ^PSGAL5
"RTN","PSJADT0",17,0)
 .K TMP
"RTN","PSJADT0",18,0)
 .S TMP(55.06,""_PSJDA_","_PSGP_","_"",28)="D"
"RTN","PSJADT0",19,0)
 .S TMP(55.06,""_PSJDA_","_PSGP_","_"",136)=$S(PSGALO=1010:"DD",1:"DA")
"RTN","PSJADT0",20,0)
 .D FILE^DIE("","TMP")
"RTN","PSJADT0",21,0)
 .K TMP
"RTN","PSJADT0",22,0)
 .S TMP(55.06,""_PSJDA_","_PSGP_","_"",34)=PSJDCDT
"RTN","PSJADT0",23,0)
 .S TMP(55.06,""_PSJDA_","_PSGP_","_"",49)=1
"RTN","PSJADT0",24,0)
 .D FILE^DIE("","TMP")
"RTN","PSJADT0",25,0)
 .K TMP
"RTN","PSJADT0",26,0)
 .D EN1^PSJHL2(PSGP,"OD",PSJDA_"U","AUTO DC")
"RTN","PSJADT0",27,0)
 .I PSGALO'=1050 S DA=PSJDA,^PS(55,"AUE",PSGP,DA)="" I $P(PSJSYSW0,"^",15),(PSGALO'<1060) S $P(^PS(55,PSGP,5,PSJDA,7),"^",1,2)=PSJDCDT_"^D" D ENL^PSGVDS
"RTN","PSJADT0",28,0)
 S PSGTOO=2 F PSJDA=0:0 S PSJDA=$O(^PS(53.1,"AC",PSGP,PSJDA)) Q:'PSJDA  D
"RTN","PSJADT0",29,0)
 .Q:'$$DCIMO(PSGP,PSJDA,"P")
"RTN","PSJADT0",30,0)
 .I PSGALO'<1060,$P(PSJSYSW0,U,15),$P($G(^PS(53.1,PSJDA,0)),U,9)="N" K DA D ENLBL^PSIVOPT(PSGTOL,PSGUOW,DFN,2,+PSJDA,"AD")
"RTN","PSJADT0",31,0)
 .K DA S DA=PSJDA D  I $P($G(^PS(53.1,DA,0)),"^",21) D EN1^PSJHL2(PSGP,"OC",PSJDA_"P","AUTO DC")
"RTN","PSJADT0",32,0)
 ..K TMP
"RTN","PSJADT0",33,0)
 ..S TMP(53.1,""_PSJDA_","_"",28)="D"
"RTN","PSJADT0",34,0)
 ..S TMP(53.1,""_PSJDA_","_"",42)=1
"RTN","PSJADT0",35,0)
 ..D FILE^DIE("","TMP")
"RTN","PSJADT0",36,0)
 ..K TMP
"RTN","PSJADT0",37,0)
 ;
"RTN","PSJADT0",38,0)
ENIV ;
"RTN","PSJADT0",39,0)
 S DFN=PSGP F PSJIVON=0:0 S PSJIVON=$O(^PS(55,DFN,"IV",PSJIVON)) Q:'PSJIVON  S Y=$G(^(PSJIVON,0)) I "PDEN"'[$P(Y,U,17) S P(17)=$P(Y,U,17),P(3)=$P(Y,U,3) D DC
"RTN","PSJADT0",40,0)
 Q
"RTN","PSJADT0",41,0)
DC ;
"RTN","PSJADT0",42,0)
 Q:'$$DCIMO(DFN,PSJIVON,"V")
"RTN","PSJADT0",43,0)
 S (ON,ON55)=PSJIVON_"V" D NOW^%DTC I P(17)="H",P(3)<% D  D EXPIR^PSIVOE Q
"RTN","PSJADT0",44,0)
 .K TMP
"RTN","PSJADT0",45,0)
 .S TMP(55.01,""_+ON_","_DFN_","_"",100)="E"
"RTN","PSJADT0",46,0)
 .D FILE^DIE("","TMP")
"RTN","PSJADT0",47,0)
 .K TMP
"RTN","PSJADT0",48,0)
 K PSIVALT S PSIVAC="AD",PSIVALCK="STOP",PSIVREA="D",PSIVAL=$S('+$G(PSGALO):$G(PSIVRES),1:$P($G(^PS(53.3,+PSGALO,0)),U)) D D1^PSIVOPT2,LOG^PSIVORAL
"RTN","PSJADT0",49,0)
 K TMP
"RTN","PSJADT0",50,0)
 S TMP(55.01,""_+ON_","_DFN_","_"",157)=$S($G(PSGALO)=1010:"DD",1:"DA")
"RTN","PSJADT0",51,0)
 S TMP(55.01,""_+ON_","_DFN_","_"",.03)=PSJDCDT
"RTN","PSJADT0",52,0)
 S TMP(55.01,""_+ON_","_DFN_","_"",121)=1
"RTN","PSJADT0",53,0)
 D FILE^DIE("","TMP")
"RTN","PSJADT0",54,0)
 K TMP
"RTN","PSJADT0",55,0)
 D EN1^PSJHL2(DFN,"OD",+ON_"V","AUTO DC")
"RTN","PSJADT0",56,0)
 S PSJIVDCF=1
"RTN","PSJADT0",57,0)
 Q
"RTN","PSJADT0",58,0)
 ;
"RTN","PSJADT0",59,0)
SIVDIE ; Setup DIE,DA for IV
"RTN","PSJADT0",60,0)
 K DA,DIE,DR S DA=+ON,DA(1)=DFN,DIE="^PS(55,"_DFN_",""IV"","
"RTN","PSJADT0",61,0)
 Q
"RTN","PSJADT0",62,0)
 ;
"RTN","PSJADT0",63,0)
AUDDD ; set up orders for discharge report and purging
"RTN","PSJADT0",64,0)
 S DIS=+VAIP(17,1) I $S('DIS:1,1:$D(^PS(55,"AUDDD",DIS,PSGP))) Q
"RTN","PSJADT0",65,0)
 S X=$$EN^PSGCT(+VAIP(13,1),-1)
"RTN","PSJADT0",66,0)
 F Q=X:0 S Q=$O(^PS(55,PSGP,5,"AUS",Q)) Q:'Q  F QQ=0:0 S QQ=$O(^PS(55,PSGP,5,"AUS",Q,QQ)) Q:'QQ  I $S($D(^PS(55,PSGP,5,QQ,0)):'$P(^(0),"^",20),1:1) S $P(^(0),"^",20)=DIS,^PS(55,"AUDDD",DIS,PSGP,QQ)=""
"RTN","PSJADT0",67,0)
 Q
"RTN","PSJADT0",68,0)
 ;
"RTN","PSJADT0",69,0)
ENHE ; status from hold to expired
"RTN","PSJADT0",70,0)
 D NOW^%DTC S PSGDT=+$E(%,1,12),DIE="^PS(55,"_PSGP_",5,"
"RTN","PSJADT0",71,0)
 F PSJS=+PSJPAD:0 S PSJS=$O(^PS(55,PSGP,5,"AUS",PSJS)) Q:'PSJS  Q:PSJS>PSGDT  F PSJDA=0:0 S PSJDA=$O(^PS(55,PSGP,5,"AUS",PSJS,PSJDA)) Q:'PSJDA  K DA S DA(1)=PSGP,DA=PSJDA I $D(^PS(55,PSGP,5,DA,0)),$P(^(0),"^",9)="H" S DR="28////E" D ^DIE
"RTN","PSJADT0",72,0)
 Q
"RTN","PSJADT0",73,0)
 ;
"RTN","PSJADT0",74,0)
ENUNDC(PSJDCDT,PSGP,PSJUOW,PSGALO) ; Auto-reinstate orders DC'ed due to a patient movement.
"RTN","PSJADT0",75,0)
 N PSJSYSW0 D NOW^%DTC S PSJUNDC=1,PSGDT=%,PSJFIRST='$D(PSJQUIET),PSJSYSW0=$G(^PS(59.6,+$O(^PS(59.6,"B",+PSJUOW,0)),0))
"RTN","PSJADT0",76,0)
 S PSJS=$O(^PS(55,PSGP,5,"AUS",PSJDCDT-.0002)) F PSGORD=0:0 S PSGORD=$O(^PS(55,PSGP,5,"AUS",+PSJS,PSGORD)) Q:'PSGORD  D
"RTN","PSJADT0",77,0)
 .I $P($G(^PS(55,PSGP,5,PSGORD,0)),U,9)["D",$P($G(^(4)),U,11) D DISREIN,ENRI^PSGOERI
"RTN","PSJADT0",78,0)
 .S ^PS(55,"AUE",PSGP,PSGORD)=""
"RTN","PSJADT0",79,0)
 ;
"RTN","PSJADT0",80,0)
 S:PSJS="" PSJS=$O(^PS(55,PSGP,"IV","AIS",PSJDCDT-.0002))
"RTN","PSJADT0",81,0)
 F PSGORD=0:0 S PSGORD=$O(^PS(55,PSGP,"IV","AIS",+PSJS,PSGORD)) Q:'PSGORD  D
"RTN","PSJADT0",82,0)
 .I $P($G(^PS(55,PSGP,"IV",PSGORD,0)),U,12),$P($G(^(2)),U,7)>PSGDT S P(3)=$P($G(^(0)),U,3) D DISREIN,ENARI^PSIVOPT(PSGP,PSGORD,+PSJUOW,PSGALO)
"RTN","PSJADT0",83,0)
 I $D(^TMP("PSJUNDC")) S ^TMP("PSJUNDC",$J,DFN)=$P(^DPT(DFN,0),"^")_"^"_$G(^DPT(PSGP,.1))_"^"_PSGALO D ^PSJADT2
"RTN","PSJADT0",84,0)
 ;
"RTN","PSJADT0",85,0)
ENKL ;
"RTN","PSJADT0",86,0)
 F UW=0:0 S UW=$O(^PS(53.41,1,1,UW)) Q:'UW  D  I '$O(^PS(53.41,1,1,0)) K DA S DA=1,DIK="^PS(53.41," D ^DIK
"RTN","PSJADT0",87,0)
 .F PSGP=0:0 S PSGP=$O(^PS(53.41,1,1,UW,1,PSGP)) Q:'PSGP  D  I '$O(^PS(53.41,1,1,UW,1,0)) K DA S DIK="^PS(53.41,1,1,",DA(1)=1,DA=UW D ^DIK
"RTN","PSJADT0",88,0)
 ..F TO=0:0 S TO=$O(^PS(53.41,1,1,UW,1,PSGP,1,TO)) Q:'TO  D  I '$O(^PS(53.41,1,1,UW,1,PSGP,1,0)) K DA S DA(2)=1,DA(1)=UW,DA=PSGP,DIK="^PS(53.41,1,1,"_UW_",1," D ^DIK
"RTN","PSJADT0",89,0)
 ...I '$O(^PS(53.41,1,1,UW,1,PSGP,1,TO,1,0))  K DA S DA(3)=1,DA(2)=UW,DA(1)=PSGP,DA=TO,DIK="^PS(53.41,1,1,"_UW_",1,"_PSGP_",1," D ^DIK
"RTN","PSJADT0",90,0)
 K DA,DIK,P,PSGDT,PSGP,PSGORD,PSJS,PSJUNDC,TO,UW
"RTN","PSJADT0",91,0)
 Q
"RTN","PSJADT0",92,0)
 ;
"RTN","PSJADT0",93,0)
DISREIN ; Display reinstate msg. for first order.
"RTN","PSJADT0",94,0)
 W:PSJFIRST&'$D(DGQUIET) !,"...reinstating Inpatient Medication orders..." S PSJFIRST=0
"RTN","PSJADT0",95,0)
 Q
"RTN","PSJADT0",96,0)
 ;
"RTN","PSJADT0",97,0)
DCIMO(DFN,ON,TYP) ; Check parameter before DC'ing clinic order
"RTN","PSJADT0",98,0)
 N GLO,IMOND,A,CLINIC,APPT,B,C S GLO=$S(TYP="P":"^PS(53.1,",TYP="U":"^PS(55,"_DFN_",5,",TYP="V":"^PS(55,"_PSGP_",""IV"",",1:"") I TYP="" Q 1
"RTN","PSJADT0",99,0)
 S IMOND=$S(TYP="P"!(TYP="V"):"""DSS""",TYP="U":8,1:"") I IMOND="" Q 1
"RTN","PSJADT0",100,0)
 S GLO=GLO_+ON_","_IMOND_")",A=$G(@GLO),CLINIC=$P(A,"^"),APPT=$P(A,"^",2)
"RTN","PSJADT0",101,0)
 Q:'$$CLINIC^PSJBCMA(A) 1
"RTN","PSJADT0",102,0)
 I '$D(^PS(53.46,"B",CLINIC)) Q 1
"RTN","PSJADT0",103,0)
 I $$GET1^DIQ(2,DFN,.351,"I") Q 1 ;p390 .351 Patient DATE OF DEATH
"RTN","PSJADT0",104,0)
 S B=$O(^PS(53.46,"B",CLINIC,"")),C=+$P(^PS(53.46,B,0),"^",3) Q C
"VER")
8.0^22.2
"BLD",11162,6)
^334
**END**
**END**

