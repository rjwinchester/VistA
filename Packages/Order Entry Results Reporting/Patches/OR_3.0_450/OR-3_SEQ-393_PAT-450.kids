Released OR*3*450 SEQ #393
Extracted from mail message
**KIDS**:OR*3.0*450^

**INSTALL NAME**
OR*3.0*450
"BLD",10710,0)
OR*3.0*450^ORDER ENTRY/RESULTS REPORTING^0^3170927^y
"BLD",10710,1,0)
^^6^6^3170921^
"BLD",10710,1,1,0)
Patch OR*3.0*450 will address the following two issues:
"BLD",10710,1,2,0)
Note: issue 2 is documentation only
"BLD",10710,1,3,0)
 
"BLD",10710,1,4,0)
1. Flagged Orderable Item Alert not processing all inpatient items in an 
"BLD",10710,1,5,0)
   order
"BLD",10710,1,6,0)
2. CPRS GUI Technical Manual update Lab test order "other" clarification
"BLD",10710,4,0)
^9.64PA^^
"BLD",10710,6.3)
14
"BLD",10710,"ABPKG")
n
"BLD",10710,"KRN",0)
^9.67PA^779.2^20
"BLD",10710,"KRN",.4,0)
.4
"BLD",10710,"KRN",.401,0)
.401
"BLD",10710,"KRN",.402,0)
.402
"BLD",10710,"KRN",.403,0)
.403
"BLD",10710,"KRN",.5,0)
.5
"BLD",10710,"KRN",.84,0)
.84
"BLD",10710,"KRN",3.6,0)
3.6
"BLD",10710,"KRN",3.8,0)
3.8
"BLD",10710,"KRN",9.2,0)
9.2
"BLD",10710,"KRN",9.8,0)
9.8
"BLD",10710,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",10710,"KRN",9.8,"NM",1,0)
ORB3TIM2^^0^B48303565
"BLD",10710,"KRN",9.8,"NM",2,0)
ORB3SPEC^^0^B104096377
"BLD",10710,"KRN",9.8,"NM","B","ORB3SPEC",2)

"BLD",10710,"KRN",9.8,"NM","B","ORB3TIM2",1)

"BLD",10710,"KRN",19,0)
19
"BLD",10710,"KRN",19,"NM",0)
^9.68A^^
"BLD",10710,"KRN",19.1,0)
19.1
"BLD",10710,"KRN",101,0)
101
"BLD",10710,"KRN",409.61,0)
409.61
"BLD",10710,"KRN",771,0)
771
"BLD",10710,"KRN",779.2,0)
779.2
"BLD",10710,"KRN",870,0)
870
"BLD",10710,"KRN",8989.51,0)
8989.51
"BLD",10710,"KRN",8989.51,"NM",0)
^9.68A^^0
"BLD",10710,"KRN",8989.52,0)
8989.52
"BLD",10710,"KRN",8994,0)
8994
"BLD",10710,"KRN","B",.4,.4)

"BLD",10710,"KRN","B",.401,.401)

"BLD",10710,"KRN","B",.402,.402)

"BLD",10710,"KRN","B",.403,.403)

"BLD",10710,"KRN","B",.5,.5)

"BLD",10710,"KRN","B",.84,.84)

"BLD",10710,"KRN","B",3.6,3.6)

"BLD",10710,"KRN","B",3.8,3.8)

"BLD",10710,"KRN","B",9.2,9.2)

"BLD",10710,"KRN","B",9.8,9.8)

"BLD",10710,"KRN","B",19,19)

"BLD",10710,"KRN","B",19.1,19.1)

"BLD",10710,"KRN","B",101,101)

"BLD",10710,"KRN","B",409.61,409.61)

"BLD",10710,"KRN","B",771,771)

"BLD",10710,"KRN","B",779.2,779.2)

"BLD",10710,"KRN","B",870,870)

"BLD",10710,"KRN","B",8989.51,8989.51)

"BLD",10710,"KRN","B",8989.52,8989.52)

"BLD",10710,"KRN","B",8994,8994)

"BLD",10710,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",10710,"QUES",0)
^9.62^^
"BLD",10710,"REQB",0)
^9.611^1^1
"BLD",10710,"REQB",1,0)
OR*3.0*423^1
"BLD",10710,"REQB","B","OR*3.0*423",1)

"MBREQ")
0
"PKG",174,-1)
1^1
"PKG",174,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",174,20,0)
^9.402P^^
"PKG",174,22,0)
^9.49I^1^1
"PKG",174,22,1,0)
3.0^2971217^2990325^66481
"PKG",174,22,1,"PAH",1,0)
450^3170927
"PKG",174,22,1,"PAH",1,1,0)
^^6^6^3170927
"PKG",174,22,1,"PAH",1,1,1,0)
Patch OR*3.0*450 will address the following two issues:
"PKG",174,22,1,"PAH",1,1,2,0)
Note: issue 2 is documentation only
"PKG",174,22,1,"PAH",1,1,3,0)
 
"PKG",174,22,1,"PAH",1,1,4,0)
1. Flagged Orderable Item Alert not processing all inpatient items in an 
"PKG",174,22,1,"PAH",1,1,5,0)
   order
"PKG",174,22,1,"PAH",1,1,6,0)
2. CPRS GUI Technical Manual update Lab test order "other" clarification
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","ORB3SPEC")
0^2^B104096377^B95914098
"RTN","ORB3SPEC",1,0)
ORB3SPEC ; slc/CLA,TC - Support routine for ORB3 ; 9/27/17 4:34pm
"RTN","ORB3SPEC",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**139,220,215,280,348,423,450**;Dec 17, 1997;Build 14
"RTN","ORB3SPEC",3,0)
SPECIAL(ORN,ORBASPEC,ORBU,ORBUI,ORNUM,ORDFN,ORDATA,ORBSMSG,ORBMSG,ORBSDEV,ORBPRIM,ORBATTD) ;
"RTN","ORB3SPEC",4,0)
 ;;Per VA Directive 6402, this routine should not be modified.
"RTN","ORB3SPEC",5,0)
 ;
"RTN","ORB3SPEC",6,0)
 ;DBIA SECTION
"RTN","ORB3SPEC",7,0)
 ; 10114 - ^%ZIS(1
"RTN","ORB3SPEC",8,0)
 ; 10035 - ^DPT(
"RTN","ORB3SPEC",9,0)
 ; 10060 - ^VA(200
"RTN","ORB3SPEC",10,0)
 ;  1960 - ^SCAPMC
"RTN","ORB3SPEC",11,0)
 ;  5697 - ^SCMCMHTC
"RTN","ORB3SPEC",12,0)
 ;  1252 - ^SDUTL3
"RTN","ORB3SPEC",13,0)
 ; 10103 - ^XLFDT
"RTN","ORB3SPEC",14,0)
 ;  2263 - ^XPAR
"RTN","ORB3SPEC",15,0)
 ;
"RTN","ORB3SPEC",16,0)
 ;process special notifs to get recips (users,teams,devices)
"RTN","ORB3SPEC",17,0)
 ; ORN: notif ien
"RTN","ORB3SPEC",18,0)
 ; ORBASPEC: recip DUZ array
"RTN","ORB3SPEC",19,0)
 ; ORBU: recip debug array
"RTN","ORB3SPEC",20,0)
 ; ORBUI: ORBU cntr
"RTN","ORB3SPEC",21,0)
 ; ORNUM: order no
"RTN","ORB3SPEC",22,0)
 ; ORDFN: pt id
"RTN","ORB3SPEC",23,0)
 ; ORDATA: pkg data
"RTN","ORB3SPEC",24,0)
 ; ORBSMSG: special notif msg rtn by SPECIAL
"RTN","ORB3SPEC",25,0)
 ; ORBMSG: original notif msg
"RTN","ORB3SPEC",26,0)
 ; ORBSDEV: array of recip devices
"RTN","ORB3SPEC",27,0)
 ; ORBPRIM: pt's inpt primary care provider
"RTN","ORB3SPEC",28,0)
 ; ORBATTD: pt's attending physician
"RTN","ORB3SPEC",29,0)
 ;
"RTN","ORB3SPEC",30,0)
 N ORPAR,ORPTLOC
"RTN","ORB3SPEC",31,0)
 S ORPTLOC=$S($L($G(^DPT(ORDFN,.1))):"I",1:"O")  ;DBIA #10035
"RTN","ORB3SPEC",32,0)
 I +$G(ORNUM) S ORPTLOC=$$ISCLORIP^ORB3F1(+$G(ORNUM),ORPTLOC)
"RTN","ORB3SPEC",33,0)
 ;
"RTN","ORB3SPEC",34,0)
 I ORPTLOC="I" D  ;inpt flagged OI notifs
"RTN","ORB3SPEC",35,0)
 .I ORN=32 S ORPAR="ORB OI RESULTS - INPT" D OI
"RTN","ORB3SPEC",36,0)
 .I ORN=41 S ORPAR="ORB OI ORDERED - INPT" D OI
"RTN","ORB3SPEC",37,0)
 .I ORN=64 S ORPAR="ORB OI EXPIRING - INPT" D OI
"RTN","ORB3SPEC",38,0)
 ;
"RTN","ORB3SPEC",39,0)
 I ORPTLOC="O" D  ;outpt flagged OI notifs
"RTN","ORB3SPEC",40,0)
 .I ORN=60 S ORPAR="ORB OI RESULTS - OUTPT" D OI
"RTN","ORB3SPEC",41,0)
 .I ORN=61 S ORPAR="ORB OI ORDERED - OUTPT" D OI
"RTN","ORB3SPEC",42,0)
 .I ORN=65 S ORPAR="ORB OI EXPIRING - OUTPT" D OI
"RTN","ORB3SPEC",43,0)
 ;
"RTN","ORB3SPEC",44,0)
 I ORN=3!(ORN=14)!(ORN=44)!(ORN=57) D  ;lab results notifs
"RTN","ORB3SPEC",45,0)
 .D LRALRTS(ORN,ORDFN,ORDATA,.ORBSMSG,ORBMSG)
"RTN","ORB3SPEC",46,0)
 ;
"RTN","ORB3SPEC",47,0)
 I ORN=33 D  ;requested results notif
"RTN","ORB3SPEC",48,0)
 .I $D(ORBU) D
"RTN","ORB3SPEC",49,0)
 ..S ORBU(ORBUI)=" ",ORBUI=ORBUI+1
"RTN","ORB3SPEC",50,0)
 ..S ORBU(ORBUI)="Potential Orderer-flagged Results recipient: ",ORBUI=ORBUI+1
"RTN","ORB3SPEC",51,0)
 .N RECIP
"RTN","ORB3SPEC",52,0)
 .S RECIP=$$RSLTFLG^ORQOR2(ORNUM)
"RTN","ORB3SPEC",53,0)
 .I +$G(RECIP)>0 D
"RTN","ORB3SPEC",54,0)
 ..S ORBASPEC(+$G(RECIP))=""
"RTN","ORB3SPEC",55,0)
 ..I $D(ORBU) N NODE S NODE=$G(^VA(200,+$G(RECIP),0)) I $L(NODE) D
"RTN","ORB3SPEC",56,0)
 ...S ORBU(ORBUI)="   "_$P(NODE,U)_" is a potential recipient.",ORBUI=ORBUI+1
"RTN","ORB3SPEC",57,0)
 Q
"RTN","ORB3SPEC",58,0)
OI ;get potential recips for OI-flagged notifs
"RTN","ORB3SPEC",59,0)
 N OROI,ORLST,ORERR,ORBX,ORBZ,ORBE,ORBDUZ,ORBDEV,ORBUF
"RTN","ORB3SPEC",60,0)
 S OROI=+$G(^OR(100,+$G(ORNUM),.1,1,0))  ;get oi
"RTN","ORB3SPEC",61,0)
 I ORN=41,$G(ORDATA) S OROI=ORDATA
"RTN","ORB3SPEC",62,0)
 I ORN=61,$G(ORDATA) S OROI=ORDATA
"RTN","ORB3SPEC",63,0)
 I ORN=64,$G(ORDATA) S OROI=ORDATA
"RTN","ORB3SPEC",64,0)
 I ORN=65,$G(ORDATA) S OROI=ORDATA
"RTN","ORB3SPEC",65,0)
 Q:+$G(OROI)<0
"RTN","ORB3SPEC",66,0)
 I $D(ORBU) D
"RTN","ORB3SPEC",67,0)
 .S ORBU(ORBUI)=" ",ORBUI=ORBUI+1
"RTN","ORB3SPEC",68,0)
 .S ORBU(ORBUI)="Special potential recipients from parameter: "_ORPAR,ORBUI=ORBUI+1
"RTN","ORB3SPEC",69,0)
 S ORBE=0,ORBX=0
"RTN","ORB3SPEC",70,0)
 ;
"RTN","ORB3SPEC",71,0)
 ;process special recip users, teams and devices:
"RTN","ORB3SPEC",72,0)
 D ENVAL^XPAR(.ORLST,ORPAR,"`"_OROI,.ORERR)
"RTN","ORB3SPEC",73,0)
 I 'ORERR,$G(ORLST)>0 D
"RTN","ORB3SPEC",74,0)
 .F ORBX=1:1:ORLST S ORBE=$O(ORLST(ORBE)),ORBZ=$P(ORBE,";",2),ORBUF=0 D
"RTN","ORB3SPEC",75,0)
 ..;
"RTN","ORB3SPEC",76,0)
 ..; process USERS:
"RTN","ORB3SPEC",77,0)
 ..I ORBZ="VA(200," S ORBDUZ=$P(ORBE,";") I $L(ORBDUZ) D
"RTN","ORB3SPEC",78,0)
 ...I ORLST(ORBE,OROI)=1 S ORBASPEC(ORBDUZ)="",ORBUF=1
"RTN","ORB3SPEC",79,0)
 ...I ORLST(ORBE,OROI)=0,$$PPLINK^ORQPTQ1(ORBDUZ,ORDFN) S ORBASPEC(ORBDUZ)="",ORBUF=1
"RTN","ORB3SPEC",80,0)
 ...I $D(ORBU),ORBUF=1 N NODE S NODE=$G(^VA(200,ORBDUZ,0)) I $L(NODE) D
"RTN","ORB3SPEC",81,0)
 ....S ORBU(ORBUI)="   "_$P(NODE,U)_" is a potential recipient.",ORBUI=ORBUI+1
"RTN","ORB3SPEC",82,0)
 ..;
"RTN","ORB3SPEC",83,0)
 ..; process DEVICES:
"RTN","ORB3SPEC",84,0)
 ..I ORBZ="%ZIS(1," S ORBDEV=$P(ORBE,";") I $L(ORBDEV),$D(^%ZIS(1,ORBDEV))>0 D
"RTN","ORB3SPEC",85,0)
 ...S ORBDEV=$G(^%ZIS(1,ORBDEV,0)) I $D(ORBDEV) D
"RTN","ORB3SPEC",86,0)
 ....I ORLST(ORBE,OROI)=1 S ORBSDEV($P(ORBDEV,U))="",ORBUF=1
"RTN","ORB3SPEC",87,0)
 ....I ORLST(ORBE,OROI)=0,$$PDLINK^ORQPTQ1(ORBDEV,ORDFN) S ORBSDEV($P(ORBDEV,U))="",ORBUF=1
"RTN","ORB3SPEC",88,0)
 ....I $D(ORBU),ORBUF=1 D
"RTN","ORB3SPEC",89,0)
 .....S ORBU(ORBUI)="   "_$P(ORBDEV,U)_" is a device recipient.",ORBUI=ORBUI+1
"RTN","ORB3SPEC",90,0)
 ..;
"RTN","ORB3SPEC",91,0)
 ..; process TEAMS:
"RTN","ORB3SPEC",92,0)
 ..I ORBZ="OR(100.21," D SPECTEAM(ORBE)
"RTN","ORB3SPEC",93,0)
 D TITLE(OROI,ORPAR)
"RTN","ORB3SPEC",94,0)
 Q
"RTN","ORB3SPEC",95,0)
SPECTEAM(ORBE) ;get special team recips
"RTN","ORB3SPEC",96,0)
 N ORBLST,IJ,ORBTM
"RTN","ORB3SPEC",97,0)
 S ORBTM=$P(ORBE,";")
"RTN","ORB3SPEC",98,0)
 D TEAMPROV^ORQPTQ1(.ORBLST,ORBTM)
"RTN","ORB3SPEC",99,0)
 I $D(ORBU) N TNODE S TNODE=$G(^OR(100.21,ORBTM,0)) I $L(TNODE) D
"RTN","ORB3SPEC",100,0)
 .S ORBU(ORBUI)="   Team potential recipients from team "_$P(TNODE,U)_":",ORBUI=ORBUI+1
"RTN","ORB3SPEC",101,0)
 I +$G(ORBLST(1))>0 S IJ="" F  S IJ=$O(ORBLST(IJ)) Q:IJ=""  D
"RTN","ORB3SPEC",102,0)
 .S ORBDUZ=$P(ORBLST(IJ),U),ORBUF=0 I $L(ORBDUZ) D
"RTN","ORB3SPEC",103,0)
 ..I ORLST(ORBE,OROI)=1 S ORBASPEC(ORBDUZ_U_ORBTM)="",ORBUF=1
"RTN","ORB3SPEC",104,0)
 ..I ORLST(ORBE,OROI)=0,$D(^OR(100.21,ORBTM,10,"B",ORDFN_";DPT(")) S ORBASPEC(ORBDUZ_U_ORBTM)="",ORBUF=1
"RTN","ORB3SPEC",105,0)
 ..I $D(ORBU),ORBUF=1 N NODE S NODE=$G(^VA(200,ORBDUZ,0)) I $L(NODE) D
"RTN","ORB3SPEC",106,0)
 ...S ORBU(ORBUI)="     "_$P(NODE,U),ORBUI=ORBUI+1
"RTN","ORB3SPEC",107,0)
 ;
"RTN","ORB3SPEC",108,0)
 S ORBTD=$P($$TMDEV^ORB31(ORBTM),U,2)  ;tm's device
"RTN","ORB3SPEC",109,0)
 I $L(ORBTD) D
"RTN","ORB3SPEC",110,0)
 .S ORBSDEV(ORBTD)=""
"RTN","ORB3SPEC",111,0)
 .I $D(ORBU) D
"RTN","ORB3SPEC",112,0)
 ..S ORBU(ORBUI)="   Team's Device "_ORBTD_" is a recipient",ORBUI=ORBUI+1
"RTN","ORB3SPEC",113,0)
 Q
"RTN","ORB3SPEC",114,0)
LRALRTS(ORN,ORDFN,ORDATA,ORBSMSG,ORBMSG) ;find & delete matching alerts and gather recips
"RTN","ORB3SPEC",115,0)
 ; ORN: notif ien
"RTN","ORB3SPEC",116,0)
 ; ORDFN: pt id
"RTN","ORB3SPEC",117,0)
 ; ORDATA: pkg data
"RTN","ORB3SPEC",118,0)
 ; ORBSMSG: special notif msg rtn by LRALRTS
"RTN","ORB3SPEC",119,0)
 ; ORBMSG: original notif msg
"RTN","ORB3SPEC",120,0)
 ;
"RTN","ORB3SPEC",121,0)
 Q:+$G(ORN)<1
"RTN","ORB3SPEC",122,0)
 Q:+$G(ORDFN)<1
"RTN","ORB3SPEC",123,0)
 Q:+$G(ORDATA)<1
"RTN","ORB3SPEC",124,0)
 N LRID,ORY,I,J,XQAID,XQ0,XQ1,ORNE,RECIP,ORDATAE,LRIDE,STDATE
"RTN","ORB3SPEC",125,0)
 N ORTST,ORBMSGE,ORBMSGX,TXQAID,XQF,ORBHX,ORX,ORBI,ORTSTE
"RTN","ORB3SPEC",126,0)
 ;
"RTN","ORB3SPEC",127,0)
 S LRID=$P($P(ORDATA,"|",2),"@")  ;get lab unique results id (OE IDE)
"RTN","ORB3SPEC",128,0)
 Q:+$G(LRID)<1
"RTN","ORB3SPEC",129,0)
 ;
"RTN","ORB3SPEC",130,0)
 ;get pt's alerts within 24 hours:
"RTN","ORB3SPEC",131,0)
 S STDATE=$$FMADD^XLFDT($$NOW^XLFDT,"","-24","","")
"RTN","ORB3SPEC",132,0)
 D PATIENT^XQALERT("ORY",ORDFN,STDATE,"") ;get pt's alerts
"RTN","ORB3SPEC",133,0)
 ;
"RTN","ORB3SPEC",134,0)
 ;look for pt's alerts with same notif ien and unique lab results id:
"RTN","ORB3SPEC",135,0)
 F I=1:1:ORY D
"RTN","ORB3SPEC",136,0)
 .S XQAID=$P(ORY(I),U,2)
"RTN","ORB3SPEC",137,0)
 .S ORBMSGX=$P(ORY(I),U)
"RTN","ORB3SPEC",138,0)
 .S ORNE=$P($P(XQAID,";"),",",3)  ;get notif ien
"RTN","ORB3SPEC",139,0)
 .Q:ORNE'=ORN
"RTN","ORB3SPEC",140,0)
 .;
"RTN","ORB3SPEC",141,0)
 .;find matching alert:
"RTN","ORB3SPEC",142,0)
 .D AHISTORY^XQALBUTL(XQAID,"ORBHX")
"RTN","ORB3SPEC",143,0)
 .S ORDATAE=$G(ORBHX(2))
"RTN","ORB3SPEC",144,0)
 .Q:'$L(ORDATAE)
"RTN","ORB3SPEC",145,0)
 .S LRIDE=$P($P(ORDATAE,"|",2),"@")  ;get lab rslts id from existng alert
"RTN","ORB3SPEC",146,0)
 .Q:LRIDE'=LRID
"RTN","ORB3SPEC",147,0)
 .;
"RTN","ORB3SPEC",148,0)
 .S:ORBMSG["[" ORTST=$P($P(ORBMSG,"[",2),"]")
"RTN","ORB3SPEC",149,0)
 .I ORBMSG'["[" D
"RTN","ORB3SPEC",150,0)
 ..S:ORBMSG["labs: " ORTST=$P(ORBMSG,"labs: ",2)
"RTN","ORB3SPEC",151,0)
 ..S:ORBMSG["results: " ORTST=$P(ORBMSG,"results: ",2)
"RTN","ORB3SPEC",152,0)
 .;
"RTN","ORB3SPEC",153,0)
 .S ORBMSGE=$P(ORBMSGX,"): ",2)
"RTN","ORB3SPEC",154,0)
 .S:ORBMSGE["[" ORTSTE=$P($P(ORBMSGE,"[",2),"]")  ;added to fix CQ #17548 (Part A) for CPRS v28.1 (TC).
"RTN","ORB3SPEC",155,0)
 .;added to fix CQ #19497: undefined ORTSTE variable [v28.17] (TC)
"RTN","ORB3SPEC",156,0)
 .I ORBMSGE'["[" D
"RTN","ORB3SPEC",157,0)
 ..S:ORBMSGE["labs: " ORTSTE=$P(ORBMSGE,"labs: ",2)
"RTN","ORB3SPEC",158,0)
 ..S:ORBMSGE["results: " ORTSTE=$P(ORBMSGE,"results: ",2)
"RTN","ORB3SPEC",159,0)
 .E  S ORTSTE=""
"RTN","ORB3SPEC",160,0)
 .;
"RTN","ORB3SPEC",161,0)
 .S ORX=0
"RTN","ORB3SPEC",162,0)
 .;if alert has recips, get recips from existing alert:
"RTN","ORB3SPEC",163,0)
 .S:$L($G(ORBHX(20,0))) ORX=$P(ORBHX(20,0),U,4)
"RTN","ORB3SPEC",164,0)
 .F ORBI=1:1:ORX D
"RTN","ORB3SPEC",165,0)
 ..S RECIP=+ORBHX(20,ORBI,0)
"RTN","ORB3SPEC",166,0)
 ..S ORBASPEC(RECIP)=""  ;add recip to new alert recip list
"RTN","ORB3SPEC",167,0)
 .;
"RTN","ORB3SPEC",168,0)
 .;delete existing alert:
"RTN","ORB3SPEC",169,0)
 .S XQAKILL=0  ;delete for all recips
"RTN","ORB3SPEC",170,0)
 .D DELETE^XQALERT
"RTN","ORB3SPEC",171,0)
 .K XQAKILL,XQAID
"RTN","ORB3SPEC",172,0)
 ;
"RTN","ORB3SPEC",173,0)
 ;if NO prev alert msg for this pt, notif, lab unique id:
"RTN","ORB3SPEC",174,0)
 I '$L($G(ORBMSGE)) S ORBSMSG=ORBMSG
"RTN","ORB3SPEC",175,0)
 ;
"RTN","ORB3SPEC",176,0)
 ;if prev alert msg for this pt, notif, lab unique id:
"RTN","ORB3SPEC",177,0)
 I $L($G(ORBMSGE)) D
"RTN","ORB3SPEC",178,0)
 .;S:ORBMSGE["[" ORBSMSG=$P(ORBMSGE,"]")_", "_ORTST_"]"
"RTN","ORB3SPEC",179,0)
 .S ORBSMSG=$S(ORBMSGE["["&(ORTSTE'=ORTST):$P(ORBMSGE,"]")_", "_ORTST_"]",(ORBMSGE'["[")&(ORTSTE'=ORTST):ORBMSGE_", "_ORTST,1:ORBMSGE) ;added to fix CQ #17548 (Part A) for CPRS v28.1 (TC).
"RTN","ORB3SPEC",180,0)
 .;S:ORBMSGE'["[" ORBSMSG=ORBMSGE_", "_ORTST
"RTN","ORB3SPEC",181,0)
 ;
"RTN","ORB3SPEC",182,0)
 Q
"RTN","ORB3SPEC",183,0)
 ;
"RTN","ORB3SPEC",184,0)
TITLE(OROI,ORPAR) ;get provider recips
"RTN","ORB3SPEC",185,0)
 N ORTIT
"RTN","ORB3SPEC",186,0)
 I $D(ORBU) D
"RTN","ORB3SPEC",187,0)
 .S ORBU(ORBUI)=" ",ORBUI=ORBUI+1
"RTN","ORB3SPEC",188,0)
 .S ORBU(ORBUI)="Special potential recipients from parameter: "_ORPAR_" PR",ORBUI=ORBUI+1
"RTN","ORB3SPEC",189,0)
 ;
"RTN","ORB3SPEC",190,0)
 ;process special recip users, teams and devices for Provider Recipients
"RTN","ORB3SPEC",191,0)
 S ORTIT=$$GET^XPAR("ALL",ORPAR_" PR","`"_OROI,"E")
"RTN","ORB3SPEC",192,0)
 Q:'$L(ORTIT)
"RTN","ORB3SPEC",193,0)
 I ORTIT["P" D PRIMARY
"RTN","ORB3SPEC",194,0)
 I ORTIT["A" D ATTEND
"RTN","ORB3SPEC",195,0)
 I ORTIT["T" D TEAMS
"RTN","ORB3SPEC",196,0)
 I ORTIT["O" D ORDERER
"RTN","ORB3SPEC",197,0)
 I ORTIT["E" D ENTERBY
"RTN","ORB3SPEC",198,0)
 I ORTIT["R" D PCMMPRIM
"RTN","ORB3SPEC",199,0)
 I ORTIT["S" D PCMMASSC
"RTN","ORB3SPEC",200,0)
 I ORTIT["M" D PCMMTEAM
"RTN","ORB3SPEC",201,0)
 I ORTIT["C" D PCMMMHTC
"RTN","ORB3SPEC",202,0)
 Q
"RTN","ORB3SPEC",203,0)
PRIMARY ;
"RTN","ORB3SPEC",204,0)
 I $D(ORBU),+$G(ORBPRIM)>0 S ORBU(ORBUI)=" Flagged OI Inpt primary provider:",ORBUI=ORBUI+1
"RTN","ORB3SPEC",205,0)
 I $D(ORBU),+$G(ORBPRIM)<1 S ORBU(ORBUI)=" Flagged OI Inpt primary provider: option cannot determine without A/D/T event data.",ORBUI=ORBUI+1
"RTN","ORB3SPEC",206,0)
 I +$G(ORBPRIM)>0 S ORBASPEC(ORBPRIM)=""
"RTN","ORB3SPEC",207,0)
 Q
"RTN","ORB3SPEC",208,0)
ATTEND ;
"RTN","ORB3SPEC",209,0)
 I $D(ORBU),+$G(ORBATTD)>0 S ORBU(ORBUI)=" Flagged OI Attending physician:",ORBUI=ORBUI+1
"RTN","ORB3SPEC",210,0)
 I $D(ORBU),+$G(ORBATTD)<1 S ORBU(ORBUI)=" Flagged OI Attending physician: option cannot determine without A/D/T event data.",ORBUI=ORBUI+1
"RTN","ORB3SPEC",211,0)
 I +$G(ORBATTD)>0 S ORBASPEC(ORBATTD)=""
"RTN","ORB3SPEC",212,0)
 Q
"RTN","ORB3SPEC",213,0)
TEAMS ;
"RTN","ORB3SPEC",214,0)
 N ORBLST,ORBI,ORBJ,ORBTM,ORBTNAME,ORBTTYPE,ORBTD
"RTN","ORB3SPEC",215,0)
 I $D(ORBU) S ORBU(ORBUI)=" Flagged OI Teams/Personal Lists related to patient:",ORBUI=ORBUI+1
"RTN","ORB3SPEC",216,0)
 D TMSPT^ORQPTQ1(.ORBLST,ORDFN)
"RTN","ORB3SPEC",217,0)
 Q:+$G(ORBLST(1))<1
"RTN","ORB3SPEC",218,0)
 S ORBI="" F  S ORBI=$O(ORBLST(ORBI)) Q:ORBI=""  D
"RTN","ORB3SPEC",219,0)
 .S ORBTM=$P(ORBLST(ORBI),U),ORBTNAME=$P(ORBLST(ORBI),U,2)
"RTN","ORB3SPEC",220,0)
 .S ORBTTYPE=$P(ORBLST(ORBI),U,3)
"RTN","ORB3SPEC",221,0)
 .I $D(ORBU) D
"RTN","ORB3SPEC",222,0)
 ..S ORBU(ORBUI)="  Patient list "_ORBTNAME_" ["_ORBTTYPE_"]:",ORBUI=ORBUI+1
"RTN","ORB3SPEC",223,0)
 .N ORBLST2 D TEAMPROV^ORQPTQ1(.ORBLST2,ORBTM)
"RTN","ORB3SPEC",224,0)
 .Q:+$G(ORBLST2(1))<1
"RTN","ORB3SPEC",225,0)
 .S ORBJ="" F  S ORBJ=$O(ORBLST2(ORBJ)) Q:ORBJ=""  D
"RTN","ORB3SPEC",226,0)
 ..S ORBDUZ=$P(ORBLST2(ORBJ),U)_U_ORBTM I +$G(ORBDUZ)>0 S ORBASPEC(ORBDUZ)=""
"RTN","ORB3SPEC",227,0)
 .S ORBTD=$P($$TMDEV^ORB31(ORBTM),U,2)  ;tm's device
"RTN","ORB3SPEC",228,0)
 .I $L(ORBTD) D
"RTN","ORB3SPEC",229,0)
 ..S ORBSDEV(ORBTD)=""
"RTN","ORB3SPEC",230,0)
 ..I $D(ORBU) D
"RTN","ORB3SPEC",231,0)
 ...S ORBU(ORBUI)="   Team's Device "_ORBTD_" is a recipient",ORBUI=ORBUI+1
"RTN","ORB3SPEC",232,0)
 Q
"RTN","ORB3SPEC",233,0)
ORDERER ;
"RTN","ORB3SPEC",234,0)
 N ORBDUZ
"RTN","ORB3SPEC",235,0)
 I $D(ORBU) S ORBU(ORBUI)=" Flagged OI Ordering provider:",ORBUI=ORBUI+1
"RTN","ORB3SPEC",236,0)
 Q:+$G(ORNUM)<1
"RTN","ORB3SPEC",237,0)
 S ORBDUZ=$$ORDERER^ORQOR2(ORNUM)
"RTN","ORB3SPEC",238,0)
 I +$G(ORBDUZ)>0 D
"RTN","ORB3SPEC",239,0)
 .S ORBASPEC(ORBDUZ)=""
"RTN","ORB3SPEC",240,0)
 Q
"RTN","ORB3SPEC",241,0)
ENTERBY ;
"RTN","ORB3SPEC",242,0)
 N ORBDUZ
"RTN","ORB3SPEC",243,0)
 I $D(ORBU) S ORBU(ORBUI)=" Flagged OI User entering order's most recent activity:",ORBUI=ORBUI+1
"RTN","ORB3SPEC",244,0)
 Q:+$G(ORNUM)<1
"RTN","ORB3SPEC",245,0)
 I $D(^OR(100,ORNUM,8,0)) D
"RTN","ORB3SPEC",246,0)
 .S ORBDUZ=$P(^OR(100,ORNUM,8,$P(^OR(100,ORNUM,8,0),U,3),0),U,13)
"RTN","ORB3SPEC",247,0)
 I +$G(ORBDUZ)>0 S ORBASPEC(ORBDUZ)=""
"RTN","ORB3SPEC",248,0)
 Q
"RTN","ORB3SPEC",249,0)
PCMMPRIM ;
"RTN","ORB3SPEC",250,0)
 N ORBDUZ
"RTN","ORB3SPEC",251,0)
 I $D(ORBU) S ORBU(ORBUI)=" Flagged OI PCMM Primary Care Practitioner:",ORBUI=ORBUI+1
"RTN","ORB3SPEC",252,0)
 S ORBDUZ=+$$OUTPTPR^SDUTL3(ORDFN,$$NOW^XLFDT,1)  ;DBIA #1252
"RTN","ORB3SPEC",253,0)
 I +$G(ORBDUZ)>0 S ORBASPEC(ORBDUZ)=""
"RTN","ORB3SPEC",254,0)
 Q
"RTN","ORB3SPEC",255,0)
PCMMASSC ;
"RTN","ORB3SPEC",256,0)
 N ORBDUZ
"RTN","ORB3SPEC",257,0)
 I $D(ORBU) S ORBU(ORBUI)=" Flagged OI PCMM Associate Provider:",ORBUI=ORBUI+1
"RTN","ORB3SPEC",258,0)
 S ORBDUZ=+$$OUTPTAP^SDUTL3(ORDFN,$$NOW^XLFDT)  ;DBIA #1252
"RTN","ORB3SPEC",259,0)
 I +$G(ORBDUZ)>0 S ORBASPEC(ORBDUZ)=""
"RTN","ORB3SPEC",260,0)
 Q
"RTN","ORB3SPEC",261,0)
PCMMTEAM ;
"RTN","ORB3SPEC",262,0)
 N ORPCMM,ORPCMMDZ,ORBDUZ
"RTN","ORB3SPEC",263,0)
 I $D(ORBU) S ORBU(ORBUI)=" Flagged OI PCMM Team Position Assignments:",ORBUI=ORBUI+1
"RTN","ORB3SPEC",264,0)
 S ORPCMM=$$PRPT^SCAPMC(ORDFN,,,,,,"^TMP(""ORPCMM"",$J)",)  ;DBIA #1916
"RTN","ORB3SPEC",265,0)
 S ORPCMMDZ=0
"RTN","ORB3SPEC",266,0)
 F  S ORPCMMDZ=$O(^TMP("ORPCMM",$J,"SCPR",ORPCMMDZ)) Q:'ORPCMMDZ  D
"RTN","ORB3SPEC",267,0)
 .S ORBDUZ=ORPCMMDZ S ORBASPEC(ORBDUZ)=""
"RTN","ORB3SPEC",268,0)
 K ^TMP("ORPCMM",$J)
"RTN","ORB3SPEC",269,0)
 Q
"RTN","ORB3SPEC",270,0)
PCMMMHTC ;
"RTN","ORB3SPEC",271,0)
 N ORBDUZ
"RTN","ORB3SPEC",272,0)
 I $D(ORBU) S ORBU(ORBUI)=" Flagged OI PCMM Mental Health Treatment Coordinator:",ORBUI=ORBUI+1
"RTN","ORB3SPEC",273,0)
 S ORBDUZ=+$$START^SCMCMHTC(ORBDFN)  ;DBIA #5697
"RTN","ORB3SPEC",274,0)
 I +$G(ORBDUZ)>0 S ORBASPEC(ORBDUZ)=""
"RTN","ORB3SPEC",275,0)
 Q
"RTN","ORB3TIM2")
0^1^B48303565^B43382102
"RTN","ORB3TIM2",1,0)
ORB3TIM2 ;SLC/CLA - Routine to trigger time-related notifications ; 9/27/17 1:13pm
"RTN","ORB3TIM2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**102,215,251,265,356,350,450**;Dec 17, 1997;Build 14
"RTN","ORB3TIM2",3,0)
 ;;Per VA Directive 6402, this routine should not be modified.
"RTN","ORB3TIM2",4,0)
 ;
"RTN","ORB3TIM2",5,0)
 ;DBIA SECTION
"RTN","ORB3TIM2",6,0)
 ;10035 - ^DPT(
"RTN","ORB3TIM2",7,0)
 ;10003 - ^%DPT
"RTN","ORB3TIM2",8,0)
 ;10006 - ^DIC
"RTN","ORB3TIM2",9,0)
 ;  325 - ^VADPT2
"RTN","ORB3TIM2",10,0)
 ;10103 - ^XLFDT
"RTN","ORB3TIM2",11,0)
 ; 2263 - ^XPAR
"RTN","ORB3TIM2",12,0)
 ;
"RTN","ORB3TIM2",13,0)
EXPIR ;trigger expiring order notifs
"RTN","ORB3TIM2",14,0)
 N EDT,EXDT,EXORN,ORBDNR,ORPT,ORBRSLT,RXORD,ORLASTDT,X,Y,%DT
"RTN","ORB3TIM2",15,0)
 N OIFILE,ORBY,ORBZ,ORBI,ORSCH,ORSCHFIL,ONETIME,ORST,ORNG,ORDT,ORDW,ORHOL
"RTN","ORB3TIM2",16,0)
 N EXOI,ORBLST,ORBERR,OITXT,PTLOC,ORSDT,ORNOW,ORLDT
"RTN","ORB3TIM2",17,0)
 ;
"RTN","ORB3TIM2",18,0)
 S ORNOW=$$NOW^XLFDT
"RTN","ORB3TIM2",19,0)
 ;
"RTN","ORB3TIM2",20,0)
 I '$D(^XTMP("ORB LAST EXPIRE")) D  ;holds last dt EXPIR processed
"RTN","ORB3TIM2",21,0)
 .S ^XTMP("ORB LAST EXPIRE",0)=$$FMADD^XLFDT(ORNOW,7,"","","")_U
"RTN","ORB3TIM2",22,0)
 ;
"RTN","ORB3TIM2",23,0)
 ;determine number of days to return orders using day of week & holidays
"RTN","ORB3TIM2",24,0)
 F ORNG=1:1 D  I ORHOL=0,ORDW=0 Q
"RTN","ORB3TIM2",25,0)
 .S ORDW=$S($H-4+ORNG#7>4:1,1:0)          ;if Sat or Sun, ORDW=0
"RTN","ORB3TIM2",26,0)
 .S ORDT=$$FMADD^XLFDT(DT,ORNG)
"RTN","ORB3TIM2",27,0)
 .K DIC S DIC="^HOLIDAY(",X=ORDT D ^DIC
"RTN","ORB3TIM2",28,0)
 .S ORHOL=$S(+$G(Y)>0:1,1:0)              ;if ORDT is a holiday, ORHOL=0
"RTN","ORB3TIM2",29,0)
 S %DT="",X="T+"_ORNG D ^%DT
"RTN","ORB3TIM2",30,0)
 S EDT=Y_".2400"
"RTN","ORB3TIM2",31,0)
 K DIC
"RTN","ORB3TIM2",32,0)
 ;
"RTN","ORB3TIM2",33,0)
 ;get DNR OIs:
"RTN","ORB3TIM2",34,0)
 S OIFILE=$$TERMLKUP^ORB31(.ORBY,"DNR")
"RTN","ORB3TIM2",35,0)
 ;
"RTN","ORB3TIM2",36,0)
 ;get local admin schedules for ONE TIME MED:
"RTN","ORB3TIM2",37,0)
 S ORSCHFIL=$$TERMLKUP^ORB31(.ORBZ,"ONE TIME MED")
"RTN","ORB3TIM2",38,0)
 ;
"RTN","ORB3TIM2",39,0)
 ;examine expiring orders:
"RTN","ORB3TIM2",40,0)
 S ORLASTDT=$P(^XTMP("ORB LAST EXPIRE",0),U,2)
"RTN","ORB3TIM2",41,0)
 S EXDT=$S($L(ORLASTDT):ORLASTDT,1:ORNOW)
"RTN","ORB3TIM2",42,0)
 F  S EXDT=$O(^OR(100,"AE",EXDT)) Q:(EXDT="")  D  Q:ORBRSLT<0
"RTN","ORB3TIM2",43,0)
 .S ORBRSLT=$$FMDIFF^XLFDT(EDT,$P(EXDT,".")_".2400",2)  ;diff in seconds
"RTN","ORB3TIM2",44,0)
 .Q:ORBRSLT<0
"RTN","ORB3TIM2",45,0)
 .S EXORN="" F  S EXORN=$O(^OR(100,"AE",EXDT,EXORN)) Q:EXORN=""  D
"RTN","ORB3TIM2",46,0)
 ..;
"RTN","ORB3TIM2",47,0)
 ..;*356 Protect, if x-ref dangles.
"RTN","ORB3TIM2",48,0)
 ..I '$D(^OR(100,EXORN)) K ^OR(100,"AE",EXDT,EXORN) Q
"RTN","ORB3TIM2",49,0)
 ..;
"RTN","ORB3TIM2",50,0)
 ..;Quit if isn't at least next day after order's Date of Last Activity:
"RTN","ORB3TIM2",51,0)
 ..S ORLDT=$P(^OR(100,EXORN,3),U)
"RTN","ORB3TIM2",52,0)
 ..Q:$$FMDIFF^XLFDT(ORNOW,ORLDT)<1
"RTN","ORB3TIM2",53,0)
 ..;
"RTN","ORB3TIM2",54,0)
 ..Q:$D(^XTMP("ORB LAST EXPIRE",EXORN))  ;quit if order already processed
"RTN","ORB3TIM2",55,0)
 ..S ^XTMP("ORB LAST EXPIRE",EXORN)=EXDT
"RTN","ORB3TIM2",56,0)
 ..;
"RTN","ORB3TIM2",57,0)
 ..S ORPT=$$PT^ORQOR2(EXORN)   ; get pt assoc w/order
"RTN","ORB3TIM2",58,0)
 ..Q:+$G(ORPT)<1
"RTN","ORB3TIM2",59,0)
 ..;
"RTN","ORB3TIM2",60,0)
 ..Q:+$G(^DPT(ORPT,.35))>0  ; quit if pt deceased - DBIA #10035
"RTN","ORB3TIM2",61,0)
 ..;
"RTN","ORB3TIM2",62,0)
 ..S PTLOC=$G(^DPT(+$G(ORPT),.1)),PTLOC=$S($L(PTLOC):PTLOC,1:"OUTPT")
"RTN","ORB3TIM2",63,0)
 ..;
"RTN","ORB3TIM2",64,0)
 ..; is expiring order a DNR order:
"RTN","ORB3TIM2",65,0)
 ..I $D(ORBY),(+$G(OIFILE)=101.43) D
"RTN","ORB3TIM2",66,0)
 ...F ORBI=1:1:ORBY D
"RTN","ORB3TIM2",67,0)
 ....S ORBDNR=$P(ORBY(ORBI),U) I ORBDNR=$$OI^ORQOR2(EXORN) D
"RTN","ORB3TIM2",68,0)
 .....S ORST=$P($$STATUS^ORQOR2(EXORN),U,2)
"RTN","ORB3TIM2",69,0)
 .....I ORST'="DISCONTINUED",ORST'="COMPLETE",ORST'="EXPIRED",ORST'="CANCELLED",ORST'="DISCONTINUED/EDIT" D
"RTN","ORB3TIM2",70,0)
 ......D EN^ORB3(45,ORPT,EXORN,"","",EXORN_"@") ;trigger DNR notif
"RTN","ORB3TIM2",71,0)
 ..;
"RTN","ORB3TIM2",72,0)
 ..; is expiring order a flagged oi:
"RTN","ORB3TIM2",73,0)
 ..;S EXOI=$$OI^ORQOR2(EXORN) I +$G(EXOI)>0 D
"RTN","ORB3TIM2",74,0)
 ..;patch 450, all items not being checked
"RTN","ORB3TIM2",75,0)
 ..S EXOIC=0
"RTN","ORB3TIM2",76,0)
 ..F  S EXOIC=$O(^OR(100,EXORN,.1,EXOIC)) Q:EXOIC=""  D
"RTN","ORB3TIM2",77,0)
 ...S EXOI=$G(^OR(100,EXORN,.1,EXOIC,0))
"RTN","ORB3TIM2",78,0)
 ...I $L(PTLOC),PTLOC'="OUTPT",+$G(EXOI)>0 D
"RTN","ORB3TIM2",79,0)
 ....D ENVAL^XPAR(.ORBLST,"ORB OI EXPIRING - INPT","`"_EXOI,.ORBERR)
"RTN","ORB3TIM2",80,0)
 ....I 'ORBERR,'$G(ORBLST) D ENVAL^XPAR(.ORBLST,"ORB OI EXPIRING - INPT PR","`"_EXOI,.ORBERR)
"RTN","ORB3TIM2",81,0)
 ....I 'ORBERR,$G(ORBLST)>0 D
"RTN","ORB3TIM2",82,0)
 .....S OITXT=$P(^ORD(101.43,EXOI,0),U)
"RTN","ORB3TIM2",83,0)
 .....S ORSDT=$P(^OR(100,EXORN,0),U,8),ORSDT=$$FMTE^XLFDT(ORSDT,"2P")
"RTN","ORB3TIM2",84,0)
 .....D EN^ORB3(64,ORPT,EXORN,"","["_PTLOC_"] Order expiring: "_OITXT_" "_ORSDT,EXOI) ;trigger Expiring Flagged OI - INPT notification
"RTN","ORB3TIM2",85,0)
 ...;
"RTN","ORB3TIM2",86,0)
 ...I $L(PTLOC),PTLOC="OUTPT" D
"RTN","ORB3TIM2",87,0)
 ....D ENVAL^XPAR(.ORBLST,"ORB OI EXPIRING - OUTPT","`"_EXOI,.ORBERR)
"RTN","ORB3TIM2",88,0)
 ....;*356 Add OUTPT PR
"RTN","ORB3TIM2",89,0)
 ....I 'ORBERR,'$G(ORBLST) D ENVAL^XPAR(.ORBLST,"ORB OI EXPIRING - OUTPT PR","`"_EXOI,.ORBERR)
"RTN","ORB3TIM2",90,0)
 ....I 'ORBERR,$G(ORBLST)>0 D
"RTN","ORB3TIM2",91,0)
 .....S OITXT=$P(^ORD(101.43,EXOI,0),U)
"RTN","ORB3TIM2",92,0)
 .....S ORSDT=$P(^OR(100,EXORN,0),U,8),ORSDT=$$FMTE^XLFDT(ORSDT,"2P")
"RTN","ORB3TIM2",93,0)
 .....D EN^ORB3(65,ORPT,EXORN,"","["_PTLOC_"] Order expiring: "_OITXT_" "_ORSDT,EXOI) ;trigger Expiring Flagged OI - OUTPT notification
"RTN","ORB3TIM2",94,0)
 ..;
"RTN","ORB3TIM2",95,0)
 ..;is expiring order a med order:
"RTN","ORB3TIM2",96,0)
 ..S RXORD=$$DGRX^ORQOR2(EXORN)
"RTN","ORB3TIM2",97,0)
 ..I $L(RXORD) D  ;if expiring order is a med order
"RTN","ORB3TIM2",98,0)
 ...;
"RTN","ORB3TIM2",99,0)
 ...N DFN S DFN=ORPT
"RTN","ORB3TIM2",100,0)
 ...D ADM^VADPT2
"RTN","ORB3TIM2",101,0)
 ...;
"RTN","ORB3TIM2",102,0)
 ...I (RXORD="OUTPATIENT MEDICATIONS")!(+$G(VADMVT)<1&(RXORD'?1"CLINIC ".E)) D
"RTN","ORB3TIM2",103,0)
 ....D EN^ORB3(72,ORPT,EXORN,"","",EXORN_"@")  ;trigger outpt notif
"RTN","ORB3TIM2",104,0)
 ...;
"RTN","ORB3TIM2",105,0)
 ...Q:RXORD="OUTPATIENT MEDICATIONS"  ;quit if an outpt med
"RTN","ORB3TIM2",106,0)
 ...Q:+$G(VADMVT)<1&(RXORD'?1"CLINIC ".E)  ;quit if an outpt
"RTN","ORB3TIM2",107,0)
 ...;
"RTN","ORB3TIM2",108,0)
 ...K VADMVT
"RTN","ORB3TIM2",109,0)
 ...;
"RTN","ORB3TIM2",110,0)
 ...;is schedule for the order a ONE TIME MED:
"RTN","ORB3TIM2",111,0)
 ...S ONETIME=0
"RTN","ORB3TIM2",112,0)
 ...I $D(ORBZ),(+$G(ORSCHFIL)=51.1) F ORBI=1:1:ORBZ D
"RTN","ORB3TIM2",113,0)
 ....S ORSCH=$P(ORBZ(ORBI),U,2)
"RTN","ORB3TIM2",114,0)
 ....I ORSCH=$$VALUE^ORCSAVE2(EXORN,"SCHEDULE") S ONETIME=1 Q
"RTN","ORB3TIM2",115,0)
 ...Q:+$G(ONETIME)=1  ;quit if one time med
"RTN","ORB3TIM2",116,0)
 ...;
"RTN","ORB3TIM2",117,0)
 ...;check if this is an IMO order and what it is,send an M.E.-OUTPT alert
"RTN","ORB3TIM2",118,0)
 ...I RXORD?1"CLINIC ".E D  Q
"RTN","ORB3TIM2",119,0)
 ....N ORDLG,ORDG,ORDLGNM,FLAG,ORX
"RTN","ORB3TIM2",120,0)
 ....S FLAG=0
"RTN","ORB3TIM2",121,0)
 ....S ORDLG=$P($G(^OR(100,EXORN,0)),U,5) Q:$P(ORDLG,";",2)'="ORD(101.41,"
"RTN","ORB3TIM2",122,0)
 ....S ORDLGNM=$P($G(^ORD(101.41,+ORDLG,0)),U)
"RTN","ORB3TIM2",123,0)
 ....S ORDG=$P($G(^ORD(101.41,+ORDLG,0)),U,2)
"RTN","ORB3TIM2",124,0)
 ....I ORDLGNM="PSJ OR PAT OE"!(ORDLGNM="PSJI OR PAT FLUID OE") S FLAG=1
"RTN","ORB3TIM2",125,0)
 ....I 'FLAG F ORX="INPATIENT MEDICATIONS","IV MEDICATIONS","UNIT DOSE MEDICATIONS","CLINIC ORDERS","CLINIC INFUSIONS","CLINIC MEDICATIONS" I $$UPPER^ORU(ORDG)=ORX D
"RTN","ORB3TIM2",126,0)
 .....S FLAG=1
"RTN","ORB3TIM2",127,0)
 .....I ORX="IV MEDICATIONS",(+$$IVRENEW(EXORN)=0) S FLAG=0
"RTN","ORB3TIM2",128,0)
 .....I ORX="UNIT DOSE MEDICATIONS",(+$$UDRENEW(EXORN,EXDT)=0) S FLAG=0
"RTN","ORB3TIM2",129,0)
 ....I FLAG D EN^ORB3(72,ORPT,EXORN,"","",EXORN_"@")  ;trigger outpt notif
"RTN","ORB3TIM2",130,0)
 ...;
"RTN","ORB3TIM2",131,0)
 ...;quit if inpt/unit dose med and med is not renewable:
"RTN","ORB3TIM2",132,0)
 ...I RXORD="UNIT DOSE MEDICATIONS",(+$$UDRENEW(EXORN,EXDT)=0) Q
"RTN","ORB3TIM2",133,0)
 ...;
"RTN","ORB3TIM2",134,0)
 ...;quit if IV med and med is not renewable:
"RTN","ORB3TIM2",135,0)
 ...I RXORD="IV MEDICATIONS",(+$$IVRENEW(EXORN)=0) Q
"RTN","ORB3TIM2",136,0)
 ...;
"RTN","ORB3TIM2",137,0)
 ...D EN^ORB3(47,ORPT,EXORN,"","",EXORN_"@")  ;trigger notif
"RTN","ORB3TIM2",138,0)
 S ^XTMP("ORB LAST EXPIRE",0)=$$FMADD^XLFDT(ORNOW,7,"","","")_U_$$NOW^XLFDT
"RTN","ORB3TIM2",139,0)
 D EXCLN(ORNOW)
"RTN","ORB3TIM2",140,0)
 Q
"RTN","ORB3TIM2",141,0)
UDRENEW(EXORN,EXDT) ;extr function returns 1 if med is renewable, 0 if not
"RTN","ORB3TIM2",142,0)
 N ORNOW,ORSLT,ORSTATUS
"RTN","ORB3TIM2",143,0)
 S ORSLT=0
"RTN","ORB3TIM2",144,0)
 S ORSTATUS=$P($$STATUS^ORQOR2(EXORN),U,2)
"RTN","ORB3TIM2",145,0)
 I ORSTATUS="ACTIVE" Q 1  ;renewable if "active"
"RTN","ORB3TIM2",146,0)
 I ORSTATUS="HOLD" Q 1   ;renewable if "on hold"
"RTN","ORB3TIM2",147,0)
 I ORSTATUS="EXPIRED" D
"RTN","ORB3TIM2",148,0)
 .S ORNOW=$$NOW^XLFDT
"RTN","ORB3TIM2",149,0)
 .;renewable if expired w/in past 4 days:
"RTN","ORB3TIM2",150,0)
 .I $$FMDIFF^XLFDT(ORNOW,EXDT,1)<4 S ORSLT=1
"RTN","ORB3TIM2",151,0)
 Q ORSLT
"RTN","ORB3TIM2",152,0)
 ;
"RTN","ORB3TIM2",153,0)
IVRENEW(EXORN) ;extr function returns 1 if med is renewable, 0 if not
"RTN","ORB3TIM2",154,0)
 N ORSLT,ORSTATUS
"RTN","ORB3TIM2",155,0)
 S ORSLT=0
"RTN","ORB3TIM2",156,0)
 S ORSTATUS=$P($$STATUS^ORQOR2(EXORN),U,2)
"RTN","ORB3TIM2",157,0)
 I ORSTATUS="ACTIVE" Q 1   ;renewable if "active"
"RTN","ORB3TIM2",158,0)
 I ORSTATUS="HOLD" Q 1   ;renewable if "on hold"
"RTN","ORB3TIM2",159,0)
 I ORSTATUS="EXPIRED" Q 1  ;renewable if "expired"
"RTN","ORB3TIM2",160,0)
 Q ORSLT
"RTN","ORB3TIM2",161,0)
 ;
"RTN","ORB3TIM2",162,0)
EXCLN(ORNOW) ;clean up old entires in ^XTMP("ORB LAST EXPIRE")
"RTN","ORB3TIM2",163,0)
 N ORN,ORDT
"RTN","ORB3TIM2",164,0)
 S ORN=1
"RTN","ORB3TIM2",165,0)
 F  S ORN=$O(^XTMP("ORB LAST EXPIRE",ORN)) Q:ORN=""  D
"RTN","ORB3TIM2",166,0)
 .S ORDT=$G(^XTMP("ORB LAST EXPIRE",ORN))
"RTN","ORB3TIM2",167,0)
 .I $L(ORDT),(ORDT<ORNOW) D
"RTN","ORB3TIM2",168,0)
 ..K ^XTMP("ORB LAST EXPIRE",ORN)
"RTN","ORB3TIM2",169,0)
 Q
"VER")
8.0^22.2
"BLD",10710,6)
^393
**END**
**END**

