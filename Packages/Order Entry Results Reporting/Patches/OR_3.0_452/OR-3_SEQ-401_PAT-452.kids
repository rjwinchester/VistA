Released OR*3*452 SEQ #401
Extracted from mail message
**KIDS**:OR*3.0*452^

**INSTALL NAME**
OR*3.0*452
"BLD",9960,0)
OR*3.0*452^ORDER ENTRY/RESULTS REPORTING^0^3171012^y
"BLD",9960,4,0)
^9.64PA^^
"BLD",9960,6.3)
2
"BLD",9960,"ABPKG")
n
"BLD",9960,"KRN",0)
^9.67PA^779.2^20
"BLD",9960,"KRN",.4,0)
.4
"BLD",9960,"KRN",.401,0)
.401
"BLD",9960,"KRN",.402,0)
.402
"BLD",9960,"KRN",.403,0)
.403
"BLD",9960,"KRN",.5,0)
.5
"BLD",9960,"KRN",.84,0)
.84
"BLD",9960,"KRN",3.6,0)
3.6
"BLD",9960,"KRN",3.8,0)
3.8
"BLD",9960,"KRN",9.2,0)
9.2
"BLD",9960,"KRN",9.8,0)
9.8
"BLD",9960,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",9960,"KRN",9.8,"NM",1,0)
ORB3^^0^B141411958
"BLD",9960,"KRN",9.8,"NM",2,0)
ORB31^^0^B35605938
"BLD",9960,"KRN",9.8,"NM",3,0)
ORWDPS2^^0^B68292926
"BLD",9960,"KRN",9.8,"NM","B","ORB3",1)

"BLD",9960,"KRN",9.8,"NM","B","ORB31",2)

"BLD",9960,"KRN",9.8,"NM","B","ORWDPS2",3)

"BLD",9960,"KRN",19,0)
19
"BLD",9960,"KRN",19.1,0)
19.1
"BLD",9960,"KRN",101,0)
101
"BLD",9960,"KRN",409.61,0)
409.61
"BLD",9960,"KRN",771,0)
771
"BLD",9960,"KRN",779.2,0)
779.2
"BLD",9960,"KRN",870,0)
870
"BLD",9960,"KRN",8989.51,0)
8989.51
"BLD",9960,"KRN",8989.52,0)
8989.52
"BLD",9960,"KRN",8994,0)
8994
"BLD",9960,"KRN","B",.4,.4)

"BLD",9960,"KRN","B",.401,.401)

"BLD",9960,"KRN","B",.402,.402)

"BLD",9960,"KRN","B",.403,.403)

"BLD",9960,"KRN","B",.5,.5)

"BLD",9960,"KRN","B",.84,.84)

"BLD",9960,"KRN","B",3.6,3.6)

"BLD",9960,"KRN","B",3.8,3.8)

"BLD",9960,"KRN","B",9.2,9.2)

"BLD",9960,"KRN","B",9.8,9.8)

"BLD",9960,"KRN","B",19,19)

"BLD",9960,"KRN","B",19.1,19.1)

"BLD",9960,"KRN","B",101,101)

"BLD",9960,"KRN","B",409.61,409.61)

"BLD",9960,"KRN","B",771,771)

"BLD",9960,"KRN","B",779.2,779.2)

"BLD",9960,"KRN","B",870,870)

"BLD",9960,"KRN","B",8989.51,8989.51)

"BLD",9960,"KRN","B",8989.52,8989.52)

"BLD",9960,"KRN","B",8994,8994)

"BLD",9960,"QUES",0)
^9.62^^
"BLD",9960,"REQB",0)
^9.611^4^3
"BLD",9960,"REQB",1,0)
OR*3.0*424^2
"BLD",9960,"REQB",2,0)
OR*3.0*329^2
"BLD",9960,"REQB",4,0)
OR*3.0*454^2
"BLD",9960,"REQB","B","OR*3.0*329",2)

"BLD",9960,"REQB","B","OR*3.0*424",1)

"BLD",9960,"REQB","B","OR*3.0*454",4)

"MBREQ")
0
"PKG",170,-1)
1^1
"PKG",170,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",170,20,0)
^9.402P^^
"PKG",170,22,0)
^9.49I^1^1
"PKG",170,22,1,0)
3.0^2971217^2980917^11712
"PKG",170,22,1,"PAH",1,0)
452^3171012
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","ORB3")
0^1^B141411958^B140213780
"RTN","ORB3",1,0)
ORB3 ;SLC/CLA,WAT,TC - MAIN ROUTINE FOR OE/RR 3 NOTIFICATIONS ;06/27/17  07:19 [8/29/17 9:26am]
"RTN","ORB3",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**31,74,91,105,139,190,220,253,265,296,348,350,452**;Dec 17, 1997;Build 2
"RTN","ORB3",3,0)
 ;;Per VA Directive 6402, this routine should not be modified.
"RTN","ORB3",4,0)
 ;
"RTN","ORB3",5,0)
 ;This routine invokes to following ICR(s):
"RTN","ORB3",6,0)
 ;ICR 4156     ;REGISTRATION, COMBAT VETERAN STATUS
"RTN","ORB3",7,0)
 ;ICR 5697     ;SCHEDULING, PCMM MHTC API's
"RTN","ORB3",8,0)
 ;
"RTN","ORB3",9,0)
EN(ORN,ORBDFN,ORNUM,ORBADUZ,ORBPMSG,ORBPDATA,ORFORCE) ;
"RTN","ORB3",10,0)
 ;
"RTN","ORB3",11,0)
 N ORBENT
"RTN","ORB3",12,0)
 S ORBENT=$$ENTITY^ORB31(ORNUM)
"RTN","ORB3",13,0)
 ;
"RTN","ORB3",14,0)
 Q:$$GET^XPAR(ORBENT,"ORB SYSTEM ENABLE/DISABLE",1,"I")="D"
"RTN","ORB3",15,0)
 Q:'$L($G(^ORD(100.9,ORN,0)))
"RTN","ORB3",16,0)
 Q:+$$ONOFF^ORB3FN(ORN)=0
"RTN","ORB3",17,0)
 ;
"RTN","ORB3",18,0)
 S ORBPMSG=$E($G(ORBPMSG),1,51)
"RTN","ORB3",19,0)
 ;
"RTN","ORB3",20,0)
 ;if msg from notif file or oc notif (#54), quit if dup w/in past 1 min:
"RTN","ORB3",21,0)
 N ORBDUP,ORBN
"RTN","ORB3",22,0)
 S ORBN=^ORD(100.9,ORN,0)
"RTN","ORB3",23,0)
 I ($P(ORBN,"^",4)="NOT")!(ORN=54) D
"RTN","ORB3",24,0)
 .S ORBDUP=$$DUP^ORB31(ORN,ORBDFN,ORBPMSG,ORNUM)
"RTN","ORB3",25,0)
 Q:+$G(ORBDUP)=1
"RTN","ORB3",26,0)
 ;
"RTN","ORB3",27,0)
 N ORBDESC
"RTN","ORB3",28,0)
 S ORBDESC=" Send Alert Notification ("_(+ORN)_") "_$P($G(^ORD(100.9,+ORN,0)),U,1)_"  "
"RTN","ORB3",29,0)
 ;
"RTN","ORB3",30,0)
 D QUEUE^ORB31(ORN,ORBDFN,$G(ORNUM),.ORBADUZ,$G(ORBPMSG),$G(ORBPDATA),$H,ORBDESC,$G(DGPMA),.ORFORCE)
"RTN","ORB3",31,0)
 Q
"RTN","ORB3",32,0)
ZTSK ;
"RTN","ORB3",33,0)
 D START
"RTN","ORB3",34,0)
 S ZTREQ="@"
"RTN","ORB3",35,0)
 Q
"RTN","ORB3",36,0)
UTL(ORBU,ORN,ORBDFN,ORNUM,ORBADUZ,ORBPMSG,ORBPDATA,ORFORCE) ;
"RTN","ORB3",37,0)
 Q:$G(ORBU)'=1
"RTN","ORB3",38,0)
START Q:$G(ORN)=""!($G(ORBDFN)="")
"RTN","ORB3",39,0)
 Q:'$L($G(^ORD(100.9,ORN,0)))
"RTN","ORB3",40,0)
 N ORBNOW,ORBID,ORBLOCK,ORBDESC
"RTN","ORB3",41,0)
 S ORBNOW=$$NOW^XLFDT
"RTN","ORB3",42,0)
 S ORBLOCK=0
"RTN","ORB3",43,0)
 ;
"RTN","ORB3",44,0)
 ;lock to prevent concurrent processing by other resource slots:
"RTN","ORB3",45,0)
 I '$D(ORBU) D
"RTN","ORB3",46,0)
 .S ^XTMP("ORBLOCK",0)=$$FMADD^XLFDT(ORBNOW,1,"","","")_"^"_ORBNOW
"RTN","ORB3",47,0)
 .S ORBID=$P($P($G(ORBPDATA),"|",2),"@")  ;get unique data id
"RTN","ORB3",48,0)
 .I $L(ORBID) D
"RTN","ORB3",49,0)
 ..LOCK +^XTMP("ORBLOCK",ORBDFN,ORN,ORBID):60 E  D  Q
"RTN","ORB3",50,0)
 ...S ORBDESC=" Requeue Alert Notification ("_(+ORN)_") "_$P($G(^ORD(100.9,+ORN,0)),U,1)_"  "
"RTN","ORB3",51,0)
 ...D QUEUE^ORB31(ORN,ORBDFN,$G(ORNUM),.ORBADUZ,$G(ORBPMSG),$G(ORBPDATA),$$HADD^XLFDT($H,"","",5,""),ORBDESC,$G(DGPMA),.ORFORCE) ;requeue in 5 min.
"RTN","ORB3",52,0)
 ...S ORBLOCK=1
"RTN","ORB3",53,0)
 .;
"RTN","ORB3",54,0)
 .I '$L(ORBID) D
"RTN","ORB3",55,0)
 ..LOCK +^XTMP("ORBLOCK",ORBDFN,ORN):60 E  D  Q
"RTN","ORB3",56,0)
 ...S ORBDESC=" Requeue Alert Notification ("_(+ORN)_") "_$P($G(^ORD(100.9,+ORN,0)),U,1)_"  "
"RTN","ORB3",57,0)
 ...D QUEUE^ORB31(ORN,ORBDFN,$G(ORNUM),.ORBADUZ,$G(ORBPMSG),$G(ORBPDATA),$$HADD^XLFDT($H,"","",5,""),ORBDESC,$G(DGPMA),.ORFORCE) ;requeue in 5 min.
"RTN","ORB3",58,0)
 ...S ORBLOCK=1
"RTN","ORB3",59,0)
 .;
"RTN","ORB3",60,0)
 I ORBLOCK=1 D QUIT Q
"RTN","ORB3",61,0)
 ;
"RTN","ORB3",62,0)
DOALERT ; Entry point for alert logic outside of TaskMan
"RTN","ORB3",63,0)
 N ORBDUZ,ORBN,ORBXQAID,ORPTNAM,ORBPRIM,ORBATTD,ORBDEV,ORBENT
"RTN","ORB3",64,0)
 N ORBUI,ORBASPEC,ORBSMSG,ORBADT,ORBSDEV,ORBDEL,ORBDI,ORBTDEV,ORY
"RTN","ORB3",65,0)
 N ORBIDX,ORBFLAGS
"RTN","ORB3",66,0)
 S ORBUI=1,ORBADT=0
"RTN","ORB3",67,0)
 S:'$L($G(ORBPMSG)) ORBPMSG=""
"RTN","ORB3",68,0)
 I '$L(ORBPDATA),(+$G(ORNUM)>0) S ORBPDATA=+$G(ORNUM)_"@"
"RTN","ORB3",69,0)
 S ORBN=^ORD(100.9,ORN,0)
"RTN","ORB3",70,0)
 S ORBIDX=0 F  S ORBIDX=$O(^ORD(100.9,ORN,5,ORBIDX)) Q:'ORBIDX  D
"RTN","ORB3",71,0)
 .S ORBFLAGS=$P($G(^ORD(100.9,ORN,5,ORBIDX,0)),U)
"RTN","ORB3",72,0)
 .S:ORBFLAGS'="" ORBFLAGS(ORBFLAGS)="",ORBFLAGS=""
"RTN","ORB3",73,0)
 ;
"RTN","ORB3",74,0)
 S ORBENT=$$ENTITY^ORB31(ORNUM)
"RTN","ORB3",75,0)
 ;
"RTN","ORB3",76,0)
 N DFN S DFN=ORBDFN,VA200="" D OERR^VADPT
"RTN","ORB3",77,0)
 I ('$L($G(VA("BID"))))!('$L($G(VADM(1)))) D QUIT Q
"RTN","ORB3",78,0)
 I (ORN=18)!(ORN=20)!(ORN=35) S ORBADT=1 ;A/D/T notif
"RTN","ORB3",79,0)
 ;if not an A/D/T notif, get primary & attending from OERR^VADPT:
"RTN","ORB3",80,0)
 I ORBADT=0 S ORBPRIM=+$P(VAIN(2),U),ORBATTD=+$P(VAIN(11),U)
"RTN","ORB3",81,0)
 I ORBADT=1 D ADT^ORB31(ORN,ORBDFN,.ORBPRIM,.ORBATTD,$G(ORDGPMA)) ;A/D/T notif
"RTN","ORB3",82,0)
 I $D(ORBU) D  ;create debug msg
"RTN","ORB3",83,0)
 .S ORBU(ORBUI)="Processing notification: "_$P(ORBN,U),ORBUI=ORBUI+1
"RTN","ORB3",84,0)
 .S ORBU(ORBUI)="            for patient: "_VADM(1),ORBUI=ORBUI+1
"RTN","ORB3",85,0)
 .I $G(ORNUM)>0 S ORBU(ORBUI)="              for order: "_ORNUM,ORBUI=ORBUI+1
"RTN","ORB3",86,0)
 D REGULAR^ORB3REG(ORN,.XQA,.ORBU,.ORBUI,.ORBDEV,ORBDFN)
"RTN","ORB3",87,0)
 D SPECIAL^ORB3SPEC(ORN,.ORBASPEC,.ORBU,.ORBUI,$G(ORNUM),ORBDFN,$G(ORBPDATA),.ORBSMSG,$G(ORBPMSG),.ORBSDEV,$G(ORBPRIM),$G(ORBATTD))
"RTN","ORB3",88,0)
 I $L($G(ORBSMSG)) S ORBPMSG=$E(ORBSMSG,1,51)
"RTN","ORB3",89,0)
 I $D(ORBASPEC)>1 D SPECDUZS ;special recips
"RTN","ORB3",90,0)
 I $D(ORBADUZ)>1 D PKGDUZS ;pkg-supplied recips
"RTN","ORB3",91,0)
 D TITLE ;provider recips
"RTN","ORB3",92,0)
 S ORBXQAID=$P(ORBN,"^",2)_","_ORBDFN_","_ORN
"RTN","ORB3",93,0)
 ;
"RTN","ORB3",94,0)
 I ($D(XQA)>1)!($D(ORBDEV)>1)!($D(ORBSDEV)>1) D  ;recips found
"RTN","ORB3",95,0)
 .S XQAFLG=$P(ORBN,"^",5)
"RTN","ORB3",96,0)
 .S XQADFN=ORBDFN
"RTN","ORB3",97,0)
 .I XQAFLG="R" S XQAROU=$P(ORBN,"^",6)_"^"_$P(ORBN,"^",7)
"RTN","ORB3",98,0)
 .I $G(ORBPDATA)'="" S XQADATA=ORBPDATA
"RTN","ORB3",99,0)
 .S ORPTNAM=$E(VADM(1)_"         ",1,9)
"RTN","ORB3",100,0)
 .I $G(ORN)=27 N CVMRKR,RSLT S RSLT=$$CVEDT^DGCV(DFN) I $P($G(RSLT),U)&($P($G(RSLT),U,3)) S CVMRKR=" CV "_$$FMTE^XLFDT($P($G(RSLT),U,2),"5DZ") ;WAT
"RTN","ORB3",101,0)
 .S XQAMSG=ORPTNAM_" "_"("_$E(ORPTNAM)_$E(VA("BID"),1,4)_")"_$G(CVMRKR)_": " ;WAT
"RTN","ORB3",102,0)
 .S XQAMSG=XQAMSG_$S(ORBPMSG'="":ORBPMSG,1:$P(ORBN,"^",3))
"RTN","ORB3",103,0)
 .S XQAARCH=$$GET^XPAR(ORBENT,"ORB ARCHIVE PERIOD",ORN,"I")
"RTN","ORB3",104,0)
 .S XQASUPV=$$GET^XPAR(ORBENT,"ORB FORWARD SUPERVISOR",ORN,"I")
"RTN","ORB3",105,0)
 .S XQASURO=$$GET^XPAR(ORBENT,"ORB FORWARD SURROGATES",ORN,"I")
"RTN","ORB3",106,0)
 .S XQAREVUE=$$GET^XPAR(ORBENT,"ORB FORWARD BACKUP REVIEWER",ORN,"I")
"RTN","ORB3",107,0)
 .S XQACNDEL=$$GET^XPAR(ORBENT,"ORB REMOVE",ORN,"I")
"RTN","ORB3",108,0)
 .S XQACNDEL=$S(XQACNDEL=1:1,1:"")
"RTN","ORB3",109,0)
 .I $D(ORBDEV)>1 D REGDEV^ORB31(.ORBDEV)
"RTN","ORB3",110,0)
 .I $D(ORBSDEV)>1 D REGDEV^ORB31(.ORBSDEV)
"RTN","ORB3",111,0)
 .I $D(ORBTDEV)>1 D REGDEV^ORB31(.ORBTDEV)
"RTN","ORB3",112,0)
 .S XQAID=ORBXQAID
"RTN","ORB3",113,0)
 .I $D(ORBFLAGS("ONPP")) D COMDUP
"RTN","ORB3",114,0)
 .I $D(XQA) D SETUP^XQALERT  ;if no [new] recips don't send alert
"RTN","ORB3",115,0)
QUIT ;
"RTN","ORB3",116,0)
 K VA,VA200,VADM,VAERR,VAIN,XQA,XQADATA,XQAID,XQAFLG,XQAMSG,XQAROU,XQAARCH,XQASUPV,XQASURO,XQADFN,XQACNDEL,XQAREVUE
"RTN","ORB3",117,0)
 K ^XTMP("ORBUSER",$J)
"RTN","ORB3",118,0)
 I '$D(ORBU),$D(ORBLOCK) D
"RTN","ORB3",119,0)
 .I $G(ORBID)]"" LOCK -^XTMP("ORBLOCK",ORBDFN,ORN,ORBID)
"RTN","ORB3",120,0)
 .E  LOCK -^XTMP("ORBLOCK",ORBDFN,ORN)
"RTN","ORB3",121,0)
 Q
"RTN","ORB3",122,0)
PKGDUZS ;get DUZs from pkg-passed ORBADUZ() array
"RTN","ORB3",123,0)
 N ORBPDUZ
"RTN","ORB3",124,0)
 I $D(ORBU) D
"RTN","ORB3",125,0)
 .S ORBU(ORBUI)=" ",ORBUI=ORBUI+1
"RTN","ORB3",126,0)
 .I ORN=68 S ORBU(ORBUI)="Recipients with Lab Threshold Exceeded:",ORBUI=ORBUI+1
"RTN","ORB3",127,0)
 .E  S ORBU(ORBUI)="Recipients defined when notif was triggered:",ORBUI=ORBUI+1
"RTN","ORB3",128,0)
 S ORBPDUZ=""
"RTN","ORB3",129,0)
 F  S ORBPDUZ=$O(ORBADUZ(ORBPDUZ)) Q:ORBPDUZ=""  S ORBDUZ=ORBPDUZ D USER
"RTN","ORB3",130,0)
 Q
"RTN","ORB3",131,0)
SPECDUZS ;get DUZs rtn by SPECIAL^ORB3SPEC
"RTN","ORB3",132,0)
 N ORBSDUZ
"RTN","ORB3",133,0)
 I $D(ORBU) D
"RTN","ORB3",134,0)
 .S ORBU(ORBUI)=" ",ORBUI=ORBUI+1
"RTN","ORB3",135,0)
 .S ORBU(ORBUI)="Special recipients associated with the notification:",ORBUI=ORBUI+1
"RTN","ORB3",136,0)
 S ORBSDUZ=""
"RTN","ORB3",137,0)
 F  S ORBSDUZ=$O(ORBASPEC(ORBSDUZ)) Q:ORBSDUZ=""  S ORBDUZ=ORBSDUZ D USER
"RTN","ORB3",138,0)
 Q
"RTN","ORB3",139,0)
TITLE ;get provider recips
"RTN","ORB3",140,0)
 N TITLES
"RTN","ORB3",141,0)
 I $D(ORBU) D
"RTN","ORB3",142,0)
 .S ORBU(ORBUI)=" ",ORBUI=ORBUI+1
"RTN","ORB3",143,0)
 .S ORBU(ORBUI)="Recipients determined by Provider Recipient parameter:",ORBUI=ORBUI+1
"RTN","ORB3",144,0)
 ;
"RTN","ORB3",145,0)
 S TITLES=$$GET^XPAR(ORBENT,"ORB PROVIDER RECIPIENTS",ORN,"I")
"RTN","ORB3",146,0)
 I TITLES["P" D PRIMARY
"RTN","ORB3",147,0)
 I TITLES["A" D ATTEND
"RTN","ORB3",148,0)
 I TITLES["T" D TEAMS
"RTN","ORB3",149,0)
 I TITLES["O" D ORDERER
"RTN","ORB3",150,0)
 I TITLES["E" D ENTERBY
"RTN","ORB3",151,0)
 I TITLES["R" D PCMMPRIM
"RTN","ORB3",152,0)
 I TITLES["S" D PCMMASSC
"RTN","ORB3",153,0)
 I TITLES["M" D PCMMTEAM
"RTN","ORB3",154,0)
 I TITLES["C" D PCMMMHTC
"RTN","ORB3",155,0)
 Q
"RTN","ORB3",156,0)
PRIMARY ;
"RTN","ORB3",157,0)
 I $D(ORBU),ORBADT=0 S ORBU(ORBUI)=" Inpt primary provider:",ORBUI=ORBUI+1
"RTN","ORB3",158,0)
 I $D(ORBU),ORBADT=1 S ORBU(ORBUI)=" Inpt primary provider: option cannot determine without A/D/T event data.",ORBUI=ORBUI+1
"RTN","ORB3",159,0)
 I +$G(ORBPRIM)>0 S ORBDUZ=ORBPRIM D USER
"RTN","ORB3",160,0)
 Q
"RTN","ORB3",161,0)
ATTEND ;
"RTN","ORB3",162,0)
 I $D(ORBU),ORBADT=0 S ORBU(ORBUI)=" Attending physician:",ORBUI=ORBUI+1
"RTN","ORB3",163,0)
 I $D(ORBU),ORBADT=1 S ORBU(ORBUI)=" Attending physician: option cannot determine without A/D/T event data.",ORBUI=ORBUI+1
"RTN","ORB3",164,0)
 I +$G(ORBATTD)>0 S ORBDUZ=ORBATTD D USER
"RTN","ORB3",165,0)
 Q
"RTN","ORB3",166,0)
TEAMS ;
"RTN","ORB3",167,0)
 I $D(ORBU) S ORBU(ORBUI)=" Teams/Personal Lists related to patient:",ORBUI=ORBUI+1
"RTN","ORB3",168,0)
 N ORBLST,ORBI,ORBJ,ORBTM,ORBTNAME,ORBTTYPE,ORBTD
"RTN","ORB3",169,0)
 D TMSPT^ORQPTQ1(.ORBLST,ORBDFN)
"RTN","ORB3",170,0)
 Q:+$G(ORBLST(1))<1
"RTN","ORB3",171,0)
 S ORBI="" F  S ORBI=$O(ORBLST(ORBI)) Q:ORBI=""  D
"RTN","ORB3",172,0)
 .S ORBTM=$P(ORBLST(ORBI),U),ORBTNAME=$P(ORBLST(ORBI),U,2)
"RTN","ORB3",173,0)
 .S ORBTTYPE=$P(ORBLST(ORBI),U,3)
"RTN","ORB3",174,0)
 .I $D(ORBU) D
"RTN","ORB3",175,0)
 ..S ORBU(ORBUI)="  Patient list "_ORBTNAME_" ["_ORBTTYPE_"]:",ORBUI=ORBUI+1
"RTN","ORB3",176,0)
 .N ORBLST2 D TEAMPROV^ORQPTQ1(.ORBLST2,ORBTM)
"RTN","ORB3",177,0)
 .Q:+$G(ORBLST2(1))<1
"RTN","ORB3",178,0)
 .S ORBJ="" F  S ORBJ=$O(ORBLST2(ORBJ)) Q:ORBJ=""  D
"RTN","ORB3",179,0)
 ..S ORBDUZ=$P(ORBLST2(ORBJ),U)_U_ORBTM I +$G(ORBDUZ)>0 D USER
"RTN","ORB3",180,0)
 .;
"RTN","ORB3",181,0)
 .S ORBTD=$P($$TMDEV^ORB31(ORBTM),U,2)  ;Team's device
"RTN","ORB3",182,0)
 .I $L(ORBTD) D
"RTN","ORB3",183,0)
 ..S ORBTDEV(ORBTD)=""
"RTN","ORB3",184,0)
 ..I $D(ORBU) D
"RTN","ORB3",185,0)
 ...S ORBU(ORBUI)="   Team's Device "_ORBTD_" is a recipient",ORBUI=ORBUI+1
"RTN","ORB3",186,0)
 Q
"RTN","ORB3",187,0)
ORDERER ;
"RTN","ORB3",188,0)
 Q:+$G(ORNUM)<1
"RTN","ORB3",189,0)
 I $D(ORBU) S ORBU(ORBUI)=" Ordering provider:",ORBUI=ORBUI+1
"RTN","ORB3",190,0)
 N ORBLST,ORBI,ORBTM,ORBJ,ORBTNAME,ORBPLST,ORBPI,ORBPTM,ORBTTYPE
"RTN","ORB3",191,0)
 S ORBDUZ=$S(ORN=12:+$$UNSIGNOR^ORQOR2(ORNUM),1:$$ORDERER^ORQOR2(ORNUM))
"RTN","ORB3",192,0)
 I +$G(ORBDUZ)>0 D
"RTN","ORB3",193,0)
 .D USER
"RTN","ORB3",194,0)
 .;if notif = Order Req E/S (#12) or Order Req Co-sign (#37) and
"RTN","ORB3",195,0)
 .;user doesn't have ES authority, send to fellow team members w/ES:
"RTN","ORB3",196,0)
 .I ((ORN=12)!(ORN=37)),('$D(^XUSEC("ORES",ORBDUZ))) D
"RTN","ORB3",197,0)
 ..I $D(ORBU) S ORBU(ORBUI)=" Orderer can't elec sign, getting teams orderer belongs to:",ORBUI=ORBUI+1
"RTN","ORB3",198,0)
 ..D TEAMPR^ORQPTQ1(.ORBLST,ORBDUZ)  ;get orderer's tms
"RTN","ORB3",199,0)
 ..Q:+$G(ORBLST(1))<1
"RTN","ORB3",200,0)
 ..D TMSPT^ORQPTQ1(.ORBPLST,ORBDFN)  ;get pt's tms
"RTN","ORB3",201,0)
 ..Q:+$G(ORBPLST(1))<1
"RTN","ORB3",202,0)
 ..S ORBI="" F  S ORBI=$O(ORBLST(ORBI)) Q:ORBI=""  D
"RTN","ORB3",203,0)
 ...S ORBPI="" F  S ORBPI=$O(ORBPLST(ORBPI)) Q:ORBPI=""  D
"RTN","ORB3",204,0)
 ....S ORBTM=$P(ORBLST(ORBI),U),ORBPTM=$P(ORBPLST(ORBPI),U)
"RTN","ORB3",205,0)
 ....I ORBTM=ORBPTM D  ;if pt is on provider's team
"RTN","ORB3",206,0)
 .....I +$G(ORBPTM)>0 D
"RTN","ORB3",207,0)
 ......S ORBTNAME=$P(ORBPLST(ORBPI),U,2)
"RTN","ORB3",208,0)
 ......S ORBTTYPE=$P(ORBPLST(ORBPI),U,3)
"RTN","ORB3",209,0)
 ......I $D(ORBU) S ORBU(ORBUI)="  Orderer's pt list "_ORBTNAME_" ["_ORBTTYPE_"] recipients: ",ORBUI=ORBUI+1
"RTN","ORB3",210,0)
 ......N ORBLST2 D TEAMPROV^ORQPTQ1(.ORBLST2,ORBPTM)
"RTN","ORB3",211,0)
 ......Q:+$G(ORBLST2(1))<1
"RTN","ORB3",212,0)
 ......S ORBJ="" F  S ORBJ=$O(ORBLST2(ORBJ)) Q:ORBJ=""  D
"RTN","ORB3",213,0)
 .......S ORBDUZ=$P(ORBLST2(ORBJ),U)_U_ORBPTM I +$G(ORBDUZ)>0,($D(^XUSEC("ORES",+ORBDUZ))) D USER
"RTN","ORB3",214,0)
 Q
"RTN","ORB3",215,0)
ENTERBY ;
"RTN","ORB3",216,0)
 I $D(ORBU) S ORBU(ORBUI)=" User entering order's most recent activity:",ORBUI=ORBUI+1
"RTN","ORB3",217,0)
 Q:+$G(ORNUM)<1
"RTN","ORB3",218,0)
 I $D(^OR(100,ORNUM,8,0)) D
"RTN","ORB3",219,0)
 .S ORBDUZ=$P(^OR(100,ORNUM,8,$P(^OR(100,ORNUM,8,0),U,3),0),U,13)
"RTN","ORB3",220,0)
 I +$G(ORBDUZ)>0 D USER
"RTN","ORB3",221,0)
 Q
"RTN","ORB3",222,0)
PCMMPRIM ;
"RTN","ORB3",223,0)
 I $D(ORBU) S ORBU(ORBUI)=" PCMM Primary Care Practitioner:",ORBUI=ORBUI+1
"RTN","ORB3",224,0)
 S ORBDUZ=+$$OUTPTPR^SDUTL3(ORBDFN,$$NOW^XLFDT,1)  ;DBIA #1252
"RTN","ORB3",225,0)
 I +$G(ORBDUZ)>0 D USER
"RTN","ORB3",226,0)
 Q
"RTN","ORB3",227,0)
PCMMASSC ;
"RTN","ORB3",228,0)
 I $D(ORBU) S ORBU(ORBUI)=" PCMM Associate Provider:",ORBUI=ORBUI+1
"RTN","ORB3",229,0)
 S ORBDUZ=+$$OUTPTAP^SDUTL3(ORBDFN,$$NOW^XLFDT)  ;DBIA #1252
"RTN","ORB3",230,0)
 I +$G(ORBDUZ)>0 D USER
"RTN","ORB3",231,0)
 Q
"RTN","ORB3",232,0)
PCMMTEAM ;
"RTN","ORB3",233,0)
 N ORPCMM,ORPCMMDZ
"RTN","ORB3",234,0)
 I $D(ORBU) S ORBU(ORBUI)=" PCMM Team Position Assignments:",ORBUI=ORBUI+1
"RTN","ORB3",235,0)
 S ORPCMM=$$PRPT^SCAPMC(ORBDFN,,,,,,"^TMP(""ORPCMM"",$J)",)  ;DBIA #1916
"RTN","ORB3",236,0)
 S ORPCMMDZ=0
"RTN","ORB3",237,0)
 F  S ORPCMMDZ=$O(^TMP("ORPCMM",$J,"SCPR",ORPCMMDZ)) Q:'ORPCMMDZ  D
"RTN","ORB3",238,0)
 .S ORBDUZ=ORPCMMDZ D USER
"RTN","ORB3",239,0)
 K ^TMP("ORPCMM",$J)
"RTN","ORB3",240,0)
 Q
"RTN","ORB3",241,0)
PCMMMHTC ;
"RTN","ORB3",242,0)
 I $D(ORBU) S ORBU(ORBUI)=" PCMM Mental Health Treatment Coordinator:",ORBUI=ORBUI+1
"RTN","ORB3",243,0)
 S ORBDUZ=+$$START^SCMCMHTC(ORBDFN)  ;DBIA #5697
"RTN","ORB3",244,0)
 I +$G(ORBDUZ)>0 D USER
"RTN","ORB3",245,0)
 Q
"RTN","ORB3",246,0)
USER ;should USER (ORBDUZ) be a recip
"RTN","ORB3",247,0)
 D USER^ORB3USER(.XQA,ORBDUZ,ORN,.ORBU,.ORBUI,ORBDFN,+$G(ORNUM))
"RTN","ORB3",248,0)
 I $D(ORFORCE(ORBDUZ)) S XQA(ORBDUZ)=""
"RTN","ORB3",249,0)
 Q
"RTN","ORB3",250,0)
COMDUP ; Combine XQADATA from existing alert(s) with new alert, delete existing alert
"RTN","ORB3",251,0)
 ;and then generate the new alert for the current individual user
"RTN","ORB3",252,0)
 N ORVAR,ORDUZ,ORAID,ORODATA
"RTN","ORB3",253,0)
 F ORVAR="XQA","XQADATA","XQAID","XQAFLG","XQAMSG","XQAROU","XQAARCH","XQASUPV","XQASURO","XQADFN","XQACNDEL","XQAREVUE","XQAOPT","XQAEXIT","XQAUSER","DUZ"  D
"RTN","ORB3",254,0)
 .Q:'$D(@ORVAR)
"RTN","ORB3",255,0)
 .I $D(@ORVAR)<10 S ORVAR(ORVAR)=$G(@ORVAR)
"RTN","ORB3",256,0)
 .I $D(@ORVAR)>9 M ORVAR(ORVAR)=@ORVAR
"RTN","ORB3",257,0)
 .S ORVAR(0,ORVAR)=""
"RTN","ORB3",258,0)
 S ORDUZ=0 F  S ORDUZ=$O(XQA(ORDUZ)) Q:'+ORDUZ  D
"RTN","ORB3",259,0)
 .N ORDATA,ORGEN
"RTN","ORB3",260,0)
 .K ^TMP($J,"ORB3DATA")
"RTN","ORB3",261,0)
 .D USER^XQALERT($NA(^TMP($J,"ORB3DATA")),ORDUZ)
"RTN","ORB3",262,0)
 .S ORAID=0 F  S ORAID=$O(^TMP($J,"ORB3DATA",ORAID)) Q:'+ORAID  D
"RTN","ORB3",263,0)
 ..Q:$P($P(^TMP($J,"ORB3DATA",ORAID),U,2),";")'=($P(ORBN,"^",2)_","_ORBDFN_","_ORN)
"RTN","ORB3",264,0)
 ..I $P(ORBN,U,4)="PKG",$P(^TMP($J,"ORB3DATA",ORAID),U)'[ORVAR("XQAMSG") Q
"RTN","ORB3",265,0)
 ..N XQAID,XQADATA,XQAOPT,XQAROU,XQAUSER,DUZ,XQAKILL
"RTN","ORB3",266,0)
 ..N XQADFN,XQAMSG,XQAFLG,XQADFN,XQAARCH,XQASUPV,XQASURO,XQAREVUE,XQACNDEL
"RTN","ORB3",267,0)
 ..S DUZ=ORDUZ
"RTN","ORB3",268,0)
 ..D GETACT^XQALERT($P(^TMP($J,"ORB3DATA",ORAID),U,2))
"RTN","ORB3",269,0)
 ..I XQADATA'="" D
"RTN","ORB3",270,0)
 ...I $D(ORBFLAGS("CD")) D
"RTN","ORB3",271,0)
 ....N OROLD,ORNEW,ORSPEC,ORIDX
"RTN","ORB3",272,0)
 ....S OROLD=U_$S(XQADATA[";":$P(XQADATA,";",2),1:XQADATA)_U,ORNEW=U_$S(ORVAR("XQADATA")[";":$P(ORVAR("XQADATA"),";",2),1:ORVAR("XQADATA"))_U
"RTN","ORB3",273,0)
 ....S ORSPEC(U)=""
"RTN","ORB3",274,0)
 ....F ORIDX=2:1:$L(ORNEW,U) I OROLD[(U_$P(ORNEW,U,ORIDX)_U) S $P(ORNEW,U,ORIDX)=""
"RTN","ORB3",275,0)
 ....S ORNEW=$$REPLACE^XLFSTR(ORNEW,.ORSPEC)
"RTN","ORB3",276,0)
 ....I ORNEW="" K ORVAR("XQA",ORDUZ) Q
"RTN","ORB3",277,0)
 ....S ORDATA=$S(XQADATA[";":$P(XQADATA,";",2),1:XQADATA)_$S($G(ORDATA)'="":U_ORDATA,1:"")
"RTN","ORB3",278,0)
 ....S ORGEN=1
"RTN","ORB3",279,0)
 ...I '$D(ORBFLAGS("CD")),XQADATA=ORVAR("XQADATA") S ORGEN=2
"RTN","ORB3",280,0)
 ..Q:'$G(ORGEN)
"RTN","ORB3",281,0)
 ..S XQAUSER=ORDUZ,XQAID=$P(^TMP($J,"ORB3DATA",ORAID),U,2),XQAKILL=1
"RTN","ORB3",282,0)
 ..D DELETE^XQALERT
"RTN","ORB3",283,0)
 .Q:$G(ORGEN)'=1
"RTN","ORB3",284,0)
 .I $G(XQADATA)'=""!($G(ORDATA)'="") S ORODATA=$G(XQADATA)_$S($G(ORDATA)'="":U_ORDATA,1:"")
"RTN","ORB3",285,0)
 .K ORVAR("XQA",ORDUZ)
"RTN","ORB3",286,0)
 .D XQRESTOR
"RTN","ORB3",287,0)
 .N XQA,XQADATA
"RTN","ORB3",288,0)
 .S XQA(ORDUZ)="",XQADATA=ORODATA D SETUP^XQALERT
"RTN","ORB3",289,0)
 K ^TMP($J,"ORB3DATA")
"RTN","ORB3",290,0)
 D XQRESTOR
"RTN","ORB3",291,0)
 Q
"RTN","ORB3",292,0)
XQRESTOR ; Restore XQA* variables saved off in COMDUP
"RTN","ORB3",293,0)
 S ORVAR="" F  S ORVAR=$O(ORVAR(0,ORVAR)) Q:$G(ORVAR)=""  K @ORVAR
"RTN","ORB3",294,0)
 S ORVAR="?" F  S ORVAR=$O(ORVAR(ORVAR)) Q:$G(ORVAR)=""  D
"RTN","ORB3",295,0)
 .I $D(ORVAR(ORVAR))<10 S @ORVAR=ORVAR(ORVAR)
"RTN","ORB3",296,0)
 .I $D(ORVAR(ORVAR))>9 M @ORVAR=ORVAR(ORVAR)
"RTN","ORB3",297,0)
 Q
"RTN","ORB31")
0^2^B35605938^B34930090
"RTN","ORB31",1,0)
ORB31 ; slc/CLA - Routine to support OE/RR 3 notifications ;06/27/17  07:14
"RTN","ORB31",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,31,88,105,139,173,220,215,329,452**;Dec 17, 1997;Build 2
"RTN","ORB31",3,0)
QUEUE(ORN,ORBDFN,ORNUM,ORBADUZ,ORBPMSG,ORBPDATA,ORBH,ORBD,ORDGPMA,ORFORCE) ;
"RTN","ORB31",4,0)
 ;queue up notif for Taskman processing
"RTN","ORB31",5,0)
 ;ORN       notification ien from file 100.9
"RTN","ORB31",6,0)
 ;ORBDFN    patient dfn from file 2
"RTN","ORB31",7,0)
 ;ORNUM     order number from file 100
"RTN","ORB31",8,0)
 ;ORBADUZ   array of potential user recipients (iens from file 100)
"RTN","ORB31",9,0)
 ;ORBPMSG   alert message from triggering process
"RTN","ORB31",10,0)
 ;ORBPDATA  data potentially used in alert follow-up action
"RTN","ORB31",11,0)
 ;ORBH      $H formatted time to begin Taskman process
"RTN","ORB31",12,0)
 ;ORBD      process description for Taskman
"RTN","ORB31",13,0)
 ;ORDGPMA   DGPMA if alert triggered by A/D/T event
"RTN","ORB31",14,0)
 ;ORFORCE   set array of DUZs that should get alert even if not on
"RTN","ORB31",15,0)
 ;
"RTN","ORB31",16,0)
 N ZTCPU,ZTDESC,ZTDTH,ZTIO,ZTPAR,ZTPRE,ZTPRI,ZTREQ,ZTRTN,ZTSAVE,ZTSK,ZTUCI,X,Y,DIC
"RTN","ORB31",17,0)
 ;
"RTN","ORB31",18,0)
 S DIC="3.5",X="ORB NOTIFICATION RESOURCE",DIC(0)="X" D ^DIC
"RTN","ORB31",19,0)
 I (Y) S ZTIO=$P(Y,U,2)
"RTN","ORB31",20,0)
 E  S ZTIO=""
"RTN","ORB31",21,0)
 S ZTDTH=ORBH,ZTRTN="ZTSK^ORB3"
"RTN","ORB31",22,0)
 S ZTDESC=ORBD
"RTN","ORB31",23,0)
 S ZTDESC=ZTDESC_"for ("_ORBDFN_") "_$P($G(^DPT(+ORBDFN,0)),U,1)
"RTN","ORB31",24,0)
 K ZTSAVE,ZTCPU,ZTUCI,ZTPRI,ZTPAR,ZTPRE,DIC,Y,DTOUT,DUOUT
"RTN","ORB31",25,0)
 ;
"RTN","ORB31",26,0)
 S ZTSAVE("ORN")=""
"RTN","ORB31",27,0)
 S ZTSAVE("ORBDFN")=""
"RTN","ORB31",28,0)
 S ZTSAVE("ORNUM")=""
"RTN","ORB31",29,0)
 S ZTSAVE("ORBADUZ(")=""
"RTN","ORB31",30,0)
 S ZTSAVE("ORBPMSG")=""
"RTN","ORB31",31,0)
 S ZTSAVE("ORBPDATA")=""
"RTN","ORB31",32,0)
 S ZTSAVE("ORDGPMA")=""
"RTN","ORB31",33,0)
 S ZTSAVE("ORFORCE(")=""
"RTN","ORB31",34,0)
 D ^%ZTLOAD
"RTN","ORB31",35,0)
 Q
"RTN","ORB31",36,0)
DUP(ORN,ORBDFN,ORBPMSG,ORNUM) ;ext funct return "1" if a duplicate notif w/in 1 min.
"RTN","ORB31",37,0)
 N ORBDUP,ORBNOW,ORBLAST,ORLNUM,ORSAMEP,ORSAMEREC
"RTN","ORB31",38,0)
 S ORBDUP=0
"RTN","ORB31",39,0)
 S ORSAMEP=0
"RTN","ORB31",40,0)
 S ORBNOW=$$NOW^XLFDT
"RTN","ORB31",41,0)
 S ^XTMP("ORBDUP",0)=$$FMADD^XLFDT(ORBNOW,1,"","","")_"^"_ORBNOW
"RTN","ORB31",42,0)
 I '$L($G(^XTMP("ORBDUP",ORBDFN_";"_ORN_";"_ORBPMSG))) S ^XTMP("ORBDUP",ORBDFN_";"_ORN_";"_ORBPMSG)=ORBNOW_"^"_$G(ORNUM)
"RTN","ORB31",43,0)
 E  D
"RTN","ORB31",44,0)
 .S ORBLAST=$G(^XTMP("ORBDUP",ORBDFN_";"_ORN_";"_ORBPMSG))
"RTN","ORB31",45,0)
 .S ORLNUM=$P(ORBLAST,"^",2)
"RTN","ORB31",46,0)
 .S ORBLAST=$P(ORBLAST,"^")
"RTN","ORB31",47,0)
 .I $L($G(ORNUM)),$L($G(ORLNUM)),($$ORDERER^ORQOR2(ORNUM)=$$ORDERER^ORQOR2(ORLNUM)) S ORSAMEP=1 ;same provider as last order that triggered this notif
"RTN","ORB31",48,0)
 .S ORSAMEREC=1 I ORN=6,($$RECIP($G(ORNUM))'=$$RECIP($G(ORLNUM))) S ORSAMEREC=0
"RTN","ORB31",49,0)
 .;if last occurrence of this "NOT" notif was w/in past 1 min, its a dup
"RTN","ORB31",50,0)
 .I ORBNOW<$$FMADD^XLFDT(ORBLAST,"","",1,""),ORSAMEP=1,ORSAMEREC=1 S ORBDUP=1  ;dup
"RTN","ORB31",51,0)
 .E  S ^XTMP("ORBDUP",ORBDFN_";"_ORN_";"_ORBPMSG)=ORBNOW_"^"_ORNUM  ;refresh last pt/noti occ.
"RTN","ORB31",52,0)
 D DUPCLN(ORBNOW)  ;clean up old ^XTMP("ORBUP") entries
"RTN","ORB31",53,0)
 Q ORBDUP
"RTN","ORB31",54,0)
RECIP(ORNUM) N ORI,RECIP
"RTN","ORB31",55,0)
 Q:'ORNUM 0
"RTN","ORB31",56,0)
 S ORI=0 F  S ORI=$O(^OR(100,ORNUM,8,ORI)) Q:'ORI  D
"RTN","ORB31",57,0)
 .I '$P($G(^OR(100,ORNUM,8,ORI,3)),U,6)&($P($G(^OR(100,ORNUM,8,ORI,3)),U,9)) S RECIP=$P($G(^OR(100,ORNUM,8,ORI,3)),U,9)
"RTN","ORB31",58,0)
 Q $G(RECIP)
"RTN","ORB31",59,0)
REGDEV(ORBDA) ;send to regular recipient devices
"RTN","ORB31",60,0)
 N ORBDT,ORBD
"RTN","ORB31",61,0)
 S ORBD=""
"RTN","ORB31",62,0)
 S ORBDT=$$NOW^XLFDT
"RTN","ORB31",63,0)
 F   S ORBD=$O(ORBDA(ORBD)) Q:ORBD=""  D
"RTN","ORB31",64,0)
 .S ZTRTN="PRINTD^ORB31",ZTDESC="Print Notification to Device",ZTDTH=$H
"RTN","ORB31",65,0)
 .S ZTIO=ORBD,ZTSAVE("XQAMSG")="",ZTSAVE("ORBDT")=""
"RTN","ORB31",66,0)
 .D ^%ZTLOAD
"RTN","ORB31",67,0)
 Q
"RTN","ORB31",68,0)
PRINTD ;print queued notification to device - setup via REGDEV^ORB3
"RTN","ORB31",69,0)
 I $G(ZTSK) D KILL^%ZTLOAD
"RTN","ORB31",70,0)
 I IOT="HFS" W XQAMSG Q  ;write msg to a file then quit
"RTN","ORB31",71,0)
 W !!!,"          ***** NOTIFICATION PROCESSED *****",!!
"RTN","ORB31",72,0)
 W $$FMTE^XLFDT(ORBDT),"   "
"RTN","ORB31",73,0)
 W XQAMSG
"RTN","ORB31",74,0)
 I $E(IOST,1,2)'="C-" W @IOF
"RTN","ORB31",75,0)
 Q
"RTN","ORB31",76,0)
FWD(ORY,ORBLST,ORBRECIP,ORBTYPE,ORBCOMNT) ; forward a notification
"RTN","ORB31",77,0)
 I ORBLST="" S ORY=0 Q
"RTN","ORB31",78,0)
 S ORBLST(1)=ORBLST
"RTN","ORB31",79,0)
 D FORWARD^XQALFWD(.ORBLST,.ORBRECIP,ORBTYPE,ORBCOMNT)
"RTN","ORB31",80,0)
 S ORY=1
"RTN","ORB31",81,0)
 Q
"RTN","ORB31",82,0)
RENEW(ORY,XQAID) ; renew/restore an alert/notification
"RTN","ORB31",83,0)
 Q:$L($G(XQAID))<1
"RTN","ORB31",84,0)
 K XQAKILL
"RTN","ORB31",85,0)
 I '$D(^XTV(8992,"AXQA",XQAID,DUZ)) D RESTORE^XQALERT1 ;DBIA #4100
"RTN","ORB31",86,0)
 S ORY=1
"RTN","ORB31",87,0)
 Q
"RTN","ORB31",88,0)
TERMLKUP(OCXARR,OCXTERM) ; extrinsic function returns the local terms
"RTN","ORB31",89,0)
 ; linked to the nat'l OCX term in an array and the file where those
"RTN","ORB31",90,0)
 ; array terms can be found. The value of the extrinsic function is the
"RTN","ORB31",91,0)
 ; file pointed to for the local terms.
"RTN","ORB31",92,0)
 ;
"RTN","ORB31",93,0)
 ; OCXARR  - Array of local terms
"RTN","ORB31",94,0)
 ; OCXTERM - OCX nat'l term from file ^OCXS(860.9
"RTN","ORB31",95,0)
 ;
"RTN","ORB31",96,0)
 N OCXI,OCXJ,FILE,I
"RTN","ORB31",97,0)
 S OCXI="",OCXJ=0,FILE="",I=1
"RTN","ORB31",98,0)
 S OCXI=$O(^OCXS(860.9,"B",OCXTERM,OCXI))
"RTN","ORB31",99,0)
 I +$G(OCXI)>0 D
"RTN","ORB31",100,0)
 .S FILE=$P(^OCXS(860.9,OCXI,0),U,2)
"RTN","ORB31",101,0)
 .F  S OCXJ=$O(^OCXS(860.9,OCXI,1,OCXJ)) Q:+OCXJ<1  D
"RTN","ORB31",102,0)
 ..S OCXARR(I)=$P(^OCXS(860.9,OCXI,1,OCXJ,0),U,2)_U_$P(^(0),U)
"RTN","ORB31",103,0)
 ..S OCXARR=I,I=I+1
"RTN","ORB31",104,0)
 Q FILE
"RTN","ORB31",105,0)
DUPCLN(ORBNOW) ;clean up old entires in ^XTMP("ORBDUP")
"RTN","ORB31",106,0)
 N ORBX,ORBDT,ORNDT
"RTN","ORB31",107,0)
 S ORNDT=$$FMADD^XLFDT(ORBNOW,"","",-5,"")  ;entries older than 5 minutes
"RTN","ORB31",108,0)
 S ORBX=0
"RTN","ORB31",109,0)
 F  S ORBX=$O(^XTMP("ORBDUP",ORBX)) Q:ORBX=""  D
"RTN","ORB31",110,0)
 .S ORBDT=+$G(^XTMP("ORBDUP",ORBX))
"RTN","ORB31",111,0)
 .I $L(ORBDT),(ORBDT<ORNDT) K ^XTMP("ORBDUP",ORBX)
"RTN","ORB31",112,0)
 Q
"RTN","ORB31",113,0)
TMDEV(ORBTM) ;returns Device for a team in format device ien^device name
"RTN","ORB31",114,0)
 N ORBTDEV,ORBTDEVN
"RTN","ORB31",115,0)
 S ORBTDEVN=""
"RTN","ORB31",116,0)
 Q:'$L($G(ORBTM)) ""
"RTN","ORB31",117,0)
 Q:'$D(^OR(100.21,ORBTM,0)) ""
"RTN","ORB31",118,0)
 S ORBTDEV=$P(^OR(100.21,ORBTM,0),U,4)  ;get Team's device
"RTN","ORB31",119,0)
 Q:+$G(ORBTDEV)<1 ""
"RTN","ORB31",120,0)
 S X="`"_ORBTDEV,DIC=3.5,DIC(0)="" D ^DIC  ;DBIA #10114
"RTN","ORB31",121,0)
 Q:+Y<1 ""
"RTN","ORB31",122,0)
 S ORBTDEVN=$P(Y,U,2)
"RTN","ORB31",123,0)
 K DIC,Y,X
"RTN","ORB31",124,0)
 Q ORBTDEV_U_ORBTDEVN
"RTN","ORB31",125,0)
ENTITY(ORNUM) ;ext funct. rtns entity for parameter use
"RTN","ORB31",126,0)
 N ORBENT
"RTN","ORB31",127,0)
 S ORBENT="DIV^SYS^PKG"
"RTN","ORB31",128,0)
 I $L($G(ORNUM)) D  ;if order number use pt's location division
"RTN","ORB31",129,0)
 .N ORDIV
"RTN","ORB31",130,0)
 .S ORDIV=0,ORDIV=$$ORDIV(ORNUM)
"RTN","ORB31",131,0)
 .I +$G(ORDIV)>0 S ORBENT=ORDIV_";DIC(4,^SYS^PKG"
"RTN","ORB31",132,0)
 Q ORBENT
"RTN","ORB31",133,0)
 ;
"RTN","ORB31",134,0)
ADT(ORN,ORBDFN,ORBPRIM,ORBATTD,ORDGPMA) ;get inpt primary and attending for ADT notifs
"RTN","ORB31",135,0)
 N ORBADTDT,VAINDT
"RTN","ORB31",136,0)
 ;if notif is deceased or discharge use prev visit d/t:
"RTN","ORB31",137,0)
 I (ORN=20)!(ORN=35) D
"RTN","ORB31",138,0)
 .S ORBADTDT=$S($D(ORDGPMA):$P(ORDGPMA,U),1:$P($G(^DPT(ORBDFN,.35)),U))
"RTN","ORB31",139,0)
 .I $L(ORBADTDT) S VAINDT=$$FMADD^XLFDT(ORBADTDT,"","","","-1")
"RTN","ORB31",140,0)
 ;
"RTN","ORB31",141,0)
 I ORN=18 S VAINDT=$P($G(ORDGPMA),U)  ;if admission use this visit d/t
"RTN","ORB31",142,0)
 ;
"RTN","ORB31",143,0)
 I $L($G(VAINDT)) D
"RTN","ORB31",144,0)
 .D INP^VADPT  ;get new VAIN array for appropriate visit
"RTN","ORB31",145,0)
 .S ORBPRIM=+$P(VAIN(2),U),ORBATTD=+$P(VAIN(11),U)
"RTN","ORB31",146,0)
 Q
"RTN","ORB31",147,0)
 ;
"RTN","ORB31",148,0)
DEFDIV(ORDUZ) ; Return user's default division, if specified.
"RTN","ORB31",149,0)
 ;
"RTN","ORB31",150,0)
 N ORDD,ORDIV,ORGOOD,ORZ,ORZERR
"RTN","ORB31",151,0)
 ;
"RTN","ORB31",152,0)
 S ORDIV=""
"RTN","ORB31",153,0)
 S Y=0,(ORDD,ORGOOD)=0             ; Initialize variables.
"RTN","ORB31",154,0)
 ;
"RTN","ORB31",155,0)
 ; Get list of divisions from NEW PERSON file multiple:
"RTN","ORB31",156,0)
 D LIST^DIC(200.02,","_ORDUZ_",","@;.01;1","QP","","","","","","","ORZ","ORZERR")
"RTN","ORB31",157,0)
 I $P(ORZ("DILIST",0),U)=0 Q       ; No Divisions listed.
"RTN","ORB31",158,0)
 ;
"RTN","ORB31",159,0)
 F  S ORDD=$O(ORZ("DILIST",ORDD)) Q:+ORDD=0!'($L(ORDD))  D  Q:ORGOOD
"RTN","ORB31",160,0)
 .; See if current entry being processed is "Default" (done if so):
"RTN","ORB31",161,0)
 .I $P(ORZ("DILIST",ORDD,0),U,3)["Y" S ORDIV=$P(ORZ("DILIST",ORDD,0),U,1,2),ORGOOD=1
"RTN","ORB31",162,0)
 Q ORDIV
"RTN","ORB31",163,0)
 ;
"RTN","ORB31",164,0)
ORDIV(ORNUM) ; Return order's division based upon patient's location when order was placed
"RTN","ORB31",165,0)
 ;
"RTN","ORB31",166,0)
 Q:+$G(ORNUM)<1 ""
"RTN","ORB31",167,0)
 Q:'$D(^OR(100,ORNUM,0)) ""
"RTN","ORB31",168,0)
 N ORDIV,PTLOC
"RTN","ORB31",169,0)
 S ORDIV=""
"RTN","ORB31",170,0)
 S PTLOC=+$P(^OR(100,ORNUM,0),U,10)
"RTN","ORB31",171,0)
 Q:$G(PTLOC)<1 ""
"RTN","ORB31",172,0)
 S ORDIV=$P(^SC(PTLOC,0),U,4)  ;DBIA #10040
"RTN","ORB31",173,0)
 Q ORDIV
"RTN","ORWDPS2")
0^3^B68292926^B66201174
"RTN","ORWDPS2",1,0)
ORWDPS2 ; SLC/KCM/JLI - Pharmacy Calls for Windows Dialog;05/09/2007 ;10/12/17  09:35
"RTN","ORWDPS2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**85,116,125,131,132,148,141,195,215,258,243,424,420,454,452**;Dec 17, 1997;Build 2
"RTN","ORWDPS2",3,0)
 ;
"RTN","ORWDPS2",4,0)
OISLCT(LST,OI,PSTYPE,ORVP,NEEDPI,PKIACTIV) ; return for defaults for pharmacy orderable item
"RTN","ORWDPS2",5,0)
 I $D(NEEDPI),(NEEDPI="Y"),$G(^TMP($J,"ORWDX LOADRSP","QO SAVE")) D  ;check if bug for Supply, Clin Med/IV for NEEDPI
"RTN","ORWDPS2",6,0)
 .N ORQOIEN S ORQOIEN=$O(^ORD(101.41,"B","OR GTX ORDERABLE ITEM",0))
"RTN","ORWDPS2",7,0)
 .N ORQOI S ORQOI=$O(^ORD(101.41,$G(^TMP($J,"ORWDX LOADRSP","QO SAVE")),6,"D",ORQOIEN,0)) Q:'ORQOI
"RTN","ORWDPS2",8,0)
 .N ORQOOI S ORQOOI=$G(^ORD(101.41,$G(^TMP($J,"ORWDX LOADRSP","QO SAVE")),6,ORQOI,1)) Q:'ORQOOI
"RTN","ORWDPS2",9,0)
 .I +OI=+ORQOOI D  ;make sure QO orderable is the same as the orderable here
"RTN","ORWDPS2",10,0)
 ..N ORQOPIDA S ORQOPIDA=$O(^ORD(101.41,"B","OR GTX PATIENT INSTRUCTIONS",0))
"RTN","ORWDPS2",11,0)
 ..I '$D(^ORD(101.41,$G(^TMP($J,"ORWDX LOADRSP","QO SAVE")),6,"D",ORQOPIDA)) S NEEDPI="N"
"RTN","ORWDPS2",12,0)
 K ^TMP($J,"ORWDX LOADRSP","QO SAVE")
"RTN","ORWDPS2",13,0)
 N ILST,ORDOSE,ORWPSOI,ORWDOSES,X1,X2
"RTN","ORWDPS2",14,0)
 K ^TMP("PSJINS",$J),^TMP("PSJMR",$J),^TMP("PSJNOUN",$J),^TMP("PSJSCH",$J),^TMP("PSSDIN",$J)
"RTN","ORWDPS2",15,0)
 S ILST=0
"RTN","ORWDPS2",16,0)
 S ORWPSOI=0
"RTN","ORWDPS2",17,0)
 S:+OI ORWPSOI=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORWDPS2",18,0)
 D START^PSSJORDF(ORWPSOI,$S(PSTYPE="U":"I",1:"O")) ; dflt route, schedule, etc.
"RTN","ORWDPS2",19,0)
 I '$L($T(DOSE^PSSOPKI1)) D DOSE^PSSORUTL(.ORDOSE,ORWPSOI,PSTYPE,ORVP)       ; dflt doses
"RTN","ORWDPS2",20,0)
 I $L($T(DOSE^PSSOPKI1)) D DOSE^PSSOPKI1(.ORDOSE,ORWPSOI,PSTYPE,ORVP)       ; dflt doses NEW PKI CODE from pharmacy
"RTN","ORWDPS2",21,0)
 D EN^PSSDIN(ORWPSOI)                               ; nfi text
"RTN","ORWDPS2",22,0)
 S ILST=ILST+1,LST(ILST)="~Medication"
"RTN","ORWDPS2",23,0)
 S ILST=ILST+1,LST(ILST)="d"_OI_U_$S(+OI:$P(^ORD(101.43,OI,0),U),1:"")
"RTN","ORWDPS2",24,0)
 S ILST=ILST+1,LST(ILST)="~Verb"
"RTN","ORWDPS2",25,0)
 S ILST=ILST+1,LST(ILST)="d"_$P($G(ORDOSE("MISC")),U)
"RTN","ORWDPS2",26,0)
 S ILST=ILST+1,LST(ILST)="~Preposition"
"RTN","ORWDPS2",27,0)
 S ILST=ILST+1,LST(ILST)="d"_$P($G(ORDOSE("MISC")),U,2)
"RTN","ORWDPS2",28,0)
 I $D(NEEDPI),(NEEDPI="Y") S ILST=ILST+1,LST(ILST)="~PtInstr" D PTINSTR
"RTN","ORWDPS2",29,0)
 ;S:NEEDPI="Y" ILST=ILST+1,LST(ILST)="~PtInstr"   D PTINSTR
"RTN","ORWDPS2",30,0)
 S ILST=ILST+1,LST(ILST)="~AllDoses"  D ALLDOSE ; must do before DOSAGE
"RTN","ORWDPS2",31,0)
 S ILST=ILST+1,LST(ILST)="~Dosage"    D DOSAGE
"RTN","ORWDPS2",32,0)
 S ILST=ILST+1,LST(ILST)="~Dispense"  D DISPLST
"RTN","ORWDPS2",33,0)
 S ILST=ILST+1,LST(ILST)="~Route"     D ROUTE
"RTN","ORWDPS2",34,0)
 S ILST=ILST+1,LST(ILST)="~Schedule"  D SCHED
"RTN","ORWDPS2",35,0)
 S ILST=ILST+1,LST(ILST)="~Guideline" D GUIDE
"RTN","ORWDPS2",36,0)
 S ILST=ILST+1,LST(ILST)="~Message"   D OIMSG
"RTN","ORWDPS2",37,0)
 S ILST=ILST+1,LST(ILST)="~DEASchedule" ;PKI
"RTN","ORWDPS2",38,0)
 ;S ILST=ILST+1,LST(ILST)="d"_$P($G(ORDOSE("DEA")),U) ;PKI
"RTN","ORWDPS2",39,0)
 S ILST=ILST+1,LST(ILST)="d" ;PKI
"RTN","ORWDPS2",40,0)
 I $D(ORDOSE("DEA")) S X="",X1=$P(ORDOSE("DEA"),";"),X2=$P(ORDOSE("DEA"),";",2) D
"RTN","ORWDPS2",41,0)
 . I '$L(X2) Q
"RTN","ORWDPS2",42,0)
 . I $G(PKIACTIV)="Y" S X=X2
"RTN","ORWDPS2",43,0)
 S LST(ILST)=LST(ILST)_X
"RTN","ORWDPS2",44,0)
 I PSTYPE="U" D
"RTN","ORWDPS2",45,0)
 . ; start, expires, next admin
"RTN","ORWDPS2",46,0)
 I PSTYPE="O" D
"RTN","ORWDPS2",47,0)
 . ; days supply, quantity, refills
"RTN","ORWDPS2",48,0)
 K ^TMP("PSJINS",$J),^TMP("PSJMR",$J),^TMP("PSJNOUN",$J),^TMP("PSJSCH",$J),^TMP("PSSDIN",$J)
"RTN","ORWDPS2",49,0)
 ;begin patch OR*3*420 MOD this supports the national drug message and lab test display in CPRS RTW
"RTN","ORWDPS2",50,0)
 N CREATLST
"RTN","ORWDPS2",51,0)
 S CREATLST=0 F  S CREATLST=$O(LST(CREATLST)) Q:'CREATLST  D
"RTN","ORWDPS2",52,0)
 . I $G(LST(CREATLST))?1"t".E S ^TMP("OI",$J,CREATLST)=$G(LST(CREATLST))
"RTN","ORWDPS2",53,0)
 ;end patch OR*3*420 MOD ; RTW
"RTN","ORWDPS2",54,0)
 Q
"RTN","ORWDPS2",55,0)
 ;
"RTN","ORWDPS2",56,0)
PTINSTR ; from OISLCT, set up patient instructions
"RTN","ORWDPS2",57,0)
 N I
"RTN","ORWDPS2",58,0)
 S I=0 F  S I=$O(ORDOSE("PI",I)) Q:I'>0  S ILST=ILST+1,LST(ILST)="t"_ORDOSE("PI",I)
"RTN","ORWDPS2",59,0)
 Q
"RTN","ORWDPS2",60,0)
DOSAGE ; from OISLCT, set up the list of dosages
"RTN","ORWDPS2",61,0)
 ; LST(n)=iDrugName^Strength^NF^... (see BLDDOSE)
"RTN","ORWDPS2",62,0)
 ; must be called after ALLDOSE so ORWDOSES is set up
"RTN","ORWDPS2",63,0)
 N I
"RTN","ORWDPS2",64,0)
 S I=0 F  S I=$O(ORWDOSES(I)) Q:I'>0  S ILST=ILST+1,LST(ILST)=ORWDOSES(I)
"RTN","ORWDPS2",65,0)
 Q
"RTN","ORWDPS2",66,0)
DISPLST ; from OISLCT, set up list of dispense drugs
"RTN","ORWDPS2",67,0)
 ; DrugIEN^Strength^Units^Name^Split
"RTN","ORWDPS2",68,0)
 N DD
"RTN","ORWDPS2",69,0)
 S DD=0 F  S DD=$O(ORDOSE("DD",DD)) Q:'DD  D
"RTN","ORWDPS2",70,0)
 . S ILST=ILST+1
"RTN","ORWDPS2",71,0)
 . S LST(ILST)="i"_DD_U_$P(ORDOSE("DD",DD),U,5,6)_U_$P(ORDOSE("DD",DD),U)_U_$P(ORDOSE("DD",DD),U,11)
"RTN","ORWDPS2",72,0)
 Q
"RTN","ORWDPS2",73,0)
ALLDOSE ; from OISLCT, set up a list of all possible doses
"RTN","ORWDPS2",74,0)
 ; LST(n)=iDrugName^Strength^NF^... (see BLDDOSE)
"RTN","ORWDPS2",75,0)
 N I,J,CONJ,DD,DRUG,DDNM,LDOSE,TEXT,STREN,UD,COST,NF,ID,X
"RTN","ORWDPS2",76,0)
 S CONJ=$P($G(ORDOSE("MISC")),U,3),ORWDOSES=0
"RTN","ORWDPS2",77,0)
 S:$L(CONJ) CONJ=" "_CONJ_" " S:'$L(CONJ) CONJ=" "
"RTN","ORWDPS2",78,0)
 S I=0 F  S I=$O(ORDOSE(I)) Q:I'>0  D
"RTN","ORWDPS2",79,0)
 . S X=$$BLDDOSE(ORDOSE(I))
"RTN","ORWDPS2",80,0)
 . S ORWDOSES=ORWDOSES+1,ORWDOSES(ORWDOSES)=X
"RTN","ORWDPS2",81,0)
 . S ILST=ILST+1
"RTN","ORWDPS2",82,0)
 . S LST(ILST)="i"_$P(X,U,5)_U_$P($P(X,U,4),"&",6)_U_$P(X,U,4)
"RTN","ORWDPS2",83,0)
 . S J=0 F  S J=$O(ORDOSE(I,J)) Q:J'>0  D
"RTN","ORWDPS2",84,0)
 . . S X=$$BLDDOSE(ORDOSE(I,J))
"RTN","ORWDPS2",85,0)
 . . S ILST=ILST+1
"RTN","ORWDPS2",86,0)
 . . S LST(ILST)="i"_$P(X,U,5)_U_$P($P(X,U,4),"&",6)_U_$P(X,U,4)
"RTN","ORWDPS2",87,0)
 Q
"RTN","ORWDPS2",88,0)
BLDDOSE(X) ; build dose info where X is ORDOSE node
"RTN","ORWDPS2",89,0)
 ; from ALLDOSE
"RTN","ORWDPS2",90,0)
 ;    X=TotalDose^Units^U/D^Noun^LocalDose^DispDrugIEN
"RTN","ORWDPS2",91,0)
 ;    Y=iDrugName^Strength^NF^TDose&Units&U/D&Noun&LDose&Drug&Stren&Units^
"RTN","ORWDPS2",92,0)
 ;      DoseText^CostText^MaxRefills^DispUnits^CanSplit
"RTN","ORWDPS2",93,0)
 ; DRUG=Name^Cost^NF^DispUnit^Strength^Units^DoseForm^MaxRefills^
"RTN","ORWDPS2",94,0)
 ; No TotalDose,           use LocalDose
"RTN","ORWDPS2",95,0)
 ; TotalDose & Strength,   use LocalDose+Conjunction+Strength+Units
"RTN","ORWDPS2",96,0)
 ; TotalDose, No Strength, use LocalDose+Conjunction+DispenseName
"RTN","ORWDPS2",97,0)
 N Y,A,ORNOW
"RTN","ORWDPS2",98,0)
 S ORNOW=$$NOW^XLFDT
"RTN","ORWDPS2",99,0)
 S DD=+$P(X,U,6),DRUG=ORDOSE("DD",DD),DDNM=$P(DRUG,U),ID=$P(X,U,1,6)
"RTN","ORWDPS2",100,0)
 S LDOSE=$P(X,U,5),TEXT=LDOSE,STREN=$P(DRUG,U,5)_$P(DRUG,U,6)
"RTN","ORWDPS2",101,0)
 S $P(ID,U,7)=$P(DRUG,U,5) S $P(ID,U,8)=$P(DRUG,U,6) ; add strength
"RTN","ORWDPS2",102,0)
 I '$L($P(X,U)),$L($P(DRUG,U,5))  S TEXT=TEXT_CONJ_STREN
"RTN","ORWDPS2",103,0)
 I '$L($P(X,U)),'$L($P(DRUG,U,5)) S TEXT=TEXT_CONJ_$P(DRUG,U)
"RTN","ORWDPS2",104,0)
 S UD=$P(X,U,3),COST=$P(X,U,7),NF=$S($P(DRUG,U,3):"NF",1:"")
"RTN","ORWDPS2",105,0)
 S A=$P($$CPTIER^PSNAPIS("",$P(ORNOW,"."),DD,1),"^")
"RTN","ORWDPS2",106,0)
 I UD S COST="$"_$J(UD*$P(DRUG,U,2),1,3)_"      Tier "_A ;_" per "_UD_" "_$P(X,U,4)
"RTN","ORWDPS2",107,0)
 ;I UD S COST="$"_$J(UD*$P(DRUG,U,2),1,3) ;_" per "_UD_" "_$P(X,U,4)
"RTN","ORWDPS2",108,0)
 S Y="i"_DDNM_U_STREN_U_NF_U_$TR(ID,U,"&")_U_TEXT_U_COST_U_$P(DRUG,U,8)_U_$P(DRUG,U,4)
"RTN","ORWDPS2",109,0)
 Q Y
"RTN","ORWDPS2",110,0)
ROUTE ; from OISLCT, get list of routes for the drug form
"RTN","ORWDPS2",111,0)
 ; ** NEED BOTH ABBREVIATION & NAME IN LIST BOX
"RTN","ORWDPS2",112,0)
 N I,CNT,ABBR,IEN,ROUT,EXP,X
"RTN","ORWDPS2",113,0)
 S I="" F  S I=$O(^TMP("PSJMR",$J,I)) Q:I=""  D
"RTN","ORWDPS2",114,0)
 . S X=^TMP("PSJMR",$J,I)
"RTN","ORWDPS2",115,0)
 . S ROUT=$P(X,U),ABBR=$P(X,U,2),IEN=$P(X,U,3),EXP=$P(X,U,4)
"RTN","ORWDPS2",116,0)
 . S ILST=ILST+1,LST(ILST)="i"_IEN_U_ROUT_U_ABBR_U_EXP_U_$P(X,U,5)
"RTN","ORWDPS2",117,0)
 . I $P(X,U,6)="D",IEN S ILST=ILST+1,LST(ILST)="d"_IEN_U_ROUT ;_U_ABBR ; assume first always default
"RTN","ORWDPS2",118,0)
 ; add abbreviations to list of routes, commented out for 15.5 on
"RTN","ORWDPS2",119,0)
 ; S I="" F  S I=$O(^TMP("PSJMR",$J,I)) Q:I=""  D
"RTN","ORWDPS2",120,0)
 ; . S X=^TMP("PSJMR",$J,I)
"RTN","ORWDPS2",121,0)
 ; . S ROUT=$P(X,U),ABBR=$P(X,U,2),IEN=$P(X,U,3),EXP=$P(X,U,4)
"RTN","ORWDPS2",122,0)
 ; . I $L(ABBR),(ABBR'=ROUT) S ILST=ILST+1,LST(ILST)="i"_IEN_U_ABBR_" ("_ROUT_")"_U_ABBR_U_EXP
"RTN","ORWDPS2",123,0)
 Q
"RTN","ORWDPS2",124,0)
SCHED ; from OISLCT, get default schedule for this medication
"RTN","ORWDPS2",125,0)
 I $L($G(^TMP("PSJSCH",$J))) S ILST=ILST+1,LST(ILST)="d"_^($J)
"RTN","ORWDPS2",126,0)
 Q
"RTN","ORWDPS2",127,0)
GUIDE ; from OISLCT, get guidelines associated with this medication
"RTN","ORWDPS2",128,0)
 N IEN,I
"RTN","ORWDPS2",129,0)
 S IEN=0 F  S IEN=$O(^TMP("PSSDIN",$J,"OI",ORWPSOI,IEN)) Q:'IEN  D
"RTN","ORWDPS2",130,0)
 . S I=0 F  S I=$O(^TMP("PSSDIN",$J,"OI",ORWPSOI,IEN,I)) Q:'I  D
"RTN","ORWDPS2",131,0)
 . . S ILST=ILST+1,LST(ILST)="t"_^TMP("PSSDIN",$J,"OI",ORWPSOI,IEN,I)
"RTN","ORWDPS2",132,0)
 Q
"RTN","ORWDPS2",133,0)
OIMSG ; from OISLCT, get the orderable item message for this medication
"RTN","ORWDPS2",134,0)
 S I=0 F  S I=$O(^ORD(101.43,OI,8,I)) Q:I'>0  S ILST=ILST+1,LST(ILST)="t"_^(I,0)
"RTN","ORWDPS2",135,0)
 I $L($T(SL^ORWDPLM1)) D SL^ORWDPLM1 ;LAB monitor
"RTN","ORWDPS2",136,0)
 Q
"RTN","ORWDPS2",137,0)
ADMIN(REC,DFN,SCH,OI,LOC,ADMIN) ; return administration time info
"RTN","ORWDPS2",138,0)
 ; REC: StartText^StartTime^Duration^FirstAdmin
"RTN","ORWDPS2",139,0)
 S OI=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORWDPS2",140,0)
 S LOC=+$G(^SC(LOC,42)),REC=""
"RTN","ORWDPS2",141,0)
 I $L($G(^DPT(DFN,.1))) S REC=$$FIRST^ORCDPS3(DFN,LOC,OI,SCH,"",$G(ADMIN))
"RTN","ORWDPS2",142,0)
 Q
"RTN","ORWDPS2",143,0)
REQST(VAL,DFN,SCH,OI,LOC,TXT) ; return requested start time
"RTN","ORWDPS2",144,0)
 ; VAL: FirstAdmin time
"RTN","ORWDPS2",145,0)
 S VAL=""
"RTN","ORWDPS2",146,0)
 Q:'$L($G(SCH))  Q:'$G(OI)
"RTN","ORWDPS2",147,0)
 S OI=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORWDPS2",148,0)
 S LOC=+$G(^SC(LOC,42))
"RTN","ORWDPS2",149,0)
 S VAL=$P($$RESOLVE^PSJORPOE(DFN,SCH,OI,TXT,LOC),U,2)
"RTN","ORWDPS2",150,0)
 Q
"RTN","ORWDPS2",151,0)
DAY2QTY(VAL,DAY,UPD,SCH,DUR,PAT,DRG) ; return qty for days supply
"RTN","ORWDPS2",152,0)
 ; VAL: quantity
"RTN","ORWDPS2",153,0)
 N ORWX,I,X,ADUR,ADURNM
"RTN","ORWDPS2",154,0)
 S ORWX("DAYS SUPPLY")=DAY
"RTN","ORWDPS2",155,0)
 S ORWX("PATIENT")=PAT
"RTN","ORWDPS2",156,0)
 I DRG S ORWX("DRUG")=DRG
"RTN","ORWDPS2",157,0)
 F I=1:1:$L(UPD,U)-1 D
"RTN","ORWDPS2",158,0)
 . S ORWX("DOSE ORDERED",I)=$P(UPD,U,I)
"RTN","ORWDPS2",159,0)
 . S ORWX("SCHEDULE",I)=$P(SCH,U,I)
"RTN","ORWDPS2",160,0)
 . S ADUR=$P(DUR,U,I),ADURNM=$P($P(ADUR," ",2),"~")
"RTN","ORWDPS2",161,0)
 . S:ADURNM="MONTHS" X=+ADUR_"L"
"RTN","ORWDPS2",162,0)
 . S:ADURNM'="MONTHS" X=+ADUR_$E($P(ADUR," ",2))
"RTN","ORWDPS2",163,0)
 . I $L(X) S ORWX("DURATION",I)=X
"RTN","ORWDPS2",164,0)
 . S X=$E($P(ADUR,"~",2))
"RTN","ORWDPS2",165,0)
 . I $L(X) S ORWX("CONJUNCTION",I)=X
"RTN","ORWDPS2",166,0)
 D QTYX^PSOSIG(.ORWX)
"RTN","ORWDPS2",167,0)
 S VAL=$G(ORWX("QTY"))
"RTN","ORWDPS2",168,0)
 Q
"RTN","ORWDPS2",169,0)
QTY2DAY(VAL,QTY,UPD,SCH,DUR,PAT,DRG) ; return days supply given quantity
"RTN","ORWDPS2",170,0)
 ; VAL: days supply
"RTN","ORWDPS2",171,0)
 N ORWX,I,X,ADUR
"RTN","ORWDPS2",172,0)
 S ORWX("QTY")=QTY
"RTN","ORWDPS2",173,0)
 S ORWX("PATIENT")=PAT
"RTN","ORWDPS2",174,0)
 I DRG S ORWX("DRUG")=DRG
"RTN","ORWDPS2",175,0)
 F I=1:1:$L(UPD,U)-1 D
"RTN","ORWDPS2",176,0)
 . S ORWX("DOSE ORDERED",I)=$P(UPD,U,I)
"RTN","ORWDPS2",177,0)
 . S ORWX("SCHEDULE",I)=$P(SCH,U,I)
"RTN","ORWDPS2",178,0)
 . S ADUR=$P(DUR,U,I),X=+ADUR_$E($P(ADUR," ",2))
"RTN","ORWDPS2",179,0)
 . I $L(X) S ORWX("DURATION",I)=X
"RTN","ORWDPS2",180,0)
 . S X=$E($P(ADUR,"~",2))
"RTN","ORWDPS2",181,0)
 . I $L(X) S ORWX("CONJUNCTION",I)=X
"RTN","ORWDPS2",182,0)
 D QTYX^PSOSIG(.ORWX)
"RTN","ORWDPS2",183,0)
 S VAL=$G(ORWX("DAYS SUPPLY"))
"RTN","ORWDPS2",184,0)
 Q
"RTN","ORWDPS2",185,0)
MAXREF(VAL,PAT,DRG,SUP,OI,OUT) ; return the maximum number of refills
"RTN","ORWDPS2",186,0)
 ; PAT=Patient DFN, DRG=ptr50, SUP=days supply, OI=orderable item
"RTN","ORWDPS2",187,0)
 ; VAL: maximum refills allowed
"RTN","ORWDPS2",188,0)
 N ORWX
"RTN","ORWDPS2",189,0)
 S ORWX("PATIENT")=PAT
"RTN","ORWDPS2",190,0)
 I $G(DRG) S ORWX("DRUG")=+DRG
"RTN","ORWDPS2",191,0)
 I $G(SUP) S ORWX("DAYS SUPPLY")=SUP
"RTN","ORWDPS2",192,0)
 I $G(OI)  S ORWX("ITEM")=+$P(^ORD(101.43,+OI,0),U,2)
"RTN","ORWDPS2",193,0)
 I $G(OUT) S ORWX("DISCHARGE")=1
"RTN","ORWDPS2",194,0)
 D MAX^PSOSIGDS(.ORWX)
"RTN","ORWDPS2",195,0)
 S VAL=$G(ORWX("MAX"))
"RTN","ORWDPS2",196,0)
 Q
"RTN","ORWDPS2",197,0)
SCHREQ(VAL,OI,RTE,DRG) ; return 1 if schedule is required
"RTN","ORWDPS2",198,0)
 ; OI=orderable item, RTE=ptr route, DRG=ptr dispense drug
"RTN","ORWDPS2",199,0)
 S VAL=1
"RTN","ORWDPS2",200,0)
 Q:'$G(OI)  Q:'$G(RTE)
"RTN","ORWDPS2",201,0)
 S VAL=$$SCHREQ^PSJORPOE(RTE,OI,+$G(DRG))
"RTN","ORWDPS2",202,0)
 Q
"RTN","ORWDPS2",203,0)
CHKPI(VAL,ODIFN) ; return pre-existing patient instruct
"RTN","ORWDPS2",204,0)
 N IDNUM,IDPI
"RTN","ORWDPS2",205,0)
 S (IDNUM,IDPI)=0,VAL=""
"RTN","ORWDPS2",206,0)
 I '$D(^OR(100,ODIFN,4.5,"ID","PI")) S VAL="" Q
"RTN","ORWDPS2",207,0)
 F  S IDNUM=$O(^OR(100,ODIFN,4.5,"ID","PI",IDNUM)) Q:'IDNUM  D
"RTN","ORWDPS2",208,0)
 . F  S IDPI=$O(^OR(100,ODIFN,4.5,IDNUM,2,IDPI)) Q:'IDPI  D
"RTN","ORWDPS2",209,0)
 .. S VAL=VAL_^OR(100,ODIFN,4.5,IDNUM,2,IDPI,0)
"RTN","ORWDPS2",210,0)
 K IDNUM,IDPI
"RTN","ORWDPS2",211,0)
 Q
"RTN","ORWDPS2",212,0)
CHKGRP(VAL,ORIFN) ;
"RTN","ORWDPS2",213,0)
 ;Inpatient Med Order Group or Clin Meds Group: return 1
"RTN","ORWDPS2",214,0)
 ;If order belong to Outpatient Med Order Grpoup: return 2
"RTN","ORWDPS2",215,0)
 ;Otherwise, return 0
"RTN","ORWDPS2",216,0)
 S VAL=0
"RTN","ORWDPS2",217,0)
 I '$L(ORIFN) Q
"RTN","ORWDPS2",218,0)
 N UDGRP,IPGRP,OPGRP,ODGRP,ODID,CLMED
"RTN","ORWDPS2",219,0)
 S ODID=+ORIFN
"RTN","ORWDPS2",220,0)
 Q:ODID<1
"RTN","ORWDPS2",221,0)
 S (UDGRP,IPGRP,OPGRP,ODGRP,CLMED)=0
"RTN","ORWDPS2",222,0)
 S UDGRP=$O(^ORD(100.98,"B","UD RX",UDGRP))
"RTN","ORWDPS2",223,0)
 S OPGRP=$O(^ORD(100.98,"B","OUTPATIENT MEDICATIONS",OPGRP))
"RTN","ORWDPS2",224,0)
 S IPGRP=$O(^ORD(100.98,"B","INPATIENT MEDICATIONS",IPGRP))
"RTN","ORWDPS2",225,0)
 S CLMED=$O(^ORD(100.98,"B","CLINIC ORDERS",CLMED))
"RTN","ORWDPS2",226,0)
 S:IPGRP=0 IPGRP=$O(^ORD(100.98,"B","I RX",IPGRP))
"RTN","ORWDPS2",227,0)
 I $L($G(^OR(100,ODID,0)))<1 Q
"RTN","ORWDPS2",228,0)
 S ODGRP=$P(^OR(100,ODID,0),U,11)
"RTN","ORWDPS2",229,0)
 I (UDGRP=ODGRP)!(CLMED=ODGRP) S VAL=1
"RTN","ORWDPS2",230,0)
 I IPGRP=ODGRP S VAL=1
"RTN","ORWDPS2",231,0)
 I OPGRP=ODGRP S VAL=2
"RTN","ORWDPS2",232,0)
 K UDGRP,ODGRP,OPGRP,IPGRP,ODID,CLMED
"RTN","ORWDPS2",233,0)
 Q
"RTN","ORWDPS2",234,0)
QOGRP(VAL,QOIFN) ;
"RTN","ORWDPS2",235,0)
 ;If quick order belong to Inpatient Med Order Group: return 1
"RTN","ORWDPS2",236,0)
 ;Otherwise, return 0
"RTN","ORWDPS2",237,0)
 S VAL=0
"RTN","ORWDPS2",238,0)
 I '$L(QOIFN) Q
"RTN","ORWDPS2",239,0)
 N UDGRP,IPGRP,QOGRP,QOID,CLMED
"RTN","ORWDPS2",240,0)
 S QOID=+QOIFN
"RTN","ORWDPS2",241,0)
 Q:QOID<1
"RTN","ORWDPS2",242,0)
 S (UDGRP,IPGRP,QOGRP,CLMED)=0
"RTN","ORWDPS2",243,0)
 S UDGRP=$O(^ORD(100.98,"B","UD RX",UDGRP))
"RTN","ORWDPS2",244,0)
 S IPGRP=$O(^ORD(100.98,"B","INPATIENT MEDICATIONS",IPGRP))
"RTN","ORWDPS2",245,0)
 S CLMED=$O(^ORD(100.98,"B","CLINIC ORDERS",CLMED))
"RTN","ORWDPS2",246,0)
 S:IPGRP=0 IPGRP=$O(^ORD(100.98,"B","I RX",IPGRP))
"RTN","ORWDPS2",247,0)
 I $L($G(^ORD(101.41,QOID,0)))<1 Q
"RTN","ORWDPS2",248,0)
 S QOGRP=$P(^ORD(101.41,QOID,0),U,5)
"RTN","ORWDPS2",249,0)
 I UDGRP=QOGRP S VAL=1
"RTN","ORWDPS2",250,0)
 I (IPGRP=QOGRP)!(CLMED=QOGRP) S VAL=1
"RTN","ORWDPS2",251,0)
 K UDGRP,QOGRP,QOID,IPGRP,CLMED
"RTN","ORWDPS2",252,0)
 Q
"VER")
8.0^22.2
"BLD",9960,6)
^401
**END**
**END**

