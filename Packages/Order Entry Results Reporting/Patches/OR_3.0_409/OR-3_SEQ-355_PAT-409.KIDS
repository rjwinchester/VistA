Released OR*3*409 SEQ #355
Extracted from mail message
**KIDS**:OR*3.0*409^

**INSTALL NAME**
OR*3.0*409
"BLD",9949,0)
OR*3.0*409^ORDER ENTRY/RESULTS REPORTING^0^3150326^y
"BLD",9949,1,0)
^^5^5^3150326^
"BLD",9949,1,1,0)
The purpose of this patch is to provide a software bug fix for CPRS 
"BLD",9949,1,2,0)
orders functionality.  This patch addresses the following issues:
"BLD",9949,1,3,0)
 
"BLD",9949,1,4,0)
-'Treating Specialty' disappears when order is renewed or Give Additional 
"BLD",9949,1,5,0)
Dose Now is selected.
"BLD",9949,4,0)
^9.64PA^^
"BLD",9949,6.3)
1
"BLD",9949,"KRN",0)
^9.67PA^779.2^20
"BLD",9949,"KRN",.4,0)
.4
"BLD",9949,"KRN",.401,0)
.401
"BLD",9949,"KRN",.402,0)
.402
"BLD",9949,"KRN",.403,0)
.403
"BLD",9949,"KRN",.5,0)
.5
"BLD",9949,"KRN",.84,0)
.84
"BLD",9949,"KRN",3.6,0)
3.6
"BLD",9949,"KRN",3.8,0)
3.8
"BLD",9949,"KRN",9.2,0)
9.2
"BLD",9949,"KRN",9.8,0)
9.8
"BLD",9949,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",9949,"KRN",9.8,"NM",1,0)
ORWDXR^^0^B60135290
"BLD",9949,"KRN",9.8,"NM",2,0)
ORCSEND3^^0^B25968577
"BLD",9949,"KRN",9.8,"NM","B","ORCSEND3",2)

"BLD",9949,"KRN",9.8,"NM","B","ORWDXR",1)

"BLD",9949,"KRN",19,0)
19
"BLD",9949,"KRN",19.1,0)
19.1
"BLD",9949,"KRN",101,0)
101
"BLD",9949,"KRN",409.61,0)
409.61
"BLD",9949,"KRN",771,0)
771
"BLD",9949,"KRN",779.2,0)
779.2
"BLD",9949,"KRN",870,0)
870
"BLD",9949,"KRN",8989.51,0)
8989.51
"BLD",9949,"KRN",8989.52,0)
8989.52
"BLD",9949,"KRN",8994,0)
8994
"BLD",9949,"KRN","B",.4,.4)

"BLD",9949,"KRN","B",.401,.401)

"BLD",9949,"KRN","B",.402,.402)

"BLD",9949,"KRN","B",.403,.403)

"BLD",9949,"KRN","B",.5,.5)

"BLD",9949,"KRN","B",.84,.84)

"BLD",9949,"KRN","B",3.6,3.6)

"BLD",9949,"KRN","B",3.8,3.8)

"BLD",9949,"KRN","B",9.2,9.2)

"BLD",9949,"KRN","B",9.8,9.8)

"BLD",9949,"KRN","B",19,19)

"BLD",9949,"KRN","B",19.1,19.1)

"BLD",9949,"KRN","B",101,101)

"BLD",9949,"KRN","B",409.61,409.61)

"BLD",9949,"KRN","B",771,771)

"BLD",9949,"KRN","B",779.2,779.2)

"BLD",9949,"KRN","B",870,870)

"BLD",9949,"KRN","B",8989.51,8989.51)

"BLD",9949,"KRN","B",8989.52,8989.52)

"BLD",9949,"KRN","B",8994,8994)

"BLD",9949,"QUES",0)
^9.62^^
"BLD",9949,"REQB",0)
^9.611^2^2
"BLD",9949,"REQB",1,0)
OR*3.0*374^2
"BLD",9949,"REQB",2,0)
OR*3.0*280^2
"BLD",9949,"REQB","B","OR*3.0*280",2)

"BLD",9949,"REQB","B","OR*3.0*374",1)

"MBREQ")
0
"PKG",174,-1)
1^1
"PKG",174,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",174,20,0)
^9.402P^^
"PKG",174,22,0)
^9.49I^1^1
"PKG",174,22,1,0)
3.0^2971217^2990325^66481
"PKG",174,22,1,"PAH",1,0)
409^3150326
"PKG",174,22,1,"PAH",1,1,0)
^^5^5^3150326
"PKG",174,22,1,"PAH",1,1,1,0)
The purpose of this patch is to provide a software bug fix for CPRS 
"PKG",174,22,1,"PAH",1,1,2,0)
orders functionality.  This patch addresses the following issues:
"PKG",174,22,1,"PAH",1,1,3,0)
 
"PKG",174,22,1,"PAH",1,1,4,0)
-'Treating Specialty' disappears when order is renewed or Give Additional 
"PKG",174,22,1,"PAH",1,1,5,0)
Dose Now is selected.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","ORCSEND3")
0^2^B25968577^B25737895
"RTN","ORCSEND3",1,0)
ORCSEND3 ;SLC/MKB,AGP-Release cont ;02/24/10  05:53
"RTN","ORCSEND3",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**243,282,280,409**;Dec 17, 1997;Build 1
"RTN","ORCSEND3",3,0)
 ;
"RTN","ORCSEND3",4,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORCSEND3",5,0)
 ;
"RTN","ORCSEND3",6,0)
 ;Reference to PSJORPOE supported by IA #3167
"RTN","ORCSEND3",7,0)
 ;
"RTN","ORCSEND3",8,0)
CHILD(STRT) ; Create child order, send to package
"RTN","ORCSEND3",9,0)
 N ORAPPT,ORPTS,A
"RTN","ORCSEND3",10,0)
 K ORIFN D EN^ORCSAVE Q:'$G(ORIFN)  D STARTDT^ORCSAVE2(ORIFN)
"RTN","ORCSEND3",11,0)
 I $G(STRT) D DATES^ORCSAVE2(ORIFN,STRT)
"RTN","ORCSEND3",12,0)
 S ORCHLD=+$G(ORCHLD)+1,^OR(100,ORPARENT,2,ORIFN,0)=ORIFN,ORLAST=ORIFN
"RTN","ORCSEND3",13,0)
 S A=$G(^OR(100,ORPARENT,0)),ORAPPT=$P(A,U,18),ORPTS=$P(A,"^",13)
"RTN","ORCSEND3",14,0)
 S $P(^OR(100,ORIFN,0),U,18)=ORAPPT,$P(^(3),U,9)=ORPARENT
"RTN","ORCSEND3",15,0)
 I $P(^OR(100,ORIFN,0),U,13)="" S $P(^(0),"^",13)=ORPTS ; 409 - Preserve Treating Specialty
"RTN","ORCSEND3",16,0)
 N X0 S X0=$G(^OR(100,ORPARENT,8,1,0))
"RTN","ORCSEND3",17,0)
 I $P(X0,U,4)'=2 D SIGN^ORCSAVE2(ORIFN,+$P(X0,U,5),ORNOW,$P(X0,U,4),1)
"RTN","ORCSEND3",18,0)
 D COPY^OROCAPI1(ORPARENT,ORIFN)
"RTN","ORCSEND3",19,0)
 I $G(ORENEW) S OLD=$O(ORENEW(0)) I OLD S $P(^OR(100,OLD,3),U,6)=ORIFN,$P(^OR(100,ORIFN,3),U,5)=OLD,$P(^(3),U,11)=2 K ORENEW(OLD)
"RTN","ORCSEND3",20,0)
 D RELEASE^ORCSAVE2(ORIFN,1,ORNOW,DUZ,$G(NATURE)),NEW^ORMBLD(ORIFN)
"RTN","ORCSEND3",21,0)
 Q
"RTN","ORCSEND3",22,0)
 ;
"RTN","ORCSEND3",23,0)
DOSES(IFN) ;
"RTN","ORCSEND3",24,0)
 N I,CNT S CNT=0
"RTN","ORCSEND3",25,0)
 S I=+$O(^OR(100,+$G(IFN),4.5,"ID","NOW",0)) I I,$G(^OR(100,+$G(IFN),4.5,I,1)) S CNT=CNT+1
"RTN","ORCSEND3",26,0)
 Q CNT
"RTN","ORCSEND3",27,0)
 ;
"RTN","ORCSEND3",28,0)
GETORDER(IFN) ; Set ORX(Inst,Ptr)=Value
"RTN","ORCSEND3",29,0)
 N I,X,Y,PTR,INST,TYPE,SOLCNT,ADDCNT
"RTN","ORCSEND3",30,0)
 S (SOLCNT,ADDCNT)=0
"RTN","ORCSEND3",31,0)
 S I=0 F  S I=$O(^OR(100,IFN,4.5,I)) Q:I'>0  S X=$G(^(I,0)),Y=$G(^(1)) D
"RTN","ORCSEND3",32,0)
 . S PTR=+$P(X,U,2),INST=+$P(X,U,3),TYPE=$P($G(^ORD(101.41,PTR,1)),U)
"RTN","ORCSEND3",33,0)
 . I TYPE'="W" S ORX(PTR,INST)=Y Q
"RTN","ORCSEND3",34,0)
 . ;S ORX(INST,PTR)="^OR(100,"_IFN_",4.5,"_I_",2)"
"RTN","ORCSEND3",35,0)
 . S ORX(PTR,INST)="^OR(100,"_IFN_",4.5,"_I_",2)"
"RTN","ORCSEND3",36,0)
 Q
"RTN","ORCSEND3",37,0)
PSJI ;
"RTN","ORCSEND3",38,0)
 ;IV dialog
"RTN","ORCSEND3",39,0)
 N ORPARENT,OR0,ORNP,ORDIALOG,ORDUZ,ORLOG,ORL,ORDG,ORCAT,ORX,ORP,ORI,STS
"RTN","ORCSEND3",40,0)
 N ORDOSE,ORT,ORSCH,ORDUR,ORSTRT,ORFRST,ORCONJ,ORID,ORDD,ORSTR,ORDGNM
"RTN","ORCSEND3",41,0)
 N ORSTART,ORCHLD,ORLAST,ORSIG,OROI,ID,OR3,ORIG,CODE,PKG,ORENEW,I,ORADMIN
"RTN","ORCSEND3",42,0)
 N ORDUR
"RTN","ORCSEND3",43,0)
 N CNT
"RTN","ORCSEND3",44,0)
 S ORPARENT=+ORIFN,OR0=$G(^OR(100,ORPARENT,0)),OR3=$G(^OR(100,ORPARENT,3))
"RTN","ORCSEND3",45,0)
 S ORCAT="I",ORNP=+$P(OR0,U,4)
"RTN","ORCSEND3",46,0)
 ;Q:$P(OR0,U,12)'="I"  S ORCAT="I",ORNP=+$P(OR0,U,4)
"RTN","ORCSEND3",47,0)
 S ORDIALOG=+$P(OR0,U,5),ORDUZ=+$P(OR0,U,6),ORLOG=$P(OR0,U,7)
"RTN","ORCSEND3",48,0)
 S ORL=$P(OR0,U,10),ORDG=+$P(OR0,U,11),PKG=$$GET1^DIQ(9.4,+$P(OR0,U,14)_",",1)
"RTN","ORCSEND3",49,0)
 ;Build ORDIALOG Array and ORX local array
"RTN","ORCSEND3",50,0)
 D GETDLG1^ORCD(ORDIALOG),GETORDER(ORPARENT)
"RTN","ORCSEND3",51,0)
 ;
"RTN","ORCSEND3",52,0)
 S ORSCH=$$PTR("SCHEDULE"),ORDUR=$$PTR("DURATION")
"RTN","ORCSEND3",53,0)
 D STRT S ORSTART=$G(ORSTRT("BEG"))
"RTN","ORCSEND3",54,0)
 S ORADMIN=$$PTR("ADMIN TIMES")
"RTN","ORCSEND3",55,0)
 D DATES^ORCSAVE2(ORPARENT,ORSTART) Q:$$DOSES(ORPARENT)<1
"RTN","ORCSEND3",56,0)
 S ORFRST=$$PTR("NOW"),ORSIG=$$PTR("SIG")
"RTN","ORCSEND3",57,0)
 ;
"RTN","ORCSEND3",58,0)
 I $P(OR3,U,11)=2,$O(^OR(100,+$P(OR3,U,5),2,0)) D
"RTN","ORCSEND3",59,0)
 . S ORENEW=+$P(OR3,U,5),I=0
"RTN","ORCSEND3",60,0)
 . I $$VALUE^ORX8(ORENEW,"NOW") S I=$O(^OR(100,ORENEW,2,0))
"RTN","ORCSEND3",61,0)
 . F  S I=$O(^OR(100,ORENEW,2,I)) Q:I<1  S ORENEW(I)=""
"RTN","ORCSEND3",62,0)
 ;
"RTN","ORCSEND3",63,0)
PSJI1 ;
"RTN","ORCSEND3",64,0)
 ;Build Order Dialog Prompts that can have Multiple Responses
"RTN","ORCSEND3",65,0)
 F ORP="ADDITIVE","ORDERABLE ITEM","STRENGTH PSIV","UNITS","VOLUME" D
"RTN","ORCSEND3",66,0)
 . N PTR S PTR=$$PTR(ORP) Q:PTR'>0  Q:'$D(ORX(PTR,1))
"RTN","ORCSEND3",67,0)
 . S CNT=0 F  S CNT=$O(ORX(PTR,CNT)) Q:CNT'>0  S ORDIALOG(PTR,CNT)=ORX(PTR,CNT)
"RTN","ORCSEND3",68,0)
 ;
"RTN","ORCSEND3",69,0)
 ;Build Order Dialog Responses that should be in both Child Orders
"RTN","ORCSEND3",70,0)
 F ORP="INFUSION RATE","IV TYPE","ROUTE","URGENCY","WORD PROCESSING 1" D
"RTN","ORCSEND3",71,0)
 . N PTR S PTR=$$PTR(ORP) Q:PTR'>0  Q:'$D(ORX(PTR,1))
"RTN","ORCSEND3",72,0)
 . S ORDIALOG(PTR,1)=ORX(PTR,1) S:$E(ORP)="O" OROI=ORX(PTR,1) Q
"RTN","ORCSEND3",73,0)
 ;
"RTN","ORCSEND3",74,0)
 ;If NOW order create NOW Child Order
"RTN","ORCSEND3",75,0)
 I $G(ORX(ORFRST,1)) D
"RTN","ORCSEND3",76,0)
 . S:$D(ORX(ORP,1)) ORDIALOG(ORP,1)=ORX(ORP,1)
"RTN","ORCSEND3",77,0)
 . ;S ID=$G(ORX(ORI,ORID)) S:$P(ID,"&",6) ORDIALOG(ORDD,1)=$P(ID,"&",6)
"RTN","ORCSEND3",78,0)
 . S ORDIALOG(ORSCH,1)="NOW",ORSTART=$$NOW^XLFDT
"RTN","ORCSEND3",79,0)
 . D CHILD(ORSTART)
"RTN","ORCSEND3",80,0)
 ;
"RTN","ORCSEND3",81,0)
 ;Build Order Fields for non-NOW Child Order
"RTN","ORCSEND3",82,0)
 F ORP=ORSCH,ORADMIN,ORDUR S:$D(ORX(ORP,1)) ORDIALOG(ORP,1)=ORX(ORP,1) K:'$D(ORX(ORP,1)) ORDIALOG(ORP,1)
"RTN","ORCSEND3",83,0)
 S ORSTART=$G(ORSTRT(1))
"RTN","ORCSEND3",84,0)
 D CHILD(ORSTART)
"RTN","ORCSEND3",85,0)
 ;
"RTN","ORCSEND3",86,0)
 S:$G(ORCHLD) ^OR(100,ORPARENT,2,0)="^100.002PA^"_ORLAST_U_ORCHLD
"RTN","ORCSEND3",87,0)
 S ORIFN=ORPARENT,ORQUIT=1,OR3=$G(^OR(100,ORIFN,3)),STS=$P(OR3,U,3)
"RTN","ORCSEND3",88,0)
 I (STS=1)!(STS=13)!(STS=11) S ORERR="1^Unable to release orders"
"RTN","ORCSEND3",89,0)
 D RELEASE^ORCSAVE2(ORIFN,1,ORNOW,DUZ,$G(NATURE)) K ^TMP("ORWORD",$J)
"RTN","ORCSEND3",90,0)
 S $P(^OR(100,ORIFN,3),U,8)=1 ;veil parent order - set stop date/time?
"RTN","ORCSEND3",91,0)
 Q:(STS=1)!(STS=13)!(STS=11)  ;unsuccessful
"RTN","ORCSEND3",92,0)
PSJI2 ; ck if parent is unsigned or edit
"RTN","ORCSEND3",93,0)
 I $P($G(^OR(100,ORIFN,8,1,0)),U,4)=2 S $P(^(0),U,4)="" K ^OR(100,"AS",ORVP,9999999-ORLOG,ORIFN,1) ;clear ES
"RTN","ORCSEND3",94,0)
 Q:$P(OR3,U,11)'=1  S ORIG=$P(OR3,U,5) Q:ORIG'>0
"RTN","ORCSEND3",95,0)
 S CODE=$S($P($G(^OR(100,ORIG,3)),U,3)=5:"CA",1:"DC")
"RTN","ORCSEND3",96,0)
 D MSG^ORMBLD(ORIG,CODE) I "^1^13^"[(U_$P($G(^OR(100,ORIG,3)),U,3)_U) D
"RTN","ORCSEND3",97,0)
 . N NATR S NATR=+$O(^ORD(100.02,"C","C",0))
"RTN","ORCSEND3",98,0)
 . S $P(^OR(100,ORIG,3),U,3)=12,$P(^(3),U,7)=0,^(6)=NATR_U_DUZ_U_ORNOW
"RTN","ORCSEND3",99,0)
 . D CANCEL^ORCSEND(ORIG) ;ck for unrel actions
"RTN","ORCSEND3",100,0)
 Q
"RTN","ORCSEND3",101,0)
PTR(X) ; Returns ptr of prompt X in Order Dialog file
"RTN","ORCSEND3",102,0)
 Q +$O(^ORD(101.41,"AB",$E("OR GTX "_X,1,63),0))
"RTN","ORCSEND3",103,0)
 ;
"RTN","ORCSEND3",104,0)
STRT ; Build ORSTRT(inst)=date.time array of start times by dose
"RTN","ORCSEND3",105,0)
 N OI,PSOI,XD,XH,XM,XS,ORWD,ORI,SCH,ORSD,X,ORD K ORSTRT
"RTN","ORCSEND3",106,0)
 S OI=$G(ORX($$PTR^ORCD("OR GTX ORDERABLE ITEM"),1))
"RTN","ORCSEND3",107,0)
 ;if OI is null assume Intermittent IV order this does not required a
"RTN","ORCSEND3",108,0)
 ;solution check for an additive only value
"RTN","ORCSEND3",109,0)
 I OI="" S OI=$G(ORX($$PTR^ORCD("OR GTX ADDITIVE"),1))
"RTN","ORCSEND3",110,0)
 S PSOI=+$P($G(^ORD(101.43,+OI,0)),U,2),(XD,XH,XM,XS)=0
"RTN","ORCSEND3",111,0)
 S ORWD=+$G(^SC(+$G(ORL),42)) ;ward
"RTN","ORCSEND3",112,0)
 ;S ORI=0 F  S ORI=$O(ORX(ORI)) Q:ORI<1  D
"RTN","ORCSEND3",113,0)
 S SCH=$G(ORX(ORSCH,1)),ORSD="" S:'$L(SCH) X=$$NOW^XLFDT
"RTN","ORCSEND3",114,0)
 S:$L(SCH) ORSD=$$STARTSTP^PSJORPOE(+ORVP,SCH,PSOI,ORWD),X=$P(ORSD,U,4)
"RTN","ORCSEND3",115,0)
 S ORSTRT(1)=$$FMADD^XLFDT(X,XD,XH,XM,XS) ;START+OFFSET
"RTN","ORCSEND3",116,0)
 ; find beginning date.time for parent
"RTN","ORCSEND3",117,0)
 S ORI=0,X=9999999 F  S ORI=$O(ORSTRT(ORI)) Q:ORI<1  I ORSTRT(ORI)<X S X=ORSTRT(ORI)
"RTN","ORCSEND3",118,0)
 S ORSTRT("BEG")=X
"RTN","ORCSEND3",119,0)
 Q
"RTN","ORWDXR")
0^1^B60135290^B59460463
"RTN","ORWDXR",1,0)
ORWDXR ;SLC/KCM/JDL - Utilites for Order Actions ;05/06/14  16:06
"RTN","ORWDXR",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,85,125,131,134,141,149,187,190,213,243,331,306,349,374,409**;Dec 17, 1997;Build 1
"RTN","ORWDXR",3,0)
 ;
"RTN","ORWDXR",4,0)
ACTDCREA(DCIEN) ; Valid DC Reason
"RTN","ORWDXR",5,0)
 N X
"RTN","ORWDXR",6,0)
 S X=$G(^ORD(100.03,DCIEN,0))
"RTN","ORWDXR",7,0)
 I $P(X,U,4) Q 0
"RTN","ORWDXR",8,0)
 I $P(X,U,5)'=+$O(^DIC(9.4,"C","OR",0)) Q 0
"RTN","ORWDXR",9,0)
 I $P(X,U,7)=+$O(^ORD(100.02,"C","A",0)) Q 0
"RTN","ORWDXR",10,0)
 Q 1
"RTN","ORWDXR",11,0)
 ;
"RTN","ORWDXR",12,0)
ISREL(VAL,ORIFN) ; Return true if an order has been released
"RTN","ORWDXR",13,0)
 N STS S STS=$P(^OR(100,+ORIFN,3),U,3)
"RTN","ORWDXR",14,0)
 S VAL=$S(STS=10:0,STS=11:0,1:1)  ; false if delayed or unreleased order
"RTN","ORWDXR",15,0)
 Q
"RTN","ORWDXR",16,0)
RENEW(REC,ORIFN,ORVP,ORNP,ORL,FLDS,CPLX,ORAPPT) ; Renew an order
"RTN","ORWDXR",17,0)
 N ORDG
"RTN","ORWDXR",18,0)
 N ORDUZ,ORSTS,OREVENT,ORCAT,ORDA,ORTS,ORNEW,ORCHECK,ORLOG,ORPKG
"RTN","ORWDXR",19,0)
 N ORDIALOG,PRMT,X0
"RTN","ORWDXR",20,0)
 N FSTDOSE,FST
"RTN","ORWDXR",21,0)
 ;*349 Allow for ORDUZ to come in through FLDS. Allow renewer to be specified by the caller.
"RTN","ORWDXR",22,0)
 S ORDUZ=$G(FLDS("ORDUZ"))
"RTN","ORWDXR",23,0)
 S (FSTDOSE,FST)=0
"RTN","ORWDXR",24,0)
 I '$D(CPLX) S CPLX=0
"RTN","ORWDXR",25,0)
 I '$G(ORAPPT) S ORAPPT=""
"RTN","ORWDXR",26,0)
 S ORVP=ORVP_";DPT(",ORL(2)=ORL_";SC(",ORL=ORL(2)
"RTN","ORWDXR",27,0)
 S X0=^OR(100,+ORIFN,0)
"RTN","ORWDXR",28,0)
 S ORDG=$P(X0,U,11)
"RTN","ORWDXR",29,0)
 S ORTS=$P(X0,U,13) ; 409 - Transfer Treating Specialty
"RTN","ORWDXR",30,0)
 S ORPKG=$P(X0,U,14)
"RTN","ORWDXR",31,0)
 I $D(FLDS("ORCHECK")) M ORCHECK=FLDS("ORCHECK")
"RTN","ORWDXR",32,0)
 I $P(X0,U,5)["101.41," D                        ; version 3
"RTN","ORWDXR",33,0)
 . S ORDIALOG=+$P(X0,U,5),ORCAT=$P(^OR(100,+ORIFN,0),U,12)
"RTN","ORWDXR",34,0)
 . D GETDLG^ORCD(ORDIALOG),GETORDER^ORCD(+ORIFN)
"RTN","ORWDXR",35,0)
 . I CPLX S FSTDOSE=$P($G(ORDIALOG("B","FIRST DOSE")),U,2) S:'FSTDOSE FSTDOSE=$$PTR^ORCD("OR GTX NOW")
"RTN","ORWDXR",36,0)
 . I FSTDOSE,$G(ORDIALOG(FSTDOSE,1)) K ORDIALOG(FSTDOSE,1)
"RTN","ORWDXR",37,0)
 E  D                                            ; version 2.5 generic
"RTN","ORWDXR",38,0)
 . S ORDIALOG=$O(^ORD(101.41,"B","OR GXTEXT WORD PROCESSING ORDE",0))
"RTN","ORWDXR",39,0)
 . D GETDLG^ORCD(ORDIALOG)
"RTN","ORWDXR",40,0)
 . S PRMT=$O(^ORD(101.41,"B","OR GTX WORD PROCESSING 1",0))
"RTN","ORWDXR",41,0)
 . S ORDIALOG(PRMT,1)=$NA(^TMP("ORWORD",$J,PRMT,1))
"RTN","ORWDXR",42,0)
 . M ^TMP("ORWORD",$J,PRMT,1)=^OR(100,+ORIFN,1)
"RTN","ORWDXR",43,0)
 . S PRMT=$O(^ORD(101.41,"B","OR GTX START DATE/TIME",0))
"RTN","ORWDXR",44,0)
 . I $P(X0,U,9) S ORDIALOG(PRMT,1)=$P(X0,U,9)
"RTN","ORWDXR",45,0)
 I +FLDS(1)=999 D  ; generic order
"RTN","ORWDXR",46,0)
 . S ORDIALOG($$PTR^ORCD("OR GTX START DATE/TIME"),1)=$P(FLDS(1),U,2)
"RTN","ORWDXR",47,0)
 . S ORDIALOG($$PTR^ORCD("OR GTX STOP DATE/TIME"),1)=$P(FLDS(1),U,3)
"RTN","ORWDXR",48,0)
 I ($O(^ORD(101.41,"AB","PS MEDS",0))>0),(+FLDS(1)=130)!(+FLDS(1)=135)!(+FLDS(1)=140),'$L($G(ORDIALOG($$PTR^ORCD("OR GTX SIG"),1))) D
"RTN","ORWDXR",49,0)
 . N ORDOSE,ORDRUG,ORCAT,ORWPSOI,PROMPT,DRUG
"RTN","ORWDXR",50,0)
 . S ORCAT=$P($G(^OR(100,+ORIFN,0)),U,12)
"RTN","ORWDXR",51,0)
 . S PROMPT=$$PTR^ORCD("OR GTX INSTRUCTIONS")
"RTN","ORWDXR",52,0)
 . S ORDRUG=$G(ORDIALOG($$PTR^ORCD("OR GTX DISPENSE DRUG"),1))
"RTN","ORWDXR",53,0)
 . S ORWPSOI=+$G(ORDIALOG($$PTR^ORCD("OR GTX ORDERABLE ITEM"),1))
"RTN","ORWDXR",54,0)
 . I ORWPSOI S ORWPSOI=+$P($G(^ORD(101.43,+ORWPSOI,0)),U,2)
"RTN","ORWDXR",55,0)
 . D DOSE^PSSORUTL(.ORDOSE,ORWPSOI,$S(ORCAT="I":"U",1:"O"),ORVP)       ; dflt doses
"RTN","ORWDXR",56,0)
 . D D1^ORCDPS2  ; set up ORDOSE
"RTN","ORWDXR",57,0)
 . S DRUG=$G(ORDOSE("DD",+ORDRUG))
"RTN","ORWDXR",58,0)
 . I DRUG,ORCAT="O" D RESETID^ORCDPS
"RTN","ORWDXR",59,0)
 . D SIG^ORCDPS2
"RTN","ORWDXR",60,0)
 I +FLDS(1)=140 D  ; outpatient meds
"RTN","ORWDXR",61,0)
 . K ORDIALOG($$PTR^ORCD("OR GTX START DATE"),1) ; remove effective dt
"RTN","ORWDXR",62,0)
 . S ORDIALOG($$PTR^ORCD("OR GTX REFILLS"),1)=$P(FLDS(1),U,4)
"RTN","ORWDXR",63,0)
 . S ORDIALOG($$PTR^ORCD("OR GTX ROUTING"),1)=$P(FLDS(1),U,5)
"RTN","ORWDXR",64,0)
 . S PRMT=$$PTR^ORCD("OR GTX WORD PROCESSING 1")
"RTN","ORWDXR",65,0)
 . K ^TMP("ORWORD",$J,PRMT,1)
"RTN","ORWDXR",66,0)
 . S I=1 F  S I=$O(FLDS(I)) Q:'I  S ^TMP("ORWORD",$J,PRMT,1,I-1,0)=FLDS(I)
"RTN","ORWDXR",67,0)
 . S ^TMP("ORWORD",$J,PRMT,1,0)=U_U_(I-1)_U_(I-1)_U_DT_U
"RTN","ORWDXR",68,0)
 . S ORDIALOG(PRMT,1)=$NA(^TMP("ORWORD",$J,PRMT,1))
"RTN","ORWDXR",69,0)
 . N SIG,PI,X S SIG=$$PTR^ORCD("OR GTX SIG")
"RTN","ORWDXR",70,0)
 . S PI=$$PTR^ORCD("OR GTX PATIENT INSTRUCTIONS"),X=$$STR(PI)
"RTN","ORWDXR",71,0)
 . I $L(X),$$STR(SIG)[X S ORDIALOG(PI,"FORMAT")="@" ;PI in Sig
"RTN","ORWDXR",72,0)
 D RN^ORCSAVE
"RTN","ORWDXR",73,0)
 S REC="" S ORIFN=+ORIFN_";"_ORDA D GETBYIFN^ORWORR(.REC,ORIFN)
"RTN","ORWDXR",74,0)
 Q
"RTN","ORWDXR",75,0)
RNWFLDS(LST,ORIFN) ; Return fields for renew action
"RTN","ORWDXR",76,0)
 ; LST(0)=RenewType^Start^Stop^Refills^Pickup  LST(n)=Comments
"RTN","ORWDXR",77,0)
 N X0,DG,PKG,RNWTYPE,START,STOP,REFILLS,OROI
"RTN","ORWDXR",78,0)
 S ORIFN=+ORIFN,X0=^OR(100,ORIFN,0),DG=$P(X0,U,11),PKG=$P(X0,U,14)
"RTN","ORWDXR",79,0)
 S PKG=$E($P(^DIC(9.4,PKG,0),U,2),1,2),DG=$P(^ORD(100.98,DG,0),U,3)
"RTN","ORWDXR",80,0)
 S LST(0)=$S(PKG="OR":999,PKG="PS"&(DG="O RX"):140,PKG="PS"&(DG="UD RX"):130,PKG="PS"&(DG="NV RX"):145,1:0)
"RTN","ORWDXR",81,0)
 I +LST(0)=140 D
"RTN","ORWDXR",82,0)
 . N ORPICK,ORPREV
"RTN","ORWDXR",83,0)
 . S ORPICK=$$DEFPICK^ORWDPS1("")
"RTN","ORWDXR",84,0)
 . I ORPICK="" D
"RTN","ORWDXR",85,0)
 .. N D3
"RTN","ORWDXR",86,0)
 .. S D3=$G(^OR(100,ORIFN,3))
"RTN","ORWDXR",87,0)
 .. I $P(D3,"^",3)=11,$P(D3,"^",11)=2 S ORPREV=$P(D3,"^",5) I ORPREV]"" S ORPICK=$$VAL(ORPREV,"PICKUP")
"RTN","ORWDXR",88,0)
 .. I $P(D3,"^",3)'=11 S ORPICK=$$VAL(ORIFN,"PICKUP")
"RTN","ORWDXR",89,0)
 .. I ORPICK="" S ORPICK="M^by Mail"
"RTN","ORWDXR",90,0)
 . S LST(0)=LST(0)_U_U_U_+$$VAL(ORIFN,"REFILLS")_U_ORPICK
"RTN","ORWDXR",91,0)
 . ;D WPVAL(.LST,ORIFN,"COMMENT")
"RTN","ORWDXR",92,0)
 I +LST(0)=999 S LST(0)=LST(0)_U_$$VAL(ORIFN,"START")_U_$$VAL(ORIFN,"STOP")
"RTN","ORWDXR",93,0)
 ; make sure start/stop times are relative times, otherwise use NOW, no Stop
"RTN","ORWDXR",94,0)
 ;I +$P(LST(0),U,2) S $P(LST(0),U,2)="NOW" ;DJE-VM *331 - moved to $$VAL
"RTN","ORWDXR",95,0)
 ;I +$P(LST(0),U,3)!($P(LST(0),U,3)="0") S $P(LST(0),U,3)=""
"RTN","ORWDXR",96,0)
 ;NEW STUFF AFTER THIS LINE OR*3*243
"RTN","ORWDXR",97,0)
 S $P(LST(0),U,9)=0
"RTN","ORWDXR",98,0)
 S OROI=$O(^OR(100,+ORIFN,4.5,"ID","ORDERABLE",0))
"RTN","ORWDXR",99,0)
 Q:'OROI
"RTN","ORWDXR",100,0)
 S OROI=$G(^OR(100,+ORIFN,4.5,OROI,1))
"RTN","ORWDXR",101,0)
 Q:'OROI
"RTN","ORWDXR",102,0)
 S $P(LST(0),U,9)=$$ISCLOZ^ORALWORD(OROI)
"RTN","ORWDXR",103,0)
 ; add to LST node specifying if patient of ORIFN passes clozapine lab tests
"RTN","ORWDXR",104,0)
 I $P(LST(0),U,9) D
"RTN","ORWDXR",105,0)
 .N ORY,ORDFN,ORTMP
"RTN","ORWDXR",106,0)
 .S ORTMP=LST(0)
"RTN","ORWDXR",107,0)
 .K LST
"RTN","ORWDXR",108,0)
 .S LST(0)=ORTMP
"RTN","ORWDXR",109,0)
 .S ORDFN=$P(^OR(100,ORIFN,0),U,2)
"RTN","ORWDXR",110,0)
 .I $P(ORDFN,";",2)'="DPT(" Q
"RTN","ORWDXR",111,0)
 .S ORDFN=+ORDFN
"RTN","ORWDXR",112,0)
 .D ALLWORD^ORALWORD(.ORY,ORDFN,ORIFN,"E")
"RTN","ORWDXR",113,0)
 .M LST(1)=ORY
"RTN","ORWDXR",114,0)
 Q
"RTN","ORWDXR",115,0)
VAL(ORIFN,ID) ; Return value for order response
"RTN","ORWDXR",116,0)
 N DA,Y,ORDIALOG,ORDGDA,CAPS,XCODE
"RTN","ORWDXR",117,0)
 S DA=+$O(^OR(100,ORIFN,4.5,"ID",ID,0))
"RTN","ORWDXR",118,0)
 I (ID="START")!(ID="STOP") D  I 1 ;DJE-VM *331
"RTN","ORWDXR",119,0)
 . ; make sure start/stop times are relative times, otherwise use dialog default values
"RTN","ORWDXR",120,0)
 . S CAPS=$$UP^XLFSTR($G(^OR(100,ORIFN,4.5,DA,1)))
"RTN","ORWDXR",121,0)
 . I ('$L(CAPS))!($E(CAPS)="T")!($E(CAPS)="V")!($E(CAPS)="N"&($E(CAPS,1,3)'="NOV")) S Y=CAPS Q
"RTN","ORWDXR",122,0)
 . S ORDIALOG=$P(^OR(100,+ORIFN,0),U,5)
"RTN","ORWDXR",123,0)
 . S ORDGDA=+^OR(100,ORIFN,4.5,DA,0)
"RTN","ORWDXR",124,0)
 . S XCODE=$G(^ORD(101.41,+ORDIALOG,10,ORDGDA,7))
"RTN","ORWDXR",125,0)
 . I $L(XCODE) X XCODE
"RTN","ORWDXR",126,0)
 . I '$L($G(Y)),ID="START" S Y="NOW" ;if no default, set START to NOW
"RTN","ORWDXR",127,0)
 E  S Y=$G(^OR(100,ORIFN,4.5,DA,1))
"RTN","ORWDXR",128,0)
 Q $G(Y)
"RTN","ORWDXR",129,0)
WPVAL(TXT,ORIFN,ID) ; Return word processing value
"RTN","ORWDXR",130,0)
 N DA S DA=+$O(^OR(100,ORIFN,4.5,"ID",ID,0))
"RTN","ORWDXR",131,0)
 S I=0 F  S I=$O(^OR(100,ORIFN,4.5,DA,2,I)) Q:'I  S TXT(I)=^(I,0)
"RTN","ORWDXR",132,0)
 Q
"RTN","ORWDXR",133,0)
STR(PTR) ; -- Return word processing text as long string for comparison
"RTN","ORWDXR",134,0)
 N X,Y,I,ARRY
"RTN","ORWDXR",135,0)
 S ARRY=$G(ORDIALOG(+$G(PTR),1)) Q:'$L(ARRY) ""
"RTN","ORWDXR",136,0)
 S I=+$O(@ARRY@(0)),Y=$$UP^XLFSTR($G(@ARRY@(I,0)))
"RTN","ORWDXR",137,0)
 F  S I=+$O(@ARRY@(I)) Q:'I  S X=$G(@ARRY@(I,0)),Y=Y_$$UP^XLFSTR(X)
"RTN","ORWDXR",138,0)
 S Y=$TR(Y," ") ;remove all spaces, compare only text
"RTN","ORWDXR",139,0)
 Q Y
"RTN","ORWDXR",140,0)
CHKACT(ORDERID,ORWSIG,ORWREL,ORWNATR) ; Return error if can't sign/release order
"RTN","ORWDXR",141,0)
 N ORACT,ORWERR
"RTN","ORWDXR",142,0)
 ; begin case
"RTN","ORWDXR",143,0)
 S ORACT=""
"RTN","ORWDXR",144,0)
 I (ORWSIG=1),$D(^XUSEC("ORES",DUZ)) S ORACT="ES" G XC1
"RTN","ORWDXR",145,0)
 I (ORWSIG=7),$D(^XUSEC("ORES",DUZ)) S ORACT="DS" G XC1
"RTN","ORWDXR",146,0)
 I ORWREL,(ORWNATR="W") S ORACT="OC" G XC1
"RTN","ORWDXR",147,0)
 I ORWREL S ORACT="RS" S:$P($G(^OR(100,+ORDERID,0)),U,16)<2 ORACT="ES"
"RTN","ORWDXR",148,0)
XC1 ; end case
"RTN","ORWDXR",149,0)
 S ORWERR=""
"RTN","ORWDXR",150,0)
 I $L(ORACT),$$VALID^ORCACT0(ORDERID,ORACT,.ORWERR,ORWNATR) S ORWERR=""
"RTN","ORWDXR",151,0)
 Q ORWERR
"RTN","ORWDXR",152,0)
GTORITM(Y,ORIFN) ;-- Get back the orderable item IEN
"RTN","ORWDXR",153,0)
 S ORIFN=+ORIFN
"RTN","ORWDXR",154,0)
 S Y=$$VALUE^ORCSAVE2(ORIFN,"ORDERABLE")
"RTN","ORWDXR",155,0)
 Q
"RTN","ORWDXR",156,0)
GETPKG(Y,IFN) ;Get package for an order
"RTN","ORWDXR",157,0)
 N ORDERID,PKGID
"RTN","ORWDXR",158,0)
 Q:+IFN<1
"RTN","ORWDXR",159,0)
 S ORDERID=+IFN,Y=""
"RTN","ORWDXR",160,0)
 S PKGID=$P(^OR(100,ORDERID,0),U,14)
"RTN","ORWDXR",161,0)
 S:PKGID>0 Y=$P(^DIC(9.4,PKGID,0),U,2)
"RTN","ORWDXR",162,0)
 Q
"RTN","ORWDXR",163,0)
ISCPLX(ORY,ORID) ; 1: is complex order 0: is not
"RTN","ORWDXR",164,0)
 Q:'$D(^OR(100,+ORID,0))
"RTN","ORWDXR",165,0)
 N PKG
"RTN","ORWDXR",166,0)
 S PKG=$P($G(^OR(100,+ORID,0)),U,14)
"RTN","ORWDXR",167,0)
 S PKG=$$NMSP^ORCD(PKG)
"RTN","ORWDXR",168,0)
 I PKG'="PS" Q
"RTN","ORWDXR",169,0)
 N NUMCHDS,NOWID,NOWVAL
"RTN","ORWDXR",170,0)
 S (NOWVAL,NOWID)=0
"RTN","ORWDXR",171,0)
 S NUMCHDS=$P($G(^OR(100,+ORID,2,0)),U,4)
"RTN","ORWDXR",172,0)
 I NUMCHDS>2 S ORY=1 Q
"RTN","ORWDXR",173,0)
 I NUMCHDS=2 D
"RTN","ORWDXR",174,0)
 . S ORY=1
"RTN","ORWDXR",175,0)
 . S:$D(^OR(100,+ORID,4.5,"ID","NOW")) NOWID=$O(^("NOW",0))
"RTN","ORWDXR",176,0)
 . S:NOWID NOWVAL=$G(^OR(100,+ORID,4.5,NOWID,1))
"RTN","ORWDXR",177,0)
 I NOWVAL=1 S ORY=0 Q
"RTN","ORWDXR",178,0)
 Q
"RTN","ORWDXR",179,0)
ORCPLX(ORY,ORID,ORACT) ;Return children orders of the complex order
"RTN","ORWDXR",180,0)
 Q:'$D(^OR(100,+ORID,0))
"RTN","ORWDXR",181,0)
 N PKG,LACT,OELACT,ISNOW
"RTN","ORWDXR",182,0)
 S PKG=$P($G(^OR(100,+ORID,0)),U,14)
"RTN","ORWDXR",183,0)
 S PKG=$$NMSP^ORCD(PKG)
"RTN","ORWDXR",184,0)
 I PKG'="PS" Q
"RTN","ORWDXR",185,0)
 N CHLDCNT,IDX,X3
"RTN","ORWDXR",186,0)
 S (CHLDCNT,IDX)=0
"RTN","ORWDXR",187,0)
 S:$L($G(^OR(100,+ORID,2,0))) CHLDCNT=$P(^(0),U,4)
"RTN","ORWDXR",188,0)
 I 'CHLDCNT Q
"RTN","ORWDXR",189,0)
 F  S IDX=$O(^OR(100,+ORID,2,IDX)) Q:'IDX  D
"RTN","ORWDXR",190,0)
 . S (LACT,OELACT,ISNOW)=0
"RTN","ORWDXR",191,0)
 . D ISNOW(.ISNOW,IDX)
"RTN","ORWDXR",192,0)
 . Q:ISNOW
"RTN","ORWDXR",193,0)
 . S X3=$G(^OR(100,IDX,3))
"RTN","ORWDXR",194,0)
 . S LACT=$P(X3,U,7)
"RTN","ORWDXR",195,0)
 . F  S OELACT=$O(^OR(100,IDX,8,OELACT),-1) Q:OELACT
"RTN","ORWDXR",196,0)
 . S:OELACT>LACT LACT=OELACT
"RTN","ORWDXR",197,0)
 . S ORY(IDX)=IDX_";"_LACT
"RTN","ORWDXR",198,0)
 Q
"RTN","ORWDXR",199,0)
CANRN(ORY,ORID) ; Check conjunction for renew.
"RTN","ORWDXR",200,0)
 ; All conjunctioni = "And" return 1
"RTN","ORWDXR",201,0)
 ; Has a "Then" return 0
"RTN","ORWDXR",202,0)
 Q:'$G(^OR(100,+ORID,0))
"RTN","ORWDXR",203,0)
 N PKG
"RTN","ORWDXR",204,0)
 S PKG=$P($G(^OR(100,+ORID,0)),U,14)
"RTN","ORWDXR",205,0)
 S PKG=$$NMSP^ORCD(PKG)
"RTN","ORWDXR",206,0)
 I PKG'="PS" Q
"RTN","ORWDXR",207,0)
 N INDX,INDY,CANRENEW
"RTN","ORWDXR",208,0)
 S INDX=0
"RTN","ORWDXR",209,0)
 S CANRENEW=1
"RTN","ORWDXR",210,0)
 N CHID
"RTN","ORWDXR",211,0)
 S CHID=0 F  S CHID=$O(^OR(100,+ORID,2,CHID)) Q:'CHID  D
"RTN","ORWDXR",212,0)
 . N ORSTS,ACTIVE S ORSTS=0
"RTN","ORWDXR",213,0)
 . S ORSTS=$P($G(^OR(100,CHID,3)),U,3)
"RTN","ORWDXR",214,0)
 . S ACTIVE=$O(^ORD(100.01,"B","ACTIVE",0))
"RTN","ORWDXR",215,0)
 . I ACTIVE'=ORSTS S CANRENEW=0
"RTN","ORWDXR",216,0)
 I 'CANRENEW S ORY=CANRENEW Q
"RTN","ORWDXR",217,0)
 F  S INDX=$O(^OR(100,+ORID,4.5,"ID","CONJ",INDX)) Q:'INDX  D
"RTN","ORWDXR",218,0)
 . S INDY=0 F  S INDY=$O(^OR(100,+ORID,4.5,INDX,INDY)) Q:'INDY  D
"RTN","ORWDXR",219,0)
 . . I $G(^(INDY))="T" S CANRENEW=0 Q
"RTN","ORWDXR",220,0)
 . I CANRENEW=0 Q
"RTN","ORWDXR",221,0)
 S ORY=CANRENEW
"RTN","ORWDXR",222,0)
 Q
"RTN","ORWDXR",223,0)
ISNOW(ORY,ORID) ; Is first time now order?
"RTN","ORWDXR",224,0)
 N SCH
"RTN","ORWDXR",225,0)
 Q:'$D(^OR(100,+ORID,0))
"RTN","ORWDXR",226,0)
 S SCH=""
"RTN","ORWDXR",227,0)
 S SCH=$O(^OR(100,+ORID,4.5,"ID","SCHEDULE",0))
"RTN","ORWDXR",228,0)
 S:SCH SCH=$G(^OR(100,+ORID,4.5,SCH,1))
"RTN","ORWDXR",229,0)
 S:SCH="NOW" ORY=1
"RTN","ORWDXR",230,0)
 Q
"VER")
8.0^22.0
"BLD",9949,6)
^355
**END**
**END**

