Released OR*3*375 SEQ #336
Extracted from mail message
**KIDS**:OR*3.0*375^

**INSTALL NAME**
OR*3.0*375
"BLD",9474,0)
OR*3.0*375^ORDER ENTRY/RESULTS REPORTING^0^3130726^y
"BLD",9474,1,0)
^^1^1^3130726^
"BLD",9474,1,1,0)
Delayed order-Framestack-Cumulative Report fixes
"BLD",9474,4,0)
^9.64PA^^
"BLD",9474,6.3)
1
"BLD",9474,"KRN",0)
^9.67PA^779.2^20
"BLD",9474,"KRN",.4,0)
.4
"BLD",9474,"KRN",.401,0)
.401
"BLD",9474,"KRN",.402,0)
.402
"BLD",9474,"KRN",.403,0)
.403
"BLD",9474,"KRN",.5,0)
.5
"BLD",9474,"KRN",.84,0)
.84
"BLD",9474,"KRN",3.6,0)
3.6
"BLD",9474,"KRN",3.8,0)
3.8
"BLD",9474,"KRN",9.2,0)
9.2
"BLD",9474,"KRN",9.8,0)
9.8
"BLD",9474,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",9474,"KRN",9.8,"NM",1,0)
ORCMEDT5^^0^B37965466
"BLD",9474,"KRN",9.8,"NM",2,0)
ORWLR1^^0^B40488173
"BLD",9474,"KRN",9.8,"NM",3,0)
ORWDFH^^0^B53150906
"BLD",9474,"KRN",9.8,"NM","B","ORCMEDT5",1)

"BLD",9474,"KRN",9.8,"NM","B","ORWDFH",3)

"BLD",9474,"KRN",9.8,"NM","B","ORWLR1",2)

"BLD",9474,"KRN",19,0)
19
"BLD",9474,"KRN",19.1,0)
19.1
"BLD",9474,"KRN",101,0)
101
"BLD",9474,"KRN",409.61,0)
409.61
"BLD",9474,"KRN",771,0)
771
"BLD",9474,"KRN",779.2,0)
779.2
"BLD",9474,"KRN",870,0)
870
"BLD",9474,"KRN",8989.51,0)
8989.51
"BLD",9474,"KRN",8989.52,0)
8989.52
"BLD",9474,"KRN",8994,0)
8994
"BLD",9474,"KRN","B",.4,.4)

"BLD",9474,"KRN","B",.401,.401)

"BLD",9474,"KRN","B",.402,.402)

"BLD",9474,"KRN","B",.403,.403)

"BLD",9474,"KRN","B",.5,.5)

"BLD",9474,"KRN","B",.84,.84)

"BLD",9474,"KRN","B",3.6,3.6)

"BLD",9474,"KRN","B",3.8,3.8)

"BLD",9474,"KRN","B",9.2,9.2)

"BLD",9474,"KRN","B",9.8,9.8)

"BLD",9474,"KRN","B",19,19)

"BLD",9474,"KRN","B",19.1,19.1)

"BLD",9474,"KRN","B",101,101)

"BLD",9474,"KRN","B",409.61,409.61)

"BLD",9474,"KRN","B",771,771)

"BLD",9474,"KRN","B",779.2,779.2)

"BLD",9474,"KRN","B",870,870)

"BLD",9474,"KRN","B",8989.51,8989.51)

"BLD",9474,"KRN","B",8989.52,8989.52)

"BLD",9474,"KRN","B",8994,8994)

"BLD",9474,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9474,"QUES",0)
^9.62^^
"BLD",9474,"REQB",0)
^9.611^2^2
"BLD",9474,"REQB",1,0)
OR*3.0*314^1
"BLD",9474,"REQB",2,0)
OR*3.0*332^1
"BLD",9474,"REQB","B","OR*3.0*314",1)

"BLD",9474,"REQB","B","OR*3.0*332",2)

"MBREQ")
0
"PKG",174,-1)
1^1
"PKG",174,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",174,20,0)
^9.402P^^
"PKG",174,22,0)
^9.49I^1^1
"PKG",174,22,1,0)
3.0^2971217^2990325^66481
"PKG",174,22,1,"PAH",1,0)
375^3130726
"PKG",174,22,1,"PAH",1,1,0)
^^1^1^3130726
"PKG",174,22,1,"PAH",1,1,1,0)
Delayed order-Framestack-Cumulative Report fixes
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","ORCMEDT5")
0^1^B37965466^B36616080
"RTN","ORCMEDT5",1,0)
ORCMEDT5 ;SLC/MKB-Misc menu utilities ;03:29 PM  12 Feb 1999
"RTN","ORCMEDT5",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**8,46,296,314,375**;Dec 17, 1997;Build 1
"RTN","ORCMEDT5",3,0)
SEARCH ; -- Search/replace menu items
"RTN","ORCMEDT5",4,0)
 N ORDLG
"RTN","ORCMEDT5",5,0)
 F  S ORDLG=$$DIC Q:ORDLG'>0  D SR1(ORDLG) W !!
"RTN","ORCMEDT5",6,0)
 Q
"RTN","ORCMEDT5",7,0)
 ;
"RTN","ORCMEDT5",8,0)
SR1(ORX) ; -- list parents, get replacement
"RTN","ORCMEDT5",9,0)
 N CNT,DA,DR,DIE,DIK,I,J,ORDAD,ORY,ORNMBR,NUM,ORI,ORDAD,ORNM
"RTN","ORCMEDT5",10,0)
 I '$O(^ORD(101.41,"AD",+ORX,0)) W !,$P(ORX,U,2)_" has no menu items." Q
"RTN","ORCMEDT5",11,0)
 W @IOF,"Menu items of "_$P(ORX,U,2),!?4,"Name",?69,"Type",!,$$REPEAT^XLFSTR("-",79)
"RTN","ORCMEDT5",12,0)
 S (I,ORDAD)=0 F  S I=$O(^ORD(101.41,"AD",+ORX,I)) Q:I'>0  D
"RTN","ORCMEDT5",13,0)
 . S J=0 F  S J=$O(^ORD(101.41,"AD",+ORX,I,J)) Q:J'>0  D
"RTN","ORCMEDT5",14,0)
 . . S ORDAD=ORDAD+1,ORDAD(ORDAD)=I_U_J
"RTN","ORCMEDT5",15,0)
 . . W !,ORDAD,?4,$P(^ORD(101.41,I,0),U),?69,$$TYPE($P(^(0),U,4))
"RTN","ORCMEDT5",16,0)
 W !,$$REPEAT^XLFSTR("-",79)
"RTN","ORCMEDT5",17,0)
 S ORY=$$REPLWITH(ORX) Q:ORY="^"
"RTN","ORCMEDT5",18,0)
 D SELECT(ORY,ORDAD,.ORNMBR) Q:ORNMBR="^"
"RTN","ORCMEDT5",19,0)
 Q:'$$OK  W !!,$S(ORY="@":"Removing",1:"Replacing "_$P(ORX,U,2)_" with "_$P(ORY,U,2))_" in:"
"RTN","ORCMEDT5",20,0)
 S CNT="" F  S CNT=$O(ORNMBR(CNT)) Q:CNT=""  D
"RTN","ORCMEDT5",21,0)
 . D LOOP($G(ORNMBR(CNT)))
"RTN","ORCMEDT5",22,0)
 Q
"RTN","ORCMEDT5",23,0)
LOOP(ORNMBR)    ;
"RTN","ORCMEDT5",24,0)
 F ORI=1:1:$L(ORNMBR,",") S NUM=$P(ORNMBR,",",ORI) I NUM D
"RTN","ORCMEDT5",25,0)
 . S DA(1)=+ORDAD(NUM),DA=$P(ORDAD(NUM),U,2),DIE="^ORD(101.41,"_DA(1)_",10,"
"RTN","ORCMEDT5",26,0)
 . S ORDAD=DA(1),ORNM=$P(^ORD(101.41,ORDAD,0),U) W !?3,ORNM_" ..."
"RTN","ORCMEDT5",27,0)
 . I '$$VALID(ORY,ORDAD,.ORERR) D  Q
"RTN","ORCMEDT5",28,0)
 . . W "not "_$S(ORY="@":"removed.",1:"changed."),!?3,">> "_$G(ORERR)
"RTN","ORCMEDT5",29,0)
 . . S I=0 F  S I=$O(ORERR(I)) Q:I'>0  W !?25,"=>"_ORERR(I)
"RTN","ORCMEDT5",30,0)
 . I ORY="@" S DIK=DIE D ^DIK W "done." Q
"RTN","ORCMEDT5",31,0)
 . S DR="2////"_+ORY D ^DIE W $S($P(^ORD(101.41,DA(1),10,DA,0),U,2)=+ORY:"done.",1:"error - not replaced.")
"RTN","ORCMEDT5",32,0)
 Q
"RTN","ORCMEDT5",33,0)
 ;
"RTN","ORCMEDT5",34,0)
TYPE(X) ; -- Returns name of dialog type
"RTN","ORCMEDT5",35,0)
 N Y S Y=$S(X="P":"prompt",X="D":"dialog",X="Q":"quick order",X="O":"order set",X="M":"menu",X="A":"action",1:"")
"RTN","ORCMEDT5",36,0)
 Q Y
"RTN","ORCMEDT5",37,0)
 ;
"RTN","ORCMEDT5",38,0)
DIC() ; -- ^DIC on Order Dialog file
"RTN","ORCMEDT5",39,0)
 N X,Y,DIC
"RTN","ORCMEDT5",40,0)
 S DIC=101.41,DIC(0)="AEQM",DIC("A")="Search for: "
"RTN","ORCMEDT5",41,0)
 S DIC("?")="Enter the name of the dialog component you wish to search for."
"RTN","ORCMEDT5",42,0)
 D ^DIC
"RTN","ORCMEDT5",43,0)
 Q Y
"RTN","ORCMEDT5",44,0)
 ;
"RTN","ORCMEDT5",45,0)
SELECT(ORY,MAX,Y) ; -- Select which Dlgs to replace items
"RTN","ORCMEDT5",46,0)
 N X,DIR
"RTN","ORCMEDT5",47,0)
 S DIR(0)="LA^1:"_MAX,DIR("A")=$S(ORY="@":"Remove in: ",1:"Replace in: "),DIR("B")=$S(MAX>1:"1-"_MAX,1:"1")
"RTN","ORCMEDT5",48,0)
 ; S DIR("?")
"RTN","ORCMEDT5",49,0)
 D ^DIR S:$D(DTOUT)!(X["^") Y="^"
"RTN","ORCMEDT5",50,0)
 Q
"RTN","ORCMEDT5",51,0)
 ;
"RTN","ORCMEDT5",52,0)
OK() ; -- Are you ready?
"RTN","ORCMEDT5",53,0)
 N X,Y,DIR
"RTN","ORCMEDT5",54,0)
 S DIR(0)="YA",DIR("A")="Are you ready? ",DIR("B")="NO"
"RTN","ORCMEDT5",55,0)
 W ! D ^DIR
"RTN","ORCMEDT5",56,0)
 Q +Y
"RTN","ORCMEDT5",57,0)
 ;
"RTN","ORCMEDT5",58,0)
REPLWITH(ORIT) ; -- Remove item, or select replacement
"RTN","ORCMEDT5",59,0)
 N X,Y,DIR,DIC
"RTN","ORCMEDT5",60,0)
 S DIR(0)="FAO^1:63",DIR("A")="Replace "_$P(ORIT,U,2)_" with: "
"RTN","ORCMEDT5",61,0)
 S DIR("?")="Enter the name of the item you wish to replace this one with, or @ to remove this item; to quit without changing anything, press <return>."
"RTN","ORCMEDT5",62,0)
R1 D ^DIR I X="@" Q "@"
"RTN","ORCMEDT5",63,0)
 I $D(DTOUT)!("^"[X) Q "^"
"RTN","ORCMEDT5",64,0)
 S DIC=101.41,DIC(0)="EQM" D ^DIC I Y'>0 G R1
"RTN","ORCMEDT5",65,0)
 Q Y
"RTN","ORCMEDT5",66,0)
 ;
"RTN","ORCMEDT5",67,0)
VALID(ITM,DAD,ERR) ; -- Ck if ITM may be placed on DAD
"RTN","ORCMEDT5",68,0)
 N DTYPE,ITYPE,Y S Y=0
"RTN","ORCMEDT5",69,0)
 S DTYPE=$P(^ORD(101.41,DAD,0),U,4) I DTYPE="D",$$NMSP^ORCD($P(^(0),U,7))'="OR" S ERR="Only generic ordering dialogs are editable." G VQ
"RTN","ORCMEDT5",70,0)
 I ITM="@" S Y=1 G VQ ; ok to delete
"RTN","ORCMEDT5",71,0)
 S ITYPE=$P(^ORD(101.41,+ITM,0),U,4)
"RTN","ORCMEDT5",72,0)
 I ITYPE="P",DTYPE'="D" S ERR="A prompt may not be added to a "_$$TYPE(DTYPE)_"." G VQ
"RTN","ORCMEDT5",73,0)
 I ITYPE="A","DOM"'[DTYPE S ERR="An action may not be added to a "_$$TYPE(DTYPE)_"." G VQ
"RTN","ORCMEDT5",74,0)
 I "DQOM"[ITYPE,"OM"'[DTYPE S ERR="A "_$$TYPE(ITYPE)_" may not be added to a "_$$TYPE(DTYPE)_"." G VQ
"RTN","ORCMEDT5",75,0)
 D RECURSV(+ITM,DAD,.ERR) I $D(ERR) S Y=0 G VQ
"RTN","ORCMEDT5",76,0)
 S Y=1 ; ok
"RTN","ORCMEDT5",77,0)
VQ Q Y
"RTN","ORCMEDT5",78,0)
 ;
"RTN","ORCMEDT5",79,0)
RECURSV(ITEM,MENU,MSG) ; -- Return 1 or 0, if recursive reference to ITEM
"RTN","ORCMEDT5",80,0)
 N STACK,CNT S STACK=0,CNT=0
"RTN","ORCMEDT5",81,0)
 K MSG
"RTN","ORCMEDT5",82,0)
 I ITEM=MENU S MSG="Recursive Reference: "_$P($G(^ORD(101.41,ITEM,0)),U) Q  ;p375 prevents menu on itself
"RTN","ORCMEDT5",83,0)
 D CHKPAR(MENU)
"RTN","ORCMEDT5",84,0)
 Q
"RTN","ORCMEDT5",85,0)
CHKPAR(MENU) ; follow tree to check parents
"RTN","ORCMEDT5",86,0)
 N PMENU,I
"RTN","ORCMEDT5",87,0)
 S STACK=STACK+1,STACK(STACK)=MENU,STACK("B",MENU)=STACK,PMENU=0
"RTN","ORCMEDT5",88,0)
 F  S PMENU=$O(^ORD(101.41,"AD",MENU,PMENU)) Q:'PMENU  D  Q:$D(MSG)
"RTN","ORCMEDT5",89,0)
 . I PMENU=ITEM D  Q
"RTN","ORCMEDT5",90,0)
 . . S MSG="Recursive Reference: "_$P(^ORD(101.41,ITEM,0),U)
"RTN","ORCMEDT5",91,0)
 . . F I=STACK:-1:1 S CNT=CNT+1,MSG(CNT)=$P(^ORD(101.41,STACK(I),0),U)
"RTN","ORCMEDT5",92,0)
 . I $D(STACK("B",PMENU)) Q
"RTN","ORCMEDT5",93,0)
 . D CHKPAR(PMENU)
"RTN","ORCMEDT5",94,0)
 K STACK(STACK) S STACK=STACK-1
"RTN","ORCMEDT5",95,0)
 Q
"RTN","ORCMEDT5",96,0)
 ;
"RTN","ORCMEDT5",97,0)
INUSE(MENU) ; -- Returns 1 or 0, if MENU is in use by parameter
"RTN","ORCMEDT5",98,0)
 N PARAM,ENT,Y
"RTN","ORCMEDT5",99,0)
 S PARAM=$O(^XTV(8989.51,"B","OR ADD ORDERS MENU",0)),Y=0
"RTN","ORCMEDT5",100,0)
 S ENT="" F  S ENT=$O(^XTV(8989.5,"AC",PARAM,ENT)) Q:ENT=""  I $G(^(ENT,1))=MENU S Y=1 Q
"RTN","ORCMEDT5",101,0)
 Q Y
"RTN","ORCMEDT5",102,0)
 ;
"RTN","ORCMEDT5",103,0)
ASSIGN ; -- Assign menu to user(s)
"RTN","ORCMEDT5",104,0)
 D FULL^VALM1
"RTN","ORCMEDT5",105,0)
 D EDITPAR^XPAREDIT("OR ADD ORDERS MENU")
"RTN","ORCMEDT5",106,0)
 S VALMBCK="R"
"RTN","ORCMEDT5",107,0)
 Q
"RTN","ORCMEDT5",108,0)
 ;
"RTN","ORCMEDT5",109,0)
INQ ; -- Inquire to Order Dialog file
"RTN","ORCMEDT5",110,0)
 N X,Y,DIC,DA,DR,DIQ
"RTN","ORCMEDT5",111,0)
 S DIC="^ORD(101.41,",DIC(0)="AEQM"
"RTN","ORCMEDT5",112,0)
 F  D ^DIC Q:Y'>0  S DA=+Y W ! D EN^DIQ W !
"RTN","ORCMEDT5",113,0)
 Q
"RTN","ORCMEDT5",114,0)
 ;
"RTN","ORCMEDT5",115,0)
OUTPUT(ORY) ; -- Output Xform for Value field of Response multiple
"RTN","ORCMEDT5",116,0)
 N ORDIALOG,ORP,ORZ S ORZ=ORY
"RTN","ORCMEDT5",117,0)
 S ORP=$P($G(^ORD(101.41,D0,6,D1,0)),U,2)
"RTN","ORCMEDT5",118,0)
 I ORP S ORDIALOG(ORP,0)=$P($G(^ORD(101.41,ORP,1)),U,1,2),ORDIALOG(ORP,1)=ORY,ORZ=$$EXT^ORCD(ORP,1)
"RTN","ORCMEDT5",119,0)
 Q ORZ
"RTN","ORCMEDT5",120,0)
 ;
"RTN","ORCMEDT5",121,0)
AOPAR ; -- List of add order menus assigned to users
"RTN","ORCMEDT5",122,0)
 N BY,DHD,DIC,FLDS,FR,TO
"RTN","ORCMEDT5",123,0)
 S DIC=8989.5
"RTN","ORCMEDT5",124,0)
 S FR="OR ADD ORDERS MENU,?",TO="OR ADD ORDERS MENU,?"
"RTN","ORCMEDT5",125,0)
 S BY="@.02,@1;S2;""Add order menu: """
"RTN","ORCMEDT5",126,0)
 S DHD="CPRS Add order menu list"
"RTN","ORCMEDT5",127,0)
 S FLDS="VALUE;N;""Menu"",ENTITY;""User/Location/etc."";C40"
"RTN","ORCMEDT5",128,0)
 D EN1^DIP
"RTN","ORCMEDT5",129,0)
 Q
"RTN","ORCMEDT5",130,0)
 ;
"RTN","ORCMEDT5",131,0)
DISABLE ; -- Disable order dialogs
"RTN","ORCMEDT5",132,0)
 N X,Y,DIC,DIR,ORDIS,ORI K ^TMP("ORDISABLE",$J)
"RTN","ORCMEDT5",133,0)
 S DIC=101.41,DIC(0)="AEQM",DIC("A")="Select ORDER DIALOG: ",DIC("?")="Enter the name of an order dialog you wish to disable."
"RTN","ORCMEDT5",134,0)
 S DIC("W")="I $L($P(^(0),U,3)) W !?3,"">> disabled: ""_$P(^(0),U,3)"
"RTN","ORCMEDT5",135,0)
 F  D ^DIC Q:Y'>0  S ^TMP("ORDISABLE",$J,+Y)="" S DIC("A")="ANOTHER ONE: "
"RTN","ORCMEDT5",136,0)
 Q:'$O(^TMP("ORDISABLE",$J,0))  ;none selected
"RTN","ORCMEDT5",137,0)
 W !!,"Enter a message to disable the dialog(s), or @ to enable again."
"RTN","ORCMEDT5",138,0)
 S DIR(0)="FAO^1:40",DIR("A")="MESSAGE: "
"RTN","ORCMEDT5",139,0)
 S DIR("?")="Enter up to 40 characters explaining why use of this dialog has been disabled that will display if the dialog is selected, or @ to enable the dialog again."
"RTN","ORCMEDT5",140,0)
 D ^DIR G:$D(DTOUT)!$D(DUOUT)!(X="") DQ S ORDIS=X
"RTN","ORCMEDT5",141,0)
 I '$$OK W !,"Nothing "_$S(ORDIS="@":"en",1:"dis")_"abled." H 1 G DQ
"RTN","ORCMEDT5",142,0)
 S ORI=0  F  S ORI=$O(^TMP("ORDISABLE",$J,ORI)) Q:ORI'>0  S $P(^ORD(101.41,ORI,0),U,3)=$S(ORDIS="@":"",1:ORDIS) W "."
"RTN","ORCMEDT5",143,0)
 W !,"done." H 1
"RTN","ORCMEDT5",144,0)
DQ K ^TMP("ORDISABLE",$J)
"RTN","ORCMEDT5",145,0)
 Q
"RTN","ORWDFH")
0^3^B53150906^B51608431
"RTN","ORWDFH",1,0)
ORWDFH ; SLC/KCM/JLI - Diet Order calls for Windows Dialogs ;12/12/00  14:44
"RTN","ORWDFH",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,92,141,187,215,243,375**;Dec 17, 1997;Build 1
"RTN","ORWDFH",3,0)
TXT(LST,DFN)    ; Return text of current & future diets for a patient
"RTN","ORWDFH",4,0)
 S LST(1)="Current Diet:  "_$$DIET^ORCDFH(DFN)
"RTN","ORWDFH",5,0)
 N FUTLST D FUT(.FUTLST,DFN) I $D(FUTLST)>1 D
"RTN","ORWDFH",6,0)
 . S LST(2)="Future Diet Orders:",ILST=2
"RTN","ORWDFH",7,0)
 . S I=0 F  S I=$O(FUTLST(I)) Q:'I  D
"RTN","ORWDFH",8,0)
 . . S X=$$FMTE^XLFDT(I,2)_"  "_$P(FUTLST(I),U,2)
"RTN","ORWDFH",9,0)
 . . S LST(ILST)=$S(ILST=2:"Future Diet Orders:  "_X,1:"   "_X)
"RTN","ORWDFH",10,0)
 . . S ILST=ILST+1
"RTN","ORWDFH",11,0)
 Q
"RTN","ORWDFH",12,0)
FUT(LST,DFN)    ; Return a list of future diet orders
"RTN","ORWDFH",13,0)
 N DGRP,NXTDT,ORIFN,ORVP,ORTX
"RTN","ORWDFH",14,0)
 S ORVP=DFN_";DPT(",DGRP=$O(^ORD(100.98,"B","DO",0)),NXTDT=$$NOW^XLFDT
"RTN","ORWDFH",15,0)
 F  S NXTDT=$O(^OR(100,"AW",ORVP,DGRP,NXTDT)) Q:NXTDT'>0  D
"RTN","ORWDFH",16,0)
 . S ORIFN=+$O(^OR(100,"AW",ORVP,DGRP,NXTDT,0))
"RTN","ORWDFH",17,0)
 . I $P($G(^OR(100,ORIFN,3)),U,3)'=8 Q  ; only scheduled diets
"RTN","ORWDFH",18,0)
 . D TEXT^ORQ12(.ORTX,ORIFN) S LST(NXTDT)=NXTDT_U_$G(ORTX(1))
"RTN","ORWDFH",19,0)
 Q
"RTN","ORWDFH",20,0)
PARAM(ORLST,ORVP,ORLOC)  ; Return dietetics parameters for a patient at a location
"RTN","ORWDFH",21,0)
 ; ORLOC: hospital location ptr to ^SC #44
"RTN","ORWDFH",22,0)
 ; ORLST(1)=EB1^EB2^EB3^LB1^LB2^LB3^EN1^EN2^...LE2^LE3
"RTN","ORWDFH",23,0)
 ; ORLST(2)=BAB^BAE^NAB^NAE^EAB^EAE^BegB^BegN^BegE^Bagged
"RTN","ORWDFH",24,0)
 ; ORLST(3)=type of service^RegIEN^NPOIEN^EarlyIEN^LateIEN^TFIFN
"RTN","ORWDFH",25,0)
 ; ORLST(4)=max days in future for outpatient recurring meals
"RTN","ORWDFH",26,0)
 ; ORLST(5)=default outpatient diet
"RTN","ORWDFH",27,0)
 Q:'+ORVP
"RTN","ORWDFH",28,0)
 N X,IEN,CURTM
"RTN","ORWDFH",29,0)
 S ORVP=+ORVP_";DPT(",ORLOC=+ORLOC
"RTN","ORWDFH",30,0)
 S CURTM=$$NOW^XLFDT
"RTN","ORWDFH",31,0)
 I +$G(^SC(ORLOC,42)) S ORLOC=$G(^SC(ORLOC,42))_";DIC(42"
"RTN","ORWDFH",32,0)
 E  S ORLOC=ORLOC_";SC("
"RTN","ORWDFH",33,0)
 D EN1^FHWOR8(ORLOC,.ORLST)
"RTN","ORWDFH",34,0)
 ;
"RTN","ORWDFH",35,0)
 S:'$D(ORLST(1)) ORLST(1)="" S:'$D(ORLST(2)) ORLST(2)="" ;p375 corrected array return for missing/invalid location
"RTN","ORWDFH",36,0)
 I '$L($G(ORLST(3))) S ORLST(3)="TCD" ;p375 changed default from "T" to "TCD" 
"RTN","ORWDFH",37,0)
 S $P(ORLST(3),U,2)=$O(^ORD(101.43,"S.DIET","REGULAR",0))
"RTN","ORWDFH",38,0)
 S $P(ORLST(3),U,3)=$O(^ORD(101.43,"S.DIET","NPO",0))
"RTN","ORWDFH",39,0)
 S $P(ORLST(3),U,4)=$O(^ORD(101.43,"S.E/L T","EARLY TRAY",0))
"RTN","ORWDFH",40,0)
 S $P(ORLST(3),U,5)=$O(^ORD(101.43,"S.E/L T","LATE TRAY",0))
"RTN","ORWDFH",41,0)
 N TF S TF=$$CURRENT^ORCDFH("TF") I $L(TF,";")=1 S TF=TF_";1"
"RTN","ORWDFH",42,0)
 I TF,'$$FUTURE^ORCDFH("EFFECTIVE DATE/TIME") S $P(ORLST(3),U,6)=TF
"RTN","ORWDFH",43,0)
 I $$VERSION^XPDUTL("FH")>5 D
"RTN","ORWDFH",44,0)
 . S ORLST(4)=$$MAXDAYS^FHOMAPI(ORLOC)
"RTN","ORWDFH",45,0)
 . D DIETLST^FHOMAPI Q:'$G(FHDIET(1))
"RTN","ORWDFH",46,0)
 . S IEN=$O(^ORD(101.43,"ID",$P(FHDIET(1),U,1)_";99FHD",0)) Q:+IEN=0
"RTN","ORWDFH",47,0)
 . S X=^ORD(101.43,"S.DIET",$P(FHDIET(1),U,2),IEN)
"RTN","ORWDFH",48,0)
 . I +$P(X,U,3),$P(X,U,3)<CURTM Q
"RTN","ORWDFH",49,0)
 . I $P($G(^ORD(101.43,IEN,"FH")),U)'="D",($P($G(^(0)),U)'="NPO") Q
"RTN","ORWDFH",50,0)
 . S ORLST(5)=+$G(IEN)
"RTN","ORWDFH",51,0)
 Q
"RTN","ORWDFH",52,0)
ATTR(REC,OI)    ; Return OI^Text^Type^Precedence^AskExpire for a diet
"RTN","ORWDFH",53,0)
 I $G(^ORD(101.43,OI,.1)),^(.1)'>$$NOW^XLFDT S REC="0^"_$P($G(^ORD(101.43,OI,0)),U)_" has been inactivated and may not be ordered anymore." Q
"RTN","ORWDFH",54,0)
 S REC=OI_U_$P($G(^ORD(101.43,OI,0)),U)_U_$G(^("FH"))
"RTN","ORWDFH",55,0)
 Q
"RTN","ORWDFH",56,0)
DIETS(Y,FROM,DIR)       ; Return a subset of active diets, including NPO
"RTN","ORWDFH",57,0)
 ; Y(n)=IEN^.01 Name^.01 Name  -or-  IEN^Synonym <.01 Name>^.01 Name
"RTN","ORWDFH",58,0)
 N I,IEN,CNT,X,CURTM
"RTN","ORWDFH",59,0)
 S I=0,CNT=44,CURTM=$$NOW^XLFDT
"RTN","ORWDFH",60,0)
 F  Q:I'<CNT  S FROM=$O(^ORD(101.43,"S.DIET",FROM),DIR) Q:FROM=""  D
"RTN","ORWDFH",61,0)
 . S IEN=0 F  S IEN=$O(^ORD(101.43,"S.DIET",FROM,IEN)) Q:'IEN  D
"RTN","ORWDFH",62,0)
 . . S X=^ORD(101.43,"S.DIET",FROM,IEN)
"RTN","ORWDFH",63,0)
 . . I +$P(X,U,3),$P(X,U,3)<CURTM Q
"RTN","ORWDFH",64,0)
 . . I $P($G(^ORD(101.43,IEN,"FH")),U)'="D",($P($G(^(0)),U)'="NPO") Q
"RTN","ORWDFH",65,0)
 . . S I=I+1
"RTN","ORWDFH",66,0)
 . . I 'X S Y(I)=IEN_U_$P(X,U,2)_U_$P(X,U,2)
"RTN","ORWDFH",67,0)
 . . E  S Y(I)=IEN_U_$P(X,U,2)_$C(9)_"<"_$P(X,U,4)_">"_U_$P(X,U,4)
"RTN","ORWDFH",68,0)
 Q
"RTN","ORWDFH",69,0)
OPDIETS(ORY,FROM,DIR)   ;Return a list of up to 5 outpatient diets from file 119.9
"RTN","ORWDFH",70,0)
 N X,I,J,IEN,CURTM,SYNCNT,SYNTOT,FHDIET
"RTN","ORWDFH",71,0)
 D DIETLST^FHOMAPI
"RTN","ORWDFH",72,0)
 S CURTM=$$NOW^XLFDT,I=0,SYNTOT=1
"RTN","ORWDFH",73,0)
 F  S I=$O(FHDIET(I)) Q:'I  D
"RTN","ORWDFH",74,0)
 . S IEN=$O(^ORD(101.43,"ID",$P(FHDIET(I),U,1)_";99FHD",0)) Q:+IEN=0
"RTN","ORWDFH",75,0)
 . S X=^ORD(101.43,"S.DIET",$P(FHDIET(I),U,2),IEN)
"RTN","ORWDFH",76,0)
 . I +$P(X,U,3),$P(X,U,3)<CURTM Q
"RTN","ORWDFH",77,0)
 . I $P($G(^ORD(101.43,IEN,"FH")),U)'="D",($P($G(^(0)),U)'="NPO") Q
"RTN","ORWDFH",78,0)
 . S X=$P(^ORD(101.43,IEN,0),U,1)
"RTN","ORWDFH",79,0)
 . S SYNCNT=$P($G(^ORD(101.43,IEN,2,0)),U,4),J=0
"RTN","ORWDFH",80,0)
 . S ORY(X)=IEN_U_X_U_X
"RTN","ORWDFH",81,0)
 . I +SYNCNT  D  Q
"RTN","ORWDFH",82,0)
 . . S SYNTOT=SYNTOT+SYNCNT
"RTN","ORWDFH",83,0)
 . . F  S J=$O(^ORD(101.43,IEN,2,J)) Q:'J  D
"RTN","ORWDFH",84,0)
 . . . S ORY(^ORD(101.43,IEN,2,J,0))=IEN_U_^ORD(101.43,IEN,2,J,0)_$C(9)_"<"_X_">"_U_X
"RTN","ORWDFH",85,0)
 Q
"RTN","ORWDFH",86,0)
TFPROD(Y)     ; Return a list of active tubefeeding products
"RTN","ORWDFH",87,0)
 N I,IEN,NAM,X,CURTM
"RTN","ORWDFH",88,0)
 S I=0,NAM="",CURTM=$$NOW^XLFDT
"RTN","ORWDFH",89,0)
 F  S NAM=$O(^ORD(101.43,"S.TF",NAM)) Q:NAM=""  D
"RTN","ORWDFH",90,0)
 . S IEN=0 F  S IEN=$O(^ORD(101.43,"S.TF",NAM,IEN)) Q:'IEN  D
"RTN","ORWDFH",91,0)
 . . S X=^ORD(101.43,"S.TF",NAM,IEN)
"RTN","ORWDFH",92,0)
 . . I +$P(X,U,3),$P(X,U,3)<CURTM Q
"RTN","ORWDFH",93,0)
 . . S I=I+1
"RTN","ORWDFH",94,0)
 . . I 'X S Y(I)=IEN_U_$P(X,U,2)_U_$P(X,U,2)
"RTN","ORWDFH",95,0)
 . . E  S Y(I)=IEN_U_$P(X,U,2)_$C(9)_"<"_$P(X,U,4)_">"_U_$P(X,U,4)
"RTN","ORWDFH",96,0)
 Q
"RTN","ORWDFH",97,0)
QTY2CC(VAL,PRD,STR,QTY)     ; Return cc's given a product, strength, & quantity
"RTN","ORWDFH",98,0)
 N X,VQTY,DUR
"RTN","ORWDFH",99,0)
 S VQTY=$$VALIDQTY^ORCDFHTF(QTY) I '$L(VQTY)!('PRD)!('STR) S VAL="" Q
"RTN","ORWDFH",100,0)
 S PRD=+$P($G(^ORD(101.43,PRD,0)),U,2)
"RTN","ORWDFH",101,0)
 S DUR=$P(VQTY," X ",2) I $L(DUR) S DUR=$S(DUR["H":"H",1:"X")_+DUR
"RTN","ORWDFH",102,0)
 S X=+VQTY_"&"_$E($P(VQTY," ",2))_U_$P($P(VQTY,"/",2)," ")_U_DUR
"RTN","ORWDFH",103,0)
 S VAL=$$QUAN^FHWOR5R(PRD_"-"_STR,X)_U_VQTY
"RTN","ORWDFH",104,0)
 Q
"RTN","ORWDFH",105,0)
FINDTYP(VAL,DGRP)       ; Return type of dietetics order based on display group
"RTN","ORWDFH",106,0)
 S VAL=$P($G(^ORD(100.98,DGRP,0)),U,3)
"RTN","ORWDFH",107,0)
 S:VAL="D AO" VAL="A" S VAL=$E(VAL)
"RTN","ORWDFH",108,0)
 Q
"RTN","ORWDFH",109,0)
ISOIEN(VAL)     ; Return IEN for the Isolation/Precaution orderable item
"RTN","ORWDFH",110,0)
 S VAL=$O(^ORD(101.43,"S.PREC","ISOLATION PROCEDURES",0))
"RTN","ORWDFH",111,0)
 Q
"RTN","ORWDFH",112,0)
CURISO(VAL,ORVP) ; Return a patient's current isolation
"RTN","ORWDFH",113,0)
 S ORVP=ORVP_";DPT(" S VAL=$P($$IP^ORMBLD,U,2)
"RTN","ORWDFH",114,0)
 I '$L(VAL) S VAL="<none>"
"RTN","ORWDFH",115,0)
 Q
"RTN","ORWDFH",116,0)
ISOLIST(LST)    ; Return list of active isolations/precautions
"RTN","ORWDFH",117,0)
 N I,X,IEN
"RTN","ORWDFH",118,0)
 S I=0,X="" F  S X=$O(^FH(119.4,"B",X)) Q:X=""  S IEN=$O(^(X,0)) D
"RTN","ORWDFH",119,0)
 . I '$D(^FH(119.4,IEN,"I")) S I=I+1,LST(I)=IEN_U_X
"RTN","ORWDFH",120,0)
 Q
"RTN","ORWDFH",121,0)
MILTM(X)        ; return military time for am/pm time
"RTN","ORWDFH",122,0)
 N TM
"RTN","ORWDFH",123,0)
 S TM=$P(X,":",1)_+$P(X,":",2)
"RTN","ORWDFH",124,0)
 I X["P",TM<1200 S TM=TM+1200
"RTN","ORWDFH",125,0)
 I X["A",TM>1200 S TM=TM-1200
"RTN","ORWDFH",126,0)
 Q TM
"RTN","ORWDFH",127,0)
 ;
"RTN","ORWDFH",128,0)
ASKLATE(REC,DFN,ORIFN)        ; Return info for ordering late tray for diet order
"RTN","ORWDFH",129,0)
 ; REC=0  or  1^meal^bagged^time^time^time
"RTN","ORWDFH",130,0)
 S REC=0 Q:'$G(ORIFN)  Q:$E($$VALUE^ORX8(ORIFN,"ORDERABLE",1,"E"),1,3)="NPO"
"RTN","ORWDFH",131,0)
 N X,Y,%DT,STRT,DATE,ORPARAM,I,MEAL,MEALTIME
"RTN","ORWDFH",132,0)
 S X=$O(^OR(100,ORIFN,4.5,"ID","START",0)),X=$G(^OR(100,ORIFN,4.5,+X,1))
"RTN","ORWDFH",133,0)
 Q:X=""  S %DT="TX" D ^%DT Q:Y'>0  Q:$P(Y,".")>DT  ;invalid or future
"RTN","ORWDFH",134,0)
 S DATE=$P(Y,"."),STRT=+$E($P(Y,".",2)_"0000",1,4),MEAL=0
"RTN","ORWDFH",135,0)
 D EN^FHWOR8(DFN,.ORPARAM) Q:'$D(ORPARAM(2))
"RTN","ORWDFH",136,0)
 F I=1,3,5 I $P(ORPARAM(2),U,I)<STRT,STRT<$P(ORPARAM(2),U,I+1) S MEAL=I Q
"RTN","ORWDFH",137,0)
 S MEAL=$S(MEAL=1:4,MEAL=3:10,MEAL=5:16,1:0) Q:'MEAL
"RTN","ORWDFH",138,0)
 S MEALTIME=$P(ORPARAM(1),U,MEAL,MEAL+2)
"RTN","ORWDFH",139,0)
 S MEAL=$S(MEAL=4:"B",MEAL=10:"N",MEAL=16:"E",1:"")
"RTN","ORWDFH",140,0)
 F I=1:1:3 S X=$$MILTM($P(MEAL,U,I)) I X<STRT S $P(MEAL,U,I)=""
"RTN","ORWDFH",141,0)
 S REC="1"_U_MEAL_U_$P(ORPARAM(2),U,10)_U_MEALTIME
"RTN","ORWDFH",142,0)
 I $P(REC,U,2,4)="^^" S REC=0
"RTN","ORWDFH",143,0)
 Q
"RTN","ORWDFH",144,0)
ADDLATE(REC,ORVP,ORNP,ORL,MEAL,TIME,BAG)      ; Add late tray order
"RTN","ORWDFH",145,0)
 N ORIFN,ORNEW,ORDUZ,ORSTS,OREVENT,ORCAT,ORDA,ORTS,ORCHECK,ORLOG
"RTN","ORWDFH",146,0)
 N ORDIALOG,ORDG,ORTYPE,DA,FIRST,TRAY
"RTN","ORWDFH",147,0)
 S ORVP=ORVP_";DPT(",ORL(2)=ORL_";SC(",ORL=ORL(2)
"RTN","ORWDFH",148,0)
 S ORTYPE="D",FIRST=1,ORDUZ=DUZ,ORLOG=+$E($$NOW^XLFDT,1,12)
"RTN","ORWDFH",149,0)
 S TRAY=+$O(^ORD(101.43,"S.E/L T","LATE TRAY",0))
"RTN","ORWDFH",150,0)
 S ORDIALOG=$O(^ORD(101.41,"AB","FHW2",0))
"RTN","ORWDFH",151,0)
 D GETDLG^ORCD(ORDIALOG)
"RTN","ORWDFH",152,0)
 S ORDIALOG($$PTR^ORCD("OR GTX MEAL"),1)=MEAL
"RTN","ORWDFH",153,0)
 S ORDIALOG($$PTR^ORCD("OR GTX ORDERABLE ITEM"),1)=TRAY
"RTN","ORWDFH",154,0)
 S ORDIALOG($$PTR^ORCD("OR GTX START DATE"),1)=DT
"RTN","ORWDFH",155,0)
 S ORDIALOG($$PTR^ORCD("OR GTX STOP DATE"),1)=DT
"RTN","ORWDFH",156,0)
 S ORDIALOG($$PTR^ORCD("OR GTX MEAL TIME"),1)=TIME
"RTN","ORWDFH",157,0)
 S ORDIALOG($$PTR^ORCD("OR GTX YES/NO"),1)=BAG
"RTN","ORWDFH",158,0)
 D EN^ORCSAVE
"RTN","ORWDFH",159,0)
 S REC="" I ORIFN D GETBYIFN^ORWORR(.REC,ORIFN)
"RTN","ORWDFH",160,0)
 Q
"RTN","ORWDFH",161,0)
CURMEALS(ORY,ORDFN,ORMEAL)     ;Return current list of recurring meals for AO and TF orders
"RTN","ORWDFH",162,0)
 N I,Y,X S I=0
"RTN","ORWDFH",163,0)
 S ORMEAL=$G(ORMEAL,"")
"RTN","ORWDFH",164,0)
 D EN2^FHWOR8(ORDFN,ORMEAL,.ORY)
"RTN","ORWDFH",165,0)
 F  S I=$O(ORY(I)) Q:'I  D
"RTN","ORWDFH",166,0)
 . S X=$P(ORY(I),U,2)
"RTN","ORWDFH",167,0)
 . S Y=$P(ORY(I),U,1) D DD^%DT S $P(ORY(I),U,2)=Y
"RTN","ORWDFH",168,0)
 . S $P(ORY(I),U,3)=$S(X="B":"Breakfast",X="N":"Noon",X="E":"Evening",1:"")
"RTN","ORWDFH",169,0)
 Q
"RTN","ORWDFH",170,0)
NFSLOC(ORLOC) ;Get NUTRITION LOCATION name for HOSPITAL LOCATION
"RTN","ORWDFH",171,0)
 Q $$NFSLOC^FHOMAPI(ORLOC)
"RTN","ORWDFH",172,0)
OPLOCOK(ORY,ORLOC) ; OK to order OP Meals from this location
"RTN","ORWDFH",173,0)
 I 'ORLOC S ORY=0 Q
"RTN","ORWDFH",174,0)
 S ORY=$S($L($$NFSLOC^FHOMAPI(ORLOC))>0:1,1:0)
"RTN","ORWDFH",175,0)
 Q
"RTN","ORWLR1")
0^2^B40488173^B40020805
"RTN","ORWLR1",1,0)
ORWLR1 ; slc/dcm -  VBEC Blood Bank Report ;01/16/03  15:02
"RTN","ORWLR1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**172,212,309,332,375**;Dec 17, 1997;Build 1
"RTN","ORWLR1",3,0)
 ;Re-write of ^LR7OSBR
"RTN","ORWLR1",4,0)
EN(DFN) ;Get Blood Bank Report
"RTN","ORWLR1",5,0)
 Q:'$G(DFN)
"RTN","ORWLR1",6,0)
 N GCNT,CCNT,GIOSL,GIOM,ORABORH,PATID,PATNAM,PATDOB,ORN
"RTN","ORWLR1",7,0)
 S PATID="`"_DFN,PATNAM=$P(^DPT(DFN,0),"^"),PATDOB=$P(^(0),"^",3) ;Why PATNAM and PATDOB???
"RTN","ORWLR1",8,0)
 K ^TMP("ORLRC",$J)
"RTN","ORWLR1",9,0)
 S GCNT=0,CCNT=1,GIOSL=999999,GIOM=80
"RTN","ORWLR1",10,0)
 S ORABORH=$$ABORH^VBECA1(PATID,PATNAM,PATDOB) ;Get ABO/RH
"RTN","ORWLR1",11,0)
 I $E(ORABORH,1,2)="1^" S ORX("ERROR")=ORABORH D  Q  ;Isolate error condition
"RTN","ORWLR1",12,0)
 . N GCNT,CCNT,GIOSL,GIOM,I,TYPE,ORUA,VBERROR,ABFND,LINE1,LINE2,NOABO,NOPAT,TREQFND
"RTN","ORWLR1",13,0)
 . S (GCNT,NOPAT,NOABO)=0,CCNT=1,GIOSL=999999,GIOM=80
"RTN","ORWLR1",14,0)
 . ;S OROOT=$NA(^TMP("ORVBEC",$J)) ;p375 line removed because it is not needed and causing issues
"RTN","ORWLR1",15,0)
 . D ERROR^ORWDXVB2("^TMP(""ORLRC"",$J)")
"RTN","ORWLR1",16,0)
 S ORN(2.91)="DIRECT AHG TEST COMMENT",ORN(8)="ANTIBODY SCREEN COMMENT"
"RTN","ORWLR1",17,0)
 S ORN(10.3)="ABO TESTING COMMENT",ORN(11.3)="RH TESTING COMMENT"
"RTN","ORWLR1",18,0)
 D EN^ORWLR2
"RTN","ORWLR1",19,0)
 Q
"RTN","ORWLR1",20,0)
REPORT ;Blood Bank Report for M reports menu
"RTN","ORWLR1",21,0)
 Q:'$G(DFN)
"RTN","ORWLR1",22,0)
 N DIC,ID,ORDFN,ORY,PAGE,XQORNOD,ORDAYSBK
"RTN","ORWLR1",23,0)
 S ORDFN=DFN,ID=2
"RTN","ORWLR1",24,0)
 D BLR^ORWRP1(.ORY,.ORDFN,.ID,.ORALPHA,.OROMEGA,.ORDAYSBK,.REMOTE)
"RTN","ORWLR1",25,0)
 Q:'$L(ORY)
"RTN","ORWLR1",26,0)
 S PAGE=1
"RTN","ORWLR1",27,0)
 D HEAD^ORWRPP1(ORDFN,PAGE,"PATIENT BLOOD BANK REPORT",$G(STATION))
"RTN","ORWLR1",28,0)
 D HURL^ORWRPP1(.ORY,ORDFN,"PATIENT BLOOD BANK REPORT",,,1)
"RTN","ORWLR1",29,0)
 Q
"RTN","ORWLR1",30,0)
GETPAT(ERR) ;Setup Patient Variables
"RTN","ORWLR1",31,0)
 N ORPNM
"RTN","ORWLR1",32,0)
 S ERR=0
"RTN","ORWLR1",33,0)
 D EN2^ORUDPA
"RTN","ORWLR1",34,0)
 I 'ORVP S ERR=1 Q
"RTN","ORWLR1",35,0)
 S PATID="`"_+ORVP,PATNAM=ORPNM,PATDOB=$P(^DPT(+ORVP,0),"^",3)
"RTN","ORWLR1",36,0)
 D PAT^VBECA1A
"RTN","ORWLR1",37,0)
 W !,LRDFN
"RTN","ORWLR1",38,0)
 I $O(VBECERR(0)) D  S ERR=1 Q
"RTN","ORWLR1",39,0)
 . S ERR=0 F  S ERR=$O(VBECERR(ERR)) Q:'ERR  W !?5," ERR:"_VBECERR(1)
"RTN","ORWLR1",40,0)
 Q
"RTN","ORWLR1",41,0)
TEST ;Test calls
"RTN","ORWLR1",42,0)
 N ORVP,PATID,PATNAM,PATDOB,LRDFN,ERR,ABORH,ID,ID1,ID2,ARR,GMI,DI2,BPN,VBECERR,ERROR
"RTN","ORWLR1",43,0)
 D GETPAT(.ERROR)
"RTN","ORWLR1",44,0)
 I $G(ERROR) W !,"Error on Patient lookup" Q
"RTN","ORWLR1",45,0)
 D ABORH,ABID,TRRX,DFN,CPRS,TRAN
"RTN","ORWLR1",46,0)
 I $O(^TMP("VBDATA",$J,"CROSSMATCH",0)) D
"RTN","ORWLR1",47,0)
 . W !,"Crossmatched Units: " S ID=0 F  S ID=$O(^TMP("VBDATA",$J,"CROSSMATCH",ID)) Q:'ID  W !?2,^(ID)
"RTN","ORWLR1",48,0)
 K ^TMP("VBDATA",$J),^TMP("TRRX",$J),^TMP("TRAN",$J)
"RTN","ORWLR1",49,0)
 Q
"RTN","ORWLR1",50,0)
OEAPI ;Test call to OEAPI^VBECA3
"RTN","ORWLR1",51,0)
 N DIV,ORSTN,ERROR,ORVB
"RTN","ORWLR1",52,0)
 D GETPAT^ORWLR1(.ERROR)
"RTN","ORWLR1",53,0)
 I $G(ERROR) W !,"Error on Patient lookup" Q
"RTN","ORWLR1",54,0)
 S DIV=+$P($G(^SC(+$G(ORL),0)),U,15),ORSTN=$P($$SITE^VASITE(DT,DIV),U,3)
"RTN","ORWLR1",55,0)
 D OEAPI^VBECA3(.ORVB,+ORVP,ORSTN)
"RTN","ORWLR1",56,0)
 I $O(ORVB(0)) D
"RTN","ORWLR1",57,0)
 . W !,"Array returned from OEAPI^VBECA3 API in ORVB():",!
"RTN","ORWLR1",58,0)
 . ;ZW ORVB
"RTN","ORWLR1",59,0)
 K ^TMP("OR",$J),^TMP("VBECRPC",$J),^TMP("VBECS_XML_RES",$J),^TMP("VBEC_OE_DATA",$J)
"RTN","ORWLR1",60,0)
 Q
"RTN","ORWLR1",61,0)
ABORH ;Test call to ABORH^VBECA1 for ABO/Rh - DBIA 3181
"RTN","ORWLR1",62,0)
 N ERROR
"RTN","ORWLR1",63,0)
 I '$G(ORVP) D GETPAT(.ERROR)
"RTN","ORWLR1",64,0)
 I $G(ERROR) W !,"Error on Patient lookup" Q
"RTN","ORWLR1",65,0)
 S ABORH=$$ABORH^VBECA1(PATID,PATNAM,PATDOB) W !,"ABO/RH: "_ABORH
"RTN","ORWLR1",66,0)
 Q
"RTN","ORWLR1",67,0)
ABID ;Test call to ABID^VBECA1 for Antibodies Identified - DBIA 3181, 3184
"RTN","ORWLR1",68,0)
 N ID,ERROR,ORPARNT
"RTN","ORWLR1",69,0)
 I '$G(ORVP) D GETPAT(.ERROR)
"RTN","ORWLR1",70,0)
 I $G(ERROR) W !,"Error on Patient lookup" Q
"RTN","ORWLR1",71,0)
 D ABID^VBECA1(PATID,PATNAM,PATDOB,.ORPARNT,.ORARR) I $O(ARR("ABID",0)) D
"RTN","ORWLR1",72,0)
 . W !,"Antibodies Identified: " S ID=0 F  S ID=$O(ARR("ABID",ID)) Q:'ID  W !?2,ARR("ABID",ID)
"RTN","ORWLR1",73,0)
 Q
"RTN","ORWLR1",74,0)
DFN ;Test call to DFN^VBECA3A - DBIA 3879
"RTN","ORWLR1",75,0)
 N ID,ID1,ID2,ERROR
"RTN","ORWLR1",76,0)
 K ^TMP("VBDATA",$J)
"RTN","ORWLR1",77,0)
 I '$G(ORVP) D GETPAT(.ERROR)
"RTN","ORWLR1",78,0)
 I $G(ERROR) W !,"Error on Patient lookup" Q
"RTN","ORWLR1",79,0)
 D DFN^VBECA3A(DFN)
"RTN","ORWLR1",80,0)
 I $O(^TMP("VBDATA",$J,"COMPONENT REQUEST",0)) D
"RTN","ORWLR1",81,0)
 . W !,"Component request: " S ID=0 F  S ID=$O(^TMP("VBDATA",$J,"COMPONENT REQUEST",ID)) Q:'ID  W !?2,^(ID) D
"RTN","ORWLR1",82,0)
 .. S ID1=0 F  S ID1=$O(^TMP("VBDATA",$J,"COMPONENT REQUEST",ID,ID1)) Q:'ID1  W !,"."_^(ID1)
"RTN","ORWLR1",83,0)
 I $O(^TMP("VBDATA",$J,"SPECIMEN",0)) D
"RTN","ORWLR1",84,0)
 . W !,"Specimen: " S ID=0 F  S ID=$O(^TMP("VBDATA",$J,"SPECIMEN",ID)) Q:'ID  W !?2,^(ID) D
"RTN","ORWLR1",85,0)
 .. S ID1=0 F  S ID1=$O(^TMP("VBDATA",$J,"SPECIMEN",ID,ID1)) Q:'ID1  W:$D(^(ID1))#2 !,"."_^(ID1) D
"RTN","ORWLR1",86,0)
 ... S ID2=0 F  S ID2=$O(^TMP("VBDATA",$J,"SPECIMEN",ID,ID1,ID2)) Q:'ID2  W:$D(^(ID2))#2 !,".."_^(ID2)
"RTN","ORWLR1",87,0)
 I $O(^TMP("VBDATA",$J,"UNIT",0)) D
"RTN","ORWLR1",88,0)
 . W !,"Available Units: "
"RTN","ORWLR1",89,0)
 . S ID=0 F  S ID=$O(^TMP("VBDATA",$J,"UNIT",ID)) Q:'ID  W !?2,^(ID)
"RTN","ORWLR1",90,0)
 Q
"RTN","ORWLR1",91,0)
CPRS ;Test call to CPRS^VBECA3B - DBIA 3880
"RTN","ORWLR1",92,0)
 N ID,ID1,ID2,ERROR
"RTN","ORWLR1",93,0)
 K ^TMP("BBD",$J)
"RTN","ORWLR1",94,0)
 I '$G(ORVP) D GETPAT(.ERROR)
"RTN","ORWLR1",95,0)
 I $G(ERROR) W !,"Error on Patient lookup" Q
"RTN","ORWLR1",96,0)
 D CPRS^VBECA3B
"RTN","ORWLR1",97,0)
 I $O(^TMP("BBD",$J,"SPECIMEN",0)) D
"RTN","ORWLR1",98,0)
 . W !,"Specimen: " S ID=0 F  S ID=$O(^TMP("BBD",$J,"SPECIMEN",ID)) Q:'ID  W !?2,^(ID) D
"RTN","ORWLR1",99,0)
 .. S ID1=0 F  S ID1=$O(^TMP("BBD",$J,"SPECIMEN",ID,ID1)) Q:'ID1  W:$D(^(ID1))#2 !,"."_^(ID1) D
"RTN","ORWLR1",100,0)
 ... S ID2=0 F  S ID2=$O(^TMP("BBD",$J,"SPECIMEN",ID,ID1,ID2)) Q:'ID2  W:$D(^(ID2))#2 !,".."_^(ID2)
"RTN","ORWLR1",101,0)
 Q
"RTN","ORWLR1",102,0)
TRAN ;Test call to TRAN^VBECA4 for Tranfused Units - DBIA 3176
"RTN","ORWLR1",103,0)
 N BPN,ID,GMI,GMR,ERROR,CNT,ORAY,COMP,COMPSEQ,X,TD
"RTN","ORWLR1",104,0)
 K ^TMP("TRAN",$J),^TMP("ZTRAN",$J)
"RTN","ORWLR1",105,0)
 I '$G(ORVP) D GETPAT(.ERROR)
"RTN","ORWLR1",106,0)
 I $G(ERROR) W !,"Error on Patient lookup" Q
"RTN","ORWLR1",107,0)
 D TRAN^VBECA4(+ORVP,"TRAN")
"RTN","ORWLR1",108,0)
 ;^TMP("TRAN",$J,InverseDate)="Date^Number of Units\Product Type"
"RTN","ORWLR1",109,0)
 ;^TMP("TRAN",$J,"Product Type")="Product Type Print Name"
"RTN","ORWLR1",110,0)
 S CNT=0 F ID="RBC","FFP","PLT","CRY","PLA","SER","GRA","WB" S CNT=CNT+1,ORAY(ID)=CNT
"RTN","ORWLR1",111,0)
 S ID=0 F  S ID=$O(^TMP("TRAN",$J,ID)) Q:'ID  S GMR=^(ID),COMP=$P(GMR,"^",2),COMP=$P(COMP,"\",2),COMP=$E($P(COMP,";"),1,3),COMPSEQ=$S($D(ORAY(COMP)):ORAY(COMP),1:99) D
"RTN","ORWLR1",112,0)
 . I '$D(^TMP("ZTRAN",$J,$P(ID,"."),COMPSEQ)) S ^TMP("ZTRAN",$J,$P(ID,"."),COMPSEQ)=GMR_"^"_1 Q
"RTN","ORWLR1",113,0)
 . S CNT=$P(^TMP("ZTRAN",$J,$P(ID,"."),COMPSEQ),"^",3),$P(^(COMPSEQ),"^",3)=CNT+1
"RTN","ORWLR1",114,0)
 I $O(^TMP("ZTRAN",$J,0)) D
"RTN","ORWLR1",115,0)
 . W !,"Sorted/grouped Transfused Units: ",! S ID=0
"RTN","ORWLR1",116,0)
 . F  S ID=$O(^TMP("ZTRAN",$J,ID)) Q:'ID  S COMP="" F  S COMP=$O(^TMP("ZTRAN",$J,ID,COMP)) Q:COMP=""  S GMR=^(COMP) D
"RTN","ORWLR1",117,0)
 .. I $P(GMR,"^",3) S $P(GMR,"^",2)=$P(GMR,"^",3)_"\"_$P($P(GMR,"^",2),"\",2)
"RTN","ORWLR1",118,0)
 .. D PARSE,WRT
"RTN","ORWLR1",119,0)
 I $O(^TMP("TRAN",$J,0)) D
"RTN","ORWLR1",120,0)
 . W !,"Transfused Units (from VBECS API): ",! S ID=0
"RTN","ORWLR1",121,0)
 . F  S ID=$O(^TMP("TRAN",$J,ID)) Q:'ID  S GMR=^(ID) D
"RTN","ORWLR1",122,0)
 .. D PARSE,WRT
"RTN","ORWLR1",123,0)
 . I $O(^TMP("TRAN",$J,"A"))'="" D
"RTN","ORWLR1",124,0)
 .. W !," Blood Product Key: "
"RTN","ORWLR1",125,0)
 . S GMI="A" F  S GMI=$O(^TMP("TRAN",$J,GMI)) Q:GMI=""  D
"RTN","ORWLR1",126,0)
 .. W ?22,GMI," = ",$G(^TMP("TRAN",$J,GMI)),!
"RTN","ORWLR1",127,0)
 Q
"RTN","ORWLR1",128,0)
TRRX ;Test call to TRRX^VBECA1 for Transfusion Reactions - DBIA 3181, 3187
"RTN","ORWLR1",129,0)
 N ARR,ID,ERROR,ORPARNT
"RTN","ORWLR1",130,0)
 I '$G(ORVP) D GETPAT(.ERROR)
"RTN","ORWLR1",131,0)
 I $G(ERROR) W !,"Error on Patient lookup" Q
"RTN","ORWLR1",132,0)
 D TRRX^VBECA1(PATID,PATNAM,PATDOB,.ORPARNT,.ORARR) I $O(ARR("TRRX",0)) D
"RTN","ORWLR1",133,0)
 . W !,"Transfusion reactions: " S ID=0 F  S ID=$O(ARR("TRRX",ID)) Q:'ID  W !?2,ARR("TRRX",ID)
"RTN","ORWLR1",134,0)
 Q
"RTN","ORWLR1",135,0)
PARSE ;Parse Record
"RTN","ORWLR1",136,0)
 N GMI,X
"RTN","ORWLR1",137,0)
 S TD=$$FMTE^XLFDT(+GMR)
"RTN","ORWLR1",138,0)
 S GMA(1)=$P(GMR,U,2),BPN=$L(GMA(1),";")
"RTN","ORWLR1",139,0)
 I $P(GMA(1),";",BPN)="" S BPN=BPN-1
"RTN","ORWLR1",140,0)
 F GMI=2:1:BPN S GMA(GMI)="("_$P($P(GMA(1),";",GMI),"\")_") "_$P($P(GMA(1),";",GMI),"\",2)
"RTN","ORWLR1",141,0)
 S GMA(1)="("_$P($P(GMA(1),";",1),"\")_") "_$P($P(GMA(1),";",1),"\",2)
"RTN","ORWLR1",142,0)
 Q
"RTN","ORWLR1",143,0)
WRT ; Writes the Transfusion Record for each day
"RTN","ORWLR1",144,0)
 N GML,GMI1,GMI2,GMM,GMJ
"RTN","ORWLR1",145,0)
 S GMM=$S(BPN#4:1,1:0),GML=BPN\4+GMM
"RTN","ORWLR1",146,0)
 W TD
"RTN","ORWLR1",147,0)
 F GMI1=1:1:GML D
"RTN","ORWLR1",148,0)
 . F GMI2=1:1:($S((GMI1=GML)&(BPN#4):BPN#4,1:4)) D
"RTN","ORWLR1",149,0)
 .. S GMJ=((GMI1-1)*4)+GMI2
"RTN","ORWLR1",150,0)
 .. W ?(((GMI2-1)*15)+13),GMA(GMJ)
"RTN","ORWLR1",151,0)
 .. I $S(GMI2#4=0:1,GMI2=BPN:1,GMI2+(4*(GMI1-1))=BPN:1,1:0) W !
"RTN","ORWLR1",152,0)
 Q
"VER")
8.0^22.0
"BLD",9474,6)
^336
**END**
**END**

