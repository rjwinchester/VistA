Released OR*3*469 SEQ #395
Extracted from mail message
**KIDS**:OR*3.0*469^

**INSTALL NAME**
OR*3.0*469
"BLD",9891,0)
OR*3.0*469^ORDER ENTRY/RESULTS REPORTING^0^3180130^y
"BLD",9891,1,0)
^^1^1^3170919^
"BLD",9891,1,1,0)
MOCHA 2.1 follow-up
"BLD",9891,4,0)
^9.64PA^^
"BLD",9891,6.3)
4
"BLD",9891,"KRN",0)
^9.67PA^779.2^20
"BLD",9891,"KRN",.4,0)
.4
"BLD",9891,"KRN",.401,0)
.401
"BLD",9891,"KRN",.402,0)
.402
"BLD",9891,"KRN",.403,0)
.403
"BLD",9891,"KRN",.5,0)
.5
"BLD",9891,"KRN",.84,0)
.84
"BLD",9891,"KRN",3.6,0)
3.6
"BLD",9891,"KRN",3.8,0)
3.8
"BLD",9891,"KRN",9.2,0)
9.2
"BLD",9891,"KRN",9.8,0)
9.8
"BLD",9891,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",9891,"KRN",9.8,"NM",1,0)
ORKPS^^0^B104632974
"BLD",9891,"KRN",9.8,"NM",2,0)
ORKPS1^^0^B108794510
"BLD",9891,"KRN",9.8,"NM",3,0)
ORKCHK6^^0^B28136818
"BLD",9891,"KRN",9.8,"NM",4,0)
ORWDXC^^0^B77488724
"BLD",9891,"KRN",9.8,"NM","B","ORKCHK6",3)

"BLD",9891,"KRN",9.8,"NM","B","ORKPS",1)

"BLD",9891,"KRN",9.8,"NM","B","ORKPS1",2)

"BLD",9891,"KRN",9.8,"NM","B","ORWDXC",4)

"BLD",9891,"KRN",19,0)
19
"BLD",9891,"KRN",19.1,0)
19.1
"BLD",9891,"KRN",101,0)
101
"BLD",9891,"KRN",409.61,0)
409.61
"BLD",9891,"KRN",771,0)
771
"BLD",9891,"KRN",779.2,0)
779.2
"BLD",9891,"KRN",870,0)
870
"BLD",9891,"KRN",8989.51,0)
8989.51
"BLD",9891,"KRN",8989.52,0)
8989.52
"BLD",9891,"KRN",8994,0)
8994
"BLD",9891,"KRN","B",.4,.4)

"BLD",9891,"KRN","B",.401,.401)

"BLD",9891,"KRN","B",.402,.402)

"BLD",9891,"KRN","B",.403,.403)

"BLD",9891,"KRN","B",.5,.5)

"BLD",9891,"KRN","B",.84,.84)

"BLD",9891,"KRN","B",3.6,3.6)

"BLD",9891,"KRN","B",3.8,3.8)

"BLD",9891,"KRN","B",9.2,9.2)

"BLD",9891,"KRN","B",9.8,9.8)

"BLD",9891,"KRN","B",19,19)

"BLD",9891,"KRN","B",19.1,19.1)

"BLD",9891,"KRN","B",101,101)

"BLD",9891,"KRN","B",409.61,409.61)

"BLD",9891,"KRN","B",771,771)

"BLD",9891,"KRN","B",779.2,779.2)

"BLD",9891,"KRN","B",870,870)

"BLD",9891,"KRN","B",8989.51,8989.51)

"BLD",9891,"KRN","B",8989.52,8989.52)

"BLD",9891,"KRN","B",8994,8994)

"BLD",9891,"QUES",0)
^9.62^^
"BLD",9891,"REQB",0)
^9.611^3^3
"BLD",9891,"REQB",1,0)
OR*3.0*382^2
"BLD",9891,"REQB",2,0)
OR*3.0*269^2
"BLD",9891,"REQB",3,0)
OR*3.0*457^2
"BLD",9891,"REQB","B","OR*3.0*269",2)

"BLD",9891,"REQB","B","OR*3.0*382",1)

"BLD",9891,"REQB","B","OR*3.0*457",3)

"MBREQ")
0
"PKG",170,-1)
1^1
"PKG",170,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",170,22,0)
^9.49I^1^1
"PKG",170,22,1,0)
3.0^2971217^2980917^11712
"PKG",170,22,1,"PAH",1,0)
469^3180130
"PKG",170,22,1,"PAH",1,1,0)
^^1^1^3180130
"PKG",170,22,1,"PAH",1,1,1,0)
MOCHA 2.1 follow-up
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","ORKCHK6")
0^3^B28136818^B28204591
"RTN","ORKCHK6",1,0)
ORKCHK6 ; SLC/CLA - Support routine called by ORKCHK to do SESSION mode order checks ;12/14/17  09:01
"RTN","ORKCHK6",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,87,94,123,162,190,249,280,272,346,345,269,469**;Dec 17, 1997;Build 4
"RTN","ORKCHK6",3,0)
 Q
"RTN","ORKCHK6",4,0)
 ;
"RTN","ORKCHK6",5,0)
EN(ORKS,ORKDFN,ORKA,ORENT,ORKTMODE) ;perform order checking for entire ordering session
"RTN","ORKCHK6",6,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE",1,"I")="D"
"RTN","ORKCHK6",7,0)
 ;
"RTN","ORKCHK6",8,0)
 N OI,ORKDG,HL7,ODT,ORNUM,HL7NPTR,HL7NTXT,HL7NCOD,HL7LPTR,HL7LTXT,HL7LCOD
"RTN","ORKCHK6",9,0)
 N ORKMSG,ORKDGI,ORKTXT,ORKPDATA,ORIFN
"RTN","ORKCHK6",10,0)
 ;
"RTN","ORKCHK6",11,0)
 S OI=$P(ORKA,"|"),ORKDG=$P(ORKA,"|",2),HL7=$P(ORKA,"|",3)
"RTN","ORKCHK6",12,0)
 S ODT=$P(ORKA,"|",4),ORNUM=$P(ORKA,"|",5),ORKPDATA=$P(ORKA,"|",6)
"RTN","ORKCHK6",13,0)
 S HL7NPTR=$P(HL7,U),HL7NTXT=$P(HL7,U,2),HL7NCOD=$P(HL7,U,3)
"RTN","ORKCHK6",14,0)
 S HL7LPTR=$P(HL7,U,4),HL7LTXT=$P(HL7,U,5),HL7LCOD=$P(HL7,U,6)
"RTN","ORKCHK6",15,0)
 S ORIFN=ORNUM
"RTN","ORKCHK6",16,0)
 ;
"RTN","ORKCHK6",17,0)
 S:ORKDG="PSJ" ORKDG="PSI"
"RTN","ORKCHK6",18,0)
 I $E(ORKDG,1,2)="PS" D PHARM
"RTN","ORKCHK6",19,0)
 I $E(ORKDG,1,2)'="PS" D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",20,0)
 Q
"RTN","ORKCHK6",21,0)
 ;
"RTN","ORKCHK6",22,0)
PHARM ;process pharmacy order checks:
"RTN","ORKCHK6",23,0)
 N ORPSPKG,ORPSA,ORRXDONE
"RTN","ORKCHK6",24,0)
 N ORCRITN,ORCRITF,ORCRITD,ORSIGN,ORSIGF,ORSIGD,ORDUPN,ORDUPF,ORDUPD,ORDUPC,ORDUPCF,ORDUPCD,ORALLRN,ORALLRF,ORALLRD,ORDUPCN
"RTN","ORKCHK6",25,0)
 ;
"RTN","ORKCHK6",26,0)
 D PARAMS("ALLERGY-DRUG INTERACTION",.ORALLRN,.ORALLRF,.ORALLRD)
"RTN","ORKCHK6",27,0)
 D PARAMS("CRITICAL DRUG INTERACTION",.ORCRITN,.ORCRITF,.ORCRITD)
"RTN","ORKCHK6",28,0)
 D PARAMS("SIGNIFICANT DRUG INTERACTION",.ORSIGN,.ORSIGF,.ORSIGD)
"RTN","ORKCHK6",29,0)
 D PARAMS("DUPLICATE DRUG ORDER",.ORDUPN,.ORDUPF,.ORDUPD)
"RTN","ORKCHK6",30,0)
 D PARAMS("DUPLICATE DRUG THERAPY",.ORDUPCN,.ORDUPCF,.ORDUPCD)
"RTN","ORKCHK6",31,0)
 ;
"RTN","ORKCHK6",32,0)
 S ORRXDONE=0 ;flag to set if RXOCS gets called
"RTN","ORKCHK6",33,0)
 ;dispense drug selected:
"RTN","ORKCHK6",34,0)
 I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK6",35,0)
 .D RXOCS
"RTN","ORKCHK6",36,0)
 .S:$P(ORKA,"|",7)'="" $P(ORKA,"|",7)=""
"RTN","ORKCHK6",37,0)
 .S ORRXDONE=1
"RTN","ORKCHK6",38,0)
 .D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",39,0)
 ;
"RTN","ORKCHK6",40,0)
 ;dispense drug NOT selected, split OI into dispense drugs:
"RTN","ORKCHK6",41,0)
 I '$L($G(HL7LPTR)) D
"RTN","ORKCHK6",42,0)
 .S ORPSPKG=$E(ORKDG,3)
"RTN","ORKCHK6",43,0)
 .I "IOH"[ORPSPKG D
"RTN","ORKCHK6",44,0)
 ..S ORPSA=$$OI2DD^ORKPS(OI,ORPSPKG,1)
"RTN","ORKCHK6",45,0)
 ..I +ORPSA D
"RTN","ORKCHK6",46,0)
 ...S HL7LTXT=$P($G(^ORD(101.43,OI,0)),U)
"RTN","ORKCHK6",47,0)
 ...S HL7NPTR=$P(ORPSA,";",2)
"RTN","ORKCHK6",48,0)
 ...S HL7LPTR=+ORPSA
"RTN","ORKCHK6",49,0)
 ...S HL7LCOD="99PSD",HL7NCOD="99NDF"
"RTN","ORKCHK6",50,0)
 ...S $P(HL7,U)=HL7NPTR,$P(HL7,U,3)=HL7NCOD
"RTN","ORKCHK6",51,0)
 ...S $P(HL7,U,4)=HL7LPTR,$P(HL7,U,5)=HL7LTXT,$P(HL7,U,6)=HL7LCOD
"RTN","ORKCHK6",52,0)
 ...S $P(ORKA,"|",3)=HL7  ;set these for MLM OCX call
"RTN","ORKCHK6",53,0)
 ..D RXOCS
"RTN","ORKCHK6",54,0)
 ..S:$P(ORKA,"|",7)'="" $P(ORKA,"|",7)=""
"RTN","ORKCHK6",55,0)
 ..S ORRXDONE=1
"RTN","ORKCHK6",56,0)
 ..Q:HL7LTXT=""
"RTN","ORKCHK6",57,0)
 ..D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",58,0)
 I ORRXDONE=0 D
"RTN","ORKCHK6",59,0)
 .N ORKSMSG,OROITXT
"RTN","ORKCHK6",60,0)
 .S OROITXT=$P($G(^ORD(101.43,OI,0)),U)
"RTN","ORKCHK6",61,0)
 .I $L(OROITXT)>0 S OROITXT=" for "_$$TRIM^XLFSTR(OROITXT)
"RTN","ORKCHK6",62,0)
 .S ORKMSG="Enhanced order checks cannot be done"_OROITXT_". Please perform a manual check for Drug-Interactions, Duplicate Therapy"
"RTN","ORKCHK6",63,0)
 .I $$DS^PSSDSAPI S ORKMSG=ORKMSG_" and Dosing"
"RTN","ORKCHK6",64,0)
 .S ORKS("ORK",2_$E(ORKMSG,1,225))=ORNUM_U_25_U_3_U_ORKMSG
"RTN","ORKCHK6",65,0)
 Q
"RTN","ORKCHK6",66,0)
 ;
"RTN","ORKCHK6",67,0)
RXOCS ;drug-drug interaction, duplicate drug order, duplicate drug class
"RTN","ORKCHK6",68,0)
 Q:ORCRITF_ORSIGF_ORDUPF_ORDUPCF_ORALLRF'["E"  ;quit if none are "E"nabled
"RTN","ORKCHK6",69,0)
 N ORKRX,ORPSNUM,ORY,CHK,XX
"RTN","ORKCHK6",70,0)
 ;I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK6",71,0)
 I 1 D
"RTN","ORKCHK6",72,0)
 .D CHKSESS^ORKPS(.ORKRX,ORKDFN,HL7LPTR_U_HL7LTXT,OI,ORKPDATA,ORKDG,+$P($G(ORPSA),";",4),$P(ORKA,"|",7))
"RTN","ORKCHK6",73,0)
 .S CHK=0,XX="" F  S CHK=$O(ORKRX(CHK)) Q:'CHK  D
"RTN","ORKCHK6",74,0)
 ..S XX=ORKRX(CHK)
"RTN","ORKCHK6",75,0)
 ..;
"RTN","ORKCHK6",76,0)
 ..;get errors/exceptions/checks not done
"RTN","ORKCHK6",77,0)
 ..I $P(XX,U)="ERR" S ORKS("ORK",2_$E($P(XX,U,2),1,225)_","_$G(ORNUM))=ORNUM_U_25_U_3_U_$P(XX,U,2)
"RTN","ORKCHK6",78,0)
 ..;
"RTN","ORKCHK6",79,0)
 ..;critical drug interaction:
"RTN","ORKCHK6",80,0)
 ..I $P(XX,U)="DI",$P(XX,U,2)="CRITICAL" D
"RTN","ORKCHK6",81,0)
 ...Q:ORCRITF="D"
"RTN","ORKCHK6",82,0)
 ...S ORPSNUM=$P(XX,U,3)
"RTN","ORKCHK6",83,0)
 ...S ORKTXT=$P(XX,U,2)_" drug-drug interaction: "_$P(XX,U,5)
"RTN","ORKCHK6",84,0)
 ...S ORKS("ORK",ORCRITD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKTXT,1,225))=ORNUM_U_ORCRITN_U_ORCRITD_U_ORKTXT
"RTN","ORKCHK6",85,0)
 ..;
"RTN","ORKCHK6",86,0)
 ..;significant drug interaction:
"RTN","ORKCHK6",87,0)
 ..I $P(XX,U)="DI",$P(XX,U,2)="SIGNIFICANT" D
"RTN","ORKCHK6",88,0)
 ...Q:ORSIGF="D"
"RTN","ORKCHK6",89,0)
 ...S ORPSNUM=$P(XX,U,3)
"RTN","ORKCHK6",90,0)
 ...S ORKTXT=$P(XX,U,2)_" drug-drug interaction: "_$P(XX,U,5)
"RTN","ORKCHK6",91,0)
 ...S ORKS("ORK",ORSIGD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKTXT,1,225))=ORNUM_U_ORSIGN_U_ORSIGD_U_ORKTXT
"RTN","ORKCHK6",92,0)
 ..;
"RTN","ORKCHK6",93,0)
 ..;duplicate drug:
"RTN","ORKCHK6",94,0)
 ..I $P(XX,U)="DD" D
"RTN","ORKCHK6",95,0)
 ...Q:ORDUPF="D"
"RTN","ORKCHK6",96,0)
 ...S ORPSNUM=$P(XX,U,4)  ;get the associated order number
"RTN","ORKCHK6",97,0)
 ...S ORKTXT=$P(XX,U,3)
"RTN","ORKCHK6",98,0)
 ...I $L(ORPSNUM),$G(^OR(100,+ORPSNUM,0)) D
"RTN","ORKCHK6",99,0)
 ....D TEXT^ORQ12(.ORY,ORPSNUM,"")
"RTN","ORKCHK6",100,0)
 ....S ORKTXT=ORKTXT_$S($D(ORY(2))=1:" "_$$TRIM^XLFSTR(ORY(2)),1:"")_" ["_$P($G(^ORD(100.01,+$P(^OR(100,+ORPSNUM,3),U,3),0)),U,1)_"]"
"RTN","ORKCHK6",101,0)
 ...S ORKMSG="Duplicate drug order: "_ORKTXT
"RTN","ORKCHK6",102,0)
 ...S ORKS("ORK",ORDUPD_","_$G(ORNUM)_","_ORPSNUM_",Duplicate drug order: "_$E($P(XX,U,3),1,200))=ORNUM_U_ORDUPN_U_ORDUPD_U_ORKMSG_U_$G(ORPSNUM)
"RTN","ORKCHK6",103,0)
 ..;
"RTN","ORKCHK6",104,0)
 ..;duplicate class: NOW DRUG THERAPY
"RTN","ORKCHK6",105,0)
 ..I $P(XX,U)="DC" D
"RTN","ORKCHK6",106,0)
 ...Q:ORDUPCF="D"
"RTN","ORKCHK6",107,0)
 ...S ORPSNUM=$P(XX,U,2)  ;get the associated order number
"RTN","ORKCHK6",108,0)
 ...S ORKMSG=$P(XX,U,4)
"RTN","ORKCHK6",109,0)
 ...S ORKS("ORK",ORDUPCD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKMSG,1,225))=ORNUM_U_ORDUPCN_U_ORDUPCD_U_ORKMSG
"RTN","ORKCHK6",110,0)
 D RXOCS^ORKCHK5
"RTN","ORKCHK6",111,0)
 Q
"RTN","ORKCHK6",112,0)
 ;
"RTN","ORKCHK6",113,0)
PARAMS(ORKNAME,ORKNUM,ORKFLAG,ORKDNGR) ; get parameter values for an order chk
"RTN","ORKCHK6",114,0)
 S ORKNUM=0,ORKNUM=$O(^ORD(100.8,"B",ORKNAME,ORKNUM))
"RTN","ORKCHK6",115,0)
 S ORKFLAG=$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",ORKNUM,"I")
"RTN","ORKCHK6",116,0)
 S ORKDNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",ORKNUM,"I")
"RTN","ORKCHK6",117,0)
 Q
"RTN","ORKPS")
0^1^B104632974^B115111476
"RTN","ORKPS",1,0)
ORKPS ; slc/CLA - Order checking support procedures for medications ;12/29/17  11:58
"RTN","ORKPS",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,94,123,141,190,232,316,272,346,345,382,469**;Dec 17, 1997;Build 4
"RTN","ORKPS",3,0)
 Q
"RTN","ORKPS",4,0)
CHECK(YY,DFN,MED,OI,ORKDG,OROIL,ORSUPPLY,ORIVTYPE,ORIVRAN,ORDODSG) ; return drug order checks
"RTN","ORKPS",5,0)
 ;YY:    returned array of data
"RTN","ORKPS",6,0)
 ;DFN:   patient id
"RTN","ORKPS",7,0)
 ;MED:   drug ien [file #50] ^ generic name [file #50]
"RTN","ORKPS",8,0)
 ;OI:    orderable item ien [file #101.43]
"RTN","ORKPS",9,0)
 ;ORKDG: display group (should be PSI, PSIV, PSO or PSH)
"RTN","ORKPS",10,0)
 ;OROIL: list of items ordered
"RTN","ORKPS",11,0)
 ;ORSUPPLY: pharmacy orderable item ien [file #50.7] if it resolves to one or more supply items
"RTN","ORKPS",12,0)
 ;          0 if the pharmacy orderable item does not resolve to any supply items
"RTN","ORKPS",13,0)
 ;ORIVTYPE: the MED type as sent from Infusion Order Dialog
"RTN","ORKPS",14,0)
 ;          A for additive
"RTN","ORKPS",15,0)
 ;          B for base
"RTN","ORKPS",16,0)
 ;ORIVRAN: FLAG THAT DENOTES IF ALL COMPONENTS OF INFUSION ORDER HAVE ALREADY BEEN PROCESSED
"RTN","ORKPS",17,0)
 ;         1 FOR ALREADY PROCESSED
"RTN","ORKPS",18,0)
 ;         EMPTY STRING FOR NOT YET PROCESSED
"RTN","ORKPS",19,0)
 ;ORDODSG: FLAG THAT DENOTES IF DOSAGE CHECKS SHOULD BE PERFORMED
"RTN","ORKPS",20,0)
 ;         1 FOR PERFORM DOSAGE CHECKS
"RTN","ORKPS",21,0)
 ;         0 FOR DO NOT PERFORM DOSAGE CHECKS
"RTN","ORKPS",22,0)
 ; returned info: varies for ^TMP($J x-ref - refer to listings below
"RTN","ORKPS",23,0)
 N OR2CRITN,OR2CRITF,OR2CRITD,OR2SIGN,OR2SIGF,OR2SIGD,OR2DUPN,OR2DUPF,OR2DUPD,OR2DUPCN,OR2DUPCF,OR2DUPCD
"RTN","ORKPS",24,0)
 N ORPHDG,ORKSOIA,ORDOCHKS
"RTN","ORKPS",25,0)
 D PARAMS^ORKCHK6("CRITICAL DRUG INTERACTION",.OR2CRITN,.OR2CRITF,.OR2CRITD)
"RTN","ORKPS",26,0)
 D PARAMS^ORKCHK6("SIGNIFICANT DRUG INTERACTION",.OR2SIGN,.OR2SIGF,.OR2SIGD)
"RTN","ORKPS",27,0)
 D PARAMS^ORKCHK6("DUPLICATE DRUG THERAPY",.OR2DUPCN,.OR2DUPCF,.OR2DUPCD)
"RTN","ORKPS",28,0)
 N ORDFN,ORKA,ORPTY,ORPHOI,OROILI,ORKAI S ORDFN=DFN
"RTN","ORKPS",29,0)
 S ORPHOI=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORKPS",30,0)
 S ORPTY=$S($G(ORKDG)="PSI":"I;",$G(ORKDG)="PSIV":"I;",$G(ORKDG)="PSO":"O;",$G(ORKDG)="PSH":"O;",1:"O;")
"RTN","ORKPS",31,0)
 S ORPHDG=$S(ORKDG="PSI":"U",ORKDG="PSIV":"I",ORKDG="PSO":"O",ORKDG="PSH":"N",1:"")
"RTN","ORKPS",32,0)
 I $G(ORIVTYPE)'="A" D  Q:'ORDOCHKS  ; Don't do checks if pharmacy does not want us to
"RTN","ORKPS",33,0)
 .S ORDOCHKS=$$PRE^PSSDSAPK(ORPHOI,ORPHDG)
"RTN","ORKPS",34,0)
 .S:'ORDODSG ORDODSG=ORDOCHKS
"RTN","ORKPS",35,0)
 S:$G(ORIVTYPE)="A" ORDODSG=1
"RTN","ORKPS",36,0)
 I +MED,('ORIVRAN) S ORKA(1)=MED_U_$$GETPSNM(+MED),ORKAI=1
"RTN","ORKPS",37,0)
 ;ADD ALL COMPONENTS OF IV ORDER SO WE ONLY HAVE TO DO A SINGLE PRE CALL
"RTN","ORKPS",38,0)
 I ORKDG="PSIV",('ORIVRAN) D
"RTN","ORKPS",39,0)
 .S ORIVRAN=1,OROILI=0 F  S OROILI=$O(OROIL(OROILI)) Q:'OROILI  D
"RTN","ORKPS",40,0)
 ..N OR2OI,OR2PSOI,OR2PHDG
"RTN","ORKPS",41,0)
 ..I 'OROIL(OROILI) Q
"RTN","ORKPS",42,0)
 ..I +OROIL(OROILI)=OI Q
"RTN","ORKPS",43,0)
 ..S OR2OI=+OROIL(OROILI)
"RTN","ORKPS",44,0)
 ..S OR2PSOI=+$P($G(^ORD(101.43,+OR2OI,0)),U,2)
"RTN","ORKPS",45,0)
 ..S OR2PHDG=$P(OROIL(OROILI),U,2)
"RTN","ORKPS",46,0)
 ..S OR2PHDG=$S(OR2PHDG="PSI":"U",OR2PHDG="PSIV":"I",OR2PHDG="PSO":"O",OR2PHDG="PSH":"N",1:"")
"RTN","ORKPS",47,0)
 ..Q:OR2PHDG'="I"
"RTN","ORKPS",48,0)
 ..I $P($P(OROIL(OROILI),U,3),";")="B",$$PRE^PSSDSAPK(OR2PSOI,OR2PHDG)=0 Q
"RTN","ORKPS",49,0)
 ..I $P($P(OROIL(OROILI),U,3),";")="B",$P($P(OROIL(OROILI),U,3),";",2)="",$G(ORREN)=1 D
"RTN","ORKPS",50,0)
 ...N ORVOLID,ORVOLVAL S ORVOLVAL="",ORVOLID=$O(^OR(100,+$G(ORIFN),4.5,"ID","VOLUME",""))
"RTN","ORKPS",51,0)
 ...I ORVOLID>0 S ORVOLVAL=$G(^OR(100,+$G(ORIFN),4.5,ORVOLID,1))
"RTN","ORKPS",52,0)
 ...S OROIL(OROILI)=OROIL(OROILI)_ORVOLVAL
"RTN","ORKPS",53,0)
 ..N ORUSID
"RTN","ORKPS",54,0)
 ..S ORUSID=$$USID^ORWDXC(OROIL(OROILI))
"RTN","ORKPS",55,0)
 ..S ORKAI=ORKAI+1,ORKA(ORKAI)=$P(ORUSID,U,4)_U_$$GETPSNM($P(ORUSID,U,4))
"RTN","ORKPS",56,0)
 D:$D(ORKA) CPRS^PSODDPR4(ORDFN,"OROCOUT"_ORPTY,.ORKA,ORPTY_+$G(^OR(100,+$G(ORIFN),4)))
"RTN","ORKPS",57,0)
 I +ORSUPPLY D
"RTN","ORKPS",58,0)
 .S ORKSOIA(+ORSUPPLY)=$G(ORIFN)
"RTN","ORKPS",59,0)
 .D CPRS^PSODDPR8(ORDFN,"OROCOUT"_ORPTY,.ORKSOIA,ORPHDG_";"_+$G(^OR(100,+$G(ORNUM),4)),$S($D(ORKA):1,1:""))
"RTN","ORKPS",60,0)
 I $D(ORKA)!($D(ORKSOIA))!(ORIVRAN) D
"RTN","ORKPS",61,0)
 .S:OR2CRITF_OR2SIGF_OR2DUPCF["E" ^TMP($J,"ORENHCHK")=1
"RTN","ORKPS",62,0)
 .D PROCESS^ORKPS1(OI,ORDFN,ORKDG,+ORSUPPLY_U_+MED,"OROCOUT"_ORPTY)
"RTN","ORKPS",63,0)
 Q
"RTN","ORKPS",64,0)
CHKSESS(YY,DFN,MED,OI,ORKPDATA,ORKDG,ORSUPPLY,ORIVTYPE) ; return drug order checks for session
"RTN","ORKPS",65,0)
 ;ORSUPPLY: pharmacy orderable item ien [file #50.7] if it resolves to one or more supply items
"RTN","ORKPS",66,0)
 ;          0 if the pharmacy orderable item does not resolve to any supply items
"RTN","ORKPS",67,0)
 ;ORIVTYPE: the MED type as sent from Infusion Order Dialog
"RTN","ORKPS",68,0)
 ;          A for additive
"RTN","ORKPS",69,0)
 ;          B for base
"RTN","ORKPS",70,0)
 N ORKDGI,ORKDRUG,ORKDRUGA,ORKORN,HOR,SEQ,CNT,CNTX,ORKOI,ORPHOI
"RTN","ORKPS",71,0)
 N ORKFLG,ORSESS,ORPSPKG,ORPSA,ORSNUM,ORNUM,DUPX,DUPORN,ORPTY
"RTN","ORKPS",72,0)
 N ORKSOIA,ORRET,ORDFN,ORPHDG S ORDFN=DFN
"RTN","ORKPS",73,0)
 S ORPTY=$S($G(ORKDG)="PSI":"I;",$G(ORKDG)="PSIV":"I;",$G(ORKDG)="PSO":"O;",$G(ORKDG)="PSH":"O;",1:"O;")
"RTN","ORKPS",74,0)
 S ORPHDG=$S(ORKDG="PSI":"U",ORKDG="PSIV":"I",ORKDG="PSO":"O",ORKDG="PSH":"N",1:"")
"RTN","ORKPS",75,0)
 I '$D(^TMP($J,"OROCOUT"_ORPTY)) D
"RTN","ORKPS",76,0)
 .S ORKFLG=0
"RTN","ORKPS",77,0)
 .S ORNUM=$P(ORKA,"|",5)
"RTN","ORKPS",78,0)
 .S ORPHOI=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORKPS",79,0)
 .I $G(ORIVTYPE)'="A",'$$PRE^PSSDSAPK(ORPHOI,ORPHDG) Q  ; Don't do checks if pharmacy does not want us to
"RTN","ORKPS",80,0)
 .;get unsigned medication orders:
"RTN","ORKPS",81,0)
 .S HOR=0,SEQ=0
"RTN","ORKPS",82,0)
 .S HOR=$O(^TMP("ORR",$J,HOR))
"RTN","ORKPS",83,0)
 .I +$G(HOR)>0 D
"RTN","ORKPS",84,0)
 ..F  S SEQ=$O(^TMP("ORR",$J,HOR,SEQ)) Q:+SEQ<1  D
"RTN","ORKPS",85,0)
 ...S ORKORN=+$P(^TMP("ORR",$J,HOR,SEQ),U),DUPORN=0
"RTN","ORKPS",86,0)
 ...Q:+$G(ORKORN)<1
"RTN","ORKPS",87,0)
 ...Q:+ORKORN=+ORNUM
"RTN","ORKPS",88,0)
 ...Q:$P(^OR(100,+ORKORN,8,$P(^OR(100,+ORKORN,8,0),U,3),0),U,2)="DC"
"RTN","ORKPS",89,0)
 ...Q:$P(^ORD(100.01,$P(^OR(100,+ORKORN,3),U,3),0),U)="DISCONTINUED"
"RTN","ORKPS",90,0)
 ...S ORKDRUG=$$VALUE^ORCSAVE2(+ORKORN,"DRUG") ;get disp drug for order
"RTN","ORKPS",91,0)
 ...S ORPSPKG=$$DGRX^ORQOR2(+ORKORN)
"RTN","ORKPS",92,0)
 ...S:ORPSPKG="CLINIC INFUSIONS" ORPSPKG="IV MEDICATIONS" ; OR*3*430
"RTN","ORKPS",93,0)
 ...S ORPSPKG=$S(ORPSPKG="UNIT DOSE MEDICATIONS":"PSI",ORPSPKG="OUTPATIENT MEDICATIONS":"PSO",ORPSPKG="IV MEDICATIONS":"PSIV",ORPSPKG="NON-VA MEDICATIONS":"PSH",1:"")
"RTN","ORKPS",94,0)
 ...S DUPX="" F  S DUPX=$O(ORKDRUGA(DUPX)) Q:'DUPX!(DUPORN=1)  D
"RTN","ORKPS",95,0)
 ....S:ORKORN=ORKDRUGA(DUPX) DUPORN=1
"RTN","ORKPS",96,0)
 ...Q:DUPORN=1  ;quit if already processed drug order
"RTN","ORKPS",97,0)
 ...I +$G(ORKDRUG)<1,$L(ORPSPKG)>0 D
"RTN","ORKPS",98,0)
 ....N OROI S OROI=$$OI^ORX8(+ORKORN)
"RTN","ORKPS",99,0)
 ....S ORRET=$$OI2DD(+OROI,$S($G(ORKDG)="PSI":"I",$G(ORKDG)="PSIV":"I",$G(ORKDG)="PSO":"O",$G(ORKDG)="PSH":"O",1:"O"),1)
"RTN","ORKPS",100,0)
 ....I +$P(ORRET,";",4) S ORKSOIA(+$P(ORRET,";",4))=ORKORN
"RTN","ORKPS",101,0)
 ....I +ORRET S ORKDRUG=+ORRET
"RTN","ORKPS",102,0)
 ...;only process vs. unsigned med order if disp drug is assoc w/order:
"RTN","ORKPS",103,0)
 ...Q:+$G(ORKDRUG)<1
"RTN","ORKPS",104,0)
 ...I ORPSPKG="PSIV" D
"RTN","ORKPS",105,0)
 ....;loop through each OI in the IV order
"RTN","ORKPS",106,0)
 ....N OR2I
"RTN","ORKPS",107,0)
 ....S OR2I=0 F  S OR2I=$O(^OR(100,+ORKORN,4.5,"ID","ORDERABLE",OR2I)) Q:'OR2I  D
"RTN","ORKPS",108,0)
 .....N OR2OI,OR2DRUG
"RTN","ORKPS",109,0)
 .....S OR2OI=$G(^OR(100,+ORKORN,4.5,OR2I,1))
"RTN","ORKPS",110,0)
 .....Q:'OR2OI
"RTN","ORKPS",111,0)
 .....;get the drug for each OI
"RTN","ORKPS",112,0)
 .....S OR2DRUG=$$OI2DD(+OR2OI,"I",1)
"RTN","ORKPS",113,0)
 .....;check if drug should be add it and add it if so
"RTN","ORKPS",114,0)
 .....I $$IVADD(OR2DRUG,OR2OI) S ORKDRUGA(+OR2DRUG_";"_ORPSPKG_";"_ORKORN)=ORKORN_U_$$GETPSNM(+OR2DRUG)
"RTN","ORKPS",115,0)
 ...I ORPSPKG'="PSIV" S ORKDRUGA(+ORKDRUG_";"_ORPSPKG_";"_ORKORN)=ORKORN_U_$$GETPSNM(+ORKDRUG)
"RTN","ORKPS",116,0)
 ...; OR*3*469 - Load all components (solution and additive) of IV for order checking
"RTN","ORKPS",117,0)
 ... I ORPSPKG="PSIV" D
"RTN","ORKPS",118,0)
 .... N ORX,ORRET S ORX=0 F  S ORX=+$O(^OR(100,ORKORN,4.5,"ID","ORDERABLE",ORX)) Q:'ORX   D
"RTN","ORKPS",119,0)
 ..... S ORRET=$$OI2DD(+$G(^OR(100,ORKORN,4.5,ORX,1)),"I",1) Q:'ORRET
"RTN","ORKPS",120,0)
 ..... I +$P(ORRET,";",4) S ORKSOIA(+$P(ORRET,";",4))=ORKORN
"RTN","ORKPS",121,0)
 ..... I '$D(ORKDRUGA(+ORRET_";PSIV;"_ORKORN)) S ORKDRUGA(+ORRET_";PSIV;"_ORKORN)=ORKORN_U_$$GETPSNM(+ORRET)
"RTN","ORKPS",122,0)
 .... Q  ; end of OR*3*469 change
"RTN","ORKPS",123,0)
 .N ORPROSP,CNT
"RTN","ORKPS",124,0)
 .S CNT=1
"RTN","ORKPS",125,0)
 .S:+MED ORPROSP(CNT)=MED_U_$$GETPSNM(+MED)_U_+$G(ORNUM),CNT=CNT+1
"RTN","ORKPS",126,0)
 .N I S I="" F  S I=$O(ORKDRUGA(I)) Q:'I  S ORPROSP(CNT)=+I_U_$P(ORKDRUGA(I),U,2)_U_U_$P(ORKDRUGA(I),U,1),CNT=CNT+1
"RTN","ORKPS",127,0)
 .D SHRNKPR
"RTN","ORKPS",128,0)
 .D CPRS^PSODDPR4(DFN,"OROCOUT"_ORPTY,.ORPROSP,ORPTY_+$G(^OR(100,+$G(ORNUM),4)))
"RTN","ORKPS",129,0)
 .I +ORSUPPLY D
"RTN","ORKPS",130,0)
 ..S ORKSOIA(+ORSUPPLY)=$G(ORNUM)
"RTN","ORKPS",131,0)
 ..D:$D(ORKSOIA)>9 CPRS^PSODDPR8(DFN,"OROCOUT"_ORPTY,.ORKSOIA,ORPHDG_";"_+$G(^OR(100,+$G(ORNUM),4)),1)
"RTN","ORKPS",132,0)
 D PROCESS^ORKPS1(OI,ORDFN,ORKDG,+ORSUPPLY_U_+MED,"OROCOUT"_ORPTY)
"RTN","ORKPS",133,0)
 Q
"RTN","ORKPS",134,0)
IVADD(ORDRUG,OROI) ;RETURN YES OR NO IF SHOULD ADD THE IV ITEM
"RTN","ORKPS",135,0)
 N ORRET
"RTN","ORKPS",136,0)
 ;default is yes to add it, will always be 1 for an additive
"RTN","ORKPS",137,0)
 S ORRET=1
"RTN","ORKPS",138,0)
 ;check if drug is a base
"RTN","ORKPS",139,0)
 K ^TMP($J,"ORBASECHECK")
"RTN","ORKPS",140,0)
 D DRGIEN^PSS52P7(ORDRUG,,"ORBASECHECK")
"RTN","ORKPS",141,0)
 I $P($G(^TMP($J,"ORBASECHECK",0),0),U)>0 D  ;GOT A BASE HERE
"RTN","ORKPS",142,0)
 .;if drug is a base, check if pharmacy says we can add it or not
"RTN","ORKPS",143,0)
 .N ORPHOI
"RTN","ORKPS",144,0)
 .S ORPHOI=+$P($G(^ORD(101.43,+OROI,0)),U,2)
"RTN","ORKPS",145,0)
 .S ORRET=$$PRE^PSSDSAPK(ORPHOI,"I")
"RTN","ORKPS",146,0)
 K ^TMP($J,"ORBASECHECK")
"RTN","ORKPS",147,0)
 Q ORRET
"RTN","ORKPS",148,0)
SHRNKPR ;REMOVE DUPLICATS FROM PROSPECTIVE LIST
"RTN","ORKPS",149,0)
 Q:'$D(ORPROSP)
"RTN","ORKPS",150,0)
 N ORX,ORI S ORI=0 F  S ORI=$O(ORPROSP(ORI)) Q:'ORI  S ORX=ORPROSP(ORI) D
"RTN","ORKPS",151,0)
 .N ORJ S ORJ=ORI F  S ORJ=$O(ORPROSP(ORJ)) Q:'ORJ  I ORX=ORPROSP(ORJ) K ORPROSP(ORJ)
"RTN","ORKPS",152,0)
 Q
"RTN","ORKPS",153,0)
GETPSNM(ORIEN) ;GET THE FILE 50 .01 FIELD FROM A FILE 50 IEN
"RTN","ORKPS",154,0)
 N RET K ^TMP($J,"ORRETNM")
"RTN","ORKPS",155,0)
 D NDF^PSS50(ORIEN,,,,,"ORRETNM") S RET=$G(^TMP($J,"ORRETNM",ORIEN,.01))
"RTN","ORKPS",156,0)
 K ^TMP($J,"ORRETNM")
"RTN","ORKPS",157,0)
 Q RET
"RTN","ORKPS",158,0)
TAKEMED(ORKDFN,ORKMED) ;extrinsic function returns med orderable item if any
"RTN","ORKPS",159,0)
 ;active med patient is taking contains any piece of ORKMED
"RTN","ORKPS",160,0)
 ;ORKDFN   patient DFN
"RTN","ORKPS",161,0)
 ;ORKMED   meds to check vs. active med list in format MED1^MED2^MED3...
"RTN","ORKPS",162,0)
 Q:'$L($G(ORKDFN)) "0^Patient not identified."
"RTN","ORKPS",163,0)
 Q:'$L($G(ORKMED)) "0^Medication not identified."
"RTN","ORKPS",164,0)
 N ORKARX,ORKY,ORI,ORJ,ORCNT,ORKMEDP,ORKRSLT
"RTN","ORKPS",165,0)
 D LIST^ORQQPS(.ORKY,ORKDFN,"","")
"RTN","ORKPS",166,0)
 Q:$P(ORKY(1),U)="" "0^No active meds found."
"RTN","ORKPS",167,0)
 S ORKRSLT="0^No matching meds found."
"RTN","ORKPS",168,0)
 S ORCNT=$L(ORKMED,U)
"RTN","ORKPS",169,0)
 S ORI=0 F  S ORI=$O(ORKY(ORI)) Q:ORI<1  D
"RTN","ORKPS",170,0)
 .S ORKARX=$P(ORKY(ORI),U,2)
"RTN","ORKPS",171,0)
 .F ORJ=1:1:ORCNT S ORKMEDP=$P(ORKMED,U,ORJ) D
"RTN","ORKPS",172,0)
 ..I $L(ORKMEDP),($$UP^XLFSTR(ORKARX)[ORKMEDP) S ORKRSLT="1^"_ORKARX ;DJE/VM *316 use uppercase in comparison
"RTN","ORKPS",173,0)
 Q ORKRSLT
"RTN","ORKPS",174,0)
POLYRX(DFN) ;extrins funct rtns 1 if patient exceeds polypharmacy, 0 if not
"RTN","ORKPS",175,0)
 N ORSLT,ORENT,ORLOC,ORPAR,ORMEDS
"RTN","ORKPS",176,0)
 S ORSLT=0
"RTN","ORKPS",177,0)
 Q:'$L(DFN) ORSLT
"RTN","ORKPS",178,0)
 S VA200="" D OERR^VADPT
"RTN","ORKPS",179,0)
 S ORLOC=+$G(^DIC(42,+VAIN(4),44))
"RTN","ORKPS",180,0)
 K VA200,VAIN
"RTN","ORKPS",181,0)
 S ORENT=+$G(ORLOC)_";SC(^DIV^SYS^PKG"
"RTN","ORKPS",182,0)
 S ORPAR=$$GET^XPAR(ORENT,"ORK POLYPHARMACY",1,"I")
"RTN","ORKPS",183,0)
 S ORMEDS=$$NUMRX(DFN)
"RTN","ORKPS",184,0)
 I $G(ORMEDS)>$G(ORPAR) S ORSLT=1
"RTN","ORKPS",185,0)
 Q ORSLT
"RTN","ORKPS",186,0)
GLCREAT(DFN) ;extrinsic function returns patient's (DFN) most recent serum
"RTN","ORKPS",187,0)
 ; creatinine within # of days from parameter ORK GLUCOPHAGE CREATININE
"RTN","ORKPS",188,0)
 ; results format: test id^result units flag ref range collect d/t^result
"RTN","ORKPS",189,0)
 ; used by order check GLUCOPHAGE-LAB RESULTS
"RTN","ORKPS",190,0)
 N ORLOC,ORPAR,ORDAYS
"RTN","ORKPS",191,0)
 N BDT,CDT,ORY,ORX,ORZ,TEST,ORI,ORJ,CREARSLT,LABFILE,SPECFILE,SPECIMEN,VAIN,VADM,RSLTS
"RTN","ORKPS",192,0)
 Q:'$L(DFN) "0^"
"RTN","ORKPS",193,0)
 S ORDAYS=$$GCDAYS(DFN)
"RTN","ORKPS",194,0)
 Q:'$L(ORDAYS) "0^"
"RTN","ORKPS",195,0)
 D NOW^%DTC
"RTN","ORKPS",196,0)
 S BDT=$$FMADD^XLFDT(%,"-"_ORDAYS,"","","")
"RTN","ORKPS",197,0)
 K %
"RTN","ORKPS",198,0)
 Q:'$L($G(BDT)) "0^"
"RTN","ORKPS",199,0)
 S LABFILE=$$TERMLKUP^ORB31(.ORY,"SERUM CREATININE")
"RTN","ORKPS",200,0)
 Q:'$D(ORY) "0^" ;no link between SERUM CREATININE and local lab test
"RTN","ORKPS",201,0)
 Q:$G(LABFILE)'=60 "0^"
"RTN","ORKPS",202,0)
 S SPECFILE=$$TERMLKUP^ORB31(.ORX,"SERUM SPECIMEN")
"RTN","ORKPS",203,0)
 Q:'$D(ORX) "0^" ;no link between SERUM SPECIMEN and local specimen
"RTN","ORKPS",204,0)
 Q:$G(SPECFILE)'=61 "0^"
"RTN","ORKPS",205,0)
 F ORI=1:1:ORY D
"RTN","ORKPS",206,0)
 .S TEST=$P(ORY(ORI),U)
"RTN","ORKPS",207,0)
 .Q:+$G(TEST)<1
"RTN","ORKPS",208,0)
 .F ORJ=1:1:ORX D
"RTN","ORKPS",209,0)
 ..S SPECIMEN=$P(ORX(ORJ),U)
"RTN","ORKPS",210,0)
 ..Q:+$G(SPECIMEN)<1
"RTN","ORKPS",211,0)
 ..S ORZ=$$LOCL^ORQQLR1(DFN,TEST,SPECIMEN)
"RTN","ORKPS",212,0)
 ..Q:'$L($G(ORZ))
"RTN","ORKPS",213,0)
 ..S CDT=$P(ORZ,U,7)
"RTN","ORKPS",214,0)
 ..I CDT'<BDT S RSLTS(CDT)=ORZ,CREARSLT=1  ;*SMT Use RSLTS as array.
"RTN","ORKPS",215,0)
 Q:+$G(CREARSLT)<1 "0^"
"RTN","ORKPS",216,0)
 S CDT=$O(RSLTS(0)),ORZ=RSLTS(CDT)  ;*SMT
"RTN","ORKPS",217,0)
 Q $P(ORZ,U)_U_$P(ORZ,U,3)_" "_$P(ORZ,U,4)_" "_$P(ORZ,U,5)_" ("_$P(ORZ,U,6)_")  "_$$FMTE^XLFDT(CDT,"2P")_U_$P(ORZ,U,3)
"RTN","ORKPS",218,0)
GCDAYS(DFN) ;extrinsic function to return number of days to look for
"RTN","ORKPS",219,0)
 ; glucophage serum creatinine result
"RTN","ORKPS",220,0)
 Q:'$L(DFN) ""
"RTN","ORKPS",221,0)
 N ORLOC,ORENT,ORDAYS
"RTN","ORKPS",222,0)
 ;get patient's location flag (INPATIENT ONLY - outpt locations cannot be
"RTN","ORKPS",223,0)
 ;reliably determined, and many simultaneous outpt locations can occur):
"RTN","ORKPS",224,0)
 S VA200="" D OERR^VADPT
"RTN","ORKPS",225,0)
 S ORLOC=+$G(^DIC(42,+VAIN(4),44))
"RTN","ORKPS",226,0)
 K VA200,VAIN
"RTN","ORKPS",227,0)
 S ORENT=+$G(ORLOC)_";SC(^DIV^SYS^PKG"
"RTN","ORKPS",228,0)
 S ORDAYS=$$GET^XPAR(ORENT,"ORK GLUCOPHAGE CREATININE",1,"I")
"RTN","ORKPS",229,0)
 Q:$L(ORDAYS) ORDAYS
"RTN","ORKPS",230,0)
 Q ""
"RTN","ORKPS",231,0)
SUPPLY(OI) ;extrinsic function returns 1 (true) if the orderable item is
"RTN","ORKPS",232,0)
 ; a supply
"RTN","ORKPS",233,0)
 Q:+$G(OI)<1 ""
"RTN","ORKPS",234,0)
 N OITEXT
"RTN","ORKPS",235,0)
 S OITEXT=$G(^ORD(101.43,OI,0))
"RTN","ORKPS",236,0)
 Q:'$L(OITEXT) ""
"RTN","ORKPS",237,0)
 S OITEXT=$P(OITEXT,U)
"RTN","ORKPS",238,0)
 Q:$D(^ORD(101.43,"S.SPLY",OITEXT)) 1
"RTN","ORKPS",239,0)
 Q ""
"RTN","ORKPS",240,0)
NUMRX(DFN) ;extrinsic funct returns number of active meds patient is taking
"RTN","ORKPS",241,0)
 N NUMRX,ORPTYPE,ORX,ORY,ORS,ORNUM,ORPRENEW,VADMVT
"RTN","ORKPS",242,0)
 S NUMRX=0
"RTN","ORKPS",243,0)
 Q:+$G(DFN)<1 NUMRX
"RTN","ORKPS",244,0)
 ;check to determine if inpatient or outpatient:
"RTN","ORKPS",245,0)
 D ADM^VADPT2
"RTN","ORKPS",246,0)
 S ORPTYPE=$S(+$G(VADMVT)>0:"I",1:"O")
"RTN","ORKPS",247,0)
 K ^TMP("PS",$J)
"RTN","ORKPS",248,0)
 D OCL^PSOORRL(DFN,"","")  ;if no date range, returns active meds for pt
"RTN","ORKPS",249,0)
 N X
"RTN","ORKPS",250,0)
 S X=0
"RTN","ORKPS",251,0)
 F  S X=$O(^TMP("PS",$J,X)) Q:X<1  D
"RTN","ORKPS",252,0)
 .S ORX=$G(^TMP("PS",$J,X,0))
"RTN","ORKPS",253,0)
 .S ORY=$P(ORX,U)
"RTN","ORKPS",254,0)
 .S ORNUM=$P(ORX,U,8) ;order entry order number
"RTN","ORKPS",255,0)
 .S ORS=$P(ORX,U,9) ;medication status from pharmacy
"RTN","ORKPS",256,0)
 .S ORPRENEW=$P(ORX,U,14)  ;pending renewal flag (1: pending renewal)
"RTN","ORKPS",257,0)
 .Q:+ORX<1
"RTN","ORKPS",258,0)
 .Q:$P(ORY,";",2)'=ORPTYPE  ;quit if med is not pt type (inpt/outpt)
"RTN","ORKPS",259,0)
 .;quit if status is a non-active type:
"RTN","ORKPS",260,0)
 .Q:$G(ORS)="EXPIRED"
"RTN","ORKPS",261,0)
 .Q:$G(ORS)["DISCONTINUE"
"RTN","ORKPS",262,0)
 .Q:$G(ORS)="DELETED"
"RTN","ORKPS",263,0)
 .Q:+$G(ORPRENEW)>0
"RTN","ORKPS",264,0)
 .Q:$$SUPPLY($$OI^ORQOR2(ORNUM))=1  ;quit if a supply
"RTN","ORKPS",265,0)
 .S NUMRX=NUMRX+1
"RTN","ORKPS",266,0)
 K ^TMP("PS",$J)
"RTN","ORKPS",267,0)
 Q NUMRX
"RTN","ORKPS",268,0)
OI2DD(OROI,ORPSPKG,ORCHKTYP)       ;rtn dispense drugs for a PS OI
"RTN","ORKPS",269,0)
 ;ORCHKTYP: TYPE OF ORDER CHECK SYSTEM IS PERFORMING
"RTN","ORKPS",270,0)
 ;          1 FOR ENHANCED ORDER CHECKS
"RTN","ORKPS",271,0)
 ;          2 FOR DOSAGE ORDER CHECK
"RTN","ORKPS",272,0)
 N PSOI,ORRET
"RTN","ORKPS",273,0)
 Q:'$D(^ORD(101.43,OROI,0)) ""
"RTN","ORKPS",274,0)
 S PSOI=+$P(^ORD(101.43,OROI,0),U,2)
"RTN","ORKPS",275,0)
 Q:PSOI<1 ""
"RTN","ORKPS",276,0)
 S:ORPSPKG="H" ORPSPKG="X"  ;if non-va med need to pass api "X"
"RTN","ORKPS",277,0)
 S ORRET=$$DRG^PSSDSAPM(PSOI,ORPSPKG,ORCHKTYP)
"RTN","ORKPS",278,0)
 I ORCHKTYP=1,(+$P(ORRET,";",4)) S $P(ORRET,";",4)=PSOI
"RTN","ORKPS",279,0)
 Q ORRET
"RTN","ORKPS1")
0^2^B108794510^B86882851
"RTN","ORKPS1",1,0)
ORKPS1 ; SLC/CLA - Order checking support procedures for medications ;01/04/18  11:26
"RTN","ORKPS1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**232,272,346,352,345,311,402,457,469**;Dec 17, 1997;Build 4
"RTN","ORKPS1",3,0)
 Q
"RTN","ORKPS1",4,0)
PROCESS(OI,DFN,ORKDG,ORPROSP,ORGLOBL) ;process data from pharmacy order check API
"RTN","ORKPS1",5,0)
 ;ORPROSP = pharmacy orderable item ien [file #50.7] ^ drug ien [file #50]
"RTN","ORKPS1",6,0)
 ;          NOTE: PIECE 1 WILL ONLY BE FILLED IN FOR ORDERABLE ITEMS THAT RESOLVE TO SUPPLY ITEMS
"RTN","ORKPS1",7,0)
 Q:'$D(^TMP($J))
"RTN","ORKPS1",8,0)
 N II,XX,ZZ,ZZD,ORMTYPE,ORN,ORZ,RCNT,GL,I,J,K,L,M,TDATA,VADMVT,ORX,ORY
"RTN","ORKPS1",9,0)
 S II=1,XX=0,ZZ="",ZZD="",RCNT=0
"RTN","ORKPS1",10,0)
 I $G(^TMP($J,ORGLOBL,"OUT",0))<0 D  Q
"RTN","ORKPS1",11,0)
 .S YY(II)="ERR^Drug-Drug order checks (Duplicate Therapy, Duplicate Drug, Drug Interaction) were not able to be performed. "_$P($G(^TMP($J,ORGLOBL,"OUT",0)),U,2)
"RTN","ORKPS1",12,0)
 .S II=II+1
"RTN","ORKPS1",13,0)
 I $D(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS")) D
"RTN","ORKPS1",14,0)
 .S ORX="" F  S ORX=$O(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX)) Q:'$L(ORX)  D
"RTN","ORKPS1",15,0)
 ..S ORY=0 F  S ORY=$O(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)) Q:'ORY  D
"RTN","ORKPS1",16,0)
 ...I $L($G(ORIFN))>0,$G(ORIFN)=$P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,5) Q
"RTN","ORKPS1",17,0)
 ...S YY(II)="ERR^"_$P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,7)
"RTN","ORKPS1",18,0)
 ...I $L($P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,10))>0 S YY(II)=YY(II)_"("_$P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,10)_")"
"RTN","ORKPS1",19,0)
 ...S II=II+1
"RTN","ORKPS1",20,0)
 S ORX="" F ORX="DRUGDRUG","THERAPY" D
"RTN","ORKPS1",21,0)
 .Q:'$D(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR"))
"RTN","ORKPS1",22,0)
 .S ORY="" F  S ORY=$O(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY)) Q:'$L(ORY)  D
"RTN","ORKPS1",23,0)
 ..S ORZ=0 F  S ORZ=$O(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ)) Q:'ORZ  D
"RTN","ORKPS1",24,0)
 ...S YY(II)="ERR^"_$$UPPER^ORWDPS32($G(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ,"SEV")))_": "_$P($G(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ,0)),U)_" - "_$G(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ,"TEXT"))
"RTN","ORKPS1",25,0)
 ...S II=II+1
"RTN","ORKPS1",26,0)
 I +$P(ORPROSP,U,2) D
"RTN","ORKPS1",27,0)
 .;set info about the drug being ordered
"RTN","ORKPS1",28,0)
 .S TDATA("NEW","TXT")=""
"RTN","ORKPS1",29,0)
 .S I="" F  S I=$O(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)) Q:'$L(I)  D
"RTN","ORKPS1",30,0)
 ..I $P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,5)=+$G(ORIFN),$P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,3)=(+$P(ORPROSP,U,2)) D
"RTN","ORKPS1",31,0)
 ...S TDATA("NEW","TXT")=$P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,4)
"RTN","ORKPS1",32,0)
 ...S TDATA("NEW","PROSP")=$P(I,";",3,4)
"RTN","ORKPS1",33,0)
 .;if we get here and we don't have anything in TDATA("NEW","PROSP") then we need to set to the first PROSPECTIVE
"RTN","ORKPS1",34,0)
 .I '$L($G(TDATA("NEW","PROSP"))) D
"RTN","ORKPS1",35,0)
 ..S I="" F  S I=$O(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)) Q:'$L(I)  I $P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,3)=(+$P(ORPROSP,U,2)) D
"RTN","ORKPS1",36,0)
 ...S TDATA("NEW","TXT")=$P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,4)
"RTN","ORKPS1",37,0)
 ...S TDATA("NEW","PROSP")=$P(I,";",3,4)
"RTN","ORKPS1",38,0)
 .;/////////////////GET PTYPE RIGHT///////////////////
"RTN","ORKPS1",39,0)
 .S TDATA("NEW","OTYPE")=$S($G(ORKDG)="PSI":"UD",$G(ORKDG)="PSO":"OP",$G(ORKDG)="PSIV":"IV",$G(ORKDG)="PSH":"NV",1:"")
"RTN","ORKPS1",40,0)
 .;initially base PTYPE on display group
"RTN","ORKPS1",41,0)
 .S TDATA("NEW","PTYPE")=$S($G(ORKDG)="PSI":"I",$G(ORKDG)="PSO":"O",$G(ORKDG)="PSIV":"I",$G(ORKDG)="PSH":"O",1:"")
"RTN","ORKPS1",42,0)
 .;if we have an order number then we can accurately determine if it is a Clinic med or not
"RTN","ORKPS1",43,0)
 .I +$G(ORIFN) D
"RTN","ORKPS1",44,0)
 ..I $$ISCLIN(+$G(ORIFN)) S TDATA("NEW","PTYPE")="C" Q
"RTN","ORKPS1",45,0)
 .;if we don't have an order number then if the patient is an outpatient and the OTYPE is UD or IV we assume Clinic med
"RTN","ORKPS1",46,0)
 .I '(+$G(ORIFN)) D
"RTN","ORKPS1",47,0)
 ..I ($G(TDATA("NEW","OTYPE"))="UD")!($G(TDATA("NEW","OTYPE"))="IV") D
"RTN","ORKPS1",48,0)
 ...I $$PATTYPE(DFN)="O" S TDATA("NEW","PTYPE")="C"
"RTN","ORKPS1",49,0)
 .;if PTYPE not set at this point, set it to patient type (catch all for safety)
"RTN","ORKPS1",50,0)
 .I '$L(TDATA("NEW","PTYPE")) D
"RTN","ORKPS1",51,0)
 ..S TDATA("NEW","PTYPE")=$$PATTYPE(DFN)
"RTN","ORKPS1",52,0)
 .;/////////////////END GET PTYPE RIGHT///////////////////
"RTN","ORKPS1",53,0)
 D DD(.TDATA,$S(+ORPROSP>0:0,1:1))
"RTN","ORKPS1",54,0)
 Q:'$L($G(TDATA("NEW","PROSP")))
"RTN","ORKPS1",55,0)
 D DI(.TDATA)
"RTN","ORKPS1",56,0)
 D DT(.TDATA)
"RTN","ORKPS1",57,0)
 Q
"RTN","ORKPS1",58,0)
 ;
"RTN","ORKPS1",59,0)
DI(TDATA) ;add drug interaction checks
"RTN","ORKPS1",60,0)
 N GL,ORSEV,ORDRUG,ORTXT,ORIEN
"RTN","ORKPS1",61,0)
 S GL=$NA(^TMP($J,ORGLOBL,"OUT","DRUGDRUG"))
"RTN","ORKPS1",62,0)
 S J="" F  S J=$O(@GL@(J)) Q:'$L(J)  D
"RTN","ORKPS1",63,0)
 .S K="" F  S K=$O(@GL@(J,K)) Q:'$L(K)  D
"RTN","ORKPS1",64,0)
 ..S L=0 F  S L=$O(@GL@(J,K,L)) Q:'$L(L)  D
"RTN","ORKPS1",65,0)
 ...S M=0 F  S M=$O(@GL@(J,K,L,M)) Q:'M  D
"RTN","ORKPS1",66,0)
 ....N ORNUM,ORSEV,ORDNAME,ORZ,CNT,ORSTAT,ORMON,ORWHICH,ORLINE,ORIDX
"RTN","ORKPS1",67,0)
 ....;get the associated order number
"RTN","ORKPS1",68,0)
 ....S ORNUM=$P(L,";",1,2)
"RTN","ORKPS1",69,0)
 ....;if the status of the associated order is DISCONTINUED then don't add
"RTN","ORKPS1",70,0)
 ....S ORSTAT=$$PHSTAT(DFN,ORNUM)
"RTN","ORKPS1",71,0)
 ....Q:ORSTAT="DISCONTINUED"
"RTN","ORKPS1",72,0)
 ....S ORWHICH=""
"RTN","ORKPS1",73,0)
 ....I $P($P(@GL@(J,K,L,M),U),";",3,4)=TDATA("NEW","PROSP") D
"RTN","ORKPS1",74,0)
 .....S ORWHICH=K_" ["_$S($P(L,";",3)="PROSPECTIVE":"UNRELEASED",1:ORSTAT)_"]"
"RTN","ORKPS1",75,0)
 ....I $P(L,";",3,4)=TDATA("NEW","PROSP") D
"RTN","ORKPS1",76,0)
 .....S ORWHICH=$P(@GL@(J,K,L,M),U,4)_" ["
"RTN","ORKPS1",77,0)
 .....S ORWHICH=ORWHICH_$S($P($P(@GL@(J,K,L,M),U),";",3)="PROSPECTIVE":"UNRELEASED",1:$$PHSTAT(DFN,$P($P(@GL@(J,K,L,M),U),";",1,2)))
"RTN","ORKPS1",78,0)
 .....S ORWHICH=ORWHICH_"]"
"RTN","ORKPS1",79,0)
 ....Q:$L(ORWHICH)<2
"RTN","ORKPS1",80,0)
 ....;get text
"RTN","ORKPS1",81,0)
 ....S ORTXT(J,K_";"_ORNUM)=$S($G(ORTXT(J,K))'="":ORTXT(J,K)_" ",1:"")_$P($G(@GL@(J,K,L,M,"CLIN")),"CLINICAL EFFECTS:  ",2),ORTXT(J,K_";"_ORNUM,"ORWHICH")=ORWHICH ;*457
"RTN","ORKPS1",82,0)
 ....;set the monograph into the temp global
"RTN","ORKPS1",83,0)
 ....I $D(@GL@(J,K,L,M,"PMON")) D
"RTN","ORKPS1",84,0)
 .....S ^TMP($J,"ORMONOGRAPH")=1+$G(^TMP($J,"ORMONOGRAPH"))
"RTN","ORKPS1",85,0)
 .....S ORMON=^TMP($J,"ORMONOGRAPH")
"RTN","ORKPS1",86,0)
 .....S ^TMP($J,"ORMONOGRAPH",ORMON,"INT")=@GL@(J,K,L,M,"INT")
"RTN","ORKPS1",87,0)
 .....S ORIDX="",ORLINE=1 F  S ORIDX=$O(@GL@(J,K,L,M,"PMON",ORIDX)) Q:+$G(ORIDX)=0  D
"RTN","ORKPS1",88,0)
 ......S ^TMP($J,"ORMONOGRAPH",ORMON,"DATA",ORLINE,0)=@GL@(J,K,L,M,"PMON",ORIDX,0),ORLINE=ORLINE+1
"RTN","ORKPS1",89,0)
 .....S ORTXT(J,K_";"_ORNUM,"MONOGRAPH")=1,ORTXT(J,K_";"_ORNUM,"ORMON",ORMON)="" ;*457
"RTN","ORKPS1",90,0)
 ....;get the severity
"RTN","ORKPS1",91,0)
 ....S ORSEV=$$UPPER^ORU($G(@GL@(J,K,L,M,"SEV")))
"RTN","ORKPS1",92,0)
 ....;get the drug name
"RTN","ORKPS1",93,0)
 ....S ORDNAME=K
"RTN","ORKPS1",94,0)
 ....S ORTXT(J,K_";"_ORNUM,"YY")="DI^"_ORSEV_U_ORNUM_U_ORDNAME_U_U_$G(@GL@(J,K,L,M,"INT")) ;*457
"RTN","ORKPS1",95,0)
 ;RETURN DATA IN EXPECTED FORMAT
"RTN","ORKPS1",96,0)
 S ORSEV="" F  S ORSEV=$O(ORTXT(ORSEV)) Q:$G(ORSEV)=""  D
"RTN","ORKPS1",97,0)
 .S ORDRUG="" F  S ORDRUG=$O(ORTXT(ORSEV,ORDRUG)) Q:$G(ORDRUG)=""  D
"RTN","ORKPS1",98,0)
 ..S YY(II)=ORTXT(ORSEV,ORDRUG,"YY")
"RTN","ORKPS1",99,0)
 ..S $P(YY(II),U,5)=TDATA("NEW","TXT")_" and "_ORTXT(ORSEV,ORDRUG,"ORWHICH")_" - "_ORTXT(ORSEV,ORDRUG)
"RTN","ORKPS1",100,0)
 ..S ORIEN=0 F  S ORIEN=$O(ORTXT(ORSEV,ORDRUG,"ORMON",ORIEN)) Q:+$G(ORIEN)=0  D
"RTN","ORKPS1",101,0)
 ...S ^TMP($J,"ORMONOGRAPH",ORIEN,"OC")=$P(YY(II),U,5)
"RTN","ORKPS1",102,0)
 ..S:$G(ORTXT(ORSEV,ORDRUG,"MONOGRAPH")) $P(YY(II),U,5)=$P(YY(II),U,5)_" - Monograph Available"
"RTN","ORKPS1",103,0)
 ..S II=II+1
"RTN","ORKPS1",104,0)
 Q
"RTN","ORKPS1",105,0)
 ;
"RTN","ORKPS1",106,0)
DD(TDATA,ORDPROSP) ;add duplicate drug checks
"RTN","ORKPS1",107,0)
 ;ORDPROSP: PERFORM PROSPECTIVE DRUG CHECK
"RTN","ORKPS1",108,0)
 ;          1 FOR YES
"RTN","ORKPS1",109,0)
 ;          0 FOR NO
"RTN","ORKPS1",110,0)
 S XX=0,ZZ=""
"RTN","ORKPS1",111,0)
 F  S XX=$O(^TMP($J,"DD",XX)) Q:XX<1  D
"RTN","ORKPS1",112,0)
 .N ORREM
"RTN","ORKPS1",113,0)
 .S ZZ=$G(^TMP($J,"DD",XX,0)),ORMTYPE=$P($P(ZZ,U,4),";",2)
"RTN","ORKPS1",114,0)
 .S ORREM=$P($P(ZZ,U,4),";") I (ORREM["Z"),$D(^TMP($J,ORGLOBL,"OUT","REMOTE",+ORREM)) D
"RTN","ORKPS1",115,0)
 ..N ORTXT,ORREM1,ORREMSIG
"RTN","ORKPS1",116,0)
 ..S ORREM1=$G(^TMP($J,ORGLOBL,"OUT","REMOTE",+ORREM))
"RTN","ORKPS1",117,0)
 ..S ORREMSIG=$G(^TMP($J,ORGLOBL,"OUT","REMOTE",+ORREM,"SIG",0))
"RTN","ORKPS1",118,0)
 ..S ORTXT=" "_ORREMSIG_" ["_$P(ORREM1,U,4)_" -  Last Fill: "_$P(ORREM1,U,6)_"  Quantity Dispensed: "_$P(ORREM1,U,8)_"] >>"_$P(ORREM1,U)
"RTN","ORKPS1",119,0)
 ..S $P(ZZ,U,2)=$P(ZZ,U,2)_ORTXT
"RTN","ORKPS1",120,0)
 .I +ORDPROSP,$G(TDATA("NEW","PTYPE"))'=$G(ORMTYPE) Q
"RTN","ORKPS1",121,0)
 .S ORN=$P($P(ZZ,U,3),";"),ORZ=""
"RTN","ORKPS1",122,0)
 .I $L($G(ORN))>0,+$G(ORN)=+$G(ORIFN) Q  ;QUIT if dup med ord # = current ord #
"RTN","ORKPS1",123,0)
 .I +$G(ORIFN),+$G(ORN)=$P(^OR(100,+ORIFN,3),U,5) Q  ;QUIT if dup med ord # = the current order #'s REPLACED ORDER (changing an order)
"RTN","ORKPS1",124,0)
 .I +ORDPROSP,+$P(ORPROSP,U,2)'=+ZZ Q
"RTN","ORKPS1",125,0)
 .I $L(ORN),$D(^OR(100,ORN,8,0)) S ORZ=^OR(100,ORN,8,0)
"RTN","ORKPS1",126,0)
 .I $L($G(ORZ)),($P(^OR(100,ORN,8,$P(ORZ,U,3),0),U,2)="DC") Q
"RTN","ORKPS1",127,0)
 .I $L(ORN),$P(^ORD(100.01,$P(^OR(100,ORN,3),U,3),0),U)="DISCONTINUED" Q
"RTN","ORKPS1",128,0)
 .I ZZ'="" S YY(II)="DD^"_ZZ,II=II+1
"RTN","ORKPS1",129,0)
 .S ^TMP($J,"DD",XX,"OC")="" ;set this if this DD entry turned into an OC
"RTN","ORKPS1",130,0)
 Q
"RTN","ORKPS1",131,0)
 ;
"RTN","ORKPS1",132,0)
DT(TDATA) ;add duplicate therapy checks
"RTN","ORKPS1",133,0)
 N I,GL
"RTN","ORKPS1",134,0)
 S GL=$NA(^TMP($J,ORGLOBL,"OUT","THERAPY"))
"RTN","ORKPS1",135,0)
 S I=0 F  S I=$O(@GL@(I)) Q:'I  D
"RTN","ORKPS1",136,0)
 .N ORDRUGS,J,ORCLASS,ORNUM,ORRETSTR,ORPROSIN S ORPROSIN=0,ORDRUGS="",ORCLASS=""
"RTN","ORKPS1",137,0)
 .S J=0 F  S J=$O(@GL@(I,"DRUGS",J)) Q:'J  D
"RTN","ORKPS1",138,0)
 ..;get the type of the item checked against
"RTN","ORKPS1",139,0)
 ..N ORPTYPE S ORPTYPE=$P($G(@GL@(I,"DRUGS",J)),U,5)
"RTN","ORKPS1",140,0)
 ..;get if the item checked against is PROSPECTIVE or PROFILE
"RTN","ORKPS1",141,0)
 ..N ORDTYPE S ORDTYPE=$P($G(@GL@(I,"DRUGS",J)),";",3)
"RTN","ORKPS1",142,0)
 ..;if the item checked against is a PROSPECTIVE then get its type from file 100
"RTN","ORKPS1",143,0)
 ..I ORDTYPE="PROSPECTIVE" D
"RTN","ORKPS1",144,0)
 ...N ORXNUM S ORXNUM=+$P($G(@GL@(I,"DRUGS",J)),U,4)
"RTN","ORKPS1",145,0)
 ...I ORXNUM D
"RTN","ORKPS1",146,0)
 ....N ORKDGIEN S ORKDGIEN=$P($G(^OR(100,ORXNUM,0)),U,11)
"RTN","ORKPS1",147,0)
 ....N ORKDG S ORKDG=$P($G(^ORD(100.98,ORKDGIEN,0)),U,3)
"RTN","ORKPS1",148,0)
 ....S ORPTYPE=$S($G(ORKDG)="UD RX":"I",$G(ORKDG)="I RX":"I",$G(ORKDG)="IV RX":"I",$G(ORKDG)="CI RX":"C",$G(ORKDG)="CL OR":"C",$G(ORKDG)="C RX":"C",$G(ORKDG)="C RX":"C",1:"O")
"RTN","ORKPS1",149,0)
 ..;consider Remote orders in the DRUGS array to be outpatient orders
"RTN","ORKPS1",150,0)
 ..I ORPTYPE="R" S ORPTYPE="O"
"RTN","ORKPS1",151,0)
 ..;if this is the prospective we are checking, set ORPROSIN=1 to indicate the one we are looking at is in this OC from the API
"RTN","ORKPS1",152,0)
 ..I $G(TDATA("NEW","PROSP"))=$P($P($G(@GL@(I,"DRUGS",J)),U),";",3,4) S ORPROSIN=1
"RTN","ORKPS1",153,0)
 ..;if neither the item being checked and the item checked against are not Clinic meds and they do not match in type, don't use it
"RTN","ORKPS1",154,0)
 ..I ($G(TDATA("NEW","PTYPE"))'=ORPTYPE),(ORPTYPE'="C"),($G(TDATA("NEW","PTYPE"))'="C") Q
"RTN","ORKPS1",155,0)
 ..;if this matches the replacement order of the item being checked against, don't use it
"RTN","ORKPS1",156,0)
 ..I $L($P($G(@GL@(I,"DRUGS",J)),U,4))>0,(+$P($G(@GL@(I,"DRUGS",J)),U,4)=$P($G(^OR(100,+$G(ORIFN),3)),U,5)) Q
"RTN","ORKPS1",157,0)
 ..;if this matches the order number of the item being checked against, don't use it
"RTN","ORKPS1",158,0)
 ..I $L($P($G(@GL@(I,"DRUGS",J)),U,4))>0,(+$P($G(@GL@(I,"DRUGS",J)),U,4)=+$G(ORIFN)) Q
"RTN","ORKPS1",159,0)
 ..;if this is the prospective we are checking, don't use it
"RTN","ORKPS1",160,0)
 ..I $G(TDATA("NEW","PROSP"))=$P($P($G(@GL@(I,"DRUGS",J)),U),";",3,4)  Q
"RTN","ORKPS1",161,0)
 ..;if we got here then this order from the DRUGS array should be in the output message
"RTN","ORKPS1",162,0)
 ..S ORNUM=$P($P($G(@GL@(I,"DRUGS",J)),U),";",1,2)
"RTN","ORKPS1",163,0)
 ..S ORDRUGS=ORDRUGS_$S($L(ORDRUGS):", ",1:"")_$P($G(@GL@(I,"DRUGS",J)),U,3)_" ["_$$PHSTAT(DFN,ORNUM)_"]"
"RTN","ORKPS1",164,0)
 .;quit if no drugs have been set into ORDRUGS
"RTN","ORKPS1",165,0)
 .Q:('$L(ORDRUGS))
"RTN","ORKPS1",166,0)
 .;quit if ORPROSIN is still 0 which means the prospective we are looking at was not part of this OC returned from the API
"RTN","ORKPS1",167,0)
 .Q:'ORPROSIN
"RTN","ORKPS1",168,0)
 .;get all classes
"RTN","ORKPS1",169,0)
 .S J=0 F  S J=$O(@GL@(I,J)) Q:'J  D
"RTN","ORKPS1",170,0)
 ..S ORCLASS=ORCLASS_$S($L(ORCLASS):", ",1:"")_$G(@GL@(I,J,"CLASS"))
"RTN","ORKPS1",171,0)
 .;assemble return string ("DC"+ORNUM_U_Classes_U_Classes (drugs))
"RTN","ORKPS1",172,0)
 .S ORRETSTR="Duplicate Therapy: Order(s) exist for {"_ORDRUGS_"} in the same therapeutic categor(ies): "_ORCLASS
"RTN","ORKPS1",173,0)
 .S YY(II)="DC"_U_$G(ORNUM)_U_ORCLASS_U_ORRETSTR,II=II+1
"RTN","ORKPS1",174,0)
 Q
"RTN","ORKPS1",175,0)
 ;
"RTN","ORKPS1",176,0)
PHSTAT(DFN,ORNUM) ;get the status of the order
"RTN","ORKPS1",177,0)
 N RET,J,I
"RTN","ORKPS1",178,0)
 S RET=""
"RTN","ORKPS1",179,0)
 I $P(ORNUM,";")="P" S RET="PENDING"
"RTN","ORKPS1",180,0)
 I $P(ORNUM,";")="N" S RET="ACTIVE NON-VA"
"RTN","ORKPS1",181,0)
 I $P(ORNUM,";")="O" D
"RTN","ORKPS1",182,0)
 .N ORLAST
"RTN","ORKPS1",183,0)
 .I $E($P(ORNUM,";"),1)="C" S ORLAST=$S($E($P(ORNUM,";"),2)=1:"V",$E($P(ORNUM,";"),2)=2:"U",1:"NV")
"RTN","ORKPS1",184,0)
 .E  S ORLAST=$E(ORNUM,$L(ORNUM))
"RTN","ORKPS1",185,0)
 .I ORLAST="0" S RET="UNRELEASED" Q
"RTN","ORKPS1",186,0)
 .I ORLAST="P" S RET="PENDING" Q
"RTN","ORKPS1",187,0)
 .K ^TMP($J,"OROCLST") D RX^PSO52API(DFN,"OROCLST",$P(ORNUM,";",2),,"ST")
"RTN","ORKPS1",188,0)
 .S RET=$P($G(^TMP($J,"OROCLST",DFN,$P(ORNUM,";",2),100)),U,2)
"RTN","ORKPS1",189,0)
 .K ^TMP($J,"OROCLST")
"RTN","ORKPS1",190,0)
 I $P(ORNUM,";")="I"!($E($P(ORNUM,";"),1)="C") D
"RTN","ORKPS1",191,0)
 .N ORLAST,ORPHNUM
"RTN","ORKPS1",192,0)
 .I $E($P(ORNUM,";"),1)="C" S ORLAST=$S($E($P(ORNUM,";"),2)=1:"V",$E($P(ORNUM,";"),2)=2:"U",1:"NV")
"RTN","ORKPS1",193,0)
 .E  S ORLAST=$E(ORNUM,$L(ORNUM))
"RTN","ORKPS1",194,0)
 .I ORLAST="0" S RET="UNRELEASED" Q
"RTN","ORKPS1",195,0)
 .I ORLAST="P" S RET="PENDING" Q
"RTN","ORKPS1",196,0)
 .S ORPHNUM=+$P(ORNUM,";",2)
"RTN","ORKPS1",197,0)
 .I ORLAST="U" D
"RTN","ORKPS1",198,0)
 ..K ^TMP($J,"OR GET STATUS") D PSS431^PSS55(DFN,ORPHNUM,"","","OR GET STATUS")
"RTN","ORKPS1",199,0)
 ..S RET=$P($G(^TMP($J,"OR GET STATUS",ORPHNUM,28)),U,2)
"RTN","ORKPS1",200,0)
 .I ORLAST="V" D
"RTN","ORKPS1",201,0)
 ..K ^TMP($J,"OR GET STATUS") D PSS436^PSS55(DFN,ORPHNUM,"OR GET STATUS")
"RTN","ORKPS1",202,0)
 ..S RET=$P($G(^TMP($J,"OR GET STATUS",ORPHNUM,100)),U,2)
"RTN","ORKPS1",203,0)
 .I ORLAST="NV" D
"RTN","ORKPS1",204,0)
 ..K ^TMP($J,"OR GET STATUS") D PSJ^PSJ53P1(ORPHNUM,"OR GET STATUS")
"RTN","ORKPS1",205,0)
 ..S RET=$P($G(^TMP($J,"OR GET STATUS",ORPHNUM,28)),U,2)
"RTN","ORKPS1",206,0)
 .S:$E($P(ORNUM,";"),1)="C" RET=RET_" CLINIC ORDER"
"RTN","ORKPS1",207,0)
 I $P(ORNUM,";")="R" D
"RTN","ORKPS1",208,0)
 .N ORREMOTE S ORREMOTE=$G(^TMP($J,ORGLOBL,"OUT","REMOTE",$P(ORNUM,";",2)))
"RTN","ORKPS1",209,0)
 .S RET=$P(ORREMOTE,U,4)_" >> "_$P(ORREMOTE,U)
"RTN","ORKPS1",210,0)
 I "^PENDING^NON-VERIFIED^NON VERIFIED^INCOMPLETE^DRUG INTERACTIONS^"[(U_RET_U) S RET="PENDING"
"RTN","ORKPS1",211,0)
 Q RET
"RTN","ORKPS1",212,0)
 ;
"RTN","ORKPS1",213,0)
ISCLIN(ORNUM) ;check if the order number is a clinic order
"RTN","ORKPS1",214,0)
 N ORRET
"RTN","ORKPS1",215,0)
 D IMOOD^ORIMO(.ORRET,+ORNUM)
"RTN","ORKPS1",216,0)
 Q ORRET
"RTN","ORKPS1",217,0)
 ;
"RTN","ORKPS1",218,0)
PATTYPE(DFN) ;return if patient is Inpatient "I" or Outpatient "O"
"RTN","ORKPS1",219,0)
 N ORRET
"RTN","ORKPS1",220,0)
 D ADM^VADPT2
"RTN","ORKPS1",221,0)
 S ORRET=$S(+$G(VADMVT)>0:"I",1:"O")
"RTN","ORKPS1",222,0)
 K VADMVT
"RTN","ORKPS1",223,0)
 Q ORRET
"RTN","ORKPS1",224,0)
 ;
"RTN","ORWDXC")
0^4^B77488724^B72504942
"RTN","ORWDXC",1,0)
ORWDXC ; SLC/KCM - Utilities for Order Checking ;01/04/18  13:10
"RTN","ORWDXC",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,141,221,243,280,346,345,311,395,269,469**;Dec 17, 1997;Build 4
"RTN","ORWDXC",3,0)
 ;
"RTN","ORWDXC",4,0)
ON(VAL) ; returns E if order checking enabled, otherwise D
"RTN","ORWDXC",5,0)
 S VAL=$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")
"RTN","ORWDXC",6,0)
 Q
"RTN","ORWDXC",7,0)
FILLID(VAL,DLG) ; Return the FillerID (namespace) for a dialog
"RTN","ORWDXC",8,0)
 N DGRP
"RTN","ORWDXC",9,0)
 S VAL="",DGRP=$P($G(^ORD(101.41,DLG,0)),U,5) Q:'DGRP
"RTN","ORWDXC",10,0)
 S DLG=$$DEFDLG^ORWDXQ(DGRP)
"RTN","ORWDXC",11,0)
 S VAL=$P($G(^ORD(101.41,DLG,0)),U,7),VAL=$$NMSP^ORCD(VAL)
"RTN","ORWDXC",12,0)
 I VAL="PS" D
"RTN","ORWDXC",13,0)
 . N X
"RTN","ORWDXC",14,0)
 . S X=$P($P($G(^ORD(100.98,DGRP,0)),U,3)," ")
"RTN","ORWDXC",15,0)
 . I $L(X) S VAL="PS"_$S(X="UD":"I",1:X)
"RTN","ORWDXC",16,0)
 Q
"RTN","ORWDXC",17,0)
DISPLAY(LST,DFN,FID) ; Return list of Order Checks for a FillerID (namespace)
"RTN","ORWDXC",18,0)
 N I,ORX,ORY
"RTN","ORWDXC",19,0)
 S ORX=1,ORX(1)="|"_FID
"RTN","ORWDXC",20,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"DISPLAY")
"RTN","ORWDXC",21,0)
 S I=0 F  S I=$O(ORY(I)) Q:I'>0  S LST(I)=$P(ORY(I),U,4)
"RTN","ORWDXC",22,0)
 Q
"RTN","ORWDXC",23,0)
ACCEPT(LST,DFN,FID,STRT,ORL,OIL,ORIFN,ORREN)    ; Return list of Order Checks on Accept Order
"RTN","ORWDXC",24,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",25,0)
 ; OIL(n)=OIptr^PS|PSIV|LR^PkgInfo
"RTN","ORWDXC",26,0)
 ; ORREN - IF ORREN IS SET TO 1 THEN ORIFN IS THE ORDER GETTING RENEWED
"RTN","ORWDXC",27,0)
 K ^TMP($J,"ORENHCHK")
"RTN","ORWDXC",28,0)
 N X,Y,USID,ORCHECK,ORI,ORX,ORY,%DT,ORDODSG
"RTN","ORWDXC",29,0)
 ; convert relative start date to real start date
"RTN","ORWDXC",30,0)
 S ORL=ORL_";SC(",X=STRT,STRT="",ORDODSG=0
"RTN","ORWDXC",31,0)
 D:X="AM" AM^ORCSAVE2 D:X="NEXT" NEXT^ORCSAVE2
"RTN","ORWDXC",32,0)
 I $L(X) S %DT="FTX" D ^%DT S:Y'>0 Y="" S STRT=Y
"RTN","ORWDXC",33,0)
 ; do the SELECT order checks
"RTN","ORWDXC",34,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",35,0)
 . Q:'OIL(ORI)
"RTN","ORWDXC",36,0)
 . S USID=$$USID(OIL(ORI))
"RTN","ORWDXC",37,0)
 . S OIL(ORI,"USID")=USID
"RTN","ORWDXC",38,0)
 . S ORX=ORX+1,ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_USID
"RTN","ORWDXC",39,0)
 . S:$P(OIL(ORI),U,2)="PSIV" $P(ORX(ORX),"|",7)=$P($P(OIL(ORI),U,3),";")
"RTN","ORWDXC",40,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"SELECT",.OIL,.ORDODSG)
"RTN","ORWDXC",41,0)
 I $D(ORY) D RETURN^ORCHECK ; expects ORY, ORCHECK
"RTN","ORWDXC",42,0)
 K ORX,ORY
"RTN","ORWDXC",43,0)
 ; do the ACCEPT order checks
"RTN","ORWDXC",44,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",45,0)
 . Q:'OIL(ORI)
"RTN","ORWDXC",46,0)
 . S ORX=ORX+1
"RTN","ORWDXC",47,0)
 . S ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_OIL(ORI,"USID")_"|"_STRT
"RTN","ORWDXC",48,0)
 . S:$P(OIL(ORI),U,2)="LR" $P(ORX(ORX),"|",6)=$P(OIL(ORI),U,3)
"RTN","ORWDXC",49,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"ACCEPT",.OIL,.ORDODSG)
"RTN","ORWDXC",50,0)
 I $D(ORY) D RETURN^ORCHECK   ; expects ORY, ORCHECK
"RTN","ORWDXC",51,0)
 ; return ORCHECK as 1 dimensional list
"RTN","ORWDXC",52,0)
 D FDBDOWN^ORCHECK(0)
"RTN","ORWDXC",53,0)
 D OPOS(DFN)
"RTN","ORWDXC",54,0)
 D CHK2LST
"RTN","ORWDXC",55,0)
 D CHECKIT(.LST)
"RTN","ORWDXC",56,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",57,0)
 Q
"RTN","ORWDXC",58,0)
DELAY(LST,DFN,FID,STRT,ORL,OIL) ; Return list of Order Checks on Accept Delayed
"RTN","ORWDXC",59,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",60,0)
 ; OIL(n)=OIptr^PS|PSIV|LR^PkgInfo
"RTN","ORWDXC",61,0)
 N X,Y,ORCHECK,ORI,ORX,ORY,%DT
"RTN","ORWDXC",62,0)
 ; convert relative start date to real start date
"RTN","ORWDXC",63,0)
 S ORL=ORL_";SC(",X=STRT,STRT=""
"RTN","ORWDXC",64,0)
 D:X="AM" AM^ORCSAVE2 D:X="NEXT" NEXT^ORCSAVE2
"RTN","ORWDXC",65,0)
 I $L(X) S %DT="FTX" D ^%DT S:Y'>0 Y="" S STRT=Y
"RTN","ORWDXC",66,0)
 ; do the ACCEPT order checks
"RTN","ORWDXC",67,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",68,0)
 . S ORX=ORX+1
"RTN","ORWDXC",69,0)
 . S ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_$$USID(OIL(ORI))_"|"_STRT
"RTN","ORWDXC",70,0)
 . I $P(OIL(ORI),U,2)="LR" S $P(ORX(ORX),"|",6)=$P(OIL(ORI),U,3)
"RTN","ORWDXC",71,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"ALL",.OIL)
"RTN","ORWDXC",72,0)
 I $D(ORY) D RETURN^ORCHECK   ; expects ORY, ORCHECK
"RTN","ORWDXC",73,0)
 ; return ORCHECK as 1 dimensional list
"RTN","ORWDXC",74,0)
 D CHK2LST
"RTN","ORWDXC",75,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",76,0)
 Q
"RTN","ORWDXC",77,0)
SESSION(LST,ORVP,ORLST) ; Return list of Order Checks on Release Order
"RTN","ORWDXC",78,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD")
"RTN","ORWDXC",79,0)
 N ORES,ORCHECK
"RTN","ORWDXC",80,0)
 S ORVP=+ORVP_";DPT("
"RTN","ORWDXC",81,0)
 S I=0 F  S I=$O(ORLST(I)) Q:'I  D
"RTN","ORWDXC",82,0)
 . I +$P(ORLST(I),";",2)'=1 Q  ; order not new
"RTN","ORWDXC",83,0)
 . I $P(ORLST(I),U,3)="0" Q    ; order not being released
"RTN","ORWDXC",84,0)
 . S ORES($P(ORLST(I),U))=""
"RTN","ORWDXC",85,0)
 D SESSION^ORCHECK
"RTN","ORWDXC",86,0)
 D OPOS(+ORVP)
"RTN","ORWDXC",87,0)
 D CHK2LST
"RTN","ORWDXC",88,0)
 D CHECKIT(.LST)
"RTN","ORWDXC",89,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD")
"RTN","ORWDXC",90,0)
 Q
"RTN","ORWDXC",91,0)
SAVECHK(OK,ORVP,RSN,LST)    ; Save order checks for session
"RTN","ORWDXC",92,0)
 N ORCHECK,ORIFN S OK=1
"RTN","ORWDXC",93,0)
 D LST2CHK
"RTN","ORWDXC",94,0)
 I $L(RSN)>0 S ORCHECK("OK")=RSN
"RTN","ORWDXC",95,0)
 S ORIFN=0 F  S ORIFN=$O(ORCHECK(ORIFN)) Q:'ORIFN  D OC^ORCSAVE2
"RTN","ORWDXC",96,0)
 Q
"RTN","ORWDXC",97,0)
DELORD(OK,ORIFN)      ; Delete order
"RTN","ORWDXC",98,0)
 N STS,DIK,DA
"RTN","ORWDXC",99,0)
 S STS=$P(^OR(100,+ORIFN,8,1,0),U,15),OK=0
"RTN","ORWDXC",100,0)
 I (STS=10)!(STS=11) D  Q  ; makes sure it's an unreleased order
"RTN","ORWDXC",101,0)
 . ;*400 - Delete unused replacement order
"RTN","ORWDXC",102,0)
 . N OLDIFN,DA,DIE,DR S OLDIFN=$P(^OR(100,+ORIFN,3),U,5) I $G(OLDIFN) D
"RTN","ORWDXC",103,0)
 . . S DA=+OLDIFN,DIE="^OR(100,",DR="9.1///@"
"RTN","ORWDXC",104,0)
 . . D ^DIE K DA,DIE,DR
"RTN","ORWDXC",105,0)
 . S DA=+ORIFN,DIK="^OR(100," Q:'DA
"RTN","ORWDXC",106,0)
 . D ^DIK
"RTN","ORWDXC",107,0)
 . S OK=1
"RTN","ORWDXC",108,0)
 . D DELETE^OROCAPI1(+ORIFN)
"RTN","ORWDXC",109,0)
 Q
"RTN","ORWDXC",110,0)
USID(ORITMX) ; Return universal svc ID for an orderable item
"RTN","ORWDXC",111,0)
 ; ORITMX = OI^NMSP^PKGINFO
"RTN","ORWDXC",112,0)
 N RSLT,ORDRUG S RSLT=""
"RTN","ORWDXC",113,0)
 I $E($P(ORITMX,U,2),1,2)="PS" D
"RTN","ORWDXC",114,0)
 . I $P(ORITMX,U,2)="PSIV" D
"RTN","ORWDXC",115,0)
 . . N PSOI,TYPE,VOL S VOL=""
"RTN","ORWDXC",116,0)
 . . S PSOI=+$P($G(^ORD(101.43,+ORITMX,0)),U,2)
"RTN","ORWDXC",117,0)
 . . S TYPE=$P($P(ORITMX,U,3),";")
"RTN","ORWDXC",118,0)
 . . I TYPE="B" S VOL=$P($P(ORITMX,U,3),";",2)
"RTN","ORWDXC",119,0)
 . . D ENDDIV^PSJORUTL(PSOI,TYPE,VOL,.ORDRUG)
"RTN","ORWDXC",120,0)
 . . S ORDRUG=+ORDRUG
"RTN","ORWDXC",121,0)
 . E  S ORDRUG=+$P(ORITMX,U,3)
"RTN","ORWDXC",122,0)
 . S RSLT=$$ENDCM^PSJORUTL(ORDRUG)
"RTN","ORWDXC",123,0)
 . S RSLT=$P(RSLT,U,3)_"^^99NDF^"_ORDRUG_U_$$NAME50^ORPEAPI(ORDRUG)_"^99PSD"
"RTN","ORWDXC",124,0)
 E  S RSLT=$$USID^ORMBLD(+ORITMX)
"RTN","ORWDXC",125,0)
 I +$P(RSLT,U)=0,+($P(RSLT,U,4)=0) S RSLT="" ; has to be null (why?)
"RTN","ORWDXC",126,0)
 Q RSLT
"RTN","ORWDXC",127,0)
 ;
"RTN","ORWDXC",128,0)
CHK2LST ; creates list that can be passed to broker from ORCHECK array
"RTN","ORWDXC",129,0)
 ; expects ORCHECK to be present and populates LST
"RTN","ORWDXC",130,0)
 D REMDUPS ;similar to REMDUPS^ORCHECK
"RTN","ORWDXC",131,0)
 N ORIFN,ORID,CDL,I,ILST,LASTIFN,RESERVED,ORCHECK2,ORNUM,OLIST,SORT
"RTN","ORWDXC",132,0)
 S ILST=0,LASTIFN=0,RESERVED=0,OLIST=0,SORT=""
"RTN","ORWDXC",133,0)
 S ORIFN="" F  S ORIFN=$O(ORCHECK(ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",134,0)
 . S CDL=0 F  S CDL=$O(ORCHECK(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",135,0)
 . . S SORT=$S(+SORT=0:CDL,CDL<+SORT:CDL,1:+SORT)
"RTN","ORWDXC",136,0)
 . . S I=0 F  S I=$O(ORCHECK(ORIFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",137,0)
 . . . S ORCHECK2(ORIFN,CDL,+ORCHECK(ORIFN,CDL,I),I)=ORCHECK(ORIFN,CDL,I)
"RTN","ORWDXC",138,0)
 . S:SORT'="" SORT(SORT,ORIFN)="",SORT=""
"RTN","ORWDXC",139,0)
 K ORCHECK
"RTN","ORWDXC",140,0)
 S ORIFN="" F  S ORIFN=$O(ORCHECK2(ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",141,0)
 . S CDL=0 F  S CDL=$O(ORCHECK2(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",142,0)
 . . S ORNUM=0 F  S ORNUM=$O(ORCHECK2(ORIFN,CDL,ORNUM)) Q:'ORNUM  D
"RTN","ORWDXC",143,0)
 . . . S I=0 F  S I=$O(ORCHECK2(ORIFN,CDL,ORNUM,I)) Q:'I  D
"RTN","ORWDXC",144,0)
 . . . . S OLIST=OLIST+1,ORCHECK(ORIFN,CDL,OLIST)=ORCHECK2(ORIFN,CDL,ORNUM,I)
"RTN","ORWDXC",145,0)
 S SORT=0 F  S SORT=$O(SORT(SORT)) Q:'SORT  D
"RTN","ORWDXC",146,0)
 . S ORIFN="" F  S ORIFN=$O(SORT(SORT,ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",147,0)
 . . S CDL=0 F  S CDL=$O(ORCHECK(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",148,0)
 . . . S I=0 F  S I=$O(ORCHECK(ORIFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",149,0)
 . . . . I LASTIFN'=ORIFN S LASTIFN=ORIFN,RESERVED=ILST+1,ILST=ILST+1 ; saves a spot for the RDI warning at the top of each order's checks
"RTN","ORWDXC",150,0)
 . . . . S ORID=ORIFN I +ORID,(+ORID=ORID) S ORID=ORID_";1"
"RTN","ORWDXC",151,0)
 . . . . I '$P(ORCHECK(ORIFN,CDL,I),U,2) Q  ; CDL="" means don't show
"RTN","ORWDXC",152,0)
 . . . . I $P(ORCHECK(ORIFN,CDL,I),U,1)=99 S LST(RESERVED)=ORID_U_ORCHECK(ORIFN,CDL,I) Q  ;Put RDI warning at the top of each order's checks
"RTN","ORWDXC",153,0)
 . . . . S ILST=ILST+1,LST(ILST)=ORID_U_ORCHECK(ORIFN,CDL,I)
"RTN","ORWDXC",154,0)
 Q
"RTN","ORWDXC",155,0)
LST2CHK ; create ORCHECK array from list passed by broker
"RTN","ORWDXC",156,0)
 N ORIFN,CDL,I,ILST S I=0
"RTN","ORWDXC",157,0)
 S ILST="" F  S ILST=$O(LST("ORCHECKS",ILST)) Q:$L(ILST)'>0  D
"RTN","ORWDXC",158,0)
 . I $D(LST("ORCHECKS",ILST,0)) D
"RTN","ORWDXC",159,0)
 . . N J S J=0 S X=LST("ORCHECKS",ILST,J) F  S J=$O(LST("ORCHECKS",ILST,J)) Q:'J  S X=X_LST("ORCHECKS",ILST,J)
"RTN","ORWDXC",160,0)
 . I '$D(LST("ORCHECKS",ILST,0)) S X=LST("ORCHECKS",ILST)
"RTN","ORWDXC",161,0)
 . S ORIFN=$P(X,U),CDL=$P(X,U,3)
"RTN","ORWDXC",162,0)
 . I +$G(ORIFN)>0,+$G(CDL)>0 D  ;cla 12/16/03
"RTN","ORWDXC",163,0)
 . . S I=I+1,ORCHECK(+ORIFN,CDL,I)=$P(X,U,2,4)
"RTN","ORWDXC",164,0)
 Q
"RTN","ORWDXC",165,0)
CHECKIT(X) ;remove uncessesary duplication of Duplicate Therapy checks
"RTN","ORWDXC",166,0)
 N I,J,Y,Z
"RTN","ORWDXC",167,0)
 S I=0 F  S I=$O(X(I)) Q:'I  I $P(X(I),U,2)=17 D
"RTN","ORWDXC",168,0)
 .Q:$P($G(^ORD(100.8,17,0)),U)'="DUPLICATE DRUG THERAPY"
"RTN","ORWDXC",169,0)
 .N STR S STR=$P($P(X(I),"{",2),"}")
"RTN","ORWDXC",170,0)
 .N CLASS S CLASS=$P(X(I),"in the same therapeutic categor(ies): ",2)
"RTN","ORWDXC",171,0)
 .S Z(+X(I),I)=CLASS
"RTN","ORWDXC",172,0)
 .S J=0 F  S J=J+1 Q:J>$L(STR,", ")  D
"RTN","ORWDXC",173,0)
 ..S Y(+X(I),I,J)=$P(STR,", ",J)
"RTN","ORWDXC",174,0)
 S I="" F  S I=$O(Y(I)) Q:'$L(I)  D
"RTN","ORWDXC",175,0)
 .S J=0 F  S J=$O(Y(I,J)) Q:'J  D
"RTN","ORWDXC",176,0)
 ..S K=J F  S K=$O(Y(I,K)) Q:'K!('$D(Y(I,J)))  D
"RTN","ORWDXC",177,0)
 ...N A,B M A=Y(I,J),B=Y(I,K)
"RTN","ORWDXC",178,0)
 ...I $$AINB(.A,.B) D
"RTN","ORWDXC",179,0)
 ....N ADDCLASS S ADDCLASS=$P(Z(I,J),U)
"RTN","ORWDXC",180,0)
 ....K X(J),Y(I,J)
"RTN","ORWDXC",181,0)
 ....I X(K)'[ADDCLASS S X(K)=X(K)_", "_ADDCLASS
"RTN","ORWDXC",182,0)
 ...Q:'$D(Y(I,J))
"RTN","ORWDXC",183,0)
 ...I $$AINB(.B,.A) D
"RTN","ORWDXC",184,0)
 ....N ADDCLASS S ADDCLASS=$P(Z(I,K),U)
"RTN","ORWDXC",185,0)
 ....K X(K),Y(I,K)
"RTN","ORWDXC",186,0)
 ....I X(J)'[ADDCLASS S X(J)=X(J)_", "_ADDCLASS
"RTN","ORWDXC",187,0)
 Q
"RTN","ORWDXC",188,0)
AINB(A,B) ;if array A is a subset of array B then return 1, else return 0
"RTN","ORWDXC",189,0)
 N I,RET
"RTN","ORWDXC",190,0)
 S RET=1
"RTN","ORWDXC",191,0)
 S I=0 F  S I=$O(A(I)) Q:'I  I '$$XINA(A(I),.B) S RET=0 Q
"RTN","ORWDXC",192,0)
 Q RET
"RTN","ORWDXC",193,0)
XINA(X,A) ;if string X is an entry in array A then return 1, else return 0
"RTN","ORWDXC",194,0)
 N I,RET
"RTN","ORWDXC",195,0)
 S RET=0
"RTN","ORWDXC",196,0)
 S I=0 F  S I=$O(A(I)) Q:'I  I X=A(I) S RET=1 Q
"RTN","ORWDXC",197,0)
 Q RET
"RTN","ORWDXC",198,0)
REMDUPS ;
"RTN","ORWDXC",199,0)
 N IFN,CDL,I,J,CDL2 S IFN="NEW"
"RTN","ORWDXC",200,0)
 S CDL=0 F  S CDL=$O(ORCHECK(IFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",201,0)
 . S I=0 F  S I=$O(ORCHECK(IFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",202,0)
 .. S CDL2=0 F  S CDL2=$O(ORCHECK(IFN,CDL2)) Q:'CDL2  D
"RTN","ORWDXC",203,0)
 ... S J=I F  S J=$O(ORCHECK(IFN,CDL2,J)) Q:'J  I $TR($P($G(ORCHECK(IFN,CDL,I)),U,3),";",",")=$TR($P($G(ORCHECK(IFN,CDL2,J)),U,3),";",",") D
"RTN","ORWDXC",204,0)
 .... I CDL2<=CDL K ORCHECK(IFN,CDL2,J) S ORCHECK=$G(ORCHECK)-1
"RTN","ORWDXC",205,0)
 .... I CDL2>CDL S $P(ORCHECK(IFN,CDL,I),U,7)="X"
"RTN","ORWDXC",206,0)
 .. I $P(ORCHECK(IFN,CDL,I),U,7)="X" K ORCHECK(IFN,CDL,I) S ORCHECK=$G(ORCHECK)-1
"RTN","ORWDXC",207,0)
 Q
"RTN","ORWDXC",208,0)
REMDUPSX ;similar to REMDUPS^ORCHECK
"RTN","ORWDXC",209,0)
 N IFN,CDL,I S IFN="NEW"
"RTN","ORWDXC",210,0)
 S CDL=0 F  S CDL=$O(ORCHECK(IFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",211,0)
 . S I=0 F  S I=$O(ORCHECK(IFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",212,0)
 . . S J=I F  S J=$O(ORCHECK(IFN,CDL,J)) Q:'J  I $G(ORCHECK(IFN,CDL,I))=$G(ORCHECK(IFN,CDL,J)) K ORCHECK(IFN,CDL,J) S ORCHECK=$G(ORCHECK)-1
"RTN","ORWDXC",213,0)
 Q
"RTN","ORWDXC",214,0)
OPOS(DFN) ;handles saving and removing order checks that should only be displayed once per cprs session
"RTN","ORWDXC",215,0)
 ; expects ORCHECK
"RTN","ORWDXC",216,0)
 ; sets these order checks into the "Once Per cprs Session" global ^TMP($J,"OC-OPOS",DFN)
"RTN","ORWDXC",217,0)
 N I,J,K
"RTN","ORWDXC",218,0)
 S I="" F  S I=$O(ORCHECK(I)) Q:'$L(I)  D
"RTN","ORWDXC",219,0)
 .S J=0 F  S J=$O(ORCHECK(I,J)) Q:'J  D
"RTN","ORWDXC",220,0)
 ..S K=0 F  S K=$O(ORCHECK(I,J,K)) Q:'K  D
"RTN","ORWDXC",221,0)
 ...N ORTXT,ORTXTO,ORTXT0,ORTXTI,ORXTRAI
"RTN","ORWDXC",222,0)
 ...S ORTXTO="These checks could not be completed for this patient:"
"RTN","ORWDXC",223,0)
 ...Q:(ORCHECK(I,J,K)'[ORTXTO)
"RTN","ORWDXC",224,0)
 ...S ORTXT=ORTXTO
"RTN","ORWDXC",225,0)
 ...S ORXTRAI=$P($P(ORCHECK(I,J,K),"||",2),"&")
"RTN","ORWDXC",226,0)
 ...S ORTXTI=0 F  S ORTXTI=$O(^TMP($J,"ORK XTRA TXT",ORXTRAI,ORTXTO,ORTXTI))  Q:'ORTXTI  D
"RTN","ORWDXC",227,0)
 ....S ORTXT=ORTXT_$G(^TMP($J,"ORK XTRA TXT",ORXTRAI,ORTXTO,ORTXTI))
"RTN","ORWDXC",228,0)
 ...I $D(^TMP($J,"OC-OPOS",DFN,$E(ORTXT,1,225))) K ORCHECK(I,J,K) Q
"RTN","ORWDXC",229,0)
 ...S ^TMP($J,"OC-OPOS",DFN,$E(ORTXT,1,225))="" Q
"RTN","ORWDXC",230,0)
 Q
"VER")
8.0^22.2
"BLD",9891,6)
^395
**END**
**END**

