Released PSS*1*231 SEQ #202
Extracted from mail message
**KIDS**:PSS*1.0*231^

**INSTALL NAME**
PSS*1.0*231
"BLD",11216,0)
PSS*1.0*231^PHARMACY DATA MANAGEMENT^0^3181227^y
"BLD",11216,1,0)
^^8^8^3181019^
"BLD",11216,1,1,0)
Subject:  FIX ERRORS CALLING DOSAGE CHECK
"BLD",11216,1,2,0)
 
"BLD",11216,1,3,0)
1)  Dosing check fails when values are added and then deleted from field
"BLD",11216,1,4,0)
DRUG(S) FOR DOSING CHK FREQ (#11.1) in the ADMINISTRATION SCHEDULE FILE
"BLD",11216,1,5,0)
(#51.1)
"BLD",11216,1,6,0)
 
"BLD",11216,1,7,0)
2)  Dosing check fails when an OLD SCHEDULE NAME(S) is used with a PRN
"BLD",11216,1,8,0)
designation.
"BLD",11216,4,0)
^9.64PA^^
"BLD",11216,6.3)
4
"BLD",11216,"ABPKG")
n
"BLD",11216,"KRN",0)
^9.67PA^779.2^20
"BLD",11216,"KRN",.4,0)
.4
"BLD",11216,"KRN",.401,0)
.401
"BLD",11216,"KRN",.402,0)
.402
"BLD",11216,"KRN",.403,0)
.403
"BLD",11216,"KRN",.5,0)
.5
"BLD",11216,"KRN",.84,0)
.84
"BLD",11216,"KRN",3.6,0)
3.6
"BLD",11216,"KRN",3.8,0)
3.8
"BLD",11216,"KRN",9.2,0)
9.2
"BLD",11216,"KRN",9.8,0)
9.8
"BLD",11216,"KRN",9.8,"NM",0)
^9.68A^3^2
"BLD",11216,"KRN",9.8,"NM",2,0)
PSSDSUTL^^0^B139786830
"BLD",11216,"KRN",9.8,"NM",3,0)
PSSSCHMS^^0^B128463744
"BLD",11216,"KRN",9.8,"NM","B","PSSDSUTL",2)

"BLD",11216,"KRN",9.8,"NM","B","PSSSCHMS",3)

"BLD",11216,"KRN",19,0)
19
"BLD",11216,"KRN",19.1,0)
19.1
"BLD",11216,"KRN",101,0)
101
"BLD",11216,"KRN",409.61,0)
409.61
"BLD",11216,"KRN",771,0)
771
"BLD",11216,"KRN",779.2,0)
779.2
"BLD",11216,"KRN",870,0)
870
"BLD",11216,"KRN",8989.51,0)
8989.51
"BLD",11216,"KRN",8989.52,0)
8989.52
"BLD",11216,"KRN",8994,0)
8994
"BLD",11216,"KRN","B",.4,.4)

"BLD",11216,"KRN","B",.401,.401)

"BLD",11216,"KRN","B",.402,.402)

"BLD",11216,"KRN","B",.403,.403)

"BLD",11216,"KRN","B",.5,.5)

"BLD",11216,"KRN","B",.84,.84)

"BLD",11216,"KRN","B",3.6,3.6)

"BLD",11216,"KRN","B",3.8,3.8)

"BLD",11216,"KRN","B",9.2,9.2)

"BLD",11216,"KRN","B",9.8,9.8)

"BLD",11216,"KRN","B",19,19)

"BLD",11216,"KRN","B",19.1,19.1)

"BLD",11216,"KRN","B",101,101)

"BLD",11216,"KRN","B",409.61,409.61)

"BLD",11216,"KRN","B",771,771)

"BLD",11216,"KRN","B",779.2,779.2)

"BLD",11216,"KRN","B",870,870)

"BLD",11216,"KRN","B",8989.51,8989.51)

"BLD",11216,"KRN","B",8989.52,8989.52)

"BLD",11216,"KRN","B",8994,8994)

"BLD",11216,"QUES",0)
^9.62^^
"BLD",11216,"REQB",0)
^9.611^1^1
"BLD",11216,"REQB",1,0)
PSS*1.0*224^2
"BLD",11216,"REQB","B","PSS*1.0*224",1)

"MBREQ")
0
"PKG",488,-1)
1^1
"PKG",488,0)
PHARMACY DATA MANAGEMENT^PSS^Maintenance of Pharmacy files.
"PKG",488,22,0)
^9.49I^1^1
"PKG",488,22,1,0)
1.0^2970930^3000316^66481
"PKG",488,22,1,"PAH",1,0)
231^3181227
"PKG",488,22,1,"PAH",1,1,0)
^^8^8^3181227
"PKG",488,22,1,"PAH",1,1,1,0)
Subject:  FIX ERRORS CALLING DOSAGE CHECK
"PKG",488,22,1,"PAH",1,1,2,0)
 
"PKG",488,22,1,"PAH",1,1,3,0)
1)  Dosing check fails when values are added and then deleted from field
"PKG",488,22,1,"PAH",1,1,4,0)
DRUG(S) FOR DOSING CHK FREQ (#11.1) in the ADMINISTRATION SCHEDULE FILE
"PKG",488,22,1,"PAH",1,1,5,0)
(#51.1)
"PKG",488,22,1,"PAH",1,1,6,0)
 
"PKG",488,22,1,"PAH",1,1,7,0)
2)  Dosing check fails when an OLD SCHEDULE NAME(S) is used with a PRN
"PKG",488,22,1,"PAH",1,1,8,0)
designation.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSSDSUTL")
0^2^B139786830^B133206578
"RTN","PSSDSUTL",1,0)
PSSDSUTL ;BIR/MV-Dose Check utility routine (continued) ;27 Oct 2009  12:22 PM
"RTN","PSSDSUTL",2,0)
 ;;1.0;PHARMACY DATA MANAGEMENT;**201,178,206,224,231**;9/30/97;Build 4
"RTN","PSSDSUTL",3,0)
 ;
"RTN","PSSDSUTL",4,0)
RANGE ;Evaluate free text dosages for range patterns
"RTN","PSSDSUTL",5,0)
 N PSSRG1,PSSRG2,PSSRG3,PSSRG4,PSSRG5,PSSRG6,PSSRGAR,PSSRGDOS,PSSRGLT,PSSRGNM1,PSSRGNM2,PSSRGUN1,PSSRGUN2
"RTN","PSSDSUTL",6,0)
 S PSSRG2=0,PSSRGDOS=$G(PSSDSLCL)
"RTN","PSSDSUTL",7,0)
 S PSSRGDOS=$$UP^XLFSTR(PSSRGDOS)
"RTN","PSSDSUTL",8,0)
 S PSSRGLT=$L(PSSRGDOS) I PSSRGLT'>3!(PSSRGDOS["  ") Q
"RTN","PSSDSUTL",9,0)
 F PSSRG1=1:1:PSSRGLT Q:PSSRG2>4  I $E(PSSRGDOS,PSSRG1)=" " S PSSRG2=PSSRG2+1
"RTN","PSSDSUTL",10,0)
 I PSSRG2>4 Q
"RTN","PSSDSUTL",11,0)
 S PSSRGDOS=$TR(PSSRGDOS," ","") Q:$L(PSSRGDOS)'>0  ;Remove all spaces
"RTN","PSSDSUTL",12,0)
 ;Derive leading numeric value
"RTN","PSSDSUTL",13,0)
 I $E(PSSRGDOS)'?1N,$E(PSSRGDOS)'?1"." Q
"RTN","PSSDSUTL",14,0)
 I $E(PSSRGDOS)?1".",$E(PSSRGDOS,2)'?1N Q
"RTN","PSSDSUTL",15,0)
 S PSSRG2=0 F PSSRG3=1:1:$L(PSSRGDOS) Q:PSSRG2  S PSSRG4=$E(PSSRGDOS,PSSRG3) I PSSRG4'?1N,PSSRG4'?1".",PSSRG4'?1"," S PSSRG2=PSSRG3
"RTN","PSSDSUTL",16,0)
 Q:'PSSRG2  ;only a numeric passed in
"RTN","PSSDSUTL",17,0)
 S PSSRGNM1=$E(PSSRGDOS,1,(PSSRG2-1)),PSSRGDOS=$E(PSSRGDOS,PSSRG2,$L(PSSRGDOS)) Q:$L(PSSRGDOS)'>2
"RTN","PSSDSUTL",18,0)
 S PSSRGAR=$E(PSSRGNM1,$L(PSSRGNM1)) I PSSRGAR="."!(PSSRGAR=",") Q
"RTN","PSSDSUTL",19,0)
 S PSSRG2=0 F PSSRG3=1:1:$L(PSSRGNM1) Q:PSSRG2>1  S PSSRG5=$E(PSSRGNM1,PSSRG3) S:PSSRG5="." PSSRG2=PSSRG2+1
"RTN","PSSDSUTL",20,0)
 Q:PSSRG2>1
"RTN","PSSDSUTL",21,0)
 S PSSRGNM1=$TR(PSSRGNM1,",","") ;PSSRGNM1 Set to first numeric
"RTN","PSSDSUTL",22,0)
 S (PSSRG2,PSSRG4,PSSRG5)=0 F PSSRG3=1:1:$L(PSSRGDOS) Q:PSSRG2  S PSSRG4=$E(PSSRGDOS,PSSRG3) D:'PSSRG5  I PSSRG5,PSSRG4'?1N,PSSRG4'?1",",PSSRG4'?1"." S PSSRG2=PSSRG3
"RTN","PSSDSUTL",23,0)
 .I PSSRG4?1N!(PSSRG4?1".") S (PSSRG5,PSSRG6)=PSSRG3
"RTN","PSSDSUTL",24,0)
 I 'PSSRG5 Q
"RTN","PSSDSUTL",25,0)
 I PSSRG2 S PSSRGUN2=$E(PSSRGDOS,PSSRG2,$L(PSSRGDOS)),PSSRGNM2=$E(PSSRGDOS,PSSRG5,(PSSRG2-1)) ;PSSRGUN2 set to second Unit if there is one
"RTN","PSSDSUTL",26,0)
 I 'PSSRG2 S PSSRGNM2=$E(PSSRGDOS,PSSRG5,$L(PSSRGDOS))
"RTN","PSSDSUTL",27,0)
 I $E(PSSRGNM2)'?1N,$E(PSSRGNM2)'?1"." Q
"RTN","PSSDSUTL",28,0)
 I $E(PSSRGNM2)?1".",$E(PSSRGNM2,2)'?1N Q
"RTN","PSSDSUTL",29,0)
 S PSSRGAR=$E(PSSRGNM2,$L(PSSRGNM2)) I PSSRGAR="."!(PSSRGAR=",") Q
"RTN","PSSDSUTL",30,0)
 S PSSRG2=0 F PSSRG3=1:1:$L(PSSRGNM2) Q:PSSRG2>1  S PSSRG5=$E(PSSRGNM2,PSSRG3) S:PSSRG5="." PSSRG2=PSSRG2+1
"RTN","PSSDSUTL",31,0)
 Q:PSSRG2>1
"RTN","PSSDSUTL",32,0)
 S PSSRGNM2=$TR(PSSRGNM2,",","") ;PSSRGNM2 Set to second numeric
"RTN","PSSDSUTL",33,0)
 S PSSRGDOS=$E(PSSRGDOS,1,(PSSRG6-1))
"RTN","PSSDSUTL",34,0)
 S PSSRG6=$L(PSSRGDOS) Q:PSSRG6'>0
"RTN","PSSDSUTL",35,0)
 S PSSRG1=$E(PSSRGDOS,PSSRG6)
"RTN","PSSDSUTL",36,0)
 I PSSRG1="-" S:PSSRG6>1 PSSRGUN1=$E(PSSRGDOS,1,(PSSRG6-1)) D RANGEOK Q
"RTN","PSSDSUTL",37,0)
 S PSSRG2=$E(PSSRGDOS,(PSSRG6-1),PSSRG6) I PSSRG2="TO"!(PSSRG2="OR") S:PSSRG6>2 PSSRGUN1=$E(PSSRGDOS,1,(PSSRG6-2)) D RANGEOK
"RTN","PSSDSUTL",38,0)
 Q
"RTN","PSSDSUTL",39,0)
 ;
"RTN","PSSDSUTL",40,0)
 ;
"RTN","PSSDSUTL",41,0)
RANGEOK ;Retrieved all needed Dosing
"RTN","PSSDSUTL",42,0)
 N PSSRGUNA,PSSRGUNB
"RTN","PSSDSUTL",43,0)
 I PSSRGNM2'>PSSRGNM1 Q
"RTN","PSSDSUTL",44,0)
 I PSSDBIFL D  Q
"RTN","PSSDSUTL",45,0)
 .I $G(PSSRGUN1)'="" S PSSRGUNA=$$UNITD^PSSDSAPI(PSSRGUN1)
"RTN","PSSDSUTL",46,0)
 .I $G(PSSRGUN2)'="" S PSSRGUNB=$$UNITD^PSSDSAPI(PSSRGUN2)
"RTN","PSSDSUTL",47,0)
 .I $G(PSSRGUN1)'="",$G(PSSRGUN2)'="" D  Q
"RTN","PSSDSUTL",48,0)
 ..I $G(PSSRGUNA)'="",PSSRGUNA=$G(PSSRGUNB) S PSSDBAR("AMN")=PSSRGNM2,PSSDBAR("UNIT")=PSSRGUNA,PSSDBFAL=1
"RTN","PSSDSUTL",49,0)
 .I $G(PSSRGUN1)="" D
"RTN","PSSDSUTL",50,0)
 ..I $G(PSSRGUNB)'="" S PSSDBAR("AMN")=PSSRGNM2,PSSDBAR("UNIT")=PSSRGUNB,PSSDBFAL=1
"RTN","PSSDSUTL",51,0)
 .I $G(PSSRGUN2)="" D
"RTN","PSSDSUTL",52,0)
 ..I $G(PSSRGUNA)'="" S PSSDBAR("AMN")=PSSRGNM2,PSSDBAR("UNIT")=PSSRGUNA,PSSDBFAL=1
"RTN","PSSDSUTL",53,0)
 I $G(PSSRGUN1)'="" S PSSRGUNA=$$UNIT^PSSDSAPI(PSSRGUN1)
"RTN","PSSDSUTL",54,0)
 I $G(PSSRGUN2)'="" S PSSRGUNB=$$UNIT^PSSDSAPI(PSSRGUN2)
"RTN","PSSDSUTL",55,0)
 I $G(PSSRGUN1)'="",$G(PSSRGUN2)'="" D  Q
"RTN","PSSDSUTL",56,0)
 .I $G(PSSRGUNA)'="",PSSRGUNA=$G(PSSRGUNB) S PSSDBAR("AMN")=PSSRGNM2,PSSDBAR("UNIT")=PSSRGUNA,PSSDBFAL=1
"RTN","PSSDSUTL",57,0)
 I $G(PSSRGUN1)="" D
"RTN","PSSDSUTL",58,0)
 .I $G(PSSRGUNB)'="" S PSSDBAR("AMN")=PSSRGNM2,PSSDBAR("UNIT")=PSSRGUNB,PSSDBFAL=1
"RTN","PSSDSUTL",59,0)
 I $G(PSSRGUN2)="" D
"RTN","PSSDSUTL",60,0)
 .I $G(PSSRGUNA)'="" S PSSDBAR("AMN")=PSSRGNM2,PSSDBAR("UNIT")=PSSRGUNA,PSSDBFAL=1
"RTN","PSSDSUTL",61,0)
 Q
"RTN","PSSDSUTL",62,0)
 ;
"RTN","PSSDSUTL",63,0)
 ;
"RTN","PSSDSUTL",64,0)
MLTOK(PSSUTM1,PSSUTM3) ;If multi ingredient, and all ingredients in VA Product have a Unit and it matches the unit from the order
"RTN","PSSDSUTL",65,0)
 N DA,PSSUTMCT,PSSUTMLP,PSSUTMUX,PSSUTMAR,PSSUTMQT,PSSUTMUZ
"RTN","PSSDSUTL",66,0)
 S PSSUTMQT=0
"RTN","PSSDSUTL",67,0)
 S PSSUTMCT=$$PSJING^PSNAPIS(PSSUTM1,PSSUTM3,.PSSUTMAR) I $G(PSSUTMCT)'>1 Q 1
"RTN","PSSDSUTL",68,0)
 F PSSUTMLP=0:0 S PSSUTMLP=$O(PSSUTMAR(PSSUTMLP)) Q:'PSSUTMLP!(PSSUTMQT)  D
"RTN","PSSDSUTL",69,0)
 .S PSSUTMUX=$P(PSSUTMAR(PSSUTMLP),"^",4) I PSSUTMUX="" S PSSUTMQT=1 Q
"RTN","PSSDSUTL",70,0)
 .S PSSUTMUZ=$$UNITD^PSSDSAPI(PSSUTMUX) I PSSUTMUZ="" S PSSUTMQT=1 Q
"RTN","PSSDSUTL",71,0)
 .I PSSUTMUZ'=PSSDBAR("UNIT") S PSSUTMQT=1
"RTN","PSSDSUTL",72,0)
 Q PSSUTMQT
"RTN","PSSDSUTL",73,0)
 ;
"RTN","PSSDSUTL",74,0)
 ;
"RTN","PSSDSUTL",75,0)
UPCPRS ;Update CPRS global
"RTN","PSSDSUTL",76,0)
 I '$D(^TMP($J,PSSDBASF)) Q
"RTN","PSSDSUTL",77,0)
 N PSSCPC5,PSSCPC6,PSSCPC7,PSSCPC8,PSSCPC9,PSSCPCNM,PSSCPGL,PSSCPCND,PSSCPCNN,PSSCPCAR,PSSCPCNX,PSSCPCO1,PSSCPCO2,PSSCPCO3,PSSCPCG1,PSSCPCGN,PSSCPCWA,PSSCPBMR,PSSCPCAJ,PSSCPCAC,PSSCPCE1,PSSCPCE2,PSSCPCR1,PSSCPCR2
"RTN","PSSDSUTL",78,0)
 N PSSCPCR3,PSSCPCR4,PSSCPCR5,PSSCPCR6
"RTN","PSSDSUTL",79,0)
 K ^TMP($J,"PSSCPNEW") M ^TMP($J,"PSSCPNEW")=^TMP($J,PSSDBASF) K ^TMP($J,PSSDBASF)
"RTN","PSSDSUTL",80,0)
 S PSSCPCGL="PSSCPNEW"
"RTN","PSSDSUTL",81,0)
 ;
"RTN","PSSDSUTL",82,0)
 ;Errors - remove Dose subscript, and piece 27 check to to see any error should be kept
"RTN","PSSDSUTL",83,0)
 S PSSCPC5="" F  S PSSCPC5=$O(PSSDBCAR(PSSCPC5)) Q:PSSCPC5=""  S PSSCPCWA=0 D:'$P(PSSDBCAR(PSSCPC5),"^",14)
"RTN","PSSDSUTL",84,0)
 .S PSSCPCR1=0,(PSSCPCR2,PSSCPCR5)=1,PSSCPC6="" F  S PSSCPC6=$O(^TMP($J,PSSCPCGL,"OUT","DOSE","ERROR",PSSCPC5,PSSCPC6)) Q:PSSCPC6=""  S PSSCPCNM=$P(PSSCPC5,";",4) D
"RTN","PSSDSUTL",85,0)
 ..S PSSCPCE1=$G(^TMP($J,PSSCPCGL,"OUT","DOSE","ERROR",PSSCPC5,PSSCPC6,"MSG"))
"RTN","PSSDSUTL",86,0)
 ..S PSSCPCE2=$G(^TMP($J,PSSCPCGL,"OUT","DOSE","ERROR",PSSCPC5,PSSCPC6,"TEXT"))
"RTN","PSSDSUTL",87,0)
 ..I $G(^TMP($J,PSSCPCGL,"OUT","DOSE","ERROR",PSSCPC5,PSSCPC6,"WARN"))="Warning",'$P(PSSCPC5,";",5) S $P(PSSDBCAR(PSSCPC5),"^",13)="",PSSCPCWA=1 D  Q
"RTN","PSSDSUTL",88,0)
 ...S ^TMP($J,PSSDBASF,"OUT","CHECK",PSSCPCNM,PSSCPC5,1,"ATYPE")="DOSE^EXCEPTION"
"RTN","PSSDSUTL",89,0)
 ...S ^TMP($J,PSSDBASF,"OUT","CHECK",PSSCPCNM,PSSCPC5,1,"MSG",1)=PSSCPCE1_$S($E(PSSCPCE1,$L(PSSCPCE1))'=":":":",1:"")_" "_PSSCPCE2
"RTN","PSSDSUTL",90,0)
 ..I '$P(PSSDBCAR(PSSCPC5),"^",27) Q
"RTN","PSSDSUTL",91,0)
 ..I '$O(^TMP($J,PSSCPCGL,"OUT","EXCEPTIONS","DOSE",PSSCPC5,""))!(PSSCPCR1) D  Q
"RTN","PSSDSUTL",92,0)
 ...S PSSCPCR1=1
"RTN","PSSDSUTL",93,0)
 ...S ^TMP($J,PSSCPCGL,"OUT","EXCEPTIONS","DOSE",PSSCPC5,PSSCPCR2)=PSSCPCE1_$S($E(PSSCPCE1,$L(PSSCPCE1))'=".":".",1:"")_" "_PSSCPCE2,PSSCPCR2=PSSCPCR2+1
"RTN","PSSDSUTL",94,0)
 ..I PSSCPCR5=1 K PSSCPCR3 S PSSCPCR4="" F  S PSSCPCR4=$O(^TMP($J,PSSCPCGL,"OUT","EXCEPTIONS","DOSE",PSSCPC5,PSSCPCR4)) Q:PSSCPCR4=""  D
"RTN","PSSDSUTL",95,0)
 ...S PSSCPCR3(PSSCPCR4)=^TMP($J,PSSCPCGL,"OUT","EXCEPTIONS","DOSE",PSSCPC5,PSSCPCR4) K ^TMP($J,PSSCPCGL,"OUT","EXCEPTIONS","DOSE",PSSCPC5,PSSCPCR4)
"RTN","PSSDSUTL",96,0)
 ..S ^TMP($J,PSSCPCGL,"OUT","EXCEPTIONS","DOSE",PSSCPC5,PSSCPCR5)=PSSCPCE1_$S($E(PSSCPCE1,$L(PSSCPCE1))'=".":".",1:"")_" "_PSSCPCE2,PSSCPCR5=PSSCPCR5+1
"RTN","PSSDSUTL",97,0)
 .I $O(PSSCPCR3("")) S PSSCPCR6="" F  S PSSCPCR6=$O(PSSCPCR3(PSSCPCR6)) Q:PSSCPCR6=""  D
"RTN","PSSDSUTL",98,0)
 ..S ^TMP($J,PSSCPCGL,"OUT","EXCEPTIONS","DOSE",PSSCPC5,PSSCPCR5)=PSSCPCR3(PSSCPCR6),PSSCPCR5=PSSCPCR5+1
"RTN","PSSDSUTL",99,0)
 .;
"RTN","PSSDSUTL",100,0)
 .Q:PSSCPCWA  ;Quit if warning
"RTN","PSSDSUTL",101,0)
 .S PSSCPCAR(PSSCPC5)=1 S PSSCPCNM=$P(PSSCPC5,";",4) I $P(PSSDBCAR(PSSCPC5),"^",27) D
"RTN","PSSDSUTL",102,0)
 ..S PSSCPC6="" F  S PSSCPC6=$O(^TMP($J,PSSCPCGL,"OUT","EXCEPTIONS","DOSE",PSSCPC5,PSSCPC6)) Q:PSSCPC6=""  D
"RTN","PSSDSUTL",103,0)
 ...S PSSCPCND=$G(^TMP($J,PSSCPCGL,"OUT","EXCEPTIONS","DOSE",PSSCPC5,PSSCPC6)) Q:PSSCPCND=""
"RTN","PSSDSUTL",104,0)
 ...S ^TMP($J,PSSDBASF,"OUT","CHECK",PSSCPCNM,PSSCPC5,PSSCPCAR(PSSCPC5),"ATYPE")="DOSE^EXCEPTION"
"RTN","PSSDSUTL",105,0)
 ...S ^TMP($J,PSSDBASF,"OUT","CHECK",PSSCPCNM,PSSCPC5,PSSCPCAR(PSSCPC5),"MSG",1)=PSSCPCND,PSSCPCAR(PSSCPC5)=PSSCPCAR(PSSCPC5)+1
"RTN","PSSDSUTL",106,0)
 .;Set generic exception if needed
"RTN","PSSDSUTL",107,0)
 .I '$P(PSSDBCAR(PSSCPC5),"^",27),('$G(PSSENHK(PSSCPC5))!('$G(PSSENHKZ(PSSCPC5)))) D
"RTN","PSSDSUTL",108,0)
 ..;I $P(PSSDBCAR(PSSCPC5),"^",29) S $P(PSSDBCAR(PSSCPC5),"^",4)=0 ;need this to show Daily Dose error
"RTN","PSSDSUTL",109,0)
 ..I '$D(PSSDSDPL(PSSCPC5))!($P(PSSDBCAR(PSSCPC5),"^",4)&('$P(PSSDBCAR(PSSCPC5),"^",13))) Q
"RTN","PSSDSUTL",110,0)
 ..S PSSCPCG1="" I '$P(PSSDBCAR(PSSCPC5),"^",13),'$P(PSSDBCAR(PSSCPC5),"^",4) S PSSCPCG1="Max Daily Dose Check"
"RTN","PSSDSUTL",111,0)
 ..I '$P(PSSDBCAR(PSSCPC5),"^",13),PSSCPCG1="" Q
"RTN","PSSDSUTL",112,0)
 ..I PSSCPCG1'="",$P(PSSDBCAR(PSSCPC5),"^",15)!($P(PSSDBCAR(PSSCPC5),"^",16))!($P(PSSCPC5,";",5)) K PSSCPCG1 Q
"RTN","PSSDSUTL",113,0)
 ..I PSSCPCG1="" S PSSCPCG1=$S('$P(PSSDBCAR(PSSCPC5),"^",15)&('$P(PSSDBCAR(PSSCPC5),"^",16)):"Dosing Checks",1:"Maximum Single Dose Check")
"RTN","PSSDSUTL",114,0)
 ..S PSSCPBMR=$S($P(PSSDBCAR(PSSCPC5),"^",31):$E($P(PSSDBCAR(PSSCPC5),"^",32),1,($L($P(PSSDBCAR(PSSCPC5),"^",32))-2)),1:"")_$S($P(PSSDBCAR(PSSCPC5),"^",16):" (Dose="_$G(PSSDSDPL(PSSCPC5))_")",1:"")
"RTN","PSSDSUTL",115,0)
 ..S PSSCPCGN=PSSCPCG1_" could not be done for Drug: "_$P(PSSDBCAR(PSSCPC5),"^",2)_PSSCPBMR
"RTN","PSSDSUTL",116,0)
 ..S PSSCPCGN=PSSCPCGN_", please complete a manual check for appropriate Dosing."
"RTN","PSSDSUTL",117,0)
 ..S ^TMP($J,PSSDBASF,"OUT","CHECK",PSSCPCNM,PSSCPC5,PSSCPCAR(PSSCPC5),"ATYPE")="DOSE^EXCEPTION"
"RTN","PSSDSUTL",118,0)
 ..S ^TMP($J,PSSDBASF,"OUT","CHECK",PSSCPCNM,PSSCPC5,PSSCPCAR(PSSCPC5),"MSG",1)=PSSCPCGN,PSSCPCAR(PSSCPC5)=PSSCPCAR(PSSCPC5)+1
"RTN","PSSDSUTL",119,0)
 .;
"RTN","PSSDSUTL",120,0)
 .K PSSCPCAJ S PSSCPCO2="",(PSSCPCO3,PSSCPCAC)=0 S PSSCPC6="" F  S PSSCPC6=$O(^TMP($J,PSSCPCGL,"OUT","DOSE",PSSCPC5,PSSCPC6)) Q:PSSCPC6=""  D
"RTN","PSSDSUTL",121,0)
 ..D PEROR S PSSCPCNM=$P(PSSCPC5,";",4) S PSSCPC7="" F  S PSSCPC7=$O(^TMP($J,PSSCPCGL,"OUT","DOSE",PSSCPC5,PSSCPC6,PSSCPC7)) Q:PSSCPC7=""  D
"RTN","PSSDSUTL",122,0)
 ...I +PSSCPC7=2,$P(PSSDBCAR(PSSCPC5),"^",15)!($P(PSSDBCAR(PSSCPC5),"^",16))!($P(PSSCPC5,";",5)) Q  ;2.1 added the conditions
"RTN","PSSDSUTL",123,0)
 ...S PSSCPC8="" F  S PSSCPC8=$O(^TMP($J,PSSCPCGL,"OUT","DOSE",PSSCPC5,PSSCPC6,PSSCPC7,"MESSAGE",PSSCPC8)) Q:PSSCPC8=""  D
"RTN","PSSDSUTL",124,0)
 ....I PSSCPCO2'="" D
"RTN","PSSDSUTL",125,0)
 .....S ^TMP($J,PSSDBASF,"OUT","CHECK",PSSCPCNM,PSSCPC5,PSSCPCAR(PSSCPC5),"ATYPE")="DOSE^"_$S(+PSSCPC7=1:"SINGLE",+PSSCPC7=2:"DAILY",1:"GENERAL")
"RTN","PSSDSUTL",126,0)
 .....S ^TMP($J,PSSDBASF,"OUT","CHECK",PSSCPCNM,PSSCPC5,PSSCPCAR(PSSCPC5),"MSG",1)=PSSCPCO2
"RTN","PSSDSUTL",127,0)
 ....I +PSSCPC7'=3 S PSSCPCNN=$S(PSSCPCO3:2,1:1) D:$G(PSSDBADJ(PSSCPC5))'=""&($G(PSSCPCAJ(PSSCPC5))="") SADJ D  Q
"RTN","PSSDSUTL",128,0)
 .....S PSSCPCND=^TMP($J,PSSCPCGL,"OUT","DOSE",PSSCPC5,PSSCPC6,PSSCPC7,"MESSAGE",PSSCPC8) I PSSCPCAC S PSSCPCND=PSSCPCND_PSSCPCAJ(PSSCPC5)
"RTN","PSSDSUTL",129,0)
 .....I PSSCPCNN=1 S ^TMP($J,PSSDBASF,"OUT","CHECK",PSSCPCNM,PSSCPC5,PSSCPCAR(PSSCPC5),"ATYPE")="DOSE^"_$S(+PSSCPC7=1:"SINGLE",1:"DAILY")
"RTN","PSSDSUTL",130,0)
 .....S ^TMP($J,PSSDBASF,"OUT","CHECK",PSSCPCNM,PSSCPC5,PSSCPCAR(PSSCPC5),"MSG",PSSCPCNN)=PSSCPCND,PSSCPCAR(PSSCPC5)=PSSCPCAR(PSSCPC5)+1
"RTN","PSSDSUTL",131,0)
 ....S PSSCPCNN=$S(PSSCPCO3:1,1:0),PSSCPCAA=$S(PSSCPCNN:2,1:1)
"RTN","PSSDSUTL",132,0)
 ....S PSSCPC9="" F  S PSSCPC9=$O(^TMP($J,PSSCPCGL,"OUT","DOSE",PSSCPC5,PSSCPC6,PSSCPC7,"MESSAGE",PSSCPC8,PSSCPC9)) Q:PSSCPC9=""  D
"RTN","PSSDSUTL",133,0)
 .....I 'PSSCPCNN S ^TMP($J,PSSDBASF,"OUT","CHECK",PSSCPCNM,PSSCPC5,PSSCPCAR(PSSCPC5),"ATYPE")="DOSE^GENERAL"
"RTN","PSSDSUTL",134,0)
 .....S PSSCPCND=^TMP($J,PSSCPCGL,"OUT","DOSE",PSSCPC5,PSSCPC6,PSSCPC7,"MESSAGE",PSSCPC8,PSSCPC9)
"RTN","PSSDSUTL",135,0)
 .....S ^TMP($J,PSSDBASF,"OUT","CHECK",PSSCPCNM,PSSCPC5,PSSCPCAR(PSSCPC5),"MSG",PSSCPCAA)=PSSCPCND,PSSCPCAA=PSSCPCAA+1,PSSCPCAR(PSSCPC5)=PSSCPCAR(PSSCPC5)+1
"RTN","PSSDSUTL",136,0)
 .I $P(PSSDBCAR(PSSCPC5),"^",29) D CFREQ
"RTN","PSSDSUTL",137,0)
 K ^TMP($J,PSSCPCGL)
"RTN","PSSDSUTL",138,0)
 Q
"RTN","PSSDSUTL",139,0)
 ;
"RTN","PSSDSUTL",140,0)
 ;
"RTN","PSSDSUTL",141,0)
CFREQ ;Add customized Frequency
"RTN","PSSDSUTL",142,0)
 I $P(PSSDBCAR(PSSCPC5),"^",15)!($P(PSSDBCAR(PSSCPC5),"^",16))!($P(PSSCPC5,";",5)) Q
"RTN","PSSDSUTL",143,0)
 S ^TMP($J,PSSDBASF,"OUT","CHECK",PSSCPCNM,PSSCPC5,PSSCPCAR(PSSCPC5),"ATYPE")="DOSE^INFORMATIONAL"
"RTN","PSSDSUTL",144,0)
 S ^TMP($J,PSSDBASF,"OUT","CHECK",PSSCPCNM,PSSCPC5,PSSCPCAR(PSSCPC5),"MSG",1)=$G(^TMP($J,PSSDBASE,"OUT","DOSE",PSSCPC5,$P(PSSDBCAR(PSSCPC5),"^",2),"FREQ","FREQUENCYCUSTOMMESSAGE",$P(PSSDBCAR(PSSCPC5),"^",3)))
"RTN","PSSDSUTL",145,0)
 Q
"RTN","PSSDSUTL",146,0)
 ;
"RTN","PSSDSUTL",147,0)
 ;
"RTN","PSSDSUTL",148,0)
PEROR ;Per Orifice check
"RTN","PSSDSUTL",149,0)
 N PSSCPCO9
"RTN","PSSDSUTL",150,0)
 S PSSCPCO9=$P(PSSDBCAR(PSSCPC5),"^",9) I PSSCPCO9="OTIC"!(PSSCPCO9="OPHTHALMIC")!(PSSCPCO9="INTRANASAL") D
"RTN","PSSDSUTL",151,0)
 .S PSSCPCO2="Dosing Information provided is PER "_$S(PSSCPCO9="OTIC":"EAR:",PSSCPCO9="OPHTHALMIC":"EYE:",1:"NOSTRIL:"),PSSCPCO3=1
"RTN","PSSDSUTL",152,0)
 Q
"RTN","PSSDSUTL",153,0)
 ;
"RTN","PSSDSUTL",154,0)
 ;
"RTN","PSSDSUTL",155,0)
SADJ ;Parse out Adjusted Frequency message
"RTN","PSSDSUTL",156,0)
 N PSSSDADJ
"RTN","PSSDSUTL",157,0)
 S PSSCPCAC=1
"RTN","PSSDSUTL",158,0)
 S PSSSDADJ=$F(PSSDBADJ(PSSCPC5),"(") I 'PSSSDADJ S PSSCPCAJ(PSSCPC5)=" "_PSSDBADJ(PSSCPC5) Q
"RTN","PSSDSUTL",159,0)
 S PSSCPCAJ(PSSCPC5)=" "_$E(PSSDBADJ(PSSCPC5),(PSSSDADJ-1),$L(PSSDBADJ(PSSCPC5))-1)
"RTN","PSSDSUTL",160,0)
 Q
"RTN","PSSDSUTL",161,0)
 ;
"RTN","PSSDSUTL",162,0)
 ;
"RTN","PSSDSUTL",163,0)
PTH ;Local Dosage with parenthesis, extract data from before and within
"RTN","PSSDSUTL",164,0)
 N PSSPTH1,PSSPTH2,PSSPTH3,PSSPTH4,PSSPTHL,PSSPTHA,PSSPTHC,PSSPTHF,PSSPTHD,PSSPTHS1,PSSPTHS2,PSSPTHS3,PSSPTHS4
"RTN","PSSDSUTL",165,0)
 K PSSDSLC1 S (PSSPTH1,PSSPTH2,PSSPTH3,PSSPTH4,PSSPTHF)=0,PSSPTHD=PSSDSLCL
"RTN","PSSDSUTL",166,0)
 S PSSPTHL=$L(PSSPTHD)
"RTN","PSSDSUTL",167,0)
 F PSSPTHA=1:1:PSSPTHL Q:PSSPTHF  S PSSPTHC=$E(PSSPTHD,PSSPTHA) D
"RTN","PSSDSUTL",168,0)
 .I PSSPTHC'="(",PSSPTHC'=")" Q
"RTN","PSSDSUTL",169,0)
 .I PSSPTHC="(" S PSSPTH1=PSSPTHA,PSSPTH3=PSSPTH3+1 S:PSSPTH3>1 PSSPTHF=1 Q
"RTN","PSSDSUTL",170,0)
 .S PSSPTH2=PSSPTHA,PSSPTH4=PSSPTH4+1 S:PSSPTH4>1 PSSPTHF=1 Q
"RTN","PSSDSUTL",171,0)
 Q:PSSPTHF  ;Quit if more than 1 of either parenthesis
"RTN","PSSDSUTL",172,0)
 Q:'PSSPTH3!('PSSPTH4)  ;Quit if either parenthesis is missing
"RTN","PSSDSUTL",173,0)
 Q:PSSPTH1'<PSSPTH2  ;Quit if left paren is not before right paren
"RTN","PSSDSUTL",174,0)
 I PSSPTH1>1 S PSSPTHS1="" D  I PSSPTHS1'="" S PSSDSLC1(2)=PSSPTHS1,PSSDSLCT=2
"RTN","PSSDSUTL",175,0)
 .S PSSPTHS1=$E(PSSPTHD,1,(PSSPTH1-1)),PSSPTHS2=$L(PSSPTHS1),PSSPTHS4=0
"RTN","PSSDSUTL",176,0)
 .F PSSPTHS3=PSSPTHS2:-1:1 I $E(PSSPTHS1,PSSPTHS3)'=" " S PSSPTHS4=PSSPTHS3 Q
"RTN","PSSDSUTL",177,0)
 .Q:PSSPTHS4=PSSPTHS2
"RTN","PSSDSUTL",178,0)
 .I 'PSSPTHS4 S PSSPTHS1="" Q
"RTN","PSSDSUTL",179,0)
 .S PSSPTHS1=$E(PSSPTHS1,1,PSSPTHS4)
"RTN","PSSDSUTL",180,0)
 I (PSSPTH1+1)'<PSSPTH2 D:PSSDSLCT  Q
"RTN","PSSDSUTL",181,0)
 .S PSSDSLC1(1)=PSSDSLC1(2),PSSDSLCT=1 K PSSDSLC1(2)
"RTN","PSSDSUTL",182,0)
 S PSSDSLC1(1)=$E(PSSPTHD,(PSSPTH1+1),(PSSPTH2-1)) I 'PSSDSLCT S PSSDSLCT=1
"RTN","PSSDSUTL",183,0)
 Q
"RTN","PSSDSUTL",184,0)
 ;
"RTN","PSSDSUTL",185,0)
 ;
"RTN","PSSDSUTL",186,0)
RTEXT(PSSBAMRT,PSSBSPC) ;Set Reason Header
"RTN","PSSDSUTL",187,0)
 N PSSBSPCS S PSSBSPCS=$S(PSSBSPC:"  ",1:"")
"RTN","PSSDSUTL",188,0)
 S PSSDWRSN=$S('$P(PSSDBCAR(PSSBAMRT),"^",31):PSSBSPCS_"Reason(s): ",1:PSSBSPCS_"Reason(s)"_$P(PSSDBCAR(PSSBAMRT),"^",32))
"RTN","PSSDSUTL",189,0)
 Q
"RTN","PSSDSUTL",190,0)
 ;
"RTN","PSSDSUTL",191,0)
 ;
"RTN","PSSDSUTL",192,0)
ORDFREQ(PSSDADF) ; -- in 2.1 get order frequency by converting FDB frequency patterns -- called from PSSHRQ23
"RTN","PSSDSUTL",193,0)
 ;PSSDADF - Frequency # or Pattern
"RTN","PSSDSUTL",194,0)
 ;
"RTN","PSSDSUTL",195,0)
 ;Return: Order Frequency or 0
"RTN","PSSDSUTL",196,0)
 ;
"RTN","PSSDSUTL",197,0)
 N PSSDADL,PSSDADN,PSSDADTM,PSSDADS
"RTN","PSSDSUTL",198,0)
 ; -- check for missing variable, exit if not defined
"RTN","PSSDSUTL",199,0)
 I $G(PSSDADF)']"" Q 0
"RTN","PSSDSUTL",200,0)
 ; -- check for number
"RTN","PSSDSUTL",201,0)
 I $G(PSSDADF) Q $G(PSSDADF)
"RTN","PSSDSUTL",202,0)
 ; -- every other day
"RTN","PSSDSUTL",203,0)
 I PSSDADF="QOD" Q .5
"RTN","PSSDSUTL",204,0)
 ; -- set PSSDADL=Frequency Length, exit if not equal to 3 or 4
"RTN","PSSDSUTL",205,0)
 S PSSDADL=$L(PSSDADF) I PSSDADL'=3,PSSDADL'=4 Q 0
"RTN","PSSDSUTL",206,0)
 ; -- set PSSDADS=Action associated with frequency Q=every, X=times
"RTN","PSSDSUTL",207,0)
 S PSSDADS=$E(PSSDADF)
"RTN","PSSDSUTL",208,0)
 ; -- check action associated with frequency, exit if not "Q" or "X"
"RTN","PSSDSUTL",209,0)
 I PSSDADS'="Q",PSSDADS'="X" Q 0
"RTN","PSSDSUTL",210,0)
 ; -- set PSSDADN=Frequency Number
"RTN","PSSDSUTL",211,0)
 S PSSDADN=$E(PSSDADF,2,$L(PSSDADF)-1)
"RTN","PSSDSUTL",212,0)
 ; -- check if PSSDADN is numeric, exit if it is not
"RTN","PSSDSUTL",213,0)
 I PSSDADN'?.N Q 0
"RTN","PSSDSUTL",214,0)
 ; -- set PSSDADTM=period of time associated with frequency H=hour, D=day, W=week, L=month
"RTN","PSSDSUTL",215,0)
 S PSSDADTM=$E(PSSDADF,PSSDADL)
"RTN","PSSDSUTL",216,0)
 ; -- calculate order frequency every # hour(s)
"RTN","PSSDSUTL",217,0)
 I PSSDADS="Q",PSSDADTM="H" Q 24/PSSDADN
"RTN","PSSDSUTL",218,0)
 ; -- calculate order frequency every # days(s)
"RTN","PSSDSUTL",219,0)
 I PSSDADS="Q",PSSDADTM="D" Q 1/PSSDADN
"RTN","PSSDSUTL",220,0)
 ; -- calculate order frequency every # week(s)
"RTN","PSSDSUTL",221,0)
 I PSSDADS="Q",PSSDADTM="W" Q 1/(PSSDADN*7)
"RTN","PSSDSUTL",222,0)
 ; -- calculate order frequency every # month(s)
"RTN","PSSDSUTL",223,0)
 I PSSDADS="Q",PSSDADTM="L" Q 1/(PSSDADN*30)
"RTN","PSSDSUTL",224,0)
 ; -- calculate order frequency # times per day
"RTN","PSSDSUTL",225,0)
 I PSSDADS="X",PSSDADTM="D" Q PSSDADN
"RTN","PSSDSUTL",226,0)
 ; -- calculate order frequency # times per week
"RTN","PSSDSUTL",227,0)
 I PSSDADS="X",PSSDADTM="W" Q PSSDADN/7
"RTN","PSSDSUTL",228,0)
 ; -- calculate order frequency # times per month
"RTN","PSSDSUTL",229,0)
 I PSSDADS="X",PSSDADTM="L" Q PSSDADN/30
"RTN","PSSDSUTL",230,0)
 Q 0
"RTN","PSSDSUTL",231,0)
 ;
"RTN","PSSDSUTL",232,0)
 ;
"RTN","PSSDSUTL",233,0)
ROUNDNUM(X) ; -- in 2.1 if number is < or = 1, round to 4 decimals otherwise no decimals -- called from PSSHRQ23 
"RTN","PSSDSUTL",234,0)
 ;X - Number
"RTN","PSSDSUTL",235,0)
 ;
"RTN","PSSDSUTL",236,0)
 ;Return: Rounded Number or 0
"RTN","PSSDSUTL",237,0)
 N N,ND
"RTN","PSSDSUTL",238,0)
 ; -- check for missing variable, exit if not defined
"RTN","PSSDSUTL",239,0)
 I $G(X)'>0 Q 0
"RTN","PSSDSUTL",240,0)
 ; -- get number of decimals
"RTN","PSSDSUTL",241,0)
 S ND=$L($P(+X,".",2))
"RTN","PSSDSUTL",242,0)
 ; -- set number Of decimals
"RTN","PSSDSUTL",243,0)
 S N=$S(+X>1:0,1:4)
"RTN","PSSDSUTL",244,0)
 ; -- if number is zero, round up until number is nolonger zero 
"RTN","PSSDSUTL",245,0)
 I $J(+X,"",N)'>0 D
"RTN","PSSDSUTL",246,0)
 . F N=1:1:ND Q:$J(X,"",N)>0
"RTN","PSSDSUTL",247,0)
 Q +$J(X,"",N)
"RTN","PSSDSUTL",248,0)
 ;
"RTN","PSSDSUTL",249,0)
 ;
"RTN","PSSDSUTL",250,0)
PRNSCHD(PSSSCHD) ;If 'PRN' appended to the schedule, return the schedule with 'PRN' remove
"RTN","PSSDSUTL",251,0)
 NEW PSSXL,PSSXSCHD,PSSXSCHN
"RTN","PSSDSUTL",252,0)
 I $G(PSSSCHD)="" Q ""
"RTN","PSSDSUTL",253,0)
 I $D(^PS(51.1,"APPSJ",PSSSCHD)) Q PSSSCHD
"RTN","PSSDSUTL",254,0)
 S PSSXL=$L(PSSSCHD)
"RTN","PSSDSUTL",255,0)
 I $E(PSSSCHD,(PSSXL-2),PSSXL)="PRN" D  ;Check name cross-index
"RTN","PSSDSUTL",256,0)
 . S PSSXSCHD=$E(PSSSCHD,1,(PSSXL-4))
"RTN","PSSDSUTL",257,0)
 . I (PSSXSCHD'=""),(PSSXSCHD'?." ") S:$D(^PS(51.1,"APPSJ",PSSXSCHD)) PSSSCHD=PSSXSCHD
"RTN","PSSDSUTL",258,0)
 I $E(PSSSCHD,(PSSXL-2),PSSXL)="PRN" D  ;Check Old Schedule Name(s) cross-index PSS*1*231
"RTN","PSSDSUTL",259,0)
 . S PSSXSCHD=$E(PSSSCHD,1,(PSSXL-4))
"RTN","PSSDSUTL",260,0)
 . I (PSSXSCHD'=""),(PSSXSCHD'?." "),$D(^PS(51.1,"D",PSSXSCHD)) S PSSXSCHN=$O(^PS(51.1,"D",PSSXSCHD,0)),PSSSCHD=$P($G(^PS(51.1,PSSXSCHN,0)),U,1)
"RTN","PSSDSUTL",261,0)
 Q PSSSCHD
"RTN","PSSDSUTL",262,0)
 ;
"RTN","PSSDSUTL",263,0)
 ;
"RTN","PSSDSUTL",264,0)
PRNMI(PSSMI) ;If 'PRN' appended to the Med instruction, return the MI with 'PRN' remove
"RTN","PSSDSUTL",265,0)
 NEW PSSXL,PSSXMI
"RTN","PSSDSUTL",266,0)
 I $G(PSSMI)="" Q ""
"RTN","PSSDSUTL",267,0)
 I $D(^PS(51,"B",PSSMI)) Q PSSMI
"RTN","PSSDSUTL",268,0)
 S PSSXL=$L(PSSMI)
"RTN","PSSDSUTL",269,0)
 I $E(PSSMI,(PSSXL-2),PSSXL)="PRN" D
"RTN","PSSDSUTL",270,0)
 . S PSSXMI=$E(PSSMI,1,(PSSXL-4))
"RTN","PSSDSUTL",271,0)
 . I (PSSXMI'=""),(PSSXMI'?." ") S:$D(^PS(51,"B",PSSXMI)) PSSMI=PSSXMI
"RTN","PSSDSUTL",272,0)
 Q PSSMI
"RTN","PSSSCHMS")
0^3^B128463744^B127350691
"RTN","PSSSCHMS",1,0)
PSSSCHMS ;BIR/MV-Frequency utilities routine ;09/13/10
"RTN","PSSSCHMS",2,0)
 ;;1.0;PHARMACY DATA MANAGEMENT;**178,206,231**;9/30/97;Build 4
"RTN","PSSSCHMS",3,0)
 ;;Reference to INP^VADPT supported by DBIA #10061
"RTN","PSSSCHMS",4,0)
 ;
"RTN","PSSSCHMS",5,0)
OLDSCH(PSSFWSCC) ;Get IEN for .01 of the schedule file from the Old Schedule name
"RTN","PSSSCHMS",6,0)
 ;Input:
"RTN","PSSSCHMS",7,0)
 ; PSSFWSC - Schedule name from the order
"RTN","PSSSCHMS",8,0)
 ;Output:
"RTN","PSSSCHMS",9,0)
 ; Schedule Name(.01)^51.1 IEN(if old schedule found) 
"RTN","PSSSCHMS",10,0)
 ;
"RTN","PSSSCHMS",11,0)
 NEW PSSOLDNM,PSSSCH,PSSIEN,PSSOSN
"RTN","PSSSCHMS",12,0)
 I $G(PSSFWSCC)="" Q ""
"RTN","PSSSCHMS",13,0)
 ; Skip looking for the old schedule name if there is an exact matched for the original schedule
"RTN","PSSSCHMS",14,0)
 I $O(^PS(51.1,"APPSJ",PSSFWSCC,0)) Q PSSFWSCC
"RTN","PSSSCHMS",15,0)
 S PSSOLDNM=PSSFWSCC
"RTN","PSSSCHMS",16,0)
 S PSSIEN=+$O(^PS(51.1,"D",PSSOLDNM,0))
"RTN","PSSSCHMS",17,0)
 ; If there is an exact matched to the old schedule name then use it. Otherwise retain the original schedule
"RTN","PSSSCHMS",18,0)
 I 'PSSIEN Q PSSFWSCC
"RTN","PSSSCHMS",19,0)
 S PSSSCH=$G(^PS(51.1,PSSIEN,0))
"RTN","PSSSCHMS",20,0)
 I $P(PSSSCH,U)]"",($P(PSSSCH,U,4)="PSJ") S PSSFWSCC=$P(PSSSCH,U),PSSOSN=+PSSIEN
"RTN","PSSSCHMS",21,0)
 Q PSSFWSCC_U_$G(PSSOSN)
"RTN","PSSSCHMS",22,0)
 ;
"RTN","PSSSCHMS",23,0)
OLD51(PSSFWSCC) ;Get IEN for .01 of the Med Instruction file from the Old Med Instruction name
"RTN","PSSSCHMS",24,0)
 ;Input:
"RTN","PSSSCHMS",25,0)
 ; PSSFWSC - Schedule name from the order
"RTN","PSSSCHMS",26,0)
 ;Output:
"RTN","PSSSCHMS",27,0)
 ; Med instruction name(.01)^51 IEN(If old med Instruction found)
"RTN","PSSSCHMS",28,0)
 ;
"RTN","PSSSCHMS",29,0)
 NEW PSSOLDNM,PSSSCH,PSSIEN,PSSOMEDN
"RTN","PSSSCHMS",30,0)
 I $G(PSSFWSCC)="" Q ""
"RTN","PSSSCHMS",31,0)
 I $O(^PS(51,"B",PSSFWSCC,0)) Q PSSFWSCC
"RTN","PSSSCHMS",32,0)
 S PSSOLDNM=PSSFWSCC
"RTN","PSSSCHMS",33,0)
 S PSSIEN=+$O(^PS(51,"D",PSSOLDNM,0))
"RTN","PSSSCHMS",34,0)
 I 'PSSIEN Q PSSFWSCC
"RTN","PSSSCHMS",35,0)
 S PSSSCH=$P($G(^PS(51,PSSIEN,0)),U)
"RTN","PSSSCHMS",36,0)
 S:PSSSCH]"" PSSFWSCC=PSSSCH,PSSOMEDN=+PSSIEN
"RTN","PSSSCHMS",37,0)
 Q PSSFWSCC_U_$G(PSSOMEDN)
"RTN","PSSSCHMS",38,0)
 ;
"RTN","PSSSCHMS",39,0)
DCFSCH(PSSIEN,PSSDDIEN,PSSFWDRL) ;Dosing Check Frequency process for 51.1
"RTN","PSSSCHMS",40,0)
 ;Input:
"RTN","PSSSCHMS",41,0)
 ; PSSIEN - IEN from 51.1
"RTN","PSSSCHMS",42,0)
 ; PSSDDIEN - IEN from file 50
"RTN","PSSSCHMS",43,0)
 ; PSSFWDRL - The order duration
"RTN","PSSSCHMS",44,0)
 ;Output:
"RTN","PSSSCHMS",45,0)
 ; PSSDCF - P1(adjust if order duration is passed in)^P2(#51.1 - 0;11)
"RTN","PSSSCHMS",46,0)
 ;
"RTN","PSSSCHMS",47,0)
 Q:'+$G(PSSIEN) ""
"RTN","PSSSCHMS",48,0)
 NEW PSSDCF,PSSDCFLG,PSSDCF1,PSSFRQF,PSSNODD
"RTN","PSSSCHMS",49,0)
 S PSSDCFLG=0
"RTN","PSSSCHMS",50,0)
 S PSSDCF=$P($G(^PS(51.1,+PSSIEN,0)),U,11)
"RTN","PSSSCHMS",51,0)
 Q:PSSDCF="" ""
"RTN","PSSSCHMS",52,0)
 ; If no dispense drug is defined in 51.1 then return DCF if available
"RTN","PSSSCHMS",53,0)
 I '$O(^PS(51.1,+PSSIEN,4,0)) S PSSDCFLG=1
"RTN","PSSSCHMS",54,0)
 I $G(PSSDBIFL) D  Q:+PSSNODD ""
"RTN","PSSSCHMS",55,0)
 .S PSSNODD=$$NOTALLDD(+$G(PSSDBFDB("OI")),PSSIEN)
"RTN","PSSSCHMS",56,0)
 .S:'+PSSNODD PSSDDIEN=$P(PSSNODD,U,2)
"RTN","PSSSCHMS",57,0)
 ; If the dispense drug is defined, then verify if PSSDDIEN existed
"RTN","PSSSCHMS",58,0)
 I 'PSSDCFLG,+$G(PSSDDIEN),$D(^PS(51.1,+PSSIEN,4,"B",+PSSDDIEN)) S PSSDCFLG=1
"RTN","PSSSCHMS",59,0)
 I 'PSSDCFLG Q ""
"RTN","PSSSCHMS",60,0)
 I $G(PSSFWDRL)]"" S PSSFRQF=$P($G(^PS(51.1,PSSIEN,0)),"^",3),PSSDCF1=$$DCFSCHD(PSSIEN,PSSFWDRL,PSSDCF,PSSFRQF) Q $S($G(PSSDCF1)]"":PSSDCF1,1:"")_U_PSSDCF
"RTN","PSSSCHMS",61,0)
 Q $S($G(PSSDCF1)]"":PSSDCF1,1:PSSDCF)_U_PSSDCF
"RTN","PSSSCHMS",62,0)
 ;
"RTN","PSSSCHMS",63,0)
DCFSCHD(PSSIEN,PSSFWDRL,PSSDCF,PSSFRQF) ;Adjusting the frequency based on the order duration
"RTN","PSSSCHMS",64,0)
 ;PSSDRL - The order duration (in minute)
"RTN","PSSSCHMS",65,0)
 ;PSSFRQF - Frequency value from 51 or 51.1
"RTN","PSSSCHMS",66,0)
 ;Return the adjusted frequency
"RTN","PSSSCHMS",67,0)
 ;Note - the frequency is rounded up when needed. (ex: Q4H for 6 hours (order duration), the frequency = 2; 
"RTN","PSSSCHMS",68,0)
 ; the reason is that the pt received dose 1 in the first hour and 2nd dose 4 hours later.
"RTN","PSSSCHMS",69,0)
 NEW PSSDRL,PSSFRQ,PSSDCFN,PSSDCFD,PSSDCF1
"RTN","PSSSCHMS",70,0)
 Q:$G(PSSDCF)="" ""
"RTN","PSSSCHMS",71,0)
 Q:$G(PSSFWDRL)="" ""
"RTN","PSSSCHMS",72,0)
 S PSSDRL=$$DRT^PSSDSAPD(PSSFWDRL)
"RTN","PSSSCHMS",73,0)
 I PSSDRL'<1440 Q ""
"RTN","PSSSCHMS",74,0)
 S PSSDCF1=""
"RTN","PSSSCHMS",75,0)
 ; Adjust frequency for Q#H
"RTN","PSSSCHMS",76,0)
 I PSSDCF?1"Q"1N.N1"H" D  Q PSSDCF1
"RTN","PSSSCHMS",77,0)
 . S PSSDCFN=+$E(PSSDCF,2,$L(PSSDCF))*60
"RTN","PSSSCHMS",78,0)
 . S PSSDCFD=PSSDRL/PSSDCFN
"RTN","PSSSCHMS",79,0)
 . I PSSDCFD<1 S PSSDCF1="" Q
"RTN","PSSSCHMS",80,0)
 . S PSSDCF1=$S((PSSDCFD?.N):PSSDCFD,1:$J((PSSDCFD+.5),0,0))
"RTN","PSSSCHMS",81,0)
 ; Adjust frequency for X#D (# per day)
"RTN","PSSSCHMS",82,0)
 I +$G(PSSFRQF),(PSSDCF?1"X"1N.N1"D") D  Q PSSDCF1
"RTN","PSSSCHMS",83,0)
 . I '+$G(PSSIEN) S PSSDCF1="" Q
"RTN","PSSSCHMS",84,0)
 . S PSSFRQ=PSSDRL/PSSFRQF
"RTN","PSSSCHMS",85,0)
 . S PSSFRQ=$S((PSSFRQ?.N):PSSFRQ,1:$J((PSSFRQ+.5),0,0))
"RTN","PSSSCHMS",86,0)
 . S (PSSDCFN,PSSDCF1)=+$E(PSSDCF,2,$L(PSSDCF))
"RTN","PSSSCHMS",87,0)
 . I PSSDCFN>PSSFRQ S PSSDCF1=PSSFRQ
"RTN","PSSSCHMS",88,0)
 Q $G(PSSDCF1)
"RTN","PSSSCHMS",89,0)
 ;
"RTN","PSSSCHMS",90,0)
DCF51(PSSIEN,PSSDDIEN,PSSFWDRL) ;Dosing Check Frequency process for Med Instruction file
"RTN","PSSSCHMS",91,0)
 ;Input:
"RTN","PSSSCHMS",92,0)
 ; PSSIEN - IEN from 51
"RTN","PSSSCHMS",93,0)
 ; PSSDDIEN - IEN from file 50
"RTN","PSSSCHMS",94,0)
 ; PSSFWDRL - Order duration
"RTN","PSSSCHMS",95,0)
 ;Output:
"RTN","PSSSCHMS",96,0)
 ; PSSDCF - P1(adjust if order duration is passed in)^P2(#51 - 0;9)
"RTN","PSSSCHMS",97,0)
 ;
"RTN","PSSSCHMS",98,0)
 Q:'+$G(PSSIEN) ""
"RTN","PSSSCHMS",99,0)
 NEW PSSDCF,PSSDCFLG,PSSDCF1,PSSFRQF
"RTN","PSSSCHMS",100,0)
 S PSSDCFLG=0
"RTN","PSSSCHMS",101,0)
 S PSSDCF=$P($G(^PS(51,+PSSIEN,0)),U,9)
"RTN","PSSSCHMS",102,0)
 Q:PSSDCF="" ""
"RTN","PSSSCHMS",103,0)
 ; check if the dispense drug is specified in 51
"RTN","PSSSCHMS",104,0)
 I '$O(^PS(51,+PSSIEN,5,0)) S PSSDCFLG=1
"RTN","PSSSCHMS",105,0)
 I 'PSSDCFLG,+$G(PSSDDIEN),$D(^PS(51,+PSSIEN,5,"B",+PSSDDIEN)) S PSSDCFLG=1
"RTN","PSSSCHMS",106,0)
 I 'PSSDCFLG Q ""
"RTN","PSSSCHMS",107,0)
 I $G(PSSFWDRL)]"" S PSSFRQF=$P($G(^PS(51,PSSIEN,0)),U,8),PSSDCF1=$$DCFSCHD(PSSIEN,PSSFWDRL,PSSDCF,PSSFRQF)
"RTN","PSSSCHMS",108,0)
 Q $S($G(PSSDCF1)]"":PSSDCF1,1:PSSDCF)_U_PSSDCF
"RTN","PSSSCHMS",109,0)
 ;
"RTN","PSSSCHMS",110,0)
MULTSCH(PSSMSCH,PSSFWFR,PSSFWPK,PSSFWDRL) ;Return Frequency for PSSMSCHD with multi schedules
"RTN","PSSSCHMS",111,0)
 ;Piece out each word (schedule) in PSSMSCH
"RTN","PSSSCHMS",112,0)
 ;PSSMSCH - Multi-schedules
"RTN","PSSSCHMS",113,0)
 ;PSSFWSCC - Single schedule (pieced out)
"RTN","PSSSCHMS",114,0)
 ;PSSFRQ - Return 2 pieces - p1 = adjusted frequency (duration); p2 = the frequency
"RTN","PSSSCHMS",115,0)
 ;It is necessary to set PSSDBAR("TYPE")="SINGLE DOSE" when the schedule is determined for "Once" or "ONCALL".
"RTN","PSSSCHMS",116,0)
 ;PSSDBAR array came from DOSE^PSSDSAPD
"RTN","PSSSCHMS",117,0)
 NEW PSSFRQ,PSSFWSCC,PSSDOW,PSSDOWAT,PSSONCE,PSSODRL,PSSOSCH,PSSOUT1,PSSOUTD,PSSOUTX,PSSP1,PSSX
"RTN","PSSSCHMS",118,0)
 S PSSFRQ="^",PSSONCE=0,PSSDOW=0,PSSODRL=$G(PSSFWDRL),PSSOSCH=""
"RTN","PSSSCHMS",119,0)
 I $G(PSSMSCH)="" Q "^"
"RTN","PSSSCHMS",120,0)
 F PSSX=1:1:$L(PSSMSCH," ") S PSSFWSCC=$P(PSSMSCH," ",PSSX) D  Q:PSSONCE
"RTN","PSSSCHMS",121,0)
 . I $G(PSSFWSCC)="" S PSSFRQ="^"
"RTN","PSSSCHMS",122,0)
 . S PSSFWSCC=$$ADDAT(PSSFWSCC)
"RTN","PSSSCHMS",123,0)
 . I $$ONETIME(PSSFWSCC) S PSSONCE=1 Q
"RTN","PSSSCHMS",124,0)
 . I PSSFWSCC["@" S PSSFWFR="D",PSSDOW=1
"RTN","PSSSCHMS",125,0)
 . ; $$FRQZ^PSSDSAPI needs PSSFWFR="D" for DOW schedule
"RTN","PSSSCHMS",126,0)
 . S PSSOUT1=$$FRQZ^PSSDSAPI()
"RTN","PSSSCHMS",127,0)
 . ;I PSSFWSCC["@" S PSSDOWAT=PSSOUT1
"RTN","PSSSCHMS",128,0)
 . I PSSFWSCC["@" S:$G(PSSOUT1)]"" PSSOUTD(PSSOUT1,PSSFWSCC)=""
"RTN","PSSSCHMS",129,0)
 . I PSSOUT1]"" S PSSOUTX(PSSOUT1,PSSFWSCC)="" S:PSSOSCH="" PSSOSCH=PSSFWSCC
"RTN","PSSSCHMS",130,0)
 ;
"RTN","PSSSCHMS",131,0)
 I $G(PSSONCE) S PSSDBAR("TYPE")="SINGLE DOSE" Q "1^1"
"RTN","PSSSCHMS",132,0)
 I $D(PSSOUTD) D  Q $S($G(PSSP1)]"":PSSP1_"^"_PSSP1,1:"^")
"RTN","PSSSCHMS",133,0)
 . S PSSP1=$O(PSSOUTD("")) I $O(PSSOUTD(PSSP1))]"" S PSSP1="" Q
"RTN","PSSSCHMS",134,0)
 ; Check if the schedules have the same frequency.
"RTN","PSSSCHMS",135,0)
 S PSSP1=$O(PSSOUTX("")) I $O(PSSOUTX(PSSP1))]"" Q "^"
"RTN","PSSSCHMS",136,0)
 I $G(PSSFWDRL)="" Q PSSP1_U_PSSP1
"RTN","PSSSCHMS",137,0)
 ; Get the frequency for piece 2 without the duration factor in 
"RTN","PSSSCHMS",138,0)
 I $G(PSSP1)]"",($G(PSSFWDRL)]""),($G(PSSOSCH)]"") S PSSFWDRL="",PSSFWSCC=PSSOSCH,PSSFRQ=PSSP1_U_$$FRQZ^PSSDSAPI(),PSSFWDRL=PSSODRL
"RTN","PSSSCHMS",139,0)
 Q PSSFRQ
"RTN","PSSSCHMS",140,0)
ONETIME(PSSSCHD) ;check for one-time, now, oncall schedules
"RTN","PSSSCHMS",141,0)
 ;Return 1 if schedule is one-time, now
"RTN","PSSSCHMS",142,0)
 ; 0 if not
"RTN","PSSSCHMS",143,0)
 NEW PSSX,PSSASIEN,PSSOUT
"RTN","PSSSCHMS",144,0)
 I $G(PSSSCHD)="" Q 0
"RTN","PSSSCHMS",145,0)
 S PSSOUT=0
"RTN","PSSSCHMS",146,0)
 F PSSASIEN=0:0 S PSSASIEN=$O(^PS(51.1,"APPSJ",PSSSCHD,PSSASIEN)) Q:'PSSASIEN  D  Q:PSSOUT
"RTN","PSSSCHMS",147,0)
 . S PSSX=$P($G(^PS(51.1,PSSASIEN,0)),U,5)
"RTN","PSSSCHMS",148,0)
 . S:PSSX="O"!(PSSX="OC") PSSOUT=1
"RTN","PSSSCHMS",149,0)
 Q PSSOUT
"RTN","PSSSCHMS",150,0)
 ;
"RTN","PSSSCHMS",151,0)
DOWAT(PSSFWSCC,PSSDDIEN) ;
"RTN","PSSSCHMS",152,0)
 ;Process day of week with admin times (ex SU-MO@12)
"RTN","PSSSCHMS",153,0)
 NEW PSSIEN,PSSSCH1,PSSSCH2
"RTN","PSSSCHMS",154,0)
 Q:$G(PSSFWSCC)="" ""
"RTN","PSSSCHMS",155,0)
 S PSSSCH1=$P(PSSFWSCC,"@"),PSSSCH2=$P(PSSFWSCC,"@",2)
"RTN","PSSSCHMS",156,0)
 S PSSIEN=$$DOWIEN(PSSFWSCC,PSSSCH1,PSSSCH2)
"RTN","PSSSCHMS",157,0)
 I 'PSSIEN S PSSIEN=$$DOWIEN(PSSSCH1_"@"_PSSSCH2,PSSSCH1,PSSSCH2)
"RTN","PSSSCHMS",158,0)
 I 'PSSIEN S PSSIEN=$$DOWIEN(PSSSCH1_"@"_$$AT(PSSSCH2,2),PSSSCH1,PSSSCH2)
"RTN","PSSSCHMS",159,0)
 I 'PSSIEN S PSSIEN=$$DOWIEN(PSSSCH1_"@"_$$AT(PSSSCH2,4),PSSSCH1,PSSSCH2)
"RTN","PSSSCHMS",160,0)
 I 'PSSIEN S PSSIEN=$$DOWIEN(PSSSCH1,PSSSCH1,PSSSCH2)
"RTN","PSSSCHMS",161,0)
 I 'PSSIEN Q ""
"RTN","PSSSCHMS",162,0)
 ;Get DCF(the order duration is ignored when it's DOW schedule)
"RTN","PSSSCHMS",163,0)
 Q $$DCFSCH(PSSIEN,$G(PSSDDIEN))
"RTN","PSSSCHMS",164,0)
 ;
"RTN","PSSSCHMS",165,0)
DOWIEN(PSSSCH,PSSSCH1,PSSSCH2) ;
"RTN","PSSSCHMS",166,0)
 ;Return 51.1 IEN (if more than one matched, return the DOW, else the first matched)
"RTN","PSSSCHMS",167,0)
 NEW PSSIEN,PSSX,PSSFLG
"RTN","PSSSCHMS",168,0)
 Q:$G(PSSSCH)="" ""
"RTN","PSSSCHMS",169,0)
 S PSSIEN=0,PSSFLG=0
"RTN","PSSSCHMS",170,0)
 F PSSX=0:0 S PSSX=$O(^PS(51.1,"APPSJ",PSSSCH,PSSX)) Q:'PSSX  D  Q:PSSFLG
"RTN","PSSSCHMS",171,0)
 . I '$$SCHAT(PSSX,$G(PSSSCH1),$G(PSSSCH2)) Q
"RTN","PSSSCHMS",172,0)
 . ; store the first IEN found
"RTN","PSSSCHMS",173,0)
 . I 'PSSIEN S PSSIEN=PSSX
"RTN","PSSSCHMS",174,0)
 . I $P($G(^PS(51.1,PSSX,0)),U,5)="D" S PSSIEN=PSSX,PSSFLG=1 Q
"RTN","PSSSCHMS",175,0)
 Q PSSIEN
"RTN","PSSSCHMS",176,0)
 ;
"RTN","PSSSCHMS",177,0)
AT(PSSAT,PSSDIG) ;return admin time(s) in 2 or 4 digits format
"RTN","PSSSCHMS",178,0)
 ;PSSDIG - set admin time to 2 digits or 4 digits format (ex: 09 or 0900)
"RTN","PSSSCHMS",179,0)
 NEW PSSY,PSSX
"RTN","PSSSCHMS",180,0)
 Q:$G(PSSAT)="" ""
"RTN","PSSSCHMS",181,0)
 I '+$G(PSSDIG) S PSSDIG=4
"RTN","PSSSCHMS",182,0)
 S PSSX=""
"RTN","PSSSCHMS",183,0)
 F PSSY=1:1:$L(PSSAT,"-") S PSSX=PSSX_$S(PSSX="":"",1:"-")_$E($P(PSSAT,"-",PSSY)_"0000",1,PSSDIG)
"RTN","PSSSCHMS",184,0)
 Q PSSX
"RTN","PSSSCHMS",185,0)
 ;
"RTN","PSSSCHMS",186,0)
SCHAT(PSSIEN,PSSSCH1,PSSSCH2) ;return PSSIEN from 51.1 for DOW
"RTN","PSSSCHMS",187,0)
 NEW PSSFL1,PSSFL2,PSSAT,PSSIEN0
"RTN","PSSSCHMS",188,0)
 Q:'+$G(PSSIEN) 0
"RTN","PSSSCHMS",189,0)
 S PSSIEN0=$G(^PS(51.1,PSSIEN,0))
"RTN","PSSSCHMS",190,0)
 S PSSAT=$P(PSSIEN0,U,2),(PSSFL1,PSSFL2)=0
"RTN","PSSSCHMS",191,0)
 ; Return IEN if there is no admin time define and schedule matched .01
"RTN","PSSSCHMS",192,0)
 I (PSSAT=""),($G(PSSSCH1)_"@"_$G(PSSSCH2))=$P(PSSIEN0,U) Q PSSIEN
"RTN","PSSSCHMS",193,0)
 I (PSSAT=""),($G(PSSSCH1)_"@"_$$AT($G(PSSSCH2),2))=$P(PSSIEN0,U) Q PSSIEN
"RTN","PSSSCHMS",194,0)
 I (PSSAT=""),($G(PSSSCH1)_"@"_$$AT($G(PSSSCH2),4))=$P(PSSIEN0,U) Q PSSIEN
"RTN","PSSSCHMS",195,0)
 ; If admin is not defined in 51.1 but was entered with order
"RTN","PSSSCHMS",196,0)
 I (PSSAT=""),(PSSSCH2]"") S PSSFL1=1
"RTN","PSSSCHMS",197,0)
 ; There maybe multiple entries with the same DOW. Tried to find the one with the same admin time 
"RTN","PSSSCHMS",198,0)
 ; Check for schedule and admin times from 51.1(in 2 & 4 digit format) matched to the admin time entered for the order
"RTN","PSSSCHMS",199,0)
 I (PSSAT]""),($G(PSSSCH1)_"@"_$$AT(PSSAT,2))'=($G(PSSSCH1)_"@"_$$AT($G(PSSSCH2),2)) S PSSFL1=1
"RTN","PSSSCHMS",200,0)
 I (PSSAT]""),($G(PSSSCH1)_"@"_$$AT(PSSAT,4))'=($G(PSSSCH1)_"@"_$$AT($G(PSSSCH2),4)) S PSSFL1=1
"RTN","PSSSCHMS",201,0)
 ; Only return PSSIEN if the schedule and admin time from 51.1 matched order's Admin time
"RTN","PSSSCHMS",202,0)
 I PSSFL1 S PSSIEN=0
"RTN","PSSSCHMS",203,0)
 Q PSSIEN
"RTN","PSSSCHMS",204,0)
ADDAT(PSSFWSCC) ;concatenate admin times from 51.1 to the schedule name for DOW
"RTN","PSSSCHMS",205,0)
 ;PSSFWSCC - Schedule name
"RTN","PSSSCHMS",206,0)
 NEW PSSASIEN,PSSX,PSSXFG
"RTN","PSSSCHMS",207,0)
 I $G(PSSFWSCC)="" Q ""
"RTN","PSSSCHMS",208,0)
 S PSSXFG=0
"RTN","PSSSCHMS",209,0)
 F PSSASIEN=0:0 S PSSASIEN=$O(^PS(51.1,"APPSJ",PSSFWSCC,PSSASIEN)) Q:'PSSASIEN  D  Q:PSSXFG
"RTN","PSSSCHMS",210,0)
 . I PSSFWSCC["@" S PSSXFG=1 Q
"RTN","PSSSCHMS",211,0)
 . S PSSX=$G(^PS(51.1,PSSASIEN,0))
"RTN","PSSSCHMS",212,0)
 . I $P(PSSX,U,5)'="D" S PSSXFG=1 Q
"RTN","PSSSCHMS",213,0)
 . I $P(PSSX,U,2)]"" S PSSFWSCC=PSSFWSCC_"@"_$P(PSSX,U,2) S PSSXFG=1
"RTN","PSSSCHMS",214,0)
 Q PSSFWSCC
"RTN","PSSSCHMS",215,0)
CONVSCH(PSSFRQ) ;Convert numeric frequency to a schedule
"RTN","PSSSCHMS",216,0)
 ;PSSFRQ - Frequency in minutes
"RTN","PSSSCHMS",217,0)
 ;Return null or Schedule_0/1
"RTN","PSSSCHMS",218,0)
 I '+$G(PSSFRQ) Q ""
"RTN","PSSSCHMS",219,0)
 NEW PSSFWBAM,PSSFWBMN,PSSFWBNM,PSSFWRST,PSSFWBWK,PSSFWBXW,PSSFWBXL,PSSFWFLG
"RTN","PSSSCHMS",220,0)
 S PSSFWFLG=0
"RTN","PSSSCHMS",221,0)
 S PSSFWBAM=PSSFRQ/1440
"RTN","PSSSCHMS",222,0)
 I PSSFWBAM'?.N Q ""
"RTN","PSSSCHMS",223,0)
 I PSSFWBAM?.N D  Q PSSFWRST_U_PSSFWFLG
"RTN","PSSSCHMS",224,0)
 .S PSSFWBMN=PSSFWBAM/30 I PSSFWBMN?.N S PSSFWFLG=1,PSSFWRST="Q"_PSSFWBMN_"L" Q
"RTN","PSSSCHMS",225,0)
 .S PSSFWBWK=PSSFWBAM/7 I PSSFWBWK?.N S PSSFWFLG=1,PSSFWRST="Q"_PSSFWBWK_"W" Q
"RTN","PSSSCHMS",226,0)
 .S PSSFWFLG=1,PSSFWRST="Q"_PSSFWBAM_"D" Q
"RTN","PSSSCHMS",227,0)
 I PSSFRQ'>10080 S PSSFWBXW=10080/PSSFRQ I PSSFWBXW?.N S PSSFWFLG=1,PSSFWRST="X"_PSSFWBXW_"W" Q PSSFWRST_U_PSSFWFLG
"RTN","PSSSCHMS",228,0)
 S PSSFWBXL=43200/PSSFRQ I PSSFWBXL?.N S PSSFWFLG=1,PSSFWRST="X"_PSSFWBXL_"L" Q PSSFWRST_U_PSSFWFLG
"RTN","PSSSCHMS",229,0)
 Q ""
"RTN","PSSSCHMS",230,0)
NOTALLDD(PSSGTOI,PSSIEN) ;When only OI is sent from CPRS, all DDs must be defined in 51.1 in order for the DCF value to be used. 
"RTN","PSSSCHMS",231,0)
 ;PSSNOTDD=1 if not all dispense drugs are defined in in 51.1 and the last good DD
"RTN","PSSSCHMS",232,0)
 ;PSSGOI - Orderable Item
"RTN","PSSSCHMS",233,0)
 ;PSSIEN - 51.1 ien
"RTN","PSSSCHMS",234,0)
 NEW PSSDD,PSSDDIEN,PSSDDACT,PSSNODD
"RTN","PSSSCHMS",235,0)
 Q:'+$G(PSSGTOI) 0
"RTN","PSSSCHMS",236,0)
 Q:'+$G(PSSIEN) 0
"RTN","PSSSCHMS",237,0)
 I '$O(^PS(51.1,+PSSIEN,4,0)) Q 0  ;PSS*1*231 Correct issue with orphan 0 node
"RTN","PSSSCHMS",238,0)
 S PSSNODD=0
"RTN","PSSSCHMS",239,0)
 F PSSDDIEN=0:0 S PSSDDIEN=$O(^PSDRUG("ASP",PSSGTOI,PSSDDIEN)) Q:'PSSDDIEN!PSSNODD  D
"RTN","PSSSCHMS",240,0)
 .I $$EXMT^PSSDSAPI(PSSDDIEN) Q
"RTN","PSSSCHMS",241,0)
 .S PSSDDACT=$P($G(^PSDRUG(PSSDDIEN,"I")),"^") I PSSDDACT,PSSDDACT<DT Q
"RTN","PSSSCHMS",242,0)
 .S PSSDD=PSSDDIEN
"RTN","PSSSCHMS",243,0)
 .I '$D(^PS(51.1,+PSSIEN,4,"B",+PSSDDIEN)) S PSSNODD=1
"RTN","PSSSCHMS",244,0)
 Q PSSNODD_U_$G(PSSDD)
"RTN","PSSSCHMS",245,0)
CHKIPDUR() ;Check if CPRR IP has a duration <24hrs
"RTN","PSSSCHMS",246,0)
 ;*************************************************************************
"RTN","PSSSCHMS",247,0)
 ;*** MOCHA 2.1b - only perform daily dose if it is not a complex order ***
"RTN","PSSSCHMS",248,0)
 ;*************************************************************************
"RTN","PSSSCHMS",249,0)
 ;This is for CPRS IP order
"RTN","PSSSCHMS",250,0)
 ;Check: only one sequence(not complex); EFD (expected first dose); Duration <24h;
"RTN","PSSSCHMS",251,0)
 ;Return: 0 or 1^# of dose(s) for admin times within the duration.
"RTN","PSSSCHMS",252,0)
 NEW PSSDUR,PSSADMIN,PSSDSCNT,PSSX
"RTN","PSSSCHMS",253,0)
 I '$D(PSSDBFDB)!'$D(PSSDBDS) Q 0
"RTN","PSSSCHMS",254,0)
 I $O(PSSDBFDB(1)) Q 0
"RTN","PSSSCHMS",255,0)
 I $G(PSSDBFDB("PACKAGE"))'="I" Q 0
"RTN","PSSSCHMS",256,0)
 I $G(PSSDBDS(1,"EFD"))="" Q 0
"RTN","PSSSCHMS",257,0)
 S PSSX=$G(PSSDBDS(1,"DRATE"))
"RTN","PSSSCHMS",258,0)
 S PSSDUR=$S((PSSX["H"):(+PSSX*60),(PSSX["M"):+PSSX,1:0)
"RTN","PSSSCHMS",259,0)
 I 'PSSDUR Q 0
"RTN","PSSSCHMS",260,0)
 I PSSDUR'<1440 Q 0
"RTN","PSSSCHMS",261,0)
 S PSSADMIN=$$ADMIN($G(PSSDBDFN),$G(PSSDBDS(1,"SCHEDULE")))
"RTN","PSSSCHMS",262,0)
 I PSSADMIN="" Q 0
"RTN","PSSSCHMS",263,0)
 S PSSDSCNT=$$DOSECNT^PSSSCHMS(PSSDBDS(1,"EFD"),PSSADMIN,PSSDUR)
"RTN","PSSSCHMS",264,0)
 Q 1_U_PSSDSCNT
"RTN","PSSSCHMS",265,0)
ADMIN(DFN,PSSSCHD) ;Determine if admin times for the ward should be used
"RTN","PSSSCHMS",266,0)
 NEW VAIN,PSSWARD,PSSIEN,PSSADM,PSSWDADM
"RTN","PSSSCHMS",267,0)
 I $G(PSSSCHD)="" Q ""
"RTN","PSSSCHMS",268,0)
 ;I '+$G(DFN) Q ""
"RTN","PSSSCHMS",269,0)
 D:+$G(DFN) INP^VADPT
"RTN","PSSSCHMS",270,0)
 S PSSWARD=+$G(VAIN(4))
"RTN","PSSSCHMS",271,0)
 S (PSSADM,PSSWDADM)=""
"RTN","PSSSCHMS",272,0)
 F PSSIEN=0:0 S PSSIEN=$O(^PS(51.1,"APPSJ",PSSSCHD,PSSIEN)) Q:(PSSIEN="")!(PSSWDADM]"")  D
"RTN","PSSSCHMS",273,0)
 . S:PSSADM="" PSSADM=$P($G(^PS(51.1,PSSIEN,0)),U,2)
"RTN","PSSSCHMS",274,0)
 . S PSSWDADM=$P($G(^PS(51.1,PSSIEN,1,+PSSWARD,0)),U,2)
"RTN","PSSSCHMS",275,0)
 I PSSWDADM]"" Q PSSWDADM
"RTN","PSSSCHMS",276,0)
 Q PSSADM
"RTN","PSSSCHMS",277,0)
DOSECNT(PSSEFD,PSSAT,PSSDUR) ;count # of dose for duration <24h
"RTN","PSSSCHMS",278,0)
 ;PSSEFD - Expected First Dose (dt.time)^Admin times from CPRS
"RTN","PSSSCHMS",279,0)
 ;PSSDUR - duration in minutes
"RTN","PSSSCHMS",280,0)
 ;Calculate # of doses for CPRS IP order with a duration
"RTN","PSSSCHMS",281,0)
 ;Return p1^p2 (p1=0 unable to figure, 1 use p2 for count; p2=# doses need for this duration)
"RTN","PSSSCHMS",282,0)
 NEW PSSEDT,PSSCNT,PSSSTRTM,PSSSTPTM,PSSDTFLG,PSSADMIN,PSSX
"RTN","PSSSCHMS",283,0)
 Q:$G(PSSEFD)="" 0
"RTN","PSSSCHMS",284,0)
 Q:$G(PSSAT)="" 0
"RTN","PSSSCHMS",285,0)
 Q:'+$G(PSSDUR) 0
"RTN","PSSSCHMS",286,0)
 S PSSEDT=$$FMADD^XLFDT(PSSEFD,,,+PSSDUR)
"RTN","PSSSCHMS",287,0)
 S PSSCNT=0
"RTN","PSSSCHMS",288,0)
 S PSSSTRTM=$E($P(PSSEFD,".",2)_"0000",1,4)
"RTN","PSSSCHMS",289,0)
 S PSSSTPTM=$E($P(PSSEDT,".",2)_"0000",1,4)
"RTN","PSSSCHMS",290,0)
 S PSSDTFLG=0
"RTN","PSSSCHMS",291,0)
 I $P(PSSEFD,".")=$P(PSSEDT,".") S PSSDTFLG=1
"RTN","PSSSCHMS",292,0)
 F PSSX=1:1 S PSSADMIN=$P(PSSAT,"-",PSSX) Q:PSSADMIN=""  D
"RTN","PSSSCHMS",293,0)
 . S PSSADMIN=$E($P(PSSAT,"-",PSSX)_"0000",1,4)
"RTN","PSSSCHMS",294,0)
 . I PSSDTFLG D  Q
"RTN","PSSSCHMS",295,0)
 .. I (PSSSTRTM'>PSSADMIN),(PSSADMIN<PSSSTPTM) S PSSCNT=PSSCNT+1
"RTN","PSSSCHMS",296,0)
 . I (PSSSTRTM'>PSSADMIN) S PSSCNT=PSSCNT+1
"RTN","PSSSCHMS",297,0)
 . I (PSSSTPTM>PSSADMIN) S PSSCNT=PSSCNT+1
"RTN","PSSSCHMS",298,0)
 Q PSSCNT
"RTN","PSSSCHMS",299,0)
SCHD ;^PSSDSAPD is too big - move it here.
"RTN","PSSSCHMS",300,0)
 N PSSDBSCD,PSSDBSCP,PSSDBSCF,PSSDBSCG,PSSDBSCH,PSSDCF
"RTN","PSSSCHMS",301,0)
 S PSSDBAR("FREQ")=""
"RTN","PSSSCHMS",302,0)
 ;I $D(PSSDBFDB(PSSDBLP,"FREQ")) S PSSDBAR("FREQ")=PSSDBFDB(PSSDBLP,"FREQ") Q
"RTN","PSSSCHMS",303,0)
 I PSSDBAR("TYPE")="SINGLE DOSE" S PSSDBAR("FREQ")="" Q
"RTN","PSSSCHMS",304,0)
 ;I $G(PSSDBDS(PSSDBLP,"DRATE"))'="",$$DRT(PSSDBDS(PSSDBLP,"DRATE"))<1440 S PSSDBSDR=1
"RTN","PSSSCHMS",305,0)
 S PSSDBSCD=$G(PSSDBDS(PSSDBLP,"SCHEDULE"))
"RTN","PSSSCHMS",306,0)
 I PSSDBSCD="",'$D(PSSDBFDB(PSSDBLP,"FREQ")) S PSSDBCAZ(PSSDBFDB(PSSDBLP,"RX_NUM"),"FRQ_ERROR")="" Q
"RTN","PSSSCHMS",307,0)
 S (PSSDBSCF,PSSDBSCH)="" S PSSDBSCP=$P(PSSDBFDB(PSSDBLP,"RX_NUM"),";")
"RTN","PSSSCHMS",308,0)
 I $G(PSSDBSCD)'="" F PSSDBSCG=0:0 S PSSDBSCG=$O(^PS(51.1,"APPSJ",PSSDBSCD,PSSDBSCG)) Q:'PSSDBSCG!(PSSDBSCH)  D
"RTN","PSSSCHMS",309,0)
 .I $P($G(^PS(51.1,PSSDBSCG,0)),"^",5)="D" S PSSDBSCF="D"
"RTN","PSSSCHMS",310,0)
 .I $P($G(^PS(51.1,PSSDBSCG,0)),"^",5)="O"!($P($G(^PS(51.1,PSSDBSCG,0)),"^",5)="OC") S PSSDBSCH=1
"RTN","PSSSCHMS",311,0)
 I PSSDBSCH,'$D(PSSDBFDB(PSSDBLP,"FREQ")) S PSSDBAR("FREQ")=1 Q
"RTN","PSSSCHMS",312,0)
 I $G(PSSDBSCD)["@" S PSSDBSCF="D"
"RTN","PSSSCHMS",313,0)
 I $G(PSSDBSCD)'="" D
"RTN","PSSSCHMS",314,0)
 . S PSSDBSCP=$S(PSSDBSCP="I":"I",1:"O")
"RTN","PSSSCHMS",315,0)
 . S PSSDBAR("FREQZZ")=$$FRQ^PSSDSAPI(PSSDBSCD,PSSDBSCF,PSSDBSCP,$G(PSSDBDS(PSSDBLP,"DRATE")),$G(PSSDBFDB(PSSDBLP,"DRUG_IEN")))
"RTN","PSSSCHMS",316,0)
 . S PSSDCF=$P(PSSDBAR("FREQZZ"),U,2)
"RTN","PSSSCHMS",317,0)
 . I PSSDCF?1"X"1N.N1"D" S PSSDBAR("FREQZZ")=PSSDCF_U_PSSDCF,PSSDBFDB(PSSDBLP,"FREQ")=PSSDCF
"RTN","PSSSCHMS",318,0)
 . S PSSDBAR("FREQ")=$P(PSSDBAR("FREQZZ"),"^")
"RTN","PSSSCHMS",319,0)
 I $D(PSSDBFDB(PSSDBLP,"FREQ")) S PSSDBAR("FREQ")=PSSDBFDB(PSSDBLP,"FREQ") Q
"RTN","PSSSCHMS",320,0)
 S:PSSDBAR("FREQ")="" PSSDBCAZ(PSSDBFDB(PSSDBLP,"RX_NUM"),"FRQ_ERROR")=""
"RTN","PSSSCHMS",321,0)
 Q
"VER")
8.0^22.2
"BLD",11216,6)
^202
**END**
**END**

