KIDS Distribution saved on Nov 05, 2012@14:34:22
Sync software
**KIDS**:PPSNS*1.1*12^

**INSTALL NAME**
PPSNS*1.1*12
"BLD",1452,0)
PPSNS*1.1*12^^0^3121105^n
"BLD",1452,1,0)
^^1^1^3121105^^^^
"BLD",1452,1,1,0)
16th delivery of sync software. 
"BLD",1452,4,0)
^9.64PA^^
"BLD",1452,6.3)
39
"BLD",1452,"KRN",0)
^9.67PA^9002226^21
"BLD",1452,"KRN",.4,0)
.4
"BLD",1452,"KRN",.401,0)
.401
"BLD",1452,"KRN",.402,0)
.402
"BLD",1452,"KRN",.403,0)
.403
"BLD",1452,"KRN",.5,0)
.5
"BLD",1452,"KRN",.84,0)
.84
"BLD",1452,"KRN",3.6,0)
3.6
"BLD",1452,"KRN",3.8,0)
3.8
"BLD",1452,"KRN",9.2,0)
9.2
"BLD",1452,"KRN",9.8,0)
9.8
"BLD",1452,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",1452,"KRN",9.8,"NM",1,0)
PSSMIGRC^^0^B133790113
"BLD",1452,"KRN",9.8,"NM",2,0)
PSSMIGRD^^0^B215666817
"BLD",1452,"KRN",9.8,"NM",3,0)
PSSMIGRE^^0^B170727260
"BLD",1452,"KRN",9.8,"NM",4,0)
PSSMIGRP^^0^B79156432
"BLD",1452,"KRN",9.8,"NM",5,0)
PSSMIGRR^^0^B104608215
"BLD",1452,"KRN",9.8,"NM","B","PSSMIGRC",1)

"BLD",1452,"KRN",9.8,"NM","B","PSSMIGRD",2)

"BLD",1452,"KRN",9.8,"NM","B","PSSMIGRE",3)

"BLD",1452,"KRN",9.8,"NM","B","PSSMIGRP",4)

"BLD",1452,"KRN",9.8,"NM","B","PSSMIGRR",5)

"BLD",1452,"KRN",19,0)
19
"BLD",1452,"KRN",19,"NM",0)
^9.68A^^
"BLD",1452,"KRN",19.1,0)
19.1
"BLD",1452,"KRN",101,0)
101
"BLD",1452,"KRN",409.61,0)
409.61
"BLD",1452,"KRN",771,0)
771
"BLD",1452,"KRN",779.2,0)
779.2
"BLD",1452,"KRN",870,0)
870
"BLD",1452,"KRN",8989.51,0)
8989.51
"BLD",1452,"KRN",8989.52,0)
8989.52
"BLD",1452,"KRN",8994,0)
8994
"BLD",1452,"KRN",8994,"NM",0)
^9.68A^1^1
"BLD",1452,"KRN",8994,"NM",1,0)
PPS NDFMS SYNC^^0
"BLD",1452,"KRN",8994,"NM","B","PPS NDFMS SYNC",1)

"BLD",1452,"KRN",9002226,0)
9002226
"BLD",1452,"KRN",9002226,"NM",0)
^9.68A^^
"BLD",1452,"KRN","B",.4,.4)

"BLD",1452,"KRN","B",.401,.401)

"BLD",1452,"KRN","B",.402,.402)

"BLD",1452,"KRN","B",.403,.403)

"BLD",1452,"KRN","B",.5,.5)

"BLD",1452,"KRN","B",.84,.84)

"BLD",1452,"KRN","B",3.6,3.6)

"BLD",1452,"KRN","B",3.8,3.8)

"BLD",1452,"KRN","B",9.2,9.2)

"BLD",1452,"KRN","B",9.8,9.8)

"BLD",1452,"KRN","B",19,19)

"BLD",1452,"KRN","B",19.1,19.1)

"BLD",1452,"KRN","B",101,101)

"BLD",1452,"KRN","B",409.61,409.61)

"BLD",1452,"KRN","B",771,771)

"BLD",1452,"KRN","B",779.2,779.2)

"BLD",1452,"KRN","B",870,870)

"BLD",1452,"KRN","B",8989.51,8989.51)

"BLD",1452,"KRN","B",8989.52,8989.52)

"BLD",1452,"KRN","B",8994,8994)

"BLD",1452,"KRN","B",9002226,9002226)

"BLD",1452,"QUES",0)
^9.62^^
"BLD",1452,"REQB",0)
^9.611^^
"KRN",8994,82,-1)
0^1
"KRN",8994,82,0)
PPS NDFMS SYNC^SYNC^PSSMIGRC^1^P^0
"KRN",8994,82,1,0)
^8994.01^1^1^3120109^^
"KRN",8994,82,1,1,0)
This RPC is for non migration sync items.
"KRN",8994,82,2,0)
^8994.02A^1^1
"KRN",8994,82,2,1,0)
XML^4^^1
"KRN",8994,82,2,"B","XML",1)

"MBREQ")
0
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","PSSMIGRC")
0^1^B133790113
"RTN","PSSMIGRC",1,0)
PSSMIGRC ;AJF - Receives and Process Synch XML message from PEPS;  6/22/2012 0747
"RTN","PSSMIGRC",2,0)
 ;;1.0;PHARMACY ENTERPRISE PRODUCT SYSTEM;;;Build 39
"RTN","PSSMIGRC",3,0)
 ;;
"RTN","PSSMIGRC",4,0)
 ; Start of Sync request
"RTN","PSSMIGRC",5,0)
 ; Calls PSSMIGRP AND EN^PSSMIGRD
"RTN","PSSMIGRC",6,0)
 ;;
"RTN","PSSMIGRC",7,0)
SYNC(XOBY,PSSMSG) ;Entry point into routine
"RTN","PSSMIGRC",8,0)
 N X,Y,DIR,PATH,FILE,DOCHAND,PSSFDA,XMLFILE,VAL,LEN,INPUT,XFILE,OUTCNT,PSS,PSTATUS,ERROR
"RTN","PSSMIGRC",9,0)
 N ERROR,PSNDC,PSUPN,PSMAN,PSTNAME,PSPNAME,PSSIZE,PSTYPE,PSOTC,NIEN,MIEN,TIEN,SIEN
"RTN","PSSMIGRC",10,0)
 N PSCNT,PSNUM,D,DA,DATE,DIC,DIE,DLAYGO,DOCHAND,DOCHAND1,DR,DT,FILE,FRMTENT,GT,IMPUT,LEN,MIEN,NIEN
"RTN","PSSMIGRC",11,0)
 N NWARRY,OUT,PS0,PSNDC1,XML2,PSIADT,NIEN2,PNIEN,DIK,PNT,BNAME,PSSTITLE,PST,XMESS,XIEN,JOB
"RTN","PSSMIGRC",12,0)
 ;
"RTN","PSSMIGRC",13,0)
 D DT^DICRW S U="^",INPUT="",(ERROR,OUTCNT)=0,DATE=DT,PST="",DUZ(0)="@"
"RTN","PSSMIGRC",14,0)
 ;
"RTN","PSSMIGRC",15,0)
 S OUT=$NA(^UTILITY($J,"OUT"))
"RTN","PSSMIGRC",16,0)
 K ^UTILITY($J),^TMP($J,"XML OUT")
"RTN","PSSMIGRC",17,0)
 S ^TMP($J,"NDC1","START")=DATE
"RTN","PSSMIGRC",18,0)
 S ^TMP($J,"NDC1","XML")=$G(PSSMSG)
"RTN","PSSMIGRC",19,0)
 ;
"RTN","PSSMIGRC",20,0)
 D PRSTRING(.PSSMSG,.XMLFILE)
"RTN","PSSMIGRC",21,0)
 ;
"RTN","PSSMIGRC",22,0)
 S VAL="" F  S VAL=$O(XMLFILE(VAL)) Q:VAL=""  D
"RTN","PSSMIGRC",23,0)
 .S ^TMP($J,"XML OUT",VAL)=XMLFILE(VAL)
"RTN","PSSMIGRC",24,0)
 ;
"RTN","PSSMIGRC",25,0)
 ;**strip out any invisible ASCII characters before passing the TMP global to MXMLDOM
"RTN","PSSMIGRC",26,0)
 ;F  S PSS("charCount")=$O(^TMP($J,"XML OUT",PSS("charCount"))) Q:PSS("charCount")=""  D
"RTN","PSSMIGRC",27,0)
 ;F PSS("char")=0:1:32 S ^TMP($J,"XML OUT",PSS("charCount"))=$TRANSLATE(^TMP($J,"XML OUT",PSS("charCount")),$C(PSS("char")),"")
"RTN","PSSMIGRC",28,0)
 ;
"RTN","PSSMIGRC",29,0)
 ;**get handle to XML document in memory, the date/time message was received, and the DUZ of the associated user
"RTN","PSSMIGRC",30,0)
 S DOCHAND=$$EN^MXMLDOM($NA(^TMP($J,"XML OUT")),"VO")
"RTN","PSSMIGRC",31,0)
 S PSS("date/time")=$$NOW^XLFDT
"RTN","PSSMIGRC",32,0)
 S PSS("duz")=DUZ,PSS("FILE")=""
"RTN","PSSMIGRC",33,0)
 S (PSUPN,MIEN,PSTNAME,PNIEN,SIEN,TIEN,PSOTC,PSIADT,PSSTITLE)=""
"RTN","PSSMIGRC",34,0)
 ;
"RTN","PSSMIGRC",35,0)
 ;**retrieve parent node attributes
"RTN","PSSMIGRC",36,0)
 S PSS("body")=$$PARENT^MXMLDOM(DOCHAND,2)
"RTN","PSSMIGRC",37,0)
 S PSS("bodyName")=$$NAME^MXMLDOM(DOCHAND,PSS("body"))
"RTN","PSSMIGRC",38,0)
 S PSS("status")=$$VALUE^MXMLDOM(DOCHAND,PSS("body"),"status")
"RTN","PSSMIGRC",39,0)
 S PSS("pepsIdNumber")=$$VALUE^MXMLDOM(DOCHAND,PSS("body"),"pepsIdNumber")
"RTN","PSSMIGRC",40,0)
 S JOB=$J
"RTN","PSSMIGRC",41,0)
 ;
"RTN","PSSMIGRC",42,0)
 ;
"RTN","PSSMIGRC",43,0)
 S BNAME=$G(PSS("bodyName"))
"RTN","PSSMIGRC",44,0)
 I BNAME]"" D
"RTN","PSSMIGRC",45,0)
 . I BNAME="ndcSyncRequest" D NDC Q
"RTN","PSSMIGRC",46,0)
 . I BNAME="manufacturerSyncRequest" D MAN Q
"RTN","PSSMIGRC",47,0)
 . I BNAME="packageTypeSyncRequest" D PACK Q
"RTN","PSSMIGRC",48,0)
 . I BNAME="drugUnitSyncRequest" D DRU Q
"RTN","PSSMIGRC",49,0)
 . I BNAME="vaDispenseUnitSyncRequest" D DIS Q
"RTN","PSSMIGRC",50,0)
 . I BNAME="drugIngredientSyncRequest" D DRUI Q
"RTN","PSSMIGRC",51,0)
 . I BNAME="vaGenericNameSyncRequest" D VAG Q
"RTN","PSSMIGRC",52,0)
 . I BNAME="drugClassSyncRequest" D DRUC^PSSMIGRP Q
"RTN","PSSMIGRC",53,0)
 . I BNAME="dosageFormSyncRequest" D DOF^PSSMIGRP Q
"RTN","PSSMIGRC",54,0)
 . I BNAME="vaProductSyncRequest" D VAP^PSSMIGRP Q
"RTN","PSSMIGRC",55,0)
 ;
"RTN","PSSMIGRC",56,0)
 ; Quit if REQUIRED DATA is Missing
"RTN","PSSMIGRC",57,0)
 I PSS("FILE")="" D OUT(" Error...Missing Required START TAG") Q
"RTN","PSSMIGRC",58,0)
 I PSS("RTYPE")'="ADD",PSS("RTYPE")'="MODIFY"  D OUT("Error...Invalid Request Type") Q
"RTN","PSSMIGRC",59,0)
 I PSS("RTYPE")="MODIFY",'+$G(PSS("IEN")) D OUT(" Error... Missing Required IEN") Q
"RTN","PSSMIGRC",60,0)
 ;
"RTN","PSSMIGRC",61,0)
 D MIGR
"RTN","PSSMIGRC",62,0)
 Q
"RTN","PSSMIGRC",63,0)
 ;
"RTN","PSSMIGRC",64,0)
NDC ;
"RTN","PSSMIGRC",65,0)
 ;
"RTN","PSSMIGRC",66,0)
 I PSS("bodyName")="ndcSyncRequest" D
"RTN","PSSMIGRC",67,0)
 . S PSS("child")=1,PSS("FILE")=50.67,(PSSTITLE,PST)="syncResponse"
"RTN","PSSMIGRC",68,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,1,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRC",69,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRC",70,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",71,0)
 .. I PSS("ELE")="ndcName" S PSS("NAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",72,0)
 .. I PSS("ELE")="ndcIen" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",73,0)
 .. I PSS("ELE")="upn" S PSS("UPN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",74,0)
 .. I PSS("ELE")="tradeName" S PSS("TNAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",75,0)
 .. I PSS("ELE")="manufacturer" D
"RTN","PSSMIGRC",76,0)
 ... S DOCHAND1=PSS("child"),PSS("child1")=1
"RTN","PSSMIGRC",77,0)
 ... F  S PSS("child1")=$$CHILD^MXMLDOM(DOCHAND,DOCHAND1,PSS("child1")) Q:PSS("child1")=0  D
"RTN","PSSMIGRC",78,0)
 .... S PSS("ELE1")=$$NAME^MXMLDOM(DOCHAND,PSS("child1"))
"RTN","PSSMIGRC",79,0)
 .... I PSS("ELE1")="manufacturerName" S PSS("MNAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRC",80,0)
 .... I PSS("ELE1")="manufacturerIen" S PSS("MIEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRC",81,0)
 .. I PSS("ELE")="product" D
"RTN","PSSMIGRC",82,0)
 ... S DOCHAND1=PSS("child"),PSS("child1")=1
"RTN","PSSMIGRC",83,0)
 ... F  S PSS("child1")=$$CHILD^MXMLDOM(DOCHAND,DOCHAND1,PSS("child1")) Q:PSS("child1")=0  D
"RTN","PSSMIGRC",84,0)
 .... S PSS("ELE1")=$$NAME^MXMLDOM(DOCHAND,PSS("child1"))
"RTN","PSSMIGRC",85,0)
 .... I PSS("ELE1")="productName" S PSS("PNAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRC",86,0)
 .... I PSS("ELE1")="productIen" S PSS("PIEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRC",87,0)
 .. I PSS("ELE")="packageSize" S PSS("PSIZE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",88,0)
 .. I PSS("ELE")="inactivationDate" S PSS("IDATE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",89,0)
 .. I PSS("ELE")="packageType" D
"RTN","PSSMIGRC",90,0)
 ... S DOCHAND1=PSS("child"),PSS("child1")=1
"RTN","PSSMIGRC",91,0)
 ... F  S PSS("child1")=$$CHILD^MXMLDOM(DOCHAND,DOCHAND1,PSS("child1")) Q:PSS("child1")=0  D
"RTN","PSSMIGRC",92,0)
 .... S PSS("ELE1")=$$NAME^MXMLDOM(DOCHAND,PSS("child1"))
"RTN","PSSMIGRC",93,0)
 .... I PSS("ELE1")="packageTypeName" S PSS("PTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRC",94,0)
 .... I PSS("ELE1")="packageTypeIen" S PSS("PTIEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRC",95,0)
 .. I PSS("ELE")="otcRxIndicator" S PSS("PSOTC")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",96,0)
 Q
"RTN","PSSMIGRC",97,0)
 ;
"RTN","PSSMIGRC",98,0)
MAN  ;MANUFACTURER
"RTN","PSSMIGRC",99,0)
 I PSS("bodyName")="manufacturerSyncRequest" D
"RTN","PSSMIGRC",100,0)
 . S PSS("child")=1,PSS("FILE")=55.95,(PSSTITLE,PST)="syncResponse"
"RTN","PSSMIGRC",101,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,1,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRC",102,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRC",103,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",104,0)
 .. I PSS("ELE")="manufacturerIen" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",105,0)
 .. I PSS("ELE")="manufacturerName" S PSS("NAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",106,0)
 .. I PSS("ELE")="NDCNumber" S PSS("NDCNUM")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",107,0)
 .. I PSS("ELE")="inactivationDate" S PSS("IDATE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",108,0)
 Q
"RTN","PSSMIGRC",109,0)
 ;
"RTN","PSSMIGRC",110,0)
PACK ; PACKAGETYPE
"RTN","PSSMIGRC",111,0)
 I PSS("bodyName")="packageTypeSyncRequest" D
"RTN","PSSMIGRC",112,0)
 . S PSS("child")=1,PSS("FILE")=50.608,(PSSTITLE,PST)="syncResponse"
"RTN","PSSMIGRC",113,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,1,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRC",114,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRC",115,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",116,0)
 .. I PSS("ELE")="packageTypeIen" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",117,0)
 .. I PSS("ELE")="packageTypeName" S PSS("NAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",118,0)
 .. I PSS("ELE")="inactivationDate" S PSS("IDATE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",119,0)
 Q
"RTN","PSSMIGRC",120,0)
 ;
"RTN","PSSMIGRC",121,0)
DRU ;DRUGUNIT
"RTN","PSSMIGRC",122,0)
 ;
"RTN","PSSMIGRC",123,0)
 I PSS("bodyName")="drugUnitSyncRequest" D
"RTN","PSSMIGRC",124,0)
 . S PSS("child")=1,PSS("FILE")=50.607,(PSSTITLE,PST)="syncResponse"
"RTN","PSSMIGRC",125,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,1,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRC",126,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRC",127,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",128,0)
 .. I PSS("ELE")="drugUnitIen" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",129,0)
 .. I PSS("ELE")="drugUnitName" S PSS("NAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",130,0)
 .. I PSS("ELE")="inactivationDate" S PSS("IDATE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",131,0)
 Q
"RTN","PSSMIGRC",132,0)
 ;
"RTN","PSSMIGRC",133,0)
DIS ;DISPENSEUNIT
"RTN","PSSMIGRC",134,0)
 I PSS("bodyName")="vaDispenseUnitSyncRequest" D
"RTN","PSSMIGRC",135,0)
 . S PSS("child")=1,PSS("FILE")=50.64,(PSSTITLE,PST)="syncResponse"
"RTN","PSSMIGRC",136,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,1,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRC",137,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRC",138,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",139,0)
 .. I PSS("ELE")="vaDispenseUnitIen" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",140,0)
 .. I PSS("ELE")="vaDispenseUnitName" S PSS("NAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",141,0)
 .. I PSS("ELE")="inactivationDate" S PSS("IDATE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",142,0)
 Q
"RTN","PSSMIGRC",143,0)
 ;
"RTN","PSSMIGRC",144,0)
DRUI ;DRUGINGREDIENT
"RTN","PSSMIGRC",145,0)
 ;
"RTN","PSSMIGRC",146,0)
 I PSS("bodyName")="drugIngredientSyncRequest" D
"RTN","PSSMIGRC",147,0)
 . S PSS("child")=1,PSS("FILE")=50.416,(PSSTITLE,PST)="syncResponse"
"RTN","PSSMIGRC",148,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,1,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRC",149,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRC",150,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",151,0)
 .. I PSS("ELE")="drugIngredientName" S PSS("NAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",152,0)
 .. I PSS("ELE")="ingredientIen" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",153,0)
 .. I PSS("ELE")="primaryIngredient" S PSS("PRIMARY")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",154,0)
 .. I PSS("ELE")="inactivationDate" S PSS("INACTDATE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",155,0)
 .. I PSS("ELE")="masterEntryForVuid" S PSS("MASTERVUID")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",156,0)
 .. I PSS("ELE")="vuid" S PSS("VUID")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",157,0)
 .. I PSS("ELE")="effectiveDateTimeRecord" D
"RTN","PSSMIGRC",158,0)
 ... S DOCHAND1=PSS("child"),PSS("child1")=1
"RTN","PSSMIGRC",159,0)
 ... F  S PSS("child1")=$$CHILD^MXMLDOM(DOCHAND,DOCHAND1,PSS("child1")) Q:PSS("child1")=0  D
"RTN","PSSMIGRC",160,0)
 .... S PSS("ELE1")=$$NAME^MXMLDOM(DOCHAND,PSS("child1"))
"RTN","PSSMIGRC",161,0)
 .... I PSS("ELE1")="effectiveDateTime" S PSS("EFFDATE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRC",162,0)
 .... I PSS("ELE1")="status" S PSS("STATUS")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRC",163,0)
 Q
"RTN","PSSMIGRC",164,0)
 ;
"RTN","PSSMIGRC",165,0)
VAG ;VAGENERIC
"RTN","PSSMIGRC",166,0)
 ;
"RTN","PSSMIGRC",167,0)
 I PSS("bodyName")="vaGenericNameSyncRequest" D
"RTN","PSSMIGRC",168,0)
 . S PSS("child")=1,PSS("FILE")=50.6,(PSSTITLE,PST)="syncResponse"
"RTN","PSSMIGRC",169,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,1,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRC",170,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRC",171,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",172,0)
 .. I PSS("ELE")="vaGenericNameIen" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",173,0)
 .. I PSS("ELE")="vaGenericNameName" S PSS("NAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",174,0)
 .. I PSS("ELE")="masterEntryForVuid" S PSS("MASTERVUID")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",175,0)
 .. I PSS("ELE")="inactivationDate" S PSS("INACTDATE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",176,0)
 .. I PSS("ELE")="vuid" S PSS("VUID")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRC",177,0)
 .. I PSS("ELE")="effectiveDateTimeRecord" D
"RTN","PSSMIGRC",178,0)
 ... S DOCHAND1=PSS("child"),PSS("child1")=1
"RTN","PSSMIGRC",179,0)
 ... F  S PSS("child1")=$$CHILD^MXMLDOM(DOCHAND,DOCHAND1,PSS("child1")) Q:PSS("child1")=0  D
"RTN","PSSMIGRC",180,0)
 .... S PSS("ELE1")=$$NAME^MXMLDOM(DOCHAND,PSS("child1"))
"RTN","PSSMIGRC",181,0)
 .... I PSS("ELE1")="effectiveDateTime" S PSS("EFFDATE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRC",182,0)
 .... I PSS("ELE1")="status" S PSS("STATUS")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRC",183,0)
 ;
"RTN","PSSMIGRC",184,0)
 Q
"RTN","PSSMIGRC",185,0)
 ;
"RTN","PSSMIGRC",186,0)
MIGR ;Process sync request
"RTN","PSSMIGRC",187,0)
 D EN^PSSMIGRD(.PSS)
"RTN","PSSMIGRC",188,0)
 ;
"RTN","PSSMIGRC",189,0)
 Q:ERROR=1
"RTN","PSSMIGRC",190,0)
 ;
"RTN","PSSMIGRC",191,0)
XMLR  ;**generate XML response message
"RTN","PSSMIGRC",192,0)
 ;
"RTN","PSSMIGRC",193,0)
 ;
"RTN","PSSMIGRC",194,0)
 S PSS("xmlResponse")=$$XMLBODY(.PSS)
"RTN","PSSMIGRC",195,0)
 ;
"RTN","PSSMIGRC",196,0)
 ;
"RTN","PSSMIGRC",197,0)
 ;**store value in VistALink return parameter
"RTN","PSSMIGRC",198,0)
 ;
"RTN","PSSMIGRC",199,0)
 ;
"RTN","PSSMIGRC",200,0)
 ;
"RTN","PSSMIGRC",201,0)
 ;Write the XML response message to a new file
"RTN","PSSMIGRC",202,0)
 S FILE=PSSTITLE_".XML"
"RTN","PSSMIGRC",203,0)
 S XML2=PSS("xmlHeader")_"<"_PSSTITLE_PSS("xmlns")
"RTN","PSSMIGRC",204,0)
 S XML2=XML2_PSS("xmlns:xsi")_">"_"<syncResponseType>"_"<status>Success</status>"
"RTN","PSSMIGRC",205,0)
 S XML2=XML2_XMESS_"</syncResponseType>"_XIEN
"RTN","PSSMIGRC",206,0)
 S XOBY=XML2_"</"_PSSTITLE_">"
"RTN","PSSMIGRC",207,0)
 S ^TMP($J,"NDC1","XOBY")=XOBY
"RTN","PSSMIGRC",208,0)
 ;
"RTN","PSSMIGRC",209,0)
 ;
"RTN","PSSMIGRC",210,0)
Q1 ; exit and clean-up
"RTN","PSSMIGRC",211,0)
 ;K ^TMP("MXMLDOM",$J),^TMP($J)
"RTN","PSSMIGRC",212,0)
 ;
"RTN","PSSMIGRC",213,0)
 ;
"RTN","PSSMIGRC",214,0)
 Q
"RTN","PSSMIGRC",215,0)
 ;
"RTN","PSSMIGRC",216,0)
 ;
"RTN","PSSMIGRC",217,0)
RESPONSE(PSS) ;**check to see if current XML message was successfully written to the PEPS QUEUE file (#54.5)
"RTN","PSSMIGRC",218,0)
 N PSSOUT
"RTN","PSSMIGRC",219,0)
 ;
"RTN","PSSMIGRC",220,0)
 I $D(PSS("ERR")) S PSS("response")="Failure",PSS("attribValue")="<response status="""_PSS("response")_""">Unable to queue message.  Reason: "_$P(PSS("ERR"),"^",2)_"</response>"
"RTN","PSSMIGRC",221,0)
 E  I $D(^PSSPEPS("B",PSS("pepsIdNumber"))) S PSS("response")="Queued",PSS("attribValue")="<response status="""_PSS("response")_""">Message "_PSS("pepsIdNumber")_" is queued.</response>"
"RTN","PSSMIGRC",222,0)
 E  S PSS("response")="Failure",PSS("attribValue")="<response status="""_PSS("response")_""">Unable to queue message "_PSS("pepsIdNumber")_". Reason: "_$P($G(PSS("ERR")),"^",2)_"</response>"
"RTN","PSSMIGRC",223,0)
 S PSSOUT=$$XMLBODY(.PSS)
"RTN","PSSMIGRC",224,0)
 Q PSSOUT
"RTN","PSSMIGRC",225,0)
 ;
"RTN","PSSMIGRC",226,0)
XMLBODY(PSS) ;**generates response XML message
"RTN","PSSMIGRC",227,0)
 S PSS("xmlHeader")=$$XMLHDR^MXMLUTL
"RTN","PSSMIGRC",228,0)
 S PSS("xmlns:xsi")=" xmlns:xsi=""http://www.w3.org/2001/XMLSchema"""
"RTN","PSSMIGRC",229,0)
 S PSS("xmlns")=" xmlns=""gov/va/med/pharmacy/peps/external/common/vo/inbound/sync/syncResponse"""
"RTN","PSSMIGRC",230,0)
 ;S PSS("xmlns")=" xmlns=""gov/va/med/pharmacy/peps/external/common/vo/inbound/migration/"_PST_"/response"""
"RTN","PSSMIGRC",231,0)
 S PSSOUT=PSS("xmlHeader")
"RTN","PSSMIGRC",232,0)
 S PSSOUT=PSSOUT_"<"_PSSTITLE
"RTN","PSSMIGRC",233,0)
 S PSSOUT=PSSOUT_" "_PSS("xmlns")
"RTN","PSSMIGRC",234,0)
 S PSSOUT=PSSOUT_" "_PSS("xmlns:xsi")
"RTN","PSSMIGRC",235,0)
 Q PSSOUT
"RTN","PSSMIGRC",236,0)
 ;
"RTN","PSSMIGRC",237,0)
TRASH ;**delete XML handle
"RTN","PSSMIGRC",238,0)
 D DELETE^MXMLDOM(DOCHAND)
"RTN","PSSMIGRC",239,0)
 Q
"RTN","PSSMIGRC",240,0)
 ;
"RTN","PSSMIGRC",241,0)
OUT(X) ;Error message 
"RTN","PSSMIGRC",242,0)
 S FILE=PSSTITLE_".XML",ERROR=1,PSS("xmlResponse")=$$XMLBODY(.PSS)
"RTN","PSSMIGRC",243,0)
 S XML2=PSS("xmlHeader")_"<syncResponse "_PSS("xmlns")
"RTN","PSSMIGRC",244,0)
 S XML2=XML2_PSS("xmlns:xsi")_"><syncResponseType><status>Failure</status>"
"RTN","PSSMIGRC",245,0)
 S XML2=XML2_"<message>"_X_"</message></syncResponseType></syncResponse>"
"RTN","PSSMIGRC",246,0)
 S XOBY=XML2
"RTN","PSSMIGRC",247,0)
 S ^TMP($J,"NDC1","OUT")=XOBY,ERROR=1
"RTN","PSSMIGRC",248,0)
 D Q1
"RTN","PSSMIGRC",249,0)
 Q
"RTN","PSSMIGRC",250,0)
 ;
"RTN","PSSMIGRC",251,0)
PRSTRING(XML,NWARRY) ;**parses the incoming xml string coming back from PEPS
"RTN","PSSMIGRC",252,0)
 ;;
"RTN","PSSMIGRC",253,0)
 ;XML is the xml string that is passed by PEPS. 
"RTN","PSSMIGRC",254,0)
 ;It must be parsed into an array that is usable by MXML Kernel routines. 
"RTN","PSSMIGRC",255,0)
 ;;
"RTN","PSSMIGRC",256,0)
 I '$D(XML) D OUT(" Error... Invalid xml string") Q
"RTN","PSSMIGRC",257,0)
 N POS,GT,FRNTEND,CNT
"RTN","PSSMIGRC",258,0)
 ;**FRNTEND holds the front portion of the extracted data
"RTN","PSSMIGRC",259,0)
 S GT=">",POS=0
"RTN","PSSMIGRC",260,0)
 F CNT=0:1 Q:XML=""!(XML'[">")  D
"RTN","PSSMIGRC",261,0)
 .S POS=$F(XML,GT)
"RTN","PSSMIGRC",262,0)
 .S FRNTEND=$E(XML,1,POS-1)
"RTN","PSSMIGRC",263,0)
 .S XML=$E(XML,POS,$L(XML))
"RTN","PSSMIGRC",264,0)
 .S NWARRY(CNT)=FRNTEND
"RTN","PSSMIGRC",265,0)
 Q
"RTN","PSSMIGRC",266,0)
 ;
"RTN","PSSMIGRC",267,0)
 ;
"RTN","PSSMIGRC",268,0)
DATE(Y)  ;RETURN A DATE
"RTN","PSSMIGRC",269,0)
 I Y X ^DD("DD")
"RTN","PSSMIGRC",270,0)
 Q Y
"RTN","PSSMIGRD")
0^2^B215666817
"RTN","PSSMIGRD",1,0)
PSSMIGRD ;AJF - Process Sync XML message from PEPS;  11/01/2012 0703
"RTN","PSSMIGRD",2,0)
 ;;1.0;PHARMACY ENTERPRISE PRODUCT SYSTEM;;7/11/2008;Build 39
"RTN","PSSMIGRD",3,0)
 ;;
"RTN","PSSMIGRD",4,0)
 ;  Process Sync request
"RTN","PSSMIGRD",5,0)
 ;  Called from ^PSSMIGRC
"RTN","PSSMIGRD",6,0)
 ;  Calls to ^PSSMIGRE and PSSMIGRR
"RTN","PSSMIGRD",7,0)
 ;;
"RTN","PSSMIGRD",8,0)
EN(PSS) ;Entry point into routine
"RTN","PSSMIGRD",9,0)
 ; FL - File
"RTN","PSSMIGRD",10,0)
 ; IEN - The starting IEN
"RTN","PSSMIGRD",11,0)
 ; RCNT - Number of records desired
"RTN","PSSMIGRD",12,0)
 ; TYPE - 1
"RTN","PSSMIGRD",13,0)
 ;
"RTN","PSSMIGRD",14,0)
 ;
"RTN","PSSMIGRD",15,0)
 S FNAME="SyncResponse.XML"
"RTN","PSSMIGRD",16,0)
 S FL=$G(PSS("FILE"))
"RTN","PSSMIGRD",17,0)
 I FL="" D OUT^PSSMIGRC(" Error... Missing required data") Q
"RTN","PSSMIGRD",18,0)
 N XST,CNT
"RTN","PSSMIGRD",19,0)
 S CNT=0,XST=0
"RTN","PSSMIGRD",20,0)
 I FL=50.607 D DUNI Q  ;Drug Unit
"RTN","PSSMIGRD",21,0)
 I FL=50.416 D DING Q  ;Drug Ingredients
"RTN","PSSMIGRD",22,0)
 I FL=50.605 D VADC Q  ;VA Drug Class
"RTN","PSSMIGRD",23,0)
 I FL=50.606 D DSFO Q  ;Dosage Form
"RTN","PSSMIGRD",24,0)
 I FL=50.6 D VAGN^PSSMIGRE Q  ;VA Generic Name
"RTN","PSSMIGRD",25,0)
 I FL=50.64 D VADU Q  ; VA Dispense UNIT
"RTN","PSSMIGRD",26,0)
 I FL=55.95 D MAN^PSSMIGRE Q  ;Manufacturer
"RTN","PSSMIGRD",27,0)
 I FL=50.608 D PTYP^PSSMIGRE Q  ;Package Type
"RTN","PSSMIGRD",28,0)
 I FL=50.67 D NDC^PSSMIGRE Q  ;NDC 
"RTN","PSSMIGRD",29,0)
 I FL=50.68 D VAPD^PSSMIGRR Q  ;VA Product
"RTN","PSSMIGRD",30,0)
 ;
"RTN","PSSMIGRD",31,0)
 ;File Error Process
"RTN","PSSMIGRD",32,0)
 D OUT^PSSMIGRC(" Error... Invalid File Number")
"RTN","PSSMIGRD",33,0)
 Q
"RTN","PSSMIGRD",34,0)
 ;
"RTN","PSSMIGRD",35,0)
 ;DIA(50.
"RTN","PSSMIGRD",36,0)
DUNI ; DRUG UNIT file Synch 
"RTN","PSSMIGRD",37,0)
 ;
"RTN","PSSMIGRD",38,0)
 N X,Y,DIC,DA,DR,DIE,IEN,NAME,RTYPE,IDATE,PS5
"RTN","PSSMIGRD",39,0)
 I PSS("NAME")="" D OUT^PSSMIGRC(" Error...Missing Required NAME") Q
"RTN","PSSMIGRD",40,0)
 S NAME=$G(PSS("NAME")),IEN=$G(PSS("IEN")),RTYPE=$G(PSS("RTYPE"))
"RTN","PSSMIGRD",41,0)
 S IDATE=$TR($P($G(PSS("IDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE,"L")
"RTN","PSSMIGRD",42,0)
 S FNAME="syncResponse.XML",FNUM=50.607
"RTN","PSSMIGRD",43,0)
 S FNAME1="drugUnits"
"RTN","PSSMIGRD",44,0)
 ;
"RTN","PSSMIGRD",45,0)
 ;Add the DRUG UNIT to the Database
"RTN","PSSMIGRD",46,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRD",47,0)
 . ; Lock the Global
"RTN","PSSMIGRD",48,0)
 . L +^PS(50.607):5 E  D OUT^PSSMIGRC(" Another USER editing DRUG UNIT file") Q
"RTN","PSSMIGRD",49,0)
 . ;
"RTN","PSSMIGRD",50,0)
 . ; Cheating - Remove LAYGO temporarly
"RTN","PSSMIGRD",51,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.607,.01,"LAYGO",.01,0))
"RTN","PSSMIGRD",52,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.607,.01,"LAYGO",.01,0)
"RTN","PSSMIGRD",53,0)
 . ;
"RTN","PSSMIGRD",54,0)
 . ; Get the IEN
"RTN","PSSMIGRD",55,0)
 . S X=NAME,DIC=50.607,DIC(0)="LMXZ"
"RTN","PSSMIGRD",56,0)
 . D ^DIC
"RTN","PSSMIGRD",57,0)
 . S (DA,PSS("IEN"))=+Y
"RTN","PSSMIGRD",58,0)
 . ;
"RTN","PSSMIGRD",59,0)
 . ; Quit if cannot get IEN
"RTN","PSSMIGRD",60,0)
 . I Y<1 D  Q
"RTN","PSSMIGRD",61,0)
 . . D OUT^PSSMIGRC(" Error...Cannot obtain an IEN for NAME")
"RTN","PSSMIGRD",62,0)
 . . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.607,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",63,0)
 . ;
"RTN","PSSMIGRD",64,0)
 . ; Set Database Variables
"RTN","PSSMIGRD",65,0)
 . S PSS("IEN")=DA,DIE=DIC K DIC
"RTN","PSSMIGRD",66,0)
 . ;S DR=".01///^S X=NAME;1///^S X=IDATE"
"RTN","PSSMIGRD",67,0)
 . S DR="1///^S X=IDATE"
"RTN","PSSMIGRD",68,0)
 . ;
"RTN","PSSMIGRD",69,0)
 . ; Update Database
"RTN","PSSMIGRD",70,0)
 . D ^DIE
"RTN","PSSMIGRD",71,0)
 . ;
"RTN","PSSMIGRD",72,0)
 . ; Put LAYGO back
"RTN","PSSMIGRD",73,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.607,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",74,0)
 . L -^PS(50.607)
"RTN","PSSMIGRD",75,0)
 ;
"RTN","PSSMIGRD",76,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRD",77,0)
 .S DA=PSS("IEN"),DIE="^PS(50.607,"
"RTN","PSSMIGRD",78,0)
 .;S DR=".01///^S X=NAME;1///"_$S(IDATE]"":"^S X=IDATE",1:"@")
"RTN","PSSMIGRD",79,0)
 .S PS5=$G(^PS(50.607,DA,0)),DR="",PQ=""
"RTN","PSSMIGRD",80,0)
 .S:$P(PS5,"^",1)'=NAME DR=".01///^S X=NAME" S:$L(DR) PQ=";"
"RTN","PSSMIGRD",81,0)
 .S DR=DR_PQ_"1///"_$S(IDATE]"":"^S X=IDATE",1:"@")
"RTN","PSSMIGRD",82,0)
 .D ^DIE
"RTN","PSSMIGRD",83,0)
 ;
"RTN","PSSMIGRD",84,0)
 S XMESS="<message>  Updated Drug Units: "_NAME_" </message>"
"RTN","PSSMIGRD",85,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRD",86,0)
 K DIC,DA,DR,DIE,^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",87,0)
 Q
"RTN","PSSMIGRD",88,0)
 ;
"RTN","PSSMIGRD",89,0)
VADU ; VA Dispense UNIT file Synch
"RTN","PSSMIGRD",90,0)
 ;
"RTN","PSSMIGRD",91,0)
 N X,Y,DIC,DA,DR,DIE,IEN,NAME,RTYPE,IDATE
"RTN","PSSMIGRD",92,0)
 S IEN=$G(PSS("IEN")),NAME=$G(PSS("NAME")),RTYPE=$G(PSS("RTYPE"))
"RTN","PSSMIGRD",93,0)
 S IDATE=$TR($P($G(PSS("IDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE,"L")
"RTN","PSSMIGRD",94,0)
 S FNUM=50.64,FNAME="syncResponse.XML",FNAME1="vaDispenseUnits"
"RTN","PSSMIGRD",95,0)
 S ERROR=0
"RTN","PSSMIGRD",96,0)
 ;
"RTN","PSSMIGRD",97,0)
 ; Quit if REQUIRED DATA is Missing
"RTN","PSSMIGRD",98,0)
 I RTYPE="MODIFY",'+(PSS("IEN")) D OUT^PSSMIGRC(" Error... Invalid IEN") Q
"RTN","PSSMIGRD",99,0)
 I NAME="" D OUT^PSSMIGRC(" Error...Missing Required NAME") Q
"RTN","PSSMIGRD",100,0)
 I RTYPE'="ADD",RTYPE'="MODIFY"  D OUT^PSSMIGRC("Error...Invalid Request Type") Q
"RTN","PSSMIGRD",101,0)
 ;
"RTN","PSSMIGRD",102,0)
 ;Add the Dispense UNIT to the Database
"RTN","PSSMIGRD",103,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRD",104,0)
 . ; Lock the Global
"RTN","PSSMIGRD",105,0)
 . L +^PSNDF(50.64):5 E  S ERROR=1 D OUT^PSSMIGRC(" *Another USER editing VA Dispense Unit file") Q
"RTN","PSSMIGRD",106,0)
 . ;
"RTN","PSSMIGRD",107,0)
 . ; Cheating - Remove LAYGO temporarly
"RTN","PSSMIGRD",108,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.64,.01,"LAYGO",.01,0))
"RTN","PSSMIGRD",109,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.64,.01,"LAYGO",.01,0)
"RTN","PSSMIGRD",110,0)
 . ;
"RTN","PSSMIGRD",111,0)
 . ; Get the IEN
"RTN","PSSMIGRD",112,0)
 . S X=NAME,DIC=50.64,DIC(0)="LMXZ"
"RTN","PSSMIGRD",113,0)
 . D ^DIC
"RTN","PSSMIGRD",114,0)
 . S (DA,PSS("IEN"))=+Y
"RTN","PSSMIGRD",115,0)
 . ;
"RTN","PSSMIGRD",116,0)
 . ; Quit if cannot get IEN
"RTN","PSSMIGRD",117,0)
 . I Y<1 D  Q
"RTN","PSSMIGRD",118,0)
 . . S ERROR=1
"RTN","PSSMIGRD",119,0)
 . . D OUT^PSSMIGRC(" Error...Cannot obtain an IEN for NAME")
"RTN","PSSMIGRD",120,0)
 . . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.64,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",121,0)
 . ;
"RTN","PSSMIGRD",122,0)
 . ;Set Database Variables
"RTN","PSSMIGRD",123,0)
 . S PSS("IEN")=DA,DIE=DIC K DIC
"RTN","PSSMIGRD",124,0)
 . ;S DR=".01///^S X=NAME;1///^S X=IDATE"
"RTN","PSSMIGRD",125,0)
 . S DR="1///^S X=IDATE"
"RTN","PSSMIGRD",126,0)
 . ;
"RTN","PSSMIGRD",127,0)
 . ; Update Database
"RTN","PSSMIGRD",128,0)
 . D ^DIE
"RTN","PSSMIGRD",129,0)
 . ;
"RTN","PSSMIGRD",130,0)
 . ; Put LAYGO back
"RTN","PSSMIGRD",131,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.64,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",132,0)
 . L -^PSNDF(50.64)
"RTN","PSSMIGRD",133,0)
 ;
"RTN","PSSMIGRD",134,0)
 Q:ERROR
"RTN","PSSMIGRD",135,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRD",136,0)
 .S DA=PSS("IEN"),DIE=50.64
"RTN","PSSMIGRD",137,0)
 .S PS5=$G(^PSNDF(50.64,DA,0)),DR="",PQ=""
"RTN","PSSMIGRD",138,0)
 .S:$P(PS5,"^",1)'=NAME DR=".01///^S X=NAME" S:$L(DR) PQ=";"
"RTN","PSSMIGRD",139,0)
 .S DR=DR_PQ_"1///"_$S(IDATE]"":"^S X=IDATE",1:"@")
"RTN","PSSMIGRD",140,0)
 .D ^DIE
"RTN","PSSMIGRD",141,0)
 ;
"RTN","PSSMIGRD",142,0)
 S XMESS="<message> Updated Dispense Units "_NAME_" </message>"
"RTN","PSSMIGRD",143,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRD",144,0)
 Q
"RTN","PSSMIGRD",145,0)
 ;
"RTN","PSSMIGRD",146,0)
DING ; Drug Ingredients file Synch
"RTN","PSSMIGRD",147,0)
 ;
"RTN","PSSMIGRD",148,0)
 N X,Y,DIC,DA,DR,DIE,IEN,NAME,RTYPE,IDATE,PRIMARY,MVUID,VUID,EFFDT,STATUS
"RTN","PSSMIGRD",149,0)
 S IEN=$G(PSS("IEN")),NAME=$G(PSS("NAME")),RTYPE=$G(PSS("RTYPE"))
"RTN","PSSMIGRD",150,0)
 S PRIMARY=$G(PSS("PRIMARY")),MVUID=$G(PSS("MASTERVUID")),VUID=$G(PSS("VUID"))
"RTN","PSSMIGRD",151,0)
 S EFFDT=$G(PSS("EFFDATE")),STATUS=$G(PSS("STATUS"))
"RTN","PSSMIGRD",152,0)
 S IDATE=$TR($P($G(PSS("INACTDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE,"L")
"RTN","PSSMIGRD",153,0)
 S FNUM=50.416,FNAME="syncResponse.XML",FNAME1="drugIngredients"
"RTN","PSSMIGRD",154,0)
 ;
"RTN","PSSMIGRD",155,0)
 ; Quit if REQUIRED DATA is Missing
"RTN","PSSMIGRD",156,0)
 I NAME="" D OUT^PSSMIGRC(" Error...Missing Required NAME") Q
"RTN","PSSMIGRD",157,0)
 I MVUID="" D OUT^PSSMIGRC(" Error...Missing Required MASTER VUID") Q
"RTN","PSSMIGRD",158,0)
 I VUID="" D OUT^PSSMIGRC(" Error...Missing Required VUID") Q
"RTN","PSSMIGRD",159,0)
 I EFFDT="" D OUT^PSSMIGRC(" Error...Missing Required EFFECTIVE DATE") Q
"RTN","PSSMIGRD",160,0)
 I STATUS="" D OUT^PSSMIGRC(" Error...Missing Required STATUS") Q
"RTN","PSSMIGRD",161,0)
 I RTYPE="MODIFY",'+(PSS("IEN")) D OUT^PSSMIGRC(" Error... Invalid IEN") Q
"RTN","PSSMIGRD",162,0)
 ;
"RTN","PSSMIGRD",163,0)
 S EFFDT=$$DATE($G(PSS("EFFDATE")))
"RTN","PSSMIGRD",164,0)
 ;
"RTN","PSSMIGRD",165,0)
 ;Add the Ingredient to the Database
"RTN","PSSMIGRD",166,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRD",167,0)
 . ; Lock the Global
"RTN","PSSMIGRD",168,0)
 . ;L +^PS(50.416):5 E  D OUT^PSSMIGRC(" Another USER is editing Drug Ingredients file") Q
"RTN","PSSMIGRD",169,0)
 . ;
"RTN","PSSMIGRD",170,0)
 . ; Cheating - Remove LAYGO temporarly
"RTN","PSSMIGRD",171,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.416,.01,"LAYGO",.01,0))
"RTN","PSSMIGRD",172,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.416,.01,"LAYGO",.01,0)
"RTN","PSSMIGRD",173,0)
 . ;
"RTN","PSSMIGRD",174,0)
 . ; Get the IEN
"RTN","PSSMIGRD",175,0)
 . S X=NAME,DIC=50.416,DIC(0)="LMXZ"
"RTN","PSSMIGRD",176,0)
 . D ^DIC
"RTN","PSSMIGRD",177,0)
 . S (DA,PSS("IEN"),PIEN)=+Y
"RTN","PSSMIGRD",178,0)
 . ;
"RTN","PSSMIGRD",179,0)
 . ; Quit if cannot get IEN
"RTN","PSSMIGRD",180,0)
 . I Y<1 D  Q
"RTN","PSSMIGRD",181,0)
 . . D OUT^PSSMIGRC(" Error...Cannot obtain an IEN for NAME")
"RTN","PSSMIGRD",182,0)
 . . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.416,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",183,0)
 . ;
"RTN","PSSMIGRD",184,0)
 . ; Set Database Variables
"RTN","PSSMIGRD",185,0)
 . S DIE=DIC K DIC
"RTN","PSSMIGRD",186,0)
 . S DR="2///^S X=PRIMARY;3///^S X=IDATE;99.98///^S X=MVUID;99.99///^S X=VUID"
"RTN","PSSMIGRD",187,0)
 . S (PSS("IEN"),PIEN)=DA
"RTN","PSSMIGRD",188,0)
 . ;
"RTN","PSSMIGRD",189,0)
 . ; Update Database
"RTN","PSSMIGRD",190,0)
 . D ^DIE
"RTN","PSSMIGRD",191,0)
 . ; Stuff EFFECTIVE DATE/TIME entries
"RTN","PSSMIGRD",192,0)
 . S DIC="^PS(50.416,"_PIEN_",""TERMSTATUS"",",DIC(0)="L",DIC("P")="50.4169A"
"RTN","PSSMIGRD",193,0)
 . S DA(1)=PIEN,DA=1,X=EFFDT
"RTN","PSSMIGRD",194,0)
 . D FILE^DICN
"RTN","PSSMIGRD",195,0)
 . S DIE=DIC,DR=".02///^S X=STATUS"
"RTN","PSSMIGRD",196,0)
 . D ^DIE
"RTN","PSSMIGRD",197,0)
 . ; 
"RTN","PSSMIGRD",198,0)
 . ;
"RTN","PSSMIGRD",199,0)
 . ; Put LAYGO back
"RTN","PSSMIGRD",200,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.416,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",201,0)
 . ;L -^PS(50.416)
"RTN","PSSMIGRD",202,0)
 . ;
"RTN","PSSMIGRD",203,0)
 . ; Updating ^NDFK files
"RTN","PSSMIGRD",204,0)
 . ;
"RTN","PSSMIGRD",205,0)
 . I NAME]"" S X=NAME,DIC=5000.508,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRD",206,0)
 . ;
"RTN","PSSMIGRD",207,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRD",208,0)
 .S (DA,PIEN)=PSS("IEN"),DIE=50.416
"RTN","PSSMIGRD",209,0)
 .S PS5=$G(^PS(50.416,DA,0)),PSMV=$G(^PS(50.416,DA,"VUID")),DR="",PQ=""
"RTN","PSSMIGRD",210,0)
 .S OPN=$P(PS5,"^",2)
"RTN","PSSMIGRD",211,0)
 .S:+OPN OPN=$P($G(^PS(50.416,OPN,0)),"^")
"RTN","PSSMIGRD",212,0)
 .S:OPN'=PRIMARY DR="2///"_$S(PRIMARY]"":"^S X=PRIMARY",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRD",213,0)
 .S:$P($G(^PS(50.416,DA,2)),"^",1)'=IDATE DR=DR_PQ_"3///"_$S(IDATE]"":"^S X=IDATE",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRD",214,0)
 .;S CMVUID=$P(PSMV,"^",2),CMVUID=$S(CMVUID=1:"YES",CMVUID=0:"NO",1:"")
"RTN","PSSMIGRD",215,0)
 .S:$P(PSMV,"^",2)'=MVUID DR=DR_PQ_"99.98///^S X=MVUID" S:$L(DR) PQ=";"
"RTN","PSSMIGRD",216,0)
 .S:$P(PSMV,"^",1)'=VUID DR=DR_PQ_"99.99///^S X=VUID" S:$L(DR) PQ=";"
"RTN","PSSMIGRD",217,0)
 .;
"RTN","PSSMIGRD",218,0)
 .; Update Database
"RTN","PSSMIGRD",219,0)
 .D ^DIE
"RTN","PSSMIGRD",220,0)
 .;
"RTN","PSSMIGRD",221,0)
 ;
"RTN","PSSMIGRD",222,0)
 S XMESS="<message>  Updated Drug Ingredients: "_NAME_" </message>"
"RTN","PSSMIGRD",223,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRD",224,0)
 K DIC,DA,DR,DIE,^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",225,0)
 Q
"RTN","PSSMIGRD",226,0)
 ;
"RTN","PSSMIGRD",227,0)
VADC ;VA DRUG CLASS Sync
"RTN","PSSMIGRD",228,0)
 ;
"RTN","PSSMIGRD",229,0)
 N DA,DIE,DR,CLASS,CODE,PARENTCLASS,TYPE,RTYPE,DESC,VUID,MVUID,EFFDT,STATUS,PCIEN,PCODE
"RTN","PSSMIGRD",230,0)
 S PCLASS=$G(PSS("PCLASS")),PCODE=$G(PSS("PCODE")),PCIEN=$G(PSS("PCIEN"))
"RTN","PSSMIGRD",231,0)
 S CODE=$G(PSS("CLASSCODE")),CLASS=$G(PSS("CLASSCLASS")),TYPE=$G(PSS("TYPE"))
"RTN","PSSMIGRD",232,0)
 S RTYPE=$G(PSS("RTYPE")),DESC=$G(PSS("DESC")),VUID=$G(PSS("VUID"))
"RTN","PSSMIGRD",233,0)
 S MVUID=$G(PSS("MASTERVUID")),IEN=$G(PSS("IEN"))
"RTN","PSSMIGRD",234,0)
 S EFFDT=$G(PSS("EFFDATE")),STATUS=$G(PSS("STATUS")),DESC=$G(PSS("DESC"))
"RTN","PSSMIGRD",235,0)
 S FNUM=50.605,FNAME="syncResponse.XML",FNAME1="vaDrugClass"
"RTN","PSSMIGRD",236,0)
 ;
"RTN","PSSMIGRD",237,0)
 ; Quit if REQUIRED DATA is Missing
"RTN","PSSMIGRD",238,0)
 I CODE="" D OUT^PSSMIGRC(" Error...Missing Required VA DRUG CLASS CODE") Q
"RTN","PSSMIGRD",239,0)
 I MVUID="" D OUT^PSSMIGRC(" Error...Missing Required VA DRUG CLASS MASTER VUID") Q
"RTN","PSSMIGRD",240,0)
 I VUID="" D OUT^PSSMIGRC(" Error...Missing Required VA DRUG CLASS VUID") Q
"RTN","PSSMIGRD",241,0)
 I EFFDT="" D OUT^PSSMIGRC(" Error...Missing Required VA DRUG CLASS EFFECTIVE DATE") Q
"RTN","PSSMIGRD",242,0)
 I STATUS="" D OUT^PSSMIGRC(" Error...Missing Required VA DRUG CLASS STATUS") Q
"RTN","PSSMIGRD",243,0)
 ;
"RTN","PSSMIGRD",244,0)
 S EFFDT=$$DATE($G(PSS("EFFDATE")))
"RTN","PSSMIGRD",245,0)
 ;
"RTN","PSSMIGRD",246,0)
 ;Add the VA DRUG Class to the Database
"RTN","PSSMIGRD",247,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRD",248,0)
 . ; Lock the Global
"RTN","PSSMIGRD",249,0)
 . L +^PS(50.605):5 E  D OUT^PSSMIGRC(" *VA DRUG CLASS file NOT UPDATED. Another USER editing file") Q
"RTN","PSSMIGRD",250,0)
 . ;
"RTN","PSSMIGRD",251,0)
 . ; Cheating - Remove the check for LAYGO temporarly
"RTN","PSSMIGRD",252,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.605,.01,"LAYGO",.01,0))
"RTN","PSSMIGRD",253,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.605,.01,"LAYGO",.01,0)
"RTN","PSSMIGRD",254,0)
 . ;
"RTN","PSSMIGRD",255,0)
 . ; Get the IEN
"RTN","PSSMIGRD",256,0)
 . S X=CODE,DIC=50.605,DIC(0)="LMXZ"
"RTN","PSSMIGRD",257,0)
 . D ^DIC
"RTN","PSSMIGRD",258,0)
 . S (DA,PSS("IEN"),PIEN)=+Y
"RTN","PSSMIGRD",259,0)
 . ;
"RTN","PSSMIGRD",260,0)
 . ; Quit if cannot get IEN
"RTN","PSSMIGRD",261,0)
 . I Y<1 D  Q
"RTN","PSSMIGRD",262,0)
 . . D OUT^PSSMIGRC(" Error...Cannot obtain an IEN for VA DRUG CLASS - CLASS CODE")
"RTN","PSSMIGRD",263,0)
 . . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.605,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",264,0)
 . ;
"RTN","PSSMIGRD",265,0)
 . ; Set Database Variables
"RTN","PSSMIGRD",266,0)
 . S DIE=DIC K DIC
"RTN","PSSMIGRD",267,0)
 . S DR="1///^S X=CLASS;2///^S X=PCIEN;3///^S X=TYPE;4///^S X=DESC;"
"RTN","PSSMIGRD",268,0)
 . S DR=DR_"99.98///^S X=MVUID;99.99///^S X=VUID"
"RTN","PSSMIGRD",269,0)
 . ;
"RTN","PSSMIGRD",270,0)
 . ; Update Database
"RTN","PSSMIGRD",271,0)
 . D ^DIE
"RTN","PSSMIGRD",272,0)
 . ; Stuff EFFECTIVE DATE/TIME entries
"RTN","PSSMIGRD",273,0)
 . S DIC="^PS(50.605,"_PIEN_",""TERMSTATUS"",",DIC(0)="L",DIC("P")="50.60509DA"
"RTN","PSSMIGRD",274,0)
 . S DA(1)=PIEN,DA=1,X=EFFDT
"RTN","PSSMIGRD",275,0)
 . D FILE^DICN
"RTN","PSSMIGRD",276,0)
 . S DIE=DIC,DR=".02///^S X=STATUS"
"RTN","PSSMIGRD",277,0)
 . D ^DIE
"RTN","PSSMIGRD",278,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.605,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",279,0)
 . L -^PS(50.605)
"RTN","PSSMIGRD",280,0)
 ;
"RTN","PSSMIGRD",281,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRD",282,0)
 .S (DA,PIEN)=PSS("IEN"),DIE=50.605
"RTN","PSSMIGRD",283,0)
 .S PS5=$G(^PS(50.605,DA,0)),PSMV=$G(^PS(50.605,DA,"VUID")),DR="",PQ=""
"RTN","PSSMIGRD",284,0)
 .S:$P(PS5,"^",3)'=PCIEN DR="2///"_$S(PCIEN]"":"^S X=PCIEN",1:"@"),PQ=";"
"RTN","PSSMIGRD",285,0)
 .S:$P(PS5,"^",4)'=TYPE DR=DR_PQ_"3///^S X=TYPE",PQ=";"
"RTN","PSSMIGRD",286,0)
 .S:$P($G(^PS(50.605,DA,1)),"^",1)'=DESC DR=DR_PQ_"4///^S X=DESC",PQ=";"
"RTN","PSSMIGRD",287,0)
 .;S CMVUID=$P(PSMV,"^",2),CMVUID=$S(CMVUID=1:"YES",CMVUID=0:"NO",1:"")
"RTN","PSSMIGRD",288,0)
 .S:$P(PSMV,"^",2)'=MVUID DR=DR_PQ_"99.98///^S X=MVUID" S:$L(DR) PQ=";"
"RTN","PSSMIGRD",289,0)
 .S:$P(PSMV,"^",1)'=VUID DR=DR_PQ_"99.99///^S X=VUID" S:$L(DR) PQ=";"
"RTN","PSSMIGRD",290,0)
 . ;
"RTN","PSSMIGRD",291,0)
 . ; Update Database
"RTN","PSSMIGRD",292,0)
 . D ^DIE
"RTN","PSSMIGRD",293,0)
 ;
"RTN","PSSMIGRD",294,0)
 S XMESS="<message>  Updated Drug Class "_CODE_" </message>"
"RTN","PSSMIGRD",295,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRD",296,0)
 Q
"RTN","PSSMIGRD",297,0)
 ;
"RTN","PSSMIGRD",298,0)
DSFO ;DOSAGE FORM Sync
"RTN","PSSMIGRD",299,0)
 ;
"RTN","PSSMIGRD",300,0)
 ;
"RTN","PSSMIGRD",301,0)
 N X,Y,DIC,DA,DR,DIE,NAME,EXCLUDE,PACKAGE,PDPACKAGE,PERDOSE,UNIT,PIEN
"RTN","PSSMIGRD",302,0)
 S NAME=$G(PSS("NAME")),EXCLUDE=$G(PSS("EXCLUDE")),RTYPE=$G(PSS("RTYPE"))
"RTN","PSSMIGRD",303,0)
 S IDATE=$TR($P($G(PSS("INACTDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE)
"RTN","PSSMIGRD",304,0)
 S PERDOSE=$G(PSS("PERDOSE")),PDPACKAGE=$G(PSS("PDPACKAGE"))
"RTN","PSSMIGRD",305,0)
 S UNIT=$G(PSS("UNITS")),PACKAGE=$G(PSS("PACKAGE"))
"RTN","PSSMIGRD",306,0)
 S FNUM=50.606,FNAME="syncResponse.XML",FNAME1="dosageForm"
"RTN","PSSMIGRD",307,0)
 ;
"RTN","PSSMIGRD",308,0)
 I NAME="" D OUT^PSSMIGRC(" Error...Missing Required DOSAGE FORM NAME") Q
"RTN","PSSMIGRD",309,0)
 I EXCLUDE="" D OUT^PSSMIGRC(" Error...Missing Required Exclude From Dosage Checks FLAG") Q
"RTN","PSSMIGRD",310,0)
 I RTYPE'="ADD",RTYPE'="MODIFY"  D OUT^PSSMIGRC("Error...Invalid Request Type") Q
"RTN","PSSMIGRD",311,0)
 ;
"RTN","PSSMIGRD",312,0)
 ;Add the DOSAGE FORM to the Database 
"RTN","PSSMIGRD",313,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRD",314,0)
 . ;L +^PS(50.606):5 E  D OUT^PSSMIGRC(" Another USER editing DOSAGE FORM file") Q
"RTN","PSSMIGRD",315,0)
 . ;L -^PS(50.606)
"RTN","PSSMIGRD",316,0)
 . ;
"RTN","PSSMIGRD",317,0)
 . ; Cheating - Remove the check for LAYGO temporarly
"RTN","PSSMIGRD",318,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.606,.01,"LAYGO",.01,0))
"RTN","PSSMIGRD",319,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.606,.01,"LAYGO",.01,0)
"RTN","PSSMIGRD",320,0)
 . ;
"RTN","PSSMIGRD",321,0)
 . ; Get the IEN
"RTN","PSSMIGRD",322,0)
 . S X=NAME,DIC=50.606,DIC(0)="LMXZ"
"RTN","PSSMIGRD",323,0)
 . D ^DIC I Y<1 K DIC,DA Q
"RTN","PSSMIGRD",324,0)
 . ;
"RTN","PSSMIGRD",325,0)
 . ; Set Database Variables
"RTN","PSSMIGRD",326,0)
 . S DIE=DIC K DIC
"RTN","PSSMIGRD",327,0)
 . S DA=+Y
"RTN","PSSMIGRD",328,0)
 . S DR="7///^S X=IDATE;11///^S X=EXCLUDE"
"RTN","PSSMIGRD",329,0)
 . S (PSS("IEN"),PIEN)=DA
"RTN","PSSMIGRD",330,0)
 . ;
"RTN","PSSMIGRD",331,0)
 . ; Update Database
"RTN","PSSMIGRD",332,0)
 . D ^DIE
"RTN","PSSMIGRD",333,0)
 . ;
"RTN","PSSMIGRD",334,0)
 . D DUPD
"RTN","PSSMIGRD",335,0)
 . ;
"RTN","PSSMIGRD",336,0)
 . ; Put LAYGO back
"RTN","PSSMIGRD",337,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.606,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",338,0)
 ;
"RTN","PSSMIGRD",339,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRD",340,0)
 . S DA=PSS("IEN"),DIE=50.606
"RTN","PSSMIGRD",341,0)
 . S PS5=$G(^PS(50.606,DA,0)),DR="",PQ=""
"RTN","PSSMIGRD",342,0)
 . S:$P(PS5,"^",2)'=IDATE DR="7///"_$S(IDATE]"":"^S X=IDATE",1:"@"),PQ=";"
"RTN","PSSMIGRD",343,0)
 . S PSX=$P($G(^PS(50.606,DA,1)),"^",1),PSX=$S(PSX=0:"NO",PSX=1:"YES",1:"")
"RTN","PSSMIGRD",344,0)
 . S:PSX'=EXCLUDE DR=DR_PQ_"11///^S X=EXCLUDE"
"RTN","PSSMIGRD",345,0)
 . ;
"RTN","PSSMIGRD",346,0)
 . ; Update Database
"RTN","PSSMIGRD",347,0)
 . D ^DIE
"RTN","PSSMIGRD",348,0)
 . S PIEN=DA
"RTN","PSSMIGRD",349,0)
 . D DUPD
"RTN","PSSMIGRD",350,0)
 ;
"RTN","PSSMIGRD",351,0)
 ;
"RTN","PSSMIGRD",352,0)
 ;
"RTN","PSSMIGRD",353,0)
 Q:$G(ERROR)=1
"RTN","PSSMIGRD",354,0)
 ;
"RTN","PSSMIGRD",355,0)
 S XMESS="<message> <![CDATA[ Updated Dosage Form "_NAME_"]]> </message>"
"RTN","PSSMIGRD",356,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRD",357,0)
 K DIC,DA,DR,DIE,^TMP("AJF LAYGO",$J),^TMP("AJF LAYGO DF",$J),^TMP("AJF LAYGO UT",$J)
"RTN","PSSMIGRD",358,0)
 Q
"RTN","PSSMIGRD",359,0)
 ;
"RTN","PSSMIGRD",360,0)
DUPD ;
"RTN","PSSMIGRD",361,0)
 ;
"RTN","PSSMIGRD",362,0)
 I +PERDOSE D
"RTN","PSSMIGRD",363,0)
 . N CNT,UPACK,DA,PSDUPD S (DA,CNT)=0
"RTN","PSSMIGRD",364,0)
 . S DIC="^PS(50.606,"_PIEN_",""DUPD"",",DIC(0)="L",DIC("P")="50.6069"
"RTN","PSSMIGRD",365,0)
 . ; Cheating - Remove the check for LAYGO temporarly
"RTN","PSSMIGRD",366,0)
 . S ^TMP("AJF LAYGO DF",$J)=$G(^DD(50.6069,.01,"LAYGO",1,0))
"RTN","PSSMIGRD",367,0)
 . I ^TMP("AJF LAYGO DF",$J)]"" K ^DD(50.6069,.01,"LAYGO",1,0)
"RTN","PSSMIGRD",368,0)
 . F CNT=1:1:PERDOSE Q:'$D(PSS("PDDOSE"_CNT))  D
"RTN","PSSMIGRD",369,0)
 .. S DA=$O(^PS(50.606,PIEN,"DUPD","B",PSS("PDDOSE"_CNT),""))
"RTN","PSSMIGRD",370,0)
 .. I '+DA S DA(1)=PIEN,DA=CNT,X=PSS("PDDOSE"_CNT) D FILE^DICN
"RTN","PSSMIGRD",371,0)
 .. S DA(1)=PIEN,OPACK="",PSDUPD(PSS("PDDOSE"_CNT))=""
"RTN","PSSMIGRD",372,0)
 .. S DA=$O(^PS(50.606,PIEN,"DUPD","B",PSS("PDDOSE"_CNT),""))
"RTN","PSSMIGRD",373,0)
 .. S:+DA OPACK=$P(^PS(50.606,PIEN,"DUPD",DA,0),"^",2)
"RTN","PSSMIGRD",374,0)
 .. S UPACK=$G(PSS("PDPACKAGE"_CNT))
"RTN","PSSMIGRD",375,0)
 .. I OPACK'=UPACK S DIE=DIC,DR="1///"_$S(UPACK]"":"^S X=UPACK",1:"@") D ^DIE
"RTN","PSSMIGRD",376,0)
 . ;
"RTN","PSSMIGRD",377,0)
 . ; Removing old entries from multiple
"RTN","PSSMIGRD",378,0)
 . S CNT=0,DIK="^PS(50.606,"_PIEN_",""DUPD"",",DA(1)=PIEN
"RTN","PSSMIGRD",379,0)
 . F  S CNT=$O(^PS(50.606,PIEN,"DUPD","B",CNT)) Q:CNT=""  D
"RTN","PSSMIGRD",380,0)
 .. Q:$D(PSDUPD(CNT))
"RTN","PSSMIGRD",381,0)
 .. S DA=$O(^PS(50.606,PIEN,"DUPD","B",CNT,""))
"RTN","PSSMIGRD",382,0)
 .. D ^DIK
"RTN","PSSMIGRD",383,0)
 . S:^TMP("AJF LAYGO DF",$J)]"" ^DD(50.6069,.01,"LAYGO",1,0)=^TMP("AJF LAYGO DF",$J)
"RTN","PSSMIGRD",384,0)
 ;
"RTN","PSSMIGRD",385,0)
 ;
"RTN","PSSMIGRD",386,0)
 I +UNIT D
"RTN","PSSMIGRD",387,0)
 . N CNT,UPACK,DA,PSUNITS S (DA,CNT)=0
"RTN","PSSMIGRD",388,0)
 . S DIC="^PS(50.606,"_PIEN_",""UNIT"",",DIC(0)="L",DIC("P")="50.6068P"
"RTN","PSSMIGRD",389,0)
 . ; Cheating - Remove the check for LAYGO temporarly
"RTN","PSSMIGRD",390,0)
 . S ^TMP("AJF LAYGO UT",$J)=$G(^DD(50.6068,.01,"LAYGO",1,0))
"RTN","PSSMIGRD",391,0)
 . I ^TMP("AJF LAYGO UT",$J)]"" K ^DD(50.6068,.01,"LAYGO",1,0)
"RTN","PSSMIGRD",392,0)
 . ;
"RTN","PSSMIGRD",393,0)
 . F CNT=1:1:UNIT Q:'$D(PSS("UNITS"_CNT))  D
"RTN","PSSMIGRD",394,0)
 .. S DA=$O(^PS(50.606,PIEN,"UNIT","B",PSS("UNITSIEN"_CNT),""))
"RTN","PSSMIGRD",395,0)
 .. I '+DA S DA(1)=PIEN,DA=CNT,X=PSS("UNITSIEN"_CNT) D FILE^DICN
"RTN","PSSMIGRD",396,0)
 .. S DA(1)=PIEN,OPACK="",PSUNITS(PSS("UNITSIEN"_CNT))=""
"RTN","PSSMIGRD",397,0)
 .. S DA=$O(^PS(50.606,PIEN,"UNIT","B",PSS("UNITSIEN"_CNT),""))
"RTN","PSSMIGRD",398,0)
 .. S:+DA OPACK=$P(^PS(50.606,PIEN,"UNIT",DA,0),"^",2)
"RTN","PSSMIGRD",399,0)
 .. S UPACK=$G(PSS("PACKAGE"_CNT))
"RTN","PSSMIGRD",400,0)
 .. I OPACK'=UPACK S DIE=DIC,DR="1///"_$S(UPACK]"":"^S X=UPACK",1:"@") D ^DIE
"RTN","PSSMIGRD",401,0)
 . ;
"RTN","PSSMIGRD",402,0)
 . ; Removing old entries from multiple
"RTN","PSSMIGRD",403,0)
 . S CNT=0,DIK="^PS(50.606,"_PIEN_",""UNIT"",",DA(1)=PIEN
"RTN","PSSMIGRD",404,0)
 . F  S CNT=$O(^PS(50.606,PIEN,"UNIT","B",CNT)) Q:CNT=""  D
"RTN","PSSMIGRD",405,0)
 .. Q:$D(PSUNITS(CNT))
"RTN","PSSMIGRD",406,0)
 .. S DA=$O(^PS(50.606,PIEN,"UNIT","B",CNT,""))
"RTN","PSSMIGRD",407,0)
 .. D ^DIK
"RTN","PSSMIGRD",408,0)
 . S:^TMP("AJF LAYGO UT",$J)]"" ^DD(50.6068,.01,"LAYGO",1,0)=^TMP("AJF LAYGO UT",$J)
"RTN","PSSMIGRD",409,0)
 ;
"RTN","PSSMIGRD",410,0)
 ;
"RTN","PSSMIGRD",411,0)
 ;
"RTN","PSSMIGRD",412,0)
DATE(DT) ; Format date time
"RTN","PSSMIGRD",413,0)
 ;
"RTN","PSSMIGRD",414,0)
 Q:$L(DT)="" ""
"RTN","PSSMIGRD",415,0)
 S FDT=$TR($P($G(DT),"T"),"-","")
"RTN","PSSMIGRD",416,0)
 ;S $TR($P(DT,"."),":",""),FDT=$TR(FDT,"-",""),FDT=$TR(FDT,"T","")
"RTN","PSSMIGRD",417,0)
 S FDT=$$HL7TFM^XLFDT(FDT,"L")
"RTN","PSSMIGRD",418,0)
 Q FDT
"RTN","PSSMIGRD",419,0)
 ;
"RTN","PSSMIGRE")
0^3^B170727260
"RTN","PSSMIGRE",1,0)
PSSMIGRE ;AJF - Process Sync XML message from PEPS;  6/19/2012 0840
"RTN","PSSMIGRE",2,0)
 ;;1.0;PHARMACY ENTERPRISE PRODUCT SYSTEM;;7/11/2008;Build 39
"RTN","PSSMIGRE",3,0)
 ;;
"RTN","PSSMIGRE",4,0)
 ; Process Sync request 
"RTN","PSSMIGRE",5,0)
 ; Called from ^PSSMIGRD
"RTN","PSSMIGRE",6,0)
 ;;
"RTN","PSSMIGRE",7,0)
 Q
"RTN","PSSMIGRE",8,0)
 ;
"RTN","PSSMIGRE",9,0)
MAN ; Manufacturer file Sync
"RTN","PSSMIGRE",10,0)
 ;
"RTN","PSSMIGRE",11,0)
 ;
"RTN","PSSMIGRE",12,0)
 N X,Y,DIC,DA,DR,DIE,IEN,NAME,RTYPE,IDATE
"RTN","PSSMIGRE",13,0)
 I PSS("NAME")="" D OUT^PSSMIGRC(" Error...Missing Required NAME") Q
"RTN","PSSMIGRE",14,0)
 S NAME=$G(PSS("NAME")),IEN=$G(PSS("IEN")),RTYPE=$G(PSS("RTYPE"))
"RTN","PSSMIGRE",15,0)
 S IDATE=$TR($P($G(PSS("IDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE)
"RTN","PSSMIGRE",16,0)
 S FNAME="syncResponse.XML",FNUM=55.95
"RTN","PSSMIGRE",17,0)
 S FNAME1="Manufacturer"
"RTN","PSSMIGRE",18,0)
 ;
"RTN","PSSMIGRE",19,0)
 ;Add the Manufacturer to the Database
"RTN","PSSMIGRE",20,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRE",21,0)
 . ; Lock the Global
"RTN","PSSMIGRE",22,0)
 . L +^PS(55.95):5 E  D OUT^PSSMIGRC(" Another USER editing Manufacturer file") Q
"RTN","PSSMIGRE",23,0)
 . ;
"RTN","PSSMIGRE",24,0)
 . ; Cheating - Remove LAYGO temporarly
"RTN","PSSMIGRE",25,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(55.95,.01,"LAYGO",.01,0))
"RTN","PSSMIGRE",26,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(55.95,.01,"LAYGO",.01,0)
"RTN","PSSMIGRE",27,0)
 . ;
"RTN","PSSMIGRE",28,0)
 . ; Get the IEN
"RTN","PSSMIGRE",29,0)
 . S X=NAME,DIC=55.95,DIC(0)="LMXZ"
"RTN","PSSMIGRE",30,0)
 . D ^DIC
"RTN","PSSMIGRE",31,0)
 . S (DA,PSS("IEN"))=+Y
"RTN","PSSMIGRE",32,0)
 . ;
"RTN","PSSMIGRE",33,0)
 . ; Quit if cannot get IEN
"RTN","PSSMIGRE",34,0)
 . I Y<1 D  Q:'$L(DA)
"RTN","PSSMIGRE",35,0)
 . . S DA=$O(^PS(55.95,"B",NAME,""))
"RTN","PSSMIGRE",36,0)
 . . Q:$L(DA)
"RTN","PSSMIGRE",37,0)
 . . D OUT^PSSMIGRC(" Error...Cannot obtain an IEN for "_NAME)
"RTN","PSSMIGRE",38,0)
 . . S:^TMP("AJF LAYGO",$J)]"" ^DD(55.95,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",39,0)
 . ;
"RTN","PSSMIGRE",40,0)
 . ; Set Database Variables
"RTN","PSSMIGRE",41,0)
 . S PSS("IEN")=DA,DIE=DIC K DIC
"RTN","PSSMIGRE",42,0)
 . S DR="2///^S X=IDATE"
"RTN","PSSMIGRE",43,0)
 . ;
"RTN","PSSMIGRE",44,0)
 . ; Update Database
"RTN","PSSMIGRE",45,0)
 . D ^DIE
"RTN","PSSMIGRE",46,0)
 . ;
"RTN","PSSMIGRE",47,0)
 . ; Put LAYGO back
"RTN","PSSMIGRE",48,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(55.95,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",49,0)
 . L -^PS(55.95)
"RTN","PSSMIGRE",50,0)
 ;
"RTN","PSSMIGRE",51,0)
 Q:$G(ERORR)=1
"RTN","PSSMIGRE",52,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRE",53,0)
 .S DA=PSS("IEN"),DIE=55.95
"RTN","PSSMIGRE",54,0)
 .S PS5=$G(^PS(55.95,DA,0)),DR="",PQ=""
"RTN","PSSMIGRE",55,0)
 .S:$P(PS5,"^",1)'=NAME DR=".01///^S X=NAME" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",56,0)
 .S DR=DR_PQ_"2///"_$S(IDATE]"":"^S X=IDATE",1:"@")
"RTN","PSSMIGRE",57,0)
 .;S DR=".01///^S X=NAME;2///"_$S(IDATE]"":"^S X=IDATE",1:"@")
"RTN","PSSMIGRE",58,0)
 .D ^DIE
"RTN","PSSMIGRE",59,0)
 ;
"RTN","PSSMIGRE",60,0)
 S XMESS="<message>  Updated Manufactrer: "_NAME_" </message>"
"RTN","PSSMIGRE",61,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRE",62,0)
 K DIC,DA,DR,DIE,^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",63,0)
 Q
"RTN","PSSMIGRE",64,0)
 ;
"RTN","PSSMIGRE",65,0)
PTYP ; PACKAGE TYPE file Synch
"RTN","PSSMIGRE",66,0)
 ;
"RTN","PSSMIGRE",67,0)
 N X,Y,DIC,DA,DR,DIE,IEN,NAME,RTYPE,IDATE
"RTN","PSSMIGRE",68,0)
 I PSS("NAME")="" D OUT^PSSMIGRC(" Error...Missing Required NAME") Q
"RTN","PSSMIGRE",69,0)
 S NAME=$G(PSS("NAME")),IEN=$G(PSS("IEN")),RTYPE=$G(PSS("RTYPE"))
"RTN","PSSMIGRE",70,0)
 S IDATE=$TR($P($G(PSS("IDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE,"L")
"RTN","PSSMIGRE",71,0)
 S FNAME="syncResponse.XML",FNUM=50.608
"RTN","PSSMIGRE",72,0)
 S FNAME1="packageType"
"RTN","PSSMIGRE",73,0)
 ;
"RTN","PSSMIGRE",74,0)
 ;Add the PACKAGE TYPE to the Database
"RTN","PSSMIGRE",75,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRE",76,0)
 . ; Lock the Global
"RTN","PSSMIGRE",77,0)
 . L +^PS(50.608):5 E  D OUT^PSSMIGRC(" Another USER editing PACKAGE TYPE file") Q
"RTN","PSSMIGRE",78,0)
 . ;
"RTN","PSSMIGRE",79,0)
 . ; Cheating - Remove LAYGO temporarly
"RTN","PSSMIGRE",80,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.608,.01,"LAYGO",.01,0))
"RTN","PSSMIGRE",81,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.608,.01,"LAYGO",.01,0)
"RTN","PSSMIGRE",82,0)
 . ;
"RTN","PSSMIGRE",83,0)
 . ; Get the IEN
"RTN","PSSMIGRE",84,0)
 . S X=NAME,DIC=50.608,DIC(0)="LMXZ"
"RTN","PSSMIGRE",85,0)
 . D ^DIC
"RTN","PSSMIGRE",86,0)
 . S (DA,PSS("IEN"))=+Y
"RTN","PSSMIGRE",87,0)
 . ;
"RTN","PSSMIGRE",88,0)
 . ; Quit if cannot get IEN
"RTN","PSSMIGRE",89,0)
 . I Y<1 D  Q
"RTN","PSSMIGRE",90,0)
 . . D OUT^PSSMIGRC(" Error...Cannot obtain an IEN for NAME")
"RTN","PSSMIGRE",91,0)
 . . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.608,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",92,0)
 . ;
"RTN","PSSMIGRE",93,0)
 . ; Set Database Variables
"RTN","PSSMIGRE",94,0)
 . S PSS("IEN")=DA,DIE=DIC K DIC
"RTN","PSSMIGRE",95,0)
 . ;S DR=".01///^S X=NAME;1///^S X=IDATE"
"RTN","PSSMIGRE",96,0)
 . S DR="1///^S X=IDATE"
"RTN","PSSMIGRE",97,0)
 . ;
"RTN","PSSMIGRE",98,0)
 . ; Update Database
"RTN","PSSMIGRE",99,0)
 . D ^DIE
"RTN","PSSMIGRE",100,0)
 . ;
"RTN","PSSMIGRE",101,0)
 . ; Put LAYGO back
"RTN","PSSMIGRE",102,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.608,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",103,0)
 . L -^PS(50.608)
"RTN","PSSMIGRE",104,0)
 ;
"RTN","PSSMIGRE",105,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRE",106,0)
 .S DA=PSS("IEN"),DIE=50.608
"RTN","PSSMIGRE",107,0)
 .S PS5=$G(^PS(50.608,DA,0)),DR="",PQ=""
"RTN","PSSMIGRE",108,0)
 .S:$P(PS5,"^",1)'=NAME DR=".01///^S X=NAME" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",109,0)
 .S DR=DR_PQ_"1///"_$S(IDATE]"":"^S X=IDATE",1:"@")
"RTN","PSSMIGRE",110,0)
 .;S DR=".01///^S X=NAME;1///"_$S(IDATE]"":"^S X=IDATE",1:"@")
"RTN","PSSMIGRE",111,0)
 .D ^DIE
"RTN","PSSMIGRE",112,0)
 ;
"RTN","PSSMIGRE",113,0)
 S XMESS="<message>  Updated Package Type: "_NAME_" </message>"
"RTN","PSSMIGRE",114,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRE",115,0)
 K DIC,DA,DR,DIE,^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",116,0)
 Q
"RTN","PSSMIGRE",117,0)
 ;
"RTN","PSSMIGRE",118,0)
NDC ;  Synch for NDC
"RTN","PSSMIGRE",119,0)
 ;
"RTN","PSSMIGRE",120,0)
 N X,Y,DIC,DA,DR,DIE,IEN,NAME,RTYPE,IDATE,TNAME,MNAME,MIEN,PNAME,PIEN,PSIZE,PTYPE,PTIEN
"RTN","PSSMIGRE",121,0)
 N PSOTC,NIEN,PSO,SCK,SIEN,UPN,VAPRO
"RTN","PSSMIGRE",122,0)
 ;
"RTN","PSSMIGRE",123,0)
 I PSS("NAME")="" D OUT^PSSMIGRC(" Error...Missing Required NAME") Q
"RTN","PSSMIGRE",124,0)
 S NAME=$G(PSS("NAME")),IEN=$G(PSS("IEN")),RTYPE=$G(PSS("RTYPE")),TNAME=$G(PSS("TNAME"))
"RTN","PSSMIGRE",125,0)
 S IDATE=$TR($P($G(PSS("IDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE,"L")
"RTN","PSSMIGRE",126,0)
 S MNAME=$G(PSS("MNAME")),MIEN=$G(PSS("MIEN")),PNAME=$G(PSS("PNAME")),PIEN=$G(PSS("PIEN"))
"RTN","PSSMIGRE",127,0)
 S PSIZE=$G(PSS("PSIZE")),PTYPE=$G(PSS("PTYPE")),PTIEN=$G(PSS("PTIEN"))
"RTN","PSSMIGRE",128,0)
 S PSOTC=$G(PSS("PSOTC")),UPN=$G(PSS("UPN"))
"RTN","PSSMIGRE",129,0)
 S FNAME="syncResponse.XML",FNUM=50.67
"RTN","PSSMIGRE",130,0)
 S FNAME1="NDC",NAME=$TR(NAME,"-","")
"RTN","PSSMIGRE",131,0)
 ;
"RTN","PSSMIGRE",132,0)
 ;
"RTN","PSSMIGRE",133,0)
 ; Adding Package Size
"RTN","PSSMIGRE",134,0)
 I PSIZE'="" S SIEN="",SCK=0 D
"RTN","PSSMIGRE",135,0)
 .F  S SIEN=$O(^PS(50.609,"B",PSIZE,SIEN)) Q:SIEN=""  D  Q:+SCK
"RTN","PSSMIGRE",136,0)
 ..S:$P(^PS(50.609,SIEN,0),"^",2)="" SCK=1
"RTN","PSSMIGRE",137,0)
 I SIEN="" N PSNUM,PSCNT L +^PS(50.609,0):0 I $T D
"RTN","PSSMIGRE",138,0)
 .S PS0=^PS(50.609,0),PSCNT=$P(PS0,"^",3)+1,PSNUM=$P(PS0,"^",4)+1
"RTN","PSSMIGRE",139,0)
 .S $P(^PS(50.609,0),"^",3)=PSCNT,$P(^PS(50.609,0),"^",4)=PSNUM
"RTN","PSSMIGRE",140,0)
 .L -^PS(50.609,0)
"RTN","PSSMIGRE",141,0)
 .S SIEN=PSCNT
"RTN","PSSMIGRE",142,0)
 .;S ^PS(50.609,SIEN,0)=PSIZE
"RTN","PSSMIGRE",143,0)
 .;S ^PS(50.609,"B",PSIZE,SIEN)=""
"RTN","PSSMIGRE",144,0)
 .S DA=SIEN,DIE="^PS(50.609,"
"RTN","PSSMIGRE",145,0)
 .S DR=".01///^S X=PSIZE"
"RTN","PSSMIGRE",146,0)
 .D ^DIE
"RTN","PSSMIGRE",147,0)
 ;
"RTN","PSSMIGRE",148,0)
 ;
"RTN","PSSMIGRE",149,0)
 ;Add NDC to the Database
"RTN","PSSMIGRE",150,0)
 D:RTYPE="ADD"  Q:ERROR=1
"RTN","PSSMIGRE",151,0)
 . S NIEN=$O(^PSNDF(50.67,"NDC",NAME,""))
"RTN","PSSMIGRE",152,0)
 . ; Create new NDC entry
"RTN","PSSMIGRE",153,0)
 . I NIEN="" D
"RTN","PSSMIGRE",154,0)
 .. ; Lock the Global
"RTN","PSSMIGRE",155,0)
 .. L +^PSNDF(50.67):5 E  D OUT^PSSMIGRC(" Another USER editing NDC file") Q
"RTN","PSSMIGRE",156,0)
 .. ;S PS0=^PSNDF(50.67,0),PSCNT=$P(PS0,"^",3)+1,PSNUM=$P(PS0,"^",4)+1
"RTN","PSSMIGRE",157,0)
 .. ;S $P(^PSNDF(50.67,0),"^",3)=PSCNT,$P(^PSNDF(50.67,0),"^",4)=PSNUM
"RTN","PSSMIGRE",158,0)
 .. ;L -^PSNDF(50.67,0)
"RTN","PSSMIGRE",159,0)
 .. ;S NIEN=PSCNT
"RTN","PSSMIGRE",160,0)
 .. ;S ^PSNDF(50.67,NIEN,0)=NIEN
"RTN","PSSMIGRE",161,0)
 .. ;S ^PSNDF(50.67,"NDC",NAME,NIEN)=""
"RTN","PSSMIGRE",162,0)
 .. ;
"RTN","PSSMIGRE",163,0)
 .. S PS0=^PSNDF(50.67,0),PSCNT=$P(PS0,"^",3)+1
"RTN","PSSMIGRE",164,0)
 .. S $P(^PSNDF(50.67,0),"^",3)=PSCNT
"RTN","PSSMIGRE",165,0)
 .. L -^PSNDF(50.67,0)
"RTN","PSSMIGRE",166,0)
 .. S X=PSCNT,DIC=50.67,DIC(0)="LMXZ"
"RTN","PSSMIGRE",167,0)
 .. D ^DIC
"RTN","PSSMIGRE",168,0)
 .. S:Y'="-1" NIEN=$P(Y,"^")
"RTN","PSSMIGRE",169,0)
 . ;
"RTN","PSSMIGRE",170,0)
 . ; Cheating - Remove LAYGO temporarly
"RTN","PSSMIGRE",171,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.67,.01,"LAYGO",.01,0))
"RTN","PSSMIGRE",172,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.67,.01,"LAYGO",.01,0)
"RTN","PSSMIGRE",173,0)
 . ;
"RTN","PSSMIGRE",174,0)
 . I NIEN="" D OUT^PSSMIGRC(" Error... Unable To Create NEW IEN") Q 
"RTN","PSSMIGRE",175,0)
 . ;
"RTN","PSSMIGRE",176,0)
 . ;
"RTN","PSSMIGRE",177,0)
 . ;
"RTN","PSSMIGRE",178,0)
 . ; Set Database Variables
"RTN","PSSMIGRE",179,0)
 . ;
"RTN","PSSMIGRE",180,0)
 . ;
"RTN","PSSMIGRE",181,0)
 . S NDF0=$G(^PSNDF(50.67,NIEN,0))
"RTN","PSSMIGRE",182,0)
 . S (DA,PSS("IEN"))=NIEN,DIE="^PSNDF(50.67,",DR="",PQ=""
"RTN","PSSMIGRE",183,0)
 . S:$P(NDF0,"^",2)'=NAME DR="1///^S X=NAME" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",184,0)
 . S:$P(NDF0,"^",3)'=UPN DR=DR_PQ_"2///"_$S(UPN]"":"^S X=UPN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",185,0)
 . S:$P(NDF0,"^",4)'=MIEN DR=DR_PQ_"3///^S X=MIEN" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",186,0)
 . S:$P(NDF0,"^",5)'=TNAME DR=DR_PQ_"4///"_$S(TNAME]"":"^S X=TNAME",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",187,0)
 . S:$P(NDF0,"^",6)'=PIEN DR=DR_PQ_"5///^S X=PIEN" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",188,0)
 . S:$P(NDF0,"^",7)'=IDATE DR=DR_PQ_"7///"_$S(IDATE]"":"^S X=IDATE",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",189,0)
 . S:$P(NDF0,"^",8)'=SIEN DR=DR_PQ_"8///"_$S(SIEN]"":"^S X=SIEN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",190,0)
 . S:$P(NDF0,"^",9)'=PTIEN DR=DR_PQ_"9///"_$S(PTIEN]"":"^S X=PTIEN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",191,0)
 . S PSOT=$S(PSOTC="Prescription":"R",PSOTC="Over the Counter":"O",1:"")
"RTN","PSSMIGRE",192,0)
 . S:$P(NDF0,"^",10)'=PSOT DR=DR_PQ_"10///"_$S(PSOTC]"":"^S X=PSOTC",1:"@")
"RTN","PSSMIGRE",193,0)
 . ;
"RTN","PSSMIGRE",194,0)
 . ; Update Database
"RTN","PSSMIGRE",195,0)
 . D ^DIE
"RTN","PSSMIGRE",196,0)
 . ;
"RTN","PSSMIGRE",197,0)
 . ;
"RTN","PSSMIGRE",198,0)
 . I '$D(^PSNDF(50.67,NIEN,1,0)) D
"RTN","PSSMIGRE",199,0)
 .. ; Stuff ROUTE OF ADMINISTRATION entries
"RTN","PSSMIGRE",200,0)
 .. S DIC="^PSNDF(50.67,"_NIEN_",1,",DIC(0)="L",DIC("P")="50.676A"
"RTN","PSSMIGRE",201,0)
 .. S DA(1)=NIEN,DA=1,X="N/A" D FILE^DICN
"RTN","PSSMIGRE",202,0)
 .. ;
"RTN","PSSMIGRE",203,0)
 . ;
"RTN","PSSMIGRE",204,0)
 . S NIEN2=NIEN
"RTN","PSSMIGRE",205,0)
 . F  S NIEN2=$O(^PSNDF(50.67,"NDC",NAME,NIEN2)) Q:NIEN2=""  D
"RTN","PSSMIGRE",206,0)
 .. D DT^DICRW S DA=NIEN2,DIE=50.67,IDATE=DT,DR=""
"RTN","PSSMIGRE",207,0)
 .. S DR="7///^S X=IDATE"
"RTN","PSSMIGRE",208,0)
 .. S:$P(NDF0,"^",2)'=NAME DR=";1///^S X=NAME"
"RTN","PSSMIGRE",209,0)
 .. S:$P(NDF0,"^",3)'=UPN DR=DR_";2///"_$S(UPN]"":"^S X=UPN",1:"@")
"RTN","PSSMIGRE",210,0)
 .. S:$P(NDF0,"^",4)'=MIEN DR=DR_";3///^S X=MIEN"
"RTN","PSSMIGRE",211,0)
 .. S:$P(NDF0,"^",5)'=TNAME DR=DR_";4///"_$S(TNAME]"":"^S X=TNAME",1:"@")
"RTN","PSSMIGRE",212,0)
 .. S:$P(NDF0,"^",6)'=PIEN DR=DR_";5///^S X=PIEN"
"RTN","PSSMIGRE",213,0)
 .. S:$P(NDF0,"^",8)'=SIEN DR=DR_";8///"_$S(SIEN]"":"^S X=SIEN",1:"@")
"RTN","PSSMIGRE",214,0)
 .. S:$P(NDF0,"^",9)'=PTIEN DR=DR_";9///"_$S(PTIEN]"":"^S X=PTIEN",1:"@")
"RTN","PSSMIGRE",215,0)
 .. S PSOT=$S(PSOTC="Prescription":"R",PSOTC="Over the Counter":"O",1:"")
"RTN","PSSMIGRE",216,0)
 .. S:$P(NDF0,"^",10)'=PSOT DR=DR_";10///"_$S(PSOTC]"":"^S X=PSOTC",1:"@")
"RTN","PSSMIGRE",217,0)
 .. D ^DIE
"RTN","PSSMIGRE",218,0)
 . ;
"RTN","PSSMIGRE",219,0)
 . ; Put LAYGO back
"RTN","PSSMIGRE",220,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.67,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",221,0)
 . L -^PSNDF(50.67)
"RTN","PSSMIGRE",222,0)
 ;
"RTN","PSSMIGRE",223,0)
 Q:$G(ERORR)=1
"RTN","PSSMIGRE",224,0)
 ;
"RTN","PSSMIGRE",225,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRE",226,0)
 . S DA=PSS("IEN"),DIE=50.67
"RTN","PSSMIGRE",227,0)
 . S NAME1=$P($G(^PSNDF(50.67,DA,0)),"^",2)
"RTN","PSSMIGRE",228,0)
 . I NAME'=NAME1 D OUT^PSSMIGRC(" Error... NDC Numbers Don't Match") S ERORR=1 Q
"RTN","PSSMIGRE",229,0)
 . S NDF0=$G(^PSNDF(50.67,DA,0)),DR="",PQ=""
"RTN","PSSMIGRE",230,0)
 . S:$P(NDF0,"^",2)'=NAME DR="1///^S X=NAME" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",231,0)
 . S:$P(NDF0,"^",3)'=UPN DR=DR_PQ_"2///"_$S(UPN]"":"^S X=UPN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",232,0)
 . S:$P(NDF0,"^",4)'=MIEN DR=DR_PQ_"3///^S X=MIEN" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",233,0)
 . S:$P(NDF0,"^",5)'=TNAME DR=DR_PQ_"4///"_$S(TNAME]"":"^S X=TNAME",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",234,0)
 . S:$P(NDF0,"^",6)'=PIEN DR=DR_PQ_"5///^S X=PIEN" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",235,0)
 . S:$P(NDF0,"^",7)'=IDATE DR=DR_PQ_"7///"_$S(IDATE]"":"^S X=IDATE",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",236,0)
 . S:$P(NDF0,"^",8)'=SIEN DR=DR_PQ_"8///"_$S(SIEN]"":"^S X=SIEN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",237,0)
 . S:$P(NDF0,"^",9)'=PTIEN DR=DR_PQ_"9///"_$S(PTIEN]"":"^S X=PTIEN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",238,0)
 . S PSOT=$S(PSOTC="Prescription":"R",PSOTC="Over the Counter":"O",1:"")
"RTN","PSSMIGRE",239,0)
 . S:$P(NDF0,"^",10)'=PSOT DR=DR_PQ_"10///"_$S(PSOTC]"":"^S X=PSOTC",1:"@")
"RTN","PSSMIGRE",240,0)
 . D ^DIE
"RTN","PSSMIGRE",241,0)
 . S NIEN2=DA
"RTN","PSSMIGRE",242,0)
 . F  S NIEN2=$O(^PSNDF(50.67,"NDC",NAME,NIEN2)) Q:NIEN2=""  D
"RTN","PSSMIGRE",243,0)
 .. D DT^DICRW S DA=NIEN2,DIE=50.67,IDATE=DT
"RTN","PSSMIGRE",244,0)
 .. S DR="7///^S X=IDATE"
"RTN","PSSMIGRE",245,0)
 .. S:$P(NDF0,"^",2)'=NAME DR=";1///^S X=NAME"
"RTN","PSSMIGRE",246,0)
 .. S:$P(NDF0,"^",3)'=UPN DR=DR_";2///"_$S(UPN]"":"^S X=UPN",1:"@")
"RTN","PSSMIGRE",247,0)
 .. S:$P(NDF0,"^",4)'=MIEN DR=DR_";3///^S X=MIEN"
"RTN","PSSMIGRE",248,0)
 .. S:$P(NDF0,"^",5)'=TNAME DR=DR_";4///"_$S(TNAME]"":"^S X=TNAME",1:"@")
"RTN","PSSMIGRE",249,0)
 .. S:$P(NDF0,"^",6)'=PIEN DR=DR_";5///^S X=PIEN"
"RTN","PSSMIGRE",250,0)
 .. S:$P(NDF0,"^",8)'=SIEN DR=DR_";8///"_$S(SIEN]"":"^S X=SIEN",1:"@")
"RTN","PSSMIGRE",251,0)
 .. S:$P(NDF0,"^",9)'=PTIEN DR=DR_";9///"_$S(PTIEN]"":"^S X=PTIEN",1:"@")
"RTN","PSSMIGRE",252,0)
 .. S PSOT=$S(PSOTC="Prescription":"R",PSOTC="Over the Counter":"O",1:"")
"RTN","PSSMIGRE",253,0)
 .. S:$P(NDF0,"^",10)'=PSOT DR=DR_";10///"_$S(PSOTC]"":"^S X=PSOTC",1:"@")
"RTN","PSSMIGRE",254,0)
 .. D ^DIE
"RTN","PSSMIGRE",255,0)
 ;
"RTN","PSSMIGRE",256,0)
 Q:$G(ERORR)=1
"RTN","PSSMIGRE",257,0)
 ;
"RTN","PSSMIGRE",258,0)
 S XMESS="<message>  Updated NDC: "_NAME_" </message>"
"RTN","PSSMIGRE",259,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRE",260,0)
 K DIC,DA,DR,DIE,^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",261,0)
 Q
"RTN","PSSMIGRE",262,0)
 ;
"RTN","PSSMIGRE",263,0)
 ;
"RTN","PSSMIGRE",264,0)
VAGN ; VA Generic Sync
"RTN","PSSMIGRE",265,0)
 N X,Y,DIC,DA,DR,DIE,IEN,NAME,RTYPE,IDATE,MVUID,VUID,EFFDT,STATUS,CMVUID
"RTN","PSSMIGRE",266,0)
 S NAME=$G(PSS("NAME")),IEN=$G(PSS("IEN")),RTYPE=$G(PSS("RTYPE"))
"RTN","PSSMIGRE",267,0)
 S IDATE=$TR($P($G(PSS("INACTDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE,"L")
"RTN","PSSMIGRE",268,0)
 S MVUID=$G(PSS("MASTERVUID")),VUID=$G(PSS("VUID")),EFFDT=$G(PSS("EFFDATE")),STATUS=$G(PSS("STATUS"))
"RTN","PSSMIGRE",269,0)
 S FNUM=50.6,FNAME="syncResponse.XML",FNAME1="vaGenericName"
"RTN","PSSMIGRE",270,0)
 ;
"RTN","PSSMIGRE",271,0)
 ; Quit if REQUIRED DATA is Missing
"RTN","PSSMIGRE",272,0)
 I NAME="" D OUT^PSSMIGRC(" Error...Missing Required NAME") Q
"RTN","PSSMIGRE",273,0)
 I MVUID="" D OUT^PSSMIGRC(" Error...Missing Required MASTER VUID") Q
"RTN","PSSMIGRE",274,0)
 I VUID="" D OUT^PSSMIGRC(" Error...Missing Required VUID") Q
"RTN","PSSMIGRE",275,0)
 I EFFDT="" D OUT^PSSMIGRC(" Error...Missing Required EFFECTIVE DATE") Q
"RTN","PSSMIGRE",276,0)
 I STATUS="" D OUT^PSSMIGRC(" Error...Missing Required STATUS") Q
"RTN","PSSMIGRE",277,0)
 ;
"RTN","PSSMIGRE",278,0)
 S EFFDT=$$DATE^PSSMIGRD($G(PSS("EFFDATE")))
"RTN","PSSMIGRE",279,0)
 ;Q
"RTN","PSSMIGRE",280,0)
 ;Add the VA Generic Name to the Database
"RTN","PSSMIGRE",281,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRE",282,0)
 . ; Lock the Global
"RTN","PSSMIGRE",283,0)
 . L +^PSNDF(50.6):5 E  D OUT^PSSMIGRC(" Another USER editing VA Generic Name file") Q
"RTN","PSSMIGRE",284,0)
 . ;
"RTN","PSSMIGRE",285,0)
 . ; Cheating - Remove LAYGO temporarly
"RTN","PSSMIGRE",286,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.6,.01,"LAYGO",.01,0))
"RTN","PSSMIGRE",287,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.6,.01,"LAYGO",.01,0)
"RTN","PSSMIGRE",288,0)
 . ;
"RTN","PSSMIGRE",289,0)
 . ; Get the IEN
"RTN","PSSMIGRE",290,0)
 . S X=NAME,DIC=50.6,DIC(0)="LMXZ"
"RTN","PSSMIGRE",291,0)
 . D ^DIC
"RTN","PSSMIGRE",292,0)
 . S (DA,PSS("IEN"),PIEN)=+Y
"RTN","PSSMIGRE",293,0)
 . ;
"RTN","PSSMIGRE",294,0)
 . ; Quit if cannot get IEN
"RTN","PSSMIGRE",295,0)
 . I Y<1 D  Q
"RTN","PSSMIGRE",296,0)
 . . D OUT^PSSMIGRC(" Error...Cannot obtain an IEN for NAME")
"RTN","PSSMIGRE",297,0)
 . . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.6,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",298,0)
 . ;
"RTN","PSSMIGRE",299,0)
 . ; Set Database Variables
"RTN","PSSMIGRE",300,0)
 . S DIE=DIC K DIC
"RTN","PSSMIGRE",301,0)
 . S DR="1///^S X=IDATE;99.98///^S X=MVUID;99.99///^S X=VUID"
"RTN","PSSMIGRE",302,0)
 . ;S DR(2,50.6009)=".01///^S X=EFFDT;.02///^S X=STATUS"
"RTN","PSSMIGRE",303,0)
 . ;
"RTN","PSSMIGRE",304,0)
 . ; Update Database
"RTN","PSSMIGRE",305,0)
 . D ^DIE
"RTN","PSSMIGRE",306,0)
 . S DIC="^PSNDF(50.6,"_PIEN_",""TERMSTATUS"",",DIC(0)="L",DIC("P")="50.6009DA"
"RTN","PSSMIGRE",307,0)
 . S DA(1)=PIEN,DA=1,X=EFFDT
"RTN","PSSMIGRE",308,0)
 . D FILE^DICN
"RTN","PSSMIGRE",309,0)
 . S DIE=DIC,DR=".02///^S X=STATUS"
"RTN","PSSMIGRE",310,0)
 . D ^DIE
"RTN","PSSMIGRE",311,0)
 . ;
"RTN","PSSMIGRE",312,0)
 . ;S ^PSNDF(50.6,DA,"TERMSTATUS",0)="^50.6009^1^1"
"RTN","PSSMIGRE",313,0)
 . ;S ^PSNDF(50.6,DA,"TERMSTATUS",1,0)=EFFDT_"^"_STATUS
"RTN","PSSMIGRE",314,0)
 . ;S ^PSNDF(50.6,DA,"TERMSTATUS","B",EFFDT,1)=""
"RTN","PSSMIGRE",315,0)
 . ;
"RTN","PSSMIGRE",316,0)
 . ; Put LAYGO back
"RTN","PSSMIGRE",317,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.416,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",318,0)
 . L -^PSNDF(50.6)
"RTN","PSSMIGRE",319,0)
 . ;
"RTN","PSSMIGRE",320,0)
 ;
"RTN","PSSMIGRE",321,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRE",322,0)
 . S DA=PSS("IEN"),DIE=50.6
"RTN","PSSMIGRE",323,0)
 . S PS5=$G(^PSNDF(50.6,DA,0)),PSMV=$G(^PSNDF(50.6,DA,"VUID")),DR="",PQ=""
"RTN","PSSMIGRE",324,0)
 . S:$P(PS5,"^",2)'=IDATE DR=DR_PQ_"1///"_$S(IDATE]"":"^S X=IDATE",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",325,0)
 . ;S CMVUID=$P(PSMV,"^",2),CMVUID=$S(CMVUID=1:"YES",CMVUID=0:"NO",1:"")
"RTN","PSSMIGRE",326,0)
 . S:$P(PSMV,"^",2)'=MVUID DR=DR_PQ_"99.98///^S X=MVUID" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",327,0)
 . S:$P(PSMV,"^",1)'=VUID DR=DR_PQ_"99.99///^S X=VUID" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",328,0)
 . ;S DR="1///"_$S(IDATE]"":"^S X=IDATE",1:"@")_";99.98///^S X=MVUID;99.99///^S X=VUID"
"RTN","PSSMIGRE",329,0)
 . ;S DR(2,50.6009)=".01///^S X=EFFDT;.02///^S X=STATUS"
"RTN","PSSMIGRE",330,0)
 . ;
"RTN","PSSMIGRE",331,0)
 . ; Update Database
"RTN","PSSMIGRE",332,0)
 . D ^DIE
"RTN","PSSMIGRE",333,0)
 . ;
"RTN","PSSMIGRE",334,0)
 . ; Stuff EFFECTIVE DATE/TIME entries
"RTN","PSSMIGRE",335,0)
 . ;K ^PSNDF(50.6,DA,"TERMSTATUS")
"RTN","PSSMIGRE",336,0)
 . ;S DIC="^PSNDF(50.6,"_PIEN_",""TERMSTATUS"",",DIC(0)="L",DIC("P")="50.6009DA"
"RTN","PSSMIGRE",337,0)
 . ;S DA(1)=PIEN,DA=1,X=EFFDT
"RTN","PSSMIGRE",338,0)
 . ;D FILE^DICN
"RTN","PSSMIGRE",339,0)
 . ;S DIE=DIC,DR=".02///^S X=STATUS"
"RTN","PSSMIGRE",340,0)
 . ;D ^DIE
"RTN","PSSMIGRE",341,0)
 . ;
"RTN","PSSMIGRE",342,0)
 . ;S ^PSNDF(50.6,DA,"TERMSTATUS",0)="^50.6009^1^1"
"RTN","PSSMIGRE",343,0)
 . ;S ^PSNDF(50.6,DA,"TERMSTATUS",1,0)=EFFDT_"^"_STATUS
"RTN","PSSMIGRE",344,0)
 . ;S ^PSNDF(50.6,DA,"TERMSTATUS","B",EFFDT,1)=""
"RTN","PSSMIGRE",345,0)
 . ;
"RTN","PSSMIGRE",346,0)
 . ; Updating ^NDFK files
"RTN","PSSMIGRE",347,0)
 . ;
"RTN","PSSMIGRE",348,0)
 . I IDATE]"" D
"RTN","PSSMIGRE",349,0)
 . . S X=NAME,DIC=5000.3,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRE",350,0)
 . . S VAPRO=""
"RTN","PSSMIGRE",351,0)
 . . F  S VAPRO=$O(^PSNDF(50.6,"APRO",DA,VAPRO)) Q:VAPRO=""  D
"RTN","PSSMIGRE",352,0)
 . . .S X=VAPRO,DIC=5000.2,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRE",353,0)
 ;
"RTN","PSSMIGRE",354,0)
 ;
"RTN","PSSMIGRE",355,0)
 S XMESS="<message>  Updated VA Generic: "_NAME_" </message>"
"RTN","PSSMIGRE",356,0)
 S XIEN="<ien>"_$G(PSS("IEN"))_"</ien>"
"RTN","PSSMIGRE",357,0)
 K DIC,DA,DR,DIE,^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",358,0)
 Q
"RTN","PSSMIGRP")
0^4^B79156432
"RTN","PSSMIGRP",1,0)
PSSMIGRP ;AJF - Process Synch XML message from PEPS;  6/28/2012 0941
"RTN","PSSMIGRP",2,0)
 ;;1.0;PHARMACY ENTERPRISE PRODUCT SYSTEM;;;Build 39
"RTN","PSSMIGRP",3,0)
 ;;
"RTN","PSSMIGRP",4,0)
 ; Called from ^PSSMIGRC
"RTN","PSSMIGRP",5,0)
 ;;
"RTN","PSSMIGRP",6,0)
 Q
"RTN","PSSMIGRP",7,0)
 ;
"RTN","PSSMIGRP",8,0)
 ;
"RTN","PSSMIGRP",9,0)
VAP ;VAPRODUCT ;
"RTN","PSSMIGRP",10,0)
 I PSS("bodyName")="vaProductSyncRequest" N RCNT D
"RTN","PSSMIGRP",11,0)
 . S PSS("child")=1,PSS("FILE")=50.68,(PSSTITLE,PST)="syncResponse",RCNT=0
"RTN","PSSMIGRP",12,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,1,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRP",13,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRP",14,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",15,0)
 .. I PSS("ELE")="vaProductName" S PSS("NAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",16,0)
 .. I PSS("ELE")="vaProductIen" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",17,0)
 .. ; 
"RTN","PSSMIGRP",18,0)
 .. ; Get vaGenericNameRecord
"RTN","PSSMIGRP",19,0)
 .. I PSS("ELE")="vaGenericNameRecord" D
"RTN","PSSMIGRP",20,0)
 ... S DOCHAND1=PSS("child"),PSS("child1")=1
"RTN","PSSMIGRP",21,0)
 ... F  S PSS("child1")=$$CHILD^MXMLDOM(DOCHAND,DOCHAND1,PSS("child1")) Q:PSS("child1")=0  D
"RTN","PSSMIGRP",22,0)
 .... S PSS("ELE1")=$$NAME^MXMLDOM(DOCHAND,PSS("child1"))
"RTN","PSSMIGRP",23,0)
 .... I PSS("ELE1")="vaGenericNameName" S PSS("GENNAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",24,0)
 .... I PSS("ELE1")="vaGenericIen" S PSS("GENIEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",25,0)
 .. ; 
"RTN","PSSMIGRP",26,0)
 .. ; Get dosageFormRecord
"RTN","PSSMIGRP",27,0)
 .. I PSS("ELE")="dosageFormRecord" D
"RTN","PSSMIGRP",28,0)
 ... S DOCHAND1=PSS("child"),PSS("child1")=1
"RTN","PSSMIGRP",29,0)
 ... F  S PSS("child1")=$$CHILD^MXMLDOM(DOCHAND,DOCHAND1,PSS("child1")) Q:PSS("child1")=0  D
"RTN","PSSMIGRP",30,0)
 .... S PSS("ELE1")=$$NAME^MXMLDOM(DOCHAND,PSS("child1"))
"RTN","PSSMIGRP",31,0)
 .... I PSS("ELE1")="dosageFormName" S PSS("DFNAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",32,0)
 .... I PSS("ELE1")="dosageFormIen" S PSS("DFIEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",33,0)
 .. I PSS("ELE")="strength" S PSS("STRGEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",34,0)
 .. I PSS("ELE")="units" S PSS("UNITS")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",35,0)
 .. I PSS("ELE")="nationalFormularyName" S PSS("NFNAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",36,0)
 .. I PSS("ELE")="vaPrintName" S PSS("PRINTNAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",37,0)
 .. I PSS("ELE")="vaProductIdentifier" S PSS("PRODID")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",38,0)
 .. I PSS("ELE")="transmitToCmop" S PSS("TRANSTC")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",39,0)
 .. ;
"RTN","PSSMIGRP",40,0)
 .. ; Get vaDispenseUnitRecord
"RTN","PSSMIGRP",41,0)
 .. I PSS("ELE")="vaDispenseUnitRecord" D
"RTN","PSSMIGRP",42,0)
 ... S DOCHAND1=PSS("child"),PSS("child1")=1
"RTN","PSSMIGRP",43,0)
 ... F  S PSS("child1")=$$CHILD^MXMLDOM(DOCHAND,DOCHAND1,PSS("child1")) Q:PSS("child1")=0  D
"RTN","PSSMIGRP",44,0)
 .... S PSS("ELE1")=$$NAME^MXMLDOM(DOCHAND,PSS("child1"))
"RTN","PSSMIGRP",45,0)
 .... I PSS("ELE1")="vaDispenseUnitName" S PSS("DUNAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",46,0)
 .... I PSS("ELE1")="vaDispenseUnitIen" S PSS("DUIEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",47,0)
 .. ;
"RTN","PSSMIGRP",48,0)
 .. ; Get activeIngredientsRecord
"RTN","PSSMIGRP",49,0)
 .. I PSS("ELE")="activeIngredientsRecord" S RCNT=$G(RCNT)+1 D
"RTN","PSSMIGRP",50,0)
 ... S DOCHAND1=PSS("child"),PSS("child1")=1
"RTN","PSSMIGRP",51,0)
 ... F  S PSS("child1")=$$CHILD^MXMLDOM(DOCHAND,DOCHAND1,PSS("child1")) Q:PSS("child1")=0  D
"RTN","PSSMIGRP",52,0)
 .... S PSS("ELE1")=$$NAME^MXMLDOM(DOCHAND,PSS("child1"))
"RTN","PSSMIGRP",53,0)
 .... I PSS("ELE1")="activeIngredientsName" S PSS("AINAME"_RCNT)=$G(^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1))
"RTN","PSSMIGRP",54,0)
 .... I PSS("ELE1")="activeIngredientsIen" S PSS("AIIEN"_RCNT)=$G(^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1))
"RTN","PSSMIGRP",55,0)
 .... I PSS("ELE1")="activeIngredientsStrength" S PSS("AISTRG"_RCNT)=$G(^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1))
"RTN","PSSMIGRP",56,0)
 .... I PSS("ELE1")="activeIngredientsUnitsName" S PSS("AIUNAME"_RCNT)=$G(^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1))
"RTN","PSSMIGRP",57,0)
 .... S PSS("ACTID")=RCNT
"RTN","PSSMIGRP",58,0)
 .. ;
"RTN","PSSMIGRP",59,0)
 .. I PSS("ELE")="gcnSeqNo" S PSS("GCNSEQNO")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",60,0)
 .. ;
"RTN","PSSMIGRP",61,0)
 .. ; Get primaryVaDrugClassRecord
"RTN","PSSMIGRP",62,0)
 .. I PSS("ELE")="primaryVaDrugClassRecord" D
"RTN","PSSMIGRP",63,0)
 ... S DOCHAND1=PSS("child"),PSS("child1")=1
"RTN","PSSMIGRP",64,0)
 ... F  S PSS("child1")=$$CHILD^MXMLDOM(DOCHAND,DOCHAND1,PSS("child1")) Q:PSS("child1")=0  D
"RTN","PSSMIGRP",65,0)
 .... S PSS("ELE1")=$$NAME^MXMLDOM(DOCHAND,PSS("child1"))
"RTN","PSSMIGRP",66,0)
 .... I PSS("ELE1")="primaryVaDrugClassCode" S PSS("PVADCCODE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",67,0)
 .... I PSS("ELE1")="primaryVaDrugClassClassification" S PSS("PVADCCLASS")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",68,0)
 .... I PSS("ELE1")="primaryVaDrugClassIen" S PSS("PVADCIEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",69,0)
 .. I PSS("ELE")="nationalFormularyIndicator" S PSS("NFINDICATOR")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",70,0)
 .. I PSS("ELE")="csFederalSchedule" S PSS("CSFSCHED")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",71,0)
 .. I PSS("ELE")="singleMultiSourceProduct" S PSS("SMSPROD")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",72,0)
 .. I PSS("ELE")="excludeDrugDrugInteraction" S PSS("EDDINTER")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",73,0)
 .. I PSS("ELE")="overrideDfDoseChkExclusion" S PSS("ODFDCHKX")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",74,0)
 .. I PSS("ELE")="createPossibleDosage" S PSS("CPDOSAGE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",75,0)
 .. I PSS("ELE")="masterEntryForVuid" S PSS("MVUID")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",76,0)
 .. I PSS("ELE")="vuid" S PSS("VUID")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",77,0)
 .. I PSS("ELE")="productPackage" S PSS("PACK")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",78,0)
 .. ;
"RTN","PSSMIGRP",79,0)
 .. ; Get effectiveDateTimeRecord
"RTN","PSSMIGRP",80,0)
 .. I PSS("ELE")="effectiveDateTimeRecord" D
"RTN","PSSMIGRP",81,0)
 ... S DOCHAND1=PSS("child"),PSS("child1")=1
"RTN","PSSMIGRP",82,0)
 ... F  S PSS("child1")=$$CHILD^MXMLDOM(DOCHAND,DOCHAND1,PSS("child1")) Q:PSS("child1")=0  D
"RTN","PSSMIGRP",83,0)
 .... S PSS("ELE1")=$$NAME^MXMLDOM(DOCHAND,PSS("child1"))
"RTN","PSSMIGRP",84,0)
 .... I PSS("ELE1")="effectiveDateTime" S PSS("EFFDT")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",85,0)
 .... I PSS("ELE1")="effectiveDateTimeStatus" S PSS("EDTS")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",86,0)
 .. I PSS("ELE")="possibleDosagesToCreate" S PSS("PDTCREATE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",87,0)
 .. I PSS("ELE")="inactivationDate" S PSS("INACTDATE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",88,0)
 .. I PSS("ELE")="fdaMedGuide" S PSS("FDAMEDGUIDE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",89,0)
 .. I PSS("ELE")="serviceCode" S PSS("SCODE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",90,0)
 Q
"RTN","PSSMIGRP",91,0)
 ;
"RTN","PSSMIGRP",92,0)
DRUC ;DRUGCLASS 
"RTN","PSSMIGRP",93,0)
 I PSS("bodyName")="drugClassSyncRequest" D
"RTN","PSSMIGRP",94,0)
 . S PSS("child")=1,PSS("FILE")=50.605,(PSSTITLE,PST)="syncResponse"
"RTN","PSSMIGRP",95,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,1,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRP",96,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRP",97,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",98,0)
 .. I PSS("ELE")="drugClassCode" S PSS("CLASSCODE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",99,0)
 .. I PSS("ELE")="drugClassIen" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",100,0)
 .. I PSS("ELE")="drugClassClassification" S PSS("CLASSCLASS")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",101,0)
 .. I PSS("ELE")="ParentClass" D
"RTN","PSSMIGRP",102,0)
 ... S DOCHAND1=PSS("child"),PSS("child1")=1
"RTN","PSSMIGRP",103,0)
 ... F  S PSS("child1")=$$CHILD^MXMLDOM(DOCHAND,DOCHAND1,PSS("child1")) Q:PSS("child1")=0  D
"RTN","PSSMIGRP",104,0)
 .... S PSS("ELE1")=$$NAME^MXMLDOM(DOCHAND,PSS("child1"))
"RTN","PSSMIGRP",105,0)
 .... I PSS("ELE1")="drugClassIen" S PSS("PCIEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",106,0)
 .... I PSS("ELE1")="code" S PSS("PCODE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",107,0)
 .... I PSS("ELE1")="classification" S PSS("PCLASS")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",108,0)
 .. I PSS("ELE")="type" S PSS("TYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",109,0)
 .. I PSS("ELE")="masterEntryForVuid" S PSS("MASTERVUID")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",110,0)
 .. I PSS("ELE")="vuid" S PSS("VUID")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",111,0)
 .. I PSS("ELE")="description" S PSS("DESC")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",112,0)
 .. I PSS("ELE")="effectiveDateTimeRecord" D
"RTN","PSSMIGRP",113,0)
 ... S DOCHAND1=PSS("child"),PSS("child1")=1
"RTN","PSSMIGRP",114,0)
 ... F  S PSS("child1")=$$CHILD^MXMLDOM(DOCHAND,DOCHAND1,PSS("child1")) Q:PSS("child1")=0  D
"RTN","PSSMIGRP",115,0)
 .... S PSS("ELE1")=$$NAME^MXMLDOM(DOCHAND,PSS("child1"))
"RTN","PSSMIGRP",116,0)
 .... I PSS("ELE1")="effectiveDateTime" S PSS("EFFDATE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",117,0)
 .... I PSS("ELE1")="status" S PSS("STATUS")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",118,0)
 Q
"RTN","PSSMIGRP",119,0)
 ;
"RTN","PSSMIGRP",120,0)
DOF ;DOSAGEFORM ;
"RTN","PSSMIGRP",121,0)
 I PSS("bodyName")="dosageFormSyncRequest" N UNCT,DCNT D
"RTN","PSSMIGRP",122,0)
 . S (UCNT,DCNT)=0,PSS("child")=1,PSS("FILE")=50.606,(PSSTITLE,PST)="syncResponse"
"RTN","PSSMIGRP",123,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,1,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRP",124,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRP",125,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",126,0)
 .. I PSS("ELE")="dosageFormName" S PSS("NAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",127,0)
 .. I PSS("ELE")="excludeFromDosageChecks" S PSS("EXCLUDE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",128,0)
 .. I PSS("ELE")="dosageFormIen" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",129,0)
 .. I PSS("ELE")="inactivationDate" S PSS("INACTDATE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRP",130,0)
 .. I PSS("ELE")="unitsRecord" S UCNT=UCNT+1 D  Q
"RTN","PSSMIGRP",131,0)
 ... S DOCHAND1=PSS("child"),PSS("child1")=1
"RTN","PSSMIGRP",132,0)
 ... F  S PSS("child1")=$$CHILD^MXMLDOM(DOCHAND,DOCHAND1,PSS("child1")) Q:PSS("child1")=0  D
"RTN","PSSMIGRP",133,0)
 .... S PSS("ELE1")=$$NAME^MXMLDOM(DOCHAND,PSS("child1"))
"RTN","PSSMIGRP",134,0)
 .... I PSS("ELE1")="units" S PSS("UNITS"_UCNT)=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",135,0)
 .... I PSS("ELE1")="unitsIen" S PSS("UNITSIEN"_UCNT)=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",136,0)
 .... I PSS("ELE1")="package" S PSS("PACKAGE"_UCNT)=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",137,0)
 .... S PSS("UNITS")=UCNT
"RTN","PSSMIGRP",138,0)
 .. I PSS("ELE")="dispenseUnitsPerDose" S DCNT=DCNT+1 D  Q
"RTN","PSSMIGRP",139,0)
 ... S DOCHAND1=PSS("child"),PSS("child1")=1
"RTN","PSSMIGRP",140,0)
 ... F  S PSS("child1")=$$CHILD^MXMLDOM(DOCHAND,DOCHAND1,PSS("child1")) Q:PSS("child1")=0  D
"RTN","PSSMIGRP",141,0)
 .... S PSS("ELE1")=$$NAME^MXMLDOM(DOCHAND,PSS("child1"))
"RTN","PSSMIGRP",142,0)
 .... I PSS("ELE1")="dispenseUnitsPerDoseNumber" S PSS("PDDOSE"_DCNT)=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",143,0)
 .... I PSS("ELE1")="package" S PSS("PDPACKAGE"_DCNT)=^TMP("MXMLDOM",$J,DOCHAND,PSS("child1"),"T",1)
"RTN","PSSMIGRP",144,0)
 .... S PSS("PERDOSE")=DCNT
"RTN","PSSMIGRP",145,0)
 Q
"RTN","PSSMIGRR")
0^5^B104608215
"RTN","PSSMIGRR",1,0)
PSSMIGRR ;AJF - Process Synch XML message from PEPS;  10/11/2012 0845
"RTN","PSSMIGRR",2,0)
 ;;1.0;PHARMACY ENTERPRISE PRODUCT SYSTEM;;;Build 39
"RTN","PSSMIGRR",3,0)
 ;;
"RTN","PSSMIGRR",4,0)
 ; Called from ^PSSMIGRD
"RTN","PSSMIGRR",5,0)
 ;;
"RTN","PSSMIGRR",6,0)
 Q
"RTN","PSSMIGRR",7,0)
 ;
"RTN","PSSMIGRR",8,0)
VAPD ;VA Product Sync
"RTN","PSSMIGRR",9,0)
 ;
"RTN","PSSMIGRR",10,0)
 ;
"RTN","PSSMIGRR",11,0)
 N X,Y,DIC,DA,DR,DIE,EFFDT,STATUS,EDT,PACK,UTIEN,GCNO
"RTN","PSSMIGRR",12,0)
 N RTYPE,NAME,GENNAME,GENIEN,DFNAME,DFIEN,STRGEN,UNITS,NFNAME,PRINTNAME,PRODID,TRANSTC,DUIEN
"RTN","PSSMIGRR",13,0)
 N AINAME,AIIEN,AISTRG,AIUNAME,AINAME2,AIIEN2,AIUNAME2,GCNSEQNO,PVADCCODE,PVADCCLASS,PVADCIEN
"RTN","PSSMIGRR",14,0)
 N NFINDICATOR,CSFSCHED,SMSPROD,EDDINTER,CPDOSAGE,MVUID,VUID,PRODID,PDTCREATE,ODFDCHKX,VAPTN
"RTN","PSSMIGRR",15,0)
 ; Check REQUIRED Fields
"RTN","PSSMIGRR",16,0)
 I $G(PSS("NAME"))="" D OUT^PSSMIGRC(" Error...Missing Required VA PRODUCT NAME") Q
"RTN","PSSMIGRR",17,0)
 I $G(PSS("MVUID"))="" D OUT^PSSMIGRC(" Error...Missing Required VA PRODUCT Master Entry VUID") Q
"RTN","PSSMIGRR",18,0)
 I $G(PSS("VUID"))="" D OUT^PSSMIGRC(" Error...Missing Required VA PRODUCT VUID") Q
"RTN","PSSMIGRR",19,0)
 I $G(PSS("EFFDT"))="" D OUT^PSSMIGRC(" Error...Missing Required VA PRODUCT EFFECTIVE DATE/TIME") Q
"RTN","PSSMIGRR",20,0)
 I $G(PSS("EDTS"))="" D OUT^PSSMIGRC(" Error...Missing Required VA PRODUCT PRODUCT EFFECTIVE DATE/TIME") Q
"RTN","PSSMIGRR",21,0)
 I $G(PSS("ODFDCHKX"))="" D OUT^PSSMIGRC(" Error...Missing Required VA PRODUCT OVERRIDE DF DOSE CHK EXCLUSION") Q
"RTN","PSSMIGRR",22,0)
 ;
"RTN","PSSMIGRR",23,0)
 ;
"RTN","PSSMIGRR",24,0)
 S RTYPE=$G(PSS("RTYPE")) ;RequestType
"RTN","PSSMIGRR",25,0)
 S NAME=$G(PSS("NAME")) ;vaProductName
"RTN","PSSMIGRR",26,0)
 S GENNAME=$G(PSS("GENNAME")) ;vaGenericNameName
"RTN","PSSMIGRR",27,0)
 S GENIEN=$G(PSS("GENIEN")) ;vaGenericIen
"RTN","PSSMIGRR",28,0)
 S DFNAME=$G(PSS("DFNAME")) ;dosageFormName
"RTN","PSSMIGRR",29,0)
 S DFIEN=$G(PSS("DFIEN")) ;dosageFormIen
"RTN","PSSMIGRR",30,0)
 S STRGEN=$G(PSS("STRGEN")) ;strength
"RTN","PSSMIGRR",31,0)
 S UNITS=$G(PSS("UNITS")) ;units
"RTN","PSSMIGRR",32,0)
 S NFNAME=$G(PSS("NFNAME")) ;nationalFormularyName
"RTN","PSSMIGRR",33,0)
 S PRINTNAME=$G(PSS("PRINTNAME")) ;vaPrintName
"RTN","PSSMIGRR",34,0)
 S PRODID=$G(PSS("PRODID")) ;vaProductIdentifier
"RTN","PSSMIGRR",35,0)
 S TRANSTC=$G(PSS("TRANSTC")) ;transmitToCmop
"RTN","PSSMIGRR",36,0)
 S DUNAME=$G(PSS("DUNAME")) ;vaDispenseName
"RTN","PSSMIGRR",37,0)
 S DUNIEN=$G(PSS("DUIEN")) ;vaDispenseUnitIen
"RTN","PSSMIGRR",38,0)
 S GCNO="0000000"_$G(PSS("GCNSEQNO")) ;gcnSeqNo padded with zeros
"RTN","PSSMIGRR",39,0)
 S GCNSEQNO=$E(GCNO,($L(GCNO)-5),$L(GCNO)) ;gcnSeqNo
"RTN","PSSMIGRR",40,0)
 S:+GCNSEQNO=0 GCNSEQNO="" ; Reset gcnSeqNo to blank if all zeros 10/11/12
"RTN","PSSMIGRR",41,0)
 S PVADCCLASS=$G(PSS("PVADCCLASS")) ;primaryVaDrugClassClassification
"RTN","PSSMIGRR",42,0)
 S PVADCCODE=$G(PSS("PVADCCODE")) ;primaryVaDrugClassCode
"RTN","PSSMIGRR",43,0)
 S PVADCIEN=$G(PSS("PVADCIEN")) ;primaryVaDrugClassIen
"RTN","PSSMIGRR",44,0)
 S NFINDICATOR=$G(PSS("NFINDICATOR")) ;nationalFormularyIndicator
"RTN","PSSMIGRR",45,0)
 S CSFSCHED=$G(PSS("CSFSCHED")) ;csFederalSchedule
"RTN","PSSMIGRR",46,0)
 S SMSPROG=$G(PSS("SMSPROD")) ;singleMultiSourceProduct
"RTN","PSSMIGRR",47,0)
 S EDDINTER=$G(PSS("EDDINTER")) ;excludeDrugDrugInteraction
"RTN","PSSMIGRR",48,0)
 S:EDDINTER'=1 EDDINTER=""
"RTN","PSSMIGRR",49,0)
 S ODFDCHKX=$G(PSS("ODFDCHKX")) ;overrideDfDoseChkExclusion
"RTN","PSSMIGRR",50,0)
 S CPDOSAGE=$G(PSS("CPDOSAGE")) ;createPossibleDosage
"RTN","PSSMIGRR",51,0)
 S PDTCREATE=$G(PSS("PDTCREATE")) ;possibleDosagesToCreateS
"RTN","PSSMIGRR",52,0)
 S MVUID=$G(PSS("MVUID")) ;masterEntryForVuid
"RTN","PSSMIGRR",53,0)
 S VUID=$G(PSS("VUID")) ;Vuid
"RTN","PSSMIGRR",54,0)
 S PRODID=$G(PSS("PRODID")) ;Vuid
"RTN","PSSMIGRR",55,0)
 S IDATE=$TR($P($G(PSS("INACTDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE)
"RTN","PSSMIGRR",56,0)
 S FNUM=50.68,FNAME="syncResponse.XML",FNAME1="dosageForm"
"RTN","PSSMIGRR",57,0)
 S ACTID=$G(PSS("ACTID"))
"RTN","PSSMIGRR",58,0)
 S EFFDT=$$DATE^PSSMIGRD($G(PSS("EFFDT"))) ;effectiveDateTime
"RTN","PSSMIGRR",59,0)
 S STATUS=$G(PSS("EDTS")) ;effectiveDateTimeStatus
"RTN","PSSMIGRR",60,0)
 S FDAMG=$G(PSS("FDAMEDGUIDE")) ;fdamedguide
"RTN","PSSMIGRR",61,0)
 S SCODE=$G(PSS("SCODE")) ; servicecode
"RTN","PSSMIGRR",62,0)
 S PACK=$G(PSS("PACK")) ;package
"RTN","PSSMIGRR",63,0)
 S:SMSPROG="" SMSPROG="@"
"RTN","PSSMIGRR",64,0)
 ;
"RTN","PSSMIGRR",65,0)
 I $L(UNITS),'$O(^PS(50.607,"B",UNITS,"")) D OUT^PSSMIGRC(" Error...Invaild Units Name") Q 
"RTN","PSSMIGRR",66,0)
 ;
"RTN","PSSMIGRR",67,0)
 ;Add the VA PRODUCT record to the Database 
"RTN","PSSMIGRR",68,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRR",69,0)
 . ;L +^PSNDF(50.68):5 E  D OUT^PSSMIGRC(" Another USER editing VA PRODUCT FILE file") Q
"RTN","PSSMIGRR",70,0)
 . ;
"RTN","PSSMIGRR",71,0)
 . ; Cheating - Remove the check for LAYGO temporarly
"RTN","PSSMIGRR",72,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.68,.01,"LAYGO",.01,0))
"RTN","PSSMIGRR",73,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.68,.01,"LAYGO",.01,0)
"RTN","PSSMIGRR",74,0)
 . ;
"RTN","PSSMIGRR",75,0)
 . ; Get the IEN
"RTN","PSSMIGRR",76,0)
 . S X=NAME,DIC=50.68,DIC(0)="LMXZ"
"RTN","PSSMIGRR",77,0)
 . D ^DIC
"RTN","PSSMIGRR",78,0)
 . ; Quit if cannot get IEN
"RTN","PSSMIGRR",79,0)
 . I Y<1 D  Q
"RTN","PSSMIGRR",80,0)
 . . S:^TMP("AJF LAYGO",$J)]"" DD(50.68,.01,"LAYGO",1,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRR",81,0)
 . . L -^PS(50.68)
"RTN","PSSMIGRR",82,0)
 . . D OUT^PSSMIGRC(" Error...Cannot obtain an IEN for VA PRODUCT NAME")
"RTN","PSSMIGRR",83,0)
 . ;L -^PS(50.68)
"RTN","PSSMIGRR",84,0)
 . ;
"RTN","PSSMIGRR",85,0)
 . ; Set Database Variables
"RTN","PSSMIGRR",86,0)
 . S DIE=DIC K DIC
"RTN","PSSMIGRR",87,0)
 . S DA=+Y
"RTN","PSSMIGRR",88,0)
 . S DR=".05////^S X=GENIEN;1////^S X=DFIEN;2///^S X=STRGEN;17///^S X=NFINDICATOR;3///^S X=UNITS;4///^S X=NFNAME;"
"RTN","PSSMIGRR",89,0)
 . S DR=DR_"5///^S X=PRINTNAME;6///^S X=PRODID;7///^S X=TRANSTC;8///^S X=DUNAME;"
"RTN","PSSMIGRR",90,0)
 . S DR=DR_"11////^S X=GCNSEQNO;15///^S X=PVADCIEN;42///^S X=PACK;"
"RTN","PSSMIGRR",91,0)
 . S DR=DR_"19///^S X=CSFSCHED;20///^S X=SMSPROG;23///^S X=EDDINTER;31///^S X=ODFDCHKX;"
"RTN","PSSMIGRR",92,0)
 . S DR=DR_"40///^S X=CPDOSAGE;41///^S X=PDTCREATE;99.98///^S X=MVUID;99.99///^S X=VUID;"
"RTN","PSSMIGRR",93,0)
 . S DR=DR_"100///^S X=FDAMG;2000///^S X=SCODE"
"RTN","PSSMIGRR",94,0)
 . ;
"RTN","PSSMIGRR",95,0)
 . S (PSS("IEN"),PIEN)=DA
"RTN","PSSMIGRR",96,0)
 . ; Update Database
"RTN","PSSMIGRR",97,0)
 . D ^DIE
"RTN","PSSMIGRR",98,0)
 . ;
"RTN","PSSMIGRR",99,0)
 . ; Update Active Ingredients multiple
"RTN","PSSMIGRR",100,0)
 . I +ACTID D UAI
"RTN","PSSMIGRR",101,0)
 . ;
"RTN","PSSMIGRR",102,0)
 . ;  Update Effective Date/Time
"RTN","PSSMIGRR",103,0)
 . S DIC="^PSNDF(50.68,"_PIEN_",""TERMSTATUS"",",DIC(0)="L",DIC("P")="50.6899DA"
"RTN","PSSMIGRR",104,0)
 . S DA(1)=PIEN,DA=1,X=EFFDT
"RTN","PSSMIGRR",105,0)
 . D FILE^DICN
"RTN","PSSMIGRR",106,0)
 . S DIE=DIC,DR=".02///^S X=STATUS"
"RTN","PSSMIGRR",107,0)
 . D ^DIE
"RTN","PSSMIGRR",108,0)
 . ; Put LAYGO back 
"RTN","PSSMIGRR",109,0)
 . S:^TMP("AJF LAYGO",$J)]"" DD(50.68,.01,"LAYGO",1,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRR",110,0)
 . ;
"RTN","PSSMIGRR",111,0)
 . ;
"RTN","PSSMIGRR",112,0)
 . ; Updating ^NDFK files
"RTN","PSSMIGRR",113,0)
 . ;
"RTN","PSSMIGRR",114,0)
 . I NAME]"" S X=NAME,DIC=5000.506,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRR",115,0)
 . ;I IDATE]"" S X=NAME,DIC=5000.2,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRR",116,0)
 ;
"RTN","PSSMIGRR",117,0)
 ;
"RTN","PSSMIGRR",118,0)
 ;
"RTN","PSSMIGRR",119,0)
 ;Modify the VA PRODUCT record
"RTN","PSSMIGRR",120,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRR",121,0)
 . ; Setting variables for NDFK checking
"RTN","PSSMIGRR",122,0)
 . S (PIEN,DA)=PSS("IEN"),DIE=50.68
"RTN","PSSMIGRR",123,0)
 . S PS0=^PSNDF(50.68,DA,0),PS1=$G(^PSNDF(50.68,DA,1))
"RTN","PSSMIGRR",124,0)
 . S NAFI=$P($G(^PSNDF(50.68,DA,5)),"^"),EDCK=$P($G(^PSNDF(50.68,DA,8)),"^")
"RTN","PSSMIGRR",125,0)
 . S PVDC=$P($G(^PSNDF(50.68,DA,3)),"^"),PS1=$G(^PSNDF(50.68,DA,1))
"RTN","PSSMIGRR",126,0)
 . S OVCK=$P($G(^PSNDF(50.68,DA,9)),"^",1),PS7=$G(^PSNDF(50.68,DA,7))
"RTN","PSSMIGRR",127,0)
 . S DOS=$G(^PSNDF(50.68,DA,"DOS")),FMG=$P($G(^PSNDF(50.68,DA,"MG")),"^")
"RTN","PSSMIGRR",128,0)
 . S VUID0=$G(^PSNDF(50.68,DA,"VUID")),PSF0=$G(^PSNDF(50.68,DA,"PFS"))
"RTN","PSSMIGRR",129,0)
 . S DR="",PQ=""
"RTN","PSSMIGRR",130,0)
 . ;
"RTN","PSSMIGRR",131,0)
 . S:$P(PS0,"^",2)'=GENIEN DR=".05////"_$S(GENIEN]"":"^S X=GENIEN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRR",132,0)
 . S:$P(PS0,"^",3)'=DFIEN DR=DR_PQ_"1////"_$S(DFIEN]"":"^S X=DFIEN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRR",133,0)
 . I $P(PS0,"^",4)'=STRGEN S DR=DR_PQ_"2///"_$S(STRGEN]"":"^S X=STRGEN",1:"@") S:$L(DR) PQ=";" D
"RTN","PSSMIGRR",134,0)
 .. ; Strength Change
"RTN","PSSMIGRR",135,0)
 .. S X=NAME,DIC=5000.4,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRR",136,0)
 .. S X=NAME,DIC=5000.2,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRR",137,0)
 . S UIEN=$P(PS0,"^",5)
"RTN","PSSMIGRR",138,0)
 . S UNT=$S($L(UIEN):$P($G(^PS(50.607,UIEN,0)),"^",1),1:"")
"RTN","PSSMIGRR",139,0)
 . S:UNT'=UNITS DR=DR_PQ_"3///"_$S(UNITS]"":"^S X=UNITS",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRR",140,0)
 . I $P(DOS,"^",1)'=$E(CPDOSAGE,1) S DR=DR_PQ_"40///^S X=CPDOSAGE" S:$L(DR) PQ=";" D
"RTN","PSSMIGRR",141,0)
 .. ; Possible Dosage Setting Changes
"RTN","PSSMIGRR",142,0)
 .. S (X,DINUM)=PIEN,DIC=5000.92,DIC(0)="LMXZ" D FILE^DICN
"RTN","PSSMIGRR",143,0)
 . I $P(DOS,"^",3)'=PACK S DR=DR_PQ_"42///"_$S(PACK]"":"^S X=PACK",1:"@") S:$L(DR) PQ=";" D
"RTN","PSSMIGRR",144,0)
 .. S (X,DINUM)=PIEN,DIC=5000.92,DIC(0)="LMXZ" D FILE^DICN
"RTN","PSSMIGRR",145,0)
 . I $P(DOS,"^",2)'=PDTCREATE S DR=DR_PQ_"41///"_$S(PDTCREATE]"":"^S X=PDTCREATE",1:"@") D
"RTN","PSSMIGRR",146,0)
 .. S:$L(DR) PQ=";"
"RTN","PSSMIGRR",147,0)
 .. S (X,DINUM)=PIEN,DIC=5000.92,DIC(0)="LMXZ" D FILE^DICN
"RTN","PSSMIGRR",148,0)
 . S:$P(PS0,"^",6)'=NFNAME DR=DR_PQ_"4///"_$S(NFNAME]"":"^S X=NFNAME",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRR",149,0)
 . S VAPTN=$$TRIM^XLFSTR($$UP($P(PS1,"^",1)))
"RTN","PSSMIGRR",150,0)
 . S:VAPTN'=PRINTNAME DR=DR_PQ_"5///"_$S(PRINTNAME]"":"^S X=PRINTNAME",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRR",151,0)
 . S:$P(PS1,"^",2)'=PRODID DR=DR_PQ_"6///"_$S(PRODID]"":"^S X=PRODID",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRR",152,0)
 . I $P(PS1,"^",3)'=TRANSTC S DR=DR_PQ_"7///"_$S(TRANSTC]"":"^S X=TRANSTC",1:"@") S:$L(DR) PQ=";" D
"RTN","PSSMIGRR",153,0)
 .. ; Umarked For CMOP
"RTN","PSSMIGRR",154,0)
 .. I TRANSTC=0&($P(PS1,"^",3)=1) S X=NAME,DIC=5000.7,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRR",155,0)
 . S:$P(PS1,"^",4)'=DUNIEN DR=DR_PQ_"8///"_$S(DUNAME]"":"^S X=DUNAME",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRR",156,0)
 . S:$P(PS1,"^",5)'=GCNSEQNO DR=DR_PQ_"11////"_$S(GCNSEQNO]"":"^S X=GCNSEQNO",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRR",157,0)
 . I PVDC'=PVADCIEN S DR=DR_PQ_"15///^S X=PVADCIEN" S:$L(DR) PQ=";" D PVDC
"RTN","PSSMIGRR",158,0)
 . I $P($G(^PSNDF(50.68,PIEN,5)),"^")'=NFINDICATOR S DR=DR_PQ_"17///^S X=NFINDICATOR" S:$L(DR) PQ=";" D
"RTN","PSSMIGRR",159,0)
 .. ; National Formulary Indicator
"RTN","PSSMIGRR",160,0)
 .. S X=NAME,DIC=5000.5,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRR",161,0)
 . I $P(PS7,"^",1)'=CSFSCHED S DR=DR_PQ_"19///^S X=CSFSCHED" S:$L(DR) PQ=";" D
"RTN","PSSMIGRR",162,0)
 ..; Product With Schedule Change
"RTN","PSSMIGRR",163,0)
 ..I CSFSCHED'=0 S X=NAME,DIC=5000.9,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRR",164,0)
 . S:$P(PS7,"^",2)'=SMSPROG DR=DR_PQ_"20///^S X=SMSPROG" S:$L(DR) PQ=";"
"RTN","PSSMIGRR",165,0)
 . I EDCK'=EDDINTER Q:EDCK=""&(EDDINTER=0)  S DR=DR_PQ_"23///"_$S(EDDINTER=1:"^S X=EDDINTER",1:"@") S:$L(DR) PQ=";" D EDCK
"RTN","PSSMIGRR",166,0)
 . ;S OVCKX=$S(ODFDCHKX="YES":1,ODFDCHKX="NO":0,1:"")
"RTN","PSSMIGRR",167,0)
 . I OVCK'=ODFDCHKX S DR=DR_PQ_"31///^S X=ODFDCHKX" S:$L(DR) PQ=";" D OVCK
"RTN","PSSMIGRR",168,0)
 . ;S MVUIDX=$S(MVUID="YES":1,MVUID="NO":0,1:"")
"RTN","PSSMIGRR",169,0)
 . S:$P(VUID0,"^",2)'=MVUID DR=DR_PQ_"99.98///^S X=MVUID" S:$L(DR) PQ=";"
"RTN","PSSMIGRR",170,0)
 . S:$P(VUID0,"^",1)'=VUID DR=DR_PQ_"99.99///^S X=VUID" S:$L(DR) PQ=";"
"RTN","PSSMIGRR",171,0)
 . S:$P(PS7,"^",3)'=IDATE DR=DR_PQ_"21///"_$S(IDATE]"":"^S X=IDATE",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRR",172,0)
 . I FMG'=FDAMG S DR=DR_PQ_"100///"_$S(FDAMG]"":"^S X=FDAMG",1:"@") S:$L(DR) PQ=";" D FMG
"RTN","PSSMIGRR",173,0)
 . S:$P(PSF0,"^",1)'=SCODE DR=DR_PQ_"2000///"_$S(SCODE]"":"^S X=SCODE",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRR",174,0)
 . ;
"RTN","PSSMIGRR",175,0)
 . ; Update Database
"RTN","PSSMIGRR",176,0)
 . S DA=PSS("IEN"),DIE=50.68
"RTN","PSSMIGRR",177,0)
 . D ^DIE
"RTN","PSSMIGRR",178,0)
 . ;
"RTN","PSSMIGRR",179,0)
 . ; Update Active Ingredients multiple
"RTN","PSSMIGRR",180,0)
 . I +ACTID D UAI
"RTN","PSSMIGRR",181,0)
 . ;
"RTN","PSSMIGRR",182,0)
 . ; Check for NDFK changes
"RTN","PSSMIGRR",183,0)
 . ; Inactivation Date
"RTN","PSSMIGRR",184,0)
 . S UTIEN=$P(^PSNDF(50.68,DA,0),"^",5)
"RTN","PSSMIGRR",185,0)
 . I IDATE]"",$P(PS7,"^",3)="" S X=NAME,DIC=5000.2,DIC(0)="LMXZ" D ^DIC D ^DIC S ^TMP("NDFK",DA,"0")=""
"RTN","PSSMIGRR",186,0)
 . I GENIEN'=$P(PS0,"^",2) S X=NAME,DIC=5000.2,DIC(0)="LMXZ" D ^DIC S ^TMP("NDFK",DA,"1")=""
"RTN","PSSMIGRR",187,0)
 . I DFIEN'=$P(PS0,"^",3) S X=NAME,DIC=5000.2,DIC(0)="LMXZ" D ^DIC S ^TMP("NDFK",DA,"2")=""
"RTN","PSSMIGRR",188,0)
 . I UTIEN'=$P(PS0,"^",5) S X=NAME,DIC=5000.2,DIC(0)="LMXZ" D ^DIC S ^TMP("NDFK",DA,"3")=""
"RTN","PSSMIGRR",189,0)
 . I VAPTN'=PRINTNAME S X=NAME,DIC=5000.2,DIC(0)="LMXZ" D ^DIC S ^TMP("NDFK",DA,"4")=""
"RTN","PSSMIGRR",190,0)
 . I PRODID'=$P(PS1,"^",2) S X=NAME,DIC=5000.2,DIC(0)="LMXZ" D ^DIC S ^TMP("NDFK",DA,"5")=""
"RTN","PSSMIGRR",191,0)
 . I DUNIEN'=$P(PS1,"^",4) S X=NAME,DIC=5000.2,DIC(0)="LMXZ" D ^DIC S ^TMP("NDFK",DA,"6")=""
"RTN","PSSMIGRR",192,0)
 ;
"RTN","PSSMIGRR",193,0)
 ;PVADCIEN
"RTN","PSSMIGRR",194,0)
 ;
"RTN","PSSMIGRR",195,0)
 S XMESS="<message> <![CDATA[ Updated VA Product "_NAME_" ]]> </message>"
"RTN","PSSMIGRR",196,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRR",197,0)
 K DIC,DA,DR,DIE,^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRR",198,0)
 Q
"RTN","PSSMIGRR",199,0)
 ;
"RTN","PSSMIGRR",200,0)
UAI ; Update Active Ingredients multiple
"RTN","PSSMIGRR",201,0)
 ;
"RTN","PSSMIGRR",202,0)
 ; Removing old Active Ingredients
"RTN","PSSMIGRR",203,0)
 ;K ^PSNDF(50.68,DA,2)  
"RTN","PSSMIGRR",204,0)
 ;
"RTN","PSSMIGRR",205,0)
 N CNT,AIIEN,AISTRG,AINAME S CNT=0,PIEN=DA
"RTN","PSSMIGRR",206,0)
 N DA
"RTN","PSSMIGRR",207,0)
 F  S CNT=$O(^PSNDF(50.68,PIEN,2,CNT)) Q:CNT=""  D
"RTN","PSSMIGRR",208,0)
 . S DIE="^PSNDF(50.68,"_PIEN_",2,",DA(1)=PIEN,DA=CNT
"RTN","PSSMIGRR",209,0)
 . S DR=".01///@"
"RTN","PSSMIGRR",210,0)
 . D ^DIE
"RTN","PSSMIGRR",211,0)
 ;
"RTN","PSSMIGRR",212,0)
 ; Adding new Active Ingredients
"RTN","PSSMIGRR",213,0)
 ;
"RTN","PSSMIGRR",214,0)
 F CNT=1:1:ACTID I $D(PSS("AIIEN"_CNT)) D
"RTN","PSSMIGRR",215,0)
 . S DIC="^PSNDF(50.68,"_PIEN_",2,",DIC(0)="L",DIC("P")="50.6814P"
"RTN","PSSMIGRR",216,0)
 . S AIIEN=$G(PSS("AIIEN"_CNT)) ;activeIngredientsIen
"RTN","PSSMIGRR",217,0)
 . S AISTRG=$G(PSS("AISTRG"_CNT)) ;activeIngredientsStrength
"RTN","PSSMIGRR",218,0)
 . S AINAME=$G(PSS("AIUNAME"_CNT)) ;activeIngredientsUnitsName
"RTN","PSSMIGRR",219,0)
 . S DA(1)=PIEN,(DA,DINUM,X)=AIIEN
"RTN","PSSMIGRR",220,0)
 . D FILE^DICN
"RTN","PSSMIGRR",221,0)
 . S DIE=DIC,DR="1///^S X=AISTRG;2///^S X=AINAME"
"RTN","PSSMIGRR",222,0)
 . D ^DIE
"RTN","PSSMIGRR",223,0)
 Q
"RTN","PSSMIGRR",224,0)
 ;
"RTN","PSSMIGRR",225,0)
 ; Check for NDFK changes 
"RTN","PSSMIGRR",226,0)
EDCK  ; Interaction Exclusion/Inclusion
"RTN","PSSMIGRR",227,0)
 ;I EDCK'=EDDINTER D
"RTN","PSSMIGRR",228,0)
 N DR
"RTN","PSSMIGRR",229,0)
 S X=NAME,DIC=5000.23,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRR",230,0)
 S DIE=DIC,DA=+Y K DIC
"RTN","PSSMIGRR",231,0)
 S DR="1///"_$S(EDDINTER]"":"^S X=EDDINTER",1:"@")
"RTN","PSSMIGRR",232,0)
 D ^DIE
"RTN","PSSMIGRR",233,0)
 Q
"RTN","PSSMIGRR",234,0)
PVDC ; Product Name With Change Code
"RTN","PSSMIGRR",235,0)
 N DR
"RTN","PSSMIGRR",236,0)
 S X=NAME,DIC=5000.507,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRR",237,0)
 S DIE=DIC,DA=+Y K DIC
"RTN","PSSMIGRR",238,0)
 S DR="2///^S X=PVDC;3///^S X=PVADCIEN"
"RTN","PSSMIGRR",239,0)
 D ^DIE
"RTN","PSSMIGRR",240,0)
 ; Class Changes
"RTN","PSSMIGRR",241,0)
 S X=NAME,DIC=5000.8,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRR",242,0)
 S DIE=DIC,DA=+Y K DIC
"RTN","PSSMIGRR",243,0)
 S DR="1///^S X=PVDC;2///^S X=PVADCIEN;3///^S X=GENIEN"
"RTN","PSSMIGRR",244,0)
 D ^DIE
"RTN","PSSMIGRR",245,0)
 Q
"RTN","PSSMIGRR",246,0)
 ;
"RTN","PSSMIGRR",247,0)
OVCK ; Override Change
"RTN","PSSMIGRR",248,0)
 ;S OVCK=$S(OVCK="YES":1,OVCK="NO":0,1:""
"RTN","PSSMIGRR",249,0)
 ;I OVCK'=ODFDCHKX D
"RTN","PSSMIGRR",250,0)
 N DR
"RTN","PSSMIGRR",251,0)
 S X=NAME,DIC=5000.608,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRR",252,0)
 S DIE=DIC,DA=+Y K DIC
"RTN","PSSMIGRR",253,0)
 S DR="1///^S X=OVCK;2///^S X=ODFDCHKX"
"RTN","PSSMIGRR",254,0)
 D ^DIE
"RTN","PSSMIGRR",255,0)
 Q
"RTN","PSSMIGRR",256,0)
 ;
"RTN","PSSMIGRR",257,0)
FMG ; Med Guide Changes
"RTN","PSSMIGRR",258,0)
 ;I FMG'=FDAMG D
"RTN","PSSMIGRR",259,0)
 N DR,FAMG
"RTN","PSSMIGRR",260,0)
 S (X,DINUM)=PSS("IEN"),DIC=5000.91,DIC(0)="LMXZ" D FILE^DICN
"RTN","PSSMIGRR",261,0)
 S FAMG=$S(FMG="":"A",FDAMG]"":"E",1:"D")
"RTN","PSSMIGRR",262,0)
 S DIE=DIC,DA=+Y K DIC
"RTN","PSSMIGRR",263,0)
 S DR="1///^S X=FAMG"
"RTN","PSSMIGRR",264,0)
 D ^DIE
"RTN","PSSMIGRR",265,0)
 Q
"RTN","PSSMIGRR",266,0)
 ;
"RTN","PSSMIGRR",267,0)
UP(X)    Q $TR(X,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSSMIGRR",268,0)
 ;
"VER")
8.0^22.0
**END**
**END**
