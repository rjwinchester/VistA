KIDS Distribution saved on Nov 05, 2012@14:35:34
Migration sync software
**KIDS**:PPSN*1.1*12^

**INSTALL NAME**
PPSN*1.1*12
"BLD",1453,0)
PPSN*1.1*12^^0^3121105^n
"BLD",1453,1,0)
^^1^1^3121105^^^^
"BLD",1453,1,1,0)
21st delivery of migration code. 
"BLD",1453,4,0)
^9.64PA^^
"BLD",1453,6.3)
38
"BLD",1453,"KRN",0)
^9.67PA^9002226^21
"BLD",1453,"KRN",.4,0)
.4
"BLD",1453,"KRN",.401,0)
.401
"BLD",1453,"KRN",.402,0)
.402
"BLD",1453,"KRN",.403,0)
.403
"BLD",1453,"KRN",.5,0)
.5
"BLD",1453,"KRN",.84,0)
.84
"BLD",1453,"KRN",3.6,0)
3.6
"BLD",1453,"KRN",3.8,0)
3.8
"BLD",1453,"KRN",9.2,0)
9.2
"BLD",1453,"KRN",9.8,0)
9.8
"BLD",1453,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",1453,"KRN",9.8,"NM",1,0)
PSSMIGR^^0^B41941636
"BLD",1453,"KRN",9.8,"NM",2,0)
PSSMIGR1^^0^B78582836
"BLD",1453,"KRN",9.8,"NM",3,0)
PSSMIGR2^^0^B76354283
"BLD",1453,"KRN",9.8,"NM",4,0)
PSSMIGRS^^0^B91482671
"BLD",1453,"KRN",9.8,"NM",5,0)
PSSMIGRT^^0^B47611640
"BLD",1453,"KRN",9.8,"NM","B","PSSMIGR",1)

"BLD",1453,"KRN",9.8,"NM","B","PSSMIGR1",2)

"BLD",1453,"KRN",9.8,"NM","B","PSSMIGR2",3)

"BLD",1453,"KRN",9.8,"NM","B","PSSMIGRS",4)

"BLD",1453,"KRN",9.8,"NM","B","PSSMIGRT",5)

"BLD",1453,"KRN",19,0)
19
"BLD",1453,"KRN",19,"NM",0)
^9.68A^^
"BLD",1453,"KRN",19.1,0)
19.1
"BLD",1453,"KRN",101,0)
101
"BLD",1453,"KRN",409.61,0)
409.61
"BLD",1453,"KRN",771,0)
771
"BLD",1453,"KRN",779.2,0)
779.2
"BLD",1453,"KRN",870,0)
870
"BLD",1453,"KRN",8989.51,0)
8989.51
"BLD",1453,"KRN",8989.52,0)
8989.52
"BLD",1453,"KRN",8994,0)
8994
"BLD",1453,"KRN",8994,"NM",0)
^9.68A^2^2
"BLD",1453,"KRN",8994,"NM",1,0)
PPS NDFMS MIGR^^0
"BLD",1453,"KRN",8994,"NM",2,0)
PPS NDFMS MIGR SYNC^^0
"BLD",1453,"KRN",8994,"NM","B","PPS NDFMS MIGR",1)

"BLD",1453,"KRN",8994,"NM","B","PPS NDFMS MIGR SYNC",2)

"BLD",1453,"KRN",9002226,0)
9002226
"BLD",1453,"KRN",9002226,"NM",0)
^9.68A^^
"BLD",1453,"KRN","B",.4,.4)

"BLD",1453,"KRN","B",.401,.401)

"BLD",1453,"KRN","B",.402,.402)

"BLD",1453,"KRN","B",.403,.403)

"BLD",1453,"KRN","B",.5,.5)

"BLD",1453,"KRN","B",.84,.84)

"BLD",1453,"KRN","B",3.6,3.6)

"BLD",1453,"KRN","B",3.8,3.8)

"BLD",1453,"KRN","B",9.2,9.2)

"BLD",1453,"KRN","B",9.8,9.8)

"BLD",1453,"KRN","B",19,19)

"BLD",1453,"KRN","B",19.1,19.1)

"BLD",1453,"KRN","B",101,101)

"BLD",1453,"KRN","B",409.61,409.61)

"BLD",1453,"KRN","B",771,771)

"BLD",1453,"KRN","B",779.2,779.2)

"BLD",1453,"KRN","B",870,870)

"BLD",1453,"KRN","B",8989.51,8989.51)

"BLD",1453,"KRN","B",8989.52,8989.52)

"BLD",1453,"KRN","B",8994,8994)

"BLD",1453,"KRN","B",9002226,9002226)

"BLD",1453,"QUES",0)
^9.62^^
"BLD",1453,"REQB",0)
^9.611^^
"KRN",8994,80,-1)
0^1
"KRN",8994,80,0)
PPS NDFMS MIGR^MIGR^PSSMIGR^1^P^0
"KRN",8994,80,2,0)
^8994.02A^1^1
"KRN",8994,80,2,1,0)
XML^4^^1
"KRN",8994,80,2,"B","XML",1)

"KRN",8994,81,-1)
0^2
"KRN",8994,81,0)
PPS NDFMS MIGR SYNC^SYNC^PSSMIGRS^1^P^0
"KRN",8994,81,2,0)
^8994.02A^1^1
"KRN",8994,81,2,1,0)
XML^4^^1
"KRN",8994,81,2,"B","XML",1)

"MBREQ")
0
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","PSSMIGR")
0^1^B41941636
"RTN","PSSMIGR",1,0)
PSSMIGR ;AJF - Receives and Process XML message from PEPS; 10/12/2011 1905
"RTN","PSSMIGR",2,0)
 ;;1.0;PHARMACY ENTERPRISE PRODUCT SYSTEM;;;Build 38
"RTN","PSSMIGR",3,0)
 ;;
"RTN","PSSMIGR",4,0)
 ; Start of Migration code
"RTN","PSSMIGR",5,0)
 ;
"RTN","PSSMIGR",6,0)
 ; Modified Copy of routine PSSXML
"RTN","PSSMIGR",7,0)
 ;;
"RTN","PSSMIGR",8,0)
MIGR2(XOBY,PSSMSG) ;Entry point into routine
"RTN","PSSMIGR",9,0)
 N X,Y,DIR,FILE,DOCHAND,XMLFILE,VAL,LEN,INPUT,OUTCNT,PSS
"RTN","PSSMIGR",10,0)
 N RERR,PSSEOF,EOF,FNUM,FNAME,FNAME1
"RTN","PSSMIGR",11,0)
 S PSSEOF=0,PSS("xmlResponse")=$$XMLBODY(.PSS)
"RTN","PSSMIGR",12,0)
 S XML=PSS("xmlHeader")_"<drugMigrationResponse"_PSS("xmlns:xsi")
"RTN","PSSMIGR",13,0)
 S XML=XML_PSS("xsi:schemaLocation")_PSS("xmlns")_">"_PSS("respHead")
"RTN","PSSMIGR",14,0)
 S XML=XML_"<drugUnits><drugUnitsIen>12</drugUnitsIen><name>5ML</name>"
"RTN","PSSMIGR",15,0)
 S XML=XML_"<inactivationDate>20080219</inactivationDate></drugUnits></drugMigrationResponse>"
"RTN","PSSMIGR",16,0)
 S XOBY=XML
"RTN","PSSMIGR",17,0)
 Q
"RTN","PSSMIGR",18,0)
 ;
"RTN","PSSMIGR",19,0)
MIGR(XOBY,PSSMSG) ;Entry point into routine
"RTN","PSSMIGR",20,0)
 N IEN,MIEN,CNT,OUT,RCNT,XML2,VAL
"RTN","PSSMIGR",21,0)
 ;
"RTN","PSSMIGR",22,0)
 D DT^DICRW S U="^",OUTCNT=0
"RTN","PSSMIGR",23,0)
 ;
"RTN","PSSMIGR",24,0)
 S OUT=$NA(^UTILITY($J,"OUT")) K ^UTILITY($J),^TMP($J,"XML OUT")
"RTN","PSSMIGR",25,0)
 ;
"RTN","PSSMIGR",26,0)
 D PRSTRING(.PSSMSG,.XMLFILE)
"RTN","PSSMIGR",27,0)
 ;
"RTN","PSSMIGR",28,0)
 S VAL="" F  S VAL=$O(XMLFILE(VAL)) Q:VAL=""  D
"RTN","PSSMIGR",29,0)
 .S ^TMP($J,"XML OUT",VAL)=XMLFILE(VAL)
"RTN","PSSMIGR",30,0)
 ;
"RTN","PSSMIGR",31,0)
 ;**strip out any invisible ASCII characters before passing the TMP global to MXMLDOM
"RTN","PSSMIGR",32,0)
 ;F  S PSS("charCount")=$O(^TMP($J,"XML OUT",PSS("charCount"))) Q:PSS("charCount")=""  D
"RTN","PSSMIGR",33,0)
 ;F PSS("char")=0:1:32 S ^TMP($J,"XML OUT",PSS("charCount"))=$TRANSLATE(^TMP($J,"XML OUT",PSS("charCount")),$C(PSS("char")),"")
"RTN","PSSMIGR",34,0)
 ;
"RTN","PSSMIGR",35,0)
 ;**get handle to XML document in memory, the date/time message was received, and the DUZ of the associated user
"RTN","PSSMIGR",36,0)
 S DOCHAND=$$EN^MXMLDOM($NA(^TMP($J,"XML OUT")),"VO")
"RTN","PSSMIGR",37,0)
 S PSS("date/time")=$$NOW^XLFDT
"RTN","PSSMIGR",38,0)
 S PSS("duz")=DUZ
"RTN","PSSMIGR",39,0)
 ;
"RTN","PSSMIGR",40,0)
 ;**retrieve parent node attributes
"RTN","PSSMIGR",41,0)
 S PSS("body")=$$PARENT^MXMLDOM(DOCHAND,2)
"RTN","PSSMIGR",42,0)
 S PSS("bodyName")=$$NAME^MXMLDOM(DOCHAND,PSS("body"))
"RTN","PSSMIGR",43,0)
 S PSS("status")=$$VALUE^MXMLDOM(DOCHAND,PSS("body"),"status")
"RTN","PSSMIGR",44,0)
 S PSS("pepsIdNumber")=$$VALUE^MXMLDOM(DOCHAND,PSS("body"),"pepsIdNumber")
"RTN","PSSMIGR",45,0)
 ;
"RTN","PSSMIGR",46,0)
 I PSS("bodyName")="drugMigrationRequest" D
"RTN","PSSMIGR",47,0)
 . S PSS("child")=2
"RTN","PSSMIGR",48,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,2,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGR",49,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGR",50,0)
 .. I PSS("ELE")="ndfmsFile" S PSS("FILE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGR",51,0)
 .. I PSS("ELE")="startingIen" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGR",52,0)
 .. I PSS("ELE")="numElements" S PSS("SNUM")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGR",53,0)
 .. I PSS("ELE")="type" S PSS("TYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGR",54,0)
 ;
"RTN","PSSMIGR",55,0)
 ;
"RTN","PSSMIGR",56,0)
 D EN^PSSMIGR1(PSS("FILE"),PSS("IEN"),PSS("SNUM"),PSS("TYPE"))
"RTN","PSSMIGR",57,0)
 Q:$D(RERR)=1
"RTN","PSSMIGR",58,0)
 ;
"RTN","PSSMIGR",59,0)
 S RCNT=PSS("SNUM"),PSSEOF=+$G(^TMP($J,PSS("FILE"),"EOF"))
"RTN","PSSMIGR",60,0)
 ;**generate XML response message
"RTN","PSSMIGR",61,0)
 ;
"RTN","PSSMIGR",62,0)
 S PSS("xmlResponse")=$$XMLBODY(.PSS)
"RTN","PSSMIGR",63,0)
 ;
"RTN","PSSMIGR",64,0)
 ;**store value in VistALink return parameter
"RTN","PSSMIGR",65,0)
 ;
"RTN","PSSMIGR",66,0)
 ;
"RTN","PSSMIGR",67,0)
 ;
"RTN","PSSMIGR",68,0)
 ;Write the XML response message to a new file
"RTN","PSSMIGR",69,0)
 S FILE=FNAME
"RTN","PSSMIGR",70,0)
 S XML2=PSS("xmlHeader")_"<drugMigrationResponse"_PSS("xmlns:xsi")
"RTN","PSSMIGR",71,0)
 S XML2=XML2_PSS("xsi:schemaLocation")_PSS("xmlns")_">"_PSS("respHead")
"RTN","PSSMIGR",72,0)
 S IEN="",CNT=0
"RTN","PSSMIGR",73,0)
 F  S IEN=$O(^TMP($J,FNUM,PSS("TYPE"),IEN)) Q:IEN=""  D
"RTN","PSSMIGR",74,0)
 . I IEN="" S EOF=1,RCNT=CNT Q
"RTN","PSSMIGR",75,0)
 .S XML2=XML2_"<"_FNAME1_">"
"RTN","PSSMIGR",76,0)
 . S XML2=XML2_^TMP($J,FNUM,PSS("TYPE"),IEN)
"RTN","PSSMIGR",77,0)
 .S MIEN=0
"RTN","PSSMIGR",78,0)
 .F  S MIEN=$O(^TMP($J,FNUM,PSS("TYPE"),IEN,MIEN)) Q:MIEN=""  D
"RTN","PSSMIGR",79,0)
 .. S XML2=XML2_^TMP($J,FNUM,PSS("TYPE"),IEN,MIEN)
"RTN","PSSMIGR",80,0)
 .S XML2=XML2_"</"_FNAME1_">"
"RTN","PSSMIGR",81,0)
 S XOBY=XML2_"</drugMigrationResponse>"
"RTN","PSSMIGR",82,0)
 ;
"RTN","PSSMIGR",83,0)
 ; exit and clean-up
"RTN","PSSMIGR",84,0)
 K ^TMP($J,FNUM),^TMP("MXMLDOM",$J)
"RTN","PSSMIGR",85,0)
 Q
"RTN","PSSMIGR",86,0)
 ;
"RTN","PSSMIGR",87,0)
GFILE ;Get file path and name 
"RTN","PSSMIGR",88,0)
 S DIR(0)="F" ;Free text Input
"RTN","PSSMIGR",89,0)
 S DIR("A")="Enter Directory (path) and File Name"
"RTN","PSSMIGR",90,0)
 S DIR("?")=""
"RTN","PSSMIGR",91,0)
 S DIR("?",1)="**********************************************************"
"RTN","PSSMIGR",92,0)
 S DIR("?",2)="Enter the Path and File Name to where the File is Located."
"RTN","PSSMIGR",93,0)
 S DIR("?",3)="  example:  c:\tmp\test.xml"
"RTN","PSSMIGR",94,0)
 S DIR("?",4)="Enter ""^"" to Exit"
"RTN","PSSMIGR",95,0)
 S DIR("?")="**********************************************************"
"RTN","PSSMIGR",96,0)
 D ^DIR W ! K DIR Q:X[U!(X']"")
"RTN","PSSMIGR",97,0)
 Q
"RTN","PSSMIGR",98,0)
 ;
"RTN","PSSMIGR",99,0)
RESPONSE(PSS) ;**check to see if current XML message was successfully written to the PEPS QUEUE file (#54.5)
"RTN","PSSMIGR",100,0)
 N PSSOUT
"RTN","PSSMIGR",101,0)
 ;
"RTN","PSSMIGR",102,0)
 I $D(PSS("ERR")) S PSS("response")="Failure",PSS("attribValue")="<response status="""_PSS("response")_""">Unable to queue message.  Reason: "_$P(PSS("ERR"),"^",2)_"</response>"
"RTN","PSSMIGR",103,0)
 E  I $D(^PSSPEPS("B",PSS("pepsIdNumber"))) S PSS("response")="Queued",PSS("attribValue")="<response status="""_PSS("response")_""">Message "_PSS("pepsIdNumber")_" is queued.</response>"
"RTN","PSSMIGR",104,0)
 E  S PSS("response")="Failure",PSS("attribValue")="<response status="""_PSS("response")_""">Unable to queue message "_PSS("pepsIdNumber")_". Reason: "_$P($G(PSS("ERR")),"^",2)_"</response>"
"RTN","PSSMIGR",105,0)
 S PSSOUT=$$XMLBODY(.PSS)
"RTN","PSSMIGR",106,0)
 Q PSSOUT
"RTN","PSSMIGR",107,0)
 ;
"RTN","PSSMIGR",108,0)
XMLBODY(PSS) ;**generates response XML message
"RTN","PSSMIGR",109,0)
 S PSS("xmlHeader")=$$XMLHDR^MXMLUTL
"RTN","PSSMIGR",110,0)
 S PSS("xmlns:xsi")=" xmlns:xsi=""http://www.w3.org/2001/XMLSchema"""
"RTN","PSSMIGR",111,0)
 ;S PSS("xsi:schemaLocation")="xsi:schemaLocation=""gov/va/med/pharmacy/peps/external/common/vo/inbound/migration/data/response ../../../schema/migration/drugMigrationResponse.xsd"""
"RTN","PSSMIGR",112,0)
 S PSS("xsi:schemaLocation")=" "
"RTN","PSSMIGR",113,0)
 S PSS("xmlns")="xmlns=""gov/va/med/pharmacy/peps/external/common/vo/inbound/migration/data/response"""
"RTN","PSSMIGR",114,0)
 S PSS("elementFormDefault")="elementFormDefault=""qualified"""
"RTN","PSSMIGR",115,0)
 S PSS("attributeFormDefault")="attributeFormDefault=""unqualified"""
"RTN","PSSMIGR",116,0)
 S PSS("respHead")="<responseHeader><endOfFile>"_PSSEOF_"</endOfFile></responseHeader>"
"RTN","PSSMIGR",117,0)
 ;
"RTN","PSSMIGR",118,0)
 S PSSOUT=PSS("xmlHeader")
"RTN","PSSMIGR",119,0)
 S PSSOUT=PSSOUT_"<drugMigrationResponse"
"RTN","PSSMIGR",120,0)
 S PSSOUT=PSSOUT_" "_PSS("xmlns:xsi")
"RTN","PSSMIGR",121,0)
 S PSSOUT=PSSOUT_" "_PSS("xsi:schemaLocation")
"RTN","PSSMIGR",122,0)
 S PSSOUT=PSSOUT_" "_PSS("xmlns")
"RTN","PSSMIGR",123,0)
 S PSSOUT=PSSOUT_" "_PSS("elementFormDefault")
"RTN","PSSMIGR",124,0)
 S PSSOUT=PSSOUT_" "_PSS("attributeFormDefault")_">"
"RTN","PSSMIGR",125,0)
 S PSSOUT=PSSOUT_" "_PSS("respHead")
"RTN","PSSMIGR",126,0)
 Q PSSOUT
"RTN","PSSMIGR",127,0)
 ;
"RTN","PSSMIGR",128,0)
TRASH ;**delete XML handle
"RTN","PSSMIGR",129,0)
 D DELETE^MXMLDOM(DOCHAND)
"RTN","PSSMIGR",130,0)
 Q
"RTN","PSSMIGR",131,0)
 ;
"RTN","PSSMIGR",132,0)
OUT(X) S OUTCNT=OUTCNT+1,@OUT@(OUTCNT)=X,PSSEOF=+$G(^TMP($J,PSS("FILE"),"EOF"))
"RTN","PSSMIGR",133,0)
 S FILE=FNAME,RERR=1,PSS("xmlResponse")=$$XMLBODY(.PSS)
"RTN","PSSMIGR",134,0)
 S XML2=PSS("xmlHeader")_"<drugMigrationResponse"_PSS("xmlns:xsi")
"RTN","PSSMIGR",135,0)
 S XML2=XML2_PSS("xsi:schemaLocation")_PSS("xmlns")_">"_PSS("respHead")
"RTN","PSSMIGR",136,0)
 S XML2=XML2_"<invalidRequest>"_X_"</invalidRequest>"_"</drugMigrationResponse>"
"RTN","PSSMIGR",137,0)
 S XOBY=XML2
"RTN","PSSMIGR",138,0)
 Q
"RTN","PSSMIGR",139,0)
 ;
"RTN","PSSMIGR",140,0)
PRSTRING(XML,NWARRY) ;**parses the incoming xml string coming back from PEPS
"RTN","PSSMIGR",141,0)
 ;;
"RTN","PSSMIGR",142,0)
 ;XML is the xml string that is passed by PEPS. 
"RTN","PSSMIGR",143,0)
 ;It must be parsed into an array that is usable by MXML Kernel routines. 
"RTN","PSSMIGR",144,0)
 ;;
"RTN","PSSMIGR",145,0)
 N POS,GT,FRNTEND,CNT
"RTN","PSSMIGR",146,0)
 ;**FRNTEND holds the front portion of the extracted data
"RTN","PSSMIGR",147,0)
 S GT=">",POS=0
"RTN","PSSMIGR",148,0)
 F CNT=0:1 Q:XML=""!(XML'[">")  D
"RTN","PSSMIGR",149,0)
 .S POS=$F(XML,GT)
"RTN","PSSMIGR",150,0)
 .S FRNTEND=$E(XML,1,POS-1)
"RTN","PSSMIGR",151,0)
 .S XML=$E(XML,POS,$L(XML))
"RTN","PSSMIGR",152,0)
 .S NWARRY(CNT)=FRNTEND
"RTN","PSSMIGR",153,0)
 Q
"RTN","PSSMIGR",154,0)
 ;
"RTN","PSSMIGR",155,0)
DATE(Y)  ;RETURN A DATE
"RTN","PSSMIGR",156,0)
 I Y X ^DD("DD")
"RTN","PSSMIGR",157,0)
 Q Y
"RTN","PSSMIGR1")
0^2^B78582836
"RTN","PSSMIGR1",1,0)
PSSMIGR1 ;AJF - Receives and Process XML message from PEPS; 10/31/2011 1845
"RTN","PSSMIGR1",2,0)
 ;;1.0;PHARMACY ENTERPRISE PRODUCT SYSTEM;;;Build 38
"RTN","PSSMIGR1",3,0)
 ;;
"RTN","PSSMIGR1",4,0)
 ; Called from PSSMIGR - calls to PSSMIGR2
"RTN","PSSMIGR1",5,0)
 ; Process migration request
"RTN","PSSMIGR1",6,0)
 ;;
"RTN","PSSMIGR1",7,0)
EN(FL,IEN,RCNT,TYPE) ;Entry point into routine
"RTN","PSSMIGR1",8,0)
 ;  FL   - File Number
"RTN","PSSMIGR1",9,0)
 ;  IEN  - The starting IEN
"RTN","PSSMIGR1",10,0)
 ;  RCNT - Number of records desired
"RTN","PSSMIGR1",11,0)
 ;  TYPE - 1 or 2
"RTN","PSSMIGR1",12,0)
 ;
"RTN","PSSMIGR1",13,0)
 ;Global Variables:
"RTN","PSSMIGR1",14,0)
 ;  FNAME,FNAME1,FNUM
"RTN","PSSMIGR1",15,0)
 ;
"RTN","PSSMIGR1",16,0)
 S FNAME="drugMigrationResponse.XML"
"RTN","PSSMIGR1",17,0)
 I FL=""!(IEN="")!(RCNT="")!(TYPE="") D OUT^PSSMIGR(" Error... Missing required data") Q
"RTN","PSSMIGR1",18,0)
 N XST,CNT
"RTN","PSSMIGR1",19,0)
 S CNT=0,XST=0
"RTN","PSSMIGR1",20,0)
 S:IEN'=0 IEN=IEN-1
"RTN","PSSMIGR1",21,0)
 I FL=50.607 D DUNI Q  ;Drug Unit
"RTN","PSSMIGR1",22,0)
 I FL=50.416 D DING Q  ;Drug Ingredients
"RTN","PSSMIGR1",23,0)
 I FL=50.6 D VAGN Q  ;VA Generic Name
"RTN","PSSMIGR1",24,0)
 I FL=50.64 D VADU Q  ;VA Dispense Unit
"RTN","PSSMIGR1",25,0)
 I FL=50.605 D VADC Q  ;VA Drug Class
"RTN","PSSMIGR1",26,0)
 I FL=50.606 D DSFO^PSSMIGR2(IEN,RCNT,TYPE) Q  ;Dosage Form
"RTN","PSSMIGR1",27,0)
 I FL=50.68 D VAPD^PSSMIGR2(IEN,RCNT,TYPE) Q  ;VA Product
"RTN","PSSMIGR1",28,0)
 ;
"RTN","PSSMIGR1",29,0)
 ;File Error Process
"RTN","PSSMIGR1",30,0)
 D OUT^PSSMIGR(" Error... Invalid File Number")
"RTN","PSSMIGR1",31,0)
 Q
"RTN","PSSMIGR1",32,0)
 ;
"RTN","PSSMIGR1",33,0)
DUNI ; Process Migration for DRUG UNIT file
"RTN","PSSMIGR1",34,0)
 ;
"RTN","PSSMIGR1",35,0)
 N IND,NAME,PS0,XIEN,XTYPE,XIND
"RTN","PSSMIGR1",36,0)
 K ^TMP($J,50.607)
"RTN","PSSMIGR1",37,0)
 S CNT=0,^TMP($J,50.607,"EOF")=0
"RTN","PSSMIGR1",38,0)
 S FNAME="drugMigrationResponse_DrugUnits.XML",FNUM=50.607
"RTN","PSSMIGR1",39,0)
 S FNAME1="drugUnits"
"RTN","PSSMIGR1",40,0)
 I IEN<0 D OUT^PSSMIGR(" Error... Invalid IEN") Q
"RTN","PSSMIGR1",41,0)
 I RCNT<1 D OUT^PSSMIGR(" Error... Invalid Number of Elements") Q
"RTN","PSSMIGR1",42,0)
 I TYPE>1!(TYPE<0) D OUT^PSSMIGR(" Error... Invalid TYPE") Q
"RTN","PSSMIGR1",43,0)
 F  S IEN=$O(^PS(50.607,IEN)) D  Q:XST=1
"RTN","PSSMIGR1",44,0)
 .I IEN="B" S ^TMP($J,50.607,"EOF")=1,XST=1 Q
"RTN","PSSMIGR1",45,0)
 .I RCNT=CNT S XST=1 Q
"RTN","PSSMIGR1",46,0)
 .S PS0=^PS(50.607,IEN,0)
"RTN","PSSMIGR1",47,0)
 .S NAME=$P(PS0,"^"),IND=$P(PS0,"^",2)
"RTN","PSSMIGR1",48,0)
 .S XTYPE=$S(+IND:0,1:1)
"RTN","PSSMIGR1",49,0)
 .S:+IND IND=$$FMTHL7^XLFDT(IND)
"RTN","PSSMIGR1",50,0)
 .S XIEN="<drugUnitsIen>"_IEN_"</drugUnitsIen>"
"RTN","PSSMIGR1",51,0)
 .S XNAME=$S(NAME="":"",1:"<name>"_NAME_"</name>")
"RTN","PSSMIGR1",52,0)
 .S XIND=$S(IND="":"",1:"<inactivationDate>"_IND_"</inactivationDate>")
"RTN","PSSMIGR1",53,0)
 .S ^TMP($J,50.607,XTYPE,IEN)=XIEN_XNAME_XIND
"RTN","PSSMIGR1",54,0)
 .S:XTYPE=TYPE CNT=CNT+1
"RTN","PSSMIGR1",55,0)
 Q
"RTN","PSSMIGR1",56,0)
 ;
"RTN","PSSMIGR1",57,0)
VADU ; Process Migration for VA Dispense UNIT file
"RTN","PSSMIGR1",58,0)
 ;
"RTN","PSSMIGR1",59,0)
 N CNT,IND,NAME,PS0,XIEN,XTYPE,XIND
"RTN","PSSMIGR1",60,0)
 K ^TMP($J,50.64)
"RTN","PSSMIGR1",61,0)
 S CNT=0,^TMP($J,50.64,"EOF")=0
"RTN","PSSMIGR1",62,0)
 S FNAME="drugMigrationResponse_vaDispenseUnits.XML",FNUM=50.64
"RTN","PSSMIGR1",63,0)
 S FNAME1="vaDispenseUnit"
"RTN","PSSMIGR1",64,0)
 I IEN<0 D OUT^PSSMIGR(" Error... Invalid IEN") Q
"RTN","PSSMIGR1",65,0)
 I RCNT<1 D OUT^PSSMIGR(" Error... Invalid Starting Record Number") Q
"RTN","PSSMIGR1",66,0)
 I TYPE>1!(TYPE<0) D OUT^PSSMIGR(" Error... Invalid TYPE") Q
"RTN","PSSMIGR1",67,0)
 F  S IEN=$O(^PSNDF(50.64,IEN)) D  Q:XST=1
"RTN","PSSMIGR1",68,0)
 .I IEN="B" S ^TMP($J,50.64,"EOF")=1,XST=1 Q
"RTN","PSSMIGR1",69,0)
 .I RCNT=CNT S XST=1 Q
"RTN","PSSMIGR1",70,0)
 .S PS0=^PSNDF(50.64,IEN,0)
"RTN","PSSMIGR1",71,0)
 .S NAME=$P(PS0,"^"),IND=$P(PS0,"^",2)
"RTN","PSSMIGR1",72,0)
 .S XTYPE=$S(+IND:0,1:1)
"RTN","PSSMIGR1",73,0)
 .S:+IND IND=$$FMTHL7^XLFDT(IND)
"RTN","PSSMIGR1",74,0)
 .S XIEN="<dispenseUnitsIen>"_IEN_"</dispenseUnitsIen>"
"RTN","PSSMIGR1",75,0)
 .S XNAME=$S(NAME="":"",1:"<name>"_NAME_"</name>")
"RTN","PSSMIGR1",76,0)
 .S XIND=$S(IND="":"",1:"<inactivationDate>"_IND_"</inactivationDate>")
"RTN","PSSMIGR1",77,0)
 .S ^TMP($J,50.64,XTYPE,IEN)=XIEN_XNAME_XIND
"RTN","PSSMIGR1",78,0)
 .S:XTYPE=TYPE CNT=CNT+1
"RTN","PSSMIGR1",79,0)
 Q
"RTN","PSSMIGR1",80,0)
 ;
"RTN","PSSMIGR1",81,0)
DING ; Process Migration for Drug Ingredients file
"RTN","PSSMIGR1",82,0)
 ;
"RTN","PSSMIGR1",83,0)
 N CNT,IND,MAEN,MIEN,NAME,PRIN,PS0,PST0,PSV,STA,VUID,XEDT,XIEN,XPRIN,XSTA,XTYPE,XIND,XMAEN,XVUID
"RTN","PSSMIGR1",84,0)
 K ^TMP($J,50.416)
"RTN","PSSMIGR1",85,0)
 S CNT=0,^TMP($J,50.416,"EOF")=0
"RTN","PSSMIGR1",86,0)
 S FNAME="drugMigrationResponse_DrugIngredients.XML",FNUM=50.416
"RTN","PSSMIGR1",87,0)
 S FNAME1="drugIngredients"
"RTN","PSSMIGR1",88,0)
 I IEN<0 D OUT^PSSMIGR(" Error... Invalid IEN") Q
"RTN","PSSMIGR1",89,0)
 I RCNT<1 D OUT^PSSMIGR(" Error... Invalid Starting Record Number") Q
"RTN","PSSMIGR1",90,0)
 I TYPE>1!(TYPE<0) D OUT^PSSMIGR(" Error... Invalid TYPE") Q
"RTN","PSSMIGR1",91,0)
 F  S IEN=$O(^PS(50.416,IEN)) D  Q:XST=1
"RTN","PSSMIGR1",92,0)
 .I +IEN=0 S ^TMP($J,50.416,"EOF")=1,XST=1 Q
"RTN","PSSMIGR1",93,0)
 .I RCNT=CNT S XST=1 Q
"RTN","PSSMIGR1",94,0)
 .S PS0=^PS(50.416,IEN,0)
"RTN","PSSMIGR1",95,0)
 .S NAME=$P(PS0,"^"),PRIN=$P(PS0,"^",2),IND=$P($G(^PS(50.416,IEN,2)),"^")
"RTN","PSSMIGR1",96,0)
 .S:+PRIN PRIN=$P($G(^PS(50.416,PRIN,0)),"^")
"RTN","PSSMIGR1",97,0)
 .S XTYPE=$S(+IND:0,1:1)
"RTN","PSSMIGR1",98,0)
 .S:+IND IND=$$FMTHL7^XLFDT(IND)
"RTN","PSSMIGR1",99,0)
 .S PSV=$G(^PS(50.416,IEN,"VUID"))
"RTN","PSSMIGR1",100,0)
 .S MAEN=$P(PSV,"^",2),VUID=$P(PSV,"^")
"RTN","PSSMIGR1",101,0)
 .S XIEN="<drugIngredientsIen>"_IEN_"</drugIngredientsIen>"
"RTN","PSSMIGR1",102,0)
 .S XNAME=$S(NAME="":"",1:"<name><![CDATA["_NAME_"]]></name>")
"RTN","PSSMIGR1",103,0)
 .S XPRIN=$S(PRIN="":"",1:"<primaryIngredient><![CDATA["_PRIN_"]]></primaryIngredient>")
"RTN","PSSMIGR1",104,0)
 .S XIND=$S(IND="":"",1:"<inactivationDate>"_IND_"</inactivationDate>")
"RTN","PSSMIGR1",105,0)
 .S XMAEN="<masterEntryForVuid>"_MAEN_"</masterEntryForVuid>"
"RTN","PSSMIGR1",106,0)
 .S XVUID="<vuid>"_VUID_"</vuid>"
"RTN","PSSMIGR1",107,0)
 .S ^TMP($J,50.416,XTYPE,IEN)=XIEN_XNAME_XPRIN_XIND_XMAEN_XVUID
"RTN","PSSMIGR1",108,0)
 .I $D(^PS(50.416,IEN,"TERMSTATUS",0)) D
"RTN","PSSMIGR1",109,0)
 ..S MIEN=0
"RTN","PSSMIGR1",110,0)
 ..F  S MIEN=$O(^PS(50.416,IEN,"TERMSTATUS",MIEN)) Q:MIEN="B"  D
"RTN","PSSMIGR1",111,0)
 ...S PST0=^PS(50.416,IEN,"TERMSTATUS",MIEN,0)
"RTN","PSSMIGR1",112,0)
 ...S EDT=$P(PST0,"^"),STA=$P(PST0,"^",2)
"RTN","PSSMIGR1",113,0)
 ...S EDT=$$FMTHL7^XLFDT(EDT)
"RTN","PSSMIGR1",114,0)
 ...S XEDT="<effectiveDateTime>"_EDT_"</effectiveDateTime>"
"RTN","PSSMIGR1",115,0)
 ...S XSTA="<status>"_STA_"</status>"
"RTN","PSSMIGR1",116,0)
 ...S ^TMP($J,50.416,XTYPE,IEN,MIEN)="<effectiveDateTime>"_XEDT_XSTA_"</effectiveDateTime>"
"RTN","PSSMIGR1",117,0)
 .S:XTYPE=TYPE CNT=CNT+1
"RTN","PSSMIGR1",118,0)
 Q
"RTN","PSSMIGR1",119,0)
 ;
"RTN","PSSMIGR1",120,0)
VAGN ; Process Migration for VA Generic Name
"RTN","PSSMIGR1",121,0)
 ;
"RTN","PSSMIGR1",122,0)
 N CNT,XST,PSV,XVUID,MAEN,XMAEN,XIND,XNAME,IND,MIEN,NAME,PS0,PST0,STA,VUID,XEDT,XIEN,XSTA,XTYPE
"RTN","PSSMIGR1",123,0)
 K ^TMP($J,50.6)
"RTN","PSSMIGR1",124,0)
 S CNT=0,^TMP($J,50.6,"EOF")=0,XST=0
"RTN","PSSMIGR1",125,0)
 S FNAME="drugMigrationResponse_VAGeneric.XML",FNUM=50.6
"RTN","PSSMIGR1",126,0)
 S FNAME1="vaGenericName"
"RTN","PSSMIGR1",127,0)
 I IEN<0 D OUT^PSSMIGR(" Error... Invalid IEN") Q
"RTN","PSSMIGR1",128,0)
 I RCNT<1 D OUT^PSSMIGR(" Error... Invalid Starting Record Number") Q
"RTN","PSSMIGR1",129,0)
 I TYPE>1!(TYPE<0) D OUT^PSSMIGR(" Error... Invalid TYPE") Q
"RTN","PSSMIGR1",130,0)
 F  S IEN=$O(^PSNDF(50.6,IEN)) D  Q:XST=1
"RTN","PSSMIGR1",131,0)
 .I +IEN=0 S ^TMP($J,50.6,"EOF")=1,XST=1 Q
"RTN","PSSMIGR1",132,0)
 .I RCNT=CNT S XST=1 Q
"RTN","PSSMIGR1",133,0)
 .S PS0=^PSNDF(50.6,IEN,0)
"RTN","PSSMIGR1",134,0)
 .S NAME=$P(PS0,"^"),IND=$P(PS0,"^",2)
"RTN","PSSMIGR1",135,0)
 .S XTYPE=$S(+IND:0,1:1)
"RTN","PSSMIGR1",136,0)
 .S:+IND IND=$$FMTHL7^XLFDT(IND)
"RTN","PSSMIGR1",137,0)
 .S PSV=$G(^PSNDF(50.6,IEN,"VUID"))
"RTN","PSSMIGR1",138,0)
 .S MAEN=$P(PSV,"^",2),VUID=$P(PSV,"^")
"RTN","PSSMIGR1",139,0)
 .S XIEN="<vaGenericIen>"_IEN_"</vaGenericIen>"
"RTN","PSSMIGR1",140,0)
 .S XNAME=$S(NAME="":"",1:"<name><![CDATA["_NAME_"]]></name>")
"RTN","PSSMIGR1",141,0)
 .S XIND=$S(IND="":"",1:"<inactivationDate>"_IND_"</inactivationDate>")
"RTN","PSSMIGR1",142,0)
 .S XMAEN="<masterEntryForVuid>"_MAEN_"</masterEntryForVuid>"
"RTN","PSSMIGR1",143,0)
 .S XVUID="<vuid>"_VUID_"</vuid>"
"RTN","PSSMIGR1",144,0)
 .S ^TMP($J,50.6,XTYPE,IEN)=XIEN_XNAME_XIND_XMAEN_XVUID
"RTN","PSSMIGR1",145,0)
 .I $D(^PSNDF(50.6,IEN,"TERMSTATUS",0)) D
"RTN","PSSMIGR1",146,0)
 ..S MIEN=0
"RTN","PSSMIGR1",147,0)
 ..F  S MIEN=$O(^PSNDF(50.6,IEN,"TERMSTATUS",MIEN)) Q:MIEN="B"  D
"RTN","PSSMIGR1",148,0)
 ...S PST0=^PSNDF(50.6,IEN,"TERMSTATUS",MIEN,0)
"RTN","PSSMIGR1",149,0)
 ...S EDT=$P(PST0,"^"),STA=$P(PST0,"^",2)
"RTN","PSSMIGR1",150,0)
 ...S EDT=$$FMTHL7^XLFDT(EDT)
"RTN","PSSMIGR1",151,0)
 ...S XEDT="<effectiveDateTime>"_EDT_"</effectiveDateTime>"
"RTN","PSSMIGR1",152,0)
 ...S XSTA="<status>"_STA_"</status>"
"RTN","PSSMIGR1",153,0)
 ...S ^TMP($J,50.6,XTYPE,IEN,MIEN)="<effectiveDateTime>"_XEDT_XSTA_"</effectiveDateTime>"
"RTN","PSSMIGR1",154,0)
 .S:XTYPE=TYPE CNT=CNT+1
"RTN","PSSMIGR1",155,0)
 Q
"RTN","PSSMIGR1",156,0)
VADC ; Process Migration for VA DRUG CLASS
"RTN","PSSMIGR1",157,0)
 ;
"RTN","PSSMIGR1",158,0)
 N CNT,CODE,CODE1,CLASS,CLASS1,EDT,MAEN,MIEN,PCLS,PS0,PS01,PS10,PST0,PSV,STA,TYP,VUID
"RTN","PSSMIGR1",159,0)
 N XCLASS,XCLASS1,XCODE,XCODE1,XEDT,XIEN,XIEN1,XMIEN,XPCLS,XSTA,XTMP,XTYP,XMAEN,XVUID
"RTN","PSSMIGR1",160,0)
 K ^TMP($J,50.605)
"RTN","PSSMIGR1",161,0)
 S CNT=0,^TMP($J,50.605,"EOF")=0
"RTN","PSSMIGR1",162,0)
 S FNAME="drugMigrationResponse_DrugClass.XML",FNUM=50.605
"RTN","PSSMIGR1",163,0)
 S FNAME1="vaDrugClass"
"RTN","PSSMIGR1",164,0)
 I IEN<0 D OUT^PSSMIGR(" Error... Invalid IEN") Q
"RTN","PSSMIGR1",165,0)
 I RCNT<1 D OUT^PSSMIGR(" Error... Invalid Starting Record Number") Q
"RTN","PSSMIGR1",166,0)
 I TYPE>3!(TYPE<0) D OUT^PSSMIGR(" Error... Invalid TYPE") Q
"RTN","PSSMIGR1",167,0)
 F  S IEN=$O(^PS(50.605,IEN)) D  Q:XST=1
"RTN","PSSMIGR1",168,0)
 .I +IEN=0 S ^TMP($J,50.605,"EOF")=1,XST=1 Q
"RTN","PSSMIGR1",169,0)
 .I RCNT=CNT S XST=1 Q
"RTN","PSSMIGR1",170,0)
 .S PS0=^PS(50.605,IEN,0)
"RTN","PSSMIGR1",171,0)
 .S CODE=$P(PS0,"^"),CLASS=$P(PS0,"^",2),PCLS=$P(PS0,"^",3),TYP=$P(PS0,"^",4)
"RTN","PSSMIGR1",172,0)
 .I TYP="" S TYP=3
"RTN","PSSMIGR1",173,0)
 .Q:TYP'=TYPE
"RTN","PSSMIGR1",174,0)
 .S PSV=$G(^PS(50.605,IEN,"VUID"))
"RTN","PSSMIGR1",175,0)
 .S MAEN=$P(PSV,"^",2),VUID=$P(PSV,"^"),XTMP=""
"RTN","PSSMIGR1",176,0)
 .;
"RTN","PSSMIGR1",177,0)
 .;Drug class row
"RTN","PSSMIGR1",178,0)
 .I +PCLS,$D(^PS(50.605,PCLS,0)) D
"RTN","PSSMIGR1",179,0)
 ..S PS01=^PS(50.605,PCLS,0)
"RTN","PSSMIGR1",180,0)
 ..S CODE1=$P(PS01,"^"),CLASS1=$P(PS01,"^",2)
"RTN","PSSMIGR1",181,0)
 ..S XIEN1="<vaDrugClassIen>"_PCLS_"</vaDrugClassIen>"
"RTN","PSSMIGR1",182,0)
 ..S XCODE1=$S(CODE1="":"",1:"<code>"_CODE1_"</code>")
"RTN","PSSMIGR1",183,0)
 ..S XCLASS1=$S(CLASS1="":"",1:"<classification>"_CLASS1_"</classification>")
"RTN","PSSMIGR1",184,0)
 ..S XTMP=XIEN1_XCODE1_XCLASS1
"RTN","PSSMIGR1",185,0)
 .;
"RTN","PSSMIGR1",186,0)
 .S XIEN="<vaDrugClassIen>"_IEN_"</vaDrugClassIen>"
"RTN","PSSMIGR1",187,0)
 .S XCODE=$S(CODE="":"",1:"<code>"_CODE_"</code>")
"RTN","PSSMIGR1",188,0)
 .S XCLASS=$S(CLASS="":"",1:"<classification>"_CLASS_"</classification>")
"RTN","PSSMIGR1",189,0)
 .S XPCLS=$S(PCLS="":"",1:"<parentClass>"_XTMP_"</parentClass>")
"RTN","PSSMIGR1",190,0)
 .S XTYP=$S(TYP="":"",1:"<type>"_TYP_"</type>")
"RTN","PSSMIGR1",191,0)
 .S XMAEN="<masterEntryForVuid>"_MAEN_"</masterEntryForVuid>"
"RTN","PSSMIGR1",192,0)
 .S XVUID="<vuid>"_VUID_"</vuid>"
"RTN","PSSMIGR1",193,0)
 .S ^TMP($J,50.605,TYP,IEN)=XIEN_XCODE_XCLASS_XPCLS_XTYP_XMAEN_XVUID
"RTN","PSSMIGR1",194,0)
 .;
"RTN","PSSMIGR1",195,0)
 .;Effective Date/Time Multiple
"RTN","PSSMIGR1",196,0)
 .I $D(^PS(50.605,IEN,"TERMSTATUS",0)) D
"RTN","PSSMIGR1",197,0)
 ..S MIEN=0
"RTN","PSSMIGR1",198,0)
 ..F  S MIEN=$O(^PS(50.605,IEN,"TERMSTATUS",MIEN)) Q:MIEN="B"  D
"RTN","PSSMIGR1",199,0)
 ...S PST0=^PS(50.605,IEN,"TERMSTATUS",MIEN,0)
"RTN","PSSMIGR1",200,0)
 ...S EDT=$P(PST0,"^"),STA=$P(PST0,"^",2)
"RTN","PSSMIGR1",201,0)
 ...S EDT=$$FMTHL7^XLFDT(EDT)
"RTN","PSSMIGR1",202,0)
 ...S XEDT="<effectiveDateTime>"_EDT_"</effectiveDateTime>"
"RTN","PSSMIGR1",203,0)
 ...S XSTA="<status>"_STA_"</status>"
"RTN","PSSMIGR1",204,0)
 ...S ^TMP($J,50.605,TYP,IEN,MIEN)="<effectiveDateTime>"_XEDT_XSTA_"</effectiveDateTime>"
"RTN","PSSMIGR1",205,0)
 .; Description - Word Processing Multiple
"RTN","PSSMIGR1",206,0)
 .I $D(^PS(50.605,IEN,1,0)) D
"RTN","PSSMIGR1",207,0)
 ..S MIEN=0
"RTN","PSSMIGR1",208,0)
 ..F  S MIEN=$O(^PS(50.605,IEN,1,MIEN)) Q:MIEN=""  D
"RTN","PSSMIGR1",209,0)
 ...S PS10=^PS(50.605,IEN,1,MIEN,0)
"RTN","PSSMIGR1",210,0)
 ...S XMIEN="4"_MIEN
"RTN","PSSMIGR1",211,0)
 ...S ^TMP($J,50.605,TYP,IEN,XMIEN)="<description>"_PS10_"</description>"
"RTN","PSSMIGR1",212,0)
 .S:TYP=TYPE CNT=CNT+1
"RTN","PSSMIGR1",213,0)
 Q
"RTN","PSSMIGR2")
0^3^B76354283
"RTN","PSSMIGR2",1,0)
PSSMIGR2 ;AJF - Receives and Process XML message from PEPS; 2/27/2012 1713
"RTN","PSSMIGR2",2,0)
 ;;1.0;PHARMACY ENTERPRISE PRODUCT SYSTEM;;;Build 38
"RTN","PSSMIGR2",3,0)
 ;;
"RTN","PSSMIGR2",4,0)
 ; Called from PSSMIGR1
"RTN","PSSMIGR2",5,0)
 ; Continue process migration request
"RTN","PSSMIGR2",6,0)
 ;;
"RTN","PSSMIGR2",7,0)
 ;
"RTN","PSSMIGR2",8,0)
DSFO(IEN,RCNT,TYPE) ; Process Migration for DOSAGE FORM
"RTN","PSSMIGR2",9,0)
 ;
"RTN","PSSMIGR2",10,0)
 ;
"RTN","PSSMIGR2",11,0)
 N CNT,XST,EFDC,IND,MIEN,NAME,PACK,PREP,PS0,PSM,PST0,VERB
"RTN","PSSMIGR2",12,0)
 N UNAME,UNIT,XEFDC,XIEN,XIEN1,XPACK,XTYPE,XUNIT,XND,XNAME,XIND
"RTN","PSSMIGR2",13,0)
 K ^TMP($J,50.606)
"RTN","PSSMIGR2",14,0)
 S CNT=0,^TMP($J,50.606,"EOF")=0,XST=0
"RTN","PSSMIGR2",15,0)
 S FNAME="drugMigrationResponse_DosageForm.XML",FNUM=50.606
"RTN","PSSMIGR2",16,0)
 S FNAME1="dosageForm"
"RTN","PSSMIGR2",17,0)
 I IEN<0 D OUT^PSSMIGR(" Error... Invalid IEN") Q
"RTN","PSSMIGR2",18,0)
 I RCNT<1 D OUT^PSSMIGR(" Error... Invalid Starting Record Number") Q
"RTN","PSSMIGR2",19,0)
 I TYPE>1!(TYPE<0) D OUT^PSSMIGR(" Error... Invalid TYPE") Q
"RTN","PSSMIGR2",20,0)
 F  S IEN=$O(^PS(50.606,IEN)) D  Q:XST=1
"RTN","PSSMIGR2",21,0)
 .I +IEN=0 S ^TMP($J,50.606,"EOF")=1,XST=1 Q
"RTN","PSSMIGR2",22,0)
 .I RCNT=CNT S XST=1 Q
"RTN","PSSMIGR2",23,0)
 .S PS0=^PS(50.606,IEN,0)
"RTN","PSSMIGR2",24,0)
 .S NAME=$P(PS0,"^"),IND=$P(PS0,"^",2)
"RTN","PSSMIGR2",25,0)
 .S XTYPE=$S(+IND:0,1:1)
"RTN","PSSMIGR2",26,0)
 .;Q:XTYPE'=TYPE
"RTN","PSSMIGR2",27,0)
 .S:+IND IND=$$FMTHL7^XLFDT(IND)
"RTN","PSSMIGR2",28,0)
 .S PSM=$G(^PS(50.606,IEN,"MISC")),EFDC=$P($G(^PS(50.606,IEN,1)),"^")
"RTN","PSSMIGR2",29,0)
 .S VERB=$P(PSM,"^"),PREP=$P(PSM,"^",3)
"RTN","PSSMIGR2",30,0)
 .S XIEN="<dosageFormIen>"_IEN_"</dosageFormIen>"
"RTN","PSSMIGR2",31,0)
 .S XNAME=$S(NAME="":"",1:"<name>"_NAME_"</name>")
"RTN","PSSMIGR2",32,0)
 .S XIND=$S(IND="":"",1:"<inactivationDate>"_IND_"</inactivationDate>")
"RTN","PSSMIGR2",33,0)
 .S XEFDC=$S(EFDC="":"",1:"<excludeFromDosageChecks>"_EFDC_"</excludeFromDosageChecks>")
"RTN","PSSMIGR2",34,0)
 .;
"RTN","PSSMIGR2",35,0)
 .S ^TMP($J,50.606,XTYPE,IEN)=XIEN_XNAME_XIND
"RTN","PSSMIGR2",36,0)
 .S ^TMP($J,50.606,XTYPE,IEN,999999)=XEFDC
"RTN","PSSMIGR2",37,0)
 .;
"RTN","PSSMIGR2",38,0)
 .;
"RTN","PSSMIGR2",39,0)
 .;Unit Multiple
"RTN","PSSMIGR2",40,0)
 .I $D(^PS(50.606,IEN,"UNIT",0)) D
"RTN","PSSMIGR2",41,0)
 ..S MIEN=0
"RTN","PSSMIGR2",42,0)
 ..F  S MIEN=$O(^PS(50.606,IEN,"UNIT",MIEN)) Q:MIEN="B"!(MIEN="")  D
"RTN","PSSMIGR2",43,0)
 ...S PST0=^PS(50.606,IEN,"UNIT",MIEN,0)
"RTN","PSSMIGR2",44,0)
 ...S UNIT=$P(PST0,"^"),PACK=$P(PST0,"^",2)
"RTN","PSSMIGR2",45,0)
 ...S:+UNIT UNAME=$P($G(^PS(50.607,UNIT,0)),"^")
"RTN","PSSMIGR2",46,0)
 ...S XIEN1="<unitsIen>"_MIEN_"</unitsIen>"
"RTN","PSSMIGR2",47,0)
 ...S XUNIT=$S(UNIT="":"",1:"<units>"_UNAME_"</units>")
"RTN","PSSMIGR2",48,0)
 ...S XPACK=$S(PACK="":"",1:"<package>"_PACK_"</package>")
"RTN","PSSMIGR2",49,0)
 ...S ^TMP($J,50.606,XTYPE,IEN,91_MIEN)="<units>"_XIEN1_XUNIT_XPACK_"</units>"
"RTN","PSSMIGR2",50,0)
 .;
"RTN","PSSMIGR2",51,0)
 .;Dispense Unit PER Dose Multiple
"RTN","PSSMIGR2",52,0)
 .I $D(^PS(50.606,IEN,"DUPD",0)) D
"RTN","PSSMIGR2",53,0)
 ..S MIEN=0
"RTN","PSSMIGR2",54,0)
 ..F  S MIEN=$O(^PS(50.606,IEN,"DUPD",MIEN)) Q:MIEN="B"!(MIEN="")  D
"RTN","PSSMIGR2",55,0)
 ...S PST0=^PS(50.606,IEN,"DUPD",MIEN,0)
"RTN","PSSMIGR2",56,0)
 ...S UNIT=$P(PST0,"^"),PACK=$P(PST0,"^",2)
"RTN","PSSMIGR2",57,0)
 ...S XIEN1="<dispenseUnitsPerDoseIen>"_MIEN_"</dispenseUnitsPerDoseIen>"
"RTN","PSSMIGR2",58,0)
 ...S XUNIT=$S(UNIT="":"",1:"<dispenseUnitsPerDose>"_UNIT_"</dispenseUnitsPerDose>")
"RTN","PSSMIGR2",59,0)
 ...S XPACK=$S(PACK="":"",1:"<package>"_PACK_"</package>")
"RTN","PSSMIGR2",60,0)
 ...S ^TMP($J,50.606,XTYPE,IEN,999_MIEN)="<dispenseUnitsPerDose>"_XIEN1_XUNIT_XPACK_"</dispenseUnitsPerDose>"
"RTN","PSSMIGR2",61,0)
 .S:XTYPE=TYPE CNT=CNT+1
"RTN","PSSMIGR2",62,0)
 Q
"RTN","PSSMIGR2",63,0)
 ;
"RTN","PSSMIGR2",64,0)
VAPD(IEN,RCNT,TYPE) ; Process Migration for VA Product
"RTN","PSSMIGR2",65,0)
 ;
"RTN","PSSMIGR2",66,0)
 ;
"RTN","PSSMIGR2",67,0)
 N CNT,ACTI,CPD,CSFS,CODE1,CLASS1,DOS,DOSF,EDCK,FMG,INAD,MIEN,MVUID,NAFI,NAFN,NAME,OVCK,XACTI,XCLASS1,XCODE1,XDOSF,XSVC,XTYPE,XUNTS,XVAPI,SVDC
"RTN","PSSMIGR2",68,0)
 N PDTC,PP,PS0,PS01,PS1,PS7,PST0,PVDC,SMSP,STA,STRG,STRN,SVC,TRTC,UNIT,UNTS,VADU,VAGN,VAPI,VAPN,VUID,XCPD,XCSFS,XSTRN,XTMP,XUNIT,XVAGN,GCNS
"RTN","PSSMIGR2",69,0)
 N XEDCK,XEDT,XFMG,XGCNS,XIEN,XIEN1,XINAD,XMIEN,XML,XML2,XML3,XMVUID,XNAFI,XNAFN,XOVCK,XPDTC,XPP,XPVDC,XSMSP,XSTA,XSTRG,XTRTC,XVADU,XVAPN,XVUID
"RTN","PSSMIGR2",70,0)
 N MADD,MACD,MIDD,MASD,MISD,NSFR,NLTG,PREG,NAFR,EDT,XNNAME
"RTN","PSSMIGR2",71,0)
 K ^TMP($J,50.68)
"RTN","PSSMIGR2",72,0)
 S CNT=0,^TMP($J,50.68,"EOF")=0
"RTN","PSSMIGR2",73,0)
 S FNAME="drugMigrationResponse_VAProduct.XML",FNUM=50.68
"RTN","PSSMIGR2",74,0)
 S FNAME1="vaProduct"
"RTN","PSSMIGR2",75,0)
 I IEN<0 D OUT^PSSMIGR(" Error... Invalid IEN") Q
"RTN","PSSMIGR2",76,0)
 I RCNT<1 D OUT^PSSMIGR(" Error... Invalid Starting Record Number") Q
"RTN","PSSMIGR2",77,0)
 I TYPE>1!(TYPE<0) D OUT^PSSMIGR(" Error... Invalid TYPE") Q
"RTN","PSSMIGR2",78,0)
 F  S IEN=$O(^PSNDF(50.68,IEN)) D  Q:XST=1
"RTN","PSSMIGR2",79,0)
 .I +IEN=0 S ^TMP($J,50.68,"EOF")=1,XST=1 Q
"RTN","PSSMIGR2",80,0)
 .I RCNT=CNT S XST=1 Q
"RTN","PSSMIGR2",81,0)
 .Q:'$D(^PSNDF(50.68,IEN,0))
"RTN","PSSMIGR2",82,0)
 .S PS0=^PSNDF(50.68,IEN,0)
"RTN","PSSMIGR2",83,0)
 .S NAME=$P(PS0,"^"),VAGN=$P(PS0,"^",2),DOSF=$P(PS0,"^",3),STRG=$P(PS0,"^",4),NAFN=$P(PS0,"^",6)
"RTN","PSSMIGR2",84,0)
 .S UNIT=$P(PS0,"^",5) S:+UNIT UNIT=$P($G(^PS(50.607,UNIT,0)),"^",1)
"RTN","PSSMIGR2",85,0)
 .S:VAGN]"" VAGN=$P($G(^PSNDF(50.6,VAGN,0)),"^")
"RTN","PSSMIGR2",86,0)
 .S:DOSF]"" DOSF=$P($G(^PS(50.606,DOSF,0)),"^")
"RTN","PSSMIGR2",87,0)
 .S PS1=$G(^PSNDF(50.68,IEN,1))
"RTN","PSSMIGR2",88,0)
 .S VAPN=$P(PS1,"^"),VAPI=$P(PS1,"^",2),TRTC=$P(PS1,"^",3),VADU=$P(PS1,"^",4),GCNS=$P(PS1,"^",5),PREG=$P(PS1,"^",6),NLTG=$P(PS1,"^",7)
"RTN","PSSMIGR2",89,0)
 .S VADU=$P($G(^PSNDF(50.64,+VADU,0)),"^")
"RTN","PSSMIGR2",90,0)
 .S PVDC=$P($G(^PSNDF(50.68,IEN,3)),"^"),OVCK=$P($G(^PSNDF(50.68,IEN,9)),"^",1)
"RTN","PSSMIGR2",91,0)
 .S EDCK=$P($G(^PSNDF(50.68,IEN,8)),"^")
"RTN","PSSMIGR2",92,0)
 .;Drug class row
"RTN","PSSMIGR2",93,0)
 .I +PVDC,$D(^PS(50.605,PVDC,0)) D
"RTN","PSSMIGR2",94,0)
 ..S PS01=^PS(50.605,PVDC,0)
"RTN","PSSMIGR2",95,0)
 ..S CODE1=$P(PS01,"^"),CLASS1=$P(PS01,"^",2)
"RTN","PSSMIGR2",96,0)
 ..S XIEN1="<vaDrugClassIen>"_PVDC_"</vaDrugClassIen>"
"RTN","PSSMIGR2",97,0)
 ..S XCODE1=$S(CODE1="":"",1:"<code>"_CODE1_"</code>")
"RTN","PSSMIGR2",98,0)
 ..S XCLASS1=$S(CLASS1="":"",1:"<classification>"_CLASS1_"</classification>")
"RTN","PSSMIGR2",99,0)
 ..S XTMP=XIEN1_XCODE1_XCLASS1
"RTN","PSSMIGR2",100,0)
 .;
"RTN","PSSMIGR2",101,0)
 .S SVDC=$P($G(^PSNDF(50.68,IEN,4,0)),"^")
"RTN","PSSMIGR2",102,0)
 .S NAFI=$P($G(^PSNDF(50.68,IEN,5)),"^")
"RTN","PSSMIGR2",103,0)
 .S NAFR=$P($G(^PSNDF(50.68,IEN,6,0)),"^")
"RTN","PSSMIGR2",104,0)
 .S PS7=$G(^PSNDF(50.68,IEN,7))
"RTN","PSSMIGR2",105,0)
 .S CSFS=$P(PS7,"^"),SMSP=$P(PS7,"^",2),INAD=$P(PS7,"^",3),MASD=$P(PS7,"^",4),MISD=$P(PS7,"^",5)
"RTN","PSSMIGR2",106,0)
 .S MADD=$P(PS7,"^",6),MIDD=$P(PS7,"^",7),MACD=$P(PS7,"^",8)
"RTN","PSSMIGR2",107,0)
 .S XTYPE=$S(+INAD:0,1:1)
"RTN","PSSMIGR2",108,0)
 .S:+INAD INAD=$$FMTHL7^XLFDT(INAD)
"RTN","PSSMIGR2",109,0)
 .S VUID=$P($G(^PSNDF(50.68,IEN,"VUID")),"^"),MVUID=$P($G(^PSNDF(50.68,IEN,"VUID")),"^",2)
"RTN","PSSMIGR2",110,0)
 .S DOS=$G(^PSNDF(50.68,IEN,"DOS"))
"RTN","PSSMIGR2",111,0)
 .S CPD=$P(DOS,"^"),PDTC=$P(DOS,"^",2),PP=$P(DOS,"^",3)
"RTN","PSSMIGR2",112,0)
 .S FMG=$P($G(^PSNDF(50.68,IEN,"MG")),"^")
"RTN","PSSMIGR2",113,0)
 .S SVC=$P($G(^PSNDF(50.68,IEN,"PFS")),"^")
"RTN","PSSMIGR2",114,0)
 .;
"RTN","PSSMIGR2",115,0)
 .S XIEN="<ndfProductIen>"_IEN_"</ndfProductIen>"
"RTN","PSSMIGR2",116,0)
 .S XNAME=$S(NAME="":"",1:"<name><![CDATA["_NAME_"]]></name>")
"RTN","PSSMIGR2",117,0)
 .S XVAGN=$S(VAGN="":"",1:"<vaGenericName><![CDATA["_VAGN_"]]></vaGenericName>")
"RTN","PSSMIGR2",118,0)
 .S XDOSF=$S(DOSF="":"",1:"<dosageForm>"_DOSF_"</dosageForm>")
"RTN","PSSMIGR2",119,0)
 .S XSTRG=$S(STRG="":"",1:"<strength><![CDATA["_STRG_"]]></strength>")
"RTN","PSSMIGR2",120,0)
 .s XUNIT=$s(UNIT="":"",1:"<units>"_UNIT_"</units>")
"RTN","PSSMIGR2",121,0)
 .S XNAFN=$S(NAFN="":"",1:"<nationalFormularyName><![CDATA["_NAFN_"]]></nationalFormularyName>")
"RTN","PSSMIGR2",122,0)
 .S XVAPN=$S(VAPN="":"",1:"<vaPrintName><![CDATA["_VAPN_"]]></vaPrintName>")
"RTN","PSSMIGR2",123,0)
 .S XVAPI=$S(VAPI="":"",1:"<vaProductIdentifier>"_VAPI_"</vaProductIdentifier>")
"RTN","PSSMIGR2",124,0)
 .S XTRTC=$S(TRTC="":"",1:"<transmitToCmop>"_TRTC_"</transmitToCmop>")
"RTN","PSSMIGR2",125,0)
 .S XVADU=$S(VADU="":"",1:"<vaDispenseUnit>"_VADU_"</vaDispenseUnit>")
"RTN","PSSMIGR2",126,0)
 .S XGCNS=$S(GCNS="":"",1:"<gcnSeqNo>"_GCNS_"</gcnSeqNo>")
"RTN","PSSMIGR2",127,0)
 .;
"RTN","PSSMIGR2",128,0)
 .S XPVDC=$S(PVDC="":"",1:"<primaryVaDrugClass>"_XTMP_"</primaryVaDrugClass>")
"RTN","PSSMIGR2",129,0)
 .S XNAFI=$S(NAFI="":"",1:"<nationalFormularyIndicator>"_NAFI_"</nationalFormularyIndicator>")
"RTN","PSSMIGR2",130,0)
 .S XCSFS=$S(CSFS="":"",1:"<csFederalSchedule>"_CSFS_"</csFederalSchedule>")
"RTN","PSSMIGR2",131,0)
 .S XSMSP=$S(SMSP="":"",1:"<singleMultiSourceProduct>"_SMSP_"</singleMultiSourceProduct>")
"RTN","PSSMIGR2",132,0)
 .S XINAD=$S(INAD="":"",1:"<inactivationDate>"_INAD_"</inactivationDate>")
"RTN","PSSMIGR2",133,0)
 .S XOVCK=$S(OVCK="":"",1:"<overrideDfDoseChkExclusion>"_OVCK_"</overrideDfDoseChkExclusion>")
"RTN","PSSMIGR2",134,0)
 .S XEDCK=$S(EDCK="":"",1:"<excludeDrugDrugInteraction>"_EDCK_"</excludeDrugDrugInteraction>")
"RTN","PSSMIGR2",135,0)
 .S XCPD=$S(CPD="":"",1:"<createPossibleDosage>"_CPD_"</createPossibleDosage>")
"RTN","PSSMIGR2",136,0)
 .S XPP=$S(PP="":"",1:"<productPackage>"_PP_"</productPackage>")
"RTN","PSSMIGR2",137,0)
 .S XMVUID=$S(MVUID="":"",1:"<masterEntryForVuid>"_MVUID_"</masterEntryForVuid>")
"RTN","PSSMIGR2",138,0)
 .S XVUID=$S(VUID="":"",1:"<vuid>"_VUID_"</vuid>")
"RTN","PSSMIGR2",139,0)
 .S XFMG=$S(FMG="":"",1:"<fdaMedGuide>"_FMG_"</fdaMedGuide>")
"RTN","PSSMIGR2",140,0)
 .S XSVC=$S(SVC="":"",1:"<serviceCode>"_SVC_"</serviceCode>")
"RTN","PSSMIGR2",141,0)
 .S XPDTC=$S(PDTC="":"",1:"<possibleDosagesToCreate>"_PDTC_"</possibleDosagesToCreate>")
"RTN","PSSMIGR2",142,0)
 .;
"RTN","PSSMIGR2",143,0)
 .S XML=XIEN_XNAME_XVAGN_XDOSF_XSTRG_XUNIT_XNAFN_XVAPN_XVAPI_XTRTC_XVADU_XGCNS
"RTN","PSSMIGR2",144,0)
 .S XML2=XPVDC_XNAFI_XCSFS_XSMSP_XINAD_XOVCK_XEDCK_XCPD_XPP_XMVUID_XVUID
"RTN","PSSMIGR2",145,0)
 .S XML3=XFMG_XSVC_XPDTC
"RTN","PSSMIGR2",146,0)
 .S ^TMP($J,50.68,XTYPE,IEN)=XML
"RTN","PSSMIGR2",147,0)
 .S ^TMP($J,50.68,XTYPE,IEN,9999)=XML2
"RTN","PSSMIGR2",148,0)
 .S ^TMP($J,50.68,XTYPE,IEN,99999)=XML3
"RTN","PSSMIGR2",149,0)
 .;
"RTN","PSSMIGR2",150,0)
 .;Active Ingredients Multiple
"RTN","PSSMIGR2",151,0)
 .I $D(^PSNDF(50.68,IEN,2,0)) D
"RTN","PSSMIGR2",152,0)
 ..S MIEN=0
"RTN","PSSMIGR2",153,0)
 ..F  S MIEN=$O(^PSNDF(50.68,IEN,2,MIEN)) Q:MIEN="B"!(MIEN="")  D
"RTN","PSSMIGR2",154,0)
 ...S PST0=^PSNDF(50.68,IEN,2,MIEN,0)
"RTN","PSSMIGR2",155,0)
 ...S ACTI=$P(PST0,"^"),STRN=$P(PST0,"^",2),UNTS=$P(PST0,"^",3)
"RTN","PSSMIGR2",156,0)
 ...S ACTI=$P($G(^PS(50.416,+ACTI,0)),"^")
"RTN","PSSMIGR2",157,0)
 ...S UNTS=$P($G(^PS(50.607,+UNTS,0)),"^")
"RTN","PSSMIGR2",158,0)
 ...S XMIEN=$S(MIEN="":"",1:"<activeIngredientIen>"_MIEN_"</activeIngredientIen>")
"RTN","PSSMIGR2",159,0)
 ...S XACTI=$S(ACTI="":"",1:"<ingredientName><![CDATA["_ACTI_"]]></ingredientName>")
"RTN","PSSMIGR2",160,0)
 ...S XSTRN=$S(STRN="":"",2:"<strength><![CDATA["_STRN_"]]></strength>")
"RTN","PSSMIGR2",161,0)
 ...S XUNTS=$S(UNTS="":"",3:"<units>"_UNTS_"</units>")
"RTN","PSSMIGR2",162,0)
 ...S XTMP=XMIEN_XACTI_XSTRN_XUNTS
"RTN","PSSMIGR2",163,0)
 ...S ^TMP($J,50.68,XTYPE,IEN,MIEN)="<activeIngredients>"_XTMP_"</activeIngredients>"
"RTN","PSSMIGR2",164,0)
 .;
"RTN","PSSMIGR2",165,0)
 .;Override DF Dose CHK Exclusion Multiple
"RTN","PSSMIGR2",166,0)
 .I $D(^PSNDF(50.68,IEN,"TERMSTATUS",0)) D
"RTN","PSSMIGR2",167,0)
 ..S MIEN=0
"RTN","PSSMIGR2",168,0)
 ..F  S MIEN=$O(^PSNDF(50.68,IEN,"TERMSTATUS",MIEN)) Q:MIEN="B"  D
"RTN","PSSMIGR2",169,0)
 ...S PST0=$G(^PSNDF(50.68,IEN,"TERMSTATUS",MIEN,0))
"RTN","PSSMIGR2",170,0)
 ...S EDT=$P(PST0,"^"),STA=$P(PST0,"^",2)
"RTN","PSSMIGR2",171,0)
 ...S EDT=$$FMTHL7^XLFDT(EDT)
"RTN","PSSMIGR2",172,0)
 ...S XEDT="<effectiveDateTime>"_EDT_"</effectiveDateTime>"
"RTN","PSSMIGR2",173,0)
 ...S XSTA="<status>"_STA_"</status>"
"RTN","PSSMIGR2",174,0)
 ...S ^TMP($J,50.68,XTYPE,IEN,9999_MIEN)="<effectiveDateTime>"_XEDT_XSTA_"</effectiveDateTime>"
"RTN","PSSMIGR2",175,0)
 .S:XTYPE=TYPE CNT=CNT+1
"RTN","PSSMIGR2",176,0)
 ;
"RTN","PSSMIGR2",177,0)
 Q
"RTN","PSSMIGRS")
0^4^B91482671
"RTN","PSSMIGRS",1,0)
PSSMIGRS ;AJF - Receives and Process Migration Synch XML message from PEPS; 05/15/2012 0645
"RTN","PSSMIGRS",2,0)
 ;;1.0;PHARMACY ENTERPRISE PRODUCT SYSTEM;;;Build 38
"RTN","PSSMIGRS",3,0)
 ;;
"RTN","PSSMIGRS",4,0)
 ; Start of Migration Sync code
"RTN","PSSMIGRS",5,0)
 ; Calls ^PSSMIGRT
"RTN","PSSMIGRS",6,0)
 ;;
"RTN","PSSMIGRS",7,0)
SYNC(XOBY,PSSMSG) ;Entry point into routine
"RTN","PSSMIGRS",8,0)
 N X,Y,DIR,PATH,FILE,DOCHAND,PSSFDA,XMLFILE,VAL,LEN,INPUT,XFILE,OUTCNT,PSS,PSTATUS
"RTN","PSSMIGRS",9,0)
 N RERR,PSNDC,PSUPN,PSMAN,PSTNAME,PSPNAME,PSSIZE,PSTYPE,PSOTC,NIEN,MIEN,TIEN,SIEN
"RTN","PSSMIGRS",10,0)
 N PSCNT,PSNUM,D,DA,DATE,DIC,DIE,DLAYGO,DOCHAND,DR,DT,FILE,FRMTENT,GT,IMPUT,LEN,MIEN,NIEN
"RTN","PSSMIGRS",11,0)
 N NWARRY,OUT,PS0,PSNDC1,XML2,PSIADT,NIEN2,PNIEN,DIK,PNT
"RTN","PSSMIGRS",12,0)
 ;
"RTN","PSSMIGRS",13,0)
 D DT^DICRW S U="^",INPUT="",OUTCNT=0,DATE=DT,PST=""
"RTN","PSSMIGRS",14,0)
 ;
"RTN","PSSMIGRS",15,0)
 S OUT=$NA(^UTILITY($J,"OUT"))
"RTN","PSSMIGRS",16,0)
 K ^UTILITY($J),^TMP($J,"XML OUT")
"RTN","PSSMIGRS",17,0)
 S ^TMP($J,"NDC1","START")=DATE
"RTN","PSSMIGRS",18,0)
 S ^TMP($J,"NDC1","XML")=$G(PSSMSG)
"RTN","PSSMIGRS",19,0)
 ;
"RTN","PSSMIGRS",20,0)
 D PRSTRING(.PSSMSG,.XMLFILE)
"RTN","PSSMIGRS",21,0)
 ;
"RTN","PSSMIGRS",22,0)
 S VAL="" F  S VAL=$O(XMLFILE(VAL)) Q:VAL=""  D
"RTN","PSSMIGRS",23,0)
 .S ^TMP($J,"XML OUT",VAL)=XMLFILE(VAL)
"RTN","PSSMIGRS",24,0)
 ;
"RTN","PSSMIGRS",25,0)
 ;**strip out any invisible ASCII characters before passing the TMP global to MXMLDOM
"RTN","PSSMIGRS",26,0)
 ;F  S PSS("charCount")=$O(^TMP($J,"XML OUT",PSS("charCount"))) Q:PSS("charCount")=""  D
"RTN","PSSMIGRS",27,0)
 ;F PSS("char")=0:1:32 S ^TMP($J,"XML OUT",PSS("charCount"))=$TRANSLATE(^TMP($J,"XML OUT",PSS("charCount")),$C(PSS("char")),"")
"RTN","PSSMIGRS",28,0)
 ;
"RTN","PSSMIGRS",29,0)
 ;**get handle to XML document in memory, the date/time message was received, and the DUZ of the associated user
"RTN","PSSMIGRS",30,0)
 S DOCHAND=$$EN^MXMLDOM($NA(^TMP($J,"XML OUT")),"VO")
"RTN","PSSMIGRS",31,0)
 S PSS("date/time")=$$NOW^XLFDT
"RTN","PSSMIGRS",32,0)
 S PSS("duz")=DUZ
"RTN","PSSMIGRS",33,0)
 S (PSUPN,MIEN,PSTNAME,PNIEN,SIEN,TIEN,PSOTC,PSIADT)=""
"RTN","PSSMIGRS",34,0)
 ;
"RTN","PSSMIGRS",35,0)
 ;**retrieve parent node attributes
"RTN","PSSMIGRS",36,0)
 S PSS("body")=$$PARENT^MXMLDOM(DOCHAND,2)
"RTN","PSSMIGRS",37,0)
 S PSS("bodyName")=$$NAME^MXMLDOM(DOCHAND,PSS("body"))
"RTN","PSSMIGRS",38,0)
 S PSS("status")=$$VALUE^MXMLDOM(DOCHAND,PSS("body"),"status")
"RTN","PSSMIGRS",39,0)
 S PSS("pepsIdNumber")=$$VALUE^MXMLDOM(DOCHAND,PSS("body"),"pepsIdNumber")
"RTN","PSSMIGRS",40,0)
 ;
"RTN","PSSMIGRS",41,0)
 I PSS("bodyName")="ndcMigrationSynchRequest" D
"RTN","PSSMIGRS",42,0)
 . S PSS("child")=1,PSS("FILE")=50.67,PSSTITLE="ndcMigrationSynchResponse",PST="ndc"
"RTN","PSSMIGRS",43,0)
 . F  S PSS("child")=$O(^TMP("MXMLDOM",$J,DOCHAND,PSS("child"))) Q:PSS("child")=""  D
"RTN","PSSMIGRS",44,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRS",45,0)
 .. I PSS("ELE")="ndc" S PSNDC=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",46,0)
 .. I PSS("ELE")="ndcIen" S NIEN=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",47,0)
 .. I PSS("ELE")="upn" S PSUPN=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",48,0)
 .. I PSS("ELE")="manufacturer" S PSMAN=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",49,0)
 .. I PSS("ELE")="manufacturerIen" S MIEN=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",50,0)
 .. I PSS("ELE")="tradeName" S PSTNAME=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",51,0)
 .. I PSS("ELE")="productName" S PSPNAME=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",52,0)
 .. I PSS("ELE")="productIen" S PIEN=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",53,0)
 .. I PSS("ELE")="packageSize" S PSSIZE=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",54,0)
 .. I PSS("ELE")="inactivationDate" S PSIADT=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",55,0)
 .. I PSS("ELE")="packageType" S PSTYPE=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",56,0)
 .. I PSS("ELE")="packageTypeIen" S PKIEN=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",57,0)
 .. I PSS("ELE")="otcRxIndicator" S PSOTC=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",58,0)
 .. I PSS("ELE")="status" S PSTATUS=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",59,0)
 ;
"RTN","PSSMIGRS",60,0)
 ;
"RTN","PSSMIGRS",61,0)
 I PSS("bodyName")="manufacturerMigrationSyncRequest" D
"RTN","PSSMIGRS",62,0)
 . S PSS("child")=1,PSS("FILE")=55.95,PSSTITLE="manufacturerMigrationSynchResponse",PST="manufacturer"
"RTN","PSSMIGRS",63,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,1,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRS",64,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRS",65,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",66,0)
 .. I PSS("ELE")="ien" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",67,0)
 .. I PSS("ELE")="manufacturer" S PSS("NAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",68,0)
 .. I PSS("ELE")="NDCNumber" S PSS("NDCNUM")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",69,0)
 .. I PSS("ELE")="inactivationDate" S PSS("IDATE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",70,0)
 ;
"RTN","PSSMIGRS",71,0)
 ;
"RTN","PSSMIGRS",72,0)
 I PSS("bodyName")="packageTypeMigrationSyncRequest" D
"RTN","PSSMIGRS",73,0)
 . S PSS("child")=1,PSS("FILE")=50.608,PSSTITLE="packageTypeMigrationSynchResponse",PST="packageType"
"RTN","PSSMIGRS",74,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,1,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRS",75,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRS",76,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",77,0)
 .. I PSS("ELE")="ien" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",78,0)
 .. I PSS("ELE")="packageType" S PSS("NAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",79,0)
 .. I PSS("ELE")="inactivationDate" S PSS("IDATE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",80,0)
 ;
"RTN","PSSMIGRS",81,0)
 ;
"RTN","PSSMIGRS",82,0)
 I PSS("bodyName")="drugUnitSyncRequest" D
"RTN","PSSMIGRS",83,0)
 . S PSS("child")=1,PSS("FILE")=50.607,PSSTITLE="drugUnitMigrationSynchResponse",PST="drugUnit"
"RTN","PSSMIGRS",84,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,1,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRS",85,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRS",86,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",87,0)
 .. I PSS("ELE")="ien" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",88,0)
 .. I PSS("ELE")="drugUnitName" S PSS("NAME")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",89,0)
 .. I PSS("ELE")="inactivationDate" S PSS("IDATE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",90,0)
 ;
"RTN","PSSMIGRS",91,0)
 I PSS("bodyName")="drugIngredientsSyncRequest" D
"RTN","PSSMIGRS",92,0)
 . S PSS("child")=2,PSS("FILE")=50.416
"RTN","PSSMIGRS",93,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,2,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRS",94,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRS",95,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",96,0)
 .. I PSS("ELE")="ien" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",97,0)
 ;
"RTN","PSSMIGRS",98,0)
 I PSS("bodyName")="genericNameSyncRequest" D
"RTN","PSSMIGRS",99,0)
 . S PSS("child")=2,PSS("FILE")=50.6
"RTN","PSSMIGRS",100,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,2,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRS",101,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRS",102,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",103,0)
 .. I PSS("ELE")="ien" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",104,0)
 ;
"RTN","PSSMIGRS",105,0)
 I PSS("bodyName")="dispenseUnitSyncRequest" D
"RTN","PSSMIGRS",106,0)
 . S PSS("child")=2,PSS("FILE")=50.64
"RTN","PSSMIGRS",107,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,2,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRS",108,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRS",109,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",110,0)
 .. I PSS("ELE")="ien" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",111,0)
 ;
"RTN","PSSMIGRS",112,0)
 I PSS("bodyName")="drugClassSyncRequest" D
"RTN","PSSMIGRS",113,0)
 . S PSS("child")=2,PSS("FILE")=50.605
"RTN","PSSMIGRS",114,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,2,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRS",115,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRS",116,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",117,0)
 .. I PSS("ELE")="ien" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",118,0)
 ;
"RTN","PSSMIGRS",119,0)
 I PSS("bodyName")="dosageFormSyncRequest" D
"RTN","PSSMIGRS",120,0)
 . S PSS("child")=2,PSS("FILE")=50.606
"RTN","PSSMIGRS",121,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,2,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRS",122,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRS",123,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",124,0)
 .. I PSS("ELE")="ien" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",125,0)
 ;
"RTN","PSSMIGRS",126,0)
 I PSS("bodyName")="productSyncRequest" D
"RTN","PSSMIGRS",127,0)
 . S PSS("child")=2,PSS("FILE")=50.68
"RTN","PSSMIGRS",128,0)
 . F  S PSS("child")=$$CHILD^MXMLDOM(DOCHAND,2,PSS("child")) Q:PSS("child")=0  D
"RTN","PSSMIGRS",129,0)
 .. S PSS("ELE")=$$NAME^MXMLDOM(DOCHAND,PSS("child"))
"RTN","PSSMIGRS",130,0)
 .. I PSS("ELE")="RequestType" S PSS("RTYPE")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",131,0)
 .. I PSS("ELE")="ien" S PSS("IEN")=^TMP("MXMLDOM",$J,DOCHAND,PSS("child"),"T",1)
"RTN","PSSMIGRS",132,0)
 ;
"RTN","PSSMIGRS",133,0)
 ; Date conversion
"RTN","PSSMIGRS",134,0)
 ;S PSIADT=$TR($P(PSIADT,"T",1),"-","")
"RTN","PSSMIGRS",135,0)
 ;S PSIADT=$$HL7TFM^XLFDT(PSIADT)
"RTN","PSSMIGRS",136,0)
 ;
"RTN","PSSMIGRS",137,0)
 ;Check for Migration Status
"RTN","PSSMIGRS",138,0)
 I $G(PSTATUS)="Start" D  Q
"RTN","PSSMIGRS",139,0)
 . S X=0 F  S X=$O(^PSNDF(50.67,X)) Q:X="NDC"  D
"RTN","PSSMIGRS",140,0)
 .. S:$P(^PSNDF(50.67,X,0),"^",7)="" ^TMP($J,"NDC",X)=""
"RTN","PSSMIGRS",141,0)
 . S XMESS=" Started ",XIEN="" D XMLR
"RTN","PSSMIGRS",142,0)
 ;
"RTN","PSSMIGRS",143,0)
 I $G(PSTATUS)="Stop" D  Q
"RTN","PSSMIGRS",144,0)
 . S X=0 F  S X=$O(^TMP($J,"NDC",X)) Q:X=""  D
"RTN","PSSMIGRS",145,0)
 ..Q:'$D(^PSNDF(50.67,X,0))  S $P(^PSNDF(50.67,X,0),"^",7)=DATE
"RTN","PSSMIGRS",146,0)
 . S XMESS=" Stop ",XIEN="" D XMLR
"RTN","PSSMIGRS",147,0)
 ;
"RTN","PSSMIGRS",148,0)
 ;
"RTN","PSSMIGRS",149,0)
MIGR D EN^PSSMIGRT(.PSS)
"RTN","PSSMIGRS",150,0)
 ;Process sync request
"RTN","PSSMIGRS",151,0)
 ;
"RTN","PSSMIGRS",152,0)
 ;
"RTN","PSSMIGRS",153,0)
 Q:$D(RERR)=1
"RTN","PSSMIGRS",154,0)
 ;
"RTN","PSSMIGRS",155,0)
 ;
"RTN","PSSMIGRS",156,0)
 ;
"RTN","PSSMIGRS",157,0)
 ;
"RTN","PSSMIGRS",158,0)
XMLR  ;**generate XML response message
"RTN","PSSMIGRS",159,0)
 ;
"RTN","PSSMIGRS",160,0)
 ;
"RTN","PSSMIGRS",161,0)
 S PSS("xmlResponse")=$$XMLBODY(.PSS)
"RTN","PSSMIGRS",162,0)
 ;
"RTN","PSSMIGRS",163,0)
 ;
"RTN","PSSMIGRS",164,0)
 ;**store value in VistALink return parameter
"RTN","PSSMIGRS",165,0)
 ;
"RTN","PSSMIGRS",166,0)
 ;
"RTN","PSSMIGRS",167,0)
 ;
"RTN","PSSMIGRS",168,0)
 ;Write the XML response message to a new file
"RTN","PSSMIGRS",169,0)
 S FILE=PSSTITLE_".XML"
"RTN","PSSMIGRS",170,0)
 S XML2=PSS("xmlHeader")_"<"_PSSTITLE_PSS("xmlns:xsi")
"RTN","PSSMIGRS",171,0)
 S XML2=XML2_PSS("xmlns")_">"_"<responseType>"_"<status>Success</status>"
"RTN","PSSMIGRS",172,0)
 S XML2=XML2_XMESS_"</responseType>"_XIEN
"RTN","PSSMIGRS",173,0)
 S XOBY=XML2_"</"_PSSTITLE_">"
"RTN","PSSMIGRS",174,0)
 S ^TMP($J,"NDC1","XOBY")=XOBY
"RTN","PSSMIGRS",175,0)
 ;
"RTN","PSSMIGRS",176,0)
 ;
"RTN","PSSMIGRS",177,0)
Q1 ; exit and clean-up
"RTN","PSSMIGRS",178,0)
 ;K ^TMP("MXMLDOM",$J)
"RTN","PSSMIGRS",179,0)
 ;
"RTN","PSSMIGRS",180,0)
 ;
"RTN","PSSMIGRS",181,0)
 Q
"RTN","PSSMIGRS",182,0)
 ;
"RTN","PSSMIGRS",183,0)
 ;
"RTN","PSSMIGRS",184,0)
RESPONSE(PSS) ;**check to see if current XML message was successfully written to the PEPS QUEUE file (#54.5)
"RTN","PSSMIGRS",185,0)
 N PSSOUT
"RTN","PSSMIGRS",186,0)
 ;
"RTN","PSSMIGRS",187,0)
 I $D(PSS("ERR")) S PSS("response")="Failure",PSS("attribValue")="<response status="""_PSS("response")_""">Unable to queue message.  Reason: "_$P(PSS("ERR"),"^",2)_"</response>"
"RTN","PSSMIGRS",188,0)
 E  I $D(^PSSPEPS("B",PSS("pepsIdNumber"))) S PSS("response")="Queued",PSS("attribValue")="<response status="""_PSS("response")_""">Message "_PSS("pepsIdNumber")_" is queued.</response>"
"RTN","PSSMIGRS",189,0)
 E  S PSS("response")="Failure",PSS("attribValue")="<response status="""_PSS("response")_""">Unable to queue message "_PSS("pepsIdNumber")_". Reason: "_$P($G(PSS("ERR")),"^",2)_"</response>"
"RTN","PSSMIGRS",190,0)
 S PSSOUT=$$XMLBODY(.PSS)
"RTN","PSSMIGRS",191,0)
 Q PSSOUT
"RTN","PSSMIGRS",192,0)
 ;
"RTN","PSSMIGRS",193,0)
XMLBODY(PSS) ;**generates response XML message
"RTN","PSSMIGRS",194,0)
 S PSS("xmlHeader")=$$XMLHDR^MXMLUTL
"RTN","PSSMIGRS",195,0)
 S PSS("xmlns:xsi")=" xmlns:xsi=""http://www.w3.org/2001/XMLSchema"""
"RTN","PSSMIGRS",196,0)
 S PSS("xmlns")=" xmlns=""gov/va/med/pharmacy/peps/external/common/vo/inbound/migration/"_PST_"/response"""
"RTN","PSSMIGRS",197,0)
 S PSSOUT=PSS("xmlHeader")
"RTN","PSSMIGRS",198,0)
 S PSSOUT=PSSOUT_"<"_PSSTITLE
"RTN","PSSMIGRS",199,0)
 S PSSOUT=PSSOUT_" "_PSS("xmlns:xsi")
"RTN","PSSMIGRS",200,0)
 S PSSOUT=PSSOUT_" "_PSS("xmlns")
"RTN","PSSMIGRS",201,0)
 Q PSSOUT
"RTN","PSSMIGRS",202,0)
 ;
"RTN","PSSMIGRS",203,0)
TRASH ;**delete XML handle
"RTN","PSSMIGRS",204,0)
 D DELETE^MXMLDOM(DOCHAND)
"RTN","PSSMIGRS",205,0)
 Q
"RTN","PSSMIGRS",206,0)
 ;
"RTN","PSSMIGRS",207,0)
OUT(X) ;Error message 
"RTN","PSSMIGRS",208,0)
 S FILE=PSSTITLE_".XML",RERR=1,PSS("xmlResponse")=$$XMLBODY(.PSS)
"RTN","PSSMIGRS",209,0)
 S XML2=PSS("xmlHeader")_"<"_PSSTITLE_PSS("xmlns:xsi")
"RTN","PSSMIGRS",210,0)
 S XML2=XML2_PSS("xmlns")_"><responseType><status>Failure</status>"
"RTN","PSSMIGRS",211,0)
 S XML2=XML2_"<message>"_X_"</message></responseType></"_PSSTITLE_">"
"RTN","PSSMIGRS",212,0)
 S XOBY=XML2
"RTN","PSSMIGRS",213,0)
 S ^TMP($J,"NDC1","OUT")=XOBY
"RTN","PSSMIGRS",214,0)
 D Q1
"RTN","PSSMIGRS",215,0)
 Q
"RTN","PSSMIGRS",216,0)
 ;
"RTN","PSSMIGRS",217,0)
PRSTRING(XML,NWARRY) ;**parses the incoming xml string coming back from PEPS
"RTN","PSSMIGRS",218,0)
 ;;
"RTN","PSSMIGRS",219,0)
 ;XML is the xml string that is passed by PEPS. 
"RTN","PSSMIGRS",220,0)
 ;It must be parsed into an array that is usable by MXML Kernel routines. 
"RTN","PSSMIGRS",221,0)
 ;;
"RTN","PSSMIGRS",222,0)
 I '$D(XML) D OUT(" Error... Invalid xml string") Q
"RTN","PSSMIGRS",223,0)
 N POS,GT,FRNTEND,CNT
"RTN","PSSMIGRS",224,0)
 ;**FRNTEND holds the front portion of the extracted data
"RTN","PSSMIGRS",225,0)
 S GT=">",POS=0
"RTN","PSSMIGRS",226,0)
 F CNT=0:1 Q:XML=""!(XML'[">")  D
"RTN","PSSMIGRS",227,0)
 .S POS=$F(XML,GT)
"RTN","PSSMIGRS",228,0)
 .S FRNTEND=$E(XML,1,POS-1)
"RTN","PSSMIGRS",229,0)
 .S XML=$E(XML,POS,$L(XML))
"RTN","PSSMIGRS",230,0)
 .S NWARRY(CNT)=FRNTEND
"RTN","PSSMIGRS",231,0)
 Q
"RTN","PSSMIGRS",232,0)
 ;
"RTN","PSSMIGRS",233,0)
 ;
"RTN","PSSMIGRS",234,0)
DATE(Y)  ;RETURN A DATE
"RTN","PSSMIGRS",235,0)
 I Y X ^DD("DD")
"RTN","PSSMIGRS",236,0)
 Q Y
"RTN","PSSMIGRS",237,0)
 ;
"RTN","PSSMIGRT")
0^5^B47611640
"RTN","PSSMIGRT",1,0)
PSSMIGRT ;AJF -  Process Migration Sync XML message from PEPS; 10/12/2012 0931
"RTN","PSSMIGRT",2,0)
 ;;1.0;PHARMACY ENTERPRISE PRODUCT SYSTEM;;7/11/2008;Build 38
"RTN","PSSMIGRT",3,0)
 ;;
"RTN","PSSMIGRT",4,0)
 ; Migration Sync continued
"RTN","PSSMIGRT",5,0)
 ;;
"RTN","PSSMIGRT",6,0)
EN(PSS) ;Entry point into routine
"RTN","PSSMIGRT",7,0)
 ;FL - File Number
"RTN","PSSMIGRT",8,0)
 ;IEN - The starting IEN
"RTN","PSSMIGRT",9,0)
 ;RCNT - Number of records desired
"RTN","PSSMIGRT",10,0)
 ;TYPE - 1
"RTN","PSSMIGRT",11,0)
 ;
"RTN","PSSMIGRT",12,0)
 ;
"RTN","PSSMIGRT",13,0)
 S FNAME="MigrationSyncResponse.XML"
"RTN","PSSMIGRT",14,0)
 S FL=$G(PSS("FILE"))
"RTN","PSSMIGRT",15,0)
 I FL="" D OUT^PSSMIGRS(" Error... Missing required data") Q
"RTN","PSSMIGRT",16,0)
 N XST,CNT,PS5
"RTN","PSSMIGRT",17,0)
 S CNT=0,XST=0
"RTN","PSSMIGRT",18,0)
 I FL=55.95 D MAN Q  ;Manufacturer
"RTN","PSSMIGRT",19,0)
 I FL=50.608 D PTYP Q  ;Package Type
"RTN","PSSMIGRT",20,0)
 I FL=50.67 D NDC Q  ;NDC 
"RTN","PSSMIGRT",21,0)
 ;File Error Process
"RTN","PSSMIGRT",22,0)
 D OUT^PSSMIGRS(" Error... Invalid File Number")
"RTN","PSSMIGRT",23,0)
 Q
"RTN","PSSMIGRT",24,0)
 ;
"RTN","PSSMIGRT",25,0)
MAN ; Migration Synch for Manufacturer file
"RTN","PSSMIGRT",26,0)
 ;
"RTN","PSSMIGRT",27,0)
 K ^TMP($J,55.95)
"RTN","PSSMIGRT",28,0)
 S CNT=0,^TMP($J,55.95,"EOF")=0
"RTN","PSSMIGRT",29,0)
 S FNAME="MigrationSyncResponse_Manufacturer.XML",FNUM=55.95
"RTN","PSSMIGRT",30,0)
 S FNAME1="Manufacturer"
"RTN","PSSMIGRT",31,0)
 ;
"RTN","PSSMIGRT",32,0)
 S:PSS("NAME")'="" PSS("IEN")=$O(^PS(55.95,"B",PSS("NAME"),""))
"RTN","PSSMIGRT",33,0)
 ;
"RTN","PSSMIGRT",34,0)
 I $G(PSS("IEN"))="" L +^PS(55.95,0):0 I $T D
"RTN","PSSMIGRT",35,0)
 .S PS0=^PS(55.95,0),PSCNT=$P(PS0,"^",3)+1,PSNUM=$P(PS0,"^",4)+1
"RTN","PSSMIGRT",36,0)
 .S $P(^PS(55.95,0),"^",3)=PSCNT,$P(^PS(55.95,0),"^",4)=PSNUM
"RTN","PSSMIGRT",37,0)
 .L -^PS(55.95,0)
"RTN","PSSMIGRT",38,0)
 .S MIEN=PSCNT
"RTN","PSSMIGRT",39,0)
 .S PSS("IEN")=MIEN
"RTN","PSSMIGRT",40,0)
 ;
"RTN","PSSMIGRT",41,0)
 S DA=PSS("IEN"),DIE="^PS(55.95,",IDATE=$TR($P($G(PSS("IDATE")),""),"-","")
"RTN","PSSMIGRT",42,0)
 S NAME=$G(PSS("NAME")),IDATE=$$HL7TFM^XLFDT(IDATE,"L")
"RTN","PSSMIGRT",43,0)
 S PS5=$G(^PS(55.95,DA,0)),DR="",PQ=""
"RTN","PSSMIGRT",44,0)
 S:$P(PS5,"^",1)'=NAME DR=".01///^S X=NAME" S:$L(DR) PQ=";"
"RTN","PSSMIGRT",45,0)
 S DR=DR_PQ_"2///^S X=IDATE"
"RTN","PSSMIGRT",46,0)
 D ^DIE
"RTN","PSSMIGRT",47,0)
 S XMESS="<message><![CDATA[  Updated Manufacturer: "_NAME_" ]]></message>"
"RTN","PSSMIGRT",48,0)
 S XIEN="<manufacturerIen>"_PSS("IEN")_"</manufacturerIen>"
"RTN","PSSMIGRT",49,0)
 Q
"RTN","PSSMIGRT",50,0)
 ;
"RTN","PSSMIGRT",51,0)
PTYP ; Migration Synch for PACKAGE TYPE file
"RTN","PSSMIGRT",52,0)
 ;
"RTN","PSSMIGRT",53,0)
 K ^TMP($J,50.608)
"RTN","PSSMIGRT",54,0)
 S CNT=0,^TMP($J,50.608,"EOF")=0
"RTN","PSSMIGRT",55,0)
 S FNAME="MigrationSyncResponse_packageType.XML",FNUM=50.608
"RTN","PSSMIGRT",56,0)
 S FNAME1="packageType"
"RTN","PSSMIGRT",57,0)
 ;
"RTN","PSSMIGRT",58,0)
 S:PSS("NAME")'="" PSS("IEN")=$O(^PS(50.608,"B",PSS("NAME"),""))
"RTN","PSSMIGRT",59,0)
 ;
"RTN","PSSMIGRT",60,0)
 I $G(PSS("IEN"))=""  L +^PS(50.608,0):0 I $T D
"RTN","PSSMIGRT",61,0)
 .S PS0=^PS(50.608,0),PSCNT=$P(PS0,"^",3)+1,PSNUM=$P(PS0,"^",4)+1
"RTN","PSSMIGRT",62,0)
 .S $P(^PS(50.608,0),"^",3)=PSCNT,$P(^PS(50.608,0),"^",4)=PSNUM
"RTN","PSSMIGRT",63,0)
 .L -^PS(50.608,0)
"RTN","PSSMIGRT",64,0)
 .S TIEN=PSCNT
"RTN","PSSMIGRT",65,0)
 .S PSS("IEN")=TIEN
"RTN","PSSMIGRT",66,0)
 ;
"RTN","PSSMIGRT",67,0)
 S DA=PSS("IEN"),DIE="^PS(50.608,",IDATE=$TR($P($G(PSS("IDATE")),""),"-","")
"RTN","PSSMIGRT",68,0)
 S NAME=$G(PSS("NAME")),IDATE=$$HL7TFM^XLFDT(IDATE,"L")
"RTN","PSSMIGRT",69,0)
 S PS5=$G(^PS(50.608,DA,0)),DR="",PQ=""
"RTN","PSSMIGRT",70,0)
 S:$P(PS5,"^",1)'=NAME DR=".01///^S X=NAME" S:$L(DR) PQ=";"
"RTN","PSSMIGRT",71,0)
 S DR=DR_PQ_"1///^S X=IDATE"
"RTN","PSSMIGRT",72,0)
 D ^DIE
"RTN","PSSMIGRT",73,0)
 S XMESS="<message><![CDATA[  Updated Package Type: "_NAME_"  ]]></message>"
"RTN","PSSMIGRT",74,0)
 S XIEN="<packageTypeIen>"_PSS("IEN")_"</packageTypeIen>"
"RTN","PSSMIGRT",75,0)
 Q
"RTN","PSSMIGRT",76,0)
 ;
"RTN","PSSMIGRT",77,0)
 ;
"RTN","PSSMIGRT",78,0)
NDC ;  Migration Synch for NDC
"RTN","PSSMIGRT",79,0)
 ;
"RTN","PSSMIGRT",80,0)
 N NIEN,PIEN1,MIEN1,PKIEN1,PSPNAME1,PSTYPE1,PSMAN1,SCK
"RTN","PSSMIGRT",81,0)
 S PSNDC1=$TR($G(PSNDC),"-",""),(NIEN,PIEN1,MIEN1,PKIEN1,PSPNAME1,PSTYPE1,PSMAN1)=""
"RTN","PSSMIGRT",82,0)
 D DT^DICRW
"RTN","PSSMIGRT",83,0)
 ;
"RTN","PSSMIGRT",84,0)
 ; Match Product IEN and Name
"RTN","PSSMIGRT",85,0)
 S:$G(PIEN)'="" PSPNAME1=$P($G(^PSNDF(50.68,PIEN,0)),"^")
"RTN","PSSMIGRT",86,0)
 S PSPNAME1=$$UPC(PSPNAME1),PSPNAME1=$$TR(PSPNAME1)
"RTN","PSSMIGRT",87,0)
 I PSPNAME'=PSPNAME1 D OUT^PSSMIGRS(" Error... Product Names Don't Match") Q
"RTN","PSSMIGRT",88,0)
 ;
"RTN","PSSMIGRT",89,0)
 ; Match Manufacturer IEN and Name
"RTN","PSSMIGRT",90,0)
 S:$G(MIEN)'="" PSMAN1=$P($G(^PS(55.95,MIEN,0)),"^")
"RTN","PSSMIGRT",91,0)
 S PSMAN1=$$UPC(PSMAN1),PSMAN1=$$TR(PSMAN1)
"RTN","PSSMIGRT",92,0)
 I PSMAN'=PSMAN1 D OUT^PSSMIGRS(" Error... Manufacturer Names Don't Match") Q
"RTN","PSSMIGRT",93,0)
 ;
"RTN","PSSMIGRT",94,0)
 ; Match Package Type IEN and Name
"RTN","PSSMIGRT",95,0)
 S:$G(PKIEN)'="" PSTYPE1=$P($G(^PS(50.608,PKIEN,0)),"^")
"RTN","PSSMIGRT",96,0)
 S PSTYPE1=$$UPC(PSTYPE1),PSTYPE1=$$TR(PSTYPE1)
"RTN","PSSMIGRT",97,0)
 I PSTYPE'=PSTYPE1 D OUT^PSSMIGRS(" Error... Package Type Names Don't Match") Q
"RTN","PSSMIGRT",98,0)
 ;
"RTN","PSSMIGRT",99,0)
 ; Package Size
"RTN","PSSMIGRT",100,0)
 I PSSIZE'="" S SIEN="",SCK=0 D
"RTN","PSSMIGRT",101,0)
 .F  S SIEN=$O(^PS(50.609,"B",PSSIZE,SIEN)) Q:SIEN=""  D  Q:+SCK
"RTN","PSSMIGRT",102,0)
 ..S:$P(^PS(50.609,SIEN,0),"^",2)="" SCK=1
"RTN","PSSMIGRT",103,0)
 I SIEN="" L +^PS(50.609,0):0 I $T D
"RTN","PSSMIGRT",104,0)
 .S PS0=^PS(50.609,0),PSCNT=$P(PS0,"^",3)+1,PSNUM=$P(PS0,"^",4)+1
"RTN","PSSMIGRT",105,0)
 .S $P(^PS(50.609,0),"^",3)=PSCNT,$P(^PS(50.609,0),"^",4)=PSNUM
"RTN","PSSMIGRT",106,0)
 .L -^PS(50.609,0)
"RTN","PSSMIGRT",107,0)
 .S SIEN=PSCNT
"RTN","PSSMIGRT",108,0)
 .;S ^PS(50.609,SIEN,0)=PSSIZE
"RTN","PSSMIGRT",109,0)
 .;S ^PS(50.609,"B",PSSIZE,SIEN)=""
"RTN","PSSMIGRT",110,0)
 .;
"RTN","PSSMIGRT",111,0)
 .S DA=SIEN,DIE="^PS(50.609,"
"RTN","PSSMIGRT",112,0)
 .S DR=".01///^S X=PSSIZE"
"RTN","PSSMIGRT",113,0)
 .D ^DIE
"RTN","PSSMIGRT",114,0)
 ;
"RTN","PSSMIGRT",115,0)
 ; 
"RTN","PSSMIGRT",116,0)
 ; NDC Lookup
"RTN","PSSMIGRT",117,0)
 I NIEN="" S NIEN=$O(^PSNDF(50.67,"NDC",PSNDC1,""))
"RTN","PSSMIGRT",118,0)
 ;
"RTN","PSSMIGRT",119,0)
 ; Create new NDC entry
"RTN","PSSMIGRT",120,0)
 I NIEN="" D
"RTN","PSSMIGRT",121,0)
 .L +^PSNDF(50.67,0):0 I $T D
"RTN","PSSMIGRT",122,0)
 ..S PS0=^PSNDF(50.67,0),PSCNT=$P(PS0,"^",3)+1
"RTN","PSSMIGRT",123,0)
 ..S $P(^PSNDF(50.67,0),"^",3)=PSCNT
"RTN","PSSMIGRT",124,0)
 ..L -^PSNDF(50.67,0)
"RTN","PSSMIGRT",125,0)
 ..S X=PSCNT,DIC=50.67,DIC(0)="LMXZ"
"RTN","PSSMIGRT",126,0)
 ..D ^DIC
"RTN","PSSMIGRT",127,0)
 ..S:Y'="-1" NIEN=$P(Y,"^")
"RTN","PSSMIGRT",128,0)
 ;
"RTN","PSSMIGRT",129,0)
 I NIEN="" D OUT^PSSMIGRS(" Error... Unable To Create NEW IEN") Q 
"RTN","PSSMIGRT",130,0)
 ;
"RTN","PSSMIGRT",131,0)
 I PSIADT="" S $P(^PSNDF(50.67,NIEN,0),"^",7)=""
"RTN","PSSMIGRT",132,0)
 ;
"RTN","PSSMIGRT",133,0)
 ;
"RTN","PSSMIGRT",134,0)
 ; Date conversion
"RTN","PSSMIGRT",135,0)
 S PSIADT=$TR($P(PSIADT,"T",1),"-","")
"RTN","PSSMIGRT",136,0)
 S PSIADT=$$HL7TFM^XLFDT(PSIADT)
"RTN","PSSMIGRT",137,0)
 ;
"RTN","PSSMIGRT",138,0)
 ;
"RTN","PSSMIGRT",139,0)
 ;
"RTN","PSSMIGRT",140,0)
 S NDF0=$G(^PSNDF(50.67,NIEN,0))
"RTN","PSSMIGRT",141,0)
 S DA=NIEN,DIE="^PSNDF(50.67,",DR="",PQ=""
"RTN","PSSMIGRT",142,0)
 S:$P(NDF0,"^",2)'=PSNDC DR="1///^S X=PSNDC" S:$L(DR) PQ=";"
"RTN","PSSMIGRT",143,0)
 S:$P(NDF0,"^",3)'=PSUPN DR=DR_PQ_"2///"_$S(PSUPN]"":"^S X=PSUPN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRT",144,0)
 S:$P(NDF0,"^",4)'=MIEN DR=DR_PQ_"3///^S X=MIEN" S:$L(DR) PQ=";"
"RTN","PSSMIGRT",145,0)
 S:$P(NDF0,"^",5)'=PSTNAME DR=DR_PQ_"4///"_$S(PSTNAME]"":"^S X=PSTNAME",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRT",146,0)
 S:$P(NDF0,"^",6)'=PIEN DR=DR_PQ_"5///^S X=PIEN" S:$L(DR) PQ=";"
"RTN","PSSMIGRT",147,0)
 S:$P(NDF0,"^",7)'=PSIADT DR=DR_PQ_"7///"_$S(PSIADT]"":"^S X=PSIADT",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRT",148,0)
 S:$P(NDF0,"^",8)'=SIEN DR=DR_PQ_"8///"_$S(SIEN]"":"^S X=SIEN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRT",149,0)
 S:$P(NDF0,"^",9)'=PKIEN DR=DR_PQ_"9///"_$S(PKIEN]"":"^S X=PKIEN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRT",150,0)
 S PSOT=$S(PSOTC="Prescription":"R",PSOTC="Over the Counter":"O",1:"")
"RTN","PSSMIGRT",151,0)
 S:$P(NDF0,"^",10)'=PSOT DR=DR_PQ_"10///"_$S(PSOTC]"":"^S X=PSOTC",1:"@")
"RTN","PSSMIGRT",152,0)
 D ^DIE
"RTN","PSSMIGRT",153,0)
 ;
"RTN","PSSMIGRT",154,0)
 I '$D(^PSNDF(50.67,NIEN,1,0)) D
"RTN","PSSMIGRT",155,0)
 .; Stuff ROUTE OF ADMINISTRATION entries
"RTN","PSSMIGRT",156,0)
 .S DIC="^PSNDF(50.67,"_NIEN_",1,",DIC(0)="L",DIC("P")="50.676A"
"RTN","PSSMIGRT",157,0)
 .S DA(1)=NIEN,DA=1,X="N/A" D FILE^DICN
"RTN","PSSMIGRT",158,0)
 .;
"RTN","PSSMIGRT",159,0)
 S NIEN2=NIEN
"RTN","PSSMIGRT",160,0)
 F  S NIEN2=$O(^PSNDF(50.67,"NDC",PSNDC1,NIEN2)) Q:NIEN2=""  D
"RTN","PSSMIGRT",161,0)
 . D DT^DICRW S DA=NIEN2,DIE=50.67,PSIADT=DT
"RTN","PSSMIGRT",162,0)
 . S NDF0=$G(^PSNDF(50.67,NIEN2,0))
"RTN","PSSMIGRT",163,0)
 . S DR="7///^S X=PSIADT"
"RTN","PSSMIGRT",164,0)
 . S:$P(NDF0,"^",2)'=PSNDC DR=DR_";1///^S X=PSNDC"
"RTN","PSSMIGRT",165,0)
 . S:$P(NDF0,"^",3)'=PSUPN DR=DR_";2///"_$S(PSUPN]"":"^S X=PSUPN",1:"@")
"RTN","PSSMIGRT",166,0)
 . S:$P(NDF0,"^",4)'=MIEN DR=DR_";3///^S X=MIEN"
"RTN","PSSMIGRT",167,0)
 . S:$P(NDF0,"^",5)'=PSTNAME DR=DR_";4///"_$S(PSTNAME]"":"^S X=PSTNAME",1:"@")
"RTN","PSSMIGRT",168,0)
 . S:$P(NDF0,"^",6)'=PIEN DR=DR_";5///^S X=PIEN"
"RTN","PSSMIGRT",169,0)
 . S:$P(NDF0,"^",8)'=SIEN DR=DR_";8///"_$S(SIEN]"":"^S X=SIEN",1:"@")
"RTN","PSSMIGRT",170,0)
 . S:$P(NDF0,"^",9)'=PKIEN DR=DR_";9///"_$S(PKIEN]"":"^S X=PKIEN",1:"@")
"RTN","PSSMIGRT",171,0)
 . S PSOT=$S(PSOTC="Prescription":"R",PSOTC="Over the Counter":"O",1:"")
"RTN","PSSMIGRT",172,0)
 . S:$P(NDF0,"^",10)'=PSOT DR=DR_";10///"_$S(PSOTC]"":"^S X=PSOTC",1:"@")
"RTN","PSSMIGRT",173,0)
 . D ^DIE
"RTN","PSSMIGRT",174,0)
 ;
"RTN","PSSMIGRT",175,0)
 S XMESS="<message>  Updated ndcName: "_PSNDC_" </message>"
"RTN","PSSMIGRT",176,0)
 S XIEN="<ndcIen>"_NIEN_"</ndcIen>"
"RTN","PSSMIGRT",177,0)
 ;
"RTN","PSSMIGRT",178,0)
 ;
"RTN","PSSMIGRT",179,0)
 K ^TMP($J,"NDC",NIEN)
"RTN","PSSMIGRT",180,0)
 ;
"RTN","PSSMIGRT",181,0)
 Q
"RTN","PSSMIGRT",182,0)
UPC(X) ;convert lower case to upper case
"RTN","PSSMIGRT",183,0)
 Q $TR(X,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSSMIGRT",184,0)
 ;
"RTN","PSSMIGRT",185,0)
TR(X)    ;Strip trailing blanks
"RTN","PSSMIGRT",186,0)
 Q:$G(X)="" X
"RTN","PSSMIGRT",187,0)
 N I
"RTN","PSSMIGRT",188,0)
 F I=$L(X):-1:0 Q:$E(X,I)'=" "
"RTN","PSSMIGRT",189,0)
 Q $E(X,1,I)
"RTN","PSSMIGRT",190,0)
 ;
"VER")
8.0^22.0
**END**
**END**
