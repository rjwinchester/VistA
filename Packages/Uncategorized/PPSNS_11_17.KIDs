KIDS Distribution saved on Aug 21, 2014@16:08:27
PATCH 17
**KIDS**:PPSNS*1.1*17^

**INSTALL NAME**
PPSNS*1.1*17
"BLD",1495,0)
PPSNS*1.1*17^^0^3140821^y
"BLD",1495,4,0)
^9.64PA^^
"BLD",1495,6.3)
1
"BLD",1495,"KRN",0)
^9.67PA^9002226^21
"BLD",1495,"KRN",.4,0)
.4
"BLD",1495,"KRN",.401,0)
.401
"BLD",1495,"KRN",.402,0)
.402
"BLD",1495,"KRN",.403,0)
.403
"BLD",1495,"KRN",.5,0)
.5
"BLD",1495,"KRN",.84,0)
.84
"BLD",1495,"KRN",3.6,0)
3.6
"BLD",1495,"KRN",3.8,0)
3.8
"BLD",1495,"KRN",9.2,0)
9.2
"BLD",1495,"KRN",9.8,0)
9.8
"BLD",1495,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",1495,"KRN",9.8,"NM",1,0)
PSSMIGRD^^0^B227164495
"BLD",1495,"KRN",9.8,"NM",2,0)
PSSMIGRE^^0^B181541115
"BLD",1495,"KRN",9.8,"NM","B","PSSMIGRD",1)

"BLD",1495,"KRN",9.8,"NM","B","PSSMIGRE",2)

"BLD",1495,"KRN",19,0)
19
"BLD",1495,"KRN",19.1,0)
19.1
"BLD",1495,"KRN",101,0)
101
"BLD",1495,"KRN",409.61,0)
409.61
"BLD",1495,"KRN",771,0)
771
"BLD",1495,"KRN",779.2,0)
779.2
"BLD",1495,"KRN",870,0)
870
"BLD",1495,"KRN",8989.51,0)
8989.51
"BLD",1495,"KRN",8989.52,0)
8989.52
"BLD",1495,"KRN",8994,0)
8994
"BLD",1495,"KRN",9002226,0)
9002226
"BLD",1495,"KRN","B",.4,.4)

"BLD",1495,"KRN","B",.401,.401)

"BLD",1495,"KRN","B",.402,.402)

"BLD",1495,"KRN","B",.403,.403)

"BLD",1495,"KRN","B",.5,.5)

"BLD",1495,"KRN","B",.84,.84)

"BLD",1495,"KRN","B",3.6,3.6)

"BLD",1495,"KRN","B",3.8,3.8)

"BLD",1495,"KRN","B",9.2,9.2)

"BLD",1495,"KRN","B",9.8,9.8)

"BLD",1495,"KRN","B",19,19)

"BLD",1495,"KRN","B",19.1,19.1)

"BLD",1495,"KRN","B",101,101)

"BLD",1495,"KRN","B",409.61,409.61)

"BLD",1495,"KRN","B",771,771)

"BLD",1495,"KRN","B",779.2,779.2)

"BLD",1495,"KRN","B",870,870)

"BLD",1495,"KRN","B",8989.51,8989.51)

"BLD",1495,"KRN","B",8989.52,8989.52)

"BLD",1495,"KRN","B",8994,8994)

"BLD",1495,"KRN","B",9002226,9002226)

"MBREQ")
0
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSSMIGRD")
0^1^B227164495
"RTN","PSSMIGRD",1,0)
PSSMIGRD ;AJF - Process Sync XML message from PEPS;  12/14/2012 1403 ; 8/21/14 12:51pm
"RTN","PSSMIGRD",2,0)
 ;;1.0;PHARMACY ENTERPRISE PRODUCT SYSTEM;;7/11/2008;Build 1
"RTN","PSSMIGRD",3,0)
 ;;
"RTN","PSSMIGRD",4,0)
 ;  Process Sync request
"RTN","PSSMIGRD",5,0)
 ;  Called from ^PSSMIGRC
"RTN","PSSMIGRD",6,0)
 ;  Calls to ^PSSMIGRE and PSSMIGRR
"RTN","PSSMIGRD",7,0)
 ;;
"RTN","PSSMIGRD",8,0)
EN(PSS) ;Entry point into routine
"RTN","PSSMIGRD",9,0)
 ; FL - File
"RTN","PSSMIGRD",10,0)
 ; IEN - The starting IEN
"RTN","PSSMIGRD",11,0)
 ; RCNT - Number of records desired
"RTN","PSSMIGRD",12,0)
 ; TYPE - 1
"RTN","PSSMIGRD",13,0)
 ;
"RTN","PSSMIGRD",14,0)
 ;
"RTN","PSSMIGRD",15,0)
 S FNAME="SyncResponse.XML"
"RTN","PSSMIGRD",16,0)
 S FL=$G(PSS("FILE"))
"RTN","PSSMIGRD",17,0)
 I FL="" D OUT^PSSMIGRC(" Error... Missing required data") Q
"RTN","PSSMIGRD",18,0)
 N XST,CNT
"RTN","PSSMIGRD",19,0)
 S CNT=0,XST=0
"RTN","PSSMIGRD",20,0)
 I FL=50.607 D DUNI Q  ;Drug Unit
"RTN","PSSMIGRD",21,0)
 I FL=50.416 D DING Q  ;Drug Ingredients
"RTN","PSSMIGRD",22,0)
 I FL=50.605 D VADC Q  ;VA Drug Class
"RTN","PSSMIGRD",23,0)
 I FL=50.606 D DSFO Q  ;Dosage Form
"RTN","PSSMIGRD",24,0)
 I FL=50.6 D VAGN^PSSMIGRE Q  ;VA Generic Name
"RTN","PSSMIGRD",25,0)
 I FL=50.64 D VADU Q  ; VA Dispense UNIT
"RTN","PSSMIGRD",26,0)
 I FL=55.95 D MAN^PSSMIGRE Q  ;Manufacturer
"RTN","PSSMIGRD",27,0)
 I FL=50.608 D PTYP^PSSMIGRE Q  ;Package Type
"RTN","PSSMIGRD",28,0)
 I FL=50.67 D NDC^PSSMIGRE Q  ;NDC 
"RTN","PSSMIGRD",29,0)
 I FL=50.68 D VAPD^PSSMIGRR Q  ;VA Product
"RTN","PSSMIGRD",30,0)
 ;
"RTN","PSSMIGRD",31,0)
 ;File Error Process
"RTN","PSSMIGRD",32,0)
 D OUT^PSSMIGRC(" Error... Invalid File Number")
"RTN","PSSMIGRD",33,0)
 Q
"RTN","PSSMIGRD",34,0)
 ;
"RTN","PSSMIGRD",35,0)
 ;DIA(50.
"RTN","PSSMIGRD",36,0)
DUNI ; DRUG UNIT file Synch 
"RTN","PSSMIGRD",37,0)
 ;
"RTN","PSSMIGRD",38,0)
 N X,Y,DIC,DA,DR,DIE,IEN,NAME,RTYPE,IDATE,PS5
"RTN","PSSMIGRD",39,0)
 I PSS("NAME")="" D OUT^PSSMIGRC(" Error...Missing Required NAME") Q
"RTN","PSSMIGRD",40,0)
 S NAME=$G(PSS("NAME")),IEN=$G(PSS("IEN")),RTYPE=$G(PSS("RTYPE"))
"RTN","PSSMIGRD",41,0)
 S IDATE=$TR($P($G(PSS("IDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE,"L")
"RTN","PSSMIGRD",42,0)
 S FNAME="syncResponse.XML",FNUM=50.607
"RTN","PSSMIGRD",43,0)
 S FNAME1="drugUnits"
"RTN","PSSMIGRD",44,0)
 ;
"RTN","PSSMIGRD",45,0)
 ;Add the DRUG UNIT to the Database
"RTN","PSSMIGRD",46,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRD",47,0)
 . ; Lock the Global
"RTN","PSSMIGRD",48,0)
 . L +^PS(50.607):5 E  D OUT^PSSMIGRC(" Another USER editing DRUG UNIT file") Q
"RTN","PSSMIGRD",49,0)
 . ;
"RTN","PSSMIGRD",50,0)
 . ; Cheating - Remove LAYGO temporarly
"RTN","PSSMIGRD",51,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.607,.01,"LAYGO",.01,0))
"RTN","PSSMIGRD",52,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.607,.01,"LAYGO",.01,0)
"RTN","PSSMIGRD",53,0)
 . ;
"RTN","PSSMIGRD",54,0)
 . ; Get the IEN
"RTN","PSSMIGRD",55,0)
 . S X=NAME,DIC=50.607,DIC(0)="LMXZ"
"RTN","PSSMIGRD",56,0)
 . D ^DIC
"RTN","PSSMIGRD",57,0)
 . S (DA,PSS("IEN"))=+Y
"RTN","PSSMIGRD",58,0)
 . ;
"RTN","PSSMIGRD",59,0)
 . ; Quit if cannot get IEN
"RTN","PSSMIGRD",60,0)
 . I Y<1 D  Q
"RTN","PSSMIGRD",61,0)
 . . D OUT^PSSMIGRC(" Error...Cannot obtain an IEN for NAME")
"RTN","PSSMIGRD",62,0)
 . . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.607,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",63,0)
 . ;
"RTN","PSSMIGRD",64,0)
 . ; Set Database Variables
"RTN","PSSMIGRD",65,0)
 . S PSS("IEN")=DA,DIE=DIC K DIC
"RTN","PSSMIGRD",66,0)
 . ;S DR=".01///^S X=NAME;1///^S X=IDATE"
"RTN","PSSMIGRD",67,0)
 . S DR="1///^S X=IDATE"
"RTN","PSSMIGRD",68,0)
 . ;
"RTN","PSSMIGRD",69,0)
 . ; Update Database
"RTN","PSSMIGRD",70,0)
 . D ^DIE
"RTN","PSSMIGRD",71,0)
 . ;
"RTN","PSSMIGRD",72,0)
 . ; Put LAYGO back
"RTN","PSSMIGRD",73,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.607,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",74,0)
 . L -^PS(50.607)
"RTN","PSSMIGRD",75,0)
 ;
"RTN","PSSMIGRD",76,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRD",77,0)
 .S DA=PSS("IEN"),DIE="^PS(50.607,"
"RTN","PSSMIGRD",78,0)
 .;S DR=".01///^S X=NAME;1///"_$S(IDATE]"":"^S X=IDATE",1:"@")
"RTN","PSSMIGRD",79,0)
 .S PS5=$G(^PS(50.607,DA,0)),DR="",PQ=""
"RTN","PSSMIGRD",80,0)
 .S:$P(PS5,"^",1)'=NAME DR=".01///^S X=NAME" S:$L(DR) PQ=";"
"RTN","PSSMIGRD",81,0)
 .S DR=DR_PQ_"1///"_$S(IDATE]"":"^S X=IDATE",1:"@")
"RTN","PSSMIGRD",82,0)
 .D ^DIE
"RTN","PSSMIGRD",83,0)
 ;
"RTN","PSSMIGRD",84,0)
 S XMESS="<message>  Updated Drug Units: "_NAME_" </message>"
"RTN","PSSMIGRD",85,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRD",86,0)
 K DIC,DA,DR,DIE,^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",87,0)
 Q
"RTN","PSSMIGRD",88,0)
 ;
"RTN","PSSMIGRD",89,0)
VADU ; VA Dispense UNIT file Synch
"RTN","PSSMIGRD",90,0)
 ;
"RTN","PSSMIGRD",91,0)
 N X,Y,DIC,DA,DR,DIE,IEN,NAME,RTYPE,IDATE
"RTN","PSSMIGRD",92,0)
 S IEN=$G(PSS("IEN")),NAME=$G(PSS("NAME")),RTYPE=$G(PSS("RTYPE"))
"RTN","PSSMIGRD",93,0)
 S IDATE=$TR($P($G(PSS("IDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE,"L")
"RTN","PSSMIGRD",94,0)
 S FNUM=50.64,FNAME="syncResponse.XML",FNAME1="vaDispenseUnits"
"RTN","PSSMIGRD",95,0)
 S ERROR=0
"RTN","PSSMIGRD",96,0)
 ;
"RTN","PSSMIGRD",97,0)
 ; Quit if REQUIRED DATA is Missing
"RTN","PSSMIGRD",98,0)
 I RTYPE="MODIFY",'+(PSS("IEN")) D OUT^PSSMIGRC(" Error... Invalid IEN") Q
"RTN","PSSMIGRD",99,0)
 I NAME="" D OUT^PSSMIGRC(" Error...Missing Required NAME") Q
"RTN","PSSMIGRD",100,0)
 I RTYPE'="ADD",RTYPE'="MODIFY"  D OUT^PSSMIGRC("Error...Invalid Request Type") Q
"RTN","PSSMIGRD",101,0)
 ;
"RTN","PSSMIGRD",102,0)
 ;Add the Dispense UNIT to the Database
"RTN","PSSMIGRD",103,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRD",104,0)
 . ; Lock the Global
"RTN","PSSMIGRD",105,0)
 . L +^PSNDF(50.64):5 E  S ERROR=1 D OUT^PSSMIGRC(" *Another USER editing VA Dispense Unit file") Q
"RTN","PSSMIGRD",106,0)
 . ;
"RTN","PSSMIGRD",107,0)
 . ; Cheating - Remove LAYGO temporarly
"RTN","PSSMIGRD",108,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.64,.01,"LAYGO",.01,0))
"RTN","PSSMIGRD",109,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.64,.01,"LAYGO",.01,0)
"RTN","PSSMIGRD",110,0)
 . ;
"RTN","PSSMIGRD",111,0)
 . ; Get the IEN
"RTN","PSSMIGRD",112,0)
 . S X=NAME,DIC=50.64,DIC(0)="LMXZ"
"RTN","PSSMIGRD",113,0)
 . D ^DIC
"RTN","PSSMIGRD",114,0)
 . S (DA,PSS("IEN"))=+Y
"RTN","PSSMIGRD",115,0)
 . ;
"RTN","PSSMIGRD",116,0)
 . ; Quit if cannot get IEN
"RTN","PSSMIGRD",117,0)
 . I Y<1 D  Q
"RTN","PSSMIGRD",118,0)
 . . S ERROR=1
"RTN","PSSMIGRD",119,0)
 . . D OUT^PSSMIGRC(" Error...Cannot obtain an IEN for NAME")
"RTN","PSSMIGRD",120,0)
 . . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.64,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",121,0)
 . ;
"RTN","PSSMIGRD",122,0)
 . ;Set Database Variables
"RTN","PSSMIGRD",123,0)
 . S PSS("IEN")=DA,DIE=DIC K DIC
"RTN","PSSMIGRD",124,0)
 . ;S DR=".01///^S X=NAME;1///^S X=IDATE"
"RTN","PSSMIGRD",125,0)
 . S DR="1///^S X=IDATE"
"RTN","PSSMIGRD",126,0)
 . ;
"RTN","PSSMIGRD",127,0)
 . ; Update Database
"RTN","PSSMIGRD",128,0)
 . D ^DIE
"RTN","PSSMIGRD",129,0)
 . ;
"RTN","PSSMIGRD",130,0)
 . ; Put LAYGO back
"RTN","PSSMIGRD",131,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.64,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",132,0)
 . L -^PSNDF(50.64)
"RTN","PSSMIGRD",133,0)
 ;
"RTN","PSSMIGRD",134,0)
 Q:ERROR
"RTN","PSSMIGRD",135,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRD",136,0)
 .S DA=PSS("IEN"),DIE=50.64
"RTN","PSSMIGRD",137,0)
 .S PS5=$G(^PSNDF(50.64,DA,0)),DR="",PQ=""
"RTN","PSSMIGRD",138,0)
 .S:$P(PS5,"^",1)'=NAME DR=".01///^S X=NAME" S:$L(DR) PQ=";"
"RTN","PSSMIGRD",139,0)
 .S DR=DR_PQ_"1///"_$S(IDATE]"":"^S X=IDATE",1:"@")
"RTN","PSSMIGRD",140,0)
 .D ^DIE
"RTN","PSSMIGRD",141,0)
 ;
"RTN","PSSMIGRD",142,0)
 S XMESS="<message> Updated Dispense Units "_NAME_" </message>"
"RTN","PSSMIGRD",143,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRD",144,0)
 Q
"RTN","PSSMIGRD",145,0)
 ;
"RTN","PSSMIGRD",146,0)
DING ; Drug Ingredients file Synch
"RTN","PSSMIGRD",147,0)
 ;
"RTN","PSSMIGRD",148,0)
 N X,Y,DIC,DA,DR,DIE,IEN,NAME,RTYPE,IDATE,PRIMARY,MVUID,VUID,EFFDT,STATUS,PRNAME
"RTN","PSSMIGRD",149,0)
 S IEN=$G(PSS("IEN")),NAME=$G(PSS("NAME")),RTYPE=$G(PSS("RTYPE"))
"RTN","PSSMIGRD",150,0)
 S MVUID=$G(PSS("MASTERVUID")),VUID=$G(PSS("VUID"))
"RTN","PSSMIGRD",151,0)
 S EFFDT=$G(PSS("EFFDATE")),STATUS=$G(PSS("STATUS"))
"RTN","PSSMIGRD",152,0)
 S IDATE=$TR($P($G(PSS("INACTDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE,"L")
"RTN","PSSMIGRD",153,0)
 S PRNAME=$G(PSS("PRIMARY")),PRIMARY=""
"RTN","PSSMIGRD",154,0)
 I $L(PRNAME) D  ;find active ien for name
"RTN","PSSMIGRD",155,0)
 . N PRIEN,PRDATE,PRTERM
"RTN","PSSMIGRD",156,0)
 . S PRIEN=0,PRDATE=PSS("date/time")
"RTN","PSSMIGRD",157,0)
 . F  S PRIEN=$O(^PS(50.416,"B",PRNAME,PRIEN)) D  Q:PRIEN=0  Q:PRIMARY
"RTN","PSSMIGRD",158,0)
 .. S PRDATE=$O(^PS(50.416,PRIEN,"TERMSTATUS","B",PRDATE),-1)
"RTN","PSSMIGRD",159,0)
 .. S PRTERM=$O(^PS(50.416,PRIEN,"TERMSTATUS","B",PRDATE,0))
"RTN","PSSMIGRD",160,0)
 .. I $P(^PS(50.416,PRIEN,"TERMSTATUS",PRTERM,0),U,2) S PRIMARY=PRIEN
"RTN","PSSMIGRD",161,0)
 S FNUM=50.416,FNAME="syncResponse.XML",FNAME1="drugIngredients"
"RTN","PSSMIGRD",162,0)
 ;
"RTN","PSSMIGRD",163,0)
 ; Quit if REQUIRED DATA is Missing
"RTN","PSSMIGRD",164,0)
 I NAME="" D OUT^PSSMIGRC(" Error...Missing Required NAME") Q
"RTN","PSSMIGRD",165,0)
 I MVUID="" D OUT^PSSMIGRC(" Error...Missing Required MASTER VUID") Q
"RTN","PSSMIGRD",166,0)
 I VUID="" D OUT^PSSMIGRC(" Error...Missing Required VUID") Q
"RTN","PSSMIGRD",167,0)
 I EFFDT="" D OUT^PSSMIGRC(" Error...Missing Required EFFECTIVE DATE") Q
"RTN","PSSMIGRD",168,0)
 I STATUS="" D OUT^PSSMIGRC(" Error...Missing Required STATUS") Q
"RTN","PSSMIGRD",169,0)
 I RTYPE="MODIFY",'+(PSS("IEN")) D OUT^PSSMIGRC(" Error... Invalid IEN") Q
"RTN","PSSMIGRD",170,0)
 ;
"RTN","PSSMIGRD",171,0)
 S EFFDT=$$DATE($G(PSS("EFFDATE")))
"RTN","PSSMIGRD",172,0)
 ;
"RTN","PSSMIGRD",173,0)
 ;Add the Ingredient to the Database
"RTN","PSSMIGRD",174,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRD",175,0)
 . ; Lock the Global
"RTN","PSSMIGRD",176,0)
 . ;L +^PS(50.416):5 E  D OUT^PSSMIGRC(" Another USER is editing Drug Ingredients file") Q
"RTN","PSSMIGRD",177,0)
 . ;
"RTN","PSSMIGRD",178,0)
 . ; Cheating - Remove LAYGO temporarly
"RTN","PSSMIGRD",179,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.416,.01,"LAYGO",.01,0))
"RTN","PSSMIGRD",180,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.416,.01,"LAYGO",.01,0)
"RTN","PSSMIGRD",181,0)
 . ;
"RTN","PSSMIGRD",182,0)
 . ; Get the IEN
"RTN","PSSMIGRD",183,0)
 . S X=NAME,DIC=50.416,DIC(0)="LMXZ"
"RTN","PSSMIGRD",184,0)
 . D ^DIC
"RTN","PSSMIGRD",185,0)
 . S (DA,PSS("IEN"),PIEN)=+Y
"RTN","PSSMIGRD",186,0)
 . ;
"RTN","PSSMIGRD",187,0)
 . ; Quit if cannot get IEN
"RTN","PSSMIGRD",188,0)
 . I Y<1 D  Q
"RTN","PSSMIGRD",189,0)
 . . D OUT^PSSMIGRC(" Error...Cannot obtain an IEN for NAME")
"RTN","PSSMIGRD",190,0)
 . . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.416,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",191,0)
 . ;
"RTN","PSSMIGRD",192,0)
 . ; Set required fields first
"RTN","PSSMIGRD",193,0)
 . S DIE=DIC K DIC
"RTN","PSSMIGRD",194,0)
 . S DR="99.98///^S X=MVUID;99.99///^S X=VUID"
"RTN","PSSMIGRD",195,0)
 . S (PSS("IEN"),PIEN)=DA
"RTN","PSSMIGRD",196,0)
 . D ^DIE ; Update Database
"RTN","PSSMIGRD",197,0)
 . ; Set other fields
"RTN","PSSMIGRD",198,0)
 . S DR="2///^S X=PRIMARY;3///^S X=IDATE"
"RTN","PSSMIGRD",199,0)
 . D ^DIE ; Update Database
"RTN","PSSMIGRD",200,0)
 . ;
"RTN","PSSMIGRD",201,0)
 . ; Stuff EFFECTIVE DATE/TIME entries
"RTN","PSSMIGRD",202,0)
 . S DIC="^PS(50.416,"_PIEN_",""TERMSTATUS"",",DIC(0)="L",DIC("P")="50.4169A"
"RTN","PSSMIGRD",203,0)
 . S DA(1)=PIEN,DA=1,X=EFFDT
"RTN","PSSMIGRD",204,0)
 . D FILE^DICN
"RTN","PSSMIGRD",205,0)
 . S DIE=DIC,DR=".02///^S X=STATUS"
"RTN","PSSMIGRD",206,0)
 . D ^DIE
"RTN","PSSMIGRD",207,0)
 . ; 
"RTN","PSSMIGRD",208,0)
 . ;
"RTN","PSSMIGRD",209,0)
 . ; Put LAYGO back
"RTN","PSSMIGRD",210,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.416,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",211,0)
 . ;L -^PS(50.416)
"RTN","PSSMIGRD",212,0)
 . ;
"RTN","PSSMIGRD",213,0)
 . ; Updating ^NDFK files
"RTN","PSSMIGRD",214,0)
 . ;
"RTN","PSSMIGRD",215,0)
 . I NAME]"" S X=NAME,DIC=5000.508,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRD",216,0)
 . ;
"RTN","PSSMIGRD",217,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRD",218,0)
 .S (DA,PIEN)=PSS("IEN"),DIE=50.416
"RTN","PSSMIGRD",219,0)
 .S PS5=$G(^PS(50.416,DA,0)),PSMV=$G(^PS(50.416,DA,"VUID")),DR="",PQ=""
"RTN","PSSMIGRD",220,0)
 .S OPN=$P(PS5,"^",2)
"RTN","PSSMIGRD",221,0)
 .S:+OPN OPN=$P($G(^PS(50.416,OPN,0)),"^")
"RTN","PSSMIGRD",222,0)
 .S:OPN'=PRIMARY DR="2///"_$S(PRIMARY]"":"^S X=PRIMARY",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRD",223,0)
 .S:$P($G(^PS(50.416,DA,2)),"^",1)'=IDATE DR=DR_PQ_"3///"_$S(IDATE]"":"^S X=IDATE",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRD",224,0)
 .;S CMVUID=$P(PSMV,"^",2),CMVUID=$S(CMVUID=1:"YES",CMVUID=0:"NO",1:"")
"RTN","PSSMIGRD",225,0)
 .S:$P(PSMV,"^",2)'=MVUID DR=DR_PQ_"99.98///^S X=MVUID" S:$L(DR) PQ=";"
"RTN","PSSMIGRD",226,0)
 .S:$P(PSMV,"^",1)'=VUID DR=DR_PQ_"99.99///^S X=VUID" S:$L(DR) PQ=";"
"RTN","PSSMIGRD",227,0)
 .;
"RTN","PSSMIGRD",228,0)
 .; Update Database
"RTN","PSSMIGRD",229,0)
 .D ^DIE
"RTN","PSSMIGRD",230,0)
 .;
"RTN","PSSMIGRD",231,0)
 ;
"RTN","PSSMIGRD",232,0)
 S XMESS="<message><![CDATA[ Updated Drug Ingredients: "_NAME_" ]]></message>"
"RTN","PSSMIGRD",233,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRD",234,0)
 K DIC,DA,DR,DIE,^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",235,0)
 Q
"RTN","PSSMIGRD",236,0)
 ;
"RTN","PSSMIGRD",237,0)
VADC ;VA DRUG CLASS Sync
"RTN","PSSMIGRD",238,0)
 ;
"RTN","PSSMIGRD",239,0)
 N DA,DIE,DR,CLASS,CODE,PARENTCLASS,TYPE,RTYPE,DESC,VUID,MVUID,EFFDT,STATUS,PCIEN,PCODE
"RTN","PSSMIGRD",240,0)
 S PCLASS=$G(PSS("PCLASS")),PCODE=$G(PSS("PCODE")),PCIEN=$G(PSS("PCIEN"))
"RTN","PSSMIGRD",241,0)
 S CODE=$G(PSS("CLASSCODE")),CLASS=$G(PSS("CLASSCLASS")),TYPE=$G(PSS("TYPE"))
"RTN","PSSMIGRD",242,0)
 S RTYPE=$G(PSS("RTYPE")),DESC=$G(PSS("DESC")),VUID=$G(PSS("VUID"))
"RTN","PSSMIGRD",243,0)
 S MVUID=$G(PSS("MASTERVUID")),IEN=$G(PSS("IEN"))
"RTN","PSSMIGRD",244,0)
 S EFFDT=$G(PSS("EFFDATE")),STATUS=$G(PSS("STATUS")),DESC=$G(PSS("DESC"))
"RTN","PSSMIGRD",245,0)
 S FNUM=50.605,FNAME="syncResponse.XML",FNAME1="vaDrugClass"
"RTN","PSSMIGRD",246,0)
 ;
"RTN","PSSMIGRD",247,0)
 ; Quit if REQUIRED DATA is Missing
"RTN","PSSMIGRD",248,0)
 I CODE="" D OUT^PSSMIGRC(" Error...Missing Required VA DRUG CLASS CODE") Q
"RTN","PSSMIGRD",249,0)
 I MVUID="" D OUT^PSSMIGRC(" Error...Missing Required VA DRUG CLASS MASTER VUID") Q
"RTN","PSSMIGRD",250,0)
 I VUID="" D OUT^PSSMIGRC(" Error...Missing Required VA DRUG CLASS VUID") Q
"RTN","PSSMIGRD",251,0)
 I EFFDT="" D OUT^PSSMIGRC(" Error...Missing Required VA DRUG CLASS EFFECTIVE DATE") Q
"RTN","PSSMIGRD",252,0)
 I STATUS="" D OUT^PSSMIGRC(" Error...Missing Required VA DRUG CLASS STATUS") Q
"RTN","PSSMIGRD",253,0)
 ;
"RTN","PSSMIGRD",254,0)
 S EFFDT=$$DATE($G(PSS("EFFDATE")))
"RTN","PSSMIGRD",255,0)
 ;
"RTN","PSSMIGRD",256,0)
 ;Add the VA DRUG Class to the Database
"RTN","PSSMIGRD",257,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRD",258,0)
 . ; Lock the Global
"RTN","PSSMIGRD",259,0)
 . L +^PS(50.605):5 E  D OUT^PSSMIGRC(" *VA DRUG CLASS file NOT UPDATED. Another USER editing file") Q
"RTN","PSSMIGRD",260,0)
 . ;
"RTN","PSSMIGRD",261,0)
 . ; Cheating - Remove the check for LAYGO temporarly
"RTN","PSSMIGRD",262,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.605,.01,"LAYGO",.01,0))
"RTN","PSSMIGRD",263,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.605,.01,"LAYGO",.01,0)
"RTN","PSSMIGRD",264,0)
 . ;
"RTN","PSSMIGRD",265,0)
 . ; Get the IEN
"RTN","PSSMIGRD",266,0)
 . S X=CODE,DIC=50.605,DIC(0)="LMXZ"
"RTN","PSSMIGRD",267,0)
 . D ^DIC
"RTN","PSSMIGRD",268,0)
 . S (DA,PSS("IEN"),PIEN)=+Y
"RTN","PSSMIGRD",269,0)
 . ;
"RTN","PSSMIGRD",270,0)
 . ; Quit if cannot get IEN
"RTN","PSSMIGRD",271,0)
 . I Y<1 D  Q
"RTN","PSSMIGRD",272,0)
 . . D OUT^PSSMIGRC(" Error...Cannot obtain an IEN for VA DRUG CLASS - CLASS CODE")
"RTN","PSSMIGRD",273,0)
 . . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.605,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",274,0)
 . ;
"RTN","PSSMIGRD",275,0)
 . ; Set Database Variables
"RTN","PSSMIGRD",276,0)
 . S DIE=DIC K DIC
"RTN","PSSMIGRD",277,0)
 . S DR="1///^S X=CLASS;2///^S X=PCIEN;3///^S X=TYPE;4///^S X=DESC;"
"RTN","PSSMIGRD",278,0)
 . S DR=DR_"99.98///^S X=MVUID;99.99///^S X=VUID"
"RTN","PSSMIGRD",279,0)
 . ;
"RTN","PSSMIGRD",280,0)
 . ; Update Database
"RTN","PSSMIGRD",281,0)
 . D ^DIE
"RTN","PSSMIGRD",282,0)
 . ; Stuff EFFECTIVE DATE/TIME entries
"RTN","PSSMIGRD",283,0)
 . S DIC="^PS(50.605,"_PIEN_",""TERMSTATUS"",",DIC(0)="L",DIC("P")="50.60509DA"
"RTN","PSSMIGRD",284,0)
 . S DA(1)=PIEN,DA=1,X=EFFDT
"RTN","PSSMIGRD",285,0)
 . D FILE^DICN
"RTN","PSSMIGRD",286,0)
 . S DIE=DIC,DR=".02///^S X=STATUS"
"RTN","PSSMIGRD",287,0)
 . D ^DIE
"RTN","PSSMIGRD",288,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.605,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",289,0)
 . L -^PS(50.605)
"RTN","PSSMIGRD",290,0)
 ;
"RTN","PSSMIGRD",291,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRD",292,0)
 .S (DA,PIEN)=PSS("IEN"),DIE=50.605
"RTN","PSSMIGRD",293,0)
 .S PS5=$G(^PS(50.605,DA,0)),PSMV=$G(^PS(50.605,DA,"VUID")),DR="",PQ=""
"RTN","PSSMIGRD",294,0)
 .S:$P(PS5,"^",3)'=PCIEN DR="2///"_$S(PCIEN]"":"^S X=PCIEN",1:"@"),PQ=";"
"RTN","PSSMIGRD",295,0)
 .S:$P(PS5,"^",4)'=TYPE DR=DR_PQ_"3///^S X=TYPE",PQ=";"
"RTN","PSSMIGRD",296,0)
 .S:$P($G(^PS(50.605,DA,1)),"^",1)'=DESC DR=DR_PQ_"4///^S X=DESC",PQ=";"
"RTN","PSSMIGRD",297,0)
 .;S CMVUID=$P(PSMV,"^",2),CMVUID=$S(CMVUID=1:"YES",CMVUID=0:"NO",1:"")
"RTN","PSSMIGRD",298,0)
 .S:$P(PSMV,"^",2)'=MVUID DR=DR_PQ_"99.98///^S X=MVUID" S:$L(DR) PQ=";"
"RTN","PSSMIGRD",299,0)
 .S:$P(PSMV,"^",1)'=VUID DR=DR_PQ_"99.99///^S X=VUID" S:$L(DR) PQ=";"
"RTN","PSSMIGRD",300,0)
 . ;
"RTN","PSSMIGRD",301,0)
 . ; Update Database
"RTN","PSSMIGRD",302,0)
 . D ^DIE
"RTN","PSSMIGRD",303,0)
 ;
"RTN","PSSMIGRD",304,0)
 S XMESS="<message>  Updated Drug Class "_CODE_" </message>"
"RTN","PSSMIGRD",305,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRD",306,0)
 Q
"RTN","PSSMIGRD",307,0)
 ;
"RTN","PSSMIGRD",308,0)
DSFO ;DOSAGE FORM Sync
"RTN","PSSMIGRD",309,0)
 ;
"RTN","PSSMIGRD",310,0)
 ;
"RTN","PSSMIGRD",311,0)
 N X,Y,DIC,DA,DR,DIE,NAME,EXCLUDE,PACKAGE,PDPACKAGE,PERDOSE,UNIT,PIEN
"RTN","PSSMIGRD",312,0)
 S NAME=$G(PSS("NAME")),EXCLUDE=$G(PSS("EXCLUDE")),RTYPE=$G(PSS("RTYPE"))
"RTN","PSSMIGRD",313,0)
 S IDATE=$TR($P($G(PSS("INACTDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE)
"RTN","PSSMIGRD",314,0)
 S PERDOSE=$G(PSS("PERDOSE")),PDPACKAGE=$G(PSS("PDPACKAGE"))
"RTN","PSSMIGRD",315,0)
 S UNIT=$G(PSS("UNITS")),PACKAGE=$G(PSS("PACKAGE"))
"RTN","PSSMIGRD",316,0)
 S FNUM=50.606,FNAME="syncResponse.XML",FNAME1="dosageForm"
"RTN","PSSMIGRD",317,0)
 ;
"RTN","PSSMIGRD",318,0)
 I NAME="" D OUT^PSSMIGRC(" Error...Missing Required DOSAGE FORM NAME") Q
"RTN","PSSMIGRD",319,0)
 I EXCLUDE="" D OUT^PSSMIGRC(" Error...Missing Required Exclude From Dosage Checks FLAG") Q
"RTN","PSSMIGRD",320,0)
 I RTYPE'="ADD",RTYPE'="MODIFY"  D OUT^PSSMIGRC("Error...Invalid Request Type") Q
"RTN","PSSMIGRD",321,0)
 ;
"RTN","PSSMIGRD",322,0)
 ;Add the DOSAGE FORM to the Database 
"RTN","PSSMIGRD",323,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRD",324,0)
 . ;L +^PS(50.606):5 E  D OUT^PSSMIGRC(" Another USER editing DOSAGE FORM file") Q
"RTN","PSSMIGRD",325,0)
 . ;L -^PS(50.606)
"RTN","PSSMIGRD",326,0)
 . ;
"RTN","PSSMIGRD",327,0)
 . ; Cheating - Remove the check for LAYGO temporarly
"RTN","PSSMIGRD",328,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.606,.01,"LAYGO",.01,0))
"RTN","PSSMIGRD",329,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.606,.01,"LAYGO",.01,0)
"RTN","PSSMIGRD",330,0)
 . ;
"RTN","PSSMIGRD",331,0)
 . ; Get the IEN
"RTN","PSSMIGRD",332,0)
 . S X=NAME,DIC=50.606,DIC(0)="LMXZ"
"RTN","PSSMIGRD",333,0)
 . D ^DIC I Y<1 K DIC,DA Q
"RTN","PSSMIGRD",334,0)
 . ;
"RTN","PSSMIGRD",335,0)
 . ; Set Database Variables
"RTN","PSSMIGRD",336,0)
 . S DIE=DIC K DIC
"RTN","PSSMIGRD",337,0)
 . S DA=+Y
"RTN","PSSMIGRD",338,0)
 . S DR="7///^S X=IDATE;11///^S X=EXCLUDE"
"RTN","PSSMIGRD",339,0)
 . S (PSS("IEN"),PIEN)=DA
"RTN","PSSMIGRD",340,0)
 . ;
"RTN","PSSMIGRD",341,0)
 . ; Update Database
"RTN","PSSMIGRD",342,0)
 . D ^DIE
"RTN","PSSMIGRD",343,0)
 . ;
"RTN","PSSMIGRD",344,0)
 . D DUPD
"RTN","PSSMIGRD",345,0)
 . ;
"RTN","PSSMIGRD",346,0)
 . ; Put LAYGO back
"RTN","PSSMIGRD",347,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.606,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRD",348,0)
 ;
"RTN","PSSMIGRD",349,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRD",350,0)
 . S DA=PSS("IEN"),DIE=50.606
"RTN","PSSMIGRD",351,0)
 . S PS5=$G(^PS(50.606,DA,0)),DR="",PQ=""
"RTN","PSSMIGRD",352,0)
 . S:$P(PS5,"^",2)'=IDATE DR="7///"_$S(IDATE]"":"^S X=IDATE",1:"@"),PQ=";"
"RTN","PSSMIGRD",353,0)
 . S PSX=$P($G(^PS(50.606,DA,1)),"^",1),PSX=$S(PSX=0:"NO",PSX=1:"YES",1:"")
"RTN","PSSMIGRD",354,0)
 . S:PSX'=EXCLUDE DR=DR_PQ_"11///^S X=EXCLUDE"
"RTN","PSSMIGRD",355,0)
 . ;
"RTN","PSSMIGRD",356,0)
 . ; Update Database
"RTN","PSSMIGRD",357,0)
 . D ^DIE
"RTN","PSSMIGRD",358,0)
 . S PIEN=DA
"RTN","PSSMIGRD",359,0)
 . D DUPD
"RTN","PSSMIGRD",360,0)
 ;
"RTN","PSSMIGRD",361,0)
 ;
"RTN","PSSMIGRD",362,0)
 ;
"RTN","PSSMIGRD",363,0)
 Q:$G(ERROR)=1
"RTN","PSSMIGRD",364,0)
 ;
"RTN","PSSMIGRD",365,0)
 S XMESS="<message> <![CDATA[ Updated Dosage Form "_NAME_"]]> </message>"
"RTN","PSSMIGRD",366,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRD",367,0)
 K DIC,DA,DR,DIE,^TMP("AJF LAYGO",$J),^TMP("AJF LAYGO DF",$J),^TMP("AJF LAYGO UT",$J)
"RTN","PSSMIGRD",368,0)
 Q
"RTN","PSSMIGRD",369,0)
 ;
"RTN","PSSMIGRD",370,0)
DUPD ;
"RTN","PSSMIGRD",371,0)
 ;
"RTN","PSSMIGRD",372,0)
 I +PERDOSE D
"RTN","PSSMIGRD",373,0)
 . N CNT,UPACK,DA,PSDUPD S (DA,CNT)=0
"RTN","PSSMIGRD",374,0)
 . S DIC="^PS(50.606,"_PIEN_",""DUPD"",",DIC(0)="L",DIC("P")="50.6069"
"RTN","PSSMIGRD",375,0)
 . ; Cheating - Remove the check for LAYGO temporarly
"RTN","PSSMIGRD",376,0)
 . S ^TMP("AJF LAYGO DF",$J)=$G(^DD(50.6069,.01,"LAYGO",1,0))
"RTN","PSSMIGRD",377,0)
 . I ^TMP("AJF LAYGO DF",$J)]"" K ^DD(50.6069,.01,"LAYGO",1,0)
"RTN","PSSMIGRD",378,0)
 . F CNT=1:1:PERDOSE Q:'$D(PSS("PDDOSE"_CNT))  D
"RTN","PSSMIGRD",379,0)
 .. S DA=$O(^PS(50.606,PIEN,"DUPD","B",PSS("PDDOSE"_CNT),""))
"RTN","PSSMIGRD",380,0)
 .. I '+DA S DA(1)=PIEN,DA=CNT,X=PSS("PDDOSE"_CNT) D FILE^DICN
"RTN","PSSMIGRD",381,0)
 .. S DA(1)=PIEN,OPACK="",PSDUPD(PSS("PDDOSE"_CNT))=""
"RTN","PSSMIGRD",382,0)
 .. S DA=$O(^PS(50.606,PIEN,"DUPD","B",PSS("PDDOSE"_CNT),""))
"RTN","PSSMIGRD",383,0)
 .. S:+DA OPACK=$P(^PS(50.606,PIEN,"DUPD",DA,0),"^",2)
"RTN","PSSMIGRD",384,0)
 .. S UPACK=$G(PSS("PDPACKAGE"_CNT))
"RTN","PSSMIGRD",385,0)
 .. I OPACK'=UPACK S DIE=DIC,DR="1///"_$S(UPACK]"":"^S X=UPACK",1:"@") D ^DIE
"RTN","PSSMIGRD",386,0)
 . ;
"RTN","PSSMIGRD",387,0)
 . ; Removing old entries from multiple
"RTN","PSSMIGRD",388,0)
 . S CNT=0,DIK="^PS(50.606,"_PIEN_",""DUPD"",",DA(1)=PIEN
"RTN","PSSMIGRD",389,0)
 . F  S CNT=$O(^PS(50.606,PIEN,"DUPD","B",CNT)) Q:CNT=""  D
"RTN","PSSMIGRD",390,0)
 .. Q:$D(PSDUPD(CNT))
"RTN","PSSMIGRD",391,0)
 .. S DA=$O(^PS(50.606,PIEN,"DUPD","B",CNT,""))
"RTN","PSSMIGRD",392,0)
 .. D ^DIK
"RTN","PSSMIGRD",393,0)
 . S:^TMP("AJF LAYGO DF",$J)]"" ^DD(50.6069,.01,"LAYGO",1,0)=^TMP("AJF LAYGO DF",$J)
"RTN","PSSMIGRD",394,0)
 ;
"RTN","PSSMIGRD",395,0)
 ;
"RTN","PSSMIGRD",396,0)
 I +UNIT D
"RTN","PSSMIGRD",397,0)
 . N CNT,UPACK,DA,PSUNITS S (DA,CNT)=0
"RTN","PSSMIGRD",398,0)
 . S DIC="^PS(50.606,"_PIEN_",""UNIT"",",DIC(0)="L",DIC("P")="50.6068P"
"RTN","PSSMIGRD",399,0)
 . ; Cheating - Remove the check for LAYGO temporarly
"RTN","PSSMIGRD",400,0)
 . S ^TMP("AJF LAYGO UT",$J)=$G(^DD(50.6068,.01,"LAYGO",1,0))
"RTN","PSSMIGRD",401,0)
 . I ^TMP("AJF LAYGO UT",$J)]"" K ^DD(50.6068,.01,"LAYGO",1,0)
"RTN","PSSMIGRD",402,0)
 . ;
"RTN","PSSMIGRD",403,0)
 . F CNT=1:1:UNIT Q:'$D(PSS("UNITS"_CNT))  D
"RTN","PSSMIGRD",404,0)
 .. S DA=$O(^PS(50.606,PIEN,"UNIT","B",PSS("UNITSIEN"_CNT),""))
"RTN","PSSMIGRD",405,0)
 .. I '+DA S DA(1)=PIEN,DA=CNT,X=PSS("UNITSIEN"_CNT) D FILE^DICN
"RTN","PSSMIGRD",406,0)
 .. S DA(1)=PIEN,OPACK="",PSUNITS(PSS("UNITSIEN"_CNT))=""
"RTN","PSSMIGRD",407,0)
 .. S DA=$O(^PS(50.606,PIEN,"UNIT","B",PSS("UNITSIEN"_CNT),""))
"RTN","PSSMIGRD",408,0)
 .. S:+DA OPACK=$P(^PS(50.606,PIEN,"UNIT",DA,0),"^",2)
"RTN","PSSMIGRD",409,0)
 .. S UPACK=$G(PSS("PACKAGE"_CNT))
"RTN","PSSMIGRD",410,0)
 .. I OPACK'=UPACK S DIE=DIC,DR="1///"_$S(UPACK]"":"^S X=UPACK",1:"@") D ^DIE
"RTN","PSSMIGRD",411,0)
 . ;
"RTN","PSSMIGRD",412,0)
 . ; Removing old entries from multiple
"RTN","PSSMIGRD",413,0)
 . S CNT=0,DIK="^PS(50.606,"_PIEN_",""UNIT"",",DA(1)=PIEN
"RTN","PSSMIGRD",414,0)
 . F  S CNT=$O(^PS(50.606,PIEN,"UNIT","B",CNT)) Q:CNT=""  D
"RTN","PSSMIGRD",415,0)
 .. Q:$D(PSUNITS(CNT))
"RTN","PSSMIGRD",416,0)
 .. S DA=$O(^PS(50.606,PIEN,"UNIT","B",CNT,""))
"RTN","PSSMIGRD",417,0)
 .. D ^DIK
"RTN","PSSMIGRD",418,0)
 . S:^TMP("AJF LAYGO UT",$J)]"" ^DD(50.6068,.01,"LAYGO",1,0)=^TMP("AJF LAYGO UT",$J)
"RTN","PSSMIGRD",419,0)
 ;
"RTN","PSSMIGRD",420,0)
 ;
"RTN","PSSMIGRD",421,0)
 ;
"RTN","PSSMIGRD",422,0)
DATE(DT) ; Format date time
"RTN","PSSMIGRD",423,0)
 ;
"RTN","PSSMIGRD",424,0)
 Q:$L(DT)="" ""
"RTN","PSSMIGRD",425,0)
 S FDT=$TR($P($G(DT),"T"),"-","")
"RTN","PSSMIGRD",426,0)
 ;S $TR($P(DT,"."),":",""),FDT=$TR(FDT,"-",""),FDT=$TR(FDT,"T","")
"RTN","PSSMIGRD",427,0)
 S FDT=$$HL7TFM^XLFDT(FDT,"L")
"RTN","PSSMIGRD",428,0)
 Q FDT
"RTN","PSSMIGRD",429,0)
 ;
"RTN","PSSMIGRE")
0^2^B181541115
"RTN","PSSMIGRE",1,0)
PSSMIGRE ;AJF - Process Sync XML message from PEPS; 12/17/13 1:46pm ; 12/17/13 2:08pm
"RTN","PSSMIGRE",2,0)
 ;;1.0;PHARMACY ENTERPRISE PRODUCT SYSTEM;;7/11/2008;Build 1
"RTN","PSSMIGRE",3,0)
 ;;
"RTN","PSSMIGRE",4,0)
 ; Process Sync request 
"RTN","PSSMIGRE",5,0)
 ; Called from ^PSSMIGRD
"RTN","PSSMIGRE",6,0)
 ;;
"RTN","PSSMIGRE",7,0)
 Q
"RTN","PSSMIGRE",8,0)
 ;
"RTN","PSSMIGRE",9,0)
MAN ; Manufacturer file Sync
"RTN","PSSMIGRE",10,0)
 ;
"RTN","PSSMIGRE",11,0)
 ;
"RTN","PSSMIGRE",12,0)
 N X,Y,DIC,DA,DR,DIE,IEN,NAME,RTYPE,IDATE
"RTN","PSSMIGRE",13,0)
 I PSS("NAME")="" D OUT^PSSMIGRC(" Error...Missing Required NAME") Q
"RTN","PSSMIGRE",14,0)
 S NAME=$G(PSS("NAME")),IEN=$G(PSS("IEN")),RTYPE=$G(PSS("RTYPE"))
"RTN","PSSMIGRE",15,0)
 S IDATE=$TR($P($G(PSS("IDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE)
"RTN","PSSMIGRE",16,0)
 S FNAME="syncResponse.XML",FNUM=55.95
"RTN","PSSMIGRE",17,0)
 S FNAME1="Manufacturer"
"RTN","PSSMIGRE",18,0)
 ;
"RTN","PSSMIGRE",19,0)
 ;Add the Manufacturer to the Database
"RTN","PSSMIGRE",20,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRE",21,0)
 . ; Lock the Global
"RTN","PSSMIGRE",22,0)
 . L +^PS(55.95):5 E  D OUT^PSSMIGRC(" Another USER editing Manufacturer file") Q
"RTN","PSSMIGRE",23,0)
 . ;
"RTN","PSSMIGRE",24,0)
 . ; Cheating - Remove LAYGO temporarly
"RTN","PSSMIGRE",25,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(55.95,.01,"LAYGO",.01,0))
"RTN","PSSMIGRE",26,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(55.95,.01,"LAYGO",.01,0)
"RTN","PSSMIGRE",27,0)
 . ;
"RTN","PSSMIGRE",28,0)
 . ; Get the IEN
"RTN","PSSMIGRE",29,0)
 . S X=NAME,DIC=55.95,DIC(0)="LMXZ"
"RTN","PSSMIGRE",30,0)
 . D ^DIC
"RTN","PSSMIGRE",31,0)
 . S (DA,PSS("IEN"))=+Y
"RTN","PSSMIGRE",32,0)
 . ;
"RTN","PSSMIGRE",33,0)
 . ; Quit if cannot get IEN
"RTN","PSSMIGRE",34,0)
 . I Y<1 D  Q:'$L(DA)
"RTN","PSSMIGRE",35,0)
 . . S DA=$O(^PS(55.95,"B",NAME,""))
"RTN","PSSMIGRE",36,0)
 . . Q:$L(DA)
"RTN","PSSMIGRE",37,0)
 . . D OUT^PSSMIGRC(" Error...Cannot obtain an IEN for "_NAME)
"RTN","PSSMIGRE",38,0)
 . . S:^TMP("AJF LAYGO",$J)]"" ^DD(55.95,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",39,0)
 . ;
"RTN","PSSMIGRE",40,0)
 . ; Set Database Variables
"RTN","PSSMIGRE",41,0)
 . S PSS("IEN")=DA,DIE=DIC K DIC
"RTN","PSSMIGRE",42,0)
 . S DR="2///^S X=IDATE"
"RTN","PSSMIGRE",43,0)
 . ;
"RTN","PSSMIGRE",44,0)
 . ; Update Database
"RTN","PSSMIGRE",45,0)
 . D ^DIE
"RTN","PSSMIGRE",46,0)
 . ;
"RTN","PSSMIGRE",47,0)
 . ; Put LAYGO back
"RTN","PSSMIGRE",48,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(55.95,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",49,0)
 . L -^PS(55.95)
"RTN","PSSMIGRE",50,0)
 ;
"RTN","PSSMIGRE",51,0)
 Q:$G(ERORR)=1
"RTN","PSSMIGRE",52,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRE",53,0)
 .S DA=PSS("IEN"),DIE=55.95
"RTN","PSSMIGRE",54,0)
 .S PS5=$G(^PS(55.95,DA,0)),DR="",PQ=""
"RTN","PSSMIGRE",55,0)
 .S:$P(PS5,"^",1)'=NAME DR=".01///^S X=NAME" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",56,0)
 .S DR=DR_PQ_"2///"_$S(IDATE]"":"^S X=IDATE",1:"@")
"RTN","PSSMIGRE",57,0)
 .;S DR=".01///^S X=NAME;2///"_$S(IDATE]"":"^S X=IDATE",1:"@")
"RTN","PSSMIGRE",58,0)
 .D ^DIE
"RTN","PSSMIGRE",59,0)
 ;
"RTN","PSSMIGRE",60,0)
 S XMESS="<message><![CDATA[  Updated Manufacturer: "_NAME_" ]]></message>"
"RTN","PSSMIGRE",61,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRE",62,0)
 K DIC,DA,DR,DIE,^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",63,0)
 Q
"RTN","PSSMIGRE",64,0)
 ;
"RTN","PSSMIGRE",65,0)
PTYP ; PACKAGE TYPE file Synch
"RTN","PSSMIGRE",66,0)
 ;
"RTN","PSSMIGRE",67,0)
 N X,Y,DIC,DA,DR,DIE,IEN,NAME,RTYPE,IDATE
"RTN","PSSMIGRE",68,0)
 I PSS("NAME")="" D OUT^PSSMIGRC(" Error...Missing Required NAME") Q
"RTN","PSSMIGRE",69,0)
 S NAME=$G(PSS("NAME")),IEN=$G(PSS("IEN")),RTYPE=$G(PSS("RTYPE"))
"RTN","PSSMIGRE",70,0)
 S IDATE=$TR($P($G(PSS("IDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE,"L")
"RTN","PSSMIGRE",71,0)
 S FNAME="syncResponse.XML",FNUM=50.608
"RTN","PSSMIGRE",72,0)
 S FNAME1="packageType"
"RTN","PSSMIGRE",73,0)
 ;
"RTN","PSSMIGRE",74,0)
 ;Add the PACKAGE TYPE to the Database
"RTN","PSSMIGRE",75,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRE",76,0)
 . ; Lock the Global
"RTN","PSSMIGRE",77,0)
 . L +^PS(50.608):5 E  D OUT^PSSMIGRC(" Another USER editing PACKAGE TYPE file") Q
"RTN","PSSMIGRE",78,0)
 . ;
"RTN","PSSMIGRE",79,0)
 . ; Cheating - Remove LAYGO temporarly
"RTN","PSSMIGRE",80,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.608,.01,"LAYGO",.01,0))
"RTN","PSSMIGRE",81,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.608,.01,"LAYGO",.01,0)
"RTN","PSSMIGRE",82,0)
 . ;
"RTN","PSSMIGRE",83,0)
 . ; Get the IEN
"RTN","PSSMIGRE",84,0)
 . S X=NAME,DIC=50.608,DIC(0)="LMXZ"
"RTN","PSSMIGRE",85,0)
 . D ^DIC
"RTN","PSSMIGRE",86,0)
 . S (DA,PSS("IEN"))=+Y
"RTN","PSSMIGRE",87,0)
 . ;
"RTN","PSSMIGRE",88,0)
 . ; Quit if cannot get IEN
"RTN","PSSMIGRE",89,0)
 . I Y<1 D  Q
"RTN","PSSMIGRE",90,0)
 . . D OUT^PSSMIGRC(" Error...Cannot obtain an IEN for NAME")
"RTN","PSSMIGRE",91,0)
 . . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.608,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",92,0)
 . ;
"RTN","PSSMIGRE",93,0)
 . ; Set Database Variables
"RTN","PSSMIGRE",94,0)
 . S PSS("IEN")=DA,DIE=DIC K DIC
"RTN","PSSMIGRE",95,0)
 . ;S DR=".01///^S X=NAME;1///^S X=IDATE"
"RTN","PSSMIGRE",96,0)
 . S DR="1///^S X=IDATE"
"RTN","PSSMIGRE",97,0)
 . ;
"RTN","PSSMIGRE",98,0)
 . ; Update Database
"RTN","PSSMIGRE",99,0)
 . D ^DIE
"RTN","PSSMIGRE",100,0)
 . ;
"RTN","PSSMIGRE",101,0)
 . ; Put LAYGO back
"RTN","PSSMIGRE",102,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.608,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",103,0)
 . L -^PS(50.608)
"RTN","PSSMIGRE",104,0)
 ;
"RTN","PSSMIGRE",105,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRE",106,0)
 .S DA=PSS("IEN"),DIE=50.608
"RTN","PSSMIGRE",107,0)
 .S PS5=$G(^PS(50.608,DA,0)),DR="",PQ=""
"RTN","PSSMIGRE",108,0)
 .S:$P(PS5,"^",1)'=NAME DR=".01///^S X=NAME" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",109,0)
 .S DR=DR_PQ_"1///"_$S(IDATE]"":"^S X=IDATE",1:"@")
"RTN","PSSMIGRE",110,0)
 .;S DR=".01///^S X=NAME;1///"_$S(IDATE]"":"^S X=IDATE",1:"@")
"RTN","PSSMIGRE",111,0)
 .D ^DIE
"RTN","PSSMIGRE",112,0)
 ;
"RTN","PSSMIGRE",113,0)
 S XMESS="<message><![CDATA[  Updated Package Type: "_NAME_"  ]]></message>"
"RTN","PSSMIGRE",114,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRE",115,0)
 K DIC,DA,DR,DIE,^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",116,0)
 Q
"RTN","PSSMIGRE",117,0)
 ;
"RTN","PSSMIGRE",118,0)
NDC ;  Synch for NDC
"RTN","PSSMIGRE",119,0)
 ;
"RTN","PSSMIGRE",120,0)
 N X,Y,DIC,DA,DR,DIE,IEN,NAME,RTYPE,IDATE,TNAME,MNAME,MIEN,PNAME,PIEN,PSIZE,PTYPE,PTIEN
"RTN","PSSMIGRE",121,0)
 N PSOTC,NIEN,PSO,SCK,SIEN,UPN,VAPRO
"RTN","PSSMIGRE",122,0)
 ;
"RTN","PSSMIGRE",123,0)
 I PSS("NAME")="" D OUT^PSSMIGRC(" Error...Missing Required NAME") Q
"RTN","PSSMIGRE",124,0)
 S NAME=$G(PSS("NAME")),IEN=$G(PSS("IEN")),RTYPE=$G(PSS("RTYPE")),TNAME=$G(PSS("TNAME"))
"RTN","PSSMIGRE",125,0)
 S IDATE=$TR($P($G(PSS("IDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE,"L")
"RTN","PSSMIGRE",126,0)
 S MNAME=$G(PSS("MNAME")),MIEN=$G(PSS("MIEN")),PNAME=$G(PSS("PNAME")),PIEN=$G(PSS("PIEN"))
"RTN","PSSMIGRE",127,0)
 S PSIZE=$G(PSS("PSIZE")),PTYPE=$G(PSS("PTYPE")),PTIEN=$G(PSS("PTIEN"))
"RTN","PSSMIGRE",128,0)
 S PSOTC=$G(PSS("PSOTC")),UPN=$G(PSS("UPN"))
"RTN","PSSMIGRE",129,0)
 S FNAME="syncResponse.XML",FNUM=50.67
"RTN","PSSMIGRE",130,0)
 S FNAME1="NDC",NAME=$TR(NAME,"-","")
"RTN","PSSMIGRE",131,0)
 ;
"RTN","PSSMIGRE",132,0)
 ;
"RTN","PSSMIGRE",133,0)
 ; Adding Package Size
"RTN","PSSMIGRE",134,0)
 I PSIZE'="" S SIEN="",SCK=0 D
"RTN","PSSMIGRE",135,0)
 .F  S SIEN=$O(^PS(50.609,"B",PSIZE,SIEN)) Q:SIEN=""  D  Q:+SCK
"RTN","PSSMIGRE",136,0)
 ..S:$P(^PS(50.609,SIEN,0),"^",2)="" SCK=1
"RTN","PSSMIGRE",137,0)
 I SIEN="" N PSNUM,PSCNT L +^PS(50.609,0):0 I $T D
"RTN","PSSMIGRE",138,0)
 .S PS0=^PS(50.609,0),PSCNT=$P(PS0,"^",3)+1,PSNUM=$P(PS0,"^",4)+1
"RTN","PSSMIGRE",139,0)
 .S $P(^PS(50.609,0),"^",3)=PSCNT,$P(^PS(50.609,0),"^",4)=PSNUM
"RTN","PSSMIGRE",140,0)
 .L -^PS(50.609,0)
"RTN","PSSMIGRE",141,0)
 .S SIEN=PSCNT
"RTN","PSSMIGRE",142,0)
 .;S ^PS(50.609,SIEN,0)=PSIZE
"RTN","PSSMIGRE",143,0)
 .;S ^PS(50.609,"B",PSIZE,SIEN)=""
"RTN","PSSMIGRE",144,0)
 .S DA=SIEN,DIE="^PS(50.609,"
"RTN","PSSMIGRE",145,0)
 .S DR=".01///^S X=PSIZE"
"RTN","PSSMIGRE",146,0)
 .D ^DIE
"RTN","PSSMIGRE",147,0)
 ;
"RTN","PSSMIGRE",148,0)
 ;
"RTN","PSSMIGRE",149,0)
 ;Add NDC to the Database
"RTN","PSSMIGRE",150,0)
 D:RTYPE="ADD"  Q:ERROR=1
"RTN","PSSMIGRE",151,0)
 . S NIEN=$O(^PSNDF(50.67,"NDC",NAME,""))
"RTN","PSSMIGRE",152,0)
 . ; Create new NDC entry
"RTN","PSSMIGRE",153,0)
 . I NIEN="" D
"RTN","PSSMIGRE",154,0)
 .. ; Lock the Global
"RTN","PSSMIGRE",155,0)
 .. L +^PSNDF(50.67):5 E  D OUT^PSSMIGRC(" Another USER editing NDC file") Q
"RTN","PSSMIGRE",156,0)
 .. ;S PS0=^PSNDF(50.67,0),PSCNT=$P(PS0,"^",3)+1,PSNUM=$P(PS0,"^",4)+1
"RTN","PSSMIGRE",157,0)
 .. ;S $P(^PSNDF(50.67,0),"^",3)=PSCNT,$P(^PSNDF(50.67,0),"^",4)=PSNUM
"RTN","PSSMIGRE",158,0)
 .. ;L -^PSNDF(50.67,0)
"RTN","PSSMIGRE",159,0)
 .. ;S NIEN=PSCNT
"RTN","PSSMIGRE",160,0)
 .. ;S ^PSNDF(50.67,NIEN,0)=NIEN
"RTN","PSSMIGRE",161,0)
 .. ;S ^PSNDF(50.67,"NDC",NAME,NIEN)=""
"RTN","PSSMIGRE",162,0)
 .. ;
"RTN","PSSMIGRE",163,0)
 .. S PS0=^PSNDF(50.67,0),PSCNT=$P(PS0,"^",3)+1
"RTN","PSSMIGRE",164,0)
 .. S $P(^PSNDF(50.67,0),"^",3)=PSCNT
"RTN","PSSMIGRE",165,0)
 .. L -^PSNDF(50.67,0)
"RTN","PSSMIGRE",166,0)
 .. S X=PSCNT,DIC=50.67,DIC(0)="LMXZ"
"RTN","PSSMIGRE",167,0)
 .. D ^DIC
"RTN","PSSMIGRE",168,0)
 .. S:Y'="-1" NIEN=$P(Y,"^")
"RTN","PSSMIGRE",169,0)
 . ;
"RTN","PSSMIGRE",170,0)
 . ; Cheating - Remove LAYGO temporarly
"RTN","PSSMIGRE",171,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.67,.01,"LAYGO",.01,0))
"RTN","PSSMIGRE",172,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.67,.01,"LAYGO",.01,0)
"RTN","PSSMIGRE",173,0)
 . ;
"RTN","PSSMIGRE",174,0)
 . I NIEN="" D OUT^PSSMIGRC(" Error... Unable To Create NEW IEN") Q 
"RTN","PSSMIGRE",175,0)
 . ;
"RTN","PSSMIGRE",176,0)
 . ;
"RTN","PSSMIGRE",177,0)
 . ;
"RTN","PSSMIGRE",178,0)
 . ; Set Database Variables
"RTN","PSSMIGRE",179,0)
 . ;
"RTN","PSSMIGRE",180,0)
 . ;
"RTN","PSSMIGRE",181,0)
 . S NDF0=$G(^PSNDF(50.67,NIEN,0))
"RTN","PSSMIGRE",182,0)
 . S (DA,PSS("IEN"))=NIEN,DIE="^PSNDF(50.67,",DR="",PQ=""
"RTN","PSSMIGRE",183,0)
 . S:$P(NDF0,"^",2)'=NAME DR="1///^S X=NAME" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",184,0)
 . S:$P(NDF0,"^",3)'=UPN DR=DR_PQ_"2///"_$S(UPN]"":"^S X=UPN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",185,0)
 . S:$P(NDF0,"^",4)'=MIEN DR=DR_PQ_"3///^S X=MIEN" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",186,0)
 . S:$P(NDF0,"^",5)'=TNAME DR=DR_PQ_"4///"_$S(TNAME]"":"^S X=TNAME",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",187,0)
 . S:$P(NDF0,"^",6)'=PIEN DR=DR_PQ_"5///^S X=PIEN" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",188,0)
 . S:$P(NDF0,"^",7)'=IDATE DR=DR_PQ_"7///"_$S(IDATE]"":"^S X=IDATE",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",189,0)
 . S:$P(NDF0,"^",8)'=SIEN DR=DR_PQ_"8///"_$S(SIEN]"":"^S X=SIEN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",190,0)
 . S:$P(NDF0,"^",9)'=PTIEN DR=DR_PQ_"9///"_$S(PTIEN]"":"^S X=PTIEN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",191,0)
 . S PSOT=$S(PSOTC="Prescription":"R",PSOTC="Over the Counter":"O",1:"")
"RTN","PSSMIGRE",192,0)
 . S:$P(NDF0,"^",10)'=PSOT DR=DR_PQ_"10///"_$S(PSOTC]"":"^S X=PSOTC",1:"@")
"RTN","PSSMIGRE",193,0)
 . ;
"RTN","PSSMIGRE",194,0)
 . ; Update Database
"RTN","PSSMIGRE",195,0)
 . D ^DIE
"RTN","PSSMIGRE",196,0)
 . ;
"RTN","PSSMIGRE",197,0)
 . ;
"RTN","PSSMIGRE",198,0)
 . I '$D(^PSNDF(50.67,NIEN,1,0)) D
"RTN","PSSMIGRE",199,0)
 .. ; Stuff ROUTE OF ADMINISTRATION entries
"RTN","PSSMIGRE",200,0)
 .. S DIC="^PSNDF(50.67,"_NIEN_",1,",DIC(0)="L",DIC("P")="50.676A"
"RTN","PSSMIGRE",201,0)
 .. S DA(1)=NIEN,DA=1,X="N/A" D FILE^DICN
"RTN","PSSMIGRE",202,0)
 .. ;
"RTN","PSSMIGRE",203,0)
 . ;
"RTN","PSSMIGRE",204,0)
 . S NIEN2=NIEN
"RTN","PSSMIGRE",205,0)
 . F  S NIEN2=$O(^PSNDF(50.67,"NDC",NAME,NIEN2)) Q:NIEN2=""  D
"RTN","PSSMIGRE",206,0)
 .. D DT^DICRW S DA=NIEN2,DIE=50.67,IDATE=DT,DR=""
"RTN","PSSMIGRE",207,0)
 .. S DR="7///^S X=IDATE"
"RTN","PSSMIGRE",208,0)
 .. S:$P(NDF0,"^",2)'=NAME DR=";1///^S X=NAME"
"RTN","PSSMIGRE",209,0)
 .. S:$P(NDF0,"^",3)'=UPN DR=DR_";2///"_$S(UPN]"":"^S X=UPN",1:"@")
"RTN","PSSMIGRE",210,0)
 .. S:$P(NDF0,"^",4)'=MIEN DR=DR_";3///^S X=MIEN"
"RTN","PSSMIGRE",211,0)
 .. S:$P(NDF0,"^",5)'=TNAME DR=DR_";4///"_$S(TNAME]"":"^S X=TNAME",1:"@")
"RTN","PSSMIGRE",212,0)
 .. S:$P(NDF0,"^",6)'=PIEN DR=DR_";5///^S X=PIEN"
"RTN","PSSMIGRE",213,0)
 .. S:$P(NDF0,"^",8)'=SIEN DR=DR_";8///"_$S(SIEN]"":"^S X=SIEN",1:"@")
"RTN","PSSMIGRE",214,0)
 .. S:$P(NDF0,"^",9)'=PTIEN DR=DR_";9///"_$S(PTIEN]"":"^S X=PTIEN",1:"@")
"RTN","PSSMIGRE",215,0)
 .. S PSOT=$S(PSOTC="Prescription":"R",PSOTC="Over the Counter":"O",1:"")
"RTN","PSSMIGRE",216,0)
 .. S:$P(NDF0,"^",10)'=PSOT DR=DR_";10///"_$S(PSOTC]"":"^S X=PSOTC",1:"@")
"RTN","PSSMIGRE",217,0)
 .. D ^DIE
"RTN","PSSMIGRE",218,0)
 . ;
"RTN","PSSMIGRE",219,0)
 . ; Put LAYGO back
"RTN","PSSMIGRE",220,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.67,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",221,0)
 . L -^PSNDF(50.67)
"RTN","PSSMIGRE",222,0)
 ;
"RTN","PSSMIGRE",223,0)
 Q:$G(ERORR)=1
"RTN","PSSMIGRE",224,0)
 ;
"RTN","PSSMIGRE",225,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRE",226,0)
 . S DA=PSS("IEN"),DIE=50.67
"RTN","PSSMIGRE",227,0)
 . S NAME1=$P($G(^PSNDF(50.67,DA,0)),"^",2)
"RTN","PSSMIGRE",228,0)
 . I NAME'=NAME1 D OUT^PSSMIGRC(" Error... NDC Numbers Don't Match") S ERORR=1 Q
"RTN","PSSMIGRE",229,0)
 . S NDF0=$G(^PSNDF(50.67,DA,0)),DR="",PQ=""
"RTN","PSSMIGRE",230,0)
 . S:$P(NDF0,"^",2)'=NAME DR="1///^S X=NAME" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",231,0)
 . S:$P(NDF0,"^",3)'=UPN DR=DR_PQ_"2///"_$S(UPN]"":"^S X=UPN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",232,0)
 . S:$P(NDF0,"^",4)'=MIEN DR=DR_PQ_"3///^S X=MIEN" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",233,0)
 . S:$P(NDF0,"^",5)'=TNAME DR=DR_PQ_"4///"_$S(TNAME]"":"^S X=TNAME",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",234,0)
 . S:$P(NDF0,"^",6)'=PIEN DR=DR_PQ_"5///^S X=PIEN" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",235,0)
 . S:$P(NDF0,"^",7)'=IDATE DR=DR_PQ_"7///"_$S(IDATE]"":"^S X=IDATE",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",236,0)
 . S:$P(NDF0,"^",8)'=SIEN DR=DR_PQ_"8///"_$S(SIEN]"":"^S X=SIEN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",237,0)
 . S:$P(NDF0,"^",9)'=PTIEN DR=DR_PQ_"9///"_$S(PTIEN]"":"^S X=PTIEN",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",238,0)
 . S PSOT=$S(PSOTC="Prescription":"R",PSOTC="Over the Counter":"O",1:"")
"RTN","PSSMIGRE",239,0)
 . S:$P(NDF0,"^",10)'=PSOT DR=DR_PQ_"10///"_$S(PSOTC]"":"^S X=PSOTC",1:"@")
"RTN","PSSMIGRE",240,0)
 . D ^DIE
"RTN","PSSMIGRE",241,0)
 . S NIEN2=DA
"RTN","PSSMIGRE",242,0)
 . ; Delete ROUTE OF ADMINISTRATION
"RTN","PSSMIGRE",243,0)
 . I $D(^PSNDF(50.67,NIEN2,1,1)) D
"RTN","PSSMIGRE",244,0)
 .. N DA,DIK
"RTN","PSSMIGRE",245,0)
 .. S DIK="^PSNDF(50.67,"_NIEN2_",1,"
"RTN","PSSMIGRE",246,0)
 .. S DA(1)=NIEN2,DA=$O(^PSNDF(50.67,NIEN2,1,"A"),-1) D ^DIK
"RTN","PSSMIGRE",247,0)
 .. F  S DA=DA-1 Q:'DA>0  D ^DIK
"RTN","PSSMIGRE",248,0)
 . ;
"RTN","PSSMIGRE",249,0)
 . I '$D(^PSNDF(50.67,NIEN2,1,1)) D
"RTN","PSSMIGRE",250,0)
 .. ; Stuff ROUTE OF ADMINISTRATION entries
"RTN","PSSMIGRE",251,0)
 .. N DA,DIC
"RTN","PSSMIGRE",252,0)
 .. S DIC="^PSNDF(50.67,"_NIEN2_",1,",DIC(0)="L",DIC("P")="50.676A"
"RTN","PSSMIGRE",253,0)
 .. S DA(1)=NIEN2,DA=1,X="N/A" D FILE^DICN
"RTN","PSSMIGRE",254,0)
 . ;
"RTN","PSSMIGRE",255,0)
 . F  S NIEN2=$O(^PSNDF(50.67,"NDC",NAME,NIEN2)) Q:NIEN2=""  D
"RTN","PSSMIGRE",256,0)
 .. D DT^DICRW S DA=NIEN2,DIE=50.67,IDATE=DT
"RTN","PSSMIGRE",257,0)
 .. S DR="7///^S X=IDATE"
"RTN","PSSMIGRE",258,0)
 .. S:$P(NDF0,"^",2)'=NAME DR=";1///^S X=NAME"
"RTN","PSSMIGRE",259,0)
 .. S:$P(NDF0,"^",3)'=UPN DR=DR_";2///"_$S(UPN]"":"^S X=UPN",1:"@")
"RTN","PSSMIGRE",260,0)
 .. S:$P(NDF0,"^",4)'=MIEN DR=DR_";3///^S X=MIEN"
"RTN","PSSMIGRE",261,0)
 .. S:$P(NDF0,"^",5)'=TNAME DR=DR_";4///"_$S(TNAME]"":"^S X=TNAME",1:"@")
"RTN","PSSMIGRE",262,0)
 .. S:$P(NDF0,"^",6)'=PIEN DR=DR_";5///^S X=PIEN"
"RTN","PSSMIGRE",263,0)
 .. S:$P(NDF0,"^",8)'=SIEN DR=DR_";8///"_$S(SIEN]"":"^S X=SIEN",1:"@")
"RTN","PSSMIGRE",264,0)
 .. S:$P(NDF0,"^",9)'=PTIEN DR=DR_";9///"_$S(PTIEN]"":"^S X=PTIEN",1:"@")
"RTN","PSSMIGRE",265,0)
 .. S PSOT=$S(PSOTC="Prescription":"R",PSOTC="Over the Counter":"O",1:"")
"RTN","PSSMIGRE",266,0)
 .. S:$P(NDF0,"^",10)'=PSOT DR=DR_";10///"_$S(PSOTC]"":"^S X=PSOTC",1:"@")
"RTN","PSSMIGRE",267,0)
 .. D ^DIE
"RTN","PSSMIGRE",268,0)
 ;
"RTN","PSSMIGRE",269,0)
 Q:$G(ERORR)=1
"RTN","PSSMIGRE",270,0)
 ;
"RTN","PSSMIGRE",271,0)
 S XMESS="<message>  Updated NDC: "_NAME_" </message>"
"RTN","PSSMIGRE",272,0)
 S XIEN="<ien>"_PSS("IEN")_"</ien>"
"RTN","PSSMIGRE",273,0)
 K DIC,DA,DR,DIE,^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",274,0)
 Q
"RTN","PSSMIGRE",275,0)
 ;
"RTN","PSSMIGRE",276,0)
 ;
"RTN","PSSMIGRE",277,0)
VAGN ; VA Generic Sync
"RTN","PSSMIGRE",278,0)
 N X,Y,DIC,DA,DR,DIE,IEN,NAME,RTYPE,IDATE,MVUID,VUID,EFFDT,STATUS,CMVUID
"RTN","PSSMIGRE",279,0)
 S NAME=$G(PSS("NAME")),IEN=$G(PSS("IEN")),RTYPE=$G(PSS("RTYPE"))
"RTN","PSSMIGRE",280,0)
 S IDATE=$TR($P($G(PSS("INACTDATE")),"T"),"-",""),IDATE=$$HL7TFM^XLFDT(IDATE,"L")
"RTN","PSSMIGRE",281,0)
 S MVUID=$G(PSS("MASTERVUID")),VUID=$G(PSS("VUID")),EFFDT=$G(PSS("EFFDATE")),STATUS=$G(PSS("STATUS"))
"RTN","PSSMIGRE",282,0)
 S FNUM=50.6,FNAME="syncResponse.XML",FNAME1="vaGenericName"
"RTN","PSSMIGRE",283,0)
 ;
"RTN","PSSMIGRE",284,0)
 ; Quit if REQUIRED DATA is Missing
"RTN","PSSMIGRE",285,0)
 I NAME="" D OUT^PSSMIGRC(" Error...Missing Required NAME") Q
"RTN","PSSMIGRE",286,0)
 I MVUID="" D OUT^PSSMIGRC(" Error...Missing Required MASTER VUID") Q
"RTN","PSSMIGRE",287,0)
 I VUID="" D OUT^PSSMIGRC(" Error...Missing Required VUID") Q
"RTN","PSSMIGRE",288,0)
 I EFFDT="" D OUT^PSSMIGRC(" Error...Missing Required EFFECTIVE DATE") Q
"RTN","PSSMIGRE",289,0)
 I STATUS="" D OUT^PSSMIGRC(" Error...Missing Required STATUS") Q
"RTN","PSSMIGRE",290,0)
 ;
"RTN","PSSMIGRE",291,0)
 S EFFDT=$$DATE^PSSMIGRD($G(PSS("EFFDATE")))
"RTN","PSSMIGRE",292,0)
 ;Q
"RTN","PSSMIGRE",293,0)
 ;Add the VA Generic Name to the Database
"RTN","PSSMIGRE",294,0)
 D:RTYPE="ADD"
"RTN","PSSMIGRE",295,0)
 . ; Lock the Global
"RTN","PSSMIGRE",296,0)
 . L +^PSNDF(50.6):5 E  D OUT^PSSMIGRC(" Another USER editing VA Generic Name file") Q
"RTN","PSSMIGRE",297,0)
 . ;
"RTN","PSSMIGRE",298,0)
 . ; Cheating - Remove LAYGO temporarly
"RTN","PSSMIGRE",299,0)
 . S ^TMP("AJF LAYGO",$J)=$G(^DD(50.6,.01,"LAYGO",.01,0))
"RTN","PSSMIGRE",300,0)
 . I ^TMP("AJF LAYGO",$J)]"" K ^DD(50.6,.01,"LAYGO",.01,0)
"RTN","PSSMIGRE",301,0)
 . ;
"RTN","PSSMIGRE",302,0)
 . ; Get the IEN
"RTN","PSSMIGRE",303,0)
 . S X=NAME,DIC=50.6,DIC(0)="LMXZ"
"RTN","PSSMIGRE",304,0)
 . D ^DIC
"RTN","PSSMIGRE",305,0)
 . S (DA,PSS("IEN"),PIEN)=+Y
"RTN","PSSMIGRE",306,0)
 . ;
"RTN","PSSMIGRE",307,0)
 . ; Quit if cannot get IEN
"RTN","PSSMIGRE",308,0)
 . I Y<1 D  Q
"RTN","PSSMIGRE",309,0)
 . . D OUT^PSSMIGRC(" Error...Cannot obtain an IEN for NAME")
"RTN","PSSMIGRE",310,0)
 . . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.6,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",311,0)
 . ;
"RTN","PSSMIGRE",312,0)
 . ; Set Database Variables
"RTN","PSSMIGRE",313,0)
 . S DIE=DIC K DIC
"RTN","PSSMIGRE",314,0)
 . S DR="1///^S X=IDATE;99.98///^S X=MVUID;99.99///^S X=VUID"
"RTN","PSSMIGRE",315,0)
 . ;S DR(2,50.6009)=".01///^S X=EFFDT;.02///^S X=STATUS"
"RTN","PSSMIGRE",316,0)
 . ;
"RTN","PSSMIGRE",317,0)
 . ; Update Database
"RTN","PSSMIGRE",318,0)
 . D ^DIE
"RTN","PSSMIGRE",319,0)
 . S DIC="^PSNDF(50.6,"_PIEN_",""TERMSTATUS"",",DIC(0)="L",DIC("P")="50.6009DA"
"RTN","PSSMIGRE",320,0)
 . S DA(1)=PIEN,DA=1,X=EFFDT
"RTN","PSSMIGRE",321,0)
 . D FILE^DICN
"RTN","PSSMIGRE",322,0)
 . S DIE=DIC,DR=".02///^S X=STATUS"
"RTN","PSSMIGRE",323,0)
 . D ^DIE
"RTN","PSSMIGRE",324,0)
 . ;
"RTN","PSSMIGRE",325,0)
 . ;S ^PSNDF(50.6,DA,"TERMSTATUS",0)="^50.6009^1^1"
"RTN","PSSMIGRE",326,0)
 . ;S ^PSNDF(50.6,DA,"TERMSTATUS",1,0)=EFFDT_"^"_STATUS
"RTN","PSSMIGRE",327,0)
 . ;S ^PSNDF(50.6,DA,"TERMSTATUS","B",EFFDT,1)=""
"RTN","PSSMIGRE",328,0)
 . ;
"RTN","PSSMIGRE",329,0)
 . ; Put LAYGO back
"RTN","PSSMIGRE",330,0)
 . S:^TMP("AJF LAYGO",$J)]"" ^DD(50.416,.01,"LAYGO",.01,0)=^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",331,0)
 . L -^PSNDF(50.6)
"RTN","PSSMIGRE",332,0)
 . ;
"RTN","PSSMIGRE",333,0)
 ;
"RTN","PSSMIGRE",334,0)
 D:RTYPE="MODIFY"
"RTN","PSSMIGRE",335,0)
 . S DA=PSS("IEN"),DIE=50.6
"RTN","PSSMIGRE",336,0)
 . S PS5=$G(^PSNDF(50.6,DA,0)),PSMV=$G(^PSNDF(50.6,DA,"VUID")),DR="",PQ=""
"RTN","PSSMIGRE",337,0)
 . S:$P(PS5,"^",2)'=IDATE DR=DR_PQ_"1///"_$S(IDATE]"":"^S X=IDATE",1:"@") S:$L(DR) PQ=";"
"RTN","PSSMIGRE",338,0)
 . ;S CMVUID=$P(PSMV,"^",2),CMVUID=$S(CMVUID=1:"YES",CMVUID=0:"NO",1:"")
"RTN","PSSMIGRE",339,0)
 . S:$P(PSMV,"^",2)'=MVUID DR=DR_PQ_"99.98///^S X=MVUID" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",340,0)
 . S:$P(PSMV,"^",1)'=VUID DR=DR_PQ_"99.99///^S X=VUID" S:$L(DR) PQ=";"
"RTN","PSSMIGRE",341,0)
 . ;S DR="1///"_$S(IDATE]"":"^S X=IDATE",1:"@")_";99.98///^S X=MVUID;99.99///^S X=VUID"
"RTN","PSSMIGRE",342,0)
 . ;S DR(2,50.6009)=".01///^S X=EFFDT;.02///^S X=STATUS"
"RTN","PSSMIGRE",343,0)
 . ;
"RTN","PSSMIGRE",344,0)
 . ; Update Database
"RTN","PSSMIGRE",345,0)
 . D ^DIE
"RTN","PSSMIGRE",346,0)
 . ;
"RTN","PSSMIGRE",347,0)
 . ; Stuff EFFECTIVE DATE/TIME entries
"RTN","PSSMIGRE",348,0)
 . ;K ^PSNDF(50.6,DA,"TERMSTATUS")
"RTN","PSSMIGRE",349,0)
 . ;S DIC="^PSNDF(50.6,"_PIEN_",""TERMSTATUS"",",DIC(0)="L",DIC("P")="50.6009DA"
"RTN","PSSMIGRE",350,0)
 . ;S DA(1)=PIEN,DA=1,X=EFFDT
"RTN","PSSMIGRE",351,0)
 . ;D FILE^DICN
"RTN","PSSMIGRE",352,0)
 . ;S DIE=DIC,DR=".02///^S X=STATUS"
"RTN","PSSMIGRE",353,0)
 . ;D ^DIE
"RTN","PSSMIGRE",354,0)
 . ;
"RTN","PSSMIGRE",355,0)
 . ;S ^PSNDF(50.6,DA,"TERMSTATUS",0)="^50.6009^1^1"
"RTN","PSSMIGRE",356,0)
 . ;S ^PSNDF(50.6,DA,"TERMSTATUS",1,0)=EFFDT_"^"_STATUS
"RTN","PSSMIGRE",357,0)
 . ;S ^PSNDF(50.6,DA,"TERMSTATUS","B",EFFDT,1)=""
"RTN","PSSMIGRE",358,0)
 . ;
"RTN","PSSMIGRE",359,0)
 . ; Updating ^NDFK files
"RTN","PSSMIGRE",360,0)
 . ;
"RTN","PSSMIGRE",361,0)
 . I IDATE]"" D
"RTN","PSSMIGRE",362,0)
 . . S X=NAME,DIC=5000.3,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRE",363,0)
 . . S VAPRO=""
"RTN","PSSMIGRE",364,0)
 . . F  S VAPRO=$O(^PSNDF(50.6,"APRO",DA,VAPRO)) Q:VAPRO=""  D
"RTN","PSSMIGRE",365,0)
 . . .S X=VAPRO,DIC=5000.2,DIC(0)="LMXZ" D ^DIC
"RTN","PSSMIGRE",366,0)
 ;
"RTN","PSSMIGRE",367,0)
 ;
"RTN","PSSMIGRE",368,0)
 S XMESS="<message><![CDATA[ Updated VA Generic: "_NAME_"]]></message>"
"RTN","PSSMIGRE",369,0)
 S XIEN="<ien>"_$G(PSS("IEN"))_"</ien>"
"RTN","PSSMIGRE",370,0)
 K DIC,DA,DR,DIE,^TMP("AJF LAYGO",$J)
"RTN","PSSMIGRE",371,0)
 Q
"VER")
8.0^22.0
**END**
**END**
