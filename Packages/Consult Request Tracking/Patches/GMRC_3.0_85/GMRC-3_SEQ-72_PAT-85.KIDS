EMERGENCY Released GMRC*3*85 SEQ #72
Extracted from mail message
**KIDS**:GMRC*3.0*85^

**INSTALL NAME**
GMRC*3.0*85
"BLD",9373,0)
GMRC*3.0*85^CONSULT/REQUEST TRACKING^0^3151222^y
"BLD",9373,1,0)
^^2^2^3151104^
"BLD",9373,1,1,0)
Remove diagnosis code validation from processing of new and edit/resubmit 
"BLD",9373,1,2,0)
consult orders.
"BLD",9373,4,0)
^9.64PA^^
"BLD",9373,6.3)
3
"BLD",9373,"ABPKG")
n
"BLD",9373,"INI")
PRE^GMRCP85
"BLD",9373,"INID")
^n^n
"BLD",9373,"INIT")
POST^GMRCP85
"BLD",9373,"KRN",0)
^9.67PA^779.2^20
"BLD",9373,"KRN",.4,0)
.4
"BLD",9373,"KRN",.401,0)
.401
"BLD",9373,"KRN",.402,0)
.402
"BLD",9373,"KRN",.403,0)
.403
"BLD",9373,"KRN",.5,0)
.5
"BLD",9373,"KRN",.84,0)
.84
"BLD",9373,"KRN",3.6,0)
3.6
"BLD",9373,"KRN",3.8,0)
3.8
"BLD",9373,"KRN",9.2,0)
9.2
"BLD",9373,"KRN",9.8,0)
9.8
"BLD",9373,"KRN",9.8,"NM",0)
^9.68A^6^6
"BLD",9373,"KRN",9.8,"NM",1,0)
GMRCGUIC^^0^B68517845
"BLD",9373,"KRN",9.8,"NM",2,0)
GMRCHL7B^^0^B26855576
"BLD",9373,"KRN",9.8,"NM",3,0)
GMRCEDT1^^0^B69360979
"BLD",9373,"KRN",9.8,"NM",4,0)
GMRCEDT2^^0^B16802448
"BLD",9373,"KRN",9.8,"NM",5,0)
GMRCEDT4^^0^B85518879
"BLD",9373,"KRN",9.8,"NM",6,0)
GMRCHL7H^^0^B130038973
"BLD",9373,"KRN",9.8,"NM","B","GMRCEDT1",3)

"BLD",9373,"KRN",9.8,"NM","B","GMRCEDT2",4)

"BLD",9373,"KRN",9.8,"NM","B","GMRCEDT4",5)

"BLD",9373,"KRN",9.8,"NM","B","GMRCGUIC",1)

"BLD",9373,"KRN",9.8,"NM","B","GMRCHL7B",2)

"BLD",9373,"KRN",9.8,"NM","B","GMRCHL7H",6)

"BLD",9373,"KRN",19,0)
19
"BLD",9373,"KRN",19.1,0)
19.1
"BLD",9373,"KRN",101,0)
101
"BLD",9373,"KRN",409.61,0)
409.61
"BLD",9373,"KRN",771,0)
771
"BLD",9373,"KRN",779.2,0)
779.2
"BLD",9373,"KRN",870,0)
870
"BLD",9373,"KRN",8989.51,0)
8989.51
"BLD",9373,"KRN",8989.52,0)
8989.52
"BLD",9373,"KRN",8994,0)
8994
"BLD",9373,"KRN","B",.4,.4)

"BLD",9373,"KRN","B",.401,.401)

"BLD",9373,"KRN","B",.402,.402)

"BLD",9373,"KRN","B",.403,.403)

"BLD",9373,"KRN","B",.5,.5)

"BLD",9373,"KRN","B",.84,.84)

"BLD",9373,"KRN","B",3.6,3.6)

"BLD",9373,"KRN","B",3.8,3.8)

"BLD",9373,"KRN","B",9.2,9.2)

"BLD",9373,"KRN","B",9.8,9.8)

"BLD",9373,"KRN","B",19,19)

"BLD",9373,"KRN","B",19.1,19.1)

"BLD",9373,"KRN","B",101,101)

"BLD",9373,"KRN","B",409.61,409.61)

"BLD",9373,"KRN","B",771,771)

"BLD",9373,"KRN","B",779.2,779.2)

"BLD",9373,"KRN","B",870,870)

"BLD",9373,"KRN","B",8989.51,8989.51)

"BLD",9373,"KRN","B",8989.52,8989.52)

"BLD",9373,"KRN","B",8994,8994)

"BLD",9373,"QUES",0)
^9.62^^
"BLD",9373,"REQB",0)
^9.611^2^2
"BLD",9373,"REQB",1,0)
GMRC*3.0*73^1
"BLD",9373,"REQB",2,0)
GMRC*3.0*75^1
"BLD",9373,"REQB","B","GMRC*3.0*73",1)

"BLD",9373,"REQB","B","GMRC*3.0*75",2)

"INI")
PRE^GMRCP85
"INIT")
POST^GMRCP85
"MBREQ")
0
"PKG",294,-1)
1^1
"PKG",294,0)
CONSULT/REQUEST TRACKING^GMRC^CONSULTS/REQUESTS
"PKG",294,20,0)
^9.402P^^
"PKG",294,22,0)
^9.49I^1^1
"PKG",294,22,1,0)
3.0^2980101^2980917^11712
"PKG",294,22,1,"PAH",1,0)
85^3151222
"PKG",294,22,1,"PAH",1,1,0)
^^2^2^3151222
"PKG",294,22,1,"PAH",1,1,1,0)
Remove diagnosis code validation from processing of new and edit/resubmit 
"PKG",294,22,1,"PAH",1,1,2,0)
consult orders.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","GMRCEDT1")
0^3^B69360979^B70113386
"RTN","GMRCEDT1",1,0)
GMRCEDT1 ;SLC/DCM,JFR - EDIT A CONSULT AND RE-SEND AS NEW ;10/13/15  06:57
"RTN","GMRCEDT1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,15,22,33,47,66,73,85**;DEC 27, 1997;Build 3
"RTN","GMRCEDT1",3,0)
 ;
"RTN","GMRCEDT1",4,0)
 ; This routine invokes IA #2638 (^ORD(100.01,), #10117 (VALM10)
"RTN","GMRCEDT1",5,0)
 ;                         #10103 (XLFDT), #10104 (XLFSTR), #10060 (access ^VA(200)), #2056 (GET1^DIQ)
"RTN","GMRCEDT1",6,0)
 ;
"RTN","GMRCEDT1",7,0)
EN(GMRCO) ;GMRCO=IEN of consult from file 123
"RTN","GMRCEDT1",8,0)
 ;GMRCSS=To Service   GMRCPROC=Procedure Request Type
"RTN","GMRCEDT1",9,0)
 ;GMRCURG=Urgency     GMRCPL=Place Of Consultation
"RTN","GMRCEDT1",10,0)
 ;GMRCATN=Attention   GMRCINO=Service is In/Out Patient
"RTN","GMRCEDT1",11,0)
 ;GMRCPNM=Patient Name  GMRCDIAG=Provisional Diagnosis
"RTN","GMRCEDT1",12,0)
 ;GMRCERDT=Earliest Appr. Date
"RTN","GMRCEDT1",13,0)
 ;GMRCPROS=Prosthetics Service y/n
"RTN","GMRCEDT1",14,0)
 ;GMRCCPTR=pointer to coding systems file
"RTN","GMRCEDT1",15,0)
 ;GMRCCSYS=provisional diagnosis code sys    GMRCCODE=provisional diagnosis code
"RTN","GMRCEDT1",16,0)
 N GMRCSS,GMRCPROC,GMRCURG,GMRCPL,GMRCATN,GMRCINO,GMRCDIAG,LN,GMRCRESP,GMRCERDT,GMRCPROS,IDX,GMRCDATE,GMRCCSYS,GMRCCODE
"RTN","GMRCEDT1",17,0)
 N GMRCLBL,BUFFER,REPEAT
"RTN","GMRCEDT1",18,0)
 S REPEAT=24
"RTN","GMRCEDT1",19,0)
 K ^TMP("GMRCR",$J,"ED") S GMRCLNO=1
"RTN","GMRCEDT1",20,0)
 I $L($P(^GMR(123,+GMRCO,0),"^",12)) S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  CURRENT STATUS: (Not Editable): "_$P(^ORD(100.01,$P(^(0),"^",12),0),"^",1),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",21,0)
 S GMRCD=0 F  S GMRCD=$O(^GMR(123,+GMRCO,40,"B",GMRCD)) Q:'GMRCD  S GMRCDD="" F  S GMRCDD=$O(^GMR(123,GMRCO,40,"B",GMRCD,GMRCDD)) Q:'GMRCDD  D
"RTN","GMRCEDT1",22,0)
 .I $P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",2)=19 S LN=0 D
"RTN","GMRCEDT1",23,0)
 ..N GMRCPERS,GMRCTX
"RTN","GMRCEDT1",24,0)
 ..I '$D(^GMR(123,+GMRCO,12)) D
"RTN","GMRCEDT1",25,0)
 ...S GMRCPERS=+$P($G(^GMR(123,+GMRCO,40,GMRCDD,0)),"^",5)
"RTN","GMRCEDT1",26,0)
 ...S GMRCPERS=$$GET1^DIQ(200,GMRCPERS,.01)
"RTN","GMRCEDT1",27,0)
 ..I $D(^GMR(123,+GMRCO,12)) D
"RTN","GMRCEDT1",28,0)
 ...I $P(^GMR(123,+GMRCO,12),U,5)="P" D
"RTN","GMRCEDT1",29,0)
 ....S GMRCPERS=$P($G(^GMR(123,+GMRCO,40,GMRCDD,2)),U,1)
"RTN","GMRCEDT1",30,0)
 ...I $P(^GMR(123,+GMRCO,12),U,5)="F" D
"RTN","GMRCEDT1",31,0)
 ....S GMRCPERS=$P($G(^GMR(123,+GMRCO,40,GMRCDD,0)),U,5)
"RTN","GMRCEDT1",32,0)
 ....S GMRCPERS=$$GET1^DIQ(200,GMRCPERS,.01)
"RTN","GMRCEDT1",33,0)
 ..S GMRCTX="  CANCELLED BY (Not Editable): "_GMRCPERS
"RTN","GMRCEDT1",34,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=GMRCTX,GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",35,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  CANCELLED COMMENT (Not Editable):",GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",36,0)
 ..S LN=$O(^GMR(123,+GMRCO,40,GMRCDD,1,LN)) Q:LN=""!(LN?1A.E)  I $L(^GMR(123,+GMRCO,40,GMRCDD,1,LN,0))>75 S FLG=1 D WPSET^GMRCUTIL("^GMR(123,+GMRCO,40,GMRCDD,1)","^TMP(""GMRCR"",$J,""ED"")","",.GMRCLNO,"",FLG)
"RTN","GMRCEDT1",37,0)
 ..I '$D(FLG) S LN=0 F  S LN=$O(^GMR(123,+GMRCO,40,GMRCDD,1,LN)) Q:LN=""!(LN?1A.E)  S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^(LN,0),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",38,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="",$P(^(0),"-",79)=""
"RTN","GMRCEDT1",39,0)
 ..S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",40,0)
 ..Q
"RTN","GMRCEDT1",41,0)
 .Q
"RTN","GMRCEDT1",42,0)
 S GMRCSS=$S($D(GMRCEDT(1)):GMRCEDT(1),1:$P(^GMR(123,+GMRCO,0),"^",5)_U_$P(^GMR(123.5,$P(^GMR(123,+GMRCO,0),"^",5),0),U))
"RTN","GMRCEDT1",43,0)
 S GMRCPROC=$S($D(GMRCED(1)):GMRCED(1),1:$P(^GMR(123,+GMRCO,0),"^",8)_U_$$GET1^DIQ(123.3,+$P(^GMR(123,+GMRCO,0),"^",8),.01))
"RTN","GMRCEDT1",44,0)
 I $D(GMRCED(2)) S GMRCINO=GMRCED(2)
"RTN","GMRCEDT1",45,0)
 I '$D(GMRCINO) S GMRCINO=$P(^GMR(123,+GMRCO,0),U,18)_U_$S($P(^(0),U,18)="I":"Inpatient",1:"Outpatient")
"RTN","GMRCEDT1",46,0)
 S GMRCURG=$S($D(GMRCED(3)):GMRCED(3),1:$P(^GMR(123,+GMRCO,0),"^",9)_U_$$GET1^DIQ(101,+$P(^(0),"^",9),1))
"RTN","GMRCEDT1",47,0)
 S GMRCPL=$S($D(GMRCED(4)):GMRCED(4),1:$P(^GMR(123,+GMRCO,0),"^",10)_U_$$GET1^DIQ(101,+$P(^(0),U,10),1))
"RTN","GMRCEDT1",48,0)
 S GMRCPROS=$G(^GMR(123.5,$P(GMRCSS,U),"INT")) I $G(GMRCPROS)="" D
"RTN","GMRCEDT1",49,0)
 .S GMRCERDT=$S($D(GMRCED(5)):GMRCED(5),1:$P(^GMR(123,+GMRCO,0),"^",24)_U_$$FMTE^XLFDT($P(^GMR(123,GMRCO,0),U,24)))
"RTN","GMRCEDT1",50,0)
 S GMRCATN=$S($D(GMRCED(6)):GMRCED(6),1:$P(^GMR(123,+GMRCO,0),"^",11)_U_$$GET1^DIQ(200,+$P(^(0),U,11),.01))
"RTN","GMRCEDT1",51,0)
 I '$D(^GMR(123,GMRCO,30.1)) D
"RTN","GMRCEDT1",52,0)
 . I $D(GMRCED(7)),$L($P(GMRCED(7),U,2)) D  Q
"RTN","GMRCEDT1",53,0)
 .. S GMRCDIAG=$P(GMRCED(7),U)_" ("_$P(GMRCED(7),U,2)_")"
"RTN","GMRCEDT1",54,0)
 . S GMRCDIAG=$S($D(GMRCED(7)):GMRCED(7),1:$G(^GMR(123,+GMRCO,30)))
"RTN","GMRCEDT1",55,0)
 I $D(^GMR(123,GMRCO,30.1)) D
"RTN","GMRCEDT1",56,0)
 . S GMRCCODE=$P($G(^GMR(123,+GMRCO,30.1)),"^",1)
"RTN","GMRCEDT1",57,0)
 . S GMRCCSYS=$P($G(^GMR(123,+GMRCO,30.1)),"^",3)
"RTN","GMRCEDT1",58,0)
 . S:$G(GMRCCSYS)="ICD" GMRCLBL="(ICD-9-CM "_$G(GMRCCODE)_")"
"RTN","GMRCEDT1",59,0)
 . S:$G(GMRCCSYS)="10D" GMRCLBL="(ICD-10-CM "_$G(GMRCCODE)_")"
"RTN","GMRCEDT1",60,0)
 . I $D(GMRCED(7)),$L(GMRCED(7)) D  Q
"RTN","GMRCEDT1",61,0)
 .. S GMRCDIAG=$P(GMRCED(7),U)
"RTN","GMRCEDT1",62,0)
 .. S GMRCCODE=$P(GMRCED(7),U,2)
"RTN","GMRCEDT1",63,0)
 .. S GMRCCSYS=$$CODECS^ICDEX($G(GMRCCODE),80) ;WAT/85 use dx code to get coding system
"RTN","GMRCEDT1",64,0)
 .. S GMRCLBL="" ;just in case coding system is null
"RTN","GMRCEDT1",65,0)
 .. S:GMRCCSYS="ICD" GMRCLBL="(ICD-9-CM "_GMRCCODE_")"
"RTN","GMRCEDT1",66,0)
 .. S:GMRCCSYS="10D" GMRCLBL="(ICD-10-CM "_GMRCCODE_")"
"RTN","GMRCEDT1",67,0)
 .. S GMRCDIAG=$G(GMRCDIAG)_$G(GMRCLBL)
"RTN","GMRCEDT1",68,0)
 . S GMRCDIAG=$G(^GMR(123,+GMRCO,30))_$G(GMRCLBL)
"RTN","GMRCEDT1",69,0)
 S GMRCREQ=$S(+$P(^GMR(123,+GMRCO,0),U,17)="P":"Procedure",1:"Consult")
"RTN","GMRCEDT1",70,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="SENDING PROVIDER (Not Editable): "_$S($P($G(^GMR(123,+GMRCO,12)),U,6):$P(^GMR(123,+GMRCO,12),U,6),$P(^GMR(123,+GMRCO,0),"^",14):$$GET1^DIQ(200,+$P(^GMR(123,+GMRCO,0),"^",14),.01),1:"UNKNOWN"),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",71,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="REQUEST TYPE (Not Editable): "_GMRCREQ,GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",72,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=$$REPEAT^XLFSTR("-",79),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",73,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  TO SERVICE (Not Editable): "_$P(GMRCSS,U,2) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",74,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=" ",GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",75,0)
 S IDX=1,^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" PROCEDURE: "_$P(GMRCPROC,U,2)
"RTN","GMRCEDT1",76,0)
 D:+GMRCPROC RVRS(GMRCLNO,$D(GMRCED(IDX))) S GMRCLNO=GMRCLNO+1,IDX=IDX+1
"RTN","GMRCEDT1",77,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" Performed as INPT OR OUTPT: "_$P(GMRCINO,U,2) D RVRS(GMRCLNO,$D(GMRCED(2))) S GMRCLNO=GMRCLNO+1,IDX=IDX+1
"RTN","GMRCEDT1",78,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" URGENCY: "_$P(GMRCURG,U,2) D RVRS(GMRCLNO,$D(GMRCED(3))) S GMRCLNO=GMRCLNO+1,IDX=IDX+1
"RTN","GMRCEDT1",79,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" PLACE OF CONSULTATION: "_$P(GMRCPL,U,2) D RVRS(GMRCLNO,$D(GMRCED(4))) S GMRCLNO=GMRCLNO+1,IDX=IDX+1
"RTN","GMRCEDT1",80,0)
 I $G(GMRCPROS)="" S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" EARLIEST APPROPRIATE DATE: "_$P(GMRCERDT,U,2) D RVRS(GMRCLNO,$D(GMRCED(5))) S GMRCLNO=GMRCLNO+1,IDX=IDX+1
"RTN","GMRCEDT1",81,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" ATTENTION (CONSULTANT): "_$P(GMRCATN,U,2) D RVRS(GMRCLNO,$D(GMRCED(6))) S GMRCLNO=GMRCLNO+1,IDX=IDX+1
"RTN","GMRCEDT1",82,0)
 I $L($G(GMRCDIAG))<55 S:$G(FLG)="" ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" PROVISIONAL DIAGNOSIS: "_GMRCDIAG D RVRS(GMRCLNO,$D(GMRCED(7))) S GMRCLNO=GMRCLNO+1,IDX=IDX+1
"RTN","GMRCEDT1",83,0)
 I $L($G(GMRCDIAG))>54 D
"RTN","GMRCEDT1",84,0)
 .N PIECE,FLG S FLG=0
"RTN","GMRCEDT1",85,0)
 .F  S PIECE=$L(GMRCDIAG) Q:PIECE<54  D
"RTN","GMRCEDT1",86,0)
 .. N SEG,I S I=2
"RTN","GMRCEDT1",87,0)
 .. F  S SEG=$P(GMRCDIAG," ",1,I) Q:$L(SEG)>=54!($L(SEG," ")<I)  S I=I+1
"RTN","GMRCEDT1",88,0)
 .. I $L(SEG)=$L(GMRCDIAG) S SEG=$E(GMRCDIAG,1,54) ;means GMRCDIAG doesn't contain spaces, e.g. v55,250.00,414.00,etc.
"RTN","GMRCEDT1",89,0)
 .. S BUFFER=SEG
"RTN","GMRCEDT1",90,0)
 .. S:SEG[" " SEG=$P(GMRCDIAG," ",1,(I-1)) I $L(SEG)=0 S SEG=$E(BUFFER,1,54) ;$P only good when SEG contains a space, otherwise grab a SEG from BUFFER
"RTN","GMRCEDT1",91,0)
 .. D KILL^VALM10(GMRCLNO)
"RTN","GMRCEDT1",92,0)
 .. S:FLG=0 ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" PROVISIONAL DIAGNOSIS: "_SEG D RVRS(GMRCLNO,$D(GMRCED(7)))
"RTN","GMRCEDT1",93,0)
 .. I FLG=1&($F(GMRCDIAG," ")'=2) S REPEAT=25
"RTN","GMRCEDT1",94,0)
 .. S:FLG=1 ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=$$REPEAT^XLFSTR(" ",REPEAT)_SEG
"RTN","GMRCEDT1",95,0)
 .. S FLG=1,GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",96,0)
 .. S GMRCDIAG=$E(GMRCDIAG,$L(SEG)+1,999)
"RTN","GMRCEDT1",97,0)
 . I $F(GMRCD," ")'=2 S REPEAT=25
"RTN","GMRCEDT1",98,0)
 . S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=$$REPEAT^XLFSTR(" ",REPEAT)_GMRCDIAG
"RTN","GMRCEDT1",99,0)
 . S IDX=IDX+1,GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",100,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" REASON FOR REQUEST:" D RVRS(GMRCLNO,$D(^TMP("GMRCED",$J,20))) S GMRCLNO=GMRCLNO+1,IDX=IDX+1 D
"RTN","GMRCEDT1",101,0)
 . I $D(^TMP("GMRCED",$J,20)) D  Q
"RTN","GMRCEDT1",102,0)
 .. N ND S ND=0
"RTN","GMRCEDT1",103,0)
 .. F  S ND=$O(^TMP("GMRCED",$J,20,ND)) Q:'ND  D
"RTN","GMRCEDT1",104,0)
 ... D KILL^VALM10(GMRCLNO)
"RTN","GMRCEDT1",105,0)
 ... S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^TMP("GMRCED",$J,20,ND,0)
"RTN","GMRCEDT1",106,0)
 ... S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",107,0)
 . N ND S ND=0
"RTN","GMRCEDT1",108,0)
 . F  S ND=$O(^GMR(123,+GMRCO,20,ND)) Q:ND=""  D
"RTN","GMRCEDT1",109,0)
 .. S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^GMR(123,+GMRCO,20,ND,0)
"RTN","GMRCEDT1",110,0)
 .. S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",111,0)
 .Q
"RTN","GMRCEDT1",112,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="",GMRCLNO=GMRCLNO+1,^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" COMMENT(S): (Add Only)" D RVRS(GMRCLNO) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",113,0)
 I $D(^TMP("GMRCED",$J,40)) D
"RTN","GMRCEDT1",114,0)
 . D KILL^VALM10(GMRCLNO)
"RTN","GMRCEDT1",115,0)
 . S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  New Comment:",GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",116,0)
 . N ND S ND=0 F  S ND=$O(^TMP("GMRCED",$J,40,ND)) Q:'ND  D
"RTN","GMRCEDT1",117,0)
 .. S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^TMP("GMRCED",$J,40,ND,0)
"RTN","GMRCEDT1",118,0)
 .. S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",119,0)
 N GMRCEDCT
"RTN","GMRCEDT1",120,0)
 S GMRCD=0,GMRCEDCT=0 F  S GMRCD=$O(^GMR(123,+GMRCO,40,"B",GMRCD)) Q:'GMRCD  S GMRCDD="",GMRCDD=$O(^GMR(123,+GMRCO,40,"B",GMRCD,GMRCDD)) Q:'GMRCDD  D
"RTN","GMRCEDT1",121,0)
 .I $P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",2)=20 S LN=0,GMRCEDCT=GMRCEDCT+1,GMRCEDCM(GMRCEDCT)=GMRCDD D
"RTN","GMRCEDT1",122,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="",GMRCLNO=GMRCLNO+1,^TMP("GMRCR",$J,"ED",GMRCLNO,0)="ADDED COMMENT (Not Editable) Entered: "_$P($$FMTE^XLFDT($P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",1)),"@",1)
"RTN","GMRCEDT1",123,0)
 ..S GMRCRESP=$S($L($P($G(^GMR(123,+GMRCO,40,GMRCDD,0)),"^",5)):$$GET1^DIQ(200,$P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",5),.01),$L($P($G(^GMR(123,+GMRCO,40,GMRCDD,2)),"^",1)):$P(^GMR(123,+GMRCO,40,GMRCDD,2),"^",1),1:"UNKNOWN")
"RTN","GMRCEDT1",124,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^TMP("GMRCR",$J,"ED",GMRCLNO,0)_" BY: "_GMRCRESP,GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",125,0)
 ..;S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^TMP("GMRCR",$J,"ED",GMRCLNO,0)_" BY: "_$S($L($P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",4)):$P(^VA(200,$P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",4),0),"^",1),1:"UNKNOWN"),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",126,0)
 ..S LN=$O(^GMR(123,+GMRCO,40,GMRCDD,1,LN)) Q:LN=""!(LN?1A.E)  I $L(^GMR(123,+GMRCO,40,GMRCDD,1,LN,0))>75 S FLG=1 D WPSET^GMRCUTIL("^GMR(123,+GMRCO,40,GMRCDD,1)","^TMP(""GMRCR"",$J,""ED"")","",.GMRCLNO,"",FLG) Q
"RTN","GMRCEDT1",127,0)
 ..S LN=0 F  S LN=$O(^GMR(123,+GMRCO,40,GMRCDD,1,LN)) Q:LN=""!(LN?1A.E)  S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^(LN,0),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",128,0)
 ..Q
"RTN","GMRCEDT1",129,0)
 .Q
"RTN","GMRCEDT1",130,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=""
"RTN","GMRCEDT1",131,0)
 K FLG
"RTN","GMRCEDT1",132,0)
 Q
"RTN","GMRCEDT1",133,0)
RVRS(LINE,EDITED) ;reverse video for fields that can be edited
"RTN","GMRCEDT1",134,0)
 I '$G(EDITED) D CNTRL^VALM10(LINE,1,1,IORVON,IORVOFF) Q
"RTN","GMRCEDT1",135,0)
 D CNTRL^VALM10(LINE,1,1,IORVON_IOINHI,IORVOFF_IOINORM)
"RTN","GMRCEDT1",136,0)
 Q
"RTN","GMRCEDT2")
0^4^B16802448^B17559466
"RTN","GMRCEDT2",1,0)
GMRCEDT2 ;SLC/JFR,DCM - RESUBMIT A CANCELLED CONSULT ;10/09/15  13:08
"RTN","GMRCEDT2",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,15,22,33,66,46,73,85**;DEC 27, 1997;Build 3
"RTN","GMRCEDT2",3,0)
 ;
"RTN","GMRCEDT2",4,0)
 ;ICRs in use: #2053 (DIE), #2056 (GET1^DIQ), #872 (ORD(101))
"RTN","GMRCEDT2",5,0)
 ;patch 85 removed call to $$PDOK^GMRCEDT4
"RTN","GMRCEDT2",6,0)
 ;
"RTN","GMRCEDT2",7,0)
EN(GMRCO,COMNO) ;entry point into the routine
"RTN","GMRCEDT2",8,0)
 ;COMNO=CMDA from ^GMRCEDT2=comments array IEN from ^GMR(123,IEN,40,
"RTN","GMRCEDT2",9,0)
 ;GMRCO=IEN of the consult from file 123
"RTN","GMRCEDT2",10,0)
 I $S($P(^GMR(123,GMRCO,0),"^",12)'=13:1,$D(GMRCRSUB):1,1:0) D  Q
"RTN","GMRCEDT2",11,0)
 .S GMRCMSG="***     Consult Has Already Been Resubmitted   ***"
"RTN","GMRCEDT2",12,0)
 .S GMRCMSG(1)="***  No Further Action Is Required Or Allowed ***"
"RTN","GMRCEDT2",13,0)
 .D EXAC^GMRCADC(.GMRCMSG)
"RTN","GMRCEDT2",14,0)
 .S:'$D(GMRCRSUB) GMRCRSUB=1
"RTN","GMRCEDT2",15,0)
 .Q
"RTN","GMRCEDT2",16,0)
 N MSG S MSG=$$EDRESOK(GMRCO)
"RTN","GMRCEDT2",17,0)
 I '+MSG D EXAC^GMRCADC($P(MSG,U,2)) Q
"RTN","GMRCEDT2",18,0)
 I '$D(GMRCGUIF) W !,"Resubmitting Consult ... One moment please ..."
"RTN","GMRCEDT2",19,0)
 K ^TMP("GMRCSUB",$J) S ^TMP("GMRCSUB",$J)=0
"RTN","GMRCEDT2",20,0)
 I $D(GMRCEDT(1)) S ^TMP("GMRCSUB",$J,1)="GMRCSS^"_+GMRCEDT(1)
"RTN","GMRCEDT2",21,0)
 I $D(GMRCED(1)) D
"RTN","GMRCEDT2",22,0)
 . I $P(GMRCED(1),U)=$P(^GMR(123,+GMRCO,0),U,8) K GMRCED(1) Q
"RTN","GMRCEDT2",23,0)
 . S ^TMP("GMRCSUB",$J,2)="GMRCPROC^"_+GMRCED(1)_";GMR(123.3,"
"RTN","GMRCEDT2",24,0)
 I $D(GMRCED(2)) D
"RTN","GMRCEDT2",25,0)
 . I $P(GMRCED(2),U)=$P(^GMR(123,+GMRCO,0),U,18) K GMRCED(2) Q
"RTN","GMRCEDT2",26,0)
 . S ^TMP("GMRCSUB",$J,3)="GMRCION^"_$P(GMRCED(2),U)
"RTN","GMRCEDT2",27,0)
 I $D(GMRCED(3)) D
"RTN","GMRCEDT2",28,0)
 . I $P(GMRCED(3),U)=$P(^GMR(123,+GMRCO,0),U,9) K GMRCED(3) Q
"RTN","GMRCEDT2",29,0)
 . S ^TMP("GMRCSUB",$J,4)="GMRCURG^"_$P(GMRCED(3),U)
"RTN","GMRCEDT2",30,0)
 I $D(GMRCED(4)) D
"RTN","GMRCEDT2",31,0)
 . I $P(GMRCED(4),U)=$P(^GMR(123,+GMRCO,0),U,10) K GMRCED(4) Q
"RTN","GMRCEDT2",32,0)
 . S ^TMP("GMRCSUB",$J,5)="GMRCPL^"_$P(GMRCED(4),U)
"RTN","GMRCEDT2",33,0)
 I $D(GMRCED(5)) D  ;wat/66 add early date
"RTN","GMRCEDT2",34,0)
 . I $P(GMRCED(5),U)=$P(^GMR(123,+GMRCO,0),U,24) K GMRCED(5) Q
"RTN","GMRCEDT2",35,0)
 . S ^TMP("GMRCSUB",$J,6)="GMRCERDT^"_$P(GMRCED(5),U)
"RTN","GMRCEDT2",36,0)
 I $D(GMRCED(6)) D
"RTN","GMRCEDT2",37,0)
 . I $P(GMRCED(6),U)=$P(^GMR(123,+GMRCO,0),U,11) K GMRCED(6) Q
"RTN","GMRCEDT2",38,0)
 . I '$L($P(GMRCED(6),U)) S $P(GMRCED(6),U)="@"
"RTN","GMRCEDT2",39,0)
 . S ^TMP("GMRCSUB",$J,7)="GMRCATN^"_$P(GMRCED(6),U)
"RTN","GMRCEDT2",40,0)
 I $D(GMRCED(7)) D
"RTN","GMRCEDT2",41,0)
 . I GMRCED(7)=$G(^GMR(123,+GMRCO,30)) K GMRCED(7) Q
"RTN","GMRCEDT2",42,0)
 . I $P(GMRCED(7),U)_" ("_$P(GMRCED(7),U,2)_")"=$G(^GMR(123,GMRCO,30)) K GMRCED(7) Q
"RTN","GMRCEDT2",43,0)
 . I '$L($P(GMRCED(7),U)) S $P(GMRCED(7),U,1,2)="@"
"RTN","GMRCEDT2",44,0)
 . S ^TMP("GMRCSUB",$J,8)="GMRCDIAG^"_GMRCED(7)
"RTN","GMRCEDT2",45,0)
 I $D(^TMP("GMRCED",$J,20)) S ^TMP("GMRCSUB",$J,20)="GMRCRFQ^" D
"RTN","GMRCEDT2",46,0)
 . N ND S ND=0
"RTN","GMRCEDT2",47,0)
 . F  S ND=$O(^TMP("GMRCED",$J,20,ND)) Q:'ND  D
"RTN","GMRCEDT2",48,0)
 .. S ^TMP("GMRCSUB",$J,20,ND)=^TMP("GMRCED",$J,20,ND,0)
"RTN","GMRCEDT2",49,0)
 I $D(^TMP("GMRCED",$J,40)) S ^TMP("GMRCSUB",$J,40)="COMMENT^" D
"RTN","GMRCEDT2",50,0)
 . N ND S ND=0
"RTN","GMRCEDT2",51,0)
 . F  S ND=$O(^TMP("GMRCED",$J,40,ND)) Q:'ND  D
"RTN","GMRCEDT2",52,0)
 .. S ^TMP("GMRCSUB",$J,40,ND)=^TMP("GMRCED",$J,40,ND,0)
"RTN","GMRCEDT2",53,0)
 D FILE^GMRCGUIC(+GMRCO,$NAME(^TMP("GMRCSUB",$J)),1)
"RTN","GMRCEDT2",54,0)
 N GMRCADUZ S GMRCADUZ=""
"RTN","GMRCEDT2",55,0)
 S DFN=$P(^GMR(123,+GMRCO,0),"^",2),GMRCPROV=$P(^(0),"^",14)
"RTN","GMRCEDT2",56,0)
 S GMRCTYPE=$P(^GMR(123,+GMRCO,0),U,17),GMRCTRLC="XX",VISIT="",RMBED=""
"RTN","GMRCEDT2",57,0)
 S DIE="^GMR(123,",DA=+GMRCO,DR="8////^S X=5;9////^S X=11" D ^DIE
"RTN","GMRCEDT2",58,0)
 K DIE,DA,DR
"RTN","GMRCEDT2",59,0)
 S GMRCRSUB=1
"RTN","GMRCEDT2",60,0)
 S GMRCURG=$P(^GMR(123,+GMRCO,0),"^",9)
"RTN","GMRCEDT2",61,0)
 I +$P(^GMR(123,+GMRCO,0),"^",11) S GMRCADUZ($P(^(0),"^",11))=""
"RTN","GMRCEDT2",62,0)
 S GMRCSVC=$P(^GMR(123,+GMRCO,0),"^",5)
"RTN","GMRCEDT2",63,0)
 I +GMRCSVC D
"RTN","GMRCEDT2",64,0)
 . D EN^GMRCT(GMRCSVC)
"RTN","GMRCEDT2",65,0)
 S GMRCORTX="Resubmitted consult "_$$ORTX^GMRCAU(+GMRCO)_$S(+GMRCURG:" ("_$P(^ORD(101,+GMRCURG,0),"^",2)_")",1:"")
"RTN","GMRCEDT2",66,0)
 K GMRCFL,GMRCPROV,GMRCTYPE,GMRCTRLC,VISIT,RMBED,GMRCOM,GMRCURG
"RTN","GMRCEDT2",67,0)
 K GMRCSVC,GMRCORTX
"RTN","GMRCEDT2",68,0)
 Q
"RTN","GMRCEDT2",69,0)
EDRESOK(GMRCDA) ;check cslt or proc to see if still resubmittable
"RTN","GMRCEDT2",70,0)
 ; if procedure is inactive or no services, not resubmittable
"RTN","GMRCEDT2",71,0)
 ; if service is grouper or disabled, not resubmittable
"RTN","GMRCEDT2",72,0)
 N MSG,GMRC
"RTN","GMRCEDT2",73,0)
 Q:'$D(^GMR(123,+$G(GMRCDA),0)) "0^Invalid Consult Number"
"RTN","GMRCEDT2",74,0)
 I $P($G(^GMR(123,+GMRCDA,12)),U,5)="F" D  Q MSG
"RTN","GMRCEDT2",75,0)
 . S MSG="0^This inter-facility cconsult may only be resubmitted by the"
"RTN","GMRCEDT2",76,0)
 . S MSG=MSG_" ordering facility."
"RTN","GMRCEDT2",77,0)
 S GMRC(0)=^GMR(123,+GMRCDA,0)
"RTN","GMRCEDT2",78,0)
 I '$P(GMRC(0),U,8) D  Q MSG
"RTN","GMRCEDT2",79,0)
 . I "19"[+$P(^GMR(123.5,+$P(GMRC(0),U,5),0),U,2) D  Q
"RTN","GMRCEDT2",80,0)
 .. S MSG="0^The service for this Consult is no longer orderable."
"RTN","GMRCEDT2",81,0)
 . S MSG=1
"RTN","GMRCEDT2",82,0)
 S MSG=1
"RTN","GMRCEDT2",83,0)
 I "19"[+$P(^GMR(123.5,+$P(GMRC(0),U,5),0),U,2) S MSG=0
"RTN","GMRCEDT2",84,0)
 I '$L($$GET1^DIQ(123.3,+$P(GMRC(0),U,8),.01)) S MSG=0
"RTN","GMRCEDT2",85,0)
 I +$$GET1^DIQ(123.3,+$P(GMRC(0),U,8),.02) S MSG=0
"RTN","GMRCEDT2",86,0)
 I '$D(^GMR(123.3,+$P(GMRC(0),U,8),2,"B",+$P(GMRC(0),U,5))) S MSG=0
"RTN","GMRCEDT2",87,0)
 I MSG=0 D
"RTN","GMRCEDT2",88,0)
 . S MSG=MSG_"^This procedure may no longer be ordered or the service "
"RTN","GMRCEDT2",89,0)
 . S MSG=MSG_"may no longer perform it."
"RTN","GMRCEDT2",90,0)
 Q MSG
"RTN","GMRCEDT4")
0^5^B85518879^B85583529
"RTN","GMRCEDT4",1,0)
GMRCEDT4 ;SLC/DCM,JFR - UTILITIES FOR EDITING FIELDS ;10/13/15  07:31
"RTN","GMRCEDT4",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,15,22,33,66,73,85**;DEC 27, 1997;Build 3
"RTN","GMRCEDT4",3,0)
 ;
"RTN","GMRCEDT4",4,0)
 ; This routine invokes IA #5747 (ICDEX), #872 (ORD(101)), #10142 (DDIOL), #10006 (DIC)
"RTN","GMRCEDT4",5,0)
 ;                         #2051 (FIND1^DIC), #2056 (GET1^DIQ), #10026 (DIR), #10028 (DIWE), #5679 (LEXU)
"RTN","GMRCEDT4",6,0)
 ;                         #1572 (LEX(757.01), #1609 (CONFIG^LEXSET), #10103 (XLFDT), #10104 (XLFSTR), #10140 (XQORM)
"RTN","GMRCEDT4",7,0)
 ;
"RTN","GMRCEDT4",8,0)
 Q
"RTN","GMRCEDT4",9,0)
EDITFLD(GMRCO)    ;edit field in file 123.
"RTN","GMRCEDT4",10,0)
 ;GMRCO=IEN of consult record in file 123
"RTN","GMRCEDT4",11,0)
 N DIR,X,Y,GMRCSS,GMRCPROC,GMRCPROC,GMRCURG,GMRCPL,GMRCREND,GMRCY,GMRCX
"RTN","GMRCEDT4",12,0)
 N GMRCMSG,GMRCTAG
"RTN","GMRCEDT4",13,0)
 I $S($P(^GMR(123,GMRCO,0),"^",12)'=13:1,$D(GMRCRSUB):1,1:0) D  Q
"RTN","GMRCEDT4",14,0)
 .S GMRCMSG="This consult is no longer editable." D EXAC^GMRCADC(GMRCMSG)
"RTN","GMRCEDT4",15,0)
 S GMRCMSG=$$EDRESOK^GMRCEDT2(GMRCO)
"RTN","GMRCEDT4",16,0)
 I '+GMRCMSG D EXAC^GMRCADC($P(GMRCMSG,U,2)) Q
"RTN","GMRCEDT4",17,0)
 ;patch 85 removed call to $$PDOK(GMRCO)
"RTN","GMRCEDT4",18,0)
 S DIR(0)="LAO^1:9",DIR("A")="Select the fields to edit: "
"RTN","GMRCEDT4",19,0)
 D ^DIR I $D(DIRUT) Q
"RTN","GMRCEDT4",20,0)
 I $P(Y,",")<1 Q
"RTN","GMRCEDT4",21,0)
 S GMRCY=Y
"RTN","GMRCEDT4",22,0)
 F GMRCX=1:1:9 S GMRCTAG=$P(GMRCY,",",GMRCX) Q:'GMRCTAG  D
"RTN","GMRCEDT4",23,0)
 . D SETUP
"RTN","GMRCEDT4",24,0)
 . D @GMRCTAG
"RTN","GMRCEDT4",25,0)
 . K DIROUT,DIRUT,DTOUT,DUOUT
"RTN","GMRCEDT4",26,0)
 . D EN^GMRCEDT1(+GMRCO),INIT^GMRCEDIT
"RTN","GMRCEDT4",27,0)
 Q
"RTN","GMRCEDT4",28,0)
SETUP   ;get info needed for edit (save global reads)
"RTN","GMRCEDT4",29,0)
 S:$D(GMRCEDT(1)) GMRCSS=GMRCEDT(1)
"RTN","GMRCEDT4",30,0)
 I '$D(GMRCSS) S GMRCSS=$P(^GMR(123,+GMRCO,0),U,5),GMRCSS=GMRCSS_U_$P(^GMR(123.5,GMRCSS,0),U)
"RTN","GMRCEDT4",31,0)
 S:$D(GMRCED(1)) GMRCPROC=GMRCED(1)
"RTN","GMRCEDT4",32,0)
 I '$D(GMRCPROC) S GMRCPROC=+$P(^GMR(123,+GMRCO,0),U,8),GMRCPROC=GMRCPROC_U_$$GET1^DIQ(123.3,+GMRCPROC,.01)
"RTN","GMRCEDT4",33,0)
 S:$D(GMRCED(2)) GMRCREND=GMRCED(2)
"RTN","GMRCEDT4",34,0)
 I '$D(GMRCREND) S GMRCREND=$P(^GMR(123,GMRCO,0),U,18),GMRCREND=GMRCREND_U_$S(GMRCREND="I":"In",1:"Out")_"patient"
"RTN","GMRCEDT4",35,0)
 S:$D(GMRCED(3)) GMRCURG=GMRCED(3)
"RTN","GMRCEDT4",36,0)
 I '$D(GMRCURG) S GMRCURG=$P(^GMR(123,+GMRCO,0),U,9),GMRCURG=GMRCURG_U_$$GET1^DIQ(101,+GMRCURG,1)
"RTN","GMRCEDT4",37,0)
 S:$D(GMRCED(4)) GMRCPL=GMRCED(4)
"RTN","GMRCEDT4",38,0)
 I '$D(GMRCPL) S GMRCPL=$P(^GMR(123,+GMRCO,0),U,10),GMRCPL=GMRCPL_U_$$GET1^DIQ(101,+GMRCPL,1)
"RTN","GMRCEDT4",39,0)
 Q
"RTN","GMRCEDT4",40,0)
01       ;edit TO SERVICE
"RTN","GMRCEDT4",41,0)
 N I,PROCSERV,DIR,X,Y
"RTN","GMRCEDT4",42,0)
 I $G(GMRCPROC) D  Q:'PROCSERV
"RTN","GMRCEDT4",43,0)
 . N I S I=0,PROCSERV=0 F  S I=$O(^GMR(123.3,+GMRCPROC,2,"B",I)) Q:'I  D
"RTN","GMRCEDT4",44,0)
 .. S PROCSERV(I)="",PROCSERV=PROCSERV+1
"RTN","GMRCEDT4",45,0)
 . I PROCSERV=1 W !,"Only one SERVICE can perform this procedure.",!
"RTN","GMRCEDT4",46,0)
 S DIR(0)="PA^123.5:EMQ"
"RTN","GMRCEDT4",47,0)
 I $G(PROCSERV) D
"RTN","GMRCEDT4",48,0)
 . I $D(PROCSERV(+GMRCSS)) Q
"RTN","GMRCEDT4",49,0)
 . S DIR("B")=$$GET1^DIQ(123.5,$O(PROCSERV(0)),.01)
"RTN","GMRCEDT4",50,0)
 I '$D(DIR("B")) S DIR("B")=$P(GMRCSS,U,2)
"RTN","GMRCEDT4",51,0)
 S DIR("A")="Select the Service to perform this request: "
"RTN","GMRCEDT4",52,0)
 S DIR("S")="I $P(^(0),U,2)<1" ;naked reference for ^GMR(123.5
"RTN","GMRCEDT4",53,0)
 I +$G(GMRCPROC) S DIR("S")=DIR("S")_",$D(PROCSERV(+Y))"
"RTN","GMRCEDT4",54,0)
 S DIR("??")="^D LISTALL^GMRCASV"
"RTN","GMRCEDT4",55,0)
 D ^DIR I $D(DUOUT)!($D(DTOUT)) Q
"RTN","GMRCEDT4",56,0)
 I Y<1!(+Y=+GMRCSS) W !,$$NOCHG,! Q
"RTN","GMRCEDT4",57,0)
 S GMRCEDT(1)=Y,GMRCSS=Y
"RTN","GMRCEDT4",58,0)
 Q
"RTN","GMRCEDT4",59,0)
1 ;edit Procedure
"RTN","GMRCEDT4",60,0)
 W !,$C(7),"The procedure associated with a request may not be changed."
"RTN","GMRCEDT4",61,0)
 W !,"Place a new request if a different procedure is desired"
"RTN","GMRCEDT4",62,0)
 H 2
"RTN","GMRCEDT4",63,0)
 Q
"RTN","GMRCEDT4",64,0)
2       ;edit service rendered
"RTN","GMRCEDT4",65,0)
 N DIR,X,Y,GMRCURSV,GMRCPLSV,GMRCED4,GMRCED5,RENDED
"RTN","GMRCEDT4",66,0)
 S DIR(0)="S:A^I:Inpatient;O:Outpatient",DIR("B")=$P(GMRCREND,U,2)
"RTN","GMRCEDT4",67,0)
 S DIR("A")="Service to be performed Inpatient or Outpatient: "
"RTN","GMRCEDT4",68,0)
 D ^DIR I $D(DUOUT)!($D(DTOUT)) W !,$$NOCHG,! Q
"RTN","GMRCEDT4",69,0)
 I Y'=$P(GMRCREND,U) S RENDED=Y_U_Y(0)
"RTN","GMRCEDT4",70,0)
 I '$D(RENDED) Q
"RTN","GMRCEDT4",71,0)
 I '$$VALIDUR(GMRCURG,RENDED,+$G(GMRCPROC)) D  I '$D(RENDED) Q
"RTN","GMRCEDT4",72,0)
 . N GMRCREND,CHGIO S GMRCREND=RENDED
"RTN","GMRCEDT4",73,0)
 . W $C(7),!!,"The urgency of this request is no longer valid.",!
"RTN","GMRCEDT4",74,0)
 . S GMRCURSV=GMRCURG S:$D(GMRCED(3)) GMRCED3=GMRCED(3)
"RTN","GMRCEDT4",75,0)
 . S CHGREND="" D 3
"RTN","GMRCEDT4",76,0)
 . I '$$VALIDUR(GMRCURG,RENDED,+$G(GMRCPROC)) D  Q
"RTN","GMRCEDT4",77,0)
 .. W !,$C(7),"Unable to change the way service is rendered.",!
"RTN","GMRCEDT4",78,0)
 .. K RENDED S GMRCURG=GMRCURSV S:$D(GMRCED3) GMRCED(3)=GMRCED3
"RTN","GMRCEDT4",79,0)
 I '$$VALIDPL(GMRCPL,RENDED) D  I '$D(RENDED) Q
"RTN","GMRCEDT4",80,0)
 . N GMRCREND,CHGREND S GMRCREND=RENDED
"RTN","GMRCEDT4",81,0)
 . W $C(7),!!,"The Place of Consultation is no longer valid.",!
"RTN","GMRCEDT4",82,0)
 . S GMRCPLSV=GMRCPL S:$D(GMRCED(4)) GMRCED4=GMRCED(4) S CHGREND="" D 4
"RTN","GMRCEDT4",83,0)
 . I '$$VALIDPL(GMRCPL,RENDED) D  Q
"RTN","GMRCEDT4",84,0)
 .. W !,$C(7),"Unable to change the way service is rendered.",!
"RTN","GMRCEDT4",85,0)
 .. K RENDED S GMRCPL=GMRCPLSV S:$D(GMRCED4) GMRCED(4)=GMRCED4
"RTN","GMRCEDT4",86,0)
 .. S:$D(GMRCURSV) GMRCURG=GMRCURSV
"RTN","GMRCEDT4",87,0)
 .. S:$D(GMRCED3) GMRCED(3)=GMRCED3
"RTN","GMRCEDT4",88,0)
 S (GMRCREND,GMRCED(2))=RENDED
"RTN","GMRCEDT4",89,0)
 Q
"RTN","GMRCEDT4",90,0)
3 ;edit urgency
"RTN","GMRCEDT4",91,0)
 N X,Y,XQORM
"RTN","GMRCEDT4",92,0)
 I $P(GMRCREND,U)="O" S Y=$$FIND1^DIC(101,"","QX","GMRCURGENCYM - OUTPATIENT")
"RTN","GMRCEDT4",93,0)
 I '$D(Y) D  ;inpatient
"RTN","GMRCEDT4",94,0)
 .I '$G(GMRCPROC) S Y=$$FIND1^DIC(101,"","QX","GMRCURGENCYM CSLT - INPATIENT") Q
"RTN","GMRCEDT4",95,0)
 .S Y=$$FIND1^DIC(101,"","QX","GMRCURGENCYM REQ - INPATIENT")
"RTN","GMRCEDT4",96,0)
 I 'Y W !,$C(7),"Unable to change urgency." Q
"RTN","GMRCEDT4",97,0)
 S XQORM=+Y_";ORD(101,",XQORM(0)="1A\",XQORM("A")="Urgency: "
"RTN","GMRCEDT4",98,0)
 S XQORM("^^NO")=0
"RTN","GMRCEDT4",99,0)
 S:'$D(CHGREND) XQORM("B")=$P($G(GMRCURG),U,2)
"RTN","GMRCEDT4",100,0)
 D EN^XQORM
"RTN","GMRCEDT4",101,0)
 Q:Y'>0
"RTN","GMRCEDT4",102,0)
 I $P(Y(1),U,2)'=+GMRCURG D
"RTN","GMRCEDT4",103,0)
 . S GMRCED(3)=$P(Y(1),U,2)_U_$P(Y(1),U,3),GMRCURG=GMRCED(3)
"RTN","GMRCEDT4",104,0)
 Q
"RTN","GMRCEDT4",105,0)
4 ;edit place of CSLT
"RTN","GMRCEDT4",106,0)
 N X,Y,XQORM
"RTN","GMRCEDT4",107,0)
 S Y=$$FIND1^DIC(101,,"QX","GMRCPLACEM - "_$$UP^XLFSTR($P(GMRCREND,U,2))) Q:'Y
"RTN","GMRCEDT4",108,0)
 S XQORM=Y_";ORD(101,"
"RTN","GMRCEDT4",109,0)
 S XQORM(0)="1AR\",XQORM("A")="Place of Consultation: ",XQORM("NO^^")=""
"RTN","GMRCEDT4",110,0)
 S:'$D(CHGREND) XQORM("B")=$P($G(GMRCPL),U,2)
"RTN","GMRCEDT4",111,0)
 D EN^XQORM
"RTN","GMRCEDT4",112,0)
 Q:Y'>0
"RTN","GMRCEDT4",113,0)
 I $P(Y(1),U,2)'=+GMRCPL D
"RTN","GMRCEDT4",114,0)
 . S GMRCED(4)=$P(Y(1),U,2)_U_$P(Y(1),U,3),GMRCPL=GMRCED(4)
"RTN","GMRCEDT4",115,0)
 Q
"RTN","GMRCEDT4",116,0)
5 ;edit Earliest Appr. Date wat/66
"RTN","GMRCEDT4",117,0)
 N X,Y,DIR
"RTN","GMRCEDT4",118,0)
 S DIR(0)="D^^K:Y<DT X",DIR("A")="Earliest Appropriate Date: " ;S DIR(0)="D^DT:GMRCFTDT:EX"
"RTN","GMRCEDT4",119,0)
 S DIR("?")="Enter a date greater than or equal to TODAY"
"RTN","GMRCEDT4",120,0)
 S DIR("B")=$$FMTE^XLFDT(DT)
"RTN","GMRCEDT4",121,0)
 D ^DIR I $D(DTOUT)!($D(DUOUT)) Q
"RTN","GMRCEDT4",122,0)
 S GMRCED(5)=Y_U_Y(0)
"RTN","GMRCEDT4",123,0)
 Q
"RTN","GMRCEDT4",124,0)
6 ;edit ATTN person
"RTN","GMRCEDT4",125,0)
 N X,Y,DIR
"RTN","GMRCEDT4",126,0)
 S DIR(0)="PAO^200:EQM",DIR("A")="Select ATTENTION person: "
"RTN","GMRCEDT4",127,0)
 S DIR("B")=$$GET1^DIQ(200,+$P(^GMR(123,+GMRCO,0),U,11),.01)
"RTN","GMRCEDT4",128,0)
 S:$D(GMRCED(6)) DIR("B")=$P($G(GMRCED(6)),U,2)
"RTN","GMRCEDT4",129,0)
 K:'$L(DIR("B")) DIR("B")
"RTN","GMRCEDT4",130,0)
 D ^DIR I $D(DTOUT)!($D(DUOUT)) Q
"RTN","GMRCEDT4",131,0)
 I $G(DIR("B"))=$P(Y,U,2) Q
"RTN","GMRCEDT4",132,0)
 S GMRCED(6)=$S(Y=-1:"",1:Y)
"RTN","GMRCEDT4",133,0)
 I GMRCED(6)="" W !,?5,"<DELETED>",!
"RTN","GMRCEDT4",134,0)
 Q
"RTN","GMRCEDT4",135,0)
7 ;edit prov. DX
"RTN","GMRCEDT4",136,0)
 N X,Y,DIC,DIR,PRMPT
"RTN","GMRCEDT4",137,0)
 S PRMPT=$$PROVDX^GMRCUTL1(+$P(^GMR(123,+GMRCO,0),U,5))
"RTN","GMRCEDT4",138,0)
 I $P(PRMPT,U,2)="F" D
"RTN","GMRCEDT4",139,0)
 . S DIR(0)="FA^2:245",DIR("A")="Provisional Diagnosis: "
"RTN","GMRCEDT4",140,0)
 . I $P(PRMPT,U)'="R" S $P(DIR(0),U)="FAO"
"RTN","GMRCEDT4",141,0)
 . S:$D(GMRCED(7)) DIR("B")=$P(GMRCED(7),U)
"RTN","GMRCEDT4",142,0)
 . I '$D(DIR("B")) S DIR("B")=$G(^GMR(123,+GMRCO,30))
"RTN","GMRCEDT4",143,0)
 . K:'$L(DIR("B")) DIR("B")
"RTN","GMRCEDT4",144,0)
 . D ^DIR Q:$D(DTOUT)!($D(DUOUT))  Q:Y=$G(DIR("B"))
"RTN","GMRCEDT4",145,0)
 . I '$L(Y) W !,?5,"<DELETED>",!
"RTN","GMRCEDT4",146,0)
 . S GMRCED(7)=Y
"RTN","GMRCEDT4",147,0)
 I $P(PRMPT,U,2)="L" D
"RTN","GMRCEDT4",148,0)
 . N DIR,X,Y,DTOUT,DUOUT,VAL
"RTN","GMRCEDT4",149,0)
 . I $D(GMRCED(7)) D
"RTN","GMRCEDT4",150,0)
 .. I '$L($P(GMRCED(7),U,2)) S DIR("B")=$P(GMRCED(7),U) Q
"RTN","GMRCEDT4",151,0)
 .. S DIR("B")=$P(GMRCED(7),U)_" ("_$P(GMRCED(7),U,2)_")"
"RTN","GMRCEDT4",152,0)
 . I '$D(DIR("B")) S DIR("B")=$G(^GMR(123,GMRCO,30))
"RTN","GMRCEDT4",153,0)
 . K:'$L(DIR("B")) DIR("B")
"RTN","GMRCEDT4",154,0)
 . S DIR("?")="Enter a code or term for the provisional diagnosis."
"RTN","GMRCEDT4",155,0)
 . S DIR("A")="Provisional Diagnosis: "
"RTN","GMRCEDT4",156,0)
 . S DIR(0)="FA"_$S($P(PRMPT,U)'="R":"O",1:"")_"^1:245"
"RTN","GMRCEDT4",157,0)
 . D ^DIR
"RTN","GMRCEDT4",158,0)
 . I $D(DTOUT)!($D(DUOUT)) Q
"RTN","GMRCEDT4",159,0)
 . I '$L(Y) W !,?5,"<DELETED>",! S GMRCED(7)="" Q
"RTN","GMRCEDT4",160,0)
 . I Y=$G(DIR("B")) Q
"RTN","GMRCEDT4",161,0)
 . I $E(Y,1)=" " W !,"Leading space not allowed, no change." Q
"RTN","GMRCEDT4",162,0)
 . S VAL=$$LEXLKUP(Y)
"RTN","GMRCEDT4",163,0)
 . I '$L(VAL),$P(PRMPT,U)="R" W !,"Prov. DX required. No change." Q
"RTN","GMRCEDT4",164,0)
 . I VAL=$G(^GMR(123,GMRCO,30)) W !,"No change." Q
"RTN","GMRCEDT4",165,0)
 . I ($P(VAL,U)_" ("_$P(VAL,U,2)_")")=$G(^GMR(123,GMRCO,30)) D  Q
"RTN","GMRCEDT4",166,0)
 .. W !,"No change."
"RTN","GMRCEDT4",167,0)
 . I '$L(VAL) W !,?5,"<DELETED>",!
"RTN","GMRCEDT4",168,0)
 . S GMRCED(7)=VAL
"RTN","GMRCEDT4",169,0)
 Q
"RTN","GMRCEDT4",170,0)
 ;
"RTN","GMRCEDT4",171,0)
LEXLKUP(GMRCX)  ; run input through the Lexicon
"RTN","GMRCEDT4",172,0)
 ;
"RTN","GMRCEDT4",173,0)
 N DIC,X,Y,DUOUT,DTOUT,GMRCSYS
"RTN","GMRCEDT4",174,0)
 S GMRCSYS="ICD" I DT>=$$IMPDATE^LEXU("10D") S GMRCSYS="10D"
"RTN","GMRCEDT4",175,0)
 D CONFIG^LEXSET(GMRCSYS,GMRCSYS,DT)
"RTN","GMRCEDT4",176,0)
 S DIC="^LEX(757.01,",DIC(0)="EQM",DIC("B")=GMRCX,X=GMRCX
"RTN","GMRCEDT4",177,0)
 D ^DIC
"RTN","GMRCEDT4",178,0)
 I $D(DTOUT)!($D(DUOUT))!($G(Y)<1) Q ""
"RTN","GMRCEDT4",179,0)
 Q $P(Y,U,2)_U_$S(GMRCSYS="ICD":$G(Y(1)),1:$G(Y(30)))
"RTN","GMRCEDT4",180,0)
 ;
"RTN","GMRCEDT4",181,0)
8 ;edit Reason for Request
"RTN","GMRCEDT4",182,0)
 N DIC,DIWESUB,DWLW,DWPK
"RTN","GMRCEDT4",183,0)
 I $D(^TMP("GMRCED",$J,20)) M ^TMP("GMRCEDSV",$J,20)=^TMP("GMRCED",$J,20)
"RTN","GMRCEDT4",184,0)
 I '$D(^TMP("GMRCED",$J,20)) M ^TMP("GMRCED",$J,20)=^GMR(123,+GMRCO,20)
"RTN","GMRCEDT4",185,0)
 S DIC="^TMP(""GMRCED"",$J,20,",DIWESUB="Reason for Request"
"RTN","GMRCEDT4",186,0)
 W !,"Editing Reason for Request:",!
"RTN","GMRCEDT4",187,0)
 S DWPK=1,DWLW=74 D EN^DIWE
"RTN","GMRCEDT4",188,0)
 I '$$DIFFRFR($D(^TMP("GMRCEDSV",$J,20))) D  Q
"RTN","GMRCEDT4",189,0)
 . I $D(^TMP("GMRCEDSV",$J,20)) K ^TMP("GMRCEDSV",$J,20) Q
"RTN","GMRCEDT4",190,0)
 . K ^TMP("GMRCED",$J,20)
"RTN","GMRCEDT4",191,0)
 K ^TMP("GMRCEDSV",$J,20)
"RTN","GMRCEDT4",192,0)
 I '$D(^TMP("GMRCED",$J,20))!('$O(^TMP("GMRCED",$J,20,0))) D
"RTN","GMRCEDT4",193,0)
 . N GMRCMSG
"RTN","GMRCEDT4",194,0)
 . S GMRCMSG="Unable to delete Reason for Request (REQUIRED)"
"RTN","GMRCEDT4",195,0)
 . D EXAC^GMRCADC(GMRCMSG)
"RTN","GMRCEDT4",196,0)
 . K ^TMP("GMRCED",$J,20)
"RTN","GMRCEDT4",197,0)
 Q
"RTN","GMRCEDT4",198,0)
9 ;add comment
"RTN","GMRCEDT4",199,0)
 N DIC,DIWEPSE,DIWESUB,DWLW,DWPK
"RTN","GMRCEDT4",200,0)
 I $D(^TMP("GMRCED",$J,40)) D
"RTN","GMRCEDT4",201,0)
 . W !,"An unsaved comment exists. You may edit this comment.",!
"RTN","GMRCEDT4",202,0)
 . S DIWEPSE=1
"RTN","GMRCEDT4",203,0)
 S DIC="^TMP(""GMRCED"",$J,40,",DIWESUB="New Comment"
"RTN","GMRCEDT4",204,0)
 W !,"Adding new comment:",!
"RTN","GMRCEDT4",205,0)
 S DWPK=1,DWLW=74 D EN^DIWE
"RTN","GMRCEDT4",206,0)
 I '$O(^TMP("GMRCED",$J,40,0)) K ^TMP("GMRCED",$J,40)
"RTN","GMRCEDT4",207,0)
 Q
"RTN","GMRCEDT4",208,0)
DIFFRFR(SAVED) ;edited reason for req same as original?
"RTN","GMRCEDT4",209,0)
 N I,DIFF
"RTN","GMRCEDT4",210,0)
 I SAVED,$P($G(^TMP("GMRCED",$J,20,0)),U,3,4)'=$P($G(^TMP("GMRCEDSV",$J,20,0)),U,3,4) S DIFF=1 Q 1
"RTN","GMRCEDT4",211,0)
 I 'SAVED,$P($G(^TMP("GMRCED",$J,20,0)),U,3,4)'=$P($G(^GMR(123,+GMRCO,20,0)),U,3,4) S DIFF=1 Q 1
"RTN","GMRCEDT4",212,0)
 I SAVED S I=0 F  S I=$O(^TMP("GMRCED",$J,20,I)) Q:'I!($D(DIFF))  D
"RTN","GMRCEDT4",213,0)
 . I ^TMP("GMRCED",$J,20,I,0)=$G(^TMP("GMRCEDSV",$J,20,I,0)) Q
"RTN","GMRCEDT4",214,0)
 . S DIFF=1
"RTN","GMRCEDT4",215,0)
 . Q
"RTN","GMRCEDT4",216,0)
 I 'SAVED S I=0 F  S I=$O(^TMP("GMRCED",$J,20,I)) Q:'I!($D(DIFF))  D
"RTN","GMRCEDT4",217,0)
 . I ^TMP("GMRCED",$J,20,I,0)'=$G(^GMR(123,+GMRCO,20,I,0)) S DIFF=1
"RTN","GMRCEDT4",218,0)
 . Q
"RTN","GMRCEDT4",219,0)
 Q $G(DIFF)
"RTN","GMRCEDT4",220,0)
VALIDPL(PL,REND) ; place still valid?
"RTN","GMRCEDT4",221,0)
 N PLMENU
"RTN","GMRCEDT4",222,0)
 S PLMENU=$S($P(REND,U)="I":"IN",1:"OUT")
"RTN","GMRCEDT4",223,0)
 S PLMENU="GMRCPLACEM - "_PLMENU_"PATIENT"
"RTN","GMRCEDT4",224,0)
 S PLMENU=$$FIND1^DIC(101,,"QX",PLMENU) Q:PLMENU'>1 0
"RTN","GMRCEDT4",225,0)
 Q $D(^ORD(101,PLMENU,10,"B",+PL))
"RTN","GMRCEDT4",226,0)
VALIDUR(URG,REND,PROC) ;urgency still valid?
"RTN","GMRCEDT4",227,0)
 N URMENU
"RTN","GMRCEDT4",228,0)
 I $P(REND,U)="I" D
"RTN","GMRCEDT4",229,0)
 .I 'PROC S URMENU="GMRCURGENCYM CSLT - INPATIENT" Q
"RTN","GMRCEDT4",230,0)
 .S URMENU="GMRCURGENCYM REQ - INPATIENT" Q
"RTN","GMRCEDT4",231,0)
 I '$D(URMENU) S URMENU="GMRCURGENCYM - OUTPATIENT"
"RTN","GMRCEDT4",232,0)
 S URMENU=$$FIND1^DIC(101,,"QX",URMENU) Q:URMENU<0 0
"RTN","GMRCEDT4",233,0)
 Q $D(^ORD(101,URMENU,10,"B",+URG))
"RTN","GMRCEDT4",234,0)
 Q
"RTN","GMRCEDT4",235,0)
NOCHG() ;no changes made
"RTN","GMRCEDT4",236,0)
 Q "No Changes made!"
"RTN","GMRCEDT4",237,0)
PDOK(GMRCDA) ;check validity of Prov. DX code for active status
"RTN","GMRCEDT4",238,0)
 ;WAT - as of patch 85 this code no longer called. Leaving here in case biz needs change.
"RTN","GMRCEDT4",239,0)
 N MSG,GMRCCPTR,GMRCCSYS,GMRCCODE
"RTN","GMRCEDT4",240,0)
 I '$L($G(^GMR(123,GMRCDA,30.1))) Q 1
"RTN","GMRCEDT4",241,0)
 S GMRCCODE=$P($G(^GMR(123,+GMRCO,30.1)),"^",1)
"RTN","GMRCEDT4",242,0)
 S GMRCCSYS=$P($G(^GMR(123,+GMRCO,30.1)),"^",3)
"RTN","GMRCEDT4",243,0)
 S GMRCCPTR=$S(GMRCCSYS="ICD":1,1:30)
"RTN","GMRCEDT4",244,0)
 I +$$STATCHK^ICDEX(GMRCCODE,DT,GMRCCPTR) Q 1 ;code still active
"RTN","GMRCEDT4",245,0)
 S MSG="The provisional DX code must be edited before this request"
"RTN","GMRCEDT4",246,0)
 S MSG=MSG_" may be resubmitted."
"RTN","GMRCEDT4",247,0)
 D EN^DDIOL(MSG,,"!!")
"RTN","GMRCEDT4",248,0)
 Q 0
"RTN","GMRCGUIC")
0^1^B68517845^B69004877
"RTN","GMRCGUIC",1,0)
GMRCGUIC ;SLC/DCM,JFR - GUI actions for editing consults; 3/13/03 12:21 ;10/09/15  13:03
"RTN","GMRCGUIC",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,12,20,15,22,33,66,73,85**;DEC 27, 1997;Build 3
"RTN","GMRCGUIC",3,0)
 ;
"RTN","GMRCGUIC",4,0)
 ; This routine invokes IA #2698 (ORD(101.42)), #872(ORD(101)), #2713 (ORB3F1), #2051 (FIND1^DIC)
"RTN","GMRCGUIC",5,0)
 ;                         #2053 (DIE), #2056 (GET1^DIQ), #2690 (ORB3FUP1), #5679 (LEXU), #10103 (XLFDT), #10104 (XLFSTR), #5747 (ICDEX)
"RTN","GMRCGUIC",6,0)
 ;
"RTN","GMRCGUIC",7,0)
RFQ(GMRCO,MSG,ND,NOW) ;File Reason For Request field 20
"RTN","GMRCGUIC",8,0)
 N GMRCND,GMRCNT
"RTN","GMRCGUIC",9,0)
 S GMRCND=$O(^GMR(123,GMRCO,20,0)) I GMRCND="" S GMRCFLD(20)="Reason For Request: No Previous Value^20" Q
"RTN","GMRCGUIC",10,0)
 M ^TMP("GMRCFLD20",$J,20)=^GMR(123,GMRCO,20)
"RTN","GMRCGUIC",11,0)
 S GMRCFLD(20)=$NAME(^TMP("GMRCFLD20",$J,20))
"RTN","GMRCGUIC",12,0)
 K ^GMR(123,GMRCO,20)
"RTN","GMRCGUIC",13,0)
 S ^GMR(123,GMRCO,20,0)="^^^^"_DT_"^"
"RTN","GMRCGUIC",14,0)
 S GMRCND="",GMRCNT=1 F  S GMRCND=$O(@MSG@(ND,GMRCND)) Q:GMRCND=""  S ^GMR(123,GMRCO,20,GMRCNT,0)=@MSG@(ND,GMRCND),GMRCNT=GMRCNT+1
"RTN","GMRCGUIC",15,0)
 S $P(^GMR(123,GMRCO,20,0),"^",3)=GMRCNT-1,$P(^(0),"^",4)=GMRCNT-1
"RTN","GMRCGUIC",16,0)
 Q
"RTN","GMRCGUIC",17,0)
FILE(GMRCO,MSG,GMRCLM) ;File Edit changes
"RTN","GMRCGUIC",18,0)
 ;GMRCO=Record IEN,  GMRCCOM=Comment Array
"RTN","GMRCGUIC",19,0)
 ;MSG=^TMP global where the data resides, i.e., MSG="^TMP(""GMRCR"",$J)"
"RTN","GMRCGUIC",20,0)
 ;    Data is stored in subscripted nodes: ^TMP("GMRCR",$J,1)="GMRCSS^2"
"RTN","GMRCGUIC",21,0)
 ;    Word processing data is stored in second subscripted node:
"RTN","GMRCGUIC",22,0)
 ;    ^TMP("GMRCR",$J,9,1)="This is word processing data."
"RTN","GMRCGUIC",23,0)
 ;GMRCSS=To Service     GMRCPROC=procedure/Request Type
"RTN","GMRCGUIC",24,0)
 ;GMRCURG=Urgency       GMRCPL=Place Of Consultation
"RTN","GMRCGUIC",25,0)
 ;GMRCATN=Attention To  GMRCINO=Service is In/Out Patient
"RTN","GMRCGUIC",26,0)
 ;GMRCDIAG=Provisional Diagnosis  .GMRCRFQ=Reason For Request array
"RTN","GMRCGUIC",27,0)
 ;GMRCREQ=Procedure or Request; i.e., GMRCRQT=1727=^ORD(101,1727,0)='Procedure';GMRCRQT=1296=^ORD(101,1296,0)='Consult'
"RTN","GMRCGUIC",28,0)
 ;GMRCITM=Item ordered for field .1 (stored in ^GMR(123,GMRCO,1.11,
"RTN","GMRCGUIC",29,0)
 ;GMRCLM=coming from List Manager instead of the GUI
"RTN","GMRCGUIC",30,0)
 ;GMRCERDT=Earliest Appropriate Date WAT/66
"RTN","GMRCGUIC",31,0)
 ;GMRCCSYS=coding system for provsional dx GMRCDXDT=Date of provisional dx   GMRCLABL=label applied to dx code for display purposes e.g. "ICD-9-CM"
"RTN","GMRCGUIC",32,0)
 ;
"RTN","GMRCGUIC",33,0)
 I '$D(GMRCO)!('+GMRCO) Q
"RTN","GMRCGUIC",34,0)
 N GMRCSS,GMRCPROC,GMRCURG,GMRCPL,GMRCATN,GMRCRQT
"RTN","GMRCGUIC",35,0)
 N GMRCION,GMRCDIAG,GMRCDXCD,GMRCACTN,GMRCERDT,GMRCCSYS,GMRCDXDT,GMRCLABL,CODINTXT
"RTN","GMRCGUIC",36,0)
 S GMRCDT=$$NOW^XLFDT
"RTN","GMRCGUIC",37,0)
 S GMRCMSG="",GMRCNOD=0
"RTN","GMRCGUIC",38,0)
 F  S GMRCNOD=$O(@MSG@(GMRCNOD)) Q:GMRCNOD=""  S GMRCMSG=@MSG@(GMRCNOD) D
"RTN","GMRCGUIC",39,0)
 .I $P(GMRCMSG,"^",1)="COMMENT" D COMMENT^GMRCGUIU(GMRCO,MSG,GMRCNOD,$P(GMRCMSG,"^",2)) Q
"RTN","GMRCGUIC",40,0)
 .I $P(GMRCMSG,"^",1)="GMRCRFQ" D RFQ(GMRCO,MSG,GMRCNOD,GMRCDT) Q
"RTN","GMRCGUIC",41,0)
 .I $P(GMRCMSG,"^",1)="GMRCSS" S GMRCSS=$P(GMRCMSG,"^",2),GMRCFLD(1)=$P(^GMR(123.5,$P(^GMR(123,GMRCO,0),"^",5),0),"^",1)_"^1" Q
"RTN","GMRCGUIC",42,0)
 .I $P(GMRCMSG,"^",1)="GMRCITM" S GMRCITM=$P(GMRCMSG,"^",2),GMRCFLD(.1)=^GMR(123,GMRCO,1.11)_"^.1" Q
"RTN","GMRCGUIC",43,0)
 .I $P(GMRCMSG,"^",1)="GMRCPROC" Q  ;S GMRCFLD(4)=+$P(^GMR(123,+GMRCO,0),"^",8)_"^4" D  Q ;ignore procedure, can't be changed currently
"RTN","GMRCGUIC",44,0)
 .; ..S GMRCPROC=$P(GMRCMSG,"^",2) I $L($P(^GMR(123,GMRCO,0),"^",8)),$P(GMRCMSG,"^",2)="" S GMRCPROC="DELETE"
"RTN","GMRCGUIC",45,0)
 .I $P(GMRCMSG,"^",1)="GMRCURG" S GMRCURG=$P(GMRCMSG,"^",2),GMRCFLD(5)=$S(+$P(^GMR(123,+GMRCO,0),"^",9):$P(^ORD(101,+$P(^GMR(123,+GMRCO,0),"^",9),0),"^",2),1:"")_"^"_$P(^GMR(123,+GMRCO,0),"^",9) Q
"RTN","GMRCGUIC",46,0)
 .I $P(GMRCMSG,"^",1)="GMRCPL" D  Q
"RTN","GMRCGUIC",47,0)
 ..S GMRCPL=$P(GMRCMSG,"^",2) I '+GMRCPL D
"RTN","GMRCGUIC",48,0)
 ...S GMRCPL="GMRCPLACE - "_$S(GMRCPL="C":"ON CALL",GMRCPL="B":"BEDSIDE",GMRCPL="E":"EMERGENCY ROOM",1:GMRCPL),GMRCPL=$O(^ORD(101,"B",GMRCPL,0))
"RTN","GMRCGUIC",49,0)
 ..S GMRCFLD(6)=$S(+$P(^GMR(123,+GMRCO,0),"^",10):$P($P(^ORD(101,+$P(^GMR(123,+GMRCO,0),"^",10),0),"^",1)," - ",2),1:"")_"^6"
"RTN","GMRCGUIC",50,0)
 ..Q
"RTN","GMRCGUIC",51,0)
 .I $P(GMRCMSG,"^",1)="GMRCATN" S GMRCATN=$P(GMRCMSG,"^",2),GMRCFLD(7)=$S(+$P(^GMR(123,+GMRCO,0),"^",11):$$GET1^DIQ(200,+$P(^GMR(123,+GMRCO,0),"^",11),.01),1:"")_"^7" Q
"RTN","GMRCGUIC",52,0)
 .I $P(GMRCMSG,"^",1)="GMRCREQ" S GMRCREQ=$P(GMRCMSG,"^",2),GMRCFLD(13)=$S($P(^GMR(123,+GMRCO,0),"^",17)="P":"Procedure",1:"Consult")_"^13" Q
"RTN","GMRCGUIC",53,0)
 .I $P(GMRCMSG,"^",1)="GMRCION" S GMRCION=$P(GMRCMSG,"^",2),GMRCFLD(14)=$S($P(^GMR(123,+GMRCO,0),"^",18)="I":"Inpatient",$P(^(0),"^",18)="O":"Outpatient",1:"")_"^14" Q
"RTN","GMRCGUIC",54,0)
 .I $P(GMRCMSG,"^",1)="GMRCERDT" S GMRCERDT=$P(GMRCMSG,"^",2),GMRCFLD(17)=$S(+$P(^GMR(123,+GMRCO,0),"^",24)>0:$$FMTE^XLFDT($P(^GMR(123,+GMRCO,0),"^",24)),1:"")_"^17" Q
"RTN","GMRCGUIC",55,0)
 .I $P(GMRCMSG,"^",1)="GMRCDIAG" D  Q
"RTN","GMRCGUIC",56,0)
 ..S GMRCDIAG=$P(GMRCMSG,"^",2)
"RTN","GMRCGUIC",57,0)
 ..S GMRCFLD(30)=$G(^GMR(123,+GMRCO,30))_"^30"
"RTN","GMRCGUIC",58,0)
 ..I $P(GMRCFLD(30),U)="" S $P(GMRCFLD(30),U)="No Previous Value"
"RTN","GMRCGUIC",59,0)
 ..I $L($P(GMRCMSG,U,3)) D
"RTN","GMRCGUIC",60,0)
 ...S GMRCDXCD=$P(GMRCMSG,"^",3)
"RTN","GMRCGUIC",61,0)
 ...S GMRCCSYS=$$CODECS^ICDEX($G(GMRCDXCD),80) S GMRCCSYS=$S($P(GMRCCSYS,U)=1:"ICD",$P(GMRCCSYS,U)=30:"10D",1:"")
"RTN","GMRCGUIC",62,0)
 ...S GMRCLABL=$P($G(^GMR(123,+GMRCO,30.1)),U,3)
"RTN","GMRCGUIC",63,0)
 ...S GMRCLABL=$S($G(GMRCLABL)="ICD":"ICD-9-CM",$G(GMRCLABL)="10D":"ICD-10-CM",1:"")
"RTN","GMRCGUIC",64,0)
 ...S GMRCFLD(30.1)=$P($G(^GMR(123,+GMRCO,30.1)),U)_"("_$G(GMRCLABL)_")"_"^30.1"
"RTN","GMRCGUIC",65,0)
 ...S GMRCDXDT=$P($G(^GMR(123,+GMRCO,30.1)),U,2)
"RTN","GMRCGUIC",66,0)
 ...S:$G(GMRCDXDT)="" GMRCFLD(30.2)="No Previous Value"_"^30.2"
"RTN","GMRCGUIC",67,0)
 ...S:DT>+$G(GMRCDXDT) GMRCFLD(30.2)=$$FMTE^XLFDT(GMRCDXDT,"D")_"^30.2"
"RTN","GMRCGUIC",68,0)
 ...I GMRCCSYS'=$P($G(^GMR(123,+GMRCO,30.1)),U,3) S GMRCFLD(30.3)=$S($P($G(^GMR(123,+GMRCO,30.1)),U,3)="ICD":"ICD-9-CM",$P($G(^GMR(123,+GMRCO,30.1)),U,3)="10D":"ICD-10-CM",1:"")_"^30.3"
"RTN","GMRCGUIC",69,0)
 ..I $G(GMRCDXCD)'="" S CODINTXT="("_GMRCDXCD_")" D
"RTN","GMRCGUIC",70,0)
 ... I GMRCDIAG[CODINTXT S GMRCDIAG=$E(GMRCDIAG,0,($L(GMRCDIAG)-$L(CODINTXT))) S GMRCDIAG=$$TRIM^XLFSTR(GMRCDIAG,"R")
"RTN","GMRCGUIC",71,0)
 .Q
"RTN","GMRCGUIC",72,0)
 S:'$D(GMRCLM) GMRCGUIF=1
"RTN","GMRCGUIC",73,0)
 S GMRCACTN=$$EN^GMRCEDT3(GMRCO)
"RTN","GMRCGUIC",74,0)
 S DR=$$SETDA^GMRCGUIU($G(GMRCSS),$G(GMRCPROC),$G(GMRCURG),$G(GMRCPL),$G(GMRCATN),$G(GMRCRQT),$G(GMRCION),$G(GMRCERDT),$G(GMRCDIAG),$G(GMRCDXCD)) I $L(DR) D
"RTN","GMRCGUIC",75,0)
 .S DIE="^GMR(123,",DA=GMRCO
"RTN","GMRCGUIC",76,0)
 .L +^GMR(123,GMRCO):$S($G(DILOCKTM)>0:DILOCKTM,1:5) ;WAT/66 added timeout
"RTN","GMRCGUIC",77,0)
 .D ^DIE
"RTN","GMRCGUIC",78,0)
 .S DR="8////^S X=5;9////^S X=11"
"RTN","GMRCGUIC",79,0)
 .D ^DIE
"RTN","GMRCGUIC",80,0)
 .L -^GMR(123,GMRCO)
"RTN","GMRCGUIC",81,0)
 .K DIE,DR,DA
"RTN","GMRCGUIC",82,0)
 .Q
"RTN","GMRCGUIC",83,0)
 S DFN=$P(^GMR(123,+GMRCO,0),"^",2),GMRCPROV=$P(^(0),"^",14),GMRCTYPE=$P(^(0),"^",17),GMRCTRLC="XX^RESUBMIT",VISIT="",RMBED=""
"RTN","GMRCGUIC",84,0)
 D EN^GMRCHL7(DFN,+GMRCO,GMRCTYPE,RMBED,GMRCTRLC,$G(DUZ),VISIT,.GMRCOM)
"RTN","GMRCGUIC",85,0)
 S GMRCSVC=$S($G(GMRCSS):GMRCSS,1:$P(^GMR(123,+GMRCO,0),U,5))
"RTN","GMRCGUIC",86,0)
 S GMRCORTX="Resubmitted consult "_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCGUIC",87,0)
 S GMRCORTX=GMRCORTX_$S($G(GMRCURG):" ("_$P(^ORD(101,+GMRCURG,0),"^",2)_")",+$P(^GMR(123,+GMRCO,0),U,9):"( "_$P(^ORD(101,+$P(^GMR(123,+GMRCO,0),U,9),0),"^",2)_" )",1:"")
"RTN","GMRCGUIC",88,0)
 S GMRCFL=1
"RTN","GMRCGUIC",89,0)
 D MSG^GMRCP(DFN,GMRCORTX,+GMRCO,27,.GMRCADUZ,GMRCFL) ;Send notification of NEW consult
"RTN","GMRCGUIC",90,0)
 D PRNT^GMRCUTL1(+$P(^GMR(123,+GMRCO,0),U,5),+GMRCO) ;send 513 to service
"RTN","GMRCGUIC",91,0)
 ;Next line gets rid of alert
"RTN","GMRCGUIC",92,0)
 I $D(XQAID),$L(XQAID) D
"RTN","GMRCGUIC",93,0)
 . N GMRCCORY
"RTN","GMRCGUIC",94,0)
 . S XQAKILL=$$XQAKILL^ORB3F1 D DEL^ORB3FUP1(.GMRCCORY,XQAID)
"RTN","GMRCGUIC",95,0)
 I $P($G(^GMR(123,+GMRCO,12)),U,5)="P" D
"RTN","GMRCGUIC",96,0)
 . D TRIGR^GMRCIEVT(GMRCO,GMRCACTN)
"RTN","GMRCGUIC",97,0)
 D GUIC^GMRCGUIU
"RTN","GMRCGUIC",98,0)
 Q
"RTN","GMRCGUIC",99,0)
SEND(GMRCO,GLOBAL) ;Get data fields to send to GUI for editing consult
"RTN","GMRCGUIC",100,0)
 ;GMRCO=record being edited GLOBAL=Global Referece, i.e., "^TMP("GMRCR",$J)"
"RTN","GMRCGUIC",101,0)
 K @GLOBAL
"RTN","GMRCGUIC",102,0)
 N ND,GMRCSX,TYPE,NDX,GMRCCPTR,GMRCCSYS,GMRCCODE,CODINTXT
"RTN","GMRCGUIC",103,0)
 S ND=1,GMRCSX=""
"RTN","GMRCGUIC",104,0)
 I '$D(GMRCO)!('+GMRCO) Q
"RTN","GMRCGUIC",105,0)
 S GMRC(0)=$G(^GMR(123,+GMRCO,0)) Q:'$L(GMRC(0))
"RTN","GMRCGUIC",106,0)
 S GMRCSS=$P(GMRC(0),"^",5),GMRCPROC=$P(GMRC(0),"^",8)
"RTN","GMRCGUIC",107,0)
 S GMRCURG=$P(GMRC(0),"^",9),GMRCPL=$P(GMRC(0),"^",10)
"RTN","GMRCGUIC",108,0)
 S GMRCATN=$P(GMRC(0),"^",11),GMRCINO=$P(GMRC(0),"^",18)
"RTN","GMRCGUIC",109,0)
 S GMRCREQ=$P(GMRC(0),"^",17),GMRCERDT=$P(GMRC(0),"^",24)
"RTN","GMRCGUIC",110,0)
 S GMRCDIAG=$G(^GMR(123,+GMRCO,30)) I $L($G(^(30.1))) D
"RTN","GMRCGUIC",111,0)
 . S GMRCCODE=$P($G(^GMR(123,+GMRCO,30.1)),"^",1)
"RTN","GMRCGUIC",112,0)
 . S GMRCCSYS=$P($G(^GMR(123,+GMRCO,30.1)),"^",3)
"RTN","GMRCGUIC",113,0)
 . S GMRCCPTR=$S(GMRCCSYS="ICD":1,1:30)
"RTN","GMRCGUIC",114,0)
 . I $G(GMRCCODE)'="" D  ;users expect to see prov dx text and dx code in edit/resubmit dialog
"RTN","GMRCGUIC",115,0)
 .. S CODINTXT=" ("_GMRCCODE_")"
"RTN","GMRCGUIC",116,0)
 .. Q:GMRCDIAG[CODINTXT
"RTN","GMRCGUIC",117,0)
 .. S GMRCDIAG=GMRCDIAG_CODINTXT
"RTN","GMRCGUIC",118,0)
 . S GMRCDIAG=GMRCDIAG_U_$G(GMRCCODE)
"RTN","GMRCGUIC",119,0)
 S GMRCPROV=$S($P(^GMR(123,+GMRCO,0),U,14):$$GET1^DIQ(200,+$P(^(0),U,14),.01),1:"")
"RTN","GMRCGUIC",120,0)
 S @GLOBAL@(ND,0)="~SERVICE",ND=ND+1
"RTN","GMRCGUIC",121,0)
 I +GMRCSS S GMRCSX=$P(^GMR(123.5,GMRCSS,0),"^",1),@GLOBAL@(ND,0)="d"_GMRCSX_"^"_GMRCSS_"^",ND=ND+1,GMRCSX=""
"RTN","GMRCGUIC",122,0)
 E  S @GLOBAL@(ND,0)="d"_"^^",ND=ND+1
"RTN","GMRCGUIC",123,0)
 S @GLOBAL@(ND,0)="~PROCEDURE",ND=ND+1
"RTN","GMRCGUIC",124,0)
 I $L(GMRCPROC),+GMRCPROC D
"RTN","GMRCGUIC",125,0)
 .S GMRCSX=$$UP^XLFSTR($$GET1^DIQ(123.3,+GMRCPROC,.01))
"RTN","GMRCGUIC",126,0)
 .S GMRCSY=$$FIND1^DIC(101.43,,"QX",+GMRCPROC_";99PRC","ID")
"RTN","GMRCGUIC",127,0)
 .I +GMRCSY D
"RTN","GMRCGUIC",128,0)
 ..S @GLOBAL@(ND,0)="d"_GMRCSY_"^"_GMRCSX,ND=ND+1
"RTN","GMRCGUIC",129,0)
 ..Q
"RTN","GMRCGUIC",130,0)
 E  S @GLOBAL@(ND,0)="d^^"
"RTN","GMRCGUIC",131,0)
 S @GLOBAL@(ND,0)="~TYPE",ND=ND+1
"RTN","GMRCGUIC",132,0)
 I $L(GMRCREQ) D  I '$L(GMRCREQ) S @GLOBAL@(ND,0)="d^^"
"RTN","GMRCGUIC",133,0)
 . S GMRCSX=$S(GMRCREQ="P":"PROCEDURE",1:"CONSULT")
"RTN","GMRCGUIC",134,0)
 . S @GLOBAL@(ND,0)="d"_$E(GMRCSX,1)_"^"_GMRCSX_"^"_GMRCREQ
"RTN","GMRCGUIC",135,0)
 . S GMRCSX=""
"RTN","GMRCGUIC",136,0)
 S ND=ND+1
"RTN","GMRCGUIC",137,0)
 S @GLOBAL@(ND,0)="~CATEGORY",ND=ND+1
"RTN","GMRCGUIC",138,0)
 I $L(GMRCINO) D  S ND=ND+1,GMRCSX=""
"RTN","GMRCGUIC",139,0)
 .S @GLOBAL@(ND,0)="d"_GMRCINO_"^"_$S(GMRCINO="I":"INPATIENT",1:"OUTPATIENT")_"^"
"RTN","GMRCGUIC",140,0)
 .S @GLOBAL@(ND,0)=@GLOBAL@(ND,0)_$S(GMRCINO="I":$O(^ORD(101,"B","GMRCURGENCYM CSLT - INPATIENT",0)),1:$O(^ORD(101,"B","GMRCURGENCYM - OUTPATIENT",0)))
"RTN","GMRCGUIC",141,0)
 .Q
"RTN","GMRCGUIC",142,0)
 E  S @GLOBAL@(ND,0)="d^^"
"RTN","GMRCGUIC",143,0)
 S @GLOBAL@(ND,0)="~DIAGNOSIS",ND=ND+1
"RTN","GMRCGUIC",144,0)
 I $L(GMRCDIAG) S @GLOBAL@(ND,0)="d"_GMRCDIAG,ND=ND+1
"RTN","GMRCGUIC",145,0)
 E  S @GLOBAL@(ND,0)="d"
"RTN","GMRCGUIC",146,0)
 S @GLOBAL@(ND,0)="~PLACE",ND=ND+1
"RTN","GMRCGUIC",147,0)
 I +GMRCPL D  S ND=ND+1,GMRCSX=""
"RTN","GMRCGUIC",148,0)
 .S GMRCSX=$P($P(^ORD(101,GMRCPL,0),"^",1),"GMRCPLACE - ",2),GMRCSX=$S(GMRCSX="ON CALL":"CONSULTANTS CHOICE",1:GMRCSX),@GLOBAL@(ND,0)="d"_$E(GMRCSX,1)_"^"_GMRCSX_"^"_GMRCPL
"RTN","GMRCGUIC",149,0)
 .Q
"RTN","GMRCGUIC",150,0)
 E  S @GLOBAL@(ND,0)="d^^",ND=ND+1
"RTN","GMRCGUIC",151,0)
 S @GLOBAL@(ND,0)="~ATTENTION",ND=ND+1
"RTN","GMRCGUIC",152,0)
 I +GMRCATN S GMRCSX=$$GET1^DIQ(200,GMRCATN,.01),@GLOBAL@(ND,0)="d"_GMRCATN_"^"_GMRCSX_"^"_GMRCATN,ND=ND+1,GMRCSX=""
"RTN","GMRCGUIC",153,0)
 E  S @GLOBAL@(ND,0)="d^^",ND=ND+1
"RTN","GMRCGUIC",154,0)
 S @GLOBAL@(ND,0)="~EARLIEST",ND=ND+1 ;WAT/66
"RTN","GMRCGUIC",155,0)
 I GMRCERDT S @GLOBAL@(ND,0)="d"_"^"_GMRCERDT,ND=ND+1 ;WAT66
"RTN","GMRCGUIC",156,0)
 E  S @GLOBAL@(ND,0)="d^" ;WAT
"RTN","GMRCGUIC",157,0)
 S @GLOBAL@(ND,0)="~URGENCY",ND=ND+1
"RTN","GMRCGUIC",158,0)
 I +GMRCURG S GMRCSX=$P($P(^ORD(101,GMRCURG,0),"^",1),"GMRCURGENCY - ",2),GMRCURGY=$O(^ORD(101.42,"S.GMRCO",GMRCSX,0)) I $L(GMRCSX) D
"RTN","GMRCGUIC",159,0)
 .S GMRCSY=$O(^ORD(101.42,"B",GMRCSX,0))
"RTN","GMRCGUIC",160,0)
 .S @GLOBAL@(ND,0)="d"_GMRCSY_"^"_GMRCSX_"^"_GMRCURG,ND=ND+1
"RTN","GMRCGUIC",161,0)
 .S GMRCSX="" K GMRCSY
"RTN","GMRCGUIC",162,0)
 .Q
"RTN","GMRCGUIC",163,0)
 E  S @GLOBAL@(ND,0)="d^^",ND=ND+1
"RTN","GMRCGUIC",164,0)
 ;Get reason for request
"RTN","GMRCGUIC",165,0)
 S @GLOBAL@(ND,0)="~REASON",ND=ND+1
"RTN","GMRCGUIC",166,0)
 I $O(^GMR(123,+GMRCO,20,0)) S NDX=0 F  S NDX=$O(^GMR(123,+GMRCO,20,NDX)) Q:NDX=""  S @GLOBAL@(ND,0)="t"_^GMR(123,+GMRCO,20,NDX,0),ND=ND+1
"RTN","GMRCGUIC",167,0)
 E  S @GLOBAL@(ND,0)="~REASON",ND=ND+1,@GLOBAL@(ND,0)="tREASON "
"RTN","GMRCGUIC",168,0)
 ;Get Comments, including Deny Comments
"RTN","GMRCGUIC",169,0)
 D SENDCOMT^GMRCGUIU(GMRCO,.ND)
"RTN","GMRCGUIC",170,0)
 D GUIC^GMRCGUIU
"RTN","GMRCGUIC",171,0)
 Q
"RTN","GMRCHL7B")
0^2^B26855576^B29886300
"RTN","GMRCHL7B",1,0)
GMRCHL7B ;SLC/DCM,MA,JFR - Process data from GMRCHL7A ;10/09/15  13:26
"RTN","GMRCHL7B",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,21,17,22,33,66,46,73,85**;DEC 27, 1997;Build 3
"RTN","GMRCHL7B",3,0)
 ;
"RTN","GMRCHL7B",4,0)
 ; This routine invokes IA #2053(DIE), #10006(DIC), #2056(GET1^DIQ), #5747$$CODECS^ICDEX
"RTN","GMRCHL7B",5,0)
 ;
"RTN","GMRCHL7B",6,0)
NEW(MESSAGE) ;Add new order
"RTN","GMRCHL7B",7,0)
 ;GMRCO=^GMR(123,IFN, the new file number in file ^GMR(123,
"RTN","GMRCHL7B",8,0)
 ;GMRCORFN=OE/RR file number       GMRCWARD=ward patient is on
"RTN","GMRCHL7B",9,0)
 ;GMRCSS=service consult sent to   GMRCAD=date/time of request
"RTN","GMRCHL7B",10,0)
 ;GMRCPRI=procedure/request        GMRCURGI=urgency
"RTN","GMRCHL7B",11,0)
 ;GMRCERDT=earliest desired date
"RTN","GMRCHL7B",12,0)
 ;GMRCATN=attention                GMRCSTS=OE/RR order status
"RTN","GMRCHL7B",13,0)
 ;GMRCORNP=patient's provider      GMRCTYPE=request type (request or consult)
"RTN","GMRCHL7B",14,0)
 ;GMRCSBR=service rendered on what basis (Inpatient, or Outpatient)
"RTN","GMRCHL7B",15,0)
 ;GMRCRFQ=reason for request array - word processing fields
"RTN","GMRCHL7B",16,0)
 ;GMRCOTXT=order display text from dialog or orderable item
"RTN","GMRCHL7B",17,0)
 ;GMRCPRDG=provisional DX
"RTN","GMRCHL7B",18,0)
 ;GMRCPRCD=provisional DX code
"RTN","GMRCHL7B",19,0)
 ;GMRCCS=coding system for prov diagnosis
"RTN","GMRCHL7B",20,0)
 ;GMRCCPTR=pointer to coding system file
"RTN","GMRCHL7B",21,0)
 ; Output:
"RTN","GMRCHL7B",22,0)
 ;    MESSAGE = rejection message if problems encountered while filing
"RTN","GMRCHL7B",23,0)
 ;
"RTN","GMRCHL7B",24,0)
 ;
"RTN","GMRCHL7B",25,0)
 N DIC,DLAYGO,X,Y,DR,DIE,GMRCADUZ,GMRCCP,GMRCCS
"RTN","GMRCHL7B",26,0)
 S DIC="^GMR(123,",DIC(0)="L",X="""N""",DLAYGO=123 D ^DIC K DLAYGO Q:Y<1
"RTN","GMRCHL7B",27,0)
 ; Patch #21 changed GMRCA=1 to GMRCA=2
"RTN","GMRCHL7B",28,0)
 S (DA,GMRCO)=+Y,GMRCSTS=5,GMRCA=2,DIE=DIC
"RTN","GMRCHL7B",29,0)
 L +^GMR(123,GMRCO):$S($G(DILOCKTM)>0:DILOCKTM,1:5)
"RTN","GMRCHL7B",30,0)
 S DR=".02////^S X=DFN;.03////^S X=GMRCORFN;.04////^S X=GMRCWARD;.05////^S X=GMRCFAC;.06////^S X=$G(GMRCOFN);1////^S X=GMRCSS;2////^S X=$G(GMRCWARD);3////^S X=GMRCAD;4////^S X=GMRCPRI;5////^S X=GMRCURGI;7////^S X=$G(GMRCATN)"
"RTN","GMRCHL7B",31,0)
 D ^DIE
"RTN","GMRCHL7B",32,0)
 I GMRCOTXT=$$GET1^DIQ(123.5,+GMRCSS,.01) S GMRCOTXT=""
"RTN","GMRCHL7B",33,0)
 ;Added new field .1 to DR on 7/11/98 to save the order text
"RTN","GMRCHL7B",34,0)
 S DR="6////^S X=GMRCPLI;8////^S X=GMRCSTS;9////^S X=GMRCA;10////^S X=GMRCORNP;13////^S X=GMRCTYPE;14////^S X=$G(GMRCSBR);17////^S X=$G(GMRCERDT);30////^S X=$G(GMRCPRDG);.1////^S X=$G(GMRCOTXT)" ;wat/66
"RTN","GMRCHL7B",35,0)
 I $D(GMRCPRCD) D
"RTN","GMRCHL7B",36,0)
 .S GMRCCS=""
"RTN","GMRCHL7B",37,0)
 .S GMRCCS=$$CODECS^ICDEX(GMRCPRCD,80) I $G(GMRCCS)'="" D  ;use dx code to get coding system
"RTN","GMRCHL7B",38,0)
 ..S GMRCCS=$S($P(GMRCCS,U)=1:"ICD",1:"10D")
"RTN","GMRCHL7B",39,0)
 .S DR=DR_";30.1///^S X=GMRCPRCD;30.2////^S X=DT;30.3////^S X=GMRCCS"
"RTN","GMRCHL7B",40,0)
 S GMRCCP=$P($G(^GMR(123.3,+GMRCPRI,0)),U,4) I GMRCCP D  ;file CP
"RTN","GMRCHL7B",41,0)
 . S DR=DR_";1.01///^S X=GMRCCP"
"RTN","GMRCHL7B",42,0)
 D  ;check to see if an IFC and add .07 ROUTING FACILITY
"RTN","GMRCHL7B",43,0)
 . I $G(GMRCPRI) D  Q  ;see if procedure is mapped
"RTN","GMRCHL7B",44,0)
 .. I '$D(^GMR(123.3,+GMRCPRI,"IFC")) Q
"RTN","GMRCHL7B",45,0)
 .. N IFC S IFC=$G(^GMR(123.3,+GMRCPRI,"IFC"))
"RTN","GMRCHL7B",46,0)
 .. I '+IFC Q  ; no ifc routing site
"RTN","GMRCHL7B",47,0)
 .. I '$L($P(^GMR(123.3,+GMRCPRI,"IFC"),U,2)) Q  ;no remote proc name
"RTN","GMRCHL7B",48,0)
 .. S DR=DR_";.07////"_+IFC_";.125////P"
"RTN","GMRCHL7B",49,0)
 . I '$G(GMRCPRI) D  Q  ;see if service is mapped
"RTN","GMRCHL7B",50,0)
 .. I '$D(^GMR(123.5,+GMRCSS,"IFC")) Q
"RTN","GMRCHL7B",51,0)
 .. N IFC S IFC=$G(^GMR(123.5,+GMRCSS,"IFC"))
"RTN","GMRCHL7B",52,0)
 .. I '+IFC Q  ; no ifc routing site
"RTN","GMRCHL7B",53,0)
 .. I '$L($P(IFC,U,2)) Q  ;no remote service name
"RTN","GMRCHL7B",54,0)
 .. S DR=DR_";.07////"_+IFC_";.125////P;.131////"_$P(IFC,U,2)
"RTN","GMRCHL7B",55,0)
 . Q
"RTN","GMRCHL7B",56,0)
 D ^DIE
"RTN","GMRCHL7B",57,0)
 I $O(GMRCRFQ(0)) D REASON
"RTN","GMRCHL7B",58,0)
 L -^GMR(123,GMRCO)
"RTN","GMRCHL7B",59,0)
 S GMRCA=1 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",60,0)
 I $D(GMRCXMF),$D(GMRCOFN) S $P(^GMR(123,GMRCO,0),"^",21)=GMRCOFN
"RTN","GMRCHL7B",61,0)
 I $D(GMRCACTN) S GMRCADUZ(GMRCACTN)=""
"RTN","GMRCHL7B",62,0)
 D ALERT^GMRCHL7U(DFN,GMRCSS,GMRCPRI,GMRCO,GMRCURGI,"")
"RTN","GMRCHL7B",63,0)
 D PRNT^GMRCUTL1(GMRCSS,GMRCO) ;contains print audit update
"RTN","GMRCHL7B",64,0)
 D EXIT
"RTN","GMRCHL7B",65,0)
 Q
"RTN","GMRCHL7B",66,0)
DC(GMRCO,ACTRL) ;Discontinue request from OERR
"RTN","GMRCHL7B",67,0)
 ;Denied request also gets this action. Deny request updates status to dc
"RTN","GMRCHL7B",68,0)
 ;GMRCO=IEN of record in file ^GMR(123, i.e., ^GMR(123,DA,
"RTN","GMRCHL7B",69,0)
 ;ACTRL=GMRCCTRL=control code defining action -
"RTN","GMRCHL7B",70,0)
 ;         DC control code = action DC for discontinued
"RTN","GMRCHL7B",71,0)
 ;         CA control code = action DY for denied
"RTN","GMRCHL7B",72,0)
 ;Update the last action taken, order status, and processing activity
"RTN","GMRCHL7B",73,0)
 Q:'$L(GMRCO)
"RTN","GMRCHL7B",74,0)
 Q:'$D(^GMR(123,+GMRCO,0))
"RTN","GMRCHL7B",75,0)
 N GMRCACT,GMRCSVC,GMRCDFN,GMRCFL,GMRCADUZ,GMRCRQR,DA
"RTN","GMRCHL7B",76,0)
 S GMRCACT=$O(^GMR(123.1,"D",ACTRL,0))
"RTN","GMRCHL7B",77,0)
 S GMRCSTS=$P(^GMR(123.1,GMRCACT,0),"^",2)
"RTN","GMRCHL7B",78,0)
 S DIE="^GMR(123,",DA=GMRCO
"RTN","GMRCHL7B",79,0)
 S DR="8////^S X=GMRCSTS;9////^S X=GMRCACT" ; upd status + last action
"RTN","GMRCHL7B",80,0)
 D ^DIE
"RTN","GMRCHL7B",81,0)
 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",82,0)
 ; send 513 back through service printer if order DC'd
"RTN","GMRCHL7B",83,0)
 I $G(ACTRL)="DC",$$DCPRNT^GMRCUTL1(GMRCO,DUZ) D
"RTN","GMRCHL7B",84,0)
 . D PRNT^GMRCUTL1(+$P(^GMR(123,GMRCO,0),U,5),GMRCO)
"RTN","GMRCHL7B",85,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCHL7B",86,0)
 S GMRCFL=$$DCNOTE^GMRCADC(GMRCO,DUZ),GMRCADUZ=""
"RTN","GMRCHL7B",87,0)
 S GMRCRQR=+$P($G(^GMR(123,+GMRCO,0)),"^",14)
"RTN","GMRCHL7B",88,0)
 I +GMRCRQR,GMRCRQR'=DUZ S GMRCADUZ(GMRCRQR)=""
"RTN","GMRCHL7B",89,0)
 S GMRCSVC=$P($G(^GMR(123,+GMRCO,0)),"^",5)
"RTN","GMRCHL7B",90,0)
 I +GMRCSVC S GMRCSVC=$S($D(^GMR(123.5,GMRCSVC,.1)):^(.1),1:$P(^GMR(123.5,GMRCSVC,0),"^",1))
"RTN","GMRCHL7B",91,0)
 E  S GMRCSVC="Unknown Service: Consult # "_GMRCO
"RTN","GMRCHL7B",92,0)
 S GMRCORTX=$S(ACTRL="DC":"Discontinued",1:"Cancelled")
"RTN","GMRCHL7B",93,0)
 S GMRCORTX=GMRCORTX_" Consult "_$$ORTX^GMRCAU(GMRCO)
"RTN","GMRCHL7B",94,0)
 N NOTYPE S NOTYPE=$S(ACTRL="DC":23,1:30)
"RTN","GMRCHL7B",95,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,NOTYPE,.GMRCADUZ,GMRCFL)
"RTN","GMRCHL7B",96,0)
 D EXIT
"RTN","GMRCHL7B",97,0)
 Q
"RTN","GMRCHL7B",98,0)
MODIFY ;Change an order/request when an HL7 'XX' code is received
"RTN","GMRCHL7B",99,0)
 ;This is currently not used.
"RTN","GMRCHL7B",100,0)
 ;    When Consults sends an XX, CPRS returns NA with a new order ien.
"RTN","GMRCHL7B",101,0)
 ;GMRCACT=processing activity - from file ^GMR(123.1,
"RTN","GMRCHL7B",102,0)
 S DIE="^GMR(123,",DA=+GMRCO
"RTN","GMRCHL7B",103,0)
 S GMRCWARD=$G(GMRCWARD),GMRCPRI=$G(GMRCPRI),GMRCURGI=$G(GMRCURGI),GMRCSTS=$G(GMRCSTS),GMRCTYPE=$G(GMRCTYPE),GMRCSS=$G(GMRCSS)
"RTN","GMRCHL7B",104,0)
 S GMRCACT=$O(^GMR(123.1,"D",GMRCTRLC,0))
"RTN","GMRCHL7B",105,0)
 S GMRCSTS=$P(^GMR(123.1,GMRCACT,0),"^",2)
"RTN","GMRCHL7B",106,0)
 S DIE=123,DR=".04////^S X=$G(GMRCWARD);1////^S X=$G(GMRCSS);4////^S X=$G(GMRCPRI);5////^S X=$G(GMRCURGI);8////^S X=$G(GMRCSTS);9////^S X=GMRCACT"
"RTN","GMRCHL7B",107,0)
 D ^DIE
"RTN","GMRCHL7B",108,0)
 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",109,0)
 D EXIT Q
"RTN","GMRCHL7B",110,0)
REASON ;load the reason for request into ^GMR(123,IFN,20
"RTN","GMRCHL7B",111,0)
 S ^GMR(123,GMRCO,20,0)="^^^"_$S($D(GMRCDA):GMRCDA,1:DT)_"^"
"RTN","GMRCHL7B",112,0)
 S L=0,LN=1 F  S L=$O(GMRCRFQ(L)) Q:L=""  S ^GMR(123,GMRCO,20,LN,0)=GMRCRFQ(L),LN=LN+1
"RTN","GMRCHL7B",113,0)
 S LN=LN-1,$P(^GMR(123,GMRCO,20,0),"^",3)=LN
"RTN","GMRCHL7B",114,0)
 K L,LN
"RTN","GMRCHL7B",115,0)
 Q
"RTN","GMRCHL7B",116,0)
COMMENT(GMRCARY) ;add comments to the record.  Add the comment header, then the comment lines, and lastly, the number of comment lines to the header
"RTN","GMRCHL7B",117,0)
 ;GMRCARY= GMRCNTC array
"RTN","GMRCHL7B",118,0)
 S LN=0,^GMR(123,GMRCO,40,DA,1,0)="^^^^"_$P(GMRCDA,".",1)_"^"
"RTN","GMRCHL7B",119,0)
 F  S LN=$O(GMRCARY(LN)) Q:LN=""  S ^GMR(123,+GMRCO,40,DA,1,LN,0)=GMRCARY(LN),LN1=LN
"RTN","GMRCHL7B",120,0)
 S $P(^GMR(123,+GMRCO,40,DA,1,0),"^",3,4)=LN1_"^"_LN1
"RTN","GMRCHL7B",121,0)
 K LN,LN1 Q
"RTN","GMRCHL7B",122,0)
 Q
"RTN","GMRCHL7B",123,0)
EXIT ;kill off all variables
"RTN","GMRCHL7B",124,0)
 K DA,DIC,DIE,DR,GMRCORTX,GMRCADUZ
"RTN","GMRCHL7B",125,0)
 Q
"RTN","GMRCHL7H")
0^6^B130038973^B129894392
"RTN","GMRCHL7H",1,0)
GMRCHL7H ;DSS/KC - Receive HL7 Message for HCP ;10/29/15  16:55
"RTN","GMRCHL7H",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**75,85**;DEC 27, 1997;Build 3
"RTN","GMRCHL7H",3,0)
 ;
"RTN","GMRCHL7H",4,0)
 ;DBIA# Supported Reference
"RTN","GMRCHL7H",5,0)
 ;----- --------------------------------
"RTN","GMRCHL7H",6,0)
 ;2161  INIT^HLFNC2
"RTN","GMRCHL7H",7,0)
 ;2164  GENERATE^HLMA
"RTN","GMRCHL7H",8,0)
 ;2944  TGET^TIUSRVR1
"RTN","GMRCHL7H",9,0)
 ;3267  SSN^DPTLK1
"RTN","GMRCHL7H",10,0)
 ;3630  BLDPID^VAFCQRY
"RTN","GMRCHL7H",11,0)
 ;5807  GETLINK^TIUSRVT1
"RTN","GMRCHL7H",12,0)
 ;10103 FMTE^XLFDT, FMTHL7^XLFDT
"RTN","GMRCHL7H",13,0)
 ;10104 UP^XLFSTR
"RTN","GMRCHL7H",14,0)
 ;10106 FMDATE^HLFNC
"RTN","GMRCHL7H",15,0)
 ;;Patch 85 fix for CA SDM ticket R6063960FY16
"RTN","GMRCHL7H",16,0)
 ;
"RTN","GMRCHL7H",17,0)
EN(MSG) ;Entry point to routine from GMRC CONSULTS TO HCP protocol attached or GMRC EVSEND OR
"RTN","GMRCHL7H",18,0)
 ;MSG = local array which contains the HL7 segments
"RTN","GMRCHL7H",19,0)
 N I,QUIT,MSGTYP,DFN,ORC,GMRCDA,FS,MSGTYP2,MSGTYP3,ACTIEN,FROMSVC,OK,OKFROM,STATUS
"RTN","GMRCHL7H",20,0)
 S (I,QUIT)=0,I=$O(MSG(I)) Q:'I  S MSG=MSG(I) Q:$E(MSG,1,3)'="MSH"  D  Q:QUIT
"RTN","GMRCHL7H",21,0)
 .S FS=$E(MSG,4) I $P(MSG,FS,3)'="CONSULTS" S QUIT=1 Q
"RTN","GMRCHL7H",22,0)
 .S MSGTYP=$P(MSG,FS,9) I ",ORR,ORM,"'[","_MSGTYP_"," S QUIT=1 Q  ;ORR is new consult, ORM are updates
"RTN","GMRCHL7H",23,0)
 .Q
"RTN","GMRCHL7H",24,0)
 F  S I=$O(MSG(I)) Q:'I!QUIT  S MSG=MSG(I) D
"RTN","GMRCHL7H",25,0)
 .I $E(MSG,1,3)="PID" S DFN=$P(MSG,FS,4) I 'DFN!('$D(^DPT(DFN))) S QUIT=1 Q
"RTN","GMRCHL7H",26,0)
 .I $E(MSG,1,3)="ORC" S ORC=MSG S GMRCDA=+$P(ORC,FS,4),MSGTYP2=$P(ORC,FS,2),MSGTYP3=$P(ORC,FS,6) D
"RTN","GMRCHL7H",27,0)
 ..I MSGTYP3="IP" S ACTIEN=$O(^GMR(123,GMRCDA,40,99999),-1) D
"RTN","GMRCHL7H",28,0)
 ...I ACTIEN S FROMSVC=$P($G(^GMR(123,GMRCDA,40,ACTIEN,0)),U,6) I FROMSVC S OKFROM=$$FEE(FROMSVC)
"RTN","GMRCHL7H",29,0)
 ..S OK=$$FEE($$GET1^DIQ(123,GMRCDA,1,"I"))
"RTN","GMRCHL7H",30,0)
 ..I '$G(OKFROM)&'$G(OK) S QUIT=1 ;not a Fee service or not forwarded from a fee service
"RTN","GMRCHL7H",31,0)
 ..Q
"RTN","GMRCHL7H",32,0)
 .Q
"RTN","GMRCHL7H",33,0)
 Q:QUIT
"RTN","GMRCHL7H",34,0)
 I MSGTYP="ORR" S MSGTYP3="NW"
"RTN","GMRCHL7H",35,0)
 S STATUS=$$STATUS(MSGTYP2,MSGTYP3) I STATUS="UNKNOWN" Q  ;don't process anything we haven't coded for
"RTN","GMRCHL7H",36,0)
 ;done verifying this consult needs to go to HCP, start building HL7 message
"RTN","GMRCHL7H",37,0)
 N SNAME,GMRCHL,ZERR,ZCNT,ECH,DATA,GDATA,URG,TYP,RES,EFFDT,PDUZ,PN,ADDR,PH,GMRCP,SENS,DX,DXCODE
"RTN","GMRCHL7H",38,0)
 S SNAME="GMRC HCP REF-"_$S(MSGTYP2="DR":"I14",MSGTYP="ORR":"I12",MSGTYP2="OC":"I14",MSGTYP2="OD":"I14",1:"I13")_" SERVER"
"RTN","GMRCHL7H",39,0)
 S GMRCHL("EID")=$$FIND1^DIC(101,,"X",SNAME)
"RTN","GMRCHL7H",40,0)
 Q:'GMRCHL("EID")  D INIT^HLFNC2(GMRCHL("EID"),.GMRCHL)
"RTN","GMRCHL7H",41,0)
 S ZERR="",ZCNT=0,ECH=$E(GMRCHL("ECH")) ;component separator
"RTN","GMRCHL7H",42,0)
 ;start creating the segments.
"RTN","GMRCHL7H",43,0)
 S DATA=$NA(^TMP("GMRCHL7H",$J)) K @DATA D GETS^DIQ(123,GMRCDA,"*","IE",DATA)
"RTN","GMRCHL7H",44,0)
 S GDATA=$NA(^TMP("GMRCHL7H",$J,123,+GMRCDA_",")) ;File 123 data
"RTN","GMRCHL7H",45,0)
 ;RF1 segment
"RTN","GMRCHL7H",46,0)
 K GMRCM
"RTN","GMRCHL7H",47,0)
 S URG=$G(@GDATA@(5,"E")) ;I URG]"" S URG=$S(URG["ROUTINE":"R",URG["STAT":"S",1:"A")
"RTN","GMRCHL7H",48,0)
 S URG=$P(URG,"- ",2)
"RTN","GMRCHL7H",49,0)
 S TYP=$G(@GDATA@(1,"I"))_ECH_$G(@GDATA@(1,"E")) D GETLINK^TIUSRVT1(.RES,+TYP_";GMR(123.5,")
"RTN","GMRCHL7H",50,0)
 S TYP=TYP_ECH_ECH_$P($G(RES),U)_ECH_$P($G(RES),U,4)
"RTN","GMRCHL7H",51,0)
 S EFFDT=$$FMTHL7^XLFDT($G(@GDATA@(.01,"I")))
"RTN","GMRCHL7H",52,0)
 S ZCNT=ZCNT+1,GMRCM(ZCNT)="RF1|"_STATUS_"|"_URG_"|"_TYP_"||"_$G(@GDATA@(14,"I"))_"|"_GMRCDA_"|"_EFFDT_"||||"
"RTN","GMRCHL7H",53,0)
 ;PRD segment
"RTN","GMRCHL7H",54,0)
 S PDUZ=$G(@GDATA@(10,"I")),PN=$G(@GDATA@(10,"E")),PN=$$HLNAME^XLFNAME(PN,"S",ECH),$P(PN,ECH,9)=PDUZ
"RTN","GMRCHL7H",55,0)
 S ADDR=$$ADDR^GMRCHL7P(PDUZ,.GMRCHL),PH=$$PH^GMRCHL7P(PDUZ,.GMRCHL)
"RTN","GMRCHL7H",56,0)
 S ZCNT=ZCNT+1,GMRCM(ZCNT)="PRD|RP|"_PN_"|"_$G(ADDR)_"||"_$G(PH)_"|"
"RTN","GMRCHL7H",57,0)
 ;PID segment  May be multiple nodes in the return array - make nodes 2-n sub nodes
"RTN","GMRCHL7H",58,0)
 D BLDPID^VAFCQRY(DFN,1,"ALL",.GMRCP,.GMRCHL,ZERR)
"RTN","GMRCHL7H",59,0)
 S I=0 F  S I=$O(GMRCP(I)) Q:'I  D
"RTN","GMRCHL7H",60,0)
 .I I=1 S ZCNT=ZCNT+1,GMRCM(ZCNT)=$TR(GMRCP(I),"""") Q
"RTN","GMRCHL7H",61,0)
 .S GMRCM(ZCNT,I)=$TR(GMRCP(I),"""")
"RTN","GMRCHL7H",62,0)
 K GMRCP
"RTN","GMRCHL7H",63,0)
 ;DG1 segment ;Patch 85 modified
"RTN","GMRCHL7H",64,0)
 S DX=$G(@GDATA@(30,"E"))
"RTN","GMRCHL7H",65,0)
 S DXCODE=$G(@GDATA@(30.1,"E"))
"RTN","GMRCHL7H",66,0)
 I $G(DX)["(" S DX=$P(DX,"(")
"RTN","GMRCHL7H",67,0)
 S ZCNT=ZCNT+1,GMRCM(ZCNT)="DG1|1||"_$G(DXCODE)_ECH_$G(DX)_"|||W"
"RTN","GMRCHL7H",68,0)
 ;OBR segment
"RTN","GMRCHL7H",69,0)
 S ZCNT=ZCNT+1,GMRCM(ZCNT)="OBR|1|"_$P(ORC,FS,3)_"|"_$P(ORC,FS,4)_"|ZZ||"_$$FMTHL7^XLFDT($G(@GDATA@(17,"I")))
"RTN","GMRCHL7H",70,0)
 ;PV1 segment
"RTN","GMRCHL7H",71,0)
 D IN5^VADPT ;VAIP(18)=Attending Physician, VAIP(13,5)=Primary Physician for admission
"RTN","GMRCHL7H",72,0)
 S ZCNT=ZCNT+1,GMRCM(ZCNT)="PV1|1|"_$S(VAIP(13):"I",1:"O")_"|||||"_VAIP(18)_"|"
"RTN","GMRCHL7H",73,0)
 I VAIP(5) S $P(GMRCM(ZCNT),"|",4)=VAIP(5) ;location for last movement event
"RTN","GMRCHL7H",74,0)
 S SENS=$$SSN^DPTLK1(DFN) I SENS["*SENSITIVE*" S $P(GMRCM(ZCNT),"|",17)="R" ;sensitive patient
"RTN","GMRCHL7H",75,0)
 S $P(GMRCM(ZCNT),"|",18)=VAIP(13,5)
"RTN","GMRCHL7H",76,0)
 D KVA^VADPT
"RTN","GMRCHL7H",77,0)
 ;NTE segment
"RTN","GMRCHL7H",78,0)
 D NTE(.GMRCHL)
"RTN","GMRCHL7H",79,0)
 K ^TMP("GMRCHL7H",$J)
"RTN","GMRCHL7H",80,0)
 ;
"RTN","GMRCHL7H",81,0)
 ; When done, re-serve the (modified) referral message to HCP
"RTN","GMRCHL7H",82,0)
 N HL,HLA,GMRCRES,GMRCHLP
"RTN","GMRCHL7H",83,0)
 M HL=GMRCHL,HLA("HLS")=GMRCM
"RTN","GMRCHL7H",84,0)
 D GENERATE^HLMA(GMRCHL("EID"),"LM",1,.GMRCRES,"",.GMRCHLP)
"RTN","GMRCHL7H",85,0)
 Q
"RTN","GMRCHL7H",86,0)
NTE(HL) ;Find Reason for Request for New or Resubmit entries, Find TIU for complete, find Activity Comment for others
"RTN","GMRCHL7H",87,0)
 N NTECNT,X S NTECNT=1
"RTN","GMRCHL7H",88,0)
 I (MSGTYP="ORR"&(MSGTYP2'="DR"))!((MSGTYP3="IP")&'$G(OKFROM)) D  Q
"RTN","GMRCHL7H",89,0)
 .D AUTHDTTM
"RTN","GMRCHL7H",90,0)
 .S ZCNT=ZCNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"|P|Reason for Request"
"RTN","GMRCHL7H",91,0)
 .S I=0 F  S I=$O(@GDATA@(20,I)) Q:'I  S X=@GDATA@(20,I) Q:X["^TMP"  D
"RTN","GMRCHL7H",92,0)
 ..S X=$$TRIM^XLFSTR(X) I $L(X)=0 Q
"RTN","GMRCHL7H",93,0)
 ..I X=$C(9,9) Q
"RTN","GMRCHL7H",94,0)
 ..D HL7TXT^GMRCHL7P(.X,.HL,"\")
"RTN","GMRCHL7H",95,0)
 ..S ZCNT=ZCNT+1,NTECNT=NTECNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||"_X
"RTN","GMRCHL7H",96,0)
 ..Q
"RTN","GMRCHL7H",97,0)
 .Q
"RTN","GMRCHL7H",98,0)
 ; Build NTE for CM^ADDENDED
"RTN","GMRCHL7H",99,0)
 I MSGTYP2="XX",MSGTYP3="CM" D  Q
"RTN","GMRCHL7H",100,0)
 .N GMRCN,GMRCTXT,GMRCCMP,GMRCASTR
"RTN","GMRCHL7H",101,0)
 .D AUTHDTTM
"RTN","GMRCHL7H",102,0)
 .S ZCNT=ZCNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"|P|Progress Note"
"RTN","GMRCHL7H",103,0)
 .S GMRCN=$P($G(^GMR(123,GMRCDA,50,1,0)),U) I GMRCN'["TIU(8925," Q
"RTN","GMRCHL7H",104,0)
 .D TGET^TIUSRVR1(.GMRCTXT,$S(+$G(GMRCPARN):+GMRCPARN,+$G(TIUDA):+TIUDA,1:+GMRCN),"VIEW")
"RTN","GMRCHL7H",105,0)
 .;
"RTN","GMRCHL7H",106,0)
 .S GMRCCMP=$$DATE($P($G(^TIU(8925,+TIUDA,13)),U),"MM/DD/CCYY")_" ADDENDUM"_"                      STATUS: "_$$GET1^DIQ(8925,+TIUDA_",",.05)
"RTN","GMRCHL7H",107,0)
 .S (I,GMRCASTR)=0
"RTN","GMRCHL7H",108,0)
 .F  S I=$O(@GMRCTXT@(I)) Q:I=""  S X=@GMRCTXT@(I) D
"RTN","GMRCHL7H",109,0)
 ..I X=GMRCCMP S GMRCASTR=I
"RTN","GMRCHL7H",110,0)
 .;
"RTN","GMRCHL7H",111,0)
 .I GMRCASTR D
"RTN","GMRCHL7H",112,0)
 ..S I=GMRCASTR-1
"RTN","GMRCHL7H",113,0)
 ..F  S I=$O(@GMRCTXT@(I)) Q:I=""  S X=@GMRCTXT@(I) D
"RTN","GMRCHL7H",114,0)
 ...S X=$$TRIM^XLFSTR(X) I $L(X)=0 Q
"RTN","GMRCHL7H",115,0)
 ...D HL7TXT^GMRCHL7P(.X,.HL,"\")
"RTN","GMRCHL7H",116,0)
 ...S ZCNT=ZCNT+1,NTECNT=NTECNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||"_X
"RTN","GMRCHL7H",117,0)
 .K ^TMP("TIUVIEW",$J) ;clean up results of TIUSRVR1 call
"RTN","GMRCHL7H",118,0)
 ;
"RTN","GMRCHL7H",119,0)
 I MSGTYP3="CM" D  Q
"RTN","GMRCHL7H",120,0)
 .N GMRCN,GMRCTXT
"RTN","GMRCHL7H",121,0)
 .D AUTHDTTM
"RTN","GMRCHL7H",122,0)
 .S ZCNT=ZCNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"|P|Progress Note"
"RTN","GMRCHL7H",123,0)
 .S GMRCN=$P($G(^GMR(123,GMRCDA,50,1,0)),U) I GMRCN'["TIU(8925," Q
"RTN","GMRCHL7H",124,0)
 .D TGET^TIUSRVR1(.GMRCTXT,$S(+$G(TIUDA):+TIUDA,1:+GMRCN),"VIEW") S I=0
"RTN","GMRCHL7H",125,0)
 .F  S I=$O(@GMRCTXT@(I)) Q:I=""  S X=@GMRCTXT@(I) D
"RTN","GMRCHL7H",126,0)
 ..S X=$$TRIM^XLFSTR(X) I $L(X)=0 Q
"RTN","GMRCHL7H",127,0)
 ..D HL7TXT^GMRCHL7P(.X,.HL,"\")
"RTN","GMRCHL7H",128,0)
 ..S ZCNT=ZCNT+1,NTECNT=NTECNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||"_X
"RTN","GMRCHL7H",129,0)
 ..Q
"RTN","GMRCHL7H",130,0)
 .K ^TMP("TIUVIEW",$J) ;clean up results of TIUSRVR1 call
"RTN","GMRCHL7H",131,0)
 .Q
"RTN","GMRCHL7H",132,0)
 I (MSGTYP2="DR") D  Q
"RTN","GMRCHL7H",133,0)
 .N ORIEN,CMT
"RTN","GMRCHL7H",134,0)
 .D AUTHDTTM
"RTN","GMRCHL7H",135,0)
 .S ZCNT=ZCNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"|L|Activity Comment"
"RTN","GMRCHL7H",136,0)
 .S ORIEN=$G(@GDATA@(.03,"I")) I 'ORIEN Q
"RTN","GMRCHL7H",137,0)
 .S CMT=$$GET1^DIQ(100,ORIEN_",",64),CMT=$$TRIM^XLFSTR(CMT)
"RTN","GMRCHL7H",138,0)
 .D HL7TXT^GMRCHL7P(.CMT,.HL,"\")
"RTN","GMRCHL7H",139,0)
 .S ZCNT=ZCNT+1,GMRCM(ZCNT)="NTE|2||"_CMT
"RTN","GMRCHL7H",140,0)
 .Q
"RTN","GMRCHL7H",141,0)
 N ACT,ACTD,ACTIEN,Q
"RTN","GMRCHL7H",142,0)
 S Q=0,ACTIEN=9999 F  S ACTIEN=$O(^GMR(123,GMRCDA,40,ACTIEN),-1) Q:'ACTIEN!Q  S X=$G(^GMR(123,GMRCDA,40,ACTIEN,0)) D
"RTN","GMRCHL7H",143,0)
 .S ACT=$P(X,U,2),ACTD=$P($P($G(^GMR(123.1,+ACT,0)),U)," ")
"RTN","GMRCHL7H",144,0)
 .I $P($P(STATUS,ECH,2)," ")'=ACTD Q
"RTN","GMRCHL7H",145,0)
 .I +$O(^GMR(123,GMRCDA,40,ACTIEN,1,0)) D AUTHDTTM
"RTN","GMRCHL7H",146,0)
 .S I=0 F  S I=$O(^GMR(123,GMRCDA,40,ACTIEN,1,I)) Q:'I  S X=$G(^GMR(123,GMRCDA,40,ACTIEN,1,I,0)) D
"RTN","GMRCHL7H",147,0)
 ..I 'Q S ZCNT=ZCNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"|L|Activity Comment",Q=1
"RTN","GMRCHL7H",148,0)
 ..S X=$$TRIM^XLFSTR(X) I $L(X)=0 Q
"RTN","GMRCHL7H",149,0)
 ..D HL7TXT^GMRCHL7P(.X,.HL,"\")
"RTN","GMRCHL7H",150,0)
 ..S ZCNT=ZCNT+1,NTECNT=NTECNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||"_X
"RTN","GMRCHL7H",151,0)
 ..Q
"RTN","GMRCHL7H",152,0)
 .Q
"RTN","GMRCHL7H",153,0)
 Q
"RTN","GMRCHL7H",154,0)
AUTHDTTM ; Add Author and Date/Time to NTE
"RTN","GMRCHL7H",155,0)
 S ACTIEN=$G(ACTIEN,$O(^GMR(123,GMRCDA,40,99999),-1))
"RTN","GMRCHL7H",156,0)
 I '+ACTIEN D  Q
"RTN","GMRCHL7H",157,0)
 .S ZCNT=ZCNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||Author\R\\R\"
"RTN","GMRCHL7H",158,0)
 .S ZCNT=ZCNT+1,NTECNT=NTECNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||Datetime\R\\R\"
"RTN","GMRCHL7H",159,0)
 .S ZCNT=ZCNT+1,NTECNT=NTECNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||Comment\R\\R\"
"RTN","GMRCHL7H",160,0)
 .S NTECNT=4
"RTN","GMRCHL7H",161,0)
 ;
"RTN","GMRCHL7H",162,0)
 S ZCNT=ZCNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||Author\R\\R\"_$$GET1^DIQ(123.02,ACTIEN_","_GMRCDA_",",4)
"RTN","GMRCHL7H",163,0)
 S ZCNT=ZCNT+1,NTECNT=NTECNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||Datetime\R\\R\"_$$FMTHL7^XLFDT($$GET1^DIQ(123.02,ACTIEN_","_GMRCDA_",",2,"I"))
"RTN","GMRCHL7H",164,0)
 S ZCNT=ZCNT+1,NTECNT=NTECNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||Comment\R\\R\"
"RTN","GMRCHL7H",165,0)
 S NTECNT=4
"RTN","GMRCHL7H",166,0)
 Q
"RTN","GMRCHL7H",167,0)
STATUS(T1,T2) ;get status for event
"RTN","GMRCHL7H",168,0)
 ;also add IP^COMMENT when those events are captured
"RTN","GMRCHL7H",169,0)
 I T2="DC"!(T1="DR") Q "DC^DISCONTINUED"
"RTN","GMRCHL7H",170,0)
 I T2="NW" Q "NW^CPRS RELEASED ORDER"
"RTN","GMRCHL7H",171,0)
 I T1="SC"&(T2="SC") Q "SC^RECEIVED"
"RTN","GMRCHL7H",172,0)
 I T1="SC"&(T2="ZC") Q "SC^SCHEDULED"
"RTN","GMRCHL7H",173,0)
 I T1="XX"&(T2="XX") Q "IP^ADDED COMMENT"
"RTN","GMRCHL7H",174,0)
 I T2="CA" Q "CA^CANCELLED"
"RTN","GMRCHL7H",175,0)
 I T2="CM" D
"RTN","GMRCHL7H",176,0)
 .I '+$G(GMRCPARN),'+$G(TIUDA) S GMRCPARN=$P($G(^GMR(123,GMRCDA,50,1,0)),U)
"RTN","GMRCHL7H",177,0)
 .S $P(ORC,FS,4)=$S(+$G(GMRCPARN):+GMRCPARN_";TIU^TIU",+$G(TIUDA):+TIUDA_";TIU^TIU",1:$P(ORC,FS,4))
"RTN","GMRCHL7H",178,0)
 I T1="XX"&(T2="CM") Q "CM^ADDENDED"
"RTN","GMRCHL7H",179,0)
 I T2="CM" Q "CM^COMPLETE"
"RTN","GMRCHL7H",180,0)
 I T1="XX"&(T2="IP")&$G(OKFROM) Q "XX^FORWARDED"
"RTN","GMRCHL7H",181,0)
 I T1="XX"&(T2="IP") Q "IP^RESUBMITTED"
"RTN","GMRCHL7H",182,0)
 Q "UNKNOWN"
"RTN","GMRCHL7H",183,0)
FEE(FEESVC) ;send only if name contains HCPS
"RTN","GMRCHL7H",184,0)
 I $G(FEESVC)="" Q 0
"RTN","GMRCHL7H",185,0)
 N VAL
"RTN","GMRCHL7H",186,0)
 S VAL=0
"RTN","GMRCHL7H",187,0)
 I $$UP^XLFSTR($$GET1^DIQ(123.5,FEESVC,.01,"E"))["HCPS" S VAL=1
"RTN","GMRCHL7H",188,0)
 Q VAL
"RTN","GMRCHL7H",189,0)
COMMENT(GMRCDA) ;send comments on Non VA Care consults to HCP
"RTN","GMRCHL7H",190,0)
 ;create a fake event for HCP since there is no HL7 event passed to GMRC EVSEND OR
"RTN","GMRCHL7H",191,0)
 I '$G(GMRCDA) Q
"RTN","GMRCHL7H",192,0)
 N DFN S DFN=$$GET1^DIQ(123,GMRCDA,.02,"I") I 'DFN,'$D(^DPT(DFN)) Q
"RTN","GMRCHL7H",193,0)
 N T S T(1)="MSH|^~\&|CONSULTS||||||ORM"
"RTN","GMRCHL7H",194,0)
 S T(2)="PID|||"_DFN
"RTN","GMRCHL7H",195,0)
 S T(4)="ORC|XX|"_$$GET1^DIQ(123,GMRCDA,.03,"I")_";"_$$OITEM($$GET1^DIQ(123,GMRCDA,.03,"I"))_"^OR|"_GMRCDA_";GMRC^GMRC||XX|"
"RTN","GMRCHL7H",196,0)
 D EN(.T)
"RTN","GMRCHL7H",197,0)
 Q
"RTN","GMRCHL7H",198,0)
ADDEND(TIUDA) ;send addendums on Non VA Care consults to HCP
"RTN","GMRCHL7H",199,0)
 ;create a fake event for HCP since there is no HL7 event passed to GMRC EVSEND OR
"RTN","GMRCHL7H",200,0)
 I '$G(TIUDA) Q
"RTN","GMRCHL7H",201,0)
 Q:'$D(^TIU(8925,+TIUDA,0))
"RTN","GMRCHL7H",202,0)
 N TIUTYP,DFN,GMRCPARN,GMRCO,GMRCD,GMRCDA,GMRCD1,GMRC8925,T
"RTN","GMRCHL7H",203,0)
 ;
"RTN","GMRCHL7H",204,0)
 ; Quit if not an addendum
"RTN","GMRCHL7H",205,0)
 S TIUTYP=$$GET1^DIQ(8925,TIUDA,.01,"I")
"RTN","GMRCHL7H",206,0)
 I TIUTYP'=81 Q
"RTN","GMRCHL7H",207,0)
 ;
"RTN","GMRCHL7H",208,0)
 S DFN=$$GET1^DIQ(8925,TIUDA,.02,"I")
"RTN","GMRCHL7H",209,0)
 I 'DFN,'$D(^DPT(DFN)) Q
"RTN","GMRCHL7H",210,0)
 ;
"RTN","GMRCHL7H",211,0)
 ; Get parent note IEN, if addendum IEN is passed in:
"RTN","GMRCHL7H",212,0)
 S GMRCPARN=$$GET1^DIQ(8925,TIUDA,.06,"I")
"RTN","GMRCHL7H",213,0)
 ;
"RTN","GMRCHL7H",214,0)
 S (GMRCO,GMRCD)=0
"RTN","GMRCHL7H",215,0)
 F  S GMRCD=$O(^GMR(123,"AD",DFN,GMRCD)) Q:'GMRCD!(GMRCO)  D
"RTN","GMRCHL7H",216,0)
 .S GMRCDA=0
"RTN","GMRCHL7H",217,0)
 .F  S GMRCDA=$O(^GMR(123,"AD",DFN,GMRCD,GMRCDA)) Q:'GMRCDA!(GMRCO)  D
"RTN","GMRCHL7H",218,0)
 ..S GMRCD1=0
"RTN","GMRCHL7H",219,0)
 ..F  S GMRCD1=$O(^GMR(123,GMRCDA,50,GMRCD1)) Q:'GMRCD1!(GMRCO)  D
"RTN","GMRCHL7H",220,0)
 ...S GMRC8925=$$GET1^DIQ(123.03,GMRCD1_","_GMRCDA_",",.01,"I")
"RTN","GMRCHL7H",221,0)
 ...I +GMRC8925=$S(+GMRCPARN:+GMRCPARN,1:TIUDA) S GMRCO=GMRCDA
"RTN","GMRCHL7H",222,0)
 Q:'GMRCO
"RTN","GMRCHL7H",223,0)
 ;
"RTN","GMRCHL7H",224,0)
 S T(1)="MSH|^~\&|CONSULTS||||||ORM"
"RTN","GMRCHL7H",225,0)
 S T(2)="PID|||"_DFN
"RTN","GMRCHL7H",226,0)
 S T(4)="ORC|XX|"_$$GET1^DIQ(123,GMRCO,.03,"I")_";"_$$OITEM($$GET1^DIQ(123,GMRCO,.03,"I"))_"^OR|"_GMRCO_";GMRC^GMRC||CM|"
"RTN","GMRCHL7H",227,0)
 I $$FEE($$GET1^DIQ(123,GMRCO,1,"I")) D EN(.T)
"RTN","GMRCHL7H",228,0)
 Q
"RTN","GMRCHL7H",229,0)
TIME(X,FMT) ; Copied from $$TIME^TIULS
"RTN","GMRCHL7H",230,0)
 ; Recieves X as 2910419.01 and FMT=Return Format of time (HH:MM:SS).
"RTN","GMRCHL7H",231,0)
 N HR,MIN,SEC,TIUI
"RTN","GMRCHL7H",232,0)
 I $S('$D(FMT):1,'$L(FMT):1,1:0) S FMT="HR:MIN"
"RTN","GMRCHL7H",233,0)
 S X=$P(X,".",2),HR=$E(X,1,2)_$E("00",0,2-$L($E(X,1,2))),MIN=$E(X,3,4)_$E("00",0,2-$L($E(X,3,4))),SEC=$E(X,5,6)_$E("00",0,2-$L($E(X,5,6)))
"RTN","GMRCHL7H",234,0)
 F TIUI="HR","MIN","SEC" S:FMT[TIUI FMT=$P(FMT,TIUI)_@TIUI_$P(FMT,TIUI,2)
"RTN","GMRCHL7H",235,0)
 Q FMT
"RTN","GMRCHL7H",236,0)
DATE(X,FMT) ; Copied from $$DATE^TIULS
"RTN","GMRCHL7H",237,0)
 ; Call with X=2910419.01 and FMT=Return Format of date ("MM/DD")
"RTN","GMRCHL7H",238,0)
 N AMTH,MM,CC,DD,YY,TIUI,TIUTMP
"RTN","GMRCHL7H",239,0)
 I +X'>0 S $P(TIUTMP," ",$L($G(FMT))+1)="",FMT=TIUTMP G QDATE
"RTN","GMRCHL7H",240,0)
 I $S('$D(FMT):1,'$L(FMT):1,1:0) S FMT="MM/DD/YY"
"RTN","GMRCHL7H",241,0)
 S MM=$E(X,4,5),DD=$E(X,6,7),YY=$E(X,2,3),CC=17+$E(X)
"RTN","GMRCHL7H",242,0)
 S:FMT["AMTH" AMTH=$P("JAN^FEB^MAR^APR^MAY^JUN^JUL^AUG^SEP^OCT^NOV^DEC","^",+MM)
"RTN","GMRCHL7H",243,0)
 F TIUI="AMTH","MM","DD","CC","YY" S:FMT[TIUI FMT=$P(FMT,TIUI)_@TIUI_$P(FMT,TIUI,2)
"RTN","GMRCHL7H",244,0)
 I FMT["HR" S FMT=$$TIME(X,FMT)
"RTN","GMRCHL7H",245,0)
QDATE Q FMT
"RTN","GMRCHL7H",246,0)
OITEM(GMRCORDN) ; Orderable Item
"RTN","GMRCHL7H",247,0)
 N RETVAL,GMRCOITM
"RTN","GMRCHL7H",248,0)
 S RETVAL=1
"RTN","GMRCHL7H",249,0)
 S GMRCOITM=+$O(^OR(100,GMRCORDN,.1,0))
"RTN","GMRCHL7H",250,0)
 I GMRCOITM D
"RTN","GMRCHL7H",251,0)
 .S RETVAL=+$G(^OR(100,GMRCORDN,.1,GMRCOITM,0))
"RTN","GMRCHL7H",252,0)
 .I 'RETVAL S RETVAL=1
"RTN","GMRCHL7H",253,0)
 Q RETVAL
"RTN","GMRCHL7H",254,0)
ACK ; Process ACK HL7 messages
"RTN","GMRCHL7H",255,0)
 N GMRCMSG,I,X,DONE,MSGID,ERRARY,ERRI
"RTN","GMRCHL7H",256,0)
 ;Get the message
"RTN","GMRCHL7H",257,0)
 S ERRI=0
"RTN","GMRCHL7H",258,0)
 F I=1:1 X HLNEXT Q:(HLQUIT'>0)  D
"RTN","GMRCHL7H",259,0)
 . S GMRCMSG(I,1)=HLNODE
"RTN","GMRCHL7H",260,0)
 . S X=0 F  S X=+$O(HLNODE(X)) Q:'X  S GMRCMSG(I,(X+1))=HLNODE(X)
"RTN","GMRCHL7H",261,0)
 S DONE=0
"RTN","GMRCHL7H",262,0)
 S I=0 F  S I=$O(GMRCMSG(I)) Q:'+I  D  Q:DONE
"RTN","GMRCHL7H",263,0)
 . I $P($G(GMRCMSG(I,1)),"|",1)="MSA" D  Q
"RTN","GMRCHL7H",264,0)
 . . I $P($G(GMRCMSG(I,1)),"|",2)="AA" S DONE=1 Q
"RTN","GMRCHL7H",265,0)
 . . S MSGID=$P($G(GMRCMSG(I,1)),"|",3)
"RTN","GMRCHL7H",266,0)
 . I $P($G(GMRCMSG(I,1)),"|",1)="ERR" D
"RTN","GMRCHL7H",267,0)
 . . ;Process Error
"RTN","GMRCHL7H",268,0)
 . . S ERRI=ERRI+1
"RTN","GMRCHL7H",269,0)
 . . S ERRARY(ERRI,2)=$P($G(GMRCMSG(I,1)),"|",3)
"RTN","GMRCHL7H",270,0)
 . . I $P($G(GMRCMSG(I,1)),"|",6)'="" D  Q
"RTN","GMRCHL7H",271,0)
 . . . S ERRARY(ERRI,3)=$P($P($G(GMRCMSG(I,1)),"|",6),"^",4)_"^"_$P($P($G(GMRCMSG(I,1)),"|",6),"^",5)
"RTN","GMRCHL7H",272,0)
 . . S ERRARY(ERRI,3)=$P($G(GMRCMSG(I,1)),"|",4)
"RTN","GMRCHL7H",273,0)
 I $D(ERRARY) D MESSAGE(MSGID,.ERRARY)
"RTN","GMRCHL7H",274,0)
 Q
"RTN","GMRCHL7H",275,0)
MESSAGE(MSGID,ERRARY) ; Send a MailMan Message with the errors
"RTN","GMRCHL7H",276,0)
 N MSGTEXT,DUZ,XMDUZ,XMSUB,XMTEXT,XMY,XMMG,XMSTRIP,XMROU,DIFROM,XMYBLOB,XMZ,XMMG,DATE,J
"RTN","GMRCHL7H",277,0)
 S DATE=$$FMTE^XLFDT($$FMDATE^HLFNC($P(HL("DTM"),"-",1)))
"RTN","GMRCHL7H",278,0)
 S XMSUB="GMRC Consults to HCP HL7 Error"
"RTN","GMRCHL7H",279,0)
 S MSGTEXT(1)=" "
"RTN","GMRCHL7H",280,0)
 S MSGTEXT(2)="Error in transmitting HL7 message to HCP"
"RTN","GMRCHL7H",281,0)
 S MSGTEXT(3)="Date:       "_DATE
"RTN","GMRCHL7H",282,0)
 S MSGTEXT(4)="Message ID: "_MSGID
"RTN","GMRCHL7H",283,0)
 S MSGTEXT(5)="Error(s):"
"RTN","GMRCHL7H",284,0)
 S I=0,J=5 F  S I=$O(ERRARY(I)) Q:'I  D
"RTN","GMRCHL7H",285,0)
 . S J=J+1,MSGTEXT(J)=" "
"RTN","GMRCHL7H",286,0)
 . S J=J+1,MSGTEXT(J)="   "_$P($G(ERRARY(I,3)),U)_" - "_$P($G(ERRARY(I,3)),U,2)
"RTN","GMRCHL7H",287,0)
 . I $P($G(ERRARY(I,2)),U,1)'="" S J=J+1,MSGTEXT(J)="      Segment:       "_$P($G(ERRARY(I,2)),U,1)
"RTN","GMRCHL7H",288,0)
 . I $P($G(ERRARY(I,2)),U,2)'="" S J=J+1,MSGTEXT(J)="      Sequence:      "_$P($G(ERRARY(I,2)),U,2)
"RTN","GMRCHL7H",289,0)
 . I $P($G(ERRARY(I,2)),U,3)'="" S J=J+1,MSGTEXT(J)="      Field:         "_$P($G(ERRARY(I,2)),U,3)
"RTN","GMRCHL7H",290,0)
 . I $P($G(ERRARY(I,2)),U,4)'="" S J=J+1,MSGTEXT(J)="      Fld Rep:       "_$P($G(ERRARY(I,2)),U,4)
"RTN","GMRCHL7H",291,0)
 . I $P($G(ERRARY(I,2)),U,5)'="" S J=J+1,MSGTEXT(J)="      Component:     "_$P($G(ERRARY(I,2)),U,5)
"RTN","GMRCHL7H",292,0)
 . I $P($G(ERRARY(I,2)),U,6)'="" S J=J+1,MSGTEXT(J)="      Sub-component: "_$P($G(ERRARY(I,2)),U,6)
"RTN","GMRCHL7H",293,0)
 S XMTEXT="MSGTEXT("
"RTN","GMRCHL7H",294,0)
 S XMDUZ="GMRC->HCP Transaction Error"
"RTN","GMRCHL7H",295,0)
 S XMY("G.GMRC HCP HL7 MESSAGES")=""
"RTN","GMRCHL7H",296,0)
 D ^XMD
"RTN","GMRCHL7H",297,0)
 Q
"RTN","GMRCP85")
0^^B77500247^n/a
"RTN","GMRCP85",1,0)
GMRCP85 ;WAT - Post-install for GMRC*3.0*85 ;12/22/15  07:21
"RTN","GMRCP85",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**85**;DEC 27, 1997;Build 3
"RTN","GMRCP85",3,0)
 ;;ICR 6257 - GMRC READ OF OR(100 GLOBAL
"RTN","GMRCP85",4,0)
 ;;10061 VADPT (DEM and KVA)
"RTN","GMRCP85",5,0)
 ;;10104 XLFSTR ;;10103 XLFDT ;;10141 XPDUTL ;;1131 ^XMB("NETNAME")
"RTN","GMRCP85",6,0)
 ;;10063 ZTLOAD
"RTN","GMRCP85",7,0)
 ;;3169 ^ORD(101.43 ;;873 ^ORD(100.98
"RTN","GMRCP85",8,0)
 ;; ZT* TaskMan variables
"RTN","GMRCP85",9,0)
 Q
"RTN","GMRCP85",10,0)
RECIP ;RECIPIENTS
"RTN","GMRCP85",11,0)
 K:$D(^XTMP("GMRCP85RECIPS")) ^XTMP("GMRCP85RECIPS")
"RTN","GMRCP85",12,0)
 W !,$$CJ^XLFSTR("*** REJECTED CONSULT/PROCEDURE ORDERS REPORT ",80," "),!
"RTN","GMRCP85",13,0)
 W $$CJ^XLFSTR("DATE DEFAULT VALUE REPORT QUESTIONS ***",80," "),!
"RTN","GMRCP85",14,0)
 W !,"The post-install will create the REJECTED CONSULT/PROCEDURE ORDERS",!
"RTN","GMRCP85",15,0)
 W "REPORT, which contains orders rejected by Consults with the message:",!
"RTN","GMRCP85",16,0)
 W "   Code not valid for Coding System",!!
"RTN","GMRCP85",17,0)
 W "The installer MUST include the site's local Clinical Application Coordinators",!
"RTN","GMRCP85",18,0)
 W "(CACs) or other identified points-of-contact as recipients of this report.",!!
"RTN","GMRCP85",19,0)
 W !!,"Please select the recipients for the REJECTED CONSULT/PROCEDURE ORDERS REPORT",!
"RTN","GMRCP85",20,0)
 W "below."
"RTN","GMRCP85",21,0)
 N XMDUZ,XMDF,XMMG,X,XMOUT,XMY
"RTN","GMRCP85",22,0)
 S XMDUZ=DUZ
"RTN","GMRCP85",23,0)
 D DES^XMA21 ;ICR #10067
"RTN","GMRCP85",24,0)
 I $D(XMY)>9 D
"RTN","GMRCP85",25,0)
 .S ^XTMP("GMRCP85RECIPS",0)=$$FMADD^XLFDT(DT,31)_U_DT_U_"RECIPIENTS OF REJECTED CONSULT/PROCEDURE ORDERS REPORT"
"RTN","GMRCP85",26,0)
 .M ^XTMP("GMRCP85RECIPS")=XMY
"RTN","GMRCP85",27,0)
 Q
"RTN","GMRCP85",28,0)
PRE ; pre-init
"RTN","GMRCP85",29,0)
 D RECIP
"RTN","GMRCP85",30,0)
 Q
"RTN","GMRCP85",31,0)
POST ; post init
"RTN","GMRCP85",32,0)
 N GMRCPOST
"RTN","GMRCP85",33,0)
 S GMRCPOST=1
"RTN","GMRCP85",34,0)
 D QUEUE("find rejected gmrc orders report","ORDSRCH^GMRCP85","FILE #100 SEARCH FOR ORDERS REJECTED BY GMRC")
"RTN","GMRCP85",35,0)
 Q
"RTN","GMRCP85",36,0)
 ;
"RTN","GMRCP85",37,0)
RESTART ;index redux
"RTN","GMRCP85",38,0)
 W !,"Queueing file 100 search..."
"RTN","GMRCP85",39,0)
 D QUEUE("GMRC*3.0*85 file #100 search","ORDSRCH^GMRCP85","FILE #100 SEARCH FOR ORDERS REJECTED BY GMRC")
"RTN","GMRCP85",40,0)
 Q
"RTN","GMRCP85",41,0)
QUEUE(GMRCMSG,ZTRTN,ZTDESC) ;CREATE A SPECIFIED TASK
"RTN","GMRCP85",42,0)
 ;PARAMETERS: GMRCMSG    => STRING CONTAINING THE TEXT TO OUTPUT TO THE SCREEN
"RTN","GMRCP85",43,0)
 ;            ZTRTN    => STRING CONTAINING THE ROUTINE TASKMAN SHOULD EXECUTE
"RTN","GMRCP85",44,0)
 ;            ZTDESC   => STRING CONTAINING THE TASK'S DESCRIPTION
"RTN","GMRCP85",45,0)
 N ZTDTH,ZTIO,ZTSK
"RTN","GMRCP85",46,0)
 D BMES^XPDUTL("Queueing "_GMRCMSG_"...")
"RTN","GMRCP85",47,0)
 S ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,0,10)
"RTN","GMRCP85",48,0)
 S ZTIO=""
"RTN","GMRCP85",49,0)
 D ^%ZTLOAD
"RTN","GMRCP85",50,0)
 I +$G(ZTSK)=0 D
"RTN","GMRCP85",51,0)
 .I $G(GMRCPOST) D BMES^XPDUTL("Unable to queue the "_GMRCMSG_"; file a Remedy ticket for assistance.")
"RTN","GMRCP85",52,0)
 .E  W "ERROR",!,"Unable to queue the "_GMRCMSG_"; file a Remedy ticket for assistance.",!
"RTN","GMRCP85",53,0)
 E  D
"RTN","GMRCP85",54,0)
 .I $G(GMRCPOST) D
"RTN","GMRCP85",55,0)
 ..D BMES^XPDUTL("DONE - Task #"_ZTSK)
"RTN","GMRCP85",56,0)
 .E  W "DONE",!,"Task #"_ZTSK,!
"RTN","GMRCP85",57,0)
 Q
"RTN","GMRCP85",58,0)
 ;
"RTN","GMRCP85",59,0)
ORDSRCH ;find rejected consult/procedure orders
"RTN","GMRCP85",60,0)
 K ^XTMP("GMRCP85_ORDERS")
"RTN","GMRCP85",61,0)
 S ^XTMP("GMRCP85_ORDERS",0)=$$FMADD^XLFDT(DT,31)_U_DT_U_"REJECTED ORDERS FOUND BY GMRC*3.0*85"
"RTN","GMRCP85",62,0)
 N GMRCON,GMRCPROC,DISPGRP,GMRCIFN,DCTXT,COUNT,GMRCREP,GMRCSTAT,DFN,GMRCNAME,GMRCSVC,GMRCDATE,LOOPCNT
"RTN","GMRCP85",63,0)
 S COUNT=1,LOOPCNT=0
"RTN","GMRCP85",64,0)
 S GMRCON="",GMRCON=$O(^ORD(100.98,"B","CONSULTS",""))
"RTN","GMRCP85",65,0)
 S GMRCPROC="",GMRCPROC=$O(^ORD(100.98,"B","PROCEDURES",""))
"RTN","GMRCP85",66,0)
 N STRTDATE S STRTDATE=3150901
"RTN","GMRCP85",67,0)
 I $D(^XTMP("GMRCP85","OR100AF","DATE")) S STRTDATE=^XTMP("GMRCP85","OR100AF","DATE") ;restart search from last date referenced
"RTN","GMRCP85",68,0)
 N GMRCIDX S GMRCIDX=$Q(^OR(100,"AF",STRTDATE))
"RTN","GMRCP85",69,0)
 F  S GMRCIDX=$Q(@GMRCIDX) Q:GMRCIDX'?1"^OR(100,""AF"",".E!($G(ZTSTOP)=1)  D
"RTN","GMRCP85",70,0)
 .S GMRCIFN=$P(GMRCIDX,",",4) Q:+$G(GMRCIFN)'>0
"RTN","GMRCP85",71,0)
 .S DISPGRP=$P(^OR(100,GMRCIFN,0),U,11) ;DISPLAY GROUP
"RTN","GMRCP85",72,0)
 .Q:DISPGRP'=GMRCON&(DISPGRP'=GMRCPROC)
"RTN","GMRCP85",73,0)
 .Q:$D(^OR(100,GMRCIFN,6))=0  ;not rejected
"RTN","GMRCP85",74,0)
 .Q:$P(^OR(100,GMRCIFN,6),U)'=7  ;REJECTED
"RTN","GMRCP85",75,0)
 .S DCTXT=$P(^OR(100,GMRCIFN,6),U,5) ;DC REASON TEXT
"RTN","GMRCP85",76,0)
 .Q:$G(DCTXT)'["Code not valid for Coding System"
"RTN","GMRCP85",77,0)
 .S GMRCSVC=""
"RTN","GMRCP85",78,0)
 .I $D(^OR(100,GMRCIFN,4.5,"ID","SERVICE")) D
"RTN","GMRCP85",79,0)
 ..S GMRCSVC=$O(^OR(100,GMRCIFN,4.5,"ID","SERVICE",0))
"RTN","GMRCP85",80,0)
 ..S GMRCSVC=^OR(100,GMRCIFN,4.5,GMRCSVC,1) S GMRCSVC=$P(^GMR(123.5,GMRCSVC,0),U)
"RTN","GMRCP85",81,0)
 .I $G(GMRCSVC)="" D
"RTN","GMRCP85",82,0)
 ..S GMRCSVC=$$FINDSVC(.GMRCIFN)  S:+$G(GMRCSVC)="" GMRCSVC="NOT FOUND"
"RTN","GMRCP85",83,0)
 .S GMRCNAME=$P(^OR(100,GMRCIFN,0),U,2) Q:$G(GMRCNAME)'["DPT"
"RTN","GMRCP85",84,0)
 .S DFN=+$G(GMRCNAME)
"RTN","GMRCP85",85,0)
 .D DEM^VADPT ;get pt name and last 4
"RTN","GMRCP85",86,0)
 .S GMRCDATE=$P(^OR(100,GMRCIFN,0),U,7) ;to service
"RTN","GMRCP85",87,0)
 .S ^XTMP("GMRCP85_ORDERS",VADM(1)_" ("_VA("BID")_")",COUNT)=VADM(1)_"("_VA("BID")_")"_U_GMRCSVC_U_GMRCDATE_U_GMRCIFN,COUNT=COUNT+1 ;name + last 4
"RTN","GMRCP85",88,0)
 .D KVA^VADPT
"RTN","GMRCP85",89,0)
 .S LOOPCNT=LOOPCNT+1
"RTN","GMRCP85",90,0)
 .I LOOPCNT#500=0,($$S^%ZTLOAD) N X S ZTSTOP=1,X=$$S^%ZTLOAD("Received shutdown request")
"RTN","GMRCP85",91,0)
 ;SEND STATUS EMAIL
"RTN","GMRCP85",92,0)
 I +$G(ZTSTOP)=0 D
"RTN","GMRCP85",93,0)
 .S GMRCREP(1)="The file #100 search process from GMRC*3.0*85 was successfully completed."
"RTN","GMRCP85",94,0)
 .S GMRCREP(2)=""
"RTN","GMRCP85",95,0)
 .D OUTPUT
"RTN","GMRCP85",96,0)
 E  D
"RTN","GMRCP85",97,0)
 .K GMRCREP
"RTN","GMRCP85",98,0)
 .S GMRCREP(1)="The file #100 search process from GMRC*3.0*85 has unexpectedly stopped."
"RTN","GMRCP85",99,0)
 .S GMRCREP(2)="If you or the system manager did not stop the process, please check the"
"RTN","GMRCP85",100,0)
 .S GMRCREP(3)="error log and file a Remedy ticket for assistance."
"RTN","GMRCP85",101,0)
 .S GMRCREP(4)=""
"RTN","GMRCP85",102,0)
 .S GMRCREP(5)="To requeue the cleanup/conversion process, run RESTART^GMRCP85 from the"
"RTN","GMRCP85",103,0)
 .S GMRCREP(6)="programmer prompt."
"RTN","GMRCP85",104,0)
 S GMRCSTAT=$$MAIL("GMRCREP(","PATCH GMRC*3.0*85 ORDER SEARCH STATUS",,"GMRCP85RECIPS")
"RTN","GMRCP85",105,0)
 I +GMRCSTAT,($G(ZTSTOP)=1) D
"RTN","GMRCP85",106,0)
 .S ^XTMP("GMRCP85",0)=$$FMADD^XLFDT($$NOW^XLFDT,7,0,0,0)_U_$$NOW^XLFDT_U_"GMRC*3.0*85 POST-INSTALL DATA"
"RTN","GMRCP85",107,0)
 .S ^XTMP("GMRCP85","OR100AF","DATE")=$P(GMRCIDX,",",3) ;capture last date referenced to restart search from.
"RTN","GMRCP85",108,0)
 S ZTREQ="@"
"RTN","GMRCP85",109,0)
 Q
"RTN","GMRCP85",110,0)
FINDSVC(GMRCIFN) ; service not directly accessbile in the OR(100 entry, go find it
"RTN","GMRCP85",111,0)
 N GMRCSERV,GMRCODBL,GMRCPROC S GMRCSERV=""
"RTN","GMRCP85",112,0)
 ;GMRSERV - CONSULT SERVICE
"RTN","GMRCP85",113,0)
 ;GMRCODBL - ORDERABLE ITEM FROM OR(100
"RTN","GMRCP85",114,0)
 I $D(^OR(100,GMRCIFN,.1,1,0)) D
"RTN","GMRCP85",115,0)
 .S GMRCODBL=^OR(100,GMRCIFN,.1,1,0)
"RTN","GMRCP85",116,0)
 I $D(^ORD(101.43,$G(GMRCODBL),0)) D
"RTN","GMRCP85",117,0)
 .S GMRCODBL=$P(^ORD(101.43,$G(GMRCODBL),0),U,2) ; service IEN;99CON or procedure IEN;99PRC
"RTN","GMRCP85",118,0)
 .I $G(GMRCODBL)["CON" S GMRCSERV=$P(GMRCODBL,";") I $D(^GMR(123.5,GMRCSERV,0)) S GMRCSERV=$P(^GMR(123.5,GMRCSERV,0),U) Q
"RTN","GMRCP85",119,0)
 .I $G(GMRCODBL)["PRC" D
"RTN","GMRCP85",120,0)
 ..S GMRCPROC=$P(GMRCODBL,";")
"RTN","GMRCP85",121,0)
 ..I $D(^GMR(123.3,GMRCPROC)) D
"RTN","GMRCP85",122,0)
 ...I $D(^GMR(123.3,GMRCPROC,2,1,0)) S GMRCSERV=^GMR(123.3,GMRCPROC,2,1,0) Q
"RTN","GMRCP85",123,0)
 Q GMRCSERV
"RTN","GMRCP85",124,0)
 ;
"RTN","GMRCP85",125,0)
OUTPUT ;add data to message array
"RTN","GMRCP85",126,0)
 I '$D(^XTMP("GMRCP85_ORDERS")) D  Q
"RTN","GMRCP85",127,0)
 .S GMRCREP(3)="REPORT DATA NO LONGER AVAILABLE. A NEW SEARCH MUST BE COMPLETED."
"RTN","GMRCP85",128,0)
 .S GMRCREP(4)="SEE GMRC*3.0*85 PATCH DESCRIPTION FOR INSTRUCTIONS."
"RTN","GMRCP85",129,0)
 I $O(^XTMP("GMRCP85_ORDERS",0))="" D  Q
"RTN","GMRCP85",130,0)
 .S GMRCREP(3)="No CONSULT or PROCEDURE orders found with the "
"RTN","GMRCP85",131,0)
 .S GMRCREP(4)="'Code not valid for Coding System' rejection message."
"RTN","GMRCP85",132,0)
 N GMRCINC,GMRCPAT,GMRCSERV,GMRCDATE,GMRCONBR,GMRCNAME,GMRCTEMP,LINECNT,TOTAL
"RTN","GMRCP85",133,0)
 S GMRCINC=0,GMRCPAT="",TOTAL=0
"RTN","GMRCP85",134,0)
 S GMRCREP(3)="PATIENT"
"RTN","GMRCP85",135,0)
 S GMRCREP(4)="  SERVICE"_$$REPEAT^XLFSTR(" ",44)_"   ORDER DATE    ORDER #"
"RTN","GMRCP85",136,0)
 S GMRCREP(5)=$$REPEAT^XLFSTR("-",78)
"RTN","GMRCP85",137,0)
 S LINECNT=6
"RTN","GMRCP85",138,0)
 F  S GMRCPAT=$O(^XTMP("GMRCP85_ORDERS",GMRCPAT)) Q:$G(GMRCPAT)=""   D
"RTN","GMRCP85",139,0)
 .Q:$G(GMRCPAT)=0
"RTN","GMRCP85",140,0)
 .S GMRCREP(LINECNT)=$G(GMRCPAT),LINECNT=LINECNT+1
"RTN","GMRCP85",141,0)
 .F  S GMRCINC=$O(^XTMP("GMRCP85_ORDERS",GMRCPAT,GMRCINC)) Q:+$G(GMRCINC)'>0  D
"RTN","GMRCP85",142,0)
 ..S GMRCSERV=$P(^XTMP("GMRCP85_ORDERS",GMRCPAT,GMRCINC),U,2)
"RTN","GMRCP85",143,0)
 ..S GMRCDATE=$P(^XTMP("GMRCP85_ORDERS",GMRCPAT,GMRCINC),U,3) S GMRCDATE=$$FMTE^XLFDT(GMRCDATE,"2DZ") ;MM/DD/YY
"RTN","GMRCP85",144,0)
 ..S GMRCONBR=$P(^XTMP("GMRCP85_ORDERS",GMRCPAT,GMRCINC),U,4)
"RTN","GMRCP85",145,0)
 ..S GMRCSERV=$E(GMRCSERV,0,53)
"RTN","GMRCP85",146,0)
 ..I $L(GMRCSERV)<53 S GMRCSERV=GMRCSERV_$$REPEAT^XLFSTR(" ",(53-$L(GMRCSERV)))
"RTN","GMRCP85",147,0)
 ..S GMRCREP(LINECNT)="  "_GMRCSERV_$J(GMRCDATE,10)_$J(GMRCONBR,14),LINECNT=LINECNT+1,TOTAL=TOTAL+1
"RTN","GMRCP85",148,0)
 .S GMRCREP(LINECNT)="",LINECNT=LINECNT+1
"RTN","GMRCP85",149,0)
 .S GMRCREP(LINECNT)=""
"RTN","GMRCP85",150,0)
 S GMRCREP(LINECNT)="TOTAL ORDERS FOUND:     "_TOTAL
"RTN","GMRCP85",151,0)
 Q
"RTN","GMRCP85",152,0)
 ;
"RTN","GMRCP85",153,0)
MAIL(XMTEXT,XMSUB,XMY,SUBSCR) ;SEND AN EMAIL
"RTN","GMRCP85",154,0)
 ;PARAMETERS: XMTEXT => STRING CONTAINING NAME OF ARRAY CONTAINING MESSAGE TEXT (REQUIRED)
"RTN","GMRCP85",155,0)
 ;            XMSUB  => STRING CONTAINING THE SUBJECT OF THE MESSAGE (REQUIRED)
"RTN","GMRCP85",156,0)
 ;            XMY    => REFERENCE TO AN ARRAY CONTAINING THE RECIPIENTS (OPTIONAL)
"RTN","GMRCP85",157,0)
 ;            SUBSCR => STRING CONTAINING THE SUBSCIPT WITHIN ^XTMP WHERE RECIPIENTS ARE STORED (OPTIONAL)
"RTN","GMRCP85",158,0)
 ;RETURN: $$MAIL => STRING CONTAINING XMMG (ERROR STRING)^XMERR (NUMBER OF ERRORS)
"RTN","GMRCP85",159,0)
 N XMMG,XMDUZ,XMZ,XMERR,DIFROM,GMRCMSG
"RTN","GMRCP85",160,0)
 Q:'$D(XMTEXT)!($G(XMSUB)="")
"RTN","GMRCP85",161,0)
 I $D(XMY)=0 D
"RTN","GMRCP85",162,0)
 .I $G(SUBSCR)'="",($Q(^XTMP(SUBSCR,0))[SUBSCR) D  Q
"RTN","GMRCP85",163,0)
 ..K ^XTMP(SUBSCR,0)
"RTN","GMRCP85",164,0)
 ..M XMY=^XTMP(SUBSCR)
"RTN","GMRCP85",165,0)
 ..K ^XTMP(SUBSCR)
"RTN","GMRCP85",166,0)
 .I $D(ZTQUEUED)>0 D
"RTN","GMRCP85",167,0)
 ..S XMY(DUZ)=""
"RTN","GMRCP85",168,0)
 .E  D
"RTN","GMRCP85",169,0)
 ..S GMRCMSG(1)=" "
"RTN","GMRCP85",170,0)
 ..S GMRCMSG(2)="Select the recipient(s) of the report below."
"RTN","GMRCP85",171,0)
 ..D MAILOUT(.GMRCMSG)
"RTN","GMRCP85",172,0)
 S XMDUZ="GMRC*3.0*85 Install@"_^XMB("NETNAME")
"RTN","GMRCP85",173,0)
 D ^XMD ;ICR #10070
"RTN","GMRCP85",174,0)
 K GMRCMSG
"RTN","GMRCP85",175,0)
 I $D(XMMG)>0 D
"RTN","GMRCP85",176,0)
 .S GMRCMSG(1)=" "
"RTN","GMRCP85",177,0)
 .S GMRCMSG(2)="Unable to email the report:"
"RTN","GMRCP85",178,0)
 .S GMRCMSG(3)=XMMG
"RTN","GMRCP85",179,0)
 .D MAILOUT(.GMRCMSG)
"RTN","GMRCP85",180,0)
 Q $G(XMMG)_U_$G(XMERR)
"RTN","GMRCP85",181,0)
 ;
"RTN","GMRCP85",182,0)
MAILOUT(MESSAGE) ;OUTPUT THE GMRCMSG ARRAY FROM MAIL LINE TAG
"RTN","GMRCP85",183,0)
 ;IF KIDS IS NOT EXECUTING, OUTPUT THE MESSAGE TO THE SCREEN
"RTN","GMRCP85",184,0)
 I $G(XPDNM)="" D
"RTN","GMRCP85",185,0)
 .N LINE S LINE=0 F  S LINE=$O(MESSAGE(LINE)) Q:+$G(LINE)=0  W MESSAGE(LINE),!
"RTN","GMRCP85",186,0)
 E  D MES^XPDUTL(.MESSAGE)
"RTN","GMRCP85",187,0)
 Q
"RTN","GMRCP85",188,0)
 ;
"RTN","GMRCP85",189,0)
OUTPUT2 ;programmer mode write data to screen
"RTN","GMRCP85",190,0)
 I '$D(^XTMP("GMRCP85_ORDERS")) D  Q
"RTN","GMRCP85",191,0)
 .W !,"REPORT DATA NO LONGER AVAILABLE. A NEW SEARCH MUST BE COMPLETED."
"RTN","GMRCP85",192,0)
 .W !,"SEE GMRC*3.0*85 PATCH DESCRIPTION FOR INSTRUCTIONS."
"RTN","GMRCP85",193,0)
 I $O(^XTMP("GMRCP85_ORDERS",0))="" D  Q
"RTN","GMRCP85",194,0)
 .W !,"No CONSULT or PROCEDURE orders found with the "
"RTN","GMRCP85",195,0)
 .W !,"'Code not valid for Coding System' rejection message."
"RTN","GMRCP85",196,0)
 N GMRCINC,GMRCPAT,GMRCSERV,GMRCDATE,GMRCONBR,GMRCNAME,GMRCTEMP S GMRCINC=0,GMRCPAT=""
"RTN","GMRCP85",197,0)
 D HEADER
"RTN","GMRCP85",198,0)
 F  S GMRCPAT=$O(^XTMP("GMRCP85_ORDERS",GMRCPAT)) Q:$G(GMRCPAT)=""  D
"RTN","GMRCP85",199,0)
 .Q:$G(GMRCPAT)=0
"RTN","GMRCP85",200,0)
 .W !!,$G(GMRCPAT)
"RTN","GMRCP85",201,0)
 .F  S GMRCINC=$O(^XTMP("GMRCP85_ORDERS",GMRCPAT,GMRCINC)) Q:+$G(GMRCINC)'>0  D
"RTN","GMRCP85",202,0)
 ..S GMRCSERV=$P(^XTMP("GMRCP85_ORDERS",GMRCPAT,GMRCINC),U,2)
"RTN","GMRCP85",203,0)
 ..S GMRCDATE=$P(^XTMP("GMRCP85_ORDERS",GMRCPAT,GMRCINC),U,3) S GMRCDATE=$$FMTE^XLFDT(GMRCDATE,"2DZ") ;MM/DD/YY
"RTN","GMRCP85",204,0)
 ..S GMRCONBR=$P(^XTMP("GMRCP85_ORDERS",GMRCPAT,GMRCINC),U,4)
"RTN","GMRCP85",205,0)
 ..I $L(GMRCSERV)<53 S GMRCSERV=GMRCSERV_$$REPEAT^XLFSTR(" ",(53-$L(GMRCSERV)))
"RTN","GMRCP85",206,0)
 ..W !,"  "_GMRCSERV_$J(GMRCDATE,10)_$J(GMRCONBR,14)
"RTN","GMRCP85",207,0)
 Q
"RTN","GMRCP85",208,0)
 ;
"RTN","GMRCP85",209,0)
HEADER ;header
"RTN","GMRCP85",210,0)
 W @IOF
"RTN","GMRCP85",211,0)
 W "PATIENT",!
"RTN","GMRCP85",212,0)
 W "  SERVICE"_$$REPEAT^XLFSTR(" ",44)_"   ORDER DATE    ORDER #"
"RTN","GMRCP85",213,0)
 W !,$$REPEAT^XLFSTR("-",78)
"RTN","GMRCP85",214,0)
 Q
"VER")
8.0^22.0
"BLD",9373,6)
^72
**END**
**END**

