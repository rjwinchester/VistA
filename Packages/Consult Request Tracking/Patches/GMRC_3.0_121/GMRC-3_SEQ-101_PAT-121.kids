Released GMRC*3*121 SEQ #101
Extracted from mail message
**KIDS**:GMRC*3.0*121^

**INSTALL NAME**
GMRC*3.0*121
"BLD",11213,0)
GMRC*3.0*121^CONSULT/REQUEST TRACKING^0^3190221^y
"BLD",11213,1,0)
^^2^2^3190221^^
"BLD",11213,1,1,0)
This patch creates an NTE segment in the ORMO001 message which will
"BLD",11213,1,2,0)
contain the UCID.
"BLD",11213,4,0)
^9.64PA^^
"BLD",11213,6)
1^
"BLD",11213,6.3)
6
"BLD",11213,"ABPKG")
n
"BLD",11213,"KRN",0)
^9.67PA^1.61^23
"BLD",11213,"KRN",.4,0)
.4
"BLD",11213,"KRN",.401,0)
.401
"BLD",11213,"KRN",.402,0)
.402
"BLD",11213,"KRN",.403,0)
.403
"BLD",11213,"KRN",.5,0)
.5
"BLD",11213,"KRN",.84,0)
.84
"BLD",11213,"KRN",1.6,0)
1.6
"BLD",11213,"KRN",1.61,0)
1.61
"BLD",11213,"KRN",1.62,0)
1.62
"BLD",11213,"KRN",3.6,0)
3.6
"BLD",11213,"KRN",3.8,0)
3.8
"BLD",11213,"KRN",9.2,0)
9.2
"BLD",11213,"KRN",9.8,0)
9.8
"BLD",11213,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",11213,"KRN",9.8,"NM",1,0)
GMRCIEVT^^0^B60069903
"BLD",11213,"KRN",9.8,"NM",2,0)
GMRCIACT^^0^B72710395
"BLD",11213,"KRN",9.8,"NM","B","GMRCIACT",2)

"BLD",11213,"KRN",9.8,"NM","B","GMRCIEVT",1)

"BLD",11213,"KRN",19,0)
19
"BLD",11213,"KRN",19.1,0)
19.1
"BLD",11213,"KRN",101,0)
101
"BLD",11213,"KRN",409.61,0)
409.61
"BLD",11213,"KRN",771,0)
771
"BLD",11213,"KRN",779.2,0)
779.2
"BLD",11213,"KRN",870,0)
870
"BLD",11213,"KRN",8989.51,0)
8989.51
"BLD",11213,"KRN",8989.52,0)
8989.52
"BLD",11213,"KRN",8994,0)
8994
"BLD",11213,"KRN","B",.4,.4)

"BLD",11213,"KRN","B",.401,.401)

"BLD",11213,"KRN","B",.402,.402)

"BLD",11213,"KRN","B",.403,.403)

"BLD",11213,"KRN","B",.5,.5)

"BLD",11213,"KRN","B",.84,.84)

"BLD",11213,"KRN","B",1.6,1.6)

"BLD",11213,"KRN","B",1.61,1.61)

"BLD",11213,"KRN","B",1.62,1.62)

"BLD",11213,"KRN","B",3.6,3.6)

"BLD",11213,"KRN","B",3.8,3.8)

"BLD",11213,"KRN","B",9.2,9.2)

"BLD",11213,"KRN","B",9.8,9.8)

"BLD",11213,"KRN","B",19,19)

"BLD",11213,"KRN","B",19.1,19.1)

"BLD",11213,"KRN","B",101,101)

"BLD",11213,"KRN","B",409.61,409.61)

"BLD",11213,"KRN","B",771,771)

"BLD",11213,"KRN","B",779.2,779.2)

"BLD",11213,"KRN","B",870,870)

"BLD",11213,"KRN","B",8989.51,8989.51)

"BLD",11213,"KRN","B",8989.52,8989.52)

"BLD",11213,"KRN","B",8994,8994)

"BLD",11213,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",11213,"QUES",0)
^9.62^^
"BLD",11213,"REQB",0)
^9.611^2^2
"BLD",11213,"REQB",1,0)
GMRC*3.0*31^1
"BLD",11213,"REQB",2,0)
GMRC*3.0*73^1
"BLD",11213,"REQB","B","GMRC*3.0*31",1)

"BLD",11213,"REQB","B","GMRC*3.0*73",2)

"MBREQ")
0
"PKG",406,-1)
1^1
"PKG",406,0)
CONSULT/REQUEST TRACKING^GMRC^CONSULTS/REQUESTS
"PKG",406,22,0)
^9.49I^1^1
"PKG",406,22,1,0)
3.0^2980101^2981113^1
"PKG",406,22,1,"PAH",1,0)
121^3190221^520824650
"PKG",406,22,1,"PAH",1,1,0)
^^2^2^3190221
"PKG",406,22,1,"PAH",1,1,1,0)
This patch creates an NTE segment in the ORMO001 message which will
"PKG",406,22,1,"PAH",1,1,2,0)
contain the UCID.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","GMRCIACT")
0^2^B72710395^B68184742
"RTN","GMRCIACT",1,0)
GMRCIACT ;SLC/JFR - PROCESS ACTIONS ON IFC ;02/15/19  05:42
"RTN","GMRCIACT",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,47,58,66,73,121**;DEC 27, 1997;Build 6
"RTN","GMRCIACT",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","GMRCIACT",4,0)
 ;#2051($$FIND1^DIC), #2053(DIE), #2165 HLMA1, #2701 MPIF001, #10103 XLFDT, #3065 XLFNAME, #2171 XUAF4
"RTN","GMRCIACT",5,0)
 Q  ;don't start here!
"RTN","GMRCIACT",6,0)
NW(ARRAY) ;process and file new order
"RTN","GMRCIACT",7,0)
 ;Input:
"RTN","GMRCIACT",8,0)
 ; ARRAY  = name of array containing message parts
"RTN","GMRCIACT",9,0)
 ;
"RTN","GMRCIACT",10,0)
 N GMRCFDA,GMRCORC,GMRCDA,GMRCITM,GMRCITER,GMRCROUT,GMRCFCN,GMRCLAC
"RTN","GMRCIACT",11,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIACT",12,0)
 M ^TMP("GMRCIN",$J)=@ARRAY
"RTN","GMRCIACT",13,0)
 S GMRCORC=^TMP("GMRCIN",$J,"ORC")
"RTN","GMRCIACT",14,0)
 D  I $D(GMRCITER) Q  ;Check for order already being on file
"RTN","GMRCIACT",15,0)
 . S GMRCFCN=+$P(GMRCORC,"|",2)
"RTN","GMRCIACT",16,0)
 . S GMRCROUT=$$IEN^XUAF4($P($P(GMRCORC,"|",2),U,2))
"RTN","GMRCIACT",17,0)
 . I '$O(^GMR(123,"AIFC",GMRCROUT,GMRCFCN,0)) Q  ;no dup
"RTN","GMRCIACT",18,0)
 . S GMRCITER=802
"RTN","GMRCIACT",19,0)
 . D APPACK^GMRCIAC2(0,"AR",GMRCITER) ;send app. ack w/ error
"RTN","GMRCIACT",20,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIACT",21,0)
 I '$D(^TMP("GMRCIN",$J,"PID")) Q  ;prepare reject message (no PID)
"RTN","GMRCIACT",22,0)
 D  ;get patient DFN from ICN in message
"RTN","GMRCIACT",23,0)
 . N PAT
"RTN","GMRCIACT",24,0)
 . S PAT=$$GETDFN^MPIF001(+$P(^TMP("GMRCIN",$J,"PID"),"|",2))
"RTN","GMRCIACT",25,0)
 . I +PAT'>1 S GMRCFDA(.02)="" Q
"RTN","GMRCIACT",26,0)
 . S GMRCFDA(.02)=+PAT
"RTN","GMRCIACT",27,0)
 I '$G(GMRCFDA(.02)) D  Q  ;reject message, patient is unknown
"RTN","GMRCIACT",28,0)
 . N STA S STA=$P($P(^TMP("GMRCIN",$J,"ORC"),"|",2),U,2)
"RTN","GMRCIACT",29,0)
 . N OBR S OBR=^TMP("GMRCIN",$J,"OBR")
"RTN","GMRCIACT",30,0)
 . D PTERRMSG^GMRCIERR(^TMP("GMRCIN",$J,"PID"),STA,,OBR)
"RTN","GMRCIACT",31,0)
 . D APPACK^GMRCIAC2(0,"AR",201) ; send app. ack w/error
"RTN","GMRCIACT",32,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIACT",33,0)
 D  ;get ordered item and service
"RTN","GMRCIACT",34,0)
 . S GMRCITM=$P(^TMP("GMRCIN",$J,"OBR"),"|",4)
"RTN","GMRCIACT",35,0)
 . I GMRCITM["VA1233" D  ; proc
"RTN","GMRCIACT",36,0)
 .. N PROC
"RTN","GMRCIACT",37,0)
 .. S PROC=$$GETPROC^GMRCIUTL(GMRCITM)
"RTN","GMRCIACT",38,0)
 .. I +PROC'>0!('$P(PROC,U,2)) S GMRCITER=$P(PROC,U,3) Q
"RTN","GMRCIACT",39,0)
 .. S GMRCFDA(4)=$P(PROC,U)_";GMR(123.3,"
"RTN","GMRCIACT",40,0)
 .. S GMRCFDA(1)=$P(PROC,U,2)
"RTN","GMRCIACT",41,0)
 . I GMRCITM["VA1235" D
"RTN","GMRCIACT",42,0)
 .. N SERV
"RTN","GMRCIACT",43,0)
 .. S SERV=$$GETSERV^GMRCIUTL(GMRCITM) ;consult
"RTN","GMRCIACT",44,0)
 .. I +SERV'>0 S GMRCITER=$P(SERV,U,3)
"RTN","GMRCIACT",45,0)
 .. S GMRCFDA(1)=SERV
"RTN","GMRCIACT",46,0)
 I $D(GMRCITER) D  Q  ;error in procedure or service, reject new order
"RTN","GMRCIACT",47,0)
 . D APPACK^GMRCIAC2(0,"AR",GMRCITER) ; send app. ACK
"RTN","GMRCIACT",48,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIACT",49,0)
 ;
"RTN","GMRCIACT",50,0)
 S GMRCFDA(.01)=$$NOW^XLFDT
"RTN","GMRCIACT",51,0)
 S GMRCFDA(3)=$$HL7TFM^XLFDT($P(GMRCORC,"|",15))
"RTN","GMRCIACT",52,0)
 S GMRCFDA(6)=$$FIND1^DIC(101,"","X","GMRCPLACE - ON CALL")
"RTN","GMRCIACT",53,0)
 S GMRCFDA(17)=$$HL7TFM^XLFDT($P($P(GMRCORC,"|",7),U,4)) ;WAT/66 Earliest Date
"RTN","GMRCIACT",54,0)
 D  ;get urgency to file
"RTN","GMRCIACT",55,0)
 . N URG
"RTN","GMRCIACT",56,0)
 . S URG=$$URG^GMRCHL7A($P($P(GMRCORC,"|",7),U,6))
"RTN","GMRCIACT",57,0)
 . S GMRCFDA(5)=$$FIND1^DIC(101,"","X","GMRCURGENCY - "_URG)
"RTN","GMRCIACT",58,0)
 S GMRCFDA(8)=5
"RTN","GMRCIACT",59,0)
 S GMRCFDA(9)=$S($P(GMRCORC,"|",16)["FI":24,1:23),GMRCLAC=GMRCFDA(9)
"RTN","GMRCIACT",60,0)
 S GMRCFDA(14)=$P(^TMP("GMRCIN",$J,"OBR"),"|",18)
"RTN","GMRCIACT",61,0)
 S GMRCFDA(.05)=$$IEN^XUAF4(+$P(GMRCORC,"|",17))
"RTN","GMRCIACT",62,0)
 S GMRCFDA(.06)=GMRCFCN
"RTN","GMRCIACT",63,0)
 S GMRCFDA(.07)=GMRCROUT
"RTN","GMRCIACT",64,0)
 D  ;get and set ordering prov info & entering person info
"RTN","GMRCIACT",65,0)
 . N GMRCOP
"RTN","GMRCIACT",66,0)
 . S GMRCOP=$$FMNAME^XLFNAME($P(GMRCORC,"|",12))
"RTN","GMRCIACT",67,0)
 . Q:'$L(GMRCOP)
"RTN","GMRCIACT",68,0)
 . S GMRCFDA(.126)=GMRCOP
"RTN","GMRCIACT",69,0)
 . Q
"RTN","GMRCIACT",70,0)
 S GMRCFDA(.125)="F"
"RTN","GMRCIACT",71,0)
 I $L($P(GMRCORC,"|",14)) D
"RTN","GMRCIACT",72,0)
 . N GMRCP14 S GMRCP14=$P(GMRCORC,"|",14)
"RTN","GMRCIACT",73,0)
 . S GMRCFDA(.132)=$P(GMRCP14,"B") ; requestor's phone number
"RTN","GMRCIACT",74,0)
 . S GMRCFDA(.133)=$P(GMRCP14,"B",2) ; requestor's dig pager
"RTN","GMRCIACT",75,0)
 S GMRCFDA(13)=$S($D(GMRCFDA(4)):"P",1:"C")
"RTN","GMRCIACT",76,0)
 I $D(^TMP("GMRCIN",$J,"OBX",2)) D
"RTN","GMRCIACT",77,0)
 . N GMRCCSYS,CODINTXT
"RTN","GMRCIACT",78,0)
 . S GMRCFDA(30)=$P($P(^TMP("GMRCIN",$J,"OBX",2,1),"|",5),U,2)
"RTN","GMRCIACT",79,0)
 . S GMRCFDA(30.1)=$P($P(^TMP("GMRCIN",$J,"OBX",2,1),"|",5),U)
"RTN","GMRCIACT",80,0)
 . S GMRCFDA(30.2)=$$HL7TFM^XLFDT($P($P(^TMP("GMRCIN",$J,"OBX",2,1),"|",14),U)) ;date OBX-14 WAT/73
"RTN","GMRCIACT",81,0)
 . S GMRCCSYS=$P($P(^TMP("GMRCIN",$J,"OBX",2,1),"|",5),U,3) ;code system WAT/73
"RTN","GMRCIACT",82,0)
 . S GMRCCSYS=$S($G(GMRCCSYS)="I9C":"ICD",1:"10D")
"RTN","GMRCIACT",83,0)
 . S GMRCFDA(30.3)=GMRCCSYS
"RTN","GMRCIACT",84,0)
 . I $D(GMRCFDA(30.1)) D  ;if dx code exists, ensure that code is removed from dx text
"RTN","GMRCIACT",85,0)
 .. S CODINTXT="("_GMRCFDA(30.1)_")"
"RTN","GMRCIACT",86,0)
 .. I GMRCFDA(30)[CODINTXT D
"RTN","GMRCIACT",87,0)
 ... S GMRCFDA(30)=$E(GMRCFDA(30),0,($L(GMRCFDA(30))-$L(CODINTXT)))
"RTN","GMRCIACT",88,0)
 ... S GMRCFDA(30)=$$TRIM^XLFSTR(GMRCFDA(30),"R")
"RTN","GMRCIACT",89,0)
 ;
"RTN","GMRCIACT",90,0)
 ;BL;121;Adding UCID to FILE #123 FIELD 80
"RTN","GMRCIACT",91,0)
 ;check for NTE segment
"RTN","GMRCIACT",92,0)
 I $D(^TMP("GMRCIN",$J,"NTE")) D
"RTN","GMRCIACT",93,0)
 . N NODE,UCIDNODE
"RTN","GMRCIACT",94,0)
 . S NODE=0
"RTN","GMRCIACT",95,0)
 . F  S NODE=$O(^TMP("GMRCIN",$J,"NTE",NODE))  Q:NODE=""  D
"RTN","GMRCIACT",96,0)
 . . S UCIDNODE=$P(^TMP("GMRCIN",$J,"NTE",NODE),"|",2)
"RTN","GMRCIACT",97,0)
 . . S:UCIDNODE["UCID:" GMRCFDA(80)=$P(UCIDNODE,"UCID:",2)
"RTN","GMRCIACT",98,0)
 ;
"RTN","GMRCIACT",99,0)
 M FDA(1,123,"+1,")=GMRCFDA
"RTN","GMRCIACT",100,0)
 D UPDATE^DIE("","FDA(1)","GMRCDA","GMRCERR")
"RTN","GMRCIACT",101,0)
 I '$D(GMRCDA) D  Q  ;couldn't get new consult #
"RTN","GMRCIACT",102,0)
 . D APPACK^GMRCIAC2(0,"AR",901) ; send app. ACK
"RTN","GMRCIACT",103,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIACT",104,0)
 K GMRCFDA,FDA
"RTN","GMRCIACT",105,0)
 D  ; file reason for request
"RTN","GMRCIACT",106,0)
 . D TRIMWP^GMRCIUTL($NA(^TMP("GMRCIN",$J,"OBX",1)),5)
"RTN","GMRCIACT",107,0)
 . D WP^DIE(123,GMRCDA(1)_",",20,"K",$NA(^TMP("GMRCIN",$J,"OBX",1)))
"RTN","GMRCIACT",108,0)
 . Q
"RTN","GMRCIACT",109,0)
 D  ;file activity tracking
"RTN","GMRCIACT",110,0)
 . N GMRCSEG
"RTN","GMRCIACT",111,0)
 . S GMRCSEG("ORC")=GMRCORC
"RTN","GMRCIACT",112,0)
 . S GMRCSEG("OBX",5,1)=^TMP("GMRCIN",$J,"OBX",5,1)
"RTN","GMRCIACT",113,0)
 . D FILEACT^GMRCIAC2(GMRCDA(1),GMRCLAC,,"GMRCSEG")
"RTN","GMRCIACT",114,0)
 D  ;print SF-513
"RTN","GMRCIACT",115,0)
 . I GMRCLAC=24 Q  ;don't print if part of a FWD to IFC
"RTN","GMRCIACT",116,0)
 . D PRNT^GMRCUTL1("",GMRCDA(1))
"RTN","GMRCIACT",117,0)
 D  ;send notifications
"RTN","GMRCIACT",118,0)
 . I GMRCLAC=24 Q  ;no alerts yet if part of FWD to IFC
"RTN","GMRCIACT",119,0)
 . N GMRCORTX
"RTN","GMRCIACT",120,0)
 . S GMRCORTX="New remotely ordered consult "_$$ORTX^GMRCAU(+GMRCDA(1))
"RTN","GMRCIACT",121,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA(1),0),U,2),GMRCORTX,GMRCDA(1),27,,1)
"RTN","GMRCIACT",122,0)
 D  ;send appl ack :-(
"RTN","GMRCIACT",123,0)
 . N GMRCRSLT
"RTN","GMRCIACT",124,0)
 . D RESP^GMRCIUTL("AA",HL("MID"),$P(GMRCORC,"|"),GMRCDA(1))
"RTN","GMRCIACT",125,0)
 . D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.GMRCRSLT)
"RTN","GMRCIACT",126,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIACT",127,0)
 Q
"RTN","GMRCIACT",128,0)
 ;
"RTN","GMRCIACT",129,0)
DIS(GMRCAR) ;dis-associate a result from a remote request
"RTN","GMRCIACT",130,0)
 ;Input:
"RTN","GMRCIACT",131,0)
 ; GMRCAR = array name containing message
"RTN","GMRCIACT",132,0)
 ;      e.g.  ^TMP("GMRCIF",$J)
"RTN","GMRCIACT",133,0)
 N GMRCDA,GMRCFDA,FDA,GMRCERR,GMRCORC
"RTN","GMRCIACT",134,0)
 M ^TMP("GMRCID",$J)=@GMRCAR
"RTN","GMRCIACT",135,0)
 S GMRCORC=^TMP("GMRCID",$J,"ORC")
"RTN","GMRCIACT",136,0)
 S GMRCDA=$$GETDA^GMRCIAC2(GMRCORC)
"RTN","GMRCIACT",137,0)
 I '$$LOCKREC^GMRCUTL1(GMRCDA) D  Q  ;couldn't lock record
"RTN","GMRCIACT",138,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AR",901) ;send app. ACK
"RTN","GMRCIACT",139,0)
 . K ^TMP("GMRCID",$J) Q
"RTN","GMRCIACT",140,0)
 ;    v--check to see if a dup transmission
"RTN","GMRCIACT",141,0)
 I $$DUPACT^GMRCIAC2(GMRCDA,12,GMRCORC,^TMP("GMRCID",$J,"OBX",4,1)) Q
"RTN","GMRCIACT",142,0)
 ;
"RTN","GMRCIACT",143,0)
 D FILEACT^GMRCIAC2(GMRCDA,12,,$NA(^TMP("GMRCID",$J))) ; act. tracking
"RTN","GMRCIACT",144,0)
 D FILRES^GMRCIAC2(GMRCDA,^TMP("GMRCID",$J,"OBX",4,1)) ;file results
"RTN","GMRCIACT",145,0)
 K GMRCERR,FDA,GMRCFDA
"RTN","GMRCIACT",146,0)
 I $$STSCHG^GMRCDIS(GMRCDA) S FDA(1,123,GMRCDA_",",8)=6
"RTN","GMRCIACT",147,0)
 S FDA(1,123,GMRCDA_",",9)=12
"RTN","GMRCIACT",148,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR") ;file last action and status
"RTN","GMRCIACT",149,0)
 D  ;send notifications
"RTN","GMRCIACT",150,0)
 . I $P(^GMR(123,GMRCDA,12),U,5)="F" Q  ;DIS from placer before IFC
"RTN","GMRCIACT",151,0)
 . N GMRCORTX
"RTN","GMRCIACT",152,0)
 . S GMRCORTX="Remote result removed from "_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIACT",153,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA,0),U,2),GMRCORTX,GMRCDA,63,,1)
"RTN","GMRCIACT",154,0)
 D  ;send appl ACK
"RTN","GMRCIACT",155,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AA") ; send app. ACK and unlock record
"RTN","GMRCIACT",156,0)
 K ^TMP("GMRCID",$J)
"RTN","GMRCIACT",157,0)
 Q
"RTN","GMRCIACT",158,0)
 ;
"RTN","GMRCIACT",159,0)
OTHER(GMRCAR) ;process most IFC actions
"RTN","GMRCIACT",160,0)
 ;will process the receive, schedule, DC, cancel and added comment action
"RTN","GMRCIACT",161,0)
 ;
"RTN","GMRCIACT",162,0)
 ;Input:
"RTN","GMRCIACT",163,0)
 ; GMRCAR = array name containing message
"RTN","GMRCIACT",164,0)
 ;      e.g.  ^TMP("GMRCIF",$J)
"RTN","GMRCIACT",165,0)
 ;
"RTN","GMRCIACT",166,0)
 N GMRCDA,GMRCFDA,GMRCORC,GMRCLAT,GMRCACT,GMRCROL,FDA
"RTN","GMRCIACT",167,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIACT",168,0)
 M ^TMP("GMRCIN",$J)=@GMRCAR
"RTN","GMRCIACT",169,0)
 ;
"RTN","GMRCIACT",170,0)
 S GMRCORC=^TMP("GMRCIN",$J,"ORC")
"RTN","GMRCIACT",171,0)
 S GMRCDA=$$GETDA^GMRCIAC2(GMRCORC)  ;get ien to work on
"RTN","GMRCIACT",172,0)
 S GMRCROL=$P(^GMR(123,GMRCDA,12),U,5)
"RTN","GMRCIACT",173,0)
 I '$$LOCKREC^GMRCUTL1(GMRCDA) D  Q  ;couldn't lock record
"RTN","GMRCIACT",174,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AR",901) ; send app. ACK
"RTN","GMRCIACT",175,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIACT",176,0)
 ;
"RTN","GMRCIACT",177,0)
 I $P(GMRCORC,"|")'="IP" D  ; status update
"RTN","GMRCIACT",178,0)
 . N GMRCOS S GMRCOS=$P(GMRCORC,"|",5)
"RTN","GMRCIACT",179,0)
 . S GMRCFDA(8)=$S(GMRCOS="IP":6,GMRCOS="SC":8,GMRCOS="CA":13,1:1)
"RTN","GMRCIACT",180,0)
 . ; IP=receive, SC=schedule, CA=cancel, DC=discontinue
"RTN","GMRCIACT",181,0)
 D  ; get last action taken
"RTN","GMRCIACT",182,0)
 . I '$G(GMRCFDA(8)) S (GMRCFDA(9),GMRCLAT)=20 Q
"RTN","GMRCIACT",183,0)
 . I GMRCFDA(8)=6 S (GMRCFDA(9),GMRCLAT)=21 Q
"RTN","GMRCIACT",184,0)
 . I GMRCFDA(8)=8 S (GMRCFDA(9),GMRCLAT)=8 Q
"RTN","GMRCIACT",185,0)
 . I GMRCFDA(8)=1 S (GMRCFDA(9),GMRCLAT)=6 Q
"RTN","GMRCIACT",186,0)
 . I GMRCFDA(8)=13 S (GMRCFDA(9),GMRCLAT)=19 Q
"RTN","GMRCIACT",187,0)
 ;                         ^--last action taken
"RTN","GMRCIACT",188,0)
 ;    v-- check to see if a dup transmission
"RTN","GMRCIACT",189,0)
 I $$DUPACT^GMRCIAC2(GMRCDA,GMRCLAT,GMRCORC) Q
"RTN","GMRCIACT",190,0)
 ;
"RTN","GMRCIACT",191,0)
 M FDA(1,123,GMRCDA_",")=GMRCFDA
"RTN","GMRCIACT",192,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR") ;file last action and update status
"RTN","GMRCIACT",193,0)
 K GMRCFDA
"RTN","GMRCIACT",194,0)
 D FILEACT^GMRCIAC2(GMRCDA,GMRCLAT,,$NA(^TMP("GMRCIN",$J)))
"RTN","GMRCIACT",195,0)
 D  ;send notifications
"RTN","GMRCIACT",196,0)
 . N GMRCTX,GMRCNOT,GMRCFL
"RTN","GMRCIACT",197,0)
 . S GMRCFL=1
"RTN","GMRCIACT",198,0)
 . I GMRCLAT=20!(GMRCLAT=8)!(GMRCLAT=21) D
"RTN","GMRCIACT",199,0)
 .. I GMRCLAT=20 D  I '$D(GMRCTX) Q
"RTN","GMRCIACT",200,0)
 ... I $P(^GMR(123,GMRCDA,40,1,0),U,2)'=24 D  Q
"RTN","GMRCIACT",201,0)
 .... S GMRCTX="Comment Added to remote"
"RTN","GMRCIACT",202,0)
 ... N ACT S ACT=1
"RTN","GMRCIACT",203,0)
 ... F  S ACT=$O(^GMR(123,GMRCDA,40,ACT)) Q:'ACT!($D(GMRCTX))  D
"RTN","GMRCIACT",204,0)
 .... I $P(^GMR(123,GMRCDA,40,ACT,0),U,2)=25,$O(^GMR(123,GMRCDA,40,ACT)) D
"RTN","GMRCIACT",205,0)
 ..... S GMRCTX="Comment Added to remote"
"RTN","GMRCIACT",206,0)
 .. I '$D(GMRCTX),GMRCROL="F" Q  ;sch & rec on filler part of FWD 2 IFC
"RTN","GMRCIACT",207,0)
 .. I GMRCLAT=8 S GMRCTX="Scheduled remote"
"RTN","GMRCIACT",208,0)
 .. I GMRCLAT=21 S GMRCTX="Received remote"
"RTN","GMRCIACT",209,0)
 .. S GMRCTX=GMRCTX_" Consult: "_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIACT",210,0)
 .. S GMRCNOT=63
"RTN","GMRCIACT",211,0)
 . I GMRCLAT=6 D
"RTN","GMRCIACT",212,0)
 .. S GMRCFL=$$DCNOTE^GMRCADC(GMRCDA,.5)
"RTN","GMRCIACT",213,0)
 .. S GMRCTX="Discontinued remote Consult: "_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIACT",214,0)
 .. S GMRCNOT=23
"RTN","GMRCIACT",215,0)
 . I GMRCLAT=19 D
"RTN","GMRCIACT",216,0)
 .. I GMRCROL="F" Q  ;canc on a filler is part of FWD 2 IFC
"RTN","GMRCIACT",217,0)
 .. S GMRCTX="Cancelled remote Consult: "_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIACT",218,0)
 .. S GMRCNOT=30
"RTN","GMRCIACT",219,0)
 . I '$D(GMRCNOT) Q  ;don't send any alerts
"RTN","GMRCIACT",220,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA,0),U,2),GMRCTX,GMRCDA,GMRCNOT,,GMRCFL)
"RTN","GMRCIACT",221,0)
 ;
"RTN","GMRCIACT",222,0)
 D  ;send appl ACK
"RTN","GMRCIACT",223,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AA") ;send app. ACK and unlock record
"RTN","GMRCIACT",224,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIACT",225,0)
 Q
"RTN","GMRCIACT",226,0)
 ;
"RTN","GMRCIEVT")
0^1^B60069903^B56867552
"RTN","GMRCIEVT",1,0)
GMRCIEVT ;SLC/JFR - process events and build HL7 message; 2/7/19 09:23
"RTN","GMRCIEVT",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,28,31,121**;DEC 27, 1997;Build 6
"RTN","GMRCIEVT",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","GMRCIEVT",4,0)
 Q  ;don't start at the top
"RTN","GMRCIEVT",5,0)
TRIGR(IEN,ACTN) ;determine what action was taken on IFC and call event point
"RTN","GMRCIEVT",6,0)
 ;Input: 
"RTN","GMRCIEVT",7,0)
 ; IEN = consult number from file 123
"RTN","GMRCIEVT",8,0)
 ; ACT = ien in 40 multiple corresponding to activity
"RTN","GMRCIEVT",9,0)
 ;
"RTN","GMRCIEVT",10,0)
 N ACTYPE
"RTN","GMRCIEVT",11,0)
 S ACTYPE=$P(^GMR(123,IEN,40,ACTN,0),U,2)
"RTN","GMRCIEVT",12,0)
 I 'ACTYPE Q
"RTN","GMRCIEVT",13,0)
 I ACTYPE=26 Q  ;don't send admin corrections yet...
"RTN","GMRCIEVT",14,0)
 ;
"RTN","GMRCIEVT",15,0)
 ; check bkgrd job and run if overdue
"RTN","GMRCIEVT",16,0)
 I '$D(ZTQUEUED),$$GONOGO^GMRCIBKG D
"RTN","GMRCIEVT",17,0)
 . N ZTQUEUED S ZTQUEUED=1 D EN^GMRCIBKG ;remove ZTQUEUED? 
"RTN","GMRCIEVT",18,0)
 ;
"RTN","GMRCIEVT",19,0)
 I $O(^GMR(123.6,"AC",IEN,ACTN),-1) D  Q  ;earlier pending activities
"RTN","GMRCIEVT",20,0)
 . I ACTYPE=22 Q  ; not a trigger or not done here
"RTN","GMRCIEVT",21,0)
 . I ACTYPE=6 N GMRCQT D  I $D(GMRCQT) Q
"RTN","GMRCIEVT",22,0)
 .. ;complete all transactions if IFC DC'd before request ever sent 
"RTN","GMRCIEVT",23,0)
 .. I $O(^GMR(123.6,"AC",IEN,ACTN),-1)'=1 Q  ;new request already sent
"RTN","GMRCIEVT",24,0)
 .. S GMRCQT=1
"RTN","GMRCIEVT",25,0)
 .. N DA,DIE,DR,GMRCACTS
"RTN","GMRCIEVT",26,0)
 .. S GMRCACTS=0
"RTN","GMRCIEVT",27,0)
 .. F  S GMRCACTS=$O(^GMR(123.6,"AC",IEN,GMRCACTS)) Q:'GMRCACTS  D
"RTN","GMRCIEVT",28,0)
 ... S DIE="^GMR(123.6,",DA=$O(^GMR(123.6,"AC",IEN,GMRCACTS,1,0))
"RTN","GMRCIEVT",29,0)
 ... S DR=".06///@" D ^DIE
"RTN","GMRCIEVT",30,0)
 . D LOGMSG^GMRCIUTL(IEN,ACTN,"",902) ;msg log entry but no msg sent
"RTN","GMRCIEVT",31,0)
 I ACTYPE=2!(ACTYPE=1) D NW(IEN) Q  ;send new order
"RTN","GMRCIEVT",32,0)
 I ACTYPE=9!(ACTYPE=14) D RSLT(IEN,ACTN) Q  ;inc report or add'l notes
"RTN","GMRCIEVT",33,0)
 I ACTYPE=10,$P(^GMR(123,IEN,40,ACTN,0),U,9) D RSLT(IEN,ACTN) Q  ;comp
"RTN","GMRCIEVT",34,0)
 I ACTYPE=12 D RSLT(IEN,ACTN) Q  ;dis-associate result
"RTN","GMRCIEVT",35,0)
 I ACTYPE=11 D RESUB^GMRCIEV1(IEN,ACTN) Q  ;ed/resubmit
"RTN","GMRCIEVT",36,0)
 I ACTYPE=13 D RSLT(IEN,ACTN) Q  ; addendum added
"RTN","GMRCIEVT",37,0)
 I ACTYPE=4 D SF^GMRCIEV1(IEN,ACTN) Q  ; sig finding update
"RTN","GMRCIEVT",38,0)
 I ACTYPE=22 Q  ;printed to is not a trigger
"RTN","GMRCIEVT",39,0)
 I ACTYPE=17 D FWD^GMRCIEV1(IEN,ACTN) Q  ; forward
"RTN","GMRCIEVT",40,0)
 I ACTYPE=25 D FWD2IFC^GMRCIEV1(IEN,ACTN) Q  ; FWD into an IFC service
"RTN","GMRCIEVT",41,0)
 D GENUPD(IEN,ACTN) ;all other updates
"RTN","GMRCIEVT",42,0)
 Q
"RTN","GMRCIEVT",43,0)
NW(GMRCDA) ;build new order message for IFC
"RTN","GMRCIEVT",44,0)
 ; Input:
"RTN","GMRCIEVT",45,0)
 ; GMRCDA = ien from file 123
"RTN","GMRCIEVT",46,0)
 ;
"RTN","GMRCIEVT",47,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT
"RTN","GMRCIEVT",48,0)
 S SEG=1
"RTN","GMRCIEVT",49,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEVT",50,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEVT",51,0)
 I $G(HL) D  Q  ; if HL array can't be built, log it with an error
"RTN","GMRCIEVT",52,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,,904)
"RTN","GMRCIEVT",53,0)
 D  I $D(GMRCIQT) D NOMPI(GMRCDA,1) Q  ;build PID seg if not a local ICN
"RTN","GMRCIEVT",54,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEVT",55,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",56,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEVT",57,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",58,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEVT",59,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",60,0)
 . Q
"RTN","GMRCIEVT",61,0)
 S ^TMP("HLS",$J,SEG)=$$NWORC^GMRCISG1(GMRCDA) ; get ORC for new ord
"RTN","GMRCIEVT",62,0)
 S SEG=SEG+1
"RTN","GMRCIEVT",63,0)
 S ^TMP("HLS",$J,SEG)=$$OBR^GMRCISG1(GMRCDA) ;get OBR segment
"RTN","GMRCIEVT",64,0)
 S SEG=SEG+1
"RTN","GMRCIEVT",65,0)
 D  ;build reason for request into OBX segment(s)
"RTN","GMRCIEVT",66,0)
 . K ^TMP("GMRCRFR",$J)
"RTN","GMRCIEVT",67,0)
 . D OBXWP^GMRCISEG(GMRCDA,"NW",1,$NA(^TMP("GMRCRFR",$J)))
"RTN","GMRCIEVT",68,0)
 . I '$D(^TMP("GMRCRFR",$J)) Q
"RTN","GMRCIEVT",69,0)
 . N I S I=0
"RTN","GMRCIEVT",70,0)
 . F  S I=$O(^TMP("GMRCRFR",$J,I)) Q:'I  D
"RTN","GMRCIEVT",71,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCRFR",$J,I)
"RTN","GMRCIEVT",72,0)
 .. S SEG=SEG+1
"RTN","GMRCIEVT",73,0)
 . K ^TMP("GMRCRFR",$J)
"RTN","GMRCIEVT",74,0)
 . Q
"RTN","GMRCIEVT",75,0)
 S ^TMP("HLS",$J,SEG)=$$OBXPD^GMRCISG1(GMRCDA) ; build prov DX in OBX
"RTN","GMRCIEVT",76,0)
 S SEG=SEG+1
"RTN","GMRCIEVT",77,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always send local time zone
"RTN","GMRCIEVT",78,0)
 ;
"RTN","GMRCIEVT",79,0)
 ;AV/MKN Add NTE segment to HL7 to send UCID file #123, field #80 *121*
"RTN","GMRCIEVT",80,0)
 N SEP
"RTN","GMRCIEVT",81,0)
 S SEP=HL("FS")
"RTN","GMRCIEVT",82,0)
 N UCID S UCID=$$GET1^DIQ(123,GMRCDA,80) S:UCID]"" SEG=SEG+1,^TMP("HLS",$J,SEG)="NTE"_SEP_"P"_SEP_"UCID:"_UCID
"RTN","GMRCIEVT",83,0)
 ;AV/MKN End of NTE for UCID *121*
"RTN","GMRCIEVT",84,0)
 ;
"RTN","GMRCIEVT",85,0)
 S HLL("LINKS",1)=$$ROUTE(GMRCDA) I '$L(HLL("LINKS",1)) D  Q  ;log error
"RTN","GMRCIEVT",86,0)
 . D LOGMSG^GMRCIUTL(IEN,ACTN,"",903)
"RTN","GMRCIEVT",87,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEVT",88,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"")
"RTN","GMRCIEVT",89,0)
 D LOGMSG^GMRCIUTL(GMRCDA,1,+GMRC773,ERR)
"RTN","GMRCIEVT",90,0)
 Q
"RTN","GMRCIEVT",91,0)
 ;
"RTN","GMRCIEVT",92,0)
GENUPD(GMRCDA,GMRCACT) ;build msg and send upon REC, SC or ADD CMT event
"RTN","GMRCIEVT",93,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT
"RTN","GMRCIEVT",94,0)
 S SEG=1
"RTN","GMRCIEVT",95,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEVT",96,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEVT",97,0)
 I $G(HL) D  Q  ; if HL array can't be built, log it with an error
"RTN","GMRCIEVT",98,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,,904)
"RTN","GMRCIEVT",99,0)
 D  I $D(GMRCIQT) D NOMPI(GMRCDA,GMRCACT) Q  ;build PID seg if nat'l ICN
"RTN","GMRCIEVT",100,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEVT",101,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",102,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEVT",103,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",104,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEVT",105,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",106,0)
 . Q
"RTN","GMRCIEVT",107,0)
 D  ;build ORC seg based on GMRCACT
"RTN","GMRCIEVT",108,0)
 . N ACTVT,OC,OS
"RTN","GMRCIEVT",109,0)
 . S ACTVT=$P(^GMR(123,GMRCDA,40,GMRCACT,0),U,2) ; get activity
"RTN","GMRCIEVT",110,0)
 . ;set order control for ORC seg:
"RTN","GMRCIEVT",111,0)
 . ; v-- IP=cmt RE=adm comp OD=DC OC=cancel SC=sch or receive
"RTN","GMRCIEVT",112,0)
 . S OC=$S(ACTVT=20:"IP",ACTVT=10:"RE",ACTVT=6:"OD",ACTVT=19:"OC",1:"SC")
"RTN","GMRCIEVT",113,0)
 . ;set order status for ORC seg:
"RTN","GMRCIEVT",114,0)
 . ; v-- SC=sch RE=adm comp DC=DC CA=cancel IP=cmt or receive
"RTN","GMRCIEVT",115,0)
 . S OS=$S(ACTVT=8:"SC",ACTVT=10:"CM",ACTVT=6:"DC",ACTVT=19:"CA",1:"IP")
"RTN","GMRCIEVT",116,0)
 . S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,OC,OS,GMRCACT)
"RTN","GMRCIEVT",117,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",118,0)
 . Q
"RTN","GMRCIEVT",119,0)
 I $L($P(^GMR(123,GMRCDA,0),U,19)) D  ;send sig findings
"RTN","GMRCIEVT",120,0)
 . S ^TMP("HLS",$J,SEG)=$$OBXSF^GMRCISEG(GMRCDA)
"RTN","GMRCIEVT",121,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",122,0)
 I $O(^GMR(123,GMRCDA,40,GMRCACT,1,0)) D  ;load up a comment if there
"RTN","GMRCIEVT",123,0)
 . N I
"RTN","GMRCIEVT",124,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEVT",125,0)
 . I $P(^TMP("HLS",$J,SEG-1),"|",2)'["O" D 
"RTN","GMRCIEVT",126,0)
 .. D OBXWP^GMRCISEG(GMRCDA,"",GMRCACT,$NA(^TMP("GMRCMT",$J)))
"RTN","GMRCIEVT",127,0)
 . I $P(^TMP("HLS",$J,SEG-1),"|",2)["O" D
"RTN","GMRCIEVT",128,0)
 .. N GMRCMT
"RTN","GMRCIEVT",129,0)
 .. D NTE^GMRCISEG(GMRCDA,GMRCACT,.GMRCMT)
"RTN","GMRCIEVT",130,0)
 .. I $D(GMRCMT) M ^TMP("GMRCMT",$J)=GMRCMT
"RTN","GMRCIEVT",131,0)
 . Q:'$O(^TMP("GMRCMT",$J,0))
"RTN","GMRCIEVT",132,0)
 . S I=0 F  S I=$O(^TMP("GMRCMT",$J,I)) Q:'I  D
"RTN","GMRCIEVT",133,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCMT",$J,I)
"RTN","GMRCIEVT",134,0)
 .. S SEG=SEG+1
"RTN","GMRCIEVT",135,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEVT",136,0)
 . Q
"RTN","GMRCIEVT",137,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEVT",138,0)
 S HLL("LINKS",1)=$$ROUTE(GMRCDA) I '$L(HLL("LINKS",1)) D  Q  ;log error
"RTN","GMRCIEVT",139,0)
 . D LOGMSG^GMRCIUTL(IEN,ACTN,"",903)
"RTN","GMRCIEVT",140,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEVT",141,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEVT",142,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEVT",143,0)
 Q
"RTN","GMRCIEVT",144,0)
 ;
"RTN","GMRCIEVT",145,0)
RSLT(GMRCDA,GMRCACT) ;attach or dis-associate results and update
"RTN","GMRCIEVT",146,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT
"RTN","GMRCIEVT",147,0)
 S SEG=1
"RTN","GMRCIEVT",148,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEVT",149,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEVT",150,0)
 I $G(HL) D  Q  ; if HL array can't be built, log it with an error
"RTN","GMRCIEVT",151,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,,904)
"RTN","GMRCIEVT",152,0)
 D  I $D(GMRCIQT) D NOMPI(GMRCDA,GMRCACT) Q  ;build PID seg if nat'l ICN
"RTN","GMRCIEVT",153,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEVT",154,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",155,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEVT",156,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",157,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEVT",158,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",159,0)
 . Q
"RTN","GMRCIEVT",160,0)
 D  ;build ORC seg based on GMRCACT
"RTN","GMRCIEVT",161,0)
 . N ACTVT,OC,OS
"RTN","GMRCIEVT",162,0)
 . S ACTVT=$P(^GMR(123,GMRCDA,40,GMRCACT,0),U,2) ; get activity
"RTN","GMRCIEVT",163,0)
 . S OC="RE"
"RTN","GMRCIEVT",164,0)
 . S OS=$S(ACTVT=9:"A",ACTVT=12:"IP",1:"CM") ; A=part res CM=comp IP=dis
"RTN","GMRCIEVT",165,0)
 . S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,OC,OS,GMRCACT)
"RTN","GMRCIEVT",166,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",167,0)
 I $P(^GMR(123,GMRCDA,40,GMRCACT,0),U,2)'=99 D
"RTN","GMRCIEVT",168,0)
 . S ^TMP("HLS",$J,SEG)=$$OBXRSLT^GMRCISEG(GMRCDA,GMRCACT)
"RTN","GMRCIEVT",169,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",170,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEVT",171,0)
 S HLL("LINKS",1)=$$ROUTE(GMRCDA) I '$L(HLL("LINKS",1)) D  Q  ;log error
"RTN","GMRCIEVT",172,0)
 . D LOGMSG^GMRCIUTL(IEN,ACTN,"",903)
"RTN","GMRCIEVT",173,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEVT",174,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEVT",175,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEVT",176,0)
 Q
"RTN","GMRCIEVT",177,0)
 ;
"RTN","GMRCIEVT",178,0)
NOMPI(GMRCIEN,GMRCACTV) ;process MPI exception
"RTN","GMRCIEVT",179,0)
 N GMRCDFN
"RTN","GMRCIEVT",180,0)
 S GMRCDFN=$P(^GMR(123,GMRCIEN,0),U,2)
"RTN","GMRCIEVT",181,0)
 D PTMPIER^GMRCIERR(GMRCDFN) ; send msg to local group for ICN problem
"RTN","GMRCIEVT",182,0)
 D LOGMSG^GMRCIUTL(GMRCIEN,GMRCACTV,,202) ;put inc. entry in MSG log
"RTN","GMRCIEVT",183,0)
 Q
"RTN","GMRCIEVT",184,0)
 ;
"RTN","GMRCIEVT",185,0)
ROUTE(GMRCDA) ; determine correct routing for IFC msg
"RTN","GMRCIEVT",186,0)
 ; Input:
"RTN","GMRCIEVT",187,0)
 ; GMRCDA = ien from file 123
"RTN","GMRCIEVT",188,0)
 ;
"RTN","GMRCIEVT",189,0)
 ; Output:
"RTN","GMRCIEVT",190,0)
 ; the logical link to send the message to in format
"RTN","GMRCIEVT",191,0)
 ; "GMRC IFC SUBSC^VHAHIN"
"RTN","GMRCIEVT",192,0)
 ;
"RTN","GMRCIEVT",193,0)
 N SITE,GMRCLINK,STA
"RTN","GMRCIEVT",194,0)
 S SITE=$P(^GMR(123,GMRCDA,0),U,23) I 'SITE Q "" ;no ROUTING FACILITY
"RTN","GMRCIEVT",195,0)
 S STA=$$STA^XUAF4(SITE)
"RTN","GMRCIEVT",196,0)
 I '$L(STA) Q "" ;can't find station num for that site
"RTN","GMRCIEVT",197,0)
 D LINK^HLUTIL3(STA,.GMRCLINK,"I")
"RTN","GMRCIEVT",198,0)
 S GMRCLINK=$O(GMRCLINK(0)) I 'GMRCLINK Q "" ; no link for that site
"RTN","GMRCIEVT",199,0)
 S GMRCLINK=GMRCLINK(GMRCLINK) I '$L(GMRCLINK) Q "" ;no link name
"RTN","GMRCIEVT",200,0)
 Q "GMRC IFC SUBSC^"_GMRCLINK
"RTN","GMRCIEVT",201,0)
 ;
"VER")
8.0^22.2
"BLD",11213,6)
^101
**END**
**END**

