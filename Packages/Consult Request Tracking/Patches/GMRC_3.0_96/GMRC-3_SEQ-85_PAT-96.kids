Released GMRC*3*96 SEQ #85
Extracted from mail message
**KIDS**:GMRC*3.0*96^

**INSTALL NAME**
GMRC*3.0*96
"BLD",10823,0)
GMRC*3.0*96^CONSULT/REQUEST TRACKING^0^3180503^y
"BLD",10823,4,0)
^9.64PA^123^1
"BLD",10823,4,123,0)
123
"BLD",10823,4,123,2,0)
^9.641^123^1
"BLD",10823,4,123,2,123,0)
REQUEST/CONSULTATION  (File-top level)
"BLD",10823,4,123,2,123,1,0)
^9.6411^80^1
"BLD",10823,4,123,2,123,1,80,0)
UNIQUE CONSULT ID 
"BLD",10823,4,123,222)
y^y^p^^^^n^^n
"BLD",10823,4,123,224)

"BLD",10823,4,"APDD",123,123)

"BLD",10823,4,"APDD",123,123,80)

"BLD",10823,4,"B",123,123)

"BLD",10823,6)
7^
"BLD",10823,6.3)
21
"BLD",10823,"ABPKG")
n
"BLD",10823,"INID")
^n
"BLD",10823,"INIT")
POST^GMRCP96
"BLD",10823,"KRN",0)
^9.67PA^779.2^20
"BLD",10823,"KRN",.4,0)
.4
"BLD",10823,"KRN",.401,0)
.401
"BLD",10823,"KRN",.402,0)
.402
"BLD",10823,"KRN",.403,0)
.403
"BLD",10823,"KRN",.5,0)
.5
"BLD",10823,"KRN",.84,0)
.84
"BLD",10823,"KRN",3.6,0)
3.6
"BLD",10823,"KRN",3.8,0)
3.8
"BLD",10823,"KRN",9.2,0)
9.2
"BLD",10823,"KRN",9.8,0)
9.8
"BLD",10823,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",10823,"KRN",9.8,"NM",1,0)
GMRCUTL1^^0^B17295672
"BLD",10823,"KRN",9.8,"NM",2,0)
GMRCHL7B^^0^B29656014
"BLD",10823,"KRN",9.8,"NM",3,0)
GMRCHL7H^^0^B135984194
"BLD",10823,"KRN",9.8,"NM","B","GMRCHL7B",2)

"BLD",10823,"KRN",9.8,"NM","B","GMRCHL7H",3)

"BLD",10823,"KRN",9.8,"NM","B","GMRCUTL1",1)

"BLD",10823,"KRN",19,0)
19
"BLD",10823,"KRN",19.1,0)
19.1
"BLD",10823,"KRN",101,0)
101
"BLD",10823,"KRN",409.61,0)
409.61
"BLD",10823,"KRN",771,0)
771
"BLD",10823,"KRN",779.2,0)
779.2
"BLD",10823,"KRN",870,0)
870
"BLD",10823,"KRN",8989.51,0)
8989.51
"BLD",10823,"KRN",8989.51,"NM",0)
^9.68A^1^1
"BLD",10823,"KRN",8989.51,"NM",1,0)
GMRC UNIQUE CONSULT SITE ID^^0
"BLD",10823,"KRN",8989.51,"NM","B","GMRC UNIQUE CONSULT SITE ID",1)

"BLD",10823,"KRN",8989.52,0)
8989.52
"BLD",10823,"KRN",8989.52,"NM",0)
^9.68A^^
"BLD",10823,"KRN",8994,0)
8994
"BLD",10823,"KRN","B",.4,.4)

"BLD",10823,"KRN","B",.401,.401)

"BLD",10823,"KRN","B",.402,.402)

"BLD",10823,"KRN","B",.403,.403)

"BLD",10823,"KRN","B",.5,.5)

"BLD",10823,"KRN","B",.84,.84)

"BLD",10823,"KRN","B",3.6,3.6)

"BLD",10823,"KRN","B",3.8,3.8)

"BLD",10823,"KRN","B",9.2,9.2)

"BLD",10823,"KRN","B",9.8,9.8)

"BLD",10823,"KRN","B",19,19)

"BLD",10823,"KRN","B",19.1,19.1)

"BLD",10823,"KRN","B",101,101)

"BLD",10823,"KRN","B",409.61,409.61)

"BLD",10823,"KRN","B",771,771)

"BLD",10823,"KRN","B",779.2,779.2)

"BLD",10823,"KRN","B",870,870)

"BLD",10823,"KRN","B",8989.51,8989.51)

"BLD",10823,"KRN","B",8989.52,8989.52)

"BLD",10823,"KRN","B",8994,8994)

"BLD",10823,"QUES",0)
^9.62^^
"BLD",10823,"REQB",0)
^9.611^3^3
"BLD",10823,"REQB",1,0)
GMRC*3.0*28^1
"BLD",10823,"REQB",2,0)
GMRC*3.0*85^1
"BLD",10823,"REQB",3,0)
GMRC*3.0*89^1
"BLD",10823,"REQB","B","GMRC*3.0*28",1)

"BLD",10823,"REQB","B","GMRC*3.0*85",2)

"BLD",10823,"REQB","B","GMRC*3.0*89",3)

"FIA",123)
REQUEST/CONSULTATION
"FIA",123,0)
^GMR(123,
"FIA",123,0,0)
123DI
"FIA",123,0,1)
y^y^p^^^^n^^n
"FIA",123,0,10)

"FIA",123,0,11)

"FIA",123,0,"RLRO")

"FIA",123,0,"VR")
3.0^GMRC
"FIA",123,123)
1
"FIA",123,123,80)

"INIT")
POST^GMRCP96
"KRN",8989.5,603824,0)
406;DIC(9.4,^GMRC UNIQUE CONSULT SITE ID^1
"KRN",8989.5,603824,1)
999
"KRN",8989.51,1025,-1)
0^1
"KRN",8989.51,1025,0)
GMRC UNIQUE CONSULT SITE ID^GMRC Unique Consult Site ID^0^^^0
"KRN",8989.51,1025,1)
N^^Enter a unique three-digit site identifier assigned to this location.
"KRN",8989.51,1025,20,0)
^^2^2^3171215^
"KRN",8989.51,1025,20,1,0)
A unique three-digit number to identify this VistA facility for One 
"KRN",8989.51,1025,20,2,0)
Consult.
"KRN",8989.51,1025,30,0)
^8989.513I^1^1
"KRN",8989.51,1025,30,1,0)
1^9.4
"MBREQ")
0
"ORD",20,8989.51)
8989.51;20;;;PAR1E1^XPDTA2;PAR1F1^XPDIA3;PAR1E1^XPDIA3;PAR1F2^XPDIA3;;PAR1DEL^XPDIA3(%)
"ORD",20,8989.51,0)
PARAMETER DEFINITION
"PKG",406,-1)
1^1
"PKG",406,0)
CONSULT/REQUEST TRACKING^GMRC^CONSULTS/REQUESTS
"PKG",406,20,0)
^9.402P^^
"PKG",406,22,0)
^9.49I^1^1
"PKG",406,22,1,0)
3.0^2980101^2981113^1
"PKG",406,22,1,"PAH",1,0)
96^3180503^520824649
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","GMRCHL7B")
0^2^B29656014^B26855576
"RTN","GMRCHL7B",1,0)
GMRCHL7B ;SLC/DCM,MA,JFR - Process data from GMRCHL7A ;10/09/15  13:26
"RTN","GMRCHL7B",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,21,17,22,33,66,46,73,85,96**;DEC 27, 1997;Build 21
"RTN","GMRCHL7B",3,0)
 ;
"RTN","GMRCHL7B",4,0)
 ; This routine invokes IA #2053(DIE), #10006(DIC), #2056(GET1^DIQ), #5747$$CODECS^ICDEX
"RTN","GMRCHL7B",5,0)
 ;
"RTN","GMRCHL7B",6,0)
 ; ABV/SCR: 09/26/2007 *96*- Modified to include population of UNIQUE CONSULT ID field
"RTN","GMRCHL7B",7,0)
 ;
"RTN","GMRCHL7B",8,0)
NEW(MESSAGE) ;Add new order
"RTN","GMRCHL7B",9,0)
 ;GMRCO=^GMR(123,IFN, the new file number in file ^GMR(123,
"RTN","GMRCHL7B",10,0)
 ;GMRCORFN=OE/RR file number       GMRCWARD=ward patient is on
"RTN","GMRCHL7B",11,0)
 ;GMRCSS=service consult sent to   GMRCAD=date/time of request
"RTN","GMRCHL7B",12,0)
 ;GMRCPRI=procedure/request        GMRCURGI=urgency
"RTN","GMRCHL7B",13,0)
 ;GMRCERDT=earliest desired date
"RTN","GMRCHL7B",14,0)
 ;GMRCATN=attention                GMRCSTS=OE/RR order status
"RTN","GMRCHL7B",15,0)
 ;GMRCORNP=patient's provider      GMRCTYPE=request type (request or consult)
"RTN","GMRCHL7B",16,0)
 ;GMRCSBR=service rendered on what basis (Inpatient, or Outpatient)
"RTN","GMRCHL7B",17,0)
 ;GMRCRFQ=reason for request array - word processing fields
"RTN","GMRCHL7B",18,0)
 ;GMRCOTXT=order display text from dialog or orderable item
"RTN","GMRCHL7B",19,0)
 ;GMRCPRDG=provisional DX
"RTN","GMRCHL7B",20,0)
 ;GMRCPRCD=provisional DX code
"RTN","GMRCHL7B",21,0)
 ;GMRCCS=coding system for prov diagnosis
"RTN","GMRCHL7B",22,0)
 ;GMRCCPTR=pointer to coding system file
"RTN","GMRCHL7B",23,0)
 ; Output:
"RTN","GMRCHL7B",24,0)
 ;    MESSAGE = rejection message if problems encountered while filing
"RTN","GMRCHL7B",25,0)
 ;
"RTN","GMRCHL7B",26,0)
 ;
"RTN","GMRCHL7B",27,0)
 N DIC,DLAYGO,X,Y,DR,DIE,GMRCADUZ,GMRCCP,GMRCCS
"RTN","GMRCHL7B",28,0)
 N GMRCUCID   ;ABV/SCR 09/26/2017
"RTN","GMRCHL7B",29,0)
 S DIC="^GMR(123,",DIC(0)="L",X="""N""",DLAYGO=123 D ^DIC K DLAYGO Q:Y<1
"RTN","GMRCHL7B",30,0)
 ; Patch #21 changed GMRCA=1 to GMRCA=2
"RTN","GMRCHL7B",31,0)
 S (DA,GMRCO)=+Y,GMRCSTS=5,GMRCA=2,DIE=DIC
"RTN","GMRCHL7B",32,0)
 S GMRCUCID=$$NEWUCID^GMRCUTL1(DA)    ;ABV/SCR 09/26/2017
"RTN","GMRCHL7B",33,0)
 I GMRCUCID="" S ^XTMP("GMRCHL7B","UCID IS BLANK",DA)=DA    ;ABV/SCR 12/14/2017 - TEMPORARY ERROR HANDLER
"RTN","GMRCHL7B",34,0)
 L +^GMR(123,GMRCO):$S($G(DILOCKTM)>0:DILOCKTM,1:5)
"RTN","GMRCHL7B",35,0)
 S DR=".02////^S X=DFN;.03////^S X=GMRCORFN;.04////^S X=GMRCWARD;.05////^S X=GMRCFAC;.06////^S X=$G(GMRCOFN);1////^S X=GMRCSS;2////^S X=$G(GMRCWARD);3////^S X=GMRCAD;4////^S X=GMRCPRI;5////^S X=GMRCURGI;7////^S X=$G(GMRCATN)"
"RTN","GMRCHL7B",36,0)
 D ^DIE
"RTN","GMRCHL7B",37,0)
 I GMRCOTXT=$$GET1^DIQ(123.5,+GMRCSS,.01) S GMRCOTXT=""
"RTN","GMRCHL7B",38,0)
 ;Added new field .1 to DR on 7/11/98 to save the order text
"RTN","GMRCHL7B",39,0)
 ;S DR="6////^S X=GMRCPLI;8////^S X=GMRCSTS;9////^S X=GMRCA;10////^S X=GMRCORNP;13////^S X=GMRCTYPE;14////^S X=$G(GMRCSBR);17////^S X=$G(GMRCERDT);30////^S X=$G(GMRCPRDG);.1////^S X=$G(GMRCOTXT)" ;wat/66
"RTN","GMRCHL7B",40,0)
 S DR="6////^S X=GMRCPLI;8////^S X=GMRCSTS;9////^S X=GMRCA;10////^S X=GMRCORNP;13////^S X=GMRCTYPE;14////^S X=$G(GMRCSBR);17////^S X=$G(GMRCERDT);30////^S X=$G(GMRCPRDG);.1////^S X=$G(GMRCOTXT);80////^S X=GMRCUCID" ;ABV/SCR 12/14/17 *96*
"RTN","GMRCHL7B",41,0)
 I $D(GMRCPRCD) D
"RTN","GMRCHL7B",42,0)
 .S GMRCCS=""
"RTN","GMRCHL7B",43,0)
 .S GMRCCS=$$CODECS^ICDEX(GMRCPRCD,80) I $G(GMRCCS)'="" D  ;use dx code to get coding system
"RTN","GMRCHL7B",44,0)
 ..S GMRCCS=$S($P(GMRCCS,U)=1:"ICD",1:"10D")
"RTN","GMRCHL7B",45,0)
 .S DR=DR_";30.1///^S X=GMRCPRCD;30.2////^S X=DT;30.3////^S X=GMRCCS"
"RTN","GMRCHL7B",46,0)
 S GMRCCP=$P($G(^GMR(123.3,+GMRCPRI,0)),U,4) I GMRCCP D  ;file CP
"RTN","GMRCHL7B",47,0)
 . S DR=DR_";1.01///^S X=GMRCCP"
"RTN","GMRCHL7B",48,0)
 D  ;check to see if an IFC and add .07 ROUTING FACILITY
"RTN","GMRCHL7B",49,0)
 . I $G(GMRCPRI) D  Q  ;see if procedure is mapped
"RTN","GMRCHL7B",50,0)
 .. I '$D(^GMR(123.3,+GMRCPRI,"IFC")) Q
"RTN","GMRCHL7B",51,0)
 .. N IFC S IFC=$G(^GMR(123.3,+GMRCPRI,"IFC"))
"RTN","GMRCHL7B",52,0)
 .. I '+IFC Q  ; no ifc routing site
"RTN","GMRCHL7B",53,0)
 .. I '$L($P(^GMR(123.3,+GMRCPRI,"IFC"),U,2)) Q  ;no remote proc name
"RTN","GMRCHL7B",54,0)
 .. S DR=DR_";.07////"_+IFC_";.125////P"
"RTN","GMRCHL7B",55,0)
 . I '$G(GMRCPRI) D  Q  ;see if service is mapped
"RTN","GMRCHL7B",56,0)
 .. I '$D(^GMR(123.5,+GMRCSS,"IFC")) Q
"RTN","GMRCHL7B",57,0)
 .. N IFC S IFC=$G(^GMR(123.5,+GMRCSS,"IFC"))
"RTN","GMRCHL7B",58,0)
 .. I '+IFC Q  ; no ifc routing site
"RTN","GMRCHL7B",59,0)
 .. I '$L($P(IFC,U,2)) Q  ;no remote service name
"RTN","GMRCHL7B",60,0)
 .. S DR=DR_";.07////"_+IFC_";.125////P;.131////"_$P(IFC,U,2)
"RTN","GMRCHL7B",61,0)
 . Q
"RTN","GMRCHL7B",62,0)
 D ^DIE
"RTN","GMRCHL7B",63,0)
 I $O(GMRCRFQ(0)) D REASON
"RTN","GMRCHL7B",64,0)
 L -^GMR(123,GMRCO)
"RTN","GMRCHL7B",65,0)
 S GMRCA=1 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",66,0)
 I $D(GMRCXMF),$D(GMRCOFN) S $P(^GMR(123,GMRCO,0),"^",21)=GMRCOFN
"RTN","GMRCHL7B",67,0)
 I $D(GMRCACTN) S GMRCADUZ(GMRCACTN)=""
"RTN","GMRCHL7B",68,0)
 D ALERT^GMRCHL7U(DFN,GMRCSS,GMRCPRI,GMRCO,GMRCURGI,"")
"RTN","GMRCHL7B",69,0)
 D PRNT^GMRCUTL1(GMRCSS,GMRCO) ;contains print audit update
"RTN","GMRCHL7B",70,0)
 D EXIT
"RTN","GMRCHL7B",71,0)
 Q
"RTN","GMRCHL7B",72,0)
DC(GMRCO,ACTRL) ;Discontinue request from OERR
"RTN","GMRCHL7B",73,0)
 ;Denied request also gets this action. Deny request updates status to dc
"RTN","GMRCHL7B",74,0)
 ;GMRCO=IEN of record in file ^GMR(123, i.e., ^GMR(123,DA,
"RTN","GMRCHL7B",75,0)
 ;ACTRL=GMRCCTRL=control code defining action -
"RTN","GMRCHL7B",76,0)
 ;         DC control code = action DC for discontinued
"RTN","GMRCHL7B",77,0)
 ;         CA control code = action DY for denied
"RTN","GMRCHL7B",78,0)
 ;Update the last action taken, order status, and processing activity
"RTN","GMRCHL7B",79,0)
 Q:'$L(GMRCO)
"RTN","GMRCHL7B",80,0)
 Q:'$D(^GMR(123,+GMRCO,0))
"RTN","GMRCHL7B",81,0)
 N GMRCACT,GMRCSVC,GMRCDFN,GMRCFL,GMRCADUZ,GMRCRQR,DA
"RTN","GMRCHL7B",82,0)
 S GMRCACT=$O(^GMR(123.1,"D",ACTRL,0))
"RTN","GMRCHL7B",83,0)
 S GMRCSTS=$P(^GMR(123.1,GMRCACT,0),"^",2)
"RTN","GMRCHL7B",84,0)
 S DIE="^GMR(123,",DA=GMRCO
"RTN","GMRCHL7B",85,0)
 S DR="8////^S X=GMRCSTS;9////^S X=GMRCACT" ; upd status + last action
"RTN","GMRCHL7B",86,0)
 D ^DIE
"RTN","GMRCHL7B",87,0)
 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",88,0)
 ; send 513 back through service printer if order DC'd
"RTN","GMRCHL7B",89,0)
 I $G(ACTRL)="DC",$$DCPRNT^GMRCUTL1(GMRCO,DUZ) D
"RTN","GMRCHL7B",90,0)
 . D PRNT^GMRCUTL1(+$P(^GMR(123,GMRCO,0),U,5),GMRCO)
"RTN","GMRCHL7B",91,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCHL7B",92,0)
 S GMRCFL=$$DCNOTE^GMRCADC(GMRCO,DUZ),GMRCADUZ=""
"RTN","GMRCHL7B",93,0)
 S GMRCRQR=+$P($G(^GMR(123,+GMRCO,0)),"^",14)
"RTN","GMRCHL7B",94,0)
 I +GMRCRQR,GMRCRQR'=DUZ S GMRCADUZ(GMRCRQR)=""
"RTN","GMRCHL7B",95,0)
 S GMRCSVC=$P($G(^GMR(123,+GMRCO,0)),"^",5)
"RTN","GMRCHL7B",96,0)
 I +GMRCSVC S GMRCSVC=$S($D(^GMR(123.5,GMRCSVC,.1)):^(.1),1:$P(^GMR(123.5,GMRCSVC,0),"^",1))
"RTN","GMRCHL7B",97,0)
 E  S GMRCSVC="Unknown Service: Consult # "_GMRCO
"RTN","GMRCHL7B",98,0)
 S GMRCORTX=$S(ACTRL="DC":"Discontinued",1:"Cancelled")
"RTN","GMRCHL7B",99,0)
 S GMRCORTX=GMRCORTX_" Consult "_$$ORTX^GMRCAU(GMRCO)
"RTN","GMRCHL7B",100,0)
 N NOTYPE S NOTYPE=$S(ACTRL="DC":23,1:30)
"RTN","GMRCHL7B",101,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,NOTYPE,.GMRCADUZ,GMRCFL)
"RTN","GMRCHL7B",102,0)
 D EXIT
"RTN","GMRCHL7B",103,0)
 Q
"RTN","GMRCHL7B",104,0)
MODIFY ;Change an order/request when an HL7 'XX' code is received
"RTN","GMRCHL7B",105,0)
 ;This is currently not used.
"RTN","GMRCHL7B",106,0)
 ;    When Consults sends an XX, CPRS returns NA with a new order ien.
"RTN","GMRCHL7B",107,0)
 ;GMRCACT=processing activity - from file ^GMR(123.1,
"RTN","GMRCHL7B",108,0)
 S DIE="^GMR(123,",DA=+GMRCO
"RTN","GMRCHL7B",109,0)
 S GMRCWARD=$G(GMRCWARD),GMRCPRI=$G(GMRCPRI),GMRCURGI=$G(GMRCURGI),GMRCSTS=$G(GMRCSTS),GMRCTYPE=$G(GMRCTYPE),GMRCSS=$G(GMRCSS)
"RTN","GMRCHL7B",110,0)
 S GMRCACT=$O(^GMR(123.1,"D",GMRCTRLC,0))
"RTN","GMRCHL7B",111,0)
 S GMRCSTS=$P(^GMR(123.1,GMRCACT,0),"^",2)
"RTN","GMRCHL7B",112,0)
 S DIE=123,DR=".04////^S X=$G(GMRCWARD);1////^S X=$G(GMRCSS);4////^S X=$G(GMRCPRI);5////^S X=$G(GMRCURGI);8////^S X=$G(GMRCSTS);9////^S X=GMRCACT"
"RTN","GMRCHL7B",113,0)
 D ^DIE
"RTN","GMRCHL7B",114,0)
 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",115,0)
 D EXIT Q
"RTN","GMRCHL7B",116,0)
REASON ;load the reason for request into ^GMR(123,IFN,20
"RTN","GMRCHL7B",117,0)
 S ^GMR(123,GMRCO,20,0)="^^^"_$S($D(GMRCDA):GMRCDA,1:DT)_"^"
"RTN","GMRCHL7B",118,0)
 S L=0,LN=1 F  S L=$O(GMRCRFQ(L)) Q:L=""  S ^GMR(123,GMRCO,20,LN,0)=GMRCRFQ(L),LN=LN+1
"RTN","GMRCHL7B",119,0)
 S LN=LN-1,$P(^GMR(123,GMRCO,20,0),"^",3)=LN
"RTN","GMRCHL7B",120,0)
 K L,LN
"RTN","GMRCHL7B",121,0)
 Q
"RTN","GMRCHL7B",122,0)
COMMENT(GMRCARY) ;add comments to the record.  Add the comment header, then the comment lines, and lastly, the number of comment lines to the header
"RTN","GMRCHL7B",123,0)
 ;GMRCARY= GMRCNTC array
"RTN","GMRCHL7B",124,0)
 S LN=0,^GMR(123,GMRCO,40,DA,1,0)="^^^^"_$P(GMRCDA,".",1)_"^"
"RTN","GMRCHL7B",125,0)
 F  S LN=$O(GMRCARY(LN)) Q:LN=""  S ^GMR(123,+GMRCO,40,DA,1,LN,0)=GMRCARY(LN),LN1=LN
"RTN","GMRCHL7B",126,0)
 S $P(^GMR(123,+GMRCO,40,DA,1,0),"^",3,4)=LN1_"^"_LN1
"RTN","GMRCHL7B",127,0)
 K LN,LN1 Q
"RTN","GMRCHL7B",128,0)
 Q
"RTN","GMRCHL7B",129,0)
EXIT ;kill off all variables
"RTN","GMRCHL7B",130,0)
 K DA,DIC,DIE,DR,GMRCORTX,GMRCADUZ
"RTN","GMRCHL7B",131,0)
 Q
"RTN","GMRCHL7H")
0^3^B135984194^B130038973
"RTN","GMRCHL7H",1,0)
GMRCHL7H ;DSS/KC - Receive HL7 Message for HCP ;10/29/15  16:55
"RTN","GMRCHL7H",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**75,85,96**;DEC 27, 1997;Build 21
"RTN","GMRCHL7H",3,0)
 ;
"RTN","GMRCHL7H",4,0)
 ;DBIA# Supported Reference
"RTN","GMRCHL7H",5,0)
 ;----- --------------------------------
"RTN","GMRCHL7H",6,0)
 ;2161  INIT^HLFNC2
"RTN","GMRCHL7H",7,0)
 ;2164  GENERATE^HLMA
"RTN","GMRCHL7H",8,0)
 ;2944  TGET^TIUSRVR1
"RTN","GMRCHL7H",9,0)
 ;3267  SSN^DPTLK1
"RTN","GMRCHL7H",10,0)
 ;3630  BLDPID^VAFCQRY
"RTN","GMRCHL7H",11,0)
 ;5807  GETLINK^TIUSRVT1
"RTN","GMRCHL7H",12,0)
 ;10103 FMTE^XLFDT, FMTHL7^XLFDT
"RTN","GMRCHL7H",13,0)
 ;10104 UP^XLFSTR
"RTN","GMRCHL7H",14,0)
 ;10106 FMDATE^HLFNC
"RTN","GMRCHL7H",15,0)
 ;;Patch 85 fix for CA SDM ticket R6063960FY16
"RTN","GMRCHL7H",16,0)
 ;
"RTN","GMRCHL7H",17,0)
EN(MSG) ;Entry point to routine from GMRC CONSULTS TO HCP protocol attached or GMRC EVSEND OR
"RTN","GMRCHL7H",18,0)
 ;MSG = local array which contains the HL7 segments
"RTN","GMRCHL7H",19,0)
 N I,QUIT,MSGTYP,DFN,ORC,GMRCDA,FS,MSGTYP2,MSGTYP3,ACTIEN,FROMSVC,OK,OKFROM,STATUS
"RTN","GMRCHL7H",20,0)
 N UCID ;ABV/SCR 12/14/2017 *96*
"RTN","GMRCHL7H",21,0)
 S (I,QUIT)=0,I=$O(MSG(I)) Q:'I  S MSG=MSG(I) Q:$E(MSG,1,3)'="MSH"  D  Q:QUIT
"RTN","GMRCHL7H",22,0)
 .S FS=$E(MSG,4) I $P(MSG,FS,3)'="CONSULTS" S QUIT=1 Q
"RTN","GMRCHL7H",23,0)
 .S MSGTYP=$P(MSG,FS,9) I ",ORR,ORM,"'[","_MSGTYP_"," S QUIT=1 Q  ;ORR is new consult, ORM are updates
"RTN","GMRCHL7H",24,0)
 .Q
"RTN","GMRCHL7H",25,0)
 F  S I=$O(MSG(I)) Q:'I!QUIT  S MSG=MSG(I) D
"RTN","GMRCHL7H",26,0)
 .I $E(MSG,1,3)="PID" S DFN=$P(MSG,FS,4) I 'DFN!('$D(^DPT(DFN))) S QUIT=1 Q
"RTN","GMRCHL7H",27,0)
 .I $E(MSG,1,3)="ORC" S ORC=MSG S GMRCDA=+$P(ORC,FS,4),MSGTYP2=$P(ORC,FS,2),MSGTYP3=$P(ORC,FS,6) D
"RTN","GMRCHL7H",28,0)
 ..I MSGTYP3="IP" S ACTIEN=$O(^GMR(123,GMRCDA,40,99999),-1) D
"RTN","GMRCHL7H",29,0)
 ...I ACTIEN S FROMSVC=$P($G(^GMR(123,GMRCDA,40,ACTIEN,0)),U,6) I FROMSVC S OKFROM=$$FEE(FROMSVC)
"RTN","GMRCHL7H",30,0)
 ..S OK=$$FEE($$GET1^DIQ(123,GMRCDA,1,"I"))
"RTN","GMRCHL7H",31,0)
 ..I '$G(OKFROM)&'$G(OK) S QUIT=1 ;not a Fee service or not forwarded from a fee service
"RTN","GMRCHL7H",32,0)
 ..Q
"RTN","GMRCHL7H",33,0)
 .Q
"RTN","GMRCHL7H",34,0)
 Q:QUIT
"RTN","GMRCHL7H",35,0)
 I MSGTYP="ORR" S MSGTYP3="NW"
"RTN","GMRCHL7H",36,0)
 S STATUS=$$STATUS(MSGTYP2,MSGTYP3) I STATUS="UNKNOWN" Q  ;don't process anything we haven't coded for
"RTN","GMRCHL7H",37,0)
 ;done verifying this consult needs to go to HCP, start building HL7 message
"RTN","GMRCHL7H",38,0)
 N SNAME,GMRCHL,ZERR,ZCNT,ECH,DATA,GDATA,URG,TYP,RES,EFFDT,PDUZ,PN,ADDR,PH,GMRCP,SENS,DX,DXCODE
"RTN","GMRCHL7H",39,0)
 S SNAME="GMRC HCP REF-"_$S(MSGTYP2="DR":"I14",MSGTYP="ORR":"I12",MSGTYP2="OC":"I14",MSGTYP2="OD":"I14",1:"I13")_" SERVER"
"RTN","GMRCHL7H",40,0)
 S GMRCHL("EID")=$$FIND1^DIC(101,,"X",SNAME)
"RTN","GMRCHL7H",41,0)
 Q:'GMRCHL("EID")  D INIT^HLFNC2(GMRCHL("EID"),.GMRCHL)
"RTN","GMRCHL7H",42,0)
 S ZERR="",ZCNT=0,ECH=$E(GMRCHL("ECH")) ;component separator
"RTN","GMRCHL7H",43,0)
 ;start creating the segments.
"RTN","GMRCHL7H",44,0)
 S DATA=$NA(^TMP("GMRCHL7H",$J)) K @DATA D GETS^DIQ(123,GMRCDA,"*","IE",DATA)
"RTN","GMRCHL7H",45,0)
 S GDATA=$NA(^TMP("GMRCHL7H",$J,123,+GMRCDA_",")) ;File 123 data
"RTN","GMRCHL7H",46,0)
 ;RF1 segment
"RTN","GMRCHL7H",47,0)
 K GMRCM
"RTN","GMRCHL7H",48,0)
 S URG=$G(@GDATA@(5,"E")) ;I URG]"" S URG=$S(URG["ROUTINE":"R",URG["STAT":"S",1:"A")
"RTN","GMRCHL7H",49,0)
 S URG=$P(URG,"- ",2)
"RTN","GMRCHL7H",50,0)
 S TYP=$G(@GDATA@(1,"I"))_ECH_$G(@GDATA@(1,"E")) D GETLINK^TIUSRVT1(.RES,+TYP_";GMR(123.5,")
"RTN","GMRCHL7H",51,0)
 S TYP=TYP_ECH_ECH_$P($G(RES),U)_ECH_$P($G(RES),U,4)
"RTN","GMRCHL7H",52,0)
 S EFFDT=$$FMTHL7^XLFDT($G(@GDATA@(.01,"I")))
"RTN","GMRCHL7H",53,0)
 S ZCNT=ZCNT+1,GMRCM(ZCNT)="RF1|"_STATUS_"|"_URG_"|"_TYP_"||"_$G(@GDATA@(14,"I"))_"|"_GMRCDA_"|"_EFFDT_"||||"
"RTN","GMRCHL7H",54,0)
 ;**ABV/PIJ 10/10/2017 *96*- update RF1 segment
"RTN","GMRCHL7H",55,0)
 S UCID=$$GET1^DIQ(123,GMRCDA,80)
"RTN","GMRCHL7H",56,0)
 S:$G(UCID)'="" GMRCM(ZCNT)="RF1|"_STATUS_"|"_URG_"|"_TYP_"||"_$G(@GDATA@(14,"I"))_"|"_UCID_"|"_EFFDT_"||||"
"RTN","GMRCHL7H",57,0)
 S:$G(UCID)="" ^XTMP("GMRCHL7H","UCID IS EMPTY",GMRCDA)=GMRCDA ;TEMP ERROR HANDLER
"RTN","GMRCHL7H",58,0)
 ;*96*
"RTN","GMRCHL7H",59,0)
 ;PRD segment
"RTN","GMRCHL7H",60,0)
 S PDUZ=$G(@GDATA@(10,"I")),PN=$G(@GDATA@(10,"E")),PN=$$HLNAME^XLFNAME(PN,"S",ECH),$P(PN,ECH,9)=PDUZ
"RTN","GMRCHL7H",61,0)
 S ADDR=$$ADDR^GMRCHL7P(PDUZ,.GMRCHL),PH=$$PH^GMRCHL7P(PDUZ,.GMRCHL)
"RTN","GMRCHL7H",62,0)
 S ZCNT=ZCNT+1,GMRCM(ZCNT)="PRD|RP|"_PN_"|"_$G(ADDR)_"||"_$G(PH)_"|"
"RTN","GMRCHL7H",63,0)
 ;PID segment  May be multiple nodes in the return array - make nodes 2-n sub nodes
"RTN","GMRCHL7H",64,0)
 D BLDPID^VAFCQRY(DFN,1,"ALL",.GMRCP,.GMRCHL,ZERR)
"RTN","GMRCHL7H",65,0)
 S I=0 F  S I=$O(GMRCP(I)) Q:'I  D
"RTN","GMRCHL7H",66,0)
 .I I=1 S ZCNT=ZCNT+1,GMRCM(ZCNT)=$TR(GMRCP(I),"""") Q
"RTN","GMRCHL7H",67,0)
 .S GMRCM(ZCNT,I)=$TR(GMRCP(I),"""")
"RTN","GMRCHL7H",68,0)
 K GMRCP
"RTN","GMRCHL7H",69,0)
 ;DG1 segment ;Patch 85 modified
"RTN","GMRCHL7H",70,0)
 S DX=$G(@GDATA@(30,"E"))
"RTN","GMRCHL7H",71,0)
 S DXCODE=$G(@GDATA@(30.1,"E"))
"RTN","GMRCHL7H",72,0)
 I $G(DX)["(" S DX=$P(DX,"(")
"RTN","GMRCHL7H",73,0)
 S ZCNT=ZCNT+1,GMRCM(ZCNT)="DG1|1||"_$G(DXCODE)_ECH_$G(DX)_"|||W"
"RTN","GMRCHL7H",74,0)
 ;OBR segment
"RTN","GMRCHL7H",75,0)
 S ZCNT=ZCNT+1,GMRCM(ZCNT)="OBR|1|"_$P(ORC,FS,3)_"|"_$P(ORC,FS,4)_"|ZZ||"_$$FMTHL7^XLFDT($G(@GDATA@(17,"I")))
"RTN","GMRCHL7H",76,0)
 ;PV1 segment
"RTN","GMRCHL7H",77,0)
 D IN5^VADPT ;VAIP(18)=Attending Physician, VAIP(13,5)=Primary Physician for admission
"RTN","GMRCHL7H",78,0)
 S ZCNT=ZCNT+1,GMRCM(ZCNT)="PV1|1|"_$S(VAIP(13):"I",1:"O")_"|||||"_VAIP(18)_"|"
"RTN","GMRCHL7H",79,0)
 I VAIP(5) S $P(GMRCM(ZCNT),"|",4)=VAIP(5) ;location for last movement event
"RTN","GMRCHL7H",80,0)
 S SENS=$$SSN^DPTLK1(DFN) I SENS["*SENSITIVE*" S $P(GMRCM(ZCNT),"|",17)="R" ;sensitive patient
"RTN","GMRCHL7H",81,0)
 S $P(GMRCM(ZCNT),"|",18)=VAIP(13,5)
"RTN","GMRCHL7H",82,0)
 D KVA^VADPT
"RTN","GMRCHL7H",83,0)
 ;NTE segment
"RTN","GMRCHL7H",84,0)
 D NTE(.GMRCHL)
"RTN","GMRCHL7H",85,0)
 K ^TMP("GMRCHL7H",$J)
"RTN","GMRCHL7H",86,0)
 ;
"RTN","GMRCHL7H",87,0)
 ; When done, re-serve the (modified) referral message to HCP
"RTN","GMRCHL7H",88,0)
 N HL,HLA,GMRCRES,GMRCHLP
"RTN","GMRCHL7H",89,0)
 M HL=GMRCHL,HLA("HLS")=GMRCM
"RTN","GMRCHL7H",90,0)
 M GMRCHL=^XTMP("GMRCHL7H","MESSAGE")
"RTN","GMRCHL7H",91,0)
 D GENERATE^HLMA(GMRCHL("EID"),"LM",1,.GMRCRES,"",.GMRCHLP)
"RTN","GMRCHL7H",92,0)
 Q
"RTN","GMRCHL7H",93,0)
NTE(HL) ;Find Reason for Request for New or Resubmit entries, Find TIU for complete, find Activity Comment for others
"RTN","GMRCHL7H",94,0)
 N NTECNT,X S NTECNT=1
"RTN","GMRCHL7H",95,0)
 I (MSGTYP="ORR"&(MSGTYP2'="DR"))!((MSGTYP3="IP")&'$G(OKFROM)) D  Q
"RTN","GMRCHL7H",96,0)
 .D AUTHDTTM
"RTN","GMRCHL7H",97,0)
 .S ZCNT=ZCNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"|P|Reason for Request"
"RTN","GMRCHL7H",98,0)
 .S I=0 F  S I=$O(@GDATA@(20,I)) Q:'I  S X=@GDATA@(20,I) Q:X["^TMP"  D
"RTN","GMRCHL7H",99,0)
 ..S X=$$TRIM^XLFSTR(X) I $L(X)=0 Q
"RTN","GMRCHL7H",100,0)
 ..I X=$C(9,9) Q
"RTN","GMRCHL7H",101,0)
 ..D HL7TXT^GMRCHL7P(.X,.HL,"\")
"RTN","GMRCHL7H",102,0)
 ..S ZCNT=ZCNT+1,NTECNT=NTECNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||"_X
"RTN","GMRCHL7H",103,0)
 ..Q
"RTN","GMRCHL7H",104,0)
 .Q
"RTN","GMRCHL7H",105,0)
 ; Build NTE for CM^ADDENDED
"RTN","GMRCHL7H",106,0)
 I MSGTYP2="XX",MSGTYP3="CM" D  Q
"RTN","GMRCHL7H",107,0)
 .N GMRCN,GMRCTXT,GMRCCMP,GMRCASTR
"RTN","GMRCHL7H",108,0)
 .D AUTHDTTM
"RTN","GMRCHL7H",109,0)
 .S ZCNT=ZCNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"|P|Progress Note"
"RTN","GMRCHL7H",110,0)
 .S GMRCN=$P($G(^GMR(123,GMRCDA,50,1,0)),U) I GMRCN'["TIU(8925," Q
"RTN","GMRCHL7H",111,0)
 .D TGET^TIUSRVR1(.GMRCTXT,$S(+$G(GMRCPARN):+GMRCPARN,+$G(TIUDA):+TIUDA,1:+GMRCN),"VIEW")
"RTN","GMRCHL7H",112,0)
 .;
"RTN","GMRCHL7H",113,0)
 .S GMRCCMP=$$DATE($P($G(^TIU(8925,+TIUDA,13)),U),"MM/DD/CCYY")_" ADDENDUM"_"                      STATUS: "_$$GET1^DIQ(8925,+TIUDA_",",.05)
"RTN","GMRCHL7H",114,0)
 .S (I,GMRCASTR)=0
"RTN","GMRCHL7H",115,0)
 .F  S I=$O(@GMRCTXT@(I)) Q:I=""  S X=@GMRCTXT@(I) D
"RTN","GMRCHL7H",116,0)
 ..I X=GMRCCMP S GMRCASTR=I
"RTN","GMRCHL7H",117,0)
 .;
"RTN","GMRCHL7H",118,0)
 .I GMRCASTR D
"RTN","GMRCHL7H",119,0)
 ..S I=GMRCASTR-1
"RTN","GMRCHL7H",120,0)
 ..F  S I=$O(@GMRCTXT@(I)) Q:I=""  S X=@GMRCTXT@(I) D
"RTN","GMRCHL7H",121,0)
 ...S X=$$TRIM^XLFSTR(X) I $L(X)=0 Q
"RTN","GMRCHL7H",122,0)
 ...D HL7TXT^GMRCHL7P(.X,.HL,"\")
"RTN","GMRCHL7H",123,0)
 ...S ZCNT=ZCNT+1,NTECNT=NTECNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||"_X
"RTN","GMRCHL7H",124,0)
 .K ^TMP("TIUVIEW",$J) ;clean up results of TIUSRVR1 call
"RTN","GMRCHL7H",125,0)
 ;
"RTN","GMRCHL7H",126,0)
 I MSGTYP3="CM" D  Q
"RTN","GMRCHL7H",127,0)
 .N GMRCN,GMRCTXT
"RTN","GMRCHL7H",128,0)
 .D AUTHDTTM
"RTN","GMRCHL7H",129,0)
 .S ZCNT=ZCNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"|P|Progress Note"
"RTN","GMRCHL7H",130,0)
 .S GMRCN=$P($G(^GMR(123,GMRCDA,50,1,0)),U) I GMRCN'["TIU(8925," Q
"RTN","GMRCHL7H",131,0)
 .D TGET^TIUSRVR1(.GMRCTXT,$S(+$G(TIUDA):+TIUDA,1:+GMRCN),"VIEW") S I=0
"RTN","GMRCHL7H",132,0)
 .F  S I=$O(@GMRCTXT@(I)) Q:I=""  S X=@GMRCTXT@(I) D
"RTN","GMRCHL7H",133,0)
 ..S X=$$TRIM^XLFSTR(X) I $L(X)=0 Q
"RTN","GMRCHL7H",134,0)
 ..D HL7TXT^GMRCHL7P(.X,.HL,"\")
"RTN","GMRCHL7H",135,0)
 ..S ZCNT=ZCNT+1,NTECNT=NTECNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||"_X
"RTN","GMRCHL7H",136,0)
 ..Q
"RTN","GMRCHL7H",137,0)
 .K ^TMP("TIUVIEW",$J) ;clean up results of TIUSRVR1 call
"RTN","GMRCHL7H",138,0)
 .Q
"RTN","GMRCHL7H",139,0)
 I (MSGTYP2="DR") D  Q
"RTN","GMRCHL7H",140,0)
 .N ORIEN,CMT
"RTN","GMRCHL7H",141,0)
 .D AUTHDTTM
"RTN","GMRCHL7H",142,0)
 .S ZCNT=ZCNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"|L|Activity Comment"
"RTN","GMRCHL7H",143,0)
 .S ORIEN=$G(@GDATA@(.03,"I")) I 'ORIEN Q
"RTN","GMRCHL7H",144,0)
 .S CMT=$$GET1^DIQ(100,ORIEN_",",64),CMT=$$TRIM^XLFSTR(CMT)
"RTN","GMRCHL7H",145,0)
 .D HL7TXT^GMRCHL7P(.CMT,.HL,"\")
"RTN","GMRCHL7H",146,0)
 .S ZCNT=ZCNT+1,GMRCM(ZCNT)="NTE|2||"_CMT
"RTN","GMRCHL7H",147,0)
 .Q
"RTN","GMRCHL7H",148,0)
 N ACT,ACTD,ACTIEN,Q
"RTN","GMRCHL7H",149,0)
 S Q=0,ACTIEN=9999 F  S ACTIEN=$O(^GMR(123,GMRCDA,40,ACTIEN),-1) Q:'ACTIEN!Q  S X=$G(^GMR(123,GMRCDA,40,ACTIEN,0)) D
"RTN","GMRCHL7H",150,0)
 .S ACT=$P(X,U,2),ACTD=$P($P($G(^GMR(123.1,+ACT,0)),U)," ")
"RTN","GMRCHL7H",151,0)
 .I $P($P(STATUS,ECH,2)," ")'=ACTD Q
"RTN","GMRCHL7H",152,0)
 .I +$O(^GMR(123,GMRCDA,40,ACTIEN,1,0)) D AUTHDTTM
"RTN","GMRCHL7H",153,0)
 .S I=0 F  S I=$O(^GMR(123,GMRCDA,40,ACTIEN,1,I)) Q:'I  S X=$G(^GMR(123,GMRCDA,40,ACTIEN,1,I,0)) D
"RTN","GMRCHL7H",154,0)
 ..I 'Q S ZCNT=ZCNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"|L|Activity Comment",Q=1
"RTN","GMRCHL7H",155,0)
 ..S X=$$TRIM^XLFSTR(X) I $L(X)=0 Q
"RTN","GMRCHL7H",156,0)
 ..D HL7TXT^GMRCHL7P(.X,.HL,"\")
"RTN","GMRCHL7H",157,0)
 ..S ZCNT=ZCNT+1,NTECNT=NTECNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||"_X
"RTN","GMRCHL7H",158,0)
 ..Q
"RTN","GMRCHL7H",159,0)
 .Q
"RTN","GMRCHL7H",160,0)
 Q
"RTN","GMRCHL7H",161,0)
AUTHDTTM ; Add Author and Date/Time to NTE
"RTN","GMRCHL7H",162,0)
 S ACTIEN=$G(ACTIEN,$O(^GMR(123,GMRCDA,40,99999),-1))
"RTN","GMRCHL7H",163,0)
 I '+ACTIEN D  Q
"RTN","GMRCHL7H",164,0)
 .S ZCNT=ZCNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||Author\R\\R\"
"RTN","GMRCHL7H",165,0)
 .S ZCNT=ZCNT+1,NTECNT=NTECNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||Datetime\R\\R\"
"RTN","GMRCHL7H",166,0)
 .S ZCNT=ZCNT+1,NTECNT=NTECNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||Comment\R\\R\"
"RTN","GMRCHL7H",167,0)
 .S NTECNT=4
"RTN","GMRCHL7H",168,0)
 ;
"RTN","GMRCHL7H",169,0)
 S ZCNT=ZCNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||Author\R\\R\"_$$GET1^DIQ(123.02,ACTIEN_","_GMRCDA_",",4)
"RTN","GMRCHL7H",170,0)
 S ZCNT=ZCNT+1,NTECNT=NTECNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||Datetime\R\\R\"_$$FMTHL7^XLFDT($$GET1^DIQ(123.02,ACTIEN_","_GMRCDA_",",2,"I"))
"RTN","GMRCHL7H",171,0)
 S ZCNT=ZCNT+1,NTECNT=NTECNT+1,GMRCM(ZCNT)="NTE|"_NTECNT_"||Comment\R\\R\"
"RTN","GMRCHL7H",172,0)
 S NTECNT=4
"RTN","GMRCHL7H",173,0)
 Q
"RTN","GMRCHL7H",174,0)
STATUS(T1,T2) ;get status for event
"RTN","GMRCHL7H",175,0)
 ;also add IP^COMMENT when those events are captured
"RTN","GMRCHL7H",176,0)
 I T2="DC"!(T1="DR") Q "DC^DISCONTINUED"
"RTN","GMRCHL7H",177,0)
 I T2="NW" Q "NW^CPRS RELEASED ORDER"
"RTN","GMRCHL7H",178,0)
 I T1="SC"&(T2="SC") Q "SC^RECEIVED"
"RTN","GMRCHL7H",179,0)
 I T1="SC"&(T2="ZC") Q "SC^SCHEDULED"
"RTN","GMRCHL7H",180,0)
 I T1="XX"&(T2="XX") Q "IP^ADDED COMMENT"
"RTN","GMRCHL7H",181,0)
 I T2="CA" Q "CA^CANCELLED"
"RTN","GMRCHL7H",182,0)
 I T2="CM" D
"RTN","GMRCHL7H",183,0)
 .I '+$G(GMRCPARN),'+$G(TIUDA) S GMRCPARN=$P($G(^GMR(123,GMRCDA,50,1,0)),U)
"RTN","GMRCHL7H",184,0)
 .S $P(ORC,FS,4)=$S(+$G(GMRCPARN):+GMRCPARN_";TIU^TIU",+$G(TIUDA):+TIUDA_";TIU^TIU",1:$P(ORC,FS,4))
"RTN","GMRCHL7H",185,0)
 I T1="XX"&(T2="CM") Q "CM^ADDENDED"
"RTN","GMRCHL7H",186,0)
 I T2="CM" Q "CM^COMPLETE"
"RTN","GMRCHL7H",187,0)
 I T1="XX"&(T2="IP")&$G(OKFROM) Q "XX^FORWARDED"
"RTN","GMRCHL7H",188,0)
 I T1="XX"&(T2="IP") Q "IP^RESUBMITTED"
"RTN","GMRCHL7H",189,0)
 Q "UNKNOWN"
"RTN","GMRCHL7H",190,0)
FEE(FEESVC) ;send only if name contains HCPS
"RTN","GMRCHL7H",191,0)
 I $G(FEESVC)="" Q 0
"RTN","GMRCHL7H",192,0)
 N VAL
"RTN","GMRCHL7H",193,0)
 S VAL=0
"RTN","GMRCHL7H",194,0)
 I $$UP^XLFSTR($$GET1^DIQ(123.5,FEESVC,.01,"E"))["HCPS" S VAL=1
"RTN","GMRCHL7H",195,0)
 Q VAL
"RTN","GMRCHL7H",196,0)
COMMENT(GMRCDA) ;send comments on Non VA Care consults to HCP
"RTN","GMRCHL7H",197,0)
 ;create a fake event for HCP since there is no HL7 event passed to GMRC EVSEND OR
"RTN","GMRCHL7H",198,0)
 I '$G(GMRCDA) Q
"RTN","GMRCHL7H",199,0)
 N DFN S DFN=$$GET1^DIQ(123,GMRCDA,.02,"I") I 'DFN,'$D(^DPT(DFN)) Q
"RTN","GMRCHL7H",200,0)
 N T S T(1)="MSH|^~\&|CONSULTS||||||ORM"
"RTN","GMRCHL7H",201,0)
 S T(2)="PID|||"_DFN
"RTN","GMRCHL7H",202,0)
 S T(4)="ORC|XX|"_$$GET1^DIQ(123,GMRCDA,.03,"I")_";"_$$OITEM($$GET1^DIQ(123,GMRCDA,.03,"I"))_"^OR|"_GMRCDA_";GMRC^GMRC||XX|"
"RTN","GMRCHL7H",203,0)
 D EN(.T)
"RTN","GMRCHL7H",204,0)
 Q
"RTN","GMRCHL7H",205,0)
ADDEND(TIUDA) ;send addendums on Non VA Care consults to HCP
"RTN","GMRCHL7H",206,0)
 ;create a fake event for HCP since there is no HL7 event passed to GMRC EVSEND OR
"RTN","GMRCHL7H",207,0)
 I '$G(TIUDA) Q
"RTN","GMRCHL7H",208,0)
 Q:'$D(^TIU(8925,+TIUDA,0))
"RTN","GMRCHL7H",209,0)
 N TIUTYP,DFN,GMRCPARN,GMRCO,GMRCD,GMRCDA,GMRCD1,GMRC8925,T
"RTN","GMRCHL7H",210,0)
 ;
"RTN","GMRCHL7H",211,0)
 ; Quit if not an addendum
"RTN","GMRCHL7H",212,0)
 S TIUTYP=$$GET1^DIQ(8925,TIUDA,.01,"I")
"RTN","GMRCHL7H",213,0)
 I TIUTYP'=81 Q
"RTN","GMRCHL7H",214,0)
 ;
"RTN","GMRCHL7H",215,0)
 S DFN=$$GET1^DIQ(8925,TIUDA,.02,"I")
"RTN","GMRCHL7H",216,0)
 I 'DFN,'$D(^DPT(DFN)) Q
"RTN","GMRCHL7H",217,0)
 ;
"RTN","GMRCHL7H",218,0)
 ; Get parent note IEN, if addendum IEN is passed in:
"RTN","GMRCHL7H",219,0)
 S GMRCPARN=$$GET1^DIQ(8925,TIUDA,.06,"I")
"RTN","GMRCHL7H",220,0)
 ;
"RTN","GMRCHL7H",221,0)
 S (GMRCO,GMRCD)=0
"RTN","GMRCHL7H",222,0)
 F  S GMRCD=$O(^GMR(123,"AD",DFN,GMRCD)) Q:'GMRCD!(GMRCO)  D
"RTN","GMRCHL7H",223,0)
 .S GMRCDA=0
"RTN","GMRCHL7H",224,0)
 .F  S GMRCDA=$O(^GMR(123,"AD",DFN,GMRCD,GMRCDA)) Q:'GMRCDA!(GMRCO)  D
"RTN","GMRCHL7H",225,0)
 ..S GMRCD1=0
"RTN","GMRCHL7H",226,0)
 ..F  S GMRCD1=$O(^GMR(123,GMRCDA,50,GMRCD1)) Q:'GMRCD1!(GMRCO)  D
"RTN","GMRCHL7H",227,0)
 ...S GMRC8925=$$GET1^DIQ(123.03,GMRCD1_","_GMRCDA_",",.01,"I")
"RTN","GMRCHL7H",228,0)
 ...I +GMRC8925=$S(+GMRCPARN:+GMRCPARN,1:TIUDA) S GMRCO=GMRCDA
"RTN","GMRCHL7H",229,0)
 Q:'GMRCO
"RTN","GMRCHL7H",230,0)
 ;
"RTN","GMRCHL7H",231,0)
 S T(1)="MSH|^~\&|CONSULTS||||||ORM"
"RTN","GMRCHL7H",232,0)
 S T(2)="PID|||"_DFN
"RTN","GMRCHL7H",233,0)
 S T(4)="ORC|XX|"_$$GET1^DIQ(123,GMRCO,.03,"I")_";"_$$OITEM($$GET1^DIQ(123,GMRCO,.03,"I"))_"^OR|"_GMRCO_";GMRC^GMRC||CM|"
"RTN","GMRCHL7H",234,0)
 I $$FEE($$GET1^DIQ(123,GMRCO,1,"I")) D EN(.T)
"RTN","GMRCHL7H",235,0)
 Q
"RTN","GMRCHL7H",236,0)
TIME(X,FMT) ; Copied from $$TIME^TIULS
"RTN","GMRCHL7H",237,0)
 ; Recieves X as 2910419.01 and FMT=Return Format of time (HH:MM:SS).
"RTN","GMRCHL7H",238,0)
 N HR,MIN,SEC,TIUI
"RTN","GMRCHL7H",239,0)
 I $S('$D(FMT):1,'$L(FMT):1,1:0) S FMT="HR:MIN"
"RTN","GMRCHL7H",240,0)
 S X=$P(X,".",2),HR=$E(X,1,2)_$E("00",0,2-$L($E(X,1,2))),MIN=$E(X,3,4)_$E("00",0,2-$L($E(X,3,4))),SEC=$E(X,5,6)_$E("00",0,2-$L($E(X,5,6)))
"RTN","GMRCHL7H",241,0)
 F TIUI="HR","MIN","SEC" S:FMT[TIUI FMT=$P(FMT,TIUI)_@TIUI_$P(FMT,TIUI,2)
"RTN","GMRCHL7H",242,0)
 Q FMT
"RTN","GMRCHL7H",243,0)
DATE(X,FMT) ; Copied from $$DATE^TIULS
"RTN","GMRCHL7H",244,0)
 ; Call with X=2910419.01 and FMT=Return Format of date ("MM/DD")
"RTN","GMRCHL7H",245,0)
 N AMTH,MM,CC,DD,YY,TIUI,TIUTMP
"RTN","GMRCHL7H",246,0)
 I +X'>0 S $P(TIUTMP," ",$L($G(FMT))+1)="",FMT=TIUTMP G QDATE
"RTN","GMRCHL7H",247,0)
 I $S('$D(FMT):1,'$L(FMT):1,1:0) S FMT="MM/DD/YY"
"RTN","GMRCHL7H",248,0)
 S MM=$E(X,4,5),DD=$E(X,6,7),YY=$E(X,2,3),CC=17+$E(X)
"RTN","GMRCHL7H",249,0)
 S:FMT["AMTH" AMTH=$P("JAN^FEB^MAR^APR^MAY^JUN^JUL^AUG^SEP^OCT^NOV^DEC","^",+MM)
"RTN","GMRCHL7H",250,0)
 F TIUI="AMTH","MM","DD","CC","YY" S:FMT[TIUI FMT=$P(FMT,TIUI)_@TIUI_$P(FMT,TIUI,2)
"RTN","GMRCHL7H",251,0)
 I FMT["HR" S FMT=$$TIME(X,FMT)
"RTN","GMRCHL7H",252,0)
QDATE Q FMT
"RTN","GMRCHL7H",253,0)
OITEM(GMRCORDN) ; Orderable Item
"RTN","GMRCHL7H",254,0)
 N RETVAL,GMRCOITM
"RTN","GMRCHL7H",255,0)
 S RETVAL=1
"RTN","GMRCHL7H",256,0)
 S GMRCOITM=+$O(^OR(100,GMRCORDN,.1,0))
"RTN","GMRCHL7H",257,0)
 I GMRCOITM D
"RTN","GMRCHL7H",258,0)
 .S RETVAL=+$G(^OR(100,GMRCORDN,.1,GMRCOITM,0))
"RTN","GMRCHL7H",259,0)
 .I 'RETVAL S RETVAL=1
"RTN","GMRCHL7H",260,0)
 Q RETVAL
"RTN","GMRCHL7H",261,0)
ACK ; Process ACK HL7 messages
"RTN","GMRCHL7H",262,0)
 N GMRCMSG,I,X,DONE,MSGID,ERRARY,ERRI
"RTN","GMRCHL7H",263,0)
 ;Get the message
"RTN","GMRCHL7H",264,0)
 S ERRI=0
"RTN","GMRCHL7H",265,0)
 F I=1:1 X HLNEXT Q:(HLQUIT'>0)  D
"RTN","GMRCHL7H",266,0)
 . S GMRCMSG(I,1)=HLNODE
"RTN","GMRCHL7H",267,0)
 . S X=0 F  S X=+$O(HLNODE(X)) Q:'X  S GMRCMSG(I,(X+1))=HLNODE(X)
"RTN","GMRCHL7H",268,0)
 S DONE=0
"RTN","GMRCHL7H",269,0)
 S I=0 F  S I=$O(GMRCMSG(I)) Q:'+I  D  Q:DONE
"RTN","GMRCHL7H",270,0)
 . I $P($G(GMRCMSG(I,1)),"|",1)="MSA" D  Q
"RTN","GMRCHL7H",271,0)
 . . I $P($G(GMRCMSG(I,1)),"|",2)="AA" S DONE=1 Q
"RTN","GMRCHL7H",272,0)
 . . S MSGID=$P($G(GMRCMSG(I,1)),"|",3)
"RTN","GMRCHL7H",273,0)
 . I $P($G(GMRCMSG(I,1)),"|",1)="ERR" D
"RTN","GMRCHL7H",274,0)
 . . ;Process Error
"RTN","GMRCHL7H",275,0)
 . . S ERRI=ERRI+1
"RTN","GMRCHL7H",276,0)
 . . S ERRARY(ERRI,2)=$P($G(GMRCMSG(I,1)),"|",3)
"RTN","GMRCHL7H",277,0)
 . . I $P($G(GMRCMSG(I,1)),"|",6)'="" D  Q
"RTN","GMRCHL7H",278,0)
 . . . S ERRARY(ERRI,3)=$P($P($G(GMRCMSG(I,1)),"|",6),"^",4)_"^"_$P($P($G(GMRCMSG(I,1)),"|",6),"^",5)
"RTN","GMRCHL7H",279,0)
 . . S ERRARY(ERRI,3)=$P($G(GMRCMSG(I,1)),"|",4)
"RTN","GMRCHL7H",280,0)
 I $D(ERRARY) D MESSAGE(MSGID,.ERRARY)
"RTN","GMRCHL7H",281,0)
 Q
"RTN","GMRCHL7H",282,0)
MESSAGE(MSGID,ERRARY) ; Send a MailMan Message with the errors
"RTN","GMRCHL7H",283,0)
 N MSGTEXT,DUZ,XMDUZ,XMSUB,XMTEXT,XMY,XMMG,XMSTRIP,XMROU,DIFROM,XMYBLOB,XMZ,XMMG,DATE,J
"RTN","GMRCHL7H",284,0)
 S DATE=$$FMTE^XLFDT($$FMDATE^HLFNC($P(HL("DTM"),"-",1)))
"RTN","GMRCHL7H",285,0)
 S XMSUB="GMRC Consults to HCP HL7 Error"
"RTN","GMRCHL7H",286,0)
 S MSGTEXT(1)=" "
"RTN","GMRCHL7H",287,0)
 S MSGTEXT(2)="Error in transmitting HL7 message to HCP"
"RTN","GMRCHL7H",288,0)
 S MSGTEXT(3)="Date:       "_DATE
"RTN","GMRCHL7H",289,0)
 S MSGTEXT(4)="Message ID: "_MSGID
"RTN","GMRCHL7H",290,0)
 S MSGTEXT(5)="Error(s):"
"RTN","GMRCHL7H",291,0)
 S I=0,J=5 F  S I=$O(ERRARY(I)) Q:'I  D
"RTN","GMRCHL7H",292,0)
 . S J=J+1,MSGTEXT(J)=" "
"RTN","GMRCHL7H",293,0)
 . S J=J+1,MSGTEXT(J)="   "_$P($G(ERRARY(I,3)),U)_" - "_$P($G(ERRARY(I,3)),U,2)
"RTN","GMRCHL7H",294,0)
 . I $P($G(ERRARY(I,2)),U,1)'="" S J=J+1,MSGTEXT(J)="      Segment:       "_$P($G(ERRARY(I,2)),U,1)
"RTN","GMRCHL7H",295,0)
 . I $P($G(ERRARY(I,2)),U,2)'="" S J=J+1,MSGTEXT(J)="      Sequence:      "_$P($G(ERRARY(I,2)),U,2)
"RTN","GMRCHL7H",296,0)
 . I $P($G(ERRARY(I,2)),U,3)'="" S J=J+1,MSGTEXT(J)="      Field:         "_$P($G(ERRARY(I,2)),U,3)
"RTN","GMRCHL7H",297,0)
 . I $P($G(ERRARY(I,2)),U,4)'="" S J=J+1,MSGTEXT(J)="      Fld Rep:       "_$P($G(ERRARY(I,2)),U,4)
"RTN","GMRCHL7H",298,0)
 . I $P($G(ERRARY(I,2)),U,5)'="" S J=J+1,MSGTEXT(J)="      Component:     "_$P($G(ERRARY(I,2)),U,5)
"RTN","GMRCHL7H",299,0)
 . I $P($G(ERRARY(I,2)),U,6)'="" S J=J+1,MSGTEXT(J)="      Sub-component: "_$P($G(ERRARY(I,2)),U,6)
"RTN","GMRCHL7H",300,0)
 S XMTEXT="MSGTEXT("
"RTN","GMRCHL7H",301,0)
 S XMDUZ="GMRC->HCP Transaction Error"
"RTN","GMRCHL7H",302,0)
 S XMY("G.GMRC HCP HL7 MESSAGES")=""
"RTN","GMRCHL7H",303,0)
 D ^XMD
"RTN","GMRCHL7H",304,0)
 Q
"RTN","GMRCP96")
0^^B21123189^n/a
"RTN","GMRCP96",1,0)
GMRCP96 ;ABV/SCR - Post-Install Routine for patch 96 ;12/8/17 07:36
"RTN","GMRCP96",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**96**;DEC 27;Build 21; 1997;Build 1
"RTN","GMRCP96",3,0)
 ;
"RTN","GMRCP96",4,0)
 ;This routine locates a a unique three digit site id used by Community Care and updates the newly added
"RTN","GMRCP96",5,0)
 ;  GMRC UNIQUE CONSULT SITE ID paramater with the value for this site.
"RTN","GMRCP96",6,0)
 ; if a value is not identified, a default value of 999 is used
"RTN","GMRCP96",7,0)
 Q
"RTN","GMRCP96",8,0)
 ;
"RTN","GMRCP96",9,0)
POST ;updates GMRC UNIQUE CONSULT ID paramater with a mapped value
"RTN","GMRCP96",10,0)
 N GMRCSITE,GMRCID
"RTN","GMRCP96",11,0)
 N GMRCHECK ;pij 4/8/2018
"RTN","GMRCP96",12,0)
 ;
"RTN","GMRCP96",13,0)
 ;*** v8 I am adding a default of 999 to the PARAMETERS file. PIJ 5/3/2018
"RTN","GMRCP96",14,0)
 D EN^XPAR("PKG.CONSULT/REQUEST TRACKING","GMRC UNIQUE CONSULT SITE ID",,999)
"RTN","GMRCP96",15,0)
 ;***
"RTN","GMRCP96",16,0)
 ;
"RTN","GMRCP96",17,0)
 S GMRCSITE=$P($$SITE^VASITE(),U,3)
"RTN","GMRCP96",18,0)
 S GMRCID=$$GET^XPAR("PKG.CONSULT/REQUEST TRACKING","GMRC UNIQUE CONSULT SITE ID") ;If this value has been set, don't overwrite
"RTN","GMRCP96",19,0)
 ;I $G(GMRCID)'="" D
"RTN","GMRCP96",20,0)
 I $G(GMRCID)'=999 D  ; We are shipping 999 as a value from #8989.5
"RTN","GMRCP96",21,0)
 .D MES^XPDUTL("Your GMRC UNIQUE CONSULT SITE ID value was found in the PARAMETER file: "_GMRCID)
"RTN","GMRCP96",22,0)
 .I (GMRCID=999) D
"RTN","GMRCP96",23,0)
 ..S GMRCID=""
"RTN","GMRCP96",24,0)
 ..D MES^XPDUTL("Will look for a mapped value to replace default 999")
"RTN","GMRCP96",25,0)
 ;I $G(GMRCID)="" D
"RTN","GMRCP96",26,0)
 I $G(GMRCID)=999 D
"RTN","GMRCP96",27,0)
 .S GMRCID=$$MAPID(GMRCSITE)
"RTN","GMRCP96",28,0)
 .D BMES^XPDUTL()
"RTN","GMRCP96",29,0)
 .D MES^XPDUTL("*********************************")
"RTN","GMRCP96",30,0)
 .D MES^XPDUTL("PLEASE NOTE: Your SITE ID will not be changed.")
"RTN","GMRCP96",31,0)
 .D MES^XPDUTL("The GMRC UNIQUE CONSULT SITE ID parameter will be set.")
"RTN","GMRCP96",32,0)
 .D MES^XPDUTL("*********************************")
"RTN","GMRCP96",33,0)
 .D BMES^XPDUTL()
"RTN","GMRCP96",34,0)
 .D MES^XPDUTL("These are the instructions for the patch installer at your site...")
"RTN","GMRCP96",35,0)
 .D MES^XPDUTL("1. Your SITE ID number is... '"_GMRCSITE_"'")
"RTN","GMRCP96",36,0)
 .D MES^XPDUTL("2. Your GMRC UNIQUE CONSULT SITE ID number is... '"_GMRCID_"'")
"RTN","GMRCP96",37,0)
 .D MES^XPDUTL("3. Please reference the attached Post-Install instructions to verify that the GMRC UNIQUE CONSULT SITE ID is correct")
"RTN","GMRCP96",38,0)
 .D EN^XPAR("PKG.CONSULT/REQUEST TRACKING","GMRC UNIQUE CONSULT SITE ID",,GMRCID)
"RTN","GMRCP96",39,0)
 .;
"RTN","GMRCP96",40,0)
 .D BMES^XPDUTL()
"RTN","GMRCP96",41,0)
 .D MES^XPDUTL("Your GMRC UNIQUE CONSULT SITE ID value has been set in the PARAMETER file: "_$$GET^XPAR("PKG.CONSULT/REQUEST TRACKING","GMRC UNIQUE CONSULT SITE ID"))
"RTN","GMRCP96",42,0)
 D BMES^XPDUTL()
"RTN","GMRCP96",43,0)
 D MES^XPDUTL("If your GMRC UNIQUE CONSULT SITE ID number is '999' please contact IRM for assistance")
"RTN","GMRCP96",44,0)
 Q
"RTN","GMRCP96",45,0)
 ;
"RTN","GMRCP96",46,0)
MAPID(GMRCSITE)  ;RETURN A MAPPED 3 DIGIT VALUE FOR A SITE ID - DEFAULT TO 999
"RTN","GMRCP96",47,0)
 ; INPUT GMRCSITE IS THE SITE ID
"RTN","GMRCP96",48,0)
 ; RETURN: IS THE MAPPED GMRC VISTA SITE ID
"RTN","GMRCP96",49,0)
 N GMRCRTN
"RTN","GMRCP96",50,0)
 N GMRCNXT ;pij 4/8/2018
"RTN","GMRCP96",51,0)
 S GMRCRTN=999
"RTN","GMRCP96",52,0)
 S GMRCNXT=1
"RTN","GMRCP96",53,0)
 F  S GMRCNXT=$T(MAP)+GMRCNXT Q:GMRCNXT=0  D
"RTN","GMRCP96",54,0)
 .S GMRCHECK=$P($T(MAP+GMRCNXT),";;",2)
"RTN","GMRCP96",55,0)
 .I $P(GMRCHECK,":",1)=GMRCSITE S GMRCRTN=$P(GMRCHECK,":",2)
"RTN","GMRCP96",56,0)
 .S:GMRCRTN=999 GMRCNXT=GMRCNXT+1
"RTN","GMRCP96",57,0)
 .S:GMRCRTN'=999 GMRCNXT=0
"RTN","GMRCP96",58,0)
 .S:GMRCHECK="" GMRCNXT=0
"RTN","GMRCP96",59,0)
 Q GMRCRTN
"RTN","GMRCP96",60,0)
MAP ;;ASSOCIATE SITE ID TO THREE DIGIT CC SITE ID
"RTN","GMRCP96",61,0)
 ;;402:202
"RTN","GMRCP96",62,0)
 ;;405:203
"RTN","GMRCP96",63,0)
 ;;518:204
"RTN","GMRCP96",64,0)
 ;;523:205
"RTN","GMRCP96",65,0)
 ;;608:208
"RTN","GMRCP96",66,0)
 ;;631:209
"RTN","GMRCP96",67,0)
 ;;650:210
"RTN","GMRCP96",68,0)
 ;;689:212
"RTN","GMRCP96",69,0)
 ;;526:218
"RTN","GMRCP96",70,0)
 ;;528:215
"RTN","GMRCP96",71,0)
 ;;528A5:216
"RTN","GMRCP96",72,0)
 ;;528A6:214
"RTN","GMRCP96",73,0)
 ;;528A7:217
"RTN","GMRCP96",74,0)
 ;;528A8:213
"RTN","GMRCP96",75,0)
 ;;561:221
"RTN","GMRCP96",76,0)
 ;;620:223
"RTN","GMRCP96",77,0)
 ;;630:224
"RTN","GMRCP96",78,0)
 ;;632:225
"RTN","GMRCP96",79,0)
 ;;460:226
"RTN","GMRCP96",80,0)
 ;;503:227
"RTN","GMRCP96",81,0)
 ;;529:228
"RTN","GMRCP96",82,0)
 ;;542:230
"RTN","GMRCP96",83,0)
 ;;562:231
"RTN","GMRCP96",84,0)
 ;;595:232
"RTN","GMRCP96",85,0)
 ;;642:233
"RTN","GMRCP96",86,0)
 ;;646:234
"RTN","GMRCP96",87,0)
 ;;693:235
"RTN","GMRCP96",88,0)
 ;;512:236
"RTN","GMRCP96",89,0)
 ;;517:241
"RTN","GMRCP96",90,0)
 ;;540:229
"RTN","GMRCP96",91,0)
 ;;581:265
"RTN","GMRCP96",92,0)
 ;;613:239
"RTN","GMRCP96",93,0)
 ;;688:240
"RTN","GMRCP96",94,0)
 ;;558:242
"RTN","GMRCP96",95,0)
 ;;565:243
"RTN","GMRCP96",96,0)
 ;;590:244
"RTN","GMRCP96",97,0)
 ;;637:245
"RTN","GMRCP96",98,0)
 ;;652:246
"RTN","GMRCP96",99,0)
 ;;658:247
"RTN","GMRCP96",100,0)
 ;;659:248
"RTN","GMRCP96",101,0)
 ;;508:249
"RTN","GMRCP96",102,0)
 ;;509:250
"RTN","GMRCP96",103,0)
 ;;521:251
"RTN","GMRCP96",104,0)
 ;;534:252
"RTN","GMRCP96",105,0)
 ;;544:253
"RTN","GMRCP96",106,0)
 ;;557:254
"RTN","GMRCP96",107,0)
 ;;619:256
"RTN","GMRCP96",108,0)
 ;;679:257
"RTN","GMRCP96",109,0)
 ;;516:258
"RTN","GMRCP96",110,0)
 ;;546:259
"RTN","GMRCP96",111,0)
 ;;548:260
"RTN","GMRCP96",112,0)
 ;;573:261
"RTN","GMRCP96",113,0)
 ;;672:263
"RTN","GMRCP96",114,0)
 ;;673:264
"RTN","GMRCP96",115,0)
 ;;675:358
"RTN","GMRCP96",116,0)
 ;;596:267
"RTN","GMRCP96",117,0)
 ;;603:268
"RTN","GMRCP96",118,0)
 ;;614:269
"RTN","GMRCP96",119,0)
 ;;621:270
"RTN","GMRCP96",120,0)
 ;;626:272
"RTN","GMRCP96",121,0)
 ;;506:279
"RTN","GMRCP96",122,0)
 ;;515:280
"RTN","GMRCP96",123,0)
 ;;538:273
"RTN","GMRCP96",124,0)
 ;;539:274
"RTN","GMRCP96",125,0)
 ;;541:276
"RTN","GMRCP96",126,0)
 ;;552:277
"RTN","GMRCP96",127,0)
 ;;553:282
"RTN","GMRCP96",128,0)
 ;;583:283
"RTN","GMRCP96",129,0)
 ;;610:284
"RTN","GMRCP96",130,0)
 ;;655:285
"RTN","GMRCP96",131,0)
 ;;757:278
"RTN","GMRCP96",132,0)
 ;;537:287
"RTN","GMRCP96",133,0)
 ;;550:281
"RTN","GMRCP96",134,0)
 ;;556:288
"RTN","GMRCP96",135,0)
 ;;578:289
"RTN","GMRCP96",136,0)
 ;;585:290
"RTN","GMRCP96",137,0)
 ;;607:291
"RTN","GMRCP96",138,0)
 ;;676:292
"RTN","GMRCP96",139,0)
 ;;695:293
"RTN","GMRCP96",140,0)
 ;;589:295
"RTN","GMRCP96",141,0)
 ;;589A4:294
"RTN","GMRCP96",142,0)
 ;;589A5:297
"RTN","GMRCP96",143,0)
 ;;589A7:298
"RTN","GMRCP96",144,0)
 ;;657:302
"RTN","GMRCP96",145,0)
 ;;657A4:300
"RTN","GMRCP96",146,0)
 ;;657A5:299
"RTN","GMRCP96",147,0)
 ;;502:303
"RTN","GMRCP96",148,0)
 ;;520:304
"RTN","GMRCP96",149,0)
 ;;564:305
"RTN","GMRCP96",150,0)
 ;;580:306
"RTN","GMRCP96",151,0)
 ;;586:307
"RTN","GMRCP96",152,0)
 ;;598:308
"RTN","GMRCP96",153,0)
 ;;629:310
"RTN","GMRCP96",154,0)
 ;;667:312
"RTN","GMRCP96",155,0)
 ;;504:317
"RTN","GMRCP96",156,0)
 ;;519:318
"RTN","GMRCP96",157,0)
 ;;549:313
"RTN","GMRCP96",158,0)
 ;;671:314
"RTN","GMRCP96",159,0)
 ;;674:315
"RTN","GMRCP96",160,0)
 ;;740:427
"RTN","GMRCP96",161,0)
 ;;756:322
"RTN","GMRCP96",162,0)
 ;;436:323
"RTN","GMRCP96",163,0)
 ;;442:325
"RTN","GMRCP96",164,0)
 ;;554:326
"RTN","GMRCP96",165,0)
 ;;575:327
"RTN","GMRCP96",166,0)
 ;;623:309
"RTN","GMRCP96",167,0)
 ;;635:311
"RTN","GMRCP96",168,0)
 ;;660:328
"RTN","GMRCP96",169,0)
 ;;666:329
"RTN","GMRCP96",170,0)
 ;;463:330
"RTN","GMRCP96",171,0)
 ;;531:331
"RTN","GMRCP96",172,0)
 ;;648:332
"RTN","GMRCP96",173,0)
 ;;653:333
"RTN","GMRCP96",174,0)
 ;;663:334
"RTN","GMRCP96",175,0)
 ;;668:335
"RTN","GMRCP96",176,0)
 ;;687:336
"RTN","GMRCP96",177,0)
 ;;692:337
"RTN","GMRCP96",178,0)
 ;;459:339
"RTN","GMRCP96",179,0)
 ;;570:340
"RTN","GMRCP96",180,0)
 ;;593:345
"RTN","GMRCP96",181,0)
 ;;612A4:341
"RTN","GMRCP96",182,0)
 ;;640:342
"RTN","GMRCP96",183,0)
 ;;654:343
"RTN","GMRCP96",184,0)
 ;;662:344
"RTN","GMRCP96",185,0)
 ;;501:316
"RTN","GMRCP96",186,0)
 ;;600:346
"RTN","GMRCP96",187,0)
 ;;605:347
"RTN","GMRCP96",188,0)
 ;;644:319
"RTN","GMRCP96",189,0)
 ;;649:320
"RTN","GMRCP96",190,0)
 ;;664:348
"RTN","GMRCP96",191,0)
 ;;678:321
"RTN","GMRCP96",192,0)
 ;;691:349
"RTN","GMRCP96",193,0)
 ;;437:350
"RTN","GMRCP96",194,0)
 ;;438:351
"RTN","GMRCP96",195,0)
 ;;568:352
"RTN","GMRCP96",196,0)
 ;;618:353
"RTN","GMRCP96",197,0)
 ;;636:356
"RTN","GMRCP96",198,0)
 ;;636A6:354
"RTN","GMRCP96",199,0)
 ;;636A8:355
"RTN","GMRCP96",200,0)
 ;;656:357
"RTN","GMRCP96",201,0)
 Q
"RTN","GMRCUTL1")
0^1^B17295672^B14006176
"RTN","GMRCUTL1",1,0)
GMRCUTL1 ;SLC/DCM,JFR,MA - General Utilities ;04/27/2017  15:23
"RTN","GMRCUTL1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,12,15,21,17,28,89,96**;DEC 27, 1997;Build 21
"RTN","GMRCUTL1",3,0)
 ; Added call to GMRCUTL2 for secondary printer
"RTN","GMRCUTL1",4,0)
 ; This routine invokes IA #2876,3121
"RTN","GMRCUTL1",5,0)
 ; Patch #21 added variable GMRCAUDT and moved line tag PRNTAUDT
"RTN","GMRCUTL1",6,0)
 ; to GMRCP5A.
"RTN","GMRCUTL1",7,0)
 ;
"RTN","GMRCUTL1",8,0)
 ; ABV/SCR - 12/14/2017 added tag NEWUCID for patch number TBD to return the UniqueConsultID which is added to 
"RTN","GMRCUTL1",9,0)
 ;           ORIGINAL records (records created through CPRS)
"RTN","GMRCUTL1",10,0)
 ;
"RTN","GMRCUTL1",11,0)
ACTM ;;Set correct variables to complete, discontinue, etc. a consult
"RTN","GMRCUTL1",12,0)
 K GMRCQUT
"RTN","GMRCUTL1",13,0)
 S:'+$G(GMRCA) GMRCA=$O(^GMR(123.1,"B",GMRCACTM,""))
"RTN","GMRCUTL1",14,0)
 S GMRCACTM=$P($G(^GMR(123.1,+GMRCA,0)),"^")
"RTN","GMRCUTL1",15,0)
 S ORSTS=$S(GMRCA:$P(^GMR(123.1,GMRCA,0),"^",2),1:0)
"RTN","GMRCUTL1",16,0)
 I 'GMRCA S GMRCQUT=1
"RTN","GMRCUTL1",17,0)
 Q
"RTN","GMRCUTL1",18,0)
PRNT(SRVCIFN,GMRCO) ;print form 513 to a printer when new consult is entered
"RTN","GMRCUTL1",19,0)
 D PRNT^GMRCUTL2(SRVCIFN,GMRCO)  ;89 call for secondary copy
"RTN","GMRCUTL1",20,0)
 N ORVP,GMRCDEV,GMRCQUED,IOP,%ZIS,POP,ZTDTH,ZTDESC,ZTIO,ZTRTN,ZTSK,GMRCAUDT
"RTN","GMRCUTL1",21,0)
 I '$G(SRVCIFN) S SRVCIFN=+$P(^GMR(123,GMRCO,0),U,5)
"RTN","GMRCUTL1",22,0)
 Q:'$D(^GMR(123.5,SRVCIFN,123))  Q:'$P(^GMR(123.5,SRVCIFN,123),"^",9)
"RTN","GMRCUTL1",23,0)
 S IOP="`"_$P(^GMR(123.5,SRVCIFN,123),"^",9)
"RTN","GMRCUTL1",24,0)
 S %ZIS="N" D ^%ZIS I POP S %ZIS=0 D HOME^%ZIS Q
"RTN","GMRCUTL1",25,0)
 S GMRCDEV=ION,GMRCQUED=1,GMRCAUDT=1
"RTN","GMRCUTL1",26,0)
 S ZTRTN="PRNT^GMRCP5A("_(+GMRCO)_","_(+$G(TIUFLG))_",1,"""_$G(GMRCCPY,"W")_""",0,"_(GMRCAUDT)_")"
"RTN","GMRCUTL1",27,0)
 S ZTDESC="CONSULT/REQUEST PACKAGE PRINT FORM 513 FOR NEW CONSULT"
"RTN","GMRCUTL1",28,0)
 S ZTIO=GMRCDEV,ZTDTH=$H
"RTN","GMRCUTL1",29,0)
 D ^%ZTLOAD
"RTN","GMRCUTL1",30,0)
 S %ZIS=0 D HOME^%ZIS
"RTN","GMRCUTL1",31,0)
 K GMRCQUED,GMRCDEV1
"RTN","GMRCUTL1",32,0)
 Q
"RTN","GMRCUTL1",33,0)
END K GMRCDEV,GMRCDEV1,GMRCOREC,GMRCFMT
"RTN","GMRCUTL1",34,0)
 Q
"RTN","GMRCUTL1",35,0)
PROVDX(OI) ;return PROV DX prompting info from 123.5
"RTN","GMRCUTL1",36,0)
 ;    Input:
"RTN","GMRCUTL1",37,0)
 ;       OI = ref to file 123.5("#;99CON") or file 123.3 (#;99PRC)
"RTN","GMRCUTL1",38,0)
 ;
"RTN","GMRCUTL1",39,0)
 ;    Returns:  string  A^B
"RTN","GMRCUTL1",40,0)
 ;       A = O (optional), R (required) or S (suppress)
"RTN","GMRCUTL1",41,0)
 ;       B = F (free-text) or L (lexicon)
"RTN","GMRCUTL1",42,0)
 ;
"RTN","GMRCUTL1",43,0)
 N GMRCFIL
"RTN","GMRCUTL1",44,0)
 Q:'+$G(OI) "^"
"RTN","GMRCUTL1",45,0)
 S GMRCFIL=$S(OI["99PRC":123.3,1:123.5)
"RTN","GMRCUTL1",46,0)
 Q:'$D(^GMR(GMRCFIL,+OI)) "^"
"RTN","GMRCUTL1",47,0)
 N STRING,NODE
"RTN","GMRCUTL1",48,0)
 I GMRCFIL=123.3 S NODE=$P(^GMR(123.3,+OI,0),U,7,8)
"RTN","GMRCUTL1",49,0)
 I GMRCFIL=123.5 S NODE=$P($G(^GMR(123.5,+OI,1)),U,1,2)
"RTN","GMRCUTL1",50,0)
 I NODE="" Q "O^F" ;values not set
"RTN","GMRCUTL1",51,0)
 S $P(STRING,U)=$S($L($P(NODE,U)):$P(NODE,U),1:"O")
"RTN","GMRCUTL1",52,0)
 S $P(STRING,U,2)=$S($L($P(NODE,U,2)):$P(NODE,U,2),1:"F")
"RTN","GMRCUTL1",53,0)
 Q STRING
"RTN","GMRCUTL1",54,0)
ORIFN(GMRC123) ;return ORIFN associated with give record in ^GMR(123,
"RTN","GMRCUTL1",55,0)
 ; GMRC123 = ien of consult record in file 123
"RTN","GMRCUTL1",56,0)
 Q $P($G(^GMR(123,GMRC123,0)),U,3)
"RTN","GMRCUTL1",57,0)
GETDT(PROMPT,DEFAULT) ;prompt and return FM date
"RTN","GMRCUTL1",58,0)
 ;Input:
"RTN","GMRCUTL1",59,0)
 ;  PROMPT  = text of prompt - DIR("A")          (optional)
"RTN","GMRCUTL1",60,0)
 ;  DEFAULT = default date to prompt - DIR("B")  (optional)
"RTN","GMRCUTL1",61,0)
 ; 
"RTN","GMRCUTL1",62,0)
 ;Output:
"RTN","GMRCUTL1",63,0)
 ; FM date/time if successfully answered, "^" if exit or timeout
"RTN","GMRCUTL1",64,0)
 N DIR,DIRUT,DIROUT,DTOUT,DUOUT,X,Y
"RTN","GMRCUTL1",65,0)
 S DIR(0)="DA^::EPT"
"RTN","GMRCUTL1",66,0)
 S DIR("?")="Enter the date/time the activity took place."
"RTN","GMRCUTL1",67,0)
 S DIR("A")=$S($D(PROMPT):PROMPT_" ",1:"Actual Date/Time of Activity: ")
"RTN","GMRCUTL1",68,0)
 S DIR("B")=$S($D(DEFAULT):DEFAULT,1:"NOW")
"RTN","GMRCUTL1",69,0)
 D ^DIR
"RTN","GMRCUTL1",70,0)
 I $D(DUOUT)!($D(DTOUT)) S Y="^"
"RTN","GMRCUTL1",71,0)
 Q Y
"RTN","GMRCUTL1",72,0)
 ;
"RTN","GMRCUTL1",73,0)
DCPRNT(IEN,USER) ;reprint SF-513 on DC?
"RTN","GMRCUTL1",74,0)
 N SERV,REPR
"RTN","GMRCUTL1",75,0)
 S SERV=$P(^GMR(123,IEN,0),U,5) I 'SERV Q 0
"RTN","GMRCUTL1",76,0)
 S REPR=$P($G(^GMR(123.5,SERV,1)),U,5)
"RTN","GMRCUTL1",77,0)
 I 'REPR Q 1
"RTN","GMRCUTL1",78,0)
 I REPR=2 Q 0
"RTN","GMRCUTL1",79,0)
 I REPR=1,'$$VALID^GMRCAU(SERV,IEN,USER) Q 1
"RTN","GMRCUTL1",80,0)
 Q 0
"RTN","GMRCUTL1",81,0)
 ;
"RTN","GMRCUTL1",82,0)
PREREQ(GMRCARR,GMRCSRV,GMRCDFN,UNRESOLV) ; return service pre-requisite
"RTN","GMRCUTL1",83,0)
 ; pre-requisite stored in 125 nodes in file 123.5 or 123.3
"RTN","GMRCUTL1",84,0)
 ; GMRCARR = array to return containing pre-requisite
"RTN","GMRCUTL1",85,0)
 ; GMRCSRV = ref to file 123.5 (ien;99CON) or 123.3 (ien;99PRC)
"RTN","GMRCUTL1",86,0)
 ; GMRCDFN = patient identifier if to return resolved
"RTN","GMRCUTL1",87,0)
 ; UNRESOLV = 1 or 0 ; if UNRESOLV=1 GMRCARR will be returned unresolved
"RTN","GMRCUTL1",88,0)
 Q:'+GMRCSRV
"RTN","GMRCUTL1",89,0)
 N GMRCFIL
"RTN","GMRCUTL1",90,0)
 S GMRCFIL=$S(GMRCSRV["99PRC":123.3,1:123.5)
"RTN","GMRCUTL1",91,0)
 Q:'$D(^GMR(GMRCFIL,+GMRCSRV,125))
"RTN","GMRCUTL1",92,0)
 I '$D(GMRCDFN)!($G(UNRESOLV)) D  Q
"RTN","GMRCUTL1",93,0)
 . M @GMRCARR=^GMR(GMRCFIL,+GMRCSRV,125)
"RTN","GMRCUTL1",94,0)
 D BLRPLT^TIUSRVD(,,GMRCDFN,,$NA(^GMR(GMRCFIL,+GMRCSRV,125)))
"RTN","GMRCUTL1",95,0)
 I $D(^TMP("TIUBOIL",$J)) M @GMRCARR=^TMP("TIUBOIL",$J)
"RTN","GMRCUTL1",96,0)
 K ^TMP("TIUBOIL",$J)
"RTN","GMRCUTL1",97,0)
 Q
"RTN","GMRCUTL1",98,0)
 ;
"RTN","GMRCUTL1",99,0)
LOCKREC(GMRCDA) ;attempt to lock a consult record using order or record
"RTN","GMRCUTL1",100,0)
 ; Input:
"RTN","GMRCUTL1",101,0)
 ;   GMRCDA  = ien of consult record from file 123
"RTN","GMRCUTL1",102,0)
 ;
"RTN","GMRCUTL1",103,0)
 ; Output: 
"RTN","GMRCUTL1",104,0)
 ;     1 or 0^reason can't be locked  
"RTN","GMRCUTL1",105,0)
 ;          1 = successfully locked
"RTN","GMRCUTL1",106,0)
 ;          0 = couldn't be locked
"RTN","GMRCUTL1",107,0)
 N GMRCORD,GMRCMSG
"RTN","GMRCUTL1",108,0)
 S GMRCORD=$P($G(^GMR(123,GMRCDA,0)),U,3)
"RTN","GMRCUTL1",109,0)
 I $G(GMRCORD) D  ;an order associated
"RTN","GMRCUTL1",110,0)
 . S GMRCMSG=$$LOCK1^ORX2(GMRCORD)
"RTN","GMRCUTL1",111,0)
 . ; GMRCMSG=1 if locked  or 0 if couldn't be locked
"RTN","GMRCUTL1",112,0)
 I $L($G(GMRCMSG)) Q GMRCMSG
"RTN","GMRCUTL1",113,0)
 ; no order = Inter-facility Consult so lock consult record
"RTN","GMRCUTL1",114,0)
 L +^GMR(123,GMRCDA):5
"RTN","GMRCUTL1",115,0)
 I '$T Q "0^Another user is editing this record" ; couldn't lock it
"RTN","GMRCUTL1",116,0)
 Q 1
"RTN","GMRCUTL1",117,0)
 ;
"RTN","GMRCUTL1",118,0)
UNLKREC(GMRCDA) ;unlock a consult record
"RTN","GMRCUTL1",119,0)
 ; Input:
"RTN","GMRCUTL1",120,0)
 ;   GMRCDA  = ien of consult record from file 123
"RTN","GMRCUTL1",121,0)
 ;
"RTN","GMRCUTL1",122,0)
 N GMRCORD
"RTN","GMRCUTL1",123,0)
 S GMRCORD=$P($G(^GMR(123,GMRCDA,0)),U,3)
"RTN","GMRCUTL1",124,0)
 I $G(GMRCORD) D  Q
"RTN","GMRCUTL1",125,0)
 . D UNLK1^ORX2(GMRCORD)
"RTN","GMRCUTL1",126,0)
 L -^GMR(123,GMRCDA)
"RTN","GMRCUTL1",127,0)
 Q
"RTN","GMRCUTL1",128,0)
 ;ABV/SCR 12/14/2017 added sub-routine to generate new field #80 - UCID for *96*
"RTN","GMRCUTL1",129,0)
NEWUCID(GMRCIEN) ;return a string that uniquely identifies this record accross VistAs
"RTN","GMRCUTL1",130,0)
 ; INPUT:
"RTN","GMRCUTL1",131,0)
 ;   GMRCIEN  ien of consult/request record from file 123 
"RTN","GMRCUTL1",132,0)
 ;
"RTN","GMRCUTL1",133,0)
 N GMRCSTA,GMRCSTRN
"RTN","GMRCUTL1",134,0)
 ;
"RTN","GMRCUTL1",135,0)
 ;Validate the GMRCIEN exists
"RTN","GMRCUTL1",136,0)
 S GMRCSTRN=""
"RTN","GMRCUTL1",137,0)
 I $G(^GMR(123,$G(GMRCIEN),0))'="" D
"RTN","GMRCUTL1",138,0)
 .S GMRCSTA=$$GET^XPAR("PKG","GMRC UNIQUE CONSULT SITE ID",,"E")   ;RETURNS THE EXTERNAL VALUE OF THE PARAMETER
"RTN","GMRCUTL1",139,0)
 .S:GMRCSTA GMRCSTRN=GMRCSTA_"_"_GMRCIEN
"RTN","GMRCUTL1",140,0)
 Q GMRCSTRN
"RTN","GMRCUTL1",141,0)
 ;
"VER")
8.0^22.2
"^DD",123,123,80,0)
UNIQUE CONSULT ID ^FJ15^^UCID;1^K:$L(X)>15!($L(X)<1) X
"^DD",123,123,80,3)
Answer must be 1-15 characters in length.
"^DD",123,123,80,21,0)
^^1^1^3171215^
"^DD",123,123,80,21,1,0)
A Unique Consult record identifier across all VistA systems.
"^DD",123,123,80,23,0)
^^4^4^3171215^
"^DD",123,123,80,23,1,0)
The UCID value is created from the value in the GMRC UNIQUE CONSULT SITE 
"^DD",123,123,80,23,2,0)
ID entry in the PARAMETER file for this site concatenated with the IEN of 
"^DD",123,123,80,23,3,0)
this record. This field is populated when a record is created and should 
"^DD",123,123,80,23,4,0)
not be modified.
"^DD",123,123,80,"DT")
3171215
"BLD",10823,6)
^85
**END**
**END**

