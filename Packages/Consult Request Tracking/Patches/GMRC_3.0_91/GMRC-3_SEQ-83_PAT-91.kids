Released GMRC*3*91 SEQ #83
Extracted from mail message
**KIDS**:GMRC*3.0*91^

**INSTALL NAME**
GMRC*3.0*91
"BLD",10026,0)
GMRC*3.0*91^CONSULT/REQUEST TRACKING^0^3180111^y
"BLD",10026,1,0)
^^2^2^3180110^^
"BLD",10026,1,1,0)
Adds override mechanism for Send additional alerts on consult comments. 
"BLD",10026,1,2,0)
Released with OR*3*452.
"BLD",10026,4,0)
^9.64PA^^
"BLD",10026,6.3)
4
"BLD",10026,"ABPKG")
n
"BLD",10026,"KRN",0)
^9.67PA^779.2^20
"BLD",10026,"KRN",.4,0)
.4
"BLD",10026,"KRN",.401,0)
.401
"BLD",10026,"KRN",.402,0)
.402
"BLD",10026,"KRN",.403,0)
.403
"BLD",10026,"KRN",.5,0)
.5
"BLD",10026,"KRN",.84,0)
.84
"BLD",10026,"KRN",3.6,0)
3.6
"BLD",10026,"KRN",3.8,0)
3.8
"BLD",10026,"KRN",9.2,0)
9.2
"BLD",10026,"KRN",9.8,0)
9.8
"BLD",10026,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",10026,"KRN",9.8,"NM",1,0)
GMRCP^^0^B20556617
"BLD",10026,"KRN",9.8,"NM",2,0)
GMRCGUIB^^0^B54784294
"BLD",10026,"KRN",9.8,"NM","B","GMRCGUIB",2)

"BLD",10026,"KRN",9.8,"NM","B","GMRCP",1)

"BLD",10026,"KRN",19,0)
19
"BLD",10026,"KRN",19,"NM",0)
^9.68A^^
"BLD",10026,"KRN",19.1,0)
19.1
"BLD",10026,"KRN",101,0)
101
"BLD",10026,"KRN",409.61,0)
409.61
"BLD",10026,"KRN",771,0)
771
"BLD",10026,"KRN",779.2,0)
779.2
"BLD",10026,"KRN",870,0)
870
"BLD",10026,"KRN",8989.51,0)
8989.51
"BLD",10026,"KRN",8989.52,0)
8989.52
"BLD",10026,"KRN",8994,0)
8994
"BLD",10026,"KRN","B",.4,.4)

"BLD",10026,"KRN","B",.401,.401)

"BLD",10026,"KRN","B",.402,.402)

"BLD",10026,"KRN","B",.403,.403)

"BLD",10026,"KRN","B",.5,.5)

"BLD",10026,"KRN","B",.84,.84)

"BLD",10026,"KRN","B",3.6,3.6)

"BLD",10026,"KRN","B",3.8,3.8)

"BLD",10026,"KRN","B",9.2,9.2)

"BLD",10026,"KRN","B",9.8,9.8)

"BLD",10026,"KRN","B",19,19)

"BLD",10026,"KRN","B",19.1,19.1)

"BLD",10026,"KRN","B",101,101)

"BLD",10026,"KRN","B",409.61,409.61)

"BLD",10026,"KRN","B",771,771)

"BLD",10026,"KRN","B",779.2,779.2)

"BLD",10026,"KRN","B",870,870)

"BLD",10026,"KRN","B",8989.51,8989.51)

"BLD",10026,"KRN","B",8989.52,8989.52)

"BLD",10026,"KRN","B",8994,8994)

"BLD",10026,"QUES",0)
^9.62^^
"BLD",10026,"REQB",0)
^9.611^4^4
"BLD",10026,"REQB",1,0)
GMRC*3.0*46^1
"BLD",10026,"REQB",2,0)
GMRC*3.0*86^1
"BLD",10026,"REQB",3,0)
OR*3.0*452^1
"BLD",10026,"REQB",4,0)
GMRC*3.0*90^1
"BLD",10026,"REQB","B","GMRC*3.0*46",1)

"BLD",10026,"REQB","B","GMRC*3.0*86",2)

"BLD",10026,"REQB","B","GMRC*3.0*90",4)

"BLD",10026,"REQB","B","OR*3.0*452",3)

"MBREQ")
0
"PKG",294,-1)
1^1
"PKG",294,0)
CONSULT/REQUEST TRACKING^GMRC^CONSULTS/REQUESTS
"PKG",294,20,0)
^9.402P^^
"PKG",294,22,0)
^9.49I^1^1
"PKG",294,22,1,0)
3.0^2980101^2980917^11712
"PKG",294,22,1,"PAH",1,0)
91^3180111
"PKG",294,22,1,"PAH",1,1,0)
^^2^2^3180111
"PKG",294,22,1,"PAH",1,1,1,0)
Adds override mechanism for Send additional alerts on consult comments. 
"PKG",294,22,1,"PAH",1,1,2,0)
Released with OR*3*452.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","GMRCGUIB")
0^2^B54784294^B53899117
"RTN","GMRCGUIB",1,0)
GMRCGUIB ;SLC/DCM,JFR,MA/AFS,PB - GUI actions for consults ;01/10/18  13:55
"RTN","GMRCGUIB",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,12,18,20,17,22,29,30,35,45,53,55,64,46,75,86,90,91**;DEC 27, 1997;Build 4
"RTN","GMRCGUIB",3,0)
 ;
"RTN","GMRCGUIB",4,0)
 ; This routine invokes IA #2980
"RTN","GMRCGUIB",5,0)
 ; This routine invokes IA #6755 - DE6745 - PB Apr 12, 2017
"RTN","GMRCGUIB",6,0)
 ;
"RTN","GMRCGUIB",7,0)
SETDA() ;set DA of where audit actions are to be filed
"RTN","GMRCGUIB",8,0)
 S:'$D(^GMR(123,+GMRCO,40,0)) ^GMR(123,GMRCO,40,0)="^123.02DA^^"
"RTN","GMRCGUIB",9,0)
 S DA=$S($P(^GMR(123,+GMRCO,40,0),"^",3):$P(^(0),"^",3)+1,1:1)
"RTN","GMRCGUIB",10,0)
 S $P(^GMR(123,+GMRCO,40,0),"^",3,4)=DA_"^"_DA
"RTN","GMRCGUIB",11,0)
 Q DA
"RTN","GMRCGUIB",12,0)
REASON(GMRCFN,GMRCRQ,GMRCDT) ;Load the reason for the request into ^GMR(123,GMRCO,20
"RTN","GMRCGUIB",13,0)
 ;GMRCFN=File 123 IFN; GMRCRQ=Array containing Reason For Request
"RTN","GMRCGUIB",14,0)
 ;GMRCDT=Date time of entry
"RTN","GMRCGUIB",15,0)
 S ^GMR(123,GMRCFN,20,0)="^^^"_GMRCDT_"^"
"RTN","GMRCGUIB",16,0)
 S L=0,LN=1 F  S L=$O(GMRCRQ(L)) Q:L=""  S ^GMR(123,GMRCFN,20,LN,0)=GMRCRQ(L),LN=LN+1
"RTN","GMRCGUIB",17,0)
 S LN=LN-1,$P(^GMR(123,GMRCFN,20,0),"^",3)=LN
"RTN","GMRCGUIB",18,0)
 K LN,L
"RTN","GMRCGUIB",19,0)
 Q
"RTN","GMRCGUIB",20,0)
SETCOM(COMMENT,WHO) ;Set comment array into tracking actions
"RTN","GMRCGUIB",21,0)
 N GMRCNOW,DR,DIE
"RTN","GMRCGUIB",22,0)
 S GMRCNOW=$$NOW^XLFDT
"RTN","GMRCGUIB",23,0)
 I $P($G(^GMR(123,+GMRCO,0)),"^",11)=$G(GMRCPA) S GMRCPA=""
"RTN","GMRCGUIB",24,0)
 S DIE="^GMR(123,GMRCO,40,",DA(1)=GMRCO,DR=".01////^S X=GMRCNOW;1////^S X=GMRCA;2////^S X=GMRCAD;3////^S X=$G(GMRCORNP);4////^S X=$S($G(WHO):WHO,1:DUZ);6////^S X=$G(GMRCFR);8////^S X=$G(GMRCFF);7////^S X=$G(GMRCPA)"
"RTN","GMRCGUIB",25,0)
 D ^DIE
"RTN","GMRCGUIB",26,0)
 S ^GMR(123,GMRCO,40,DA,1,0)="^^^^"_GMRCAD_"^"
"RTN","GMRCGUIB",27,0)
 S (GMRCND,GMRCND1)=0 F  S GMRCND1=$O(COMMENT(GMRCND1)) Q:GMRCND1=""  S GMRCND=GMRCND+1,^GMR(123,GMRCO,40,DA,1,GMRCND,0)=COMMENT(GMRCND)
"RTN","GMRCGUIB",28,0)
 S $P(^GMR(123,GMRCO,40,DA,1,0),"^",3)=GMRCND,$P(^(0),"^",4)=GMRCND,^GMR(123,GMRCO,40,"B",GMRCNOW,DA)=""
"RTN","GMRCGUIB",29,0)
 D:$D(^GMR(123,+GMRCO,0)) AG123S1^GMRCXR(+GMRCO)  ;alb/sat 86 - update AG xref
"RTN","GMRCGUIB",30,0)
 ;
"RTN","GMRCGUIB",31,0)
 ; if an IFC, call event handler to generate a msg to remote site
"RTN","GMRCGUIB",32,0)
 I $D(^GMR(123,+GMRCO,12)),$D(^(40,DA)) D TRIGR^GMRCIEVT(GMRCO,DA)
"RTN","GMRCGUIB",33,0)
 ;
"RTN","GMRCGUIB",34,0)
 K GMRCND,GMRCND1
"RTN","GMRCGUIB",35,0)
 Q
"RTN","GMRCGUIB",36,0)
CMT(GMRCO,GMRCOM,GMRCADUZ,GMRCWHN,GMRCWHO) ;add comment to consult
"RTN","GMRCGUIB",37,0)
 ; GMRCO = IEN from file 123
"RTN","GMRCGUIB",38,0)
 ; GMRCOM = array of comments in format GMRCOM(1)="xxxx", GMRCOM(2)="xxx"
"RTN","GMRCGUIB",39,0)
 ; GMRCADUZ = array of alert recipients as GMRCADUZ(DUZ)="" (optional)
"RTN","GMRCGUIB",40,0)
 ; GMRCWHO = IEN from file 200 who's responsible activity (optional)
"RTN","GMRCGUIB",41,0)
 ; GMRCWHN = date time of activity in FM format
"RTN","GMRCGUIB",42,0)
 ; GMRCFORC = copy of GMRCADUZ; these users will recieve alert 63 even if alert is turned OFF; optional argument to MSG^GMRCP
"RTN","GMRCGUIB",43,0)
 ;
"RTN","GMRCGUIB",44,0)
 N DA,GMRCA,GMRCAD,GMRCORTX,GMRCDFN,GMRCTM,GMRCRP,GMRCUPD,GMRCFORC
"RTN","GMRCGUIB",45,0)
 M GMRCFORC=GMRCADUZ
"RTN","GMRCGUIB",46,0)
 S DA=$$SETDA ; get next activity tracking entry
"RTN","GMRCGUIB",47,0)
 S GMRCA=20,GMRCAD=GMRCWHN S:$G(GMRCWHO) GMRCORNP=GMRCWHO
"RTN","GMRCGUIB",48,0)
 D SETCOM(.GMRCOM,$G(GMRCWHO))
"RTN","GMRCGUIB",49,0)
 ;if a Non VA Care consult, notify HCP of the comment
"RTN","GMRCGUIB",50,0)
 I $$FEE^GMRCHL7H($$GET1^DIQ(123,+GMRCO,1,"I")) D COMMENT^GMRCHL7H(+GMRCO)
"RTN","GMRCGUIB",51,0)
 D  ;update LAST ACTION field even though no status change
"RTN","GMRCGUIB",52,0)
 . N GMRCDR,GMRCSTS
"RTN","GMRCGUIB",53,0)
 . S GMRCSTS="",GMRCDR="9////20"
"RTN","GMRCGUIB",54,0)
 . D STATUS^GMRCP
"RTN","GMRCGUIB",55,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCGUIB",56,0)
 S GMRCORTX="Comment Added to Consult "
"RTN","GMRCGUIB",57,0)
 D POST^HMPEVNT(GMRCDFN,"consult",GMRCO,"") ; DE6745 PB - Added to make a call to HMP to sync the patient comments
"RTN","GMRCGUIB",58,0)
 I $P($G(^GMR(123,GMRCO,12)),U,5)="P" D
"RTN","GMRCGUIB",59,0)
 . S GMRCORTX="Comment Added to remote consult "
"RTN","GMRCGUIB",60,0)
 S GMRCORTX=GMRCORTX_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCGUIB",61,0)
 S GMRCRP=+$P(^GMR(123,GMRCO,0),U,14)
"RTN","GMRCGUIB",62,0)
 S GMRCUPD=$$VALID^GMRCAU($P(^GMR(123,+GMRCO,0),U,5),GMRCO,DUZ)
"RTN","GMRCGUIB",63,0)
 I GMRCRP=DUZ D  ;alert team if ord. prov. takes the action
"RTN","GMRCGUIB",64,0)
 . S GMRCTM=1
"RTN","GMRCGUIB",65,0)
 I GMRCUPD>1,GMRCRP'=DUZ D  ; alert ord. prov if update users takes action
"RTN","GMRCGUIB",66,0)
 . S GMRCADUZ(GMRCRP)=""
"RTN","GMRCGUIB",67,0)
 I '$G(GMRCTM),GMRCUPD<2 D  ;alert both if not ord. prov or update user
"RTN","GMRCGUIB",68,0)
 . S GMRCTM=1,GMRCADUZ(GMRCRP)=""
"RTN","GMRCGUIB",69,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,63,.GMRCADUZ,$G(GMRCTM),.GMRCFORC)
"RTN","GMRCGUIB",70,0)
 Q
"RTN","GMRCGUIB",71,0)
SFILE(GMRCO,GMRCA,GMRCSF,GMRCORNP,GMRCDUZ,GMRCOM,GMRCALF,GMRCATO,GMRCAD) ;Process various file update functions from the GUI for a consult
"RTN","GMRCGUIB",72,0)
 ; ADMIN COMPLETE or SIGNIFICANT FINDINGS
"RTN","GMRCGUIB",73,0)
 ;Input variables:
"RTN","GMRCGUIB",74,0)
 ;GMRCO=File 123 IEN of the consult record
"RTN","GMRCGUIB",75,0)
 ;GMRCA=pointer to REQUEST ACTION TYPES (#123.1) 10=complete, 4=Sig find.
"RTN","GMRCGUIB",76,0)
 ;GMRCSF=Significant Findings flag: 'Y'= significant finding
"RTN","GMRCGUIB",77,0)
 ;                                : 'N'= no significant finding
"RTN","GMRCGUIB",78,0)
 ;                                : 'U'=unknown significant finding
"RTN","GMRCGUIB",79,0)
 ;GMRCORNP=Provider Responsible for action
"RTN","GMRCGUIB",80,0)
 ;GMRCDUZ=Person actually doing the action
"RTN","GMRCGUIB",81,0)
 ;GMRCOM=An array of comments by reference ARRAY(1)="xxx",ARRAY(2)="xxx"
"RTN","GMRCGUIB",82,0)
 ;GMRCALF=Flag to signal that alerts are to be sent; 'N'=NO, 'Y'=YES
"RTN","GMRCGUIB",83,0)
 ;GMRCATO=Who alerts are to be sent to; a comma delimited string of DUZ's
"RTN","GMRCGUIB",84,0)
 ;GMRCAD =FM date/time of activity
"RTN","GMRCGUIB",85,0)
 ;
"RTN","GMRCGUIB",86,0)
 ;Output:
"RTN","GMRCGUIB",87,0)
 ; GMRCERR=Error Flag: 0 if no error, 1 if error occurred
"RTN","GMRCGUIB",88,0)
 ; GMRCERMS - Error message or null
"RTN","GMRCGUIB",89,0)
 ;    returned as GMRCERR^GMRCERMS
"RTN","GMRCGUIB",90,0)
 ;
"RTN","GMRCGUIB",91,0)
 N GMRCERR,GMRCERMS,GMRCTM
"RTN","GMRCGUIB",92,0)
 L +^GMR(123,GMRCO):5 I '$T S GMRCERR=1,GMRCERMS="Record Locked. File Update Not Accomplished." Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",93,0)
 S GMRCERR=0,GMRCTM=0,GMRCERMS="",DR="",GMRCORTX=""
"RTN","GMRCGUIB",94,0)
 N GMRCADUZ S GMRCADUZ=""
"RTN","GMRCGUIB",95,0)
 S GMRCNOW=$$NOW^XLFDT,GMRCSTS=$P(^GMR(123,+GMRCO,0),"^",12),GMRCDFN=$P(^(0),"^",2)
"RTN","GMRCGUIB",96,0)
 I '$G(GMRCDUZ) S GMRCDUZ=DUZ
"RTN","GMRCGUIB",97,0)
 I '$G(GMRCAD) S GMRCAD=GMRCNOW
"RTN","GMRCGUIB",98,0)
 ;Insure comment array contains text for Complete action.
"RTN","GMRCGUIB",99,0)
 I GMRCA=10 D  I GMRCERR=1 S GMRCERMS="Comment field must contain a text value!" Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",100,0)
 . S GMRCERR=1
"RTN","GMRCGUIB",101,0)
 . I '$D(GMRCOM) Q
"RTN","GMRCGUIB",102,0)
 . N GMRCOM1 S GMRCOM1=""
"RTN","GMRCGUIB",103,0)
 . F  S GMRCOM1=$O(GMRCOM(GMRCOM1)) Q:(GMRCOM1=""!(GMRCERR=0))  D
"RTN","GMRCGUIB",104,0)
 .. I $TR($G(GMRCOM(GMRCOM1))," ","")'="" S GMRCERR=0 Q
"RTN","GMRCGUIB",105,0)
 I +$G(GMRCA),GMRCA=10 D
"RTN","GMRCGUIB",106,0)
 .S GMRCSF=$G(GMRCSF,"")
"RTN","GMRCGUIB",107,0)
 .S GMRCSTS=2
"RTN","GMRCGUIB",108,0)
 .S DR="8////^S X=GMRCSTS;9////^S X=GMRCA;15////^S X=GMRCSF"
"RTN","GMRCGUIB",109,0)
 .S GMRCORTX="Completed Consult "_$$ORTX^GMRCAU(+GMRCO)_$S(GMRCSF="Y":" with Sig Findings",GMRCSF="N":" with no Sig Findings",1:"")
"RTN","GMRCGUIB",110,0)
 .I $P($G(^GMR(123,+GMRCO,0)),U,14),$P($G(^GMR(123,+GMRCO,0)),U,14)'=DUZ S GMRCADUZ($P($G(^(0)),U,14))=""
"RTN","GMRCGUIB",111,0)
 .Q
"RTN","GMRCGUIB",112,0)
 I $G(GMRCALF)=1 D
"RTN","GMRCGUIB",113,0)
 .N I
"RTN","GMRCGUIB",114,0)
 .F I=1:1  S X=$P(GMRCATO,";",I) Q:X=""  S GMRCADUZ(X)=""
"RTN","GMRCGUIB",115,0)
 .Q
"RTN","GMRCGUIB",116,0)
 I $L(GMRCA),GMRCA=4 S DR=DR_$S($L(DR):";",1:"")_"9////^S X=GMRCA;15////^S X=GMRCSF" D
"RTN","GMRCGUIB",117,0)
 .S GMRCORTX=$S(GMRCSF="Y":"Sig Findings ",GMRCSF="N":"No Sig Findings ",1:"Unknown Sig Findings ")_"for consult "_$$ORTX^GMRCAU(GMRCO)
"RTN","GMRCGUIB",118,0)
 .I $P($G(^GMR(123,+GMRCO,0)),U,14),$P($G(^GMR(123,+GMRCO,0)),U,14)'=DUZ S GMRCADUZ($P($G(^(0)),U,14))=""
"RTN","GMRCGUIB",119,0)
 .S GMRCUPD=$$VALID^GMRCAU($P(^GMR(123,+GMRCO,0),U,5),GMRCO,DUZ)
"RTN","GMRCGUIB",120,0)
 .I +GMRCUPD<2 S GMRCTM=1
"RTN","GMRCGUIB",121,0)
 .I +GMRCUPD>1,+$P($G(^GMR(123,+GMRCO,0)),U,14)=DUZ S GMRCTM=1
"RTN","GMRCGUIB",122,0)
 .Q
"RTN","GMRCGUIB",123,0)
 I $L(DR) S DIE="^GMR(123,",DA=GMRCO D ^DIE K DIE,DR
"RTN","GMRCGUIB",124,0)
 I '$O(GMRCOM(0)) D AUDIT^GMRCP
"RTN","GMRCGUIB",125,0)
 I $D(GMRCOM),$O(GMRCOM(0)) D
"RTN","GMRCGUIB",126,0)
 .N DA
"RTN","GMRCGUIB",127,0)
 .S DA=$$SETDA()
"RTN","GMRCGUIB",128,0)
 .D SETCOM(.GMRCOM,GMRCDUZ)
"RTN","GMRCGUIB",129,0)
 .Q
"RTN","GMRCGUIB",130,0)
 L -^GMR(123,GMRCO)
"RTN","GMRCGUIB",131,0)
 ;
"RTN","GMRCGUIB",132,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,$S(GMRCA=20:63,1:23),.GMRCADUZ,GMRCTM)
"RTN","GMRCGUIB",133,0)
 ;
"RTN","GMRCGUIB",134,0)
 I $S(GMRCA=10:1,(GMRCA=4&($P(^GMR(123,GMRCO,0),U,12)=2)):1,1:0) D
"RTN","GMRCGUIB",135,0)
 . D EN^GMRCHL7($P(^GMR(123,GMRCO,0),"^",2),GMRCO,$G(GMRCTYPE),$G(GMRCRB),"RE",GMRCORNP,$G(GMRCVSIT),.GMRCOM,,GMRCAD)
"RTN","GMRCGUIB",136,0)
 K DIE,DR,DA,GMRCDT,GMRCNOW,GMRCAD,GMRCORNP,GMRCDUZ,GMRCRSLT,GMRCSTS,GMRCADUZ,GMRCORTX,GMRCDFN
"RTN","GMRCGUIB",137,0)
 Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",138,0)
 ;
"RTN","GMRCGUIB",139,0)
SCH(GMRCO,GMRCORNP,GMRCAD,GMRCADUZ,GMRCMT) ;schedule a consult API
"RTN","GMRCGUIB",140,0)
 ; Input variables:
"RTN","GMRCGUIB",141,0)
 ;GMRCO - The internal file number of the consult from File 123
"RTN","GMRCGUIB",142,0)
 ;GMRCORNP - Name of the person who actually 'Received' the consult
"RTN","GMRCGUIB",143,0)
 ;GMRCAD - Actual date time that consult was received into the service.
"RTN","GMRCGUIB",144,0)
 ;GMRCADUZ - array of alert recipients as chosen by user (by reference)
"RTN","GMRCGUIB",145,0)
 ;   ARRAY(DUZ)=""
"RTN","GMRCGUIB",146,0)
 ;GMRCMT - array of comments if entered (by reference)
"RTN","GMRCGUIB",147,0)
 ;   ARRAY(1)="FIRST LINE OF COMMENT"
"RTN","GMRCGUIB",148,0)
 ;   ARRAY(2)="SECOND LINE OF COMMENT"
"RTN","GMRCGUIB",149,0)
 ;
"RTN","GMRCGUIB",150,0)
 ;Output:
"RTN","GMRCGUIB",151,0)
 ;GMRCERR - Error Condition Code: 0 = NO error, 1=error
"RTN","GMRCGUIB",152,0)
 ;GMRCERMS - Error message or null
"RTN","GMRCGUIB",153,0)
 ;  returned as GMRCERR^GMRCERMS
"RTN","GMRCGUIB",154,0)
        ;
"RTN","GMRCGUIB",155,0)
 N DFN,GMRCSTS,GMRCNOW,GMRCERR,GMRCERMS
"RTN","GMRCGUIB",156,0)
 S GMRCERR=0,GMRCERMS="",GMRCNOW=$$NOW^XLFDT
"RTN","GMRCGUIB",157,0)
 S:$G(GMRCAD)="" GMRCAD=GMRCNOW
"RTN","GMRCGUIB",158,0)
 S:'$G(GMRCDUZ) GMRCDUZ=DUZ
"RTN","GMRCGUIB",159,0)
 S DFN=$P($G(^GMR(123,GMRCO,0)),"^",2) I DFN="" D  Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",160,0)
 . S GMRCERR="1",GMRCERMS="Not A Valid Consult - File Not Found."
"RTN","GMRCGUIB",161,0)
 . D EXIT^GMRCGUIA
"RTN","GMRCGUIB",162,0)
 S GMRCSTS=8,GMRCA=8
"RTN","GMRCGUIB",163,0)
 D STATUS^GMRCP I $D(GMRCQUT) D EXIT^GMRCGUIA Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",164,0)
 I '$O(GMRCMT(0)) D AUDIT^GMRCP
"RTN","GMRCGUIB",165,0)
 I $O(GMRCMT(0)) D
"RTN","GMRCGUIB",166,0)
 . S DA=$$SETDA
"RTN","GMRCGUIB",167,0)
 . D SETCOM(.GMRCMT,GMRCDUZ)
"RTN","GMRCGUIB",168,0)
 D EN^GMRCHL7(DFN,GMRCO,"","","SC",GMRCORNP,"","","",GMRCAD)
"RTN","GMRCGUIB",169,0)
 D  ;send alerts
"RTN","GMRCGUIB",170,0)
 . N GMRCUPD,GMRCTM,TXT
"RTN","GMRCGUIB",171,0)
 . S TXT="Scheduled Consult: "_$$ORTX^GMRCAU(GMRCO)
"RTN","GMRCGUIB",172,0)
 . S GMRCTM=0
"RTN","GMRCGUIB",173,0)
 . I $P(^GMR(123,+GMRCO,0),U,14),$P(^GMR(123,+GMRCO,0),U,14)'=DUZ S GMRCADUZ($P(^(0),U,14))=""
"RTN","GMRCGUIB",174,0)
 . S GMRCUPD=$$VALID^GMRCAU($P(^GMR(123,+GMRCO,0),U,5),GMRCO,DUZ)
"RTN","GMRCGUIB",175,0)
 . I +GMRCUPD<2 S GMRCTM=1
"RTN","GMRCGUIB",176,0)
 . I +GMRCUPD>1,+$P($G(^GMR(123,+GMRCO,0)),U,14)=DUZ S GMRCTM=1
"RTN","GMRCGUIB",177,0)
 . D MSG^GMRCP(DFN,TXT,GMRCO,63,.GMRCADUZ,GMRCTM)
"RTN","GMRCGUIB",178,0)
 D EXIT^GMRCGUIA
"RTN","GMRCGUIB",179,0)
 Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",180,0)
DOCLIST(GMRCAR,GMRCDA,GMRCMED)  ;return list of linked results
"RTN","GMRCGUIB",181,0)
 ; Input:
"RTN","GMRCGUIB",182,0)
 ;  GMRCAR - array to return list, passed by reference
"RTN","GMRCGUIB",183,0)
 ;  GMRCDA - ien from file 123
"RTN","GMRCGUIB",184,0)
 ;  GMRCMED- 1 = include med results; 0 = only TIU docs
"RTN","GMRCGUIB",185,0)
 ;
"RTN","GMRCGUIB",186,0)
 ; Output:
"RTN","GMRCGUIB",187,0)
 ;  GMRCAR - array in format
"RTN","GMRCGUIB",188,0)
 ;       GMRCAR(0)=zero node of record
"RTN","GMRCGUIB",189,0)
 ;       GMRCAR(50,1)="ien;global ref," e.g. 5;TIU(8925, or 3;MCAR(691,
"RTN","GMRCGUIB",190,0)
 ;       GMRCAR(50,2)="ien;global ref,"
"RTN","GMRCGUIB",191,0)
 ;
"RTN","GMRCGUIB",192,0)
 I '$D(^GMR(123,GMRCDA,0)) Q
"RTN","GMRCGUIB",193,0)
 S GMRCAR(0)=^GMR(123,GMRCDA,0),$P(GMRCAR(0),U,20)=""
"RTN","GMRCGUIB",194,0)
 N RES,CNT S RES="",CNT=1
"RTN","GMRCGUIB",195,0)
 F  S RES=$O(^GMR(123,GMRCDA,50,"B",RES)) Q:RES=""  D
"RTN","GMRCGUIB",196,0)
 . I '$G(GMRCMED) Q:RES'["TIU(8925"
"RTN","GMRCGUIB",197,0)
 . S GMRCAR(50,CNT)=RES
"RTN","GMRCGUIB",198,0)
 . I RES["MCAR" D
"RTN","GMRCGUIB",199,0)
 .. N ARR,STR
"RTN","GMRCGUIB",200,0)
 .. D MEDLKUP^MCARUTL3(.ARR,+$P(RES,"MCAR(",2),+RES)
"RTN","GMRCGUIB",201,0)
 .. I '+ARR K GMRCAR(50,CNT) Q
"RTN","GMRCGUIB",202,0)
 .. S STR=$P(ARR,U,9)_U_$P(ARR,U,6)_$S($P(ARR,U,10):"^^^^^^^^1",1:"")
"RTN","GMRCGUIB",203,0)
 .. S GMRCAR(50,CNT)=GMRCAR(50,CNT)_U_STR
"RTN","GMRCGUIB",204,0)
 . S CNT=CNT+1
"RTN","GMRCGUIB",205,0)
 Q
"RTN","GMRCP")
0^1^B20556617^B19973660
"RTN","GMRCP",1,0)
GMRCP ;SLC/DLT,DCM - Message audit and status process ;08/29/17  09:09
"RTN","GMRCP",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,17,22,27,53,55,46,91**;DEC 27, 1997;Build 4
"RTN","GMRCP",3,0)
 ;Processing action on Generic Requests/Consults from OE/RR
"RTN","GMRCP",4,0)
MSG(GMRCDFN,GMRCALRM,GMRCIFN,ORN,GMRCADUZ,FLG,GMRCFORC) ;send alert notification information to OERR for notification or update
"RTN","GMRCP",5,0)
 ;GMRCDFN=patient's DFN           GMRCORFN=OR file # ^OR(100,GMRCORFN
"RTN","GMRCP",6,0)
 ;GMRCALRM=alert message to be displayed with alert
"RTN","GMRCP",7,0)
 ;GMRCIFN=internal file number of consult in file 123
"RTN","GMRCP",8,0)
 ;GMRCADUZ=set in call to EN^GMRCT=array of providers who will be alerted
"RTN","GMRCP",9,0)
 ;FLG=1 if need to get list of service's providers, 0 if service dc'd.
"RTN","GMRCP",10,0)
 ;GMRCFORC=optional array passed in; users who will be alerted even if alert is turned OFF
"RTN","GMRCP",11,0)
 ;ORN=IFN from file ^ORD(100.9, for consult notification action
"RTN","GMRCP",12,0)
 N GMRCSS,GMRCORFN
"RTN","GMRCP",13,0)
 S GMRCORFN=$P(^GMR(123,+GMRCIFN,0),"^",3)
"RTN","GMRCP",14,0)
 S GMRCSS=$P($G(^GMR(123,+GMRCIFN,0)),"^",5)
"RTN","GMRCP",15,0)
 I FLG,GMRCSS D EN^GMRCT(GMRCSS)
"RTN","GMRCP",16,0)
 I $P($G(^GMR(123,+GMRCIFN,12)),U,5)="P" D
"RTN","GMRCP",17,0)
 . Q:ORN=27  ; don't notify requestor if a new order they placed, duh...
"RTN","GMRCP",18,0)
 . I DUZ=+$P(^GMR(123,+GMRCIFN,0),U,14) Q  ; don;t alert on own actions
"RTN","GMRCP",19,0)
 . S GMRCADUZ(+$P(^GMR(123,+GMRCIFN,0),U,14))=""
"RTN","GMRCP",20,0)
 I FLG,$P(^GMR(123,+GMRCIFN,0),"^",11) S GMRCADUZ($P(^(0),"^",11))=""
"RTN","GMRCP",21,0)
 S:'$D(GMRCADUZ) GMRCADUZ=""
"RTN","GMRCP",22,0)
 S:'$D(GMRCFORC) GMRCFORC=""
"RTN","GMRCP",23,0)
 ;N X S X="" F  S X=$O(GMRCADUZ(X)) Q:(X="")  I +X=DUZ,X'=DUZ K GMRCADUZ(X) ;Don't send alert to user generating alert
"RTN","GMRCP",24,0)
 K GMRCADUZ(DUZ) ;Don't send alert to user generating alert
"RTN","GMRCP",25,0)
 D EN^ORB3(ORN,GMRCDFN,GMRCORFN,.GMRCADUZ,GMRCALRM,GMRCIFN,.GMRCFORC)
"RTN","GMRCP",26,0)
 Q
"RTN","GMRCP",27,0)
AUDIT ;Build processing activity audit trail multiple.
"RTN","GMRCP",28,0)
 S GMRCDT=$$NOW^XLFDT
"RTN","GMRCP",29,0)
AUDIT0 ;alternate entry with date already defined
"RTN","GMRCP",30,0)
 L +^GMR(123,+GMRCO,40):5 I '$T S GMRCUT=1,GMRCERR=1,GMRCERMS="Activity Trail Not filed - Consult In Use By Another User." L -^GMR(123,+GMRCO,40)  Q
"RTN","GMRCP",31,0)
 S:'$D(^GMR(123,+GMRCO,40,0)) ^(0)="^123.02DA^^"
"RTN","GMRCP",32,0)
 S DA=$S($P(^GMR(123,+GMRCO,40,0),"^",3):$P(^(0),"^",3)+1,1:1)
"RTN","GMRCP",33,0)
 S $P(^GMR(123,+GMRCO,40,0),"^",3,4)=DA_"^"_DA
"RTN","GMRCP",34,0)
AUDIT1 ;entry when the DA is not incremented (INCOMPLETE RPT writeovers)
"RTN","GMRCP",35,0)
 S GMRCORNP=$G(GMRCORNP) S:'$D(GMRCOM) GMRCOM=0
"RTN","GMRCP",36,0)
 S GMRCDEV=$G(GMRCDEV),GMRCFF=$G(GMRCFF),GMRCPA=$G(GMRCPA)
"RTN","GMRCP",37,0)
 S GMRCAD=$S('$D(GMRCAD):GMRCDT,1:GMRCAD)
"RTN","GMRCP",38,0)
 S GMRCRSLT=$G(GMRCRSLT) ;Added result with GMRC*3.0*4
"RTN","GMRCP",39,0)
 S DIE="^GMR(123,"_+GMRCO_",40,",DA(1)=+GMRCO
"RTN","GMRCP",40,0)
 I '$D(^GMR(123,DA(1),40,DA,0)) D
"RTN","GMRCP",41,0)
 . S DR=".01////^S X=GMRCDT;1////^S X=GMRCA;2////^S X=GMRCAD;3////^S X=GMRCORNP"
"RTN","GMRCP",42,0)
 . I GMRCA'=22 S DR=DR_";4////^S X=DUZ" ;if it's a print, pkg did it
"RTN","GMRCP",43,0)
 . S DR=DR_";6////^S X=GMRCFF;7////^S X=GMRCPA;9////^S X=GMRCRSLT;8///^S X=GMRCDEV"
"RTN","GMRCP",44,0)
 E  D
"RTN","GMRCP",45,0)
 . ;DR string on .01 allows write over, rather than forced new entry
"RTN","GMRCP",46,0)
 . S DR=".01///^S X=GMRCDT;1////^S X=GMRCA;2////^S X=GMRCAD;3////^S X=GMRCORNP;4////^S X=DUZ;6////^S X=GMRCFF;7////^S X=GMRCPA;9////^S X=GMRCRSLT;8///^S X=GMRCDEV"
"RTN","GMRCP",47,0)
 ;Added result to the DR string
"RTN","GMRCP",48,0)
 D ^DIE
"RTN","GMRCP",49,0)
COMMENT ;Enter comment
"RTN","GMRCP",50,0)
 I +$G(GMRCOM) S GMRCOM(0)=DA D
"RTN","GMRCP",51,0)
 . W !,"Enter COMMENT..."
"RTN","GMRCP",52,0)
 . N DIC,DWPK,DWLW,DIWESUB
"RTN","GMRCP",53,0)
 . S DIC=DIE_DA_",1,",DWPK=1,DWLW=74
"RTN","GMRCP",54,0)
 . S DIWESUB="COMMENTS" D EN^DIWE
"RTN","GMRCP",55,0)
 . I $P($G(^GMR(123.1,+$P(^GMR(123,+GMRCO,40,DA,0),U,2),0)),U)="ADDED COMMENT",'$O(^GMR(123,+GMRCO,40,DA,0)) D  Q
"RTN","GMRCP",56,0)
 .. S DA(1)=+GMRCO,DIK="^GMR(123,"_DA(1)_",40," D ^DIK K DIK
"RTN","GMRCP",57,0)
 .. Q
"RTN","GMRCP",58,0)
 . I $P($G(^GMR(123.1,+$P(^GMR(123,+GMRCO,40,DA,0),U,2),0)),U)="COMPLETE/UPDATE",$P($G(^GMR(123,+GMRCO,40,DA,0)),U,9)="" D
"RTN","GMRCP",59,0)
 .. N GMRCMT,GMRCMT1
"RTN","GMRCP",60,0)
 .. S (GMRCMT,GMRCMT1)=0
"RTN","GMRCP",61,0)
 .. F  S GMRCMT=$O(^GMR(123,+GMRCO,40,DA,1,GMRCMT)) Q:GMRCMT=""  D  Q:GMRCMT1=1
"RTN","GMRCP",62,0)
 ... I $TR($G(^GMR(123,+GMRCO,40,DA,1,GMRCMT,0))," ","")'="" S GMRCMT1=1
"RTN","GMRCP",63,0)
 .. I 'GMRCMT1 D  G:'GMRCQUIT COMMENT Q
"RTN","GMRCP",64,0)
 ... S GMRCQUIT=0
"RTN","GMRCP",65,0)
 ... W !!,"A comment is required to complete this request!",!
"RTN","GMRCP",66,0)
 ... D WP^DIE(123.02,DA_","_+GMRCO_",",5,,"@")
"RTN","GMRCP",67,0)
 ... K DIR
"RTN","GMRCP",68,0)
 ... S DIR("A")="Type 'Q' to quit or 'C' to continue entering a comment:"
"RTN","GMRCP",69,0)
 ... S DIR("B")="C"
"RTN","GMRCP",70,0)
 ... S DIR(0)="S^C:CONTINUE;Q:QUIT"
"RTN","GMRCP",71,0)
 ... S DIR("?")="Type 'Q' if you would like to abort completion of this Consult/Procedure."
"RTN","GMRCP",72,0)
 ... S DIR("?",1)="Type 'C' or press <RETURN> to re-enter your comments."
"RTN","GMRCP",73,0)
 ... D ^DIR K DIR I Y'="C" S GMRCQUIT=1,DA(1)=+GMRCO,DIK="^GMR(123,"_DA(1)_",40," D ^DIK K DIK
"RTN","GMRCP",74,0)
 . I '$G(DA) S DA=D0
"RTN","GMRCP",75,0)
 . I $D(^GMR(123,+GMRCO,40,DA,0)),$O(^GMR(123,+GMRCO,40,DA,0)) S $P(GMRCOM,"^",2)=1
"RTN","GMRCP",76,0)
 . Q
"RTN","GMRCP",77,0)
 L -^GMR(123,+GMRCO,40)
"RTN","GMRCP",78,0)
 ; if an IFC, call event handler to generate a msg to remote site
"RTN","GMRCP",79,0)
 I $D(^GMR(123,GMRCO,12)),$L($P(^(12),U,5)) D
"RTN","GMRCP",80,0)
 . Q:'$D(^GMR(123,GMRCO,40,DA))
"RTN","GMRCP",81,0)
 . D TRIGR^GMRCIEVT(GMRCO,DA)
"RTN","GMRCP",82,0)
 ;
"RTN","GMRCP",83,0)
 K DIE,DA,DR,GMRCDEV,GMRCFF,GMRCPA,X,% Q
"RTN","GMRCP",84,0)
 ;
"RTN","GMRCP",85,0)
STATUS ;Update the status for the Request/Consultation File
"RTN","GMRCP",86,0)
 K GMRCQUT
"RTN","GMRCP",87,0)
 Q:'$D(GMRCSTS)!('$D(GMRCA))
"RTN","GMRCP",88,0)
 S DIE=123,DA=+GMRCO
"RTN","GMRCP",89,0)
 I $D(GMRCDR),$L(GMRCDR) S DR=GMRCDR
"RTN","GMRCP",90,0)
 E  S DR="8////^S X=GMRCSTS;9////^S X=GMRCA"
"RTN","GMRCP",91,0)
 L +^GMR(123,GMRCO):2 I '$T S GMRCQUT=1,GMRCERR=1,GMRCERMS="Unable to update status and last action - Consult In Use By Another User." Q
"RTN","GMRCP",92,0)
 D ^DIE
"RTN","GMRCP",93,0)
 L -^GMR(123,+GMRCO)
"RTN","GMRCP",94,0)
 K DIE,DA,DR,GMRCDR
"RTN","GMRCP",95,0)
 Q
"VER")
8.0^22.2
"BLD",10026,6)
^83
**END**
**END**

