KIDS Distribution saved on Aug 05, 2014@14:04:28
GMRC*3.0*73 ICD-10 Update
**KIDS**:GMRC*3.0*73^

**INSTALL NAME**
GMRC*3.0*73
"BLD",8113,0)
GMRC*3.0*73^CONSULT/REQUEST TRACKING^0^3140805^y
"BLD",8113,4,0)
^9.64PA^123^1
"BLD",8113,4,123,0)
123
"BLD",8113,4,123,2,0)
^9.641^123^1
"BLD",8113,4,123,2,123,0)
REQUEST/CONSULTATION  (File-top level)
"BLD",8113,4,123,2,123,1,0)
^9.6411^30^4
"BLD",8113,4,123,2,123,1,30,0)
PROVISIONAL DIAGNOSIS
"BLD",8113,4,123,2,123,1,30.1,0)
PROVISIONAL DIAGNOSIS CODE
"BLD",8113,4,123,2,123,1,30.2,0)
PROVISIONAL DIAGNOSIS DATE
"BLD",8113,4,123,2,123,1,30.3,0)
PROVISIONAL DIAGNOSIS SYSTEM
"BLD",8113,4,123,222)
y^y^p^^^^n^^n
"BLD",8113,4,123,224)

"BLD",8113,4,"APDD",123,123)

"BLD",8113,4,"APDD",123,123,30)

"BLD",8113,4,"APDD",123,123,30.1)

"BLD",8113,4,"APDD",123,123,30.2)

"BLD",8113,4,"APDD",123,123,30.3)

"BLD",8113,4,"B",123,123)

"BLD",8113,6.3)
22
"BLD",8113,"INIT")
POST^GMRCY73
"BLD",8113,"KRN",0)
^9.67PA^779.2^20
"BLD",8113,"KRN",.4,0)
.4
"BLD",8113,"KRN",.401,0)
.401
"BLD",8113,"KRN",.402,0)
.402
"BLD",8113,"KRN",.403,0)
.403
"BLD",8113,"KRN",.5,0)
.5
"BLD",8113,"KRN",.84,0)
.84
"BLD",8113,"KRN",3.6,0)
3.6
"BLD",8113,"KRN",3.8,0)
3.8
"BLD",8113,"KRN",9.2,0)
9.2
"BLD",8113,"KRN",9.8,0)
9.8
"BLD",8113,"KRN",9.8,"NM",0)
^9.68A^18^16
"BLD",8113,"KRN",9.8,"NM",1,0)
GMRCY73^^0^B682231
"BLD",8113,"KRN",9.8,"NM",2,0)
GMRCEDT1^^0^B70113386
"BLD",8113,"KRN",9.8,"NM",3,0)
GMRCEDT4^^0^B85583529
"BLD",8113,"KRN",9.8,"NM",4,0)
GMRCGUIC^^0^B69004877
"BLD",8113,"KRN",9.8,"NM",5,0)
GMRCHL72^^0^B16984753
"BLD",8113,"KRN",9.8,"NM",7,0)
GMRCHL7B^^0^B29886300
"BLD",8113,"KRN",9.8,"NM",9,0)
GMRCIACT^^0^B68184742
"BLD",8113,"KRN",9.8,"NM",10,0)
GMRCISG1^^0^B31718858
"BLD",8113,"KRN",9.8,"NM",11,0)
GMRCP5B^^0^B43394633
"BLD",8113,"KRN",9.8,"NM",12,0)
GMRCSLM2^^0^B92878039
"BLD",8113,"KRN",9.8,"NM",13,0)
GMRCEDT3^^0^B21921693
"BLD",8113,"KRN",9.8,"NM",14,0)
GMRCIAC1^^0^B78977784
"BLD",8113,"KRN",9.8,"NM",15,0)
GMRCGUIU^^0^B30591724
"BLD",8113,"KRN",9.8,"NM",16,0)
GMRCHL7A^^0^B31527698
"BLD",8113,"KRN",9.8,"NM",17,0)
GMRCEDT2^^0^B17559466
"BLD",8113,"KRN",9.8,"NM",18,0)
GMRCSLM4^^0^B48679858
"BLD",8113,"KRN",9.8,"NM","B","GMRCEDT1",2)

"BLD",8113,"KRN",9.8,"NM","B","GMRCEDT2",17)

"BLD",8113,"KRN",9.8,"NM","B","GMRCEDT3",13)

"BLD",8113,"KRN",9.8,"NM","B","GMRCEDT4",3)

"BLD",8113,"KRN",9.8,"NM","B","GMRCGUIC",4)

"BLD",8113,"KRN",9.8,"NM","B","GMRCGUIU",15)

"BLD",8113,"KRN",9.8,"NM","B","GMRCHL72",5)

"BLD",8113,"KRN",9.8,"NM","B","GMRCHL7A",16)

"BLD",8113,"KRN",9.8,"NM","B","GMRCHL7B",7)

"BLD",8113,"KRN",9.8,"NM","B","GMRCIAC1",14)

"BLD",8113,"KRN",9.8,"NM","B","GMRCIACT",9)

"BLD",8113,"KRN",9.8,"NM","B","GMRCISG1",10)

"BLD",8113,"KRN",9.8,"NM","B","GMRCP5B",11)

"BLD",8113,"KRN",9.8,"NM","B","GMRCSLM2",12)

"BLD",8113,"KRN",9.8,"NM","B","GMRCSLM4",18)

"BLD",8113,"KRN",9.8,"NM","B","GMRCY73",1)

"BLD",8113,"KRN",19,0)
19
"BLD",8113,"KRN",19.1,0)
19.1
"BLD",8113,"KRN",101,0)
101
"BLD",8113,"KRN",409.61,0)
409.61
"BLD",8113,"KRN",771,0)
771
"BLD",8113,"KRN",779.2,0)
779.2
"BLD",8113,"KRN",870,0)
870
"BLD",8113,"KRN",8989.51,0)
8989.51
"BLD",8113,"KRN",8989.52,0)
8989.52
"BLD",8113,"KRN",8994,0)
8994
"BLD",8113,"KRN","B",.4,.4)

"BLD",8113,"KRN","B",.401,.401)

"BLD",8113,"KRN","B",.402,.402)

"BLD",8113,"KRN","B",.403,.403)

"BLD",8113,"KRN","B",.5,.5)

"BLD",8113,"KRN","B",.84,.84)

"BLD",8113,"KRN","B",3.6,3.6)

"BLD",8113,"KRN","B",3.8,3.8)

"BLD",8113,"KRN","B",9.2,9.2)

"BLD",8113,"KRN","B",9.8,9.8)

"BLD",8113,"KRN","B",19,19)

"BLD",8113,"KRN","B",19.1,19.1)

"BLD",8113,"KRN","B",101,101)

"BLD",8113,"KRN","B",409.61,409.61)

"BLD",8113,"KRN","B",771,771)

"BLD",8113,"KRN","B",779.2,779.2)

"BLD",8113,"KRN","B",870,870)

"BLD",8113,"KRN","B",8989.51,8989.51)

"BLD",8113,"KRN","B",8989.52,8989.52)

"BLD",8113,"KRN","B",8994,8994)

"BLD",8113,"QUES",0)
^9.62^^
"BLD",8113,"REQB",0)
^9.611^7^7
"BLD",8113,"REQB",1,0)
GMRC*3.0*66^2
"BLD",8113,"REQB",2,0)
GMRC*3.0*44^2
"BLD",8113,"REQB",3,0)
GMRC*3.0*29^2
"BLD",8113,"REQB",4,0)
LEX*2.0*80^2
"BLD",8113,"REQB",5,0)
ICD*18.0*57^2
"BLD",8113,"REQB",6,0)
OR*3.0*361^2
"BLD",8113,"REQB",7,0)
GMRC*3.0*46^2
"BLD",8113,"REQB","B","GMRC*3.0*29",3)

"BLD",8113,"REQB","B","GMRC*3.0*44",2)

"BLD",8113,"REQB","B","GMRC*3.0*46",7)

"BLD",8113,"REQB","B","GMRC*3.0*66",1)

"BLD",8113,"REQB","B","ICD*18.0*57",5)

"BLD",8113,"REQB","B","LEX*2.0*80",4)

"BLD",8113,"REQB","B","OR*3.0*361",6)

"FIA",123)
REQUEST/CONSULTATION
"FIA",123,0)
^GMR(123,
"FIA",123,0,0)
123DI
"FIA",123,0,1)
y^y^p^^^^n^^n
"FIA",123,0,10)

"FIA",123,0,11)

"FIA",123,0,"RLRO")

"FIA",123,0,"VR")
3.0^GMRC
"FIA",123,123)
1
"FIA",123,123,30)

"FIA",123,123,30.1)

"FIA",123,123,30.2)

"FIA",123,123,30.3)

"INIT")
POST^GMRCY73
"MBREQ")
0
"PKG",294,-1)
1^1
"PKG",294,0)
CONSULT/REQUEST TRACKING^GMRC^CONSULTS/REQUESTS
"PKG",294,20,0)
^9.402P^^
"PKG",294,22,0)
^9.49I^1^1
"PKG",294,22,1,0)
3.0^2980101^2980917^11712
"PKG",294,22,1,"PAH",1,0)
73^3140805
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
16
"RTN","GMRCEDT1")
0^2^B70113386
"RTN","GMRCEDT1",1,0)
GMRCEDT1 ;SLC/DCM,JFR - EDIT A CONSULT AND RE-SEND AS NEW ;08/04/14  14:31
"RTN","GMRCEDT1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,15,22,33,47,66,73**;DEC 27, 1997;Build 22
"RTN","GMRCEDT1",3,0)
 ;
"RTN","GMRCEDT1",4,0)
 ; This routine invokes IA #2638 (^ORD(100.01,), #5699 (ICDXCODE), #10117 (VALM10)
"RTN","GMRCEDT1",5,0)
 ;                         #10103 (XLFDT), #10104 (XLFSTR), #10060 (access ^VA(200)), #2056 (GET1^DIQ)
"RTN","GMRCEDT1",6,0)
 ;
"RTN","GMRCEDT1",7,0)
EN(GMRCO) ;GMRCO=IEN of consult from file 123
"RTN","GMRCEDT1",8,0)
 ;GMRCSS=To Service   GMRCPROC=Procedure Request Type
"RTN","GMRCEDT1",9,0)
 ;GMRCURG=Urgency     GMRCPL=Place Of Consultation
"RTN","GMRCEDT1",10,0)
 ;GMRCATN=Attention   GMRCINO=Service is In/Out Patient
"RTN","GMRCEDT1",11,0)
 ;GMRCPNM=Patient Name  GMRCDIAG=Provisional Diagnosis
"RTN","GMRCEDT1",12,0)
 ;GMRCERDT=Earliest Appr. Date
"RTN","GMRCEDT1",13,0)
 ;GMRCPROS=Prosthetics Service y/n
"RTN","GMRCEDT1",14,0)
 ;GMRCCPTR=pointer to coding systems file
"RTN","GMRCEDT1",15,0)
 ;GMRCCSYS=provisional diagnosis code sys    GMRCCODE=provisional diagnosis code
"RTN","GMRCEDT1",16,0)
 N GMRCSS,GMRCPROC,GMRCURG,GMRCPL,GMRCATN,GMRCINO,GMRCDIAG,LN,GMRCRESP,GMRCERDT,GMRCPROS,IDX,GMRCDATE,GMRCCPTR,GMRCCSYS,GMRCCODE
"RTN","GMRCEDT1",17,0)
 N GMRCLBL,BUFFER,REPEAT
"RTN","GMRCEDT1",18,0)
 S REPEAT=24
"RTN","GMRCEDT1",19,0)
 K ^TMP("GMRCR",$J,"ED") S GMRCLNO=1
"RTN","GMRCEDT1",20,0)
 I $L($P(^GMR(123,+GMRCO,0),"^",12)) S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  CURRENT STATUS: (Not Editable): "_$P(^ORD(100.01,$P(^(0),"^",12),0),"^",1),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",21,0)
 S GMRCD=0 F  S GMRCD=$O(^GMR(123,+GMRCO,40,"B",GMRCD)) Q:'GMRCD  S GMRCDD="" F  S GMRCDD=$O(^GMR(123,GMRCO,40,"B",GMRCD,GMRCDD)) Q:'GMRCDD  D
"RTN","GMRCEDT1",22,0)
 .I $P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",2)=19 S LN=0 D
"RTN","GMRCEDT1",23,0)
 ..N GMRCPERS,GMRCTX
"RTN","GMRCEDT1",24,0)
 ..I '$D(^GMR(123,+GMRCO,12)) D
"RTN","GMRCEDT1",25,0)
 ...S GMRCPERS=+$P($G(^GMR(123,+GMRCO,40,GMRCDD,0)),"^",5)
"RTN","GMRCEDT1",26,0)
 ...S GMRCPERS=$$GET1^DIQ(200,GMRCPERS,.01)
"RTN","GMRCEDT1",27,0)
 ..I $D(^GMR(123,+GMRCO,12)) D
"RTN","GMRCEDT1",28,0)
 ...I $P(^GMR(123,+GMRCO,12),U,5)="P" D
"RTN","GMRCEDT1",29,0)
 ....S GMRCPERS=$P($G(^GMR(123,+GMRCO,40,GMRCDD,2)),U,1)
"RTN","GMRCEDT1",30,0)
 ...I $P(^GMR(123,+GMRCO,12),U,5)="F" D
"RTN","GMRCEDT1",31,0)
 ....S GMRCPERS=$P($G(^GMR(123,+GMRCO,40,GMRCDD,0)),U,5)
"RTN","GMRCEDT1",32,0)
 ....S GMRCPERS=$$GET1^DIQ(200,GMRCPERS,.01)
"RTN","GMRCEDT1",33,0)
 ..S GMRCTX="  CANCELLED BY (Not Editable): "_GMRCPERS
"RTN","GMRCEDT1",34,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=GMRCTX,GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",35,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  CANCELLED COMMENT (Not Editable):",GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",36,0)
 ..S LN=$O(^GMR(123,+GMRCO,40,GMRCDD,1,LN)) Q:LN=""!(LN?1A.E)  I $L(^GMR(123,+GMRCO,40,GMRCDD,1,LN,0))>75 S FLG=1 D WPSET^GMRCUTIL("^GMR(123,+GMRCO,40,GMRCDD,1)","^TMP(""GMRCR"",$J,""ED"")","",.GMRCLNO,"",FLG)
"RTN","GMRCEDT1",37,0)
 ..I '$D(FLG) S LN=0 F  S LN=$O(^GMR(123,+GMRCO,40,GMRCDD,1,LN)) Q:LN=""!(LN?1A.E)  S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^(LN,0),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",38,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="",$P(^(0),"-",79)=""
"RTN","GMRCEDT1",39,0)
 ..S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",40,0)
 ..Q
"RTN","GMRCEDT1",41,0)
 .Q
"RTN","GMRCEDT1",42,0)
 S GMRCSS=$S($D(GMRCEDT(1)):GMRCEDT(1),1:$P(^GMR(123,+GMRCO,0),"^",5)_U_$P(^GMR(123.5,$P(^GMR(123,+GMRCO,0),"^",5),0),U))
"RTN","GMRCEDT1",43,0)
 S GMRCPROC=$S($D(GMRCED(1)):GMRCED(1),1:$P(^GMR(123,+GMRCO,0),"^",8)_U_$$GET1^DIQ(123.3,+$P(^GMR(123,+GMRCO,0),"^",8),.01))
"RTN","GMRCEDT1",44,0)
 I $D(GMRCED(2)) S GMRCINO=GMRCED(2)
"RTN","GMRCEDT1",45,0)
 I '$D(GMRCINO) S GMRCINO=$P(^GMR(123,+GMRCO,0),U,18)_U_$S($P(^(0),U,18)="I":"Inpatient",1:"Outpatient")
"RTN","GMRCEDT1",46,0)
 S GMRCURG=$S($D(GMRCED(3)):GMRCED(3),1:$P(^GMR(123,+GMRCO,0),"^",9)_U_$$GET1^DIQ(101,+$P(^(0),"^",9),1))
"RTN","GMRCEDT1",47,0)
 S GMRCPL=$S($D(GMRCED(4)):GMRCED(4),1:$P(^GMR(123,+GMRCO,0),"^",10)_U_$$GET1^DIQ(101,+$P(^(0),U,10),1))
"RTN","GMRCEDT1",48,0)
 S GMRCPROS=$G(^GMR(123.5,$P(GMRCSS,U),"INT")) I $G(GMRCPROS)="" D
"RTN","GMRCEDT1",49,0)
 .S GMRCERDT=$S($D(GMRCED(5)):GMRCED(5),1:$P(^GMR(123,+GMRCO,0),"^",24)_U_$$FMTE^XLFDT($P(^GMR(123,GMRCO,0),U,24)))
"RTN","GMRCEDT1",50,0)
 S GMRCATN=$S($D(GMRCED(6)):GMRCED(6),1:$P(^GMR(123,+GMRCO,0),"^",11)_U_$$GET1^DIQ(200,+$P(^(0),U,11),.01))
"RTN","GMRCEDT1",51,0)
 I '$D(^GMR(123,GMRCO,30.1)) D
"RTN","GMRCEDT1",52,0)
 . I $D(GMRCED(7)),$L($P(GMRCED(7),U,2)) D  Q
"RTN","GMRCEDT1",53,0)
 .. S GMRCDIAG=$P(GMRCED(7),U)_" ("_$P(GMRCED(7),U,2)_")"
"RTN","GMRCEDT1",54,0)
 . S GMRCDIAG=$S($D(GMRCED(7)):GMRCED(7),1:$G(^GMR(123,+GMRCO,30)))
"RTN","GMRCEDT1",55,0)
 I $D(^GMR(123,GMRCO,30.1)) D
"RTN","GMRCEDT1",56,0)
 . S GMRCCODE=$P($G(^GMR(123,+GMRCO,30.1)),"^",1)
"RTN","GMRCEDT1",57,0)
 . S GMRCCSYS=$P($G(^GMR(123,+GMRCO,30.1)),"^",3)
"RTN","GMRCEDT1",58,0)
 . S:$G(GMRCCSYS)="ICD" GMRCLBL="(ICD-9-CM "_$G(GMRCCODE)_")"
"RTN","GMRCEDT1",59,0)
 . S:$G(GMRCCSYS)="10D" GMRCLBL="(ICD-10-CM "_$G(GMRCCODE)_")"
"RTN","GMRCEDT1",60,0)
 . I $D(GMRCED(7)),$L(GMRCED(7)) D  Q
"RTN","GMRCEDT1",61,0)
 .. S GMRCDIAG=$P(GMRCED(7),U)
"RTN","GMRCEDT1",62,0)
 .. S GMRCCODE=$P(GMRCED(7),U,2)
"RTN","GMRCEDT1",63,0)
 .. S GMRCCSYS="ICD" I DT>=$$IMPDATE^LEXU("10D") S GMRCCSYS="10D"
"RTN","GMRCEDT1",64,0)
 .. S:GMRCCSYS="ICD" GMRCLBL="(ICD-9-CM "_GMRCCODE_")"
"RTN","GMRCEDT1",65,0)
 .. S:GMRCCSYS="10D" GMRCLBL="(ICD-10-CM "_GMRCCODE_")"
"RTN","GMRCEDT1",66,0)
 .. S GMRCDIAG=GMRCDIAG_GMRCLBL
"RTN","GMRCEDT1",67,0)
 .. S GMRCCPTR=$S($G(GMRCCSYS)="ICD":1,1:30)
"RTN","GMRCEDT1",68,0)
 .. I '+$$STATCHK^ICDXCODE(GMRCCPTR,GMRCCODE,DT) D
"RTN","GMRCEDT1",69,0)
 ... S GMRCDIAG=GMRCDIAG_"   <INACTIVE CODE>"
"RTN","GMRCEDT1",70,0)
 . S GMRCDIAG=$G(^GMR(123,+GMRCO,30))_$G(GMRCLBL)
"RTN","GMRCEDT1",71,0)
 S GMRCREQ=$S(+$P(^GMR(123,+GMRCO,0),U,17)="P":"Procedure",1:"Consult")
"RTN","GMRCEDT1",72,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="SENDING PROVIDER (Not Editable): "_$S($P($G(^GMR(123,+GMRCO,12)),U,6):$P(^GMR(123,+GMRCO,12),U,6),$P(^GMR(123,+GMRCO,0),"^",14):$$GET1^DIQ(200,+$P(^GMR(123,+GMRCO,0),"^",14),.01),1:"UNKNOWN"),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",73,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="REQUEST TYPE (Not Editable): "_GMRCREQ,GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",74,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=$$REPEAT^XLFSTR("-",79),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",75,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  TO SERVICE (Not Editable): "_$P(GMRCSS,U,2) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",76,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=" ",GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",77,0)
 S IDX=1,^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" PROCEDURE: "_$P(GMRCPROC,U,2)
"RTN","GMRCEDT1",78,0)
 D:+GMRCPROC RVRS(GMRCLNO,$D(GMRCED(IDX))) S GMRCLNO=GMRCLNO+1,IDX=IDX+1
"RTN","GMRCEDT1",79,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" Performed as INPT OR OUTPT: "_$P(GMRCINO,U,2) D RVRS(GMRCLNO,$D(GMRCED(2))) S GMRCLNO=GMRCLNO+1,IDX=IDX+1
"RTN","GMRCEDT1",80,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" URGENCY: "_$P(GMRCURG,U,2) D RVRS(GMRCLNO,$D(GMRCED(3))) S GMRCLNO=GMRCLNO+1,IDX=IDX+1
"RTN","GMRCEDT1",81,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" PLACE OF CONSULTATION: "_$P(GMRCPL,U,2) D RVRS(GMRCLNO,$D(GMRCED(4))) S GMRCLNO=GMRCLNO+1,IDX=IDX+1
"RTN","GMRCEDT1",82,0)
 I $G(GMRCPROS)="" S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" EARLIEST APPROPRIATE DATE: "_$P(GMRCERDT,U,2) D RVRS(GMRCLNO,$D(GMRCED(5))) S GMRCLNO=GMRCLNO+1,IDX=IDX+1
"RTN","GMRCEDT1",83,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" ATTENTION (CONSULTANT): "_$P(GMRCATN,U,2) D RVRS(GMRCLNO,$D(GMRCED(6))) S GMRCLNO=GMRCLNO+1,IDX=IDX+1
"RTN","GMRCEDT1",84,0)
 I $L($G(GMRCDIAG))<55 S:$G(FLG)="" ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" PROVISIONAL DIAGNOSIS: "_GMRCDIAG D RVRS(GMRCLNO,$D(GMRCED(7))) S GMRCLNO=GMRCLNO+1,IDX=IDX+1
"RTN","GMRCEDT1",85,0)
 I $L($G(GMRCDIAG))>54 D
"RTN","GMRCEDT1",86,0)
 .N PIECE,FLG S FLG=0
"RTN","GMRCEDT1",87,0)
 .F  S PIECE=$L(GMRCDIAG) Q:PIECE<54  D
"RTN","GMRCEDT1",88,0)
 .. N SEG,I S I=2
"RTN","GMRCEDT1",89,0)
 .. F  S SEG=$P(GMRCDIAG," ",1,I) Q:$L(SEG)>=54!($L(SEG," ")<I)  S I=I+1
"RTN","GMRCEDT1",90,0)
 .. I $L(SEG)=$L(GMRCDIAG) S SEG=$E(GMRCDIAG,1,54) ;means GMRCDIAG doesn't contain spaces, e.g. v55,250.00,414.00,etc.
"RTN","GMRCEDT1",91,0)
 .. S BUFFER=SEG
"RTN","GMRCEDT1",92,0)
 .. S:SEG[" " SEG=$P(GMRCDIAG," ",1,(I-1)) I $L(SEG)=0 S SEG=$E(BUFFER,1,54) ;$P only good when SEG contains a space, otherwise grab a SEG from BUFFER
"RTN","GMRCEDT1",93,0)
 .. D KILL^VALM10(GMRCLNO)
"RTN","GMRCEDT1",94,0)
 .. S:FLG=0 ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" PROVISIONAL DIAGNOSIS: "_SEG D RVRS(GMRCLNO,$D(GMRCED(7)))
"RTN","GMRCEDT1",95,0)
 .. I FLG=1&($F(GMRCDIAG," ")'=2) S REPEAT=25
"RTN","GMRCEDT1",96,0)
 .. S:FLG=1 ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=$$REPEAT^XLFSTR(" ",REPEAT)_SEG
"RTN","GMRCEDT1",97,0)
 .. S FLG=1,GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",98,0)
 .. S GMRCDIAG=$E(GMRCDIAG,$L(SEG)+1,999)
"RTN","GMRCEDT1",99,0)
 . I $F(GMRCD," ")'=2 S REPEAT=25
"RTN","GMRCEDT1",100,0)
 . S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=$$REPEAT^XLFSTR(" ",REPEAT)_GMRCDIAG
"RTN","GMRCEDT1",101,0)
 . S IDX=IDX+1,GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",102,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" REASON FOR REQUEST:" D RVRS(GMRCLNO,$D(^TMP("GMRCED",$J,20))) S GMRCLNO=GMRCLNO+1,IDX=IDX+1 D
"RTN","GMRCEDT1",103,0)
 . I $D(^TMP("GMRCED",$J,20)) D  Q
"RTN","GMRCEDT1",104,0)
 .. N ND S ND=0
"RTN","GMRCEDT1",105,0)
 .. F  S ND=$O(^TMP("GMRCED",$J,20,ND)) Q:'ND  D
"RTN","GMRCEDT1",106,0)
 ... D KILL^VALM10(GMRCLNO)
"RTN","GMRCEDT1",107,0)
 ... S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^TMP("GMRCED",$J,20,ND,0)
"RTN","GMRCEDT1",108,0)
 ... S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",109,0)
 . N ND S ND=0
"RTN","GMRCEDT1",110,0)
 . F  S ND=$O(^GMR(123,+GMRCO,20,ND)) Q:ND=""  D
"RTN","GMRCEDT1",111,0)
 .. S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^GMR(123,+GMRCO,20,ND,0)
"RTN","GMRCEDT1",112,0)
 .. S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",113,0)
 .Q
"RTN","GMRCEDT1",114,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="",GMRCLNO=GMRCLNO+1,^TMP("GMRCR",$J,"ED",GMRCLNO,0)=IDX_" COMMENT(S): (Add Only)" D RVRS(GMRCLNO) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",115,0)
 I $D(^TMP("GMRCED",$J,40)) D
"RTN","GMRCEDT1",116,0)
 . D KILL^VALM10(GMRCLNO)
"RTN","GMRCEDT1",117,0)
 . S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  New Comment:",GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",118,0)
 . N ND S ND=0 F  S ND=$O(^TMP("GMRCED",$J,40,ND)) Q:'ND  D
"RTN","GMRCEDT1",119,0)
 .. S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^TMP("GMRCED",$J,40,ND,0)
"RTN","GMRCEDT1",120,0)
 .. S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",121,0)
 N GMRCEDCT
"RTN","GMRCEDT1",122,0)
 S GMRCD=0,GMRCEDCT=0 F  S GMRCD=$O(^GMR(123,+GMRCO,40,"B",GMRCD)) Q:'GMRCD  S GMRCDD="",GMRCDD=$O(^GMR(123,+GMRCO,40,"B",GMRCD,GMRCDD)) Q:'GMRCDD  D
"RTN","GMRCEDT1",123,0)
 .I $P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",2)=20 S LN=0,GMRCEDCT=GMRCEDCT+1,GMRCEDCM(GMRCEDCT)=GMRCDD D
"RTN","GMRCEDT1",124,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="",GMRCLNO=GMRCLNO+1,^TMP("GMRCR",$J,"ED",GMRCLNO,0)="ADDED COMMENT (Not Editable) Entered: "_$P($$FMTE^XLFDT($P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",1)),"@",1)
"RTN","GMRCEDT1",125,0)
 ..S GMRCRESP=$S($L($P($G(^GMR(123,+GMRCO,40,GMRCDD,0)),"^",5)):$$GET1^DIQ(200,$P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",5),.01),$L($P($G(^GMR(123,+GMRCO,40,GMRCDD,2)),"^",1)):$P(^GMR(123,+GMRCO,40,GMRCDD,2),"^",1),1:"UNKNOWN")
"RTN","GMRCEDT1",126,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^TMP("GMRCR",$J,"ED",GMRCLNO,0)_" BY: "_GMRCRESP,GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",127,0)
 ..;S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^TMP("GMRCR",$J,"ED",GMRCLNO,0)_" BY: "_$S($L($P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",4)):$P(^VA(200,$P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",4),0),"^",1),1:"UNKNOWN"),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",128,0)
 ..S LN=$O(^GMR(123,+GMRCO,40,GMRCDD,1,LN)) Q:LN=""!(LN?1A.E)  I $L(^GMR(123,+GMRCO,40,GMRCDD,1,LN,0))>75 S FLG=1 D WPSET^GMRCUTIL("^GMR(123,+GMRCO,40,GMRCDD,1)","^TMP(""GMRCR"",$J,""ED"")","",.GMRCLNO,"",FLG) Q
"RTN","GMRCEDT1",129,0)
 ..S LN=0 F  S LN=$O(^GMR(123,+GMRCO,40,GMRCDD,1,LN)) Q:LN=""!(LN?1A.E)  S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^(LN,0),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",130,0)
 ..Q
"RTN","GMRCEDT1",131,0)
 .Q
"RTN","GMRCEDT1",132,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=""
"RTN","GMRCEDT1",133,0)
 K FLG
"RTN","GMRCEDT1",134,0)
 Q
"RTN","GMRCEDT1",135,0)
RVRS(LINE,EDITED) ;reverse video for fields that can be edited
"RTN","GMRCEDT1",136,0)
 I '$G(EDITED) D CNTRL^VALM10(LINE,1,1,IORVON,IORVOFF) Q
"RTN","GMRCEDT1",137,0)
 D CNTRL^VALM10(LINE,1,1,IORVON_IOINHI,IORVOFF_IOINORM)
"RTN","GMRCEDT1",138,0)
 Q
"RTN","GMRCEDT2")
0^17^B17559466
"RTN","GMRCEDT2",1,0)
GMRCEDT2 ;SLC/JFR,DCM - RESUBMIT A CANCELLED CONSULT ;01/29/14  11:56
"RTN","GMRCEDT2",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,15,22,33,66,46,73**;DEC 27, 1997;Build 22
"RTN","GMRCEDT2",3,0)
 ;
"RTN","GMRCEDT2",4,0)
 ;ICRs in use: #2053 (DIE), #2056 (GET1^DIQ), #872 (ORD(101))
"RTN","GMRCEDT2",5,0)
 ;
"RTN","GMRCEDT2",6,0)
EN(GMRCO,COMNO) ;entry point into the routine
"RTN","GMRCEDT2",7,0)
 ;COMNO=CMDA from ^GMRCEDT2=comments array IEN from ^GMR(123,IEN,40,
"RTN","GMRCEDT2",8,0)
 ;GMRCO=IEN of the consult from file 123
"RTN","GMRCEDT2",9,0)
 I $S($P(^GMR(123,GMRCO,0),"^",12)'=13:1,$D(GMRCRSUB):1,1:0) D  Q
"RTN","GMRCEDT2",10,0)
 .S GMRCMSG="***     Consult Has Already Been Resubmitted   ***"
"RTN","GMRCEDT2",11,0)
 .S GMRCMSG(1)="***  No Further Action Is Required Or Allowed ***"
"RTN","GMRCEDT2",12,0)
 .D EXAC^GMRCADC(.GMRCMSG)
"RTN","GMRCEDT2",13,0)
 .S:'$D(GMRCRSUB) GMRCRSUB=1
"RTN","GMRCEDT2",14,0)
 .Q
"RTN","GMRCEDT2",15,0)
 N MSG S MSG=$$EDRESOK(GMRCO)
"RTN","GMRCEDT2",16,0)
 I '+MSG D EXAC^GMRCADC($P(MSG,U,2)) Q
"RTN","GMRCEDT2",17,0)
 I '$$PDOK^GMRCEDT4(GMRCO) D  Q
"RTN","GMRCEDT2",18,0)
 . D EXAC^GMRCADC("Can't resubmit!")
"RTN","GMRCEDT2",19,0)
 . S GMRCRSUB=1
"RTN","GMRCEDT2",20,0)
 . Q
"RTN","GMRCEDT2",21,0)
 I '$D(GMRCGUIF) W !,"Resubmitting Consult ... One moment please ..."
"RTN","GMRCEDT2",22,0)
 K ^TMP("GMRCSUB",$J) S ^TMP("GMRCSUB",$J)=0
"RTN","GMRCEDT2",23,0)
 I $D(GMRCEDT(1)) S ^TMP("GMRCSUB",$J,1)="GMRCSS^"_+GMRCEDT(1)
"RTN","GMRCEDT2",24,0)
 I $D(GMRCED(1)) D
"RTN","GMRCEDT2",25,0)
 . I $P(GMRCED(1),U)=$P(^GMR(123,+GMRCO,0),U,8) K GMRCED(1) Q
"RTN","GMRCEDT2",26,0)
 . S ^TMP("GMRCSUB",$J,2)="GMRCPROC^"_+GMRCED(1)_";GMR(123.3,"
"RTN","GMRCEDT2",27,0)
 I $D(GMRCED(2)) D
"RTN","GMRCEDT2",28,0)
 . I $P(GMRCED(2),U)=$P(^GMR(123,+GMRCO,0),U,18) K GMRCED(2) Q
"RTN","GMRCEDT2",29,0)
 . S ^TMP("GMRCSUB",$J,3)="GMRCION^"_$P(GMRCED(2),U)
"RTN","GMRCEDT2",30,0)
 I $D(GMRCED(3)) D
"RTN","GMRCEDT2",31,0)
 . I $P(GMRCED(3),U)=$P(^GMR(123,+GMRCO,0),U,9) K GMRCED(3) Q
"RTN","GMRCEDT2",32,0)
 . S ^TMP("GMRCSUB",$J,4)="GMRCURG^"_$P(GMRCED(3),U)
"RTN","GMRCEDT2",33,0)
 I $D(GMRCED(4)) D
"RTN","GMRCEDT2",34,0)
 . I $P(GMRCED(4),U)=$P(^GMR(123,+GMRCO,0),U,10) K GMRCED(4) Q
"RTN","GMRCEDT2",35,0)
 . S ^TMP("GMRCSUB",$J,5)="GMRCPL^"_$P(GMRCED(4),U)
"RTN","GMRCEDT2",36,0)
 I $D(GMRCED(5)) D  ;wat/66 add early date
"RTN","GMRCEDT2",37,0)
 . I $P(GMRCED(5),U)=$P(^GMR(123,+GMRCO,0),U,24) K GMRCED(5) Q
"RTN","GMRCEDT2",38,0)
 . S ^TMP("GMRCSUB",$J,6)="GMRCERDT^"_$P(GMRCED(5),U)
"RTN","GMRCEDT2",39,0)
 I $D(GMRCED(6)) D
"RTN","GMRCEDT2",40,0)
 . I $P(GMRCED(6),U)=$P(^GMR(123,+GMRCO,0),U,11) K GMRCED(6) Q
"RTN","GMRCEDT2",41,0)
 . I '$L($P(GMRCED(6),U)) S $P(GMRCED(6),U)="@"
"RTN","GMRCEDT2",42,0)
 . S ^TMP("GMRCSUB",$J,7)="GMRCATN^"_$P(GMRCED(6),U)
"RTN","GMRCEDT2",43,0)
 I $D(GMRCED(7)) D
"RTN","GMRCEDT2",44,0)
 . I GMRCED(7)=$G(^GMR(123,+GMRCO,30)) K GMRCED(7) Q
"RTN","GMRCEDT2",45,0)
 . I $P(GMRCED(7),U)_" ("_$P(GMRCED(7),U,2)_")"=$G(^GMR(123,GMRCO,30)) K GMRCED(7) Q
"RTN","GMRCEDT2",46,0)
 . I '$L($P(GMRCED(7),U)) S $P(GMRCED(7),U,1,2)="@"
"RTN","GMRCEDT2",47,0)
 . S ^TMP("GMRCSUB",$J,8)="GMRCDIAG^"_GMRCED(7)
"RTN","GMRCEDT2",48,0)
 I $D(^TMP("GMRCED",$J,20)) S ^TMP("GMRCSUB",$J,20)="GMRCRFQ^" D
"RTN","GMRCEDT2",49,0)
 . N ND S ND=0
"RTN","GMRCEDT2",50,0)
 . F  S ND=$O(^TMP("GMRCED",$J,20,ND)) Q:'ND  D
"RTN","GMRCEDT2",51,0)
 .. S ^TMP("GMRCSUB",$J,20,ND)=^TMP("GMRCED",$J,20,ND,0)
"RTN","GMRCEDT2",52,0)
 I $D(^TMP("GMRCED",$J,40)) S ^TMP("GMRCSUB",$J,40)="COMMENT^" D
"RTN","GMRCEDT2",53,0)
 . N ND S ND=0
"RTN","GMRCEDT2",54,0)
 . F  S ND=$O(^TMP("GMRCED",$J,40,ND)) Q:'ND  D
"RTN","GMRCEDT2",55,0)
 .. S ^TMP("GMRCSUB",$J,40,ND)=^TMP("GMRCED",$J,40,ND,0)
"RTN","GMRCEDT2",56,0)
 D FILE^GMRCGUIC(+GMRCO,$NAME(^TMP("GMRCSUB",$J)),1)
"RTN","GMRCEDT2",57,0)
 N GMRCADUZ S GMRCADUZ=""
"RTN","GMRCEDT2",58,0)
 S DFN=$P(^GMR(123,+GMRCO,0),"^",2),GMRCPROV=$P(^(0),"^",14)
"RTN","GMRCEDT2",59,0)
 S GMRCTYPE=$P(^GMR(123,+GMRCO,0),U,17),GMRCTRLC="XX",VISIT="",RMBED=""
"RTN","GMRCEDT2",60,0)
 S DIE="^GMR(123,",DA=+GMRCO,DR="8////^S X=5;9////^S X=11" D ^DIE
"RTN","GMRCEDT2",61,0)
 K DIE,DA,DR
"RTN","GMRCEDT2",62,0)
 S GMRCRSUB=1
"RTN","GMRCEDT2",63,0)
 S GMRCURG=$P(^GMR(123,+GMRCO,0),"^",9)
"RTN","GMRCEDT2",64,0)
 I +$P(^GMR(123,+GMRCO,0),"^",11) S GMRCADUZ($P(^(0),"^",11))=""
"RTN","GMRCEDT2",65,0)
 S GMRCSVC=$P(^GMR(123,+GMRCO,0),"^",5)
"RTN","GMRCEDT2",66,0)
 I +GMRCSVC D
"RTN","GMRCEDT2",67,0)
 . D EN^GMRCT(GMRCSVC)
"RTN","GMRCEDT2",68,0)
 S GMRCORTX="Resubmitted consult "_$$ORTX^GMRCAU(+GMRCO)_$S(+GMRCURG:" ("_$P(^ORD(101,+GMRCURG,0),"^",2)_")",1:"")
"RTN","GMRCEDT2",69,0)
 K GMRCFL,GMRCPROV,GMRCTYPE,GMRCTRLC,VISIT,RMBED,GMRCOM,GMRCURG
"RTN","GMRCEDT2",70,0)
 K GMRCSVC,GMRCORTX
"RTN","GMRCEDT2",71,0)
 Q
"RTN","GMRCEDT2",72,0)
EDRESOK(GMRCDA) ;check cslt or proc to see if still resubmittable
"RTN","GMRCEDT2",73,0)
 ; if procedure is inactive or no services, not resubmittable
"RTN","GMRCEDT2",74,0)
 ; if service is grouper or disabled, not resubmittable
"RTN","GMRCEDT2",75,0)
 N MSG,GMRC
"RTN","GMRCEDT2",76,0)
 Q:'$D(^GMR(123,+$G(GMRCDA),0)) "0^Invalid Consult Number"
"RTN","GMRCEDT2",77,0)
 I $P($G(^GMR(123,+GMRCDA,12)),U,5)="F" D  Q MSG
"RTN","GMRCEDT2",78,0)
 . S MSG="0^This inter-facility cconsult may only be resubmitted by the"
"RTN","GMRCEDT2",79,0)
 . S MSG=MSG_" ordering facility."
"RTN","GMRCEDT2",80,0)
 S GMRC(0)=^GMR(123,+GMRCDA,0)
"RTN","GMRCEDT2",81,0)
 I '$P(GMRC(0),U,8) D  Q MSG
"RTN","GMRCEDT2",82,0)
 . I "19"[+$P(^GMR(123.5,+$P(GMRC(0),U,5),0),U,2) D  Q
"RTN","GMRCEDT2",83,0)
 .. S MSG="0^The service for this Consult is no longer orderable."
"RTN","GMRCEDT2",84,0)
 . S MSG=1
"RTN","GMRCEDT2",85,0)
 S MSG=1
"RTN","GMRCEDT2",86,0)
 I "19"[+$P(^GMR(123.5,+$P(GMRC(0),U,5),0),U,2) S MSG=0
"RTN","GMRCEDT2",87,0)
 I '$L($$GET1^DIQ(123.3,+$P(GMRC(0),U,8),.01)) S MSG=0
"RTN","GMRCEDT2",88,0)
 I +$$GET1^DIQ(123.3,+$P(GMRC(0),U,8),.02) S MSG=0
"RTN","GMRCEDT2",89,0)
 I '$D(^GMR(123.3,+$P(GMRC(0),U,8),2,"B",+$P(GMRC(0),U,5))) S MSG=0
"RTN","GMRCEDT2",90,0)
 I MSG=0 D
"RTN","GMRCEDT2",91,0)
 . S MSG=MSG_"^This procedure may no longer be ordered or the service "
"RTN","GMRCEDT2",92,0)
 . S MSG=MSG_"may no longer perform it."
"RTN","GMRCEDT2",93,0)
 Q MSG
"RTN","GMRCEDT3")
0^13^B21921693
"RTN","GMRCEDT3",1,0)
GMRCEDT3 ;SLC/DCM,JFR - file edit/resubmit ;07/06/12  13:15
"RTN","GMRCEDT3",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,15,22,66,73**;DEC 27, 1997;Build 22
"RTN","GMRCEDT3",3,0)
 ;
"RTN","GMRCEDT3",4,0)
 ;IRCS in use: #2053 (DIE), #2056 (GET1^DIQ), #10103 (XLFDT), #10104 (XLFSTR)
"RTN","GMRCEDT3",5,0)
 ;
"RTN","GMRCEDT3",6,0)
EN(GMRCDA) ;File tracking Data from array
"RTN","GMRCEDT3",7,0)
 W:'$D(GMRCGUIF) !,"Filing Tracking Data..."
"RTN","GMRCEDT3",8,0)
 N GMRCOUNT,GMRC40DA
"RTN","GMRCEDT3",9,0)
 S GMRCDT=$$NOW^XLFDT
"RTN","GMRCEDT3",10,0)
 S DIE="^GMR(123,",DA=GMRCDA,DR="8////^S X=5" D ^DIE K DIE,DA,DR
"RTN","GMRCEDT3",11,0)
 I '$D(^GMR(123,GMRCDA,40,0)) S ^GMR(123,GMRCDA,40,0)="123.02^^"
"RTN","GMRCEDT3",12,0)
 S DA=$S(+$P(^GMR(123,GMRCDA,40,0),"^",3):$P(^(0),"^",3)+1,1:1)
"RTN","GMRCEDT3",13,0)
 S GMRC40DA=DA
"RTN","GMRCEDT3",14,0)
 S $P(^GMR(123,GMRCDA,40,0),"^",3,4)=DA_"^"_DA D
"RTN","GMRCEDT3",15,0)
 .S ^GMR(123,GMRCDA,40,DA,0)=GMRCDT_"^"_$O(^GMR(123.1,"B","EDIT/RESUBMITTED",0))_"^"_GMRCDT_"^"_DUZ_"^"_DUZ D
"RTN","GMRCEDT3",16,0)
 .S ^GMR(123,GMRCDA,40,DA,1,0)="^^^^"_GMRCDT_"^" D
"RTN","GMRCEDT3",17,0)
 ..S GMRCOUNT=1,GMRCND=0,^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)=$$REPEAT^XLFSTR("-",21)_" PREVIOUS VALUES OF EDITED FIELDS  "_$$REPEAT^XLFSTR("-",21),GMRCOUNT=GMRCOUNT+1
"RTN","GMRCEDT3",18,0)
 ..I '$D(GMRCFLD) S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="No Fields Were Edited Before Resubmission",GMRCOUNT=GMRCOUNT+1 Q
"RTN","GMRCEDT3",19,0)
 ..F  S GMRCND=$O(GMRCFLD(GMRCND)) Q:GMRCND=""  D  S GMRCOUNT=GMRCOUNT+1
"RTN","GMRCEDT3",20,0)
 ...I GMRCND=.1 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="DISPLAY TEXT OF ITEM ORDERED: "_$P(GMRCFLD(GMRCND),"^",1),GMRCOUNT=GMRCOUNT+1 Q
"RTN","GMRCEDT3",21,0)
 ...I GMRCND=1 D  S GMRCOUNT=GMRCOUNT+1 Q
"RTN","GMRCEDT3",22,0)
 ....S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="To Service: "_$S($L($P(GMRCFLD(GMRCND),U)):$P(GMRCFLD(GMRCND),U),1:"No Previous Value")
"RTN","GMRCEDT3",23,0)
 ....Q
"RTN","GMRCEDT3",24,0)
 ...I GMRCND=4 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Procedure: "_$$GET1^DIQ(123.3,+GMRCFLD(4),.01) Q
"RTN","GMRCEDT3",25,0)
 ...I GMRCND=14 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Performed as Inpt or Outpt: "_$S($L($P(GMRCFLD(GMRCND),"^")):$P(GMRCFLD(GMRCND),U),1:"No Previous Value") Q
"RTN","GMRCEDT3",26,0)
 ...I $S(GMRCND=5:1,GMRCND=6:1,GMRCND=13:1,1:0) D  Q
"RTN","GMRCEDT3",27,0)
 ....N CAPTION S CAPTION=$S(GMRCND=5:"Urgency: ",GMRCND=6:"Place of Consultation: ",1:"Type of Request: ")
"RTN","GMRCEDT3",28,0)
 ....S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)=CAPTION_$S($L($P(GMRCFLD(GMRCND),U)):$P(GMRCFLD(GMRCND),U),1:"No Previous Value")
"RTN","GMRCEDT3",29,0)
 ...I GMRCND=7 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Attention: "_$S($L($P(GMRCFLD(GMRCND),U)):$P(GMRCFLD(GMRCND),U),1:"No Previous Value") Q
"RTN","GMRCEDT3",30,0)
 ...I GMRCND=17 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Earliest Appropriate Date: "_$S($L($P(GMRCFLD(GMRCND),U)):$P(GMRCFLD(GMRCND),U),1:"No Previous Value") ;wat/66
"RTN","GMRCEDT3",31,0)
 ...I GMRCND=20 N GMRCND1 S GMRCND1=0,GMRCOUNT=GMRCOUNT+1 D  Q
"RTN","GMRCEDT3",32,0)
 ....S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Reason for Request: "
"RTN","GMRCEDT3",33,0)
 ....S GMRCOUNT=GMRCOUNT+1
"RTN","GMRCEDT3",34,0)
 ....F  S GMRCND1=$O(@GMRCFLD(20)@(GMRCND1)) Q:GMRCND1=""  S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)=@GMRCFLD(20)@(GMRCND1,0),GMRCOUNT=GMRCOUNT+1
"RTN","GMRCEDT3",35,0)
 ...I GMRCND=30 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Provisional Diagnosis: "_$S($L($P(GMRCFLD(GMRCND),U)):$P(GMRCFLD(GMRCND),U),1:"No Previous Value") Q
"RTN","GMRCEDT3",36,0)
 ...I GMRCND=30.1 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Provisional Diagnosis Code: "_$S($L($P(GMRCFLD(GMRCND),U)):$P(GMRCFLD(GMRCND),U),1:"No Previous Value") Q
"RTN","GMRCEDT3",37,0)
 ...I GMRCND=30.2 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Provisional Diagnosis Date: "_$S($L($P(GMRCFLD(GMRCND),U)):$P(GMRCFLD(GMRCND),U),1:"No Previous Value") Q
"RTN","GMRCEDT3",38,0)
 ...I GMRCND=30.3 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Provisional Diagnosis System: "_$S($L($P(GMRCFLD(GMRCND),U)):$P(GMRCFLD(GMRCND),U),1:"No Previous Value") Q
"RTN","GMRCEDT3",39,0)
 ...I GMRCND=40 S ^GMR(123,+GMRCDA,40,DA,1,GMRCOUNT,0)=$P(GMRCFLD(GMRCND),"^",1) Q
"RTN","GMRCEDT3",40,0)
 ...Q
"RTN","GMRCEDT3",41,0)
 ..Q
"RTN","GMRCEDT3",42,0)
 .S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)=$$REPEAT^XLFSTR("-",75),GMRCOUNT=GMRCOUNT-1,^GMR(123,+GMRCDA,40,"B",GMRCDT,DA)=""
"RTN","GMRCEDT3",43,0)
 .S $P(^GMR(123,GMRCDA,40,DA,1,0),"^",3)=GMRCOUNT-1,$P(^(0),"^",4)=GMRCOUNT-1,^GMR(123,+GMRCDA,40,"B",GMRCDT,DA)=""
"RTN","GMRCEDT3",44,0)
 .Q
"RTN","GMRCEDT3",45,0)
 K GMRCIND,GMRCND
"RTN","GMRCEDT3",46,0)
 Q GMRC40DA
"RTN","GMRCEDT3",47,0)
 ;
"RTN","GMRCEDT3",48,0)
ADDCM(GMRCO) ;set up to add comment when none exists or to add a new comment
"RTN","GMRCEDT3",49,0)
 ;returns DA for the entry it sets up
"RTN","GMRCEDT3",50,0)
 N X
"RTN","GMRCEDT3",51,0)
 S:'$D(^GMR(123,+GMRCO,40,0)) ^(0)="^123.02DA^^" S X=$S($P(^GMR(123,GMRCO,40,0),"^",3):$P(^(0),"^",3)+1,1:1)
"RTN","GMRCEDT3",52,0)
 S $P(^GMR(123,GMRCO,40,0),"^",3,4)=X_"^"_X
"RTN","GMRCEDT3",53,0)
 Q X
"RTN","GMRCEDT3",54,0)
 ;
"RTN","GMRCEDT3",55,0)
AUDIT0(DA,GMRCDA) ;Add the necessary tracking information to word processing fields
"RTN","GMRCEDT3",56,0)
 N DIE,DR
"RTN","GMRCEDT3",57,0)
 S DIE="^GMR(123,"_GMRCDA_",40,",DA(1)=GMRCDA,DR=".01////^S X=$$NOW^XLFDT;1////^S X=GMRCA;2////^S X=$$NOW^XLFDT;3////^S X=DUZ;4////^S X=DUZ"
"RTN","GMRCEDT3",58,0)
 D ^DIE
"RTN","GMRCEDT3",59,0)
 Q
"RTN","GMRCEDT4")
0^3^B85583529
"RTN","GMRCEDT4",1,0)
GMRCEDT4 ;SLC/DCM,JFR - UTILITIES FOR EDITING FIELDS ;03/27/13  09:21
"RTN","GMRCEDT4",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,15,22,33,66,73**;DEC 27, 1997;Build 22
"RTN","GMRCEDT4",3,0)
 ;
"RTN","GMRCEDT4",4,0)
 ; This routine invokes IA #5699 (ICDXCODE), #872 (ORD(101)), #10142 (DDIOL), #10006 (DIC)
"RTN","GMRCEDT4",5,0)
 ;                         #2051 (FIND1^DIC), #2056 (GET1^DIQ), #10026 (DIR), #10028 (DIWE)
"RTN","GMRCEDT4",6,0)
 ;                         #1572 (LEX(757.01), #1609 (CONFIG^LEXSET), #10103 (XLFDT), #10104 (XLFSTR), #10140 (XQORM)
"RTN","GMRCEDT4",7,0)
 ;
"RTN","GMRCEDT4",8,0)
 Q
"RTN","GMRCEDT4",9,0)
EDITFLD(GMRCO)    ;edit field in file 123.
"RTN","GMRCEDT4",10,0)
 ;GMRCO=IEN of consult record in file 123
"RTN","GMRCEDT4",11,0)
 N DIR,X,Y,GMRCSS,GMRCPROC,GMRCPROC,GMRCURG,GMRCPL,GMRCREND,GMRCY,GMRCX
"RTN","GMRCEDT4",12,0)
 N GMRCMSG,GMRCTAG
"RTN","GMRCEDT4",13,0)
 I $S($P(^GMR(123,GMRCO,0),"^",12)'=13:1,$D(GMRCRSUB):1,1:0) D  Q
"RTN","GMRCEDT4",14,0)
 .S GMRCMSG="This consult is no longer editable." D EXAC^GMRCADC(GMRCMSG)
"RTN","GMRCEDT4",15,0)
 S GMRCMSG=$$EDRESOK^GMRCEDT2(GMRCO)
"RTN","GMRCEDT4",16,0)
 I '+GMRCMSG D EXAC^GMRCADC($P(GMRCMSG,U,2)) Q
"RTN","GMRCEDT4",17,0)
 I $$PDOK(GMRCO)
"RTN","GMRCEDT4",18,0)
 S DIR(0)="LAO^1:9",DIR("A")="Select the fields to edit: "
"RTN","GMRCEDT4",19,0)
 D ^DIR I $D(DIRUT) Q
"RTN","GMRCEDT4",20,0)
 I $P(Y,",")<1 Q
"RTN","GMRCEDT4",21,0)
 S GMRCY=Y
"RTN","GMRCEDT4",22,0)
 F GMRCX=1:1:9 S GMRCTAG=$P(GMRCY,",",GMRCX) Q:'GMRCTAG  D
"RTN","GMRCEDT4",23,0)
 . D SETUP
"RTN","GMRCEDT4",24,0)
 . D @GMRCTAG
"RTN","GMRCEDT4",25,0)
 . K DIROUT,DIRUT,DTOUT,DUOUT
"RTN","GMRCEDT4",26,0)
 . D EN^GMRCEDT1(+GMRCO),INIT^GMRCEDIT
"RTN","GMRCEDT4",27,0)
 Q
"RTN","GMRCEDT4",28,0)
SETUP   ;get info needed for edit (save global reads)
"RTN","GMRCEDT4",29,0)
 S:$D(GMRCEDT(1)) GMRCSS=GMRCEDT(1)
"RTN","GMRCEDT4",30,0)
 I '$D(GMRCSS) S GMRCSS=$P(^GMR(123,+GMRCO,0),U,5),GMRCSS=GMRCSS_U_$P(^GMR(123.5,GMRCSS,0),U)
"RTN","GMRCEDT4",31,0)
 S:$D(GMRCED(1)) GMRCPROC=GMRCED(1)
"RTN","GMRCEDT4",32,0)
 I '$D(GMRCPROC) S GMRCPROC=+$P(^GMR(123,+GMRCO,0),U,8),GMRCPROC=GMRCPROC_U_$$GET1^DIQ(123.3,+GMRCPROC,.01)
"RTN","GMRCEDT4",33,0)
 S:$D(GMRCED(2)) GMRCREND=GMRCED(2)
"RTN","GMRCEDT4",34,0)
 I '$D(GMRCREND) S GMRCREND=$P(^GMR(123,GMRCO,0),U,18),GMRCREND=GMRCREND_U_$S(GMRCREND="I":"In",1:"Out")_"patient"
"RTN","GMRCEDT4",35,0)
 S:$D(GMRCED(3)) GMRCURG=GMRCED(3)
"RTN","GMRCEDT4",36,0)
 I '$D(GMRCURG) S GMRCURG=$P(^GMR(123,+GMRCO,0),U,9),GMRCURG=GMRCURG_U_$$GET1^DIQ(101,+GMRCURG,1)
"RTN","GMRCEDT4",37,0)
 S:$D(GMRCED(4)) GMRCPL=GMRCED(4)
"RTN","GMRCEDT4",38,0)
 I '$D(GMRCPL) S GMRCPL=$P(^GMR(123,+GMRCO,0),U,10),GMRCPL=GMRCPL_U_$$GET1^DIQ(101,+GMRCPL,1)
"RTN","GMRCEDT4",39,0)
 Q
"RTN","GMRCEDT4",40,0)
01       ;edit TO SERVICE
"RTN","GMRCEDT4",41,0)
 N I,PROCSERV,DIR,X,Y
"RTN","GMRCEDT4",42,0)
 I $G(GMRCPROC) D  Q:'PROCSERV
"RTN","GMRCEDT4",43,0)
 . N I S I=0,PROCSERV=0 F  S I=$O(^GMR(123.3,+GMRCPROC,2,"B",I)) Q:'I  D
"RTN","GMRCEDT4",44,0)
 .. S PROCSERV(I)="",PROCSERV=PROCSERV+1
"RTN","GMRCEDT4",45,0)
 . I PROCSERV=1 W !,"Only one SERVICE can perform this procedure.",!
"RTN","GMRCEDT4",46,0)
 S DIR(0)="PA^123.5:EMQ"
"RTN","GMRCEDT4",47,0)
 I $G(PROCSERV) D
"RTN","GMRCEDT4",48,0)
 . I $D(PROCSERV(+GMRCSS)) Q
"RTN","GMRCEDT4",49,0)
 . S DIR("B")=$$GET1^DIQ(123.5,$O(PROCSERV(0)),.01)
"RTN","GMRCEDT4",50,0)
 I '$D(DIR("B")) S DIR("B")=$P(GMRCSS,U,2)
"RTN","GMRCEDT4",51,0)
 S DIR("A")="Select the Service to perform this request: "
"RTN","GMRCEDT4",52,0)
 S DIR("S")="I $P(^(0),U,2)<1" ;naked reference for ^GMR(123.5
"RTN","GMRCEDT4",53,0)
 I +$G(GMRCPROC) S DIR("S")=DIR("S")_",$D(PROCSERV(+Y))"
"RTN","GMRCEDT4",54,0)
 S DIR("??")="^D LISTALL^GMRCASV"
"RTN","GMRCEDT4",55,0)
 D ^DIR I $D(DUOUT)!($D(DTOUT)) Q
"RTN","GMRCEDT4",56,0)
 I Y<1!(+Y=+GMRCSS) W !,$$NOCHG,! Q
"RTN","GMRCEDT4",57,0)
 S GMRCEDT(1)=Y,GMRCSS=Y
"RTN","GMRCEDT4",58,0)
 Q
"RTN","GMRCEDT4",59,0)
1 ;edit Procedure
"RTN","GMRCEDT4",60,0)
 W !,$C(7),"The procedure associated with a request may not be changed."
"RTN","GMRCEDT4",61,0)
 W !,"Place a new request if a different procedure is desired"
"RTN","GMRCEDT4",62,0)
 H 2
"RTN","GMRCEDT4",63,0)
 Q
"RTN","GMRCEDT4",64,0)
2       ;edit service rendered
"RTN","GMRCEDT4",65,0)
 N DIR,X,Y,GMRCURSV,GMRCPLSV,GMRCED4,GMRCED5,RENDED
"RTN","GMRCEDT4",66,0)
 S DIR(0)="S:A^I:Inpatient;O:Outpatient",DIR("B")=$P(GMRCREND,U,2)
"RTN","GMRCEDT4",67,0)
 S DIR("A")="Service to be performed Inpatient or Outpatient: "
"RTN","GMRCEDT4",68,0)
 D ^DIR I $D(DUOUT)!($D(DTOUT)) W !,$$NOCHG,! Q
"RTN","GMRCEDT4",69,0)
 I Y'=$P(GMRCREND,U) S RENDED=Y_U_Y(0)
"RTN","GMRCEDT4",70,0)
 I '$D(RENDED) Q
"RTN","GMRCEDT4",71,0)
 I '$$VALIDUR(GMRCURG,RENDED,+$G(GMRCPROC)) D  I '$D(RENDED) Q
"RTN","GMRCEDT4",72,0)
 . N GMRCREND,CHGIO S GMRCREND=RENDED
"RTN","GMRCEDT4",73,0)
 . W $C(7),!!,"The urgency of this request is no longer valid.",!
"RTN","GMRCEDT4",74,0)
 . S GMRCURSV=GMRCURG S:$D(GMRCED(3)) GMRCED3=GMRCED(3)
"RTN","GMRCEDT4",75,0)
 . S CHGREND="" D 3
"RTN","GMRCEDT4",76,0)
 . I '$$VALIDUR(GMRCURG,RENDED,+$G(GMRCPROC)) D  Q
"RTN","GMRCEDT4",77,0)
 .. W !,$C(7),"Unable to change the way service is rendered.",!
"RTN","GMRCEDT4",78,0)
 .. K RENDED S GMRCURG=GMRCURSV S:$D(GMRCED3) GMRCED(3)=GMRCED3
"RTN","GMRCEDT4",79,0)
 I '$$VALIDPL(GMRCPL,RENDED) D  I '$D(RENDED) Q
"RTN","GMRCEDT4",80,0)
 . N GMRCREND,CHGREND S GMRCREND=RENDED
"RTN","GMRCEDT4",81,0)
 . W $C(7),!!,"The Place of Consultation is no longer valid.",!
"RTN","GMRCEDT4",82,0)
 . S GMRCPLSV=GMRCPL S:$D(GMRCED(4)) GMRCED4=GMRCED(4) S CHGREND="" D 4
"RTN","GMRCEDT4",83,0)
 . I '$$VALIDPL(GMRCPL,RENDED) D  Q
"RTN","GMRCEDT4",84,0)
 .. W !,$C(7),"Unable to change the way service is rendered.",!
"RTN","GMRCEDT4",85,0)
 .. K RENDED S GMRCPL=GMRCPLSV S:$D(GMRCED4) GMRCED(4)=GMRCED4
"RTN","GMRCEDT4",86,0)
 .. S:$D(GMRCURSV) GMRCURG=GMRCURSV
"RTN","GMRCEDT4",87,0)
 .. S:$D(GMRCED3) GMRCED(3)=GMRCED3
"RTN","GMRCEDT4",88,0)
 S (GMRCREND,GMRCED(2))=RENDED
"RTN","GMRCEDT4",89,0)
 Q
"RTN","GMRCEDT4",90,0)
3 ;edit urgency
"RTN","GMRCEDT4",91,0)
 N X,Y,XQORM
"RTN","GMRCEDT4",92,0)
 I $P(GMRCREND,U)="O" S Y=$$FIND1^DIC(101,"","QX","GMRCURGENCYM - OUTPATIENT")
"RTN","GMRCEDT4",93,0)
 I '$D(Y) D  ;inpatient
"RTN","GMRCEDT4",94,0)
 .I '$G(GMRCPROC) S Y=$$FIND1^DIC(101,"","QX","GMRCURGENCYM CSLT - INPATIENT") Q
"RTN","GMRCEDT4",95,0)
 .S Y=$$FIND1^DIC(101,"","QX","GMRCURGENCYM REQ - INPATIENT")
"RTN","GMRCEDT4",96,0)
 I 'Y W !,$C(7),"Unable to change urgency." Q
"RTN","GMRCEDT4",97,0)
 S XQORM=+Y_";ORD(101,",XQORM(0)="1A\",XQORM("A")="Urgency: "
"RTN","GMRCEDT4",98,0)
 S XQORM("^^NO")=0
"RTN","GMRCEDT4",99,0)
 S:'$D(CHGREND) XQORM("B")=$P($G(GMRCURG),U,2)
"RTN","GMRCEDT4",100,0)
 D EN^XQORM
"RTN","GMRCEDT4",101,0)
 Q:Y'>0
"RTN","GMRCEDT4",102,0)
 I $P(Y(1),U,2)'=+GMRCURG D
"RTN","GMRCEDT4",103,0)
 . S GMRCED(3)=$P(Y(1),U,2)_U_$P(Y(1),U,3),GMRCURG=GMRCED(3)
"RTN","GMRCEDT4",104,0)
 Q
"RTN","GMRCEDT4",105,0)
4 ;edit place of CSLT
"RTN","GMRCEDT4",106,0)
 N X,Y,XQORM
"RTN","GMRCEDT4",107,0)
 S Y=$$FIND1^DIC(101,,"QX","GMRCPLACEM - "_$$UP^XLFSTR($P(GMRCREND,U,2))) Q:'Y
"RTN","GMRCEDT4",108,0)
 S XQORM=Y_";ORD(101,"
"RTN","GMRCEDT4",109,0)
 S XQORM(0)="1AR\",XQORM("A")="Place of Consultation: ",XQORM("NO^^")=""
"RTN","GMRCEDT4",110,0)
 S:'$D(CHGREND) XQORM("B")=$P($G(GMRCPL),U,2)
"RTN","GMRCEDT4",111,0)
 D EN^XQORM
"RTN","GMRCEDT4",112,0)
 Q:Y'>0
"RTN","GMRCEDT4",113,0)
 I $P(Y(1),U,2)'=+GMRCPL D
"RTN","GMRCEDT4",114,0)
 . S GMRCED(4)=$P(Y(1),U,2)_U_$P(Y(1),U,3),GMRCPL=GMRCED(4)
"RTN","GMRCEDT4",115,0)
 Q
"RTN","GMRCEDT4",116,0)
5 ;edit Earliest Appr. Date wat/66
"RTN","GMRCEDT4",117,0)
 N X,Y,DIR
"RTN","GMRCEDT4",118,0)
 S DIR(0)="D^^K:Y<DT X",DIR("A")="Earliest Appropriate Date: " ;S DIR(0)="D^DT:GMRCFTDT:EX"
"RTN","GMRCEDT4",119,0)
 S DIR("?")="Enter a date greater than or equal to TODAY"
"RTN","GMRCEDT4",120,0)
 S DIR("B")=$$FMTE^XLFDT(DT)
"RTN","GMRCEDT4",121,0)
 D ^DIR I $D(DTOUT)!($D(DUOUT)) Q
"RTN","GMRCEDT4",122,0)
 S GMRCED(5)=Y_U_Y(0)
"RTN","GMRCEDT4",123,0)
 Q
"RTN","GMRCEDT4",124,0)
6 ;edit ATTN person
"RTN","GMRCEDT4",125,0)
 N X,Y,DIR
"RTN","GMRCEDT4",126,0)
 S DIR(0)="PAO^200:EQM",DIR("A")="Select ATTENTION person: "
"RTN","GMRCEDT4",127,0)
 S DIR("B")=$$GET1^DIQ(200,+$P(^GMR(123,+GMRCO,0),U,11),.01)
"RTN","GMRCEDT4",128,0)
 S:$D(GMRCED(6)) DIR("B")=$P($G(GMRCED(6)),U,2)
"RTN","GMRCEDT4",129,0)
 K:'$L(DIR("B")) DIR("B")
"RTN","GMRCEDT4",130,0)
 D ^DIR I $D(DTOUT)!($D(DUOUT)) Q
"RTN","GMRCEDT4",131,0)
 I $G(DIR("B"))=$P(Y,U,2) Q
"RTN","GMRCEDT4",132,0)
 S GMRCED(6)=$S(Y=-1:"",1:Y)
"RTN","GMRCEDT4",133,0)
 I GMRCED(6)="" W !,?5,"<DELETED>",!
"RTN","GMRCEDT4",134,0)
 Q
"RTN","GMRCEDT4",135,0)
7 ;edit prov. DX
"RTN","GMRCEDT4",136,0)
 N X,Y,DIC,DIR,PRMPT
"RTN","GMRCEDT4",137,0)
 S PRMPT=$$PROVDX^GMRCUTL1(+$P(^GMR(123,+GMRCO,0),U,5))
"RTN","GMRCEDT4",138,0)
 I $P(PRMPT,U,2)="F" D
"RTN","GMRCEDT4",139,0)
 . S DIR(0)="FA^2:245",DIR("A")="Provisional Diagnosis: "
"RTN","GMRCEDT4",140,0)
 . I $P(PRMPT,U)'="R" S $P(DIR(0),U)="FAO"
"RTN","GMRCEDT4",141,0)
 . S:$D(GMRCED(7)) DIR("B")=$P(GMRCED(7),U)
"RTN","GMRCEDT4",142,0)
 . I '$D(DIR("B")) S DIR("B")=$G(^GMR(123,+GMRCO,30))
"RTN","GMRCEDT4",143,0)
 . K:'$L(DIR("B")) DIR("B")
"RTN","GMRCEDT4",144,0)
 . D ^DIR Q:$D(DTOUT)!($D(DUOUT))  Q:Y=$G(DIR("B"))
"RTN","GMRCEDT4",145,0)
 . I '$L(Y) W !,?5,"<DELETED>",!
"RTN","GMRCEDT4",146,0)
 . S GMRCED(7)=Y
"RTN","GMRCEDT4",147,0)
 I $P(PRMPT,U,2)="L" D
"RTN","GMRCEDT4",148,0)
 . N DIR,X,Y,DTOUT,DUOUT,VAL
"RTN","GMRCEDT4",149,0)
 . I $D(GMRCED(7)) D
"RTN","GMRCEDT4",150,0)
 .. I '$L($P(GMRCED(7),U,2)) S DIR("B")=$P(GMRCED(7),U) Q
"RTN","GMRCEDT4",151,0)
 .. S DIR("B")=$P(GMRCED(7),U)_" ("_$P(GMRCED(7),U,2)_")"
"RTN","GMRCEDT4",152,0)
 . I '$D(DIR("B")) S DIR("B")=$G(^GMR(123,GMRCO,30))
"RTN","GMRCEDT4",153,0)
 . K:'$L(DIR("B")) DIR("B")
"RTN","GMRCEDT4",154,0)
 . S DIR("?")="Enter a code or term for the provisional diagnosis."
"RTN","GMRCEDT4",155,0)
 . S DIR("A")="Provisional Diagnosis: "
"RTN","GMRCEDT4",156,0)
 . S DIR(0)="FA"_$S($P(PRMPT,U)'="R":"O",1:"")_"^1:245"
"RTN","GMRCEDT4",157,0)
 . D ^DIR
"RTN","GMRCEDT4",158,0)
 . I $D(DTOUT)!($D(DUOUT)) Q
"RTN","GMRCEDT4",159,0)
 . I '$L(Y) W !,?5,"<DELETED>",! S GMRCED(7)="" Q
"RTN","GMRCEDT4",160,0)
 . I Y=$G(DIR("B")) Q
"RTN","GMRCEDT4",161,0)
 . I $E(Y,1)=" " W !,"Leading space not allowed, no change." Q
"RTN","GMRCEDT4",162,0)
 . S VAL=$$LEXLKUP(Y)
"RTN","GMRCEDT4",163,0)
 . I '$L(VAL),$P(PRMPT,U)="R" W !,"Prov. DX required. No change." Q
"RTN","GMRCEDT4",164,0)
 . I VAL=$G(^GMR(123,GMRCO,30)) W !,"No change." Q
"RTN","GMRCEDT4",165,0)
 . I ($P(VAL,U)_" ("_$P(VAL,U,2)_")")=$G(^GMR(123,GMRCO,30)) D  Q
"RTN","GMRCEDT4",166,0)
 .. W !,"No change."
"RTN","GMRCEDT4",167,0)
 . I '$L(VAL) W !,?5,"<DELETED>",!
"RTN","GMRCEDT4",168,0)
 . S GMRCED(7)=VAL
"RTN","GMRCEDT4",169,0)
 Q
"RTN","GMRCEDT4",170,0)
 ;
"RTN","GMRCEDT4",171,0)
LEXLKUP(GMRCX)  ; run input through the Lexicon
"RTN","GMRCEDT4",172,0)
 ;
"RTN","GMRCEDT4",173,0)
 N DIC,X,Y,DUOUT,DTOUT,GMRCSYS
"RTN","GMRCEDT4",174,0)
 S GMRCSYS="ICD" I DT>=$$IMPDATE^LEXU("10D") S GMRCSYS="10D"
"RTN","GMRCEDT4",175,0)
 D CONFIG^LEXSET(GMRCSYS,GMRCSYS,DT)
"RTN","GMRCEDT4",176,0)
 S DIC="^LEX(757.01,",DIC(0)="EQM",DIC("B")=GMRCX,X=GMRCX
"RTN","GMRCEDT4",177,0)
 D ^DIC
"RTN","GMRCEDT4",178,0)
 I $D(DTOUT)!($D(DUOUT))!($G(Y)<1) Q ""
"RTN","GMRCEDT4",179,0)
 Q $P(Y,U,2)_U_$S(GMRCSYS="ICD":$G(Y(1)),1:$G(Y(30)))
"RTN","GMRCEDT4",180,0)
 ;
"RTN","GMRCEDT4",181,0)
8 ;edit Reason for Request
"RTN","GMRCEDT4",182,0)
 N DIC,DIWESUB,DWLW,DWPK
"RTN","GMRCEDT4",183,0)
 I $D(^TMP("GMRCED",$J,20)) M ^TMP("GMRCEDSV",$J,20)=^TMP("GMRCED",$J,20)
"RTN","GMRCEDT4",184,0)
 I '$D(^TMP("GMRCED",$J,20)) M ^TMP("GMRCED",$J,20)=^GMR(123,+GMRCO,20)
"RTN","GMRCEDT4",185,0)
 S DIC="^TMP(""GMRCED"",$J,20,",DIWESUB="Reason for Request"
"RTN","GMRCEDT4",186,0)
 W !,"Editing Reason for Request:",!
"RTN","GMRCEDT4",187,0)
 S DWPK=1,DWLW=74 D EN^DIWE
"RTN","GMRCEDT4",188,0)
 I '$$DIFFRFR($D(^TMP("GMRCEDSV",$J,20))) D  Q
"RTN","GMRCEDT4",189,0)
 . I $D(^TMP("GMRCEDSV",$J,20)) K ^TMP("GMRCEDSV",$J,20) Q
"RTN","GMRCEDT4",190,0)
 . K ^TMP("GMRCED",$J,20)
"RTN","GMRCEDT4",191,0)
 K ^TMP("GMRCEDSV",$J,20)
"RTN","GMRCEDT4",192,0)
 I '$D(^TMP("GMRCED",$J,20))!('$O(^TMP("GMRCED",$J,20,0))) D
"RTN","GMRCEDT4",193,0)
 . N GMRCMSG
"RTN","GMRCEDT4",194,0)
 . S GMRCMSG="Unable to delete Reason for Request (REQUIRED)"
"RTN","GMRCEDT4",195,0)
 . D EXAC^GMRCADC(GMRCMSG)
"RTN","GMRCEDT4",196,0)
 . K ^TMP("GMRCED",$J,20)
"RTN","GMRCEDT4",197,0)
 Q
"RTN","GMRCEDT4",198,0)
9 ;add comment
"RTN","GMRCEDT4",199,0)
 N DIC,DIWEPSE,DIWESUB,DWLW,DWPK
"RTN","GMRCEDT4",200,0)
 I $D(^TMP("GMRCED",$J,40)) D
"RTN","GMRCEDT4",201,0)
 . W !,"An unsaved comment exists. You may edit this comment.",!
"RTN","GMRCEDT4",202,0)
 . S DIWEPSE=1
"RTN","GMRCEDT4",203,0)
 S DIC="^TMP(""GMRCED"",$J,40,",DIWESUB="New Comment"
"RTN","GMRCEDT4",204,0)
 W !,"Adding new comment:",!
"RTN","GMRCEDT4",205,0)
 S DWPK=1,DWLW=74 D EN^DIWE
"RTN","GMRCEDT4",206,0)
 I '$O(^TMP("GMRCED",$J,40,0)) K ^TMP("GMRCED",$J,40)
"RTN","GMRCEDT4",207,0)
 Q
"RTN","GMRCEDT4",208,0)
DIFFRFR(SAVED) ;edited reason for req same as original?
"RTN","GMRCEDT4",209,0)
 N I,DIFF
"RTN","GMRCEDT4",210,0)
 I SAVED,$P($G(^TMP("GMRCED",$J,20,0)),U,3,4)'=$P($G(^TMP("GMRCEDSV",$J,20,0)),U,3,4) S DIFF=1 Q 1
"RTN","GMRCEDT4",211,0)
 I 'SAVED,$P($G(^TMP("GMRCED",$J,20,0)),U,3,4)'=$P($G(^GMR(123,+GMRCO,20,0)),U,3,4) S DIFF=1 Q 1
"RTN","GMRCEDT4",212,0)
 I SAVED S I=0 F  S I=$O(^TMP("GMRCED",$J,20,I)) Q:'I!($D(DIFF))  D
"RTN","GMRCEDT4",213,0)
 . I ^TMP("GMRCED",$J,20,I,0)=$G(^TMP("GMRCEDSV",$J,20,I,0)) Q
"RTN","GMRCEDT4",214,0)
 . S DIFF=1
"RTN","GMRCEDT4",215,0)
 . Q
"RTN","GMRCEDT4",216,0)
 I 'SAVED S I=0 F  S I=$O(^TMP("GMRCED",$J,20,I)) Q:'I!($D(DIFF))  D
"RTN","GMRCEDT4",217,0)
 . I ^TMP("GMRCED",$J,20,I,0)'=$G(^GMR(123,+GMRCO,20,I,0)) S DIFF=1
"RTN","GMRCEDT4",218,0)
 . Q
"RTN","GMRCEDT4",219,0)
 Q $G(DIFF)
"RTN","GMRCEDT4",220,0)
VALIDPL(PL,REND) ; place still valid?
"RTN","GMRCEDT4",221,0)
 N PLMENU
"RTN","GMRCEDT4",222,0)
 S PLMENU=$S($P(REND,U)="I":"IN",1:"OUT")
"RTN","GMRCEDT4",223,0)
 S PLMENU="GMRCPLACEM - "_PLMENU_"PATIENT"
"RTN","GMRCEDT4",224,0)
 S PLMENU=$$FIND1^DIC(101,,"QX",PLMENU) Q:PLMENU'>1 0
"RTN","GMRCEDT4",225,0)
 Q $D(^ORD(101,PLMENU,10,"B",+PL))
"RTN","GMRCEDT4",226,0)
VALIDUR(URG,REND,PROC) ;urgency still valid?
"RTN","GMRCEDT4",227,0)
 N URMENU
"RTN","GMRCEDT4",228,0)
 I $P(REND,U)="I" D
"RTN","GMRCEDT4",229,0)
 .I 'PROC S URMENU="GMRCURGENCYM CSLT - INPATIENT" Q
"RTN","GMRCEDT4",230,0)
 .S URMENU="GMRCURGENCYM REQ - INPATIENT" Q
"RTN","GMRCEDT4",231,0)
 I '$D(URMENU) S URMENU="GMRCURGENCYM - OUTPATIENT"
"RTN","GMRCEDT4",232,0)
 S URMENU=$$FIND1^DIC(101,,"QX",URMENU) Q:URMENU<0 0
"RTN","GMRCEDT4",233,0)
 Q $D(^ORD(101,URMENU,10,"B",+URG))
"RTN","GMRCEDT4",234,0)
 Q
"RTN","GMRCEDT4",235,0)
NOCHG() ;no changes made
"RTN","GMRCEDT4",236,0)
 Q "No Changes made!"
"RTN","GMRCEDT4",237,0)
PDOK(GMRCDA) ;check validity of Prov. DX code for active status
"RTN","GMRCEDT4",238,0)
 N MSG,GMRCCPTR,GMRCCSYS,GMRCCODE
"RTN","GMRCEDT4",239,0)
 I '$L($G(^GMR(123,GMRCDA,30.1))) Q 1
"RTN","GMRCEDT4",240,0)
 S GMRCCODE=$P($G(^GMR(123,+GMRCO,30.1)),"^",1)
"RTN","GMRCEDT4",241,0)
 S GMRCCSYS=$P($G(^GMR(123,+GMRCO,30.1)),"^",3)
"RTN","GMRCEDT4",242,0)
 S GMRCCPTR=$S(GMRCCSYS="ICD":1,1:30)
"RTN","GMRCEDT4",243,0)
 I +$$STATCHK^ICDXCODE(GMRCCPTR,GMRCCODE,DT) Q 1 ;code still active
"RTN","GMRCEDT4",244,0)
 S MSG="The provisional DX code must be edited before this request"
"RTN","GMRCEDT4",245,0)
 S MSG=MSG_" may be resubmitted."
"RTN","GMRCEDT4",246,0)
 D EN^DDIOL(MSG,,"!!")
"RTN","GMRCEDT4",247,0)
 Q 0
"RTN","GMRCGUIC")
0^4^B69004877
"RTN","GMRCGUIC",1,0)
GMRCGUIC ;SLC/DCM,JFR - GUI actions for editing consults; 3/13/03 12:21 ;03/25/14  08:51
"RTN","GMRCGUIC",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,12,20,15,22,33,66,73**;DEC 27, 1997;Build 22
"RTN","GMRCGUIC",3,0)
 ;
"RTN","GMRCGUIC",4,0)
 ; This routine invokes IA #2698 (ORD(101.42)), #872(ORD(101)), #2713 (ORB3F1), #5699 (ICXCODE), #2051 (FIND1^DIC)
"RTN","GMRCGUIC",5,0)
 ;                         #2053 (DIE), #2056 (GET1^DIQ), #2690 (ORB3FUP1), #5679 (LEXU), #10103 (XLFDT), #10104 (XLFSTR)
"RTN","GMRCGUIC",6,0)
 ;
"RTN","GMRCGUIC",7,0)
RFQ(GMRCO,MSG,ND,NOW) ;File Reason For Request field 20
"RTN","GMRCGUIC",8,0)
 N GMRCND,GMRCNT
"RTN","GMRCGUIC",9,0)
 S GMRCND=$O(^GMR(123,GMRCO,20,0)) I GMRCND="" S GMRCFLD(20)="Reason For Request: No Previous Value^20" Q
"RTN","GMRCGUIC",10,0)
 M ^TMP("GMRCFLD20",$J,20)=^GMR(123,GMRCO,20)
"RTN","GMRCGUIC",11,0)
 S GMRCFLD(20)=$NAME(^TMP("GMRCFLD20",$J,20))
"RTN","GMRCGUIC",12,0)
 K ^GMR(123,GMRCO,20)
"RTN","GMRCGUIC",13,0)
 S ^GMR(123,GMRCO,20,0)="^^^^"_DT_"^"
"RTN","GMRCGUIC",14,0)
 S GMRCND="",GMRCNT=1 F  S GMRCND=$O(@MSG@(ND,GMRCND)) Q:GMRCND=""  S ^GMR(123,GMRCO,20,GMRCNT,0)=@MSG@(ND,GMRCND),GMRCNT=GMRCNT+1
"RTN","GMRCGUIC",15,0)
 S $P(^GMR(123,GMRCO,20,0),"^",3)=GMRCNT-1,$P(^(0),"^",4)=GMRCNT-1
"RTN","GMRCGUIC",16,0)
 Q
"RTN","GMRCGUIC",17,0)
FILE(GMRCO,MSG,GMRCLM) ;File Edit changes
"RTN","GMRCGUIC",18,0)
 ;GMRCO=Record IEN,  GMRCCOM=Comment Array
"RTN","GMRCGUIC",19,0)
 ;MSG=^TMP global where the data resides, i.e., MSG="^TMP(""GMRCR"",$J)"
"RTN","GMRCGUIC",20,0)
 ;    Data is stored in subscripted nodes: ^TMP("GMRCR",$J,1)="GMRCSS^2"
"RTN","GMRCGUIC",21,0)
 ;    Word processing data is stored in second subscripted node:
"RTN","GMRCGUIC",22,0)
 ;    ^TMP("GMRCR",$J,9,1)="This is word processing data."
"RTN","GMRCGUIC",23,0)
 ;GMRCSS=To Service     GMRCPROC=procedure/Request Type
"RTN","GMRCGUIC",24,0)
 ;GMRCURG=Urgency       GMRCPL=Place Of Consultation
"RTN","GMRCGUIC",25,0)
 ;GMRCATN=Attention To  GMRCINO=Service is In/Out Patient
"RTN","GMRCGUIC",26,0)
 ;GMRCDIAG=Provisional Diagnosis  .GMRCRFQ=Reason For Request array
"RTN","GMRCGUIC",27,0)
 ;GMRCREQ=Procedure or Request; i.e., GMRCRQT=1727=^ORD(101,1727,0)='Procedure';GMRCRQT=1296=^ORD(101,1296,0)='Consult'
"RTN","GMRCGUIC",28,0)
 ;GMRCITM=Item ordered for field .1 (stored in ^GMR(123,GMRCO,1.11,
"RTN","GMRCGUIC",29,0)
 ;GMRCLM=coming from List Manager instead of the GUI
"RTN","GMRCGUIC",30,0)
 ;GMRCERDT=Earliest Appropriate Date WAT/66
"RTN","GMRCGUIC",31,0)
 ;GMRCCSYS=coding system for provsional dx GMRCDXDT=Date of provisional dx   GMRCLABL=label applied to dx code for display purposes e.g. "ICD-9-CM"
"RTN","GMRCGUIC",32,0)
 ;
"RTN","GMRCGUIC",33,0)
 I '$D(GMRCO)!('+GMRCO) Q
"RTN","GMRCGUIC",34,0)
 N GMRCSS,GMRCPROC,GMRCURG,GMRCPL,GMRCATN,GMRCRQT
"RTN","GMRCGUIC",35,0)
 N GMRCION,GMRCDIAG,GMRCDXCD,GMRCACTN,GMRCERDT,GMRCCSYS,GMRCDXDT,GMRCLABL,CODINTXT
"RTN","GMRCGUIC",36,0)
 S GMRCDT=$$NOW^XLFDT
"RTN","GMRCGUIC",37,0)
 S GMRCMSG="",GMRCNOD=0
"RTN","GMRCGUIC",38,0)
 F  S GMRCNOD=$O(@MSG@(GMRCNOD)) Q:GMRCNOD=""  S GMRCMSG=@MSG@(GMRCNOD) D
"RTN","GMRCGUIC",39,0)
 .I $P(GMRCMSG,"^",1)="COMMENT" D COMMENT^GMRCGUIU(GMRCO,MSG,GMRCNOD,$P(GMRCMSG,"^",2)) Q
"RTN","GMRCGUIC",40,0)
 .I $P(GMRCMSG,"^",1)="GMRCRFQ" D RFQ(GMRCO,MSG,GMRCNOD,GMRCDT) Q
"RTN","GMRCGUIC",41,0)
 .I $P(GMRCMSG,"^",1)="GMRCSS" S GMRCSS=$P(GMRCMSG,"^",2),GMRCFLD(1)=$P(^GMR(123.5,$P(^GMR(123,GMRCO,0),"^",5),0),"^",1)_"^1" Q
"RTN","GMRCGUIC",42,0)
 .I $P(GMRCMSG,"^",1)="GMRCITM" S GMRCITM=$P(GMRCMSG,"^",2),GMRCFLD(.1)=^GMR(123,GMRCO,1.11)_"^.1" Q
"RTN","GMRCGUIC",43,0)
 .I $P(GMRCMSG,"^",1)="GMRCPROC" Q  ;S GMRCFLD(4)=+$P(^GMR(123,+GMRCO,0),"^",8)_"^4" D  Q ;ignore procedure, can't be changed currently
"RTN","GMRCGUIC",44,0)
 .; ..S GMRCPROC=$P(GMRCMSG,"^",2) I $L($P(^GMR(123,GMRCO,0),"^",8)),$P(GMRCMSG,"^",2)="" S GMRCPROC="DELETE"
"RTN","GMRCGUIC",45,0)
 .I $P(GMRCMSG,"^",1)="GMRCURG" S GMRCURG=$P(GMRCMSG,"^",2),GMRCFLD(5)=$S(+$P(^GMR(123,+GMRCO,0),"^",9):$P(^ORD(101,+$P(^GMR(123,+GMRCO,0),"^",9),0),"^",2),1:"")_"^"_$P(^GMR(123,+GMRCO,0),"^",9) Q
"RTN","GMRCGUIC",46,0)
 .I $P(GMRCMSG,"^",1)="GMRCPL" D  Q
"RTN","GMRCGUIC",47,0)
 ..S GMRCPL=$P(GMRCMSG,"^",2) I '+GMRCPL D
"RTN","GMRCGUIC",48,0)
 ...S GMRCPL="GMRCPLACE - "_$S(GMRCPL="C":"ON CALL",GMRCPL="B":"BEDSIDE",GMRCPL="E":"EMERGENCY ROOM",1:GMRCPL),GMRCPL=$O(^ORD(101,"B",GMRCPL,0))
"RTN","GMRCGUIC",49,0)
 ..S GMRCFLD(6)=$S(+$P(^GMR(123,+GMRCO,0),"^",10):$P($P(^ORD(101,+$P(^GMR(123,+GMRCO,0),"^",10),0),"^",1)," - ",2),1:"")_"^6"
"RTN","GMRCGUIC",50,0)
 ..Q
"RTN","GMRCGUIC",51,0)
 .I $P(GMRCMSG,"^",1)="GMRCATN" S GMRCATN=$P(GMRCMSG,"^",2),GMRCFLD(7)=$S(+$P(^GMR(123,+GMRCO,0),"^",11):$$GET1^DIQ(200,+$P(^GMR(123,+GMRCO,0),"^",11),.01),1:"")_"^7" Q
"RTN","GMRCGUIC",52,0)
 .I $P(GMRCMSG,"^",1)="GMRCREQ" S GMRCREQ=$P(GMRCMSG,"^",2),GMRCFLD(13)=$S($P(^GMR(123,+GMRCO,0),"^",17)="P":"Procedure",1:"Consult")_"^13" Q
"RTN","GMRCGUIC",53,0)
 .I $P(GMRCMSG,"^",1)="GMRCION" S GMRCION=$P(GMRCMSG,"^",2),GMRCFLD(14)=$S($P(^GMR(123,+GMRCO,0),"^",18)="I":"Inpatient",$P(^(0),"^",18)="O":"Outpatient",1:"")_"^14" Q
"RTN","GMRCGUIC",54,0)
 .I $P(GMRCMSG,"^",1)="GMRCERDT" S GMRCERDT=$P(GMRCMSG,"^",2),GMRCFLD(17)=$S(+$P(^GMR(123,+GMRCO,0),"^",24)>0:$$FMTE^XLFDT($P(^GMR(123,+GMRCO,0),"^",24)),1:"")_"^17" Q
"RTN","GMRCGUIC",55,0)
 .I $P(GMRCMSG,"^",1)="GMRCDIAG" D  Q
"RTN","GMRCGUIC",56,0)
 ..S GMRCDIAG=$P(GMRCMSG,"^",2)
"RTN","GMRCGUIC",57,0)
 ..S GMRCFLD(30)=$G(^GMR(123,+GMRCO,30))_"^30"
"RTN","GMRCGUIC",58,0)
 ..I $P(GMRCFLD(30),U)="" S $P(GMRCFLD(30),U)="No Previous Value"
"RTN","GMRCGUIC",59,0)
 ..I $L($P(GMRCMSG,U,3)) D
"RTN","GMRCGUIC",60,0)
 ...S GMRCDXCD=$P(GMRCMSG,"^",3)
"RTN","GMRCGUIC",61,0)
 ...S GMRCCSYS="ICD" I GMRCDT>=$$IMPDATE^LEXU("10D") S GMRCCSYS="10D"
"RTN","GMRCGUIC",62,0)
 ...S GMRCLABL=$P($G(^GMR(123,+GMRCO,30.1)),U,3)
"RTN","GMRCGUIC",63,0)
 ...S GMRCLABL=$S($G(GMRCLABL)="ICD":"ICD-9-CM",$G(GMRCLABL)="10D":"ICD-10-CM",1:"")
"RTN","GMRCGUIC",64,0)
 ...S GMRCFLD(30.1)=$P($G(^GMR(123,+GMRCO,30.1)),U)_"("_$G(GMRCLABL)_")"_"^30.1"
"RTN","GMRCGUIC",65,0)
 ...S GMRCDXDT=$P($G(^GMR(123,+GMRCO,30.1)),U,2)
"RTN","GMRCGUIC",66,0)
 ...S:$G(GMRCDXDT)="" GMRCFLD(30.2)="No Previous Value"_"^30.2"
"RTN","GMRCGUIC",67,0)
 ...S:DT>+$G(GMRCDXDT) GMRCFLD(30.2)=$$FMTE^XLFDT(GMRCDXDT,"D")_"^30.2"
"RTN","GMRCGUIC",68,0)
 ...I GMRCCSYS'=$P($G(^GMR(123,+GMRCO,30.1)),U,3) S GMRCFLD(30.3)=$S($P($G(^GMR(123,+GMRCO,30.1)),U,3)="ICD":"ICD-9-CM",$P($G(^GMR(123,+GMRCO,30.1)),U,3)="10D":"ICD-10-CM",1:"")_"^30.3"
"RTN","GMRCGUIC",69,0)
 ..I $G(GMRCDXCD)'="" S CODINTXT="("_GMRCDXCD_")" D
"RTN","GMRCGUIC",70,0)
 ... I GMRCDIAG[CODINTXT S GMRCDIAG=$E(GMRCDIAG,0,($L(GMRCDIAG)-$L(CODINTXT))) S GMRCDIAG=$$TRIM^XLFSTR(GMRCDIAG,"R")
"RTN","GMRCGUIC",71,0)
 .Q
"RTN","GMRCGUIC",72,0)
 S:'$D(GMRCLM) GMRCGUIF=1
"RTN","GMRCGUIC",73,0)
 S GMRCACTN=$$EN^GMRCEDT3(GMRCO)
"RTN","GMRCGUIC",74,0)
 S DR=$$SETDA^GMRCGUIU($G(GMRCSS),$G(GMRCPROC),$G(GMRCURG),$G(GMRCPL),$G(GMRCATN),$G(GMRCRQT),$G(GMRCION),$G(GMRCERDT),$G(GMRCDIAG),$G(GMRCDXCD)) I $L(DR) D
"RTN","GMRCGUIC",75,0)
 .S DIE="^GMR(123,",DA=GMRCO
"RTN","GMRCGUIC",76,0)
 .L +^GMR(123,GMRCO):$S($G(DILOCKTM)>0:DILOCKTM,1:5) ;WAT/66 added timeout
"RTN","GMRCGUIC",77,0)
 .D ^DIE
"RTN","GMRCGUIC",78,0)
 .S DR="8////^S X=5;9////^S X=11"
"RTN","GMRCGUIC",79,0)
 .D ^DIE
"RTN","GMRCGUIC",80,0)
 .L -^GMR(123,GMRCO)
"RTN","GMRCGUIC",81,0)
 .K DIE,DR,DA
"RTN","GMRCGUIC",82,0)
 .Q
"RTN","GMRCGUIC",83,0)
 S DFN=$P(^GMR(123,+GMRCO,0),"^",2),GMRCPROV=$P(^(0),"^",14),GMRCTYPE=$P(^(0),"^",17),GMRCTRLC="XX^RESUBMIT",VISIT="",RMBED=""
"RTN","GMRCGUIC",84,0)
 D EN^GMRCHL7(DFN,+GMRCO,GMRCTYPE,RMBED,GMRCTRLC,$G(DUZ),VISIT,.GMRCOM)
"RTN","GMRCGUIC",85,0)
 S GMRCSVC=$S($G(GMRCSS):GMRCSS,1:$P(^GMR(123,+GMRCO,0),U,5))
"RTN","GMRCGUIC",86,0)
 S GMRCORTX="Resubmitted consult "_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCGUIC",87,0)
 S GMRCORTX=GMRCORTX_$S($G(GMRCURG):" ("_$P(^ORD(101,+GMRCURG,0),"^",2)_")",+$P(^GMR(123,+GMRCO,0),U,9):"( "_$P(^ORD(101,+$P(^GMR(123,+GMRCO,0),U,9),0),"^",2)_" )",1:"")
"RTN","GMRCGUIC",88,0)
 S GMRCFL=1
"RTN","GMRCGUIC",89,0)
 D MSG^GMRCP(DFN,GMRCORTX,+GMRCO,27,.GMRCADUZ,GMRCFL) ;Send notification of NEW consult
"RTN","GMRCGUIC",90,0)
 D PRNT^GMRCUTL1(+$P(^GMR(123,+GMRCO,0),U,5),+GMRCO) ;send 513 to service
"RTN","GMRCGUIC",91,0)
 ;Next line gets rid of alert
"RTN","GMRCGUIC",92,0)
 I $D(XQAID),$L(XQAID) D
"RTN","GMRCGUIC",93,0)
 . N GMRCCORY
"RTN","GMRCGUIC",94,0)
 . S XQAKILL=$$XQAKILL^ORB3F1 D DEL^ORB3FUP1(.GMRCCORY,XQAID)
"RTN","GMRCGUIC",95,0)
 I $P($G(^GMR(123,+GMRCO,12)),U,5)="P" D
"RTN","GMRCGUIC",96,0)
 . D TRIGR^GMRCIEVT(GMRCO,GMRCACTN)
"RTN","GMRCGUIC",97,0)
 D GUIC^GMRCGUIU
"RTN","GMRCGUIC",98,0)
 Q
"RTN","GMRCGUIC",99,0)
SEND(GMRCO,GLOBAL) ;Get data fields to send to GUI for editing consult
"RTN","GMRCGUIC",100,0)
 ;GMRCO=record being edited GLOBAL=Global Referece, i.e., "^TMP("GMRCR",$J)"
"RTN","GMRCGUIC",101,0)
 K @GLOBAL
"RTN","GMRCGUIC",102,0)
 N ND,GMRCSX,TYPE,NDX,GMRCCPTR,GMRCCSYS,GMRCCODE,CODINTXT
"RTN","GMRCGUIC",103,0)
 S ND=1,GMRCSX=""
"RTN","GMRCGUIC",104,0)
 I '$D(GMRCO)!('+GMRCO) Q
"RTN","GMRCGUIC",105,0)
 S GMRC(0)=$G(^GMR(123,+GMRCO,0)) Q:'$L(GMRC(0))
"RTN","GMRCGUIC",106,0)
 S GMRCSS=$P(GMRC(0),"^",5),GMRCPROC=$P(GMRC(0),"^",8)
"RTN","GMRCGUIC",107,0)
 S GMRCURG=$P(GMRC(0),"^",9),GMRCPL=$P(GMRC(0),"^",10)
"RTN","GMRCGUIC",108,0)
 S GMRCATN=$P(GMRC(0),"^",11),GMRCINO=$P(GMRC(0),"^",18)
"RTN","GMRCGUIC",109,0)
 S GMRCREQ=$P(GMRC(0),"^",17),GMRCERDT=$P(GMRC(0),"^",24)
"RTN","GMRCGUIC",110,0)
 S GMRCDIAG=$G(^GMR(123,+GMRCO,30)) I $L($G(^(30.1))) D
"RTN","GMRCGUIC",111,0)
 . S GMRCCODE=$P($G(^GMR(123,+GMRCO,30.1)),"^",1)
"RTN","GMRCGUIC",112,0)
 . S GMRCCSYS=$P($G(^GMR(123,+GMRCO,30.1)),"^",3)
"RTN","GMRCGUIC",113,0)
 . S GMRCCPTR=$S(GMRCCSYS="ICD":1,1:30)
"RTN","GMRCGUIC",114,0)
 . I $G(GMRCCODE)'="" D  ;users expect to see prov dx text and dx code in edit/resubmit dialog
"RTN","GMRCGUIC",115,0)
 .. S CODINTXT=" ("_GMRCCODE_")"
"RTN","GMRCGUIC",116,0)
 .. Q:GMRCDIAG[CODINTXT
"RTN","GMRCGUIC",117,0)
 .. S GMRCDIAG=GMRCDIAG_CODINTXT
"RTN","GMRCGUIC",118,0)
 . S GMRCDIAG=GMRCDIAG_U_$G(GMRCCODE)
"RTN","GMRCGUIC",119,0)
 . I '$$STATCHK^ICDXCODE(GMRCCPTR,GMRCCODE,DT) S GMRCDIAG=GMRCDIAG_U_1
"RTN","GMRCGUIC",120,0)
 S GMRCPROV=$S($P(^GMR(123,+GMRCO,0),U,14):$$GET1^DIQ(200,+$P(^(0),U,14),.01),1:"")
"RTN","GMRCGUIC",121,0)
 S @GLOBAL@(ND,0)="~SERVICE",ND=ND+1
"RTN","GMRCGUIC",122,0)
 I +GMRCSS S GMRCSX=$P(^GMR(123.5,GMRCSS,0),"^",1),@GLOBAL@(ND,0)="d"_GMRCSX_"^"_GMRCSS_"^",ND=ND+1,GMRCSX=""
"RTN","GMRCGUIC",123,0)
 E  S @GLOBAL@(ND,0)="d"_"^^",ND=ND+1
"RTN","GMRCGUIC",124,0)
 S @GLOBAL@(ND,0)="~PROCEDURE",ND=ND+1
"RTN","GMRCGUIC",125,0)
 I $L(GMRCPROC),+GMRCPROC D
"RTN","GMRCGUIC",126,0)
 .S GMRCSX=$$UP^XLFSTR($$GET1^DIQ(123.3,+GMRCPROC,.01))
"RTN","GMRCGUIC",127,0)
 .S GMRCSY=$$FIND1^DIC(101.43,,"QX",+GMRCPROC_";99PRC","ID")
"RTN","GMRCGUIC",128,0)
 .I +GMRCSY D
"RTN","GMRCGUIC",129,0)
 ..S @GLOBAL@(ND,0)="d"_GMRCSY_"^"_GMRCSX,ND=ND+1
"RTN","GMRCGUIC",130,0)
 ..Q
"RTN","GMRCGUIC",131,0)
 E  S @GLOBAL@(ND,0)="d^^"
"RTN","GMRCGUIC",132,0)
 S @GLOBAL@(ND,0)="~TYPE",ND=ND+1
"RTN","GMRCGUIC",133,0)
 I $L(GMRCREQ) D  I '$L(GMRCREQ) S @GLOBAL@(ND,0)="d^^"
"RTN","GMRCGUIC",134,0)
 . S GMRCSX=$S(GMRCREQ="P":"PROCEDURE",1:"CONSULT")
"RTN","GMRCGUIC",135,0)
 . S @GLOBAL@(ND,0)="d"_$E(GMRCSX,1)_"^"_GMRCSX_"^"_GMRCREQ
"RTN","GMRCGUIC",136,0)
 . S GMRCSX=""
"RTN","GMRCGUIC",137,0)
 S ND=ND+1
"RTN","GMRCGUIC",138,0)
 S @GLOBAL@(ND,0)="~CATEGORY",ND=ND+1
"RTN","GMRCGUIC",139,0)
 I $L(GMRCINO) D  S ND=ND+1,GMRCSX=""
"RTN","GMRCGUIC",140,0)
 .S @GLOBAL@(ND,0)="d"_GMRCINO_"^"_$S(GMRCINO="I":"INPATIENT",1:"OUTPATIENT")_"^"
"RTN","GMRCGUIC",141,0)
 .S @GLOBAL@(ND,0)=@GLOBAL@(ND,0)_$S(GMRCINO="I":$O(^ORD(101,"B","GMRCURGENCYM CSLT - INPATIENT",0)),1:$O(^ORD(101,"B","GMRCURGENCYM - OUTPATIENT",0)))
"RTN","GMRCGUIC",142,0)
 .Q
"RTN","GMRCGUIC",143,0)
 E  S @GLOBAL@(ND,0)="d^^"
"RTN","GMRCGUIC",144,0)
 S @GLOBAL@(ND,0)="~DIAGNOSIS",ND=ND+1
"RTN","GMRCGUIC",145,0)
 I $L(GMRCDIAG) S @GLOBAL@(ND,0)="d"_GMRCDIAG,ND=ND+1
"RTN","GMRCGUIC",146,0)
 E  S @GLOBAL@(ND,0)="d"
"RTN","GMRCGUIC",147,0)
 S @GLOBAL@(ND,0)="~PLACE",ND=ND+1
"RTN","GMRCGUIC",148,0)
 I +GMRCPL D  S ND=ND+1,GMRCSX=""
"RTN","GMRCGUIC",149,0)
 .S GMRCSX=$P($P(^ORD(101,GMRCPL,0),"^",1),"GMRCPLACE - ",2),GMRCSX=$S(GMRCSX="ON CALL":"CONSULTANTS CHOICE",1:GMRCSX),@GLOBAL@(ND,0)="d"_$E(GMRCSX,1)_"^"_GMRCSX_"^"_GMRCPL
"RTN","GMRCGUIC",150,0)
 .Q
"RTN","GMRCGUIC",151,0)
 E  S @GLOBAL@(ND,0)="d^^",ND=ND+1
"RTN","GMRCGUIC",152,0)
 S @GLOBAL@(ND,0)="~ATTENTION",ND=ND+1
"RTN","GMRCGUIC",153,0)
 I +GMRCATN S GMRCSX=$$GET1^DIQ(200,GMRCATN,.01),@GLOBAL@(ND,0)="d"_GMRCATN_"^"_GMRCSX_"^"_GMRCATN,ND=ND+1,GMRCSX=""
"RTN","GMRCGUIC",154,0)
 E  S @GLOBAL@(ND,0)="d^^",ND=ND+1
"RTN","GMRCGUIC",155,0)
 S @GLOBAL@(ND,0)="~EARLIEST",ND=ND+1 ;WAT/66
"RTN","GMRCGUIC",156,0)
 I GMRCERDT S @GLOBAL@(ND,0)="d"_"^"_GMRCERDT,ND=ND+1 ;WAT66
"RTN","GMRCGUIC",157,0)
 E  S @GLOBAL@(ND,0)="d^" ;WAT
"RTN","GMRCGUIC",158,0)
 S @GLOBAL@(ND,0)="~URGENCY",ND=ND+1
"RTN","GMRCGUIC",159,0)
 I +GMRCURG S GMRCSX=$P($P(^ORD(101,GMRCURG,0),"^",1),"GMRCURGENCY - ",2),GMRCURGY=$O(^ORD(101.42,"S.GMRCO",GMRCSX,0)) I $L(GMRCSX) D
"RTN","GMRCGUIC",160,0)
 .S GMRCSY=$O(^ORD(101.42,"B",GMRCSX,0))
"RTN","GMRCGUIC",161,0)
 .S @GLOBAL@(ND,0)="d"_GMRCSY_"^"_GMRCSX_"^"_GMRCURG,ND=ND+1
"RTN","GMRCGUIC",162,0)
 .S GMRCSX="" K GMRCSY
"RTN","GMRCGUIC",163,0)
 .Q
"RTN","GMRCGUIC",164,0)
 E  S @GLOBAL@(ND,0)="d^^",ND=ND+1
"RTN","GMRCGUIC",165,0)
 ;Get reason for request
"RTN","GMRCGUIC",166,0)
 S @GLOBAL@(ND,0)="~REASON",ND=ND+1
"RTN","GMRCGUIC",167,0)
 I $O(^GMR(123,+GMRCO,20,0)) S NDX=0 F  S NDX=$O(^GMR(123,+GMRCO,20,NDX)) Q:NDX=""  S @GLOBAL@(ND,0)="t"_^GMR(123,+GMRCO,20,NDX,0),ND=ND+1
"RTN","GMRCGUIC",168,0)
 E  S @GLOBAL@(ND,0)="~REASON",ND=ND+1,@GLOBAL@(ND,0)="tREASON "
"RTN","GMRCGUIC",169,0)
 ;Get Comments, including Deny Comments
"RTN","GMRCGUIC",170,0)
 D SENDCOMT^GMRCGUIU(GMRCO,.ND)
"RTN","GMRCGUIC",171,0)
 D GUIC^GMRCGUIU
"RTN","GMRCGUIC",172,0)
 Q
"RTN","GMRCGUIU")
0^15^B30591724
"RTN","GMRCGUIU",1,0)
GMRCGUIU ;SLC/DCM,JFR - Utilities for CPRS GUI ;07/06/12  13:21
"RTN","GMRCGUIU",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,12,15,17,22,66,73**;DEC 27, 1997;Build 22
"RTN","GMRCGUIU",3,0)
 ;
"RTN","GMRCGUIU",4,0)
 ; This routine invokes IA #2757(EN^MCARPS2), #3042 (SINGLE^MCAPI), #3171 (START^ORWRP)
"RTN","GMRCGUIU",5,0)
 ;                         #(GET1^DIQ), #3280 (MEDLKUP^MCARUTL3), #10103 (XLFDT)
"RTN","GMRCGUIU",6,0)
 ;
"RTN","GMRCGUIU",7,0)
GUIC ;Kill variables from GMRCGUIC
"RTN","GMRCGUIU",8,0)
 K GMRC(0),GMRCA,GMRCATN,GMRCD,GMRCDD,GMRCDIAG,GMRCDT,GMRCED,GMRCEDCM
"RTN","GMRCGUIU",9,0)
 K GMRCFL,GMRCFLD,GMRCION,GMRCLNO,GMRCNATO,GMRCNT,GMRCORTX,GMRCPL
"RTN","GMRCGUIU",10,0)
 K GMRCPROC,GMRCRQT,GMRCS38,GMRCSS,GMRCSVC,GMRCTRLC,GMRCTYPE,GMRCURG
"RTN","GMRCGUIU",11,0)
 K GMRCX,LN,GMRCADUZ,ORDG,RMBED,VISIT
"RTN","GMRCGUIU",12,0)
 K GMRCITM,GMRCMSG,GMRCND1,GMRCNOD,GMRCPROV,GMRCOUNT,GMRCGUIF,GMRCREQ
"RTN","GMRCGUIU",13,0)
 K GMRCSS,GMRCPROC,GMRCURG,GMRCURGY,GMRCPL,GMRCATN,GMRCINO,GMRCREQ
"RTN","GMRCGUIU",14,0)
 K GMRCDIAG,GMRCDXCD,GMRCPROV,ND,NDX
"RTN","GMRCGUIU",15,0)
 K XQAKILL,^TMP("GMRCFLD20",$J)
"RTN","GMRCGUIU",16,0)
 Q
"RTN","GMRCGUIU",17,0)
SETDA(GMRCSS,GMRCPROC,GMRCURG,GMRCPL,GMRCATN,GMRCRQT,GMRCION,GMRCERDT,GMRCDIAG,GMRCDXCD)  ;Set DA in ^GMR(123,GMRCO,40
"RTN","GMRCGUIU",18,0)
 ;WAT/66 added earliest date
"RTN","GMRCGUIU",19,0)
 N X
"RTN","GMRCGUIU",20,0)
 S X=""
"RTN","GMRCGUIU",21,0)
 I +GMRCSS S X="1////^S X=+GMRCSS;.1///@;"
"RTN","GMRCGUIU",22,0)
 I +GMRCPROC S X=X_"4////^S X=GMRCPROC;.1///@;"
"RTN","GMRCGUIU",23,0)
 I +GMRCURG S X=X_"5////^S X=GMRCURG;"
"RTN","GMRCGUIU",24,0)
 I +GMRCPL S X=X_"6////^S X=GMRCPL;"
"RTN","GMRCGUIU",25,0)
 I +GMRCATN S X=X_"7////^S X=GMRCATN;"
"RTN","GMRCGUIU",26,0)
 I $G(GMRCATN)="@" S X=X_"7///@;"
"RTN","GMRCGUIU",27,0)
 I $L(GMRCION) S X=X_"14///^S X=GMRCION;"
"RTN","GMRCGUIU",28,0)
 I +GMRCERDT S X=X_"17///^S X=GMRCERDT;"
"RTN","GMRCGUIU",29,0)
 I $L(GMRCDIAG) D
"RTN","GMRCGUIU",30,0)
 . I GMRCDIAG="@" S X=X_"30///@;30.1///@;30.2///@;30.3///@;" Q
"RTN","GMRCGUIU",31,0)
 . S X=X_"30////^S X=GMRCDIAG;"
"RTN","GMRCGUIU",32,0)
 I $L(GMRCDXCD) D
"RTN","GMRCGUIU",33,0)
 .S X=X_"30.1////^S X=GMRCDXCD;30.2////^S X=DT;30.3////^S X=GMRCCSYS;"
"RTN","GMRCGUIU",34,0)
 I $L(X) S X=$E(X,1,$L(X)-1)
"RTN","GMRCGUIU",35,0)
 Q X
"RTN","GMRCGUIU",36,0)
 ;
"RTN","GMRCGUIU",37,0)
COMMENT(GMRCO,MSG,ND,GMRCDA)    ;File comments from GUI edits
"RTN","GMRCGUIU",38,0)
 N Y,GMRCND
"RTN","GMRCGUIU",39,0)
 S GMRCDA=$$ADDCM^GMRCEDT3(GMRCO),GMRCA=20
"RTN","GMRCGUIU",40,0)
 D AUDIT0^GMRCEDT3(GMRCDA,GMRCO)
"RTN","GMRCGUIU",41,0)
 S Y=$$FMTE^XLFDT(DT,"1D"),GMRCFLD(40)="COMMENT ADDED: "_Y_"^"_GMRCDA
"RTN","GMRCGUIU",42,0)
 S GMRCND="",GMRCNT=1 F  S GMRCND=$O(@MSG@(ND,GMRCND)) Q:GMRCND=""  S ^GMR(123,GMRCO,40,GMRCDA,1,GMRCNT,0)=@MSG@(ND,GMRCND),GMRCNT=GMRCNT+1
"RTN","GMRCGUIU",43,0)
 S ^GMR(123,GMRCO,40,GMRCDA,1,0)="^^"_(GMRCNT-1)_"^"_(GMRCNT-1)_"^"_GMRCDT_"^"
"RTN","GMRCGUIU",44,0)
 I $P($G(^GMR(123,GMRCO,12)),U,5)="P" D
"RTN","GMRCGUIU",45,0)
 . D TRIGR^GMRCIEVT(GMRCO,GMRCDA)
"RTN","GMRCGUIU",46,0)
 Q
"RTN","GMRCGUIU",47,0)
 ;
"RTN","GMRCGUIU",48,0)
SENDCOMT(GMRCO,ND1)     ;Get comments   ;wat/66 replaced ^VA(200 with $$GET1^DIQ
"RTN","GMRCGUIU",49,0)
 N NDX,NDY,CMTDT,SENDR,TYPE
"RTN","GMRCGUIU",50,0)
 S NDX=0,CMTDT="",SENDR=""
"RTN","GMRCGUIU",51,0)
 S NDX=0 F  S NDX=$O(^GMR(123,GMRCO,40,NDX)) Q:NDX?1A.E!(NDX="")  S TYPE=$P(^GMR(123,GMRCO,40,NDX,0),"^",2) I $S(TYPE=19:1,TYPE=20:1,1:0) S TYPE(TYPE,NDX)=""
"RTN","GMRCGUIU",52,0)
 I $O(TYPE(19,0)) S @GLOBAL@(ND1,0)="~DENY COMMENT",ND1=ND1+1 D
"RTN","GMRCGUIU",53,0)
 .S NDX=0 F  S NDX=$O(TYPE(19,NDX)) Q:NDX=""   D
"RTN","GMRCGUIU",54,0)
 ..S CMTDT=$$FMTE^XLFDT($P(^GMR(123,GMRCO,40,NDX,0),"^",1)),SENDR=$S($L($P(^GMR(123,GMRCO,40,NDX,0),"^",4)):$$GET1^DIQ(200,$P(^(0),"^",4),.01),1:"Missing Data")
"RTN","GMRCGUIU",55,0)
 ..S @GLOBAL@(ND1,0)="t"_"CANCELLED: "_CMTDT_" BY: "_SENDR,ND1=ND1+1,NDY=0
"RTN","GMRCGUIU",56,0)
 ..S NDY=0 F  S NDY=$O(^GMR(123,GMRCO,40,NDX,1,NDY)) Q:NDY=""  S @GLOBAL@(ND1,0)="t"_^GMR(123,GMRCO,40,NDX,1,NDY,0),ND1=ND1+1
"RTN","GMRCGUIU",57,0)
 ..S @GLOBAL@(ND1,0)="t",$P(@GLOBAL@(ND1,0),"-",81)="",ND1=ND1+1
"RTN","GMRCGUIU",58,0)
 ..Q
"RTN","GMRCGUIU",59,0)
 .Q
"RTN","GMRCGUIU",60,0)
 S NDX=0 F  S NDX=$O(TYPE(20,NDX)) Q:NDX=""  S @GLOBAL@(ND1,0)="~ADDED COMMENT",ND1=ND1+1 D
"RTN","GMRCGUIU",61,0)
 .S CMTDT=$$FMTE^XLFDT($P(^GMR(123,GMRCO,40,NDX,0),"^",1)),SENDR=$S($L($P(^GMR(123,GMRCO,40,NDX,0),"^",4)):$$GET1^DIQ(200,$P(^(0),"^",4),.01),1:"UNKNOWN")
"RTN","GMRCGUIU",62,0)
 .S @GLOBAL@(ND1,0)="t"_"COMMENT on "_CMTDT_" BY: "_SENDR,ND1=ND1+1
"RTN","GMRCGUIU",63,0)
 .S NDY=0 F  S NDY=$O(^GMR(123,GMRCO,40,NDX,1,NDY)) Q:NDY=""  S @GLOBAL@(ND,0)="t"_^GMR(123,GMRCO,40,NDX,1,NDY,0),ND1=ND1+1
"RTN","GMRCGUIU",64,0)
 .S @GLOBAL@(ND1,0)="t",$P(@GLOBAL@(ND1,0),"-",81)="",ND1=ND1+1
"RTN","GMRCGUIU",65,0)
 .Q
"RTN","GMRCGUIU",66,0)
 Q
"RTN","GMRCGUIU",67,0)
GETMED(GMRCIFN,GMRCRES) ;return available med results for proc request
"RTN","GMRCGUIU",68,0)
 ; input:
"RTN","GMRCGUIU",69,0)
 ;    GMRCIFN - ien from file 123
"RTN","GMRCGUIU",70,0)
 ;    GMRCRES - variable passed in by reference used for output
"RTN","GMRCGUIU",71,0)
 ; output:
"RTN","GMRCGUIU",72,0)
 ;     GMRCRES(x) = result_name^date^summary^result_ref
"RTN","GMRCGUIU",73,0)
 ;      example:
"RTN","GMRCGUIU",74,0)
 ;       GMRCRES(1)="19;MCAR(691.5,^EKG^JUN 30,1999@15:52^ABNORMAL"
"RTN","GMRCGUIU",75,0)
 N CNT,ROOT,PROC,S5,DFN,I
"RTN","GMRCGUIU",76,0)
 N MCARCODE,MCARDT,MCESKEY,MCKEYCAR,MCFILE
"RTN","GMRCGUIU",77,0)
 S PROC=+$P($G(^GMR(123,GMRCIFN,0)),U,8)
"RTN","GMRCGUIU",78,0)
 I 'PROC Q  ;no procedure there
"RTN","GMRCGUIU",79,0)
 S ROOT=$$GET1^DIQ(697.2,+$P(^GMR(123.3,PROC,0),U,5),1)
"RTN","GMRCGUIU",80,0)
 I '$L(ROOT) Q  ;proc not set up for med resulting
"RTN","GMRCGUIU",81,0)
 S S5=ROOT D EN^MCARPS2(+$P(^GMR(123,GMRCIFN,0),U,2))
"RTN","GMRCGUIU",82,0)
 I '$D(^TMP("OR",$J,"MCAR","OT")) Q  ;no results available
"RTN","GMRCGUIU",83,0)
 S CNT=0,I=0
"RTN","GMRCGUIU",84,0)
 F  S CNT=$O(^TMP("OR",$J,"MCAR","OT",CNT)) Q:'CNT  D
"RTN","GMRCGUIU",85,0)
 . N DATA S DATA=^TMP("OR",$J,"MCAR","OT",CNT)
"RTN","GMRCGUIU",86,0)
 . Q:$D(^GMR(123,"R",$P(DATA,U,2)_";"_ROOT_","))
"RTN","GMRCGUIU",87,0)
 . Q:$$SCRNDRFT^GMRCMED($P(DATA,U,2),$P(ROOT,"(",2))  ;screen draft rpts
"RTN","GMRCGUIU",88,0)
 . S I=I+1
"RTN","GMRCGUIU",89,0)
 . S GMRCRES(I)=$P(DATA,U,2)_";"_ROOT_","_U_$P(DATA,U)_U_$P(DATA,U,6,7)
"RTN","GMRCGUIU",90,0)
 . Q
"RTN","GMRCGUIU",91,0)
 K MCARCODE,MCARDT,MCESKEY,MCKEYCAR,MCFILE
"RTN","GMRCGUIU",92,0)
 K ^TMP("OR",$J,"MCAR")
"RTN","GMRCGUIU",93,0)
 Q
"RTN","GMRCGUIU",94,0)
GETRES(GMRCO,GMRCAR) ;return array of associated med rslts
"RTN","GMRCGUIU",95,0)
 ; DBIA #: ?
"RTN","GMRCGUIU",96,0)
 ; Input:
"RTN","GMRCGUIU",97,0)
 ;   GMRCO - ien from file 123
"RTN","GMRCGUIU",98,0)
 ;   GMRCAR - variable passed by ref to return array in
"RTN","GMRCGUIU",99,0)
 ; Output:
"RTN","GMRCGUIU",100,0)
 ;   GMRCAR(x)=result_ref^result_name^date^impression
"RTN","GMRCGUIU",101,0)
 ;    Example:
"RTN","GMRCGUIU",102,0)
 ;      GMRCAR(1)="19;MCAR(691.5,^EKG^JUN 30,1999@15:52^ABNORMAL"
"RTN","GMRCGUIU",103,0)
 N RES,CNT,DATA
"RTN","GMRCGUIU",104,0)
 S RES=0,CNT=1
"RTN","GMRCGUIU",105,0)
 F  S RES=$O(^GMR(123,GMRCO,50,RES)) Q:'RES  D
"RTN","GMRCGUIU",106,0)
 . N GMRCMCR,GMRCMCAR,RES0
"RTN","GMRCGUIU",107,0)
 . S RES0=$G(^GMR(123,GMRCO,50,RES,0))
"RTN","GMRCGUIU",108,0)
 . I RES0'["MCAR" Q
"RTN","GMRCGUIU",109,0)
 . S GMRCMCR=$$SINGLE^MCAPI(RES0)
"RTN","GMRCGUIU",110,0)
 . Q:'$L(GMRCMCR)
"RTN","GMRCGUIU",111,0)
 . D MEDLKUP^MCARUTL3(.GMRCMCAR,+$P(RES0,"MCAR(",2),+RES0)
"RTN","GMRCGUIU",112,0)
 . S GMRCAR(CNT)=^GMR(123,GMRCO,50,RES,0)_U
"RTN","GMRCGUIU",113,0)
 . S GMRCAR(CNT)=GMRCAR(CNT)_$P(GMRCMCR,U)_U_$P(GMRCMCR,U,6,7)
"RTN","GMRCGUIU",114,0)
 . I $P(GMRCMCAR,U,10) S GMRCAR(CNT)=GMRCAR(CNT)_"^1"
"RTN","GMRCGUIU",115,0)
 . S CNT=CNT+1
"RTN","GMRCGUIU",116,0)
 . Q
"RTN","GMRCGUIU",117,0)
 Q
"RTN","GMRCGUIU",118,0)
DISPMED(GMRCRES,GMRCAR) ; display a med result
"RTN","GMRCGUIU",119,0)
 ; Input:
"RTN","GMRCGUIU",120,0)
 ;  GMRCRES - med result var ptr  (e.g. "19;MCAR(691.5")
"RTN","GMRCGUIU",121,0)
 ;  GMRCAR  - array to return output from medicine API
"RTN","GMRCGUIU",122,0)
 ; Output:
"RTN","GMRCGUIU",123,0)
 ;  GMRCAR
"RTN","GMRCGUIU",124,0)
 ;    - var passed by ref or as global ref to return text of
"RTN","GMRCGUIU",125,0)
 ;      medicine pkg report
"RTN","GMRCGUIU",126,0)
 ;    Example:  GMRCAR(1)="      PROCEDURE DATE/TIME: 06/30/99 15:52"
"RTN","GMRCGUIU",127,0)
 ;              GMRCAR(2)="        CONFIDENTIAL ECG REPORT"
"RTN","GMRCGUIU",128,0)
 ;              GMRCAR(3...)=
"RTN","GMRCGUIU",129,0)
 D START^ORWRP(80,"EN^MCAPI(GMRCRES,1)")
"RTN","GMRCGUIU",130,0)
 I '$D(^TMP("ORDATA",$J,1)) D  Q
"RTN","GMRCGUIU",131,0)
 . I $D(GMRCAR) S @GMRCAR@(1)="Unable to locate result." Q
"RTN","GMRCGUIU",132,0)
 . I '$D(GMRCAR) S GMRCAR(1)="Unable to locate result."
"RTN","GMRCGUIU",133,0)
 I $D(GMRCAR) M @GMRCAR=^TMP("ORDATA",$J,1)
"RTN","GMRCGUIU",134,0)
 I '$D(GMRCAR) M GMRCAR=^TMP("ORDATA",$J,1)
"RTN","GMRCGUIU",135,0)
 K ^TMP("ORDATA",$J,1)
"RTN","GMRCGUIU",136,0)
 Q
"RTN","GMRCGUIU",137,0)
CANDOMED(GMRCIEN,USER) ;can person associate med results?
"RTN","GMRCGUIU",138,0)
 ; GMRCIEN - ien from file 123
"RTN","GMRCGUIU",139,0)
 N PROC
"RTN","GMRCGUIU",140,0)
 I '$D(^GMR(123,GMRCIEN,0)) Q 0  ;bad record
"RTN","GMRCGUIU",141,0)
 S PROC=+$P(^GMR(123,GMRCIEN,0),U,8) I 'PROC Q 0  ;no procedure
"RTN","GMRCGUIU",142,0)
 I +$G(^GMR(123,GMRCIEN,1)) Q 0  ;med rslts not allowed on CP
"RTN","GMRCGUIU",143,0)
 I '+$P(^GMR(123.3,PROC,0),U,5) Q 0  ;proc not set up
"RTN","GMRCGUIU",144,0)
 Q 1
"RTN","GMRCHL72")
0^5^B16984753
"RTN","GMRCHL72",1,0)
GMRCHL72 ;SLC/DCM - HL-7 formats OBX and NTE segments ;06/27/12  07:58
"RTN","GMRCHL72",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,15,29,73**;DEC 27, 1997;Build 22
"RTN","GMRCHL72",3,0)
 ;
"RTN","GMRCHL72",4,0)
 ; This routine invokes IA #872
"RTN","GMRCHL72",5,0)
 ;
"RTN","GMRCHL72",6,0)
 Q
"RTN","GMRCHL72",7,0)
OBX(GMRCIFN) ;Build the OBX segment of the HL-7 message
"RTN","GMRCHL72",8,0)
 ;GMRCIFN=GMRCIEN - the internal file # of the record from file 123
"RTN","GMRCHL72",9,0)
 N OBXSEGNO,GMRCND,GMRCND1,GMRCSYS
"RTN","GMRCHL72",10,0)
 S OBXSEGNO=0
"RTN","GMRCHL72",11,0)
 I ORCTRL'="RT",$D(^GMR(123,GMRCIFN,20,0)) S GMRCND=0,GMRCND1=0 D
"RTN","GMRCHL72",12,0)
 . S OBXSEGNO=OBXSEGNO+1
"RTN","GMRCHL72",13,0)
 . S GMRCND=$O(^GMR(123,GMRCIFN,20,GMRCND))
"RTN","GMRCHL72",14,0)
 . S OBX(OBXSEGNO)="OBX|"_OBXSEGNO
"RTN","GMRCHL72",15,0)
 . S OBX(OBXSEGNO)=OBX(OBXSEGNO)_"|TX|2000.02^REASON FOR REQUEST^AS4||"
"RTN","GMRCHL72",16,0)
 . S OBX(OBXSEGNO)=OBX(OBXSEGNO)_^GMR(123,GMRCIFN,20,GMRCND,0)
"RTN","GMRCHL72",17,0)
 . S GMRCND1=GMRCND1+1
"RTN","GMRCHL72",18,0)
 . F  S GMRCND=$O(^GMR(123,GMRCIFN,20,GMRCND)) Q:GMRCND=""  D
"RTN","GMRCHL72",19,0)
 .. S OBX(OBXSEGNO,GMRCND1)=^GMR(123,GMRCIFN,20,GMRCND,0)
"RTN","GMRCHL72",20,0)
 .. S GMRCND1=GMRCND1+1
"RTN","GMRCHL72",21,0)
 .Q
"RTN","GMRCHL72",22,0)
 I $D(^GMR(123,GMRCIFN,30)) S OBXSEGNO=OBXSEGNO+1 D
"RTN","GMRCHL72",23,0)
 . S OBX(OBXSEGNO)="OBX|"_OBXSEGNO
"RTN","GMRCHL72",24,0)
 . N OBXSEG
"RTN","GMRCHL72",25,0)
 . I '$D(^GMR(123,GMRCIFN,30.1)) D
"RTN","GMRCHL72",26,0)
 .. S OBXSEG="|TX|^PROVISIONAL DIAGNOSIS^||"_$G(^GMR(123,GMRCIFN,30))
"RTN","GMRCHL72",27,0)
 . I $D(^GMR(123,GMRCIFN,30.1)) D
"RTN","GMRCHL72",28,0)
 .. S GMRCSYS=$P(^GMR(123,GMRCIFN,30.1),U,3) S GMRCSYS=$S(GMRCSYS="ICD":"I9C",GMRCSYS="10D":"I10",1:"") ;WAT/73
"RTN","GMRCHL72",29,0)
 .. S OBXSEG="|CE|^PROVISIONAL DIAGNOSIS^||"_$P(^GMR(123,GMRCIFN,30.1),U)_U
"RTN","GMRCHL72",30,0)
 .. S OBXSEG=OBXSEG_$P(^GMR(123,GMRCIFN,30),(" ("_^(30.1)))_U_GMRCSYS ;WAT/73
"RTN","GMRCHL72",31,0)
 . S OBX(OBXSEGNO)=OBX(OBXSEGNO)_OBXSEG
"RTN","GMRCHL72",32,0)
 I ORCTRL="RE",$L($P(^GMR(123,GMRCIFN,0),U,19)) D
"RTN","GMRCHL72",33,0)
 . S OBXSEGNO=OBXSEGNO+1
"RTN","GMRCHL72",34,0)
 . S OBX(OBXSEGNO)="OBX|"_OBXSEGNO
"RTN","GMRCHL72",35,0)
 . N OBXSEG
"RTN","GMRCHL72",36,0)
 . S OBXSEG="|TX|^SIG FINDINGS^|1|"_$P(^GMR(123,GMRCIFN,0),U,19)
"RTN","GMRCHL72",37,0)
 . S OBX(OBXSEGNO)=OBX(OBXSEGNO)_OBXSEG
"RTN","GMRCHL72",38,0)
 Q
"RTN","GMRCHL72",39,0)
 ;
"RTN","GMRCHL72",40,0)
NTE(GMRCFN,GMRCND,GMRCTRL) ;Build the NTE segment of the HL7 message
"RTN","GMRCHL72",41,0)
 ;GMRCND=GMRCOM, an array. GMRCND = flag that a comment exists.
"RTN","GMRCHL72",42,0)
 ;GMRCND(0)= DA = the internal entry in node 40: ^GMR(123,IEN,40,DA
"RTN","GMRCHL72",43,0)
 ;GMRCTRL=HL7 control code from table 119
"RTN","GMRCHL72",44,0)
 Q:'$D(GMRCND(0))  S ND=GMRCND(0)
"RTN","GMRCHL72",45,0)
 S ND2=1,NTE(ND2)="NTE|16|L|"
"RTN","GMRCHL72",46,0)
 I $S($P(^GMR(123,GMRCFN,40,ND,0),"^",2)=6:1,$P(^(0),"^",2)=20:1,$P(^(0),"^",2)=7:1,$P(^(0),"^",2)=5:1,GMRCTRL="XX":1,1:0) D
"RTN","GMRCHL72",47,0)
 .S ND1=0,ND1=$O(^GMR(123,GMRCFN,40,ND,1,ND1)) Q:ND1=""  S NTE(ND2)=NTE(ND2)_^GMR(123,GMRCFN,40,ND,1,ND1,0),ND2=ND2+1
"RTN","GMRCHL72",48,0)
 .F  S ND1=$O(^GMR(123,GMRCFN,40,ND,1,ND1)) Q:ND1=""  S NTE(ND2)=^GMR(123,GMRCFN,40,ND,1,ND1,0),ND2=ND2+1
"RTN","GMRCHL72",49,0)
 .Q
"RTN","GMRCHL72",50,0)
 ;I $P(NTE(1),"|",4)="",$S(GMRCTRL="OD":1,GMRCTRL="OC":1,1:0) S $P(NTE(1),"|",4)=$P(^GMR(123.1,$P(^GMR(123,GMRCFN,40,ND,0),"^",2),0),"^",1)_$S($P(^(0),"^",2)]"":" BY SERVICE",1:"")
"RTN","GMRCHL72",51,0)
 I GMRCTRL="OD"!(GMRCTRL="OC") D
"RTN","GMRCHL72",52,0)
 . N ACTION S ACTION=$P(^GMR(123,GMRCFN,40,ND,0),"^",2) Q:ACTION=""
"RTN","GMRCHL72",53,0)
 . S ACTION=$$GET1^DIQ(123.1,ACTION,.01)
"RTN","GMRCHL72",54,0)
 . S $P(NTE(1),"|",4)=ACTION_" BY SERVICE"
"RTN","GMRCHL72",55,0)
 I $P(NTE(1),"|",4)="",GMRCTRL="XX" S $P(NTE(1),"|",4)=$P(^GMR(123.1,$P(^GMR(123,GMRCFN,40,ND,0),"^",2),0),"^",1)_" "_$S($P(^GMR(123,GMRCFN,40,ND,0),"^",6)]"":$P(^GMR(123.5,$P(^GMR(123,GMRCFN,40,ND,0),"^",6),0),"^",1),1:GMRCSSNM)
"RTN","GMRCHL72",56,0)
 K N,ND1,ND2
"RTN","GMRCHL72",57,0)
 Q
"RTN","GMRCHL72",58,0)
OBR(GMRCIEN,RESBY,GMRCACDT) ;Build the OBR segment of the HL-7 message
"RTN","GMRCHL72",59,0)
 ;GMRCIEN=IEN of the consult from file 123
"RTN","GMRCHL72",60,0)
 ;NOTIFY=Person who is notified when consult is ordered/completed
"RTN","GMRCHL72",61,0)
 ;RESBY=Person entering/interpreting result & signing report- GMRCPROV
"RTN","GMRCHL72",62,0)
 K OBR
"RTN","GMRCHL72",63,0)
 N OI,PROCID,PROCNM,STS,RESTATUS,SERVID,ORCDT,CONLOC,CONSVC,HL7DT
"RTN","GMRCHL72",64,0)
 ;I +$P(^GMR(123,GMRCIEN,0),"^",5)'>0,$S($D(GMRCSSNM):1,+GMRCGRP("ROOT"):1,1:0) S $P(^(0),"^",5)=$S(+GMRCGRP("ROOT"):GMRCGRP("ROOT"),1:$O(^GMR(123.5,"B",GMRCSSNM,0)))
"RTN","GMRCHL72",65,0)
 S STS=$P(^GMR(123,GMRCIEN,0),"^",12),RESTATUS=$S(STS=1:"X",STS=2:"F",STS=5:"O",STS=6:"I",STS=8:"S",STS=9:"R",1:"X")
"RTN","GMRCHL72",66,0)
 S SERVID=$P(^GMR(123,GMRCIEN,0),"^",5),ORCDT=$P(^(0),"^",7),CONLOC=$P(^(0),"^",10) I CONLOC]"" S CONLOC=$S($P(^ORD(101,CONLOC,0),"^",1)["BEDSIDE":"B",$P(^(0),"^",1)["EMERGENCY":"E",1:"OC")
"RTN","GMRCHL72",67,0)
 S NOTIFY=$P(^GMR(123,GMRCIEN,0),"^",11),CONSVC=$S(+SERVID]"":$P($G(^GMR(123.5,+SERVID,0)),"^",1),1:"")
"RTN","GMRCHL72",68,0)
 I +$P(^GMR(123,+GMRCIEN,0),U,8) D
"RTN","GMRCHL72",69,0)
 . S PROCID=+$P(^GMR(123,+GMRCIEN,0),U,8)
"RTN","GMRCHL72",70,0)
 . S PROCNM=$$GET1^DIQ(123.3,PROCID,.01)
"RTN","GMRCHL72",71,0)
 . S OI=PROCID_U_PROCNM_"^99PRC"
"RTN","GMRCHL72",72,0)
 I '$D(OI) S OI=SERVID_U_CONSVC_"^99CON"
"RTN","GMRCHL72",73,0)
 S HL7DT=$$HL7DT^GMRCHL7($S($G(GMRCACDT):GMRCACDT,1:$$NOW^XLFDT))
"RTN","GMRCHL72",74,0)
 S OBR="OBR||||^^^"_OI_"||||||||||||||"_CONLOC_"|"_NOTIFY_"|||"_HL7DT_"|||"_RESTATUS_$S(RESBY]"":"|||||||"_RESBY,1:"")
"RTN","GMRCHL72",75,0)
 K STS,RESTATUS,SERVID,ORCDT,CONLOC,CONSVC,HL7DT
"RTN","GMRCHL72",76,0)
 Q
"RTN","GMRCHL7A")
0^16^B31527698
"RTN","GMRCHL7A",1,0)
GMRCHL7A ;SLC/DCM,MA - Receive HL-7 Message from OERR ;08/01/13  06:38
"RTN","GMRCHL7A",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,15,21,22,33,68,66,73**;DEC 27, 1997;Build 22
"RTN","GMRCHL7A",3,0)
 ;
"RTN","GMRCHL7A",4,0)
 ;ICRs
"RTN","GMRCHL7A",5,0)
 ;;GLOBALS/FILES  #872(FILE 101 ^ORD(101))
"RTN","GMRCHL7A",6,0)
 ;;ROUTINES  #2053(DIE)
"RTN","GMRCHL7A",7,0)
 ;
"RTN","GMRCHL7A",8,0)
URG(X) ;Return Urgency give Z-code from HL-7 segment; see ORC+9
"RTN","GMRCHL7A",9,0)
 S X=$S(X="S":"STAT",X="R":"ROUTINE",X="ZT":"TODAY",X="Z24":"WITHIN 24 HOURS",X="Z48":"WITHIN 48 HOURS",X="Z72":"WITHIN 72 HOURS",X="ZW":"WITHIN 1 WEEK",X="ZM":"WITHIN 1 MONTH",X="ZNA":"NEXT AVAILABLE",1:X)
"RTN","GMRCHL7A",10,0)
 I $E(X,1)="Z" S X=$S(X="ZT":"TODAY",X="ZE":"EMERGENCY",1:"")
"RTN","GMRCHL7A",11,0)
 Q X
"RTN","GMRCHL7A",12,0)
 ;
"RTN","GMRCHL7A",13,0)
ORC(GMRCORC) ;Get fields from ORC segment and set into GMRC variables
"RTN","GMRCHL7A",14,0)
 ;GMRCTRLC=ORC control code from HL7 Table 119
"RTN","GMRCHL7A",15,0)
 ;GMRCURGI=priority/urgency     GMRCPLCR=who entered the order
"RTN","GMRCHL7A",16,0)
 ;GMRCORNP=provider             GMRCNATO=nature of order
"RTN","GMRCHL7A",17,0)
 ;GMRCAD=date of request        GMRCOCR=order request reason
"RTN","GMRCHL7A",18,0)
 ;GMRCORFN=oe/rr file number    GMRCO=file 123 IEN - if not a new order
"RTN","GMRCHL7A",19,0)
 ;GMRCS38=order status - taken from Table 38, HL7 standard
"RTN","GMRCHL7A",20,0)
 ;GMRCERDT=earliest date desired
"RTN","GMRCHL7A",21,0)
 S GMRCTRLC=$P(GMRCORC,SEP1,2),GMRCORFN=$P(GMRCORC,SEP1,3),GMRCORFN=$P($P(GMRCORFN,SEP2,1),";",1),GMRCAPP=$P($P(GMRCORC,SEP1,3),SEP2,2)
"RTN","GMRCHL7A",22,0)
 S GMRCS38=$P(GMRCORC,SEP1,6),GMRCURGI=$P($P(GMRCORC,SEP1,8),SEP2,6),GMRCPLCR=$P(GMRCORC,SEP1,11),GMRCORNP=$P(GMRCORC,SEP1,13)
"RTN","GMRCHL7A",23,0)
 I $L(GMRCURGI) S GMRCURGI="GMRCURGENCY - "_$$URG(GMRCURGI),GMRCURGI=$O(^ORD(101,"B",GMRCURGI,0))
"RTN","GMRCHL7A",24,0)
 S GMRCERDT=$P($P(GMRCORC,SEP1,8),SEP2,4),GMRCERDT=$$FMDATE^GMRCHL7($G(GMRCERDT)) ;WAT/66
"RTN","GMRCHL7A",25,0)
 S GMRCO=+$P($P(GMRCORC,SEP1,4),SEP2,1)
"RTN","GMRCHL7A",26,0)
 S GMRCODT=$P(GMRCORC,SEP1,16),GMRCAD=$$FMDATE^GMRCHL7(GMRCODT)
"RTN","GMRCHL7A",27,0)
 S GMRCOCR=$P(GMRCORC,SEP1,17),GMRCNATO=$P(GMRCOCR,SEP2,5)
"RTN","GMRCHL7A",28,0)
 Q
"RTN","GMRCHL7A",29,0)
OBR(GMRCOBR) ;Get fields from OBR segment and set into GMRC variables
"RTN","GMRCHL7A",30,0)
 ;GMRCTYPE=GMRC consult or GMRC request  GMRCSS=To Service
"RTN","GMRCHL7A",31,0)
 ;GMRCPLI=place of consultation          GMRCODT=observation date/time
"RTN","GMRCHL7A",32,0)
 ;GMRCATN=person to alert (attention)    GMRCSTDT=status change date/time
"RTN","GMRCHL7A",33,0)
 ;GMRCS123=results status (table 123)    GMRCINTR=results interpreter
"RTN","GMRCHL7A",34,0)
 ;GMRCPRI=procedure from file ^ORD(101,
"RTN","GMRCHL7A",35,0)
 ;GMRCXMF=foreign consult service
"RTN","GMRCHL7A",36,0)
 ;        a flag that tells the HL7 routine that
"RTN","GMRCHL7A",37,0)
 ;        consults does not need to return CPRS a file
"RTN","GMRCHL7A",38,0)
 ;        IEN for file 123. See routine ^GMRCXMF
"RTN","GMRCHL7A",39,0)
 S GMRCPR=$P($P(GMRCOBR,SEP1,5),SEP2,6)
"RTN","GMRCHL7A",40,0)
 S GMRCTYPE=$S(GMRCPR="99PRC":"P",1:"C")
"RTN","GMRCHL7A",41,0)
 S GMRCPRI="",GMRCSS=""
"RTN","GMRCHL7A",42,0)
 I GMRCPR="99PRC" D
"RTN","GMRCHL7A",43,0)
 . S GMRCPRI=$P($P(GMRCOBR,SEP1,5),SEP2,4)
"RTN","GMRCHL7A",44,0)
 . S GMRCPRI=$S(+GMRCPRI:GMRCPRI_";GMR(123.3,",1:"")
"RTN","GMRCHL7A",45,0)
 . Q
"RTN","GMRCHL7A",46,0)
 ;
"RTN","GMRCHL7A",47,0)
 S GMRCOTXT=$P($P(GMRCOBR,SEP1,5),SEP2,5) ;consult type or service name
"RTN","GMRCHL7A",48,0)
 S GMRCODT=$P(GMRCOBR,SEP1,7) I GMRCODT]"" S GMRCODT=$$FMDATE^GMRCHL7(GMRCODT)
"RTN","GMRCHL7A",49,0)
 S GMRCPLI=$P(GMRCOBR,SEP1,19) I GMRCPLI]"" S GMRCPLI="GMRCPLACE - "_$S(GMRCPLI="OC":"ON CALL",GMRCPLI="B":"BEDSIDE",GMRCPLI="E":"EMERGENCY ROOM",1:GMRCPLI),GMRCPLI=$O(^ORD(101,"B",GMRCPLI,0))
"RTN","GMRCHL7A",50,0)
 S GMRCATN=$P(GMRCOBR,SEP1,20),GMRCSTDT=$P(GMRCOBR,SEP1,23),GMRCSTDT=$$FMDATE^GMRCHL7(GMRCSTDT)
"RTN","GMRCHL7A",51,0)
 S GMRCS123=$P(GMRCOBR,SEP1,26),GMRCINTR=$P(GMRCOBR,SEP1,33)
"RTN","GMRCHL7A",52,0)
 Q
"RTN","GMRCHL7A",53,0)
ZSV(GMRCZSV) ;Get service from ZSV segment and set into GMRCSS
"RTN","GMRCHL7A",54,0)
 S GMRCZSS=$P($P(GMRCZSV,SEP1,2),SEP2,4)
"RTN","GMRCHL7A",55,0)
 I +$G(GMRCZSS) S GMRCSS=+$G(GMRCZSS) ;Set the service if ZSV provided
"RTN","GMRCHL7A",56,0)
 I $L($P(GMRCZSV,"|",3)) S GMRCOTXT=$P(GMRCZSV,"|",3) ;consult type
"RTN","GMRCHL7A",57,0)
 Q
"RTN","GMRCHL7A",58,0)
OBX(GMRCOBX) ;Get fields from OBX segment and set into GMRC variables
"RTN","GMRCHL7A",59,0)
 ;GMRCVTYP=Value type from table 123 - i.e. TX(text), ST(string data),etc.
"RTN","GMRCHL7A",60,0)
 ;GMRCOID=observation id identifying value in seg. 5
"RTN","GMRCHL7A",61,0)
 ;GMRCVAL=observation value coded by segment 3
"RTN","GMRCHL7A",62,0)
 ;GMRCPRDG=provisional diagnosis
"RTN","GMRCHL7A",63,0)
 ;    free text or code^free text^I9C
"RTN","GMRCHL7A",64,0)
 S GMRCMSG=MSG(GMRCOBX)
"RTN","GMRCHL7A",65,0)
 S GMRCVTYP=$P(GMRCMSG,SEP1,3),GMRCOID=$P($P(GMRCMSG,SEP1,4),SEP2,2),GMRCVAL=$P(GMRCOID,SEP2,3)
"RTN","GMRCHL7A",66,0)
 I GMRCOID="REASON FOR REQUEST" D
"RTN","GMRCHL7A",67,0)
 .S GMRCRFQ(1)=$P(GMRCMSG,SEP1,6)
"RTN","GMRCHL7A",68,0)
 .S LN=0 F  S LN=$O(MSG(GMRCOBX,LN)) Q:LN=""  S GMRCRFQ(LN+1)=MSG(GMRCOBX,LN)
"RTN","GMRCHL7A",69,0)
 .Q
"RTN","GMRCHL7A",70,0)
 I GMRCOID="PROVISIONAL DIAGNOSIS" D  Q
"RTN","GMRCHL7A",71,0)
 . I GMRCVTYP="TX" D  Q
"RTN","GMRCHL7A",72,0)
 .. S GMRCPRDG=$P(GMRCMSG,SEP1,6)
"RTN","GMRCHL7A",73,0)
 .. S GMRCPRDG=$TR(GMRCPRDG,$C(9,10,13)," ") Q
"RTN","GMRCHL7A",74,0)
 . I GMRCVTYP="CE" D  Q
"RTN","GMRCHL7A",75,0)
 .. N PRDXSEG S PRDXSEG=$P(GMRCMSG,SEP1,6)
"RTN","GMRCHL7A",76,0)
 .. S GMRCPRDG=$TR($P(PRDXSEG,"^",2),$C(9,10,13),"") ;_"("_$P(PRDXSEG,"^")_")" WAT/73 no longer appending (code number) to end of diagnosis text
"RTN","GMRCHL7A",77,0)
 .. S GMRCPRCD=$P(PRDXSEG,"^")
"RTN","GMRCHL7A",78,0)
 I GMRCOID["COMMENT" D
"RTN","GMRCHL7A",79,0)
 .S GMRCCMT(1)=$P(GMRCMSG,SEP1,6)
"RTN","GMRCHL7A",80,0)
 .S LN=0 F  S LN=$O(MSG(GMRCOBX,LN)) Q:LN=""  S GMRCCMT(LN+1)=MSG(GMRCOBX,LN)
"RTN","GMRCHL7A",81,0)
 .Q
"RTN","GMRCHL7A",82,0)
 K LN
"RTN","GMRCHL7A",83,0)
 Q
"RTN","GMRCHL7A",84,0)
EN(MSG) ;Entry point to routine
"RTN","GMRCHL7A",85,0)
 ;MSG = local array which contains the HL-7 segments
"RTN","GMRCHL7A",86,0)
 ;GMRCSEND=sending application   GMRCFAC=sending facility
"RTN","GMRCHL7A",87,0)
 ;GMRCMTP=message type
"RTN","GMRCHL7A",88,0)
 N DFN,GMRCACT,GMRCADD,GMRCFAC,GMRCMTP,GMRCPNM,GMRCO,GMRCOCR,GMRCORNP
"RTN","GMRCHL7A",89,0)
 N GMRCORFN,GMRCPLCR,GMRCRB,GMRCSEND,GMRCSTS,GMRCTRLC,GMRCWARD,ORIFN
"RTN","GMRCHL7A",90,0)
 N GMRCTRLC,GMRCAD,ORC,GMRCSBR,GMRCZSS,GMRCSS,GMRCOTXT,GMRCPRCD
"RTN","GMRCHL7A",91,0)
 N GMRCREJ,GMRCRECV,GMRCERDT
"RTN","GMRCHL7A",92,0)
 S GMRCMSG="",GMRCNOD=0 F  S GMRCNOD=$O(MSG(GMRCNOD)) Q:GMRCNOD=""  S GMRCMSG=MSG(GMRCNOD) I $E(GMRCMSG,1,3)="MSH" D INIT^GMRCHL7U(GMRCMSG) D  Q
"RTN","GMRCHL7A",93,0)
 .S GMRCSEND=$P(GMRCMSG,SEP1,3),GMRCFAC=$P(GMRCMSG,SEP1,4)
"RTN","GMRCHL7A",94,0)
 .S GMRCMTP=$P(GMRCMSG,SEP1,9),GMRCRECV=$P(GMRCMSG,SEP1,5)
"RTN","GMRCHL7A",95,0)
 .Q
"RTN","GMRCHL7A",96,0)
 I $G(GMRCRECV)'="CONSULTS" Q  ;not intended for Consults
"RTN","GMRCHL7A",97,0)
 S GMRCMSG="",GMRCNOD=0
"RTN","GMRCHL7A",98,0)
 F  S GMRCNOD=$O(MSG(GMRCNOD)) Q:GMRCNOD=""  S GMRCMSG=MSG(GMRCNOD) D
"RTN","GMRCHL7A",99,0)
 .I $E(GMRCMSG,1,3)="PID" D PID^GMRCHL7U(GMRCMSG) Q
"RTN","GMRCHL7A",100,0)
 .I $E(GMRCMSG,1,3)="PV1" D PV1^GMRCHL7U(GMRCMSG) Q
"RTN","GMRCHL7A",101,0)
 .I $E(GMRCMSG,1,3)="ORC" D ORC(GMRCMSG) Q
"RTN","GMRCHL7A",102,0)
 .I $E(GMRCMSG,1,3)="OBR" D OBR(GMRCMSG) Q
"RTN","GMRCHL7A",103,0)
 .I $E(GMRCMSG,1,3)="ZSV" D ZSV(GMRCMSG) Q
"RTN","GMRCHL7A",104,0)
 .I $E(GMRCMSG,1,3)="OBX" D OBX(GMRCNOD) Q
"RTN","GMRCHL7A",105,0)
 .I $E(GMRCMSG,1,3)="NTE" D NTE^GMRCHL7U(.MSG,GMRCNOD,GMRCO,GMRCTRLC) Q
"RTN","GMRCHL7A",106,0)
 .I $E(GMRCMSG,1,3)="ZXX" S GMRCOFN=+$P(GMRCMSG,SEP1,2) K MSG(GMRCNOD) Q
"RTN","GMRCHL7A",107,0)
 .Q
"RTN","GMRCHL7A",108,0)
 ;Note, ZXX is not used yet; planned for future sharing consults with foreign facilities.
"RTN","GMRCHL7A",109,0)
 I '$D(GMRCTRLC) D EXIT^GMRCHL7U Q
"RTN","GMRCHL7A",110,0)
 I GMRCTRLC="Z@" D CPRSPURG^GMRCPURG(+GMRCO),EXIT^GMRCHL7U Q
"RTN","GMRCHL7A",111,0)
 I GMRCTRLC="NW" D NEW^GMRCHL7B(.GMRCREJ) D
"RTN","GMRCHL7A",112,0)
 . I $G(GMRCO) D RETURN^GMRCHL7U(GMRCO,GMRCTRLC) Q
"RTN","GMRCHL7A",113,0)
 . D REJECT^GMRCHL7U(.MSG,$G(GMRCREJ))
"RTN","GMRCHL7A",114,0)
 I '$D(GMRCO) D EXIT^GMRCHL7U Q
"RTN","GMRCHL7A",115,0)
 I $S(GMRCTRLC="CA":1,GMRCTRLC="DC":1,1:0) D DC^GMRCHL7B(GMRCO,GMRCTRLC),RETURN^GMRCHL7U(GMRCO,GMRCTRLC)
"RTN","GMRCHL7A",116,0)
 I GMRCTRLC="NA" D RTN(GMRCORFN,GMRCO)
"RTN","GMRCHL7A",117,0)
 I GMRCTRLC="XX" D MODIFY^GMRCHL7B ;Not currently returned by CPRS
"RTN","GMRCHL7A",118,0)
 ; If consults sends an XX, CPRS returns an NA.
"RTN","GMRCHL7A",119,0)
 D EXIT^GMRCHL7U
"RTN","GMRCHL7A",120,0)
 Q
"RTN","GMRCHL7A",121,0)
RTN(GMRCORN,DA) ;Put ^OR(100, ien for order into ^GMR(123,
"RTN","GMRCHL7A",122,0)
 S DIE="^GMR(123,",DR=".03////^S X=GMRCORN"
"RTN","GMRCHL7A",123,0)
 L +^GMR(123,DA):$S($G(DILOCKTM)>0:DILOCKTM,1:5) D ^DIE L -^GMR(123,DA) ;wat/66 add lock timeout
"RTN","GMRCHL7A",124,0)
 K DIE,DR
"RTN","GMRCHL7A",125,0)
 Q
"RTN","GMRCHL7B")
0^7^B29886300
"RTN","GMRCHL7B",1,0)
GMRCHL7B ;SLC/DCM,MA,JFR - Process data from GMRCHL7A ;01/28/14  07:12
"RTN","GMRCHL7B",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,21,17,22,33,66,46,73**;DEC 27, 1997;Build 22
"RTN","GMRCHL7B",3,0)
 ;
"RTN","GMRCHL7B",4,0)
 ; This routine invokes IA #5699(ICDXCODE), #2053(DIE), #10006(DIC), #2056(GET1^DIQ)
"RTN","GMRCHL7B",5,0)
 ;
"RTN","GMRCHL7B",6,0)
NEW(MESSAGE) ;Add new order
"RTN","GMRCHL7B",7,0)
 ;GMRCO=^GMR(123,IFN, the new file number in file ^GMR(123,
"RTN","GMRCHL7B",8,0)
 ;GMRCORFN=OE/RR file number       GMRCWARD=ward patient is on
"RTN","GMRCHL7B",9,0)
 ;GMRCSS=service consult sent to   GMRCAD=date/time of request
"RTN","GMRCHL7B",10,0)
 ;GMRCPRI=procedure/request        GMRCURGI=urgency
"RTN","GMRCHL7B",11,0)
 ;GMRCERDT=earliest desired date
"RTN","GMRCHL7B",12,0)
 ;GMRCATN=attention                GMRCSTS=OE/RR order status
"RTN","GMRCHL7B",13,0)
 ;GMRCORNP=patient's provider      GMRCTYPE=request type (request or consult)
"RTN","GMRCHL7B",14,0)
 ;GMRCSBR=service rendered on what basis (Inpatient, or Outpatient)
"RTN","GMRCHL7B",15,0)
 ;GMRCRFQ=reason for request array - word processing fields
"RTN","GMRCHL7B",16,0)
 ;GMRCOTXT=order display text from dialog or orderable item
"RTN","GMRCHL7B",17,0)
 ;GMRCPRDG=provisional DX
"RTN","GMRCHL7B",18,0)
 ;GMRCPRCD=provisional DX code
"RTN","GMRCHL7B",19,0)
 ;GMRCCS=coding system for prov diagnosis
"RTN","GMRCHL7B",20,0)
 ;GMRCCPTR=pointer to coding system file
"RTN","GMRCHL7B",21,0)
 ; Output:
"RTN","GMRCHL7B",22,0)
 ;    MESSAGE = rejection message if problems encountered while filing
"RTN","GMRCHL7B",23,0)
 ;
"RTN","GMRCHL7B",24,0)
 ;
"RTN","GMRCHL7B",25,0)
 N DIC,DLAYGO,X,Y,DR,DIE,GMRCADUZ,GMRCCP,GMRCCS,GMRCCDT,GMRCCPTR,STATCHK
"RTN","GMRCHL7B",26,0)
 ;    check for inactive ICD-9 code in Prov. DX
"RTN","GMRCHL7B",27,0)
 I $D(GMRCPRCD) D  I $D(MESSAGE) Q  ; rejected due to inactive code
"RTN","GMRCHL7B",28,0)
 .S GMRCCS="ICD"
"RTN","GMRCHL7B",29,0)
 .I DT>=$$IMPDATE^LEXU("10D") S GMRCCS="10D"
"RTN","GMRCHL7B",30,0)
 .S GMRCCPTR=$S(GMRCCS="ICD":1,1:30)
"RTN","GMRCHL7B",31,0)
 .S STATCHK=$$STATCHK^ICDXCODE(GMRCCPTR,GMRCPRCD,DT)
"RTN","GMRCHL7B",32,0)
 .I +STATCHK Q  ;code is OK
"RTN","GMRCHL7B",33,0)
 .I $P(STATCHK,"^",2)=-1 S MESSAGE="Provisional DX code rejected: "_$P(STATCHK,"^",3)_" unable to file request" Q
"RTN","GMRCHL7B",34,0)
 .S MESSAGE="Provisional DX code is inactive. Unable to file request."
"RTN","GMRCHL7B",35,0)
 S DIC="^GMR(123,",DIC(0)="L",X="""N""",DLAYGO=123 D ^DIC K DLAYGO Q:Y<1
"RTN","GMRCHL7B",36,0)
 ; Patch #21 changed GMRCA=1 to GMRCA=2
"RTN","GMRCHL7B",37,0)
 S (DA,GMRCO)=+Y,GMRCSTS=5,GMRCA=2,DIE=DIC
"RTN","GMRCHL7B",38,0)
 L +^GMR(123,GMRCO):$S($G(DILOCKTM)>0:DILOCKTM,1:5)
"RTN","GMRCHL7B",39,0)
 S DR=".02////^S X=DFN;.03////^S X=GMRCORFN;.04////^S X=GMRCWARD;.05////^S X=GMRCFAC;.06////^S X=$G(GMRCOFN);1////^S X=GMRCSS;2////^S X=$G(GMRCWARD);3////^S X=GMRCAD;4////^S X=GMRCPRI;5////^S X=GMRCURGI;7////^S X=$G(GMRCATN)"
"RTN","GMRCHL7B",40,0)
 D ^DIE
"RTN","GMRCHL7B",41,0)
 I GMRCOTXT=$$GET1^DIQ(123.5,+GMRCSS,.01) S GMRCOTXT=""
"RTN","GMRCHL7B",42,0)
 ;Added new field .1 to DR on 7/11/98 to save the order text
"RTN","GMRCHL7B",43,0)
 S DR="6////^S X=GMRCPLI;8////^S X=GMRCSTS;9////^S X=GMRCA;10////^S X=GMRCORNP;13////^S X=GMRCTYPE;14////^S X=$G(GMRCSBR);17////^S X=$G(GMRCERDT);30////^S X=$G(GMRCPRDG);.1////^S X=$G(GMRCOTXT)" ;wat/66
"RTN","GMRCHL7B",44,0)
 I $D(GMRCPRCD) D
"RTN","GMRCHL7B",45,0)
 .S DR=DR_";30.1///^S X=GMRCPRCD;30.2////^S X=DT;30.3////^S X=GMRCCS"
"RTN","GMRCHL7B",46,0)
 S GMRCCP=$P($G(^GMR(123.3,+GMRCPRI,0)),U,4) I GMRCCP D  ;file CP
"RTN","GMRCHL7B",47,0)
 . S DR=DR_";1.01///^S X=GMRCCP"
"RTN","GMRCHL7B",48,0)
 D  ;check to see if an IFC and add .07 ROUTING FACILITY
"RTN","GMRCHL7B",49,0)
 . I $G(GMRCPRI) D  Q  ;see if procedure is mapped
"RTN","GMRCHL7B",50,0)
 .. I '$D(^GMR(123.3,+GMRCPRI,"IFC")) Q
"RTN","GMRCHL7B",51,0)
 .. N IFC S IFC=$G(^GMR(123.3,+GMRCPRI,"IFC"))
"RTN","GMRCHL7B",52,0)
 .. I '+IFC Q  ; no ifc routing site
"RTN","GMRCHL7B",53,0)
 .. I '$L($P(^GMR(123.3,+GMRCPRI,"IFC"),U,2)) Q  ;no remote proc name
"RTN","GMRCHL7B",54,0)
 .. S DR=DR_";.07////"_+IFC_";.125////P"
"RTN","GMRCHL7B",55,0)
 . I '$G(GMRCPRI) D  Q  ;see if service is mapped
"RTN","GMRCHL7B",56,0)
 .. I '$D(^GMR(123.5,+GMRCSS,"IFC")) Q
"RTN","GMRCHL7B",57,0)
 .. N IFC S IFC=$G(^GMR(123.5,+GMRCSS,"IFC"))
"RTN","GMRCHL7B",58,0)
 .. I '+IFC Q  ; no ifc routing site
"RTN","GMRCHL7B",59,0)
 .. I '$L($P(IFC,U,2)) Q  ;no remote service name
"RTN","GMRCHL7B",60,0)
 .. S DR=DR_";.07////"_+IFC_";.125////P;.131////"_$P(IFC,U,2)
"RTN","GMRCHL7B",61,0)
 . Q
"RTN","GMRCHL7B",62,0)
 D ^DIE
"RTN","GMRCHL7B",63,0)
 I $O(GMRCRFQ(0)) D REASON
"RTN","GMRCHL7B",64,0)
 L -^GMR(123,GMRCO)
"RTN","GMRCHL7B",65,0)
 S GMRCA=1 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",66,0)
 I $D(GMRCXMF),$D(GMRCOFN) S $P(^GMR(123,GMRCO,0),"^",21)=GMRCOFN
"RTN","GMRCHL7B",67,0)
 I $D(GMRCACTN) S GMRCADUZ(GMRCACTN)=""
"RTN","GMRCHL7B",68,0)
 D ALERT^GMRCHL7U(DFN,GMRCSS,GMRCPRI,GMRCO,GMRCURGI,"")
"RTN","GMRCHL7B",69,0)
 D PRNT^GMRCUTL1(GMRCSS,GMRCO) ;contains print audit update
"RTN","GMRCHL7B",70,0)
 D EXIT
"RTN","GMRCHL7B",71,0)
 Q
"RTN","GMRCHL7B",72,0)
DC(GMRCO,ACTRL) ;Discontinue request from OERR
"RTN","GMRCHL7B",73,0)
 ;Denied request also gets this action. Deny request updates status to dc
"RTN","GMRCHL7B",74,0)
 ;GMRCO=IEN of record in file ^GMR(123, i.e., ^GMR(123,DA,
"RTN","GMRCHL7B",75,0)
 ;ACTRL=GMRCCTRL=control code defining action -
"RTN","GMRCHL7B",76,0)
 ;         DC control code = action DC for discontinued
"RTN","GMRCHL7B",77,0)
 ;         CA control code = action DY for denied
"RTN","GMRCHL7B",78,0)
 ;Update the last action taken, order status, and processing activity
"RTN","GMRCHL7B",79,0)
 Q:'$L(GMRCO)
"RTN","GMRCHL7B",80,0)
 Q:'$D(^GMR(123,+GMRCO,0))
"RTN","GMRCHL7B",81,0)
 N GMRCACT,GMRCSVC,GMRCDFN,GMRCFL,GMRCADUZ,GMRCRQR,DA
"RTN","GMRCHL7B",82,0)
 S GMRCACT=$O(^GMR(123.1,"D",ACTRL,0))
"RTN","GMRCHL7B",83,0)
 S GMRCSTS=$P(^GMR(123.1,GMRCACT,0),"^",2)
"RTN","GMRCHL7B",84,0)
 S DIE="^GMR(123,",DA=GMRCO
"RTN","GMRCHL7B",85,0)
 S DR="8////^S X=GMRCSTS;9////^S X=GMRCACT" ; upd status + last action
"RTN","GMRCHL7B",86,0)
 D ^DIE
"RTN","GMRCHL7B",87,0)
 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",88,0)
 ; send 513 back through service printer if order DC'd
"RTN","GMRCHL7B",89,0)
 I $G(ACTRL)="DC",$$DCPRNT^GMRCUTL1(GMRCO,DUZ) D
"RTN","GMRCHL7B",90,0)
 . D PRNT^GMRCUTL1(+$P(^GMR(123,GMRCO,0),U,5),GMRCO)
"RTN","GMRCHL7B",91,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCHL7B",92,0)
 S GMRCFL=$$DCNOTE^GMRCADC(GMRCO,DUZ),GMRCADUZ=""
"RTN","GMRCHL7B",93,0)
 S GMRCRQR=+$P($G(^GMR(123,+GMRCO,0)),"^",14)
"RTN","GMRCHL7B",94,0)
 I +GMRCRQR,GMRCRQR'=DUZ S GMRCADUZ(GMRCRQR)=""
"RTN","GMRCHL7B",95,0)
 S GMRCSVC=$P($G(^GMR(123,+GMRCO,0)),"^",5)
"RTN","GMRCHL7B",96,0)
 I +GMRCSVC S GMRCSVC=$S($D(^GMR(123.5,GMRCSVC,.1)):^(.1),1:$P(^GMR(123.5,GMRCSVC,0),"^",1))
"RTN","GMRCHL7B",97,0)
 E  S GMRCSVC="Unknown Service: Consult # "_GMRCO
"RTN","GMRCHL7B",98,0)
 S GMRCORTX=$S(ACTRL="DC":"Discontinued",1:"Cancelled")
"RTN","GMRCHL7B",99,0)
 S GMRCORTX=GMRCORTX_" Consult "_$$ORTX^GMRCAU(GMRCO)
"RTN","GMRCHL7B",100,0)
 N NOTYPE S NOTYPE=$S(ACTRL="DC":23,1:30)
"RTN","GMRCHL7B",101,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,NOTYPE,.GMRCADUZ,GMRCFL)
"RTN","GMRCHL7B",102,0)
 D EXIT
"RTN","GMRCHL7B",103,0)
 Q
"RTN","GMRCHL7B",104,0)
MODIFY ;Change an order/request when an HL7 'XX' code is received
"RTN","GMRCHL7B",105,0)
 ;This is currently not used.
"RTN","GMRCHL7B",106,0)
 ;    When Consults sends an XX, CPRS returns NA with a new order ien.
"RTN","GMRCHL7B",107,0)
 ;GMRCACT=processing activity - from file ^GMR(123.1,
"RTN","GMRCHL7B",108,0)
 S DIE="^GMR(123,",DA=+GMRCO
"RTN","GMRCHL7B",109,0)
 S GMRCWARD=$G(GMRCWARD),GMRCPRI=$G(GMRCPRI),GMRCURGI=$G(GMRCURGI),GMRCSTS=$G(GMRCSTS),GMRCTYPE=$G(GMRCTYPE),GMRCSS=$G(GMRCSS)
"RTN","GMRCHL7B",110,0)
 S GMRCACT=$O(^GMR(123.1,"D",GMRCTRLC,0))
"RTN","GMRCHL7B",111,0)
 S GMRCSTS=$P(^GMR(123.1,GMRCACT,0),"^",2)
"RTN","GMRCHL7B",112,0)
 S DIE=123,DR=".04////^S X=$G(GMRCWARD);1////^S X=$G(GMRCSS);4////^S X=$G(GMRCPRI);5////^S X=$G(GMRCURGI);8////^S X=$G(GMRCSTS);9////^S X=GMRCACT"
"RTN","GMRCHL7B",113,0)
 D ^DIE
"RTN","GMRCHL7B",114,0)
 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",115,0)
 D EXIT Q
"RTN","GMRCHL7B",116,0)
REASON ;load the reason for request into ^GMR(123,IFN,20
"RTN","GMRCHL7B",117,0)
 S ^GMR(123,GMRCO,20,0)="^^^"_$S($D(GMRCDA):GMRCDA,1:DT)_"^"
"RTN","GMRCHL7B",118,0)
 S L=0,LN=1 F  S L=$O(GMRCRFQ(L)) Q:L=""  S ^GMR(123,GMRCO,20,LN,0)=GMRCRFQ(L),LN=LN+1
"RTN","GMRCHL7B",119,0)
 S LN=LN-1,$P(^GMR(123,GMRCO,20,0),"^",3)=LN
"RTN","GMRCHL7B",120,0)
 K L,LN
"RTN","GMRCHL7B",121,0)
 Q
"RTN","GMRCHL7B",122,0)
COMMENT(GMRCARY) ;add comments to the record.  Add the comment header, then the comment lines, and lastly, the number of comment lines to the header
"RTN","GMRCHL7B",123,0)
 ;GMRCARY= GMRCNTC array
"RTN","GMRCHL7B",124,0)
 S LN=0,^GMR(123,GMRCO,40,DA,1,0)="^^^^"_$P(GMRCDA,".",1)_"^"
"RTN","GMRCHL7B",125,0)
 F  S LN=$O(GMRCARY(LN)) Q:LN=""  S ^GMR(123,+GMRCO,40,DA,1,LN,0)=GMRCARY(LN),LN1=LN
"RTN","GMRCHL7B",126,0)
 S $P(^GMR(123,+GMRCO,40,DA,1,0),"^",3,4)=LN1_"^"_LN1
"RTN","GMRCHL7B",127,0)
 K LN,LN1 Q
"RTN","GMRCHL7B",128,0)
 Q
"RTN","GMRCHL7B",129,0)
EXIT ;kill off all variables
"RTN","GMRCHL7B",130,0)
 K DA,DIC,DIE,DR,GMRCORTX,GMRCADUZ
"RTN","GMRCHL7B",131,0)
 Q
"RTN","GMRCIAC1")
0^14^B78977784
"RTN","GMRCIAC1",1,0)
GMRCIAC1 ;SLC/JFR - FILE IFC ACTIVITIES cont'd ;03/20/14  11:40
"RTN","GMRCIAC1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,66,73**;DEC 27, 1997;Build 22
"RTN","GMRCIAC1",3,0)
 ;#2051($$FIND1^DIC), #2053(DIE), #10104 (XLFSTR)
"RTN","GMRCIAC1",4,0)
 Q
"RTN","GMRCIAC1",5,0)
COMP(GMRCAR) ;process partial result, clin complete and admin complete
"RTN","GMRCIAC1",6,0)
 ;
"RTN","GMRCIAC1",7,0)
 N GMRCDA,GMRCFDA,GMRCORC,GMRCLAT,GMRCACT,FDA
"RTN","GMRCIAC1",8,0)
 N GMRCRES,GMRCERR,GMRCSTS,GMRCREAS
"RTN","GMRCIAC1",9,0)
 M ^TMP("GMRCIN",$J)=@GMRCAR
"RTN","GMRCIAC1",10,0)
 S GMRCORC=^TMP("GMRCIN",$J,"ORC")
"RTN","GMRCIAC1",11,0)
 S GMRCREAS=$P($P(GMRCORC,"|",16),U)
"RTN","GMRCIAC1",12,0)
 S GMRCDA=$$GETDA^GMRCIAC2(GMRCORC)
"RTN","GMRCIAC1",13,0)
 S GMRCSTS=$P(^GMR(123,GMRCDA,0),U,12)
"RTN","GMRCIAC1",14,0)
 I '$$LOCKREC^GMRCUTL1(GMRCDA) D  Q  ;couldn't lock record
"RTN","GMRCIAC1",15,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AR",901) ;send app. ACK
"RTN","GMRCIAC1",16,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIAC1",17,0)
 ;
"RTN","GMRCIAC1",18,0)
 S GMRCFDA(8)=$S($P(GMRCORC,"|",5)="CM":2,GMRCSTS=2:2,1:9) ;comp or pr
"RTN","GMRCIAC1",19,0)
 S GMRCLAT=$S($P(GMRCORC,"|",5)="A":9,GMRCREAS="A":13,1:10)
"RTN","GMRCIAC1",20,0)
 S GMRCFDA(9)=GMRCLAT ;complete/upd or incomplete rpt
"RTN","GMRCIAC1",21,0)
 I $D(^TMP("GMRCIN",$J,"OBX",6,1)) D
"RTN","GMRCIAC1",22,0)
 . S GMRCFDA(15)=$P(^TMP("GMRCIN",$J,"OBX",6,1),"|",5)
"RTN","GMRCIAC1",23,0)
 ;     v-- check to see if a duplicate transmission
"RTN","GMRCIAC1",24,0)
 I $$DUPACT^GMRCIAC2(GMRCDA,GMRCLAT,GMRCORC,$S(GMRCLAT=13:"",1:$G(^TMP("GMRCIN",$J,"OBX",4,1)))) Q
"RTN","GMRCIAC1",25,0)
 M FDA(1,123,GMRCDA_",")=GMRCFDA
"RTN","GMRCIAC1",26,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR") ;file last action and status
"RTN","GMRCIAC1",27,0)
 ; check GMRCERR and act if error
"RTN","GMRCIAC1",28,0)
 K GMRCERR
"RTN","GMRCIAC1",29,0)
 K GMRCFDA,FDA
"RTN","GMRCIAC1",30,0)
 D FILEACT^GMRCIAC2(GMRCDA,GMRCLAT,,$NA(^TMP("GMRCIN",$J)))
"RTN","GMRCIAC1",31,0)
 ;     ^--- file result and activities
"RTN","GMRCIAC1",32,0)
 I $D(^TMP("GMRCIN",$J,"OBX",4,1)) D  ;file result if there
"RTN","GMRCIAC1",33,0)
 . I GMRCLAT=13 Q  ; addendum carries the result that it's addending
"RTN","GMRCIAC1",34,0)
 . I GMRCLAT=9 Q  ; don't file result on inc. report
"RTN","GMRCIAC1",35,0)
 . I $P(^GMR(123,GMRCDA,12),U,5)="F" Q  ;no comp coming from placer
"RTN","GMRCIAC1",36,0)
 . D FILRES^GMRCIAC2(GMRCDA,^TMP("GMRCIN",$J,"OBX",4,1))
"RTN","GMRCIAC1",37,0)
 D  ;send notifications
"RTN","GMRCIAC1",38,0)
 . I GMRCLAT=9 Q
"RTN","GMRCIAC1",39,0)
 . I $P(^GMR(123,GMRCDA,12),U,5)="F" Q  ;filler only gets historical comp
"RTN","GMRCIAC1",40,0)
 . N GMRCORTX S GMRCORTX=""
"RTN","GMRCIAC1",41,0)
 . I $O(^GMR(123,GMRCDA,51," "),-1)>1 D
"RTN","GMRCIAC1",42,0)
 .. S GMRCORTX="New remote result added to "
"RTN","GMRCIAC1",43,0)
 . I GMRCLAT=13 S GMRCORTX="Addendum added to "
"RTN","GMRCIAC1",44,0)
 . S GMRCORTX=GMRCORTX_"Remote Complete Consult: "_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIAC1",45,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA,0),U,2),GMRCORTX,GMRCDA,23,,1)
"RTN","GMRCIAC1",46,0)
 D  ;send appl ACK
"RTN","GMRCIAC1",47,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AA")
"RTN","GMRCIAC1",48,0)
 ;
"RTN","GMRCIAC1",49,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIAC1",50,0)
 Q
"RTN","GMRCIAC1",51,0)
 ;
"RTN","GMRCIAC1",52,0)
FWD(GMRCAR)     ;file forward action from a remote site
"RTN","GMRCIAC1",53,0)
 ;Input:
"RTN","GMRCIAC1",54,0)
 ; GMRCAR = array name containing message
"RTN","GMRCIAC1",55,0)
 ;      e.g.  ^TMP("GMRCIF",$J)
"RTN","GMRCIAC1",56,0)
 ;
"RTN","GMRCIAC1",57,0)
 N GMRCFDA,GMRCDA,GMRCFWSR,GMRCFROM,GMRCORC,GMRCTIFC,GMRCLAC,GMRCROL
"RTN","GMRCIAC1",58,0)
 M ^TMP("GMRCIN",$J)=@GMRCAR
"RTN","GMRCIAC1",59,0)
 I '$D(^TMP("GMRCIN",$J,"OBR")) Q
"RTN","GMRCIAC1",60,0)
 S GMRCORC=^TMP("GMRCIN",$J,"ORC")
"RTN","GMRCIAC1",61,0)
 S GMRCTIFC=$S($P($P(GMRCORC,"|",16),U)="F":0,1:1)
"RTN","GMRCIAC1",62,0)
 S GMRCDA=$$GETDA^GMRCIAC2(GMRCORC)
"RTN","GMRCIAC1",63,0)
 I '$$LOCKREC^GMRCUTL1(GMRCDA) D  Q  ;couldn't lock record
"RTN","GMRCIAC1",64,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AR",901) ;send app. ACK
"RTN","GMRCIAC1",65,0)
        . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIAC1",66,0)
 S GMRCROL=$P(^GMR(123,GMRCDA,12),U,5)
"RTN","GMRCIAC1",67,0)
 I 'GMRCTIFC D
"RTN","GMRCIAC1",68,0)
 . S GMRCFDA(9)=17,GMRCLAC=17
"RTN","GMRCIAC1",69,0)
 . I GMRCROL="F" D  Q
"RTN","GMRCIAC1",70,0)
 .. S GMRCFROM=$P($P(^TMP("GMRCIN",$J,"OBR"),"|",4),U,2)
"RTN","GMRCIAC1",71,0)
 . S GMRCFDA(.131)=$P($P(^TMP("GMRCIN",$J,"OBR"),"|",4),U,2)
"RTN","GMRCIAC1",72,0)
 . S GMRCFROM=$P($G(^GMR(123,GMRCDA,13)),U)
"RTN","GMRCIAC1",73,0)
 I GMRCTIFC D
"RTN","GMRCIAC1",74,0)
 . S GMRCFROM=$P($P(^TMP("GMRCIN",$J,"OBR"),"|",4),U,2)
"RTN","GMRCIAC1",75,0)
 . S GMRCFDA(9)=25,GMRCLAC=25
"RTN","GMRCIAC1",76,0)
 ;
"RTN","GMRCIAC1",77,0)
 S GMRCFDA(8)=5
"RTN","GMRCIAC1",78,0)
 D  ;get urgency to file
"RTN","GMRCIAC1",79,0)
 . N URG
"RTN","GMRCIAC1",80,0)
 . S URG=$$URG^GMRCHL7A($P($P(^TMP("GMRCIN",$J,"ORC"),"|",7),U,6))
"RTN","GMRCIAC1",81,0)
 . S GMRCFDA(5)=$$FIND1^DIC(101,"","X","GMRCURGENCY - "_URG)
"RTN","GMRCIAC1",82,0)
 ;   v-- chk to see if activity is a dup transmission
"RTN","GMRCIAC1",83,0)
 I $$DUPACT^GMRCIAC2(GMRCDA,GMRCLAC,GMRCORC) Q
"RTN","GMRCIAC1",84,0)
 ;
"RTN","GMRCIAC1",85,0)
 M FDA(1,123,GMRCDA_",")=GMRCFDA
"RTN","GMRCIAC1",86,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR")
"RTN","GMRCIAC1",87,0)
 K GMRCFDA
"RTN","GMRCIAC1",88,0)
 ;
"RTN","GMRCIAC1",89,0)
 ; file activity tracking
"RTN","GMRCIAC1",90,0)
 D FILEACT^GMRCIAC2(GMRCDA,GMRCLAC,GMRCFROM,$NA(^TMP("GMRCIN",$J)))
"RTN","GMRCIAC1",91,0)
 ;
"RTN","GMRCIAC1",92,0)
 ; send alerts
"RTN","GMRCIAC1",93,0)
 I GMRCROL="F" D
"RTN","GMRCIAC1",94,0)
 . I GMRCLAC'=25 Q  ; filler alerts only on FWD 2 IFC
"RTN","GMRCIAC1",95,0)
 . N GMRCTX
"RTN","GMRCIAC1",96,0)
 . S GMRCTX="New remote Consult: "_$$ORTX^GMRCAU(GMRCDA)
"RTN","GMRCIAC1",97,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA,0),U,2),GMRCTX,GMRCDA,27,,1)
"RTN","GMRCIAC1",98,0)
 . Q
"RTN","GMRCIAC1",99,0)
 I GMRCROL="P" D
"RTN","GMRCIAC1",100,0)
 . N GMRCTX
"RTN","GMRCIAC1",101,0)
 . S GMRCTX="Updated Remote Consult: "_$$ORTX^GMRCAU(GMRCDA)
"RTN","GMRCIAC1",102,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA,0),U,2),GMRCTX,GMRCDA,63,,1)
"RTN","GMRCIAC1",103,0)
 . Q
"RTN","GMRCIAC1",104,0)
 ;
"RTN","GMRCIAC1",105,0)
 ; print if FWD to IFC
"RTN","GMRCIAC1",106,0)
 I GMRCROL="F" D
"RTN","GMRCIAC1",107,0)
 . I GMRCLAC'=25 Q
"RTN","GMRCIAC1",108,0)
 . D PRNT^GMRCUTL1("",GMRCDA)
"RTN","GMRCIAC1",109,0)
 ;
"RTN","GMRCIAC1",110,0)
 D  ;send app. ACK and unlock record
"RTN","GMRCIAC1",111,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AA")
"RTN","GMRCIAC1",112,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIAC1",113,0)
 Q
"RTN","GMRCIAC1",114,0)
 ;
"RTN","GMRCIAC1",115,0)
SF(GMRCAR) ;add significant findings
"RTN","GMRCIAC1",116,0)
 ; Input:
"RTN","GMRCIAC1",117,0)
 ; GMRCAR = array name containing message
"RTN","GMRCIAC1",118,0)
 ;      e.g.  ^TMP("GMRCIF",$J)
"RTN","GMRCIAC1",119,0)
 ;
"RTN","GMRCIAC1",120,0)
 N FDA,GMRCERR,GMRCOSF,GMRCISF
"RTN","GMRCIAC1",121,0)
 M ^TMP("GMRCIS",$J)=@GMRCAR
"RTN","GMRCIAC1",122,0)
 I '$D(^TMP("GMRCIS",$J,"OBX",6,1)) Q  ;no SF flag sent  ;-(
"RTN","GMRCIAC1",123,0)
 S GMRCDA=$$GETDA^GMRCIAC2(^TMP("GMRCIS",$J,"ORC"))
"RTN","GMRCIAC1",124,0)
 I '$$LOCKREC^GMRCUTL1(GMRCDA) D  Q  ;couldn't lock record
"RTN","GMRCIAC1",125,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AR",901) ;send app. ACK
"RTN","GMRCIAC1",126,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIAC1",127,0)
 ;
"RTN","GMRCIAC1",128,0)
 S GMRCOSF=$P(^GMR(123,GMRCDA,0),U,19)
"RTN","GMRCIAC1",129,0)
 S GMRCISF=$P(^TMP("GMRCIS",$J,"OBX",6,1),"|",5)
"RTN","GMRCIAC1",130,0)
 S FDA(1,123,GMRCDA_",",15)=GMRCISF
"RTN","GMRCIAC1",131,0)
 S FDA(1,123,GMRCDA_",",9)=4
"RTN","GMRCIAC1",132,0)
 ;   v-- quit if a duplicate activity
"RTN","GMRCIAC1",133,0)
 I $$DUPACT^GMRCIAC2(GMRCDA,4,^TMP("GMRCIS",$J,"ORC")) Q
"RTN","GMRCIAC1",134,0)
 ;
"RTN","GMRCIAC1",135,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR") ;file last action and SF
"RTN","GMRCIAC1",136,0)
 D FILEACT^GMRCIAC2(GMRCDA,4,,$NA(^TMP("GMRCIS",$J))) ;activity track
"RTN","GMRCIAC1",137,0)
 D  ;send notifications
"RTN","GMRCIAC1",138,0)
 . I $P(^GMR(123,GMRCDA,12),U,5)="F" Q  ;filler only gets hist. SF
"RTN","GMRCIAC1",139,0)
 . N GMRCORTX
"RTN","GMRCIAC1",140,0)
 . S GMRCORTX=$S(GMRCISF="N":"No ",GMRCISF="Y":"",1:"Unknown ")
"RTN","GMRCIAC1",141,0)
 . S GMRCORTX=GMRCORTX_"Sig Findings for "_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIAC1",142,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA,0),U,2),GMRCORTX,GMRCDA,23,,1)
"RTN","GMRCIAC1",143,0)
 D  ;send appl ACK and unlock record
"RTN","GMRCIAC1",144,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AA")
"RTN","GMRCIAC1",145,0)
 K ^TMP("GMRCIS",$J)
"RTN","GMRCIAC1",146,0)
 Q
"RTN","GMRCIAC1",147,0)
 ;
"RTN","GMRCIAC1",148,0)
RESUB(GMRCAR) ;resubmit a cancelled, remote consult
"RTN","GMRCIAC1",149,0)
 ; Input:
"RTN","GMRCIAC1",150,0)
 ;   GMRCAR - array name containing message
"RTN","GMRCIAC1",151,0)
 ;      e.g.  ^TMP("GMRCIF",$J)
"RTN","GMRCIAC1",152,0)
 ;
"RTN","GMRCIAC1",153,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIAC1",154,0)
 M ^TMP("GMRCIN",$J)=@GMRCAR
"RTN","GMRCIAC1",155,0)
 N GMRCDA,GMRCFDA,FDA
"RTN","GMRCIAC1",156,0)
 S GMRCDA=$$GETDA^GMRCIAC2(^TMP("GMRCIN",$J,"ORC"))
"RTN","GMRCIAC1",157,0)
 I '$$LOCKREC^GMRCUTL1(GMRCDA) D  Q  ;couldn't lock record
"RTN","GMRCIAC1",158,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AR",901) ; send app. ACK
"RTN","GMRCIAC1",159,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIAC1",160,0)
 ;
"RTN","GMRCIAC1",161,0)
 S GMRCFDA(8)=5,GMRCFDA(9)=11 ;status and last action
"RTN","GMRCIAC1",162,0)
 ;
"RTN","GMRCIAC1",163,0)
 I $D(^TMP("GMRCIN",$J,"OBR")) D  ; has INPATIENT or OUTPATIENT changed?
"RTN","GMRCIAC1",164,0)
 . N GMRCION
"RTN","GMRCIAC1",165,0)
 . S GMRCION=$P(^TMP("GMRCIN",$J,"OBR"),"|",18)
"RTN","GMRCIAC1",166,0)
 . I GMRCION'=$P(^GMR(123,GMRCDA,0),U,18) S GMRCFDA(14)=GMRCION
"RTN","GMRCIAC1",167,0)
 . Q
"RTN","GMRCIAC1",168,0)
 D  ; check for change in urgency
"RTN","GMRCIAC1",169,0)
 . N GMRCURG
"RTN","GMRCIAC1",170,0)
 . S GMRCURG=$P($P(^TMP("GMRCIN",$J,"ORC"),"|",7),U,6)
"RTN","GMRCIAC1",171,0)
 . I '$L(GMRCURG) Q
"RTN","GMRCIAC1",172,0)
 . S GMRCURG=$$URG^GMRCHL7A(GMRCURG)
"RTN","GMRCIAC1",173,0)
 . S GMRCURG=$$FIND1^DIC(101,"","X","GMRCURGENCY - "_GMRCURG)
"RTN","GMRCIAC1",174,0)
 . I GMRCURG'>1 Q
"RTN","GMRCIAC1",175,0)
 . I GMRCURG=$P(^GMR(123,GMRCDA,0),U,9) Q  ;no change
"RTN","GMRCIAC1",176,0)
 . S GMRCFDA(5)=GMRCURG
"RTN","GMRCIAC1",177,0)
 . Q
"RTN","GMRCIAC1",178,0)
 D  ;check for change earliest date WAT/66
"RTN","GMRCIAC1",179,0)
 . N GMRCERDT
"RTN","GMRCIAC1",180,0)
 . S GMRCERDT=$P($P(^TMP("GMRCIN",$J,"ORC"),"|",7),U,4)
"RTN","GMRCIAC1",181,0)
 . I '$L(GMRCERDT) Q
"RTN","GMRCIAC1",182,0)
 . S GMRCERDT=$$FMDATE^GMRCHL7(GMRCERDT)
"RTN","GMRCIAC1",183,0)
 . I GMRCERDT=$P(^GMR(123,GMRCDA,0),U,24) Q  ;no change
"RTN","GMRCIAC1",184,0)
 . S GMRCFDA(17)=GMRCERDT
"RTN","GMRCIAC1",185,0)
 . Q
"RTN","GMRCIAC1",186,0)
 I $D(^TMP("GMRCIN",$J,"OBX",2)) D  ; change in Prov. DX?
"RTN","GMRCIAC1",187,0)
 . N PROVDX,GMRCDXDT,GMRCCSYS,CODINTXT
"RTN","GMRCIAC1",188,0)
 . S PROVDX=$P($P(^TMP("GMRCIN",$J,"OBX",2,1),"|",5),U,2)
"RTN","GMRCIAC1",189,0)
 . S GMRCDXDT=$P(^TMP("GMRCIN",$J,"OBX",2,1),"|",14) S GMRCDXDT=$$HL7TFM^XLFDT($G(GMRCDXDT))
"RTN","GMRCIAC1",190,0)
 . S GMRCCSYS=$P($P(^TMP("GMRCIN",$J,"OBX",2,1),"|",5),U,3)
"RTN","GMRCIAC1",191,0)
 . S GMRCCSYS=$S($G(GMRCCSYS)="I9C":"ICD",1:"10D")
"RTN","GMRCIAC1",192,0)
 . I '$L(PROVDX) Q
"RTN","GMRCIAC1",193,0)
 . I PROVDX'=$G(^GMR(123,GMRCDA,30)) D
"RTN","GMRCIAC1",194,0)
 .. S GMRCFDA(30)=PROVDX
"RTN","GMRCIAC1",195,0)
 .. S GMRCFDA(30.1)=$P($P(^TMP("GMRCIN",$J,"OBX",2,1),"|",5),U),CODINTXT="("_GMRCFDA(30.1)_")"
"RTN","GMRCIAC1",196,0)
 .. I GMRCFDA(30)[CODINTXT D
"RTN","GMRCIAC1",197,0)
 ... S GMRCFDA(30)=$E(GMRCFDA(30),0,($L(GMRCFDA(30))-$L(CODINTXT)))
"RTN","GMRCIAC1",198,0)
 ... S GMRCFDA(30)=$$TRIM^XLFSTR(GMRCFDA(30),"R")
"RTN","GMRCIAC1",199,0)
 . I $G(GMRCDXDT)'=""&($G(GMRCDXDT)'=$P($G(^GMR(123,GMRCDA,30.1)),U,2)) D
"RTN","GMRCIAC1",200,0)
 .. S:$D(^DD(123,30.2,0)) GMRCFDA(30.2)=$G(GMRCDXDT)
"RTN","GMRCIAC1",201,0)
 . I $G(GMRCCSYS)'=$P($G(^GMR(123,GMRCDA,30.1)),U,3) D
"RTN","GMRCIAC1",202,0)
 .. S:$D(^DD(123,30.3,0)) GMRCFDA(30.3)=$G(GMRCCSYS)
"RTN","GMRCIAC1",203,0)
 . Q
"RTN","GMRCIAC1",204,0)
 ;   v-- QUIT if a duplicate transmission
"RTN","GMRCIAC1",205,0)
 I $$DUPACT^GMRCIAC2(GMRCDA,11,^TMP("GMRCIN",$J,"ORC")) Q
"RTN","GMRCIAC1",206,0)
 ;
"RTN","GMRCIAC1",207,0)
 M FDA(1,123,GMRCDA_",")=GMRCFDA
"RTN","GMRCIAC1",208,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR") ;file edits
"RTN","GMRCIAC1",209,0)
 K GMRCFDA,FDA
"RTN","GMRCIAC1",210,0)
 ;
"RTN","GMRCIAC1",211,0)
 I $D(^TMP("GMRCIN",$J,"OBX",1)) D  ; reason for request change?
"RTN","GMRCIAC1",212,0)
 . D TRIMWP^GMRCIUTL($NA(^TMP("GMRCIN",$J,"OBX",1)),5)
"RTN","GMRCIAC1",213,0)
 . N DIFF S DIFF=0
"RTN","GMRCIAC1",214,0)
 . D  I 'DIFF Q
"RTN","GMRCIAC1",215,0)
 .. I $O(^TMP("GMRCIN",$J,"OBX",1," "),-1)'=$O(^GMR(123,GMRCDA,20," "),-1) S DIFF=1 Q  ;  diff # of lines in new and existing
"RTN","GMRCIAC1",216,0)
 .. N LN S LN=0 F  S LN=$O(^GMR(123,GMRCDA,20,LN)) Q:'LN!(DIFF)  D
"RTN","GMRCIAC1",217,0)
 ... I $G(^GMR(123,GMRCDA,20,LN,0))=$G(^TMP("GMRCIN",$J,"OBX",1,LN)) Q
"RTN","GMRCIAC1",218,0)
 ... S DIFF=1 ;if the lines aren't the same, set DIFF and Q
"RTN","GMRCIAC1",219,0)
 . D WP^DIE(123,GMRCDA_",",20,"K",$NA(^TMP("GMRCIN",$J,"OBX",1)))
"RTN","GMRCIAC1",220,0)
 . Q
"RTN","GMRCIAC1",221,0)
 D  ;file activity tracking
"RTN","GMRCIAC1",222,0)
 . D FILEACT^GMRCIAC2(GMRCDA,11,,$NA(^TMP("GMRCIN",$J)))
"RTN","GMRCIAC1",223,0)
 N GMRCNTIF
"RTN","GMRCIAC1",224,0)
 D  ;determine if part of a FWD to IFC
"RTN","GMRCIAC1",225,0)
 . I $P(^GMR(123,GMRCDA,40,1,0),U,2)'=24 S GMRCNTIF=1 Q
"RTN","GMRCIAC1",226,0)
 . N ACT S ACT=1
"RTN","GMRCIAC1",227,0)
 . S GMRCNTIF=0
"RTN","GMRCIAC1",228,0)
 . F  S ACT=$O(^GMR(123,GMRCDA,40,ACT)) Q:'ACT!($G(GMRCNTIF))  D
"RTN","GMRCIAC1",229,0)
 .. I ($P(^GMR(123,GMRCDA,40,ACT,0),U,2)=25),$O(^GMR(123,GMRCDA,40,ACT)) S GMRCNTIF=1 ;wat/66 Remedy 278355
"RTN","GMRCIAC1",230,0)
 ;
"RTN","GMRCIAC1",231,0)
 D  ;print SF-513 & send notifications
"RTN","GMRCIAC1",232,0)
 . I '$G(GMRCNTIF) Q  ;part of a FWD to IFC
"RTN","GMRCIAC1",233,0)
 . D PRNT^GMRCUTL1("",GMRCDA)
"RTN","GMRCIAC1",234,0)
 . N GMRCORTX
"RTN","GMRCIAC1",235,0)
 . S GMRCORTX="New remotely re-submitted consult "
"RTN","GMRCIAC1",236,0)
 . S GMRCORTX=GMRCORTX_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIAC1",237,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA,0),U,2),GMRCORTX,GMRCDA,27,,1)
"RTN","GMRCIAC1",238,0)
 ;
"RTN","GMRCIAC1",239,0)
 D  ;send appl ACK and unlock record
"RTN","GMRCIAC1",240,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AA")
"RTN","GMRCIAC1",241,0)
 ;
"RTN","GMRCIAC1",242,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIAC1",243,0)
 Q
"RTN","GMRCIAC1",244,0)
 ;
"RTN","GMRCIACT")
0^9^B68184742
"RTN","GMRCIACT",1,0)
GMRCIACT ;SLC/JFR - PROCESS ACTIONS ON IFC ;03/18/14  05:42
"RTN","GMRCIACT",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,47,58,66,73**;DEC 27, 1997;Build 22
"RTN","GMRCIACT",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","GMRCIACT",4,0)
 ;#2051($$FIND1^DIC), #2053(DIE), #2165 HLMA1, #2701 MPIF001, #10103 XLFDT, #3065 XLFNAME, #2171 XUAF4
"RTN","GMRCIACT",5,0)
 Q  ;don't start here!
"RTN","GMRCIACT",6,0)
NW(ARRAY) ;process and file new order
"RTN","GMRCIACT",7,0)
 ;Input:
"RTN","GMRCIACT",8,0)
 ; ARRAY  = name of array containing message parts
"RTN","GMRCIACT",9,0)
 ;
"RTN","GMRCIACT",10,0)
 N GMRCFDA,GMRCORC,GMRCDA,GMRCITM,GMRCITER,GMRCROUT,GMRCFCN,GMRCLAC
"RTN","GMRCIACT",11,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIACT",12,0)
 M ^TMP("GMRCIN",$J)=@ARRAY
"RTN","GMRCIACT",13,0)
 S GMRCORC=^TMP("GMRCIN",$J,"ORC")
"RTN","GMRCIACT",14,0)
 D  I $D(GMRCITER) Q  ;Check for order already being on file
"RTN","GMRCIACT",15,0)
 . S GMRCFCN=+$P(GMRCORC,"|",2)
"RTN","GMRCIACT",16,0)
 . S GMRCROUT=$$IEN^XUAF4($P($P(GMRCORC,"|",2),U,2))
"RTN","GMRCIACT",17,0)
 . I '$O(^GMR(123,"AIFC",GMRCROUT,GMRCFCN,0)) Q  ;no dup
"RTN","GMRCIACT",18,0)
 . S GMRCITER=802
"RTN","GMRCIACT",19,0)
 . D APPACK^GMRCIAC2(0,"AR",GMRCITER) ;send app. ack w/ error
"RTN","GMRCIACT",20,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIACT",21,0)
 I '$D(^TMP("GMRCIN",$J,"PID")) Q  ;prepare reject message (no PID)
"RTN","GMRCIACT",22,0)
 D  ;get patient DFN from ICN in message
"RTN","GMRCIACT",23,0)
 . N PAT
"RTN","GMRCIACT",24,0)
 . S PAT=$$GETDFN^MPIF001(+$P(^TMP("GMRCIN",$J,"PID"),"|",2))
"RTN","GMRCIACT",25,0)
 . I +PAT'>1 S GMRCFDA(.02)="" Q
"RTN","GMRCIACT",26,0)
 . S GMRCFDA(.02)=+PAT
"RTN","GMRCIACT",27,0)
 I '$G(GMRCFDA(.02)) D  Q  ;reject message, patient is unknown
"RTN","GMRCIACT",28,0)
 . N STA S STA=$P($P(^TMP("GMRCIN",$J,"ORC"),"|",2),U,2)
"RTN","GMRCIACT",29,0)
 . N OBR S OBR=^TMP("GMRCIN",$J,"OBR")
"RTN","GMRCIACT",30,0)
 . D PTERRMSG^GMRCIERR(^TMP("GMRCIN",$J,"PID"),STA,,OBR)
"RTN","GMRCIACT",31,0)
 . D APPACK^GMRCIAC2(0,"AR",201) ; send app. ack w/error
"RTN","GMRCIACT",32,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIACT",33,0)
 D  ;get ordered item and service
"RTN","GMRCIACT",34,0)
 . S GMRCITM=$P(^TMP("GMRCIN",$J,"OBR"),"|",4)
"RTN","GMRCIACT",35,0)
 . I GMRCITM["VA1233" D  ; proc
"RTN","GMRCIACT",36,0)
 .. N PROC
"RTN","GMRCIACT",37,0)
 .. S PROC=$$GETPROC^GMRCIUTL(GMRCITM)
"RTN","GMRCIACT",38,0)
 .. I +PROC'>0!('$P(PROC,U,2)) S GMRCITER=$P(PROC,U,3) Q
"RTN","GMRCIACT",39,0)
 .. S GMRCFDA(4)=$P(PROC,U)_";GMR(123.3,"
"RTN","GMRCIACT",40,0)
 .. S GMRCFDA(1)=$P(PROC,U,2)
"RTN","GMRCIACT",41,0)
 . I GMRCITM["VA1235" D
"RTN","GMRCIACT",42,0)
 .. N SERV
"RTN","GMRCIACT",43,0)
 .. S SERV=$$GETSERV^GMRCIUTL(GMRCITM) ;consult
"RTN","GMRCIACT",44,0)
 .. I +SERV'>0 S GMRCITER=$P(SERV,U,3)
"RTN","GMRCIACT",45,0)
 .. S GMRCFDA(1)=SERV
"RTN","GMRCIACT",46,0)
 I $D(GMRCITER) D  Q  ;error in procedure or service, reject new order
"RTN","GMRCIACT",47,0)
 . D APPACK^GMRCIAC2(0,"AR",GMRCITER) ; send app. ACK
"RTN","GMRCIACT",48,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIACT",49,0)
 ;
"RTN","GMRCIACT",50,0)
 S GMRCFDA(.01)=$$NOW^XLFDT
"RTN","GMRCIACT",51,0)
 S GMRCFDA(3)=$$HL7TFM^XLFDT($P(GMRCORC,"|",15))
"RTN","GMRCIACT",52,0)
 S GMRCFDA(6)=$$FIND1^DIC(101,"","X","GMRCPLACE - ON CALL")
"RTN","GMRCIACT",53,0)
 S GMRCFDA(17)=$$HL7TFM^XLFDT($P($P(GMRCORC,"|",7),U,4)) ;WAT/66 Earliest Date
"RTN","GMRCIACT",54,0)
 D  ;get urgency to file
"RTN","GMRCIACT",55,0)
 . N URG
"RTN","GMRCIACT",56,0)
 . S URG=$$URG^GMRCHL7A($P($P(GMRCORC,"|",7),U,6))
"RTN","GMRCIACT",57,0)
 . S GMRCFDA(5)=$$FIND1^DIC(101,"","X","GMRCURGENCY - "_URG)
"RTN","GMRCIACT",58,0)
 S GMRCFDA(8)=5
"RTN","GMRCIACT",59,0)
 S GMRCFDA(9)=$S($P(GMRCORC,"|",16)["FI":24,1:23),GMRCLAC=GMRCFDA(9)
"RTN","GMRCIACT",60,0)
 S GMRCFDA(14)=$P(^TMP("GMRCIN",$J,"OBR"),"|",18)
"RTN","GMRCIACT",61,0)
 S GMRCFDA(.05)=$$IEN^XUAF4(+$P(GMRCORC,"|",17))
"RTN","GMRCIACT",62,0)
 S GMRCFDA(.06)=GMRCFCN
"RTN","GMRCIACT",63,0)
 S GMRCFDA(.07)=GMRCROUT
"RTN","GMRCIACT",64,0)
 D  ;get and set ordering prov info & entering person info
"RTN","GMRCIACT",65,0)
 . N GMRCOP
"RTN","GMRCIACT",66,0)
 . S GMRCOP=$$FMNAME^XLFNAME($P(GMRCORC,"|",12))
"RTN","GMRCIACT",67,0)
 . Q:'$L(GMRCOP)
"RTN","GMRCIACT",68,0)
 . S GMRCFDA(.126)=GMRCOP
"RTN","GMRCIACT",69,0)
 . Q
"RTN","GMRCIACT",70,0)
 S GMRCFDA(.125)="F"
"RTN","GMRCIACT",71,0)
 I $L($P(GMRCORC,"|",14)) D
"RTN","GMRCIACT",72,0)
 . N GMRCP14 S GMRCP14=$P(GMRCORC,"|",14)
"RTN","GMRCIACT",73,0)
 . S GMRCFDA(.132)=$P(GMRCP14,"B") ; requestor's phone number
"RTN","GMRCIACT",74,0)
 . S GMRCFDA(.133)=$P(GMRCP14,"B",2) ; requestor's dig pager
"RTN","GMRCIACT",75,0)
 S GMRCFDA(13)=$S($D(GMRCFDA(4)):"P",1:"C")
"RTN","GMRCIACT",76,0)
 I $D(^TMP("GMRCIN",$J,"OBX",2)) D
"RTN","GMRCIACT",77,0)
 . N GMRCCSYS,CODINTXT
"RTN","GMRCIACT",78,0)
 . S GMRCFDA(30)=$P($P(^TMP("GMRCIN",$J,"OBX",2,1),"|",5),U,2)
"RTN","GMRCIACT",79,0)
 . S GMRCFDA(30.1)=$P($P(^TMP("GMRCIN",$J,"OBX",2,1),"|",5),U)
"RTN","GMRCIACT",80,0)
 . S GMRCFDA(30.2)=$$HL7TFM^XLFDT($P($P(^TMP("GMRCIN",$J,"OBX",2,1),"|",14),U)) ;date OBX-14 WAT/73
"RTN","GMRCIACT",81,0)
 . S GMRCCSYS=$P($P(^TMP("GMRCIN",$J,"OBX",2,1),"|",5),U,3) ;code system WAT/73
"RTN","GMRCIACT",82,0)
 . S GMRCCSYS=$S($G(GMRCCSYS)="I9C":"ICD",1:"10D")
"RTN","GMRCIACT",83,0)
 . S GMRCFDA(30.3)=GMRCCSYS
"RTN","GMRCIACT",84,0)
 . I $D(GMRCFDA(30.1)) D  ;if dx code exists, ensure that code is removed from dx text
"RTN","GMRCIACT",85,0)
 .. S CODINTXT="("_GMRCFDA(30.1)_")"
"RTN","GMRCIACT",86,0)
 .. I GMRCFDA(30)[CODINTXT D
"RTN","GMRCIACT",87,0)
 ... S GMRCFDA(30)=$E(GMRCFDA(30),0,($L(GMRCFDA(30))-$L(CODINTXT)))
"RTN","GMRCIACT",88,0)
 ... S GMRCFDA(30)=$$TRIM^XLFSTR(GMRCFDA(30),"R")
"RTN","GMRCIACT",89,0)
 M FDA(1,123,"+1,")=GMRCFDA
"RTN","GMRCIACT",90,0)
 D UPDATE^DIE("","FDA(1)","GMRCDA","GMRCERR")
"RTN","GMRCIACT",91,0)
 I '$D(GMRCDA) D  Q  ;couldn't get new consult #
"RTN","GMRCIACT",92,0)
 . D APPACK^GMRCIAC2(0,"AR",901) ; send app. ACK
"RTN","GMRCIACT",93,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIACT",94,0)
 K GMRCFDA,FDA
"RTN","GMRCIACT",95,0)
 D  ; file reason for request
"RTN","GMRCIACT",96,0)
 . D TRIMWP^GMRCIUTL($NA(^TMP("GMRCIN",$J,"OBX",1)),5)
"RTN","GMRCIACT",97,0)
 . D WP^DIE(123,GMRCDA(1)_",",20,"K",$NA(^TMP("GMRCIN",$J,"OBX",1)))
"RTN","GMRCIACT",98,0)
 . Q
"RTN","GMRCIACT",99,0)
 D  ;file activity tracking
"RTN","GMRCIACT",100,0)
 . N GMRCSEG
"RTN","GMRCIACT",101,0)
 . S GMRCSEG("ORC")=GMRCORC
"RTN","GMRCIACT",102,0)
 . S GMRCSEG("OBX",5,1)=^TMP("GMRCIN",$J,"OBX",5,1)
"RTN","GMRCIACT",103,0)
 . D FILEACT^GMRCIAC2(GMRCDA(1),GMRCLAC,,"GMRCSEG")
"RTN","GMRCIACT",104,0)
 D  ;print SF-513
"RTN","GMRCIACT",105,0)
 . I GMRCLAC=24 Q  ;don't print if part of a FWD to IFC
"RTN","GMRCIACT",106,0)
 . D PRNT^GMRCUTL1("",GMRCDA(1))
"RTN","GMRCIACT",107,0)
 D  ;send notifications
"RTN","GMRCIACT",108,0)
 . I GMRCLAC=24 Q  ;no alerts yet if part of FWD to IFC
"RTN","GMRCIACT",109,0)
 . N GMRCORTX
"RTN","GMRCIACT",110,0)
 . S GMRCORTX="New remotely ordered consult "_$$ORTX^GMRCAU(+GMRCDA(1))
"RTN","GMRCIACT",111,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA(1),0),U,2),GMRCORTX,GMRCDA(1),27,,1)
"RTN","GMRCIACT",112,0)
 D  ;send appl ack :-(
"RTN","GMRCIACT",113,0)
 . N GMRCRSLT
"RTN","GMRCIACT",114,0)
 . D RESP^GMRCIUTL("AA",HL("MID"),$P(GMRCORC,"|"),GMRCDA(1))
"RTN","GMRCIACT",115,0)
 . D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.GMRCRSLT)
"RTN","GMRCIACT",116,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIACT",117,0)
 Q
"RTN","GMRCIACT",118,0)
 ;
"RTN","GMRCIACT",119,0)
DIS(GMRCAR) ;dis-associate a result from a remote request
"RTN","GMRCIACT",120,0)
 ;Input:
"RTN","GMRCIACT",121,0)
 ; GMRCAR = array name containing message
"RTN","GMRCIACT",122,0)
 ;      e.g.  ^TMP("GMRCIF",$J)
"RTN","GMRCIACT",123,0)
 N GMRCDA,GMRCFDA,FDA,GMRCERR,GMRCORC
"RTN","GMRCIACT",124,0)
 M ^TMP("GMRCID",$J)=@GMRCAR
"RTN","GMRCIACT",125,0)
 S GMRCORC=^TMP("GMRCID",$J,"ORC")
"RTN","GMRCIACT",126,0)
 S GMRCDA=$$GETDA^GMRCIAC2(GMRCORC)
"RTN","GMRCIACT",127,0)
 I '$$LOCKREC^GMRCUTL1(GMRCDA) D  Q  ;couldn't lock record
"RTN","GMRCIACT",128,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AR",901) ;send app. ACK
"RTN","GMRCIACT",129,0)
 . K ^TMP("GMRCID",$J) Q
"RTN","GMRCIACT",130,0)
 ;    v--check to see if a dup transmission
"RTN","GMRCIACT",131,0)
 I $$DUPACT^GMRCIAC2(GMRCDA,12,GMRCORC,^TMP("GMRCID",$J,"OBX",4,1)) Q
"RTN","GMRCIACT",132,0)
 ;
"RTN","GMRCIACT",133,0)
 D FILEACT^GMRCIAC2(GMRCDA,12,,$NA(^TMP("GMRCID",$J))) ; act. tracking
"RTN","GMRCIACT",134,0)
 D FILRES^GMRCIAC2(GMRCDA,^TMP("GMRCID",$J,"OBX",4,1)) ;file results
"RTN","GMRCIACT",135,0)
 K GMRCERR,FDA,GMRCFDA
"RTN","GMRCIACT",136,0)
 I $$STSCHG^GMRCDIS(GMRCDA) S FDA(1,123,GMRCDA_",",8)=6
"RTN","GMRCIACT",137,0)
 S FDA(1,123,GMRCDA_",",9)=12
"RTN","GMRCIACT",138,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR") ;file last action and status
"RTN","GMRCIACT",139,0)
 D  ;send notifications
"RTN","GMRCIACT",140,0)
 . I $P(^GMR(123,GMRCDA,12),U,5)="F" Q  ;DIS from placer before IFC
"RTN","GMRCIACT",141,0)
 . N GMRCORTX
"RTN","GMRCIACT",142,0)
 . S GMRCORTX="Remote result removed from "_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIACT",143,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA,0),U,2),GMRCORTX,GMRCDA,63,,1)
"RTN","GMRCIACT",144,0)
 D  ;send appl ACK
"RTN","GMRCIACT",145,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AA") ; send app. ACK and unlock record
"RTN","GMRCIACT",146,0)
 K ^TMP("GMRCID",$J)
"RTN","GMRCIACT",147,0)
 Q
"RTN","GMRCIACT",148,0)
 ;
"RTN","GMRCIACT",149,0)
OTHER(GMRCAR) ;process most IFC actions
"RTN","GMRCIACT",150,0)
 ;will process the receive, schedule, DC, cancel and added comment action
"RTN","GMRCIACT",151,0)
 ;
"RTN","GMRCIACT",152,0)
 ;Input:
"RTN","GMRCIACT",153,0)
 ; GMRCAR = array name containing message
"RTN","GMRCIACT",154,0)
 ;      e.g.  ^TMP("GMRCIF",$J)
"RTN","GMRCIACT",155,0)
 ;
"RTN","GMRCIACT",156,0)
 N GMRCDA,GMRCFDA,GMRCORC,GMRCLAT,GMRCACT,GMRCROL,FDA
"RTN","GMRCIACT",157,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIACT",158,0)
 M ^TMP("GMRCIN",$J)=@GMRCAR
"RTN","GMRCIACT",159,0)
 ;
"RTN","GMRCIACT",160,0)
 S GMRCORC=^TMP("GMRCIN",$J,"ORC")
"RTN","GMRCIACT",161,0)
 S GMRCDA=$$GETDA^GMRCIAC2(GMRCORC)  ;get ien to work on
"RTN","GMRCIACT",162,0)
 S GMRCROL=$P(^GMR(123,GMRCDA,12),U,5)
"RTN","GMRCIACT",163,0)
 I '$$LOCKREC^GMRCUTL1(GMRCDA) D  Q  ;couldn't lock record
"RTN","GMRCIACT",164,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AR",901) ; send app. ACK
"RTN","GMRCIACT",165,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIACT",166,0)
 ;
"RTN","GMRCIACT",167,0)
 I $P(GMRCORC,"|")'="IP" D  ; status update
"RTN","GMRCIACT",168,0)
 . N GMRCOS S GMRCOS=$P(GMRCORC,"|",5)
"RTN","GMRCIACT",169,0)
 . S GMRCFDA(8)=$S(GMRCOS="IP":6,GMRCOS="SC":8,GMRCOS="CA":13,1:1)
"RTN","GMRCIACT",170,0)
 . ; IP=receive, SC=schedule, CA=cancel, DC=discontinue
"RTN","GMRCIACT",171,0)
 D  ; get last action taken
"RTN","GMRCIACT",172,0)
 . I '$G(GMRCFDA(8)) S (GMRCFDA(9),GMRCLAT)=20 Q
"RTN","GMRCIACT",173,0)
 . I GMRCFDA(8)=6 S (GMRCFDA(9),GMRCLAT)=21 Q
"RTN","GMRCIACT",174,0)
 . I GMRCFDA(8)=8 S (GMRCFDA(9),GMRCLAT)=8 Q
"RTN","GMRCIACT",175,0)
 . I GMRCFDA(8)=1 S (GMRCFDA(9),GMRCLAT)=6 Q
"RTN","GMRCIACT",176,0)
 . I GMRCFDA(8)=13 S (GMRCFDA(9),GMRCLAT)=19 Q
"RTN","GMRCIACT",177,0)
 ;                         ^--last action taken
"RTN","GMRCIACT",178,0)
 ;    v-- check to see if a dup transmission
"RTN","GMRCIACT",179,0)
 I $$DUPACT^GMRCIAC2(GMRCDA,GMRCLAT,GMRCORC) Q
"RTN","GMRCIACT",180,0)
 ;
"RTN","GMRCIACT",181,0)
 M FDA(1,123,GMRCDA_",")=GMRCFDA
"RTN","GMRCIACT",182,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR") ;file last action and update status
"RTN","GMRCIACT",183,0)
 K GMRCFDA
"RTN","GMRCIACT",184,0)
 D FILEACT^GMRCIAC2(GMRCDA,GMRCLAT,,$NA(^TMP("GMRCIN",$J)))
"RTN","GMRCIACT",185,0)
 D  ;send notifications
"RTN","GMRCIACT",186,0)
 . N GMRCTX,GMRCNOT,GMRCFL
"RTN","GMRCIACT",187,0)
 . S GMRCFL=1
"RTN","GMRCIACT",188,0)
 . I GMRCLAT=20!(GMRCLAT=8)!(GMRCLAT=21) D
"RTN","GMRCIACT",189,0)
 .. I GMRCLAT=20 D  I '$D(GMRCTX) Q
"RTN","GMRCIACT",190,0)
 ... I $P(^GMR(123,GMRCDA,40,1,0),U,2)'=24 D  Q
"RTN","GMRCIACT",191,0)
 .... S GMRCTX="Comment Added to remote"
"RTN","GMRCIACT",192,0)
 ... N ACT S ACT=1
"RTN","GMRCIACT",193,0)
 ... F  S ACT=$O(^GMR(123,GMRCDA,40,ACT)) Q:'ACT!($D(GMRCTX))  D
"RTN","GMRCIACT",194,0)
 .... I $P(^GMR(123,GMRCDA,40,ACT,0),U,2)=25,$O(^GMR(123,GMRCDA,40,ACT)) D
"RTN","GMRCIACT",195,0)
 ..... S GMRCTX="Comment Added to remote"
"RTN","GMRCIACT",196,0)
 .. I '$D(GMRCTX),GMRCROL="F" Q  ;sch & rec on filler part of FWD 2 IFC
"RTN","GMRCIACT",197,0)
 .. I GMRCLAT=8 S GMRCTX="Scheduled remote"
"RTN","GMRCIACT",198,0)
 .. I GMRCLAT=21 S GMRCTX="Received remote"
"RTN","GMRCIACT",199,0)
 .. S GMRCTX=GMRCTX_" Consult: "_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIACT",200,0)
 .. S GMRCNOT=63
"RTN","GMRCIACT",201,0)
 . I GMRCLAT=6 D
"RTN","GMRCIACT",202,0)
 .. S GMRCFL=$$DCNOTE^GMRCADC(GMRCDA,.5)
"RTN","GMRCIACT",203,0)
 .. S GMRCTX="Discontinued remote Consult: "_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIACT",204,0)
 .. S GMRCNOT=23
"RTN","GMRCIACT",205,0)
 . I GMRCLAT=19 D
"RTN","GMRCIACT",206,0)
 .. I GMRCROL="F" Q  ;canc on a filler is part of FWD 2 IFC
"RTN","GMRCIACT",207,0)
 .. S GMRCTX="Cancelled remote Consult: "_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIACT",208,0)
 .. S GMRCNOT=30
"RTN","GMRCIACT",209,0)
 . I '$D(GMRCNOT) Q  ;don't send any alerts
"RTN","GMRCIACT",210,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA,0),U,2),GMRCTX,GMRCDA,GMRCNOT,,GMRCFL)
"RTN","GMRCIACT",211,0)
 ;
"RTN","GMRCIACT",212,0)
 D  ;send appl ACK
"RTN","GMRCIACT",213,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AA") ;send app. ACK and unlock record
"RTN","GMRCIACT",214,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIACT",215,0)
 Q
"RTN","GMRCIACT",216,0)
 ;
"RTN","GMRCISG1")
0^10^B31718858
"RTN","GMRCISG1",1,0)
GMRCISG1 ;SLC/JFR - BUILD IFC HL7 SEGMENTS CONT'D ;03/24/14  13:27
"RTN","GMRCISG1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,66,73**;DEC 27, 1997;Build 22
"RTN","GMRCISG1",3,0)
 ;#2171 XUAF4, #10103 XLFDT, #10106 HLFNC, #10112 VASITE, #2541 $$KSP^XUPARAM, #2056(GET1^DIQ)
"RTN","GMRCISG1",4,0)
 ;
"RTN","GMRCISG1",5,0)
 Q  ;can't start here
"RTN","GMRCISG1",6,0)
ORCRESP(GMRCO,GMRCOC,GMRCOS) ;build ORC for app ACK msgs
"RTN","GMRCISG1",7,0)
 ; Input:
"RTN","GMRCISG1",8,0)
 ;  GMRCO   = ien from file 123 of entry responding to
"RTN","GMRCISG1",9,0)
 ;  GMRCOC  = order control to put into segment
"RTN","GMRCISG1",10,0)
 ;  GMRCOS  = HL7 encoded order status to put in message
"RTN","GMRCISG1",11,0)
 ;
"RTN","GMRCISG1",12,0)
 ; Output:
"RTN","GMRCISG1",13,0)
 ;  ORC segment to use in response message
"RTN","GMRCISG1",14,0)
 ;
"RTN","GMRCISG1",15,0)
 N GMRCPCS,SITE
"RTN","GMRCISG1",16,0)
 S GMRCPCS(1)=GMRCOC
"RTN","GMRCISG1",17,0)
 S GMRCPCS(2)=$P(^GMR(123,GMRCO,0),U,22)_U_$$STA^XUAF4($P(^(0),U,23))_"^GMRCIFR"
"RTN","GMRCISG1",18,0)
 S GMRCPCS(3)=GMRCO_U_$$STA^XUAF4($$KSP^XUPARAM("INST"))_"^GMRCIFC"
"RTN","GMRCISG1",19,0)
 S GMRCPCS(5)=$G(GMRCOS)
"RTN","GMRCISG1",20,0)
 S GMRCPCS(17)=$$STA^XUAF4($$KSP^XUPARAM("INST"))
"RTN","GMRCISG1",21,0)
 Q $$BUILD^GMRCISEG("ORC",.GMRCPCS)
"RTN","GMRCISG1",22,0)
 ;
"RTN","GMRCISG1",23,0)
NWORC(GMRCO) ; build ORC seg for a new order
"RTN","GMRCISG1",24,0)
 ; Input:
"RTN","GMRCISG1",25,0)
 ;  GMRCO = ien from file 123 of order to send remotely
"RTN","GMRCISG1",26,0)
 ;
"RTN","GMRCISG1",27,0)
 ; Output:
"RTN","GMRCISG1",28,0)
 ;  ORC segment to send with a new order to remote facility
"RTN","GMRCISG1",29,0)
 ;
"RTN","GMRCISG1",30,0)
 N GMRCPCS,SITE,GMRCPHN,GMRCPAG
"RTN","GMRCISG1",31,0)
 S GMRCPCS(1)="NW"
"RTN","GMRCISG1",32,0)
 S GMRCPCS(2)=GMRCO_U_$$STA^XUAF4($$KSP^XUPARAM("INST"))_U_"GMRCIFR"
"RTN","GMRCISG1",33,0)
 S $P(GMRCPCS(7),U,4)=$$FMTHL7^XLFDT($P(^GMR(123,GMRCO,0),U,24)) ;wat/66
"RTN","GMRCISG1",34,0)
 S $P(GMRCPCS(7),U,6)=$$URG^GMRCIUTL(GMRCO)
"RTN","GMRCISG1",35,0)
 S GMRCPCS(9)=$$FMTHL7^XLFDT(+^GMR(123,GMRCO,0))
"RTN","GMRCISG1",36,0)
 S GMRCPCS(10)=$$HLNAME^GMRCIUTL($P($G(^GMR(123,GMRCO,40,1,0)),U,5))
"RTN","GMRCISG1",37,0)
 S GMRCPCS(12)=$$HLNAME^GMRCIUTL($P(^GMR(123,GMRCO,0),U,14))
"RTN","GMRCISG1",38,0)
 S GMRCPHN=$$GET1^DIQ(200,$P(^GMR(123,GMRCO,0),U,14),.132)
"RTN","GMRCISG1",39,0)
 S GMRCPAG=$$GET1^DIQ(200,$P(^GMR(123,GMRCO,0),U,14),.138)
"RTN","GMRCISG1",40,0)
 S GMRCPCS(14)=$$HLPHONE^HLFNC(GMRCPHN,GMRCPAG)
"RTN","GMRCISG1",41,0)
 S GMRCPCS(15)=$$FMTHL7^XLFDT($P(^GMR(123,GMRCO,0),U,7))
"RTN","GMRCISG1",42,0)
 I $O(^GMR(123,GMRCO,40,1)) D
"RTN","GMRCISG1",43,0)
 . N I,ACTV S I=1
"RTN","GMRCISG1",44,0)
 . F  S I=$O(^GMR(123,GMRCO,40,I)) Q:'I  S ACTV=$P(^(I,0),U,2) D
"RTN","GMRCISG1",45,0)
 .. I ACTV'=25 Q
"RTN","GMRCISG1",46,0)
 .. S GMRCPCS(16)="FI^FORWARD TO IFC^99GMRC"
"RTN","GMRCISG1",47,0)
 S SITE=$$SITE^VASITE
"RTN","GMRCISG1",48,0)
 I +SITE S GMRCPCS(17)=$P(SITE,U,3)_U_$P(SITE,U,2) ;use loc instead? ;-(
"RTN","GMRCISG1",49,0)
 Q $$BUILD^GMRCISEG("ORC",.GMRCPCS)
"RTN","GMRCISG1",50,0)
OBXPD(GMRCO) ; create OBX segment for the prov. dx
"RTN","GMRCISG1",51,0)
 ; Input:
"RTN","GMRCISG1",52,0)
 ;  GMRCO  = ien from file 123 of order to send remotely
"RTN","GMRCISG1",53,0)
 ;
"RTN","GMRCISG1",54,0)
 ; Output:
"RTN","GMRCISG1",55,0)
 ;  OBX segment containing the Provisional Diagnosis
"RTN","GMRCISG1",56,0)
 ;
"RTN","GMRCISG1",57,0)
 Q:'$L($G(^GMR(123,GMRCO,30))) ""
"RTN","GMRCISG1",58,0)
 N GMRCPCS,GMRCCODE,GMRCSYS
"RTN","GMRCISG1",59,0)
 S GMRCPCS(1)=2,GMRCPCS(2)=$S($L($G(^GMR(123,GMRCO,30.1))):"CE",1:"TX")
"RTN","GMRCISG1",60,0)
 S GMRCPCS(3)="^PROVISIONAL DIAGNOSIS^",GMRCPCS(4)=1
"RTN","GMRCISG1",61,0)
 S GMRCPCS(11)="O"
"RTN","GMRCISG1",62,0)
 I $L($G(^GMR(123,GMRCO,30.1))) D  Q $$BUILD^GMRCISEG("OBX",.GMRCPCS)
"RTN","GMRCISG1",63,0)
 . ;coded diagnosis
"RTN","GMRCISG1",64,0)
 . S GMRCCODE=$P(^GMR(123,GMRCO,30.1),U,1) ;WAT/73
"RTN","GMRCISG1",65,0)
 . S GMRCSYS=$P(^GMR(123,GMRCO,30.1),U,3) S GMRCSYS=$S($G(GMRCSYS)="ICD":"I9C",$G(GMRCSYS)="10D":"I10",1:"") ;WAT/73
"RTN","GMRCISG1",66,0)
 . ;GMRCPCS(5) keep ICD code as part of dx text for correct dx display in 513 and Details at sites not testing patch 73
"RTN","GMRCISG1",67,0)
 . S GMRCPCS(5)=$G(GMRCCODE)_U_$G(^(30))_" ("_$G(GMRCCODE)_")"_U_GMRCSYS
"RTN","GMRCISG1",68,0)
 . S GMRCPCS(14)=$$FMTHL7^XLFDT($P(^GMR(123,GMRCO,30.1),U,2)) ;WAT/73
"RTN","GMRCISG1",69,0)
 S GMRCPCS(5)=U_$G(^GMR(123,GMRCO,30))_U ;free text dx
"RTN","GMRCISG1",70,0)
 Q $$BUILD^GMRCISEG("OBX",.GMRCPCS)
"RTN","GMRCISG1",71,0)
 ;
"RTN","GMRCISG1",72,0)
OBR(GMRCO,GMRCACT) ; build an OBR seg for new order or resubmit
"RTN","GMRCISG1",73,0)
 ; Input:
"RTN","GMRCISG1",74,0)
 ;  GMRCO   = ien from file 123
"RTN","GMRCISG1",75,0)
 ;  GMRCACT = ien from 40 multiple of action (only on resubmit or fwd)
"RTN","GMRCISG1",76,0)
 ;
"RTN","GMRCISG1",77,0)
 ; Output:
"RTN","GMRCISG1",78,0)
 ;  OBR segment
"RTN","GMRCISG1",79,0)
 ;
"RTN","GMRCISG1",80,0)
 N GMRCPCS,GMRCROL
"RTN","GMRCISG1",81,0)
 S GMRCPCS(1)=1
"RTN","GMRCISG1",82,0)
 S GMRCROL=$P(^GMR(123,GMRCO,12),U,5)
"RTN","GMRCISG1",83,0)
 I GMRCROL="P" D
"RTN","GMRCISG1",84,0)
 . S GMRCPCS(2)=GMRCO_U_$$STA^XUAF4($$KSP^XUPARAM("INST"))_U_"GMRCIFR"
"RTN","GMRCISG1",85,0)
 I $D(GMRCACT) D  ;  resubmit sends filler # too
"RTN","GMRCISG1",86,0)
 . I GMRCROL="P" D
"RTN","GMRCISG1",87,0)
 .. S GMRCPCS(3)=$P(^GMR(123,GMRCO,0),U,22)_U_$$STA^XUAF4($P(^(0),U,23))
"RTN","GMRCISG1",88,0)
 .. S GMRCPCS(3)=GMRCPCS(3)_U_"GMRCIFC"
"RTN","GMRCISG1",89,0)
 . I GMRCROL="F" D
"RTN","GMRCISG1",90,0)
 .. S GMRCPCS(2)=$P(^GMR(123,GMRCO,0),U,22)_U_$$STA^XUAF4($P(^(0),U,23))
"RTN","GMRCISG1",91,0)
 .. S GMRCPCS(2)=GMRCPCS(2)_U_"GMRCIFR"
"RTN","GMRCISG1",92,0)
 .. S GMRCPCS(3)=GMRCO_U_$$STA^XUAF4($$KSP^XUPARAM("INST"))_U_"GMRCIFC"
"RTN","GMRCISG1",93,0)
 I $D(GMRCACT),$P(^GMR(123,GMRCO,40,GMRCACT,0),U,2)=17 D
"RTN","GMRCISG1",94,0)
 . ;FWD uses txt of current svc
"RTN","GMRCISG1",95,0)
 . N SITE,SERVNM,SERV
"RTN","GMRCISG1",96,0)
 . S SITE=$$STA^XUAF4($$KSP^XUPARAM("INST"))_"VA1235"
"RTN","GMRCISG1",97,0)
 . I GMRCROL="F" S SERV=$P(^GMR(123,GMRCO,0),U,5)
"RTN","GMRCISG1",98,0)
 . I GMRCROL="P" S SERV=$P(^GMR(123,GMRCO,40,GMRCACT,0),U,6)
"RTN","GMRCISG1",99,0)
 . S SERVNM=$S(+SERV:$P(^GMR(123.5,SERV,0),U),1:"")
"RTN","GMRCISG1",100,0)
 . S GMRCPCS(4)=SERV_U_SERVNM_U_SITE
"RTN","GMRCISG1",101,0)
 I $D(GMRCACT),$P(^GMR(123,GMRCO,40,GMRCACT,0),U,2)=25 D
"RTN","GMRCISG1",102,0)
 . ;FWD to IFC uses the FORWARDED FROM service name
"RTN","GMRCISG1",103,0)
 . N SITE,SERVNM,SERV
"RTN","GMRCISG1",104,0)
 . S SITE=$$STA^XUAF4($$KSP^XUPARAM("INST"))_"VA1235"
"RTN","GMRCISG1",105,0)
 . S SERV=$P(^GMR(123,GMRCO,40,GMRCACT,0),U,6)
"RTN","GMRCISG1",106,0)
 . I '+SERV Q
"RTN","GMRCISG1",107,0)
 . S SERVNM=$P(^GMR(123.5,SERV,0),U)
"RTN","GMRCISG1",108,0)
 . S GMRCPCS(4)=SERV_U_SERVNM_U_SITE
"RTN","GMRCISG1",109,0)
 I '$D(GMRCPCS(4)) D
"RTN","GMRCISG1",110,0)
 . S GMRCPCS(4)=$$CODEOI^GMRCIUTL(GMRCO) ;get remote service or proc
"RTN","GMRCISG1",111,0)
 I $D(GMRCACT) D  ;resubmit or fwd so use activity fields for msg
"RTN","GMRCISG1",112,0)
 . S GMRCPCS(6)=$$FMTHL7^XLFDT($P(^GMR(123,GMRCO,40,GMRCACT,0),U,3))
"RTN","GMRCISG1",113,0)
 . S GMRCPCS(16)=$$HLNAME^GMRCIUTL($P(^GMR(123,GMRCO,40,GMRCACT,0),U,4))
"RTN","GMRCISG1",114,0)
 I '$D(GMRCACT) D  ; new order being sent
"RTN","GMRCISG1",115,0)
 . S GMRCPCS(6)=$$FMTHL7^XLFDT($P(^GMR(123,GMRCO,0),U,7))
"RTN","GMRCISG1",116,0)
 . S GMRCPCS(16)=$$HLNAME^GMRCIUTL($P(^GMR(123,GMRCO,0),U,14))
"RTN","GMRCISG1",117,0)
 S GMRCPCS(18)=$P(^GMR(123,GMRCO,0),U,18)
"RTN","GMRCISG1",118,0)
 Q $$BUILD^GMRCISEG("OBR",.GMRCPCS)
"RTN","GMRCISG1",119,0)
 ;
"RTN","GMRCISG1",120,0)
ORCTST() ;build ORC for testing imp.
"RTN","GMRCISG1",121,0)
 ;Input:
"RTN","GMRCISG1",122,0)
 ;
"RTN","GMRCISG1",123,0)
 ;Output:
"RTN","GMRCISG1",124,0)
 ; ORC segment used to test IFC implementation
"RTN","GMRCISG1",125,0)
 ;
"RTN","GMRCISG1",126,0)
 N GMRCPCS,SITE,GMRCRP
"RTN","GMRCISG1",127,0)
 S GMRCPCS(1)="NW"
"RTN","GMRCISG1",128,0)
 S GMRCPCS(2)="TST1234"_U_$$STA^XUAF4($$KSP^XUPARAM("INST"))_"^GMRCIFR"
"RTN","GMRCISG1",129,0)
 S GMRCPCS(9)=$$FMTHL7^XLFDT($$NOW^XLFDT)
"RTN","GMRCISG1",130,0)
 S GMRCPCS(10)="PUBLIC^JOHN^Q"
"RTN","GMRCISG1",131,0)
 S GMRCPCS(16)="T^TESTING^99GMRC"
"RTN","GMRCISG1",132,0)
 Q $$BUILD^GMRCISEG("ORC",.GMRCPCS)
"RTN","GMRCISG1",133,0)
 ;
"RTN","GMRCISG1",134,0)
 ;
"RTN","GMRCISG1",135,0)
OBRTST(GMRCOI,GMRCTYP) ; build OBR seg for testing imp.
"RTN","GMRCISG1",136,0)
 ; Input:
"RTN","GMRCISG1",137,0)
 ;  GMRCOI   = ien from file 123.5 or 123.3
"RTN","GMRCISG1",138,0)
 ;  GMRCTYP = "P" or "C"   (procedure or consult service)
"RTN","GMRCISG1",139,0)
 ;
"RTN","GMRCISG1",140,0)
 ; Output:
"RTN","GMRCISG1",141,0)
 ;  OBR segment used to test implementation
"RTN","GMRCISG1",142,0)
 ;
"RTN","GMRCISG1",143,0)
 N GMRCPCS,SITE
"RTN","GMRCISG1",144,0)
 S SITE=$$STA^XUAF4($$KSP^XUPARAM("INST"))
"RTN","GMRCISG1",145,0)
 S GMRCPCS(1)=1
"RTN","GMRCISG1",146,0)
 S GMRCPCS(2)="TST1234"_U_SITE_"^GMRCIFR"
"RTN","GMRCISG1",147,0)
 I GMRCTYP="C" D
"RTN","GMRCISG1",148,0)
 . N SERV
"RTN","GMRCISG1",149,0)
 . S SERV=$P(^GMR(123.5,GMRCOI,"IFC"),U,2)
"RTN","GMRCISG1",150,0)
 . S GMRCPCS(4)=GMRCOI_U_SERV_U_SITE_"VA1235"
"RTN","GMRCISG1",151,0)
 I GMRCTYP="P" D
"RTN","GMRCISG1",152,0)
 . N PROC
"RTN","GMRCISG1",153,0)
 . S PROC=$P(^GMR(123.3,GMRCOI,"IFC"),U,2)
"RTN","GMRCISG1",154,0)
 . S GMRCPCS(4)=GMRCOI_U_PROC_U_SITE_"VA1233"
"RTN","GMRCISG1",155,0)
 Q $$BUILD^GMRCISEG("OBR",.GMRCPCS)
"RTN","GMRCISG1",156,0)
 ;
"RTN","GMRCP5B")
0^11^B43394633
"RTN","GMRCP5B",1,0)
GMRCP5B ;SLC/DCM,RJS - Print Consult form 513 (Gather Data - Footers, Provisional Diagnosis and Reason For Request) ;01/29/14  06:26
"RTN","GMRCP5B",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,13,12,15,24,23,22,29,65,66,73**;Dec 27, 1997;Build 22
"RTN","GMRCP5B",3,0)
 ;
"RTN","GMRCP5B",4,0)
 ; Patch #23 add "SERVICE RENDERED AS:" to SF513
"RTN","GMRCP5B",5,0)
 ;ICRs
"RTN","GMRCP5B",6,0)
 ;GLOBALS/FILES
"RTN","GMRCP5B",7,0)
 ;;#872 PROTOCOL ^ORD(101)  #2849 PROTOCOL  #10035 PATIENT FILE  #10040 HOSPITAL LOCATION(^SC)  #10060 NEW PERSON
"RTN","GMRCP5B",8,0)
 ;ROUTINES/APIs
"RTN","GMRCP5B",9,0)
 ;;#1252  SDUTL3  #2056 $$GET1^DIQ  #4156 REGISTRATION, COMBAT VETERAN STATUS  #10003 %DT  #10061 VADPT  #10103 FMTE^XLFDT  #10112 VASITE
"RTN","GMRCP5B",10,0)
 Q
"RTN","GMRCP5B",11,0)
 ;
"RTN","GMRCP5B",12,0)
INIT(GMRCSG) ; Initialize the form
"RTN","GMRCP5B",13,0)
 ;
"RTN","GMRCP5B",14,0)
 D HDR^GMRCP5D,FTR(.GMRCSG),REQUEST,PDIAG Q
"RTN","GMRCP5B",15,0)
 ;
"RTN","GMRCP5B",16,0)
REQUEST ;
"RTN","GMRCP5B",17,0)
 N GMRCX
"RTN","GMRCP5B",18,0)
 ;
"RTN","GMRCP5B",19,0)
 I $L($T(OUTPTPR^SDUTL3)) D
"RTN","GMRCP5B",20,0)
 .S GMRCX=$P($$OUTPTPR^SDUTL3(DFN),U,2)
"RTN","GMRCP5B",21,0)
 .D:$L(GMRCX) BLD("REQ",1,1,0,"Current Primary Care Provider: "_GMRCX)
"RTN","GMRCP5B",22,0)
 I $L($T(OUTPTTM^SDUTL3)) D
"RTN","GMRCP5B",23,0)
 .S GMRCX=$P($$OUTPTTM^SDUTL3(DFN),U,2)
"RTN","GMRCP5B",24,0)
 .D:$L(GMRCX) BLD("REQ",1,1,0,"    Current Primary Care Team: "_GMRCX)
"RTN","GMRCP5B",25,0)
 ;
"RTN","GMRCP5B",26,0)
 I $O(^TMP("GMRC",$J,"OUTPUT","REQ",0)) D BLD("REQ",1,1,0,"")
"RTN","GMRCP5B",27,0)
 ;
"RTN","GMRCP5B",28,0)
 D SUB("H","REQ",1,"Reason For Request continued.")
"RTN","GMRCP5B",29,0)
 D SUB("H","REQ",1," ")
"RTN","GMRCP5B",30,0)
 ;
"RTN","GMRCP5B",31,0)
 D BLD("REQ",1,1,0,"REASON FOR REQUEST: (Complaints and findings)")
"RTN","GMRCP5B",32,0)
 I '$O(^GMR(123,GMRCIFN,20,0)) D BLD("REQ",1,1,0,"") I 1
"RTN","GMRCP5B",33,0)
 E  D
"RTN","GMRCP5B",34,0)
 .N LN S LN=0 F  S LN=$O(^GMR(123,GMRCIFN,20,LN)) Q:LN=""  D
"RTN","GMRCP5B",35,0)
 ..D BLD("REQ",1,1,0,^GMR(123,GMRCIFN,20,LN,0))
"RTN","GMRCP5B",36,0)
 ;
"RTN","GMRCP5B",37,0)
 Q
"RTN","GMRCP5B",38,0)
PDIAG ;
"RTN","GMRCP5B",39,0)
 ;
"RTN","GMRCP5B",40,0)
 ;WAT GMRC 73
"RTN","GMRCP5B",41,0)
 N GMRCD,GMRCCODE,GMRCDA,GMRCSYS,CODINTXT
"RTN","GMRCP5B",42,0)
 S GMRCD="",GMRCCODE="",GMRCSYS=""
"RTN","GMRCP5B",43,0)
 S GMRCD=$G(^GMR(123,GMRCIFN,30)) ;free txt prov diag
"RTN","GMRCP5B",44,0)
 S GMRCCODE=$G(^GMR(123,GMRCIFN,30.1)) ;ICD code^prov diag date^coding system
"RTN","GMRCP5B",45,0)
 S CODINTXT="("_GMRCCODE_")"
"RTN","GMRCP5B",46,0)
 I $L(GMRCCODE)>0 D
"RTN","GMRCP5B",47,0)
 .S GMRCSYS=$P(GMRCCODE,U,3) S GMRCSYS=$S(GMRCSYS="ICD":"ICD-9-CM",GMRCSYS="10D":"ICD-10-CM",1:"") ;coding system
"RTN","GMRCP5B",48,0)
 .S GMRCCODE=$P(GMRCCODE,U) ;actual code
"RTN","GMRCP5B",49,0)
 .S GMRCSYS="("_GMRCSYS_" "_$G(GMRCCODE)_")"
"RTN","GMRCP5B",50,0)
 I GMRCD[$G(CODINTXT) D
"RTN","GMRCP5B",51,0)
 .S GMRCD=$E(GMRCD,0,($L(GMRCD)-$L(CODINTXT)))
"RTN","GMRCP5B",52,0)
 ;
"RTN","GMRCP5B",53,0)
 D BLD("PDIAG",1,1,0,"PROVISIONAL DIAG: "_GMRCD_$G(GMRCSYS))
"RTN","GMRCP5B",54,0)
 ;/GMRC 73
"RTN","GMRCP5B",55,0)
 D BLD("PDIAG",1,1,0,GMRCDVL)
"RTN","GMRCP5B",56,0)
 ;
"RTN","GMRCP5B",57,0)
 S (GMRCQSTR,GMRCPGR,GMRCIPH,GMRCQSTT)=""
"RTN","GMRCP5B",58,0)
 ;
"RTN","GMRCP5B",59,0)
 I $S('$P(GMRCRD,U,23):1,$P(GMRCRD(12),U,5)="P":1,1:0) D
"RTN","GMRCP5B",60,0)
 .S GMRCQSTR=$P(GMRCRD,U,14)
"RTN","GMRCP5B",61,0)
 .S:'GMRCQSTR GMRCQSTR=$$GET1^DIQ(100,+$P(GMRCRD,U,3),1)
"RTN","GMRCP5B",62,0)
 .S GMRCPGR=$$GET1^DIQ(200,+$G(GMRCQSTR),.137) S:'$L(GMRCPGR) GMRCPGR=$$GET1^DIQ(200,+$G(GMRCQSTR),.138)
"RTN","GMRCP5B",63,0)
 .S GMRCIPH=$$GET1^DIQ(200,$G(GMRCQSTR),.132)
"RTN","GMRCP5B",64,0)
 .;
"RTN","GMRCP5B",65,0)
 .S GMRCQSTT=$$GET1^DIQ(200,+$G(GMRCQSTR),20.3)
"RTN","GMRCP5B",66,0)
 .S:'$L(GMRCQSTT) GMRCQSTT=$$GET1^DIQ(200,+$G(GMRCQSTR),8)
"RTN","GMRCP5B",67,0)
 .S GMRCQSTR=$$GET1^DIQ(200,+$G(GMRCQSTR),.01)
"RTN","GMRCP5B",68,0)
 ;
"RTN","GMRCP5B",69,0)
 I $P(GMRCRD,U,23),$P(GMRCRD(12),U,5)="F" D
"RTN","GMRCP5B",70,0)
 .S GMRCQSTR=$P(GMRCRD(12),U,6)
"RTN","GMRCP5B",71,0)
 .S GMRCIPH=$P(GMRCRD(13),U,2)
"RTN","GMRCP5B",72,0)
 .S GMRCPGR=$P(GMRCRD(13),U,3)
"RTN","GMRCP5B",73,0)
 ;
"RTN","GMRCP5B",74,0)
 S GMRCIPH="(Phone: "_GMRCIPH_")"
"RTN","GMRCP5B",75,0)
 S GMRCPGR="(Pager: "_GMRCPGR_")"
"RTN","GMRCP5B",76,0)
 ;
"RTN","GMRCP5B",77,0)
 D BLD("PDIAG",1,1,0,"REQUESTED BY: ")
"RTN","GMRCP5B",78,0)
 D BLD("PDIAG",1,0,35,"|PLACE:")
"RTN","GMRCP5B",79,0)
 D BLD("PDIAG",1,0,59,"|URGENCY:")
"RTN","GMRCP5B",80,0)
 ;
"RTN","GMRCP5B",81,0)
 D BLD("PDIAG",1,1,0,$E(GMRCQSTR,1,37))
"RTN","GMRCP5B",82,0)
 D BLD("PDIAG",1,0,35,"|"_$E($P($G(^ORD(101,+$P(GMRCRD,U,10),0)),U,2),1,20))
"RTN","GMRCP5B",83,0)
 D BLD("PDIAG",1,0,59,"|"_$E($P($G(^ORD(101,+$P(GMRCRD,U,9),0)),U,2),1,18))
"RTN","GMRCP5B",84,0)
 ;
"RTN","GMRCP5B",85,0)
 I $L(GMRCQSTT) D
"RTN","GMRCP5B",86,0)
 .D BLD("PDIAG",1,1,0,GMRCQSTT)
"RTN","GMRCP5B",87,0)
 .D BLD("PDIAG",1,0,35,"|")
"RTN","GMRCP5B",88,0)
 .D BLD("PDIAG",1,0,59,"|")
"RTN","GMRCP5B",89,0)
 D BLD("PDIAG",1,1,0,GMRCPGR)
"RTN","GMRCP5B",90,0)
 D BLD("PDIAG",1,0,35,"|SERVICE RENDERED AS:")
"RTN","GMRCP5B",91,0)
 D BLD("PDIAG",1,0,59,"|EARLIEST DATE:") ;WAT/66
"RTN","GMRCP5B",92,0)
 D BLD("PDIAG",1,0,59,"|")
"RTN","GMRCP5B",93,0)
 S GMRCINOU=$S($P(GMRCRD,U,18)="O":"Outpatient",1:"Inpatient")
"RTN","GMRCP5B",94,0)
 I $D(GMRCIPH)>0 D
"RTN","GMRCP5B",95,0)
 .D BLD("PDIAG",1,1,0,GMRCIPH)
"RTN","GMRCP5B",96,0)
 .D BLD("PDIAG",1,0,35,"|"_GMRCINOU)
"RTN","GMRCP5B",97,0)
 E  D
"RTN","GMRCP5B",98,0)
 .D BLD("PDIAG",1,1,35,"|"_GMRCINOU)
"RTN","GMRCP5B",99,0)
 D BLD("PDIAG",1,0,59,"|")
"RTN","GMRCP5B",100,0)
 D BLD("PDIAG",1,0,59,"|"_$$FMTE^XLFDT($P(GMRCRD,U,24),1)) ;WAT/66
"RTN","GMRCP5B",101,0)
 K GMRCINOU
"RTN","GMRCP5B",102,0)
 ;***************************************************************
"RTN","GMRCP5B",103,0)
 D BLD("PDIAG",1,1,0,GMRCDVL)
"RTN","GMRCP5B",104,0)
 ;
"RTN","GMRCP5B",105,0)
 Q
"RTN","GMRCP5B",106,0)
 ;
"RTN","GMRCP5B",107,0)
FTR(GMRCSG) ;Footer of form 513
"RTN","GMRCP5B",108,0)
 ;
"RTN","GMRCP5B",109,0)
 N GMRCRMBD,GMRCFAC1,GMRCLOC,GMRCX,SUB,VAIN,VAPA,VAERR
"RTN","GMRCP5B",110,0)
 ;
"RTN","GMRCP5B",111,0)
 D ADD^VADPT,INP^VADPT
"RTN","GMRCP5B",112,0)
 ;
"RTN","GMRCP5B",113,0)
 S (GMRCLOC,GMRCRMBD)=""
"RTN","GMRCP5B",114,0)
 S GMRCLOC=$P($G(VAIN(4)),U,2)
"RTN","GMRCP5B",115,0)
 S GMRCRMBD=$G(VAIN(5))
"RTN","GMRCP5B",116,0)
 S:'$L(GMRCLOC) GMRCLOC=$P($G(^SC(+$P($G(^GMR(123,+GMRCIFN,0)),U,4),0)),U,1)
"RTN","GMRCP5B",117,0)
 ;No location, IFC - consulting site
"RTN","GMRCP5B",118,0)
 I '$L(GMRCLOC),$P(GMRCRD,U,23),$P($G(GMRCRD(12)),U,5)="F" D
"RTN","GMRCP5B",119,0)
 .I $P(GMRCRD,U,21) S GMRCLOC=$$GET1^DIQ(4,$P(GMRCRD,U,21),.01)
"RTN","GMRCP5B",120,0)
 .E  S GMRCLOC=$$GET1^DIQ(4,$P(GMRCRD,U,23),.01)
"RTN","GMRCP5B",121,0)
 S:'$L(GMRCLOC) GMRCLOC=GMRCUL
"RTN","GMRCP5B",122,0)
 ;
"RTN","GMRCP5B",123,0)
 D BLD("FTR",0,1,0,GMRCEQL)
"RTN","GMRCP5B",124,0)
 D BLD("FTR",1,1,0,GMRCEQL)
"RTN","GMRCP5B",125,0)
 ;
"RTN","GMRCP5B",126,0)
 I ($G(GMRCSG("GMRCSIGM"))="electronic") D  I 1
"RTN","GMRCP5B",127,0)
 .D BLD("FTR",0,1,0,"SIGNATURE & TITLE: ")
"RTN","GMRCP5B",128,0)
 .D BLD("FTR",0,0,20,$G(GMRCSG("GMRCSIG"))_" /es/")
"RTN","GMRCP5B",129,0)
 .D BLD("FTR",0,0,54,"|")
"RTN","GMRCP5B",130,0)
 .D BLD("FTR",0,1,20,$G(GMRCSG("GMRCSIGT")))
"RTN","GMRCP5B",131,0)
 .D BLD("FTR",0,0,54,"|DATE: "_$$EXDT($G(GMRCSG("GMRCSDT"))))
"RTN","GMRCP5B",132,0)
 E  D
"RTN","GMRCP5B",133,0)
 .D BLD("FTR",0,1,0,"AUTHOR & TITLE: ")
"RTN","GMRCP5B",134,0)
 .D BLD("FTR",0,0,20,$G(GMRCSG("GMRCSIG")))
"RTN","GMRCP5B",135,0)
 .D BLD("FTR",0,0,54,"|")
"RTN","GMRCP5B",136,0)
 .D BLD("FTR",0,1,20,$G(GMRCSG("GMRCSIGT")))
"RTN","GMRCP5B",137,0)
 .D BLD("FTR",0,0,54,"|DATE: "_$$EXDT($G(GMRCSG("GMRCSDT"))))
"RTN","GMRCP5B",138,0)
 ;
"RTN","GMRCP5B",139,0)
 S GMRCFAC1=+$G(DUZ(2))
"RTN","GMRCP5B",140,0)
 S:'GMRCFAC1 GMRCFAC1=+$$SITE^VASITE()
"RTN","GMRCP5B",141,0)
 S GMRCFAC1=$$GET1^DIQ(4,+GMRCFAC1,.01)
"RTN","GMRCP5B",142,0)
 ;
"RTN","GMRCP5B",143,0)
 D BLD("FTR",0,1,0,GMRCDVL)
"RTN","GMRCP5B",144,0)
 D BLD("FTR",0,1,0,"ID #:"_$E(GMRCUL,1,8))
"RTN","GMRCP5B",145,0)
 D BLD("FTR",0,0,12,"|ORGANIZATION:"_$J($E(GMRCFAC1,1,17),17))
"RTN","GMRCP5B",146,0)
 D BLD("FTR",0,0,45,"|REG #:"_$E(GMRCUL,1,4))
"RTN","GMRCP5B",147,0)
 D BLD("FTR",0,0,58,"|LOC: "_$E($G(GMRCLOC),1,11))
"RTN","GMRCP5B",148,0)
 ;
"RTN","GMRCP5B",149,0)
 I $L(GMRCRMBD) D  I 1
"RTN","GMRCP5B",150,0)
 .D BLD("FTR",0,1,12,"|")
"RTN","GMRCP5B",151,0)
 .D BLD("FTR",0,0,45,"|")
"RTN","GMRCP5B",152,0)
 .D BLD("FTR",0,0,58,"|RM/BD: "_GMRCRMBD)
"RTN","GMRCP5B",153,0)
 ;
"RTN","GMRCP5B",154,0)
 D BLD("FTR",0,1,0,GMRCDVL)
"RTN","GMRCP5B",155,0)
 ;
"RTN","GMRCP5B",156,0)
 F SUB=0,1 D
"RTN","GMRCP5B",157,0)
 .I SUB D BLD("FTR",SUB,1,33,"Page ","GMRCPG,38"_" FIRST ONE") I 1
"RTN","GMRCP5B",158,0)
 .E  I '$G(GMRCGUI) D BLD("FTR",SUB,1,33,"Page ","GMRCPG,38"_" SECOND ONE")
"RTN","GMRCP5B",159,0)
 I $G(GMRCPG)=0 D BLD("FTR",0,1,51,"Standard Form 513 (Rev 9-77)")
"RTN","GMRCP5B",160,0)
 Q
"RTN","GMRCP5B",161,0)
 ;
"RTN","GMRCP5B",162,0)
CONSRQ(GMRCRQ) ;
"RTN","GMRCP5B",163,0)
 ;
"RTN","GMRCP5B",164,0)
 N ORND,ORFL,REF
"RTN","GMRCP5B",165,0)
 I '$L(GMRCRQ) Q "Consult"
"RTN","GMRCP5B",166,0)
 S ORND=$P(GMRCRQ,";",1),ORFL=$P(GMRCRQ,";",2),REF=U_ORFL_ORND_",0)"
"RTN","GMRCP5B",167,0)
 S GMRCRQ=$P($G(@(REF)),U,2)
"RTN","GMRCP5B",168,0)
 Q:$L(GMRCRQ) GMRCRQ Q "Consult"
"RTN","GMRCP5B",169,0)
 ;
"RTN","GMRCP5B",170,0)
EXDT(X) ;EXTERNAL DATE FORMAT
"RTN","GMRCP5B",171,0)
 ;
"RTN","GMRCP5B",172,0)
 N DATE,TIME,HR,MN,PD,Y,%DT
"RTN","GMRCP5B",173,0)
 Q:'$L(X) ""
"RTN","GMRCP5B",174,0)
 I '(X?7N.1".".6N) S %DT="PTS" D ^%DT S X=Y
"RTN","GMRCP5B",175,0)
 Q $$FMTE^XLFDT(X,"5PMZ")
"RTN","GMRCP5B",176,0)
 ;
"RTN","GMRCP5B",177,0)
PRCMT(CMT) ;
"RTN","GMRCP5B",178,0)
 ;
"RTN","GMRCP5B",179,0)
 Q $P($G(^GMR(123.1,+CMT,0)),U,8)
"RTN","GMRCP5B",180,0)
 ;
"RTN","GMRCP5B",181,0)
 ;
"RTN","GMRCP5B",182,0)
BLD(SUB,NDX,LINE,TAB,TEXT,RUNTIME) ;
"RTN","GMRCP5B",183,0)
 ;
"RTN","GMRCP5B",184,0)
 Q:'$L($G(SUB))
"RTN","GMRCP5B",185,0)
 N LINECNT
"RTN","GMRCP5B",186,0)
 ;
"RTN","GMRCP5B",187,0)
 F LINECNT=1:1:+LINE S ^TMP("GMRC",$J,"OUTPUT",SUB,NDX,$$LASTLN(SUB,NDX)+1,0)=""
"RTN","GMRCP5B",188,0)
 ;
"RTN","GMRCP5B",189,0)
 S $E(^TMP("GMRC",$J,"OUTPUT",SUB,NDX,$$LASTLN(SUB,NDX),0),TAB+1)=TEXT
"RTN","GMRCP5B",190,0)
 I $L($G(RUNTIME)) S ^TMP("GMRC",$J,"OUTPUT",SUB,NDX,$$LASTLN(SUB,NDX),1)=RUNTIME
"RTN","GMRCP5B",191,0)
 ;
"RTN","GMRCP5B",192,0)
 S GMRCLAST=SUB
"RTN","GMRCP5B",193,0)
 Q
"RTN","GMRCP5B",194,0)
 ;
"RTN","GMRCP5B",195,0)
SUB(ZONE,SUB,NDX,TEXT) ;
"RTN","GMRCP5B",196,0)
 ;
"RTN","GMRCP5B",197,0)
 N NEXT
"RTN","GMRCP5B",198,0)
 S NEXT=$O(^TMP("GMRC",$J,"OUTPUT",SUB,NDX,ZONE," "),-1)+1
"RTN","GMRCP5B",199,0)
 S ^TMP("GMRC",$J,"OUTPUT",SUB,NDX,ZONE,NEXT,0)=TEXT
"RTN","GMRCP5B",200,0)
 Q
"RTN","GMRCP5B",201,0)
 ;
"RTN","GMRCP5B",202,0)
LASTLN(SUB,NDX) ;
"RTN","GMRCP5B",203,0)
 Q +$O(^TMP("GMRC",$J,"OUTPUT",SUB,NDX," "),-1)
"RTN","GMRCP5B",204,0)
 ;
"RTN","GMRCSLM2")
0^12^B92878039
"RTN","GMRCSLM2",1,0)
GMRCSLM2 ;SLC/DCM,WAT - LM Detailed  display and printing ;08/04/14  13:28
"RTN","GMRCSLM2",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,18,15,17,23,22,65,66,73**;DEC 27,1997;Build 22
"RTN","GMRCSLM2",3,0)
 ;
"RTN","GMRCSLM2",4,0)
 ;ICRs
"RTN","GMRCSLM2",5,0)
 ;GLOBALS/FILES
"RTN","GMRCSLM2",6,0)
 ;#872 ^ORD(101  #875 ORDER STATUS file point(100.01)  #2638 ORDER STATUS file access  #2849 ORDERS file  #10060 NEW PERSON (file 200)  #10040 HOSPITAL LOCATION (^SC)
"RTN","GMRCSLM2",7,0)
 ;#10090 INSTITUTION
"RTN","GMRCSLM2",8,0)
 ;ROUTINES
"RTN","GMRCSLM2",9,0)
 ;#2467 $$OI^ORX8  #2056 $$GET1^DIQ   #10104 XLFSTR   #4156 $$CVEDT^DGCV   #10117  ^VALM10   #4807 RDIS^DGRPDB
"RTN","GMRCSLM2",10,0)
 ;
"RTN","GMRCSLM2",11,0)
DT(GMRCO,GMRCIERR) ;;Entry point to set-up detailed display.
"RTN","GMRCSLM2",12,0)
 ;;Pass in GMRCO as +GMRCO - a number only. GMRCO=IEN from of consult from file 123
"RTN","GMRCSLM2",13,0)
 ;;Results are placed in ^TMP("GMRCR",$J,"DT",
"RTN","GMRCSLM2",14,0)
 ;;Pass in variable GMRCOER=2 if calling from the GUI, GMRCOER=1 if call is from CPRS consults tab
"RTN","GMRCSLM2",15,0)
 ;;Pass in variable GMRCOER=0 (or as <UNDEFINED>) if call is from consults routines
"RTN","GMRCSLM2",16,0)
 K GMRCQUT
"RTN","GMRCSLM2",17,0)
 N DFN,GMRCD,GMRCDA,ORIFN,GMRCSF S GMRCDVDL="",$P(GMRCDVDL,"-",80)=""
"RTN","GMRCSLM2",18,0)
 I $S('GMRCO:1,'$D(^GMR(123,+GMRCO,0)):1,1:0) D:$S('$D(GMRCOER):1,'GMRCOER:1,1:0)  S GMRCQUT=1 Q
"RTN","GMRCSLM2",19,0)
 .S GMRCMSG="The consult entry selected for the Detailed Display is unknown." D EXAC^GMRCADC(GMRCMSG) K GMRCMSG
"RTN","GMRCSLM2",20,0)
 .Q
"RTN","GMRCSLM2",21,0)
 K ^TMP("GMRCR",$J,"DT") S TAB="",$P(TAB," ",30)="",GMRCCT=1
"RTN","GMRCSLM2",22,0)
 S GMRCO(0)=^GMR(123,+GMRCO,0),ORIFN=$P(GMRCO(0),"^",3),DFN=$P(GMRCO(0),"^",2)
"RTN","GMRCSLM2",23,0)
 S X="SDUTL3" X ^%ZOSF("TEST") I  D
"RTN","GMRCSLM2",24,0)
 .N PR S PR=$$OUTPTPR^SDUTL3(DFN) I $L(PR) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Current PC Provider:   "_$P(PR,"^",2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",25,0)
 .S PR=$$OUTPTTM^SDUTL3(DFN) I $L(PR) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Current PC Team:       "_$P(PR,"^",2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",26,0)
 .Q
"RTN","GMRCSLM2",27,0)
 N VAIN,VAEL,CVELIG
"RTN","GMRCSLM2",28,0)
 D INP^VADPT S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Current Pat. Status:   "_$S(+VAIN(8):"Inpatient",1:"Outpatient"),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",29,0)
 I $D(VAIN(4)),$L($P(VAIN(4),"^",2)) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Ward:"_$E(TAB,1,18)_$P(VAIN(4),"^",2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",30,0)
 D ELIG^VADPT
"RTN","GMRCSLM2",31,0)
 S:$L($P(VAEL(1),"^",2)) ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Primary Eligibility:"_$E(TAB,1,3)_$P(VAEL(1),"^",2)_$S(VAEL(8)']"":" (NOT VERIFIED)",1:"("_$P(VAEL(8),"^",2)_")"),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",32,0)
 ;wat 66
"RTN","GMRCSLM2",33,0)
 I $L($P(VAEL(6),U,2))  D
"RTN","GMRCSLM2",34,0)
 .;if TYPE is Active Duty and VETERAN Y/N? is No, then call the pt Active Duty
"RTN","GMRCSLM2",35,0)
 .I $P(VAEL(6),U,1)=5&(VAEL(4)=0) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Patient Type:"_$E(TAB,1,10)_$P(VAEL(6),U,2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",36,0)
 .E  S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Patient Type:"_$E(TAB,1,10)_$P(VAEL(6),U,2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",37,0)
 ;//wat 66
"RTN","GMRCSLM2",38,0)
 S CVELIG=$$CVEDT^DGCV(DFN) S:$P($G(CVELIG),U,3) ^TMP("GMRCR",$J,"DT",GMRCCT,0)="CV Eligible:"_$E(TAB,1,11)_"YES",GMRCCT=GMRCCT+1 ;WAT
"RTN","GMRCSLM2",39,0)
 ;wat 66
"RTN","GMRCSLM2",40,0)
 N VASV,OIFOEF S OIFOEF="NO" D SVC^VADPT S:(VASV(11)>0)!(VASV(12)>0)!(VASV(13)>0) OIFOEF="YES"
"RTN","GMRCSLM2",41,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="OEF/OIF: "_$E(TAB,1,14)_$G(OIFOEF),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",42,0)
 ; GET SC RATINGS AND %
"RTN","GMRCSLM2",43,0)
 N INC,COND S INC=0
"RTN","GMRCSLM2",44,0)
 I $P(VAEL(3),U)=1  D
"RTN","GMRCSLM2",45,0)
 .S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",46,0)
 .S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Service Connection/Rated Disabilities",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",47,0)
 .I '$P(VAEL(3),U,2) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="SC Percent:"_$E(TAB,1,12)_"DATA NOT FOUND",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",48,0)
 .E  S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="SC Percent:"_$E(TAB,1,12)_$P(VAEL(3),U,2)_"%",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",49,0)
 .D RDIS^DGRPDB(DFN,.GMRCRDIS) I $D(GMRCRDIS(1))  D
"RTN","GMRCSLM2",50,0)
 ..F  S INC=$O(GMRCRDIS(INC)) Q:INC=""  D
"RTN","GMRCSLM2",51,0)
 ...S COND=$$GET1^DIQ(31,$P(GMRCRDIS(INC),U),.01)
"RTN","GMRCSLM2",52,0)
 ...S:$G(INC)=1 ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Rated Disabilities:"_$E(TAB,1,4)_$G(COND)_"  ("_$P(GMRCRDIS(INC),U,2)_"%)",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",53,0)
 ...S:$G(INC)>1 ^TMP("GMRCR",$J,"DT",GMRCCT,0)=$E(TAB,1,23)_$G(COND)_"  ("_$P(GMRCRDIS(INC),U,2)_"%)",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",54,0)
 .I '$D(GMRCRDIS)  D
"RTN","GMRCSLM2",55,0)
 ..S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Rated Disabilities:"_$E(TAB,1,4)_"NONE STATED",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",56,0)
 ;//wat 66
"RTN","GMRCSLM2",57,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",58,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Order Information",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",59,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="To Service:"_$E(TAB,1,12)_$P($G(^GMR(123.5,+$P(GMRCO(0),"^",5),0)),"^"),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",60,0)
 I $P(GMRCO(0),"^",11) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Attention:"_$E(TAB,1,13)_$$GET1^DIQ(200,$P($G(GMRCO(0)),"^",11),.01),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",61,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="From Service:"_$E(TAB,1,10)_$P($G(^SC(+$P(GMRCO(0),"^",6),0)),"^"),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",62,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Requesting Provider: "_$E(TAB,1,2)_$S($P(GMRCO(0),"^",14)]"":$$GET1^DIQ(200,$P($G(GMRCO(0)),"^",14),.01),1:""),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",63,0)
 I $L($P(GMRCO(0),"^",18)) D
"RTN","GMRCSLM2",64,0)
 .S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Service is to be rendered on an "_$S($P(GMRCO(0),"^",18)="I":"INPATIENT",1:"OUTPATIENT")_" basis",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",65,0)
 .Q
"RTN","GMRCSLM2",66,0)
 I $P(GMRCO(0),"^",10) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Place:"_$E(TAB,1,17)_$P($G(^ORD(101,+$P(GMRCO(0),"^",10),0)),"^",2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",67,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Urgency:"_$E(TAB,1,15)_$S($L($P(GMRCO(0),"^",9)):$P($G(^ORD(101,+$P(GMRCO(0),"^",9),0)),"^",2),1:""),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",68,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Earliest Appr. Date:"_$E(TAB,1,3)_$$FMTE^XLFDT($P($G(GMRCO(0)),"^",24),1),GMRCCT=GMRCCT+1 ;WAT/66
"RTN","GMRCSLM2",69,0)
 S X="ORX8" X ^%ZOSF("TEST") I  D
"RTN","GMRCSLM2",70,0)
 .N GMRCOITM S GMRCOITM=$$OI^ORX8(ORIFN)
"RTN","GMRCSLM2",71,0)
 .S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Orderable Item:"_$E(TAB,1,8)_$P(GMRCOITM,U,2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",72,0)
 .Q
"RTN","GMRCSLM2",73,0)
 S GMRCPRNM=$P(GMRCO(0),"^",8),GMRCPROC=$S(+GMRCPRNM:$P($G(^GMR(123.3,+GMRCPRNM,0)),"^"),1:"Consult Request")
"RTN","GMRCSLM2",74,0)
 I $L(GMRCPROC) D
"RTN","GMRCSLM2",75,0)
 .N GMRCLN
"RTN","GMRCSLM2",76,0)
 .S GMRCTYPE=$S($P(GMRCO(0),U,17)="P":"Procedure",1:"Consult")
"RTN","GMRCSLM2",77,0)
 .S GMRCLN=GMRCTYPE_":"_$E(TAB,1,22-$L(GMRCTYPE))_GMRCPROC
"RTN","GMRCSLM2",78,0)
 .S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=GMRCLN
"RTN","GMRCSLM2",79,0)
 .S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",80,0)
 .I $G(^GMR(123,+GMRCO,1)) D
"RTN","GMRCSLM2",81,0)
 .. S GMRCLN=""
"RTN","GMRCSLM2",82,0)
 .. S GMRCLN="Clinical Procedure:"_$E(TAB,1,4)
"RTN","GMRCSLM2",83,0)
 .. S GMRCLN=GMRCLN_$$GET1^DIQ(123,+GMRCO,1.01,"E")
"RTN","GMRCSLM2",84,0)
 .. S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=GMRCLN
"RTN","GMRCSLM2",85,0)
 .. S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",86,0)
 .Q
"RTN","GMRCSLM2",87,0)
 D PROVDIAG(+GMRCO)
"RTN","GMRCSLM2",88,0)
 I $D(^GMR(123,+GMRCO,20,0)) D
"RTN","GMRCSLM2",89,0)
 .I $O(^GMR(123,+GMRCO,20,0)) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Reason For Request:",GMRCCT=GMRCCT+1 D  Q
"RTN","GMRCSLM2",90,0)
 .. S LN=0
"RTN","GMRCSLM2",91,0)
 .. F  S LN=$O(^GMR(123,+GMRCO,20,LN)) Q:LN=""  D
"RTN","GMRCSLM2",92,0)
 ... S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=^GMR(123,+GMRCO,20,LN,0)
"RTN","GMRCSLM2",93,0)
 ... I $G(GMRCIERR) D
"RTN","GMRCSLM2",94,0)
 .... N TXT S TXT=^TMP("GMRCR",$J,"DT",GMRCCT,0)_"..."
"RTN","GMRCSLM2",95,0)
 .... S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=TXT
"RTN","GMRCSLM2",96,0)
 .... S LN=9999 ;quit with just one line
"RTN","GMRCSLM2",97,0)
 ... S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",98,0)
 .. Q
"RTN","GMRCSLM2",99,0)
 . Q
"RTN","GMRCSLM2",100,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=" ",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",101,0)
 ; get inter-facility consult info
"RTN","GMRCSLM2",102,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Inter-facility Information",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",103,0)
 I '$P(GMRCO(0),"^",23) D
"RTN","GMRCSLM2",104,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="This is not an inter-facility consult request.",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",105,0)
 E  D
"RTN","GMRCSLM2",106,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=$$REPEAT^XLFSTR("-",27)
"RTN","GMRCSLM2",107,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",108,0)
 . N GMRCOP
"RTN","GMRCSLM2",109,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Remote Facility:"_$E(TAB,1,6)_$$GET1^DIQ(4,+$P(GMRCO(0),"^",23),.01),GMRCCT=GMRCCT+1 ;WAT/73
"RTN","GMRCSLM2",110,0)
 . S GMRCO(12)=$G(^GMR(123,+GMRCO,12))
"RTN","GMRCSLM2",111,0)
 . I $L($P(GMRCO(12),U,6)) D
"RTN","GMRCSLM2",112,0)
 .. S GMRCOP=$P(GMRCO(12),U,6)
"RTN","GMRCSLM2",113,0)
 . I '$D(GMRCOP) S GMRCOP=$$GET1^DIQ(200,+$P(GMRCO(0),U,14),.01)
"RTN","GMRCSLM2",114,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Ordering Provider:"_$E(TAB,1,5)_GMRCOP,GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",115,0)
 . S GMRCO(13)=$G(^GMR(123,+GMRCO,13)) I $L($P(GMRCO(13),U,2,3))>1 D
"RTN","GMRCSLM2",116,0)
 .. N LINE
"RTN","GMRCSLM2",117,0)
 .. S LINE=$P(GMRCO(13),U,2) I $L(LINE) S LINE=LINE_$E(TAB,1,5) D
"RTN","GMRCSLM2",118,0)
 ... S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Ordering Provider phone: "_LINE
"RTN","GMRCSLM2",119,0)
 ... S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",120,0)
 .. S LINE=$P(GMRCO(13),U,3) I $L(LINE) S LINE=LINE_$E(TAB,1,5) D
"RTN","GMRCSLM2",121,0)
 ... S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Ordering Provider pager: "_LINE
"RTN","GMRCSLM2",122,0)
 ... S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",123,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Remote Consult #"_$E(TAB)_$P(GMRCO(0),"^",22),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",124,0)
 . I $L($P(GMRCO(13),U)) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Remote Service name: "_$E(TAB)_$P(GMRCO(13),U),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",125,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Role: "_$E(TAB,1,10)_$S($P(GMRCO(12),U,5)="P":"Requesting facility",1:"Consulting facility"),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",126,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",127,0)
 ;get status, last action, and significant findings
"RTN","GMRCSLM2",128,0)
 S STS=$P(GMRCO(0),"^",12),^TMP("GMRCR",$J,"DT",GMRCCT,0)="Status:  "_$E(TAB,1,14)_$S($D(^ORD(100.01,+STS,0)):$P(^(0),"^",1),1:$P(^ORD(100.01,6,0),"^",1)),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",129,0)
 S GMRCA=$P(^GMR(123,+GMRCO,0),"^",13),^TMP("GMRCR",$J,"DT",GMRCCT,0)="Last Action:"_$E(TAB,1,11)_$S(+GMRCA:$P($G(^GMR(123.1,GMRCA,0)),"^",1),1:""),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",130,0)
 I $L($P(GMRCO(0),"^",19)) D
"RTN","GMRCSLM2",131,0)
 .S GMRCSF=$P(GMRCO(0),"^",19)
"RTN","GMRCSLM2",132,0)
 .S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Significant Findings:  "_$S(GMRCSF="Y":"YES",GMRCSF="N":"NO",1:"Unknown")
"RTN","GMRCSLM2",133,0)
 .S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",134,0)
 .Q
"RTN","GMRCSLM2",135,0)
 I $G(GMRCIERR) Q  ;don't need results or activities on IFC errors
"RTN","GMRCSLM2",136,0)
 D ACTLOG^GMRCSLM4(+GMRCO)
"RTN","GMRCSLM2",137,0)
 ; any inter-facility results?
"RTN","GMRCSLM2",138,0)
 I $P(GMRCO(0),"^",23) D
"RTN","GMRCSLM2",139,0)
 . N GMRCIFRS,X S GMRCIFRS=0,X=""
"RTN","GMRCSLM2",140,0)
 . F  S X=$O(^GMR(123,GMRCO,51,"B",X)) Q:X=""  S GMRCIFRS=GMRCIFRS+1
"RTN","GMRCSLM2",141,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",142,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Inter-facility Results: "_$S(GMRCIFRS>0:"Results are available via Display Results action.",1:"No results available for this consult request."),GMRCCT=GMRCCT+2
"RTN","GMRCSLM2",143,0)
 ;get local results
"RTN","GMRCSLM2",144,0)
 D GETRSLT^GMRCART($NA(^TMP("GMRCRT",$J)),1)
"RTN","GMRCSLM2",145,0)
 N NXT S NXT=0
"RTN","GMRCSLM2",146,0)
 F  S NXT=$O(^TMP("GMRCRT",$J,NXT)) Q:'NXT  D
"RTN","GMRCSLM2",147,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=$G(^TMP("GMRCRT",$J,NXT,0))
"RTN","GMRCSLM2",148,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",149,0)
 . Q
"RTN","GMRCSLM2",150,0)
 K ^TMP("GMRCRT",$J)
"RTN","GMRCSLM2",151,0)
 I $S('$D(GMRCOER):1,'GMRCOER:1,1:0),$D(VALMAR) D CLEAN^VALM10
"RTN","GMRCSLM2",152,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",$P(^(0),"=",80)="",^(0)=$E(^(0),1,36)_" END "_$E(^(0),43,80)
"RTN","GMRCSLM2",153,0)
DTQ K X,LN,PL,TO,WP,FLG,SEX,STS,URG,WRD,BKLN,DATA,WRD,PROC,LINE,GMRCD,GMRCDVDL,GMRCO,GMRCAR,GMRCRB,GMRCLA,GMRCSR,GMRCTO,MCFILE,MCPROC,DSPLINE,GMRCLA1,GMRCPRNM,GMRCPROC,GMRCTYPE,GMRCWARD
"RTN","GMRCSLM2",154,0)
 I $D(GMRCOER),'GMRCOER D:$D(VALMEVL) KILL^VALM10() D:$D(VALMAR) CLEAN^VALM10
"RTN","GMRCSLM2",155,0)
 Q
"RTN","GMRCSLM2",156,0)
PROVDIAG(GMRCDA) ;test all prov diags
"RTN","GMRCSLM2",157,0)
 N GMRCD,GMRCCODE,PIECE,FLG,CODINTXT,BUFFER,REPEAT
"RTN","GMRCSLM2",158,0)
 S FLG=0
"RTN","GMRCSLM2",159,0)
 S REPEAT=22 ;spaces to repeat for formatting
"RTN","GMRCSLM2",160,0)
 S GMRCD=$G(^GMR(123,GMRCDA,30))
"RTN","GMRCSLM2",161,0)
 S GMRCCODE=$G(^GMR(123,GMRCDA,30.1)),CODINTXT="("_$P(GMRCCODE,U)_")"
"RTN","GMRCSLM2",162,0)
 ;icd-9 consults stored code in diagnosis text, icd-10 does not. Strip code from text and append to end for display
"RTN","GMRCSLM2",163,0)
 ;desired coding system and code display format (ICD-9-CM 123.45) or (ICD-10-CM S06.4X0S)
"RTN","GMRCSLM2",164,0)
 I GMRCD[$G(CODINTXT) D
"RTN","GMRCSLM2",165,0)
 .S GMRCD=$E(GMRCD,0,($L(GMRCD)-$L(CODINTXT)))
"RTN","GMRCSLM2",166,0)
 I $L($P(GMRCCODE,U))>0 D
"RTN","GMRCSLM2",167,0)
 .I $P(GMRCCODE,U,3)="ICD" S GMRCD=GMRCD_"(ICD-9-CM "_$P(GMRCCODE,U)_")"
"RTN","GMRCSLM2",168,0)
 .I $P(GMRCCODE,U,3)="10D" S GMRCD=GMRCD_"(ICD-10-CM "_$P(GMRCCODE,U)_")"
"RTN","GMRCSLM2",169,0)
 I $L($G(GMRCD))>54 D
"RTN","GMRCSLM2",170,0)
 .F  S PIECE=$L(GMRCD) Q:PIECE<54  D  ;$L of GMRCD will change below, so hold original length in PIECE
"RTN","GMRCSLM2",171,0)
 .. N SEG,I S I=2
"RTN","GMRCSLM2",172,0)
 .. F  S SEG=$P(GMRCD," ",1,I) Q:$L(SEG)>=54!($L(SEG," ")<I)  S I=I+1
"RTN","GMRCSLM2",173,0)
 .. I $L(SEG)=$L(GMRCD) S SEG=$E(GMRCD,1,54) ;means GMRCD doesn't contain spaces, e.g. v55,250.00,414.00,etc.
"RTN","GMRCSLM2",174,0)
 .. S BUFFER=SEG
"RTN","GMRCSLM2",175,0)
 .. S:SEG[" " SEG=$P(GMRCD," ",1,(I-1)) I $L(SEG)=0 S SEG=$E(BUFFER,1,54) ;$P only good when SEG contains a space, otherwise grab a SEG from BUFFER
"RTN","GMRCSLM2",176,0)
 .. S:FLG=0 ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Provisional Diagnosis: "_SEG
"RTN","GMRCSLM2",177,0)
 .. I FLG=1&($F(GMRCD," ")'=2) S REPEAT=23
"RTN","GMRCSLM2",178,0)
 .. S:FLG=1 ^TMP("GMRCR",$J,"DT",GMRCCT,0)=$$REPEAT^XLFSTR(" ",REPEAT)_SEG
"RTN","GMRCSLM2",179,0)
 .. S FLG=1,GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",180,0)
 .. S GMRCD=$E(GMRCD,$L(SEG)+1,999)
"RTN","GMRCSLM2",181,0)
 . I $F(GMRCD," ")'=2 S REPEAT=23
"RTN","GMRCSLM2",182,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=$$REPEAT^XLFSTR(" ",REPEAT)_GMRCD
"RTN","GMRCSLM2",183,0)
 . S GMRCCT=GMRCCT+1,GMRCD=""
"RTN","GMRCSLM2",184,0)
 I $G(GMRCD)'="" D
"RTN","GMRCSLM2",185,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Provisional Diagnosis: "_GMRCD
"RTN","GMRCSLM2",186,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",187,0)
 Q
"RTN","GMRCSLM4")
0^18^B48679858
"RTN","GMRCSLM4",1,0)
GMRCSLM4 ;SLC/DCM - List Manager routine - Activity Log Detailed Display ;08/05/14  13:06
"RTN","GMRCSLM4",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,12,15,22,50,64,72,73**;DEC 27,1997;Build 22
"RTN","GMRCSLM4",3,0)
 ;
"RTN","GMRCSLM4",4,0)
ACTLOG(GMRCO) ;Print activity log
"RTN","GMRCSLM4",5,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",6,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Facility",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",7,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=" Activity"_$E(TAB,1,16)_"Date/Time/Zone"_$E(TAB,1,6)_"Responsible Person"_$E(TAB,1,2)_"Entered By",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",8,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=$$REPEAT^XLFSTR("-",79),GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",9,0)
 N GMRCD,GMRCDA
"RTN","GMRCSLM4",10,0)
 S GMRCD=0 F  S GMRCD=$O(^GMR(123,+GMRCO,40,"B",GMRCD)) Q:'GMRCD  S GMRCDA="" F  S GMRCDA=$O(^GMR(123,+GMRCO,40,"B",GMRCD,GMRCDA)) Q:'GMRCDA  D BLDALN(GMRCO,GMRCDA)
"RTN","GMRCSLM4",11,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",12,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Note: TIME ZONE is local if not indicated",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",13,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",14,0)
 Q
"RTN","GMRCSLM4",15,0)
 ;
"RTN","GMRCSLM4",16,0)
BLDALN(GMRCO,GMRCDA) ;Build Activity Log Lines for an activity
"RTN","GMRCSLM4",17,0)
 ; GMRCO=  consult internal entry number
"RTN","GMRCSLM4",18,0)
 ; GMRCDA= activity internal entry number
"RTN","GMRCSLM4",19,0)
 N GMRCACT,GMRCSLN,XDT1,XDT2,FLG,LN,LINE,DASH,X,GMRCX,GMRCDEV,GMRCISIT,GMRC3LN
"RTN","GMRCSLM4",20,0)
 S GMRCDA(0)=^GMR(123,+GMRCO,40,GMRCDA,0)
"RTN","GMRCSLM4",21,0)
 S GMRCACT=$P(GMRCDA(0),"^",2)
"RTN","GMRCSLM4",22,0)
 S GMRCDA(2)=$G(^GMR(123,+GMRCO,40,GMRCDA,2))
"RTN","GMRCSLM4",23,0)
 S GMRCDA(3)=$G(^GMR(123,+GMRCO,40,GMRCDA,3))
"RTN","GMRCSLM4",24,0)
 I $D(^GMR(123,GMRCO,40,GMRCDA,2)) D
"RTN","GMRCSLM4",25,0)
 . S GMRCISIT=$P(^GMR(123,GMRCO,0),U,23) Q:'GMRCISIT
"RTN","GMRCSLM4",26,0)
 . S GMRCISIT=$$GET1^DIQ(4,GMRCISIT,.01)
"RTN","GMRCSLM4",27,0)
 D BLDLN1
"RTN","GMRCSLM4",28,0)
 D BLDLN2
"RTN","GMRCSLM4",29,0)
 D BLDCMTS
"RTN","GMRCSLM4",30,0)
 Q
"RTN","GMRCSLM4",31,0)
 ;
"RTN","GMRCSLM4",32,0)
BLDLN1 ;Build the first line for the activity
"RTN","GMRCSLM4",33,0)
 ;GMRCX is scratch pad variable
"RTN","GMRCSLM4",34,0)
 I $L($G(GMRCISIT)) D
"RTN","GMRCSLM4",35,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=GMRCISIT
"RTN","GMRCSLM4",36,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",37,0)
 S GMRCX=$P($G(^GMR(123.1,+GMRCACT,0)),"^",1)
"RTN","GMRCSLM4",38,0)
 S:'$L(GMRCX) GMRCX=GMRCACT_" action?"
"RTN","GMRCSLM4",39,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=" "_GMRCX
"RTN","GMRCSLM4",40,0)
 ;
"RTN","GMRCSLM4",41,0)
 ;Add to line for Printed to (action 22) when device name <13 characters
"RTN","GMRCSLM4",42,0)
 I GMRCACT=22 D
"RTN","GMRCSLM4",43,0)
 . S GMRCDEV=$$GET1^DIQ(3.5,+$P(GMRCDA(0),"^",8),.01)
"RTN","GMRCSLM4",44,0)
 . I '$L(GMRCDEV) S GMRCDEV=$P(GMRCDA(0),"^",8)
"RTN","GMRCSLM4",45,0)
 . I $L(GMRCDEV)<13 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=^TMP("GMRCR",$J,"DT",GMRCCT,0)_" "_GMRCDEV K GMRCDEV
"RTN","GMRCSLM4",46,0)
 ;
"RTN","GMRCSLM4",47,0)
 ;Add on generic fields that apply to every activity
"RTN","GMRCSLM4",48,0)
 ;Date/time of Actual Activity, Who's Responsible for Activity,
"RTN","GMRCSLM4",49,0)
 ;and Who entered activity
"RTN","GMRCSLM4",50,0)
 S X=$P(GMRCDA(0),"^",3) D REGDTM^GMRCU S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=$S($D(^TMP("GMRCR",$J,"DT",GMRCCT,0)):^TMP("GMRCR",$J,"DT",GMRCCT,0)_$E(TAB,1,25-$L(^(0)))_X,1:X)_$E(TAB)_$S($P(GMRCDA(2),"^",3)]"":$P(GMRCDA(2),"^",3),1:$E(TAB,1,3))
"RTN","GMRCSLM4",51,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=^TMP("GMRCR",$J,"DT",GMRCCT,0)_$E(TAB,1,45-$L(^(0)))_$S($P(GMRCDA(2),"^",2)]"":$E($P(GMRCDA(2),"^",2),1,17),$P(GMRCDA(0),"^",4):$E($P($G(^VA(200,$P(GMRCDA(0),"^",4),0)),"^"),1,17),1:$E(TAB,1,18))
"RTN","GMRCSLM4",52,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=^TMP("GMRCR",$J,"DT",GMRCCT,0)_$E(TAB,1,65-$L(^(0)))_$S($P(GMRCDA(2),"^")]"":$E($P(GMRCDA(2),"^"),1,17),$P(GMRCDA(0),"^",5):$E($P($G(^VA(200,$P(GMRCDA(0),"^",5),0)),"^"),1,17),1:$E(TAB,1,17))
"RTN","GMRCSLM4",53,0)
 S GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",54,0)
 Q
"RTN","GMRCSLM4",55,0)
 ;
"RTN","GMRCSLM4",56,0)
BLDLN2 ;SECOND line for activity
"RTN","GMRCSLM4",57,0)
 N GMRCSLN S GMRCSLN="" ;saved SECOND line
"RTN","GMRCSLM4",58,0)
 ;
"RTN","GMRCSLM4",59,0)
 ; Check if the entry date and specified actual date are different
"RTN","GMRCSLM4",60,0)
 S XDT1=$P(GMRCDA(0),"^",1),XDT2=$P(GMRCDA(0),"^",3),GMRCX=0
"RTN","GMRCSLM4",61,0)
 S:XDT2>XDT1 X=XDT1,XDT1=XDT2,XDT2=X
"RTN","GMRCSLM4",62,0)
 S GMRCDIF=$$FMDIFF^XLFDT(XDT1,XDT2,3)
"RTN","GMRCSLM4",63,0)
 I $L(GMRCDIF) D
"RTN","GMRCSLM4",64,0)
 . I +$P(GMRCDIF," ",1)>0 S GMRCX=1 Q  ;Check Days
"RTN","GMRCSLM4",65,0)
 . S GMRCDIF=$P(GMRCDIF," ",2)
"RTN","GMRCSLM4",66,0)
 . I +$P(GMRCDIF,":",1)>0 S GMRCX=1 Q  ;Check Hours
"RTN","GMRCSLM4",67,0)
 . I +$P(GMRCDIF,":",2)>1 S GMRCX=1 Q  ;Check Minutes
"RTN","GMRCSLM4",68,0)
 . Q
"RTN","GMRCSLM4",69,0)
 I GMRCX D
"RTN","GMRCSLM4",70,0)
 . S X=$P(GMRCDA(0),"^",1) D REGDTM^GMRCU
"RTN","GMRCSLM4",71,0)
 . ;S GMRCSLN=$E(GMRCSLN_TAB,1,15)_"(entered) "_X_$E(TAB)_$S($P(GMRCDA(2),"^",3)]"":$P(GMRCDA(2),"^",3),1:$E(TAB,1,3))
"RTN","GMRCSLM4",72,0)
 . S GMRCSLN=$E(GMRCSLN_TAB,1,15)_"(entered) "_X_$E(TAB,1,4)
"RTN","GMRCSLM4",73,0)
 . Q
"RTN","GMRCSLM4",74,0)
 ;
"RTN","GMRCSLM4",75,0)
 I $L($G(GMRCSLN)) D  S GMRCSLN=""
"RTN","GMRCSLM4",76,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=GMRCSLN
"RTN","GMRCSLM4",77,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",78,0)
 . Q
"RTN","GMRCSLM4",79,0)
 ;
"RTN","GMRCSLM4",80,0)
 ;Get local Incomplete Report and Complete result # for second line of action
"RTN","GMRCSLM4",81,0)
 I +$P(GMRCDA(0),"^",9) D
"RTN","GMRCSLM4",82,0)
 . I $P($P(GMRCDA(0),"^",9),";",2)["TIU" D  Q
"RTN","GMRCSLM4",83,0)
 .. S GMRCSLN=$E(TAB,1,5)_"Note# "_+$P(GMRCDA(0),"^",9)
"RTN","GMRCSLM4",84,0)
 . I $P($P(GMRCDA(0),"^",9),";",2)["MCAR" D  Q
"RTN","GMRCSLM4",85,0)
 .. N MCFILE S MCFILE=+$P($P(GMRCDA(0),"^",9),"MCAR(",2) Q:'MCFILE
"RTN","GMRCSLM4",86,0)
 .. N MCPRDT S MCPRDT=$$GET1^DIQ(MCFILE,+$P(GMRCDA(0),"^",9),.01)
"RTN","GMRCSLM4",87,0)
 .. Q:'$L(MCPRDT)
"RTN","GMRCSLM4",88,0)
 .. S GMRCSLN=$E(TAB,1,5)_"Medicine Procedure performed: "_MCPRDT
"RTN","GMRCSLM4",89,0)
 ;
"RTN","GMRCSLM4",90,0)
 ;Get remote Incomplete Report and Complete result # for second line of action
"RTN","GMRCSLM4",91,0)
 I +$P(GMRCDA(2),"^",4) D
"RTN","GMRCSLM4",92,0)
 . N GMRCRR S GMRCRR=$P(GMRCDA(2),"^",4)
"RTN","GMRCSLM4",93,0)
 . S GMRCSLN=$E(TAB,1,5)_"Remote "_$P(GMRCRR,";",3)_" #"_+$P(GMRCRR,";")_" from "_$P($G(^DIC(4,+$P(GMRCRR,";",4),0)),"^")
"RTN","GMRCSLM4",94,0)
 ;
"RTN","GMRCSLM4",95,0)
 ;If GMRCDEV is defined, then print the device name on the second line
"RTN","GMRCSLM4",96,0)
 I GMRCACT=22,$D(GMRCDEV) D
"RTN","GMRCSLM4",97,0)
 . S GMRCSLN=$E(TAB,1,5)_$E(GMRCDEV,1,17) K GMRCDEV
"RTN","GMRCSLM4",98,0)
 ;
"RTN","GMRCSLM4",99,0)
 ;Build line for forwarded to (action 17)
"RTN","GMRCSLM4",100,0)
 I GMRCACT=17 D
"RTN","GMRCSLM4",101,0)
 . S GMRCX=$S(+$P(GMRCDA(0),"^",6):$P($G(^GMR(123.5,+$P(GMRCDA(0),"^",6),0)),"^"),$P(GMRCDA(3),"^")]"":$P(GMRCDA(3),"^"),1:" ??")
"RTN","GMRCSLM4",102,0)
 . S GMRCSLN=$E(TAB,1,5)_GMRCX
"RTN","GMRCSLM4",103,0)
 . I $P(GMRCDA(0),"^",7)'="" S GMRC3LN="Previous Attention:  "_$P($G(^VA(200,$P(GMRCDA(0),"^",7),0)),"^")
"RTN","GMRCSLM4",104,0)
 I GMRCACT=25 D
"RTN","GMRCSLM4",105,0)
 . S GMRCX=""
"RTN","GMRCSLM4",106,0)
 . I $P(^GMR(123,+GMRCO,12),U,5)="F" D
"RTN","GMRCSLM4",107,0)
 .. S GMRCX="Previous remote service name: "
"RTN","GMRCSLM4",108,0)
 . S GMRCX=GMRCX_$S(+$P(GMRCDA(0),"^",6):$P($G(^GMR(123.5,+$P(GMRCDA(0),"^",6),0)),"^"),$P(GMRCDA(3),"^")]"":$P(GMRCDA(3),"^"),1:" ??")
"RTN","GMRCSLM4",109,0)
 . S GMRCSLN=$E(TAB,1,5)_GMRCX
"RTN","GMRCSLM4",110,0)
 . I $P(GMRCDA(0),"^",7)'="" S GMRC3LN="Previous Attention:  "_$P($G(^VA(200,$P(GMRCDA(0),"^",7),0)),"^")
"RTN","GMRCSLM4",111,0)
 ;
"RTN","GMRCSLM4",112,0)
 I $L($G(GMRCSLN)) D  S GMRCSLN=""
"RTN","GMRCSLM4",113,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=GMRCSLN
"RTN","GMRCSLM4",114,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",115,0)
 . Q
"RTN","GMRCSLM4",116,0)
 I $D(GMRC3LN) D
"RTN","GMRCSLM4",117,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=GMRC3LN
"RTN","GMRCSLM4",118,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",119,0)
 . Q
"RTN","GMRCSLM4",120,0)
 ;
"RTN","GMRCSLM4",121,0)
 Q
"RTN","GMRCSLM4",122,0)
 ;
"RTN","GMRCSLM4",123,0)
BLDCMTS ;Build lines for Comment activity.
"RTN","GMRCSLM4",124,0)
 I GMRCACT=11 D BLDCMT Q
"RTN","GMRCSLM4",125,0)
 ;
"RTN","GMRCSLM4",126,0)
 ;Build lines for general comments on any activity
"RTN","GMRCSLM4",127,0)
 I $D(^GMR(123,+GMRCO,40,+GMRCDA,1)) D  Q
"RTN","GMRCSLM4",128,0)
 . S LN=$O(^GMR(123,+GMRCO,40,+GMRCDA,1,0)) Q:'+LN
"RTN","GMRCSLM4",129,0)
 . ;Check for edited fields generated text with lines <75 characters
"RTN","GMRCSLM4",130,0)
 . I $G(^GMR(123,+GMRCO,40,+GMRCDA,1,LN,0))["EDITED FIELDS" D BLDCMT Q
"RTN","GMRCSLM4",131,0)
 . D BLDCMT
"RTN","GMRCSLM4",132,0)
 . Q
"RTN","GMRCSLM4",133,0)
 . I $L($G(^GMR(123,+GMRCO,40,+GMRCDA,1,LN,0)))'>75 D BLDCMT Q
"RTN","GMRCSLM4",134,0)
 . ;Use utilities for long line formating
"RTN","GMRCSLM4",135,0)
 . S FLG=1,LINE="     "
"RTN","GMRCSLM4",136,0)
 . D WPSET^GMRCUTIL("^GMR(123,+GMRCO,40,GMRCDA,1)","^TMP(""GMRCR"",$J,""DT"")",LINE,.GMRCCT,TAB,FLG)
"RTN","GMRCSLM4",137,0)
 . D BLDASH
"RTN","GMRCSLM4",138,0)
 . Q
"RTN","GMRCSLM4",139,0)
 Q
"RTN","GMRCSLM4",140,0)
 ;
"RTN","GMRCSLM4",141,0)
BLDCMT ;Build comment lines
"RTN","GMRCSLM4",142,0)
 ;DASH is 1 or "" for print dash line after comment
"RTN","GMRCSLM4",143,0)
 S LN=0
"RTN","GMRCSLM4",144,0)
 N GMRCLINE,SEG,BUFFER,PIECE
"RTN","GMRCSLM4",145,0)
 F  S LN=$O(^GMR(123,+GMRCO,40,+GMRCDA,1,LN)) Q:'+LN  D
"RTN","GMRCSLM4",146,0)
 . S GMRCLINE=^GMR(123,+GMRCO,40,GMRCDA,1,LN,0)
"RTN","GMRCSLM4",147,0)
 . I $E(GMRCLINE,1,22)="Provisional Diagnosis:"&($L($G(GMRCLINE))>80) D
"RTN","GMRCSLM4",148,0)
 .. F  S PIECE=$L(GMRCLINE) Q:PIECE<80  D  ;$L of GMRCLINE will change below, so hold original length in PIECE
"RTN","GMRCSLM4",149,0)
 ... N SEG,I S I=2
"RTN","GMRCSLM4",150,0)
 ... F  S SEG=$P(GMRCLINE," ",1,I) Q:$L(SEG)>=80!($L(SEG," ")<I)  S I=I+1
"RTN","GMRCSLM4",151,0)
 ... I $L(SEG)=$L(GMRCLINE) S SEG=$E(GMRCLINE,1,80) ;means GMRCLINE doesn't contain spaces, e.g. v55,250.00,414.00,etc.
"RTN","GMRCSLM4",152,0)
 ... S BUFFER=SEG
"RTN","GMRCSLM4",153,0)
 ... S:SEG[" " SEG=$P(GMRCLINE," ",1,(I-1)) I $L(SEG)=0 S SEG=$E(BUFFER,1,80) ;$P only good when SEG contains a space, otherwise grab a SEG from BUFFER
"RTN","GMRCSLM4",154,0)
 ... S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=SEG,GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",155,0)
 ... S GMRCLINE=$E(GMRCLINE,$L(SEG)+1,999)
"RTN","GMRCSLM4",156,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=GMRCLINE ;$P(^GMR(123,+GMRCO,40,GMRCDA,1,LN,0),"^",1)
"RTN","GMRCSLM4",157,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",158,0)
 . Q
"RTN","GMRCSLM4",159,0)
 ;D BLDASH
"RTN","GMRCSLM4",160,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",161,0)
 Q
"RTN","GMRCSLM4",162,0)
 ;
"RTN","GMRCSLM4",163,0)
BLDASH ;Build separater line with dashes
"RTN","GMRCSLM4",164,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",$P(^(0),"-",80)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",165,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",166,0)
 Q
"RTN","GMRCY73")
0^1^B682231
"RTN","GMRCY73",1,0)
GMRCY73 ;SLC/JMH,WAT - ICD10 PATCH POST INSTALL ;12/12/13  10:54
"RTN","GMRCY73",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**73**;DEC 27,1997;Build 22
"RTN","GMRCY73",3,0)
 ;
"RTN","GMRCY73",4,0)
 ;;UPDATE^XPDID, ICR #2172
"RTN","GMRCY73",5,0)
 Q
"RTN","GMRCY73",6,0)
POST ;post install for patch GMRC*3.0*73
"RTN","GMRCY73",7,0)
 D PROVDIAG
"RTN","GMRCY73",8,0)
 Q
"RTN","GMRCY73",9,0)
 ;
"RTN","GMRCY73",10,0)
PROVDIAG ;script to update the provisional diagnosis
"RTN","GMRCY73",11,0)
 N GMRCI,GMRCSYS,XPDIDTOT
"RTN","GMRCY73",12,0)
 S XPDIDTOT=$P(^GMR(123,0),U,4)
"RTN","GMRCY73",13,0)
 S GMRCI=0,GMRCSYS="ICD"
"RTN","GMRCY73",14,0)
 F  S GMRCI=$O(^GMR(123,GMRCI)) Q:'GMRCI  D
"RTN","GMRCY73",15,0)
 .I $D(^GMR(123,GMRCI,30.1)) D
"RTN","GMRCY73",16,0)
 ..N GMRCDT
"RTN","GMRCY73",17,0)
 ..S GMRCDT=+^GMR(123,GMRCI,0)
"RTN","GMRCY73",18,0)
 ..S $P(^GMR(123,GMRCI,30.1),U,2,3)=GMRCDT_U_GMRCSYS
"RTN","GMRCY73",19,0)
 ..D UPDATE^XPDID(GMRCI)
"RTN","GMRCY73",20,0)
 D UPDATE^XPDID(XPDIDTOT) H 1
"RTN","GMRCY73",21,0)
 Q
"VER")
8.0^22.0
"^DD",123,123,30,0)
PROVISIONAL DIAGNOSIS^F^^30;1^K:$L(X)>245!($L(X)<2) X
"^DD",123,123,30,3)
Enter a Provisional Diagnosis, 2 to 245 characters in length.
"^DD",123,123,30,21,0)
^^2^2^2970911^^^^
"^DD",123,123,30,21,1,0)
This is the Provisional Diagnosis the ordering clinician would specify
"^DD",123,123,30,21,2,0)
on the Consult Form 513.
"^DD",123,123,30,"DT")
3120710
"^DD",123,123,30.1,0)
PROVISIONAL DIAGNOSIS CODE^F^^30.1;1^K:$L(X)>20!($L(X)<2) X
"^DD",123,123,30.1,3)
Answer must be 2-20 characters in length
"^DD",123,123,30.1,21,0)
^^2^2^3120221^
"^DD",123,123,30.1,21,1,0)
This field is used to store the coded portion of the Provisional Diagnosis
"^DD",123,123,30.1,21,2,0)
if a coded diagnosis is sent via CPRS. 
"^DD",123,123,30.1,"DT")
3120221
"^DD",123,123,30.2,0)
PROVISIONAL DIAGNOSIS DATE^D^^30.1;2^S %DT="E" D ^%DT S X=Y K:X<1 X
"^DD",123,123,30.2,3)
(No range limit on date)
"^DD",123,123,30.2,21,0)
^^3^3^3120221^
"^DD",123,123,30.2,21,1,0)
This is the date of the provisional diagnosis and will contain a value if
"^DD",123,123,30.2,21,2,0)
the request is filed with a coded diagnosis.  This field is used
"^DD",123,123,30.2,21,3,0)
internally to help identify if a given code is active.
"^DD",123,123,30.2,"DT")
3120221
"^DD",123,123,30.3,0)
PROVISIONAL DIAGNOSIS SYSTEM^F^^30.1;3^K:$L(X)>3!($L(X)<1) X
"^DD",123,123,30.3,3)
Answer must be 1-3 characters in length.
"^DD",123,123,30.3,21,0)
^^6^6^3120329^
"^DD",123,123,30.3,21,1,0)
This is the 3-character Source Abbreviation (SAB) for the coding system 
"^DD",123,123,30.3,21,2,0)
to which a given diagnosis code belongs.  This field will only contain a 
"^DD",123,123,30.3,21,3,0)
value when a given service is configured to receive a coded diagnosis.  
"^DD",123,123,30.3,21,4,0)
This field is used internally to check if a given code is active. 
"^DD",123,123,30.3,21,5,0)
For example, ICD is stored if the coding system is ICD-9. 10D is stored if
"^DD",123,123,30.3,21,6,0)
the coding system is ICD-10.
"^DD",123,123,30.3,"DT")
3120329
**END**
**END**
