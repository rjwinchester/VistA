Released TIU*1*295 SEQ #263
Extracted from mail message
**KIDS**:TIU*1.0*295^

**INSTALL NAME**
TIU*1.0*295
"BLD",9961,0)
TIU*1.0*295^TEXT INTEGRATION UTILITIES^0^3150520^y
"BLD",9961,1,0)
^^6^6^3150520^
"BLD",9961,1,1,0)
This patch will resolve the following issues in the Text Integration
"BLD",9961,1,2,0)
Utilities package:
"BLD",9961,1,3,0)
 
"BLD",9961,1,4,0)
1) The reasignment of TIU documents can be required to be accomplished 
"BLD",9961,1,5,0)
twice before the reassign is successfull.
"BLD",9961,1,6,0)
2) Error occurs in TIUSRVR1 when TIUDA is passed in null
"BLD",9961,4,0)
^9.64PA^^
"BLD",9961,6.3)
3
"BLD",9961,"ABPKG")
n
"BLD",9961,"KRN",0)
^9.67PA^779.2^20
"BLD",9961,"KRN",.4,0)
.4
"BLD",9961,"KRN",.401,0)
.401
"BLD",9961,"KRN",.402,0)
.402
"BLD",9961,"KRN",.403,0)
.403
"BLD",9961,"KRN",.5,0)
.5
"BLD",9961,"KRN",.84,0)
.84
"BLD",9961,"KRN",3.6,0)
3.6
"BLD",9961,"KRN",3.8,0)
3.8
"BLD",9961,"KRN",9.2,0)
9.2
"BLD",9961,"KRN",9.8,0)
9.8
"BLD",9961,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",9961,"KRN",9.8,"NM",1,0)
TIURD3^^0^B68096138
"BLD",9961,"KRN",9.8,"NM",2,0)
TIUPXAP1^^0^B33744423
"BLD",9961,"KRN",9.8,"NM",3,0)
TIUSRVR1^^0^B42513780
"BLD",9961,"KRN",9.8,"NM","B","TIUPXAP1",2)

"BLD",9961,"KRN",9.8,"NM","B","TIURD3",1)

"BLD",9961,"KRN",9.8,"NM","B","TIUSRVR1",3)

"BLD",9961,"KRN",19,0)
19
"BLD",9961,"KRN",19.1,0)
19.1
"BLD",9961,"KRN",101,0)
101
"BLD",9961,"KRN",409.61,0)
409.61
"BLD",9961,"KRN",771,0)
771
"BLD",9961,"KRN",779.2,0)
779.2
"BLD",9961,"KRN",870,0)
870
"BLD",9961,"KRN",8989.51,0)
8989.51
"BLD",9961,"KRN",8989.52,0)
8989.52
"BLD",9961,"KRN",8994,0)
8994
"BLD",9961,"KRN","B",.4,.4)

"BLD",9961,"KRN","B",.401,.401)

"BLD",9961,"KRN","B",.402,.402)

"BLD",9961,"KRN","B",.403,.403)

"BLD",9961,"KRN","B",.5,.5)

"BLD",9961,"KRN","B",.84,.84)

"BLD",9961,"KRN","B",3.6,3.6)

"BLD",9961,"KRN","B",3.8,3.8)

"BLD",9961,"KRN","B",9.2,9.2)

"BLD",9961,"KRN","B",9.8,9.8)

"BLD",9961,"KRN","B",19,19)

"BLD",9961,"KRN","B",19.1,19.1)

"BLD",9961,"KRN","B",101,101)

"BLD",9961,"KRN","B",409.61,409.61)

"BLD",9961,"KRN","B",771,771)

"BLD",9961,"KRN","B",779.2,779.2)

"BLD",9961,"KRN","B",870,870)

"BLD",9961,"KRN","B",8989.51,8989.51)

"BLD",9961,"KRN","B",8989.52,8989.52)

"BLD",9961,"KRN","B",8994,8994)

"BLD",9961,"QDEF")
^^^^NO^^^^^^NO
"BLD",9961,"QUES",0)
^9.62^^
"BLD",9961,"REQB",0)
^9.611^2^2
"BLD",9961,"REQB",1,0)
TIU*1.0*205^2
"BLD",9961,"REQB",2,0)
TIU*1.0*222^2
"BLD",9961,"REQB","B","TIU*1.0*205",1)

"BLD",9961,"REQB","B","TIU*1.0*222",2)

"MBREQ")
0
"PKG",470,-1)
1^1
"PKG",470,0)
TEXT INTEGRATION UTILITIES^TIU^Text Integration Utilities 
"PKG",470,20,0)
^9.402P^^
"PKG",470,22,0)
^9.49I^1^1
"PKG",470,22,1,0)
1.0^3010801^3010806^66481
"PKG",470,22,1,"PAH",1,0)
295^3150520
"PKG",470,22,1,"PAH",1,1,0)
^^6^6^3150520
"PKG",470,22,1,"PAH",1,1,1,0)
This patch will resolve the following issues in the Text Integration
"PKG",470,22,1,"PAH",1,1,2,0)
Utilities package:
"PKG",470,22,1,"PAH",1,1,3,0)
 
"PKG",470,22,1,"PAH",1,1,4,0)
1) The reasignment of TIU documents can be required to be accomplished 
"PKG",470,22,1,"PAH",1,1,5,0)
twice before the reassign is successfull.
"PKG",470,22,1,"PAH",1,1,6,0)
2) Error occurs in TIUSRVR1 when TIUDA is passed in null
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","TIUPXAP1")
0^2^B33744423^B32890821
"RTN","TIUPXAP1",1,0)
TIUPXAP1 ; SLC/JER - Interface w/PCE/Visit Tracking ;28-OCT-2003 16:45:37 [8/18/04 11:24am]
"RTN","TIUPXAP1",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**15,29,20,89,82,107,117,126,124,149,179,205,295**;Jun 20, 1997;Build 3
"RTN","TIUPXAP1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","TIUPXAP1",4,0)
QUE ; Use a RESOURCE to post visit tracking information in background
"RTN","TIUPXAP1",5,0)
 N ZTDTH,ZTIO,ZTSAVE,ZTSK,ZTRTN,ZTDESC
"RTN","TIUPXAP1",6,0)
 ; if there is already a visit, and no workload data quit
"RTN","TIUPXAP1",7,0)
 ; *295 Skip defer logic if from reassign (TIURD3)
"RTN","TIUPXAP1",8,0)
 I '$G(TIUREASS),+$P($G(TIUDPRM(0)),U,16),(+$P($G(^TIU(8925,$S(+$G(TIUDA):+$G(TIUDA),1:+$G(DA)),0)),U,11)=0),+$$WORKOK($S(+$G(TIUDA):+$G(TIUDA),1:+$G(DA))) D  Q:'$$BROKER^XWBLIB
"RTN","TIUPXAP1",9,0)
 . D DEFER($S(+$G(TIUDA):+$G(TIUDA),1:+$G(DA)))
"RTN","TIUPXAP1",10,0)
 I +$G(TIU("VISIT")),($D(CPT)'>9) Q
"RTN","TIUPXAP1",11,0)
 I +$P($G(^TIU(8925,$S(+$G(TIUDA):+$G(TIUDA),1:+$G(DA)),0)),U,3),($D(CPT)'>9) Q
"RTN","TIUPXAP1",12,0)
 S (ZTSAVE("TIU("),ZTSAVE("DFN"),ZTSAVE("TIUDA"),ZTSAVE("DA"))=""
"RTN","TIUPXAP1",13,0)
 S (ZTSAVE("DUZ("),ZTSAVE("ICD("),ZTSAVE("CPT("),ZTSAVE("SC("))=""
"RTN","TIUPXAP1",14,0)
 S (ZTSAVE("TIUPRLST("),ZTSAVE("XWBOS"))=""
"RTN","TIUPXAP1",15,0)
 S ZTDTH=$H,ZTIO="TIU/PXAPI RESOURCE",ZTRTN="ENQ^TIUPXAP1"
"RTN","TIUPXAP1",16,0)
 S ZTDESC="TIU/PCE/AmbCare API Call" D ^%ZTLOAD
"RTN","TIUPXAP1",17,0)
 I '$D(ZTSK) D ENQ ; If can't get Resource, Run PXAPI call in foreground
"RTN","TIUPXAP1",18,0)
 Q
"RTN","TIUPXAP1",19,0)
WORKOK(DA) ; Evaluate whether workload collection is appropriate
"RTN","TIUPXAP1",20,0)
 N TIUD0 S TIUD0=$G(^TIU(8925,DA,0))
"RTN","TIUPXAP1",21,0)
 Q $S($P(TIUD0,U,13)="A":1,$P(TIUD0,U,13)="I":1,$P(TIUD0,U,13)="T":1,1:0)
"RTN","TIUPXAP1",22,0)
ENQ ; Entry point for Resource
"RTN","TIUPXAP1",23,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","TIUPXAP1",24,0)
 D POST(.TIU,DFN,$S(+$G(TIUDA):+$G(TIUDA),1:$G(DA)),.ICD,.CPT,.SC)
"RTN","TIUPXAP1",25,0)
 Q
"RTN","TIUPXAP1",26,0)
POST(TIUX,DFN,TIUDA,ICD,CPT,SC) ; Call on commitment to post data to PCE/AmbCare
"RTN","TIUPXAP1",27,0)
 N TIULOC,TIUVDT,TIUSTOP,TIUVCAT,TIUVSIT,TIUD0
"RTN","TIUPXAP1",28,0)
 S TIULOC=$P($G(TIUX("VSTR")),";"),TIUVDT=+$P($G(TIUX("VSTR")),";",2)
"RTN","TIUPXAP1",29,0)
 S TIUVCAT=$P($G(TIUX("VSTR")),";",3),TIUSTOP=$P($G(^SC(+TIULOC,0)),U,7)
"RTN","TIUPXAP1",30,0)
 D PXAPI(.TIUVSIT,DFN,TIULOC,TIUVDT,TIUVCAT,TIUSTOP,.ICD,.CPT,.SC,TIUDA)
"RTN","TIUPXAP1",31,0)
 I +$G(TIUVSIT)>0,+$G(TIUDA)>0,$D(^TIU(8925,+TIUDA,0)) S TIUD0=^(0) D
"RTN","TIUPXAP1",32,0)
 . I $P(TIUD0,U,2)=DFN,$P(TIUD0,U,7)=TIUVDT,$P($G(^TIU(8925,+TIUDA,12)),U,11)=TIULOC D
"RTN","TIUPXAP1",33,0)
 . . N DIE,DR,DA S DA=+$G(TIUDA)
"RTN","TIUPXAP1",34,0)
 . . S DIE=8925,DR=".03////^S X="_+$G(TIUVSIT)
"RTN","TIUPXAP1",35,0)
 . . D ^DIE
"RTN","TIUPXAP1",36,0)
 . . S TIUX("VISIT")=+$G(TIUVSIT)_U_TIUVDT
"RTN","TIUPXAP1",37,0)
 Q
"RTN","TIUPXAP1",38,0)
PXAPI(TIUVSIT,DFN,VLOC,VDT,VCAT,VSTOP,ICD,CPT,SC,TIUDA) ; Build input root
"RTN","TIUPXAP1",39,0)
 N TIUPXAPI,SUCCESS,TIUI,TIUPROV,DA,TIUAUTH
"RTN","TIUPXAP1",40,0)
 K ^TMP("TIUPXAPI",$J) S TIUPXAPI=$NA(^TMP("TIUPXAPI",$J))
"RTN","TIUPXAP1",41,0)
 S:+$G(VDT) @TIUPXAPI@("ENCOUNTER",1,"ENC D/T")=+$G(VDT)
"RTN","TIUPXAP1",42,0)
 S:+$G(DFN) @TIUPXAPI@("ENCOUNTER",1,"PATIENT")=+$G(DFN)
"RTN","TIUPXAP1",43,0)
 S:+$G(VLOC) @TIUPXAPI@("ENCOUNTER",1,"HOS LOC")=+$G(VLOC)
"RTN","TIUPXAP1",44,0)
 I $D(SC)>9 D
"RTN","TIUPXAP1",45,0)
 . S @TIUPXAPI@("ENCOUNTER",1,"SC")=$P($G(SC("SC")),U)
"RTN","TIUPXAP1",46,0)
 . I $G(SC("AO"))]"" S @TIUPXAPI@("ENCOUNTER",1,"AO")=$P($G(SC("AO")),U)
"RTN","TIUPXAP1",47,0)
 . I $G(SC("IR"))]"" S @TIUPXAPI@("ENCOUNTER",1,"IR")=$P($G(SC("IR")),U)
"RTN","TIUPXAP1",48,0)
 . I $G(SC("EC"))]"" S @TIUPXAPI@("ENCOUNTER",1,"EC")=$P($G(SC("EC")),U)
"RTN","TIUPXAP1",49,0)
 . I $G(SC("MST"))]"" S @TIUPXAPI@("ENCOUNTER",1,"MST")=$P($G(SC("MST")),U)
"RTN","TIUPXAP1",50,0)
 . I $G(SC("HNC"))]"" S @TIUPXAPI@("ENCOUNTER",1,"HNC")=$P($G(SC("HNC")),U)
"RTN","TIUPXAP1",51,0)
 I $D(CPT) S @TIUPXAPI@("ENCOUNTER",1,"CHECKOUT D/T")=$E($$NOW^XLFDT,1,12)
"RTN","TIUPXAP1",52,0)
 S:$G(VCAT)]"" @TIUPXAPI@("ENCOUNTER",1,"SERVICE CATEGORY")=$G(VCAT)
"RTN","TIUPXAP1",53,0)
 S:+$G(VSTOP) @TIUPXAPI@("ENCOUNTER",1,"DSS ID")=+$G(VSTOP)
"RTN","TIUPXAP1",54,0)
 S @TIUPXAPI@("ENCOUNTER",1,"APPT")=9
"RTN","TIUPXAP1",55,0)
 S @TIUPXAPI@("ENCOUNTER",1,"ENCOUNTER TYPE")="P"
"RTN","TIUPXAP1",56,0)
 I $D(TIUPRLST) D
"RTN","TIUPXAP1",57,0)
 . M @TIUPXAPI@("PROVIDER")=TIUPRLST
"RTN","TIUPXAP1",58,0)
 . S TIUPROV=$S($G(TIUPRLST(1,"PRIMARY")):$G(TIUPRLST(1,"NAME")),1:$G(TIUPRLST(2,"NAME")))
"RTN","TIUPXAP1",59,0)
 E  D
"RTN","TIUPXAP1",60,0)
 . N TIUDDOC
"RTN","TIUPXAP1",61,0)
 . I +$G(TIUDA) D
"RTN","TIUPXAP1",62,0)
 . . S TIUAUTH=$P($G(^TIU(8925,+$G(TIUDA),12)),U,2) Q:+TIUAUTH'>0
"RTN","TIUPXAP1",63,0)
 . . I +$$PROVIDER(TIUAUTH,$G(VDT))'>0 S TIUAUTH=0
"RTN","TIUPXAP1",64,0)
 . S TIUDDOC=+$$DFLTDOC^TIUPXAPI(+$G(VLOC))
"RTN","TIUPXAP1",65,0)
 . D:'$D(TIUPRM0) SETPARM^TIULE
"RTN","TIUPXAP1",66,0)
 . S TIUPROV=$S(+$G(TIUAUTH):+$G(TIUAUTH),+$$PROVIDER(DUZ,$G(VDT)):+$G(DUZ),1:"")
"RTN","TIUPXAP1",67,0)
 . I +TIUPROV>0,'$D(XWBOS) D
"RTN","TIUPXAP1",68,0)
 . . I +TIUDDOC'=+TIUPROV,(+$P(TIUPRM0,U,8)=1),+TIUDDOC>0 D
"RTN","TIUPXAP1",69,0)
 . . . ; Get Provider information from Encounter.
"RTN","TIUPXAP1",70,0)
 . . . ; If ENC has no provicders then add default provider as primary. 
"RTN","TIUPXAP1",71,0)
 . . . ; Add TIUPROV unless already primary provider for encounter.
"RTN","TIUPXAP1",72,0)
 . . . N TIUPRIME,TIUPVCNT,TIUTVST,TIUTPRV,TIUPDATA
"RTN","TIUPXAP1",73,0)
 . . . S TIUPRIME="",TIUPVCNT=1
"RTN","TIUPXAP1",74,0)
 . . . D GETENC^PXAPI($G(DFN),$G(VDT),$G(VLOC))
"RTN","TIUPXAP1",75,0)
 . . . S TIUTVST=""
"RTN","TIUPXAP1",76,0)
 . . . F  S TIUTVST=$O(^TMP("PXKENC",$J,TIUTVST)) Q:TIUTVST=""  D
"RTN","TIUPXAP1",77,0)
 . . . . S TIUTPRV=""
"RTN","TIUPXAP1",78,0)
 . . . . F  S TIUTPRV=$O(^TMP("PXKENC",$J,TIUTVST,"PRV",TIUTPRV)) Q:TIUTPRV=""  D
"RTN","TIUPXAP1",79,0)
 . . . . . S TIUPDATA=$G(^TMP("PXKENC",$J,TIUTVST,"PRV",TIUTPRV,0))
"RTN","TIUPXAP1",80,0)
 . . . . . I $P(TIUPDATA,"^",4)="P" S TIUPRIME=+TIUPDATA
"RTN","TIUPXAP1",81,0)
 . . . I 'TIUPRIME D
"RTN","TIUPXAP1",82,0)
 . . . . S @TIUPXAPI@("PROVIDER",TIUPVCNT,"NAME")=+TIUDDOC
"RTN","TIUPXAP1",83,0)
 . . . . S @TIUPXAPI@("PROVIDER",TIUPVCNT,"PRIMARY")=1
"RTN","TIUPXAP1",84,0)
 . . . . S TIUPVCNT=TIUPVCNT+1
"RTN","TIUPXAP1",85,0)
 . . . S @TIUPXAPI@("PROVIDER",TIUPVCNT,"NAME")=+TIUPROV
"RTN","TIUPXAP1",86,0)
 . . E  D
"RTN","TIUPXAP1",87,0)
 . . . S @TIUPXAPI@("PROVIDER",1,"NAME")=+TIUPROV
"RTN","TIUPXAP1",88,0)
 I $D(ICD)>9 S TIUI=0 F  S TIUI=$O(ICD(TIUI)) Q:+TIUI'>0  D
"RTN","TIUPXAP1",89,0)
 . S @TIUPXAPI@("DX/PL",TIUI,"ENC PROVIDER")=$G(TIUPROV)
"RTN","TIUPXAP1",90,0)
 . S @TIUPXAPI@("DX/PL",TIUI,"DIAGNOSIS")=$P(ICD(TIUI),U)
"RTN","TIUPXAP1",91,0)
 . S @TIUPXAPI@("DX/PL",TIUI,"NARRATIVE")=$P(ICD(TIUI),U,3)
"RTN","TIUPXAP1",92,0)
 . S:$P(ICD(TIUI),U,4)]"" @TIUPXAPI@("DX/PL",TIUI,"CATEGORY")=$P(ICD(TIUI),U,4)
"RTN","TIUPXAP1",93,0)
 . S:+$G(ICD(TIUI,"PRIMARY")) @TIUPXAPI@("DX/PL",TIUI,"PRIMARY")=$G(ICD(TIUI,"PRIMARY"))
"RTN","TIUPXAP1",94,0)
 I $D(CPT)>9 S TIUI=0 F  S TIUI=$O(CPT(TIUI)) Q:+TIUI'>0  D
"RTN","TIUPXAP1",95,0)
 . S @TIUPXAPI@("PROCEDURE",TIUI,"PROCEDURE")=$P(CPT(TIUI),U)
"RTN","TIUPXAP1",96,0)
 . S @TIUPXAPI@("PROCEDURE",TIUI,"QTY")=$S(+$G(CPT(TIUI,"QTY")):+$G(CPT(TIUI,"QTY")),1:1)
"RTN","TIUPXAP1",97,0)
 . ;Set CPT Modifiers in Array for PCE
"RTN","TIUPXAP1",98,0)
 . N MODCNT,MODATA
"RTN","TIUPXAP1",99,0)
 . S MODCNT=0
"RTN","TIUPXAP1",100,0)
 . F  S MODCNT=$O(CPT(TIUI,"MOD",MODCNT)) Q:'MODCNT  D
"RTN","TIUPXAP1",101,0)
 . . S MODATA=$G(CPT(TIUI,"MOD",MODCNT))
"RTN","TIUPXAP1",102,0)
 . . S:$P(MODATA,U,2)'="" @TIUPXAPI@("PROCEDURE",TIUI,"MODIFIERS",$P(MODATA,U,2))=""
"RTN","TIUPXAP1",103,0)
 . S @TIUPXAPI@("PROCEDURE",TIUI,"ENC PROVIDER")=$G(TIUPROV)
"RTN","TIUPXAP1",104,0)
 . S @TIUPXAPI@("PROCEDURE",TIUI,"NARRATIVE")=$P(CPT(TIUI),U,2)
"RTN","TIUPXAP1",105,0)
 . S:$P(CPT(TIUI),U,3)]"" @TIUPXAPI@("PROCEDURE",TIUI,"CATEGORY")=$P(CPT(TIUI),U,3)
"RTN","TIUPXAP1",106,0)
 S SUCCESS=$$DATA2PCE^PXAPI(TIUPXAPI,"TIU","TEXT INTEGRATION UTILITIES",.TIUVSIT,DUZ,0)
"RTN","TIUPXAP1",107,0)
 K @TIUPXAPI
"RTN","TIUPXAP1",108,0)
 Q
"RTN","TIUPXAP1",109,0)
PROVIDER(USER,DATE) ; Was USER a PROVIDER on DATE?
"RTN","TIUPXAP1",110,0)
 N TIUY,PRVCL,EXCL S TIUY=0
"RTN","TIUPXAP1",111,0)
 S EXCL="V0802V0805V0806V0808V0809V0812V0813"
"RTN","TIUPXAP1",112,0)
 I +$$ISA^USRLM(USER,"PROVIDER") S TIUY=1 G PROVIDEX
"RTN","TIUPXAP1",113,0)
 S PRVCL=$$PRVCLASS^PXAPI(USER,DATE) I PRVCL'>0 G PROVIDEX
"RTN","TIUPXAP1",114,0)
 I $P(PRVCL,U,7)]"",(EXCL'[$E($P(PRVCL,U,7),1,5)) S TIUY=1
"RTN","TIUPXAP1",115,0)
PROVIDEX Q TIUY
"RTN","TIUPXAP1",116,0)
DEFER(DA) ; Mark record to defer workload collection
"RTN","TIUPXAP1",117,0)
 N DIE,DR,TIUVSIT
"RTN","TIUPXAP1",118,0)
 I +$P($G(^TIU(8925,$S(+$G(TIUDA):+$G(TIUDA),1:+$G(DA)),0)),U,11)=1 Q
"RTN","TIUPXAP1",119,0)
 S DIE=8925,DR=".11////1" D ^DIE
"RTN","TIUPXAP1",120,0)
 ;If not called via the broker try to link document to an existing visit
"RTN","TIUPXAP1",121,0)
 I '$$BROKER^XWBLIB,$$LNKVST^TIUPXAP3(+DA,.TIUVSIT)
"RTN","TIUPXAP1",122,0)
 Q
"RTN","TIURD3")
0^1^B68096138^B66718658
"RTN","TIURD3",1,0)
TIURD3  ; SLC/JER - Reassign actions ;11/01/03
"RTN","TIURD3",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**61,124,113,112,295**;Jun 20, 1997;Build 3
"RTN","TIURD3",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","TIURD3",4,0)
REASSIGO ; Reassign an original Document
"RTN","TIURD3",5,0)
 N TIU,TIUASK,TIUDPRM,TIUREASS
"RTN","TIURD3",6,0)
 W !!,"Please choose the correct PATIENT and CARE EPISODE:",!
"RTN","TIURD3",7,0)
 ; --- Get a patient ---
"RTN","TIURD3",8,0)
 S DFN=+$$PATIENT^TIULA
"RTN","TIURD3",9,0)
 ; --- If no pt. selected, QUIT ---
"RTN","TIURD3",10,0)
 I +$G(DFN)'>0 D  Q
"RTN","TIURD3",11,0)
 . S TIUOUT=1
"RTN","TIURD3",12,0)
 . W !!,"No PATIENT Selected: Aborting Transaction, No Harm Done...",!
"RTN","TIURD3",13,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURD3",14,0)
 ; --- If document is a Surgical Report, redirect processing ---
"RTN","TIURD3",15,0)
 I +$$ISA^TIULX(TIUTYPE,+$$CLASS^TIUSROI("SURGICAL REPORTS")) D REASSOP^TIUSROI(DFN,TIUDA) Q
"RTN","TIURD3",16,0)
 ; --- If moving to another pt keep retracted original ---
"RTN","TIURD3",17,0)
 I +$G(DFN)'=$P(TIUD0(0),U,2),(+$P(TIUD0(0),U,5)>5) D
"RTN","TIURD3",18,0)
 . W !!,"Moving signed document to another Patient...A RETRACTED copy will be retained.",!
"RTN","TIURD3",19,0)
 . S TIUODA=TIUDA,TIUDA=+$$RETRACT^TIURD2(TIUDA)
"RTN","TIURD3",20,0)
 I TIUDA'>0 D  Q
"RTN","TIURD3",21,0)
 . S TIUOUT=1
"RTN","TIURD3",22,0)
 . W !!,"Creation of a new Copy of the RETRACTED record failed...Contact IRM.",!
"RTN","TIURD3",23,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURD3",24,0)
 ; --- Get Document Parameters for TIUTYPE
"RTN","TIURD3",25,0)
 D DOCPRM^TIULC1(TIUTYPE,.TIUDPRM)
"RTN","TIURD3",26,0)
 ; --- Get associated visit ---
"RTN","TIURD3",27,0)
 S TIULMETH=$$GETLMETH^TIUEDI1(TIUTYPE)
"RTN","TIURD3",28,0)
 I '$L(TIULMETH) D  Q
"RTN","TIURD3",29,0)
 . S TIUOUT=1
"RTN","TIURD3",30,0)
 . W !!,$C(7),"No Visit Linkage Method defined for "
"RTN","TIURD3",31,0)
 . W $$PNAME^TIULC1(TIUTYPE),".",!,"Please contact IRM...",!
"RTN","TIURD3",32,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURD3",33,0)
 X TIULMETH
"RTN","TIURD3",34,0)
 I '$D(TIU) D  Q
"RTN","TIURD3",35,0)
 . S TIUOUT=1
"RTN","TIURD3",36,0)
 . W !!,$C(7),"Patient & Visit required: Aborting Transaction...No Harm Done.",!
"RTN","TIURD3",37,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURD3",38,0)
 ; --- Validate Selection ---
"RTN","TIURD3",39,0)
 S TIUVMETH=$$GETVMETH^TIUEDI1(TIUTYPE)
"RTN","TIURD3",40,0)
 I '$L(TIUVMETH) D  Q
"RTN","TIURD3",41,0)
 . S TIUOUT=1
"RTN","TIURD3",42,0)
 . W !!,$C(7),"No Validation Method defined for "
"RTN","TIURD3",43,0)
 . W $$PNAME^TIULC1(TIUTYPE),".",!,"Please contact IRM...",!
"RTN","TIURD3",44,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURD3",45,0)
 X TIUVMETH
"RTN","TIURD3",46,0)
 I +$G(TIUASK)'>0 D  Q
"RTN","TIURD3",47,0)
 . S TIUOUT=1
"RTN","TIURD3",48,0)
 . W !!,$C(7),"Okay, No Harm Done.",!
"RTN","TIURD3",49,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") W ""
"RTN","TIURD3",50,0)
 ; --- If same Pt & Visit, abort transaction ---
"RTN","TIURD3",51,0)
 I +$G(TIU("VISIT"))=$P(TIUD0(0),U,3) D  Q:+$G(TIUOUT)
"RTN","TIURD3",52,0)
 . I +$G(TIUADD0),+$P($G(TIUDPRM(0)),U,10) Q
"RTN","TIURD3",53,0)
 . S TIUOUT=1
"RTN","TIURD3",54,0)
 . W !!,$C(7),$C(7),$C(7),"This ",$$PNAME^TIULC1(TIUTYPE)," is already associated with the selected visit...",!
"RTN","TIURD3",55,0)
 . W !,"No action taken.",!
"RTN","TIURD3",56,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURD3",57,0)
 ; --- If valid Pt and Visit, Reassign the document ---
"RTN","TIURD3",58,0)
 I $L($G(TIU("VSTR"))) D
"RTN","TIURD3",59,0)
 . N DA,DR,DIE,TIUORIG,TIUOLD0
"RTN","TIURD3",60,0)
 . S TIUORIG=+$O(^TIU(8925,"APTLD",DFN,TIUTYPE,$G(TIU("VSTR")),0))
"RTN","TIURD3",61,0)
 . S TIUOLD0=$G(^TIU(8925,+TIUORIG,0))
"RTN","TIURD3",62,0)
 . ; If record exists and >1 documents/visit NOT allowed, offer
"RTN","TIURD3",63,0)
 . ; chance to attach record as addendum
"RTN","TIURD3",64,0)
 . I +TIUORIG,(+$P(TIUDPRM(0),U,10)'>0),(+$P(TIUOLD0,U,5)'>13) D  Q
"RTN","TIURD3",65,0)
 . . N TIUATT
"RTN","TIURD3",66,0)
 . . I TIUORIG=TIUDA D  Q
"RTN","TIURD3",67,0)
 . . . W !,$C(7),$C(7),$C(7),"This ",$$PNAME^TIULC1(TIUTYPE)," is already associated with the selected visit...",!
"RTN","TIURD3",68,0)
 . . . W !,"No action taken.",!
"RTN","TIURD3",69,0)
 . . . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURD3",70,0)
 . . W !!,$C(7),$C(7),$C(7),"This patient already has a "
"RTN","TIURD3",71,0)
 . . W $$UP^XLFSTR($$PNAME^TIULC1(TIUTYPE))," for the selected care"
"RTN","TIURD3",72,0)
 . . W !,"episode. Do you wish to make the current record an ADDENDUM of that ",!,$$UP^XLFSTR($$PNAME^TIULC1(TIUTYPE)),"?",!
"RTN","TIURD3",73,0)
 . . S TIUATT=$$READ^TIUU("YOA","   ...OK? ","YES")
"RTN","TIURD3",74,0)
 . . I +TIUATT'>0 D  Q
"RTN","TIURD3",75,0)
 . . . W !!,"All right. No harm done.",!
"RTN","TIURD3",76,0)
 . . . S TIUOUT=1
"RTN","TIURD3",77,0)
 . . . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURD3",78,0)
 . . D DELIRT^TIUDIRT($S(+$G(TIUODA):+TIUODA,1:+TIUDA))
"RTN","TIURD3",79,0)
 . . D ATTACH^TIURD2(+TIUORIG,TIUDA),SEND^TIUALRT(TIUDA) S TIUCHNG=1
"RTN","TIURD3",80,0)
 . ; --- Roll back old IRT data ---
"RTN","TIURD3",81,0)
 . D DELIRT^TIUDIRT($S(+$G(TIUODA):+TIUODA,1:+TIUDA))
"RTN","TIURD3",82,0)
 . ; --- Set up the ^DIE Call ---
"RTN","TIURD3",83,0)
 . S DR=$G(DR)_".02////"_DFN_";.03////"_$S(+$P($G(TIU("VISIT")),U):$P($G(TIU("VISIT")),U),1:"@")_";.07////"_$P($G(TIU("EDT")),U)_";.08////"_$S(+$G(TIU("LDT")):$P($G(TIU("LDT")),U),1:"@")_";.13////"_$P($G(TIU("VSTR")),";",3)
"RTN","TIURD3",84,0)
 . S DR=DR_";1205////"_$P($G(TIU("LOC")),U)_";1401////"_$S($L($G(TIU("AD#"))):+$G(TIU("AD#")),1:"@")_";1402////"_$P($G(TIU("TS")),U)_";1211////"_$P($G(TIU("VLOC")),U)_";1212////"_$P($G(TIU("INST")),U)
"RTN","TIURD3",85,0)
 . S:+$$ISDS^TIULX(TIUTYPE) DR=DR_";1301////^S X="_$$REFDTO^TIURD2(TIUDA,.TIU)
"RTN","TIURD3",86,0)
 . ; --- Don't ask author or cosigner for documents that have been signed ---
"RTN","TIURD3",87,0)
 . S:+$P($G(^TIU(8925,+TIUDA,0)),U,5)'>5 DR=DR_";1202;1204////^S X=$P(^TIU(8925,DA,12),U,2);I '+$P($G(^TIU(8925,+TIUDA,12)),U,8) S Y=0;1208"
"RTN","TIURD3",88,0)
 . ; --- Call ^DIE to affect the Reassignment ---
"RTN","TIURD3",89,0)
 . S DA=TIUDA,DIE=8925 D ^DIE
"RTN","TIURD3",90,0)
 . ; --- Post-reassignment Steps ---
"RTN","TIURD3",91,0)
 . ;*295 SET FLAG TO AVOID DEFER CODE
"RTN","TIURD3",92,0)
 . S TIUREASS=1
"RTN","TIURD3",93,0)
 . ; 1. Package Reassign Action:
"RTN","TIURD3",94,0)
 . D PKGACT(TIUDA,.TIUD0,.TIUD12,.TIUD13,.TIUD14,.TIUOUT)
"RTN","TIURD3",95,0)
 . Q:+$G(TIUOUT)
"RTN","TIURD3",96,0)
 . W !!,$G(TIUNAME)," Reassigned.",!
"RTN","TIURD3",97,0)
 . ; 2. Attach document to new Visit
"RTN","TIURD3",98,0)
 . D QUE^TIUPXAP1
"RTN","TIURD3",99,0)
 . ; 3. Update Addenda to Document
"RTN","TIURD3",100,0)
 . D UPDTADD^TIURD2(TIUDA)
"RTN","TIURD3",101,0)
 . ; 4. Update IRT Record
"RTN","TIURD3",102,0)
 . D UPDTIRT^TIUDIRT(.TIU,+TIUDA)
"RTN","TIURD3",103,0)
 . ; 5. Send Signature Alerts
"RTN","TIURD3",104,0)
 . D SEND^TIUALRT(TIUDA)
"RTN","TIURD3",105,0)
 . ; 6. Audit Reassignment
"RTN","TIURD3",106,0)
 . S TIUD0(1)=$G(^TIU(8925,+TIUDA,0)),TIUD12(1)=$G(^(12))
"RTN","TIURD3",107,0)
 . D AUDREASS^TIURB1(TIUDA,.TIUD0,.TIUD12)
"RTN","TIURD3",108,0)
 . ; 7. If document was retracted, register audit trail for it
"RTN","TIURD3",109,0)
 . I +$G(TIUODA) D AUDREASS^TIURB1(TIUODA,.TIUD0,.TIUD12)
"RTN","TIURD3",110,0)
 . I +$P($G(TIUD0(0)),U,3) D WKLD(.TIUD0,.TIUD12)
"RTN","TIURD3",111,0)
 . ;Finally, collect workload for target visit as appropriate
"RTN","TIURD3",112,0)
 . I (+$P(^TIU(8925,+TIUDA,0),U,5)>6),+$P(^TIU(8925,+TIUDA,0),U,11) D
"RTN","TIURD3",113,0)
 . . I $P(+$G(TIU("EDT")),".")'>DT D  Q:'+TIUASK
"RTN","TIURD3",114,0)
 . . . W !!,"You may now edit the encounter data for the DESTINATION Visit...",!
"RTN","TIURD3",115,0)
 . . . W !,"Patient: ",$G(TIU("PNM")),!,"  Visit: ",$P($G(TIU("EDT")),U,2)," to ",$P($G(TIU("VLOC")),U,2)
"RTN","TIURD3",116,0)
 . . . W ! S TIUASK=+$$READ^TIUU("Y","Do you wish to do this now","NO")
"RTN","TIURD3",117,0)
 . . ;If no workload process using TIU's interview
"RTN","TIURD3",118,0)
 . . ;else, process using PCE's interview
"RTN","TIURD3",119,0)
 . . I '$$CHKVST^TIUPXAP2(+TIUDA) D  I 1
"RTN","TIURD3",120,0)
 . . . N TIUCONT,TIUPRMT
"RTN","TIURD3",121,0)
 . . . Q:$D(XWBOS)
"RTN","TIURD3",122,0)
 . . . I $P(+$P(^TIU(8925,+TIUDA,0),U,7),".")>DT D  Q
"RTN","TIURD3",123,0)
 . . . . W !!
"RTN","TIURD3",124,0)
 . . . . D QUE^TIUPXAP1
"RTN","TIURD3",125,0)
 . . . . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURD3",126,0)
 . . . ;W !!
"RTN","TIURD3",127,0)
 . . . ;need workload? if yes enter
"RTN","TIURD3",128,0)
 . . . I $$CHKWKL^TIUPXAP2(+TIUDA,.TIUDPRM) D CREDIT^TIUVSIT(TIUDA)
"RTN","TIURD3",129,0)
 . . E  D
"RTN","TIURD3",130,0)
 . . . ;need workload? if yes enter
"RTN","TIURD3",131,0)
 . . . I $$CHKWKL^TIUPXAP2(+TIUDA,.TIUDPRM) D EDTENC^TIUPXAP2(TIUDA)
"RTN","TIURD3",132,0)
 . S TIUCHNG=1 S:+$G(TIUODA) TIUCHNG=TIUCHNG_U_TIUDA
"RTN","TIURD3",133,0)
 . W ! I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURD3",134,0)
 Q
"RTN","TIURD3",135,0)
 ;
"RTN","TIURD3",136,0)
WKLD(TIUD0,TIUD12) ; Allow user to clean up workload for visit from which document was removed
"RTN","TIURD3",137,0)
 N TIUVSIT,TIUWHAT,TIUERR,TIUDFN,TIUEDT,TIUHL
"RTN","TIURD3",138,0)
 I $S($P(TIUD0(0),U,13)="H":1,$P(TIUD0(0),U,13)="E":1,1:0) Q
"RTN","TIURD3",139,0)
 S TIUHL=$P(TIUD12(0),U,11)
"RTN","TIURD3",140,0)
 I $P($G(^SC(+TIUHL,0)),U,3)'="C" Q
"RTN","TIURD3",141,0)
 S TIUDFN=$P(TIUD0(0),U,2),TIUEDT=$P(TIUD0(0),U,7),TIUVSIT=$P(TIUD0(0),U,3)
"RTN","TIURD3",142,0)
 W !,"You may now clean up the encounter data for the ORIGINAL Visit...",!
"RTN","TIURD3",143,0)
 W !,"Patient: ",$$PTNAME^TIULC1(TIUDFN),!,"  Visit: ",$$DATE^TIULS(TIUEDT,"AMTH DD, CCYY@HR:MIN")," to ",$$VLOC^TIURD2(TIUHL)
"RTN","TIURD3",144,0)
 W ! I '+$$READ^TIUU("Y","Do you wish to do this now","NO") Q
"RTN","TIURD3",145,0)
 I $G(VALMAR)'="^TMP(""TIUR"",$J)" W !!,"Editing Encounter Data...",!
"RTN","TIURD3",146,0)
 S TIUWHAT=$S($$CHKAPPT^TIUPXAP2(TIUVSIT,TIUDFN,TIUEDT,TIUHL):"INTV",1:"ADDEDIT")
"RTN","TIURD3",147,0)
 S TIUERR=$$INTV^PXAPI(TIUWHAT,"TIU","TEXT INTEGRATION UTILITIES",.TIUVSIT,$S(+$G(TIUVSIT):"",1:TIUHL),TIUDFN,$S(+$G(TIUVSIT):"",1:TIUEDT))
"RTN","TIURD3",148,0)
 ;
"RTN","TIURD3",149,0)
 ;If an error is returned prompt to continue otherwise if a Visit
"RTN","TIURD3",150,0)
 ;IEN is returned and one is not already defined update the document
"RTN","TIURD3",151,0)
 ;I +TIUERR<0 D  I 1
"RTN","TIURD3",152,0)
 ;. W ! I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURD3",153,0)
 ;E  I +$G(TIUVSIT),(+$G(TIUVSIT)'=$P($G(^TIU(8925,+TIUDA,0)),U,3)) D
"RTN","TIURD3",154,0)
 ;.  
"RTN","TIURD3",155,0)
 Q
"RTN","TIURD3",156,0)
PKGACT(TIUDA,TIUD0,TIUD12,TIUD13,TIUD14,TIUOUT) ; Get/Execute Package Reassign Action
"RTN","TIURD3",157,0)
 N TIUREASX,TIUPOP
"RTN","TIURD3",158,0)
 S TIUREASX=$$REASSIGN^TIULC1(+$G(^TIU(8925,+TIUDA,0)))
"RTN","TIURD3",159,0)
 I TIUREASX]"" D  Q:+$G(TIUPOP)
"RTN","TIURD3",160,0)
 . X TIUREASX
"RTN","TIURD3",161,0)
 . I +$G(TIUPOP) D  Q
"RTN","TIURD3",162,0)
 . . S TIUOUT=1
"RTN","TIURD3",163,0)
 . . D WHOABACK(TIUDA,TIUD0(0),TIUD12(0),TIUD13(0),TIUD14(0))
"RTN","TIURD3",164,0)
 . . W !!,$C(7),"Can't Reassign this document...",!
"RTN","TIURD3",165,0)
 . . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURD3",166,0)
 . ; --- If original was retracted, call package Delete Action to roll-back ---
"RTN","TIURD3",167,0)
 . I +$G(TIUODA) D
"RTN","TIURD3",168,0)
 . . N TIUDA,TIUDELX
"RTN","TIURD3",169,0)
 . . S TIUDA=TIUODA
"RTN","TIURD3",170,0)
 . . S TIUDELX=$$DELETE^TIULC1(+$G(^TIU(8925,+TIUDA,0)))
"RTN","TIURD3",171,0)
 . . I TIUDELX]"" X TIUDELX
"RTN","TIURD3",172,0)
 Q
"RTN","TIURD3",173,0)
 ;
"RTN","TIURD3",174,0)
WHOABACK(DA,TIUD0,TIUD12,TIUD13,TIUD14) ; Undo Reassign when fails
"RTN","TIURD3",175,0)
 N DIE,DR S DIE=8925
"RTN","TIURD3",176,0)
 S DR=".02////"_$P(TIUD0,U,2)_";.03////"_$P(TIUD0,U,3)_";.07////"_$P(TIUD0,U,7)_";.08////"_$P(TIUD0,U,8)_";.13////"_$P(TIUD0,U,13)
"RTN","TIURD3",177,0)
 S DR=DR_";1205////"_$P(TIUD12,U,5)_";1401////"_$P(TIUD14,U)_";1402////"_$P(TIUD14,U,2)_";1211////"_$P(TIUD12,U,11)_";1212////"_$P(TIUD12,U,12)
"RTN","TIURD3",178,0)
 D ^DIE
"RTN","TIURD3",179,0)
 I +$P($G(^TIU(8925,+DA,0)),U,5)'>5 D
"RTN","TIURD3",180,0)
 . S DR="1202////"_$P(TIUD12,U,2)_";1305////"_$P(TIUD13,U,5)_";1306////"_$P(TIUD13,U,6)_";1208////"_$P(TIUD12,U,8)_";1209////"_$P(TIUD12,U,9)
"RTN","TIURD3",181,0)
 . S DIE=8925 D ^DIE
"RTN","TIURD3",182,0)
 Q
"RTN","TIUSRVR1")
0^3^B42513780^B41541143
"RTN","TIUSRVR1",1,0)
TIUSRVR1 ; SLC/JER - RPC for record-wise GET ;8/16/06  11:48
"RTN","TIUSRVR1",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**19,32,87,89,100,109,112,173,186,208,211,222,295**;Jun 20, 1997;Build 3
"RTN","TIUSRVR1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","TIUSRVR1",4,0)
TGET(TIUY,TIUDA,ACTION) ; Build ^TMP("TIUVIEW",$J,
"RTN","TIUSRVR1",5,0)
 N TIUL,TIUREC,TIUARR,TIUGDATA,TIUNAME,TIUPRM0,TIUPRM1,X,Y,TIUCPF,ONBROWSE
"RTN","TIUSRVR1",6,0)
 K ^TMP("TIUVIEW",$J),^TMP("TIU FOCUS",$J)
"RTN","TIUSRVR1",7,0)
 S ACTION=$G(ACTION,"VIEW"),TIUL=0
"RTN","TIUSRVR1",8,0)
 D SETPARM^TIULE
"RTN","TIUSRVR1",9,0)
 ; *295 next line moved up 3 lines to avoid error when TIUDA is null
"RTN","TIUSRVR1",10,0)
 I '$D(^TIU(8925,+$G(TIUDA),0)) S VALMQUIT=1 Q
"RTN","TIUSRVR1",11,0)
 S TIUGDATA=$$SETGDATA(TIUDA)
"RTN","TIUSRVR1",12,0)
 S TIUY=$NA(^TMP("TIUVIEW",$J))
"RTN","TIUSRVR1",13,0)
 S TIUARR="^TMP(""TIUVIEW"",$J)"
"RTN","TIUSRVR1",14,0)
  ; Initialize ^TMP("TIU FOCUS",$J) to the entry that has focus
"RTN","TIUSRVR1",15,0)
 S ^TMP("TIU FOCUS",$J)=TIUDA
"RTN","TIUSRVR1",16,0)
 ; if the document has a browse action, execute it
"RTN","TIUSRVR1",17,0)
 S ONBROWSE=$$ONBROWSE^TIULC1(+$G(^TIU(8925,+TIUDA,0)))
"RTN","TIUSRVR1",18,0)
 I $L(ONBROWSE) D LOADSUPP(ONBROWSE,TIUDA,.TIUL)
"RTN","TIUSRVR1",19,0)
 ; Call INQUIRE to get record
"RTN","TIUSRVR1",20,0)
 ;Set a flag to indicate whether or not a Title is a memer of the
"RTN","TIUSRVR1",21,0)
 ;Clinical Procedures Class (1=Yes and 0=No)
"RTN","TIUSRVR1",22,0)
 S TIUCPF=+$$ISA^TIULX(+$G(^TIU(8925,TIUDA,0)),+$$CLASS^TIUCP)
"RTN","TIUSRVR1",23,0)
 ; Call INQUIRE to get record
"RTN","TIUSRVR1",24,0)
 D INQUIRE^TIUSRVR2(TIUDA,.TIUREC,TIUCPF)
"RTN","TIUSRVR1",25,0)
 ; First, load dictation, transcription data, etc.
"RTN","TIUSRVR1",26,0)
 D LOADTOP(.TIUREC,TIUDA,.TIUL,TIUGDATA,TIUCPF)
"RTN","TIUSRVR1",27,0)
 ; Next, load the remainder of the record
"RTN","TIUSRVR1",28,0)
 D LOADREC^TIUSRVR2(TIUDA,.TIUL,TIUGDATA,0,ACTION)
"RTN","TIUSRVR1",29,0)
 ;
"RTN","TIUSRVR1",30,0)
 ; *222 display closing & footer data for FORM LETTERS only
"RTN","TIUSRVR1",31,0)
 I +$$MEMBEROF^TIUPR222(+$G(^TIU(8925,+TIUDA,0)),"FORM LETTERS") D
"RTN","TIUSRVR1",32,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)="" D GUIVIEW^TIUFLP1(TIUDA,"CLS",.TIUL,.TIUARR)
"RTN","TIUSRVR1",33,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)="" D GUIVIEW^TIUFLP1(TIUDA,"FTR",.TIUL,.TIUARR)
"RTN","TIUSRVR1",34,0)
 ;
"RTN","TIUSRVR1",35,0)
 K ^TMP("TIU FOCUS",$J)
"RTN","TIUSRVR1",36,0)
 S VALMCNT=+$G(TIUL)
"RTN","TIUSRVR1",37,0)
 Q
"RTN","TIUSRVR1",38,0)
SETGDATA(TIUDA) ; Set TIUGDATA
"RTN","TIUSRVR1",39,0)
 N TIUDPRM,TIUY,SORT S TIUY=""
"RTN","TIUSRVR1",40,0)
 D DOCPRM^TIULC1(+$G(^TIU(8925,TIUDA,0)),.TIUDPRM,TIUDA)
"RTN","TIUSRVR1",41,0)
 S SORT=$S(+$P(TIUDPRM(0),U,18):"TITLE",1:"REFDT")
"RTN","TIUSRVR1",42,0)
 I +$G(^TIU(8925,TIUDA,21)) S TIUY=TIUDA_U_0_U_+$G(^(21))_U_SORT G SETGX
"RTN","TIUSRVR1",43,0)
 I +$O(^TIU(8925,"GDAD",TIUDA,0)) S TIUY=TIUDA_U_1_U_0_U_SORT
"RTN","TIUSRVR1",44,0)
SETGX Q TIUY
"RTN","TIUSRVR1",45,0)
LOADSUPP(METHOD,TIUDA,TIUL) ; Execute OnBrowse/Load Supplementary data
"RTN","TIUSRVR1",46,0)
 N TIUY,TIUI S TIUI=0
"RTN","TIUSRVR1",47,0)
 X METHOD I '$D(@TIUY) Q
"RTN","TIUSRVR1",48,0)
 F  S TIUI=$O(@TIUY@(TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRVR1",49,0)
 . S TIUL=+$G(TIUL)+1,@TIUARR@(TIUL,0)=$G(@TIUY@(TIUI))
"RTN","TIUSRVR1",50,0)
 S TIUL=+$G(TIUL)+1,@TIUARR@(TIUL,0)=" "
"RTN","TIUSRVR1",51,0)
 K @TIUY
"RTN","TIUSRVR1",52,0)
 Q
"RTN","TIUSRVR1",53,0)
LOADTOP(TIUREC,TIUDA,TIUL,TIUGDATA,TIUCPF) ; Load top information
"RTN","TIUSRVR1",54,0)
 N TIUY,SHORT,CURCHLD,CURPRNT,SELCHLD,SELPRNT
"RTN","TIUSRVR1",55,0)
 ; ---- For ID note, include Title, [Location, & Visit] with each
"RTN","TIUSRVR1",56,0)
 ;      entry, since they vary by entry.
"RTN","TIUSRVR1",57,0)
 ; ---- Follow with Date, Author, etc.
"RTN","TIUSRVR1",58,0)
 ; ---- For ID children in whole note display, shorten top info:
"RTN","TIUSRVR1",59,0)
 ;      Instead of Title, Location, Visit, Date, Author, etc.,
"RTN","TIUSRVR1",60,0)
 ;      use just Title, followed by just Date and Status:
"RTN","TIUSRVR1",61,0)
 S (SHORT,CURCHLD,CURPRNT,SELCHLD,SELPRNT)=0
"RTN","TIUSRVR1",62,0)
 I $P(TIUGDATA,U,3) S SELCHLD=1 ; Selected record was IDchild
"RTN","TIUSRVR1",63,0)
 I $P(TIUGDATA,U,2) S SELPRNT=1
"RTN","TIUSRVR1",64,0)
 I SELCHLD,TIUDA'=$P(TIUGDATA,U,3) S CURCHLD=1 ; Current rec is IDchild
"RTN","TIUSRVR1",65,0)
 I SELCHLD,TIUDA=$P(TIUGDATA,U,3) S CURPRNT=1
"RTN","TIUSRVR1",66,0)
 I SELPRNT,TIUDA=+TIUGDATA S CURPRNT=1
"RTN","TIUSRVR1",67,0)
 I SELPRNT,TIUDA'=+TIUGDATA S CURCHLD=1
"RTN","TIUSRVR1",68,0)
 I SELPRNT,CURCHLD S SHORT=1 ;Child in whole note: shorten top info
"RTN","TIUSRVR1",69,0)
 I SELCHLD,CURCHLD,$G(TIUGWHOL) S SHORT=1
"RTN","TIUSRVR1",70,0)
 I SELCHLD!SELPRNT D IDTOP(TIUDA,.TIUL,SHORT,CURPRNT) I 1
"RTN","TIUSRVR1",71,0)
 S TIUY=""
"RTN","TIUSRVR1",72,0)
 E  I $L(TIUREC(8925,+TIUDA,.01)) D
"RTN","TIUSRVR1",73,0)
 . S TIUY=$$SETSTR^VALM1("LOCAL TITLE: "_TIUREC(8925,+TIUDA,.01),TIUY,2,64)
"RTN","TIUSRVR1",74,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",75,0)
 S TIUY=""
"RTN","TIUSRVR1",76,0)
 I $L($G(TIUREC(8925,+TIUDA,89261))) D
"RTN","TIUSRVR1",77,0)
 . S TIUY=$$SETSTR^VALM1("STANDARD TITLE: "_TIUREC(8925,+TIUDA,89261),TIUY,1,64)
"RTN","TIUSRVR1",78,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",79,0)
 S TIUY=""
"RTN","TIUSRVR1",80,0)
 I SHORT D
"RTN","TIUSRVR1",81,0)
 . S TIUY=$$SETSTR^VALM1("DATE OF NOTE: "_TIUREC(8925,+TIUDA,1301),TIUY,1,39)
"RTN","TIUSRVR1",82,0)
 . S TIUY=$$SETSTR^VALM1("STATUS: "_TIUREC(8925,+TIUDA,.05),TIUY,42,38)
"RTN","TIUSRVR1",83,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",84,0)
 S TIUY=""
"RTN","TIUSRVR1",85,0)
 I 'SHORT D
"RTN","TIUSRVR1",86,0)
 . I $L(TIUREC(8925,+TIUDA,1307)) D  I 1
"RTN","TIUSRVR1",87,0)
 . . S TIUY=$$SETSTR^VALM1("DICT DATE: "_TIUREC(8925,+TIUDA,1307),TIUY,4,39)
"RTN","TIUSRVR1",88,0)
 . E  S TIUY=$$SETSTR^VALM1("DATE OF NOTE: "_TIUREC(8925,+TIUDA,1301),TIUY,1,39)
"RTN","TIUSRVR1",89,0)
 . S TIUY=$$SETSTR^VALM1("ENTRY DATE: "_TIUREC(8925,+TIUDA,1201),$G(TIUY),38,39)
"RTN","TIUSRVR1",90,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",91,0)
 . S TIUY=""
"RTN","TIUSRVR1",92,0)
 . I $L(TIUREC(8925,+TIUDA,1307)) D  I 1
"RTN","TIUSRVR1",93,0)
 . . S TIUY=$$SETSTR^VALM1("DICTATED BY: "_TIUREC(8925,+TIUDA,1202),TIUY,2,32)
"RTN","TIUSRVR1",94,0)
 . E  S TIUY=$$SETSTR^VALM1("AUTHOR: "_TIUREC(8925,+TIUDA,1202),TIUY,7,27)
"RTN","TIUSRVR1",95,0)
 . I +$G(^TIU(8925,+TIUDA,0))=$$CHKFILE^TIUADCL(8925.1,"OPERATION REPORT","I $P(^(0),U,4)=""DOC""") S TIUY=$$SETSTR^VALM1("    SURGEON: "_TIUREC(8925,+TIUDA,1202),TIUY,2,32)
"RTN","TIUSRVR1",96,0)
 . I $L(TIUREC(8925,+TIUDA,1209)) D  I 1
"RTN","TIUSRVR1",97,0)
 . . S TIUY=$$SETSTR^VALM1("ATTENDING: "_TIUREC(8925,+TIUDA,1209),TIUY,39,40)
"RTN","TIUSRVR1",98,0)
 . E  S TIUY=$$SETSTR^VALM1("EXP COSIGNER: "_TIUREC(8925,+TIUDA,1208),TIUY,36,40)
"RTN","TIUSRVR1",99,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",100,0)
 . S TIUY=""
"RTN","TIUSRVR1",101,0)
 . S TIUY=$$SETSTR^VALM1("URGENCY: "_TIUREC(8925,+TIUDA,.09),TIUY,6,36)
"RTN","TIUSRVR1",102,0)
 . S TIUY=$$SETSTR^VALM1("STATUS: "_TIUREC(8925,+TIUDA,.05),TIUY,42,38)
"RTN","TIUSRVR1",103,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",104,0)
 ; * 173 
"RTN","TIUSRVR1",105,0)
 I TIUREC(8925,+TIUDA,.05)="UNCOSIGNED" D
"RTN","TIUSRVR1",106,0)
 . S TIUY="",TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",107,0)
 . S TIUY="",TIUL=TIUL+1,TIUY=$$SETSTR^VALM1("*** NOT YET COSIGNED ***",TIUY,20,51),@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",108,0)
 S TIUY=""
"RTN","TIUSRVR1",109,0)
 I '$L($G(^TIU(8925,+TIUDA,17))) D  I 1
"RTN","TIUSRVR1",110,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",111,0)
 E  D
"RTN","TIUSRVR1",112,0)
 . S TIUY=$$SETSTR^VALM1("SUBJECT: "_$G(^TIU(8925,+TIUDA,17)),TIUY,6,74)
"RTN","TIUSRVR1",113,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",114,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=""
"RTN","TIUSRVR1",115,0)
 ;If the document is a member of the Clinical Procedures Class, include the
"RTN","TIUSRVR1",116,0)
 ; Procedure Summary Code field and the Date/Time Performed field
"RTN","TIUSRVR1",117,0)
 I $G(TIUCPF) D
"RTN","TIUSRVR1",118,0)
 . S TIUL=TIUL+1,TIUY=""
"RTN","TIUSRVR1",119,0)
 . S TIUY=$$SETSTR^VALM1("PROCEDURE SUMMARY CODE: "_TIUREC(8925,+TIUDA,70201),$G(TIUY),1,54)
"RTN","TIUSRVR1",120,0)
 . S @TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",121,0)
 . S TIUL=TIUL+1,TIUY=""
"RTN","TIUSRVR1",122,0)
 . S TIUY=$$SETSTR^VALM1("DATE/TIME PERFORMED: "_TIUREC(8925,+TIUDA,70202),$G(TIUY),1,41)
"RTN","TIUSRVR1",123,0)
 . S @TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",124,0)
 . S TIUL=TIUL+1,TIUY="",@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",125,0)
 I +$$HASADDEN^TIULC1(TIUDA) D
"RTN","TIUSRVR1",126,0)
 . S TIUY="   *** "_$$PNAME^TIULC1(+$G(^TIU(8925,TIUDA,0)))
"RTN","TIUSRVR1",127,0)
 . S TIUY=TIUY_" Has ADDENDA ***"
"RTN","TIUSRVR1",128,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",129,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=""
"RTN","TIUSRVR1",130,0)
 ; *222 display header data for FORM LETTERS only
"RTN","TIUSRVR1",131,0)
 I +$$MEMBEROF^TIUPR222(+$G(^TIU(8925,+TIUDA,0)),"FORM LETTERS") D
"RTN","TIUSRVR1",132,0)
 . D GUIVIEW^TIUFLP1(TIUDA,"HDR",.TIUL,.TIUARR)
"RTN","TIUSRVR1",133,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=""
"RTN","TIUSRVR1",134,0)
 Q
"RTN","TIUSRVR1",135,0)
 ;
"RTN","TIUSRVR1",136,0)
ISCOMP(DA) ; Evaluate whether a given record is a component
"RTN","TIUSRVR1",137,0)
 N TIUY,TIUTYP
"RTN","TIUSRVR1",138,0)
 S TIUTYP=+$G(^TIU(8925,DA,0))
"RTN","TIUSRVR1",139,0)
 S TIUY=$S($P($G(^TIU(8925.1,+TIUTYP,0)),U,4)="CO":1,1:0)
"RTN","TIUSRVR1",140,0)
 Q TIUY
"RTN","TIUSRVR1",141,0)
IDTOP(TIUDA,TIUL,SHORT,CURPRNT) ; Load entry-specific info:
"RTN","TIUSRVR1",142,0)
 ;Title, [Location, Visit] for ID entry.
"RTN","TIUSRVR1",143,0)
 ; Called by LOADTOP
"RTN","TIUSRVR1",144,0)
 N TIUY,TIUX,TIU
"RTN","TIUSRVR1",145,0)
 I CURPRNT S TIUL=+$G(TIUL)+1,@TIUARR@(TIUL)="                         << Interdisciplinary Note >>"
"RTN","TIUSRVR1",146,0)
 I SHORT S TIUL=+$G(TIUL)+1,@TIUARR@(TIUL)="                      << Interdisciplinary Note - Cont. >>"
"RTN","TIUSRVR1",147,0)
 D GETTIU^TIULD(.TIU,+TIUDA)
"RTN","TIUSRVR1",148,0)
 I 'SHORT D
"RTN","TIUSRVR1",149,0)
 . S TIUY="",TIUX="LOCATION: "_$P($G(TIU("LOC")),U,2)
"RTN","TIUSRVR1",150,0)
 . S TIUY=$$SETSTR^VALM1(TIUX,TIUY,1,31)
"RTN","TIUSRVR1",151,0)
 . I $L($G(TIU("WARD"))) D  I 1
"RTN","TIUSRVR1",152,0)
 . . S TIUX="ADMISSION DATE: "_$P($G(TIU("EDT")),U,2)
"RTN","TIUSRVR1",153,0)
 . . S TIUY=$$SETSTR^VALM1(TIUX,TIUY,34,37)
"RTN","TIUSRVR1",154,0)
 . E  D
"RTN","TIUSRVR1",155,0)
 . . S TIUX="VISIT DATE: "_$P($G(TIU("EDT")),U,2)
"RTN","TIUSRVR1",156,0)
 . . S TIUY=$$SETSTR^VALM1(TIUX,TIUY,38,33)
"RTN","TIUSRVR1",157,0)
 . S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",158,0)
 S TIUY="",TIUX="LOCAL TITLE: "_$P($G(TIU("DOCTYP")),U,2)
"RTN","TIUSRVR1",159,0)
 S TIUY=$$SETSTR^VALM1(TIUX,TIUY,1,67)
"RTN","TIUSRVR1",160,0)
 S TIUL=TIUL+1,@TIUARR@(TIUL)=TIUY
"RTN","TIUSRVR1",161,0)
 Q
"VER")
8.0^22.0
"BLD",9961,6)
^263
**END**
**END**

