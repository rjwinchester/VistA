Released GMRA*4*52 SEQ #47
Extracted from mail message
**KIDS**:GMRA*4.0*52^

**INSTALL NAME**
GMRA*4.0*52
"BLD",9546,0)
GMRA*4.0*52^ADVERSE REACTION TRACKING^0^3160601^y
"BLD",9546,1,0)
^^2^2^3160225^
"BLD",9546,1,1,0)
This patch is a follow-up patch to GMRA*4*46. See the associated patch 
"BLD",9546,1,2,0)
description for details on this patch.
"BLD",9546,4,0)
^9.64PA^^
"BLD",9546,6.3)
7
"BLD",9546,"KRN",0)
^9.67PA^779.2^20
"BLD",9546,"KRN",.4,0)
.4
"BLD",9546,"KRN",.401,0)
.401
"BLD",9546,"KRN",.402,0)
.402
"BLD",9546,"KRN",.403,0)
.403
"BLD",9546,"KRN",.5,0)
.5
"BLD",9546,"KRN",.84,0)
.84
"BLD",9546,"KRN",3.6,0)
3.6
"BLD",9546,"KRN",3.8,0)
3.8
"BLD",9546,"KRN",9.2,0)
9.2
"BLD",9546,"KRN",9.8,0)
9.8
"BLD",9546,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",9546,"KRN",9.8,"NM",1,0)
GMRAOR^^0^B152346772
"BLD",9546,"KRN",9.8,"NM",2,0)
GMRADPT^^0^B83390495
"BLD",9546,"KRN",9.8,"NM","B","GMRADPT",2)

"BLD",9546,"KRN",9.8,"NM","B","GMRAOR",1)

"BLD",9546,"KRN",19,0)
19
"BLD",9546,"KRN",19.1,0)
19.1
"BLD",9546,"KRN",101,0)
101
"BLD",9546,"KRN",409.61,0)
409.61
"BLD",9546,"KRN",771,0)
771
"BLD",9546,"KRN",779.2,0)
779.2
"BLD",9546,"KRN",870,0)
870
"BLD",9546,"KRN",8989.51,0)
8989.51
"BLD",9546,"KRN",8989.52,0)
8989.52
"BLD",9546,"KRN",8994,0)
8994
"BLD",9546,"KRN","B",.4,.4)

"BLD",9546,"KRN","B",.401,.401)

"BLD",9546,"KRN","B",.402,.402)

"BLD",9546,"KRN","B",.403,.403)

"BLD",9546,"KRN","B",.5,.5)

"BLD",9546,"KRN","B",.84,.84)

"BLD",9546,"KRN","B",3.6,3.6)

"BLD",9546,"KRN","B",3.8,3.8)

"BLD",9546,"KRN","B",9.2,9.2)

"BLD",9546,"KRN","B",9.8,9.8)

"BLD",9546,"KRN","B",19,19)

"BLD",9546,"KRN","B",19.1,19.1)

"BLD",9546,"KRN","B",101,101)

"BLD",9546,"KRN","B",409.61,409.61)

"BLD",9546,"KRN","B",771,771)

"BLD",9546,"KRN","B",779.2,779.2)

"BLD",9546,"KRN","B",870,870)

"BLD",9546,"KRN","B",8989.51,8989.51)

"BLD",9546,"KRN","B",8989.52,8989.52)

"BLD",9546,"KRN","B",8994,8994)

"BLD",9546,"QUES",0)
^9.62^^
"BLD",9546,"REQB",0)
^9.611^1^1
"BLD",9546,"REQB",1,0)
GMRA*4.0*46^2
"BLD",9546,"REQB","B","GMRA*4.0*46",1)

"MBREQ")
0
"PKG",247,-1)
1^1
"PKG",247,0)
ADVERSE REACTION TRACKING^GMRA^Adverse Reaction Tracking package
"PKG",247,20,0)
^9.402P^1^1
"PKG",247,20,1,0)
2^^GMRAMRG
"PKG",247,20,1,1)

"PKG",247,20,"B",2,1)

"PKG",247,22,0)
^9.49I^1^1
"PKG",247,22,1,0)
4.0^2960328^2960718^11595
"PKG",247,22,1,"PAH",1,0)
52^3160601
"PKG",247,22,1,"PAH",1,1,0)
^^2^2^3160601
"PKG",247,22,1,"PAH",1,1,1,0)
This patch is a follow-up patch to GMRA*4*46. See the associated patch 
"PKG",247,22,1,"PAH",1,1,2,0)
description for details on this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","GMRADPT")
0^2^B83390495^B83164261
"RTN","GMRADPT",1,0)
GMRADPT ;HIRMFO/RM,WAA - UTILITY TO GATHER PATIENT DATA ;06/01/2016  12:54
"RTN","GMRADPT",2,0)
 ;;4.0;Adverse Reaction Tracking;**2,10,46,52**;Mar 29, 1996;Build 7
"RTN","GMRADPT",3,0)
EN1 ; ENTRY TO GATHER PATIENT A/AR DATA
"RTN","GMRADPT",4,0)
 ;CONTROLLED BY SUPPORTED INTEGRATION AGREEMENT #10099
"RTN","GMRADPT",5,0)
 ;*BD
"RTN","GMRADPT",6,0)
 N GMRAOTH,GMRAV1
"RTN","GMRADPT",7,0)
 Q:'$D(DFN)
"RTN","GMRADPT",8,0)
 I '$D(GMRA)#2 S GMRA="0^0^111"
"RTN","GMRADPT",9,0)
 K GMRAL
"RTN","GMRADPT",10,0)
 S GMRAV1=1,GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRADPT",11,0)
 D DPT
"RTN","GMRADPT",12,0)
 Q
"RTN","GMRADPT",13,0)
 ;*ED
"RTN","GMRADPT",14,0)
EN2 ; ENTRY TO GATHER PATIENT A/AR DATA
"RTN","GMRADPT",15,0)
 ;CONTROLLED BY SUPPORTED INTEGRATION AGREEMENT #10099
"RTN","GMRADPT",16,0)
 ;INPUT VARIABLES:
"RTN","GMRADPT",17,0)
 ;
"RTN","GMRADPT",18,0)
 ; DFN             Pointer to Patient file.
"RTN","GMRADPT",19,0)
 ; GMRA (OPTIONAL) A^B^C^D   DEFAULT="0^0^111^0"
"RTN","GMRADPT",20,0)
 ;    where  A = 0 return all reactions (allergic/non-allergic).
"RTN","GMRADPT",21,0)
 ;               1 return allergies only.
"RTN","GMRADPT",22,0)
 ;               2 return non-allergies only.
"RTN","GMRADPT",23,0)
 ;           B = 0 return all data (verified or non-verified).
"RTN","GMRADPT",24,0)
 ;               1 return only verified data.
"RTN","GMRADPT",25,0)
 ;               2 return only non-verified data.
"RTN","GMRADPT",26,0)
 ;           C = X_Y_Z
"RTN","GMRADPT",27,0)
 ;               where X, Y, and Z are either 0 or 1.  1 would mean to
"RTN","GMRADPT",28,0)
 ;               return an Adverse Reaction of that particular type,
"RTN","GMRADPT",29,0)
 ;               and zero means do not return an Adverse Reaction of
"RTN","GMRADPT",30,0)
 ;               that type.
"RTN","GMRADPT",31,0)
 ;               X is for TYPE=OTHER
"RTN","GMRADPT",32,0)
 ;               Y is for TYPE=FOOD
"RTN","GMRADPT",33,0)
 ;               Z is for TYPE=DRUG.
"RTN","GMRADPT",34,0)
 ;               E.g., 001 (return drug only), 111 (returns all types),
"RTN","GMRADPT",35,0)
 ;               and 010 (returns food only).
"RTN","GMRADPT",36,0)
 ;           D = 0 return local allergies only
"RTN","GMRADPT",37,0)
 ;               1 return local and remote allergies
"RTN","GMRADPT",38,0)
 ;OUTPUT VARIABLES:
"RTN","GMRADPT",39,0)
 ; GMRAL = 1 if patient has Adverse Reaction
"RTN","GMRADPT",40,0)
 ;         0 if patient has no known Adverse Reaction
"RTN","GMRADPT",41,0)
 ;      null if patient has not been asked about Adverse Reaction
"RTN","GMRADPT",42,0)
 ; GMRAL(PTR) = A^B^C^D^E^F^G^H^I^J^K
"RTN","GMRADPT",43,0)
 ;    where PTR = Either pointer to 120.8 for local reactions or 
"RTN","GMRADPT",44,0)
 ;                'R' appended with pointer to ^XTMP("ORRDI","ART",DFN, for remote reactions
"RTN","GMRADPT",45,0)
 ;          A = Pointer to Patient file.
"RTN","GMRADPT",46,0)
 ;          B = Free text of causative agent.
"RTN","GMRADPT",47,0)
 ;         *C = Type of reaction, where D is drug, F is food, and O is
"RTN","GMRADPT",48,0)
 ;              other.
"RTN","GMRADPT",49,0)
 ;          D = 1 if Adverse Reaction has been verified
"RTN","GMRADPT",50,0)
 ;              0 if Adverse Reaction has not been verified
"RTN","GMRADPT",51,0)
 ;          E = 0 if this is an allergic reaction
"RTN","GMRADPT",52,0)
 ;              1 if this is not an allergic reaction
"RTN","GMRADPT",53,0)
 ;        **F = the mechanism of reaction in the format:
"RTN","GMRADPT",54,0)
 ;              External format;Internal format
"RTN","GMRADPT",55,0)
 ;              (ALLERGY;0, PHARMACOLOGIC;2, UNKNOWN;U).
"RTN","GMRADPT",56,0)
 ;          G = Type of reaction.
"RTN","GMRADPT",57,0)
 ;              where   D = drug
"RTN","GMRADPT",58,0)
 ;                     DF = drug/food
"RTN","GMRADPT",59,0)
 ;                    DFO = drug/food/other
"RTN","GMRADPT",60,0)
 ;                     DO = drug/other
"RTN","GMRADPT",61,0)
 ;                      F = food
"RTN","GMRADPT",62,0)
 ;                     FO = food/other
"RTN","GMRADPT",63,0)
 ;                      O = other
"RTN","GMRADPT",64,0)
 ;          H = the mechanism of reaction in the format:
"RTN","GMRADPT",65,0)
 ;              External format;Internal format
"RTN","GMRADPT",66,0)
 ;              (ALLERGY;A, PHARMACOLOGIC;P, UNKNOWN;U)
"RTN","GMRADPT",67,0)
 ;          I = variable pointer to the causative agent returned in piece B
"RTN","GMRADPT",68,0)
 ;          J = observed/historical of the reaction in the format:
"RTN","GMRADPT",69,0)
 ;              External format;Internal format
"RTN","GMRADPT",70,0)
 ; GMRAL(PTR,"S",COUNT) = S^D
"RTN","GMRADPT",71,0)
 ;    where COUNT = number 1 to number of signs/symptoms for this
"RTN","GMRADPT",72,0)
 ;                  reaction.
"RTN","GMRADPT",73,0)
 ;              S = a sign/symptom for this reaction in the format:
"RTN","GMRADPT",74,0)
 ;                  External format;Internal format
"RTN","GMRADPT",75,0)
 ;              D = date/time sign/symptom entered in the format:
"RTN","GMRADPT",76,0)
 ;                  External format;Internal format
"RTN","GMRADPT",77,0)
 ; GMRAL(PTR,"O",COUNT) = S^D
"RTN","GMRADPT",78,0)
 ;    where COUNT = number 1 to number of observations for this
"RTN","GMRADPT",79,0)
 ;                  reaction.
"RTN","GMRADPT",80,0)
 ;              S = a severity for this reaction in the format:
"RTN","GMRADPT",81,0)
 ;                  External format;Internal format
"RTN","GMRADPT",82,0)
 ;              D = date/time of observation in the format:
"RTN","GMRADPT",83,0)
 ;                  External format;Internal format
"RTN","GMRADPT",84,0)
 ; GMRAL(PTR,"SITE") = SITE
"RTN","GMRADPT",85,0)
 ;    where SITE = reporting institution in the format:
"RTN","GMRADPT",86,0)
 ;                 Institution File (#4) Pointer^Station Name^Station Number
"RTN","GMRADPT",87,0)
 ;                 Note: This will only exist for remote reactions
"RTN","GMRADPT",88,0)
 ;
"RTN","GMRADPT",89,0)
 ;*  NOTE: This piece will no longer be supported after 9/1/97,
"RTN","GMRADPT",90,0)
 ;         Please use piece G.
"RTN","GMRADPT",91,0)
 ;** NOTE: This piece will no longer be supported after 9/1/97,
"RTN","GMRADPT",92,0)
 ;         Please use piece H.
"RTN","GMRADPT",93,0)
 ;
"RTN","GMRADPT",94,0)
 ;*BD
"RTN","GMRADPT",95,0)
 D DPT2
"RTN","GMRADPT",96,0)
 Q
"RTN","GMRADPT",97,0)
 ;*ED
"RTN","GMRADPT",98,0)
DPT ;
"RTN","GMRADPT",99,0)
 ;*BD
"RTN","GMRADPT",100,0)
 ;Read NKA Node in file 120.86
"RTN","GMRADPT",101,0)
 S GMRAL=$P($G(^GMR(120.86,DFN,0)),U,2)
"RTN","GMRADPT",102,0)
 ;Do not set GMRAL array if patient is unassessed or NKA.
"RTN","GMRADPT",103,0)
 I GMRAL=0 Q  ;PATIENT HAS NO KNOWN ALLERGIES
"RTN","GMRADPT",104,0)
 F GMRAREC=0:0 S GMRAREC=$O(^GMR(120.8,"B",DFN,GMRAREC)) Q:GMRAREC'>0  S GMRANODE=$S($D(^GMR(120.8,GMRAREC,0)):^(0),1:"") D:GMRANODE SETAL(0)
"RTN","GMRADPT",105,0)
 I GMRAL=1,+$O(GMRAL(0))'>0 S GMRAL=0 ;if flag is set to 1 (reactions exist), then make certain the reactions are passed in the GMRAL array
"RTN","GMRADPT",106,0)
 K GMRA,GMRANODE,GMRAOSOF,GMRAREC,GMRATCNT
"RTN","GMRADPT",107,0)
 Q
"RTN","GMRADPT",108,0)
DPT2 ;DO NOT CALL THIS ENTRY POINT AS IT WILL BE DELETED IN THE FUTURE. USE EN2 INSTEAD.
"RTN","GMRADPT",109,0)
 ;*ED
"RTN","GMRADPT",110,0)
 N GMRAOTH,REMOTE,MECH,IDX,GMRANODE,GMRAOSOF,GMRAREC,GMRATCNT
"RTN","GMRADPT",111,0)
 Q:'$D(DFN)
"RTN","GMRADPT",112,0)
 I '$D(GMRA)#2 S GMRA="0^0^111^0"
"RTN","GMRADPT",113,0)
 K GMRAL
"RTN","GMRADPT",114,0)
 S GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRADPT",115,0)
 S REMOTE=$S(+$P(GMRA,U,4):$$HDRDATA^GMRAHDR,1:0)
"RTN","GMRADPT",116,0)
 S GMRAL=$$NKA^GMRANKA(DFN)
"RTN","GMRADPT",117,0)
 I +GMRAL=0,$P(GMRA,U,4),($D(^XTMP("ORRDI","ART",DFN,"ASSESSMENT"))>9) D
"RTN","GMRADPT",118,0)
 .S IDX=0 F  S IDX=$O(^XTMP("ORRDI","ART",DFN,"ASSESSMENT",IDX)) Q:'IDX  D
"RTN","GMRADPT",119,0)
 ..N RETURN
"RTN","GMRADPT",120,0)
 ..S RETURN=$$INTERNAL(120.86,1,^XTMP("ORRDI","ART",DFN,"ASSESSMENT",1))
"RTN","GMRADPT",121,0)
 ..I RETURN=1 S GMRAL=1
"RTN","GMRADPT",122,0)
 ..I GMRAL'=1,(RETURN=0) S GMRAL=0
"RTN","GMRADPT",123,0)
 Q:+GMRAL=0
"RTN","GMRADPT",124,0)
 D MECH
"RTN","GMRADPT",125,0)
 F GMRAREC=0:0 S GMRAREC=$O(^GMR(120.8,"B",DFN,GMRAREC)) Q:GMRAREC'>0  S GMRANODE=$S($D(^GMR(120.8,GMRAREC,0)):^(0),1:"") D:GMRANODE SETAL(0)
"RTN","GMRADPT",126,0)
 I +$G(REMOTE)>0 D
"RTN","GMRADPT",127,0)
 .N INDEX
"RTN","GMRADPT",128,0)
 .S INDEX=0 F  S INDEX=$O(^XTMP("ORRDI","ART",DFN,INDEX)) Q:+$G(INDEX)=0  D
"RTN","GMRADPT",129,0)
 ..N GMRANODE,GMRAREC,RETURN
"RTN","GMRADPT",130,0)
 ..S GMRAREC=$NA(^XTMP("ORRDI","ART",DFN,INDEX))
"RTN","GMRADPT",131,0)
 ..S RETURN=$$INTERNAL(120.8,17,$G(@GMRAREC@("MECHANISM",0)))
"RTN","GMRADPT",132,0)
 ..S:RETURN'=-1 $P(GMRANODE,U,14)=RETURN
"RTN","GMRADPT",133,0)
 ..S RETURN=$$UP^XLFSTR($E($G(@GMRAREC@("VERIFIED",0)),1))
"RTN","GMRADPT",134,0)
 ..S $P(GMRANODE,U,16)=$S(RETURN="Y":1,RETURN="N":0,1:"")
"RTN","GMRADPT",135,0)
 ..S $P(GMRANODE,U,20)=$P($G(@GMRAREC@("TYPE",0)),U,1)
"RTN","GMRADPT",136,0)
 ..D SETAL(1)
"RTN","GMRADPT",137,0)
 I GMRAL=1,$O(GMRAL(0))="" S GMRAL=0
"RTN","GMRADPT",138,0)
 K GMRA
"RTN","GMRADPT",139,0)
 Q
"RTN","GMRADPT",140,0)
INTERNAL(FILE,FIELD,VALUE) ;RETURN INTERNAL VALUE OF VUID
"RTN","GMRADPT",141,0)
 ;PARAMETERS: FILE => FILE NUMBER WHERE THE DATA RESIDES
"RTN","GMRADPT",142,0)
 ;            FIELD => FIELD NUMBER WHERE THE DATA RESIDES
"RTN","GMRADPT",143,0)
 ;            VALUE => CARET-DELIMITED STRING WHERE THE FIRST
"RTN","GMRADPT",144,0)
 ;                     PIECE CONTAINS THE VUID
"RTN","GMRADPT",145,0)
 ;RETURNS: -1 => BAD INPUT PARAMETERS
"RTN","GMRADPT",146,0)
 ;         INTERNAL VALUE OF VUID
"RTN","GMRADPT",147,0)
 N RETURN
"RTN","GMRADPT",148,0)
 S RETURN=-1
"RTN","GMRADPT",149,0)
 Q:$G(VALUE)="" RETURN
"RTN","GMRADPT",150,0)
 N GMRARRAY
"RTN","GMRADPT",151,0)
 D GETIREF^XTID(FILE,,$P(VALUE,U,1),"GMRARRAY")
"RTN","GMRADPT",152,0)
 S:$D(GMRARRAY(FILE,FIELD))>9 RETURN=$O(GMRARRAY(FILE,FIELD,""))
"RTN","GMRADPT",153,0)
 Q RETURN
"RTN","GMRADPT",154,0)
SETAL(REMOTE) ;DETERMINE WHETHER TO RETURN CURRENT ALLERGY
"RTN","GMRADPT",155,0)
 ;PARAMETER: REMOTE => 0 IF ALLERGY IS LOCAL, 1 IF IT IS REMOTE
"RTN","GMRADPT",156,0)
 N %,GMRAI,GMRASIGN
"RTN","GMRADPT",157,0)
 I 'REMOTE,(+$G(^GMR(120.8,GMRAREC,"ER"))) Q  ;IF LOCAL AND ENTERED IN ERROR QUIT (REMOTE ENTERED IN ERROR ALREADY FILTERED)
"RTN","GMRADPT",158,0)
 I GMRAL'=1 S GMRAL=1 ; PATIENT HAS ALLERGIES
"RTN","GMRADPT",159,0)
 S GMRAI=0 ; BEGIN CHECK FOR ADR/ALL CRITERIA
"RTN","GMRADPT",160,0)
 I '$P(GMRA,"^") S GMRAI=1
"RTN","GMRADPT",161,0)
 E  I $P(GMRA,"^")=1 S:$F("AU",$P(GMRANODE,"^",14))>1 GMRAI=1
"RTN","GMRADPT",162,0)
 E  S:$F("P",$P(GMRANODE,"^",14))>1 GMRAI=1
"RTN","GMRADPT",163,0)
 Q:'GMRAI  ; QUIT IF ADR/ALL CRITERIA NOT MET
"RTN","GMRADPT",164,0)
 Q:2-$P(GMRA,"^",2)=(1-$P(GMRANODE,"^",16))  ;QUIT IF VER/NON VER CRITERIA NOT MET
"RTN","GMRADPT",165,0)
 S GMRAI=0 ; BEGIN CHECK FOR ALLERGY TYPE CRITERIA
"RTN","GMRADPT",166,0)
 F %=1:1:3 I $E($P(GMRA,"^",3),%),$P(GMRANODE,"^",20)[$E("OFD",%) S GMRAI=1 Q
"RTN","GMRADPT",167,0)
 Q:'GMRAI  ; QUIT IF ALLERGY TYPE CRITERIA NOT MET
"RTN","GMRADPT",168,0)
 D DATA(.GMRAREC,.GMRAL)
"RTN","GMRADPT",169,0)
 Q
"RTN","GMRADPT",170,0)
DATA(GMRAREC,GMRAL) ;RETRIEVE THE APPROPRIATE DATA
"RTN","GMRADPT",171,0)
 ;PARAMETERS: GMRAREC => REFERENCE TO THE VARIABLE CONTAINING THE CURRENT ALLERGY'S IEN
"RTN","GMRADPT",172,0)
 ;            GMRAL => REFERENCE TO THE ARRAY IN WHICH TO RETURN DATA
"RTN","GMRADPT",173,0)
 D:+$G(GMRAREC)>0 PASS(.GMRAREC,.GMRAL)
"RTN","GMRADPT",174,0)
 D:+$G(GMRAREC)=0 REMOTE(.GMRAL,.GMRAREC)
"RTN","GMRADPT",175,0)
 Q
"RTN","GMRADPT",176,0)
PASS(GMRAREC,GMRAL) ;RETRIEVE LOCAL DATA
"RTN","GMRADPT",177,0)
 ;PARAMETERS: GMRAREC => IEN OF THE CURRENT ALLERGY
"RTN","GMRADPT",178,0)
 ;            GMRAL => ARRAY IN WHICH TO RETURN DATA
"RTN","GMRADPT",179,0)
 N GMRANODE,%,GMRAX,GMRAY,GMRAZ,GMRAKC
"RTN","GMRADPT",180,0)
 I '$D(MECH) D
"RTN","GMRADPT",181,0)
 .D MECH
"RTN","GMRADPT",182,0)
 .S GMRAKC=1
"RTN","GMRADPT",183,0)
 S GMRANODE=$G(^GMR(120.8,GMRAREC,0)) Q:GMRANODE=""
"RTN","GMRADPT",184,0)
 S %=$P(GMRANODE,U,14)
"RTN","GMRADPT",185,0)
 S GMRAL(GMRAREC)=$P(GMRANODE,U,1,2)_U_$E($P(GMRANODE,U,20))_U_+$P(GMRANODE,U,16)_U_$S(%="A"!(%="U"):0,1:1)
"RTN","GMRADPT",186,0)
 S GMRAL(GMRAREC)=GMRAL(GMRAREC)_U_$S(%="A":"ALLERGY;0",%="P":"PHARMACOLOGIC;2",%="U":"UNKNOWN;U",1:"")_U_$P(GMRANODE,U,20)_U_$S(%'="":$G(MECH(%)),1:"")
"RTN","GMRADPT",187,0)
 S GMRAL(GMRAREC)=GMRAL(GMRAREC)_U_$P(GMRANODE,U,3)
"RTN","GMRADPT",188,0)
 ;*BD
"RTN","GMRADPT",189,0)
 I '$G(GMRAV1) D
"RTN","GMRADPT",190,0)
 .;*ED
"RTN","GMRADPT",191,0)
 .S %=$P(GMRANODE,U,6)
"RTN","GMRADPT",192,0)
 .S GMRAL(GMRAREC)=GMRAL(GMRAREC)_U_$$EXTERNAL^DILFD(120.8,6,,%)_";"_%
"RTN","GMRADPT",193,0)
 .I $D(^GMR(120.85,"C",GMRAREC))>9 D
"RTN","GMRADPT",194,0)
 ..N IEN,IDX
"RTN","GMRADPT",195,0)
 ..S IEN=0 F  S IEN=$O(^GMR(120.85,"C",GMRAREC,IEN)) Q:'+IEN  D
"RTN","GMRADPT",196,0)
 ...S IDX=1+$G(IDX),%=$P($G(^GMR(120.85,IEN,0)),U,14)
"RTN","GMRADPT",197,0)
 ...S GMRAL(GMRAREC,"O",IDX)=$$EXTERNAL^DILFD(120.85,14.5,,%)_";"_%_U
"RTN","GMRADPT",198,0)
 ...S %=$P($G(^GMR(120.85,IEN,0)),U)
"RTN","GMRADPT",199,0)
 ...S GMRAL(GMRAREC,"O",IDX)=GMRAL(GMRAREC,"O",IDX)_$$EXTERNAL^DILFD(120.85,.01,,%)_";"_%
"RTN","GMRADPT",200,0)
 I $O(^GMR(120.8,GMRAREC,10,0)) D
"RTN","GMRADPT",201,0)
 .S GMRAX=0,GMRAY=1 F  S GMRAX=$O(^GMR(120.8,GMRAREC,10,GMRAX)) Q:GMRAX<1  D
"RTN","GMRADPT",202,0)
 ..S GMRAZ=$G(^GMR(120.8,GMRAREC,10,GMRAX,0))
"RTN","GMRADPT",203,0)
 ..Q:GMRAZ=""
"RTN","GMRADPT",204,0)
 ..S GMRAZ(1)=$S(+GMRAZ'=GMRAOTH:$P($G(^GMRD(120.83,+GMRAZ,0)),U)_";"_+GMRAZ,1:$P(GMRAZ,U,2)_";"_+GMRAZ)
"RTN","GMRADPT",205,0)
 ..;*BD
"RTN","GMRADPT",206,0)
 ..I '$G(GMRAV1) D
"RTN","GMRADPT",207,0)
 ...;*ED (CLEAN UP PERIODS)
"RTN","GMRADPT",208,0)
 ...S GMRAZ(1)=GMRAZ(1)_U_$$FMTE^XLFDT($P(GMRAZ,U,4))_";"_$P(GMRAZ,U,4)
"RTN","GMRADPT",209,0)
 ..S GMRAL(GMRAREC,"S",GMRAY)=GMRAZ(1),GMRAY=GMRAY+1
"RTN","GMRADPT",210,0)
 K:+$G(GMRAKC) MECH
"RTN","GMRADPT",211,0)
 Q
"RTN","GMRADPT",212,0)
REMOTE(GMRAL,NODE) ;RETRIEVE REMOTE DATA
"RTN","GMRADPT",213,0)
 ;PARAMETERS: GMRAL => ARRAY IN WHICH TO RETURN DATA
"RTN","GMRADPT",214,0)
 ;            NODE => IEN OF THE CURRENT ALLERGY
"RTN","GMRADPT",215,0)
 S MECH=$P(GMRANODE,U,14)
"RTN","GMRADPT",216,0)
 ;A, B, & C
"RTN","GMRADPT",217,0)
 S GMRAL("R"_INDEX)=DFN_U_$G(@NODE@("REACTANT",0))_U_U
"RTN","GMRADPT",218,0)
 ;D
"RTN","GMRADPT",219,0)
 S GMRAL("R"_INDEX)=GMRAL("R"_INDEX)_+$P(GMRANODE,U,16)_U
"RTN","GMRADPT",220,0)
 ;E & F
"RTN","GMRADPT",221,0)
 S GMRAL("R"_INDEX)=GMRAL("R"_INDEX)_$S(MECH="A"!(MECH="U"):0,1:1)_U_U
"RTN","GMRADPT",222,0)
 ;G
"RTN","GMRADPT",223,0)
 S GMRAL("R"_INDEX)=GMRAL("R"_INDEX)_$P(GMRANODE,U,20)_U
"RTN","GMRADPT",224,0)
 ;H
"RTN","GMRADPT",225,0)
 S GMRAL("R"_INDEX)=GMRAL("R"_INDEX)_$S(MECH'="":$G(MECH(MECH)),1:"")_U
"RTN","GMRADPT",226,0)
 ;I
"RTN","GMRADPT",227,0)
 N VUID,FILE,IEN,GLOBAL,RETURN,ERROR,GMRARRAY
"RTN","GMRADPT",228,0)
 S VUID=$P($G(@NODE@("GMRALLERGY",0)),U,1)
"RTN","GMRADPT",229,0)
 S FILE=$P($P($G(@NODE@("GMRALLERGY",0)),U,3),"99VA",2)
"RTN","GMRADPT",230,0)
 I FILE>0 D
"RTN","GMRADPT",231,0)
 .D FILE^DID(FILE,,"GLOBAL NAME","RETURN","ERROR")
"RTN","GMRADPT",232,0)
 .Q:$D(ERROR)
"RTN","GMRADPT",233,0)
 .D GETIREF^XTID(FILE,,VUID,"GMRARRAY")
"RTN","GMRADPT",234,0)
 .S IEN=0 F  S IEN=$O(GMRARRAY(FILE,.01,IEN)) Q:+$G(IEN)=0  D
"RTN","GMRADPT",235,0)
 ..S $P(GMRAL("R"_INDEX),U,9)=+IEN_";"_$P(RETURN("GLOBAL NAME"),U,2)
"RTN","GMRADPT",236,0)
 S GMRAL("R"_INDEX)=GMRAL("R"_INDEX)_U
"RTN","GMRADPT",237,0)
 ;J
"RTN","GMRADPT",238,0)
 N OBSHIS
"RTN","GMRADPT",239,0)
 I $D(@NODE@("OBS/HISTORICAL"))>9 D
"RTN","GMRADPT",240,0)
 .N GMRARRAY
"RTN","GMRADPT",241,0)
 .D GETIREF^XTID(120.8,,$P($G(@NODE@("OBS/HISTORICAL",0)),U,1),"GMRARRAY")
"RTN","GMRADPT",242,0)
 .S OBSHIS=$O(GMRARRAY(120.8,6,"")),OBSHIS=$$EXTERNAL^DILFD(120.8,6,,OBSHIS)_";"_OBSHIS
"RTN","GMRADPT",243,0)
 S GMRAL("R"_INDEX)=GMRAL("R"_INDEX)_$G(OBSHIS)
"RTN","GMRADPT",244,0)
 ;K
"RTN","GMRADPT",245,0)
 I $D(@NODE@("SEVERITY"))>9 D
"RTN","GMRADPT",246,0)
 .S GMRAL("R"_INDEX,"O",1)=$P($G(@NODE@("SEVERITY",0)),U,2)_";"_$P($G(@NODE@("SEVERITY",0)),U)_U
"RTN","GMRADPT",247,0)
 N SINDEX,DATE
"RTN","GMRADPT",248,0)
 S SINDEX=0 F  S SINDEX=$O(@NODE@("SIGNS/SYMPTOMS",SINDEX)) Q:+$G(SINDEX)=0  D
"RTN","GMRADPT",249,0)
 .I $P($G(@NODE@("SIGNS/SYMPTOMS",SINDEX)),U,3)="L" D
"RTN","GMRADPT",250,0)
 ..S GMRAL("R"_INDEX,"S",SINDEX)=$P($G(@NODE@("SIGNS/SYMPTOMS",SINDEX)),U,2)_";"_GMRAOTH
"RTN","GMRADPT",251,0)
 .I $P($G(@NODE@("SIGNS/SYMPTOMS",SINDEX)),U,3)'="L" D
"RTN","GMRADPT",252,0)
 ..N GMRARRAY
"RTN","GMRADPT",253,0)
 ..S VUID=$P($G(@NODE@("SIGNS/SYMPTOMS",SINDEX)),U,1)
"RTN","GMRADPT",254,0)
 ..S FILE=$P($P($G(@NODE@("SIGNS/SYMPTOMS",SINDEX)),U,3),"99VA",2)
"RTN","GMRADPT",255,0)
 ..D GETIREF^XTID(FILE,,VUID,"GMRARRAY")
"RTN","GMRADPT",256,0)
 ..S IEN=0 F  S IEN=$O(GMRARRAY(FILE,.01,IEN)) Q:+$G(IEN)=0  D
"RTN","GMRADPT",257,0)
 ...S GMRAL("R"_INDEX,"S",SINDEX)=$P($G(@NODE@("SIGNS/SYMPTOMS",SINDEX)),U,2)_";"_+IEN
"RTN","GMRADPT",258,0)
 .S DATE=$$HL7TFM^XLFDT($G(@NODE@("SIGNS/SYMPTOMS",SINDEX,"DATE_ENTERED",0)))
"RTN","GMRADPT",259,0)
 .S $P(GMRAL("R"_INDEX,"S",SINDEX),U,2)=$$FMTE^XLFDT(DATE)_";"_DATE
"RTN","GMRADPT",260,0)
 S GMRAL("R"_INDEX,"SITE")=$G(@NODE@("FACILITY",0))
"RTN","GMRADPT",261,0)
MECH ;CREATE MECHANISM ARRAY
"RTN","GMRADPT",262,0)
 S MECH("A")="ALLERGY;A",MECH("P")="PHARMACOLOGIC;P",MECH("U")="UNKNOWN;U"
"RTN","GMRADPT",263,0)
 Q
"RTN","GMRAOR")
0^1^B152346772^B151697530
"RTN","GMRAOR",1,0)
GMRAOR ;HIRMFO/WAA,RM - ORDER CHECK UTILITY ;04/01/2016  14:51
"RTN","GMRAOR",2,0)
 ;;4.0;Adverse Reaction Tracking;**2,13,26,37,41,42,44,46,52**;Mar 29, 1996;Build 7
"RTN","GMRAOR",3,0)
 Q
"RTN","GMRAOR",4,0)
ORCHK(DFN,TYP,PTR,LOC) ;DETERMINE IF PATIENT HAS ADVERSE REACTION TO AGENT
"RTN","GMRAOR",5,0)
 ;CONTROLLED BY SUPPORTED INTEGRATION AGREEMENT #2378
"RTN","GMRAOR",6,0)
 ;*BD
"RTN","GMRAOR",7,0)
 N GMRAFLG,GMRACM,DA,GMRAV1,GMRAOTH
"RTN","GMRAOR",8,0)
 S GMRAFLG=0,GMRAV1=1,GMRAOTH=+$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRAOR",9,0)
 I $G(DFN)<1!("^CM^DR^IN^CL^"'[("^"_$G(TYP)_"^"))!($G(TYP)'="CM"&($G(PTR)<1)) S GMRAFLG=""
"RTN","GMRAOR",10,0)
 E  D
"RTN","GMRAOR",11,0)
 .K GMRAING,GMRADRCL,GMRAIEN
"RTN","GMRAOR",12,0)
 .D GETDATA(DFN)
"RTN","GMRAOR",13,0)
 .I TYP="CM" S GMRAFLG=$$RAD(DFN,+$G(LOC))
"RTN","GMRAOR",14,0)
 .I TYP="DR" S GMRAFLG=$$DRUG(DFN,PTR)
"RTN","GMRAOR",15,0)
 .I TYP="IN" S GMRAFLG=$$ING(DFN,PTR)
"RTN","GMRAOR",16,0)
 .I TYP="CL" S GMRAFLG=$$CLASS(DFN,PTR)
"RTN","GMRAOR",17,0)
 K ^TMP("GMRAOC",$J)
"RTN","GMRAOR",18,0)
 Q GMRAFLG
"RTN","GMRAOR",19,0)
 ;*ED
"RTN","GMRAOR",20,0)
 Q $$ORCHK2(DFN,TYP,PTR,LOC)
"RTN","GMRAOR",21,0)
ORCHK2(DFN,TYP,PTR,LOC,RETURN) ;DETERMINE IF PATIENT HAS ADVERSE REACTION TO AGENT
"RTN","GMRAOR",22,0)
 ;CONTROLLED BY SUPPORTED INTEGRATION AGREEMENT #2378
"RTN","GMRAOR",23,0)
 ;PARAMETERS: DFN => IEN IN THE PATIENT FILE (#2)
"RTN","GMRAOR",24,0)
 ;            TYP => TYPE OF CHECK TO PERFORM
"RTN","GMRAOR",25,0)
 ;                   "CM": CONTRAST MEDIA
"RTN","GMRAOR",26,0)
 ;                   "DR": DRUG
"RTN","GMRAOR",27,0)
 ;                   "IN": DRUG INGREDIENT
"RTN","GMRAOR",28,0)
 ;                   "CL": DRUG CLASS
"RTN","GMRAOR",29,0)
 ;            PTR => AGENT
"RTN","GMRAOR",30,0)
 ;                   TYP="CM", PTR IS IGNORED
"RTN","GMRAOR",31,0)
 ;                   TYP="DR", PTR=PSNDA.PSNVPN.LPTR, WHERE
"RTN","GMRAOR",32,0)
 ;                             PSNDA IS IEN IN VA GENERIC FILE (#50.6),
"RTN","GMRAOR",33,0)
 ;                             PSNVPN IS IEN IN VA PRODUCT FILE (#50.68), AND
"RTN","GMRAOR",34,0)
 ;                             LPTR IS IEN IN DRUG FILE (#50)
"RTN","GMRAOR",35,0)
 ;                   TYP="IN", PTR=IEN IN DRUG INGREDIENTS FILE (#50.416)
"RTN","GMRAOR",36,0)
 ;                   TYP="CL", PTR=IEN IN VA DRUG CLASS FILE (#50.605)
"RTN","GMRAOR",37,0)
 ;            LOC => FOR TYP="CM" ONLY, 1 TO RETURN LOCATION(S) IN SECOND CARET PIECE OF $$ORCHK
"RTN","GMRAOR",38,0)
 ;                   FOR TYP="CM" ONLY, 0 OR UNDEFINED TO NOT RETURN LOCATION(S) IN SECOND CARET PIECE OF $$ORCHK
"RTN","GMRAOR",39,0)
 ;            RETURN => FOR TYP="DR" ONLY, NAME OF ARRAY IN WHICH TO RETURN ORDER CHECK MESSAGES AND REACTION DATA
"RTN","GMRAOR",40,0)
 ;RETURN: -1 => BAD PARAMETERS
"RTN","GMRAOR",41,0)
 ;        EMPTY STRING => NO ASSESSMENT
"RTN","GMRAOR",42,0)
 ;        0 => NO REACTION
"RTN","GMRAOR",43,0)
 ;        1 => FOR TYP="CM", PATIENT HAS REACTION
"RTN","GMRAOR",44,0)
 ;             FOR TYP="IN" AND TYP="CL", PATIENT HAS REACTION; INGREDIENT(S) RETURNED IN GMRAING() AND
"RTN","GMRAOR",45,0)
 ;                                        DRUG CLASS(ES) IN GMRADRCL()
"RTN","GMRAOR",46,0)
 ;             FOR TYP="DR", PATIENT HAS REACTION
"RTN","GMRAOR",47,0)
 I +$G(DFN)<1!("^CM^DR^IN^CL^"'[(U_$G(TYP)_U)) Q -1
"RTN","GMRAOR",48,0)
 I $G(TYP)="DR",PTR'?.N.1".".N.1".".N Q -1
"RTN","GMRAOR",49,0)
 I +$G(PTR)<1,($G(TYP)="IN"!($G(TYP)="CL")) Q -1
"RTN","GMRAOR",50,0)
 I +$G(LOC)>0,($G(TYP)'="CM") Q -1
"RTN","GMRAOR",51,0)
 I $G(TYP)="DR" I $G(RETURN)=""!($G(RETURN)="RETURN") Q -1
"RTN","GMRAOR",52,0)
 K GMRAING,GMRADRCL,GMRAREAC
"RTN","GMRAOR",53,0)
 N GMRAFLG,GMRASESS,IDX,GMRAOTH
"RTN","GMRAOR",54,0)
 S GMRAFLG=0,GMRASESS="",GMRAOTH=+$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRAOR",55,0)
 ;*BD MOVE CODE IN LINETAG TO HERE
"RTN","GMRAOR",56,0)
 D GETDATA(DFN)
"RTN","GMRAOR",57,0)
 ;*ED
"RTN","GMRAOR",58,0)
 S GMRASESS=$$NKA^GMRANKA(DFN)
"RTN","GMRAOR",59,0)
 I +GMRASESS=0,($D(^XTMP("ORRDI","ART",DFN,"ASSESSMENT"))>9) D
"RTN","GMRAOR",60,0)
 .S IDX=0 F  S IDX=$O(^XTMP("ORRDI","ART",DFN,"ASSESSMENT",IDX)) Q:'IDX  D
"RTN","GMRAOR",61,0)
 ..I $P(^XTMP("ORRDI","ART",DFN,"ASSESSMENT",IDX),U,2)="YES" S GMRASESS=1
"RTN","GMRAOR",62,0)
 ..I GMRASESS'=1,($P(^XTMP("ORRDI","ART",DFN,"ASSESSMENT",IDX),U,2)'="YES") S GMRASESS=0
"RTN","GMRAOR",63,0)
 Q:'+GMRASESS GMRASESS
"RTN","GMRAOR",64,0)
 I TYP="CM" S GMRAFLG=$$RAD(DFN,+$G(LOC))
"RTN","GMRAOR",65,0)
 I TYP="DR" S GMRAFLG=$$DRUG(DFN,PTR)
"RTN","GMRAOR",66,0)
 I TYP="IN" S GMRAFLG=$$ING(DFN,PTR)
"RTN","GMRAOR",67,0)
 I TYP="CL" S GMRAFLG=$$CLASS(DFN,PTR)
"RTN","GMRAOR",68,0)
 K ^TMP("GMRAOC",$J)
"RTN","GMRAOR",69,0)
 Q GMRAFLG
"RTN","GMRAOR",70,0)
RAD(DFN,LOC) ;CONTRAST MEDIA CHECK
"RTN","GMRAOR",71,0)
 ;PARAMTERS: DFN => IEN IN THE PATIENT FILE (#2)
"RTN","GMRAOR",72,0)
 ;           LOC => 1 TO RETURN LOCATION(S)
"RTN","GMRAOR",73,0)
 ;                  0 OR UNDEFINED TO NOT RETURN LOCATION(S)
"RTN","GMRAOR",74,0)
 ;RETURN: HAS_REACTION^LOCATION(S), WHERE
"RTN","GMRAOR",75,0)
 ;        HAS_REACTION IS 0 FOR PATIENT DOES NOT HAVE A REACTION
"RTN","GMRAOR",76,0)
 ;        AND 1 IS FOR PATIENT HAS REACTION AND
"RTN","GMRAOR",77,0)
 ;        LOCATION(S) IS A SCREEN-PRINTABLE STRING OF ALL THE LOCATIONS DOCUMENTING
"RTN","GMRAOR",78,0)
 ;        A REACTION
"RTN","GMRAOR",79,0)
 N FLG,DC,DELIMIT,REACT,SITES,SITE,GMRACM,COUNT
"RTN","GMRAOR",80,0)
 ;*BD
"RTN","GMRAOR",81,0)
 N LOCAL,REMOTE
"RTN","GMRAOR",82,0)
 ;*ED
"RTN","GMRAOR",83,0)
 S FLG=0,DC="DX10" F  S DC=$O(^TMP("GMRAOC",$J,"APC",DC)) Q:DC'["DX10"  D
"RTN","GMRAOR",84,0)
 .S FLG=1
"RTN","GMRAOR",85,0)
 .I $G(LOC) D
"RTN","GMRAOR",86,0)
 ..;*BD
"RTN","GMRAOR",87,0)
 ..I $G(GMRAV1) D
"RTN","GMRAOR",88,0)
 ...I $G(^TMP("GMRAOC",$J,"APC",DC))["LOCAL" S LOCAL=1
"RTN","GMRAOR",89,0)
 ...I $G(^TMP("GMRAOC",$J,"APC",DC))["REMOTE" S REMOTE=1
"RTN","GMRAOR",90,0)
 ..I '$G(GMRAV1) D
"RTN","GMRAOR",91,0)
 ...;*ED (C U DOTS)
"RTN","GMRAOR",92,0)
 ...S REACT="" F  S REACT=$O(^TMP("GMRAOC",$J,"APC",DC,REACT)) Q:REACT=""  D
"RTN","GMRAOR",93,0)
 ....Q:$D(SITES(REACT))
"RTN","GMRAOR",94,0)
 ....S SITES=1+$G(SITES),SITES(REACT)=$$GET1^DIQ(4,$P(^TMP("GMRAOC",$J,"APC",DC,REACT),U),.01)
"RTN","GMRAOR",95,0)
 ....S SITES(REACT)=SITES(REACT)_" entered on "_$$FMTE^XLFDT($P(^TMP("GMRAOC",$J,"APC",DC,REACT),U,3))
"RTN","GMRAOR",96,0)
 I $G(LOC) D
"RTN","GMRAOR",97,0)
 .;*BD
"RTN","GMRAOR",98,0)
 .I $G(GMRAV1) D
"RTN","GMRAOR",99,0)
 ..S GMRACM=$S($G(LOCAL)&($G(REMOTE)):"LOCAL AND REMOTE SITE(S)",$G(LOCAL):"LOCAL",$G(REMOTE):"REMOTE SITE(S)",1:"")
"RTN","GMRAOR",100,0)
 .I '$G(GMRAV1) D
"RTN","GMRAOR",101,0)
 ..;*ED (C U DOTS)
"RTN","GMRAOR",102,0)
 ..S DELIMIT=", ",SITE="",COUNT=1
"RTN","GMRAOR",103,0)
 ..F  S SITE=$O(SITES(SITE)) Q:SITE=""  D
"RTN","GMRAOR",104,0)
 ...S:COUNT=SITES DELIMIT=" and "
"RTN","GMRAOR",105,0)
 ...S GMRACM=$S($G(GMRACM)'="":GMRACM_DELIMIT,1:"")_SITES(SITE),COUNT=COUNT+1
"RTN","GMRAOR",106,0)
 Q FLG_$S($G(GMRACM)'="":U_GMRACM,1:"")
"RTN","GMRAOR",107,0)
DRUG(DFN,PTR) ;DRUG CHECK
"RTN","GMRAOR",108,0)
 ;PARAMTERS: DFN => IEN IN THE PATIENT FILE (#2)
"RTN","GMRAOR",109,0)
 ;           PTR => PSNDA.PSNVPN.LPTR, WHERE
"RTN","GMRAOR",110,0)
 ;                  PSNDA IS IEN IN VA GENERIC FILE (#50.6),
"RTN","GMRAOR",111,0)
 ;                  PSNVPN IS IEN IN VA PRODUCT FILE (#50.68), AND
"RTN","GMRAOR",112,0)
 ;                  LPTR IS IEN IN DRUG FILE (#50)
"RTN","GMRAOR",113,0)
 ;RETURN: 1 => REACTION TO DRUG
"RTN","GMRAOR",114,0)
 ;        0 => NO REACTION TO DRUG
"RTN","GMRAOR",115,0)
 N %,FLG,GMRAC,GMRADR,GMRAI,PSNVPN,PSNDA,LPTR,GMRANVPN,GMRANDA,REACT,CLASS,GMRALIST
"RTN","GMRAOR",116,0)
 N TMPFLG,REACS,NODE
"RTN","GMRAOR",117,0)
 S (FLG,TMPFLG)=0,GMRANDA=$P(PTR,"."),GMRANVPN=$P(PTR,".",2),LPTR=$P(PTR,".",3)
"RTN","GMRAOR",118,0)
 I GMRANDA>0,($G(@($$NDFREF_GMRANDA_",0)"))'="") D
"RTN","GMRAOR",119,0)
 .;INGREDIENT
"RTN","GMRAOR",120,0)
 .S PSNDA=GMRANDA
"RTN","GMRAOR",121,0)
 .I $T(DISPDRG^PSNNGR)]"",GMRANVPN]"" D
"RTN","GMRAOR",122,0)
 ..S NODE="PSNDD",PSNVPN=GMRANVPN
"RTN","GMRAOR",123,0)
 ..K ^TMP(NODE,$J)
"RTN","GMRAOR",124,0)
 ..D DISPDRG^PSNNGR
"RTN","GMRAOR",125,0)
 .I $T(DISPDRG^PSNNGR)=""!(GMRANVPN="") D
"RTN","GMRAOR",126,0)
 ..S NODE="PSN"
"RTN","GMRAOR",127,0)
 ..K ^TMP(NODE,$J)
"RTN","GMRAOR",128,0)
 ..D ^PSNNGR
"RTN","GMRAOR",129,0)
 .S GMRAI=0,%=1 F  S GMRAI=$O(^TMP(NODE,$J,GMRAI)) Q:GMRAI<1  I $D(^TMP("GMRAOC",$J,"API",GMRAI)) D
"RTN","GMRAOR",130,0)
 ..S FLG=1
"RTN","GMRAOR",131,0)
 ..;*BD (C U % VAR)
"RTN","GMRAOR",132,0)
 ..I $G(GMRAV1) S GMRAING(%)=^TMP(NODE,$J,GMRAI)_$$FAC(^TMP("GMRAOC",$J,"API",GMRAI)),%=%+1
"RTN","GMRAOR",133,0)
 ..I '$G(GMRAV1) D
"RTN","GMRAOR",134,0)
 ...;*ED (C U DOTS)
"RTN","GMRAOR",135,0)
 ...S REACT="" F  S REACT=$O(^TMP("GMRAOC",$J,"API",GMRAI,REACT)) Q:REACT=""  D
"RTN","GMRAOR",136,0)
 ....S REACS(REACT)=$G(^TMP("GMRAOC",$J,"API",GMRAI,REACT))
"RTN","GMRAOR",137,0)
 ....I $G(REACS(REACT,"ING"))'[GMRAI S REACS(REACT,"ING")=$S($D(REACS(REACT,"ING")):REACS(REACT,"ING")_"~",1:"")_^TMP(NODE,$J,GMRAI)_U_GMRAI
"RTN","GMRAOR",138,0)
 .K ^TMP(NODE,$J)
"RTN","GMRAOR",139,0)
 .;*BD
"RTN","GMRAOR",140,0)
 .I $G(GMRAV1),FLG Q
"RTN","GMRAOR",141,0)
 .;*ED
"RTN","GMRAOR",142,0)
 .;DRUG CLASS
"RTN","GMRAOR",143,0)
 .I GMRANVPN D  Q
"RTN","GMRAOR",144,0)
 ..S CLASS=$$DCLCODE^PSNAPIS(GMRANDA,GMRANVPN)
"RTN","GMRAOR",145,0)
 ..S TMPFLG=$$PCCHK(CLASS)
"RTN","GMRAOR",146,0)
 ..S:TMPFLG>0 FLG=TMPFLG
"RTN","GMRAOR",147,0)
 .S GMRALIST=$$CLIST^PSNAPIS(GMRANDA,.GMRALIST) Q:'$G(GMRALIST)
"RTN","GMRAOR",148,0)
 .S GMRALIST=0 F  S GMRALIST=$O(GMRALIST(GMRALIST)) Q:'GMRALIST  D
"RTN","GMRAOR",149,0)
 ..S TMPFLG=$$PCCHK($P(GMRALIST(GMRALIST),U,2))
"RTN","GMRAOR",150,0)
 ..S:TMPFLG>0 FLG=TMPFLG
"RTN","GMRAOR",151,0)
 ;*BD
"RTN","GMRAOR",152,0)
 Q:$G(GMRAV1) FLG
"RTN","GMRAOR",153,0)
 ;*ED
"RTN","GMRAOR",154,0)
 I +LPTR>0 D
"RTN","GMRAOR",155,0)
 .;GMR ALLERGY
"RTN","GMRAOR",156,0)
 .N IEN,NAME
"RTN","GMRAOR",157,0)
 .S IEN=0 F  S IEN=$O(^GMR(120.8,"B",DFN,IEN)) Q:'+IEN!(+FLG=3)  D
"RTN","GMRAOR",158,0)
 ..I $P($G(^GMR(120.8,IEN,0)),U,3)=(LPTR_";PSDRUG("),('$P($G(^GMR(120.8,IEN,"ER")),U)) D
"RTN","GMRAOR",159,0)
 ...D DATA^PSS50(LPTR,,,,,"GMRALST")
"RTN","GMRAOR",160,0)
 ...S NAME=$G(^TMP($J,"GMRALST",LPTR,.01))
"RTN","GMRAOR",161,0)
 ...K ^TMP($J,"GMRALST")
"RTN","GMRAOR",162,0)
 ...D ADDLDATA($NA(REACS(IEN)),IEN)
"RTN","GMRAOR",163,0)
 ...S FLG=3
"RTN","GMRAOR",164,0)
 ...I $G(REACS(IEN,"REC"))'[NAME S REACS(IEN,"REC")=$S($D(REACS(IEN,"REC")):"~",1:"")_NAME_U_LPTR
"RTN","GMRAOR",165,0)
 .;DRUG CLASS
"RTN","GMRAOR",166,0)
 .I 'GMRANDA D
"RTN","GMRAOR",167,0)
 ..S TMPFLG=$$PCCHK($$DRP2VACL^GMRAPENC(LPTR))
"RTN","GMRAOR",168,0)
 ..S:TMPFLG>0 FLG=TMPFLG
"RTN","GMRAOR",169,0)
 S:FLG>0 FLG=1
"RTN","GMRAOR",170,0)
 K @RETURN
"RTN","GMRAOR",171,0)
 N STYPE,IPIECE,OPIECE,FIELDS,ITEM,FILE,NODE,FIELD,MSGNUM,RINDEX,SITE,SEV
"RTN","GMRAOR",172,0)
 S STYPE("L")="LOCAL",STYPE("R")="REMOTE"
"RTN","GMRAOR",173,0)
 S FIELDS(1,3)="120.8^4^3",FIELDS(1.1,1)="120.85^.01|14.5+^4",FIELDS(2,1)="120.81^.01*^5"
"RTN","GMRAOR",174,0)
 S FIELDS(2,2)="120.8^^6",FIELDS(2,3)="120.8^^7"
"RTN","GMRAOR",175,0)
 S FIELDS(2,3,"OTRANSFORM")="S Y=$S(Y["";PS(50.605,"":$P($G(^PS(50.605,+Y,0)),U,2),1:$P($G(@(U_$P(Y,"";"",2)_+Y_"",0)"")),U)) S:Y="""" Y=""UNKNOWN"""
"RTN","GMRAOR",176,0)
 S FIELDS(1,4)="120.8^6^8"
"RTN","GMRAOR",177,0)
 I $D(REACS)>9 D
"RTN","GMRAOR",178,0)
 .S REACT="" F  S REACT=$O(REACS(REACT)) Q:REACT=""  D
"RTN","GMRAOR",179,0)
 ..S REACT(1)=$S($P(REACS(REACT),U,7)'="":$P(REACS(REACT),U,7),1:$P(REACS(REACT),U,6))
"RTN","GMRAOR",180,0)
 ..S REACT(2)=$P(REACS(REACT),U,8) S:REACT(2)="" REACT(2)="UNKNOWN"
"RTN","GMRAOR",181,0)
 ..S REACT(3)=$P($P(REACS(REACT),U,4),"|",2) S:REACT(3)="" REACT(3)="UNKNOWN"
"RTN","GMRAOR",182,0)
 ..I $D(RINDEX(REACT(1),REACT(2),REACT(3))) S MSGNUM=$O(RINDEX(REACT(1),REACT(2),REACT(3),0))
"RTN","GMRAOR",183,0)
 ..E  S MSGNUM(0)=1+$G(MSGNUM(0)),MSGNUM=MSGNUM(0),RINDEX(REACT(1),REACT(2),REACT(3),MSGNUM)=""
"RTN","GMRAOR",184,0)
 ..S @RETURN@(MSGNUM,REACT)=REACS(REACT),SITE=$P(REACS(REACT),U),@RETURN@(MSGNUM,"MESSAGE",1)=1+$G(@RETURN@(MSGNUM,"MESSAGE",1))
"RTN","GMRAOR",185,0)
 ..F NODE="ING","CLS","REC" I $D(REACS(REACT,NODE)) F ITEM=1:1:$L(REACS(REACT,NODE),"~")  D
"RTN","GMRAOR",186,0)
 ...S $P(@RETURN@(MSGNUM,"MESSAGE","OFFENDERS",NODE),"~",ITEM)=$P($P(REACS(REACT,NODE),"~",ITEM),U)
"RTN","GMRAOR",187,0)
 ...S $P(@RETURN@(MSGNUM,REACT,NODE),"~",ITEM)=$P($P(REACS(REACT,NODE),"~",ITEM),U,2)
"RTN","GMRAOR",188,0)
 ..S @RETURN@(MSGNUM,"MESSAGE",1,SITE)=$$GET1^DIQ(4,$P(REACS(REACT),U)_",",.01)_U_STYPE($P(REACS(REACT),U,2))_U
"RTN","GMRAOR",189,0)
 ..S NODE=0 F  S NODE=$O(FIELDS(NODE)) Q:NODE=""  S OPIECE=0 F  S OPIECE=$O(FIELDS(NODE,OPIECE)) Q:OPIECE=""  D
"RTN","GMRAOR",190,0)
 ...S FILE=$P(FIELDS(NODE,OPIECE),U),FIELD=$P(FIELDS(NODE,OPIECE),U,2),IPIECE=$P(FIELDS(NODE,OPIECE),U,3)
"RTN","GMRAOR",191,0)
 ...I NODE=1 S RETURN=$NA(@RETURN@(MSGNUM,"MESSAGE",NODE,SITE))
"RTN","GMRAOR",192,0)
 ...I $L(NODE,".")=2 S RETURN=$NA(@RETURN@(MSGNUM,"MESSAGE",$P(NODE,"."),SITE,$P(NODE,".",2)))
"RTN","GMRAOR",193,0)
 ...I NODE'=1,NODE'["."  S RETURN=$NA(@RETURN@(MSGNUM,"MESSAGE",NODE))
"RTN","GMRAOR",194,0)
 ...I FIELD>0,FIELD'["*",FIELD'["+" S $P(@RETURN,U,OPIECE)=$$EXTERNAL^DILFD(FILE,FIELD,,$P(REACS(REACT),U,IPIECE))
"RTN","GMRAOR",195,0)
 ...I 'FIELD,'$D(FIELDS(NODE,OPIECE,"OTRANSFORM")) S $P(@RETURN,U,OPIECE)=$P(REACS(REACT),U,IPIECE)
"RTN","GMRAOR",196,0)
 ...I $D(FIELDS(NODE,OPIECE,"OTRANSFORM")) N Y S Y=$P(REACS(REACT),U,IPIECE) X:Y'="" FIELDS(NODE,OPIECE,"OTRANSFORM") S $P(@RETURN,U,OPIECE)=Y
"RTN","GMRAOR",197,0)
 ...I FIELD["*" D
"RTN","GMRAOR",198,0)
 ....N TEXT,DELIMIT,ITEMS,STR,COUNT,NEWIVAL
"RTN","GMRAOR",199,0)
 ....S DELIMIT=", ",COUNT=0,COUNT(1)=1
"RTN","GMRAOR",200,0)
 ....I $P($G(@RETURN),U,OPIECE)'="" F ITEM=1:1:$L($P(@RETURN,U,OPIECE),",")  S STR=$P($P(@RETURN,U,OPIECE),",",ITEM) S:$E(STR,1,5)=" and " STR=$E(STR,6,*) S ITEMS(STR)="",COUNT=1+$G(COUNT)
"RTN","GMRAOR",201,0)
 ....I $P(REACS(REACT),U,IPIECE)'="" F ITEM=1:1:$L($P(REACS(REACT),U,IPIECE),"~")  D
"RTN","GMRAOR",202,0)
 .....S STR=$P($P(REACS(REACT),U,IPIECE),"~",ITEM),$P(NEWIVAL,"~",ITEM)=+STR
"RTN","GMRAOR",203,0)
 .....I STR["-" S STR=$P(STR,"-",2)
"RTN","GMRAOR",204,0)
 .....E  S STR=$$EXTERNAL^DILFD(FILE,+FIELD,,STR)
"RTN","GMRAOR",205,0)
 .....I STR'="",'$D(ITEMS(STR)) S ITEMS(STR)="",COUNT=1+$G(COUNT)
"RTN","GMRAOR",206,0)
 ....S ITEM="" F  S ITEM=$O(ITEMS(ITEM)) Q:ITEM=""  D
"RTN","GMRAOR",207,0)
 .....S:COUNT(1)=COUNT DELIMIT=" and "
"RTN","GMRAOR",208,0)
 .....S TEXT=$S($G(TEXT)'="":TEXT_DELIMIT,1:"")_ITEM,COUNT(1)=1+COUNT(1)
"RTN","GMRAOR",209,0)
 ....S $P(@RETURN,U,OPIECE)=$G(TEXT),RETURN=$P(RETURN,"(")
"RTN","GMRAOR",210,0)
 ....I $G(NEWIVAL)'="",NEWIVAL'=$P(@RETURN@(MSGNUM,REACT),U,IPIECE) S $P(@RETURN@(MSGNUM,REACT),U,IPIECE)=NEWIVAL
"RTN","GMRAOR",211,0)
 ...I FIELD["+" D
"RTN","GMRAOR",212,0)
 ....N FNUM,ITEMS
"RTN","GMRAOR",213,0)
 ....F ITEM=1:1:$L($P(REACS(REACT),U,IPIECE),"~")  N STR F FNUM=1:1:$L(FIELD,"|")  D  S:STR'="" ITEMS(ITEM)=STR
"RTN","GMRAOR",214,0)
 .....S STR=$S($G(STR)'="":STR_U,1:"")_$$EXTERNAL^DILFD(FILE,+$P(FIELD,"|",FNUM),,$P($P($P(REACS(REACT),U,IPIECE),"~",ITEM),"|",FNUM))
"RTN","GMRAOR",215,0)
 ....M:$D(ITEMS)>9 @RETURN=ITEMS
"RTN","GMRAOR",216,0)
 ...S RETURN=$P(RETURN,"(")
"RTN","GMRAOR",217,0)
 .S @RETURN=MSGNUM(0)
"RTN","GMRAOR",218,0)
 Q FLG
"RTN","GMRAOR",219,0)
 ;*BD
"RTN","GMRAOR",220,0)
FAC(NODE) ;
"RTN","GMRAOR",221,0)
 N FAC
"RTN","GMRAOR",222,0)
 S FAC=$S($L(NODE):" ("_NODE_")",1:"")
"RTN","GMRAOR",223,0)
 Q FAC
"RTN","GMRAOR",224,0)
 ;*ED
"RTN","GMRAOR",225,0)
DRCL(CODE) ;POPULATE GMRADRCL()
"RTN","GMRAOR",226,0)
 ;PARAMTER: CODE => FIVE CHARACTER DRUG CLASS CODE TO ADD
"RTN","GMRAOR",227,0)
 ;RETURN: 0 => CODE NOT ADDED TO ARRAY
"RTN","GMRAOR",228,0)
 ;        2 => CODE ADDED TO THE ARRAY OR ALREADY EXISTS IN ARRAY
"RTN","GMRAOR",229,0)
 I '$L(CODE) Q 0
"RTN","GMRAOR",230,0)
 N CLSFN,REACT,RETURN,IEN
"RTN","GMRAOR",231,0)
 I '$D(^TMP("GMRAOC",$J,"APC",CODE)) S RETURN=$S($D(GMRADRCL):2,1:0)
"RTN","GMRAOR",232,0)
 Q:$D(RETURN) RETURN
"RTN","GMRAOR",233,0)
 Q:$D(GMRADRCL(CODE)) 2
"RTN","GMRAOR",234,0)
 Q:CODE="HA000" 0
"RTN","GMRAOR",235,0)
 S CLSFN=$$CODE2CL^GMRAPENC(CODE)
"RTN","GMRAOR",236,0)
 S IEN=$$CODE2CLP^GMRAPENC(CODE)
"RTN","GMRAOR",237,0)
 ;*BD (C U % VAR)
"RTN","GMRAOR",238,0)
 I $G(GMRAV1) D
"RTN","GMRAOR",239,0)
 .N J
"RTN","GMRAOR",240,0)
 .S J=$S('$D(GMRADRCL):1,1:$O(GMRADRCL(999),-1)+1)
"RTN","GMRAOR",241,0)
 .S GMRADRCL(J)=CODE_U_CLSFN_$$FAC(^TMP("GMRAOC",$J,"APC",CODE))
"RTN","GMRAOR",242,0)
 I '$G(GMRAV1) D
"RTN","GMRAOR",243,0)
 .;*ED (C U DOTS)
"RTN","GMRAOR",244,0)
 .S REACT="" F  S REACT=$O(^TMP("GMRAOC",$J,"APC",CODE,REACT)) Q:REACT=""  D
"RTN","GMRAOR",245,0)
 ..S REACS(REACT)=$G(^TMP("GMRAOC",$J,"APC",CODE,REACT))
"RTN","GMRAOR",246,0)
 ..I $G(REACS(REACT,"CLS"))'[CODE S REACS(REACT,"CLS")=$S($D(REACS(REACT,"CLS")):REACS(REACT,"CLS")_"~",1:"")_CODE_" "_CLSFN_U_IEN
"RTN","GMRAOR",247,0)
 Q 2
"RTN","GMRAOR",248,0)
PCCHK(VACLASS) ;PARTIAL DRUG CLASS CHECK
"RTN","GMRAOR",249,0)
 Q:$L($G(VACLASS))<4 0
"RTN","GMRAOR",250,0)
 N CL,I,RETURN
"RTN","GMRAOR",251,0)
 S CL=$S($E(VACLASS,1,4)="CN10":5,1:4),RETURN=0
"RTN","GMRAOR",252,0)
 S I="" F  S I=$O(^TMP("GMRAOC",$J,"APC",I)) Q:'$L(I)  D
"RTN","GMRAOR",253,0)
 .I $E(I,1,CL)=$E(VACLASS,1,CL) S RETURN=$$DRCL(I)
"RTN","GMRAOR",254,0)
 Q RETURN
"RTN","GMRAOR",255,0)
ING(DFN,PTR) ;DRUG INGREDIENT CHECK
"RTN","GMRAOR",256,0)
 ;PARAMTERS: DFN => IEN IN THE PATIENT FILE (#2)
"RTN","GMRAOR",257,0)
 ;           PTR => IEN IN THE DRUG INGREDIENTS FILE (#50.416)
"RTN","GMRAOR",258,0)
 ;RETURN: 0 => NO REACTION
"RTN","GMRAOR",259,0)
 ;        1 => REACTION
"RTN","GMRAOR",260,0)
 N GMRAX,FLG
"RTN","GMRAOR",261,0)
 S FLG=0,GMRAX=0
"RTN","GMRAOR",262,0)
 ;*BD
"RTN","GMRAOR",263,0)
 I $G(GMRAV1) D
"RTN","GMRAOR",264,0)
 .F  S GMRAX=$O(^GMR(120.8,"API",DFN,PTR,GMRAX)) Q:GMRAX<1  S FLG=1,GMRAIEN(GMRAX)=""
"RTN","GMRAOR",265,0)
 I '$G(GMRAV1) D
"RTN","GMRAOR",266,0)
 .;*ED (C U DOTS)
"RTN","GMRAOR",267,0)
 .K ^TMP($J,"GMRALST") D ZERO^PSN50P41(PTR,,,"GMRALST")
"RTN","GMRAOR",268,0)
 .F  S GMRAX=$O(^TMP("GMRAOC",$J,"API",PTR,GMRAX)) Q:GMRAX=""  D
"RTN","GMRAOR",269,0)
 ..S FLG=1,GMRAING(GMRAX)=$G(^TMP($J,"GMRALST",PTR,.01))_"|"_PTR_U_$G(^TMP("GMRAOC",$J,"API",PTR,GMRAX))
"RTN","GMRAOR",270,0)
 .K ^TMP($J,"GMRALST")
"RTN","GMRAOR",271,0)
 Q FLG
"RTN","GMRAOR",272,0)
CLASS(DFN,PTR) ;DRUG CLASS CHECK
"RTN","GMRAOR",273,0)
 ;PARAMTERS: DFN => IEN IN THE PATIENT FILE (#2)
"RTN","GMRAOR",274,0)
 ;           PTR => IEN IN THE VA DRUG CLASS FILE (#50.605)
"RTN","GMRAOR",275,0)
 ;RETURN: 0 => NO REACTION
"RTN","GMRAOR",276,0)
 ;        1 => REACTION
"RTN","GMRAOR",277,0)
 N GMRAC,GMRAX,FLG,CLSFN
"RTN","GMRAOR",278,0)
 S GMRAX=0,FLG=0,GMRAC=$$CLP2CODE^GMRAPENC(PTR),CLSFN=$$CODE2CL^GMRAPENC(GMRAC)
"RTN","GMRAOR",279,0)
 I GMRAC'="" D
"RTN","GMRAOR",280,0)
 .;*BD
"RTN","GMRAOR",281,0)
 .I $G(GMRAV1) D
"RTN","GMRAOR",282,0)
 ..F  S GMRAX=$O(^GMR(120.8,"APC",DFN,GMRAC,GMRAX)) Q:GMRAX<1  S FLG=2,GMRAIEN(GMRAX)=""
"RTN","GMRAOR",283,0)
 .I '$G(GMRAV1) D
"RTN","GMRAOR",284,0)
 ..;*ED (C U DOTS)
"RTN","GMRAOR",285,0)
 ..F  S GMRAX=$O(^TMP("GMRAOC",$J,"APC",GMRAC,GMRAX)) Q:GMRAX=""  D
"RTN","GMRAOR",286,0)
 ...S FLG=2
"RTN","GMRAOR",287,0)
 ...S GMRADRCL(GMRAX)=CLSFN_"|"_PTR_U_$G(^TMP("GMRAOC",$J,"APC",GMRAC,GMRAX))
"RTN","GMRAOR",288,0)
 Q FLG
"RTN","GMRAOR",289,0)
NDFREF() ;VERSION-DEPENDENT GLOBAL LOCATION OF VA GENERIC FILE (#50.6)
"RTN","GMRAOR",290,0)
 ;RETURN: GLOBAL LOCATION OF VA GENERIC FILE (#50.6)
"RTN","GMRAOR",291,0)
 I $$VERSION^XPDUTL("PSN")<4 Q "^PSNDF("
"RTN","GMRAOR",292,0)
 Q "^PSNDF(50.6,"
"RTN","GMRAOR",293,0)
GETDATA(DFN) ;OBTAIN ADVERSE REACTION DATA
"RTN","GMRAOR",294,0)
 ;PARAMTER: DFN => IEN IN THE PATIENT (#2) FILE
"RTN","GMRAOR",295,0)
 K ^TMP("GMRAOC",$J)
"RTN","GMRAOR",296,0)
 D REMOTE^GMRAOR0(DFN),LOCAL(DFN)
"RTN","GMRAOR",297,0)
 Q
"RTN","GMRAOR",298,0)
LOCAL(DFN) ;OBTAIN DATA STORED LOCALLY
"RTN","GMRAOR",299,0)
 ;PARAMTER: DFN => IEN IN THE PATIENT (#2) FILE
"RTN","GMRAOR",300,0)
 N J
"RTN","GMRAOR",301,0)
 S J=0 F  S J=$O(^GMR(120.8,"API",DFN,J)) Q:'+J  D
"RTN","GMRAOR",302,0)
 .D LDATA("API",DFN,J)
"RTN","GMRAOR",303,0)
 S J="" F  S J=$O(^GMR(120.8,"APC",DFN,J)) Q:J=""  D
"RTN","GMRAOR",304,0)
 .D LDATA("APC",DFN,J)
"RTN","GMRAOR",305,0)
 Q
"RTN","GMRAOR",306,0)
LDATA(NODE,DFN,J) ;OBTAIN EACH REACTION'S LOCALLY STORED DATA ELEMENTS
"RTN","GMRAOR",307,0)
 ;PARAMTERS: NODE => CURRENT INDEX IN FILE #120.8
"RTN","GMRAOR",308,0)
 ;                   EITHER "API" OR "APC".
"RTN","GMRAOR",309,0)
 ;           DFN => IEN IN THE PATIENT (#2) FILE
"RTN","GMRAOR",310,0)
 ;           J => CURRENT INGREDIENT OR CLASS
"RTN","GMRAOR",311,0)
 N PAIEN
"RTN","GMRAOR",312,0)
 S PAIEN=0 F  S PAIEN=$O(^GMR(120.8,NODE,DFN,J,PAIEN)) Q:+$G(PAIEN)=0  D
"RTN","GMRAOR",313,0)
 .Q:$P($G(^GMR(120.8,PAIEN,"ER")),U)
"RTN","GMRAOR",314,0)
 .;*BD
"RTN","GMRAOR",315,0)
 .S ^TMP("GMRAOC",$J,NODE,J)=$$SETNODE^GMRAOR1($G(^TMP("GMRAOC",$J,NODE,J)),"LOCAL")
"RTN","GMRAOR",316,0)
 .Q:+$G(GMRAV1)
"RTN","GMRAOR",317,0)
 .;*ED
"RTN","GMRAOR",318,0)
 .D ADDLDATA($NA(^TMP("GMRAOC",$J,NODE,J,PAIEN)),PAIEN)
"RTN","GMRAOR",319,0)
 Q
"RTN","GMRAOR",320,0)
ADDLDATA(GLOBAL,PAIEN) ;OBTAIN LOCALLY STORED DATA ELEMENTS FOR ONE REACTION
"RTN","GMRAOR",321,0)
 ;PARAMETERS: GLOBAL => GLOBAL REFERENCE WHERE TO RETURN THE DATA
"RTN","GMRAOR",322,0)
 ;            PAIEN => IEN IN FILE #120.8
"RTN","GMRAOR",323,0)
 N SITE
"RTN","GMRAOR",324,0)
 S SITE=$$SITE^VASITE(),SITE=$P(SITE,U)_U_"L"_U
"RTN","GMRAOR",325,0)
 S @GLOBAL=SITE_$P(^GMR(120.8,PAIEN,0),U,4)
"RTN","GMRAOR",326,0)
 N REACT,IEN
"RTN","GMRAOR",327,0)
 S REACT=0 F  S REACT=$O(^GMR(120.8,PAIEN,10,REACT)) Q:+$G(REACT)=0  D
"RTN","GMRAOR",328,0)
 .S REACT("VALUE")=$P($G(^GMR(120.8,PAIEN,10,REACT,0)),U)
"RTN","GMRAOR",329,0)
 .I REACT("VALUE")=GMRAOTH D
"RTN","GMRAOR",330,0)
 ..S REACT("VALUE")=REACT("VALUE")_"-"_$P($G(^GMR(120.8,PAIEN,10,REACT,0)),U,2)
"RTN","GMRAOR",331,0)
 ..I $P(REACT("VALUE"),"-",2)="" D
"RTN","GMRAOR",332,0)
 ...I GMRAOTH>0 S $P(REACT("VALUE"),"-",2)=$P($G(^GMRD(120.83,GMRAOTH,0)),U)
"RTN","GMRAOR",333,0)
 ...E  K REACT("VALUE")
"RTN","GMRAOR",334,0)
 .S:$D(REACT("VALUE")) $P(@GLOBAL,U,5)=$S($P($G(@GLOBAL),U,5)'="":$P(@GLOBAL,U,5)_"~",1:"")_REACT("VALUE")
"RTN","GMRAOR",335,0)
 S $P(@GLOBAL,U,6)=$P(^GMR(120.8,PAIEN,0),U,2)
"RTN","GMRAOR",336,0)
 S $P(@GLOBAL,U,7)=$P(^GMR(120.8,PAIEN,0),U,3)
"RTN","GMRAOR",337,0)
 S $P(@GLOBAL,U,8)=$P(^GMR(120.8,PAIEN,0),U,6)
"RTN","GMRAOR",338,0)
 S $P(@GLOBAL,U,9)="V"
"RTN","GMRAOR",339,0)
 Q:$D(^GMR(120.85,"C",PAIEN))<10
"RTN","GMRAOR",340,0)
 S IEN=0 F  S IEN=$O(^GMR(120.85,"C",PAIEN,IEN)) Q:'+IEN  D
"RTN","GMRAOR",341,0)
 .S $P(@GLOBAL,U,4)=$S($P($G(@GLOBAL),U,4)'="":$P(@GLOBAL,U,4)_"~",1:"")_$P($G(^GMR(120.85,IEN,0)),U)_"|"_$P($G(^(0)),U,14)
"RTN","GMRAOR",342,0)
 Q
"VER")
8.0^22.0
"BLD",9546,6)
^47
**END**
**END**

