Released GMRA*4*50 SEQ #49
Extracted from mail message
**KIDS**:GMRA*4.0*50^

**INSTALL NAME**
GMRA*4.0*50
"BLD",9717,0)
GMRA*4.0*50^ADVERSE REACTION TRACKING^0^3160831^y
"BLD",9717,4,0)
^9.64PA^^
"BLD",9717,6.3)
3
"BLD",9717,"ABPKG")
n
"BLD",9717,"INID")
^n
"BLD",9717,"INIT")
POST^GMRA50P1
"BLD",9717,"KRN",0)
^9.67PA^779.2^20
"BLD",9717,"KRN",.4,0)
.4
"BLD",9717,"KRN",.401,0)
.401
"BLD",9717,"KRN",.402,0)
.402
"BLD",9717,"KRN",.403,0)
.403
"BLD",9717,"KRN",.5,0)
.5
"BLD",9717,"KRN",.84,0)
.84
"BLD",9717,"KRN",3.6,0)
3.6
"BLD",9717,"KRN",3.8,0)
3.8
"BLD",9717,"KRN",9.2,0)
9.2
"BLD",9717,"KRN",9.8,0)
9.8
"BLD",9717,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",9717,"KRN",9.8,"NM",1,0)
GMRAPEM0^^0^B67572191
"BLD",9717,"KRN",9.8,"NM",2,0)
GMRAGUI1^^0^B59594462
"BLD",9717,"KRN",9.8,"NM","B","GMRAGUI1",2)

"BLD",9717,"KRN",9.8,"NM","B","GMRAPEM0",1)

"BLD",9717,"KRN",19,0)
19
"BLD",9717,"KRN",19.1,0)
19.1
"BLD",9717,"KRN",101,0)
101
"BLD",9717,"KRN",409.61,0)
409.61
"BLD",9717,"KRN",771,0)
771
"BLD",9717,"KRN",779.2,0)
779.2
"BLD",9717,"KRN",870,0)
870
"BLD",9717,"KRN",8989.51,0)
8989.51
"BLD",9717,"KRN",8989.52,0)
8989.52
"BLD",9717,"KRN",8994,0)
8994
"BLD",9717,"KRN","B",.4,.4)

"BLD",9717,"KRN","B",.401,.401)

"BLD",9717,"KRN","B",.402,.402)

"BLD",9717,"KRN","B",.403,.403)

"BLD",9717,"KRN","B",.5,.5)

"BLD",9717,"KRN","B",.84,.84)

"BLD",9717,"KRN","B",3.6,3.6)

"BLD",9717,"KRN","B",3.8,3.8)

"BLD",9717,"KRN","B",9.2,9.2)

"BLD",9717,"KRN","B",9.8,9.8)

"BLD",9717,"KRN","B",19,19)

"BLD",9717,"KRN","B",19.1,19.1)

"BLD",9717,"KRN","B",101,101)

"BLD",9717,"KRN","B",409.61,409.61)

"BLD",9717,"KRN","B",771,771)

"BLD",9717,"KRN","B",779.2,779.2)

"BLD",9717,"KRN","B",870,870)

"BLD",9717,"KRN","B",8989.51,8989.51)

"BLD",9717,"KRN","B",8989.52,8989.52)

"BLD",9717,"KRN","B",8994,8994)

"BLD",9717,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9717,"QUES",0)
^9.62^^
"BLD",9717,"REQB",0)
^9.611^2^2
"BLD",9717,"REQB",1,0)
GMRA*4.0*42^2
"BLD",9717,"REQB",2,0)
GMRA*4.0*36^2
"BLD",9717,"REQB","B","GMRA*4.0*36",2)

"BLD",9717,"REQB","B","GMRA*4.0*42",1)

"INIT")
POST^GMRA50P1
"MBREQ")
0
"PKG",392,-1)
1^1
"PKG",392,0)
ADVERSE REACTION TRACKING^GMRA^Adverse Reaction Tracking package
"PKG",392,20,0)
^9.402P^1^1
"PKG",392,20,1,0)
2^^GMRAMRG
"PKG",392,20,1,1)

"PKG",392,20,"B",2,1)

"PKG",392,22,0)
^9.49I^1^1
"PKG",392,22,1,0)
4.0^2960328^2960801^1
"PKG",392,22,1,"PAH",1,0)
50^3160831^520736442
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","GMRA50P1")
0^^B2416014^n/a
"RTN","GMRA50P1",1,0)
GMRA50P1 ;VIP/WW - PATCH 50 POST INSTALL ; 19 Oct 2015
"RTN","GMRA50P1",2,0)
 ;;4.0;Adverse Reaction Tracking;**50**;Oct 19, 2015;Build 3
"RTN","GMRA50P1",3,0)
 ;
"RTN","GMRA50P1",4,0)
 ; This post-installation routine will add the mailgroup
"RTN","GMRA50P1",5,0)
 ; ADVERSE_ALLERGY_WARNING to receive Allergy/Adverse Reactions
"RTN","GMRA50P1",6,0)
 ; Without a VA Drug Class.
"RTN","GMRA50P1",7,0)
 ;
"RTN","GMRA50P1",8,0)
POST ; Entry point. Check for existance and create if not there.
"RTN","GMRA50P1",9,0)
 ;
"RTN","GMRA50P1",10,0)
 N FIND,MG
"RTN","GMRA50P1",11,0)
 ;
"RTN","GMRA50P1",12,0)
 S MG="ADVERSE_ALLERGY_WARNING"
"RTN","GMRA50P1",13,0)
 S FIND=$$FIND1^DIC(3.8,"","",MG)
"RTN","GMRA50P1",14,0)
 ;
"RTN","GMRA50P1",15,0)
 I FIND D  Q
"RTN","GMRA50P1",16,0)
  .D BMES^XPDUTL(">>> Mail group "_MG_" already exists...nothing added")
"RTN","GMRA50P1",17,0)
 ;
"RTN","GMRA50P1",18,0)
 S FIND=$$MG^XMBGRP(MG,0,0,1,,1,1)
"RTN","GMRA50P1",19,0)
 ;
"RTN","GMRA50P1",20,0)
 I FIND D  Q
"RTN","GMRA50P1",21,0)
  .D BMES^XPDUTL(">>> Mail group: "_MG_" added successfully!")
"RTN","GMRA50P1",22,0)
  .D BMES^XPDUTL("    Please add members as appropriate for those")
"RTN","GMRA50P1",23,0)
  .D MES^XPDUTL("    who should receive notice of VA Drug Class field")
"RTN","GMRA50P1",24,0)
  .D MES^XPDUTL("    is empty.")
"RTN","GMRA50P1",25,0)
 ;
"RTN","GMRA50P1",26,0)
 I 'FIND  D  Q
"RTN","GMRA50P1",27,0)
  .D BMES^XPDUTL(">>> NOTE:   Mail group: "_MG_" not added!!!")
"RTN","GMRA50P1",28,0)
  .D MES^XPDUTL("    ERROR:  "_FIND)
"RTN","GMRA50P1",29,0)
  .D BMES^XPDUTL("    Please check your file and type")
"RTN","GMRA50P1",30,0)
  .D MES^XPDUTL("    D EN^ESP116PT to try again.")
"RTN","GMRA50P1",31,0)
 ;
"RTN","GMRA50P1",32,0)
 Q
"RTN","GMRAGUI1")
0^2^B59594462^B59206501
"RTN","GMRAGUI1",1,0)
GMRAGUI1 ;SLC/DAN - CPRS GUI support ;2/9/09  09:45
"RTN","GMRAGUI1",2,0)
 ;;4.0;Adverse Reaction Tracking;**21,25,36,38,42,50**;Mar 29, 1996;Build 3
"RTN","GMRAGUI1",3,0)
 ;
"RTN","GMRAGUI1",4,0)
 Q
"RTN","GMRAGUI1",5,0)
EN1 ; GETREC, cont'd
"RTN","GMRAGUI1",6,0)
OBSV ;  Get OBSERVATIONS from file 120.85
"RTN","GMRAGUI1",7,0)
 S STRING="~OBSERVATIONS" D NEXT
"RTN","GMRAGUI1",8,0)
 S OBSIEN=0
"RTN","GMRAGUI1",9,0)
OBSLOOP S OBSIEN=$O(^GMR(120.85,"C",GMRAIEN,OBSIEN)) G:OBSIEN<1 EXIT
"RTN","GMRAGUI1",10,0)
 S GMRA(1)=$G(^GMR(120.85,OBSIEN,0)) Q:'$L(GMRA(1))
"RTN","GMRAGUI1",11,0)
 S STRING="tRecord            : "_OBSIEN D NEXT
"RTN","GMRAGUI1",12,0)
 S USRNAM=""
"RTN","GMRAGUI1",13,0)
 S USR=$P(GMRA(1),U,13) I USR'="" D GETUSR
"RTN","GMRAGUI1",14,0)
 S Y=$P(GMRA(1),U,1) X ^DD("DD")
"RTN","GMRAGUI1",15,0)
 S STRING="tDate/Time of Event: "_Y D NEXT
"RTN","GMRAGUI1",16,0)
 S STRING="tObserver          : "_USRNAM D NEXT
"RTN","GMRAGUI1",17,0)
 S SEVCOD=$P(GMRA(1),U,14)
"RTN","GMRAGUI1",18,0)
 S SEVER=$S(SEVCOD=1:"MILD",SEVCOD=2:"MODERATE",SEVCOD=3:"SEVERE",1:"")
"RTN","GMRAGUI1",19,0)
 S STRING="tSeverity          : "_SEVER D NEXT
"RTN","GMRAGUI1",20,0)
 S Y=$P(GMRA(1),U,18) X ^DD("DD")
"RTN","GMRAGUI1",21,0)
 S STRING="tDate Reported     : "_Y D NEXT
"RTN","GMRAGUI1",22,0)
 S USRNAM=""
"RTN","GMRAGUI1",23,0)
 S USR=$P(GMRA(1),U,19) I USR'="" D GETUSR
"RTN","GMRAGUI1",24,0)
 S STRING="tReporting User    : "_USRNAM D NEXT
"RTN","GMRAGUI1",25,0)
 S STRING="t" F I=1:1:60 S STRING=STRING_"-"
"RTN","GMRAGUI1",26,0)
 D NEXT
"RTN","GMRAGUI1",27,0)
 G OBSLOOP
"RTN","GMRAGUI1",28,0)
EXIT Q
"RTN","GMRAGUI1",29,0)
NEXT ;SET ARRAY NODE AND INCREMENT ARRAY COUNTER
"RTN","GMRAGUI1",30,0)
 S @GMRARRAY@(ND)=STRING,ND=ND+1,STRING=""
"RTN","GMRAGUI1",31,0)
 Q
"RTN","GMRAGUI1",32,0)
GETUSR S USRNAM=$$GET1^DIQ(200,USR_",",".01")
"RTN","GMRAGUI1",33,0)
 Q
"RTN","GMRAGUI1",34,0)
 ;
"RTN","GMRAGUI1",35,0)
EIE(GMRAIEN,GMRADFN,GMRARRAY) ;Mark individual entry as entered in error
"RTN","GMRAGUI1",36,0)
 N DIE,DA,DR,Y,DIK,DFN,OROLD,VAIN,X,GMRAOUT,GMRAPA
"RTN","GMRAGUI1",37,0)
 L +^XTMP("GMRAED",GMRADFN):1 I '$T D MESS Q
"RTN","GMRAGUI1",38,0)
 S GMRAPA=GMRAIEN
"RTN","GMRAGUI1",39,0)
 S DIE="^GMR(120.8,",DA=GMRAPA,DR="15///1;22///1;23///"_@GMRARRAY@("GMRAERRDT")_";24////"_$G(@GMRARRAY@("GMRAERRBY"),.5) ;36
"RTN","GMRAGUI1",40,0)
 D ^DIE ;Entered in error on date/time by user
"RTN","GMRAGUI1",41,0)
 I $D(@GMRARRAY@("GMRAERRCMTS")) D ADCOM(GMRAPA,"E",$NA(@GMRARRAY@("GMRAERRCMTS"))) ;add comments
"RTN","GMRAGUI1",42,0)
 I $$NKASCR^GMRANKA($P(^GMR(120.8,GMRAPA,0),U)) D
"RTN","GMRAGUI1",43,0)
 .S DIK="^GMR(120.86,",DA=$P(^GMR(120.8,GMRAPA,0),U)
"RTN","GMRAGUI1",44,0)
 .D ^DIK ;If patient's last allergy marked as entered in error then delete assessment
"RTN","GMRAGUI1",45,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRAGUI1",46,0)
 S GMRAOUT=0
"RTN","GMRAGUI1",47,0)
 D EN1^GMRAEAB ;Sends entered in error bulletin to appropriate mail groups
"RTN","GMRAGUI1",48,0)
 D EN1^GMRAPET0(GMRADFN,GMRAPA,"E",.GMRAOUT) ;21 File Progress Note
"RTN","GMRAGUI1",49,0)
 S DFN=GMRADFN
"RTN","GMRAGUI1",50,0)
 D INP^VADPT S X=$$FIND1^DIC(101,,"BX","GMRA ENTERED IN ERROR")_";ORD(101,"
"RTN","GMRAGUI1",51,0)
 D:X EN^XQOR ;Process protocols hanging off of "entered in error" protocol
"RTN","GMRAGUI1",52,0)
 L -^XTMP("GMRAED",GMRADFN)
"RTN","GMRAGUI1",53,0)
 S ORY=0_$S(+$G(GMRAPN)>0:("^"_+$G(GMRAPN)),1:"") ;38 Return IEN of progress note if created
"RTN","GMRAGUI1",54,0)
 Q
"RTN","GMRAGUI1",55,0)
 ;
"RTN","GMRAGUI1",56,0)
ADCOM(ENTRY,TYPE,GMRACOM) ;Add comments to allergies
"RTN","GMRAGUI1",57,0)
 ;
"RTN","GMRAGUI1",58,0)
 N FDA,GMRAI,X,DIWL,DIWR
"RTN","GMRAGUI1",59,0)
 K ^UTILITY($J,"W") S DIWL=1,DIWR=60 S GMRAI=0 F  S GMRAI=$O(@GMRACOM@(GMRAI)) Q:'+GMRAI  S X=@GMRACOM@(GMRAI) D ^DIWP
"RTN","GMRAGUI1",60,0)
 S GMRACOM="^UTILITY($J,""W"",1)"
"RTN","GMRAGUI1",61,0)
 S FDA(120.826,"+1,"_ENTRY_",",.01)=$$NOW^XLFDT
"RTN","GMRAGUI1",62,0)
 S FDA(120.826,"+1,"_ENTRY_",",1)=DUZ
"RTN","GMRAGUI1",63,0)
 S FDA(120.826,"+1,"_ENTRY_",",1.5)=TYPE
"RTN","GMRAGUI1",64,0)
 S FDA(120.826,"+1,"_ENTRY_",",2)=GMRACOM
"RTN","GMRAGUI1",65,0)
 D UPDATE^DIE("","FDA")
"RTN","GMRAGUI1",66,0)
 Q
"RTN","GMRAGUI1",67,0)
 ;
"RTN","GMRAGUI1",68,0)
NKA ;Change patient assessment to NKA
"RTN","GMRAGUI1",69,0)
 ;
"RTN","GMRAGUI1",70,0)
 N DA,DR,DIE,NKA,DFN
"RTN","GMRAGUI1",71,0)
 S DFN=ORDFN
"RTN","GMRAGUI1",72,0)
 L +^XTMP("GMRAED",DFN):1 I '$T D MESS Q
"RTN","GMRAGUI1",73,0)
 S NKA=$$NKA^GMRANKA(DFN)
"RTN","GMRAGUI1",74,0)
 I NKA=0 Q  ;Patient is already NKA
"RTN","GMRAGUI1",75,0)
 I NKA=1 S ORY="-1^Patient has active allergies - can't mark as NKA" Q
"RTN","GMRAGUI1",76,0)
 L +^GMR(120.86,0):5 I '$T S ORY="-1^Unable to update assessment - try again." Q
"RTN","GMRAGUI1",77,0)
 I '$D(^GMR(120.86,DFN,0)) D  ;Add assessment entry
"RTN","GMRAGUI1",78,0)
 .S $P(^GMR(120.86,0),U,3,4)=(DFN_"^"_($P(^GMR(120.86,0),U,4)+1))
"RTN","GMRAGUI1",79,0)
 .S ^GMR(120.86,DFN,0)=DFN_U,^GMR(120.86,"B",DFN,DFN)=""
"RTN","GMRAGUI1",80,0)
 L -^GMR(120.86,0) L +^GMR(120.86,DFN,0):5 I '$T S ORY="-1^Unable to update assessment - try again." Q
"RTN","GMRAGUI1",81,0)
 S DIE="^GMR(120.86,",DA=DFN,DR="1////0;2////"_DUZ_";3///NOW" D ^DIE
"RTN","GMRAGUI1",82,0)
 S ORY=0
"RTN","GMRAGUI1",83,0)
 L -^XTMP("GMRAED",DFN)
"RTN","GMRAGUI1",84,0)
 Q
"RTN","GMRAGUI1",85,0)
 ;
"RTN","GMRAGUI1",86,0)
UPDATE(GMRAIEN,DFN,GMRARRAY) ;Add/edit allergies
"RTN","GMRAGUI1",87,0)
 N NEW,NKA,FDA,NODE,IEN,SUB,FILE,DA,DIK,SIEN,GMRAS0,GMRAIEN,GMRAL,GMRAPA,GMRAAR,GMRALL,GMRADFN,GMRAOUT,GMRAROT,GMRAPN
"RTN","GMRAGUI1",88,0)
 S NEW='$G(GMRAIEN)
"RTN","GMRAGUI1",89,0)
 I NEW,$$DUPCHK^GMRAOR0(DFN,$P(@GMRARRAY@("GMRAGNT"),U))=1 S ORY="-1^Patient already has a "_$P(@GMRARRAY@("GMRAGNT"),U)_" reaction entered.  No duplicates allowed." Q
"RTN","GMRAGUI1",90,0)
 L +^XTMP("GMRAED",DFN):1 I '$T D MESS Q
"RTN","GMRAGUI1",91,0)
 D SITE^GMRAUTL S GMRASITE(0)=$G(^GMRD(120.84,+GMRASITE,0))
"RTN","GMRAGUI1",92,0)
 S NKA='$$NKA^GMRANKA(DFN) ;is patient NKA?
"RTN","GMRAGUI1",93,0)
 I NKA,NEW D
"RTN","GMRAGUI1",94,0)
 .S FDA(120.86,"?+"_DFN_",",.01)=DFN
"RTN","GMRAGUI1",95,0)
 .S FDA(120.86,"?+"_DFN_",",1)=1
"RTN","GMRAGUI1",96,0)
 .S FDA(120.86,"?+"_DFN_",",2)=DUZ
"RTN","GMRAGUI1",97,0)
 .S FDA(120.86,"?+"_DFN_",",3)=$G(@GMRARRAY@("GMRAORDT"),$$NOW^XLFDT)
"RTN","GMRAGUI1",98,0)
 .S IEN(DFN)=DFN
"RTN","GMRAGUI1",99,0)
 .D UPDATE^DIE("","FDA","IEN")
"RTN","GMRAGUI1",100,0)
 K FDA,IEN
"RTN","GMRAGUI1",101,0)
 S NODE=$S($G(NEW):"+1,",1:(GMRAIEN_","))
"RTN","GMRAGUI1",102,0)
 S:$G(NEW) FDA(120.8,NODE,.01)=DFN
"RTN","GMRAGUI1",103,0)
 I $P($G(@GMRARRAY@("GMRAGNT")),U,2)["50.67" S $P(@GMRARRAY@("GMRAGNT"),U,2)=$$TGTOG^PSNAPIS($P(@GMRARRAY@("GMRAGNT"),U))_";PSNDF(50.6,"
"RTN","GMRAGUI1",104,0)
 F SUB="GMRAGNT;.02","GMRATYPE;3.1","GMRANATR;17","GMRAORIG;5","GMRAORDT;4","GMRAOBHX;6" D
"RTN","GMRAGUI1",105,0)
 .S FDA(120.8,NODE,$P(SUB,";",2))=$P(@GMRARRAY@($P(SUB,";")),U)
"RTN","GMRAGUI1",106,0)
 .I (SUB["GMRAGNT"),NEW S FDA(120.8,NODE,1)=$P(@GMRARRAY@($P(SUB,";")),U,2)
"RTN","GMRAGUI1",107,0)
 D UPDATE^DIE("","FDA","IEN")
"RTN","GMRAGUI1",108,0)
 S:NEW GMRAIEN=IEN(1)
"RTN","GMRAGUI1",109,0)
 K FDA
"RTN","GMRAGUI1",110,0)
 F SUB="GMRACHT","GMRAIDBN" D
"RTN","GMRAGUI1",111,0)
 .Q:'$D(@GMRARRAY@(SUB))  ;Stop if no updates
"RTN","GMRAGUI1",112,0)
 .S FILE=$S(SUB="GMRACHT":120.813,1:120.814)
"RTN","GMRAGUI1",113,0)
 .S FDA(FILE,"+1,"_GMRAIEN_",",.01)=@GMRARRAY@(SUB,1)
"RTN","GMRAGUI1",114,0)
 .S FDA(FILE,"+1,"_GMRAIEN_",",1)=DUZ
"RTN","GMRAGUI1",115,0)
 .D UPDATE^DIE("","FDA")
"RTN","GMRAGUI1",116,0)
 I $D(@GMRARRAY@("GMRACMTS")) D ADCOM(GMRAIEN,"O",$NA(@GMRARRAY@("GMRACMTS"))) ;Add comments if included
"RTN","GMRAGUI1",117,0)
 K FDA
"RTN","GMRAGUI1",118,0)
 S SUB=0 F  S SUB=$O(@GMRARRAY@("GMRASYMP",SUB)) Q:'+SUB  D
"RTN","GMRAGUI1",119,0)
 .S GMRAS0=^(SUB) ;Naked from above
"RTN","GMRAGUI1",120,0)
 .Q:$P(^(SUB),U)=""  ;25 No text or free text entered so don't store
"RTN","GMRAGUI1",121,0)
 .S SIEN=$O(^GMR(120.8,GMRAIEN,10,"B",$P(GMRAS0,U),0))
"RTN","GMRAGUI1",122,0)
 .I SIEN,$P(^GMR(120.8,GMRAIEN,10,SIEN,0),U,4)=$P(GMRAS0,U,3) Q  ;Exists and nothing has changed
"RTN","GMRAGUI1",123,0)
 .I SIEN,$P(GMRAS0,U,5)="@" S DIK="^GMR(120.8,"_GMRAIEN_",",DA(1)=GMRAIEN,DA=SIEN D ^DIK Q  ;Sign/symptom deleted
"RTN","GMRAGUI1",124,0)
 .S:'SIEN FDA(120.81,"+1,"_GMRAIEN_",",.01)=$S($P(GMRAS0,U)="FT":$O(^GMRD(120.83,"B","OTHER REACTION",0)),1:$P(GMRAS0,U))
"RTN","GMRAGUI1",125,0)
 .S NODE=$S(SIEN:SIEN_","_GMRAIEN,1:"+1,"_GMRAIEN_",")
"RTN","GMRAGUI1",126,0)
 .S:$P(GMRAS0,U)="FT" FDA(120.81,NODE,1)=$P(GMRAS0,U,2)
"RTN","GMRAGUI1",127,0)
 .S FDA(120.81,NODE,2)=DUZ
"RTN","GMRAGUI1",128,0)
 .S FDA(120.81,NODE,3)=$P(GMRAS0,U,3)
"RTN","GMRAGUI1",129,0)
 .D UPDATE^DIE("","FDA","","ERR")
"RTN","GMRAGUI1",130,0)
 .S GMRAROT($P(GMRAS0,U,2))="" ;21 record s/s added
"RTN","GMRAGUI1",131,0)
 I NEW D
"RTN","GMRAGUI1",132,0)
 .S GMRALL(GMRAIEN)="" D VAD^GMRAUTL1(DFN,,.GMRALOC,.GMRANAM) D EN7^GMRAMCB ;Send mark chart/ID band bulletin if needed.
"RTN","GMRAGUI1",133,0)
 .I $P(@GMRARRAY@("GMRAOBHX"),U)="o" D  ;if observed reaction add data to 120.85
"RTN","GMRAGUI1",134,0)
 ..S GMRAOUT=0 ;21
"RTN","GMRAGUI1",135,0)
 ..S GMRAL(GMRAIEN,"O",GMRAIEN)=$G(@GMRARRAY@("GMRARDT"))_"^"_$G(@GMRARRAY@("GMRASEVR"))
"RTN","GMRAGUI1",136,0)
 ..S GMRADFN=DFN
"RTN","GMRAGUI1",137,0)
 ..S GMRAL(GMRAIEN)="^^"_$P($G(@GMRARRAY@("GMRAGNT")),U)_"^^^^"_$G(@GMRARRAY@("GMRAORIG"))
"RTN","GMRAGUI1",138,0)
 ..M GMRAL(GMRAIEN,"S")=@GMRARRAY@("GMRASYMP")
"RTN","GMRAGUI1",139,0)
 ..S SUB=0 F  S SUB=$O(GMRAL(GMRAIEN,"S",SUB)) Q:'+SUB  S $P(GMRAL(GMRAIEN,"S",SUB),U,2)=$P(GMRAL(GMRAIEN,"S",SUB),U,2)_"^" S:$P(GMRAL(GMRAIEN,"S",SUB),U)="FT" $P(GMRAL(GMRAIEN,"S",SUB),U)=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRAGUI1",140,0)
 ..S GMRAL=GMRAIEN
"RTN","GMRAGUI1",141,0)
 ..D ADVERSE^GMRAOR7(GMRAIEN,.GMRAL) ;adds entry to 120.85
"RTN","GMRAGUI1",142,0)
 ..S GMRAIEN(GMRAIEN)="" ;21
"RTN","GMRAGUI1",143,0)
 ..D EN1^GMRAPET0(GMRADFN,.GMRAIEN,"S",.GMRAOUT) ;21 File progress note
"RTN","GMRAGUI1",144,0)
 ..I $G(@GMRARRAY@("GMRATYPE"))["D" S GMRAPA=GMRAIEN D EN1^GMRAPTB ;21 Send med-watch update
"RTN","GMRAGUI1",145,0)
 .S GMRAAR=$P($G(@GMRARRAY@("GMRAGNT")),U,2),GMRAPA=GMRAIEN
"RTN","GMRAGUI1",146,0)
 .D EN1^GMRAOR9 S ^TMP($J,"GMRASF",1,GMRAPA)="" D RANGE^GMRASIGN(1) ;add ingredients/classes send appropriate bulletins
"RTN","GMRAGUI1",147,0)
 S ORY=0_$S(+$G(GMRAPN)>0:("^"_+$G(GMRAPN)),1:"") ;38 If note was created send back IEN
"RTN","GMRAGUI1",148,0)
 I NEW D GMRACHK^GMRAPEM0(GMRAPA)
"RTN","GMRAGUI1",149,0)
 L -^XTMP("GMRAED",DFN)
"RTN","GMRAGUI1",150,0)
 Q
"RTN","GMRAGUI1",151,0)
 ;
"RTN","GMRAGUI1",152,0)
MESS ;Give out locked message
"RTN","GMRAGUI1",153,0)
 N GMRAXBOS,GMRAL1,GMRAL2
"RTN","GMRAGUI1",154,0)
 S GMRAXBOS=$$BROKER^XWBLIB ;In GUI?
"RTN","GMRAGUI1",155,0)
 S GMRAL1="Another user is editing this patient's allergy information."
"RTN","GMRAGUI1",156,0)
 S GMRAL2="Please refresh/review the patient's information before proceeding."
"RTN","GMRAGUI1",157,0)
 I 'GMRAXBOS W !,GMRAL1,!,GMRAL2 D WAIT^GMRAFX3 Q
"RTN","GMRAGUI1",158,0)
 S ORY="-1^"_GMRAL1_"  "_GMRAL2
"RTN","GMRAGUI1",159,0)
 Q
"RTN","GMRAPEM0")
0^1^B67572191^B43826251
"RTN","GMRAPEM0",1,0)
GMRAPEM0 ;HIRMFO/WAA,FT-ALLERGY/ADVERSE REACTION PATIENT EDIT DRIVER ; 12 Jul 2016  1:54 PM
"RTN","GMRAPEM0",2,0)
 ;;4.0;Adverse Reaction Tracking;**2,5,17,21,36,50**;Mar 29, 1996;Build 3
"RTN","GMRAPEM0",3,0)
EN11 ; Entry point for GMRA USER E/E PAT REC DATA option
"RTN","GMRAPEM0",4,0)
 ; GMRAUSER is a flag that indicates that this is a User
"RTN","GMRAPEM0",5,0)
 ; If user has Verifier Key then user will act normal
"RTN","GMRAPEM0",6,0)
 I '$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) S GMRAUSER=1
"RTN","GMRAPEM0",7,0)
EN1 ; Entry for ENTER/EDIT PATIENT REACTION DATA option
"RTN","GMRAPEM0",8,0)
 ; EDIT PATIENT A/AR (DFN UNK.)
"RTN","GMRAPEM0",9,0)
 S GMRAOUT=0
"RTN","GMRAPEM0",10,0)
 W @IOF D PAT^GMRAPAT ; Select A Patient
"RTN","GMRAPEM0",11,0)
 D:'GMRAOUT EN21 G:'GMRAOUT EN1
"RTN","GMRAPEM0",12,0)
 K DFN,DIC,GMRAOUT,GMRARET,GMA,GMRAUSER
"RTN","GMRAPEM0",13,0)
 D EXIT,EN1^GMRAKILL
"RTN","GMRAPEM0",14,0)
 Q
"RTN","GMRAPEM0",15,0)
EN21 ; Process patient data and determine if patient is NKA
"RTN","GMRAPEM0",16,0)
 S GMRAOUT=$G(GMRAOUT,0)
"RTN","GMRAPEM0",17,0)
 ; check patient assessment before enter/edit reaction
"RTN","GMRAPEM0",18,0)
 I $$NKA^GMRANKA(DFN),$$NKASCR^GMRANKA(DFN) D  ;delete 120.86 entry if assessment=yes, but no active reactions in 120.8
"RTN","GMRAPEM0",19,0)
 .N DA,DIK
"RTN","GMRAPEM0",20,0)
 .S DIK="^GMR(120.86,",DA=DFN D ^DIK
"RTN","GMRAPEM0",21,0)
 .Q
"RTN","GMRAPEM0",22,0)
 I '$$NKA^GMRANKA(DFN) D NKAASK^GMRANKA(DFN,.GMRAOUT) Q:GMRAOUT  I '$$NKA^GMRANKA(DFN) Q
"RTN","GMRAPEM0",23,0)
 L +^XTMP("GMRAED",DFN):1 I '$T D MESS^GMRAGUI1 Q  ;21
"RTN","GMRAPEM0",24,0)
 S GMRAOUT=0
"RTN","GMRAPEM0",25,0)
 D:'GMRAOUT SELECT
"RTN","GMRAPEM0",26,0)
 I $G(GMRAPA)'>0 S GMRAOUT=0
"RTN","GMRAPEM0",27,0)
 S GMRARP=1 I 'GMRAOUT D
"RTN","GMRAPEM0",28,0)
 .D ASK^GMRAUTL("Enter another Causative Agent? ",.GMRAOUT,.GMRARP)
"RTN","GMRAPEM0",29,0)
 .I 'GMRARP S GMRACNT=$O(^TMP($J,"GMRASF","B"),-1) D
"RTN","GMRAPEM0",30,0)
 ..I GMRACNT D SIGNOFF^GMRASIGN
"RTN","GMRAPEM0",31,0)
 ..I 'GMRAOUT D IDBAND^GMRASIGN
"RTN","GMRAPEM0",32,0)
 ..I GMRAOUT S GMRAOUT=2-GMRAOUT D:GMRAOUT&($D(^TMP($J,"GMRASF"))) ALERT^GMRASIGN K ^TMP($J,"GMRASF"),GMRACNT
"RTN","GMRAPEM0",33,0)
 ..Q
"RTN","GMRAPEM0",34,0)
 .Q
"RTN","GMRAPEM0",35,0)
 I GMRARP,'GMRAOUT K GMRARP L -^XTMP("GMRAED",DFN) G EN21 ;21
"RTN","GMRAPEM0",36,0)
 K GMRARP
"RTN","GMRAPEM0",37,0)
 ; check patient assessment when exiting enter/edit reaction
"RTN","GMRAPEM0",38,0)
 I $$NKA^GMRANKA(DFN),$$NKASCR^GMRANKA(DFN) D  ;delete 120.86 entry if assessment=yes, but no active reactions in 120.8
"RTN","GMRAPEM0",39,0)
 .N DA,DIK
"RTN","GMRAPEM0",40,0)
 .S DIK="^GMR(120.86,",DA=DFN D ^DIK
"RTN","GMRAPEM0",41,0)
 .Q
"RTN","GMRAPEM0",42,0)
 L -^XTMP("GMRAED",DFN) ;21
"RTN","GMRAPEM0",43,0)
 Q
"RTN","GMRAPEM0",44,0)
EN2 ; EDIT PATIENT A/AR (DFN KNOWN)
"RTN","GMRAPEM0",45,0)
 ; Called from the GMRAOR ALLERGY ENTER/EDIT protocol
"RTN","GMRAPEM0",46,0)
 I '$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) S GMRAUSER=1
"RTN","GMRAPEM0",47,0)
 N GMRAOUT
"RTN","GMRAPEM0",48,0)
 D EN21 D
"RTN","GMRAPEM0",49,0)
 .;N GMRAOUT
"RTN","GMRAPEM0",50,0)
 .D EXIT,EN1^GMRAKILL
"RTN","GMRAPEM0",51,0)
 .Q
"RTN","GMRAPEM0",52,0)
 K GMA,GMRARET,GMRAUSER
"RTN","GMRAPEM0",53,0)
 Q
"RTN","GMRAPEM0",54,0)
ALERT ; PROCESS ALERTS FOR ART
"RTN","GMRAPEM0",55,0)
 N DFN,GMRAPA,GMRACNT,GMRAOUT,GMRANEW,GMRAUSER
"RTN","GMRAPEM0",56,0)
 S (GMRACNT,GMRAOUT,GMRANEW)=0 D
"RTN","GMRAPEM0",57,0)
 .  I $G(XQADATA)="" S XQAKILL=0 Q
"RTN","GMRAPEM0",58,0)
 .  S DFN=$P(XQADATA,U),GMRAPA=$P(XQADATA,U,2),GMRAUSER=$P(XQADATA,U,3) Q:'DFN!'GMRAPA
"RTN","GMRAPEM0",59,0)
 .  I $D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) K GMRAUSER
"RTN","GMRAPEM0",60,0)
 .  S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRAPEM0",61,0)
 .  I $P(GMRAPA(0),U,12) D  Q
"RTN","GMRAPEM0",62,0)
 .  .  W !,"This reaction has been signed off.",$C(7)
"RTN","GMRAPEM0",63,0)
 .  .  D HANGT^GMRAPEH0
"RTN","GMRAPEM0",64,0)
 .  .  S XQAKILL=0
"RTN","GMRAPEM0",65,0)
 .  .  Q
"RTN","GMRAPEM0",66,0)
 .  D EDIT^GMRAPEM4
"RTN","GMRAPEM0",67,0)
 .  D UPDATE^GMRAPEM3
"RTN","GMRAPEM0",68,0)
 .  I '$P(GMRAPA(0),U,12) D SIGNOFF^GMRASIGN
"RTN","GMRAPEM0",69,0)
 .  I GMRAOUT S GMRAOUT=2-GMRAOUT K XQAKILL
"RTN","GMRAPEM0",70,0)
 .  E  D
"RTN","GMRAPEM0",71,0)
 .  .I $P(GMRAPA(0),U,12) S XQAKILL=0
"RTN","GMRAPEM0",72,0)
 .  .I '$P(GMRAPA(0),U,12) K XQAKILL
"RTN","GMRAPEM0",73,0)
 .  D EXIT,EN1^GMRAKILL
"RTN","GMRAPEM0",74,0)
 .  Q
"RTN","GMRAPEM0",75,0)
 Q
"RTN","GMRAPEM0",76,0)
SELECT ;Select a patient reaction
"RTN","GMRAPEM0",77,0)
 S GMRACNT=0 D 1^VADPT
"RTN","GMRAPEM0",78,0)
 S GMRALOC=$P(VAIN(4),U,2),GMRANAM=VADM(1),GMRASEX=VADM(5),GMRAOUT=0,GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0)) D KVAR^VADPT K VA,VAROOT
"RTN","GMRAPEM0",79,0)
 K GMRADUP S GMRALAGO=1
"RTN","GMRAPEM0",80,0)
 D REACT^GMRAPAT(DFN) ; Load all reaction for this patient.
"RTN","GMRAPEM0",81,0)
 D EN1^GMRAPES0
"RTN","GMRAPEM0",82,0)
 I GMRAPA>0 D TYPE D
"RTN","GMRAPEM0",83,0)
 .I GMRAOUT D:$G(GMRANEW) DELETE S:'$$MISSREQ&('$P($G(GMRAPA(0)),U,12)) GMRAOUT=0,^TMP($J,"GMRASF","B",GMRAPA,GMRACNT)="",^TMP($J,"GMRASF",GMRACNT,GMRAPA)="" D:GMRAOUT UPOUT^GMRAPEM3 Q  ; 21,36
"RTN","GMRAPEM0",84,0)
 .I GMRAERR D ERR^GMRAPEM3 Q  ;The reaction was entered in error
"RTN","GMRAPEM0",85,0)
 .I $P(GMRAPA(0),U,12) D SIGNED^GMRAPEM3 Q  ;The reaction has been signed
"RTN","GMRAPEM0",86,0)
 .; Reaction is a new reaction or Update data
"RTN","GMRAPEM0",87,0)
 .I GMRANEW D GMRACHK^GMRAPEM0(GMRAPA)
"RTN","GMRAPEM0",88,0)
 .D UPDATE^GMRAPEM3
"RTN","GMRAPEM0",89,0)
 .Q
"RTN","GMRAPEM0",90,0)
 Q
"RTN","GMRAPEM0",91,0)
TYPE ; Select the type of the process to use this reaction
"RTN","GMRAPEM0",92,0)
 S GMRAERR=0
"RTN","GMRAPEM0",93,0)
 ; If reaction is not new check to see if user want to enter in error
"RTN","GMRAPEM0",94,0)
 I 'GMRANEW W @IOF N GMRADFN D EN1^GMRAPEE0 I GMRAERR!GMRAOUT Q
"RTN","GMRAPEM0",95,0)
 ;If reaction is observed and signed off
"RTN","GMRAPEM0",96,0)
 I $P(GMRAPA(0),U,6)="o",$P(GMRAPA(0),U,12) D  Q:GMRAOUT
"RTN","GMRAPEM0",97,0)
 .Q:$G(GMRAUSER,0)
"RTN","GMRAPEM0",98,0)
 .N GMRARP
"RTN","GMRAPEM0",99,0)
 .S GMRARP=0 D ASK^GMRAUTL("DO YOU WISH TO EDIT OBSERVED DATA? ",.GMRAOUT,.GMRARP) Q:GMRAOUT
"RTN","GMRAPEM0",100,0)
 .Q:'GMRARP  ;Observed data
"RTN","GMRAPEM0",101,0)
 .N GMRAOD S GMRAOD=$D(^GMR(120.85,"C",GMRAPA)) ;Existing observation data?
"RTN","GMRAPEM0",102,0)
OBSDATE .;
"RTN","GMRAPEM0",103,0)
 .S GMRALAGO=1 F  D EN2^GMRAU85 Q:GMRAPA1>0  Q:GMRAOUT  W !,"You must enter a valid date or an Up-arrow to exit",!,$C(7)
"RTN","GMRAPEM0",104,0)
 .I 'GMRAOUT,GMRAPA1>0  D EN2^GMRAROBS
"RTN","GMRAPEM0",105,0)
 .I '$D(^GMR(120.85,"C",GMRAPA)),$G(GMRANEW)!('$G(GMRANEW)&($G(GMRAOD))) D OBSPROB S GMRAOUT=0 G OBSDATE
"RTN","GMRAPEM0",106,0)
 .Q
"RTN","GMRAPEM0",107,0)
 ;Verify data
"RTN","GMRAPEM0",108,0)
 I 'GMRAERR,$P($G(^GMR(120.8,GMRAPA,0)),U,16)=0,$P(GMRAPA(0),U,12)=1,$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) D  Q:GMRAOUT
"RTN","GMRAPEM0",109,0)
 .K GMRAVER S GMRAVER=0
"RTN","GMRAPEM0",110,0)
 .N GMRAPRNT D EN1^GMRAVFY K GMRALLER,GMRAMEC,GMRAY
"RTN","GMRAPEM0",111,0)
 .I $P($G(^GMR(120.8,GMRAPA,0)),U,16)=1 S GMRASLL(GMRAPA)=1
"RTN","GMRAPEM0",112,0)
 .Q
"RTN","GMRAPEM0",113,0)
 ;EDIT Verified data
"RTN","GMRAPEM0",114,0)
 I 'GMRAERR,$P($G(^GMR(120.8,GMRAPA,0)),U,16)=1,$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) D  Q:GMRAOUT
"RTN","GMRAPEM0",115,0)
 .Q:$G(GMRAVER)=1
"RTN","GMRAPEM0",116,0)
 .N GMRARP
"RTN","GMRAPEM0",117,0)
 .S GMRARP=0
"RTN","GMRAPEM0",118,0)
 .D ASK^GMRAUTL("DO YOU WISH TO EDIT VERIFIED DATA? ",.GMRAOUT,.GMRARP) Q:GMRAOUT
"RTN","GMRAPEM0",119,0)
 .D:GMRARP SITE^GMRAUTL,EN1^GMRAPED0
"RTN","GMRAPEM0",120,0)
 .Q
"RTN","GMRAPEM0",121,0)
 ;if the reaction is new or not signed off
"RTN","GMRAPEM0",122,0)
 I '$P(GMRAPA(0),U,12) D
"RTN","GMRAPEM0",123,0)
 .D EDIT^GMRAPEM4
"RTN","GMRAPEM0",124,0)
 .I $P($G(^GMR(120.8,GMRAPA,0)),U,16) S GMRASLL(GMRAPA)=1
"RTN","GMRAPEM0",125,0)
 .Q
"RTN","GMRAPEM0",126,0)
 Q
"RTN","GMRAPEM0",127,0)
EXIT S GMRAPA=0 F  S GMRAPA=$O(^TMP($J,"GMRASF","B",GMRAPA)) Q:GMRAPA<1  D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRAPEM0",128,0)
 K ^TMP($J,"GMRASF")
"RTN","GMRAPEM0",129,0)
 K ^TMP($J,"GMRALST")
"RTN","GMRAPEM0",130,0)
 Q
"RTN","GMRAPEM0",131,0)
 ;
"RTN","GMRAPEM0",132,0)
DELETE ;Delete entry if required information is not entered - section added in 17
"RTN","GMRAPEM0",133,0)
 N DA,DIK,GMRAPA1
"RTN","GMRAPEM0",134,0)
 W !!,"Entry process not completed, deleting entry...",!
"RTN","GMRAPEM0",135,0)
 S GMRAPA1=$O(^GMR(120.85,"C",GMRAPA,0))
"RTN","GMRAPEM0",136,0)
 I GMRAPA1,$G(^GMR(120.85,GMRAPA1,0))="" K ^GMR(120.85,"C",GMRAPA,GMRAPA1)
"RTN","GMRAPEM0",137,0)
 I GMRAPA1 S DIK="^GMR(120.85,",DA=GMRAPA1 D ^DIK D UNLOCK^GMRAUTL(120.85,GMRAPA1)
"RTN","GMRAPEM0",138,0)
 I GMRAPA S DIK="^GMR(120.8,",DA=GMRAPA D ^DIK D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRAPEM0",139,0)
 Q
"RTN","GMRAPEM0",140,0)
 ;
"RTN","GMRAPEM0",141,0)
OBSPROB ;Display help information for missing observed date/time entry
"RTN","GMRAPEM0",142,0)
 W !!,"Observed reactions must have at least one observation entry.",!,"If this reaction is incorrect then enter a date and then proceed",!,"to mark it as entered in error.",!
"RTN","GMRAPEM0",143,0)
 Q
"RTN","GMRAPEM0",144,0)
 ;
"RTN","GMRAPEM0",145,0)
MISSREQ() ;Function determines if required data is missing
"RTN","GMRAPEM0",146,0)
 N GMRA0,TYPE
"RTN","GMRAPEM0",147,0)
 S GMRA0=$G(^GMR(120.8,+$G(GMRAPA),0)) I GMRA0="" Q 1  ;Entry not found
"RTN","GMRAPEM0",148,0)
 S TYPE=$P(GMRA0,U,6) ;Get observed/historical
"RTN","GMRAPEM0",149,0)
 I TYPE="" Q 1  ;Type not entered
"RTN","GMRAPEM0",150,0)
 I TYPE="h" Q 0  ;Historical has no requirements
"RTN","GMRAPEM0",151,0)
 I TYPE="o" I '$D(^GMR(120.85,"C",GMRAPA))!('$O(^GMR(120.85,+$O(^GMR(120.85,"C",GMRAPA,0)),2,0)))!('$$REQCOM) Q 1  ;Missing obs date/time or sign/symptom or required comment
"RTN","GMRAPEM0",152,0)
 Q 0
"RTN","GMRAPEM0",153,0)
 ;
"RTN","GMRAPEM0",154,0)
REQCOM() ;Function determines if comments required
"RTN","GMRAPEM0",155,0)
 I '$D(GMRASITE) D SITE^GMRAUTL
"RTN","GMRAPEM0",156,0)
 I +$P(^GMRD(120.84,+GMRASITE,0),U,4)=0 Q 1  ;Comments required?
"RTN","GMRAPEM0",157,0)
 I $O(^GMR(120.8,GMRAPA,26,0)) Q 1
"RTN","GMRAPEM0",158,0)
 Q 0
"RTN","GMRAPEM0",159,0)
 ;
"RTN","GMRAPEM0",160,0)
GMRACHK(GMRAPA) ;
"RTN","GMRAPEM0",161,0)
 ;Send a warning MailMan message if the VA DRUG CLASS field is empty.
"RTN","GMRAPEM0",162,0)
 ;Get the first, if any,VA DRUG CLASS entries for this agent.
"RTN","GMRAPEM0",163,0)
 N PATALLER,VADRCL1,PATNAME,REAC,REACTS,LINE
"RTN","GMRAPEM0",164,0)
 N PATIEN,SSN,LAST4
"RTN","GMRAPEM0",165,0)
 D GETS^DIQ(120.8,GMRAPA_",","**","E","PATALLER")
"RTN","GMRAPEM0",166,0)
 S VADRCL1=$G(PATALLER(120.803,"1,"_GMRAPA_",",.01,"E"))
"RTN","GMRAPEM0",167,0)
 S PATNAME=$G(PATALLER(120.8,GMRAPA_",",.01,"E"))
"RTN","GMRAPEM0",168,0)
 S PATIEN=$$GET1^DIQ(120.8,GMRAPA,.01,"I")
"RTN","GMRAPEM0",169,0)
 S SSN=$$GET1^DIQ(2,PATIEN,.09,"E")
"RTN","GMRAPEM0",170,0)
 S LAST4=$E(PATNAME,1,1)_$E(SSN,6,9)
"RTN","GMRAPEM0",171,0)
 I '$G(GMRAERR),(VADRCL1=""),(PATNAME'="") D
"RTN","GMRAPEM0",172,0)
 . K ^XTMP("GMRACHK",$J)
"RTN","GMRAPEM0",173,0)
 . S LINE=1
"RTN","GMRAPEM0",174,0)
 . S ^XTMP("GMRACHK",$J,LINE)="The following allergy/adverse reaction may need a VA DRUG CLASS added"
"RTN","GMRAPEM0",175,0)
 . S LINE=LINE+1
"RTN","GMRAPEM0",176,0)
 . S ^XTMP("GMRACHK",$J,LINE)="for the following Patient:"
"RTN","GMRAPEM0",177,0)
 . S LINE=LINE+1
"RTN","GMRAPEM0",178,0)
 . S ^XTMP("GMRACHK",$J,LINE)=""
"RTN","GMRAPEM0",179,0)
 . S LINE=LINE+1
"RTN","GMRAPEM0",180,0)
 . S ^XTMP("GMRACHK",$J,LINE)="Patient: "_PATNAME
"RTN","GMRAPEM0",181,0)
 . S LINE=LINE+1
"RTN","GMRAPEM0",182,0)
 . S ^XTMP("GMRACHK",$J,LINE)="LAST4: "_LAST4
"RTN","GMRAPEM0",183,0)
 . S LINE=LINE+1
"RTN","GMRAPEM0",184,0)
 . S ^XTMP("GMRACHK",$J,LINE)="Reactant: "_$G(PATALLER(120.8,GMRAPA_",",.02,"E"))
"RTN","GMRAPEM0",185,0)
 . S LINE=LINE+1
"RTN","GMRAPEM0",186,0)
 . ;Build a pretty string of reactions
"RTN","GMRAPEM0",187,0)
 . S REAC=1
"RTN","GMRAPEM0",188,0)
 . S REACTS=$G(PATALLER(120.81,REAC_","_GMRAPA_",",.01,"E"))
"RTN","GMRAPEM0",189,0)
 . S REAC=REAC+1
"RTN","GMRAPEM0",190,0)
 . F  Q:'$D(PATALLER(120.81,REAC_","_GMRAPA_",",.01,"E"))  D
"RTN","GMRAPEM0",191,0)
 . . S REACTS=REACTS_", "_$G(PATALLER(120.81,REAC_","_GMRAPA_",",.01,"E"))
"RTN","GMRAPEM0",192,0)
 . . S REAC=REAC+1
"RTN","GMRAPEM0",193,0)
 . S ^XTMP("GMRACHK",$J,LINE)="Reactions: "_REACTS
"RTN","GMRAPEM0",194,0)
 . S LINE=LINE+1
"RTN","GMRAPEM0",195,0)
 . S ^XTMP("GMRACHK",$J,LINE)="OBS/HIS: "_$G(PATALLER(120.8,GMRAPA_",",6,"E"))
"RTN","GMRAPEM0",196,0)
 . S LINE=LINE+1
"RTN","GMRAPEM0",197,0)
 . S ^XTMP("GMRACHK",$J,LINE)="Location: "_$$GET1^DIQ(405,$$GET1^DIQ(2,DFN,.102,"I"),.06,"E")
"RTN","GMRAPEM0",198,0)
 . S LINE=LINE+1
"RTN","GMRAPEM0",199,0)
 . S XMDUZ=DUZ
"RTN","GMRAPEM0",200,0)
 . S XMTEXT="^XTMP(""GMRACHK"","_$J_","
"RTN","GMRAPEM0",201,0)
 . I $G(DUZ(2))="" S DUZ(2)=+$$STA^XUAF4($$KSP^XUPARAM("INST"))
"RTN","GMRAPEM0",202,0)
 . S XMSUB="ALLERGY/ADVERSE REACTION WITHOUT VA DRUG CLASS ("
"RTN","GMRAPEM0",203,0)
 . S XMSUB=XMSUB_$P($$NS^XUAF4(DUZ(2)),U)_")"
"RTN","GMRAPEM0",204,0)
 . S XMY("G.ADVERSE_ALLERGY_WARNING")=""
"RTN","GMRAPEM0",205,0)
 . D ^XMD
"RTN","GMRAPEM0",206,0)
 . K ^XTMP("GMRACHK",$J)
"RTN","GMRAPEM0",207,0)
 Q
"VER")
8.0^22.0
"BLD",9717,6)
^49
**END**
**END**

