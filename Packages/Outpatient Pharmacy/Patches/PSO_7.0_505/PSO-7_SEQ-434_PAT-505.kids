Released PSO*7*505 SEQ #434
Extracted from mail message
**KIDS**:PSO*7.0*505^

**INSTALL NAME**
PSO*7.0*505
"BLD",10346,0)
PSO*7.0*505^OUTPATIENT PHARMACY^0^3180501^y
"BLD",10346,1,0)
^^1^1^3171109^
"BLD",10346,1,1,0)
Medication Prescribing and Dispensing Updates.
"BLD",10346,4,0)
^9.64PA^^
"BLD",10346,6.3)
39
"BLD",10346,"ABPKG")
n
"BLD",10346,"KRN",0)
^9.67PA^779.2^20
"BLD",10346,"KRN",.4,0)
.4
"BLD",10346,"KRN",.401,0)
.401
"BLD",10346,"KRN",.402,0)
.402
"BLD",10346,"KRN",.403,0)
.403
"BLD",10346,"KRN",.5,0)
.5
"BLD",10346,"KRN",.84,0)
.84
"BLD",10346,"KRN",3.6,0)
3.6
"BLD",10346,"KRN",3.8,0)
3.8
"BLD",10346,"KRN",9.2,0)
9.2
"BLD",10346,"KRN",9.8,0)
9.8
"BLD",10346,"KRN",9.8,"NM",0)
^9.68A^16^14
"BLD",10346,"KRN",9.8,"NM",2,0)
PSOOREDT^^0^B91171061
"BLD",10346,"KRN",9.8,"NM",3,0)
PSOOTMRX^^0^B23201302
"BLD",10346,"KRN",9.8,"NM",4,0)
PSOORNEW^^0^B112662411
"BLD",10346,"KRN",9.8,"NM",5,0)
PSOHLEXP^^0^B24025393
"BLD",10346,"KRN",9.8,"NM",6,0)
PSODIR1^^0^B95371987
"BLD",10346,"KRN",9.8,"NM",7,0)
PSOORFIN^^0^B72047260
"BLD",10346,"KRN",9.8,"NM",8,0)
PSOORFI3^^0^B77499735
"BLD",10346,"KRN",9.8,"NM",9,0)
PSOORFI5^^0^B76809208
"BLD",10346,"KRN",9.8,"NM",10,0)
PSOORFI6^^0^B120103085
"BLD",10346,"KRN",9.8,"NM",12,0)
PSOHELP^^0^B50313084
"BLD",10346,"KRN",9.8,"NM",13,0)
PSOORFI1^^0^B86566158
"BLD",10346,"KRN",9.8,"NM",14,0)
PSOHLDS4^^0^B16987762
"BLD",10346,"KRN",9.8,"NM",15,0)
PSON52^^0^B102819042
"BLD",10346,"KRN",9.8,"NM",16,0)
PSOORNE6^^0^B50434819
"BLD",10346,"KRN",9.8,"NM","B","PSODIR1",6)

"BLD",10346,"KRN",9.8,"NM","B","PSOHELP",12)

"BLD",10346,"KRN",9.8,"NM","B","PSOHLDS4",14)

"BLD",10346,"KRN",9.8,"NM","B","PSOHLEXP",5)

"BLD",10346,"KRN",9.8,"NM","B","PSON52",15)

"BLD",10346,"KRN",9.8,"NM","B","PSOOREDT",2)

"BLD",10346,"KRN",9.8,"NM","B","PSOORFI1",13)

"BLD",10346,"KRN",9.8,"NM","B","PSOORFI3",8)

"BLD",10346,"KRN",9.8,"NM","B","PSOORFI5",9)

"BLD",10346,"KRN",9.8,"NM","B","PSOORFI6",10)

"BLD",10346,"KRN",9.8,"NM","B","PSOORFIN",7)

"BLD",10346,"KRN",9.8,"NM","B","PSOORNE6",16)

"BLD",10346,"KRN",9.8,"NM","B","PSOORNEW",4)

"BLD",10346,"KRN",9.8,"NM","B","PSOOTMRX",3)

"BLD",10346,"KRN",19,0)
19
"BLD",10346,"KRN",19.1,0)
19.1
"BLD",10346,"KRN",101,0)
101
"BLD",10346,"KRN",409.61,0)
409.61
"BLD",10346,"KRN",771,0)
771
"BLD",10346,"KRN",779.2,0)
779.2
"BLD",10346,"KRN",870,0)
870
"BLD",10346,"KRN",8989.51,0)
8989.51
"BLD",10346,"KRN",8989.51,"NM",0)
^9.68A^^
"BLD",10346,"KRN",8989.52,0)
8989.52
"BLD",10346,"KRN",8994,0)
8994
"BLD",10346,"KRN","B",.4,.4)

"BLD",10346,"KRN","B",.401,.401)

"BLD",10346,"KRN","B",.402,.402)

"BLD",10346,"KRN","B",.403,.403)

"BLD",10346,"KRN","B",.5,.5)

"BLD",10346,"KRN","B",.84,.84)

"BLD",10346,"KRN","B",3.6,3.6)

"BLD",10346,"KRN","B",3.8,3.8)

"BLD",10346,"KRN","B",9.2,9.2)

"BLD",10346,"KRN","B",9.8,9.8)

"BLD",10346,"KRN","B",19,19)

"BLD",10346,"KRN","B",19.1,19.1)

"BLD",10346,"KRN","B",101,101)

"BLD",10346,"KRN","B",409.61,409.61)

"BLD",10346,"KRN","B",771,771)

"BLD",10346,"KRN","B",779.2,779.2)

"BLD",10346,"KRN","B",870,870)

"BLD",10346,"KRN","B",8989.51,8989.51)

"BLD",10346,"KRN","B",8989.52,8989.52)

"BLD",10346,"KRN","B",8994,8994)

"BLD",10346,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",10346,"QUES",0)
^9.62^^
"BLD",10346,"REQB",0)
^9.611^14^11
"BLD",10346,"REQB",1,0)
PSO*7.0*313^2
"BLD",10346,"REQB",2,0)
PSO*7.0*446^2
"BLD",10346,"REQB",4,0)
PSO*7.0*411^2
"BLD",10346,"REQB",5,0)
PSO*7.0*391^2
"BLD",10346,"REQB",6,0)
PSO*7.0*372^2
"BLD",10346,"REQB",7,0)
PSO*7.0*225^2
"BLD",10346,"REQB",9,0)
PSO*7.0*444^2
"BLD",10346,"REQB",11,0)
PSO*7.0*467^2
"BLD",10346,"REQB",12,0)
PSO*7.0*385^2
"BLD",10346,"REQB",13,0)
PSO*7.0*488^2
"BLD",10346,"REQB",14,0)
PSO*7.0*504^2
"BLD",10346,"REQB","B","PSO*7.0*225",7)

"BLD",10346,"REQB","B","PSO*7.0*313",1)

"BLD",10346,"REQB","B","PSO*7.0*372",6)

"BLD",10346,"REQB","B","PSO*7.0*385",12)

"BLD",10346,"REQB","B","PSO*7.0*391",5)

"BLD",10346,"REQB","B","PSO*7.0*411",4)

"BLD",10346,"REQB","B","PSO*7.0*444",9)

"BLD",10346,"REQB","B","PSO*7.0*446",2)

"BLD",10346,"REQB","B","PSO*7.0*467",11)

"BLD",10346,"REQB","B","PSO*7.0*488",13)

"BLD",10346,"REQB","B","PSO*7.0*504",14)

"MBREQ")
0
"PKG",170,-1)
1^1
"PKG",170,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",170,20,0)
^9.402P^^
"PKG",170,22,0)
^9.49I^1^1
"PKG",170,22,1,0)
7.0^2971216^2981113^1
"PKG",170,22,1,"PAH",1,0)
505^3180501^520736435
"PKG",170,22,1,"PAH",1,1,0)
^^1^1^3180501
"PKG",170,22,1,"PAH",1,1,1,0)
Medication Prescribing and Dispensing Updates.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
14
"RTN","PSODIR1")
0^6^B95371987^B93842245
"RTN","PSODIR1",1,0)
PSODIR1 ;IHS/DSD - ASKS DATA FOR RX ORDER ENTRY CONT. ;5/18/10 2:28pm
"RTN","PSODIR1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**23,46,78,102,121,131,146,166,184,222,268,206,266,340,391,444,446,505**;DEC 1997;Build 39
"RTN","PSODIR1",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSODIR1",4,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSODIR1",5,0)
 ;External reference $$MXDAYSUP^PSSUTIL1 supported by DBIA 6229
"RTN","PSODIR1",6,0)
 ;
"RTN","PSODIR1",7,0)
PTSTAT(PSODIR) ;
"RTN","PSODIR1",8,0)
PTSTATEN K DIC,DR,DIE S PSODIR("FIELD")=0
"RTN","PSODIR1",9,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" K PSORX("PATIENT STATUS"),PSODIR("PATIENT STATUS") N PSOFNDRX,PSOFNDFL,PSOFNDPS D
"RTN","PSODIR1",10,0)
 .S PSOFNDFL=0 F PSOFNDPS=0:0 S PSOFNDPS=$O(^PS(53,PSOFNDPS)) Q:'PSOFNDPS!(PSOFNDFL)  D
"RTN","PSODIR1",11,0)
 ..S PSOFNDRX=$P($G(^PS(53,PSOFNDPS,0)),"^") S PSOFNDRX=$$UP^XLFSTR(PSOFNDRX) I PSOFNDRX="NON-VA" S PSOFNDFL=1 S (PSORX("PATIENT STATUS"),DIC("B"))=$P($G(^PS(53,PSOFNDPS,0)),"^")
"RTN","PSODIR1",12,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW",$G(PSORX("PATIENT STATUS"))="" W !,"Could not find a 'NON-VA' Patient Status in the RX PATIENT STATUS file (#53)!" D PSTPB D  S PSODIR("DFLG")=1 G PTSTATX
"RTN","PSODIR1",13,0)
 .K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODIR1",14,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" G TPBB
"RTN","PSODIR1",15,0)
 N PSOX
"RTN","PSODIR1",16,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^"),DIC("B")=PSORX("PATIENT STATUS")
"RTN","PSODIR1",17,0)
 S:$G(PSODIR("PATIENT STATUS"))]"" DIC("B")=PSODIR("PATIENT STATUS")
"RTN","PSODIR1",18,0)
TPBB ;
"RTN","PSODIR1",19,0)
 D ELIG^VADPT W !,"Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:"")
"RTN","PSODIR1",20,0)
 S N=0 F  S N=$O(VAEL(1,N)) Q:'N  W !,?10,$P(VAEL(1,N),"^",2)
"RTN","PSODIR1",21,0)
 S DIC("A")="RX PATIENT STATUS: "
"RTN","PSODIR1",22,0)
 S DIC(0)="QEAMZ",DIC=53 D ^DIC K DIC
"RTN","PSODIR1",23,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" N PSOPSDIR,PSOFNDZZ,PSOPSUPA S (PSOPSDIR,PSOPSUPA)=0 D  I PSOPSDIR S:PSOPSUPA PSODIR("DFLG")=1 G:PSOPSUPA PTSTATX W ! D PSTPB G PTSTATEN
"RTN","PSODIR1",24,0)
 .I +Y'>0!($D(DTOUT))!($D(DUOUT)) S (PSOPSDIR,PSOPSUPA)=1 Q
"RTN","PSODIR1",25,0)
 .S (PSODIR("PATIENT STATUS"),PSORX("PATIENT STATUS"))=+Y,PSODIR("PTST NODE")=Y(0)
"RTN","PSODIR1",26,0)
 .S PSOFNDZZ=$P($G(^PS(53,+Y,0)),"^") S PSOFNDZZ=$$UP^XLFSTR(PSOFNDZZ) I PSOFNDZZ'="NON-VA" S PSOPSDIR=1 K PSODIR("PATIENT STATUS"),PSORX("PATIENT STATUS"),PSODIR("PTST NODE")
"RTN","PSODIR1",27,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" G TPBSC
"RTN","PSODIR1",28,0)
 I X[U,$L(X)>1 D:'$G(PSOEDIT) JUMP G PTSTATX
"RTN","PSODIR1",29,0)
 I $D(DUOUT)!$D(DTOUT) S PSODIR("DFLG")=1 G PTSTATX
"RTN","PSODIR1",30,0)
 I Y=-1 W $C(7)," Required" G PTSTATEN
"RTN","PSODIR1",31,0)
 N PSOFNDX,PSOFNDXY,PSOFNDXX,PSOFNDYY
"RTN","PSODIR1",32,0)
 S PSOFNDXY=$G(Y),PSOFNDYY=$G(Y(0))
"RTN","PSODIR1",33,0)
 I '$G(PSOTPBFG),$G(PSOFROM)="NEW" S PSOFNDX=$P($G(^PS(53,+Y,0)),"^") S PSOFNDXX=$$UP^XLFSTR(PSOFNDX) I PSOFNDXX="NON-VA" K PSOFNDX,PSOFNDXY,PSOFNDYY,PSOFNDXX,Y W !!,"Cannot select 'NON-VA' Rx Patient Status!",! G PTSTATEN
"RTN","PSODIR1",34,0)
 S Y=$G(PSOFNDXY),Y(0)=$G(PSOFNDYY)
"RTN","PSODIR1",35,0)
 K PSOFNDXY,PSOFNDYY,PSOFNDX,PSOFNDXX
"RTN","PSODIR1",36,0)
 S (PSODIR("PATIENT STATUS"),PSORX("PATIENT STATUS"))=+Y
"RTN","PSODIR1",37,0)
 S PSODIR("PTST NODE")=Y(0)
"RTN","PSODIR1",38,0)
TPBSC ;
"RTN","PSODIR1",39,0)
 I $G(PSOFDR),$P($G(OR0),"^",17)="C" G PTSTATX
"RTN","PSODIR1",40,0)
 L +^PS(55,PSODFN):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T G PTSTATX
"RTN","PSODIR1",41,0)
 S DIE="55",DR="3////"_+Y,DA=PSODFN D ^DIE K DIE,DA,D0
"RTN","PSODIR1",42,0)
 L -^PS(55,PSODFN)
"RTN","PSODIR1",43,0)
PTSTATX K DTOUT,DUOUT,X,Y,DA
"RTN","PSODIR1",44,0)
 Q
"RTN","PSODIR1",45,0)
SIG(PSODIR) ;
"RTN","PSODIR1",46,0)
 I $G(PSOFDR),$G(PSODIR("SIG"))']"" D SIGOK G:$G(SIGOK)!($G(PSODIR("DFLG"))) SIGX
"RTN","PSODIR1",47,0)
 K DIR,DIC
"RTN","PSODIR1",48,0)
 S DIR(0)="52,10"
"RTN","PSODIR1",49,0)
 S:$G(PSODRUG("SIG"))]"" DIR("B")=PSODRUG("SIG")
"RTN","PSODIR1",50,0)
 S:$G(PSODIR("SIG"))]"" DIR("B")=PSODIR("SIG")
"RTN","PSODIR1",51,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") SIGX
"RTN","PSODIR1",52,0)
 S PSODIR("SIG")=Y,SIGOK=0 K SIG
"RTN","PSODIR1",53,0)
SIGX K X,Y
"RTN","PSODIR1",54,0)
 Q
"RTN","PSODIR1",55,0)
QTY(PSODIR) ;
"RTN","PSODIR1",56,0)
QTYA K DIR,DIC N RFL,RXIEN
"RTN","PSODIR1",57,0)
 I $G(CLOZPAT)=1 S DIR("A",1)="Patient Eligible for 14 day supply or 7 day supply with 1 refill"
"RTN","PSODIR1",58,0)
 I $G(CLOZPAT)=2 S DIR("A",1)="Patient Eligible 28 day supply or 14 day supply with 1 refill or 7 day supply with 3 refill"
"RTN","PSODIR1",59,0)
 S DIR(0)="52,7" S:$G(PSODRUG("IEN")) DIR("A")="QTY ( "_$G(PSODRUG("UNIT"))_" ) "_$S($P($G(^PSDRUG(+PSODRUG("IEN"),5)),"^")]"":$P(^PSDRUG(+PSODRUG("IEN"),5),"^"),1:"")
"RTN","PSODIR1",60,0)
 K QTYHLD I $G(PSODIR("QTY"))]"" S QTYHLD=PSODIR("QTY") K PSODIR("QTY")
"RTN","PSODIR1",61,0)
 D:'$G(PSOQTY) QTY^PSOSIG(.PSODIR)
"RTN","PSODIR1",62,0)
 I '$G(SPEED),$G(QTYHLD),'$G(PSODIR("QTY")) S PSODIR("QTY")=QTYHLD
"RTN","PSODIR1",63,0)
 K QTYHLD K:'$G(PSODIR("QTY")) PSODIR("QTY")
"RTN","PSODIR1",64,0)
 I $G(SPEED),$G(PSODIR("QTY"))']"" S PSODIR("QTY")=$P(^PSRX(PSORENW("OIRXN"),0),"^",7)
"RTN","PSODIR1",65,0)
 S:$G(PSODIR("QTY"))]"" DIR("B")=PSODIR("QTY")
"RTN","PSODIR1",66,0)
 D DIR
"RTN","PSODIR1",67,0)
 ;/BLB/ PSO*7.0*505 ;MODIFIED QTY CHECK TO ALLOW LEADING ZEROS
"RTN","PSODIR1",68,0)
 I Y[".",$P(Y,".")<1 S Y="0"_"."_$P(Y,".",2)
"RTN","PSODIR1",69,0)
 G:PSODIR("DFLG")!PSODIR("FIELD") QTYX
"RTN","PSODIR1",70,0)
 I $G(Y),$G(PSODRUG("MAXDOSE"))]"",$G(PSODIR("DAYS SUPPLY")),(Y/+PSODIR("DAYS SUPPLY")>PSODRUG("MAXDOSE")) D  G:$G(PSODIR("DFLG")) QTYX  G QTYA
"RTN","PSODIR1",71,0)
 .W !,$C(7)," Greater than Maximum dose of "_PSODRUG("MAXDOSE")_" per day" D DAYSEN
"RTN","PSODIR1",72,0)
 I $G(PSOFDR),$P($G(OR0),"^",24),$G(PSODIR("QTY")),+Y>$G(PSODIR("QTY")) D  G QTYX
"RTN","PSODIR1",73,0)
 .W !!,"Digitally Signed Order - QTY cannot be increased",!
"RTN","PSODIR1",74,0)
 .N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSODIR1",75,0)
 S PSODIR("QTY")=Y
"RTN","PSODIR1",76,0)
QTYX K X,Y
"RTN","PSODIR1",77,0)
 Q
"RTN","PSODIR1",78,0)
COPIES(PSODIR) ;
"RTN","PSODIR1",79,0)
 K DIR,DIC
"RTN","PSODIR1",80,0)
 S DIR(0)="52,10.6"
"RTN","PSODIR1",81,0)
 S DIR("B")=$S($G(PSODIR("COPIES"))]"":PSODIR("COPIES"),1:1)
"RTN","PSODIR1",82,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") COPIESX
"RTN","PSODIR1",83,0)
 S PSODIR("COPIES")=Y
"RTN","PSODIR1",84,0)
COPIESX K X,Y
"RTN","PSODIR1",85,0)
 Q
"RTN","PSODIR1",86,0)
DAYS(PSODIR) ;
"RTN","PSODIR1",87,0)
DAYSEN K DIR,DIC N PSORFLS
"RTN","PSODIR1",88,0)
 ;PSO*7*266
"RTN","PSODIR1",89,0)
 N S2DS,MXDAYSUP,DFDAYSUP,CSDRUG,NEWTOTDS S S2DS=0
"RTN","PSODIR1",90,0)
 S MXDAYSUP=90,CSDRUG=0
"RTN","PSODIR1",91,0)
 I $D(PSODRUG("IEN")) D
"RTN","PSODIR1",92,0)
 .S MXDAYSUP=$$MXDAYSUP^PSSUTIL1(PSODRUG("IEN"))
"RTN","PSODIR1",93,0)
 .S S2DS=$$CSDS^PSOSIGDS(PSODRUG("IEN")) I S2DS,$P($G(PSODIR("PTST NODE")),"^",3)>29 S S2DS=30
"RTN","PSODIR1",94,0)
 .S PSORFLS=$S($G(PSODIR("# OF REFILLS")):PSODIR("# OF REFILLS"),1:$P($G(PSODIR("RX0")),"^",9))
"RTN","PSODIR1",95,0)
 .I '$D(PSODRUG("DEA")) S PSODRUG("DEA")=$$GET1^DIQ(50,PSODRUG("IEN"),3,"")
"RTN","PSODIR1",96,0)
 .I (PSODRUG("DEA")["2")!(PSODRUG("DEA")["3")!(PSODRUG("DEA")["4")!(PSODRUG("DEA")["5") S CSDRUG=1
"RTN","PSODIR1",97,0)
 S DIR(0)="N^1:"_$S($G(CLOZPAT)=2:28,$G(CLOZPAT)=1:14,$G(CLOZPAT)=0:7,1:MXDAYSUP)
"RTN","PSODIR1",98,0)
 S DFDAYSUP=$S($D(CLOZPAT)&('$G(PSODIR("DAYS SUPPLY"))):7,$G(PSODIR("DAYS SUPPLY"))]"":PSODIR("DAYS SUPPLY"),S2DS>1:S2DS,$P($G(PSODIR("PTST NODE")),"^",3):$P(PSODIR("PTST NODE"),"^",3),1:30)
"RTN","PSODIR1",99,0)
 I DFDAYSUP>MXDAYSUP D  S DFDAYSUP=MXDAYSUP
"RTN","PSODIR1",100,0)
 .W:$G(PSODIR("DAYS SUPPLY")) !!,$C(7),"Invalid DAYS SUPPLY value (",DFDAYSUP,"), resetting it to ",MXDAYSUP," (maximum allowed).",!
"RTN","PSODIR1",101,0)
 S DIR("B")=DFDAYSUP
"RTN","PSODIR1",102,0)
 S DIR("A")="DAYS SUPPLY",DIR("?")="Enter a whole number between 1 and "_$S($G(CLOZPAT)=2:28,$G(CLOZPAT)=1:14,$G(CLOZPAT)=0:7,1:MXDAYSUP)
"RTN","PSODIR1",103,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") DAYSX
"RTN","PSODIR1",104,0)
 I $G(Y),$G(PSODRUG("MAXDOSE"))]"",$G(PSODIR("QTY"))]"",(+PSODIR("QTY")/Y>PSODRUG("MAXDOSE")) D  G DAYSEN
"RTN","PSODIR1",105,0)
 .W !,$C(7)," Greater than Maximum dose of "_PSODRUG("MAXDOSE")_" per day"
"RTN","PSODIR1",106,0)
 I $G(PSOFDR),$P($G(OR0),"^",24),$G(PSODIR("DAYS SUPPLY")),+Y>$G(PSODIR("DAYS SUPPLY")) D  G DAYSX
"RTN","PSODIR1",107,0)
 .W !!,"Digitally Signed Order - Days Supply cannot be increased",!
"RTN","PSODIR1",108,0)
 .N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSODIR1",109,0)
 I $G(PSONEW("FLD"))=8,PSODIR("DAYS SUPPLY")=Y Q
"RTN","PSODIR1",110,0)
 S:$G(PSODIR("DAYS SUPPLY")) PSODIR("OLD DAYS SUPPLY")=PSODIR("DAYS SUPPLY")
"RTN","PSODIR1",111,0)
 S PSODIR("DAYS SUPPLY")=Y
"RTN","PSODIR1",112,0)
 ; Checking the # Of Refills field value after the Days Supply field was edited
"RTN","PSODIR1",113,0)
 I $D(PSODRUG("IEN")),$G(Y) D
"RTN","PSODIR1",114,0)
 .N PTST
"RTN","PSODIR1",115,0)
 .S PTST=+$G(PSODIR("PATIENT STATUS")) S:'PTST PTST=$P($G(PSODIR("RX0")),"^",3)
"RTN","PSODIR1",116,0)
 .I 'PTST,$G(PSODFN) S PTST=+$G(^PS(55,PSODFN,"PS"))
"RTN","PSODIR1",117,0)
 .I PSORFLS>$$MAXNUMRF^PSOUTIL(PSODRUG("IEN"),Y,PTST,.CLOZPAT) D
"RTN","PSODIR1",118,0)
 .. W !,$C(7),"Invalid number of REFILLS for amount of DAYS SUPPLY.",!,"REFILL EDIT FORCED." D REFILL(.PSODIR)
"RTN","PSODIR1",119,0)
 .. S PSODIR("FLD",9)=PSODIR("# OF REFILLS")
"RTN","PSODIR1",120,0)
 S:$G(CLOZPAT)=0 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=0
"RTN","PSODIR1",121,0)
 D:$G(CLOZPAT)=2
"RTN","PSODIR1",122,0)
 .S:PSODIR("DAYS SUPPLY")=28 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=0
"RTN","PSODIR1",123,0)
 .S:PSODIR("DAYS SUPPLY")=14 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=1
"RTN","PSODIR1",124,0)
 .S:PSODIR("DAYS SUPPLY")=7 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=3
"RTN","PSODIR1",125,0)
 D:$G(CLOZPAT)=1
"RTN","PSODIR1",126,0)
 .S:PSODIR("DAYS SUPPLY")=14 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=0
"RTN","PSODIR1",127,0)
 .S:PSODIR("DAYS SUPPLY")=7 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=1
"RTN","PSODIR1",128,0)
 K QTYHLD S:$G(PSODIR("QTY")) QTYHLD=PSODIR("QTY") D QTY^PSOSIG(.PSODIR)
"RTN","PSODIR1",129,0)
 I $G(QTYHLD),'$G(PSODIR("QTY")) S PSODIR("QTY")=QTYHLD
"RTN","PSODIR1",130,0)
 K QTYHLD K:'$G(PSODIR("QTY")) PSODIR("QTY")
"RTN","PSODIR1",131,0)
DAYSX K X,Y
"RTN","PSODIR1",132,0)
 Q
"RTN","PSODIR1",133,0)
REFILL(PSODIR) ;
"RTN","PSODIR1",134,0)
 N PSODAYS,PSOX
"RTN","PSODIR1",135,0)
 S PSODAYS=+$G(PSODIR("DAYS SUPPLY"))
"RTN","PSODIR1",136,0)
 ;Recalculating RFTT if it doesn't exist
"RTN","PSODIR1",137,0)
 I '$G(PSONEW) D
"RTN","PSODIR1",138,0)
 .N I I '$G(RFTT),$G(PSORXED("IRXN")) F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),1,I)) Q:'I  S RFTT=$G(RFTT)+1
"RTN","PSODIR1",139,0)
 ;
"RTN","PSODIR1",140,0)
 I $G(PSODIR("PTST NODE"))="" D
"RTN","PSODIR1",141,0)
 .N X,Y
"RTN","PSODIR1",142,0)
 .S X=$G(PSODIR("PATIENT STATUS")) S:'X X=$P(RX0,"^",3)
"RTN","PSODIR1",143,0)
 .S DIC=53,DIC(0)="QXZ" D ^DIC K DIC
"RTN","PSODIR1",144,0)
 .S:+Y PSODIR("PTST NODE")=Y(0)
"RTN","PSODIR1",145,0)
 .S:'$G(PSODIR("PATIENT STATUS")) PSODIR("PATIENT STATUS")=+Y
"RTN","PSODIR1",146,0)
 S $P(PSODIR("PTST NODE"),"^",4)=+$P($G(PSODIR("PTST NODE")),"^",4)
"RTN","PSODIR1",147,0)
 I $G(OR0) G REFOR
"RTN","PSODIR1",148,0)
 K DIR,DIC,PSOX
"RTN","PSODIR1",149,0)
 ; Controlled Substance
"RTN","PSODIR1",150,0)
 S PSODIR("CS")=0
"RTN","PSODIR1",151,0)
 I (PSODRUG("DEA")["2")!(PSODRUG("DEA")["3")!(PSODRUG("DEA")["4")!(PSODRUG("DEA")["5") D
"RTN","PSODIR1",152,0)
 . S $P(PSODIR("CS"),"^")=1 S:(PSODRUG("DEA")["2") $P(PSODIR("CS"),"^",2)=1
"RTN","PSODIR1",153,0)
 ;
"RTN","PSODIR1",154,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSODIR1",155,0)
 S PSOX=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),PSODAYS,+$G(PSODIR("PATIENT STATUS")),.CLOZPAT)
"RTN","PSODIR1",156,0)
 ;
"RTN","PSODIR1",157,0)
 I '$D(CLOZPAT) I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")["F")!(PSODRUG("DEA")[1)!(PSODRUG("DEA")[2) D  G REFILLX
"RTN","PSODIR1",158,0)
 .I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")[1)!(PSODRUG("DEA")[2)!'$O(^PSRX(+$G(PSODIR("IRXN")),1,0))!('$G(PSOLOKED)) D  Q
"RTN","PSODIR1",159,0)
 ..S VALMSG="No refills allowed on "_$S(PSODRUG("DEA")["F":"this drug.",1:"Narcotics.") W !,VALMSG,!
"RTN","PSODIR1",160,0)
 ..S:$D(PSODIR("FIELD")) PSODIR("FIELD")=0 S PSODIR("# OF REFILLS")=0
"RTN","PSODIR1",161,0)
 ..Q
"RTN","PSODIR1",162,0)
 .;reset refills to the # given
"RTN","PSODIR1",163,0)
 .D RFRSET^PSODIR2
"RTN","PSODIR1",164,0)
 .Q
"RTN","PSODIR1",165,0)
 I $P($G(PSODIR("CS")),"^",2)=1 W !,"No refills allowed on Schedule 2 drugs...",! S:$D(PSODIR("FIELD")) PSODIR("FIELD")=0 S PSODIR("# OF REFILLS")=0 G REFILLX
"RTN","PSODIR1",166,0)
 ;PSO*7*266 make sure PSOX is greater than RFTT
"RTN","PSODIR1",167,0)
 S DIR(0)="N^"_$S($G(RFTT):RFTT,1:0)_":"_$S(+$G(RFTT)>PSOX:RFTT,1:PSOX),DIR("A")="# OF REFILLS"
"RTN","PSODIR1",168,0)
 ;PSO*7*340 Correct Default Value.
"RTN","PSODIR1",169,0)
 S DIR("B")=$S($G(COPY):PSODIR("# OF REFILLS"),$G(PSODIR("N# REF"))]"":PSODIR("N# REF"),$G(PSODIR("# OF REFILLS"))]"":PSODIR("# OF REFILLS"),$G(RFTT)>PSOX:RFTT,1:PSOX)
"RTN","PSODIR1",170,0)
 S DIR("?",1)="Enter a whole number. The maximum number of refills is based on"
"RTN","PSODIR1",171,0)
 S DIR("?")="the DAYS SUPPLY and the PATIENT STATUS fields."
"RTN","PSODIR1",172,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") REFILLX
"RTN","PSODIR1",173,0)
 S (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=Y
"RTN","PSODIR1",174,0)
REFILLX S:$G(PSODIR("# OF REFILLS"))']"" PSODIR("# OF REFILLS")=$S($G(PSODIR("N# REF"))]"":PSODIR("N# REF"),1:PSOX)
"RTN","PSODIR1",175,0)
 K X,Y,PSOX,DEA,PSOCS,RFTT ;PSO*7*340 Kill RFTT
"RTN","PSODIR1",176,0)
 Q
"RTN","PSODIR1",177,0)
 ;OERR CALL
"RTN","PSODIR1",178,0)
REFOR ;
"RTN","PSODIR1",179,0)
 D REFOR^PSODIR3
"RTN","PSODIR1",180,0)
 G REFILLX
"RTN","PSODIR1",181,0)
 Q
"RTN","PSODIR1",182,0)
DIR ;
"RTN","PSODIR1",183,0)
 S (PSODIR("FIELD"),PSODIR("DFLG"))=0
"RTN","PSODIR1",184,0)
 G:$G(DIR(0))']"" DIRX
"RTN","PSODIR1",185,0)
 D ^DIR K DIR,DIE,DIC,DA
"RTN","PSODIR1",186,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)),$L($G(X))'>1!(Y="") S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR1",187,0)
 I $D(DIRUT)!($D(DIROUT)),$G(SPEED) S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR1",188,0)
 I X[U,$L(X)>1 D JUMP
"RTN","PSODIR1",189,0)
DIRX K DIRUT,DTOUT,DUOUT,DIROUT
"RTN","PSODIR1",190,0)
 Q
"RTN","PSODIR1",191,0)
JUMP ;
"RTN","PSODIR1",192,0)
 I $G(PSOEDIT)!($G(OR0)) S PSODIR("DFLG")=1 Q
"RTN","PSODIR1",193,0)
 S X=$P(X,"^",2),DIC="^DD(52,",DIC(0)="QM" D ^DIC K DIC
"RTN","PSODIR1",194,0)
 I Y=-1 S PSODIR("FIELD")=PSODIR("FLD") G JUMPX
"RTN","PSODIR1",195,0)
 I $G(PSONEW1)=0 D JUMP^PSONEW1 G JUMPX
"RTN","PSODIR1",196,0)
 I $G(PSOREF1)=0 D JUMP^PSOREF1 G JUMPX
"RTN","PSODIR1",197,0)
 I $G(PSONEW3)=0 D JUMP^PSONEW3 G JUMPX
"RTN","PSODIR1",198,0)
 I $G(PSORENW3)=0 D JUMP^PSORENW3 G JUMPX
"RTN","PSODIR1",199,0)
JUMPX S X="^"_X
"RTN","PSODIR1",200,0)
 Q
"RTN","PSODIR1",201,0)
SIGOK ;review and decide on oerr sig
"RTN","PSODIR1",202,0)
 I '$O(SIG(0)) S SIGOK=0 Q
"RTN","PSODIR1",203,0)
 K SIGOK W !,"SIG: "
"RTN","PSODIR1",204,0)
 F SIG=0:0 S SIG=$O(SIG(SIG)) W SIG(SIG)_" ",!?5 Q:'$O(SIG(SIG))
"RTN","PSODIR1",205,0)
 K DIR,DIRUT,DUOUT,DTOUT S DIR("B")="YES",DIR(0)="Y",DIR("A")="Is this SIG correct" D ^DIR K DIR I $D(DIRUT) S PSODIR("DFLG")=1 K DIRUT,DUOUT,DTOUT Q
"RTN","PSODIR1",206,0)
 S SIGOK=Y I Y K PSODIR("SIG")
"RTN","PSODIR1",207,0)
 Q
"RTN","PSODIR1",208,0)
PSTPB ;
"RTN","PSODIR1",209,0)
 W !,"New orders entered through this option must have a Patient Status of 'NON-VA'!",!
"RTN","PSODIR1",210,0)
 Q
"RTN","PSOHELP")
0^12^B50313084^B49812789
"RTN","PSOHELP",1,0)
PSOHELP ;BHAM ISC/SAB-outpatient utility routine ; 10/17/07 7:41am
"RTN","PSOHELP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**3,23,29,48,46,117,131,222,268,206,276,282,444,505**;DEC 1997;Build 39
"RTN","PSOHELP",3,0)
 ;External reference ^PS(51 supported by DBIA 2224
"RTN","PSOHELP",4,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOHELP",5,0)
 ;External reference ^PS(56 supported by DBIA 2229
"RTN","PSOHELP",6,0)
 ;External reference ^PSNPPIP supported by DBIA 2261
"RTN","PSOHELP",7,0)
 ;
"RTN","PSOHELP",8,0)
XREF D XREF^PSOHELP3
"RTN","PSOHELP",9,0)
 Q
"RTN","PSOHELP",10,0)
SIG ;checks PI for RXs
"RTN","PSOHELP",11,0)
 K VALMSG
"RTN","PSOHELP",12,0)
 I $E(X)=" " D EN^DDIOL("Leading spaces should not entered in the Patient Instructions! ","","$C(7),!") S VALMSG="There are leading spaces in Patient Instructions!"
"RTN","PSOHELP",13,0)
SIGONE K INS1 Q:$L(X)<1  F Z0=1:1:$L(X," ") G:Z0="" EN S Z1=$P(X," ",Z0) D  G:'$D(X) EN
"RTN","PSOHELP",14,0)
 .I $L(Z1)>32 W $C(7),!?5,"MAX OF 32 CHARACTERS ALLOWED BETWEEN SPACES.",! K X Q
"RTN","PSOHELP",15,0)
 .D:$D(X)&($G(Z1)]"")  S INS1=$G(INS1)_" "_Z1
"RTN","PSOHELP",16,0)
 ..S Z1=$$UPPER^PSOSIG(Z1) ;*282 Provider Comments
"RTN","PSOHELP",17,0)
 ..S Y=$O(^PS(51,"B",Z1,0)) Q:'Y!($P($G(^PS(51,+Y,0)),"^",4)>1)  S Z1=$P(^PS(51,Y,0),"^",2)
"RTN","PSOHELP",18,0)
 ..I $G(^PS(51,+Y,9))]"" S Y=$P(X," ",Z0-1),Y=$E(Y,$L(Y)) S:Y>1 Z1=^(9)
"RTN","PSOHELP",19,0)
EN K Z1,Z0
"RTN","PSOHELP",20,0)
 Q
"RTN","PSOHELP",21,0)
SSIG ;other lang. mods
"RTN","PSOHELP",22,0)
 K VALMSG
"RTN","PSOHELP",23,0)
 I $E(X)=" " D EN^DDIOL("Leading spaces should not entered in the Patient Instructions! ","","$C(7),!") S VALMSG="There are leading spaces in Patient Instructions!"
"RTN","PSOHELP",24,0)
 K SINS1 Q:$L(X)<1  F Z0=1:1:$L(X," ") G:Z0="" EX S Z1=$P(X," ",Z0) D  G:'$D(X) EX
"RTN","PSOHELP",25,0)
 .I $L(Z1)>32 W $C(7),!?5,"MAX OF 32 CHARACTERS ALLOWED BETWEEN SPACES.",! K X Q
"RTN","PSOHELP",26,0)
 .D:$D(X)&($G(Z1)]"")  S SINS1=$G(SINS1)_" "_Z1
"RTN","PSOHELP",27,0)
 ..S Z1=$$UPPER^PSOSIG(Z1) ;*282 Provider Comments
"RTN","PSOHELP",28,0)
 ..S Y=$O(^PS(51,"B",Z1,0)) Q:'Y!($P($G(^PS(51,+Y,0)),"^",4)>1)  S Z1=$P(^PS(51,Y,0),"^",2)
"RTN","PSOHELP",29,0)
 ..I $G(^PS(51,+Y,4))]"" S Z1=^PS(51,+Y,4) ;,Y=$P(X," ",Z0-1),Y=$E(Y,$L(Y)) S:Y>1 Z1=^(9)
"RTN","PSOHELP",30,0)
EX K Z1,Z0
"RTN","PSOHELP",31,0)
 Q
"RTN","PSOHELP",32,0)
QTY ;Check quantity dispensed against inventory
"RTN","PSOHELP",33,0)
 Q:'$G(PSODRUG("IEN"))
"RTN","PSOHELP",34,0)
 S Z0=$S($G(PSODRUG("IEN"))]"":PSODRUG("IEN"),$G(PSXYES):$P(^PSRX(ZRX,0),"^",6),$D(^PSRX(DA,0)):+$P(^(0),"^",6),1:0)
"RTN","PSOHELP",35,0)
 ; PSO*7*505 - Removed the following line to prevent the removal of leading zero's 0.5 being 'plused' removes the 0 and
"RTN","PSOHELP",36,0)
 ; evaluates to false, killing X in the event the drug is a cmop drug.
"RTN","PSOHELP",37,0)
 ;I $D(^PSDRUG("AQ",Z0)),(+X'=X) K X,Z0 Q
"RTN","PSOHELP",38,0)
 S Z1=$S($D(^PSDRUG(Z0,660.1)):^(660.1),1:0)+(+X) D:X>Z1 EN^DDIOL("  Greater Than Current Inventory!","","$C(7)") K Z1
"RTN","PSOHELP",39,0)
 S ZX=X,ZZ0=$G(D0),D0=Z0
"RTN","PSOHELP",40,0)
 S Y(18,2)=$S($D(^PSDRUG(D0,660)):^(660),1:""),Y(18,1)=$S($D(^(660.1)):^(660.1),1:"")
"RTN","PSOHELP",41,0)
 S X=$P(Y(18,1),"^",1),X=$S($P(Y(18,2),"^",5):X/$P(Y(18,2),"^",5),1:"*******")
"RTN","PSOHELP",42,0)
 S X=$J(X,0,2)
"RTN","PSOHELP",43,0)
 D:X<$S($D(^PSDRUG(Z0,660)):+^(660),1:1) EN^DDIOL("  Below Reorder Level.","","$C(7)") S X=ZX,D0=$G(ZZ0) K ZZ0,Z0,ZX
"RTN","PSOHELP",44,0)
 Q
"RTN","PSOHELP",45,0)
HELP ;qty help
"RTN","PSOHELP",46,0)
 G:$G(PSOFDR) HLP
"RTN","PSOHELP",47,0)
 S Z0=$S($G(PSODRUG("IEN"))]"":PSODRUG("IEN"),$G(PSXYES):$P(^PSRX(ZRX,0),"^",6),$D(^PSRX(DA,0)):$P(^PSRX(DA,0),"^",6),1:0)
"RTN","PSOHELP",48,0)
HLP S Z0=+$G(PSODRUG("IEN"))  I $D(^PSDRUG("AQ",Z0)) D EN^DDIOL("This is a CMOP drug. The quantity may not contain alpha characters (i.e.; ML)","","!!") D EN^DDIOL("or more than two fractional decimal places (i.e.; .01).","","!") D  K Z0 Q
"RTN","PSOHELP",49,0)
 .D EN^DDIOL("Enter a number between 0 and 99999999 inclusive. The total entry cannot","","!") D EN^DDIOL("exceed 11 characters.","","!")
"RTN","PSOHELP",50,0)
 D EN^DDIOL("Enter a whole number between 0 and 99999999 inclusive.  Alpha characters are","","!!")
"RTN","PSOHELP",51,0)
 D EN^DDIOL("not allowed, and the entry cannot exceed 11 characters, or contain more than","","!") D EN^DDIOL("two fractional decimal places (i.e.; .01).","","!")
"RTN","PSOHELP",52,0)
 K Z0
"RTN","PSOHELP",53,0)
 Q
"RTN","PSOHELP",54,0)
ADD ;add/edited local drug/drug interactions
"RTN","PSOHELP",55,0)
 W ! S DIC("A")="Select Drug Interaction: ",DIC(0)="AEMQL",DLAYGO=56
"RTN","PSOHELP",56,0)
 S (DIC,DIE)="^PS(56,",DIC("S")="I '$P(^(0),""^"",5)" D ^DIC G:"^"[X QU G:Y<0 ADD S DA=+Y,DR="[PSO INTERACT]" L +^PS(56,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !,"Entry is being edited by another user. Try Later!",! G ADD
"RTN","PSOHELP",57,0)
 D ^DIE L:$G(DA) -^PS(56,DA) K DA G ADD
"RTN","PSOHELP",58,0)
QU L -^PS(56,DA) K X,DIC,DIE,DA
"RTN","PSOHELP",59,0)
 Q
"RTN","PSOHELP",60,0)
CRI ;change drug interaction severity to critical from significant
"RTN","PSOHELP",61,0)
 W ! S DIC("A")="Select Drug Interaction: ",DIC(0)="AEQM",(DIC,DIE)="^PS(56,",DIC("S")="I $P(^(0),""^"",4)=2" D ^DIC G:"^"[X QU G:Y<0 CRI S DA=+Y,DR=3
"RTN","PSOHELP",62,0)
 L +^PS(56,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !,"Entry is being edited by another user. Try Later!",! G CRI
"RTN","PSOHELP",63,0)
 D ^DIE L -^PS(56,DA) K DA G CRI
"RTN","PSOHELP",64,0)
 G QU
"RTN","PSOHELP",65,0)
 Q
"RTN","PSOHELP",66,0)
MAX S:$G(EXH) P(7)=$P(^PSRX(DA,0),"^",8),P(5)=$P(^(0),"^",6),P(2)=+$P(^(0),"^",3) S:P(2) PTST=$G(^PS(53,P(2),0)),PTDY=$P($G(^(0)),"^",3),PTRF=$P($G(^(0)),"^",4)
"RTN","PSOHELP",67,0)
 S PSODEA=$P(^PSDRUG(P(5),0),"^",3),CS=0
"RTN","PSOHELP",68,0)
 I $D(CLOZPAT) S MAX=$S(CLOZPAT=2&($P(^PSRX(DA,0),"^",8)=14):1,CLOZPAT=2&($P(^PSRX(DA,0),"^",8)=7):3,CLOZPAT=1&($P(^PSRX(DA,0),"^",8)=7):1,1:0),MIN=0 Q
"RTN","PSOHELP",69,0)
 I PSODEA["A"&(PSODEA'["B")!(PSODEA["F")!(PSODEA[1)!(PSODEA[2) D EN^DDIOL("No refills allowed on "_$S(PSODEA["A":"this narcotic drug.",1:"this drug."),"","!") D EN^DDIOL(" ","","!") S $P(^PSRX(DA,0),"^",9)=0 K X,Y,PSODEA,CS,PTST Q
"RTN","PSOHELP",70,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSOHELP",71,0)
 S MAX=$$MAXNUMRF^PSOUTIL(+$G(P(5)),+$G(P(7)),+$G(P(2)),.CLOZPAT)
"RTN","PSOHELP",72,0)
 I $D(X) S MIN=0 I $D(DA) F REF=0:0 S REF=$O(^PSRX(DA,1,REF)) Q:'REF  I $D(^(REF,0)) S MIN=MIN+1
"RTN","PSOHELP",73,0)
 I $G(EXH) D EN^DDIOL("Enter a number Between "_MIN_" AND "_MAX_".","","!?10") K P(2),P(5),P(7),MAX,MAX1,MIN,REF
"RTN","PSOHELP",74,0)
 Q
"RTN","PSOHELP",75,0)
 ;
"RTN","PSOHELP",76,0)
REF S PSRF=X,P(7)=$P(^PSRX(DA,0),"^",8),P(5)=$P(^(0),"^",6),P(2)=+$P(^(0),"^",3) S:P(2) PTST=$G(^PS(53,P(2),0)) S PTDY=$P(^(0),"^",3),PTRF=$P(^(0),"^",4)
"RTN","PSOHELP",77,0)
 D MAX Q:'$D(X)  I (+X'=X)!(X<0)!(X>MAX)!(X?.E1"."1N.N) D EN^DDIOL(" ** MAX REFILLS ALLOWED ARE "_MAX_" ** ","","$C(7)") K X
"RTN","PSOHELP",78,0)
 I $D(X),X<MIN D EN^DDIOL(" ** PATIENT HAS ALREADY RECEIVED "_MIN_" REFILLS ** ","","$C(7)") K X
"RTN","PSOHELP",79,0)
 D DAYS^PSOUTLA
"RTN","PSOHELP",80,0)
 K PTDY,PTRF,MAX,DAYS,PSDAYS,PSODEA,PSOX,PSOX1,PSDY,PSDY1,DEA,CS,PTST,PSRF,MIN,REF,P(2),P(7),P(5),MAX1
"RTN","PSOHELP",81,0)
 Q
"RTN","PSOHELP",82,0)
PAT ;patient field screen in file 52
"RTN","PSOHELP",83,0)
 N DIC,DIE S DFN=X D INP^VADPT,DEM^VADPT
"RTN","PSOHELP",84,0)
 I $P(VADM(6),"^") D EN^DDIOL("PATIENT DIED "_$P(VADM(6),"^",2),"","$C(7),!?10") D EN^DDIOL(" ","","!") K X,DFN Q
"RTN","PSOHELP",85,0)
 I $P(VAIN(4),"^") D EN^DDIOL("PATIENT IS AN INPATIENT ON WARD "_$P(VAIN(4),"^",2)_" !!","","$C(7),!?10") K DIR D DIR K VA,VADN,VAIN Q
"RTN","PSOHELP",86,0)
 E  S X=DFN K DFN,DIRUT,DTOUT,DUOUT
"RTN","PSOHELP",87,0)
 Q
"RTN","PSOHELP",88,0)
DIR S DIR(0)="Y",DIR("B")="YES",DIR("A")="DO YOU WISH TO CONTINUE" D ^DIR K DIR
"RTN","PSOHELP",89,0)
 K:'Y X S:Y X=DFN K DFN,DIRUT,DTOUT,DUOUT,VA,VADM,VAIN
"RTN","PSOHELP",90,0)
 Q
"RTN","PSOHELP",91,0)
BG ;prevents editing of display groups with patients from name to ticket
"RTN","PSOHELP",92,0)
 S $P(^PS(59.3,DA,0),"^",2)=PDP W !,$C(7),"The display cannot be changed from NAME to TICKET when patients are",!,"already in the Display Group.  All patients must be purged and re-entered.",!,"Ticket numbers must be issued !!",! K Y,PDP
"RTN","PSOHELP",93,0)
 Q
"RTN","PSOHELP",94,0)
CLNAP ;quits action profile
"RTN","PSOHELP",95,0)
 Q
"RTN","PSOHELP",96,0)
PRMI ;prints medication instruction sheets.  select drug.
"RTN","PSOHELP",97,0)
 S X="PSNPPIP" X ^%ZOSF("TEST") I '$T S VALMBCK="",VALMSG="Medication Instruction Sheets Not Installed!" Q
"RTN","PSOHELP",98,0)
 I $G(PSODFN) N PSNDFN S PSNDFN=PSODFN
"RTN","PSOHELP",99,0)
 W !! K PSNPPI("MESSAGE") D FULL^VALM1,^PSNPPIP S VALMBCK="R"
"RTN","PSOHELP",100,0)
 I $G(PSNPPI("MESSAGE"))]"" D
"RTN","PSOHELP",101,0)
 .K DIR W PSNPPI("MESSAGE"),! S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DIRUT,PSNPPI("MESSGAE")
"RTN","PSOHELP",102,0)
 Q
"RTN","PSOHELP",103,0)
PRMID ;prints medication instruction sheets.  pass in drug.
"RTN","PSOHELP",104,0)
 N RX0,RXN  ;*276
"RTN","PSOHELP",105,0)
 S RXN=$P($G(PSOLST(ORN)),"^",2) Q:RXN=""  ;*276
"RTN","PSOHELP",106,0)
 I $T(ENOP^PSNPPIP)']"" S VALMBCK="",VALMSG="Medication Instruction Sheets Not Installed!" Q
"RTN","PSOHELP",107,0)
 K PSNPPI("MESSAGE") D FULL^VALM1
"RTN","PSOHELP",108,0)
 S RX0=$G(^PSRX(RXN,0))  ;*276
"RTN","PSOHELP",109,0)
 W !! D ENOP^PSNPPIP($P(RX0,"^",6),$G(^PSRX(RXN,"TN")),$P(RX0,"^"),PSODFN)
"RTN","PSOHELP",110,0)
 S VALMBCK="R" I $G(PSNPPI("MESSAGE"))]"" D
"RTN","PSOHELP",111,0)
 .K DIR W PSNPPI("MESSAGE"),! S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DIRUT,PSNPPI("MESSGAE")
"RTN","PSOHELP",112,0)
 Q
"RTN","PSOHLDS4")
0^14^B16987762^B16602666
"RTN","PSOHLDS4",1,0)
PSOHLDS4 ;BIR/PWC - Build HL7 Segments for Automated Interface ; 2/13/08 3:21pm
"RTN","PSOHLDS4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**156,255,279,385,505**;DEC 1997;Build 39
"RTN","PSOHLDS4",3,0)
 ;HLFNC       supp. by DBIA 10106
"RTN","PSOHLDS4",4,0)
 ;DIC(5       supp. by DBIA 10056
"RTN","PSOHLDS4",5,0)
 ;EN^PSNPPIO  supp. by DBIA 3794
"RTN","PSOHLDS4",6,0)
 ;This routine is called from PSOHLDS1
"RTN","PSOHLDS4",7,0)
 ;
"RTN","PSOHLDS4",8,0)
 ;*255 moved tag NTEPMI from PSOHLDS2
"RTN","PSOHLDS4",9,0)
 Q
"RTN","PSOHLDS4",10,0)
IAM(PSI) ;allergy list segment
"RTN","PSOHLDS4",11,0)
 Q:'$D(DFN)!$D(PAS3)
"RTN","PSOHLDS4",12,0)
 N IAM,IDX,SEV,SEV1,DAT,X,TYP,TYP1,VER,VER1
"RTN","PSOHLDS4",13,0)
 S IAM="",CNT=0,GMRA="0^0^111" D EN1^GMRADPT
"RTN","PSOHLDS4",14,0)
 I $G(GMRAL)="" G ZALQT
"RTN","PSOHLDS4",15,0)
 F AIEN=0:0 S AIEN=$O(GMRAL(AIEN)) Q:'AIEN  D
"RTN","PSOHLDS4",16,0)
 .K ADTL D EN1^GMRAOR2(AIEN,"ADTL") S CNT=CNT+1
"RTN","PSOHLDS4",17,0)
 .S TYP1=$P(GMRAL(AIEN),"^",7)
"RTN","PSOHLDS4",18,0)
 .S TYP=$S(TYP1="D":"DRUG",TYP1="F":"FOOD",TYP1="O":"OTHER",TYP1="DF":"DRUG/FOOD",TYP1="DO":"DRUG/OTHER",TYP1="DFO":"DRUG/FOOD/OTHER",1:"""""")
"RTN","PSOHLDS4",19,0)
 .S VER=$S($P(GMRAL(AIEN),"^",4)=1:"VERIFIED",1:"NON-VERIFIED")
"RTN","PSOHLDS4",20,0)
 .S VER1=$S($P(GMRAL(AIEN),"^",4)=1:"C",1:"U")  ;confirmed or unconfirmed
"RTN","PSOHLDS4",21,0)
 .S $P(IAM,"|",2)=TYP1_CS_TYP_CS_"LGMR120.8"
"RTN","PSOHLDS4",22,0)
 .S $P(IAM,"|",3)=AIEN_CS_$P(GMRAL(AIEN),"^",2)_CS_"LGMR120.8"
"RTN","PSOHLDS4",23,0)
 .S IDX=$O(ADTL("O","")),X="" S:IDX'="" X=$G(ADTL("O",IDX))
"RTN","PSOHLDS4",24,0)
 .S DAT=$P(X,"^"),DAT=$S(DAT'="":$$HLDATE^HLFNC(DAT,"DT"),1:"")
"RTN","PSOHLDS4",25,0)
 .S SEV=$P(X,"^",2) S:SEV="" SEV="""""",DAT=""
"RTN","PSOHLDS4",26,0)
 .S SEV1=$S(SEV="MILD":"MI",SEV="MODERATE":"MO",SEV="SEVERE":"SV",1:"U")
"RTN","PSOHLDS4",27,0)
 .S $P(IAM,"|",4)=SEV1
"RTN","PSOHLDS4",28,0)
 .S $P(IAM,"|",5)=$P($P(GMRAL(AIEN),"^",8),";")
"RTN","PSOHLDS4",29,0)
 .S $P(IAM,"|",13)=DAT
"RTN","PSOHLDS4",30,0)
 .S $P(IAM,"|",17)=VER1
"RTN","PSOHLDS4",31,0)
 .S ^TMP("PSO",$J,PSI)="IAM|"_IAM,PSI=PSI+1
"RTN","PSOHLDS4",32,0)
 .F  S IDX=$O(ADTL("O",IDX)) Q:IDX=""  D   ;repeat for all reactions
"RTN","PSOHLDS4",33,0)
 ..S X=$G(ADTL("O",IDX)),DAT=$P(X,"^"),SEV=$P(X,"^",2) I SEV="" Q
"RTN","PSOHLDS4",34,0)
 ..S DAT=$S(DAT'="":$$HLDATE^HLFNC(DAT,"DT"),1:"")
"RTN","PSOHLDS4",35,0)
 ..S $P(IAM,FS,4)=SEV,$P(IAM,FS,13)=DAT
"RTN","PSOHLDS4",36,0)
 ..S ^TMP("PSO",$J,PSI)="IAM|"_IAM,PSI=PSI+1
"RTN","PSOHLDS4",37,0)
 S PAS3=1
"RTN","PSOHLDS4",38,0)
 ;
"RTN","PSOHLDS4",39,0)
ZALQT K GMRAL,ADTL,AIEN,CNT,CNT,GMRA,TYP,TYP1,SEV,SEV1,VER,VER1
"RTN","PSOHLDS4",40,0)
 Q
"RTN","PSOHLDS4",41,0)
 ;
"RTN","PSOHLDS4",42,0)
ORC(PSI) ;common order segment
"RTN","PSOHLDS4",43,0)
 Q:'$D(DFN)
"RTN","PSOHLDS4",44,0)
 N ORC S ORC=""
"RTN","PSOHLDS4",45,0)
 S $P(ORC,"|",1)="NW"
"RTN","PSOHLDS4",46,0)
 S $P(ORC,"|",2)=IRXN_CS_"OP7.0"
"RTN","PSOHLDS4",47,0)
 S $P(ORC,"|",9)=ISDT
"RTN","PSOHLDS4",48,0)
 S $P(ORC,"|",10)=EBY_CS_EBY1
"RTN","PSOHLDS4",49,0)
 S $P(ORC,"|",12)=PVDR_CS_PVDR1
"RTN","PSOHLDS4",50,0)
 S $P(ORC,"|",13)=$G(PSOLAP)
"RTN","PSOHLDS4",51,0)
 S $P(ORC,"|",15)=EFDT
"RTN","PSOHLDS4",52,0)
 S $P(ORC,"|",16)=$S($G(RXPR(IRXN)):"PARTIAL",$G(RXFL(IRXN)):"REFILL",$G(RXRP(IRXN)):"REPRINT",1:"NEW")
"RTN","PSOHLDS4",53,0)
 S $P(ORC,"|",17)=CLN_CS_CLN1_CS_"99PSC"
"RTN","PSOHLDS4",54,0)
 S $P(ORC,"|",19)=$S(CSINER'="":CSINER_CS_CSINER1,1:"")
"RTN","PSOHLDS4",55,0)
 S $P(ORC,"|",20)=$S($$STATUS^PSOBPSUT(IRXN,$G(RXFL(IRXN)))]"":"VA5",1:"") ; Added ePharmacy indicator (VA5) BNT; PSO*7*385
"RTN","PSOHLDS4",56,0)
 S $P(ORC,"|",21)=$P(SITE,"^",1)_CS_CS_$P(SITE,"^",6)
"RTN","PSOHLDS4",57,0)
 S PSZIP=$P(SITE,"^",5),PSOHZIP=$S(PSZIP["-":PSZIP,1:$E(PSZIP,1,5)_$S($E(PSZIP,6,9)]"":"-"_$E(PSZIP,6,9),1:""))
"RTN","PSOHLDS4",58,0)
 S $P(ORC,"|",22)=$P(SITE,"^",2)_CS_CS_$P(SITE,"^",7)_CS_$S($D(^DIC(5,+$P(SITE,"^",8),0)):$P(^(0),"^",2),1:"UKN")_CS_PSOHZIP
"RTN","PSOHLDS4",59,0)
 S $P(ORC,"|",23)="("_$P(SITE,"^",3)_")"_$P(SITE,"^",4)
"RTN","PSOHLDS4",60,0)
 ;/BLB/ PSO*7.0*505 ;ADDED LOGIC TO ADD DIGITAL SIGNATURE FOR CONTROLLED SUBSTANCE PRESCRIPTIONS
"RTN","PSOHLDS4",61,0)
 I $$GET1^DIQ(52,IRXN,310,"I") S $P(ORC,"|",30)="EL"
"RTN","PSOHLDS4",62,0)
 S ^TMP("PSO",$J,PSI)="ORC|"_ORC,PSI=PSI+1
"RTN","PSOHLDS4",63,0)
 Q
"RTN","PSOHLDS4",64,0)
 ;
"RTN","PSOHLDS4",65,0)
NTEPMI(PSI) ;build NTE segment for PMI sheets                   ;*255
"RTN","PSOHLDS4",66,0)
 Q:'$D(DFN)  N A,I,PREVLN,CURRLN,PMI,PSNMSG,PSDRUG
"RTN","PSOHLDS4",67,0)
 S PSDRUG=+$P(^PSRX(IRXN,0),"^",6),PMI=$$EN^PSNPPIO(PSDRUG,.PSNMSG)
"RTN","PSOHLDS4",68,0)
 Q:'$D(^TMP($J,"PSNPMI"))
"RTN","PSOHLDS4",69,0)
 ;PSO*7*279 Add missing PMI ID(7) to NTE Segment
"RTN","PSOHLDS4",70,0)
 S ^TMP("PSO",$J,PSI)="NTE"_FS_7_FS_FS_^TMP($J,"PSNPMI",0)
"RTN","PSOHLDS4",71,0)
 K A S CNT1=1,CNT=0
"RTN","PSOHLDS4",72,0)
 F A="W","U","H","S","M","P","I","O","N","D","R" S CNT=CNT+1,A(CNT)=A
"RTN","PSOHLDS4",73,0)
 F I=1:1:11 I $D(^TMP($J,"PSNPMI",A(I))) D
"RTN","PSOHLDS4",74,0)
 .S CNT=$P(^TMP($J,"PSNPMI",A(I),0),"^",3)
"RTN","PSOHLDS4",75,0)
 .S (PREVLN,CURRLN)=""
"RTN","PSOHLDS4",76,0)
 .F J=1:1:CNT D
"RTN","PSOHLDS4",77,0)
 .. S ^TMP("PSO",$J,PSI,CNT1)=^TMP($J,"PSNPMI",A(I),J,0)
"RTN","PSOHLDS4",78,0)
 .. ;PSO*198 check if " " should be inserted
"RTN","PSOHLDS4",79,0)
 .. S CURRLN=^TMP("PSO",$J,PSI,CNT1)
"RTN","PSOHLDS4",80,0)
 .. S:CNT1>1 PREVLN=$S(CNT>1:^TMP("PSO",$J,PSI,CNT1-1),1:"")
"RTN","PSOHLDS4",81,0)
 .. I CNT1>1,$$SPACE^PSOHLDS3(PREVLN,CURRLN) D
"RTN","PSOHLDS4",82,0)
 ... S ^TMP("PSO",$J,PSI,CNT1)=" "_^TMP("PSO",$J,PSI,CNT1)
"RTN","PSOHLDS4",83,0)
 .. I J=1 S $P(^TMP("PSO",$J,PSI,CNT1),":",1)="\H\"_$P(^TMP("PSO",$J,PSI,CNT1),":",1)_"\N\"
"RTN","PSOHLDS4",84,0)
 .. S CNT1=CNT1+1
"RTN","PSOHLDS4",85,0)
 S ^TMP("PSO",$J,PSI,CNT1-1)=^TMP("PSO",$J,PSI,CNT1-1)_FS_"Patient Medication Instructions"
"RTN","PSOHLDS4",86,0)
 S PSI=PSI+1 K A,I,J,CNT,CNT1,^TMP($J,"PSNPMI")
"RTN","PSOHLDS4",87,0)
 Q
"RTN","PSOHLEXP")
0^5^B24025393^B22400492
"RTN","PSOHLEXP",1,0)
PSOHLEXP ;BIR/RTR-Auto expire prescriptions ; 10/10/07 11:16am
"RTN","PSOHLEXP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,22,36,73,148,257,391,505**;DEC 1997;Build 39
"RTN","PSOHLEXP",3,0)
 ;
"RTN","PSOHLEXP",4,0)
 ;External reference to ^PS(59.7 supported by DBIA 694
"RTN","PSOHLEXP",5,0)
 ;External reference to STATUS^ORQOR2 is supported by DBIA 3458
"RTN","PSOHLEXP",6,0)
 ;External references to LOCK1^ORX2 and UNLK1^ORX2 are supported by DBIA 867
"RTN","PSOHLEXP",7,0)
EN N PSOEXRX,PSOEXCOM,PSOEXSTS,SUSD,PSOEXSTA,ZZDT,ZZEDT,IFN,NODE,RF,PIFN,PSUSD,PRFDT,PDA,PSDTEST,ORN,CPRSDC
"RTN","PSOHLEXP",8,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOHLEXP",9,0)
 S X1=DT,X2=-1 D C^%DTC S ZZEDT=X
"RTN","PSOHLEXP",10,0)
 S ZZDT=$P($G(^PS(59.7,1,49.99)),"^",8) I +ZZDT=0 S X1=DT,X2=-2 D C^%DTC S ZZDT=X
"RTN","PSOHLEXP",11,0)
 F  S ZZDT=$O(^PSRX("AG",ZZDT)) Q:ZZDT>ZZEDT  Q:ZZDT=""  D EN1
"RTN","PSOHLEXP",12,0)
 D FACDEA
"RTN","PSOHLEXP",13,0)
 Q
"RTN","PSOHLEXP",14,0)
EN1 F PSOEXRX=0:0 S PSOEXRX=$O(^PSRX("AG",ZZDT,PSOEXRX)) Q:'PSOEXRX  D:$D(^PSRX(PSOEXRX,0))
"RTN","PSOHLEXP",15,0)
 .N CPRSDC,CPRSSTA
"RTN","PSOHLEXP",16,0)
 .S CPRSDC=",1,7,12,13,"
"RTN","PSOHLEXP",17,0)
 .S ORN=$P($G(^PSRX(PSOEXRX,"OR1")),"^",2),CPRSSTA=""
"RTN","PSOHLEXP",18,0)
 .I ORN S CPRSSTA=+$$STATUS^ORQOR2(ORN) I CPRSSTA=0 S ORN=""
"RTN","PSOHLEXP",19,0)
 .Q:$P($G(^PSRX(PSOEXRX,2)),"^",6)'=ZZDT
"RTN","PSOHLEXP",20,0)
 .K CMOP S DA=PSOEXRX I DA D ^PSOCMOPA  ;*257 ;SET UP CMOP() ARRAY
"RTN","PSOHLEXP",21,0)
 .S DA=$O(^PS(52.5,"B",PSOEXRX,0))
"RTN","PSOHLEXP",22,0)
 .I DA S SUSD=$P($G(^PS(52.5,DA,0)),"^",2) I SUSD,$P($G(^(0)),"^",3) S DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOHLEXP",23,0)
 .I $D(^PS(52.4,PSOEXRX,0)) S DIK="^PS(52.4,",DA=PSOEXRX D ^DIK K DIK
"RTN","PSOHLEXP",24,0)
 .I $G(^PSRX(PSOEXRX,"H"))]"" K:$P(^PSRX(PSOEXRX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSOEXRX,"H"),"^"),PSOEXRX) S ^PSRX(PSOEXRX,"H")=""
"RTN","PSOHLEXP",25,0)
 .S PSOEXSTA=$P($G(^PSRX(PSOEXRX,"STA")),"^")
"RTN","PSOHLEXP",26,0)
 .I PSOEXSTA=13 D  Q
"RTN","PSOHLEXP",27,0)
 ..I 'ORN D EN^PSOHDR("PRES",PSOEXRX)
"RTN","PSOHLEXP",28,0)
 .I PSOEXSTA=12!(PSOEXSTA=14)!(PSOEXSTA=15) I ORN,CPRSDC'[(","_CPRSSTA_",") D
"RTN","PSOHLEXP",29,0)
 ..D EN^PSOHLSN1(PSOEXRX,"OD","","","A")
"RTN","PSOHLEXP",30,0)
 ..I ORN S CPRSSTA=+$$STATUS^ORQOR2(ORN)
"RTN","PSOHLEXP",31,0)
 .I PSOEXSTA=11 I ORN,CPRSDC'[(","_CPRSSTA_",") D
"RTN","PSOHLEXP",32,0)
 ..S $P(^PSRX(PSOEXRX,0),"^",19)=1
"RTN","PSOHLEXP",33,0)
 ..D EN^PSOHLSN1(PSOEXRX,"SC","ZE","Prescription is expired")
"RTN","PSOHLEXP",34,0)
 .I PSOEXSTA>9&(PSOEXSTA'=16) Q
"RTN","PSOHLEXP",35,0)
 .S $P(^PSRX(PSOEXRX,"STA"),"^")=11
"RTN","PSOHLEXP",36,0)
 .D REVERSE^PSOBPSU1(PSOEXRX,0,"DE",5,"RX EXPIRED")
"RTN","PSOHLEXP",37,0)
 .S (PIFN,PSUSD,PRFDT)=0 F  S PIFN=$O(^PSRX(PSOEXRX,1,PIFN)) Q:'PIFN  S PSUSD=PIFN,PRFDT=+$P($G(^PSRX(PSOEXRX,1,PIFN,0)),"^")
"RTN","PSOHLEXP",38,0)
 .S ORN=$P($G(^PSRX(PSOEXRX,"OR1")),"^",2)
"RTN","PSOHLEXP",39,0)
 .I $G(PSUSD) I '$P($G(^PSRX(PSOEXRX,1,PSUSD,0)),"^",18) S PSDTEST=0 D  I 'PSDTEST K ^PSRX(PSOEXRX,1,PSUSD),^PSRX("AD",PRFDT,PSOEXRX,PSUSD),^PSRX(PSOEXRX,1,"B",PRFDT,PSUSD) D NSET
"RTN","PSOHLEXP",40,0)
 ..D REVERSE^PSOBPSU1(PSOEXRX,PSUSD,"DE",5,"RX EXPIRED")
"RTN","PSOHLEXP",41,0)
 ..F PDA=0:0 S PDA=$O(^PSRX(PSOEXRX,"L",PDA)) Q:'PDA  I $P($G(^PSRX(PSOEXRX,"L",PDA,0)),"^",2)=PSUSD S PSDTEST=1
"RTN","PSOHLEXP",42,0)
 ..I $G(CMOP(CMOP("L")))="",".L.X."[("."_$G(CMOP("S"))_".") S PSDTEST=1
"RTN","PSOHLEXP",43,0)
 ..N PSOORL
"RTN","PSOHLEXP",44,0)
 ..S PSOORL=$$LOCK1^ORX2(ORN) S:'PSOORL PSDTEST=1 I PSOORL D UNLK1^ORX2(ORN)
"RTN","PSOHLEXP",45,0)
 ..N PDA0
"RTN","PSOHLEXP",46,0)
 ..;S PDAQ=0
"RTN","PSOHLEXP",47,0)
 ..F PDA=0:0 S PDA=$O(^PSRX(PSOEXRX,4,PDA)) Q:'PDA  D
"RTN","PSOHLEXP",48,0)
 ...S PDA0=$G(^PSRX(PSOEXRX,4,PDA,0))
"RTN","PSOHLEXP",49,0)
 ...I $P(PDA0,"^",3)=PSUSD S PSDTEST=1   ;*257
"RTN","PSOHLEXP",50,0)
 ..;Q:'PDAQ
"RTN","PSOHLEXP",51,0)
 ..;S PSDTEST=1
"RTN","PSOHLEXP",52,0)
 .I 'ORN D EN^PSOHDR("PRES",PSOEXRX) Q
"RTN","PSOHLEXP",53,0)
 .I CPRSDC[(","_CPRSSTA_",") D EN^PSOHDR("PRES",PSOEXRX) Q
"RTN","PSOHLEXP",54,0)
 .S $P(^PSRX(PSOEXRX,0),"^",19)=1
"RTN","PSOHLEXP",55,0)
 .S PSOEXCOM="Prescription past expiration date" D EN^PSOHLSN1(PSOEXRX,"SC","ZE",PSOEXCOM)
"RTN","PSOHLEXP",56,0)
 S DIE=59.7,DA=1,DR="49.95///"_ZZDT D ^DIE K DIE,DA,DR
"RTN","PSOHLEXP",57,0)
 Q
"RTN","PSOHLEXP",58,0)
NSET ;
"RTN","PSOHLEXP",59,0)
 N PSONM,PSONMX
"RTN","PSOHLEXP",60,0)
 S PSONM="" F PSONMX=0:0 S PSONMX=$O(^PSRX(PSOEXRX,1,PSONMX)) Q:'PSONMX  S PSONM=PSONMX
"RTN","PSOHLEXP",61,0)
 S ^PSRX(PSOEXRX,1,0)="^52.1DA^"_$G(PSONM)_"^"_$G(PSONM)
"RTN","PSOHLEXP",62,0)
 Q
"RTN","PSOHLEXP",63,0)
SETUP ;
"RTN","PSOHLEXP",64,0)
 K %DT,DIC,DTOUT S DIC(0)="XZM",DIC="^DIC(19.2,",X="PSO EXPIRE PRESCRIPTIONS" D ^DIC
"RTN","PSOHLEXP",65,0)
 I +Y>0 D EDIT^XUTMOPT("PSO EXPIRE PRESCRIPTIONS") K DIC,Y,X Q
"RTN","PSOHLEXP",66,0)
 D RESCH^XUTMOPT("PSO EXPIRE PRESCRIPTIONS","","","24H","L"),EDIT^XUTMOPT("PSO EXPIRE PRESCRIPTIONS") K DIC,Y,X
"RTN","PSOHLEXP",67,0)
OUT Q
"RTN","PSOHLEXP",68,0)
FACDEA ;PSO*7*391/JAM  - Checks and notifies PSDMGR group when facility DEA is about to expire. /BLB/ PSO*7.0*505 ;MODIFIED THE TEXT OF THE MESSAGE
"RTN","PSOHLEXP",69,0)
 N DIV,INACT,SITE,DEA,DEAXDT,XMDUZ,XMY,XMTEXT,XMSUB,USR,TEXT
"RTN","PSOHLEXP",70,0)
 S DIV=0 F  S DIV=$O(^PS(59,DIV)) Q:'DIV  D
"RTN","PSOHLEXP",71,0)
 .S INACT=$P($G(^PS(59,DIV,"I")),"^") I INACT,DT>INACT Q
"RTN","PSOHLEXP",72,0)
 .S SITE=$P($G(^PS(59,DIV,"INI")),"^") I SITE="" Q
"RTN","PSOHLEXP",73,0)
 .I '$$ACTIVE^XUAF4(SITE) Q
"RTN","PSOHLEXP",74,0)
 .S DEA=$$WHAT^XUAF4(SITE,52) I DEA="" Q
"RTN","PSOHLEXP",75,0)
 .S DEAXDT=$$GET1^DIQ(4,SITE,52.1,"I") I '+DEAXDT Q
"RTN","PSOHLEXP",76,0)
 .I $$FMDIFF^XLFDT(DEAXDT,DT)>30 Q
"RTN","PSOHLEXP",77,0)
 .S DIV(SITE)=DEA_"^"_DEAXDT
"RTN","PSOHLEXP",78,0)
 S SITE=0 F  S SITE=$O(DIV(SITE)) Q:'SITE  D
"RTN","PSOHLEXP",79,0)
 .K TEXT
"RTN","PSOHLEXP",80,0)
 .S DEAXDT=$P(DIV(SITE),"^",2)
"RTN","PSOHLEXP",81,0)
 .S TEXT(1)=""
"RTN","PSOHLEXP",82,0)
 .S TEXT(2)="The institutional (facility) DEA Number for"
"RTN","PSOHLEXP",83,0)
 .S TEXT(3)=$$GET1^DIQ(4,SITE,.01,"I")_" (Institution File #4 IEN = "_SITE_")"
"RTN","PSOHLEXP",84,0)
 .S TEXT(4)=$S($$FMDIFF^XLFDT(DEAXDT,DT)<0:"expired on ",1:"is about to expire on ")_$$GET1^DIQ(4,SITE,52.1,"E")
"RTN","PSOHLEXP",85,0)
 .S TEXT(5)=""
"RTN","PSOHLEXP",86,0)
 .S TEXT(6)="Please update the Institutional DEA expiration date using option "
"RTN","PSOHLEXP",87,0)
 .S TEXT(7)="Edit Facility DEA# and Expiration Date [XU EPCS EDIT DEA# AND XDATE]. "
"RTN","PSOHLEXP",88,0)
 .S XMTEXT="TEXT(",XMSUB="Institutional DEA Number "_$S($$FMDIFF^XLFDT(DEAXDT,DT)<0:"has expired",1:"is about to expire"),XMDUZ=.5
"RTN","PSOHLEXP",89,0)
 .S USR="" F  S USR=$O(^XUSEC("PSDMGR",USR)) Q:USR=""  S XMY(USR)=""
"RTN","PSOHLEXP",90,0)
 .D ^XMD
"RTN","PSOHLEXP",91,0)
 Q
"RTN","PSON52")
0^15^B102819042^B98826270
"RTN","PSON52",1,0)
PSON52 ;BIR/DSD - files new entries in prescription file ;08/09/93
"RTN","PSON52",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,16,23,27,32,46,71,111,124,117,131,139,157,143,219,148,239,201,268,260,225,303,358,251,387,379,390,391,313,408,473,504,505**;DEC 1997;Build 39
"RTN","PSON52",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSON52",4,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSON52",5,0)
 ;External reference to ^XUSEC supported by DBIA 10076
"RTN","PSON52",6,0)
 ;External reference SWSTAT^IBBAPI supported by DBIA 4663
"RTN","PSON52",7,0)
 ;External reference SAVNDC^PSSNDCUT supported by DBIA 4707
"RTN","PSON52",8,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSON52",9,0)
EN(PSOX) ;Entry Point
"RTN","PSON52",10,0)
START ;
"RTN","PSON52",11,0)
 D:$D(XRTL) T0^%ZOSV ; Start RT Monitor
"RTN","PSON52",12,0)
 D INIT G:PSON52("QFLG") END D NFILE Q:$G(PSONEW("DFLG"))
"RTN","PSON52",13,0)
 D PS55,DIK
"RTN","PSON52",14,0)
 S:$D(XRT0) XRTN=$T(+0) D:$D(XRT0) T1^%ZOSV ; Stop RT Monitor
"RTN","PSON52",15,0)
 D FINISH
"RTN","PSON52",16,0)
 I $P(^PSRX(PSOX("IRXN"),0),"^",11)="W",$G(^("IB")) S ^PSRX("ACP",$P(^PSRX(PSOX("IRXN"),0),"^",2),$P(^(2),"^",2),0,PSOX("IRXN"))=""
"RTN","PSON52",17,0)
END D EOJ
"RTN","PSON52",18,0)
 Q
"RTN","PSON52",19,0)
INIT ;
"RTN","PSON52",20,0)
 K X,%DT S:$G(PSOID) PSOX("ISSUE DATE")=PSOID
"RTN","PSON52",21,0)
 S PSOX("CS")=0 K PSOX("NOPSDRPH")
"RTN","PSON52",22,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSOX("CS"),"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSOX("CS"),"^",2)=1
"RTN","PSON52",23,0)
 I $P($G(PSOX("CS")),"^"),'$D(^XUSEC("PSDRPH",DUZ)) S PSOX("NOPSDRPH")=1
"RTN","PSON52",24,0)
 S PSON52("QFLG")=0,X1=PSOX("ISSUE DATE"),X2=PSOX("DAYS SUPPLY")*(PSOX("# OF REFILLS")+1)\1
"RTN","PSON52",25,0)
 I $D(CLOZPAT) S X2=$S(X2=14:14,X2=7:7,1:X2) G DT
"RTN","PSON52",26,0)
 S X2=$S(PSOX("DAYS SUPPLY")=X2:X2,+$G(PSOX("CS")):184,+$G(DEA("CS")):184,1:366)
"RTN","PSON52",27,0)
 I X2<30 D
"RTN","PSON52",28,0)
 . N % S %=$P($G(PSORX("PATIENT STATUS")),"^"),X2=30
"RTN","PSON52",29,0)
 . S:%?.N %=$P($G(^PS(53,+%,0)),"^") I %["AUTH ABS" S X2=5
"RTN","PSON52",30,0)
DT D C^%DTC S PSOX("STOP DATE")=$P(X,".") K X
"RTN","PSON52",31,0)
 ;*473 - If Calculated Exp. Date < Fill Date with No refills, reset Exp.
"RTN","PSON52",32,0)
 I '$D(CLOZPAT),'PSOX("# OF REFILLS"),PSOX("FILL DATE")>PSOX("STOP DATE") D
"RTN","PSON52",33,0)
 . N EXP S EXP=$$FMADD^XLFDT(PSOX("FILL DATE"),PSOX("DAYS SUPPLY"))
"RTN","PSON52",34,0)
 . I $$FMDIFF^XLFDT(EXP,PSOX("ISSUE DATE"))>$S(+$G(PSOX("CS")):184,1:366) D
"RTN","PSON52",35,0)
 . . S EXP=$$FMADD^XLFDT(PSOX("ISSUE DATE"),$S(+$G(PSOX("CS")):184,1:366))
"RTN","PSON52",36,0)
 . S PSOX("STOP DATE")=EXP
"RTN","PSON52",37,0)
 ; Titration to Maintenance Rx Conversion - Set Maint. Rx Exp. Date = Original Rx Exp. Date
"RTN","PSON52",38,0)
 I $G(PSOTITRX) D
"RTN","PSON52",39,0)
 . S PSOX("STOP DATE")=$$GET1^DIQ(52,PSOTITRX,26,"I")
"RTN","PSON52",40,0)
 I PSOX("# OF REFILLS")>0 S X1=PSOX("FILL DATE"),X2=$S((PSOX("DAYS SUPPLY")-10\1)<1:1,1:PSOX("DAYS SUPPLY")-10\1) D C^%DTC S PSOX("NEXT POSSIBLE REFILL")=$P(X,".") K X
"RTN","PSON52",41,0)
 S PSOX("TYPE OF RX")=0,PSOX("DISPENSED DATE")=PSOX("FILL DATE") D NOW^%DTC S PSOX("LOGIN DATE")=$S($P($G(OR0),"^",12):$P($G(OR0),"^",12),1:%) K %,X
"RTN","PSON52",42,0)
 S PSOX("STATUS")=$S($G(PSOX("STATUS"))]"":PSOX("STATUS"),$D(PSORX("VERIFY")):1,$D(PSOX("NOPSDRPH")):1,1:0)
"RTN","PSON52",43,0)
 S PSOX("COPIES")=$S($G(PSOX("COPIES"))]"":PSOX("COPIES"),1:1)
"RTN","PSON52",44,0)
 I $G(PSORX("PHARM"))]"" S PSOX("PHARMACIST")=PSORX("PHARM") K PSORX("PHARM")
"RTN","PSON52",45,0)
INITX Q
"RTN","PSON52",46,0)
 ;
"RTN","PSON52",47,0)
NFILE I $G(OR0) D  Q:$G(PSONEW("DFLG"))
"RTN","PSON52",48,0)
 .D NOOR^PSONEW Q:$G(PSONEW("DFLG"))
"RTN","PSON52",49,0)
 .I $G(PSOSIGFL)!($G(PSODRUG("OI"))'=$P(OR0,"^",8)) S PSONEW("CLERK CODE")=DUZ,PSONEW("REMARKS")=$G(PSONEW("REMARKS"))_" CPRS Order #"_$P(OR0,"^")_" Edited."
"RTN","PSON52",50,0)
 S DIC="^PSRX(",DLAYGO=52,DIC(0)="L",X=PSOX("RX #") K DD,DO D FILE^DICN S PSOX("IRXN")=+Y K DLAYGO,X,Y,DIC,DD,DO
"RTN","PSON52",51,0)
 I '$D(^XUSEC("PSORPH",DUZ))!($D(PSOX("NOPSDRPH"))),$$DS^PSSDSAPI&(+$G(^TMP("PSODOSF",$J,0))) S PSON52(PSOX("IRXN"),"STA")=1,PSOX("STATUS")=1
"RTN","PSON52",52,0)
 F PSOX1=0:1 S PSON52=$P($T(DD+PSOX1),";;",2,4) Q:PSON52=""  K PSOY S PSOY=$P(PSON52,";;") I $G(@PSOY)]"" S $P(PSON52(PSOX("IRXN"),$P(PSON52,";;",2)),"^",$P(PSON52,";;",3))=@PSOY
"RTN","PSON52",53,0)
 F I=1:1:PSOX("ENT") S ^PSRX(PSOX("IRXN"),6,I,0)=PSOX("DOSE",I)_"^"_$G(PSOX("DOSE ORDERED",I))_"^"_$G(PSOX("UNITS",I))_"^"_$G(PSOX("NOUN",I))_"^" D
"RTN","PSON52",54,0)
 .S ^PSRX(PSOX("IRXN"),6,I,0)=^PSRX(PSOX("IRXN"),6,I,0)_$G(PSOX("DURATION",I))_"^"_$G(PSOX("CONJUNCTION",I))_"^"_$G(PSOX("ROUTE",I))_"^"_$G(PSOX("SCHEDULE",I))_"^"_$G(PSOX("VERB",I))
"RTN","PSON52",55,0)
 .I $G(PSOX("ODOSE",I))]"" S ^PSRX(PSOX("IRXN"),6,I,1)=PSOX("ODOSE",I)
"RTN","PSON52",56,0)
 S ^PSRX(PSOX("IRXN"),6,0)="^52.0113^"_PSOX("ENT")_"^"_PSOX("ENT")
"RTN","PSON52",57,0)
 K PSOX1,PSOY
"RTN","PSON52",58,0)
 S PSOX1="" F  S PSOX1=$O(PSON52(PSOX("IRXN"),PSOX1)) Q:PSOX1=""  S ^PSRX(PSOX("IRXN"),PSOX1)=$G(PSON52(PSOX("IRXN"),PSOX1))
"RTN","PSON52",59,0)
 ; PSO*7*505 - quantity check - leading zeros
"RTN","PSON52",60,0)
 N QTYTMP
"RTN","PSON52",61,0)
 S QTYTMP=$P(^PSRX(PSOX("IRXN"),0),U,7)
"RTN","PSON52",62,0)
 I QTYTMP["." D
"RTN","PSON52",63,0)
 .Q:$P(QTYTMP,".")=0
"RTN","PSON52",64,0)
 .S $P(^PSRX(PSOX("IRXN"),0),U,7)=0_QTYTMP
"RTN","PSON52",65,0)
 ; PSO*7*505 - end quantity check - leading zero's
"RTN","PSON52",66,0)
 I $O(PSOX("SIG",0)) D
"RTN","PSON52",67,0)
 .S D=0 F  S D=$O(PSOX("SIG",D)) Q:'D  S ^PSRX(PSOX("IRXN"),"INS1",D,0)=PSOX("SIG",D),TP=$G(TP)+1
"RTN","PSON52",68,0)
 .S ^PSRX(PSOX("IRXN"),"INS1",0)="^52.0115^"_TP_"^"_TP_"^"_DT_"^^" K TP,D
"RTN","PSON52",69,0)
 I $G(PSOX("SINS"))]"" S ^PSRX(PSOX("IRXN"),"INSS")=PSOX("SINS")
"RTN","PSON52",70,0)
 I $G(SIGOK) D
"RTN","PSON52",71,0)
 .S $P(^PSRX(PSOX("IRXN"),"SIG"),"^",2)=1,^PSRX(PSOX("IRXN"),"SIG1",0)="^52.04A^^"
"RTN","PSON52",72,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSOX("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSOX("IRXN"),"SIG1",0),"^",3)=+$P(^PSRX(PSOX("IRXN"),"SIG1",0),"^",3)+1,$P(^(0),"^",4)=+$P(^(0),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSON52",73,0)
 .K SIG
"RTN","PSON52",74,0)
 I $D(PSOINSFL) S ^PSRX(PSOX("IRXN"),"A",0)="^52.3DA^1^1",^PSRX(PSOX("IRXN"),"A",1,0)=DT_"^G^^0^Patient Instructions "_$S(PSOINSFL=1:"",1:"Not ")_"Sent By Provider."
"RTN","PSON52",75,0)
 I $G(OR0),$P(OR0,"^",24) S ^PSRX(PSOX("IRXN"),"PKI")=$S($G(PSOSIGFL):"^1",1:1) D ACLOG
"RTN","PSON52",76,0)
 I $P($G(PSOX("CS")),"^"),'+$P($G(^PSRX(PSOX("IRXN"),"PKI")),"^") S $P(^PSRX(PSOX("IRXN"),"PKI"),"^",2)=1
"RTN","PSON52",77,0)
 K PSOX1,PSOFINFL,HLDSIG,D,PSOINSFL,D
"RTN","PSON52",78,0)
 D:$G(^TMP("PSODAI",$J,0))
"RTN","PSON52",79,0)
 .S $P(^PSRX(PSOX("IRXN"),3),"^",6)=1
"RTN","PSON52",80,0)
 .I $O(^TMP("PSODAI",$J,0)) S DAI=0 F  S DAI=$O(^TMP("PSODAI",$J,DAI)) Q:'DAI  D
"RTN","PSON52",81,0)
 ..S:'$D(^PSRX(PSOX("IRXN"),"DAI",0)) ^PSRX(PSOX("IRXN"),"DAI",0)="^52.03^^" S ^PSRX(PSOX("IRXN"),"DAI",DAI,0)=^TMP("PSODAI",$J,DAI,0)
"RTN","PSON52",82,0)
 ..S $P(^PSRX(PSOX("IRXN"),"DAI",0),"^",3)=+$P(^PSRX(PSOX("IRXN"),"DAI",0),"^",3)+1,$P(^(0),"^",4)=+$P(^(0),"^",4)+1
"RTN","PSON52",83,0)
 .K ^TMP("PSODAI",$J),DAI
"RTN","PSON52",84,0)
 I $G(PSOX("CHCS NUMBER"))'="" S $P(^PSRX(PSOX("IRXN"),"EXT"),"^")=$G(PSOX("CHCS NUMBER"))
"RTN","PSON52",85,0)
 I $G(PSOX("EXTERNAL SYSTEM"))'="" S $P(^PSRX(PSOX("IRXN"),"EXT"),"^",2)=$G(PSOX("EXTERNAL SYSTEM"))
"RTN","PSON52",86,0)
 I $G(PSOX("NEWCOPAY")) S ^PSRX(PSOX("IRXN"),"IB")=$G(PSOX("NEWCOPAY"))
"RTN","PSON52",87,0)
 ;Next line, set SC question based on Copay status?
"RTN","PSON52",88,0)
IBQ ;I $G(PSOBILL)=2 S ^PSRX(PSOX("IRXN"),"IBQ")=$S($G(PSOX("NEWCOPAY")):0,1:1)
"RTN","PSON52",89,0)
 N PSOSCFLD S PSOSCFLD=$S(PSOSCP'="":$G(PSOANSQ("SC")),1:"")_"^"_$G(PSOANSQ("MST"))_"^"_$G(PSOANSQ("VEH"))_"^"_$G(PSOANSQ("RAD"))_"^"_$G(PSOANSQ("PGW"))_"^"_$G(PSOANSQ("HNC"))_"^"_$G(PSOANSQ("CV"))_"^"_$G(PSOANSQ("SHAD"))
"RTN","PSON52",90,0)
 I PSOSCP<50&($TR(PSOSCFLD,"^")'="")&($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)'=1) D
"RTN","PSON52",91,0)
 . S ^PSRX(PSOX("IRXN"),"IBQ")=PSOSCFLD K PSOSCFLD  ;don't set if SC % is null or 0, just set it in ICD node
"RTN","PSON52",92,0)
 D ICD^PSODIAG
"RTN","PSON52",93,0)
 D:$$SWSTAT^IBBAPI() GACT^PSOPFSU0(PSOX("IRXN"),0)
"RTN","PSON52",94,0)
 D:$G(PSOTITRX) SAVETIT(PSOTITRX,PSOX("IRXN"))
"RTN","PSON52",95,0)
 K PSOTITRX,PSOANSQ,PSOANSQD,PSOX("NEWCOPAY")
"RTN","PSON52",96,0)
 L -^PSRX("B",PSOX("IRXN"))
"RTN","PSON52",97,0)
 Q
"RTN","PSON52",98,0)
 ;
"RTN","PSON52",99,0)
ACLOG ;activity log (digitally signed CS orders)
"RTN","PSON52",100,0)
 N DTTM,CNT,OCNT,XX
"RTN","PSON52",101,0)
 D NOW^%DTC S DTTM=%
"RTN","PSON52",102,0)
 S CNT=0 F XX=0:0 S XX=$O(^PSRX(PSOX("IRXN"),"A",XX)) Q:'XX  S CNT=XX
"RTN","PSON52",103,0)
 S OCNT=CNT
"RTN","PSON52",104,0)
 I $G(PSOCSP("NAME"))'=PSODRUG("NAME") S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^NAME: "_PSOCSP("NAME")
"RTN","PSON52",105,0)
 S XX=0 F  S XX=$O(PSOCSP("DOSE",XX)) Q:'XX  I PSOCSP("DOSE",XX)'=$G(PSONEW("DOSE",XX)) D
"RTN","PSON52",106,0)
 .S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^DOSAGE: "_PSOCSP("DOSE",XX)
"RTN","PSON52",107,0)
 S XX=0 F  S XX=$O(PSOCSP("DOSE ORDERED",XX)) Q:'XX  I PSOCSP("DOSE ORDERED",XX)'=$G(PSONEW("DOSE ORDERED",XX)) D
"RTN","PSON52",108,0)
 .S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^DISPENSE UNITS: "_PSOCSP("DOSE ORDERED",XX)
"RTN","PSON52",109,0)
 I PSOCSP("ISSUE DATE")'=PSONEW("ISSUE DATE") S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^ISSUE DATE: "_$$FMTE^XLFDT(PSOCSP("ISSUE DATE"))
"RTN","PSON52",110,0)
 I PSOCSP("DAYS SUPPLY")'=PSONEW("DAYS SUPPLY") S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^DAYS SUPPLY: "_PSOCSP("DAYS SUPPLY")
"RTN","PSON52",111,0)
 I PSOCSP("QTY")'=PSONEW("QTY") S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^QTY: "_PSOCSP("QTY")
"RTN","PSON52",112,0)
 I PSOCSP("# OF REFILLS")'=PSONEW("# OF REFILLS") S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^# OF REFILLS: "_PSOCSP("# OF REFILLS")
"RTN","PSON52",113,0)
 I '$$SUBSCRIB^ORDEA($P(OR0,"^"),PSOX("IRXN")) S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^ORDER DEA ARCHIVE INFO file entry failure"
"RTN","PSON52",114,0)
 I OCNT'=CNT S ^PSRX(PSOX("IRXN"),"A",0)="^52.3DA^"_CNT_"^"_CNT
"RTN","PSON52",115,0)
 Q
"RTN","PSON52",116,0)
 ;
"RTN","PSON52",117,0)
PS55 ;
"RTN","PSON52",118,0)
 L +^PS(55,PSODFN,"P"):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSON52",119,0)
 S:'$D(^PS(55,PSODFN,"P",0)) ^(0)="^55.03PA^^"
"RTN","PSON52",120,0)
 F PSOX1=$P(^PS(55,PSODFN,"P",0),"^",3):1 Q:'$D(^PS(55,PSODFN,"P",PSOX1))
"RTN","PSON52",121,0)
 S PSOX("55 IEN")=PSOX1
"RTN","PSON52",122,0)
 S ^PS(55,PSODFN,"P",PSOX1,0)=PSOX("IRXN"),$P(^PS(55,PSODFN,"P",0),"^",3,4)=PSOX1_"^"_($P(^PS(55,PSODFN,"P",0),"^",4)+1)
"RTN","PSON52",123,0)
 S ^PS(55,PSODFN,"P","A",PSONEW("STOP DATE"),PSOX("IRXN"))=""
"RTN","PSON52",124,0)
PS55X L -^PS(55,PSODFN,"P")
"RTN","PSON52",125,0)
 K PSOX1
"RTN","PSON52",126,0)
 Q
"RTN","PSON52",127,0)
DIK ;
"RTN","PSON52",128,0)
 I $D(^XUSEC("PSORPH",DUZ)) S DA=PSOX("IRXN"),DIE=52,DR="41////"_PSOCOU_";S:'X Y=""@1"";42////"_PSOCOUU_";@1" D ^DIE K DIE,DR
"RTN","PSON52",129,0)
 K DIK,DA S DIK="^PSRX(",DA=PSOX("IRXN") D IX1^DIK K DIK
"RTN","PSON52",130,0)
 S DA=PSOX("IRXN") D ORC^PSORN52C
"RTN","PSON52",131,0)
 Q
"RTN","PSON52",132,0)
FINISH ;
"RTN","PSON52",133,0)
ANQ I $G(ANQDATA)]"" D NOW^%DTC G:$D(^PS(52.52,"B",%)) ANQ D
"RTN","PSON52",134,0)
 .K DD,DO S DIC="^PS(52.52,",DIC(0)="L",DLAYGO=52.52,X=% D FILE^DICN K DIC,DLAYGO,DD,DO
"RTN","PSON52",135,0)
 .S ^PS(52.52,+Y,0)=$P(Y,"^",2)_"^"_PSOX("IRXN")_"^"_ANQDATA,^PS(52.52,"A",PSOX("IRXN"),+Y)="" K ANQDATA,X,Y,%,ANQREM
"RTN","PSON52",136,0)
 ;
"RTN","PSON52",137,0)
 N PSOTFIN
"RTN","PSON52",138,0)
 I $D(PSOX("NOPSDRPH"))!('$D(^XUSEC("PSORPH",DUZ))) S PSOTFIN="",PSOTFIN=$$TECH2^PSODGDGP(PSOX("IRXN"),PSODFN,DUZ,.PSOX)
"RTN","PSON52",139,0)
 I $D(PSOX("NOPSDRPH"))!('$D(^XUSEC("PSORPH",DUZ))) G FINISHP:$G(PSOTFIN)=1 G FINISHX:$G(PSOTFIN)=2
"RTN","PSON52",140,0)
 ;
"RTN","PSON52",141,0)
 I PSOX("FILL DATE")>DT,$P(PSOPAR,"^",6) S DA=PSOX("IRXN"),RXFL(PSOX("IRXN"))=0 D SUS^PSORXL K DA G FINISHX
"RTN","PSON52",142,0)
 ;
"RTN","PSON52",143,0)
 ; - Calling ECME for claims generation and transmission / REJECT handling
"RTN","PSON52",144,0)
 N ACTION,PSOERX
"RTN","PSON52",145,0)
 S PSOERX=PSOX("IRXN")
"RTN","PSON52",146,0)
 I $$SUBMIT^PSOBPSUT(PSOERX,0) D  I ACTION="Q"!(ACTION="^") Q
"RTN","PSON52",147,0)
 . S ACTION="" D ECMESND^PSOBPSU1(PSOERX,0,"","OF")
"RTN","PSON52",148,0)
 . ; Quit if there is an unresolved Tricare/CHAMPVA non-billable reject code, PSO*7*358
"RTN","PSON52",149,0)
 . I $$PSOET^PSOREJP3(PSOERX,0) S ACTION="Q" Q
"RTN","PSON52",150,0)
 . I $$FIND^PSOREJUT(PSOERX,0) D
"RTN","PSON52",151,0)
 . . S ACTION=$$HDLG^PSOREJU1(PSOERX,0,"79,88","OF","IOQ","Q")
"RTN","PSON52",152,0)
 . I $$STATUS^PSOBPSUT(PSOERX,0)="E PAYABLE" D
"RTN","PSON52",153,0)
 . . D SAVNDC^PSSNDCUT(+$$GET1^DIQ(52,PSOERX,6,"I"),$G(PSOSITE),$$GETNDC^PSONDCUT(PSOERX,0))
"RTN","PSON52",154,0)
 ;
"RTN","PSON52",155,0)
FINISHP ;
"RTN","PSON52",156,0)
 I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=PSOX("IRXN")_",",RXFL(PSOX("IRXN"))=0 G FINISHX
"RTN","PSON52",157,0)
 F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSON52",158,0)
 I $L(PSORX("PSOL",PSOX2))+$L(PSOX("IRXN"))<220 S PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_PSOX("IRXN")_","
"RTN","PSON52",159,0)
 E  S PSORX("PSOL",PSOX2+1)=PSOX("IRXN")_","
"RTN","PSON52",160,0)
 S RXFL(PSOX("IRXN"))=0
"RTN","PSON52",161,0)
FINISHX ;call to build Rx array for bingo board
"RTN","PSON52",162,0)
 I $G(PSORX("MAIL/WINDOW"))["W" S BINGCRT=1,BINGRTE="W",BBFLG=1 D BBRX^PSORN52C
"RTN","PSON52",163,0)
 K PSOX1,PSOX2
"RTN","PSON52",164,0)
 K ^TMP("PSODGI",$J),^TMP("PSOSER",$J),^TMP("PSOSERS",$J),^TMP("PSODGS",$J),^TMP("PSOTDD",$J),^TMP("PSODOSF",$J)
"RTN","PSON52",165,0)
 Q
"RTN","PSON52",166,0)
 ;
"RTN","PSON52",167,0)
SAVETIT(TITRX,MNTRX) ; Save Titration/Maintenance dose Rx information
"RTN","PSON52",168,0)
 I '$D(^PSRX(+$G(TITRX),0))!'$D(^PSRX(+$G(MNTRX),0)) Q
"RTN","PSON52",169,0)
 S $P(^PSRX(TITRX,"TIT"),"^",2,3)=MNTRX_"^1"
"RTN","PSON52",170,0)
 D RXACT^PSOBPSU2(TITRX,0,"Maintenance Rx#: "_$$GET1^DIQ(52,MNTRX,.01),"E")
"RTN","PSON52",171,0)
 S $P(^PSRX(MNTRX,"TIT"),"^",1)=TITRX
"RTN","PSON52",172,0)
 D RXACT^PSOBPSU2(MNTRX,0,"Titration Rx#: "_$$GET1^DIQ(52,TITRX,.01),"E")
"RTN","PSON52",173,0)
 Q
"RTN","PSON52",174,0)
 ;
"RTN","PSON52",175,0)
EOJ ;
"RTN","PSON52",176,0)
 ;B xref locked in routine PSONRXN
"RTN","PSON52",177,0)
 L -^PSRX("B",PSOX("IRXN")) K OTHDOS,DA,PSON52,PSOPRC,RTE,SCH,PSOX("INS"),PSONEW("INS"),PSORXED("INS"),PSONEW("ENT"),PSORXED("ENT"),OLENT
"RTN","PSON52",178,0)
 D PSOUL^PSSLOCK(PSOX("IRXN"))
"RTN","PSON52",179,0)
 Q
"RTN","PSON52",180,0)
 ;
"RTN","PSON52",181,0)
 ;;PSOX("SIG");;SIG;;1
"RTN","PSON52",182,0)
DD ;;PSOX("RX #");;0;;1
"RTN","PSON52",183,0)
 ;;PSOX("ISSUE DATE");;0;;13
"RTN","PSON52",184,0)
 ;;PSODFN;;0;;2
"RTN","PSON52",185,0)
 ;;PSOX("PATIENT STATUS");;0;;3
"RTN","PSON52",186,0)
 ;;PSOX("PROVIDER");;0;;4
"RTN","PSON52",187,0)
 ;;PSOX("CLINIC");;0;;5
"RTN","PSON52",188,0)
 ;;PSODRUG("IEN");;0;;6
"RTN","PSON52",189,0)
 ;;PSODRUG("TRADE NAME");;TN;;1
"RTN","PSON52",190,0)
 ;;PSOX("QTY");;0;;7
"RTN","PSON52",191,0)
 ;;PSOX("DAYS SUPPLY");;0;;8
"RTN","PSON52",192,0)
 ;;PSOX("# OF REFILLS");;0;;9
"RTN","PSON52",193,0)
 ;;PSOX("COPIES");;0;;18
"RTN","PSON52",194,0)
 ;;PSOX("MAIL/WINDOW");;0;;11
"RTN","PSON52",195,0)
 ;;PSOX("REMARKS");;3;;7
"RTN","PSON52",196,0)
 ;;PSOX("ADMINCLINIC");;0;;15 
"RTN","PSON52",197,0)
 ;;PSOX("CLERK CODE");;0;;16
"RTN","PSON52",198,0)
 ;;PSODRUG("COST");;0;;17
"RTN","PSON52",199,0)
 ;;PSOSITE;;2;;9
"RTN","PSON52",200,0)
 ;;PSOX("LOGIN DATE");;2;;1
"RTN","PSON52",201,0)
 ;;PSOX("FILL DATE");;2;;2
"RTN","PSON52",202,0)
 ;;PSOX("PHARMACIST");;2;;3
"RTN","PSON52",203,0)
 ;;PSOX("LOT #");;2;;4
"RTN","PSON52",204,0)
 ;;PSOX("DISPENSED DATE");;2;;5
"RTN","PSON52",205,0)
 ;;PSOX("STOP DATE");;2;;6
"RTN","PSON52",206,0)
 ;;PSODRUG("NDC");;2;;7
"RTN","PSON52",207,0)
 ;;PSODRUG("DAW");;EPH;;1
"RTN","PSON52",208,0)
 ;;PSODRUG("MANUFACTURER");;2;;8
"RTN","PSON52",209,0)
 ;;PSOX("EXPIRATION DATE");;2;;11
"RTN","PSON52",210,0)
 ;;PSOX("GENERIC PROVIDER");;2;;12
"RTN","PSON52",211,0)
 ;;PSOX("RELEASED DATE/TIME");;2;;13
"RTN","PSON52",212,0)
 ;;PSOX("METHOD OF PICK-UP");;MP;;1
"RTN","PSON52",213,0)
 ;;PSOX("STATUS");;STA;;1
"RTN","PSON52",214,0)
 ;;PSOX("LAST DISPENSED DATE");;3;;1
"RTN","PSON52",215,0)
 ;;PSOX("NEXT POSSIBLE REFILL");;3;;2
"RTN","PSON52",216,0)
 ;;PSOX("COSIGNING PROVIDER");;3;;3
"RTN","PSON52",217,0)
 ;;PSOX("TYPE OF RX");;TYPE;;1
"RTN","PSON52",218,0)
 ;;PSOX("SAND");;SAND;;1
"RTN","PSON52",219,0)
 ;;PSOX("POE");;POE;;1
"RTN","PSON52",220,0)
 ;;PSOX("INS");;INS;;1
"RTN","PSOOREDT")
0^2^B91171061^B82334396
"RTN","PSOOREDT",1,0)
PSOOREDT ;BIR/SAB - Edit orders from backdoor ;5/8/08 3:27pm
"RTN","PSOOREDT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**4,20,27,37,57,46,78,102,104,119,143,148,260,281,304,289,298,379,377,391,313,427,411,505**;DEC 1997;Build 39
"RTN","PSOOREDT",3,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSOOREDT",4,0)
 ;External reference to L^PSSLOCK supported by DBIA 2789
"RTN","PSOOREDT",5,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSOOREDT",6,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789
"RTN","PSOOREDT",7,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOOREDT",8,0)
 ;External reference to ^VA(200 supported by DBIA 10060
"RTN","PSOOREDT",9,0)
SEL K PSOISLKD,PSOLOKED S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY D SVAL K PSOPLCK S VALMBCK="" Q
"RTN","PSOOREDT",10,0)
 K PSOPLCK D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) D UL^PSSLOCK(+$G(PSODFN)) D SVALO K PSOMSG S VALMBCK="" Q
"RTN","PSOOREDT",11,0)
 K PSOMSG S PSOLOKED=1
"RTN","PSOOREDT",12,0)
 S REF=0 S:$$LSTRFL^PSOBPSU1($P(PSOLST(ORN),"^",2)) REF=1  ;*377
"RTN","PSOOREDT",13,0)
 K PSORX("DFLG"),DIR,DUOUT,DIRUT S DIR("A")="Select fields by number"
"RTN","PSOOREDT",14,0)
 S DIR(0)="LO^1:"_$S($$STATUS^PSOBPSUT($P(PSOLST(ORN),"^",2))'="":21,$G(REF):20,1:19)
"RTN","PSOOREDT",15,0)
 D ^DIR I $D(DIRUT) K DIR,DIRUT,DTOUT S VALMBCK="" D UL K PSOLOKED Q
"RTN","PSOOREDT",16,0)
EDTSEL N VALMCNT K PSOISLKD,PSORX("DFLG"),PSOOIFLG,PSOMRFLG,DIR,DIRUT,DTOUT,DTOUT,ZONE S PSOQUIT=0,(PSOEDIT,PSORXED)=1 I +Y S FST=Y D HLDHDR^PSOLMUTL D  G EX ;PSO LM SELECT MENU protocol
"RTN","PSOOREDT",17,0)
 .I '$G(PSOLOKED) S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY D SVAL K PSOPLCK S VALMBCK="",(PSOISLKD,PSODE)=1 Q
"RTN","PSOOREDT",18,0)
 .I '$G(PSOLOKED) K PSOPLCK D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) D UL^PSSLOCK(+$G(PSODFN)) D SVALO K PSOMSG S VALMBCK="",(PSOISLKD,PSODE)=1 Q
"RTN","PSOOREDT",19,0)
 .K PSOMSG,PSOPLCK S (NEWEDT,PSOLOKED)=1 D EDT
"RTN","PSOOREDT",20,0)
 E  S VALMBCK="",PSODE=1
"RTN","PSOOREDT",21,0)
EX I $G(PSOISLKD)!($G(PSOQUIT)) D UL K PSOISLKD G EX2
"RTN","PSOOREDT",22,0)
 I '$G(PSOSIGFL),'$G(PSORXED("DFLG")) D UPDATE^PSOORED6 D LOG^PSORXED,POST^PSORXED G EX1
"RTN","PSOOREDT",23,0)
 I $G(PSOSIGFL)=1 D  Q:$G(PSORX("FN"))
"RTN","PSOOREDT",24,0)
 .N PSOTMP
"RTN","PSOOREDT",25,0)
 .S PSOTMP=$G(PSOFROM),PSOFROM="NEW"
"RTN","PSOOREDT",26,0)
 .S VALMSG="This change will create a new prescription!",NCPDPFLG=1
"RTN","PSOOREDT",27,0)
 .D EN^PSOORED1(.PSORXED)
"RTN","PSOOREDT",28,0)
 .I $G(PSORX("FN")) D  Q
"RTN","PSOOREDT",29,0)
 ..D ^PSOBUILD
"RTN","PSOOREDT",30,0)
 ..K QUIT,PSORX("DFLG"),FST,FLD,IEN,FLN,INCOM,PSOI,PSODRUG,PSOEDIT
"RTN","PSOOREDT",31,0)
 ..K PSORENW,PSOSIGFL,PSOOIFLG,PSOMRFLG,PSODIR,CHK,PSORX("SIG"),PSODE
"RTN","PSOOREDT",32,0)
 ..K PSOTRN,PSORX("EDIT"),PSORXED("FLD"),NEWEDT
"RTN","PSOOREDT",33,0)
 ..S ZZEDIT=1 D EOJ^PSONEW K ZZEDIT
"RTN","PSOOREDT",34,0)
 ..D UL K PSOLOKED S VALMBCK="Q"
"RTN","PSOOREDT",35,0)
 .S PSOFROM=PSOTMP I PSOFROM="" K PSOFROM
"RTN","PSOOREDT",36,0)
 ;
"RTN","PSOOREDT",37,0)
EX1 I '$G(PSODE)!('$G(ZONE)) I $G(PSORENW("OIRXN")) D EN^PSOHLSN1(PSORENW("OIRXN"),"XX","","Order edited")
"RTN","PSOOREDT",38,0)
QUIT D UL K PSOLOKED D ^PSOBUILD,ACT^PSOORNE2 D:+^PSRX($P(PSOLST(ORN),"^",2),"STA")=5 EN^PSOCMOPC($P(PSOLST(ORN),"^",2))
"RTN","PSOOREDT",39,0)
 K:'$O(^PSRX($P(PSOLST(ORN),"^",2),1,0)) REF
"RTN","PSOOREDT",40,0)
EX2 S VALMBCK=$S($G(PSOQUIT):"R",$G(PSORX("FN")):"Q",$G(ZONE):"Q",1:"R")
"RTN","PSOOREDT",41,0)
 K PSORXED,FST,FLD,IEN,FLN,INCOM,PSOI,PSODRUG,PSOEDIT,PSORENW,PSOSIGFL,PSODIR,CHK,PSORX("SIG"),PSODE,PSOTRN,PSORX("DFLG"),RFED,ZONE,PSORX("EDIT"),PSOOIFLG,PSOMRFLG,SIG,QUIT,PSOQUIT
"RTN","PSOOREDT",42,0)
 K NEWEDT I $G(VALMBCK)="R" W ! D CLEAN^PSOVER1 H 2
"RTN","PSOOREDT",43,0)
 Q
"RTN","PSOOREDT",44,0)
 ;
"RTN","PSOOREDT",45,0)
EDT ; Rx Edit (Backdoor) 
"RTN","PSOOREDT",46,0)
 ;/BLB/ Patch PSO*7*505 Modified EDT to block the editing functionality of certain fields of CS drugs
"RTN","PSOOREDT",47,0)
 N FLNCHK,CSDRG,DRGIEN
"RTN","PSOOREDT",48,0)
 K NCPDPFLG,PSOPKI,DEA
"RTN","PSOOREDT",49,0)
 S I=0 F  S I=$O(^PSRX($P(PSOLST(ORN),"^",2),1,I)) Q:'I  S PSORXED("RX1")=^PSRX($P(PSOLST(ORN),"^",2),1,I,0)
"RTN","PSOOREDT",50,0)
 ;*298 Track PI and Oth Lang PI
"RTN","PSOOREDT",51,0)
 S (RX0,PSORXED("RX0"))=^PSRX($P(PSOLST(ORN),"^",2),0),PSORXED("RX2")=$G(^(2)),PSORXED("RX3")=$G(^(3)),PSOSIG=$P(^("SIG"),"^"),PSOPINS=$G(^("INS")),PSOOINS=$G(^("INSS"))
"RTN","PSOOREDT",52,0)
 I '$D(PSODRUG) NEW PSOY S PSOY=$P(RX0,U,6),PSOY(0)=^PSDRUG(PSOY,0) D SET^PSODRG ; *298 moved this line from EDT+2  RX0 was not defined yet
"RTN","PSOOREDT",53,0)
 S CSDRG=0 I $$NDF^PSOORNEW(PSODRUG("IEN"))!$$CSDRG^PSOORNEW(PSODRUG("IEN")) S CSDRG=1
"RTN","PSOOREDT",54,0)
 I CSDRG,$$CSFLDBLK(FST) D
"RTN","PSOOREDT",55,0)
 .W !!,"The selection includes field(s) that are not editable" W !,"for controlled substances. These field(s) will be skipped.",!
"RTN","PSOOREDT",56,0)
 .S DIR(0)="E" D ^DIR K DIR
"RTN","PSOOREDT",57,0)
 F FLD=1:1:$L(FST,",") Q:$P(FST,",",FLD)']""!($G(PSORXED("DFLG")))!($G(PSORX("DFLG")))  S FLN=+$P(FST,",",FLD) S DRGIEN=PSODRUG("IEN") D
"RTN","PSOOREDT",58,0)
 .S FLNCHK=","_FLN_","
"RTN","PSOOREDT",59,0)
 .S PSORXED("DFLG")=0,(DA,PSORXED("IRXN"),PSORENW("OIRXN"))=$P(PSOLST(ORN),"^",2),RX0=^PSRX(PSORXED("IRXN"),0),PSOPKI=$P($G(^PSRX(PSORXED("IRXN"),"PKI")),"^") S:$G(PSOSIG)="" PSOSIG=$P(^("SIG"),"^")
"RTN","PSOOREDT",60,0)
 .;*298 Track PI and Oth Lang PI
"RTN","PSOOREDT",61,0)
 .S:$G(PSOPINS)="" PSOPINS=$G(^PSRX(DA,"INS")) S:$G(PSOOINS)="" PSOOINS=$G(^PSRX(DA,"INSS"))
"RTN","PSOOREDT",62,0)
 .I '$G(PSOSIGFL) D
"RTN","PSOOREDT",63,0)
 ..S PSOI=+^PSRX(DA,"OR1"),PSODAYS=$P(RX0,"^",8),PSORXST=+$P($G(^PS(53,$P(RX0,"^",3),0)),"^",7)
"RTN","PSOOREDT",64,0)
 ..I 'PSOI S PSOI=+^PSDRUG($P(RX0,"^",6),2),$P(^PSRX(DA,"OR1"),"^")=PSOI
"RTN","PSOOREDT",65,0)
 ..S:'$G(PSODRUG("IEN")) PSODRUG("IEN")=$P(RX0,"^",6),PSODRUG("NAME")=$P(^PSDRUG($P(RX0,"^",6),0),"^")
"RTN","PSOOREDT",66,0)
 ..S PSODRUG("OI")=PSOI
"RTN","PSOOREDT",67,0)
 .S PSORX("PROVIDER")=$P(RX0,"^",4),PSORX("PROVIDER NAME")=$P(^VA(200,$P(RX0,"^",4),0),"^"),PSOTRN=$G(^PSRX(DA,"TN"))
"RTN","PSOOREDT",68,0)
 .D:'$G(CHK) POP^PSOSIGNO(DA),CHK Q:$G(PSORXED("DFLG"))
"RTN","PSOOREDT",69,0)
 .S FDR="39.2^"_$S($P(PSOPAR,"^",3):"6",1:"")_";6.5^113^114^3^1^22R^24^8^7^9^4^11;"_$S($P(RX0,"^",11)="W"&($P(PSOPAR,"^",12)):"35;",1:"")_"^10.6^5^20^23^12^PSOCOU^RF^81"
"RTN","PSOOREDT",70,0)
 .; Titration/Maintenance Rx check
"RTN","PSOOREDT",71,0)
 .I $$REQFLDS(FST),$$TITRX^PSOUTL($P(PSOLST(ORN),"^",2))="t" D  S PSORXED("DFLG")=1 Q
"RTN","PSOOREDT",72,0)
 .. S VALMSG="Cannot edit Drug/Dose fields (Titration Rx).",VALMBCK="R" W $C(7)
"RTN","PSOOREDT",73,0)
 .D:'$G(CHK) POP^PSOSIGNO(DA),CHK Q:$G(PSORXED("DFLG"))
"RTN","PSOOREDT",74,0)
 .S FDR="39.2^"_$S($P(PSOPAR,"^",3):"6",1:"")_";6.5^113^114^3^1^22R^24^8^7^9^4^11;"_$S($P(RX0,"^",11)="W"&($P(PSOPAR,"^",12)):"35;",1:"")_"^10.6^5^20^23^12^PSOCOU^RF^81"
"RTN","PSOOREDT",75,0)
 .I $G(ST)=11!($G(ST)=12)!($G(ST)=14)!($G(ST)=15) D NDCDAWDE^PSOORED7(ST,FLN,$G(RXN)) Q
"RTN","PSOOREDT",76,0)
 .S REF=0 S:$$LSTRFL^PSOBPSU1($P(PSOLST(ORN),"^",2)) REF=1  ;*377
"RTN","PSOOREDT",77,0)
 .I FLN=20,'$G(REF) S VALMSG="There is no Refill Data to be edited." Q
"RTN","PSOOREDT",78,0)
 .S DR=$P(FDR,"^",FLN) I DR="RF" D REF^PSOORED2 Q
"RTN","PSOOREDT",79,0)
 .I DR="PSOCOU" D PSOCOU^PSOORED6 Q
"RTN","PSOOREDT",80,0)
 .I $$CSDRG^PSOORNEW(DRGIEN)!($$NDF^PSOORNEW(DRGIEN)),",1,3,11,12,17,"[FLNCHK Q
"RTN","PSOOREDT",81,0)
 .; Allow edit of the NDC when the EDIT DRUG setting is off
"RTN","PSOOREDT",82,0)
 .; Other checks regarding if the NDC may be edited are found in NDC^PSODRG - PSO*7*427
"RTN","PSOOREDT",83,0)
 .I FLN=2,'$P(PSOPAR,"^",3) D  Q
"RTN","PSOOREDT",84,0)
 ..N NDC D NDC^PSODRG(RXN,0,,.NDC) I $G(NDC)="^"!($G(NDC)="") Q
"RTN","PSOOREDT",85,0)
 ..S (PSODRUG("NDC"),PSORXED("FLD",27))=NDC
"RTN","PSOOREDT",86,0)
 .I FLN'>2,'$P(PSOPAR,"^",3) S VALMSG="Check site parameters, Drug data is not editable." Q
"RTN","PSOOREDT",87,0)
 .I FLN=3 D EDTDOSE^PSOORED2,FULL^VALM1,POST^PSODRG S:$G(PSORX("DFLG")) PSOISLKD=1,PSORX("FN")=1 Q
"RTN","PSOOREDT",88,0)
 .I FLN=4 D INS^PSOORED1 Q
"RTN","PSOOREDT",89,0)
 .I FLN=1 D PSOI^PSOORED6 N PSOX S PSORXED=1,PSOX("IRXN")=$S($D(DA):DA,$D(PSORXED("IRXN")):PSORXED("IRXN"),$D(PSORENW("OIRXN")):PSORENW("OIRXN")) D:'$G(PSORXED("DFLG")) EN^PSODIAG Q
"RTN","PSOOREDT",90,0)
 .I FLN=2 D DRG^PSOORED6 N PSOX S PSORXED=1,PSOX("IRXN")=PSORXED("IRXN") D:'$G(PSORXED("DFLG")) EN^PSODIAG S:$O(^PSRX(PSORXED("IRXN"),1,0)) REF=1 Q
"RTN","PSOOREDT",91,0)
 .I FLN=12,PSOPKI W !!,"Digitally Signed Order - Provider can't be changed" D PAUSE Q
"RTN","PSOOREDT",92,0)
 .I FLN=12 D PROV Q
"RTN","PSOOREDT",93,0)
 .I FLN=6 D ISDT^PSOORED2 Q
"RTN","PSOOREDT",94,0)
 .I FLN=7 D FLDT^PSOORED2 Q
"RTN","PSOOREDT",95,0)
 .I FLN=21,$$STATUS^PSOBPSUT(RXN,0)="" S VALMSG="Invalid selection!" Q
"RTN","PSOOREDT",96,0)
 .I FLN=21 D  Q
"RTN","PSOOREDT",97,0)
 ..N DAW D EDTDAW^PSODAWUT(RXN,0,.DAW) I $G(DAW)="^" Q
"RTN","PSOOREDT",98,0)
 ..S (PSODRUG("DAW"),PSORXED("FLD",81))=DAW
"RTN","PSOOREDT",99,0)
 .I FLN=9!(FLN=10)!(FLN=11) D NOCHG^PSOORED7 Q
"RTN","PSOOREDT",100,0)
 .S DR=+DR
"RTN","PSOOREDT",101,0)
 .K DIR,DIRUT,DIROUT ;S DIE=52 D ^DIE I $D(Y) S PSORXED("DFLG")=1
"RTN","PSOOREDT",102,0)
 .K DIC,DIQ S DIC=52,DA=PSORXED("IRXN"),DIQ="PSORXED" D EN^DIQ1 K DIC,DIQ
"RTN","PSOOREDT",103,0)
 .S DIR("B")=$S($G(PSORXED("FLD",DR))]"":PSORXED("FLD",DR),1:PSORXED(52,DA,DR)),DIR(0)="52,"_DR D ^DIR
"RTN","PSOOREDT",104,0)
 .I DR=24!(DR=12) S PSORXED("FLD",DR)=X
"RTN","PSOOREDT",105,0)
 .I $D(DIRUT) K DIR,DIRUT,DUOUT,DTOUT,PSORXED(52,DA,DR),PSORXED("FLD",DR) Q
"RTN","PSOOREDT",106,0)
 .I DR'=5,X="@" W !,"Data Required!",! K DIC,DIQ,DR,DA,DIR,DIRUT,PSORXED(52,DA,DR),X,Y Q
"RTN","PSOOREDT",107,0)
 .I DR=5,X'="@" S Y=+Y
"RTN","PSOOREDT",108,0)
 .I DR=3!(DR=20)!(DR=23) S Y=+Y
"RTN","PSOOREDT",109,0)
 .S PSORXED("FLD",DR)=$S(X="@":X,1:Y) K DIR,DIRUT,DIROUT,X,Y,PSORXED(52,DA,DR)
"RTN","PSOOREDT",110,0)
 .I DR=11,PSORXED("FLD",DR)="W",$P(PSOPAR,"^",12) D
"RTN","PSOOREDT",111,0)
 ..D FIELD^DID(52,DR,"","LABEL","ZZ") S PSORXED(ZZ("LABEL"))=PSORXED("FLD",DR) K ZZ
"RTN","PSOOREDT",112,0)
 ..S DR=35,DIQ="PSORXED" D EN^DIQ1 K DIC,DIQ,DIRUT,DUOUT,DTOUT
"RTN","PSOOREDT",113,0)
 ..S:$G(PSORXED(52,DA,DR))]"" DIR("B")=PSORXED(52,DA,DR)
"RTN","PSOOREDT",114,0)
 ..S DIR(0)="52,"_(DR) D ^DIR I $D(DIRUT),X'="@" K DIR,DIRUT Q
"RTN","PSOOREDT",115,0)
 ..S PSORXED("FLD",DR)=X K DIR,DIRUT,DIROUT,X,Y,PSORXED(52,DA,DR)
"RTN","PSOOREDT",116,0)
 .I $G(PSORXED("FLD",DR))]"" D FIELD^DID(52,DR,"","LABEL","ZZ") S PSORXED(ZZ("LABEL"))=PSORXED("FLD",DR) K ZZ
"RTN","PSOOREDT",117,0)
 Q:$G(PSOSIGFL)
"RTN","PSOOREDT",118,0)
 S (RX1,I,RFD,RFDT)=0 F  S I=$O(^PSRX(PSORXED("IRXN"),1,I)) Q:'I  S RFD=I,RFDT=$P(^PSRX(PSORXED("IRXN"),1,I,0),"^"),RX1(I)=$G(RX1(I))+1
"RTN","PSOOREDT",119,0)
 Q
"RTN","PSOOREDT",120,0)
CHK S CHK=1 I $G(^PSDRUG($P(PSORXED("RX0"),"^",6),"I"))]"",^("I")<DT S VALMSG="This drug has been inactivated. ",PSORXED("DFLG")=1 Q
"RTN","PSOOREDT",121,0)
 K PSPOP I $G(PSODIV),$P(PSORXED("RX2"),"^",9)'=PSOSITE S PSPRXN=PSORXED("IRXN") D  Q:PSORXED("DFLG")
"RTN","PSOOREDT",122,0)
 .I '$P(PSOSYS,"^",2) S VALMSG="RX# "_$P(^PSRX(PSPRXN,0),"^")_" is not a valid choice. (Different Division)" S PSORXED("DFLG")=1 Q
"RTN","PSOOREDT",123,0)
 .I $P(PSOSYS,"^",3) K DIR,DUOUT,DTOUT D  K DIR,DUOUT,DTOUT Q
"RTN","PSOOREDT",124,0)
 ..W $C(7) S DIR("A",1)="",DIR("A",2)="RX# "_$P(^PSRX(PSPRXN,0),"^")_" is from another division.",DIR("A")="Continue: (Y/N)",DIR(0)="Y",DIR("?",1)="'Y' FOR YES",DIR("?")="'N' FOR NO"
"RTN","PSOOREDT",125,0)
 ..S DIR("B")="N" D ^DIR I 'Y!($D(DIRUT)) S PSORXED("DFLG")=1 W !
"RTN","PSOOREDT",126,0)
 ;
"RTN","PSOOREDT",127,0)
 I $P(^PSRX(PSORXED("IRXN"),"STA"),"^")=16 D  Q
"RTN","PSOOREDT",128,0)
 . S PSORXED("DFLG")=1 S VALMSG="Prescriptions on Provider Hold cannot be edited."
"RTN","PSOOREDT",129,0)
 ;
"RTN","PSOOREDT",130,0)
CHKX K PSPOP,DIR,DTOUT,DUOUT,Y,X Q
"RTN","PSOOREDT",131,0)
 Q
"RTN","PSOOREDT",132,0)
PROV ;select provider
"RTN","PSOOREDT",133,0)
 S PSORXED("PROVIDER")=$P(RX0,"^",4),PSORXED("PROVIDER NAME")=$P(^VA(200,$P(RX0,"^",4),0),"^")
"RTN","PSOOREDT",134,0)
 D PROV^PSODIR(.PSORXED) I PSORXED("PROVIDER")'=$P(RX0,"^",4) D
"RTN","PSOOREDT",135,0)
 .K DIR,DIRUT W ! S DIR(0)="Y",DIR("A",1)="You have changed the name of the provider entered for this Rx."
"RTN","PSOOREDT",136,0)
 .S DIR("A",2)="This edit will cause the provider's name to be update for all fills.",DIR("A")="Do you want to continue" D ^DIR
"RTN","PSOOREDT",137,0)
 .I 'Y!$D(DIRUT) K PSORX("PROVIDER"),PSORX("PROVIDER NAME"),PSORX("COSIGNING PROVIDER") Q
"RTN","PSOOREDT",138,0)
 .S PSORXED("FLD",4)=PSORXED("PROVIDER") K DIR,DIRUT,DUOUT
"RTN","PSOOREDT",139,0)
 .S PSORXED("FLD",109)=$G(PSORXED("COSIGNING PROVIDER"))
"RTN","PSOOREDT",140,0)
 Q
"RTN","PSOOREDT",141,0)
UDPROV ;update provider
"RTN","PSOOREDT",142,0)
 S $P(^PSRX(PSORXED("IRXN"),0),"^",4)=PSORXED("PROVIDER"),$P(^(3),"^",3)=$G(PSORX("COSIGNING PROVIDER"))
"RTN","PSOOREDT",143,0)
 F XTY="1","P" F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),XTY,I)) Q:'I  S $P(^PSRX(PSORXED("IRXN"),XTY,I,0),"^",17)=PSORXED("PROVIDER") S:XTY RFED=I
"RTN","PSOOREDT",144,0)
 K XTY,I
"RTN","PSOOREDT",145,0)
 Q
"RTN","PSOOREDT",146,0)
SIG ;edit medication instructions (SIG)
"RTN","PSOOREDT",147,0)
 S PSOFDR=+$P(^PSRX(PSORXED("IRXN"),"SIG"),"^",2) I PSOFDR D
"RTN","PSOOREDT",148,0)
 .F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S SIG(I)=^PSRX(PSORXED("IRXN"),"SIG1",I,0)
"RTN","PSOOREDT",149,0)
 E  S PSORX("SIG")=$P(^PSRX(PSORXED("IRXN"),"SIG"),"^")
"RTN","PSOOREDT",150,0)
 D SIG^PSODIR1(.PSORX) D:$G(PSORX("SIG"))]"" EN1^PSOSIGNO(PSORXED("IRXN"),PSORX("SIG"))
"RTN","PSOOREDT",151,0)
 I '$G(PSOSIGFL),$G(PSORX("SIG"))]"" S ^PSRX(PSORXED("IRXN"),"SIG")=PSORX("SIG") K ^PSRX(PSORXED("IRXN"),"SIG1") Q
"RTN","PSOOREDT",152,0)
 S PSOMRFLG=1
"RTN","PSOOREDT",153,0)
 Q
"RTN","PSOOREDT",154,0)
UL ;
"RTN","PSOOREDT",155,0)
 I '$G(PSOLOKED) Q
"RTN","PSOOREDT",156,0)
 D UL^PSSLOCK(PSODFN)
"RTN","PSOOREDT",157,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOOREDT",158,0)
 Q
"RTN","PSOOREDT",159,0)
SVAL ;Set message for patient lock
"RTN","PSOOREDT",160,0)
 S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.")
"RTN","PSOOREDT",161,0)
 Q
"RTN","PSOOREDT",162,0)
SVALO ;Set message for order lock
"RTN","PSOOREDT",163,0)
 S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order.")
"RTN","PSOOREDT",164,0)
 Q
"RTN","PSOOREDT",165,0)
 ;
"RTN","PSOOREDT",166,0)
PAUSE     ;
"RTN","PSOOREDT",167,0)
 N DIR,X,Y
"RTN","PSOOREDT",168,0)
 W ! S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR
"RTN","PSOOREDT",169,0)
 Q
"RTN","PSOOREDT",170,0)
REQFLDS(FIELDS) ; Checks if fields 1,2 or 3 are being edited
"RTN","PSOOREDT",171,0)
 N REQFLDS,I
"RTN","PSOOREDT",172,0)
 S REQFLDS=0
"RTN","PSOOREDT",173,0)
 F I=1:1:$L(FIELDS) I ",1,2,3,"[(","_+$P(FIELDS,",",I)_",") S REQFLDS=1 Q
"RTN","PSOOREDT",174,0)
 Q REQFLDS
"RTN","PSOOREDT",175,0)
CSFLDBLK(FIELDS) ; checks if this field shold be blocked for a controlled substance
"RTN","PSOOREDT",176,0)
 N B,FLDCHECK
"RTN","PSOOREDT",177,0)
 S FLDCHECK=0
"RTN","PSOOREDT",178,0)
 F B=1:1:$L(FIELDS) D
"RTN","PSOOREDT",179,0)
 .I (","_FST[",1,")!(","_FST[",3,")!(","_FST[",11,")!(","_FST[",12,")!(","_FST[",17,") S FLDCHECK=1 Q
"RTN","PSOOREDT",180,0)
 Q FLDCHECK
"RTN","PSOORFI1")
0^13^B86566158^B82061614
"RTN","PSOORFI1",1,0)
PSOORFI1 ;BIR/SAB - finish OP orders from OE/RR continued ; 10/23/15 4:14pm
"RTN","PSOORFI1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**7,15,23,27,32,44,51,46,71,90,108,131,152,186,210,222,258,260,225,391,408,444,467,505**;DEC 1997;Build 39
"RTN","PSOORFI1",3,0)
 ;Ref. ^PS(50.7 supp. DBIA 2223
"RTN","PSOORFI1",4,0)
 ;Ref. ^PSDRUG( supp. DBIA 221
"RTN","PSOORFI1",5,0)
 ;Ref. L^PSSLOCK supp. DBIA 2789
"RTN","PSOORFI1",6,0)
 ;Ref. ^PS(50.606 supp. DBIA 2174
"RTN","PSOORFI1",7,0)
 ;Ref. ^PS(55 supp. DBIA 2228
"RTN","PSOORFI1",8,0)
 ;Ref. ULK^ORX2 supp. DBIA 867
"RTN","PSOORFI1",9,0)
 ;
"RTN","PSOORFI1",10,0)
 ;PSO*186 add call to function $$DEACHK
"RTN","PSOORFI1",11,0)
 ;PSO*210 add call to WORDWRAP api
"RTN","PSOORFI1",12,0)
 ;
"RTN","PSOORFI1",13,0)
 S SIGOK=1
"RTN","PSOORFI1",14,0)
DSPL K ^TMP("PSOPO",$J),CLOZPAT,PSOPRC,PSODSPL
"RTN","PSOORFI1",15,0)
 S (OI,PSODRUG("OI"))=$P(OR0,"^",8),PSODRUG("OIN")=$P(^PS(50.7,$P(OR0,"^",8),0),"^"),OID=$P(OR0,"^",9)
"RTN","PSOORFI1",16,0)
 I $P($G(OR0),"^",9) S POERR=1,DREN=$P(OR0,"^",9) D DRG^PSOORDRG K POERR G DRG
"RTN","PSOORFI1",17,0)
 I '$P(OR0,"^",9) D DREN^PSOORNW2
"RTN","PSOORFI1",18,0)
DRG I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),"CLOZ1")),"^")="PSOCLO1" D CLOZ^PSOORFI2
"RTN","PSOORFI1",19,0)
 ;PSO*186 modify If/Else below to use DEACHK
"RTN","PSOORFI1",20,0)
 I $G(PSODRUG("DEA"))]"" D
"RTN","PSOORFI1",21,0)
 .S PSOCS=0 K DIR,DIC,PSOX
"RTN","PSOORFI1",22,0)
 .N PSDEA,PSDAYS S PSDEA=PSODRUG("DEA"),PSDAYS=+$P(OR0,"^",22)
"RTN","PSOORFI1",23,0)
 .I $$DEACHK^PSOUTLA1("*",PSDEA,PSDAYS,$G(CLOZPAT),.PSOCS,.PSOMAX)
"RTN","PSOORFI1",24,0)
 E  D
"RTN","PSOORFI1",25,0)
 .S PSOMAX=$S($G(CLOZPAT)=2:3,$G(CLOZPAT)=1:1,1:$P(OR0,"^",11))
"RTN","PSOORFI1",26,0)
ISSDT S (PSOID,Y,PSONEW("ISSUE DATE"))=$S($G(PSONEW("ISSUE DATE")):PSONEW("ISSUE DATE"),$P($G(OR0),"^",6):$E($P(OR0,"^",6),1,7),1:DT)
"RTN","PSOORFI1",27,0)
 X ^DD("DD") S PSONEW("ISSUE DATE")=Y
"RTN","PSOORFI1",28,0)
 D USER^PSOORFI2($P(OR0,"^",4)) S PSONEW("CLERK CODE")=$P(OR0,"^",4),PSORX("CLERK CODE")=USER1
"RTN","PSOORFI1",29,0)
 S (PSONEW("DFLG"),PSONEW("QFLG"))=0,PSODFN=$P(OR0,"^",2),PSONEW("QTY")=$P(OR0,"^",10),PSONEW("MAIL/WINDOW")=$S($P(OR0,"^",17)="M":"M",1:"W")
"RTN","PSOORFI1",30,0)
 S:$G(PSONEW("CLINIC"))']"" PSONEW("CLINIC")=+$P(OR0,"^",13),PSORX("CLINIC")=$S($D(^SC(PSONEW("CLINIC"),0)):$P(^SC(PSONEW("CLINIC"),0),"^"),1:"")
"RTN","PSOORFI1",31,0)
 S:$G(PSORX("CLINIC"))']"" PSORX("CLINIC")=$S($D(^SC(+$P(OR0,"^",13),0)):$P(^SC($P(OR0,"^",13),0),"^"),1:"")
"RTN","PSOORFI1",32,0)
 D USER^PSOORFI2($P(OR0,"^",5))
"RTN","PSOORFI1",33,0)
 S PSONEW("CLERK CODE")=$P(OR0,"^",4),PSONEW("PROVIDER")=$P(OR0,"^",5),PSONEW("PROVIDER NAME")=USER1
"RTN","PSOORFI1",34,0)
 S PSONEW("PATIENT STATUS")=$S(+$G(^PS(55,PSODFN,"PS")):+$G(^PS(55,PSODFN,"PS")),1:"")
"RTN","PSOORFI1",35,0)
 S PSONEW("CHCS NUMBER")=$S($P($G(^PS(52.41,+$G(ORD),"EXT")),"^")'="":$P($G(^("EXT")),"^"),1:"")
"RTN","PSOORFI1",36,0)
 S PSONEW("EXTERNAL SYSTEM")=$S($P($G(^PS(52.41,+$G(ORD),"EXT")),"^",3)'="":$P($G(^("EXT")),"^",3),1:"")
"RTN","PSOORFI1",37,0)
 I $P(OR0,"^",22)>0 S PSONEW("DAYS SUPPLY")=$P(OR0,"^",22) G DS
"RTN","PSOORFI1",38,0)
 S PSONEW("DAYS SUPPLY")=$S(+$G(^PS(55,PSODFN,"PS"))&($P($G(^PS(53,+$G(^PS(55,PSODFN,"PS")),0)),"^",3)):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:30)
"RTN","PSOORFI1",39,0)
DS ;
"RTN","PSOORFI1",40,0)
 S:$D(CLOZPAT) PSONEW("DAYS SUPPLY")=$S(CLOZPAT=2&(PSONEW("DAYS SUPPLY")>28):28,CLOZPAT=1&(PSONEW("DAYS SUPPLY")>14):14,'CLOZPAT&(PSONEW("DAYS SUPPLY")>7):7,1:PSONEW("DAYS SUPPLY"))
"RTN","PSOORFI1",41,0)
 S IEN=0 D OBX                ; Display Order Checks Information
"RTN","PSOORFI1",42,0)
 D LMDISP^PSOORFI5(+$G(ORD))  ; Display Flag/Unflag Information
"RTN","PSOORFI1",43,0)
 D DIN^PSONFI(PSODRUG("OI"),$S($D(PSODRUG("IEN")):PSODRUG("IEN"),1:"")) ;Setup for N/F & DIN indicator
"RTN","PSOORFI1",44,0)
 ; pso*7*467 - add display of erx information if the rx came from eRx
"RTN","PSOORFI1",45,0)
 N ERXIEN
"RTN","PSOORFI1",46,0)
 S ERXIEN=$$CHKERX^PSOERXU1(OR0) I ERXIEN D DERX1^PSOERXU1($NA(^TMP("PSOPO",$J)),ERXIEN,"",.IEN)
"RTN","PSOORFI1",47,0)
 ; pso*7*467 - end eRx enhancement
"RTN","PSOORFI1",48,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="*(1) Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORFI1",49,0)
 S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORFI1",50,0)
 ;
"RTN","PSOORFI1",51,0)
 K LST I $G(PSODRUG("NAME"))]"" D  G PST
"RTN","PSOORFI1",52,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)"_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORFI1",53,0)
 .S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORFI1",54,0)
 .I $P(^PSDRUG(PSODRUG("IEN"),0),"^",10)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Drug Message:" D DRGMSG^PSOORNEW
"RTN","PSOORFI1",55,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)           Drug: No Dispense Drug Selected"
"RTN","PSOORFI1",56,0)
PST D DOSE^PSOORFI4 K PSOINSFL
"RTN","PSOORFI1",57,0)
 S PSOINSFL=$P($G(^PS(52.41,ORD,"INS")),"^",2)
"RTN","PSOORFI1",58,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (4)   Pat Instruct:" D INST^PSOORFI4
"RTN","PSOORFI1",59,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Provider Comments:" S TY=3 D INST
"RTN","PSOORFI1",60,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Instructions:" S TY=2 D INST
"RTN","PSOORFI1",61,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                SIG:" D SIG
"RTN","PSOORFI1",62,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (5) Patient Status: "_$P($G(^PS(53,+PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORFI1",63,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (6)     Issue Date: "_PSONEW("ISSUE DATE")
"RTN","PSOORFI1",64,0)
 S (Y,PSONEW("FILL DATE"))=$S($E($P(OR0,"^",6),1,7)<DT:DT,1:$E($P(OR0,"^",6),1,7)) X ^DD("DD") S PSORX("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"        (7) Fill Date: "_Y
"RTN","PSOORFI1",65,0)
 I $P(OR0,"^",18) D
"RTN","PSOORFI1",66,0)
 .S IEN=IEN+1,Y=$P(OR0,"^",18) X ^DD("DD") S $P(^TMP("PSOPO",$J,IEN,0)," ",39)="Effective Date: "_Y
"RTN","PSOORFI1",67,0)
 D:$D(CLOZPAT) ELIG^PSOORFI2,CLQTY^PSOORFI4
"RTN","PSOORFI1",68,0)
 N PSDAYS,MAXRF
"RTN","PSOORFI1",69,0)
 S PSDAYS=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3)):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:"")
"RTN","PSOORFI1",70,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (8)    Days Supply: "_PSDAYS
"RTN","PSOORFI1",71,0)
 S RXPT=+$G(^PS(55,PSODFN,"PS"))
"RTN","PSOORFI1",72,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSOORFI1",73,0)
 S MAXRF=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),PSDAYS,RXPT,.CLOZPAT)
"RTN","PSOORFI1",74,0)
 S PSONEW("# OF REFILLS")=$S(+$P(OR0,"^",11)>MAXRF:MAXRF,1:+$P(OR0,"^",11))
"RTN","PSOORFI1",75,0)
 KILL RXPT
"RTN","PSOORFI1",76,0)
 ;
"RTN","PSOORFI1",77,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                (9)   QTY"_$S($P($G(^PSDRUG(+$G(PSODRUG("IEN")),660)),"^",8)]"":" ("_$P($G(^PSDRUG(+$G(PSODRUG("IEN")),660)),"^",8)_")",1:" (  )")_": "_$G(PSONEW("QTY"))
"RTN","PSOORFI1",78,0)
 I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),5)),"^")]"" D
"RTN","PSOORFI1",79,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORFI1",80,0)
 .S ^TMP("PSOPO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^") K RN
"RTN","PSOORFI1",81,0)
 S IEN=IEN+1
"RTN","PSOORFI1",82,0)
 I $P(OR0,"^",24) S ^TMP("PSOPO",$J,IEN,0)="   Provider ordered: days supply "_$P(OR0,"^",22)_", quantity "_$P(OR0,"^",10)_" & refills "_+$P(OR0,"^",11)
"RTN","PSOORFI1",83,0)
 E  S ^TMP("PSOPO",$J,IEN,0)="       Provider ordered "_+$P(OR0,"^",11)_" refills"
"RTN","PSOORFI1",84,0)
 D:$D(CLOZPAT) PQTY^PSOORFI4
"RTN","PSOORFI1",85,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(10)   # of Refills: "_PSONEW("# OF REFILLS")_$E("  ",$L(PSONEW("# OF REFILLS"))+1,2)_"               (11)   Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORFI1",86,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(12)         Clinic: "_PSORX("CLINIC")
"RTN","PSOORFI1",87,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(13)       Provider: "_PSONEW("PROVIDER NAME")
"RTN","PSOORFI1",88,0)
 I $G(PKI),+$G(PSODRUG("DEA"))>1,+$G(PSODRUG("DEA"))<6 D PRV^PSOORFI5($P(OR0,"^",5),$P(OR0,"^",9),$P(OR0,"^"))
"RTN","PSOORFI1",89,0)
 I $P($G(^VA(200,$S($G(PSONEW("PROVIDER")):PSONEW("PROVIDER"),1:$P(OR0,"^",5)),"PS")),"^",7)&($P($G(^("PS")),"^",8)) S PSONEW("COSIGNING PROVIDER")=$P(^("PS"),"^",8) D
"RTN","PSOORFI1",90,0)
 .D USER^PSOORFI2(PSONEW("COSIGNING PROVIDER"))
"RTN","PSOORFI1",91,0)
 .S IEN=IEN+1 S ^TMP("PSOPO",$J,IEN,0)="        Cos-Provider: "_USER1
"RTN","PSOORFI1",92,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(14)         Copies: 1"
"RTN","PSOORFI1",93,0)
 S PSONEW("REMARKS")=$S($P(OR0,"^",17)="C":"Administered in Clinic.",1:"")
"RTN","PSOORFI1",94,0)
 K PSONEW("ADMINCLINIC") S:$P(OR0,"^",17)="C" PSONEW("ADMINCLINIC")=1
"RTN","PSOORFI1",95,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(15)        Remarks: "_$S($G(PSONEW("REMARKS"))]"":PSONEW("REMARKS"),1:"")
"RTN","PSOORFI1",96,0)
 D USER^PSOORFI2($P(OR0,"^",4))
"RTN","PSOORFI1",97,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_USER1_$E(RN,$L(USER1)+1,35)
"RTN","PSOORFI1",98,0)
 S Y=$P(OR0,"^",12) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$E($P(OR0,"^",12),4,5)_"/"_$E($P(OR0,"^",12),6,7)_"/"_$E($P(OR0,"^",12),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORFI1",99,0)
 I $P(OR0,"^",24) S PSOACT=$S($D(^XUSEC("PSDRPH",DUZ)):"DEFX",$D(^XUSEC("PSORPH",DUZ)):"F",$P($G(PSOPAR),"^",2):"F",1:"") D
"RTN","PSOORFI1",100,0)
 .K PSOCSP S PSOCSP("NAME")=$G(PSODRUG("NAME")) M PSOCSP("DOSE")=PSONEW("DOSE"),PSOCSP("DOSE ORDERED")=PSONEW("DOSE ORDERED")
"RTN","PSOORFI1",101,0)
 .S PSOCSP("# OF REFILLS")=PSONEW("# OF REFILLS") ;track original data for dig. orders
"RTN","PSOORFI1",102,0)
 .S PSOCSP("ISSUE DATE")=$E($P(OR0,"^",6),1,7),PSOCSP("QTY")=PSONEW("QTY"),PSOCSP("DAYS SUPPLY")=PSONEW("DAYS SUPPLY")
"RTN","PSOORFI1",103,0)
 E  S PSOACT=$S($D(^XUSEC("PSORPH",DUZ)):"DEFX",'$D(^XUSEC("PSORPH",DUZ))&($P($G(PSOPAR),"^",2)):"F",1:"")
"RTN","PSOORFI1",104,0)
 ; - PSOACTOV is used to force the Pending Order to be Read-Only (no updates) even if invoked by a Pharmacist
"RTN","PSOORFI1",105,0)
 I $G(PSOACTOV) S PSOACT=""
"RTN","PSOORFI1",106,0)
 D:'$G(ACP) EN^PSOLMPO S:$G(ACP) VALMBCK="Q" D:$G(PKI1)=2 DCP^PSOPKIV1
"RTN","PSOORFI1",107,0)
 Q
"RTN","PSOORFI1",108,0)
POST ;post patient selection
"RTN","PSOORFI1",109,0)
 D POST^PSOORFI2 Q
"RTN","PSOORFI1",110,0)
SIG ;displays possible sig
"RTN","PSOORFI1",111,0)
 D SIG^PSOORFI2 Q
"RTN","PSOORFI1",112,0)
INST ;displays provider comments and pharmacy instructions
"RTN","PSOORFI1",113,0)
 S INST=0 F  S INST=$O(^PS(52.41,ORD,TY,INST)) Q:'INST  D     ;PSO*210
"RTN","PSOORFI1",114,0)
 . S (MIG,INST(INST))=^PS(52.41,ORD,TY,INST,0)
"RTN","PSOORFI1",115,0)
 . D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOPO",$J)),20)
"RTN","PSOORFI1",116,0)
 K INST,TY,MIG,SG
"RTN","PSOORFI1",117,0)
 Q
"RTN","PSOORFI1",118,0)
OBX ;formats obx section
"RTN","PSOORFI1",119,0)
 D OBX^PSOORFI4
"RTN","PSOORFI1",120,0)
 Q
"RTN","PSOORFI1",121,0)
ST(PSRT) ;sort by route or patient
"RTN","PSOORFI1",122,0)
 W !!,"Enter: ",!
"RTN","PSOORFI1",123,0)
 I $G(PSRT)'="PA" W "      'PA' to process orders by patients",!
"RTN","PSOORFI1",124,0)
 I $G(PSRT)'="RT" W "      'RT' to process orders by route (mail/window)",!
"RTN","PSOORFI1",125,0)
 I $G(PSRT)'="PR" W "      'PR' to process orders by priority",!
"RTN","PSOORFI1",126,0)
 I $G(PSRT)'="CL" W "      'CL' to process orders by clinic",!
"RTN","PSOORFI1",127,0)
 I $G(PSRT)'="FL" W "      'FL' to process flagged orders",!
"RTN","PSOORFI1",128,0)
 I $G(PSRT)']"" W "      'CS' to process digitally signed CS orders",!
"RTN","PSOORFI1",129,0)
 I $G(PSRT)]"","SUCS"'[$G(PSRT) W "      'CS' to process digitally signed CS orders",!
"RTN","PSOORFI1",130,0)
 I $G(PSRT)']"" W "      'SU' to process supply item orders",!
"RTN","PSOORFI1",131,0)
 I $G(PSRT)]"","SUCS"'[$G(PSRT) W "      'SU' to process supply item orders",!
"RTN","PSOORFI1",132,0)
 I $D(PSRT) W "   or 'C' to continue with one filter ",!
"RTN","PSOORFI1",133,0)
 W "   or 'E' or '^' to exit" W ! Q
"RTN","PSOORFI1",134,0)
RT ;which route to sort by
"RTN","PSOORFI1",135,0)
 W !!,"Enter 'W' to process window orders first",!,"      'M' to process mail orders first",!,"      'C' to process orders administered in clinic first",!,"   or 'E' or '^' to exit" Q
"RTN","PSOORFI1",136,0)
PT ;process for all or one patient
"RTN","PSOORFI1",137,0)
 W !!,"Enter 'A' to process all patient orders",!,"      'S' to process orders for a patient",!,"      or 'E' or '^' to exit" Q
"RTN","PSOORFI1",138,0)
EP ;continue processing or not
"RTN","PSOORFI1",139,0)
 W !,"If you want to continue processing orders Press RETURN or enter '^' to exit" Q
"RTN","PSOORFI1",140,0)
LOCK S PSOPLCK=$$L^PSSLOCK(PAT,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S POERR("QFLG")=1
"RTN","PSOORFI1",141,0)
 K PSOPLCK
"RTN","PSOORFI1",142,0)
 Q
"RTN","PSOORFI1",143,0)
ULK S X=PAT_";DPT(" D ULK^ORX2 S:$G(PSOQUIT) POERR("QFLG")=1 ; not called anymore
"RTN","PSOORFI1",144,0)
 Q
"RTN","PSOORFI1",145,0)
LOCK1 ;
"RTN","PSOORFI1",146,0)
 I $P($G(^PS(52.41,ORD,0)),"^",24) S PSOACT=$S($D(^XUSEC("PSDRPH",DUZ)):"DEFX",$D(^XUSEC("PSORPH",DUZ)):"F",'$D(^XUSEC("PSORPH",DUZ))&($P($G(PSOPAR),"^",2)):"F",1:"")
"RTN","PSOORFI1",147,0)
 E  S PSOACT=$S($D(^XUSEC("PSORPH",DUZ)):"DEFX",'$D(^XUSEC("PSORPH",DUZ))&($P($G(PSOPAR),"^",2)):"F",1:"")
"RTN","PSOORFI1",148,0)
 Q
"RTN","PSOORFI1",149,0)
EX K DRET,SIG,PSODRUG,PRC,PHI
"RTN","PSOORFI1",150,0)
 K DIR,DIRUT,DUOUT,DIRUT,X,Y,DIC,POERR,PSONEW,PSOSD,MAIL,CLI,WIN,OR0,OR1,OR2,ORD,SRT,PSRT,PSODFN,PSOFROM,T,OR3,PAT,%,%T,%Y,DI,DQ,DR,DRG,STA,I,T1,PSOSORT,PSOCSP
"RTN","PSOORFI1",151,0)
 K TO,TC,TZ,PSOCPAY,PSOBILL,PSOIBQS,GROUPCNT,AGROUP,AGROUP1,OBX,%,%I,%H,D0,DFN,PSORX,PSOPTPST,PSOQFLG,PT,RTN,TM,TM1,DIPGM,PSOID,PSOCNT,PSOLK,PSZFIN,PSZFZZ D KVA^VADPT
"RTN","PSOORFI1",152,0)
 K PSOFDR,PSOQUIT,PSOFIN,^TMP("PSOAO",$J),^TMP("PSODA",$J),^TMP("PSOPO",$J),^TMP("PSOPF",$J),^TMP("PSOPI",$J),^TMP("PSOHDR",$J),MEDA,MEDP
"RTN","PSOORFI1",153,0)
 K C,CC,CNT,CRIT,D,DGI,DGS,DREN,IT,JJ,LG,MM,NIEN,PSOD,PATA,PSDAYS,PSOACT,PSOBM,PSOCOU,PSOCOUU,PSOFLAG,PSON,PSONOOR,PSOOPT,PSOPF,PSOPI,PSRF,RXFL,SDA,SEG1,SER,SERS,SLPPL,STAT,Z,Z4,ZDA
"RTN","PSOORFI1",154,0)
 D FULL^VALM1
"RTN","PSOORFI1",155,0)
 Q
"RTN","PSOORFI3")
0^8^B77499735^B74671626
"RTN","PSOORFI3",1,0)
PSOORFI3 ;BIR/RTR-finish CPRS orders by Clinic ; 4/26/11 2:05pm
"RTN","PSOORFI3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**15,27,32,46,84,99,130,117,139,172,225,300,384,372,505**;DEC 1997;Build 39
"RTN","PSOORFI3",3,0)
 ;SC(-2675,40.8-728,51.2-2226,50.607-2221,55-2228,PSSLOCK-2789,DPT-10035,ORX2-867
"RTN","PSOORFI3",4,0)
 ;
"RTN","PSOORFI3",5,0)
 K ^TMP($J,"PSOCL"),^TMP($J,"PSOCLX"),PSOCLIN,PSOCLINF,PSOXINST
"RTN","PSOORFI3",6,0)
 N PSOCFLAG,PSONPTRX,PSOINPTR,PSCLP,PSOCLINS,PSOSTC,PSOLGD,PSODIEN,PSOCTMP
"RTN","PSOORFI3",7,0)
 K DIR S DIR(0)="SMB^C:CLINIC;S:SORT GROUP;E:EXIT",DIR("A")="Select By",DIR("B")="Clinic",DIR("?",1)="Enter 'C' to process orders for one individual Clinic,"
"RTN","PSOORFI3",8,0)
 S DIR("?",2)="      'S' to process orders for all Clinics associated with a Sort Group,",DIR("?",3)="      '^' or 'E' to exit" S DIR("?")=" "
"RTN","PSOORFI3",9,0)
 W ! D ^DIR K DIR I $D(DTOUT)!($D(DUOUT))!(Y="E") W ! G EXIT
"RTN","PSOORFI3",10,0)
 I Y="S" G SORT
"RTN","PSOORFI3",11,0)
CLIN W ! K DIC S DIC="^SC(",DIC(0)="QEAMZ",DIC("A")="Select CLINIC: " D ^DIC K DIC I Y<1!($D(DTOUT))!($D(DUOUT)) G EXIT
"RTN","PSOORFI3",12,0)
 S PSOCLIN=+Y,PSOCLINF=1 D CHECK I $G(PSOCFLAG) D INSTNM^PSOORFI2 W !!,"You are signed in under the "_$G(PSODINST)_" CPRS Ordering",!,"Institution, which does not match the Institution for this Clinic!",! K PSODINST G CLIN
"RTN","PSOORFI3",13,0)
 S ^TMP($J,"PSOCL",PSOCLIN)=PSOCLIN K PSOCLIN G START
"RTN","PSOORFI3",14,0)
SORT W ! K DIC S DIC="^PS(59.8,",DIC(0)="QEAMZ",DIC("A")="Select CLINIC SORT GROUP: " D ^DIC K DIC I Y<1!($D(DTOUT))!($D(DUOUT)) G EXIT
"RTN","PSOORFI3",15,0)
 S PSOCLINS=+Y
"RTN","PSOORFI3",16,0)
 K ^TMP($J,"PSOCL"),^TMP($J,"PSOCLX") F PSCLP=0:0 S PSCLP=$O(^PS(59.8,PSOCLINS,1,PSCLP)) Q:'PSCLP  S PSOSTC=+$P($G(^PS(59.8,PSOCLINS,1,PSCLP,0)),"^") S:$G(PSOSTC)&($D(^SC(PSOSTC,0))) ^TMP($J,"PSOCL",PSOSTC)=PSOSTC
"RTN","PSOORFI3",17,0)
 I '$O(^TMP($J,"PSOCL",0)) W !!,"There are no Clinics associated with this Sort Group!",! K ^TMP($J,"PSOCL") G SORT
"RTN","PSOORFI3",18,0)
 F PSCLP=0:0 S PSCLP=$O(^TMP($J,"PSOCL",PSCLP)) Q:'PSCLP  S PSOCLIN=PSCLP D CHECK I $G(PSOCFLAG) S ^TMP($J,"PSOCLX",PSCLP)=PSCLP K ^TMP($J,"PSOCL",PSCLP)
"RTN","PSOORFI3",19,0)
 I $O(^TMP($J,"PSOCLX",0)) H 1 W @IOF W !,"Orders for these Clinics in the Sort Group will not be displayed for Finishing",!,"because the CPRS Ordering Institution does not match the Institution that is",!,"associated with the Clinic:",! D
"RTN","PSOORFI3",20,0)
 .F PSCLP=0:0 S PSCLP=$O(^TMP($J,"PSOCLX",PSCLP)) Q:'PSCLP  D:($Y+4)>IOSL  W !,$P($G(^SC(PSCLP,0)),"^")
"RTN","PSOORFI3",21,0)
 ..W ! K DIR S DIR(0)="E",DIR("A")="Press RETURN to continue" D ^DIR K DIR W @IOF
"RTN","PSOORFI3",22,0)
 I $O(^TMP($J,"PSOCLX",0)) D EOP
"RTN","PSOORFI3",23,0)
 K ^TMP($J,"PSOCLX") I '$O(^TMP($J,"PSOCL",0)) W !!,"There are no Clinics that have a matching Institution!",! D EOP G SORT
"RTN","PSOORFI3",24,0)
 ;
"RTN","PSOORFI3",25,0)
 S PSOCLINF=2
"RTN","PSOORFI3",26,0)
START K MEDP,MEDA,PSOQUIT,POERR("QFLG"),POERR("DFLG"),DIR
"RTN","PSOORFI3",27,0)
 G:'$O(^TMP($J,"PSOCL",0)) EXIT
"RTN","PSOORFI3",28,0)
 ;PSO*505 - added secondary sort
"RTN","PSOORFI3",29,0)
 N SECSORT S SECSORT=$$DIR^PSOORFI6("CL:CLINIC")
"RTN","PSOORFI3",30,0)
 S PATA=0 F PSOCLIN=0:0 S PSOCLIN=$O(^TMP($J,"PSOCL",PSOCLIN)) Q:'PSOCLIN!($G(POERR("QFLG")))  F PSOLGD=0:0 S PSOLGD=$O(^PS(52.41,"ACL",PSOCLIN,PSOLGD)) Q:'PSOLGD!($G(POERR("QFLG")))  D
"RTN","PSOORFI3",31,0)
 .F PSODIEN=0:0 S PSODIEN=$O(^PS(52.41,"ACL",PSOCLIN,PSOLGD,PSODIEN)) Q:'PSODIEN!($G(POERR("QFLG")))  D
"RTN","PSOORFI3",32,0)
 ..I $P($G(^PS(52.41,PSODIEN,0)),"^",3)'="NW",$P($G(^(0)),"^",3)'="RNW",$P($G(^(0)),"^",3)'="RF" Q
"RTN","PSOORFI3",33,0)
 ..I $G(PSOPINST)'=$P($G(^PS(52.41,PSODIEN,"INI")),"^") Q
"RTN","PSOORFI3",34,0)
 ..Q:$G(PAT($P(^PS(52.41,PSODIEN,0),"^",2)))=$P(^PS(52.41,PSODIEN,0),"^",2)  S PAT=$P(^PS(52.41,PSODIEN,0),"^",2)
"RTN","PSOORFI3",35,0)
 ..I PAT'=PATA K PSORX("DOSING OFF") I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI3",36,0)
 ..D LK^PSOORFIN I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI3",37,0)
 ..I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP^PSOORFIN Q
"RTN","PSOORFI3",38,0)
 ..S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(+$G(PAT),0)),"^"),PATA=PAT
"RTN","PSOORFI3",39,0)
 ..; PSO*505 - secondary sort check
"RTN","PSOORFI3",40,0)
 ..I SECSORT'=0,'$$CHKFLTR^PSOORFI6(PSODIEN,SECSORT) Q
"RTN","PSOORFI3",41,0)
 ..D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) K PSOFIN S POERR("QFLG")=0 S PSONOLCK=1,PSOPTLOK=PAT D OERR^PSORX1 S PSOFIN=1 D QU^PSOORFIN S X=PSOPTLOK D KLLP^PSOORFIN,ULP^PSOORFIN,KLL^PSOORFIN Q
"RTN","PSOORFI3",42,0)
 ..D SDFN^PSOORFIN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP^PSOORFIN K PSOQFLG Q
"RTN","PSOORFI3",43,0)
 ..S PAT(PAT)=PAT
"RTN","PSOORFI3",44,0)
 ..F ORD=0:0 S ORD=$O(^PS(52.41,"AOR",PAT,PSOPINST,ORD)) Q:'ORD!($G(POERR("QFLG")))  I '$P($G(^PS(52.41,ORD,0)),"^",23) D
"RTN","PSOORFI3",45,0)
 ...S PSODFN=PAT D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2)
"RTN","PSOORFI3",46,0)
 ...I SECSORT'=0,'$$CHKFLTR^PSOORFI6(ORD,SECSORT) Q
"RTN","PSOORFI3",47,0)
 ...D LK1^PSOORFIN,ORD^PSOORFIN S X=PAT D ULP^PSOORFIN
"RTN","PSOORFI3",48,0)
 I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI3",49,0)
 ;
"RTN","PSOORFI3",50,0)
EXIT K ^TMP($J,"PSOCL"),^TMP($J,"PSOCLX"),PSOCLIN,PSOCLINF,PSOXINST G EX^PSOORFIN
"RTN","PSOORFI3",51,0)
 Q
"RTN","PSOORFI3",52,0)
CHECK ; check Institution
"RTN","PSOORFI3",53,0)
 K PSOXINST,PSOCFLAG
"RTN","PSOORFI3",54,0)
 I $P($G(^SC(PSOCLIN,0)),"^",4),$P($G(^(0)),"^",4)'=$G(PSOPINST) S PSOCFLAG=1 Q
"RTN","PSOORFI3",55,0)
 I $P($G(^SC(PSOCLIN,0)),"^",4) Q
"RTN","PSOORFI3",56,0)
 S PSONPTRX=$P($G(^SC(PSOCLIN,0)),"^",15)
"RTN","PSOORFI3",57,0)
 I '$G(PSONPTRX) S PSONPTRX=$O(^DG(40.8,0))
"RTN","PSOORFI3",58,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOORFI3",59,0)
 S PSOINPTR=+$$SITE^VASITE(DT,PSONPTRX) I PSOINPTR'=$G(PSOPINST) S PSOCFLAG=1
"RTN","PSOORFI3",60,0)
 Q
"RTN","PSOORFI3",61,0)
EOP W ! K DIR S DIR(0)="E",DIR("A")="Press RETURN to continue" D ^DIR K DIR
"RTN","PSOORFI3",62,0)
 Q
"RTN","PSOORFI3",63,0)
L1 ;Lock single order
"RTN","PSOORFI3",64,0)
 I '$G(ORD) Q
"RTN","PSOORFI3",65,0)
 K PSOMSG D PSOL^PSSLOCK(+ORD_"S") I '$G(PSOMSG) W !!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"This Order is being edited by another person."),! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSOORFI3",66,0)
 Q
"RTN","PSOORFI3",67,0)
UL1 ;Unlock single order
"RTN","PSOORFI3",68,0)
 I '$G(ORD) Q
"RTN","PSOORFI3",69,0)
 I '$D(^PS(52.41,ORD,0)) D  Q
"RTN","PSOORFI3",70,0)
 . D UNLK1^ORX2(+$G(OR0))
"RTN","PSOORFI3",71,0)
 . Q
"RTN","PSOORFI3",72,0)
 D PSOUL^PSSLOCK(+ORD_"S")
"RTN","PSOORFI3",73,0)
 Q
"RTN","PSOORFI3",74,0)
DOSE ;pending orders
"RTN","PSOORFI3",75,0)
 K DOENT S DS=1
"RTN","PSOORFI3",76,0)
 F I=0:0 S I=$O(^PS(52.41,ORD,1,I)) Q:'I  S DOSE=$G(^PS(52.41,ORD,1,I,1)),DOSE1=$G(^(2)) D  D DOSE1
"RTN","PSOORFI3",77,0)
 .S PSONEW("DOSE",I)=$P(DOSE1,"^"),PSONEW("DOSE ORDERED",I)=$P(DOSE1,"^",2),PSONEW("UNITS",I)=$P(DOSE,"^",9),PSONEW("NOUN",I)=$P(DOSE,"^",5)
"RTN","PSOORFI3",78,0)
 .S:$P(DOSE,"^",9) UNITS=$P(^PS(50.607,$P(DOSE,"^",9),0),"^")
"RTN","PSOORFI3",79,0)
 .S PSONEW("VERB",I)=$P(DOSE,"^",10),PSONEW("ROUTE",I)=$P(DOSE,"^",8)
"RTN","PSOORFI3",80,0)
 .S ROUTE="" S:$P(DOSE,"^",8) ROUTE=$P(^PS(51.2,$P(DOSE,"^",8),0),"^") ;PSO*7*384
"RTN","PSOORFI3",81,0)
 .S PSONEW("SCHEDULE",I)=$P(DOSE,"^"),PSONEW("DURATION",I)=$P(DOSE,"^",2)
"RTN","PSOORFI3",82,0)
 .S DOENT=$G(DOENT)+1 S PSONEW("CONJUNCTION",I)=$S($P(DOSE,"^",6)="A":"AND",$P(DOSE,"^",6)="S":"THEN",$P(DOSE,"^",6)="X":"EXCEPT",1:"")
"RTN","PSOORFI3",83,0)
 .I 'PSONEW("DOSE ORDERED",I),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOORFI3",84,0)
 .S:$G(DS) IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (3)"
"RTN","PSOORFI3",85,0)
 S PSONEW("ENT")=DOENT K DOSE,DOSE1,I,UNITS,ROUTE,DOENT
"RTN","PSOORFI3",86,0)
 Q
"RTN","PSOORFI3",87,0)
DOSE1 I $G(DS)=1 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"        *Dosage:" D FMD G DU
"RTN","PSOORFI3",88,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="            *Dosage:" D FMD
"RTN","PSOORFI3",89,0)
DU I 'PSONEW("DOSE ORDERED",I),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Oth. Lang. Dosage: "_$G(PSONEW("ODOSE",I))
"RTN","PSOORFI3",90,0)
 I PSONEW("DOSE ORDERED",I),$G(PSONEW("VERB",I))]"" D
"RTN","PSOORFI3",91,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOORFI3",92,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     Dispense Units: "_$S($E(PSONEW("DOSE ORDERED",I),1)=".":"0",1:"")_PSONEW("DOSE ORDERED",I)
"RTN","PSOORFI3",93,0)
 I PSONEW("NOUN",I) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Noun: "_PSONEW("NOUN",I)
"RTN","PSOORFI3",94,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="             *Route: "_$G(ROUTE)
"RTN","PSOORFI3",95,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          *Schedule: "_PSONEW("SCHEDULE",I)
"RTN","PSOORFI3",96,0)
 I $P(DOSE,"^",2)]"" D
"RTN","PSOORFI3",97,0)
 .S DUR=$S($E($P(DOSE,"^",2),1)'?.N:$E($P(DOSE,"^",2),2,99)_$E($P(DOSE,"^",2),1),1:$P(DOSE,"^",2))
"RTN","PSOORFI3",98,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          *Duration: "_DUR_" ("_$S($P(DOSE,"^",2)["M":"MINUTES",$P(DOSE,"^",2)["H":"HOURS",$P(DOSE,"^",2)["L":"MONTHS",$P(DOSE,"^",2)["W":"WEEKS",1:"DAYS")_")"
"RTN","PSOORFI3",99,0)
 I $P(DOSE,"^",6)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       *Conjunction: "_$S($P(DOSE,"^",6)="A":"AND",$P(DOSE,"^",6)="S":"THEN",$P(DOSE,"^",6)="X":"EXCEPT",1:"")
"RTN","PSOORFI3",100,0)
 Q
"RTN","PSOORFI3",101,0)
DOSE2 ;displays pending order after edits
"RTN","PSOORFI3",102,0)
 S DS=1
"RTN","PSOORFI3",103,0)
 F I=1:1:PSONEW("ENT") Q:'I  D  D DOSE3 K COJ
"RTN","PSOORFI3",104,0)
 .S:$G(PSONEW("UNITS",I))]"" UNITS=$P(^PS(50.607,PSONEW("UNITS",I),0),"^") S:$G(PSONEW("ROUTE",I))]"" ROUTE=$P(^PS(51.2,PSONEW("ROUTE",I),0),"^")
"RTN","PSOORFI3",105,0)
 .S DUR=$G(PSONEW("DURATION",I)) S:$G(PSONEW("CONJUNCTION",I))]"" COJ=PSONEW("CONJUNCTION",I)
"RTN","PSOORFI3",106,0)
 .S NOUN=PSONEW("NOUN",I),VERB=$G(PSONEW("VERB",I))
"RTN","PSOORFI3",107,0)
 .I 'PSONEW("DOSE ORDERED",I),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Oth. Lang. Dosage: "_$G(PSONEW("ODOSE",I))
"RTN","PSOORFI3",108,0)
 .I '$G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOORFI3",109,0)
 .S:$G(DS) IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (3)"
"RTN","PSOORFI3",110,0)
 K I,UNITS,ROUTE,DUR,COJ,VERB,NOUN
"RTN","PSOORFI3",111,0)
 Q
"RTN","PSOORFI3",112,0)
DOSE3 I $G(DS)=1 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"        *Dosage:" D FMD G DO
"RTN","PSOORFI3",113,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="            *Dosage:" D FMD
"RTN","PSOORFI3",114,0)
DO I 'PSONEW("DOSE ORDERED",I),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Oth. Lang. Dosage: "_$G(PSONEW("ODOSE",I))
"RTN","PSOORFI3",115,0)
 I $G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOORFI3",116,0)
 I $G(PSONEW("DOSE ORDERED",I)) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     Dispense Units: "_$S($E(PSONEW("DOSE ORDERED",I),1)=".":"0",1:"")_PSONEW("DOSE ORDERED",I)
"RTN","PSOORFI3",117,0)
 I $G(PSONEW("DOSE ORDERED",I)) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               NOUN: "_PSONEW("NOUN",I)
"RTN","PSOORFI3",118,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="             *Route: "_$G(ROUTE)
"RTN","PSOORFI3",119,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          *Schedule: "_PSONEW("SCHEDULE",I)
"RTN","PSOORFI3",120,0)
 I $G(DUR)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          *Duration: "_DUR_" ("_$S(DUR["M":"MINUTES",DUR["H":"HOURS",DUR["L":"MONTHS",DUR["W":"WEEKS",1:"DAYS")_")"
"RTN","PSOORFI3",121,0)
 I $G(COJ)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       *Conjunction: "_$S(COJ="A":"AND",COJ="T":"THEN",COJ="X":"EXCEPT",1:"")
"RTN","PSOORFI3",122,0)
 Q
"RTN","PSOORFI3",123,0)
FMD Q:$G(PSONEW("DOSE",II))']""  S MIG=PSONEW("DOSE",II)
"RTN","PSOORFI3",124,0)
 I $E(MIG,1)=".",$G(PSONEW("DOSE ORDERED",II)) S MIG="0"_MIG
"RTN","PSOORFI3",125,0)
 F SG=1:1:$L(MIG," ") S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORFI3",126,0)
 I $G(UNITS)]"" S:$L(^TMP("PSOPO",$J,IEN,0)_" ("_UNITS_")")>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" ("_UNITS_")"
"RTN","PSOORFI3",127,0)
 K DS,MIG,SG
"RTN","PSOORFI3",128,0)
 I '$G(PSONEW("DOSE ORDERED",II)),$P($G(^PS(55,PSODFN,"LAN")),"^") D LAN^PSOORED5
"RTN","PSOORFI3",129,0)
 Q
"RTN","PSOORFI3",130,0)
SQR ;
"RTN","PSOORFI3",131,0)
 D SQR^PSOORFIN
"RTN","PSOORFI3",132,0)
 Q
"RTN","PSOORFI3",133,0)
SQN ;
"RTN","PSOORFI3",134,0)
 K MAXRF,PSOSIG,MPSDY,PSOMAX,STA,PSORX0,ORCHK,ORDRG
"RTN","PSOORFI3",135,0)
 I $G(PSOQUIT) S PSOQQ=1 K PSOQUIT
"RTN","PSOORFI3",136,0)
 Q
"RTN","PSOORFI5")
0^9^B76809208^B48135325
"RTN","PSOORFI5",1,0)
PSOORFI5 ;BIR/SJA-finish cprs orders ; 8/27/08 4:47pm
"RTN","PSOORFI5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**225,315,266,391,372,416,504,505**;DEC 1997;Build 39
"RTN","PSOORFI5",3,0)
 ;External references UL^PSSLOCK supported by DBIA 2789
"RTN","PSOORFI5",4,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSOORFI5",5,0)
 ;
"RTN","PSOORFI5",6,0)
FLG W ! K MEDP,MEDA,POERR("DFLG"),DIR D KQ S PSOSORT="FLAGGED^FLAGGED"
"RTN","PSOORFI5",7,0)
 N SECSORT S SECSORT=$$DIR^PSOORFI6("FL:FLAGGED","FLAGGED") Q:SECSORT=U
"RTN","PSOORFI5",8,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFI5",9,0)
 .Q:'$D(^PS(52.41,PSOD,0))!('$P($G(^PS(52.41,PSOD,0)),"^",23))
"RTN","PSOORFI5",10,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFI5",11,0)
 .I PAT'=PATA K PSORX("DOSING OFF") I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",12,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",13,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG,PSOQQ Q
"RTN","PSOORFI5",14,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFI5",15,0)
 .I SECSORT'=0,'$$CHKFLTR^PSOORFI6(PSOD,SECSORT) Q
"RTN","PSOORFI5",16,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFI5",17,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFI5",18,0)
 .S PAT(PAT)=PAT
"RTN","PSOORFI5",19,0)
 .F ORD=0:0 S ORD=$O(^PS(52.41,"AOR",PAT,PSOPINST,ORD)) Q:'ORD!($G(POERR("QFLG")))!($G(PSOQQ))  D
"RTN","PSOORFI5",20,0)
 ..I SECSORT'=0,'$$CHKFLTR^PSOORFI6(ORD,SECSORT) Q
"RTN","PSOORFI5",21,0)
 ..I $P($G(^PS(52.41,ORD,0)),"^",23) D PP,LK1,ORD^PSOORFIN
"RTN","PSOORFI5",22,0)
 .S X=PAT D ULP K PSOQQ
"RTN","PSOORFI5",23,0)
 I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",24,0)
 I $G(PSOQUIT) K PSOQUIT D EX G ^PSOORFIN
"RTN","PSOORFI5",25,0)
 G EX
"RTN","PSOORFI5",26,0)
 ;
"RTN","PSOORFI5",27,0)
SUP W ! K MEDP,MEDA,POERR("DFLG"),DIR D KQ S PSOSORT="SUPPLY^SUPPLY"
"RTN","PSOORFI5",28,0)
 N SECSORT S SECSORT=$$DIR^PSOORFI6("SU:SUPPLY","SUPPLY") Q:SECSORT=U
"RTN","PSOORFI5",29,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFI5",30,0)
 .Q:'$D(^PS(52.41,PSOD,0))!('$$ISSUPPLY^PSOORFI6(PSOD))
"RTN","PSOORFI5",31,0)
 .I SECSORT'=0,'$$CHKFLTR^PSOORFI6(PSOD,SECSORT) Q
"RTN","PSOORFI5",32,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFI5",33,0)
 .I PAT'=PATA K PSORX("DOSING OFF") I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",34,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",35,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG,PSOQQ Q
"RTN","PSOORFI5",36,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFI5",37,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFI5",38,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFI5",39,0)
 .S PAT(PAT)=PAT
"RTN","PSOORFI5",40,0)
 .F ORD=0:0 S ORD=$O(^PS(52.41,"AOR",PAT,PSOPINST,ORD)) Q:'ORD!($G(POERR("QFLG")))!($G(PSOQQ))  D
"RTN","PSOORFI5",41,0)
 ..Q:$P($G(^PS(52.41,ORD,0)),"^",23)
"RTN","PSOORFI5",42,0)
 ..Q:'$$ISSUPPLY^PSOORFI6(ORD)
"RTN","PSOORFI5",43,0)
 ..I SECSORT'=0,'$$CHKFLTR^PSOORFI6(ORD,SECSORT) Q
"RTN","PSOORFI5",44,0)
 ..D PP,LK1,ORD^PSOORFIN
"RTN","PSOORFI5",45,0)
 .S X=PAT D ULP K PSOQQ
"RTN","PSOORFI5",46,0)
 I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",47,0)
 I $G(PSOQUIT) K PSOQUIT D EX G ^PSOORFIN
"RTN","PSOORFI5",48,0)
 G EX
"RTN","PSOORFI5",49,0)
 Q
"RTN","PSOORFI5",50,0)
PRI ; Called from PSOORFIN due to it's routine size.
"RTN","PSOORFI5",51,0)
 K DIR S PSOSORT="PRIORITY"
"RTN","PSOORFI5",52,0)
 S DIR("A")="Select Priority",DIR(0)="SBM^S:STAT;E:EMERGENCY;R:ROUTINE",DIR("B")="ROUTINE"
"RTN","PSOORFI5",53,0)
 D ^DIR G:$D(DIRUT) EX S PSOSORT=PSOSORT_"^"_Y,PSRT=Y
"RTN","PSOORFI5",54,0)
 N SECSORT S SECSORT=$$DIR^PSOORFI6("PR:PRIORITY",Y) Q:SECSORT=U
"RTN","PSOORFI5",55,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFI5",56,0)
 .Q:$P($G(^PS(52.41,PSOD,0)),"^",23)
"RTN","PSOORFI5",57,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFI5",58,0)
 .;PSO*7*266
"RTN","PSOORFI5",59,0)
 .I PAT'=PATA K PSORX("DOSING OFF") D LBL^PSOORFIN
"RTN","PSOORFI5",60,0)
 .I '$O(^PS(52.41,"AP",PAT,PSRT,0)) S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",61,0)
 .D PRI^PSOORFI2 I $G(PSZFIN) S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",62,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",63,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP Q
"RTN","PSOORFI5",64,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFI5",65,0)
 .I SECSORT'=0,'$$CHKFLTR^PSOORFI6(PSOD,SECSORT) Q
"RTN","PSOORFI5",66,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFI5",67,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFI5",68,0)
 .D PP S ORD=0 D @PSRT S PAT(PAT)=PAT
"RTN","PSOORFI5",69,0)
 .S X=PAT D ULP
"RTN","PSOORFI5",70,0)
 ;PSO*7*266
"RTN","PSOORFI5",71,0)
 D LBL^PSOORFIN
"RTN","PSOORFI5",72,0)
 I $G(PSOQUIT) K PSOQUIT D EX G ^PSOORFIN
"RTN","PSOORFI5",73,0)
EX D EX^PSOORFI1
"RTN","PSOORFI5",74,0)
 Q
"RTN","PSOORFI5",75,0)
LK D LOCK^PSOORFI1
"RTN","PSOORFI5",76,0)
 Q
"RTN","PSOORFI5",77,0)
LK1 D LOCK1^PSOORFI1 Q
"RTN","PSOORFI5",78,0)
QU I $G(PSOQUIT) S POERR("QFLG")=1 K PSOQUIT
"RTN","PSOORFI5",79,0)
 S:$G(PSOQFLG) PAT(PAT)=PAT
"RTN","PSOORFI5",80,0)
 Q
"RTN","PSOORFI5",81,0)
ULP K PSORX("MAIL/WINDOW"),PSORX("METHOD OF PICK-UP")
"RTN","PSOORFI5",82,0)
 D CLEAN^PSOVER1
"RTN","PSOORFI5",83,0)
 I '$G(X) Q
"RTN","PSOORFI5",84,0)
 D UL^PSSLOCK(X) Q
"RTN","PSOORFI5",85,0)
KLL K PSOPTLOK
"RTN","PSOORFI5",86,0)
 Q
"RTN","PSOORFI5",87,0)
KLLP K PSONOLCK
"RTN","PSOORFI5",88,0)
 Q
"RTN","PSOORFI5",89,0)
SPL D SPL^PSOORFI4
"RTN","PSOORFI5",90,0)
 Q
"RTN","PSOORFI5",91,0)
SDFN S PSODFN=+$G(PSODFN)
"RTN","PSOORFI5",92,0)
 Q
"RTN","PSOORFI5",93,0)
PP D PP^PSOORFI4
"RTN","PSOORFI5",94,0)
 Q
"RTN","PSOORFI5",95,0)
KQ K PSOQUIT,POERR("QFLG")
"RTN","PSOORFI5",96,0)
 Q
"RTN","PSOORFI5",97,0)
S D S^PSOORFI2 ; Process STAT priority
"RTN","PSOORFI5",98,0)
 Q
"RTN","PSOORFI5",99,0)
 ;
"RTN","PSOORFI5",100,0)
E D E^PSOORFI2 ; Process EMERGENCY priority
"RTN","PSOORFI5",101,0)
 Q
"RTN","PSOORFI5",102,0)
 ;
"RTN","PSOORFI5",103,0)
R D R^PSOORFI2 ; Process ROUTINE priority
"RTN","PSOORFI5",104,0)
 Q
"RTN","PSOORFI5",105,0)
 ;
"RTN","PSOORFI5",106,0)
LMDISP(ORD) ; Backdoor ListManager Display of Flag/Unflag Information
"RTN","PSOORFI5",107,0)
 N FLAG
"RTN","PSOORFI5",108,0)
 K FLAGLINE S ORD=+$G(ORD) I 'ORD Q
"RTN","PSOORFI5",109,0)
 ;
"RTN","PSOORFI5",110,0)
 I '$G(^PS(52.41,ORD,"FLG")) Q
"RTN","PSOORFI5",111,0)
 ; S X=IORVON_"Flagged"_IORVOFF
"RTN","PSOORFI5",112,0)
 D GETS^DIQ(52.41,ORD,"33;34;35;36;37;38","IE","FLAG")
"RTN","PSOORFI5",113,0)
 S L1="Flagged by "_$E(FLAG(52.41,ORD_",",34,"E"),1,30)_" on "_$$FMTE^XLFDT(FLAG(52.41,ORD_",",33,"I"),2)_": "
"RTN","PSOORFI5",114,0)
 S LEN=80-$L(L1),L1=L1_$E(FLAG(52.41,ORD_",",35,"E"),1,LEN),L2=$E(FLAG(52.41,ORD_",",35,"E"),LEN+1,999)
"RTN","PSOORFI5",115,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=L1,FLAGLINE(IEN)=7
"RTN","PSOORFI5",116,0)
 I L2'="" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=L2
"RTN","PSOORFI5",117,0)
 I FLAG(52.41,ORD_",",36,"I")'="" D
"RTN","PSOORFI5",118,0)
 . S L1="Unflagged by "_$E(FLAG(52.41,ORD_",",37,"E"),1,30)_" on "_$$FMTE^XLFDT(FLAG(52.41,ORD_",",36,"I"),2)_": "
"RTN","PSOORFI5",119,0)
 . S LEN=80-$L(L1),L1=L1_$E(FLAG(52.41,ORD_",",38,"E"),1,LEN),L2=$E(FLAG(52.41,ORD_",",38,"E"),LEN+1,999)
"RTN","PSOORFI5",120,0)
 . S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=L1,FLAGLINE(IEN)=9
"RTN","PSOORFI5",121,0)
 . I L2'="" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=L2
"RTN","PSOORFI5",122,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" "
"RTN","PSOORFI5",123,0)
 Q
"RTN","PSOORFI5",124,0)
 ;
"RTN","PSOORFI5",125,0)
CS ; Digitally Signed CS - PSO*7*391
"RTN","PSOORFI5",126,0)
 K DIR N PSOCSRT S DIR("A")="Route",DIR(0)="SBM^W:WINDOW;M:MAIL;B:BOTH;E:EXIT",DIR("B")="BOTH" D ^DIR
"RTN","PSOORFI5",127,0)
 Q:$D(DIRUT)!(Y="E")
"RTN","PSOORFI5",128,0)
 S PSOCSRT=$S(Y="B":1,1:Y)
"RTN","PSOORFI5",129,0)
 W !!,"Select a schedule(s)"
"RTN","PSOORFI5",130,0)
 K DIR S PSOSORT="DIGITALLY SIGNED"
"RTN","PSOORFI5",131,0)
 S DIR("A")="Select Schedule(s)",DIR(0)="S^1:SCHEDULE II;2:SCHEDULES III - V;3:SCHEDULES II - V;4:NON-CS+SCHEDULES III - V;5:NON-CS ONLY;E:EXIT",DIR("B")=3
"RTN","PSOORFI5",132,0)
 D ^DIR G:$D(DIRUT)!(Y="E") EX S PSOSORT=PSOSORT_"^"_Y,PSRT=Y
"RTN","PSOORFI5",133,0)
 N SECSORT S SECSORT=$$DIR^PSOORFI6("CS:CONTROLLED SUBSTANCES",Y) Q:SECSORT=U
"RTN","PSOORFI5",134,0)
 N PDEA,OR0 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFI5",135,0)
 .Q:'$D(^PS(52.41,PSOD,0))
"RTN","PSOORFI5",136,0)
 .S OR0=^PS(52.41,PSOD,0)
"RTN","PSOORFI5",137,0)
 .;PSO*7*505 - still quit if the order is flagged, but now only look for digital signature if the selection does not ask for non contolled substances
"RTN","PSOORFI5",138,0)
 .Q:$P(OR0,"^",23)
"RTN","PSOORFI5",139,0)
 .S PDEA=0 D PDEA Q:'PDEA!(PDEA'=PSRT)
"RTN","PSOORFI5",140,0)
 .;PSO*7*505 moved digitally signed check after the DEA check
"RTN","PSOORFI5",141,0)
 .I PSRT<4,'$P(OR0,"^",24) Q
"RTN","PSOORFI5",142,0)
 .I 'PSOCSRT,PSOCSRT'=$P(OR0,"^",17) Q
"RTN","PSOORFI5",143,0)
 .Q:$G(PAT($P(OR0,"^",2)))=$P(OR0,"^",2)  S PAT=$P(OR0,"^",2)
"RTN","PSOORFI5",144,0)
 .I PAT'=PATA K PSORX("DOSING OFF") I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",145,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",146,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG,PSOQQ Q
"RTN","PSOORFI5",147,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFI5",148,0)
 .I SECSORT'=0,'$$CHKFLTR^PSOORFI6(PSOD,SECSORT) Q
"RTN","PSOORFI5",149,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFI5",150,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFI5",151,0)
 .S PAT(PAT)=PAT
"RTN","PSOORFI5",152,0)
 .F ORD=0:0 S ORD=$O(^PS(52.41,"AOR",PAT,PSOPINST,ORD)) Q:'ORD!($G(POERR("QFLG")))!($G(PSOQQ))  D
"RTN","PSOORFI5",153,0)
 ..Q:'$D(^PS(52.41,ORD,0))
"RTN","PSOORFI5",154,0)
 ..S OR0=^PS(52.41,ORD,0)
"RTN","PSOORFI5",155,0)
 ..;PSO*505 - Move the check for digitally signed, so non-cs substances will be shown if selected as sort criteria
"RTN","PSOORFI5",156,0)
 ..Q:$P(OR0,U,23)
"RTN","PSOORFI5",157,0)
 ..I SECSORT'=0,'$$CHKFLTR^PSOORFI6(ORD,SECSORT) Q
"RTN","PSOORFI5",158,0)
 ..I 'PSOCSRT,PSOCSRT'=$P(OR0,"^",17) Q
"RTN","PSOORFI5",159,0)
 ..Q:$P(OR0,"^",3)="DC"!($P(OR0,"^",3)="DE")
"RTN","PSOORFI5",160,0)
 ..S PDEA=0 D PDEA Q:'PDEA!(PDEA'=PSRT)
"RTN","PSOORFI5",161,0)
 ..I PSRT<4,'$P(OR0,"^",24) Q
"RTN","PSOORFI5",162,0)
 ..D PP,LK1,ORD^PSOORFIN
"RTN","PSOORFI5",163,0)
 .S X=PAT D ULP K PSOQQ
"RTN","PSOORFI5",164,0)
 I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",165,0)
 I $G(PSOQUIT) K PSOQUIT D EX G ^PSOORFIN
"RTN","PSOORFI5",166,0)
 G EX
"RTN","PSOORFI5",167,0)
 ;
"RTN","PSOORFI5",168,0)
PDEA ;
"RTN","PSOORFI5",169,0)
 I +$P(OR0,"^",9) S PDEA=$P($G(^PSDRUG($P(OR0,"^",9),0)),"^",3),PDEA=$S(PDEA[2:1,PDEA[3!(PDEA[4)!(PDEA[5):2,1:0)
"RTN","PSOORFI5",170,0)
 E  S PDEA=$$OIDEA^PSSUTLA1($P(OR0,"^",8),"O")
"RTN","PSOORFI5",171,0)
 ; PSO*7*505 - adding checks for new sort criteria
"RTN","PSOORFI5",172,0)
 ; PDEA=0 OR 2, covers non-cs and schedule 3-5
"RTN","PSOORFI5",173,0)
 I (PDEA=0)!(PDEA=2),PSRT=4 S PDEA=4 Q
"RTN","PSOORFI5",174,0)
 I PDEA=0,PSRT=5 S PDEA=5 Q
"RTN","PSOORFI5",175,0)
 ; PSO*7*505 end
"RTN","PSOORFI5",176,0)
 I PDEA,PSRT=3 S PDEA=3
"RTN","PSOORFI5",177,0)
 Q
"RTN","PSOORFI5",178,0)
 ;
"RTN","PSOORFI5",179,0)
PRV(PROV,DRG,ORN) ;
"RTN","PSOORFI5",180,0)
 N DETN,DEA,I,LBL,VADD,SPC
"RTN","PSOORFI5",181,0)
 I PROV="" Q
"RTN","PSOORFI5",182,0)
 S DEA=$S($G(ORN):$$RXDEA^PSOUTIL(,ORN),1:$$DEA^XUSER(0,PROV))
"RTN","PSOORFI5",183,0)
 S LBL=$S(DEA["-":" VA#: ",1:"DEA#: ") I $G(ADDS) S LBL=" "_LBL
"RTN","PSOORFI5",184,0)
 I DRG,$$DETOX^PSSOPKI(DRG) S DETN=$S($G(ORN):$$RXDETOX^PSOUTIL(,ORN),1:$$DETOX^XUSER(PROV))
"RTN","PSOORFI5",185,0)
 S $P(SPC," ",($S($G(ADDS):30,1:33)-$L(DEA)))=" "
"RTN","PSOORFI5",186,0)
 I (DEA'="")!($G(DETN)'="") S IEN=IEN+1,$E(^TMP("PSOPO",$J,IEN,0),16)=LBL_DEA_$S($G(DETN)]"":SPC_"DETOX#: "_$G(DETN),1:"")
"RTN","PSOORFI5",187,0)
 I $G(ORN) D PRVAD^PSOPKIV2 I $G(VADD(1))]"" D
"RTN","PSOORFI5",188,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(ADDS):" ",1:"")_"       Site Address: "_VADD(1)
"RTN","PSOORFI5",189,0)
 .S:VADD(2)'="" IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(ADDS):" ",1:"")_"                     "_VADD(2) S:VADD(3)'="" IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(ADDS):" ",1:"")_"                     "_VADD(3)
"RTN","PSOORFI5",190,0)
 Q
"RTN","PSOORFI5",191,0)
 ;
"RTN","PSOORFI6")
0^10^B120103085^B23497771
"RTN","PSOORFI6",1,0)
PSOORFI6 ;BIR/SJA-finish cprs orders cont. ;01/05/07
"RTN","PSOORFI6",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**225,505**;DEC 1997;Build 39
"RTN","PSOORFI6",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORFI6",4,0)
 ;External references PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOORFI6",5,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSOORFI6",6,0)
 ;
"RTN","PSOORFI6",7,0)
DC N ACTION,LST,PSI,PSODFLG,PSONOORS,PSOOPT
"RTN","PSOORFI6",8,0)
 N VALMCNT W ! K DIR,DUOUT,DIROUT,DTOUT,PSOELSE
"RTN","PSOORFI6",9,0)
 I '$G(PSOERR("DEAD")) S PSOELSE=1 D PDATA Q:$D(DUOUT)!$D(DTOUT)  D  Q:$D(DIRUT)
"RTN","PSOORFI6",10,0)
 .D NOOR^PSOCAN4 Q:$D(DIRUT)
"RTN","PSOORFI6",11,0)
 .S DIR("A")="Comments",DIR(0)="F^10:75",DIR("B")="Per Pharmacy Request" D ^DIR K DIR
"RTN","PSOORFI6",12,0)
 I '$G(PSOELSE) K PSOELSE S PSONOOR="A" D DE^PSOORFI2 I '$G(ACTION)!('$D(PSODFLG)) S VALMBCK="R" Q
"RTN","PSOORFI6",13,0)
 K PSOELSE I $D(DIRUT) K DIRUT,DUOUT,DTOUT,Y Q
"RTN","PSOORFI6",14,0)
 S ACOM=Y
"RTN","PSOORFI6",15,0)
 S INCOM=ACOM,PSONOORS=PSONOOR D DE^PSOORFI2
"RTN","PSOORFI6",16,0)
 I '$G(ACTION)!('$D(PSODFLG)) Q
"RTN","PSOORFI6",17,0)
 S PSONOOR=PSONOORS D RTEST D SPEED D ULP^PSOCAN
"RTN","PSOORFI6",18,0)
 K PSOCAN,ACOM,INCOM,ACTION,LINE,PSONOOR,PSOSDXY,PSONOORS,PSOOPT,RXCNT,REA,RX,PSODA,DRG
"RTN","PSOORFI6",19,0)
 S Y=-1
"RTN","PSOORFI6",20,0)
 Q
"RTN","PSOORFI6",21,0)
PSPEED S (YY,PSODA)=$P(PSOSD(STA,DRG),"^"),RX=$P($G(^PSRX(PSODA,0)),"^") D SPEED1 Q:PSPOP!($D(PSINV(RX)))
"RTN","PSOORFI6",22,0)
 Q:$G(SPEED)&(REA="R")
"RTN","PSOORFI6",23,0)
SHOW S DRG=+$P(^PSRX(PSODA,0),"^",6),DRG=$S($D(^PSDRUG(DRG,0)):$P(^(0),"^"),1:"")
"RTN","PSOORFI6",24,0)
 S LC=0 W !,$P(^PSRX(PSODA,0),"^"),"  ",DRG,?52,$S($D(^DPT(+$P(^PSRX(PSODA,0),"^",2),0)):$P(^(0),"^"),1:"PATIENT UNKNOWN")
"RTN","PSOORFI6",25,0)
 I REA="C" W !?25,"Rx to be Discontinued",! Q
"RTN","PSOORFI6",26,0)
 W !?21,"*** Rx to be Reinstated ***",!
"RTN","PSOORFI6",27,0)
 Q
"RTN","PSOORFI6",28,0)
SPEED1 S PSPOP=0 I $G(PSODIV),+$P($G(^PSRX(PSODA,2)),"^",9)'=$G(PSOSITE) D:'$G(SPEED) DIV^PSOCAN
"RTN","PSOORFI6",29,0)
 K STAT S STAT=+$P(^PSRX(PSODA,"STA"),"^"),REA=$E("C00CCCCCCCCCR000C",STAT+1)
"RTN","PSOORFI6",30,0)
 Q:$G(SPEED)&(REA="R")
"RTN","PSOORFI6",31,0)
 I REA="R",$P($G(^PSRX(PSODA,"PKI")),"^") S PKI=1 S PSINV(RX)="" Q
"RTN","PSOORFI6",32,0)
 I REA=0!(PSPOP)!($P(^PSRX(+YY,"STA"),"^")>12),$P(^("STA"),"^")<16 S PSINV(RX)="" Q
"RTN","PSOORFI6",33,0)
 S:REA'=0&('PSPOP) PSCAN(RX)=PSODA_"^"_REA,RXCNT=$G(RXCNT)+1
"RTN","PSOORFI6",34,0)
 Q
"RTN","PSOORFI6",35,0)
SPEED N PKI K PSINV,PSCAN S PSODA=IN I $D(^PSRX(PSODA,0)) S YY=PSODA,RX=$P(^(0),"^") S:PSODA<0 PSINV(RX)="" D:PSODA>0 SPEED1
"RTN","PSOORFI6",36,0)
 G:'$D(PSCAN) INVALD S II="",RXCNT=0 F  S II=$O(PSCAN(II)) Q:II=""  S PSODA=+PSCAN(II),REA=$P(PSCAN(II),"^",2),RXCNT=RXCNT+1 D SHOW
"RTN","PSOORFI6",37,0)
 ;
"RTN","PSOORFI6",38,0)
ASK G:'$D(PSCAN) INVALD W ! S DIR("A")="OK to "_$S($G(RXCNT)>1:"Change Status",REA="C":"Discontinue the active order",1:"Reinstate"),DIR(0)="Y",DIR("B")="N"
"RTN","PSOORFI6",39,0)
 D ^DIR K DIR I $D(DIRUT) S:$O(PSOSDX(0)) PSOSDXY=1 Q
"RTN","PSOORFI6",40,0)
 I 'Y S:$O(PSOSDX(0)) PSOSDXY=1 K PSCAN D INVALD Q
"RTN","PSOORFI6",41,0)
 S RX="" F  S RX=$O(PSCAN(RX)) Q:RX=""  D PSOL^PSSLOCK(+PSCAN(RX)) I $G(PSOMSG) D ACT D PSOUL^PSSLOCK(+PSCAN(RX))
"RTN","PSOORFI6",42,0)
 D INVALD
"RTN","PSOORFI6",43,0)
 Q
"RTN","PSOORFI6",44,0)
ACT S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2),II=RX,PSODFN=$P(^PSRX(DA,0),"^",2) I REA="R" D REINS^PSOCAN2 Q
"RTN","PSOORFI6",45,0)
 S PSOOPT=-1 D CAN^PSOCAN
"RTN","PSOORFI6",46,0)
 Q
"RTN","PSOORFI6",47,0)
INVALD K PSCAN Q:'$D(PSINV)  W !! F I=1:1:80 W "="
"RTN","PSOORFI6",48,0)
 W $C(7),!!,"The Following Rx Number(s) Are Invalid Choices, Expired, "_$S($G(PKI):"Digitally Signed",1:""),!,"Discontinued by Provider, or Marked As Deleted:" S II="" F  S II=$O(PSINV(II)) Q:II=""  W !?10,II
"RTN","PSOORFI6",49,0)
 K PSINV I $G(PSOERR)!($G(SPEED)) K DIR,DUOUT,DTOUT,DIRUT S DIR(0)="E",DIR("A")="Press Return to Continue"
"RTN","PSOORFI6",50,0)
 D ^DIR K DIR,DTOUT,DIRUT,DUOUT
"RTN","PSOORFI6",51,0)
KILL D KILL^PSOCAN2
"RTN","PSOORFI6",52,0)
 K PSOMSG,PSOPLCK,PSOWUN,PSOULRX
"RTN","PSOORFI6",53,0)
 Q
"RTN","PSOORFI6",54,0)
RTEST ;
"RTN","PSOORFI6",55,0)
 Q:'$G(LINE)
"RTN","PSOORFI6",56,0)
 N PCIN,PCINFLAG,PCINX
"RTN","PSOORFI6",57,0)
 S PCINFLAG=0 F PCIN=1:1 S PCINX=$P(LINE,",",PCIN) Q:$P(LINE,",",PCIN)']""  D
"RTN","PSOORFI6",58,0)
 .Q:'$G(PCINX)
"RTN","PSOORFI6",59,0)
 .Q:'$G(PSOCAN(PCINX))
"RTN","PSOORFI6",60,0)
 .I $P($G(^PSRX(+$G(PSOCAN(PCINX)),"STA")),"^")'=12,'$G(PCINFLAG) S PSOCANRD=+$P($G(^PSRX($G(PSOCAN(PCINX)),0)),"^",4) S PCINFLAG=1
"RTN","PSOORFI6",61,0)
 I '$G(PCINFLAG) S PSOCANRZ=1
"RTN","PSOORFI6",62,0)
 Q
"RTN","PSOORFI6",63,0)
RTESTA ;
"RTN","PSOORFI6",64,0)
 N PFIN,PFINZ,PFINFLAG
"RTN","PSOORFI6",65,0)
 S PFINFLAG=0 S PFIN="" F  S PFIN=$O(PSOSD(PFIN)) Q:PFIN=""  S PFINZ="" F  S PFINZ=$O(PSOSD(PFIN,PFINZ)) Q:PFINZ=""  D
"RTN","PSOORFI6",66,0)
 .I $G(PFIN)'="PENDING" I $P($G(^PSRX(+$P($G(PSOSD(PFIN,PFINZ)),"^"),"STA")),"^")'=12,'$G(PFINFLAG) S PSOCANRD=+$P($G(^(0)),"^",4),PFINFLAG=1
"RTN","PSOORFI6",67,0)
 I '$G(PFINFLAG) S PSOCANRZ=1
"RTN","PSOORFI6",68,0)
 Q
"RTN","PSOORFI6",69,0)
PDATA Q:$P(^PS(52.41,ORD,0),"^",3)'="RNW"!('$P(^PS(52.41,ORD,0),"^",21))
"RTN","PSOORFI6",70,0)
 S PSI=0,IN=0 F  S PSI=$O(PSOLST(PSI)) Q:'PSI!(IN)  I $P(PSOLST(PSI),"^",2)=$P(^PS(52.41,ORD,0),"^",21) S LINE=PSI,(PSOCAN(PSI),IN)=$P(PSOLST(PSI),"^",2)
"RTN","PSOORFI6",71,0)
 Q:'$G(LINE)
"RTN","PSOORFI6",72,0)
 S:(+$G(^PSRX($P(^PS(52.41,ORD,0),"^",21),"STA"))<9) PSODFLG=1 Q:'$G(PSODFLG)
"RTN","PSOORFI6",73,0)
 D ASKDC S ACTION=Y
"RTN","PSOORFI6",74,0)
 Q
"RTN","PSOORFI6",75,0)
ASKDC W ! K DIR,DUOUT,DIRUT,DTOUT
"RTN","PSOORFI6",76,0)
 S DIR("A")="There is an active Rx for this pending order, Discontinue both (Y/N)",DIR("B")="NO",DIR(0)="Y"
"RTN","PSOORFI6",77,0)
 S DIR("?",1)="Y - Discontinue both pending and active Rx",DIR("?",2)="N - Discontinue pending order only"
"RTN","PSOORFI6",78,0)
 S DIR("?")="'^' - Quit (no action taken)" D ^DIR K DIR Q
"RTN","PSOORFI6",79,0)
 ; INPUT
"RTN","PSOORFI6",80,0)
 ; FS - the first sort type that was done before calling into the secondary sort.
"RTN","PSOORFI6",81,0)
 ;    - EX: PA:PATIENT, RT:ROUTE, PR:PRIORITY ..
"RTN","PSOORFI6",82,0)
 ; FSVAL - the value associated with the first sort.
"RTN","PSOORFI6",83,0)
DIR(FSORT,FSVAL) ;
"RTN","PSOORFI6",84,0)
 N DIR,Y,RLINE,STAG,SVAL,RES,FILSTR,DONE,FILTER,FIRST,JCNT,J
"RTN","PSOORFI6",85,0)
 K DIR
"RTN","PSOORFI6",86,0)
 S DIR(0)="Y",DIR("B")="N"
"RTN","PSOORFI6",87,0)
 S DIR("A")="Would you like to select a secondary filter"
"RTN","PSOORFI6",88,0)
 D ^DIR K DIR I 'Y K Y Q 0
"RTN","PSOORFI6",89,0)
 I $G(FSORT)']"" S FILSTR="PA:PATIENT;RT:ROUTE;PR:PRIORITY;CL:CLINIC;FL:FLAGGED;CS:CONTROLLED SUBSTANCES;SU:SUPPLY;C:CONTINUE W/PRIMARY;E:EXIT"
"RTN","PSOORFI6",90,0)
 I '$L($G(FILSTR)) D
"RTN","PSOORFI6",91,0)
 .S (DONE,JCNT)=0
"RTN","PSOORFI6",92,0)
 .F J=1:1 D  Q:DONE
"RTN","PSOORFI6",93,0)
 ..S FILTER=$T(SCRIT+J) I FILTER=" Q" S DONE=1 Q
"RTN","PSOORFI6",94,0)
 ..S FILTER=$P(FILTER,";;",2)
"RTN","PSOORFI6",95,0)
 ..I $D(FSORT),FILTER=FSORT Q
"RTN","PSOORFI6",96,0)
 ..I $D(FSORT),FSORT="SU:SUPPLY",FILTER="CS:CONTROLLED SUBSTANCES" Q
"RTN","PSOORFI6",97,0)
 ..I $D(FSORT),FSORT="CS:CONTROLLED SUBSTANCES",FILTER="SU:SUPPLY" Q
"RTN","PSOORFI6",98,0)
 ..; set up default for DIR("B"), in our case we will use the first item in the list that is not equal
"RTN","PSOORFI6",99,0)
 ..; to the first sort that occured
"RTN","PSOORFI6",100,0)
 ..S JCNT=JCNT+1 I JCNT=1 S FIRST=FILTER
"RTN","PSOORFI6",101,0)
 ..I '$L($G(FILSTR)) S FILSTR=FILTER Q
"RTN","PSOORFI6",102,0)
 ..S FILSTR=$G(FILSTR)_";"_FILTER
"RTN","PSOORFI6",103,0)
 I $G(FIRST)']"" S FIRST="PA:PATIENT"
"RTN","PSOORFI6",104,0)
 S DIR("?")="^D ST^PSOORFI1("_""""_$P(FSORT,":")_""""_")",DIR("A")="Select another filter",DIR("B")=$P($G(FIRST),":",2)
"RTN","PSOORFI6",105,0)
 S DIR(0)="SMB"_U_FILSTR
"RTN","PSOORFI6",106,0)
 D ^DIR K DIR
"RTN","PSOORFI6",107,0)
 I $D(DIRUT)!(Y="E") Q U
"RTN","PSOORFI6",108,0)
 I Y="C" Q 0
"RTN","PSOORFI6",109,0)
 S RES=Y
"RTN","PSOORFI6",110,0)
 S RLINE=$S(RES="PA":"PAT",RES="RT":"RTE",RES="PR":"PRI",RES="CL":"CLIN",RES="FL":"FLG",RES="CS":"CS",RES="SU":"SUPPLY",1:"")
"RTN","PSOORFI6",111,0)
 I RLINE']"" Q 0
"RTN","PSOORFI6",112,0)
 S STAG=RLINE
"RTN","PSOORFI6",113,0)
 S SVAL=$$@STAG
"RTN","PSOORFI6",114,0)
 I SVAL=U Q U
"RTN","PSOORFI6",115,0)
 I SVAL=""!(SVAL=0) Q 0
"RTN","PSOORFI6",116,0)
 ; consider a message indicating that the secondary sort may cause delays/hang time before display
"RTN","PSOORFI6",117,0)
 Q RES_U_SVAL
"RTN","PSOORFI6",118,0)
PAT() ;
"RTN","PSOORFI6",119,0)
 N DIR,Y,PSOSORT,DIC,SEL
"RTN","PSOORFI6",120,0)
 S PSOSORT="PATIENT"
"RTN","PSOORFI6",121,0)
 S DIR("?")="^D PT^PSOORFI1",DIR("A")="All Patients or Single Patient",DIR(0)="SBM^A:ALL;S:SINGLE;E:EXIT",DIR("B")="SINGLE"
"RTN","PSOORFI6",122,0)
 D ^DIR K DIR
"RTN","PSOORFI6",123,0)
 S SEL=Y
"RTN","PSOORFI6",124,0)
 I $D(DIRUT)!(SEL="E") Q U
"RTN","PSOORFI6",125,0)
PRMT I SEL="S" D  Q PSOSORT
"RTN","PSOORFI6",126,0)
 .S PSOSORT=PSOSORT_U_"SINGLE"
"RTN","PSOORFI6",127,0)
 .S DIR(0)="FO^2:30",DIR("A")="Select Patient",DIR("?")="^D HELP^PSOORFI2" D ^DIR I $E(X)="?" S PSOSORT=0 Q
"RTN","PSOORFI6",128,0)
 .I $D(DIRUT) S PSOSORT=0 Q
"RTN","PSOORFI6",129,0)
 .S DIC(0)="EQM",DIC=2,DIC("S")="I $D(^PS(52.41,""AOR"",+Y,PSOPINST))"
"RTN","PSOORFI6",130,0)
 .D ^DIC K DIC
"RTN","PSOORFI6",131,0)
 .I "^"[X S PSOSORT=0 Q
"RTN","PSOORFI6",132,0)
 .S (PSODFN,PAT)=+Y,PSOFINY=Y
"RTN","PSOORFI6",133,0)
 .I $P(Y,U)<1 G PRMT
"RTN","PSOORFI6",134,0)
 .I $P(Y,U) S PSOSORT=PSOSORT_U_$P(Y,U),(PSODFN,PAT)=+Y,PSOFINY=Y
"RTN","PSOORFI6",135,0)
 I SEL="A" S PSOSORT=PSOSORT_U_"ALL"
"RTN","PSOORFI6",136,0)
 Q PSOSORT
"RTN","PSOORFI6",137,0)
RTE() ;
"RTN","PSOORFI6",138,0)
 N DIR,Y,PSOSORT
"RTN","PSOORFI6",139,0)
 K DIR S PSOSORT="ROUTE"
"RTN","PSOORFI6",140,0)
 S DIR("?")="^D RT^PSOORFI1",DIR("A")="Route",DIR(0)="SBM^W:WINDOW;M:MAIL;C:CLINIC;E:EXIT",DIR("B")="WINDOW"
"RTN","PSOORFI6",141,0)
 D ^DIR K DIR
"RTN","PSOORFI6",142,0)
 I $D(DIRUT)!(Y="E") Q U
"RTN","PSOORFI6",143,0)
 S PSOSORT=PSOSORT_"^"_Y
"RTN","PSOORFI6",144,0)
 Q PSOSORT
"RTN","PSOORFI6",145,0)
PRI() ;
"RTN","PSOORFI6",146,0)
 N DIR,Y,PSOSORT
"RTN","PSOORFI6",147,0)
 K DIR S PSOSORT="PRIORITY"
"RTN","PSOORFI6",148,0)
 S DIR("A")="Select Priority",DIR(0)="SBM^S:STAT;E:EMERGENCY;R:ROUTINE",DIR("B")="ROUTINE"
"RTN","PSOORFI6",149,0)
 D ^DIR K DIR
"RTN","PSOORFI6",150,0)
 I $D(DIRUT) Q U
"RTN","PSOORFI6",151,0)
 S PSOSORT=PSOSORT_"^"_Y
"RTN","PSOORFI6",152,0)
 Q PSOSORT
"RTN","PSOORFI6",153,0)
CLIN() ;
"RTN","PSOORFI6",154,0)
 K ^TMP($J,"PSOCL"),^TMP($J,"PSOCLX"),PSOCLIN,PSOCLINF,PSOXINST
"RTN","PSOORFI6",155,0)
 N PSOCFLAG,PSONPTRX,PSOINPTR,PSCLP,PSOCLINS,PSOSTC,PSOLGD,PSODIEN,PSOCTMP
"RTN","PSOORFI6",156,0)
 K DIR S DIR(0)="SMB^C:CLINIC;S:SORT GROUP;E:EXIT",DIR("A")="Select By",DIR("B")="Clinic",DIR("?",1)="Enter 'C' to process orders for one individual Clinic,"
"RTN","PSOORFI6",157,0)
 S DIR("?",2)="      'S' to process orders for all Clinics associated with a Sort Group,",DIR("?",3)="      '^' or 'E' to exit" S DIR("?")=" "
"RTN","PSOORFI6",158,0)
 W ! D ^DIR K DIR I $D(DTOUT)!($D(DUOUT))!(Y="E") W ! Q U
"RTN","PSOORFI6",159,0)
 I Y="S" D SORT I $O(^TMP($J,"PSOCL",0)) Q 1
"RTN","PSOORFI6",160,0)
CLIN2 W ! K DIC S DIC="^SC(",DIC(0)="QEAMZ",DIC("A")="Select CLINIC: " D ^DIC K DIC I Y<1!($D(DTOUT))!($D(DUOUT)) Q 0
"RTN","PSOORFI6",161,0)
 S PSOCLIN=+Y,PSOCLINF=1 D CHECK^PSOORFI3 I $G(PSOCFLAG) D INSTNM^PSOORFI2 W !!,"You are signed in under the "_$G(PSODINST)_" CPRS Ordering",!,"Institution, which does not match the Institution for this Clinic!",! K PSODINST G CLIN2
"RTN","PSOORFI6",162,0)
 S ^TMP($J,"PSOCL",PSOCLIN)=PSOCLIN K PSOCLIN Q 1
"RTN","PSOORFI6",163,0)
SORT W ! K DIC S DIC="^PS(59.8,",DIC(0)="QEAMZ",DIC("A")="Select CLINIC SORT GROUP: " D ^DIC K DIC I Y<1!($D(DTOUT))!($D(DUOUT)) Q 0
"RTN","PSOORFI6",164,0)
 S PSOCLINS=+Y
"RTN","PSOORFI6",165,0)
 K ^TMP($J,"PSOCL"),^TMP($J,"PSOCLX") F PSCLP=0:0 S PSCLP=$O(^PS(59.8,PSOCLINS,1,PSCLP)) Q:'PSCLP  S PSOSTC=+$P($G(^PS(59.8,PSOCLINS,1,PSCLP,0)),"^") S:$G(PSOSTC)&($D(^SC(PSOSTC,0))) ^TMP($J,"PSOCL",PSOSTC)=PSOSTC
"RTN","PSOORFI6",166,0)
 I '$O(^TMP($J,"PSOCL",0)) W !!,"There are no Clinics associated with this Sort Group!",! K ^TMP($J,"PSOCL") G SORT
"RTN","PSOORFI6",167,0)
 F PSCLP=0:0 S PSCLP=$O(^TMP($J,"PSOCL",PSCLP)) Q:'PSCLP  S PSOCLIN=PSCLP D CHECK^PSOORFI3 I $G(PSOCFLAG) S ^TMP($J,"PSOCLX",PSCLP)=PSCLP K ^TMP($J,"PSOCL",PSCLP)
"RTN","PSOORFI6",168,0)
 I $O(^TMP($J,"PSOCLX",0)) H 1 W @IOF W !,"Orders for these Clinics in the Sort Group will not be displayed for Finishing",!,"because the CPRS Ordering Institution does not match the Institution that is",!,"associated with the Clinic:",! D
"RTN","PSOORFI6",169,0)
 .F PSCLP=0:0 S PSCLP=$O(^TMP($J,"PSOCLX",PSCLP)) Q:'PSCLP  D:($Y+4)>IOSL  W !,$P($G(^SC(PSCLP,0)),"^")
"RTN","PSOORFI6",170,0)
 ..W ! K DIR S DIR(0)="E",DIR("A")="Press RETURN to continue" D ^DIR K DIR W @IOF
"RTN","PSOORFI6",171,0)
 I $O(^TMP($J,"PSOCLX",0)) D EOP^PSOORFI3 Q 1
"RTN","PSOORFI6",172,0)
 K ^TMP($J,"PSOCLX") I '$O(^TMP($J,"PSOCL",0)) W !!,"There are no Clinics that have a matching Institution!",! D EOP^PSOORFI3 G SORT
"RTN","PSOORFI6",173,0)
 Q
"RTN","PSOORFI6",174,0)
FLG() ;
"RTN","PSOORFI6",175,0)
 Q "FLAGGED^FLAGGED"
"RTN","PSOORFI6",176,0)
CS() ;
"RTN","PSOORFI6",177,0)
 N DIR,PSOCSRT,Y
"RTN","PSOORFI6",178,0)
 K DIR N PSOCSRT S DIR("A")="Route",DIR(0)="SBM^W:WINDOW;M:MAIL;B:BOTH;E:EXIT",DIR("B")="BOTH" D ^DIR
"RTN","PSOORFI6",179,0)
 Q:$D(DIRUT)!(Y="E") U
"RTN","PSOORFI6",180,0)
 S PSOCSRT=$S(Y="B":1,1:Y)
"RTN","PSOORFI6",181,0)
 W !!,"Select a schedule(s)"
"RTN","PSOORFI6",182,0)
 K DIR S PSOSORT="DIGITALLY SIGNED"
"RTN","PSOORFI6",183,0)
 S DIR("A")="Select Schedule(s)",DIR(0)="S^1:SCHEDULE II;2:SCHEDULES III - V;3:SCHEDULES II - V;4:NON-CS+SCHEDULES III - V;5:NON-CS ONLY;E:EXIT",DIR("B")=3
"RTN","PSOORFI6",184,0)
 D ^DIR K DIR
"RTN","PSOORFI6",185,0)
 I $D(DIRUT)!(Y="E") Q U
"RTN","PSOORFI6",186,0)
 S PSOSORT=PSOSORT_"^"_Y_U_PSOCSRT
"RTN","PSOORFI6",187,0)
 Q PSOSORT
"RTN","PSOORFI6",188,0)
SUPPLY() ;
"RTN","PSOORFI6",189,0)
 Q "SUPPLY^SUPPLY"
"RTN","PSOORFI6",190,0)
 ; INPUT
"RTN","PSOORFI6",191,0)
 ;  IEN - IEN of the entry in 52.41 (PENDING OUTPATIENT ORDERS)
"RTN","PSOORFI6",192,0)
 ;  FLTR - filter criteria as returned from $$DIR
"RTN","PSOORFI6",193,0)
CHKFLTR(IEN,FLTR,CNT) ; CHECK THE SECONDARY FILTER FOR PENDING ORDERS
"RTN","PSOORFI6",194,0)
 N FLTRTYP,FLTRVAL,RES,DRG,CLIN,OR0
"RTN","PSOORFI6",195,0)
 ; everytime we have a result of 0 increment the counter
"RTN","PSOORFI6",196,0)
 ; everytime we have a result of 1, reset the counter
"RTN","PSOORFI6",197,0)
 ; when counter reaches 100, display a '.' on the screen and reset the counter
"RTN","PSOORFI6",198,0)
 ;S GL=$NA(^TMP($J,"ROUTINE","CNT"))
"RTN","PSOORFI6",199,0)
 I '$G(IEN) Q 0
"RTN","PSOORFI6",200,0)
 S FLTRTYP=$P(FLTR,U) I FLTRTYP="" Q 1
"RTN","PSOORFI6",201,0)
 S FLTRVAL=$P(FLTR,U,3)
"RTN","PSOORFI6",202,0)
 ; always return 1 for all patients
"RTN","PSOORFI6",203,0)
 I FLTRTYP="PA",FLTRVAL="ALL" Q 1
"RTN","PSOORFI6",204,0)
 ; route filter
"RTN","PSOORFI6",205,0)
 I FLTRTYP="RT" D  Q RES
"RTN","PSOORFI6",206,0)
 .I $$GET1^DIQ(52.41,IEN,19,"I")'=FLTRVAL S RES=0 Q
"RTN","PSOORFI6",207,0)
 .S RES=1
"RTN","PSOORFI6",208,0)
 ; single patient
"RTN","PSOORFI6",209,0)
 I FLTRTYP="PA" D  Q RES
"RTN","PSOORFI6",210,0)
 .; for a single patient selection, the IEN is piece 4. also, if there is no filter value, how could we filter? just return 1?
"RTN","PSOORFI6",211,0)
 .S FLTRVAL=$P(FLTR,U,4) I 'FLTRVAL S RES=1 Q
"RTN","PSOORFI6",212,0)
 .I $$GET1^DIQ(52.41,IEN,1,"I")'=FLTRVAL S RES=0 Q
"RTN","PSOORFI6",213,0)
 .S RES=1
"RTN","PSOORFI6",214,0)
 ; clinic filter
"RTN","PSOORFI6",215,0)
 I FLTRTYP="CL" D  Q RES
"RTN","PSOORFI6",216,0)
 .I $P(FLTR,U,2)'=1 S RES=1 Q
"RTN","PSOORFI6",217,0)
 .I '$O(^TMP($J,"PSOCL",0)) S RES=1 Q
"RTN","PSOORFI6",218,0)
 .S CLIN=$$GET1^DIQ(52.41,IEN,1.1,"I") I 'CLIN S RES=0 Q
"RTN","PSOORFI6",219,0)
 .I '$D(^TMP($J,"PSOCL",CLIN)) S RES=0 Q
"RTN","PSOORFI6",220,0)
 .S RES=1
"RTN","PSOORFI6",221,0)
 ; supply items filter
"RTN","PSOORFI6",222,0)
 I FLTRTYP="FL" D  Q RES
"RTN","PSOORFI6",223,0)
 .I '$D(^PS(52.41,IEN,0))!('$P($G(^PS(52.41,IEN,0)),"^",23)) S RES=0 Q
"RTN","PSOORFI6",224,0)
 .S RES=1
"RTN","PSOORFI6",225,0)
 ; priority
"RTN","PSOORFI6",226,0)
 I FLTRTYP="PR" D  Q RES
"RTN","PSOORFI6",227,0)
 .I $$GET1^DIQ(52.41,IEN,25,"I")'=FLTRVAL S RES=0 Q
"RTN","PSOORFI6",228,0)
 .S RES=1
"RTN","PSOORFI6",229,0)
 ; supply filter
"RTN","PSOORFI6",230,0)
 I FLTRTYP="SU" D  Q RES
"RTN","PSOORFI6",231,0)
 .S RES=$$ISSUPPLY(IEN)
"RTN","PSOORFI6",232,0)
 ; controlled substances
"RTN","PSOORFI6",233,0)
 S FLTRVAL=$P(FLTR,U,3)
"RTN","PSOORFI6",234,0)
 I FLTRTYP="CS" D  Q RES
"RTN","PSOORFI6",235,0)
 .S PDEA=0,OR0=$G(^PS(52.41,IEN,0)),PSRT=FLTRVAL
"RTN","PSOORFI6",236,0)
 .D PDEA^PSOORFI5 I 'PDEA!(PDEA'=PSRT) S RES=0 Q
"RTN","PSOORFI6",237,0)
 .S RES=1
"RTN","PSOORFI6",238,0)
 Q
"RTN","PSOORFI6",239,0)
ISSUPPLY(IEN) ;
"RTN","PSOORFI6",240,0)
 N DIEN,DEAHLDG,ORITEM,ORSUP,RES
"RTN","PSOORFI6",241,0)
 S RES=0
"RTN","PSOORFI6",242,0)
 S DIEN=$$GET1^DIQ(52.41,IEN,11,"I")
"RTN","PSOORFI6",243,0)
 I DIEN S DEAHLDG=$$GET1^DIQ(50,DIEN,3,"E")
"RTN","PSOORFI6",244,0)
 S ORITEM=$$GET1^DIQ(52.41,IEN,8,"I") Q:'ORITEM
"RTN","PSOORFI6",245,0)
 I ORITEM S ORSUP=$$GET1^DIQ(50.7,ORITEM,.09,"I")
"RTN","PSOORFI6",246,0)
 I $G(DEAHLDG)["S"!($G(ORSUP)=1) S RES=1
"RTN","PSOORFI6",247,0)
 Q RES
"RTN","PSOORFI6",248,0)
 ; replace PDEA^PSOORFI5 with updated version
"RTN","PSOORFI6",249,0)
PDEA ;
"RTN","PSOORFI6",250,0)
 I +$P(OR0,"^",9) S PDEA=$P($G(^PSDRUG($P(OR0,"^",9),0)),"^",3),PDEA=$S(PDEA[2:1,PDEA[3!(PDEA[4)!(PDEA[5):2,1:0)
"RTN","PSOORFI6",251,0)
 E  S PDEA=$$OIDEA^PSSUTLA1($P(OR0,"^",8),"O")
"RTN","PSOORFI6",252,0)
 I PDEA=2,PSRT=4 S PDEA=4 Q
"RTN","PSOORFI6",253,0)
 I PDEA=0,PSRT=5 S PDEA=5 Q
"RTN","PSOORFI6",254,0)
 I PDEA,PSRT=3 S PDEA=3
"RTN","PSOORFI6",255,0)
 Q
"RTN","PSOORFI6",256,0)
SCRIT ;
"RTN","PSOORFI6",257,0)
 ;;PA:PATIENT
"RTN","PSOORFI6",258,0)
 ;;RT:ROUTE
"RTN","PSOORFI6",259,0)
 ;;PR:PRIORITY
"RTN","PSOORFI6",260,0)
 ;;CL:CLINIC
"RTN","PSOORFI6",261,0)
 ;;FL:FLAGGED
"RTN","PSOORFI6",262,0)
 ;;CS:CONTROLLED SUBSTANCES
"RTN","PSOORFI6",263,0)
 ;;SU:SUPPLY
"RTN","PSOORFI6",264,0)
 ;;C:CONTINUE W/PRIMARY
"RTN","PSOORFI6",265,0)
 ;;E:EXIT
"RTN","PSOORFI6",266,0)
 Q
"RTN","PSOORFIN")
0^7^B72047260^B64024579
"RTN","PSOORFIN",1,0)
PSOORFIN ;BIR/SAB-finish cprs orders ;8/27/08 4:57pm
"RTN","PSOORFIN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**7,15,27,32,44,46,84,106,111,117,131,146,139,195,225,315,266,338,391,372,416,446,505**;DEC 1997;Build 39
"RTN","PSOORFIN",3,0)
 ;PSSLOCK-2789,PSDRUG-221,50.7-2223,55-2228,50.606-2174
"RTN","PSOORFIN",4,0)
 ;PSO*7*266 Change order of calling ^PSOBING1 and ^PSORXL
"RTN","PSOORFIN",5,0)
 ;
"RTN","PSOORFIN",6,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) D MSG^PSODPT G EX
"RTN","PSOORFIN",7,0)
 D INST^PSOORFI2 I $G(PSOIQUIT) K PSOIQUIT G EX
"RTN","PSOORFIN",8,0)
 I $P($G(PSOPAR),"^",2),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("VERIFY")=1
"RTN","PSOORFIN",9,0)
 S (PSOFIN,POERR)=1
"RTN","PSOORFIN",10,0)
 K PSOBCK,MEDA,MEDP,SRT,DIR D KQ
"RTN","PSOORFIN",11,0)
 S DIR("?")="^D ST^PSOORFI1",DIR("A")="Select By",DIR("B")="PATIENT"
"RTN","PSOORFIN",12,0)
 S DIR(0)="SMB^PA:PATIENT;RT:ROUTE;PR:PRIORITY;CL:CLINIC;FL:FLAGGED;CS:CONTROLLED SUBSTANCES;SU:SUPPLY;E:EXIT"
"RTN","PSOORFIN",13,0)
 D ^DIR I $D(DIRUT)!(Y="E") G EX
"RTN","PSOORFIN",14,0)
 K:Y="FL" ^TMP($J,"PSOFLPO") ;file not needed when selection="FL"
"RTN","PSOORFIN",15,0)
 G:Y="PA" PAT G:Y="PR" PRI^PSOORFI5 G:Y="CL" ^PSOORFI3 G:Y="FL" FLG^PSOORFI5 G:Y="CS" CS^PSOORFI5 G:Y="SU" SUP^PSOORFI5
"RTN","PSOORFIN",16,0)
 K DIR S PSOSORT="ROUTE"
"RTN","PSOORFIN",17,0)
 S DIR("?")="^D RT^PSOORFI1",DIR("A")="Route",DIR(0)="SBM^W:WINDOW;M:MAIL;C:CLINIC;E:EXIT",DIR("B")="WINDOW"
"RTN","PSOORFIN",18,0)
 D ^DIR G:$D(DIRUT)!(Y="E") EX S PSOSORT=PSOSORT_"^"_Y,PSRT=Y
"RTN","PSOORFIN",19,0)
 N SECSORT S SECSORT=$$DIR^PSOORFI6("RT:ROUTE",Y) Q:SECSORT=U
"RTN","PSOORFIN",20,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFIN",21,0)
 .Q:$P($G(^PS(52.41,PSOD,0)),"^",23)
"RTN","PSOORFIN",22,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFIN",23,0)
 .;PSO*7*266
"RTN","PSOORFIN",24,0)
 .I PAT'=PATA D LBL
"RTN","PSOORFIN",25,0)
 .I '$O(^PS(52.41,"AC",PAT,PSRT,0)) S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFIN",26,0)
 .D RTE^PSOORFI2 I $G(PSZFIN) S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFIN",27,0)
 .;PSO*7*505
"RTN","PSOORFIN",28,0)
 .I SECSORT'=0,'$$CHKFLTR^PSOORFI6(PSOD,SECSORT) Q
"RTN","PSOORFIN",29,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFIN",30,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP Q
"RTN","PSOORFIN",31,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFIN",32,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFIN",33,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFIN",34,0)
 .D PP S ORD=0 D @PSRT S PAT(PAT)=PAT
"RTN","PSOORFIN",35,0)
 .S X=PAT D ULP
"RTN","PSOORFIN",36,0)
 ;PSO*7*266
"RTN","PSOORFIN",37,0)
 K POERR("QFLG"),PSOQFLG,PSOPTPST,MAIL,WIN,CLI D LBL
"RTN","PSOORFIN",38,0)
 I $G(PSOQUIT) K PSOQUIT D EX G PSOORFIN
"RTN","PSOORFIN",39,0)
EX D EX^PSOORFI1
"RTN","PSOORFIN",40,0)
 Q
"RTN","PSOORFIN",41,0)
W D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"W",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD S MAIL=1
"RTN","PSOORFIN",42,0)
 Q:$G(POERR("QFLG"))  I $G(MAIL) S ORD=0 D
"RTN","PSOORFIN",43,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"M",ORD)) Q:'ORD!($G(POERR("QFLG")))  D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") LK1,ORD
"RTN","PSOORFIN",44,0)
 .Q:$G(POERR("QFLG"))
"RTN","PSOORFIN",45,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"C",ORD)) Q:'ORD!($G(POERR("QFLG")))  D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") LK1,ORD
"RTN","PSOORFIN",46,0)
 Q
"RTN","PSOORFIN",47,0)
M D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"M",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD S WIN=1
"RTN","PSOORFIN",48,0)
 Q:$G(POERR("QFLG"))  I $G(WIN) S ORD=0 D
"RTN","PSOORFIN",49,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"W",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD
"RTN","PSOORFIN",50,0)
 .Q:$G(POERR("QFLG"))
"RTN","PSOORFIN",51,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"C",ORD)) Q:'ORD!($G(POERR("QFLG")))  D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") LK1,ORD
"RTN","PSOORFIN",52,0)
 Q
"RTN","PSOORFIN",53,0)
C D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"C",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD S CLI=1
"RTN","PSOORFIN",54,0)
 Q:$G(POERR("QFLG"))  I $G(CLI) S ORD=0 D
"RTN","PSOORFIN",55,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"M",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD
"RTN","PSOORFIN",56,0)
 .Q:$G(POERR("QFLG"))
"RTN","PSOORFIN",57,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"W",ORD)) Q:'ORD!($G(POERR("QFLG")))  D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") LK1,ORD
"RTN","PSOORFIN",58,0)
 Q
"RTN","PSOORFIN",59,0)
PAT W ! K MEDP,MEDA,POERR("DFLG"),DIR D KQ S PSOSORT="PATIENT"
"RTN","PSOORFIN",60,0)
 S DIR("?")="^D PT^PSOORFI1",DIR("A")="All Patients or Single Patient",DIR(0)="SBM^A:ALL;S:SINGLE;E:EXIT",DIR("B")="SINGLE"
"RTN","PSOORFIN",61,0)
 D ^DIR K DIR G:$D(DIRUT)!(Y="E") EX I Y="S" S PSOSORT=PSOSORT_"^"_"SINGLE" G SPAT
"RTN","PSOORFIN",62,0)
 S PSOSORT=PSOSORT_"^ALL"
"RTN","PSOORFIN",63,0)
 N SECSORT S SECSORT=$$DIR^PSOORFI6("PA:PATIENT",Y) Q:SECSORT=U
"RTN","PSOORFIN",64,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFIN",65,0)
 .Q:'$D(^PS(52.41,PSOD,0))!($P($G(^PS(52.41,PSOD,0)),"^",23))
"RTN","PSOORFIN",66,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFIN",67,0)
 .;PSO*7*505 - secondary sort filter
"RTN","PSOORFIN",68,0)
 .I SECSORT'=0,'$$CHKFLTR^PSOORFI6(PSOD,SECSORT) Q
"RTN","PSOORFIN",69,0)
 .;PSO*7*266
"RTN","PSOORFIN",70,0)
 .I PAT'=PATA D LBL
"RTN","PSOORFIN",71,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFIN",72,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG,PSOQQ Q
"RTN","PSOORFIN",73,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFIN",74,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFIN",75,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFIN",76,0)
 .S PAT(PAT)=PAT
"RTN","PSOORFIN",77,0)
 .F ORD=0:0 S ORD=$O(^PS(52.41,"AOR",PAT,PSOPINST,ORD)) Q:'ORD!($G(POERR("QFLG")))!($G(PSOQQ))  D
"RTN","PSOORFIN",78,0)
 ..I SECSORT'=0,'$$CHKFLTR^PSOORFI6(ORD,SECSORT) Q
"RTN","PSOORFIN",79,0)
 ..I '$P($G(^PS(52.41,ORD,0)),"^",23) D PP,LK1,ORD
"RTN","PSOORFIN",80,0)
 .S X=PAT D ULP K PSOQQ
"RTN","PSOORFIN",81,0)
 I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL
"RTN","PSOORFIN",82,0)
 I $G(PSOQUIT) K PSOQUIT D EX G PSOORFIN
"RTN","PSOORFIN",83,0)
 G EX
"RTN","PSOORFIN",84,0)
 ;PSO*7*266 kill BINGCRT,BINGRTE when selecting pat.
"RTN","PSOORFIN",85,0)
SPAT K MEDA,MEDP,PSOQFLG,PSORX("FN"),BINGCRT,BINGRTE D KQ,KV^PSOVER1
"RTN","PSOORFIN",86,0)
 S DIR(0)="FO^2:30",DIR("A")="Select Patient",DIR("?")="^D HELP^PSOORFI2" D ^DIR I $E(X)="?" G SPAT
"RTN","PSOORFIN",87,0)
 G:$D(DIRUT) EX D KV^PSOVER1
"RTN","PSOORFIN",88,0)
 S DIC(0)="EQM",DIC=2,DIC("S")="I $D(^PS(52.41,""AOR"",+Y,PSOPINST))"
"RTN","PSOORFIN",89,0)
 D ^DIC K DIC G:"^"[X EX G:Y=-1 SPAT S (PSODFN,PAT)=+Y,PSOFINY=Y
"RTN","PSOORFIN",90,0)
 D LK I $G(POERR("QFLG")) G SPAT
"RTN","PSOORFIN",91,0)
 N SNGLPAT S SNGLPAT=1
"RTN","PSOORFIN",92,0)
 ; PSO*7*505 - SECONDARY SORT
"RTN","PSOORFIN",93,0)
 N SECSORT S SECSORT=$$DIR^PSOORFI6("PA:PATIENT",PSODFN) I SECSORT'=0,$P(SECSORT,U,1)="CS" N PSRT S PSRT=$P(SECSORT,U,3)
"RTN","PSOORFIN",94,0)
 Q:SECSORT=U
"RTN","PSOORFIN",95,0)
 ; PSO*7*505 - END
"RTN","PSOORFIN",96,0)
 ;PSO*7*266
"RTN","PSOORFIN",97,0)
 D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSOFINY I $G(MEDP) D SPL D OERR^PSORX1 D LBL S PSOFIN=1,X=PSOPTLOK D KLLP,ULP,KLL G SPAT
"RTN","PSOORFIN",98,0)
 D PP,SDFN,POST^PSOORFI1 D:$G(PSOQFLG)  G:$G(PSOQFLG) EX I $G(PSOQUIT) S:$G(PSOQUIT) POERR("QFLG")=1 S X=PAT D ULP G SPAT
"RTN","PSOORFIN",99,0)
 .S X=PAT D ULP
"RTN","PSOORFIN",100,0)
 S ORD=0 F  S ORD=$O(^PS(52.41,"P",PAT,ORD)) Q:'ORD!($G(POERR("QFLG")))  D:'$P($G(^PS(52.41,ORD,0)),"^",23)
"RTN","PSOORFIN",101,0)
 .;PSO*7*505 - SECONDARY SORT
"RTN","PSOORFIN",102,0)
 .I SECSORT'=0,'$$CHKFLTR^PSOORFI6(ORD,SECSORT) Q
"RTN","PSOORFIN",103,0)
 .;PSO*7*505 - END
"RTN","PSOORFIN",104,0)
 .D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE")&($P(^(0),"^",3)'="HD") LK1,ORD
"RTN","PSOORFIN",105,0)
 ;PSO*7*266
"RTN","PSOORFIN",106,0)
 D LBL
"RTN","PSOORFIN",107,0)
 S PSOFIN=1,X=PAT D ULP G SPAT
"RTN","PSOORFIN",108,0)
ORD I $G(PSOBCK) N LST,ORN
"RTN","PSOORFIN",109,0)
 E  S PSOLOUD=1 D:$P($G(^PS(55,PAT,0)),"^",6)'=2 EN^PSOHLUP(PAT) K PSOLOUD
"RTN","PSOORFIN",110,0)
 K DRET,SIG,^TMP("PSORXDC",$J) Q:'$D(^PS(52.41,ORD,0))
"RTN","PSOORFIN",111,0)
 I $G(PSOFIN),$P($G(^PS(52.41,ORD,"INI")),"^")'=$G(PSOPINST) Q
"RTN","PSOORFIN",112,0)
 D L1^PSOORFI3 I '$G(PSOMSG) K PSOMSG Q
"RTN","PSOORFIN",113,0)
 I '$D(^PS(52.41,ORD,0)) K PSOMSG Q
"RTN","PSOORFIN",114,0)
 K DRET,SIG,PSOPRC,PHI,PRC,PSOSIGFL,OBX,PSOMSG,PSOFOERR S OR0=^PS(52.41,ORD,0)
"RTN","PSOORFIN",115,0)
 I $P(OR0,"^",24),($P(OR0,"^",3)="RNW"!($P(OR0,"^",3)="NW")) N PKI,PKI1,PKIR,PKIE,PKID S PKI=0 D CER^PSOPKIV1 I PKI<1 D UL1^PSOORFI3 K OR0 Q
"RTN","PSOORFIN",116,0)
 S (PSOFOERR,PSOFDR)=1,OI=$P(OR0,"^",8),PSORX("SC")=$P(OR0,"^",16)
"RTN","PSOORFIN",117,0)
 I $O(^PS(52.41,ORD,2,0)) S PHI=^PS(52.41,ORD,2,0),T=0 F  S T=$O(^PS(52.41,ORD,2,T)) Q:'T  S PHI(T)=^PS(52.41,ORD,2,T,0)
"RTN","PSOORFIN",118,0)
 I $P($G(^PS(52.41,ORD,"EXT")),"^")'="" K PHI I $O(^PS(52.41,ORD,"SIG",0)) S PHI=$G(^PS(52.41,ORD,"SIG",0)),T=0 F  S T=$O(^PS(52.41,ORD,"SIG",T)) Q:'T  S PHI(T)=$G(^PS(52.41,ORD,"SIG",T,0))
"RTN","PSOORFIN",119,0)
 I $O(^PS(52.41,ORD,3,0)) S PRC=^PS(52.41,ORD,3,0),T=0 F  S T=$O(^PS(52.41,ORD,3,T)) Q:'T  S PRC(T)=^PS(52.41,ORD,3,T,0)
"RTN","PSOORFIN",120,0)
 I $P(OR0,"^",3)="RNW",$D(^PSRX(+$P(OR0,"^",21),0)) D  G SUCC ;process renews
"RTN","PSOORFIN",121,0)
 .K PSOREEDT S (PSOORRNW,PSOFDR)=1,PSORENW("OIRXN")=$P(OR0,"^",21),PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"))=0 D ^PSOORRNW,SQR
"RTN","PSOORFIN",122,0)
 I $P(OR0,"^",3)="RF",$D(^PSRX(+$P(OR0,"^",19),0)) D RF^PSOORFI2 G SUCC
"RTN","PSOORFIN",123,0)
 N PSODRUG,PSONEW S PSOFROM="PENDING" D:'$G(PSOTPBFG) DSPL^PSOTPCAN(ORD) D DSPL^PSOORFI1,SQN^PSOORFI3
"RTN","PSOORFIN",124,0)
SUCC ;
"RTN","PSOORFIN",125,0)
 D UL1^PSOORFI3,FULL^VALM1
"RTN","PSOORFIN",126,0)
 D:$P($G(^PS(52.41,+$G(ORD),0)),"^",3)'="NW"&($P($G(^(0)),"^",3)'="RNW")&($P($G(^(0)),"^",3)'="HD")&($P($G(^(0)),"^",3)'="RF")
"RTN","PSOORFIN",127,0)
 .K PSOSD("PENDING",$S('$G(OID):$P(^PS(50.7,$P(OR0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(OR0,"^",8),0),"^",2),0),"^"),1:$P(^PSDRUG($P(OR0,"^",9),0),"^")))
"RTN","PSOORFIN",128,0)
 S:$G(POERR("DFLG")) POERR("QFLG")=1 K POERR("DFLG"),PSONEW,ACP,OR0,DRET,SIG,OID,OI
"RTN","PSOORFIN",129,0)
 K PSORX("SC"),PSORX("CLINIC"),PSORX("PROVIDER NAME"),PSODRUG,PSOFOERR
"RTN","PSOORFIN",130,0)
 Q
"RTN","PSOORFIN",131,0)
 ;PSO*7*266 change order of bingo checks.
"RTN","PSOORFIN",132,0)
LBL I $O(PSORX("PSOL",0))!($D(RXRS)) S PSOFROM="NEW" D ^PSORXL K PSORX("PSOL"),PPL,RXRS
"RTN","PSOORFIN",133,0)
 D:$D(BINGCRT)&($D(BINGRTE)&($D(DISGROUP))) ^PSOBING1 K BINGCRT,BINGRTE,PSONEW,BBFLG,BBRX,PSORX("DOSING OFF"),PSOONOFC
"RTN","PSOORFIN",134,0)
 Q
"RTN","PSOORFIN",135,0)
CHK ;
"RTN","PSOORFIN",136,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) W !,$C(7),"Outpatient Division MUST be selected!",! G EX
"RTN","PSOORFIN",137,0)
 D INST1^PSOORFI2
"RTN","PSOORFIN",138,0)
 S PSZCNT=0 F PSZZI=0:0 S PSZZI=$O(^PS(59,PSZZI)) Q:'PSZZI  S PSZCNT=PSZCNT+1
"RTN","PSOORFIN",139,0)
 S TC=0 F TO=0:0 S TO=$O(^PS(52.41,"AOR",TO)) Q:'TO  F TZ=0:0 S TZ=$O(^PS(52.41,"AOR",TO,TZ)) Q:'TZ  F PSTZ=0:0 S PSTZ=$O(^PS(52.41,"AOR",TO,TZ,PSTZ)) Q:'PSTZ  S TC=TC+1
"RTN","PSOORFIN",140,0)
 W !!?10,$C(7),"Orders to be completed"_$S(PSZCNT=1:": ",1:" for all divisions: ")_TC,! Q:'TC
"RTN","PSOORFIN",141,0)
 D SUMM^PSOORNE1 K PSZZI,PSZCNT,PSTZ
"RTN","PSOORFIN",142,0)
 Q
"RTN","PSOORFIN",143,0)
 ;
"RTN","PSOORFIN",144,0)
LK D LOCK^PSOORFI1
"RTN","PSOORFIN",145,0)
 Q
"RTN","PSOORFIN",146,0)
LK1 D LOCK1^PSOORFI1 Q
"RTN","PSOORFIN",147,0)
QU I $G(PSOQUIT) S POERR("QFLG")=1 K PSOQUIT
"RTN","PSOORFIN",148,0)
 S:$G(PSOQFLG) PAT(PAT)=PAT
"RTN","PSOORFIN",149,0)
 Q
"RTN","PSOORFIN",150,0)
ULP K PSORX("MAIL/WINDOW"),PSORX("METHOD OF PICK-UP")
"RTN","PSOORFIN",151,0)
 D CLEAN^PSOVER1
"RTN","PSOORFIN",152,0)
 I '$G(X) Q
"RTN","PSOORFIN",153,0)
 D UL^PSSLOCK(X) Q
"RTN","PSOORFIN",154,0)
KLL K PSOPTLOK Q
"RTN","PSOORFIN",155,0)
KLLP K PSONOLCK Q
"RTN","PSOORFIN",156,0)
SPL D SPL^PSOORFI4 Q
"RTN","PSOORFIN",157,0)
SDFN S PSODFN=+$G(PSODFN) Q
"RTN","PSOORFIN",158,0)
PP D PP^PSOORFI4 Q
"RTN","PSOORFIN",159,0)
KQ K PSOQUIT,POERR("QFLG") Q
"RTN","PSOORFIN",160,0)
SQR ;
"RTN","PSOORFIN",161,0)
 K PSOORRNW,PSOOPT,PSOREEDT,PSOQUIT,VALMSG S POERR("DFLG")=0
"RTN","PSOORFIN",162,0)
 Q
"RTN","PSOORNE6")
0^16^B50434819^B50160901
"RTN","PSOORNE6",1,0)
PSOORNE6 ;ISC-BHAM/SAB-display  orders from backdoor ;5/23/05 2:08pm
"RTN","PSOORNE6",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,103,117,156,210,488,505**;DEC 1997;Build 39
"RTN","PSOORNE6",3,0)
 ;External reference to MAIN^TIUEDIT is supported by DBIA 2410
"RTN","PSOORNE6",4,0)
 ;PSO*210 add call to WORDWRAP api
"RTN","PSOORNE6",5,0)
 ;
"RTN","PSOORNE6",6,0)
SIG ;called from psoorne3
"RTN","PSOORNE6",7,0)
 I $G(PSOSIGFL)!$G(PSOCOPY)!($O(SIG(0))) G DOSE
"RTN","PSOORNE6",8,0)
 I '$P(^PSRX(PSORXED("IRXN"),"SIG"),"^",2) D  Q
"RTN","PSOORNE6",9,0)
 .S X=$P(^PSRX(PSORXED("IRXN"),"SIG"),"^") D SIGONE^PSOHELP S SIG=$E($G(INS1),2,250)
"RTN","PSOORNE6",10,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNE6",11,0)
 F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S MIG=$P(^PSRX(PSORXED("IRXN"),"SIG1",I,0),"^") D
"RTN","PSOORNE6",12,0)
 .S SIG(I)=MIG
"RTN","PSOORNE6",13,0)
 .F SG=1:1:$L(MIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " S:$P(MIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORNE6",14,0)
 .S SIGOK=1 K MIG,SG
"RTN","PSOORNE6",15,0)
 Q
"RTN","PSOORNE6",16,0)
DOSE ;displays new SIG with dosing
"RTN","PSOORNE6",17,0)
 F I=0:0 S I=$O(SIG(I)) Q:'$D(SIG(+I))  D
"RTN","PSOORNE6",18,0)
 .F SG=1:1:$L(SIG(I)) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG(I)," ",SG))>75 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " S:$P(SIG(I)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG(I)," ",SG)
"RTN","PSOORNE6",19,0)
 S SIGOK=1 K MIG,I
"RTN","PSOORNE6",20,0)
 Q
"RTN","PSOORNE6",21,0)
K1 ;
"RTN","PSOORNE6",22,0)
 K DRET,SIG,RTE,PRC,PHI,PSONOOR,PSOFDR,PSORXED,REF,DIR,DUOUT,DIRUT,SIGOK
"RTN","PSOORNE6",23,0)
 Q
"RTN","PSOORNE6",24,0)
K2 ;
"RTN","PSOORNE6",25,0)
 K SIG,DRET,RTE,PRC,PHI,DIR,DIRUT,DTOUT,PSOOELSE,DUOUT,PSOFDR,SIGOK,PSORXED,REF,INS1
"RTN","PSOORNE6",26,0)
 Q
"RTN","PSOORNE6",27,0)
K3 ;
"RTN","PSOORNE6",28,0)
 K PSLST,ORD,IEN,ORN,RPH,ST,REFL,REF,PSOACT,ORSV,CC,CRIT,CT,DAYS,DDER,DEA,DSMSG,HDR,PSOAC,PSOFLAG,RFCNT
"RTN","PSOORNE6",29,0)
 K UPMI,RIFN,RX,RXDA,RXOR,RXREF,SEG1,SER,STA,PSOFDR,SIGOK,INCOM,PSONOOR,ACTREF,ACTREN,INS1,RX0,RX2,RX3
"RTN","PSOORNE6",30,0)
 Q
"RTN","PSOORNE6",31,0)
ACP1 ;
"RTN","PSOORNE6",32,0)
 K REA,DA,MSG S REA="C",DA=PSONEW("OIRXN") S MSG="Renewed"_$S($G(PSOFDR):" from CPRS",1:"")
"RTN","PSOORNE6",33,0)
 S PSCAN(PSONEW("ORX #"))=DA_"^C" D CAN^PSOCAN,DCORD^PSONEW2 K REA,DA,MSG,PSCAN,RXXN
"RTN","PSOORNE6",34,0)
 S RXXN=$O(^TMP("PSORXN",$J,0)) I RXXN D
"RTN","PSOORNE6",35,0)
 .S RXN1=^TMP("PSORXN",$J,RXXN) D EN^PSOHLSN1(RXXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSOORNE6",36,0)
 .I $P(^PSRX(RXXN,"STA"),"^")=5 D EN^PSOHLSN1(RXXN,"SC","ZS",$P(RXN1,"^",4))
"RTN","PSOORNE6",37,0)
 I $G(PSONOTE) D FULL^VALM1,MAIN^TIUEDIT(3,.TIUDA,PSODFN,"","","","",1) K PSONOTE
"RTN","PSOORNE6",38,0)
 K VERB,RTE,DRET,RXXN,RXN1,^TMP("PSORXN",$J)
"RTN","PSOORNE6",39,0)
 S BBRN="",BBRN1=$O(^PSRX("B",PSONEW("NRX #"),BBRN)) I $P($G(^PSRX(BBRN1,0)),"^",11)["W" S BINGCRT="Y",BINGRTE="W"
"RTN","PSOORNE6",40,0)
 Q
"RTN","PSOORNE6",41,0)
INST ;formats instruction from front door
"RTN","PSOORNE6",42,0)
 I $O(^PSRX(RXN,"PI",0)) S PHI=^PSRX(RXN,"PI",0),T=0 D
"RTN","PSOORNE6",43,0)
 .F  S T=$O(^PSRX(RXN,"PI",T)) Q:'T  S PHI(T)=^PSRX(RXN,"PI",T,0)
"RTN","PSOORNE6",44,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="        Instructions:"
"RTN","PSOORNE6",45,0)
 .S T=0 F  S T=$O(^PSRX(RXN,"PI",T)) Q:'T  D                  ;PSO*210
"RTN","PSOORNE6",46,0)
 .. S MIG=^PSRX(RXN,"PI",T,0)
"RTN","PSOORNE6",47,0)
 .. D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAO",$J)),21)
"RTN","PSOORNE6",48,0)
 K T,TY,MIG,SG
"RTN","PSOORNE6",49,0)
 Q
"RTN","PSOORNE6",50,0)
PC ;displays provider comments
"RTN","PSOORNE6",51,0)
 I $O(^PSRX(RXN,"PRC",0)) S PRC=^PSRX(RXN,"PRC",0),T=0 D
"RTN","PSOORNE6",52,0)
 .F  S T=$O(^PSRX(RXN,"PRC",T)) Q:'T  S PRC(T)=^PSRX(RXN,"PRC",T,0)
"RTN","PSOORNE6",53,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="   Provider Comments:"
"RTN","PSOORNE6",54,0)
 .S T=0 F  S T=$O(^PSRX(RXN,"PRC",T)) Q:'T  D                 ;PSO*210
"RTN","PSOORNE6",55,0)
 .. S MIG=^PSRX(RXN,"PRC",T,0)
"RTN","PSOORNE6",56,0)
 .. D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAO",$J)),21)
"RTN","PSOORNE6",57,0)
 K T,TY,MIG,SG
"RTN","PSOORNE6",58,0)
 Q
"RTN","PSOORNE6",59,0)
INST1 ;formats instruction from front door
"RTN","PSOORNE6",60,0)
 I $O(^PSRX(RXN,"PI",0)) S PHI=^PSRX(RXN,"PI",0),T=0 D
"RTN","PSOORNE6",61,0)
 .F  S T=$O(^PSRX(RXN,"PI",T)) Q:'T  S PHI(T)=^PSRX(RXN,"PI",T,0)
"RTN","PSOORNE6",62,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="        Instructions:"
"RTN","PSOORNE6",63,0)
 .S T=0 F  S T=$O(^PSRX(RXN,"PI",T)) Q:'T  D                  ;PSO*210
"RTN","PSOORNE6",64,0)
 .. S MIG=^PSRX(RXN,"PI",T,0)
"RTN","PSOORNE6",65,0)
 .. D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOPO",$J)),21)
"RTN","PSOORNE6",66,0)
 K T,TY,MIG,SG
"RTN","PSOORNE6",67,0)
 Q
"RTN","PSOORNE6",68,0)
PC1 ;displays provider comments
"RTN","PSOORNE6",69,0)
 I $O(^PSRX(RXN,"PRC",0)) S PRC=^PSRX(RXN,"PRC",0),T=0 D
"RTN","PSOORNE6",70,0)
 .F  S T=$O(^PSRX(RXN,"PRC",T)) Q:'T  S PRC(T)=^PSRX(RXN,"PRC",T,0)
"RTN","PSOORNE6",71,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Provider Comments:"
"RTN","PSOORNE6",72,0)
 .S T=0 F  S T=$O(^PSRX(RXN,"PRC",T)) Q:'T  D                 ;PSO*210
"RTN","PSOORNE6",73,0)
 .. S MIG=^PSRX(RXN,"PRC",T,0)
"RTN","PSOORNE6",74,0)
 .. D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOPO",$J)),21)
"RTN","PSOORNE6",75,0)
 K T,TY,MIG,SG
"RTN","PSOORNE6",76,0)
 Q
"RTN","PSOORNE6",77,0)
ORCHK ;
"RTN","PSOORNE6",78,0)
 S (PSONEW("QFLG"),PSONEW("DFLG"))=0
"RTN","PSOORNE6",79,0)
 D FULL^VALM1 W !
"RTN","PSOORNE6",80,0)
 I $G(PSODRUG("NAME"))']""  D  S:$D(DIRUT)!($G(PSODRUG("NAME"))']"") ACP=0 Q:$G(PSOQFLG)!($D(DIRUT))
"RTN","PSOORNE6",81,0)
 .W !,"DRUG NAME REQUIRED" D 2^PSOORNW1,FULL^VALM1 I $G(PSODRUG("NAME"))']"" S VALMSG="No Dispense Drug selected."
"RTN","PSOORNE6",82,0)
 S PSOMIS=$S($G(PSONEW("DOSE",1))']"":1,$G(PSONEW("SCHEDULE",1))']"":2,1:0)
"RTN","PSOORNE6",83,0)
 D:PSOMIS  I PSODIR("DFLG")=1 S (PSONEW("QFLG"),POERR("DFLG"))=1 Q
"RTN","PSOORNE6",84,0)
 .W !!,"Incomplete Dosaging Instructions - "_$S(PSOMIS=2:"Schedule",1:"Dosage")_".",! S FDORC=1 D DOSE^PSOORED4(.PSONEW) K FDORC
"RTN","PSOORNE6",85,0)
 .I $G(PSONEW("DOSE",1))']""!($G(PSONEW("SCHEDULE",1))']"") S PSODIR("DFLG")=1 Q
"RTN","PSOORNE6",86,0)
 .D EN^PSOFSIG(.PSONEW) I PSONEW("ENT")>0,$O(SIG(0)) S (SIGOK,NEWDOSE)=1
"RTN","PSOORNE6",87,0)
 .D INS^PSODIR(.PSONEW),EN^PSOFSIG(.PSONEW)
"RTN","PSOORNE6",88,0)
 K PSOMIS,PSODOSE,POERR("DFLG"),PSONEW("QFLG") S I=0
"RTN","PSOORNE6",89,0)
 F  S I=$O(PSONEW("DOSE",I)) Q:'I  I $L(PSONEW("DOSE",I))>60 S (PSONEW("QFLG"),POERR("DFLG"))=1,PSODOSE("MSG",I)="Dosage #"_I_" is greater 60 characters in length!",VALMSG="Dosage Greater than 60 Characters, Please Edit!"
"RTN","PSOORNE6",90,0)
 I $G(POERR("DFLG"))=1 D  K PSODOSE,I Q
"RTN","PSOORNE6",91,0)
 .S I=0 F  S I=$O(PSODOSE("MSG",I)) Q:'I  W !,PSODOSE("MSG",I)
"RTN","PSOORNE6",92,0)
 .H 3
"RTN","PSOORNE6",93,0)
 Q:$G(PSONEW("QFLG"))
"RTN","PSOORNE6",94,0)
 K PSONEW("FLD") F FLD="PATIENT STATUS^5","QTY^9","DAYS SUPPLY^8","# OF REFILLS^10","ISSUE DATE^6","FILL DATE^7","MAIL/WINDOW^11","PROVIDER NAME^13" D  I $G(PSONEW($P(FLD,"^")))']"" S VALMBCK="R",PSONEW("FLD")=1
"RTN","PSOORNE6",95,0)
 .I $G(PSONEW($P(FLD,"^")))']"" W !,$P(FLD,"^")_" is required data" N RTN S RTN=$P(FLD,"^",2)_"^PSOORNEW" D @RTN K RTN
"RTN","PSOORNE6",96,0)
 Q:$G(PSONEW("DFLG"))=1
"RTN","PSOORNE6",97,0)
QTY I PSONEW("QTY")'=+PSONEW("QTY"),PSONEW("QTY")'["." W !,"Quantity must be ALL numeric!",! D 9^PSOORNEW Q:$G(PSONEW("DFLG"))=1  G QTY
"RTN","PSOORNE6",98,0)
 I $G(PSODRUG("MAXDOSE"))]"",(PSONEW("QTY")/PSONEW("DAYS SUPPLY")>PSODRUG("MAXDOSE")) D  Q:$G(PSONEW("DFLG"))=1!($G(PSONEW("QFLG")))  G QTY
"RTN","PSOORNE6",99,0)
 .W !,$C(7)," Greater than Maximum dose of "_PSODRUG("MAXDOSE")_" per day"
"RTN","PSOORNE6",100,0)
 .D KV^PSOVER1 S DIR(0)="Y",DIR("B")="Yes",DIR("A")="Do You Want to Edit Days Supply and Quantity Fields"
"RTN","PSOORNE6",101,0)
 .S DIR("?")="Enter 'Y' for Yes, 'N' for No, '^' to exit."
"RTN","PSOORNE6",102,0)
 .D ^DIR I $D(DIRUT) D KV^PSOVER1 K X,Y S (PSONEW("DFLG"),PSONEW("QFLG"))=1 Q  ;*488
"RTN","PSOORNE6",103,0)
 .D KV^PSOVER1 I 'Y K X,Y Q
"RTN","PSOORNE6",104,0)
 .D 8^PSOORNEW Q:$G(PSONEW("DFLG"))  D 9^PSOORNEW
"RTN","PSOORNE6",105,0)
 I $G(PSONEW("PROVIDER")) D PROV^PSOUTIL(.PSONEW) I $G(PSONEW("DFLG")) S PSODIR("DFLG")=1 Q
"RTN","PSOORNE6",106,0)
 S PSONEW("DFLG")=0 K DIC,X,Y
"RTN","PSOORNE6",107,0)
 Q
"RTN","PSOORNE6",108,0)
DISP ;
"RTN","PSOORNE6",109,0)
 S:$P(RX2,"^",10)&('$G(PSOCOPY)) IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="         Verified By: "_$P(^VA(200,$P(RX2,"^",10),0),"^")
"RTN","PSOORNE6",110,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",5) S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="         Finished By: "_$P(^VA(200,$P(^PSRX(RXN,"OR1"),"^",5),0),"^")
"RTN","PSOORNE6",111,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",6) D
"RTN","PSOORNE6",112,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="           Filled By: "_$P(^VA(200,$P(^PSRX(RXN,"OR1"),"^",6),0),"^")
"RTN","PSOORNE6",113,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",7) D
"RTN","PSOORNE6",114,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="          Checked By: "_$P(^VA(200,$P(^PSRX(RXN,"OR1"),"^",7),0),"^")
"RTN","PSOORNE6",115,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="   Entry By: "_$P(^VA(200,$P(RX0,"^",16),0),"^")_$E(RN,$L($P(^VA(200,$P(RX0,"^",16),0),"^"))+1,35)
"RTN","PSOORNE6",116,0)
 S Y=$P(RX2,"^") X ^DD("DD")
"RTN","PSOORNE6",117,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"Entry Date: "_$E($P(RX2,"^"),4,5)_"/"_$E($P(RX2,"^"),6,7)_"/"_$E($P(RX2,"^"),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORNE6",118,0)
 S (VALMCNT,PSOPF)=IEN S:$P($G(^PSRX(RXN,"PKI")),"^") VALMSG="Digitally Signed Order"
"RTN","PSOORNE6",119,0)
 Q
"RTN","PSOORNEW")
0^4^B112662411^B98552577
"RTN","PSOORNEW",1,0)
PSOORNEW ;BIR/SAB - display orders from oerr ;6/19/06 3:53pm
"RTN","PSOORNEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,55,46,71,90,94,106,131,133,143,237,222,258,206,225,251,386,390,391,372,416,431,313,408,436,411,444,486,446,505**;DEC 1997;Build 39
"RTN","PSOORNEW",3,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORNEW",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORNEW",5,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOORNEW",6,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORNEW",7,0)
 ;External reference to EN1^ORCFLAG supported by DBIA 3620
"RTN","PSOORNEW",8,0)
 ;
"RTN","PSOORNEW",9,0)
 ;PSO*237 quit Finish if Today > Issue date + 365
"RTN","PSOORNEW",10,0)
 ;
"RTN","PSOORNEW",11,0)
DSPL I $G(PSODSPL) S VALMBCK="Q" K PSODSPL,PSOANSQD Q
"RTN","PSOORNEW",12,0)
 Q:'$D(PSOLMC)  K ^TMP("PSOPO",$J) S PSOLMC=PSOLMC+1
"RTN","PSOORNEW",13,0)
 I $D(CLOZPAT) S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),1:7) G OI
"RTN","PSOORNEW",14,0)
 S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3))&('$G(PSONEW("DAYS SUPPLY"))):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:30)
"RTN","PSOORNEW",15,0)
OI I '$G(PSODRUG("OI")) D
"RTN","PSOORNEW",16,0)
 .N OI,OID S (OI,PSODRUG("OI"))=$P(OR0,"^",8),PSODRUG("OIN")=$P(^PS(50.7,$P(OR0,"^",8),0),"^"),OID=$P(OR0,"^",9)
"RTN","PSOORNEW",17,0)
 .I $P($G(OR0),"^",9) S POERR=1,DREN=$P(OR0,"^",9) D DRG^PSOORDRG K POERR
"RTN","PSOORNEW",18,0)
 I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A",$G(PSODRUG("DEA"))'["B"!($G(PSODRUG("DEA"))["F") S PSONEW("# OF REFILLS")=0
"RTN","PSOORNEW",19,0)
 I $D(CLOZPAT) S PSONEW("# OF REFILLS")=$S($D(PSONEW("# OF REFILLS")):PSONEW("# OF REFILLS"),$G(CLOZPAT)=2&($P(OR0,"^",11)>2):3,$G(CLOZPAT)&($P(OR0,"^",11)>1):1,1:0)
"RTN","PSOORNEW",20,0)
 S IEN=0 D OBX^PSOORFI1,DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:""))
"RTN","PSOORNEW",21,0)
 D LMDISP^PSOORFI5(+$G(ORD)) ; Display Flag/Unflag Information
"RTN","PSOORNEW",22,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="*(1) Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNEW",23,0)
 S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",24,0)
 K LST I $G(PSODRUG("NAME"))]"" D  G PT
"RTN","PSOORNEW",25,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)"_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORNEW",26,0)
 .S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",27,0)
 .I $P($G(^PSDRUG(PSODRUG("IEN"),0)),"^",10)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Drug Message:" D DRGMSG
"RTN","PSOORNEW",28,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)           Drug: No Dispense Drug Selected"
"RTN","PSOORNEW",29,0)
PT D DOSE2^PSOORFI4
"RTN","PSOORNEW",30,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (4)   Pat Instruct:" D:$O(PSONEW("SIG",0)) INST^PSOORFI4
"RTN","PSOORNEW",31,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Provider Comments:" S TY=3 D INST^PSOORFI1
"RTN","PSOORNEW",32,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Instructions:" S TY=2 D INST^PSOORFI1
"RTN","PSOORNEW",33,0)
 K PSOELSE S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                SIG:"
"RTN","PSOORNEW",34,0)
 F I=0:0 S I=$O(SIG(I)) Q:'I  S SIG=SIG(I) D
"RTN","PSOORNEW",35,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNEW",36,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (5) Patient Status: "_$P($G(^PS(53,+PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORNEW",37,0)
 K PSOELSE I $G(PSONEW("ISSUE DATE"))']"" S PSOELSE=1 S IEN=IEN+1,(PSOID,Y)=$E($P(OR0,"^",6),1,7) X ^DD("DD") S PSONEW("ISSUE DATE")=Y,^TMP("PSOPO",$J,IEN,0)=" (4)     Issue Date: "_Y
"RTN","PSOORNEW",38,0)
 I '$G(PSOELSE) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (6)     Issue Date: "_PSONEW("ISSUE DATE")
"RTN","PSOORNEW",39,0)
 K PSOELSE I $G(PSORX("FILL DATE"))']"" S PSOELSE=1 D
"RTN","PSOORNEW",40,0)
 .S (Y,PSORX("FILL DATE"))=$S($E($P(OR0,"^",6),1,7)<DT:DT,1:$E($P(OR0,"^",6),1,7)) X ^DD("DD") S PSONEW("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                  (5) Fill Date: "_Y
"RTN","PSOORNEW",41,0)
 I '$G(PSOELSE) S Y=PSORX("FILL DATE") X ^DD("DD") S PSORX("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"       (7) Fill Date: "_PSORX("FILL DATE")
"RTN","PSOORNEW",42,0)
 I $P(OR0,"^",18) S IEN=IEN+1,Y=$P(OR0,"^",18) X ^DD("DD") S $P(^TMP("PSOPO",$J,IEN,0)," ",39)="Effective Date: "_Y
"RTN","PSOORNEW",43,0)
 I $D(CLOZPAT) D ELIG^PSOORFI2 S:'$D(PSONEW("QTY")) PSONEW("QTY")=0
"RTN","PSOORNEW",44,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (8)    Days Supply: "_PSONEW("DAYS SUPPLY")
"RTN","PSOORNEW",45,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"               (9)   QTY"_$S($P($G(^PSDRUG(+$G(PSODRUG("IEN")),660)),"^",8)]"":" ("_$P($G(^PSDRUG(+PSODRUG("IEN"),660)),"^",8)_")",1:" (  )")
"RTN","PSOORNEW",46,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_": "_$S($G(PSONEW("QTY"))]"":PSONEW("QTY"),1:$P(OR0,"^",10))
"RTN","PSOORNEW",47,0)
 I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),5)),"^")]"" D
"RTN","PSOORNEW",48,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNEW",49,0)
 .S ^TMP("PSOPO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^") K RN
"RTN","PSOORNEW",50,0)
 S IEN=IEN+1
"RTN","PSOORNEW",51,0)
 I $P(OR0,"^",24) S ^TMP("PSOPO",$J,IEN,0)="   Provider ordered: days supply "_+$P(OR0,"^",22)_", quantity "_$P(OR0,"^",10)_" & refills "_+$P(OR0,"^",11)
"RTN","PSOORNEW",52,0)
 E  S ^TMP("PSOPO",$J,IEN,0)="       Provider ordered "_+$P(OR0,"^",11)_" refills"
"RTN","PSOORNEW",53,0)
 D:$D(CLOZPAT) PQTY^PSOORFI4
"RTN","PSOORNEW",54,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(10)   # of Refills: "_$S($G(PSONEW("# OF REFILLS"))]"":PSONEW("# OF REFILLS"),1:$P(OR0,"^",11))_"               (11)   Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORNEW",55,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(12)         Clinic: "_PSORX("CLINIC")
"RTN","PSOORNEW",56,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(13)       Provider: "_PSONEW("PROVIDER NAME")
"RTN","PSOORNEW",57,0)
 D:$P(OR0,"^",24)!((+$G(PSODRUG("DEA"))>1)&(+$G(PSODRUG("DEA"))<6)) PRV^PSOORFI5($G(PSONEW("PROVIDER")),$G(PSODRUG("IEN")),$P(OR0,"^"))
"RTN","PSOORNEW",58,0)
 I $P($G(^VA(200,$S($G(PSONEW("PROVIDER")):PSONEW("PROVIDER"),1:$P(OR0,"^",5)),"PS")),"^",7)&($P($G(^("PS")),"^",8)) D
"RTN","PSOORNEW",59,0)
 .S IEN=IEN+1,PSONEW("COSIGNING PROVIDER")=$S($G(PSONEW("COSIGNING PROVIDER")):PSONEW("COSIGNING PROVIDER"),1:$P(^("PS"),"^",8))
"RTN","PSOORNEW",60,0)
 .S ^TMP("PSOPO",$J,IEN,0)="       Cos-Provider: "_$P(^VA(200,PSONEW("COSIGNING PROVIDER"),0),"^")
"RTN","PSOORNEW",61,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(14)         Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1)
"RTN","PSOORNEW",62,0)
 S PSONEW("REMARKS")=$S($G(PSONEW("REMARKS"))]"":PSONEW("REMARKS"),$P(OR0,"^",17)="C":"Administered in Clinic.",1:"")
"RTN","PSOORNEW",63,0)
 K PSONEW("ADMINCLINIC") S:$P(OR0,"^",17)="C" PSONEW("ADMINCLINIC")=1
"RTN","PSOORNEW",64,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(15)        Remarks:"
"RTN","PSOORNEW",65,0)
 I $G(PSONEW("REMARKS"))]"" D
"RTN","PSOORNEW",66,0)
 .F SG=1:1:$L(PSONEW("REMARKS")) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("REMARKS")," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",67,0)
 ..S:$P(PSONEW("REMARKS")," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("REMARKS")," ",SG)
"RTN","PSOORNEW",68,0)
 I $G(PSOSIGFL)!(PSODRUG("OI")'=$P(OR0,"^",8)) S PSONEW("CLERK CODE")=DUZ,PSORX("CLERK CODE")=$P(^VA(200,DUZ,0),"^"),VALMSG="This change will create a new prescription!"
"RTN","PSOORNEW",69,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,PSONEW("CLERK CODE"),0),"^")_$E(RN,$L($P(^VA(200,PSONEW("CLERK CODE"),0),"^"))+1,35)
"RTN","PSOORNEW",70,0)
 S Y=$P(OR0,"^",12) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$E($P(OR0,"^",12),4,5)_"/"_$E($P(OR0,"^",12),6,7)_"/"_$E($P(OR0,"^",12),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORNEW",71,0)
 I PSOLMC<2 D ^PSOLMPO1 S VALMBCK="Q",PSOLMC=0
"RTN","PSOORNEW",72,0)
 S:PSOLMC>1 VALMBCK="R"
"RTN","PSOORNEW",73,0)
 Q
"RTN","PSOORNEW",74,0)
ORCHK D PROVCOM^PSOORFI4,ORCHK^PSOORFI4
"RTN","PSOORNEW",75,0)
 Q
"RTN","PSOORNEW",76,0)
EDT D KV S DIR("A",1)="* Indicates which fields will create an new Order",DIR("A")="Select Field to Edit by number",DIR(0)="LO^1:15" D ^DIR Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOORNEW",77,0)
EDTSEL N LST,FLD,OUT,CHECK,CSDRG D KV S (OUT,CSDRG)=0 ;/BLB/ PSO*7.0*505 MODIFIED EDIT FUNCTIONALITY TO BLOCK CERTAIN FIELDS FOR CONTROLLED SUBSTANCE RX
"RTN","PSOORNEW",78,0)
 I '$D(PSODRG) S PSODRG=$G(PSODRUG("IEN"))
"RTN","PSOORNEW",79,0)
 I PSODRG,$$NDF(PSODRG)!($$CSDRG(PSODRG)) S CSDRG=1
"RTN","PSOORNEW",80,0)
 I +Y S LST=Y D FULL^VALM1 N PSODOSE M PSODOSE=PSONEW D  G DSPL
"RTN","PSOORNEW",81,0)
 .I CSDRG,(","_LST[",1,")!(","_LST[",3,")!(","_LST[",10,")!(","_LST[",13,") D
"RTN","PSOORNEW",82,0)
 ..W !!,"The selection includes field(s) that are not editable" W !,"for controlled substances. These field(s) will be skipped.",!
"RTN","PSOORNEW",83,0)
 ..S DIR(0)="E" D ^DIR K DIR
"RTN","PSOORNEW",84,0)
 .F FLD=1:1:$L(LST,",") Q:$P(LST,",",FLD)']""!(OUT)  D
"RTN","PSOORNEW",85,0)
 ..S CHECK=","_+$P(LST,",",FLD)_"," I CSDRG,",1,3,10,13,"[CHECK Q
"RTN","PSOORNEW",86,0)
 ..D @(+$P(LST,",",FLD)) D:$P(LST,",",FLD)=8 REF D KV
"RTN","PSOORNEW",87,0)
 E  S VALMBCK="" Q
"RTN","PSOORNEW",88,0)
ACP ;
"RTN","PSOORNEW",89,0)
 N PSOORNEW,DIR,Y S Y=0,PSOORNEW=1
"RTN","PSOORNEW",90,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 D  Q:$D(DIRUT)!'Y  D EN1^ORCFLAG(+$P($G(^PS(52.41,ORD,0)),"^")) H 1
"RTN","PSOORNEW",91,0)
 . D FULL^VALM1
"RTN","PSOORNEW",92,0)
 . I '$D(^XUSEC("PSORPH",DUZ)) D  S Y=0 Q
"RTN","PSOORNEW",93,0)
 . . S DIR("A",1)="Order must be unflagged by a pharmacist before it can be finished."
"RTN","PSOORNEW",94,0)
 . . S DIR("A",2)=""
"RTN","PSOORNEW",95,0)
 . . S DIR(0)="E",DIR("A")="Enter RETURN to continue" W !,$C(7) D ^DIR
"RTN","PSOORNEW",96,0)
 . . S VALMBCK="R"
"RTN","PSOORNEW",97,0)
 . D KV
"RTN","PSOORNEW",98,0)
 . S DIR("A",1)="This Order is flagged. In order to finish it"
"RTN","PSOORNEW",99,0)
 . S DIR("A",2)="you must unflag it first."
"RTN","PSOORNEW",100,0)
 . S DIR("A",3)=""
"RTN","PSOORNEW",101,0)
 . S DIR(0)="Y",DIR("A")="Unflag Order",DIR("B")="NO"
"RTN","PSOORNEW",102,0)
 . W ! D ^DIR I $D(DIRUT)!'Y S VALMBCK="Q"
"RTN","PSOORNEW",103,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 Q
"RTN","PSOORNEW",104,0)
 ;
"RTN","PSOORNEW",105,0)
 I $D(CLOZPAT),+$G(PSONEW("QTY"))=0 S VALMSG="Unable to calculate the quantity, enter a quantity" G DSPL
"RTN","PSOORNEW",106,0)
 S (PSODIR("DFLG"),PSORX("DFLG"),PSODIR("QFLD"))=0,ACP=1 D ORCHK
"RTN","PSOORNEW",107,0)
 ;PATCH PSO*7*505 - Blocking action FN if issuing a controlled substance to a patient without a zipcode
"RTN","PSOORNEW",108,0)
 I '$D(VAPA) N VAPA D ADD^VADPT
"RTN","PSOORNEW",109,0)
 S DRGIEN=PSODRUG("IEN")
"RTN","PSOORNEW",110,0)
 I $$CSDRG(DRGIEN)!($$NDF(DRGIEN)),'($L(VAPA(6))),'($L(VAPA(11))) D  S DIR(0)="E" W ! D ^DIR K DIR K Y Q
"RTN","PSOORNEW",111,0)
 .W !,"Controlled substance prescriptions require a patient"
"RTN","PSOORNEW",112,0)
 .W !,"address. Please update patient address information."
"RTN","PSOORNEW",113,0)
 G:$G(PSONEW("QFLG")) DSPL
"RTN","PSOORNEW",114,0)
 I $G(PSODIR("DFLG"))!$G(PSORX("DFLG")) Q
"RTN","PSOORNEW",115,0)
 I $G(PSONEW("FLD"))!($G(PSODRUG("NAME"))']"")!('$O(SIG(0))) G DSPL
"RTN","PSOORNEW",116,0)
 I $G(PSODRUG("NAME"))]"",'$G(ORCHK)!($G(ORDRG)'=PSODRUG("NAME")) D  I $G(PSORX("DFLG")) D CLEAN^PSOVER1 G DSPL
"RTN","PSOORNEW",117,0)
 . D POST^PSODRG S:'$G(PSORX("DFLG")) ORCHK=1,ORDRG=PSODRUG("NAME")
"RTN","PSOORNEW",118,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("N") I $G(PSORX("DFLG")) G DSPL
"RTN","PSOORNEW",119,0)
 I '$D(PSONEW("RX #")) S PSOFROM="NEW",RTN=$S($P($G(PSOPAR),"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN") D @RTN Q:PSONEW("QFLG")  I '$P($G(PSOPAR),"^",7) S PSOX=PSONEW("RX #") D CHECK^PSONRXN
"RTN","PSOORNEW",120,0)
 D RXNCHK^PSOORNE1 I $G(PSONEW("QFLG")) S PSONEW("DFLG")=1 Q
"RTN","PSOORNEW",121,0)
 I DT>$$FMADD^XLFDT($P(OR0,"^",6),365) D EXPR^PSONEW2 G DSPL
"RTN","PSOORNEW",122,0)
 D STOP^PSONEW2,DISPLAY^PSONEW2,^PSONEWF
"RTN","PSOORNEW",123,0)
 I $G(PSOCPZ("DFLG")) W !!,"No action taken!",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR,KV K PSOCPZ("DFLG"),DRET,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",124,0)
 ;
"RTN","PSOORNEW",125,0)
 K PSOCPZ("DFLG") D KV S DIR(0)="Y",DIR("A")="Are you sure you want to Accept this Order",DIR("B")="NO" D ^DIR I $D(DIRUT) D KV K DRET,PSOANSQ,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",126,0)
 D KV I 'Y K PSOANSQ G DSPL
"RTN","PSOORNEW",127,0)
 I $G(PSONEW("MAIL/WINDOW"))["W" D:$P($G(PSOPAR),"^",12)  S BINGCRT="Y",BINGRTE="W",PSORX("MAIL/WINDOW")="WINDOW" K RTN
"RTN","PSOORNEW",128,0)
 .W ! K DIR,DIRUT S DIR(0)="52,35O"
"RTN","PSOORNEW",129,0)
 .S:$G(PSORX("METHOD OF PICK-UP"))]"" DIR("B")=PSORX("METHOD OF PICK-UP") D ^DIR I $D(DIRUT) K DIR,DIRUT Q
"RTN","PSOORNEW",130,0)
 .S (PSONEW("METHOD OF PICK-UP"),PSORX("METHOD OF PICK-UP"))=Y K X,Y
"RTN","PSOORNEW",131,0)
 S PSONEW("POE")=1 K PSORX("DFLG"),PSONEW("DFLG") D EN^PSON52(.PSONEW) G:$G(PSONEW("DFLG")) ABORT D DCORD^PSONEW2 D:$G(PKI)=89802020 ALERT^PSOPKIV1
"RTN","PSOORNEW",132,0)
 ; - Possible Titration Rx?
"RTN","PSOORNEW",133,0)
 I $G(PSONEW("IRXN")) D MARK^PSOOTMRX(PSONEW("IRXN"),0)
"RTN","PSOORNEW",134,0)
 ;saves drug allergy order chks pso*7*390
"RTN","PSOORNEW",135,0)
 I $D(^TMP("PSODAOC",$J)) D
"RTN","PSOORNEW",136,0)
 .I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSOORNEW",137,0)
 .S RXN=PSONEW("IRXN"),PSODAOC="Finished CPRS Rx "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"Order Acceptance_OP"
"RTN","PSOORNEW",138,0)
 .D DAOC^PSONEW
"RTN","PSOORNEW",139,0)
 D NPSOSD^PSOUTIL(.PSONEW),FULL^VALM1 K PSORX("MAIL/WINDOW")
"RTN","PSOORNEW",140,0)
 D EOJ^PSONEW
"RTN","PSOORNEW",141,0)
ABORT S VALMBCK="Q",DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR,CLEAN^PSOVER1,KV
"RTN","PSOORNEW",142,0)
 Q
"RTN","PSOORNEW",143,0)
KV K DIRUT,DUOUT,DTOUT,DIR,PSOEDDOS
"RTN","PSOORNEW",144,0)
 Q
"RTN","PSOORNEW",145,0)
REF ;
"RTN","PSOORNEW",146,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSOORNEW",147,0)
 N MAXRF S MAXRF=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),+$G(PSONEW("DAYS SUPPLY")),+$G(PSONEW("PATIENT STATUS")),.CLOZPAT)
"RTN","PSOORNEW",148,0)
 I ($G(PSONEW("# OF REFILLS"))'="")&($G(PSONEW("# OF REFILLS"))'>MAXRF) D
"RTN","PSOORNEW",149,0)
 . S PSONEW("N# REF")=PSONEW("# OF REFILLS")
"RTN","PSOORNEW",150,0)
 E  D
"RTN","PSOORNEW",151,0)
 . S (PSONEW("N# REF"),PSONEW("# OF REFILLS"))=MAXRF
"RTN","PSOORNEW",152,0)
 Q
"RTN","PSOORNEW",153,0)
1 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",154,0)
 . W !!,"Digitally Signed Order - Orderable Item cannot be changed",! D PZ
"RTN","PSOORNEW",155,0)
 N PSOBDR,PSOBDRG S PSOBDRG=1 D 1^PSOORNW2 Q  ;oi
"RTN","PSOORNEW",156,0)
 ;
"RTN","PSOORNEW",157,0)
4 D INS^PSOORNW2 Q
"RTN","PSOORNEW",158,0)
 ;
"RTN","PSOORNEW",159,0)
3 I $G(LST)["3,",$P(OR0,"^",24) D  Q 
"RTN","PSOORNEW",160,0)
 . W !!,"Digitally Signed Order - Dose cannot be changed",! D PZ
"RTN","PSOORNEW",161,0)
 N PSOEDDOS S PSOEDDOS=1 D DOSE^PSOORED4(.PSONEW) Q
"RTN","PSOORNEW",162,0)
 ;
"RTN","PSOORNEW",163,0)
6 D 4^PSOORNW2 Q  ;idt
"RTN","PSOORNEW",164,0)
 ;
"RTN","PSOORNEW",165,0)
7 D 5^PSOORNW2 Q  ;fdt
"RTN","PSOORNEW",166,0)
 ;
"RTN","PSOORNEW",167,0)
5 D 3^PSOORNW2 Q  ;pstat
"RTN","PSOORNEW",168,0)
 ;
"RTN","PSOORNEW",169,0)
13 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",170,0)
 . W !!,"Digitally Signed Order - Provider cannot be changed",! D PZ
"RTN","PSOORNEW",171,0)
 D 12^PSOORNW2 Q  ;doc
"RTN","PSOORNEW",172,0)
 ;
"RTN","PSOORNEW",173,0)
12 D 11^PSOORNW2 Q  ;cli
"RTN","PSOORNEW",174,0)
 ;
"RTN","PSOORNEW",175,0)
2 N PSOCSIG I '$G(PSOBDRG) N PSOBDR,PSOBDRG S PSOBDRG=1,PSOQFLG=0
"RTN","PSOORNEW",176,0)
 N CPRN S CPRN=+$P($G(OR0),"^",24) D 2^PSOORNW1 Q:$G(PSOQFLG)  D EN^PSODIAG  ;drg/ICD
"RTN","PSOORNEW",177,0)
 I $G(PSOCSIG) K PSOCSIG G 3
"RTN","PSOORNEW",178,0)
 Q
"RTN","PSOORNEW",179,0)
 ;
"RTN","PSOORNEW",180,0)
9 D 8^PSOORNW2 Q  ;qty
"RTN","PSOORNEW",181,0)
 ;
"RTN","PSOORNEW",182,0)
8 N CPRN S CPRN=+$P($G(OR0),"^",24) D 7^PSOORNW2 Q  ;ds
"RTN","PSOORNEW",183,0)
 ;
"RTN","PSOORNEW",184,0)
10 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",185,0)
 . W !!,"Digitally Signed Order - Refills cannot be changed",! D PZ
"RTN","PSOORNEW",186,0)
 D 9^PSOORNW2 Q  ;#rfs
"RTN","PSOORNEW",187,0)
 ;
"RTN","PSOORNEW",188,0)
14 D 13^PSOORNW2 Q  ;cop
"RTN","PSOORNEW",189,0)
 ;
"RTN","PSOORNEW",190,0)
11 D 10^PSOORNW2 Q  ;m/w
"RTN","PSOORNEW",191,0)
 ;
"RTN","PSOORNEW",192,0)
15 D 14^PSOORNW2 Q  ;rem
"RTN","PSOORNEW",193,0)
 ;
"RTN","PSOORNEW",194,0)
DRGMSG ;
"RTN","PSOORNEW",195,0)
 F SG=1:1:$L($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",196,0)
 .S:$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)
"RTN","PSOORNEW",197,0)
 K SG
"RTN","PSOORNEW",198,0)
 Q
"RTN","PSOORNEW",199,0)
 ;
"RTN","PSOORNEW",200,0)
PZ ;
"RTN","PSOORNEW",201,0)
 N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOORNEW",202,0)
 Q
"RTN","PSOORNEW",203,0)
CSDRG(DRGIEN) ;/BLB/ Patch PSO*7*505 Controlled Substance drug?
"RTN","PSOORNEW",204,0)
 ; Input: DRGIEN - DRUG file (#50) pointer
"RTN","PSOORNEW",205,0)
 ;Output: $$CS - 1:YES / 0:NO
"RTN","PSOORNEW",206,0)
 N DEA
"RTN","PSOORNEW",207,0)
 Q:'DRGIEN 0
"RTN","PSOORNEW",208,0)
 S DEA=$$GET1^DIQ(50,DRGIEN,3)
"RTN","PSOORNEW",209,0)
 I (DEA'["0"),(DEA'["M"),(DEA["2")!(DEA["3")!(DEA["4")!(DEA["5") Q 1
"RTN","PSOORNEW",210,0)
 Q 0
"RTN","PSOORNEW",211,0)
NDF(DRGIEN) ;PATCH PSO*7*505 - 1:YES 0:NO checks the cs federal schedule field of the va product file
"RTN","PSOORNEW",212,0)
 N DEARES,VPROD
"RTN","PSOORNEW",213,0)
 S VPROD=$$GET1^DIQ(50,DRGIEN,22,"I") Q:'VPROD 0
"RTN","PSOORNEW",214,0)
 S DEARES=$$GET1^DIQ(50.68,VPROD,19,"I")
"RTN","PSOORNEW",215,0)
 I +$E(DEARES)>0 Q 1
"RTN","PSOORNEW",216,0)
 Q 0
"RTN","PSOOTMRX")
0^3^B23201302^B20486782
"RTN","PSOOTMRX",1,0)
PSOOTMRX ;BIR/MFR - Titration/Maintenance Dose Prescription ;10/17/96
"RTN","PSOOTMRX",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**313,505**;DEC 1997;Build 39
"RTN","PSOOTMRX",3,0)
 ;External reference to ULK^ORX2 supported by DBIA 867
"RTN","PSOOTMRX",4,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSOOTMRX",5,0)
 ;
"RTN","PSOOTMRX",6,0)
TIMTRX ; Titration/Maintenance Dose Rx Hidden Action Entry Point
"RTN","PSOOTMRX",7,0)
 N PSOMTFLG,PSOTITRX,PSORXIEN,LASTDOSE,BEFLST,DOSEINFO,DEA,LAB
"RTN","PSOOTMRX",8,0)
 S PSORXIEN=$P(PSOLST(ORN),"^",2)
"RTN","PSOOTMRX",9,0)
 ;
"RTN","PSOOTMRX",10,0)
 ; - Rx already marked Maintenance
"RTN","PSOOTMRX",11,0)
 I $$TITRX^PSOUTL(PSORXIEN)="m" D  Q
"RTN","PSOOTMRX",12,0)
 . S VALMSG="Prescription already marked as 'Maintenance Rx'.",VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",13,0)
 ;
"RTN","PSOOTMRX",14,0)
 ; - Rx already split into Maintenance Rx
"RTN","PSOOTMRX",15,0)
 I $P($G(^PSRX(PSORXIEN,"TIT")),"^",2) D  Q
"RTN","PSOOTMRX",16,0)
 . S VALMSG="A Maintenance Rx already exists for this Rx ("_$$GET1^DIQ(52,$P($G(^PSRX(PSORXIEN,"TIT")),"^",2),.01)_")"
"RTN","PSOOTMRX",17,0)
 . S VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",18,0)
 ;
"RTN","PSOOTMRX",19,0)
 ; - Rx was Digitally Signed
"RTN","PSOOTMRX",20,0)
 I $$GET1^DIQ(52,PSORXIEN,310,"I") D  Q
"RTN","PSOOTMRX",21,0)
 . S VALMSG="Rx was digitally signed and cannot be converted.",VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",22,0)
 ; 
"RTN","PSOOTMRX",23,0)
 ; - No THEN conjunction for the last dose
"RTN","PSOOTMRX",24,0)
 I '$$LTHEN^PSOUTL(PSORXIEN) D  Q
"RTN","PSOOTMRX",25,0)
 . S VALMSG="A Titration Rx must have a THEN conjunction.",VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",26,0)
 ;
"RTN","PSOOTMRX",27,0)
 ; - Rx is not ACTIVE
"RTN","PSOOTMRX",28,0)
 I $$GET1^DIQ(52,PSORXIEN,100,"I")'=0 D  Q
"RTN","PSOOTMRX",29,0)
 . S VALMSG="Prescription is not ACTIVE.",VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",30,0)
 ;
"RTN","PSOOTMRX",31,0)
 ; - Rx NOT released
"RTN","PSOOTMRX",32,0)
 I '$$RXRLDT^PSOBPSUT(PSORXIEN,0) D  Q
"RTN","PSOOTMRX",33,0)
 . S VALMSG="Prescription must be RELEASED first.",VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",34,0)
 ;
"RTN","PSOOTMRX",35,0)
 ; - Rx already has refills
"RTN","PSOOTMRX",36,0)
 I $O(^PSRX(PSORXIEN,1,0)) D  Q
"RTN","PSOOTMRX",37,0)
 . S VALMSG="Prescription has previously been refilled.",VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",38,0)
 ;
"RTN","PSOOTMRX",39,0)
 ; - Rx already has refills
"RTN","PSOOTMRX",40,0)
 I '$$GET1^DIQ(52,PSORXIEN,9) D  Q
"RTN","PSOOTMRX",41,0)
 . S VALMSG="There are no refills available for this Rx.",VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",42,0)
 ;
"RTN","PSOOTMRX",43,0)
 ; - Rx not been marked as Titration
"RTN","PSOOTMRX",44,0)
 I '$P($G(^PSRX(PSORXIEN,"TIT")),"^",3) D  Q
"RTN","PSOOTMRX",45,0)
 . S VALMSG="Rx has not been marked as Titration",VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",46,0)
 ;
"RTN","PSOOTMRX",47,0)
 S PSOMTFLG=1,PSOTITRX=PSORXIEN
"RTN","PSOOTMRX",48,0)
 D COPY^PSOORCPY K PSOMTFLG,PSOTITRX
"RTN","PSOOTMRX",49,0)
 ;
"RTN","PSOOTMRX",50,0)
 Q
"RTN","PSOOTMRX",51,0)
 ;
"RTN","PSOOTMRX",52,0)
MARKTIT ; Mark Rx as 'Titration' Hidden Action Entry Point
"RTN","PSOOTMRX",53,0)
 N PSORXIEN,CHECK
"RTN","PSOOTMRX",54,0)
 S PSORXIEN=$P(PSOLST(ORN),"^",2)
"RTN","PSOOTMRX",55,0)
 S CHECK=$$CHECK(PSORXIEN)
"RTN","PSOOTMRX",56,0)
 I 'CHECK D  Q
"RTN","PSOOTMRX",57,0)
 . S VALMBCK="R",VALMSG=$P(CHECK,"^",2) W $C(7)
"RTN","PSOOTMRX",58,0)
 ;
"RTN","PSOOTMRX",59,0)
 I $G(PSORXIEN) D MARK(PSORXIEN,1)
"RTN","PSOOTMRX",60,0)
 Q
"RTN","PSOOTMRX",61,0)
 ;
"RTN","PSOOTMRX",62,0)
END ;
"RTN","PSOOTMRX",63,0)
 Q
"RTN","PSOOTMRX",64,0)
 ;
"RTN","PSOOTMRX",65,0)
MARK(PSORXIEN,REFRESH) ; Mark a non-refillable Rx as Titration
"RTN","PSOOTMRX",66,0)
 N CHECK,DIR,PTLOCK,X,Y,DFN,COMM
"RTN","PSOOTMRX",67,0)
 ;
"RTN","PSOOTMRX",68,0)
 I '$$CHECK(PSORXIEN) Q
"RTN","PSOOTMRX",69,0)
 ;
"RTN","PSOOTMRX",70,0)
 D FULL^VALM1
"RTN","PSOOTMRX",71,0)
 W !
"RTN","PSOOTMRX",72,0)
 S DIR("A")="Do you want to "_$S($$TITRX^PSOUTL(PSORXIEN)="t":"UN",1:"")_"MARK this Rx as 'Titration'? "
"RTN","PSOOTMRX",73,0)
 I $$TITRX^PSOUTL(PSORXIEN)'="t" S (DIR("?"),DIR("??"))="^D TITHLP^PSOOTMRX"
"RTN","PSOOTMRX",74,0)
 S DIR(0)="YA" D ^DIR I Y'>0 D UNLK S VALMBCK="R" Q
"RTN","PSOOTMRX",75,0)
 ;
"RTN","PSOOTMRX",76,0)
 W !!,"Updating..."
"RTN","PSOOTMRX",77,0)
 I '$P($G(^PSRX(PSORXIEN,"TIT")),"^",3) D
"RTN","PSOOTMRX",78,0)
 . S $P(^PSRX(PSORXIEN,"TIT"),"^",3)=1,COMM="MARKED as Titration"
"RTN","PSOOTMRX",79,0)
 E  D
"RTN","PSOOTMRX",80,0)
 . S $P(^PSRX(PSORXIEN,"TIT"),"^",3)="",COMM="UNMARKED as Titration"
"RTN","PSOOTMRX",81,0)
 . I ($D(^PSRX(PSORXIEN,"TIT"))=1),$TR($G(^PSRX(PSORXIEN,"TIT")),"^","")="" D
"RTN","PSOOTMRX",82,0)
 . . K ^PSRX(PSORXIEN,"TIT")      ; Cleaning up the "TIT" subscript
"RTN","PSOOTMRX",83,0)
 D RXACT^PSOBPSU2(PSORXIEN,,COMM,"E")
"RTN","PSOOTMRX",84,0)
 H 1 W "OK"
"RTN","PSOOTMRX",85,0)
 ;
"RTN","PSOOTMRX",86,0)
 ; PSORXED is necessary to perform a REFRESH only
"RTN","PSOOTMRX",87,0)
 I $G(REFRESH) N PSORXED S PSORXED=1 D ACT^PSOORNE2 S VALMBCK="R"
"RTN","PSOOTMRX",88,0)
 ;
"RTN","PSOOTMRX",89,0)
 Q
"RTN","PSOOTMRX",90,0)
 ;
"RTN","PSOOTMRX",91,0)
UNLK ; Unlocks the Patient/Rx
"RTN","PSOOTMRX",92,0)
 S X=PSODFN_";DPT(" D ULK^ORX2
"RTN","PSOOTMRX",93,0)
 D UL^PSSLOCK(PSODFN)
"RTN","PSOOTMRX",94,0)
 Q
"RTN","PSOOTMRX",95,0)
 ;
"RTN","PSOOTMRX",96,0)
CHECK(PSORXIEN) ; Checks if Rx is eligible to be Marked as Titration/Maintenance
"RTN","PSOOTMRX",97,0)
 N MSG
"RTN","PSOOTMRX",98,0)
 S MSG=""
"RTN","PSOOTMRX",99,0)
 ; - Rx already marked as  Maintenance
"RTN","PSOOTMRX",100,0)
 I $$TITRX^PSOUTL(PSORXIEN)="m" D  Q ("0^"_MSG)
"RTN","PSOOTMRX",101,0)
 . S MSG="Prescription already marked as 'Maintenance Rx'."
"RTN","PSOOTMRX",102,0)
 ;
"RTN","PSOOTMRX",103,0)
 ; - No THEN conjunction for the last dose
"RTN","PSOOTMRX",104,0)
 I '$$LTHEN^PSOUTL(PSORXIEN) D  Q ("0^"_MSG)
"RTN","PSOOTMRX",105,0)
 . S MSG="A TITRATION Rx must have a THEN conjunction."
"RTN","PSOOTMRX",106,0)
 ;
"RTN","PSOOTMRX",107,0)
 ;
"RTN","PSOOTMRX",108,0)
 ; - Rx is not ACTIVE or SUSPENDED
"RTN","PSOOTMRX",109,0)
 I $$GET1^DIQ(52,PSORXIEN,100,"I")'=0,$$GET1^DIQ(52,PSORXIEN,100,"I")'=5 D  Q ("0^"_MSG)
"RTN","PSOOTMRX",110,0)
 . S MSG="Prescription must be ACTIVE or SUSPENDED."
"RTN","PSOOTMRX",111,0)
 ;
"RTN","PSOOTMRX",112,0)
 ;/BLB/ PSO*7*505 - Added functionality to prevent marking controlled substance prescriptions as titration.
"RTN","PSOOTMRX",113,0)
 I $$NDF(PSORXIEN)!($$CSRX^PSOSPMUT(PSORXIEN)) D  Q ("0^"_MSG)
"RTN","PSOOTMRX",114,0)
 .S MSG="Cannot mark controlled substances as Titration."
"RTN","PSOOTMRX",115,0)
 Q 1
"RTN","PSOOTMRX",116,0)
 ;
"RTN","PSOOTMRX",117,0)
TITHLP ; Help Text for Mark Rx as Titration/Maintenance prompt
"RTN","PSOOTMRX",118,0)
 W !?5,"Answer YES if this is a Titration to Maintenance prescription."
"RTN","PSOOTMRX",119,0)
 W !?5,"Actions such as Renewal (including from CPRS), Refill, and Copy"
"RTN","PSOOTMRX",120,0)
 W !?5,"are not allowed on prescriptions marked as Titration."
"RTN","PSOOTMRX",121,0)
 W !?5,"However, you will be able to create a Maintenance Rx from this Rx"
"RTN","PSOOTMRX",122,0)
 W !?5,"upon refill request via the TR (Convert Titration Rx) hidden action."
"RTN","PSOOTMRX",123,0)
 Q
"RTN","PSOOTMRX",124,0)
NDF(PSORXIEN) ;PATCH PSO*7*505 - 1:YES 0:NO checks the cs federal schedule field of the va product file
"RTN","PSOOTMRX",125,0)
 N DRGIEN,DEARES
"RTN","PSOOTMRX",126,0)
 S DRGIEN=$$GET1^DIQ(52,PSORXIEN,6,"I") I 'DRGIEN Q 0
"RTN","PSOOTMRX",127,0)
 S DEARES=$$GET1^DIQ(50.68,DRGIEN,19,"I")
"RTN","PSOOTMRX",128,0)
 I +$E(DEARES)>0 Q 1
"RTN","PSOOTMRX",129,0)
 Q 0
"VER")
8.0^22.2
"BLD",10346,6)
^434
**END**
**END**

