Released PSO*7*527 SEQ #436
Extracted from mail message
**KIDS**:PSO*7.0*527^

**INSTALL NAME**
PSO*7.0*527
"BLD",9969,0)
PSO*7.0*527^OUTPATIENT PHARMACY^0^3180627^y
"BLD",9969,4,0)
^9.64PA^59^3
"BLD",9969,4,52.48,0)
52.48
"BLD",9969,4,52.48,2,0)
^9.641^52.48^1
"BLD",9969,4,52.48,2,52.48,0)
ERX EXTERNAL PERSON  (File-top level)
"BLD",9969,4,52.48,2,52.48,1,0)
^9.6411^4.1^2
"BLD",9969,4,52.48,2,52.48,1,.03,0)
FIRST NAME
"BLD",9969,4,52.48,2,52.48,1,4.1,0)
STREET ADDRESS LINE 1
"BLD",9969,4,52.48,222)
y^y^p^^^^n^^n
"BLD",9969,4,52.48,224)
 
"BLD",9969,4,52.49,0)
52.49
"BLD",9969,4,52.49,2,0)
^9.641^52.49^1
"BLD",9969,4,52.49,2,52.49,0)
ERX HOLDING QUEUE  (File-top level)
"BLD",9969,4,52.49,2,52.49,1,0)
^9.6411^2.1^2
"BLD",9969,4,52.49,2,52.49,1,.04,0)
EXTERNAL PATIENT IDENTIFIER
"BLD",9969,4,52.49,2,52.49,1,2.1,0)
EXTERNAL PROVIDER
"BLD",9969,4,52.49,222)
y^y^p^^^^n^^n
"BLD",9969,4,52.49,224)
 
"BLD",9969,4,59,0)
59
"BLD",9969,4,59,2,0)
^9.641^59^1
"BLD",9969,4,59,2,59,0)
OUTPATIENT SITE  (File-top level)
"BLD",9969,4,59,2,59,1,0)
^9.6411^10.2^1
"BLD",9969,4,59,2,59,1,10.2,0)
ERX DEFAULT LOOKBACK DAYS
"BLD",9969,4,59,222)
y^y^p^^^^n^^n
"BLD",9969,4,59,224)
 
"BLD",9969,4,"APDD",52.48,52.48)
 
"BLD",9969,4,"APDD",52.48,52.48,.03)
 
"BLD",9969,4,"APDD",52.48,52.48,4.1)
 
"BLD",9969,4,"APDD",52.49,52.49)
 
"BLD",9969,4,"APDD",52.49,52.49,.04)
 
"BLD",9969,4,"APDD",52.49,52.49,2.1)
 
"BLD",9969,4,"APDD",59,59)
 
"BLD",9969,4,"APDD",59,59,10.2)
 
"BLD",9969,4,"B",52.48,52.48)
 
"BLD",9969,4,"B",52.49,52.49)
 
"BLD",9969,4,"B",59,59)
 
"BLD",9969,6.3)
30
"BLD",9969,"INIT")
PSO527PO
"BLD",9969,"KRN",0)
^9.67PA^779.2^20
"BLD",9969,"KRN",.4,0)
.4
"BLD",9969,"KRN",.401,0)
.401
"BLD",9969,"KRN",.402,0)
.402
"BLD",9969,"KRN",.402,"NM",0)
^9.68A^1^1
"BLD",9969,"KRN",.402,"NM",1,0)
PSO SITE    FILE #59^59^0
"BLD",9969,"KRN",.402,"NM","B","PSO SITE    FILE #59",1)
 
"BLD",9969,"KRN",.403,0)
.403
"BLD",9969,"KRN",.5,0)
.5
"BLD",9969,"KRN",.84,0)
.84
"BLD",9969,"KRN",3.6,0)
3.6
"BLD",9969,"KRN",3.8,0)
3.8
"BLD",9969,"KRN",9.2,0)
9.2
"BLD",9969,"KRN",9.8,0)
9.8
"BLD",9969,"KRN",9.8,"NM",0)
^9.68A^10^9
"BLD",9969,"KRN",9.8,"NM",1,0)
PSOERX^^0^B70347933
"BLD",9969,"KRN",9.8,"NM",2,0)
PSOERX1^^0^B78477879
"BLD",9969,"KRN",9.8,"NM",3,0)
PSOERX1A^^0^B129260267
"BLD",9969,"KRN",9.8,"NM",5,0)
PSOERXP1^^0^B30549693
"BLD",9969,"KRN",9.8,"NM",6,0)
PSOERXR1^^0^B33604868
"BLD",9969,"KRN",9.8,"NM",7,0)
PSOERXX1^^0^B47206629
"BLD",9969,"KRN",9.8,"NM",8,0)
PSOERX1C^^0^B40194088
"BLD",9969,"KRN",9.8,"NM",9,0)
PSOERXH1^^0^B17222601
"BLD",9969,"KRN",9.8,"NM",10,0)
PSOERX1B^^0^B162952220
"BLD",9969,"KRN",9.8,"NM","B","PSOERX",1)
 
"BLD",9969,"KRN",9.8,"NM","B","PSOERX1",2)
 
"BLD",9969,"KRN",9.8,"NM","B","PSOERX1A",3)
 
"BLD",9969,"KRN",9.8,"NM","B","PSOERX1B",10)
 
"BLD",9969,"KRN",9.8,"NM","B","PSOERX1C",8)
 
"BLD",9969,"KRN",9.8,"NM","B","PSOERXH1",9)
 
"BLD",9969,"KRN",9.8,"NM","B","PSOERXP1",5)
 
"BLD",9969,"KRN",9.8,"NM","B","PSOERXR1",6)
 
"BLD",9969,"KRN",9.8,"NM","B","PSOERXX1",7)
 
"BLD",9969,"KRN",19,0)
19
"BLD",9969,"KRN",19.1,0)
19.1
"BLD",9969,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",9969,"KRN",101,0)
101
"BLD",9969,"KRN",101,"NM",0)
^9.68A^4^4
"BLD",9969,"KRN",101,"NM",1,0)
PSO ERX HQ MENU^^0
"BLD",9969,"KRN",101,"NM",2,0)
PSO ERX HQ SEARCH^^4^
"BLD",9969,"KRN",101,"NM",3,0)
PSO ERX HQ SORT^^4^
"BLD",9969,"KRN",101,"NM",4,0)
PSO ERX HQ SELECT^^4^
"BLD",9969,"KRN",101,"NM","B","PSO ERX HQ MENU",1)
 
"BLD",9969,"KRN",101,"NM","B","PSO ERX HQ SEARCH",2)
 
"BLD",9969,"KRN",101,"NM","B","PSO ERX HQ SELECT",4)
 
"BLD",9969,"KRN",101,"NM","B","PSO ERX HQ SORT",3)
 
"BLD",9969,"KRN",409.61,0)
409.61
"BLD",9969,"KRN",771,0)
771
"BLD",9969,"KRN",779.2,0)
779.2
"BLD",9969,"KRN",870,0)
870
"BLD",9969,"KRN",8989.51,0)
8989.51
"BLD",9969,"KRN",8989.52,0)
8989.52
"BLD",9969,"KRN",8994,0)
8994
"BLD",9969,"KRN","B",.4,.4)
 
"BLD",9969,"KRN","B",.401,.401)
 
"BLD",9969,"KRN","B",.402,.402)
 
"BLD",9969,"KRN","B",.403,.403)
 
"BLD",9969,"KRN","B",.5,.5)
 
"BLD",9969,"KRN","B",.84,.84)
 
"BLD",9969,"KRN","B",3.6,3.6)
 
"BLD",9969,"KRN","B",3.8,3.8)
 
"BLD",9969,"KRN","B",9.2,9.2)
 
"BLD",9969,"KRN","B",9.8,9.8)
 
"BLD",9969,"KRN","B",19,19)
 
"BLD",9969,"KRN","B",19.1,19.1)
 
"BLD",9969,"KRN","B",101,101)
 
"BLD",9969,"KRN","B",409.61,409.61)
 
"BLD",9969,"KRN","B",771,771)
 
"BLD",9969,"KRN","B",779.2,779.2)
 
"BLD",9969,"KRN","B",870,870)
 
"BLD",9969,"KRN","B",8989.51,8989.51)
 
"BLD",9969,"KRN","B",8989.52,8989.52)
 
"BLD",9969,"KRN","B",8994,8994)
 
"BLD",9969,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9969,"QUES",0)
^9.62^^
"BLD",9969,"REQB",0)
^9.611^2^2
"BLD",9969,"REQB",1,0)
PSO*7.0*520^2
"BLD",9969,"REQB",2,0)
PSO*7.0*467^2
"BLD",9969,"REQB","B","PSO*7.0*467",2)
 
"BLD",9969,"REQB","B","PSO*7.0*520",1)
 
"FIA",52.48)
ERX EXTERNAL PERSON
"FIA",52.48,0)
^PS(52.48,
"FIA",52.48,0,0)
52.48I
"FIA",52.48,0,1)
y^y^p^^^^n^^n
"FIA",52.48,0,10)
 
"FIA",52.48,0,11)
 
"FIA",52.48,0,"RLRO")
 
"FIA",52.48,0,"VR")
7.0^PSO
"FIA",52.48,52.48)
1
"FIA",52.48,52.48,.03)
 
"FIA",52.48,52.48,4.1)
 
"FIA",52.49)
ERX HOLDING QUEUE
"FIA",52.49,0)
^PS(52.49,
"FIA",52.49,0,0)
52.49
"FIA",52.49,0,1)
y^y^p^^^^n^^n
"FIA",52.49,0,10)
 
"FIA",52.49,0,11)
 
"FIA",52.49,0,"RLRO")
 
"FIA",52.49,0,"VR")
7.0^PSO
"FIA",52.49,52.49)
1
"FIA",52.49,52.49,.04)
 
"FIA",52.49,52.49,2.1)
 
"FIA",59)
OUTPATIENT SITE
"FIA",59,0)
^PS(59,
"FIA",59,0,0)
59I
"FIA",59,0,1)
y^y^p^^^^n^^n
"FIA",59,0,10)
 
"FIA",59,0,11)
 
"FIA",59,0,"RLRO")
 
"FIA",59,0,"VR")
7.0^PSO
"FIA",59,59)
1
"FIA",59,59,10.2)
 
"INIT")
PSO527PO
"IX",52.49,52.49,"EPAT",0)
52.49^EPAT^Index by Institution,Date/Time, and Patient^R^^R^IR^I^52.49^^^^^LS
"IX",52.49,52.49,"EPAT",.1,0)
^^2^2^3180524^
"IX",52.49,52.49,"EPAT",.1,1,0)
This indexes the institution, eRx received date/time, and patient IEN for 
"IX",52.49,52.49,"EPAT",.1,2,0)
quick lookup when using the search feature.
"IX",52.49,52.49,"EPAT",1)
S ^PS(52.49,"EPAT",X(1),X(2),X(3),DA)=""
"IX",52.49,52.49,"EPAT",2)
K ^PS(52.49,"EPAT",X(1),X(2),X(3),DA)
"IX",52.49,52.49,"EPAT",2.5)
K ^PS(52.49,"EPAT")
"IX",52.49,52.49,"EPAT",11.1,0)
^.114IA^3^3
"IX",52.49,52.49,"EPAT",11.1,1,0)
1^F^52.49^24.1^^1^F
"IX",52.49,52.49,"EPAT",11.1,1,3)
 
"IX",52.49,52.49,"EPAT",11.1,2,0)
2^F^52.49^.03^^2^F
"IX",52.49,52.49,"EPAT",11.1,2,3)
 
"IX",52.49,52.49,"EPAT",11.1,3,0)
3^F^52.49^.04^^3^F
"IX",52.49,52.49,"EPAT",11.1,3,3)
 
"IX",52.49,52.49,"EPROV",0)
52.49^EPROV^This indexes the Institution,Date/Time, and Provider^R^^R^IR^I^52.49^^^^^LS
"IX",52.49,52.49,"EPROV",.1,0)
^^3^3^3180524^
"IX",52.49,52.49,"EPROV",.1,1,0)
This index provides quick access to the provider IEN associated with a 
"IX",52.49,52.49,"EPROV",.1,2,0)
given institution and eRx date/time. This index is used to speed up 
"IX",52.49,52.49,"EPROV",.1,3,0)
searching logic in Inbound eRx.
"IX",52.49,52.49,"EPROV",1)
S ^PS(52.49,"EPROV",X(1),X(2),X(3),DA)=""
"IX",52.49,52.49,"EPROV",2)
K ^PS(52.49,"EPROV",X(1),X(2),X(3),DA)
"IX",52.49,52.49,"EPROV",2.5)
K ^PS(52.49,"EPROV")
"IX",52.49,52.49,"EPROV",11.1,0)
^.114IA^3^3
"IX",52.49,52.49,"EPROV",11.1,1,0)
1^F^52.49^24.1^^1^F
"IX",52.49,52.49,"EPROV",11.1,1,3)
 
"IX",52.49,52.49,"EPROV",11.1,2,0)
2^F^52.49^.03^^2^F
"IX",52.49,52.49,"EPROV",11.1,2,3)
 
"IX",52.49,52.49,"EPROV",11.1,3,0)
3^F^52.49^2.1^^3^F
"IX",52.49,52.49,"EPROV",11.1,3,3)
 
"IX",52.49,52.49,"PAT",0)
52.49^PAT^Patient and Date Time index^R^^R^IR^I^52.49^^^^^LS
"IX",52.49,52.49,"PAT",.1,0)
^^2^2^3170610^
"IX",52.49,52.49,"PAT",.1,1,0)
This index provides a quick reference to patient, date, and site. Used 
"IX",52.49,52.49,"PAT",.1,2,0)
for bulk validation.
"IX",52.49,52.49,"PAT",1)
S ^PS(52.49,"PAT",X(1),X(2),X(3),X(4),DA)=""
"IX",52.49,52.49,"PAT",2)
K ^PS(52.49,"PAT",X(1),X(2),X(3),X(4),DA)
"IX",52.49,52.49,"PAT",2.5)
K ^PS(52.49,"PAT")
"IX",52.49,52.49,"PAT",11.1,0)
^.114IA^4^4
"IX",52.49,52.49,"PAT",11.1,1,0)
1^F^52.49^24.1^^1^F
"IX",52.49,52.49,"PAT",11.1,1,3)
 
"IX",52.49,52.49,"PAT",11.1,2,0)
2^F^52.49^1^^2^F
"IX",52.49,52.49,"PAT",11.1,2,3)
 
"IX",52.49,52.49,"PAT",11.1,3,0)
3^F^52.49^.04^^3^F
"IX",52.49,52.49,"PAT",11.1,3,3)
 
"IX",52.49,52.49,"PAT",11.1,4,0)
4^F^52.49^.03^^4^F
"IX",52.49,52.49,"PAT",11.1,4,3)
 
"KRN",.402,1379,-1)
0^1
"KRN",.402,1379,0)
PSO SITE^3180524.1529^^59^^^3180605
"KRN",.402,1379,"DR",1,59)
.01:.06;1008;.07:.081;2004;.09:.091;.1:.18;.2:.52;3:5;2008;6:7;105;105.1;105.2;2006;2007;8;100;101;109;1000;1001;1002;2001;2002;1003;1004;1005;1006;2005;2030;2035;134;135;10:10.2;
"KRN",.402,1379,"DR",2,59.0135)
.01:.02;
"KRN",.402,1379,"DR",2,59.02008)
.01;S DIE("NO^")="BACK";1;K DIE("NO^");
"KRN",.402,1379,"DR",2,59.08)
.01;1;
"KRN",.402,1379,"DR",3,59.20081)
.01:1;
"KRN",101,6544,-1)
4^4
"KRN",101,6544,0)
PSO ERX HQ SELECT
"KRN",101,6547,-1)
4^2
"KRN",101,6547,0)
PSO ERX HQ SEARCH
"KRN",101,6548,-1)
4^3
"KRN",101,6548,0)
PSO ERX HQ SORT
"KRN",101,6597,-1)
0^1
"KRN",101,6597,0)
PSO ERX HQ MENU^PSO ERX HQ MENU^^M^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6597,4)
25^3
"KRN",101,6597,10,0)
^101.01PA^4^4
"KRN",101,6597,10,1,0)
6544^SI^1^
"KRN",101,6597,10,1,"^")
PSO ERX HQ SELECT
"KRN",101,6597,10,2,0)
6547^SR^2^
"KRN",101,6597,10,2,"^")
PSO ERX HQ SEARCH
"KRN",101,6597,10,3,0)
6548^SO^3^
"KRN",101,6597,10,3,"^")
PSO ERX HQ SORT
"KRN",101,6597,24)
I 1 X:$D(^ORD(101,+$P(^ORD(101,DA(1),10,DA,0),"""^""",1),24)) ^(24)
"KRN",101,6597,26)
D SHOW^VALM S XQORM("#")=$O(^ORD(101,"B","PSO ERX SELECT BY NUMBER",0))_"^1:"_VALMCNT
"KRN",101,6597,28)
Select Action:
"KRN",101,6597,99)
64817,34579
"MBREQ")
0
"ORD",7,.402)
.402;7;;;EDEOUT^DIFROMSO(.402,DA,"",XPDA);FPRE^DIFROMSI(.402,"",XPDA);EPRE^DIFROMSI(.402,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.402,DA,"",XPDA);DEL^DIFROMSK(.402,"",%)
"ORD",7,.402,0)
INPUT TEMPLATE
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
527^3180627
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")
 
"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","PSO527PO")
0^^B3290055^n/a
"RTN","PSO527PO",1,0)
PSO527PO ;ALB/BLB - eRx utilities ; 5/03/2018 11:25am
"RTN","PSO527PO",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**527**;DEC 1997;Build 30
"RTN","PSO527PO",3,0)
 ;
"RTN","PSO527PO",4,0)
 N FDA,DIK,DRU02IEN
"RTN","PSO527PO",5,0)
 S DRU02IEN=$$PRESOLV^PSOERXA1("DRU02","REJ")
"RTN","PSO527PO",6,0)
 I DRU02IEN D
"RTN","PSO527PO",7,0)
 .S FDA(52.45,DRU02IEN_",",.02)="Non-formulary drug"
"RTN","PSO527PO",8,0)
 .D FILE^DIE(,"FDA") K FDA
"RTN","PSO527PO",9,0)
 S DIK="^PS(52.49,",DIK(1)=".04^EPAT" D ENALL^DIK K DIK
"RTN","PSO527PO",10,0)
 S DIK="^PS(52.49,",DIK(1)="2.1^EPROV" D ENALL^DIK K DIK
"RTN","PSO527PO",11,0)
 I '$D(^PS(52.45,"C","ERX","W")) D
"RTN","PSO527PO",12,0)
 .S FDA(52.45,"+1,",.01)="W"
"RTN","PSO527PO",13,0)
 .S FDA(52.45,"+1,",.02)="WAIT"
"RTN","PSO527PO",14,0)
 .S FDA(52.45,"+1,",.03)="ERX"
"RTN","PSO527PO",15,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSO527PO",16,0)
UPSTATUS ;
"RTN","PSO527PO",17,0)
 N BDATE,EDATE,RXDATE,RXSTAT,RXSTATE,ERXIEN,VALCNT,PSOINST
"RTN","PSO527PO",18,0)
 S BDATE=$$FMADD^XLFDT(DT,-1000)
"RTN","PSO527PO",19,0)
 S EDATE=DT_".9999"
"RTN","PSO527PO",20,0)
 S PSOINST=0 F  S PSOINST=$O(^PS(52.49,"F",PSOINST)) Q:'PSOINST  D
"RTN","PSO527PO",21,0)
 .S RXDATE=BDATE
"RTN","PSO527PO",22,0)
 .F  S RXDATE=$O(^PS(52.49,"F",PSOINST,RXDATE)) Q:'RXDATE!(RXDATE>EDATE)!(RXDATE="")  D
"RTN","PSO527PO",23,0)
 ..S RXSTAT=0 F  S RXSTAT=$O(^PS(52.49,"F",PSOINST,RXDATE,RXSTAT)) Q:'RXSTAT  D
"RTN","PSO527PO",24,0)
 ...S RXSTATE=$$GET1^DIQ(52.45,RXSTAT,.01,"E")
"RTN","PSO527PO",25,0)
 ...I ((RXSTATE="RJ")!(RXSTATE="RM")!(RXSTATE="PR")) Q
"RTN","PSO527PO",26,0)
 ...S ERXIEN=0
"RTN","PSO527PO",27,0)
 ...F  S ERXIEN=$O(^PS(52.49,"F",PSOINST,RXDATE,RXSTAT,ERXIEN)) Q:'ERXIEN  D
"RTN","PSO527PO",28,0)
 ....I $$GET1^DIQ(52.49,ERXIEN,1.3,"I"),$$GET1^DIQ(52.49,ERXIEN,1.5,"I"),$$GET1^DIQ(52.49,ERXIEN,1.7,"I") D
"RTN","PSO527PO",29,0)
 .....D UPDSTAT^PSOERXU1(ERXIEN,"W")
"RTN","PSO527PO",30,0)
 Q
"RTN","PSOERX")
0^1^B70347933^B62148150
"RTN","PSOERX",1,0)
PSOERX ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERX",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,527**;DEC 1997;Build 30
"RTN","PSOERX",3,0)
 ;
"RTN","PSOERX",4,0)
EN(SRCH,SORTT) ; -- main entry point for PSO ERX HOLDING QUEUE
"RTN","PSOERX",5,0)
 N PSNPINST,PSOREFSH
"RTN","PSOERX",6,0)
 I '$$CHKKEY^PSOERX(DUZ) D  Q
"RTN","PSOERX",7,0)
 .W !,"You do not have the appropriate key to access this option." S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX",8,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) D MSG^PSODPT G EX^PSOERX
"RTN","PSOERX",9,0)
 D:'$D(PSOPINST) INST^PSOORFI2 I $G(PSOIQUIT) K PSOIQUIT G EX^PSOERX
"RTN","PSOERX",10,0)
 S PSNPINST=$$GET1^DIQ(59,PSOSITE,101,"I")
"RTN","PSOERX",11,0)
 I 'PSNPINST W !,"NPI Institution must be defined to continue." S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX",12,0)
 D EN^VALM("PSO ERX HOLDING QUEUE")
"RTN","PSOERX",13,0)
 Q
"RTN","PSOERX",14,0)
 ;
"RTN","PSOERX",15,0)
HDR ; -- header code
"RTN","PSOERX",16,0)
 S VALMHDR(1)="PSO ERX HOLDING QUEUE"
"RTN","PSOERX",17,0)
 I $G(PSOREFSH) K @VALMAR D INIT
"RTN","PSOERX",18,0)
 Q
"RTN","PSOERX",19,0)
 ;
"RTN","PSOERX",20,0)
INIT ; -- init variables and list array
"RTN","PSOERX",21,0)
 ;/BLB/ PSO*7.0*527 - BEING CHANGE - SIGNIFICANT CHANGES HAVE OCCURED TO FACILITATE FASTER PROCESSING TIMES IN THE ERX HOLDING QUEUE
"RTN","PSOERX",22,0)
 N LINE,LINEVAR,X,SGLOB,EF,ESIEN,CHKSTAT,EARY,SUBS,SUBS2,SVAL,SSTWO,EBDATE,ERXIEN,DTLOOP,PTLOOP,ERXDB,ERXDS,ERX,ERXDAT,P5246IEN,BDOVR,EEDATE,CNT
"RTN","PSOERX",23,0)
 S EF=52.49
"RTN","PSOERX",24,0)
 S SGLOB=$NA(^TMP("PSOERX",$J)) K @SGLOB
"RTN","PSOERX",25,0)
 S PSOSRCH=$S($D(SRCH):1,1:0) I PSOSRCH S PSOSRCH(VALMEVL)=""
"RTN","PSOERX",26,0)
 S PSOSRT=$S($D(SORTT):1,1:0) I PSOSRT S PSOSRT(VALMEVL)=""
"RTN","PSOERX",27,0)
 ; initialize LINE
"RTN","PSOERX",28,0)
 I '$G(PSOPINST) Q
"RTN","PSOERX",29,0)
 F CHKSTAT="RJ","RM","PR" D
"RTN","PSOERX",30,0)
 .S ESIEN=$$PRESOLV^PSOERXA1(CHKSTAT,"ERX") Q:'ESIEN
"RTN","PSOERX",31,0)
 .S EARY(ESIEN)=""
"RTN","PSOERX",32,0)
 I $D(SRCH) D
"RTN","PSOERX",33,0)
 .I $D(SRCH(1)) S SUBS="EPAT",SVAL=$P(SRCH(1),U) Q
"RTN","PSOERX",34,0)
 .I $D(SRCH(4)) S SUBS="EPROV",SVAL=$P(SRCH(4),U) Q
"RTN","PSOERX",35,0)
 .I $D(SRCH(2)) S SUBS="F",SUBS2="DOB",SVAL=$P(SRCH(2),U) Q
"RTN","PSOERX",36,0)
 .I $D(SRCH(5)) S SUBS="F",SVAL=$P(SRCH(5),U) Q
"RTN","PSOERX",37,0)
 .S SUBS="F"
"RTN","PSOERX",38,0)
 I '$D(SRCH) S SUBS="F"
"RTN","PSOERX",39,0)
 S (LINE,CNT)=0
"RTN","PSOERX",40,0)
  I '$D(SVAL) S SVAL=0
"RTN","PSOERX",41,0)
 ; Look back 90 days.
"RTN","PSOERX",42,0)
 S EBDATE=$S($D(SRCH(3)):$P(SRCH(3),U),1:$$FMADD^XLFDT(DT,-90)),EEDATE=$S($D(SRCH(3)):$P(SRCH(3),U,2),1:DT_".9999")
"RTN","PSOERX",43,0)
 ; get lookback days override. Use it if we are not searching by date range.
"RTN","PSOERX",44,0)
 S BDOVR=$$GET1^DIQ(59,PSOSITE,10.2,"E") I BDOVR,'$D(SRCH(3)) S EBDATE=$$FMADD^XLFDT(DT,-BDOVR)
"RTN","PSOERX",45,0)
 F  S EBDATE=$O(^PS(52.49,SUBS,PSNPINST,EBDATE)) Q:'EBDATE!(EBDATE>EEDATE)!(CNT>998)  D
"RTN","PSOERX",46,0)
 .I $G(SUBS2)="DOB" D  Q
"RTN","PSOERX",47,0)
 ..S P5246IEN=0 F  S P5246IEN=$O(^PS(52.46,SUBS2,SVAL,P5246IEN)) Q:'P5246IEN!(CNT>998)  D
"RTN","PSOERX",48,0)
 ...S ERXIEN=0 F  S ERXIEN=$O(^PS(EF,"EPAT",PSNPINST,EBDATE,P5246IEN,ERXIEN)) Q:'ERXIEN!(CNT>998)  D
"RTN","PSOERX",49,0)
 ....D BLDITEM(ERXIEN,.CNT)
"RTN","PSOERX",50,0)
 .I SVAL D  Q
"RTN","PSOERX",51,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(EF,SUBS,PSNPINST,EBDATE,SVAL,ERXIEN)) Q:'ERXIEN!(CNT>998)  D
"RTN","PSOERX",52,0)
 ...D BLDITEM(ERXIEN,.CNT)
"RTN","PSOERX",53,0)
 .S SSTWO=0 F  S SSTWO=$O(^PS(EF,SUBS,PSNPINST,EBDATE,SSTWO)) Q:'SSTWO!(CNT>998)  D
"RTN","PSOERX",54,0)
 ..; Filter out RJ, RM, and PR status erx's if we are not searching for a specific eRx status
"RTN","PSOERX",55,0)
 ..I '$D(SRCH(5)),$D(EARY(SSTWO)) Q
"RTN","PSOERX",56,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(EF,SUBS,PSNPINST,EBDATE,SSTWO,ERXIEN)) Q:'ERXIEN!(CNT>998)  D
"RTN","PSOERX",57,0)
 ...D BLDITEM(ERXIEN,.CNT)
"RTN","PSOERX",58,0)
 S DTLOOP=0 F  S DTLOOP=$O(@SGLOB@(DTLOOP)) Q:'DTLOOP  D
"RTN","PSOERX",59,0)
 .S PTLOOP="" F  S PTLOOP=$O(@SGLOB@(DTLOOP,PTLOOP)) Q:PTLOOP=""  D
"RTN","PSOERX",60,0)
 ..S ERXDB="" F  S ERXDB=$O(@SGLOB@(DTLOOP,PTLOOP,ERXDB)) Q:ERXDB=""  D
"RTN","PSOERX",61,0)
 ...S ERXDS="" F  S ERXDS=$O(@SGLOB@(DTLOOP,PTLOOP,ERXDB,ERXDS)) Q:ERXDS=""  D
"RTN","PSOERX",62,0)
 ....S ERX=0 F  S ERX=$O(@SGLOB@(DTLOOP,PTLOOP,ERXDB,ERXDS,ERX)) Q:'ERX  D
"RTN","PSOERX",63,0)
 .....S LINE=LINE+1,LINEVAR=""
"RTN","PSOERX",64,0)
 .....S ERXDAT=$G(@SGLOB@(DTLOOP,PTLOOP,ERXDB,ERXDS,ERX))
"RTN","PSOERX",65,0)
 .....S LINEVAR=$$SETFLD^VALM1(LINE_".",LINEVAR,"#")
"RTN","PSOERX",66,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U),LINEVAR,"PATIENT NAME")
"RTN","PSOERX",67,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,2),LINEVAR,"DOB")
"RTN","PSOERX",68,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,3),LINEVAR,"DRUG")
"RTN","PSOERX",69,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,4),LINEVAR,"PROVIDER")
"RTN","PSOERX",70,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,8),LINEVAR,"STA")
"RTN","PSOERX",71,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,7),LINEVAR,"RECORD DATE")
"RTN","PSOERX",72,0)
 .....D SET^VALM10(LINE,LINEVAR,ERX)
"RTN","PSOERX",73,0)
 I LINE=0 S LINE=LINE+1 D SET^VALM10(LINE,"No results for current query.")
"RTN","PSOERX",74,0)
 S VALMCNT=LINE
"RTN","PSOERX",75,0)
 Q
"RTN","PSOERX",76,0)
BLDITEM(ERXIEN,CNT) ;
"RTN","PSOERX",77,0)
 N ERXIENS,ERXDAT,PATIEN,PATNM,PTDOB,PTDOBE,EXDS,EXPRIEN,EXPRNM,AUTOST,MANST,ERXSTAT,ERXISTAT,ERXDT,ERXEDT
"RTN","PSOERX",78,0)
 S ERXIENS=ERXIEN_","
"RTN","PSOERX",79,0)
 K ERXDAT D GETS^DIQ(52.49,ERXIENS,".03;.04;4.9;3.1;2.1;1;1.2;1.3","IE","ERXDAT")
"RTN","PSOERX",80,0)
 S PATIEN=$G(ERXDAT(EF,ERXIENS,.04,"I"))
"RTN","PSOERX",81,0)
 I $D(SRCH(1)),PATIEN'=$P($G(SRCH(1)),U) Q
"RTN","PSOERX",82,0)
 ; patient ien missing, do not process
"RTN","PSOERX",83,0)
 Q:'PATIEN
"RTN","PSOERX",84,0)
 ; patient name/dob
"RTN","PSOERX",85,0)
 S PATNM=$G(ERXDAT(EF,ERXIENS,.04,"E"))
"RTN","PSOERX",86,0)
 S PTDOBE=""
"RTN","PSOERX",87,0)
 S PTDOB=$$GET1^DIQ(52.46,PATIEN,.08,"I")
"RTN","PSOERX",88,0)
 I PTDOB]"" S PTDOBE=$$FMTE^XLFDT(PTDOB,"2D")
"RTN","PSOERX",89,0)
 I 'PTDOB S PTDOB="N/A"
"RTN","PSOERX",90,0)
 I $D(SRCH(2)),PTDOB'=$G(SRCH(2)) Q
"RTN","PSOERX",91,0)
 ; external drug/supply
"RTN","PSOERX",92,0)
 S EXDS=$G(ERXDAT(EF,ERXIENS,3.1,"E"))
"RTN","PSOERX",93,0)
 I $D(SRCH(6)),EXDS'[$P($G(SRCH(6)),U) Q
"RTN","PSOERX",94,0)
 ; external provider ien and name
"RTN","PSOERX",95,0)
 S EXPRIEN=$G(ERXDAT(EF,ERXIENS,2.1,"I"))
"RTN","PSOERX",96,0)
 I $D(SRCH(4)),EXPRIEN'=$P($G(SRCH(4)),U,1) Q
"RTN","PSOERX",97,0)
 ; if there is no external provider, quit - FUTURE ENHANCEMENT - may need to find a way to log, view, and deal with these instances.
"RTN","PSOERX",98,0)
 S EXPRNM=$G(ERXDAT(EF,ERXIENS,2.1,"E")) Q:'$L(EXPRNM)
"RTN","PSOERX",99,0)
 ; auto and manual validation status
"RTN","PSOERX",100,0)
 S AUTOST=$G(ERXDAT(EF,ERXIENS,1.2,"E"))
"RTN","PSOERX",101,0)
 S MANST=$G(ERXDAT(EF,ERXIENS,1.3,"E"))
"RTN","PSOERX",102,0)
 S ERXSTAT=$G(ERXDAT(EF,ERXIENS,1,"E"))
"RTN","PSOERX",103,0)
 S ERXISTAT=$G(ERXDAT(EF,ERXIENS,1,"I"))
"RTN","PSOERX",104,0)
 I $D(SRCH(5)),ERXSTAT'=$P(SRCH(5),U,2) Q
"RTN","PSOERX",105,0)
 ; date ERX was received
"RTN","PSOERX",106,0)
 S ERXDT=$G(ERXDAT(EF,ERXIENS,.03,"I")),ERXEDT=$$FMTE^XLFDT($P(ERXDT,"."),"2D")
"RTN","PSOERX",107,0)
 I $D(SRCH(3)),(ERXDT<$P($G(SRCH(3)),U,1))!(ERXDT>$P($G(SRCH(3)),U,2)) Q
"RTN","PSOERX",108,0)
 S CNT=CNT+1
"RTN","PSOERX",109,0)
 I $G(SORTT) D  Q
"RTN","PSOERX",110,0)
 .I SORTT=1 S @SGLOB@(1,PATNM,ERXDT-9999999,EXPRNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",111,0)
 .I SORTT=2 S @SGLOB@(1,PTDOB,ERXDT-9999999,PATNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",112,0)
 .I SORTT=3 S @SGLOB@(1,ERXDT-9999999,PATNM,EXPRNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",113,0)
 .I SORTT=4 S @SGLOB@(1,EXPRNM,ERXDT,PATNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",114,0)
 .I SORTT=5 S @SGLOB@(1,ERXSTAT,PATNM,ERXDT-9999999,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",115,0)
 .I SORTT=6 S @SGLOB@(1,EXDS,PATNM,ERXDT-9999999,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",116,0)
 ;S @SGLOB@(ERXDT,PATNM,EXPRNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",117,0)
 S @SGLOB@(ERXDT,PATNM,PTDOB,EXDS,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",118,0)
 Q
"RTN","PSOERX",119,0)
HELP ; -- help code
"RTN","PSOERX",120,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERX",121,0)
 Q
"RTN","PSOERX",122,0)
 ;
"RTN","PSOERX",123,0)
EXIT ; -- exit code
"RTN","PSOERX",124,0)
 ;S VALMBCK="R"
"RTN","PSOERX",125,0)
 K PSOSRCH(VALMEVL),PSOSRT(VALMEVL),@VALMAR,PSOPRMPT
"RTN","PSOERX",126,0)
 I VALMEVL=0 K PSOSRCH,PSOSRT
"RTN","PSOERX",127,0)
 D FULL^VALM1
"RTN","PSOERX",128,0)
 Q
"RTN","PSOERX",129,0)
 ;
"RTN","PSOERX",130,0)
EX ; early exit logic
"RTN","PSOERX",131,0)
 K PSOSRCH,PSOSRT,SRCH,SORTT,PSOPRMPT
"RTN","PSOERX",132,0)
 ;K PSOSRCH,PSOSRT,PSOPAR,PSOPINST
"RTN","PSOERX",133,0)
 D EX^PSOORFI1
"RTN","PSOERX",134,0)
 Q
"RTN","PSOERX",135,0)
EXPND ; -- expand code
"RTN","PSOERX",136,0)
 Q
"RTN","PSOERX",137,0)
 ;
"RTN","PSOERX",138,0)
 ; search list and display results
"RTN","PSOERX",139,0)
SEARCH ;
"RTN","PSOERX",140,0)
 N RES,SVAL,I,DONE,SRCHARY
"RTN","PSOERX",141,0)
 D FULL^VALM1
"RTN","PSOERX",142,0)
 S DONE=0
"RTN","PSOERX",143,0)
 F I=1:1 D  Q:DONE
"RTN","PSOERX",144,0)
 .S RES=$$DIR(,I,.SRCHARY)
"RTN","PSOERX",145,0)
 .I '+RES S DONE=1 Q
"RTN","PSOERX",146,0)
 .S SRCHARY(+RES)=$P(RES,U,2,99)
"RTN","PSOERX",147,0)
 I $D(STYP) D EN(.SRCHARY,STYP) Q
"RTN","PSOERX",148,0)
 D EN(.SRCHARY)
"RTN","PSOERX",149,0)
 ;S VALMBCK="R"
"RTN","PSOERX",150,0)
 Q
"RTN","PSOERX",151,0)
 ; sort target list
"RTN","PSOERX",152,0)
SORT ;
"RTN","PSOERX",153,0)
 N RES,STYP,SVAL
"RTN","PSOERX",154,0)
 D FULL^VALM1
"RTN","PSOERX",155,0)
 S RES=$$DIR(1,0)
"RTN","PSOERX",156,0)
 I '+$P(RES,U) Q
"RTN","PSOERX",157,0)
 S STYP=$P(RES,U)
"RTN","PSOERX",158,0)
 I $D(SRCHARY) D EN(.SRCHARY,STYP) Q
"RTN","PSOERX",159,0)
 D EN(,STYP)
"RTN","PSOERX",160,0)
 Q
"RTN","PSOERX",161,0)
DIR(SORT,CNT,SLIST) ;
"RTN","PSOERX",162,0)
 N DIR,Y,RLINE,STAG,SVAL,REFCHK
"RTN","PSOERX",163,0)
 K DIR
"RTN","PSOERX",164,0)
 S DIR(0)="SO^1:PATIENT NAME;2:DATE OF BIRTH;3:RECEIVED DATE RANGE;4:PROVIDER NAME;5:ERX STATUS;6:DRUG NAME"
"RTN","PSOERX",165,0)
 I CNT<2 S DIR("L")="Select one of the following "_$S($G(SORT):"sort",1:"search")_" criteria:"
"RTN","PSOERX",166,0)
 I CNT>1 D
"RTN","PSOERX",167,0)
 .S DIR("L")=""
"RTN","PSOERX",168,0)
 .S DIR("L",11)="Select another search criteria or '^' to exit. Press enter to use the currently"
"RTN","PSOERX",169,0)
 .S DIR("L",12)="selected search criteria."
"RTN","PSOERX",170,0)
 S DIR("L",2)=""
"RTN","PSOERX",171,0)
 S DIR("L",3)=" "_$S($D(SLIST(1)):"*",1:"")_"1.) PATIENT NAME"
"RTN","PSOERX",172,0)
 S DIR("L",4)=" "_$S($D(SLIST(2)):"*",1:"")_"2.) DATE OF BIRTH"
"RTN","PSOERX",173,0)
 S DIR("L",5)=" "_$S($D(SLIST(3)):"*",1:"")_"3.) RECEIVED DATE"_$S('$G(SORT):" RANGE",1:"")
"RTN","PSOERX",174,0)
 S DIR("L",6)=" "_$S($D(SLIST(4)):"*",1:"")_"4.) PROVIDER NAME"
"RTN","PSOERX",175,0)
 S DIR("L",7)=" "_$S($D(SLIST(5)):"*",1:"")_"5.) ERX STATUS"
"RTN","PSOERX",176,0)
 S DIR("L",8)=" "_$S($D(SLIST(6)):"*",1:"")_"6.) DRUG NAME"
"RTN","PSOERX",177,0)
 S DIR("L",9)=""
"RTN","PSOERX",178,0)
 S DIR("L",10)=$S($D(SLIST):" * - indicates selected criteria.",1:"")
"RTN","PSOERX",179,0)
 D ^DIR K DIR Q:'Y 0
"RTN","PSOERX",180,0)
 S RES=Y I $G(SORT) Q RES
"RTN","PSOERX",181,0)
 S RLINE=$S(RES=1:"PAT",RES=2:"DOB",RES=3:"RDT",RES=4:"PRVNM",RES=5:"ESTAT",RES=6:"DNAME",1:"")
"RTN","PSOERX",182,0)
 I RLINE']"" Q 0
"RTN","PSOERX",183,0)
 S STAG=RLINE
"RTN","PSOERX",184,0)
 S SVAL=$$@STAG I SVAL="" Q 0
"RTN","PSOERX",185,0)
 Q RES_U_SVAL
"RTN","PSOERX",186,0)
PAT() ;
"RTN","PSOERX",187,0)
 N Y,DIC
"RTN","PSOERX",188,0)
 S DIC=52.46,DIC(0)="AEMQ" D ^DIC
"RTN","PSOERX",189,0)
 I Y<1 Q ""
"RTN","PSOERX",190,0)
 Q Y
"RTN","PSOERX",191,0)
DOB() ;
"RTN","PSOERX",192,0)
 N %DT,Y
"RTN","PSOERX",193,0)
 S %DT="A"
"RTN","PSOERX",194,0)
 S %DT("A")="Enter the Date of Birth (DOB): "
"RTN","PSOERX",195,0)
 D ^%DT
"RTN","PSOERX",196,0)
 I Y<1 Q ""
"RTN","PSOERX",197,0)
 Q Y
"RTN","PSOERX",198,0)
RDT() ;
"RTN","PSOERX",199,0)
 N BDATE,EDATE,%DT,Y
"RTN","PSOERX",200,0)
 S %DT="A"
"RTN","PSOERX",201,0)
 S %DT("A")="Enter the beginning date: "
"RTN","PSOERX",202,0)
 D ^%DT
"RTN","PSOERX",203,0)
 I Y<0 Q ""
"RTN","PSOERX",204,0)
 S BDATE=Y K Y,%DT
"RTN","PSOERX",205,0)
 S %DT="A"
"RTN","PSOERX",206,0)
 S %DT("A")="Enter the ending date: "
"RTN","PSOERX",207,0)
 S %DT("B")="T"
"RTN","PSOERX",208,0)
 D ^%DT
"RTN","PSOERX",209,0)
 I Y<0 Q ""
"RTN","PSOERX",210,0)
 S EDATE=Y_".999999"
"RTN","PSOERX",211,0)
 Q BDATE_U_EDATE
"RTN","PSOERX",212,0)
PRVNM() ;
"RTN","PSOERX",213,0)
 N Y,DIC
"RTN","PSOERX",214,0)
 S DIC("A")="Select PROVIDER: "
"RTN","PSOERX",215,0)
 S DIC=52.48,DIC(0)="AEQ" D ^DIC
"RTN","PSOERX",216,0)
 I Y<1 Q ""
"RTN","PSOERX",217,0)
 Q Y
"RTN","PSOERX",218,0)
ESTAT() ;
"RTN","PSOERX",219,0)
 ; prompt for erx status
"RTN","PSOERX",220,0)
 N Y,DIC
"RTN","PSOERX",221,0)
 S DIC("A")="Select eRx Status: "
"RTN","PSOERX",222,0)
 S DIC=52.45,DIC(0)="AEQ",DIC("S")="I $D(^PS(52.45,""TYPE"",""ERX"",Y))" D ^DIC
"RTN","PSOERX",223,0)
 I Y<1 Q ""
"RTN","PSOERX",224,0)
 Q Y
"RTN","PSOERX",225,0)
DNAME() ;
"RTN","PSOERX",226,0)
 N DIR,Y
"RTN","PSOERX",227,0)
 S DIR(0)="FO"
"RTN","PSOERX",228,0)
 S DIR("A")="Enter the name or partial name of the incoming eRx drug"
"RTN","PSOERX",229,0)
 D ^DIR
"RTN","PSOERX",230,0)
 I Y=""!(Y="^") Q ""
"RTN","PSOERX",231,0)
 Q $$UP^XLFSTR(Y)
"RTN","PSOERX",232,0)
CHKKEY(DUZ) ;
"RTN","PSOERX",233,0)
 I $D(^XUSEC("PSDRPH",DUZ))!($D(^XUSEC("PSO ERX ADV TECH",DUZ)))!($D(^XUSEC("PSO ERX TECH",DUZ)))!($D(^XUSEC("PSO ERX VIEW",DUZ))) Q 1
"RTN","PSOERX",234,0)
 Q 0
"RTN","PSOERX1")
0^2^B78477879^B78113313
"RTN","PSOERX1",1,0)
PSOERX1 ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERX1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,527**;DEC 1997;Build 30
"RTN","PSOERX1",3,0)
 ;
"RTN","PSOERX1",4,0)
EN(PSOIEN) ; -- main entry point for PSO ERX HOLDING QUEUE
"RTN","PSOERX1",5,0)
 D EN^VALM("PSO ERX HQ DISPLAY")
"RTN","PSOERX1",6,0)
 Q
"RTN","PSOERX1",7,0)
 ;
"RTN","PSOERX1",8,0)
HDR ; -- header code
"RTN","PSOERX1",9,0)
 S VALMHDR(1)="eRx Patient: "_$$GET1^DIQ(52.49,PSOIEN,.04,"E")
"RTN","PSOERX1",10,0)
 S VALMHDR(2)="eRx Reference #: "_$$GET1^DIQ(52.49,PSOIEN,.01,"E")
"RTN","PSOERX1",11,0)
 I VALMBCK="R" K @VALMAR S VALMBCK="" D INIT
"RTN","PSOERX1",12,0)
 Q
"RTN","PSOERX1",13,0)
 ;
"RTN","PSOERX1",14,0)
INIT ;
"RTN","PSOERX1",15,0)
 Q:'$G(PSOIEN)
"RTN","PSOERX1",16,0)
 N PATIEN,PHARMIEN,PRVIEN,PHDAT,PATDAT,SUPDAT,PRVDAT,LINE,PRVLNM,PRVMI,PRVFN,EPAT,EPATDOB,VPATIEN
"RTN","PSOERX1",17,0)
 N VPATNM,VPATDOB,EPRVIEN,EPRVNM,EPRVNPI,VAPRVIEN,VAPRVNM,VAPRVNPI,SUPIEN,ERXDRUG,ERXQTY,ERXFLS
"RTN","PSOERX1",18,0)
 N ERXDS,ERXDT,VADRG,LINETXT,ERXCOMM,ERXRFLS,PATIENS,VAHREA,VAQTY,VAREF,VASIG,PATDAT,CURSTATE,CURSTATI
"RTN","PSOERX1",19,0)
 N LHFOUND,LHMATCH,LHSTATI,VAPDEAEX,ERXCOMM,COMFRST,COMARY,SIGDATA,SIGLOOP,SFIRST,SGLOOP,SIGARY,VADAYS
"RTN","PSOERX1",20,0)
 N SLOOP,VASIG,VASARY,FSSIG,VAHSTA,EDIRECT,VAHPER,PAMANVAL,DRMANVAL,PRMANVAL,VPATINST,VAPIARY,VLOOP,FSVPIN
"RTN","PSOERX1",21,0)
 N DRGARY,DLP
"RTN","PSOERX1",22,0)
 S LINE=0
"RTN","PSOERX1",23,0)
 S PATIEN=$$GET1^DIQ(52.49,PSOIEN,.04,"I"),PATIENS=PATIEN_","
"RTN","PSOERX1",24,0)
 D GETS^DIQ(52.46,PATIENS,"**","IE","PATDAT")
"RTN","PSOERX1",25,0)
 S EPAT=$G(PATDAT(52.46,PATIENS,.01,"E"))
"RTN","PSOERX1",26,0)
 S EPATDOB=$G(PATDAT(52.46,PATIENS,.08,"I")),EPATDOB=$$FMTE^XLFDT(EPATDOB,"2D")
"RTN","PSOERX1",27,0)
 ; Future enhancement - if 52.46 is linked to the patient in the patient file, use it. for now use 52.49
"RTN","PSOERX1",28,0)
 ;S VPATIEN=$G(PATDAT(52.46,PATIENS,1.5,"I"))
"RTN","PSOERX1",29,0)
 S VPATIEN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERX1",30,0)
 S VPATNM=$S(VPATIEN:$$GET1^DIQ(2,VPATIEN,.01,"E"),1:"NOT LINKED")
"RTN","PSOERX1",31,0)
 S VPATDOB=$S(VPATIEN:$$GET1^DIQ(2,VPATIEN,.03,"I"),1:"N/A")
"RTN","PSOERX1",32,0)
 I VPATDOB S VPATDOB=$$FMTE^XLFDT(VPATDOB,"2D")
"RTN","PSOERX1",33,0)
 S PHARMIEN=$$GET1^DIQ(52.49,PSOIEN,2.5,"I")
"RTN","PSOERX1",34,0)
 D GETS^DIQ(52.47,PHARMIEN,"**","E","PHDAT")
"RTN","PSOERX1",35,0)
 S EPRVIEN=$$GET1^DIQ(52.49,PSOIEN,2.1,"I")
"RTN","PSOERX1",36,0)
 S EPRVNM=$$GET1^DIQ(52.48,EPRVIEN,.01,"E")
"RTN","PSOERX1",37,0)
 S EPRVNPI=$$GET1^DIQ(52.48,EPRVIEN,1.5,"E")
"RTN","PSOERX1",38,0)
 S VAPRVIEN=$$GET1^DIQ(52.49,PSOIEN,2.3,"I")
"RTN","PSOERX1",39,0)
 S EDIRECT=$$GET1^DIQ(52.49,PSOIEN,7,"E")
"RTN","PSOERX1",40,0)
 S VAPRVNM=$S(VAPRVIEN:$$GET1^DIQ(200,VAPRVIEN,.01,"E"),1:"NOT LINKED")
"RTN","PSOERX1",41,0)
 S VAPRVNPI=$S(VAPRVIEN:$$GET1^DIQ(200,VAPRVIEN,41.99,"E"),1:"N/A")
"RTN","PSOERX1",42,0)
 D GETS^DIQ(52.48,EPRVIEN,"**","E","PRVDAT")
"RTN","PSOERX1",43,0)
 S SUPIEN=$$GET1^DIQ(52.49,PSOIEN,2.6,"I")
"RTN","PSOERX1",44,0)
 D GETS^DIQ(52.48,SUPIEN,"**","E","SUPDAT")
"RTN","PSOERX1",45,0)
 S PAMANVAL=$$GET1^DIQ(52.49,PSOIEN,1.7,"I")
"RTN","PSOERX1",46,0)
 S PRMANVAL=$$GET1^DIQ(52.49,PSOIEN,1.3,"I")
"RTN","PSOERX1",47,0)
 S DRMANVAL=$$GET1^DIQ(52.49,PSOIEN,1.5,"I")
"RTN","PSOERX1",48,0)
 S LINETXT=""
"RTN","PSOERX1",49,0)
 S LINE=LINE+1
"RTN","PSOERX1",50,0)
 ;/BLB/ - PSO*7.0*520 BEGIN CHANGE
"RTN","PSOERX1",51,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Patient: ",$E(EPAT,1,39),1,52)
"RTN","PSOERX1",52,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",EPATDOB,57,20)
"RTN","PSOERX1",53,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",54,0)
 I $L(EPAT)>39 D
"RTN","PSOERX1",55,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"             "_$E(EPAT,40,78))
"RTN","PSOERX1",56,0)
 I $L(EPAT)>78 D
"RTN","PSOERX1",57,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"             "_$E(EPAT,79,135))
"RTN","PSOERX1",58,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1",59,0)
 S LINETXT=""
"RTN","PSOERX1",60,0)
 S LINE=LINE+1
"RTN","PSOERX1",61,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Vista Patient"_$S(PAMANVAL:"[v]",1:"")_": ",$E(VPATNM,1,55),1,55)
"RTN","PSOERX1",62,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",VPATDOB,57,20)
"RTN","PSOERX1",63,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",64,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",65,0)
 S LINE=LINE+1
"RTN","PSOERX1",66,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1",67,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Provider: ",$E(EPRVNM,1,39),1,52)
"RTN","PSOERX1",68,0)
 D ADDITEM^PSOERX1A(.LINETXT,"NPI: ",EPRVNPI,57,20)
"RTN","PSOERX1",69,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",70,0)
 I $L(EPRVNM)>39 D
"RTN","PSOERX1",71,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"              "_$E(EPRVNM,40,77))
"RTN","PSOERX1",72,0)
 I $L(EPRVNM)>77 D
"RTN","PSOERX1",73,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"              "_$E(EPRVNM,78,135))
"RTN","PSOERX1",74,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1",75,0)
 S LINE=LINE+1
"RTN","PSOERX1",76,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Vista Provider"_$S(PRMANVAL:"[v]",1:"")_": ",$E(VAPRVNM,1,55),1,55)
"RTN","PSOERX1",77,0)
 D ADDITEM^PSOERX1A(.LINETXT,"NPI: ",VAPRVNPI,57,20)
"RTN","PSOERX1",78,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",79,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",80,0)
 S ERXDRUG=$$GET1^DIQ(52.49,PSOIEN,3.1,"E")
"RTN","PSOERX1",81,0)
 S ERXQTY=$$GET1^DIQ(52.49,PSOIEN,5.1,"E")
"RTN","PSOERX1",82,0)
 S ERXRFLS=$$GET1^DIQ(52.49,PSOIEN,5.6,"E")
"RTN","PSOERX1",83,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1",84,0)
 I ERXRFLS="" D
"RTN","PSOERX1",85,0)
 .S ERXRFLS=$$GET1^DIQ(52.49,PSOIEN,5.7,"I")
"RTN","PSOERX1",86,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1",87,0)
 S ERXDS=$$GET1^DIQ(52.49,PSOIEN,5.5,"E")
"RTN","PSOERX1",88,0)
 S ERXDT=$$GET1^DIQ(52.49,PSOIEN,.03,"E")
"RTN","PSOERX1",89,0)
 S VADRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"E")
"RTN","PSOERX1",90,0)
 S VAREF=$$GET1^DIQ(52.49,PSOIEN,20.5,"E")
"RTN","PSOERX1",91,0)
 S VAQTY=$$GET1^DIQ(52.49,PSOIEN,20.1,"E")
"RTN","PSOERX1",92,0)
 S VADAYS=$$GET1^DIQ(52.49,PSOIEN,20.2,"E")
"RTN","PSOERX1",93,0)
 ; only set the hold reason if the eRx has a hold status
"RTN","PSOERX1",94,0)
 S CURSTATE=$$GET1^DIQ(52.49,PSOIEN,1,"E")
"RTN","PSOERX1",95,0)
 S VAHREA=""
"RTN","PSOERX1",96,0)
 I $E(CURSTATE,1)="H" D
"RTN","PSOERX1",97,0)
 .S CURSTATI=$$GET1^DIQ(52.49,PSOIEN,1,"I")
"RTN","PSOERX1",98,0)
 .S LHMATCH=999999,LHFOUND=0 F  S LHMATCH=$O(^PS(52.49,PSOIEN,19,LHMATCH),-1) Q:'LHMATCH!(LHFOUND)  D
"RTN","PSOERX1",99,0)
 ..S LHSTATI=$$GET1^DIQ(52.4919,LHMATCH_","_PSOIEN_",",.02,"I") I LHSTATI=CURSTATI D  S LHFOUND=LHMATCH Q
"RTN","PSOERX1",100,0)
 ...S VAHREA=$$GET1^DIQ(52.4919,LHMATCH_","_PSOIEN_",",1)
"RTN","PSOERX1",101,0)
 ...S VAHSTA=$$GET1^DIQ(52.45,LHSTATI,.01,"E")_" - "_$$GET1^DIQ(52.45,LHSTATI,.02,"E")
"RTN","PSOERX1",102,0)
 ...S VAHPER=$$GET1^DIQ(52.4919,LHMATCH_","_PSOIEN_",",.03,"E")
"RTN","PSOERX1",103,0)
 I VADRG']"" S VADRG="NOT LINKED"
"RTN","PSOERX1",104,0)
 D TXT2ARY^PSOERXD1(.DRGARY,ERXDRUG,,70)
"RTN","PSOERX1",105,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"eRx Drug: "_$G(DRGARY(1)))
"RTN","PSOERX1",106,0)
 S DLP=1
"RTN","PSOERX1",107,0)
 F  S DLP=$O(DRGARY(DLP)) Q:'DLP  D
"RTN","PSOERX1",108,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"          "_$G(DRGARY(DLP)))
"RTN","PSOERX1",109,0)
 S LINE=LINE+1
"RTN","PSOERX1",110,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Qty: ",ERXQTY,1,17)
"RTN","PSOERX1",111,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Refills: ",ERXRFLS,19,16)
"RTN","PSOERX1",112,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Days Supply: ",ERXDS,37,20)
"RTN","PSOERX1",113,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Date: ",$P(ERXDT,"@"),58,22)
"RTN","PSOERX1",114,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",115,0)
 D TXT2ARY^PSOERXD1(.SIGARY,EDIRECT,,70)
"RTN","PSOERX1",116,0)
 S SFIRST=$O(SIGARY(0))
"RTN","PSOERX1",117,0)
 S SGLOOP=0 F  S SGLOOP=$O(SIGARY(SGLOOP)) Q:'SGLOOP  D
"RTN","PSOERX1",118,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,$S(SGLOOP=SFIRST:"eRx Sig: ",1:"         ")_$G(SIGARY(SGLOOP)))
"RTN","PSOERX1",119,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",120,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Vista Drug"_$S(DRMANVAL:"[v]",1:"")_": "_VADRG)
"RTN","PSOERX1",121,0)
 S LINE=LINE+1
"RTN","PSOERX1",122,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Vista Qty: ",$G(VAQTY),1,25)
"RTN","PSOERX1",123,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Vista Refills: ",$G(VAREF),27,18)
"RTN","PSOERX1",124,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Vista Days Supply: ",$G(VADAYS),54,22)
"RTN","PSOERX1",125,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",126,0)
 S VASIG=""
"RTN","PSOERX1",127,0)
 S SLOOP=0 F  S SLOOP=$O(^PS(52.49,PSOIEN,"SIG",SLOOP)) Q:'SLOOP  D
"RTN","PSOERX1",128,0)
 .I '$L($G(VASIG)) S VASIG=$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0)) Q
"RTN","PSOERX1",129,0)
 .S VASIG=$G(VASIG)_" "_$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0))
"RTN","PSOERX1",130,0)
 D TXT2ARY^PSOERXD1(.VASARY,VASIG,,68)
"RTN","PSOERX1",131,0)
 S FSSIG=$O(VASARY(0))
"RTN","PSOERX1",132,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Vista Sig: "_$S(FSSIG:$G(VASARY(FSSIG)),1:""))
"RTN","PSOERX1",133,0)
 S SLOOP=1 F  S SLOOP=$O(VASARY(SLOOP)) Q:'SLOOP  D
"RTN","PSOERX1",134,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"                        "_VASARY(SLOOP))
"RTN","PSOERX1",135,0)
 S VPATINST=$$GET1^DIQ(52.49,PSOIEN,27,"E")
"RTN","PSOERX1",136,0)
 I VPATINST]"" S VPATINST=$$LSIG^PSOQUTIL(VPATINST)
"RTN","PSOERX1",137,0)
 D TXT2ARY^PSOERXD1(.VAPIARY,VPATINST,68)
"RTN","PSOERX1",138,0)
 S FSVPIN=$O(VAPIARY(0))
"RTN","PSOERX1",139,0)
 S LINE=LINE+1 D SET^VALM10(LINE," Pat Inst: "_$S(FSVPIN:$G(VAPIARY(FSVPIN)),1:""))
"RTN","PSOERX1",140,0)
 S VLOOP=1 F  S VLOOP=$O(VAPIARY(VLOOP)) Q:'VLOOP  D
"RTN","PSOERX1",141,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"                        "_VAPIARY(VLOOP))
"RTN","PSOERX1",142,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Hold Status: "_$G(VAHSTA))
"RTN","PSOERX1",143,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Hold Reason: "_$G(VAHREA))
"RTN","PSOERX1",144,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Placed on hold by: "_$G(VAHPER))
"RTN","PSOERX1",145,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",146,0)
 S ERXCOMM=$$GET1^DIQ(52.49,PSOIEN,8,"E")
"RTN","PSOERX1",147,0)
 D TXT2ARY^PSOERXD1(.COMARY,ERXCOMM," ",68)
"RTN","PSOERX1",148,0)
 S COMFRST=$O(COMARY(0)) S LINE=LINE+1 D SET^VALM10(LINE,"eRx Notes: "_$G(ERXCOMM))
"RTN","PSOERX1",149,0)
 F  S COMFRST=$O(COMARY(COMFRST)) Q:'COMFRST  D
"RTN","PSOERX1",150,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"          "_$G(COMARY(COMFRST)))
"RTN","PSOERX1",151,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",152,0)
 ;/BLB/ PSO*7.0*520 - BEGIN
"RTN","PSOERX1",153,0)
 I $$GET1^DIQ(52.49,PSOIEN,.05,"I") D
"RTN","PSOERX1",154,0)
 .D ALG^PSOERXU1(.LINE)
"RTN","PSOERX1",155,0)
 ;/BLB/ - END
"RTN","PSOERX1",156,0)
 N DIAGIEN,DIAGDAT,DIAGSEQ,PDIAGQ,PDIAGV,SDIAGQ,SDIAGV,DIAGDAT,DIACIC,DRES,SDRES
"RTN","PSOERX1",157,0)
 N SDRESL,SDRESDAT,DRESL,DRESDAT,PDIAGARY,SDIAGARY,PDFRST,SDFRST,PDLOOP,SDLOOP,DIENS
"RTN","PSOERX1",158,0)
 S DIAGIEN=0 F  S DIAGIEN=$O(^PS(52.49,PSOIEN,9,DIAGIEN)) Q:'DIAGIEN  D
"RTN","PSOERX1",159,0)
 .S DIENS=DIAGIEN_","_PSOIEN_"," K PDIAGARY,SDIAGARY,DIAGDAT
"RTN","PSOERX1",160,0)
 .D GETS^DIQ(52.499,DIENS,".01:.06","IE","DIAGDAT")
"RTN","PSOERX1",161,0)
 .S DIAGSEQ=$G(DIAGDAT(52.499,DIENS,.01,"E"))
"RTN","PSOERX1",162,0)
 .S DIACIC=$G(DIAGDAT(52.499,DIENS,.02,"E"))
"RTN","PSOERX1",163,0)
 .S PDIAGQ=$G(DIAGDAT(52.499,DIENS,.03,"E"))
"RTN","PSOERX1",164,0)
 .S PDIAGV=$G(DIAGDAT(52.499,DIENS,.04,"E"))
"RTN","PSOERX1",165,0)
 .I PDIAGQ="ICD-10-CM"!(PDIAGQ="ICD-9-CM") D
"RTN","PSOERX1",166,0)
 ..K DRES,PDIAGARY
"RTN","PSOERX1",167,0)
 ..D ICDDESC^ICDXCODE(PDIAGQ,PDIAGV,,.DRES)
"RTN","PSOERX1",168,0)
 ..I '$O(DRES(0)) D TXT2ARY^PSOERXD1(.PDIAGARY,PDIAGV," ",62) Q
"RTN","PSOERX1",169,0)
 ..S DRESL=0 F  S DRESL=$O(DRES(DRESL)) Q:'DRESL  D
"RTN","PSOERX1",170,0)
 ...S DRESDAT=$G(DRES(DRESL)) Q:DRESDAT=""
"RTN","PSOERX1",171,0)
 ...I DRESL=1 S PDIAGV=PDIAGV_" - "_DRESDAT Q
"RTN","PSOERX1",172,0)
 ...S PDIAGV=PDIAGV_" "_DRESDAT
"RTN","PSOERX1",173,0)
 ..D TXT2ARY^PSOERXD1(.PDIAGARY,PDIAGV," ",62)
"RTN","PSOERX1",174,0)
 .S SDIAGQ=$G(DIAGDAT(52.499,DIENS,.05,"E"))
"RTN","PSOERX1",175,0)
 .S SDIAGV=$G(DIAGDAT(52.499,DIENS,.06,"E"))
"RTN","PSOERX1",176,0)
 .I SDIAGQ="ICD-10-CM"!(SDIAGQ="ICD-9-CM") D
"RTN","PSOERX1",177,0)
 ..K SDRES,SDIAGARY
"RTN","PSOERX1",178,0)
 ..D ICDDESC^ICDXCODE(SDIAGQ,SDIAGV,,.SDRES)
"RTN","PSOERX1",179,0)
 ..I '$O(DRES(0)) D TXT2ARY^PSOERXD1(.SDIAGARY,SDIAGV," ",62) Q
"RTN","PSOERX1",180,0)
 ..S SDRESL=0 F  S SDRESL=$O(SDRES(SDRESL)) Q:'SDRESL  D
"RTN","PSOERX1",181,0)
 ...S SDRESDAT=$G(SDRES(SDRESL)) Q:SDRESDAT=""
"RTN","PSOERX1",182,0)
 ...I SDRESL=1 S SDIAGV=SDIAGV_" - "_SDRESDAT Q
"RTN","PSOERX1",183,0)
 ...S SDIAGV=SDIAGV_" "_SDRESDAT
"RTN","PSOERX1",184,0)
 ..D TXT2ARY^PSOERXD1(.SDIAGARY,SDIAGV," ",62)
"RTN","PSOERX1",185,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Diagnosis Sequence: "_DIAGSEQ)
"RTN","PSOERX1",186,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Primary DX Qualifier: "_PDIAGQ)
"RTN","PSOERX1",187,0)
 .S PDFRST=$O(PDIAGARY(0))
"RTN","PSOERX1",188,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Primary Dx Value: "_$S(PDFRST:$G(PDIAGARY(PDFRST)),1:PDIAGV))
"RTN","PSOERX1",189,0)
 .S PDLOOP=PDFRST F  S PDLOOP=$O(PDIAGARY(PDLOOP)) Q:'PDLOOP  D
"RTN","PSOERX1",190,0)
 ..S LINE=LINE+1 D SET^VALM10(LINE,"                  "_$G(PDIAGARY(PDLOOP)))
"RTN","PSOERX1",191,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",192,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Secondary DX Qualifier: "_SDIAGQ)
"RTN","PSOERX1",193,0)
 .S SDFRST=$O(SDIAGARY(0))
"RTN","PSOERX1",194,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Secondary Dx Value: "_$S(SDFRST:$G(SDIAGARY(SDFRST)),1:SDIAGV))
"RTN","PSOERX1",195,0)
 .S SDLOOP=SDFRST F  S SDLOOP=$O(SDIAGARY(SDLOOP)) Q:'SDLOOP  D
"RTN","PSOERX1",196,0)
 ..S LINE=LINE+1 D SET^VALM10(LINE,"                    "_$G(SDIAGARY(SDLOOP)))
"RTN","PSOERX1",197,0)
 .I $O(^PS(52.49,PSOIEN,9,DIAGIEN)) S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",198,0)
 S VALMCNT=LINE
"RTN","PSOERX1",199,0)
 Q
"RTN","PSOERX1",200,0)
 ;
"RTN","PSOERX1",201,0)
HELP ; -- help code
"RTN","PSOERX1",202,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERX1",203,0)
 Q
"RTN","PSOERX1",204,0)
 ;
"RTN","PSOERX1",205,0)
EXIT ; -- exit code
"RTN","PSOERX1",206,0)
 K @VALMAR
"RTN","PSOERX1",207,0)
 ; PSO*7*527 - set VALMBCK and PSOREFSH to force refresh when returning to list view
"RTN","PSOERX1",208,0)
 S VALMBCK="R",PSOREFSH=1
"RTN","PSOERX1",209,0)
 ;D INIT^PSOERX
"RTN","PSOERX1",210,0)
 Q
"RTN","PSOERX1",211,0)
 ;
"RTN","PSOERX1",212,0)
EXPND ; -- expand code
"RTN","PSOERX1",213,0)
 Q
"RTN","PSOERX1A")
0^3^B129260267^B116223189
"RTN","PSOERX1A",1,0)
PSOERX1A ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERX1A",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,527**;DEC 1997;Build 30
"RTN","PSOERX1A",3,0)
 ;
"RTN","PSOERX1A",4,0)
 Q
"RTN","PSOERX1A",5,0)
 ; select an item
"RTN","PSOERX1A",6,0)
SI ;
"RTN","PSOERX1A",7,0)
 N RESP,ERXIEN,ERXDAT,LINE,LINEVAR,ERXPAT,ERXLOCK
"RTN","PSOERX1A",8,0)
 S DIR(0)="N^"_VALMBG_":"_VALMLST_":0" D ^DIR
"RTN","PSOERX1A",9,0)
 I 'Y S VALMBCK="R" Q
"RTN","PSOERX1A",10,0)
 S RESP=Y
"RTN","PSOERX1A",11,0)
 S ERXIEN=$O(@VALMAR@("IDX",RESP,"")) Q:'ERXIEN
"RTN","PSOERX1A",12,0)
 ; Get the patient IEN
"RTN","PSOERX1A",13,0)
 S ERXPAT=$$GET1^DIQ(52.49,ERXIEN,.04,"I")
"RTN","PSOERX1A",14,0)
 S ERXLOCK=$$L(ERXPAT,1)
"RTN","PSOERX1A",15,0)
 I 'ERXLOCK S DIR(0)="E" D ^DIR K DIR S VALMBCK="R" Q
"RTN","PSOERX1A",16,0)
 D EN^PSOERX1(ERXIEN)
"RTN","PSOERX1A",17,0)
 D UL(ERXPAT)
"RTN","PSOERX1A",18,0)
 K %
"RTN","PSOERX1A",19,0)
 S VALMBCK="R"
"RTN","PSOERX1A",20,0)
 Q
"RTN","PSOERX1A",21,0)
SBN ;
"RTN","PSOERX1A",22,0)
 N Y,ERXIEN
"RTN","PSOERX1A",23,0)
 S Y=+$P(XQORNOD(0),"=",2)
"RTN","PSOERX1A",24,0)
 I 'Y S VALMBCK="R" Q
"RTN","PSOERX1A",25,0)
 S ERXIEN=$O(@VALMAR@("IDX",Y,"")) Q:'ERXIEN
"RTN","PSOERX1A",26,0)
 S ERXPAT=$$GET1^DIQ(52.49,ERXIEN,.04,"I")
"RTN","PSOERX1A",27,0)
 S ERXLOCK=$$L(ERXPAT,1)
"RTN","PSOERX1A",28,0)
 I 'ERXLOCK S DIR(0)="E" D ^DIR K DIR S VALMBCK="R" Q
"RTN","PSOERX1A",29,0)
 D EN^PSOERX1(ERXIEN)
"RTN","PSOERX1A",30,0)
 D UL(ERXPAT)
"RTN","PSOERX1A",31,0)
 S VALMBCK="R"
"RTN","PSOERX1A",32,0)
 K %
"RTN","PSOERX1A",33,0)
 Q
"RTN","PSOERX1A",34,0)
L(DFN,DIS) ; 
"RTN","PSOERX1A",35,0)
 I $G(PSONOLCK) Q 1
"RTN","PSOERX1A",36,0)
 N FLAG S ^XTMP("PSOERXLOCK",0)=$$PDATE
"RTN","PSOERX1A",37,0)
 I '$D(^XTMP("PSOERXLOCK",DFN)) D  Q FLAG
"RTN","PSOERX1A",38,0)
 . D NOW^%DTC S ^XTMP("PSOERXLOCK",DFN)=DUZ_"^"_%
"RTN","PSOERX1A",39,0)
 . L +^XTMP("PSOERXLOCK",DFN):$S($G(DILOCKTM)>0:DILOCKTM,1:3) S FLAG=$S($T=1:$T,1:0)
"RTN","PSOERX1A",40,0)
 I $D(^XTMP("PSOERXLOCK",DFN)) Q $$R
"RTN","PSOERX1A",41,0)
UL(DFN) ; unlock
"RTN","PSOERX1A",42,0)
 I $G(PSONOLCK) Q
"RTN","PSOERX1A",43,0)
 L -^XTMP("PSOERXLOCK",DFN) K ^XTMP("PSOERXLOCK",DFN)
"RTN","PSOERX1A",44,0)
 Q 
"RTN","PSOERX1A",45,0)
 ;
"RTN","PSOERX1A",46,0)
R() ; check lock on node
"RTN","PSOERX1A",47,0)
 ;if user has same patient already locked, Q 1, will only lock once
"RTN","PSOERX1A",48,0)
 I $P($G(^XTMP("PSOERXLOCK",DFN)),"^")=DUZ Q 1
"RTN","PSOERX1A",49,0)
 L +^XTMP("PSOERXLOCK",DFN):$S($G(DILOCKTM)>0:DILOCKTM,1:3)
"RTN","PSOERX1A",50,0)
 I $T=1 D NOW^%DTC S ^XTMP("PSOERXLOCK",DFN)=DUZ_"^"_% Q 1
"RTN","PSOERX1A",51,0)
 I $T=0 W:DIS=1 !,$$WHO(DFN) S Y=$P($G(^XTMP("PSOERXLOCK",DFN)),"^",2) X ^DD("DD") Q $S(DIS=0:0_"^"_$P($G(^VA(200,+$P($G(^XTMP("PSOERXLOCK",DFN)),"^"),0)),"^")_"^"_Y,1:0)
"RTN","PSOERX1A",52,0)
 ;
"RTN","PSOERX1A",53,0)
PDATE() ;
"RTN","PSOERX1A",54,0)
 N X1,X2 S X1=DT,X2=+14 D C^%DTC
"RTN","PSOERX1A",55,0)
 Q X_"^"_DT_"^eRx Pharmacy patient locks"
"RTN","PSOERX1A",56,0)
 ;
"RTN","PSOERX1A",57,0)
WHO(DFN) ;
"RTN","PSOERX1A",58,0)
 S Y=$P($G(^XTMP("PSOERXLOCK",DFN)),"^",2) X ^DD("DD")
"RTN","PSOERX1A",59,0)
 Q $P($G(^VA(200,+$P($G(^XTMP("PSOERXLOCK",DFN)),"^"),0)),"^")_" is editing orders for this patient ("_Y_")"
"RTN","PSOERX1A",60,0)
 ;
"RTN","PSOERX1A",61,0)
 ;
"RTN","PSOERX1A",62,0)
 ; TEXT - variable where text is stored (passed by reference)
"RTN","PSOERX1A",63,0)
 ; HDR - header text
"RTN","PSOERX1A",64,0)
 ; DATA - data associated with the header
"RTN","PSOERX1A",65,0)
 ; STRT - start location (column)
"RTN","PSOERX1A",66,0)
 ; LEN - total length for header and data
"RTN","PSOERX1A",67,0)
ADDITEM(TEXT,HDR,DATA,STRT,LEN) ;
"RTN","PSOERX1A",68,0)
 N LLEN,FULLDAT,L
"RTN","PSOERX1A",69,0)
 S FULLDAT=$G(HDR)_$G(DATA)
"RTN","PSOERX1A",70,0)
 S TEXT=$G(TEXT,"") I STRT=1 S TEXT=TEXT_$E(FULLDAT,1,LEN) Q
"RTN","PSOERX1A",71,0)
 S LLEN=$L(TEXT)
"RTN","PSOERX1A",72,0)
 I LLEN<STRT D
"RTN","PSOERX1A",73,0)
 .F L=$L(TEXT):1:STRT-1 D
"RTN","PSOERX1A",74,0)
 ..S TEXT=TEXT_" "
"RTN","PSOERX1A",75,0)
 S TEXT=TEXT_$E(FULLDAT,1,LEN)
"RTN","PSOERX1A",76,0)
 Q
"RTN","PSOERX1A",77,0)
 ; provider information display
"RTN","PSOERX1A",78,0)
PROV ;
"RTN","PSOERX1A",79,0)
 I '$$GET1^DIQ(52.49,PSOIEN,2.3,"I") S XQORM("B")="Edit"
"RTN","PSOERX1A",80,0)
 D EN^PSOERXR1
"RTN","PSOERX1A",81,0)
 Q
"RTN","PSOERX1A",82,0)
 ; patient information display
"RTN","PSOERX1A",83,0)
PAT ;
"RTN","PSOERX1A",84,0)
 I '$$GET1^DIQ(52.49,PSOIEN,.05,"I") S XQORM("B")="Edit"
"RTN","PSOERX1A",85,0)
 D EN^PSOERXP1
"RTN","PSOERX1A",86,0)
 Q
"RTN","PSOERX1A",87,0)
 ; drug information display
"RTN","PSOERX1A",88,0)
DRUG ;
"RTN","PSOERX1A",89,0)
 I '$$GET1^DIQ(52.49,PSOIEN,3.2,"I") S XQORM("B")="Edit"
"RTN","PSOERX1A",90,0)
 D EN^PSOERXD1
"RTN","PSOERX1A",91,0)
 Q
"RTN","PSOERX1A",92,0)
 ; edit validation
"RTN","PSOERX1A",93,0)
 ; EDTYPE - D=drug, P=patient, PR=provider
"RTN","PSOERX1A",94,0)
EDIT(EDTYP,SBN) ;
"RTN","PSOERX1A",95,0)
 N DIR,Y,ITEM,RES,TAG,PQUIT,RXSTAT
"RTN","PSOERX1A",96,0)
 D FULL^VALM1
"RTN","PSOERX1A",97,0)
 S SBN=$G(SBN,"")
"RTN","PSOERX1A",98,0)
 S VALMBCK="R"
"RTN","PSOERX1A",99,0)
 Q:'$G(PSOIEN)
"RTN","PSOERX1A",100,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERX1A",101,0)
 .W !!,"Cannot edit a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERX1A",102,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1A",103,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1A",104,0)
 Q:'$D(EDTYP)
"RTN","PSOERX1A",105,0)
 I EDTYP="D" D  Q
"RTN","PSOERX1A",106,0)
 .D PLSTRNG(1,10,.RES,SBN)
"RTN","PSOERX1A",107,0)
 .I '$O(RES(0)) Q
"RTN","PSOERX1A",108,0)
 .D DERX1^PSOERXD2(PSOIEN,PSOIENS)
"RTN","PSOERX1A",109,0)
 .S (ITEM,PQUIT)=0 F  S ITEM=$O(RES(ITEM)) Q:'ITEM!(PQUIT)  D
"RTN","PSOERX1A",110,0)
 ..S TAG="VDRG"_ITEM_"^PSOERXD2(PSOIEN,PSOIENS)" D @TAG
"RTN","PSOERX1A",111,0)
 .K @VALMAR D INIT^PSOERXD1
"RTN","PSOERX1A",112,0)
 I EDTYP="P" D VPAT K @VALMAR D INIT^PSOERXP1 Q
"RTN","PSOERX1A",113,0)
 I EDTYP="PR" D VPROV K @VALMAR D INIT^PSOERXR1 Q
"RTN","PSOERX1A",114,0)
 Q
"RTN","PSOERX1A",115,0)
 ; edit provider
"RTN","PSOERX1A",116,0)
VPROV ;
"RTN","PSOERX1A",117,0)
 N EXPRVIEN,VAPRVIEN,MANVAL,PRVDAT,EXPRNAME,EXPRLNAM,EXPRFNAM,PSOIENS
"RTN","PSOERX1A",118,0)
 N EXPRIENS,SELPRV,QUIT,VAPNM,NEWPIEN,VANPI
"RTN","PSOERX1A",119,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1A",120,0)
 S VAPNM=$$GET1^DIQ(52.49,PSOIEN,2.3,"E")
"RTN","PSOERX1A",121,0)
 S EXPRVIEN=$$GET1^DIQ(52.49,PSOIEN,2.1,"I")
"RTN","PSOERX1A",122,0)
 S EXPRIENS=EXPRVIEN_","
"RTN","PSOERX1A",123,0)
 D GETS^DIQ(52.48,EXPRIENS,".01;.02;.03;1.5;1.6","E","PRVDAT")
"RTN","PSOERX1A",124,0)
 S EXPRNAME=$G(PRVDAT(52.48,EXPRIENS,.01,"E"))
"RTN","PSOERX1A",125,0)
 S EXPRLNAM=$G(PRVDAT(52.48,EXPRIENS,.02,"E"))
"RTN","PSOERX1A",126,0)
 S EXPRFNAM=$G(PRVDAT(52.48,EXPRIENS,.03,"E"))
"RTN","PSOERX1A",127,0)
 S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.3,"I")
"RTN","PSOERX1A",128,0)
 S VAPIEN=$$GET1^DIQ(52.49,PSOIEN,2.3,"I")
"RTN","PSOERX1A",129,0)
 I VAPIEN D  Q
"RTN","PSOERX1A",130,0)
 .W !,"Current Vista provider: "_VAPNM,!
"RTN","PSOERX1A",131,0)
 .S DIR(0)="YO",DIR("A")="Would you like to modify the current provider"
"RTN","PSOERX1A",132,0)
 .I MANVAL S DIR("A",1)="This provider has already been validated."
"RTN","PSOERX1A",133,0)
 .S DIR("B")="NO" D ^DIR
"RTN","PSOERX1A",134,0)
 .Q:'Y
"RTN","PSOERX1A",135,0)
 .S DIC=200,DIC("A")="Select PROVIDER NAME: ",DIC(0)="AEMQ",DIC("S")="I $$CHKPRV2^PSOERX1A(Y)" D ^DIC
"RTN","PSOERX1A",136,0)
 .Q:Y<1
"RTN","PSOERX1A",137,0)
 .S NEWPIEN=$P(Y,U) K Y
"RTN","PSOERX1A",138,0)
 .S ERXMMFLG=$$PRVWARN(PSOIEN,VAPIEN)
"RTN","PSOERX1A",139,0)
 .S DIR(0)="Y",DIR("A")="Would you like to use this provider"
"RTN","PSOERX1A",140,0)
 .S DIR("A",1)="You have selected provider: "_$$GET1^DIQ(200,NEWPIEN,.01,"E")
"RTN","PSOERX1A",141,0)
 .S DIR("B")=$S(ERXMMFLG:"NO",1:"YES") D ^DIR
"RTN","PSOERX1A",142,0)
 .I Y<1 S QUIT=1 Q
"RTN","PSOERX1A",143,0)
 .; change existing entry
"RTN","PSOERX1A",144,0)
 .S FDA(52.49,PSOIENS,2.3)=NEWPIEN
"RTN","PSOERX1A",145,0)
 .; if the provider is different, clear manual validation
"RTN","PSOERX1A",146,0)
 .I VAPIEN'=NEWPIEN S FDA(52.49,PSOIENS,1.3)="",FDA(52.49,PSOIENS,1.8)="",FDA(52.49,PSOIENS,1.9)=""
"RTN","PSOERX1A",147,0)
 .D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1A",148,0)
 .I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1A",149,0)
 ; for now, only list providers that are authorized to write med orders and whose dea is not expired
"RTN","PSOERX1A",150,0)
 S DIC=200,DIC("A")="Select PROVIDER NAME: ",DIC(0)="AEMQ",DIC("S")="I $$CHKPRV2^PSOERX1A(Y)" D ^DIC
"RTN","PSOERX1A",151,0)
 ;/BLB/ PSO*7.0*527 - BEGIN CHANGE - SET DEFAULT TO EDIT
"RTN","PSOERX1A",152,0)
 I Y<1 S XQORM("B")="Edit" Q
"RTN","PSOERX1A",153,0)
 ;/BLB/ PSO*7.0*527 - END CHANGE
"RTN","PSOERX1A",154,0)
 S SELPRV=$P(Y,U)
"RTN","PSOERX1A",155,0)
 S ERXMMFLG=$$PRVWARN(PSOIEN,SELPRV)
"RTN","PSOERX1A",156,0)
 S DIR(0)="Y",DIR("A")="Would you like to use this provider"
"RTN","PSOERX1A",157,0)
 S DIR("A",1)="You have selected provider: "_$$GET1^DIQ(200,SELPRV,.01,"E")
"RTN","PSOERX1A",158,0)
 S DIR("B")=$S(ERXMMFLG:"NO",1:"YES") D ^DIR
"RTN","PSOERX1A",159,0)
 I Y<1 S XQORM("B")="Edit" Q
"RTN","PSOERX1A",160,0)
 S FDA(52.49,PSOIENS,2.3)=$P(SELPRV,U)
"RTN","PSOERX1A",161,0)
 D FILE^DIE(,"FDA","ERR") K FDA
"RTN","PSOERX1A",162,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1A",163,0)
 Q
"RTN","PSOERX1A",164,0)
PRVWARN(PSOIEN,VAPIEN) ;
"RTN","PSOERX1A",165,0)
 N EXPRVNPI,VANPI,ERXDEA,VADEA,ERXMMFLG,I,ERXMSG,ERXPIEN,EXPRVDEA
"RTN","PSOERX1A",166,0)
 S ERXMMFLG=0
"RTN","PSOERX1A",167,0)
 S ERXPIEN=$$GET1^DIQ(52.49,PSOIEN,2.1,"I")
"RTN","PSOERX1A",168,0)
 S EXPRVNPI=$$GET1^DIQ(52.48,ERXPIEN,1.5,"E")
"RTN","PSOERX1A",169,0)
 S EXPRVDEA=$$GET1^DIQ(52.48,ERXPIEN,1.6,"E")
"RTN","PSOERX1A",170,0)
 I '$G(VAPIEN) S VAPIEN=$$GET1^DIQ(52.49,PSOIEN,2.3,"I") I '$G(VAPIEN) Q 0
"RTN","PSOERX1A",171,0)
 I EXPRVNPI]"",'$D(^VA(200,"ANPI",EXPRVNPI,VAPIEN)) S ERXMMFLG=1,ERXMSG(1)="Provider NPI Mismatch."
"RTN","PSOERX1A",172,0)
 I EXPRVDEA]"",'$D(^VA(200,"PS1",EXPRVDEA,VAPIEN)) S ERXMMFLG=1,ERXMSG(2)="Provider DEA Mismatch."
"RTN","PSOERX1A",173,0)
 I 'ERXMMFLG Q ERXMMFLG
"RTN","PSOERX1A",174,0)
 W !!,"******************************WARNING********************************"
"RTN","PSOERX1A",175,0)
 S I=0 F  S I=$O(ERXMSG(I)) Q:'I  D
"RTN","PSOERX1A",176,0)
 .W !,$G(ERXMSG(I))
"RTN","PSOERX1A",177,0)
 W !,"*********************************************************************"
"RTN","PSOERX1A",178,0)
 Q ERXMMFLG
"RTN","PSOERX1A",179,0)
CHKPRV2(Y) ;
"RTN","PSOERX1A",180,0)
 ;Ref. to ^VA(200 supp. by IA 224
"RTN","PSOERX1A",181,0)
 I '$P($G(^VA(200,Y,"PS")),U) Q 0
"RTN","PSOERX1A",182,0)
 Q 1
"RTN","PSOERX1A",183,0)
 ; validate drug
"RTN","PSOERX1A",184,0)
 ; prompt list or range
"RTN","PSOERX1A",185,0)
 ; LOW - lowest number to prompt for
"RTN","PSOERX1A",186,0)
 ; HIGH - highest number to prompt for
"RTN","PSOERX1A",187,0)
 ; EDIT - returned list of selected values
"RTN","PSOERX1A",188,0)
 ;        EDIT(n1)=""
"RTN","PSOERX1A",189,0)
 ;        EDIT(n2)=""
"RTN","PSOERX1A",190,0)
 ;        EDIT(n3)=""
"RTN","PSOERX1A",191,0)
PLSTRNG(LOW,HIGH,EDIT,SBN) ;
"RTN","PSOERX1A",192,0)
 N DIR,DONE,DONE2,Y,NUMCHK,NUM,VAL,I,LIST
"RTN","PSOERX1A",193,0)
 I '$G(LOW)!'$G(HIGH) S LIST=0 Q
"RTN","PSOERX1A",194,0)
 S DONE=0
"RTN","PSOERX1A",195,0)
 F  D  Q:DONE
"RTN","PSOERX1A",196,0)
 .I $$GET1^DIQ(52.49,PSOIEN,3.2,"I")="" S Y="A"
"RTN","PSOERX1A",197,0)
 .I '$D(Y),'$O(^PS(52.49,PSOIEN,21,0)) S Y="A"
"RTN","PSOERX1A",198,0)
 .I '$D(Y)!($G(Y)[" ")!($G(Y)[".") D
"RTN","PSOERX1A",199,0)
 ..S DIR(0)="FO^",DIR("A")="Which field(s) would you like to edit? ("_LOW_"-"_HIGH_") or 'A'll"
"RTN","PSOERX1A",200,0)
 ..S DIR("?")="Enter a number, range, or a list of numbers (i.e. 3, 1-5, 3,7,9, or 'A'll)"
"RTN","PSOERX1A",201,0)
 ..S DIR("B")="A"
"RTN","PSOERX1A",202,0)
 ..D ^DIR K DIR
"RTN","PSOERX1A",203,0)
 ..I Y="^" S DONE=1 Q
"RTN","PSOERX1A",204,0)
 .;/BLB/ PSO*7.0*527 - BEGIN CHANGE - PREVENTING INVALID VALUES FROM BEING ENTERED IN VD
"RTN","PSOERX1A",205,0)
 .I Y["-",Y["," D  Q
"RTN","PSOERX1A",206,0)
 ..W !!,"Invalid Response."
"RTN","PSOERX1A",207,0)
 ..W !,"Answer must be numeric (1-10), a series of numbers (3,5,7), 'A' or 'ALL'."
"RTN","PSOERX1A",208,0)
 ..S DIR(0)="E" D ^DIR K Y,DIR
"RTN","PSOERX1A",209,0)
 .I (Y[".")!(Y[" ") D  Q
"RTN","PSOERX1A",210,0)
 ..W !!,"Invalid Response."
"RTN","PSOERX1A",211,0)
 ..W !,"Answer must be numeric (1-10), a series of numbers (3,5,7), 'A' or 'ALL'."
"RTN","PSOERX1A",212,0)
 ..S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX1A",213,0)
 ..I Y'[" " K Y
"RTN","PSOERX1A",214,0)
 .;/BLB/ PSO*7.0*527 - END CHANGE
"RTN","PSOERX1A",215,0)
 .I SBN]"",'$D(Y) S Y=SBN
"RTN","PSOERX1A",216,0)
 .I Y="^" S DONE=1 Q
"RTN","PSOERX1A",217,0)
 .S Y=$$UP^XLFSTR(Y)
"RTN","PSOERX1A",218,0)
 .I Y="A"!(Y="ALL") D  Q
"RTN","PSOERX1A",219,0)
 ..F I=LOW:1:HIGH D
"RTN","PSOERX1A",220,0)
 ...S EDIT(I)=""
"RTN","PSOERX1A",221,0)
 ..S DONE=1
"RTN","PSOERX1A",222,0)
 .; check for a range or list of numbers
"RTN","PSOERX1A",223,0)
 .I Y'["-",Y'[",",Y'<LOW,Y'>HIGH S EDIT(+Y)="" S DONE=1 Q
"RTN","PSOERX1A",224,0)
 .I Y?1.2N1"-"1.2N D
"RTN","PSOERX1A",225,0)
 ..F I=$P(Y,"-"):1:$P(Y,"-",2) D
"RTN","PSOERX1A",226,0)
 ...Q:I<LOW!(I>HIGH)
"RTN","PSOERX1A",227,0)
 ...S EDIT(I)=""
"RTN","PSOERX1A",228,0)
 .I $D(EDIT) S DONE=1 Q
"RTN","PSOERX1A",229,0)
 .I Y["," D
"RTN","PSOERX1A",230,0)
 ..; check to see if there are alpha-numerics if there are, quit and reprompt
"RTN","PSOERX1A",231,0)
 ..S NUMCHK=$TR(Y,",","") I 'NUMCHK W !,"Invalid response." Q
"RTN","PSOERX1A",232,0)
 ..S DONE2=0
"RTN","PSOERX1A",233,0)
 ..F NUM=1:1 D  Q:DONE2
"RTN","PSOERX1A",234,0)
 ...S VAL=$P(Y,",",NUM)
"RTN","PSOERX1A",235,0)
 ...I 'VAL S DONE2=1 Q
"RTN","PSOERX1A",236,0)
 ...I VAL<LOW!(VAL>HIGH) Q
"RTN","PSOERX1A",237,0)
 ...S EDIT(VAL)=""
"RTN","PSOERX1A",238,0)
 .I $D(EDIT) S DONE=1 Q
"RTN","PSOERX1A",239,0)
 .W !!,"Invalid Response."
"RTN","PSOERX1A",240,0)
 .W !,"Answer must be numeric (1-10), a series of numbers (3,5,7), 'A' or 'ALL'."
"RTN","PSOERX1A",241,0)
 .S DIR(0)="E" D ^DIR K Y,DIR
"RTN","PSOERX1A",242,0)
 .;S DONE=1
"RTN","PSOERX1A",243,0)
 Q
"RTN","PSOERX1A",244,0)
 ; validate patient
"RTN","PSOERX1A",245,0)
VPAT ;
"RTN","PSOERX1A",246,0)
 N ERXPIEN,VAPIEN,MANVAL,ERXLNAME,ERXFNAME,DIR,Y,PSOIENS,VAPIEN,MANVAL,DIR,DIC,SELPAT,PDONE,DFN,I
"RTN","PSOERX1A",247,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1A",248,0)
 S ERXPIEN=$$GET1^DIQ(52.49,PSOIEN,.04,"I")
"RTN","PSOERX1A",249,0)
 S ERXLNAME=$$GET1^DIQ(52.46,ERXPIEN,.02,"E")
"RTN","PSOERX1A",250,0)
 S ERXFNAME=$$GET1^DIQ(52.46,ERXPIEN,.03,"E")
"RTN","PSOERX1A",251,0)
 S VAPIEN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERX1A",252,0)
 S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.7,"I")
"RTN","PSOERX1A",253,0)
 ; if there is a patient currently defined
"RTN","PSOERX1A",254,0)
 I VAPIEN D  Q
"RTN","PSOERX1A",255,0)
 .W !,"Current Vista patient: "_$$GET1^DIQ(2,VAPIEN,.01,"E"),!
"RTN","PSOERX1A",256,0)
 .S DIR(0)="YO",DIR("A")="Would you like to edit the patient"
"RTN","PSOERX1A",257,0)
 .S DIR("A",1)="A patient has already matched to a vista patient."
"RTN","PSOERX1A",258,0)
 .;/BLB/ PSO*7.0*527 - BEGIN CHANGE - PREVENT USER FROM ADDING NEW PATIENT
"RTN","PSOERX1A",259,0)
 .S DIR("B")="NO",DIC(0)="AEMQ" D ^DIR
"RTN","PSOERX1A",260,0)
 .;/BLB/ - END CHANGE
"RTN","PSOERX1A",261,0)
 .Q:Y'=1
"RTN","PSOERX1A",262,0)
 .S SELPAT=$$PATPRMT() K DUOUT Q:'SELPAT
"RTN","PSOERX1A",263,0)
 .S DFN=SELPAT D DEM^VADPT
"RTN","PSOERX1A",264,0)
 .I $P($G(VADM(6)),U)]"" W "[PATIENT DIED ON "_$P($G(VADM(6)),U,2)_"]" Q
"RTN","PSOERX1A",265,0)
 .S ERXMMFLG=$$PATWARN(PSOIEN,SELPAT)
"RTN","PSOERX1A",266,0)
 .S DIR(0)="Y",DIR("A")="Would you like to use this patient"
"RTN","PSOERX1A",267,0)
 .S DIR("A",1)="You have selected patient: "_$$GET1^DIQ(2,SELPAT,.01,"E")
"RTN","PSOERX1A",268,0)
 .S DIR("B")=$S($G(ERXMMFLG):"NO",1:"YES") D ^DIR
"RTN","PSOERX1A",269,0)
 .Q:Y'=1
"RTN","PSOERX1A",270,0)
 .; change existing entry
"RTN","PSOERX1A",271,0)
 .S FDA(52.49,PSOIENS,.05)=SELPAT
"RTN","PSOERX1A",272,0)
 .I SELPAT'=VAPIEN S FDA(52.49,PSOIENS,1.7)="",FDA(52.49,PSOIENS,1.13)="",FDA(52.49,PSOIENS,1.14)=""
"RTN","PSOERX1A",273,0)
 .D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1A",274,0)
 .I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1A",275,0)
 S DIC(0)="AEMQ",SELPAT=$$PATPRMT() K DUOUT I 'SELPAT S XQORM("B")="Edit" Q
"RTN","PSOERX1A",276,0)
 S DFN=SELPAT D DEM^VADPT
"RTN","PSOERX1A",277,0)
 I $P($G(VADM(6)),U)]"" W "[PATIENT DIED ON "_$P($G(VADM(6)),U,2)_"]" S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX1A",278,0)
 S ERXMMFLG=$$PATWARN(PSOIEN,SELPAT)
"RTN","PSOERX1A",279,0)
 S DIR(0)="Y",DIR("A")="Would you like to use this patient"
"RTN","PSOERX1A",280,0)
 S DIR("A",1)="You have selected patient: "_$$GET1^DIQ(2,SELPAT,.01,"E")
"RTN","PSOERX1A",281,0)
 S DIR("B")=$S($G(ERXMMFLG):"NO",1:"YES") D ^DIR
"RTN","PSOERX1A",282,0)
 I Y'=1 S XQORM("B")="Edit" Q
"RTN","PSOERX1A",283,0)
 S FDA(52.49,PSOIENS,.05)=SELPAT
"RTN","PSOERX1A",284,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1A",285,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1A",286,0)
 Q
"RTN","PSOERX1A",287,0)
PATWARN(PSOIEN,SELPAT) ;
"RTN","PSOERX1A",288,0)
 N ERXPIEN,ERXSSN,ERXDOB,ERXGEN,ERXMMFLG,ERXMSG,EXPRVDEA
"RTN","PSOERX1A",289,0)
 S ERXMMFLG=0
"RTN","PSOERX1A",290,0)
 S ERXPIEN=$$GET1^DIQ(52.49,PSOIEN,.04,"I")
"RTN","PSOERX1A",291,0)
 S ERXSSN=$$GET1^DIQ(52.46,ERXPIEN,1.4,"E"),ERXSSN=$TR(ERXSSN,"-","")
"RTN","PSOERX1A",292,0)
 S ERXDOB=$$GET1^DIQ(52.46,ERXPIEN,.08,"I")
"RTN","PSOERX1A",293,0)
 S ERXGEN=$$GET1^DIQ(52.46,ERXPIEN,.07,"I")
"RTN","PSOERX1A",294,0)
 ; if the selected patient is not defined, use the va matched patient because we are doing this check
"RTN","PSOERX1A",295,0)
 ; during accept validation
"RTN","PSOERX1A",296,0)
 I '$G(SELPAT) S SELPAT=$$GET1^DIQ(52.49,PSOIEN,.05,"I") Q:'$G(SELPAT) 0
"RTN","PSOERX1A",297,0)
 I '$D(VADM) S DFN=SELPAT D DEM^VADPT
"RTN","PSOERX1A",298,0)
 I ERXSSN,'$D(^DPT("SSN",ERXSSN,SELPAT)) S ERXMMFLG=1,ERXMSG(1)="SSN mismatch."
"RTN","PSOERX1A",299,0)
 I ERXDOB,'$D(^DPT("ADOB",ERXDOB,SELPAT)) S ERXMMFLG=1,ERXMSG(2)="Date of Birth mismatch."
"RTN","PSOERX1A",300,0)
 I ERXGEN]"",$P($G(VADM(5)),U)'=ERXGEN S ERXMMFLG=1,ERXMSG(3)="Gender mismatch."
"RTN","PSOERX1A",301,0)
 Q:'ERXMMFLG 0
"RTN","PSOERX1A",302,0)
 W !!,"******************************WARNING********************************"
"RTN","PSOERX1A",303,0)
 S I=0 F  S I=$O(ERXMSG(I)) Q:'I  D
"RTN","PSOERX1A",304,0)
 .W !,$G(ERXMSG(I))
"RTN","PSOERX1A",305,0)
 W !,"*********************************************************************"
"RTN","PSOERX1A",306,0)
 Q 1
"RTN","PSOERX1A",307,0)
PATPRMT() ;
"RTN","PSOERX1A",308,0)
 N Y
"RTN","PSOERX1A",309,0)
 D ^DPTLK
"RTN","PSOERX1A",310,0)
 I $P(Y,U)<1 Q 0
"RTN","PSOERX1A",311,0)
 Q $P(Y,U)
"RTN","PSOERX1B")
0^10^B162952220^B154507607
"RTN","PSOERX1B",1,0)
PSOERX1B ;ALB/BWF - Accept eRx function ; 8/3/2016 5:14pm
"RTN","PSOERX1B",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,506,520,527**;DEC 1997;Build 30
"RTN","PSOERX1B",3,0)
 ;
"RTN","PSOERX1B",4,0)
 Q
"RTN","PSOERX1B",5,0)
ACVAL(PSOIEN,TYPE) ;
"RTN","PSOERX1B",6,0)
 N F,VBFLD,VBDTTMF,DIR,TAG,VALPAR,VAL,CURVAL,MVFLD,VBFLD,VBDTTMF,PSOIENS,RXSTAT,QFLG,VDTTM,ERXMMFLG
"RTN","PSOERX1B",7,0)
 S F=52.49,PSOIENS=PSOIEN_","
"RTN","PSOERX1B",8,0)
 D FULL^VALM1
"RTN","PSOERX1B",9,0)
 S VALMBCK="R"
"RTN","PSOERX1B",10,0)
 ; first check to see if the entry exists. cannot validate something that has no value
"RTN","PSOERX1B",11,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERX1B",12,0)
 .W !!,"Cannot accept validation for a prescription with a status of 'Rejected',",!,"'Removed',or 'Processed",!
"RTN","PSOERX1B",13,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",14,0)
 Q:TYPE']""
"RTN","PSOERX1B",15,0)
 S TAG=$S(TYPE="P":"patient",TYPE="PR":"provider",TYPE="D":"drug",1:"")
"RTN","PSOERX1B",16,0)
 S VALPAR=$S(TYPE="P":.05,TYPE="PR":2.3,TYPE="D":3.2,1:"") Q:VALPAR=""
"RTN","PSOERX1B",17,0)
 S VAL=$$GET1^DIQ(F,PSOIEN,VALPAR,"I") I 'VAL D  Q
"RTN","PSOERX1B",18,0)
 .W !,"Vista "_TAG_" has not been matched. Cannot manually validate."
"RTN","PSOERX1B",19,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",20,0)
 S MVFLD=$S(TYPE="P":1.7,TYPE="PR":1.3,TYPE="D":1.5,1:"")
"RTN","PSOERX1B",21,0)
 S VBFLD=$S(TYPE="P":1.13,TYPE="PR":1.8,TYPE="D":1.11,1:"")
"RTN","PSOERX1B",22,0)
 S VBDTTMF=$S(TYPE="P":1.14,TYPE="PR":1.9,TYPE="D":1.12,1:"")
"RTN","PSOERX1B",23,0)
 ; check to see if this is already validated
"RTN","PSOERX1B",24,0)
 I MVFLD S CURVAL=$$GET1^DIQ(F,PSOIEN,MVFLD,"I")
"RTN","PSOERX1B",25,0)
 I CURVAL D  Q
"RTN","PSOERX1B",26,0)
 .W !!,"This "_TAG_" has already been manually validated."
"RTN","PSOERX1B",27,0)
 .W !,"Validated By: "_$$GET1^DIQ(F,PSOIEN,VBFLD,"E")
"RTN","PSOERX1B",28,0)
 .W !,"Validated Date/Time: "_$$GET1^DIQ(F,PSOIEN,VBDTTMF,"E"),!
"RTN","PSOERX1B",29,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",30,0)
 S QFLG=0
"RTN","PSOERX1B",31,0)
 I TYPE="D" D
"RTN","PSOERX1B",32,0)
 .W !
"RTN","PSOERX1B",33,0)
 .I '$O(^PS(52.49,PSOIEN,21,0)) W !,"Dosing information missing." S QFLG=1
"RTN","PSOERX1B",34,0)
 .I $$GET1^DIQ(52.49,PSOIEN,20.1,"E")="" W !,"Quantity missing." S QFLG=1
"RTN","PSOERX1B",35,0)
 .I $$GET1^DIQ(52.49,PSOIEN,20.2,"E")="" W !,"Days supply missing." S QFLG=1
"RTN","PSOERX1B",36,0)
 .;I $$GET1^DIQ(52.49,PSOIEN,20.5,"E")="" W !,"Refills missing."  S QFLG=1
"RTN","PSOERX1B",37,0)
 .I QFLG=1 D
"RTN","PSOERX1B",38,0)
 ..W !!,"Cannot validate drug information."
"RTN","PSOERX1B",39,0)
 ..S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX1B",40,0)
 Q:QFLG
"RTN","PSOERX1B",41,0)
 I TYPE="P" S ERXMMFLG=$$PATWARN^PSOERX1A(PSOIEN)
"RTN","PSOERX1B",42,0)
 I TYPE="PR" S ERXMMFLG=$$PRVWARN^PSOERX1A(PSOIEN)
"RTN","PSOERX1B",43,0)
 W !,"Would you like to mark this "_TAG_" as VALIDATED?"
"RTN","PSOERX1B",44,0)
 S DIR(0)="Y",DIR("B")=$S($G(ERXMMFLG):"NO",1:"YES") D ^DIR Q:Y'=1
"RTN","PSOERX1B",45,0)
 K FDA,DIR
"RTN","PSOERX1B",46,0)
 S VDTTM=$$NOW^XLFDT
"RTN","PSOERX1B",47,0)
 I MVFLD S FDA(F,PSOIENS,MVFLD)=1
"RTN","PSOERX1B",48,0)
 I VBFLD S FDA(F,PSOIENS,VBFLD)=$G(DUZ)
"RTN","PSOERX1B",49,0)
 I VBDTTMF S FDA(F,PSOIENS,VBDTTMF)=VDTTM
"RTN","PSOERX1B",50,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1B",51,0)
 I $D(FDA) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",52,0)
 W !,"Validation Updated!!" S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",53,0)
 ;/BLB/ PSO*7.0*527 - BEGIN CHANGE - VALIDATION/WAIT STATUS CHECK
"RTN","PSOERX1B",54,0)
 ; check validations and update status to 'wait' if all validations have occured.
"RTN","PSOERX1B",55,0)
 I $$GET1^DIQ(52.49,PSOIEN,1.3,"I"),$$GET1^DIQ(52.49,PSOIEN,1.5,"I"),$$GET1^DIQ(52.49,PSOIEN,1.7,"I") D
"RTN","PSOERX1B",56,0)
 .D UPDSTAT^PSOERXU1(PSOIEN,"W")
"RTN","PSOERX1B",57,0)
 .;/BLB/ - PSO*7.0*527 END CHANGE
"RTN","PSOERX1B",58,0)
 I TYPE="P" D BPROC(PSOIEN,"PA",MVFLD,VBFLD,VBDTTMF,VDTTM) K @VALMAR D INIT^PSOERXP1
"RTN","PSOERX1B",59,0)
 I TYPE="PR" D BPROC(PSOIEN,"PR",MVFLD,VBFLD,VBDTTMF,VDTTM) K @VALMAR D INIT^PSOERXR1
"RTN","PSOERX1B",60,0)
 I TYPE="D" K @VALMAR D INIT^PSOERXD1
"RTN","PSOERX1B",61,0)
 Q
"RTN","PSOERX1B",62,0)
BPROC(PSOIEN,BTYPE,MVFLD,VBFLD,VBDTTMF,VDTTM) ;
"RTN","PSOERX1B",63,0)
 N ERXPAT,ERXSTAT,ERESTAT,ERXDT,ERXIEN,ERXARY,DIR,Y,L,LINE,CNT,EHID,EDRUG,EPROV,EPAT,ERXRDT,ERXRECDT,ERXEDT,I
"RTN","PSOERX1B",64,0)
 N REXEDT,EEPROV,ERXPROV,EXARY
"RTN","PSOERX1B",65,0)
 S ERXPAT=$$GET1^DIQ(52.49,PSOIEN,.04,"I") Q:'ERXPAT
"RTN","PSOERX1B",66,0)
 S ERXPROV=$$GET1^DIQ(52.49,PSOIEN,2.1,"I")
"RTN","PSOERX1B",67,0)
 S ERXRECDT=$P($$GET1^DIQ(52.49,PSOIEN,.03,"I"),".")
"RTN","PSOERX1B",68,0)
 S ERXEDT=ERXRECDT_".2359"
"RTN","PSOERX1B",69,0)
 S ERXSTAT=0 F  S ERXSTAT=$O(^PS(52.49,"PAT",PSNPINST,ERXSTAT)) Q:'ERXSTAT  D
"RTN","PSOERX1B",70,0)
 .S ERESTAT=$$GET1^DIQ(52.45,ERXSTAT,.01,"E")
"RTN","PSOERX1B",71,0)
 .; do not consider rx's that are rejected, removed, processed.
"RTN","PSOERX1B",72,0)
 .I ERESTAT="PR"!(ERESTAT="RM")!(ERESTAT="RJ") Q
"RTN","PSOERX1B",73,0)
 .S ERXDT=ERXRECDT-.0001 F  S ERXDT=$O(^PS(52.49,"PAT",PSNPINST,ERXSTAT,ERXPAT,ERXDT)) Q:ERXDT>ERXEDT!(ERXDT="")  D
"RTN","PSOERX1B",74,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"PAT",PSNPINST,ERXSTAT,ERXPAT,ERXDT,ERXIEN)) Q:'ERXIEN  D
"RTN","PSOERX1B",75,0)
 ...;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1B",76,0)
 ...Q:PSOIEN=ERXIEN
"RTN","PSOERX1B",77,0)
 ...;/BLB/ PSO*7.0*520 - END CHANGE
"RTN","PSOERX1B",78,0)
 ...I BTYPE="PR",$$GET1^DIQ(52.49,ERXIEN,2.1,"I")'=ERXPROV Q
"RTN","PSOERX1B",79,0)
 ...S EXARY(ERXIEN)=""
"RTN","PSOERX1B",80,0)
 I '$O(EXARY(0)) Q
"RTN","PSOERX1B",81,0)
 W !!
"RTN","PSOERX1B",82,0)
 I BTYPE="PA" D
"RTN","PSOERX1B",83,0)
 .W !,"This patient has other prescriptions for: "_$$FMTE^XLFDT(ERXRECDT)
"RTN","PSOERX1B",84,0)
 .W !,"Patient: "_$$GET1^DIQ(52.46,ERXPAT,.01,"E")
"RTN","PSOERX1B",85,0)
 I BTYPE="PR" D
"RTN","PSOERX1B",86,0)
 .W !,"There are other prescriptions for this patient, written by this provider on"
"RTN","PSOERX1B",87,0)
 .W !,$$FMTE^XLFDT(ERXRECDT)
"RTN","PSOERX1B",88,0)
 .W !,"Provider: "_$$GET1^DIQ(52.48,ERXPROV,.01,"E")
"RTN","PSOERX1B",89,0)
 .W !,"Patient: "_$$GET1^DIQ(52.46,ERXPAT,.01,"E")
"RTN","PSOERX1B",90,0)
 W !!,?4,"DRUG",?30,"PROVIDER",?60,"REC DATE"
"RTN","PSOERX1B",91,0)
 S $P(LINE,"-",80)="" W !,LINE
"RTN","PSOERX1B",92,0)
 S L=0,CNT=0 F  S L=$O(EXARY(L)) Q:'L  D
"RTN","PSOERX1B",93,0)
 .S CNT=CNT+1
"RTN","PSOERX1B",94,0)
 .S EHID=$$GET1^DIQ(52.49,L,.01,"E")
"RTN","PSOERX1B",95,0)
 .S EDRUG=$$GET1^DIQ(52.49,L,3.1,"E")
"RTN","PSOERX1B",96,0)
 .S EEPROV=$$GET1^DIQ(52.49,L,2.1,"I")
"RTN","PSOERX1B",97,0)
 .S EPROV=$$GET1^DIQ(52.48,EEPROV,.01,"E")
"RTN","PSOERX1B",98,0)
 .S EPAT=$$GET1^DIQ(52.46,ERXPAT,.01,"E")
"RTN","PSOERX1B",99,0)
 .S ERXRDT=$P($$GET1^DIQ(52.49,L,.03,"E"),"@")
"RTN","PSOERX1B",100,0)
 .W !,CNT_".) "_$E(EDRUG,1,28),?30,$E(EPROV,1,28),?60,ERXRDT
"RTN","PSOERX1B",101,0)
 W !!,"Would you like apply the above validation to these prescriptions?"
"RTN","PSOERX1B",102,0)
 K Y S DIR(0)="YO"
"RTN","PSOERX1B",103,0)
 S DIR("B")="N" D ^DIR K DIR
"RTN","PSOERX1B",104,0)
 I Y="^"!(Y=0) Q
"RTN","PSOERX1B",105,0)
 S I=0 F  S I=$O(EXARY(I)) Q:'I  D
"RTN","PSOERX1B",106,0)
 .I BTYPE="PA" S FDA(52.49,I_",",.05)=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERX1B",107,0)
 .I BTYPE="PR" S FDA(52.49,I_",",2.3)=$$GET1^DIQ(52.49,PSOIEN,2.3,"I")
"RTN","PSOERX1B",108,0)
 .S FDA(52.49,I_",",MVFLD)=1,FDA(52.49,I_",",VBFLD)=$G(DUZ),FDA(52.49,I_",",VBDTTMF)=VDTTM
"RTN","PSOERX1B",109,0)
 .D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",110,0)
 .I $$GET1^DIQ(52.49,I,1,"E")="N" D UPDSTAT^PSOERXU1(I,"I")
"RTN","PSOERX1B",111,0)
 .;/BLB/ PSO*7.0*527 - BEGIN CHANGE - BULK PROCESSING/WAIT STATUS CHECK
"RTN","PSOERX1B",112,0)
 .I $$GET1^DIQ(52.49,I,1.3,"I"),$$GET1^DIQ(52.49,I,1.5,"I"),$$GET1^DIQ(52.49,I,1.7,"I") D
"RTN","PSOERX1B",113,0)
 ..D UPDSTAT^PSOERXU1(I,"W")
"RTN","PSOERX1B",114,0)
 .;/BLB/ -  PSO*7.0*527 END CHANGE
"RTN","PSOERX1B",115,0)
 Q
"RTN","PSOERX1B",116,0)
 ;PSOHY("LOC")=IEN of hospital location file (#44) - NOT USED, 
"RTN","PSOERX1B",117,0)
 ;PSOHY("CHNUM")=EXTERNAL PLACER ORDER NUMBER (NEED TO FIND OUT HOW WE SHOULD SET THIS) (25)
"RTN","PSOERX1B",118,0)
 ;PSOHY("PICK")=MAIL/WINDOW (20.4) 
"RTN","PSOERX1B",119,0)
 ;PSOHY("ENTER")=ENTERED BY IEN (2.1)
"RTN","PSOERX1B",120,0)
 ;PSOHY("PROV")=PROVIDER IEN (2.3)
"RTN","PSOERX1B",121,0)
 ;PSOHY("SDT")=EFFECTIVE DATE (6.3)
"RTN","PSOERX1B",122,0)
 ;PSOHY("ITEM")=PHARMACY ORDERABLE ITEM (DERIVED FROM THE DRUG IEN) - NO MAPPING TO 52.49
"RTN","PSOERX1B",123,0)
 ;PSOHY("DRUG")=DRUG IEN (3.2)
"RTN","PSOERX1B",124,0)
 ;PSOHY("QTY")=QUANTITY (20.1)
"RTN","PSOERX1B",125,0)
 ;PSOHY("REF")=# OF REFILLS (20.5)
"RTN","PSOERX1B",126,0)
 ;PSOHY("PAT")=PATIENT IEN (.05)
"RTN","PSOERX1B",127,0)
 ;PSOHY("OCC")=ORDER TYPE (ALWAYS 'NW') - NO MAPPING TO 52.49
"RTN","PSOERX1B",128,0)
 ;PSOHY("EDT")=LOGIN DATE (TODAYS DATE) - NO MAPPING TO 52.49
"RTN","PSOERX1B",129,0)
 ;PSOHY("PRIOR")=PRIORITY (SET OF CODES, 52.41,25 - STAT, EMERGENCY, ROUTINE)
"RTN","PSOERX1B",130,0)
 ;PSOHY("EXAPP")=EXTERNAL APPLICATION (FREE TEXT), LIKELY "PSO" - NO MAPPING TO 52.49
"RTN","PSOERX1B",131,0)
 ;PSOHY("PRCOM",#)=PROVIDER COMMENTS (8- NOTES)
"RTN","PSOERX1B",132,0)
 ;PSOHY("SIG",#)=SIG (52.4911 (STRUCTURED SIG), FIELD 1 (SIG FREE TEXT)
"RTN","PSOERX1B",133,0)
 ;PSOHY("QTSUB",CNT)=QUANTITY TIMING SUBFILE DATA. MERGED IN, FULL SUBFILE DATA
"RTN","PSOERX1B",134,0)
 ; QUANTITY/TIMING MAPS DIRECTLY TO QUANTITY TIMING IN 52.41
"RTN","PSOERX1B",135,0)
SETUP ;
"RTN","PSOERX1B",136,0)
 N PSOIENS,PSODAT,F,PATIEN,PROVIEN,OC,VQTY,EFFDT,VADRUG,VAOI,VAREF,VAROUT,VAPRIOR,PSOHY,LOC,ERXNUM,PRVARY,PRVCOMM
"RTN","PSOERX1B",137,0)
 N PLOOP,PCNT,QTLOOP,QTCNT,PSOEXMS,DIR,ORDERTYP,PSOEXCNT,SCNT,SIGDAT,SLOOP,POORD,PMVAL,PRMVAL,DMVAL,PATINST,RXSTAT
"RTN","PSOERX1B",138,0)
 N VADAYS,UNEXPI,PINARY,WRITDT,SLOOP2
"RTN","PSOERX1B",139,0)
 S F=52.49
"RTN","PSOERX1B",140,0)
 Q:'$G(PSOIEN)
"RTN","PSOERX1B",141,0)
 D FULL^VALM1
"RTN","PSOERX1B",142,0)
 S VALMBCK="R"
"RTN","PSOERX1B",143,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERX1B",144,0)
 .W !!,"Cannot accept a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERX1B",145,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",146,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1B",147,0)
 D GETS^DIQ(F,PSOIENS,".01;.05;.07;1;1.3;1.5;1.7;2.1;2.3;3.2;5.9;6.2;6.3;8;20.1;20.2;20.4;20.5;20.6;25;25.2;27;30","IE","PSODAT")
"RTN","PSOERX1B",148,0)
 S PSOEXCNT=0
"RTN","PSOERX1B",149,0)
 S ERXSTA=$G(PSODAT(F,PSOIENS,1,"E")) I ERXSTA="E"!($E(ERXSTA)="H") S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="eRx is in a 'Hold' status." D MSGDIR^PSOERXU1(.PSOEXMS) Q
"RTN","PSOERX1B",150,0)
 S PMVAL=$G(PSODAT(F,PSOIENS,1.7,"I")) I 'PMVAL S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Patient has not been manually validated."
"RTN","PSOERX1B",151,0)
 S PRMVAL=$G(PSODAT(F,PSOIENS,1.3,"I")) I 'PRMVAL S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Provider has not been manually validated."
"RTN","PSOERX1B",152,0)
 S DMVAL=$G(PSODAT(F,PSOIENS,1.5,"I")) I 'DMVAL S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Drug has not been manually validated."
"RTN","PSOERX1B",153,0)
 ; for now, if validations have not occurred, do not check the other fields.
"RTN","PSOERX1B",154,0)
 I $O(PSOEXMS(0)) D MSGDIR^PSOERXU1(.PSOEXMS) Q
"RTN","PSOERX1B",155,0)
 S POORD=$G(PSODAT(F,PSOIENS,25.2,"I")) I POORD S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Pending outpatient order already exists."
"RTN","PSOERX1B",156,0)
 S PATIEN=$G(PSODAT(F,PSOIENS,.05,"I")) I 'PATIEN S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="No matched vista patient."
"RTN","PSOERX1B",157,0)
 S PROVIEN=$G(PSODAT(F,PSOIENS,2.3,"I")) I 'PROVIEN S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Provider not matched to a vista provider."
"RTN","PSOERX1B",158,0)
 S VADRUG=$G(PSODAT(F,PSOIENS,3.2,"I")) I 'VADRUG S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Drug not matched to a vista drug."
"RTN","PSOERX1B",159,0)
 S LOC=$G(PSODAT(F,PSOIENS,20.6,"I"))
"RTN","PSOERX1B",160,0)
 S ERXNUM=$G(PSODAT(F,PSOIENS,.01,"E")) I 'ERXNUM S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="eRx number missing."
"RTN","PSOERX1B",161,0)
 S VQTY=$G(PSODAT(F,PSOIENS,20.1,"E")) I 'VQTY S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Quantity missing."
"RTN","PSOERX1B",162,0)
 S EFFDT=$G(PSODAT(F,PSOIENS,6.3,"I")),WRITDT=$G(PSODAT(F,PSOIENS,5.9,"I"))
"RTN","PSOERX1B",163,0)
 ; if the effective date is passed in and there is no time, add .000001 to the date
"RTN","PSOERX1B",164,0)
 I EFFDT]"" S EFFDT=$P(EFFDT,".")
"RTN","PSOERX1B",165,0)
 I '$L(EFFDT) S EFFDT=WRITDT
"RTN","PSOERX1B",166,0)
 S VADAYS=$G(PSODAT(F,PSOIENS,20.2,"E"))
"RTN","PSOERX1B",167,0)
 S VAOI=$$GET1^DIQ(50,VADRUG,2.1,"I") I 'VAOI S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Orderable item not associated with drug."
"RTN","PSOERX1B",168,0)
 S VAREF=$G(PSODAT(F,PSOIENS,20.5,"E"))
"RTN","PSOERX1B",169,0)
 S VAROUT=$G(PSODAT(F,PSOIENS,20.4,"I")) I '$L(VAROUT) S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Pickup routing missing."
"RTN","PSOERX1B",170,0)
 S PATINST=$G(PSODAT(F,PSOIENS,27,"E"))
"RTN","PSOERX1B",171,0)
 D TXT2ARY^PSOERXD1(.PINARY,$$LSIG^PSOQUTIL(PATINST))
"RTN","PSOERX1B",172,0)
 ; get provider comments from VA PROVIDER COMMENTS field
"RTN","PSOERX1B",173,0)
 S PRVCOMM=$G(PSODAT(F,PSOIENS,30,"E"))
"RTN","PSOERX1B",174,0)
 D TXT2ARY^PSOERXD1(.PRVARY,$$LSIG^PSOQUTIL(PRVCOMM))
"RTN","PSOERX1B",175,0)
 S (PLOOP,PCNT)=0 F  S PLOOP=$O(PRVARY(PLOOP)) Q:'PLOOP  D
"RTN","PSOERX1B",176,0)
 .S PCNT=PCNT+1,PSOHY("PRCOM",PCNT)=$G(PRVARY(PLOOP))
"RTN","PSOERX1B",177,0)
 I '$O(^PS(52.49,PSOIEN,21,0)) S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Dosing information missing."
"RTN","PSOERX1B",178,0)
 S (QTLOOP,QTCNT)=0 F  S QTLOOP=$O(^PS(52.49,PSOIEN,21,QTLOOP)) Q:'QTLOOP  D
"RTN","PSOERX1B",179,0)
 .S QTCNT=QTCNT+1 M PSOHY("QTSUB",QTCNT)=^PS(52.49,PSOIEN,21,QTLOOP)
"RTN","PSOERX1B",180,0)
 ; always 'routine' for now
"RTN","PSOERX1B",181,0)
 S VAPRIOR="R"
"RTN","PSOERX1B",182,0)
 ; always 'new' for this version
"RTN","PSOERX1B",183,0)
 S ORDERTYP="NW"
"RTN","PSOERX1B",184,0)
 S PSOHY("LOC")=LOC,PSOHY("CHNUM")=$G(ERXNUM)
"RTN","PSOERX1B",185,0)
 S PSOHY("PICK")=VAROUT,PSOHY("ENTER")=PROVIEN
"RTN","PSOERX1B",186,0)
 S PSOHY("PROV")=PROVIEN,PSOHY("SDT")=EFFDT
"RTN","PSOERX1B",187,0)
 S PSOHY("ITEM")=VAOI,PSOHY("DRUG")=VADRUG
"RTN","PSOERX1B",188,0)
 S PSOHY("QTY")=VQTY,PSOHY("REF")=VAREF
"RTN","PSOERX1B",189,0)
 S (PSOHY("PAT"),DFN)=PATIEN,PSOHY("OCC")=ORDERTYP
"RTN","PSOERX1B",190,0)
 ; login date will always be the written date. if there is no written date by chance, use the received date
"RTN","PSOERX1B",191,0)
 ;S PSOHY("EDT")=$S(WRITDT'="":$P(WRITDT,"."),1:$P($$GET1^DIQ(52.49,PSOIEN,.03,"I"),"."))
"RTN","PSOERX1B",192,0)
 S PSOHY("EDT")=DT,PSOHY("PRIOR")=VAPRIOR
"RTN","PSOERX1B",193,0)
 ; ALWAYS PSO as the external application
"RTN","PSOERX1B",194,0)
 S PSOHY("EXAPP")="PHARMACY"
"RTN","PSOERX1B",195,0)
 S PSOHY("DAYS")=VADAYS
"RTN","PSOERX1B",196,0)
 ; sig from eRx
"RTN","PSOERX1B",197,0)
 S (SLOOP,SCNT)=0 F  S SLOOP=$O(^PS(52.49,PSOIEN,"SIG",SLOOP)) Q:'SLOOP  D
"RTN","PSOERX1B",198,0)
 .S SIGDAT=$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0))
"RTN","PSOERX1B",199,0)
 .S SCNT=SCNT+1,PSOHY("SIG",SCNT)=SIGDAT
"RTN","PSOERX1B",200,0)
 S SLOOP2=0 F  S SLOOP2=$O(PINARY(SLOOP2)) Q:'SLOOP2  D
"RTN","PSOERX1B",201,0)
 .S SCNT=SCNT+1,PSOHY("SIG",SCNT)=$G(PINARY(SLOOP2))
"RTN","PSOERX1B",202,0)
 ; if provider, patient or drug is missing, no need to continue.
"RTN","PSOERX1B",203,0)
 ; future consideration - do we need to check more fields?
"RTN","PSOERX1B",204,0)
 I $D(PSOEXMS) D MSGDIR^PSOERXU1(.PSOEXMS) Q
"RTN","PSOERX1B",205,0)
 D ADD
"RTN","PSOERX1B",206,0)
 I $G(PSOEXMS)]"" W !,PSOEXMS S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX1B",207,0)
 K DFN
"RTN","PSOERX1B",208,0)
 Q
"RTN","PSOERX1B",209,0)
ADD ;Add CHCS message to Outpatient Pending Orders file
"RTN","PSOERX1B",210,0)
 N PSOHQ,PSOHQT,PSOCPEND,PSOHINI,PSOHINLO,ERXSTA,ORDNUM,ILOOP,IARY,PSSRET,X
"RTN","PSOERX1B",211,0)
 S (PSOHINI,PSOHINLO)=0 D
"RTN","PSOERX1B",212,0)
 .I $G(PSOHY("LOC")) S PSOHINLO=$P($G(^SC(PSOHY("LOC"),0)),"^",4) I PSOHINLO Q
"RTN","PSOERX1B",213,0)
 .; FUTURE - consider enabling further institution checks. For now the institution is being pulled from either
"RTN","PSOERX1B",214,0)
 .; the institution associated with the hospital location, or below, from the eRx.
"RTN","PSOERX1B",215,0)
 .;I $G(PSOHY("LOC")) S PSOHINI=$P($G(^SC(PSOHY("LOC"),0)),"^",15)
"RTN","PSOERX1B",216,0)
 .;I '$G(PSOHINI) S PSOHINI=$O(^DG(40.8,0))
"RTN","PSOERX1B",217,0)
 .;S PSOHINLO=+$$SITE^VASITE(PSOHINI)
"RTN","PSOERX1B",218,0)
 ; get institution from 52.49 if clinic was not passed in
"RTN","PSOERX1B",219,0)
 I $G(PSOHINLO)<1 S PSOHINLO=$$GET1^DIQ(52.49,PSOIEN,24.1,"I")
"RTN","PSOERX1B",220,0)
 I +$G(PSOHINLO)<1 S PSOEXMS="Unable to derive Institution from Clinic." Q
"RTN","PSOERX1B",221,0)
 K DD,DO,DIC S X=PSOHY("CHNUM"),DIC="^PS(52.41,",DIC(0)="L"
"RTN","PSOERX1B",222,0)
 S:$G(PSOHY("PICK"))="" PSOHY("PICK")="M"
"RTN","PSOERX1B",223,0)
 S DIC("DR")="4////"_$G(PSOHY("ENTER"))_";5////"_PSOHY("PROV")_";6////"_$G(PSOHY("SDT"))_";8////"_PSOHY("ITEM")_";11////"_PSOHY("DRUG")_";12////"_$G(PSOHY("QTY"))_";13////"_$G(PSOHY("REF"))_";101////"_$G(PSOHY("DAYS"))
"RTN","PSOERX1B",224,0)
 D FILE^DICN K DD,DIC,DO I Y<0 S PSOEXMS="Unable to add order to Pending file." Q
"RTN","PSOERX1B",225,0)
 S PSOCPEND=+Y
"RTN","PSOERX1B",226,0)
 S $P(^PS(52.41,PSOCPEND,0),"^",2)=PSOHY("PAT"),$P(^(0),"^",3)=PSOHY("OCC"),$P(^(0),"^",12)=$G(PSOHY("EDT")),$P(^(0),"^",13)=$G(PSOHY("LOC"))
"RTN","PSOERX1B",227,0)
 S $P(^PS(52.41,PSOCPEND,0),"^",14)=$G(PSOHY("PRIOR")),$P(^(0),"^",17)=$G(PSOHY("PICK"))
"RTN","PSOERX1B",228,0)
 S $P(^PS(52.41,PSOCPEND,"EXT"),"^")=PSOHY("CHNUM"),$P(^("EXT"),"^",2)=0,$P(^("EXT"),"^",3)=PSOHY("EXAPP")
"RTN","PSOERX1B",229,0)
 S DIE="^PS(52.41,",DA=PSOCPEND,DR="104.1///1" D ^DIE K DIE,DA,DR
"RTN","PSOERX1B",230,0)
 ; PSO*7*506
"RTN","PSOERX1B",231,0)
 S FDA(52.41,PSOCPEND_",",104)=PATINST D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",232,0)
 N DA,DIK S DA=PSOCPEND,DIK="^PS(52.41,",DIK(1)="114^C" D EN1^DIK
"RTN","PSOERX1B",233,0)
 I $O(PSOHY("PRCOM",0)) D  I PSOHQT S ^PS(52.41,PSOCPEND,3,0)="^^"_PSOHQT_"^"_PSOHQT_"^"_DT_"^"
"RTN","PSOERX1B",234,0)
 .S PSOHQ="",PSOHQT=0 F  S PSOHQ=$O(PSOHY("PRCOM",PSOHQ)) Q:PSOHQ=""  I $G(PSOHY("PRCOM",PSOHQ))'="" S PSOHQT=PSOHQT+1,^PS(52.41,PSOCPEND,3,PSOHQT,0)=$G(PSOHY("PRCOM",PSOHQ))
"RTN","PSOERX1B",235,0)
 I $O(PSOHY("SIG",0)) D  I PSOHQT S ^PS(52.41,PSOCPEND,"SIG",0)="^52.4124A^"_PSOHQT_"^"_PSOHQT
"RTN","PSOERX1B",236,0)
 .S PSOHQ="",PSOHQT=0 F  S PSOHQ=$O(PSOHY("SIG",PSOHQ)) Q:PSOHQ=""  I $G(PSOHY("SIG",PSOHQ))'="" S PSOHQT=PSOHQT+1,^PS(52.41,PSOCPEND,"SIG",PSOHQT,0)=$G(PSOHY("SIG",PSOHQ))
"RTN","PSOERX1B",237,0)
 S $P(^PS(52.41,PSOCPEND,"INI"),"^")=$G(PSOHINLO)
"RTN","PSOERX1B",238,0)
 ; add quantity/timing subfile information
"RTN","PSOERX1B",239,0)
 I $O(PSOHY("QTSUB",0)) D  I PSOHQT S ^PS(52.41,PSOCPEND,1,0)="^52.413^"_PSOHQT_"^"_PSOHQT
"RTN","PSOERX1B",240,0)
 .S PSOHQ="",PSOHQT=0 F  S PSOHQ=$O(PSOHY("QTSUB",PSOHQ)) Q:PSOHQ=""  D
"RTN","PSOERX1B",241,0)
 ..I $O(PSOHY("QTSUB",PSOHQ,0)) S PSOHQT=PSOHQT+1
"RTN","PSOERX1B",242,0)
 ..S ^PS(52.41,PSOCPEND,1,PSOHQT,0)=PSOHY("QTSUB",PSOHQ,0)
"RTN","PSOERX1B",243,0)
 ..S ^PS(52.41,PSOCPEND,1,PSOHQT,1)=PSOHY("QTSUB",PSOHQ,1)
"RTN","PSOERX1B",244,0)
 ..S ^PS(52.41,PSOCPEND,1,PSOHQT,2)=PSOHY("QTSUB",PSOHQ,2)
"RTN","PSOERX1B",245,0)
 I $O(PINARY(0)) D WP^DIE(52.41,PSOCPEND_",",105,"K","PINARY")
"RTN","PSOERX1B",246,0)
 ;Cross references not set yet preventing Pharmacy from finishing order
"RTN","PSOERX1B",247,0)
 D EN^PSOHLSNC(PSOCPEND,"SN","IP")
"RTN","PSOERX1B",248,0)
 D FULL^VALM1
"RTN","PSOERX1B",249,0)
 ;Just set to DC, don't delete because 52.41 entry would be re-used
"RTN","PSOERX1B",250,0)
 ;I '$P($G(^PS(52.41,PSOCPEND,"EXT")),"^",2) S DA=PSOCPEND,DIK="^PS(52.41," D ^DIK K DIK,DA S PSOEXMS="Unable to send CHCS order to CPRS." D NAK^PSOHLEXC Q
"RTN","PSOERX1B",251,0)
 I '$P($G(^PS(52.41,PSOCPEND,"EXT")),"^",2) D  S $P(^PS(52.41,PSOCPEND,0),"^",3)="DC" S PSOEXMS="Unable to send CHCS order to CPRS." Q
"RTN","PSOERX1B",252,0)
 .;x-ref shouldn't be set, but we'll kill them just in case
"RTN","PSOERX1B",253,0)
 .K ^PS(52.41,"AOR",$P(^PS(52.41,PSOCPEND,0),"^",2),+$P($G(^("INI")),"^"),PSOCPEND),^PS(52.41,"AD",$P(^PS(52.41,PSOCPEND,0),"^",12),+$P($G(^("INI")),"^"),PSOCPEND)
"RTN","PSOERX1B",254,0)
 .K ^PS(52.41,"ACL",+$P(^PS(52.41,PSOCPEND,0),"^",13),$P(^(0),"^",12),PSOCPEND),^PS(52.41,"AQ",+$P($G(^PS(52.41,PSOCPEND,0)),"^",21),PSOCPEND)
"RTN","PSOERX1B",255,0)
 .S $P(^PS(52.41,PSOCPEND,4),"^")="External order, unable to successfully transmit to CPRS."
"RTN","PSOERX1B",256,0)
 .W !!,"External order, unable to successfully transmit to CPRS."
"RTN","PSOERX1B",257,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",258,0)
 ;Successful transmission to CPRS
"RTN","PSOERX1B",259,0)
 S DA=PSOCPEND,DIK="^PS(52.41," D IX^DIK
"RTN","PSOERX1B",260,0)
 ; add the pending outpatient order number to 52.49 and update status of eRx to PR (Processed)
"RTN","PSOERX1B",261,0)
 S ERXSTA=$O(^PS(52.45,"C","ERX","PR",0))
"RTN","PSOERX1B",262,0)
 S ORDNUM=$P($G(^PS(52.41,PSOCPEND,0)),U)
"RTN","PSOERX1B",263,0)
 S DIE="^PS(52.49,",DR="25.2///"_PSOCPEND_";.12///"_ORDNUM,DA=PSOIEN D ^DIE K DIE,DA,DR
"RTN","PSOERX1B",264,0)
 ; add activity to status history
"RTN","PSOERX1B",265,0)
 D UPDSTAT^PSOERXU1(PSOIEN,"PR")
"RTN","PSOERX1B",266,0)
 ; gather the unexpanded sig and file in 52.41
"RTN","PSOERX1B",267,0)
 S ILOOP=0 F  S ILOOP=$O(^PS(52.49,PSOIEN,31,ILOOP)) Q:'ILOOP  D
"RTN","PSOERX1B",268,0)
 .S IARY(ILOOP)=$G(^PS(52.49,PSOIEN,31,ILOOP,0))
"RTN","PSOERX1B",269,0)
 I $D(IARY) D WP^DIE(52.41,PSOCPEND_",",9,"K","IARY","IERR")
"RTN","PSOERX1B",270,0)
 W !!,"eRx #"_PSOHY("CHNUM")_" sent to PENDING OUTPATIENT ORDERS!"
"RTN","PSOERX1B",271,0)
 ;PSO*7*520 - add sending and warning/information related to RxVerify Message.
"RTN","PSOERX1B",272,0)
 W !!,"Sending rxVerify Message to prescriber."
"RTN","PSOERX1B",273,0)
 D POST^PSOERXO1(PSOIEN,.PSSRET,,,,1)
"RTN","PSOERX1B",274,0)
 ; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERX1B",275,0)
 I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX1B",276,0)
 I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX1B",277,0)
 ;PSO*7*520 - end rxVerify changes
"RTN","PSOERX1B",278,0)
 Q
"RTN","PSOERX1B",279,0)
 ; remove eRx from holding queue
"RTN","PSOERX1B",280,0)
REM ;
"RTN","PSOERX1B",281,0)
 D REM^PSOERXU4
"RTN","PSOERX1B",282,0)
 Q
"RTN","PSOERX1B",283,0)
 ; reject eRx
"RTN","PSOERX1B",284,0)
REJ ;
"RTN","PSOERX1B",285,0)
 D REJ^PSOERXU4
"RTN","PSOERX1B",286,0)
 Q
"RTN","PSOERX1C")
0^8^B40194088^B40751092
"RTN","PSOERX1C",1,0)
PSOERX1C ;ALB/BWF - eRx Utilities ; 8/3/2016 5:14pm
"RTN","PSOERX1C",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,527**;DEC 1997;Build 30
"RTN","PSOERX1C",3,0)
 ;
"RTN","PSOERX1C",4,0)
 Q
"RTN","PSOERX1C",5,0)
 ; select an item
"RTN","PSOERX1C",6,0)
PRINT(PSOIEN,OP) ;
"RTN","PSOERX1C",7,0)
 N %ZIS,POP
"RTN","PSOERX1C",8,0)
 S OP=$G(OP)
"RTN","PSOERX1C",9,0)
 D FULL^VALM1
"RTN","PSOERX1C",10,0)
 S VALMBCK="R"
"RTN","PSOERX1C",11,0)
 S %ZIS="Q",%ZIS("B")=$G(PSOPROP) D ^%ZIS Q:POP
"RTN","PSOERX1C",12,0)
 ; if queuing, queue it and quit.
"RTN","PSOERX1C",13,0)
 I $D(IO("Q")) D  Q
"RTN","PSOERX1C",14,0)
 .S ZTSAVE("PSOIEN")="",ZTSAVE("OP")=""
"RTN","PSOERX1C",15,0)
 .S ZTRTN="PRINTQ^PSOERX1C(PSOIEN,OP)",ZTDESC="eRx Print" D ^%ZTLOAD
"RTN","PSOERX1C",16,0)
 .K ZTSAVE,ZTRTN
"RTN","PSOERX1C",17,0)
 .D INIT^PSOERX1
"RTN","PSOERX1C",18,0)
 .D TERM^VALM0
"RTN","PSOERX1C",19,0)
 D PRINTQ(PSOIEN,OP)
"RTN","PSOERX1C",20,0)
 D TERM^VALM0
"RTN","PSOERX1C",21,0)
 D INIT^PSOERX1
"RTN","PSOERX1C",22,0)
 Q
"RTN","PSOERX1C",23,0)
 ; fallthrough if no queueing
"RTN","PSOERX1C",24,0)
PRINTQ(PSOIEN,OP) ;
"RTN","PSOERX1C",25,0)
 N %ZIS,POP,RXDAT,PHARIEN,PRVIEN,PATIEN,PHARDAT,PRVDAT,PATDAT,PSOIENS,PHNM,PHAD1,PHAD2,PHCTY
"RTN","PSOERX1C",26,0)
 N PHST,PHZIP,PHNCP,PHTEL,PRFNM,PRLNM,PRMNM,PRAD1,PRAD2,PRCTY,PRST,PRZIP,PRNPI,PRDEA,PRSTL,LTXT
"RTN","PSOERX1C",27,0)
 N PRTEL,PRFAX,PRSUPER,PRAGNT,PTLNM,PTFNM,PTMNM,PTAD1,PTAD2,PTCTY,PTST,PTZIP,PTDOB,PTGEN,PTHPHON,PTPLANID
"RTN","PSOERX1C",28,0)
 N PHARIENS,PATIENS,PRVIENS,PTSSN,PRAGNTFN,PRAGNTMN,PRAGNTLN,TYPE,VALUE,PRFAX,PRTEL,SIEN,REFILL,IENS
"RTN","PSOERX1C",29,0)
 S OP=$G(OP,"")
"RTN","PSOERX1C",30,0)
 S PSOIEN=$G(PSOIEN)
"RTN","PSOERX1C",31,0)
 I '$G(PSOIEN) D
"RTN","PSOERX1C",32,0)
 .I $D(RXOR) S PSOIEN=$$CHKERX^PSOERXU1($P(RXOR,U,2)) Q:PSOIEN
"RTN","PSOERX1C",33,0)
 .I $D(OR0) S PSOIEN=$$CHKERX^PSOERXU1(OR0)
"RTN","PSOERX1C",34,0)
 Q:'$G(PSOIEN)
"RTN","PSOERX1C",35,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1C",36,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","PSOERX1C",37,0)
 U IO
"RTN","PSOERX1C",38,0)
 D GETS^DIQ(52.49,PSOIENS,".04;2.1;2.5","I","RXDAT")
"RTN","PSOERX1C",39,0)
 S PHARIEN=$G(RXDAT(52.49,PSOIENS,2.5,"I")) I PHARIEN S PHARIENS=PHARIEN_","
"RTN","PSOERX1C",40,0)
 S PRVIEN=$G(RXDAT(52.49,PSOIENS,2.1,"I")) I PRVIEN S PRVIENS=PRVIEN_","
"RTN","PSOERX1C",41,0)
 S PATIEN=$G(RXDAT(52.49,PSOIENS,.04,"I")) I PATIEN S PATIENS=PATIEN_","
"RTN","PSOERX1C",42,0)
 D GETS^DIQ(52.47,PHARIENS,"**","E","PHARDAT")
"RTN","PSOERX1C",43,0)
 D GETS^DIQ(52.48,PRVIENS,"**","E","PRVDAT")
"RTN","PSOERX1C",44,0)
 D GETS^DIQ(52.46,PATIENS,"**","E","PATDAT")
"RTN","PSOERX1C",45,0)
 ; pharmacy information
"RTN","PSOERX1C",46,0)
 S PHNM=$G(PHARDAT(52.47,PHARIENS,.05,"E"))
"RTN","PSOERX1C",47,0)
 S PHAD1=$G(PHARDAT(52.47,PHARIENS,1.1,"E"))
"RTN","PSOERX1C",48,0)
 S PHAD2=$G(PHARDAT(52.47,PHARIENS,1.2,"E"))
"RTN","PSOERX1C",49,0)
 S PHCTY=$G(PHARDAT(52.47,PHARIENS,1.3,"E"))
"RTN","PSOERX1C",50,0)
 S PHST=$G(PHARDAT(52.47,PHARIENS,1.4,"E"))
"RTN","PSOERX1C",51,0)
 S PHZIP=$G(PHARDAT(52.47,PHARIENS,1.5,"E"))
"RTN","PSOERX1C",52,0)
 S PHNCP=$G(PHARDAT(52.47,PHARIENS,.02,"E"))
"RTN","PSOERX1C",53,0)
 ; todo - get telephone
"RTN","PSOERX1C",54,0)
 S PHTEL=""
"RTN","PSOERX1C",55,0)
 ; provider information
"RTN","PSOERX1C",56,0)
 S PRFNM=$G(PRVDAT(52.48,PRVIENS,.03,"E"))
"RTN","PSOERX1C",57,0)
 S PRMNM=$G(PRVDAT(52.48,PRVIENS,.04,"E"))
"RTN","PSOERX1C",58,0)
 S PRLNM=$G(PRVDAT(52.48,PRVIENS,.02,"E"))
"RTN","PSOERX1C",59,0)
 S PRAD1=$G(PRVDAT(52.48,PRVIENS,4.1,"E"))
"RTN","PSOERX1C",60,0)
 S PRAD2=$G(PRVDAT(52.48,PRVIENS,4.2,"E"))
"RTN","PSOERX1C",61,0)
 S PRCTY=$G(PRVDAT(52.48,PRVIENS,4.3,"E"))
"RTN","PSOERX1C",62,0)
 S PRST=$G(PRVDAT(52.48,PRVIENS,4.4,"E"))
"RTN","PSOERX1C",63,0)
 S PRZIP=$G(PRVDAT(52.48,PRVIENS,4.5,"E"))
"RTN","PSOERX1C",64,0)
 S PRNPI=$G(PRVDAT(52.48,PRVIENS,1.5,"E"))
"RTN","PSOERX1C",65,0)
 S PRDEA=$G(PRVDAT(52.48,PRVIENS,1.6,"E"))
"RTN","PSOERX1C",66,0)
 S PRSTL=$G(PRVDAT(52.48,PRVIENS,1.8,"E"))
"RTN","PSOERX1C",67,0)
 S PRSUPER=$$GET1^DIQ(52.49,PSOIEN,2.6,"E")
"RTN","PSOERX1C",68,0)
 S PRAGNTFN=$$GET1^DIQ(52.48,PRVIEN,5.2,"E")
"RTN","PSOERX1C",69,0)
 S PRAGNTMN=$$GET1^DIQ(52.48,PRVIEN,5.3,"E")
"RTN","PSOERX1C",70,0)
 S PRAGNTLN=$$GET1^DIQ(52.48,PRVIEN,5.1,"E")
"RTN","PSOERX1C",71,0)
 ;/BLB/ PSO*7.0*520  - BEGIN CHANGE
"RTN","PSOERX1C",72,0)
 S SIEN=0
"RTN","PSOERX1C",73,0)
 F  S SIEN=$O(^PS(52.48,PRVIEN,3,SIEN)) Q:'SIEN  D
"RTN","PSOERX1C",74,0)
 .S IENS=SIEN_","_PRVIEN_","
"RTN","PSOERX1C",75,0)
 .S TYPE=$$GET1^DIQ(52.483,IENS,.02)
"RTN","PSOERX1C",76,0)
 .S VALUE=$$GET1^DIQ(52.483,IENS,.01)
"RTN","PSOERX1C",77,0)
 .I TYPE="FAX" S PRFAX=VALUE
"RTN","PSOERX1C",78,0)
 .I TYPE="TELEPHONE" S PRTEL=VALUE
"RTN","PSOERX1C",79,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",80,0)
 ; patient information
"RTN","PSOERX1C",81,0)
 S PTLNM=$G(PATDAT(52.46,PATIENS,.02,"E"))
"RTN","PSOERX1C",82,0)
 S PTMNM=$G(PATDAT(52.46,PATIENS,.04,"E"))
"RTN","PSOERX1C",83,0)
 S PTFNM=$G(PATDAT(52.46,PATIENS,.03,"E"))
"RTN","PSOERX1C",84,0)
 S PTAD1=$G(PATDAT(52.46,PATIENS,3.1,"E"))
"RTN","PSOERX1C",85,0)
 S PTAD2=$G(PATDAT(52.46,PATIENS,3.2,"E"))
"RTN","PSOERX1C",86,0)
 S PTCTY=$G(PATDAT(52.46,PATIENS,3.3,"E"))
"RTN","PSOERX1C",87,0)
 S PTST=$G(PATDAT(52.46,PATIENS,3.4,"E"))
"RTN","PSOERX1C",88,0)
 S PTZIP=$G(PATDAT(52.46,PATIENS,3.5,"E"))
"RTN","PSOERX1C",89,0)
 S PTDOB=$G(PATDAT(52.46,PATIENS,.08,"E"))
"RTN","PSOERX1C",90,0)
 S PTGEN=$G(PATDAT(52.46,PATIENS,.07,"E"))
"RTN","PSOERX1C",91,0)
 S PTSSN=$G(PATDAT(52.46,PATIENS,1.4,"E"))
"RTN","PSOERX1C",92,0)
 S PTHPHON=""
"RTN","PSOERX1C",93,0)
 S PTPLANID=""
"RTN","PSOERX1C",94,0)
 W !,"*************************PHARMACY INFORMATION****************************"
"RTN","PSOERX1C",95,0)
 W !,$$UP^XLFSTR(PHNM)
"RTN","PSOERX1C",96,0)
 W !,"Address: "_PHAD1
"RTN","PSOERX1C",97,0)
 I $L(PHAD2) W !,"         "_PHAD2
"RTN","PSOERX1C",98,0)
 W !,!,"         "_PHCTY_", "_PHST_" "_PHZIP
"RTN","PSOERX1C",99,0)
 S LTXT=""
"RTN","PSOERX1C",100,0)
 D ADDITEM^PSOERX1A(.LTXT,"Tel: ",PHTEL,1,26)
"RTN","PSOERX1C",101,0)
 D ADDITEM^PSOERX1A(.LTXT,"NCPDP: ",PHNCP,28,26)
"RTN","PSOERX1C",102,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",103,0)
 W !,"******************PRESCRIBER INFORMATION*********************************"
"RTN","PSOERX1C",104,0)
 ; /BLB/ PSO*7.0*520 - CHANGED ORDER OF NAMES TO LAST,FIRST,MIDDLE - BEGIN CHANGE
"RTN","PSOERX1C",105,0)
 W !,"Last: "_PRLNM
"RTN","PSOERX1C",106,0)
 W !,"First: "_PRFNM
"RTN","PSOERX1C",107,0)
 W !,"Mid: "_PRMNM
"RTN","PSOERX1C",108,0)
 ; /BLB/ - END CHANGE
"RTN","PSOERX1C",109,0)
 W !,"Address: "_PRAD1
"RTN","PSOERX1C",110,0)
 I $L(PHAD2) W !,"         "_PRAD2
"RTN","PSOERX1C",111,0)
 W !,"         "_PRCTY_", "_PRST_" "_PRZIP
"RTN","PSOERX1C",112,0)
 S LTXT=""
"RTN","PSOERX1C",113,0)
 ;/BLB/ PSO*7.0*527 - BEGIN CHANGE - MOVE FIELDS TO THEIR OWN LINE
"RTN","PSOERX1C",114,0)
 W !,"NPI: "_PRNPI
"RTN","PSOERX1C",115,0)
 W !,"DEA: "_PRDEA
"RTN","PSOERX1C",116,0)
 W !,"State Lic: "_PRSTL
"RTN","PSOERX1C",117,0)
 ;/BLB/ - PSO*7.0*527 END CHANGE
"RTN","PSOERX1C",118,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",119,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1C",120,0)
 W !,"Tel: "_$G(PRTEL)
"RTN","PSOERX1C",121,0)
 W !,"Fax: "_$G(PRFAX)
"RTN","PSOERX1C",122,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",123,0)
 W !,"Supervisor: "_$G(PRSUPER)
"RTN","PSOERX1C",124,0)
 W !,"Agent Last Name: "_$G(PRAGNTLN)
"RTN","PSOERX1C",125,0)
 W !,"Agent First Name: "_$G(PRAGNTFN)
"RTN","PSOERX1C",126,0)
 W !,"Agent Middle Name: "_$G(PRAGNTMN)
"RTN","PSOERX1C",127,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",128,0)
 W !,"******************PATIENT INFORMATION************************************"
"RTN","PSOERX1C",129,0)
 S LTXT=""
"RTN","PSOERX1C",130,0)
 ;/BLB/PSO*7.0*520 RESTRUCTURED ORDER OF PATIENT NAME - BEGIN CHANGE
"RTN","PSOERX1C",131,0)
 W !,"Last: "_PTLNM
"RTN","PSOERX1C",132,0)
 W !,"First: "_PTFNM
"RTN","PSOERX1C",133,0)
 W !,"Mid: "_PTMNM
"RTN","PSOERX1C",134,0)
 ;/BLB END CHANGE
"RTN","PSOERX1C",135,0)
 W !,LTXT
"RTN","PSOERX1C",136,0)
 S LTXT=""
"RTN","PSOERX1C",137,0)
 D ADDITEM^PSOERX1A(.LTXT,"SSN: ",PTSSN,1,28)
"RTN","PSOERX1C",138,0)
 D ADDITEM^PSOERX1A(.LTXT,"Sex: ",PTGEN,30,20) W !,LTXT S LTXT=""
"RTN","PSOERX1C",139,0)
 W !,"Address: "_PTAD1
"RTN","PSOERX1C",140,0)
 I $L(PTAD2) W !,"         "_PTAD2
"RTN","PSOERX1C",141,0)
 W !,"         "_PTCTY_", "_PTST_" "_PTZIP
"RTN","PSOERX1C",142,0)
 S LTXT=""
"RTN","PSOERX1C",143,0)
 D ADDITEM^PSOERX1A(.LTXT,"DOB: ",PTDOB,1,26)
"RTN","PSOERX1C",144,0)
 D ADDITEM^PSOERX1A(.LTXT,"Home: ",PTHPHON,28,16)
"RTN","PSOERX1C",145,0)
 D ADDITEM^PSOERX1A(.LTXT,"Plan ID: ",PTPLANID,52,27)
"RTN","PSOERX1C",146,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",147,0)
 W !,"******************PRESCRIPTION INFORMATION*******************************"
"RTN","PSOERX1C",148,0)
 W !,"eRx Drug: "_$$GET1^DIQ(52.49,PSOIEN,3.1,"E")
"RTN","PSOERX1C",149,0)
 S LTXT=""
"RTN","PSOERX1C",150,0)
 D ADDITEM^PSOERX1A(.LTXT,"Qty: ",$$GET1^DIQ(52.49,PSOIEN,5.1,"E"),1,26)
"RTN","PSOERX1C",151,0)
 D ADDITEM^PSOERX1A(.LTXT,"Days Supply: ",$$GET1^DIQ(52.49,PSOIEN,5.5,"E"),28,16)
"RTN","PSOERX1C",152,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE - MOVING "Written Date" TO ITS OWN LINE
"RTN","PSOERX1C",153,0)
 ;D ADDITEM^PSOERX1A(.LTXT,"Date Written: ",$$FMTE^XLFDT($$GET1^DIQ(52.49,PSOIEN,5.9,"E"),"2D"),52,27)
"RTN","PSOERX1C",154,0)
 W !,"Date Written: "_$$FMTE^XLFDT($$GET1^DIQ(52.49,PSOIEN,5.9,"E"),"2D")
"RTN","PSOERX1C",155,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",156,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",157,0)
 ;/BLB/PSO*7.0*520 REMOVED ADDITEM CALLS AND MOVED FIELDS TO INDIVIDUAL LINES - BEGIN CHANGE
"RTN","PSOERX1C",158,0)
 W !,"Qty Qualifier: "_$$GET1^DIQ(52.49,PSOIEN,5.2,"E")
"RTN","PSOERX1C",159,0)
 W !,"Drug Form: "_$$GET1^DIQ(52.49,PSOIEN,41,"E")
"RTN","PSOERX1C",160,0)
 W !,"Strength: "_$$GET1^DIQ(52.49,PSOIEN,43,"E")
"RTN","PSOERX1C",161,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",162,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",163,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1C",164,0)
 S REFILL=$$GET1^DIQ(52.49,PSOIEN,5.6,"E")
"RTN","PSOERX1C",165,0)
 I REFILL'="" D
"RTN","PSOERX1C",166,0)
 .W !,"Refills: "_REFILL
"RTN","PSOERX1C",167,0)
 I REFILL="" D
"RTN","PSOERX1C",168,0)
 .S REFILL=$$GET1^DIQ(52.49,PSOIEN,5.7,"I")
"RTN","PSOERX1C",169,0)
 .W !,"Refills: "_REFILL
"RTN","PSOERX1C",170,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",171,0)
 W !,"SIG: "_$$GET1^DIQ(52.49,PSOIEN,7,"E")
"RTN","PSOERX1C",172,0)
 D ADDITEM^PSOERX1A(.LTXT,"eRx Reference #: ",$$GET1^DIQ(52.49,PSOIEN,.01,"E"),1,40)
"RTN","PSOERX1C",173,0)
 D ADDITEM^PSOERX1A(.LTXT,"Message ID: ",$$GET1^DIQ(52.49,PSOIEN,25,"E"),42,35)
"RTN","PSOERX1C",174,0)
 W !!,LTXT S LTXT=""
"RTN","PSOERX1C",175,0)
 W !,"Dispense Notes: "_$$GET1^DIQ(52.49,PSOIEN,5.8,"E")
"RTN","PSOERX1C",176,0)
 W !,"Comments: "_$$GET1^DIQ(52.49,PSOIEN,8,"E")
"RTN","PSOERX1C",177,0)
 W !,"******************END OF eRx*********************************************"
"RTN","PSOERX1C",178,0)
 D:'$D(ZTQUEUED) ^%ZISC
"RTN","PSOERX1C",179,0)
 Q
"RTN","PSOERXH1")
0^9^B17222601^B14280628
"RTN","PSOERXH1",1,0)
PSOERXH1 ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERXH1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,527**;DEC 1997;Build 30
"RTN","PSOERXH1",3,0)
 ;
"RTN","PSOERXH1",4,0)
 Q
"RTN","PSOERXH1",5,0)
 ; place eRx on Hold
"RTN","PSOERXH1",6,0)
HOLD ;
"RTN","PSOERXH1",7,0)
 N DIE,DA,DR,CURSTAT,CSTATI,LMATCH,LSTAT,SUBFIEN,NEWSTAT,RESP,DIR,RXSTAT,HCOMM
"RTN","PSOERXH1",8,0)
 Q:'$G(PSOIEN)
"RTN","PSOERXH1",9,0)
 D FULL^VALM1
"RTN","PSOERXH1",10,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERXH1",11,0)
 .W !!,"Cannot hold a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERXH1",12,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERXH1",13,0)
 ; check to see if the erx order status is a hold status
"RTN","PSOERXH1",14,0)
 S CSTATI=$$GET1^DIQ(52.49,PSOIEN,1,"I")
"RTN","PSOERXH1",15,0)
 S CURSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E")
"RTN","PSOERXH1",16,0)
 S VALMBCK="R"
"RTN","PSOERXH1",17,0)
 I $E(CURSTAT,1)="H" D  Q
"RTN","PSOERXH1",18,0)
 .S DIR(0)="YO",DIR("B")="NO"
"RTN","PSOERXH1",19,0)
 .S DIR("A",1)="This eRx is already in a 'HOLD' status."
"RTN","PSOERXH1",20,0)
 .S DIR("A")="Would you like to change the hold status and comments?"
"RTN","PSOERXH1",21,0)
 .D ^DIR
"RTN","PSOERXH1",22,0)
 .Q:'Y
"RTN","PSOERXH1",23,0)
 .K DIR
"RTN","PSOERXH1",24,0)
 .S RESP=$$HDIR(1)
"RTN","PSOERXH1",25,0)
 .I 'RESP D  Q
"RTN","PSOERXH1",26,0)
 ..W "Hold Reason required. eRx not placed in a 'Hold' status."
"RTN","PSOERXH1",27,0)
 ..S DIR(0)="E" D ^DIR
"RTN","PSOERXH1",28,0)
 .S DIR(0)="52.4919,1",DIR("A")="Additional Comments (Optional)" D ^DIR K DIR
"RTN","PSOERXH1",29,0)
 .I Y="^" W !,"eRx NOT placed on hold." D ^DIR K DIR Q
"RTN","PSOERXH1",30,0)
 .S HCOMM=$G(Y)
"RTN","PSOERXH1",31,0)
 .S DIE="52.49",DR="1///"_RESP,DA=PSOIEN D ^DIE K DIE
"RTN","PSOERXH1",32,0)
 .S SUBFIEN=$$NSTAT(PSOIEN,RESP,HCOMM)
"RTN","PSOERXH1",33,0)
 .K @VALMAR D INIT^PSOERX1
"RTN","PSOERXH1",34,0)
 K Y
"RTN","PSOERXH1",35,0)
 S RESP=$$HDIR()
"RTN","PSOERXH1",36,0)
 I 'RESP D  Q
"RTN","PSOERXH1",37,0)
 .W "Hold Reason required. eRx not placed in a 'Hold' status."
"RTN","PSOERXH1",38,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERXH1",39,0)
 S DIR(0)="52.4919,1",DIR("A")="Additional Comments (Optional)" D ^DIR K DIR
"RTN","PSOERXH1",40,0)
 I Y="^" Q
"RTN","PSOERXH1",41,0)
 S HCOMM=Y
"RTN","PSOERXH1",42,0)
 S DIE="52.49",DR="1///"_RESP,DA=PSOIEN D ^DIE K DIE
"RTN","PSOERXH1",43,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",.01)=$$NOW^XLFDT()
"RTN","PSOERXH1",44,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",.02)=RESP
"RTN","PSOERXH1",45,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",.03)=$G(DUZ)
"RTN","PSOERXH1",46,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",1)=HCOMM
"RTN","PSOERXH1",47,0)
 D UPDATE^DIE(,"FDA","NEWSTAT","ERR") K FDA
"RTN","PSOERXH1",48,0)
 S SUBFIEN=$O(NEWSTAT(0)) Q:'SUBFIEN
"RTN","PSOERXH1",49,0)
 S SUBFIEN=$G(NEWSTAT(SUBFIEN))
"RTN","PSOERXH1",50,0)
 K @VALMAR D INIT^PSOERX1
"RTN","PSOERXH1",51,0)
 Q
"RTN","PSOERXH1",52,0)
NSTAT(IEN,STAT,COMM) ;
"RTN","PSOERXH1",53,0)
 N SUBFIEN
"RTN","PSOERXH1",54,0)
 S FDA(52.4919,"+1,"_IEN_",",.01)=$$NOW^XLFDT()
"RTN","PSOERXH1",55,0)
 S FDA(52.4919,"+1,"_IEN_",",.02)=STAT
"RTN","PSOERXH1",56,0)
 S FDA(52.4919,"+1,"_IEN_",",.03)=$G(DUZ)
"RTN","PSOERXH1",57,0)
 S FDA(52.4919,"+1,"_IEN_",",1)=COMM
"RTN","PSOERXH1",58,0)
 D UPDATE^DIE(,"FDA","NEWSTAT") K FDA
"RTN","PSOERXH1",59,0)
 S SUBFIEN=$O(NEWSTAT(0)) Q:'SUBFIEN
"RTN","PSOERXH1",60,0)
 S SUBFIEN=$G(NEWSTAT(SUBFIEN))
"RTN","PSOERXH1",61,0)
 Q SUBFIEN
"RTN","PSOERXH1",62,0)
HDIR(HTYP) ; 
"RTN","PSOERXH1",63,0)
 N DIR,DIC,Y,X
"RTN","PSOERXH1",64,0)
 ;S DIC="^PS(52.45,",X(1)="ERX",X(2)="H",DIC(0)="EMQ",D="C" D IX^DIC K DIC,D
"RTN","PSOERXH1",65,0)
 S DIC("A")="Select HOLD reason code: "
"RTN","PSOERXH1",66,0)
 S DIC="^PS(52.45,",DIC(0)="AEMQ",DIC("S")="I $D(^PS(52.45,""TYPE"",""ERX"",Y)),$E($P(^PS(52.45,Y,0),U),1)=""H"""
"RTN","PSOERXH1",67,0)
 D ^DIC K DIC
"RTN","PSOERXH1",68,0)
 I Y<1 Q 0
"RTN","PSOERXH1",69,0)
 Q:'+$P(Y,U) 0
"RTN","PSOERXH1",70,0)
 Q $P(Y,U)
"RTN","PSOERXH1",71,0)
 ; remove hold from eRx
"RTN","PSOERXH1",72,0)
UNHOLD ;
"RTN","PSOERXH1",73,0)
 N Y,DIR,DIE,DA,DR,NEWSIEN,RXSTAT,RXSTATI
"RTN","PSOERXH1",74,0)
 D FULL^VALM1
"RTN","PSOERXH1",75,0)
 S VALMBCK="R"
"RTN","PSOERXH1",76,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERXH1",77,0)
 .W !!,"Cannot un-hold a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERXH1",78,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERXH1",79,0)
 W !
"RTN","PSOERXH1",80,0)
 I $E($$GET1^DIQ(52.49,PSOIEN,1,"E"),1)'="H" D  Q
"RTN","PSOERXH1",81,0)
 .W !,"This eRx is not currently on hold. Please use the 'Hold'",!,"function to update the hold status and comments.",!!
"RTN","PSOERXH1",82,0)
 .S DIR(0)="E"
"RTN","PSOERXH1",83,0)
 .D ^DIR
"RTN","PSOERXH1",84,0)
 .K @VALMAR D INIT^PSOERX1
"RTN","PSOERXH1",85,0)
 ;/BLB/ PSO*7.0*527 - BEGIN CHANGE - CHECKING FOR THE WAIT STATUS UPON UNHOLDING AN ERX
"RTN","PSOERXH1",86,0)
 I $$GET1^DIQ(52.49,PSOIEN,1.3,"I"),$$GET1^DIQ(52.49,PSOIEN,1.5,"I"),$$GET1^DIQ(52.49,PSOIEN,1.7,"I") D
"RTN","PSOERXH1",87,0)
 .S RXSTATI=$$PRESOLV^PSOERXA1("W","ERX"),RXSTAT=$$GET1^DIQ(52.45,RXSTATI,.01,"E")
"RTN","PSOERXH1",88,0)
 I '$G(RXSTATI) S RXSTATI=$$PRESOLV^PSOERXA1("I","ERX"),RXSTAT=$$GET1^DIQ(52.45,RXSTATI,.01,"E")
"RTN","PSOERXH1",89,0)
 D UPDSTAT^PSOERXU1(PSOIEN,RXSTAT,"HOLD REMOVED BY "_$$NAME^XUSER(DUZ))
"RTN","PSOERXH1",90,0)
 W !,"eRx removed from hold status, and placed to '"_$$SENTENCE^XLFSTR($$GET1^DIQ(52.45,RXSTATI,.02,"E"))_"'."
"RTN","PSOERXH1",91,0)
 ;/BLB/ PSO*7.0*527 - END CHANGE
"RTN","PSOERXH1",92,0)
 S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXH1",93,0)
 K @VALMAR D INIT^PSOERX1
"RTN","PSOERXH1",94,0)
 Q
"RTN","PSOERXP1")
0^5^B30549693^B27447625
"RTN","PSOERXP1",1,0)
PSOERXP1 ;ALB/BWF - eRx Patient Display/Actions ; 8/3/2016 5:14pm
"RTN","PSOERXP1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,527**;DEC 1997;Build 30
"RTN","PSOERXP1",3,0)
 ;
"RTN","PSOERXP1",4,0)
EN ; -- main entry point for PSO ERX HOLDING QUEUE
"RTN","PSOERXP1",5,0)
 D EN^VALM("PSO ERX PATIENT VALIDATION")
"RTN","PSOERXP1",6,0)
 Q
"RTN","PSOERXP1",7,0)
 ;
"RTN","PSOERXP1",8,0)
HDR ; -- header code
"RTN","PSOERXP1",9,0)
 S VALMHDR(1)="eRx Patient: "_$$GET1^DIQ(52.49,PSOIEN,.04,"E")
"RTN","PSOERXP1",10,0)
 S VALMHDR(2)="eRx Reference #: "_$$GET1^DIQ(52.49,PSOIEN,.01,"E")
"RTN","PSOERXP1",11,0)
 I $G(VALMBCK)="R" K @VALMAR D INIT S VALMBCK=""
"RTN","PSOERXP1",12,0)
 Q
"RTN","PSOERXP1",13,0)
 ;
"RTN","PSOERXP1",14,0)
INIT ;
"RTN","PSOERXP1",15,0)
 Q:'$G(PSOIEN)
"RTN","PSOERXP1",16,0)
 N LINE,PATDAT,EXPIEN,EXPIENS,EXPNM,EXPDOB,EXPSSN,EXPADD,EXPGEN,EXPCTY,EXPST,EXPZIP,HFIEN,EXPHPH,CPIEN,EXPCPH,LINETXT
"RTN","PSOERXP1",17,0)
 N MANVAL,VAPATIEN,SEPLN,COMM,COMLINE,DONE,TEXT,VAEL,VAELIEN,VAELIG,VAELNM,WORD,VALBY,VALDTTM
"RTN","PSOERXP1",18,0)
 S LINE=0,LINETXT=""
"RTN","PSOERXP1",19,0)
 S EXPIEN=$$GET1^DIQ(52.49,PSOIEN,.04,"I")
"RTN","PSOERXP1",20,0)
 S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.13,"I")
"RTN","PSOERXP1",21,0)
 S EXPIENS=EXPIEN_","
"RTN","PSOERXP1",22,0)
 D GETS^DIQ(52.46,EXPIENS,"**","E","PATDAT")
"RTN","PSOERXP1",23,0)
 S EXPNM=$G(PATDAT(52.46,EXPIENS,.01,"E"))
"RTN","PSOERXP1",24,0)
 S EXPDOB=$G(PATDAT(52.46,EXPIENS,.08,"E"))
"RTN","PSOERXP1",25,0)
 S EXPSSN=$G(PATDAT(52.46,EXPIENS,1.4,"E"))
"RTN","PSOERXP1",26,0)
 ;/BLB/ PSO*7.0*527 - BEGIN CHANGE - CORRECTING SSN FORMAT
"RTN","PSOERXP1",27,0)
 I EXPSSN D
"RTN","PSOERXP1",28,0)
 .I EXPSSN'["-" S EXPSSN=$E(EXPSSN,1,3)_"-"_$E(EXPSSN,4,5)_"-"_$E(EXPSSN,6,9)
"RTN","PSOERXP1",29,0)
 ;/BLB/ PSO*7.0*527 - END CHANGE
"RTN","PSOERXP1",30,0)
 S EXPADD=$G(PATDAT(52.46,EXPIENS,3.1,"E"))
"RTN","PSOERXP1",31,0)
 S EXPGEN=$G(PATDAT(52.46,EXPIENS,.07,"E"))
"RTN","PSOERXP1",32,0)
 S EXPCTY=$G(PATDAT(52.46,EXPIENS,3.3,"E"))
"RTN","PSOERXP1",33,0)
 S EXPST=$G(PATDAT(52.46,EXPIENS,3.4,"E"))
"RTN","PSOERXP1",34,0)
 S EXPZIP=$G(PATDAT(52.46,EXPIENS,3.5,"E")),EXPZIP=$E(EXPZIP,1,5)
"RTN","PSOERXP1",35,0)
 S HFIEN=$O(^PS(52.46,EXPIEN,3,"C","HP",0))
"RTN","PSOERXP1",36,0)
 ; home phone
"RTN","PSOERXP1",37,0)
 S EXPHPH=$$GET1^DIQ(52.462,HFIEN_","_EXPIENS,.01,"E")
"RTN","PSOERXP1",38,0)
 ; cellular phone
"RTN","PSOERXP1",39,0)
 S CPIEN=$O(^PS(52.46,EXPIEN,3,"C","CP",0))
"RTN","PSOERXP1",40,0)
 S EXPCPH=$$GET1^DIQ(52.462,CPIEN_","_EXPIENS,.01,"E")
"RTN","PSOERXP1",41,0)
 S LINE=LINE+1,LINETXT=""
"RTN","PSOERXP1",42,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXP1",43,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Patient: ",$E(EXPNM,1,39),1,52)
"RTN","PSOERXP1",44,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",EXPDOB,55,72)
"RTN","PSOERXP1",45,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",46,0)
 I $L(EXPNM)>39 D
"RTN","PSOERXP1",47,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"             "_$E(EXPNM,40,78))
"RTN","PSOERXP1",48,0)
 I $L(EXPNM)>78 D
"RTN","PSOERXP1",49,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"             "_$E(EXPNM,79,135))
"RTN","PSOERXP1",50,0)
 S LINE=LINE+1
"RTN","PSOERXP1",51,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",52,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXP1",53,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Sex: ",EXPGEN,1,15)
"RTN","PSOERXP1",54,0)
 D ADDITEM^PSOERX1A(.LINETXT,"SSN: ",EXPSSN,55,65)
"RTN","PSOERXP1",55,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",56,0)
 S LINE=LINE+1
"RTN","PSOERXP1",57,0)
 ;/BLB/ PSO*7.0*527 - BEGIN CHANGE - CORRECTING FORMAT OF STATE/OTHER FIELDS THAT LACK CONTINUITY
"RTN","PSOERXP1",58,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Addr: ",$E(EXPADD,1,40),1,50)
"RTN","PSOERXP1",59,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",60,0)
 S LINE=LINE+1
"RTN","PSOERXP1",61,0)
 ;/BLB/ PSO*7.0*520 MOVED CITY TO ITS OWN LINE - BEGIN CHANGE
"RTN","PSOERXP1",62,0)
 D ADDITEM^PSOERX1A(.LINETXT,"City: ",$E(EXPCTY,1,35),1,45)
"RTN","PSOERXP1",63,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",64,0)
 S LINE=LINE+1
"RTN","PSOERXP1",65,0)
 D ADDITEM^PSOERX1A(.LINETXT,"St: ",$E(EXPST,1,35),1,45)
"RTN","PSOERXP1",66,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Zip: ",EXPZIP,55,75)
"RTN","PSOERXP1",67,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXP1",68,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",69,0)
 S LINE=LINE+1
"RTN","PSOERXP1",70,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Home Phone: ",EXPHPH,1,25)
"RTN","PSOERXP1",71,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Cell Phone: ",EXPCPH,55,75)
"RTN","PSOERXP1",72,0)
 ;/BLB/ PSO*7.0*527 - END CHANGE
"RTN","PSOERXP1",73,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",74,0)
 S COMM=$$GET1^DIQ(52.49,PSOIEN,8,"E"),COMM="Comments: "_COMM
"RTN","PSOERXP1",75,0)
 S COMLINE="",DONE=0
"RTN","PSOERXP1",76,0)
 I $L(COMM)<80!$L(COMM)=80 D SET^VALM10(LINE,COMM)
"RTN","PSOERXP1",77,0)
 I $L(COMM)>80 D
"RTN","PSOERXP1",78,0)
 .F WORD=1:1:$L(COMM," ") D
"RTN","PSOERXP1",79,0)
 ..S TEXT=$P(COMM," ",WORD)
"RTN","PSOERXP1",80,0)
 ..; if the text is to long, quit
"RTN","PSOERXP1",81,0)
 ..I $L(COMLINE)+$L(TEXT)>80 D  Q
"RTN","PSOERXP1",82,0)
 ...S LINE=LINE+1 D SET^VALM10(LINE,COMLINE)
"RTN","PSOERXP1",83,0)
 ...S COMLINE=TEXT
"RTN","PSOERXP1",84,0)
 ..I '$L(COMLINE) S COMLINE=TEXT Q
"RTN","PSOERXP1",85,0)
 ..S COMLINE=$G(COMLINE)_" "_TEXT
"RTN","PSOERXP1",86,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXP1",87,0)
 ;S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXP1",88,0)
 S $P(SEPLN,"-",80)="-" D SET^VALM10(LINE,SEPLN)
"RTN","PSOERXP1",89,0)
 ; vista patient information
"RTN","PSOERXP1",90,0)
 S VAPATIEN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXP1",91,0)
 I VAPATIEN D
"RTN","PSOERXP1",92,0)
 .S DFN=VAPATIEN D DEM^VADPT,ADD^VADPT,ELIG^VADPT
"RTN","PSOERXP1",93,0)
 .S VAELIG=$G(VAEL(1)),VAELIEN=$P(VAELIG,U),VAELNM=$P(VAELIG,U,2)
"RTN","PSOERXP1",94,0)
 S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.7,"I")
"RTN","PSOERXP1",95,0)
 S VALBY=$$GET1^DIQ(52.49,PSOIEN,1.13,"E")
"RTN","PSOERXP1",96,0)
 S VALDTTM=$$GET1^DIQ(52.49,PSOIEN,1.14,"E")
"RTN","PSOERXP1",97,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Status: "_$S(MANVAL:"VALIDATED ("_VALBY_" - "_VALDTTM_")",1:"NOT VALIDATED"))
"RTN","PSOERXP1",98,0)
 ;/BLB/ PSO*7.0*527 - BEGIN CHANGE - REPLACING BLANK LINES WITH ALLERGY FIELDS
"RTN","PSOERXP1",99,0)
 I 'VAPATIEN D
"RTN","PSOERXP1",100,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"PATIENT NOT MATCHED")
"RTN","PSOERXP1",101,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Allergies:")
"RTN","PSOERXP1",102,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Adverse Reactions:")
"RTN","PSOERXP1",103,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXP1",104,0)
 I VAPATIEN D
"RTN","PSOERXP1",105,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",106,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Vista Patient: ",$G(VADM(1)),1,53)
"RTN","PSOERXP1",107,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",$P($G(VADM(3)),U,2),55,20)
"RTN","PSOERXP1",108,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",109,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",110,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Sex: ",$P($G(VADM(5)),U,2),1,20)
"RTN","PSOERXP1",111,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"SSN: ",$P($G(VADM(2)),U,2),55,20)
"RTN","PSOERXP1",112,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",113,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",114,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Addr: ",$P($G(VAPA(1)),U),1,70)
"RTN","PSOERXP1",115,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",116,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",117,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"City: ",$P($G(VAPA(4)),U),1,25)
"RTN","PSOERXP1",118,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",119,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",120,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"St: ",$P(VAPA(5),U,2),1,20)
"RTN","PSOERXP1",121,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Zip: ",$P($G(VAPA(6)),U),55,10)
"RTN","PSOERXP1",122,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",123,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",124,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Home Phone: ",$P($G(VAPA(8)),U),1,25)
"RTN","PSOERXP1",125,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Cell Phone: ",$$GET1^DIQ(2,VAPATIEN,.134,"E"),55,80)
"RTN","PSOERXP1",126,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",127,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXP1",128,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Eligibility: "_$G(VAELNM))
"RTN","PSOERXP1",129,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Pharmacy Narrative: "_$$GET1^DIQ(55,VAPATIEN,1,"E"))
"RTN","PSOERXP1",130,0)
 .I $$GET1^DIQ(52.49,PSOIEN,.05,"I") D
"RTN","PSOERXP1",131,0)
 ..D ALG^PSOERXU1(.LINE)
"RTN","PSOERXP1",132,0)
 S VALMCNT=LINE
"RTN","PSOERXP1",133,0)
 S EDTYP="P"
"RTN","PSOERXP1",134,0)
 K VAPA,VADM,DFN,VA
"RTN","PSOERXP1",135,0)
 Q
"RTN","PSOERXP1",136,0)
HELP ; -- help code
"RTN","PSOERXP1",137,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERXP1",138,0)
 Q
"RTN","PSOERXP1",139,0)
 ;
"RTN","PSOERXP1",140,0)
EXIT ; -- exit code
"RTN","PSOERXP1",141,0)
 K EDTYP,@VALMAR
"RTN","PSOERXP1",142,0)
 Q
"RTN","PSOERXP1",143,0)
 ;
"RTN","PSOERXP1",144,0)
EXPND ; -- expand code
"RTN","PSOERXP1",145,0)
 Q
"RTN","PSOERXR1")
0^6^B33604868^B31327096
"RTN","PSOERXR1",1,0)
PSOERXR1 ;ALB/BWF - eRx Provider Display/actions ; 8/3/2016 5:14pm
"RTN","PSOERXR1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,527**;DEC 1997;Build 30
"RTN","PSOERXR1",3,0)
 ;
"RTN","PSOERXR1",4,0)
EN ; -- main entry point for PSO ERX HOLDING QUEUE
"RTN","PSOERXR1",5,0)
 D EN^VALM("PSO ERX PROVIDER VALIDATION")
"RTN","PSOERXR1",6,0)
 Q
"RTN","PSOERXR1",7,0)
 ;
"RTN","PSOERXR1",8,0)
HDR ; -- header code
"RTN","PSOERXR1",9,0)
 ;S VALMHDR(1)="eRx Processing"
"RTN","PSOERXR1",10,0)
 S VALMHDR(1)="eRx Patient: "_$$GET1^DIQ(52.49,PSOIEN,.04,"E")
"RTN","PSOERXR1",11,0)
 S VALMHDR(2)="eRx Reference #: "_$$GET1^DIQ(52.49,PSOIEN,.01,"E")
"RTN","PSOERXR1",12,0)
 I $G(VALMBCK)="R" D INIT
"RTN","PSOERXR1",13,0)
 Q
"RTN","PSOERXR1",14,0)
 ;
"RTN","PSOERXR1",15,0)
INIT ;
"RTN","PSOERXR1",16,0)
 Q:'$G(PSOIEN)
"RTN","PSOERXR1",17,0)
 N LINE,PARVDAT,EXPIEN,EXPIENS,EXPNM,EXPDOB,EXPSSN,EXPADD,EXPGEN,EXPCTY,EXPST,EXPZIP,HFIEN,EXPHPH,CPIEN,EXPCPH,LINETXT
"RTN","PSOERXR1",18,0)
 N EXPADD1,EXPADD2,EXPAGNT,EXPDEA,EXPFN,EXPLIC,EXPNPI,EXPSUPER,EXPWPH,FNIEN,MANVAL,PRVDAT,VAPADD1,VAPADD2,VAPCIT,DEAEXP
"RTN","PSOERXR1",19,0)
 N VAPDEA,VAPFAX,VAPIENS,VAPLIC,VAPNM,VAPNPI,VAPROV,VAPRVIEN,VAPST,VAPTEL,VAPZIP,WPIEN,SEPLN,VAPDEAEX,VALBY,VALDTTM,NFIRST
"RTN","PSOERXR1",20,0)
 N NLOOP,AGENTARY,TLOOP,TFIRST,SUPERARY,SIEN,TYPE,VALUE,PRFAX,PRTEL,IENS
"RTN","PSOERXR1",21,0)
 S LINE=0,LINETXT=""
"RTN","PSOERXR1",22,0)
 S EXPIEN=$$GET1^DIQ(52.49,PSOIEN,2.1,"I")
"RTN","PSOERXR1",23,0)
 S EXPIENS=EXPIEN_","
"RTN","PSOERXR1",24,0)
 D GETS^DIQ(52.48,EXPIENS,"**","E","PRVDAT")
"RTN","PSOERXR1",25,0)
 S EXPNM=$G(PRVDAT(52.48,EXPIENS,.01,"E"))
"RTN","PSOERXR1",26,0)
 S EXPNPI=$G(PRVDAT(52.48,EXPIENS,1.5,"E"))
"RTN","PSOERXR1",27,0)
 S EXPDEA=$G(PRVDAT(52.48,EXPIENS,1.6,"E"))
"RTN","PSOERXR1",28,0)
 S EXPLIC=$G(PRVDAT(52.48,EXPIENS,1.8,"E"))
"RTN","PSOERXR1",29,0)
 S EXPAGNT=$G(PRVDAT(52.48,EXPIENS,5.1,"E")) I $L(EXPAGNT) S EXPAGNT=EXPAGNT_", "_$G(PRVDAT(52.48,EXPIENS,5.2,"E"))_" "_$G(PRVDAT(52.48,EXPIENS,5.3,"E"))
"RTN","PSOERXR1",30,0)
 S EXPSUPER=$$GET1^DIQ(52.49,PSOIEN,2.6,"E")
"RTN","PSOERXR1",31,0)
 S EXPADD1=$G(PRVDAT(52.48,EXPIENS,4.1,"E"))
"RTN","PSOERXR1",32,0)
 S EXPADD2=$G(PRVDAT(52.48,EXPIENS,4.2,"E"))
"RTN","PSOERXR1",33,0)
 S EXPCTY=$G(PRVDAT(52.48,EXPIENS,4.3,"E"))
"RTN","PSOERXR1",34,0)
 S EXPST=$G(PRVDAT(52.48,EXPIENS,4.4,"E"))
"RTN","PSOERXR1",35,0)
 S EXPZIP=$G(PRVDAT(52.48,EXPIENS,4.5,"E")),EXPZIP=$E(EXPZIP,1,5)
"RTN","PSOERXR1",36,0)
 S WPIEN=$O(^PS(52.48,EXPIEN,3,"C","WP",0))
"RTN","PSOERXR1",37,0)
 ; home phone
"RTN","PSOERXR1",38,0)
 ; fax number
"RTN","PSOERXR1",39,0)
 S SIEN=0
"RTN","PSOERXR1",40,0)
 F  S SIEN=$O(^PS(52.48,EXPIEN,3,SIEN)) Q:'SIEN  D
"RTN","PSOERXR1",41,0)
 .S IENS=SIEN_","_EXPIEN_","
"RTN","PSOERXR1",42,0)
 .S TYPE=$$GET1^DIQ(52.483,IENS,.02)
"RTN","PSOERXR1",43,0)
 .S VALUE=$$GET1^DIQ(52.483,IENS,.01)
"RTN","PSOERXR1",44,0)
 .I TYPE="FAX" S PRFAX=VALUE
"RTN","PSOERXR1",45,0)
 .I TYPE="TELEPHONE" S PRTEL=VALUE
"RTN","PSOERXR1",46,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"eRx Provider: "_$E(EXPNM,1,50))
"RTN","PSOERXR1",47,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Address: "_$E(EXPADD1,1,50))
"RTN","PSOERXR1",48,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"         "_$E(EXPADD2,1,50))
"RTN","PSOERXR1",49,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"         "_EXPCTY_", "_EXPST_" "_EXPZIP)
"RTN","PSOERXR1",50,0)
 S LINE=LINE+1
"RTN","PSOERXR1",51,0)
 ;/BLB/ PSO*7.0*520 moved NPI and DEA to own line - BEGIN CHANGE
"RTN","PSOERXR1",52,0)
 D ADDITEM^PSOERX1A(.LINETXT,"NPI: ",EXPNPI,1,40)
"RTN","PSOERXR1",53,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXR1",54,0)
 S LINE=LINE+1
"RTN","PSOERXR1",55,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DEA: ",EXPDEA,1,40)
"RTN","PSOERXR1",56,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXR1",57,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXR1",58,0)
 S LINE=LINE+1
"RTN","PSOERXR1",59,0)
 D ADDITEM^PSOERX1A(.LINETXT,"State Lic: ",EXPLIC,1,46)
"RTN","PSOERXR1",60,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXR1",61,0)
 S LINE=LINE+1
"RTN","PSOERXR1",62,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Tel: ",$G(PRTEL),1,26)
"RTN","PSOERXR1",63,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Fax: ",$G(PRFAX),28,26)
"RTN","PSOERXR1",64,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXR1",65,0)
 ;/BLB/ PSO*7.0*520 MOVED AGENT/SUPERVISOR TO OWN LINE - BEGIN CHANGE
"RTN","PSOERXR1",66,0)
 S LINE=LINE+1
"RTN","PSOERXR1",67,0)
 ;/BLB/ PSO*7.0*527 - BEGIN CHANGE - REMOVE BLANK LINES FROM AGENT/SUPERVISOR
"RTN","PSOERXR1",68,0)
 I $L($G(EXPAGNT)) D
"RTN","PSOERXR1",69,0)
 .D TXT2ARY^PSOERXD1(.AGENTARY,EXPAGNT,,65)
"RTN","PSOERXR1",70,0)
 .S NFIRST=$O(AGENTARY(0))
"RTN","PSOERXR1",71,0)
 .S NLOOP=0 F  S NLOOP=$O(AGENTARY(NLOOP)) Q:'NLOOP  D
"RTN","PSOERXR1",72,0)
 ..S LINE=LINE+1 D SET^VALM10(LINE,$S(NLOOP=NFIRST:"Agent: ",1:" ")_$G(AGENTARY(NLOOP)))
"RTN","PSOERXR1",73,0)
 .S LINE=LINE+1
"RTN","PSOERXR1",74,0)
 I $L($G(EXPSUPER)) D
"RTN","PSOERXR1",75,0)
 .D TXT2ARY^PSOERXD1(.SUPERARY,EXPSUPER,,65)
"RTN","PSOERXR1",76,0)
 .S TFIRST=$O(SUPERARY(0))
"RTN","PSOERXR1",77,0)
 .S TLOOP=0 F  S TLOOP=$O(SUPERARY(TLOOP)) Q:'TLOOP  D
"RTN","PSOERXR1",78,0)
 ..S LINE=LINE+1 D SET^VALM10(LINE,$S(TLOOP=TFIRST:"Supervisor: ",1:" ")_$G(SUPERARY(TLOOP)))
"RTN","PSOERXR1",79,0)
 .S LINE=LINE+1
"RTN","PSOERXR1",80,0)
 I '$L($G(EXPAGNT)) D
"RTN","PSOERXR1",81,0)
 .S LINE=LINE+1
"RTN","PSOERXR1",82,0)
 .D SET^VALM10(LINE,"Agent: ")
"RTN","PSOERXR1",83,0)
 I '$L($G(EXPSUPER)) D
"RTN","PSOERXR1",84,0)
 .S LINE=LINE+1
"RTN","PSOERXR1",85,0)
 .D SET^VALM10(LINE,"Supervisor: ")
"RTN","PSOERXR1",86,0)
 ;/BLB/ - END CHANGE *527
"RTN","PSOERXR1",87,0)
 S LINE=LINE+1
"RTN","PSOERXR1",88,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXR1",89,0)
 S $P(SEPLN,"-",80)="-" D SET^VALM10(LINE,SEPLN)
"RTN","PSOERXR1",90,0)
 ; vista patient information
"RTN","PSOERXR1",91,0)
 S VAPRVIEN=$$GET1^DIQ(52.49,PSOIEN,2.3,"I")
"RTN","PSOERXR1",92,0)
 ; INITIALIZE variables
"RTN","PSOERXR1",93,0)
 S (VAPNM,VAPADD1,VAPADD2,VAPCIT,VAPST,VAPZIP,VAPNPI,VAPDEA,VAPLIC,VAPTEL,VAPFAX)=""
"RTN","PSOERXR1",94,0)
 S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.3,"I")
"RTN","PSOERXR1",95,0)
 S VALBY=$$GET1^DIQ(52.49,PSOIEN,1.8,"E")
"RTN","PSOERXR1",96,0)
 S VALDTTM=$$GET1^DIQ(52.49,PSOIEN,1.9,"E")
"RTN","PSOERXR1",97,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Status: "_$S(MANVAL:"VALIDATED ("_VALBY_" - "_VALDTTM_")",1:"NOT VALIDATED"))
"RTN","PSOERXR1",98,0)
 I 'VAPRVIEN S LINE=LINE+1 D SET^VALM10(LINE,"PROVIDER NOT MATCHED")
"RTN","PSOERXR1",99,0)
 I VAPRVIEN D
"RTN","PSOERXR1",100,0)
 .S VAPIENS=VAPRVIEN_","
"RTN","PSOERXR1",101,0)
 .; 41.99 - NPI, 53.2 - DEA, 54.2 - STATE LICENSING DEA NUMBER, .132 - OFFICE PHONE, .136 - FAX
"RTN","PSOERXR1",102,0)
 .D GETS^DIQ(200,VAPIENS_",",".01;.111;.112;.113;.114;.115;.116;.132;.136;41.99;53.2;54.2","IE","VAPROV")
"RTN","PSOERXR1",103,0)
 .S VAPNM=$G(VAPROV(200,VAPIENS,.01,"E"))
"RTN","PSOERXR1",104,0)
 .S VAPADD1=$G(VAPROV(200,VAPIENS,.111,"E"))
"RTN","PSOERXR1",105,0)
 .S VAPADD2=$G(VAPROV(200,VAPIENS,.112,"E"))
"RTN","PSOERXR1",106,0)
 .S VAPCIT=$G(VAPROV(200,VAPIENS,.114,"E"))
"RTN","PSOERXR1",107,0)
 .S VAPST=$G(VAPROV(200,VAPIENS,.115,"E"))
"RTN","PSOERXR1",108,0)
 .S VAPZIP=$G(VAPROV(200,VAPIENS,.116,"E"))
"RTN","PSOERXR1",109,0)
 .S VAPNPI=$G(VAPROV(200,VAPIENS,41.99,"E"))
"RTN","PSOERXR1",110,0)
 .S VAPDEA=$G(VAPROV(200,VAPIENS,53.2,"E"))
"RTN","PSOERXR1",111,0)
 .S VAPDEAEX=$$GET1^DIQ(200,VAPIENS,747.44,"I") I VAPDEAEX,VAPDEAEX<DT S DEAEXP=1
"RTN","PSOERXR1",112,0)
 .S VAPLIC=$G(VAPROV(200,VAPIENS,54.2,"E"))
"RTN","PSOERXR1",113,0)
 .S VAPTEL=$G(VAPROV(200,VAPIENS,.132,"E"))
"RTN","PSOERXR1",114,0)
 .S VAPFAX=$G(VAPROV(200,VAPIENS,.136,"E"))
"RTN","PSOERXR1",115,0)
 .S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.3,"I")
"RTN","PSOERXR1",116,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Vista Provider: "_VAPNM)
"RTN","PSOERXR1",117,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Address: "_$S($L(VAPADD1):VAPADD1,1:"No street address on file."))
"RTN","PSOERXR1",118,0)
 .I $L(VAPADD2) S LINE=LINE+1 D SET^VALM10(LINE,"         "_VAPADD2)
"RTN","PSOERXR1",119,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"         "_VAPCIT_", "_VAPST_" "_VAPZIP)
"RTN","PSOERXR1",120,0)
 .S LINE=LINE+1
"RTN","PSOERXR1",121,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"NPI: ",VAPNPI,1,26)
"RTN","PSOERXR1",122,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"DEA: ",VAPDEA_$S($G(DEAEXP):" (Expired)",1:""),28,26)
"RTN","PSOERXR1",123,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXR1",124,0)
 .S LINE=LINE+1
"RTN","PSOERXR1",125,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Tel: ",VAPTEL,1,26)
"RTN","PSOERXR1",126,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Fax: ",VAPFAX,28,26)
"RTN","PSOERXR1",127,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXR1",128,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXR1",129,0)
 S VALMCNT=LINE
"RTN","PSOERXR1",130,0)
 S EDTYP="PR"
"RTN","PSOERXR1",131,0)
 Q
"RTN","PSOERXR1",132,0)
HELP ; -- help code
"RTN","PSOERXR1",133,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERXR1",134,0)
 Q
"RTN","PSOERXR1",135,0)
 ;
"RTN","PSOERXR1",136,0)
EXIT ; -- exit code
"RTN","PSOERXR1",137,0)
 K EDTYP,@VALMAR
"RTN","PSOERXR1",138,0)
 Q
"RTN","PSOERXR1",139,0)
 ;
"RTN","PSOERXR1",140,0)
EXPND ; -- expand code
"RTN","PSOERXR1",141,0)
 Q
"RTN","PSOERXX1")
0^7^B47206629^B45537071
"RTN","PSOERXX1",1,0)
PSOERXX1 ;ALB/BWF - eRx xml utilities ; 8/3/2016 5:14pm
"RTN","PSOERXX1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,527**;DEC 1997;Build 30
"RTN","PSOERXX1",3,0)
 ;
"RTN","PSOERXX1",4,0)
 Q
"RTN","PSOERXX1",5,0)
 ; PSOIEN - ien from 52.49 (erx holding queue)
"RTN","PSOERXX1",6,0)
 ; PSOSITE - site ien from the outpatient site file (59)
"RTN","PSOERXX1",7,0)
 ; REFILL REQUEST VIA THE ERX HOLDING QUEUE
"RTN","PSOERXX1",8,0)
RREQHQ(PSOIEN,PSOSITE) ;
"RTN","PSOERXX1",9,0)
 ;/BLB/ PSO*7.0*527 BEGIN CHANGE - BLOCK RR
"RTN","PSOERXX1",10,0)
 W !,"Renewal Request is not available at this time"
"RTN","PSOERXX1",11,0)
 D DIRE Q
"RTN","PSOERXX1",12,0)
 ;/BLB/ PSO*7.0*527 - END CHANGE
"RTN","PSOERXX1",13,0)
 N ORNUM,RXIEN,PSSOUT,GBL,REFL,I,EXDT,PEND,PSSRET,CNT,DIR,Y
"RTN","PSOERXX1",14,0)
 S VALMBCK="R"
"RTN","PSOERXX1",15,0)
 Q:'PSOIEN
"RTN","PSOERXX1",16,0)
 D FULL^VALM1
"RTN","PSOERXX1",17,0)
 S ORNUM=$$GET1^DIQ(52.49,PSOIEN,.12,"I") I 'ORNUM W !!,"No OE/RR order number. Cannot create renewal request." D DIRE Q
"RTN","PSOERXX1",18,0)
 S PEND=$O(^PS(52.41,"B",ORNUM,0))
"RTN","PSOERXX1",19,0)
 S RXIEN=$O(^PSRX("APL",ORNUM,0))
"RTN","PSOERXX1",20,0)
 I PEND,'RXIEN W !!,"RX appears to be in Pending Outpatient Orders, but not yet processed to",!,"backdoor orders." D DIRE Q
"RTN","PSOERXX1",21,0)
 I 'PEND,'RXIEN W !!,"Cannot resolve RX#. Please ensure the prescription is in the prescription file."  D DIRE Q
"RTN","PSOERXX1",22,0)
 ;/BLB/ PSO*7.0*520 - correct typo in the word "prescription" - BEGIN CHANGE
"RTN","PSOERXX1",23,0)
 S EXDT=$$GET1^DIQ(52,RXIEN,26,"I") I EXDT<DT W !!,"Medication has expired, cannot renew prescription." D DIRE Q
"RTN","PSOERXX1",24,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXX1",25,0)
 S REFL=$$GET1^DIQ(52,RXIEN,9,"I"),I=0 F  S I=$O(^PSRX(RXIEN,1,I)) Q:'I  S REFL=REFL-1
"RTN","PSOERXX1",26,0)
 ; When renewal/refill request is being used, re-activate the following line of code
"RTN","PSOERXX1",27,0)
 ;I REFL>0 W !!,"Refills remaining for this prescription. Cannot create refill request." D DIRE Q
"RTN","PSOERXX1",28,0)
 W !!,"Would you like to send a refill (renewal) request to the prescriber"
"RTN","PSOERXX1",29,0)
 S DIR(0)="YO" D ^DIR
"RTN","PSOERXX1",30,0)
 I Y<1 Q
"RTN","PSOERXX1",31,0)
 S GBL=$$RREQ(PSOIEN,RXIEN,ORNUM,PSOSITE) I '$O(@GBL@(0)) W !!,"Could not create outgoing renewal message structure." D DIRE Q
"RTN","PSOERXX1",32,0)
 S PSSRET=$$RESTPOST^PSOERXO1(.PSSRET,.GBL)
"RTN","PSOERXX1",33,0)
 ; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERXX1",34,0)
 I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",35,0)
 I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",36,0)
 W !!,"Renewal Request sent." S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXX1",37,0)
 K @GBL
"RTN","PSOERXX1",38,0)
 Q
"RTN","PSOERXX1",39,0)
 ; CHANGE REQUEST VIA ERX HOLDING QUEUE
"RTN","PSOERXX1",40,0)
CREQHQ(PSOIEN) ;
"RTN","PSOERXX1",41,0)
 N ORNUM,RXIEN,DRUG,GBL,DROK,PSSRET,CNT
"RTN","PSOERXX1",42,0)
 Q:'PSOIEN
"RTN","PSOERXX1",43,0)
 ; IF THIS HASN'T BEEN SENT TO THE PRESCRIPTION FILE, WE DONT NEED ORDER OR RXIEN
"RTN","PSOERXX1",44,0)
 S ORNUM=$$GET1^DIQ(52.49,PSOIEN,.12,"I") I 'ORNUM W !!,"This order has been Accepted from eRx and cannot be changed." D DIRE Q
"RTN","PSOERXX1",45,0)
 S RXIEN=$O(^PSRX("APL",ORNUM,0)) I 'RXIEN W !!,"A current prescription exists for this eRx. Cannot change eRx." D DIRE Q
"RTN","PSOERXX1",46,0)
 ; build drug information into array to be passed into xml builder
"RTN","PSOERXX1",47,0)
 ; for future use
"RTN","PSOERXX1",48,0)
 ; may consider having the user fill in the drug validation screen then issue change request. Or replicate
"RTN","PSOERXX1",49,0)
 ; drug validation section into another 'Change Request' screen.
"RTN","PSOERXX1",50,0)
 S DROK=$$DRGPRMPT(.DRUG) I 'DROK W !!,"Insufficient drug information. Cannot create change request.",!,"Please try again." D DIRE Q
"RTN","PSOERXX1",51,0)
 S GBL=$$CREQ(PSOIEN,.DRUG) I '$L(GBL) W !!,"Could not create outgoing message structure." D DIRE Q
"RTN","PSOERXX1",52,0)
 S PSSRET=$$RESTPOST^PSOERXO1(.PSSRET,.GBL)
"RTN","PSOERXX1",53,0)
 ; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERXX1",54,0)
 I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",55,0)
 I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",56,0)
 W !!,"Change Request sent." S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXX1",57,0)
 K @GBL
"RTN","PSOERXX1",58,0)
 Q
"RTN","PSOERXX1",59,0)
 ; RXFILL MESSAGE
"RTN","PSOERXX1",60,0)
FMES(PSOIEN) ;
"RTN","PSOERXX1",61,0)
 N ORNUM,RXIEN,DRUG,GBL,FTYPE,PSSRET,CNT
"RTN","PSOERXX1",62,0)
 Q:'PSOIEN
"RTN","PSOERXX1",63,0)
 S ORNUM=$$GET1^DIQ(52.49,PSOIEN,.12,"I") I 'ORNUM W !!,"No OE/RR order number. Cannot create refill request." D DIRE Q
"RTN","PSOERXX1",64,0)
 S RXIEN=$O(^PSRX("APL",ORNUM,0)) I 'RXIEN W !!,"Could not resolve RX #. Please contact technical support." D DIRE Q
"RTN","PSOERXX1",65,0)
 ; FOR NOW SET NOTE AND FTYPE (FULL/PARTIAL) FOR BUILDING XML
"RTN","PSOERXX1",66,0)
 S NOTE="TESTING NOTE"
"RTN","PSOERXX1",67,0)
 S FTYPE="F"
"RTN","PSOERXX1",68,0)
 S GBL=$$RXFILL(PSOIEN,FTYPE,NOTE,RXIEN,ORNUM) I '$L(GBL) W !!,"Could not create outgoing message structure." D DIRE Q
"RTN","PSOERXX1",69,0)
 ;W !!,"RxFill message sent to prescriber." S DIR(0)="E" D ^DIR K DIR 
"RTN","PSOERXX1",70,0)
 S PSSRET=$$RESTPOST^PSOERXO1(.PSSRET,.GBL)
"RTN","PSOERXX1",71,0)
 ; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERXX1",72,0)
 I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",73,0)
 I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",74,0)
 W !!,"RxFill Message sent." S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXX1",75,0)
 K @GBL
"RTN","PSOERXX1",76,0)
 Q
"RTN","PSOERXX1",77,0)
 ; prompt for drug fields needed to create a change request - not currently used
"RTN","PSOERXX1",78,0)
DRGPRMPT(DRG) ;
"RTN","PSOERXX1",79,0)
 ; Prompt for drug
"RTN","PSOERXX1",80,0)
 N DIC,PSODRUG,DIR,Y
"RTN","PSOERXX1",81,0)
 S DIC(0)="AEMQ",DIC=50,DIC("S")="I $$ACTIVE^PSOERXA0(Y),($$OUTPAT^PSOERXA0(Y)),('$$INVCOMP^PSOERXA0(Y)),('$$CS^PSOERXA0(Y))" D ^DIC
"RTN","PSOERXX1",82,0)
 K DIC
"RTN","PSOERXX1",83,0)
 Q:$P(Y,U)<1 0
"RTN","PSOERXX1",84,0)
 ; FOR FUTURE USE - ADD ROUTE PROMPT
"RTN","PSOERXX1",85,0)
 ; Y=DRUG IEN^DRUG DESCRIPTION
"RTN","PSOERXX1",86,0)
 S DRG("DRUG")=$P(Y,U,2)
"RTN","PSOERXX1",87,0)
 S PSODRUG("IEN")=$P(Y,U)
"RTN","PSOERXX1",88,0)
 ; prompt for days supply
"RTN","PSOERXX1",89,0)
 K DIR S DIR(0)="52.49,20.2" D ^DIR
"RTN","PSOERXX1",90,0)
 Q:$P(Y,U)<1 0
"RTN","PSOERXX1",91,0)
 S DRG("DSUP")=Y
"RTN","PSOERXX1",92,0)
 ; prompt for quantity
"RTN","PSOERXX1",93,0)
 K DIR S DIR(0)="52.49,20.1" D ^DIR
"RTN","PSOERXX1",94,0)
 Q:$P(Y,U)<1 0
"RTN","PSOERXX1",95,0)
 S DRG("QTY")=Y
"RTN","PSOERXX1",96,0)
 ; prompt for refills
"RTN","PSOERXX1",97,0)
 K DIR S DIR(0)="52.49,20.5" D ^DIR
"RTN","PSOERXX1",98,0)
 Q:$P(Y,U)<1 0
"RTN","PSOERXX1",99,0)
 S DRG("REF")=Y
"RTN","PSOERXX1",100,0)
 ; prompt for directions
"RTN","PSOERXX1",101,0)
 K DIR S DIR(0)="52.49,7" D ^DIR
"RTN","PSOERXX1",102,0)
 Q:Y="^" 0
"RTN","PSOERXX1",103,0)
 Q:Y']"" 0
"RTN","PSOERXX1",104,0)
 S DRG("DIR")=Y
"RTN","PSOERXX1",105,0)
 Q 1
"RTN","PSOERXX1",106,0)
 ; CHANGE REQUEST VIA BACKDOOR ORDERS
"RTN","PSOERXX1",107,0)
CREQBD(RXIEN) ;
"RTN","PSOERXX1",108,0)
 Q
"RTN","PSOERXX1",109,0)
 ; CHANGE REQUEST VIA PSO LMOE FINISH
"RTN","PSOERXX1",110,0)
CREQPO(ORIEN) ;
"RTN","PSOERXX1",111,0)
 Q
"RTN","PSOERXX1",112,0)
RREQ(PSOIEN,RXIEN,ORNUM,PSOSITE) ;RefillRequest
"RTN","PSOERXX1",113,0)
 N GBL,PSOIENS,CNT
"RTN","PSOERXX1",114,0)
 Q:'PSOIEN ""
"RTN","PSOERXX1",115,0)
 S GBL=$NA(^TMP("RREQ^PSOERXX1",$J)) K @GBL
"RTN","PSOERXX1",116,0)
 S CNT=0
"RTN","PSOERXX1",117,0)
 D MSG^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",118,0)
 ; header
"RTN","PSOERXX1",119,0)
 D HDR^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",120,0)
 ; body header
"RTN","PSOERXX1",121,0)
 D BHF^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",122,0)
 ; request type header
"RTN","PSOERXX1",123,0)
 D RTYPE^PSOERXX2(.GBL,"RefillRequest",1)
"RTN","PSOERXX1",124,0)
 ; request info - not currently used
"RTN","PSOERXX1",125,0)
 ;D REQUEST^PSOERXX2(.GBL,"ACC","ACC")
"RTN","PSOERXX1",126,0)
 D VAPHARM^PSOERXX2(.GBL,PSOSITE,PSOIEN)
"RTN","PSOERXX1",127,0)
 D PRESCRIB^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",128,0)
 D SUPERVIS^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",129,0)
 D FACIL^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",130,0)
 D PATIENT^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",131,0)
 D MEDPRES^PSOERXX4(.GBL,PSOIEN)
"RTN","PSOERXX1",132,0)
 D MEDDIS^PSOERXX4(.GBL,RXIEN,ORNUM,PSOIEN)
"RTN","PSOERXX1",133,0)
 D OBSERVE^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",134,0)
 D BENEFITS^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",135,0)
 D DRUGEVAL^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",136,0)
 ;D DIAGNOS(.GBL,PSOIEN)
"RTN","PSOERXX1",137,0)
 D RTYPE^PSOERXX2(.GBL,"RefillRequest",2)
"RTN","PSOERXX1",138,0)
 D BHF^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",139,0)
 D MSG^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",140,0)
 Q GBL
"RTN","PSOERXX1",141,0)
 ; PSOIEN - erx IEN from 52.49
"RTN","PSOERXX1",142,0)
CREQ(PSOIEN,REQDRUG) ;ChangeRequest
"RTN","PSOERXX1",143,0)
 N GBL,PSOIENS,CNT
"RTN","PSOERXX1",144,0)
 Q:'PSOIEN ""
"RTN","PSOERXX1",145,0)
 S GBL=$NA(^TMP("CREQ^PSOERXX1",$J)) K @GBL
"RTN","PSOERXX1",146,0)
 S CNT=0
"RTN","PSOERXX1",147,0)
 D MSG^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",148,0)
 ; header
"RTN","PSOERXX1",149,0)
 D HDR^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",150,0)
 ; body header
"RTN","PSOERXX1",151,0)
 D BHF^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",152,0)
 ; request type header
"RTN","PSOERXX1",153,0)
 D RTYPE^PSOERXX2(.GBL,"ChangeRequest",1)
"RTN","PSOERXX1",154,0)
 ; request info
"RTN","PSOERXX1",155,0)
 D REQUEST^PSOERXX2(.GBL,"TST","TST")
"RTN","PSOERXX1",156,0)
 D VAPHARM^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",157,0)
 D PRESCRIB^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",158,0)
 D SUPERVIS^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",159,0)
 D FACIL^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",160,0)
 D PATIENT^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",161,0)
 D MEDPRES^PSOERXX4(.GBL,PSOIEN)
"RTN","PSOERXX1",162,0)
 D MEDREQ^PSOERXX4(.GBL,PSOIEN,.REQDRUG)
"RTN","PSOERXX1",163,0)
 D OBSERVE^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",164,0)
 D BENEFITS^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",165,0)
 D DRUGEVAL^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",166,0)
 D DIAGNOS^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",167,0)
 D RTYPE^PSOERXX2(.GBL,"ChangeRequest",2)
"RTN","PSOERXX1",168,0)
 D BHF^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",169,0)
 D MSG^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",170,0)
 Q GBL
"RTN","PSOERXX1",171,0)
 ; FP - full or partial fill (F/P)
"RTN","PSOERXX1",172,0)
 ; NOTE - fill notes
"RTN","PSOERXX1",173,0)
RXFILL(PSOIEN,FP,NOTE,RXIEN,ORNUM) ;
"RTN","PSOERXX1",174,0)
 N GBL,PSOIENS,CNT
"RTN","PSOERXX1",175,0)
 Q:'PSOIEN ""
"RTN","PSOERXX1",176,0)
 S GBL=$NA(^TMP("RXFILL^PSOERXX1",$J)) K @GBL
"RTN","PSOERXX1",177,0)
 S CNT=0
"RTN","PSOERXX1",178,0)
 D MSG^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",179,0)
 ; header
"RTN","PSOERXX1",180,0)
 D HDR^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",181,0)
 ; body header
"RTN","PSOERXX1",182,0)
 D BHF^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",183,0)
 ; request type header
"RTN","PSOERXX1",184,0)
 D RTYPE^PSOERXX2(.GBL,"RxFill",1)
"RTN","PSOERXX1",185,0)
 ; request info
"RTN","PSOERXX1",186,0)
 ;D REQUEST(.GBL,"TEST1","TEST2")
"RTN","PSOERXX1",187,0)
 ;FP - full or partial fill
"RTN","PSOERXX1",188,0)
 S FP="F"
"RTN","PSOERXX1",189,0)
 S NOTE=$G(NOTE,"TESTING NOTES")
"RTN","PSOERXX1",190,0)
 ; fill status
"RTN","PSOERXX1",191,0)
 D FILLST^PSOERXX3(.GBL,FP,NOTE)
"RTN","PSOERXX1",192,0)
 D VAPHARM^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",193,0)
 D PRESCRIB^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",194,0)
 D SUPERVIS^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",195,0)
 D FACIL^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",196,0)
 D PATIENT^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",197,0)
 D MEDPRES^PSOERXX4(.GBL,PSOIEN)
"RTN","PSOERXX1",198,0)
 D MEDDIS^PSOERXX4(.GBL,PSOIEN)
"RTN","PSOERXX1",199,0)
 D OBSERVE^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",200,0)
 D BENEFITS^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",201,0)
 D DRUGEVAL^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",202,0)
 ;D DIAGNOS^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",203,0)
 D RTYPE^PSOERXX2(.GBL,"RxFill",2)
"RTN","PSOERXX1",204,0)
 D BHF^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",205,0)
 D MSG^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",206,0)
 Q GBL
"RTN","PSOERXX1",207,0)
DIRE ;
"RTN","PSOERXX1",208,0)
 N DIR S DIR(0)="E" D ^DIR
"RTN","PSOERXX1",209,0)
 Q
"VER")
8.0^22.2
"^DD",52.48,52.48,.03,0)
FIRST NAME^FJ35^^0;3^K:$L(X)>35!($L(X)<3) X
"^DD",52.48,52.48,.03,3)
Enter the first name of the eRx external person. Answer must be 3-35 characters in length.
"^DD",52.48,52.48,.03,21,0)
^.001^1^1^3180423^^
"^DD",52.48,52.48,.03,21,1,0)
The first name of the eRx external person.
"^DD",52.48,52.48,.03,"DT")
3180412
"^DD",52.48,52.48,4.1,0)
STREET ADDRESS LINE 1^FJ35^^4;1^K:$L(X)>35!($L(X)<3) X
"^DD",52.48,52.48,4.1,3)
Enter street address line 1 for this eRx external person. Answer must be 3-35 characters in length.
"^DD",52.48,52.48,4.1,21,0)
^.001^1^1^3180627^^^
"^DD",52.48,52.48,4.1,21,1,0)
This is street address line 1 for the eRx external person.
"^DD",52.48,52.48,4.1,"DT")
3180627
"^DD",52.49,52.49,.04,0)
EXTERNAL PATIENT IDENTIFIER^P52.46'^PS(52.46,^0;4^Q
"^DD",52.49,52.49,.04,3)
Enter the patient associated with the incoming eRx.
"^DD",52.49,52.49,.04,21,0)
^.001^1^1^3170626^^^
"^DD",52.49,52.49,.04,21,1,0)
This is the external patient identifier.
"^DD",52.49,52.49,.04,"DT")
3180524
"^DD",52.49,52.49,2.1,0)
EXTERNAL PROVIDER^P52.48'^PS(52.48,^2;1^Q
"^DD",52.49,52.49,2.1,3)
Enter the name of the external provider for this eRx holding queue entry.
"^DD",52.49,52.49,2.1,21,0)
^^1^1^3160902^
"^DD",52.49,52.49,2.1,21,1,0)
The external provider for this incoming prescription.
"^DD",52.49,52.49,2.1,"DT")
3180524
"^DD",59,59,10.2,0)
ERX DEFAULT LOOKBACK DAYS^NJ3,0^^10;2^K:+X'=X!(X>365)!(X<1)!(X?.E1"."1N.N) X
"^DD",59,59,10.2,3)
Enter the number of days in the past to look back when loading the holding queue and searching data. Type a number between 1 and 365, 0 decimal digits.
"^DD",59,59,10.2,21,0)
^^3^3^3180524^
"^DD",59,59,10.2,21,1,0)
This field holds the number of days in the past the eRx software will 
"^DD",59,59,10.2,21,2,0)
search the eRx holding queue on initial load, and when performing 
"^DD",59,59,10.2,21,3,0)
searches.
"^DD",59,59,10.2,"DT")
3180524
"BLD",9969,6)
^436
**END**
**END**

