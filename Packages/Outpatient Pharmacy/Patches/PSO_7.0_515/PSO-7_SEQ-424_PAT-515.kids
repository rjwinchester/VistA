Released PSO*7*515 SEQ #424
Extracted from mail message
**KIDS**:PSO*7.0*515^

**INSTALL NAME**
PSO*7.0*515
"BLD",10004,0)
PSO*7.0*515^OUTPATIENT PHARMACY^0^3180131^y
"BLD",10004,1,0)
^^22^22^3180131^
"BLD",10004,1,1,0)
This patch will correct 2 hard errors that are present in PSO*7.0*500, 
"BLD",10004,1,2,0)
which is part of the MOCHA 2.1B COMBINED BUILD and is due for national 
"BLD",10004,1,3,0)
release.
"BLD",10004,1,4,0)
 
"BLD",10004,1,5,0)
The following two errors have been addressed in this patch:
"BLD",10004,1,6,0)
 
"BLD",10004,1,7,0)
<UNDEFINED>SCH+3^PSOORED3 *SCHEX
"BLD",10004,1,8,0)
<UNDEFINED>SCH+3^PSOORED4 *SCHEX
"BLD",10004,1,9,0)
 
"BLD",10004,1,10,0)
The functions where the errors occur are:
"BLD",10004,1,11,0)
- Editing the Schedule while finishing a Pending order from CPRS
"BLD",10004,1,12,0)
- Editing a Schedule of an existing prescription
"BLD",10004,1,13,0)
- Editing a Schedule while Verifying a Non-verified Prescription using 
"BLD",10004,1,14,0)
  either the ListMan verification action or the  'Rx Verification by 
"BLD",10004,1,15,0)
  Clerk' option
"BLD",10004,1,16,0)
- Editing a Schedule while using the 'Process Order Checks' option
"BLD",10004,1,17,0)
 
"BLD",10004,1,18,0)
This patch will also correct an issue presented with the release version 
"BLD",10004,1,19,0)
of PSO*7.0*500 where multiple word schedule expansions are not echoed to 
"BLD",10004,1,20,0)
the screen.  This defect does not affect the patient sig section were 
"BLD",10004,1,21,0)
multiple word schedules continue to be expanded appropriately, only the 
"BLD",10004,1,22,0)
immediate echo response functionality at the time of entry.
"BLD",10004,4,0)
^9.64PA^^
"BLD",10004,6.3)
1
"BLD",10004,"ABPKG")
n
"BLD",10004,"KRN",0)
^9.67PA^779.2^20
"BLD",10004,"KRN",.4,0)
.4
"BLD",10004,"KRN",.401,0)
.401
"BLD",10004,"KRN",.402,0)
.402
"BLD",10004,"KRN",.403,0)
.403
"BLD",10004,"KRN",.5,0)
.5
"BLD",10004,"KRN",.84,0)
.84
"BLD",10004,"KRN",3.6,0)
3.6
"BLD",10004,"KRN",3.8,0)
3.8
"BLD",10004,"KRN",9.2,0)
9.2
"BLD",10004,"KRN",9.8,0)
9.8
"BLD",10004,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",10004,"KRN",9.8,"NM",1,0)
PSOORED3^^0^B66908103
"BLD",10004,"KRN",9.8,"NM",2,0)
PSOORED4^^0^B57964531
"BLD",10004,"KRN",9.8,"NM",3,0)
PSOSIG^^0^B95915445
"BLD",10004,"KRN",9.8,"NM","B","PSOORED3",1)

"BLD",10004,"KRN",9.8,"NM","B","PSOORED4",2)

"BLD",10004,"KRN",9.8,"NM","B","PSOSIG",3)

"BLD",10004,"KRN",19,0)
19
"BLD",10004,"KRN",19.1,0)
19.1
"BLD",10004,"KRN",101,0)
101
"BLD",10004,"KRN",409.61,0)
409.61
"BLD",10004,"KRN",771,0)
771
"BLD",10004,"KRN",779.2,0)
779.2
"BLD",10004,"KRN",870,0)
870
"BLD",10004,"KRN",8989.51,0)
8989.51
"BLD",10004,"KRN",8989.52,0)
8989.52
"BLD",10004,"KRN",8994,0)
8994
"BLD",10004,"KRN","B",.4,.4)

"BLD",10004,"KRN","B",.401,.401)

"BLD",10004,"KRN","B",.402,.402)

"BLD",10004,"KRN","B",.403,.403)

"BLD",10004,"KRN","B",.5,.5)

"BLD",10004,"KRN","B",.84,.84)

"BLD",10004,"KRN","B",3.6,3.6)

"BLD",10004,"KRN","B",3.8,3.8)

"BLD",10004,"KRN","B",9.2,9.2)

"BLD",10004,"KRN","B",9.8,9.8)

"BLD",10004,"KRN","B",19,19)

"BLD",10004,"KRN","B",19.1,19.1)

"BLD",10004,"KRN","B",101,101)

"BLD",10004,"KRN","B",409.61,409.61)

"BLD",10004,"KRN","B",771,771)

"BLD",10004,"KRN","B",779.2,779.2)

"BLD",10004,"KRN","B",870,870)

"BLD",10004,"KRN","B",8989.51,8989.51)

"BLD",10004,"KRN","B",8989.52,8989.52)

"BLD",10004,"KRN","B",8994,8994)

"BLD",10004,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",10004,"QUES",0)
^9.62^^
"BLD",10004,"REQB",0)
^9.611^1^1
"BLD",10004,"REQB",1,0)
PSO*7.0*500^2
"BLD",10004,"REQB","B","PSO*7.0*500",1)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
515^3180131
"PKG",141,22,1,"PAH",1,1,0)
^^22^22^3180131
"PKG",141,22,1,"PAH",1,1,1,0)
This patch will correct 2 hard errors that are present in PSO*7.0*500, 
"PKG",141,22,1,"PAH",1,1,2,0)
which is part of the MOCHA 2.1B COMBINED BUILD and is due for national 
"PKG",141,22,1,"PAH",1,1,3,0)
release.
"PKG",141,22,1,"PAH",1,1,4,0)
 
"PKG",141,22,1,"PAH",1,1,5,0)
The following two errors have been addressed in this patch:
"PKG",141,22,1,"PAH",1,1,6,0)
 
"PKG",141,22,1,"PAH",1,1,7,0)
<UNDEFINED>SCH+3^PSOORED3 *SCHEX
"PKG",141,22,1,"PAH",1,1,8,0)
<UNDEFINED>SCH+3^PSOORED4 *SCHEX
"PKG",141,22,1,"PAH",1,1,9,0)
 
"PKG",141,22,1,"PAH",1,1,10,0)
The functions where the errors occur are:
"PKG",141,22,1,"PAH",1,1,11,0)
- Editing the Schedule while finishing a Pending order from CPRS
"PKG",141,22,1,"PAH",1,1,12,0)
- Editing a Schedule of an existing prescription
"PKG",141,22,1,"PAH",1,1,13,0)
- Editing a Schedule while Verifying a Non-verified Prescription using 
"PKG",141,22,1,"PAH",1,1,14,0)
  either the ListMan verification action or the  'Rx Verification by 
"PKG",141,22,1,"PAH",1,1,15,0)
  Clerk' option
"PKG",141,22,1,"PAH",1,1,16,0)
- Editing a Schedule while using the 'Process Order Checks' option
"PKG",141,22,1,"PAH",1,1,17,0)
 
"PKG",141,22,1,"PAH",1,1,18,0)
This patch will also correct an issue presented with the release version 
"PKG",141,22,1,"PAH",1,1,19,0)
of PSO*7.0*500 where multiple word schedule expansions are not echoed to 
"PKG",141,22,1,"PAH",1,1,20,0)
the screen.  This defect does not affect the patient sig section were 
"PKG",141,22,1,"PAH",1,1,21,0)
multiple word schedules continue to be expanded appropriately, only the 
"PKG",141,22,1,"PAH",1,1,22,0)
immediate echo response functionality at the time of entry.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSOORED3")
0^1^B66908103^B66487001
"RTN","PSOORED3",1,0)
PSOORED3 ;BIR/SAB-edit finished orders through backdoor ;10/20/06 11:09am
"RTN","PSOORED3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,78,99,117,133,148,249,251,379,378,372,416,313,444,402,515**;DEC 1997;Build 1
"RTN","PSOORED3",3,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOORED3",4,0)
 ;External reference to PS(51.2 supported by DBIA 2226 
"RTN","PSOORED3",5,0)
 ;called from psoored2
"RTN","PSOORED3",6,0)
 D DOLST
"RTN","PSOORED3",7,0)
 ;
"RTN","PSOORED3",8,0)
DOSE ;adds dosing info
"RTN","PSOORED3",9,0)
 I '$G(PSORXED("ENT")) F  S I=$O(PSORXED("DOSE",I)) Q:'I  S PSORXED("ENT")=$G(PSORXED("ENT"))+1
"RTN","PSOORED3",10,0)
 K ROU,UNITN,STRE,PSODOSE,RTE,NOUN,VERB M PSODOSE=PSORXED
"RTN","PSOORED3",11,0)
 D KV K FIELD,DOSEOR,DOOR,X,Y,UNITS S ENT=1
"RTN","PSOORED3",12,0)
ASK S ROU="PSOORED3" D ASK^PSOBKDED K ROU I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED3",13,0)
 G:$D(DIRUT) EXQ
"RTN","PSOORED3",14,0)
 I $G(QUIT)]"" K QUIT,ROU Q
"RTN","PSOORED3",15,0)
 ;
"RTN","PSOORED3",16,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED3",17,0)
VER D VER^PSOOREDX I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED3",18,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",19,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED3",20,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED3",21,0)
DUPD ;
"RTN","PSOORED3",22,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED3",23,0)
 D DUPD^PSOOREDX
"RTN","PSOORED3",24,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:"") S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED3",25,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED3",26,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",27,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED3",28,0)
 D STR^PSOOREDX
"RTN","PSOORED3",29,0)
NOU1 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOORED3",30,0)
 D CNON
"RTN","PSOORED3",31,0)
 N PSONDEF
"RTN","PSOORED3",32,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOORED3",33,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED3",34,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",35,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED3",36,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED3",37,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED3",38,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED3",39,0)
RTE S:$G(PSORXED("ROUTE",ENT))']"" DRET=1
"RTN","PSOORED3",40,0)
 K JUMP S ROU="PSOORED3" D RTE^PSOBKDED K ROU
"RTN","PSOORED3",41,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED3",42,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",43,0)
 I $G(QUIT) K QUIT,ROU Q
"RTN","PSOORED3",44,0)
 ;
"RTN","PSOORED3",45,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED3",46,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",47,0)
 S SCH=$$SCHASL^PSOORED5(Y) D SCH^PSOSIG I $G(SCH)']""!($D(DTOUT))!($D(DUOUT)) G SCH
"RTN","PSOORED3",48,0)
 S PSORXED("SCHEDULE",ENT)=SCH IF $G(SCHEX)'="" W " ("_SCHEX_")"
"RTN","PSOORED3",49,0)
 K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED3",50,0)
 S:$G(PSORXED("ENT"))<ENT PSORXED("ENT")=ENT
"RTN","PSOORED3",51,0)
 ;
"RTN","PSOORED3",52,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN MONTHS, WEEKS, DAYS, HOURS OR MINUTES)"
"RTN","PSOORED3",53,0)
 S DIR("B")=$S($G(DUR)]"":DUR,$G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED3",54,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED3",55,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",56,0)
 D DUR1^PSOOREDX
"RTN","PSOORED3",57,0)
 ;
"RTN","PSOORED3",58,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED3",59,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",60,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED3",61,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED3",62,0)
 I X="@" D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOORED3",63,0)
 ;
"RTN","PSOORED3",64,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED3",65,0)
 I '$$DUROK(.PSORXED,ENT) D  G DUR
"RTN","PSOORED3",66,0)
 . W !!,"Duration is required for the dosage entered prior to the THEN conjunction.",$C(7),!
"RTN","PSOORED3",67,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSORXED("DFLG"))!($G(PSORX("DFLG"))) EXQ S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED3",68,0)
 E  K PSOCKCON I $$DCHK^PSODOSUT S PSOQUIT=1 G EXQ
"RTN","PSOORED3",69,0)
 I PSOSAVX="",$G(PSORXED)!$D(PSOEDDOS) K PSOCKCON
"RTN","PSOORED3",70,0)
 K PSOSAVX
"RTN","PSOORED3",71,0)
 ;
"RTN","PSOORED3",72,0)
 S DENT=$O(PSORXED("DOSE",ENT)) I DENT,(ENT+1)'=DENT D
"RTN","PSOORED3",73,0)
 .K PSORXED("DOSE",DENT),PSORXED("NOUN",DENT),PSORXED("VERB",DENT),PSORXED("DOSE ORDERED",DENT),PSORXED("ROUTE",DENT),PSORXED("ODOSE",DENT)
"RTN","PSOORED3",74,0)
 .K PSORXED("SCHEDULE",DENT),PSORXED("DURATION",DENT),PSORXED("CONJUNCTION",DENT),DENT
"RTN","PSOORED3",75,0)
 I $G(FIELD)]"" K FIELD S QUIT=1
"RTN","PSOORED3",76,0)
 I $O(^PSRX(PSORXED("IRXN"),"INS1",0)) D
"RTN","PSOORED3",77,0)
 .F D=0:0 S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORED3",78,0)
 D EN^PSOFSIG(.PSORXED) D VER^PSOORED7:'$G(PSOVER) I $G(CKX),'$G(PSOSIGFL) D M1 K CKX
"RTN","PSOORED3",79,0)
 S:'$D(PSORXED("DAYS SUPPLY")) PSORXED("DAYS SUPPLY")=$P(PSORXED("RX0"),"^",8)
"RTN","PSOORED3",80,0)
 ; Checks if the current Days Supply value is greater than the Maximum Days Supply for the Drug, if so, reset
"RTN","PSOORED3",81,0)
 D DAYSUP^PSOUTIL(+$G(PSODRUG("IEN")),.PSORXED,0)
"RTN","PSOORED3",82,0)
 ;Needed to calculate QTY
"RTN","PSOORED3",83,0)
 K QTY,QTYHLD S QTYHLD=$P(PSORXED("RX0"),"^",7) D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED3",84,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED3",85,0)
 I $G(PSOSIGFL)=1 S PSORXED("ENT")=ENT,SIGOK=1 G EX1
"RTN","PSOORED3",86,0)
 K QTYHLD Q:$G(PSOVER)!($G(PSOREEDQ))
"RTN","PSOORED3",87,0)
UDSIG I $O(SIG(0)) D
"RTN","PSOORED3",88,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSOORED3",89,0)
 .S (A,I)=0 F  S I=$O(^PSRX(PSORXED("IRXN"),"A",I)) Q:'I  S A=A+1
"RTN","PSOORED3",90,0)
 .D NOW^%DTC I $G(QTY) S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^Quantity Updated "_"("_$P(^PSRX(PSORXED("IRXN"),0),"^",7)_")",$P(^PSRX(PSORXED("IRXN"),0),"^",7)=$G(PSORXED("QTY")) K QTY
"RTN","PSOORED3",91,0)
 .S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^New Dosing Instructions Added",^PSRX(PSORXED("IRXN"),"A",A,1)="ORIGINAL SIG^" D
"RTN","PSOORED3",92,0)
 ..I '$P($G(^PSRX(PSORXED("IRXN"),"SIG")),"^",2) S $P(^PSRX(PSORXED("IRXN"),"A",A,1),"^",2)=$P($G(^PSRX(PSORXED("IRXN"),"SIG")),"^") Q
"RTN","PSOORED3",93,0)
 ..F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S ^PSRX(PSORXED("IRXN"),"A",A,2,I,0)=^PSRX(PSORXED("IRXN"),"SIG1",I,0),^PSRX(PSORXED("IRXN"),"A",A,2,0)="^52.34A^"_I_"^"_I
"RTN","PSOORED3",94,0)
 .S ^PSRX(PSORXED("IRXN"),"SIG")="^1"
"RTN","PSOORED3",95,0)
 .K SIG,A,I
"RTN","PSOORED3",96,0)
 S ^PSRX(PSORXED("IRXN"),6,0)="^52.0113^"_ENT_"^"_ENT
"RTN","PSOORED3",97,0)
 F I=1:1:ENT S ^PSRX(PSORXED("IRXN"),6,I,0)=PSORXED("DOSE",I)_"^"_$G(PSORXED("DOSE ORDERED",I))_"^"_$G(PSORXED("UNITS",I))_"^"_$G(PSORXED("NOUN",I))_"^" D
"RTN","PSOORED3",98,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,0)=^PSRX(PSORXED("IRXN"),6,I,0)_$G(PSORXED("DURATION",I))_"^"_$G(PSORXED("CONJUNCTION",I))_"^"_$G(PSORXED("ROUTE",I))_"^"_$G(PSORXED("SCHEDULE",I))_"^"_$G(PSORXED("VERB",I))
"RTN","PSOORED3",99,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,1)=$G(PSORXED("ODOSE",I))
"RTN","PSOORED3",100,0)
 S ^PSRX(PSORXED("IRXN"),"POE")=1
"RTN","PSOORED3",101,0)
 G EX
"RTN","PSOORED3",102,0)
 Q
"RTN","PSOORED3",103,0)
EX ;
"RTN","PSOORED3",104,0)
 K PSORXED("DOSE"),DOSE,DUPD,SCH,PSORXED("NOUN"),PSORXED("VERB"),VERB,NOUN,PSORXED("DOSE ORDERED"),DOSEOR,PSORXED("ROUTE"),ENT,PSORTE,SIG,PSODOSE
"RTN","PSOORED3",105,0)
 K PSORXED("SCHEDULE"),PSORXED("DURATION"),PSORXED("CONJUNCTION"),DURA,X,Y,PSORXED("ODOSE")
"RTN","PSOORED3",106,0)
EX1 K STRE,UNITN,DOSE,DUPD,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSOSCH,ERTE,ROU
"RTN","PSOORED3",107,0)
KV K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOORED3",108,0)
 Q
"RTN","PSOORED3",109,0)
EXQ K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) S PSORXED("DFLG")=1 D M1 G EX
"RTN","PSOORED3",110,0)
 Q
"RTN","PSOORED3",111,0)
M1 D M1^PSOOREDX
"RTN","PSOORED3",112,0)
 Q
"RTN","PSOORED3",113,0)
DOLST1(PSORXED) ;
"RTN","PSOORED3",114,0)
 ;
"RTN","PSOORED3",115,0)
DOLST F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),6,I)) Q:'I  S INST=^(I,0) D
"RTN","PSOORED3",116,0)
 .S PSORXED("DOSE",I)=$P(INST,"^"),PSORXED("DOSE ORDERED",I)=$P(INST,"^",2),PSORXED("UNITS",I)=$P(INST,"^",3),PSORXED("NOUN",I)=$P(INST,"^",4)
"RTN","PSOORED3",117,0)
 .I $P(INST,"^",5)]"" D
"RTN","PSOORED3",118,0)
 ..S PSORXED("DURATION",I)=$S($E($P(INST,"^",5),1)'?.N:$E($P(INST,"^",5),2,99)_$E($P(INST,"^",5),1),1:$P(INST,"^",5))
"RTN","PSOORED3",119,0)
 .S PSORXED("ROUTE",I)=$P(INST,"^",7),PSORXED("SCHEDULE",I)=$P(INST,"^",8)
"RTN","PSOORED3",120,0)
 .S PSORXED("CONJUNCTION",I)=$P(INST,"^",6),PSORXED("VERB",I)=$P(INST,"^",9),OLENT=I
"RTN","PSOORED3",121,0)
 .S PSORXED("ODOSE",I)=$G(^PSRX(PSORXED("IRXN"),6,I,1))
"RTN","PSOORED3",122,0)
 K:'$O(PSORXED("DOSE",0)) PSORXED("ENT"),OLENT
"RTN","PSOORED3",123,0)
 S PSORXED("INS")=$G(^PSRX(PSORXED("IRXN"),"INS"))
"RTN","PSOORED3",124,0)
 Q
"RTN","PSOORED3",125,0)
UPDSIG ;updates sig
"RTN","PSOORED3",126,0)
 K ^PSRX(PSORXED("IRXN"),"SIG1") S ^PSRX(PSORXED("IRXN"),"SIG1",0)="^52.04A^^"
"RTN","PSOORED3",127,0)
 S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1
"RTN","PSOORED3",128,0)
 S ^PSRX(PSORXED("IRXN"),"SIG")="^1"
"RTN","PSOORED3",129,0)
 Q
"RTN","PSOORED3",130,0)
JUMP ;jump to fields
"RTN","PSOORED3",131,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED3",132,0)
 D FNM^PSOOREDX
"RTN","PSOORED3",133,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED3",134,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED3",135,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED3",136,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED3",137,0)
 G EX
"RTN","PSOORED3",138,0)
 Q
"RTN","PSOORED3",139,0)
 ;
"RTN","PSOORED3",140,0)
CNON ;
"RTN","PSOORED3",141,0)
 I $G(NOUN)'="" Q
"RTN","PSOORED3",142,0)
 I '$G(PSORXED("DOSE ORDERED",ENT)) Q
"RTN","PSOORED3",143,0)
 N PSONLT,PSONLL,PSONLG
"RTN","PSOORED3",144,0)
 S PSONLL=$P($G(DOSE("DD",+$G(PSODRUG("IEN")))),"^",9) I PSONLL="" Q
"RTN","PSOORED3",145,0)
 S PSONLG=$L(PSONLL)
"RTN","PSOORED3",146,0)
 I PSONLG'>3 Q
"RTN","PSOORED3",147,0)
 S PSONLT=$E(PSONLL,(PSONLG-2),PSONLG)
"RTN","PSOORED3",148,0)
 I PSONLT'="(S)",PSONLT'="(s)" Q
"RTN","PSOORED3",149,0)
 ;test noun of (S)
"RTN","PSOORED3",150,0)
 K NOUN ; NOT SURE ABOUT THIS???
"RTN","PSOORED3",151,0)
 I $G(PSORXED("DOSE ORDERED",ENT))>1 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))_$E(PSONLT,2) Q
"RTN","PSOORED3",152,0)
 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))
"RTN","PSOORED3",153,0)
 Q
"RTN","PSOORED3",154,0)
 ;
"RTN","PSOORED3",155,0)
DUROK(DOSE,ENT) ; Duration OK? (Complex Doses only)
"RTN","PSOORED3",156,0)
 ;Input: PSORXED - array with doses
"RTN","PSOORED3",157,0)
 ;       ENT - dose entry in the PSORXED array
"RTN","PSOORED3",158,0)
 ;Output: 1: Duration OK / 0: Duration not OK (required, but missing)
"RTN","PSOORED3",159,0)
 N SCHIEN
"RTN","PSOORED3",160,0)
 I $G(DOSE("CONJUNCTION",ENT))'="T" Q 1
"RTN","PSOORED3",161,0)
 I $G(DOSE("DURATION",ENT)) Q 1
"RTN","PSOORED3",162,0)
 I $G(DOSE("SCHEDULE",ENT))="" Q 1
"RTN","PSOORED3",163,0)
 S SCHIEN=$O(^PS(51.1,"B",$G(DOSE("SCHEDULE",ENT)),0))
"RTN","PSOORED3",164,0)
 I $$GET1^DIQ(51.1,SCHIEN,5,"I")="O" Q 1
"RTN","PSOORED3",165,0)
 Q 0
"RTN","PSOORED4")
0^2^B57964531^B57603808
"RTN","PSOORED4",1,0)
PSOORED4 ;BIR/SAB - Edit front door dosing ;07/13/00
"RTN","PSOORED4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,91,78,99,111,117,133,159,148,251,391,372,416,313,437,282,402,515**;DEC 1997;Build 1
"RTN","PSOORED4",3,0)
 ;External reference ^PS(51 supported by DBIA 2224
"RTN","PSOORED4",4,0)
 ;External reference to PS(51.2 supported by DBIA 2226
"RTN","PSOORED4",5,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOORED4",6,0)
 ;called from psoornew
"RTN","PSOORED4",7,0)
 ;
"RTN","PSOORED4",8,0)
DOSE(PSORXED) ;
"RTN","PSOORED4",9,0)
 I '$G(PSODRUG("IEN")) W !,"DRUG NAME REQUIRED!" D 2^PSOORNW1 I '$G(PSODRUG("IEN")) S VALMSG="No Dispense Drug Selected" Q
"RTN","PSOORED4",10,0)
 K ROU,STRE,UNITN,PSODOSE M PSODOSE=PSORXED
"RTN","PSOORED4",11,0)
 D KV K FIELD,DOSEOR,DUPD,X,Y,UNITS S ENT=1,OLENT=$G(PSORXED("ENT"))
"RTN","PSOORED4",12,0)
ASK I $G(ORD) W !!,"Possible SIG: " D
"RTN","PSOORED4",13,0)
 .;Coded only for outside orders with no Patient Instructions
"RTN","PSOORED4",14,0)
 .I $O(SIG(""))="",$G(ORD),$P($G(^PS(52.41,ORD,"EXT")),"^")'="" D SIGS^PSOHCPRS
"RTN","PSOORED4",15,0)
 .S INST=0 F  S INST=$O(SIG(INST)) Q:'INST  S MIG=SIG(INST) D
"RTN","PSOORED4",16,0)
 ..F SG=1:1:$L(MIG," ") W:$X+$L($P(MIG," ",SG)_" ")>IOM !?14 W $P(MIG," ",SG)_" "
"RTN","PSOORED4",17,0)
 K SG,INST,MIG
"RTN","PSOORED4",18,0)
 S ROU="PSOORED4",II=ENT D ASK^PSOBKDED K ROU,II I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED4",19,0)
 G:$D(DIRUT) EXQ
"RTN","PSOORED4",20,0)
 ;
"RTN","PSOORED4",21,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED4",22,0)
VER D VER^PSOOREDX I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED4",23,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",24,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED4",25,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED4",26,0)
DUPD ;
"RTN","PSOORED4",27,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED4",28,0)
 D DUPD^PSOOREDX
"RTN","PSOORED4",29,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:1) S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED4",30,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED4",31,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",32,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED4",33,0)
 D STR^PSOOREDX
"RTN","PSOORED4",34,0)
NOU1 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOORED4",35,0)
 D CNON^PSOORED3
"RTN","PSOORED4",36,0)
 N PSONDEF
"RTN","PSOORED4",37,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOORED4",38,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED4",39,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",40,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED4",41,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED4",42,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED4",43,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED4",44,0)
 ;
"RTN","PSOORED4",45,0)
RTE K JUMP S ROU="PSOORED4" D RTE^PSOBKDED K ROU
"RTN","PSOORED4",46,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED4",47,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",48,0)
 ;
"RTN","PSOORED4",49,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED4",50,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",51,0)
 S SCH=$$SCHASL^PSOORED5(Y) D SCH^PSOSIG I $G(SCH)']""!($D(DTOUT))!($D(DUOUT)) G SCH
"RTN","PSOORED4",52,0)
 S PSORXED("SCHEDULE",ENT)=SCH IF $G(SCHEX)'="" W " ("_SCHEX_")"
"RTN","PSOORED4",53,0)
 K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED4",54,0)
 S:$G(PSORXED("ENT"))<ENT PSORXED("ENT")=ENT
"RTN","PSOORED4",55,0)
 ;
"RTN","PSOORED4",56,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN DAYS, HOURS OR MINUTES)"
"RTN","PSOORED4",57,0)
 S DIR("B")=$S($G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED4",58,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED4",59,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",60,0)
 D DUR1^PSOOREDX
"RTN","PSOORED4",61,0)
 ;
"RTN","PSOORED4",62,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED4",63,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",64,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED4",65,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED4",66,0)
 I X="@",$D(PSORXED("CONJUNCTION",ENT)) D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOORED4",67,0)
 ;
"RTN","PSOORED4",68,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED4",69,0)
 ;*437
"RTN","PSOORED4",70,0)
 I '$$DUROK^PSOORED3(.PSORXED,ENT) D  G DUR
"RTN","PSOORED4",71,0)
 . W !!,"Duration is required for the dosage entered prior to the THEN conjunction.",$C(7),!
"RTN","PSOORED4",72,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSONEW("DFLG")) EX S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED4",73,0)
 E  K PSOCKCON D DCHK1^PSODOSUT I $D(DTOUT)!($D(DUOUT)) S PSORX("DFLG")=1,PSONEW("DFLG")=1 G EX  ;don't need to print the full summary, just the last sequence. 
"RTN","PSOORED4",74,0)
 I PSOSAVX="",$G(PSORXED) K PSOCKCON,PSOEDDOS
"RTN","PSOORED4",75,0)
 K PSOSAVX
"RTN","PSOORED4",76,0)
 ;
"RTN","PSOORED4",77,0)
 S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOORED4",78,0)
 D EN^PSOFSIG(.PSORXED),VERI I $G(CKX),'$G(PSOSIGFL) D MP1 K CKX
"RTN","PSOORED4",79,0)
 I $G(PSOSIGFL)=1 D  I '$G(PSOSIGFL) Q
"RTN","PSOORED4",80,0)
 .I $D(OR0),$P(OR0,"^",24)=1 S VALMSG="Digitally Signed Order - No such changes allowed." K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D  Q
"RTN","PSOORED4",81,0)
 ..I $D(PSOBDR) K PSODRUG M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOORED4",82,0)
 .S PSORXED("ENT")=ENT,SIGOK=1,VALMSG="This change will create a new prescription!",NCPDPFLG=1
"RTN","PSOORED4",83,0)
 K QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED4",84,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED4",85,0)
 K QTYHLD
"RTN","PSOORED4",86,0)
 I '$G(PSORXED("QTY")),$P(OR0,"^",10) S PSORXED("QTY")=$P(OR0,"^",10)
"RTN","PSOORED4",87,0)
EX ;
"RTN","PSOORED4",88,0)
 K PSOBDR,PSOBDRG,PSOSCH,DUPD,STRE,UNITN,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSODOSE,OLENT,FIELD,FLDNM,AR,NM,ENT,STRE,UNITN,PSODOSE,ERTE,ROU
"RTN","PSOORED4",89,0)
KV K DTOUT,DUOUT,DIR,DIRUT
"RTN","PSOORED4",90,0)
 Q
"RTN","PSOORED4",91,0)
EXQ ;
"RTN","PSOORED4",92,0)
 K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D MP1
"RTN","PSOORED4",93,0)
 I $D(PSOBDR) M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOORED4",94,0)
 G EX Q
"RTN","PSOORED4",95,0)
MP1 D MP1^PSOOREDX
"RTN","PSOORED4",96,0)
 Q
"RTN","PSOORED4",97,0)
VERI ;checks for changes to dosing instructions
"RTN","PSOORED4",98,0)
 S ENTS=0
"RTN","PSOORED4",99,0)
 F I=0:0 S I=$O(PSORXED("DOSE",I)) Q:'I  S ENTS=$G(ENTS)+1
"RTN","PSOORED4",100,0)
 I ENTS<OLENT!(ENTS>OLENT) S PSOSIGFL=1 Q
"RTN","PSOORED4",101,0)
 F I=1:1:OLENT D
"RTN","PSOORED4",102,0)
 .I +PSODOSE("DOSE",I)'=$G(PSORXED("DOSE",I)) S PSOSIGFL=1
"RTN","PSOORED4",103,0)
 .I $G(PSODOSE("DURATION",I))]"" D
"RTN","PSOORED4",104,0)
 ..S DURATION=$S($E(PSODOSE("DURATION",I),1)'?.N:$E(PSODOSE("DURATION",I),2,99)_$E(PSODOSE("DURATION",I),1),1:PSODOSE("DURATION",I))
"RTN","PSOORED4",105,0)
 ..I +DURATION'=+$G(PSORXED("DURATION",I)) S PSOSIGFL=1
"RTN","PSOORED4",106,0)
 .I $G(PSODOSE("CONJUNCTION",I))'=$G(PSORXED("CONJUNCTION",I)) S PSOSIGFL=1
"RTN","PSOORED4",107,0)
 .I PSODOSE("ROUTE",I)'=$G(PSORXED("ROUTE",I)) S PSOSIGFL=1
"RTN","PSOORED4",108,0)
 .I PSODOSE("SCHEDULE",I)'=$G(PSORXED("SCHEDULE",I)) S PSOSIGFL=1
"RTN","PSOORED4",109,0)
 K DURATION Q
"RTN","PSOORED4",110,0)
JUMP ;jump to fields
"RTN","PSOORED4",111,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED4",112,0)
 D FNM^PSOOREDX
"RTN","PSOORED4",113,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED4",114,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED4",115,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED4",116,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED4",117,0)
 G EX
"RTN","PSOORED4",118,0)
 Q
"RTN","PSOORED4",119,0)
HLP ;help text for med route
"RTN","PSOORED4",120,0)
 D FULL^VALM1 W !,"Please enter how patient will use the medication!"
"RTN","PSOORED4",121,0)
 S DIC=51.2,X="??",DIC(0)="M",DIC("S")="I $P(^PS(51.2,+Y,0),""^"",4)" D ^DIC K DIC,X,Y
"RTN","PSOORED4",122,0)
 Q
"RTN","PSOORED4",123,0)
SCHLP ;
"RTN","PSOORED4",124,0)
 D FULL^VALM1 W !,"You can choose an entry from the Administration Schedule File (#51.1),",!,"Medication Instruction File (#51) or enter free text."
"RTN","PSOORED4",125,0)
 W !,"The free text entry cannot contain more than 2 spaces or be greater than 20",!,"characters in length."
"RTN","PSOORED4",126,0)
 W ! S DIR(0)="S^A:Administration Schedule File;M:Medication Instruction File;B:Both;F:Free Text",DIR("B")="Both"
"RTN","PSOORED4",127,0)
 S DIR("A")="Do you want to list from" D ^DIR I Y="F"!($G(DIRUT)) K X,Y G X
"RTN","PSOORED4",128,0)
 S LBL=Y G @LBL
"RTN","PSOORED4",129,0)
A ;display 51.1 entries only
"RTN","PSOORED4",130,0)
B K X,Y,DIC S X="??",DIC="^PS(51.1,",DIC(0)="QESMVZ",DIC("W")="D DICW^PSOORED4",D="APPSJ^D" W ! D MIX^DIC1
"RTN","PSOORED4",131,0)
 K DIC,X I LBL="A"!($G(DTOUT)) K LBL G X
"RTN","PSOORED4",132,0)
 I Y=-1!($G(DUOUT)) K DIR,DTOUT,DUOUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Do you want to continue with the Medication Instruction File"
"RTN","PSOORED4",133,0)
 D ^DIR I 'Y!($G(DTOUT)) K DIR,X,Y G X
"RTN","PSOORED4",134,0)
M K X,Y,DIC S DIC=51,X="??",DIC(0)="M" D ^DIC K DIC,X,Y,DTOUT,DUOUT,LBL
"RTN","PSOORED4",135,0)
 ;*282 Allow multi-word schedules
"RTN","PSOORED4",136,0)
X S DIR("?")="^D SCHLP^PSOORED4",DIR("A")="Schedule: ",DIR(0)="FA^1:20^I X[""""""""!(X?.E1C.E)!($A(X)=45)!($L(X,"" "")>$S(X[""PRN"":4,1:3))!($L(X)>20)!($L(X)<1) K X"
"RTN","PSOORED4",137,0)
 S DIR("B")=$S($D(PSOSCH)&('$D(PSORXED("SCHEDULE",ENT))):PSOSCH,$G(PSORXED("SCHEDULE",ENT))]"":PSORXED("SCHEDULE",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED4",138,0)
 Q
"RTN","PSOORED4",139,0)
DICW ;
"RTN","PSOORED4",140,0)
 S Z=$P(^PS(51.1,+Y,0),"^",5),Z=$S(Z="O":-1,Z="S":1,Z="R":-2,1:0) W:Z "  ",$S(Z>0:"SHIFT",Z=-2:"RANGE",1:"ONE-TIME")
"RTN","PSOORED4",141,0)
 I Z'<0,$D(PSJW),$D(^(PSJPP'="PSJ"+1,PSJW,0)),$P(^(0),"^",Z+2)]"" W "  ",$P(^(0),"^",Z+2)
"RTN","PSOORED4",142,0)
 ;Naked reference on DICW+2 is from DICW+1, ^PS(51.1,+Y,0)
"RTN","PSOORED4",143,0)
 Q
"RTN","PSOSIG")
0^3^B95915445^B96478034
"RTN","PSOSIG",1,0)
PSOSIG ;BIR/RTR-Utility to create SIG ;6/04/00
"RTN","PSOSIG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,99,114,391,313,282,455,446,402,500,515**;DEC 1997;Build 1
"RTN","PSOSIG",3,0)
 ;External reference to PS(51 supported by DBIA 2224
"RTN","PSOSIG",4,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOSIG",5,0)
 ;External reference to PSDRUG( supported by DBIA 221
"RTN","PSOSIG",6,0)
 ;
"RTN","PSOSIG",7,0)
EN(PSOSIGX) ;
"RTN","PSOSIG",8,0)
 N VARIABLE
"RTN","PSOSIG",9,0)
 Q
"RTN","PSOSIG",10,0)
SCH ;*282 Preserve old functionality
"RTN","PSOSIG",11,0)
 I $D(DTOUT)!($D(DUOUT)) Q
"RTN","PSOSIG",12,0)
 I Y>0!($G(SCH)[" ") S SCHEX=$$SCHE(SCH)
"RTN","PSOSIG",13,0)
 I Y'>0 W !,?2,"Free text '"_$G(SCH)_"' entered for schedule"
"RTN","PSOSIG",14,0)
 Q
"RTN","PSOSIG",15,0)
 ;
"RTN","PSOSIG",16,0)
 ;SCHE is the new schedule expander
"RTN","PSOSIG",17,0)
SCHE(SCH) ;
"RTN","PSOSIG",18,0)
 ;SCH = Schedule entered
"RTN","PSOSIG",19,0)
 ;Returns Expanded Schedule, or ""
"RTN","PSOSIG",20,0)
 N SCHEX,SPCT
"RTN","PSOSIG",21,0)
 I SCH[""""!($A(SCH)=45)!(SCH?.E1C.E)!($L(SCH," ")>$S(SCH["PRN":4,1:3))!($L(SCH)>20)!($L(SCH)<1) K SCH Q ""
"RTN","PSOSIG",22,0)
 S SCH=$$UPPER(SCH)
"RTN","PSOSIG",23,0)
 S SPCT=0 F I=1:1:$L(SCH) I $E(SCH,I)=" " S SPCT=SPCT+1
"RTN","PSOSIG",24,0)
 S SCHEX=$$EXP(SCH) I SCHEX]"" Q SCHEX
"RTN","PSOSIG",25,0)
 Q:SPCT=0 SCH
"RTN","PSOSIG",26,0)
 Q $$SCHE($P(SCH," ",1,SPCT))_" "_$$SCHE($P(SCH," ",SPCT+1))
"RTN","PSOSIG",27,0)
EXP(X) ; expand based on 51.1 and 51
"RTN","PSOSIG",28,0)
 N PSIN,SCFLG,SCHEX
"RTN","PSOSIG",29,0)
 S PSIN=0 F  S PSIN=$O(^PS(51.1,"APPSJ",X,PSIN)) Q:'PSIN!$G(SCFLG)  I $P(^PS(51.1,PSIN,0),"^",8)'="" S SCHEX=$P($G(^(0)),"^",8),SCFLG=1
"RTN","PSOSIG",30,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",31,0)
 S PSIN=0 F  S PSIN=$O(^PS(51.1,"D",X,PSIN)) Q:'PSIN!$G(SCFLG)  I $P(^PS(51.1,PSIN,0),"^",8)'="" S SCHEX=$P($G(^(0)),"^",8),SCFLG=1
"RTN","PSOSIG",32,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",33,0)
 S PSIN=0 F  S PSIN=$O(^PS(51,"B",X,PSIN)) Q:'PSIN!$G(SCLFL)  I PSIN,($P(^PS(51,PSIN,0),"^",4)<2)&($P($G(^PS(51,"A",X)),"^")'="") S SCHEX=$P(^(X),"^"),SCFLG=1
"RTN","PSOSIG",34,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",35,0)
 S PSIN=0 F  S PSIN=$O(^PS(51,"D",X,PSIN)) Q:'PSIN!$G(SCLFL)  I PSIN,($P(^PS(51,PSIN,0),"^",4)<2)&($P($G(^PS(51,"A",X)),"^")'="") S SCHEX=$P(^(X),"^"),SCFLG=1
"RTN","PSOSIG",36,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",37,0)
 Q ""
"RTN","PSOSIG",38,0)
 ;
"RTN","PSOSIG",39,0)
QTY(PSOQX) ; PSOQX - Array containing Rx information
"RTN","PSOSIG",40,0)
 N QDOSE,PSORXIEN,PSODSEDT,PSOOUTQT
"RTN","PSOSIG",41,0)
 K PSOQX("QTY")
"RTN","PSOSIG",42,0)
 S PSORXIEN=$S($G(PSOQX("IRXN")):+PSOQX("IRXN"),1:0)
"RTN","PSOSIG",43,0)
 S PSODSEDT=$S(PSORXIEN&$D(PSOQX(52,PSORXIEN,8)):1,'PSORXIEN&($G(PSOQX("FLD"))=8):1,1:0)  ; DAYS SUPPLY field edited
"RTN","PSOSIG",44,0)
 I 'PSORXIEN,$G(PSOQX("FLD"))=7 Q   ; QTY field being edite for Pending Order (do not ajust current QTY)
"RTN","PSOSIG",45,0)
 S PSOOUTQT=1
"RTN","PSOSIG",46,0)
QTYCP ;CPRS qty call comes through here
"RTN","PSOSIG",47,0)
 N PSQQUIT,QTSH,PSQ,PSQMIN,PSQMINZ,PSOQRND,PSOLOWER,PSOLOWX,PSOLOWXL,PSOLOWST
"RTN","PSOSIG",48,0)
 K PSOFRQ S PSQQUIT=0
"RTN","PSOSIG",49,0)
 I '$G(PSOCPRQT) S QDOSE=0 F PSQ=0:0 S PSQ=$O(PSOQX("DOSE",PSQ)) Q:'PSQ  S QDOSE=PSQ S:'$G(PSOQX("DOSE ORDERED",PSQ)) PSQQUIT=1
"RTN","PSOSIG",50,0)
 I '$G(PSOCPRQT) Q:PSQQUIT
"RTN","PSOSIG",51,0)
 Q:'$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",52,0)
 Q:'$G(QDOSE)
"RTN","PSOSIG",53,0)
 G:QDOSE>1 COMP
"RTN","PSOSIG",54,0)
 Q:'$G(PSOQX("DOSE ORDERED",1))
"RTN","PSOSIG",55,0)
 Q:'$G(PSOQX("DAYS SUPPLY"))&('$G(PSOQX("DURATION",1)))
"RTN","PSOSIG",56,0)
 S PSOLOWER=0
"RTN","PSOSIG",57,0)
 I $G(PSOQX("DURATION",1)) D
"RTN","PSOSIG",58,0)
 .S PSOLOWX=$L(PSOQX("DURATION",1))
"RTN","PSOSIG",59,0)
 .S PSOLOWXL=$S($E(PSOQX("DURATION",1),PSOLOWX)="M":1,$E(PSOQX("DURATION",1),PSOLOWX)="H":60,$E(PSOQX("DURATION",1),PSOLOWX)="S":.01666,$E(PSOQX("DURATION",1),PSOLOWX)="W":10080,$E(PSOQX("DURATION",1),PSOLOWX)="L":43200,1:1440)
"RTN","PSOSIG",60,0)
 .S PSOLOWER=PSOLOWXL*(+$G(PSOQX("DURATION",1)))
"RTN","PSOSIG",61,0)
 S PSOLOWX=0 I +$G(PSOQX("DAYS SUPPLY")) S PSOLOWX=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",62,0)
 Q:'$G(PSOLOWER)&('$G(PSOLOWX))
"RTN","PSOSIG",63,0)
 S QTSH=$G(PSOQX("SCHEDULE",1)) D QTS Q:PSQQUIT!('$G(PSOFRQ))
"RTN","PSOSIG",64,0)
 S PSOLOWST=$S('$G(PSOLOWER):$G(PSOLOWX),'$G(PSOLOWX):$G(PSOLOWER),$G(PSOLOWER)>$G(PSOLOWX):$G(PSOLOWX),$G(PSOLOWX)>$G(PSOLOWER):$G(PSOLOWER),$G(PSOLOWX)=$G(PSOLOWER):$G(PSOLOWER),1:0)
"RTN","PSOSIG",65,0)
 Q:'$G(PSOLOWST)
"RTN","PSOSIG",66,0)
 S PSQMIN=+$G(PSOLOWST)
"RTN","PSOSIG",67,0)
 S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIG",68,0)
 S PSOQRND=PSQMINZ*+$G(PSOQX("DOSE ORDERED",1)) Q:'PSOQRND
"RTN","PSOSIG",69,0)
 ;If DAYS SUPPLY was edited by Pharmacy and previous quantity was calculated, don't calculate/update quantity automatically
"RTN","PSOSIG",70,0)
 I $G(PSODSEDT),'$$UPDQTY(PSOQRND+.9999\1) Q
"RTN","PSOSIG",71,0)
 D ROUND G QEND
"RTN","PSOSIG",72,0)
 Q
"RTN","PSOSIG",73,0)
COMP ;COMPLEX DOSE HERE
"RTN","PSOSIG",74,0)
 N PSOQEXC,PSOQAND,PSOQTHEN,PSQL,PSQMNL,PSQMNLX,PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSQ1,PSODUX,PSODUXX,PSODSMIN
"RTN","PSOSIG",75,0)
 ;PSODUTOT = TOTAL OF ALL DURATIONS
"RTN","PSOSIG",76,0)
 ;PSODUDIF = DIFF. OF DURATION VS DAYS SUPPLY
"RTN","PSOSIG",77,0)
 ;PSODUMIS = # OF SEQUENCES MISSING A DURATION IF >1 CAN'T DEFAULT
"RTN","PSOSIG",78,0)
 ;PSODUREP = SEQUENCE # THAT IS MISSING DURATION
"RTN","PSOSIG",79,0)
 ;PSODSMIN = MINUTES OF DAYS SUPPLY
"RTN","PSOSIG",80,0)
 S (PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSODSMIN,PSOQAND,PSOQTHEN,PSOQEXC)=0
"RTN","PSOSIG",81,0)
 F PSQL=1:1:QDOSE S:$G(PSOQX("CONJUNCTION",PSQL))["A" PSOQAND=1 S:$G(PSOQX("CONJUNCTION",PSQL))["T" PSOQTHEN=1 S:$G(PSOQX("CONJUNCTION",PSQL))["X" PSOQEXC=1
"RTN","PSOSIG",82,0)
 I $G(PSOQEXC) G QEND
"RTN","PSOSIG",83,0)
 I $G(PSOQAND) G COMP^PSOSIGCX
"RTN","PSOSIG",84,0)
 F PSQ1=1:1:QDOSE D  Q:PSODUMIS>1
"RTN","PSOSIG",85,0)
 .I '$G(PSOQX("DURATION",PSQ1)) S PSODUMIS=PSODUMIS+1,PSODUREP=PSQ1 Q
"RTN","PSOSIG",86,0)
 .S PSODUX=$L(PSOQX("DURATION",PSQ1))
"RTN","PSOSIG",87,0)
 .S PSODUXX=$S($E(PSOQX("DURATION",PSQ1),PSODUX)="M":1,$E(PSOQX("DURATION",PSQ1),PSODUX)="H":60,$E(PSOQX("DURATION",PSQ1),PSODUX)="S":.01666,$E(PSOQX("DURATION",PSQ1),PSODUX)="W":10080,$E(PSOQX("DURATION",PSQ1),PSODUX)="L":43200,1:1440)
"RTN","PSOSIG",88,0)
 .S PSODUTOT=PSODUTOT+(PSODUXX*(+$G(PSOQX("DURATION",PSQ1))))
"RTN","PSOSIG",89,0)
 G:PSODUMIS>1 QEND ; More than 1 sequence missing a duration
"RTN","PSOSIG",90,0)
 I $G(PSODUMIS),'$G(PSOQX("DAYS SUPPLY")) G QEND ; missing 1 duration, no days supply
"RTN","PSOSIG",91,0)
 S PSODSMIN=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",92,0)
 I $G(PSODSMIN),$G(PSODSMIN)<$G(PSODUTOT) G QEND
"RTN","PSOSIG",93,0)
 I '$G(PSODUMIS),$G(PSODSMIN),$G(PSODUTOT)>$G(PSODSMIN) G QEND ; no missing durations, but total durations are greater than days supply
"RTN","PSOSIG",94,0)
 I $G(PSODUMIS),$G(PSODSMIN),$G(PSODSMIN)'>$G(PSODUTOT) G QEND ; 1 missing duration, and total of other durations are not less than days supply
"RTN","PSOSIG",95,0)
 I '$G(PSODSMIN),$G(PSODUMIS) G QEND ; no days supply, missing a duration
"RTN","PSOSIG",96,0)
 I $G(PSODUREP) S PSODUDIF=$G(PSODSMIN)-$G(PSODUTOT)
"RTN","PSOSIG",97,0)
 F PSQ=1:1:QDOSE D  Q:$G(PSQQUIT)
"RTN","PSOSIG",98,0)
 .I '$G(PSOQX("DOSE ORDERED",PSQ))!($G(PSOQX("SCHEDULE",PSQ))="") S PSQQUIT=1 Q
"RTN","PSOSIG",99,0)
 .S QTSH=$G(PSOQX("SCHEDULE",PSQ)) D QTS S:'$G(PSOFRQ) PSQQUIT=1 Q:$G(PSQQUIT)
"RTN","PSOSIG",100,0)
 .I $G(PSOQX("DURATION",PSQ)) S PSQMNL=$L(PSOQX("DURATION",PSQ)) D
"RTN","PSOSIG",101,0)
 ..S PSQMNLX=$S($E(PSOQX("DURATION",PSQ),PSQMNL)="M":1,$E(PSOQX("DURATION",PSQ),PSQMNL)="H":60,$E(PSOQX("DURATION",PSQ),PSQMNL)="S":.01666,$E(PSOQX("DURATION",PSQ),PSQMNL)="W":10080,$E(PSOQX("DURATION",PSQ),PSQMNL)="L":43200,1:1440)
"RTN","PSOSIG",102,0)
 ..S PSQMIN=PSQMNLX*(+$G(PSOQX("DURATION",PSQ)))
"RTN","PSOSIG",103,0)
 .I '$G(PSOQX("DURATION",PSQ)) S PSQMIN=$G(PSODUDIF)
"RTN","PSOSIG",104,0)
 .S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIG",105,0)
 .S PSOQRND=$S('$G(PSOQRND):PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ)),1:$G(PSOQRND)+(PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ))))
"RTN","PSOSIG",106,0)
 I $G(PSQQUIT) G QEND
"RTN","PSOSIG",107,0)
 ;If DAYS SUPPLY was edited by Pharmacy, don't re-calculate QTY automatically for Digitally Signed Pending Orders
"RTN","PSOSIG",108,0)
 I $G(PSODSEDT),$G(QTYHLD),$G(PSOFDR),$P($G(OR0),"^",24) D  Q
"RTN","PSOSIG",109,0)
 . W !!,"The Quantity (",QTYHLD,") has not been changed."
"RTN","PSOSIG",110,0)
 . W !,"Please review and update it if necessary.",!,$C(7)
"RTN","PSOSIG",111,0)
 . N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOSIG",112,0)
 I $G(PSOQRND) D ROUND
"RTN","PSOSIG",113,0)
 G QEND
"RTN","PSOSIG",114,0)
QTS ;*282 Preserve Old Functionality
"RTN","PSOSIG",115,0)
 S PSOFRQ=$$QTSCH(QTSH)
"RTN","PSOSIG",116,0)
 I '$G(PSOFRQ) S PSQQUIT=1
"RTN","PSOSIG",117,0)
 Q
"RTN","PSOSIG",118,0)
 ;
"RTN","PSOSIG",119,0)
QTSCH(QTSH) ; 
"RTN","PSOSIG",120,0)
 ; Return Frequency for Schedule QTSH
"RTN","PSOSIG",121,0)
 ; Otherwise return ""
"RTN","PSOSIG",122,0)
 N PSOFRQ,SPCT,FOUND
"RTN","PSOSIG",123,0)
 Q:$G(QTSH)="" ""
"RTN","PSOSIG",124,0)
 Q:$E(QTSH,1)=" " ""
"RTN","PSOSIG",125,0)
 S QTSH=$$UPPER(QTSH)
"RTN","PSOSIG",126,0)
 S SPCT=1,PSOFRQ=0 F I=1:1:$L(QTSH) I $E(QTSH,I)=" " S SPCT=SPCT+1
"RTN","PSOSIG",127,0)
 F I=0:1:SPCT-1 S SCHTMP=$P(QTSH," ",1,SPCT-I) Q:PSOFRQ  D
"RTN","PSOSIG",128,0)
 . F II=0:0 S II=$O(^PS(51.1,"APPSJ",SCHTMP,II)) Q:'II!PSOFRQ  S PSOFRQ=$P(^PS(51.1,II,0),"^",3)
"RTN","PSOSIG",129,0)
 Q:PSOFRQ PSOFRQ
"RTN","PSOSIG",130,0)
  F I=0:1:SPCT-1 S SCHTMP=$P(QTSH," ",1,SPCT-I) Q:PSOFRQ  D
"RTN","PSOSIG",131,0)
 . F II=0:0 S II=$O(^PS(51,"B",SCHTMP,II)) Q:'II!PSOFRQ  I $P(^PS(51,II,0),"^",4)<2 S PSOFRQ=$P(^PS(51,II,0),"^",8)
"RTN","PSOSIG",132,0)
 Q:PSOFRQ PSOFRQ
"RTN","PSOSIG",133,0)
 Q ""
"RTN","PSOSIG",134,0)
 ;
"RTN","PSOSIG",135,0)
QEND ;
"RTN","PSOSIG",136,0)
 ; PSOMTFLG variable indicates a Maintenance Rx (Titration/Maintenance)
"RTN","PSOSIG",137,0)
 K PSOFRQ
"RTN","PSOSIG",138,0)
 I $G(PSOOUTQT),$G(QTYHLD),$G(PSOQX("QTY")),$G(QTYHLD)'=$G(PSOQX("QTY")) W !!,"Quantity has been changed from "_QTYHLD_" to "_PSOQX("QTY") D  I '$G(PSOMTFLG) W ! N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOSIG",139,0)
 .I $G(PSONEW("FLD"))=8,$P($G(OR0),"^",24),$G(PSODRUG("IEN")),$D(^PSDRUG(+$G(PSODRUG("IEN")),0)) D
"RTN","PSOSIG",140,0)
 ..I $P(^PSDRUG(PSODRUG("IEN"),0),"^",3)[2!($P(^PSDRUG(PSODRUG("IEN"),0),"^",3)["F") Q
"RTN","PSOSIG",141,0)
 ..N ZRFA S ZRFA=$S($G(CLOZPAT)=2&(PSOQX("DAYS SUPPLY")=14):1,$G(CLOZPAT)=2&(PSOQX("DAYS SUPPLY")=7):3,$G(CLOZPAT)=1&(PSOQX("DAYS SUPPLY")=7):1,$D(CLOZPAT):0,1:5)
"RTN","PSOSIG",142,0)
 ..N ZREF,ZTQ S ZREF=QTYHLD\PSOQX("QTY") I ZREF>0 D
"RTN","PSOSIG",143,0)
 ...S ZTQ=QTYHLD*(PSOQX("# OF REFILLS")+1),ZTQ=ZTQ-PSOQX("QTY"),ZREF=ZTQ\PSOQX("QTY") S:ZREF>ZRFA ZREF=ZRFA
"RTN","PSOSIG",144,0)
 ...I ZREF'=PSOQX("# OF REFILLS") W !,"# of Refills has been changed from "_PSOQX("# OF REFILLS")_" to "_ZREF S PSOQX("# OF REFILLS")=ZREF
"RTN","PSOSIG",145,0)
 Q
"RTN","PSOSIG",146,0)
ROUND ;
"RTN","PSOSIG",147,0)
 Q:'$G(PSOQRND)
"RTN","PSOSIG",148,0)
 I PSOQRND'["." S PSOQX("QTY")=PSOQRND Q
"RTN","PSOSIG",149,0)
 S PSOQX("QTY")=$P(PSOQRND,".")+1
"RTN","PSOSIG",150,0)
 Q
"RTN","PSOSIG",151,0)
DAY(DATE) ;First 5 digits of FileMan date
"RTN","PSOSIG",152,0)
 N X
"RTN","PSOSIG",153,0)
 I DATE'?5N Q -1
"RTN","PSOSIG",154,0)
 S X=$E(DATE,4,5) I X<1!(X>12) Q -1
"RTN","PSOSIG",155,0)
 S X=DATE+1+(X=12*88)_"01"
"RTN","PSOSIG",156,0)
 Q $E($$FMADD^XLFDT(X,-1),6,7)
"RTN","PSOSIG",157,0)
 ;
"RTN","PSOSIG",158,0)
QTYX(PSOQX) ;
"RTN","PSOSIG",159,0)
 N PSOQLP,PSOQLN,PSOQAR,PSOCPRQT,QDOSE,QDOSEX S PSOCPRQT=1 F PSOQLP=0:0 S PSOQLP=$O(PSOQX("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIG",160,0)
 .S PSOQAR("DURATION",PSOQLP)=$G(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIG",161,0)
 .I $E(PSOQX("DURATION",PSOQLP))?1A S PSOQLN=$L(PSOQX("DURATION",PSOQLP)) S PSOQX("DURATION",PSOQLP)=$E(PSOQX("DURATION",PSOQLP),2,PSOQLN)_$E(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIG",162,0)
 S QDOSE=0 F QDOSEX=0:0 S QDOSEX=$O(PSOQX("DOSE ORDERED",QDOSEX)) Q:'QDOSEX  S QDOSE=QDOSE+1
"RTN","PSOSIG",163,0)
 I '$G(PSOQX("QTY")) D QTYCP G QPASS
"RTN","PSOSIG",164,0)
 D QTYCP^PSOSIGDS
"RTN","PSOSIG",165,0)
QPASS F PSOQLP=0:0 S PSOQLP=$O(PSOQAR("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIG",166,0)
 .S PSOQX("DURATION",PSOQLP)=$G(PSOQAR("DURATION",PSOQLP))
"RTN","PSOSIG",167,0)
 K PSOCPRQT
"RTN","PSOSIG",168,0)
 Q
"RTN","PSOSIG",169,0)
DAYS(PSOQX) ;Entry point for Days Supply calc for PSO
"RTN","PSOSIG",170,0)
 ;Kill days supply here
"RTN","PSOSIG",171,0)
 Q:'$G(PSOQX("QTY"))
"RTN","PSOSIG",172,0)
 D QTYOPS^PSOSIGDS
"RTN","PSOSIG",173,0)
 Q
"RTN","PSOSIG",174,0)
 ;
"RTN","PSOSIG",175,0)
UPDQTY(NEWQTY) ; If DAYS SUPPLY is being edited and previous QTY was not calculated, don't calculate and update QTY
"RTN","PSOSIG",176,0)
 ; Also, if digitally signed, do not automatically calculate and update quantity if QTY increases
"RTN","PSOSIG",177,0)
 ; Input: NEWQTY - Newly Calculated Quantity
"RTN","PSOSIG",178,0)
 ;Output: 1: YES - Update Rx with re-calculated QTY / 0: NO - Don't update Rx with re-calculated QTY
"RTN","PSOSIG",179,0)
 N UPDQTY,PSOFREQ,PSOOLDDS,PSONEWDS,PSOOLDQT,PSODOSOR,PSODUR
"RTN","PSOSIG",180,0)
 S UPDQTY=1 I 'NEWQTY Q UPDQTY
"RTN","PSOSIG",181,0)
 S PSOOLDDS=$G(PSOQX("OLD DAYS SUPPLY")) I 'PSOOLDDS Q UPDQTY ; DAYS SUPPLY value prior to edit
"RTN","PSOSIG",182,0)
 S PSONEWDS=$G(PSOQX("DAYS SUPPLY")) I 'PSONEWDS Q UPDQTY ; New DAYS SUPPLY value
"RTN","PSOSIG",183,0)
 S PSOOLDQT=$G(QTYHLD) I 'PSOOLDQT Q UPDQTY ; QTY on file, possibly calculated
"RTN","PSOSIG",184,0)
 S PSOFREQ=$$SCHFREQ(),PSODOSOR=$G(PSOQX("DOSE ORDERED",1))
"RTN","PSOSIG",185,0)
 S PSODUR=$G(PSOQX("DURATION",1)) I PSODUR,PSODUR<PSOOLDDS S PSOOLDDS=PSODUR
"RTN","PSOSIG",186,0)
 ;
"RTN","PSOSIG",187,0)
 ;Checking whether current QTY was previously calculated, if not don't update with new QTY
"RTN","PSOSIG",188,0)
 I (PSODOSOR<1)!(PSOFREQ>1440) D
"RTN","PSOSIG",189,0)
 . ;Different calculation for doses of less than one QTY (e.g., 1/2 tablet) OR frequency lower than every 24hrs
"RTN","PSOSIG",190,0)
 . I PSOFREQ,(((PSOOLDDS*(1440/PSOFREQ))*PSODOSOR)+.9\1)'=PSOOLDQT S UPDQTY=0
"RTN","PSOSIG",191,0)
 E  D
"RTN","PSOSIG",192,0)
 . ;Checking whether current QTY was previously calculated
"RTN","PSOSIG",193,0)
 . I ((NEWQTY/PSONEWDS)'=(PSOOLDQT/PSOOLDDS)) S UPDQTY=0
"RTN","PSOSIG",194,0)
 ;
"RTN","PSOSIG",195,0)
 ;QTY is increasing for a CS Rx/Order, so don't update with new QTY
"RTN","PSOSIG",196,0)
 I ($G(PSOFDR)&$P($G(OR0),"^",24)&(NEWQTY>PSOOLDQT)) S UPDQTY=0
"RTN","PSOSIG",197,0)
 ;
"RTN","PSOSIG",198,0)
 I 'UPDQTY D
"RTN","PSOSIG",199,0)
 . W !!,"The Quantity (",PSOOLDQT,") has not been changed."
"RTN","PSOSIG",200,0)
 . W !,"Please review and update it if necessary.",!,$C(7)
"RTN","PSOSIG",201,0)
 . N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOSIG",202,0)
 Q UPDQTY
"RTN","PSOSIG",203,0)
 ;
"RTN","PSOSIG",204,0)
SCHFREQ() ; Returns the Frequency (in minutes) for the schedule
"RTN","PSOSIG",205,0)
 ; Output: SCHFREQ - Schedule Frequency (in minutes)
"RTN","PSOSIG",206,0)
 N SCHED,SCHEDIEN
"RTN","PSOSIG",207,0)
 S SCHED=$G(PSOQX("SCHEDULE",1)) I SCHED="" Q 0
"RTN","PSOSIG",208,0)
 S SCHEDIEN=$O(^PS(51.1,"B",SCHED,0)) I SCHEDIEN Q $$GET1^DIQ(51.1,SCHEDIEN,2)
"RTN","PSOSIG",209,0)
 S SCHEDIEN=$O(^PS(51,"B",SCHED,0)) I SCHEDIEN Q $$GET1^DIQ(51,SCHEDIEN,31)
"RTN","PSOSIG",210,0)
 Q 0
"RTN","PSOSIG",211,0)
 ;
"RTN","PSOSIG",212,0)
UPPER(PSOSCUP) ;
"RTN","PSOSIG",213,0)
 Q $TR(PSOSCUP,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"VER")
8.0^22.2
"BLD",10004,6)
^424
**END**
**END**

