Released PSO*7*422 SEQ #407
Extracted from mail message
**KIDS**:PSO*7.0*422^

**INSTALL NAME**
PSO*7.0*422
"BLD",9240,0)
PSO*7.0*422^OUTPATIENT PHARMACY^0^3161013^y
"BLD",9240,1,0)
^^8^8^3141205^
"BLD",9240,1,1,0)
This patch will resolve the following issues:
"BLD",9240,1,2,0)
1.      If patient has Other Language Preference set to Yes and medication
"BLD",9240,1,3,0)
instructions are entered into Other Patient Instructions, this
"BLD",9240,1,4,0)
information will not print on the pharmacy fill part of the label.
"BLD",9240,1,5,0)
2.      Duplicate Prescriptions are active on a patients profile
"BLD",9240,1,6,0)
3.      Pharmacy staff can process their own prescriptions
"BLD",9240,1,7,0)
4.      When editing the Drug on a Prescription and answering NO to Edit 
"BLD",9240,1,8,0)
the SIG prompt, the Dosage is not updated to match the Drug and SIG.
"BLD",9240,4,0)
^9.64PA^^0
"BLD",9240,6)
1^
"BLD",9240,6.3)
132
"BLD",9240,"ABPKG")
n
"BLD",9240,"KRN",0)
^9.67PA^779.2^20
"BLD",9240,"KRN",.4,0)
.4
"BLD",9240,"KRN",.401,0)
.401
"BLD",9240,"KRN",.402,0)
.402
"BLD",9240,"KRN",.403,0)
.403
"BLD",9240,"KRN",.5,0)
.5
"BLD",9240,"KRN",.84,0)
.84
"BLD",9240,"KRN",3.6,0)
3.6
"BLD",9240,"KRN",3.8,0)
3.8
"BLD",9240,"KRN",9.2,0)
9.2
"BLD",9240,"KRN",9.8,0)
9.8
"BLD",9240,"KRN",9.8,"NM",0)
^9.68A^21^13
"BLD",9240,"KRN",9.8,"NM",3,0)
PSODRGN^^0^B11617807
"BLD",9240,"KRN",9.8,"NM",4,0)
PSONEW1^^0^B18114075
"BLD",9240,"KRN",9.8,"NM",6,0)
PSOORED6^^0^B63254797
"BLD",9240,"KRN",9.8,"NM",7,0)
PSOORNE1^^0^B88261913
"BLD",9240,"KRN",9.8,"NM",10,0)
PSOORNW1^^0^B34134148
"BLD",9240,"KRN",9.8,"NM",12,0)
PSORXEDT^^0^B49246602
"BLD",9240,"KRN",9.8,"NM",15,0)
PSORXPR^^0^B30390926
"BLD",9240,"KRN",9.8,"NM",16,0)
PSOVER1^^0^B126916647
"BLD",9240,"KRN",9.8,"NM",17,0)
PSODPT^^0^B2911997
"BLD",9240,"KRN",9.8,"NM",18,0)
PSOHELP3^^0^B29022810
"BLD",9240,"KRN",9.8,"NM",19,0)
PSOORED1^^0^B76283215
"BLD",9240,"KRN",9.8,"NM",20,0)
PSODIR^^0^B42450394
"BLD",9240,"KRN",9.8,"NM",21,0)
PSOORNW2^^0^B49647517
"BLD",9240,"KRN",9.8,"NM","B","PSODIR",20)

"BLD",9240,"KRN",9.8,"NM","B","PSODPT",17)

"BLD",9240,"KRN",9.8,"NM","B","PSODRGN",3)

"BLD",9240,"KRN",9.8,"NM","B","PSOHELP3",18)

"BLD",9240,"KRN",9.8,"NM","B","PSONEW1",4)

"BLD",9240,"KRN",9.8,"NM","B","PSOORED1",19)

"BLD",9240,"KRN",9.8,"NM","B","PSOORED6",6)

"BLD",9240,"KRN",9.8,"NM","B","PSOORNE1",7)

"BLD",9240,"KRN",9.8,"NM","B","PSOORNW1",10)

"BLD",9240,"KRN",9.8,"NM","B","PSOORNW2",21)

"BLD",9240,"KRN",9.8,"NM","B","PSORXEDT",12)

"BLD",9240,"KRN",9.8,"NM","B","PSORXPR",15)

"BLD",9240,"KRN",9.8,"NM","B","PSOVER1",16)

"BLD",9240,"KRN",19,0)
19
"BLD",9240,"KRN",19.1,0)
19.1
"BLD",9240,"KRN",101,0)
101
"BLD",9240,"KRN",409.61,0)
409.61
"BLD",9240,"KRN",771,0)
771
"BLD",9240,"KRN",779.2,0)
779.2
"BLD",9240,"KRN",870,0)
870
"BLD",9240,"KRN",8989.51,0)
8989.51
"BLD",9240,"KRN",8989.52,0)
8989.52
"BLD",9240,"KRN",8994,0)
8994
"BLD",9240,"KRN","B",.4,.4)

"BLD",9240,"KRN","B",.401,.401)

"BLD",9240,"KRN","B",.402,.402)

"BLD",9240,"KRN","B",.403,.403)

"BLD",9240,"KRN","B",.5,.5)

"BLD",9240,"KRN","B",.84,.84)

"BLD",9240,"KRN","B",3.6,3.6)

"BLD",9240,"KRN","B",3.8,3.8)

"BLD",9240,"KRN","B",9.2,9.2)

"BLD",9240,"KRN","B",9.8,9.8)

"BLD",9240,"KRN","B",19,19)

"BLD",9240,"KRN","B",19.1,19.1)

"BLD",9240,"KRN","B",101,101)

"BLD",9240,"KRN","B",409.61,409.61)

"BLD",9240,"KRN","B",771,771)

"BLD",9240,"KRN","B",779.2,779.2)

"BLD",9240,"KRN","B",870,870)

"BLD",9240,"KRN","B",8989.51,8989.51)

"BLD",9240,"KRN","B",8989.52,8989.52)

"BLD",9240,"KRN","B",8994,8994)

"BLD",9240,"QDEF")
^^^^NO^^^^^^NO
"BLD",9240,"QUES",0)
^9.62^^
"BLD",9240,"REQB",0)
^9.611^4^3
"BLD",9240,"REQB",2,0)
PSO*7.0*291^2
"BLD",9240,"REQB",3,0)
PSO*7.0*427^2
"BLD",9240,"REQB",4,0)
PSO*7.0*411^2
"BLD",9240,"REQB","B","PSO*7.0*291",2)

"BLD",9240,"REQB","B","PSO*7.0*411",4)

"BLD",9240,"REQB","B","PSO*7.0*427",3)

"MBREQ")
0
"PKG",206,-1)
1^1
"PKG",206,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",206,20,0)
^9.402P^^
"PKG",206,22,0)
^9.49I^1^1
"PKG",206,22,1,0)
7.0^3021122^3021202^66481
"PKG",206,22,1,"PAH",1,0)
422^3161013^123456952
"PKG",206,22,1,"PAH",1,1,0)
^^8^8^3161013
"PKG",206,22,1,"PAH",1,1,1,0)
This patch will resolve the following issues:
"PKG",206,22,1,"PAH",1,1,2,0)
1.      If patient has Other Language Preference set to Yes and medication
"PKG",206,22,1,"PAH",1,1,3,0)
instructions are entered into Other Patient Instructions, this
"PKG",206,22,1,"PAH",1,1,4,0)
information will not print on the pharmacy fill part of the label.
"PKG",206,22,1,"PAH",1,1,5,0)
2.      Duplicate Prescriptions are active on a patients profile
"PKG",206,22,1,"PAH",1,1,6,0)
3.      Pharmacy staff can process their own prescriptions
"PKG",206,22,1,"PAH",1,1,7,0)
4.      When editing the Drug on a Prescription and answering NO to Edit 
"PKG",206,22,1,"PAH",1,1,8,0)
the SIG prompt, the Dosage is not updated to match the Drug and SIG.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
13
"RTN","PSODIR")
0^20^B42450394^B34430452
"RTN","PSODIR",1,0)
PSODIR ;BHAM ISC/SAB - asks data for rx order entry ; 9/17/07 5:03pm
"RTN","PSODIR",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**37,46,111,117,146,164,211,264,275,391,372,416,422**;DEC 1997;Build 132
"RTN","PSODIR",3,0)
 ;External reference PSDRUG( supported by DBIA 221
"RTN","PSODIR",4,0)
 ;External reference PS(50.7 supported by DBIA 2223
"RTN","PSODIR",5,0)
 ;External reference to VA(200 is supported by DBIA 10060
"RTN","PSODIR",6,0)
 ;----------------------------------------------------------------
"RTN","PSODIR",7,0)
 ;
"RTN","PSODIR",8,0)
PROV(PSODIR) ;
"RTN","PSODIR",9,0)
PROVEN ; Entry point for failed lookup
"RTN","PSODIR",10,0)
 K DIC,X,Y S:$G(PSOFDR)&($G(OR0)) DIC("B")=$P(^VA(200,$P($G(OR0),"^",5),0),"^")
"RTN","PSODIR",11,0)
 I '$D(PSODIR("CS")),$D(PSODRUG("DEA")) D
"RTN","PSODIR",12,0)
 .N DEA S PSODIR("CS")=0 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S PSODIR("CS")=1
"RTN","PSODIR",13,0)
 I $G(PSODIR("PROVIDER"))]"" S PSODIR("OLD VAL")=PSODIR("PROVIDER")
"RTN","PSODIR",14,0)
 S DIC="^VA(200,",DIC(0)="QEAM",PSODIR("FIELD")=0
"RTN","PSODIR",15,0)
 S DIC("W")="W ""     "",$P(^(""PS""),""^"",9)"
"RTN","PSODIR",16,0)
 S DIC("A")="PROVIDER: ",DIC("S")="I $D(^(""PS"")),$P(^(""PS""),""^""),$S('$P(^(""PS""),""^"",4):1,1:$P(^(""PS""),""^"",4)'<DT)"
"RTN","PSODIR",17,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" S DIC("S")=DIC("S")_",$P($G(^(""TPB"")),""^""),$P($G(^(""TPB"")),""^"",5)=0"
"RTN","PSODIR",18,0)
 S:$G(PSORX("PROVIDER NAME"))]"" DIC("B")=PSORX("PROVIDER NAME")
"RTN","PSODIR",19,0)
 D ^DIC K DIC
"RTN","PSODIR",20,0)
 I X[U,$L(X)>1 D:'$G(PSOEDIT) JUMP G PROVX
"RTN","PSODIR",21,0)
 I $D(DTOUT)!$D(DUOUT) S PSODIR("DFLG")=1 G PROVX
"RTN","PSODIR",22,0)
 I '$G(SPEED),Y=-1 G PROVEN
"RTN","PSODIR",23,0)
 Q:$G(SPEED)&(Y=-1)
"RTN","PSODIR",24,0)
 ;PSO*7*211; ADD CHECK FOR DEA# AND VA#
"RTN","PSODIR",25,0)
 I $P($G(PSODIR("CS")),"^",1)!($D(CLOZPAT)) N NDEA,SDEA S SDEA=$$DRGSCH() S NDEA=$$SDEA^XUSER(0,+Y,SDEA) I $L($P(NDEA,"^"))<3 D  G PROVEN
"RTN","PSODIR",26,0)
 .I NDEA=2 W $C(7),!!,"Provider not authorized to write Federal Schedule "_SDEA_" prescriptions.",! Q
"RTN","PSODIR",27,0)
 .W $C(7),!!,"Provider must have a DEA# or VA# to write prescriptions for this drug.",!
"RTN","PSODIR",28,0)
 ;PSO*7.0*391; Added check for DETOX#
"RTN","PSODIR",29,0)
 I $$DETOX^PSSOPKI($G(PSODRUG("IEN"))),$$DETOX^XUSER(+Y)="" W $C(7),!!,"Provider must have a DETOX# to order this drug.",! G PROVEN
"RTN","PSODIR",30,0)
 I $D(CLOZPAT),'$D(^XUSEC("YSCL AUTHORIZED",+Y)) D  G PROVEN
"RTN","PSODIR",31,0)
 .W $C(7),!!,"Provider must hold YSCL AUTHORIZED key to write prescriptions for clozapine.",!
"RTN","PSODIR",32,0)
 I '$G(PSODRUG("IEN")),'$G(PSORENW("DRUG IEN")) G NODRUG
"RTN","PSODIR",33,0)
NODRUG S PSODIR("PROVIDER")=+Y
"RTN","PSODIR",34,0)
 S (PSODIR("PROVIDER NAME"),PSORX("PROVIDER NAME"))=$P(Y,"^",2)
"RTN","PSODIR",35,0)
 I $G(PSODIR("OLD VAL"))'=+Y K PSODIR("GENERIC PROVIDER"),PSODIR("COSIGNING PROVIDER")
"RTN","PSODIR",36,0)
 I $G(PSODIR("OLD VAL"))'=$G(PSODIR("PROVIDER")),$P(Y,"^",2)="PROVIDER,OTHER"!($P(Y,"^",2)="PROVIDER,OUTSIDE") D GENERIC
"RTN","PSODIR",37,0)
 I $P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",7),$P(^("PS"),"^",8) D COSIGN
"RTN","PSODIR",38,0)
 I $G(PSODIR("COSIGNING PROVIDER")),'$P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",7) K PSODIR("COSIGNING PROVIDER")
"RTN","PSODIR",39,0)
PROVX K X,Y
"RTN","PSODIR",40,0)
 Q
"RTN","PSODIR",41,0)
 ;
"RTN","PSODIR",42,0)
DRGSCH() ; determine the drug schedule
"RTN","PSODIR",43,0)
 N ND3,SCH
"RTN","PSODIR",44,0)
 S SCH="",ND3=$P($G(^PSDRUG(PSODRUG("IEN"),"ND")),"^",3) S:+ND3 SCH=$$GET1^DIQ(50.68,ND3,19,"I")
"RTN","PSODIR",45,0)
 I +SCH>0!($G(PSODRUG("DEA"))="") Q SCH
"RTN","PSODIR",46,0)
 I "^4^5^"[+PSODRUG("DEA") Q +PSODRUG("DEA")
"RTN","PSODIR",47,0)
 Q $S($G(PSODRUG("DEA"))["A":+PSODRUG("DEA"),1:+PSODRUG("DEA")_"n")
"RTN","PSODIR",48,0)
 ;
"RTN","PSODIR",49,0)
GENERIC ;
"RTN","PSODIR",50,0)
 K DIR,DIC,PSODIR("GENERIC PROVIDER")
"RTN","PSODIR",51,0)
 S DIR(0)="52,30"
"RTN","PSODIR",52,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") GENERICX
"RTN","PSODIR",53,0)
 S PSODIR("GENERIC PROVIDER")=Y
"RTN","PSODIR",54,0)
GENERICX K X,Y
"RTN","PSODIR",55,0)
 Q
"RTN","PSODIR",56,0)
 ;
"RTN","PSODIR",57,0)
COSIGN ;
"RTN","PSODIR",58,0)
 K DIC
"RTN","PSODIR",59,0)
 I '$G(PSODIR("COSIGNING PROVIDER")),$P($G(RX3),"^",3) S PSODIR("COSIGNING PROVIDER")=$P(RX3,"^",3) G COSIGN1
"RTN","PSODIR",60,0)
 I $P($G(RX3),"^",3),$P($G(RX3),"^",3)'=$P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",8) D
"RTN","PSODIR",61,0)
 .W !!,"Previous Co-Signing Provider: "_$P(^VA(200,$P(RX3,"^",3),0),"^")
"RTN","PSODIR",62,0)
 .S PSODIR("COSIGNING PROVIDER")=$S($P(RX3,"^",3)'=PSODIR("COSIGNING PROVIDER"):PSODIR("COSIGNING PROVIDER"),1:$P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",8))
"RTN","PSODIR",63,0)
COSIGN1 S DIC(0)="QEAM",DIC="^VA(200,",DIC("B")=$S($G(PSODIR("COSIGNING PROVIDER")):$P(^VA(200,PSODIR("COSIGNING PROVIDER"),0),"^"),1:$P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",8))
"RTN","PSODIR",64,0)
 S DIC("S")="I $D(^(""PS"")),$P(^(""PS""),""^""),$S('$P(^(""PS""),""^"",4):1,1:$P(^(""PS""),""^"",4)'<DT)"
"RTN","PSODIR",65,0)
 S DIC("W")="W ""     "",$P(^(""PS""),""^"",9)",DIC("S")=DIC("S")_",'$P(^(""PS""),""^"",7)"
"RTN","PSODIR",66,0)
 S DIC("A")="COSIGNING PROVIDER: " D ^DIC K DIC
"RTN","PSODIR",67,0)
 I $D(DTOUT)!$D(DUOUT) S PSODIR("DFLG")=1 G COSIGNX
"RTN","PSODIR",68,0)
 S:+Y>0 PSODIR("COSIGNING PROVIDER")=+Y G:Y<0 COSIGN
"RTN","PSODIR",69,0)
COSIGNX K X,Y
"RTN","PSODIR",70,0)
 Q
"RTN","PSODIR",71,0)
DOSE(PSODIR) ;add dosing info
"RTN","PSODIR",72,0)
 N PSODOSNW S PSODOSNW=1
"RTN","PSODIR",73,0)
 D DOSE1^PSOORED5(.PSODIR)
"RTN","PSODIR",74,0)
EX K PSODOSE,PSOSCH,DOSE,DOOR,SCH,VERB,NOUN,DOSEOR,ENT,PSORTE,DRUA,DIR,X,Y,DIRUT,RTE,ERTE,DD,INS1,SINS1
"RTN","PSODIR",75,0)
 Q
"RTN","PSODIR",76,0)
INS(PSODIR) ;patient instructions
"RTN","PSODIR",77,0)
 N DA
"RTN","PSODIR",78,0)
 K INS1,DD,DIR,DIRUT S D=0 F  S D=$O(PSODIR("SIG",D)) Q:'D  S DD=$G(DD)+1
"RTN","PSODIR",79,0)
 I $G(DD)=1 S PSODIR("INS")=$G(PSODIR("SIG",1)) G INSD
"RTN","PSODIR",80,0)
 ;PSO*7*275 remove check for PSOINSFL just check for multi line sig
"RTN","PSODIR",81,0)
 I $G(DD)>1 D  G EX
"RTN","PSODIR",82,0)
 .K ^TMP($J) S D=0 F  S D=$O(PSODIR("SIG",D)) Q:'D  S ^TMP($J,"SIG",D,0)=PSODIR("SIG",D)
"RTN","PSODIR",83,0)
 .S DWPK=2,DWLW=80,DIC="^TMP($J,""SIG""," D EN^DIWE K PSODIR("SIG")
"RTN","PSODIR",84,0)
 .S D=0 F  S D=$O(^TMP($J,"SIG",D)) Q:'D  S PSODIR("SIG",D)=^TMP($J,"SIG",D,0)
"RTN","PSODIR",85,0)
 .D EN^PSOFSIG(.PSODIR,1) K DWLW,D,DWPK,^TMP($J)
"RTN","PSODIR",86,0)
 I $G(PSOINSFL)=0 G INSD
"RTN","PSODIR",87,0)
 I $G(PSOFDR),$G(ORD),$P($G(^PS(52.41,+$G(ORD),"EXT")),"^")'="" G INSD
"RTN","PSODIR",88,0)
 I $G(PSODIR("INS"))']"",$G(^PS(50.7,PSODRUG("OI"),"INS"))]"",'$D(PSODIR("FLD",114)) S (DIR("B"),PSOOEINS)=^PS(50.7,PSODRUG("OI"),"INS") G INSD  ;*422
"RTN","PSODIR",89,0)
 S (DIR("B"),PSOOEINS)=$G(PSODIR("SIG",1))  ;*422
"RTN","PSODIR",90,0)
INSD S DIR(0)="52,114" S:$G(PSODIR("INS"))]"" DIR("B")=PSODIR("INS")
"RTN","PSODIR",91,0)
 D DIR
"RTN","PSODIR",92,0)
 I $G(PSODIR("DFLG")) S (PSODIR("INS"),PSODIR("SIG"),PSODIR("SIG",1))=$G(PSOOEINS),PSODIR("SINS")=$G(PSOOSINS) D EN^PSOFSIG(.PSODIR,0)
"RTN","PSODIR",93,0)
 G:$G(PSODIR("DFLG"))!(PSODIR("FIELD")) EX
"RTN","PSODIR",94,0)
 I X'="",X'="@" S PSODIR("INS")=Y D SIG^PSOHELP G INSD:'$D(X)
"RTN","PSODIR",95,0)
 I $G(INS1)]"" D EN^DDIOL($E(INS1,2,9999999)) S (PSODIR("SIG",1),PSODIR("SIG"))=$E(INS1,2,9999999)
"RTN","PSODIR",96,0)
 I X="@" S PSODELINS=1 D DELINS^PSOHELP3 I $G(PSODELINS) S (PSODIR("FLD",114),PSODIR("FLD",114.1))="" K PSODIR("INS"),PSODIR("SIG"),PSODIR("SINS")  ;*422
"RTN","PSODIR",97,0)
 D EN^PSOFSIG(.PSODIR,1) I $O(SIG(0)) S SIGOK=1
"RTN","PSODIR",98,0)
 G EX
"RTN","PSODIR",99,0)
 Q
"RTN","PSODIR",100,0)
SINS(PSODIR) ;other lang. patient instructions
"RTN","PSODIR",101,0)
 K SINS1,DIR
"RTN","PSODIR",102,0)
 S DIR(0)="52,114.1" S:$G(PSODIR("SINS"))]"" DIR("B")=PSODIR("SINS")
"RTN","PSODIR",103,0)
 I $G(PSODIR("SINS"))']"",$G(^PS(50.7,PSODRUG("OI"),"INS1"))]"",'$D(PSODIR("FLD",114)),$G(PSOOEINS)]"" S (DIR("B"),PSOOSINS)=^PS(50.7,PSODRUG("OI"),"INS1")
"RTN","PSODIR",104,0)
 D DIR I $G(PSODIR("DFLG")) S (PSODIR("INS"),PSODIR("SIG"),PSODIR("SIG",1))=$G(PSOOEINS),PSODIR("SINS")=$G(PSOOSINS) D EN^PSOFSIG(.PSODIR,0) G EX
"RTN","PSODIR",105,0)
 I X'="",X'="@" S PSODIR("SINS")=Y D SSIG^PSOHELP
"RTN","PSODIR",106,0)
 I $G(SINS1)]"" D EN^DDIOL($E(SINS1,2,9999999)) S PSODIR("SINS")=$E(SINS1,2,9999999)
"RTN","PSODIR",107,0)
 I X="@" S PSODELINS=2 D DELINS^PSOHELP3 I $G(PSODELINS) S (PSODIR("FLD",114),PSODIR("FLD",114.1))="" K PSODIR("INS"),PSODIR("SIG"),PSODIR("SINS") D EN^PSOFSIG(.PSODIR,1) ;*422
"RTN","PSODIR",108,0)
 G EX
"RTN","PSODIR",109,0)
 Q
"RTN","PSODIR",110,0)
 ;
"RTN","PSODIR",111,0)
DIR ;
"RTN","PSODIR",112,0)
 S PSODIR("FIELD")=0
"RTN","PSODIR",113,0)
 G:$G(DIR(0))']"" DIRX
"RTN","PSODIR",114,0)
 D ^DIR K DIR,DIE,DIC,DA
"RTN","PSODIR",115,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)),$L($G(X))'>1 S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR",116,0)
 I X[U,$L(X)>1 D:'$G(PSOEDIT) JUMP
"RTN","PSODIR",117,0)
DIRX K DIRUT,DTOUT,DUOUT,DIROUT,PSOX
"RTN","PSODIR",118,0)
 Q
"RTN","PSODIR",119,0)
 ;
"RTN","PSODIR",120,0)
JUMP ;
"RTN","PSODIR",121,0)
 I $G(PSOEDIT)!($G(OR0)) S PSODIR("DFLG")=1 Q
"RTN","PSODIR",122,0)
 S X=$P(X,"^",2),DIC="^DD(52,",DIC(0)="QM" D ^DIC K DIC
"RTN","PSODIR",123,0)
 I Y=-1 S PSODIR("FIELD")=$G(PSODIR("FLD")) G JUMPX
"RTN","PSODIR",124,0)
 I $G(PSONEW1)=0 D JUMP^PSONEW1 G JUMPX
"RTN","PSODIR",125,0)
 I $G(PSOREF1)=0 D JUMP^PSOREF1 G JUMPX
"RTN","PSODIR",126,0)
 I $G(PSONEW3)=0 D JUMP^PSONEW3 G JUMPX
"RTN","PSODIR",127,0)
 I $G(PSORENW3)=0 D JUMP^PSORENW3 G JUMPX
"RTN","PSODIR",128,0)
JUMPX S X="^"_X
"RTN","PSODIR",129,0)
 Q
"RTN","PSODPT")
0^17^B2911997^B2714408
"RTN","PSODPT",1,0)
PSODPT ;BIR/MFR - CENTRALIZED PATIENT LOOKUP FOR OP ;07/15/03
"RTN","PSODPT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**139,185,422**;DEC 1997;Build 132
"RTN","PSODPT",3,0)
 ;Ref. ^DGSEC4 supp. IA 3027
"RTN","PSODPT",4,0)
 ;Ref. MPIQQ^MPIFAPI supp. IA 3300
"RTN","PSODPT",5,0)
 ;
"RTN","PSODPT",6,0)
CHK(DFN,DISP,PAUSE) ; Security Check for Patient Selection
"RTN","PSODPT",7,0)
 ;Input: DFN   - Patient IEN ^ Patient Name
"RTN","PSODPT",8,0)
 ;       DISP  - Display Messages Flag
"RTN","PSODPT",9,0)
 ;       PAUSE - Pause Flag
"RTN","PSODPT",10,0)
 N RESULT,RES,CHK
"RTN","PSODPT",11,0)
 S DISP=$G(DISP),PAUSE=$G(PAUSE),CHK=+DFN D ICN(CHK)
"RTN","PSODPT",12,0)
 D PTSEC^DGSEC4(.RESULT,$P(DFN,"^"),1)
"RTN","PSODPT",13,0)
 I RESULT(1)'=0 D
"RTN","PSODPT",14,0)
 . W !! I DISP W ?(80-$L($P(DFN,"^",2)))\2,$P(DFN,"^",2),!
"RTN","PSODPT",15,0)
 . I RESULT(1)=3 S:$G(RX0) RESULT(3)="(RX# "_+RX0_")"  ;*422
"RTN","PSODPT",16,0)
 . F I=2:1:9 I $D(RESULT(I)) W ?(80-$L(RESULT(I)))\2,RESULT(I),!
"RTN","PSODPT",17,0)
 . I RESULT(1)'=0,RESULT(1)'=2,PAUSE H 1
"RTN","PSODPT",18,0)
 . Q:RESULT(1)=1
"RTN","PSODPT",19,0)
 . I RESULT(1)=-1!(RESULT(1)=3)!(RESULT(1)=4) S CHK=-1 Q
"RTN","PSODPT",20,0)
 . I RESULT(1)=2 D ENCONT I CHK=-1 Q
"RTN","PSODPT",21,0)
 . D NOTICE^DGSEC4(.RES,DFN,XQY0,$S(RESULT(1)=1:1,1:3))
"RTN","PSODPT",22,0)
 . I RES=0 S CHK=-1 Q
"RTN","PSODPT",23,0)
 H 1 Q CHK
"RTN","PSODPT",24,0)
ENCONT W !,"Do you want to continue processing this patient record"
"RTN","PSODPT",25,0)
 S %=2 D YN^DICN I %<0!(%=2) S CHK=-1
"RTN","PSODPT",26,0)
 I '% W !!,"Enter 'YES' to continue processing, or 'NO' to quit processing this record." G ENCONT
"RTN","PSODPT",27,0)
 Q
"RTN","PSODPT",28,0)
MSG ;
"RTN","PSODPT",29,0)
 W !,$C(7),"Outpatient Division MUST be selected!",!
"RTN","PSODPT",30,0)
 Q
"RTN","PSODPT",31,0)
ICN(X) ;
"RTN","PSODPT",32,0)
 Q:'$G(X)
"RTN","PSODPT",33,0)
 Q:'$D(^DPT(X,0))
"RTN","PSODPT",34,0)
 I +$$GETICN^MPIF001(X)<1 N Y S Y=$$MPIQQ^MPIFAPI(X) K Y
"RTN","PSODPT",35,0)
 Q
"RTN","PSODRGN")
0^3^B11617807^B12292884
"RTN","PSODRGN",1,0)
PSODRGN ;BIR/SJA-ORDER ENTRY DRUG SELECTION ;02/15/07
"RTN","PSODRGN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**268,422**;DEC 1997;Build 132
"RTN","PSODRGN",3,0)
 ;Reference ^PSDRUG supported by DBIA 221
"RTN","PSODRGN",4,0)
 ;
"RTN","PSODRGN",5,0)
SELECT ;
"RTN","PSODRGN",6,0)
 K:'$G(PSORXED) CLOZPAT
"RTN","PSODRGN",7,0)
 K DIC,X,Y,PSODRUG("TRADE NAME"),PSODRUG("NDC"),PSODRUG("DAW") S:$G(POERR)&($P($G(OR0),"^",9)) Y=$P(^PSDRUG($P(OR0,"^",9),0),"^")
"RTN","PSODRGN",8,0)
 I $G(PSODRUG("IEN"))]"" S Y=PSODRUG("NAME"),PSONEW("OLD VAL")=PSODRUG("IEN")
"RTN","PSODRGN",9,0)
 S (PSDC,PSI)=0 W !!!,"The following Drug(s) are available for selection:"
"RTN","PSODRGN",10,0)
 F PSI=0:0 S PSI=$O(^PSDRUG("ASP",PSODRUG("OI"),PSI)) Q:'PSI  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["O":0,1:1) D
"RTN","PSODRGN",11,0)
 .S PSDC=PSDC+1 W !,PSDC_". "_$P(^PSDRUG(PSI,0),"^")_$S($P(^(0),"^",9):"     (N/F)",1:"")
"RTN","PSODRGN",12,0)
 .S PSDC(PSDC)=PSI
"RTN","PSODRGN",13,0)
 I PSDC=0 D
"RTN","PSODRGN",14,0)
 .N X,DRG
"RTN","PSODRGN",15,0)
 .S DRG=+$P($G(^PSRX(DA,0)),"^",6)
"RTN","PSODRGN",16,0)
 .S X=$$GET1^DIQ(50,DRG,100)
"RTN","PSODRGN",17,0)
 .I X'="",(DT>X) D
"RTN","PSODRGN",18,0)
 .. W !!,"   This Dispense Drug is now Inactive. You may select a"
"RTN","PSODRGN",19,0)
 .. W !,"    new Orderable Item, or you can enter a new Order with"
"RTN","PSODRGN",20,0)
 .. W !,"    an Active Drug.",!
"RTN","PSODRGN",21,0)
 .E  W !!,"No drugs available!",!
"RTN","PSODRGN",22,0)
 .K DIR S DIR(0)="E",DIR("A")="Press return to continue"
"RTN","PSODRGN",23,0)
 .D ^DIR K DIR
"RTN","PSODRGN",24,0)
 G:'PSDC ETX K PSOBDR S PSOBDR("NAME")=PSODRUG("NAME")
"RTN","PSODRGN",25,0)
 I PSDC'=1 D
"RTN","PSODRGN",26,0)
 .I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),2)),"^")=$G(PSODRUG("OI")) Q
"RTN","PSODRGN",27,0)
 .K PSODRUG("NAME"),PSODRUG("IEN")
"RTN","PSODRGN",28,0)
 W ! D KV S DIR(0)="N^1:"_PSDC,DIR("A")="Select Drug by number" D ^DIR
"RTN","PSODRGN",29,0)
 I $G(PSORXED),X["^" S PSORXED("DFLG")=1 G SELECTX
"RTN","PSODRGN",30,0)
 I +$G(PSOEDIT)=1,X="^"!(X["^^")!($D(DTOUT)) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODRGN",31,0)
 I '$G(POERR),X[U,$L(X)>1 S PSODIR("FLD")=PSONEW("FLD") D JUMP^PSODIR1 S:$G(PSODIR("FIELD")) PSONEW("FIELD")=PSODIR("FIELD") K PSODIR S PSODRG("QFLG")=1 G SELECTX
"RTN","PSODRGN",32,0)
 I +$G(PSOEDIT)=1,$D(DTOUT) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODRGN",33,0)
 I $D(DUOUT) K DUOUT G SELECT
"RTN","PSODRGN",34,0)
 I Y<0 G SELECT
"RTN","PSODRGN",35,0)
 S:$G(PSONEW("OLD VAL"))=+Y&('$G(PSOEDIT)) PSODRG("QFLG")=1
"RTN","PSODRGN",36,0)
 D KV K PSOY S PSOY(0)=^PSDRUG(PSDC(Y),0),PSOY=PSDC(Y)_"^"_$P(PSOY(0),"^")
"RTN","PSODRGN",37,0)
 I $P(PSOY(0),"^")="OTHER DRUG"!($P(PSOY(0),"^")="OUTSIDE DRUG") D TRADE
"RTN","PSODRGN",38,0)
SELECTX K X,Y,DTOUT,DUOUT,PSDC,PSI,PSONEW("OLD VAL")
"RTN","PSODRGN",39,0)
 Q
"RTN","PSODRGN",40,0)
TRADE ;
"RTN","PSODRGN",41,0)
 K DIR,DIC,DA,X,Y
"RTN","PSODRGN",42,0)
 S DIR(0)="52,6.5" S:$G(PSOTRN)]"" DIR("B")=$G(PSOTRN) D ^DIR K DIR,DIC
"RTN","PSODRGN",43,0)
 I X="@" S Y=X K DIRUT
"RTN","PSODRGN",44,0)
 I $D(DIRUT) S:$D(DUOUT)!$D(DTOUT)&('$D(PSORX("EDIT"))) PSONEW("DFLG")=1 G TRADEX
"RTN","PSODRGN",45,0)
 S PSODRUG("TRADE NAME")=Y
"RTN","PSODRGN",46,0)
TRADEX I $G(PSORXED("DFLG")),$D(DIRUT) S PSORXED("DFLG")=1
"RTN","PSODRGN",47,0)
 K DIRUT,DTOUT,DUOUT,X,Y,DA,DR,DIE
"RTN","PSODRGN",48,0)
 Q
"RTN","PSODRGN",49,0)
ETX S VALMBCK="R" I 'PSDC S VALMSG="NO dispense drugs tied to this orderable item!"
"RTN","PSODRGN",50,0)
TX D KV K PSDC,PSI,X,Y
"RTN","PSODRGN",51,0)
 Q
"RTN","PSODRGN",52,0)
KV K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSODRGN",53,0)
 Q
"RTN","PSODRGN",54,0)
6 ;Called from PSOBKDED due to it's routine size.
"RTN","PSODRGN",55,0)
 I $G(PSOEDIT),$G(PSODRUG("NAME"))'=$G(PSOBDR("NAME")) D
"RTN","PSODRGN",56,0)
 .S PSOXXX(1)="You have changed the dispense drug from",PSOXXX(2)=$P($G(PSOBDR("NAME")),"^")_" to "_$P($G(PSODRUG("NAME")),"^")_"." D EN^DDIOL(.PSOXXX,"","!") S PSOAC=1
"RTN","PSODRGN",57,0)
 .K PSOBDR D 10^PSOBKDED ;Dose
"RTN","PSODRGN",58,0)
 Q
"RTN","PSOHELP3")
0^18^B29022810^B22564080
"RTN","PSOHELP3",1,0)
PSOHELP3 ;BHAM ISC/SAB - outpatient utility routine #4 ;2/17/93 18:00:36
"RTN","PSOHELP3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,291,422**;DEC 1997;Build 132
"RTN","PSOHELP3",3,0)
XREF ;code to create 'APD' xref on Drug Interaction file (#56)
"RTN","PSOHELP3",4,0)
 ;I '$D(ZTSK),'$D(PSMSG) D WAIT^DICD W "Building 'APD' X-Ref."
"RTN","PSOHELP3",5,0)
 ;The following code accessing files 56 and 50.416 is no longer executed
"RTN","PSOHELP3",6,0)
 S ID1=$P(^PS(56,DA,0),"^",2),ID2=$P(^(0),"^",3),TOT=0
"RTN","PSOHELP3",7,0)
 F I1=0:0 S I1=$O(^PS(50.416,ID1,1,I1)) Q:'I1  S R2=$P(^(I1,0),"^") F I2=0:0 S I2=$O(^PS(50.416,ID2,1,I2)) Q:'I2  S D2=$P(^(I2,0),"^") W:+$G(PSMSG) "." D SEC
"RTN","PSOHELP3",8,0)
 F I1=0:0 S I1=$O(^PS(50.416,"APS",ID1,I1)) Q:'I1  F I3=0:0 S I3=$O(^PS(50.416,I1,1,I3)) Q:'I3  S R2=$P(^(I3,0),"^") F I5=0:0 S I5=$O(^PS(50.416,"APS",ID2,I5)) Q:'I5  F I6=0:0 S I6=$O(^PS(50.416,I5,1,I6)) Q:'I6  S D2=$P(^(I6,0),"^") D SEC
"RTN","PSOHELP3",9,0)
 F I1=0:0 S I1=$O(^PS(50.416,ID1,1,I1)) Q:'I1  S R2=$P(^(I1,0),"^") F I5=0:0 S I5=$O(^PS(50.416,"APS",ID2,I5)) Q:'I5  F I6=0:0 S I6=$O(^PS(50.416,I5,1,I6)) Q:'I6  S D2=$P(^(I6,0),"^") D SEC
"RTN","PSOHELP3",10,0)
 F I2=0:0 S I2=$O(^PS(50.416,ID2,1,I2)) Q:'I2  S D2=$P(^(I2,0),"^") F I1=0:0 S I1=$O(^PS(50.416,"APS",ID1,I1)) Q:'I1  F I3=0:0 S I3=$O(^PS(50.416,I1,1,I3)) Q:'I3  S R2=$P(^(I3,0),"^") D SEC
"RTN","PSOHELP3",11,0)
 S $P(^PS(56,DA,0),"^",6)=TOT
"RTN","PSOHELP3",12,0)
EX K TOT,I5,I6,D2,I4,I3,PRI,I1,I2,R2,PS1,PS2,ID2,ID1
"RTN","PSOHELP3",13,0)
 Q
"RTN","PSOHELP3",14,0)
SEC I +$G(DEL) K ^PS(56,"APD",R2,D2,DA),^PS(56,"APD",D2,R2,DA) Q
"RTN","PSOHELP3",15,0)
 S ^PS(56,"APD",R2,D2,DA)="",^PS(56,"APD",D2,R2,DA)="",TOT=TOT+2
"RTN","PSOHELP3",16,0)
 Q
"RTN","PSOHELP3",17,0)
DRUG ;selects drug and updates Rx file with cost (pso*7*20)
"RTN","PSOHELP3",18,0)
 W !!,"This option will update the drug cost on all fills in the PRESCRIPTION"
"RTN","PSOHELP3",19,0)
 W !,"file (#52) based on the selected date range and the current cost in the"
"RTN","PSOHELP3",20,0)
 W !,"DRUG file (#50).",!
"RTN","PSOHELP3",21,0)
 K X,Y,DA,DIC S DIC(0)="AQEM",DIC=50 D ^DIC I $G(DUOUT) K DIC,Y,X,DA Q
"RTN","PSOHELP3",22,0)
 I Y<0 G OUT
"RTN","PSOHELP3",23,0)
 S (DRG,DA)=+Y K DIC,DR,DIQ S DIC=50,DR=16,DIQ="PSODRG",DIQ(0)="I"
"RTN","PSOHELP3",24,0)
 D EN^DIQ1 S COST=PSODRG(50,DA,16,"I") K PSODRG,DIC,DA,DR,DIQ,DIR
"RTN","PSOHELP3",25,0)
 W ! S DIR("A")="Do you want to exclude Refills and Partials",DIR(0)="Y",DIR("B")="No" D ^DIR K DIR I $G(DIRUT) K COST,X,DRG,Y Q
"RTN","PSOHELP3",26,0)
 S REF=$S(Y:0,1:1)
"RTN","PSOHELP3",27,0)
 S X1=DT,X2=-485 D C^%DTC S (DEF,Y)=X X ^DD("DD")
"RTN","PSOHELP3",28,0)
 W !!,"You can only go back One Year plus 120 days."
"RTN","PSOHELP3",29,0)
 S %DT(0)=DEF,%DT="AQEX",%DT("A")="Enter starting fill date: ",%DT("B")=Y D ^%DT K %DT("B"),DEF I Y<0!($D(DTOUT)) K REF,COST,DRG,X,Y Q
"RTN","PSOHELP3",30,0)
 S (FBCK,%DT(0))=Y,%DT("A")="Enter ending fill date: " D ^%DT
"RTN","PSOHELP3",31,0)
 K %DT I Y<0!($D(DTOUT)) K FBCK,REF,COST,DRG,X,Y Q
"RTN","PSOHELP3",32,0)
 S FAHD=Y
"RTN","PSOHELP3",33,0)
 S PSOFUTR=0 I FAHD>(DT-1) S PSOFUTR=1 D
"RTN","PSOHELP3",34,0)
 .W !!,"Since you selected an end fill date of today or in the future, this option"
"RTN","PSOHELP3",35,0)
 .W !,"will update the cost for all existing and suspended fills that have a"
"RTN","PSOHELP3",36,0)
 .W !,"fill date in the future.",!
"RTN","PSOHELP3",37,0)
 K DIR,X,Y S DIR(0)="Y",DIR("A")="Do you want to Queue to run at a specific Time",DIR("B")="Yes" D ^DIR K DIR I $D(DIRUT) G OUT
"RTN","PSOHELP3",38,0)
 I Y S PSOQ=1 K ZTDTH D  G OUT
"RTN","PSOHELP3",39,0)
 .S ZTRTN="EN^PSOHELP3",ZTIO="",ZTDESC="Outpatient Pharmacy Rx Cost Update"
"RTN","PSOHELP3",40,0)
 .F G="REF","COST","DRG","FBCK","FAHD","PSOQ","PSOFUTR" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOHELP3",41,0)
 .D ^%ZTLOAD I $D(ZTSK) W !!,"Rxs Cost Update Queued",! K ZTSK
"RTN","PSOHELP3",42,0)
EN W:'$G(PSOQ) !,"Updating cost. Please wait... "
"RTN","PSOHELP3",43,0)
 S FDT=FBCK-1 F  S FDT=$O(^PSRX("ADL",FDT)) Q:'FDT  D  Q:FDT>FAHD
"RTN","PSOHELP3",44,0)
 .I '$G(PSOFUTR) I FDT>FAHD Q
"RTN","PSOHELP3",45,0)
 .S RXN=0 F  S RXN=$O(^PSRX("ADL",FDT,DRG,RXN)) Q:'RXN  D  W:'$G(PSOQ) "."
"RTN","PSOHELP3",46,0)
 ..I $P($G(^PSRX(RXN,0)),"^",6)=DRG,$P($G(^(2)),"^",2)=FDT S $P(^PSRX(RXN,0),"^",17)=COST
"RTN","PSOHELP3",47,0)
 I 'REF G OUT
"RTN","PSOHELP3",48,0)
 D REFILL,PARTIAL
"RTN","PSOHELP3",49,0)
OUT K G,COST,I,X,Y,REF,RXN,FDT,FAHD,FBCK,DRG,PSOQ,DIRUT,PSOFUTR I $D(ZTQUEUED) S ZTREQ="@"
"RTN","PSOHELP3",50,0)
 Q
"RTN","PSOHELP3",51,0)
POST ;post install entry point.  builds new "ADL" xref for file 52 pso*7*20
"RTN","PSOHELP3",52,0)
 S ZTRTN="EN1^PSOHELP3",ZTIO="",ZTDESC="Outpatient Pharmacy Rx XREF Update"
"RTN","PSOHELP3",53,0)
 S ZTDTH=$H D ^%ZTLOAD I $D(ZTSK) D BMES^XPDUTL(" Post Install Background Job Queued.") K ZTSK
"RTN","PSOHELP3",54,0)
 Q
"RTN","PSOHELP3",55,0)
EN1 K ^PSRX("ADL") S X1=DT,X2=-485 D C^%DTC S DEF=X-1 W !,"DEF: "_DEF
"RTN","PSOHELP3",56,0)
 F  S DEF=$O(^PSRX("AD",DEF)) Q:'DEF  F IFN=0:0 S IFN=$O(^PSRX("AD",DEF,IFN)) Q:'IFN  S FTY="" F  S FTY=$O(^PSRX("AD",DEF,IFN,FTY)) Q:FTY=""  I FTY=0 D
"RTN","PSOHELP3",57,0)
 .I $P($G(^PSRX(IFN,2)),"^",2),$P($G(^(0)),"^",6) S ^PSRX("ADL",$P($G(^PSRX(IFN,2)),"^",2),$P($G(^(0)),"^",6),IFN)=""
"RTN","PSOHELP3",58,0)
 K X,Y,DEF,FTY,IFN S ZTREQ="@"
"RTN","PSOHELP3",59,0)
 Q
"RTN","PSOHELP3",60,0)
REFILL ;
"RTN","PSOHELP3",61,0)
 N FILL,FDT,RXN
"RTN","PSOHELP3",62,0)
 S FDT=FBCK-1 F  S FDT=$O(^PSRX("AD",FDT)) Q:'FDT  D  Q:FDT>FAHD
"RTN","PSOHELP3",63,0)
 .I '$G(PSOFUTR),FDT>FAHD Q
"RTN","PSOHELP3",64,0)
 .S RXN="" F  S RXN=$O(^PSRX("AD",FDT,RXN)) Q:'RXN  D
"RTN","PSOHELP3",65,0)
 ..I $P($G(^PSRX(RXN,0)),"^",6)'=DRG Q
"RTN","PSOHELP3",66,0)
 ..S FILL=0 F  S FILL=$O(^PSRX("AD",FDT,RXN,FILL)) Q:'FILL  I $D(^PSRX(RXN,1,FILL,0)) S $P(^(0),"^",11)=COST
"RTN","PSOHELP3",67,0)
 Q
"RTN","PSOHELP3",68,0)
PARTIAL ;
"RTN","PSOHELP3",69,0)
  N FILL,FDT,RXN
"RTN","PSOHELP3",70,0)
  S FDT=FBCK-1 F  S FDT=$O(^PSRX("ADP",FDT)) Q:'FDT  D  Q:FDT>FAHD
"RTN","PSOHELP3",71,0)
 .I '$G(PSOFUTR),FDT>FAHD Q
"RTN","PSOHELP3",72,0)
 .S RXN="" F  S RXN=$O(^PSRX("ADP",FDT,RXN)) Q:'RXN  D
"RTN","PSOHELP3",73,0)
 ..I $P($G(^PSRX(RXN,0)),"^",6)'=DRG Q
"RTN","PSOHELP3",74,0)
 ..S FILL=0 F  S FILL=$O(^PSRX("ADP",FDT,RXN,FILL)) Q:'FILL  I $D(^PSRX(RXN,"P",FILL,0)) S $P(^(0),"^",11)=COST
"RTN","PSOHELP3",75,0)
 Q
"RTN","PSOHELP3",76,0)
INSCHK(PSOINS) ;CHECK PATIENT INSTRUCTIONS/OTHER PATIENT INSTRUCTIONS  ;*422
"RTN","PSOHELP3",77,0)
 I '$P($G(^PS(55,PSODFN,"LAN")),"^") Q 0
"RTN","PSOHELP3",78,0)
 I $G(PSOINS("DFLG")) Q 0
"RTN","PSOHELP3",79,0)
 I $G(PSOINS("INS"))]"",$G(PSOINS("SINS"))="" W $C(7),!!?5,"OTHER PATIENT INSTRUCTIONS REQUIRED",! Q 2
"RTN","PSOHELP3",80,0)
 I $G(PSOINS("INS"))="",$G(PSOINS("SINS"))]"" W $C(7),!!?5,"PATIENT INSTRUCTIONS REQUIRED",! Q 1
"RTN","PSOHELP3",81,0)
 Q 0
"RTN","PSOHELP3",82,0)
DELINS  ;IF DELETE PATIENT INSTRUCTIONS OR OTHER PATIENT INSTRUCTIONS, NOTIFY USER BOTH WILL BE DELETED, PROMPT IF OKAY ; *422
"RTN","PSOHELP3",83,0)
 I '$P($G(^PS(55,PSODFN,"LAN")),"^") Q
"RTN","PSOHELP3",84,0)
 N X,Y,DIR,DIRUT
"RTN","PSOHELP3",85,0)
 W $C(7),!!?5,"ANY DATA ENTERED FOR "_$S($G(PSODELINS)=1:"OTHER PATIENT INSTRUCTIONS",1:"PATIENT INSTRUCTIONS")
"RTN","PSOHELP3",86,0)
 W $C(7),!?5,"WILL ALSO BE DELETED.",!
"RTN","PSOHELP3",87,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("A")="Continue with Deletion" D ^DIR
"RTN","PSOHELP3",88,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)) S X="NO",Y=0  ;IF ^ OR TIMEOUT TREAT AS IF ANSWERED NO
"RTN","PSOHELP3",89,0)
 S (PSODELINS,PSODONE)=Y
"RTN","PSOHELP3",90,0)
 K DIR,DIRUT
"RTN","PSOHELP3",91,0)
 Q
"RTN","PSONEW1")
0^4^B18114075^B14209647
"RTN","PSONEW1",1,0)
PSONEW1 ;BIR/DSD - new Rx order entry ;10/17/92
"RTN","PSONEW1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,104,117,143,422**;DEC 1997;Build 132
"RTN","PSONEW1",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSONEW1",4,0)
 ;
"RTN","PSONEW1",5,0)
START ;
"RTN","PSONEW1",6,0)
 S (PSONEW("DFLG"),PSONEW("FIELD"),PSONEW1)=0
"RTN","PSONEW1",7,0)
 ;
"RTN","PSONEW1",8,0)
1 S PSONEW("FLD")=1 S PSONEW("FIELD")=0
"RTN","PSONEW1",9,0)
 I $P($G(PSOPAR),"^",7)'=1 D MANUAL^PSONRXN ; Get Manual Rx number
"RTN","PSONEW1",10,0)
 G:PSONEW("QFLG")!PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",11,0)
 ;
"RTN","PSONEW1",12,0)
2 S PSONEW("FLD")=2 D PTSTAT^PSODIR1(.PSONEW) ; Get Patient Status
"RTN","PSONEW1",13,0)
 G:PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",14,0)
 ;
"RTN","PSONEW1",15,0)
3 S PSONEW("FLD")=3 D ^PSODRG  ; Get drug and related information
"RTN","PSONEW1",16,0)
 G:PSONEW("DFLG") END D EN^PSODIAG  ; get ICD diagnosis codes for order
"RTN","PSONEW1",17,0)
 G:PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",18,0)
 ;
"RTN","PSONEW1",19,0)
31 S PSONEW("FLD")=31 D DOSE^PSODIR(.PSONEW) ; Get Dosing
"RTN","PSONEW1",20,0)
 G:PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",21,0)
 ;
"RTN","PSONEW1",22,0)
32 K PSODELINS
"RTN","PSONEW1",23,0)
 I '$G(PSONEW("ENT")) W !,"Incomplete Dosaging Data!",! K DIRUT G 31
"RTN","PSONEW1",24,0)
 S:'$D(PSOOEINS) PSOOEINS=$G(PSONEW("INS")) S:'$D(PSOOSINS) PSOOSINS=$G(PSONEW("SINS"))
"RTN","PSONEW1",25,0)
 I '$P($G(^PS(55,PSODFN,"LAN")),"^") S PSONEW("FLD")=32 D INS^PSODIR(.PSONEW) ; Get Patient Instructions
"RTN","PSONEW1",26,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") D
"RTN","PSONEW1",27,0)
 .N PSOINSCH,PSODONE S PSODONE=0
"RTN","PSONEW1",28,0)
 .F  D  Q:PSODONE
"RTN","PSONEW1",29,0)
 ..S PSONEW("FLD")=32 D INS^PSODIR(.PSONEW)
"RTN","PSONEW1",30,0)
 ..I '$G(PSONEW("DFLG")),'PSODONE,'$G(PSODELINS) D SINS^PSODIR(.PSONEW)
"RTN","PSONEW1",31,0)
 ..I $G(PSONEW("DFLG")) S PSODONE=1 K PSONEW("DFLG") D  Q
"RTN","PSONEW1",32,0)
 ...I $G(PSONEW("INS"))]"",$G(PSONEW("SINS"))="" K PSONEW("INS"),PSONEW("SIG") Q
"RTN","PSONEW1",33,0)
 ...I $G(PSONEW("INS"))="",$G(PSONEW("SINS"))]"" K PSONEW("SINS")
"RTN","PSONEW1",34,0)
 ..S PSOINSCH=$$INSCHK^PSOHELP3(.PSONEW)
"RTN","PSONEW1",35,0)
 ..I 'PSOINSCH S PSODONE=1
"RTN","PSONEW1",36,0)
 G:$G(PSONEW("DFLG")) END G:$G(PSONEW("FIELD")) @PSONEW("FIELD")
"RTN","PSONEW1",37,0)
 ;
"RTN","PSONEW1",38,0)
 ;
"RTN","PSONEW1",39,0)
4 D EN^PSOFSIG(.PSONEW) I $O(SIG(0)) S SIGOK=1
"RTN","PSONEW1",40,0)
 ;S PSONEW("FLD")=4 D SIG^PSODIR1(.PSONEW) ; Get Rx directions
"RTN","PSONEW1",41,0)
 ;G:PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",42,0)
 ;
"RTN","PSONEW1",43,0)
7 S PSONEW("FLD")=7 D DAYS^PSODIR1(.PSONEW) ; Get days supply
"RTN","PSONEW1",44,0)
 G:PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",45,0)
 ;
"RTN","PSONEW1",46,0)
5 S PSONEW("FLD")=5 D QTY^PSODIR1(.PSONEW) ; Get quantity
"RTN","PSONEW1",47,0)
 G:PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",48,0)
 ;
"RTN","PSONEW1",49,0)
6 I $P($G(PSOPAR),"^",15) S PSONEW("FLD")=6 D COPIES^PSODIR1(.PSONEW) ; Get label copies
"RTN","PSONEW1",50,0)
 G:PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",51,0)
 ;
"RTN","PSONEW1",52,0)
8 S PSONEW("FLD")=8 D REFILL^PSODIR1(.PSONEW) ; Get # of refills
"RTN","PSONEW1",53,0)
 G:PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",54,0)
 ;
"RTN","PSONEW1",55,0)
9 S PSONEW("FLD")=9 D PROV^PSODIR(.PSONEW) ; Get Provider
"RTN","PSONEW1",56,0)
 G:PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",57,0)
 G:$G(DUZ("AG"))'="I" 11
"RTN","PSONEW1",58,0)
 ;
"RTN","PSONEW1",59,0)
10 Q:$G(DUZ("AG"))'="I"  S PSONEW("FLD")=10 D EXP^PSODIR2(.PSONEW) ; Get Expiration Date - Indian Health Service ONLY
"RTN","PSONEW1",60,0)
 G:PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",61,0)
 ;
"RTN","PSONEW1",62,0)
11 S PSONEW("FLD")=11 D CLINIC^PSODIR2(.PSONEW) ; Get Clinic
"RTN","PSONEW1",63,0)
 G:PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",64,0)
 ;
"RTN","PSONEW1",65,0)
12 S PSONEW("FLD")=12 D MW^PSODIR2(.PSONEW) ; Get Mail/Window Info
"RTN","PSONEW1",66,0)
 G:PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",67,0)
 ;
"RTN","PSONEW1",68,0)
13 S PSONEW("FLD")=13 D RMK^PSODIR2(.PSONEW) ; Get Remarks
"RTN","PSONEW1",69,0)
 G:PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",70,0)
 ;
"RTN","PSONEW1",71,0)
14 S PSONEW("FLD")=14 D ISSDT^PSODIR2(.PSONEW) ; Get Issue Date
"RTN","PSONEW1",72,0)
 G:PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",73,0)
 ;
"RTN","PSONEW1",74,0)
15 S PSONEW("FLD")=15 D FILLDT^PSODIR2(.PSONEW) ; Get Fill date
"RTN","PSONEW1",75,0)
 G:PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",76,0)
 ;
"RTN","PSONEW1",77,0)
16 S PSONEW("FLD")=16 D CLERK^PSODIR2(.PSONEW) ; Get Clerk Code
"RTN","PSONEW1",78,0)
 G:PSONEW("DFLG") END G:PSONEW("FIELD") @PSONEW("FIELD")
"RTN","PSONEW1",79,0)
 ;
"RTN","PSONEW1",80,0)
END ;
"RTN","PSONEW1",81,0)
 K PSONEW1,PSOOEINS,PSOOSINS
"RTN","PSONEW1",82,0)
 Q
"RTN","PSONEW1",83,0)
 ;
"RTN","PSONEW1",84,0)
JUMP ;
"RTN","PSONEW1",85,0)
 S PSONEW("FIELD")=$S(+Y=.01:1,+Y=3:2,+Y=6:3,+Y=10:4,+Y=7:5,+Y=10.6:6,+Y=8:7,+Y=9:8,+Y=4:9,+Y=29:10,+Y=5:11,+Y=11:12,+Y=12:13,+Y=1:14,+Y=22:15,+Y=16:16,+Y=113:31,+Y=114:32,1:PSONEW("FLD"))
"RTN","PSONEW1",86,0)
 I PSONEW("FIELD")>PSONEW("FLD") W !,$C(7),"Cannot jump ahead ..",! S PSONEW("FIELD")=PSONEW("FLD")
"RTN","PSONEW1",87,0)
 Q
"RTN","PSOORED1")
0^19^B76283215^B64951982
"RTN","PSOORED1",1,0)
PSOORED1 ;ISC-BHAM/SAB - edit orders from backdoor ;5/10/07 8:25am
"RTN","PSOORED1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**5,23,46,78,114,117,131,146,223,148,244,249,268,206,313,444,422**;DEC 1997;Build 132
"RTN","PSOORED1",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOORED1",4,0)
 ;External reference ^PS(50.7 supported by DBIA 2223
"RTN","PSOORED1",5,0)
 ;
"RTN","PSOORED1",6,0)
 ;*244 call to remove DC'd Rx's from Rx ien strings
"RTN","PSOORED1",7,0)
 ;
"RTN","PSOORED1",8,0)
EN(PSORENW) ;
"RTN","PSOORED1",9,0)
 N LST,ORD,ORN K VALMBCK,PSORX("FN") S PSOAC=1,(PSORX("QFLG"),PSORX("DFLG"))=0 ;D DREN^PSOORNW2,INIT
"RTN","PSOORED1",10,0)
 D INIT
"RTN","PSOORED1",11,0)
 D @$S($P(PSOPAR,"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN")
"RTN","PSOORED1",12,0)
 I '$D(PSONEW("RX #")),'$P(PSOPAR,"^",7) D PAUSE^VALM1 K VALMSG,PSONEW("QFLG") S VALMBCK="Q" Q
"RTN","PSOORED1",13,0)
 I '$D(PSONEW("RX #")) K VALMSG D DEL^PSONEW,PAUSE^VALM1 S VALMBCK="Q" Q
"RTN","PSOORED1",14,0)
 S PSORENW("RX #")=PSONEW("RX #") I '$P(PSOPAR,"^",7) D  Q:$G(PSONEW("DFLG"))!($G(PSONEW("QFLG")))
"RTN","PSOORED1",15,0)
 .S PSOX=PSORENW("RX #") D CHECK^PSONRXN
"RTN","PSOORED1",16,0)
 I $G(PSONEW("DFLG"))!$G(PSONEW("QFLG")) D DEL^PSONEW,PAUSE^VALM1 S VALMBCK="Q" K PSORENW Q
"RTN","PSOORED1",17,0)
 D EN^PSOORNE1(.PSORENW) I '$G(PSORX("FN")) D:$P($G(PSOPAR),"^",7)=1  S VALMBCK="Q" Q
"RTN","PSOORED1",18,0)
 .S DIE="^PS(59,",DA=PSOSITE,PSOY=$O(PSONEW("OLD LAST RX#","")),PSOX=PSONEW("OLD LAST RX#",PSOY)
"RTN","PSOORED1",19,0)
 .L +^PS(59,+PSOSITE,PSOY):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSOORED1",20,0)
 .S DR=$S(PSOY=8:"2003////"_PSOX,PSOY=3:"1002.1////"_PSOX,1:"2003////"_PSOX)
"RTN","PSOORED1",21,0)
 .D:PSOX<$P(^PS(59,+PSOSITE,PSOY),"^",3) ^DIE K DIE,X,Y L -^PS(59,+PSOSITE,PSOY)
"RTN","PSOORED1",22,0)
 .I $D(PSONEW("RX #")) L -^PSRX("B",PSONEW("RX #"))
"RTN","PSOORED1",23,0)
 .K PSOX,PSOY Q
"RTN","PSOORED1",24,0)
 Q:$G(COPY)
"RTN","PSOORED1",25,0)
TRY S $P(^PSRX(PSORENW("OIRXN"),"STA"),"^")=15,DA=PSORENW("OIRXN")
"RTN","PSOORED1",26,0)
 S $P(^PSRX(DA,3),"^",5)=DT,$P(^PSRX(DA,3),"^",10)=$P(^PSRX(DA,3),"^")
"RTN","PSOORED1",27,0)
 D REVERSE^PSOBPSU1(DA,,"DC",7),CAN^PSOTPCAN(DA)
"RTN","PSOORED1",28,0)
 D RMP^PSOCAN3                ;*244
"RTN","PSOORED1",29,0)
 ;cancel/discontinue action
"RTN","PSOORED1",30,0)
 S PHARM="",STAT="RP",COMM="Prescription discontinued due to editing." D EN^PSOHLSN1(DA,STAT,PHARM,COMM,PSONOOR) K STAT,PHARM,COMM
"RTN","PSOORED1",31,0)
 S ACOM="Discontinued due to editing. New Rx created "_$P(^PSRX(PSORENW("IRXN"),0),"^")_"."
"RTN","PSOORED1",32,0)
 I $G(^PSRX(DA,"H"))]"" D
"RTN","PSOORED1",33,0)
 .I $P(^PSRX(DA,"STA"),"^")=3!($P(^("STA"),"^")=16) D
"RTN","PSOORED1",34,0)
 ..S DIE=52,DR="22///"_$P(^PSRX(DA,3),"^") D ^DIE S ACOM="Discontinued due to editing while on hold. " K:$P(^PSRX(DA,"H"),"^") ^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA)
"RTN","PSOORED1",35,0)
 ..S ^PSRX(DA,"H")=""
"RTN","PSOORED1",36,0)
 S RXDA=DA,(DA,SUSDA)=$O(^PS(52.5,"B",RXDA,0)) D:DA
"RTN","PSOORED1",37,0)
 .S SUSD=$P($G(^PS(52.5,DA,0)),"^",2)
"RTN","PSOORED1",38,0)
 .S:+$G(^PS(52.5,DA,"P"))'=1 ACOM="Discontinued due to editing while suspended."
"RTN","PSOORED1",39,0)
 .I $O(^PSRX(RXDA,1,0)) S DA=RXDA D:'$G(^PS(52.5,+SUSDA,"P")) REF^PSOCAN2
"RTN","PSOORED1",40,0)
 .S DA=SUSDA,DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOORED1",41,0)
 K SUSD,SUSDA S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2) D
"RTN","PSOORED1",42,0)
 .S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOORED1",43,0)
 .S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOORED1",44,0)
 .D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_(ACNT+1)_"^"_(ACNT+1),^PSRX(DA,"A",ACNT+1,0)=%_"^C^"_DUZ_"^"_RFCNT_"^"_$G(ACOM)
"RTN","PSOORED1",45,0)
 .I $G(PSOOIFLG),'$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Pharmacy Orderable Item Edited."
"RTN","PSOORED1",46,0)
 .I '$G(PSOOIFLG),$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Medication Route/Schedule Edited."
"RTN","PSOORED1",47,0)
 .I $G(PSOOIFLG),$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Pharmacy Orderable Item and Medication Route/Schedule Edited."
"RTN","PSOORED1",48,0)
 .S REA="C" D EXP^PSOHELP1
"RTN","PSOORED1",49,0)
 I $G(^PS(52.4,DA,0))]"" S PSCDA=DA,DIK="^PS(52.4," D ^DIK S DA=PSCDA K DIK,PSCDA
"RTN","PSOORED1",50,0)
 Q
"RTN","PSOORED1",51,0)
INS K X,QUIT,Y,DIR,DIRUT,DUOUT,DTOUT,DIC,INSDEL,UPMI,^TMP($J,"INS1")
"RTN","PSOORED1",52,0)
 I '$O(^PSRX(PSORXED("IRXN"),6,0)),'$O(PSORXED("DOSE",0)) D UPMI Q:$G(QUIT)  ;G INS1
"RTN","PSOORED1",53,0)
 I $G(^PSRX(PSORXED("IRXN"),"INS"))]"" S PSORXED("FLD",114)=^PSRX(PSORXED("IRXN"),"INS") K UPMI G INS1
"RTN","PSOORED1",54,0)
 K DD,GG F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"INS1",I)) Q:'I  S DD=$G(DD)+1
"RTN","PSOORED1",55,0)
 I $G(DD)=1 S PSORXED("FLD",114)=^PSRX(PSORXED("IRXN"),"INS1",$O(^PSRX(PSORXED("IRXN"),"INS1",0)),0) K UPMI,DD G INS1
"RTN","PSOORED1",56,0)
 I $O(^PSRX(PSORXED("IRXN"),"INS1",0)) D  G INSX
"RTN","PSOORED1",57,0)
 .F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"INS1",I)) Q:'I  S ^TMP($J,"INS1",I,0)=^PSRX(PSORXED("IRXN"),"INS1",I,0)
"RTN","PSOORED1",58,0)
 .S ^TMP($J,"INS1",0)=^PSRX(PSORXED("IRXN"),"INS1",0)
"RTN","PSOORED1",59,0)
 .S DIC="^TMP($J,""INS1"",",DWPK=2,DWLW=80 D EN^DIWE I $G(X)="^" K ^TMP($J,"INS1") Q
"RTN","PSOORED1",60,0)
 .I '$O(^TMP($J,"INS1",0)) S INSDEL=1
"RTN","PSOORED1",61,0)
 .S D=0 F  S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORED1",62,0)
INS1 K Y,DIR,DIRUT,DUOUT,DTOUT,DIC,X
"RTN","PSOORED1",63,0)
 I $G(PSORXED("IRXN")) S:'$D(PSOOEINS) PSOOEINS=$G(^PSRX(PSORXED("IRXN"),"INS")) S:'$D(PSOOSINS) PSOOSINS=$G(^PSRX(PSORXED("IRXN"),"INSS")) ;*422
"RTN","PSOORED1",64,0)
 I $G(UPMI) K UPMI I $G(^PS(50.7,PSODRUG("OI"),"INS"))]"" S PSORXED("FLD",114)=^PS(50.7,PSODRUG("OI"),"INS")
"RTN","PSOORED1",65,0)
 S:$G(PSORXED("FLD",114))]"" DIR("B")=PSORXED("FLD",114)
"RTN","PSOORED1",66,0)
 S DIR("?")="Enter Quick codes or Free Text",DIR(0)="52,114" D ^DIR
"RTN","PSOORED1",67,0)
 I $D(DTOUT)!($D(DUOUT)) K PSORXED("FLD",114),PSORXED("FLD",114.1) S (PSORXED("INS"),PSORXED("SIG",1))=$G(PSOOEINS) S:$P($G(^PS(55,PSODFN,"LAN")),"^") PSORXED("SINS")=$G(PSOOSINS) D EN^PSOFSIG(.PSORXED,1) G INSQ  ;*422
"RTN","PSOORED1",68,0)
 I $G(PSORXED("DFLG")) S (PSORXED("SIG"),PSORXED("INS"))=$G(PSOOEINS),PSORXED("SINS")=$G(PSOOSINS) K PSORXED("SIG") D EN^PSOFSIG(.PSONEW,1) G INSQ  ;*422
"RTN","PSOORED1",69,0)
 S PSODELINS=0 I X="@" S PSODELINS=1 D DELINS^PSOHELP3 ;*422
"RTN","PSOORED1",70,0)
 I '$G(PSODELINS),($G(X)="@"!($G(X)="")) S (X,INS1,PSORXED("INS"))=$G(PSOOEINS) ;*422
"RTN","PSOORED1",71,0)
 I $G(PSODELINS) S (INS1,PSORXED("FLD",114),PSORXED("FLD",114.1))="" K PSORXED("INS"),PSORXED("SIG"),PSORXED("SINS")  ;*422
"RTN","PSOORED1",72,0)
 I X'="",X'="@" D SIG^PSOHELP G INS1:'$D(X)
"RTN","PSOORED1",73,0)
 I $G(INS1)]"" W " ("_$E(INS1,2,9999999)_")"
"RTN","PSOORED1",74,0)
 S:$G(INS1)]"" (PSORXED("INS"),PSORXED("SIG",1),PSORXED("FLD",114))=$E(INS1,2,9999999) D EN^PSOFSIG(.PSORXED)
"RTN","PSOORED1",75,0)
 I $G(PSODELINS) G INSQ
"RTN","PSOORED1",76,0)
INSX I '$P($G(^PS(55,PSODFN,"LAN")),"^") G INSQ
"RTN","PSOORED1",77,0)
 K DIR
"RTN","PSOORED1",78,0)
 I $G(^PSRX(PSORXED("IRXN"),"INSS"))]"" S PSORXED("SINS")=^PSRX(PSORXED("IRXN"),"INSS")
"RTN","PSOORED1",79,0)
 D SINS^PSODIR(.PSORXED) ;*422
"RTN","PSOORED1",80,0)
 I $G(PSORXED("DFLG")) K PSORXED("FLD",114) S PSORXED("INS")=$G(PSOOEINS) S:$P($G(^PS(55,PSODFN,"LAN")),"^") PSORXED("SINS")=$G(PSOOSINS) D EN^PSOFSIG(.PSORXED,1) G INSQ  ;*422
"RTN","PSOORED1",81,0)
 S:$G(PSORXED("SINS"))]"" PSORXED("FLD",114.1)=$G(PSORXED("SINS"))  ;*422
"RTN","PSOORED1",82,0)
 S PSOINSCH=$$INSCHK^PSOHELP3(.PSORXED)  ;*422
"RTN","PSOORED1",83,0)
 G:PSOINSCH INS1  ;*422
"RTN","PSOORED1",84,0)
INSQ K DIRUT,DUOUT,DTOUT,DIR,X,Y,DIC,DWPK,PSOOEINS,PSOOSINS,PSODELINS
"RTN","PSOORED1",85,0)
 Q
"RTN","PSOORED1",86,0)
INIT ;setup psorenw array
"RTN","PSOORED1",87,0)
 S PSORENW("RX0")=^PSRX(PSORENW("IRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN"))
"RTN","PSOORED1",88,0)
 I $G(PSOSIGFL),$G(PSORX("SIG"))]"" S PSORENW("SIG")=PSORX("SIG"),SIGOK=0
"RTN","PSOORED1",89,0)
 E  D
"RTN","PSOORED1",90,0)
 .I '$P($G(^PSRX(PSORENW("IRXN"),"SIG")),"^",2) S PSORENW("SIG")=$P($G(^("SIG")),"^")
"RTN","PSOORED1",91,0)
 .E  D
"RTN","PSOORED1",92,0)
 ..S SIGOK=1 Q:$O(SIG(0))
"RTN","PSOORED1",93,0)
 ..S D=0 F I=0:0 S D=D+1,I=$O(^PSRX(PSORENW("IRXN"),"SIG1",I)) Q:'I  S SIG(D)=^PSRX(PSORENW("IRXN"),"SIG1",I,0)
"RTN","PSOORED1",94,0)
 ..K PSOX1,D
"RTN","PSOORED1",95,0)
 S PSORENW("OIRXN")=PSORENW("IRXN")
"RTN","PSOORED1",96,0)
 S PSORENW("PROVIDER")=$S($G(PSORENW("PROVIDER")):PSORENW("PROVIDER"),1:$P(PSORENW("RX0"),"^",4))
"RTN","PSOORED1",97,0)
 S (PSORENW("PROVIDER NAME"),PSORX("PROVIDER NAME"))=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSOORED1",98,0)
 I $P($G(^VA(200,PSORENW("PROVIDER"),"PS")),"^",7),$P($G(^("PS")),"^",8) S PSORENW("COSIGNING PROVIDER")=$P($G(^("PS")),"^",8)
"RTN","PSOORED1",99,0)
 S PSORENW("CLINIC")=$S($G(PSORENW("CLINIC")):PSORENW("CLINIC"),1:$P(PSORENW("RX0"),"^",5))
"RTN","PSOORED1",100,0)
 S PSORENW("REMARKS")="New Order Created by "_$S($G(COPY)&('$G(PSOEDIT)):"copying",1:"editing")_" Rx # "_$P(PSORENW("RX0"),"^")_"."
"RTN","PSOORED1",101,0)
 ;
"RTN","PSOORED1",102,0)
 ; - Maintenance Dose Rx Remarks field
"RTN","PSOORED1",103,0)
 I $G(PSOMTFLG) S PSORENW("REMARKS")="Maintenance Rx created from Titration Rx# "_$P(PSORENW("RX0"),"^")_"."
"RTN","PSOORED1",104,0)
 ;
"RTN","PSOORED1",105,0)
 S PSORENW("COSIGNER")=$S($G(PSORENW("COSIGNER")):PSORENW("COSIGNER"),$P(PSORENW("RX3"),"^",3):$P(PSORENW("RX3"),"^",3),1:"")
"RTN","PSOORED1",106,0)
 K:PSORENW("COSIGNER")="" PSORENW("COSIGNER")
"RTN","PSOORED1",107,0)
 S PSORENW("PSODFN")=$P(PSORENW("RX0"),"^",2)
"RTN","PSOORED1",108,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSOORED1",109,0)
 S:$G(PSODRUG("IEN")) PSORENW("DRUG IEN")=PSODRUG("IEN")
"RTN","PSOORED1",110,0)
 I $G(PSORENW("DAYS SUPPLY")) G QTY
"RTN","PSOORED1",111,0)
 S PSORENW("DAYS SUPPLY")=$S($D(CLOZPAT):7,1:$P(PSORENW("RX0"),"^",8))
"RTN","PSOORED1",112,0)
QTY S PSORENW("QTY")=$S($G(PSORENW("QTY")):PSORENW("QTY"),1:$P(PSORENW("RX0"),"^",7))
"RTN","PSOORED1",113,0)
RFN S PSORENW("# OF REFILLS")=$S($D(CLOZPAT):0,$G(PSORENW("# OF REFILLS")):PSORENW("# OF REFILLS"),1:$P(PSORENW("RX0"),"^",9))
"RTN","PSOORED1",114,0)
 S (PSOID,Y,PSORENW("FILL DATE"),PSORENW("ISSUE DATE"))=DT
"RTN","PSOORED1",115,0)
 ;
"RTN","PSOORED1",116,0)
 ; - Maintenance Rx Fill Date is set with Next Possible Fill from Titration Rx
"RTN","PSOORED1",117,0)
 I $G(PSOMTFLG),$P($G(PSORENW("RX3")),"^",2)>DT S PSORENW("FILL DATE")=$P(PSORENW("RX3"),"^",2)
"RTN","PSOORED1",118,0)
 ;
"RTN","PSOORED1",119,0)
 S:PSORENW("CLINIC") PSORX("CLINIC")=$P(^SC(+PSORENW("CLINIC"),0),"^")
"RTN","PSOORED1",120,0)
 S PSORENW("PATIENT STATUS")=$S($G(PSORENW("PATIENT STATUS")):PSORENW("PATIENT STATUS"),'$P(PSORENW("RX0"),"^",3):$G(^PS(55,PSORENW("PSODFN"),"PS")),1:$P(PSORENW("RX0"),"^",3))
"RTN","PSOORED1",121,0)
 S PSORENW("PTST NODE")=$G(^PS(53,PSORENW("PATIENT STATUS"),0))
"RTN","PSOORED1",122,0)
 S PSDAYS=$S($G(PSORENW("DAYS SUPPLY")):PSORENW("DAYS SUPPLY"),'$P(PSORENW("RX0"),"^",8):$P(PSORENW("PTST NODE"),"^",3),1:$P(PSORENW("RX0"),"^",8))
"RTN","PSOORED1",123,0)
 I $G(PSODRUG("IEN")) S DREN=PSODRUG("IEN"),POERR=1 D DRG^PSOORDRG K POERR
"RTN","PSOORED1",124,0)
 D:$G(PSORENW("# OF REFILLS"))']"" RF
"RTN","PSOORED1",125,0)
 ;
"RTN","PSOORED1",126,0)
 ; - Maintenance Rx # of Refills adjustment
"RTN","PSOORED1",127,0)
 I $G(PSOMTFLG),$G(PSORENW("# OF REFILLS"))>0 S PSORENW("# OF REFILLS")=PSORENW("# OF REFILLS")-1
"RTN","PSOORED1",128,0)
 ;
"RTN","PSOORED1",129,0)
 S PSORENW("MAIL/WINDOW")=$S($G(PSORENW("MAIL/WINDOW"))]"":PSORENW("MAIL/WINDOW"),1:$P(PSORENW("RX0"),"^",11))
"RTN","PSOORED1",130,0)
 S PSORX("MAIL/WINDOW")=$S(PSORENW("MAIL/WINDOW")="W":"WINDOW",1:"MAIL")
"RTN","PSOORED1",131,0)
 S PSORENW("COPIES")=$S($G(PSORENW("COPIES")):PSORENW("COPIES"),$P(PSORENW("RX0"),"^",18):$P(PSORENW("RX0"),"^",18),1:1)
"RTN","PSOORED1",132,0)
 S PSORENW("CLERK CODE")=DUZ
"RTN","PSOORED1",133,0)
 S:$G(PSORX("CLERK CODE"))']"" PSORX("CLERK CODE")=$P($G(^VA(200,DUZ,0)),"^")
"RTN","PSOORED1",134,0)
 Q:$D(COPY)  S PSORENW("ENT")=0
"RTN","PSOORED1",135,0)
 K PSORENW("ENT") F I=0:0 S I=$O(PSORENW("DOSE",I)) Q:'I  S PSORENW("ENT")=$G(PSORENW("ENT"))+1
"RTN","PSOORED1",136,0)
 I $O(^TMP($J,"INS1",0)) D
"RTN","PSOORED1",137,0)
 .K PSORXED("SIG"),DD
"RTN","PSOORED1",138,0)
 .F I=0:0 S I=$O(^TMP($J,"INS1",I)) Q:'I  S PSORENW("SIG",I)=^TMP($J,"INS1",I,0)
"RTN","PSOORED1",139,0)
 .K ^TMP($J,"INS1")
"RTN","PSOORED1",140,0)
 I $G(^PSRX(PSORENW("IRXN"),"INS"))]"" S PSORENW("INS")=^PSRX(PSORENW("IRXN"),"INS")
"RTN","PSOORED1",141,0)
 I $G(^PSRX(PSORENW("IRXN"),"INSS"))]"" S PSORENW("SINS")=^PSRX(PSORENW("IRXN"),"INSS")
"RTN","PSOORED1",142,0)
 I '$G(PSORENW("ENT")),'$G(PSOSIGFL) D DOLST1^PSOORED3(.PSORENW) S PSORENW("ENT")=+$G(OLENT)
"RTN","PSOORED1",143,0)
 Q
"RTN","PSOORED1",144,0)
RF ;# of refills
"RTN","PSOORED1",145,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSOORED1",146,0)
 S PSORENW("# OF REFILLS")=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),PSDAYS,+$G(PSORENW("PATIENT STATUS")),.CLOZPAT)
"RTN","PSOORED1",147,0)
 Q
"RTN","PSOORED1",148,0)
UPMI ;add dosing data for pre-poe rxs
"RTN","PSOORED1",149,0)
 W !! K PSONEW("DFLG"),DIR,DIRUT,DTOUT,DUOUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Dosing Instructions Are Missing!! Do You Want to Add Them"
"RTN","PSOORED1",150,0)
 D ^DIR I 'Y!($D(DIRUT)) S QUIT=1 K DIR,DIRUT,DUOT,DUOUT Q
"RTN","PSOORED1",151,0)
 S UPMI=1,EDTHLD=$G(PSORX("EDIT")) K PSORX("EDIT")
"RTN","PSOORED1",152,0)
 D DOSE1^PSOORED5(.PSORXED) S (PSORXED,PSORX("EDIT"))=EDTHLD K EDTHLD I $G(PSONEW("DFLG")) S QUIT=1
"RTN","PSOORED1",153,0)
 Q
"RTN","PSOORED6")
0^6^B63254797^B68287627
"RTN","PSOORED6",1,0)
PSOORED6 ;BIR/SAB - edit orders from backdoor ;03/06/96
"RTN","PSOORED6",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**78,104,117,133,143,219,148,247,268,260,269,251,372,422**;DEC 1997;Build 132
"RTN","PSOORED6",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORED6",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORED6",5,0)
 ;External reference ^PS(50.606 supported by DBIA 2174
"RTN","PSOORED6",6,0)
DRG ;select drug
"RTN","PSOORED6",7,0)
 S PSORX("EDIT")=1,RX0HLD=RX0
"RTN","PSOORED6",8,0)
 S PSODRUG("IEN")=$S($G(PSODRUG("IEN"))]"":PSODRUG("IEN"),1:$P(RX0,"^",6)),PSODRUG("NAME")=$S($G(PSODRUG("NAME"))]"":PSODRUG("NAME"),1:$P(^PSDRUG($P(RX0,"^",6),0),"^"))
"RTN","PSOORED6",9,0)
 D ^PSODRG I PSODRUG("IEN")=$P(RX0,"^",6) K PSORXED("FLD",6)
"RTN","PSOORED6",10,0)
 D:PSODRUG("IEN")'=$P(RX0,"^",6)  I $G(PSORX("DFLG")) K PSORXED("FLD",6) S PSORXED("DFLG")=1 Q
"RTN","PSOORED6",11,0)
 .S ^TMP("PSORXBO",$J,RX0,0)=1
"RTN","PSOORED6",12,0)
 .D POST^PSODRG
"RTN","PSOORED6",13,0)
 .I '$O(^PSRX(PSORXED("IRXN"),1,0)) S PSORXED("FLD",17)=$G(PSODRUG("COST"))
"RTN","PSOORED6",14,0)
 .I $G(PSORX("DFLG")) K PSORXED("FLD",6),PSODRUG,PSOOIFLG,PSOSIGFL,VALMSG Q
"RTN","PSOORED6",15,0)
 .N PSOXXX  ;*422
"RTN","PSOORED6",16,0)
 .S PSOXXX(1)="You have changed the dispense drug from",PSOXXX(2)=$P(^PSDRUG($P(PSORXED("RX0"),"^",6),0),"^")_" to "_$P(^PSDRUG(PSODRUG("IEN"),0),"^")_"." D EN^DDIOL(.PSOXXX,"","!") S PSOAC=1  ;*422
"RTN","PSOORED6",17,0)
 .S PSOREEDQ=1 D DOLST^PSOORED3,DOSE^PSOORED3 K PSOREEDQ
"RTN","PSOORED6",18,0)
 .I '$O(PSORXED("DOSE",0)) S PSORX("DFLG")=1 Q
"RTN","PSOORED6",19,0)
 .D:$G(PSOSIGFL) M2
"RTN","PSOORED6",20,0)
 S RX0=RX0HLD K RX0HLD I $G(PSODRUG("OI"))=$G(PSOI) D  Q
"RTN","PSOORED6",21,0)
 .D:$O(^TMP("PSORXDC",$J,0))
"RTN","PSOORED6",22,0)
 ..W !!,"This edit will discontinue the duplicate Rx & change the dispensed drug!"
"RTN","PSOORED6",23,0)
 ..K DIR,X,Y S DIR("A")="Do You Want to Proceed",DIR("B")="NO",DIR(0)="Y"
"RTN","PSOORED6",24,0)
 ..D ^DIR K DIR S:'Y!($D(DIRUT)) PSORXED("DFLG")=1 D:Y DCORD^PSONEW2
"RTN","PSOORED6",25,0)
 .Q:$G(PSORXED("DFLG"))
"RTN","PSOORED6",26,0)
 .I PSODRUG("IEN")'=$P(RX0,"^",6) D
"RTN","PSOORED6",27,0)
 ..S PSORXED("FLD",6)=PSODRUG("IEN"),PSORXED("FLD",39.2)=PSOI
"RTN","PSOORED6",28,0)
 .S:$G(PSODRUG("TRADE NAME"))]"" PSORXED("FLD",6.5)=PSODRUG("TRADE NAME")
"RTN","PSOORED6",29,0)
 .S:$G(PSODRUG("NDC"))]"" PSORXED("FLD",27)=PSODRUG("NDC")
"RTN","PSOORED6",30,0)
 .S:$G(PSODRUG("DAW"))]"" PSORXED("FLD",81)=PSODRUG("DAW")
"RTN","PSOORED6",31,0)
 W !!,"New Orderable Item selected. This edit will create a new prescription!",! D PAUSE^VALM1 S VALMSG="New Orderable Item selected. This edit will create a new prescription!" S (PSOOIFLG,PSOSIGFL)=1
"RTN","PSOORED6",32,0)
 Q
"RTN","PSOORED6",33,0)
PSOCOU ;patient counseling
"RTN","PSOORED6",34,0)
 K DIC,DIQ S DIC=52,DA=PSORXED("IRXN"),DIQ="PSORXED",DR=41 D EN^DIQ1 K DIC,DIQ
"RTN","PSOORED6",35,0)
 D KV S DIR(0)="52,41" S:$G(PSORXED(52,DA,DR))]"" DIR("B")=PSORXED(52,DA,DR) D ^DIR K DIR,PSORXED(52,DA,DR)
"RTN","PSOORED6",36,0)
 I $D(DIRUT) K PSORXED("FLD",41) D KV Q
"RTN","PSOORED6",37,0)
 S PSORXED("FLD",DR)=Y D  K DIRUT
"RTN","PSOORED6",38,0)
 .I Y D  Q
"RTN","PSOORED6",39,0)
 ..K DIC,DIQ S DIC=52,DA=PSORXED("IRXN"),DIQ="PSORXED",DR=42 D EN^DIQ1 K DIC,DIQ
"RTN","PSOORED6",40,0)
 ..K DIR,DIRUT S DIR(0)="52,42" S:$G(PSORXED(52,DA,DR))]"" DIR("B")=PSORXED(52,DA,DR) D ^DIR K DIR,PSORXED(52,DA,DR)
"RTN","PSOORED6",41,0)
 ..I $D(DIRUT) K PSORXED("FLD",41),DUOUT,DTOUT Q
"RTN","PSOORED6",42,0)
 ..S PSORXED("FLD",42)=Y
"RTN","PSOORED6",43,0)
 .S PSORXED("FLD",41)=0,PSORXED("FLD",42)="@"
"RTN","PSOORED6",44,0)
 Q
"RTN","PSOORED6",45,0)
PSOI ;select orderable item
"RTN","PSOORED6",46,0)
 W !!,"Current Orderable Item: "_$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSOORED6",47,0)
 S DIC("B")=$P(^PS(50.7,PSOI,0),"^"),DIC="^PS(50.7,",DIC(0)="AEMQZ"
"RTN","PSOORED6",48,0)
 S DIC("S")="I '$P(^PS(50.7,+Y,0),""^"",4)!($P(^(0),""^"",4)'<DT) N PSOF,PSOL S (PSOF,PSOL)=0 F  S PSOL=$O(^PSDRUG(""ASP"",+Y,PSOL)) Q:PSOF!'PSOL  "
"RTN","PSOORED6",49,0)
 S DIC("S")=DIC("S")_"I $P($G(^PSDRUG(PSOL,2)),U,3)[""O"",'$G(^(""I""))!($G(^(""I""))'<DT) S PSOF=1"
"RTN","PSOORED6",50,0)
 S D="B^C" D MIX^DIC1 I "^"[X S PSORXED("DFLG")=1 Q
"RTN","PSOORED6",51,0)
 G:Y<1 PSOI Q:PSOI=+Y
"RTN","PSOORED6",52,0)
 S PSODRUG("OI")=+Y,PSODRUG("OIN")=Y(0,0) K DIC
"RTN","PSOORED6",53,0)
 I PSOI'=PSODRUG("OI") W !!,"New Orderable Item selected. This edit will create a new prescription!",! D  K PSHOLDD Q
"RTN","PSOORED6",54,0)
 .N PSODDCHK S PSODDCHK=0  ;*422 - DUP DRUG CHECK ALREADY DONE IF SET TO 1
"RTN","PSOORED6",55,0)
 .D PAUSE^VALM1 I ($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) S PSORX("DFLG")=1 D M1 Q
"RTN","PSOORED6",56,0)
 .D M2
"RTN","PSOORED6",57,0)
 .S PSHOLDD=$G(PSODRUG("IEN")) K PSODRUG("IEN"),PSODRUG("NAME") S PSODRUG("DEA")="",(PSOOIFLG,PSOSIGFL)=1
"RTN","PSOORED6",58,0)
 .D DREN^PSOORNW2
"RTN","PSOORED6",59,0)
 .I $G(PSHOLDD),$G(PSODRUG("IEN")),$G(PSHOLDD)'=$G(PSODRUG("IEN")) D  Q:$G(PSORX("DFLG"))
"RTN","PSOORED6",60,0)
 ..I $G(PSORX("DFLG")) K PSODRUG S PSODRUG("IEN")=$G(PSHOLDD),PSODRUG("NAME")=$P($G(^PSDRUG(PSODRUG("IEN"),0)),"^") K PSOOIFLG,PSOSIGFL S VALMSG=""
"RTN","PSOORED6",61,0)
 .I '$G(PSODRUG("IEN")) W !!,"DRUG NAME REQUIRED!" D 2^PSOORNW1 S PSODDCHK=1  ;*422
"RTN","PSOORED6",62,0)
 .I '$G(PSODRUG("IEN")) K PSORXED("FLD"),INDEL,^TMP($J,"INS1"),PSOSIGFL,VALMSG S PSORXED("DFLG")=1,VALMSG="Dispense Drug NOT Selected!" Q
"RTN","PSOORED6",63,0)
 .D FULL^VALM1 D:'$G(PSODDCHK) POST^PSODRG S VALMBCK="R"  ;*422 ADDED PSODDCHK CHECK
"RTN","PSOORED6",64,0)
 .I PSORX("DFLG") K PSORXED("FLD"),INDEL,^TMP($J,"INS1"),PSOSIGFL,VALMSG Q
"RTN","PSOORED6",65,0)
 .N PSOXXX  ;*422
"RTN","PSOORED6",66,0)
 .S PSOXXX(1)="You have changed the Orderable Item from"
"RTN","PSOORED6",67,0)
 .S PSOXXX(2)=$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,PSOI,0),"^",2),0),"^")_" to "_PSODRUG("OIN")_" "_$P(^PS(50.606,$P(^PS(50.7,PSODRUG("OI"),0),"^",2),0),"^") D EN^DDIOL(.PSOXXX,"","!")  ;*422
"RTN","PSOORED6",68,0)
 .S PSOREEDQ=1 D DOLST^PSOORED3,DOSE^PSOORED3 K PSOREEDQ
"RTN","PSOORED6",69,0)
 .I '$O(PSORXED("DOSE",0)) S PSORX("DFLG")=1 Q
"RTN","PSOORED6",70,0)
 .D:$G(PSOSIGFL) M2
"RTN","PSOORED6",71,0)
 S PSORXED("FLD",39.2)=PSOI
"RTN","PSOORED6",72,0)
 Q
"RTN","PSOORED6",73,0)
NCPDP ;Reverse previously billed Rx on an edited orderable item or drug. 
"RTN","PSOORED6",74,0)
 N RX,NPSOY
"RTN","PSOORED6",75,0)
 S RX=$G(PSORXED("IRXN")) I RX="" D
"RTN","PSOORED6",76,0)
 . S NPSOY=$O(PSONEW("OLD LAST RX#","")),NPSOY=$G(PSONEW("OLD LAST RX#",NPSOY)),RX=$O(^PSRX("B",NPSOY,RX))
"RTN","PSOORED6",77,0)
 I 'RX Q
"RTN","PSOORED6",78,0)
 D REVERSE^PSOBPSU1(RX,,"DC",7) S NCPDPFLG=0
"RTN","PSOORED6",79,0)
 Q
"RTN","PSOORED6",80,0)
UPDATE ;add new data to file
"RTN","PSOORED6",81,0)
 N RXREF,UPDATE,FLDS,CHGNDC
"RTN","PSOORED6",82,0)
 Q:'$G(PSORXED("IRXN"))
"RTN","PSOORED6",83,0)
 I $O(PSORXED("FLD",0))!($G(^TMP($J,"INS1",0))]"")!($G(INSDEL))!($O(PSORXED("ODOSE",0))) D  G:'Y UPDX
"RTN","PSOORED6",84,0)
 .K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOORED6",85,0)
 .S DIR(0)="Y",DIR("A")="Are You Sure You Want to Update Rx "_$P(^PSRX(PSORXED("IRXN"),0),"^"),DIR("B")="Yes"
"RTN","PSOORED6",86,0)
 .D ^DIR K DIR I 'Y D M1 Q
"RTN","PSOORED6",87,0)
 .I $D(^PSRX(PSORXED("IRXN"),1,0))  D
"RTN","PSOORED6",88,0)
 ..S RXREF=$P(^PSRX(PSORXED("IRXN"),0),"^",9)-$P(^PSRX(PSORXED("IRXN"),1,0),"^",4)
"RTN","PSOORED6",89,0)
 .E  S RXREF=0
"RTN","PSOORED6",90,0)
 .K X,DIRUT,DUOUT,DTOUT
"RTN","PSOORED6",91,0)
 I $D(PSORXED("FLD",39.3)) D UPDATE^PSODIAG  ;update ICD's after edit
"RTN","PSOORED6",92,0)
 ; - Retrieving fields before changes that are relevant for 3rd Party Billing
"RTN","PSOORED6",93,0)
 D GETS^DIQ(52,PSORXED("IRXN")_",","4;7;8;20;22;27;81","I","FLDS")
"RTN","PSOORED6",94,0)
 K Y S DA=PSORXED("IRXN"),DIE="^PSRX(",FLD=0
"RTN","PSOORED6",95,0)
 F  S FLD=$O(PSORXED("FLD",FLD)) Q:'FLD  D
"RTN","PSOORED6",96,0)
 .I FLD=12!(FLD=24)!(FLD=35) D  Q
"RTN","PSOORED6",97,0)
 ..I FLD=12,PSORXED("FLD",12)="@" S $P(^PSRX(DA,3),"^",7)="" Q
"RTN","PSOORED6",98,0)
 ..I FLD=12,PSORXED("FLD",12)]"" S $P(^PSRX(DA,3),"^",7)=PSORXED("FLD",12) Q
"RTN","PSOORED6",99,0)
 ..I FLD=24,PSORXED("FLD",24)="@" S $P(^PSRX(DA,2),"^",4)="" Q
"RTN","PSOORED6",100,0)
 ..I FLD=24,PSORXED("FLD",24)]"" S $P(^PSRX(DA,2),"^",4)=PSORXED("FLD",24) Q
"RTN","PSOORED6",101,0)
 ..I FLD=35,PSORXED("FLD",35)="@" S $P(^PSRX(DA,"MP"),"^")="" Q
"RTN","PSOORED6",102,0)
 ..I FLD=35,PSORXED("FLD",35)]"" S $P(^PSRX(DA,"MP"),"^")=PSORXED("FLD",35) Q
"RTN","PSOORED6",103,0)
 .I FLD=114 D  Q
"RTN","PSOORED6",104,0)
 ..;I PSORXED("FLD",114)="@" K ^PSRX(DA,"INS"),^PSRX(DA,"INS1")
"RTN","PSOORED6",105,0)
 ..I PSORXED("FLD",114)="" K ^PSRX(DA,"INS"),^PSRX(DA,"INS1"),^PSRX(DA,"INSS") ;*422
"RTN","PSOORED6",106,0)
 ..I PSORXED("FLD",114)'="@" D
"RTN","PSOORED6",107,0)
 ...S ^PSRX(DA,"INS")=PSORXED("FLD",114)
"RTN","PSOORED6",108,0)
 ...S X=PSORXED("FLD",114) D SIG^PSOHELP Q:$G(INS1)']""
"RTN","PSOORED6",109,0)
 ...S PSORXED("SIG",1)=$E(INS1,2,9999999) K ^PSRX(DA,"INS1")
"RTN","PSOORED6",110,0)
 ...S ^PSRX(DA,"INS1",0)="^52.0115^1^1^"_DT_"^^"
"RTN","PSOORED6",111,0)
 ...S ^PSRX(DA,"INS1",1,0)=PSORXED("SIG",1)
"RTN","PSOORED6",112,0)
 ..D DOLST^PSOORED3 K:PSORXED("FLD",114)="@" PSORXED("SIG") D EN^PSOFSIG(.PSORXED),UPDSIG^PSOORED3
"RTN","PSOORED6",113,0)
 .I FLD=27 D  Q
"RTN","PSOORED6",114,0)
 ..I PSORXED("FLD",27)'=$$GETNDC^PSONDCUT(DA,0) D
"RTN","PSOORED6",115,0)
 ...S CHGNDC=1
"RTN","PSOORED6",116,0)
 ...D RXACT^PSOBPSU2(DA,0,"NDC changed from "_$$GETNDC^PSONDCUT(DA,0)_" to "_PSORXED("FLD",27)_".","E")
"RTN","PSOORED6",117,0)
 ..D SAVNDC^PSONDCUT(DA,0,PSORXED("FLD",27),0,1)
"RTN","PSOORED6",118,0)
 .I FLD=81 D SAVDAW^PSODAWUT(DA,0,PSORXED("FLD",81)) Q
"RTN","PSOORED6",119,0)
 .S DR=FLD_"////"_PSORXED("FLD",FLD) D ^DIE
"RTN","PSOORED6",120,0)
 .I FLD=4 D UDPROV^PSOOREDT Q
"RTN","PSOORED6",121,0)
 ;
"RTN","PSOORED6",122,0)
 ; - Re-submitting Rx to ECME due to edits
"RTN","PSOORED6",123,0)
 D RESUB^PSOORED7
"RTN","PSOORED6",124,0)
 ;
"RTN","PSOORED6",125,0)
 I $G(INSDEL) K ^PSRX(DA,"INS"),^PSRX(DA,"INS1") D DOLST^PSOORED3 K PSORXED("SIG") D EN^PSOFSIG(.PSORXED),UPDSIG^PSOORED3 G UPDX
"RTN","PSOORED6",126,0)
 I $O(^TMP($J,"INS1",0)) D
"RTN","PSOORED6",127,0)
 .K ^PSRX(DA,"INS"),^PSRX(DA,"INS1"),DD,PSORXED("SIG")
"RTN","PSOORED6",128,0)
 .F I=0:0 S I=$O(^TMP($J,"INS1",I)) Q:'I  S (PSORXED("SIG",I),^PSRX(DA,"INS1",I,0))=^TMP($J,"INS1",I,0),DD=$G(DD)+1
"RTN","PSOORED6",129,0)
 .S ^PSRX(DA,"INS1",0)=^TMP($J,"INS1",0)
"RTN","PSOORED6",130,0)
 .I DD=1 S ^PSRX(DA,"INS")=^PSRX(DA,"INS1",1,0)
"RTN","PSOORED6",131,0)
 .D DOLST^PSOORED3,EN^PSOFSIG(.PSORXED),UPDSIG^PSOORED3
"RTN","PSOORED6",132,0)
 ;
"RTN","PSOORED6",133,0)
UPDX ;
"RTN","PSOORED6",134,0)
 K DIE,DA,DR,FLD,X,Y,PSORXED("FLD"),DD,^TMP($J,"INS1")
"RTN","PSOORED6",135,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOORED6",136,0)
 Q
"RTN","PSOORED6",137,0)
UPD ;updates dosing array
"RTN","PSOORED6",138,0)
 S HENT=ENT
"RTN","PSOORED6",139,0)
UPD1 ;
"RTN","PSOORED6",140,0)
 I $G(PSORXED("CONJUNCTION",(HENT+1)))]"" S PSORXED("CONJUNCTION",HENT)=PSORXED("CONJUNCTION",(HENT+1)) D  G UPD
"RTN","PSOORED6",141,0)
 .K PSORXED("CONJUNCTION",(HENT+1))
"RTN","PSOORED6",142,0)
 .I $D(PSORXED("DOSE",(HENT+2))) D
"RTN","PSOORED6",143,0)
 ..S PSORXED("DOSE",(HENT+1))=PSORXED("DOSE",(HENT+2))
"RTN","PSOORED6",144,0)
 ..S PSORXED("ODOSE",(HENT+1))=$G(PSORXED("ODOSE",(HENT+2)))
"RTN","PSOORED6",145,0)
 ..S PSORXED("DOSE ORDERED",(HENT+1))=$G(PSORXED("DOSE ORDERED",(HENT+2)))
"RTN","PSOORED6",146,0)
 ..S PSORXED("UNITS",(HENT+1))=$G(PSORXED("UNITS",(HENT+2)))
"RTN","PSOORED6",147,0)
 ..S PSORXED("NOUN",(HENT+1))=$G(PSORXED("NOUN",(HENT+2)))
"RTN","PSOORED6",148,0)
 ..S PSORXED("DURATION",(HENT+1))=$G(PSORXED("DURATION",(HENT+2)))
"RTN","PSOORED6",149,0)
 ..S PSORXED("CONJUNCTION",(HENT+1))=$G(PSORXED("CONJUNCTION",(HENT+2)))
"RTN","PSOORED6",150,0)
 ..S PSORXED("ROUTE",(HENT+1))=$G(PSORXED("ROUTE",(HENT+2)))
"RTN","PSOORED6",151,0)
 ..S PSORXED("SCHEDULE",(HENT+1))=$G(PSORXED("SCHEDULE",(HENT+2)))
"RTN","PSOORED6",152,0)
 ..S PSORXED("VERB",(HENT+1))=$G(PSORXED("VERB",(HENT+2)))
"RTN","PSOORED6",153,0)
 ..K PSORXED("DOSE",(HENT+2)),PSORXED("ODOSE",(HENT+2)),PSORXED("DOSE ORDERED",(HENT+2))
"RTN","PSOORED6",154,0)
 ..K PSORXED("UNITS",(HENT+2)),PSORXED("NOUN",(HENT+2)),PSORXED("DURATION",(HENT+2)),PSORXED("ROUTE",(HENT+2)),PSORXED("SCHEDULE",(HENT+2)),PSORXED("VERB",(HENT+2))
"RTN","PSOORED6",155,0)
 .S HENT=HENT+1
"RTN","PSOORED6",156,0)
 F I=0:0 S I=$O(PSORXED("DOSE",I)) Q:'I  S SENT=$G(SENT)+1
"RTN","PSOORED6",157,0)
 Q
"RTN","PSOORED6",158,0)
 ;
"RTN","PSOORED6",159,0)
M1 D M1^PSOOREDX
"RTN","PSOORED6",160,0)
 Q
"RTN","PSOORED6",161,0)
M2 D M2^PSOOREDX
"RTN","PSOORED6",162,0)
 Q
"RTN","PSOORNE1")
0^7^B88261913^B77126364
"RTN","PSOORNE1",1,0)
PSOORNE1 ;BIR/SAB - Display new orders from backdoor ;03/06/95 10:30am
"RTN","PSOORNE1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,21,27,32,37,46,71,94,104,117,133,148,279,251,372,313,422**;DEC 1997;Build 132
"RTN","PSOORNE1",3,0)
 ;External reference to ^PS(55 is supported by DBIA 2228
"RTN","PSOORNE1",4,0)
EN(PSONEW) D DSPL^PSOORNE3,^PSOLMPO2
"RTN","PSOORNE1",5,0)
 Q
"RTN","PSOORNE1",6,0)
EDT N FLD,FIELDLST K DIR,DUOUT,DIRUT S DIR("A")="Select Field to Edit by number",DIR(0)="LO^1:14" D ^DIR I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DTOUT S VALMBCK="" Q
"RTN","PSOORNE1",7,0)
EDTSEL S:'$G(COPY) PSOEDIT=1 S (PSONEW("DFLG"),PSONEW("FIELD"),PSONEW3)=0
"RTN","PSOORNE1",8,0)
 I +Y S FIELDLST=Y D HLDHDR^PSOLMUTL D  Q:$G(PSORX("DFLG"))!($G(PSORX("QFLG")))  S VALMBCK="R" G DSPL^PSOORNE3
"RTN","PSOORNE1",9,0)
 .F FLD=1:1:$L(FIELDLST,",") Q:$P(FIELDLST,",",FLD)']""  D @(+$P(FIELDLST,",",FLD)) Q:$G(PSODIR("DFLG"))!($G(PSODIR("QFLG")))
"RTN","PSOORNE1",10,0)
 E  S VALMBCK="" D FULL^VALM1
"RTN","PSOORNE1",11,0)
 D RDSPL G DSPL^PSOORNE3
"RTN","PSOORNE1",12,0)
 Q
"RTN","PSOORNE1",13,0)
ACP K VALMSG,DIR,PSORX("DFLG") D VER I $G(PSONEW2("QFLG"))!($G(PSORX("DFLG"))) S VALMBCK="Q" K PSONEW2 Q
"RTN","PSOORNE1",14,0)
 N PSONOBCK S PSONOBCK=$S($G(PSOSIGFL):1,1:0)
"RTN","PSOORNE1",15,0)
 D NOOR^PSONEW I $D(DIRUT) S PSONEW("DFLG")=1 K DIR,X,Y,DIRUT,DUOUT,DTOUT Q
"RTN","PSOORNE1",16,0)
 D RXNCHK,RDSPL
"RTN","PSOORNE1",17,0)
 I $G(PSONEW("QFLG")) S PSONEW("DFLG")=1 K DIR,X,Y,DIRUT,DUOUT,DTOUT Q
"RTN","PSOORNE1",18,0)
 D DISPLAY^PSONEW2
"RTN","PSOORNE1",19,0)
 D ^PSONEWG I $G(PSOCPZ("DFLG")) S PSONEW("DFLG")=1 K PSOANSQ,DIR,X,Y,DIRUT,DUOUT,DTOUT,PSOCPZ("DFLG"),PSOANSQD Q
"RTN","PSOORNE1",20,0)
 K PSOCPZ("DFLG")
"RTN","PSOORNE1",21,0)
 K DIR,DIRUT,X,Y S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is this correct" D ^DIR
"RTN","PSOORNE1",22,0)
 I $D(DIRUT) S PSONEW("DFLG")=1 K PSOANSQ,PSOANSQD,DIR,X,Y,DIRUT,DUOUT,DTOUT Q
"RTN","PSOORNE1",23,0)
 I 'Y S VALMBCK="R" K PSOANSQ,DIR,X,Y,DIRUT,DUOUT,DTOUT D DSPL^PSOORNE3 Q
"RTN","PSOORNE1",24,0)
 W "..." K PSOANSQD,DIR,X,Y,DIRUT,DUOUT,DTOUT D DCORD^PSONEW2
"RTN","PSOORNE1",25,0)
 I $G(NCPDPFLG) D NCPDP^PSOORED6
"RTN","PSOORNE1",26,0)
 K:$G(COPY)!($G(PSOSIGFL)) PRC,PHI
"RTN","PSOORNE1",27,0)
 S:'$G(PSOID) PSOID=DT S (PSORX("FN"),PSONEW("POE"))=1 D EN^PSON52(.PSONEW) ; Files entry in File 52
"RTN","PSOORNE1",28,0)
 ;
"RTN","PSOORNE1",29,0)
 ; - Possible Titration prescription
"RTN","PSOORNE1",30,0)
 I $G(PSONEW("IRXN")) D MARK^PSOOTMRX(PSONEW("IRXN"),0)
"RTN","PSOORNE1",31,0)
 ;
"RTN","PSOORNE1",32,0)
 I $G(PSOBEDT) D
"RTN","PSOORNE1",33,0)
 .I '$D(^TMP("PSOBEDT",$J,PSODFN,0)) S ^TMP("PSOBEDT",$J,PSODFN,0)=PSORXED("IRXN") S:$G(PSONEW("MAIL/WINDOW"))["W" ^TMP("PSOBEDT",$J,PSODFN,1)=1 Q
"RTN","PSOORNE1",34,0)
 .S ^TMP("PSOBEDT",$J,PSODFN,0)=^TMP("PSOBEDT",$J,PSODFN,0)_","_PSORXED("IRXN")
"RTN","PSOORNE1",35,0)
 .I $G(PSONEW("MAIL/WINDOW"))["W" S ^TMP("PSOBEDT",$J,PSODFN,1)=1
"RTN","PSOORNE1",36,0)
 D NPSOSD^PSOUTIL(.PSONEW) ; Adds newly added rx to PSOSD array
"RTN","PSOORNE1",37,0)
 D ^PSOBUILD S VALMBCK="Q"
"RTN","PSOORNE1",38,0)
 K PSONEW("# OF REFILLS"),PSONEW("DAYS SUPPLY"),SDA,SEG1,SSN1,STA,Z4,ZDA
"RTN","PSOORNE1",39,0)
 Q:$G(COPY)  S PSONEW("DFLG")=0
"RTN","PSOORNE1",40,0)
 Q
"RTN","PSOORNE1",41,0)
VER I $G(PSOAC),$G(PSODRUG("NAME"))']"" D FULL^VALM1,2^PSOORNW1
"RTN","PSOORNE1",42,0)
 I $G(PSODRUG("NAME"))']"" S VALMSG="A Dispense Drug Must be Chosen!" S PSONEW2("QFLG")=1 Q
"RTN","PSOORNE1",43,0)
 I '$G(PSONEW("ENT")) W !,"Dosing Instruction Missing!!",! D  I PSONEW("DFLG")=1 S PSONEW2("QFLG")=1 Q
"RTN","PSOORNE1",44,0)
 .S PSOORRNW=1
"RTN","PSOORNE1",45,0)
 .K VALMSG D FULL^VALM1 W !,"Drug: "_PSODRUG("NAME")
"RTN","PSOORNE1",46,0)
 .I $O(SIG(0)) F I=1:1 Q:$G(SIG(I))']""  W !,SIG(I)
"RTN","PSOORNE1",47,0)
 .E   I $G(^PSRX(PSONEW("OIRXN"),"SIG"))]"" S X=$P(^PSRX(PSONEW("OIRXN"),"SIG"),"^") D SIGONE^PSOHELP W !,$E($G(INS1),2,250)
"RTN","PSOORNE1",48,0)
 .W ! D 5 K PSOORRNW I PSONEW("DFLG")=1 D M3 Q
"RTN","PSOORNE1",49,0)
 .D 6 D:PSONEW("DFLG")=1 M3
"RTN","PSOORNE1",50,0)
 D:$G(COPY) PROV^PSOUTIL(.PSORENW) I $G(PSONEW("DFLG"))=1 S PSONEW2("QFLG")=1 Q
"RTN","PSOORNE1",51,0)
 N PSODOSD D FULL^VALM1,POST^PSODRG:'$G(PSOSIGFL)
"RTN","PSOORNE1",52,0)
 I $G(POERR("DFLG"))=1 S (PSONEW("DFLG"),PSONEW2("QFLG"))=1 Q
"RTN","PSOORNE1",53,0)
 I $G(PSODOSD) S (PSONEW("DFLG"),PSONEW2("QFLG"))=1 Q
"RTN","PSOORNE1",54,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("N") K PSONOOR I $G(PSORX("DFLG")) S VALMBCK="Q" Q
"RTN","PSOORNE1",55,0)
 I +$G(PSEXDT) D
"RTN","PSOORNE1",56,0)
 .D FULL^VALM1 S:$G(PSONEW("MAIL/WINDOW"))["W" BINGCRT="Y",BINGRTE="W"
"RTN","PSOORNE1",57,0)
 .D:+$G(PSEXDT)
"RTN","PSOORNE1",58,0)
 ..S Y=PSONEW("FILL DATE") X ^DD("DD") W !!,$C(7),Y_" fill date is greater than possible expiration date of " S Y=$P(PSEXDT,"^",2) X ^DD("DD") W Y_"."
"RTN","PSOORNE1",59,0)
 .S PSONEW2("QFLG")=1,VALMBCK="R" D PAUSE^VALM1
"RTN","PSOORNE1",60,0)
 Q
"RTN","PSOORNE1",61,0)
1 I $G(PSOSIGFL)!$G(PSOMTFLG) D  Q
"RTN","PSOORNE1",62,0)
 . S PSOAC=1 D 2^PSOORNW1 D:'$G(PSORX("DFLG")) 10^PSOBKDED K PSOAC Q:$G(PSORX("DFLG"))  D RDSPL D DSPL^PSOORNE3
"RTN","PSOORNE1",63,0)
 . I $G(PSOMTFLG),$G(PSORXED("DRUG IEN"))'=$G(PSODRUG("IEN")) D
"RTN","PSOORNE1",64,0)
 . . I FIELDLST'["5," D 5 Q:$G(PSODIR("DFLG"))!($G(PSODIR("QFLG")))
"RTN","PSOORNE1",65,0)
 . . I FIELDLST'["6," D 6 Q:$G(PSODIR("DFLG"))!($G(PSODIR("QFLG")))
"RTN","PSOORNE1",66,0)
 . . I FIELDLST'["8," D 8 Q:$G(PSODIR("DFLG"))!($G(PSODIR("QFLG")))
"RTN","PSOORNE1",67,0)
 ;
"RTN","PSOORNE1",68,0)
 D 6^PSOBKDED D RDSPL G DSPL^PSOORNE3 Q
"RTN","PSOORNE1",69,0)
 ;
"RTN","PSOORNE1",70,0)
2 D 3^PSOBKDED Q
"RTN","PSOORNE1",71,0)
 ;
"RTN","PSOORNE1",72,0)
3 D 1^PSOBKDED Q
"RTN","PSOORNE1",73,0)
 ;
"RTN","PSOORNE1",74,0)
4 D 2^PSOBKDED Q
"RTN","PSOORNE1",75,0)
 ;
"RTN","PSOORNE1",76,0)
5 I '$G(PSODRUG("IEN")) W !,"DRUG NAME REQUIRED!" D 2^PSOORNW1 I '$G(PSODRUG("IEN")) S VALMSG="No Dispense Drug Selected" Q
"RTN","PSOORNE1",77,0)
 W !!,"Drug: "_PSODRUG("NAME") D 10^PSOBKDED Q
"RTN","PSOORNE1",78,0)
 ;
"RTN","PSOORNE1",79,0)
6 ;D INS^PSOBKDED Q:$G(PSONEW("DFLG"))  I $P($G(^PS(55,PSODFN,"LAN")),"^") D SINS^PSODIR(.PSONEW)  ;*422
"RTN","PSOORNE1",80,0)
 N PSOINSCH,PSODELINS
"RTN","PSOORNE1",81,0)
 S:'$D(PSOOEINS) PSOOEINS=$G(PSONEW("INS")) S:'$D(PSOOSINS) PSOOSINS=$G(PSONEW("SINS"))
"RTN","PSOORNE1",82,0)
 I '$P($G(^PS(55,PSODFN,"LAN")),"^") D INS^PSOBKDED Q:$G(PSONEW("DFLG"))
"RTN","PSOORNE1",83,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") D
"RTN","PSOORNE1",84,0)
 .N PSODONE S (PSODONE,PSODELINS)=0
"RTN","PSOORNE1",85,0)
 .F  D  Q:PSODONE
"RTN","PSOORNE1",86,0)
 ..K PSONEW("DFLG")
"RTN","PSOORNE1",87,0)
 ..D INS^PSOBKDED
"RTN","PSOORNE1",88,0)
 ..I '$G(PSONEW("DFLG")),'PSODONE,'$G(PSODELINS) D SINS^PSODIR(.PSONEW)
"RTN","PSOORNE1",89,0)
 ..;POSS NOT NEEDED;I $G(PSONEW("DFLG")) S PSODONE=1,(PSONEW("SIG"),PSONEW("INS"))=$G(PSOOEINS),PSONEW("SINS")=$G(PSOOSINS) K PSONEW("SIG") D EN^PSOFSIG(.PSONEW,1) Q
"RTN","PSOORNE1",90,0)
 ..I $G(PSONEW("DFLG")) S (X,Y)=$G(PSONEW("INS")) D SIG^PSOHELP S (PSONEW("SIG",1),PSONEW("SIG"))=$E($G(INS1),2,9999999) K X,Y,PSONEW("DFLG") S PSODONE=1 Q
"RTN","PSOORNE1",91,0)
 ..S PSOINSCH=$$INSCHK^PSOHELP3(.PSONEW)
"RTN","PSOORNE1",92,0)
 ..I '$G(PSOINSCH) S PSODONE=1
"RTN","PSOORNE1",93,0)
 ;
"RTN","PSOORNE1",94,0)
 K PSOOEINS,PSOOSINS
"RTN","PSOORNE1",95,0)
 Q
"RTN","PSOORNE1",96,0)
 ;
"RTN","PSOORNE1",97,0)
7 D 8^PSOBKDED Q
"RTN","PSOORNE1",98,0)
 ;
"RTN","PSOORNE1",99,0)
8 D 7^PSOBKDED Q
"RTN","PSOORNE1",100,0)
 ;
"RTN","PSOORNE1",101,0)
9 D 9^PSOBKDED Q
"RTN","PSOORNE1",102,0)
 ;
"RTN","PSOORNE1",103,0)
10 D 12^PSOBKDED Q
"RTN","PSOORNE1",104,0)
 ;
"RTN","PSOORNE1",105,0)
11 D 5^PSOBKDED Q
"RTN","PSOORNE1",106,0)
 ;
"RTN","PSOORNE1",107,0)
12 D 4^PSOBKDED Q
"RTN","PSOORNE1",108,0)
 ;
"RTN","PSOORNE1",109,0)
13 D 11^PSOBKDED Q
"RTN","PSOORNE1",110,0)
 ;
"RTN","PSOORNE1",111,0)
14 D 13^PSOBKDED Q
"RTN","PSOORNE1",112,0)
 ;
"RTN","PSOORNE1",113,0)
SUMM ;print break down of orders to be finished
"RTN","PSOORNE1",114,0)
 K ^TMP($J,"PSOCZT"),^TMP($J,"PSODPAT"),PAT,RT,DIR,DUOUT,DIRUT,PSZLQUIT
"RTN","PSOORNE1",115,0)
 S DIR("A")="Do you want an Order Summary",DIR(0)="Y",DIR("B")="No"
"RTN","PSOORNE1",116,0)
 D ^DIR K DIR I 'Y!($D(DIRUT)) K Y,X,DIRUT Q
"RTN","PSOORNE1",117,0)
 K PSOINPRT,DIQ,^UTILITY("DIQ1",$J) I $G(PSOPINST) S DA=PSOPINST,DIC=4,DIQ(0)="E",DR=".01" D EN^DIQ1 S PSOINPRT=$G(^UTILITY("DIQ1",$J,4,DA,.01,"E")) K ^UTILITY("DIQ1",$J),DA,DR,DIC,DIQ
"RTN","PSOORNE1",118,0)
 I $D(^PS(52.41,"ACL")) N PSOCLSUM D SUMMCL I $G(PSOCLSUM) K PSOINPRT Q
"RTN","PSOORNE1",119,0)
 F PSI=0:0 S PSI=$O(^PS(52.41,"AOR",PSI)) Q:'PSI  F PSID=0:0 S PSID=$O(^PS(52.41,"AOR",PSI,PSID)) Q:'PSID  F PIN=0:0 S PIN=$O(^PS(52.41,"AOR",PSI,PSID,PIN)) Q:'PIN  D
"RTN","PSOORNE1",120,0)
 .I '$D(^TMP($J,"PSOCZT",PSID,"PAT")) F PZA="PAT","WIN","MAIL","CLIN" S ^TMP($J,"PSOCZT",PSID,PZA)=0
"RTN","PSOORNE1",121,0)
 .I '$D(^TMP($J,"PSODPAT",PSID,PSI)) S ^TMP($J,"PSODPAT",PSID,PSI)=1,^TMP($J,"PSOCZT",PSID,"PAT")=^TMP($J,"PSOCZT",PSID,"PAT")+1
"RTN","PSOORNE1",122,0)
 .S PZROUT=$P($G(^PS(52.41,PIN,0)),"^",17) I PZROUT'="" S ^TMP($J,"PSOCZT",PSID,$S(PZROUT="C":"CLIN",PZROUT="M":"MAIL",1:"WIN"))=^TMP($J,"PSOCZT",PSID,$S(PZROUT="C":"CLIN",PZROUT="M":"MAIL",1:"WIN"))+1
"RTN","PSOORNE1",123,0)
 W @IOF W !?20,"Pending Outpatient Medication Orders",! I $G(PSZCNT)>1 W ?20,"(signed in under "_$G(PSOINPRT)_")",!
"RTN","PSOORNE1",124,0)
 F PSOINL=0:0 S PSOINL=$O(^TMP($J,"PSOCZT",PSOINL)) Q:'PSOINL!($G(PSZLQUIT))  D
"RTN","PSOORNE1",125,0)
 .I ($Y+6)>IOSL K DIR S DIR(0)="E" D ^DIR K DIR D:$G(Y)  I '$G(Y) S PSZLQUIT=1 W ! Q
"RTN","PSOORNE1",126,0)
 ..W @IOF W !?20,"Pending Outpatient Medication Orders",! I $G(PSZCNT)>1 W ?20,"(signed in under "_$G(PSOINPRT)_")",!
"RTN","PSOORNE1",127,0)
 .K ^UTILITY("DIQ1",$J),DIQ,PSOINPRX S DA=$G(PSOINL),DIC=4,DIQ(0)="E",DR=".01" D EN^DIQ1 S PSOINPRX=$G(^UTILITY("DIQ1",$J,4,DA,.01,"E")) K ^UTILITY("DIQ1",$J),DA,DR,DIC,DIQ
"RTN","PSOORNE1",128,0)
 .;PSO*7*279 Change division to Institution
"RTN","PSOORNE1",129,0)
 .W !,"Institution: ",$G(PSOINPRX)
"RTN","PSOORNE1",130,0)
 .W !,"Patients: "_$G(^TMP($J,"PSOCZT",PSOINL,"PAT"))_"  Window: "_$G(^("WIN"))_"  Mail: "_$G(^("MAIL"))_"  Clinic: "_$G(^("CLIN")),!
"RTN","PSOORNE1",131,0)
 K DIR S DIR(0)="E",(DIR("A"),DIR("?"))="Press Return to Continue" D ^DIR K DIR
"RTN","PSOORNE1",132,0)
 K ^TMP($J,"PSOCZT"),^TMP($J,"PSODPAT"),RT,PSOINPRT,PSOINPRX,PSI,PSID,PIN,PZA,PZROUT,PSOINL,PSZLQUIT
"RTN","PSOORNE1",133,0)
 Q
"RTN","PSOORNE1",134,0)
SUMMCL ;
"RTN","PSOORNE1",135,0)
 ;PSO*7*279 Change Division to Institution
"RTN","PSOORNE1",136,0)
 W ! K DIR S DIR(0)="SMB^I:INSTITUTION;C:CLINIC",DIR("A")="Do you want the summary by Institution or Clinic",DIR("B")="Institution",DIR("?")=" "
"RTN","PSOORNE1",137,0)
 S DIR("?",1)="Enter 'I' to see the summary by Institution, and within Institution the orders",DIR("?",2)="shown by Mail, Window, or Administered in Clinic.",DIR("?",3)="Enter 'C' to see the summary by Clinic, along with Clinic Sort Groups."
"RTN","PSOORNE1",138,0)
 D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) S PSOCLSUM=1 Q
"RTN","PSOORNE1",139,0)
 Q:$G(Y)="I"
"RTN","PSOORNE1",140,0)
 S PSOCLSUM=1
"RTN","PSOORNE1",141,0)
 K ^TMP($J,"PSOLOC"),^TMP($J,"PSOLOCP") N PSCX,PSCXL,PSLX,PSCIN,PSCPT,PSCNDE,PSNCL,PSNPAT,PSCLOUT,PSCSFLAG,PCCNT,PSOCAG
"RTN","PSOORNE1",142,0)
 F PSCX=0:0 S PSCX=$O(^PS(52.41,"ACL",PSCX)) Q:'PSCX  F PSLX=0:0 S PSLX=$O(^PS(52.41,"ACL",PSCX,PSLX)) Q:'PSLX  F PSCIN=0:0 S PSCIN=$O(^PS(52.41,"ACL",PSCX,PSLX,PSCIN)) Q:'PSCIN  S PSCPT=+$P($G(^PS(52.41,PSCIN,0)),"^",2) D:PSCPT
"RTN","PSOORNE1",143,0)
 .S PSCNDE=$G(^PS(52.41,PSCIN,0))
"RTN","PSOORNE1",144,0)
 .I $P(PSCNDE,"^",3)'="NW",$P(PSCNDE,"^",3)'="RNW",$P(PSCNDE,"^",3)'="RF" Q
"RTN","PSOORNE1",145,0)
 .I $P(PSCNDE,"^",13)="" Q
"RTN","PSOORNE1",146,0)
 .S PSNCL=+$P(PSCNDE,"^",13),PSNPAT=+$P(PSCNDE,"^",2)
"RTN","PSOORNE1",147,0)
 .I '$D(^TMP($J,"PSOLOC",PSNCL)) S ^TMP($J,"PSOLOC",PSNCL)="1^1",^TMP($J,"PSOLOCP",PSNCL,PSNPAT)="" Q
"RTN","PSOORNE1",148,0)
 .S $P(^TMP($J,"PSOLOC",PSNCL),"^",2)=$P(^TMP($J,"PSOLOC",PSNCL),"^",2)+1
"RTN","PSOORNE1",149,0)
 .I '$D(^TMP($J,"PSOLOCP",PSNCL,PSNPAT)) S $P(^TMP($J,"PSOLOC",PSNCL),"^")=$P(^TMP($J,"PSOLOC",PSNCL),"^")+1
"RTN","PSOORNE1",150,0)
 .S ^TMP($J,"PSOLOCP",PSNCL,PSNPAT)=""
"RTN","PSOORNE1",151,0)
 I '$O(^TMP($J,"PSOLOC",0)) G SUMMQ
"RTN","PSOORNE1",152,0)
 W @IOF W !?20,"Pending Outpatient Medication Orders" I $G(PSZCNT)>1 W !?20,"(signed in under "_$G(PSOINPRT)_")"
"RTN","PSOORNE1",153,0)
 F PSCXL=0:0 S PSCXL=$O(^TMP($J,"PSOLOC",PSCXL)) Q:'PSCXL!($G(PSCLOUT))  D
"RTN","PSOORNE1",154,0)
 .I ($Y+7)>IOSL D CLDIR Q:$G(PSCLOUT)
"RTN","PSOORNE1",155,0)
 .W !!,"Clinic:   ",$P($G(^SC(+PSCXL,0)),"^")
"RTN","PSOORNE1",156,0)
 .W !,"Patients: ",$P($G(^TMP($J,"PSOLOC",PSCXL)),"^"),?16,"Orders: ",$P($G(^TMP($J,"PSOLOC",PSCXL)),"^",2)
"RTN","PSOORNE1",157,0)
 .W !,"In Sort Groups:"
"RTN","PSOORNE1",158,0)
 .S (PCCNT,PSCSFLAG)=0 F PSCSORT=0:0 S PSCSORT=$O(^PS(59.8,PSCSORT)) Q:'PSCSORT!($G(PSCLOUT))  I $D(^PS(59.8,PSCSORT,1,"B",PSCXL)) S PSOCAG=0 D
"RTN","PSOORNE1",159,0)
 ..S PSCSFLAG=1 S:($Y+5)>IOSL&(PCCNT) PSOCAG=1 D:($Y+5)>IOSL&(PCCNT) CLDIR Q:$G(PSCLOUT)  W:$G(PSOCAG) !,"Clinic: "_$P($G(^SC(PSCXL,0)),"^")_"   cont." W:$G(PCCNT)>0 ! W ?16,$P($G(^PS(59.8,PSCSORT,0)),"^") S PCCNT=1
"RTN","PSOORNE1",160,0)
 .I '$G(PSCSFLAG) W ?16,"*** NO CLINIC SORT GROUPS ***"
"RTN","PSOORNE1",161,0)
 I '$G(PSCLOUT) K DIR S DIR(0)="E",(DIR("A"),DIR("?"))="Press Return to continue"  D ^DIR K DIR
"RTN","PSOORNE1",162,0)
SUMMQ K ^TMP($J,"PSOLOC"),^TMP($J,"PSOLOCP")
"RTN","PSOORNE1",163,0)
 Q
"RTN","PSOORNE1",164,0)
CLDIR K DIR S DIR(0)="E",(DIR("A"),DIR("?"))="Press Return to continue, '^' to exit" D ^DIR K DIR I Y'=1 S PSCLOUT=1 Q
"RTN","PSOORNE1",165,0)
 W @IOF
"RTN","PSOORNE1",166,0)
 Q
"RTN","PSOORNE1",167,0)
RXNCHK I $G(PSONEW("RX #"))']"" D RXNCHK^PSOORNE5
"RTN","PSOORNE1",168,0)
 Q
"RTN","PSOORNE1",169,0)
RDSPL D RDSPL^PSOORNE5
"RTN","PSOORNE1",170,0)
 Q
"RTN","PSOORNE1",171,0)
M3 D M3^PSOOREDX
"RTN","PSOORNE1",172,0)
 Q
"RTN","PSOORNW1")
0^10^B34134148^B34256749
"RTN","PSOORNW1",1,0)
PSOORNW1 ;ISC BHAM/SAB - continuation of finish of new order ;5/10/07 8:30am
"RTN","PSOORNW1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**23,46,78,117,131,133,172,148,222,268,206,251,379,391,313,444,469,422**;DEC 1997;Build 132
"RTN","PSOORNW1",3,0)
 ;Reference ^YSCL(603.01 supported by DBIA 2697
"RTN","PSOORNW1",4,0)
 ;Reference ^PS(55 supported by DBIA 2228
"RTN","PSOORNW1",5,0)
 ;Reference ^PSDRUG( supported by DBIA 221
"RTN","PSOORNW1",6,0)
 ;Reference to $$GETNDC^PSSNDCUT supported by IA 4707
"RTN","PSOORNW1",7,0)
 ;
"RTN","PSOORNW1",8,0)
2 I $G(ORD),$G(ORSV) W !!,"Instructions: " D
"RTN","PSOORNW1",9,0)
 .S INST=0 F  S INST=$O(^PS(52.41,ORD,2,INST)) Q:'INST  S (MIG,INST(INST))=^PS(52.41,ORD,2,INST,0) D
"RTN","PSOORNW1",10,0)
 ..F SG=1:1:$L(MIG," ") W:$X+$L($P(MIG," ",SG)_" ")>IOM !?14 W $P(MIG," ",SG)_" "
"RTN","PSOORNW1",11,0)
 .S:'$D(PSODRUG("OI")) PSODRUG("OI")=$P(OR0,"^",8)
"RTN","PSOORNW1",12,0)
 .K INST,TY,MIG,SG
"RTN","PSOORNW1",13,0)
 N DEFAULT
"RTN","PSOORNW1",14,0)
 S (PSDC,PSI,DEFAULT)=0 W !!,"The following Drug(s) are available for selection:"
"RTN","PSOORNW1",15,0)
 F PSI=0:0 S PSI=$O(^PSDRUG("ASP",PSODRUG("OI"),PSI)) Q:'PSI  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["O":0,1:1) D
"RTN","PSOORNW1",16,0)
 .S PSDC=PSDC+1 W !,PSDC_". "_$P(^PSDRUG(PSI,0),"^")_$S($P(^(0),"^",9):"     (N/F)",1:"")
"RTN","PSOORNW1",17,0)
 .S PSDC(PSDC)=PSI I $G(PSORXED("DRUG IEN")),PSI=$G(PSORXED("DRUG IEN")) S DEFAULT=PSDC
"RTN","PSOORNW1",18,0)
 I PSDC=0 D
"RTN","PSOORNW1",19,0)
 . N X,DRG
"RTN","PSOORNW1",20,0)
 . S DRG=+$P($G(^PS(52.41,+$G(ORD),0)),"^",9)
"RTN","PSOORNW1",21,0)
 . S X=$$GET1^DIQ(50,DRG,100)
"RTN","PSOORNW1",22,0)
 . I X'="",(DT>X) D
"RTN","PSOORNW1",23,0)
 . . W !!,"   This Dispense Drug is now Inactive. You may select a"
"RTN","PSOORNW1",24,0)
 . . W !,"    new Orderable Item, or you can enter a new Order with"
"RTN","PSOORNW1",25,0)
 . . W !,"    an Active Drug.",!
"RTN","PSOORNW1",26,0)
 . E  W !!,"No drugs available!",!
"RTN","PSOORNW1",27,0)
 . K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press return to continue"
"RTN","PSOORNW1",28,0)
 . D ^DIR K DIR
"RTN","PSOORNW1",29,0)
 G:'PSDC ETX I $G(PSOBDRG),'$D(PSOBDR) M PSOBDR=PSODRUG
"RTN","PSOORNW1",30,0)
 I PSDC'=1 D
"RTN","PSOORNW1",31,0)
 .I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),2)),"^")=$G(PSODRUG("OI")) Q
"RTN","PSOORNW1",32,0)
 .K PSODRUG("NAME"),PSODRUG("IEN")
"RTN","PSOORNW1",33,0)
 W ! D KV
"RTN","PSOORNW1",34,0)
 S DIR(0)="N^1:"_PSDC S:$G(DEFAULT) DIR("B")=DEFAULT
"RTN","PSOORNW1",35,0)
 S DIR("A")="Select Drug by number" D ^DIR
"RTN","PSOORNW1",36,0)
 I $D(DIRUT) S OUT=1 G EX
"RTN","PSOORNW1",37,0)
 D KV K PSOY S PSOY=PSDC(Y),PSOY(0)=^PSDRUG(PSOY,0),PSOCSIG=0
"RTN","PSOORNW1",38,0)
 I $G(PSOBDR("IEN")),PSOBDR("IEN")'=+PSOY D:$G(ORD)  ;G:$D(DIRUT) EX ;*422
"RTN","PSOORNW1",39,0)
 .N PSOMSG S PSOMSG(1)="You have changed the dispense drug from",PSOMSG(2)=$G(PSOBDR("NAME"))_" to "_$P(^PSDRUG(+PSOY,0),"^")_"." D EN^DDIOL(.PSOMSG,"","!") S (PSOAC,PSOCSIG)=1  ;*422
"RTN","PSOORNW1",40,0)
 .K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press return to continue" ;*422
"RTN","PSOORNW1",41,0)
 .D ^DIR K DIR ;*422
"RTN","PSOORNW1",42,0)
CT1 I $P($G(^PSDRUG(PSOY,"CLOZ1")),"^")="PSOCLO1",'$O(^YSCL(603.01,"C",PSODFN,0)) D  Q
"RTN","PSOORNW1",43,0)
 .S VALMSG="Patient Not Registered in Clozapine Program",VALMBCK="Q" K PSOY,PSDC
"RTN","PSOORNW1",44,0)
 I $G(ORD) S ^TMP("PSORXPO",$J,ORD,0)=1
"RTN","PSOORNW1",45,0)
 S PSODRUG("IEN")=+PSOY,PSODRUG("VA CLASS")=$P(PSOY(0),"^",2),PSODRUG("NAME")=$P(PSOY(0),"^")
"RTN","PSOORNW1",46,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(+PSOY,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOORNW1",47,0)
 S PSODRUG("MAXDOSE")=$P(PSOY(0),"^",4),PSODRUG("DEA")=$P(PSOY(0),"^",3),PSODRUG("CLN")=$S($D(^PSDRUG(+PSOY,"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSOORNW1",48,0)
 S PSODRUG("SIG")=$P(PSOY(0),"^",5),PSODRUG("NDC")=$$GETNDC^PSSNDCUT(+PSOY,$G(PSOSITE)),PSODRUG("STKLVL")=$G(^PSDRUG(+PSOY,660.1))
"RTN","PSOORNW1",49,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,+PSOY,81)
"RTN","PSOORNW1",50,0)
 S PSOX1=$G(^PSDRUG(+PSOY,660)),PSODRUG("COST")=$P($G(PSOX1),"^",6),PSODRUG("UNIT")=$P($G(PSOX1),"^",8),PSODRUG("EXPIRATION DATE")=$P($G(PSOX1),"^",9)
"RTN","PSOORNW1",51,0)
 D:('$G(PSOFIN)&('$G(PSOCOPY)))!($G(PSOAC)) POST^PSODRG I $G(PSORX("DFLG")) K PSODRUG N LST Q:$G(PSOAC)!($G(NEWEDT))  D DSPL^PSOORFI1 S VALMBCK="Q" Q
"RTN","PSOORNW1",52,0)
ETX D REF S VALMBCK="R" I 'PSDC S VALMSG="NO dispense drugs tied to this orderable item!" S PSOQFLG=1
"RTN","PSOORNW1",53,0)
TX D KV K PSDC,PSI,X,Y,PSOX1,PSOY
"RTN","PSOORNW1",54,0)
 Q
"RTN","PSOORNW1",55,0)
EX M PSODRUG=PSOBDR K PSOBDR,PSOBDRG S PSOQFLG=1,VALMBCK="R" D MP1^PSOOREDX
"RTN","PSOORNW1",56,0)
 D TX Q
"RTN","PSOORNW1",57,0)
URX D KV S DIR(0)="Y",DIR("A")="Are You Sure You Want to Update Rx",DIR("B")="Yes"
"RTN","PSOORNW1",58,0)
 D ^DIR S:$D(DIRUT)!('Y) DIRUT=1
"RTN","PSOORNW1",59,0)
 I Y S ^TMP("PSORXPO",$J,ORD,0)=1 ;screens 4 order checks
"RTN","PSOORNW1",60,0)
 Q
"RTN","PSOORNW1",61,0)
REF ;
"RTN","PSOORNW1",62,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSOORNW1",63,0)
 N MAXRF S MAXRF=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),+$G(PSONEW("DAYS SUPPLY")),+$G(PSONEW("PATIENT STATUS")),.CLOZPAT)
"RTN","PSOORNW1",64,0)
 I ($G(PSONEW("# OF REFILLS"))'="")&($G(PSONEW("# OF REFILLS"))'>MAXRF) D
"RTN","PSOORNW1",65,0)
 . S PSONEW("N# REF")=PSONEW("# OF REFILLS")
"RTN","PSOORNW1",66,0)
 E  D
"RTN","PSOORNW1",67,0)
 . S (PSONEW("N# REF"),PSONEW("# OF REFILLS"))=MAXRF
"RTN","PSOORNW1",68,0)
 Q
"RTN","PSOORNW1",69,0)
 ;
"RTN","PSOORNW1",70,0)
EDNEW ;
"RTN","PSOORNW1",71,0)
 N MAXRF S MAXRF=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),+$G(PSONEW("DAYS SUPPLY")),+$G(PSONEW("PATIENT STATUS")),.CLOZPAT)
"RTN","PSOORNW1",72,0)
 I PSRF>MAXRF D
"RTN","PSOORNW1",73,0)
 .W $C(7),!!,PSRF_" refills are not correct for a "_PSDAYS_" day supply.",!,"Please enter correct # of refills for a "_PSDAYS_" day supply. Max refills allowed is "_MAXRF_".",!
"RTN","PSOORNW1",74,0)
 .S (PSMAX("MAX"),PSFMAX("MAX"))=MAXRF,(PSMAX("RF"),PSFMAX("RF"))=PSRF,(PSMAX("DAYS"),PSFMAX("DAYS"))=PSDAYS,(PSMAX,PSFMAX)=1
"RTN","PSOORNW1",75,0)
 K PSTMAX D EDSTAT
"RTN","PSOORNW1",76,0)
 Q
"RTN","PSOORNW1",77,0)
STATDAY K PSMAX,PSRMAX,PSFMAX,PSTMAX S PSDAYS=$P(^PSRX(DA,0),"^",8),PSRF=$P(^PSRX(DA,0),"^",9),PTST=$P(^PS(53,X,0),"^"),PTDY=$P(^(0),"^",3),PTRF=$P(^(0),"^",4)
"RTN","PSOORNW1",78,0)
EDSTAT I PSRF>PTRF W !,$C(7),PSRF_" refills are greater than "_PTRF_" allowed for "_$P(PTST,"^")_" Rx Patient Status.",! S PSTMAX=1,PSTMAX("PTRF")=PTRF,PSTMAX("PSRF")=PSRF,PSTMAX("PT")=$P(PTST,"^")
"RTN","PSOORNW1",79,0)
 Q
"RTN","PSOORNW1",80,0)
OERF S DIR(0)="N^0:"_PSOX,DIR("A")="# OF REFILLS"
"RTN","PSOORNW1",81,0)
 S DIR("B")=$S($G(POERR):PSONEW("# OF REFILLS"),$G(PSONEW("N# REF"))]"":PSONEW("N# REF"),$G(PSONEW("# OF REFILLS"))]"":PSONEW("# OF REFILLS"),$G(PSOX1)]""&(PSOX>PSOX1):PSOX1,1:PSOX)
"RTN","PSOORNW1",82,0)
 S DIR("?")="Enter a whole number.  The maximum is set by the Rx Patient Status because there is no Dispense Drug."
"RTN","PSOORNW1",83,0)
 D ^DIR G:$D(DIRUT) REFX
"RTN","PSOORNW1",84,0)
 S (PSONEW("N# REF"),PSONEW("# OF REFILLS"))=Y
"RTN","PSOORNW1",85,0)
REFX S:'$D(PSONEW("# OF REFILLS")) PSONEW("# OF REFILLS")=$S($G(PSONEW("N# REF"))]"":PSONEW("N# REF"),$G(PSOX1)]""&($G(PSOX)>PSOX1):PSOX1,1:PSOX)
"RTN","PSOORNW1",86,0)
 K X,Y,PSOX,PSOX1,PSDY,PSDY1,DEA
"RTN","PSOORNW1",87,0)
KV K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOORNW1",88,0)
 Q
"RTN","PSOORNW2")
0^21^B49647517^B45717814
"RTN","PSOORNW2",1,0)
PSOORNW2 ;ISC-BHAM/SAB - edit orders from oerr ; 6/28/07 11:36am
"RTN","PSOORNW2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,23,37,46,117,131,133,148,222,269,206,251,422**;DEC 1997;Build 132
"RTN","PSOORNW2",3,0)
 ;Reference to ^YSCL(603.01 supported by DBIA 2697
"RTN","PSOORNW2",4,0)
 ;Reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORNW2",5,0)
 ;Reference to ^PSDRUG( supported by DBIA 221
"RTN","PSOORNW2",6,0)
 ;Reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOORNW2",7,0)
 ;Reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORNW2",8,0)
 ;Reference to $$GETNDC^PSSNDCUT supported by IA 4707
"RTN","PSOORNW2",9,0)
 ;
"RTN","PSOORNW2",10,0)
1 I $G(PSODRUG("OI")) M:$G(PSOBDRG) PSOBDR=PSODRUG W !!,"Current Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSOORNW2",11,0)
 S DIC("B")=$S($G(PSODRUG("OIN"))]"":PSODRUG("OIN"),1:""),DIC="^PS(50.7,",DIC(0)="AEMQZ"
"RTN","PSOORNW2",12,0)
 S DIC("S")="I '$P(^PS(50.7,+Y,0),""^"",4)!($P(^(0),""^"",4)'<DT) N PSOF,PSOL S (PSOF,PSOL)=0 F  S PSOL=$O(^PSDRUG(""ASP"",+Y,PSOL)) Q:PSOF!'PSOL  "
"RTN","PSOORNW2",13,0)
 S DIC("S")=DIC("S")_"I $P($G(^PSDRUG(PSOL,2)),U,3)[""O"",'$G(^(""I""))!($G(^(""I""))'<DT) S PSOF=1"
"RTN","PSOORNW2",14,0)
 ;BHW;PSO*7*269;Modify ^DIC call to call MIX^DIC to use only the B and C Cross-References.
"RTN","PSOORNW2",15,0)
 S D="B^C" D MIX^DIC1 K DIC,D I X["^"!($D(DTOUT)) S OUT=1 Q
"RTN","PSOORNW2",16,0)
 S PSOY=Y
"RTN","PSOORNW2",17,0)
 I +Y'=OI D  I 'Y!($D(DIRUT)) D KV,MP1^PSOOREDX K DIC,Y,PSOY S OUT=1 Q
"RTN","PSOORNW2",18,0)
 .D KV S DIR(0)="Y",DIR("B")="NO",DIR("A",1)="",DIR("A")="This edit will create a new order.  Do you want to continue" D ^DIR
"RTN","PSOORNW2",19,0)
 G:Y<1 1 S PSODRUG("OI")=+PSOY,PSODRUG("OIN")=$P(PSOY,"^",2),PSONEW("CLERK CODE")=DUZ D KV K DIC,PSOY
"RTN","PSOORNW2",20,0)
 N PSOIC S PSOIC=1 D DREN
"RTN","PSOORNW2",21,0)
 D 2^PSOORNEW Q
"RTN","PSOORNW2",22,0)
4 S PSONEW("FLD")=1 D ISSDT^PSODIR2(.PSONEW) ; Issue Date
"RTN","PSOORNW2",23,0)
 I PSOID>PSONEW("FILL DATE") S PSONEW("FILL DATE")=PSOID,PSORX("FILL DATE")=PSORX("ISSUE DATE")
"RTN","PSOORNW2",24,0)
 Q
"RTN","PSOORNW2",25,0)
 ;
"RTN","PSOORNW2",26,0)
5 S PSONEW("FLD")=2 D FILLDT^PSODIR2(.PSONEW) ; Fill date
"RTN","PSOORNW2",27,0)
 Q
"RTN","PSOORNW2",28,0)
 ;
"RTN","PSOORNW2",29,0)
INS I '$P($G(^PS(55,PSODFN,"LAN")),"^") S PSONEW("FLD")=114 D INS^PSODIR(.PSONEW) Q  ; Get Patient Instructions
"RTN","PSOORNW2",30,0)
 N PSOINSCH,PSODONE,PSOOEINS,PSOOSINS S PSODONE=0
"RTN","PSOORNW2",31,0)
 S:'$D(PSOOEINS) PSOOEINS=$G(PSONEW("INS",1)) S:'$D(PSOOSINS) PSOOSINS=$G(PSONEW("SINS"))
"RTN","PSOORNW2",32,0)
 F  D  Q:PSODONE
"RTN","PSOORNW2",33,0)
 .K PSONEW("DFLG")
"RTN","PSOORNW2",34,0)
 .S PSONEW("FLD")=32 D INS^PSODIR(.PSONEW)
"RTN","PSOORNW2",35,0)
 .I '$G(PSONEW("DFLG")),'$G(PSODELINS) D SINS^PSODIR(.PSONEW)
"RTN","PSOORNW2",36,0)
 .S PSOINSCH=$$INSCHK^PSOHELP3(.PSONEW) K PSODELINS
"RTN","PSOORNW2",37,0)
 .I '$G(PSOINSCH) S PSODONE=1
"RTN","PSOORNW2",38,0)
 Q
"RTN","PSOORNW2",39,0)
 ;
"RTN","PSOORNW2",40,0)
3 S PSONEW("FLD")=3 D PTSTAT^PSODIR1(.PSONEW) ; Get Patient Status
"RTN","PSOORNW2",41,0)
 I +$G(^PS(55,PSODFN,"PS")) S RXPT=+^("PS") I $G(^PS(53,RXPT,0))]"" D  Q
"RTN","PSOORNW2",42,0)
 .S PSONEW("# OF REFILLS")=$S(+$P(OR0,"^",11)>+$P(^PS(53,RXPT,0),"^",4):+$P(^PS(53,RXPT,0),"^",4),1:+$P(OR0,"^",11)),PSOMAX=+$P(^PS(53,RXPT,0),"^",4)
"RTN","PSOORNW2",43,0)
 .S PSOMAX=$S($G(PSOCS):5,1:11),PSOMAX=$S(PSOMAX>+$P(^PS(53,RXPT,0),"^",4):+$P(^PS(53,RXPT,0),"^",4),1:PSOMAX)
"RTN","PSOORNW2",44,0)
 .S PSONEW("# OF REFILLS")=$S(PSONEW("# OF REFILLS")>PSOMAX:PSOMAX,1:PSONEW("# OF REFILLS"))
"RTN","PSOORNW2",45,0)
 I $G(PSOMAX) S PSONEW("# OF REFILLS")=$S(+$P(OR0,"^",11)>PSOMAX:PSOMAX,1:+$P(OR0,"^",11))
"RTN","PSOORNW2",46,0)
 I $G(PSODRUG("DEA"))["A"&($G(PSODRUG("DEA"))'["B")!($G(PSODRUG("DEA"))["F")!($G(PSODRUG("DEA"))[1)!($G(PSODRUG("DEA"))[2) D
"RTN","PSOORNW2",47,0)
 .S PSONEW("# OF REFILLS")=0,VALMSG="No refills allowed on "_$S(PSODRUG("DEA")["A":"this narcotic drug.",1:"this drug.")
"RTN","PSOORNW2",48,0)
 Q
"RTN","PSOORNW2",49,0)
 ;
"RTN","PSOORNW2",50,0)
12 S PSONEW("FLD")=4 D PROV^PSODIR(.PSONEW) ; Get Provider
"RTN","PSOORNW2",51,0)
 Q
"RTN","PSOORNW2",52,0)
 ;
"RTN","PSOORNW2",53,0)
11 S PSONEW("FLD")=5 D CLINIC^PSODIR2(.PSONEW) ; Get Clinic
"RTN","PSOORNW2",54,0)
 Q
"RTN","PSOORNW2",55,0)
 ;
"RTN","PSOORNW2",56,0)
8 S PSONEW("FLD")=7 D QTY^PSODIR1(.PSONEW) ; Get quantity
"RTN","PSOORNW2",57,0)
 Q
"RTN","PSOORNW2",58,0)
 ;
"RTN","PSOORNW2",59,0)
7 I '$G(PSODRUG("IEN")) W $C(7),!!,"No Dispense Drug!",! K DIR,DUOUT,DIRUT,DTOUT D 2^PSOORNW1
"RTN","PSOORNW2",60,0)
 I '$G(PSODRUG("IEN")) W !,$C(7),"No Dispense Drug Selected! A new Orderable Item may need to be selected.",! Q
"RTN","PSOORNW2",61,0)
 S PSONEW("FLD")=8 D DAYS^PSODIR1(.PSONEW) ; Get days supply
"RTN","PSOORNW2",62,0)
 Q:'$G(PSONEW("PATIENT STATUS"))
"RTN","PSOORNW2",63,0)
 K PSDY,PSDY1,PSMAX,PSTMAX S PSDAYS=PSONEW("DAYS SUPPLY"),PSRF=PSONEW("# OF REFILLS"),PTST=$P(^PS(53,PSONEW("PATIENT STATUS"),0),"^"),PTDY=$P(^(0),"^",3),PTRF=$P(^(0),"^",4),PSODEA=PSODRUG("DEA"),CS=0 ;D EDNEW^PSOORNW1
"RTN","PSOORNW2",64,0)
 Q
"RTN","PSOORNW2",65,0)
9 ;
"RTN","PSOORNW2",66,0)
 I '$G(PSONEW("PATIENT STATUS")) W !!,"Rx Patient Status required!",! D 3 I '$G(PSONEW("PATIENT STATUS")) S VALMSG="Rx Patient Status required!",VALMBCK="R" Q
"RTN","PSOORNW2",67,0)
 I +$G(^PS(55,PSODFN,"PS")) S RXPT=+^("PS") I $G(^PS(53,RXPT,0))]"" D  G ASK
"RTN","PSOORNW2",68,0)
 .S PSOMAX=$S($G(CLOZPAT)=2:3,$G(CLOZPAT)=1:1,$G(CLOZPAT)=0:0,1:+$P(^PS(53,RXPT,0),"^",4)) K RXPT
"RTN","PSOORNW2",69,0)
 .S:'$G(PSONEW("# OF REFILLS")) PSONEW("# OF REFILLS")=$S(+$P(OR0,"^",11)>PSOMAX:PSOMAX,1:+$P(OR0,"^",11))
"RTN","PSOORNW2",70,0)
 .S (PSONEW("N# REF"),PSONEW("# OF REFILLS"))=$S(PSONEW("# OF REFILLS")>PSOMAX:PSOMAX,1:PSONEW("# OF REFILLS"))
"RTN","PSOORNW2",71,0)
 .I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A"&($G(PSODRUG("DEA"))'["B")!($G(PSODRUG("DEA"))["F")!($G(PSODRUG("DEA"))[1)!($G(PSODRUG("DEA"))[2) D  Q
"RTN","PSOORNW2",72,0)
 ..S (PSOMAX,PSONEW("N# REF"),PSONEW("# OF REFILLS"))=0,VALMSG="No refills allowed on "_$S(PSODRUG("DEA")["A":"this narcotic drug.",1:"this drug.")
"RTN","PSOORNW2",73,0)
 .I $D(PSODRUG("DEA")) F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S PSOMAX=5
"RTN","PSOORNW2",74,0)
 I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A"&($G(PSODRUG("DEA"))'["B")!($G(PSODRUG("DEA"))["F")!($G(PSODRUG("DEA"))[1)!($G(PSODRUG("DEA"))[2) D  Q
"RTN","PSOORNW2",75,0)
 .S (PSONEW("N# REF"),PSONEW("# OF REFILLS"))=0,VALMSG="No refills allowed on "_$S(PSODRUG("DEA")["A":"this narcotic drug.",1:"this drug.")
"RTN","PSOORNW2",76,0)
 S (PSONEW("N# REF"),PSOMAX,PSONEW("# OF REFILLS"))=+$P(OR0,"^",11)
"RTN","PSOORNW2",77,0)
ASK S PSONEW("FLD")=9 D REFILL^PSODIR1(.PSONEW) ; Get # of refills
"RTN","PSOORNW2",78,0)
 K PSOMAX,PSMAX,PSTMAX S PSDAYS=PSONEW("DAYS SUPPLY"),PSRF=PSONEW("# OF REFILLS"),PTST=$P(^PS(53,PSONEW("PATIENT STATUS"),0),"^"),PTDY=$P(^(0),"^",3),PTRF=$P(^(0),"^",4),PSODEA=$G(PSODRUG("DEA")),CS=0 D EDNEW^PSOORNW1
"RTN","PSOORNW2",79,0)
 Q
"RTN","PSOORNW2",80,0)
 ;
"RTN","PSOORNW2",81,0)
6 Q  K DA S PSONEW("FLD")=10 D SIG^PSODIR1(.PSONEW) ; Get sig
"RTN","PSOORNW2",82,0)
 I $G(PSONEW("SIG"))]"" D EN^PSOSIGNO(ORD,PSONEW("SIG")) S SIG(1)=PSONEW("SIG")
"RTN","PSOORNW2",83,0)
 I $G(PSOSIGFL) D
"RTN","PSOORNW2",84,0)
 .K DIRUT,DUOUT,DTOUT,DIR S DIR(0)="Y",DIR("B")="NO",DIR("A",1)="",DIR("A")="This edit will create a new order.  Do you want to continue" D ^DIR
"RTN","PSOORNW2",85,0)
 .I 'Y!($D(DIRUT)) K DIR,DIRUT,DUOUT,DTOUT,DIC,Y,PSOSIGFL,PSONEW("SIG") S SIGOK=1
"RTN","PSOORNW2",86,0)
 S PSONEW("CLERK CODE")=DUZ K DIR,DIRUT,DUOUT,DTOUT,DIC,Y
"RTN","PSOORNW2",87,0)
 Q
"RTN","PSOORNW2",88,0)
 ;
"RTN","PSOORNW2",89,0)
13 S PSONEW("FLD")=11 D COPIES^PSODIR1(.PSONEW) ; Get # of copies
"RTN","PSOORNW2",90,0)
 Q
"RTN","PSOORNW2",91,0)
 ;
"RTN","PSOORNW2",92,0)
10 S PSONEW("FLD")=12 D MW^PSODIR2(.PSONEW) ; Get Mail/Window Info
"RTN","PSOORNW2",93,0)
 Q
"RTN","PSOORNW2",94,0)
 ;
"RTN","PSOORNW2",95,0)
14 S PSONEW("FLD")=13 D RMK^PSODIR2(.PSONEW) ; Get Remarks
"RTN","PSOORNW2",96,0)
 Q
"RTN","PSOORNW2",97,0)
DREN ;
"RTN","PSOORNW2",98,0)
 N PSDC,PSI S (PSDC,PSI)=0
"RTN","PSOORNW2",99,0)
 F  S PSI=$O(^PSDRUG("ASP",PSODRUG("OI"),PSI)) Q:'PSI  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["O":0,1:1) S PSDC=PSDC+1,PSDC(PSDC)=PSI
"RTN","PSOORNW2",100,0)
 Q:PSDC=0
"RTN","PSOORNW2",101,0)
 I $G(PSDC),PSDC'=1 D  G DRENX
"RTN","PSOORNW2",102,0)
 .I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),2)),"^")=$G(PSODRUG("OI")) Q
"RTN","PSOORNW2",103,0)
 .K PSODRUG("NAME"),PSODRUG("IEN")
"RTN","PSOORNW2",104,0)
 K PSOY S PSI=PSDC(1),PSOY=^PSDRUG(PSI,0)
"RTN","PSOORNW2",105,0)
 I $P($G(^PSDRUG(PSI,"CLOZ1")),"^")="PSOCLO1",'$O(^YSCL(603.01,"C",PSODFN,0)) K PSOY,PSI Q
"RTN","PSOORNW2",106,0)
 S PSODRUG("IEN")=+PSI,PSODRUG("VA CLASS")=$P(PSOY,"^",2),PSODRUG("NAME")=$P(PSOY,"^")
"RTN","PSOORNW2",107,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(PSI,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOORNW2",108,0)
 S PSODRUG("MAXDOSE")=$P(PSOY,"^",4),PSODRUG("DEA")=$P(PSOY,"^",3),PSODRUG("CLN")=$S($D(^PSDRUG(+PSI,"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSOORNW2",109,0)
 S PSODRUG("SIG")=$P(PSOY,"^",5),PSODRUG("NDC")=$$GETNDC^PSSNDCUT(+PSI,$G(PSOSITE)),PSODRUG("STKLVL")=$G(^PSDRUG(+PSI,660.1))
"RTN","PSOORNW2",110,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,+PSI,81)
"RTN","PSOORNW2",111,0)
 G:$G(^PSDRUG(+PSI,660))']"" DRENX
"RTN","PSOORNW2",112,0)
 S PSOX1=$G(^PSDRUG(+PSI,660)),PSODRUG("COST")=$P($G(PSOX1),"^",6),PSODRUG("UNIT")=$P($G(PSOX1),"^",8),PSODRUG("EXPIRATION DATE")=$P($G(PSOX1),"^",9)
"RTN","PSOORNW2",113,0)
DRENX K PSDC,PSI,PSOY,Y,PSOXI,X
"RTN","PSOORNW2",114,0)
 Q
"RTN","PSOORNW2",115,0)
KV K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOORNW2",116,0)
 Q
"RTN","PSORXEDT")
0^12^B49246602^B48455949
"RTN","PSORXEDT",1,0)
PSORXEDT ;BIR/SAB - edit rx routine ;10/21/98
"RTN","PSORXEDT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**21,23,44,71,146,185,148,253,390,372,416,313,427,422**;DEC 1997;Build 132
"RTN","PSORXEDT",3,0)
 ;Ref. ^PS(55 supp. IA 2228
"RTN","PSORXEDT",4,0)
 ;External reference to $$BSA^PSSDSAPI supported by DBIA 5425
"RTN","PSORXEDT",5,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) G EOJ Q
"RTN","PSORXEDT",6,0)
 K PSODRUG,PSOLIST,DIR,DIRUT,DUOUT,X,Y,PSOFROM,^TMP("PSOBEDT",$J),NOPP,CLOZPST,PSOTITRX,PSOMTFLG
"RTN","PSORXEDT",7,0)
 N PSOODOSP
"RTN","PSORXEDT",8,0)
 W !! S DIR(0)="FAO^1:245",DIR("A")="Edit Rx(s) => ",DIR("?",1)="Enter Rx Number or A List of numbers Separated",DIR("?")="by Commas, e.g. 1234A,345,937002Q."
"RTN","PSORXEDT",9,0)
 D ^DIR K DIR G:$D(DIRUT) EOJ
"RTN","PSORXEDT",10,0)
 S END=$L(X,","),BAD=0
"RTN","PSORXEDT",11,0)
 F I=1:1:END S RXM=$P(X,",",I) I +RXM F J=I+1:1:END S DUP=$P(X,",",J) I DUP=RXM S $P(X,",",J)="" W !?5,$C(7),"Duplicate Rx # "_RXM_"  was found in your list, ignoring it!",! S BAD=1
"RTN","PSORXEDT",12,0)
 S PSORLST=$P(X,",") F I=2:1:END S RXM=$P(X,",",I) S:RXM'?1.N.A BAD=1 I RXM?1.N.A S PSORLST=PSORLST_","_RXM
"RTN","PSORXEDT",13,0)
 F I=1:1:$L(PSORLST) S RXM=$P(PSORLST,",",I) I +RXM F J=I+1:1:END S DUP=$P(PSORLST,",",J) I DUP=RXM S $P(PSORLST,",",J)=""
"RTN","PSORXEDT",14,0)
BAD I PSORLST D  I 'Y K Y G PSORXEDT
"RTN","PSORXEDT",15,0)
 .W !?15,"=> "_PSORLST
"RTN","PSORXEDT",16,0)
 .K DIR,DIRUT S DIR(0)="Y",DIR("A")="Is this OKAY ",DIR("B")="Yes"
"RTN","PSORXEDT",17,0)
 .D ^DIR K DIR
"RTN","PSORXEDT",18,0)
 .I 'Y!$D(DIRUT) K X,PSORLST,BAD
"RTN","PSORXEDT",19,0)
 K BAD I 'PSORLST K PSORLST G PSORXEDT
"RTN","PSORXEDT",20,0)
 F I=1:1:$L(PSORLST,",") S RXM=$P(PSORLST,",",I) S GOOD=$D(^PSRX("B",RXM)) D
"RTN","PSORXEDT",21,0)
 .I 'GOOD W !!?5,"Couldn't Find RX # "_RXM H 3 Q
"RTN","PSORXEDT",22,0)
 .S RXN=$O(^PSRX("B",RXM,0)) D  I $P(^PSRX(RXN,"STA"),"^")=13 W !!?5,"Rx # "_RXM_" is marked for Deletion." H 3 Q
"RTN","PSORXEDT",23,0)
 ..I $G(RXN),$P($G(^PS(55,+$P($G(^PSRX(RXN,0)),"^",2),0)),"^",6)'=2 S PSOLOUD=1 D EN^PSOHLUP(+$P($G(^PSRX(RXN,0)),"^",2)) K PSOLOUD
"RTN","PSORXEDT",24,0)
 .D LIST K GOOD
"RTN","PSORXEDT",25,0)
 K GOOD,END
"RTN","PSORXEDT",26,0)
EPH ; - Entry for Epharmacy Rx Edit (PSOREJP1)
"RTN","PSORXEDT",27,0)
 F PSOT1=1:1 Q:'$D(PSOLIST(PSOT1))  F PSOLST2=1:1:$L(PSOLIST(PSOT1),",") S ORN=$P(PSOLIST(PSOT1),",",PSOLST2) D:+ORN PT
"RTN","PSORXEDT",28,0)
 ;
"RTN","PSORXEDT",29,0)
 ; If variable PSOREJCT is set, this means the EPH entry point was called by the EDIT action in the ePharmacy
"RTN","PSORXEDT",30,0)
 ;   Reject Info Screen. The variable will hold the RX IEN. If the Fill Date is the current date or in the
"RTN","PSORXEDT",31,0)
 ;   future (whether it has been edited or not) and the RX is not already suspended, put the Rx on the list
"RTN","PSORXEDT",32,0)
 ;   to get the QUEUE prompt. Since the EDIT action only sends one RX, we can just set the array and not
"RTN","PSORXEDT",33,0)
 ;   worry about appending to an exiting list.
"RTN","PSORXEDT",34,0)
 I $G(PSOREJCT),$$RXFLDT^PSOBPSUT(+PSOREJCT,$P(PSOREJCT,U,2))'<$$DT^XLFDT,$$GET1^DIQ(52,+PSOREJCT_",",100,"I")'=5 S PSORX("PSOL",1)=+PSOREJCT
"RTN","PSORXEDT",35,0)
 ;call to add bingo board data to file 52.11
"RTN","PSORXEDT",36,0)
 K POP,PSOLIST,TM,TM1 G:'$O(PSORX("PSOL",0)) NX
"RTN","PSORXEDT",37,0)
 D:$G(PSORX("PSOL",1))]"" ^PSORXL K PSORX G:$G(NOBG) NX
"RTN","PSORXEDT",38,0)
PRF G:'$P(PSOPAR,"^",8)!($G(NOPP)="H")!($G(NOPP)="S")!('$D(^TMP("PSOBEDT",$J))) BBG
"RTN","PSORXEDT",39,0)
 I $O(^TMP("PSOBEDT",$J,0)),$P(PSOPAR,"^",8) S PSOFROM="NEW",PSOION=ION K RXRS
"RTN","PSORXEDT",40,0)
 G:$D(PSOPROP)&($G(PSOPROP)'=ION) QUP
"RTN","PSORXEDT",41,0)
 I '$D(PSOPROP)!($G(PSOPROP)=ION) D  G:$G(POP)!($E(IOST)["C")!(PSOION=ION) BBG
"RTN","PSORXEDT",42,0)
 .S PSOION=ION W !,"Profiles must be sent to Printer !!",! K IOP,%ZIS,IO("Q"),POP
"RTN","PSORXEDT",43,0)
 .S %ZIS="MNQ",%ZIS("A")="Select Profile Device: " D ^%ZIS K %ZIS("A")
"RTN","PSORXEDT",44,0)
 .Q:$G(POP)!($E(IOST)["C")!(PSOION=ION)  S PSOPROP=ION
"RTN","PSORXEDT",45,0)
QUP S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X,HOLDRPAS=$G(PSOPRPAS),PSOPRPAS=$P(PSOPAR,"^",13)
"RTN","PSORXEDT",46,0)
 F DFN=0:0 S DFN=$O(^TMP("PSOBEDT",$J,DFN)) Q:'DFN  S PPL=^TMP("PSOBEDT",$J,DFN,0) D
"RTN","PSORXEDT",47,0)
 .S ZTRTN="DQ^PSOPRF",ZTIO=PSOPROP,ZTDESC="Outpatient Pharmacy Patient Profiles",ZTDTH=$H
"RTN","PSORXEDT",48,0)
 .F G="PSOPAR","PSODTCUT","PSOPRPAS","DFN","PSOSITE","NEW1","NEW11","PSOBMST","PFIO","PPL" S:$D(@G) ZTSAVE(G)=""
"RTN","PSORXEDT",49,0)
 .D ^%ZTLOAD
"RTN","PSORXEDT",50,0)
 W:$D(ZTSK) !,"PROFILE(S) QUEUED to PRINT",!! K G,ZTSK D ^%ZISC
"RTN","PSORXEDT",51,0)
 S PSOPRPAS=$G(HOLDRPAS) K:PSOPRPAS']"" PSOPRPAS K HOLDRPAS
"RTN","PSORXEDT",52,0)
BBG K DFN F PSODFN=0:0 S PSODFN=$O(^TMP("PSOBEDT",$J,PSODFN)) Q:'PSODFN  I $G(^TMP("PSOBEDT",$J,PSODFN,1)),$D(DISGROUP) S TM=$P($G(^TMP("PSOBB",$J)),"^"),TM1=$P($G(^($J)),"^",2),PPL=^TMP("PSOBEDT",$J,PSODFN,0) D ^PSOBING1
"RTN","PSORXEDT",53,0)
NX ;
"RTN","PSORXEDT",54,0)
 K %X,%Y,ACTREF,ACTREN,D,D0,DAT,DFN,DIC,DIQ,DQ,DRG,END,FDR,PSOBEDT,TM,TM1,PSOT1,PSOLST2,NOBG,BBFLG,BINGCRT,BINGRTE,C,CC,CMOP,COM,CT,D1,DI,DREN,BBRX,PSOFROM,POP,PSORX("QFLG"),IT,PSOERR,PSOBCK,PSOBM,PPL
"RTN","PSORXEDT",55,0)
 K ^TMP("PSOBEDT",$J),^TMP("PSOBB",$J),ZTSK,NOPP,VALMSG,VALMBCK D EOJ
"RTN","PSORXEDT",56,0)
END Q
"RTN","PSORXEDT",57,0)
 ;---------------------------------------------------------
"RTN","PSORXEDT",58,0)
PT ;
"RTN","PSORXEDT",59,0)
 N PSOTXEDT,PSOTPEXT S PSOTXEDT=$P($G(^PSRX(ORN,0)),"^",2) I PSOTXEDT I $D(^PS(52.91,PSOTXEDT,0)) I '$P(^PS(52.91,PSOTXEDT,0),"^",3)!($P(^(0),"^",3)>DT) D PDIR^PSOTPCAN(PSOTXEDT) I $G(PSOTPEXT) K PSOTPEXT,PSOTXEDT D EOJ Q
"RTN","PSORXEDT",60,0)
 K PSOTXEDT,PSOTPEXT
"RTN","PSORXEDT",61,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSORXEDT",62,0)
 S $P(PSOLST(ORN),"^",2)=ORN,(PSOBEDT)=1
"RTN","PSORXEDT",63,0)
 S (DFN,PSODFN)=+$P(^PSRX(ORN,0),"^",2),PSORX("NAME")=$P(^DPT(DFN,0),"^") I PSODFN'=$G(PSOODOSP) K PSORX("DOSING OFF") S PSOODOSP=PSODFN
"RTN","PSORXEDT",64,0)
 D ICN^PSODPT(DFN)
"RTN","PSORXEDT",65,0)
 S RX0=^PSRX(ORN,0),RX2=$G(^(2)),RX3=$G(^(3))
"RTN","PSORXEDT",66,0)
 N PSOCHK S PSOCHK=$$CHK^PSODPT(PSODFN,1,1)  ;*422
"RTN","PSORXEDT",67,0)
 I PSOCHK=-1 D EOJ Q  ;*422
"RTN","PSORXEDT",68,0)
 D:$G(DUZ("AG"))="V" COPAY^PSOPTPST ; Deals with copay
"RTN","PSORXEDT",69,0)
 K ^TMP("PSOHDR",$J),^TMP("PSOPI",$J) D ^VADPT,ADD^VADPT
"RTN","PSORXEDT",70,0)
 S ^TMP("PSOHDR",$J,1,0)=VADM(1),^TMP("PSOHDR",$J,2,0)=$P(VADM(2),"^",2)
"RTN","PSORXEDT",71,0)
 S ^TMP("PSOHDR",$J,3,0)=$P(VADM(3),"^",2)
"RTN","PSORXEDT",72,0)
 S ^TMP("PSOHDR",$J,4,0)=VADM(4),^TMP("PSOHDR",$J,5,0)=$P(VADM(5),"^",2)
"RTN","PSORXEDT",73,0)
 S POERR=1 D RE^PSODEM K POERR,VALMBCK
"RTN","PSORXEDT",74,0)
 S ^TMP("PSOHDR",$J,6,0)=$S($P(WT,"^",8):$P(WT,"^",9)_" ("_$P(WT,"^")_")",1:"_______ (______)")
"RTN","PSORXEDT",75,0)
 S ^TMP("PSOHDR",$J,7,0)=$S($P(HT,"^",8):$P(HT,"^",9)_" ("_$P(HT,"^")_")",1:"_______ (______)") K VM,WT,HT S PSOHD=7
"RTN","PSORXEDT",76,0)
 S ^TMP("PSOHDR",$J,9,0)="",^TMP("PSOHDR",$J,10,0)=""
"RTN","PSORXEDT",77,0)
 S GMRA="0^0^111" D ^GMRADPT S ^TMP("PSOHDR",$J,8,0)=+$G(GMRAL)
"RTN","PSORXEDT",78,0)
 S PSOBSA=$$BSA^PSSDSAPI(DFN),PSOBSA=$P(PSOBSA,"^",3),PSOBSA=$S(PSOBSA'>0:"_______",1:$J(PSOBSA,4,2)) S ^TMP("PSOHDR",$J,12,0)=PSOBSA
"RTN","PSORXEDT",79,0)
 S RSLT=$$CRCL^PSOORUT2(DFN)
"RTN","PSORXEDT",80,0)
 I $P(RSLT,"^",2)["Not Found" S ZDSPL=" CrCL: "_$P(RSLT,"^",2)
"RTN","PSORXEDT",81,0)
 E  S ZDSPL=" CrCL: "_$P($G(RSLT),"^",2)_"(est.) "_"(CREAT:"_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSORXEDT",82,0)
 S ^TMP("PSOHDR",$J,13,0)=ZDSPL
"RTN","PSORXEDT",83,0)
 K PSOBSA,RSLT,ZDSPL
"RTN","PSORXEDT",84,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSORXEDT",85,0)
 S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSORXEDT",86,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^")
"RTN","PSORXEDT",87,0)
 D CLEAR^VALM1
"RTN","PSORXEDT",88,0)
 S STA="ACTIVE^NON-VERIFIED^REFILL^HOLD^NON-VERIFIED^SUSPENDED^^^^^^EXPIRED^DISCONTINUED^^DISCONTINUED^DISCONTINUED^HOLD"
"RTN","PSORXEDT",89,0)
 S $P(PSOLST(ORN),"^",3)=$P(STA,"^",$P(^PSRX(ORN,"STA"),"^")+1),PSLST=ORN,ORD=1
"RTN","PSORXEDT",90,0)
 D ACT^PSOORNE2
"RTN","PSORXEDT",91,0)
EOJ ;
"RTN","PSORXEDT",92,0)
 K INS1,HDR,IK,INDT,LOG,NODE,ORN,P1,PSI,PSL,PSOLION,PSNP,PSOACT,PSOBM,PSOCLC,PSOCNT,PSODD,PSODFN,PSOHD,PSOJ,PSOLST,PSOOI,PSOPF,PSLST
"RTN","PSORXEDT",93,0)
 K PSOIBQS,PSORLST,PSOSD,PSOSIG,PSPRXN,PSORX0,PSORX1,PTST,REFL,RF,RFD,RIFN,RLD,RPH,RTS,RX0,RX1,RX2,RX3,RXM,RXOR,SIG,SIGOK
"RTN","PSORXEDT",94,0)
 D KVA^VADPT K SLPPL,ST,STA,^TMP("PS",$J),PSOQFLG,PSORXED,PSOEDIT,DIR,DIRUT,DUOUT,DTOUT,PSOLOUD,GMRAL,GG,FEV,ACNT
"RTN","PSORXEDT",95,0)
 D FULL^VALM1 K ^TMP("PSOAL",$J),^TMP("PSOAO",$J),^TMP("PSOSF",$J),^TMP("PSOPF",$J),^TMP("PSOPI",$J),^TMP("PSOPO",$J),^TMP("PSOHDR",$J),PAT
"RTN","PSORXEDT",96,0)
 K JJ,K,MM,PSDAYS,PSOAC,PSOAL,PSOCOU,PSOCOUU,PSONEW,PSODRUG,PSONOOR,PSRX0,QTY,REA,RFCNT,RFDT,RXDA,RXFL,RXREF,SUB,X,Z,ZII
"RTN","PSORXEDT",97,0)
 K ACOM,CRIT,DA,DDH,DGI,DGS,PSONEW3,SER,SERS,ZONE,RN,RXN,PSOX,PSOERR,ORD,PSOBCK,PSOBILL,SURX,PSORX("QFLG"),PSORX("FN"),CLOZPAT
"RTN","PSORXEDT",98,0)
 Q
"RTN","PSORXEDT",99,0)
LIST ;
"RTN","PSORXEDT",100,0)
 I $G(^PSRX(RXN,0))']"" W !,$C(7),"Rx data is not on file !",! G LISTX
"RTN","PSORXEDT",101,0)
 I $P(^PSRX(RXN,0),"^",15)=13 S PSVD=1 W !,$C(7),"Rx # "_RXM_" has been deleted."
"RTN","PSORXEDT",102,0)
 S RXN1=RXN,RXM1=RXM D:'$G(PSVD) LST1 W "." S RXN=RXN1,RXM=RXM1 K RXN1,RXM1
"RTN","PSORXEDT",103,0)
 F  S RXN=$O(^PSRX("B",RXM,RXN)) Q:'RXN  D
"RTN","PSORXEDT",104,0)
 .I $G(^PSRX(RXN,0))']"" Q
"RTN","PSORXEDT",105,0)
 .I $P(^PSRX(RXN,0),"^",15)=13 Q
"RTN","PSORXEDT",106,0)
 .D LST1
"RTN","PSORXEDT",107,0)
 K RXN1 G LISTX
"RTN","PSORXEDT",108,0)
 Q
"RTN","PSORXEDT",109,0)
LST1 I $G(PSOLIST(1))']"" S PSOLIST(1)=RXN_"," G LISTX
"RTN","PSORXEDT",110,0)
 F PSOX1=0:0 S PSOX1=$O(PSOLIST(PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSORXEDT",111,0)
 I $L(PSOLIST(PSOX2))+$L(RXN)<220 S:RXN_","'[PSOLIST(PSOX2) PSOLIST(PSOX2)=PSOLIST(PSOX2)_RXN_","
"RTN","PSORXEDT",112,0)
 E  S:RXN_","'[PSOLIST(PSOX2+1) PSOLIST(PSOX2+1)=RXN_","
"RTN","PSORXEDT",113,0)
LISTX K PSOX1,PSOX2,RXN,PSVD
"RTN","PSORXEDT",114,0)
 Q
"RTN","PSORXPR")
0^15^B30390926^B29984044
"RTN","PSORXPR",1,0)
PSORXPR ;BHAM ISC/SAB - view individual prescription ;08/23/96  8:15 am
"RTN","PSORXPR",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**131,156,148,251,422**;DEC 1997;Build 132
"RTN","PSORXPR",3,0)
 ;Reference to ^PS(55 supported by DBIA 2228
"RTN","PSORXPR",4,0)
 ;Reference ^PSDRUG( supported by DBIA 221
"RTN","PSORXPR",5,0)
 ;Reference to ^SC supported by DBIA 10040
"RTN","PSORXPR",6,0)
 ;Reference to ^PSXVIEW supported by DBIA 2204
"RTN","PSORXPR",7,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5424
"RTN","PSORXPR",8,0)
GET S RX0=^PSRX(DA,0),J=DA,$P(RX0,"^",15)=+$G(^("STA")),RX2=$G(^(2)),R3=$G(^(3)),RTN=$G(^("TN")) S (DFN,P0)=+$P(RX0,"^",2) S:$D(^DPT(P0,0)) P0=^(0) S FFX=0
"RTN","PSORXPR",9,0)
 S PSDIV=$S($D(^PS(59,+$P(RX2,"^",9),0)):$P(^(0),"^")_" ("_$P(^(0),"^",6)_")",1:"UNKNOWN"),PSDIV=$E(PSDIV,1,28),PSEXDT=$P(RX2,"^",6),PSEXDT=$S(PSEXDT]"":$E(PSEXDT,4,5)_"/"_$E(PSEXDT,6,7)_"/"_$E(PSEXDT,2,3),1:"UNKNOWN")
"RTN","PSORXPR",10,0)
PR D STAT^PSOFUNC I 'ST0,$D(^PS(52.4,"AREF",DFN,DA)) S ST="UNPRINTED"
"RTN","PSORXPR",11,0)
 ;S:$G(PSLSTVER)&($P($G(^PSRX(+$G(PSONV),"STA")),"^")=4) ST="PENDING DUE TO DRUG INTERACTION"
"RTN","PSORXPR",12,0)
 D PID^VADPT W @IOF,"RX: ",$P(RX0,"^"),?20,"PATIENT: "_$P(P0,"^")_" (",VA("PID")_") "
"RTN","PSORXPR",13,0)
 I $$CHK^PSODPT(DFN,1,1)=-1 S PSORX("DFLG")=1 G Q  ;*422
"RTN","PSORXPR",14,0)
 I $$DS^PSSDSAPI D DRIDOSE^PSOVER1(DA,RX0)
"RTN","PSORXPR",15,0)
 W !,"STATUS: "_ST_"   "_$S($P($G(^PSRX(DA,"IB")),"^")]"":"CO-PAY STATUS",1:"") I ($D(PS)#2),PS="DISCONTINUE",ST["DISCONTINUE" S PS="REINSTATE"
"RTN","PSORXPR",16,0)
 ;W @IOF,!,"RX: ",$P(RX0,"^"),?20,"PATIENT: ",$P(P0,"^")," (",$P(P0,"^",9),") ",!,"STATUS: ",ST_"   "_$S($P($G(^PSRX(DA,"IB")),"^")]"":"CO-PAY STATUS",1:"") I ($D(PS)#2),PS="DISCONTINUE",ST["DISCONTINUE" S PS="REINSTATE"
"RTN","PSORXPR",17,0)
 I $G(PKI1)!($G(PKI)) N PKIT D  W !,PKIT
"RTN","PSORXPR",18,0)
 .I '$D(IORVON) S X="IORVOFF;IORVON" D ENDR^%ZISS S PKIT=IORVON_PKIE_IORVOFF K IORVOFF,IORVON,X Q
"RTN","PSORXPR",19,0)
 .S PKIT=IORVON_PKIE_IORVOFF
"RTN","PSORXPR",20,0)
 S MED=+$P(RX0,"^",6),M1="" S:$D(^PSDRUG(MED,0)) M1=^(0) W !,$S($P(M1,"^",3)["S":"      ITEM: ",1:"      DRUG: "),$S(RTN'="":RTN,1:$P(M1,"^"))_$S('$D(^("I")):"",^("I")']"":"",1:" - (inactivated)")
"RTN","PSORXPR",21,0)
 W !?6," QTY: ",$P(RX0,"^",7),"     ",$S($P(RX0,"^",8)?1N.N:$P(RX0,"^",8),1:"??")," DAY SUPPLY"
"RTN","PSORXPR",22,0)
 K FSIG,BSIG I $P($G(^PSRX(DA,"SIG")),"^",2) D FSIG^PSOUTLA("R",DA,66) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSORXPR",23,0)
 K FSIG,PSREV I '$P($G(^PSRX(DA,"SIG")),"^",2) D EN3^PSOUTLA1(DA,66)
"RTN","PSORXPR",24,0)
 W !?7,"SIG: ",$G(BSIG(1))
"RTN","PSORXPR",25,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?12,$G(BSIG(PSREV))
"RTN","PSORXPR",26,0)
 K BSIG,PSREV
"RTN","PSORXPR",27,0)
 S II=J D LAST^PSORFL W !?4,"LATEST: ",RFLL,?37,"# OF REFILLS: ",$P(RX0,"^",9) S PL=0 D:$O(^PSRX(DA,1,0))  W "  REMAINING: ",$P(RX0,"^",9)-PL K IFN
"RTN","PSORXPR",28,0)
 .S IFN=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  S PL=PL+1
"RTN","PSORXPR",29,0)
DTT S DTT=$P(RX0,"^",13) D DAT W !?4,"ISSUED: ",DAT
"RTN","PSORXPR",30,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+$P(R3,"^",3) D ^DIC
"RTN","PSORXPR",31,0)
 S PHYS=$S(+Y:$P(Y,"^",2),1:"UNKNOWN") W ?41,"PROVIDER: "_PHYS S DTT=$P(RX2,"^")\1
"RTN","PSORXPR",32,0)
 I $P(R3,"^",3),+Y W !?41,"COSIGNER: "_$P(Y,"^",2)
"RTN","PSORXPR",33,0)
 D DAT W !?4,"LOGGED: ",DAT,?43,"CLINIC: ",$S($D(^SC(+$P(RX0,"^",5),0)):$P(^(0),"^"),1:"NOT ON FILE")
"RTN","PSORXPR",34,0)
 W !?3,"EXPIRES: ",PSEXDT,?41,"DIVISION: ",PSDIV,!?7,"CAP: ",$P("NON-^","^",$S($D(^PS(55,DFN,0)):+$P(^(0),"^",2),1:0)),"SAFETY",?42,"ROUTING: " S X=$F("MWI",$P(RX0,"^",11))-1 W:X $P("MAIL^WINDOW^INPATIENT","^",X)
"RTN","PSORXPR",35,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+$P(RX0,"^",16) D ^DIC
"RTN","PSORXPR",36,0)
 W !?2,"ENTRY BY: ",$S(+Y:$P(Y,"^",2),1:$P(RX0,"^",16))
"RTN","PSORXPR",37,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+$P(RX2,"^",10) D ^DIC
"RTN","PSORXPR",38,0)
 W:+Y ?38,"VERIFIED BY: ",$S(+Y:$P(Y,"^",2),1:$P(RX2,"^",10))
"RTN","PSORXPR",39,0)
 G:$D(PSOZVER) REM K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+$P(RX2,"^",3) D ^DIC
"RTN","PSORXPR",40,0)
 W !!,"FILLED: "_RFL,?20,"PHARMACIST: "_$S(+Y:$P(Y,"^",2),1:""),?52,"LOT #: "_$P(RX2,"^",4)
"RTN","PSORXPR",41,0)
 W !," DISPENSED: "_$S($P(RX2,"^",5):$E($P(RX2,"^",5),4,5)_"/"_$E($P(RX2,"^",5),6,7)_"/"_$E($P(RX2,"^",5),2,3),1:"")
"RTN","PSORXPR",42,0)
 W ?$X+10,$S($P(RX2,"^",15):" RETURNED TO STOCK: "_$E($P(RX2,"^",15),4,5)_"/"_$E($P(RX2,"^",15),6,7)_"/"_$E($P(RX2,"^",15),2,3),1:" RELEASED: "_$S($P(RX2,"^",13):$E($P(RX2,"^",13),4,5)_"/"_$E($P(RX2,"^",13),6,7)_"/"_$E($P(RX2,"^",13),2,3),1:""))
"RTN","PSORXPR",43,0)
REM W:$P($G(^PSRX(DA,3)),"^",7)]"" !?3,"REMARKS: ",$P($G(^PSRX(DA,3)),"^",7) W:$P($G(^PSRX(DA,"D")),"^")]"" !,"DELETION COMMENT: "_$P(^("D"),"^")
"RTN","PSORXPR",44,0)
 D:$G(^PSRX(DA,"H"))]""&($G(ST)="HOLD") HLD^PSORXPR1
"RTN","PSORXPR",45,0)
 W ! D:PL RF^PSORXPR1 G Q:$D(DIRUT)  D PAR^PSORXPR1 G Q:$D(DIRUT)
"RTN","PSORXPR",46,0)
ACT I $O(^PSRX(DA,"A",0)) D CON:$Y>20 G Q:$D(DIRUT) D H1 F N=0:0 S N=$O(^PSRX(DA,"A",N)) Q:'N  S P1=^(N,0),DTT=P1\1 D A1 Q:$D(DIRUT)
"RTN","PSORXPR",47,0)
 G Q:$D(DIRUT) I $O(^PSRX(DA,"L",0)) D:$Y>20 CON Q:$D(DIRUT)  D L1 F L1=0:0 S L1=$O(^PSRX(DA,"L",L1)) Q:'L1  S LBL=^PSRX(DA,"L",L1,0),DTT=$P(^(0),"^") D DAT,LG Q:$D(DIRUT)
"RTN","PSORXPR",48,0)
 N X S X="PSXVIEW" X ^%ZOSF("TEST") K X I $T D ^PSXVIEW
"RTN","PSORXPR",49,0)
 G Q
"RTN","PSORXPR",50,0)
LG I $Y>20 D CON Q:$D(DIRUT)  D L1
"RTN","PSORXPR",51,0)
 W !,L1,?3,DAT,?14,$S($P(LBL,"^",2):"REFILL "_$P(^PSRX(DA,"L",L1,0),"^",2),1:"ORIGINAL")
"RTN","PSORXPR",52,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=$P(^PSRX(DA,"L",L1,0),"^",4) D ^DIC
"RTN","PSORXPR",53,0)
 W ?40,$P(Y,"^",2),!,"COMMENTS: "_$P(^PSRX(DA,"L",L1,0),"^",3) K DIC,X,Y
"RTN","PSORXPR",54,0)
 Q
"RTN","PSORXPR",55,0)
A1 D CON:$Y>20 Q:$D(DIRUT)  D H1:FFX,DAT W !,N,?3,DAT,?14
"RTN","PSORXPR",56,0)
 S X=$P(P1,"^",2),X=$F("HUCELPRWSIVDABXGKNM",X)-1
"RTN","PSORXPR",57,0)
 W:X $P("HOLD^UNHOLD^DISCONTINUED ^EDIT^RENEWED^PARTIAL^REINSTATE^REPRINT^SUSPENSE^RETURNED^INTERVENTION^DELETED^DRUG INTERACTION^PROCESSED^X-INTERFACE^PATIENT INST.^PKI/DEA^DISPENSE COMPLETED^ECME^","^",X)
"RTN","PSORXPR",58,0)
 W ?25 S X=+$P(P1,"^",4) W $S(X>0&(X<6):"REFILL "_X,X=6:"PARTIAL",X>6:"REFILL "_(X-1),1:"ORIGINAL")
"RTN","PSORXPR",59,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+$P(P1,"^",3) D ^DIC
"RTN","PSORXPR",60,0)
 W ?40,$S(+Y:$P(Y,"^",2),1:$P(P1,"^",3)) K DIC,X,Y
"RTN","PSORXPR",61,0)
 W:$P(P1,"^",5)]"" !,"COMMENTS: ",$P(P1,"^",5) Q
"RTN","PSORXPR",62,0)
Q K ST0,RFL,RFLL,RFL1,ST,II,J,N,PHYS,L1,DIRUT,PSDIV,PSEXDT,MED,M1,FFX,DTT,DAT,RX0,RX2,R3,RTN,SIG,STA,P1,PL,P0,Z0,Z1,EXDT,IFN,DIR,DUOUT,DTOUT
"RTN","PSORXPR",63,0)
 K LBL,I,RFDATE,%H,%I K:$G(PS)="VIEW" DFN Q
"RTN","PSORXPR",64,0)
H1 I FFX W @IOF
"RTN","PSORXPR",65,0)
 W !!,"ACTIVITY LOG:",!,"#",?3,"DATE",?14,"REASON",?25,"RX REF",?40,"INITIATOR OF ACTIVITY",! F I=1:1:79 W "="
"RTN","PSORXPR",66,0)
 S FFX=0 W ! Q
"RTN","PSORXPR",67,0)
L1 I FFX W @IOF
"RTN","PSORXPR",68,0)
 W !!,"LABEL LOG:",!,"#",?3,"DATE",?14,"RX REF",?40,"PRINTED BY",! F I=1:1:79 W "="
"RTN","PSORXPR",69,0)
 S FFX=0 W ! Q
"RTN","PSORXPR",70,0)
CON Q:$D(PSOAC)  K DTOUT,DIRUT,DUOUT,DIR S DIR(0)="E" D ^DIR S FFX=1 Q
"RTN","PSORXPR",71,0)
 Q
"RTN","PSORXPR",72,0)
DAT S DAT="",DTT=DTT\1 Q:DTT'?7N  S DAT=$E(DTT,4,5)_"/"_$E(DTT,6,7)_"/"_$E(DTT,2,3)
"RTN","PSORXPR",73,0)
 Q
"RTN","PSORXPR",74,0)
EN ; Entry Point for PSORXED
"RTN","PSORXPR",75,0)
 D PSORXPR K PHYS,RFDATE,RFL,RFL1,ST,ST0,RFLL
"RTN","PSORXPR",76,0)
 Q
"RTN","PSOVER1")
0^16^B126916647^B126108249
"RTN","PSOVER1",1,0)
PSOVER1 ;BHAM ISC/SAB - verify one rx ;3/9/05 12:53pm
"RTN","PSOVER1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**32,46,90,131,202,207,148,243,268,281,324,358,251,375,387,379,390,372,416,411,422**;DEC 1997;Build 132
"RTN","PSOVER1",3,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOVER1",4,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOVER1",5,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOVER1",6,0)
 ;External reference to DOSE^PSSORPH is supported by DBIA 3234
"RTN","PSOVER1",7,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSOVER1",8,0)
 ;External reference ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOVER1",9,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSOVER1",10,0)
 ;External reference to $$GETNDC^PSSNDCUT supported by DBIA 4707
"RTN","PSOVER1",11,0)
 ;External reference to ^DPT( supported by DBIA 3097
"RTN","PSOVER1",12,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOVER1",13,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOVER1",14,0)
 ;External reference to ^PS(56 supported by DBIA 2229
"RTN","PSOVER1",15,0)
REDO ;
"RTN","PSOVER1",16,0)
 I '$G(PSOCLK) Q:$G(PSVERFLG)
"RTN","PSOVER1",17,0)
 S (DRG,PSODRUG("NAME"))=$P(^PSDRUG(+$P(^PSRX(PSONV,0),"^",6),0),"^"),PSODRUG("VA CLASS")=$P(^(0),"^",2)
"RTN","PSOVER1",18,0)
 S PSOVQUIT=0,PSODRUG("IEN")=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",19,0)
 S PSOY(0)=^PSDRUG(PSODRUG("IEN"),0),PSOY=PSODRUG("IEN")_"^"_$P(PSOY(0),"^")
"RTN","PSOVER1",20,0)
 D SET^PSODRG
"RTN","PSOVER1",21,0)
 I '$D(PSODFN) S PSODFN=$P(^PSRX(PSONV,0),"^",2)
"RTN","PSOVER1",22,0)
 ;
"RTN","PSOVER1",23,0)
EDIT ;
"RTN","PSOVER1",24,0)
 N PSDNEW,PSDOLD
"RTN","PSOVER1",25,0)
 S (PSDNEW,PSDOLD)="",PSDOLD=$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^")_"^"_PSONV
"RTN","PSOVER1",26,0)
 S DA=PSONV D ^PSORXPR
"RTN","PSOVER1",27,0)
 I $G(PSORX("DFLG")) G OUT  ;*422
"RTN","PSOVER1",28,0)
 I $G(PKI1)=2 D DCV1^PSOPKIV1 G OUT
"RTN","PSOVER1",29,0)
 K PSDTSTOP S DIR("A")="EDIT",DIR("B")="N",DIR(0)="SB^Y:YES;N:NO;P:PROFILE",DIR("?")="Enter Y to change this RX, P to see a profile, or N to proceed with verification and order checks."
"RTN","PSOVER1",30,0)
 D ^DIR K DIR W ! I $G(DIRUT)!($G(DTOUT)) S PSOVBCK=1 G OUT
"RTN","PSOVER1",31,0)
 ;PSOPOCK=1 called from Process Order Check option; PSOCLK=1 means initiated from Rx verify by clerk.
"RTN","PSOVER1",32,0)
 I Y="Y",($G(PSOCLK)!($G(PSOPOCK))) D FULLEDT S VALMBCK="R" G KILL:$$CHECK(PSONV) G EDIT
"RTN","PSOVER1",33,0)
 I Y="Y",$G(PSOACT)]"" S VALMBCK="R",PSVERFLG=1 G OUT  ;this pops the user back to the med profile screen when verify is called from Patient Prescription Processing
"RTN","PSOVER1",34,0)
 I $D(DIRUT),$G(PSOCLK) S PSOCQ=1 G OUT
"RTN","PSOVER1",35,0)
 I $D(DIRUT),$G(PSOACT)]"" S VALMBCK="R" G OUT
"RTN","PSOVER1",36,0)
 G ORDCHK:Y="N",PROF:Y="P",OUT:"YNP"'[$E(Y)
"RTN","PSOVER1",37,0)
 ;
"RTN","PSOVER1",38,0)
 D EXPIRE K DIE,DR,DEA1,DEA2,P(5),PSRX1,PSRX2
"RTN","PSOVER1",39,0)
 K PSD(PSDOLD) S PSDNEW="",PSDNEW=$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^")_"^"_PSONV,PSD(PSDNEW)=PSONV_"^*^1^"_$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^",2)
"RTN","PSOVER1",40,0)
 ;
"RTN","PSOVER1",41,0)
 S DA=$S($D(PSORXED("IRXN")):PSORXED("IRXN"),1:PSONV) D ^PSORXPR G OUT:$G(DIRUT)
"RTN","PSOVER1",42,0)
 G OUT:$D(DIRUT)!($D(DTOUT))
"RTN","PSOVER1",43,0)
 I '$G(PSOCLK) S DA=$S($D(PSORXED("IRXN")):PSORXED("IRXN"),1:PSONV) W !,"CHANGE",! D ^PSORXPR G OUT:$D(DIRUT)!($D(DTOUT)) G EDIT
"RTN","PSOVER1",44,0)
 G EDIT:PSDNEW=PSDOLD,REDO
"RTN","PSOVER1",45,0)
PROF I '$D(PSOSD) W !,$C(7),"This patient has no other prescriptions on file",!! G EDIT Q
"RTN","PSOVER1",46,0)
 W !!,$P(^DPT(DFN,0),"^"),?40,"ID#:"_VA("PID") W:$D(INT)!$D(PSONV) "  RX#: "_$S($D(INT):$P(INT,"^"),$D(^PSRX(PSONV)):$P(^PSRX(PSONV,0),"^"),1:"")
"RTN","PSOVER1",47,0)
 D HD^PSODDPR2() D ^PSODSPL D SHOW2^PSOVER G EDIT Q
"RTN","PSOVER1",48,0)
 ;
"RTN","PSOVER1",49,0)
EXPIRE S RX0=^PSRX(DA,0),X1=$P($P(RX0,"^",13),"."),X2=$P(RX0,"^",9)+1*$P(RX0,"^",8),X2=$S($P(RX0,"^",8)=X2:X2,X2<181:184,X2=360:366,1:X2),X=X1 D:X1&X2 C^%DTC
"RTN","PSOVER1",50,0)
 K ^PS(55,PSDFN,"P","A",+$P(^PSRX(DA,2),"^",6),DA) S ^PS(55,PSDFN,"P","A",X,DA)="",$P(^PSRX(DA,2),"^",6)=X,$P(^PS(52.4,DA,0),"^",7)=X K X1,X2 Q
"RTN","PSOVER1",51,0)
 ;
"RTN","PSOVER1",52,0)
ORDCHK ;
"RTN","PSOVER1",53,0)
 S PSOVER1=1
"RTN","PSOVER1",54,0)
 S RX0=^PSRX(PSONV,0)
"RTN","PSOVER1",55,0)
 D ORDCK
"RTN","PSOVER1",56,0)
 I $G(PSOQUIT) S:$G(PSOCLK) PSOQUIT=0 S:'$G(PSOCLK) PSORX("DFLG")=1  ;if verify by clerk continue on with the next Rx; if not exit
"RTN","PSOVER1",57,0)
 I $G(PSOVQUIT)!$G(PSORX("DFLG")) G OUT
"RTN","PSOVER1",58,0)
 ;------
"RTN","PSOVER1",59,0)
VERIFY ;
"RTN","PSOVER1",60,0)
 D FULL^VALM1 G:'$P(PSOPAR,"^",2) VERY
"RTN","PSOVER1",61,0)
 W !,$P(^DPT(DFN,0),"^"),?40,"ID#:"_VA("PID") W:$D(INT)!$D(PSONV) "  RX#: "_$S($D(INT):$P(INT,"^"),$D(^PSRX(PSONV)):$P(^PSRX(PSONV,0),"^"),1:"") W:$D(PSODRUG("NAME")) !,PSODRUG("NAME"),!
"RTN","PSOVER1",62,0)
 I $G(PSONAM)="" S PSONAM=$P(^DPT(PSDFN,0),"^")
"RTN","PSOVER1",63,0)
 S DIR("A")="VERIFY FOR "_PSONAM_"? (Y/N/Delete/Quit): ",DIR("B")="Y",DIR(0)="SA^Y:YES;N:NO;D:DELETE;Q:QUIT"
"RTN","PSOVER1",64,0)
 S DIR("?",1)="Enter Y (or return) to verify this prescription",DIR("?",2)="N to leave this prescription non-verified and to end this session of verification",DIR("?")="D to delete this prescription"
"RTN","PSOVER1",65,0)
 D ^DIR K DIR
"RTN","PSOVER1",66,0)
 I Y="N"!("Q^"[$E(Y)) D  G OUT
"RTN","PSOVER1",67,0)
 .S (PSVERFLG,PSOVBCK)=1,PSORX("DFLG")=1
"RTN","PSOVER1",68,0)
 .S:$D(PSOOVNOD) ^PS(52.4,PSONV,0)=PSOOVNOD S:$G(PSOOVSTA) $P(^PSRX(PSONV,"STA"),"^")=PSOOVSTA
"RTN","PSOVER1",69,0)
 .S:PSOOVSTA=4 ^PS(52.4,"ADI",PSONV,1)=""
"RTN","PSOVER1",70,0)
 G DELETE:Y="D"
"RTN","PSOVER1",71,0)
VERY I $G(PKI1)=1 D REA^PSOPKIV1 G:'$D(PKIR) VERIFY
"RTN","PSOVER1",72,0)
 K ^PSRX(PSONV,"DAI") S $P(^PSRX(PSONV,3),"^",6)=""
"RTN","PSOVER1",73,0)
 K ^PSRX(PSONV,"DRI"),SPFL1
"RTN","PSOVER1",74,0)
 I '$O(^PSRX(PSONV,6,0)) D  I $D(DUOUT)!($D(DTOUT)) W !!,"Rx: "_$P(^PSRX(DA,0),"^")_" not Verified!!",! H 2 G OUT
"RTN","PSOVER1",75,0)
 .W !!,"Dosing Instructions Missing. Please add!",!
"RTN","PSOVER1",76,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^")]"",'$P($G(^("SIG")),"^",2) W "SIG: "_$P(^PSRX(PSONV,"SIG"),"^"),!
"RTN","PSOVER1",77,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^",2),$O(^PSRX(PSONV,"SIG1",0)) D  K I
"RTN","PSOVER1",78,0)
 ..W "SIG: " F I=0:0 S I=$O(^PSRX(PSONV,"SIG1",I)) Q:'I  W ^PSRX(PSONV,"SIG1",I,0),!
"RTN","PSOVER1",79,0)
 .S DA=PSONV,PSOVER=1 K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOVER1",80,0)
 .S PSODRUG("IEN")=$P(^PSRX(DA,0),"^",6),PSODFN=$P(^(0),"^",2),PSORXED("IRXN")=DA,PSODRUG("OI")=$P(^PSRX(DA,"OR1"),"^")
"RTN","PSOVER1",81,0)
 .D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN),^PSOORED3
"RTN","PSOVER1",82,0)
 .K PSODFN,PSODRUG("IEN"),DOSE,PSOVER
"RTN","PSOVER1",83,0)
 .I '$G(ENT) S DUOUT=1
"RTN","PSOVER1",84,0)
 .Q:$D(DUOUT)!($D(DTOUT))
"RTN","PSOVER1",85,0)
 .K DIR,DIRUT,DUOUT,DTOUT S DIE=52,DR=114 D ^DIE K DIE,DR,DTOUT
"RTN","PSOVER1",86,0)
 .I X'="" D SIG^PSOHELP D:$G(INS1)]"" EN^DDIOL($E(INS1,2,9999999)) S PSORXED("SIG",1)=$E(INS1,2,9999999)
"RTN","PSOVER1",87,0)
 .D EN^PSOFSIG(.PSORXED,1),UDSIG^PSOORED3 H 2
"RTN","PSOVER1",88,0)
 S DA=PSONV,$P(^PSRX(DA,2),"^",10)=DUZ,DRG=$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^")
"RTN","PSOVER1",89,0)
 I $P(^PSRX(DA,2),"^",2)>DT,$P(PSOPAR,"^",6) D  G KILL
"RTN","PSOVER1",90,0)
 .S (SPFL1,PSOVER)="",PSORX("FILL DATE")=$P(^PSRX(DA,2),"^",2),RXF=0
"RTN","PSOVER1",91,0)
 .D UPSUS S PSTRIVER=1 D SUS^PSORXL
"RTN","PSOVER1",92,0)
 .K PSORX("FILL DATE"),PSTRIVER
"RTN","PSOVER1",93,0)
 .I $D(^TMP("PSODAOC",$J)) D ^PSONEWOC K ^TMP("PSODAOC",$J)
"RTN","PSOVER1",94,0)
 S PSOVER(PSONV)="" S $P(^PSRX(PSONV,"STA"),"^")=0,DRG=$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^")
"RTN","PSOVER1",95,0)
 S $P(PSOSD("NON-VERIFIED",DRG),"^",2)=0,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG)
"RTN","PSOVER1",96,0)
 I $D(^TMP("PSODAOC",$J)) D ^PSONEWOC K ^TMP("PSODAOC",$J)
"RTN","PSOVER1",97,0)
 I $G(PKI1)=1,$G(PKIR)]"" D ACT^PSOPKIV1(DA)
"RTN","PSOVER1",98,0)
 K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","") ;S VALMBCK=""
"RTN","PSOVER1",99,0)
 ;
"RTN","PSOVER1",100,0)
 ; - Calling ECME for claims generation and transmission / REJECT handling
"RTN","PSOVER1",101,0)
 N ACTION
"RTN","PSOVER1",102,0)
 I $$SUBMIT^PSOBPSUT(PSONV) D  I ACTION="Q"!(ACTION="^") Q
"RTN","PSOVER1",103,0)
 . S ACTION="" D ECMESND^PSOBPSU1(PSONV,,,$S($O(^PSRX(PSONV,1,0)):"RF",1:"OF"))
"RTN","PSOVER1",104,0)
 . ; Quit if there is an unresolved Tricare non-billable reject code, PSO*7*358
"RTN","PSOVER1",105,0)
 . I $$PSOET^PSOREJP3(PSONV) S ACTION="Q" Q
"RTN","PSOVER1",106,0)
 . I $$FIND^PSOREJUT(PSONV) D
"RTN","PSOVER1",107,0)
 . . S ACTION=$$HDLG^PSOREJU1(PSONV,0,"79,88","OF","IOQ","Q")
"RTN","PSOVER1",108,0)
 ;
"RTN","PSOVER1",109,0)
KILL S DA=PSONV,DIK="^PS(52.4," D ^DIK K DA,DIK D DCORD^PSONEW2
"RTN","PSOVER1",110,0)
OUT ;
"RTN","PSOVER1",111,0)
 K PSOVER1
"RTN","PSOVER1",112,0)
 I '$G(PSOCLK) S:$G(DIRUT)!($G(DTOUT)) PSORX("DFLG")=1 K DIRUT,DTOUT,DUOUT,UPFLAGX D CLEAN S VALMBCK="Q" Q
"RTN","PSOVER1",113,0)
 I $G(PSOCLK) S PSORX("DFLG")=0 K UPFLAGX D CLEAN Q
"RTN","PSOVER1",114,0)
DELETE K UPFLAGX,PSOVER1 D DELETE^PSOVER2 G:$G(UPFLAGX) OUT K PSOSD("NON-VERIFIED",$G(DRG)) Q
"RTN","PSOVER1",115,0)
QUIT S PSOQUIT="" D CLEAN K PSOVER1 Q
"RTN","PSOVER1",116,0)
UPSUS S $P(PSOSD("NON-VERIFIED",DRG),"^",2)=5,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG) K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","")
"RTN","PSOVER1",117,0)
 Q
"RTN","PSOVER1",118,0)
CLEAN ;cleans up tmp("psorxdc") global
"RTN","PSOVER1",119,0)
 I $G(PSODOSEX) K PSODOSEX Q
"RTN","PSOVER1",120,0)
 N PSOWRITE
"RTN","PSOVER1",121,0)
 I $O(^TMP("PSORXDC",$J,0)) F RORD=0:0 S RORD=$O(^TMP("PSORXDC",$J,RORD)) Q:'RORD  D
"RTN","PSOVER1",122,0)
 .D PSOUL^PSSLOCK(RORD_$S($P(^TMP("PSORXDC",$J,RORD,0),"^")="P":"S",1:""))
"RTN","PSOVER1",123,0)
 .I $P(^TMP("PSORXDC",$J,RORD,0),"^")="P" D  Q
"RTN","PSOVER1",124,0)
 ..S PSOR=^PS(52.41,RORD,0)
"RTN","PSOVER1",125,0)
 ..S DNM=$S($P(PSOR,"^",9):$P($G(^PSDRUG($P(PSOR,"^",9),0)),"^"),1:$P(^PS(50.7,$P(PSOR,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(PSOR,"^",8),0),"^",2),0),"^"))
"RTN","PSOVER1",126,0)
 ..W $C(7),!," Duplicate "_$S($P(^TMP("PSORXDC",$J,RORD,0),"^",10):"Therapy",1:"Drug")_" Pending Order "_DNM_" NOT Discontinued." S PSOWRITE=1
"RTN","PSOVER1",127,0)
 .W !," Duplicate "_$S($P(^TMP("PSORXDC",$J,RORD,0),"^",10):"Therapy",1:"Drug")_" Rx #"_$P(^PSRX(RORD,0),"^")_" "_$P(^TMP("PSORXDC",$J,RORD,0),"^",7)_" NOT Discontinued." S PSOWRITE=1
"RTN","PSOVER1",128,0)
 I $G(PSOWRITE)&('$G(PSOWRIT)) W ! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR S:($D(DTOUT))!($D(DUOUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,X,Y I ($Y+5)>IOSL W @IOF
"RTN","PSOVER1",129,0)
 K ^TMP("PSORXDC",$J),RORD,PRNXZ,ORNZZ,PSOR
"RTN","PSOVER1",130,0)
 Q
"RTN","PSOVER1",131,0)
KV1 ;
"RTN","PSOVER1",132,0)
 K PSOANSQD,DRET,LST,PSOQUIT,PSODRUG,PSONEW,SIG,PSODIR,PHI,PRC,ORCHK,ORDRG,PSOSIGFL,PSORX("ISSUE DATE"),PSORX("FILL DATE"),CLOZPAT
"RTN","PSOVER1",133,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOVER1",134,0)
 Q
"RTN","PSOVER1",135,0)
NVA ;
"RTN","PSOVER1",136,0)
 I $P(PSOSD(STA,DNM),"^",11) D NVA^PSODRDU1 Q
"RTN","PSOVER1",137,0)
 N PSOOI,CLASS,FLG,X,Y,RXREC,IFN
"RTN","PSOVER1",138,0)
 S (Y,FLG)=""
"RTN","PSOVER1",139,0)
 S RXREC=$P(PSOSD(STA,DNM),"^",10),PSOOI=+$G(^PS(55,DFN,"NVA",RXREC,0)),IFN=RXREC N DNM
"RTN","PSOVER1",140,0)
 F  S Y=$O(^PSDRUG("ASP",PSOOI,Y)) Q:Y=""!(FLG)  S DNM=$P(^PSDRUG(Y,0),"^"),CLASS=$P(^PSDRUG(Y,0),"^",2) I PSODRUG("NAME")=DNM!(CLASS=PSODRUG("VA CLASS")) D DSP^PSODRDU1 S FLG=1 Q
"RTN","PSOVER1",141,0)
 Q
"RTN","PSOVER1",142,0)
REMOTE ; 
"RTN","PSOVER1",143,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN) D
"RTN","PSOVER1",144,0)
 .I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOVER1",145,0)
 .I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOVER1",146,0)
 .D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSOVER1",147,0)
 .I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) D  Q
"RTN","PSOVER1",148,0)
 ..I $T(REMOTE^PSORX1)]"" Q
"RTN","PSOVER1",149,0)
 ..W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)>IOSL)
"RTN","PSOVER1",150,0)
 .W !!,"Now doing remote order checks. Please wait..."
"RTN","PSOVER1",151,0)
 .D REMOTE^PSOORRDI(PSODFN,+$P($G(^PSRX(PSONV,0)),"^",6))
"RTN","PSOVER1",152,0)
 .I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)>IOSL) ;D PAUSE^PSOORRD2 Q
"RTN","PSOVER1",153,0)
 .I $D(^TMP($J,"DD")) D DUP^PSOORRD2
"RTN","PSOVER1",154,0)
 .I $D(^TMP($J,"DC")) D CLS^PSOORRD2
"RTN","PSOVER1",155,0)
 .I $D(^TMP($J,"DI"_PSODFN)) K ^TMP($J,"DI") M ^TMP($J,"DI")=^TMP($J,"DI"_PSODFN) D DRGINT^PSOORRD2
"RTN","PSOVER1",156,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN)
"RTN","PSOVER1",157,0)
 Q
"RTN","PSOVER1",158,0)
NOALRGY ;
"RTN","PSOVER1",159,0)
 N PSODFN,PSODRUG
"RTN","PSOVER1",160,0)
 S PSODFN=$P(^PSRX(PSONV,0),"^",2),PSODRUG("IEN")=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",161,0)
 D NOALRGY^PSODRG
"RTN","PSOVER1",162,0)
 Q
"RTN","PSOVER1",163,0)
 ;
"RTN","PSOVER1",164,0)
ORDCK ;
"RTN","PSOVER1",165,0)
 N ORN,ORNZZ,PSOLST,Y,PSOODFN S ORN=PSONV,PSOLST(PSONV)=PSONV_"^"_PSONV,PSOVORD=1
"RTN","PSOVER1",166,0)
 N DRG,ON,CT,DRGI,PDRG,SEV,STX,INT,CLI,PSONULN,PSONULN1,LST,LSI,DGI,SER,SERS,DUPT,SV
"RTN","PSOVER1",167,0)
 S ORNZZ=ORN,PRNXZ(ORN)=PSOLST(ORN),PSORENW("OIRXN")=PSONV,PSOODFN=DFN
"RTN","PSOVER1",168,0)
 I '$D(PSODFN) S PSODFN=$P(^PSRX(PSONV,0),"^",2)
"RTN","PSOVER1",169,0)
 D SHOW^PSOVER D HD^PSODDPR2():(($Y+5)>IOSL)
"RTN","PSOVER1",170,0)
 S (PSODRUG("IEN"),PSDRUG("IEN"))=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",171,0)
 N PSOVINF S PSOVINF=^PSDRUG(PSDRUG("IEN"),0),PSODRUG("VA CLASS")=$P(^(0),"^",2)
"RTN","PSOVER1",172,0)
 S PSODRUG("VA CLASS")=$P(PSOVINF,"^",2),(DRG,PSODRUG("NAME"))=$P(^PSDRUG(PSDRUG("IEN"),0),"^")
"RTN","PSOVER1",173,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(PSDRUG("IEN"),"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOVER1",174,0)
 S PSODRUG("MAXDOSE")=$P(PSOVINF,"^",4),PSODRUG("DEA")=$P(PSOVINF,"^",3),PSODRUG("CLN")=$S($D(^PSDRUG(PSDRUG("IEN"),"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSOVER1",175,0)
 S PSODRUG("SIG")=$P(PSOVINF,"^",5),PSODRUG("NDC")=$$GETNDC^PSSNDCUT(PSDRUG("IEN"),$G(PSOSITE)),PSODRUG("STKLVL")=$G(^PSDRUG(PSDRUG("IEN"),660.1))
"RTN","PSOVER1",176,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,PSONV,81)
"RTN","PSOVER1",177,0)
 K PSOVINF
"RTN","PSOVER1",178,0)
 D POST^PSODRG S DFN=PSOODFN
"RTN","PSOVER1",179,0)
 I $$GET1^DIQ(52,PSONV,100,"I")=13 S PSORX("DFLG")=1 Q
"RTN","PSOVER1",180,0)
 I $G(PSVERFLG),$G(PSOCLK) S PSVERFLG=0
"RTN","PSOVER1",181,0)
 I $G(PSOCLK),$G(PSORX("DFLG")) S PSOVQUIT=1 K PSORX("DFLG"),DIRUT,DTOUT Q
"RTN","PSOVER1",182,0)
 Q:PSORX("DFLG")!($G(PSOQUIT))
"RTN","PSOVER1",183,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("V")
"RTN","PSOVER1",184,0)
 I $$GET1^DIQ(52,PSONV,100,"I")=13 S PSORX("DFLG")=1 Q
"RTN","PSOVER1",185,0)
 I $G(PSOCLK),$G(PSORX("DFLG")) S PSOVQUIT=1 K PSORX("DFLG"),DIRUT,DTOUT Q
"RTN","PSOVER1",186,0)
 Q:PSORX("DFLG")
"RTN","PSOVER1",187,0)
 S PSOLST(ORNZZ)=PRNXZ(ORNZZ),ORN=ORNZZ K PSORENW("OIRXN")
"RTN","PSOVER1",188,0)
 Q
"RTN","PSOVER1",189,0)
 ;
"RTN","PSOVER1",190,0)
FULLEDT  ;
"RTN","PSOVER1",191,0)
 D FULL^VALM1
"RTN","PSOVER1",192,0)
 N RX,FILL,OPSOLST,OPSLST,OLDDA,PSODRUG,REJ
"RTN","PSOVER1",193,0)
 S (RX,PSORXED("IRXN"))=PSONV
"RTN","PSOVER1",194,0)
 M OPSOLST=PSOLST,OPSLST=PSLST,ODA=DA
"RTN","PSOVER1",195,0)
 N PSOSITE,ORN,PSOPAR,PSOLIST,PSOSD
"RTN","PSOVER1",196,0)
 S PSOSITE=$$RXSITE^PSOBPSUT(RX,""),ORN=RX
"RTN","PSOVER1",197,0)
 S PSOPAR=$G(^PS(59,PSOSITE,1)),PSOLIST(1)=ORN_","
"RTN","PSOVER1",198,0)
 D EPH^PSORXEDT
"RTN","PSOVER1",199,0)
 M PSOLST=OPSOLST,PSLST=OPSLST S VALMBCK="R" S:$D(OLDDA) DA=OLDDA
"RTN","PSOVER1",200,0)
 Q
"RTN","PSOVER1",201,0)
 ;
"RTN","PSOVER1",202,0)
DRIDOSE(DA,RX0) ;where DA is RXIEN and RX0 is zero node of file 52 for the RXIEN
"RTN","PSOVER1",203,0)
 N T,RXN,RXX,SCRIPT,SEV,X,SER,PSOSERV,PSOSCPT,PSODOSF,RX
"RTN","PSOVER1",204,0)
 S RX=RX0
"RTN","PSOVER1",205,0)
 S RXN=$P(RX0,"^")
"RTN","PSOVER1",206,0)
 I $D(^PS(52.4,RX,0))!($D(^PSRX(RX,"DRI"))) D
"RTN","PSOVER1",207,0)
 . Q:'$P($G(^PS(52.4,RX,0)),"^",8)&('$D(^PSRX(RX,"DRI")))
"RTN","PSOVER1",208,0)
 .W !!,"*** During order, there were DRUG-DRUG INTERACTION for the following RX(s):"
"RTN","PSOVER1",209,0)
 I $P($G(^PS(52.4,RX,0)),"^",8) S SCRIPT=$P(^PS(52.4,RX,0),"^",10),SEV=$P(^PS(52.4,RX,0),"^",9) F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOVER1",210,0)
 . S SER=$P(^PS(56,SEV(X),0),"^",4) S:$G(SER)=1 PSOSERV=1
"RTN","PSOVER1",211,0)
 . S PSOSCPT(RXX(X))="     "_$S(SER=1:"CRITICAL",SER=2:"SIGNIFICANT",1:"UNKNOWN")_" INTERACTION    "_$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^")
"RTN","PSOVER1",212,0)
 I $D(^PSRX(RX,"DRI")) S SCRIPT=$P(^PSRX(RX,"DRI"),"^",2),SEV=$P(^PSRX(RX,"DRI"),"^") F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOVER1",213,0)
 .S SER=$P(^PS(56,SEV(X),0),"^",4)
"RTN","PSOVER1",214,0)
 .S PSOSCPT(RXX(X))="     "_$P($G(^PSRX(RXX(X),0)),"^")_"  "_$S(SER=1:"CRITICAL",SER=2:"SIGNIFICANT",1:"UNKNOWN")_" INTERACTION  "_$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^")
"RTN","PSOVER1",215,0)
 S SCRIPT="" F  S SCRIPT=$O(PSOSCPT(SCRIPT)) Q:SCRIPT=""  W !,PSOSCPT(SCRIPT)
"RTN","PSOVER1",216,0)
 I $$DS^PSSDSAPI,$D(^PS(52.4,RX,1)) S T=$P(^PS(52.4,RX,1),"^") D  W:PSODOSF'="" !,"*** Dose Warning: ",PSODOSF
"RTN","PSOVER1",217,0)
 . S PSODOSF="",PSODOSF=$S(T=4:"DOSAGE EXCEEDS MAX SINGLE DOSE",T=3:"MAX SINGLE DOSE & DAILY DOSE RANGE",T=2:"MAX SINGLE DOSE",T=1:"DAILY DOSE RANGE",1:"")
"RTN","PSOVER1",218,0)
 W !
"RTN","PSOVER1",219,0)
 Q
"RTN","PSOVER1",220,0)
CHECK(PSONV) ;
"RTN","PSOVER1",221,0)
 N PSOSTAT S PSOSTAT=$$GET1^DIQ(52,PSONV,100,"I")
"RTN","PSOVER1",222,0)
 I ",11,12,13,14,15,"[(","_PSOSTAT_",") Q 1
"RTN","PSOVER1",223,0)
 Q 0
"VER")
8.0^22.0
"BLD",9240,6)
^407
**END**
**END**

