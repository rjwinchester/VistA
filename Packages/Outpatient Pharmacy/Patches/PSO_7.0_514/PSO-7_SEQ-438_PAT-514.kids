Released PSO*7*514 SEQ #438
Extracted from mail message
**KIDS**:PSO*7.0*514^

**INSTALL NAME**
PSO*7.0*514
"BLD",10789,0)
PSO*7.0*514^OUTPATIENT PHARMACY^0^3180801^y
"BLD",10789,1,0)
^^5^5^3180228^^^
"BLD",10789,1,1,0)
This patch will resolve the following issues.
"BLD",10789,1,2,0)
 
"BLD",10789,1,3,0)
1. I9914421FY16 - all prescription information is not displayed on the
"BLD",10789,1,4,0)
                  Pharmacy verification screen
"BLD",10789,1,5,0)
2. R18151128FY18 - QTY Recalculation when Drug Changed
"BLD",10789,4,0)
^9.64PA^^
"BLD",10789,6)
2^
"BLD",10789,6.3)
32
"BLD",10789,"KRN",0)
^9.67PA^779.2^20
"BLD",10789,"KRN",.4,0)
.4
"BLD",10789,"KRN",.401,0)
.401
"BLD",10789,"KRN",.402,0)
.402
"BLD",10789,"KRN",.403,0)
.403
"BLD",10789,"KRN",.5,0)
.5
"BLD",10789,"KRN",.84,0)
.84
"BLD",10789,"KRN",3.6,0)
3.6
"BLD",10789,"KRN",3.8,0)
3.8
"BLD",10789,"KRN",9.2,0)
9.2
"BLD",10789,"KRN",9.8,0)
9.8
"BLD",10789,"KRN",9.8,"NM",0)
^9.68A^6^5
"BLD",10789,"KRN",9.8,"NM",1,0)
PSOMLLD2^^0^B38199463
"BLD",10789,"KRN",9.8,"NM",3,0)
PSORN52^^0^B45172995
"BLD",10789,"KRN",9.8,"NM",4,0)
PSOSIG^^0^B103751531
"BLD",10789,"KRN",9.8,"NM",5,0)
PSORENW3^^0^B41588780
"BLD",10789,"KRN",9.8,"NM",6,0)
PSOCPB^^0^B93317750
"BLD",10789,"KRN",9.8,"NM","B","PSOCPB",6)

"BLD",10789,"KRN",9.8,"NM","B","PSOMLLD2",1)

"BLD",10789,"KRN",9.8,"NM","B","PSORENW3",5)

"BLD",10789,"KRN",9.8,"NM","B","PSORN52",3)

"BLD",10789,"KRN",9.8,"NM","B","PSOSIG",4)

"BLD",10789,"KRN",19,0)
19
"BLD",10789,"KRN",19.1,0)
19.1
"BLD",10789,"KRN",101,0)
101
"BLD",10789,"KRN",409.61,0)
409.61
"BLD",10789,"KRN",771,0)
771
"BLD",10789,"KRN",779.2,0)
779.2
"BLD",10789,"KRN",870,0)
870
"BLD",10789,"KRN",8989.51,0)
8989.51
"BLD",10789,"KRN",8989.52,0)
8989.52
"BLD",10789,"KRN",8994,0)
8994
"BLD",10789,"KRN","B",.4,.4)

"BLD",10789,"KRN","B",.401,.401)

"BLD",10789,"KRN","B",.402,.402)

"BLD",10789,"KRN","B",.403,.403)

"BLD",10789,"KRN","B",.5,.5)

"BLD",10789,"KRN","B",.84,.84)

"BLD",10789,"KRN","B",3.6,3.6)

"BLD",10789,"KRN","B",3.8,3.8)

"BLD",10789,"KRN","B",9.2,9.2)

"BLD",10789,"KRN","B",9.8,9.8)

"BLD",10789,"KRN","B",19,19)

"BLD",10789,"KRN","B",19.1,19.1)

"BLD",10789,"KRN","B",101,101)

"BLD",10789,"KRN","B",409.61,409.61)

"BLD",10789,"KRN","B",771,771)

"BLD",10789,"KRN","B",779.2,779.2)

"BLD",10789,"KRN","B",870,870)

"BLD",10789,"KRN","B",8989.51,8989.51)

"BLD",10789,"KRN","B",8989.52,8989.52)

"BLD",10789,"KRN","B",8994,8994)

"BLD",10789,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",10789,"QUES",0)
^9.62^^
"BLD",10789,"REQB",0)
^9.611^9^4
"BLD",10789,"REQB",6,0)
PSO*7.0*440^2
"BLD",10789,"REQB",7,0)
PSO*7.0*515^2
"BLD",10789,"REQB",8,0)
PSO*7.0*362^2
"BLD",10789,"REQB",9,0)
PSO*7.0*463^2
"BLD",10789,"REQB","B","PSO*7.0*362",8)

"BLD",10789,"REQB","B","PSO*7.0*440",6)

"BLD",10789,"REQB","B","PSO*7.0*463",9)

"BLD",10789,"REQB","B","PSO*7.0*515",7)

"MBREQ")
0
"PKG",206,-1)
1^1
"PKG",206,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",206,20,0)
^9.402P^^
"PKG",206,22,0)
^9.49I^1^1
"PKG",206,22,1,0)
7.0^3021122^3021202^66481
"PKG",206,22,1,"PAH",1,0)
514^3180801^100877
"PKG",206,22,1,"PAH",1,1,0)
^^5^5^3180801
"PKG",206,22,1,"PAH",1,1,1,0)
This patch will resolve the following issues.
"PKG",206,22,1,"PAH",1,1,2,0)
 
"PKG",206,22,1,"PAH",1,1,3,0)
1. I9914421FY16 - all prescription information is not displayed on the
"PKG",206,22,1,"PAH",1,1,4,0)
                  Pharmacy verification screen
"PKG",206,22,1,"PAH",1,1,5,0)
2. R18151128FY18 - QTY Recalculation when Drug Changed
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","PSOCPB")
0^6^B93317750^B93273887
"RTN","PSOCPB",1,0)
PSOCPB ;BIR/BaB - pharmacy co-pay application cont'd ;1/30/07 9:08am
"RTN","PSOCPB",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**72,71,85,185,143,219,239,201,263,303,431,476,463,514**;DEC 1997;Build 32
"RTN","PSOCPB",3,0)
 ;
"RTN","PSOCPB",4,0)
 ;REF/IA
"RTN","PSOCPB",5,0)
 ;DIS^SDROUT2/112
"RTN","PSOCPB",6,0)
 ;^IBARX/125
"RTN","PSOCPB",7,0)
 ;VADPT/10061
"RTN","PSOCPB",8,0)
 ;SWSTAT^IBBAPI/4663
"RTN","PSOCPB",9,0)
 ;Reference to $$CPTIER^PSNAPIS(P1,P3) supported by DBIA #2531
"RTN","PSOCPB",10,0)
COPAY ;
"RTN","PSOCPB",11,0)
 ;Called by PSON52,PSORN52...Requires PSOCPAY,PSOBILL,DEA=PSDEA,PSOFLAG
"RTN","PSOCPB",12,0)
 ;PSOFLAG=1 NEW, PSOFLAG=0 RENEW
"RTN","PSOCPB",13,0)
 S PSOSAVE=PSOCPAY ; Save original status of PSOCPAY
"RTN","PSOCPB",14,0)
 I '$G(PSOSCP)!('$G(PSOSCA)) D SCP^PSORN52D  ;CIDC-must ask sc if flagged for it in enrollment
"RTN","PSOCPB",15,0)
 I $G(PSODRUG("DEA"))["S"!($G(PSODRUG("DEA"))["I")!($G(PSODRUG("DEA"))["N") S PSOCPAY=0
"RTN","PSOCPB",16,0)
 G:+PSOBILL'=2&('$G(PSOSCA)) COPAY2
"RTN","PSOCPB",17,0)
 D FULL^VALM1
"RTN","PSOCPB",18,0)
 I $G(PSOMESOI)=1,$G(PSORXED) W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESOI=2
"RTN","PSOCPB",19,0)
 I $G(PSOMESFI)=1 W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESFI=2
"RTN","PSOCPB",20,0)
 S DFN=+$G(PSODFN) D CHKPAG^PSOMLLD2,DISSCD^PSOMLLD2  ;*514
"RTN","PSOCPB",21,0)
ASK ;
"RTN","PSOCPB",22,0)
 N PSOUFLAG S PSOUFLAG=0
"RTN","PSOCPB",23,0)
 K PSOCPZ("DFLG"),PSONEW("NEWCOPAY")
"RTN","PSOCPB",24,0)
 W ! K DIR,DTOUT,DIRUT,DUOUT
"RTN","PSOCPB",25,0)
 I $G(PSORX("SC"))="SC"!($G(PSORX("SC"))="NSC")!($G(PSOSCOTH)) D
"RTN","PSOCPB",26,0)
 .W:PSOSCP<50&($G(PSODRUG("DEA"))'["S")&($G(PSODRUG("DEA"))'["I")&($G(PSODRUG("DEA"))'["N") !,"This Rx has been flagged by the provider as: "_$S($G(PSOSCOTH):"NO COPAY",$G(PSORX("SC"))="SC":"NO COPAY",1:"COPAY"),!
"RTN","PSOCPB",27,0)
 .I $G(PSOSCOTX) S PSOSCOTX=2
"RTN","PSOCPB",28,0)
 S DIR("A")="Was treatment for Service Connected condition",DIR(0)="Y"
"RTN","PSOCPB",29,0)
 S DIR("?")="Enter 'Yes' if this prescription is for a Service Connected condition"
"RTN","PSOCPB",30,0)
 I $G(PSORX("SC"))]""!($G(PSORX(+$G(PSORENW("OIRXN")),"SC"))'="") S DIR("B")=$S($G(PSORX("SC"))="SC":"YES",$G(PSORX("SC"))="NSC":"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=1:"YES",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=0:"NO",1:"")
"RTN","PSOCPB",31,0)
 I $G(PSONEWFF),$G(PSOFLAG) I $G(PSOANSQD("SC"))=0!($G(PSOANSQD("SC"))=1) S DIR("B")=$S($G(PSOANSQD("SC"))=1:"YES",1:"NO")
"RTN","PSOCPB",32,0)
 I $G(DIR("B"))="YES"!($G(DIR("B"))="NO") S PSOUFLAG=$G(DIR("B"))
"RTN","PSOCPB",33,0)
 I $G(DIR("B"))="" K DIR("B")
"RTN","PSOCPB",34,0)
 D ^DIR
"RTN","PSOCPB",35,0)
 I $G(Y)=1!($G(Y)=0) S PSOANSQ("SC")=$G(Y) I $G(PSONEWFF),$G(PSOFLAG) S PSOANSQD("SC")=$G(Y)
"RTN","PSOCPB",36,0)
 I PSOFLAG I Y["^"!($D(DTOUT))!($D(DUOUT)) S PSOCPZ("DFLG")=1
"RTN","PSOCPB",37,0)
 S:Y=0 Y=2
"RTN","PSOCPB",38,0)
 S PSOANSR=+Y I 'PSOANSR,'PSOFLAG D  S $P(PSOCPAY,"^")=$S($G(PSOUFLAG)="NO":1,1:0) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR G COPAY2
"RTN","PSOCPB",39,0)
 .W !!,"This Renewal has been designated as "_$S($G(PSOUFLAG)="YES":"SERVICE CONNECTED",1:"NON-SERVICE CONNECTED.")
"RTN","PSOCPB",40,0)
 .W:PSOSCP<50&($G(PSODRUG("DEA"))'["S")&($G(PSODRUG("DEA"))'["I")&($G(PSODRUG("DEA"))'["N") !,"Please use the 'Reset Copay Status/Cancel Charges' option to make corrections."
"RTN","PSOCPB",41,0)
 .S PSOANSQ("SC")=$S($G(PSOUFLAG)="YES":1,1:0)
"RTN","PSOCPB",42,0)
 I $G(PSOFLAG),$G(PSOCPZ("DFLG")) G EXIT
"RTN","PSOCPB",43,0)
 S:PSOANSR=1 PSOCPAY=0 S:PSOANSR=2 $P(PSOCPAY,"^")=1
"RTN","PSOCPB",44,0)
COPAY2 ;
"RTN","PSOCPB",45,0)
 N PSOPFS S PSOPFS=$$SWSTAT^IBBAPI()
"RTN","PSOCPB",46,0)
 ;***** begin - for regression test FMCT - sites must not use this as it will adversely affect billing results - only used by SQA
"RTN","PSOCPB",47,0)
 ; The following is required for testing different effective dates.  If date is less than 02/27/17 bills old way.  Otherwise bills new way.
"RTN","PSOCPB",48,0)
 ;S ^XTMP("PSOTIEREFTST",0)="3201231^3170227^FOR SQA TESTING ONLY" - Defined for SQA testing only.   Delete this XTMP when regression complete
"RTN","PSOCPB",49,0)
 D NOW^%DTC N PSOTIERE
"RTN","PSOCPB",50,0)
 S PSOTIERE=1  ;use copay tiers - new
"RTN","PSOCPB",51,0)
 I $P(%,".")<3170227 S PSOTIERE=0  ;legacy billing - old
"RTN","PSOCPB",52,0)
 I $G(^XTMP("PSOTIEREFTST",0)) S PSOTIERE=1  ;for SQA testing only - bill with copay tiers - new
"RTN","PSOCPB",53,0)
 ;***** end for regression test
"RTN","PSOCPB",54,0)
 G COPAY21:'PSOTIERE
"RTN","PSOCPB",55,0)
 ;Check copay tier. Tier zero does not have copay charges. Tier billing will be effective 2/27/17 and IB rate table decides what amount to bill based on rate effective date
"RTN","PSOCPB",56,0)
 N CPDATE,X,PSOCPT D NOW^%DTC S CPDATE=X,PSOCPT=$$CPTIER^PSNAPIS("",CPDATE,PSODRUG("IEN")) K CPDATE,X
"RTN","PSOCPB",57,0)
 I $P(PSOCPT,"^")=0 S PSOCHG=0 K PSONEW("NEWCOPAY") G EXIT  ;Tier zero do not send to IB for copay charge
"RTN","PSOCPB",58,0)
 ;
"RTN","PSOCPB",59,0)
COPAY21 I +PSOCPAY=1,($P(PSOCPAY,"^",2)=1)!($P(PSOCPAY,"^",2)=2) D
"RTN","PSOCPB",60,0)
 .;set IB node in ^PSRX for copay if xactn type is 1 or 2
"RTN","PSOCPB",61,0)
 .S PSONEW("NEWCOPAY")=$P($G(PSOCPAY),"^",2)_"^^"_$S(+$G(PSOPFS):"",1:$P($G(PSOCPAY),"^",2))
"RTN","PSOCPB",62,0)
EXIT ;
"RTN","PSOCPB",63,0)
 S PSOCPAY=PSOSAVE ;Restore val of PSOCPAY
"RTN","PSOCPB",64,0)
 K PSOSAVE,PSOANSR,DIR,DUOUT,DIRUT,DTOUT,Y,X
"RTN","PSOCPB",65,0)
 Q
"RTN","PSOCPB",66,0)
RESET ;RESET COPAY STATUS
"RTN","PSOCPB",67,0)
 K PSOSUMM,PSOPFS,PSOPFSA,PSOLFIL,PSOPFSG
"RTN","PSOCPB",68,0)
 I '$D(PSOPAR) D ^PSOLSET G RESET
"RTN","PSOCPB",69,0)
 W ! S DIC="^PSRX(",DIC(0)="AEQZ" D ^DIC K DIC G:Y<0 EXT S PSODA=+Y
"RTN","PSOCPB",70,0)
 W !,?17,"PATIENT: ",$P($G(^DPT($P(^PSRX(PSODA,0),"^",2),0)),"^")
"RTN","PSOCPB",71,0)
 D ICN^PSODPT($P(^PSRX(PSODA,0),"^",2))
"RTN","PSOCPB",72,0)
 S PSORXN=$P(^PSRX(PSODA,0),"^"),PREA="R"
"RTN","PSOCPB",73,0)
 S PCOPAY=$G(^PSRX(PSODA,"IB"))
"RTN","PSOCPB",74,0)
 W !!,"Rx # ",PSORXN," is a ",$S(+PCOPAY:"Copay",1:"No Copay")," prescription"
"RTN","PSOCPB",75,0)
 S PSOLFIL=$$LF^PSOPFSU1(PSODA) D PFSA^PSOPFSU1(PSODA,PSOLFIL,3)  ;PSOCPC def PSOPFSA=1 if OP SC/EI's change.
"RTN","PSOCPB",76,0)
 D EXEMCHK^PSOCPC ; CHECK/CHANGE EXEMPTION FLAGS
"RTN","PSOCPB",77,0)
 S PSOIBQ=$G(^PSRX(PSODA,"IBQ"))
"RTN","PSOCPB",78,0)
 I '$G(^PSRX(PSODA,"IB")),PSOIBQ'["1" D  G ASKCAN
"RTN","PSOCPB",79,0)
 . K DIR S DIR(0)="Y",DIR("B")="N",DIR("A")="Do you want to reset the status to COPAY" D ^DIR K DIR
"RTN","PSOCPB",80,0)
 . I Y'=1 Q
"RTN","PSOCPB",81,0)
 . S DIC="^IBE(350.3,",DIC("S")="I $P(^(0),U,3)'=2",DIC(0)="AEQMZ",DIC("A")="Select Reason for Reset : " D ^DIC K DIC I Y'<0 S PSORSN=+Y
"RTN","PSOCPB",82,0)
 . S PREA="R",PSOOLD="No Copay",PSONW="Copay",PSOCOMM="" D ACTLOG^PSOCPA
"RTN","PSOCPB",83,0)
 . S PSI=0,PSOCOMM="Copay status of this Rx has been reset to COPAY." D SETSUMM^PSOCPC
"RTN","PSOCPB",84,0)
 . S $P(^PSRX(PSODA,"IB"),"^")=1 ;Reset flag to COPAY
"RTN","PSOCPB",85,0)
 ;
"RTN","PSOCPB",86,0)
 I $G(^PSRX(PSODA,"IB")) D  G ASKCAN
"RTN","PSOCPB",87,0)
 . K DIR S DIR(0)="Y",DIR("B")="N",DIR("A")="Do you want to reset the status to NO COPAYMENT" D ^DIR K DIR
"RTN","PSOCPB",88,0)
 . I Y'=1 Q
"RTN","PSOCPB",89,0)
 . S DIC="^IBE(350.3,",DIC("S")="I $P(^(0),U,3)'=2",DIC(0)="AEQMZ",DIC("A")="Select Reason for Reset : " D ^DIC K DIC I Y'<0 S PSORSN=+Y
"RTN","PSOCPB",90,0)
 . S PREA="R",PSOOLD="Copay",PSONW="No Copay",PSOCOMM="" D ACTLOG^PSOCPA
"RTN","PSOCPB",91,0)
 . S PSI=0,PSOCOMM="Copay status of this Rx has been reset to NO COPAY." D SETSUMM^PSOCPC
"RTN","PSOCPB",92,0)
 . S $P(^PSRX(PSODA,"IB"),"^")="" ;Reset flag to NO COPAY
"RTN","PSOCPB",93,0)
ASKCAN D ASKCAN^PSOCPD
"RTN","PSOCPB",94,0)
 I '$D(PSOSUMM) S PSI=0,PSOCOMM="No action taken" D SETSUMM^PSOCPC
"RTN","PSOCPB",95,0)
 D PRTSUMM
"RTN","PSOCPB",96,0)
 ;I $P($G(PSOPFS),"^",3)>0&(+$G(PSOPFSA)) D CHRG^PSOPFSU1(PSODA,PSOLFIL,"CG",PSOPFS)
"RTN","PSOCPB",97,0)
RESETE K PSODA,PSORXN,PSORSN,PSOREF,X,Y,PCOPAY,PREA,PSOCOMM,PSI
"RTN","PSOCPB",98,0)
 G RESET
"RTN","PSOCPB",99,0)
EXT K PSODA,PSORXN,PSORSN,PSOREF,X,Y,PCOPAY,PREA,PSOCOPAY
"RTN","PSOCPB",100,0)
 Q
"RTN","PSOCPB",101,0)
BILLED ;Collect IB nums,cancel chrgs,reset flag.
"RTN","PSOCPB",102,0)
 W !!,"**********Charges are on file for this Rx.**********"
"RTN","PSOCPB",103,0)
 Q
"RTN","PSOCPB",104,0)
BILL2 ;
"RTN","PSOCPB",105,0)
 N PSOPREV ; VAR FOR PREV CANCELLED
"RTN","PSOCPB",106,0)
 S PSOPREV=0
"RTN","PSOCPB",107,0)
 S DIC="^IBE(350.3,",DIC("S")="I $P(^(0),U,3)'=2",DIC(0)="AEQMZ",DIC("A")="Select Reason for Reset or Charge Cancellation : " D ^DIC K DIC G ENDMSG:Y<0 S PSORSN=+Y
"RTN","PSOCPB",108,0)
 S X=PSOPAR7_"^"_+$P(^PSRX(PSODA,0),"^",2)_"^^"_DUZ
"RTN","PSOCPB",109,0)
 S SAVX=X
"RTN","PSOCPB",110,0)
 I $D(PSOCAN) D:'$G(PSOPFS)  I +$G(PSOPFS)!($G(PSOPFSG)) D PFS^PSOPFSU1 G BILL2END:'$D(PSOCAN)
"RTN","PSOCPB",111,0)
 . N III S III="" F  S III=$O(PSOCAN(III)) Q:III=""  I PSOCAN(III)["PFS" S PSOPFSG=1 Q  ;PFSS switch off, check for prev cots billing
"RTN","PSOCPB",112,0)
 D POTBILL2
"RTN","PSOCPB",113,0)
 I '$D(PSOCAN) G BILL2END
"RTN","PSOCPB",114,0)
 I $G(CANTYPE) D PREVCAN I $O(X(""))="" Q
"RTN","PSOCPB",115,0)
 I '$G(CANTYPE) S I="" F  S I=$O(PSOCAN(I)) Q:I=""  S X($P(PSOCAN(I),"^",1))=$P(PSOCAN(I),"^",2)_"^"_PSORSN
"RTN","PSOCPB",116,0)
 D CANCEL^IBARX
"RTN","PSOCPB",117,0)
 I $G(CANTYPE) D MSG
"RTN","PSOCPB",118,0)
 I '$D(Y) Q
"RTN","PSOCPB",119,0)
 I +Y=-1 Q
"RTN","PSOCPB",120,0)
 I $D(Y(PSORXN)),+Y(PSORXN)'=-1 S $P(^PSRX(PSODA,"IB"),"^",2)=+Y(PSORXN) K Y(PSORXN) S PREA="C",PSOREF=0,PSOOLD="",PSONW="" D ACTLOG^PSOCPA I '$G(CANTYPE) D MSG
"RTN","PSOCPB",121,0)
 F PSOREF=0:0 S PSOREF=$O(Y(PSOREF)) Q:PSOREF=""  I +Y(PSOREF)'=-1 S ^PSRX(PSODA,1,PSOREF,"IB")=+Y(PSOREF) S PREA="C",PSOOLD="",PSONW="" D ACTLOG^PSOCPA I '$G(CANTYPE) D MSG
"RTN","PSOCPB",122,0)
BILL2END K X,Y,SAVX,PSOREF,PSOCAN
"RTN","PSOCPB",123,0)
 Q
"RTN","PSOCPB",124,0)
 ;
"RTN","PSOCPB",125,0)
POTBILL2 ;see if any potential charges (entries from file 354.71 -- bills that exceeded cap prev) to be cancelled before cancelling regular charges
"RTN","PSOCPB",126,0)
 N X,I
"RTN","PSOCPB",127,0)
 S X=SAVX
"RTN","PSOCPB",128,0)
 I $T(CANIBAM^IBARX)="" Q
"RTN","PSOCPB",129,0)
 S I="" F  S I=$O(PSOCAN(I)) Q:I=""  I PSOCAN(I)["^CAP" S X($P(PSOCAN(I),"^",1))=$P(PSOCAN(I),"^",2)_"^"_PSORSN K PSOCAN(I)
"RTN","PSOCPB",130,0)
 I $O(X(""))="" Q
"RTN","PSOCPB",131,0)
 S PSOPREV=1
"RTN","PSOCPB",132,0)
 D CANIBAM^IBARX
"RTN","PSOCPB",133,0)
 I $D(X(PSORXN)) S $P(^PSRX(PSODA,"IB"),"^",4)="" S PREA="C",PSOREF=0,PSOCOMM="Potential charge cancelled",PSOOLD="",PSONW="" D ACTLOG^PSOCPA D POTMSG K X(PSORXN)
"RTN","PSOCPB",134,0)
 F PSOREF=0:0 S PSOREF=$O(X(PSOREF)) Q:PSOREF=""  Q:PSOREF>11  S $P(^PSRX(PSODA,1,PSOREF,"IB"),"^",2)="" S PREA="C",PSOCOMM="Potential charge cancelled",PSOOLD="",PSONW="" D ACTLOG^PSOCPA D POTMSG
"RTN","PSOCPB",135,0)
 K PSOREF,PREA,PSOCOMM
"RTN","PSOCPB",136,0)
 Q
"RTN","PSOCPB",137,0)
REFILL S PSOREF=0
"RTN","PSOCPB",138,0)
 F  S PSOREF=$O(^PSRX(PSODA,1,PSOREF)) Q:PSOREF'?1N.N  D
"RTN","PSOCPB",139,0)
 . I $D(^PSRX(PSODA,1,PSOREF,"PFS")) S:$P($G(^PSRX(PSODA,1,PSOREF,"PFS")),"^",2) X(PSOREF)="^"_$G(PSORSN) Q
"RTN","PSOCPB",140,0)
 . I $D(^PSRX(PSODA,1,PSOREF,"IB")),+^("IB")>0 S X(PSOREF)=+^PSRX(PSODA,1,PSOREF,"IB")_"^"_$G(PSORSN)
"RTN","PSOCPB",141,0)
 S PSOREF=0 F  S PSOREF=$O(^PSRX(PSODA,1,PSOREF)) Q:PSOREF'?1N.N  I '$D(X(PSOREF)),+$P($G(^PSRX(PSODA,1,PSOREF,"IB")),"^",2) S XX(PSOREF)=+$P(^PSRX(PSODA,1,PSOREF,"IB"),"^",2)_"^"_$G(PSORSN) ; IF ONLY ENTRY FROM 354.71 SAVE IT
"RTN","PSOCPB",142,0)
 Q
"RTN","PSOCPB",143,0)
SETCP ;IF NOT COPAY MAKE ELIG CALL/SET FLAG FOR FUTURE
"RTN","PSOCPB",144,0)
 W ! S X=PSOPAR7_"^"_+$P(^PSRX(PSODA,0),"^",2)
"RTN","PSOCPB",145,0)
 D XTYPE^IBARX
"RTN","PSOCPB",146,0)
 I +Y=-1 W !!,"Error in processing Copay eligibility, no action taken." Q
"RTN","PSOCPB",147,0)
 S (ACTYP,BL)="",(PSOBILL,PSOCPAY)=0
"RTN","PSOCPB",148,0)
CP ;
"RTN","PSOCPB",149,0)
 S ACTYP=$O(Y(ACTYP)) G:'ACTYP CP1
"RTN","PSOCPB",150,0)
 F I=0:0 S BL=$O(Y(ACTYP,BL)) Q:BL=""  I BL>0 S PSOBILL=BL,PSOCPAY=ACTYP
"RTN","PSOCPB",151,0)
 G CP
"RTN","PSOCPB",152,0)
CP1 K ACTYP,BL,I
"RTN","PSOCPB",153,0)
 I (PSOBILL'>0)!(PSOCPAY=0) G INELIG
"RTN","PSOCPB",154,0)
 S $P(^PSRX(PSODA,"IB"),"^")=PSOCPAY
"RTN","PSOCPB",155,0)
 W !,"COPAY status on this Rx has been reset.",!,"*** Future refills will be classified as COPAY."
"RTN","PSOCPB",156,0)
 S PREA="R",PSOOLD="No Copay",PSONW="Copay"
"RTN","PSOCPB",157,0)
 D ACTLOG^PSOCPA
"RTN","PSOCPB",158,0)
 Q
"RTN","PSOCPB",159,0)
INELIG W !,"This Rx does not meet patient eligibility requirement for Copay.",!,"****** Status unchanged *******"
"RTN","PSOCPB",160,0)
 S Y=-1
"RTN","PSOCPB",161,0)
 Q
"RTN","PSOCPB",162,0)
ENDMSG K X W !,"Unable to process CHARGE REMOVAL without REASON for Reset."
"RTN","PSOCPB",163,0)
 R !,"ENTER a REASON now?  (Y/N) ",X:DTIME Q:'$T
"RTN","PSOCPB",164,0)
 I ($E(X)["?")!("YyNn^"'[$E(X)) W !,"Enter YES to select REASON and RESET STATUS." G ENDMSG
"RTN","PSOCPB",165,0)
 I "Yy"[$E(X) G BILL2
"RTN","PSOCPB",166,0)
 Q
"RTN","PSOCPB",167,0)
MSG ;
"RTN","PSOCPB",168,0)
 S PSI=0
"RTN","PSOCPB",169,0)
 I $G(CANTYPE) S PSOCOMM="Rx # "_PSORXN_" - All copay charges cancelled" D SETSUMM^PSOCPC K PSOCOMM Q
"RTN","PSOCPB",170,0)
 S PSOCOMM="Rx # "_PSORXN_" - "_$S(PSOREF=0:"Original fill",1:"Refill "_PSOREF)_" copay charge cancelled"
"RTN","PSOCPB",171,0)
 D SETSUMM^PSOCPC
"RTN","PSOCPB",172,0)
 K PSOCOMM
"RTN","PSOCPB",173,0)
 Q
"RTN","PSOCPB",174,0)
POTMSG ;
"RTN","PSOCPB",175,0)
 S PSI=0
"RTN","PSOCPB",176,0)
 I $G(CANTYPE) Q  ; (MESSAGE WILL GET SET LATER)
"RTN","PSOCPB",177,0)
 S PSOCOMM="Rx # "_PSORXN_" - "_$S(PSOREF=0:"Original fill",1:"Refill "_PSOREF)_" potential copay charge cancelled"
"RTN","PSOCPB",178,0)
 D SETSUMM^PSOCPC
"RTN","PSOCPB",179,0)
 K PSOCOMM
"RTN","PSOCPB",180,0)
 Q
"RTN","PSOCPB",181,0)
MSGNOCAN ;
"RTN","PSOCPB",182,0)
 S PSI=0
"RTN","PSOCPB",183,0)
 S PSOCOMM="Rx # "_PSORXN_" - All copay charges have already been cancelled." D SETSUMM^PSOCPC K PSOCOMM
"RTN","PSOCPB",184,0)
 Q
"RTN","PSOCPB",185,0)
 ;
"RTN","PSOCPB",186,0)
PRTSUMM ; prt sum of actions in reset/cancel
"RTN","PSOCPB",187,0)
 I '$D(PSOSUMM) Q
"RTN","PSOCPB",188,0)
 W !
"RTN","PSOCPB",189,0)
 S PSI=""
"RTN","PSOCPB",190,0)
 F  S PSI=$O(PSOSUMM(PSI)) Q:PSI=""  W !,PSOSUMM(PSI)
"RTN","PSOCPB",191,0)
 K PSOSUMM
"RTN","PSOCPB",192,0)
 Q
"RTN","PSOCPB",193,0)
PREVCAN ; PREVIEW CANCELS IF "ALL" IS SELECTED
"RTN","PSOCPB",194,0)
 N I,PSOBILL
"RTN","PSOCPB",195,0)
 S I="" F  S I=$O(PSOCAN(I)) Q:I=""  D  I PSOBILL S X($P(PSOCAN(I),"^",1))=$P(PSOCAN(I),"^",2)_"^"_PSORSN
"RTN","PSOCPB",196,0)
 . S PSOBILL=1 I $T(STATUS^IBARX)'="" I PSOCAN(I)'["CAP" S PSOBILL=$$STATUS^IBARX($P(PSOCAN(I),"^",2)) S:PSOBILL=2 PSOBILL=0 ; PREVIOUSLY CANCELLED
"RTN","PSOCPB",197,0)
 I $O(X(""))="" D
"RTN","PSOCPB",198,0)
 . I PSOPREV D MSG Q
"RTN","PSOCPB",199,0)
 . D MSGNOCAN
"RTN","PSOCPB",200,0)
 Q
"RTN","PSOCPB",201,0)
 ;
"RTN","PSOMLLD2")
0^1^B38199463^B30902022
"RTN","PSOMLLD2",1,0)
PSOMLLD2 ;BIR/LE - Service Connection Check for SC>50% ;02/27/04
"RTN","PSOMLLD2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**143,219,239,225,431,514**;DEC 1997;Build 32
"RTN","PSOMLLD2",3,0)
 ;External reference SDC022 supported by DBIA 1579
"RTN","PSOMLLD2",4,0)
 ;External reference DIS^SDROUT2 private by DBIA 112
"RTN","PSOMLLD2",5,0)
 ;External reference $$GETSHAD^DGUTL3 supported by DBIA 4462
"RTN","PSOMLLD2",6,0)
 ;External reference ^DPT(DFN,.372 private by DBIA 1476
"RTN","PSOMLLD2",7,0)
 ;External reference ^DIC(31 supported by DBIA 658
"RTN","PSOMLLD2",8,0)
SC ;This routine is used for SC>50% - OUTSIDE OF COPAY - DFN AND PSOSCP VARIABLES ARE EXPECTED TO BE PRESENT WHEN CALLED
"RTN","PSOMLLD2",9,0)
 ; Requires: DFN, PSOSCP, PSOSCA 
"RTN","PSOMLLD2",10,0)
 I '$G(DFN) N DFN S DFN=+$G(PSODFN)
"RTN","PSOMLLD2",11,0)
 ;I $G(DFN) I '$$SC^SDCO22(DFN) D  Q  ;if SC>49 don't ask if api says not to
"RTN","PSOMLLD2",12,0)
 ;. K PSOANSQ("SC>50"),PSOANSQD("SC>50") I $G(PSOX("IRXN")) K PSOANSQ(PSOX("IRXN"),"SC>50")
"RTN","PSOMLLD2",13,0)
SC2 I $G(PSOMESOI)=1,$G(PSORXED) W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESOI=2
"RTN","PSOMLLD2",14,0)
 I $G(PSOMESFI)=1 W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESFI=2
"RTN","PSOMLLD2",15,0)
 N PSODISAR D CHKPAG,DISSCD ;*514
"RTN","PSOMLLD2",16,0)
 N PSOUFLAG S PSOUFLAG=0 K DIR S DIR(0)="Y"
"RTN","PSOMLLD2",17,0)
 S DIR("A")="Was treatment for a Service Connected condition"
"RTN","PSOMLLD2",18,0)
 S DIR("?")=" ",DIR("?",1)="Enter 'Yes' if this prescription is being used to treat a condition related",DIR("?",2)="to Service Connected."
"RTN","PSOMLLD2",19,0)
 I '$G(PSOFLAG) D
"RTN","PSOMLLD2",20,0)
 . I PSOSCP<50 S (DIR("B"),PSOUFLAG)=$S($G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=0:"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=1:"YES",1:"") I DIR("B")="" K DIR("B") S PSOUFLAG=0
"RTN","PSOMLLD2",21,0)
 . I PSOSCP<50&($D(PSORX(+$G(PSORENW("OIRXN")),"SC>50"))) S (DIR("B"),PSOUFLAG)=$S($G(PSORX(+$G(PSORENW("OIRXN")),"SC>50"))=0:"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SC>50"))=1:"YES",1:"") I DIR("B")=""  K DIR("B") S PSOUFLAG=0
"RTN","PSOMLLD2",22,0)
 . I PSOSCP>49 S (DIR("B"),PSOUFLAG)=$S($G(PSORX(+$G(PSORENW("OIRXN")),"SC>50"))=0:"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SC>50"))=1:"YES",1:"") I DIR("B")=""  K DIR("B") S PSOUFLAG=0
"RTN","PSOMLLD2",23,0)
 . I '$D(DIR("B"))&($D(PSOANSQD("SC>50"))!($D(PSOANSQD("SC")))) D  I '$D(DIR("B")) K DIR("B") S PSOUFLAG=0
"RTN","PSOMLLD2",24,0)
 .. I $D(PSOANSQD("SC>50")) I $G(PSOANSQD("SC>50"))=0!($G(PSOANSQD("SC>50"))=1) S (PSOUFLAG,DIR("B"))=$S($G(PSOANSQD("SC>50"))=1:"YES",1:"NO")
"RTN","PSOMLLD2",25,0)
 .. I $D(PSOANSQD("SC")) I $G(PSOANSQD("SC"))=0!($G(PSOANSQD("SC"))=1) S (PSOUFLAG,DIR("B"))=$S($G(PSOANSQD("SC"))=1:"YES",1:"NO")
"RTN","PSOMLLD2",26,0)
 I $G(PSORX("SC"))]""!($G(PSORX(+$G(PSORENW("OIRXN")),"SC"))'="") S DIR("B")=$S($G(PSORX("SC"))="SC":"YES",$G(PSORX("SC"))="NSC":"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=1:"YES",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=0:"NO",1:"")
"RTN","PSOMLLD2",27,0)
 ;
"RTN","PSOMLLD2",28,0)
 I $G(PSOFLAG),$G(PSONEWFF) I $G(PSOANSQD("SC>50"))=0!($G(PSOANSQD("SC>50"))=1) S DIR("B")=$S($G(PSOANSQD("SC>50"))=1:"YES",1:"NO")
"RTN","PSOMLLD2",29,0)
 I $G(DIR("B"))="YES"!($G(DIR("B"))="NO") S PSOUFLAG=$G(DIR("B"))
"RTN","PSOMLLD2",30,0)
 I $G(DIR("B"))="" K DIR("B")
"RTN","PSOMLLD2",31,0)
 W ! D ^DIR K DIR
"RTN","PSOMLLD2",32,0)
 I $G(Y)=1!($G(Y)=0) D  I $G(PSONEWFF),$G(PSOFLAG) S PSOANSQD("SC>50")=$G(Y)
"RTN","PSOMLLD2",33,0)
 . I $G(PSOX("IRXN")) S PSOANSQ(PSOX("IRXN"),"SC>50")=+Y
"RTN","PSOMLLD2",34,0)
 . S PSOANSQ("SC>50")=+Y
"RTN","PSOMLLD2",35,0)
 I PSOFLAG I Y["^"!($D(DTOUT))!($D(DUOUT)) S PSOCPZ("DFLG")=1
"RTN","PSOMLLD2",36,0)
 S:Y=0 Y=2
"RTN","PSOMLLD2",37,0)
 S PSOANSR=+Y I 'PSOANSR,'PSOFLAG D  S $P(PSOCPAY,"^")=$S($G(PSOUFLAG)="NO":1,1:0) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR Q
"RTN","PSOMLLD2",38,0)
 .W !!,"This Renewal has been designated as "_$S($G(PSOUFLAG)="YES":"SERVICE CONNECTED",1:"NON-SERVICE CONNECTED.")
"RTN","PSOMLLD2",39,0)
 .;W !,"Please use the 'Reset Copay Status/Cancel Charges' option to make  corrections."
"RTN","PSOMLLD2",40,0)
 .S PSOANSQ("SC>50")=$S($G(PSOUFLAG)="YES":1,1:0)
"RTN","PSOMLLD2",41,0)
 I $G(PSOFLAG),$G(PSOCPZ("DFLG")) G EXIT
"RTN","PSOMLLD2",42,0)
 S:PSOANSR=1 PSOCPAY=0 S:PSOANSR=2 $P(PSOCPAY,"^")=1
"RTN","PSOMLLD2",43,0)
EXIT ;
"RTN","PSOMLLD2",44,0)
 K PSOANSR,DIR,DUOUT,DIRUT,DTOUT,Y,X,PSOSCA
"RTN","PSOMLLD2",45,0)
 Q
"RTN","PSOMLLD2",46,0)
 ;
"RTN","PSOMLLD2",47,0)
PAUSE K DIR W ! S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOMLLD2",48,0)
 Q
"RTN","PSOMLLD2",49,0)
 ;
"RTN","PSOMLLD2",50,0)
SHAD ; PROJ 112/SHAD Question
"RTN","PSOMLLD2",51,0)
 I $G(PSODFN),$L($T(GETSHAD^DGUTL3)) I $$GETSHAD^DGUTL3(PSODFN)'=1 D  Q
"RTN","PSOMLLD2",52,0)
 . K PSOANSQ("SHAD"),PSOANSQD("SHAD") I $G(PSOX("IRXN")) K PSOANSQ(PSOX("IRXN"),"SHAD")
"RTN","PSOMLLD2",53,0)
 N PSOUFLAG S PSOUFLAG=0
"RTN","PSOMLLD2",54,0)
 K DIR S DIR(0)="Y"
"RTN","PSOMLLD2",55,0)
 S DIR("A")="Was treatment related to PROJ 112/SHAD"
"RTN","PSOMLLD2",56,0)
 S DIR("?")=" "
"RTN","PSOMLLD2",57,0)
 S DIR("?",1)="Enter 'Yes' if this prescription is being used to treat a condition due to"
"RTN","PSOMLLD2",58,0)
 S DIR("?",2)="Shipboard Hazard and Defense (SHAD) exposure."
"RTN","PSOMLLD2",59,0)
 S DIR("?",3)="This response will be used to determine whether or not a copay should"
"RTN","PSOMLLD2",60,0)
 S DIR("?",4)="be applied to the prescription."
"RTN","PSOMLLD2",61,0)
 I '$G(PSOFLAG) D
"RTN","PSOMLLD2",62,0)
 . S (DIR("B"),PSOUFLAG)=$S($G(PSORX(+$G(PSORENW("OIRXN")),"SHAD"))=0:"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SHAD"))=1:"YES",1:"")
"RTN","PSOMLLD2",63,0)
 . I DIR("B")="" K DIR("B") S PSOUFLAG=0
"RTN","PSOMLLD2",64,0)
 I $G(PSOFLAG),$G(PSONEWFF) D
"RTN","PSOMLLD2",65,0)
 . I $G(PSOANSQD("SHAD"))=0!($G(PSOANSQD("SHAD"))=1) D
"RTN","PSOMLLD2",66,0)
 . . S DIR("B")=$S($G(PSOANSQD("SHAD"))=1:"YES",1:"NO")
"RTN","PSOMLLD2",67,0)
 W ! D ^DIR K DIR
"RTN","PSOMLLD2",68,0)
 I $G(PSOFLAG) W ! D  Q
"RTN","PSOMLLD2",69,0)
 . I Y["^"!($D(DUOUT))!($G(DTOUT)) S PSOCPZ("DFLG")=1 Q
"RTN","PSOMLLD2",70,0)
 . S PSOANSQ("SHAD")=Y
"RTN","PSOMLLD2",71,0)
 . I $G(PSONEWFF) S PSOANSQD("SHAD")=Y
"RTN","PSOMLLD2",72,0)
 I Y["^"!($D(DUOUT))!($D(DTOUT)) D  Q
"RTN","PSOMLLD2",73,0)
 . W !!,"This Renewal has been designated as"_$S($G(PSOUFLAG)="YES":"",1:" NOT")_" being used for treatment of "
"RTN","PSOMLLD2",74,0)
 . W !,"Shipboard Hazard and Defense (SHAD) exposure." D:$G(PSOSCP)<50 MESS^PSOMLLDT D PAUSE
"RTN","PSOMLLD2",75,0)
 . S PSOANSQ(PSOX("IRXN"),"SHAD")=$S($G(PSOUFLAG)="YES":1,1:0)
"RTN","PSOMLLD2",76,0)
 I $G(PSOX("IRXN")) S PSOANSQ(PSOX("IRXN"),"SHAD")=Y
"RTN","PSOMLLD2",77,0)
 E  S PSOANSQ("SHAD")=Y
"RTN","PSOMLLD2",78,0)
 Q
"RTN","PSOMLLD2",79,0)
 ;
"RTN","PSOMLLD2",80,0)
CHKPAG ;
"RTN","PSOMLLD2",81,0)
 N PSOSPACE S $P(PSOSPACE," ",50)=""
"RTN","PSOMLLD2",82,0)
 S I3=0 F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  D
"RTN","PSOMLLD2",83,0)
 .S I1=^DPT(DFN,.372,I,0) I $P(I1,"^",3) D
"RTN","PSOMLLD2",84,0)
 ..S I2=$S($D(^DIC(31,+I1,0)):^(0),1:""),I2=$S($P(I2,"^",4)]"":$P(I2,"^",4),1:$P(I2,"^"))
"RTN","PSOMLLD2",85,0)
 ..S PSODISAR(I)=I2_$E(PSOSPACE,1,48-$L(I2))_$J($P(I1,"^",2),4)_"% - "_$S($P(I1,"^",3):"SERVICE CONNECTED",1:""),I3=I3+1
"RTN","PSOMLLD2",86,0)
 I 'I3 S PSODISAR(1)=$S('$O(^DPT(DFN,.372,0)):"NONE STATED",1:"NO SC DISABILITIES LISTED")
"RTN","PSOMLLD2",87,0)
 S PSODISAR=I3
"RTN","PSOMLLD2",88,0)
 K I1,I2,I3
"RTN","PSOMLLD2",89,0)
 Q
"RTN","PSOMLLD2",90,0)
 ;
"RTN","PSOMLLD2",91,0)
DISSCD ;DISPLAY SERVICE CONNECTED DISABILITIES - REPLACES CALL TO DIS^SDROUT2
"RTN","PSOMLLD2",92,0)
 ;
"RTN","PSOMLLD2",93,0)
 ;rated disabilities
"RTN","PSOMLLD2",94,0)
 ; -- Pharmacy is allowed to call this tag via a special agreement
"RTN","PSOMLLD2",95,0)
 ;    with MAS.  MAS should notify pharmacy developers of any
"RTN","PSOMLLD2",96,0)
 ;    changes that may impact PS* code.  (5/91 - MJK/BOK)
"RTN","PSOMLLD2",97,0)
 ;
"RTN","PSOMLLD2",98,0)
 I '$D(VAEL) D ELIG^VADPT S DGKVAR=1
"RTN","PSOMLLD2",99,0)
 I $Y<3,$O(PSODISAR(0)) W "DRUG: "_$S($G(PSODRUG("TRADE NAME"))]"":PSODRUG("TRADE NAME"),1:$G(PSODRUG("NAME")))
"RTN","PSOMLLD2",100,0)
 W:'+VAEL(3) !!,"Service Connected: NO" W:+VAEL(3) !!,"       SC Percent: ",$P(VAEL(3),"^",2)_"%"
"RTN","PSOMLLD2",101,0)
 W !,"     Disabilities: " I 'VAEL(4),$S('$D(^DG(391,+VAEL(6),0)):1,$P(^(0),"^",2):0,1:1) W "NOT A VETERAN" G DISQ
"RTN","PSOMLLD2",102,0)
 S I=0 F  S I=$O(PSODISAR(I)) Q:'I  D
"RTN","PSOMLLD2",103,0)
 .W !,PSODISAR(I)
"RTN","PSOMLLD2",104,0)
 .I $Y+3>IOSL D
"RTN","PSOMLLD2",105,0)
 ..S DIR(0)="E",DIR("A")=" Press the return key to continue" D ^DIR W @IOF
"RTN","PSOMLLD2",106,0)
 ..I $O(PSODISAR(I)) W "DRUG: "_$S($G(PSODRUG("TRADE NAME"))]"":PSODRUG("TRADE NAME"),1:$G(PSODRUG("NAME"))),!
"RTN","PSOMLLD2",107,0)
DISQ I $D(DGKVAR) D KVAR^VADPT K DGKVAR,I
"RTN","PSOMLLD2",108,0)
 Q
"RTN","PSORENW3")
0^5^B41588780^B41233677
"RTN","PSORENW3",1,0)
PSORENW3 ;IHS/DSD/JCM - EDIT TEMPLATE FOR RENEW RX ORDER ENTRY ; 03/28/93 20:59
"RTN","PSORENW3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,20,46,100,117,444,440,514**;DEC 1997;Build 32
"RTN","PSORENW3",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSORENW3",4,0)
 ;External reference to ^SC supported by DBIA 10040
"RTN","PSORENW3",5,0)
 ;
"RTN","PSORENW3",6,0)
START ;
"RTN","PSORENW3",7,0)
 D INIT
"RTN","PSORENW3",8,0)
 ;
"RTN","PSORENW3",9,0)
1 S PSORENW("FLD")=1 D ISSDT^PSODIR2(.PSORENW) ; Get Issue Date
"RTN","PSORENW3",10,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",11,0)
 ;
"RTN","PSORENW3",12,0)
2 S PSORENW("FLD")=2 D FILLDT^PSODIR2(.PSORENW) ; Get Fill date
"RTN","PSORENW3",13,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",14,0)
 ;
"RTN","PSORENW3",15,0)
3 S PSORENW("FLD")=3 D PROV^PSODIR(.PSORENW) ; Get Provider
"RTN","PSORENW3",16,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",17,0)
 ;
"RTN","PSORENW3",18,0)
4 S PSORENW("FLD")=4,PSORENW("DAYS SUPPLY")=$P(PSORENW("RX0"),"^",8)
"RTN","PSORENW3",19,0)
 K PSORENW("# OF REFILLS") D REFILL^PSODIR1(.PSORENW) ; Get # of refills
"RTN","PSORENW3",20,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",21,0)
 ;
"RTN","PSORENW3",22,0)
5 S PSORENW("FLD")=5 D RMK^PSODIR2(.PSORENW) ; Get Remarks
"RTN","PSORENW3",23,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",24,0)
 ;
"RTN","PSORENW3",25,0)
6 S PSORENW("FLD")=6 D MW^PSODIR2(.PSORENW) ; Get Mail/Window Info
"RTN","PSORENW3",26,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",27,0)
 ;
"RTN","PSORENW3",28,0)
7 I $G(DUZ("AG"))="I" S PSORENW("FLD")=7 D EXP^PSODIR2(.PSORENW) ; Get Expiration Date - Indian Health Service ONLY
"RTN","PSORENW3",29,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",30,0)
 ;
"RTN","PSORENW3",31,0)
8 I $G(DUZ("AG"))="I" S PSORENW("FLD")=8 D CLERK^PSODIR2(.PSORENW) ; Get Clerk Code
"RTN","PSORENW3",32,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",33,0)
 ;
"RTN","PSORENW3",34,0)
9 S PSORENW("FLD")=9 D CLINIC^PSODIR2(.PSORENW)
"RTN","PSORENW3",35,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",36,0)
 ;
"RTN","PSORENW3",37,0)
END ;
"RTN","PSORENW3",38,0)
 K PSORENW3 S PSORENW("EDIT")=1
"RTN","PSORENW3",39,0)
 Q
"RTN","PSORENW3",40,0)
 ;
"RTN","PSORENW3",41,0)
INIT ;
"RTN","PSORENW3",42,0)
 S:'$G(PSORENW("QTY")) PSORENW("QTY")=$P(PSORENW("RX0"),"^",7)
"RTN","PSORENW3",43,0)
 S:'$G(PSORENW("DAYS SUPPLY")) PSORENW("DAYS SUPPLY")=$P(PSORENW("RX0"),"^",8)
"RTN","PSORENW3",44,0)
 S (PSORENW("DFLG"),PSORENW("FIELD"),PSORENW3)=0
"RTN","PSORENW3",45,0)
 G:$G(PSORENW("EDIT")) INITX
"RTN","PSORENW3",46,0)
 S PSORENW("ISSUE DATE")=$S($P($G(OR0),"^",3)="RNW":$E($P($G(OR0),"^",6),1,7),DT>PSORENW("FILL DATE"):PSORENW("FILL DATE"),1:DT)  ;;PSO*440
"RTN","PSORENW3",47,0)
 S PSORENW("CLINIC")=$P(PSORENW("RX0"),"^",5)
"RTN","PSORENW3",48,0)
 I $G(PSOFDR),$P($G(OR0),"^",13) S PSORENW("CLINIC")=$P($G(OR0),"^",13)
"RTN","PSORENW3",49,0)
 S:PSORENW("CLINIC") PSORX("CLINIC")=$P(^SC(PSORENW("CLINIC"),0),"^")
"RTN","PSORENW3",50,0)
 S Y=PSORENW("FILL DATE") X ^DD("DD") S PSORX("FILL DATE")=Y K Y
"RTN","PSORENW3",51,0)
 S PSORENW("PROVIDER")=$S($G(PSORENW("PROVIDER")):PSORENW("PROVIDER"),1:$P(PSORENW("RX0"),"^",4))
"RTN","PSORENW3",52,0)
 S PSORENW("PROVIDER NAME")=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSORENW3",53,0)
 S PSORENW("PTST NODE")=$G(^PS(53,$P(PSORENW("RX0"),"^",3),0))
"RTN","PSORENW3",54,0)
 S PSORENW("# OF REFILLS")=$S($G(PSORENW("# OF REFILLS")):PSORENW("# OF REFILLS"),1:$P(PSORENW("RX0"),"^",9))
"RTN","PSORENW3",55,0)
 S PSORENW("REMARKS")="RENEWED FROM RX # "_$P(PSORENW("RX0"),"^")
"RTN","PSORENW3",56,0)
 S PSORX("MAIL/WINDOW")=$S($G(PSORX("MAIL/WINDOW"))]"":PSORX("MAIL/WINDOW"),$P(PSORENW("RX0"),"^",11)="W":"WINDOW",1:"MAIL")
"RTN","PSORENW3",57,0)
 S:$G(PSORX("CLERK CODE"))']"" PSORX("CLERK CODE")=$P($G(^VA(200,DUZ,0)),"^")
"RTN","PSORENW3",58,0)
 S PSORENW("INS")=$S($G(PSORENW("INS"))]"":PSORENW("INS"),1:$G(^PSRX(PSORENW("OIRXN"),"INS")))
"RTN","PSORENW3",59,0)
 F D=0:0 S D=$O(^PSRX(PSORENW("OIRXN"),"INS1",D)) Q:'D  S PSORENW("SIG",D)=^PSRX(PSORENW("OIRXN"),"INS1",D,0)
"RTN","PSORENW3",60,0)
 I '$O(PSORENW("DOSE",0)) F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),6,I)) Q:'I  S DOSE=^PSRX(PSORENW("OIRXN"),6,I,0) D
"RTN","PSORENW3",61,0)
 .S PSORENW("ENT")=$G(PSORENW("ENT"))+1,PSORENW("DOSE",PSORENW("ENT"))=$P(DOSE,"^")
"RTN","PSORENW3",62,0)
 .S PSORENW("UNITS",PSORENW("ENT"))=$P(DOSE,"^",3),PSORENW("DOSE ORDERED",PSORENW("ENT"))=$P(DOSE,"^",2),PSORENW("ROUTE",PSORENW("ENT"))=$P(DOSE,"^",7)
"RTN","PSORENW3",63,0)
 .S PSORENW("SCHEDULE",PSORENW("ENT"))=$P(DOSE,"^",8),PSORENW("DURATION",PSORENW("ENT"))=$P(DOSE,"^",5),PSORENW("CONJUNCTION",PSORENW("ENT"))=$P(DOSE,"^",6)
"RTN","PSORENW3",64,0)
 .S PSORENW("NOUN",PSORENW("ENT"))=$P(DOSE,"^",4),PSORENW("VERB",PSORENW("ENT"))=$P(DOSE,"^",9)
"RTN","PSORENW3",65,0)
 .I $G(^PSRX(PSORENW("OIRXN"),6,I,1))]"" S PSORENW("ODOSE",PSORENW("ENT"))=^PSRX(PSORENW("OIRXN"),6,I,1)
"RTN","PSORENW3",66,0)
 .K DOSE
"RTN","PSORENW3",67,0)
 I $P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^",2),'$O(SIG(0)) S SIGOK=1 D  Q
"RTN","PSORENW3",68,0)
 .F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),"SIG1",I)) Q:'I  S SIG(I)=^PSRX(PSORENW("OIRXN"),"SIG1",I,0)
"RTN","PSORENW3",69,0)
 .I '$O(SIG(0)),$G(ORD),$G(PSOORRNW) F I=0:0 S I=$O(^PS(52.41,ORD,"SIG",I)) Q:'I  S SIG(I)=^PS(52.41,ORD,"SIG",I,0)
"RTN","PSORENW3",70,0)
 .I '$O(SIG(0)) S SIG(1)="This Prescription is MISSING Required Medication Instructions for the Patient.  Please Review Dosaging Instructions."
"RTN","PSORENW3",71,0)
 I $P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^")]"",'$P(^("SIG"),"^",2),'$O(SIG(0)) S SIGOK=1 D
"RTN","PSORENW3",72,0)
 .S X=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^") D SIG^PSOHELP I $G(INS1)]"" S SIG(1)=$E(INS1,2,999)
"RTN","PSORENW3",73,0)
 .I '$O(SIG(0)) S (PSORENW("SIG"),SIG(1))="This Prescription is MISSING Required Usable Medication Instructions for the Patient.  Please Review Dosaging Instructions."
"RTN","PSORENW3",74,0)
INITX Q
"RTN","PSORENW3",75,0)
JUMP ;
"RTN","PSORENW3",76,0)
 S PSORENW("FIELD")=$S(+Y=1:1,+Y=22:2,+Y=4:3,+Y=5:9,+Y=9:4,+Y=12:5,+Y=11:6,+Y=29:7,+Y=16:8,1:PSORENW("FLD"))
"RTN","PSORENW3",77,0)
 Q
"RTN","PSORENW3",78,0)
DSPLY ;called from PSORENW0
"RTN","PSORENW3",79,0)
 S:'$G(DFN) DFN=+$G(PSORENW("PSODFN")) ;514
"RTN","PSORENW3",80,0)
 W !!,PSORENW("NRX #"),?12," ",$P(^PSDRUG(PSORENW("DRUG IEN"),0),"^"),?46," QTY: ",$S($G(PSORENW("QTY")):PSORENW("QTY"),1:$P(PSORENW("RX0"),"^",7))
"RTN","PSORENW3",81,0)
 W !,"# OF REFILLS: "_$S($G(PSORENW("# OF REFILLS")):PSORENW("# OF REFILLS"),1:$P(PSORENW("RX0"),"^",9))
"RTN","PSORENW3",82,0)
 W "  ISSUED: "_$S(DT>PSORENW("FILL DATE"):$E(PSORENW("FILL DATE"),4,5)_"-"_$E(PSORENW("FILL DATE"),6,7)_"-"_$E(PSORENW("FILL DATE"),2,3),1:$E(DT,4,5)_"-"_$E(DT,6,7)_"-"_$E(DT,2,3))
"RTN","PSORENW3",83,0)
 F DR=1:1:PSORENW("ENT") I $G(PSORENW("DURATION",DR))]"" D
"RTN","PSORENW3",84,0)
 .S DUR1=PSORENW("DURATION",DR)
"RTN","PSORENW3",85,0)
 .S PSORENW("DURATION",DR)=$S($E(DUR1,1)'?.N:$E(DUR1,2,99)_$E(DUR1,1),1:DUR1)
"RTN","PSORENW3",86,0)
 F D=0:0 S D=$O(^PSRX(PSORENW("OIRXN"),"INS1",D)) Q:'D  S PSORENW("SIG",D)=^PSRX(PSORENW("OIRXN"),"INS1",D,0)
"RTN","PSORENW3",87,0)
 K DR,DUR1 ;D EN^PSOFSIG(.PSORENW)
"RTN","PSORENW3",88,0)
 I $G(SIGOK) D:'$O(SIG(0))  W !,"SIG: " F D=0:0 Q:'$O(SIG(D))  S D=$O(SIG(D)) W SIG(D),!
"RTN","PSORENW3",89,0)
 .F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),"SIG1",I)) Q:'I  S SIG(I)=^PSRX(PSORENW("OIRXN"),"SIG1",I,0)
"RTN","PSORENW3",90,0)
 .I '$O(SIG(0)) S SIG(1)="This Prescription is MISSING Required Usable Medication Instructions",SIG(2)="for the Patient.  Please Review Dosaging Instructions.",PSORENW("DFLG")=1
"RTN","PSORENW3",91,0)
 E  W "  SIG: "_PSORENW("SIG")_"  "
"RTN","PSORENW3",92,0)
 W "FILLED: "_$E(PSORENW("FILL DATE"),4,5)_"-"_$E(PSORENW("FILL DATE"),6,7)_"-"_$E(PSORENW("FILL DATE"),2,3)
"RTN","PSORENW3",93,0)
 W !,"ROUTING: "_$S($G(PSORENW("MAIL/WINDOW"))["W":"WINDOW",1:"MAIL")
"RTN","PSORENW3",94,0)
 W "     PHYS: "_PSORX("PROVIDER NAME"),!
"RTN","PSORENW3",95,0)
 I $G(PSORENW("DFLG")),'$G(SPEED) K DIR S DIR(0)="E",DIR("A")="Rx NOT Renewed. Press Return to Continue" D ^DIR K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSORENW3",96,0)
DSPLYX Q
"RTN","PSORN52")
0^3^B45172995^B44851851
"RTN","PSORN52",1,0)
PSORN52 ;BIR/DSD - files renewal entries in prescription file ;08/09/93
"RTN","PSORN52",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,11,27,37,46,79,71,100,117,157,143,219,148,239,201,225,303,358,251,387,379,362,514**;DEC 1997;Build 32
"RTN","PSORN52",3,0)
 ;Ext ref to PSOUL^PSSLOCK sup by DBIA 2789
"RTN","PSORN52",4,0)
 ;Ext ref to SWSTAT^IBBAPI sup by DBIA 4663
"RTN","PSORN52",5,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSORN52",6,0)
EN(PSOX) ;EP
"RTN","PSORN52",7,0)
START ;
"RTN","PSORN52",8,0)
 D:$D(XRTL) T0^%ZOSV ; Start RT Mon
"RTN","PSORN52",9,0)
 N PSOIBHLD,PSOSCOTH,PSOSCOTX S (PSOSCOTH,PSOSCOTX)=0 S PSOIBHLD="" I $G(PSOFDR),$G(ORD) D
"RTN","PSORN52",10,0)
 .S PSOIBHLD=$S($P($G(^PS(52.41,ORD,0)),"^",16)="SC":1,$P($G(^(0)),"^",16)="NSC":0,1:"")
"RTN","PSORN52",11,0)
 .I '$$DT^PSOMLLDT Q
"RTN","PSORN52",12,0)
 .N PSOIBHLX S PSOIBHLX=$G(^PS(52.41,ORD,"IBQ"))
"RTN","PSORN52",13,0)
 .S PSOIBHLD=PSOIBHLD_"^"_$S($P(PSOIBHLX,"^")=1:1,$P(PSOIBHLX,"^")=0:0,1:"")_"^"_$S($P(PSOIBHLX,"^",2)=1:1,$P(PSOIBHLX,"^",2)=0:0,1:"")_"^"_$S($P(PSOIBHLX,"^",3)=1:1,$P(PSOIBHLX,"^",3)=0:0,1:"")
"RTN","PSORN52",14,0)
 .S PSOIBHLD=PSOIBHLD_"^"_$S($P(PSOIBHLX,"^",4)=1:1,$P(PSOIBHLX,"^",4)=0:0,1:"")_"^"_$S($P(PSOIBHLX,"^",5)=1:1,$P(PSOIBHLX,"^",5)=0:0,1:"")_"^"_$S($P(PSOIBHLX,"^",6)=1:1,$P(PSOIBHLX,"^",6)=0:0,1:"")
"RTN","PSORN52",15,0)
 .S PSOIBHLD=PSOIBHLD_"^"_$S($P(PSOIBHLX,"^",7)=1:1,$P(PSOIBHLX,"^",7)=0:0,1:"")
"RTN","PSORN52",16,0)
 .I $P(PSOIBHLX,"^")=1!($P(PSOIBHLX,"^",2)=1)!($P(PSOIBHLX,"^",3)=1)!($P(PSOIBHLX,"^",4)=1)!($P(PSOIBHLX,"^",5)=1)!($P(PSOIBHLX,"^",6)=1)!($P(PSOIBHLX,"^",7)=1) S PSOSCOTH=1
"RTN","PSORN52",17,0)
 I $G(PSOSCOTH)!($G(PSORX("SC"))="SC")!($G(PSORX("SC"))="NSC") S PSOSCOTX=1
"RTN","PSORN52",18,0)
 S PSOANSQ("SC>50")="" D SCP^PSORN52D
"RTN","PSORN52",19,0)
 I $G(PSOFDR),$G(ORD) I $D(^PS(52.41,ORD,"ICD")) S FILE=52.41 D GET^PSORN52D
"RTN","PSORN52",20,0)
 ;Set ans to renew from Rx, only if no ans from Pend file
"RTN","PSORN52",21,0)
 I $G(PSORENW("OIRXN")) D
"RTN","PSORN52",22,0)
 .N PSOLDIBQ S PSOLDIBQ=""  ;*362 ;do not copy over IBQ node for a renewal
"RTN","PSORN52",23,0)
 .I $P(PSOIBHLD,"^")="" D
"RTN","PSORN52",24,0)
 ..I $P($G(^PSRX(PSORENW("OIRXN"),"IB")),"^")=2 S $P(PSOIBHLD,"^")=0
"RTN","PSORN52",25,0)
 .I '$$DT^PSOMLLDT Q
"RTN","PSORN52",26,0)
 .I PSOLDIBQ="" Q
"RTN","PSORN52",27,0)
 .D IBHLD^PSORN52A
"RTN","PSORN52",28,0)
 D INIT G:PSORN52("QFLG") END D FILE^PSORN52A
"RTN","PSORN52",29,0)
 S:$D(XRT0) XRTN=$T(+0) D:$D(XRT0) T1^%ZOSV ; Stop RT Mon
"RTN","PSORN52",30,0)
 K PSOANSQ,PSOANSQD,PSONEWFF
"RTN","PSORN52",31,0)
 I $G(PSOIBHLD)'="" D
"RTN","PSORN52",32,0)
 .;Set answers based on Pend Renew, prior to Phar call
"RTN","PSORN52",33,0)
 .Q:'$G(PSOX("IRXN"))
"RTN","PSORN52",34,0)
 .I $P(PSOIBHLD,"^")=1!($P(PSOIBHLD,"^")=0) S PSOANSQ("SC")=$P(PSOIBHLD,"^")
"RTN","PSORN52",35,0)
 .I '$$DT^PSOMLLDT Q
"RTN","PSORN52",36,0)
 .I $P(PSOIBHLD,"^",2)=1!($P(PSOIBHLD,"^",2)=0) S PSOANSQ(PSOX("IRXN"),"MST")=$P(PSOIBHLD,"^",2)
"RTN","PSORN52",37,0)
 .I $P(PSOIBHLD,"^",3)=1!($P(PSOIBHLD,"^",3)=0) S PSOANSQ(PSOX("IRXN"),"VEH")=$P(PSOIBHLD,"^",3)
"RTN","PSORN52",38,0)
 .I $P(PSOIBHLD,"^",4)=1!($P(PSOIBHLD,"^",4)=0) S PSOANSQ(PSOX("IRXN"),"RAD")=$P(PSOIBHLD,"^",4)
"RTN","PSORN52",39,0)
 .I $P(PSOIBHLD,"^",5)=1!($P(PSOIBHLD,"^",5)=0) S PSOANSQ(PSOX("IRXN"),"PGW")=$P(PSOIBHLD,"^",5)
"RTN","PSORN52",40,0)
 .I $P(PSOIBHLD,"^",6)=1!($P(PSOIBHLD,"^",6)=0) S PSOANSQ(PSOX("IRXN"),"HNC")=$P(PSOIBHLD,"^",6)
"RTN","PSORN52",41,0)
 .I $P(PSOIBHLD,"^",7)=1!($P(PSOIBHLD,"^",7)=0) S PSOANSQ(PSOX("IRXN"),"CV")=$P(PSOIBHLD,"^",7)
"RTN","PSORN52",42,0)
 .I $P(PSOIBHLD,"^",8)=1!($P(PSOIBHLD,"^",8)=0) S PSOANSQ(PSOX("IRXN"),"SHAD")=$P(PSOIBHLD,"^",8)
"RTN","PSORN52",43,0)
 K PSOIBHLD
"RTN","PSORN52",44,0)
 I '$G(PSOFDR) I $G(PSORENW("OIRXN")) S FILE=52 D GET^PSORN52D
"RTN","PSORN52",45,0)
 S PSONEW("NEWCOPAY")=""
"RTN","PSORN52",46,0)
 I (PSOSCP<50&('$P($G(^PS(53,+$P(^PSRX(PSOX("IRXN"),0),"^",3),0)),"^",7))),$G(DUZ("AG"))="V" S PSOFLAG=0 D COPAY^PSOCPB
"RTN","PSORN52",47,0)
 ;I PSOSCP>49!($P($G(^PS(53,+$P(^PSRX(PSOX("IRXN"),0),"^",3),0)),"^",7)=1) S PSOFLAG=0 D SC^PSOMLLD2
"RTN","PSORN52",48,0)
 I PSOSCA&(PSOSCP>49)!((PSOSCA!(PSOBILL=2))&($P($G(^PS(53,+$P(^PSRX(PSOX("IRXN"),0),"^",3),0)),"^",7)=1)) S PSOFLAG=0 W:'$G(PSOSPRNW) @IOF D SC^PSOMLLD2 ;*514
"RTN","PSORN52",49,0)
 I $$DT^PSOMLLDT D
"RTN","PSORN52",50,0)
 .I $D(PSOIBQS(PSODFN,"CV")) D MESS D CV^PSOMLLDT I $G(PSOANSQ(PSOX("IRXN"),"CV")) K PSONEW("NEWCOPAY")
"RTN","PSORN52",51,0)
 .I $D(PSOIBQS(PSODFN,"VEH")) D MESS D VEH^PSOMLLDT I $G(PSOANSQ(PSOX("IRXN"),"VEH")) K PSONEW("NEWCOPAY")
"RTN","PSORN52",52,0)
 .I $D(PSOIBQS(PSODFN,"RAD")) D MESS D RAD^PSOMLLDT I $G(PSOANSQ(PSOX("IRXN"),"RAD")) K PSONEW("NEWCOPAY")
"RTN","PSORN52",53,0)
 .I $D(PSOIBQS(PSODFN,"PGW")) D MESS D PGW^PSOMLLDT I $G(PSOANSQ(PSOX("IRXN"),"PGW")) K PSONEW("NEWCOPAY")
"RTN","PSORN52",54,0)
 .I $D(PSOIBQS(PSODFN,"SHAD")) D MESS D SHAD^PSOMLLD2 I $G(PSOANSQ(PSOX("IRXN"),"SHAD")) K PSONEW("NEWCOPAY")
"RTN","PSORN52",55,0)
 .I $D(PSOIBQS(PSODFN,"MST")) D MESS D MST^PSOMLLDT I $G(PSOANSQ(PSOX("IRXN"),"MST")) K PSONEW("NEWCOPAY")
"RTN","PSORN52",56,0)
 .I $D(PSOIBQS(PSODFN,"HNC")) D MESS D HNC^PSOMLLDT I $G(PSOANSQ(PSOX("IRXN"),"HNC")) K PSONEW("NEWCOPAY")
"RTN","PSORN52",57,0)
 K PSOSCOTH,PSOSCOTX
"RTN","PSORN52",58,0)
 I $G(PSONEW("NEWCOPAY")) S ^PSRX(PSOX("IRXN"),"IB")=PSONEW("NEWCOPAY")
"RTN","PSORN52",59,0)
 ;
"RTN","PSORN52",60,0)
 D FINISH,ACP^PSOUTIL
"RTN","PSORN52",61,0)
 ;
"RTN","PSORN52",62,0)
 N PSOSCFLD S PSOSCFLD=$S(PSOSCP'="":$G(PSOANSQ("SC")),1:"")_"^"_$G(PSOANSQ(PSOX("IRXN"),"MST"))_"^"_$G(PSOANSQ(PSOX("IRXN"),"VEH"))_"^"_$G(PSOANSQ(PSOX("IRXN"),"RAD"))
"RTN","PSORN52",63,0)
 S PSOSCFLD=PSOSCFLD_"^"_$G(PSOANSQ(PSOX("IRXN"),"PGW"))_"^"_$G(PSOANSQ(PSOX("IRXN"),"HNC"))_"^"_$G(PSOANSQ(PSOX("IRXN"),"CV"))_"^"_$G(PSOANSQ(PSOX("IRXN"),"SHAD"))
"RTN","PSORN52",64,0)
 I PSOSCP<50&($TR(PSOSCFLD,"^")'="")&('$P($G(^PS(53,+$P(^PSRX(PSOX("IRXN"),0),"^",3),0)),"^",7)) S ^PSRX(PSOX("IRXN"),"IBQ")=PSOSCFLD K PSOSCFLD
"RTN","PSORN52",65,0)
 ;
"RTN","PSORN52",66,0)
 D FILE2^PSORN52D
"RTN","PSORN52",67,0)
 D:$$SWSTAT^IBBAPI() GACT^PSOPFSU0(PSOX("IRXN"),0)
"RTN","PSORN52",68,0)
 K PSONEW("NEWCOPAY"),PSOANSQ
"RTN","PSORN52",69,0)
END D EOJ
"RTN","PSORN52",70,0)
 Q
"RTN","PSORN52",71,0)
INIT S PSORN52("QFLG")=0 S:'$D(PSOX("DAYS SUPPLY")) PSOX("DAYS SUPPLY")=$P(PSOX("RX0"),"^",8)
"RTN","PSORN52",72,0)
 S:'$D(PSOX("# OF REFILLS")) PSOX("# OF REFILLS")=$P(PSOX("RX0"),"^",9) S:'$D(PSOX("ISSUE DATE")) PSOX("ISSUE DATE")=DT
"RTN","PSORN52",73,0)
 D INIT^PSON52 K PSON52
"RTN","PSORN52",74,0)
 Q
"RTN","PSORN52",75,0)
 ;
"RTN","PSORN52",76,0)
FINISH ;
"RTN","PSORN52",77,0)
 N PSOTFIN
"RTN","PSORN52",78,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S PSOTFIN="",PSOTFIN=$$TECH2^PSODGDGP(PSOX("IRXN"),PSODFN,DUZ,.PSOX)
"RTN","PSORN52",79,0)
 I '$D(^XUSEC("PSORPH",DUZ)) G FINISHP:$G(PSOTFIN)=1 G FINISHX:$G(PSOTFIN)=2
"RTN","PSORN52",80,0)
 ;
"RTN","PSORN52",81,0)
 I $G(PSOX("QS"))="S",$G(PSOBARCD) S DA=PSOX("IRXN"),RXFL(PSOX("IRXN"))=0 D SUS^PSORXL K DA G FINISHX
"RTN","PSORN52",82,0)
 ;
"RTN","PSORN52",83,0)
 I PSOX("FILL DATE")>DT,$P(PSOPAR,"^",6) S DA=PSOX("IRXN"),RXFL(PSOX("IRXN"))=0 D SUS^PSORXL K DA G FINISHX
"RTN","PSORN52",84,0)
 ;
"RTN","PSORN52",85,0)
 ; - Submitting Rx to ECME for 3rd Party Billing
"RTN","PSORN52",86,0)
 N ACTION
"RTN","PSORN52",87,0)
 I $$SUBMIT^PSOBPSUT(PSOX("IRXN"),0) D  I ACTION="Q"!(ACTION="^") Q
"RTN","PSORN52",88,0)
 . S ACTION="" D ECMESND^PSOBPSU1(PSOX("IRXN"),0,"","RN")
"RTN","PSORN52",89,0)
 .; Quit if there is an unresolved Tricare/CHAMPVA non-billable reject code, PSO*7*358
"RTN","PSORN52",90,0)
 . I $$PSOET^PSOREJP3(PSOX("IRXN"),0) S ACTION="Q" Q
"RTN","PSORN52",91,0)
 . I $$FIND^PSOREJUT(PSOX("IRXN"),0) D
"RTN","PSORN52",92,0)
 . . S ACTION=$$HDLG^PSOREJU1(PSOX("IRXN"),0,"79,88","RN","IOQ","Q")
"RTN","PSORN52",93,0)
 ;
"RTN","PSORN52",94,0)
 I $G(PSOX("QS"))="Q",$G(PSOBARCD) D  G FINISHX
"RTN","PSORN52",95,0)
 . N PSOFROM S PSOFROM="BATCH" I $G(PPL),$L(PPL_PSOX("IRXN")_",")>240 D TRI^PSOBBC D Q^PSORXL K PPL,RXFL
"RTN","PSORN52",96,0)
 .S RXFL(PSOX("IRXN"))=0
"RTN","PSORN52",97,0)
 . I $G(PPL) S PPL=PPL_PSOX("IRXN")_","
"RTN","PSORN52",98,0)
 . E  S PPL=PSOX("IRXN")_","
"RTN","PSORN52",99,0)
 . Q
"RTN","PSORN52",100,0)
FINISHP I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=PSOX("IRXN")_",",RXFL(PSOX("IRXN"))=0 G FINISHX
"RTN","PSORN52",101,0)
 F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSORN52",102,0)
 I $L(PSORX("PSOL",PSOX2))+$L(PSOX("IRXN"))<220 S PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_PSOX("IRXN")_","
"RTN","PSORN52",103,0)
 E  S PSORX("PSOL",PSOX2+1)=PSOX("IRXN")_","
"RTN","PSORN52",104,0)
 S RXFL(PSOX("IRXN"))=0
"RTN","PSORN52",105,0)
FINISHX ;
"RTN","PSORN52",106,0)
 ;call to build bingo board Rx array
"RTN","PSORN52",107,0)
 S:'$G(PSORX("MAIL/WINDOW")) PSORX("MAIL/WINDOW")=$P(PSORENW("NRX0"),"^",11)
"RTN","PSORN52",108,0)
 I $G(PSORX("MAIL/WINDOW"))["W" S BINGCRT=1,BINGRTE="W",BBFLG=1 D BBRX^PSORN52C
"RTN","PSORN52",109,0)
 K PSOX1,PSOX2,^TMP("PSODOSF")
"RTN","PSORN52",110,0)
 Q
"RTN","PSORN52",111,0)
EOJ ;
"RTN","PSORN52",112,0)
 L -^PSRX("B",PSOX("IRXN")) K PSORN52,PSOX("INS"),PSORENW("INS"),PSORXED("INS"),PSONEW("ENT"),PSORXED("ENT"),OLENT,PSOIBHLD,PSOX("SINS"),PSORENW("SINS"),PSORXED("SINS"),FILE
"RTN","PSORN52",113,0)
 D PSOUL^PSSLOCK(PSOX("IRXN")) D PSOUL^PSSLOCK(PSOX("OIRXN"))
"RTN","PSORN52",114,0)
 Q
"RTN","PSORN52",115,0)
MESS ;
"RTN","PSORN52",116,0)
 I $G(PSOSCOTX)=1&(PSOSCP<50) W:$G(PSODRUG("DEA"))'["S"&($G(PSODRUG("DEA"))'["I") !!,"This Rx has been flagged by the provider as: "_$S($G(PSOSCOTH):"NO COPAY",$G(PSORX("SC"))="SC":"NO COPAY",1:"COPAY"),! S PSOSCOTX=2
"RTN","PSORN52",117,0)
 Q
"RTN","PSOSIG")
0^4^B103751531^B95915445
"RTN","PSOSIG",1,0)
PSOSIG ;BIR/RTR-Utility to create SIG ;6/04/00
"RTN","PSOSIG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,99,114,391,313,282,455,446,402,500,515,514**;DEC 1997;Build 32
"RTN","PSOSIG",3,0)
 ;External reference to PS(51 supported by DBIA 2224
"RTN","PSOSIG",4,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOSIG",5,0)
 ;External reference to PSDRUG( supported by DBIA 221
"RTN","PSOSIG",6,0)
 ;
"RTN","PSOSIG",7,0)
EN(PSOSIGX) ;
"RTN","PSOSIG",8,0)
 N VARIABLE
"RTN","PSOSIG",9,0)
 Q
"RTN","PSOSIG",10,0)
SCH ;*282 Preserve old functionality
"RTN","PSOSIG",11,0)
 I $D(DTOUT)!($D(DUOUT)) Q
"RTN","PSOSIG",12,0)
 I Y>0!($G(SCH)[" ") S SCHEX=$$SCHE(SCH)
"RTN","PSOSIG",13,0)
 I Y'>0 W !,?2,"Free text '"_$G(SCH)_"' entered for schedule"
"RTN","PSOSIG",14,0)
 Q
"RTN","PSOSIG",15,0)
 ;
"RTN","PSOSIG",16,0)
 ;SCHE is the new schedule expander
"RTN","PSOSIG",17,0)
SCHE(SCH) ;
"RTN","PSOSIG",18,0)
 ;SCH = Schedule entered
"RTN","PSOSIG",19,0)
 ;Returns Expanded Schedule, or ""
"RTN","PSOSIG",20,0)
 N SCHEX,SPCT
"RTN","PSOSIG",21,0)
 I SCH[""""!($A(SCH)=45)!(SCH?.E1C.E)!($L(SCH," ")>$S(SCH["PRN":4,1:3))!($L(SCH)>20)!($L(SCH)<1) K SCH Q ""
"RTN","PSOSIG",22,0)
 S SCH=$$UPPER(SCH)
"RTN","PSOSIG",23,0)
 S SPCT=0 F I=1:1:$L(SCH) I $E(SCH,I)=" " S SPCT=SPCT+1
"RTN","PSOSIG",24,0)
 S SCHEX=$$EXP(SCH) I SCHEX]"" Q SCHEX
"RTN","PSOSIG",25,0)
 Q:SPCT=0 SCH
"RTN","PSOSIG",26,0)
 Q $$SCHE($P(SCH," ",1,SPCT))_" "_$$SCHE($P(SCH," ",SPCT+1))
"RTN","PSOSIG",27,0)
EXP(X) ; expand based on 51.1 and 51
"RTN","PSOSIG",28,0)
 N PSIN,SCFLG,SCHEX
"RTN","PSOSIG",29,0)
 S PSIN=0 F  S PSIN=$O(^PS(51.1,"APPSJ",X,PSIN)) Q:'PSIN!$G(SCFLG)  I $P(^PS(51.1,PSIN,0),"^",8)'="" S SCHEX=$P($G(^(0)),"^",8),SCFLG=1
"RTN","PSOSIG",30,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",31,0)
 S PSIN=0 F  S PSIN=$O(^PS(51.1,"D",X,PSIN)) Q:'PSIN!$G(SCFLG)  I $P(^PS(51.1,PSIN,0),"^",8)'="" S SCHEX=$P($G(^(0)),"^",8),SCFLG=1
"RTN","PSOSIG",32,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",33,0)
 S PSIN=0 F  S PSIN=$O(^PS(51,"B",X,PSIN)) Q:'PSIN!$G(SCLFL)  I PSIN,($P(^PS(51,PSIN,0),"^",4)<2)&($P($G(^PS(51,"A",X)),"^")'="") S SCHEX=$P(^(X),"^"),SCFLG=1
"RTN","PSOSIG",34,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",35,0)
 S PSIN=0 F  S PSIN=$O(^PS(51,"D",X,PSIN)) Q:'PSIN!$G(SCLFL)  I PSIN,($P(^PS(51,PSIN,0),"^",4)<2)&($P($G(^PS(51,"A",X)),"^")'="") S SCHEX=$P(^(X),"^"),SCFLG=1
"RTN","PSOSIG",36,0)
 Q:$G(SCFLG) SCHEX
"RTN","PSOSIG",37,0)
 Q ""
"RTN","PSOSIG",38,0)
 ;
"RTN","PSOSIG",39,0)
QTY(PSOQX) ; PSOQX - Array containing Rx information
"RTN","PSOSIG",40,0)
 N QDOSE,PSORXIEN,PSODSEDT,PSOOUTQT
"RTN","PSOSIG",41,0)
 K PSOQX("QTY")
"RTN","PSOSIG",42,0)
 S PSORXIEN=$S($G(PSOQX("IRXN")):+PSOQX("IRXN"),1:0)
"RTN","PSOSIG",43,0)
 S PSODSEDT=$S(PSORXIEN&$D(PSOQX(52,PSORXIEN,8)):1,'PSORXIEN&($G(PSOQX("FLD"))=8):1,1:0)  ; DAYS SUPPLY field edited
"RTN","PSOSIG",44,0)
 I 'PSORXIEN,$G(PSOQX("FLD"))=7 Q   ; QTY field being edite for Pending Order (do not ajust current QTY)
"RTN","PSOSIG",45,0)
 S PSOOUTQT=1
"RTN","PSOSIG",46,0)
QTYCP ;CPRS qty call comes through here
"RTN","PSOSIG",47,0)
 N PSQQUIT,QTSH,PSQ,PSQMIN,PSQMINZ,PSOQRND,PSOLOWER,PSOLOWX,PSOLOWXL,PSOLOWST,PSORXDRG
"RTN","PSOSIG",48,0)
 K PSOFRQ S PSQQUIT=0
"RTN","PSOSIG",49,0)
 I '$G(PSOCPRQT) S QDOSE=0 F PSQ=0:0 S PSQ=$O(PSOQX("DOSE",PSQ)) Q:'PSQ  S QDOSE=PSQ S:'$G(PSOQX("DOSE ORDERED",PSQ)) PSQQUIT=1
"RTN","PSOSIG",50,0)
 I '$G(PSOCPRQT) Q:PSQQUIT
"RTN","PSOSIG",51,0)
 Q:'$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",52,0)
 Q:'$G(QDOSE)
"RTN","PSOSIG",53,0)
 G:QDOSE>1 COMP
"RTN","PSOSIG",54,0)
 Q:'$G(PSOQX("DOSE ORDERED",1))
"RTN","PSOSIG",55,0)
 Q:'$G(PSOQX("DAYS SUPPLY"))&('$G(PSOQX("DURATION",1)))
"RTN","PSOSIG",56,0)
 S PSOLOWER=0
"RTN","PSOSIG",57,0)
 I $G(PSOQX("DURATION",1)) D
"RTN","PSOSIG",58,0)
 .S PSOLOWX=$L(PSOQX("DURATION",1))
"RTN","PSOSIG",59,0)
 .S PSOLOWXL=$S($E(PSOQX("DURATION",1),PSOLOWX)="M":1,$E(PSOQX("DURATION",1),PSOLOWX)="H":60,$E(PSOQX("DURATION",1),PSOLOWX)="S":.01666,$E(PSOQX("DURATION",1),PSOLOWX)="W":10080,$E(PSOQX("DURATION",1),PSOLOWX)="L":43200,1:1440)
"RTN","PSOSIG",60,0)
 .S PSOLOWER=PSOLOWXL*(+$G(PSOQX("DURATION",1)))
"RTN","PSOSIG",61,0)
 S PSOLOWX=0 I +$G(PSOQX("DAYS SUPPLY")) S PSOLOWX=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",62,0)
 Q:'$G(PSOLOWER)&('$G(PSOLOWX))
"RTN","PSOSIG",63,0)
 S QTSH=$G(PSOQX("SCHEDULE",1)) D QTS Q:PSQQUIT!('$G(PSOFRQ))
"RTN","PSOSIG",64,0)
 S PSOLOWST=$S('$G(PSOLOWER):$G(PSOLOWX),'$G(PSOLOWX):$G(PSOLOWER),$G(PSOLOWER)>$G(PSOLOWX):$G(PSOLOWX),$G(PSOLOWX)>$G(PSOLOWER):$G(PSOLOWER),$G(PSOLOWX)=$G(PSOLOWER):$G(PSOLOWER),1:0)
"RTN","PSOSIG",65,0)
 Q:'$G(PSOLOWST)
"RTN","PSOSIG",66,0)
 S PSQMIN=+$G(PSOLOWST)
"RTN","PSOSIG",67,0)
 S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIG",68,0)
 S PSOQRND=PSQMINZ*+$G(PSOQX("DOSE ORDERED",1)) Q:'PSOQRND
"RTN","PSOSIG",69,0)
 ;If DAYS SUPPLY was edited by Pharmacy and previous quantity was calculated, don't calculate/update quantity automatically
"RTN","PSOSIG",70,0)
 I $G(PSODSEDT),'$$UPDQTY(PSOQRND+.9999\1) Q
"RTN","PSOSIG",71,0)
 ;If DISPENSE DRUG was edited in Pharmacy and SIG contains "PRN" on a CS Order, don't calculate/update quantity automatically
"RTN","PSOSIG",72,0)
 S PSORXDRG=$S($G(PSORXIEN):$P($G(PSORXED("RX0")),"^",6),1:$P($G(OR0),"^",9))
"RTN","PSOSIG",73,0)
 I $D(PSORXIEN),PSORXDRG,PSORXDRG'=+$G(PSODRUG("IEN")),$G(QTYHLD),$$CSDS^PSOSIGDS(+$G(PSODRUG("IEN"))),$$PRN() D  Q
"RTN","PSOSIG",74,0)
 . W !!,"The Quantity (",$G(QTYHLD),") has not been changed."
"RTN","PSOSIG",75,0)
 . W !,"Please review and update it if necessary.",!,$C(7)
"RTN","PSOSIG",76,0)
 . N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOSIG",77,0)
 D ROUND G QEND
"RTN","PSOSIG",78,0)
 Q
"RTN","PSOSIG",79,0)
COMP ;COMPLEX DOSE HERE
"RTN","PSOSIG",80,0)
 N PSOQEXC,PSOQAND,PSOQTHEN,PSQL,PSQMNL,PSQMNLX,PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSQ1,PSODUX,PSODUXX,PSODSMIN
"RTN","PSOSIG",81,0)
 ;PSODUTOT = TOTAL OF ALL DURATIONS
"RTN","PSOSIG",82,0)
 ;PSODUDIF = DIFF. OF DURATION VS DAYS SUPPLY
"RTN","PSOSIG",83,0)
 ;PSODUMIS = # OF SEQUENCES MISSING A DURATION IF >1 CAN'T DEFAULT
"RTN","PSOSIG",84,0)
 ;PSODUREP = SEQUENCE # THAT IS MISSING DURATION
"RTN","PSOSIG",85,0)
 ;PSODSMIN = MINUTES OF DAYS SUPPLY
"RTN","PSOSIG",86,0)
 S (PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSODSMIN,PSOQAND,PSOQTHEN,PSOQEXC)=0
"RTN","PSOSIG",87,0)
 F PSQL=1:1:QDOSE S:$G(PSOQX("CONJUNCTION",PSQL))["A" PSOQAND=1 S:$G(PSOQX("CONJUNCTION",PSQL))["T" PSOQTHEN=1 S:$G(PSOQX("CONJUNCTION",PSQL))["X" PSOQEXC=1
"RTN","PSOSIG",88,0)
 I $G(PSOQEXC) G QEND
"RTN","PSOSIG",89,0)
 I $G(PSOQAND) G COMP^PSOSIGCX
"RTN","PSOSIG",90,0)
 F PSQ1=1:1:QDOSE D  Q:PSODUMIS>1
"RTN","PSOSIG",91,0)
 .I '$G(PSOQX("DURATION",PSQ1)) S PSODUMIS=PSODUMIS+1,PSODUREP=PSQ1 Q
"RTN","PSOSIG",92,0)
 .S PSODUX=$L(PSOQX("DURATION",PSQ1))
"RTN","PSOSIG",93,0)
 .S PSODUXX=$S($E(PSOQX("DURATION",PSQ1),PSODUX)="M":1,$E(PSOQX("DURATION",PSQ1),PSODUX)="H":60,$E(PSOQX("DURATION",PSQ1),PSODUX)="S":.01666,$E(PSOQX("DURATION",PSQ1),PSODUX)="W":10080,$E(PSOQX("DURATION",PSQ1),PSODUX)="L":43200,1:1440)
"RTN","PSOSIG",94,0)
 .S PSODUTOT=PSODUTOT+(PSODUXX*(+$G(PSOQX("DURATION",PSQ1))))
"RTN","PSOSIG",95,0)
 G:PSODUMIS>1 QEND ; More than 1 sequence missing a duration
"RTN","PSOSIG",96,0)
 I $G(PSODUMIS),'$G(PSOQX("DAYS SUPPLY")) G QEND ; missing 1 duration, no days supply
"RTN","PSOSIG",97,0)
 S PSODSMIN=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",98,0)
 I $G(PSODSMIN),$G(PSODSMIN)<$G(PSODUTOT) G QEND
"RTN","PSOSIG",99,0)
 I '$G(PSODUMIS),$G(PSODSMIN),$G(PSODUTOT)>$G(PSODSMIN) G QEND ; no missing durations, but total durations are greater than days supply
"RTN","PSOSIG",100,0)
 I $G(PSODUMIS),$G(PSODSMIN),$G(PSODSMIN)'>$G(PSODUTOT) G QEND ; 1 missing duration, and total of other durations are not less than days supply
"RTN","PSOSIG",101,0)
 I '$G(PSODSMIN),$G(PSODUMIS) G QEND ; no days supply, missing a duration
"RTN","PSOSIG",102,0)
 I $G(PSODUREP) S PSODUDIF=$G(PSODSMIN)-$G(PSODUTOT)
"RTN","PSOSIG",103,0)
 F PSQ=1:1:QDOSE D  Q:$G(PSQQUIT)
"RTN","PSOSIG",104,0)
 .I '$G(PSOQX("DOSE ORDERED",PSQ))!($G(PSOQX("SCHEDULE",PSQ))="") S PSQQUIT=1 Q
"RTN","PSOSIG",105,0)
 .S QTSH=$G(PSOQX("SCHEDULE",PSQ)) D QTS S:'$G(PSOFRQ) PSQQUIT=1 Q:$G(PSQQUIT)
"RTN","PSOSIG",106,0)
 .I $G(PSOQX("DURATION",PSQ)) S PSQMNL=$L(PSOQX("DURATION",PSQ)) D
"RTN","PSOSIG",107,0)
 ..S PSQMNLX=$S($E(PSOQX("DURATION",PSQ),PSQMNL)="M":1,$E(PSOQX("DURATION",PSQ),PSQMNL)="H":60,$E(PSOQX("DURATION",PSQ),PSQMNL)="S":.01666,$E(PSOQX("DURATION",PSQ),PSQMNL)="W":10080,$E(PSOQX("DURATION",PSQ),PSQMNL)="L":43200,1:1440)
"RTN","PSOSIG",108,0)
 ..S PSQMIN=PSQMNLX*(+$G(PSOQX("DURATION",PSQ)))
"RTN","PSOSIG",109,0)
 .I '$G(PSOQX("DURATION",PSQ)) S PSQMIN=$G(PSODUDIF)
"RTN","PSOSIG",110,0)
 .S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIG",111,0)
 .S PSOQRND=$S('$G(PSOQRND):PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ)),1:$G(PSOQRND)+(PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ))))
"RTN","PSOSIG",112,0)
 I $G(PSQQUIT) G QEND
"RTN","PSOSIG",113,0)
 ;If DAYS SUPPLY was edited by Pharmacy, don't re-calculate QTY automatically for Digitally Signed Pending Orders
"RTN","PSOSIG",114,0)
 I $G(PSODSEDT),$G(QTYHLD),$G(PSOFDR),$P($G(OR0),"^",24) D  Q
"RTN","PSOSIG",115,0)
 . W !!,"The Quantity (",QTYHLD,") has not been changed."
"RTN","PSOSIG",116,0)
 . W !,"Please review and update it if necessary.",!,$C(7)
"RTN","PSOSIG",117,0)
 . N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOSIG",118,0)
 I $G(PSOQRND) D ROUND
"RTN","PSOSIG",119,0)
 G QEND
"RTN","PSOSIG",120,0)
QTS ;*282 Preserve Old Functionality
"RTN","PSOSIG",121,0)
 S PSOFRQ=$$QTSCH(QTSH)
"RTN","PSOSIG",122,0)
 I '$G(PSOFRQ) S PSQQUIT=1
"RTN","PSOSIG",123,0)
 Q
"RTN","PSOSIG",124,0)
 ;
"RTN","PSOSIG",125,0)
QTSCH(QTSH) ; 
"RTN","PSOSIG",126,0)
 ; Return Frequency for Schedule QTSH
"RTN","PSOSIG",127,0)
 ; Otherwise return ""
"RTN","PSOSIG",128,0)
 N PSOFRQ,SPCT,FOUND
"RTN","PSOSIG",129,0)
 Q:$G(QTSH)="" ""
"RTN","PSOSIG",130,0)
 Q:$E(QTSH,1)=" " ""
"RTN","PSOSIG",131,0)
 S QTSH=$$UPPER(QTSH)
"RTN","PSOSIG",132,0)
 S SPCT=1,PSOFRQ=0 F I=1:1:$L(QTSH) I $E(QTSH,I)=" " S SPCT=SPCT+1
"RTN","PSOSIG",133,0)
 F I=0:1:SPCT-1 S SCHTMP=$P(QTSH," ",1,SPCT-I) Q:PSOFRQ  D
"RTN","PSOSIG",134,0)
 . F II=0:0 S II=$O(^PS(51.1,"APPSJ",SCHTMP,II)) Q:'II!PSOFRQ  S PSOFRQ=$P(^PS(51.1,II,0),"^",3)
"RTN","PSOSIG",135,0)
 Q:PSOFRQ PSOFRQ
"RTN","PSOSIG",136,0)
  F I=0:1:SPCT-1 S SCHTMP=$P(QTSH," ",1,SPCT-I) Q:PSOFRQ  D
"RTN","PSOSIG",137,0)
 . F II=0:0 S II=$O(^PS(51,"B",SCHTMP,II)) Q:'II!PSOFRQ  I $P(^PS(51,II,0),"^",4)<2 S PSOFRQ=$P(^PS(51,II,0),"^",8)
"RTN","PSOSIG",138,0)
 Q:PSOFRQ PSOFRQ
"RTN","PSOSIG",139,0)
 Q ""
"RTN","PSOSIG",140,0)
 ;
"RTN","PSOSIG",141,0)
QEND ;
"RTN","PSOSIG",142,0)
 ; PSOMTFLG variable indicates a Maintenance Rx (Titration/Maintenance)
"RTN","PSOSIG",143,0)
 K PSOFRQ
"RTN","PSOSIG",144,0)
 I $G(PSOOUTQT),$G(QTYHLD),$G(PSOQX("QTY")),$G(QTYHLD)'=$G(PSOQX("QTY")) W !!,"Quantity has been changed from "_QTYHLD_" to "_PSOQX("QTY") D  I '$G(PSOMTFLG) W ! N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOSIG",145,0)
 .I $G(PSONEW("FLD"))=8,$P($G(OR0),"^",24),$G(PSODRUG("IEN")),$D(^PSDRUG(+$G(PSODRUG("IEN")),0)) D
"RTN","PSOSIG",146,0)
 ..I $P(^PSDRUG(PSODRUG("IEN"),0),"^",3)[2!($P(^PSDRUG(PSODRUG("IEN"),0),"^",3)["F") Q
"RTN","PSOSIG",147,0)
 ..N ZRFA S ZRFA=$S($G(CLOZPAT)=2&(PSOQX("DAYS SUPPLY")=14):1,$G(CLOZPAT)=2&(PSOQX("DAYS SUPPLY")=7):3,$G(CLOZPAT)=1&(PSOQX("DAYS SUPPLY")=7):1,$D(CLOZPAT):0,1:5)
"RTN","PSOSIG",148,0)
 ..N ZREF,ZTQ S ZREF=QTYHLD\PSOQX("QTY") I ZREF>0 D
"RTN","PSOSIG",149,0)
 ...S ZTQ=QTYHLD*(PSOQX("# OF REFILLS")+1),ZTQ=ZTQ-PSOQX("QTY"),ZREF=ZTQ\PSOQX("QTY") S:ZREF>ZRFA ZREF=ZRFA
"RTN","PSOSIG",150,0)
 ...I ZREF'=PSOQX("# OF REFILLS") W !,"# of Refills has been changed from "_PSOQX("# OF REFILLS")_" to "_ZREF S PSOQX("# OF REFILLS")=ZREF
"RTN","PSOSIG",151,0)
 Q
"RTN","PSOSIG",152,0)
ROUND ;
"RTN","PSOSIG",153,0)
 Q:'$G(PSOQRND)
"RTN","PSOSIG",154,0)
 I PSOQRND'["." S PSOQX("QTY")=PSOQRND Q
"RTN","PSOSIG",155,0)
 S PSOQX("QTY")=$P(PSOQRND,".")+1
"RTN","PSOSIG",156,0)
 Q
"RTN","PSOSIG",157,0)
DAY(DATE) ;First 5 digits of FileMan date
"RTN","PSOSIG",158,0)
 N X
"RTN","PSOSIG",159,0)
 I DATE'?5N Q -1
"RTN","PSOSIG",160,0)
 S X=$E(DATE,4,5) I X<1!(X>12) Q -1
"RTN","PSOSIG",161,0)
 S X=DATE+1+(X=12*88)_"01"
"RTN","PSOSIG",162,0)
 Q $E($$FMADD^XLFDT(X,-1),6,7)
"RTN","PSOSIG",163,0)
 ;
"RTN","PSOSIG",164,0)
QTYX(PSOQX) ;
"RTN","PSOSIG",165,0)
 N PSOQLP,PSOQLN,PSOQAR,PSOCPRQT,QDOSE,QDOSEX S PSOCPRQT=1 F PSOQLP=0:0 S PSOQLP=$O(PSOQX("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIG",166,0)
 .S PSOQAR("DURATION",PSOQLP)=$G(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIG",167,0)
 .I $E(PSOQX("DURATION",PSOQLP))?1A S PSOQLN=$L(PSOQX("DURATION",PSOQLP)) S PSOQX("DURATION",PSOQLP)=$E(PSOQX("DURATION",PSOQLP),2,PSOQLN)_$E(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIG",168,0)
 S QDOSE=0 F QDOSEX=0:0 S QDOSEX=$O(PSOQX("DOSE ORDERED",QDOSEX)) Q:'QDOSEX  S QDOSE=QDOSE+1
"RTN","PSOSIG",169,0)
 I '$G(PSOQX("QTY")) D QTYCP G QPASS
"RTN","PSOSIG",170,0)
 D QTYCP^PSOSIGDS
"RTN","PSOSIG",171,0)
QPASS F PSOQLP=0:0 S PSOQLP=$O(PSOQAR("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIG",172,0)
 .S PSOQX("DURATION",PSOQLP)=$G(PSOQAR("DURATION",PSOQLP))
"RTN","PSOSIG",173,0)
 K PSOCPRQT
"RTN","PSOSIG",174,0)
 Q
"RTN","PSOSIG",175,0)
DAYS(PSOQX) ;Entry point for Days Supply calc for PSO
"RTN","PSOSIG",176,0)
 ;Kill days supply here
"RTN","PSOSIG",177,0)
 Q:'$G(PSOQX("QTY"))
"RTN","PSOSIG",178,0)
 D QTYOPS^PSOSIGDS
"RTN","PSOSIG",179,0)
 Q
"RTN","PSOSIG",180,0)
 ;
"RTN","PSOSIG",181,0)
UPDQTY(NEWQTY) ; If DAYS SUPPLY is being edited and previous QTY was not calculated, don't calculate and update QTY
"RTN","PSOSIG",182,0)
 ; Also, if digitally signed, do not automatically calculate and update quantity if QTY increases
"RTN","PSOSIG",183,0)
 ; Input: NEWQTY - Newly Calculated Quantity
"RTN","PSOSIG",184,0)
 ;Output: 1: YES - Update Rx with re-calculated QTY / 0: NO - Don't update Rx with re-calculated QTY
"RTN","PSOSIG",185,0)
 N UPDQTY,PSOFREQ,PSOOLDDS,PSONEWDS,PSOOLDQT,PSODOSOR,PSODUR
"RTN","PSOSIG",186,0)
 S UPDQTY=1 I 'NEWQTY Q UPDQTY
"RTN","PSOSIG",187,0)
 S PSOOLDDS=$G(PSOQX("OLD DAYS SUPPLY")) I 'PSOOLDDS Q UPDQTY ; DAYS SUPPLY value prior to edit
"RTN","PSOSIG",188,0)
 S PSONEWDS=$G(PSOQX("DAYS SUPPLY")) I 'PSONEWDS Q UPDQTY ; New DAYS SUPPLY value
"RTN","PSOSIG",189,0)
 S PSOOLDQT=$G(QTYHLD) I 'PSOOLDQT Q UPDQTY ; QTY on file, possibly calculated
"RTN","PSOSIG",190,0)
 S PSOFREQ=$$SCHFREQ(),PSODOSOR=$G(PSOQX("DOSE ORDERED",1))
"RTN","PSOSIG",191,0)
 S PSODUR=$G(PSOQX("DURATION",1)) I PSODUR,PSODUR<PSOOLDDS S PSOOLDDS=PSODUR
"RTN","PSOSIG",192,0)
 ;
"RTN","PSOSIG",193,0)
 ;Checking whether current QTY was previously calculated, if not don't update with new QTY
"RTN","PSOSIG",194,0)
 I (PSODOSOR<1)!(PSOFREQ>1440) D
"RTN","PSOSIG",195,0)
 . ;Different calculation for doses of less than one QTY (e.g., 1/2 tablet) OR frequency less than every 24hrs (e.g., every 72hrs)
"RTN","PSOSIG",196,0)
 . I PSOFREQ,(((PSOOLDDS*(1440/PSOFREQ))*PSODOSOR)+.9\1)'=PSOOLDQT S UPDQTY=0
"RTN","PSOSIG",197,0)
 E  D
"RTN","PSOSIG",198,0)
 . ;Checking whether current QTY was previously calculated
"RTN","PSOSIG",199,0)
 . I ((NEWQTY/PSONEWDS)'=(PSOOLDQT/PSOOLDDS)) S UPDQTY=0
"RTN","PSOSIG",200,0)
 ;
"RTN","PSOSIG",201,0)
 ;QTY is increasing for a CS Rx/Order, so don't update with new QTY
"RTN","PSOSIG",202,0)
 I ($G(PSOFDR)&$P($G(OR0),"^",24)&(NEWQTY>PSOOLDQT)) S UPDQTY=0
"RTN","PSOSIG",203,0)
 ;
"RTN","PSOSIG",204,0)
 I 'UPDQTY D
"RTN","PSOSIG",205,0)
 . W !!,"The Quantity (",PSOOLDQT,") has not been changed."
"RTN","PSOSIG",206,0)
 . W !,"Please review and update it if necessary.",!,$C(7)
"RTN","PSOSIG",207,0)
 . N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOSIG",208,0)
 Q UPDQTY
"RTN","PSOSIG",209,0)
 ;
"RTN","PSOSIG",210,0)
SCHFREQ() ; Returns the Frequency (in minutes) for the schedule
"RTN","PSOSIG",211,0)
 ; Output: SCHFREQ - Schedule Frequency (in minutes)
"RTN","PSOSIG",212,0)
 N SCHED,SCHEDIEN
"RTN","PSOSIG",213,0)
 S SCHED=$G(PSOQX("SCHEDULE",1)) I SCHED="" Q 0
"RTN","PSOSIG",214,0)
 S SCHEDIEN=$O(^PS(51.1,"B",SCHED,0)) I SCHEDIEN Q $$GET1^DIQ(51.1,SCHEDIEN,2)
"RTN","PSOSIG",215,0)
 S SCHEDIEN=$O(^PS(51,"B",SCHED,0)) I SCHEDIEN Q $$GET1^DIQ(51,SCHEDIEN,31)
"RTN","PSOSIG",216,0)
 Q 0
"RTN","PSOSIG",217,0)
 ;
"RTN","PSOSIG",218,0)
PRN() ; Returns if the Schedule is PRN (1) or not (0)
"RTN","PSOSIG",219,0)
 N PRN,SCH S PRN=0
"RTN","PSOSIG",220,0)
 F SCH=1:1 Q:'$D(PSOQX("SCHEDULE",SCH))  I $G(PSOQX("SCHEDULE",SCH))["PRN" S PRN=1 Q
"RTN","PSOSIG",221,0)
 Q PRN
"RTN","PSOSIG",222,0)
 ;
"RTN","PSOSIG",223,0)
UPPER(PSOSCUP) ;
"RTN","PSOSIG",224,0)
 Q $TR(PSOSCUP,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"VER")
8.0^22.2
"BLD",10789,6)
^438
**END**
**END**

