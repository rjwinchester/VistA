Released PSO*7*519 SEQ #428
Extracted from mail message
**KIDS**:PSO*7.0*519^

**INSTALL NAME**
PSO*7.0*519
"BLD",10821,0)
PSO*7.0*519^OUTPATIENT PHARMACY^0^3180329^y
"BLD",10821,1,0)
^^4^4^3180329^
"BLD",10821,1,1,0)
This patch will resolve the following issues.
"BLD",10821,1,2,0)
 
"BLD",10821,1,3,0)
1. I18715588FY18 - Undefined error when ^ out of prompt
"BLD",10821,1,4,0)
2. INC0023405 - Set prompt default to NO instead of YES
"BLD",10821,4,0)
^9.64PA^^
"BLD",10821,6.3)
5
"BLD",10821,"KRN",0)
^9.67PA^779.2^20
"BLD",10821,"KRN",.4,0)
.4
"BLD",10821,"KRN",.401,0)
.401
"BLD",10821,"KRN",.402,0)
.402
"BLD",10821,"KRN",.403,0)
.403
"BLD",10821,"KRN",.5,0)
.5
"BLD",10821,"KRN",.84,0)
.84
"BLD",10821,"KRN",3.6,0)
3.6
"BLD",10821,"KRN",3.8,0)
3.8
"BLD",10821,"KRN",9.2,0)
9.2
"BLD",10821,"KRN",9.2,"NM",0)
^9.68A^^
"BLD",10821,"KRN",9.8,0)
9.8
"BLD",10821,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",10821,"KRN",9.8,"NM",1,0)
PSORRX1^^0^B158317306
"BLD",10821,"KRN",9.8,"NM",2,0)
PSORX1^^0^B83629863
"BLD",10821,"KRN",9.8,"NM","B","PSORRX1",1)

"BLD",10821,"KRN",9.8,"NM","B","PSORX1",2)

"BLD",10821,"KRN",19,0)
19
"BLD",10821,"KRN",19.1,0)
19.1
"BLD",10821,"KRN",101,0)
101
"BLD",10821,"KRN",409.61,0)
409.61
"BLD",10821,"KRN",771,0)
771
"BLD",10821,"KRN",779.2,0)
779.2
"BLD",10821,"KRN",870,0)
870
"BLD",10821,"KRN",8989.51,0)
8989.51
"BLD",10821,"KRN",8989.52,0)
8989.52
"BLD",10821,"KRN",8994,0)
8994
"BLD",10821,"KRN","B",.4,.4)

"BLD",10821,"KRN","B",.401,.401)

"BLD",10821,"KRN","B",.402,.402)

"BLD",10821,"KRN","B",.403,.403)

"BLD",10821,"KRN","B",.5,.5)

"BLD",10821,"KRN","B",.84,.84)

"BLD",10821,"KRN","B",3.6,3.6)

"BLD",10821,"KRN","B",3.8,3.8)

"BLD",10821,"KRN","B",9.2,9.2)

"BLD",10821,"KRN","B",9.8,9.8)

"BLD",10821,"KRN","B",19,19)

"BLD",10821,"KRN","B",19.1,19.1)

"BLD",10821,"KRN","B",101,101)

"BLD",10821,"KRN","B",409.61,409.61)

"BLD",10821,"KRN","B",771,771)

"BLD",10821,"KRN","B",779.2,779.2)

"BLD",10821,"KRN","B",870,870)

"BLD",10821,"KRN","B",8989.51,8989.51)

"BLD",10821,"KRN","B",8989.52,8989.52)

"BLD",10821,"KRN","B",8994,8994)

"BLD",10821,"QDEF")
^^^^NO^^^^^^NO
"BLD",10821,"QUES",0)
^9.62^^
"BLD",10821,"REQB",0)
^9.611^2^2
"BLD",10821,"REQB",1,0)
PSO*7.0*509^2
"BLD",10821,"REQB",2,0)
PSO*7.0*497^2
"BLD",10821,"REQB","B","PSO*7.0*497",2)

"BLD",10821,"REQB","B","PSO*7.0*509",1)

"MBREQ")
0
"PKG",206,-1)
1^1
"PKG",206,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",206,20,0)
^9.402P^^
"PKG",206,22,0)
^9.49I^1^1
"PKG",206,22,1,0)
7.0^3021122^3021202^66481
"PKG",206,22,1,"PAH",1,0)
519^3180329
"PKG",206,22,1,"PAH",1,1,0)
^^4^4^3180329
"PKG",206,22,1,"PAH",1,1,1,0)
This patch will resolve the following issues.
"PKG",206,22,1,"PAH",1,1,2,0)
 
"PKG",206,22,1,"PAH",1,1,3,0)
1. I18715588FY18 - Undefined error when ^ out of prompt
"PKG",206,22,1,"PAH",1,1,4,0)
2. INC0023405 - Set prompt default to NO instead of YES
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSORRX1")
0^1^B158317306^B156896201
"RTN","PSORRX1",1,0)
PSORRX1 ;AITC/BWF - Remote RX driver ;8/30/16 12:00am
"RTN","PSORRX1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**454,499,509,519**;DEC 1997;Build 5
"RTN","PSORRX1",3,0)
 ;
"RTN","PSORRX1",4,0)
 ;Reference ^PSDRUG( supported by DBIA 221
"RTN","PSORRX1",5,0)
 Q
"RTN","PSORRX1",6,0)
 ;
"RTN","PSORRX1",7,0)
REMOTERX(DFN,PSOSITE) ;
"RTN","PSORRX1",8,0)
 N RXRES,MSG,HLARR,CNT,RXDAT,HLARR,HLPROT,DONE,ORFS,ORCS,ORRS,ORES,ORSS,ORQUIT,HLQUIT,HLDAT,TFLIST,HLP,HLNODE,HLNEXT,HLINSTN
"RTN","PSORRX1",9,0)
 N PID1,PID4,PID5,PID6,TFDAT,LOOP,RXMSG,PSORRDAT,PSOHCNT,ERR,HL,PSORRDAT,ORERR,SITE
"RTN","PSORRX1",10,0)
 S HLARR=$NA(^TMP("HLS",$J)) K @HLARR
"RTN","PSORRX1",11,0)
 S HLDAT=$NA(^XTMP("PSORRX1",$J)) K @HLDAT
"RTN","PSORRX1",12,0)
 ; moved to PSORX1
"RTN","PSORRX1",13,0)
 ;I '$$GET1^DIQ(59,PSOSITE,3001,"I") D  Q
"RTN","PSORRX1",14,0)
 ;.W !!,"The OneVA Pharmacy flag is turned off. Queries will NOT"
"RTN","PSORRX1",15,0)
 ;.W !,"be made to other VA Pharmacy locations.",!
"RTN","PSORRX1",16,0)
 ; possibly add error message to be returned if no DFN.
"RTN","PSORRX1",17,0)
 I 'DFN Q
"RTN","PSORRX1",18,0)
 S SITE=$P($$SITE^VASITE(),U)
"RTN","PSORRX1",19,0)
 S TFSTRING=$$GET1^DIQ(2,DFN,991.01,"I")_"^^^USVHA^NI^"_SITE
"RTN","PSORRX1",20,0)
 S HLPROT="PSO REMOTE RX QBP-Q13 EVENT"
"RTN","PSORRX1",21,0)
 D INIT^HLFNC2(HLPROT,.HL)
"RTN","PSORRX1",22,0)
 D BLDPID^PSOTPHL2(DFN,"",.PSORRDAT,.HL,.ERR)
"RTN","PSORRX1",23,0)
 I $D(ERR) W !,"There was a problem creating the PID segment for this patient.",!,"Please contact technical support.",!
"RTN","PSORRX1",24,0)
 S @HLARR@(1)="QPD^Q13~Active Prescriptions~HL70471^"
"RTN","PSORRX1",25,0)
 S DONE=0
"RTN","PSORRX1",26,0)
 F PSOHCNT=1:1 D  Q:DONE
"RTN","PSORRX1",27,0)
 .I '$D(PSORRDAT(PSOHCNT)) S DONE=1 Q
"RTN","PSORRX1",28,0)
 .S @HLARR@(2)=$G(@HLARR@(2))_PSORRDAT(PSOHCNT)
"RTN","PSORRX1",29,0)
 S @HLARR@(3)="RCP^I"
"RTN","PSORRX1",30,0)
 S HLP("SUBSCRIBER")="^^^^200HD~HDR.DOMAIN.EXT~DNS"
"RTN","PSORRX1",31,0)
 D DIRECT^HLMA(HLPROT,"GM",1,.RXDAT,"",.HLP)
"RTN","PSORRX1",32,0)
 S ORFS=$G(HL("FS")),ORCS=$E($G(HL("ECH")),1),ORRS=$E($G(HL("ECH")),2),ORES=$E($G(HL("ECH")),3),ORSS=$E($G(HL("ECH")),4)
"RTN","PSORRX1",33,0)
 S HLQUIT=0,ORQUIT="",ORERR=""
"RTN","PSORRX1",34,0)
 I $P(RXDAT,U,3)="No response"!($P(RXDAT,U,3)="Connection Failed") D  Q
"RTN","PSORRX1",35,0)
 .W !,"The system is down or not responding.",!,"Could not query prescriptions at other VA Pharmacy locations.",!
"RTN","PSORRX1",36,0)
 .K DIR S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR
"RTN","PSORRX1",37,0)
 F  X HLNEXT Q:HLQUIT'>0!(ORQUIT'="")  D
"RTN","PSORRX1",38,0)
 .N LOOP
"RTN","PSORRX1",39,0)
 .S LOOP=0 F  S LOOP=$O(HLNODE(LOOP)) Q:LOOP=""  S HLNODE=HLNODE_HLNODE(LOOP)
"RTN","PSORRX1",40,0)
 .I $E(HLNODE,1,3)="MSA"&(($P(HLNODE,ORFS,2)'="CA")) D LOGERR(DFN,.HLNODE,.HLDAT,$P(HLNODE,ORFS,4)) S ORQUIT=$P(HLNODE,ORFS,4)
"RTN","PSORRX1",41,0)
 .I $E(HLNODE,1,3)="ERR" D LOGERR(DFN,.HLNODE,.HLDAT) S ORQUIT=$P(HLNODE,ORFS,4)
"RTN","PSORRX1",42,0)
 .I $E(HLNODE,1,3)="RDT" D
"RTN","PSORRX1",43,0)
 ..S @HLDAT@(0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_U_$$NOW^XLFDT
"RTN","PSORRX1",44,0)
 ..D RXPRSE(DFN,.HLNODE,.HLDAT)
"RTN","PSORRX1",45,0)
 Q
"RTN","PSORRX1",46,0)
LOGERR(DFN,DATA,HLDAT,NMSG) ;
"RTN","PSORRX1",47,0)
 N HLERR
"RTN","PSORRX1",48,0)
 S NMSG=$G(NMSG,"")
"RTN","PSORRX1",49,0)
 S HLERR=$S(NMSG'="":NMSG,1:$P(DATA,ORFS,9))
"RTN","PSORRX1",50,0)
 S:'$D(@HLDAT@(0)) @HLDAT@(0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_U_$$NOW^XLFDT
"RTN","PSORRX1",51,0)
 S @HLDAT@(DFN,"ERR")="<"_HLERR_">"
"RTN","PSORRX1",52,0)
 W !!,"When trying to query prescriptions at other VA Pharmacy",!,"Locations the following message was encountered:",!,"***",!,HLERR,!,"***",! K DIR S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",53,0)
 Q
"RTN","PSORRX1",54,0)
 ; parse rx data from RDF segment
"RTN","PSORRX1",55,0)
RXPRSE(DFN,DATA,HLDAT) ;
"RTN","PSORRX1",56,0)
 ;RDF|14|Site Number~Rx Number~Drug Name~Quantity~Refills~Days Supply~Expiration Date
"RTN","PSORRX1",57,0)
 ;~Issue Date~Stop Date~Last Fill Date~Sig~Detail~Status~VA Product ID
"RTN","PSORRX1",58,0)
 N RXSITE,RXNUM,DNAME,QTY,REFILLS,DSUPP,EXPDT,ISSDATE,STOPDT,LFDT,SIG,DETAIL,STAT,STATNM,STATERR,DDONE,I,VAPID,VAFQDN,DAT
"RTN","PSORRX1",59,0)
 ; put data into one variable. This handles overflow nodes
"RTN","PSORRX1",60,0)
 S DAT=0 F  S DAT=$O(DATA(DAT)) Q:'DAT  D
"RTN","PSORRX1",61,0)
 .S DATA=$G(DATA)_$G(DATA(DAT))
"RTN","PSORRX1",62,0)
 S RXSITE=$P(DATA,ORFS,2),RXNUM=$P(DATA,ORFS,3),DNAME=$P(DATA,ORFS,4),QTY=$P(DATA,ORFS,5)
"RTN","PSORRX1",63,0)
 Q:DNAME=""
"RTN","PSORRX1",64,0)
 S REFILLS=$P(DATA,ORFS,6),DSUPP=$P(DATA,ORFS,7),EXPDT=$P(DATA,ORFS,8),ISSDATE=$P(DATA,ORFS,9)
"RTN","PSORRX1",65,0)
 S STOPDT=$P(DATA,ORFS,10),LFDT=$P(DATA,ORFS,11),SIG=$P(DATA,ORFS,12),DETAIL=$P(DATA,ORFS,13)
"RTN","PSORRX1",66,0)
 S STAT=$P(DATA,ORFS,14) Q:STAT=""
"RTN","PSORRX1",67,0)
 ; VA Product ID
"RTN","PSORRX1",68,0)
 S VAPID=$P(DATA,ORFS,15)
"RTN","PSORRX1",69,0)
 S VAFQDN=$P(DATA,ORFS,16)
"RTN","PSORRX1",70,0)
 Q:STAT=""
"RTN","PSORRX1",71,0)
 Q:'RXSITE!('RXNUM)
"RTN","PSORRX1",72,0)
 S @HLDAT@(DFN,RXSITE,STAT,DNAME,0)=RXNUM_U_QTY_U_REFILLS_U_DSUPP_U_EXPDT_U_ISSDATE_U_STOPDT_U_LFDT_U_STAT_U_VAPID_U_DNAME_U_VAFQDN
"RTN","PSORRX1",73,0)
 S @HLDAT@(DFN,RXSITE,STAT,DNAME,"SIG")=SIG
"RTN","PSORRX1",74,0)
 S @HLDAT@(DFN,RXSITE,STAT,DNAME,"DETAIL")=DETAIL
"RTN","PSORRX1",75,0)
 Q
"RTN","PSORRX1",76,0)
 ; build and send refill request
"RTN","PSORRX1",77,0)
REFREQ ;
"RTN","PSORRX1",78,0)
 N PHARM,PHONE,LOCSITE,DSUPP,MW,FILLDT,MSG,RXNUM,HLSTR,REMSITE,PHARMLN,PHARMFN,PHARMMI,TFSTRING,HLPROT,LOCDRUG,REMDRUG,DINACT
"RTN","PSORRX1",79,0)
 N ORFS,ORCS,ORRS,ORES,ORSS,HLQUIT,ORQUIT,RESP,RETDFN,VAPID,DONE,PSORRDAT,PSOHCNT,DONE,HL,CSVAL,DIR,REMSIEN,PSOHLNK,PSOLNKDN,DOMOVR,RMSDOM
"RTN","PSORRX1",80,0)
 S HLARR=$NA(^TMP("HLS",$J)) K @HLARR
"RTN","PSORRX1",81,0)
 S HLDAT=$NA(^XTMP("REFREQ^PSORRX1",$J)) K @HLDAT
"RTN","PSORRX1",82,0)
 S HLPROT="PSO REMOTE RX RDS-O13 EVENT"
"RTN","PSORRX1",83,0)
 S MW="W"
"RTN","PSORRX1",84,0)
 D FULL^VALM1
"RTN","PSORRX1",85,0)
 S LOCSITE=$$STA^XUAF4(DUZ(2))
"RTN","PSORRX1",86,0)
 S PHARM=$$GET1^DIQ(200,DUZ,.01,"E"),PHARMLN=$P(PHARM,","),PHARMFN=$P($P(PHARM,",",2)," "),PHARMMI=$P($P(PHARM,",",2)," ",2)
"RTN","PSORRX1",87,0)
 S PHONE=$$GET1^DIQ(200,DUZ,.132,"E")
"RTN","PSORRX1",88,0)
 S RXNUM=$P(PSOLST(ORN),U,2) I 'RXNUM S MSG(1)="Invalid Rx #. Please contact technical support." Q
"RTN","PSORRX1",89,0)
 I SRXSTAT'="ACTIVE" W !!,"Only 'ACTIVE' remote prescriptions may be refilled at this time." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",90,0)
 S REMSITE=$P(PSOLST(ORN),U,4)   ;,REMSIEN=$O(^DIC(4,"D",REMSITE,0))
"RTN","PSORRX1",91,0)
 S REMSIEN=$$FIND1^DIC(4,,"X",REMSITE,"D","I $P(^(0),U,11)=""N"",'$P($G(^(99)),U,4)") Q:'REMSIEN
"RTN","PSORRX1",92,0)
 S PSOREF("DFLG")=""
"RTN","PSORRX1",93,0)
 S REMDRUG=$P(REMDATA,U,11),VAPID=$P(REMDATA,U,10)
"RTN","PSORRX1",94,0)
 I '$L(VAPID) W !!,"Missing VA Product ID. Rx# ",RXNUM," cannot be refilled." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",95,0)
 S LOCDRUG=$$DRUGMTCH(REMDRUG,VAPID)
"RTN","PSORRX1",96,0)
 I $G(LOCDRUG)=-1 Q  ; user entered no so no reason to prompt again
"RTN","PSORRX1",97,0)
 I '$G(LOCDRUG) W !!,"Could not match remote drug to a local drug. Cannot refill Rx# ",RXNUM,"." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",98,0)
 S DINACT=$$GET1^DIQ(50,LOCDRUG,100,"I")
"RTN","PSORRX1",99,0)
 I DINACT>0,DINACT<$$NOW^XLFDT W !!,"Matched Drug "_$$GET1^DIQ(50,LOCDRUG,.01,"E")_" is inactive.",!,"Cannot refill."  S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",100,0)
 ; ****** controlled substance check
"RTN","PSORRX1",101,0)
 S CSVAL=$$GET1^DIQ(50,LOCDRUG,3,"E"),CSVAL=$E(CSVAL,1)
"RTN","PSORRX1",102,0)
 I CSVAL,CSVAL>0,CSVAL<6 W !!,"This is a controlled substance. Cannot refill Rx#",RXNUM,"." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",103,0)
 ;
"RTN","PSORRX1",104,0)
 ; if we got this far, fill is most likely happening and remote
"RTN","PSORRX1",105,0)
 ; worklist needs to be rebuilt when returning so set flag. PSORRBLD
"RTN","PSORRX1",106,0)
 ; was New'ed in calling routine. May change my mind if we get an
"RTN","PSORRX1",107,0)
 ; error from host.
"RTN","PSORRX1",108,0)
 S PSORRBLD=1
"RTN","PSORRX1",109,0)
 ;
"RTN","PSORRX1",110,0)
 S (FILLDT,PSOREF("FILL DATE"))=DT
"RTN","PSORRX1",111,0)
 D INIT^HLFNC2(HLPROT,.HL)
"RTN","PSORRX1",112,0)
 D BLDPID^PSOTPHL2(DFN,"",.PSORRDAT,.HL,.ERR)
"RTN","PSORRX1",113,0)
 S DONE=0
"RTN","PSORRX1",114,0)
 F PSOHCNT=1:1 D  Q:DONE
"RTN","PSORRX1",115,0)
 .I '$D(PSORRDAT(PSOHCNT)) S DONE=1 Q
"RTN","PSORRX1",116,0)
 .S @HLARR@(1)=$G(@HLARR@(1))_PSORRDAT(PSOHCNT)
"RTN","PSORRX1",117,0)
 ;S @HLARR@(2)="ORC^RF^"_RXNUM_"~"_REMSITE_"~"_$$GET1^DIQ(4,REMSIEN,60,"E")_"^^^^^^^"_FILLDT_U_DUZ_"~"_PHARMLN_"~"_PHARMFN_"~"_PHARMMI_"^^^~~~"_LOCSITE_U_PHONE
"RTN","PSORRX1",118,0)
 S @HLARR@(2)="ORC^RF^"_RXNUM_"~"_REMSITE_"~"_$$FQDN^PSORWRAP(,REMSIEN)_"^^^^^^^"_FILLDT_U_DUZ_"~"_PHARMLN_"~"_PHARMFN_"~"_PHARMMI_"^^^~~~"_LOCSITE_U_PHONE
"RTN","PSORRX1",119,0)
 S @HLARR@(3)="RXO^^^^^^^^"_MW_"~~~"_LOCSITE
"RTN","PSORRX1",120,0)
 W !!,"Processing refill request. Please be patient as it may take a moment"
"RTN","PSORRX1",121,0)
 W !,"for the host site to respond and generate your label data..."
"RTN","PSORRX1",122,0)
 ;S PSOHLNK=$O(^HLCS(870,"C",REMSIEN,0))
"RTN","PSORRX1",123,0)
 ;S PSOLNKNM=$$GET1^DIQ(870,PSOHLNK,.01,"E")
"RTN","PSORRX1",124,0)
 ;S RMSDOM=$$GET1^DIQ(870,PSOHLNK,.03,"E")  ; get domain name
"RTN","PSORRX1",125,0)
 ;S RMSDOM=$$GET1^DIQ(4,REMSIEN,60,"E")
"RTN","PSORRX1",126,0)
 ;S:$$PROD^XUPROD() RMSDOM="HL7."_RMSDOM   ; prefix domain name
"RTN","PSORRX1",127,0)
 S RMSDOM=$$FQDN^PSORWRAP(,REMSIEN)
"RTN","PSORRX1",128,0)
 S DOMOVR=REMSITE_"~"_RMSDOM_"~DNS"
"RTN","PSORRX1",129,0)
 S HLP("SUBSCRIBER")="^^^^"_DOMOVR
"RTN","PSORRX1",130,0)
 D DIRECT^HLMA(HLPROT,"GM",1,.RESP,"",.HLP)
"RTN","PSORRX1",131,0)
 D READMSG^PSORRX2(.HLDAT,"RF",LOCDRUG)
"RTN","PSORRX1",132,0)
 K @HLDAT,@HLARR
"RTN","PSORRX1",133,0)
 Q
"RTN","PSORRX1",134,0)
 ; build and send partial fill request
"RTN","PSORRX1",135,0)
PARTIAL() ;
"RTN","PSORRX1",136,0)
 N DIR,DONE,I,PRMPDAT,VAR,PRXNUM,PHARM,PHARMLN,PHARMFN,PHARMMI,PHONE,RXNUM,HLPROT,TFSTRING,HLARR,PHONE,REMSITE,HLDAT,LOCDRUG,EXIT,VAPID,HL,ERR
"RTN","PSORRX1",137,0)
 N PSOHCNT,DONE,PSORRDAT,CSVAL,REMSIEN,PSOHLNK,PSOLNKDN,REMDRUG,Y,DINACT,EXE,DOMOVR,RMSDOM
"RTN","PSORRX1",138,0)
 S HLPROT="PSO REMOTE RX RDS-O13 EVENT"
"RTN","PSORRX1",139,0)
 S HLDAT=$NA(^XTMP("PARTIAL^PSORRX1",$J)) K @HLDAT
"RTN","PSORRX1",140,0)
 S HLARR=$NA(^TMP("HLS",$J)) K @HLARR
"RTN","PSORRX1",141,0)
 D FULL^VALM1
"RTN","PSORRX1",142,0)
 I SRXSTAT'="ACTIVE" W !!,"Only 'ACTIVE' remote prescriptions may be actioned at this time." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",143,0)
 S LOCSITE=$$STA^XUAF4(DUZ(2))
"RTN","PSORRX1",144,0)
 S PHONE=$$GET1^DIQ(200,DUZ,.132,"E")
"RTN","PSORRX1",145,0)
 S PRXNUM=$P(PSOLST(ORN),U,2) I 'PRXNUM S MSG(1)="Invalid Rx #. Please contact technical support." Q
"RTN","PSORRX1",146,0)
 S REMSITE=$P(PSOLST(ORN),U,4)
"RTN","PSORRX1",147,0)
 S REMSIEN=$$FIND1^DIC(4,,"X",REMSITE,"D","I $P(^(0),U,11)=""N"",'$P($G(^(99)),U,4)") Q:'REMSIEN
"RTN","PSORRX1",148,0)
 S DONE=0,CNT=1
"RTN","PSORRX1",149,0)
 ; prompt for fields that would normally be prompted for a local partial fill.
"RTN","PSORRX1",150,0)
 D FULL^VALM1
"RTN","PSORRX1",151,0)
 S REMDRUG=$P(REMDATA,U,11),VAPID=$P(REMDATA,U,10)
"RTN","PSORRX1",152,0)
 I '$L(VAPID) W !!,"Missing VA Product ID. Rx# ",PRXNUM," cannot be refilled." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",153,0)
 S LOCDRUG=$$DRUGMTCH(REMDRUG,VAPID)
"RTN","PSORRX1",154,0)
 I $G(LOCDRUG)=-1 Q  ; user entered no so no reason to prompt again
"RTN","PSORRX1",155,0)
 I '$G(LOCDRUG) W !!,"Could not match remote drug to a local drug.",!,"Cannot complete partial fill for Rx# ",PRXNUM,"." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",156,0)
 S DINACT=$$GET1^DIQ(50,LOCDRUG,100,"I")
"RTN","PSORRX1",157,0)
 I DINACT>0,DINACT<$$NOW^XLFDT W !!,"Matched Drug "_$$GET1^DIQ(50,LOCDRUG,.01,"E")_" is inactive.",!,"Cannot create partial fill request."  S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",158,0)
 ; controlled substance check
"RTN","PSORRX1",159,0)
 S CSVAL=$$GET1^DIQ(50,LOCDRUG,3,"E"),CSVAL=$E(CSVAL,1)
"RTN","PSORRX1",160,0)
 I CSVAL,CSVAL>0,CSVAL<6 W !!,"This is a controlled substance. Cannot refill Rx#",PRXNUM,"." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",161,0)
 S EXIT=0
"RTN","PSORRX1",162,0)
 S PDATE=DT
"RTN","PSORRX1",163,0)
 S MW="W"
"RTN","PSORRX1",164,0)
 F I=1:1 D  Q:DONE!(EXIT)
"RTN","PSORRX1",165,0)
 .S PRMPDAT=$T(PRMPTXT+I)
"RTN","PSORRX1",166,0)
 .S PRMPDAT=$P(PRMPDAT,";;",2)
"RTN","PSORRX1",167,0)
 .I PRMPDAT="Q" S DONE=1 Q
"RTN","PSORRX1",168,0)
 .K DIR
"RTN","PSORRX1",169,0)
 .S DIR(0)=$P(PRMPDAT,"|"),DIR("A")=$P(PRMPDAT,"|",2),VAR=$P(PRMPDAT,"|",4) S:$L($P(PRMPDAT,"|",3)) DIR("B")=$P(PRMPDAT,"|",3)
"RTN","PSORRX1",170,0)
 .I $G(DIR("B"))["~" D
"RTN","PSORRX1",171,0)
 ..S EXE=$TR(DIR("B"),"~","^") X EXE S DIR("B")=DEF
"RTN","PSORRX1",172,0)
 .D ^DIR
"RTN","PSORRX1",173,0)
 .I Y="^" S EXIT=1 Q
"RTN","PSORRX1",174,0)
 .S @VAR=$S($P(DIR(0),"^")["P":$P(Y,U,2),1:Y)  ;*499
"RTN","PSORRX1",175,0)
 K DEF
"RTN","PSORRX1",176,0)
 I EXIT W !,"Cancelling partial fill request.",! K DIR S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",177,0)
 ; if we got this far, fill attempt happening and remote worklist
"RTN","PSORRX1",178,0)
 ; needs to be rebuilt when returning so set flag. PSORRBLD was New'ed
"RTN","PSORRX1",179,0)
 ; in calling routine.  May change my mind if we get an error from
"RTN","PSORRX1",180,0)
 ; host
"RTN","PSORRX1",181,0)
 S PSORRBLD=1
"RTN","PSORRX1",182,0)
 S PHARMLN=$P(PHARM,","),PHARMFN=$P($P(PHARM,",",2)," "),PHARMMI=$P($P(PHARM,",",2)," ",2)
"RTN","PSORRX1",183,0)
 D INIT^HLFNC2(HLPROT,.HL)
"RTN","PSORRX1",184,0)
 D BLDPID^PSOTPHL2(DFN,"",.PSORRDAT,.HL,.ERR)
"RTN","PSORRX1",185,0)
 S DONE=0
"RTN","PSORRX1",186,0)
 F PSOHCNT=1:1 D  Q:DONE
"RTN","PSORRX1",187,0)
 .I '$D(PSORRDAT(PSOHCNT)) S DONE=1 Q
"RTN","PSORRX1",188,0)
 .S @HLARR@(1)=$G(@HLARR@(1))_PSORRDAT(PSOHCNT)
"RTN","PSORRX1",189,0)
 ;S @HLARR@(2)="ORC^PF^"_PRXNUM_"~"_REMSITE_"~"_$$GET1^DIQ(4,REMSIEN,60,"E")_"^^^^^^^"_PDATE_"^"_DUZ_"~"_PHARMLN_"~"_PHARMFN_"~"_PHARMMI_"^^^~~~"_LOCSITE_U_PHONE
"RTN","PSORRX1",190,0)
 S @HLARR@(2)="ORC^PF^"_PRXNUM_"~"_REMSITE_"~"_$$FQDN^PSORWRAP(,REMSIEN)_"^^^^^^^"_PDATE_"^"_DUZ_"~"_PHARMLN_"~"_PHARMFN_"~"_PHARMMI_"^^^~~~"_LOCSITE_U_PHONE
"RTN","PSORRX1",191,0)
 S @HLARR@(3)="RXO^1^"_QTY_"^^^^^^"_MW_"~~~"_LOCSITE_"^^^"_DSUPP
"RTN","PSORRX1",192,0)
 S @HLARR@(4)="NTE^1^L^"_REMARKS
"RTN","PSORRX1",193,0)
 W !!,"Processing partial fill request. Please be patient as it may take a moment"
"RTN","PSORRX1",194,0)
 W !,"for the host site to respond and generate your label data...",!
"RTN","PSORRX1",195,0)
 ;S RMSDOM=$$GET1^DIQ(4,REMSIEN,60,"E")
"RTN","PSORRX1",196,0)
 ;S PSOHLNK=$O(^HLCS(870,"C",REMSIEN,0)) ; get first entry (should only be one but you never know)
"RTN","PSORRX1",197,0)
 ;S RMSDOM=$$GET1^DIQ(870,PSOHLNK,.03,"E")  ; get domain name
"RTN","PSORRX1",198,0)
 ;S:$$PROD^XUPROD() RMSDOM="HL7."_RMSDOM   ; prefix domain name
"RTN","PSORRX1",199,0)
 S RMSDOM=$$FQDN^PSORWRAP(,REMSIEN)
"RTN","PSORRX1",200,0)
 S DOMOVR=REMSITE_"~"_RMSDOM_"~DNS"
"RTN","PSORRX1",201,0)
 S HLP("SUBSCRIBER")="^^^^"_DOMOVR
"RTN","PSORRX1",202,0)
 D DIRECT^HLMA(HLPROT,"GM",1,.HL,"",.HLP)
"RTN","PSORRX1",203,0)
 I $P(HL,U,2) D  Q
"RTN","PSORRX1",204,0)
 . W !,"An error was encountered when trying to process the results",!,"from the refill/partial fill request.",!!,$P(HL,U,3)
"RTN","PSORRX1",205,0)
 . K DIR S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR
"RTN","PSORRX1",206,0)
 . D CL
"RTN","PSORRX1",207,0)
 ; clean up variables used
"RTN","PSORRX1",208,0)
 D READMSG^PSORRX2(.HLDAT,"PR",LOCDRUG)
"RTN","PSORRX1",209,0)
CL ;
"RTN","PSORRX1",210,0)
 K PDATE,QTY,DSUPP,PHARM,REMARKS,MW
"RTN","PSORRX1",211,0)
 K @HLDAT,@HLARR
"RTN","PSORRX1",212,0)
 Q
"RTN","PSORRX1",213,0)
 ;
"RTN","PSORRX1",214,0)
DRUGMTCH(DRGNM,VAPID) ;
"RTN","PSORRX1",215,0)
 ; returns -1 if a match was found but user said NO
"RTN","PSORRX1",216,0)
 N LDIEN,MATCH,EXIT,VAPIDSTR,DRL,VAPIEN,VAGENER,FOUND,CHECK,DIC,DRGARY,LDNAME,Y,DRGNM2,VAPSTR,MTCHSTR,DRLCNT
"RTN","PSORRX1",217,0)
 S CHECK=""
"RTN","PSORRX1",218,0)
 S VAPIEN=$O(^PSNDF(50.68,"C",VAPID,0))
"RTN","PSORRX1",219,0)
 I 'VAPIEN Q ""  ; ID from HDR not found - most likely CMOP ID/VA PID mismatch
"RTN","PSORRX1",220,0)
 S VAPSTR=$$GET1^DIQ(50.68,VAPIEN,2,"E")
"RTN","PSORRX1",221,0)
 S VAPIDSTR=$$GET1^DIQ(50.68,VAPIEN,.01,"E")
"RTN","PSORRX1",222,0)
 W !!,"Remote site drug name: "_DRGNM
"RTN","PSORRX1",223,0)
 I $D(^PSDRUG("B",DRGNM)) S LDIEN=$O(^PSDRUG("B",DRGNM,0))
"RTN","PSORRX1",224,0)
 I $D(LDIEN) D
"RTN","PSORRX1",225,0)
 .S LDNAME=$$GET1^DIQ(50,LDIEN,.01,"E")
"RTN","PSORRX1",226,0)
 .W !,"Matching Drug Found for Dispensing: "_LDNAME
"RTN","PSORRX1",227,0)
 .S CHECK=$$DIR
"RTN","PSORRX1",228,0)
 I $D(LDIEN),'CHECK Q -1  ; match was found but user said NO
"RTN","PSORRX1",229,0)
 I $D(LDIEN) Q LDIEN
"RTN","PSORRX1",230,0)
 S VAGENER=$$GET1^DIQ(50.68,VAPIEN,.05,"I")
"RTN","PSORRX1",231,0)
 ; loop through AND index to find drugs associated with this va generic product.
"RTN","PSORRX1",232,0)
 S FOUND=0
"RTN","PSORRX1",233,0)
 S (DRL,DRLCNT)=0 F  S DRL=$O(^PSDRUG("AND",VAGENER,DRL)) Q:'DRL!(FOUND)  D
"RTN","PSORRX1",234,0)
 .S MTCHSTR=$$GET1^DIQ(50,DRL,901,"E")
"RTN","PSORRX1",235,0)
 .I VAPSTR]"" Q:MTCHSTR'=VAPSTR
"RTN","PSORRX1",236,0)
 .S DRGARY(DRL)="",DRLCNT=DRLCNT+1
"RTN","PSORRX1",237,0)
 ; only one match found.
"RTN","PSORRX1",238,0)
 I DRLCNT=1 S LDIEN=$O(DRGARY(0))
"RTN","PSORRX1",239,0)
 I 'DRLCNT W !!,"No local match could be found for "_DRGNM_".",! K DIR S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q -1
"RTN","PSORRX1",240,0)
 I $D(LDIEN) D
"RTN","PSORRX1",241,0)
 .S LDNAME=$$GET1^DIQ(50,LDIEN,.01,"E")
"RTN","PSORRX1",242,0)
 .W !,"Matching Drug Found for Dispensing: "_LDNAME
"RTN","PSORRX1",243,0)
 .S CHECK=$$DIR()
"RTN","PSORRX1",244,0)
 I $D(LDIEN),'CHECK Q -1  ; match was found but user said NO
"RTN","PSORRX1",245,0)
 I $D(LDIEN) Q LDIEN
"RTN","PSORRX1",246,0)
 ; list the items that match strength
"RTN","PSORRX1",247,0)
 S (MATCH,EXIT)=0
"RTN","PSORRX1",248,0)
 N PSODRGL,PSODRGLI,PSODRGL0,PSODRGID,PSODRGC S DIR(0)=""
"RTN","PSORRX1",249,0)
 F PSODRGLI=0:0 S PSODRGLI=$O(DRGARY(PSODRGLI)) Q:'PSODRGLI  D
"RTN","PSORRX1",250,0)
 .S PSODRGL0=$G(^PSDRUG(PSODRGLI,0)),PSODRGID=$G(^PSDRUG(PSODRGLI,"I"))
"RTN","PSORRX1",251,0)
 .Q:$TR(PSODRGL0,"^")=""  S PSODRGC=$G(PSODRGC)+1
"RTN","PSORRX1",252,0)
 .S DIR(0)=DIR(0)_$S(DIR(0)]"":";",1:"")
"RTN","PSORRX1",253,0)
 .S DIR(0)=DIR(0)_$G(PSODRGC)_":"_PSODRGLI_"  "_$E($P(PSODRGL0,"^"),1,30)_"  "_$J($P(PSODRGL0,"^",2),7)_"  "_$S(PSODRGID:$E(PSODRGID,4,5)_"-"_$E(PSODRGID,6,7)_"-"_$E(PSODRGID,2,3)_"  ",1:"")_$P(PSODRGL0,"^",10)
"RTN","PSORRX1",254,0)
 .S DIR("L",PSODRGC)=PSODRGC_".  "_PSODRGLI_"  "_$E($P(PSODRGL0,"^"),1,30)_"  "_$J($P(PSODRGL0,"^",2),7)_"  "_$S(PSODRGID:$E(PSODRGID,4,5)_"-"_$E(PSODRGID,6,7)_"-"_$E(PSODRGID,2,3)_"  ",1:"")_$P(PSODRGL0,"^",10)
"RTN","PSORRX1",255,0)
 S DIR(0)="SO^"_DIR(0),DIR("L")=""  ;1:$G(PSODRGC)"
"RTN","PSORRX1",256,0)
 S DIR("A")="Select matching local drug"
"RTN","PSORRX1",257,0)
 D ^DIR K DIR
"RTN","PSORRX1",258,0)
 I +Y<1!($D(DUOUT))!($D(DTOUT)) S Y=-1  ;*519
"RTN","PSORRX1",259,0)
 I Y=-1 Q Y
"RTN","PSORRX1",260,0)
 S LDIEN=+Y(0)
"RTN","PSORRX1",261,0)
 I $G(LDIEN) K DIR S DIR(0)="Y",DIR("A")="Would you like to use this drug" D ^DIR I +Y<1!($D(DUOUT))!($D(DTOUT)) Q -1  ;*509 CHECK FOR Y<1 INSTEAD OF Y<0
"RTN","PSORRX1",262,0)
 Q $G(LDIEN)
"RTN","PSORRX1",263,0)
 ; TEXT to build prompts
"RTN","PSORRX1",264,0)
 ;;DIR(0)|DIR(A)|DIR(B)|VARIABLE
"RTN","PSORRX1",265,0)
PRMPTXT ;
"RTN","PSORRX1",266,0)
 ;;N^^I $D(X),X>$P(REMDATA,U,2) D EN^DDIOL("QTY CANNOT BE GREATER THAN THE ORIGINAL QTY OF "_$P(REMDATA,U,2)) K X|Enter Quantity||QTY
"RTN","PSORRX1",267,0)
 ;;N|DAYS SUPPLY||DSUPP
"RTN","PSORRX1",268,0)
 ;;P^200:QEAMZ|Select PHARMACIST Name|S DEF=$$GET1~DIQ(200,DUZ,.01,"E")|PHARM
"RTN","PSORRX1",269,0)
 ;;F^0:60|REMARKS||REMARKS
"RTN","PSORRX1",270,0)
 ;;Q
"RTN","PSORRX1",271,0)
 Q
"RTN","PSORRX1",272,0)
DIR() ;
"RTN","PSORRX1",273,0)
 N DIR,Y
"RTN","PSORRX1",274,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","PSORRX1",275,0)
 S DIR("A",1)="Would you like to use the system matched drug for this"
"RTN","PSORRX1",276,0)
 S DIR("A")="refill/partial fill"
"RTN","PSORRX1",277,0)
 D ^DIR
"RTN","PSORRX1",278,0)
 Q Y
"RTN","PSORRX1",279,0)
POST ; post init for PSO*7*454
"RTN","PSORRX1",280,0)
 N LIEN,OPSITE,DOMAIN,VAL
"RTN","PSORRX1",281,0)
 ; add TCP/IP address for EMI
"RTN","PSORRX1",282,0)
 ;S DOMAIN=$$GET1^DIQ(4,DUZ(2),60,"E")
"RTN","PSORRX1",283,0)
 S DOMAIN=$$FQDN^PSORWRAP(,DUZ(2))
"RTN","PSORRX1",284,0)
 S VAL="PSORRXSEND"
"RTN","PSORRX1",285,0)
 S LIEN=$$FIND1^DIC(870,,"B",.VAL) Q:'LIEN
"RTN","PSORRX1",286,0)
 S FDA(870,LIEN_",",.08)=DOMAIN
"RTN","PSORRX1",287,0)
 S FDA(870,LIEN_",",400.01)="vaaussoalebp2.aac.domain.ext" D FILE^DIE(,"FDA") K FDA
"RTN","PSORRX1",288,0)
 ; turn off the OneVA Pharmacy flag for all outpatient sites.
"RTN","PSORRX1",289,0)
 S OPSITE=0 F  S OPSITE=$O(^PS(59,OPSITE)) Q:'OPSITE  D
"RTN","PSORRX1",290,0)
 .S FDA(59,OPSITE_",",3001)="" D FILE^DIE(,"FDA") K FDA
"RTN","PSORRX1",291,0)
 Q
"RTN","PSORX1")
0^2^B83629863^B82991230
"RTN","PSORX1",1,0)
PSORX1 ;BIR/SAB-medication processing driver ;8/17/16 5:10pm
"RTN","PSORX1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**7,22,23,57,62,46,74,71,90,95,115,117,146,139,135,182,195,233,268,300,170,320,326,324,334,251,454,488,497,519**;DEC 1997;Build 5
"RTN","PSORX1",3,0)
 ;
"RTN","PSORX1",4,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSORX1",5,0)
 ;External reference ^DIC(31 supported by DBIA 658
"RTN","PSORX1",6,0)
 ;External reference ^DPT(D0,.372 supported by DBIA 1476
"RTN","PSORX1",7,0)
 ;External reference DISPPRF^DGPFAPI supported by DBIA #4563
"RTN","PSORX1",8,0)
 ;External reference ^ORRDI1 is supported by DBIA 4659
"RTN","PSORX1",9,0)
 ;External reference ^XTMP("ORRDI" is supported by DBIA 4660
"RTN","PSORX1",10,0)
 ;External reference ^PSUHL supported by DBIA 4803
"RTN","PSORX1",11,0)
 ;
"RTN","PSORX1",12,0)
 ;PSO*195 add call to display Patient Record Flag (DISPPRF^DGPFAPI)
"RTN","PSORX1",13,0)
 ;
"RTN","PSORX1",14,0)
START K PSOQFLG,PSOID,PSOFIN,PSOQUIT,PSODRUG,^TMP($J,"PSOTDD"),^TMP("PSORXPO",$J),^TMP("PSORXBO",$J)
"RTN","PSORX1",15,0)
 I '$G(PSOONEVA) N PSOONEVA S PSOONEVA=1
"RTN","PSORX1",16,0)
 D EOJ S (PSOBCK,PSOERR)=1 D INIT G:PSORX("QFLG") END
"RTN","PSORX1",17,0)
 D PT G:$G(PSORX("QFLG")) END D FULL^VALM1 I $G(NOPROC) K NOPROC G NX
"RTN","PSORX1",18,0)
 ;call to add bingo board data to file 52.11
"RTN","PSORX1",19,0)
 F SLPPL=0:0 S SLPPL=$O(RXRS(SLPPL)) Q:'SLPPL  D
"RTN","PSORX1",20,0)
 .I $P($G(^PSRX(SLPPL,"STA")),"^")'=5 K RXRS(SLPPL) Q
"RTN","PSORX1",21,0)
 .S RXREC=SLPPL D WIND^PSOSUPOE I $G(PBINGRTE) D BBADD^PSOSUPOE S (BINGCRT,BINGRTE)=1 S:$G(PSOFROM)'="NEW" PSOFROM="REFILL"
"RTN","PSORX1",22,0)
 K TM,TM1 I $G(PSORX("PSOL",1))]""!($D(RXRS)) D ^PSORXL K PSORX
"RTN","PSORX1",23,0)
 G:$G(NOBG) NX
"RTN","PSORX1",24,0)
 S TM=$P(^TMP("PSOBB",$J),"^"),TM1=$P(^TMP("PSOBB",$J),"^",2) K ^TMP("PSOBB",$J)
"RTN","PSORX1",25,0)
 I $G(PSOFROM)="NEW"!($G(PSOFROM)="REFILL")!($G(PSOFROM)="PARTIAL")!($G(PSOFROM)="UNHOLD") D:$D(BINGCRT)&($D(BINGRTE)&($D(DISGROUP))) ^PSOBING1 K BINGCRT,BINGRTE,BBRX,BBFLG
"RTN","PSORX1",26,0)
NX I $G(POERR("DEAD"))!$G(PSOQFLG) D EOJ G START
"RTN","PSORX1",27,0)
 D EOJ G START
"RTN","PSORX1",28,0)
END Q
"RTN","PSORX1",29,0)
 ;---------------------------------------------------------
"RTN","PSORX1",30,0)
INIT ;
"RTN","PSORX1",31,0)
 S PSORX("QFLG")=0
"RTN","PSORX1",32,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) S PSORX("QFLG")=1
"RTN","PSORX1",33,0)
 I $P($G(PSOPAR),"^",2),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("VERIFY")=1
"RTN","PSORX1",34,0)
INITX Q
"RTN","PSORX1",35,0)
 ;
"RTN","PSORX1",36,0)
PT ;
"RTN","PSORX1",37,0)
 K ^TMP("PSORXDC",$J),^TMP($J,"PSEXC","OUT"),CLOZPAT,DIC,PSODFN,PSOPTLK
"RTN","PSORX1",38,0)
 S PSORX("QFLG")=0,DIC(0)="QEAM" D EN^PSOPATLK S Y=PSOPTLK
"RTN","PSORX1",39,0)
 I +Y'>0 S PSORX("QFLG")=1 G PTX
"RTN","PSORX1",40,0)
OERR N:$G(MEDP) PAT,POERR K PSOXFLG S (DFN,PSODFN)=+Y,PSORX("NAME")=$P(Y,"^",2)
"RTN","PSORX1",41,0)
 K NPPROC,PSOQFLG,DIC,DR,DIQ S DIC=2,DA=PSODFN,DR=.351,DIQ="PSOPTPST" D EN^DIQ1
"RTN","PSORX1",42,0)
 K DIC,DA,DR,DIQ D DEAD^PSOPTPST I $G(PSOQFLG) S NOPROC=1 Q
"RTN","PSORX1",43,0)
 ;PSO*195 move SSN write to here and add DISPPRF call
"RTN","PSORX1",44,0)
 S SSN=$P(^DPT(PSODFN,0),"^",9) W !!?10,$C(7),PSORX("NAME")
"RTN","PSORX1",45,0)
 W " ("_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_")" K SSN
"RTN","PSORX1",46,0)
 I $G(XQY0)["PSO LMOE FINISH",'$G(MEDP),$D(^TMP($J,"PSOFLPO",PSODFN)) D
"RTN","PSORX1",47,0)
 .I '$D(IOINORM)!('$D(IOINHI)) S X="IORVOFF;IORVON;IOINHI;IOINORM" D ENDR^%ZISS
"RTN","PSORX1",48,0)
 .W "  ",IORVON_IOINHI,"<This patient has flagged orders>",IOINORM_IORVOFF
"RTN","PSORX1",49,0)
 S PSONOAL="" D ALLERGY^PSOORUT2 D  I PSONOAL'="" D PAUSE
"RTN","PSORX1",50,0)
 .I PSONOAL'="" W !,$C(7),"     No Allergy Assessment!"
"RTN","PSORX1",51,0)
 D REMOTE
"RTN","PSORX1",52,0)
 ; bwf - 1/9/2014 - PHARMACY INNOVATIONS, adding call and on screen message to get remote rx's from MDWS.
"RTN","PSORX1",53,0)
 I $G(PSOONEVA) D
"RTN","PSORX1",54,0)
 .N TFL,TFILIST,TFLP,TFLSITE,TFLIEN,TFLCNT,TFLDUP
"RTN","PSORX1",55,0)
 .D TFL^VAFCTFU1(.TFL,PSODFN)
"RTN","PSORX1",56,0)
 .S TFLCNT=0
"RTN","PSORX1",57,0)
 .S TFILIST="^VAMC^M&ROC^M&ROC(M&RO)^OC^OPC^CBOC^PRRTP^DOM^HCS^MC(M)^MC(M&D)^MORC^NHC^VANPH^SOC^SARRTP^"  ; only exact matches
"RTN","PSORX1",58,0)
 .S TFLP=0 F  S TFLP=$O(TFL(TFLP)) Q:'TFLP!(TFLCNT=2)  D
"RTN","PSORX1",59,0)
 ..S TFLSITE=$P(TFL(TFLP),U) Q:TFLSITE=""
"RTN","PSORX1",60,0)
 ..Q:$D(TFLDUP(TFLSITE))
"RTN","PSORX1",61,0)
 ..S TFLDUP(TFLSITE)=""
"RTN","PSORX1",62,0)
 ..Q:TFILIST'[(U_$P(TFL(TFLP),U,5)_U)
"RTN","PSORX1",63,0)
 ..S TFLCNT=$G(TFLCNT)+1
"RTN","PSORX1",64,0)
 .I $G(TFLCNT)<2 Q
"RTN","PSORX1",65,0)
 .I '$$GET1^DIQ(59.7,1,101,"I") D  Q
"RTN","PSORX1",66,0)
 ..W !!,"The OneVA Pharmacy flag is turned off. Queries will NOT"
"RTN","PSORX1",67,0)
 ..W !,"be made to other VA Pharmacy locations.",!
"RTN","PSORX1",68,0)
 .K DIR S DIR(0)="Y",DIR("B")="NO",DIR("A")="locations",DIR("A",1)="Would you like to query prescriptions from other OneVA Pharmacy" D ^DIR ;CHANGE PROMPT DEFAULT FROM YES TO NO ;*519
"RTN","PSORX1",69,0)
 .K DIR
"RTN","PSORX1",70,0)
 .Q:'Y
"RTN","PSORX1",71,0)
 .W !!,"Please wait. Checking for prescriptions at other VA Pharmacy locations. This may take a moment...",!
"RTN","PSORX1",72,0)
 .D REMOTERX^PSORRX1(PSODFN,PSOSITE)
"RTN","PSORX1",73,0)
 N PSOUPDT
"RTN","PSORX1",74,0)
 S PSOUPDT=1
"RTN","PSORX1",75,0)
 I $G(XQY0)["PSO LMOE FINISH" S PSOUPDT=0
"RTN","PSORX1",76,0)
 D CHKADDR^PSOBAI(PSODFN,1,PSOUPDT)
"RTN","PSORX1",77,0)
 D:($G(XQY0)["PSO LMOE FINISH")&('$G(SNGLPAT)) DISPPRF^DGPFAPI(PSODFN)
"RTN","PSORX1",78,0)
 ;
"RTN","PSORX1",79,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") W !?10,"Patient has another language preference!",! H 3
"RTN","PSORX1",80,0)
 I $G(^PS(55,"ASTALK",PSODFN)) W !,"Patient is enrolled to receive ScripTalk 'talking' prescription labels.",! H 2 D MAIL
"RTN","PSORX1",81,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSORX1",82,0)
 ;Call to display remote/local prescriptions
"RTN","PSORX1",83,0)
 I '$G(PSOFIN) D RDICHK^PSORMRX(PSODFN)
"RTN","PSORX1",84,0)
 S PSOQFLG=0,DIC="^PS(55,",DLAYGO=55
"RTN","PSORX1",85,0)
 I '$D(^PS(55,PSODFN,0)) D
"RTN","PSORX1",86,0)
 .K DD,DO S DIC(0)="L",(DINUM,X)=PSODFN D FILE^DICN D:Y<1  K DIC,DA,DR,DD,DO
"RTN","PSORX1",87,0)
 ..S $P(^PS(55,PSODFN,0),"^")=PSODFN K DIK S DA=PSODFN,DIK="^PS(55,",DIK(1)=.01 D EN^DIK K DIK
"RTN","PSORX1",88,0)
 D RXSTA
"RTN","PSORX1",89,0)
 S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSORX1",90,0)
 I $G(^PS(55,PSODFN,"PS"))']"" D  I $G(POERR("QFLG")) G EOJ
"RTN","PSORX1",91,0)
 .L +^PS(55,PSODFN):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W $C(7),!!,"Patient Data is Being Edited by Another User!",! S POERR("QFLG")=1 S:$G(PSOFIN) PSOQUIT=1 Q
"RTN","PSORX1",92,0)
 .S PSOXFLG=1,SSN=$P(^DPT(PSODFN,0),"^",9) W !!?10,$C(7),PSORX("NAME")_" ("_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_")",! K SSN
"RTN","PSORX1",93,0)
 .S DIE=55,DR=".02;.03;.04;.05;1;D ELIG^PSORX1;3;50;106;106.1",DA=PSODFN W !!,?5,">>PHARMACY PATIENT DATA<<",! D ^DIE L -^PS(55,PSODFN)
"RTN","PSORX1",94,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^")
"RTN","PSORX1",95,0)
 I $G(^PS(55,PSODFN,"PS"))']"" D  I $G(POERR("QFLG")) G EOJ
"RTN","PSORX1",96,0)
 .W !!,"Patient Status Required!!",! D ELIG
"RTN","PSORX1",97,0)
 .W ! K POERR("QFLG"),DIC,DR,DIE S DIC("A")="RX PATIENT STATUS: ",DIC(0)="QEAMZ",DIC=53 D ^DIC K DIC
"RTN","PSORX1",98,0)
 .I $D(DIRUT)!(Y=-1) D  Q
"RTN","PSORX1",99,0)
 ..W $C(7),"Required Data!",! S POERR("QFLG")=1 S:$G(PSOFIN) PSOQUIT=1
"RTN","PSORX1",100,0)
 ..I $O(^PS(55,PSODFN,0))="" S DA=PSODFN,DIK="^PS(55," D ^DIK
"RTN","PSORX1",101,0)
 .S ^PS(55,PSODFN,"PS")=+Y,PSORX("PATIENT STATUS")=$P(^PS(53,+Y,0),"^")
"RTN","PSORX1",102,0)
 .K DIRUT,DTOUT,DUOUT,X,Y,DA
"RTN","PSORX1",103,0)
 Q:$G(PSOFIN)
"RTN","PSORX1",104,0)
 D ^PSOBUILD
"RTN","PSORX1",105,0)
 F PT="GET","DEAD","INP","CNH","TPB","ADDRESS","COPAY" S RTN=PT_"^PSOPTPST" D @RTN Q:$G(POERR("DEAD"))!($G(PSOQFLG))
"RTN","PSORX1",106,0)
 I $G(POERR("DEAD")) S POERR("QFLG")=1 F II=0:0 S II=$O(^PS(52.41,"P",PSODFN,II)) D:$P($G(^PS(52.41,II,0)),"^",3)'="DC"&($P($G(^(0)),"^",3)'="DE") DC^PSOORFI2
"RTN","PSORX1",107,0)
 K PSOERR("DEAD"),II I $G(PSOQFLG) S POERR("QFLG")=1 G EOJ Q
"RTN","PSORX1",108,0)
 S (PAT,PSOXXDFN)=PSODFN,POERR=1 D ^PSOORUT2,BLD^PSOORUT1,EN^PSOLMUTL
"RTN","PSORX1",109,0)
 D CLEAR^VALM1 G:$G(PSOQUIT) PTX D EN^PSOLMAO
"RTN","PSORX1",110,0)
 S (DFN,PSODFN)=PSOXXDFN K DIE,DIC,DLAYGO,DR,DA,PSOX,PSORXED
"RTN","PSORX1",111,0)
 I $O(RXFL("")),$P(^PS(55,PSODFN,0),"^",7)="" D
"RTN","PSORX1",112,0)
 . N %
"RTN","PSORX1",113,0)
 . D NOW^%DTC
"RTN","PSORX1",114,0)
 . S $P(^PS(55,PSODFN,0),"^",7)=$E(%,1,12),$P(^(0),"^",8)="A" D LOGDFN^PSUHL(PSODFN)
"RTN","PSORX1",115,0)
PTX ;
"RTN","PSORX1",116,0)
 K X,Y,^TMP("PS",$J),^TMP($J,"PSEXC","OUT"),C,DEA,PRC,PSCNT,PSOACT,PSOCLC,PSOCS,PSOCT,PSOFINFL,PSOHD,PSOLST,PSOOPT,PSOPF,PSOX,PSOX1,PSOXXDFN,SIGOK,STP,STR,PSOPTLK
"RTN","PSORX1",117,0)
 Q
"RTN","PSORX1",118,0)
EOJ ;
"RTN","PSORX1",119,0)
 I $G(PSODFN) K ^TMP($J,"PSOINTERVENE",PSODFN)
"RTN","PSORX1",120,0)
 K PSOERR,PSOMED,PSORX,PSOSD,PSODRUG,PSODFN,PSOOPT,PSOBILL,PSOIBQS,PSOCPAY,PSOPF,PSOPI,COMM,DGI,DGS,PT,PTDY,PTRF,RN,RTN,SERS,ST0,STAT,DFN,STOP,SLPPL,RXREC
"RTN","PSORX1",121,0)
 K:'$G(MEDP) PSOQFLG
"RTN","PSORX1",122,0)
 D KVA^VADPT,FULL^VALM1 K PSOLST,PSOXFLG,PSCNT,PSDIS,PSOAL,P1,LOG,%,%DT,%I,D0,DAT,DFN,DRG,ORX,PSON,PSOPTPST,PSORX,PTST,PSOBCK,PSOID,PSOBXPUL
"RTN","PSORX1",123,0)
 K INCOM,SIG,SG,STP,RX0,RXN,RX2,RX3,RTS,C,DEAD,PS,PSOCLC,PSOCNT,PSOCT,PSODA,PSOFROM,PSOHD,R3,REA,RF,RFD,RFM,RLD,RXNUM,RXP,RXPR,RXRP,RXRS,STR,POERR,VALMSG
"RTN","PSORX1",124,0)
 K ^TMP("PSORXDD",$J),^TMP("PSORXDC",$J),^TMP("PSOAL",$J),^TMP("PSOAO",$J),^TMP("PSOSF",$J),^TMP("PSOPF",$J),^TMP("PSOPI",$J),^TMP("PSOPO",$J),^TMP("PSOHDR",$J),^TMP("PSORXPO",$J)
"RTN","PSORX1",125,0)
 I '$G(MEDP),'$G(PSOQUIT) K PAT
"RTN","PSORX1",126,0)
 K ^TMP("PSORXBO",$J),PSORX,RFN,PSOXXDFN,VALM,VALMKEY,PSOBCK,SPOERR,PSOFLAG,VALMBCK,D,GMRA,GMRAL,GMRAREC,PSOSTA,PSODT,RXFL,NOBG,BBRX,BBFLG,^TMP($J,"PSOFLPO")
"RTN","PSORX1",127,0)
 K PPL,PPL1,PSOQFLAG ;*334 ADDED KILLS
"RTN","PSORX1",128,0)
 K ^XTMP("PSORRX1",$J),PSORCNT ;*454 added kill
"RTN","PSORX1",129,0)
 Q
"RTN","PSORX1",130,0)
ELIG ; shows eligibility and disabilities
"RTN","PSORX1",131,0)
 D ELIG^VADPT W !,"Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:"") S N=0 F  S N=$O(VAEL(1,N)) Q:'N  W !,?10,$P(VAEL(1,N),"^",2)
"RTN","PSORX1",132,0)
 W !,"Disabilities: " F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  S I1=$S($D(^DPT(DFN,.372,I,0)):^(0),1:"") D:+I1
"RTN","PSORX1",133,0)
 .S PSDIS=$S($P($G(^DIC(31,+I1,0)),"^")]""&($P($G(^(0)),"^",4)']""):$P(^(0),"^"),$P($G(^DIC(31,+I1,0)),"^",4)]"":$P(^(0),"^",4),1:""),PSCNT=$P(I1,"^",2)
"RTN","PSORX1",134,0)
 .W:$L(PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), ")>80 !,?15
"RTN","PSORX1",135,0)
 .W $S($G(PSDIS)]"":PSDIS_"-",1:"")_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), "
"RTN","PSORX1",136,0)
 K N
"RTN","PSORX1",137,0)
 Q
"RTN","PSORX1",138,0)
PROFILE ;
"RTN","PSORX1",139,0)
 S (PSORX("REFILL"),PSORX("RENEW"))=0,PSOX="" D ^PSOBUILD
"RTN","PSORX1",140,0)
 I '$G(PSOSD) W !,"This patient has no prescriptions" S:'$D(DFN) DFN=PSODFN D GMRA^PSODEM G PROFILEX
"RTN","PSORX1",141,0)
 S (PSODRG,PSOX)="" F  S PSODRG=$O(PSOSD(PSODRG)) Q:PSODRG=""  F  S PSOX=$O(PSOSD(PSODRG,PSOX)) Q:PSOX=""  S:$P(PSOSD(PSODRG,PSOX),"^",3)="" PSORX("RENEW")=1 S:$P(PSOSD(PSODRG,PSOX),"^",4)="" PSORX("REFILL")=1
"RTN","PSORX1",142,0)
 K PSOX
"RTN","PSORX1",143,0)
PROFILEX Q
"RTN","PSORX1",144,0)
 ;
"RTN","PSORX1",145,0)
MAIL ; MAKE SURE MAIL STATUS IS COMPATIBLE WITH SCRIPTALK PATIENT
"RTN","PSORX1",146,0)
 I $P($G(^PS(59,PSOSITE,"STALK")),"^")="" Q  ; NO SCRIPTALK PRINTER SET UP FOR THIS DIVISION
"RTN","PSORX1",147,0)
 N MAIL
"RTN","PSORX1",148,0)
 S MAIL=$G(^PS(55,PSODFN,0)) I $P(MAIL,"^",3)>1 Q
"RTN","PSORX1",149,0)
MAILP W !!,"REMINDER: CMOP does not fill ScripTalk prescriptions. Please select mail"
"RTN","PSORX1",150,0)
 W !,"status:  2 (DO NOT MAIL), 3 (LOCAL REGULAR MAIL) or 4 (LOCAL CERTFIED MAIL)."
"RTN","PSORX1",151,0)
 R !,"MAIL: ",MAIL:120
"RTN","PSORX1",152,0)
 I MAIL?1"^".E Q
"RTN","PSORX1",153,0)
 I MAIL<2!(MAIL>4) W !,"INVALID MAIL SETTING - ENTER 2,3, OR 4" G MAILP
"RTN","PSORX1",154,0)
 W "  ",$S(MAIL=2:"DO NOT MAIL",MAIL=3:"LOCAL REGULAR MAIL",1:"LOCAL CERTIFIED MAIL")
"RTN","PSORX1",155,0)
 S $P(^PS(55,PSODFN,0),"^",3)=MAIL
"RTN","PSORX1",156,0)
 Q
"RTN","PSORX1",157,0)
REMOTE ; 
"RTN","PSORX1",158,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSORX1",159,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSORX1",160,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSORX1",161,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)'>IOSL) Q
"RTN","PSORX1",162,0)
 Q
"RTN","PSORX1",163,0)
PAUSE ;
"RTN","PSORX1",164,0)
 W ! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSORX1",165,0)
 Q
"RTN","PSORX1",166,0)
 ;
"RTN","PSORX1",167,0)
RXSTA ; DISPLAY ELIGIBILITY & PROMPT FOR RX PATIENT STATUS
"RTN","PSORX1",168,0)
 N DA,PSOSTA
"RTN","PSORX1",169,0)
 I '$G(PSODFN) Q
"RTN","PSORX1",170,0)
 S DA=PSODFN,PSOSTA=$G(^PS(55,PSODFN,"PS"))
"RTN","PSORX1",171,0)
 I $G(XQY0)["PSO LMOE FINISH"!(XQY0["PSO LM BACKDOOR ORDERS") I PSOSTA]"" D
"RTN","PSORX1",172,0)
 .D ELIG^VADPT W !,"Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:"")
"RTN","PSORX1",173,0)
 .S N=0 F  S N=$O(VAEL(1,N)) Q:'N  W !,?10,$P(VAEL(1,N),"^",2)
"RTN","PSORX1",174,0)
 .S DIC("A")="RX PATIENT STATUS: ",DIC("B")=PSOSTA,DIC(0)="QEAMZ",DIC=53 D ^DIC K DIC
"RTN","PSORX1",175,0)
 .I +Y>0,+Y'=PSOSTA S DIE="^PS(55,",DR="3////"_+Y D ^DIE
"RTN","PSORX1",176,0)
 Q
"VER")
8.0^22.2
"BLD",10821,6)
^428
**END**
**END**

