Released PSO*7*499 SEQ #419
Extracted from mail message
**KIDS**:PSO*7.0*499^

**INSTALL NAME**
PSO*7.0*499
"BLD",10708,0)
PSO*7.0*499^OUTPATIENT PHARMACY^0^3170929^y
"BLD",10708,1,0)
^^8^8^3170928^
"BLD",10708,1,1,0)
This patch will resolve the following issues.
"BLD",10708,1,2,0)
 
"BLD",10708,1,3,0)
1.      I12011023FY17 - One-VA partial functionality does not restrict
"BLD",10708,1,4,0)
                        quantity
"BLD",10708,1,5,0)
2.      I12010975FY17 - One-VA displaying inconsistent information
"BLD",10708,1,6,0)
                        in VistA options
"BLD",10708,1,7,0)
3.      I12150112FY17 - OneVA Pharmacy Selection of Drugs by the
"BLD",10708,1,8,0)
                        Dispensing Site
"BLD",10708,4,0)
^9.64PA^^
"BLD",10708,6.3)
8
"BLD",10708,"ABPKG")
n
"BLD",10708,"KRN",0)
^9.67PA^779.2^20
"BLD",10708,"KRN",.4,0)
.4
"BLD",10708,"KRN",.401,0)
.401
"BLD",10708,"KRN",.402,0)
.402
"BLD",10708,"KRN",.403,0)
.403
"BLD",10708,"KRN",.5,0)
.5
"BLD",10708,"KRN",.84,0)
.84
"BLD",10708,"KRN",3.6,0)
3.6
"BLD",10708,"KRN",3.8,0)
3.8
"BLD",10708,"KRN",9.2,0)
9.2
"BLD",10708,"KRN",9.8,0)
9.8
"BLD",10708,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",10708,"KRN",9.8,"NM",1,0)
PSORRX1^^0^B156041804
"BLD",10708,"KRN",9.8,"NM",2,0)
PSORXVW1^^0^B74497358
"BLD",10708,"KRN",9.8,"NM","B","PSORRX1",1)

"BLD",10708,"KRN",9.8,"NM","B","PSORXVW1",2)

"BLD",10708,"KRN",19,0)
19
"BLD",10708,"KRN",19.1,0)
19.1
"BLD",10708,"KRN",101,0)
101
"BLD",10708,"KRN",409.61,0)
409.61
"BLD",10708,"KRN",771,0)
771
"BLD",10708,"KRN",779.2,0)
779.2
"BLD",10708,"KRN",870,0)
870
"BLD",10708,"KRN",8989.51,0)
8989.51
"BLD",10708,"KRN",8989.52,0)
8989.52
"BLD",10708,"KRN",8994,0)
8994
"BLD",10708,"KRN","B",.4,.4)

"BLD",10708,"KRN","B",.401,.401)

"BLD",10708,"KRN","B",.402,.402)

"BLD",10708,"KRN","B",.403,.403)

"BLD",10708,"KRN","B",.5,.5)

"BLD",10708,"KRN","B",.84,.84)

"BLD",10708,"KRN","B",3.6,3.6)

"BLD",10708,"KRN","B",3.8,3.8)

"BLD",10708,"KRN","B",9.2,9.2)

"BLD",10708,"KRN","B",9.8,9.8)

"BLD",10708,"KRN","B",19,19)

"BLD",10708,"KRN","B",19.1,19.1)

"BLD",10708,"KRN","B",101,101)

"BLD",10708,"KRN","B",409.61,409.61)

"BLD",10708,"KRN","B",771,771)

"BLD",10708,"KRN","B",779.2,779.2)

"BLD",10708,"KRN","B",870,870)

"BLD",10708,"KRN","B",8989.51,8989.51)

"BLD",10708,"KRN","B",8989.52,8989.52)

"BLD",10708,"KRN","B",8994,8994)

"BLD",10708,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",10708,"QUES",0)
^9.62^^
"BLD",10708,"REQB",0)
^9.611^2^2
"BLD",10708,"REQB",1,0)
PSO*7.0*427^2
"BLD",10708,"REQB",2,0)
PSO*7.0*454^2
"BLD",10708,"REQB","B","PSO*7.0*427",1)

"BLD",10708,"REQB","B","PSO*7.0*454",2)

"MBREQ")
0
"PKG",206,-1)
1^1
"PKG",206,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",206,20,0)
^9.402P^^
"PKG",206,22,0)
^9.49I^1^1
"PKG",206,22,1,0)
7.0^3021122^3021202^66481
"PKG",206,22,1,"PAH",1,0)
499^3170929
"PKG",206,22,1,"PAH",1,1,0)
^^8^8^3170929
"PKG",206,22,1,"PAH",1,1,1,0)
This patch will resolve the following issues.
"PKG",206,22,1,"PAH",1,1,2,0)
 
"PKG",206,22,1,"PAH",1,1,3,0)
1.      I12011023FY17 - One-VA partial functionality does not restrict
"PKG",206,22,1,"PAH",1,1,4,0)
                        quantity
"PKG",206,22,1,"PAH",1,1,5,0)
2.      I12010975FY17 - One-VA displaying inconsistent information
"PKG",206,22,1,"PAH",1,1,6,0)
                        in VistA options
"PKG",206,22,1,"PAH",1,1,7,0)
3.      I12150112FY17 - OneVA Pharmacy Selection of Drugs by the
"PKG",206,22,1,"PAH",1,1,8,0)
                        Dispensing Site
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSORRX1")
0^1^B156041804^B139750868
"RTN","PSORRX1",1,0)
PSORRX1 ;AITC/BWF - Remote RX driver ;8/30/16 12:00am
"RTN","PSORRX1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**454,499**;DEC 1997;Build 8
"RTN","PSORRX1",3,0)
 ;
"RTN","PSORRX1",4,0)
 Q
"RTN","PSORRX1",5,0)
 ;
"RTN","PSORRX1",6,0)
REMOTERX(DFN,PSOSITE) ;
"RTN","PSORRX1",7,0)
 N RXRES,MSG,HLARR,CNT,RXDAT,HLARR,HLPROT,DONE,ORFS,ORCS,ORRS,ORES,ORSS,ORQUIT,HLQUIT,HLDAT,TFLIST,HLP,HLNODE,HLNEXT,HLINSTN
"RTN","PSORRX1",8,0)
 N PID1,PID4,PID5,PID6,TFDAT,LOOP,RXMSG,PSORRDAT,PSOHCNT,ERR,HL,PSORRDAT,ORERR,SITE
"RTN","PSORRX1",9,0)
 S HLARR=$NA(^TMP("HLS",$J)) K @HLARR
"RTN","PSORRX1",10,0)
 S HLDAT=$NA(^XTMP("PSORRX1",$J)) K @HLDAT
"RTN","PSORRX1",11,0)
 ; moved to PSORX1
"RTN","PSORRX1",12,0)
 ;I '$$GET1^DIQ(59,PSOSITE,3001,"I") D  Q
"RTN","PSORRX1",13,0)
 ;.W !!,"The OneVA Pharmacy flag is turned off. Queries will NOT"
"RTN","PSORRX1",14,0)
 ;.W !,"be made to other VA Pharmacy locations.",!
"RTN","PSORRX1",15,0)
 ; possibly add error message to be returned if no DFN.
"RTN","PSORRX1",16,0)
 I 'DFN Q
"RTN","PSORRX1",17,0)
 S SITE=$P($$SITE^VASITE(),U)
"RTN","PSORRX1",18,0)
 S TFSTRING=$$GET1^DIQ(2,DFN,991.01,"I")_"^^^USVHA^NI^"_SITE
"RTN","PSORRX1",19,0)
 S HLPROT="PSO REMOTE RX QBP-Q13 EVENT"
"RTN","PSORRX1",20,0)
 D INIT^HLFNC2(HLPROT,.HL)
"RTN","PSORRX1",21,0)
 D BLDPID^PSOTPHL2(DFN,"",.PSORRDAT,.HL,.ERR)
"RTN","PSORRX1",22,0)
 I $D(ERR) W !,"There was a problem creating the PID segment for this patient.",!,"Please contact technical support.",!
"RTN","PSORRX1",23,0)
 S @HLARR@(1)="QPD^Q13~Active Prescriptions~HL70471^"
"RTN","PSORRX1",24,0)
 S DONE=0
"RTN","PSORRX1",25,0)
 F PSOHCNT=1:1 D  Q:DONE
"RTN","PSORRX1",26,0)
 .I '$D(PSORRDAT(PSOHCNT)) S DONE=1 Q
"RTN","PSORRX1",27,0)
 .S @HLARR@(2)=$G(@HLARR@(2))_PSORRDAT(PSOHCNT)
"RTN","PSORRX1",28,0)
 S @HLARR@(3)="RCP^I"
"RTN","PSORRX1",29,0)
 S HLP("SUBSCRIBER")="^^^^200HD~HDR.DOMAIN.EXT~DNS"
"RTN","PSORRX1",30,0)
 D DIRECT^HLMA(HLPROT,"GM",1,.RXDAT,"",.HLP)
"RTN","PSORRX1",31,0)
 S ORFS=$G(HL("FS")),ORCS=$E($G(HL("ECH")),1),ORRS=$E($G(HL("ECH")),2),ORES=$E($G(HL("ECH")),3),ORSS=$E($G(HL("ECH")),4)
"RTN","PSORRX1",32,0)
 S HLQUIT=0,ORQUIT="",ORERR=""
"RTN","PSORRX1",33,0)
 I $P(RXDAT,U,3)="No response"!($P(RXDAT,U,3)="Connection Failed") D  Q
"RTN","PSORRX1",34,0)
 .W !,"The system is down or not responding.",!,"Could not query prescriptions at other VA Pharmacy locations.",!
"RTN","PSORRX1",35,0)
 .K DIR S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR
"RTN","PSORRX1",36,0)
 F  X HLNEXT Q:HLQUIT'>0!(ORQUIT'="")  D
"RTN","PSORRX1",37,0)
 .N LOOP
"RTN","PSORRX1",38,0)
 .S LOOP=0 F  S LOOP=$O(HLNODE(LOOP)) Q:LOOP=""  S HLNODE=HLNODE_HLNODE(LOOP)
"RTN","PSORRX1",39,0)
 .I $E(HLNODE,1,3)="MSA"&(($P(HLNODE,ORFS,2)'="CA")) D LOGERR(DFN,.HLNODE,.HLDAT,$P(HLNODE,ORFS,4)) S ORQUIT=$P(HLNODE,ORFS,4)
"RTN","PSORRX1",40,0)
 .I $E(HLNODE,1,3)="ERR" D LOGERR(DFN,.HLNODE,.HLDAT) S ORQUIT=$P(HLNODE,ORFS,4)
"RTN","PSORRX1",41,0)
 .I $E(HLNODE,1,3)="RDT" D
"RTN","PSORRX1",42,0)
 ..S @HLDAT@(0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_U_$$NOW^XLFDT
"RTN","PSORRX1",43,0)
 ..D RXPRSE(DFN,.HLNODE,.HLDAT)
"RTN","PSORRX1",44,0)
 Q
"RTN","PSORRX1",45,0)
LOGERR(DFN,DATA,HLDAT,NMSG) ;
"RTN","PSORRX1",46,0)
 N HLERR
"RTN","PSORRX1",47,0)
 S NMSG=$G(NMSG,"")
"RTN","PSORRX1",48,0)
 S HLERR=$S(NMSG'="":NMSG,1:$P(DATA,ORFS,9))
"RTN","PSORRX1",49,0)
 S:'$D(@HLDAT@(0)) @HLDAT@(0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_U_$$NOW^XLFDT
"RTN","PSORRX1",50,0)
 S @HLDAT@(DFN,"ERR")="<"_HLERR_">"
"RTN","PSORRX1",51,0)
 W !!,"When trying to query prescriptions at other VA Pharmacy",!,"Locations the following message was encountered:",!,"***",!,HLERR,!,"***",! K DIR S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",52,0)
 Q
"RTN","PSORRX1",53,0)
 ; parse rx data from RDF segment
"RTN","PSORRX1",54,0)
RXPRSE(DFN,DATA,HLDAT) ;
"RTN","PSORRX1",55,0)
 ;RDF|14|Site Number~Rx Number~Drug Name~Quantity~Refills~Days Supply~Expiration Date
"RTN","PSORRX1",56,0)
 ;~Issue Date~Stop Date~Last Fill Date~Sig~Detail~Status~VA Product ID
"RTN","PSORRX1",57,0)
 N RXSITE,RXNUM,DNAME,QTY,REFILLS,DSUPP,EXPDT,ISSDATE,STOPDT,LFDT,SIG,DETAIL,STAT,STATNM,STATERR,DDONE,I,VAPID,VAFQDN,DAT
"RTN","PSORRX1",58,0)
 ; put data into one variable. This handles overflow nodes
"RTN","PSORRX1",59,0)
 S DAT=0 F  S DAT=$O(DATA(DAT)) Q:'DAT  D
"RTN","PSORRX1",60,0)
 .S DATA=$G(DATA)_$G(DATA(DAT))
"RTN","PSORRX1",61,0)
 S RXSITE=$P(DATA,ORFS,2),RXNUM=$P(DATA,ORFS,3),DNAME=$P(DATA,ORFS,4),QTY=$P(DATA,ORFS,5)
"RTN","PSORRX1",62,0)
 Q:DNAME=""
"RTN","PSORRX1",63,0)
 S REFILLS=$P(DATA,ORFS,6),DSUPP=$P(DATA,ORFS,7),EXPDT=$P(DATA,ORFS,8),ISSDATE=$P(DATA,ORFS,9)
"RTN","PSORRX1",64,0)
 S STOPDT=$P(DATA,ORFS,10),LFDT=$P(DATA,ORFS,11),SIG=$P(DATA,ORFS,12),DETAIL=$P(DATA,ORFS,13)
"RTN","PSORRX1",65,0)
 S STAT=$P(DATA,ORFS,14) Q:STAT=""
"RTN","PSORRX1",66,0)
 ; VA Product ID
"RTN","PSORRX1",67,0)
 S VAPID=$P(DATA,ORFS,15)
"RTN","PSORRX1",68,0)
 S VAFQDN=$P(DATA,ORFS,16)
"RTN","PSORRX1",69,0)
 Q:STAT=""
"RTN","PSORRX1",70,0)
 Q:'RXSITE!('RXNUM)
"RTN","PSORRX1",71,0)
 S @HLDAT@(DFN,RXSITE,STAT,DNAME,0)=RXNUM_U_QTY_U_REFILLS_U_DSUPP_U_EXPDT_U_ISSDATE_U_STOPDT_U_LFDT_U_STAT_U_VAPID_U_DNAME_U_VAFQDN
"RTN","PSORRX1",72,0)
 S @HLDAT@(DFN,RXSITE,STAT,DNAME,"SIG")=SIG
"RTN","PSORRX1",73,0)
 S @HLDAT@(DFN,RXSITE,STAT,DNAME,"DETAIL")=DETAIL
"RTN","PSORRX1",74,0)
 Q
"RTN","PSORRX1",75,0)
 ; build and send refill request
"RTN","PSORRX1",76,0)
REFREQ ;
"RTN","PSORRX1",77,0)
 N PHARM,PHONE,LOCSITE,DSUPP,MW,FILLDT,MSG,RXNUM,HLSTR,REMSITE,PHARMLN,PHARMFN,PHARMMI,TFSTRING,HLPROT,LOCDRUG,REMDRUG,DINACT
"RTN","PSORRX1",78,0)
 N ORFS,ORCS,ORRS,ORES,ORSS,HLQUIT,ORQUIT,RESP,RETDFN,VAPID,DONE,PSORRDAT,PSOHCNT,DONE,HL,CSVAL,DIR,REMSIEN,PSOHLNK,PSOLNKDN,DOMOVR,RMSDOM
"RTN","PSORRX1",79,0)
 S HLARR=$NA(^TMP("HLS",$J)) K @HLARR
"RTN","PSORRX1",80,0)
 S HLDAT=$NA(^XTMP("REFREQ^PSORRX1",$J)) K @HLDAT
"RTN","PSORRX1",81,0)
 S HLPROT="PSO REMOTE RX RDS-O13 EVENT"
"RTN","PSORRX1",82,0)
 S MW="W"
"RTN","PSORRX1",83,0)
 D FULL^VALM1
"RTN","PSORRX1",84,0)
 S LOCSITE=$$STA^XUAF4(DUZ(2))
"RTN","PSORRX1",85,0)
 S PHARM=$$GET1^DIQ(200,DUZ,.01,"E"),PHARMLN=$P(PHARM,","),PHARMFN=$P($P(PHARM,",",2)," "),PHARMMI=$P($P(PHARM,",",2)," ",2)
"RTN","PSORRX1",86,0)
 S PHONE=$$GET1^DIQ(200,DUZ,.132,"E")
"RTN","PSORRX1",87,0)
 S RXNUM=$P(PSOLST(ORN),U,2) I 'RXNUM S MSG(1)="Invalid Rx #. Please contact technical support." Q
"RTN","PSORRX1",88,0)
 I SRXSTAT'="ACTIVE" W !!,"Only 'ACTIVE' remote prescriptions may be refilled at this time." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",89,0)
 S REMSITE=$P(PSOLST(ORN),U,4)   ;,REMSIEN=$O(^DIC(4,"D",REMSITE,0))
"RTN","PSORRX1",90,0)
 S REMSIEN=$$FIND1^DIC(4,,"X",REMSITE,"D","I $P(^(0),U,11)=""N"",'$P($G(^(99)),U,4)") Q:'REMSIEN
"RTN","PSORRX1",91,0)
 S PSOREF("DFLG")=""
"RTN","PSORRX1",92,0)
 S REMDRUG=$P(REMDATA,U,11),VAPID=$P(REMDATA,U,10)
"RTN","PSORRX1",93,0)
 I '$L(VAPID) W !!,"Missing VA Product ID. Rx# ",RXNUM," cannot be refilled." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",94,0)
 S LOCDRUG=$$DRUGMTCH(REMDRUG,VAPID)
"RTN","PSORRX1",95,0)
 I $G(LOCDRUG)=-1 Q  ; user entered no so no reason to prompt again
"RTN","PSORRX1",96,0)
 I '$G(LOCDRUG) W !!,"Could not match remote drug to a local drug. Cannot refill Rx# ",RXNUM,"." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",97,0)
 S DINACT=$$GET1^DIQ(50,LOCDRUG,100,"I")
"RTN","PSORRX1",98,0)
 I DINACT>0,DINACT<$$NOW^XLFDT W !!,"Matched Drug "_$$GET1^DIQ(50,LOCDRUG,.01,"E")_" is inactive.",!,"Cannot refill."  S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",99,0)
 ; ****** controlled substance check
"RTN","PSORRX1",100,0)
 S CSVAL=$$GET1^DIQ(50,LOCDRUG,3,"E"),CSVAL=$E(CSVAL,1)
"RTN","PSORRX1",101,0)
 I CSVAL,CSVAL>0,CSVAL<6 W !!,"This is a controlled substance. Cannot refill Rx#",RXNUM,"." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",102,0)
 ;
"RTN","PSORRX1",103,0)
 ; if we got this far, fill is most likely happening and remote
"RTN","PSORRX1",104,0)
 ; worklist needs to be rebuilt when returning so set flag. PSORRBLD
"RTN","PSORRX1",105,0)
 ; was New'ed in calling routine. May change my mind if we get an
"RTN","PSORRX1",106,0)
 ; error from host.
"RTN","PSORRX1",107,0)
 S PSORRBLD=1
"RTN","PSORRX1",108,0)
 ;
"RTN","PSORRX1",109,0)
 S (FILLDT,PSOREF("FILL DATE"))=DT
"RTN","PSORRX1",110,0)
 D INIT^HLFNC2(HLPROT,.HL)
"RTN","PSORRX1",111,0)
 D BLDPID^PSOTPHL2(DFN,"",.PSORRDAT,.HL,.ERR)
"RTN","PSORRX1",112,0)
 S DONE=0
"RTN","PSORRX1",113,0)
 F PSOHCNT=1:1 D  Q:DONE
"RTN","PSORRX1",114,0)
 .I '$D(PSORRDAT(PSOHCNT)) S DONE=1 Q
"RTN","PSORRX1",115,0)
 .S @HLARR@(1)=$G(@HLARR@(1))_PSORRDAT(PSOHCNT)
"RTN","PSORRX1",116,0)
 ;S @HLARR@(2)="ORC^RF^"_RXNUM_"~"_REMSITE_"~"_$$GET1^DIQ(4,REMSIEN,60,"E")_"^^^^^^^"_FILLDT_U_DUZ_"~"_PHARMLN_"~"_PHARMFN_"~"_PHARMMI_"^^^~~~"_LOCSITE_U_PHONE
"RTN","PSORRX1",117,0)
 S @HLARR@(2)="ORC^RF^"_RXNUM_"~"_REMSITE_"~"_$$FQDN^PSORWRAP(,REMSIEN)_"^^^^^^^"_FILLDT_U_DUZ_"~"_PHARMLN_"~"_PHARMFN_"~"_PHARMMI_"^^^~~~"_LOCSITE_U_PHONE
"RTN","PSORRX1",118,0)
 S @HLARR@(3)="RXO^^^^^^^^"_MW_"~~~"_LOCSITE
"RTN","PSORRX1",119,0)
 W !!,"Processing refill request. Please be patient as it may take a moment"
"RTN","PSORRX1",120,0)
 W !,"for the host site to respond and generate your label data..."
"RTN","PSORRX1",121,0)
 ;S PSOHLNK=$O(^HLCS(870,"C",REMSIEN,0))
"RTN","PSORRX1",122,0)
 ;S PSOLNKNM=$$GET1^DIQ(870,PSOHLNK,.01,"E")
"RTN","PSORRX1",123,0)
 ;S RMSDOM=$$GET1^DIQ(870,PSOHLNK,.03,"E")  ; get domain name
"RTN","PSORRX1",124,0)
 ;S RMSDOM=$$GET1^DIQ(4,REMSIEN,60,"E")
"RTN","PSORRX1",125,0)
 ;S:$$PROD^XUPROD() RMSDOM="HL7."_RMSDOM   ; prefix domain name
"RTN","PSORRX1",126,0)
 S RMSDOM=$$FQDN^PSORWRAP(,REMSIEN)
"RTN","PSORRX1",127,0)
 S DOMOVR=REMSITE_"~"_RMSDOM_"~DNS"
"RTN","PSORRX1",128,0)
 S HLP("SUBSCRIBER")="^^^^"_DOMOVR
"RTN","PSORRX1",129,0)
 D DIRECT^HLMA(HLPROT,"GM",1,.RESP,"",.HLP)
"RTN","PSORRX1",130,0)
 D READMSG^PSORRX2(.HLDAT,"RF",LOCDRUG)
"RTN","PSORRX1",131,0)
 K @HLDAT,@HLARR
"RTN","PSORRX1",132,0)
 Q
"RTN","PSORRX1",133,0)
 ; build and send partial fill request
"RTN","PSORRX1",134,0)
PARTIAL() ;
"RTN","PSORRX1",135,0)
 N DIR,DONE,I,PRMPDAT,VAR,PRXNUM,PHARM,PHARMLN,PHARMFN,PHARMMI,PHONE,RXNUM,HLPROT,TFSTRING,HLARR,PHONE,REMSITE,HLDAT,LOCDRUG,EXIT,VAPID,HL,ERR
"RTN","PSORRX1",136,0)
 N PSOHCNT,DONE,PSORRDAT,CSVAL,REMSIEN,PSOHLNK,PSOLNKDN,REMDRUG,Y,DINACT,EXE,DOMOVR,RMSDOM
"RTN","PSORRX1",137,0)
 S HLPROT="PSO REMOTE RX RDS-O13 EVENT"
"RTN","PSORRX1",138,0)
 S HLDAT=$NA(^XTMP("PARTIAL^PSORRX1",$J)) K @HLDAT
"RTN","PSORRX1",139,0)
 S HLARR=$NA(^TMP("HLS",$J)) K @HLARR
"RTN","PSORRX1",140,0)
 D FULL^VALM1
"RTN","PSORRX1",141,0)
 I SRXSTAT'="ACTIVE" W !!,"Only 'ACTIVE' remote prescriptions may be actioned at this time." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",142,0)
 S LOCSITE=$$STA^XUAF4(DUZ(2))
"RTN","PSORRX1",143,0)
 S PHONE=$$GET1^DIQ(200,DUZ,.132,"E")
"RTN","PSORRX1",144,0)
 S PRXNUM=$P(PSOLST(ORN),U,2) I 'PRXNUM S MSG(1)="Invalid Rx #. Please contact technical support." Q
"RTN","PSORRX1",145,0)
 S REMSITE=$P(PSOLST(ORN),U,4)
"RTN","PSORRX1",146,0)
 S REMSIEN=$$FIND1^DIC(4,,"X",REMSITE,"D","I $P(^(0),U,11)=""N"",'$P($G(^(99)),U,4)") Q:'REMSIEN
"RTN","PSORRX1",147,0)
 S DONE=0,CNT=1
"RTN","PSORRX1",148,0)
 ; prompt for fields that would normally be prompted for a local partial fill.
"RTN","PSORRX1",149,0)
 D FULL^VALM1
"RTN","PSORRX1",150,0)
 S REMDRUG=$P(REMDATA,U,11),VAPID=$P(REMDATA,U,10)
"RTN","PSORRX1",151,0)
 I '$L(VAPID) W !!,"Missing VA Product ID. Rx# ",PRXNUM," cannot be refilled." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",152,0)
 S LOCDRUG=$$DRUGMTCH(REMDRUG,VAPID)
"RTN","PSORRX1",153,0)
 I $G(LOCDRUG)=-1 Q  ; user entered no so no reason to prompt again
"RTN","PSORRX1",154,0)
 I '$G(LOCDRUG) W !!,"Could not match remote drug to a local drug.",!,"Cannot complete partial fill for Rx# ",PRXNUM,"." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",155,0)
 S DINACT=$$GET1^DIQ(50,LOCDRUG,100,"I")
"RTN","PSORRX1",156,0)
 I DINACT>0,DINACT<$$NOW^XLFDT W !!,"Matched Drug "_$$GET1^DIQ(50,LOCDRUG,.01,"E")_" is inactive.",!,"Cannot create partial fill request."  S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",157,0)
 ; controlled substance check
"RTN","PSORRX1",158,0)
 S CSVAL=$$GET1^DIQ(50,LOCDRUG,3,"E"),CSVAL=$E(CSVAL,1)
"RTN","PSORRX1",159,0)
 I CSVAL,CSVAL>0,CSVAL<6 W !!,"This is a controlled substance. Cannot refill Rx#",PRXNUM,"." S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",160,0)
 S EXIT=0
"RTN","PSORRX1",161,0)
 S PDATE=DT
"RTN","PSORRX1",162,0)
 S MW="W"
"RTN","PSORRX1",163,0)
 F I=1:1 D  Q:DONE!(EXIT)
"RTN","PSORRX1",164,0)
 .S PRMPDAT=$T(PRMPTXT+I)
"RTN","PSORRX1",165,0)
 .S PRMPDAT=$P(PRMPDAT,";;",2)
"RTN","PSORRX1",166,0)
 .I PRMPDAT="Q" S DONE=1 Q
"RTN","PSORRX1",167,0)
 .K DIR
"RTN","PSORRX1",168,0)
 .S DIR(0)=$P(PRMPDAT,"|"),DIR("A")=$P(PRMPDAT,"|",2),VAR=$P(PRMPDAT,"|",4) S:$L($P(PRMPDAT,"|",3)) DIR("B")=$P(PRMPDAT,"|",3)
"RTN","PSORRX1",169,0)
 .I $G(DIR("B"))["~" D
"RTN","PSORRX1",170,0)
 ..S EXE=$TR(DIR("B"),"~","^") X EXE S DIR("B")=DEF
"RTN","PSORRX1",171,0)
 .D ^DIR
"RTN","PSORRX1",172,0)
 .I Y="^" S EXIT=1 Q
"RTN","PSORRX1",173,0)
 .S @VAR=$S($P(DIR(0),"^")["P":$P(Y,U,2),1:Y)  ;*499
"RTN","PSORRX1",174,0)
 K DEF
"RTN","PSORRX1",175,0)
 I EXIT W !,"Cancelling partial fill request.",! K DIR S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q
"RTN","PSORRX1",176,0)
 ; if we got this far, fill attempt happening and remote worklist
"RTN","PSORRX1",177,0)
 ; needs to be rebuilt when returning so set flag. PSORRBLD was New'ed
"RTN","PSORRX1",178,0)
 ; in calling routine.  May change my mind if we get an error from
"RTN","PSORRX1",179,0)
 ; host
"RTN","PSORRX1",180,0)
 S PSORRBLD=1
"RTN","PSORRX1",181,0)
 S PHARMLN=$P(PHARM,","),PHARMFN=$P($P(PHARM,",",2)," "),PHARMMI=$P($P(PHARM,",",2)," ",2)
"RTN","PSORRX1",182,0)
 D INIT^HLFNC2(HLPROT,.HL)
"RTN","PSORRX1",183,0)
 D BLDPID^PSOTPHL2(DFN,"",.PSORRDAT,.HL,.ERR)
"RTN","PSORRX1",184,0)
 S DONE=0
"RTN","PSORRX1",185,0)
 F PSOHCNT=1:1 D  Q:DONE
"RTN","PSORRX1",186,0)
 .I '$D(PSORRDAT(PSOHCNT)) S DONE=1 Q
"RTN","PSORRX1",187,0)
 .S @HLARR@(1)=$G(@HLARR@(1))_PSORRDAT(PSOHCNT)
"RTN","PSORRX1",188,0)
 ;S @HLARR@(2)="ORC^PF^"_PRXNUM_"~"_REMSITE_"~"_$$GET1^DIQ(4,REMSIEN,60,"E")_"^^^^^^^"_PDATE_"^"_DUZ_"~"_PHARMLN_"~"_PHARMFN_"~"_PHARMMI_"^^^~~~"_LOCSITE_U_PHONE
"RTN","PSORRX1",189,0)
 S @HLARR@(2)="ORC^PF^"_PRXNUM_"~"_REMSITE_"~"_$$FQDN^PSORWRAP(,REMSIEN)_"^^^^^^^"_PDATE_"^"_DUZ_"~"_PHARMLN_"~"_PHARMFN_"~"_PHARMMI_"^^^~~~"_LOCSITE_U_PHONE
"RTN","PSORRX1",190,0)
 S @HLARR@(3)="RXO^1^"_QTY_"^^^^^^"_MW_"~~~"_LOCSITE_"^^^"_DSUPP
"RTN","PSORRX1",191,0)
 S @HLARR@(4)="NTE^1^L^"_REMARKS
"RTN","PSORRX1",192,0)
 W !!,"Processing partial fill request. Please be patient as it may take a moment"
"RTN","PSORRX1",193,0)
 W !,"for the host site to respond and generate your label data...",!
"RTN","PSORRX1",194,0)
 ;S RMSDOM=$$GET1^DIQ(4,REMSIEN,60,"E")
"RTN","PSORRX1",195,0)
 ;S PSOHLNK=$O(^HLCS(870,"C",REMSIEN,0)) ; get first entry (should only be one but you never know)
"RTN","PSORRX1",196,0)
 ;S RMSDOM=$$GET1^DIQ(870,PSOHLNK,.03,"E")  ; get domain name
"RTN","PSORRX1",197,0)
 ;S:$$PROD^XUPROD() RMSDOM="HL7."_RMSDOM   ; prefix domain name
"RTN","PSORRX1",198,0)
 S RMSDOM=$$FQDN^PSORWRAP(,REMSIEN)
"RTN","PSORRX1",199,0)
 S DOMOVR=REMSITE_"~"_RMSDOM_"~DNS"
"RTN","PSORRX1",200,0)
 S HLP("SUBSCRIBER")="^^^^"_DOMOVR
"RTN","PSORRX1",201,0)
 D DIRECT^HLMA(HLPROT,"GM",1,.HL,"",.HLP)
"RTN","PSORRX1",202,0)
 I $P(HL,U,2) D  Q
"RTN","PSORRX1",203,0)
 . W !,"An error was encountered when trying to process the results",!,"from the refill/partial fill request.",!!,$P(HL,U,3)
"RTN","PSORRX1",204,0)
 . K DIR S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR
"RTN","PSORRX1",205,0)
 . D CL
"RTN","PSORRX1",206,0)
 ; clean up variables used
"RTN","PSORRX1",207,0)
 D READMSG^PSORRX2(.HLDAT,"PR",LOCDRUG)
"RTN","PSORRX1",208,0)
CL ;
"RTN","PSORRX1",209,0)
 K PDATE,QTY,DSUPP,PHARM,REMARKS,MW
"RTN","PSORRX1",210,0)
 K @HLDAT,@HLARR
"RTN","PSORRX1",211,0)
 Q
"RTN","PSORRX1",212,0)
 ;
"RTN","PSORRX1",213,0)
DRUGMTCH(DRGNM,VAPID) ;
"RTN","PSORRX1",214,0)
 ; returns -1 if a match was found but user said NO
"RTN","PSORRX1",215,0)
 N LDIEN,MATCH,EXIT,VAPIDSTR,DRL,VAPIEN,VAGENER,FOUND,CHECK,DIC,DRGARY,LDNAME,Y,DRGNM2,VAPSTR,MTCHSTR,DRLCNT
"RTN","PSORRX1",216,0)
 S CHECK=""
"RTN","PSORRX1",217,0)
 S VAPIEN=$O(^PSNDF(50.68,"C",VAPID,0))
"RTN","PSORRX1",218,0)
 I 'VAPIEN Q ""  ; ID from HDR not found - most likely CMOP ID/VA PID mismatch
"RTN","PSORRX1",219,0)
 S VAPSTR=$$GET1^DIQ(50.68,VAPIEN,2,"E")
"RTN","PSORRX1",220,0)
 S VAPIDSTR=$$GET1^DIQ(50.68,VAPIEN,.01,"E")
"RTN","PSORRX1",221,0)
 W !!,"Remote site drug name: "_DRGNM
"RTN","PSORRX1",222,0)
 I $D(^PSDRUG("B",DRGNM)) S LDIEN=$O(^PSDRUG("B",DRGNM,0))
"RTN","PSORRX1",223,0)
 I $D(LDIEN) D
"RTN","PSORRX1",224,0)
 .S LDNAME=$$GET1^DIQ(50,LDIEN,.01,"E")
"RTN","PSORRX1",225,0)
 .W !,"Matching Drug Found for Dispensing: "_LDNAME
"RTN","PSORRX1",226,0)
 .S CHECK=$$DIR
"RTN","PSORRX1",227,0)
 I $D(LDIEN),'CHECK Q -1  ; match was found but user said NO
"RTN","PSORRX1",228,0)
 I $D(LDIEN) Q LDIEN
"RTN","PSORRX1",229,0)
 S VAGENER=$$GET1^DIQ(50.68,VAPIEN,.05,"I")
"RTN","PSORRX1",230,0)
 ; loop through AND index to find drugs associated with this va generic product.
"RTN","PSORRX1",231,0)
 S FOUND=0
"RTN","PSORRX1",232,0)
 S (DRL,DRLCNT)=0 F  S DRL=$O(^PSDRUG("AND",VAGENER,DRL)) Q:'DRL!(FOUND)  D
"RTN","PSORRX1",233,0)
 .S MTCHSTR=$$GET1^DIQ(50,DRL,901,"E")
"RTN","PSORRX1",234,0)
 .I VAPSTR]"" Q:MTCHSTR'=VAPSTR
"RTN","PSORRX1",235,0)
 .S DRGARY(DRL)="",DRLCNT=DRLCNT+1
"RTN","PSORRX1",236,0)
 ; only one match found.
"RTN","PSORRX1",237,0)
 I DRLCNT=1 S LDIEN=$O(DRGARY(0))
"RTN","PSORRX1",238,0)
 I 'DRLCNT W !!,"No local match could be found for "_DRGNM_".",! K DIR S DIR(0)="FO",DIR("A")="Press RETURN to continue" D ^DIR Q -1
"RTN","PSORRX1",239,0)
 I $D(LDIEN) D
"RTN","PSORRX1",240,0)
 .S LDNAME=$$GET1^DIQ(50,LDIEN,.01,"E")
"RTN","PSORRX1",241,0)
 .W !,"Matching Drug Found for Dispensing: "_LDNAME
"RTN","PSORRX1",242,0)
 .S CHECK=$$DIR()
"RTN","PSORRX1",243,0)
 I $D(LDIEN),'CHECK Q -1  ; match was found but user said NO
"RTN","PSORRX1",244,0)
 I $D(LDIEN) Q LDIEN
"RTN","PSORRX1",245,0)
 ; list the items that match strength
"RTN","PSORRX1",246,0)
 S (MATCH,EXIT)=0
"RTN","PSORRX1",247,0)
 N PSODRGL,PSODRGLI,PSODRGL0,PSODRGID,PSODRGC S DIR(0)=""
"RTN","PSORRX1",248,0)
 F PSODRGLI=0:0 S PSODRGLI=$O(DRGARY(PSODRGLI)) Q:'PSODRGLI  D
"RTN","PSORRX1",249,0)
 .S PSODRGL0=$G(^PSDRUG(PSODRGLI,0)),PSODRGID=$G(^PSDRUG(PSODRGLI,"I"))
"RTN","PSORRX1",250,0)
 .Q:$TR(PSODRGL0,"^")=""  S PSODRGC=$G(PSODRGC)+1
"RTN","PSORRX1",251,0)
 .S DIR(0)=DIR(0)_$S(DIR(0)]"":";",1:"")
"RTN","PSORRX1",252,0)
 .S DIR(0)=DIR(0)_$G(PSODRGC)_":"_PSODRGLI_"  "_$E($P(PSODRGL0,"^"),1,30)_"  "_$J($P(PSODRGL0,"^",2),7)_"  "_$S(PSODRGID:$E(PSODRGID,4,5)_"-"_$E(PSODRGID,6,7)_"-"_$E(PSODRGID,2,3)_"  ",1:"")_$P(PSODRGL0,"^",10)
"RTN","PSORRX1",253,0)
 .S DIR("L",PSODRGC)=PSODRGC_".  "_PSODRGLI_"  "_$E($P(PSODRGL0,"^"),1,30)_"  "_$J($P(PSODRGL0,"^",2),7)_"  "_$S(PSODRGID:$E(PSODRGID,4,5)_"-"_$E(PSODRGID,6,7)_"-"_$E(PSODRGID,2,3)_"  ",1:"")_$P(PSODRGL0,"^",10)
"RTN","PSORRX1",254,0)
 S DIR(0)="SO^"_DIR(0),DIR("L")=""  ;1:$G(PSODRGC)"
"RTN","PSORRX1",255,0)
 S DIR("A")="Select matching local drug"
"RTN","PSORRX1",256,0)
 D ^DIR K DIR S:Y="" Y=-1
"RTN","PSORRX1",257,0)
 I Y=-1 Q Y
"RTN","PSORRX1",258,0)
 S LDIEN=+Y(0)
"RTN","PSORRX1",259,0)
 I $G(LDIEN) K DIR S DIR(0)="Y",DIR("A")="Would you like to use this drug" D ^DIR I +Y<0!($D(DUOUT))!($D(DTOUT)) Q -1
"RTN","PSORRX1",260,0)
 Q $G(LDIEN)
"RTN","PSORRX1",261,0)
 ; TEXT to build prompts
"RTN","PSORRX1",262,0)
 ;;DIR(0)|DIR(A)|DIR(B)|VARIABLE
"RTN","PSORRX1",263,0)
PRMPTXT ;
"RTN","PSORRX1",264,0)
 ;;N^^I $D(X),X>$P(REMDATA,U,2) D EN^DDIOL("QTY CANNOT BE GREATER THAN THE ORIGINAL QTY OF "_$P(REMDATA,U,2)) K X|Enter Quantity||QTY
"RTN","PSORRX1",265,0)
 ;;N|DAYS SUPPLY||DSUPP
"RTN","PSORRX1",266,0)
 ;;P^200:QEAMZ|Select PHARMACIST Name|S DEF=$$GET1~DIQ(200,DUZ,.01,"E")|PHARM
"RTN","PSORRX1",267,0)
 ;;F^0:60|REMARKS||REMARKS
"RTN","PSORRX1",268,0)
 ;;Q
"RTN","PSORRX1",269,0)
 Q
"RTN","PSORRX1",270,0)
DIR() ;
"RTN","PSORRX1",271,0)
 N DIR,Y
"RTN","PSORRX1",272,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","PSORRX1",273,0)
 S DIR("A",1)="Would you like to use the system matched drug for this"
"RTN","PSORRX1",274,0)
 S DIR("A")="refill/partial fill"
"RTN","PSORRX1",275,0)
 D ^DIR
"RTN","PSORRX1",276,0)
 Q Y
"RTN","PSORRX1",277,0)
POST ; post init for PSO*7*454
"RTN","PSORRX1",278,0)
 N LIEN,OPSITE,DOMAIN,VAL
"RTN","PSORRX1",279,0)
 ; add TCP/IP address for EMI
"RTN","PSORRX1",280,0)
 ;S DOMAIN=$$GET1^DIQ(4,DUZ(2),60,"E")
"RTN","PSORRX1",281,0)
 S DOMAIN=$$FQDN^PSORWRAP(,DUZ(2))
"RTN","PSORRX1",282,0)
 S VAL="PSORRXSEND"
"RTN","PSORRX1",283,0)
 S LIEN=$$FIND1^DIC(870,,"B",.VAL) Q:'LIEN
"RTN","PSORRX1",284,0)
 S FDA(870,LIEN_",",.08)=DOMAIN
"RTN","PSORRX1",285,0)
 S FDA(870,LIEN_",",400.01)="vaaussoalebp2.aac.domain.ext" D FILE^DIE(,"FDA") K FDA
"RTN","PSORRX1",286,0)
 ; turn off the OneVA Pharmacy flag for all outpatient sites.
"RTN","PSORRX1",287,0)
 S OPSITE=0 F  S OPSITE=$O(^PS(59,OPSITE)) Q:'OPSITE  D
"RTN","PSORRX1",288,0)
 .S FDA(59,OPSITE_",",3001)="" D FILE^DIE(,"FDA") K FDA
"RTN","PSORRX1",289,0)
 Q
"RTN","PSORXVW1")
0^2^B74497358^B71633557
"RTN","PSORXVW1",1,0)
PSORXVW1 ;BIR/SAB - view prescription con't ;12/4/07 12:28pm
"RTN","PSORXVW1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**35,47,46,71,99,117,156,193,210,148,258,260,240,281,359,354,367,386,408,427,499**;DEC 1997;Build 8
"RTN","PSORXVW1",3,0)
 ;External reference to ^DD(52 supported by DBIA 999
"RTN","PSORXVW1",4,0)
 ;External reference to ^VA(200 supported by DBIA 10060
"RTN","PSORXVW1",5,0)
 ;PSO*210 add call to WORDWRAP api
"RTN","PSORXVW1",6,0)
 ;
"RTN","PSORXVW1",7,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",6) D
"RTN","PSORXVW1",8,0)
 .K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=$P(^PSRX(RXN,"OR1"),"^",6) D ^DIC
"RTN","PSORXVW1",9,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="           Filled By: "_$P(Y,"^",2) K DIC,X,Y
"RTN","PSORXVW1",10,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",7) D
"RTN","PSORXVW1",11,0)
 .K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=$P(^PSRX(RXN,"OR1"),"^",7) D ^DIC
"RTN","PSORXVW1",12,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="          Checked By: "_$P(Y,"^",2) K DIC,X,Y
"RTN","PSORXVW1",13,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=$P(RX0,"^",16) D ^DIC
"RTN","PSORXVW1",14,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="   Entry By: "_$P(Y,"^",2)_$E(RN,$L($P(Y,"^",2))+1,35)
"RTN","PSORXVW1",15,0)
 S Y=$P(RX2,"^") X ^DD("DD")
"RTN","PSORXVW1",16,0)
 S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"Entry Date: "_$E($P(RX2,"^"),4,5)_"/"_$E($P(RX2,"^"),6,7)_"/"_$E($P(RX2,"^"),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSORXVW1",17,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" " ;,IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSORXVW1",18,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Original Fill Released: " I $P(RX2,"^",13) S DTT=$P(RX2,"^",13) D DAT S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_DAT K DAT,DTT
"RTN","PSORXVW1",19,0)
 I $P(RX2,"^",15) S DTT=$P(RX2,"^",15) D DAT S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"(Returned to Stock "_DAT_")" K DAT,DTT
"RTN","PSORXVW1",20,0)
 S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"      Routing: "_$S($P(RX0,"^",11)="W":"Window",1:"Mail")
"RTN","PSORXVW1",21,0)
 I $G(^PSRX(DA,"H"))]"",$P(^("STA"),"^")=3 D HLD
"RTN","PSORXVW1",22,0)
 D RF,PAR,ACT,COPAY^PSORXVW2,LBL,ECME^PSOORAL1,SPMP^PSOORAL1,^PSORXVW2:$O(^PSRX(DA,4,0))
"RTN","PSORXVW1",23,0)
 Q
"RTN","PSORXVW1",24,0)
ACT ;activity log
"RTN","PSORXVW1",25,0)
 N CNT
"RTN","PSORXVW1",26,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Activity Log:"
"RTN","PSORXVW1",27,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#   Date        Reason         Rx Ref         Initiator Of Activity",IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSORXVW1",28,0)
 I '$O(^PSRX(DA,"A",0)) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There's NO Activity to report" Q
"RTN","PSORXVW1",29,0)
 S CNT=0
"RTN","PSORXVW1",30,0)
 F N=0:0 S N=$O(^PSRX(DA,"A",N)) Q:'N  S P1=^(N,0),DTT=P1\1 D DAT D
"RTN","PSORXVW1",31,0)
 .I $P(P1,"^",2)="M" Q
"RTN","PSORXVW1",32,0)
 .S IEN=IEN+1,CNT=CNT+1,^TMP("PSOAL",$J,IEN,0)=CNT_"   "_DAT_"    ",$P(RN," ",15)=" ",REA=$P(P1,"^",2)
"RTN","PSORXVW1",33,0)
 .S REA=$F("HUCELPRWSIVDABXGKNM",REA)-1
"RTN","PSORXVW1",34,0)
 .I REA D
"RTN","PSORXVW1",35,0)
 ..S STA=$P("HOLD^UNHOLD^DISCONTINUED^EDIT^RENEWED^PARTIAL^REINSTATE^REPRINT^SUSPENSE^RETURNED^INTERVENTION^DELETED^DRUG INTERACTION^PROCESSED^X-INTERFACE^PATIENT INSTR.^PKI/DEA^DISP COMPLETED^ECME^","^",REA)
"RTN","PSORXVW1",36,0)
 ..S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_STA_$E(RN,$L(STA)+1,15)
"RTN","PSORXVW1",37,0)
 .E  S $P(STA," ",15)=" ",^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_STA
"RTN","PSORXVW1",38,0)
 .K STA,RN S $P(RN," ",15)=" ",RF=+$P(P1,"^",4)
"RTN","PSORXVW1",39,0)
 .S RFT=$S(RF>0&(RF<6):"REFILL "_RF,RF=6:"PARTIAL",RF>6:"REFILL "_(RF-1),1:"ORIGINAL")
"RTN","PSORXVW1",40,0)
 .K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=$P(P1,"^",3) D ^DIC
"RTN","PSORXVW1",41,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_RFT_$E(RN,$L(RFT)+1,15)_$S(+Y:$P(Y,"^",2),1:$P(P1,"^",3))
"RTN","PSORXVW1",42,0)
 .;S:$P(P1,"^",5)]"" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Comments: "_$P(P1,"^",5)
"RTN","PSORXVW1",43,0)
 .I $P(P1,"^",5)]"" N PSOACBRK,PSOACBRV D
"RTN","PSORXVW1",44,0)
 ..S PSOACBRV=$P(P1,"^",5)
"RTN","PSORXVW1",45,0)
 ..;PSO*7*240 Use fileman to format
"RTN","PSORXVW1",46,0)
 ..K ^UTILITY($J,"W") S X="Comments: "_PSOACBRV,(DIWR,DIWL)=1,DIWF="C80" D ^DIWP F I=1:1:^UTILITY($J,"W",1) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=$G(^UTILITY($J,"W",1,I,0))
"RTN","PSORXVW1",47,0)
 .I $G(^PSRX(DA,"A",N,1))]"" S IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0)," ",5)=$P(^PSRX(DA,"A",N,1),"^") I $P(^PSRX(DA,"A",N,1),"^",2)]"" S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_":"_$P(^PSRX(DA,"A",N,1),"^",2)
"RTN","PSORXVW1",48,0)
 .I $O(^PSRX(DA,"A",N,2,0)) F I=0:0 S I=$O(^PSRX(RXN,"A",N,2,I)) Q:'I  S MIG=^PSRX(RXN,"A",N,2,I,0) D
"RTN","PSORXVW1",49,0)
 ..S:MIG["Mail Tracking Info.: " IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0)," ",9)=" "
"RTN","PSORXVW1",50,0)
 ..F SG=1:1:$L(MIG) S:$L(^TMP("PSOAL",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0)," ",9)=" " S:$P(MIG," ",SG)'="" ^TMP("PSOAL",$J,IEN,0)=$G(^TMP("PSOAL",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSORXVW1",51,0)
 K MIG,SG,I,^UTILITY($J,"W"),DIWF,DIWL,DIWR
"RTN","PSORXVW1",52,0)
 Q
"RTN","PSORXVW1",53,0)
LBL ;label log
"RTN","PSORXVW1",54,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Label Log:"
"RTN","PSORXVW1",55,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#   Date        Rx Ref                    Printed By",IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSORXVW1",56,0)
 I '$O(^PSRX(DA,"L",0)) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There are NO Labels printed." Q
"RTN","PSORXVW1",57,0)
 F L1=0:0 S L1=$O(^PSRX(DA,"L",L1)) Q:'L1  S LBL=^PSRX(DA,"L",L1,0),DTT=$P(^(0),"^") D DAT D
"RTN","PSORXVW1",58,0)
 . S $P(RN," ",26)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=L1_"   "_DAT_"    ",RFT=$S($P(LBL,"^",2):"REFILL "_$P(LBL,"^",2),1:"ORIGINAL"),RFT=RFT_$E(RN,$L(RFT)+1,26)
"RTN","PSORXVW1",59,0)
 . K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=$P(LBL,"^",4) D ^DIC
"RTN","PSORXVW1",60,0)
 . S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_RFT_$P(Y,"^",2),IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Comments: "_$P(LBL,"^",3)
"RTN","PSORXVW1",61,0)
 . N FDAMGDOC S FDAMGDOC=$P($G(^PSRX(DA,"L",L1,"FDA")),"^")
"RTN","PSORXVW1",62,0)
 . I FDAMGDOC'="" D
"RTN","PSORXVW1",63,0)
 . . S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="FDA Med Guide: "_$E(FDAMGDOC,1,61)
"RTN","PSORXVW1",64,0)
 . . I $L(FDAMGDOC)>61 D
"RTN","PSORXVW1",65,0)
 . . . F  Q:$E(FDAMGDOC,62,999)=""  D
"RTN","PSORXVW1",66,0)
 . . . . S FDAMGDOC=$E(FDAMGDOC,62,999),IEN=IEN+1
"RTN","PSORXVW1",67,0)
 . . . . S ^TMP("PSOAL",$J,IEN,0)=$E(FDAMGDOC,1,61)
"RTN","PSORXVW1",68,0)
 K DIC,X,Y Q
"RTN","PSORXVW1",69,0)
 ;
"RTN","PSORXVW1",70,0)
RF ;refill log
"RTN","PSORXVW1",71,0)
 N PSORFI ;*499
"RTN","PSORXVW1",72,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Refill Log:"
"RTN","PSORXVW1",73,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#  Log Date   Refill Date  Qty               Routing  Lot #       Pharmacist",IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSORXVW1",74,0)
 S (RF,PL)=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S PL=PL+1
"RTN","PSORXVW1",75,0)
 I 'PL S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There are NO Refills For this  Prescription" Q
"RTN","PSORXVW1",76,0)
 F N=0:0 S N=$O(^PSRX(DA,1,N)) Q:'N  S P1=^(N,0),PSORFI=$G(^PSRX(DA,1,N,"RF")) D
"RTN","PSORXVW1",77,0)
 .S DTT=$P(P1,"^",8)\1 D DAT S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=N_"   "_DAT_"   "
"RTN","PSORXVW1",78,0)
 .S DTT=$P(P1,"^"),$P(RN," ",10)=" " D DAT
"RTN","PSORXVW1",79,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_DAT_"     "_$P(P1,"^",4)_$E("               ",$L($P(P1,"^",4))+1,15)_"  "_$S($P(P1,"^",2)="M":"Mail",1:"Window")_" "_$P(P1,"^",6)_$E(RN,$L($P(P1,"^",6))+1,12)
"RTN","PSORXVW1",80,0)
 .K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+$P(P1,"^",5) D ^DIC
"RTN","PSORXVW1",81,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_$E($S($P(PSORFI,"^",2)]"":$P(PSORFI,"^",2),+Y:$P(Y,"^",2),1:""),1,16) K DIC,X,Y
"RTN","PSORXVW1",82,0)
 .S PSDIV=$S(+PSORFI:+PSORFI,$D(^PS(59,+$P(P1,"^",9),0)):$P(^(0),"^",6),1:"Unknown"),IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Division: "_PSDIV_$E("        ",$L(PSDIV)+1,8)_"  "
"RTN","PSORXVW1",83,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"Dispensed: "_$S($P(P1,"^",19):$E($P(P1,"^",19),4,5)_"/"_$E($P(P1,"^",19),6,7)_"/"_$E($P(P1,"^",19),2,3),1:"")_"  "
"RTN","PSORXVW1",84,0)
 .S RTS=$S($P(P1,"^",16):" Returned to Stock: "_$E($P(P1,"^",16),4,5)_"/"_$E($P(P1,"^",16),6,7)_"/"_$E($P(P1,"^",16),2,3),1:" Released: "_$S($$RXRLDT^PSOBPSUT(DA,N):$$FMTE^XLFDT($$RXRLDT^PSOBPSUT(DA,N)\1,2),1:""))
"RTN","PSORXVW1",85,0)
 .;Always display the NDC# - PSO*427
"RTN","PSORXVW1",86,0)
 .S RTS=RTS_"  NDC: "_$$GETNDC^PSONDCUT(DA,N)
"RTN","PSORXVW1",87,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_RTS
"RTN","PSORXVW1",88,0)
 .S:$P(P1,"^",3)]"" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="   Remarks: "_$P(P1,"^",3)
"RTN","PSORXVW1",89,0)
 K RTS Q
"RTN","PSORXVW1",90,0)
PAR ;partial log
"RTN","PSORXVW1",91,0)
 N PSOPFI
"RTN","PSORXVW1",92,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Partial Fills:"
"RTN","PSORXVW1",93,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#   Log Date   Date     Qty              Routing    Lot #        Pharmacist",IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSORXVW1",94,0)
 I '$O(^PSRX(DA,"P",0)) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There are NO Partials for this Prescription" Q
"RTN","PSORXVW1",95,0)
 S N=0 F  S N=$O(^PSRX(DA,"P",N)) Q:'N  S P1=^(N,0),DTT=$P(P1,"^",8)\1,PSOPFI=$G(^PSRX(DA,"P",N,"PF")) D DAT D
"RTN","PSORXVW1",96,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=N_"   "_DAT_"  ",QTY=$P(P1,"^",4)_$E("               ",$L($P(P1,"^",4))+1,15)
"RTN","PSORXVW1",97,0)
 .S DTT=$P(P1,"^") D DAT S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_DAT_"  "_QTY_"  "
"RTN","PSORXVW1",98,0)
 .S PSDIV=$S(+PSOPFI:+PSOPFI,$D(^PS(59,+$P(P1,"^",9),0)):$P(^(0),"^",6),1:"UNKNOWN"),PSDIV=PSDIV_$E("        ",$L(PSDIV)+1,8)  ;*499
"RTN","PSORXVW1",99,0)
 .S MW=$S($P(P1,"^",2)="M":"Mail",1:"Window"),MW=MW_$E("          ",$L(MW)+1,10)
"RTN","PSORXVW1",100,0)
 .K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+$P(P1,"^",16) D ^DIC
"RTN","PSORXVW1",101,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_MW_"  "_$P(P1,"^",6)_$E("            ",$L($P(P1,"^",6))+1,10)_$E($S($P(PSOPFI,"^",2)]"":$P(PSOPFI,"^",2),+Y:$P(Y,"^",2),1:""),1,16)  ;*499
"RTN","PSORXVW1",102,0)
 .S RTS=$S($P(P1,"^",16):" RETURNED TO STOCK: "_$E($P(P1,"^",16),4,5)_"/"_$E($P(P1,"^",16),6,7)_"/"_$E($P(P1,"^",16),2,3),1:" RELEASED: "_$S($P(P1,"^",19):$E($P(P1,"^",19),4,5)_"/"_$E($P(P1,"^",19),6,7)_"/"_$E($P(P1,"^",19),2,3),1:""))
"RTN","PSORXVW1",103,0)
 .K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=$P(P1,"^",7) D ^DIC
"RTN","PSORXVW1",104,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Division: "_PSDIV_" "_RTS ;_"      Entry By: "_$P(Y,"^",2) K DIC,X,Y
"RTN","PSORXVW1",105,0)
 .S:$P(P1,"^",3)]"" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="  REMARKS: "_$P(P1,"^",3) K RTS
"RTN","PSORXVW1",106,0)
 Q
"RTN","PSORXVW1",107,0)
HLD ;hold info
"RTN","PSORXVW1",108,0)
 S DTT=$P(^PSRX(DA,"H"),"^",3) D DAT S HLDR=$$GET1^DIQ(52,DA,99)
"RTN","PSORXVW1",109,0)
 S $P(RN," ",60)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Hold Reason: "_HLDR_$E(RN,$L("Hold Reason: "_HLDR)+1,60)_"Hold Date: "_DAT
"RTN","PSORXVW1",110,0)
 I $P($G(^PSRX(DA,"H")),"^",2)]"" D
"RTN","PSORXVW1",111,0)
 . N HLDCOMM S HLDCOMM=$P(^PSRX(DA,"H"),"^",2)
"RTN","PSORXVW1",112,0)
 . S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Hold Comments: "_$E(HLDCOMM,1,65),HLDCOMM=$E(HLDCOMM,66,999)
"RTN","PSORXVW1",113,0)
 . F  Q:HLDCOMM=""  D
"RTN","PSORXVW1",114,0)
 . . S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="               "_$E(HLDCOMM,1,65),HLDCOMM=$E(HLDCOMM,66,999)
"RTN","PSORXVW1",115,0)
 K RN,DAT,DTT,HLDR
"RTN","PSORXVW1",116,0)
 Q
"RTN","PSORXVW1",117,0)
DAT S DAT="",DTT=DTT\1 Q:DTT'?7N  S DAT=$E(DTT,4,5)_"/"_$E(DTT,6,7)_"/"_$E(DTT,2,3)
"RTN","PSORXVW1",118,0)
 Q
"RTN","PSORXVW1",119,0)
INST ;formats instruction from front door
"RTN","PSORXVW1",120,0)
 I $O(^PSRX(DA,"PI",0)) D
"RTN","PSORXVW1",121,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="        Instructions:"
"RTN","PSORXVW1",122,0)
 .S T=0 F  S T=$O(^PSRX(RXN,"PI",T)) Q:'T  D                  ;PSO*210
"RTN","PSORXVW1",123,0)
 ..S MIG=^PSRX(RXN,"PI",T,0)
"RTN","PSORXVW1",124,0)
 ..D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAL",$J)),21)
"RTN","PSORXVW1",125,0)
 K T,TY,MIG,SG
"RTN","PSORXVW1",126,0)
 Q
"RTN","PSORXVW1",127,0)
PC ;displays provider comments
"RTN","PSORXVW1",128,0)
 I $O(^PSRX(DA,"PRC",0)) D
"RTN","PSORXVW1",129,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="   Provider Comments:"
"RTN","PSORXVW1",130,0)
 .S T=0 F  S T=$O(^PSRX(RXN,"PRC",T)) Q:'T  D                 ;PSO*210
"RTN","PSORXVW1",131,0)
 ..S MIG=^PSRX(RXN,"PRC",T,0)
"RTN","PSORXVW1",132,0)
 ..D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAL",$J)),21)
"RTN","PSORXVW1",133,0)
 K T,TY,MIG,SG
"RTN","PSORXVW1",134,0)
 Q
"RTN","PSORXVW1",135,0)
DOSE ;displays dosing instruction for both simple and complex Rxs.
"RTN","PSORXVW1",136,0)
 D DOSE^PSORXVW2
"RTN","PSORXVW1",137,0)
 Q
"RTN","PSORXVW1",138,0)
 ;
"RTN","PSORXVW1",139,0)
HLP ; Help Text for the VIEW PRESCRIPTION prompt
"RTN","PSORXVW1",140,0)
 W !," A prescription number or ECME number may be entered.  To look-up a"
"RTN","PSORXVW1",141,0)
 W !," prescription by the ECME number, please enter ""E."" followed by the ECME"
"RTN","PSORXVW1",142,0)
 W !," number with or without any leading zeros."
"RTN","PSORXVW1",143,0)
 W !!,"  Or just",!
"RTN","PSORXVW1",144,0)
 D LKP("?")
"RTN","PSORXVW1",145,0)
 Q 
"RTN","PSORXVW1",146,0)
 ;
"RTN","PSORXVW1",147,0)
LKP(INPUT) ; - Peforms Lookup on the PRESCRIPTION file
"RTN","PSORXVW1",148,0)
 N DIC,X,Y
"RTN","PSORXVW1",149,0)
 S DIC="^PSRX(",DIC(0)="QE",D="B",X=INPUT
"RTN","PSORXVW1",150,0)
 S DIC("S")="I $P($G(^(0)),""^"",2),$D(^(""STA"")),$P($G(^(""STA"")),""^"")'=13"
"RTN","PSORXVW1",151,0)
 D IX^DIC
"RTN","PSORXVW1",152,0)
 Q Y
"VER")
8.0^22.2
"BLD",10708,6)
^419
**END**
**END**

