EMERGENCY Released PSO*7*520 SEQ #430
Extracted from mail message
**KIDS**:PSO*7.0*520^

**INSTALL NAME**
PSO*7.0*520
"BLD",9931,0)
PSO*7.0*520^OUTPATIENT PHARMACY^0^3180330^y
"BLD",9931,4,0)
^9.64PA^52.49^2
"BLD",9931,4,52.46,0)
52.46
"BLD",9931,4,52.46,2,0)
^9.641^52.46^1
"BLD",9931,4,52.46,2,52.46,0)
ERX EXTERNAL PATIENT  (File-top level)
"BLD",9931,4,52.46,2,52.46,1,0)
^9.6411^.07^1
"BLD",9931,4,52.46,2,52.46,1,.07,0)
GENDER
"BLD",9931,4,52.46,222)
y^y^p^^^^n^^n
"BLD",9931,4,52.46,224)

"BLD",9931,4,52.49,0)
52.49
"BLD",9931,4,52.49,2,0)
^9.641^52.4972^3
"BLD",9931,4,52.49,2,52.49,0)
ERX HOLDING QUEUE  (File-top level)
"BLD",9931,4,52.49,2,52.49,1,0)
^9.6411^70.7^7
"BLD",9931,4,52.49,2,52.49,1,70.1,0)
FACILITY NAME
"BLD",9931,4,52.49,2,52.49,1,70.2,0)
FACILITY ADDRESS LINE 1
"BLD",9931,4,52.49,2,52.49,1,70.3,0)
FACILITY ADDRESS LINE 2
"BLD",9931,4,52.49,2,52.49,1,70.4,0)
FACILITY CITY
"BLD",9931,4,52.49,2,52.49,1,70.5,0)
FACILITY STATE
"BLD",9931,4,52.49,2,52.49,1,70.6,0)
FACILITY ZIP CODE
"BLD",9931,4,52.49,2,52.49,1,70.7,0)
PLACE LOCATION QUALIFIER
"BLD",9931,4,52.49,2,52.4971,0)
FACILITY IDENTIFICATION  (sub-file)
"BLD",9931,4,52.49,2,52.4971,1,0)
^9.6411^.02^2
"BLD",9931,4,52.49,2,52.4971,1,.01,0)
ID TYPE
"BLD",9931,4,52.49,2,52.4971,1,.02,0)
ID VALUE
"BLD",9931,4,52.49,2,52.4972,0)
COMMUNICATION  (sub-file)
"BLD",9931,4,52.49,2,52.4972,1,0)
^9.6411^.02^2
"BLD",9931,4,52.49,2,52.4972,1,.01,0)
COMMUNICATION
"BLD",9931,4,52.49,2,52.4972,1,.02,0)
TYPE
"BLD",9931,4,52.49,222)
y^y^p^^^^n^^n
"BLD",9931,4,52.49,224)

"BLD",9931,4,"APDD",52.46,52.46)

"BLD",9931,4,"APDD",52.46,52.46,.07)

"BLD",9931,4,"APDD",52.49,52.49)

"BLD",9931,4,"APDD",52.49,52.49,70.1)

"BLD",9931,4,"APDD",52.49,52.49,70.2)

"BLD",9931,4,"APDD",52.49,52.49,70.3)

"BLD",9931,4,"APDD",52.49,52.49,70.4)

"BLD",9931,4,"APDD",52.49,52.49,70.5)

"BLD",9931,4,"APDD",52.49,52.49,70.6)

"BLD",9931,4,"APDD",52.49,52.49,70.7)

"BLD",9931,4,"APDD",52.49,52.4971)

"BLD",9931,4,"APDD",52.49,52.4971,.01)

"BLD",9931,4,"APDD",52.49,52.4971,.02)

"BLD",9931,4,"APDD",52.49,52.4972)

"BLD",9931,4,"APDD",52.49,52.4972,.01)

"BLD",9931,4,"APDD",52.49,52.4972,.02)

"BLD",9931,4,"B",52.46,52.46)

"BLD",9931,4,"B",52.49,52.49)

"BLD",9931,6.3)
52
"BLD",9931,"INID")
^n
"BLD",9931,"INIT")
PSO520PO
"BLD",9931,"KRN",0)
^9.67PA^779.2^20
"BLD",9931,"KRN",.4,0)
.4
"BLD",9931,"KRN",.401,0)
.401
"BLD",9931,"KRN",.402,0)
.402
"BLD",9931,"KRN",.403,0)
.403
"BLD",9931,"KRN",.5,0)
.5
"BLD",9931,"KRN",.84,0)
.84
"BLD",9931,"KRN",3.6,0)
3.6
"BLD",9931,"KRN",3.8,0)
3.8
"BLD",9931,"KRN",9.2,0)
9.2
"BLD",9931,"KRN",9.8,0)
9.8
"BLD",9931,"KRN",9.8,"NM",0)
^9.68A^14^13
"BLD",9931,"KRN",9.8,"NM",1,0)
PSOERXX1^^0^B45537071
"BLD",9931,"KRN",9.8,"NM",2,0)
PSOERX1^^0^B78113313
"BLD",9931,"KRN",9.8,"NM",3,0)
PSOERX1C^^0^B40751092
"BLD",9931,"KRN",9.8,"NM",4,0)
PSOERXP1^^0^B27447625
"BLD",9931,"KRN",9.8,"NM",5,0)
PSOERXR1^^0^B31327096
"BLD",9931,"KRN",9.8,"NM",6,0)
PSOERXD1^^0^B127051416
"BLD",9931,"KRN",9.8,"NM",8,0)
PSOERX1B^^0^B154507607
"BLD",9931,"KRN",9.8,"NM",9,0)
PSOERXA1^^0^B233267035
"BLD",9931,"KRN",9.8,"NM",10,0)
PSOERXA2^^0^B104569280
"BLD",9931,"KRN",9.8,"NM",11,0)
PSOERXU1^^0^B88661299
"BLD",9931,"KRN",9.8,"NM",12,0)
PSOERXU4^^0^B35485114
"BLD",9931,"KRN",9.8,"NM",13,0)
PSOERXD2^^0^B211196189
"BLD",9931,"KRN",9.8,"NM",14,0)
PSOERXO1^^0^B64732722
"BLD",9931,"KRN",9.8,"NM","B","PSOERX1",2)

"BLD",9931,"KRN",9.8,"NM","B","PSOERX1B",8)

"BLD",9931,"KRN",9.8,"NM","B","PSOERX1C",3)

"BLD",9931,"KRN",9.8,"NM","B","PSOERXA1",9)

"BLD",9931,"KRN",9.8,"NM","B","PSOERXA2",10)

"BLD",9931,"KRN",9.8,"NM","B","PSOERXD1",6)

"BLD",9931,"KRN",9.8,"NM","B","PSOERXD2",13)

"BLD",9931,"KRN",9.8,"NM","B","PSOERXO1",14)

"BLD",9931,"KRN",9.8,"NM","B","PSOERXP1",4)

"BLD",9931,"KRN",9.8,"NM","B","PSOERXR1",5)

"BLD",9931,"KRN",9.8,"NM","B","PSOERXU1",11)

"BLD",9931,"KRN",9.8,"NM","B","PSOERXU4",12)

"BLD",9931,"KRN",9.8,"NM","B","PSOERXX1",1)

"BLD",9931,"KRN",19,0)
19
"BLD",9931,"KRN",19,"NM",0)
^9.68A^^
"BLD",9931,"KRN",19.1,0)
19.1
"BLD",9931,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",9931,"KRN",101,0)
101
"BLD",9931,"KRN",409.61,0)
409.61
"BLD",9931,"KRN",771,0)
771
"BLD",9931,"KRN",779.2,0)
779.2
"BLD",9931,"KRN",870,0)
870
"BLD",9931,"KRN",8989.51,0)
8989.51
"BLD",9931,"KRN",8989.52,0)
8989.52
"BLD",9931,"KRN",8994,0)
8994
"BLD",9931,"KRN","B",.4,.4)

"BLD",9931,"KRN","B",.401,.401)

"BLD",9931,"KRN","B",.402,.402)

"BLD",9931,"KRN","B",.403,.403)

"BLD",9931,"KRN","B",.5,.5)

"BLD",9931,"KRN","B",.84,.84)

"BLD",9931,"KRN","B",3.6,3.6)

"BLD",9931,"KRN","B",3.8,3.8)

"BLD",9931,"KRN","B",9.2,9.2)

"BLD",9931,"KRN","B",9.8,9.8)

"BLD",9931,"KRN","B",19,19)

"BLD",9931,"KRN","B",19.1,19.1)

"BLD",9931,"KRN","B",101,101)

"BLD",9931,"KRN","B",409.61,409.61)

"BLD",9931,"KRN","B",771,771)

"BLD",9931,"KRN","B",779.2,779.2)

"BLD",9931,"KRN","B",870,870)

"BLD",9931,"KRN","B",8989.51,8989.51)

"BLD",9931,"KRN","B",8989.52,8989.52)

"BLD",9931,"KRN","B",8994,8994)

"BLD",9931,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9931,"QUES",0)
^9.62^^
"BLD",9931,"REQB",0)
^9.611^3^3
"BLD",9931,"REQB",1,0)
PSO*7.0*467^2
"BLD",9931,"REQB",2,0)
PSO*7.0*506^2
"BLD",9931,"REQB",3,0)
PSO*7.0*500^2
"BLD",9931,"REQB","B","PSO*7.0*467",1)

"BLD",9931,"REQB","B","PSO*7.0*500",3)

"BLD",9931,"REQB","B","PSO*7.0*506",2)

"FIA",52.46)
ERX EXTERNAL PATIENT
"FIA",52.46,0)
^PS(52.46,
"FIA",52.46,0,0)
52.46I
"FIA",52.46,0,1)
y^y^p^^^^n^^n
"FIA",52.46,0,10)

"FIA",52.46,0,11)

"FIA",52.46,0,"RLRO")

"FIA",52.46,0,"VR")
7.0^PSO
"FIA",52.46,52.46)
1
"FIA",52.46,52.46,.07)

"FIA",52.49)
ERX HOLDING QUEUE
"FIA",52.49,0)
^PS(52.49,
"FIA",52.49,0,0)
52.49
"FIA",52.49,0,1)
y^y^p^^^^n^^n
"FIA",52.49,0,10)

"FIA",52.49,0,11)

"FIA",52.49,0,"RLRO")

"FIA",52.49,0,"VR")
7.0^PSO
"FIA",52.49,52.49)
1
"FIA",52.49,52.49,70.1)

"FIA",52.49,52.49,70.2)

"FIA",52.49,52.49,70.3)

"FIA",52.49,52.49,70.4)

"FIA",52.49,52.49,70.5)

"FIA",52.49,52.49,70.6)

"FIA",52.49,52.49,70.7)

"FIA",52.49,52.49,71)

"FIA",52.49,52.49,72)

"FIA",52.49,52.4971)
1
"FIA",52.49,52.4971,.01)

"FIA",52.49,52.4971,.02)

"FIA",52.49,52.4972)
1
"FIA",52.49,52.4972,.01)

"FIA",52.49,52.4972,.02)

"INIT")
PSO520PO
"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
520^3180330
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
14
"RTN","PSO520PO")
0^^B4838824^n/a
"RTN","PSO520PO",1,0)
PSO520PO ;ALB/BLB - eRx utilities ; 3/29/2018 4:00pm
"RTN","PSO520PO",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**520**;DEC 1997;Build 52
"RTN","PSO520PO",3,0)
 ;
"RTN","PSO520PO",4,0)
 N EIEN,IENS,QIEN,ODOSORD,NEWDOSE,ONOUND,ODOSE,FDA,POO,POQIEN,POQIENS,PO,PODOSE,PONOUN,PODOSORD,DOSORD,ONOUN
"RTN","PSO520PO",5,0)
 N PNEWDOSE,PFDA
"RTN","PSO520PO",6,0)
 D EN^DDIOL("Correcting dosing data for inbound electronic prescriptions")
"RTN","PSO520PO",7,0)
 D EN^DDIOL("and pending outpatient orders. Please be patient.")
"RTN","PSO520PO",8,0)
 S EIEN=0 F  S EIEN=$O(^PS(52.49,EIEN)) Q:'EIEN  D
"RTN","PSO520PO",9,0)
 .S QIEN=0 F  S QIEN=$O(^PS(52.49,EIEN,21,QIEN)) Q:'QIEN  D
"RTN","PSO520PO",10,0)
 ..S IENS=QIEN_","_EIEN_","
"RTN","PSO520PO",11,0)
 ..I $$GET1^DIQ(52.4921,IENS,.01)'="&" Q
"RTN","PSO520PO",12,0)
 ..S ODOSORD=$$GET1^DIQ(52.4921,IENS,9,"E")
"RTN","PSO520PO",13,0)
 ..S ODOSE=$$GET1^DIQ(52.4921,IENS,8,"E")
"RTN","PSO520PO",14,0)
 ..S ONOUN=$$GET1^DIQ(52.4921,IENS,12,"E")
"RTN","PSO520PO",15,0)
 ..I ODOSORD]"" S NEWDOSE=ODOSORD_"&"_ONOUN,FDA(52.4921,IENS,.01)=NEWDOSE D FILE^DIE(,"FDA") K FDA Q
"RTN","PSO520PO",16,0)
 ..S NEWDOSE=ODOSE,FDA(52.4921,IENS,.01)=NEWDOSE D FILE^DIE(,"FDA") K FDA Q
"RTN","PSO520PO",17,0)
 .S POO=$$GET1^DIQ(52.49,EIEN,25.2,"I") I 'POO Q
"RTN","PSO520PO",18,0)
 .I '$D(^PS(52.41,POO)) Q
"RTN","PSO520PO",19,0)
 .S POQIEN=0 F  S POQIEN=$O(^PS(52.41,POO,1,POQIEN)) Q:'POQIEN  D
"RTN","PSO520PO",20,0)
 ..S POQIENS=POQIEN_","_POO_","
"RTN","PSO520PO",21,0)
 ..I $$GET1^DIQ(52.413,POQIENS,.01)'="&" Q
"RTN","PSO520PO",22,0)
 ..S PODOSORD=$$GET1^DIQ(52.413,POQIENS,9,"E")
"RTN","PSO520PO",23,0)
 ..S PODOSE=$$GET1^DIQ(52.413,POQIENS,8,"E")
"RTN","PSO520PO",24,0)
 ..S PONOUN=$$GET1^DIQ(52.413,POQIENS,12,"E")
"RTN","PSO520PO",25,0)
 ..I PODOSORD]"" S PNEWDOSE=PODOSORD_"&"_PONOUN,PFDA(52.413,POQIENS,.01)=PNEWDOSE D FILE^DIE(,"PFDA") K PFDA Q
"RTN","PSO520PO",26,0)
 ..S PNEWDOSE=PODOSE,PFDA(52.413,POQIENS,.01)=PNEWDOSE D FILE^DIE(,"PFDA") K PFDA Q
"RTN","PSO520PO",27,0)
 D CLEANREC
"RTN","PSO520PO",28,0)
 Q
"RTN","PSO520PO",29,0)
CLEANREC ; 
"RTN","PSO520PO",30,0)
 N EXIEN,FDA
"RTN","PSO520PO",31,0)
 S EXIEN=0 F  S EXIEN=$O(^PS(52.49,EXIEN)) Q:'EXIEN  D
"RTN","PSO520PO",32,0)
 .I '$$GET1^DIQ(52.49,EXIEN,2.1,"I"),$$GET1^DIQ(52.49,EXIEN,1,"E")="N" D
"RTN","PSO520PO",33,0)
 ..S FDA(52.49,EXIEN_",",.01)="@" D FILE^DIE(,"FDA") K FDA
"RTN","PSO520PO",34,0)
 Q
"RTN","PSOERX1")
0^2^B78113313^B73483713
"RTN","PSOERX1",1,0)
PSOERX1 ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERX1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520**;DEC 1997;Build 52
"RTN","PSOERX1",3,0)
 ;
"RTN","PSOERX1",4,0)
EN(PSOIEN) ; -- main entry point for PSO ERX HOLDING QUEUE
"RTN","PSOERX1",5,0)
 D EN^VALM("PSO ERX HQ DISPLAY")
"RTN","PSOERX1",6,0)
 Q
"RTN","PSOERX1",7,0)
 ;
"RTN","PSOERX1",8,0)
HDR ; -- header code
"RTN","PSOERX1",9,0)
 S VALMHDR(1)="eRx Patient: "_$$GET1^DIQ(52.49,PSOIEN,.04,"E")
"RTN","PSOERX1",10,0)
 S VALMHDR(2)="eRx Reference #: "_$$GET1^DIQ(52.49,PSOIEN,.01,"E")
"RTN","PSOERX1",11,0)
 I VALMBCK="R" K @VALMAR S VALMBCK="" D INIT
"RTN","PSOERX1",12,0)
 Q
"RTN","PSOERX1",13,0)
 ;
"RTN","PSOERX1",14,0)
INIT ;
"RTN","PSOERX1",15,0)
 Q:'$G(PSOIEN)
"RTN","PSOERX1",16,0)
 N PATIEN,PHARMIEN,PRVIEN,PHDAT,PATDAT,SUPDAT,PRVDAT,LINE,PRVLNM,PRVMI,PRVFN,EPAT,EPATDOB,VPATIEN
"RTN","PSOERX1",17,0)
 N VPATNM,VPATDOB,EPRVIEN,EPRVNM,EPRVNPI,VAPRVIEN,VAPRVNM,VAPRVNPI,SUPIEN,ERXDRUG,ERXQTY,ERXFLS
"RTN","PSOERX1",18,0)
 N ERXDS,ERXDT,VADRG,LINETXT,ERXCOMM,ERXRFLS,PATIENS,VAHREA,VAQTY,VAREF,VASIG,PATDAT,CURSTATE,CURSTATI
"RTN","PSOERX1",19,0)
 N LHFOUND,LHMATCH,LHSTATI,VAPDEAEX,ERXCOMM,COMFRST,COMARY,SIGDATA,SIGLOOP,SFIRST,SGLOOP,SIGARY,VADAYS
"RTN","PSOERX1",20,0)
 N SLOOP,VASIG,VASARY,FSSIG,VAHSTA,EDIRECT,VAHPER,PAMANVAL,DRMANVAL,PRMANVAL,VPATINST,VAPIARY,VLOOP,FSVPIN
"RTN","PSOERX1",21,0)
 N DRGARY,DLP
"RTN","PSOERX1",22,0)
 S LINE=0
"RTN","PSOERX1",23,0)
 S PATIEN=$$GET1^DIQ(52.49,PSOIEN,.04,"I"),PATIENS=PATIEN_","
"RTN","PSOERX1",24,0)
 D GETS^DIQ(52.46,PATIENS,"**","IE","PATDAT")
"RTN","PSOERX1",25,0)
 S EPAT=$G(PATDAT(52.46,PATIENS,.01,"E"))
"RTN","PSOERX1",26,0)
 S EPATDOB=$G(PATDAT(52.46,PATIENS,.08,"I")),EPATDOB=$$FMTE^XLFDT(EPATDOB,"2D")
"RTN","PSOERX1",27,0)
 ; Future enhancement - if 52.46 is linked to the patient in the patient file, use it. for now use 52.49
"RTN","PSOERX1",28,0)
 ;S VPATIEN=$G(PATDAT(52.46,PATIENS,1.5,"I"))
"RTN","PSOERX1",29,0)
 S VPATIEN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERX1",30,0)
 S VPATNM=$S(VPATIEN:$$GET1^DIQ(2,VPATIEN,.01,"E"),1:"NOT LINKED")
"RTN","PSOERX1",31,0)
 S VPATDOB=$S(VPATIEN:$$GET1^DIQ(2,VPATIEN,.03,"I"),1:"N/A")
"RTN","PSOERX1",32,0)
 I VPATDOB S VPATDOB=$$FMTE^XLFDT(VPATDOB,"2D")
"RTN","PSOERX1",33,0)
 S PHARMIEN=$$GET1^DIQ(52.49,PSOIEN,2.5,"I")
"RTN","PSOERX1",34,0)
 D GETS^DIQ(52.47,PHARMIEN,"**","E","PHDAT")
"RTN","PSOERX1",35,0)
 S EPRVIEN=$$GET1^DIQ(52.49,PSOIEN,2.1,"I")
"RTN","PSOERX1",36,0)
 S EPRVNM=$$GET1^DIQ(52.48,EPRVIEN,.01,"E")
"RTN","PSOERX1",37,0)
 S EPRVNPI=$$GET1^DIQ(52.48,EPRVIEN,1.5,"E")
"RTN","PSOERX1",38,0)
 S VAPRVIEN=$$GET1^DIQ(52.49,PSOIEN,2.3,"I")
"RTN","PSOERX1",39,0)
 S EDIRECT=$$GET1^DIQ(52.49,PSOIEN,7,"E")
"RTN","PSOERX1",40,0)
 S VAPRVNM=$S(VAPRVIEN:$$GET1^DIQ(200,VAPRVIEN,.01,"E"),1:"NOT LINKED")
"RTN","PSOERX1",41,0)
 S VAPRVNPI=$S(VAPRVIEN:$$GET1^DIQ(200,VAPRVIEN,41.99,"E"),1:"N/A")
"RTN","PSOERX1",42,0)
 D GETS^DIQ(52.48,EPRVIEN,"**","E","PRVDAT")
"RTN","PSOERX1",43,0)
 S SUPIEN=$$GET1^DIQ(52.49,PSOIEN,2.6,"I")
"RTN","PSOERX1",44,0)
 D GETS^DIQ(52.48,SUPIEN,"**","E","SUPDAT")
"RTN","PSOERX1",45,0)
 S PAMANVAL=$$GET1^DIQ(52.49,PSOIEN,1.7,"I")
"RTN","PSOERX1",46,0)
 S PRMANVAL=$$GET1^DIQ(52.49,PSOIEN,1.3,"I")
"RTN","PSOERX1",47,0)
 S DRMANVAL=$$GET1^DIQ(52.49,PSOIEN,1.5,"I")
"RTN","PSOERX1",48,0)
 S LINETXT=""
"RTN","PSOERX1",49,0)
 S LINE=LINE+1
"RTN","PSOERX1",50,0)
 ;/BLB/ - PSO*7.0*520 BEGIN CHANGE
"RTN","PSOERX1",51,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Patient: ",$E(EPAT,1,39),1,52)
"RTN","PSOERX1",52,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",EPATDOB,57,20)
"RTN","PSOERX1",53,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",54,0)
 I $L(EPAT)>39 D
"RTN","PSOERX1",55,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"             "_$E(EPAT,40,78))
"RTN","PSOERX1",56,0)
 I $L(EPAT)>78 D
"RTN","PSOERX1",57,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"             "_$E(EPAT,79,135))
"RTN","PSOERX1",58,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1",59,0)
 S LINETXT=""
"RTN","PSOERX1",60,0)
 S LINE=LINE+1
"RTN","PSOERX1",61,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Vista Patient"_$S(PAMANVAL:"[v]",1:"")_": ",$E(VPATNM,1,55),1,55)
"RTN","PSOERX1",62,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",VPATDOB,57,20)
"RTN","PSOERX1",63,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",64,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",65,0)
 S LINE=LINE+1
"RTN","PSOERX1",66,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1",67,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Provider: ",$E(EPRVNM,1,39),1,52)
"RTN","PSOERX1",68,0)
 D ADDITEM^PSOERX1A(.LINETXT,"NPI: ",EPRVNPI,57,20)
"RTN","PSOERX1",69,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",70,0)
 I $L(EPRVNM)>39 D
"RTN","PSOERX1",71,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"              "_$E(EPRVNM,40,77))
"RTN","PSOERX1",72,0)
 I $L(EPRVNM)>77 D
"RTN","PSOERX1",73,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"              "_$E(EPRVNM,78,135))
"RTN","PSOERX1",74,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1",75,0)
 S LINE=LINE+1
"RTN","PSOERX1",76,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Vista Provider"_$S(PRMANVAL:"[v]",1:"")_": ",$E(VAPRVNM,1,55),1,55)
"RTN","PSOERX1",77,0)
 D ADDITEM^PSOERX1A(.LINETXT,"NPI: ",VAPRVNPI,57,20)
"RTN","PSOERX1",78,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",79,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",80,0)
 S ERXDRUG=$$GET1^DIQ(52.49,PSOIEN,3.1,"E")
"RTN","PSOERX1",81,0)
 S ERXQTY=$$GET1^DIQ(52.49,PSOIEN,5.1,"E")
"RTN","PSOERX1",82,0)
 S ERXRFLS=$$GET1^DIQ(52.49,PSOIEN,5.6,"E")
"RTN","PSOERX1",83,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1",84,0)
 I ERXRFLS="" D
"RTN","PSOERX1",85,0)
 .S ERXRFLS=$$GET1^DIQ(52.49,PSOIEN,5.7,"I")
"RTN","PSOERX1",86,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1",87,0)
 S ERXDS=$$GET1^DIQ(52.49,PSOIEN,5.5,"E")
"RTN","PSOERX1",88,0)
 S ERXDT=$$GET1^DIQ(52.49,PSOIEN,.03,"E")
"RTN","PSOERX1",89,0)
 S VADRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"E")
"RTN","PSOERX1",90,0)
 S VAREF=$$GET1^DIQ(52.49,PSOIEN,20.5,"E")
"RTN","PSOERX1",91,0)
 S VAQTY=$$GET1^DIQ(52.49,PSOIEN,20.1,"E")
"RTN","PSOERX1",92,0)
 S VADAYS=$$GET1^DIQ(52.49,PSOIEN,20.2,"E")
"RTN","PSOERX1",93,0)
 ; only set the hold reason if the eRx has a hold status
"RTN","PSOERX1",94,0)
 S CURSTATE=$$GET1^DIQ(52.49,PSOIEN,1,"E")
"RTN","PSOERX1",95,0)
 S VAHREA=""
"RTN","PSOERX1",96,0)
 I $E(CURSTATE,1)="H" D
"RTN","PSOERX1",97,0)
 .S CURSTATI=$$GET1^DIQ(52.49,PSOIEN,1,"I")
"RTN","PSOERX1",98,0)
 .S LHMATCH=999999,LHFOUND=0 F  S LHMATCH=$O(^PS(52.49,PSOIEN,19,LHMATCH),-1) Q:'LHMATCH!(LHFOUND)  D
"RTN","PSOERX1",99,0)
 ..S LHSTATI=$$GET1^DIQ(52.4919,LHMATCH_","_PSOIEN_",",.02,"I") I LHSTATI=CURSTATI D  S LHFOUND=LHMATCH Q
"RTN","PSOERX1",100,0)
 ...S VAHREA=$$GET1^DIQ(52.4919,LHMATCH_","_PSOIEN_",",1)
"RTN","PSOERX1",101,0)
 ...S VAHSTA=$$GET1^DIQ(52.45,LHSTATI,.01,"E")_" - "_$$GET1^DIQ(52.45,LHSTATI,.02,"E")
"RTN","PSOERX1",102,0)
 ...S VAHPER=$$GET1^DIQ(52.4919,LHMATCH_","_PSOIEN_",",.03,"E")
"RTN","PSOERX1",103,0)
 I VADRG']"" S VADRG="NOT LINKED"
"RTN","PSOERX1",104,0)
 D TXT2ARY^PSOERXD1(.DRGARY,ERXDRUG,,70)
"RTN","PSOERX1",105,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"eRx Drug: "_$G(DRGARY(1)))
"RTN","PSOERX1",106,0)
 S DLP=1
"RTN","PSOERX1",107,0)
 F  S DLP=$O(DRGARY(DLP)) Q:'DLP  D
"RTN","PSOERX1",108,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"          "_$G(DRGARY(DLP)))
"RTN","PSOERX1",109,0)
 S LINE=LINE+1
"RTN","PSOERX1",110,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Qty: ",ERXQTY,1,17)
"RTN","PSOERX1",111,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Refills: ",ERXRFLS,19,16)
"RTN","PSOERX1",112,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Days Supply: ",ERXDS,37,20)
"RTN","PSOERX1",113,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Date: ",$P(ERXDT,"@"),58,22)
"RTN","PSOERX1",114,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",115,0)
 D TXT2ARY^PSOERXD1(.SIGARY,EDIRECT,,70)
"RTN","PSOERX1",116,0)
 S SFIRST=$O(SIGARY(0))
"RTN","PSOERX1",117,0)
 S SGLOOP=0 F  S SGLOOP=$O(SIGARY(SGLOOP)) Q:'SGLOOP  D
"RTN","PSOERX1",118,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,$S(SGLOOP=SFIRST:"eRx Sig: ",1:"         ")_$G(SIGARY(SGLOOP)))
"RTN","PSOERX1",119,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",120,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Vista Drug"_$S(DRMANVAL:"[v]",1:"")_": "_VADRG)
"RTN","PSOERX1",121,0)
 S LINE=LINE+1
"RTN","PSOERX1",122,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Vista Qty: ",$G(VAQTY),1,25)
"RTN","PSOERX1",123,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Vista Refills: ",$G(VAREF),27,18)
"RTN","PSOERX1",124,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Vista Days Supply: ",$G(VADAYS),54,22)
"RTN","PSOERX1",125,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",126,0)
 S VASIG=""
"RTN","PSOERX1",127,0)
 S SLOOP=0 F  S SLOOP=$O(^PS(52.49,PSOIEN,"SIG",SLOOP)) Q:'SLOOP  D
"RTN","PSOERX1",128,0)
 .I '$L($G(VASIG)) S VASIG=$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0)) Q
"RTN","PSOERX1",129,0)
 .S VASIG=$G(VASIG)_" "_$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0))
"RTN","PSOERX1",130,0)
 D TXT2ARY^PSOERXD1(.VASARY,VASIG,,68)
"RTN","PSOERX1",131,0)
 S FSSIG=$O(VASARY(0))
"RTN","PSOERX1",132,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Vista Sig: "_$S(FSSIG:$G(VASARY(FSSIG)),1:""))
"RTN","PSOERX1",133,0)
 S SLOOP=1 F  S SLOOP=$O(VASARY(SLOOP)) Q:'SLOOP  D
"RTN","PSOERX1",134,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"                        "_VASARY(SLOOP))
"RTN","PSOERX1",135,0)
 S VPATINST=$$GET1^DIQ(52.49,PSOIEN,27,"E")
"RTN","PSOERX1",136,0)
 I VPATINST]"" S VPATINST=$$LSIG^PSOQUTIL(VPATINST)
"RTN","PSOERX1",137,0)
 D TXT2ARY^PSOERXD1(.VAPIARY,VPATINST,68)
"RTN","PSOERX1",138,0)
 S FSVPIN=$O(VAPIARY(0))
"RTN","PSOERX1",139,0)
 S LINE=LINE+1 D SET^VALM10(LINE," Pat Inst: "_$S(FSVPIN:$G(VAPIARY(FSVPIN)),1:""))
"RTN","PSOERX1",140,0)
 S VLOOP=1 F  S VLOOP=$O(VAPIARY(VLOOP)) Q:'VLOOP  D
"RTN","PSOERX1",141,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"                        "_VAPIARY(VLOOP))
"RTN","PSOERX1",142,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Hold Status: "_$G(VAHSTA))
"RTN","PSOERX1",143,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Hold Reason: "_$G(VAHREA))
"RTN","PSOERX1",144,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Placed on hold by: "_$G(VAHPER))
"RTN","PSOERX1",145,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",146,0)
 S ERXCOMM=$$GET1^DIQ(52.49,PSOIEN,8,"E")
"RTN","PSOERX1",147,0)
 D TXT2ARY^PSOERXD1(.COMARY,ERXCOMM," ",68)
"RTN","PSOERX1",148,0)
 S COMFRST=$O(COMARY(0)) S LINE=LINE+1 D SET^VALM10(LINE,"eRx Notes: "_$G(ERXCOMM))
"RTN","PSOERX1",149,0)
 F  S COMFRST=$O(COMARY(COMFRST)) Q:'COMFRST  D
"RTN","PSOERX1",150,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"          "_$G(COMARY(COMFRST)))
"RTN","PSOERX1",151,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",152,0)
 ;/BLB/ PSO*7.0*520 - BEGIN
"RTN","PSOERX1",153,0)
 I $$GET1^DIQ(52.49,PSOIEN,.05,"I") D
"RTN","PSOERX1",154,0)
 .D ALG^PSOERXU1(.LINE)
"RTN","PSOERX1",155,0)
 ;/BLB/ - END
"RTN","PSOERX1",156,0)
 N DIAGIEN,DIAGDAT,DIAGSEQ,PDIAGQ,PDIAGV,SDIAGQ,SDIAGV,DIAGDAT,DIACIC,DRES,SDRES
"RTN","PSOERX1",157,0)
 N SDRESL,SDRESDAT,DRESL,DRESDAT,PDIAGARY,SDIAGARY,PDFRST,SDFRST,PDLOOP,SDLOOP,DIENS
"RTN","PSOERX1",158,0)
 S DIAGIEN=0 F  S DIAGIEN=$O(^PS(52.49,PSOIEN,9,DIAGIEN)) Q:'DIAGIEN  D
"RTN","PSOERX1",159,0)
 .S DIENS=DIAGIEN_","_PSOIEN_"," K PDIAGARY,SDIAGARY,DIAGDAT
"RTN","PSOERX1",160,0)
 .D GETS^DIQ(52.499,DIENS,".01:.06","IE","DIAGDAT")
"RTN","PSOERX1",161,0)
 .S DIAGSEQ=$G(DIAGDAT(52.499,DIENS,.01,"E"))
"RTN","PSOERX1",162,0)
 .S DIACIC=$G(DIAGDAT(52.499,DIENS,.02,"E"))
"RTN","PSOERX1",163,0)
 .S PDIAGQ=$G(DIAGDAT(52.499,DIENS,.03,"E"))
"RTN","PSOERX1",164,0)
 .S PDIAGV=$G(DIAGDAT(52.499,DIENS,.04,"E"))
"RTN","PSOERX1",165,0)
 .I PDIAGQ="ICD-10-CM"!(PDIAGQ="ICD-9-CM") D
"RTN","PSOERX1",166,0)
 ..K DRES,PDIAGARY
"RTN","PSOERX1",167,0)
 ..D ICDDESC^ICDXCODE(PDIAGQ,PDIAGV,,.DRES)
"RTN","PSOERX1",168,0)
 ..I '$O(DRES(0)) D TXT2ARY^PSOERXD1(.PDIAGARY,PDIAGV," ",62) Q
"RTN","PSOERX1",169,0)
 ..S DRESL=0 F  S DRESL=$O(DRES(DRESL)) Q:'DRESL  D
"RTN","PSOERX1",170,0)
 ...S DRESDAT=$G(DRES(DRESL)) Q:DRESDAT=""
"RTN","PSOERX1",171,0)
 ...I DRESL=1 S PDIAGV=PDIAGV_" - "_DRESDAT Q
"RTN","PSOERX1",172,0)
 ...S PDIAGV=PDIAGV_" "_DRESDAT
"RTN","PSOERX1",173,0)
 ..D TXT2ARY^PSOERXD1(.PDIAGARY,PDIAGV," ",62)
"RTN","PSOERX1",174,0)
 .S SDIAGQ=$G(DIAGDAT(52.499,DIENS,.05,"E"))
"RTN","PSOERX1",175,0)
 .S SDIAGV=$G(DIAGDAT(52.499,DIENS,.06,"E"))
"RTN","PSOERX1",176,0)
 .I SDIAGQ="ICD-10-CM"!(SDIAGQ="ICD-9-CM") D
"RTN","PSOERX1",177,0)
 ..K SDRES,SDIAGARY
"RTN","PSOERX1",178,0)
 ..D ICDDESC^ICDXCODE(SDIAGQ,SDIAGV,,.SDRES)
"RTN","PSOERX1",179,0)
 ..I '$O(DRES(0)) D TXT2ARY^PSOERXD1(.SDIAGARY,SDIAGV," ",62) Q
"RTN","PSOERX1",180,0)
 ..S SDRESL=0 F  S SDRESL=$O(SDRES(SDRESL)) Q:'SDRESL  D
"RTN","PSOERX1",181,0)
 ...S SDRESDAT=$G(SDRES(SDRESL)) Q:SDRESDAT=""
"RTN","PSOERX1",182,0)
 ...I SDRESL=1 S SDIAGV=SDIAGV_" - "_SDRESDAT Q
"RTN","PSOERX1",183,0)
 ...S SDIAGV=SDIAGV_" "_SDRESDAT
"RTN","PSOERX1",184,0)
 ..D TXT2ARY^PSOERXD1(.SDIAGARY,SDIAGV," ",62)
"RTN","PSOERX1",185,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Diagnosis Sequence: "_DIAGSEQ)
"RTN","PSOERX1",186,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Primary DX Qualifier: "_PDIAGQ)
"RTN","PSOERX1",187,0)
 .S PDFRST=$O(PDIAGARY(0))
"RTN","PSOERX1",188,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Primary Dx Value: "_$S(PDFRST:$G(PDIAGARY(PDFRST)),1:PDIAGV))
"RTN","PSOERX1",189,0)
 .S PDLOOP=PDFRST F  S PDLOOP=$O(PDIAGARY(PDLOOP)) Q:'PDLOOP  D
"RTN","PSOERX1",190,0)
 ..S LINE=LINE+1 D SET^VALM10(LINE,"                  "_$G(PDIAGARY(PDLOOP)))
"RTN","PSOERX1",191,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",192,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Secondary DX Qualifier: "_SDIAGQ)
"RTN","PSOERX1",193,0)
 .S SDFRST=$O(SDIAGARY(0))
"RTN","PSOERX1",194,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Secondary Dx Value: "_$S(SDFRST:$G(SDIAGARY(SDFRST)),1:SDIAGV))
"RTN","PSOERX1",195,0)
 .S SDLOOP=SDFRST F  S SDLOOP=$O(SDIAGARY(SDLOOP)) Q:'SDLOOP  D
"RTN","PSOERX1",196,0)
 ..S LINE=LINE+1 D SET^VALM10(LINE,"                    "_$G(SDIAGARY(SDLOOP)))
"RTN","PSOERX1",197,0)
 .I $O(^PS(52.49,PSOIEN,9,DIAGIEN)) S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",198,0)
 S VALMCNT=LINE
"RTN","PSOERX1",199,0)
 Q
"RTN","PSOERX1",200,0)
 ;
"RTN","PSOERX1",201,0)
HELP ; -- help code
"RTN","PSOERX1",202,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERX1",203,0)
 Q
"RTN","PSOERX1",204,0)
 ;
"RTN","PSOERX1",205,0)
EXIT ; -- exit code
"RTN","PSOERX1",206,0)
 K @VALMAR
"RTN","PSOERX1",207,0)
 ;D INIT^PSOERX
"RTN","PSOERX1",208,0)
 Q
"RTN","PSOERX1",209,0)
 ;
"RTN","PSOERX1",210,0)
EXPND ; -- expand code
"RTN","PSOERX1",211,0)
 Q
"RTN","PSOERX1B")
0^8^B154507607^B201661947
"RTN","PSOERX1B",1,0)
PSOERX1B ;ALB/BWF - Accept eRx function ; 8/3/2016 5:14pm
"RTN","PSOERX1B",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,506,520**;DEC 1997;Build 52
"RTN","PSOERX1B",3,0)
 ;
"RTN","PSOERX1B",4,0)
 Q
"RTN","PSOERX1B",5,0)
ACVAL(PSOIEN,TYPE) ;
"RTN","PSOERX1B",6,0)
 N F,VBFLD,VBDTTMF,DIR,TAG,VALPAR,VAL,CURVAL,MVFLD,VBFLD,VBDTTMF,PSOIENS,RXSTAT,QFLG,VDTTM,ERXMMFLG
"RTN","PSOERX1B",7,0)
 S F=52.49,PSOIENS=PSOIEN_","
"RTN","PSOERX1B",8,0)
 D FULL^VALM1
"RTN","PSOERX1B",9,0)
 S VALMBCK="R"
"RTN","PSOERX1B",10,0)
 ; first check to see if the entry exists. cannot validate something that has no value
"RTN","PSOERX1B",11,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERX1B",12,0)
 .W !!,"Cannot accept validation for a prescription with a status of 'Rejected',",!,"'Removed',or 'Processed",!
"RTN","PSOERX1B",13,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",14,0)
 Q:TYPE']""
"RTN","PSOERX1B",15,0)
 S TAG=$S(TYPE="P":"patient",TYPE="PR":"provider",TYPE="D":"drug",1:"")
"RTN","PSOERX1B",16,0)
 S VALPAR=$S(TYPE="P":.05,TYPE="PR":2.3,TYPE="D":3.2,1:"") Q:VALPAR=""
"RTN","PSOERX1B",17,0)
 S VAL=$$GET1^DIQ(F,PSOIEN,VALPAR,"I") I 'VAL D  Q
"RTN","PSOERX1B",18,0)
 .W !,"Vista "_TAG_" has not been matched. Cannot manually validate."
"RTN","PSOERX1B",19,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",20,0)
 S MVFLD=$S(TYPE="P":1.7,TYPE="PR":1.3,TYPE="D":1.5,1:"")
"RTN","PSOERX1B",21,0)
 S VBFLD=$S(TYPE="P":1.13,TYPE="PR":1.8,TYPE="D":1.11,1:"")
"RTN","PSOERX1B",22,0)
 S VBDTTMF=$S(TYPE="P":1.14,TYPE="PR":1.9,TYPE="D":1.12,1:"")
"RTN","PSOERX1B",23,0)
 ; check to see if this is already validated
"RTN","PSOERX1B",24,0)
 I MVFLD S CURVAL=$$GET1^DIQ(F,PSOIEN,MVFLD,"I")
"RTN","PSOERX1B",25,0)
 I CURVAL D  Q
"RTN","PSOERX1B",26,0)
 .W !!,"This "_TAG_" has already been manually validated."
"RTN","PSOERX1B",27,0)
 .W !,"Validated By: "_$$GET1^DIQ(F,PSOIEN,VBFLD,"E")
"RTN","PSOERX1B",28,0)
 .W !,"Validated Date/Time: "_$$GET1^DIQ(F,PSOIEN,VBDTTMF,"E"),!
"RTN","PSOERX1B",29,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",30,0)
 S QFLG=0
"RTN","PSOERX1B",31,0)
 I TYPE="D" D
"RTN","PSOERX1B",32,0)
 .W !
"RTN","PSOERX1B",33,0)
 .I '$O(^PS(52.49,PSOIEN,21,0)) W !,"Dosing information missing." S QFLG=1
"RTN","PSOERX1B",34,0)
 .I $$GET1^DIQ(52.49,PSOIEN,20.1,"E")="" W !,"Quantity missing." S QFLG=1
"RTN","PSOERX1B",35,0)
 .I $$GET1^DIQ(52.49,PSOIEN,20.2,"E")="" W !,"Days supply missing." S QFLG=1
"RTN","PSOERX1B",36,0)
 .;I $$GET1^DIQ(52.49,PSOIEN,20.5,"E")="" W !,"Refills missing."  S QFLG=1
"RTN","PSOERX1B",37,0)
 .I QFLG=1 D
"RTN","PSOERX1B",38,0)
 ..W !!,"Cannot validate drug information."
"RTN","PSOERX1B",39,0)
 ..S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX1B",40,0)
 Q:QFLG
"RTN","PSOERX1B",41,0)
 I TYPE="P" S ERXMMFLG=$$PATWARN^PSOERX1A(PSOIEN)
"RTN","PSOERX1B",42,0)
 I TYPE="PR" S ERXMMFLG=$$PRVWARN^PSOERX1A(PSOIEN)
"RTN","PSOERX1B",43,0)
 W !,"Would you like to mark this "_TAG_" as VALIDATED?"
"RTN","PSOERX1B",44,0)
 S DIR(0)="Y",DIR("B")=$S($G(ERXMMFLG):"NO",1:"YES") D ^DIR Q:Y'=1
"RTN","PSOERX1B",45,0)
 K FDA,DIR
"RTN","PSOERX1B",46,0)
 S VDTTM=$$NOW^XLFDT
"RTN","PSOERX1B",47,0)
 I MVFLD S FDA(F,PSOIENS,MVFLD)=1
"RTN","PSOERX1B",48,0)
 I VBFLD S FDA(F,PSOIENS,VBFLD)=$G(DUZ)
"RTN","PSOERX1B",49,0)
 I VBDTTMF S FDA(F,PSOIENS,VBDTTMF)=VDTTM
"RTN","PSOERX1B",50,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1B",51,0)
 I $D(FDA) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",52,0)
 W !,"Validation Updated!!" S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",53,0)
 I TYPE="P" D BPROC(PSOIEN,"PA",MVFLD,VBFLD,VBDTTMF,VDTTM) K @VALMAR D INIT^PSOERXP1
"RTN","PSOERX1B",54,0)
 I TYPE="PR" D BPROC(PSOIEN,"PR",MVFLD,VBFLD,VBDTTMF,VDTTM) K @VALMAR D INIT^PSOERXR1
"RTN","PSOERX1B",55,0)
 I TYPE="D" K @VALMAR D INIT^PSOERXD1
"RTN","PSOERX1B",56,0)
 Q
"RTN","PSOERX1B",57,0)
BPROC(PSOIEN,BTYPE,MVFLD,VBFLD,VBDTTMF,VDTTM) ;
"RTN","PSOERX1B",58,0)
 N ERXPAT,ERXSTAT,ERESTAT,ERXDT,ERXIEN,ERXARY,DIR,Y,L,LINE,CNT,EHID,EDRUG,EPROV,EPAT,ERXRDT,ERXRECDT,ERXEDT,I
"RTN","PSOERX1B",59,0)
 N REXEDT,EEPROV,ERXPROV,EXARY
"RTN","PSOERX1B",60,0)
 S ERXPAT=$$GET1^DIQ(52.49,PSOIEN,.04,"I") Q:'ERXPAT
"RTN","PSOERX1B",61,0)
 S ERXPROV=$$GET1^DIQ(52.49,PSOIEN,2.1,"I")
"RTN","PSOERX1B",62,0)
 S ERXRECDT=$P($$GET1^DIQ(52.49,PSOIEN,.03,"I"),".")
"RTN","PSOERX1B",63,0)
 S ERXEDT=ERXRECDT_".2359"
"RTN","PSOERX1B",64,0)
 S ERXSTAT=0 F  S ERXSTAT=$O(^PS(52.49,"PAT",PSNPINST,ERXSTAT)) Q:'ERXSTAT  D
"RTN","PSOERX1B",65,0)
 .S ERESTAT=$$GET1^DIQ(52.45,ERXSTAT,.01,"E")
"RTN","PSOERX1B",66,0)
 .; do not consider rx's that are rejected, removed, processed.
"RTN","PSOERX1B",67,0)
 .I ERESTAT="PR"!(ERESTAT="RM")!(ERESTAT="RJ") Q
"RTN","PSOERX1B",68,0)
 .S ERXDT=ERXRECDT-.0001 F  S ERXDT=$O(^PS(52.49,"PAT",PSNPINST,ERXSTAT,ERXPAT,ERXDT)) Q:ERXDT>ERXEDT!(ERXDT="")  D
"RTN","PSOERX1B",69,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"PAT",PSNPINST,ERXSTAT,ERXPAT,ERXDT,ERXIEN)) Q:'ERXIEN  D
"RTN","PSOERX1B",70,0)
 ...;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1B",71,0)
 ...Q:PSOIEN=ERXIEN
"RTN","PSOERX1B",72,0)
 ...;/BLB/ PSO*7.0*520 - END CHANGE
"RTN","PSOERX1B",73,0)
 ...I BTYPE="PR",$$GET1^DIQ(52.49,ERXIEN,2.1,"I")'=ERXPROV Q
"RTN","PSOERX1B",74,0)
 ...S EXARY(ERXIEN)=""
"RTN","PSOERX1B",75,0)
 I '$O(EXARY(0)) Q
"RTN","PSOERX1B",76,0)
 W !!
"RTN","PSOERX1B",77,0)
 I BTYPE="PA" D
"RTN","PSOERX1B",78,0)
 .W !,"This patient has other prescriptions for: "_$$FMTE^XLFDT(ERXRECDT)
"RTN","PSOERX1B",79,0)
 .W !,"Patient: "_$$GET1^DIQ(52.46,ERXPAT,.01,"E")
"RTN","PSOERX1B",80,0)
 I BTYPE="PR" D
"RTN","PSOERX1B",81,0)
 .W !,"There are other prescriptions for this patient, written by this provider on"
"RTN","PSOERX1B",82,0)
 .W !,$$FMTE^XLFDT(ERXRECDT)
"RTN","PSOERX1B",83,0)
 .W !,"Provider: "_$$GET1^DIQ(52.48,ERXPROV,.01,"E")
"RTN","PSOERX1B",84,0)
 .W !,"Patient: "_$$GET1^DIQ(52.46,ERXPAT,.01,"E")
"RTN","PSOERX1B",85,0)
 W !!,?4,"DRUG",?30,"PROVIDER",?60,"REC DATE"
"RTN","PSOERX1B",86,0)
 S $P(LINE,"-",80)="" W !,LINE
"RTN","PSOERX1B",87,0)
 S L=0,CNT=0 F  S L=$O(EXARY(L)) Q:'L  D
"RTN","PSOERX1B",88,0)
 .S CNT=CNT+1
"RTN","PSOERX1B",89,0)
 .S EHID=$$GET1^DIQ(52.49,L,.01,"E")
"RTN","PSOERX1B",90,0)
 .S EDRUG=$$GET1^DIQ(52.49,L,3.1,"E")
"RTN","PSOERX1B",91,0)
 .S EEPROV=$$GET1^DIQ(52.49,L,2.1,"I")
"RTN","PSOERX1B",92,0)
 .S EPROV=$$GET1^DIQ(52.48,EEPROV,.01,"E")
"RTN","PSOERX1B",93,0)
 .S EPAT=$$GET1^DIQ(52.46,ERXPAT,.01,"E")
"RTN","PSOERX1B",94,0)
 .S ERXRDT=$P($$GET1^DIQ(52.49,L,.03,"E"),"@")
"RTN","PSOERX1B",95,0)
 .W !,CNT_".) "_$E(EDRUG,1,28),?30,$E(EPROV,1,28),?60,ERXRDT
"RTN","PSOERX1B",96,0)
 W !!,"Would you like apply the above validation to these prescriptions?"
"RTN","PSOERX1B",97,0)
 K Y S DIR(0)="YO"
"RTN","PSOERX1B",98,0)
 S DIR("B")="N" D ^DIR K DIR
"RTN","PSOERX1B",99,0)
 I Y="^"!(Y=0) Q
"RTN","PSOERX1B",100,0)
 S I=0 F  S I=$O(EXARY(I)) Q:'I  D
"RTN","PSOERX1B",101,0)
 .I BTYPE="PA" S FDA(52.49,I_",",.05)=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERX1B",102,0)
 .I BTYPE="PR" S FDA(52.49,I_",",2.3)=$$GET1^DIQ(52.49,PSOIEN,2.3,"I")
"RTN","PSOERX1B",103,0)
 .S FDA(52.49,I_",",MVFLD)=1,FDA(52.49,I_",",VBFLD)=$G(DUZ),FDA(52.49,I_",",VBDTTMF)=VDTTM
"RTN","PSOERX1B",104,0)
 .D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",105,0)
 .I $$GET1^DIQ(52.49,I,1,"E")="N" D UPDSTAT^PSOERXU1(I,"I")
"RTN","PSOERX1B",106,0)
 Q
"RTN","PSOERX1B",107,0)
 ;PSOHY("LOC")=IEN of hospital location file (#44) - NOT USED, 
"RTN","PSOERX1B",108,0)
 ;PSOHY("CHNUM")=EXTERNAL PLACER ORDER NUMBER (NEED TO FIND OUT HOW WE SHOULD SET THIS) (25)
"RTN","PSOERX1B",109,0)
 ;PSOHY("PICK")=MAIL/WINDOW (20.4) 
"RTN","PSOERX1B",110,0)
 ;PSOHY("ENTER")=ENTERED BY IEN (2.1)
"RTN","PSOERX1B",111,0)
 ;PSOHY("PROV")=PROVIDER IEN (2.3)
"RTN","PSOERX1B",112,0)
 ;PSOHY("SDT")=EFFECTIVE DATE (6.3)
"RTN","PSOERX1B",113,0)
 ;PSOHY("ITEM")=PHARMACY ORDERABLE ITEM (DERIVED FROM THE DRUG IEN) - NO MAPPING TO 52.49
"RTN","PSOERX1B",114,0)
 ;PSOHY("DRUG")=DRUG IEN (3.2)
"RTN","PSOERX1B",115,0)
 ;PSOHY("QTY")=QUANTITY (20.1)
"RTN","PSOERX1B",116,0)
 ;PSOHY("REF")=# OF REFILLS (20.5)
"RTN","PSOERX1B",117,0)
 ;PSOHY("PAT")=PATIENT IEN (.05)
"RTN","PSOERX1B",118,0)
 ;PSOHY("OCC")=ORDER TYPE (ALWAYS 'NW') - NO MAPPING TO 52.49
"RTN","PSOERX1B",119,0)
 ;PSOHY("EDT")=LOGIN DATE (TODAYS DATE) - NO MAPPING TO 52.49
"RTN","PSOERX1B",120,0)
 ;PSOHY("PRIOR")=PRIORITY (SET OF CODES, 52.41,25 - STAT, EMERGENCY, ROUTINE)
"RTN","PSOERX1B",121,0)
 ;PSOHY("EXAPP")=EXTERNAL APPLICATION (FREE TEXT), LIKELY "PSO" - NO MAPPING TO 52.49
"RTN","PSOERX1B",122,0)
 ;PSOHY("PRCOM",#)=PROVIDER COMMENTS (8- NOTES)
"RTN","PSOERX1B",123,0)
 ;PSOHY("SIG",#)=SIG (52.4911 (STRUCTURED SIG), FIELD 1 (SIG FREE TEXT)
"RTN","PSOERX1B",124,0)
 ;PSOHY("QTSUB",CNT)=QUANTITY TIMING SUBFILE DATA. MERGED IN, FULL SUBFILE DATA
"RTN","PSOERX1B",125,0)
 ; QUANTITY/TIMING MAPS DIRECTLY TO QUANTITY TIMING IN 52.41
"RTN","PSOERX1B",126,0)
SETUP ;
"RTN","PSOERX1B",127,0)
 N PSOIENS,PSODAT,F,PATIEN,PROVIEN,OC,VQTY,EFFDT,VADRUG,VAOI,VAREF,VAROUT,VAPRIOR,PSOHY,LOC,ERXNUM,PRVARY,PRVCOMM
"RTN","PSOERX1B",128,0)
 N PLOOP,PCNT,QTLOOP,QTCNT,PSOEXMS,DIR,ORDERTYP,PSOEXCNT,SCNT,SIGDAT,SLOOP,POORD,PMVAL,PRMVAL,DMVAL,PATINST,RXSTAT
"RTN","PSOERX1B",129,0)
 N VADAYS,UNEXPI,PINARY,WRITDT,SLOOP2
"RTN","PSOERX1B",130,0)
 S F=52.49
"RTN","PSOERX1B",131,0)
 Q:'$G(PSOIEN)
"RTN","PSOERX1B",132,0)
 D FULL^VALM1
"RTN","PSOERX1B",133,0)
 S VALMBCK="R"
"RTN","PSOERX1B",134,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERX1B",135,0)
 .W !!,"Cannot accept a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERX1B",136,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",137,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1B",138,0)
 D GETS^DIQ(F,PSOIENS,".01;.05;.07;1;1.3;1.5;1.7;2.1;2.3;3.2;5.9;6.2;6.3;8;20.1;20.2;20.4;20.5;20.6;25;25.2;27;30","IE","PSODAT")
"RTN","PSOERX1B",139,0)
 S PSOEXCNT=0
"RTN","PSOERX1B",140,0)
 S ERXSTA=$G(PSODAT(F,PSOIENS,1,"E")) I ERXSTA="E"!($E(ERXSTA)="H") S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="eRx is in a 'Hold' status." D MSGDIR^PSOERXU1(.PSOEXMS) Q
"RTN","PSOERX1B",141,0)
 S PMVAL=$G(PSODAT(F,PSOIENS,1.7,"I")) I 'PMVAL S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Patient has not been manually validated."
"RTN","PSOERX1B",142,0)
 S PRMVAL=$G(PSODAT(F,PSOIENS,1.3,"I")) I 'PRMVAL S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Provider has not been manually validated."
"RTN","PSOERX1B",143,0)
 S DMVAL=$G(PSODAT(F,PSOIENS,1.5,"I")) I 'DMVAL S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Drug has not been manually validated."
"RTN","PSOERX1B",144,0)
 ; for now, if validations have not occurred, do not check the other fields.
"RTN","PSOERX1B",145,0)
 I $O(PSOEXMS(0)) D MSGDIR^PSOERXU1(.PSOEXMS) Q
"RTN","PSOERX1B",146,0)
 S POORD=$G(PSODAT(F,PSOIENS,25.2,"I")) I POORD S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Pending outpatient order already exists."
"RTN","PSOERX1B",147,0)
 S PATIEN=$G(PSODAT(F,PSOIENS,.05,"I")) I 'PATIEN S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="No matched vista patient."
"RTN","PSOERX1B",148,0)
 S PROVIEN=$G(PSODAT(F,PSOIENS,2.3,"I")) I 'PROVIEN S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Provider not matched to a vista provider."
"RTN","PSOERX1B",149,0)
 S VADRUG=$G(PSODAT(F,PSOIENS,3.2,"I")) I 'VADRUG S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Drug not matched to a vista drug."
"RTN","PSOERX1B",150,0)
 S LOC=$G(PSODAT(F,PSOIENS,20.6,"I"))
"RTN","PSOERX1B",151,0)
 S ERXNUM=$G(PSODAT(F,PSOIENS,.01,"E")) I 'ERXNUM S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="eRx number missing."
"RTN","PSOERX1B",152,0)
 S VQTY=$G(PSODAT(F,PSOIENS,20.1,"E")) I 'VQTY S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Quantity missing."
"RTN","PSOERX1B",153,0)
 S EFFDT=$G(PSODAT(F,PSOIENS,6.3,"I")),WRITDT=$G(PSODAT(F,PSOIENS,5.9,"I"))
"RTN","PSOERX1B",154,0)
 ; if the effective date is passed in and there is no time, add .000001 to the date
"RTN","PSOERX1B",155,0)
 I EFFDT]"" S EFFDT=$P(EFFDT,".")
"RTN","PSOERX1B",156,0)
 I '$L(EFFDT) S EFFDT=WRITDT
"RTN","PSOERX1B",157,0)
 S VADAYS=$G(PSODAT(F,PSOIENS,20.2,"E"))
"RTN","PSOERX1B",158,0)
 S VAOI=$$GET1^DIQ(50,VADRUG,2.1,"I") I 'VAOI S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Orderable item not associated with drug."
"RTN","PSOERX1B",159,0)
 S VAREF=$G(PSODAT(F,PSOIENS,20.5,"E"))
"RTN","PSOERX1B",160,0)
 S VAROUT=$G(PSODAT(F,PSOIENS,20.4,"I")) I '$L(VAROUT) S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Pickup routing missing."
"RTN","PSOERX1B",161,0)
 S PATINST=$G(PSODAT(F,PSOIENS,27,"E"))
"RTN","PSOERX1B",162,0)
 D TXT2ARY^PSOERXD1(.PINARY,$$LSIG^PSOQUTIL(PATINST))
"RTN","PSOERX1B",163,0)
 ; get provider comments from VA PROVIDER COMMENTS field
"RTN","PSOERX1B",164,0)
 S PRVCOMM=$G(PSODAT(F,PSOIENS,30,"E"))
"RTN","PSOERX1B",165,0)
 D TXT2ARY^PSOERXD1(.PRVARY,$$LSIG^PSOQUTIL(PRVCOMM))
"RTN","PSOERX1B",166,0)
 S (PLOOP,PCNT)=0 F  S PLOOP=$O(PRVARY(PLOOP)) Q:'PLOOP  D
"RTN","PSOERX1B",167,0)
 .S PCNT=PCNT+1,PSOHY("PRCOM",PCNT)=$G(PRVARY(PLOOP))
"RTN","PSOERX1B",168,0)
 I '$O(^PS(52.49,PSOIEN,21,0)) S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Dosing information missing."
"RTN","PSOERX1B",169,0)
 S (QTLOOP,QTCNT)=0 F  S QTLOOP=$O(^PS(52.49,PSOIEN,21,QTLOOP)) Q:'QTLOOP  D
"RTN","PSOERX1B",170,0)
 .S QTCNT=QTCNT+1 M PSOHY("QTSUB",QTCNT)=^PS(52.49,PSOIEN,21,QTLOOP)
"RTN","PSOERX1B",171,0)
 ; always 'routine' for now
"RTN","PSOERX1B",172,0)
 S VAPRIOR="R"
"RTN","PSOERX1B",173,0)
 ; always 'new' for this version
"RTN","PSOERX1B",174,0)
 S ORDERTYP="NW"
"RTN","PSOERX1B",175,0)
 S PSOHY("LOC")=LOC,PSOHY("CHNUM")=$G(ERXNUM)
"RTN","PSOERX1B",176,0)
 S PSOHY("PICK")=VAROUT,PSOHY("ENTER")=PROVIEN
"RTN","PSOERX1B",177,0)
 S PSOHY("PROV")=PROVIEN,PSOHY("SDT")=EFFDT
"RTN","PSOERX1B",178,0)
 S PSOHY("ITEM")=VAOI,PSOHY("DRUG")=VADRUG
"RTN","PSOERX1B",179,0)
 S PSOHY("QTY")=VQTY,PSOHY("REF")=VAREF
"RTN","PSOERX1B",180,0)
 S (PSOHY("PAT"),DFN)=PATIEN,PSOHY("OCC")=ORDERTYP
"RTN","PSOERX1B",181,0)
 ; login date will always be the written date. if there is no written date by chance, use the received date
"RTN","PSOERX1B",182,0)
 ;S PSOHY("EDT")=$S(WRITDT'="":$P(WRITDT,"."),1:$P($$GET1^DIQ(52.49,PSOIEN,.03,"I"),"."))
"RTN","PSOERX1B",183,0)
 S PSOHY("EDT")=DT,PSOHY("PRIOR")=VAPRIOR
"RTN","PSOERX1B",184,0)
 ; ALWAYS PSO as the external application
"RTN","PSOERX1B",185,0)
 S PSOHY("EXAPP")="PHARMACY"
"RTN","PSOERX1B",186,0)
 S PSOHY("DAYS")=VADAYS
"RTN","PSOERX1B",187,0)
 ; sig from eRx
"RTN","PSOERX1B",188,0)
 S (SLOOP,SCNT)=0 F  S SLOOP=$O(^PS(52.49,PSOIEN,"SIG",SLOOP)) Q:'SLOOP  D
"RTN","PSOERX1B",189,0)
 .S SIGDAT=$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0))
"RTN","PSOERX1B",190,0)
 .S SCNT=SCNT+1,PSOHY("SIG",SCNT)=SIGDAT
"RTN","PSOERX1B",191,0)
 S SLOOP2=0 F  S SLOOP2=$O(PINARY(SLOOP2)) Q:'SLOOP2  D
"RTN","PSOERX1B",192,0)
 .S SCNT=SCNT+1,PSOHY("SIG",SCNT)=$G(PINARY(SLOOP2))
"RTN","PSOERX1B",193,0)
 ; if provider, patient or drug is missing, no need to continue.
"RTN","PSOERX1B",194,0)
 ; future consideration - do we need to check more fields?
"RTN","PSOERX1B",195,0)
 I $D(PSOEXMS) D MSGDIR^PSOERXU1(.PSOEXMS) Q
"RTN","PSOERX1B",196,0)
 D ADD
"RTN","PSOERX1B",197,0)
 I $G(PSOEXMS)]"" W !,PSOEXMS S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX1B",198,0)
 K DFN
"RTN","PSOERX1B",199,0)
 Q
"RTN","PSOERX1B",200,0)
ADD ;Add CHCS message to Outpatient Pending Orders file
"RTN","PSOERX1B",201,0)
 N PSOHQ,PSOHQT,PSOCPEND,PSOHINI,PSOHINLO,ERXSTA,ORDNUM,ILOOP,IARY,PSSRET,X
"RTN","PSOERX1B",202,0)
 S (PSOHINI,PSOHINLO)=0 D
"RTN","PSOERX1B",203,0)
 .I $G(PSOHY("LOC")) S PSOHINLO=$P($G(^SC(PSOHY("LOC"),0)),"^",4) I PSOHINLO Q
"RTN","PSOERX1B",204,0)
 .; FUTURE - consider enabling further institution checks. For now the institution is being pulled from either
"RTN","PSOERX1B",205,0)
 .; the institution associated with the hospital location, or below, from the eRx.
"RTN","PSOERX1B",206,0)
 .;I $G(PSOHY("LOC")) S PSOHINI=$P($G(^SC(PSOHY("LOC"),0)),"^",15)
"RTN","PSOERX1B",207,0)
 .;I '$G(PSOHINI) S PSOHINI=$O(^DG(40.8,0))
"RTN","PSOERX1B",208,0)
 .;S PSOHINLO=+$$SITE^VASITE(PSOHINI)
"RTN","PSOERX1B",209,0)
 ; get institution from 52.49 if clinic was not passed in
"RTN","PSOERX1B",210,0)
 I $G(PSOHINLO)<1 S PSOHINLO=$$GET1^DIQ(52.49,PSOIEN,24.1,"I")
"RTN","PSOERX1B",211,0)
 I +$G(PSOHINLO)<1 S PSOEXMS="Unable to derive Institution from Clinic." Q
"RTN","PSOERX1B",212,0)
 K DD,DO,DIC S X=PSOHY("CHNUM"),DIC="^PS(52.41,",DIC(0)="L"
"RTN","PSOERX1B",213,0)
 S:$G(PSOHY("PICK"))="" PSOHY("PICK")="M"
"RTN","PSOERX1B",214,0)
 S DIC("DR")="4////"_$G(PSOHY("ENTER"))_";5////"_PSOHY("PROV")_";6////"_$G(PSOHY("SDT"))_";8////"_PSOHY("ITEM")_";11////"_PSOHY("DRUG")_";12////"_$G(PSOHY("QTY"))_";13////"_$G(PSOHY("REF"))_";101////"_$G(PSOHY("DAYS"))
"RTN","PSOERX1B",215,0)
 D FILE^DICN K DD,DIC,DO I Y<0 S PSOEXMS="Unable to add order to Pending file." Q
"RTN","PSOERX1B",216,0)
 S PSOCPEND=+Y
"RTN","PSOERX1B",217,0)
 S $P(^PS(52.41,PSOCPEND,0),"^",2)=PSOHY("PAT"),$P(^(0),"^",3)=PSOHY("OCC"),$P(^(0),"^",12)=$G(PSOHY("EDT")),$P(^(0),"^",13)=$G(PSOHY("LOC"))
"RTN","PSOERX1B",218,0)
 S $P(^PS(52.41,PSOCPEND,0),"^",14)=$G(PSOHY("PRIOR")),$P(^(0),"^",17)=$G(PSOHY("PICK"))
"RTN","PSOERX1B",219,0)
 S $P(^PS(52.41,PSOCPEND,"EXT"),"^")=PSOHY("CHNUM"),$P(^("EXT"),"^",2)=0,$P(^("EXT"),"^",3)=PSOHY("EXAPP")
"RTN","PSOERX1B",220,0)
 S DIE="^PS(52.41,",DA=PSOCPEND,DR="104.1///1" D ^DIE K DIE,DA,DR
"RTN","PSOERX1B",221,0)
 ; PSO*7*506
"RTN","PSOERX1B",222,0)
 S FDA(52.41,PSOCPEND_",",104)=PATINST D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",223,0)
 N DA,DIK S DA=PSOCPEND,DIK="^PS(52.41,",DIK(1)="114^C" D EN1^DIK
"RTN","PSOERX1B",224,0)
 I $O(PSOHY("PRCOM",0)) D  I PSOHQT S ^PS(52.41,PSOCPEND,3,0)="^^"_PSOHQT_"^"_PSOHQT_"^"_DT_"^"
"RTN","PSOERX1B",225,0)
 .S PSOHQ="",PSOHQT=0 F  S PSOHQ=$O(PSOHY("PRCOM",PSOHQ)) Q:PSOHQ=""  I $G(PSOHY("PRCOM",PSOHQ))'="" S PSOHQT=PSOHQT+1,^PS(52.41,PSOCPEND,3,PSOHQT,0)=$G(PSOHY("PRCOM",PSOHQ))
"RTN","PSOERX1B",226,0)
 I $O(PSOHY("SIG",0)) D  I PSOHQT S ^PS(52.41,PSOCPEND,"SIG",0)="^52.4124A^"_PSOHQT_"^"_PSOHQT
"RTN","PSOERX1B",227,0)
 .S PSOHQ="",PSOHQT=0 F  S PSOHQ=$O(PSOHY("SIG",PSOHQ)) Q:PSOHQ=""  I $G(PSOHY("SIG",PSOHQ))'="" S PSOHQT=PSOHQT+1,^PS(52.41,PSOCPEND,"SIG",PSOHQT,0)=$G(PSOHY("SIG",PSOHQ))
"RTN","PSOERX1B",228,0)
 S $P(^PS(52.41,PSOCPEND,"INI"),"^")=$G(PSOHINLO)
"RTN","PSOERX1B",229,0)
 ; add quantity/timing subfile information
"RTN","PSOERX1B",230,0)
 I $O(PSOHY("QTSUB",0)) D  I PSOHQT S ^PS(52.41,PSOCPEND,1,0)="^52.413^"_PSOHQT_"^"_PSOHQT
"RTN","PSOERX1B",231,0)
 .S PSOHQ="",PSOHQT=0 F  S PSOHQ=$O(PSOHY("QTSUB",PSOHQ)) Q:PSOHQ=""  D
"RTN","PSOERX1B",232,0)
 ..I $O(PSOHY("QTSUB",PSOHQ,0)) S PSOHQT=PSOHQT+1
"RTN","PSOERX1B",233,0)
 ..S ^PS(52.41,PSOCPEND,1,PSOHQT,0)=PSOHY("QTSUB",PSOHQ,0)
"RTN","PSOERX1B",234,0)
 ..S ^PS(52.41,PSOCPEND,1,PSOHQT,1)=PSOHY("QTSUB",PSOHQ,1)
"RTN","PSOERX1B",235,0)
 ..S ^PS(52.41,PSOCPEND,1,PSOHQT,2)=PSOHY("QTSUB",PSOHQ,2)
"RTN","PSOERX1B",236,0)
 I $O(PINARY(0)) D WP^DIE(52.41,PSOCPEND_",",105,"K","PINARY")
"RTN","PSOERX1B",237,0)
 ;Cross references not set yet preventing Pharmacy from finishing order
"RTN","PSOERX1B",238,0)
 D EN^PSOHLSNC(PSOCPEND,"SN","IP")
"RTN","PSOERX1B",239,0)
 D FULL^VALM1
"RTN","PSOERX1B",240,0)
 ;Just set to DC, don't delete because 52.41 entry would be re-used
"RTN","PSOERX1B",241,0)
 ;I '$P($G(^PS(52.41,PSOCPEND,"EXT")),"^",2) S DA=PSOCPEND,DIK="^PS(52.41," D ^DIK K DIK,DA S PSOEXMS="Unable to send CHCS order to CPRS." D NAK^PSOHLEXC Q
"RTN","PSOERX1B",242,0)
 I '$P($G(^PS(52.41,PSOCPEND,"EXT")),"^",2) D  S $P(^PS(52.41,PSOCPEND,0),"^",3)="DC" S PSOEXMS="Unable to send CHCS order to CPRS." Q
"RTN","PSOERX1B",243,0)
 .;x-ref shouldn't be set, but we'll kill them just in case
"RTN","PSOERX1B",244,0)
 .K ^PS(52.41,"AOR",$P(^PS(52.41,PSOCPEND,0),"^",2),+$P($G(^("INI")),"^"),PSOCPEND),^PS(52.41,"AD",$P(^PS(52.41,PSOCPEND,0),"^",12),+$P($G(^("INI")),"^"),PSOCPEND)
"RTN","PSOERX1B",245,0)
 .K ^PS(52.41,"ACL",+$P(^PS(52.41,PSOCPEND,0),"^",13),$P(^(0),"^",12),PSOCPEND),^PS(52.41,"AQ",+$P($G(^PS(52.41,PSOCPEND,0)),"^",21),PSOCPEND)
"RTN","PSOERX1B",246,0)
 .S $P(^PS(52.41,PSOCPEND,4),"^")="External order, unable to successfully transmit to CPRS."
"RTN","PSOERX1B",247,0)
 .W !!,"External order, unable to successfully transmit to CPRS."
"RTN","PSOERX1B",248,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",249,0)
 ;Successful transmission to CPRS
"RTN","PSOERX1B",250,0)
 S DA=PSOCPEND,DIK="^PS(52.41," D IX^DIK
"RTN","PSOERX1B",251,0)
 ; add the pending outpatient order number to 52.49 and update status of eRx to PR (Processed)
"RTN","PSOERX1B",252,0)
 S ERXSTA=$O(^PS(52.45,"C","ERX","PR",0))
"RTN","PSOERX1B",253,0)
 S ORDNUM=$P($G(^PS(52.41,PSOCPEND,0)),U)
"RTN","PSOERX1B",254,0)
 S DIE="^PS(52.49,",DR="25.2///"_PSOCPEND_";.12///"_ORDNUM,DA=PSOIEN D ^DIE K DIE,DA,DR
"RTN","PSOERX1B",255,0)
 ; add activity to status history
"RTN","PSOERX1B",256,0)
 D UPDSTAT^PSOERXU1(PSOIEN,"PR")
"RTN","PSOERX1B",257,0)
 ; gather the unexpanded sig and file in 52.41
"RTN","PSOERX1B",258,0)
 S ILOOP=0 F  S ILOOP=$O(^PS(52.49,PSOIEN,31,ILOOP)) Q:'ILOOP  D
"RTN","PSOERX1B",259,0)
 .S IARY(ILOOP)=$G(^PS(52.49,PSOIEN,31,ILOOP,0))
"RTN","PSOERX1B",260,0)
 I $D(IARY) D WP^DIE(52.41,PSOCPEND_",",9,"K","IARY","IERR")
"RTN","PSOERX1B",261,0)
 W !!,"eRx #"_PSOHY("CHNUM")_" sent to PENDING OUTPATIENT ORDERS!"
"RTN","PSOERX1B",262,0)
 ;PSO*7*520 - add sending and warning/information related to RxVerify Message.
"RTN","PSOERX1B",263,0)
 W !!,"Sending rxVerify Message to prescriber."
"RTN","PSOERX1B",264,0)
 D POST^PSOERXO1(PSOIEN,.PSSRET,,,,1)
"RTN","PSOERX1B",265,0)
 ; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERX1B",266,0)
 I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX1B",267,0)
 I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX1B",268,0)
 ;PSO*7*520 - end rxVerify changes
"RTN","PSOERX1B",269,0)
 Q
"RTN","PSOERX1B",270,0)
 ; remove eRx from holding queue
"RTN","PSOERX1B",271,0)
REM ;
"RTN","PSOERX1B",272,0)
 D REM^PSOERXU4
"RTN","PSOERX1B",273,0)
 Q
"RTN","PSOERX1B",274,0)
 ; reject eRx
"RTN","PSOERX1B",275,0)
REJ ;
"RTN","PSOERX1B",276,0)
 D REJ^PSOERXU4
"RTN","PSOERX1B",277,0)
 Q
"RTN","PSOERX1C")
0^3^B40751092^B35864468
"RTN","PSOERX1C",1,0)
PSOERX1C ;ALB/BWF - eRx Utilities ; 8/3/2016 5:14pm
"RTN","PSOERX1C",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520**;DEC 1997;Build 52
"RTN","PSOERX1C",3,0)
 ;
"RTN","PSOERX1C",4,0)
 Q
"RTN","PSOERX1C",5,0)
 ; select an item
"RTN","PSOERX1C",6,0)
PRINT(PSOIEN,OP) ;
"RTN","PSOERX1C",7,0)
 N %ZIS,POP
"RTN","PSOERX1C",8,0)
 S OP=$G(OP)
"RTN","PSOERX1C",9,0)
 D FULL^VALM1
"RTN","PSOERX1C",10,0)
 S VALMBCK="R"
"RTN","PSOERX1C",11,0)
 S %ZIS="Q",%ZIS("B")=$G(PSOPROP) D ^%ZIS Q:POP
"RTN","PSOERX1C",12,0)
 ; if queuing, queue it and quit.
"RTN","PSOERX1C",13,0)
 I $D(IO("Q")) D  Q
"RTN","PSOERX1C",14,0)
 .S ZTSAVE("PSOIEN")="",ZTSAVE("OP")=""
"RTN","PSOERX1C",15,0)
 .S ZTRTN="PRINTQ^PSOERX1C(PSOIEN,OP)",ZTDESC="eRx Print" D ^%ZTLOAD
"RTN","PSOERX1C",16,0)
 .K ZTSAVE,ZTRTN
"RTN","PSOERX1C",17,0)
 .D INIT^PSOERX1
"RTN","PSOERX1C",18,0)
 .D TERM^VALM0
"RTN","PSOERX1C",19,0)
 D PRINTQ(PSOIEN,OP)
"RTN","PSOERX1C",20,0)
 D TERM^VALM0
"RTN","PSOERX1C",21,0)
 D INIT^PSOERX1
"RTN","PSOERX1C",22,0)
 Q
"RTN","PSOERX1C",23,0)
 ; fallthrough if no queueing
"RTN","PSOERX1C",24,0)
PRINTQ(PSOIEN,OP) ;
"RTN","PSOERX1C",25,0)
 N %ZIS,POP,RXDAT,PHARIEN,PRVIEN,PATIEN,PHARDAT,PRVDAT,PATDAT,PSOIENS,PHNM,PHAD1,PHAD2,PHCTY
"RTN","PSOERX1C",26,0)
 N PHST,PHZIP,PHNCP,PHTEL,PRFNM,PRLNM,PRMNM,PRAD1,PRAD2,PRCTY,PRST,PRZIP,PRNPI,PRDEA,PRSTL,LTXT
"RTN","PSOERX1C",27,0)
 N PRTEL,PRFAX,PRSUPER,PRAGNT,PTLNM,PTFNM,PTMNM,PTAD1,PTAD2,PTCTY,PTST,PTZIP,PTDOB,PTGEN,PTHPHON,PTPLANID
"RTN","PSOERX1C",28,0)
 N PHARIENS,PATIENS,PRVIENS,PTSSN,PRAGNTFN,PRAGNTMN,PRAGNTLN,TYPE,VALUE,PRFAX,PRTEL,SIEN,REFILL,IENS
"RTN","PSOERX1C",29,0)
 S OP=$G(OP,"")
"RTN","PSOERX1C",30,0)
 S PSOIEN=$G(PSOIEN)
"RTN","PSOERX1C",31,0)
 I '$G(PSOIEN) D
"RTN","PSOERX1C",32,0)
 .I $D(RXOR) S PSOIEN=$$CHKERX^PSOERXU1($P(RXOR,U,2)) Q:PSOIEN
"RTN","PSOERX1C",33,0)
 .I $D(OR0) S PSOIEN=$$CHKERX^PSOERXU1(OR0)
"RTN","PSOERX1C",34,0)
 Q:'$G(PSOIEN)
"RTN","PSOERX1C",35,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1C",36,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","PSOERX1C",37,0)
 U IO
"RTN","PSOERX1C",38,0)
 D GETS^DIQ(52.49,PSOIENS,".04;2.1;2.5","I","RXDAT")
"RTN","PSOERX1C",39,0)
 S PHARIEN=$G(RXDAT(52.49,PSOIENS,2.5,"I")) I PHARIEN S PHARIENS=PHARIEN_","
"RTN","PSOERX1C",40,0)
 S PRVIEN=$G(RXDAT(52.49,PSOIENS,2.1,"I")) I PRVIEN S PRVIENS=PRVIEN_","
"RTN","PSOERX1C",41,0)
 S PATIEN=$G(RXDAT(52.49,PSOIENS,.04,"I")) I PATIEN S PATIENS=PATIEN_","
"RTN","PSOERX1C",42,0)
 D GETS^DIQ(52.47,PHARIENS,"**","E","PHARDAT")
"RTN","PSOERX1C",43,0)
 D GETS^DIQ(52.48,PRVIENS,"**","E","PRVDAT")
"RTN","PSOERX1C",44,0)
 D GETS^DIQ(52.46,PATIENS,"**","E","PATDAT")
"RTN","PSOERX1C",45,0)
 ; pharmacy information
"RTN","PSOERX1C",46,0)
 S PHNM=$G(PHARDAT(52.47,PHARIENS,.05,"E"))
"RTN","PSOERX1C",47,0)
 S PHAD1=$G(PHARDAT(52.47,PHARIENS,1.1,"E"))
"RTN","PSOERX1C",48,0)
 S PHAD2=$G(PHARDAT(52.47,PHARIENS,1.2,"E"))
"RTN","PSOERX1C",49,0)
 S PHCTY=$G(PHARDAT(52.47,PHARIENS,1.3,"E"))
"RTN","PSOERX1C",50,0)
 S PHST=$G(PHARDAT(52.47,PHARIENS,1.4,"E"))
"RTN","PSOERX1C",51,0)
 S PHZIP=$G(PHARDAT(52.47,PHARIENS,1.5,"E"))
"RTN","PSOERX1C",52,0)
 S PHNCP=$G(PHARDAT(52.47,PHARIENS,.02,"E"))
"RTN","PSOERX1C",53,0)
 ; todo - get telephone
"RTN","PSOERX1C",54,0)
 S PHTEL=""
"RTN","PSOERX1C",55,0)
 ; provider information
"RTN","PSOERX1C",56,0)
 S PRFNM=$G(PRVDAT(52.48,PRVIENS,.03,"E"))
"RTN","PSOERX1C",57,0)
 S PRMNM=$G(PRVDAT(52.48,PRVIENS,.04,"E"))
"RTN","PSOERX1C",58,0)
 S PRLNM=$G(PRVDAT(52.48,PRVIENS,.02,"E"))
"RTN","PSOERX1C",59,0)
 S PRAD1=$G(PRVDAT(52.48,PRVIENS,4.1,"E"))
"RTN","PSOERX1C",60,0)
 S PRAD2=$G(PRVDAT(52.48,PRVIENS,4.2,"E"))
"RTN","PSOERX1C",61,0)
 S PRCTY=$G(PRVDAT(52.48,PRVIENS,4.3,"E"))
"RTN","PSOERX1C",62,0)
 S PRST=$G(PRVDAT(52.48,PRVIENS,4.4,"E"))
"RTN","PSOERX1C",63,0)
 S PRZIP=$G(PRVDAT(52.48,PRVIENS,4.5,"E"))
"RTN","PSOERX1C",64,0)
 S PRNPI=$G(PRVDAT(52.48,PRVIENS,1.5,"E"))
"RTN","PSOERX1C",65,0)
 S PRDEA=$G(PRVDAT(52.48,PRVIENS,1.6,"E"))
"RTN","PSOERX1C",66,0)
 S PRSTL=$G(PRVDAT(52.48,PRVIENS,1.8,"E"))
"RTN","PSOERX1C",67,0)
 S PRSUPER=$$GET1^DIQ(52.49,PSOIEN,2.6,"E")
"RTN","PSOERX1C",68,0)
 S PRAGNTFN=$$GET1^DIQ(52.48,PRVIEN,5.2,"E")
"RTN","PSOERX1C",69,0)
 S PRAGNTMN=$$GET1^DIQ(52.48,PRVIEN,5.3,"E")
"RTN","PSOERX1C",70,0)
 S PRAGNTLN=$$GET1^DIQ(52.48,PRVIEN,5.1,"E")
"RTN","PSOERX1C",71,0)
 ;/BLB/ PSO*7.0*520  - BEGIN CHANGE
"RTN","PSOERX1C",72,0)
 S SIEN=0
"RTN","PSOERX1C",73,0)
 F  S SIEN=$O(^PS(52.48,PRVIEN,3,SIEN)) Q:'SIEN  D
"RTN","PSOERX1C",74,0)
 .S IENS=SIEN_","_PRVIEN_","
"RTN","PSOERX1C",75,0)
 .S TYPE=$$GET1^DIQ(52.483,IENS,.02)
"RTN","PSOERX1C",76,0)
 .S VALUE=$$GET1^DIQ(52.483,IENS,.01)
"RTN","PSOERX1C",77,0)
 .I TYPE="FAX" S PRFAX=VALUE
"RTN","PSOERX1C",78,0)
 .I TYPE="TELEPHONE" S PRTEL=VALUE
"RTN","PSOERX1C",79,0)
 ;/BLN/ - END CHANGE
"RTN","PSOERX1C",80,0)
 ; patient information
"RTN","PSOERX1C",81,0)
 S PTLNM=$G(PATDAT(52.46,PATIENS,.02,"E"))
"RTN","PSOERX1C",82,0)
 S PTMNM=$G(PATDAT(52.46,PATIENS,.04,"E"))
"RTN","PSOERX1C",83,0)
 S PTFNM=$G(PATDAT(52.46,PATIENS,.03,"E"))
"RTN","PSOERX1C",84,0)
 S PTAD1=$G(PATDAT(52.46,PATIENS,3.1,"E"))
"RTN","PSOERX1C",85,0)
 S PTAD2=$G(PATDAT(52.46,PATIENS,3.2,"E"))
"RTN","PSOERX1C",86,0)
 S PTCTY=$G(PATDAT(52.46,PATIENS,3.3,"E"))
"RTN","PSOERX1C",87,0)
 S PTST=$G(PATDAT(52.46,PATIENS,3.4,"E"))
"RTN","PSOERX1C",88,0)
 S PTZIP=$G(PATDAT(52.46,PATIENS,3.5,"E"))
"RTN","PSOERX1C",89,0)
 S PTDOB=$G(PATDAT(52.46,PATIENS,.08,"E"))
"RTN","PSOERX1C",90,0)
 S PTGEN=$G(PATDAT(52.46,PATIENS,.07,"E"))
"RTN","PSOERX1C",91,0)
 S PTSSN=$G(PATDAT(52.46,PATIENS,1.4,"E"))
"RTN","PSOERX1C",92,0)
 S PTHPHON=""
"RTN","PSOERX1C",93,0)
 S PTPLANID=""
"RTN","PSOERX1C",94,0)
 W !,"*************************PHARMACY INFORMATION****************************"
"RTN","PSOERX1C",95,0)
 W !,$$UP^XLFSTR(PHNM)
"RTN","PSOERX1C",96,0)
 W !,"Address: "_PHAD1
"RTN","PSOERX1C",97,0)
 I $L(PHAD2) W !,"         "_PHAD2
"RTN","PSOERX1C",98,0)
 W !,!,"         "_PHCTY_", "_PHST_" "_PHZIP
"RTN","PSOERX1C",99,0)
 S LTXT=""
"RTN","PSOERX1C",100,0)
 D ADDITEM^PSOERX1A(.LTXT,"Tel: ",PHTEL,1,26)
"RTN","PSOERX1C",101,0)
 D ADDITEM^PSOERX1A(.LTXT,"NCPDP: ",PHNCP,28,26)
"RTN","PSOERX1C",102,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",103,0)
 W !,"******************PRESCRIBER INFORMATION*********************************"
"RTN","PSOERX1C",104,0)
 ; /BLB/ PSO*7.0*520 - CHANGED ORDER OF NAMES TO LAST,FIRST,MIDDLE - BEGIN CHANGE
"RTN","PSOERX1C",105,0)
 W !,"Last: "_PRLNM
"RTN","PSOERX1C",106,0)
 W !,"First: "_PRFNM
"RTN","PSOERX1C",107,0)
 W !,"Mid: "_PRMNM
"RTN","PSOERX1C",108,0)
 ; /BLB/ - END CHANGE
"RTN","PSOERX1C",109,0)
 W !,"Address: "_PRAD1
"RTN","PSOERX1C",110,0)
 I $L(PHAD2) W !,"         "_PRAD2
"RTN","PSOERX1C",111,0)
 W !,"         "_PRCTY_", "_PRST_" "_PRZIP
"RTN","PSOERX1C",112,0)
 S LTXT=""
"RTN","PSOERX1C",113,0)
 D ADDITEM^PSOERX1A(.LTXT,"NPI: ",PRNPI,1,26)
"RTN","PSOERX1C",114,0)
 D ADDITEM^PSOERX1A(.LTXT,"DEA: ",PRDEA,28,26)
"RTN","PSOERX1C",115,0)
 D ADDITEM^PSOERX1A(.LTXT,"State Lic: ",PRSTL,54,26)
"RTN","PSOERX1C",116,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",117,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1C",118,0)
 W !,"Tel: "_$G(PRTEL)
"RTN","PSOERX1C",119,0)
 W !,"Fax: "_$G(PRFAX)
"RTN","PSOERX1C",120,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",121,0)
 W !,"Supervisor: "_$G(PRSUPER)
"RTN","PSOERX1C",122,0)
 W !,"Agent Last Name: "_$G(PRAGNTLN)
"RTN","PSOERX1C",123,0)
 W !,"Agent First Name: "_$G(PRAGNTFN)
"RTN","PSOERX1C",124,0)
 W !,"Agent Middle Name: "_$G(PRAGNTMN)
"RTN","PSOERX1C",125,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",126,0)
 W !,"******************PATIENT INFORMATION************************************"
"RTN","PSOERX1C",127,0)
 S LTXT=""
"RTN","PSOERX1C",128,0)
 ;/BLB/PSO*7.0*520 RESTRUCTURED ORDER OF PATIENT NAME - BEGIN CHANGE
"RTN","PSOERX1C",129,0)
 W !,"Last: "_PTLNM
"RTN","PSOERX1C",130,0)
 W !,"First: "_PTFNM
"RTN","PSOERX1C",131,0)
 W !,"Mid: "_PTMNM
"RTN","PSOERX1C",132,0)
 ;/BLB END CHANGE
"RTN","PSOERX1C",133,0)
 W !,LTXT
"RTN","PSOERX1C",134,0)
 S LTXT=""
"RTN","PSOERX1C",135,0)
 D ADDITEM^PSOERX1A(.LTXT,"SSN: ",PTSSN,1,28)
"RTN","PSOERX1C",136,0)
 D ADDITEM^PSOERX1A(.LTXT,"Sex: ",PTGEN,30,20) W !,LTXT S LTXT=""
"RTN","PSOERX1C",137,0)
 W !,"Address: "_PTAD1
"RTN","PSOERX1C",138,0)
 I $L(PTAD2) W !,"         "_PTAD2
"RTN","PSOERX1C",139,0)
 W !,"         "_PTCTY_", "_PTST_" "_PTZIP
"RTN","PSOERX1C",140,0)
 S LTXT=""
"RTN","PSOERX1C",141,0)
 D ADDITEM^PSOERX1A(.LTXT,"DOB: ",PTDOB,1,26)
"RTN","PSOERX1C",142,0)
 D ADDITEM^PSOERX1A(.LTXT,"Home: ",PTHPHON,28,16)
"RTN","PSOERX1C",143,0)
 D ADDITEM^PSOERX1A(.LTXT,"Plan ID: ",PTPLANID,52,27)
"RTN","PSOERX1C",144,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",145,0)
 W !,"******************PRESCRIPTION INFORMATION*******************************"
"RTN","PSOERX1C",146,0)
 W !,"eRx Drug: "_$$GET1^DIQ(52.49,PSOIEN,3.1,"E")
"RTN","PSOERX1C",147,0)
 S LTXT=""
"RTN","PSOERX1C",148,0)
 D ADDITEM^PSOERX1A(.LTXT,"Qty: ",$$GET1^DIQ(52.49,PSOIEN,5.1,"E"),1,26)
"RTN","PSOERX1C",149,0)
 D ADDITEM^PSOERX1A(.LTXT,"Days Supply: ",$$GET1^DIQ(52.49,PSOIEN,5.5,"E"),28,16)
"RTN","PSOERX1C",150,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE - MOVING "Written Date" TO ITS OWN LINE
"RTN","PSOERX1C",151,0)
 ;D ADDITEM^PSOERX1A(.LTXT,"Date Written: ",$$FMTE^XLFDT($$GET1^DIQ(52.49,PSOIEN,5.9,"E"),"2D"),52,27)
"RTN","PSOERX1C",152,0)
 W !,"Date Written: "_$$FMTE^XLFDT($$GET1^DIQ(52.49,PSOIEN,5.9,"E"),"2D")
"RTN","PSOERX1C",153,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",154,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",155,0)
 ;/BLB/PSO*7.0*520 REMOVED ADDITEM CALLS AND MOVED FIELDS TO INDIVIDUAL LINES - BEGIN CHANGE
"RTN","PSOERX1C",156,0)
 W !,"Qty Qualifier: "_$$GET1^DIQ(52.49,PSOIEN,5.2,"E")
"RTN","PSOERX1C",157,0)
 W !,"Drug Form: "_$$GET1^DIQ(52.49,PSOIEN,41,"E")
"RTN","PSOERX1C",158,0)
 W !,"Strength: "_$$GET1^DIQ(52.49,PSOIEN,43,"E")
"RTN","PSOERX1C",159,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",160,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",161,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1C",162,0)
 S REFILL=$$GET1^DIQ(52.49,PSOIEN,5.6,"E")
"RTN","PSOERX1C",163,0)
 I REFILL'="" D
"RTN","PSOERX1C",164,0)
 .W !,"Refills: "_REFILL
"RTN","PSOERX1C",165,0)
 I REFILL="" D
"RTN","PSOERX1C",166,0)
 .S REFILL=$$GET1^DIQ(52.49,PSOIEN,5.7,"I")
"RTN","PSOERX1C",167,0)
 .W !,"Refills: "_REFILL
"RTN","PSOERX1C",168,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",169,0)
 W !,"SIG: "_$$GET1^DIQ(52.49,PSOIEN,7,"E")
"RTN","PSOERX1C",170,0)
 D ADDITEM^PSOERX1A(.LTXT,"eRx Reference #: ",$$GET1^DIQ(52.49,PSOIEN,.01,"E"),1,40)
"RTN","PSOERX1C",171,0)
 D ADDITEM^PSOERX1A(.LTXT,"Message ID: ",$$GET1^DIQ(52.49,PSOIEN,25,"E"),42,35)
"RTN","PSOERX1C",172,0)
 W !!,LTXT S LTXT=""
"RTN","PSOERX1C",173,0)
 W !,"Dispense Notes: "_$$GET1^DIQ(52.49,PSOIEN,5.8,"E")
"RTN","PSOERX1C",174,0)
 W !,"Comments: "_$$GET1^DIQ(52.49,PSOIEN,8,"E")
"RTN","PSOERX1C",175,0)
 W !,"******************END OF eRx*********************************************"
"RTN","PSOERX1C",176,0)
 D:'$D(ZTQUEUED) ^%ZISC
"RTN","PSOERX1C",177,0)
 Q
"RTN","PSOERXA1")
0^9^B233267035^B228588207
"RTN","PSOERXA1",1,0)
PSOERXA1 ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERXA1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520**;DEC 1997;Build 52
"RTN","PSOERXA1",3,0)
 ;
"RTN","PSOERXA1",4,0)
 Q
"RTN","PSOERXA1",5,0)
 ; File incoming XML into appropriate file
"RTN","PSOERXA1",6,0)
 ; XML - xml text
"RTN","PSOERXA1",7,0)
 ; PRCHK - provider check information
"RTN","PSOERXA1",8,0)
 ; PACHK - patient check information
"RTN","PSOERXA1",9,0)
 ; DACHK - drug auto check
"RTN","PSOERXA1",10,0)
 ; STATION - station #
"RTN","PSOERXA1",11,0)
 ; DIV - division
"RTN","PSOERXA1",12,0)
 ; ERXHID - eRx processing hub id
"RTN","PSOERXA1",13,0)
 ; ERXVALS - code values for NIST codes
"RTN","PSOERXA1",14,0)
INCERX(RES,XML,PRCHK,PACHK,DACHK,STATION,DIV,ERXHID,ERXVALS,XML2) ;
"RTN","PSOERXA1",15,0)
 N CURREC,FDA,EIEN,ERRTXT,ERRSEQ,PACNT,PASCNT,PAICN,PAIEN,VAINST,NPI,VAOI,VPATINST
"RTN","PSOERXA1",16,0)
 ; meds by mail modification. Same institution pointed to by multiple outpatient pharmacy systems.
"RTN","PSOERXA1",17,0)
 ; additionally, 741CHEY and 741DUB are not associated with an institution in file 4.
"RTN","PSOERXA1",18,0)
 S NPI=$P($G(DIV),U,2)
"RTN","PSOERXA1",19,0)
 S CURREC=$$PARSE(.XML,.ERXVALS,NPI,.XML2)
"RTN","PSOERXA1",20,0)
 I $P(CURREC,U)<1 D  Q
"RTN","PSOERXA1",21,0)
 .I $L($P(CURREC,U,2)) S RES=CURREC Q
"RTN","PSOERXA1",22,0)
 .S RES="0^XML received. Error creating or finding associated record in the ERX Holding queue." Q
"RTN","PSOERXA1",23,0)
 S EIEN=CURREC
"RTN","PSOERXA1",24,0)
 S CURREC=CURREC_","
"RTN","PSOERXA1",25,0)
 ; Process auto-validation results. only log positive results for now - bwf 2/1/2017
"RTN","PSOERXA1",26,0)
 K FDA
"RTN","PSOERXA1",27,0)
 I DACHK("success")="true" D
"RTN","PSOERXA1",28,0)
 .I $G(DACHK("IEN")) D
"RTN","PSOERXA1",29,0)
 ..S FDA(52.49,CURREC,1.4)=1
"RTN","PSOERXA1",30,0)
 ..S FDA(52.49,CURREC,3.2)=DACHK("IEN")
"RTN","PSOERXA1",31,0)
 ..S FDA(52.49,CURREC,44)=1
"RTN","PSOERXA1",32,0)
 ..S VAOI=$$GET1^DIQ(50,DACHK("IEN"),2.1,"I")
"RTN","PSOERXA1",33,0)
 ..S VPATINST=$$GET1^DIQ(50.7,VAOI,7,"E")
"RTN","PSOERXA1",34,0)
 ..I $L(VPATINST) S FDA(52.49,CURREC,27)=VPATINST
"RTN","PSOERXA1",35,0)
 I DACHK("success")="false" D
"RTN","PSOERXA1",36,0)
 .S ERRTXT=$G(DACHK("error"))
"RTN","PSOERXA1",37,0)
 .S ERRSEQ=$$ERRSEQ^PSOERXU1() Q:'ERRSEQ
"RTN","PSOERXA1",38,0)
 .D FILERR^PSOERXU1(CURREC,ERRSEQ,"D","E",ERRTXT)
"RTN","PSOERXA1",39,0)
 I $G(PRCHK("success"))="true" D
"RTN","PSOERXA1",40,0)
 .I PRCHK("IEN") D
"RTN","PSOERXA1",41,0)
 ..S FDA(52.49,CURREC,1.2)=1
"RTN","PSOERXA1",42,0)
 ..S FDA(52.49,CURREC,2.3)=PRCHK("IEN")
"RTN","PSOERXA1",43,0)
 I $G(PRCHK("success"))="false" D
"RTN","PSOERXA1",44,0)
 .S ERRTXT=$G(PRCHK("error"))
"RTN","PSOERXA1",45,0)
 .S ERRSEQ=$$ERRSEQ^PSOERXU1() Q:'ERRSEQ
"RTN","PSOERXA1",46,0)
 .D FILERR^PSOERXU1(CURREC,ERRSEQ,"PR","E",ERRTXT)
"RTN","PSOERXA1",47,0)
 ; replacing below line with the one that follows for patient matching
"RTN","PSOERXA1",48,0)
 ; if there is no MVIerror, the MVI check was successful, so we need to try to auto-match the patient
"RTN","PSOERXA1",49,0)
 ;I PACHK("success")="true" D
"RTN","PSOERXA1",50,0)
 I $G(PACHK("MVIerror"))']"" D
"RTN","PSOERXA1",51,0)
 .S PAICN=+$P($G(PACHK("ICN")),"V")
"RTN","PSOERXA1",52,0)
 .I PAICN D
"RTN","PSOERXA1",53,0)
 ..S (PAIEN,PACNT)=0 F  S PAIEN=$O(^DPT("AICN",PAICN,PAIEN)) Q:'PAIEN  D
"RTN","PSOERXA1",54,0)
 ...S PACNT=PACNT+1
"RTN","PSOERXA1",55,0)
 ...; revisit in future build - if we find more than one match in the local system, do we log some sort of an error?
"RTN","PSOERXA1",56,0)
 .I $G(PACNT)=1 D  Q
"RTN","PSOERXA1",57,0)
 ..S FDA(52.49,CURREC,1.6)=1
"RTN","PSOERXA1",58,0)
 ..S FDA(52.49,CURREC,.05)=$O(^DPT("AICN",PAICN,0))
"RTN","PSOERXA1",59,0)
 .I $L(PACHK("ssn")) D
"RTN","PSOERXA1",60,0)
 ..S (PASCNT,PAIEN)=0 F  S PAIEN=$O(^DPT("SSN",$TR(PACHK("ssn"),"-",""),PAIEN)) Q:'PAIEN  D
"RTN","PSOERXA1",61,0)
 ...S PASCNT=PASCNT+1
"RTN","PSOERXA1",62,0)
 .I $G(PASCNT)=1 D  Q
"RTN","PSOERXA1",63,0)
 ..S FDA(52.49,CURREC,1.6)=1
"RTN","PSOERXA1",64,0)
 ..S FDA(52.49,CURREC,.05)=$O(^DPT("SSN",$TR(PACHK("ssn"),"-",""),0))
"RTN","PSOERXA1",65,0)
 I $D(FDA) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",66,0)
 I $G(PACHK("success"))="false" D
"RTN","PSOERXA1",67,0)
 .; file e&e error
"RTN","PSOERXA1",68,0)
 .S ERRTXT=$G(PACHK("EandEerror")) I ERRTXT]"" D
"RTN","PSOERXA1",69,0)
 ..S ERRSEQ=$$ERRSEQ^PSOERXU1() Q:'ERRSEQ
"RTN","PSOERXA1",70,0)
 ..D FILERR^PSOERXU1(CURREC,ERRSEQ,"PA","E",ERRTXT)
"RTN","PSOERXA1",71,0)
 .; file mvi error
"RTN","PSOERXA1",72,0)
 .S ERRTXT=$G(PACHK("MVIerror")) I ERRTXT]"" D
"RTN","PSOERXA1",73,0)
 ..S ERRSEQ=$$ERRSEQ^PSOERXU1() Q:'ERRSEQ
"RTN","PSOERXA1",74,0)
 ..D FILERR^PSOERXU1(CURREC,ERRSEQ,"PA","E",ERRTXT)
"RTN","PSOERXA1",75,0)
 S RES="1^Erx Received."
"RTN","PSOERXA1",76,0)
 Q
"RTN","PSOERXA1",77,0)
PARSE(STREAM,ERXVALS,NPI,STREAM2) ;
"RTN","PSOERXA1",78,0)
 N %XML,GL,VAINST
"RTN","PSOERXA1",79,0)
 S GL=$NA(^TMP($J,"PSOERXO1"))
"RTN","PSOERXA1",80,0)
 K @GL
"RTN","PSOERXA1",81,0)
 N STATUS,READER,XOBERR,S,ATTR,READER2,XOBERR2,STATUS2
"RTN","PSOERXA1",82,0)
 S STREAM=$TR(STREAM,"^","")
"RTN","PSOERXA1",83,0)
 I $L(STREAM2) S STREAM2=$TR(STREAM2,"^","")
"RTN","PSOERXA1",84,0)
 S STATUS=##class(%XML.TextReader).ParseStream(STREAM,.READER,,,,,1)
"RTN","PSOERXA1",85,0)
 I $L(STREAM2) S STATUS2=##class(%XML.TextReader).ParseStream(STREAM2,.READER2,,,,,1)
"RTN","PSOERXA1",86,0)
 I $$STATCHK^XOBWLIB(STATUS,.XOBERR,1) D
"RTN","PSOERXA1",87,0)
 .N BREAK
"RTN","PSOERXA1",88,0)
 .S BREAK=0 F  Q:BREAK||READER.EOF||'READER.Read()  D
"RTN","PSOERXA1",89,0)
 ..N X,PUSHED,PARENT
"RTN","PSOERXA1",90,0)
 ..I READER.AttributeCount D
"RTN","PSOERXA1",91,0)
 ...S PARENT=READER.LocalName
"RTN","PSOERXA1",92,0)
 ...D SPUSH(.S,PARENT) S PUSHED=1
"RTN","PSOERXA1",93,0)
 ...F ATTR=1:1:READER.AttributeCount D
"RTN","PSOERXA1",94,0)
 ....D READER.MoveToAttributeIndex(ATTR)
"RTN","PSOERXA1",95,0)
 ....I READER.NodeType="attribute" D APUT(.S,READER.Value,READER.LocalName)
"RTN","PSOERXA1",96,0)
 ..I READER.NodeType="element",'$G(PUSHED) D SPUSH(.S,READER.LocalName)
"RTN","PSOERXA1",97,0)
 ..I READER.NodeType="endelement" D SPOP(.S,.X)
"RTN","PSOERXA1",98,0)
 ..I READER.NodeType="chars" D SPUT(.S,READER.Value)
"RTN","PSOERXA1",99,0)
 I $$STATCHK^XOBWLIB(STATUS2,.XOBERR2,1) D
"RTN","PSOERXA1",100,0)
 .N BREAK,S
"RTN","PSOERXA1",101,0)
 .S BREAK=0 F  Q:BREAK||READER2.EOF||'READER2.Read()  D
"RTN","PSOERXA1",102,0)
 ..N X,PUSHED,PARENT
"RTN","PSOERXA1",103,0)
 ..I READER2.AttributeCount D
"RTN","PSOERXA1",104,0)
 ...S PARENT=READER2.LocalName
"RTN","PSOERXA1",105,0)
 ...D SPUSH(.S,PARENT) S PUSHED=1
"RTN","PSOERXA1",106,0)
 ...F ATTR=1:1:READER2.AttributeCount D
"RTN","PSOERXA1",107,0)
 ....D READER2.MoveToAttributeIndex(ATTR)
"RTN","PSOERXA1",108,0)
 ....I READER2.NodeType="attribute" D APUT(.S,READER2.Value,READER2.LocalName)
"RTN","PSOERXA1",109,0)
 ..I READER2.NodeType="element",'$G(PUSHED) D SPUSH(.S,READER2.LocalName)
"RTN","PSOERXA1",110,0)
 ..I READER2.NodeType="endelement" D SPOP(.S,.X)
"RTN","PSOERXA1",111,0)
 ..I READER2.NodeType="chars" D SPUT(.S,READER2.Value)
"RTN","PSOERXA1",112,0)
 I '$L(NPI) S NPI=$G(^TMP($J,"PSOERXO1","Message",0,"Body",0,"NewRx",0,"Pharmacy",0,"Identification",0,"NPI",0))
"RTN","PSOERXA1",113,0)
 I '$L(NPI) Q "0^Missing NPI. Institution could not be resolved. eRx not filed."
"RTN","PSOERXA1",114,0)
 S VAINST=$$FIND1^DIC(4,,"O",NPI,"ANPI")
"RTN","PSOERXA1",115,0)
 I '$G(VAINST) Q "0^Institution could not be resolved. eRx not filed."
"RTN","PSOERXA1",116,0)
 N NERXIEN,ERR
"RTN","PSOERXA1",117,0)
 S NERXIEN=$$HDR()
"RTN","PSOERXA1",118,0)
 I $P(NERXIEN,U)<1 Q NERXIEN
"RTN","PSOERXA1",119,0)
 I $G(VAINST) S FDA(52.49,NERXIEN_",",24.1)=VAINST D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",120,0)
 D PAT(NERXIEN),BFC(NERXIEN),PHR^PSOERXA2(NERXIEN),PRE^PSOERXA2(NERXIEN)
"RTN","PSOERXA1",121,0)
 D MED^PSOERXA3(NERXIEN,.ERXVALS),OBS(NERXIEN),SUP^PSOERXA2(NERXIEN)
"RTN","PSOERXA1",122,0)
 ; facility/request have no where to go at this point in time??
"RTN","PSOERXA1",123,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXA1",124,0)
 D FAC^PSOERXA2(NERXIEN)
"RTN","PSOERXA1",125,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXA1",126,0)
 Q NERXIEN
"RTN","PSOERXA1",127,0)
HDR() ; header information
"RTN","PSOERXA1",128,0)
 N GL,GL2,FQUAL,TQUAL,FROM,TO,MID,PONUM,SRTID,SSTID,SENTTIME,RTMID,FDA,ERXIEN,FMID,NEWERX,MES,ERXIENS,SSSID,SRSID
"RTN","PSOERXA1",129,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Header",0))
"RTN","PSOERXA1",130,0)
 S GL2=$NA(^TMP($J,"PSOERXO1","Message","A","Qualifier","Header","A","Qualifier"))
"RTN","PSOERXA1",131,0)
 ; from and to qualifiers
"RTN","PSOERXA1",132,0)
 S FQUAL=$G(@GL2@("From","A","Qualifier"))
"RTN","PSOERXA1",133,0)
 S TQUAL=$G(@GL2@("To","A","Qualifier"))
"RTN","PSOERXA1",134,0)
 ; from, to, message id, prescriber order number
"RTN","PSOERXA1",135,0)
 S FROM=$G(@GL@("From",0))
"RTN","PSOERXA1",136,0)
 S TO=$G(@GL@("To",0))
"RTN","PSOERXA1",137,0)
 S MID=$G(@GL@("MessageID",0))
"RTN","PSOERXA1",138,0)
 ; set up the full message id
"RTN","PSOERXA1",139,0)
 S FMID=MID
"RTN","PSOERXA1",140,0)
 ; This logic was intended to handle 'updates' to and existing message if the same message id was received
"RTN","PSOERXA1",141,0)
 ; however, updates should probably occur through a change request, so if the same message id is received, we
"RTN","PSOERXA1",142,0)
 ; are returning an error.
"RTN","PSOERXA1",143,0)
 ;I $D(^PS(52.49,"FMID",FMID)) D
"RTN","PSOERXA1",144,0)
 ;.S ERXIEN=$O(^PS(52.49,"FMID",FMID,0)),UPDATE=1
"RTN","PSOERXA1",145,0)
 ;I '$G(ERXIEN) S ERXIEN="+1"
"RTN","PSOERXA1",146,0)
 S ERXIENS="+1,"
"RTN","PSOERXA1",147,0)
 ; quit and return a message back if this eRx exists.
"RTN","PSOERXA1",148,0)
 I $D(^PS(52.49,"FMID",ERXHID)) D  Q MES
"RTN","PSOERXA1",149,0)
 .S MES="0^This message already exists. Changes must occur via a change request XML message."
"RTN","PSOERXA1",150,0)
 S PONUM=$G(@GL@("PrescriberOrderNumber",0))
"RTN","PSOERXA1",151,0)
 ; security receiver tertiary identification
"RTN","PSOERXA1",152,0)
 S SRSID=$G(@GL@("Security",0,"Receiver",0,"SecondaryIdentification",0))
"RTN","PSOERXA1",153,0)
 S SRTID=$G(@GL@("Security",0,"Receiver",0,"TertiaryIdentification,",0))
"RTN","PSOERXA1",154,0)
 ; security sender tertiary identification
"RTN","PSOERXA1",155,0)
 S SSSID=$G(@GL@("Security",0,"Sender",0,"SecondaryIdentification",0))
"RTN","PSOERXA1",156,0)
 S SSTID=$G(@GL@("Security",0,"Sender",0,"TertiaryIdentification,",0))
"RTN","PSOERXA1",157,0)
 ; convert senttime to file manager dt/tm
"RTN","PSOERXA1",158,0)
 S SENTTIME=$G(@GL@("SentTime",0)),SENTTIME=$$CONVDTTM^PSOERXA1(SENTTIME)
"RTN","PSOERXA1",159,0)
 S RTMID=$G(@GL@("RelatesToMessageID",0))
"RTN","PSOERXA1",160,0)
 ; erx hub message id
"RTN","PSOERXA1",161,0)
 S FDA(52.49,ERXIENS,.01)=ERXHID
"RTN","PSOERXA1",162,0)
 ; change healthcare message id
"RTN","PSOERXA1",163,0)
 S FDA(52.49,ERXIENS,25)=FMID
"RTN","PSOERXA1",164,0)
 S FDA(52.49,ERXIENS,.02)=RTMID
"RTN","PSOERXA1",165,0)
 S FDA(52.49,ERXIENS,.03)=$$NOW^XLFDT
"RTN","PSOERXA1",166,0)
 S FDA(52.49,ERXIENS,.09)=PONUM
"RTN","PSOERXA1",167,0)
 S FDA(52.49,ERXIENS,1)=$$PRESOLV^PSOERXA1("N","ERX")
"RTN","PSOERXA1",168,0)
 S FDA(52.49,ERXIENS,22.1)=FROM
"RTN","PSOERXA1",169,0)
 S FDA(52.49,ERXIENS,22.2)=FQUAL
"RTN","PSOERXA1",170,0)
 S FDA(52.49,ERXIENS,22.3)=TO
"RTN","PSOERXA1",171,0)
 S FDA(52.49,ERXIENS,22.4)=TQUAL
"RTN","PSOERXA1",172,0)
 S FDA(52.49,ERXIENS,22.5)=SENTTIME
"RTN","PSOERXA1",173,0)
 S FDA(52.49,ERXIENS,24.3)=SSSID
"RTN","PSOERXA1",174,0)
 S FDA(52.49,ERXIENS,24.4)=SSTID
"RTN","PSOERXA1",175,0)
 S FDA(52.49,ERXIENS,24.5)=SRSID
"RTN","PSOERXA1",176,0)
 S FDA(52.49,ERXIENS,24.6)=SRTID
"RTN","PSOERXA1",177,0)
 ; if this is an existing record, file the updates to the erx and return the IEN
"RTN","PSOERXA1",178,0)
 ;I $G(UPDATE) D FILE^DIE(,"FDA") K FDA Q ERXIEN
"RTN","PSOERXA1",179,0)
 D UPDATE^DIE(,"FDA","NEWERX","EERR") K FDA
"RTN","PSOERXA1",180,0)
 S ERXIEN=""
"RTN","PSOERXA1",181,0)
 S ERXIEN=$O(NEWERX(0)),ERXIEN=$G(NEWERX(ERXIEN))
"RTN","PSOERXA1",182,0)
 I 'ERXIEN Q ""
"RTN","PSOERXA1",183,0)
 ; Future consideration - XSD shows digital signature. Do we need to collect this?
"RTN","PSOERXA1",184,0)
 Q ERXIEN
"RTN","PSOERXA1",185,0)
BFC(ERXIEN) ; benefits coordination
"RTN","PSOERXA1",186,0)
 N GL,BFCCNT,CHFN,CHLN,CHMN,CHPRE,CHSUFF,CHID,GRPID,PIDTYP,PIDVAL,CHFN,F,PIEN,NEWPAYER,BFCERR,IENS,CHFULLN,FDA,BSEQ,PNAME,PIDCNT
"RTN","PSOERXA1",187,0)
 S F=52.4918
"RTN","PSOERXA1",188,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,"NewRx",0,"BenefitsCoordination"))
"RTN","PSOERXA1",189,0)
 ; cannot start at 0, since the first entry is on the 0 subscript.
"RTN","PSOERXA1",190,0)
 S BSEQ=0
"RTN","PSOERXA1",191,0)
 S BFCCNT=-1 F  S BFCCNT=$O(@GL@(BFCCNT)) Q:BFCCNT=""  D
"RTN","PSOERXA1",192,0)
 .S BSEQ=BSEQ+1
"RTN","PSOERXA1",193,0)
 .S CHFN=$$UP^XLFSTR($G(@GL@(BFCCNT,"CardHolderName",0,"FirstName",0)))
"RTN","PSOERXA1",194,0)
 .S CHLN=$$UP^XLFSTR($G(@GL@(BFCCNT,"CardHolderName",0,"LastName",0)))
"RTN","PSOERXA1",195,0)
 .S CHMN=$$UP^XLFSTR($G(@GL@(BFCCNT,"CardHolderName",0,"MiddleName",0)))
"RTN","PSOERXA1",196,0)
 .; set up full name - last, first, mi
"RTN","PSOERXA1",197,0)
 .S CHFULLN=CHLN_","_CHFN_$S(CHMN]"":" "_CHMN,1:"")
"RTN","PSOERXA1",198,0)
 .S CHPRE=$$UP^XLFSTR($G(@GL@(BFCCNT,"CardHolderName",0,"Prefix",0)))
"RTN","PSOERXA1",199,0)
 .S CHSUFF=$$UP^XLFSTR($G(@GL@(BFCCNT,"CardHolderName",0,"Suffix",0)))
"RTN","PSOERXA1",200,0)
 .S CHID=$G(@GL@(BFCCNT,"CardholderID",0))
"RTN","PSOERXA1",201,0)
 .S GRPID=$G(@GL@(BFCCNT,"GroupID",0))
"RTN","PSOERXA1",202,0)
 .;/BLB/ PSO*7.0*520
"RTN","PSOERXA1",203,0)
 .S PNAME=$G(@GL@(BFCCNT,"PayerName",0))
"RTN","PSOERXA1",204,0)
 .S IENS="+1,"_ERXIEN_","
"RTN","PSOERXA1",205,0)
 .S FDA(F,IENS,.01)=BSEQ,FDA(F,IENS,7)=CHID,FDA(F,IENS,.02)=GRPID,FDA(F,IENS,.03)=PNAME
"RTN","PSOERXA1",206,0)
 .S FDA(F,IENS,1)=CHLN,FDA(F,IENS,2)=CHFN,FDA(F,IENS,3)=CHMN,FDA(F,IENS,4)=CHSUFF,FDA(F,IENS,5)=CHPRE
"RTN","PSOERXA1",207,0)
 .K NEWPAYER
"RTN","PSOERXA1",208,0)
 .D UPDATE^DIE(,"FDA","NEWPAYER") K FDA
"RTN","PSOERXA1",209,0)
 .;/BLB/ - END CHANGE
"RTN","PSOERXA1",210,0)
 .S PIEN=$O(NEWPAYER(0)),PIEN=$G(NEWPAYER(PIEN)) Q:'PIEN
"RTN","PSOERXA1",211,0)
 .S PIDCNT=-1 F  S PIDCNT=$O(@GL@(BFCCNT,"PayerIdentification",PIDCNT)) Q:PIDCNT=""  D
"RTN","PSOERXA1",212,0)
 ..S PIDTYP="" F  S PIDTYP=$O(@GL@(BFCCNT,"PayerIdentification",PIDCNT,PIDTYP)) Q:PIDTYP=""  D
"RTN","PSOERXA1",213,0)
 ...S PIDVAL=$G(@GL@(BFCCNT,"PayerIdentification",PIDCNT,PIDTYP,0))
"RTN","PSOERXA1",214,0)
 ...S FDA(52.49186,"+1,"_PIEN_","_ERXIEN_",",.01)=PIDTYP
"RTN","PSOERXA1",215,0)
 ...S FDA(52.49186,"+1,"_PIEN_","_ERXIEN_",",.02)=PIDVAL
"RTN","PSOERXA1",216,0)
 ...D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",217,0)
 .K NEWPAYER,PIEN
"RTN","PSOERXA1",218,0)
 Q
"RTN","PSOERXA1",219,0)
OBS(ERXIEN) ; Observation
"RTN","PSOERXA1",220,0)
 N GL,I,LAST,DIM,MSOURCE,MUNIT,OBSDT,MVAL,OBSNOTE,OBSCNT,F,EIENS,FDA
"RTN","PSOERXA1",221,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,"NewRx",0,"Observation",0))
"RTN","PSOERXA1",222,0)
 S F=52.4914,EIENS=ERXIEN_","
"RTN","PSOERXA1",223,0)
 S I=-1,OBSCNT=0 F  S I=$O(@GL@("Measurement",I)) Q:I=""  D
"RTN","PSOERXA1",224,0)
 .S OBSCNT=OBSCNT+1,FDA(F,"+1,"_EIENS,.01)=OBSCNT
"RTN","PSOERXA1",225,0)
 .S DIM=$G(@GL@("Measurement",I,"Dimension",0)),FDA(F,"+1,"_EIENS,.02)=DIM
"RTN","PSOERXA1",226,0)
 .S MSOURCE=$G(@GL@("Measurement",I,"MeasurementSourceCode",0)),FDA(F,"+1,"_EIENS,.06)=MSOURCE
"RTN","PSOERXA1",227,0)
 .S MUNIT=$G(@GL@("Measurement",I,"MeasurementUnitCode",0)),FDA(F,"+1,"_EIENS,.07)=MUNIT
"RTN","PSOERXA1",228,0)
 .; Future enhancement - we have a field for MeasurementDataQualifier (.05) - is this valid?
"RTN","PSOERXA1",229,0)
 .S OBSDT=$G(@GL@("Measurement",I,"ObservationDate",0,"Date",0)),OBSDT=$$CONVDTTM^PSOERXA1(OBSDT),FDA(F,"+1,"_EIENS,.04)=OBSDT
"RTN","PSOERXA1",230,0)
 .S MVAL=$G(@GL@("Measurement",I,"Value",0)),FDA(F,"+1,"_EIENS,.03)=MVAL
"RTN","PSOERXA1",231,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",232,0)
 S OBSNOTE=$G(@GL@("ObservationNotes",0)),FDA(52.49,EIENS,15)=OBSNOTE D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",233,0)
 Q
"RTN","PSOERXA1",234,0)
PAT(ERXIEN) ; patient
"RTN","PSOERXA1",235,0)
 N GL,AL1,AL2,CITY,STATE,ZIP,LN,FN,MN,PREF,SUFF,COMQUAL,COMVAL,PLQUAL,DOB,GEN,PRELATE,IDDONE,CDONE,I,C,CQUAL,CVAL
"RTN","PSOERXA1",236,0)
 N IDNM,IDVAL,PFN,ERXPAT,NEWPAT,F,EIENS,FDA,IDFND,SRCH,PIENS,NPIEN,PATSSN,PREL
"RTN","PSOERXA1",237,0)
 S F=52.46
"RTN","PSOERXA1",238,0)
 S EIENS=ERXIEN_","
"RTN","PSOERXA1",239,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,"NewRx",0,"Patient",0))
"RTN","PSOERXA1",240,0)
 S PREL=$G(@GL@("PatientRelationship",0))
"RTN","PSOERXA1",241,0)
 S FN=$$UP^XLFSTR($G(@GL@("Name",0,"FirstName",0)))
"RTN","PSOERXA1",242,0)
 S LN=$$UP^XLFSTR($G(@GL@("Name",0,"LastName",0)))
"RTN","PSOERXA1",243,0)
 S MN=$$UP^XLFSTR($G(@GL@("Name",0,"MiddleName",0)))
"RTN","PSOERXA1",244,0)
 S PFN=LN_","_FN_$S(MN]"":" "_MN,1:"")
"RTN","PSOERXA1",245,0)
 S SUFF=$$UP^XLFSTR($G(@GL@("Name",0,"Suffix",0)))
"RTN","PSOERXA1",246,0)
 S PREF=$$UP^XLFSTR($G(@GL@("Name",0,"Prefix",0)))
"RTN","PSOERXA1",247,0)
 S PRELATE=$G(@GL@("PatientRelationship",0))
"RTN","PSOERXA1",248,0)
 S GEN=$G(@GL@("Gender",0))
"RTN","PSOERXA1",249,0)
 S DOB=$G(@GL@("DateOfBirth",0,"Date",0)),DOB=$$CONVDTTM^PSOERXA1(DOB)
"RTN","PSOERXA1",250,0)
 I DOB<1 S DOB=""
"RTN","PSOERXA1",251,0)
 S AL1=$G(@GL@("Address",0,"AddressLine1",0))
"RTN","PSOERXA1",252,0)
 S AL2=$G(@GL@("Address",0,"AddressLine2",0))
"RTN","PSOERXA1",253,0)
 S CITY=$G(@GL@("Address",0,"City",0))
"RTN","PSOERXA1",254,0)
 S STATE=$G(@GL@("Address",0,"State",0))
"RTN","PSOERXA1",255,0)
 S ZIP=$G(@GL@("Address",0,"ZipCode",0))
"RTN","PSOERXA1",256,0)
 ; need to check for SSN before trying to match the patient. This needs to be stored in an array for later processing
"RTN","PSOERXA1",257,0)
 ; check 52.46 for a match before filing
"RTN","PSOERXA1",258,0)
 S PATSSN=$G(@GL@("Identification",0,"SocialSecurity",0))
"RTN","PSOERXA1",259,0)
 S ERXPAT=$$FINDPAT^PSOERXA1(PFN,DOB,GEN,$G(PATSSN),$G(AL1)) S PIENS=$S(ERXPAT:ERXPAT_",",1:"+1,")
"RTN","PSOERXA1",260,0)
 ; first, lets set up the main part
"RTN","PSOERXA1",261,0)
 S FDA(F,PIENS,.01)=PFN,FDA(F,PIENS,.02)=LN,FDA(F,PIENS,.03)=FN,FDA(F,PIENS,.04)=MN,FDA(F,PIENS,.05)=SUFF,FDA(F,PIENS,.06)=PREF
"RTN","PSOERXA1",262,0)
 S FDA(F,PIENS,.07)=GEN,FDA(F,PIENS,.08)=DOB
"RTN","PSOERXA1",263,0)
 S FDA(F,PIENS,1.4)=PATSSN,FDA(F,PIENS,1.7)=PREL
"RTN","PSOERXA1",264,0)
 S FDA(F,PIENS,3.1)=AL1,FDA(F,PIENS,3.2)=AL2,FDA(F,PIENS,3.3)=CITY
"RTN","PSOERXA1",265,0)
 S FDA(F,PIENS,3.4)=$$FIND1^DIC(5,,,STATE,"C")
"RTN","PSOERXA1",266,0)
 S FDA(F,PIENS,3.5)=ZIP
"RTN","PSOERXA1",267,0)
 I PIENS["+" D  Q
"RTN","PSOERXA1",268,0)
 .D UPDATE^DIE(,"FDA","NEWPAT") K FDA
"RTN","PSOERXA1",269,0)
 .S NPIEN=$O(NEWPAT(0)),NPIEN=$G(NEWPAT(NPIEN))
"RTN","PSOERXA1",270,0)
 .Q:'NPIEN
"RTN","PSOERXA1",271,0)
 .S NPIEN=NPIEN
"RTN","PSOERXA1",272,0)
 .D PATC(NPIEN)
"RTN","PSOERXA1",273,0)
 .S FDA(52.49,EIENS,.04)=NPIEN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",274,0)
 D FILE^DIE(,"FDA") K FDA D PATC(ERXPAT)
"RTN","PSOERXA1",275,0)
 S FDA(52.49,EIENS,.04)=ERXPAT D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",276,0)
 ; if this is an existing record loop through the communication values and do a compare to see what needs to be updated
"RTN","PSOERXA1",277,0)
 ; otherwise, build the FDA and file the communication values.
"RTN","PSOERXA1",278,0)
 Q
"RTN","PSOERXA1",279,0)
PATC(IEN) ; patient communication
"RTN","PSOERXA1",280,0)
 N IENS,CQUAL,CVAL,COMARY,FDA,SRCH,IDFND,IDNM,IDVAL,IDARY,PATSSN
"RTN","PSOERXA1",281,0)
 Q:'IEN
"RTN","PSOERXA1",282,0)
 S IENS=IEN_","
"RTN","PSOERXA1",283,0)
 ; Kill off existing communication values
"RTN","PSOERXA1",284,0)
 K ^PS(52.46,IEN,3)
"RTN","PSOERXA1",285,0)
 S C=-1 F  S C=$O(@GL@("CommunicationNumbers",0,"Communication",C)) Q:C=""  D
"RTN","PSOERXA1",286,0)
 .S CQUAL=$G(@GL@("CommunicationNumbers",0,"Communication",C,"Qualifier",0))
"RTN","PSOERXA1",287,0)
 .S CVAL=$G(@GL@("CommunicationNumbers",0,"Communication",C,"Number",0))
"RTN","PSOERXA1",288,0)
 .S COMARY(CQUAL)=CVAL
"RTN","PSOERXA1",289,0)
 .S FDA(52.462,"+1,"_IENS,.01)=CVAL
"RTN","PSOERXA1",290,0)
 .S FDA(52.462,"+1,"_IENS,.02)=CQUAL
"RTN","PSOERXA1",291,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",292,0)
 ; kill existing identification values in multiple
"RTN","PSOERXA1",293,0)
 K ^PS(52.46,IEN,5)
"RTN","PSOERXA1",294,0)
 S IDNM="" F  S IDNM=$O(@GL@("Identification",0,IDNM)) Q:IDNM=""  D
"RTN","PSOERXA1",295,0)
 .S IDVAL=$G(@GL@("Identification",0,IDNM,0))
"RTN","PSOERXA1",296,0)
 .I IDNM="SocialSecurity" S PATSSN=IDVAL
"RTN","PSOERXA1",297,0)
 .S IDARY(IDNM)=IDVAL
"RTN","PSOERXA1",298,0)
 .S IDFND=0
"RTN","PSOERXA1",299,0)
 .S SRCH=0 F  S SRCH=$O(^PS(52.46,IEN,5,SRCH)) Q:'SRCH  D
"RTN","PSOERXA1",300,0)
 ..I $$GET1^DIQ(52.465,SRCH_","_IEN_",",.01)=IDNM D
"RTN","PSOERXA1",301,0)
 ...S IDFND=1
"RTN","PSOERXA1",302,0)
 ...S FDA(52.465,SRCH_","_IEN_",",.02)=IDVAL D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",303,0)
 .Q:IDFND
"RTN","PSOERXA1",304,0)
 .S FDA(52.465,"+1,"_IEN_",",.01)=IDNM
"RTN","PSOERXA1",305,0)
 .S FDA(52.465,"+1,"_IEN_",",.02)=IDVAL
"RTN","PSOERXA1",306,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",307,0)
 I $G(PATSSN)]"" S FDA(52.46,IENS,1.4)=PATSSN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",308,0)
 Q
"RTN","PSOERXA1",309,0)
REQ ; request
"RTN","PSOERXA1",310,0)
 N GL,CRTYPE,RETREC,RRNUM
"RTN","PSOERXA1",311,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,"NewRx",0,"Request",0))
"RTN","PSOERXA1",312,0)
 S CRTYPE=$G(@GL@("ChangeRequestType",0))
"RTN","PSOERXA1",313,0)
 S RETREC=$G(@GL@("ReturnReceipt",0))
"RTN","PSOERXA1",314,0)
 S RRNUM=$G(@GL@("RequestReferenceNumber",0))
"RTN","PSOERXA1",315,0)
 ; Implement when different types of messages are coming in.
"RTN","PSOERXA1",316,0)
 Q
"RTN","PSOERXA1",317,0)
 ;
"RTN","PSOERXA1",318,0)
SPUSH(S,X) ;places X on the stack S and returns the current level of the stack
"RTN","PSOERXA1",319,0)
 N I S I=$O(S(""),-1)+1,S(I)=X
"RTN","PSOERXA1",320,0)
 Q I
"RTN","PSOERXA1",321,0)
 ;
"RTN","PSOERXA1",322,0)
SPOP(S,X) ;removes the top item from the stack S and put it into the variable X and returns the level that X was at
"RTN","PSOERXA1",323,0)
 N I S I=$O(S(""),-1)
"RTN","PSOERXA1",324,0)
 I I S X=S(I) K S(I)
"RTN","PSOERXA1",325,0)
 N J S J=$O(S(I),-1) I J S S(J,X)=$G(S(J,X))+1
"RTN","PSOERXA1",326,0)
 Q I
"RTN","PSOERXA1",327,0)
 ;
"RTN","PSOERXA1",328,0)
SPEEK(S,X) ;same as SPOP except the top item is not removed
"RTN","PSOERXA1",329,0)
 N I S I=$O(S(""),-1)
"RTN","PSOERXA1",330,0)
 I I S X=S(I)
"RTN","PSOERXA1",331,0)
 Q I
"RTN","PSOERXA1",332,0)
 ;
"RTN","PSOERXA1",333,0)
SPUT(S,X) ;implementation specific, uses the stack to form a global node
"RTN","PSOERXA1",334,0)
 N I,STR
"RTN","PSOERXA1",335,0)
 S X=$TR(X,";","")
"RTN","PSOERXA1",336,0)
 S STR=$P(GL,")")
"RTN","PSOERXA1",337,0)
 S I=0 F  S I=$O(S(I)) Q:'I  D
"RTN","PSOERXA1",338,0)
 .S STR=STR_","_""""_S(I)_""""_","
"RTN","PSOERXA1",339,0)
 .N NUM S NUM=0
"RTN","PSOERXA1",340,0)
 .I $D(S(I-1,S(I))) S NUM=+$G(S(I-1,S(I)))
"RTN","PSOERXA1",341,0)
 .S STR=STR_NUM
"RTN","PSOERXA1",342,0)
 S STR=STR_")"
"RTN","PSOERXA1",343,0)
 I $D(@STR) S @STR=@STR_X
"RTN","PSOERXA1",344,0)
 I '$D(@STR) S @STR=X
"RTN","PSOERXA1",345,0)
 Q STR
"RTN","PSOERXA1",346,0)
APUT(S,X,LN) ; what am i doing here?
"RTN","PSOERXA1",347,0)
 N I,STR
"RTN","PSOERXA1",348,0)
 S X=$TR(X,";","")
"RTN","PSOERXA1",349,0)
 S STR=$P(GL,")")
"RTN","PSOERXA1",350,0)
 S I=0 F  S I=$O(S(I)) Q:'I  D
"RTN","PSOERXA1",351,0)
 .S STR=STR_","_""""_S(I)_""""_","
"RTN","PSOERXA1",352,0)
 .N NUM S NUM="""A"""
"RTN","PSOERXA1",353,0)
 .;I $D(S(I-1,S(I))) S NUM=+$G(S(I-1,S(I)))
"RTN","PSOERXA1",354,0)
 .;S STR=STR_NUM
"RTN","PSOERXA1",355,0)
 .S STR=STR_NUM_","_""""_LN_""""
"RTN","PSOERXA1",356,0)
 S STR=STR_")"
"RTN","PSOERXA1",357,0)
 I $D(@STR) S @STR=@STR_X
"RTN","PSOERXA1",358,0)
 I '$D(@STR) S @STR=X
"RTN","PSOERXA1",359,0)
 Q STR
"RTN","PSOERXA1",360,0)
 ;
"RTN","PSOERXA1",361,0)
 ; VAL - value to resolve
"RTN","PSOERXA1",362,0)
 ; TYPE - This is the code type, which will tell which 'C' index type to get the code from
"RTN","PSOERXA1",363,0)
PRESOLV(VAL,TYPE) ;
"RTN","PSOERXA1",364,0)
 N MATCH
"RTN","PSOERXA1",365,0)
 S MATCH=""
"RTN","PSOERXA1",366,0)
 Q:'$L(TYPE)!('$L(VAL)) "" ; avoid null subscript
"RTN","PSOERXA1",367,0)
 S MATCH=$O(^PS(52.45,"C",TYPE,VAL,0))
"RTN","PSOERXA1",368,0)
 ; return the match found, null if no match
"RTN","PSOERXA1",369,0)
 Q MATCH
"RTN","PSOERXA1",370,0)
 ; look for existing patient
"RTN","PSOERXA1",371,0)
 ; NAME - PATIENT FULL NAME
"RTN","PSOERXA1",372,0)
 ; IDOB - INCOMING PATIENT DOB
"RTN","PSOERXA1",373,0)
 ; IDGEN - INCOMING PATIENT GENDER
"RTN","PSOERXA1",374,0)
 ; SSN - INCOMING PATIENT SSN
"RTN","PSOERXA1",375,0)
 ; AL1 - INCOMING PATIENT ADDRESS LINE 1
"RTN","PSOERXA1",376,0)
FINDPAT(NAME,IDOB,IGEN,SSN,AL1) ;
"RTN","PSOERXA1",377,0)
 N MPAT,MTCHCNT,PIEN,MATCH,PDOB,PGEN,PSSN,PAL1
"RTN","PSOERXA1",378,0)
 ; for now, quit if name match does not occur.
"RTN","PSOERXA1",379,0)
 I '$D(^PS(52.46,"BN",NAME)) Q ""
"RTN","PSOERXA1",380,0)
 S MTCHCNT=0
"RTN","PSOERXA1",381,0)
 S PIEN=0 F  S PIEN=$O(^PS(52.46,"BN",NAME,PIEN)) Q:'PIEN  D
"RTN","PSOERXA1",382,0)
 .S PDOB=$$GET1^DIQ(52.46,PIEN,.08,"I"),PGEN=$$GET1^DIQ(52.46,PIEN,.07,"I")
"RTN","PSOERXA1",383,0)
 .S PSSN=$$GET1^DIQ(52.46,PIEN,1.4),PAL1=$$GET1^DIQ(52.46,PIEN,3.1,"E")
"RTN","PSOERXA1",384,0)
 .; if the ssn exists, and does not match, quit
"RTN","PSOERXA1",385,0)
 .I $L(SSN),SSN'=PSSN Q
"RTN","PSOERXA1",386,0)
 .I PDOB=IDOB,PGEN=IGEN,AL1=PAL1 S MTCHCNT=MTCHCNT+1,MATCH(PIEN)=""
"RTN","PSOERXA1",387,0)
 I MTCHCNT'=1 Q ""
"RTN","PSOERXA1",388,0)
 S MPAT=$O(MATCH(0))
"RTN","PSOERXA1",389,0)
 I MPAT Q MPAT
"RTN","PSOERXA1",390,0)
 Q ""
"RTN","PSOERXA1",391,0)
 ; look for existing provider/prescriber
"RTN","PSOERXA1",392,0)
FINDPRE(NAME,NPI,DEA) ;
"RTN","PSOERXA1",393,0)
 N NPCNT,NPIMTCH,NLIST,NLCNT,NLOOP,NLIST2,NAMEMTCH,NMLOOP,NMCNT,NMLIST,DCNT,DEAMTCH,DLCNT,DLIST,DLIST2
"RTN","PSOERXA1",394,0)
 N DLOOP,DMTCH,NPDEA
"RTN","PSOERXA1",395,0)
 ; if there is an NPI, and DEA#, check both. If only one match, then this is the same provider
"RTN","PSOERXA1",396,0)
 I $L(NPI) D  Q NPIMTCH
"RTN","PSOERXA1",397,0)
 .I '$D(^PS(52.48,"C",NPI)) S NPIMTCH="" Q
"RTN","PSOERXA1",398,0)
 .S NPCNT=0
"RTN","PSOERXA1",399,0)
 .S NPIMTCH=0 F  S NPIMTCH=$O(^PS(52.48,"C",NPI,NPIMTCH)) Q:'NPIMTCH  D
"RTN","PSOERXA1",400,0)
 ..S NPDEA=$$GET1^DIQ(52.48,NPIMTCH,1.6,"E") I $L(DEA),NPDEA'=DEA Q
"RTN","PSOERXA1",401,0)
 ..S NLIST(NPIMTCH)="",NPCNT=NPCNT+1
"RTN","PSOERXA1",402,0)
 .; if we have a single match for NPI and DEA# return the result
"RTN","PSOERXA1",403,0)
 .I NPCNT=0 S NPIMTCH="" Q
"RTN","PSOERXA1",404,0)
 .I NPCNT=1 S NPIMTCH=$O(NLIST(0)) Q
"RTN","PSOERXA1",405,0)
 .S NLCNT=0
"RTN","PSOERXA1",406,0)
 .S NLOOP=0 F  S NLOOP=$O(NLIST(NLOOP)) Q:'NLOOP  D
"RTN","PSOERXA1",407,0)
 ..I $L(NAME),NAME=$$GET1^DIQ(52.48,NLOOP,.01,"E") S NLIST2(NLOOP)="",NLCNT=NLCNT+1
"RTN","PSOERXA1",408,0)
 .I NLCNT=0!(NLCNT>1) S NPIMTCH="" Q
"RTN","PSOERXA1",409,0)
 .I NLCNT=1 S NPIMTCH=$O(NLIST2(0)) Q
"RTN","PSOERXA1",410,0)
 I $L(DEA) D  Q DEAMTCH
"RTN","PSOERXA1",411,0)
 .I '$D(^PS(52.48,"D",DEA)) S DEAMTCH="" Q
"RTN","PSOERXA1",412,0)
 .S (DCNT,DMTCH)=0 F  S DMTCH=$O(^PS(52.48,"D",DEA,DMTCH)) Q:'DMTCH  D
"RTN","PSOERXA1",413,0)
 ..S DLIST(DMTCH)="",DCNT=DCNT+1
"RTN","PSOERXA1",414,0)
 .I DCNT=0 S DEAMTCH="" Q
"RTN","PSOERXA1",415,0)
 .I DCNT=1 S DEAMTCH=$O(DLIST(0)) Q
"RTN","PSOERXA1",416,0)
 .S (DLOOP,DLCNT)=0 F  S DLOOP=$O(DLIST(DLOOP)) Q:'DLOOP  D
"RTN","PSOERXA1",417,0)
 ..I $L(NAME),NAME=$$GET1^DIQ(52.48,DLOOP,.01,"E") S DLIST2(DLOOP)="",DLCNT=DLCNT+1
"RTN","PSOERXA1",418,0)
 .I DLCNT=0!(DLCNT>1) S DEAMTCH="" Q
"RTN","PSOERXA1",419,0)
 .I DLCNT=1 S DEAMTCH=$O(DLIST2(0))
"RTN","PSOERXA1",420,0)
 I $L(NAME) D  Q NAMEMTCH
"RTN","PSOERXA1",421,0)
 .I '$D(^PS(52.48,"BN",NAME)) S NAMEMTCH="" Q
"RTN","PSOERXA1",422,0)
 .S (NMLOOP,NMCNT)=0 F  S NMLOOP=$O(^PS(52.48,"BN",NAME,NMLOOP)) Q:'NMLOOP  D
"RTN","PSOERXA1",423,0)
 ..S NMLIST(NMLOOP)="",NMCNT=NMCNT+1
"RTN","PSOERXA1",424,0)
 .I NMCNT=0!(NMCNT>1) S NAMEMTCH="" Q
"RTN","PSOERXA1",425,0)
 .S NAMEMTCH=$O(NMLIST(0))
"RTN","PSOERXA1",426,0)
 Q ""
"RTN","PSOERXA1",427,0)
CONVDTTM(VAL) ;
"RTN","PSOERXA1",428,0)
 N EDATE,ETIME,X,ETZ,Y
"RTN","PSOERXA1",429,0)
 I '$L(VAL) Q ""
"RTN","PSOERXA1",430,0)
 S EDATE=$P(VAL,"T"),ETIME=$P(VAL,"T",2)
"RTN","PSOERXA1",431,0)
 ; split off time zone
"RTN","PSOERXA1",432,0)
 S ETZ=$P(ETIME,".",2)
"RTN","PSOERXA1",433,0)
 S ETIME=$P(ETIME,".")
"RTN","PSOERXA1",434,0)
 S X=EDATE D ^%DT I 'Y Q ""
"RTN","PSOERXA1",435,0)
 S VAL=Y_$S($L(ETIME):"."_$TR(ETIME,":",""),1:"")
"RTN","PSOERXA1",436,0)
 Q VAL
"RTN","PSOERXA2")
0^10^B104569280^B75232526
"RTN","PSOERXA2",1,0)
PSOERXA2 ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERXA2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520**;DEC 1997;Build 52
"RTN","PSOERXA2",3,0)
 ;
"RTN","PSOERXA2",4,0)
 Q
"RTN","PSOERXA2",5,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE ( ADD BOTH THE 'FAC' AND 'FIC' LINETAG TO YOUR ROUTINE )
"RTN","PSOERXA2",6,0)
FAC(ERXIEN) ; facility
"RTN","PSOERXA2",7,0)
 N GL,IDTYPE,IDVAL,F,FIEN,IENS,FNAME,FACFDA,AL1,AL2,CITY,STATE,ZIP,PLQUAL,FACFDA
"RTN","PSOERXA2",8,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,"NewRx",0,"Facility",0))
"RTN","PSOERXA2",9,0)
 S F=52.49,FIEN="",IENS=ERXIEN_","
"RTN","PSOERXA2",10,0)
 S FNAME=$G(@GL@("FacilityName",0))
"RTN","PSOERXA2",11,0)
 S FACFDA(F,IENS,70.1)=FNAME
"RTN","PSOERXA2",12,0)
 S AL1=$G(@GL@("Address",0,"AddressLine1",0)),FACFDA(F,IENS,70.2)=AL1
"RTN","PSOERXA2",13,0)
 S AL2=$G(@GL@("Address",0,"AddressLine2",0)),FACFDA(F,IENS,70.3)=AL2
"RTN","PSOERXA2",14,0)
 S CITY=$G(@GL@("Address",0,"City",0)),FACFDA(F,IENS,70.4)=CITY
"RTN","PSOERXA2",15,0)
 S STATE=$G(@GL@("Address",0,"State",0)),FACFDA(F,IENS,70.5)=$$FIND1^DIC(5,,,STATE,"C")
"RTN","PSOERXA2",16,0)
 S ZIP=$G(@GL@("Address",0,"ZipCode",0)),FACFDA(F,IENS,70.6)=ZIP
"RTN","PSOERXA2",17,0)
 S PLQUAL=$G(@GL@("Address",0,"PlaceLocationQualifier",0)),FACFDA(F,IENS,70.7)=PLQUAL
"RTN","PSOERXA2",18,0)
 D FILE^DIE(,"FACFDA","ERR") K FACFDA ;D FIC($P(FIEN,","))
"RTN","PSOERXA2",19,0)
 D FIC(ERXIEN)
"RTN","PSOERXA2",20,0)
 ; future enhancement - file ID types - requires modification to the current payer information subfile
"RTN","PSOERXA2",21,0)
 ;                    - THIS REQUIRES RESOLUTION OF THE PAYERID TYPE ISSUE ALONG WITH PRIOR AUTH VALUES, ETC.
"RTN","PSOERXA2",22,0)
 ;S IDTYPE="" F  S IDTYPE=$O(@GL@("Identification",0,IDTYPE)) Q:IDTYPE=""  D
"RTN","PSOERXA2",23,0)
 ;S IDVAL=$G(@GL@("Identification",0,IDTYPE,0))
"RTN","PSOERXA2",24,0)
 Q
"RTN","PSOERXA2",25,0)
FIC(IEN) ;
"RTN","PSOERXA2",26,0)
 N IDTYP,IDVAL,FDA,I,CCNT,FIEN,FACFDA,IDCNT,ERR
"RTN","PSOERXA2",27,0)
 Q:'IEN
"RTN","PSOERXA2",28,0)
 S IENS=IEN_","
"RTN","PSOERXA2",29,0)
 S IDCNT=0
"RTN","PSOERXA2",30,0)
 K ^PS(52.49,IEN,71)
"RTN","PSOERXA2",31,0)
 S IDNM="" F  S IDNM=$O(@GL@("Identification",0,IDNM)) Q:IDNM=""  D
"RTN","PSOERXA2",32,0)
 .S IDVAL=$G(@GL@("Identification",0,IDNM,0))
"RTN","PSOERXA2",33,0)
 .I IDNM="NCPDPID",$G(NCPDPID)']"" S NCPDPID=$G(IDVAL)
"RTN","PSOERXA2",34,0)
 .S IDARY(IDNM)=IDVAL
"RTN","PSOERXA2",35,0)
 .S IDFND=0
"RTN","PSOERXA2",36,0)
 .S SRCH=0 F  S SRCH=$O(^PS(52.49,IEN,71,SRCH)) Q:'SRCH  D
"RTN","PSOERXA2",37,0)
 ..I $$GET1^DIQ(52.4971,SRCH_","_IEN_",",.01)=IDNM D
"RTN","PSOERXA2",38,0)
 ...S IDFND=1
"RTN","PSOERXA2",39,0)
 ...S FACFDA(52.4971,SRCH_","_IEN_",",.02)=IDVAL D FILE^DIE(,"FACFDA","ERR") K FACFDA
"RTN","PSOERXA2",40,0)
 .Q:IDFND
"RTN","PSOERXA2",41,0)
 .S FACFDA(52.4971,"+1,"_IEN_",",.01)=IDNM
"RTN","PSOERXA2",42,0)
 .S FACFDA(52.4971,"+1,"_IEN_",",.02)=IDVAL
"RTN","PSOERXA2",43,0)
 .D UPDATE^DIE(,"FACFDA") K FACFDA
"RTN","PSOERXA2",44,0)
 ; clear out existing communication Numbers
"RTN","PSOERXA2",45,0)
 K ^PS(52.49,IEN,72)
"RTN","PSOERXA2",46,0)
 S I=-1 F  S I=$O(@GL@("CommunicationNumbers",0,"Communication",I)) Q:I=""  D
"RTN","PSOERXA2",47,0)
 .S CCNT=$G(CCNT)+1
"RTN","PSOERXA2",48,0)
 .S COMVAL=$G(@GL@("CommunicationNumbers",0,"Communication",I,"Number",0))
"RTN","PSOERXA2",49,0)
 .S COMTYP=$G(@GL@("CommunicationNumbers",0,"Communication",I,"Qualifier",0))
"RTN","PSOERXA2",50,0)
 .S FACFDA(52.4972,"+"_CCNT_","_IEN_",",.01)=COMVAL
"RTN","PSOERXA2",51,0)
 .S FACFDA(52.4972,"+"_CCNT_","_IEN_",",.02)=COMTYP
"RTN","PSOERXA2",52,0)
 D UPDATE^DIE(,"FACFDA") K FACFDA
"RTN","PSOERXA2",53,0)
 Q
"RTN","PSOERXA2",54,0)
 ;/BLB/ PSO*7.0*520 - END CHANGE
"RTN","PSOERXA2",55,0)
PHR(ERXIEN) ; pharamcy
"RTN","PSOERXA2",56,0)
 N GL,SNAME,AL1,AL2,CIT,STATE,ZIP,PLQUAL,COMTYP,COMVAL,I,F,EIENS,PHIEN,CCNT,NEW,SPEC,FDA,NEWPHIEN,GL2,FQUAL,FROM
"RTN","PSOERXA2",57,0)
 N NCPDPID
"RTN","PSOERXA2",58,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,"NewRx",0,"Pharmacy",0))
"RTN","PSOERXA2",59,0)
 S GL2=$NA(^TMP($J,"PSOERXO1","Message","A","Qualifier","Header","A","Qualifier"))
"RTN","PSOERXA2",60,0)
 S FQUAL=$G(@GL2@("From","A","Qualifier"))
"RTN","PSOERXA2",61,0)
 S FROM=$G(@GL@("From",0))
"RTN","PSOERXA2",62,0)
 I FQUAL="P",FROM]"" S NCPDPID=FROM
"RTN","PSOERXA2",63,0)
 S F=52.47,PHIEN=""
"RTN","PSOERXA2",64,0)
 S EIENS=ERXIEN_","
"RTN","PSOERXA2",65,0)
 S SNAME=$G(@GL@("StoreName",0))
"RTN","PSOERXA2",66,0)
 I '$L(SNAME) Q
"RTN","PSOERXA2",67,0)
 I $D(^PS(52.47,"B",SNAME)) S PHIEN=$O(^PS(52.47,"B",SNAME,0)) I PHIEN S PHIEN=PHIEN_",",NEW=0
"RTN","PSOERXA2",68,0)
 ; if we found a match, clear out the existing communication numbers and identification
"RTN","PSOERXA2",69,0)
 I PHIEN K ^PS(52.47,$P(PHIEN,","),3),^PS(52.47,$P(PHIEN,","),2)
"RTN","PSOERXA2",70,0)
 I '$G(PHIEN) S PHIEN="+1,",NEW=1,FDA(F,PHIEN,.01)=SNAME
"RTN","PSOERXA2",71,0)
 S FDA(F,PHIEN,.05)=SNAME
"RTN","PSOERXA2",72,0)
 S SPEC=$G(@GL@("Specialty",0)),FDA(F,PHIEN,1.8)=SPEC
"RTN","PSOERXA2",73,0)
 S AL1=$G(@GL@("Address",0,"AddressLine1",0)),FDA(F,PHIEN,1.1)=AL1
"RTN","PSOERXA2",74,0)
 S AL2=$G(@GL@("Address",0,"AddressLine2",0)),FDA(F,PHIEN,1.2)=AL2
"RTN","PSOERXA2",75,0)
 S CITY=$G(@GL@("Address",0,"City",0)),FDA(F,PHIEN,1.3)=CITY
"RTN","PSOERXA2",76,0)
 S STATE=$G(@GL@("Address",0,"State",0)),FDA(F,PHIEN,1.4)=$$FIND1^DIC(5,,,STATE,"C")
"RTN","PSOERXA2",77,0)
 S ZIP=$G(@GL@("Address",0,"ZipCode",0)),FDA(F,PHIEN,1.5)=ZIP
"RTN","PSOERXA2",78,0)
 S PLQUAL=$G(@GL@("Address",0,"PlaceLocationQualifier",0)),FDA(F,PHIEN,1.7)=PLQUAL
"RTN","PSOERXA2",79,0)
 ; if this is an existing pharmacy entry, file the updates, communication values, and identification, then link to 52.49
"RTN","PSOERXA2",80,0)
 I 'NEW D  Q
"RTN","PSOERXA2",81,0)
 .D FILE^DIE(,"FDA") K FDA D PHRIC($P(PHIEN,","))
"RTN","PSOERXA2",82,0)
 .S FDA(52.49,EIENS,2.5)=$P(PHIEN,",") D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",83,0)
 ; for a new entry, file the entry, then file communication/identification and link to 52.49
"RTN","PSOERXA2",84,0)
 D UPDATE^DIE(,"FDA","NEWPHIEN") K FDA
"RTN","PSOERXA2",85,0)
 S PHIEN=$O(NEWPHIEN(0)),PHIEN=$G(NEWPHIEN(PHIEN))
"RTN","PSOERXA2",86,0)
 Q:'PHIEN
"RTN","PSOERXA2",87,0)
 D PHRIC(PHIEN)
"RTN","PSOERXA2",88,0)
 S FDA(52.49,EIENS,2.5)=PHIEN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",89,0)
 Q
"RTN","PSOERXA2",90,0)
PHRIC(IEN) ; pharmacy identification and communication information
"RTN","PSOERXA2",91,0)
 N IDTYP,IDVAL,FDA,I,CCNT,PHIEN,FDA,IDCNT
"RTN","PSOERXA2",92,0)
 Q:'IEN
"RTN","PSOERXA2",93,0)
 S PHIEN=IEN_","
"RTN","PSOERXA2",94,0)
 S IDCNT=0
"RTN","PSOERXA2",95,0)
 K ^PS(52.47,IEN,2)
"RTN","PSOERXA2",96,0)
 S IDNM="" F  S IDNM=$O(@GL@("Identification",0,IDNM)) Q:IDNM=""  D
"RTN","PSOERXA2",97,0)
 .S IDVAL=$G(@GL@("Identification",0,IDNM,0))
"RTN","PSOERXA2",98,0)
 .I IDNM="NCPDPID",$G(NCPDPID)']"" S NCPDPID=$G(IDVAL)
"RTN","PSOERXA2",99,0)
 .S IDARY(IDNM)=IDVAL
"RTN","PSOERXA2",100,0)
 .S IDFND=0
"RTN","PSOERXA2",101,0)
 .S SRCH=0 F  S SRCH=$O(^PS(52.47,IEN,2,SRCH)) Q:'SRCH  D
"RTN","PSOERXA2",102,0)
 ..I $$GET1^DIQ(52.472,SRCH_","_IEN_",",.01)=IDNM D
"RTN","PSOERXA2",103,0)
 ...S IDFND=1
"RTN","PSOERXA2",104,0)
 ...S FDA(52.472,SRCH_","_IEN_",",.02)=IDVAL D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",105,0)
 .Q:IDFND
"RTN","PSOERXA2",106,0)
 .S FDA(52.472,"+1,"_IEN_",",.01)=IDNM
"RTN","PSOERXA2",107,0)
 .S FDA(52.472,"+1,"_IEN_",",.02)=IDVAL
"RTN","PSOERXA2",108,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",109,0)
 I $G(NCPDPID)]"" S FDA(52.47,PHIEN,.02)=NCPDPID D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",110,0)
 ; clear out existing communication Numbers
"RTN","PSOERXA2",111,0)
 K ^PS(52.47,IEN,3)
"RTN","PSOERXA2",112,0)
 S I=-1 F  S I=$O(@GL@("CommunicationNumbers",0,"Communication",I)) Q:I=""  D
"RTN","PSOERXA2",113,0)
 .S CCNT=$G(CCNT)+1
"RTN","PSOERXA2",114,0)
 .S COMVAL=$G(@GL@("CommunicationNumbers",0,"Communication",I,"Number",0))
"RTN","PSOERXA2",115,0)
 .S COMTYP=$G(@GL@("CommunicationNumbers",0,"Communication",I,"Qualifier",0))
"RTN","PSOERXA2",116,0)
 .S FDA(52.473,"+"_CCNT_","_PHIEN,.01)=COMVAL
"RTN","PSOERXA2",117,0)
 .S FDA(52.473,"+"_CCNT_","_PHIEN,.02)=COMTYP
"RTN","PSOERXA2",118,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",119,0)
 Q
"RTN","PSOERXA2",120,0)
PRE(ERXIEN) ; prescriber
"RTN","PSOERXA2",121,0)
 N GL,FN,LN,MN,SUFF,PREF,AL1,AL2,CITY,STATE,ZIP,IDDONE,I,IDNM,IDVAL,C,CQUAL,CVAL,SPEC,AFN,ALN,AMN,APREF,ASUFF,FULLNM
"RTN","PSOERXA2",122,0)
 N EIENS,FDA,NPIEN,NEW,PRVIEN,PRVIENS,NEWIEN,IDFND,SRCH,PNPI,PDEA,GL2,FQUAL,FROM
"RTN","PSOERXA2",123,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,"NewRx",0,"Prescriber",0))
"RTN","PSOERXA2",124,0)
 S GL2=$NA(^TMP($J,"PSOERXO1","Message","A","Qualifier","Header","A","Qualifier"))
"RTN","PSOERXA2",125,0)
 S FQUAL=$G(@GL2@("From","A","Qualifier"))
"RTN","PSOERXA2",126,0)
 S FROM=$G(@GL@("From",0))
"RTN","PSOERXA2",127,0)
 I FQUAL="D",FROM]"" S PNPI=FROM
"RTN","PSOERXA2",128,0)
 S F=52.48
"RTN","PSOERXA2",129,0)
 S EIENS=ERXIEN_","
"RTN","PSOERXA2",130,0)
 S FN=$$UP^XLFSTR($G(@GL@("Name",0,"FirstName",0)))
"RTN","PSOERXA2",131,0)
 S LN=$$UP^XLFSTR($G(@GL@("Name",0,"LastName",0)))
"RTN","PSOERXA2",132,0)
 S MN=$$UP^XLFSTR($G(@GL@("Name",0,"MiddleName",0)))
"RTN","PSOERXA2",133,0)
 S FULLNM=LN_","_FN_$S(MN]"":" "_MN,1:"")
"RTN","PSOERXA2",134,0)
 S SUFF=$$UP^XLFSTR($G(@GL@("Name",0,"Suffix",0)))
"RTN","PSOERXA2",135,0)
 S PREF=$$UP^XLFSTR($G(@GL@("Name",0,"Prefix",0)))
"RTN","PSOERXA2",136,0)
 S AL1=$G(@GL@("Address",0,"AddressLine1",0))
"RTN","PSOERXA2",137,0)
 S AL2=$G(@GL@("Address",0,"AddressLine2",0))
"RTN","PSOERXA2",138,0)
 S CITY=$G(@GL@("Address",0,"City",0))
"RTN","PSOERXA2",139,0)
 S STATE=$G(@GL@("Address",0,"State",0))
"RTN","PSOERXA2",140,0)
 S ZIP=$G(@GL@("Address",0,"ZipCode",0))
"RTN","PSOERXA2",141,0)
 S SPEC=$G(@GL@("Specialty",0))
"RTN","PSOERXA2",142,0)
 S AFN=$$UP^XLFSTR($G(@GL@("PrescriberAgent",0,"FirstName",0)))
"RTN","PSOERXA2",143,0)
 S ALN=$$UP^XLFSTR($G(@GL@("PrescriberAgent",0,"LastName",0)))
"RTN","PSOERXA2",144,0)
 S AMN=$$UP^XLFSTR($G(@GL@("PrescriberAgent",0,"MiddleName",0)))
"RTN","PSOERXA2",145,0)
 S APREF=$$UP^XLFSTR($G(@GL@("PrescriberAgent",0,"Prefix",0)))
"RTN","PSOERXA2",146,0)
 S ASUFF=$$UP^XLFSTR($G(@GL@("PrescriberAgent",0,"Suffix",0)))
"RTN","PSOERXA2",147,0)
 ; try to match the provider/supervisor. if no match, create a  new entry for this provider
"RTN","PSOERXA2",148,0)
 ; if there is no NPI, grab it from the Identification multiple.
"RTN","PSOERXA2",149,0)
 I '$G(PNPI) S PNPI=$G(@GL@("Identification",0,"NPI",0))
"RTN","PSOERXA2",150,0)
 S PDEA=$G(@GL@("Identification",0,"DEANumber",0))
"RTN","PSOERXA2",151,0)
 S STLIC=$G(@GL@("Identification",0,"StateLicenseNumber",0))
"RTN","PSOERXA2",152,0)
 S PRVIEN=$$FINDPRE^PSOERXA1(FULLNM,$G(PNPI),PDEA) I PRVIEN S NEW=0
"RTN","PSOERXA2",153,0)
 I 'PRVIEN S NEW=1,PRVIEN="+1"
"RTN","PSOERXA2",154,0)
 S PRVIENS=PRVIEN_","
"RTN","PSOERXA2",155,0)
 S FDA(F,PRVIENS,.01)=FULLNM,FDA(F,PRVIENS,.02)=LN,FDA(F,PRVIENS,.03)=FN,FDA(F,PRVIENS,.04)=MN,FDA(F,PRVIENS,.05)=SUFF
"RTN","PSOERXA2",156,0)
 S FDA(F,PRVIENS,.06)=PREF,FDA(F,PRVIENS,4.1)=AL1,FDA(F,PRVIENS,4.2)=AL2,FDA(F,PRVIENS,4.3)=CITY
"RTN","PSOERXA2",157,0)
 S FDA(F,PRVIENS,4.4)=$$FIND1^DIC(5,,,STATE,"C"),FDA(F,PRVIENS,4.5)=ZIP
"RTN","PSOERXA2",158,0)
 S FDA(F,PRVIENS,5.1)=ALN,FDA(F,PRVIENS,5.2)=AFN,FDA(F,PRVIENS,5.3)=AMN,FDA(F,PRVIENS,5.4)=ASUFF,FDA(F,PRVIENS,5.5)=APREF
"RTN","PSOERXA2",159,0)
 S FDA(F,PRVIENS,1.2)=SPEC
"RTN","PSOERXA2",160,0)
 S FDA(F,PRVIENS,1.8)=$G(STLIC)
"RTN","PSOERXA2",161,0)
 S FDA(F,PRVIENS,1.1)="PR"
"RTN","PSOERXA2",162,0)
 I 'NEW D  Q
"RTN","PSOERXA2",163,0)
 .D FILE^DIE(,"FDA")
"RTN","PSOERXA2",164,0)
 .D PRVCI(PRVIEN)
"RTN","PSOERXA2",165,0)
 .S FDA(52.49,EIENS,2.1)=PRVIEN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",166,0)
 D UPDATE^DIE(,"FDA","NEWIEN") K FDA
"RTN","PSOERXA2",167,0)
 S NPIEN=$O(NEWIEN(0)),NPIEN=$G(NEWIEN(NPIEN))
"RTN","PSOERXA2",168,0)
 D PRVCI(NPIEN)
"RTN","PSOERXA2",169,0)
 S FDA(52.49,EIENS,2.1)=NPIEN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",170,0)
 Q
"RTN","PSOERXA2",171,0)
PRVCI(IEN) ;
"RTN","PSOERXA2",172,0)
 N IENS,C,CQUAL,CVAL,FDA,IDNM,IDVAL,IDARY,IDFND,SRCH,NCPDPID,PHIN,DEA,STLIC,PNPI
"RTN","PSOERXA2",173,0)
 S IENS=IEN_","
"RTN","PSOERXA2",174,0)
 ; kill off existing data
"RTN","PSOERXA2",175,0)
 K ^PS(52.48,IEN,3)
"RTN","PSOERXA2",176,0)
 S C=-1 F  S C=$O(@GL@("CommunicationNumbers",0,"Communication",C)) Q:C=""  D
"RTN","PSOERXA2",177,0)
 .S CQUAL=$G(@GL@("CommunicationNumbers",0,"Communication",C,"Qualifier",0))
"RTN","PSOERXA2",178,0)
 .S CVAL=$G(@GL@("CommunicationNumbers",0,"Communication",C,"Number",0))
"RTN","PSOERXA2",179,0)
 .S FDA(52.483,"+1,"_IENS,.01)=CVAL
"RTN","PSOERXA2",180,0)
 .S FDA(52.483,"+1,"_IENS,.02)=CQUAL
"RTN","PSOERXA2",181,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",182,0)
 ; kill existing Identification data.
"RTN","PSOERXA2",183,0)
 K ^PS(52.48,IEN,6)
"RTN","PSOERXA2",184,0)
 S IDNM="" F  S IDNM=$O(@GL@("Identification",0,IDNM)) Q:IDNM=""  D
"RTN","PSOERXA2",185,0)
 .S IDVAL=$G(@GL@("Identification",0,IDNM,0))
"RTN","PSOERXA2",186,0)
 .S IDARY(IDNM)=IDVAL
"RTN","PSOERXA2",187,0)
 .I IDNM="NCPDPID" S NCPDPID=IDVAL
"RTN","PSOERXA2",188,0)
 .I IDNM="HIN" S PHIN=IDVAL
"RTN","PSOERXA2",189,0)
 .I IDNM="DEANumber" S DEA=IDVAL
"RTN","PSOERXA2",190,0)
 .I IDNM="StateLicenseNumber" S STLIC=IDVAL
"RTN","PSOERXA2",191,0)
 .I IDNM="NPI" S PNPI=IDVAL
"RTN","PSOERXA2",192,0)
 .S IDFND=0
"RTN","PSOERXA2",193,0)
 .S SRCH=0 F  S SRCH=$O(^PS(52.48,IEN,6,SRCH)) Q:'SRCH  D
"RTN","PSOERXA2",194,0)
 ..I $$GET1^DIQ(52.486,SRCH_","_IEN_",",.01)=IDNM D
"RTN","PSOERXA2",195,0)
 ...S IDFND=1
"RTN","PSOERXA2",196,0)
 ...S FDA(52.486,SRCH_","_IEN_",",.02)=IDVAL D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",197,0)
 .Q:IDFND
"RTN","PSOERXA2",198,0)
 .S FDA(52.486,"+1,"_IEN_",",.01)=IDNM
"RTN","PSOERXA2",199,0)
 .S FDA(52.486,"+1,"_IEN_",",.02)=IDVAL
"RTN","PSOERXA2",200,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",201,0)
 S FDA(52.48,IENS,1.4)=$G(NCPDPID),FDA(52.48,IENS,1.5)=$G(PNPI),FDA(52.48,IENS,1.6)=$G(DEA),FDA(52.48,IENS,1.7)=$G(PHIN)
"RTN","PSOERXA2",202,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",203,0)
 Q
"RTN","PSOERXA2",204,0)
REQ ; request
"RTN","PSOERXA2",205,0)
 N GL,CRTYPE,RETREC,RRNUM
"RTN","PSOERXA2",206,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,"NewRx",0,"Request",0))
"RTN","PSOERXA2",207,0)
 S CRTYPE=$G(@GL@("ChangeRequestType",0))
"RTN","PSOERXA2",208,0)
 S RETREC=$G(@GL@("ReturnReceipt",0))
"RTN","PSOERXA2",209,0)
 S RRNUM=$G(@GL@("RequestReferenceNumber",0))
"RTN","PSOERXA2",210,0)
 ; FUTURE ENHANCEMENT - file this information when we are getting other request types.
"RTN","PSOERXA2",211,0)
 Q
"RTN","PSOERXA2",212,0)
SUP(ERXIEN) ; supervisor
"RTN","PSOERXA2",213,0)
 N GL,FN,LN,MN,SUFF,PREF,AL1,AL2,CITY,STATE,ZIP,IDDONE,I,IDNM,IDVAL,C,CQUAL,CVAL,SPEC,AFN,ALN,AMN,APREF,ASUFF,EIENS
"RTN","PSOERXA2",214,0)
 N FDA,NPIEN,NEW,PRVIEN,PRVIENS,NEWIEN,FDA,IDFND,SRCH,PNPI,PDEA,STLIC
"RTN","PSOERXA2",215,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,"NewRx",0,"Supervisor",0))
"RTN","PSOERXA2",216,0)
 S EIENS=ERXIEN_","
"RTN","PSOERXA2",217,0)
 S FN=$$UP^XLFSTR($G(@GL@("Name",0,"FirstName",0)))
"RTN","PSOERXA2",218,0)
 S LN=$$UP^XLFSTR($G(@GL@("Name",0,"LastName",0))) Q:'$L(LN)
"RTN","PSOERXA2",219,0)
 S MN=$$UP^XLFSTR($G(@GL@("Name",0,"MiddleName",0)))
"RTN","PSOERXA2",220,0)
 S FULLNM=LN_","_FN_$S(MN]"":" "_MN,1:"")
"RTN","PSOERXA2",221,0)
 S SUFF=$$UP^XLFSTR($G(@GL@("Name",0,"Suffix",0)))
"RTN","PSOERXA2",222,0)
 S PREF=$$UP^XLFSTR($G(@GL@("Name",0,"Prefix",0)))
"RTN","PSOERXA2",223,0)
 S AL1=$G(@GL@("Address",0,"AddressLine1",0))
"RTN","PSOERXA2",224,0)
 S AL2=$G(@GL@("Address",0,"AddressLine2",0))
"RTN","PSOERXA2",225,0)
 S CITY=$G(@GL@("Address",0,"City",0))
"RTN","PSOERXA2",226,0)
 S STATE=$G(@GL@("Address",0,"State",0))
"RTN","PSOERXA2",227,0)
 S ZIP=$G(@GL@("Address",0,"ZipCode",0))
"RTN","PSOERXA2",228,0)
 S SPEC=$G(@GL@("Specialty",0))
"RTN","PSOERXA2",229,0)
 S PNPI=$G(@GL@("Identification",0,"NPI",0))
"RTN","PSOERXA2",230,0)
 S PDEA=$G(@GL@("Identification",0,"DEANumber",0))
"RTN","PSOERXA2",231,0)
 S STLIC=$G(@GL@("Identification",0,"StateLicenseNumber",0))
"RTN","PSOERXA2",232,0)
 S PRVIEN=$$FINDPRE^PSOERXA1(FULLNM,$G(PNPI),$G(PDEA)) I PRVIEN S NEW=0
"RTN","PSOERXA2",233,0)
 I 'PRVIEN S NEW=1,PRVIEN="+1"
"RTN","PSOERXA2",234,0)
 S PRVIENS=PRVIEN_","
"RTN","PSOERXA2",235,0)
 S FDA(F,PRVIENS,.01)=FULLNM,FDA(F,PRVIENS,.02)=LN,FDA(F,PRVIENS,.03)=FN,FDA(F,PRVIENS,.04)=MN,FDA(F,PRVIENS,.05)=SUFF
"RTN","PSOERXA2",236,0)
 S FDA(F,PRVIENS,.06)=PREF,FDA(F,PRVIENS,4.1)=AL1,FDA(F,PRVIENS,4.2)=AL2,FDA(F,PRVIENS,4.3)=CITY
"RTN","PSOERXA2",237,0)
 ; STATE AND POINTER RESOLUTION
"RTN","PSOERXA2",238,0)
 S FDA(F,PRVIENS,4.4)=$$FIND1^DIC(5,,,STATE,"C"),FDA(F,PRVIENS,4.5)=ZIP
"RTN","PSOERXA2",239,0)
 S FDA(F,PRVIENS,1.2)=SPEC
"RTN","PSOERXA2",240,0)
 S FDA(F,PRVIENS,1.1)="S"
"RTN","PSOERXA2",241,0)
 I 'NEW D  Q
"RTN","PSOERXA2",242,0)
 .D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",243,0)
 .D PRVCI(PRVIEN)
"RTN","PSOERXA2",244,0)
 .S FDA(52.49,EIENS,2.6)=PRVIEN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",245,0)
 D UPDATE^DIE(,"FDA","NEWIEN") K FDA
"RTN","PSOERXA2",246,0)
 S NPIEN=$O(NEWIEN(0)),NPIEN=$G(NEWIEN(NPIEN))
"RTN","PSOERXA2",247,0)
 D PRVCI(NPIEN)
"RTN","PSOERXA2",248,0)
 S FDA(52.49,EIENS,2.6)=NPIEN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",249,0)
 Q
"RTN","PSOERXD1")
0^6^B127051416^B120565051
"RTN","PSOERXD1",1,0)
PSOERXD1 ;ALB/BWF - eRx Drug display/actions ; 8/3/2016 5:14pm
"RTN","PSOERXD1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520**;DEC 1997;Build 52
"RTN","PSOERXD1",3,0)
 ;
"RTN","PSOERXD1",4,0)
EN ; -- main entry point for PSO ERX HOLDING QUEUE
"RTN","PSOERXD1",5,0)
 D EN^VALM("PSO ERX DRUG VALIDATION")
"RTN","PSOERXD1",6,0)
 Q
"RTN","PSOERXD1",7,0)
 ;
"RTN","PSOERXD1",8,0)
HDR ; -- header code
"RTN","PSOERXD1",9,0)
 S VALMHDR(1)="eRx Patient: "_$$GET1^DIQ(52.49,PSOIEN,.04,"E")
"RTN","PSOERXD1",10,0)
 S VALMHDR(2)="eRx Reference #: "_$$GET1^DIQ(52.49,PSOIEN,.01,"E")
"RTN","PSOERXD1",11,0)
 I $G(VALMBCK)="R" D INIT
"RTN","PSOERXD1",12,0)
 Q
"RTN","PSOERXD1",13,0)
 ;
"RTN","PSOERXD1",14,0)
INIT ;
"RTN","PSOERXD1",15,0)
 Q:'$G(PSOIEN)
"RTN","PSOERXD1",16,0)
 N LINE,ERXDRG,LINETXT,ERXQTY,ERXQQ,ERXDF,ERXSC,ERXRFLS,ERXDS,ERXDT,ERXDW,ERXDSUB,VADRG,NXTLINE,ORDITEM
"RTN","PSOERXD1",17,0)
 N ERXCOMM,ERXDRUG,ERXSIG,FILLDT,ISSDT,MAILWIN,PATSTAT,SGLOOP,SIGDATA,SIGLINE,SIGLOOP,VACLIN,VACOPIES,VADAYS
"RTN","PSOERXD1",18,0)
 N VADOSE,VADRGIEN,VAENBY,VAENDATE,VAPINST,VAPROV,VAPUS,VAQTY,VAREF,VAREMARK,VAROUTE,VASCHED,VASIG,VAVERB
"RTN","PSOERXD1",19,0)
 N PSODAT,PSONEW,SIGDATA,SGLOOP,PRVCARY,PCRFST,PCLOOP,INSTARY,IFRST,INLOOP,SEPLN,PATINST,PIARY,PILOOP
"RTN","PSOERXD1",20,0)
 N SFIRST,SIGARY,PSOIENS,PSODAT2,PFRST,FN,FSSIG,INST,PATIEN,PCFRST,PRVCOMM,PSODFN,SLOOP,ERXDIR,MANVAL
"RTN","PSOERXD1",21,0)
 N VASIG,VASARY,VALBY,VALDTTM,NFIRST,NLOOP,ERXNARY,DIE,DA,DR,INLOOP,ERXNOTE,PUC,DRGARY,DLP,X,Y,DINUM,DFN
"RTN","PSOERXD1",22,0)
 S LINE=0
"RTN","PSOERXD1",23,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERXD1",24,0)
 S FN=52.49
"RTN","PSOERXD1",25,0)
 D GETS^DIQ(52.49,PSOIEN,"**","IE","PSODAT")
"RTN","PSOERXD1",26,0)
 S PATIEN=$G(PSODAT(FN,PSOIENS,.05,"I"))
"RTN","PSOERXD1",27,0)
 ; stub entry in file 55 if it doesn't exist
"RTN","PSOERXD1",28,0)
 I $G(PATIEN) D
"RTN","PSOERXD1",29,0)
 .Q:$D(^PS(55,PATIEN,0))
"RTN","PSOERXD1",30,0)
 .S DIC="^PS(55,",DLAYGO=55
"RTN","PSOERXD1",31,0)
 .K DD,DO S DIC(0)="L",(DINUM,X)=PATIEN D FILE^DICN D:Y<1  K DIC,DA,DR,DD,DO,DLAYGO
"RTN","PSOERXD1",32,0)
 ..S $P(^PS(55,PATIEN,0),"^")=PATIEN K DIK,DA S DA=PATIEN,DIK="^PS(55,",DIK(1)=.01 D EN^DIK K DIK,DA
"RTN","PSOERXD1",33,0)
 S ERXDRUG=$G(PSODAT(FN,PSOIENS,3.1,"E"))
"RTN","PSOERXD1",34,0)
 ; quantity
"RTN","PSOERXD1",35,0)
 S ERXQTY=$G(PSODAT(FN,PSOIENS,5.1,"E"))
"RTN","PSOERXD1",36,0)
 ; quantity qualifier
"RTN","PSOERXD1",37,0)
 S ERXQQ=$G(PSODAT(FN,PSOIENS,5.2,"E"))
"RTN","PSOERXD1",38,0)
 ; drug form code
"RTN","PSOERXD1",39,0)
 S ERXDF=$G(PSODAT(FN,PSOIENS,41,"E"))
"RTN","PSOERXD1",40,0)
 ; strength code
"RTN","PSOERXD1",41,0)
 S ERXSC=$G(PSODAT(FN,PSOIENS,43,"E"))
"RTN","PSOERXD1",42,0)
 ; refills
"RTN","PSOERXD1",43,0)
 S ERXRFLS=$G(PSODAT(FN,PSOIENS,5.6,"E"))
"RTN","PSOERXD1",44,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXD1",45,0)
 I ERXRFLS="" D
"RTN","PSOERXD1",46,0)
 .S ERXRFLS=$G(PSODAT(FN,PSOIENS,5.7,"I"))
"RTN","PSOERXD1",47,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXD1",48,0)
 ; days supply
"RTN","PSOERXD1",49,0)
 S ERXDS=$G(PSODAT(FN,PSOIENS,5.5,"E"))
"RTN","PSOERXD1",50,0)
 ; erx date
"RTN","PSOERXD1",51,0)
 S ERXDT=$G(PSODAT(FN,PSOIENS,.03,"E"))
"RTN","PSOERXD1",52,0)
 ; written date
"RTN","PSOERXD1",53,0)
 S ERXDW=$G(PSODAT(FN,PSOIENS,5.9,"E"))
"RTN","PSOERXD1",54,0)
 ; substitutions
"RTN","PSOERXD1",55,0)
 S ERXDSUB=$G(PSODAT(FN,PSOIENS,5.8,"E"))
"RTN","PSOERXD1",56,0)
 ; va (matched) drug
"RTN","PSOERXD1",57,0)
 S ERXDIR=$G(PSODAT(FN,PSOIENS,7,"E"))
"RTN","PSOERXD1",58,0)
 S VADRG=$G(PSODAT(FN,PSOIENS,3.2,"E"))
"RTN","PSOERXD1",59,0)
 I VADRG']"" S VADRG="NOT LINKED"
"RTN","PSOERXD1",60,0)
 S PUC=$G(PSODAT(FN,PSOIENS,42,"E"))
"RTN","PSOERXD1",61,0)
 D TXT2ARY(.DRGARY,ERXDRUG,,70)
"RTN","PSOERXD1",62,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"eRx Drug: "_$G(DRGARY(1)))
"RTN","PSOERXD1",63,0)
 S DLP=1
"RTN","PSOERXD1",64,0)
 F  S DLP=$O(DRGARY(DLP)) Q:'DLP  D
"RTN","PSOERXD1",65,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"          "_$G(DRGARY(DLP)))
"RTN","PSOERXD1",66,0)
 S LINE=LINE+1
"RTN","PSOERXD1",67,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Qty: ",ERXQTY,1,26)
"RTN","PSOERXD1",68,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Days Supply: ",ERXDS,28,26)
"RTN","PSOERXD1",69,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Date Written: ",$P(ERXDW,"@"),54,26)
"RTN","PSOERXD1",70,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",71,0)
 S LINE=LINE+1
"RTN","PSOERXD1",72,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Qty Qualifier: "_ERXQQ)
"RTN","PSOERXD1",73,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Drug Form: "_ERXDF)
"RTN","PSOERXD1",74,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Strength: "_ERXSC)
"RTN","PSOERXD1",75,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Potency Unit Code: "_PUC)
"RTN","PSOERXD1",76,0)
 S LINE=LINE+1
"RTN","PSOERXD1",77,0)
 S LINE=LINE+1
"RTN","PSOERXD1",78,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Refills: ",ERXRFLS,1,15)
"RTN","PSOERXD1",79,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Do not sub: ",ERXDSUB,28,50)
"RTN","PSOERXD1",80,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",81,0)
 S SIGDATA=""
"RTN","PSOERXD1",82,0)
 D TXT2ARY(.SIGARY,ERXDIR,,70)
"RTN","PSOERXD1",83,0)
 S SFIRST=$O(SIGARY(0))
"RTN","PSOERXD1",84,0)
 S SGLOOP=0 F  S SGLOOP=$O(SIGARY(SGLOOP)) Q:'SGLOOP  D
"RTN","PSOERXD1",85,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,$S(SGLOOP=SFIRST:"eRx Sig: ",1:"         ")_$G(SIGARY(SGLOOP)))
"RTN","PSOERXD1",86,0)
 S ERXNOTE=$G(PSODAT(FN,PSOIENS,8,"E"))
"RTN","PSOERXD1",87,0)
 D TXT2ARY(.ERXNARY,ERXNOTE,,65)
"RTN","PSOERXD1",88,0)
 S NFIRST=$O(ERXNARY(0))
"RTN","PSOERXD1",89,0)
 S NLOOP=0 F  S NLOOP=$O(ERXNARY(NLOOP)) Q:'NLOOP  D
"RTN","PSOERXD1",90,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,$S(NLOOP=NFIRST:"eRx Notes: ",1:"           ")_$G(ERXNARY(NLOOP)))
"RTN","PSOERXD1",91,0)
 S DFN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXD1",92,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXD1",93,0)
 S $P(SEPLN,"-",80)="-" D SET^VALM10(LINE,SEPLN)
"RTN","PSOERXD1",94,0)
 ; vista drug information
"RTN","PSOERXD1",95,0)
 S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.5,"I")
"RTN","PSOERXD1",96,0)
 S VALBY=$$GET1^DIQ(52.49,PSOIEN,1.11,"E")
"RTN","PSOERXD1",97,0)
 S VALDTTM=$$GET1^DIQ(52.49,PSOIEN,1.12,"E")
"RTN","PSOERXD1",98,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Status: "_$S(MANVAL:"VALIDATED ("_VALBY_" - "_VALDTTM_")",1:"NOT VALIDATED"))
"RTN","PSOERXD1",99,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXD1",100,0)
 I $$GET1^DIQ(52.49,PSOIEN,.05,"I") D
"RTN","PSOERXD1",101,0)
 .D ALG^PSOERXU1(.LINE)
"RTN","PSOERXD1",102,0)
 ;/BLB/ PSO*7.0*520
"RTN","PSOERXD1",103,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXD1",104,0)
 S VADRGIEN=$G(PSODAT(52.49,PSOIENS,3.2,"I"))
"RTN","PSOERXD1",105,0)
 S VADRG=$S(VADRGIEN:$$GET1^DIQ(50,VADRGIEN,.01,"E"),1:"NOT MATCHED")
"RTN","PSOERXD1",106,0)
 S LINE=LINE+1 D SET^VALM10(LINE," (1) Vista Drug: "_VADRG)
"RTN","PSOERXD1",107,0)
 ; may not need clinic or remarks.
"RTN","PSOERXD1",108,0)
 S (VACLIN,VAREMARK)=""
"RTN","PSOERXD1",109,0)
 S VAPROV=$G(PSODAT(52.49,PSOIENS,2.3,"E"))
"RTN","PSOERXD1",110,0)
 S INST=$G(PSODAT(52.49,PSOIENS,26,"E"))
"RTN","PSOERXD1",111,0)
 ; if erx user comments exist, should we display them separately from the erx provider directions?
"RTN","PSOERXD1",112,0)
 I $D(PSODAT(52.49,PSOIENS,30)) S PRVCOMM=$G(PSODAT(52.49,PSOIENS,30,"E"))
"RTN","PSOERXD1",113,0)
 I '$L($G(PRVCOMM)) S PRVCOMM=$G(PSODAT(52.49,PSOIENS,8,"E"))
"RTN","PSOERXD1",114,0)
 S VADAYS=$G(PSODAT(52.49,PSOIENS,20.2,"E"))
"RTN","PSOERXD1",115,0)
 S VAQTY=$G(PSODAT(52.49,PSOIENS,20.1,"E"))
"RTN","PSOERXD1",116,0)
 S VAVERB=$G(PSODAT(52.49,PSOIENS,20.3,"E"))
"RTN","PSOERXD1",117,0)
 S PATSTAT=$$GET1^DIQ(55,PATIEN,3,"E")
"RTN","PSOERXD1",118,0)
 S MAILWIN=$G(PSODAT(52.49,PSOIENS,20.4,"E")) I MAILWIN="" S DIE="^PS(52.49,",DA=PSOIEN,DR="20.4///W" D ^DIE K DIE
"RTN","PSOERXD1",119,0)
 S VAREF=$G(PSODAT(52.49,PSOIENS,20.5,"E"))
"RTN","PSOERXD1",120,0)
 S PATINST=$G(PSODAT(52.49,PSOIENS,27,"E"))
"RTN","PSOERXD1",121,0)
 S PATINST=$$LSIG^PSOQUTIL(PATINST)
"RTN","PSOERXD1",122,0)
 ; testing instruction building
"RTN","PSOERXD1",123,0)
 ; end testing
"RTN","PSOERXD1",124,0)
 S VACLIN=$G(PSODAT(52.49,PSOIENS,20.6,"E")) I VACLIN="" S DIE="^PS(52.49,",DA=PSOIEN,DR="20.6///"_$$GET1^DIQ(59,PSOSITE,10,"I") D ^DIE K DIE
"RTN","PSOERXD1",125,0)
 D TXT2ARY(.PIARY,PATINST,,55)
"RTN","PSOERXD1",126,0)
 D DOSE
"RTN","PSOERXD1",127,0)
 ; pat instructions built from dosage multiple
"RTN","PSOERXD1",128,0)
 S PFRST="",PFRST=$O(PIARY(0)) I 'PFRST S PFRST=0
"RTN","PSOERXD1",129,0)
 S LINE=LINE+1 D SET^VALM10(LINE," (3) Pat Instructions: "_$G(PIARY(PFRST)))
"RTN","PSOERXD1",130,0)
 S PILOOP=PFRST F  S PILOOP=$O(PIARY(PILOOP)) Q:'PILOOP  D
"RTN","PSOERXD1",131,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"                       "_$G(PIARY(PILOOP)))
"RTN","PSOERXD1",132,0)
 ; provider comments come from the 'notes' field in 52.49 (#8)
"RTN","PSOERXD1",133,0)
 D TXT2ARY(.PRVCARY,PRVCOMM,,57)
"RTN","PSOERXD1",134,0)
 S PCFRST=$O(PRVCARY(0))
"RTN","PSOERXD1",135,0)
 S PCLOOP=0 F  S PCLOOP=$O(PRVCARY(PCLOOP)) Q:'PCLOOP  D
"RTN","PSOERXD1",136,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,$S(PCFRST=PCLOOP:" (4) Provider Comments: ",1:"                        ")_PRVCARY(PCLOOP))
"RTN","PSOERXD1",137,0)
 ; instructions are the unaltered SIG.
"RTN","PSOERXD1",138,0)
 ; if the instructions are longer than 57, convert to array for display
"RTN","PSOERXD1",139,0)
 S VASIG=""
"RTN","PSOERXD1",140,0)
 S SLOOP=0 F  S SLOOP=$O(^PS(52.49,PSOIEN,"SIG",SLOOP)) Q:'SLOOP  D
"RTN","PSOERXD1",141,0)
 .I '$L($G(VASIG)) S VASIG=$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0)) Q
"RTN","PSOERXD1",142,0)
 .S VASIG=$G(VASIG)_" "_$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0))
"RTN","PSOERXD1",143,0)
 S INLOOP=0 F  S INLOOP=$O(PSODAT(52.49,PSOIENS,31,INLOOP)) Q:'INLOOP  D
"RTN","PSOERXD1",144,0)
 .I '$L(INST) S INST=$G(PSODAT(52.49,PSOIENS,31,INLOOP)) Q
"RTN","PSOERXD1",145,0)
 .S INST=INST_" "_$G(PSODAT(52.49,PSOIENS,31,INLOOP))
"RTN","PSOERXD1",146,0)
 D TXT2ARY(.INSTARY,INST,,57)
"RTN","PSOERXD1",147,0)
 S IFRST=$O(INSTARY(0))
"RTN","PSOERXD1",148,0)
 S INLOOP=0 F  S INLOOP=$O(INSTARY(INLOOP)) Q:'INLOOP  D
"RTN","PSOERXD1",149,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,$S(IFRST=INLOOP:"          Instructions: ",1:"                        ")_$G(INSTARY(INLOOP)))
"RTN","PSOERXD1",150,0)
 S VASIG=VASIG_" "_PATINST_" "_PRVCOMM
"RTN","PSOERXD1",151,0)
 D TXT2ARY(.VASARY,VASIG,,55)
"RTN","PSOERXD1",152,0)
 S FSSIG=$O(VASARY(0))
"RTN","PSOERXD1",153,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"                   SIG: "_$S(FSSIG:$G(VASARY(FSSIG)),1:""))
"RTN","PSOERXD1",154,0)
 S SLOOP=1 F  S SLOOP=$O(VASARY(SLOOP)) Q:'SLOOP  D
"RTN","PSOERXD1",155,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"                        "_VASARY(SLOOP))
"RTN","PSOERXD1",156,0)
 S LINETXT=""
"RTN","PSOERXD1",157,0)
 S LINE=LINE+1 D SET^VALM10(LINE," (5) Patient Status: "_PATSTAT)
"RTN","PSOERXD1",158,0)
 S LINE=LINE+1
"RTN","PSOERXD1",159,0)
 D ADDITEM^PSOERX1A(.LINETXT," (6) Days Supply: ",VADAYS,1,25)
"RTN","PSOERXD1",160,0)
 D ADDITEM^PSOERX1A(.LINETXT,"     (7) QTY: ",VAQTY,40,30)
"RTN","PSOERXD1",161,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",162,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"    Provider ordered '"_$S($L(ERXRFLS):ERXRFLS,1:0)_"' refills")
"RTN","PSOERXD1",163,0)
 S LINE=LINE+1
"RTN","PSOERXD1",164,0)
 D ADDITEM^PSOERX1A(.LINETXT," (8) # of Refills: ",VAREF,1,30)
"RTN","PSOERXD1",165,0)
 ; routing defaults to 'M'ail
"RTN","PSOERXD1",166,0)
 D ADDITEM^PSOERX1A(.LINETXT,"(9) Routing: ",MAILWIN,45,25)
"RTN","PSOERXD1",167,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",168,0)
 S LINE=LINE+1 D SET^VALM10(LINE," (10)    Clinic: "_VACLIN)
"RTN","PSOERXD1",169,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"       Provider: "_VAPROV)
"RTN","PSOERXD1",170,0)
 S VALMCNT=LINE
"RTN","PSOERXD1",171,0)
 S EDTYP="D"
"RTN","PSOERXD1",172,0)
 K PSODAT,PSONEW,DOENT,TDUR
"RTN","PSOERXD1",173,0)
 Q
"RTN","PSOERXD1",174,0)
 ;
"RTN","PSOERXD1",175,0)
HELP ; -- help code
"RTN","PSOERXD1",176,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERXD1",177,0)
 Q
"RTN","PSOERXD1",178,0)
 ;
"RTN","PSOERXD1",179,0)
EXIT ; -- exit code
"RTN","PSOERXD1",180,0)
 K @VALMAR,EDTYP
"RTN","PSOERXD1",181,0)
 Q
"RTN","PSOERXD1",182,0)
 ;
"RTN","PSOERXD1",183,0)
EXPND ; -- expand code
"RTN","PSOERXD1",184,0)
 Q
"RTN","PSOERXD1",185,0)
 ; ARY - array to store the output (pass by reference)
"RTN","PSOERXD1",186,0)
 ; TEXT - the text to convert into the array format
"RTN","PSOERXD1",187,0)
 ; DELIM - delimiter for text (default is space)
"RTN","PSOERXD1",188,0)
 ; MAXLEN - maximum length of each array items text, defaults to 80
"RTN","PSOERXD1",189,0)
TXT2ARY(ARY,TEXT,DELIM,MAXLEN) ;
"RTN","PSOERXD1",190,0)
 N WORD,I,LCNT,LINETXT,S
"RTN","PSOERXD1",191,0)
 S S=$S($D(DELIM):DELIM,1:" ")
"RTN","PSOERXD1",192,0)
 I '$G(MAXLEN) S MAXLEN=80
"RTN","PSOERXD1",193,0)
 S LCNT=1,LINETXT=""
"RTN","PSOERXD1",194,0)
 F I=1:1:$L(TEXT,S) D
"RTN","PSOERXD1",195,0)
 .S WORD=$P(TEXT,S,I)
"RTN","PSOERXD1",196,0)
 .I $L(LINETXT)+$L(S)+$L(WORD)>MAXLEN D  Q
"RTN","PSOERXD1",197,0)
 ..S ARY(LCNT)=LINETXT
"RTN","PSOERXD1",198,0)
 ..S LCNT=LCNT+1,LINETXT=WORD
"RTN","PSOERXD1",199,0)
 .I '$L(LINETXT) S LINETXT=WORD Q
"RTN","PSOERXD1",200,0)
 .S LINETXT=LINETXT_S_WORD
"RTN","PSOERXD1",201,0)
 ; if there is information left, set it into the array
"RTN","PSOERXD1",202,0)
 I $L(LINETXT) S ARY(LCNT)=$G(LINETXT)
"RTN","PSOERXD1",203,0)
 Q
"RTN","PSOERXD1",204,0)
DOSE ;displays dosing info for pending orders.  called from psoorfi1
"RTN","PSOERXD1",205,0)
 K II,UNITS S DS=1
"RTN","PSOERXD1",206,0)
 I '$O(^PS(52.49,PSOIEN,21,0)) S LINE=LINE+1,LINETXT="" D ADDITEM^PSOERX1A(.LINETXT," (2)          *Dosage:",,1,30) D SET^VALM10(LINE,LINETXT) S LINETXT="" G DOSEX
"RTN","PSOERXD1",207,0)
 F I=0:0 S I=$O(^PS(52.49,PSOIEN,21,I)) Q:'I  S DOSE=$G(^PS(52.49,PSOIEN,21,I,1)),DOSE1=$G(^(2)) D  D DOSE1
"RTN","PSOERXD1",208,0)
 .S II=$G(II)+1 K PSONEW("UNITS",II)
"RTN","PSOERXD1",209,0)
 .S PSONEW("DOSE",II)=$P(DOSE1,"^"),PSONEW("DOSE ORDERED",II)=$P(DOSE1,"^",2),PSONEW("UNITS",II)=$P(DOSE,"^",9),PSONEW("NOUN",II)=$P(DOSE,"^",5)
"RTN","PSOERXD1",210,0)
 .S:$P(DOSE,"^",9) UNITS=$P(^PS(50.607,$P(DOSE,"^",9),0),"^")
"RTN","PSOERXD1",211,0)
 .S PSONEW("VERB",II)=$P(DOSE,"^",10),PSONEW("ROUTE",II)=$P(DOSE,"^",8)
"RTN","PSOERXD1",212,0)
 .S ROUTE="" S:$P(DOSE,"^",8) ROUTE=$P(^PS(51.2,$P(DOSE,"^",8),0),"^")
"RTN","PSOERXD1",213,0)
 .S PSONEW("SCHEDULE",II)=$P(DOSE,"^"),PSONEW("DURATION",II)=$P(DOSE,"^",2)
"RTN","PSOERXD1",214,0)
 .S DOENT=$G(DOENT)+1 I $P(DOSE,"^",6)]"" S PSONEW("CONJUNCTION",II)=$S($P(DOSE,"^",6)="S":"T",$P(DOSE,"^",6)="X":"X",1:"A")
"RTN","PSOERXD1",215,0)
 .I 'PSONEW("DOSE ORDERED",II),$G(PSONEW("VERB",II))]"" D
"RTN","PSOERXD1",216,0)
 ..S LINETXT="" S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"               Verb: ",$G(PSONEW("VERB",II)),1,40)
"RTN","PSOERXD1",217,0)
 ..D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",218,0)
 .S:$G(DS) LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT," (2)","",1,5)
"RTN","PSOERXD1",219,0)
DOSEX S PSONEW("ENT")=+$G(II) K DOSE,DOSE1,II,I,UNITS,ROUTE,DG
"RTN","PSOERXD1",220,0)
 Q
"RTN","PSOERXD1",221,0)
DOSE1 ;
"RTN","PSOERXD1",222,0)
 I $G(DS)=1 D ADDITEM^PSOERX1A(.LINETXT,"        *Dosage:","",4,30) D FMD G DU
"RTN","PSOERXD1",223,0)
 S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"            *Dosage:","",1,30) D FMD
"RTN","PSOERXD1",224,0)
DU ;
"RTN","PSOERXD1",225,0)
 S PSODFN=$O(^PS(55,"B",PATIEN,0))
"RTN","PSOERXD1",226,0)
 I 'PSONEW("DOSE ORDERED",I),$P($G(^PS(55,PSODFN,"LAN")),"^") D
"RTN","PSOERXD1",227,0)
 .S LINE=LINE+1,LINETXT="" D ADDITEM^PSOERX1A(.LINETXT,"  Oth. Lang. Dosage: ",$G(PSONEW("ODOSE",I)),1,50) D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",228,0)
 I PSONEW("DOSE ORDERED",II),$G(PSONEW("VERB",II))]"" D
"RTN","PSOERXD1",229,0)
 .S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"               Verb: ",$G(PSONEW("VERB",II)),1,50) D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",230,0)
 .S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"     Dispense Units: ",$S($E(PSONEW("DOSE ORDERED",II),1)=".":"0",1:"")_PSONEW("DOSE ORDERED",II),1,50) D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",231,0)
 I PSONEW("NOUN",II)]"" D
"RTN","PSOERXD1",232,0)
 .S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"               Noun: ",PSONEW("NOUN",II),1,50) D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",233,0)
 I $G(ROUTE)]"" D
"RTN","PSOERXD1",234,0)
 .S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"             *Route: ",$G(ROUTE),1,50) D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",235,0)
 S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"          *Schedule: ",PSONEW("SCHEDULE",II),1,50) D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",236,0)
 I $G(PSONEW("DURATION",II))]"" D
"RTN","PSOERXD1",237,0)
 .S PSONEW("DURATION",II)=$S($E(PSONEW("DURATION",II),1)'?.N:$E(PSONEW("DURATION",II),2,99)_$E(PSONEW("DURATION",II),1),1:PSONEW("DURATION",II))
"RTN","PSOERXD1",238,0)
 .S TDUR=PSONEW("DURATION",II)_" ("_$S(PSONEW("DURATION",II)["M":"MINUTES",PSONEW("DURATION",II)["H":"HOURS",PSONEW("DURATION",II)["L":"MONTHS",PSONEW("DURATION",II)["W":"WEEKS",1:"DAYS")_")"
"RTN","PSOERXD1",239,0)
 .S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"          *Duration: ",TDUR,1,50) D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",240,0)
 I $G(PSONEW("CONJUNCTION",II))]"" D
"RTN","PSOERXD1",241,0)
 .S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"       *Conjunction: ",$S(PSONEW("CONJUNCTION",II)="T":"THEN",PSONEW("CONJUNCTION",II)="X":"EXCEPT",1:"AND"),1,50) D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",242,0)
 Q
"RTN","PSOERXD1",243,0)
FMD ;
"RTN","PSOERXD1",244,0)
 Q:$G(PSONEW("DOSE",II))']""  S MIG=PSONEW("DOSE",II)
"RTN","PSOERXD1",245,0)
 I $E(MIG,1)=".",$G(PSONEW("DOSE ORDERED",II)) S MIG="0"_MIG
"RTN","PSOERXD1",246,0)
 F SG=1:1:$L(MIG," ") D
"RTN","PSOERXD1",247,0)
 .I $L(LINETXT_" "_$P(MIG," ",SG))>80 D  Q
"RTN","PSOERXD1",248,0)
 ..S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT," ","",20,1)
"RTN","PSOERXD1",249,0)
 ..D ADDITEM^PSOERX1A(.LINETXT," ",$P(MIG," ",SG),$L(LINETXT),$L($P(MIG," ",SG))+1)
"RTN","PSOERXD1",250,0)
 .D ADDITEM^PSOERX1A(.LINETXT," ",$P(MIG," ",SG),$L(LINETXT),$L($P(MIG," ",SG))+1)
"RTN","PSOERXD1",251,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",252,0)
 I $G(UNITS)]"" D
"RTN","PSOERXD1",253,0)
 .I $L(LINETXT_" ("_UNITS_")")>80 D  Q
"RTN","PSOERXD1",254,0)
 ..S LINE=LINE+1,LINETXT=""
"RTN","PSOERXD1",255,0)
 ..D ADDITEM^PSOERX1A(.LINETXT," ","",20,1)
"RTN","PSOERXD1",256,0)
 ..D ADDITEM^PSOERX1A(.LINETXT," ("_UNITS_")",22,50)
"RTN","PSOERXD1",257,0)
 ..D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",258,0)
 K DS,MIG,SG
"RTN","PSOERXD1",259,0)
 ; Consider invoking this as a future enhancement.
"RTN","PSOERXD1",260,0)
 ;I '$G(PSONEW("DOSE ORDERED",II)),$P($G(^PS(55,PSODFN,"LAN")),"^") D LAN^PSOORED5
"RTN","PSOERXD1",261,0)
 Q
"RTN","PSOERXD2")
0^13^B211196189^B205488607
"RTN","PSOERXD2",1,0)
PSOERXD2 ;ALB/BWF - eRx Drug edit actions ; 5/26/2017 9:57am
"RTN","PSOERXD2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,506,520**;DEC 1997;Build 52
"RTN","PSOERXD2",3,0)
 ;
"RTN","PSOERXD2",4,0)
 Q
"RTN","PSOERXD2",5,0)
SBN ;
"RTN","PSOERXD2",6,0)
 N Y,ERXIEN
"RTN","PSOERXD2",7,0)
 S Y=$P(XQORNOD(0),"=",2)
"RTN","PSOERXD2",8,0)
 I Y']"" S VALMBCK="R" Q
"RTN","PSOERXD2",9,0)
 D EDIT^PSOERX1A("D",Y)
"RTN","PSOERXD2",10,0)
 S VALMBCK="R"
"RTN","PSOERXD2",11,0)
 Q
"RTN","PSOERXD2",12,0)
VDRG1(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",13,0)
 N VANDRG,VAODRG,DIE,DA,DR,AUTOVAL,DIC,Y,QTLOOP,SELDRG,VDRG,VANDRG,VAOI,PATINST,FIELD
"RTN","PSOERXD2",14,0)
 Q:'$G(PSOIEN)
"RTN","PSOERXD2",15,0)
 S VAODRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I")
"RTN","PSOERXD2",16,0)
 S AUTOVAL=$$GET1^DIQ(52.49,PSOIEN,1.4,"I")
"RTN","PSOERXD2",17,0)
 I VAODRG W !,"Current Vista Drug: "_$$GET1^DIQ(50,VAODRG,.01,"E")
"RTN","PSOERXD2",18,0)
 ; for now allow user to search by drug name. may enhance screening in the future.
"RTN","PSOERXD2",19,0)
 S DIC(0)="AEMQ",DIC=50,DIC("S")="I $$ACTIVE^PSOERXA0(Y),($$OUTPAT^PSOERXA0(Y)),('$$INVCOMP^PSOERXA0(Y)),('$$CS^PSOERXA0(Y))"
"RTN","PSOERXD2",20,0)
 I VAODRG]"" S DIC("B")=VAODRG
"RTN","PSOERXD2",21,0)
 D ^DIC K DIC
"RTN","PSOERXD2",22,0)
 I $G(DUOUT)!($P(Y,U)<1) S PQUIT=1 Q
"RTN","PSOERXD2",23,0)
 S SELDRG=Y
"RTN","PSOERXD2",24,0)
 W !!,"You have selected: "_$P(Y,U,2),!,"Would you like to use this drug/supply?" S DIR(0)="YO" D ^DIR K DIR
"RTN","PSOERXD2",25,0)
 I Y="^"!(Y<1) S PQUIT=1 Q
"RTN","PSOERXD2",26,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="3.2///"_$P(SELDRG,U,1) D ^DIE
"RTN","PSOERXD2",27,0)
 ; set the manual validation flag if the drug has been selected.
"RTN","PSOERXD2",28,0)
 S VANDRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I")
"RTN","PSOERXD2",29,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERXD2",30,0)
 ; if the drug has changed, update the manual validation by and date/time
"RTN","PSOERXD2",31,0)
 I VANDRG'="",VAODRG'=VANDRG D
"RTN","PSOERXD2",32,0)
 .S QTLOOP=0 F  S QTLOOP=$O(^PS(52.49,PSOIEN,21,QTLOOP)) Q:'QTLOOP  D
"RTN","PSOERXD2",33,0)
 ..S FDA(52.4921,QTLOOP_","_PSOIENS,.01)="@" D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",34,0)
 .; if the drug is the same, leave the manual validation,otherwise delete it.
"RTN","PSOERXD2",35,0)
 .S FDA(52.49,PSOIENS,1.5)=""
"RTN","PSOERXD2",36,0)
 .S FDA(52.49,PSOIENS,1.11)="",FDA(52.49,PSOIENS,1.12)=""
"RTN","PSOERXD2",37,0)
 .S FDA(52.49,PSOIENS,20.3)="",FDA(52.49,PSOIENS,20.4)=""
"RTN","PSOERXD2",38,0)
 .S FDA(52.49,PSOIENS,27)="",FDA(52.49,PSOIENS,20.1)="",FDA(52.49,PSOIENS,20.2)=""
"RTN","PSOERXD2",39,0)
 .S FDA(52.49,PSOIENS,20.3)="",FDA(52.49,PSOIENS,20.4)="",FDA(52.49,PSOIENS,20.5)=""
"RTN","PSOERXD2",40,0)
 ; get and file patient instructions
"RTN","PSOERXD2",41,0)
 S VDRG=VANDRG
"RTN","PSOERXD2",42,0)
 S VAOI=$$GET1^DIQ(50,VDRG,2.1,"I")
"RTN","PSOERXD2",43,0)
 S PATINST=$$GET1^DIQ(50.7,VAOI,7,"E")
"RTN","PSOERXD2",44,0)
 I $L(PATINST) D
"RTN","PSOERXD2",45,0)
 .S FDA(52.49,PSOIENS,27)=$G(PATINST)
"RTN","PSOERXD2",46,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",47,0)
 Q
"RTN","PSOERXD2",48,0)
VDRG2(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",49,0)
 N PSOQTS,PSOFROM
"RTN","PSOERXD2",50,0)
 N PSODOSE,PSONEW,PSODRUG,PSORXED,VERB,QTIEN,SFIENS,DOSE,PSODFN
"RTN","PSOERXD2",51,0)
 ; get patient IEN
"RTN","PSOERXD2",52,0)
 S PSODFN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXD2",53,0)
 I 'PSODFN D  Q
"RTN","PSOERXD2",54,0)
 .W !,"Cannot continue with dosing instructions until patient has been matched."
"RTN","PSOERXD2",55,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERXD2",56,0)
 .S PQUIT=1
"RTN","PSOERXD2",57,0)
 ; get drug ien and orderable item ien
"RTN","PSOERXD2",58,0)
 D DERX1(PSOIEN,PSOIENS,1)
"RTN","PSOERXD2",59,0)
 S PSODRUG("IEN")=$$GET1^DIQ(52.49,PSOIEN,3.2,"I") Q:'PSODRUG("IEN")
"RTN","PSOERXD2",60,0)
 S PSODRUG("OI")=$$GET1^DIQ(50,PSODRUG("IEN"),2.1,"I") Q:'PSODRUG("OI")
"RTN","PSOERXD2",61,0)
 S (PSORXED("ENT"),ENT)=1
"RTN","PSOERXD2",62,0)
 ; SET PSOFROM=PENDING so the dosage list will activate and present to the user
"RTN","PSOERXD2",63,0)
 S PSOFROM="PENDING"
"RTN","PSOERXD2",64,0)
 D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN)
"RTN","PSOERXD2",65,0)
 D ASK^PSOBKDED
"RTN","PSOERXD2",66,0)
 I $G(DOSE)']"" S PQUIT=1 Q
"RTN","PSOERXD2",67,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERXD2",68,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOERXD2",69,0)
VER ;
"RTN","PSOERXD2",70,0)
 D DERX1(PSOIEN,PSOIENS,1)
"RTN","PSOERXD2",71,0)
 ;below logic brought over from VER^PSOOREDX
"RTN","PSOERXD2",72,0)
 D KV S DIR(0)="52.0113,8"
"RTN","PSOERXD2",73,0)
 S:$G(PSORXED("VERB",ENT))]"" DIR("B")=PSORXED("VERB",ENT)
"RTN","PSOERXD2",74,0)
 D ^DIR
"RTN","PSOERXD2",75,0)
 I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOERXD2",76,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",77,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOERXD2",78,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOERXD2",79,0)
DUPD ;
"RTN","PSOERXD2",80,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOERXD2",81,0)
 ; below logic brought over from DUPD^PSOOREDX
"RTN","PSOERXD2",82,0)
 D KV S DIR(0)="52.0113,1",DIR("A")="DISPENSE UNITS PER DOSE"_$S($G(PSORXED("NOUN",ENT))]"":"("_PSORXED("NOUN",ENT)_")",1:"")
"RTN","PSOERXD2",83,0)
 I '$G(PSORXED("DOSE",ENT)),$G(PSORXED("DOSE",ENT-1)) S PSORXED("DOSE",ENT)=PSORXED("DOSE",ENT-1)
"RTN","PSOERXD2",84,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:1) S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOERXD2",85,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOERXD2",86,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",87,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOERXD2",88,0)
 ;below logic brought over from STR^PSOOREDX
"RTN","PSOERXD2",89,0)
 S:+STRE>0&(X>0) PSORXED("DOSE",ENT)=(X*STRE) W !,"Dosage Ordered: "_$S($E(PSORXED("DOSE",ENT),1)=".":"0",1:"")_PSORXED("DOSE",ENT)_UNITN,!
"RTN","PSOERXD2",90,0)
 S:X'="" (PSORXED("DOSE ORDERED",ENT),DUPD)=X
"RTN","PSOERXD2",91,0)
NOU1 ;
"RTN","PSOERXD2",92,0)
 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOERXD2",93,0)
 D CNON
"RTN","PSOERXD2",94,0)
 N PSONDEF
"RTN","PSOERXD2",95,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOERXD2",96,0)
NOU ;
"RTN","PSOERXD2",97,0)
 ;below logic brought over from NOU^PSOOREDX
"RTN","PSOERXD2",98,0)
 D KV S DIR(0)="52.0113,3"
"RTN","PSOERXD2",99,0)
 S DIR("B")=$S($G(NOUN)]"":NOUN,1:$G(PSORXED("NOUN",ENT))) K:DIR("B")="" DIR("B")
"RTN","PSOERXD2",100,0)
 S PSONDEF=$G(DIR("B"))
"RTN","PSOERXD2",101,0)
 D ^DIR
"RTN","PSOERXD2",102,0)
 I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOERXD2",103,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",104,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOERXD2",105,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOERXD2",106,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOERXD2",107,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOERXD2",108,0)
 ;
"RTN","PSOERXD2",109,0)
RTE ;
"RTN","PSOERXD2",110,0)
 N CURTE,ERXRTE
"RTN","PSOERXD2",111,0)
 S CURTE=$$GET1^DIQ(52.4921,ENT_","_PSOIEN_",",10,"E") S PSORXED("ROUTE",ENT)=CURTE
"RTN","PSOERXD2",112,0)
 K JUMP ;S ROU="PSOORED3" D RTE2 K ROU
"RTN","PSOERXD2",113,0)
 S ROU="PSOERXD2" D RTE2 K ROU
"RTN","PSOERXD2",114,0)
 K ROU
"RTN","PSOERXD2",115,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOERXD2",116,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",117,0)
 ;
"RTN","PSOERXD2",118,0)
SCH ;
"RTN","PSOERXD2",119,0)
 K PSOSCH,DIR,CURSCH
"RTN","PSOERXD2",120,0)
 I '$D(ENT) S ENT=PSORXED("ENT")
"RTN","PSOERXD2",121,0)
 S CURSCH=$$GET1^DIQ(52.4921,ENT_","_PSOIEN_",",1,"E") I CURSCH]"" S DIR("B")=CURSCH
"RTN","PSOERXD2",122,0)
 S DIR("?")="^D SCHLP^PSOORED4",DIR("A")="Schedule: ",DIR(0)="FA^1:20^I X[""""""""!(X?.E1C.E)!($A(X)=45)!($L(X,"" "")>$S(X[""PRN"":4,1:3))!($L(X)>20)!($L(X)<1) K X"
"RTN","PSOERXD2",123,0)
 D ^DIR
"RTN","PSOERXD2",124,0)
 I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOERXD2",125,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",126,0)
 S SCH=$$SCHASL^PSOORED5(Y) D SCH^PSOSIG I $G(SCH)']""!($D(DTOUT))!($D(DUOUT)) G SCH
"RTN","PSOERXD2",127,0)
 S PSORXED("SCHEDULE",ENT)=SCH IF $G(SCHEX)'="" W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOERXD2",128,0)
 S:PSORXED("ENT")<ENT PSORXED("ENT")=ENT
"RTN","PSOERXD2",129,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXD2",130,0)
 S PSORXED("SCHEDULE",ENT)=$$UP^XLFSTR(PSORXED("SCHEDULE",ENT))
"RTN","PSOERXD2",131,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXD2",132,0)
DUR ;
"RTN","PSOERXD2",133,0)
 N SIG,SIGDAT,SLOOP,P01,I,DDONE
"RTN","PSOERXD2",134,0)
 D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN DAYS, HOURS OR MINUTES)"
"RTN","PSOERXD2",135,0)
 S DIR("B")=$S($G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOERXD2",136,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOERXD2",137,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",138,0)
 ;below logic is from DUR1^PSOOREDX
"RTN","PSOERXD2",139,0)
 I X="@" K DUR,PSORXED("DURATION",ENT)
"RTN","PSOERXD2",140,0)
 I Y'="" S PSORXED("DURATION",ENT)=Y W " ("_$S(Y["L":"MONTHS",Y["W":"WEEKS",Y["H":"HOURS",Y["M":"MINUTES",1:"DAYS")_")"
"RTN","PSOERXD2",141,0)
 ;
"RTN","PSOERXD2",142,0)
 ; KEEP THIS CODE! - REMOVE CONJUNCTION FOR NOW, SINCE WE WILL NOT HAVE COMPLEX DOSING - FUTURE ENHANCEMENT
"RTN","PSOERXD2",143,0)
 ;CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOERXD2",144,0)
 ;G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",145,0)
 ;I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOERXD2",146,0)
 ;S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOERXD2",147,0)
 ;I X="@",$D(PSORXED("CONJUNCTION",ENT)) D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOERXD2",148,0)
 ;;
"RTN","PSOERXD2",149,0)
 ;N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOERXD2",150,0)
 ;;*437
"RTN","PSOERXD2",151,0)
 ;I '$$DUROK^PSOORED3(.PSORXED,ENT) D  G DUR
"RTN","PSOERXD2",152,0)
 ;. W !!,"Duration is required for the dosage entered prior to the THEN conjunction.",$C(7),!
"RTN","PSOERXD2",153,0)
 ;I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSONEW("DFLG")) EX S ENT=ENT+1 K DIR G ASK
"RTN","PSOERXD2",154,0)
 ;E  K PSOCKCON D DCHK1^PSODOSUT I $D(DTOUT)!($D(DUOUT)) S PSORX("DFLG")=1,PSONEW("DFLG")=1 G EX  ;don't need to print the full summary, just the last sequence. 
"RTN","PSOERXD2",155,0)
 ;I PSOSAVX="",$G(PSORXED) K PSOCKCON,PSOEDDOS
"RTN","PSOERXD2",156,0)
 ;K PSOSAVX
"RTN","PSOERXD2",157,0)
 ;;
"RTN","PSOERXD2",158,0)
 ;S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOERXD2",159,0)
 ;D EN^PSOFSIG(.PSORXED),VERI I $G(CKX),'$G(PSOSIGFL) D MP1 K CKX
"RTN","PSOERXD2",160,0)
 ;I $G(PSOSIGFL)=1 D  I '$G(PSOSIGFL) Q
"RTN","PSOERXD2",161,0)
 ;.I $D(OR0),$P(OR0,"^",24)=1 S VALMSG="Digitally Signed Order - No such changes allowed." K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D  Q
"RTN","PSOERXD2",162,0)
 ;..I $D(PSOBDR) K PSODRUG M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOERXD2",163,0)
 ;.S PSORXED("ENT")=ENT,SIGOK=1,VALMSG="This change will create a new prescription!",NCPDPFLG=1
"RTN","PSOERXD2",164,0)
 ;K QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOERXD2",165,0)
 ;I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOERXD2",166,0)
 ;K QTYHLD
"RTN","PSOERXD2",167,0)
 ;I '$G(PSORXED("QTY")),$P(OR0,"^",10) S PSORXED("QTY")=$P(OR0,"^",10)
"RTN","PSOERXD2",168,0)
 ;S PSORXED("INS")="TESTING TO SEE HOW LONG WE CAN MAKE THE SIG AND GET THIS TO FORMAT CORRECTLY"
"RTN","PSOERXD2",169,0)
 S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOERXD2",170,0)
 D EN^PSOFSIG(.PSORXED)
"RTN","PSOERXD2",171,0)
 ; delete existing SIG
"RTN","PSOERXD2",172,0)
 S SLOOP=0 F  S SLOOP=$O(^PS(52.49,PSOIEN,"SIG",SLOOP)) Q:'SLOOP  D
"RTN","PSOERXD2",173,0)
 .S FDA(52.4926,SLOOP_","_PSOIEN_",",.01)="@"
"RTN","PSOERXD2",174,0)
 I $D(FDA) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",175,0)
 ; file sig into appropriate VA DISPENSING INSTRUCTIONS multiple
"RTN","PSOERXD2",176,0)
 S SLOOP=0 F  S SLOOP=$O(SIG(SLOOP)) Q:'SLOOP  D
"RTN","PSOERXD2",177,0)
 .S SIGDAT=$G(SIG(SLOOP)) Q:SIGDAT=""
"RTN","PSOERXD2",178,0)
 .S SFDA(52.4926,"+1,"_PSOIENS,.01)=SIGDAT D UPDATE^DIE(,"SFDA",,"SERR") K SFDA
"RTN","PSOERXD2",179,0)
 S QTIEN=$O(^PS(52.49,PSOIEN,21,0))
"RTN","PSOERXD2",180,0)
 S SFIENS=$S(QTIEN:QTIEN_",",1:"+1,")
"RTN","PSOERXD2",181,0)
 S P01=$S($L($G(PSORXED("DOSE ORDERED",ENT))):$G(PSORXED("DOSE ORDERED",ENT))_"&"_$G(PSORXED("NOUN",ENT)),1:$G(PSORXED("DOSE",ENT)))
"RTN","PSOERXD2",182,0)
 I '$L(P01) D  Q
"RTN","PSOERXD2",183,0)
 .W !,"Dosage is required. Please re-enter the dosing instructions." S DIR(0)="W" D ^DIR D EX Q 
"RTN","PSOERXD2",184,0)
 S FDA(52.4921,SFIENS_PSOIENS,.01)=P01
"RTN","PSOERXD2",185,0)
 S FDA(52.4921,SFIENS_PSOIENS,1)=$G(PSORXED("SCHEDULE",ENT))
"RTN","PSOERXD2",186,0)
 S FDA(52.4921,SFIENS_PSOIENS,2)=$G(PSORXED("DURATION",ENT))
"RTN","PSOERXD2",187,0)
 S FDA(52.4921,SFIENS_PSOIENS,8)=$G(PSORXED("DOSE",ENT))
"RTN","PSOERXD2",188,0)
 S FDA(52.4921,SFIENS_PSOIENS,9)=$G(PSORXED("DOSE ORDERED",ENT))
"RTN","PSOERXD2",189,0)
 S FDA(52.4921,SFIENS_PSOIENS,10)=$G(PSORXED("ROUTE",ENT))
"RTN","PSOERXD2",190,0)
 S FDA(52.4921,SFIENS_PSOIENS,11)=$G(PSORXED("UNITS",ENT))
"RTN","PSOERXD2",191,0)
 S FDA(52.4921,SFIENS_PSOIENS,12)=$G(PSORXED("NOUN",ENT))
"RTN","PSOERXD2",192,0)
 S FDA(52.4921,SFIENS_PSOIENS,13)=$G(PSORXED("VERB",ENT))
"RTN","PSOERXD2",193,0)
 ; VA INSTRUCTIONS
"RTN","PSOERXD2",194,0)
 N UNEXINS,UNEXARY,DDONE
"RTN","PSOERXD2",195,0)
 I $G(PSORXED("ENT")) D
"RTN","PSOERXD2",196,0)
 .S DDONE=0
"RTN","PSOERXD2",197,0)
 .F I=1:1:PSORXED("ENT")  D  Q:DDONE
"RTN","PSOERXD2",198,0)
 ..I '$D(PSORXED("DOSE ORDERED",I)) S DDONE=1 Q
"RTN","PSOERXD2",199,0)
 ..I '$L($G(UNEXINS)) D  Q
"RTN","PSOERXD2",200,0)
 ...S UNEXINS=$G(PSORXED("VERB",I))_" "_$G(PSORXED("DOSE ORDERED",I))_" "_$G(PSORXED("NOUN",I))_" "_$G(ERXRTE(I))_" "_$G(PSORXED("SCHEDULE",I))
"RTN","PSOERXD2",201,0)
 ...I $L($G(PSORXED("DURATION",I))) S UNEXINS=UNEXINS_" "_$G(PSORXED("DURATION",I))
"RTN","PSOERXD2",202,0)
 ...I $L($G(PSORXED("CONJUNCTION",I))) S UNEXINS=UNEXINS_" "_$G(PSORXED("CONJUNCTION",I))
"RTN","PSOERXD2",203,0)
 ..S UNEXINS=UNEXINS_$G(PSORXED("VERB",I))_" "_$G(PSORXED("DOSE ORDERED",I))_" "_$G(PSORXED("NOUN",I))_" "_$G(ERXRTE(I))_" "_$G(PSORXED("SCHEDULE",I))
"RTN","PSOERXD2",204,0)
 ..I $L($G(PSORXED("DURATION",I))) S UNEXINS=UNEXINS_" "_$G(PSORXED("DURATION",I))
"RTN","PSOERXD2",205,0)
 ..I $L($G(PSORXED("CONJUNCTION",I))) S UNEXINS=UNEXINS_" "_$G(PSORXED("CONJUNCTION",I))
"RTN","PSOERXD2",206,0)
 I $L($G(UNEXINS)) D
"RTN","PSOERXD2",207,0)
 .D TXT2ARY^PSOERXD1(.UNEXARY,UNEXINS,,80)
"RTN","PSOERXD2",208,0)
 .D WP^DIE(52.49,PSOIEN_",",31,"K","UNEXARY","BWFERR")
"RTN","PSOERXD2",209,0)
 I SFIENS["+" D UPDATE^DIE(,"FDA",,"ERR") K FDA
"RTN","PSOERXD2",210,0)
 ; if there is a quantity/timing entry, overwrite the data (we are not using complex dosing in this phase)
"RTN","PSOERXD2",211,0)
 I SFIENS'["+" D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",212,0)
EX ;
"RTN","PSOERXD2",213,0)
 K PSOBDR,PSOBDRG,PSOSCH,DUPD,STRE,UNITN,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSODOSE,OLENT,FIELD,FLDNM,AR,NM,ENT,STRE,UNITN,PSODOSE,ERTE,ROU,AR1,INS1
"RTN","PSOERXD2",214,0)
KV K DTOUT,DUOUT,DIR,DIRUT
"RTN","PSOERXD2",215,0)
 Q
"RTN","PSOERXD2",216,0)
EXQ ;
"RTN","PSOERXD2",217,0)
 K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D MP1
"RTN","PSOERXD2",218,0)
 I $D(PSOBDR) M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOERXD2",219,0)
 S PQUIT=1
"RTN","PSOERXD2",220,0)
 G EX Q
"RTN","PSOERXD2",221,0)
MP1 ;
"RTN","PSOERXD2",222,0)
 S VALMSG="eRx Not Updated!"
"RTN","PSOERXD2",223,0)
 Q
"RTN","PSOERXD2",224,0)
JUMP ;jump to fields
"RTN","PSOERXD2",225,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOERXD2",226,0)
 D FNM
"RTN","PSOERXD2",227,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOERXD2",228,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOERXD2",229,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOERXD2",230,0)
 D JFN G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOERXD2",231,0)
 G EX
"RTN","PSOERXD2",232,0)
 Q
"RTN","PSOERXD2",233,0)
FNM S NM=$E(X,2,4),NM=$TR(NM,"qwertyuioplkjhgfdsazxcvbnm","QWERTYUIOPLKJHGFDSAZXCVBNM")
"RTN","PSOERXD2",234,0)
 S FLDNM=$S(NM="DOS":"DOSE^*Dosage",NM="DIS":"DOSE ORDERED^Dispense Units",NM="ROU":"ROUTE^*Route",NM="SCH":"SCHEDULE^*Schedule",NM="DUR"!(NM="LIM"):"DURATION^*Duration",1:"")
"RTN","PSOERXD2",235,0)
 S:FLDNM="" FLDNM=$S(NM="CON":"CONJUNCTION^*Conjunction",NM="NOU":"NOUN^Noun",NM="VER":"VERB^Verb",1:"")
"RTN","PSOERXD2",236,0)
 Q
"RTN","PSOERXD2",237,0)
JFN K FLDNM,AR S ENT=+Y,FLDNM=$S(NM="NOU":"NOU",NM="VER":"VER",NM="DOS":"ASK",NM="DIS":"DUPD",NM="ROU":"RTE",NM="SCH":"SCH",NM="DUR"!(NM="LIM"):"DUR",NM="CON":"CON",1:"")
"RTN","PSOERXD2",238,0)
 Q
"RTN","PSOERXD2",239,0)
CNON ;
"RTN","PSOERXD2",240,0)
 I $G(NOUN)'="" Q
"RTN","PSOERXD2",241,0)
 I '$G(PSORXED("DOSE ORDERED",ENT)) Q
"RTN","PSOERXD2",242,0)
 N PSONLT,PSONLL,PSONLG
"RTN","PSOERXD2",243,0)
 S PSONLL=$P($G(DOSE("DD",+$G(PSODRUG("IEN")))),"^",9) I PSONLL="" Q
"RTN","PSOERXD2",244,0)
 S PSONLG=$L(PSONLL)
"RTN","PSOERXD2",245,0)
 I PSONLG'>3 Q
"RTN","PSOERXD2",246,0)
 S PSONLT=$E(PSONLL,(PSONLG-2),PSONLG)
"RTN","PSOERXD2",247,0)
 I PSONLT'="(S)",PSONLT'="(s)" Q
"RTN","PSOERXD2",248,0)
 ;test noun of (S)
"RTN","PSOERXD2",249,0)
 K NOUN
"RTN","PSOERXD2",250,0)
 I $G(PSORXED("DOSE ORDERED",ENT))>1 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))_$E(PSONLT,2) Q
"RTN","PSOERXD2",251,0)
 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))
"RTN","PSOERXD2",252,0)
 Q
"RTN","PSOERXD2",253,0)
RTE2 I $G(DRET) S PSORXED("ROUTE",ENT)=""
"RTN","PSOERXD2",254,0)
 I $G(RTE) K RTE
"RTN","PSOERXD2",255,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXD2",256,0)
 K DIR,DIRUT S DIR(0)="F^2:45",DIR("A")="ROUTE",DIR("?")="^D HLP^PSOORED4"
"RTN","PSOERXD2",257,0)
 ;/BLB/ PSO*7.0*520 - END CHANGE
"RTN","PSOERXD2",258,0)
 ;S DIR("B")=$S($G(PSORXED("ROUTE",ENT)):$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),$G(RTE)]"":RTE,$G(DRET):"",1:"PO") K:DIR("B")="" DIR("B")
"RTN","PSOERXD2",259,0)
 S DIR("B")=$G(CURTE)
"RTN","PSOERXD2",260,0)
 ;I '$G(PSORXED("ROUTE",ENT)),$G(PSOREEDT) K DIR("B")
"RTN","PSOERXD2",261,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="RTE",JUMP=1 K DIRUT,DTOUT Q
"RTN","PSOERXD2",262,0)
 Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOERXD2",263,0)
 I X="@"!(X="") K RTE,ERTE S DRET=1,PSORXED("ROUTE",ENT)="" Q
"RTN","PSOERXD2",264,0)
 K DRET I X=$P($G(^PS(51.2,+$G(PSORXED("ROUTE",ENT)),0)),"^") S RTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),ERTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^",2) W X_" "_$G(ERTE) Q
"RTN","PSOERXD2",265,0)
 S DIC=51.2,DIC(0)="QEZM",DIC("S")="I $P(^(0),""^"",4)" D ^DIC Q:X[U  G:Y=-1 RTE2 W "  "_$P(Y(0),"^",2)
"RTN","PSOERXD2",266,0)
 ;S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2)
"RTN","PSOERXD2",267,0)
 S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2),ERXRTE(ENT)=$P(Y(0),U,3)
"RTN","PSOERXD2",268,0)
 Q
"RTN","PSOERXD2",269,0)
VDRG3(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",270,0)
 N DIR,Y,PATINST,ERXDRUG,VDRG,VAOI,FDA
"RTN","PSOERXD2",271,0)
 D DERX1(PSOIEN,PSOIENS,1)
"RTN","PSOERXD2",272,0)
 S ERXDRUG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I")
"RTN","PSOERXD2",273,0)
 S PATINST=$$GET1^DIQ(52.49,PSOIEN,27,"E")
"RTN","PSOERXD2",274,0)
 I '$L(PATINST) D
"RTN","PSOERXD2",275,0)
 .S VDRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I") Q:'VDRG
"RTN","PSOERXD2",276,0)
 .S VAOI=$$GET1^DIQ(50,VDRG,2.1,"I") Q:'VAOI
"RTN","PSOERXD2",277,0)
 .S PATINST=$$GET1^DIQ(50.7,VAOI,7,"E")
"RTN","PSOERXD2",278,0)
 K DIR
"RTN","PSOERXD2",279,0)
 S DIR(0)="52.49,27",DIR("A")="VA PATIENT INSTRUCTIONS"
"RTN","PSOERXD2",280,0)
 I $L(PATINST) S DIR("B")=PATINST
"RTN","PSOERXD2",281,0)
 D ^DIR K DIR
"RTN","PSOERXD2",282,0)
 I Y["^" S PQUIT=1 Q
"RTN","PSOERXD2",283,0)
 S FDA(52.49,PSOIEN_",",27)=$$UP^XLFSTR(Y) D FILE^DIE(,"FDA","ERR") K FDA
"RTN","PSOERXD2",284,0)
 Q
"RTN","PSOERXD2",285,0)
VDRG4(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",286,0)
 N DIR,Y,USERCOMM,VPATINST,UFLAG,VAPCOMM,ERXPCOMM,FDA
"RTN","PSOERXD2",287,0)
 ; POSSIBLE FUTURE IMPLEMENTATION OF ERX DETAILS
"RTN","PSOERXD2",288,0)
 ;D DERX1(PSOIEN,PSOIENS,1)
"RTN","PSOERXD2",289,0)
 S VPATINST=$$GET1^DIQ(52.49,PSOIEN,27,"E")
"RTN","PSOERXD2",290,0)
 S ERXPCOMM=$$GET1^DIQ(52.49,PSOIEN,8,"E")
"RTN","PSOERXD2",291,0)
 S VAPCOMM=$$GET1^DIQ(52.49,PSOIEN,30,"E")
"RTN","PSOERXD2",292,0)
 S DIR(0)="FO^1:240",DIR("A")="VA Provider Comments",DIR("B")=$S($L(VAPCOMM):VAPCOMM,1:ERXPCOMM)
"RTN","PSOERXD2",293,0)
 D ^DIR K DIR
"RTN","PSOERXD2",294,0)
 I Y["^" S PQUIT=1 Q
"RTN","PSOERXD2",295,0)
 S USERCOMM=$$UP^XLFSTR(Y) K Y
"RTN","PSOERXD2",296,0)
 S FDA(52.49,PSOIEN_",",30)=$$UP^XLFSTR(USERCOMM) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",297,0)
 Q
"RTN","PSOERXD2",298,0)
VDRG5(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",299,0)
 N PATIEN,PS55IEN,Y,DIE,DR,DA,FDA,ANS,DONE,PATSTAT
"RTN","PSOERXD2",300,0)
 S PATIEN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXD2",301,0)
 I 'PATIEN W !!,"Patient has not been validated, cannot edit patient status",! Q
"RTN","PSOERXD2",302,0)
 S PSODFN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXD2",303,0)
 S PATSTAT=$$GET1^DIQ(55,PSODFN,3,"E")
"RTN","PSOERXD2",304,0)
 S DIR("B")=PATSTAT
"RTN","PSOERXD2",305,0)
 S DIR(0)="55,3",DIR("A")="PATIENT STATUS"
"RTN","PSOERXD2",306,0)
 D ^DIR K DIR
"RTN","PSOERXD2",307,0)
 I 'PATSTAT,'+Y D
"RTN","PSOERXD2",308,0)
 .S DONE=0
"RTN","PSOERXD2",309,0)
 .F  D  Q:DONE
"RTN","PSOERXD2",310,0)
 ..W !,"This is a required response. Enter '^' to exit"
"RTN","PSOERXD2",311,0)
 ..S DIR(0)="55,3",DIR("A")="PATIENT STATUS" D ^DIR K DIR
"RTN","PSOERXD2",312,0)
 ..I +Y S DONE=1 Q
"RTN","PSOERXD2",313,0)
 ..I Y["^" S PQUIT=1,DONE=1 Q
"RTN","PSOERXD2",314,0)
 S ANS=$P(Y,"^",1)
"RTN","PSOERXD2",315,0)
 S FDA(55,PSODFN_",",3)=ANS
"RTN","PSOERXD2",316,0)
 D FILE^DIE(,"FDA","ERR") K FDA,ERR
"RTN","PSOERXD2",317,0)
 ;I $D(Y) S PQUIT=1
"RTN","PSOERXD2",318,0)
 Q
"RTN","PSOERXD2",319,0)
VDRG7(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",320,0)
 ;S DIE="^PS(52.49,",DA=PSOIEN,DR="20.1" D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",321,0)
 N DIR,PSODRG,DRGMSG,ERXQTY,VAQTY,DIE,DA,DR
"RTN","PSOERXD2",322,0)
 S PSODRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I")
"RTN","PSOERXD2",323,0)
 I PSODRG S DRGMSG=$$GET1^DIQ(50,PSODRG,215,"E")
"RTN","PSOERXD2",324,0)
 S ERXQTY=$$GET1^DIQ(52.49,PSOIEN,5.1,"E")
"RTN","PSOERXD2",325,0)
 W !,"eRx Quantity: "_ERXQTY
"RTN","PSOERXD2",326,0)
 I $P(ERXQTY,".",2)>2 S ERXQTY=""
"RTN","PSOERXD2",327,0)
 S VAQTY=$$GET1^DIQ(52.49,PSOIEN,20.1,"E")
"RTN","PSOERXD2",328,0)
 S PQUIT=$$QTYDSRFL^PSOERXU4(PSOIEN,2)
"RTN","PSOERXD2",329,0)
 Q
"RTN","PSOERXD2",330,0)
VDRG6(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",331,0)
 N Y,ERXDS,DIE,DR,DA
"RTN","PSOERXD2",332,0)
 S ERXDS=$$GET1^DIQ(52.49,PSOIEN,5.5,"E")
"RTN","PSOERXD2",333,0)
 W !,"eRx Days Supply: "_ERXDS
"RTN","PSOERXD2",334,0)
 S PQUIT=$$QTYDSRFL^PSOERXU4(PSOIEN,1)
"RTN","PSOERXD2",335,0)
 Q
"RTN","PSOERXD2",336,0)
VDRG8(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",337,0)
 N Y,ERXRFLS,DIE,DR,DA
"RTN","PSOERXD2",338,0)
 S ERXRFLS=$$GET1^DIQ(52.49,PSOIEN,5.6,"E")
"RTN","PSOERXD2",339,0)
 W !,"eRx Refills: "_ERXRFLS
"RTN","PSOERXD2",340,0)
 S PQUIT=$$QTYDSRFL^PSOERXU4(PSOIEN,3)
"RTN","PSOERXD2",341,0)
 Q
"RTN","PSOERXD2",342,0)
VDRG9(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",343,0)
 N Y,DIR,DIE,DR,DA
"RTN","PSOERXD2",344,0)
 S DIR("A")="PICKUP ROUTING"
"RTN","PSOERXD2",345,0)
 S DIR(0)="SO^M:MAIL;W:WINDOW",DIR("B")="M" D ^DIR K DIR
"RTN","PSOERXD2",346,0)
 I Y["^" S PQUIT=1 Q
"RTN","PSOERXD2",347,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="20.4///"_Y D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",348,0)
 Q
"RTN","PSOERXD2",349,0)
VDRG10(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",350,0)
 N DIC,Y,VACLIN,CURCLIN,DIE,DR,DA
"RTN","PSOERXD2",351,0)
 S CURCLIN=$$GET1^DIQ(52.49,PSOIEN,20.6,"E")
"RTN","PSOERXD2",352,0)
 I '$L(CURCLIN) S CURCLIN=$$GET1^DIQ(59,PSOSITE,10,"E")
"RTN","PSOERXD2",353,0)
 S DIC("B")=CURCLIN
"RTN","PSOERXD2",354,0)
 S DIC="^SC(",DIC(0)="QEAMZ",DIC("A")="Select CLINIC: " D ^DIC K DIC
"RTN","PSOERXD2",355,0)
 I Y<1 Q
"RTN","PSOERXD2",356,0)
 I ($D(DTOUT))!($D(DUOUT)) S PQUIT=1 Q
"RTN","PSOERXD2",357,0)
 S VACLIN=$P(Y,U)
"RTN","PSOERXD2",358,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="20.6///"_VACLIN D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",359,0)
 K DTOUT,DUOUT
"RTN","PSOERXD2",360,0)
 Q
"RTN","PSOERXD2",361,0)
VDRG11(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",362,0)
 N DIE,DR,DA,Y
"RTN","PSOERXD2",363,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="8" D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",364,0)
 I $O(Y(0)) S PQUIT=1
"RTN","PSOERXD2",365,0)
 Q
"RTN","PSOERXD2",366,0)
 ; display erx info
"RTN","PSOERXD2",367,0)
 ; DFLG - display flag
"RTN","PSOERXD2",368,0)
 ;          1 - drug sig comments
"RTN","PSOERXD2",369,0)
 ;          ""- all
"RTN","PSOERXD2",370,0)
 ;          
"RTN","PSOERXD2",371,0)
DERX1(PSOIEN,PSOIENS,DFLG) ;
"RTN","PSOERXD2",372,0)
 N EDRG,ERXDAT,ESIG,COMM,SUBS,DFORM,DSTR,QQUAL,POTUC,QTY,DAYS,REFILL,COMMARY,SIGARY
"RTN","PSOERXD2",373,0)
 D GETS^DIQ(52.49,PSOIENS,"3.1;4.6;4.8;5.1;5.2;5.4;5.5;5.6;5.8;7;8;41;42;43","E","ERXDAT")
"RTN","PSOERXD2",374,0)
 S DFLG=$G(DFLG,"")
"RTN","PSOERXD2",375,0)
 S EDRG=$G(ERXDAT(52.49,PSOIENS,3.1,"E"))
"RTN","PSOERXD2",376,0)
 S ESIG=$G(ERXDAT(52.49,PSOIENS,7,"E"))
"RTN","PSOERXD2",377,0)
 S COMM=$G(ERXDAT(52.49,PSOIENS,8,"E"))
"RTN","PSOERXD2",378,0)
 S SUBS=$G(ERXDAT(52.49,PSOIENS,5.8,"E"))
"RTN","PSOERXD2",379,0)
 S DFORM=$G(ERXDAT(52.49,PSOIENS,41,"E"))
"RTN","PSOERXD2",380,0)
 S DSTR=$G(ERXDAT(52.49,PSOIENS,43,"E"))
"RTN","PSOERXD2",381,0)
 S QQUAL=$G(ERXDAT(52.49,PSOIENS,5.2,"E"))
"RTN","PSOERXD2",382,0)
 S POTUC=$G(ERXDAT(52.49,PSOIENS,42,"E"))
"RTN","PSOERXD2",383,0)
 S QTY=$G(ERXDAT(52.49,PSOIENS,5.1,"E"))
"RTN","PSOERXD2",384,0)
 S DAYS=$G(ERXDAT(52.49,PSOIENS,5.5,"E"))
"RTN","PSOERXD2",385,0)
 S REFILL=$G(ERXDAT(52.49,PSOIENS,5.6,"E"))
"RTN","PSOERXD2",386,0)
 D TXT2ARY^PSOERXD1(.SIGARY,ESIG,,69)
"RTN","PSOERXD2",387,0)
 D TXT2ARY^PSOERXD1(.COMMARY,COMM,,65)
"RTN","PSOERXD2",388,0)
 W !!!,"eRx Drug: "_EDRG
"RTN","PSOERXD2",389,0)
 W !,"eRx Sig: "
"RTN","PSOERXD2",390,0)
 S I=0 F  S I=$O(SIGARY(I)) Q:'I  D
"RTN","PSOERXD2",391,0)
 .W $S(I>1:"         "_SIGARY(I),1:SIGARY(I)),!
"RTN","PSOERXD2",392,0)
 I '$L(ESIG) W !
"RTN","PSOERXD2",393,0)
 W "eRx Notes: "
"RTN","PSOERXD2",394,0)
 S I=0 F  S I=$O(COMMARY(I)) Q:'I  D
"RTN","PSOERXD2",395,0)
 .W $S(I>1:"              "_COMMARY(I),1:COMMARY(I)),!
"RTN","PSOERXD2",396,0)
 I '$L(COMM) W !
"RTN","PSOERXD2",397,0)
 Q:DFLG=1
"RTN","PSOERXD2",398,0)
 W "Drug Form: "_DFORM,?40,"Strength: "_DSTR
"RTN","PSOERXD2",399,0)
 W !,"Qty Qualifier: "_QQUAL,?40,"Potency Unit Code: "_POTUC
"RTN","PSOERXD2",400,0)
 W !,"DAW Code: "_SUBS
"RTN","PSOERXD2",401,0)
 W !,"Qty: "_QTY,?25,"Days Supply: "_DAYS,?55,"Refills: "_REFILL,!!
"RTN","PSOERXD2",402,0)
 Q
"RTN","PSOERXO1")
0^14^B64732722^B57309099
"RTN","PSOERXO1",1,0)
PSOERXO1 ;ALB/BWF - eRx Outbound Error messages ; 8/3/2016 5:14pm
"RTN","PSOERXO1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520**;DEC 1997;Build 52
"RTN","PSOERXO1",3,0)
 ;
"RTN","PSOERXO1",4,0)
 Q
"RTN","PSOERXO1",5,0)
 ;
"RTN","PSOERXO1",6,0)
MSGERR() ;check errors from XML return
"RTN","PSOERXO1",7,0)
 ; note - not currently in use
"RTN","PSOERXO1",8,0)
 ;returns empty string "" if there was no error
"RTN","PSOERXO1",9,0)
 ;returns empty string "" if the only error was "ALL_PATIENT_IDS_EXCLUDED"
"RTN","PSOERXO1",10,0)
 ;otherwise returns the exceptionMessage string from the errorSection
"RTN","PSOERXO1",11,0)
 N ORRET S ORRET=""
"RTN","PSOERXO1",12,0)
 I $D(^TMP($J,"ORRDI","ClinicalData",0,"errorSection")) D
"RTN","PSOERXO1",13,0)
 .N I F I="fatalErrors","errors","warnings" D
"RTN","PSOERXO1",14,0)
 ..N J S J="" F  S J=$O(^TMP($J,"ORRDI","ClinicalData",0,"errorSection",0,I,J)) Q:J=""  D
"RTN","PSOERXO1",15,0)
 ...N ORSTR S ORSTR=$G(^TMP($J,"ORRDI","ClinicalData",0,"errorSection",0,I,J,"errorCode",0))
"RTN","PSOERXO1",16,0)
 ...I ORSTR'="ALL_PATIENT_IDS_EXCLUDED" S ORRET=ORSTR
"RTN","PSOERXO1",17,0)
 Q ORRET
"RTN","PSOERXO1",18,0)
ERRHNDL(DFN) ;handle any errors that may get thrown in call to GET^ORRDI1
"RTN","PSOERXO1",19,0)
 K ^TMP($J,"ORRDI"),^XTMP("ORRDI","PSOO",DFN),^XTMP("ORRDI","ART",DFN)
"RTN","PSOERXO1",20,0)
 D UNWIND^%ZTER
"RTN","PSOERXO1",21,0)
 Q
"RTN","PSOERXO1",22,0)
POST(ERXIEN,PSSOUT,ECODE,DESCODE,DESC,RXVERIFY) ;
"RTN","PSOERXO1",23,0)
 N PSS,PSSERR,PSSFDBRT,PSREQ,INST,GBL,C,RXREFN,PON
"RTN","PSOERXO1",24,0)
 N TOQUAL,FRQUAL,TO,FROM,MID,RTMID,ERXIENS,F,PSODAT
"RTN","PSOERXO1",25,0)
 S F=52.49,C=0
"RTN","PSOERXO1",26,0)
 S PSSFDBRT=1
"RTN","PSOERXO1",27,0)
 S GBL=$NA(^TMP("POST^PSOERXO1",$J)) K @GBL
"RTN","PSOERXO1",28,0)
 Q:'$G(ERXIEN)
"RTN","PSOERXO1",29,0)
 S ERXIENS=ERXIEN_","
"RTN","PSOERXO1",30,0)
 D GETS^DIQ(F,ERXIENS,".01;.02;22.1:22.4;24.1;25","IE","PSODAT")
"RTN","PSOERXO1",31,0)
 S INST=$G(PSODAT(F,ERXIENS,24.1,"I")) I 'INST S PSSOUT(0)=-1_U_"Unable to identify institution. Cannot send message." Q
"RTN","PSOERXO1",32,0)
 ; message ID needs to be unique from vista - Site#.DUZ.erxIEN.date.time??
"RTN","PSOERXO1",33,0)
 S MID=INST_"."_DUZ_"."_ERXIEN_"."_$$NOW^XLFDT
"RTN","PSOERXO1",34,0)
 ; relates to message ID is the incoming message id from CH for outbound messages.
"RTN","PSOERXO1",35,0)
 S RTMID=$G(PSODAT(F,ERXIENS,25,"E"))
"RTN","PSOERXO1",36,0)
 ; from is TO from the erx.
"RTN","PSOERXO1",37,0)
 S FROM=$G(PSODAT(F,ERXIENS,22.3,"E"))
"RTN","PSOERXO1",38,0)
 S FRQUAL=$G(PSODAT(F,ERXIENS,22.4,"I"))
"RTN","PSOERXO1",39,0)
 ; to is FROM from the erx
"RTN","PSOERXO1",40,0)
 S TO=$G(PSODAT(F,ERXIENS,22.1,"E"))
"RTN","PSOERXO1",41,0)
 S TOQUAL=$G(PSODAT(F,ERXIENS,22.2,"I"))
"RTN","PSOERXO1",42,0)
 ; /BLB/ - BEGIN CHANGE PSO*7*520 - adding prescriber order number and rxReferencenumber (.01 in the case of verify and error)
"RTN","PSOERXO1",43,0)
 S PON=$G(PSODAT(F,ERXIENS,.09,"E"))
"RTN","PSOERXO1",44,0)
 S RXREFN=$G(PSODAT(F,ERXIENS,.01,"E"))
"RTN","PSOERXO1",45,0)
 ;
"RTN","PSOERXO1",46,0)
 D C S @GBL@(C,0)="<?xml version = '1.0' encoding = 'UTF-8'?><Message version=""010"" release=""006"" xmlns=""http://www.ncpdp.org/schema/SCRIPT"">"
"RTN","PSOERXO1",47,0)
 D C S @GBL@(C,0)="<Header><To Qualifier="""_TOQUAL_""">"_TO_"</To><From Qualifier="""_FRQUAL_""">"_FROM_"</From><MessageID>"_MID_"</MessageID>"
"RTN","PSOERXO1",48,0)
 D C S @GBL@(C,0)="<RelatesToMessageID>"_RTMID_"</RelatesToMessageID><SentTime>"_$$EXTIME()_"</SentTime>"
"RTN","PSOERXO1",49,0)
 I $L(RXREFN) D C S @GBL@(C,0)="<RxReferenceNumber>"_RXREFN_"</RxReferenceNumber>"
"RTN","PSOERXO1",50,0)
 I $L(PON) D C S @GBL@(C,0)="<PrescriberOrderNumber>"_PON_"</PrescriberOrderNumber>"
"RTN","PSOERXO1",51,0)
 D C S @GBL@(C,0)="</Header>"
"RTN","PSOERXO1",52,0)
 ; PSO*7*520 - /BLB/ - END CHANGE add handling of rxVerify Messages
"RTN","PSOERXO1",53,0)
 ; rxVerify
"RTN","PSOERXO1",54,0)
 I $G(RXVERIFY) D  Q
"RTN","PSOERXO1",55,0)
 .D C S @GBL@(C,0)="<Body><Verify><VerifyStatus><Code>010</Code><Description>Accepted By Pharmacy.</Description></VerifyStatus></Verify></Body></Message>"
"RTN","PSOERXO1",56,0)
 .D RESTPOST(.PSSOUT,.GBL)
"RTN","PSOERXO1",57,0)
 ; PSO*7*520 - end
"RTN","PSOERXO1",58,0)
 D C S @GBL@(C,0)="<Body><Error><Code>"_$G(ECODE)_"</Code>"
"RTN","PSOERXO1",59,0)
 I $L(DESCODE) D C S @GBL@(C,0)="<DescriptionCode>"_$G(DESCODE)_"</DescriptionCode>"
"RTN","PSOERXO1",60,0)
 D C S @GBL@(C,0)="<Description>"_$G(DESC)_"</Description>"
"RTN","PSOERXO1",61,0)
 D C S @GBL@(C,0)="</Error></Body></Message>"
"RTN","PSOERXO1",62,0)
 D RESTPOST(.PSSOUT,.GBL)
"RTN","PSOERXO1",63,0)
 K @GBL,C
"RTN","PSOERXO1",64,0)
 Q
"RTN","PSOERXO1",65,0)
C ;
"RTN","PSOERXO1",66,0)
 S C=C+1
"RTN","PSOERXO1",67,0)
 Q
"RTN","PSOERXO1",68,0)
RESTPOST(PSSOUT,GBL) ;
"RTN","PSOERXO1",69,0)
 N $ETRAP,$ESTACK,PSREQ
"RTN","PSOERXO1",70,0)
 N PSREQ,PSS,PSSERR,GLOOP,GDAT
"RTN","PSOERXO1",71,0)
 ; Set error trap
"RTN","PSOERXO1",72,0)
 SET $ETRAP="DO ERROR^PSSHTTP"
"RTN","PSOERXO1",73,0)
 K ^TMP($J,"OUT")    ; if exists from previous runs, posting would not execute.
"RTN","PSOERXO1",74,0)
 SET PSS("server")="PSO WEB SERVER"
"RTN","PSOERXO1",75,0)
 SET PSS("webserviceName")="PSO ERX WEB SERVICE"
"RTN","PSOERXO1",76,0)
 SET PSS("path")="services/rest/vistaoutboundMsg/processXMLMessage"
"RTN","PSOERXO1",77,0)
 SET PSS("parameterName")="xmlRequest"
"RTN","PSOERXO1",78,0)
 ;SET PSS("parameterValue")=PSREQ
"RTN","PSOERXO1",79,0)
 ;
"RTN","PSOERXO1",80,0)
 ; get instance of client REST request object
"RTN","PSOERXO1",81,0)
 SET PSS("restObject")=$$GETREST^XOBWLIB(PSS("webserviceName"),PSS("server"))
"RTN","PSOERXO1",82,0)
 IF $DATA(^TMP($JOB,"OUT","EXCEPTION"))>0 S PSSOUT(0)="-1^"_^TMP($JOB,"OUT","EXCEPTION") K ^TMP($JOB,"OUT","EXCEPTION") Q PSSOUT
"RTN","PSOERXO1",83,0)
 ;
"RTN","PSOERXO1",84,0)
 ; insert XML as parameter
"RTN","PSOERXO1",85,0)
 ;DO PSS("restObject").InsertFormData(PSS("parameterName"),PSS("parameterValue"))
"RTN","PSOERXO1",86,0)
 S PSS("restObject").ContentType="application/xml"
"RTN","PSOERXO1",87,0)
 S GLOOP=0 F  S GLOOP=$O(@GBL@(GLOOP)) Q:'GLOOP  D
"RTN","PSOERXO1",88,0)
 .S GDAT=$G(@GBL@(GLOOP,0))
"RTN","PSOERXO1",89,0)
 .;SET PSS("parameterValue")=$G(PSS("parameterValue"))_$G(@GBL@(GLOOP,0))
"RTN","PSOERXO1",90,0)
 .DO PSS("restObject").EntityBody.Write(GDAT)
"RTN","PSOERXO1",91,0)
 ;DO PSS("restObject").InsertFormData(PSS("parameterName"),PSS("parameterValue"))
"RTN","PSOERXO1",92,0)
 IF $DATA(^TMP($JOB,"OUT","EXCEPTION"))>0 S PSSOUT(0)="-1^"_^TMP($JOB,"OUT","EXCEPTION") K ^TMP($JOB,"OUT","EXCEPTION") QUIT PSSOUT
"RTN","PSOERXO1",93,0)
 ;
"RTN","PSOERXO1",94,0)
 ; execute HTTP Post method
"RTN","PSOERXO1",95,0)
 SET PSS("postResult")=$$POST^XOBWLIB(PSS("restObject"),PSS("path"),.PSSERR)
"RTN","PSOERXO1",96,0)
 IF $DATA(^TMP($JOB,"OUT","EXCEPTION"))>0 S PSSOUT(0)="-1^"_^TMP($JOB,"OUT","EXCEPTION") K ^TMP($JOB,"OUT","EXCEPTION") QUIT PSSOUT
"RTN","PSOERXO1",97,0)
 ;
"RTN","PSOERXO1",98,0)
 ; response coming back
"RTN","PSOERXO1",99,0)
 ;<vistaOutboundResponse><success>true</success></vistaOutboundResponse>
"RTN","PSOERXO1",100,0)
 ; error handling
"RTN","PSOERXO1",101,0)
 DO:'PSS("postResult")
"RTN","PSOERXO1",102,0)
 . SET PSSOUT(0)=-1_U_"Unable to make http request."
"RTN","PSOERXO1",103,0)
 . SET PSS("result")=0
"RTN","PSOERXO1",104,0)
 . QUIT
"RTN","PSOERXO1",105,0)
 ;
"RTN","PSOERXO1",106,0)
 ; if everything is ok parse the returned xml result
"RTN","PSOERXO1",107,0)
 I PSS("postResult") S PSS("result")=1 D PRSSTRM(PSS("restObject"),.PSSOUT) S PSSOUT(0)=1
"RTN","PSOERXO1",108,0)
 ; for now we do not pass back the message ID for storage into 52.49
"RTN","PSOERXO1",109,0)
 Q PSS("result")
"RTN","PSOERXO1",110,0)
 ;
"RTN","PSOERXO1",111,0)
PRSSTRM(RESTOBJ,PSSOUT) ;  parse the XML into token
"RTN","PSOERXO1",112,0)
 ;  input: RESTOBJ--a rest object
"RTN","PSOERXO1",113,0)
 ; output: PSSOUT - array containing the list of route names for the given drug.
"RTN","PSOERXO1",114,0)
 ;
"RTN","PSOERXO1",115,0)
 ; parse the XML into tokens. the first part of the token is the type of node being read.
"RTN","PSOERXO1",116,0)
 ; the second part is the data--either the name of the node, or data. these fields are delimited using "<>".
"RTN","PSOERXO1",117,0)
 ; if the node is type attribute, each attribute is separated by a caret ("^").
"RTN","PSOERXO1",118,0)
 ;
"RTN","PSOERXO1",119,0)
 N AREADER
"RTN","PSOERXO1",120,0)
 S AREADER=$$GETREADR(RESTOBJ)
"RTN","PSOERXO1",121,0)
 D PARSXML(AREADER,.PSSOUT)
"RTN","PSOERXO1",122,0)
 Q
"RTN","PSOERXO1",123,0)
 ;
"RTN","PSOERXO1",124,0)
PARSXML(AREADER,PSSOUT) ; extract the list of routes from XML results
"RTN","PSOERXO1",125,0)
 ;  input: AREADER-%XML.TextReader object.
"RTN","PSOERXO1",126,0)
 ; output: PSSOUT - array containing the list of route names for the given drug.
"RTN","PSOERXO1",127,0)
 ;
"RTN","PSOERXO1",128,0)
 N ATOKEN,NODETYPE
"RTN","PSOERXO1",129,0)
 F  D  Q:AREADER.EOF
"RTN","PSOERXO1",130,0)
 .S ATOKEN=$$GETTOKEN(AREADER)
"RTN","PSOERXO1",131,0)
 .I '$L(ATOKEN) Q
"RTN","PSOERXO1",132,0)
 .S NODETYPE=$P(ATOKEN,"<>"),ATOKEN=$P(ATOKEN,"<>",2)
"RTN","PSOERXO1",133,0)
 .I ATOKEN="errorMessage" D POSTERR(AREADER,.PSSOUT)
"RTN","PSOERXO1",134,0)
 .I ATOKEN="success" D POSTRES(AREADER,.PSSOUT)
"RTN","PSOERXO1",135,0)
 Q
"RTN","PSOERXO1",136,0)
 ;
"RTN","PSOERXO1",137,0)
POSTRES(AREADER,PSSOUT) ; get value of success/failure
"RTN","PSOERXO1",138,0)
 N TOKEN,TYPE
"RTN","PSOERXO1",139,0)
 F  D  Q:TOKEN="/success"
"RTN","PSOERXO1",140,0)
 .S TOKEN=$$GETTOKEN(AREADER)
"RTN","PSOERXO1",141,0)
 .S TYPE=$P(TOKEN,"<>"),TOKEN=$P(TOKEN,"<>",2)
"RTN","PSOERXO1",142,0)
 .Q:'$L(TOKEN)!(TOKEN="/success")
"RTN","PSOERXO1",143,0)
 .S PSSOUT("success")=TOKEN
"RTN","PSOERXO1",144,0)
 Q
"RTN","PSOERXO1",145,0)
POSTERR(AREADER,PSSOUT) ; get error message
"RTN","PSOERXO1",146,0)
 N TOKEN,TYPE
"RTN","PSOERXO1",147,0)
 F  D  Q:TOKEN="/errorMessage"
"RTN","PSOERXO1",148,0)
 .S TOKEN=$$GETTOKEN(AREADER)
"RTN","PSOERXO1",149,0)
 .S TYPE=$P(TOKEN,"<>"),TOKEN=$P(TOKEN,"<>",2)
"RTN","PSOERXO1",150,0)
 .Q:'$L(TOKEN)!(TOKEN="/errorMessage")
"RTN","PSOERXO1",151,0)
 .S PSSOUT("errorMessage")=$TR(TOKEN,$C(10)," ")
"RTN","PSOERXO1",152,0)
 Q
"RTN","PSOERXO1",153,0)
 ;
"RTN","PSOERXO1",154,0)
GETREADR(RESTOBJ) ; set up and return a Textreader object to be used to parse the XML stream
"RTN","PSOERXO1",155,0)
 ;  input: RESTOBJ-  REST object
"RTN","PSOERXO1",156,0)
 ; output: returns a %XML.TextReader object.
"RTN","PSOERXO1",157,0)
 ;
"RTN","PSOERXO1",158,0)
 N AREADER
"RTN","PSOERXO1",159,0)
 S AREADER=##class(%XML.TextReader).%New("%XML.TextReader")
"RTN","PSOERXO1",160,0)
 D ##class(%XML.TextReader).ParseStream(RESTOBJ.HttpResponse.Data,.AREADER)
"RTN","PSOERXO1",161,0)
 Q AREADER
"RTN","PSOERXO1",162,0)
 ;
"RTN","PSOERXO1",163,0)
GETTOKEN(READER) ; get a token at a time
"RTN","PSOERXO1",164,0)
 ;  input: AREADER-%XML.TextReader object
"RTN","PSOERXO1",165,0)
 ; Output: returns a token
"RTN","PSOERXO1",166,0)
 ;
"RTN","PSOERXO1",167,0)
 ;   this is the key to the parsing of the XML stream.
"RTN","PSOERXO1",168,0)
 ;   each element is parsed with its associated data (if any)
"RTN","PSOERXO1",169,0)
 ;   the nodetype is concatenated with "<>" with the Token
"RTN","PSOERXO1",170,0)
 ;   which can be the tag or the data.
"RTN","PSOERXO1",171,0)
 ;   for example each time is called return one of the following:
"RTN","PSOERXO1",172,0)
 ;     . . .
"RTN","PSOERXO1",173,0)
 ;     . . .
"RTN","PSOERXO1",174,0)
 ;     drug(attributes)<>gcnSeqNo=17240
"RTN","PSOERXO1",175,0)
 ;     element<>routes
"RTN","PSOERXO1",176,0)
 ;     element<>route
"RTN","PSOERXO1",177,0)
 ;     element<>id
"RTN","PSOERXO1",178,0)
 ;     chars<>006
"RTN","PSOERXO1",179,0)
 ;     endelement<>/id
"RTN","PSOERXO1",180,0)
 ;     element<>name
"RTN","PSOERXO1",181,0)
 ;     chars<>CONTINUOUS INFUSION
"RTN","PSOERXO1",182,0)
 ;     endelement<>/name
"RTN","PSOERXO1",183,0)
 ;     endelement<>/route
"RTN","PSOERXO1",184,0)
 ;     . . .
"RTN","PSOERXO1",185,0)
 ;     . . .
"RTN","PSOERXO1",186,0)
 ;
"RTN","PSOERXO1",187,0)
 N TOKEN,NODETYPE,SUBTOKEN,ALLTOKEN
"RTN","PSOERXO1",188,0)
 S TOKEN="",SUBTOKEN="",NODETYPE="",ALLTOKEN=""
"RTN","PSOERXO1",189,0)
 D
"RTN","PSOERXO1",190,0)
 .Q:READER.EOF
"RTN","PSOERXO1",191,0)
 .D READER.Read()  ; go to first node
"RTN","PSOERXO1",192,0)
 .Q:READER.EOF     ; try before and after read
"RTN","PSOERXO1",193,0)
 .;W !,READER.NodeTypeGet()
"RTN","PSOERXO1",194,0)
 .;S NODETYPE=READER.NodeTypeGet()
"RTN","PSOERXO1",195,0)
 .I READER.HasAttributes D
"RTN","PSOERXO1",196,0)
 ..S NODETYPE=READER.Name_"(attributes)"
"RTN","PSOERXO1",197,0)
 ..S TOKEN=$$GETATTS(READER)
"RTN","PSOERXO1",198,0)
 .I '$L(TOKEN) S NODETYPE=READER.NodeTypeGet() D
"RTN","PSOERXO1",199,0)
 ..I NODETYPE="element" S TOKEN=READER.Name Q
"RTN","PSOERXO1",200,0)
 ..I NODETYPE="chars" S TOKEN=READER.Value Q
"RTN","PSOERXO1",201,0)
 ..I NODETYPE="endelement" S TOKEN="/"_READER.Name Q
"RTN","PSOERXO1",202,0)
 ..I NODETYPE="comment" S TOKEN="^"
"RTN","PSOERXO1",203,0)
 ..I NODETYPE="processinginstruction" S TOKEN=READER.Value Q
"RTN","PSOERXO1",204,0)
 ..I NODETYPE="ignorablewhitespace" S TOKEN="^" Q
"RTN","PSOERXO1",205,0)
 ..I NODETYPE="startprefixmapping" S TOKEN=READER.Value Q
"RTN","PSOERXO1",206,0)
 ..I NODETYPE="warning" S TOKEN=READER.Value Q
"RTN","PSOERXO1",207,0)
 ..I '$L(TOKEN) S TOKEN="^"
"RTN","PSOERXO1",208,0)
 ..;
"RTN","PSOERXO1",209,0)
 .I $L(NODETYPE) S ALLTOKEN=NODETYPE_"<>"_TOKEN
"RTN","PSOERXO1",210,0)
 ;W !,"TOKEN="_ALLTOKEN
"RTN","PSOERXO1",211,0)
 Q ALLTOKEN
"RTN","PSOERXO1",212,0)
 ;
"RTN","PSOERXO1",213,0)
GETATTS(AREADER) ; get attributes
"RTN","PSOERXO1",214,0)
 ;  input: AREADER-%XML.TextReader object
"RTN","PSOERXO1",215,0)
 ; Output: returns the attributes
"RTN","PSOERXO1",216,0)
 ;
"RTN","PSOERXO1",217,0)
 N I,INDEX,TOKEN,SUBTOKEN,ATTRB
"RTN","PSOERXO1",218,0)
 S (TOKEN,SUBTOKEN)=""
"RTN","PSOERXO1",219,0)
 S INDEX=AREADER.AttributeCountGet()
"RTN","PSOERXO1",220,0)
 FOR I=1:1:INDEX D
"RTN","PSOERXO1",221,0)
 .S ATTRB=AREADER.MoveToAttributeIndex(I) D
"RTN","PSOERXO1",222,0)
 .S SUBTOKEN=AREADER.Name_"="_AREADER.Value
"RTN","PSOERXO1",223,0)
 .I '$L(TOKEN) S TOKEN=SUBTOKEN Q
"RTN","PSOERXO1",224,0)
 .S TOKEN=TOKEN_"^"_SUBTOKEN
"RTN","PSOERXO1",225,0)
 ;W !,"  ATT=",TOKEN
"RTN","PSOERXO1",226,0)
 Q TOKEN
"RTN","PSOERXO1",227,0)
EXTIME(IDTTM) ;
"RTN","PSOERXO1",228,0)
 N YY,MM,DD,TIME,EXDT,TLEN,I,TZONE,DTTM
"RTN","PSOERXO1",229,0)
 S IDTTM=$G(IDTTM,"")
"RTN","PSOERXO1",230,0)
 S DTTM=$S($L(IDTTM):$$FMTHL7^XLFDT(IDTTM),1:$$FMTHL7^XLFDT($$NOW^XLFDT()))
"RTN","PSOERXO1",231,0)
 S TZONE=$P(DTTM,"-",2)
"RTN","PSOERXO1",232,0)
 I 'TZONE S TZONE=$P($$FMTHL7^XLFDT($$NOW^XLFDT()),"-",2)
"RTN","PSOERXO1",233,0)
 S DTTM=$P(DTTM,"-"),TZONE=$E(TZONE,1,2)_":"_$E(TZONE,3,4)
"RTN","PSOERXO1",234,0)
 S YY=$E(DTTM,1,4),MM=$E(DTTM,5,6),DD=$E(DTTM,7,8),TIME=$E(DTTM,9,$L(DTTM))
"RTN","PSOERXO1",235,0)
 I $L(TIME)<6 D
"RTN","PSOERXO1",236,0)
 .S TLEN=$L(TIME)
"RTN","PSOERXO1",237,0)
 .F I=TLEN:1:6 D
"RTN","PSOERXO1",238,0)
 ..S TIME=TIME_0
"RTN","PSOERXO1",239,0)
 ; now construct the date
"RTN","PSOERXO1",240,0)
 S EXDT=YY_"-"_MM_"-"_DD_"T"_$E(TIME,1,2)_":"_$E(TIME,3,4)_":"_$E(TIME,5,6)_$S($L(TZONE):"-"_TZONE,1:"")
"RTN","PSOERXO1",241,0)
 Q EXDT
"RTN","PSOERXP1")
0^4^B27447625^B23837983
"RTN","PSOERXP1",1,0)
PSOERXP1 ;ALB/BWF - eRx Patient Display/Actions ; 8/3/2016 5:14pm
"RTN","PSOERXP1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520**;DEC 1997;Build 52
"RTN","PSOERXP1",3,0)
 ;
"RTN","PSOERXP1",4,0)
EN ; -- main entry point for PSO ERX HOLDING QUEUE
"RTN","PSOERXP1",5,0)
 D EN^VALM("PSO ERX PATIENT VALIDATION")
"RTN","PSOERXP1",6,0)
 Q
"RTN","PSOERXP1",7,0)
 ;
"RTN","PSOERXP1",8,0)
HDR ; -- header code
"RTN","PSOERXP1",9,0)
 S VALMHDR(1)="eRx Patient: "_$$GET1^DIQ(52.49,PSOIEN,.04,"E")
"RTN","PSOERXP1",10,0)
 S VALMHDR(2)="eRx Reference #: "_$$GET1^DIQ(52.49,PSOIEN,.01,"E")
"RTN","PSOERXP1",11,0)
 I $G(VALMBCK)="R" K @VALMAR D INIT S VALMBCK=""
"RTN","PSOERXP1",12,0)
 Q
"RTN","PSOERXP1",13,0)
 ;
"RTN","PSOERXP1",14,0)
INIT ;
"RTN","PSOERXP1",15,0)
 Q:'$G(PSOIEN)
"RTN","PSOERXP1",16,0)
 N LINE,PATDAT,EXPIEN,EXPIENS,EXPNM,EXPDOB,EXPSSN,EXPADD,EXPGEN,EXPCTY,EXPST,EXPZIP,HFIEN,EXPHPH,CPIEN,EXPCPH,LINETXT
"RTN","PSOERXP1",17,0)
 N MANVAL,VAPATIEN,SEPLN,COMM,COMLINE,DONE,TEXT,VAEL,VAELIEN,VAELIG,VAELNM,WORD,VALBY,VALDTTM
"RTN","PSOERXP1",18,0)
 S LINE=0,LINETXT=""
"RTN","PSOERXP1",19,0)
 S EXPIEN=$$GET1^DIQ(52.49,PSOIEN,.04,"I")
"RTN","PSOERXP1",20,0)
 S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.13,"I")
"RTN","PSOERXP1",21,0)
 S EXPIENS=EXPIEN_","
"RTN","PSOERXP1",22,0)
 D GETS^DIQ(52.46,EXPIENS,"**","E","PATDAT")
"RTN","PSOERXP1",23,0)
 S EXPNM=$G(PATDAT(52.46,EXPIENS,.01,"E"))
"RTN","PSOERXP1",24,0)
 S EXPDOB=$G(PATDAT(52.46,EXPIENS,.08,"E"))
"RTN","PSOERXP1",25,0)
 S EXPSSN=$G(PATDAT(52.46,EXPIENS,1.4,"E")) I EXPSSN S EXPSSN=$E(EXPSSN,1,3)_"-"_$E(EXPSSN,4,5)_"-"_$E(EXPSSN,6,9)
"RTN","PSOERXP1",26,0)
 S EXPADD=$G(PATDAT(52.46,EXPIENS,3.1,"E"))
"RTN","PSOERXP1",27,0)
 S EXPGEN=$G(PATDAT(52.46,EXPIENS,.07,"E"))
"RTN","PSOERXP1",28,0)
 S EXPCTY=$G(PATDAT(52.46,EXPIENS,3.3,"E"))
"RTN","PSOERXP1",29,0)
 S EXPST=$G(PATDAT(52.46,EXPIENS,3.4,"E"))
"RTN","PSOERXP1",30,0)
 S EXPZIP=$G(PATDAT(52.46,EXPIENS,3.5,"E")),EXPZIP=$E(EXPZIP,1,5)
"RTN","PSOERXP1",31,0)
 S HFIEN=$O(^PS(52.46,EXPIEN,3,"C","HP",0))
"RTN","PSOERXP1",32,0)
 ; home phone
"RTN","PSOERXP1",33,0)
 S EXPHPH=$$GET1^DIQ(52.462,HFIEN_","_EXPIENS,.01,"E")
"RTN","PSOERXP1",34,0)
 ; cellular phone
"RTN","PSOERXP1",35,0)
 S CPIEN=$O(^PS(52.46,EXPIEN,3,"C","CP",0))
"RTN","PSOERXP1",36,0)
 S EXPCPH=$$GET1^DIQ(52.462,CPIEN_","_EXPIENS,.01,"E")
"RTN","PSOERXP1",37,0)
 S LINE=LINE+1,LINETXT=""
"RTN","PSOERXP1",38,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXP1",39,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Patient: ",$E(EXPNM,1,39),1,52)
"RTN","PSOERXP1",40,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",EXPDOB,55,72)
"RTN","PSOERXP1",41,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",42,0)
 I $L(EXPNM)>39 D
"RTN","PSOERXP1",43,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"             "_$E(EXPNM,40,78))
"RTN","PSOERXP1",44,0)
 I $L(EXPNM)>78 D
"RTN","PSOERXP1",45,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"             "_$E(EXPNM,79,135))
"RTN","PSOERXP1",46,0)
 S LINE=LINE+1
"RTN","PSOERXP1",47,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",48,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXP1",49,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Sex: ",EXPGEN,1,15)
"RTN","PSOERXP1",50,0)
 D ADDITEM^PSOERX1A(.LINETXT,"SSN: ",EXPSSN,55,65)
"RTN","PSOERXP1",51,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",52,0)
 S LINE=LINE+1
"RTN","PSOERXP1",53,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Addr: ",$E(EXPADD,1,40),1,50)
"RTN","PSOERXP1",54,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",55,0)
 S LINE=LINE+1
"RTN","PSOERXP1",56,0)
 ;/BLB/ PSO*7.0*520 MOVED CITY TO ITS OWN LINE - BEGIN CHANGE
"RTN","PSOERXP1",57,0)
 D ADDITEM^PSOERX1A(.LINETXT,"City: ",$E(EXPCTY,1,35),1,45)
"RTN","PSOERXP1",58,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",59,0)
 S LINE=LINE+1
"RTN","PSOERXP1",60,0)
 D ADDITEM^PSOERX1A(.LINETXT,"St: ",$E(EXPST,1,35),1,45)
"RTN","PSOERXP1",61,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Zip: ",EXPZIP,65,75)
"RTN","PSOERXP1",62,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXP1",63,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",64,0)
 S LINE=LINE+1
"RTN","PSOERXP1",65,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Home Phone: ",EXPHPH,1,25)
"RTN","PSOERXP1",66,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Cell Phone: ",EXPCPH,30,25)
"RTN","PSOERXP1",67,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",68,0)
 S COMM=$$GET1^DIQ(52.49,PSOIEN,8,"E"),COMM="Comments: "_COMM
"RTN","PSOERXP1",69,0)
 S COMLINE="",DONE=0
"RTN","PSOERXP1",70,0)
 I $L(COMM)<80!$L(COMM)=80 D SET^VALM10(LINE,COMM)
"RTN","PSOERXP1",71,0)
 I $L(COMM)>80 D
"RTN","PSOERXP1",72,0)
 .F WORD=1:1:$L(COMM," ") D
"RTN","PSOERXP1",73,0)
 ..S TEXT=$P(COMM," ",WORD)
"RTN","PSOERXP1",74,0)
 ..; if the text is to long, quit
"RTN","PSOERXP1",75,0)
 ..I $L(COMLINE)+$L(TEXT)>80 D  Q
"RTN","PSOERXP1",76,0)
 ...S LINE=LINE+1 D SET^VALM10(LINE,COMLINE)
"RTN","PSOERXP1",77,0)
 ...S COMLINE=TEXT
"RTN","PSOERXP1",78,0)
 ..I '$L(COMLINE) S COMLINE=TEXT Q
"RTN","PSOERXP1",79,0)
 ..S COMLINE=$G(COMLINE)_" "_TEXT
"RTN","PSOERXP1",80,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXP1",81,0)
 ;S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXP1",82,0)
 S $P(SEPLN,"-",80)="-" D SET^VALM10(LINE,SEPLN)
"RTN","PSOERXP1",83,0)
 ; vista patient information
"RTN","PSOERXP1",84,0)
 S VAPATIEN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXP1",85,0)
 I VAPATIEN D
"RTN","PSOERXP1",86,0)
 .S DFN=VAPATIEN D DEM^VADPT,ADD^VADPT,ELIG^VADPT
"RTN","PSOERXP1",87,0)
 .S VAELIG=$G(VAEL(1)),VAELIEN=$P(VAELIG,U),VAELNM=$P(VAELIG,U,2)
"RTN","PSOERXP1",88,0)
 S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.7,"I")
"RTN","PSOERXP1",89,0)
 S VALBY=$$GET1^DIQ(52.49,PSOIEN,1.13,"E")
"RTN","PSOERXP1",90,0)
 S VALDTTM=$$GET1^DIQ(52.49,PSOIEN,1.14,"E")
"RTN","PSOERXP1",91,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Status: "_$S(MANVAL:"VALIDATED ("_VALBY_" - "_VALDTTM_")",1:"NOT VALIDATED"))
"RTN","PSOERXP1",92,0)
 I 'VAPATIEN S LINE=LINE+1 D SET^VALM10(LINE,"PATIENT NOT MATCHED")
"RTN","PSOERXP1",93,0)
 I VAPATIEN D
"RTN","PSOERXP1",94,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",95,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Vista Patient: ",$G(VADM(1)),1,53)
"RTN","PSOERXP1",96,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",$P($G(VADM(3)),U,2),55,20)
"RTN","PSOERXP1",97,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",98,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",99,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Sex: ",$P($G(VADM(5)),U,2),1,20)
"RTN","PSOERXP1",100,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"SSN: ",$P($G(VADM(2)),U,2),55,20)
"RTN","PSOERXP1",101,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",102,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",103,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Addr: ",$P($G(VAPA(1)),U),1,70)
"RTN","PSOERXP1",104,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",105,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",106,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"City: ",$P($G(VAPA(4)),U),1,25)
"RTN","PSOERXP1",107,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"St: ",$P(VAPA(5),U,2),35,20)
"RTN","PSOERXP1",108,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Zip: ",$P($G(VAPA(6)),U),65,10)
"RTN","PSOERXP1",109,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",110,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",111,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Home Phone: ",$P($G(VAPA(8)),U),1,25)
"RTN","PSOERXP1",112,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Cell Phone: ",$$GET1^DIQ(2,VAPATIEN,.134,"E"),40,25)
"RTN","PSOERXP1",113,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",114,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXP1",115,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Eligibility: "_$G(VAELNM))
"RTN","PSOERXP1",116,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Pharmacy Narrative: "_$$GET1^DIQ(55,VAPATIEN,1,"E"))
"RTN","PSOERXP1",117,0)
 .I $$GET1^DIQ(52.49,PSOIEN,.05,"I") D
"RTN","PSOERXP1",118,0)
 ..D ALG^PSOERXU1(.LINE)
"RTN","PSOERXP1",119,0)
 S VALMCNT=LINE
"RTN","PSOERXP1",120,0)
 S EDTYP="P"
"RTN","PSOERXP1",121,0)
 K VAPA,VADM,DFN,VA
"RTN","PSOERXP1",122,0)
 Q
"RTN","PSOERXP1",123,0)
HELP ; -- help code
"RTN","PSOERXP1",124,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERXP1",125,0)
 Q
"RTN","PSOERXP1",126,0)
 ;
"RTN","PSOERXP1",127,0)
EXIT ; -- exit code
"RTN","PSOERXP1",128,0)
 K EDTYP,@VALMAR
"RTN","PSOERXP1",129,0)
 Q
"RTN","PSOERXP1",130,0)
 ;
"RTN","PSOERXP1",131,0)
EXPND ; -- expand code
"RTN","PSOERXP1",132,0)
 Q
"RTN","PSOERXR1")
0^5^B31327096^B24483319
"RTN","PSOERXR1",1,0)
PSOERXR1 ;ALB/BWF - eRx Provider Display/actions ; 8/3/2016 5:14pm
"RTN","PSOERXR1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520**;DEC 1997;Build 52
"RTN","PSOERXR1",3,0)
 ;
"RTN","PSOERXR1",4,0)
EN ; -- main entry point for PSO ERX HOLDING QUEUE
"RTN","PSOERXR1",5,0)
 D EN^VALM("PSO ERX PROVIDER VALIDATION")
"RTN","PSOERXR1",6,0)
 Q
"RTN","PSOERXR1",7,0)
 ;
"RTN","PSOERXR1",8,0)
HDR ; -- header code
"RTN","PSOERXR1",9,0)
 ;S VALMHDR(1)="eRx Processing"
"RTN","PSOERXR1",10,0)
 S VALMHDR(1)="eRx Patient: "_$$GET1^DIQ(52.49,PSOIEN,.04,"E")
"RTN","PSOERXR1",11,0)
 S VALMHDR(2)="eRx Reference #: "_$$GET1^DIQ(52.49,PSOIEN,.01,"E")
"RTN","PSOERXR1",12,0)
 I $G(VALMBCK)="R" D INIT
"RTN","PSOERXR1",13,0)
 Q
"RTN","PSOERXR1",14,0)
 ;
"RTN","PSOERXR1",15,0)
INIT ;
"RTN","PSOERXR1",16,0)
 Q:'$G(PSOIEN)
"RTN","PSOERXR1",17,0)
 N LINE,PARVDAT,EXPIEN,EXPIENS,EXPNM,EXPDOB,EXPSSN,EXPADD,EXPGEN,EXPCTY,EXPST,EXPZIP,HFIEN,EXPHPH,CPIEN,EXPCPH,LINETXT
"RTN","PSOERXR1",18,0)
 N EXPADD1,EXPADD2,EXPAGNT,EXPDEA,EXPFN,EXPLIC,EXPNPI,EXPSUPER,EXPWPH,FNIEN,MANVAL,PRVDAT,VAPADD1,VAPADD2,VAPCIT,DEAEXP
"RTN","PSOERXR1",19,0)
 N VAPDEA,VAPFAX,VAPIENS,VAPLIC,VAPNM,VAPNPI,VAPROV,VAPRVIEN,VAPST,VAPTEL,VAPZIP,WPIEN,SEPLN,VAPDEAEX,VALBY,VALDTTM,NFIRST
"RTN","PSOERXR1",20,0)
 N NLOOP,AGENTARY,TLOOP,TFIRST,SUPERARY,SIEN,TYPE,VALUE,PRFAX,PRTEL,IENS
"RTN","PSOERXR1",21,0)
 S LINE=0,LINETXT=""
"RTN","PSOERXR1",22,0)
 S EXPIEN=$$GET1^DIQ(52.49,PSOIEN,2.1,"I")
"RTN","PSOERXR1",23,0)
 S EXPIENS=EXPIEN_","
"RTN","PSOERXR1",24,0)
 D GETS^DIQ(52.48,EXPIENS,"**","E","PRVDAT")
"RTN","PSOERXR1",25,0)
 S EXPNM=$G(PRVDAT(52.48,EXPIENS,.01,"E"))
"RTN","PSOERXR1",26,0)
 S EXPNPI=$G(PRVDAT(52.48,EXPIENS,1.5,"E"))
"RTN","PSOERXR1",27,0)
 S EXPDEA=$G(PRVDAT(52.48,EXPIENS,1.6,"E"))
"RTN","PSOERXR1",28,0)
 S EXPLIC=$G(PRVDAT(52.48,EXPIENS,1.8,"E"))
"RTN","PSOERXR1",29,0)
 S EXPAGNT=$G(PRVDAT(52.48,EXPIENS,5.1,"E")) I $L(EXPAGNT) S EXPAGNT=EXPAGNT_", "_$G(PRVDAT(52.48,EXPIENS,5.2,"E"))_" "_$G(PRVDAT(52.48,EXPIENS,5.3,"E"))
"RTN","PSOERXR1",30,0)
 S EXPSUPER=$$GET1^DIQ(52.49,PSOIEN,2.6,"E")
"RTN","PSOERXR1",31,0)
 S EXPADD1=$G(PRVDAT(52.48,EXPIENS,4.1,"E"))
"RTN","PSOERXR1",32,0)
 S EXPADD2=$G(PRVDAT(52.48,EXPIENS,4.2,"E"))
"RTN","PSOERXR1",33,0)
 S EXPCTY=$G(PRVDAT(52.48,EXPIENS,4.3,"E"))
"RTN","PSOERXR1",34,0)
 S EXPST=$G(PRVDAT(52.48,EXPIENS,4.4,"E"))
"RTN","PSOERXR1",35,0)
 S EXPZIP=$G(PRVDAT(52.48,EXPIENS,4.5,"E")),EXPZIP=$E(EXPZIP,1,5)
"RTN","PSOERXR1",36,0)
 S WPIEN=$O(^PS(52.48,EXPIEN,3,"C","WP",0))
"RTN","PSOERXR1",37,0)
 ; home phone
"RTN","PSOERXR1",38,0)
 ; fax number
"RTN","PSOERXR1",39,0)
 S SIEN=0
"RTN","PSOERXR1",40,0)
 F  S SIEN=$O(^PS(52.48,EXPIEN,3,SIEN)) Q:'SIEN  D
"RTN","PSOERXR1",41,0)
 .S IENS=SIEN_","_EXPIEN_","
"RTN","PSOERXR1",42,0)
 .S TYPE=$$GET1^DIQ(52.483,IENS,.02)
"RTN","PSOERXR1",43,0)
 .S VALUE=$$GET1^DIQ(52.483,IENS,.01)
"RTN","PSOERXR1",44,0)
 .I TYPE="FAX" S PRFAX=VALUE
"RTN","PSOERXR1",45,0)
 .I TYPE="TELEPHONE" S PRTEL=VALUE
"RTN","PSOERXR1",46,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"eRx Provider: "_$E(EXPNM,1,50))
"RTN","PSOERXR1",47,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Address: "_$E(EXPADD1,1,50))
"RTN","PSOERXR1",48,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"         "_$E(EXPADD2,1,50))
"RTN","PSOERXR1",49,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"         "_EXPCTY_", "_EXPST_" "_EXPZIP)
"RTN","PSOERXR1",50,0)
 S LINE=LINE+1
"RTN","PSOERXR1",51,0)
 ;/BLB/ PSO*7.0*520 moved NPI and DEA to own line - BEGIN CHANGE
"RTN","PSOERXR1",52,0)
 D ADDITEM^PSOERX1A(.LINETXT,"NPI: ",EXPNPI,1,40)
"RTN","PSOERXR1",53,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXR1",54,0)
 S LINE=LINE+1
"RTN","PSOERXR1",55,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DEA: ",EXPDEA,1,40)
"RTN","PSOERXR1",56,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXR1",57,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXR1",58,0)
 S LINE=LINE+1
"RTN","PSOERXR1",59,0)
 D ADDITEM^PSOERX1A(.LINETXT,"State Lic: ",EXPLIC,1,46)
"RTN","PSOERXR1",60,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXR1",61,0)
 S LINE=LINE+1
"RTN","PSOERXR1",62,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Tel: ",$G(PRTEL),1,26)
"RTN","PSOERXR1",63,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Fax: ",$G(PRFAX),28,26)
"RTN","PSOERXR1",64,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXR1",65,0)
 ;/BLB/ PSO*7.0*520 MOVED AGENT/SUPERVISOR TO OWN LINE - BEGIN CHANGE
"RTN","PSOERXR1",66,0)
 S LINE=LINE+1
"RTN","PSOERXR1",67,0)
 D TXT2ARY^PSOERXD1(.AGENTARY,EXPAGNT,,65)
"RTN","PSOERXR1",68,0)
 S NFIRST=$O(AGENTARY(0))
"RTN","PSOERXR1",69,0)
 S NLOOP=0 F  S NLOOP=$O(AGENTARY(NLOOP)) Q:'NLOOP  D
"RTN","PSOERXR1",70,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,$S(NLOOP=NFIRST:"Agent: ",1:" ")_$G(AGENTARY(NLOOP)))
"RTN","PSOERXR1",71,0)
 S LINE=LINE+1
"RTN","PSOERXR1",72,0)
 D TXT2ARY^PSOERXD1(.SUPERARY,EXPSUPER,,65)
"RTN","PSOERXR1",73,0)
 S TFIRST=$O(SUPERARY(0))
"RTN","PSOERXR1",74,0)
 S TLOOP=0 F  S TLOOP=$O(SUPERARY(TLOOP)) Q:'TLOOP  D
"RTN","PSOERXR1",75,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,$S(TLOOP=TFIRST:"Supervisor: ",1:" ")_$G(SUPERARY(TLOOP)))
"RTN","PSOERXR1",76,0)
 S LINE=LINE+1
"RTN","PSOERXR1",77,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXR1",78,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXR1",79,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXR1",80,0)
 S $P(SEPLN,"-",80)="-" D SET^VALM10(LINE,SEPLN)
"RTN","PSOERXR1",81,0)
 ; vista patient information
"RTN","PSOERXR1",82,0)
 S VAPRVIEN=$$GET1^DIQ(52.49,PSOIEN,2.3,"I")
"RTN","PSOERXR1",83,0)
 ; INITIALIZE variables
"RTN","PSOERXR1",84,0)
 S (VAPNM,VAPADD1,VAPADD2,VAPCIT,VAPST,VAPZIP,VAPNPI,VAPDEA,VAPLIC,VAPTEL,VAPFAX)=""
"RTN","PSOERXR1",85,0)
 S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.3,"I")
"RTN","PSOERXR1",86,0)
 S VALBY=$$GET1^DIQ(52.49,PSOIEN,1.8,"E")
"RTN","PSOERXR1",87,0)
 S VALDTTM=$$GET1^DIQ(52.49,PSOIEN,1.9,"E")
"RTN","PSOERXR1",88,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Status: "_$S(MANVAL:"VALIDATED ("_VALBY_" - "_VALDTTM_")",1:"NOT VALIDATED"))
"RTN","PSOERXR1",89,0)
 I 'VAPRVIEN S LINE=LINE+1 D SET^VALM10(LINE,"PROVIDER NOT MATCHED")
"RTN","PSOERXR1",90,0)
 I VAPRVIEN D
"RTN","PSOERXR1",91,0)
 .S VAPIENS=VAPRVIEN_","
"RTN","PSOERXR1",92,0)
 .; 41.99 - NPI, 53.2 - DEA, 54.2 - STATE LICENSING DEA NUMBER, .132 - OFFICE PHONE, .136 - FAX
"RTN","PSOERXR1",93,0)
 .D GETS^DIQ(200,VAPIENS_",",".01;.111;.112;.113;.114;.115;.116;.132;.136;41.99;53.2;54.2","IE","VAPROV")
"RTN","PSOERXR1",94,0)
 .S VAPNM=$G(VAPROV(200,VAPIENS,.01,"E"))
"RTN","PSOERXR1",95,0)
 .S VAPADD1=$G(VAPROV(200,VAPIENS,.111,"E"))
"RTN","PSOERXR1",96,0)
 .S VAPADD2=$G(VAPROV(200,VAPIENS,.112,"E"))
"RTN","PSOERXR1",97,0)
 .S VAPCIT=$G(VAPROV(200,VAPIENS,.114,"E"))
"RTN","PSOERXR1",98,0)
 .S VAPST=$G(VAPROV(200,VAPIENS,.115,"E"))
"RTN","PSOERXR1",99,0)
 .S VAPZIP=$G(VAPROV(200,VAPIENS,.116,"E"))
"RTN","PSOERXR1",100,0)
 .S VAPNPI=$G(VAPROV(200,VAPIENS,41.99,"E"))
"RTN","PSOERXR1",101,0)
 .S VAPDEA=$G(VAPROV(200,VAPIENS,53.2,"E"))
"RTN","PSOERXR1",102,0)
 .S VAPDEAEX=$$GET1^DIQ(200,VAPIENS,747.44,"I") I VAPDEAEX,VAPDEAEX<DT S DEAEXP=1
"RTN","PSOERXR1",103,0)
 .S VAPLIC=$G(VAPROV(200,VAPIENS,54.2,"E"))
"RTN","PSOERXR1",104,0)
 .S VAPTEL=$G(VAPROV(200,VAPIENS,.132,"E"))
"RTN","PSOERXR1",105,0)
 .S VAPFAX=$G(VAPROV(200,VAPIENS,.136,"E"))
"RTN","PSOERXR1",106,0)
 .S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.3,"I")
"RTN","PSOERXR1",107,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Vista Provider: "_VAPNM)
"RTN","PSOERXR1",108,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Address: "_$S($L(VAPADD1):VAPADD1,1:"No street address on file."))
"RTN","PSOERXR1",109,0)
 .I $L(VAPADD2) S LINE=LINE+1 D SET^VALM10(LINE,"         "_VAPADD2)
"RTN","PSOERXR1",110,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"         "_VAPCIT_", "_VAPST_" "_VAPZIP)
"RTN","PSOERXR1",111,0)
 .S LINE=LINE+1
"RTN","PSOERXR1",112,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"NPI: ",VAPNPI,1,26)
"RTN","PSOERXR1",113,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"DEA: ",VAPDEA_$S($G(DEAEXP):" (Expired)",1:""),28,26)
"RTN","PSOERXR1",114,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXR1",115,0)
 .S LINE=LINE+1
"RTN","PSOERXR1",116,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Tel: ",VAPTEL,1,26)
"RTN","PSOERXR1",117,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Fax: ",VAPFAX,28,26)
"RTN","PSOERXR1",118,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXR1",119,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXR1",120,0)
 S VALMCNT=LINE
"RTN","PSOERXR1",121,0)
 S EDTYP="PR"
"RTN","PSOERXR1",122,0)
 Q
"RTN","PSOERXR1",123,0)
HELP ; -- help code
"RTN","PSOERXR1",124,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERXR1",125,0)
 Q
"RTN","PSOERXR1",126,0)
 ;
"RTN","PSOERXR1",127,0)
EXIT ; -- exit code
"RTN","PSOERXR1",128,0)
 K EDTYP,@VALMAR
"RTN","PSOERXR1",129,0)
 Q
"RTN","PSOERXR1",130,0)
 ;
"RTN","PSOERXR1",131,0)
EXPND ; -- expand code
"RTN","PSOERXR1",132,0)
 Q
"RTN","PSOERXU1")
0^11^B88661299^B72865919
"RTN","PSOERXU1",1,0)
PSOERXU1 ;ALB/BWF - eRx utilities ; 5/26/2017 9:57am
"RTN","PSOERXU1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520**;DEC 1997;Build 52
"RTN","PSOERXU1",3,0)
 ;
"RTN","PSOERXU1",4,0)
 Q
"RTN","PSOERXU1",5,0)
 ; OR0 - OR0 FROM PENDING OUTPATIENT ORDERS OR BACKDOOR ORDERS
"RTN","PSOERXU1",6,0)
CHKERX(OR0) ;
"RTN","PSOERXU1",7,0)
 N ORIEN,ERXIEN
"RTN","PSOERXU1",8,0)
 S ORIEN=$P(OR0,U) Q:'ORIEN
"RTN","PSOERXU1",9,0)
 I '$D(^PS(52.49,"ORN",ORIEN)) Q 0
"RTN","PSOERXU1",10,0)
 S ERXIEN=$O(^PS(52.49,"ORN",ORIEN,0))
"RTN","PSOERXU1",11,0)
 I 'ERXIEN Q 0
"RTN","PSOERXU1",12,0)
 Q ERXIEN
"RTN","PSOERXU1",13,0)
 ; STORE IN ^TMP("PSOPO",$J,IEN,0)
"RTN","PSOERXU1",14,0)
DERX1(GL,PSOIEN,DFLG,IEN) ;
"RTN","PSOERXU1",15,0)
 N EDRG,ERXDAT,ESIG,COMM,SUBS,DFORM,DSTR,QQUAL,POTUC,QTY,DAYS,REFILL,PSOIENS,LINE,LINETXT,ADLINE,ADARY,ALOOP,COMMARY
"RTN","PSOERXU1",16,0)
 N ERXPAT,ERXPIEN,ERXPDOB,ERXPSSN,ERXPROV,ERXPRIEN,ERXPRDEA,ERXPRNPI,ERXPRSA1,ERXPRSA2,ERXPRCTY,ERXPRST,ERXPRZIP,I
"RTN","PSOERXU1",17,0)
 N PROVDAT,SIGARY,STHIS,STAT,ACBY,FOUND,ACDTTM,DRGARY,DLP,CTYSTZIP,ADLINE1
"RTN","PSOERXU1",18,0)
 Q:'PSOIEN
"RTN","PSOERXU1",19,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERXU1",20,0)
 D GETS^DIQ(52.49,PSOIENS,".04;2.1;3.1;4.6;4.8;5.1;5.2;5.4;5.5;5.6;5.7;5.8;7;8;41;42;43","IE","ERXDAT")
"RTN","PSOERXU1",21,0)
 S DFLG=$G(DFLG,"")
"RTN","PSOERXU1",22,0)
 S EDRG=$G(ERXDAT(52.49,PSOIENS,3.1,"E"))
"RTN","PSOERXU1",23,0)
 S ESIG=$G(ERXDAT(52.49,PSOIENS,7,"E"))
"RTN","PSOERXU1",24,0)
 S COMM=$G(ERXDAT(52.49,PSOIENS,8,"E"))
"RTN","PSOERXU1",25,0)
 S SUBS=$G(ERXDAT(52.49,PSOIENS,5.8,"E"))
"RTN","PSOERXU1",26,0)
 S DFORM=$G(ERXDAT(52.49,PSOIENS,41,"E"))
"RTN","PSOERXU1",27,0)
 S DSTR=$G(ERXDAT(52.49,PSOIENS,43,"E"))
"RTN","PSOERXU1",28,0)
 S QQUAL=$G(ERXDAT(52.49,PSOIENS,5.2,"E"))
"RTN","PSOERXU1",29,0)
 S POTUC=$G(ERXDAT(52.49,PSOIENS,42,"E"))
"RTN","PSOERXU1",30,0)
 S QTY=$G(ERXDAT(52.49,PSOIENS,5.1,"E"))
"RTN","PSOERXU1",31,0)
 S DAYS=$G(ERXDAT(52.49,PSOIENS,5.5,"E"))
"RTN","PSOERXU1",32,0)
 S REFILL=$G(ERXDAT(52.49,PSOIENS,5.6,"E"))
"RTN","PSOERXU1",33,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXU1",34,0)
 I REFILL="" D
"RTN","PSOERXU1",35,0)
 .S REFILL=$G(ERXDAT(52.49,PSOIENS,5.7,"I"))
"RTN","PSOERXU1",36,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXU1",37,0)
 S ERXPAT=$G(ERXDAT(52.49,PSOIENS,.04,"E"))
"RTN","PSOERXU1",38,0)
 S ERXPIEN=$G(ERXDAT(52.49,PSOIENS,.04,"I"))
"RTN","PSOERXU1",39,0)
 S ERXPDOB=$$GET1^DIQ(52.46,ERXPIEN,.08,"E")
"RTN","PSOERXU1",40,0)
 S ERXPSSN=$$GET1^DIQ(52.46,ERXPIEN,1.4,"E")
"RTN","PSOERXU1",41,0)
 S ERXPROV=$G(ERXDAT(52.49,PSOIENS,2.1,"E"))
"RTN","PSOERXU1",42,0)
 S ERXPRIEN=$G(ERXDAT(52.49,PSOIENS,2.1,"I"))
"RTN","PSOERXU1",43,0)
 D GETS^DIQ(52.48,ERXPRIEN_",","1.5;1.6;4.1;4.2;4.3;4.4;4.5","E","PROVDAT")
"RTN","PSOERXU1",44,0)
 S ERXPRDEA=$G(PROVDAT(52.48,ERXPRIEN_",",1.6,"E"))
"RTN","PSOERXU1",45,0)
 S ERXPRNPI=$G(PROVDAT(52.48,ERXPRIEN_",",1.5,"E"))
"RTN","PSOERXU1",46,0)
 S ERXPRSA1=$G(PROVDAT(52.48,ERXPRIEN_",",4.1,"E"))
"RTN","PSOERXU1",47,0)
 S ERXPRSA2=$G(PROVDAT(52.48,ERXPRIEN_",",4.2,"E"))
"RTN","PSOERXU1",48,0)
 S ERXPRCTY=$G(PROVDAT(52.48,ERXPRIEN_",",4.3,"E"))
"RTN","PSOERXU1",49,0)
 S ERXPRST=$G(PROVDAT(52.48,ERXPRIEN_",",4.4,"E"))
"RTN","PSOERXU1",50,0)
 S ERXPRZIP=$G(PROVDAT(52.48,ERXPRIEN_",",4.5,"E"))
"RTN","PSOERXU1",51,0)
 D TXT2ARY^PSOERXD1(.SIGARY,ESIG,,69)
"RTN","PSOERXU1",52,0)
 D TXT2ARY^PSOERXD1(.COMMARY,COMM,,65)
"RTN","PSOERXU1",53,0)
 S STHIS=99999,FOUND=0
"RTN","PSOERXU1",54,0)
 F  S STHIS=$O(^PS(52.49,PSOIEN,19,STHIS),-1) Q:'STHIS!(FOUND)  D
"RTN","PSOERXU1",55,0)
 .S STAT=$$GET1^DIQ(52.4919,STHIS_","_PSOIENS,.02,"I")
"RTN","PSOERXU1",56,0)
 .I $$GET1^DIQ(52.45,STAT,.01,"E")'="PR" Q
"RTN","PSOERXU1",57,0)
 .S ACDTTM=$$GET1^DIQ(52.4919,STHIS_","_PSOIENS,.01,"E")
"RTN","PSOERXU1",58,0)
 .S ACBY=$$GET1^DIQ(52.4919,STHIS_","_PSOIENS,.03,"E"),FOUND=1
"RTN","PSOERXU1",59,0)
 I $L($G(ACBY)) S IEN=IEN+1,@GL@(IEN,0)="eRx Accepted By: "_ACBY_" ("_ACDTTM_")"
"RTN","PSOERXU1",60,0)
 S LINETXT=""
"RTN","PSOERXU1",61,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Patient: ",ERXPAT,1,55)
"RTN","PSOERXU1",62,0)
 D ADDITEM^PSOERX1A(.LINETXT,"SSN: ",ERXPSSN,57,15)
"RTN","PSOERXU1",63,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT
"RTN","PSOERXU1",64,0)
 S LINETXT=""
"RTN","PSOERXU1",65,0)
 I $L(ERXPAT)>42 D ADDITEM^PSOERX1A(.LINETXT,"             ",$E(ERXPAT,43,84),1,55)
"RTN","PSOERXU1",66,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",ERXPDOB,57,20)
"RTN","PSOERXU1",67,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT
"RTN","PSOERXU1",68,0)
 I $L(ERXPAT)>84 D
"RTN","PSOERXU1",69,0)
 .S IEN=IEN+1,@GL@(IEN,0)="             "_$E(ERXPAT,85,117)
"RTN","PSOERXU1",70,0)
 S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",71,0)
 I $L(ERXPAT)>117 D
"RTN","PSOERXU1",72,0)
 .S IEN=IEN+1,@GL@(IEN,0)="             "_$E(ERXPAT,118,135)
"RTN","PSOERXU1",73,0)
 S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",74,0)
 S LINETXT=""
"RTN","PSOERXU1",75,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Provider: ",$E(ERXPROV,1,55),1,55)
"RTN","PSOERXU1",76,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DEA: ",ERXPRDEA,57,20)
"RTN","PSOERXU1",77,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT,LINETXT=""
"RTN","PSOERXU1",78,0)
 I $L(ERXPROV)>55 D ADDITEM^PSOERX1A(.LINETXT,"              ",$E(ERXPROV,56,96),1,55)
"RTN","PSOERXU1",79,0)
 D ADDITEM^PSOERX1A(.LINETXT,"NPI: ",ERXPRNPI,57,20)
"RTN","PSOERXU1",80,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT,LINETXT=""
"RTN","PSOERXU1",81,0)
 I $L(ERXPROV)>96 D ADDITEM^PSOERX1A(.LINETXT,"              ",$E(ERXPROV,97,135),1,55)
"RTN","PSOERXU1",82,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT,LINETXT=""
"RTN","PSOERXU1",83,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXU1",84,0)
 S ADLINE1=$S($L(ERXPRSA1):ERXPRSA1,1:"ADDRESS UNKNOWN ")
"RTN","PSOERXU1",85,0)
 S CTYSTZIP=$S($L(ERXPRCTY):ERXPRCTY_",",1:"")
"RTN","PSOERXU1",86,0)
 S CTYSTZIP=CTYSTZIP_$S($L(ERXPRST):ERXPRST_" ",1:"")
"RTN","PSOERXU1",87,0)
 S CTYSTZIP=" "_CTYSTZIP_$S($L(ERXPRZIP):ERXPRZIP,1:"")
"RTN","PSOERXU1",88,0)
 S IEN=IEN+1,@GL@(IEN,0)="Address: "_ADLINE1
"RTN","PSOERXU1",89,0)
 S IEN=IEN+1,@GL@(IEN,0)=CTYSTZIP
"RTN","PSOERXU1",90,0)
 I $L(ERXPRSA2) D
"RTN","PSOERXU1",91,0)
 .S IEN=IEN+1,@GL@(IEN,0)="Address Line 2: "_ERXPRSA2
"RTN","PSOERXU1",92,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXU1",93,0)
 I $O(ADARY(0)) D
"RTN","PSOERXU1",94,0)
 .S ALOOP=1 F  S ALOOP=$O(ADARY(ALOOP)) Q:'ALOOP  D
"RTN","PSOERXU1",95,0)
 ..S IEN=IEN+1,@GL@(IEN,0)="         "_ADARY(ALOOP)
"RTN","PSOERXU1",96,0)
 S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",97,0)
 D TXT2ARY^PSOERXD1(.DRGARY,EDRG,,70)
"RTN","PSOERXU1",98,0)
 S IEN=IEN+1,@GL@(IEN,0)="eRx Drug: "_$G(DRGARY(1))
"RTN","PSOERXU1",99,0)
 S DLP=1
"RTN","PSOERXU1",100,0)
 F  S DLP=$O(DRGARY(DLP)) Q:'DLP  D
"RTN","PSOERXU1",101,0)
 .S IEN=IEN+1,@GL@(IEN,0)="          "_$G(DRGARY(DLP))
"RTN","PSOERXU1",102,0)
 S LINETXT=""
"RTN","PSOERXU1",103,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Qty: ",QTY,1,25)
"RTN","PSOERXU1",104,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Days Supply: ",DAYS,27,16)
"RTN","PSOERXU1",105,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Refills: ",REFILL,58,20)
"RTN","PSOERXU1",106,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT
"RTN","PSOERXU1",107,0)
 S IEN=IEN+1,@GL@(IEN,0)="eRx Sig: "
"RTN","PSOERXU1",108,0)
 S I=0 F  S I=$O(SIGARY(I)) Q:'I  D
"RTN","PSOERXU1",109,0)
 .I I=1 S @GL@(IEN,0)=@GL@(IEN,0)_SIGARY(I) Q
"RTN","PSOERXU1",110,0)
 .S IEN=IEN+1,@GL@(IEN,0)=$S(I>1:"         "_SIGARY(I),1:SIGARY(I))
"RTN","PSOERXU1",111,0)
 I '$L(ESIG) S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",112,0)
 S IEN=IEN+1,@GL@(IEN,0)="eRx Notes: "
"RTN","PSOERXU1",113,0)
 S I=0 F  S I=$O(COMMARY(I)) Q:'I  D
"RTN","PSOERXU1",114,0)
 .I I=1 S @GL@(IEN,0)=@GL@(IEN,0)_$S(I>1:"              "_COMMARY(I),1:COMMARY(I)) Q
"RTN","PSOERXU1",115,0)
 .S IEN=IEN+1,@GL@(IEN,0)=$S(I>1:"              "_COMMARY(I),1:COMMARY(I))
"RTN","PSOERXU1",116,0)
 I '$L(COMM) S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",117,0)
 Q:DFLG=1
"RTN","PSOERXU1",118,0)
 S LINETXT=""
"RTN","PSOERXU1",119,0)
 S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",120,0)
 S IEN=IEN+1,@GL@(IEN,0)="Drug Form: "_DFORM
"RTN","PSOERXU1",121,0)
 S IEN=IEN+1,@GL@(IEN,0)="Strength: "_DSTR
"RTN","PSOERXU1",122,0)
 S LINETXT=""
"RTN","PSOERXU1",123,0)
 S IEN=IEN+1,@GL@(IEN,0)="Qty Qualifier: "_QQUAL
"RTN","PSOERXU1",124,0)
 S IEN=IEN+1,@GL@(IEN,0)="Potency Unit Code: "_POTUC
"RTN","PSOERXU1",125,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT
"RTN","PSOERXU1",126,0)
 S IEN=IEN+1,@GL@(IEN,0)="DAW Code: "_SUBS
"RTN","PSOERXU1",127,0)
 S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",128,0)
 ; diagnosis information
"RTN","PSOERXU1",129,0)
 N DIAGIEN,DIAGDAT,DIAGSEQ,PDIAGQ,PDIAGV,SDIAGQ,SDIAGV,DIAGDAT,DIACIC,DRES,SDRES
"RTN","PSOERXU1",130,0)
 N SDRESL,SDRESDAT,DRESL,DRESDAT,PDIAGARY,SDIAGARY,PDFRST,SDFRST,PDLOOP,SDLOOP,DIENS
"RTN","PSOERXU1",131,0)
 S DIAGIEN=0 F  S DIAGIEN=$O(^PS(52.49,PSOIEN,9,DIAGIEN)) Q:'DIAGIEN  D
"RTN","PSOERXU1",132,0)
 .S DIENS=DIAGIEN_","_PSOIEN_"," K PDIAGARY,SDIAGARY,DIAGDAT
"RTN","PSOERXU1",133,0)
 .D GETS^DIQ(52.499,DIENS,".01:.06","IE","DIAGDAT")
"RTN","PSOERXU1",134,0)
 .S DIAGSEQ=$G(DIAGDAT(52.499,DIENS,.01,"E"))
"RTN","PSOERXU1",135,0)
 .S DIACIC=$G(DIAGDAT(52.499,DIENS,.02,"E"))
"RTN","PSOERXU1",136,0)
 .S PDIAGQ=$G(DIAGDAT(52.499,DIENS,.03,"E"))
"RTN","PSOERXU1",137,0)
 .S PDIAGV=$G(DIAGDAT(52.499,DIENS,.04,"E"))
"RTN","PSOERXU1",138,0)
 .I PDIAGQ="ICD-10-CM"!(PDIAGQ="ICD-9-CM") D
"RTN","PSOERXU1",139,0)
 ..K DRES,PDIAGARY
"RTN","PSOERXU1",140,0)
 ..D ICDDESC^ICDXCODE(PDIAGQ,PDIAGV,,.DRES)
"RTN","PSOERXU1",141,0)
 ..I '$O(DRES(0)) D TXT2ARY^PSOERXD1(.PDIAGARY,PDIAGV," ",62) Q
"RTN","PSOERXU1",142,0)
 ..S DRESL=0 F  S DRESL=$O(DRES(DRESL)) Q:'DRESL  D
"RTN","PSOERXU1",143,0)
 ...S DRESDAT=$G(DRES(DRESL)) Q:DRESDAT=""
"RTN","PSOERXU1",144,0)
 ...I DRESL=1 S PDIAGV=PDIAGV_" - "_DRESDAT Q
"RTN","PSOERXU1",145,0)
 ...S PDIAGV=PDIAGV_" "_DRESDAT
"RTN","PSOERXU1",146,0)
 ..D TXT2ARY^PSOERXD1(.PDIAGARY,PDIAGV," ",62)
"RTN","PSOERXU1",147,0)
 .S SDIAGQ=$G(DIAGDAT(52.499,DIENS,.05,"E"))
"RTN","PSOERXU1",148,0)
 .S SDIAGV=$G(DIAGDAT(52.499,DIENS,.06,"E"))
"RTN","PSOERXU1",149,0)
 .I SDIAGQ="ICD-10-CM"!(SDIAGQ="ICD-9-CM") D
"RTN","PSOERXU1",150,0)
 ..K SDRES,SDIAGARY
"RTN","PSOERXU1",151,0)
 ..D ICDDESC^ICDXCODE(SDIAGQ,SDIAGV,,.SDRES)
"RTN","PSOERXU1",152,0)
 ..I '$O(SDRES(0)) D TXT2ARY^PSOERXD1(.SDIAGARY,SDIAGV," ",62) Q
"RTN","PSOERXU1",153,0)
 ..S SDRESL=0 F  S SDRESL=$O(SDRES(SDRESL)) Q:'SDRESL  D
"RTN","PSOERXU1",154,0)
 ...S SDRESDAT=$G(SDRES(SDRESL)) Q:SDRESDAT=""
"RTN","PSOERXU1",155,0)
 ...I SDRESL=1 S SDIAGV=SDIAGV_" - "_SDRESDAT Q
"RTN","PSOERXU1",156,0)
 ...S SDIAGV=SDIAGV_" "_SDRESDAT
"RTN","PSOERXU1",157,0)
 ..D TXT2ARY^PSOERXD1(.SDIAGARY,SDIAGV," ",62)
"RTN","PSOERXU1",158,0)
 .S IEN=IEN+1,@GL@(IEN,0)="Diagnosis Sequence: "_DIAGSEQ
"RTN","PSOERXU1",159,0)
 .S IEN=IEN+1,@GL@(IEN,0)="Primary DX Qualifier: "_PDIAGQ
"RTN","PSOERXU1",160,0)
 .S PDFRST=$O(PDIAGARY(0))
"RTN","PSOERXU1",161,0)
 .S IEN=IEN+1,@GL@(IEN,0)="Primary Dx Value: "_$S(PDFRST:$G(PDIAGARY(PDFRST)),1:PDIAGV)
"RTN","PSOERXU1",162,0)
 .S PDLOOP=PDFRST F  S PDLOOP=$O(PDIAGARY(PDLOOP)) Q:'PDLOOP  D
"RTN","PSOERXU1",163,0)
 ..S IEN=IEN+1,@GL@(IEN,0)="                  "_$G(PDIAGARY(PDLOOP))
"RTN","PSOERXU1",164,0)
 .S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",165,0)
 .S IEN=IEN+1,@GL@(IEN,0)="Secondary DX Qualifier: "_SDIAGQ
"RTN","PSOERXU1",166,0)
 .S SDFRST=$O(SDIAGARY(0))
"RTN","PSOERXU1",167,0)
 .S IEN=IEN+1,@GL@(IEN,0)="Secondary Dx Value: "_$S(SDFRST:$G(SDIAGARY(SDFRST)),1:SDIAGV)
"RTN","PSOERXU1",168,0)
 .S SDLOOP=SDFRST F  S SDLOOP=$O(SDIAGARY(SDLOOP)) Q:'SDLOOP  D
"RTN","PSOERXU1",169,0)
 ..S IEN=IEN+1,@GL@(IEN,0)="                    "_$G(SDIAGARY(SDLOOP))
"RTN","PSOERXU1",170,0)
 S $P(LINE,"-",80)=""
"RTN","PSOERXU1",171,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINE
"RTN","PSOERXU1",172,0)
 Q
"RTN","PSOERXU1",173,0)
OPACCESS(OPTION,DUZ) ;
"RTN","PSOERXU1",174,0)
 I OPTION="PSO ERX ACCEPT ERX",'$D(^XUSEC("PSDRPH",DUZ)) Q 0
"RTN","PSOERXU1",175,0)
 I OPTION="PSO ERX ACCEPT VALIDATION",($D(^XUSEC("PSO ERX TECH",DUZ))!($D(^XUSEC("PSO ERX VIEW",DUZ)))) Q 0
"RTN","PSOERXU1",176,0)
 I OPTION="PSO ERX REJECT",($D(^XUSEC("PSO ERX TECH",DUZ))!($D(^XUSEC("PSO ERX VIEW",DUZ)))) Q 0
"RTN","PSOERXU1",177,0)
 I OPTION="PSO ERX REMOVE",($D(^XUSEC("PSO ERX TECH",DUZ))!($D(^XUSEC("PSO ERX VIEW",DUZ)))) Q 0
"RTN","PSOERXU1",178,0)
 ; UNREMOVE NEEDS TO BE ADDED IF WE ADD THE OPTION
"RTN","PSOERXU1",179,0)
 I OPTION="PSO ERX VALIDATE PATIENT",$D(^XUSEC("PSO ERX VIEW",DUZ)) Q 0
"RTN","PSOERXU1",180,0)
 I OPTION="PSO ERX VALIDATE PROVIDER",$D(^XUSEC("PSO ERX VIEW",DUZ)) Q 0
"RTN","PSOERXU1",181,0)
 I OPTION="PSO ERX VALIDATE DRUG",$D(^XUSEC("PSO ERX VIEW",DUZ)) Q 0
"RTN","PSOERXU1",182,0)
 I OPTION="PSO ERX HOLD",$D(^XUSEC("PSO ERX VIEW",DUZ)) Q 0
"RTN","PSOERXU1",183,0)
 I OPTION="PSO ERX UNHOLD",$D(^XUSEC("PSO ERX VIEW",DUZ)) Q 0
"RTN","PSOERXU1",184,0)
 Q 1
"RTN","PSOERXU1",185,0)
 ; update the status of an eRx
"RTN","PSOERXU1",186,0)
 ; PSOIEN - ien for file 52.49 (required)
"RTN","PSOERXU1",187,0)
 ; STAT - The status value to change the eRx to (required)
"RTN","PSOERXU1",188,0)
 ; SCOMM - status comments (optional)
"RTN","PSOERXU1",189,0)
UPDSTAT(PSOIEN,STAT,SCOMM) ;
"RTN","PSOERXU1",190,0)
 N DIE,NSTAT,DA,DR
"RTN","PSOERXU1",191,0)
 Q:'PSOIEN!(STAT="")
"RTN","PSOERXU1",192,0)
 Q:'$D(^PS(52.45,"C","ERX",STAT))
"RTN","PSOERXU1",193,0)
 S NSTAT=$O(^PS(52.45,"C","ERX",STAT,0))
"RTN","PSOERXU1",194,0)
 ;S NSTAT=$O(^PS(52.45,"C","ERX","I",0))
"RTN","PSOERXU1",195,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="1///"_NSTAT D ^DIE
"RTN","PSOERXU1",196,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",.01)=$$NOW^XLFDT
"RTN","PSOERXU1",197,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",.02)=NSTAT
"RTN","PSOERXU1",198,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",.03)=$G(DUZ)
"RTN","PSOERXU1",199,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",1)=$G(SCOMM)
"RTN","PSOERXU1",200,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXU1",201,0)
 Q
"RTN","PSOERXU1",202,0)
ERRSEQ() ;
"RTN","PSOERXU1",203,0)
 N SEQ
"RTN","PSOERXU1",204,0)
 I '$O(^PS(52.49,EIEN,100,0)) S SEQ=1
"RTN","PSOERXU1",205,0)
 I '$G(SEQ) S SEQ=$O(^PS(52.49,EIEN,100,999999),-1)+1
"RTN","PSOERXU1",206,0)
 Q SEQ
"RTN","PSOERXU1",207,0)
 ;
"RTN","PSOERXU1",208,0)
 ; IENS - ien of the erx holding queue entry
"RTN","PSOERXU1",209,0)
 ;  SEQ - sequence number of the error
"RTN","PSOERXU1",210,0)
 ; TYPE - type (d-drug, pr-provider, pa-patient, a-allergy, o-order check, t-transfer)
"RTN","PSOERXU1",211,0)
 ;  SRC - v - vista, e - erx processing hub
"RTN","PSOERXU1",212,0)
 ;  TXT - error text
"RTN","PSOERXU1",213,0)
FILERR(IENS,SEQ,TYPE,SRC,TXT) ;
"RTN","PSOERXU1",214,0)
 N FDA
"RTN","PSOERXU1",215,0)
 S FDA(52.49101,"+1,"_IENS,.01)=SEQ
"RTN","PSOERXU1",216,0)
 S FDA(52.49101,"+1,"_IENS,.02)=TYPE
"RTN","PSOERXU1",217,0)
 S FDA(52.49101,"+1,"_IENS,.03)=SRC
"RTN","PSOERXU1",218,0)
 ; all new errors are set to pending
"RTN","PSOERXU1",219,0)
 S FDA(52.49101,"+1,"_IENS,.04)="P"
"RTN","PSOERXU1",220,0)
 S FDA(52.49101,"+1,"_IENS,1)=TXT
"RTN","PSOERXU1",221,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXU1",222,0)
 ; now set the eRx entry status to error
"RTN","PSOERXU1",223,0)
 ;S FDA(52.49,IENS,1)=$O(^PS(52.45,"C","ERX","E",0)) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXU1",224,0)
 Q
"RTN","PSOERXU1",225,0)
MSGDIR(MSG) ;
"RTN","PSOERXU1",226,0)
 N DIR,MLOOP,MTXT
"RTN","PSOERXU1",227,0)
 S VALMBCK="R"
"RTN","PSOERXU1",228,0)
 D FULL^VALM1
"RTN","PSOERXU1",229,0)
 W !!,"Errors encountered during processing:",!
"RTN","PSOERXU1",230,0)
 S MLOOP=0 F  S MLOOP=$O(MSG(MLOOP)) Q:'MLOOP  D
"RTN","PSOERXU1",231,0)
 .S MTXT=$G(MSG(MLOOP)) W !,MLOOP_".) ",MTXT
"RTN","PSOERXU1",232,0)
 W !!,"Cannot process eRx.",!
"RTN","PSOERXU1",233,0)
 S DIR(0)="E" D ^DIR
"RTN","PSOERXU1",234,0)
 Q
"RTN","PSOERXU1",235,0)
 ;/BLB/ PSO*7.0*520 -BEGIN CHANGE- ALLERGY INFO
"RTN","PSOERXU1",236,0)
ALG(LINE) ;
"RTN","PSOERXU1",237,0)
 N ALGINFO,ALGLINE,DFN,IEN,X,LDAT,GMRAL,PSONOAL
"RTN","PSOERXU1",238,0)
 S ALGLINE=""
"RTN","PSOERXU1",239,0)
 S DFN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXU1",240,0)
 D EN1^GMRADPT
"RTN","PSOERXU1",241,0)
 S IEN=1
"RTN","PSOERXU1",242,0)
 I 'GMRAL D
"RTN","PSOERXU1",243,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Allergies: "_$S(GMRAL=0:"NKA",1:"")
"RTN","PSOERXU1",244,0)
 .I GMRAL'=0 S PSONOAL="" D ALLERGY^PSOORUT2 I PSONOAL'="" S ^TMP("PSOPI",$J,IEN,0)="Allergies: "_PSONOAL K PSONOAL
"RTN","PSOERXU1",245,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOERXU1",246,0)
 .D REMOTE^PSOORUT2
"RTN","PSOERXU1",247,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Adverse Reactions:"
"RTN","PSOERXU1",248,0)
 D:$G(GMRAL) ^PSOORUT3
"RTN","PSOERXU1",249,0)
 S LINE=LINE+1
"RTN","PSOERXU1",250,0)
 S X=0 F  S X=$O(^TMP("PSOPI",$J,X)) Q:'X  D
"RTN","PSOERXU1",251,0)
 .S LDAT=$G(^TMP("PSOPI",$J,X,0))
"RTN","PSOERXU1",252,0)
 .S LINE=LINE+1
"RTN","PSOERXU1",253,0)
 .D SET^VALM10(LINE,LDAT)
"RTN","PSOERXU1",254,0)
 K ^TMP("PSOPI",$J)
"RTN","PSOERXU1",255,0)
 Q
"RTN","PSOERXU1",256,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXU4")
0^12^B35485114^n/a
"RTN","PSOERXU4",1,0)
PSOERXU4 ;ALB/BLB - eRx utilities ; 2/21/2018 4:00pm
"RTN","PSOERXU4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**520**;DEC 1997;Build 52
"RTN","PSOERXU4",3,0)
 ;
"RTN","PSOERXU4",4,0)
 Q
"RTN","PSOERXU4",5,0)
DERX1(PSOIEN,PSOIENS,DFLG) ;
"RTN","PSOERXU4",6,0)
 N EDRG,ERXDAT,ESIG,COMM,SUBS,DFORM,DSTR,QQUAL,POTUC,QTY,DAYS,REFILL,COMMARY,SIGARY,ERXRFLS,I
"RTN","PSOERXU4",7,0)
 D GETS^DIQ(52.49,PSOIENS,"3.1;4.6;4.8;5.1;5.2;5.4;5.5;5.6;5.7;5.8;7;8;41;42;43","E","ERXDAT")
"RTN","PSOERXU4",8,0)
 S DFLG=$G(DFLG,"")
"RTN","PSOERXU4",9,0)
 S EDRG=$G(ERXDAT(52.49,PSOIENS,3.1,"E"))
"RTN","PSOERXU4",10,0)
 S ESIG=$G(ERXDAT(52.49,PSOIENS,7,"E"))
"RTN","PSOERXU4",11,0)
 S COMM=$G(ERXDAT(52.49,PSOIENS,8,"E"))
"RTN","PSOERXU4",12,0)
 S SUBS=$G(ERXDAT(52.49,PSOIENS,5.8,"E"))
"RTN","PSOERXU4",13,0)
 S DFORM=$G(ERXDAT(52.49,PSOIENS,41,"E"))
"RTN","PSOERXU4",14,0)
 S DSTR=$G(ERXDAT(52.49,PSOIENS,43,"E"))
"RTN","PSOERXU4",15,0)
 S QQUAL=$G(ERXDAT(52.49,PSOIENS,5.2,"E"))
"RTN","PSOERXU4",16,0)
 S POTUC=$G(ERXDAT(52.49,PSOIENS,42,"E"))
"RTN","PSOERXU4",17,0)
 S QTY=$G(ERXDAT(52.49,PSOIENS,5.1,"E"))
"RTN","PSOERXU4",18,0)
 S DAYS=$G(ERXDAT(52.49,PSOIENS,5.5,"E"))
"RTN","PSOERXU4",19,0)
 S REFILL=$G(ERXDAT(52.49,PSOIENS,5.6,"E"))
"RTN","PSOERXU4",20,0)
 I REFILL="" D
"RTN","PSOERXU4",21,0)
 .S REFILL=$G(ERXDAT(52.49,PSOIENS,5.7,"I"))
"RTN","PSOERXU4",22,0)
 D TXT2ARY^PSOERXD1(.SIGARY,ESIG,,69)
"RTN","PSOERXU4",23,0)
 D TXT2ARY^PSOERXD1(.COMMARY,COMM,,65)
"RTN","PSOERXU4",24,0)
 W !!!,"eRx Drug: "_EDRG
"RTN","PSOERXU4",25,0)
 W !,"eRx Sig: "
"RTN","PSOERXU4",26,0)
 S I=0 F  S I=$O(SIGARY(I)) Q:'I  D
"RTN","PSOERXU4",27,0)
 .W $S(I>1:"         "_SIGARY(I),1:SIGARY(I)),!
"RTN","PSOERXU4",28,0)
 I '$L(ESIG) W !
"RTN","PSOERXU4",29,0)
 W "eRx Notes: "
"RTN","PSOERXU4",30,0)
 S I=0 F  S I=$O(COMMARY(I)) Q:'I  D
"RTN","PSOERXU4",31,0)
 .W $S(I>1:"              "_COMMARY(I),1:COMMARY(I)),!
"RTN","PSOERXU4",32,0)
 I '$L(COMM) W !
"RTN","PSOERXU4",33,0)
 Q:DFLG=1
"RTN","PSOERXU4",34,0)
 W "Drug Form: "_DFORM,?40,"Strength: "_DSTR
"RTN","PSOERXU4",35,0)
 W !,"Qty Qualifier: "_QQUAL,?40,"Potency Unit Code: "_POTUC
"RTN","PSOERXU4",36,0)
 W !,"DAW Code: "_SUBS
"RTN","PSOERXU4",37,0)
 W !,"Qty: "_QTY,?25,"Days Supply: "_DAYS,?55,"Refills: "_REFILL,!!
"RTN","PSOERXU4",38,0)
 Q
"RTN","PSOERXU4",39,0)
REM ;
"RTN","PSOERXU4",40,0)
 N DIR,Y,PSSRET,PSOIENS,REMIEN,REMSTA,REMTXT,ERXRMIEN,DIC,X,RXSTAT
"RTN","PSOERXU4",41,0)
 D FULL^VALM1
"RTN","PSOERXU4",42,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERXU4",43,0)
 S VALMBCK="R"
"RTN","PSOERXU4",44,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERXU4",45,0)
 .W !!,"Cannot remove a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERXU4",46,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERXU4",47,0)
 S DIR(0)="YO",DIR("A")="Would you like to 'Remove' eRx #"_$$GET1^DIQ(52.49,PSOIEN,.01,"E"),DIR("B")="Y" D ^DIR K DIR
"RTN","PSOERXU4",48,0)
 Q:'Y
"RTN","PSOERXU4",49,0)
 S DIC="^PS(52.45,",DIC(0)="AEMQ",DIC("S")="I $D(^PS(52.45,""TYPE"",""REM"",Y))",DIC("A")="Select REMOVAL reason code: "
"RTN","PSOERXU4",50,0)
 D ^DIC K DIC
"RTN","PSOERXU4",51,0)
 I $P(Y,U)<1 W !,"Removal reason code required!" S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXU4",52,0)
 S REMIEN=$P(Y,U),REMSTA=$P(Y,U,2)
"RTN","PSOERXU4",53,0)
 K X,Y S DIR(0)="FO^1:70",DIR("A")="Additional Comments (Optional)" D ^DIR K DIR
"RTN","PSOERXU4",54,0)
 Q:Y="^"
"RTN","PSOERXU4",55,0)
 S REMTXT=Y
"RTN","PSOERXU4",56,0)
 S FDA(52.4919,"+1,"_PSOIENS,.01)=$$NOW^XLFDT,FDA(52.4919,"+1,"_PSOIENS,.02)=REMIEN
"RTN","PSOERXU4",57,0)
 S FDA(52.4919,"+1,"_PSOIENS,.03)=DUZ,FDA(52.4919,"+1,"_PSOIENS,1)=REMTXT
"RTN","PSOERXU4",58,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXU4",59,0)
 ; SET THE ERX STATUS TO THE REMOVAL REASON
"RTN","PSOERXU4",60,0)
 S ERXRMIEN=$O(^PS(52.45,"C","ERX","RM",0))
"RTN","PSOERXU4",61,0)
 S DIE="^PS(52.49,",DR="1///"_ERXRMIEN,DA=PSOIEN D ^DIE
"RTN","PSOERXU4",62,0)
 K DIE,DA,DR
"RTN","PSOERXU4",63,0)
 Q
"RTN","PSOERXU4",64,0)
 ; reject eRx
"RTN","PSOERXU4",65,0)
REJ ;
"RTN","PSOERXU4",66,0)
 N DIR,DIC,Y,PSSRET,PSOIENS,REMTXT,REJSTA,FULLTXT,ERXRJIEN,REJDESC,REJIEN,REJTXT,X,RXSTAT
"RTN","PSOERXU4",67,0)
 D FULL^VALM1
"RTN","PSOERXU4",68,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERXU4",69,0)
 S VALMBCK="R"
"RTN","PSOERXU4",70,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERXU4",71,0)
 .W !!,"Cannot reject a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERXU4",72,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERXU4",73,0)
 S DIR(0)="YO",DIR("A")="Would you like to 'Reject' eRx #"_$$GET1^DIQ(52.49,PSOIEN,.01,"E"),DIR("B")="Y" D ^DIR K DIR
"RTN","PSOERXU4",74,0)
 Q:'Y
"RTN","PSOERXU4",75,0)
 S DIC="^PS(52.45,",DIC(0)="AEMQ",DIC("S")="I $D(^PS(52.45,""TYPE"",""REJ"",Y))",DIC("A")="Select REJECT reason code: "
"RTN","PSOERXU4",76,0)
 D ^DIC K DIC
"RTN","PSOERXU4",77,0)
 I $P(Y,U)<1 W !,"Reject reason required! eRx NOT rejected." S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXU4",78,0)
 S REJIEN=$P(Y,U),REJSTA=$P(Y,U,2)
"RTN","PSOERXU4",79,0)
 K X,Y,DIR
"RTN","PSOERXU4",80,0)
 S DIR(0)="FO^1:70",DIR("A")="Additional Comments (Optional)" D ^DIR K DIR
"RTN","PSOERXU4",81,0)
 Q:Y="^"
"RTN","PSOERXU4",82,0)
 ;I '$L(Y)!(Y="^") W !,"Reject reason text required. eRx NOT rejected." S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXU4",83,0)
 ; if reject reason was entered, log the activity.
"RTN","PSOERXU4",84,0)
 S REJTXT=Y
"RTN","PSOERXU4",85,0)
 S REJDESC=$$GET1^DIQ(52.45,REJIEN,.02,"E")
"RTN","PSOERXU4",86,0)
 S FULLTXT=REJSTA_"-"_REJDESC
"RTN","PSOERXU4",87,0)
 D POST^PSOERXO1(PSOIEN,.PSSRET,900,"",$E(FULLTXT,1,70))
"RTN","PSOERXU4",88,0)
 ; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERXU4",89,0)
 I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXU4",90,0)
 I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXU4",91,0)
 W !!,"Rejection message sent." S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXU4",92,0)
 ; if post is successful, change the eRx status and log the status activity.
"RTN","PSOERXU4",93,0)
 S FDA(52.4919,"+1,"_PSOIENS,.01)=$$NOW^XLFDT
"RTN","PSOERXU4",94,0)
 S FDA(52.4919,"+1,"_PSOIENS,.02)=REJIEN
"RTN","PSOERXU4",95,0)
 S FDA(52.4919,"+1,"_PSOIENS,.03)=DUZ
"RTN","PSOERXU4",96,0)
 S FDA(52.4919,"+1,"_PSOIENS,1)=REJTXT
"RTN","PSOERXU4",97,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXU4",98,0)
 ; SET THE ERX STATUS TO THE REJECT REASON
"RTN","PSOERXU4",99,0)
 S ERXRJIEN=$O(^PS(52.45,"C","ERX","RJ",0))
"RTN","PSOERXU4",100,0)
 S DIE="^PS(52.49,",DR="1///"_ERXRJIEN,DA=PSOIEN D ^DIE
"RTN","PSOERXU4",101,0)
 K DIE,DR,DA
"RTN","PSOERXU4",102,0)
 Q
"RTN","PSOERXU4",103,0)
 ;/BLB/ - BEGIN CHANGE - EDIT IN VD
"RTN","PSOERXU4",104,0)
QTYDSRFL(ERXIEN,EDTYP) ;
"RTN","PSOERXU4",105,0)
 ; ERXIEN - ien from 52.49
"RTN","PSOERXU4",106,0)
 ; EDTYP:
"RTN","PSOERXU4",107,0)
 ;        1 - DAYS SUPPLY
"RTN","PSOERXU4",108,0)
 ;        2 - QUANTITY
"RTN","PSOERXU4",109,0)
 ;        3 - REFILLS
"RTN","PSOERXU4",110,0)
 N PSODRUG,PSODIR,ERXDRUG,PSODFN,ERXIENS,FDA,CLOZPAT,PSOY,PATSTAT,Y,DONE,DIR,ANS,PSODRG
"RTN","PSOERXU4",111,0)
 S ERXIENS=ERXIEN_","
"RTN","PSOERXU4",112,0)
 ; setup drug array
"RTN","PSOERXU4",113,0)
 S ERXDRUG=$$GET1^DIQ(52.49,ERXIEN,3.2,"I") Q:'ERXDRUG 0
"RTN","PSOERXU4",114,0)
 S PSOY=ERXDRUG,PSOY(0)=$G(^PSDRUG(ERXDRUG,0))
"RTN","PSOERXU4",115,0)
 D SET^PSODRG
"RTN","PSOERXU4",116,0)
 S PSODRG=ERXDRUG
"RTN","PSOERXU4",117,0)
 ; set quanity, days supply, refill, and patient information
"RTN","PSOERXU4",118,0)
 S PSODFN=$$GET1^DIQ(52.49,ERXIEN,.05,"I")
"RTN","PSOERXU4",119,0)
 S PSODIR("QTY")=$$GET1^DIQ(52.49,ERXIEN,20.1,"E")
"RTN","PSOERXU4",120,0)
 S PSODIR("DAYS SUPPLY")=$$GET1^DIQ(52.49,ERXIEN,20.2,"E")
"RTN","PSOERXU4",121,0)
 S PSODIR("# OF REFILLS")=$$GET1^DIQ(52.49,ERXIEN,20.5,"E")
"RTN","PSOERXU4",122,0)
 S PSODIR("PATIENT STATUS")=$P(^PS(55,PSODFN,"PS"),U)
"RTN","PSOERXU4",123,0)
 S PSODIR("DFLG")=0
"RTN","PSOERXU4",124,0)
 S PATSTAT=$$GET1^DIQ(55,PSODFN,3,"E")
"RTN","PSOERXU4",125,0)
 I '$L(PATSTAT) D
"RTN","PSOERXU4",126,0)
 .S DONE=0
"RTN","PSOERXU4",127,0)
 .F  D  Q:DONE
"RTN","PSOERXU4",128,0)
 ..W !,"This is a required response. Enter '^' to exit"
"RTN","PSOERXU4",129,0)
 ..S DIR(0)="55,3",DIR("A")="PATIENT STATUS" D ^DIR K DIR
"RTN","PSOERXU4",130,0)
 ..I +Y S DONE=1 Q
"RTN","PSOERXU4",131,0)
 ..I Y["^" S PQUIT=1,DONE=1 Q
"RTN","PSOERXU4",132,0)
 .S ANS=$P(Y,"^",1)
"RTN","PSOERXU4",133,0)
 .S FDA(55,PSODFN_",",3)=ANS
"RTN","PSOERXU4",134,0)
 .D FILE^DIE(,"FDA","ERR") K FDA,ERR
"RTN","PSOERXU4",135,0)
 S PSODIR("PTST NODE")=$G(^PS(55,PSODFN,"PS"))
"RTN","PSOERXU4",136,0)
 I $P($G(^PSDRUG(PSODRG,"CLOZ1")),"^")="PSOCLO1" D
"RTN","PSOERXU4",137,0)
 .S CLOZPAT=$O(^YSCL(603.01,"C",PSODFN,0)) Q:'CLOZPAT
"RTN","PSOERXU4",138,0)
 .S CLOZPAT=$P(^YSCL(603.01,CLOZPAT,0),"^",3)
"RTN","PSOERXU4",139,0)
 .S CLOZPAT=$S(CLOZPAT="M":2,CLOZPAT="B":1,1:0)
"RTN","PSOERXU4",140,0)
 ; once called, PSODIR will be updated with the appropriate information 
"RTN","PSOERXU4",141,0)
 ;(refills/days supply/quantity)
"RTN","PSOERXU4",142,0)
 I EDTYP=1 S PSONEW("FLD")=7 D DAYS^PSODIR1(.PSODIR)
"RTN","PSOERXU4",143,0)
 I EDTYP=2 S PSONEW("FLD")=5 D QTY^PSODIR1(.PSODIR)
"RTN","PSOERXU4",144,0)
 I EDTYP=3 S PSONEW("FLD")=8 D REFILL^PSODIR1(.PSODIR)
"RTN","PSOERXU4",145,0)
 I $G(PSODIR("DFLG"))=1 Q 1
"RTN","PSOERXU4",146,0)
 S FDA(52.49,ERXIENS,20.1)=$G(PSODIR("QTY"))
"RTN","PSOERXU4",147,0)
 S FDA(52.49,ERXIENS,20.2)=$G(PSODIR("DAYS SUPPLY"))
"RTN","PSOERXU4",148,0)
 S FDA(52.49,ERXIENS,20.5)=$G(PSODIR("# OF REFILLS"))
"RTN","PSOERXU4",149,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXU4",150,0)
 Q 0
"RTN","PSOERXU4",151,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXX1")
0^1^B45537071^B44864162
"RTN","PSOERXX1",1,0)
PSOERXX1 ;ALB/BWF - eRx xml utilities ; 8/3/2016 5:14pm
"RTN","PSOERXX1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520**;DEC 1997;Build 52
"RTN","PSOERXX1",3,0)
 ;
"RTN","PSOERXX1",4,0)
 Q
"RTN","PSOERXX1",5,0)
 ; PSOIEN - ien from 52.49 (erx holding queue)
"RTN","PSOERXX1",6,0)
 ; PSOSITE - site ien from the outpatient site file (59)
"RTN","PSOERXX1",7,0)
 ; REFILL REQUEST VIA THE ERX HOLDING QUEUE
"RTN","PSOERXX1",8,0)
RREQHQ(PSOIEN,PSOSITE) ;
"RTN","PSOERXX1",9,0)
 N ORNUM,RXIEN,PSSOUT,GBL,REFL,I,EXDT,PEND,PSSRET,CNT,DIR,Y
"RTN","PSOERXX1",10,0)
 S VALMBCK="R"
"RTN","PSOERXX1",11,0)
 Q:'PSOIEN
"RTN","PSOERXX1",12,0)
 D FULL^VALM1
"RTN","PSOERXX1",13,0)
 S ORNUM=$$GET1^DIQ(52.49,PSOIEN,.12,"I") I 'ORNUM W !!,"No OE/RR order number. Cannot create renewal request." D DIRE Q
"RTN","PSOERXX1",14,0)
 S PEND=$O(^PS(52.41,"B",ORNUM,0))
"RTN","PSOERXX1",15,0)
 S RXIEN=$O(^PSRX("APL",ORNUM,0))
"RTN","PSOERXX1",16,0)
 I PEND,'RXIEN W !!,"RX appears to be in Pending Outpatient Orders, but not yet processed to",!,"backdoor orders." D DIRE Q
"RTN","PSOERXX1",17,0)
 I 'PEND,'RXIEN W !!,"Cannot resolve RX#. Please ensure the prescription is in the prescription file."  D DIRE Q
"RTN","PSOERXX1",18,0)
 ;/BLB/ PSO*7.0*520 - correct typo in the word "prescription" - BEGIN CHANGE
"RTN","PSOERXX1",19,0)
 S EXDT=$$GET1^DIQ(52,RXIEN,26,"I") I EXDT<DT W !!,"Medication has expired, cannot renew prescription." D DIRE Q
"RTN","PSOERXX1",20,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXX1",21,0)
 S REFL=$$GET1^DIQ(52,RXIEN,9,"I"),I=0 F  S I=$O(^PSRX(RXIEN,1,I)) Q:'I  S REFL=REFL-1
"RTN","PSOERXX1",22,0)
 ; When renewal/refill request is being used, re-activate the following line of code
"RTN","PSOERXX1",23,0)
 ;I REFL>0 W !!,"Refills remaining for this prescription. Cannot create refill request." D DIRE Q
"RTN","PSOERXX1",24,0)
 W !!,"Would you like to send a refill (renewal) request to the prescriber"
"RTN","PSOERXX1",25,0)
 S DIR(0)="YO" D ^DIR
"RTN","PSOERXX1",26,0)
 I Y<1 Q
"RTN","PSOERXX1",27,0)
 S GBL=$$RREQ(PSOIEN,RXIEN,ORNUM,PSOSITE) I '$O(@GBL@(0)) W !!,"Could not create outgoing renewal message structure." D DIRE Q
"RTN","PSOERXX1",28,0)
 S PSSRET=$$RESTPOST^PSOERXO1(.PSSRET,.GBL)
"RTN","PSOERXX1",29,0)
 ; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERXX1",30,0)
 I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",31,0)
 I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",32,0)
 W !!,"Renewal Request sent." S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXX1",33,0)
 K @GBL
"RTN","PSOERXX1",34,0)
 Q
"RTN","PSOERXX1",35,0)
 ; CHANGE REQUEST VIA ERX HOLDING QUEUE
"RTN","PSOERXX1",36,0)
CREQHQ(PSOIEN) ;
"RTN","PSOERXX1",37,0)
 N ORNUM,RXIEN,DRUG,GBL,DROK,PSSRET,CNT
"RTN","PSOERXX1",38,0)
 Q:'PSOIEN
"RTN","PSOERXX1",39,0)
 ; IF THIS HASN'T BEEN SENT TO THE PRESCRIPTION FILE, WE DONT NEED ORDER OR RXIEN
"RTN","PSOERXX1",40,0)
 S ORNUM=$$GET1^DIQ(52.49,PSOIEN,.12,"I") I 'ORNUM W !!,"This order has been Accepted from eRx and cannot be changed." D DIRE Q
"RTN","PSOERXX1",41,0)
 S RXIEN=$O(^PSRX("APL",ORNUM,0)) I 'RXIEN W !!,"A current prescription exists for this eRx. Cannot change eRx." D DIRE Q
"RTN","PSOERXX1",42,0)
 ; build drug information into array to be passed into xml builder
"RTN","PSOERXX1",43,0)
 ; for future use
"RTN","PSOERXX1",44,0)
 ; may consider having the user fill in the drug validation screen then issue change request. Or replicate
"RTN","PSOERXX1",45,0)
 ; drug validation section into another 'Change Request' screen.
"RTN","PSOERXX1",46,0)
 S DROK=$$DRGPRMPT(.DRUG) I 'DROK W !!,"Insufficient drug information. Cannot create change request.",!,"Please try again." D DIRE Q
"RTN","PSOERXX1",47,0)
 S GBL=$$CREQ(PSOIEN,.DRUG) I '$L(GBL) W !!,"Could not create outgoing message structure." D DIRE Q
"RTN","PSOERXX1",48,0)
 S PSSRET=$$RESTPOST^PSOERXO1(.PSSRET,.GBL)
"RTN","PSOERXX1",49,0)
 ; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERXX1",50,0)
 I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",51,0)
 I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",52,0)
 W !!,"Change Request sent." S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXX1",53,0)
 K @GBL
"RTN","PSOERXX1",54,0)
 Q
"RTN","PSOERXX1",55,0)
 ; RXFILL MESSAGE
"RTN","PSOERXX1",56,0)
FMES(PSOIEN) ;
"RTN","PSOERXX1",57,0)
 N ORNUM,RXIEN,DRUG,GBL,FTYPE,PSSRET,CNT
"RTN","PSOERXX1",58,0)
 Q:'PSOIEN
"RTN","PSOERXX1",59,0)
 S ORNUM=$$GET1^DIQ(52.49,PSOIEN,.12,"I") I 'ORNUM W !!,"No OE/RR order number. Cannot create refill request." D DIRE Q
"RTN","PSOERXX1",60,0)
 S RXIEN=$O(^PSRX("APL",ORNUM,0)) I 'RXIEN W !!,"Could not resolve RX #. Please contact technical support." D DIRE Q
"RTN","PSOERXX1",61,0)
 ; FOR NOW SET NOTE AND FTYPE (FULL/PARTIAL) FOR BUILDING XML
"RTN","PSOERXX1",62,0)
 S NOTE="TESTING NOTE"
"RTN","PSOERXX1",63,0)
 S FTYPE="F"
"RTN","PSOERXX1",64,0)
 S GBL=$$RXFILL(PSOIEN,FTYPE,NOTE,RXIEN,ORNUM) I '$L(GBL) W !!,"Could not create outgoing message structure." D DIRE Q
"RTN","PSOERXX1",65,0)
 ;W !!,"RxFill message sent to prescriber." S DIR(0)="E" D ^DIR K DIR 
"RTN","PSOERXX1",66,0)
 S PSSRET=$$RESTPOST^PSOERXO1(.PSSRET,.GBL)
"RTN","PSOERXX1",67,0)
 ; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERXX1",68,0)
 I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",69,0)
 I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",70,0)
 W !!,"RxFill Message sent." S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXX1",71,0)
 K @GBL
"RTN","PSOERXX1",72,0)
 Q
"RTN","PSOERXX1",73,0)
 ; prompt for drug fields needed to create a change request - not currently used
"RTN","PSOERXX1",74,0)
DRGPRMPT(DRG) ;
"RTN","PSOERXX1",75,0)
 ; Prompt for drug
"RTN","PSOERXX1",76,0)
 N DIC,PSODRUG,DIR,Y
"RTN","PSOERXX1",77,0)
 S DIC(0)="AEMQ",DIC=50,DIC("S")="I $$ACTIVE^PSOERXA0(Y),($$OUTPAT^PSOERXA0(Y)),('$$INVCOMP^PSOERXA0(Y)),('$$CS^PSOERXA0(Y))" D ^DIC
"RTN","PSOERXX1",78,0)
 K DIC
"RTN","PSOERXX1",79,0)
 Q:$P(Y,U)<1 0
"RTN","PSOERXX1",80,0)
 ; FOR FUTURE USE - ADD ROUTE PROMPT
"RTN","PSOERXX1",81,0)
 ; Y=DRUG IEN^DRUG DESCRIPTION
"RTN","PSOERXX1",82,0)
 S DRG("DRUG")=$P(Y,U,2)
"RTN","PSOERXX1",83,0)
 S PSODRUG("IEN")=$P(Y,U)
"RTN","PSOERXX1",84,0)
 ; prompt for days supply
"RTN","PSOERXX1",85,0)
 K DIR S DIR(0)="52.49,20.2" D ^DIR
"RTN","PSOERXX1",86,0)
 Q:$P(Y,U)<1 0
"RTN","PSOERXX1",87,0)
 S DRG("DSUP")=Y
"RTN","PSOERXX1",88,0)
 ; prompt for quantity
"RTN","PSOERXX1",89,0)
 K DIR S DIR(0)="52.49,20.1" D ^DIR
"RTN","PSOERXX1",90,0)
 Q:$P(Y,U)<1 0
"RTN","PSOERXX1",91,0)
 S DRG("QTY")=Y
"RTN","PSOERXX1",92,0)
 ; prompt for refills
"RTN","PSOERXX1",93,0)
 K DIR S DIR(0)="52.49,20.5" D ^DIR
"RTN","PSOERXX1",94,0)
 Q:$P(Y,U)<1 0
"RTN","PSOERXX1",95,0)
 S DRG("REF")=Y
"RTN","PSOERXX1",96,0)
 ; prompt for directions
"RTN","PSOERXX1",97,0)
 K DIR S DIR(0)="52.49,7" D ^DIR
"RTN","PSOERXX1",98,0)
 Q:Y="^" 0
"RTN","PSOERXX1",99,0)
 Q:Y']"" 0
"RTN","PSOERXX1",100,0)
 S DRG("DIR")=Y
"RTN","PSOERXX1",101,0)
 Q 1
"RTN","PSOERXX1",102,0)
 ; CHANGE REQUEST VIA BACKDOOR ORDERS
"RTN","PSOERXX1",103,0)
CREQBD(RXIEN) ;
"RTN","PSOERXX1",104,0)
 Q
"RTN","PSOERXX1",105,0)
 ; CHANGE REQUEST VIA PSO LMOE FINISH
"RTN","PSOERXX1",106,0)
CREQPO(ORIEN) ;
"RTN","PSOERXX1",107,0)
 Q
"RTN","PSOERXX1",108,0)
RREQ(PSOIEN,RXIEN,ORNUM,PSOSITE) ;RefillRequest
"RTN","PSOERXX1",109,0)
 N GBL,PSOIENS,CNT
"RTN","PSOERXX1",110,0)
 Q:'PSOIEN ""
"RTN","PSOERXX1",111,0)
 S GBL=$NA(^TMP("RREQ^PSOERXX1",$J)) K @GBL
"RTN","PSOERXX1",112,0)
 S CNT=0
"RTN","PSOERXX1",113,0)
 D MSG^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",114,0)
 ; header
"RTN","PSOERXX1",115,0)
 D HDR^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",116,0)
 ; body header
"RTN","PSOERXX1",117,0)
 D BHF^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",118,0)
 ; request type header
"RTN","PSOERXX1",119,0)
 D RTYPE^PSOERXX2(.GBL,"RefillRequest",1)
"RTN","PSOERXX1",120,0)
 ; request info - not currently used
"RTN","PSOERXX1",121,0)
 ;D REQUEST^PSOERXX2(.GBL,"ACC","ACC")
"RTN","PSOERXX1",122,0)
 D VAPHARM^PSOERXX2(.GBL,PSOSITE,PSOIEN)
"RTN","PSOERXX1",123,0)
 D PRESCRIB^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",124,0)
 D SUPERVIS^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",125,0)
 D FACIL^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",126,0)
 D PATIENT^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",127,0)
 D MEDPRES^PSOERXX4(.GBL,PSOIEN)
"RTN","PSOERXX1",128,0)
 D MEDDIS^PSOERXX4(.GBL,RXIEN,ORNUM,PSOIEN)
"RTN","PSOERXX1",129,0)
 D OBSERVE^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",130,0)
 D BENEFITS^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",131,0)
 D DRUGEVAL^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",132,0)
 ;D DIAGNOS(.GBL,PSOIEN)
"RTN","PSOERXX1",133,0)
 D RTYPE^PSOERXX2(.GBL,"RefillRequest",2)
"RTN","PSOERXX1",134,0)
 D BHF^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",135,0)
 D MSG^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",136,0)
 Q GBL
"RTN","PSOERXX1",137,0)
 ; PSOIEN - erx IEN from 52.49
"RTN","PSOERXX1",138,0)
CREQ(PSOIEN,REQDRUG) ;ChangeRequest
"RTN","PSOERXX1",139,0)
 N GBL,PSOIENS,CNT
"RTN","PSOERXX1",140,0)
 Q:'PSOIEN ""
"RTN","PSOERXX1",141,0)
 S GBL=$NA(^TMP("CREQ^PSOERXX1",$J)) K @GBL
"RTN","PSOERXX1",142,0)
 S CNT=0
"RTN","PSOERXX1",143,0)
 D MSG^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",144,0)
 ; header
"RTN","PSOERXX1",145,0)
 D HDR^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",146,0)
 ; body header
"RTN","PSOERXX1",147,0)
 D BHF^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",148,0)
 ; request type header
"RTN","PSOERXX1",149,0)
 D RTYPE^PSOERXX2(.GBL,"ChangeRequest",1)
"RTN","PSOERXX1",150,0)
 ; request info
"RTN","PSOERXX1",151,0)
 D REQUEST^PSOERXX2(.GBL,"TST","TST")
"RTN","PSOERXX1",152,0)
 D VAPHARM^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",153,0)
 D PRESCRIB^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",154,0)
 D SUPERVIS^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",155,0)
 D FACIL^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",156,0)
 D PATIENT^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",157,0)
 D MEDPRES^PSOERXX4(.GBL,PSOIEN)
"RTN","PSOERXX1",158,0)
 D MEDREQ^PSOERXX4(.GBL,PSOIEN,.REQDRUG)
"RTN","PSOERXX1",159,0)
 D OBSERVE^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",160,0)
 D BENEFITS^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",161,0)
 D DRUGEVAL^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",162,0)
 D DIAGNOS^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",163,0)
 D RTYPE^PSOERXX2(.GBL,"ChangeRequest",2)
"RTN","PSOERXX1",164,0)
 D BHF^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",165,0)
 D MSG^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",166,0)
 Q GBL
"RTN","PSOERXX1",167,0)
 ; FP - full or partial fill (F/P)
"RTN","PSOERXX1",168,0)
 ; NOTE - fill notes
"RTN","PSOERXX1",169,0)
RXFILL(PSOIEN,FP,NOTE,RXIEN,ORNUM) ;
"RTN","PSOERXX1",170,0)
 N GBL,PSOIENS,CNT
"RTN","PSOERXX1",171,0)
 Q:'PSOIEN ""
"RTN","PSOERXX1",172,0)
 S GBL=$NA(^TMP("RXFILL^PSOERXX1",$J)) K @GBL
"RTN","PSOERXX1",173,0)
 S CNT=0
"RTN","PSOERXX1",174,0)
 D MSG^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",175,0)
 ; header
"RTN","PSOERXX1",176,0)
 D HDR^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",177,0)
 ; body header
"RTN","PSOERXX1",178,0)
 D BHF^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",179,0)
 ; request type header
"RTN","PSOERXX1",180,0)
 D RTYPE^PSOERXX2(.GBL,"RxFill",1)
"RTN","PSOERXX1",181,0)
 ; request info
"RTN","PSOERXX1",182,0)
 ;D REQUEST(.GBL,"TEST1","TEST2")
"RTN","PSOERXX1",183,0)
 ;FP - full or partial fill
"RTN","PSOERXX1",184,0)
 S FP="F"
"RTN","PSOERXX1",185,0)
 S NOTE=$G(NOTE,"TESTING NOTES")
"RTN","PSOERXX1",186,0)
 ; fill status
"RTN","PSOERXX1",187,0)
 D FILLST^PSOERXX3(.GBL,FP,NOTE)
"RTN","PSOERXX1",188,0)
 D VAPHARM^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",189,0)
 D PRESCRIB^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",190,0)
 D SUPERVIS^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",191,0)
 D FACIL^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",192,0)
 D PATIENT^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",193,0)
 D MEDPRES^PSOERXX4(.GBL,PSOIEN)
"RTN","PSOERXX1",194,0)
 D MEDDIS^PSOERXX4(.GBL,PSOIEN)
"RTN","PSOERXX1",195,0)
 D OBSERVE^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",196,0)
 D BENEFITS^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",197,0)
 D DRUGEVAL^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",198,0)
 ;D DIAGNOS^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",199,0)
 D RTYPE^PSOERXX2(.GBL,"RxFill",2)
"RTN","PSOERXX1",200,0)
 D BHF^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",201,0)
 D MSG^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",202,0)
 Q GBL
"RTN","PSOERXX1",203,0)
DIRE ;
"RTN","PSOERXX1",204,0)
 N DIR S DIR(0)="E" D ^DIR
"RTN","PSOERXX1",205,0)
 Q
"UP",52.49,52.4971,-1)
52.49^26
"UP",52.49,52.4971,0)
52.4971
"UP",52.49,52.4972,-1)
52.49^27
"UP",52.49,52.4972,0)
52.4972
"VER")
8.0^22.2
"^DD",52.46,52.46,.07,0)
GENDER^S^M:MALE;F:FEMALE;O:OTHER;N:NOT IDENTIFIED;U:UNKNOWN;^1;3^Q
"^DD",52.46,52.46,.07,3)
Enter the gender associated with the eRx external patient.
"^DD",52.46,52.46,.07,21,0)
^.001^1^1^3180122^^
"^DD",52.46,52.46,.07,21,1,0)
This is the patient gender.
"^DD",52.46,52.46,.07,"DT")
3180122
"^DD",52.49,52.49,70.1,0)
FACILITY NAME^FJ35^^22;6^K:$L(X)>35!($L(X)<1) X
"^DD",52.49,52.49,70.1,3)
Enter the facility Name associated with this eRx prescription. Must be 1-35 characters in length.
"^DD",52.49,52.49,70.1,21,0)
^.001^1^1^3180315^^^^
"^DD",52.49,52.49,70.1,21,1,0)
This is the facility name associated with the incoming eRx.
"^DD",52.49,52.49,70.1,"DT")
3180315
"^DD",52.49,52.49,70.2,0)
FACILITY ADDRESS LINE 1^FJ35^^22;7^K:$L(X)>35!($L(X)<1) X
"^DD",52.49,52.49,70.2,3)
Enter the address line 1 associated with the facility. Must be 1-35 characters in length.
"^DD",52.49,52.49,70.2,21,0)
^.001^1^1^3180315^^
"^DD",52.49,52.49,70.2,21,1,0)
This is the address line 1 associated with the facility.
"^DD",52.49,52.49,70.2,"DT")
3180315
"^DD",52.49,52.49,70.3,0)
FACILITY ADDRESS LINE 2^FJ35^^22;8^K:$L(X)>35!($L(X)<1) X
"^DD",52.49,52.49,70.3,3)
Enter the address line 2 associated with the facility. Must be 1-35 characters in length.
"^DD",52.49,52.49,70.3,21,0)
^.001^1^1^3180315^^^^
"^DD",52.49,52.49,70.3,21,1,0)
This is the address line 2 associated with the facility.
"^DD",52.49,52.49,70.3,"DT")
3180315
"^DD",52.49,52.49,70.4,0)
FACILITY CITY^FJ35^^23;1^K:$L(X)>35!($L(X)<1) X
"^DD",52.49,52.49,70.4,3)
Enter the city associated with the facility. Must be 1-35 characters in length.
"^DD",52.49,52.49,70.4,21,0)
^.001^1^1^3180315^^
"^DD",52.49,52.49,70.4,21,1,0)
This is the city associated with the facility.
"^DD",52.49,52.49,70.4,"DT")
3180315
"^DD",52.49,52.49,70.5,0)
FACILITY STATE^P5'^DIC(5,^25;3^Q
"^DD",52.49,52.49,70.5,3)
Enter the state associated with this facility.
"^DD",52.49,52.49,70.5,21,0)
^^1^1^3180315^
"^DD",52.49,52.49,70.5,21,1,0)
This is the state associated with the facility.
"^DD",52.49,52.49,70.5,"DT")
3180214
"^DD",52.49,52.49,70.6,0)
FACILITY ZIP CODE^FJ9^^25;4^K:$L(X)>9!($L(X)<5) X
"^DD",52.49,52.49,70.6,3)
Enter the zip code associated with the facility. Must be 5-9 digits in length.
"^DD",52.49,52.49,70.6,21,0)
^.001^1^1^3180315^^^^
"^DD",52.49,52.49,70.6,21,1,0)
This is the zip code associated with the facility.
"^DD",52.49,52.49,70.6,"DT")
3180315
"^DD",52.49,52.49,70.7,0)
PLACE LOCATION QUALIFIER^FJ3^^29;1^K:$L(X)>3!($L(X)<1) X
"^DD",52.49,52.49,70.7,3)
Enter the place location qualifier associated with the facility. Must be 1-3 characters in length.
"^DD",52.49,52.49,70.7,21,0)
^.001^1^1^3180315^^
"^DD",52.49,52.49,70.7,21,1,0)
This is the place location qualifier associated with the facility.
"^DD",52.49,52.49,70.7,"DT")
3180315
"^DD",52.49,52.49,71,0)
FACILITY IDENTIFICATION^52.4971A^^26;0
"^DD",52.49,52.49,71,21,0)
^.001^1^1^3180320^^^
"^DD",52.49,52.49,71,21,1,0)
This multiple contains information related to the eRx facility.
"^DD",52.49,52.49,72,0)
COMMUNICATION^52.4972A^^27;0
"^DD",52.49,52.49,72,21,0)
^^1^1^3180314^
"^DD",52.49,52.49,72,21,1,0)
This multiple contains information related to the eRx facility.
"^DD",52.49,52.4971,0)
FACILITY IDENTIFICATION SUB-FIELD^^.02^2
"^DD",52.49,52.4971,0,"NM","FACILITY IDENTIFICATION")

"^DD",52.49,52.4971,.01,0)
ID TYPE^FJ50^^0;1^K:$L(X)>50!($L(X)<3) X
"^DD",52.49,52.4971,.01,1,0)
^.1
"^DD",52.49,52.4971,.01,1,1,0)
52.4971^B
"^DD",52.49,52.4971,.01,1,1,1)
S ^PS(52.49,DA(1),26,"B",$E(X,1,30),DA)=""
"^DD",52.49,52.4971,.01,1,1,2)
K ^PS(52.49,DA(1),26,"B",$E(X,1,30),DA)
"^DD",52.49,52.4971,.01,3)
Enter the identification type. Answer must be 3-50 characters in length.
"^DD",52.49,52.4971,.01,21,0)
^^2^2^3180314^
"^DD",52.49,52.4971,.01,21,1,0)
This is the ID type associated with the communication value of the eRx 
"^DD",52.49,52.4971,.01,21,2,0)
faciilty.
"^DD",52.49,52.4971,.01,"DT")
3180214
"^DD",52.49,52.4971,.02,0)
ID VALUE^FJ35^^0;2^K:$L(X)>35!($L(X)<1) X
"^DD",52.49,52.4971,.02,3)
Enter the identification value. Answer must be 1-35 characters in length.
"^DD",52.49,52.4971,.02,21,0)
^^2^2^3180320^
"^DD",52.49,52.4971,.02,21,1,0)
This is the ID value associated with the communication value of the 
"^DD",52.49,52.4971,.02,21,2,0)
eRx facility.
"^DD",52.49,52.4971,.02,"DT")
3180214
"^DD",52.49,52.4972,0)
COMMUNICATION SUB-FIELD^^.02^2
"^DD",52.49,52.4972,0,"NM","COMMUNICATION")

"^DD",52.49,52.4972,.01,0)
COMMUNICATION^FJ80^^0;1^K:$L(X)>80!($L(X)<1) X
"^DD",52.49,52.4972,.01,1,0)
^.1
"^DD",52.49,52.4972,.01,1,1,0)
52.4972^B
"^DD",52.49,52.4972,.01,1,1,1)
S ^PS(52.49,DA(1),27,"B",$E(X,1,30),DA)=""
"^DD",52.49,52.4972,.01,1,1,2)
K ^PS(52.49,DA(1),27,"B",$E(X,1,30),DA)
"^DD",52.49,52.4972,.01,3)
Enter the value for the communication method. Answer must be 1-80 characters in length.
"^DD",52.49,52.4972,.01,21,0)
^^1^1^3180314^
"^DD",52.49,52.4972,.01,21,1,0)
This is the communication value associated with the eRx facility.
"^DD",52.49,52.4972,.01,"DT")
3180214
"^DD",52.49,52.4972,.02,0)
TYPE^S^BN:BEEPER;CP:CELLULAR;EM:ELECTRONIC MAIL;FX:FAX;HP:HOME PHONE;NP:NIGHT-TIME PHONE;TE:TELEPHONE;WP:WORK PHONE;^1;E1,2^Q
"^DD",52.49,52.4972,.02,3)
Enter the type associated with the supplied communication value.
"^DD",52.49,52.4972,.02,21,0)
^^1^1^3180314^
"^DD",52.49,52.4972,.02,21,1,0)
This is the type of communication associated with the eRx facility.
"^DD",52.49,52.4972,.02,"DT")
3180214
"BLD",9931,6)
^430
**END**
**END**

