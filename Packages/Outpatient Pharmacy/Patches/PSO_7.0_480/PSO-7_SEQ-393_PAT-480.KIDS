EMERGENCY Released PSO*7*480 SEQ #393
Extracted from mail message
**KIDS**:PSO*7.0*480^

**INSTALL NAME**
PSO*7.0*480
"BLD",9645,0)
PSO*7.0*480^OUTPATIENT PHARMACY^0^3170313^y
"BLD",9645,1,0)
^^8^8^3170303^
"BLD",9645,1,1,0)
There are multiple variables used for determining whether a patient will 
"BLD",9645,1,2,0)
be billed copay in Outpatient Pharmacy (i.e. Supply Item, Investigational 
"BLD",9645,1,3,0)
Drug, Nutritional Supplement, service connection, environment indicators, 
"BLD",9645,1,4,0)
IB billable flags, etc.).  They are used separately or in conjunction 
"BLD",9645,1,5,0)
with one another to determine if the prescription is billable.  For the 
"BLD",9645,1,6,0)
Domiciliary patients, IB has a specific check for Domiciliary and returns 
"BLD",9645,1,7,0)
the exempt status; however, OP did not have one of three flags defined 
"BLD",9645,1,8,0)
correctly to exempt prescriptions from copay.
"BLD",9645,4,0)
^9.64PA^^
"BLD",9645,6)
1^
"BLD",9645,6.3)
35
"BLD",9645,"ABPKG")
n
"BLD",9645,"INID")
^n
"BLD",9645,"INIT")
EN^PSO480P
"BLD",9645,"KRN",0)
^9.67PA^779.2^20
"BLD",9645,"KRN",.4,0)
.4
"BLD",9645,"KRN",.401,0)
.401
"BLD",9645,"KRN",.402,0)
.402
"BLD",9645,"KRN",.403,0)
.403
"BLD",9645,"KRN",.5,0)
.5
"BLD",9645,"KRN",.84,0)
.84
"BLD",9645,"KRN",3.6,0)
3.6
"BLD",9645,"KRN",3.8,0)
3.8
"BLD",9645,"KRN",9.2,0)
9.2
"BLD",9645,"KRN",9.8,0)
9.8
"BLD",9645,"KRN",9.8,"NM",0)
^9.68A^13^6
"BLD",9645,"KRN",9.8,"NM",1,0)
PSOCP^^0^B81967302
"BLD",9645,"KRN",9.8,"NM",3,0)
PSOCPBAK^^0^B43718412
"BLD",9645,"KRN",9.8,"NM",4,0)
PSOCPBK1^^0^B89608216
"BLD",9645,"KRN",9.8,"NM",5,0)
PSOCPBK4^^0^B93078909
"BLD",9645,"KRN",9.8,"NM",12,0)
PSOCPIBC^^0^B49888146
"BLD",9645,"KRN",9.8,"NM",13,0)
PSOCP1^^0^B5455566
"BLD",9645,"KRN",9.8,"NM","B","PSOCP",1)

"BLD",9645,"KRN",9.8,"NM","B","PSOCP1",13)

"BLD",9645,"KRN",9.8,"NM","B","PSOCPBAK",3)

"BLD",9645,"KRN",9.8,"NM","B","PSOCPBK1",4)

"BLD",9645,"KRN",9.8,"NM","B","PSOCPBK4",5)

"BLD",9645,"KRN",9.8,"NM","B","PSOCPIBC",12)

"BLD",9645,"KRN",19,0)
19
"BLD",9645,"KRN",19.1,0)
19.1
"BLD",9645,"KRN",101,0)
101
"BLD",9645,"KRN",409.61,0)
409.61
"BLD",9645,"KRN",771,0)
771
"BLD",9645,"KRN",779.2,0)
779.2
"BLD",9645,"KRN",870,0)
870
"BLD",9645,"KRN",8989.51,0)
8989.51
"BLD",9645,"KRN",8989.52,0)
8989.52
"BLD",9645,"KRN",8994,0)
8994
"BLD",9645,"KRN","B",.4,.4)

"BLD",9645,"KRN","B",.401,.401)

"BLD",9645,"KRN","B",.402,.402)

"BLD",9645,"KRN","B",.403,.403)

"BLD",9645,"KRN","B",.5,.5)

"BLD",9645,"KRN","B",.84,.84)

"BLD",9645,"KRN","B",3.6,3.6)

"BLD",9645,"KRN","B",3.8,3.8)

"BLD",9645,"KRN","B",9.2,9.2)

"BLD",9645,"KRN","B",9.8,9.8)

"BLD",9645,"KRN","B",19,19)

"BLD",9645,"KRN","B",19.1,19.1)

"BLD",9645,"KRN","B",101,101)

"BLD",9645,"KRN","B",409.61,409.61)

"BLD",9645,"KRN","B",771,771)

"BLD",9645,"KRN","B",779.2,779.2)

"BLD",9645,"KRN","B",870,870)

"BLD",9645,"KRN","B",8989.51,8989.51)

"BLD",9645,"KRN","B",8989.52,8989.52)

"BLD",9645,"KRN","B",8994,8994)

"BLD",9645,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9645,"QUES",0)
^9.62^^
"BLD",9645,"REQB",0)
^9.611^4^4
"BLD",9645,"REQB",1,0)
PSO*7.0*476^2
"BLD",9645,"REQB",2,0)
PSO*7.0*225^1
"BLD",9645,"REQB",3,0)
PSO*7.0*268^1
"BLD",9645,"REQB",4,0)
PSO*7.0*215^1
"BLD",9645,"REQB","B","PSO*7.0*215",4)

"BLD",9645,"REQB","B","PSO*7.0*225",2)

"BLD",9645,"REQB","B","PSO*7.0*268",3)

"BLD",9645,"REQB","B","PSO*7.0*476",1)

"INIT")
EN^PSO480P
"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
480^3170313^11951
"PKG",141,22,1,"PAH",1,1,0)
^^8^8^3170313
"PKG",141,22,1,"PAH",1,1,1,0)
There are multiple variables used for determining whether a patient will 
"PKG",141,22,1,"PAH",1,1,2,0)
be billed copay in Outpatient Pharmacy (i.e. Supply Item, Investigational 
"PKG",141,22,1,"PAH",1,1,3,0)
Drug, Nutritional Supplement, service connection, environment indicators, 
"PKG",141,22,1,"PAH",1,1,4,0)
IB billable flags, etc.).  They are used separately or in conjunction 
"PKG",141,22,1,"PAH",1,1,5,0)
with one another to determine if the prescription is billable.  For the 
"PKG",141,22,1,"PAH",1,1,6,0)
Domiciliary patients, IB has a specific check for Domiciliary and returns 
"PKG",141,22,1,"PAH",1,1,7,0)
the exempt status; however, OP did not have one of three flags defined 
"PKG",141,22,1,"PAH",1,1,8,0)
correctly to exempt prescriptions from copay.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","PSO480P")
0^^B127919865^n/a
"RTN","PSO480P",1,0)
PSO480P ;BIR/PC-Automatic Cancel of Copay charges for DOM ;03/02/17 10:30am
"RTN","PSO480P",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**480**;DEC 1997;Build 35
"RTN","PSO480P",3,0)
 ;
"RTN","PSO480P",4,0)
 ;Reference to ^IB(350 supported by DBIA 2215
"RTN","PSO480P",5,0)
 ;
"RTN","PSO480P",6,0)
 ;This routine will run as a post-install for patch PSO*7*480
"RTN","PSO480P",7,0)
 ;and will loop through the prescription file by release date/time
"RTN","PSO480P",8,0)
 ;to find all prescriptions for patients logged in as inpatient
"RTN","PSO480P",9,0)
 ;assigned to a DOMICILIARY ward at release date of prescription.
"RTN","PSO480P",10,0)
 ;It will then cancel any copay that was charged by mistake with patch PSO*7*460 (FMCT)
"RTN","PSO480P",11,0)
 ; Both original and refills charges will be cancelled if needed.
"RTN","PSO480P",12,0)
 ;
"RTN","PSO480P",13,0)
 ;Detailed and summary reports will be sent to mailman at site.
"RTN","PSO480P",14,0)
 Q
"RTN","PSO480P",15,0)
 ;
"RTN","PSO480P",16,0)
 ;going to need an entry point for when the routine is jobbed off during install
"RTN","PSO480P",17,0)
EN ;
"RTN","PSO480P",18,0)
 N NAMSP,DTOUT,DUOUT,ZTSK,ZTRTN,ZTIO,ZTDTH,ZTDESC,QUIT,RUNOPT,JOBN,Y,YY,ZTSAVE,VAINDT,VAIN,TITLE,LIFE,BEGDT
"RTN","PSO480P",19,0)
 S NAMSP="",NAMSP=$T(+0)
"RTN","PSO480P",20,0)
 S LIFE=90,TITLE="FMCT Cancel DOMICILIARY Prescription Copay Charges - PSO*7*480"
"RTN","PSO480P",21,0)
 S BEGDT=$$NOW^XLFDT(),PURGDT=$$FMADD^XLFDT(BEGDT,LIFE)
"RTN","PSO480P",22,0)
 S ^XTMP(NAMSP,0)=PURGDT_"^"_BEGDT_"^"_TITLE
"RTN","PSO480P",23,0)
 S JOBN="FMCT DOMICILIARY CANCEL COPAYS"
"RTN","PSO480P",24,0)
 L +^XTMP(NAMSP):0 I '$T D  Q
"RTN","PSO480P",25,0)
 . D BMES^XPDUTL(JOBN_" job is already running.  Halting...")
"RTN","PSO480P",26,0)
 . D MES^XPDUTL("")
"RTN","PSO480P",27,0)
 . D QUIT
"RTN","PSO480P",28,0)
 ;
"RTN","PSO480P",29,0)
START ;
"RTN","PSO480P",30,0)
 ;initialize ^XTMP file according to SAC standard
"RTN","PSO480P",31,0)
 ;
"RTN","PSO480P",32,0)
 S QUIT=0
"RTN","PSO480P",33,0)
 ;
"RTN","PSO480P",34,0)
 I $G(^XTMP(NAMSP,0,"LAST"))["COMPLETED" D  Q
"RTN","PSO480P",35,0)
 . W !!,*7,"This job previously ran to completion on "
"RTN","PSO480P",36,0)
 . W $$FMTE^XLFDT($P($G(^XTMP(NAMSP,0,"LAST")),"^",2)),!!
"RTN","PSO480P",37,0)
 . D QUIT
"RTN","PSO480P",38,0)
 ;
"RTN","PSO480P",39,0)
 ;ques 2, if running from mumps prompt
"RTN","PSO480P",40,0)
 S Y=$$NOW^XLFDT S ZTDTH=$$FMTH^XLFDT(Y)
"RTN","PSO480P",41,0)
 ;
"RTN","PSO480P",42,0)
 ;ques 2, if running from kids install
"RTN","PSO480P",43,0)
 I $D(XPDQUES("POS2")) S ZTDTH=$$FMTH^XLFDT(XPDQUES("POS2"))
"RTN","PSO480P",44,0)
 ;
"RTN","PSO480P",45,0)
 D BMES^XPDUTL("===================================================")
"RTN","PSO480P",46,0)
 D MES^XPDUTL("Queuing background job to "_JOBN_"...")
"RTN","PSO480P",47,0)
 D MES^XPDUTL("Start time: "_$$HTE^XLFDT(ZTDTH))
"RTN","PSO480P",48,0)
 D MES^XPDUTL("===================================================")
"RTN","PSO480P",49,0)
 I $D(XPDQUES("POS2")) I ZTDTH="" D BMES^XPDUTL(JOBN_" NOT QUEUED") D QUIT Q
"RTN","PSO480P",50,0)
 ;
"RTN","PSO480P",51,0)
 S:$D(^XTMP(NAMSP,0,"LAST")) ^XTMP(NAMSP,0,"ZAUDIT",$H)="RE-STARTED ON"_"^"_$$NOW^XLFDT_"^"_$P(^XTMP(NAMSP,0,"LAST"),"^",2,5)
"RTN","PSO480P",52,0)
 ;
"RTN","PSO480P",53,0)
 S ZTRTN="START1^PSO480P",ZTIO=""
"RTN","PSO480P",54,0)
 S ZTDESC="Background job for "_JOBN_"."
"RTN","PSO480P",55,0)
 S ZTSAVE("JOBN")="",ZTSAVE("NAMSP")=""
"RTN","PSO480P",56,0)
 L -^XTMP(NAMSP)
"RTN","PSO480P",57,0)
 D ^%ZTLOAD
"RTN","PSO480P",58,0)
 D:$D(ZTSK)
"RTN","PSO480P",59,0)
 . D MES^XPDUTL("*** Task #"_ZTSK_" Queued! ***")
"RTN","PSO480P",60,0)
 . D BMES^XPDUTL("")
"RTN","PSO480P",61,0)
 D BMES^XPDUTL("")
"RTN","PSO480P",62,0)
 K XPDQUES
"RTN","PSO480P",63,0)
 Q
"RTN","PSO480P",64,0)
 ;
"RTN","PSO480P",65,0)
QUIT ;
"RTN","PSO480P",66,0)
 L -^XTMP(NAMSP)
"RTN","PSO480P",67,0)
 K %,ZTSAVE,VAIN,PSO,PREA,PSOARBN,PSOAT,PSOBILLD,PSOCOMM,PSODA,PSODAYS,PSODT,PSOFILL1,PSOFLAG,PSOIBDAT,PSOINSTL,PSOISTAT,PSONML,PSONW,PSOOIB,PSOOLD,PSOIBN
"RTN","PSO480P",68,0)
 K PSOINST,PSOPAR,PSOPAR7,PSORX,PSOSITE,PSOSITE7,PSOSTAT,PSOTAMT,PSOREF
"RTN","PSO480P",69,0)
 Q
"RTN","PSO480P",70,0)
 ;
"RTN","PSO480P",71,0)
START1 ;
"RTN","PSO480P",72,0)
 ;initialize ^XTMP file according to SAC standard
"RTN","PSO480P",73,0)
 N BEGDT,PURGDT,LIFE,NAMSP,PSOIB,CHKCAN,PSOSTART,PSOEND,PSOTDOL,PSOTRX,PSOTMRX,PSOTPAT,RXP,X,XX,JJ,PSORXE,PSOFILL,PSOFILL1,PSOREF
"RTN","PSO480P",74,0)
 S NAMSP="",NAMSP=$T(+0)
"RTN","PSO480P",75,0)
 D NOW^%DTC S Y=% D DD^%DT S PSOSTART=Y
"RTN","PSO480P",76,0)
 S LIFE=90,TITLE="FMCT Cancel DOMICILIARY Prescription Copay Charges - PSO*7*480"
"RTN","PSO480P",77,0)
 S BEGDT=$$NOW^XLFDT(),PURGDT=$$FMADD^XLFDT(BEGDT,LIFE),NAMSP=$T(+0)
"RTN","PSO480P",78,0)
 K ^XTMP(NAMSP) S ^XTMP(NAMSP,0)=PURGDT_"^"_BEGDT_"^"_TITLE
"RTN","PSO480P",79,0)
 ;
"RTN","PSO480P",80,0)
INST ;get first install date for FMCT patch PSO*7*460 which will be the begin date for checking for DOMICILIARY copay charges
"RTN","PSO480P",81,0)
 N DATA,PSOINSTD,PSORDT,PSOEDT,PSODOM,PSODFN,DFN,PSODATA,POSIB,PSOIBN
"RTN","PSO480P",82,0)
 S (X,XX,DATA)="",X=$$INSTALDT^XPDUTL("PSO*7.0*460",.DATA)
"RTN","PSO480P",83,0)
 S PSOINSTD="",PSOINSTD=$O(DATA(PSOINSTD))
"RTN","PSO480P",84,0)
 ;
"RTN","PSO480P",85,0)
LOOP ;loop through AL cross reference
"RTN","PSO480P",86,0)
 S:'$D(NAMSP) NAMSP=$T(+0)
"RTN","PSO480P",87,0)
 S PSORDT=PSOINSTD\1-.00001,(RXP,PSOFILL)=""
"RTN","PSO480P",88,0)
 F  S PSORDT=$O(^PSRX("AL",PSORDT)) Q:PSORDT=""  F  S RXP=$O(^PSRX("AL",PSORDT,RXP)) Q:RXP=""  D
"RTN","PSO480P",89,0)
 . F  S PSOFILL=$O(^PSRX("AL",PSORDT,RXP,PSOFILL)) Q:PSOFILL=""  D
"RTN","PSO480P",90,0)
 ..S (PSODFN,DFN,PSODA)=$$GET1^DIQ(52,RXP,2,"I"),VAINDT=PSORDT
"RTN","PSO480P",91,0)
 ..S PSODOM=0 D INP^VADPT
"RTN","PSO480P",92,0)
 ..I $D(VAIN(4)),$D(^DIC(42,+VAIN(4),0)),$P(^(0),"^",3)="D" S PSODOM=1
"RTN","PSO480P",93,0)
 ..Q:'PSODOM  ;not a DOMICILIARY
"RTN","PSO480P",94,0)
 ..S PSOREF=PSOFILL
"RTN","PSO480P",95,0)
 ..S PSOIB=0 D CHECK    ;check if Rx is billed 
"RTN","PSO480P",96,0)
 ..Q:'PSOIB   ;if PSOIB=1 Rx is billed
"RTN","PSO480P",97,0)
 ..K PSODATA
"RTN","PSO480P",98,0)
 ..I PSOFILL=0 D ZERO
"RTN","PSO480P",99,0)
 ..I PSOFILL>0 D REFILL
"RTN","PSO480P",100,0)
 ..D GETIB   ;retrieve IB Action file info and store in XTMP
"RTN","PSO480P",101,0)
 ..D CANCEL  ;cancel copay
"RTN","PSO480P",102,0)
 ..D CHKCAN  ;verify that cancel copay worked
"RTN","PSO480P",103,0)
 D REPORT
"RTN","PSO480P",104,0)
 D MAIL
"RTN","PSO480P",105,0)
 Q
"RTN","PSO480P",106,0)
 ;
"RTN","PSO480P",107,0)
CHECK ;check IB nodes
"RTN","PSO480P",108,0)
 ; see if bill already exists - returned value of PSOIB1 means Rx is billed
"RTN","PSO480P",109,0)
 I PSOFILL=0,+$P($G(^PSRX(RXP,"IB")),"^",2)>0 D CHKIB^PSOCP1
"RTN","PSO480P",110,0)
 I PSOFILL>0,+$G(^PSRX(RXP,1,PSOFILL,"IB")) D CHKIB^PSOCP1
"RTN","PSO480P",111,0)
 Q
"RTN","PSO480P",112,0)
 ;
"RTN","PSO480P",113,0)
ZERO ;
"RTN","PSO480P",114,0)
 ;get prescription information
"RTN","PSO480P",115,0)
 D GETS^DIQ(52,RXP_",","3;31;106","I","PSODATA")
"RTN","PSO480P",116,0)
 S:$G(PSODATA(52,RXP_",",3,"I")) PSOSTAT=PSODATA(52,RXP_",",3,"I")
"RTN","PSO480P",117,0)
 S:$G(PSODATA(52,RXP_",",106,"I")) PSOIBN=PSODATA(52,RXP_",",106,"I")
"RTN","PSO480P",118,0)
 Q
"RTN","PSO480P",119,0)
 ;
"RTN","PSO480P",120,0)
REFILL ;
"RTN","PSO480P",121,0)
 D GETS^DIQ(52.1,PSOFILL_","_RXP_",",".01;3;9","I","PSODATA")
"RTN","PSO480P",122,0)
 S:$G(PSODATA(52.1,PSOFILL_","_RXP_",",3,"I")) (DFN,PSODFN)=PSODATA(52.1,PSOFILL_","_RXP_",",3,"I")
"RTN","PSO480P",123,0)
 S:$G(PSODATA(52.1,PSOFILL_","_RXP_",",9,"I")) PSOIBN=PSODATA(52.1,PSOFILL_","_RXP_",",9,"I")
"RTN","PSO480P",124,0)
 Q
"RTN","PSO480P",125,0)
 ;
"RTN","PSO480P",126,0)
GETIB ;get billing information from IB Billing Action file #350
"RTN","PSO480P",127,0)
 D GETS^DIQ(350,PSOIBN,".03;.05;.07;.11;.13","IE","PSOIBDAT")
"RTN","PSO480P",128,0)
 S (PSOAT,PSOISTAT,PSOTAMT,PSOARBN,PSOINST)=""
"RTN","PSO480P",129,0)
 S:$G(PSOIBDAT(350,PSOIBN_",",.03,"E"))'="" PSOAT=PSOIBDAT(350,PSOIBN_",",.03,"E")    ;ACTION TYPE
"RTN","PSO480P",130,0)
 S:$G(PSOIBDAT(350,PSOIBN_",",.05,"E"))'="" PSOISTAT=PSOIBDAT(350,PSOIBN_",",.05,"E") ;STATUS
"RTN","PSO480P",131,0)
 S:$G(PSOIBDAT(350,PSOIBN_",",.07,"E"))'="" PSOTAMT=PSOIBDAT(350,PSOIBN_",",.07,"E")  ;TOTAL CHARGE
"RTN","PSO480P",132,0)
 S:$G(PSOIBDAT(350,PSOIBN_",",.11,"E"))'="" PSOARBN=PSOIBDAT(350,PSOIBN_",",.11,"E")  ;AR BILLING NUMBER
"RTN","PSO480P",133,0)
 S:$G(PSOIBDAT(350,PSOIBN_",",.13,"E"))'="" PSOINST=PSOIBDAT(350,PSOIBN_",",.13,"I")  ;INSTITUTION
"RTN","PSO480P",134,0)
 ;
"RTN","PSO480P",135,0)
 ;save data in XTMP file
"RTN","PSO480P",136,0)
 S ^XTMP(NAMSP,"DOM",PSORDT,PSODFN,RXP,PSOFILL)=PSOAT_"^"_PSOISTAT_"^"_PSOTAMT_"^"_PSOARBN_"^"_PSOINST
"RTN","PSO480P",137,0)
 Q
"RTN","PSO480P",138,0)
 ;
"RTN","PSO480P",139,0)
CANCEL ;cancel copay
"RTN","PSO480P",140,0)
 ;  verify again that it was billed and not already cancelled
"RTN","PSO480P",141,0)
 S PSOBILLD=0,YY=PSOREF,PSOIB=0
"RTN","PSO480P",142,0)
 I YY=0,+$P($G(^PSRX(RXP,"IB")),"^",2)>0 D CHKIB^PSOCP1 I $G(PSOIB)=1!($G(PSOIB)=3) S PSOBILLD=1
"RTN","PSO480P",143,0)
 I YY>0,+$P($G(^PSRX(RXP,1,PSOREF,"IB")),"^")>0 D CHKIB^PSOCP1 I $G(PSOIB)=1!($G(PSOIB)=3) S PSOBILLD=1
"RTN","PSO480P",144,0)
 Q:'PSOBILLD
"RTN","PSO480P",145,0)
 ;
"RTN","PSO480P",146,0)
 D NOW^%DTC S PSODT=%,PSODA=RXP,PSOCOMM="- FMCT DOM COPAY CANCEL",PSOOLD="",PSONW="",PREA=""
"RTN","PSO480P",147,0)
 I PSOREF=0 D CHKACT
"RTN","PSO480P",148,0)
 S PSOIB="",PSOIB=$S(PSOREF>0:$G(^PSRX(RXP,1,YY,"IB")),'PSOREF:$G(^PSRX(PSODA,"IB")),1:"")
"RTN","PSO480P",149,0)
 S PSOOIB="",PSOOIB=$G(^PSRX(RXP,"IB"))
"RTN","PSO480P",150,0)
 D SITE S PSOCOMM="- FMCT DOM COPAY CANCEL"
"RTN","PSO480P",151,0)
 ;PSOCPA requires PSODA,PSO,PSODAYS,PSOFLAG
"RTN","PSO480P",152,0)
 S PSODA=RXP,PSOFLAG=0,PSO=3,PSODAYS=$$GET1^DIQ(52,RXP,8),PSOOLD="",PSONW="",PREA="C"
"RTN","PSO480P",153,0)
 D RXED^PSOCPA
"RTN","PSO480P",154,0)
 K:PSOREF=0 ^PSRX(RXP,"IB")          ;...Original Rx
"RTN","PSO480P",155,0)
 I PSOREF>0 D ACTLOG^PSOCPA K ^PSRX(RXP,1,PSOREF,"IB")
"RTN","PSO480P",156,0)
 Q
"RTN","PSO480P",157,0)
 ;
"RTN","PSO480P",158,0)
SITE ; SET UP VARIABLES NEEDED BY BILLING
"RTN","PSO480P",159,0)
 S PSOSITE=$S(YY=0:$P(^PSRX(RXP,2),"^",9),1:$P($G(^PSRX(RXP,1,YY,0)),"^",9))
"RTN","PSO480P",160,0)
 Q:PSOSITE=""
"RTN","PSO480P",161,0)
 S PSOPAR=$G(^PS(59,PSOSITE,1))
"RTN","PSO480P",162,0)
 S PSOPAR7=$G(^PS(59,PSOSITE,"IB"))
"RTN","PSO480P",163,0)
 S PSOSITE7=$P($G(^PS(59,PSOSITE,"IB")),"^")
"RTN","PSO480P",164,0)
 Q
"RTN","PSO480P",165,0)
 ;
"RTN","PSO480P",166,0)
CHKACT ;check activity log for prev entry
"RTN","PSO480P",167,0)
 N ZACT,ZPSI,ZACTI
"RTN","PSO480P",168,0)
 S ZPSI=0 F  S ZPSI=$O(^PSRX(PSODA,"COPAY",ZPSI)) Q:ZPSI=""  S ZACTI="",ZACTI=$G(^PSRX(PSODA,"COPAY",ZPSI,0))
"RTN","PSO480P",169,0)
 S PSOREF=0,PSOOLD="Copay",PSONW="No Copay",PREA="R" D ACTLOG^PSOCPA S PSOREF=PSOFILL
"RTN","PSO480P",170,0)
 Q
"RTN","PSO480P",171,0)
 ;
"RTN","PSO480P",172,0)
CHKCAN ;verify that cancel copay worked
"RTN","PSO480P",173,0)
 D CHECK
"RTN","PSO480P",174,0)
 I PSOIB S ^XTMP(NAMSP,"CANCEL PROBLEM",PSORDT,RXP,PSOFILL)=""
"RTN","PSO480P",175,0)
 Q
"RTN","PSO480P",176,0)
 ;
"RTN","PSO480P",177,0)
REPORT ;accumulate reports information for national and local
"RTN","PSO480P",178,0)
 ;S ^XTMP(NAMSP,"DOM",PSORDT,PSODFN,PSORX,PSOFILL)=PSOAT_"^"_PSOISTAT_"^"_PSOTAMT_"^"_PSOARBN_"^"_PSOINST
"RTN","PSO480P",179,0)
 K ^TMP($J,"FMCT DOM MSG")
"RTN","PSO480P",180,0)
 S (XX,JJ,PSORDT,PSODFN,PSORX,PSORXE,PSOTDOL,PSOTRX,PSOTMRX,PSOTPAT,PSOAT,PSOISTAT,PSOTAMT,PSOARBN,PSOINST)=""
"RTN","PSO480P",181,0)
 S (PSOTPAT,PSOTDOL,PSOTAMT)=0
"RTN","PSO480P",182,0)
 S ^TMP($J,"FMCT DOM MSG",1)="PSO*7*480 FMCT DOMICILIARY CANCEL COPAY - Detailed Listing"
"RTN","PSO480P",183,0)
 S ^TMP($J,"FMCT DOM MSG",2)="     RELEASE DATE          PATIENT                   RX #      FILL #          IB ACTION TYPE      TTL AMT    AR BILL #   INST"
"RTN","PSO480P",184,0)
 S JJ=2
"RTN","PSO480P",185,0)
 F  S PSORDT=$O(^XTMP(NAMSP,"DOM",PSORDT)) Q:PSORDT=""  F  S PSODFN=$O(^XTMP(NAMSP,"DOM",PSORDT,PSODFN)) Q:PSODFN=""  S PSOTPAT=PSOTPAT+1 D
"RTN","PSO480P",186,0)
 .F  S PSORX=$O(^XTMP(NAMSP,"DOM",PSORDT,PSODFN,PSORX)) Q:PSORX=""  S PSOTRX=PSOTRX+1 D
"RTN","PSO480P",187,0)
 ..F  S PSOFILL=$O(^XTMP(NAMSP,"DOM",PSORDT,PSODFN,PSORX,PSOFILL)) Q:PSOFILL=""  D
"RTN","PSO480P",188,0)
 ...S XX=^XTMP(NAMSP,"DOM",PSORDT,PSODFN,PSORX,PSOFILL)
"RTN","PSO480P",189,0)
 ...S PSOAT=$P(XX,"^"),PSOISTAT=$P(XX,"^",2),PSOTAMT=$P(XX,"^",3),PSOARBN=$P(XX,"^",4),PSOINST=$P(XX,"^",5),PSOFILL1=PSOFILL
"RTN","PSO480P",190,0)
 ...S PSOTDOL=PSOTDOL+PSOTAMT,PSORXE=$P(^PSRX(PSORX,0),"^",1)
"RTN","PSO480P",191,0)
 ...S JJ=JJ+1 S PSONAM=$P(^DPT(PSODFN,0),"^",1),PSONML=$L(PSONAM),$P(PSONAM," ",21-PSONML)=""
"RTN","PSO480P",192,0)
 ...S ^TMP($J,"FMCT DOM MSG",JJ)=$J($$FMTE^XLFDT(PSORDT),21)_"  "_PSONAM_"  "_$J(PSORXE,15)_"    "_$J(PSOFILL1,2)_"  "_$J(PSOAT,30)_"  "_$J(PSOTAMT_".00",6)_"    "_$J(PSOARBN,6)_"  "_PSOINST
"RTN","PSO480P",193,0)
 Q
"RTN","PSO480P",194,0)
 ;
"RTN","PSO480P",195,0)
MAIL ;email reports
"RTN","PSO480P",196,0)
 ;
"RTN","PSO480P",197,0)
MAIL1 ;management mail message for total patients and dollars
"RTN","PSO480P",198,0)
 N XMX S PSOINST=$P($G(^DIC(4,+$P($G(^XMB(1,1,"XUS")),"^",17),99)),"^")
"RTN","PSO480P",199,0)
 D NOW^%DTC S Y=% D DD^%DT S PSOEND=Y
"RTN","PSO480P",200,0)
 K PSOTEXT
"RTN","PSO480P",201,0)
 S XMY(DUZ)=DUZ
"RTN","PSO480P",202,0)
 S XMDUZ="noreply.domain.ext"
"RTN","PSO480P",203,0)
 S XMY("ELLZEY.LINDA@FORUM.DOMAIN.EXT")=""
"RTN","PSO480P",204,0)
 S XMY("CROSSMAN.PAM@FORUM.DOMAIN.EXT")=""
"RTN","PSO480P",205,0)
 S XMY("PAMELA.CROSSMAN@DOMAIN.EXT")=""
"RTN","PSO480P",206,0)
 S XMY("LINDA.ELLZEY@DOMAIN.EXT")=""
"RTN","PSO480P",207,0)
 S XMY("PAMELA.GUNDERSON@DOMAIN.EXT")=""
"RTN","PSO480P",208,0)
 S XMY("AMY.VANEPPS@DOMAIN.EXT")=""
"RTN","PSO480P",209,0)
 S XMY("MITCHELL.FETTERMAN@DOMAIN.EXT")=""
"RTN","PSO480P",210,0)
 S XMX="PRCA ADJUSTMENT TRANS",XMY("G."_XMX_"@"_^XMB("NETNAME"))=""
"RTN","PSO480P",211,0)
 S:$$PROD^XUPROD(1) XMY("ELLZEY.LINDA@FORUM.DOMAIN.EXT")=""
"RTN","PSO480P",212,0)
 S XMDUZ="noreply.domain.ext"
"RTN","PSO480P",213,0)
 S XMSUB="STATION "_$G(PSOINST)
"RTN","PSO480P",214,0)
 S XMSUB=XMSUB_$S($$PROD^XUPROD(1):" (Prod)",1:" (Test)")
"RTN","PSO480P",215,0)
 S XMSUB=XMSUB_"PSO*7*480 FMCT DOMICILIARY CANCEL COPAY"
"RTN","PSO480P",216,0)
 S PSOTEXT(1)=""
"RTN","PSO480P",217,0)
 S PSOTEXT(2)="Post install started "_PSOSTART_" and completed "_PSOEND_"."
"RTN","PSO480P",218,0)
 S PSOTEXT(3)=""
"RTN","PSO480P",219,0)
 S PSOTEXT(4)="Summary for Domiciliary Patients with copay cancellations:"
"RTN","PSO480P",220,0)
 S PSOTEXT(5)=""
"RTN","PSO480P",221,0)
 S PSOTEXT(6)="Total Number of Prescriptions: "_PSOTRX
"RTN","PSO480P",222,0)
 S PSOTEXT(7)="Total Number of Prescriptions requiring manual intervention: "_PSOTMRX
"RTN","PSO480P",223,0)
 S PSOTEXT(9)="Total Number of Patients: "_PSOTPAT
"RTN","PSO480P",224,0)
 S PSOTEXT(10)="Total Dollars for Cancelled Copays: "_PSOTDOL
"RTN","PSO480P",225,0)
 S PSOTEXT(11)=""
"RTN","PSO480P",226,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSO480P",227,0)
 ;
"RTN","PSO480P",228,0)
MAIL2 ;site detailed report email
"RTN","PSO480P",229,0)
 N XMY,XMSUB,XMDUZ,XMTEXT,XMX
"RTN","PSO480P",230,0)
 S XMDUZ="noreply.domain.ext"
"RTN","PSO480P",231,0)
 S XMY(DUZ)=DUZ
"RTN","PSO480P",232,0)
 S XMY("ELLZEY.LINDA@FORUM.DOMAIN.EXT")=""
"RTN","PSO480P",233,0)
 S XMY("CROSSMAN.PAM@FORUM.DOMAIN.EXT")=""
"RTN","PSO480P",234,0)
 S XMX="PRCA ADJUSTMENT TRANS",XMY("G."_XMX_"@"_^XMB("NETNAME"))=""
"RTN","PSO480P",235,0)
 S:$$PROD^XUPROD(1) XMY("ELLZEY.LINDA@FORUM.DOMAIN.EXT")=""
"RTN","PSO480P",236,0)
 S XMSUB="FMCT DOMICILIARY CANCEL COPAY DETAILED REPORT (PSO*7*480)"
"RTN","PSO480P",237,0)
 S XMDUZ="noreply.domain.ext"
"RTN","PSO480P",238,0)
 S XMTEXT="^TMP($J,""FMCT DOM MSG""," N DIFROM D ^XMD
"RTN","PSO480P",239,0)
 ;
"RTN","PSO480P",240,0)
MAIL3 ;delimited file
"RTN","PSO480P",241,0)
 N XMY,XMSUB,XMDUZ,XMTEXT,PSOCNT,PSONAM,XMX
"RTN","PSO480P",242,0)
 S (PSORDT,PSODFN,RXP,PSOFILL,PSOAT,PSOISTAT,PSOTAMT,PSOARBN,PSOINST,PSOCNT,PSONAM)=""
"RTN","PSO480P",243,0)
 S XMDUZ="noreply.domain.ext"
"RTN","PSO480P",244,0)
 S XMY(DUZ)=DUZ
"RTN","PSO480P",245,0)
 S XMY("ELLZEY.LINDA@FORUM.DOMAIN.EXT")=""
"RTN","PSO480P",246,0)
 S XMY("CROSSMAN.PAM@FORUM.DOMAIN.EXT")=""
"RTN","PSO480P",247,0)
 S XMX="PRCA ADJUSTMENT TRANS",XMY("G."_XMX_"@"_^XMB("NETNAME"))=""
"RTN","PSO480P",248,0)
 S ^TMP($J,"FMCT DOM DLMT",1)="PSO*7*480 FMCT DOMICILIARY CANCEL COPAY - Delimited File"
"RTN","PSO480P",249,0)
 S ^TMP($J,"FMCT DOM DLMT",2)=""
"RTN","PSO480P",250,0)
 S ^TMP($J,"FMCT DOM DLMT",3)="Post install started "_PSOSTART_" and completed "_PSOEND_"."
"RTN","PSO480P",251,0)
 S ^TMP($J,"FMCT DOM DLMT",4)=""
"RTN","PSO480P",252,0)
 S ^TMP($J,"FMCT DOM DLMT",5)="RELEASE DATE^PATIENT NAME^PRESCRIPTION#^FILL NUMBER^IB ACTION TYPE^TOTAL AMOUNT^AR BILL #^INST"
"RTN","PSO480P",253,0)
 S PSOCNT=5
"RTN","PSO480P",254,0)
MAILL ;
"RTN","PSO480P",255,0)
 ;
"RTN","PSO480P",256,0)
 F  S PSORDT=$O(^XTMP(NAMSP,"DOM",PSORDT)) Q:PSORDT=""  F  S PSODFN=$O(^XTMP(NAMSP,"DOM",PSORDT,PSODFN)) Q:PSODFN=""  D
"RTN","PSO480P",257,0)
 .F  S RXP=$O(^XTMP(NAMSP,"DOM",PSORDT,PSODFN,RXP)) Q:RXP=""  F  S PSOFILL=$O(^XTMP(NAMSP,"DOM",PSORDT,PSODFN,RXP,PSOFILL)) Q:PSOFILL=""  S XX="" D
"RTN","PSO480P",258,0)
 ..S (PSONAM,XX)="",XX=^XTMP(NAMSP,"DOM",PSORDT,PSODFN,RXP,PSOFILL)
"RTN","PSO480P",259,0)
 ..S PSOAT=$P(XX,"^"),PSOISTAT=$P(XX,"^",2),PSOTAMT=$P(XX,"^",3),PSOARBN=$P(XX,"^",4),PSOINST=$P(XX,"^",5)
"RTN","PSO480P",260,0)
 ..S PSOCNT=PSOCNT+1,PSONAM=$$GET1^DIQ(2,PSODFN,.01)
"RTN","PSO480P",261,0)
 ..S ^TMP($J,"FMCT DOM DLMT",PSOCNT)=$$FMTE^XLFDT(PSORDT)_"^"_PSONAM_"^"_$$GET1^DIQ(52,RXP,.01)_"^"_PSOFILL_"^"_PSOAT_"^"_PSOTAMT_"^"_PSOARBN_"^"_PSOINST
"RTN","PSO480P",262,0)
 ;
"RTN","PSO480P",263,0)
 S:$$PROD^XUPROD(1) XMY("ELLZEY.LINDA@FORUM.DOMAIN.EXT")=""
"RTN","PSO480P",264,0)
 S XMSUB="FMCT DOMICILIARY CANCEL COPAY DELIMITED FILE (PSO*7*480)"
"RTN","PSO480P",265,0)
 S XMDUZ="noreply.domain.ext"
"RTN","PSO480P",266,0)
 S XMTEXT="^TMP($J,""FMCT DOM DLMT""," N DIFROM D ^XMD
"RTN","PSO480P",267,0)
 Q
"RTN","PSOCP")
0^1^B81967302^B81558217
"RTN","PSOCP",1,0)
PSOCP ;BIR/BAB - Pharmacy CO-PAY Application Utilities for IB ;02/06/92
"RTN","PSOCP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,46,71,85,137,157,143,219,239,201,225,303,460,480**;DEC 1997;Build 35
"RTN","PSOCP",3,0)
 ;
"RTN","PSOCP",4,0)
 ;REF/IA - IBARX/125, SDCO22/1579, PS(55/2228, PSDRUG(/221, DGMSTAPI/2716, $$GETSHAD^DGUTL3/4462
"RTN","PSOCP",5,0)
 ;Reference to $$CPTIER^PSNAPIS(P1,P3) supported by DBIA #2531
"RTN","PSOCP",6,0)
 ;Reference to $$GETSTAT^DGMSTAPI supported by DBIA 3457
"RTN","PSOCP",7,0)
 ; 
"RTN","PSOCP",8,0)
CP ;Check if COPAY-Requires RXP,PSOSITE7
"RTN","PSOCP",9,0)
 I '$D(PSOPAR) D ^PSOLSET G CP
"RTN","PSOCP",10,0)
 K PSOCP
"RTN","PSOCP",11,0)
 S PSOCPN=$P(^PSRX(RXP,0),"^",2) ; Set COPAY dfn PTR TO PATIENT
"RTN","PSOCP",12,0)
 S PSOCP=$P($G(^PSRX(RXP,"IB")),"^") ; IB action type
"RTN","PSOCP",13,0)
 S PSOSAVE=$S(PSOCP:1,1:"") ; save current copay status
"RTN","PSOCP",14,0)
 ; Set x=service^dfn^actiontype^user duz
"RTN","PSOCP",15,0)
 I +$G(PSOSITE7)'>0 S PSOSITE7=$P(^PS(59,PSOSITE,"IB"),"^")
"RTN","PSOCP",16,0)
 S X=PSOSITE7_"^"_PSOCPN_"^"_PSOCP_"^"_$P(^PSRX(RXP,0),"^",16)
"RTN","PSOCP",17,0)
 ;
"RTN","PSOCP",18,0)
RX ;Determine Orig or Refill for RX
"RTN","PSOCP",19,0)
 N PSOIB,PSOPFS,PSOCPT S (PSOIB,PSOREF)=0
"RTN","PSOCP",20,0)
 I $G(^PSRX(RXP,1,+$G(YY),0))]"" S PSOREF=YY
"RTN","PSOCP",21,0)
 D PFSA^PSOPFSU1(RXP,PSOREF,2) G PFS:+PSOPFS
"RTN","PSOCP",22,0)
 ; Check if bill exists
"RTN","PSOCP",23,0)
 I 'PSOREF,+$P($G(^PSRX(RXP,"IB")),"^",2)>0 D CHKIB^PSOCP1 I PSOIB G QUIT
"RTN","PSOCP",24,0)
 I 'PSOREF,+$P($G(^PSRX(RXP,"IB")),"^",4)>0 G QUIT ; 'POTENTIAL BILL' - ALREADY ATTEMPTED TO BILL, BUT EXCEEDED ANNUAL COPAY CAP
"RTN","PSOCP",25,0)
 I PSOREF,+$G(^PSRX(RXP,1,PSOREF,"IB")) D CHKIB^PSOCP1 I PSOIB G QUIT
"RTN","PSOCP",26,0)
 I PSOREF,+$P($G(^PSRX(RXP,1,PSOREF,"IB")),"^",2) G QUIT ; POTENTIAL BILL
"RTN","PSOCP",27,0)
PFS ;
"RTN","PSOCP",28,0)
 S PSOCHG=1 ; set tem var to copay and check exception
"RTN","PSOCP",29,0)
 N MAILMSG
"RTN","PSOCP",30,0)
 D COPAYREL
"RTN","PSOCP",31,0)
 I 'PSOCHG D  D:PSOPFS CHRG^PSOPFSU1(RXP,PSOREF,"CG",PSOPFS) G QUIT
"RTN","PSOCP",32,0)
 . I PSOSAVE S PSODA=RXP,PREA="R" D ACTLOG^PSOCPA S $P(^PSRX(RXP,"IB"),"^",1)=""
"RTN","PSOCP",33,0)
 I PSOCHG=2 D  I 'PSOCP D:PSOPFS CHRG^PSOPFSU1(RXP,PSOREF,"CG",PSOPFS) G QUIT ; IF 'SC' QUESTION APPLIES, BUT HAS NOT BEEN ANSWERED, SEND MAIL MSG AND KEEP COPAY STATUS AS IT WAS
"RTN","PSOCP",34,0)
 . D MAIL2^PSOCPE ; SEND MAIL TO PHARMACIST, PROVIDER, AND HOLDERS OF THE PSO COPAY KEY
"RTN","PSOCP",35,0)
 I PSOCHG=1,PSOSAVE="" D  I PSOREF S PSOCOMM="",PSOOLD="No Copay",PSONW="Copay" S PSODA=RXP,PREA="R" D ACTLOG^PSOCPA
"RTN","PSOCP",36,0)
 . I '$D(^PSRX(RXP,"IB")),'PSOREF S $P(^PSRX(RXP,"IB"),"^",1)=1 Q
"RTN","PSOCP",37,0)
 . S $P(^PSRX(RXP,"IB"),"^",1)=1
"RTN","PSOCP",38,0)
 . S PSOCP=1,$P(X,"^",3)=PSOCP
"RTN","PSOCP",39,0)
 I PSOCHG'=2 I $G(MAILMSG) D MAIL2^PSOCPE ; SEND MAIL TO PHARM, PROV, AND HOLDERS OF PSO COPAY KEY HOLDERS
"RTN","PSOCP",40,0)
 ; Units for COPAY
"RTN","PSOCP",41,0)
 S PSOCPUN=$P(($P(^PSRX(RXP,0),"^",8)+29)/30,".",1)
"RTN","PSOCP",42,0)
 ; Build softlink for x(n)=softlink^units
"RTN","PSOCP",43,0)
 S X(1)="52:"_RXP S:PSOREF>0 X(1)=X(1)_";1:"_PSOREF S X(1)=X(1)_"^"_PSOCPUN
"RTN","PSOCP",44,0)
 ; Set correct user duz if refill
"RTN","PSOCP",45,0)
 I PSOREF S:+$P(^PSRX(RXP,1,PSOREF,0),"^",7)>0 $P(X,"^",4)=$P(^PSRX(RXP,1,PSOREF,0),"^",7)
"RTN","PSOCP",46,0)
 ;
"RTN","PSOCP",47,0)
IBNEW ;  Load ^TMP global for IB call
"RTN","PSOCP",48,0)
 Q:$G(RXP)'>0
"RTN","PSOCP",49,0)
 I PSOPFS D CHRG^PSOPFSU1(RXP,PSOREF,"CG",PSOPFS)
"RTN","PSOCP",50,0)
 G QUIT:PSOPFS
"RTN","PSOCP",51,0)
 N D0
"RTN","PSOCP",52,0)
 G QUIT:'$D(X)
"RTN","PSOCP",53,0)
 S XTMP=X,XTMP(1)=X(1)
"RTN","PSOCP",54,0)
 ;
"RTN","PSOCP",55,0)
 ; Requires x=service^dfn^action type^user duz
"RTN","PSOCP",56,0)
 ;   x(n)=softlink^units 
"RTN","PSOCP",57,0)
 I $P(X,"^",3)="" S $P(X,"^",3)=$P(^PSRX(RXP,"IB"),"^",1)
"RTN","PSOCP",58,0)
 D NEW^IBARX
"RTN","PSOCP",59,0)
 ; Returns y=1^total charges for this group or Y=-1^error code
"RTN","PSOCP",60,0)
 ;         y(n)=IB number^charge for this Rx^AR bill #^Cap met^Partial or Full charge^Copay Exempt^Number from file 354.71
"RTN","PSOCP",61,0)
 ;         Cap met ('1' - If patient has met cap amount or reached cap with this charge or '0' if not)
"RTN","PSOCP",62,0)
 ;         Partial or Full ('P' for partial billing, 'F' for full billing, null for no billing)
"RTN","PSOCP",63,0)
 ;         Copay Exempt - ('1' for exempt, '0' for non-exempt, '-1' for copay off (manila)),
"RTN","PSOCP",64,0)
 ;            ('1' - If patient has met cap amount or reach cap with this charge
"RTN","PSOCP",65,0)
 ; Entry from file 354.71 will only be saved for fills that met the annual cap and could not be fully billed
"RTN","PSOCP",66,0)
 ;
"RTN","PSOCP",67,0)
 G QUIT:+Y=-1
"RTN","PSOCP",68,0)
 S XTMP=XTMP_"^"_Y,XTMP(1)=XTMP(1)_"^"_Y(1)
"RTN","PSOCP",69,0)
 ;
"RTN","PSOCP",70,0)
 ; see if exempt or copay cap was met
"RTN","PSOCP",71,0)
 I $P(Y(1),"^",6) D  G QUIT
"RTN","PSOCP",72,0)
 . S PREA="R",PSOOLD="Copay",PSONW="No Copay"
"RTN","PSOCP",73,0)
 . S PSOCOMM="RX COPAY INCOME EXEMPTION" S PSODA=RXP D ACTLOG^PSOCPA
"RTN","PSOCP",74,0)
 . S $P(^PSRX(RXP,"IB"),"^",1)=""
"RTN","PSOCP",75,0)
 I $P(Y(1),"^",4) D
"RTN","PSOCP",76,0)
 . S PSOCOMM=$S($P(Y(1),"^",5)="F":" FULL BILLING FOR THIS FILL",$P(Y(1),"^",5)="P":" PARTIAL BILLING FOR THIS FILL ",1:" NO BILLING FOR THIS FILL")
"RTN","PSOCP",77,0)
 . S PREA="A"
"RTN","PSOCP",78,0)
 . S PSODA=RXP D ACTLOG^PSOCPA
"RTN","PSOCP",79,0)
 . I $P(Y(1),"^",5)'="F" D
"RTN","PSOCP",80,0)
 . . I PSOREF S $P(^PSRX(RXP,1,PSOREF,"IB"),"^",2)=$P(Y(1),"^",7) Q
"RTN","PSOCP",81,0)
 . . S $P(^PSRX(RXP,"IB"),"^",4)=$P(Y(1),"^",7)
"RTN","PSOCP",82,0)
 I $P(Y(1),"^",1)="" G QUIT
"RTN","PSOCP",83,0)
 ;
"RTN","PSOCP",84,0)
FILE ;File IB number in ^PSRX
"RTN","PSOCP",85,0)
 S PSOCP2=0
"RTN","PSOCP",86,0)
 S PSOCP2=+$P(XTMP(1),":",3)
"RTN","PSOCP",87,0)
 S:PSOCP2>0 ^PSRX(RXP,1,PSOCP2,"IB")=$P(XTMP(1),U,3) ;  Filing in refill node
"RTN","PSOCP",88,0)
 I PSOCP2>0,'$D(^PSRX(RXP,"IB")) S ^PSRX(RXP,"IB")="1^^" ;  If refill "IB" exists, need "IB" entry on original fill node
"RTN","PSOCP",89,0)
 S:PSOCP2=0 $P(^PSRX(RXP,"IB"),"^",2)=$P(XTMP(1),U,3) ;Filing in original fill (zero node)
"RTN","PSOCP",90,0)
QUIT ;
"RTN","PSOCP",91,0)
 K Y,PSOCP1,PSOCP2,QQ,PSOCPN,X,X2,XTMP,PSOCPUN,PSOREF,PSOCHG,PSOSAVE,PSOCOMM,PSOOLD,PSONW,PREA,PSORSN
"RTN","PSOCP",92,0)
 Q
"RTN","PSOCP",93,0)
EN D ^PSOLSET
"RTN","PSOCP",94,0)
EN1 S DIR(0)="NO",DIR("A")="Enter PRESCRIPTION number" D ^DIR K DIR G:$D(DIRUT) EXIT S RXP=X I +$G(^PSRX(RXP,0))'>0!+$P($G(^PSRX(RXP,"IB")),"^",0)>0 W !,?10,"RE-CHECK PRESCRIPTION NUMBER AND RE-ENTER " G EN1
"RTN","PSOCP",95,0)
 S PSOSITE7=$P(^PS(59,PSOSITE,"IB"),"^")
"RTN","PSOCP",96,0)
 S PSODFN=$P(^PSRX(RXP,0),"^",2)
"RTN","PSOCP",97,0)
 D CP G EN1
"RTN","PSOCP",98,0)
EXIT K RXP D FINAL^PSOLSET Q
"RTN","PSOCP",99,0)
 ;
"RTN","PSOCP",100,0)
SC(PSODFN,PSODD) ;sup ref for CPRS, Pre-Copay enhancement
"RTN","PSOCP",101,0)
 N PSOSC
"RTN","PSOCP",102,0)
 I $$DT^PSOMLLDT S PSOSC="" G SCQ
"RTN","PSOCP",103,0)
 I $G(PSODD),($P($G(^PSDRUG(PSODD,0)),"^",3)["S")!($P($G(^(0)),"^",3)["I")!($P($G(^(0)),"^",3)["N") S PSOSC=1 G SCQ
"RTN","PSOCP",104,0)
 I $P($G(^PS(55,+$G(PSODFN),"PS")),"^"),$P($G(^PS(53,+$P(^("PS"),"^"),0)),"^",7) S PSOSC=1 G SCQ
"RTN","PSOCP",105,0)
 N I,J,X S (X,PSOSC)=""
"RTN","PSOCP",106,0)
 S J=0 F  S J=$O(^PS(59,J)) Q:'J  I +$G(^(J,"IB")) S X=+^("IB") Q
"RTN","PSOCP",107,0)
 G:'X SCQ
"RTN","PSOCP",108,0)
 S X=X_"^"_PSODFN D XTYPE^IBARX
"RTN","PSOCP",109,0)
 S J="" F  S J=$O(Y(J)) Q:'J  S I="" F  S I=$O(Y(J,I)) Q:I=""  S:I>0 PSOSC=I
"RTN","PSOCP",110,0)
SCQ Q $S($G(PSOSC)=2:0,1:1)
"RTN","PSOCP",111,0)
 ;
"RTN","PSOCP",112,0)
COPAYREL ; Recheck copay status at release
"RTN","PSOCP",113,0)
 ; check Rx patient status
"RTN","PSOCP",114,0)
 I $P(^PSRX(RXP,0),"^",3)'="",$P($G(^PS(53,$P(^PSRX(RXP,0),"^",3),0)),"^",7)=1 S PSOCHG=0,PSOCOMM="Rx Patient Status Change",PSOOLD="Copay",PSONW="No Copay" Q
"RTN","PSOCP",115,0)
 ; see if drug is nutritional supplement, investigational or supply
"RTN","PSOCP",116,0)
 N DRG,DRGTYP,X,PSOEXMPT
"RTN","PSOCP",117,0)
 S DRG=+$P(^PSRX(RXP,0),"^",6),DRGTYP=$P($G(^PSDRUG(DRG,0)),"^",3)
"RTN","PSOCP",118,0)
 I DRGTYP["I" S PSOCOMM="Investigational Drug",PSOOLD="Copay",PSONW="No Copay",PSOCHG=0,PSOEXMPT=1
"RTN","PSOCP",119,0)
 I DRGTYP["S" S PSOCOMM="Supply Item",PSOOLD="Copay",PSONW="No Copay",PSOCHG=0,PSOEXMPT=1
"RTN","PSOCP",120,0)
 I DRGTYP["N" S PSOCOMM="Nutritional Supplement",PSOOLD="Copay",PSONW="No Copay",PSOCHG=0,PSOEXMPT=1
"RTN","PSOCP",121,0)
 K PSOTG,CHKXTYPE
"RTN","PSOCP",122,0)
 I +$G(^PSRX(RXP,"IBQ")) D XTYPE1^PSOCP1
"RTN","PSOCP",123,0)
 I $G(^PSRX(RXP,"IBQ"))["1" D  S PSOCHG=0,PSOOLD="Copay",PSONW="No Copay",PSOEXMPT=1 Q  ; COPAY EXEMPT
"RTN","PSOCP",124,0)
 . N EXMT,II,PSOCIBQ
"RTN","PSOCP",125,0)
 . S PSOCIBQ=$G(^PSRX(RXP,"IBQ"))
"RTN","PSOCP",126,0)
 . F II=1,7,3,4,5,6,2,8 I $P(PSOCIBQ,"^",II)=1 S EXMT=$S(II=1:"SC",II=7:"CV",II=3:"AO",II=4:"IR",II=5:"EC",II=8:"SHAD",II=2:"MST",II=6:"HNC",1:"") D:EXMT'="" SETCOMM Q
"RTN","PSOCP",127,0)
 D SCNEW(.PSOTG,PSOCPN,DRG,RXP)
"RTN","PSOCP",128,0)
 N EXMT
"RTN","PSOCP",129,0)
 I '$D(CHKXTYPE) D XTYPE
"RTN","PSOCP",130,0)
 F EXMT="SC","CV","AO","IR","EC","SHAD","MST","HNC" I $D(PSOTG(EXMT)) D  I 'PSOCHG Q
"RTN","PSOCP",131,0)
 . I PSOTG(EXMT)=1 S PSOCHG=0 D SETCOMM
"RTN","PSOCP",132,0)
 ;***** begin - for regression test - sites must not use this as it will adversely affect billing results - only used by SQA
"RTN","PSOCP",133,0)
 ; The following is required for testing different effective dates.  If date is less than 02/27/17 bills old way.  Otherwise bills new way.
"RTN","PSOCP",134,0)
 ;S ^XTMP("PSOTIEREFTST",0)="3201231^3170227^FOR SQA TESTING ONLY" - Defined for SQA testing only.   Delete this XTMP when regression complete
"RTN","PSOCP",135,0)
 D NOW^%DTC N PSOTIERE
"RTN","PSOCP",136,0)
 S PSOTIERE=1  ;use copay tiers - new
"RTN","PSOCP",137,0)
 I $P(%,".")<3170227 S PSOTIERE=0  ;legacy billing - old
"RTN","PSOCP",138,0)
 I $G(^XTMP("PSOTIEREFTST",0)) S PSOTIERE=1  ;for SQA testing only - bill with copay tiers - new
"RTN","PSOCP",139,0)
 ;***** end for regression test
"RTN","PSOCP",140,0)
 G COPAYRE1:'PSOTIERE
"RTN","PSOCP",141,0)
 ;Check copay tier. Tier zero does not have copay charges. Tier billing will be effective 2/27/17 and IB rate table decides what amount to bill based on rate effective date
"RTN","PSOCP",142,0)
 N CPDATE,X D NOW^%DTC S CPDATE=X,PSOCPT=$$CPTIER^PSNAPIS("",CPDATE,DRG) K CPDATE,X
"RTN","PSOCP",143,0)
 I $P(PSOCPT,"^")=0 S PSOCHG=0 Q  ;Tier zero do not send to IB for copay charge
"RTN","PSOCP",144,0)
 I '$G(PSOEXMPT),$P(PSOCPT,"^")=""!($P(PSOCPT,"^")>0) S PSOCOMM="Copay Tier "_$S(PSOCPT="":"Null",1:+PSOCPT),PSOOLD="No Copay",PSONW="Copay",PSODA=RXP,PREA="R",PSOCHG=1 D ACTLOG^PSOCPA Q
"RTN","PSOCP",145,0)
 ;
"RTN","PSOCP",146,0)
COPAYRE1 ;
"RTN","PSOCP",147,0)
 Q:PSOCHG
"RTN","PSOCP",148,0)
 I 'PSOCHG S PSOOLD="Copay",PSONW="No Copay" Q
"RTN","PSOCP",149,0)
 ;
"RTN","PSOCP",150,0)
 ; If any of the applicable exemption quest have never been answered, send a mail msg with all of the quest
"RTN","PSOCP",151,0)
 S EXMT="",MAILMSG=0 F  S EXMT=$O(PSOTG(EXMT)) Q:EXMT=""  I PSOTG(EXMT)="" S MAILMSG=1 Q
"RTN","PSOCP",152,0)
 I MAILMSG,$D(PSOTG("SC")) I $G(PSOTG("SC"))="" S PSOCHG=2 ; 'SC' quest not answered, don't reset copay status to 'copay'
"RTN","PSOCP",153,0)
 Q
"RTN","PSOCP",154,0)
 ;
"RTN","PSOCP",155,0)
SCNEW(PSOTG,PSOPT,PSODR,PSORN) ;CPRS supported ref
"RTN","PSOCP",156,0)
 I '$$DT^PSOMLLDT Q
"RTN","PSOCP",157,0)
 I '$G(PSOPT) Q
"RTN","PSOCP",158,0)
 ;I $G(PSODR),($P($G(^PSDRUG(PSODR,0)),"^",3)["S")!($P($G(^(0)),"^",3)["I") Q ;CIDC ALWAYS ASK
"RTN","PSOCP",159,0)
 N PSOCIBQ,PSOQMSH,PSOQVEH,PSOQRQD,PSOQHNC,PSOQPGW,DFN,PSOSCA,ZXX
"RTN","PSOCP",160,0)
 K PSOANSQ("SC>50")
"RTN","PSOCP",161,0)
 S DFN=PSOPT
"RTN","PSOCP",162,0)
 D SCP^PSORN52D S:PSOSCP>49&(PSOSCA) PSOANSQ("SC>50")=1
"RTN","PSOCP",163,0)
 I $G(PSORN) D
"RTN","PSOCP",164,0)
 . S PSOCIBQ=$G(^PSRX(PSORN,"IBQ"))
"RTN","PSOCP",165,0)
 . I $TR(PSOCIBQ,"^")="" S ZXX=$G(^PSRX(PSORN,"ICD",1,0)) D ICD:ZXX'=""
"RTN","PSOCP",166,0)
 I '$G(PSORN) S PSOCIBQ=""
"RTN","PSOCP",167,0)
 ;Rx Patient Status check is not being done here
"RTN","PSOCP",168,0)
 N PSOSCMX,Y,I,J,X S (X,PSOSCMX)=""
"RTN","PSOCP",169,0)
 S J=0 F  S J=$O(^PS(59,J)) Q:'J  I +$G(^(J,"IB")) S X=+^("IB") Q
"RTN","PSOCP",170,0)
 G:'X SKIP
"RTN","PSOCP",171,0)
 S X=X_"^"_PSOPT D XTYPE^IBARX
"RTN","PSOCP",172,0)
 S J="" F  S J=$O(Y(J)) Q:'J  S I="" F  S I=$O(Y(J,I)) Q:I=""  S:I>0 PSOSCMX=I
"RTN","PSOCP",173,0)
SKIP ;
"RTN","PSOCP",174,0)
 I $G(PSOSCA)!($G(PSOSCMX)=2) S PSOTG("SC")=$S($P(PSOCIBQ,"^")=1:1,$P(PSOCIBQ,"^")=0:0,$G(PSORN)&($P($G(^PSRX(+$G(PSORN),"IB")),"^")):0,1:"")
"RTN","PSOCP",175,0)
 S:$$AO^SDCO22(PSOPT) PSOTG("AO")=$S($P(PSOCIBQ,"^",3)=1:1,$P(PSOCIBQ,"^",3)=0:0,1:"")
"RTN","PSOCP",176,0)
 S:$$IR^SDCO22(PSOPT) PSOTG("IR")=$S($P(PSOCIBQ,"^",4)=1:1,$P(PSOCIBQ,"^",4)=0:0,1:"")
"RTN","PSOCP",177,0)
 S:$$EC^SDCO22(PSOPT) PSOTG("EC")=$S($P(PSOCIBQ,"^",5)=1:1,$P(PSOCIBQ,"^",5)=0:0,1:"")
"RTN","PSOCP",178,0)
 S:$P($$GETSTAT^DGMSTAPI(PSOPT),"^",2)="Y" PSOTG("MST")=$S($P(PSOCIBQ,"^",2)=1:1,$P(PSOCIBQ,"^",2)=0:0,1:"")
"RTN","PSOCP",179,0)
 I $T(GETCUR^DGNTAPI)]"" N PSONC,PSONCX S PSONCX=$$GETCUR^DGNTAPI(PSOPT,"PSONC") I $P($G(PSONC("IND")),"^")="Y" S PSOTG("HNC")=$S($P(PSOCIBQ,"^",6)=1:1,$P(PSOCIBQ,"^",6)=0:0,1:"")
"RTN","PSOCP",180,0)
 S:$P($$CVEDT^DGCV(PSOPT),"^",3) PSOTG("CV")=$S($P(PSOCIBQ,"^",7)=1:1,$P(PSOCIBQ,"^",7)=0:0,1:"")
"RTN","PSOCP",181,0)
 I $L($T(GETSHAD^DGUTL3)) S:$$GETSHAD^DGUTL3(PSOPT)=1 PSOTG("SHAD")=$S($P(PSOCIBQ,"^",8)=1:1,$P(PSOCIBQ,"^",8)=0:0,1:"")
"RTN","PSOCP",182,0)
 Q
"RTN","PSOCP",183,0)
 ;
"RTN","PSOCP",184,0)
ICD ;
"RTN","PSOCP",185,0)
 D ICD^PSOCP1
"RTN","PSOCP",186,0)
 Q
"RTN","PSOCP",187,0)
XTYPE ;
"RTN","PSOCP",188,0)
 N PSOCIBQ,PSOSCMX,Y,I,J,X,SAVY,ZXX
"RTN","PSOCP",189,0)
 S (X,PSOSCMX,SAVY)=""
"RTN","PSOCP",190,0)
 S PSOCIBQ=$G(^PSRX(RXP,"IBQ")) I $TR(PSOCIBQ,"^")="" S ZXX=$G(^PSRX(RXP,"ICD",1,0)) D ICD:ZXX'=""
"RTN","PSOCP",191,0)
 I $P(PSOCIBQ,"^",1)'="" S PSOTG("SC")=$P(PSOCIBQ,"^",1)
"RTN","PSOCP",192,0)
 I $D(PSOTG("SC")),$P(PSOCIBQ,"^",1)="" S PSOTG("SC")="" ; USE "CURRENT" SETTING AS ANS TO SC QUEST IF IT APPLIES
"RTN","PSOCP",193,0)
 S J=0 F  S J=$O(^PS(59,J)) Q:'J  I +$G(^(J,"IB")) S X=+^("IB") Q
"RTN","PSOCP",194,0)
 I 'X Q
"RTN","PSOCP",195,0)
 S X=X_"^"_PSOCPN D XTYPE^IBARX
"RTN","PSOCP",196,0)
 I $G(Y)'=1 Q
"RTN","PSOCP",197,0)
 S J="" F  S J=$O(Y(J)) Q:'J  S I="" F  S SAVY=I,I=$O(Y(J,I)) Q:I=""  S:I>0 PSOSCMX=I
"RTN","PSOCP",198,0)
 I PSOSCMX="",SAVY=0 S PSOCHG=0,PSOEXMPT=1 S PSOCOMM="Exempt from copayment" Q  ; INCOME EXEMPT OR SC
"RTN","PSOCP",199,0)
 I PSOSCMX=2,'$D(PSOTG("SC")) S PSOTG("SC")=$S(($G(RXP)&($P($G(^PSRX(+$G(RXP),"IB")),"^")))!($P(PSOCIBQ,"^")=0):0,$P(PSOCIBQ,"^")=1:1,1:"") Q
"RTN","PSOCP",200,0)
 Q
"RTN","PSOCP",201,0)
 ;
"RTN","PSOCP",202,0)
SETCOMM ;
"RTN","PSOCP",203,0)
 D SETCOMM^PSOCP1
"RTN","PSOCP",204,0)
 Q
"RTN","PSOCP",205,0)
 ;
"RTN","PSOCP1")
0^13^B5455566^B5367762
"RTN","PSOCP1",1,0)
PSOCP1 ;BHAM ISC/EJW-PHARMACY CO-PAY APPLICATION UTILITIES FOR IB (CONT'D) ;12/12/02
"RTN","PSOCP1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**137,239,225,480**;DEC 1997;Build 35
"RTN","PSOCP1",3,0)
 ;
"RTN","PSOCP1",4,0)
 ;REF/IA
"RTN","PSOCP1",5,0)
 ;IBARX/125
"RTN","PSOCP1",6,0)
CHKIB ; SEE IF BILL # IS A CHARGE OR CANCELLATION #
"RTN","PSOCP1",7,0)
 N IBN,XX
"RTN","PSOCP1",8,0)
 I PSOREF=0 S XX=$G(^PSRX(RXP,"IB")) I $P(XX,"^",4)'="" S PSOIB=1 Q  ;ALREADY BILLED
"RTN","PSOCP1",9,0)
 I PSOREF=0 S IBN=$P(XX,"^",2)
"RTN","PSOCP1",10,0)
 I PSOREF'=0 S XX=$G(^PSRX(RXP,1,PSOREF,"IB")) I $P(XX,"^",2)'="" S PSOIB=1 Q  ;ALREADY BILLED
"RTN","PSOCP1",11,0)
 I PSOREF'=0 S IBN=$P(XX,"^",1)
"RTN","PSOCP1",12,0)
 I IBN'="" D STATUS
"RTN","PSOCP1",13,0)
 Q
"RTN","PSOCP1",14,0)
 ;
"RTN","PSOCP1",15,0)
STATUS ;
"RTN","PSOCP1",16,0)
 N XX
"RTN","PSOCP1",17,0)
 S XX=$$STATUS^IBARX(IBN)
"RTN","PSOCP1",18,0)
 I XX'=1,XX'=3 Q
"RTN","PSOCP1",19,0)
 S PSOIB=1 ; ALREADY BILLED
"RTN","PSOCP1",20,0)
 Q
"RTN","PSOCP1",21,0)
 ;
"RTN","PSOCP1",22,0)
XTYPE1 ;
"RTN","PSOCP1",23,0)
 N PSOCIBQ,PSOSCMX,Y,I,J,X,SAVY
"RTN","PSOCP1",24,0)
 S (X,PSOSCMX,SAVY)=""
"RTN","PSOCP1",25,0)
 S PSOCIBQ=$G(^PSRX(RXP,"IBQ"))
"RTN","PSOCP1",26,0)
 I $P(PSOCIBQ,"^",1)'=1 Q
"RTN","PSOCP1",27,0)
 S J=0 F  S J=$O(^PS(59,J)) Q:'J  I +$G(^(J,"IB")) S X=+^("IB") Q
"RTN","PSOCP1",28,0)
 I 'X Q
"RTN","PSOCP1",29,0)
 S X=X_"^"_PSOCPN D XTYPE^IBARX
"RTN","PSOCP1",30,0)
 I $G(Y)'=1 Q
"RTN","PSOCP1",31,0)
 S J="" F  S J=$O(Y(J)) Q:'J  S I="" F  S SAVY=I,I=$O(Y(J,I)) Q:I=""  S:I>0 PSOSCMX=I
"RTN","PSOCP1",32,0)
 I PSOSCMX="",SAVY=0 S PSOEXMPT=1 Q  ; INCOME EXEMPT OR SERVICE-CONNECTED
"RTN","PSOCP1",33,0)
 I PSOSCMX=2 Q  ; NEED TO ASK SC QUESTION
"RTN","PSOCP1",34,0)
 ; If get to here, service-connected question does not apply for this patient anymore.  Update "IBQ" and CPRS
"RTN","PSOCP1",35,0)
 S $P(^PSRX(RXP,"IBQ"),"^",1)="",CHKXTYPE=1
"RTN","PSOCP1",36,0)
 D EN^PSOHLSN1(RXP,"XX","","Order edited")
"RTN","PSOCP1",37,0)
 Q
"RTN","PSOCP1",38,0)
 ;
"RTN","PSOCP1",39,0)
SETCOMM ;
"RTN","PSOCP1",40,0)
 I EXMT="SC" S PSOCOMM="Service Connected" Q
"RTN","PSOCP1",41,0)
 I EXMT="CV" S PSOCOMM="COMBAT VETERAN" Q
"RTN","PSOCP1",42,0)
 I EXMT="AO" S PSOCOMM="AGENT ORANGE RELATED" Q
"RTN","PSOCP1",43,0)
 I EXMT="IR" S PSOCOMM="IONIZING RAD RELATED" Q
"RTN","PSOCP1",44,0)
 I EXMT="EC" S PSOCOMM="SW ASIA COND. RELATED" Q
"RTN","PSOCP1",45,0)
 I EXMT="SHAD" S PSOCOMM="PROJ 112/SHAD" Q
"RTN","PSOCP1",46,0)
 I EXMT="MST" S PSOCOMM="MILITARY SEXUAL TRAUMA" Q
"RTN","PSOCP1",47,0)
 I EXMT="HNC" S PSOCOMM="Head and/or Neck Cancer" Q
"RTN","PSOCP1",48,0)
 Q
"RTN","PSOCP1",49,0)
 ;
"RTN","PSOCP1",50,0)
ICD ;
"RTN","PSOCP1",51,0)
 S PSOCIBQ=$P(ZXX,U,4)_"^"_$P(ZXX,U,6)_"^"_$P(ZXX,U,2)_"^"_$P(ZXX,U,3)_"^"_$P(ZXX,U,5)_"^"_$P(ZXX,U,7)_"^"_$P(ZXX,U,8)_"^"_$P(ZXX,U,9)
"RTN","PSOCP1",52,0)
 Q
"RTN","PSOCP1",53,0)
 ;
"RTN","PSOCPBAK")
0^3^B43718412^B43547187
"RTN","PSOCPBAK",1,0)
PSOCPBAK ;BIR/EJW-Tally unbilled NON-SERVICE CONNECTED copays ;03/28/03
"RTN","PSOCPBAK",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**137,268,480**;DEC 1997;Build 35
"RTN","PSOCPBAK",3,0)
 ;External reference to ^XUSEC supported by DBIA 10076
"RTN","PSOCPBAK",4,0)
 ;External reference to IBARX supported by DBIA 125
"RTN","PSOCPBAK",5,0)
 S ZTDTH=""
"RTN","PSOCPBAK",6,0)
 I $D(ZTQUEUED) S ZTDTH=$H
"RTN","PSOCPBAK",7,0)
 L +^XTMP("PSOCPBAK"):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T D  Q
"RTN","PSOCPBAK",8,0)
 . I ZTDTH="" D BMES^XPDUTL("Tally job is already running.  Halting...")
"RTN","PSOCPBAK",9,0)
 L -^XTMP("PSOCPBAK")
"RTN","PSOCPBAK",10,0)
 I ZTDTH="" D
"RTN","PSOCPBAK",11,0)
 .D BMES^XPDUTL("Tally unbilled, released NON-SERVICE CONNECTED prescription fills.")
"RTN","PSOCPBAK",12,0)
 .D BMES^XPDUTL("If no start date/time is entered when prompted, the background job will be ")
"RTN","PSOCPBAK",13,0)
 .D MES^XPDUTL("queued to run NOW.")
"RTN","PSOCPBAK",14,0)
 .D GETDATE
"RTN","PSOCPBAK",15,0)
 .D BMES^XPDUTL("Queuing background job to tally unbilled NON-SERVICE CONNECTED fills...")
"RTN","PSOCPBAK",16,0)
 S ZTRTN="EN^PSOCPBAK",ZTIO="",ZTDESC="Background job to tally NON-SERVICE CONNECTED unbilled copays" D ^%ZTLOAD K ZTDTH,ZTRTN,ZTIO,ZTDESC
"RTN","PSOCPBAK",17,0)
 W:$D(ZTSK)&('$D(ZTQUEUED)) !!,"Task Queued !",!
"RTN","PSOCPBAK",18,0)
 Q
"RTN","PSOCPBAK",19,0)
EN ;
"RTN","PSOCPBAK",20,0)
 L +^XTMP("PSOCPBAK"):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T S:$D(ZTQUEUED) ZTREQ="@" Q
"RTN","PSOCPBAK",21,0)
 N PSODT,RXP,PSOTEXT,YY,PSOCNT,PSOSTART,PSOEND,PSOVETS
"RTN","PSOCPBAK",22,0)
 S PSOCNT=0
"RTN","PSOCPBAK",23,0)
 D NOW^%DTC S (Y,PSOS1)=% D DD^%DT S PSOSTART=Y
"RTN","PSOCPBAK",24,0)
 S PSOSTRT2=$$FMTE^XLFDT(%,"1PS")
"RTN","PSOCPBAK",25,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOCPBAK",26,0)
 I '$D(^XTMP("PSOCPBAK")) S X1=DT,X2=+90 D C^%DTC S ^XTMP("PSOCPBAK",0)=$G(X)_"^"_DT
"RTN","PSOCPBAK",27,0)
 S PSODT=3020203.235959 ; START WITH DATE $7 COPAY WENT INTO EFFECT
"RTN","PSOCPBAK",28,0)
 F  S PSODT=$O(^PSRX("AL",PSODT)) Q:'PSODT  S RXP="" F  S RXP=$O(^PSRX("AL",PSODT,RXP)) Q:'RXP  D
"RTN","PSOCPBAK",29,0)
 .S PSODFN=$P($G(^PSRX(RXP,0)),"^",2) Q:PSODFN=""  I '$D(^DPT(PSODFN,0)) Q
"RTN","PSOCPBAK",30,0)
 .I $G(^XTMP("PSOCPBAK",$J,PSODFN)) Q  ; EXEMPT OR SC QUESTION APPLIES-- NOTHING TO REPROCESS FOR THIS PATIENT
"RTN","PSOCPBAK",31,0)
 .S BADDT=$G(^XTMP("PSOCPBAK",$J,PSODFN,RXP))
"RTN","PSOCPBAK",32,0)
 .I 'BADDT D CHKLOG
"RTN","PSOCPBAK",33,0)
 .I BADDT,BADDT'>$P(PSODT,".") D
"RTN","PSOCPBAK",34,0)
 ..I '$D(^XTMP("PSOCPBAK",$J,PSODFN)) D XTYPE S ^XTMP("PSOCPBAK",$J,PSODFN)=$S(PSOSCMX=1:"",1:1) I PSOSCMX'=1 Q  ; QUIT IF SC QUESTION APPLIES -- NOTHING TO REPROCESS
"RTN","PSOCPBAK",35,0)
 ..S YY="" F  S YY=$O(^PSRX("AL",PSODT,RXP,YY)) Q:YY=""  D
"RTN","PSOCPBAK",36,0)
 ...S PSOREL=$S(YY=0:$P(^PSRX(RXP,2),"^",13),1:$P($G(^PSRX(RXP,1,YY,0)),"^",18)) I 'PSOREL Q  ; RELEASED DATE WON'T BE PRESENT IF RETURNED TO STOCK
"RTN","PSOCPBAK",37,0)
 ...I 'YY I $P($G(^PSRX(RXP,"IB")),"^",2)'="" Q  ; ALREADY BILLED
"RTN","PSOCPBAK",38,0)
 ...I 'YY I $P($G(^PSRX(RXP,"IB")),"^",4)'="" Q  ; ALREADY BILLED (POTENTIAL BILL - EXCEEDED ANNUAL CAP)
"RTN","PSOCPBAK",39,0)
 ...I YY,$P($G(^PSRX(RXP,1,YY,"IB")),"^",1)'="" Q  ; REFILL ALREADY BILLED
"RTN","PSOCPBAK",40,0)
 ...I YY,$P($G(^PSRX(RXP,1,YY,"IB")),"^",2)'="" Q  ; REFILL ALREADY BILLED (POTENTIAL BILL - EXCEEDED ANNUAL CAP)
"RTN","PSOCPBAK",41,0)
 ...S PSOXIN=$$RXST^IBARXEU(PSODFN,$P(PSOREL,".")) I $P($G(PSOXIN),"^")=1 Q  ; INCOME EXEMPT ON RELEASE DATE
"RTN","PSOCPBAK",42,0)
 ...I '$D(^XTMP("PSOCPBAK",$J,PSODFN,RXP)) S ^XTMP("PSOCPBAK",$J,PSODFN,RXP)=BADDT
"RTN","PSOCPBAK",43,0)
 ...S ^XTMP("PSOCPBAK",$J,PSODFN,RXP,YY)=$P(PSOREL,".") ; SAVE TO PROCESS IN "BILL" SECTION
"RTN","PSOCPBAK",44,0)
 D TALLY^PSOCPBA2
"RTN","PSOCPBAK",45,0)
 D TOTAL
"RTN","PSOCPBAK",46,0)
 D MAIL
"RTN","PSOCPBAK",47,0)
 D MAIL2
"RTN","PSOCPBAK",48,0)
 L -^XTMP("PSOCPBAK")
"RTN","PSOCPBAK",49,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCPBAK",50,0)
 Q
"RTN","PSOCPBAK",51,0)
 ;
"RTN","PSOCPBAK",52,0)
MAIL ;
"RTN","PSOCPBAK",53,0)
 D NOW^%DTC S Y=% D DD^%DT S PSOEND=Y
"RTN","PSOCPBAK",54,0)
 I $G(DUZ) S XMY(DUZ)=""
"RTN","PSOCPBAK",55,0)
 S XMDUZ="Outpatient Pharmacy",XMSUB="Outpatient Pharmacy Copay Tally"
"RTN","PSOCPBAK",56,0)
 F PSOCXPDA=0:0 S PSOCXPDA=$O(^XUSEC("PSO COPAY",PSOCXPDA)) Q:'PSOCXPDA  S XMY(PSOCXPDA)=""
"RTN","PSOCPBAK",57,0)
 I $O(XMY(""))="" Q  ; no recipients for mail message
"RTN","PSOCPBAK",58,0)
 S PSOTEXT(1)="The Rx copay tally job for the Outpatient Pharmacy patch (PSO*7*137)"
"RTN","PSOCPBAK",59,0)
 S PSOTEXT(2)="started "_PSOSTART_" and completed "_PSOEND_"."
"RTN","PSOCPBAK",60,0)
 I PSOCNT>0 S PSOTEXT(3)="Released non-service connected prescriptions have now been reprocessed."
"RTN","PSOCPBAK",61,0)
 I PSOCNT>0 S PSOTEXT(4)="There were "_PSOCNT_" fills successfully tallied for "_$G(PSOVETS)_" veterans." D
"RTN","PSOCPBAK",62,0)
 .S PSOTEXT(5)=" "
"RTN","PSOCPBAK",63,0)
 .S PSOTEXT(6)="Fills eligible for back-billing by year:"
"RTN","PSOCPBAK",64,0)
 .S PSOTEXT(7)="2002  30-DAY EQUIVALENT FILLS: "_PSOCNT("YR2002",1)
"RTN","PSOCPBAK",65,0)
 .S PSOTEXT(8)="2002  60-DAY EQUIVALENT FILLS: "_PSOCNT("YR2002",2)
"RTN","PSOCPBAK",66,0)
 .S PSOTEXT(9)="2002  90-DAY EQUIVALENT FILLS: "_PSOCNT("YR2002",3)
"RTN","PSOCPBAK",67,0)
 .S PSOTEXT(10)=""
"RTN","PSOCPBAK",68,0)
 .S PSOTEXT(11)="2003  30-DAY EQUIVALENT FILLS: "_PSOCNT("YR2003",1)
"RTN","PSOCPBAK",69,0)
 .S PSOTEXT(12)="2003  60-DAY EQUIVALENT FILLS: "_PSOCNT("YR2003",2)
"RTN","PSOCPBAK",70,0)
 .S PSOTEXT(13)="2003  90-DAY EQUIVALENT FILLS: "_PSOCNT("YR2003",3)
"RTN","PSOCPBAK",71,0)
 I PSOCNT=0 S PSOTEXT(3)="No released unbilled copay fills were found."
"RTN","PSOCPBAK",72,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCPBAK",73,0)
 Q
"RTN","PSOCPBAK",74,0)
 ;
"RTN","PSOCPBAK",75,0)
MAIL2 ;
"RTN","PSOCPBAK",76,0)
 N I,COUNTS
"RTN","PSOCPBAK",77,0)
 D NOW^%DTC S PSOTIME=$$FMDIFF^XLFDT(%,PSOS1,2)
"RTN","PSOCPBAK",78,0)
 S PSOINST=$P($G(^DIC(4,+$P($G(^XMB(1,1,"XUS")),"^",17),99)),"^")
"RTN","PSOCPBAK",79,0)
 K PSOTEXT
"RTN","PSOCPBAK",80,0)
 S COUNTS=""
"RTN","PSOCPBAK",81,0)
 F J="YR2002","YR2003" F I=1:1:3 S COUNTS=COUNTS_"^"_PSOCNT(J,I)
"RTN","PSOCPBAK",82,0)
 K XMY(DUZ)
"RTN","PSOCPBAK",83,0)
 S XMY("WHITE.ELAINE@FORUM.DOMAIN.EXT")=""
"RTN","PSOCPBAK",84,0)
 S XMY("CARROLL.DAN@FORUM.DOMAIN.EXT")=""
"RTN","PSOCPBAK",85,0)
 S XMDUZ="PSO*7*137 TALLY",XMSUB=$G(PSOINST)_" - COUNTS"
"RTN","PSOCPBAK",86,0)
 S PSOTEXT(1)=PSOSTRT2_"^"_PSOTIME_"^"_$G(PSOVETS)_"^"_PSOCNT_COUNTS
"RTN","PSOCPBAK",87,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCPBAK",88,0)
 Q
"RTN","PSOCPBAK",89,0)
 ;
"RTN","PSOCPBAK",90,0)
CHKLOG ;
"RTN","PSOCPBAK",91,0)
 S BADDT=""
"RTN","PSOCPBAK",92,0)
 S PSOSQ=0 F  S PSOSQ=$O(^PSRX(RXP,"COPAY",PSOSQ)) Q:'PSOSQ  S PSOLOG=$G(^PSRX(RXP,"COPAY",PSOSQ,0)) I PSOLOG["Service Connected" S BADDT=$P(PSOLOG,".") Q
"RTN","PSOCPBAK",93,0)
 Q
"RTN","PSOCPBAK",94,0)
 ;
"RTN","PSOCPBAK",95,0)
GETDATE ; GET DATE/TIME OF WHEN BACKGROUND JOB SHOULD BE RUN
"RTN","PSOCPBAK",96,0)
 S ZTDTH=""
"RTN","PSOCPBAK",97,0)
 S NOW=0
"RTN","PSOCPBAK",98,0)
 D NOW^%DTC S (Y,TODAY)=% D DD^%DT
"RTN","PSOCPBAK",99,0)
 D BMES^XPDUTL("At the following prompt, enter a starting date@time")
"RTN","PSOCPBAK",100,0)
 D MES^XPDUTL("or enter NOW to queue the job immediately.")
"RTN","PSOCPBAK",101,0)
 D BMES^XPDUTL("If this prompting is during patch installation, you will not see what you type.")
"RTN","PSOCPBAK",102,0)
 W ! K %DT D NOW^%DTC S %DT="RAEX",%DT(0)=%,%DT("A")="Queue copay tally Job to run Date@Time: "
"RTN","PSOCPBAK",103,0)
 D ^%DT K %DT I $D(DTOUT)!(Y<0) W "Task will be queued to run NOW" S ZTDTH=$H,NOW=1
"RTN","PSOCPBAK",104,0)
 I 'NOW,Y>0 D
"RTN","PSOCPBAK",105,0)
 .S SAVEY=Y
"RTN","PSOCPBAK",106,0)
 .D DD^%DT
"RTN","PSOCPBAK",107,0)
 .S X=Y
"RTN","PSOCPBAK",108,0)
 .S Y=SAVEY
"RTN","PSOCPBAK",109,0)
ASK D BMES^XPDUTL("Task will be queued to run "_$S(NOW:"NOW",1:X)_". Is that correct?  :")
"RTN","PSOCPBAK",110,0)
 R XX:300 S:'$T XX="Y" I XX'="Y",XX'="y",XX'="N",XX'="n" W " Enter Y or N" G ASK
"RTN","PSOCPBAK",111,0)
 I XX'="Y",XX'="y" G GETDATE
"RTN","PSOCPBAK",112,0)
 I Y>0,ZTDTH="" S ZTDTH=Y
"RTN","PSOCPBAK",113,0)
 I ZTDTH="" S ZTDTH=$H
"RTN","PSOCPBAK",114,0)
 Q
"RTN","PSOCPBAK",115,0)
 ;
"RTN","PSOCPBAK",116,0)
XTYPE ;
"RTN","PSOCPBAK",117,0)
 N Y,I,J,X,SAVY,DFN
"RTN","PSOCPBAK",118,0)
 S DFN=PSODFN D DEM^VADPT I +$G(VADM(6)) S PSOSCMX="" Q  ; DECEASED
"RTN","PSOCPBAK",119,0)
 S (X,PSOSCMX,SAVY)=""
"RTN","PSOCPBAK",120,0)
 S J=0 F  S J=$O(^PS(59,J)) Q:'J  I +$G(^(J,"IB")) S X=+^("IB") Q
"RTN","PSOCPBAK",121,0)
 I 'X Q
"RTN","PSOCPBAK",122,0)
 S X=X_"^"_PSODFN D XTYPE^IBARX
"RTN","PSOCPBAK",123,0)
 I $G(Y)'=1 Q
"RTN","PSOCPBAK",124,0)
 S J="" F  S J=$O(Y(J)) Q:'J  S I="" F  S SAVY=I,I=$O(Y(J,I)) Q:I=""  S:I>0 PSOSCMX=I
"RTN","PSOCPBAK",125,0)
 I PSOSCMX="",SAVY=0 S PSOEXMPT=1 Q  ; INCOME EXEMPT OR SERVICE-CONNECTED
"RTN","PSOCPBAK",126,0)
 I PSOSCMX=2 Q  ; NEED TO ASK SC QUESTION
"RTN","PSOCPBAK",127,0)
 Q
"RTN","PSOCPBAK",128,0)
 ;
"RTN","PSOCPBAK",129,0)
TOTAL ;
"RTN","PSOCPBAK",130,0)
 N COUNT,COUNTED
"RTN","PSOCPBAK",131,0)
 I '$D(PSOVETS) S PSOVETS=0
"RTN","PSOCPBAK",132,0)
 N I,J
"RTN","PSOCPBAK",133,0)
 F I=1:1:3 S (PSOCNT("YR2002",I),PSOCNT("YR2003",I))=0
"RTN","PSOCPBAK",134,0)
 S PSODFN=0 F  S PSODFN=$O(^XTMP("PSOCPBAK",$J,PSODFN)) Q:'PSODFN  D
"RTN","PSOCPBAK",135,0)
 .S COUNTED=0
"RTN","PSOCPBAK",136,0)
 .F J="YR2002","YR2003" F I=1:1:3 S COUNT=$G(^XTMP("PSOCPBAK",$J,PSODFN,J,I)) I COUNT>0 S:'$G(COUNTED) COUNTED=1,PSOVETS=PSOVETS+1 S PSOCNT(J,I)=PSOCNT(J,I)+COUNT
"RTN","PSOCPBAK",137,0)
 F I=1:1:3 S PSOCNT=PSOCNT+PSOCNT("YR2002",I)+PSOCNT("YR2003",I)
"RTN","PSOCPBAK",138,0)
 Q
"RTN","PSOCPBAK",139,0)
 ;
"RTN","PSOCPBK1")
0^4^B89608216^B89371510
"RTN","PSOCPBK1",1,0)
PSOCPBK1 ;BIR/EJW,GN-Tally unbilled Automated-release refill copays ;8/10/05 12:50pm
"RTN","PSOCPBK1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**215,480**;DEC 1997;Build 35
"RTN","PSOCPBK1",3,0)
 ;External reference to ^XUSEC supported by DBIA 10076
"RTN","PSOCPBK1",4,0)
 ;External reference to IBARX supported by DBIA 125
"RTN","PSOCPBK1",5,0)
 ;External reference to $$PROD^XUPROD(1) supported by DBIA 4440
"RTN","PSOCPBK1",6,0)
 ;
"RTN","PSOCPBK1",7,0)
 N DTOUT,DUOUT,ZTSK,ZTRTN,ZTIO,ZTDTH,ZTDESC
"RTN","PSOCPBK1",8,0)
 I '$D(XPDQUES("POS1")) D  Q:'ZTDTH
"RTN","PSOCPBK1",9,0)
 .K DIR
"RTN","PSOCPBK1",10,0)
 .S DIR("A")="Enter when to Queue the Tally job to run in date@time format "
"RTN","PSOCPBK1",11,0)
 .S DIR("B")="NOW"
"RTN","PSOCPBK1",12,0)
 .S DIR(0)="D^::%DT"
"RTN","PSOCPBK1",13,0)
 .S DIR("?")="Enter when to start the job. The default is Now. You can enter a date and time in the format like this: 081505@3:30p"
"RTN","PSOCPBK1",14,0)
 .D ^DIR I $D(DTOUT)!($D(DUOUT)) W !,"Halting..." S ZTDTH="" Q
"RTN","PSOCPBK1",15,0)
 .S ZTDTH=$$FMTH^XLFDT(Y)
"RTN","PSOCPBK1",16,0)
 ;
"RTN","PSOCPBK1",17,0)
 I $D(XPDQUES("POS1")) S ZTDTH=$$FMTH^XLFDT(XPDQUES("POS1"))
"RTN","PSOCPBK1",18,0)
 ;
"RTN","PSOCPBK1",19,0)
 D BMES^XPDUTL("===================================================")
"RTN","PSOCPBK1",20,0)
 D MES^XPDUTL("Queuing background job to tally unbilled refills...")
"RTN","PSOCPBK1",21,0)
 D MES^XPDUTL("Start time: "_$$HTE^XLFDT(ZTDTH))
"RTN","PSOCPBK1",22,0)
 D MES^XPDUTL("===================================================")
"RTN","PSOCPBK1",23,0)
 L +^XTMP($$NAMSP):0 I '$T D  Q
"RTN","PSOCPBK1",24,0)
 . I ZTDTH="" D BMES^XPDUTL("Tally job is already running.  Halting...")
"RTN","PSOCPBK1",25,0)
 L -^XTMP($$NAMSP)
"RTN","PSOCPBK1",26,0)
 S ZTRTN="EN^PSOCPBK1",ZTIO=""
"RTN","PSOCPBK1",27,0)
 S ZTDESC="Background job to tally unbilled copays for refills via OPAI"
"RTN","PSOCPBK1",28,0)
 D ^%ZTLOAD
"RTN","PSOCPBK1",29,0)
 D:$D(ZTSK)
"RTN","PSOCPBK1",30,0)
 .D BMES^XPDUTL("=========================")
"RTN","PSOCPBK1",31,0)
 .D MES^XPDUTL("Task #"_ZTSK_" Queued!")
"RTN","PSOCPBK1",32,0)
 .D MES^XPDUTL("=========================")
"RTN","PSOCPBK1",33,0)
 .D BMES^XPDUTL("")
"RTN","PSOCPBK1",34,0)
 D BMES^XPDUTL("")
"RTN","PSOCPBK1",35,0)
 K XPDQUES
"RTN","PSOCPBK1",36,0)
 Q
"RTN","PSOCPBK1",37,0)
EN ;
"RTN","PSOCPBK1",38,0)
 N NAMSP S NAMSP=$$NAMSP
"RTN","PSOCPBK1",39,0)
 ;if can't get Lock, then already running.
"RTN","PSOCPBK1",40,0)
 L +^XTMP(NAMSP):3 I '$T S:$D(ZTQUEUED) ZTREQ="@" Q
"RTN","PSOCPBK1",41,0)
 ;if got a lock then must be fresh start, kill possible old Xtmp
"RTN","PSOCPBK1",42,0)
 K ^XTMP(NAMSP)
"RTN","PSOCPBK1",43,0)
 N PSODT,RXP,PSOTEXT,XX,YY,PSOCNT,PSOSTART,PSOEND,PSOVETS,PSOTRX,XIEN
"RTN","PSOCPBK1",44,0)
 N PSOSCMX,PSODFN,PSOREL,PSOAMT,FOUND,V24,PSOTRF,PSOEND2,PSOSTRT2,QQ
"RTN","PSOCPBK1",45,0)
 N PSOTIME,PSOSTNM,PSOS1,PSOINST,I,PSOTC,PSOCNTS,LIN,%,X1,XMY,STOP
"RTN","PSOCPBK1",46,0)
 D NOW^%DTC S (Y,PSOS1)=% D DD^%DT S PSOSTART=Y
"RTN","PSOCPBK1",47,0)
 S PSOSTRT2=$$FMTE^XLFDT(%,"1PS")
"RTN","PSOCPBK1",48,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOCPBK1",49,0)
 I '$D(^XTMP(NAMSP)) S X1=DT D C^%DTC S ^XTMP(NAMSP,0)=$G(X)_"^"_DT_"^Tally of unbilled copays for refills via OPAI, PSO*7*215"
"RTN","PSOCPBK1",50,0)
 ;
"RTN","PSOCPBK1",51,0)
 ;get 1st occurence of install date of patch PSO*7*156 (OPAI)
"RTN","PSOCPBK1",52,0)
 S XIEN=+$O(^XPD(9.7,"B","PSO*7.0*156",0))
"RTN","PSOCPBK1",53,0)
 S PSODT=+$P($G(^XPD(9.7,XIEN,1)),"^",3)
"RTN","PSOCPBK1",54,0)
 I 'PSODT S ^XTMP(NAMSP,0,.1)="OPAI PATCH PSO*7*156 IS NOT INSTALLED" D MAIL3^PSOCPBK2(^XTMP(NAMSP,0,.1)) Q
"RTN","PSOCPBK1",55,0)
 ;
"RTN","PSOCPBK1",56,0)
 ;check if any division is on v2.4 (OPAI interface)
"RTN","PSOCPBK1",57,0)
 S V24=0
"RTN","PSOCPBK1",58,0)
 F XX=0:0 S XX=$O(^PS(59,XX)) Q:'XX  D  Q:V24
"RTN","PSOCPBK1",59,0)
 . S:+$G(^PS(59,XX,"DISP"))=2.4 V24=1
"RTN","PSOCPBK1",60,0)
 I 'V24 D  Q
"RTN","PSOCPBK1",61,0)
 . S ^XTMP(NAMSP,0,.2)="OPAI IS INSTALLED BUT IS NOT TURNED ON"
"RTN","PSOCPBK1",62,0)
 . D MAIL3^PSOCPBK2(^XTMP(NAMSP,0,.2))
"RTN","PSOCPBK1",63,0)
 ;
"RTN","PSOCPBK1",64,0)
 S (PSOTRX,PSOTRF)=1
"RTN","PSOCPBK1",65,0)
 K ^XTMP(NAMSP,0,"STOP") S STOP=0                 ;init stop flag to 0
"RTN","PSOCPBK1",66,0)
 F QQ=1:1 S PSODT=$O(^PSRX("AL",PSODT)) Q:'PSODT  D  Q:STOP
"RTN","PSOCPBK1",67,0)
 .I QQ#100=0,$D(^XTMP(NAMSP,0,"STOP")) K ^XTMP(NAMSP) S STOP=1 Q
"RTN","PSOCPBK1",68,0)
 .S RXP=""
"RTN","PSOCPBK1",69,0)
 .F PSOTRX=PSOTRX+1:1 S RXP=$O(^PSRX("AL",PSODT,RXP)) Q:'RXP  D
"RTN","PSOCPBK1",70,0)
 ..;save last date & fill info
"RTN","PSOCPBK1",71,0)
 ..S ^XTMP(NAMSP,0,"LAST")=PSODT_"^"_RXP_"^"_PSOTRX
"RTN","PSOCPBK1",72,0)
 ..S PSODFN=$P($G(^PSRX(RXP,0)),"^",2)
"RTN","PSOCPBK1",73,0)
 ..Q:('PSODFN)!('$D(^DPT(PSODFN,0)))         ;quit, no valid DFN info
"RTN","PSOCPBK1",74,0)
 ..D XTYPE
"RTN","PSOCPBK1",75,0)
 ..Q:+PSOSCMX=0                              ;quit, Exempt or deceased
"RTN","PSOCPBK1",76,0)
 ..;search refills only, ignore 0=orig fill
"RTN","PSOCPBK1",77,0)
 ..F YY=0:0 S YY=$O(^PSRX("AL",PSODT,RXP,YY)) Q:'YY  D ADDBILL
"RTN","PSOCPBK1",78,0)
 Q:STOP
"RTN","PSOCPBK1",79,0)
 ;
"RTN","PSOCPBK1",80,0)
 S PSOCNT=0
"RTN","PSOCPBK1",81,0)
 D TALLY^PSOCPBK2 Q:STOP
"RTN","PSOCPBK1",82,0)
 D TOTAL
"RTN","PSOCPBK1",83,0)
 D MAIL
"RTN","PSOCPBK1",84,0)
 D MAIL2
"RTN","PSOCPBK1",85,0)
 L -^XTMP(NAMSP)
"RTN","PSOCPBK1",86,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCPBK1",87,0)
 Q
"RTN","PSOCPBK1",88,0)
 ;
"RTN","PSOCPBK1",89,0)
ADDBILL ;add to billable ^XTMP if ok, quit if not
"RTN","PSOCPBK1",90,0)
 S PSOTRF=PSOTRF+1
"RTN","PSOCPBK1",91,0)
 S PSOREL=$P($G(^PSRX(RXP,1,YY,0)),"^",18)
"RTN","PSOCPBK1",92,0)
 Q:'PSOREL                                   ;not released
"RTN","PSOCPBK1",93,0)
 Q:'YY                                       ;orig fill
"RTN","PSOCPBK1",94,0)
 Q:+$$RXST^IBARXEU(PSODFN,$P(PSOREL,"."))    ;Exempt on Rel dte
"RTN","PSOCPBK1",95,0)
 ;check refill
"RTN","PSOCPBK1",96,0)
 Q:$P($G(^PSRX(RXP,1,YY,"IB")),"^",1)'=""    ;already billed
"RTN","PSOCPBK1",97,0)
 Q:$P($G(^PSRX(RXP,1,YY,"IB")),"^",2)'=""    ;exceeded ann. cap
"RTN","PSOCPBK1",98,0)
 ;
"RTN","PSOCPBK1",99,0)
 ;look for Activity log entry per refill # with the below text
"RTN","PSOCPBK1",100,0)
 S FOUND=0
"RTN","PSOCPBK1",101,0)
 F XX=999:0 S XX=$O(^PSRX(RXP,"A",XX),-1) Q:'XX  D  Q:FOUND
"RTN","PSOCPBK1",102,0)
 .Q:$P(^PSRX(RXP,"A",XX,0),"^",4)'=YY
"RTN","PSOCPBK1",103,0)
 .Q:^PSRX(RXP,"A",XX,0)'["External Interface Dispensing is Complete"
"RTN","PSOCPBK1",104,0)
 .S FOUND=1
"RTN","PSOCPBK1",105,0)
 Q:'FOUND
"RTN","PSOCPBK1",106,0)
 ;
"RTN","PSOCPBK1",107,0)
 S ^XTMP(NAMSP,PSODFN,RXP,YY)=$P(PSOREL,".")  ;add to XTMP to be bill
"RTN","PSOCPBK1",108,0)
 Q
"RTN","PSOCPBK1",109,0)
 ;
"RTN","PSOCPBK1",110,0)
MAIL ;
"RTN","PSOCPBK1",111,0)
 N TOTAMT,PSOCXPDA
"RTN","PSOCPBK1",112,0)
 D NOW^%DTC S Y=% D DD^%DT S PSOEND=Y
"RTN","PSOCPBK1",113,0)
 S PSOEND2=$$FMTE^XLFDT(%,"1PS")
"RTN","PSOCPBK1",114,0)
 I $G(DUZ) S XMY(DUZ)=""
"RTN","PSOCPBK1",115,0)
 S XMDUZ="Outpatient Pharmacy",XMSUB="Outpatient Pharmacy Copay Tally"
"RTN","PSOCPBK1",116,0)
 F PSOCXPDA=0:0 S PSOCXPDA=$O(^XUSEC("PSO COPAY",PSOCXPDA)) Q:'PSOCXPDA  S XMY(PSOCXPDA)=""
"RTN","PSOCPBK1",117,0)
 I $O(XMY(""))="" Q  ; no recipients for mail message
"RTN","PSOCPBK1",118,0)
 S PSOTEXT(1)="The Rx copay tally job for the Outpatient Pharmacy patch (PSO*7*215)"
"RTN","PSOCPBK1",119,0)
 S PSOTEXT(2)="started "_PSOSTART_" and completed "_PSOEND_"."
"RTN","PSOCPBK1",120,0)
 I PSOCNT=0 S PSOTEXT(3)="No released unbilled copay fills were found."
"RTN","PSOCPBK1",121,0)
 I PSOCNT>0 D
"RTN","PSOCPBK1",122,0)
 .S TOTAMT=0
"RTN","PSOCPBK1",123,0)
 .F XX="YR2004","YR2005" D
"RTN","PSOCPBK1",124,0)
 ..F YY=1:1:3 S PSOAMT(XX,YY)=PSOCNT(XX,YY)*YY*7,TOTAMT=TOTAMT+PSOAMT(XX,YY)
"RTN","PSOCPBK1",125,0)
 .S PSOTEXT(3)="Auto-Released refills have now been marked as potentials for back billing."
"RTN","PSOCPBK1",126,0)
 .S PSOTEXT(4)="There were "_$FN(PSOCNT,",")_" fills successfully tallied for "_$FN(PSOVETS,",")_" veterans."
"RTN","PSOCPBK1",127,0)
 .S PSOTEXT(5)=" "
"RTN","PSOCPBK1",128,0)
 .S PSOTEXT(6)="Fills eligible for back-billing by year:"
"RTN","PSOCPBK1",129,0)
 .S PSOTEXT(7)="2004  30-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2004",1),6)
"RTN","PSOCPBK1",130,0)
 .S PSOTEXT(7)=PSOTEXT(7)_"     $"_$J($FN(PSOAMT("YR2004",1),","),9)
"RTN","PSOCPBK1",131,0)
 .S PSOTEXT(8)="2004  60-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2004",2),6)
"RTN","PSOCPBK1",132,0)
 .S PSOTEXT(8)=PSOTEXT(8)_"     $"_$J($FN(PSOAMT("YR2004",2),","),9)
"RTN","PSOCPBK1",133,0)
 .S PSOTEXT(9)="2004  90-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2004",3),6)
"RTN","PSOCPBK1",134,0)
 .S PSOTEXT(9)=PSOTEXT(9)_"     $"_$J($FN(PSOAMT("YR2004",3),","),9)
"RTN","PSOCPBK1",135,0)
 .S PSOTEXT(10)=""
"RTN","PSOCPBK1",136,0)
 .S PSOTEXT(11)="2005  30-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2005",1),6)
"RTN","PSOCPBK1",137,0)
 .S PSOTEXT(11)=PSOTEXT(11)_"     $"_$J($FN(PSOAMT("YR2005",1),","),9)
"RTN","PSOCPBK1",138,0)
 .S PSOTEXT(12)="2005  60-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2005",2),6)
"RTN","PSOCPBK1",139,0)
 .S PSOTEXT(12)=PSOTEXT(12)_"     $"_$J($FN(PSOAMT("YR2005",2),","),9)
"RTN","PSOCPBK1",140,0)
 .S PSOTEXT(13)="2005  90-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2005",3),6)
"RTN","PSOCPBK1",141,0)
 .S PSOTEXT(13)=PSOTEXT(13)_"     $"_$J($FN(PSOAMT("YR2005",3),","),9)
"RTN","PSOCPBK1",142,0)
 .S PSOTEXT(14)="                                          =========="
"RTN","PSOCPBK1",143,0)
 .S PSOTEXT(15)="                                    TOTAL $"_$J($FN(TOTAMT,","),9)
"RTN","PSOCPBK1",144,0)
 .S PSOTEXT(16)=" "
"RTN","PSOCPBK1",145,0)
 .S PSOTEXT(17)="To get a report of patients/prescriptions that were identified as potentially"
"RTN","PSOCPBK1",146,0)
 .S PSOTEXT(18)="billable as part of this Tally, enter D RPT^PSOCPBK2 at the programmer's prompt"
"RTN","PSOCPBK1",147,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCPBK1",148,0)
 Q
"RTN","PSOCPBK1",149,0)
 ;
"RTN","PSOCPBK1",150,0)
MAIL2 ;
"RTN","PSOCPBK1",151,0)
 S LIN="",$P(LIN," ",80)=""
"RTN","PSOCPBK1",152,0)
 D NOW^%DTC S PSOTIME=$$FMDIFF^XLFDT(%,$G(PSOS1),2)
"RTN","PSOCPBK1",153,0)
 S PSOINST=$P($G(^DIC(4,+$P($G(^XMB(1,1,"XUS")),"^",17),99)),"^")
"RTN","PSOCPBK1",154,0)
 S PSOSTNM=$P($G(^DIC(4,PSOINST,0)),"^")
"RTN","PSOCPBK1",155,0)
 K PSOTEXT
"RTN","PSOCPBK1",156,0)
 S XMY(DUZ)="",PSOTC=0,PSOCNTS=""
"RTN","PSOCPBK1",157,0)
 F J="YR2004","YR2005" F I=1:1:3 D
"RTN","PSOCPBK1",158,0)
 .S PSOTC=PSOTC+PSOCNT(J,I)
"RTN","PSOCPBK1",159,0)
 .S PSOCNTS=PSOCNTS_","_PSOCNT(J,I)
"RTN","PSOCPBK1",160,0)
 S XMY("NAPOLIELLO.GREG@FORUM.DOMAIN.EXT")=""
"RTN","PSOCPBK1",161,0)
 S XMY("WHITE.ELAINE@FORUM.DOMAIN.EXT")=""
"RTN","PSOCPBK1",162,0)
 S:$$PROD^XUPROD(1) XMY("WILLIAMSON.ERIC@FORUM.DOMAIN.EXT")=""
"RTN","PSOCPBK1",163,0)
 S XMDUZ="PSO*7*215 TALLY"
"RTN","PSOCPBK1",164,0)
 S XMSUB="STATION "_$G(PSOINST)
"RTN","PSOCPBK1",165,0)
 S XMSUB=XMSUB_$S($$PROD^XUPROD(1):"(Prod)",1:"(Test)")
"RTN","PSOCPBK1",166,0)
 S XMSUB=XMSUB_" UNBILLED COPAYS FOR PRESCRIPTION REFILLS"
"RTN","PSOCPBK1",167,0)
 S PSOTEXT(1)="               Start time: "_PSOSTRT2
"RTN","PSOCPBK1",168,0)
 S PSOTEXT(2)="           Completed time: "_PSOEND2
"RTN","PSOCPBK1",169,0)
 S PSOTEXT(3)="             Elapsed Time: "_$$ETIME^PSOCPBK2(PSOTIME)
"RTN","PSOCPBK1",170,0)
 S PSOTEXT(4)=""
"RTN","PSOCPBK1",171,0)
 S PSOTEXT(5)="     Total RX's processed: "_$J($FN(PSOTRX,","),8)
"RTN","PSOCPBK1",172,0)
 S PSOTEXT(6)="  Total Refills processed: "_$J($FN(PSOTRF,","),8)
"RTN","PSOCPBK1",173,0)
 S PSOTEXT(7)="   Total billable refills: "_$J($FN(PSOTC,","),8)
"RTN","PSOCPBK1",174,0)
 S PSOTEXT(8)="      Total billable vets: "_$J($FN(PSOVETS,","),8)
"RTN","PSOCPBK1",175,0)
 S PSOTEXT(9)=""
"RTN","PSOCPBK1",176,0)
 S PSOTEXT(10)="Excel comma delimited data below, Two heading, one data line"
"RTN","PSOCPBK1",177,0)
 S PSOTEXT(11)=""
"RTN","PSOCPBK1",178,0)
 S PSOTEXT(12)="Copy and paste any of the 2 heading & 1 data rows into Excel.  Then click "
"RTN","PSOCPBK1",179,0)
 S PSOTEXT(13)="'Data', 'Text to Columns..', check 'Delimited', click Next, check 'Comma',"
"RTN","PSOCPBK1",180,0)
 S PSOTEXT(14)="and click Finish"
"RTN","PSOCPBK1",181,0)
 S PSOTEXT(15)=""
"RTN","PSOCPBK1",182,0)
 S PSOTEXT(16)=$E(("Station,Station,,2004,,,2005"_LIN),1,79)
"RTN","PSOCPBK1",183,0)
 S PSOTEXT(17)=$E(("Name,#,30 days,60 days,90 days,30 days,60 days,90 days"_LIN),1,79)
"RTN","PSOCPBK1",184,0)
 S PSOTEXT(18)=$E((PSOSTNM_","_PSOINST_PSOCNTS_LIN),1,79)
"RTN","PSOCPBK1",185,0)
 S PSOTEXT(19)=""
"RTN","PSOCPBK1",186,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCPBK1",187,0)
 Q
"RTN","PSOCPBK1",188,0)
 ;
"RTN","PSOCPBK1",189,0)
XTYPE ;
"RTN","PSOCPBK1",190,0)
 N Y,VADM,I,J,X,SAVY,DFN
"RTN","PSOCPBK1",191,0)
 S DFN=PSODFN D DEM^VADPT I +$G(VADM(6)) S PSOSCMX="" Q  ; DECEASED
"RTN","PSOCPBK1",192,0)
 S (X,PSOSCMX,SAVY)=""
"RTN","PSOCPBK1",193,0)
 S J=0 F  S J=$O(^PS(59,J)) Q:'J  I +$G(^(J,"IB")) S X=+^("IB") Q
"RTN","PSOCPBK1",194,0)
 I 'X Q
"RTN","PSOCPBK1",195,0)
 S X=X_"^"_PSODFN D XTYPE^IBARX
"RTN","PSOCPBK1",196,0)
 I $G(Y)'=1 Q
"RTN","PSOCPBK1",197,0)
 S J="" F  S J=$O(Y(J)) Q:'J  S I="" F  S SAVY=I,I=$O(Y(J,I)) Q:I=""  S:I>0 PSOSCMX=I
"RTN","PSOCPBK1",198,0)
 I PSOSCMX="",SAVY=0 S PSOEXMPT=1 Q  ; INCOME EXEMPT OR SERVICE-CONNECTED
"RTN","PSOCPBK1",199,0)
 I PSOSCMX=2 Q  ; NEED TO ASK SC QUESTION
"RTN","PSOCPBK1",200,0)
 Q
"RTN","PSOCPBK1",201,0)
 ;
"RTN","PSOCPBK1",202,0)
TOTAL ;
"RTN","PSOCPBK1",203,0)
 N COUNT,COUNTED
"RTN","PSOCPBK1",204,0)
 I '$D(PSOVETS) S PSOVETS=0
"RTN","PSOCPBK1",205,0)
 N I,J
"RTN","PSOCPBK1",206,0)
 F I=1:1:3 S (PSOCNT("YR2004",I),PSOCNT("YR2005",I))=0
"RTN","PSOCPBK1",207,0)
 S PSODFN=0 F  S PSODFN=$O(^XTMP(NAMSP,PSODFN)) Q:'PSODFN  D
"RTN","PSOCPBK1",208,0)
 .S COUNTED=0
"RTN","PSOCPBK1",209,0)
 .F J="YR2004","YR2005" F I=1:1:3 S COUNT=$G(^XTMP(NAMSP,PSODFN,J,I)) I COUNT>0 S:'$G(COUNTED) COUNTED=1,PSOVETS=PSOVETS+1 S PSOCNT(J,I)=PSOCNT(J,I)+COUNT
"RTN","PSOCPBK1",210,0)
 F I=1:1:3 S PSOCNT=PSOCNT+PSOCNT("YR2004",I)+PSOCNT("YR2005",I)
"RTN","PSOCPBK1",211,0)
 Q
"RTN","PSOCPBK1",212,0)
 ;
"RTN","PSOCPBK1",213,0)
STATUS ;show status of job running
"RTN","PSOCPBK1",214,0)
 I $$ST D
"RTN","PSOCPBK1",215,0)
 .W !,"Currently processing:"
"RTN","PSOCPBK1",216,0)
 .W !?5,"Released Date > ",+^XTMP($$NAMSP,0,"LAST")
"RTN","PSOCPBK1",217,0)
 .W !?5,"         RX # > ",$P(^XTMP($$NAMSP,0,"LAST"),"^",2)
"RTN","PSOCPBK1",218,0)
 .W !?5,"   TOTAL RX's > ",$P(^XTMP($$NAMSP,0,"LAST"),"^",3),!
"RTN","PSOCPBK1",219,0)
 Q
"RTN","PSOCPBK1",220,0)
 ;
"RTN","PSOCPBK1",221,0)
STOP ;stop job command
"RTN","PSOCPBK1",222,0)
 I $$ST S ^XTMP($$NAMSP,0,"STOP")="" D
"RTN","PSOCPBK1",223,0)
 .W !,"Outpatient RX Copay Tally Job - set to STOP Soon"
"RTN","PSOCPBK1",224,0)
 .W !!,"Check Status to be sure it has stopped and is not running..."
"RTN","PSOCPBK1",225,0)
 .W !,"     (D STATUS^PSOCPBK1)"
"RTN","PSOCPBK1",226,0)
 Q
"RTN","PSOCPBK1",227,0)
ST() ;status
"RTN","PSOCPBK1",228,0)
 L +^XTMP($$NAMSP):3 I $T D  Q 0
"RTN","PSOCPBK1",229,0)
 .L -^XTMP($$NAMSP)
"RTN","PSOCPBK1",230,0)
 .W !,"*** TALLY NOT CURRENTLY RUNNING! ***",!
"RTN","PSOCPBK1",231,0)
 Q 1
"RTN","PSOCPBK1",232,0)
NAMSP() ;
"RTN","PSOCPBK1",233,0)
 Q $T(+0)
"RTN","PSOCPBK4")
0^5^B93078909^B92981238
"RTN","PSOCPBK4",1,0)
PSOCPBK4 ;BIR/GN-Copay Back Bill for Automated-release refills cont. ;10/12/05 9:55am
"RTN","PSOCPBK4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**217,303,460,480**;DEC 1997;Build 35
"RTN","PSOCPBK4",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOCPBK4",4,0)
 ;External reference to ^IBAM(354.7 supported by DBIA 3877
"RTN","PSOCPBK4",5,0)
 ;External reference to $$PTCOV^IBCNSU3 supported by DBIA 4115
"RTN","PSOCPBK4",6,0)
 ;External reference to ^IBARX supported by DBIA 125
"RTN","PSOCPBK4",7,0)
 ;External reference to $$CPTIER^PSNAPIS(P1,P3) supported by DBIA #2531
"RTN","PSOCPBK4",8,0)
 ;External reference to ^DPT supported by DBIA #10035
"RTN","PSOCPBK4",9,0)
 ;External reference to IBARXEU supported by DBIA #10147
"RTN","PSOCPBK4",10,0)
 ;
"RTN","PSOCPBK4",11,0)
 Q
"RTN","PSOCPBK4",12,0)
 ;
"RTN","PSOCPBK4",13,0)
ADDBILL ;add to billable ^XTMP if ok, quit if not
"RTN","PSOCPBK4",14,0)
 S PSOTRF=PSOTRF+1
"RTN","PSOCPBK4",15,0)
 S PSOREL=$P($G(^PSRX(RXP,1,YY,0)),"^",18)
"RTN","PSOCPBK4",16,0)
 Q:'PSOREL                                   ;not released
"RTN","PSOCPBK4",17,0)
 Q:'YY                                       ;orig fill
"RTN","PSOCPBK4",18,0)
 Q:+$$RXST^IBARXEU(PSODFN,$P(PSOREL,"."))    ;Exempt on Rel dte
"RTN","PSOCPBK4",19,0)
 ;check refill
"RTN","PSOCPBK4",20,0)
 Q:$P($G(^PSRX(RXP,1,YY,"IB")),"^",1)'=""    ;already billed
"RTN","PSOCPBK4",21,0)
 Q:$P($G(^PSRX(RXP,1,YY,"IB")),"^",2)'=""    ;exceeded ann. cap
"RTN","PSOCPBK4",22,0)
 ;
"RTN","PSOCPBK4",23,0)
 ;look for Activity log entry per refill # with the below text
"RTN","PSOCPBK4",24,0)
 S FOUND=0
"RTN","PSOCPBK4",25,0)
 F XX=999:0 S XX=$O(^PSRX(RXP,"A",XX),-1) Q:'XX  D  Q:FOUND
"RTN","PSOCPBK4",26,0)
 .Q:$P(^PSRX(RXP,"A",XX,0),"^",4)'=YY
"RTN","PSOCPBK4",27,0)
 .Q:^PSRX(RXP,"A",XX,0)'["External Interface Dispensing is Complete"
"RTN","PSOCPBK4",28,0)
 .S FOUND=1
"RTN","PSOCPBK4",29,0)
 Q:'FOUND
"RTN","PSOCPBK4",30,0)
 ;
"RTN","PSOCPBK4",31,0)
 S ^XTMP(NAMSP,PSODFN,RXP,YY)=$P(PSOREL,".")  ;add to XTMP to be bill
"RTN","PSOCPBK4",32,0)
 Q
"RTN","PSOCPBK4",33,0)
 ;
"RTN","PSOCPBK4",34,0)
XTYPE ;
"RTN","PSOCPBK4",35,0)
 N Y,VADM,I,J,X,SAVY,DFN
"RTN","PSOCPBK4",36,0)
 S DFN=PSODFN D DEM^VADPT I +$G(VADM(6)) S PSOSCMX="" Q  ; DECEASED
"RTN","PSOCPBK4",37,0)
 S (X,PSOSCMX,SAVY)=""
"RTN","PSOCPBK4",38,0)
 S J=0 F  S J=$O(^PS(59,J)) Q:'J  I +$G(^(J,"IB")) S X=+^("IB") Q
"RTN","PSOCPBK4",39,0)
 I 'X Q
"RTN","PSOCPBK4",40,0)
 S X=X_"^"_PSODFN D XTYPE^IBARX
"RTN","PSOCPBK4",41,0)
 I $G(Y)'=1 Q
"RTN","PSOCPBK4",42,0)
 S J="" F  S J=$O(Y(J)) Q:'J  S I="" F  S SAVY=I,I=$O(Y(J,I)) Q:I=""  S:I>0 PSOSCMX=I
"RTN","PSOCPBK4",43,0)
 I PSOSCMX="",SAVY=0 S PSOEXMPT=1 Q  ; INCOME EXEMPT OR SERVICE-CONNECTED
"RTN","PSOCPBK4",44,0)
 I PSOSCMX=2 Q  ; NEED TO ASK SC QUESTION
"RTN","PSOCPBK4",45,0)
 Q
"RTN","PSOCPBK4",46,0)
 ;
"RTN","PSOCPBK4",47,0)
TOTAL ;
"RTN","PSOCPBK4",48,0)
 N COUNT,COUNTED
"RTN","PSOCPBK4",49,0)
 I '$D(PSOVETS) S PSOVETS=0
"RTN","PSOCPBK4",50,0)
 N I,J
"RTN","PSOCPBK4",51,0)
 F I=1:1:3 S (PSOCNT("YR2004",I),PSOCNT("YR2005",I))=0
"RTN","PSOCPBK4",52,0)
 S PSODFN=0 F  S PSODFN=$O(^XTMP(NAMSP,PSODFN)) Q:'PSODFN  D
"RTN","PSOCPBK4",53,0)
 .S COUNTED=0
"RTN","PSOCPBK4",54,0)
 .F J="YR2004","YR2005" F I=1:1:3 S COUNT=$G(^XTMP(NAMSP,PSODFN,J,I)) I COUNT>0 S:'$G(COUNTED) COUNTED=1,PSOVETS=PSOVETS+1 S PSOCNT(J,I)=PSOCNT(J,I)+COUNT
"RTN","PSOCPBK4",55,0)
 F I=1:1:3 S PSOCNT=PSOCNT+PSOCNT("YR2004",I)+PSOCNT("YR2005",I)
"RTN","PSOCPBK4",56,0)
 Q
"RTN","PSOCPBK4",57,0)
 ;
"RTN","PSOCPBK4",58,0)
BILLIT ;
"RTN","PSOCPBK4",59,0)
 ; IF NO IB NUMBER FOR THIS FILL, SET UP VARIABLES AND TALLY
"RTN","PSOCPBK4",60,0)
 N PSOCAP,PSODIV,PSODV,PSOFILL,PSOLOG,PSOOUT,PSOPAR,PSOPATID,PSOSITE
"RTN","PSOCPBK4",61,0)
 N PSOSITE7,PSOSQ,PSOTOT,PSOYEAR,PSOYR,SSN,SAVCPUN,SAVREF
"RTN","PSOCPBK4",62,0)
 S PSODFN=0
"RTN","PSOCPBK4",63,0)
 F CC=1:1 S PSODFN=$O(^XTMP(NAMSP,PSODFN)) Q:'PSODFN  D  Q:STOP
"RTN","PSOCPBK4",64,0)
 .I CC#100=0,$D(^XTMP(NAMSP,0,"STOP")) D  Q
"RTN","PSOCPBK4",65,0)
 ..S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="STOP^"_$$NOW^XLFDT,STOP=1
"RTN","PSOCPBK4",66,0)
 .S (PSOCAP(304),PSOCAP(305))=0 ; INITIAL ANNUAL CAP FOR 2004 & 2005
"RTN","PSOCPBK4",67,0)
 .F RXP=0:0 S RXP=$O(^XTMP(NAMSP,PSODFN,RXP)) Q:'RXP  D
"RTN","PSOCPBK4",68,0)
 ..;calc number of 30-day units eligible to bill
"RTN","PSOCPBK4",69,0)
 ..S (SAVCPUN,PSOCPUN)=($P(^PSRX(RXP,0),"^",8)+29)\30
"RTN","PSOCPBK4",70,0)
 ..F YY=0:0 S YY=$O(^XTMP(NAMSP,PSODFN,RXP,YY)) Q:YY=""  D
"RTN","PSOCPBK4",71,0)
 ...S (SAVREF,PSOREF)=YY
"RTN","PSOCPBK4",72,0)
 ...S PSOREL=$G(^XTMP(NAMSP,PSODFN,RXP,YY))
"RTN","PSOCPBK4",73,0)
 ...I PSOCAP($E(PSOREL,1,3)) Q  ; MET ANNUAL CAP FOR 2004 OR 2005
"RTN","PSOCPBK4",74,0)
 ...I $P($G(^PSRX(RXP,1,YY,"IB")),"^",1)="" D  ; REFILL LEVEL
"RTN","PSOCPBK4",75,0)
 ....D SITE
"RTN","PSOCPBK4",76,0)
 ....D CP^PSOCP                                     ;call back billing
"RTN","PSOCPBK4",77,0)
 ....S PSOCPUN=SAVCPUN,PSOREF=SAVREF
"RTN","PSOCPBK4",78,0)
 ....I $P($G(^PSRX(RXP,1,YY,"IB")),"^",1) D ACCUM   ;Do if was billed?
"RTN","PSOCPBK4",79,0)
 ....D CP I +$G(PSOREF) D ACCUM
"RTN","PSOCPBK4",80,0)
 Q
"RTN","PSOCPBK4",81,0)
 ;
"RTN","PSOCPBK4",82,0)
CP ; Entry point to Check if COPAY  -   Requires RXP,PSOSITE7
"RTN","PSOCPBK4",83,0)
 I '$D(PSOPAR) D ^PSOLSET G CP
"RTN","PSOCPBK4",84,0)
 K PSOCP
"RTN","PSOCPBK4",85,0)
 S PSOCPN=$P(^PSRX(RXP,0),"^",2) ; Set COPAY dfn PTR TO PATIENT
"RTN","PSOCPBK4",86,0)
 S PSOCP=$P($G(^PSRX(RXP,"IB")),"^") ; IB action type
"RTN","PSOCPBK4",87,0)
 S PSOSAVE=$S(PSOCP:1,1:"") ; save current copay status
"RTN","PSOCPBK4",88,0)
 ;         Set x=service^dfn^actiontype^user duz
"RTN","PSOCPBK4",89,0)
 I +$G(PSOSITE7)'>0 S PSOSITE7=$P(^PS(59,PSOSITE,"IB"),"^")
"RTN","PSOCPBK4",90,0)
 S X=PSOSITE7_"^"_PSOCPN_"^"_PSOCP_"^"_$P(^PSRX(RXP,0),"^",16)
"RTN","PSOCPBK4",91,0)
 ;
"RTN","PSOCPBK4",92,0)
RX ;         Determine Original or Refill for RX
"RTN","PSOCPBK4",93,0)
 N PSOIB
"RTN","PSOCPBK4",94,0)
 S PSOIB=0
"RTN","PSOCPBK4",95,0)
 S PSOREF=0
"RTN","PSOCPBK4",96,0)
 ;set refill number if this is a refill
"RTN","PSOCPBK4",97,0)
 I $G(^PSRX(RXP,1,+$G(YY),0))]"" S PSOREF=YY
"RTN","PSOCPBK4",98,0)
 ;
"RTN","PSOCPBK4",99,0)
 ;Orig fill -check if bill # already exists
"RTN","PSOCPBK4",100,0)
 I 'PSOREF,+$P($G(^PSRX(RXP,"IB")),"^",2)>0 D CHKIB^PSOCP1
"RTN","PSOCPBK4",101,0)
 I PSOIB D QUIT Q
"RTN","PSOCPBK4",102,0)
 ;already attempted to bill, but exceeded Anuual Cap
"RTN","PSOCPBK4",103,0)
 I 'PSOREF,+$P($G(^PSRX(RXP,"IB")),"^",4)>0 D QUIT Q
"RTN","PSOCPBK4",104,0)
 ;
"RTN","PSOCPBK4",105,0)
 ;Refill -check if bill # already exists
"RTN","PSOCPBK4",106,0)
 I PSOREF,+$G(^PSRX(RXP,1,PSOREF,"IB")) D CHKIB^PSOCP1
"RTN","PSOCPBK4",107,0)
 I PSOIB D QUIT Q
"RTN","PSOCPBK4",108,0)
 ;already attempted to bill, but exceeded Anuual Cap
"RTN","PSOCPBK4",109,0)
 I PSOREF,+$P($G(^PSRX(RXP,1,PSOREF,"IB")),"^",2) G QUIT
"RTN","PSOCPBK4",110,0)
 ;
"RTN","PSOCPBK4",111,0)
 ;set temporary variable to copay and then look for exceptions
"RTN","PSOCPBK4",112,0)
 S PSOCHG=1
"RTN","PSOCPBK4",113,0)
 D COPAYREL
"RTN","PSOCPBK4",114,0)
 I 'PSOCHG D QUIT Q           ;not billable
"RTN","PSOCPBK4",115,0)
 I PSOCHG=2,'PSOCP D QUIT
"RTN","PSOCPBK4",116,0)
 Q
"RTN","PSOCPBK4",117,0)
QUIT ;
"RTN","PSOCPBK4",118,0)
 K Y,PSOCP1,PSOREF,PSOCPUN,PSOCP2,PSOCPN,X,PSOCHG,PSOSAVE,PREA,PSORSN,PSOCOMM,PSOOLD,PSONW,PSODA
"RTN","PSOCPBK4",119,0)
 Q
"RTN","PSOCPBK4",120,0)
 ;
"RTN","PSOCPBK4",121,0)
COPAYREL ; Recheck copay status at release
"RTN","PSOCPBK4",122,0)
 ;
"RTN","PSOCPBK4",123,0)
 ; check Rx patient status
"RTN","PSOCPBK4",124,0)
 I $P(^PSRX(RXP,0),"^",3)'="",$P($G(^PS(53,$P(^PSRX(RXP,0),"^",3),0)),"^",7)=1 S PSOCHG=0 Q
"RTN","PSOCPBK4",125,0)
 ; see if drug is nutritional supplement, investigational or supply
"RTN","PSOCPBK4",126,0)
 N DRG,DRGTYP,PSOEXMPT
"RTN","PSOCPBK4",127,0)
 S DRG=+$P(^PSRX(RXP,0),"^",6),DRGTYP=$P($G(^PSDRUG(DRG,0)),"^",3)
"RTN","PSOCPBK4",128,0)
 I DRGTYP["I"!(DRGTYP["S")!(DRGTYP["N") S PSOCHG=0,PSOEXMPT=1 Q
"RTN","PSOCPBK4",129,0)
 K PSOTG,CHKXTYPE
"RTN","PSOCPBK4",130,0)
 I +$G(^PSRX(RXP,"IBQ")) D XTYPE1^PSOCP1
"RTN","PSOCPBK4",131,0)
 I $G(^PSRX(RXP,"IBQ"))["1" S PSOCHG=0 Q
"RTN","PSOCPBK4",132,0)
 ;***** begin - for regression test - sites must not use this as it will adversely affect billing results - only used by SQA
"RTN","PSOCPBK4",133,0)
 ; The following is required for testing different effective dates.  If date is less than 02/27/17 bills old way.  Otherwise bills new way.
"RTN","PSOCPBK4",134,0)
 ;S ^XTMP("PSOTIEREFTST",0)="3201231^3170227^FOR SQA TESTING ONLY" - Defined for SQA testing only.   Delete this XTMP when regression complete
"RTN","PSOCPBK4",135,0)
 D NOW^%DTC N PSOTIERE
"RTN","PSOCPBK4",136,0)
 S PSOTIERE=1  ;use copay tiers - new
"RTN","PSOCPBK4",137,0)
 I $P(%,".")<3170227 S PSOTIERE=0  ;legacy billing - old
"RTN","PSOCPBK4",138,0)
 I $G(^XTMP("PSOTIEREFTST",0)) S PSOTIERE=1  ;for SQA testing only - bill with copay tiers - new
"RTN","PSOCPBK4",139,0)
 ;***** end for regression test
"RTN","PSOCPBK4",140,0)
 G COPAYRE1:'PSOTIERE
"RTN","PSOCPBK4",141,0)
 ; check copay tier. Tier zero does not have copay charges
"RTN","PSOCPBK4",142,0)
 N CPDATE,X,PSOCPT D NOW^%DTC S CPDATE=X S PSOCPT=$$CPTIER^PSNAPIS("",CPDATE,DRG) K CPDATE,X
"RTN","PSOCPBK4",143,0)
 I $P(PSOCPT,"^")=0 S PSOCHG=0 Q   ;Tier zero do not send to IB for copay charge
"RTN","PSOCPBK4",144,0)
 I '$G(PSOEXMPT),$P(PSOCPT,"^")'=0 S PSOCOMM="",PSOOLD="No Copay",PSONW="Copay" S PSODA=RXP,PREA="R" D ACTLOG^PSOCPA
"RTN","PSOCPBK4",145,0)
COPAYRE1 ;
"RTN","PSOCPBK4",146,0)
 Q
"RTN","PSOCPBK4",147,0)
 ;
"RTN","PSOCPBK4",148,0)
ACCUM ; ACCUMULATE TOTALS AND SEE IF PATIENT MET ANNUAL CAP
"RTN","PSOCPBK4",149,0)
 S PSOYR=$E(PSOREL,1,3) I PSOYR="" Q
"RTN","PSOCPBK4",150,0)
 S PSOYEAR=$S(PSOYR="304":"YR2004",PSOYR="305":"YR2005",1:"")
"RTN","PSOCPBK4",151,0)
 Q:PSOYEAR=""
"RTN","PSOCPBK4",152,0)
 ;
"RTN","PSOCPBK4",153,0)
 ;get Xtmp billing amt which would be IBAM tot + any previous refills
"RTN","PSOCPBK4",154,0)
 S PSOTOT=$G(^XTMP(NAMSP,PSODFN,PSOYEAR))
"RTN","PSOCPBK4",155,0)
 ;
"RTN","PSOCPBK4",156,0)
 ;if none yet then init to the IBAM total for the year
"RTN","PSOCPBK4",157,0)
 I 'PSOTOT D
"RTN","PSOCPBK4",158,0)
 .F PSOSQ=0:0 S PSOSQ=$O(^IBAM(354.7,PSODFN,1,PSOSQ)) Q:'PSOSQ  D
"RTN","PSOCPBK4",159,0)
 ..S PSOLOG=$G(^IBAM(354.7,PSODFN,1,PSOSQ,0))
"RTN","PSOCPBK4",160,0)
 ..I $E(PSOLOG,1,3)=PSOYR S PSOTOT=PSOTOT+$P(PSOLOG,"^",2)
"RTN","PSOCPBK4",161,0)
 ;
"RTN","PSOCPBK4",162,0)
 ;update Xtmp tot nodes with current refill amounts
"RTN","PSOCPBK4",163,0)
 S ^XTMP(NAMSP,PSODFN,PSOYEAR)=PSOTOT+(PSOCPUN*7)
"RTN","PSOCPBK4",164,0)
 S ^XTMP(NAMSP,PSODFN,PSOYEAR,PSOCPUN)=$G(^XTMP(NAMSP,PSODFN,PSOYEAR,PSOCPUN))+1
"RTN","PSOCPBK4",165,0)
 ;
"RTN","PSOCPBK4",166,0)
 ;indicate this refill may be billable or (was billed, if BILLING run)
"RTN","PSOCPBK4",167,0)
 ;by adding to Xtmp "BILLED"
"RTN","PSOCPBK4",168,0)
 N PSONAM
"RTN","PSOCPBK4",169,0)
 S PSONAM=$P($G(^DPT(PSODFN,0)),"^"),PSONAM=$P(PSONAM,",")
"RTN","PSOCPBK4",170,0)
 S PSONAM=$E(PSONAM,1,6)
"RTN","PSOCPBK4",171,0)
 S ^XTMP(NAMSP,"BILLED",PSONAM,PSODFN,RXP,PSOREF)=PSOREL
"RTN","PSOCPBK4",172,0)
 Q
"RTN","PSOCPBK4",173,0)
 ;
"RTN","PSOCPBK4",174,0)
SITE ; SET UP VARIABLES NEEDED BY BILLING
"RTN","PSOCPBK4",175,0)
 S PSOSITE=$S(YY=0:$P(^PSRX(RXP,2),"^",9),1:$P($G(^PSRX(RXP,1,YY,0)),"^",9))
"RTN","PSOCPBK4",176,0)
 Q:PSOSITE=""
"RTN","PSOCPBK4",177,0)
 S PSOPAR=$G(^PS(59,PSOSITE,1))
"RTN","PSOCPBK4",178,0)
 S PSOSITE7=$P($G(^PS(59,PSOSITE,"IB")),"^")
"RTN","PSOCPBK4",179,0)
 Q
"RTN","PSOCPBK4",180,0)
 ;
"RTN","PSOCPBK4",181,0)
RPT ;
"RTN","PSOCPBK4",182,0)
 N JOBN,NAMSP,ZTDESC,ZTRTN
"RTN","PSOCPBK4",183,0)
 S NAMSP=$$NAMSP^PSOCPBK3
"RTN","PSOCPBK4",184,0)
 S JOBN=$S(^XTMP(NAMSP,0)["BACK":"Back Billing",1:"Tally")
"RTN","PSOCPBK4",185,0)
 L +^XTMP(NAMSP):0 I '$T D  Q
"RTN","PSOCPBK4",186,0)
 .W !,JOBN_" job for PSO*7*217 is still running.  Halting..."
"RTN","PSOCPBK4",187,0)
 L -^XTMP(NAMSP)
"RTN","PSOCPBK4",188,0)
 W !!,"This report shows the patient name and prescription information for refills"
"RTN","PSOCPBK4",189,0)
 W:JOBN["Tally" !,"that were identified as billable by the patch PSO*7*217"
"RTN","PSOCPBK4",190,0)
 W:JOBN["Back" !,"that were back-billed by the patch PSO*7*217"
"RTN","PSOCPBK4",191,0)
 W !!,"You may queue the report to print, if you wish.",!
"RTN","PSOCPBK4",192,0)
 ;
"RTN","PSOCPBK4",193,0)
DVC K %ZIS,POP,IOP S %ZIS="QM" D ^%ZIS I $G(POP) W !!,"Nothing queued to print.",! G DONE
"RTN","PSOCPBK4",194,0)
QUEUE I $D(IO("Q")) S ZTRTN="START^PSOCPBK4",ZTDESC=JOBN_" copay report" D ^%ZTLOAD K %ZSI W !,"Report queued to print.",! G DONE
"RTN","PSOCPBK4",195,0)
START ;
"RTN","PSOCPBK4",196,0)
 U IO
"RTN","PSOCPBK4",197,0)
 N BLDT,RXO,NAMSP,PSOFILL,PSODFN,PSONAM,PSOOUT,PSODV,RXP,SSN,PSODIV
"RTN","PSOCPBK4",198,0)
 N JOBN,PSOPATID
"RTN","PSOCPBK4",199,0)
 S NAMSP=$$NAMSP^PSOCPBK3
"RTN","PSOCPBK4",200,0)
 S JOBN=$S(^XTMP(NAMSP,0)["BACK":"Back Billing",1:"Tally")
"RTN","PSOCPBK4",201,0)
 S PSOOUT=0,PSODV=$S($E(IOST)="C":"C",1:"P")
"RTN","PSOCPBK4",202,0)
 S PSOPGCT=0,PSOPGLN=IOSL-7,PSOPGCT=1
"RTN","PSOCPBK4",203,0)
 S BLDT=$P($G(^XTMP(NAMSP,0,"LAST")),"^",2)
"RTN","PSOCPBK4",204,0)
 D TITLE
"RTN","PSOCPBK4",205,0)
 S PSONAM=""
"RTN","PSOCPBK4",206,0)
 F  S PSONAM=$O(^XTMP(NAMSP,"BILLED",PSONAM)) Q:PSONAM=""  D
"RTN","PSOCPBK4",207,0)
 .S PSODFN=""
"RTN","PSOCPBK4",208,0)
 .F  S PSODFN=$O(^XTMP(NAMSP,"BILLED",PSONAM,PSODFN)) Q:PSODFN=""  D
"RTN","PSOCPBK4",209,0)
 ..S RXP=""
"RTN","PSOCPBK4",210,0)
 ..F  S RXP=$O(^XTMP(NAMSP,"BILLED",PSONAM,PSODFN,RXP)) Q:RXP=""  D
"RTN","PSOCPBK4",211,0)
 ...S PSOFILL=""
"RTN","PSOCPBK4",212,0)
 ...F  S PSOFILL=$O(^XTMP(NAMSP,"BILLED",PSONAM,PSODFN,RXP,PSOFILL)) Q:PSOFILL=""  D
"RTN","PSOCPBK4",213,0)
 ....N XX,RXO,Y,PSONAME
"RTN","PSOCPBK4",214,0)
 ....S XX=$G(^XTMP(NAMSP,"BILLED",PSONAM,PSODFN,RXP,PSOFILL)) D
"RTN","PSOCPBK4",215,0)
 .....D FULL Q:$G(PSOOUT)  S PSONAME=$P($G(^DPT(PSODFN,0)),"^")
"RTN","PSOCPBK4",216,0)
 .....W !,$E(PSONAME,1,14)
"RTN","PSOCPBK4",217,0)
 .....D PRTSSN
"RTN","PSOCPBK4",218,0)
 .....S RXO=$P($G(^PSRX(RXP,0)),"^")
"RTN","PSOCPBK4",219,0)
 .....W ?42," ",RXO," (",PSOFILL,")"
"RTN","PSOCPBK4",220,0)
 .....S Y=XX I Y>0 X ^DD("DD")
"RTN","PSOCPBK4",221,0)
 .....W ?55," ",Y
"RTN","PSOCPBK4",222,0)
 .....W ?69,$S($$PTCOV^IBCNSU3(PSODFN,XX,"PHARMACY"):"YES",1:" NO")
"RTN","PSOCPBK4",223,0)
 .....W ?75,$S($$PTCOV^IBCNSU3(PSODFN,BLDT,"PHARMACY"):"YES",1:" NO")
"RTN","PSOCPBK4",224,0)
 G END
"RTN","PSOCPBK4",225,0)
 ;
"RTN","PSOCPBK4",226,0)
FULL ;
"RTN","PSOCPBK4",227,0)
 I ($Y+7)>IOSL&('$G(PSOOUT)) D TITLE
"RTN","PSOCPBK4",228,0)
 Q
"RTN","PSOCPBK4",229,0)
 ;
"RTN","PSOCPBK4",230,0)
TITLE ;
"RTN","PSOCPBK4",231,0)
 I $G(PSODV)="C",$G(PSOPGCT)'=1 W ! K DIR S DIR(0)="E" D ^DIR K DIR I 'Y S PSOOUT=1 Q
"RTN","PSOCPBK4",232,0)
 ;
"RTN","PSOCPBK4",233,0)
 W @IOF D
"RTN","PSOCPBK4",234,0)
 . W !,"Patch PSO*7*217 -COPAY PRESCRIPTION REFILLS "_JOBN
"RTN","PSOCPBK4",235,0)
 S Y=DT X ^DD("DD") W !,"Date printed: ",Y,?70,"Page: ",PSOPGCT,!
"RTN","PSOCPBK4",236,0)
 F MJT=1:1:79 W "="
"RTN","PSOCPBK4",237,0)
 W !,?69,"INS ON DTE"
"RTN","PSOCPBK4",238,0)
 W !,"PATIENT NAME     (SSN)       DIV",?43,"RX# (FILL)",?55,"RELEASE DATE",?69,"REL   BILL"
"RTN","PSOCPBK4",239,0)
 W !,"--------------  -------  ----------------",?42,"------------"
"RTN","PSOCPBK4",240,0)
 W ?55,"------------",?69,"---- -----"
"RTN","PSOCPBK4",241,0)
 S PSOPGCT=PSOPGCT+1
"RTN","PSOCPBK4",242,0)
 Q
"RTN","PSOCPBK4",243,0)
END ;
"RTN","PSOCPBK4",244,0)
 I '$G(PSOOUT),$G(PSODV)="C" W !!,"** End of Report **" K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOCPBK4",245,0)
 I $G(PSODV)="C" W !
"RTN","PSOCPBK4",246,0)
 E  W @IOF
"RTN","PSOCPBK4",247,0)
DONE ;
"RTN","PSOCPBK4",248,0)
 K MJT,PSOPGCT,PSOPGLN,Y,DIR,X,IOP,POP,IO("Q"),DIRUT,DUOUT,DTOUT
"RTN","PSOCPBK4",249,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCPBK4",250,0)
 Q
"RTN","PSOCPBK4",251,0)
 ;
"RTN","PSOCPBK4",252,0)
PRTSSN ;
"RTN","PSOCPBK4",253,0)
 S SSN=$P(^DPT(PSODFN,0),"^",9),SSN=$E(SSN,$L(SSN)-3,$L(SSN))
"RTN","PSOCPBK4",254,0)
 S PSOPATID=$E(PSONAM,1)_SSN
"RTN","PSOCPBK4",255,0)
 S PSODIV=$P($G(^PSRX(RXP,2)),"^",9)
"RTN","PSOCPBK4",256,0)
 S:PSODIV'="" PSODIV=$P($G(^PS(59,PSODIV,0)),"^",1)
"RTN","PSOCPBK4",257,0)
 W ?16,"("_PSOPATID_")"_"  "_PSODIV
"RTN","PSOCPBK4",258,0)
 Q
"RTN","PSOCPBK4",259,0)
 ;
"RTN","PSOCPBK4",260,0)
ETIME(SECTIME) ;convert seconds to day:hr:min:sec
"RTN","PSOCPBK4",261,0)
 N DAY,HR,MIN,SEC,ETIM
"RTN","PSOCPBK4",262,0)
 S (DAY,HR,MIN,SEC)=""
"RTN","PSOCPBK4",263,0)
 I SECTIME>86400 S DAY=SECTIME\86400,SECTIME=SECTIME#86400
"RTN","PSOCPBK4",264,0)
 I SECTIME>3600 S HR=SECTIME\3600,SECTIME=SECTIME#3600
"RTN","PSOCPBK4",265,0)
 I SECTIME>60 S MIN=SECTIME\60,SECTIME=SECTIME#60
"RTN","PSOCPBK4",266,0)
 S SEC=SECTIME
"RTN","PSOCPBK4",267,0)
 S ETIM=""
"RTN","PSOCPBK4",268,0)
 S:$L(HR)=1 HR=0_HR S:$L(MIN)=1 MIN=0_MIN S:$L(SEC)=1 SEC=0_SEC
"RTN","PSOCPBK4",269,0)
 S:DAY ETIM=DAY_" Day " S:HR ETIM=ETIM_HR_":" S:MIN ETIM=ETIM_MIN
"RTN","PSOCPBK4",270,0)
 S ETIM=ETIM_":"_SEC
"RTN","PSOCPBK4",271,0)
 Q ETIM
"RTN","PSOCPIBC")
0^12^B49888146^B49680609
"RTN","PSOCPIBC",1,0)
PSOCPIBC ;BHAM ISC/EJW - PHARMACY CO-PAY APPLICATION UTILITIES FOR IB ;01/15/02
"RTN","PSOCPIBC",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**93,303,460,480**;DEC 1997;Build 35
"RTN","PSOCPIBC",3,0)
 ;External references to IBARX is supported by DBIA 125
"RTN","PSOCPIBC",4,0)
 ;External reference to PSDRUG( is supported by DBIA 221
"RTN","PSOCPIBC",5,0)
 ;External reference to $$CPTIER^PSNAPIS(P1,P3) supported by DBIA #2531
"RTN","PSOCPIBC",6,0)
 ;This routine is called by PSOCPIBF to attempt to bill for released CMOP copays.
"RTN","PSOCPIBC",7,0)
 ;For Rx fills with a release date prior to 01/01/02 this routine is called instead of CP^PSOCP.  This routine does not check the additional
"RTN","PSOCPIBC",8,0)
 ;exemption questions and does not send a MailMan message if an exemption question has not been answered.
"RTN","PSOCPIBC",9,0)
CP ; Entry point to Check if COPAY  -   Requires RXP,PSOSITE7
"RTN","PSOCPIBC",10,0)
 I '$D(PSOPAR) D ^PSOLSET G CP
"RTN","PSOCPIBC",11,0)
 K PSOCP
"RTN","PSOCPIBC",12,0)
 ; Q:'$D(^PSRX(RXP,"IB"))  Q:"12"'[$E(+^PSRX(RXP,"IB"))
"RTN","PSOCPIBC",13,0)
 S PSOCPN=$P(^PSRX(RXP,0),"^",2) ; Set COPAY dfn PTR TO PATIENT
"RTN","PSOCPIBC",14,0)
 S PSOCP=$P($G(^PSRX(RXP,"IB")),"^") ; IB action type
"RTN","PSOCPIBC",15,0)
 S PSOSAVE=$S(PSOCP:1,1:"") ; save current copay status
"RTN","PSOCPIBC",16,0)
 ;         Set x=service^dfn^actiontype^user duz
"RTN","PSOCPIBC",17,0)
 I +$G(PSOSITE7)'>0 S PSOSITE7=$P(^PS(59,PSOSITE,"IB"),"^")
"RTN","PSOCPIBC",18,0)
 S X=PSOSITE7_"^"_PSOCPN_"^"_PSOCP_"^"_$P(^PSRX(RXP,0),"^",16)
"RTN","PSOCPIBC",19,0)
 ;
"RTN","PSOCPIBC",20,0)
RX ;         Determine Original or Refill for RX
"RTN","PSOCPIBC",21,0)
 S PSOREF=0
"RTN","PSOCPIBC",22,0)
 I $G(^PSRX(RXP,1,+$G(YY),0))]"" S PSOREF=YY
"RTN","PSOCPIBC",23,0)
 ;         Check if bill # already exists for this RX or Refill
"RTN","PSOCPIBC",24,0)
 I 'PSOREF,+$P($G(^PSRX(RXP,"IB")),"^",2)>0 G QUIT
"RTN","PSOCPIBC",25,0)
 I PSOREF,+$G(^PSRX(RXP,1,PSOREF,"IB")) G QUIT
"RTN","PSOCPIBC",26,0)
 S PSOCHG=1 ; set temporary variable to copay and then look for exceptions
"RTN","PSOCPIBC",27,0)
 N MAILMSG
"RTN","PSOCPIBC",28,0)
 D COPAYREL
"RTN","PSOCPIBC",29,0)
 I 'PSOCHG D  G QUIT
"RTN","PSOCPIBC",30,0)
 . I PSOSAVE S PSODA=RXP,PREA="R" D ACTLOG^PSOCPA S $P(^PSRX(RXP,"IB"),"^",1)=""
"RTN","PSOCPIBC",31,0)
 I PSOCHG=2 D  I 'PSOCP G QUIT ; IF 'SC' QUESTION APPLIES, BUT HAS NOT BEEN ANSWERED, SEND MAIL MSG AND KEEP COPAY STATUS AS IT WAS
"RTN","PSOCPIBC",32,0)
 . ; D MAIL2^PSOCPE ; SEND MAIL TO PHARMACIST, PROVIDER, AND HOLDERS OF THE PSO COPAY KEY
"RTN","PSOCPIBC",33,0)
 I PSOCHG=1,PSOSAVE="" D  I PSOREF S PSOCOMM="",PSOOLD="No Copay",PSONW="Copay" S PSODA=RXP,PREA="R" D ACTLOG^PSOCPA
"RTN","PSOCPIBC",34,0)
 . I '$D(^PSRX(RXP,"IB")),'PSOREF S $P(^PSRX(RXP,"IB"),"^",1)=1 Q
"RTN","PSOCPIBC",35,0)
 . S $P(^PSRX(RXP,"IB"),"^",1)=1
"RTN","PSOCPIBC",36,0)
 . S PSOCP=1,$P(X,"^",3)=PSOCP
"RTN","PSOCPIBC",37,0)
 I PSOCHG'=2 I $G(MAILMSG) ; D MAIL2^PSOCPE ; SEND MAIL TO PHARMACIST, PROVIDER, AND HOLDERS OF PSO COPAY KEY
"RTN","PSOCPIBC",38,0)
 ;         Units for COPAY
"RTN","PSOCPIBC",39,0)
 S PSOCPUN=$P(($P(^PSRX(RXP,0),"^",8)+29)/30,".",1)
"RTN","PSOCPIBC",40,0)
 ;         Build softlink for x(n)=softlink^units
"RTN","PSOCPIBC",41,0)
 S X(1)="52:"_RXP S:PSOREF>0 X(1)=X(1)_";1:"_PSOREF S X(1)=X(1)_"^"_PSOCPUN
"RTN","PSOCPIBC",42,0)
 ;         Set correct user duz if refill
"RTN","PSOCPIBC",43,0)
 I PSOREF S:+$P(^PSRX(RXP,1,PSOREF,0),"^",7)>0 $P(X,"^",4)=$P(^PSRX(RXP,1,PSOREF,0),"^",7)
"RTN","PSOCPIBC",44,0)
 ;
"RTN","PSOCPIBC",45,0)
IBNEW ;          Load ^TMP global for IB call
"RTN","PSOCPIBC",46,0)
 Q:$G(RXP)'>0
"RTN","PSOCPIBC",47,0)
 N D0
"RTN","PSOCPIBC",48,0)
 G QUIT:'$D(X)
"RTN","PSOCPIBC",49,0)
 S XTMP=X,XTMP(1)=X(1)
"RTN","PSOCPIBC",50,0)
 ;
"RTN","PSOCPIBC",51,0)
 ;         Requires x=service^dfn^action type^user duz
"RTN","PSOCPIBC",52,0)
 ;               x(n)=softlink^units 
"RTN","PSOCPIBC",53,0)
 I $P(X,"^",3)="" S $P(X,"^",3)=$P(^PSRX(RXP,"IB"),"^",1)
"RTN","PSOCPIBC",54,0)
 D NEW^IBARX
"RTN","PSOCPIBC",55,0)
 ;         Returns y=1^total charges for this group or Y=-1^error code
"RTN","PSOCPIBC",56,0)
 ;              y(n)=IB number^charge for this Rx^AR bill #^Cap met^Partial or Full charge^Copay Exempt^Number from file 354.71
"RTN","PSOCPIBC",57,0)
 ;                   Cap met ('1' - If patient has met cap amount or 
"RTN","PSOCPIBC",58,0)
 ;                     reached cap with this charge or '0' if not)
"RTN","PSOCPIBC",59,0)
 ;                   Partial or Full ('P' for partial billing, 'F' for
"RTN","PSOCPIBC",60,0)
 ;                     full billing, null for no billing)
"RTN","PSOCPIBC",61,0)
 ;                   Copay Exempt - ('1' for exempt, '0' for non-exempt,
"RTN","PSOCPIBC",62,0)
 ;                     '-1' for copay off (manila))
"RTN","PSOCPIBC",63,0)
 ;                   ('1' - If patient has met cap amount or reach cap with this charge
"RTN","PSOCPIBC",64,0)
 ;                  Entry from file 354.71 will only be saved for fills that met the annual cap and could not be fully billed
"RTN","PSOCPIBC",65,0)
 ;
"RTN","PSOCPIBC",66,0)
 G QUIT:+Y=-1
"RTN","PSOCPIBC",67,0)
 S XTMP=XTMP_"^"_Y,XTMP(1)=XTMP(1)_"^"_Y(1)
"RTN","PSOCPIBC",68,0)
 ;
"RTN","PSOCPIBC",69,0)
 ; see if exempt or copay cap was met for this fill
"RTN","PSOCPIBC",70,0)
 I $P(Y(1),"^",6) D  G QUIT
"RTN","PSOCPIBC",71,0)
 . S PREA="R",PSOOLD="Copay",PSONW="No Copay"
"RTN","PSOCPIBC",72,0)
 . S PSOCOMM="RX COPAY INCOME EXEMPTION" S PSODA=RXP D ACTLOG^PSOCPA
"RTN","PSOCPIBC",73,0)
 . S $P(^PSRX(RXP,"IB"),"^",1)=""
"RTN","PSOCPIBC",74,0)
 I $P(Y(1),"^",4) D
"RTN","PSOCPIBC",75,0)
 . S PSOCOMM=$S($P(Y(1),"^",5)="F":" FULL BILLING FOR THIS FILL",$P(Y(1),"^",5)="P":" PARTIAL BILLING FOR THIS FILL ",1:" NO BILLING FOR THIS FILL")
"RTN","PSOCPIBC",76,0)
 . S PREA="A"
"RTN","PSOCPIBC",77,0)
 . S PSODA=RXP D ACTLOG^PSOCPA
"RTN","PSOCPIBC",78,0)
 . I $P(Y(1),"^",5)'="F" D
"RTN","PSOCPIBC",79,0)
 . . I PSOREF S $P(^PSRX(RXP,1,PSOREF,"IB"),"^",2)=$P(Y(1),"^",7) Q
"RTN","PSOCPIBC",80,0)
 . . S $P(^PSRX(RXP,"IB"),"^",4)=$P(Y(1),"^",7)
"RTN","PSOCPIBC",81,0)
 I $P(Y(1),"^",1)="" G QUIT
"RTN","PSOCPIBC",82,0)
 ;
"RTN","PSOCPIBC",83,0)
FILE ;         File IB number in ^PSRX
"RTN","PSOCPIBC",84,0)
 S PSOCP2=0
"RTN","PSOCPIBC",85,0)
 S PSOCP2=+$P(XTMP(1),":",3)
"RTN","PSOCPIBC",86,0)
 S:PSOCP2>0 ^PSRX(RXP,1,PSOCP2,"IB")=$P(XTMP(1),U,3) ;  Filing in refill node
"RTN","PSOCPIBC",87,0)
 I PSOCP2>0,'$D(^PSRX(RXP,"IB")) S ^PSRX(RXP,"IB")="1^^" ;  If refill "IB" exists, need "IB" entry on original fill node
"RTN","PSOCPIBC",88,0)
 S:PSOCP2=0 $P(^PSRX(RXP,"IB"),"^",2)=$P(XTMP(1),U,3) ;Filing in original fill (zero node)
"RTN","PSOCPIBC",89,0)
QUIT ;
"RTN","PSOCPIBC",90,0)
 K Y,PSOCP1,PSOCP2,QQ,PSOCPN,X,X2,XTMP,PSOCPUN,PSOREF,PSOCHG,PSOSAVE,PSOCOMM,PSOOLD,PSONW,PREA,PSORSN
"RTN","PSOCPIBC",91,0)
 Q
"RTN","PSOCPIBC",92,0)
EN D ^PSOLSET
"RTN","PSOCPIBC",93,0)
EN1 S DIR(0)="NO",DIR("A")="Enter PRESCRIPTION number" D ^DIR K DIR G:$D(DIRUT) EXIT S RXP=X I +$G(^PSRX(RXP,0))'>0!+$P($G(^PSRX(RXP,"IB")),"^",0)>0 W !,?10,"RE-CHECK PRESCRIPTION NUMBER AND RE-ENTER " G EN1
"RTN","PSOCPIBC",94,0)
 S PSOSITE7=$P(^PS(59,PSOSITE,"IB"),"^")
"RTN","PSOCPIBC",95,0)
 S PSODFN=$P(^PSRX(RXP,0),"^",2)
"RTN","PSOCPIBC",96,0)
 D CP G EN1
"RTN","PSOCPIBC",97,0)
EXIT K RXP D FINAL^PSOLSET Q
"RTN","PSOCPIBC",98,0)
 ;
"RTN","PSOCPIBC",99,0)
COPAYREL ; Recheck copay status at release
"RTN","PSOCPIBC",100,0)
 ;
"RTN","PSOCPIBC",101,0)
 ; check Rx patient status
"RTN","PSOCPIBC",102,0)
 I $P(^PSRX(RXP,0),"^",3)'="",$P($G(^PS(53,$P(^PSRX(RXP,0),"^",3),0)),"^",7)=1 S PSOCHG=0,PSOCOMM="Rx Patient Status Change",PSOOLD="Copay",PSONW="No Copay" Q
"RTN","PSOCPIBC",103,0)
 ; see if drug is nutritional supplement, investigational, or supply
"RTN","PSOCPIBC",104,0)
 N DRG,DRGTYP,PSOEXMPT
"RTN","PSOCPIBC",105,0)
 S DRG=+$P(^PSRX(RXP,0),"^",6),DRGTYP=$P($G(^PSDRUG(DRG,0)),"^",3)
"RTN","PSOCPIBC",106,0)
 I DRGTYP["I" S PSOCOMM="Investigational Drug",PSOCHG=0,PSOOLD="Copay",PSONW="No Copay",(PSOEXMPT,PSOCHG)=0 Q
"RTN","PSOCPIBC",107,0)
 I DRGTYP["S" S PSOCOMM="Supply Item",PSOCHG=0,PSOOLD="Copay",PSONW="No Copay",(PSOEXMPT,PSOCHG)=0 Q
"RTN","PSOCPIBC",108,0)
 I DRGTYP["N" S PSOCOMM="Nutritional Supplement",PSOCHG=0,PSOOLD="Copay",PSONW="No Copay",(PSOEXMPT,PSOCHG)=0 Q
"RTN","PSOCPIBC",109,0)
 K PSOTG
"RTN","PSOCPIBC",110,0)
 N EXMT
"RTN","PSOCPIBC",111,0)
 D XTYPE
"RTN","PSOCPIBC",112,0)
 F EXMT="SC" I $D(PSOTG(EXMT)) D  I 'PSOCHG Q
"RTN","PSOCPIBC",113,0)
 . I PSOTG(EXMT)=1 S PSOCHG=0 S PSOCOMM="Service Connected"
"RTN","PSOCPIBC",114,0)
 ;
"RTN","PSOCPIBC",115,0)
 ;***** begin - for regression test - sites must not use this as it will adversely affect billing results - only used by SQA
"RTN","PSOCPIBC",116,0)
 ; The following is required for testing different effective dates.  If date is less than 02/27/17 bills old way.  Otherwise bills new way.
"RTN","PSOCPIBC",117,0)
 ;S ^XTMP("PSOTIEREFTST",0)="3201231^3170227^FOR SQA TESTING ONLY" - Defined for SQA testing only.   Delete this XTMP when regression complete
"RTN","PSOCPIBC",118,0)
 D NOW^%DTC N PSOTIERE
"RTN","PSOCPIBC",119,0)
 S PSOTIERE=1  ;use copay tiers - new
"RTN","PSOCPIBC",120,0)
 I $P(%,".")<3170227 S PSOTIERE=0  ;legacy billing - old
"RTN","PSOCPIBC",121,0)
 I $G(^XTMP("PSOTIEREFTST",0)) S PSOTIERE=1  ;for SQA testing only - bill with copay tiers - new
"RTN","PSOCPIBC",122,0)
 ;***** end for regression test
"RTN","PSOCPIBC",123,0)
 G COPAYRE1:'PSOTIERE
"RTN","PSOCPIBC",124,0)
 ; check copay tier. Tier zero does not have copay charges
"RTN","PSOCPIBC",125,0)
 N CPDATE,X,PSOCPT D NOW^%DTC S CPDATE=X S PSOCPT=$$CPTIER^PSNAPIS("",CPDATE,DRG) K CPDATE,X
"RTN","PSOCPIBC",126,0)
 I $P(PSOCPT,"^")=0 S PSOCOMM="Copay Tier 0",PSODA=RXP,PREA="R",PSOCHG=0,PSOOLD="Copay",PSONW="No Copay" D ACTLOG^PSOCPA Q  ;Tier zero do not send to IB for copay charge
"RTN","PSOCPIBC",127,0)
 I '$G(PSOEXMPT),$P(PSOCPT,"^")=""!(PSOCPT>0) S PSOCOMM="Copay Tier "_+PSOCPT,PSOOLD="No Copay",PSONW="Copay",PSOCHG=3 S PSODA=RXP,PREA="R" D ACTLOG^PSOCPA  ;For null values, IB defaults to tier 2. PSOCHG=3 means activity log already set.
"RTN","PSOCPIBC",128,0)
COPAYRE1 ;
"RTN","PSOCPIBC",129,0)
 Q:PSOCHG
"RTN","PSOCPIBC",130,0)
 I 'PSOCHG S PSOOLD="Copay",PSONW="No Copay" Q
"RTN","PSOCPIBC",131,0)
 ; If any of the applicable exemption questions have never been answered, generate a mail message with all of the questions
"RTN","PSOCPIBC",132,0)
 S EXMT="",MAILMSG=0 F  S EXMT=$O(PSOTG(EXMT)) Q:EXMT=""  I PSOTG(EXMT)="" S MAILMSG=1 Q
"RTN","PSOCPIBC",133,0)
 I MAILMSG,$D(PSOTG("SC")) I $G(PSOTG("SC"))="" S PSOCHG=2 ; 'SC' question not answered, don't reset copay status to 'copay'
"RTN","PSOCPIBC",134,0)
 Q
"RTN","PSOCPIBC",135,0)
 ;
"RTN","PSOCPIBC",136,0)
XTYPE ;
"RTN","PSOCPIBC",137,0)
 N PSOCIBQ,PSOSCMX,Y,I,J,X,SAVY
"RTN","PSOCPIBC",138,0)
 S (X,PSOSCMX,SAVY)=""
"RTN","PSOCPIBC",139,0)
 S PSOCIBQ=$G(^PSRX(RXP,"IBQ"))
"RTN","PSOCPIBC",140,0)
 I $P(PSOCIBQ,"^",1)'="" S PSOTG("SC")=$P(PSOCIBQ,"^",1)
"RTN","PSOCPIBC",141,0)
 I $D(PSOTG("SC")),$P(PSOCIBQ,"^",1)="" S PSOTG("SC")="" ; USE "CURRENT" SETTING AS ANSWER TO SERVICE CONNECTED QUESTION IF IT APPLIES
"RTN","PSOCPIBC",142,0)
 S J=0 F  S J=$O(^PS(59,J)) Q:'J  I +$G(^(J,"IB")) S X=+^("IB") Q
"RTN","PSOCPIBC",143,0)
 I 'X Q
"RTN","PSOCPIBC",144,0)
 S X=X_"^"_PSOCPN D XTYPE^IBARX
"RTN","PSOCPIBC",145,0)
 I $G(Y)'=1 Q
"RTN","PSOCPIBC",146,0)
 S J="" F  S J=$O(Y(J)) Q:'J  S I="" F  S SAVY=I,I=$O(Y(J,I)) Q:I=""  S:I>0 PSOSCMX=I
"RTN","PSOCPIBC",147,0)
 I PSOSCMX="",SAVY=0 S PSOCHG=0,PSOEXMPT=1 S PSOCOMM="Exempt from copayment" Q  ; INCOME EXEMPT OR SERVICE-CONNECTED
"RTN","PSOCPIBC",148,0)
 I PSOSCMX=2,'$D(PSOTG("SC")) S PSOTG("SC")=$S(($G(RXP)&($P($G(^PSRX(+$G(RXP),"IB")),"^")))!($P(PSOCIBQ,"^")=0):0,$P(PSOCIBQ,"^")=1:1,1:"") Q
"RTN","PSOCPIBC",149,0)
 Q
"RTN","PSOCPIBC",150,0)
 ;
"VER")
8.0^22.0
"BLD",9645,6)
^393
**END**
**END**

