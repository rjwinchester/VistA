Released PSO*7*508 SEQ #444
Extracted from mail message
**KIDS**:PSO*7.0*508^

**INSTALL NAME**
PSO*7.0*508
"BLD",9591,0)
PSO*7.0*508^OUTPATIENT PHARMACY^0^3181018^y
"BLD",9591,1,0)
^^1^1^3180109^
"BLD",9591,1,1,0)
Inbound eRx Version 3 updates.
"BLD",9591,4,0)
^9.64PA^52^4
"BLD",9591,4,52,0)
52
"BLD",9591,4,52,2,0)
^9.641^52.3^1
"BLD",9591,4,52,2,52.3,0)
ACTIVITY LOG  (sub-file)
"BLD",9591,4,52,2,52.3,1,0)
^9.6411^.02^1
"BLD",9591,4,52,2,52.3,1,.02,0)
REASON
"BLD",9591,4,52,222)
y^y^p^^^^n^^n
"BLD",9591,4,52,224)

"BLD",9591,4,52.45,0)
52.45
"BLD",9591,4,52.45,2,0)
^9.641^52.45^1
"BLD",9591,4,52.45,2,52.45,0)
ERX SERVICE REASON CODES  (File-top level)
"BLD",9591,4,52.45,2,52.45,1,0)
^9.6411^.03^2
"BLD",9591,4,52.45,2,52.45,1,.02,0)
BRIEF DESCRIPTION
"BLD",9591,4,52.45,2,52.45,1,.03,0)
CODE TYPE
"BLD",9591,4,52.45,222)
y^y^p^^^^n^^n
"BLD",9591,4,52.45,224)

"BLD",9591,4,52.46,0)
52.46
"BLD",9591,4,52.46,2,0)
^9.641^52.46^1
"BLD",9591,4,52.46,2,52.46,0)
ERX EXTERNAL PATIENT  (File-top level)
"BLD",9591,4,52.46,2,52.46,1,0)
^9.6411^6^1
"BLD",9591,4,52.46,2,52.46,1,6,0)
LAST LOCKED BY
"BLD",9591,4,52.46,222)
y^y^p^^^^n^^n
"BLD",9591,4,52.46,224)

"BLD",9591,4,52.49,0)
52.49
"BLD",9591,4,52.49,2,0)
^9.641^52.49101^6
"BLD",9591,4,52.49,2,52.49,0)
ERX HOLDING QUEUE  (File-top level)
"BLD",9591,4,52.49,2,52.49,1,0)
^9.6411^2.1^22
"BLD",9591,4,52.49,2,52.49,1,.02,0)
RELATED OR PARENT MESSAGE ID
"BLD",9591,4,52.49,2,52.49,1,.04,0)
EXTERNAL PATIENT IDENTIFIER
"BLD",9591,4,52.49,2,52.49,1,.08,0)
MESSAGE TYPE
"BLD",9591,4,52.49,2,52.49,1,.14,0)
RELATES TO HUB ID
"BLD",9591,4,52.49,2,52.49,1,2.1,0)
EXTERNAL PROVIDER
"BLD",9591,4,52.49,2,52.49,1,5.7,0)
REFILL QUALIFIER
"BLD",9591,4,52.49,2,52.49,1,25,0)
CH MESSAGE ID
"BLD",9591,4,52.49,2,52.49,1,50,0)
REFILL REQUEST/RESPONSE NOTES
"BLD",9591,4,52.49,2,52.49,1,50.1,0)
NOTE ADDED BY
"BLD",9591,4,52.49,2,52.49,1,50.2,0)
NOTE DATE/TIME
"BLD",9591,4,52.49,2,52.49,1,51.1,0)
REFILL/CANCEL REQEUST PERSON
"BLD",9591,4,52.49,2,52.49,1,51.2,0)
# OF REFILLS REQUESTED
"BLD",9591,4,52.49,2,52.49,1,52.1,0)
RESPONSE VALUE
"BLD",9591,4,52.49,2,52.49,1,52.2,0)
RESPONSE NOTE
"BLD",9591,4,52.49,2,52.49,1,52.3,0)
RESPONSE REFERENCE NUMBER
"BLD",9591,4,52.49,2,52.49,1,60,0)
REQUEST/RESPONSE ERROR TEXT
"BLD",9591,4,52.49,2,52.49,1,60.1,0)
REQUEST/RESPONSE ERROR CODE
"BLD",9591,4,52.49,2,52.49,1,80.1,0)
CHANGE REQUEST TYPE
"BLD",9591,4,52.49,2,52.49,1,80.2,0)
RETURN RECEIPT
"BLD",9591,4,52.49,2,52.49,1,80.3,0)
REQUEST REFERENCE NUMBER
"BLD",9591,4,52.49,2,52.49,1,80.4,0)
CHANGE RX STATUS FLAG
"BLD",9591,4,52.49,2,52.49,1,80.5,0)
CHANGE/CANCEL DENIED BY HUB
"BLD",9591,4,52.49,2,52.49101,0)
PROCESSING ERRORS  (sub-file)
"BLD",9591,4,52.49,2,52.49101,1,0)
^9.6411^^
"BLD",9591,4,52.49,2,52.49201,0)
MESSAGE HISTORY  (sub-file)
"BLD",9591,4,52.49,2,52.49201,1,0)
^9.6411^^0
"BLD",9591,4,52.49,2,52.4949,0)
MEDICATION DISPENSED/REQUESTED  (sub-file)
"BLD",9591,4,52.49,2,52.4949,1,0)
^9.6411^^
"BLD",9591,4,52.49,2,52.4955,0)
RESPONSE CODES  (sub-file)
"BLD",9591,4,52.49,2,52.4955,1,0)
^9.6411^^
"BLD",9591,4,52.49,2,52.4961,0)
REQUEST/RESPONSE ERR DCODES  (sub-file)
"BLD",9591,4,52.49,2,52.4961,1,0)
^9.6411^^
"BLD",9591,4,52.49,222)
y^y^p^^^^n^^n
"BLD",9591,4,52.49,224)

"BLD",9591,4,"APDD",52,52.3)

"BLD",9591,4,"APDD",52,52.3,.02)

"BLD",9591,4,"APDD",52.45,52.45)

"BLD",9591,4,"APDD",52.45,52.45,.02)

"BLD",9591,4,"APDD",52.45,52.45,.03)

"BLD",9591,4,"APDD",52.46,52.46)

"BLD",9591,4,"APDD",52.46,52.46,6)

"BLD",9591,4,"APDD",52.49,52.49)

"BLD",9591,4,"APDD",52.49,52.49,.02)

"BLD",9591,4,"APDD",52.49,52.49,.04)

"BLD",9591,4,"APDD",52.49,52.49,.08)

"BLD",9591,4,"APDD",52.49,52.49,.14)

"BLD",9591,4,"APDD",52.49,52.49,2.1)

"BLD",9591,4,"APDD",52.49,52.49,5.7)

"BLD",9591,4,"APDD",52.49,52.49,25)

"BLD",9591,4,"APDD",52.49,52.49,50)

"BLD",9591,4,"APDD",52.49,52.49,50.1)

"BLD",9591,4,"APDD",52.49,52.49,50.2)

"BLD",9591,4,"APDD",52.49,52.49,51.1)

"BLD",9591,4,"APDD",52.49,52.49,51.2)

"BLD",9591,4,"APDD",52.49,52.49,52.1)

"BLD",9591,4,"APDD",52.49,52.49,52.2)

"BLD",9591,4,"APDD",52.49,52.49,52.3)

"BLD",9591,4,"APDD",52.49,52.49,60)

"BLD",9591,4,"APDD",52.49,52.49,60.1)

"BLD",9591,4,"APDD",52.49,52.49,80.1)

"BLD",9591,4,"APDD",52.49,52.49,80.2)

"BLD",9591,4,"APDD",52.49,52.49,80.3)

"BLD",9591,4,"APDD",52.49,52.49,80.4)

"BLD",9591,4,"APDD",52.49,52.49,80.5)

"BLD",9591,4,"APDD",52.49,52.49101)

"BLD",9591,4,"APDD",52.49,52.49201)

"BLD",9591,4,"APDD",52.49,52.4949)

"BLD",9591,4,"APDD",52.49,52.4955)

"BLD",9591,4,"APDD",52.49,52.4961)

"BLD",9591,4,"B",52,52)

"BLD",9591,4,"B",52.45,52.45)

"BLD",9591,4,"B",52.46,52.46)

"BLD",9591,4,"B",52.49,52.49)

"BLD",9591,6.3)
295
"BLD",9591,"ABPKG")
n
"BLD",9591,"INI")

"BLD",9591,"INID")
^n^
"BLD",9591,"INIT")
PSO508PO
"BLD",9591,"KRN",0)
^9.67PA^779.2^20
"BLD",9591,"KRN",.4,0)
.4
"BLD",9591,"KRN",.4,"NM",0)
^9.68A^^
"BLD",9591,"KRN",.401,0)
.401
"BLD",9591,"KRN",.402,0)
.402
"BLD",9591,"KRN",.403,0)
.403
"BLD",9591,"KRN",.5,0)
.5
"BLD",9591,"KRN",.84,0)
.84
"BLD",9591,"KRN",3.6,0)
3.6
"BLD",9591,"KRN",3.8,0)
3.8
"BLD",9591,"KRN",9.2,0)
9.2
"BLD",9591,"KRN",9.2,"NM",0)
^9.68A^^
"BLD",9591,"KRN",9.8,0)
9.8
"BLD",9591,"KRN",9.8,"NM",0)
^9.68A^39^38
"BLD",9591,"KRN",9.8,"NM",1,0)
PSOERX^^0^B122296708
"BLD",9591,"KRN",9.8,"NM",2,0)
PSOERXA1^^0^B188146400
"BLD",9591,"KRN",9.8,"NM",3,0)
PSOERXA2^^0^B111979280
"BLD",9591,"KRN",9.8,"NM",4,0)
PSOERXA3^^0^B38164072
"BLD",9591,"KRN",9.8,"NM",5,0)
PSOORNEW^^0^B119220767
"BLD",9591,"KRN",9.8,"NM",6,0)
PSOORUT1^^0^B131536196
"BLD",9591,"KRN",9.8,"NM",7,0)
PSOERXX1^^0^B155540262
"BLD",9591,"KRN",9.8,"NM",8,0)
PSOERXX2^^0^B185958519
"BLD",9591,"KRN",9.8,"NM",9,0)
PSOERXX3^^0^B84060041
"BLD",9591,"KRN",9.8,"NM",10,0)
PSOERXX4^^0^B109158139
"BLD",9591,"KRN",9.8,"NM",11,0)
PSOERXU1^^0^B144420314
"BLD",9591,"KRN",9.8,"NM",12,0)
PSORENW^^0^B49878168
"BLD",9591,"KRN",9.8,"NM",13,0)
PSORENW4^^0^B68530272
"BLD",9591,"KRN",9.8,"NM",15,0)
PSOERXX5^^0^B161348685
"BLD",9591,"KRN",9.8,"NM",16,0)
PSOERXU2^^0^B50733365
"BLD",9591,"KRN",9.8,"NM",17,0)
PSOERXO1^^0^B115835250
"BLD",9591,"KRN",9.8,"NM",18,0)
PSOERX1^^0^B96375321
"BLD",9591,"KRN",9.8,"NM",19,0)
PSOERX1A^^0^B140048297
"BLD",9591,"KRN",9.8,"NM",20,0)
PSOERXA5^^0^B65388361
"BLD",9591,"KRN",9.8,"NM",21,0)
PSOERXU3^^0^B170900975
"BLD",9591,"KRN",9.8,"NM",22,0)
PSOCAN^^0^B55445842
"BLD",9591,"KRN",9.8,"NM",23,0)
PSOCAN1^^0^B63054494
"BLD",9591,"KRN",9.8,"NM",24,0)
PSOCAN3^^0^B73058805
"BLD",9591,"KRN",9.8,"NM",25,0)
PSOCMOPA^^0^B16718315
"BLD",9591,"KRN",9.8,"NM",26,0)
PSOERX1B^^0^B200556396
"BLD",9591,"KRN",9.8,"NM",27,0)
PSOERXZ1^^0^B224204114
"BLD",9591,"KRN",9.8,"NM",28,0)
PSOORNE6^^0^B56294478
"BLD",9591,"KRN",9.8,"NM",29,0)
PSOERXU5^^0^B64488961
"BLD",9591,"KRN",9.8,"NM",30,0)
PSOERXU6^^0^B111664391
"BLD",9591,"KRN",9.8,"NM",31,0)
PSOERXEN^^0^B15625365
"BLD",9591,"KRN",9.8,"NM",32,0)
PSOERXC1^^0^B92546733
"BLD",9591,"KRN",9.8,"NM",33,0)
PSOERXH1^^0^B17222601
"BLD",9591,"KRN",9.8,"NM",34,0)
PSOORFIN^^0^B72090334
"BLD",9591,"KRN",9.8,"NM",35,0)
PSOERX1C^^0^B61030450
"BLD",9591,"KRN",9.8,"NM",36,0)
PSOORAL1^^0^B141679409
"BLD",9591,"KRN",9.8,"NM",37,0)
PSOERXU4^^0^B33741259
"BLD",9591,"KRN",9.8,"NM",38,0)
PSOCAN4^^0^B51143319
"BLD",9591,"KRN",9.8,"NM",39,0)
PSOERXD2^^0^B182647633
"BLD",9591,"KRN",9.8,"NM","B","PSOCAN",22)

"BLD",9591,"KRN",9.8,"NM","B","PSOCAN1",23)

"BLD",9591,"KRN",9.8,"NM","B","PSOCAN3",24)

"BLD",9591,"KRN",9.8,"NM","B","PSOCAN4",38)

"BLD",9591,"KRN",9.8,"NM","B","PSOCMOPA",25)

"BLD",9591,"KRN",9.8,"NM","B","PSOERX",1)

"BLD",9591,"KRN",9.8,"NM","B","PSOERX1",18)

"BLD",9591,"KRN",9.8,"NM","B","PSOERX1A",19)

"BLD",9591,"KRN",9.8,"NM","B","PSOERX1B",26)

"BLD",9591,"KRN",9.8,"NM","B","PSOERX1C",35)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXA1",2)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXA2",3)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXA3",4)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXA5",20)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXC1",32)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXD2",39)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXEN",31)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXH1",33)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXO1",17)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXU1",11)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXU2",16)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXU3",21)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXU4",37)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXU5",29)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXU6",30)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXX1",7)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXX2",8)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXX3",9)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXX4",10)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXX5",15)

"BLD",9591,"KRN",9.8,"NM","B","PSOERXZ1",27)

"BLD",9591,"KRN",9.8,"NM","B","PSOORAL1",36)

"BLD",9591,"KRN",9.8,"NM","B","PSOORFIN",34)

"BLD",9591,"KRN",9.8,"NM","B","PSOORNE6",28)

"BLD",9591,"KRN",9.8,"NM","B","PSOORNEW",5)

"BLD",9591,"KRN",9.8,"NM","B","PSOORUT1",6)

"BLD",9591,"KRN",9.8,"NM","B","PSORENW",12)

"BLD",9591,"KRN",9.8,"NM","B","PSORENW4",13)

"BLD",9591,"KRN",19,0)
19
"BLD",9591,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",9591,"KRN",19,"NM",1,0)
PSO ERX FINISH^^0
"BLD",9591,"KRN",19,"NM","B","PSO ERX FINISH",1)

"BLD",9591,"KRN",19.1,0)
19.1
"BLD",9591,"KRN",101,0)
101
"BLD",9591,"KRN",101,"NM",0)
^9.68A^45^43
"BLD",9591,"KRN",101,"NM",1,0)
PSO ERX HIDDEN ACTIONS^^0
"BLD",9591,"KRN",101,"NM",2,0)
PSO ERX RENEW REQUEST^^1^
"BLD",9591,"KRN",101,"NM",3,0)
PSO ERX REFILL REQUEST^^0
"BLD",9591,"KRN",101,"NM",4,0)
PSO LM HIDDEN OTHER^^3
"BLD",9591,"KRN",101,"NM",5,0)
PSO LM HIDDEN OTHER #2^^3
"BLD",9591,"KRN",101,"NM",6,0)
PSO ERX SINGLE REFILL REQUEST^^0
"BLD",9591,"KRN",101,"NM",7,0)
PSO ERX MESSAGE VIEW^^0
"BLD",9591,"KRN",101,"NM",8,0)
PSO ERX HQ MENU^^3
"BLD",9591,"KRN",101,"NM",9,0)
PSO ERX DISPLAY MENU^^3
"BLD",9591,"KRN",101,"NM",10,0)
PSO ERX ADD COMMENT^^0
"BLD",9591,"KRN",101,"NM",11,0)
VALM DOWN A LINE^^4^
"BLD",9591,"KRN",101,"NM",12,0)
VALM FIRST SCREEN^^4^
"BLD",9591,"KRN",101,"NM",13,0)
VALM GOTO PAGE^^4^
"BLD",9591,"KRN",101,"NM",14,0)
VALM LAST SCREEN^^4^
"BLD",9591,"KRN",101,"NM",15,0)
VALM LEFT^^4^
"BLD",9591,"KRN",101,"NM",16,0)
VALM NEXT SCREEN^^4^
"BLD",9591,"KRN",101,"NM",17,0)
VALM PREVIOUS SCREEN^^4^
"BLD",9591,"KRN",101,"NM",18,0)
VALM PRINT LIST^^4^
"BLD",9591,"KRN",101,"NM",19,0)
VALM PRINT SCREEN^^4^
"BLD",9591,"KRN",101,"NM",20,0)
VALM QUIT^^4^
"BLD",9591,"KRN",101,"NM",21,0)
VALM REFRESH^^4^
"BLD",9591,"KRN",101,"NM",22,0)
VALM RIGHT^^4^
"BLD",9591,"KRN",101,"NM",23,0)
VALM SEARCH LIST^^4^
"BLD",9591,"KRN",101,"NM",24,0)
VALM TURN ON/OFF MENUS^^4^
"BLD",9591,"KRN",101,"NM",25,0)
VALM UP ONE LINE^^4^
"BLD",9591,"KRN",101,"NM",28,0)
PSO ERX VALIDATE DRUG^^0
"BLD",9591,"KRN",101,"NM",29,0)
PSO ERX VALIDATE PROVIDER^^0
"BLD",9591,"KRN",101,"NM",30,0)
PSO ERX VALIDATE PATIENT^^0
"BLD",9591,"KRN",101,"NM",31,0)
PSO ERX ACCEPT ERX^^0
"BLD",9591,"KRN",101,"NM",32,0)
PSO ERX HOLD^^0
"BLD",9591,"KRN",101,"NM",33,0)
PSO ERX UNHOLD^^0
"BLD",9591,"KRN",101,"NM",34,0)
PSO ERX REJECT^^0
"BLD",9591,"KRN",101,"NM",35,0)
PSO ERX REMOVE^^0
"BLD",9591,"KRN",101,"NM",36,0)
PSO ERX ACKNOWLEDGE^^0
"BLD",9591,"KRN",101,"NM",37,0)
PSO ERX PRINT^^0
"BLD",9591,"KRN",101,"NM",38,0)
PSO ERX PCV MENU^^0
"BLD",9591,"KRN",101,"NM",39,0)
PSO ERX PCV SEARCH QUEUE^^0
"BLD",9591,"KRN",101,"NM",40,0)
PSO ERX PCV SELECT BY NUMBER^^0
"BLD",9591,"KRN",101,"NM",41,0)
PSO ERX PCV SELECT PATIENT^^0
"BLD",9591,"KRN",101,"NM",42,0)
PSO ERX PCV SORT ENTRIES^^0
"BLD",9591,"KRN",101,"NM",43,0)
PSO ERX JUMP TO OP^^0
"BLD",9591,"KRN",101,"NM",44,0)
PSO ERX PCV MESSAGE VIEW^^0
"BLD",9591,"KRN",101,"NM",45,0)
PSO ERX STATUS HISTORY^^0
"BLD",9591,"KRN",101,"NM","B","PSO ERX ACCEPT ERX",31)

"BLD",9591,"KRN",101,"NM","B","PSO ERX ACKNOWLEDGE",36)

"BLD",9591,"KRN",101,"NM","B","PSO ERX ADD COMMENT",10)

"BLD",9591,"KRN",101,"NM","B","PSO ERX DISPLAY MENU",9)

"BLD",9591,"KRN",101,"NM","B","PSO ERX HIDDEN ACTIONS",1)

"BLD",9591,"KRN",101,"NM","B","PSO ERX HOLD",32)

"BLD",9591,"KRN",101,"NM","B","PSO ERX HQ MENU",8)

"BLD",9591,"KRN",101,"NM","B","PSO ERX JUMP TO OP",43)

"BLD",9591,"KRN",101,"NM","B","PSO ERX MESSAGE VIEW",7)

"BLD",9591,"KRN",101,"NM","B","PSO ERX PCV MENU",38)

"BLD",9591,"KRN",101,"NM","B","PSO ERX PCV MESSAGE VIEW",44)

"BLD",9591,"KRN",101,"NM","B","PSO ERX PCV SEARCH QUEUE",39)

"BLD",9591,"KRN",101,"NM","B","PSO ERX PCV SELECT BY NUMBER",40)

"BLD",9591,"KRN",101,"NM","B","PSO ERX PCV SELECT PATIENT",41)

"BLD",9591,"KRN",101,"NM","B","PSO ERX PCV SORT ENTRIES",42)

"BLD",9591,"KRN",101,"NM","B","PSO ERX PRINT",37)

"BLD",9591,"KRN",101,"NM","B","PSO ERX REFILL REQUEST",3)

"BLD",9591,"KRN",101,"NM","B","PSO ERX REJECT",34)

"BLD",9591,"KRN",101,"NM","B","PSO ERX REMOVE",35)

"BLD",9591,"KRN",101,"NM","B","PSO ERX RENEW REQUEST",2)

"BLD",9591,"KRN",101,"NM","B","PSO ERX SINGLE REFILL REQUEST",6)

"BLD",9591,"KRN",101,"NM","B","PSO ERX STATUS HISTORY",45)

"BLD",9591,"KRN",101,"NM","B","PSO ERX UNHOLD",33)

"BLD",9591,"KRN",101,"NM","B","PSO ERX VALIDATE DRUG",28)

"BLD",9591,"KRN",101,"NM","B","PSO ERX VALIDATE PATIENT",30)

"BLD",9591,"KRN",101,"NM","B","PSO ERX VALIDATE PROVIDER",29)

"BLD",9591,"KRN",101,"NM","B","PSO LM HIDDEN OTHER",4)

"BLD",9591,"KRN",101,"NM","B","PSO LM HIDDEN OTHER #2",5)

"BLD",9591,"KRN",101,"NM","B","VALM DOWN A LINE",11)

"BLD",9591,"KRN",101,"NM","B","VALM FIRST SCREEN",12)

"BLD",9591,"KRN",101,"NM","B","VALM GOTO PAGE",13)

"BLD",9591,"KRN",101,"NM","B","VALM LAST SCREEN",14)

"BLD",9591,"KRN",101,"NM","B","VALM LEFT",15)

"BLD",9591,"KRN",101,"NM","B","VALM NEXT SCREEN",16)

"BLD",9591,"KRN",101,"NM","B","VALM PREVIOUS SCREEN",17)

"BLD",9591,"KRN",101,"NM","B","VALM PRINT LIST",18)

"BLD",9591,"KRN",101,"NM","B","VALM PRINT SCREEN",19)

"BLD",9591,"KRN",101,"NM","B","VALM QUIT",20)

"BLD",9591,"KRN",101,"NM","B","VALM REFRESH",21)

"BLD",9591,"KRN",101,"NM","B","VALM RIGHT",22)

"BLD",9591,"KRN",101,"NM","B","VALM SEARCH LIST",23)

"BLD",9591,"KRN",101,"NM","B","VALM TURN ON/OFF MENUS",24)

"BLD",9591,"KRN",101,"NM","B","VALM UP ONE LINE",25)

"BLD",9591,"KRN",409.61,0)
409.61
"BLD",9591,"KRN",409.61,"NM",0)
^9.68A^1^1
"BLD",9591,"KRN",409.61,"NM",1,0)
PSO ERX PATIENT CENTRIC VIEW^^0
"BLD",9591,"KRN",409.61,"NM","B","PSO ERX PATIENT CENTRIC VIEW",1)

"BLD",9591,"KRN",771,0)
771
"BLD",9591,"KRN",779.2,0)
779.2
"BLD",9591,"KRN",870,0)
870
"BLD",9591,"KRN",8989.51,0)
8989.51
"BLD",9591,"KRN",8989.52,0)
8989.52
"BLD",9591,"KRN",8994,0)
8994
"BLD",9591,"KRN",8994,"NM",0)
^9.68A^1^1
"BLD",9591,"KRN",8994,"NM",1,0)
PSOERXA1 INCERX^^0
"BLD",9591,"KRN",8994,"NM","B","PSOERXA1 INCERX",1)

"BLD",9591,"KRN","B",.4,.4)

"BLD",9591,"KRN","B",.401,.401)

"BLD",9591,"KRN","B",.402,.402)

"BLD",9591,"KRN","B",.403,.403)

"BLD",9591,"KRN","B",.5,.5)

"BLD",9591,"KRN","B",.84,.84)

"BLD",9591,"KRN","B",3.6,3.6)

"BLD",9591,"KRN","B",3.8,3.8)

"BLD",9591,"KRN","B",9.2,9.2)

"BLD",9591,"KRN","B",9.8,9.8)

"BLD",9591,"KRN","B",19,19)

"BLD",9591,"KRN","B",19.1,19.1)

"BLD",9591,"KRN","B",101,101)

"BLD",9591,"KRN","B",409.61,409.61)

"BLD",9591,"KRN","B",771,771)

"BLD",9591,"KRN","B",779.2,779.2)

"BLD",9591,"KRN","B",870,870)

"BLD",9591,"KRN","B",8989.51,8989.51)

"BLD",9591,"KRN","B",8989.52,8989.52)

"BLD",9591,"KRN","B",8994,8994)

"BLD",9591,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9591,"QUES",0)
^9.62^^
"BLD",9591,"REQB",0)
^9.611^16^16
"BLD",9591,"REQB",1,0)
PSO*7.0*467^2
"BLD",9591,"REQB",2,0)
PSO*7.0*416^2
"BLD",9591,"REQB",3,0)
PSO*7.0*442^2
"BLD",9591,"REQB",4,0)
PSO*7.0*372^2
"BLD",9591,"REQB",5,0)
PSO*7.0*443^2
"BLD",9591,"REQB",6,0)
PSO*7.0*446^2
"BLD",9591,"REQB",7,0)
PSO*7.0*454^2
"BLD",9591,"REQB",8,0)
PSO*7.0*444^2
"BLD",9591,"REQB",9,0)
PSO*7.0*411^2
"BLD",9591,"REQB",10,0)
PSO*7.0*505^2
"BLD",9591,"REQB",11,0)
PSO*7.0*520^2
"BLD",9591,"REQB",12,0)
PSO*7.0*527^2
"BLD",9591,"REQB",13,0)
PSO*7.0*408^2
"BLD",9591,"REQB",14,0)
PSO*7.0*482^2
"BLD",9591,"REQB",15,0)
PSO*7.0*517^2
"BLD",9591,"REQB",16,0)
PSO*7.0*540^2
"BLD",9591,"REQB","B","PSO*7.0*372",4)

"BLD",9591,"REQB","B","PSO*7.0*408",13)

"BLD",9591,"REQB","B","PSO*7.0*411",9)

"BLD",9591,"REQB","B","PSO*7.0*416",2)

"BLD",9591,"REQB","B","PSO*7.0*442",3)

"BLD",9591,"REQB","B","PSO*7.0*443",5)

"BLD",9591,"REQB","B","PSO*7.0*444",8)

"BLD",9591,"REQB","B","PSO*7.0*446",6)

"BLD",9591,"REQB","B","PSO*7.0*454",7)

"BLD",9591,"REQB","B","PSO*7.0*467",1)

"BLD",9591,"REQB","B","PSO*7.0*482",14)

"BLD",9591,"REQB","B","PSO*7.0*505",10)

"BLD",9591,"REQB","B","PSO*7.0*517",15)

"BLD",9591,"REQB","B","PSO*7.0*520",11)

"BLD",9591,"REQB","B","PSO*7.0*527",12)

"BLD",9591,"REQB","B","PSO*7.0*540",16)

"FIA",52)
PRESCRIPTION
"FIA",52,0)
^PSRX(
"FIA",52,0,0)
52Is
"FIA",52,0,1)
y^y^p^^^^n^^n
"FIA",52,0,10)

"FIA",52,0,11)

"FIA",52,0,"RLRO")

"FIA",52,0,"VR")
7.0^PSO
"FIA",52,52)
1
"FIA",52,52.3)
1
"FIA",52,52.3,.02)

"FIA",52.45)
ERX SERVICE REASON CODES
"FIA",52.45,0)
^PS(52.45,
"FIA",52.45,0,0)
52.45I
"FIA",52.45,0,1)
y^y^p^^^^n^^n
"FIA",52.45,0,10)

"FIA",52.45,0,11)

"FIA",52.45,0,"RLRO")

"FIA",52.45,0,"VR")
7.0^PSO
"FIA",52.45,52.45)
1
"FIA",52.45,52.45,.02)

"FIA",52.45,52.45,.03)

"FIA",52.46)
ERX EXTERNAL PATIENT
"FIA",52.46,0)
^PS(52.46,
"FIA",52.46,0,0)
52.46I
"FIA",52.46,0,1)
y^y^p^^^^n^^n
"FIA",52.46,0,10)

"FIA",52.46,0,11)

"FIA",52.46,0,"RLRO")

"FIA",52.46,0,"VR")
7.0^PSO
"FIA",52.46,52.46)
1
"FIA",52.46,52.46,6)

"FIA",52.49)
ERX HOLDING QUEUE
"FIA",52.49,0)
^PS(52.49,
"FIA",52.49,0,0)
52.49
"FIA",52.49,0,1)
y^y^p^^^^n^^n
"FIA",52.49,0,10)

"FIA",52.49,0,11)

"FIA",52.49,0,"RLRO")

"FIA",52.49,0,"VR")
7.0^PSO
"FIA",52.49,52.49)
1
"FIA",52.49,52.49,.02)

"FIA",52.49,52.49,.04)

"FIA",52.49,52.49,.08)

"FIA",52.49,52.49,.14)

"FIA",52.49,52.49,2.1)

"FIA",52.49,52.49,5.7)

"FIA",52.49,52.49,25)

"FIA",52.49,52.49,49)

"FIA",52.49,52.49,50)

"FIA",52.49,52.49,50.1)

"FIA",52.49,52.49,50.2)

"FIA",52.49,52.49,51.1)

"FIA",52.49,52.49,51.2)

"FIA",52.49,52.49,52.1)

"FIA",52.49,52.49,52.2)

"FIA",52.49,52.49,52.3)

"FIA",52.49,52.49,55)

"FIA",52.49,52.49,60)

"FIA",52.49,52.49,60.1)

"FIA",52.49,52.49,61)

"FIA",52.49,52.49,80.1)

"FIA",52.49,52.49,80.2)

"FIA",52.49,52.49,80.3)

"FIA",52.49,52.49,80.4)

"FIA",52.49,52.49,80.5)

"FIA",52.49,52.49,100)

"FIA",52.49,52.49,201)

"FIA",52.49,52.49101)
0
"FIA",52.49,52.49201)
0
"FIA",52.49,52.4949)
0
"FIA",52.49,52.4955)
0
"FIA",52.49,52.4961)
0
"INIT")
PSO508PO
"IX",52.45,52.45,"C",0)
52.45^C^Index of the code type and the code identifier.^R^^R^IR^I^52.45^^^^^LS
"IX",52.45,52.45,"C",.1,0)
^^3^3^3161207^
"IX",52.45,52.45,"C",.1,1,0)
This index creates a relationship between the code type and the codes 
"IX",52.45,52.45,"C",.1,2,0)
associated with that type. This will be used to screen the codes when 
"IX",52.45,52.45,"C",.1,3,0)
choosing or looking for a code type.
"IX",52.45,52.45,"C",1)
S ^PS(52.45,"C",X(1),$E(X(2),1,30),DA)=""
"IX",52.45,52.45,"C",2)
K ^PS(52.45,"C",X(1),$E(X(2),1,30),DA)
"IX",52.45,52.45,"C",2.5)
K ^PS(52.45,"C")
"IX",52.45,52.45,"C",11.1,0)
^.114IA^2^2
"IX",52.45,52.45,"C",11.1,1,0)
1^F^52.45^.03^^1^F
"IX",52.45,52.45,"C",11.1,1,3)

"IX",52.45,52.45,"C",11.1,2,0)
2^F^52.45^.01^30^2^F
"IX",52.45,52.45,"C",11.1,2,3)

"IX",52.49,52.49,"CHVID",0)
52.49^CHVID^This indexes the CH MESSAGE ID^R^^F^IR^I^52.49^^^^^LS
"IX",52.49,52.49,"CHVID",.1,0)
^^2^2^3180117^
"IX",52.49,52.49,"CHVID",.1,1,0)
This will index the change healthcare/vista message ID in the eRx holding 
"IX",52.49,52.49,"CHVID",.1,2,0)
queue.
"IX",52.49,52.49,"CHVID",1)
S ^PS(52.49,"CHVID",$E(X,1,35),DA)=""
"IX",52.49,52.49,"CHVID",2)
K ^PS(52.49,"CHVID",$E(X,1,35),DA)
"IX",52.49,52.49,"CHVID",2.5)
K ^PS(52.49,"CHVID")
"IX",52.49,52.49,"CHVID",11.1,0)
^.114IA^1^1
"IX",52.49,52.49,"CHVID",11.1,1,0)
1^F^52.49^25^35^1^F
"IX",52.49,52.49,"EPAT",0)
52.49^EPAT^Index by date, patient IEN, and eRx IEN^R^^R^IR^I^52.49^^^^^LS
"IX",52.49,52.49,"EPAT",.1,0)
^^1^1^3180523^
"IX",52.49,52.49,"EPAT",.1,1,0)
This index provides a quick lookup by date, patient IEN, and ERX IEN.
"IX",52.49,52.49,"EPAT",1)
S ^PS(52.49,"EPAT",X(1),X(2),X(3),DA)=""
"IX",52.49,52.49,"EPAT",2)
K ^PS(52.49,"EPAT",X(1),X(2),X(3),DA)
"IX",52.49,52.49,"EPAT",2.5)
K ^PS(52.49,"EPAT")
"IX",52.49,52.49,"EPAT",11.1,0)
^.114IA^3^3
"IX",52.49,52.49,"EPAT",11.1,1,0)
1^F^52.49^24.1^^1^F
"IX",52.49,52.49,"EPAT",11.1,1,3)

"IX",52.49,52.49,"EPAT",11.1,2,0)
2^F^52.49^.03^^2^F
"IX",52.49,52.49,"EPAT",11.1,2,3)

"IX",52.49,52.49,"EPAT",11.1,3,0)
3^F^52.49^.04^^3^F
"IX",52.49,52.49,"EPAT",11.1,3,3)

"IX",52.49,52.49,"EPROV",0)
52.49^EPROV^This index allows for quick lookups on providers^R^^R^IR^I^52.49^^^^^LS
"IX",52.49,52.49,"EPROV",.1,0)
^^2^2^3180524^
"IX",52.49,52.49,"EPROV",.1,1,0)
This indexes the institution, date, provider and erx ien for quick 
"IX",52.49,52.49,"EPROV",.1,2,0)
searching when using the search function.
"IX",52.49,52.49,"EPROV",1)
S ^PS(52.49,"EPROV",X(1),X(2),X(3),DA)=""
"IX",52.49,52.49,"EPROV",2)
K ^PS(52.49,"EPROV",X(1),X(2),X(3),DA)
"IX",52.49,52.49,"EPROV",2.5)
K ^PS(52.49,"EPROV")
"IX",52.49,52.49,"EPROV",11.1,0)
^.114IA^3^3
"IX",52.49,52.49,"EPROV",11.1,1,0)
1^F^52.49^24.1^^1^F
"IX",52.49,52.49,"EPROV",11.1,1,3)

"IX",52.49,52.49,"EPROV",11.1,2,0)
2^F^52.49^.03^^2^F
"IX",52.49,52.49,"EPROV",11.1,2,3)

"IX",52.49,52.49,"EPROV",11.1,3,0)
3^F^52.49^2.1^^3^F
"IX",52.49,52.49,"EPROV",11.1,3,3)

"IX",52.49,52.49,"MTYPE",0)
52.49^MTYPE^Index by message type^R^^R^IR^I^52.49^^^^^LS
"IX",52.49,52.49,"MTYPE",.1,0)
^^2^2^3180904^
"IX",52.49,52.49,"MTYPE",.1,1,0)
This indexes the message type for quick lookup when searching by message 
"IX",52.49,52.49,"MTYPE",.1,2,0)
type.
"IX",52.49,52.49,"MTYPE",1)
S ^PS(52.49,"MTYPE",X(1),X(2),X(3),DA)=""
"IX",52.49,52.49,"MTYPE",2)
K ^PS(52.49,"MTYPE",X(1),X(2),X(3),DA)
"IX",52.49,52.49,"MTYPE",2.5)
K ^PS(52.49,"MTYPE")
"IX",52.49,52.49,"MTYPE",11.1,0)
^.114IA^3^3
"IX",52.49,52.49,"MTYPE",11.1,1,0)
1^F^52.49^24.1^^1^F
"IX",52.49,52.49,"MTYPE",11.1,2,0)
2^F^52.49^.03^^2^F
"IX",52.49,52.49,"MTYPE",11.1,3,0)
3^F^52.49^.08^^3^F
"IX",52.49,52.49,"PAT",0)
52.49^PAT^Patient and Date Time index^R^^R^IR^I^52.49^^^^^LS
"IX",52.49,52.49,"PAT",.1,0)
^^2^2^3170610^
"IX",52.49,52.49,"PAT",.1,1,0)
This index provides a quick reference to patient, date, and site. Used 
"IX",52.49,52.49,"PAT",.1,2,0)
for bulk validation.
"IX",52.49,52.49,"PAT",1)
S ^PS(52.49,"PAT",X(1),X(2),X(3),X(4),DA)=""
"IX",52.49,52.49,"PAT",2)
K ^PS(52.49,"PAT",X(1),X(2),X(3),X(4),DA)
"IX",52.49,52.49,"PAT",2.5)
K ^PS(52.49,"PAT")
"IX",52.49,52.49,"PAT",11.1,0)
^.114IA^4^4
"IX",52.49,52.49,"PAT",11.1,1,0)
1^F^52.49^24.1^^1^F
"IX",52.49,52.49,"PAT",11.1,1,3)

"IX",52.49,52.49,"PAT",11.1,2,0)
2^F^52.49^1^^2^F
"IX",52.49,52.49,"PAT",11.1,2,3)

"IX",52.49,52.49,"PAT",11.1,3,0)
3^F^52.49^.04^^3^F
"IX",52.49,52.49,"PAT",11.1,3,3)

"IX",52.49,52.49,"PAT",11.1,4,0)
4^F^52.49^.03^^4^F
"IX",52.49,52.49,"PAT",11.1,4,3)

"IX",52.49,52.49,"PAT2",0)
52.49^PAT2^Index by patient and date/time^R^^R^IR^I^52.49^^^^^LS
"IX",52.49,52.49,"PAT2",.1,0)
^^2^2^3180628^
"IX",52.49,52.49,"PAT2",.1,1,0)
This index is used to quickly lookup records for a patient within a 
"IX",52.49,52.49,"PAT2",.1,2,0)
specified date range.
"IX",52.49,52.49,"PAT2",1)
S ^PS(52.49,"PAT2",X(1),X(2),DA)=""
"IX",52.49,52.49,"PAT2",2)
K ^PS(52.49,"PAT2",X(1),X(2),DA)
"IX",52.49,52.49,"PAT2",2.5)
K ^PS(52.49,"PAT2")
"IX",52.49,52.49,"PAT2",11.1,0)
^.114IA^2^2
"IX",52.49,52.49,"PAT2",11.1,1,0)
1^F^52.49^.04^^1^F
"IX",52.49,52.49,"PAT2",11.1,1,3)

"IX",52.49,52.49,"PAT2",11.1,2,0)
2^F^52.49^.03^^2^F
"IX",52.49,52.49,"PAT2",11.1,2,3)

"IX",52.49,52.49,"RTMID",0)
52.49^RTMID^Index for relates to message ID.^R^^F^IR^I^52.49^^^^^LS
"IX",52.49,52.49,"RTMID",.1,0)
^^2^2^3180827^
"IX",52.49,52.49,"RTMID",.1,1,0)
This indexes the relates to message ID for quick retrieval of message 
"IX",52.49,52.49,"RTMID",.1,2,0)
linkage.
"IX",52.49,52.49,"RTMID",1)
S ^PS(52.49,"RTMID",$E(X,1,35),DA)=""
"IX",52.49,52.49,"RTMID",2)
K ^PS(52.49,"RTMID",$E(X,1,35),DA)
"IX",52.49,52.49,"RTMID",2.5)
K ^PS(52.49,"RTMID")
"IX",52.49,52.49,"RTMID",11.1,0)
^.114IA^1^1
"IX",52.49,52.49,"RTMID",11.1,1,0)
1^F^52.49^.02^35^1^F
"KRN",19,14309,-1)
0^1
"KRN",19,14309,0)
PSO ERX FINISH^Complete Orders from eRx^^A^^^^^^^^OUTPATIENT PHARMACY^^1^
"KRN",19,14309,1,0)
^19.06^1^1^3180525^^^
"KRN",19,14309,1,1,0)
This menu option allows users to complete incoming eRx prescriptions.
"KRN",19,14309,15)

"KRN",19,14309,20)
D EN^PSOERXEN
"KRN",19,14309,"U")
COMPLETE ORDERS FROM ERX
"KRN",101,1803,-1)
4^16
"KRN",101,1803,0)
VALM NEXT SCREEN
"KRN",101,1804,-1)
4^17
"KRN",101,1804,0)
VALM PREVIOUS SCREEN
"KRN",101,1805,-1)
4^21
"KRN",101,1805,0)
VALM REFRESH
"KRN",101,1806,-1)
4^14
"KRN",101,1806,0)
VALM LAST SCREEN
"KRN",101,1807,-1)
4^12
"KRN",101,1807,0)
VALM FIRST SCREEN
"KRN",101,1808,-1)
4^25
"KRN",101,1808,0)
VALM UP ONE LINE
"KRN",101,1809,-1)
4^11
"KRN",101,1809,0)
VALM DOWN A LINE
"KRN",101,1811,-1)
4^20
"KRN",101,1811,0)
VALM QUIT
"KRN",101,1812,-1)
4^19
"KRN",101,1812,0)
VALM PRINT SCREEN
"KRN",101,1813,-1)
4^18
"KRN",101,1813,0)
VALM PRINT LIST
"KRN",101,1815,-1)
4^24
"KRN",101,1815,0)
VALM TURN ON/OFF MENUS
"KRN",101,1817,-1)
4^23
"KRN",101,1817,0)
VALM SEARCH LIST
"KRN",101,1824,-1)
4^22
"KRN",101,1824,0)
VALM RIGHT
"KRN",101,1825,-1)
4^15
"KRN",101,1825,0)
VALM LEFT
"KRN",101,1827,-1)
4^13
"KRN",101,1827,0)
VALM GOTO PAGE
"KRN",101,3842,-1)
3^4
"KRN",101,3842,0)
PSO LM HIDDEN OTHER^Other OP Actions^^M^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,3842,10,0)
^101.01PA^16^16
"KRN",101,3842,10,16,0)
6221^RR^^
"KRN",101,3842,10,16,"^")
PSO ERX REFILL REQUEST
"KRN",101,3842,15)
S VALMBCK="R"
"KRN",101,3842,99)
64933,53171
"KRN",101,3844,-1)
3^5
"KRN",101,3844,0)
PSO LM HIDDEN OTHER #2^Other OP Actions^^M^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,3844,10,0)
^101.01PA^7^7
"KRN",101,3844,10,7,0)
6222^RR^^
"KRN",101,3844,10,7,"^")
PSO ERX SINGLE REFILL REQUEST
"KRN",101,3844,15)
S VALMBCK="R"
"KRN",101,3844,99)
64933,53171
"KRN",101,6189,-1)
3^8
"KRN",101,6189,0)
PSO ERX HQ MENU^ERX QUEUE MENU^^M^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6189,1,0)
^101.06^1^1^3170422^^^
"KRN",101,6189,1,1,0)
This is the eRx holding queue menu.
"KRN",101,6189,4)
25^3
"KRN",101,6189,10,0)
^101.01PA^4^4
"KRN",101,6189,10,4,0)
6223^MV^4^
"KRN",101,6189,10,4,"^")
PSO ERX MESSAGE VIEW
"KRN",101,6189,24)
I 1 X:$D(^ORD(101,+$P(^ORD(101,DA(1),10,DA,0),"""^""",1),24)) ^(24)
"KRN",101,6189,26)
D SHOW^VALM S XQORM("#")=$O(^ORD(101,"B","PSO ERX SELECT BY NUMBER",0))_"^1:"_VALMCNT
"KRN",101,6189,28)
Select Action:
"KRN",101,6189,99)
64933,53171
"KRN",101,6191,-1)
3^9
"KRN",101,6191,0)
PSO ERX DISPLAY MENU^eRx Display^^M^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6191,4)
26^3
"KRN",101,6191,10,0)
^101.01PA^9^9
"KRN",101,6191,10,1,0)
6192^VP^1^
"KRN",101,6191,10,1,"^")
PSO ERX VALIDATE PATIENT
"KRN",101,6191,10,2,0)
6195^VM^4^
"KRN",101,6191,10,2,"^")
PSO ERX VALIDATE PROVIDER
"KRN",101,6191,10,3,0)
6196^VD^7^
"KRN",101,6191,10,3,"^")
PSO ERX VALIDATE DRUG
"KRN",101,6191,10,4,0)
6198^P^2^
"KRN",101,6191,10,4,"^")
PSO ERX PRINT
"KRN",101,6191,10,5,0)
6199^RJ^5^
"KRN",101,6191,10,5,"^")
PSO ERX REJECT
"KRN",101,6191,10,6,0)
6200^AC^8^
"KRN",101,6191,10,6,"^")
PSO ERX ACCEPT ERX
"KRN",101,6191,10,7,0)
6201^H^3^
"KRN",101,6191,10,7,"^")
PSO ERX HOLD
"KRN",101,6191,10,8,0)
6202^UH^6^
"KRN",101,6191,10,8,"^")
PSO ERX UNHOLD
"KRN",101,6191,10,9,0)
6206^RM^9^
"KRN",101,6191,10,9,"^")
PSO ERX REMOVE
"KRN",101,6191,20)

"KRN",101,6191,24)
I 1 X:$D(^ORD(101,+$P(^ORD(101,DA(1),10,DA,0),"""^""",1),24)) ^(24)
"KRN",101,6191,26)
D SHOW^VALM
"KRN",101,6191,28)
Select Action:
"KRN",101,6191,99)
64933,53171
"KRN",101,6192,-1)
0^30
"KRN",101,6192,0)
PSO ERX VALIDATE PATIENT^VALIDATE PATIENT^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6192,1,0)
^101.06^3^3^3161201^^
"KRN",101,6192,1,1,0)
This protocol hangs off of the PSO ERX HQ DISPLAY PROTOCOL as an action. 
"KRN",101,6192,1,2,0)
This protocol allows the user to manually validate the patient for a 
"KRN",101,6192,1,3,0)
given eRx prescription.
"KRN",101,6192,20)
D PAT^PSOERX1A
"KRN",101,6192,24)
I $$OPACCESS^PSOERXU1("PSO ERX VALIDATE PATIENT",DUZ),$$RRRESCR^PSOERXU3(ERXIEN)
"KRN",101,6192,99)
64933,53171
"KRN",101,6195,-1)
0^29
"KRN",101,6195,0)
PSO ERX VALIDATE PROVIDER^VALIDATE PROVIDER^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6195,20)
D PROV^PSOERX1A
"KRN",101,6195,24)
I $$OPACCESS^PSOERXU1("PSO ERX VALIDATE PROVIDER",DUZ),$$CHPRCHG^PSOERXU1(PSOIEN)
"KRN",101,6195,99)
64933,53171
"KRN",101,6196,-1)
0^28
"KRN",101,6196,0)
PSO ERX VALIDATE DRUG^VALIDATE DRUG/SIG^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6196,20)
D DRUG^PSOERX1A
"KRN",101,6196,24)
I $$OPACCESS^PSOERXU1("PSO ERX VALIDATE DRUG",DUZ),$$GET1^DIQ(52.49,PSOIEN,.05,"I"),$$RRRESCR^PSOERXU3(PSOIEN,"DRUG")
"KRN",101,6196,99)
64933,53171
"KRN",101,6198,-1)
0^37
"KRN",101,6198,0)
PSO ERX PRINT^Print^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6198,20)
D PRINT^PSOERX1C(PSOIEN)
"KRN",101,6198,24)

"KRN",101,6198,99)
64933,53171
"KRN",101,6199,-1)
0^34
"KRN",101,6199,0)
PSO ERX REJECT^Reject^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6199,20)
D REJ^PSOERX1B
"KRN",101,6199,24)
I $$OPACCESS^PSOERXU1("PSO ERX REJECT",DUZ,PSOIEN)
"KRN",101,6199,99)
64933,53171
"KRN",101,6200,-1)
0^31
"KRN",101,6200,0)
PSO ERX ACCEPT ERX^Accept eRx^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6200,20)
D SETUP^PSOERX1B
"KRN",101,6200,24)
I $$OPACCESS^PSOERXU1("PSO ERX ACCEPT ERX",DUZ),$$RRRESCR^PSOERXU3(PSOIEN,"ACCEPT")
"KRN",101,6200,99)
64933,53171
"KRN",101,6201,-1)
0^32
"KRN",101,6201,0)
PSO ERX HOLD^Hold^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6201,15)

"KRN",101,6201,20)
D HOLD^PSOERXH1
"KRN",101,6201,24)
I $$OPACCESS^PSOERXU1("PSO ERX HOLD",DUZ,PSOIEN)
"KRN",101,6201,99)
64933,53171
"KRN",101,6202,-1)
0^33
"KRN",101,6202,0)
PSO ERX UNHOLD^Un-Hold^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6202,20)
D UNHOLD^PSOERXH1
"KRN",101,6202,24)
I $$OPACCESS^PSOERXU1("PSO ERX UNHOLD",DUZ,PSOIEN)
"KRN",101,6202,99)
64933,53171
"KRN",101,6206,-1)
0^35
"KRN",101,6206,0)
PSO ERX REMOVE^Remove eRx^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6206,20)
D REM^PSOERX1B
"KRN",101,6206,24)
I $$OPACCESS^PSOERXU1("PSO ERX REMOVE",DUZ,PSOIEN)
"KRN",101,6206,99)
64933,53171
"KRN",101,6207,-1)
0^1
"KRN",101,6207,0)
PSO ERX HIDDEN ACTIONS^eRx Hidden actions menu^^M^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6207,1,0)
^101.06^1^1^3180808^^^^
"KRN",101,6207,1,1,0)
Hidden actions for the eRx holding queue.
"KRN",101,6207,4)
25^
"KRN",101,6207,10,0)
^101.01PA^22^22
"KRN",101,6207,10,1,0)
1803^+^11^
"KRN",101,6207,10,1,"^")
VALM NEXT SCREEN
"KRN",101,6207,10,2,0)
1804^-^12^
"KRN",101,6207,10,2,"^")
VALM PREVIOUS SCREEN
"KRN",101,6207,10,3,0)
1808^UP^13^
"KRN",101,6207,10,3,"^")
VALM UP ONE LINE
"KRN",101,6207,10,4,0)
1809^DN^14^
"KRN",101,6207,10,4,"^")
VALM DOWN A LINE
"KRN",101,6207,10,5,0)
1805^RD^24^
"KRN",101,6207,10,5,"^")
VALM REFRESH
"KRN",101,6207,10,6,0)
1812^PS^25^
"KRN",101,6207,10,6,"^")
VALM PRINT SCREEN
"KRN",101,6207,10,7,0)
1813^PL^26^
"KRN",101,6207,10,7,"^")
VALM PRINT LIST
"KRN",101,6207,10,8,0)
1824^>^15^
"KRN",101,6207,10,8,"^")
VALM RIGHT
"KRN",101,6207,10,9,0)
1825^<^16^
"KRN",101,6207,10,9,"^")
VALM LEFT
"KRN",101,6207,10,10,0)
1815^ADPL^32^
"KRN",101,6207,10,10,"^")
VALM TURN ON/OFF MENUS
"KRN",101,6207,10,11,0)
1817^SL^31^
"KRN",101,6207,10,11,"^")
VALM SEARCH LIST
"KRN",101,6207,10,12,0)
1811^Q^33^
"KRN",101,6207,10,12,"^")
VALM QUIT
"KRN",101,6207,10,13,0)
1806^LS^22^
"KRN",101,6207,10,13,"^")
VALM LAST SCREEN
"KRN",101,6207,10,14,0)
1807^FS^21^
"KRN",101,6207,10,14,"^")
VALM FIRST SCREEN
"KRN",101,6207,10,15,0)
1827^GO^23^
"KRN",101,6207,10,15,"^")
VALM GOTO PAGE
"KRN",101,6207,10,16,0)
6224^AD^34^
"KRN",101,6207,10,16,"^")
PSO ERX ADD COMMENT
"KRN",101,6207,10,19,0)
6273^ACK^35^
"KRN",101,6207,10,19,"^")
PSO ERX ACKNOWLEDGE
"KRN",101,6207,10,21,0)
6279^JO^^
"KRN",101,6207,10,21,"^")
PSO ERX JUMP TO OP
"KRN",101,6207,10,22,0)
6281^SH^36^
"KRN",101,6207,10,22,"^")
PSO ERX STATUS HISTORY
"KRN",101,6207,20)

"KRN",101,6207,24)
I 1 X:$D(^ORD(101,+$P(^ORD(101,DA(1),10,DA,0),"""^""",1),24)) ^(24)
"KRN",101,6207,26)
D SHOW^VALM
"KRN",101,6207,99)
64933,53171
"KRN",101,6221,-1)
0^3
"KRN",101,6221,0)
PSO ERX REFILL REQUEST^eRx Refill Request^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6221,1,0)
^^2^2^3180106^
"KRN",101,6221,1,1,0)
This action protocol executes a rxRefillRequest to Change Healthcare. An 
"KRN",101,6221,1,2,0)
rxRefillResponse may then be returned by an external provider.
"KRN",101,6221,20)
D RREQLST^PSOERXX1(.PSOLST,PSOSITE,PSOCNT)
"KRN",101,6221,99)
64933,53171
"KRN",101,6222,-1)
0^6
"KRN",101,6222,0)
PSO ERX SINGLE REFILL REQUEST^eRx Refill Request^^A^^^^^^^^
"KRN",101,6222,1,0)
^^2^2^3180106^
"KRN",101,6222,1,1,0)
This action protocol allows a user to issue an eRx refill/renewal request 
"KRN",101,6222,1,2,0)
for a single prescription.
"KRN",101,6222,20)
D RREQSIN^PSOERXX1(RXN,PSOSITE)
"KRN",101,6222,99)
64933,53171
"KRN",101,6223,-1)
0^7
"KRN",101,6223,0)
PSO ERX MESSAGE VIEW^Message View^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6223,1,0)
^101.06^1^1^3180807^^^^
"KRN",101,6223,1,1,0)
This action protocol allows a user to view specific message types.
"KRN",101,6223,20)
D MTYPE2^PSOERX
"KRN",101,6223,24)
I '$D(SRCH(7)),'$D(PCV)
"KRN",101,6223,99)
64933,53171
"KRN",101,6224,-1)
0^10
"KRN",101,6224,0)
PSO ERX ADD COMMENT^Add Comment^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6224,1,0)
^^1^1^3180419^
"KRN",101,6224,1,1,0)
This protocol action allows a user to add comments to an eRx message.
"KRN",101,6224,20)
D ADDCOMM^PSOERXU2(PSOIEN)
"KRN",101,6224,24)
I $$GET1^DIQ(52.49,PSOIEN,.08,"I")="RR"
"KRN",101,6224,99)
64933,53171
"KRN",101,6273,-1)
0^36
"KRN",101,6273,0)
PSO ERX ACKNOWLEDGE^Acknowledge^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6273,1,0)
^^2^2^3180419^
"KRN",101,6273,1,1,0)
This action protocol allows a user to acknowledge electronic prescription 
"KRN",101,6273,1,2,0)
messages.
"KRN",101,6273,20)
D CANACK^PSOERXU5(PSOIEN)
"KRN",101,6273,99)
64933,53171
"KRN",101,6274,-1)
0^41
"KRN",101,6274,0)
PSO ERX PCV SELECT PATIENT^SELECT PATIENT^^A^^^^^^^^
"KRN",101,6274,15)

"KRN",101,6274,20)
D PATDATA^PSOERXC1
"KRN",101,6274,26)

"KRN",101,6274,99)
64933,53171
"KRN",101,6275,-1)
0^38
"KRN",101,6275,0)
PSO ERX PCV MENU^PSO ERX PCV MENU^^M^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6275,4)
25^3
"KRN",101,6275,10,0)
^101.01PA^4^4
"KRN",101,6275,10,1,0)
6274^SP^1^
"KRN",101,6275,10,1,"^")
PSO ERX PCV SELECT PATIENT
"KRN",101,6275,10,2,0)
6276^SR^2^
"KRN",101,6275,10,2,"^")
PSO ERX PCV SEARCH QUEUE
"KRN",101,6275,10,3,0)
6277^SO^3^
"KRN",101,6275,10,3,"^")
PSO ERX PCV SORT ENTRIES
"KRN",101,6275,10,4,0)
6280^MV^4^
"KRN",101,6275,10,4,"^")
PSO ERX PCV MESSAGE VIEW
"KRN",101,6275,24)
I 1 X:$D(^ORD(101,+$P(^ORD(101,DA(1),10,DA,0),"""^""",1),24)) ^(24)
"KRN",101,6275,26)
D SHOW^VALM S XQORM("#")=$O(^ORD(101,"B","PSO ERX PCV SELECT BY NUMBER",0))_"^1:"_VALMCNT
"KRN",101,6275,99)
64933,53171
"KRN",101,6276,-1)
0^39
"KRN",101,6276,0)
PSO ERX PCV SEARCH QUEUE^SEARCH QUEUE^^A^^^^^^^^
"KRN",101,6276,10,0)
^101.01PA
"KRN",101,6276,15)

"KRN",101,6276,20)
D CENTSRCH^PSOERXC1
"KRN",101,6276,24)
I '$D(PSOSRCH(VALMEVL))
"KRN",101,6276,99)
64933,53171
"KRN",101,6277,-1)
0^42
"KRN",101,6277,0)
PSO ERX PCV SORT ENTRIES^SORT ENTRIES^^A^^^^^^^^
"KRN",101,6277,4)
25^3
"KRN",101,6277,15)

"KRN",101,6277,20)
D CENTSORT^PSOERXC1
"KRN",101,6277,24)
I '$D(PSOSRT(VALMEVL))
"KRN",101,6277,99)
64933,53171
"KRN",101,6278,-1)
0^40
"KRN",101,6278,0)
PSO ERX PCV SELECT BY NUMBER^^^A^^^^^^^^
"KRN",101,6278,15)

"KRN",101,6278,20)
D SBN^PSOERXC1
"KRN",101,6278,99)
64868,58926
"KRN",101,6279,-1)
0^43
"KRN",101,6279,0)
PSO ERX JUMP TO OP^JUMP TO OP^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6279,20)
D JTQ^PSOERXU6(ERXIEN)
"KRN",101,6279,99)
64933,53171
"KRN",101,6280,-1)
0^44
"KRN",101,6280,0)
PSO ERX PCV MESSAGE VIEW^Message View^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6280,1,0)
^^2^2^3180807^
"KRN",101,6280,1,1,0)
This action protocol allows a user to view specific message types within 
"KRN",101,6280,1,2,0)
the patient centric view.
"KRN",101,6280,20)
D MTYPE2^PSOERX
"KRN",101,6280,24)
I '$D(PCV)
"KRN",101,6280,99)
64933,53171
"KRN",101,6281,-1)
0^45
"KRN",101,6281,0)
PSO ERX STATUS HISTORY^Status History^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,6281,1,0)
^^1^1^3180808^
"KRN",101,6281,1,1,0)
This action protocol displays the status history for an eRx record.
"KRN",101,6281,20)
D SH^PSOERXU6(ERXIEN)
"KRN",101,6281,99)
64933,53171
"KRN",101,6294,-1)
1^2
"KRN",101,6294,0)
PSO ERX RENEW REQUEST
"KRN",409.61,839,-1)
0^1
"KRN",409.61,839,0)
PSO ERX PATIENT CENTRIC VIEW^1^^80^5^20^0^1^^PSO ERX PCV MENU^PSO ERX PATIENT CENTRIC VIEW^1^^1
"KRN",409.61,839,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,839,"COL",0)
^409.621^14^12
"KRN",409.61,839,"COL",1,0)
ERX PATIENT^5^17^ERX PATIENT
"KRN",409.61,839,"COL",2,0)
DOB^24^10^DOB
"KRN",409.61,839,"COL",3,0)
#^1^4^#
"KRN",409.61,839,"COL",6,0)
NW^57^2^NW
"KRN",409.61,839,"COL",7,0)
WT^60^2^WT
"KRN",409.61,839,"COL",8,0)
IP^63^2^IP
"KRN",409.61,839,"COL",9,0)
HD^66^3^HD
"KRN",409.61,839,"COL",10,0)
TOT^77^3^TOT
"KRN",409.61,839,"COL",11,0)
ED^36^3^ED
"KRN",409.61,839,"COL",12,0)
LASTUSER^40^16^LAST USER
"KRN",409.61,839,"COL",13,0)
CCR^69^3^CCR
"KRN",409.61,839,"COL",14,0)
OTH^73^3^OTH
"KRN",409.61,839,"COL","B","#",3)

"KRN",409.61,839,"COL","B","CCR",13)

"KRN",409.61,839,"COL","B","DOB",2)

"KRN",409.61,839,"COL","B","ED",11)

"KRN",409.61,839,"COL","B","ERX PATIENT",1)

"KRN",409.61,839,"COL","B","HD",9)

"KRN",409.61,839,"COL","B","IP",8)

"KRN",409.61,839,"COL","B","LASTUSER",12)

"KRN",409.61,839,"COL","B","NW",6)

"KRN",409.61,839,"COL","B","OTH",14)

"KRN",409.61,839,"COL","B","TOT",10)

"KRN",409.61,839,"COL","B","WT",7)

"KRN",409.61,839,"FNL")
D EXIT^PSOERXC1
"KRN",409.61,839,"HDR")
D HDR^PSOERXC1
"KRN",409.61,839,"HLP")
D HELP^PSOERXC1
"KRN",409.61,839,"INIT")
D INIT^PSOERXC1
"KRN",8994,3626,-1)
0^1
"KRN",8994,3626,0)
PSOERXA1 INCERX^INCERX^PSOERXA1^1^^^^1^^^1
"KRN",8994,3626,1,0)
^8994.01^2^2^3180111^^^^
"KRN",8994,3626,1,1,0)
This RPC receives and processes an incoming ERX XML message, provider 
"KRN",8994,3626,1,2,0)
check information, and patient check information.
"KRN",8994,3626,2,0)
^8994.02A^10^10
"KRN",8994,3626,2,1,0)
XML^1^^1^1
"KRN",8994,3626,2,1,1,0)
^8994.021^1^1^3170825^^
"KRN",8994,3626,2,1,1,1,0)
The full XML text, as a 'stream' or 'literal'.
"KRN",8994,3626,2,2,0)
PRCHK^2^^0^2
"KRN",8994,3626,2,2,1,0)
^8994.021^1^1^3170308^^
"KRN",8994,3626,2,2,1,1,0)
This is the provider check results from the eRx middleware.
"KRN",8994,3626,2,3,0)
PACHK^2^^0^3
"KRN",8994,3626,2,3,1,0)
^8994.021^1^1^3170308^^^
"KRN",8994,3626,2,3,1,1,0)
This is the patient check information from the eRx middleware.
"KRN",8994,3626,2,4,0)
DACHK^2^^0^4
"KRN",8994,3626,2,4,1,0)
^8994.021^1^1^3170612^^
"KRN",8994,3626,2,4,1,1,0)
This is the drug autocheck information from the eRx processing hub.
"KRN",8994,3626,2,5,0)
STATION^1^^^5
"KRN",8994,3626,2,5,1,0)
^^1^1^3170612^
"KRN",8994,3626,2,5,1,1,0)
This is the station number the prescription is being sent to.
"KRN",8994,3626,2,6,0)
DIV^1^^^6
"KRN",8994,3626,2,6,1,0)
^^1^1^3170612^
"KRN",8994,3626,2,6,1,1,0)
The division associated with the incomine eRx.
"KRN",8994,3626,2,7,0)
ERXHID^1^^^7
"KRN",8994,3626,2,7,1,0)
^^1^1^3170612^
"KRN",8994,3626,2,7,1,1,0)
This is the eRx processing HUB identification number.
"KRN",8994,3626,2,8,0)
ERXVALS^2^^^8
"KRN",8994,3626,2,8,1,0)
^^2^2^3170612^
"KRN",8994,3626,2,8,1,1,0)
These are the code values, human readable associated with the erx NCLT 
"KRN",8994,3626,2,8,1,2,0)
codes.
"KRN",8994,3626,2,9,0)
XML2^1^^0^9
"KRN",8994,3626,2,10,0)
SOURCE^1^^0^10
"KRN",8994,3626,2,10,1,0)
^^2^2^3180111^
"KRN",8994,3626,2,10,1,1,0)
This parameter is used to indicate the source of the message. Null means 
"KRN",8994,3626,2,10,1,2,0)
processing hub, 1 - vista.
"KRN",8994,3626,2,"B","DACHK",4)

"KRN",8994,3626,2,"B","DIV",6)

"KRN",8994,3626,2,"B","ERXHID",7)

"KRN",8994,3626,2,"B","ERXVALS",8)

"KRN",8994,3626,2,"B","PACHK",3)

"KRN",8994,3626,2,"B","PRCHK",2)

"KRN",8994,3626,2,"B","SOURCE",10)

"KRN",8994,3626,2,"B","STATION",5)

"KRN",8994,3626,2,"B","XML",1)

"KRN",8994,3626,2,"B","XML2",9)

"KRN",8994,3626,2,"PARAMSEQ",1,1)

"KRN",8994,3626,2,"PARAMSEQ",2,2)

"KRN",8994,3626,2,"PARAMSEQ",3,3)

"KRN",8994,3626,2,"PARAMSEQ",4,4)

"KRN",8994,3626,2,"PARAMSEQ",5,5)

"KRN",8994,3626,2,"PARAMSEQ",6,6)

"KRN",8994,3626,2,"PARAMSEQ",7,7)

"KRN",8994,3626,2,"PARAMSEQ",8,8)

"KRN",8994,3626,2,"PARAMSEQ",9,9)

"KRN",8994,3626,2,"PARAMSEQ",10,10)

"KRN",8994,3626,3,0)
^8994.03^3^3^3180111^^
"KRN",8994,3626,3,1,0)
Return value(s):
"KRN",8994,3626,3,2,0)
 0^Error message
"KRN",8994,3626,3,3,0)
 1^Erx received
"MBREQ")
0
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"ORD",17,409.61)
409.61;17;1;;;;LME1^XPDIA1;;;LMDEL^XPDIA1
"ORD",17,409.61,0)
LIST TEMPLATE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
508^3181018^11952
"PKG",141,22,1,"PAH",1,1,0)
^^1^1^3181018
"PKG",141,22,1,"PAH",1,1,1,0)
Inbound eRx Version 3 updates.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
39
"RTN","PSO508PO")
0^^B19257631^n/a
"RTN","PSO508PO",1,0)
PSO508PO ;ALB/BWF - patch 508 post-install ; 1/09/2018 10:43am
"RTN","PSO508PO",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**508**;DEC 1997;Build 295
"RTN","PSO508PO",3,0)
 ;
"RTN","PSO508PO",4,0)
EN ;
"RTN","PSO508PO",5,0)
 N DIK,DA
"RTN","PSO508PO",6,0)
 D ERXTYP,ERXPOP,WSUPD
"RTN","PSO508PO",7,0)
 S DIK="^PS(52.49,",DIK(1)=".02^RTMID" D ENALL^DIK K DIK
"RTN","PSO508PO",8,0)
 S DIK="^PS(52.49,",DIK(1)="25^CHVID" D ENALL^DIK K DIK
"RTN","PSO508PO",9,0)
 S DIK="^PS(52.49,",DIK(1)=".14^RTHID" D ENALL^DIK K DIK
"RTN","PSO508PO",10,0)
 S DIK="^PS(52.49,",DIK(1)=".04^PAT2" D ENALL^DIK K DIK
"RTN","PSO508PO",11,0)
 S DIK="^PS(52.49,",DIK(1)=".08^MTYPE" D ENALL^DIK K DIK
"RTN","PSO508PO",12,0)
 ;
"RTN","PSO508PO",13,0)
 S I=0 F  S I=$O(^PS(52.49,I)) Q:'I  D
"RTN","PSO508PO",14,0)
 .S DIK="^PS(52.49,"_I_",100,",DIK(1)=".02^C",DA(1)=I
"RTN","PSO508PO",15,0)
 .D ENALL^DIK K DIK,DA
"RTN","PSO508PO",16,0)
 Q
"RTN","PSO508PO",17,0)
ERXTYP ;
"RTN","PSO508PO",18,0)
 N I
"RTN","PSO508PO",19,0)
 S I=0
"RTN","PSO508PO",20,0)
 F  S I=$O(^PS(52.49,I)) Q:'I  D
"RTN","PSO508PO",21,0)
 .I $$GET1^DIQ(52.49,I,.08,"I")]"" Q
"RTN","PSO508PO",22,0)
 .S FDA(52.49,I_",",.08)="N" D FILE^DIE(,"FDA") K FDA
"RTN","PSO508PO",23,0)
 Q
"RTN","PSO508PO",24,0)
ERXPOP ;
"RTN","PSO508PO",25,0)
 N I,DONE,NIEN,ELINE,ECODE,EDESC,ELONG,EIEN,TYPE,SUB
"RTN","PSO508PO",26,0)
 F TYPE="ERXSTAT","CLQUAL","ERR" D
"RTN","PSO508PO",27,0)
 .I TYPE="ERXSTAT" S SUB="ERX"
"RTN","PSO508PO",28,0)
 .I TYPE="CLQUAL" S SUB="CLQ"
"RTN","PSO508PO",29,0)
 .I TYPE="ERR" S SUB="ERR"
"RTN","PSO508PO",30,0)
 .S DONE=0
"RTN","PSO508PO",31,0)
 .F I=1:1 D  Q:DONE
"RTN","PSO508PO",32,0)
 ..K NIEN
"RTN","PSO508PO",33,0)
 ..I TYPE="ERR" S ELINE=$T(@TYPE+I^PSOERXZ1),ELINE=$P(ELINE,";;",2)
"RTN","PSO508PO",34,0)
 ..I TYPE'="ERR" S ELINE=$T(@TYPE+I),ELINE=$P(ELINE,";;",2)
"RTN","PSO508PO",35,0)
 ..I ELINE=" Q"!(ELINE="") S DONE=1 Q
"RTN","PSO508PO",36,0)
 ..S ECODE=$P(ELINE,U),EDESC=$P(ELINE,U,2),ELONG=$P(ELINE,U,3)
"RTN","PSO508PO",37,0)
 ..I $D(^PS(52.45,"C",SUB,ECODE)) D  Q
"RTN","PSO508PO",38,0)
 ...S EIEN=$O(^PS(52.45,"C",SUB,ECODE,0)) Q:'EIEN
"RTN","PSO508PO",39,0)
 ...S FDA(52.45,EIEN_",",.01)=ECODE
"RTN","PSO508PO",40,0)
 ...S FDA(52.45,EIEN_",",.02)=EDESC
"RTN","PSO508PO",41,0)
 ...S FDA(52.45,EIEN_",",.03)=SUB
"RTN","PSO508PO",42,0)
 ...D FILE^DIE(,"FDA") K FDA
"RTN","PSO508PO",43,0)
 ..S FDA(52.45,"+1,",.01)=ECODE
"RTN","PSO508PO",44,0)
 ..S FDA(52.45,"+1,",.02)=EDESC
"RTN","PSO508PO",45,0)
 ..S FDA(52.45,"+1,",.03)=SUB
"RTN","PSO508PO",46,0)
 ..D UPDATE^DIE(,"FDA","NIEN") K FDA
"RTN","PSO508PO",47,0)
 Q
"RTN","PSO508PO",48,0)
WSUPD ;
"RTN","PSO508PO",49,0)
 N WSIEN,WSIENS,DIE,DR,DA
"RTN","PSO508PO",50,0)
 S WSIEN=$$FIND1^DIC(18.12,,,"PSO WEB SERVER","B") Q:'WSIEN
"RTN","PSO508PO",51,0)
 ; disable web service
"RTN","PSO508PO",52,0)
 S DIE="^XOB(18.12,",DR=".06///0",DA=WSIEN D ^DIE K DIE,DR,DA
"RTN","PSO508PO",53,0)
 S WSIENS=WSIEN_","
"RTN","PSO508PO",54,0)
 S FDA(18.12,WSIENS,.04)=""
"RTN","PSO508PO",55,0)
 S FDA(18.12,WSIENS,200)=""
"RTN","PSO508PO",56,0)
 S FDA(18.12,WSIENS,300)=""
"RTN","PSO508PO",57,0)
 ; clear server, password, and username fields
"RTN","PSO508PO",58,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSO508PO",59,0)
 Q
"RTN","PSO508PO",60,0)
ERXSTAT ;
"RTN","PSO508PO",61,0)
 ;;IEA^INBOUND ERROR ACKNOWLEDGED
"RTN","PSO508PO",62,0)
 ;;RRN^REFILL REQUEST - NEW
"RTN","PSO508PO",63,0)
 ;;RRX^REFILL REQUEST EXPIRED
"RTN","PSO508PO",64,0)
 ;;RRR^REFILL REQUEST RESPONSE RECEIVED
"RTN","PSO508PO",65,0)
 ;;RRE^REFILL REQUEST ERROR
"RTN","PSO508PO",66,0)
 ;;RRP^REFILL REQUEST PROCESSED
"RTN","PSO508PO",67,0)
 ;;RRF^REFILL REQUEST FAILED
"RTN","PSO508PO",68,0)
 ;;RRC^REFILL REQUEST COMPLETE
"RTN","PSO508PO",69,0)
 ;;RXA^REFILL RESPONSE ACKNOWLEDGED
"RTN","PSO508PO",70,0)
 ;;RXD^REFILL RESPONSE DENIED/DNTF
"RTN","PSO508PO",71,0)
 ;;RXN^REFILL RESPONSE - NEW
"RTN","PSO508PO",72,0)
 ;;RXF^REFILL RESPONSE FAILED
"RTN","PSO508PO",73,0)
 ;;RXP^REFILL RESPONSE PROCESSED
"RTN","PSO508PO",74,0)
 ;;RXC^REFILL RESPONSE COMPLETE
"RTN","PSO508PO",75,0)
 ;;RXW^REFILL RESPONSE WAITING
"RTN","PSO508PO",76,0)
 ;;CAN^ORIGINAL ERX CANCELED IN THE HOLDING QUEUE
"RTN","PSO508PO",77,0)
 ;;CNP^CANCEL RESPONSE PROCESSED
"RTN","PSO508PO",78,0)
 ;;CAO^CANCEL PROCESS COMPLETE
"RTN","PSO508PO",79,0)
 ;;CAH^CANCEL COMPLETED IN HOLDING QUEUE
"RTN","PSO508PO",80,0)
 ;;CAA^CANCEL REQUEST ACKNOWLEDGED
"RTN","PSO508PO",81,0)
 ;;CAR^CANCEL REQUEST RECEIVED
"RTN","PSO508PO",82,0)
 ;;CNE^CANCEL RESPONSE/INBOUND ERROR
"RTN","PSO508PO",83,0)
 ;;CAF^CANCEL PROCESS FAILED
"RTN","PSO508PO",84,0)
 ;;CAP^CANCEL PAPER RX OR FAXED RX
"RTN","PSO508PO",85,0)
 ;;CAX^CANCEL RESPONSE FROM VISTA UNSUCCESSFUL
"RTN","PSO508PO",86,0)
 ;;IRA^INBOUND REFREQ ERROR ACKNOWLEDGED
"RTN","PSO508PO",87,0)
 Q
"RTN","PSO508PO",88,0)
 ; code list qualifiers
"RTN","PSO508PO",89,0)
CLQUAL ;
"RTN","PSO508PO",90,0)
 ;;AA^Patient unknown to the Prescriber
"RTN","PSO508PO",91,0)
 ;;AB^Patient never under Prescriber care
"RTN","PSO508PO",92,0)
 ;;AC^Patient no longer under Prescriber care
"RTN","PSO508PO",93,0)
 ;;AD^Patient has requested refill too soon
"RTN","PSO508PO",94,0)
 ;;AE^Medication never prescribed for the patient
"RTN","PSO508PO",95,0)
 ;;AF^Patient should contact Prescriber first
"RTN","PSO508PO",96,0)
 ;;AG^Refill not appropriate
"RTN","PSO508PO",97,0)
 ;;AH^Patient has picked up prescription
"RTN","PSO508PO",98,0)
 ;;AJ^Patient has picked up partial fill of prescription
"RTN","PSO508PO",99,0)
 ;;AK^Patient has not picked up prescription, drug returned to stock
"RTN","PSO508PO",100,0)
 ;;AL^Change not appropriate
"RTN","PSO508PO",101,0)
 ;;AM^Patient needs appointment
"RTN","PSO508PO",102,0)
 ;;AN^Prescriber not associated with this practice or location.
"RTN","PSO508PO",103,0)
 ;;AO^No attempt will be made to obtain Prior Authorization
"RTN","PSO508PO",104,0)
 ;;AP^Request already responded to by other means (e.g. phone or fax)
"RTN","PSO508PO",105,0)
 ;;AQ^More Medication History Available
"RTN","PSO508PO",106,0)
 Q
"RTN","PSOCAN")
0^22^B55445842^B53171969
"RTN","PSOCAN",1,0)
PSOCAN ;BIR/JMB - Rx discontinue and reinstate ;8/3/06 12:38pm
"RTN","PSOCAN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,21,24,27,32,37,88,117,131,185,253,251,375,379,390,413,372,416,508**;DEC 1997;Build 295
"RTN","PSOCAN",3,0)
 ;External reference to File #55 supported by DBIA 2228
"RTN","PSOCAN",4,0)
 ;External references L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOCAN",5,0)
START N PSOODOSP,PSOREINF,PSOONOFC S WARN=0,(DAYS360,SPCANC)=1 D KCAN1^PSOCAN3 W !! S DIR("A")="Discontinue/Reinstate by Rx# or patient name",DIR(0)="SBO^R:RX NUMBER;P:PATIENT NAME"
"RTN","PSOCAN",6,0)
 S DIR("?")="Enter 'R' to discontinue/reinstate by Rx#.  Enter 'P' to discontinue/reinstate by patient name." D ^DIR K DIR
"RTN","PSOCAN",7,0)
 G:$G(DIRUT) KILL^PSOCAN1 K RP S RP=Y G:RP="P" PAT^PSOCAN1
"RTN","PSOCAN",8,0)
NUM D DCORD^PSONEW2
"RTN","PSOCAN",9,0)
 K PSOTECCK,RXSP,PSINV,PSOWUN,PSOULRX D KCAN1^PSOCAN3 S:'$D(PSOCLC) PSOCLC=DUZ S PS="Discontinue" W ! S DIR("A")="Discontinue/Reinstate Prescription(s)#"
"RTN","PSOCAN",10,0)
 S DIR(0)="FO^1:245",DIR("?")="Wand/enter barcode or enter Rx number(s) to discontinued/reinstated. If more than one, separate with commas. Do not exceed 245 characters including commas"
"RTN","PSOCAN",11,0)
 D ^DIR K DIR G:$G(DIRUT) START S OUT=0 I Y["-" D PSOINST^PSOSUPAT G:OUT NUM S (IN,X)=$P(^PSRX($P(Y,"-",2),0),"^") G NO
"RTN","PSOCAN",12,0)
 S IN=Y G RX:Y[","
"RTN","PSOCAN",13,0)
NO I '$O(^PSRX("B",Y,0)) W " Rx Not Found!",! G NUM
"RTN","PSOCAN",14,0)
 S PSPOP=0,DIC=52,DIC(0)="QEMZ" D ^DIC K DIC Q:$G(POERR)&(Y<0)
"RTN","PSOCAN",15,0)
 G:Y<0 NUM S (DA,IFN,PSOULRX)=+Y,RXNUM=Y(0,0),PSODFN=+$P(^PSRX(DA,0),"^",2) I PSODFN'=$G(PSOODOSP) K PSORX("DOSING OFF"),PSOREINF S PSOODOSP=PSODFN
"RTN","PSOCAN",16,0)
 S PSOWUN=1 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY K PSOPLCK G NUM
"RTN","PSOCAN",17,0)
 K PSOPLCK D PSOL^PSSLOCK(IFN) I '$G(PSOMSG) W !!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order.") K PSOMSG D ULP G NUM
"RTN","PSOCAN",18,0)
 I $P($G(^PSRX(+$G(IFN),"STA")),"^")=12,$P($G(^("PKI")),"^") W !!,"Cannot be Reinstated - Digitally Signed" D ULP G NUM
"RTN","PSOCAN",19,0)
 I $P($G(^PSRX(+$G(IFN),"STA")),"^")=12 S PSOCANRZ=1
"RTN","PSOCAN",20,0)
 E  S PSOCANRD=+$P($G(^PSRX(+$G(IFN),0)),"^",4)
"RTN","PSOCAN",21,0)
 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN)
"RTN","PSOCAN",22,0)
LMNO D CHK S:'$G(DA)&($G(IFN)) DA=IFN
"RTN","PSOCAN",23,0)
 I DEAD S PSINV($P(^PSRX(DA,0),"^"))="" D:$G(PSOWUN) ULP,ULRX G EP1
"RTN","PSOCAN",24,0)
 I $P(^PSRX(DA,"STA"),"^")'<13,$P(^("STA"),"^")'=16 S PSINV($P(^PSRX(DA,0),"^"))="" D:$G(PSOWUN) ULP,ULRX G EP1
"RTN","PSOCAN",25,0)
 I $G(PSODIV),$P($G(^PSRX(DA,2)),"^",9),$P(^(2),"^",9)'=$G(PSOSITE) S RXREC=DA D DIV D:$G(POERR)&(PSPOP) ULP,ULRX Q:$G(POERR)&(PSPOP)  D:$G(PSOWUN)&($G(PSPOP)) ULP,ULRX G:PSPOP NUM
"RTN","PSOCAN",26,0)
 D ICN^PSODPT(PSODFN)
"RTN","PSOCAN",27,0)
 N PSTS S PSTS=$S($P(^PSRX(DA,"STA"),"^")=12:1,$P(^PSRX(DA,"STA"),"^")=14:1,$P(^PSRX(DA,"STA"),"^")=15:1,1:0)
"RTN","PSOCAN",28,0)
 S PS=$S($G(PSTS):"Reinstate",1:"Discontinue")
"RTN","PSOCAN",29,0)
 ;S PS=$S($P(^PSRX(DA,"STA"),"^")=12:"Reinstate",1:"Discontinue")
"RTN","PSOCAN",30,0)
 I '$G(POERR) N PKIR D
"RTN","PSOCAN",31,0)
 .I $P(^PSRX(DA,"STA"),"^")=1,$P($G(^("PKI")),"^") S PKIR=""
"RTN","PSOCAN",32,0)
 .D ^PSORXPR
"RTN","PSOCAN",33,0)
 D YN S:PS="Reinstate" PS="Discontinue" Q:$G(POERR)&('%)
"RTN","PSOCAN",34,0)
 I '% D ULP,ULRX G NUM
"RTN","PSOCAN",35,0)
 D REA D:'$D(REA)&($G(PSOWUN)) ULP,ULRX Q:'$D(REA)
"RTN","PSOCAN",36,0)
 D COM^PSOCAN1 Q:$G(POERR)&('$D(INCOM))!($D(DIRUT))  I '$D(INCOM)!($D(DIRUT)) D ULP,ULRX G NUM
"RTN","PSOCAN",37,0)
 S RX=$P(^PSRX(DA,0),"^"),PSCAN(RX)=DA_"^"_REA
"RTN","PSOCAN",38,0)
 D:REA="R" REINS^PSOCAN2 Q:$G(PSOQUIT)&($G(PSOREINS))
"RTN","PSOCAN",39,0)
 I REA="R",'$G(PSORX("DFLG")) D DCORD^PSONEW2
"RTN","PSOCAN",40,0)
 K PSOTECCK
"RTN","PSOCAN",41,0)
 D:$G(PSORX("DFLG")) ULP,ULRX
"RTN","PSOCAN",42,0)
 Q:$G(POERR)&($G(PSORX("DFLG")))
"RTN","PSOCAN",43,0)
 G NUM:$G(PSORX("DFLG"))
"RTN","PSOCAN",44,0)
 D:REA="C" CAN
"RTN","PSOCAN",45,0)
 Q:$G(POERR)
"RTN","PSOCAN",46,0)
 D ULP,ULRX G NUM
"RTN","PSOCAN",47,0)
YN D EN^PSOCMOPA I $G(XFLAG)]"" S %=0 K XFLAG Q
"RTN","PSOCAN",48,0)
 ; PSO*7*508 - if this is an eRx auto DC, set the flag to prevent prompt and quit
"RTN","PSOCAN",49,0)
 I $G(ERXDCIEN) S %=1 Q
"RTN","PSOCAN",50,0)
 W ! S DIR("A")="Are you sure you want to "_PS,DIR(0)="Y",DIR("B")="NO" D ^DIR S %=Y K DIR,DUOUT,DTOUT I 'Y!$D(DIRUT) S VALMBCK="R"
"RTN","PSOCAN",51,0)
 K DIRUT Q
"RTN","PSOCAN",52,0)
REA ;
"RTN","PSOCAN",53,0)
 ;PSO*7*508 - if this is an eRx, we are cancelling only. Set REA and quit
"RTN","PSOCAN",54,0)
 I $G(ERXDCIEN) D  Q
"RTN","PSOCAN",55,0)
 .I +$P(^PSRX(DA,"STA"),U)=12 Q
"RTN","PSOCAN",56,0)
 .S REA="C"
"RTN","PSOCAN",57,0)
 S REA=+$P(^PSRX(DA,"STA"),"^") I REA=12 S REA="R" Q
"RTN","PSOCAN",58,0)
 I REA,REA'=11 W !?5,$C(7) D
"RTN","PSOCAN",59,0)
 .W "Rx# "_RXNUM_" was"_$S(REA=1:" Non-Verified",REA=13:" Deleted",REA=11:" Expired",REA=5:" Suspended",REA=4:" Pending Due to Drug Interactions",REA=3:" On Hold",REA=14!(REA=15):" Discontinued",REA=16:" Provider Held",1:" In Fill Status")_"."
"RTN","PSOCAN",60,0)
 I REA,REA'=1,REA'=3,REA'=5,REA'=11,REA'<13,REA'=16 D  Q
"RTN","PSOCAN",61,0)
 .K REA W !?10,"Rx Cannot Be Discontinued/Reinstated!" H 2
"RTN","PSOCAN",62,0)
 .S VALMSG="Rx# "_RXNUM_" Cannot Be "_$S($G(PSTS):"Reinstated",1:"Discontinued")_"."
"RTN","PSOCAN",63,0)
 S REA="C" Q
"RTN","PSOCAN",64,0)
CAN N PSODRUG D CAN1^PSOCAN3 Q
"RTN","PSOCAN",65,0)
DIV I '$P($G(PSOSYS),"^",2) W !?10,$C(7),"RX# ",$P(^PSRX(DA,0),"^")," is not a valid choice.  (Different Division)" S PSPOP=1 Q
"RTN","PSOCAN",66,0)
 I $P($G(PSOSYS),"^",3) W !?10,$C(7) S DIR("A")="RX# "_$P(^PSRX(DA,0),"^")_" is from another division.  Continue",DIR(0)="Y",DIR("B")="Y" D ^DIR K DIR S:$G(DIRUT)!('Y) PSPOP=1
"RTN","PSOCAN",67,0)
 Q
"RTN","PSOCAN",68,0)
CHK K VADM,DEAD S DFN=PSODFN D DEM^VADPT I $G(VADM(6))="" S DEAD=0 Q
"RTN","PSOCAN",69,0)
 S (PSODEATH,DEAD)=1 W !!,?10,VADM(1)_" DIED "_$P($G(VADM(6)),"^",2) D CAN^PSOCAN3 K PSODEATH
"RTN","PSOCAN",70,0)
 Q
"RTN","PSOCAN",71,0)
RX N PKI S RXCNT=0,RXSP=1 D TESTRP D COM^PSOCAN1 G:'$D(INCOM)!($D(DIRUT)) NUM K PSINV,PSCAN F II=1:1 S (EN,X)=$P(IN,",",II) Q:$P(IN,",",II)']""  S DIC=52,DIC(0)="QMZ" D ^DIC K DIC S:Y'>0 PSINV(X)="" D:Y>0
"RTN","PSOCAN",72,0)
 .S YY=Y,YY(0,0)=Y(0,0),(PSODFN,DFN)=$P(Y(0),"^",2) D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN)
"RTN","PSOCAN",73,0)
 .D:$G(DFN)>0 CHK I DEAD!($P(^PSRX(+YY,"STA"),"^")=13)!($P(^("STA"),"^")=14) S PSINV(EN)="" Q
"RTN","PSOCAN",74,0)
 .I $P(^PSRX(+YY,"STA"),"^")=12,$P($G(^("PKI")),"^") S PKI=1,PSINV(EN)="" Q
"RTN","PSOCAN",75,0)
 .S DA=+YY I $P($G(^PSRX(DA,"STA")),"^")=11!($P($G(^(2)),"^",6)<DT) D EXP
"RTN","PSOCAN",76,0)
 .S RX=YY(0,0) D:$D(^PSRX(DA,0)) SPEED1^PSOCAN1
"RTN","PSOCAN",77,0)
 .;S DA=+YY I $P($G(^PSRX(DA,"STA")),"^")=11!($P($G(^(2)),"^",6)<DT) D EXP Q
"RTN","PSOCAN",78,0)
 .;E  S RX=YY(0,0) D:$D(^PSRX(DA,0)) SPEED1^PSOCAN1
"RTN","PSOCAN",79,0)
 K YY G:'$D(PSCAN) INVALD^PSOCAN1 S RX="",RXCNT=0 F  S RX=$O(PSCAN(RX)) Q:RX=""  S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2),RXCNT=RXCNT+1  D SHOW^PSOCAN1
"RTN","PSOCAN",80,0)
ASK Q:'$D(PSCAN)  W ! S DIR("A")="OK to "_$S($G(RXCNT)>1:"Change Status",REA="C":"Discontinued",1:"Reinstate"),DIR(0)="Y",DIR("B")="N"
"RTN","PSOCAN",81,0)
 N PSOCNRXV S PSOCNRXV=0
"RTN","PSOCAN",82,0)
 D ^DIR K DIR Q:$G(DIRUT)  I 'Y K PSCAN D INVALD^PSOCAN1 G NUM
"RTN","PSOCAN",83,0)
 K PSOPLCKZ S RX="" F  S RX=$O(PSCAN(RX)) Q:'RX  D
"RTN","PSOCAN",84,0)
 .S PSODFN=+$P($G(^PSRX(+PSCAN(RX),0)),"^",2)
"RTN","PSOCAN",85,0)
 .S PSOPLCK=$$L^PSSLOCK(+$G(PSODFN),0) D:'$G(PSOPLCK)&('$D(PSOPLCKZ(PSODFN))) LOCK^PSOORCPY I '$G(PSOPLCK) S PSOPLCKZ(PSODFN)=PSODFN Q
"RTN","PSOCAN",86,0)
 .D PSOL^PSSLOCK(+PSCAN(RX)) I '$G(PSOMSG) D  D UL^PSSLOCK(PSODFN) Q
"RTN","PSOCAN",87,0)
 ..I $P($G(PSOMSG),"^",2)'="" W !,$P($G(PSOMSG),"^",2),!,"Order "_$P($G(^PSRX(+PSCAN(RX),0)),"^")_"." Q
"RTN","PSOCAN",88,0)
 ..W !,"Another person is editing order "_$P($G(^PSRX(+PSCAN(RX),0)),"^")_"."
"RTN","PSOCAN",89,0)
 .D ACT D PSOUL^PSSLOCK(+PSCAN(RX)),UL^PSSLOCK(PSODFN)
"RTN","PSOCAN",90,0)
 .S PSOCNRXV=1
"RTN","PSOCAN",91,0)
 K PSOPLCKZ W:$G(PSOCNRXV) !,$S($G(RXCNT)>1:"Statuses Changed",REA="C":"Prescription Discontinued",1:"Prescription Reinstated") D INVALD^PSOCAN1 G NUM
"RTN","PSOCAN",92,0)
ACT S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2),II=RX,PSODFN=$P(^PSRX(DA,0),"^",2) I REA="R" D REINS^PSOCAN2 Q
"RTN","PSOCAN",93,0)
 D CAN Q
"RTN","PSOCAN",94,0)
EXP ;S PSINV($P(^PSRX(DA,0),"^"))="" 
"RTN","PSOCAN",95,0)
 Q:$P(^PSRX(DA,"STA"),"^")=12
"RTN","PSOCAN",96,0)
 S $P(^PSRX(DA,"STA"),"^")=11 D ECAN^PSOUTL(DA)
"RTN","PSOCAN",97,0)
 S STAT="SC",PHARMST="ZE",COMM="Medication Expired on "_$E($P(^PSRX(DA,2),"^",6),4,5)_"/"_$E($P(^(2),"^",6),6,7)_"/"_$E($P(^(2),"^",6),2,3) D EN^PSOHLSN1(DA,STAT,PHARMST,COMM) K COMM,STAT,PHARMST
"RTN","PSOCAN",98,0)
EP1 I '$G(RXSP) D INVALD^PSOCAN1 Q:$G(POERR)  G NUM
"RTN","PSOCAN",99,0)
 Q
"RTN","PSOCAN",100,0)
PSD ;Called from Controlled Subs, PSDRX is internal Rx number
"RTN","PSOCAN",101,0)
 S PSDRFDEL=0
"RTN","PSOCAN",102,0)
 I '$G(PSDRX)!('$D(^PSRX(+$G(PSDRX),0))) Q
"RTN","PSOCAN",103,0)
 I $P($G(^PSRX(PSDRX,"STA")),"^")<12 Q
"RTN","PSOCAN",104,0)
 N DA,NODE,RF,PSOPSDAL,PSODRX,PSODTE,PSODL,SFN,RIFN,PSOSXP,PSOFILDL
"RTN","PSOCAN",105,0)
 S PSODRX=0 F PSODLP=0:0 S PSODLP=$O(^PSRX(PSDRX,1,PSODLP)) Q:'PSODLP  S:$D(^PSRX(PSDRX,1,PSODLP,0)) PSODRX=PSODLP
"RTN","PSOCAN",106,0)
 I 'PSODRX Q
"RTN","PSOCAN",107,0)
 I $P($G(^PSRX(PSDRX,1,PSODRX,0)),"^",18) Q
"RTN","PSOCAN",108,0)
 D PSDREF I $G(PSOFILDL) K PSOFILDL Q
"RTN","PSOCAN",109,0)
 K PSOFILDL,DIE S NODE=0,PSOPSDAL=1,DA(1)=PSDRX,DA=PSODRX,DIE="^PSRX("_DA(1)_",1,",DR=".01///@" D ^DIE K DIE
"RTN","PSOCAN",110,0)
 S PSDRFDEL=1
"RTN","PSOCAN",111,0)
 Q
"RTN","PSOCAN",112,0)
PSDREF ;
"RTN","PSOCAN",113,0)
 N PRDL,PSOCNODE
"RTN","PSOCAN",114,0)
 S PSOFILDL=0
"RTN","PSOCAN",115,0)
 F PRDL=0:0 S PRDL=$O(^PSRX(PSDRX,4,PRDL)) Q:'PRDL  I $G(PSODRX)=$P($G(^PSRX(PSDRX,4,PRDL,0)),"^",3) S PSOCNODE=$G(^(0))
"RTN","PSOCAN",116,0)
 I $G(PSOCNODE)="" Q
"RTN","PSOCAN",117,0)
 I +$P(PSOCNODE,"^",4)<3 S PSOFILDL=1
"RTN","PSOCAN",118,0)
 Q
"RTN","PSOCAN",119,0)
TESTRP ;
"RTN","PSOCAN",120,0)
 N PIIN,PIINFLAG S PIINFLAG=0 F PIIN=1:1 S X=$P(IN,",",PIIN) Q:$P(IN,",",PIIN)']""  K DIC S DIC=52,DIC(0)="QMZ" D ^DIC K DIC I +$G(Y) D
"RTN","PSOCAN",121,0)
 .I $P($G(^PSRX(+Y,"STA")),"^")'=12,'$G(PIINFLAG) S PSOCANRD=+$P($G(^PSRX(+Y,0)),"^",4) S PIINFLAG=1
"RTN","PSOCAN",122,0)
 I '$G(PIINFLAG) S PSOCANRZ=1
"RTN","PSOCAN",123,0)
 Q
"RTN","PSOCAN",124,0)
ULP ;
"RTN","PSOCAN",125,0)
 D UL^PSSLOCK(+$G(PSODFN))
"RTN","PSOCAN",126,0)
 Q
"RTN","PSOCAN",127,0)
ULRX ;
"RTN","PSOCAN",128,0)
 I $G(PSOULRX) D PSOUL^PSSLOCK(PSOULRX)
"RTN","PSOCAN",129,0)
 Q
"RTN","PSOCAN1")
0^23^B63054494^B60678355
"RTN","PSOCAN1",1,0)
PSOCAN1 ;BIR/BHW - modular rx cancel with speed cancel ability ;2/22/93
"RTN","PSOCAN1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**8,20,24,27,32,131,163,185,238,372,442,508**;DEC 1997;Build 295
"RTN","PSOCAN1",3,0)
 ;External reference to File #55 supported by DBIA 2228
"RTN","PSOCAN1",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOCAN1",5,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSOCAN1",6,0)
 ;External references L, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOCAN1",7,0)
 ;
"RTN","PSOCAN1",8,0)
PAT S RXCNT=0 K X,PSODFN,ASKED,BC,DELCNT,WARN W ! S DIR("A")="Are you entering the patient name or barcode",DIR(0)="SBO^P:Patient Name;B:Barcode"
"RTN","PSOCAN1",9,0)
 S DIR("?")="Enter a P if you are going to enter the patient name.  Enter a B if you are going to enter or wand the barcode."
"RTN","PSOCAN1",10,0)
 D ^DIR K DIR G:$D(DIRUT) ^PSOCAN S BC=Y
"RTN","PSOCAN1",11,0)
BC D KCAN1^PSOCAN3 S OUT=0 I BC="B" W ! S DIR("A")="Enter/wand barcode",DIR(0)="FO^5:20",DIR("?")="Enter the barcode number or wand the barcode to discontinue all prescriptions for one patient" D ^DIR K DIR G:$G(DIRUT) PAT S BCNUM=Y D
"RTN","PSOCAN1",12,0)
 .D PSOINST^PSOSUPAT Q:OUT  S RX=$P(BCNUM,"-",2) D:$D(^PSRX(RX,0))
"RTN","PSOCAN1",13,0)
 ..S PSODFN=$P(^PSRX(RX,0),"^",2) W " ",$P($G(^DPT(PSODFN,0)),"^")
"RTN","PSOCAN1",14,0)
 ..D ICN^PSODPT(PSODFN)
"RTN","PSOCAN1",15,0)
 .I '$D(^PSRX(RX,0)) W !,$C(7),"No Prescription record for this barcode." S OUT=1
"RTN","PSOCAN1",16,0)
 G:OUT BC
"RTN","PSOCAN1",17,0)
NAM D KCAN^PSOCAN3 S PSOCANRA=1 I BC="P" W ! S DIC(0)="AEMZQ",DIC="^DPT(" D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT))!(Y<0) PAT S PSODFN=+Y S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSOCAN1",18,0)
 I PSODFN'=$G(PSOODOSP) K PSORX("DOSING OFF"),PSOREINF S PSOODOSP=PSODFN
"RTN","PSOCAN1",19,0)
 I $G(PSOREINF)!($G(PSORX("DOSING INFO"))) S PSOONOFO=1
"RTN","PSOCAN1",20,0)
 N PSONEW,PSORX S PSFROM="N" D CHK^PSOCAN G:DEAD NAM K PSOSD D ^PSOBUILD S PSOOPT=-1 D ^PSODSPL G:'$D(PSOSD) NAM
"RTN","PSOCAN1",21,0)
 D ONOFF
"RTN","PSOCAN1",22,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY K PSOPLCK G PAT
"RTN","PSOCAN1",23,0)
 W ! S DIR("A")="Discontinue all or specific Rx#'s?",DIR(0)="SBO^A:ALL Rx's;S:SPECIFIC Rx's"
"RTN","PSOCAN1",24,0)
 S DIR("?")="Enter the letter A for all listed Rx's OR the letter for specific Rx's." D ^DIR K DIR I $D(DIRUT) D ULP^PSOCAN G PAT
"RTN","PSOCAN1",25,0)
 S ALL=Y G:Y="S" LINE D RTESTA D COM I '$D(INCOM)!($D(DIRUT)) D ULP^PSOCAN G NAM
"RTN","PSOCAN1",26,0)
 K PSOSDX,PSOSDXY,PENCAN,PSOCANPN S SPEED=1,(DRG,DRUG,IN,STA)="",II=0 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DRUG=$O(PSOSD(STA,DRUG)) Q:DRUG=""  S II=II+1,DRG=DRUG D
"RTN","PSOCAN1",27,0)
 .I STA="PENDING" S DA=$P(PSOSD(STA,DRG),"^",10) S PSOSDX(DA)="" Q
"RTN","PSOCAN1",28,0)
 .;PSO*7*238
"RTN","PSOCAN1",29,0)
 .I STA="ZNONVA" D  Q
"RTN","PSOCAN1",30,0)
 ..D NOW^%DTC
"RTN","PSOCAN1",31,0)
 ..N TMP
"RTN","PSOCAN1",32,0)
 ..S TMP(55.05,PSOOI_","_PSODFN_",",5)=1
"RTN","PSOCAN1",33,0)
 ..S TMP(55.05,PSOOI_","_PSODFN_",",6)=%
"RTN","PSOCAN1",34,0)
 ..D FILE^DIE("","TMP")
"RTN","PSOCAN1",35,0)
 .S PSOCANPN=1
"RTN","PSOCAN1",36,0)
 .D PSPEED
"RTN","PSOCAN1",37,0)
 K SPEED D ASK D:$G(REA)="C"&('$G(PSOSDXY))&($O(PSOSDX(0)))&($G(PSOCANPN))  D:'$G(PSOCANPN)  K PSOCANPN,PSOSDX,PSOSDXY,PENCAN D ULP^PSOCAN G PAT
"RTN","PSOCAN1",38,0)
 .S PENCAN="" F  S PENCAN=$O(PSOSDX(PENCAN)) Q:'PENCAN  S DA=PENCAN D PSOL^PSSLOCK(DA_"S") I $G(PSOMSG) D PEN,PSOUL^PSSLOCK(DA_"S")
"RTN","PSOCAN1",39,0)
LINE W !! S DIR(0)="LO^1:"_$S($G(PSOHI):PSOHI,1:PSOSD),DIR("A")="ENTER THE LINE #",DIR("?",1)="Enter the line number(s) displayed to the left of the Rx#."
"RTN","PSOCAN1",40,0)
 S DIR("?",2)="   Separate the numbers with commas (Example: 3,8,10,7),",DIR("?",3)="   OR a dash (Example: 12-20), OR a combination of commas and",DIR("?",4)="   dashes (Example: 3-5,1,12)."
"RTN","PSOCAN1",41,0)
 S DIR("?")="Do not exceed 245 characters including commas and dashes." D ^DIR K DIR D:$D(DIRUT) ULP^PSOCAN G:$G(DIRUT) KILL I Y["." W !?53,$C(7),"INVALID LINE NUMBER(S)." G LINE
"RTN","PSOCAN1",42,0)
 S LINE=Y K PSCAN,PSOCAN S (DRG,IN,STA)="",CNT=0
"RTN","PSOCAN1",43,0)
 F  S STA=$O(PSOSD(STA))  Q:STA=""  F  S DRG=$O(PSOSD(STA,DRG)) Q:DRG=""  S CNT=CNT+1,PSOCAN(CNT)=$S(STA'="PENDING":$P(PSOSD(STA,DRG),"^"),1:$P(PSOSD(STA,DRG),"^",10)_"^P")
"RTN","PSOCAN1",44,0)
 F CNT=1:1 S PLINE=$P(LINE,",",CNT) Q:'$P(LINE,",",CNT)  S IN=$S(IN="":PSOCAN(PLINE),1:IN_","_PSOCAN(PLINE))
"RTN","PSOCAN1",45,0)
 D RTEST D SPEED D ULP^PSOCAN G:BC="P" NAM G:BC="B" BC
"RTN","PSOCAN1",46,0)
PSPEED S (YY,DA)=$P(PSOSD(STA,DRG),"^"),RX=$P($G(^PSRX(DA,0)),"^") D SPEED1 Q:PSPOP!($D(PSINV(RX)))
"RTN","PSOCAN1",47,0)
 Q:$G(SPEED)&(REA="R")
"RTN","PSOCAN1",48,0)
SHOW S DRG=+$P(^PSRX(DA,0),"^",6),DRG=$S($D(^PSDRUG(DRG,0)):$P(^(0),"^"),1:"")
"RTN","PSOCAN1",49,0)
PSHOW S LC=0 W !,$P(^PSRX(DA,0),"^"),"  ",DRG,?52,$S($D(^DPT(+$P(^PSRX(DA,0),"^",2),0)):$P(^(0),"^"),1:"PATIENT UNKNOWN")
"RTN","PSOCAN1",50,0)
 I REA="C" W !?25,"Rx to be Discontinued",! G SHOW1
"RTN","PSOCAN1",51,0)
 W !?21,"*** Rx to be Reinstated ***",!
"RTN","PSOCAN1",52,0)
SHOW1 ;S LC=LC+3 I LC>20 R !,"Press return to continue",X:DTIME G:X'="" SHOW1 S LC=0
"RTN","PSOCAN1",53,0)
 I $Y+4>IOSL K DIR,DUOUT,DTOUT,DIRUT S DIR(0)="E",DIR("A")="Press Return to Continue",DIR("?")="Press Return to continue Listing Orders" D ^DIR K DIR,DTOUT,DIRUT,DUOUT W @IOF
"RTN","PSOCAN1",54,0)
 Q
"RTN","PSOCAN1",55,0)
SPEED1 S PSPOP=0 I $G(PSODIV),+$P($G(^PSRX(DA,2)),"^",9)'=$G(PSOSITE) D:'$G(SPEED) DIV^PSOCAN
"RTN","PSOCAN1",56,0)
 K STAT S STAT=+$P(^PSRX(DA,"STA"),"^"),REA=$E("C00CCCCCCCCCR000C",STAT+1)
"RTN","PSOCAN1",57,0)
 Q:$G(SPEED)&(REA="R")
"RTN","PSOCAN1",58,0)
 I REA="R",$P($G(^PSRX(DA,"PKI")),"^") S PKI=1 S PSINV(RX)="" Q
"RTN","PSOCAN1",59,0)
 I REA=0!(PSPOP)!($P(^PSRX(+YY,"STA"),"^")>12),$P(^("STA"),"^")<16 S PSINV(RX)="" Q
"RTN","PSOCAN1",60,0)
 S:REA'=0&('PSPOP) PSCAN(RX)=DA_"^"_REA,RXCNT=$G(RXCNT)+1
"RTN","PSOCAN1",61,0)
 Q
"RTN","PSOCAN1",62,0)
AREC S:'$G(DEAD) REA=$S($G(REA)="L":"L",1:$P(PSCAN($P(^PSRX(DA,0),"^")),"^",2)) S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOCAN1",63,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOCAN1",64,0)
 D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_(ACNT+1)_"^"_(ACNT+1) S ^PSRX(DA,"A",ACNT+1,0)=%_"^"_REA_"^"_DUZ_"^"_RFCNT_"^"_$S($G(MSG)]"":MSG,1:$G(ACOM)_$G(INCOM)) S ACOM=""
"RTN","PSOCAN1",65,0)
 I $D(PKIR) N J S J=ACNT+2 D ADR^PSOPKIV1
"RTN","PSOCAN1",66,0)
 D EXP^PSOHELP1
"RTN","PSOCAN1",67,0)
 Q
"RTN","PSOCAN1",68,0)
SPEED D COM Q:'$D(INCOM)!($D(DIRUT))  N PKI K PSINV,PSCAN F II=1:1 S DA=$P(IN,",",II) Q:'$P(IN,",",II)  D
"RTN","PSOCAN1",69,0)
 .I $P(DA,"^",2)="P" S DA=+DA D  Q
"RTN","PSOCAN1",70,0)
 ..D PSOL^PSSLOCK(DA_"S") I $G(PSOMSG) D PEN D PSOUL^PSSLOCK(DA_"S")
"RTN","PSOCAN1",71,0)
 .I $D(^PSRX(DA,0)) S YY=DA,RX=$P(^(0),"^") S:DA<0 PSINV(RX)="" D:DA>0 SPEED1
"RTN","PSOCAN1",72,0)
 G:'$D(PSCAN) INVALD S II="",RXCNT=0 F  S II=$O(PSCAN(II)) Q:II=""  S DA=+PSCAN(II),REA=$P(PSCAN(II),"^",2),RXCNT=RXCNT+1  D SHOW
"RTN","PSOCAN1",73,0)
 ;
"RTN","PSOCAN1",74,0)
ASK G:'$D(PSCAN) INVALD W ! S DIR("A")="OK to "_$S($G(RXCNT)>1:"Change Status",REA="C":"Discontinue",1:"Reinstate"),DIR(0)="Y",DIR("B")="N" D ^DIR K DIR I $D(DIRUT) S:$O(PSOSDX(0)) PSOSDXY=1 Q
"RTN","PSOCAN1",75,0)
 I 'Y S:$O(PSOSDX(0)) PSOSDXY=1 K PSCAN D INVALD Q
"RTN","PSOCAN1",76,0)
 S RX="" F  S RX=$O(PSCAN(RX)) Q:RX=""  D PSOL^PSSLOCK(+PSCAN(RX)) I $G(PSOMSG) D ACT D PSOUL^PSSLOCK(+PSCAN(RX))
"RTN","PSOCAN1",77,0)
 D INVALD Q
"RTN","PSOCAN1",78,0)
ACT S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2),II=RX,PSODFN=$P(^PSRX(DA,0),"^",2) I REA="R" D REINS^PSOCAN2 I '$G(PSORX("DFLG")) D DCORD^PSONEW2 Q  ;*442
"RTN","PSOCAN1",79,0)
 D CAN^PSOCAN Q
"RTN","PSOCAN1",80,0)
INVALD K PSCAN Q:'$D(PSINV)  W !! F I=1:1:80 W "="
"RTN","PSOCAN1",81,0)
 W $C(7),!!,"The Following Rx Number(s) Are Invalid Choices, Expired, "_$S($G(PKI):"Digitally Signed",1:""),!,"Discontinued by Provider, or Marked As Deleted:" S II="" F  S II=$O(PSINV(II)) Q:II=""  W !?10,II
"RTN","PSOCAN1",82,0)
 K PSINV I $G(PSOERR)!($G(SPEED)) K DIR,DUOUT,DTOUT,DIRUT S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DTOUT,DIRUT,DUOUT
"RTN","PSOCAN1",83,0)
 G KILL Q
"RTN","PSOCAN1",84,0)
LISTPAT S X="?",DIC(0)="EMQ",DIC="^DPT(" D ^DIC K DIC Q
"RTN","PSOCAN1",85,0)
 ;
"RTN","PSOCAN1",86,0)
COM ; 
"RTN","PSOCAN1",87,0)
 ; PSO*7*508 - if this is an eRx, set the comments and nature of order and quit - no user interaction
"RTN","PSOCAN1",88,0)
 I $G(ERXDCIEN) D  Q
"RTN","PSOCAN1",89,0)
 .S INCOM=$$GET1^DIQ(52.49,ERXDCIEN,52.2,"E")
"RTN","PSOCAN1",90,0)
 .I INCOM']"" S INCOM="eRx discontinued by external prescriber"
"RTN","PSOCAN1",91,0)
 .; set nature of order to 'auto'
"RTN","PSOCAN1",92,0)
 .S PSOONOR="A"
"RTN","PSOCAN1",93,0)
 ; PSO*7*505 - end changes
"RTN","PSOCAN1",94,0)
 W !
"RTN","PSOCAN1",95,0)
 K MSG  ;Added to prevent INCOM from being superseded in AREC tag if DC comments entered.
"RTN","PSOCAN1",96,0)
 S DIR("A")="Comments"_$S($D(PKIR):"/Reason for DCing",1:""),DIR(0)="F^5:75"
"RTN","PSOCAN1",97,0)
 S DIR("?")="Comments must be entered.  Comments must be 5 to 75 characters and must not contain embedded uparrow"
"RTN","PSOCAN1",98,0)
 S:$D(INCOM) DIR("B")=INCOM
"RTN","PSOCAN1",99,0)
 D ^DIR I $D(DIRUT) K DIR,DTOUT,DUOUT,Y Q
"RTN","PSOCAN1",100,0)
 S INCOM=Y S:$D(PKIR) PKIR=Y K DIR,DTOUT,DIRUT,DUOUT
"RTN","PSOCAN1",101,0)
 D NOOR^PSOCAN4
"RTN","PSOCAN1",102,0)
 Q
"RTN","PSOCAN1",103,0)
KILL D KILL^PSOCAN2
"RTN","PSOCAN1",104,0)
 K PSOMSG,PSOPLCK,PSOWUN,PSOULRX
"RTN","PSOCAN1",105,0)
 Q
"RTN","PSOCAN1",106,0)
PEN ;discontinue pending orders
"RTN","PSOCAN1",107,0)
 S PSODAPND=DA
"RTN","PSOCAN1",108,0)
 K ^PS(52.41,"AOR",$P(^PS(52.41,DA,0),"^",2),+$P($G(^PS(52.41,DA,"INI")),"^"),DA) S $P(^PS(52.41,DA,0),"^",3)="DC",^PS(52.41,DA,4)=INCOM_" Discontinued by Pharmacy."
"RTN","PSOCAN1",109,0)
 D EN^PSOHLSN(+^PS(52.41,DA,0),"OC",INCOM,PSONOOR)
"RTN","PSOCAN1",110,0)
 S DA=PSODAPND K PSODAPND
"RTN","PSOCAN1",111,0)
 Q
"RTN","PSOCAN1",112,0)
RTEST ;
"RTN","PSOCAN1",113,0)
 Q:'$G(LINE)
"RTN","PSOCAN1",114,0)
 N PCIN,PCINFLAG,PCINX
"RTN","PSOCAN1",115,0)
 S PCINFLAG=0 F PCIN=1:1 S PCINX=$P(LINE,",",PCIN) Q:$P(LINE,",",PCIN)']""  D
"RTN","PSOCAN1",116,0)
 .Q:'$G(PCINX)
"RTN","PSOCAN1",117,0)
 .Q:'$G(PSOCAN(PCINX))
"RTN","PSOCAN1",118,0)
 .I PSOCAN(PCINX)'["^P" I $P($G(^PSRX(+$G(PSOCAN(PCINX)),"STA")),"^")'=12,'$G(PCINFLAG) S PSOCANRD=+$P($G(^PSRX($G(PSOCAN(PCINX)),0)),"^",4) S PCINFLAG=1
"RTN","PSOCAN1",119,0)
 .I PSOCAN(PCINX)["^P",'$G(PCINFLAG) S PSOCANRD=+$P($G(^PS(52.41,+$P(PSOCAN(PCINX),"^"),0)),"^",5) S PCINFLAG=1
"RTN","PSOCAN1",120,0)
 I '$G(PCINFLAG) S PSOCANRZ=1
"RTN","PSOCAN1",121,0)
 Q
"RTN","PSOCAN1",122,0)
RTESTA ;
"RTN","PSOCAN1",123,0)
 N PFIN,PFINZ,PFINFLAG
"RTN","PSOCAN1",124,0)
 S PFINFLAG=0 S PFIN="" F  S PFIN=$O(PSOSD(PFIN)) Q:PFIN=""  S PFINZ="" F  S PFINZ=$O(PSOSD(PFIN,PFINZ)) Q:PFINZ=""  D
"RTN","PSOCAN1",125,0)
 .I $G(PFIN)'="PENDING" I $P($G(^PSRX(+$P($G(PSOSD(PFIN,PFINZ)),"^"),"STA")),"^")'=12,'$G(PFINFLAG) S PSOCANRD=+$P($G(^(0)),"^",4),PFINFLAG=1
"RTN","PSOCAN1",126,0)
 .I $G(PFIN)="PENDING",'$G(PFINFLAG) S PSOCANRD=+$P($G(^PS(52.41,+$P($G(PSOSD(PFIN,PFINZ)),"^",10),0)),"^",5) S PFINFLAG=1
"RTN","PSOCAN1",127,0)
 I '$G(PFINFLAG) S PSOCANRZ=1
"RTN","PSOCAN1",128,0)
 Q
"RTN","PSOCAN1",129,0)
ONOFF ;
"RTN","PSOCAN1",130,0)
 I $G(PSOREINF) S PSORX("DOSING INFO")=1
"RTN","PSOCAN1",131,0)
 I $G(PSORX("DOSING INFO"))&'$G(PSOREINF) S PSOREINF=1
"RTN","PSOCAN1",132,0)
 Q
"RTN","PSOCAN3")
0^24^B73058805^B71988154
"RTN","PSOCAN3",1,0)
PSOCAN3 ;BIR/RTR/SAB - auto dc rxs due to death ;2/05/97 2:59pm
"RTN","PSOCAN3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**15,24,27,32,36,94,88,117,131,146,139,132,223,235,148,249,225,324,251,375,379,372,540,508**;DEC 1997;Build 295
"RTN","PSOCAN3",3,0)
 ;External reference to File #55 supported by DBIA 2228
"RTN","PSOCAN3",4,0)
 ;External references to L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOCAN3",5,0)
 Q
"RTN","PSOCAN3",6,0)
APSOD(PSODFN) ;called from file #2 date of death xref 'APOSD'
"RTN","PSOCAN3",7,0)
 N D,DA,DB,DC,DE,DG,DH,DI,DIC,DIE,DIG,DIH,DIK,DIR,DIQ,DIU,DIV,DIW,DK,DL,DM,DP,DQ,DU,DV,DW,DR
"RTN","PSOCAN3",8,0)
 S PSODEATH=1 D CAN K PSODEATH
"RTN","PSOCAN3",9,0)
 Q
"RTN","PSOCAN3",10,0)
CAN ;discontinued rxs due to death
"RTN","PSOCAN3",11,0)
 I $G(PSODFN),$D(^PS(52.91,PSODFN,0)) D
"RTN","PSOCAN3",12,0)
 .I '$P($G(^PS(52.91,PSODFN,0)),"^",3)!($P($G(^(0)),"^",3)>DT) S $P(^PS(52.91,PSODFN,0),"^",3)=DT,$P(^PS(52.91,PSODFN,0),"^",4)=5,^PS(52.91,"AX",DT,PSODFN)="" D SET^PSOTPCAN(PSODFN)
"RTN","PSOCAN3",13,0)
 F PSORXJ=0:0 S PSORXJ=$O(^PS(55,PSODFN,"P",PSORXJ)) Q:'PSORXJ  I $D(^(PSORXJ,0)) S PSORX=^(0) S STA=$S($P($G(^PSRX(PSORX,"STA")),"^")<11:1,$P($G(^("STA")),"^")=16:1,1:0) D:STA
"RTN","PSOCAN3",14,0)
 .I $D(^PSRX(PSORX,0)),$P($G(^PSRX(PSORX,"STA")),"^")="" D SETC
"RTN","PSOCAN3",15,0)
 .D REVERSE^PSOBPSU1(PSORX,,"DC",7)
"RTN","PSOCAN3",16,0)
 .I $D(^PSRX(PSORX,0)),$P($G(^PSRX(PSORX,2)),"^",6)'<DT S PSO0=^(0),PSO2=$G(^(2)) D
"RTN","PSOCAN3",17,0)
 ..S ^PSRX(PSORX,"DDSTA")="52;"_$P(^PSRX(PSORX,"STA"),"^")
"RTN","PSOCAN3",18,0)
 ..;remove from hold
"RTN","PSOCAN3",19,0)
 ..I $G(^PSRX(PSORX,"H"))]"" D
"RTN","PSOCAN3",20,0)
 ...S ^PSRX(PSORX,"DDSTA")="52;"_$P(^PSRX(PSORX,"STA"),"^")_"^"_^PSRX(PSORX,"H")
"RTN","PSOCAN3",21,0)
 ...K:$P(^PSRX(PSORX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSORX,"H"),"^"),PSORX) S ^PSRX(PSORX,"H")=""
"RTN","PSOCAN3",22,0)
 ...I '$P($G(^PSRX(PSORX,2)),"^",2),$P($G(^(3)),"^") S $P(^PSRX(PSORX,2),"^",2)=$P(^(3),"^")
"RTN","PSOCAN3",23,0)
 ...I $G(PSODEATH),$P(^PSRX(PSORX,0),"^",2) S ^PSRX("APSOD",$P(^PSRX(PSORX,0),"^",2),PSORX)=""
"RTN","PSOCAN3",24,0)
 ..;delete from non-verified file
"RTN","PSOCAN3",25,0)
 ..I $G(^PS(52.4,PSORX,0))]"" S ^PSRX(PSORX,"DDSTA")="52.4;"_$P(^PSRX(PSORX,"STA"),"^")_"^"_^PS(52.4,PSORX,0),DIK="^PS(52.4,",DA=PSORX D ^DIK K DIK
"RTN","PSOCAN3",26,0)
 ..I $G(PSODEATH),$P(^PSRX(PSORX,0),"^",2) S ^PSRX("APSOD",$P(^PSRX(PSORX,0),"^",2),PSORX)=""
"RTN","PSOCAN3",27,0)
 ..;delete from suspense
"RTN","PSOCAN3",28,0)
 ..D:$O(^PS(52.5,"B",PSORX,0))
"RTN","PSOCAN3",29,0)
 ...S DA=$O(^PS(52.5,"B",PSORX,0)) I '$G(^PS(52.5,DA,"P")),$G(PSODEATH) S ^PSRX(PSORX,"DDSTA")="52.5;5^"_^PS(52.5,DA,0),^PSRX("APSOD",$P(^PSRX(PSORX,0),"^",2),PSORX)=""
"RTN","PSOCAN3",30,0)
 ...I $O(^PSRX(PSORX,1,0)),'$G(PSODEATH) S DA=PSORX,SUSD=$P($G(^PS(52.5,$O(^PS(52.5,"B",PSORX,0)),0)),"^",2) D:'$G(^PS(52.5,$O(^PS(52.5,"B",PSORX,0)),"P")) REF^PSOCAN2
"RTN","PSOCAN3",31,0)
 ...S DA=$O(^PS(52.5,"B",PSORX,0)),DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOCAN3",32,0)
 ..D SETC
"RTN","PSOCAN3",33,0)
 ..;activity record
"RTN","PSOCAN3",34,0)
 ..S (COM,ACOM)=$S($G(PSODEATH):"Date of Death Entered by MAS",1:"Discontinued by Pharmacy")_"."
"RTN","PSOCAN3",35,0)
 ..S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(PSORX,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOCAN3",36,0)
 ..S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(PSORX,1,RF)) Q:'RF  S RFCNT=RF
"RTN","PSOCAN3",37,0)
 ..D NOW^%DTC S ACNT=ACNT+1,^PSRX(PSORX,"A",0)="^52.3DA^"_ACNT_"^"_ACNT
"RTN","PSOCAN3",38,0)
 ..S ^PSRX(PSORX,"A",ACNT,0)=%_"^"_"C"_"^^"_RFCNT_"^"_"Auto Discontinued Due to Death. "_ACOM
"RTN","PSOCAN3",39,0)
 ..;check for label/release/pending release
"RTN","PSOCAN3",40,0)
 ..D FIL
"RTN","PSOCAN3",41,0)
 ..S STAT="OD",PHARMST="" D EN^PSOHLSN1(PSORX,STAT,PHARMST,COM,"A") K COMM,PHARMST,STAT
"RTN","PSOCAN3",42,0)
 ;dc pending orders
"RTN","PSOCAN3",43,0)
 F PDA=0:0 S PDA=$O(^PS(52.41,"P",PSODFN,PDA)) Q:'PDA  I $P(^PS(52.41,PDA,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") D
"RTN","PSOCAN3",44,0)
 .I $G(PSODEATH) D
"RTN","PSOCAN3",45,0)
 ..S ^PS(52.41,PDA,"DDSTA")=$P(^PS(52.41,PDA,0),"^",3)_";"_+$P($G(^PS(52.41,PDA,"INI")),"^"),^PS(52.41,"APSOD",PSODFN,PDA)=""
"RTN","PSOCAN3",46,0)
 ..S $P(^PS(52.41,PDA,4),"^")="Date of Death Entered by MAS."
"RTN","PSOCAN3",47,0)
 .S $P(^PS(52.41,PDA,0),"^",3)="DC"
"RTN","PSOCAN3",48,0)
 .K ^PS(52.41,"AOR",PSODFN,+$P($G(^PS(52.41,PDA,"INI")),"^"),PDA)
"RTN","PSOCAN3",49,0)
 .S COM=$S($G(PSODEATH):"Date of Death Entered by MAS.",1:""),PL=$P(^PS(52.41,PDA,0),"^"),$P(^(0),"^",3)="DC"
"RTN","PSOCAN3",50,0)
 .D EN^PSOHLSN(PL,"OC",COM,"A") K COM,PL
"RTN","PSOCAN3",51,0)
 ;dc non-va meds
"RTN","PSOCAN3",52,0)
 D APSOD^PSONVNEW
"RTN","PSOCAN3",53,0)
KILL K %,%H,%T,ACNT,DA,PDA,DIRUT,DTOUT,PSO,PSO0,PSO2,PSOD,PSOD0,PSODFN,PSODL,PSORX,PSORXJ,PSOSD,RF,RFCNT,SUB,TM,TSKDT,X,X1,X2,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE
"RTN","PSOCAN3",54,0)
 D KVAR^VADPT S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCAN3",55,0)
 Q
"RTN","PSOCAN3",56,0)
CAN1 Q:$G(DODR)
"RTN","PSOCAN3",57,0)
 S PSOMGDFN=$G(PSODFN) ; SAVE IN CASE CANCELING RX THAT WAS MERGED TO ANOTHER DFN
"RTN","PSOCAN3",58,0)
 I $G(^PSRX(DA,"H"))]"" D HLD^PSOCAN2
"RTN","PSOCAN3",59,0)
 D REVERSE^PSOBPSU1(DA,,"DC",7)
"RTN","PSOCAN3",60,0)
 S PSCANVAR=0,RXDA=DA,DA=$O(^PS(52.5,"B",DA,0)) I DA,'$G(^PS(52.5,DA,"P")) S PSCANVAR=1 D
"RTN","PSOCAN3",61,0)
 .S SUSD=$P($G(^PS(52.5,DA,0)),"^",2)
"RTN","PSOCAN3",62,0)
 .S:+$G(^PS(52.5,DA,"P"))'=1 ACOM=$S(REA="C":"Discontinued",1:"Reinstated")_" while suspended. "_$G(COM)
"RTN","PSOCAN3",63,0)
 .S DIK="^PS(52.5," D ^DIK K DIK S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2)
"RTN","PSOCAN3",64,0)
 .D AREC^PSOCAN1 S DA=RXDA I $O(^PSRX(DA,1,0)) D REF^PSOCAN2
"RTN","PSOCAN3",65,0)
 I $G(REA)="C" S DA=$O(^PS(52.5,"B",RXDA,0)) I DA S DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOCAN3",66,0)
 I 'PSCANVAR S:$D(SPCANC) ACOM=$S(REA="C":"Discontinued",1:"Reinstated")_" during Rx cancel.  "
"RTN","PSOCAN3",67,0)
ADD S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2) S:$G(PSOOPT)=3 REA="L"
"RTN","PSOCAN3",68,0)
 D:'$G(PSCANVAR) AREC^PSOCAN1 S:REA="L" REA="C"
"RTN","PSOCAN3",69,0)
 S:REA'="C" $P(^PSRX(DA,"STA"),"^")=0,$P(^(7),"^")=""
"RTN","PSOCAN3",70,0)
 N PSOTPCNZ S PSOTPCNZ=0 I $P(^PSRX(DA,"STA"),"^")'=12 S PSOTPCNZ=1
"RTN","PSOCAN3",71,0)
 S:REA="C"&($P(^PSRX(DA,"STA"),"^")<12)!($P(^("STA"),"^")=16) $P(^PSRX(DA,"STA"),"^")=12 I $P($G(^PSRX(DA,"STA")),"^")=12,$G(PSOTPCNZ) D CAN^PSOTPCAN(DA)
"RTN","PSOCAN3",72,0)
 K PSOTPCNZ
"RTN","PSOCAN3",73,0)
 I REA="R" D
"RTN","PSOCAN3",74,0)
 .I $P(^PSRX(DA,3),"^",8) S $P(^PSRX(DA,3),"^",2)=$P(^PSRX(DA,3),"^",8),$P(^(3),"^",8)=""
"RTN","PSOCAN3",75,0)
 .S $P(^PSRX(DA,3),"^")=$S($P(^PSRX(DA,3),"^",10):$P(^(3),"^",10),$G(PSOCANHD):PSOCANHD,$P(^(3),"^",5):$P(^(3),"^",5),1:$P(^(3),"^")),$P(^(3),"^",5)="",$P(^(3),"^",10)=""
"RTN","PSOCAN3",76,0)
 I REA="C" D
"RTN","PSOCAN3",77,0)
 .S $P(^PSRX(DA,3),"^",10)=$P(^PSRX(DA,3),"^")
"RTN","PSOCAN3",78,0)
 .S:'$P(^PSRX(DA,3),"^",5) $P(^PSRX(DA,3),"^",5)=DT
"RTN","PSOCAN3",79,0)
 .I $O(^PS(52.41,"ARF",DA,0)),'$O(^PS(52.41,"APSOD",PSODFN,0)) S HLDDA=DA,DA=$O(^PS(52.41,"ARF",DA,0)),DIK="^PS(52.41," D ^DIK S DA=HLDDA K HLDDA
"RTN","PSOCAN3",80,0)
 .;check for label/release/pending release
"RTN","PSOCAN3",81,0)
 .I $G(PSOOPT)'=3 D FILX
"RTN","PSOCAN3",82,0)
 S PSONOOR=$S($D(PSONOOR):PSONOOR,1:"D"),STAT=$S(REA="C":"OD",1:"SC"),PHARMST=$S(REA="C":"",1:"CM")
"RTN","PSOCAN3",83,0)
 S COM=$S(REA="C":$S($G(PSOOPT)=3&('$G(DUP)):"Renewed",1:"Discontinued")_" by Pharmacy",1:"Reinstated by Pharmacy")
"RTN","PSOCAN3",84,0)
 D EN^PSOHLSN1(DA,STAT,PHARMST,$S(COM["Discontinued"&($D(INCOM)):INCOM,1:COM),$S($G(PSOOPT)=3&('$G(DUP)):"",1:PSONOOR)) K COM,STAT,PHARMST,PSCANVAR
"RTN","PSOCAN3",85,0)
 I REA="C" D
"RTN","PSOCAN3",86,0)
 .I $G(^PS(52.4,DA,0))]"" S PSCDA=DA,DIK="^PS(52.4," D ^DIK S DA=PSCDA K DIK,PSCDA
"RTN","PSOCAN3",87,0)
 I $G(PSOMGDFN)'="" S PSODFN=PSOMGDFN K PSOMGDFN
"RTN","PSOCAN3",88,0)
 S PSVC=$P(^PSRX(DA,0),"^",16)
"RTN","PSOCAN3",89,0)
 Q:(REA="C")!($P(^PSRX(DA,2),"^",10)]"")
"RTN","PSOCAN3",90,0)
 Q:$D(^XUSEC("PSORPH",DUZ))!('$P(PSOPAR,"^",2))
"RTN","PSOCAN3",91,0)
 S PSRXIN=DA,DIC="^PS(52.4,",DLAYGO=52.4,(X,DINUM)=PSRXIN,DIC(0)="ML"
"RTN","PSOCAN3",92,0)
 S DIC("DR")="1////"_$G(PSODFN)_";2////"_DUZ_";4////"_DT
"RTN","PSOCAN3",93,0)
 K DD,DO D FILE^DICN K DD,DO,DIC,DLAYGO,DINUM
"RTN","PSOCAN3",94,0)
 K DA,DIK S DA=PSRXIN K PSRXIN S $P(^PSRX(DA,"STA"),"^")=1 D NVER^PSOCAN2
"RTN","PSOCAN3",95,0)
 W !,"Rx # "_$P(^PSRX(DA,0),"^")_" is still non-verified!"
"RTN","PSOCAN3",96,0)
 Q
"RTN","PSOCAN3",97,0)
 ; PSO*7*508 - added ERXDCIEN parameter, and check for parameter and possession of psorph.
"RTN","PSOCAN3",98,0)
 ;           - the pso application proxy will not possess the PSORPH key, so we do not quit if that is the case.
"RTN","PSOCAN3",99,0)
OERR(ERXDCIEN) I '$D(^XUSEC("PSORPH",DUZ)),'$P($G(PSOPAR),"^",2),'$G(ERXDCIEN) S VALMSG="Invalid Action Selection!",VALMBCK="" Q
"RTN","PSOCAN3",100,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSOCAN3",101,0)
 K PSOPLCK S PSOCANRD=+$P($G(^PSRX($P(PSOLST(ORN),"^",2),0)),"^",4),PSOCANRA=1
"RTN","PSOCAN3",102,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG D KCAN D ULP Q
"RTN","PSOCAN3",103,0)
 I $P(^PSRX($P(PSOLST(ORN),"^",2),"STA"),"^"),$P(^("STA"),"^")=1!($P(^("STA"),"^")=4) S:$G(SPEED) PSONOORS=$G(PSONOOR) D DEL^PSOCAN4 S:$G(PSONOORS)'="" PSONOOR=$G(PSONOORS) K PSONOORS D KCAN D ULP Q
"RTN","PSOCAN3",104,0)
 I '+^PSRX($P(PSOLST(ORN),"^",2),"OR1"),$P(^("STA"),"^")=12 S VALMSG="Rx Cannot be Reinstated.  No Orderable Item." D KCAN D ULP D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSOCAN3",105,0)
 I $P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=12,$P($G(^("PKI")),"^") S VALMSG="Cannot be Reinstated - Digitally Signed" D KCAN D ULP D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSOCAN3",106,0)
 I $P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=12 S PSOCANRZ=1
"RTN","PSOCAN3",107,0)
 ; PSO*7*508 - replacing below line with following 2 lines - do not try to build header if this is an auto-dc for an eRx.
"RTN","PSOCAN3",108,0)
 ;D HLDHDR^PSOLMUTL S X=$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^"),PS=$S($P(^PSRX($P(PSOLST(ORN),"^",2),"STA"),"^")=12:"Reinstate: ",1:"Discontinue: ")
"RTN","PSOCAN3",109,0)
 I '$G(ERXDCIEN) D HLDHDR^PSOLMUTL
"RTN","PSOCAN3",110,0)
 S X=$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^"),PS=$S($P(^PSRX($P(PSOLST(ORN),"^",2),"STA"),"^")=12:"Reinstate: ",1:"Discontinue: ")
"RTN","PSOCAN3",111,0)
 ; PSO*7*508 - end changes
"RTN","PSOCAN3",112,0)
 S POERR=1,DFNHLD=PSODFN,DA=$P(PSOLST(ORN),"^",2) N PSOREINS,PSOONOFC S PSOREINS=1
"RTN","PSOCAN3",113,0)
 I $G(PSORX("DOSING OFF")) S PSOREINF=1
"RTN","PSOCAN3",114,0)
 I $P(^PSRX(DA,3),"^",5) S PSOCANHD=$P(^PSRX(DA,3),"^",5)
"RTN","PSOCAN3",115,0)
 D LMNO S:$G(PSOONOFC) PSORX("DOSING OFF")=1 I $G(PSOQUIT) D ULP,KCAN S VALMBCK="R" Q
"RTN","PSOCAN3",116,0)
 D:$P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=12 RMP
"RTN","PSOCAN3",117,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOCAN3",118,0)
 K POERR,PSCAN,PSI,PSL,PSOREINF S PSODFN=DFNHLD K DFNHLD D ULP
"RTN","PSOCAN3",119,0)
 D KCAN
"RTN","PSOCAN3",120,0)
 Q
"RTN","PSOCAN3",121,0)
ULP D UL^PSSLOCK(+$G(PSODFN))
"RTN","PSOCAN3",122,0)
 Q
"RTN","PSOCAN3",123,0)
 ;
"RTN","PSOCAN3",124,0)
LMNO ; Calls LMNO^PSOCAN
"RTN","PSOCAN3",125,0)
 N PSODFN,PSORX,RXN,RX0
"RTN","PSOCAN3",126,0)
 S PSPOP=0,RXNUM=X S PSODFN=+$P(^PSRX(DA,0),"^",2) D LMNO^PSOCAN
"RTN","PSOCAN3",127,0)
 Q
"RTN","PSOCAN3",128,0)
 ;
"RTN","PSOCAN3",129,0)
KCAN ;
"RTN","PSOCAN3",130,0)
 K PSOCANRA,PSOCANRC,PSOCANRD,PSOCANRN,PSOCANRP,PSOCANRZ,PSOMSG,PSOCANHD,PSOQUIT
"RTN","PSOCAN3",131,0)
 Q
"RTN","PSOCAN3",132,0)
 ;
"RTN","PSOCAN3",133,0)
KCAN1 ;
"RTN","PSOCAN3",134,0)
 K PSOCANRC,PSOCANRD,PSOCANRN,PSOCANRP,PSOCANRZ
"RTN","PSOCAN3",135,0)
 Q
"RTN","PSOCAN3",136,0)
 ;
"RTN","PSOCAN3",137,0)
RMP D RMP^PSOCAN3N
"RTN","PSOCAN3",138,0)
 Q
"RTN","PSOCAN3",139,0)
 ;
"RTN","PSOCAN3",140,0)
FIL Q:'$G(PSORX)
"RTN","PSOCAN3",141,0)
 S PSOFC=PSORX G FILC
"RTN","PSOCAN3",142,0)
FILX Q:'$G(DA)
"RTN","PSOCAN3",143,0)
 S PSOFC=DA
"RTN","PSOCAN3",144,0)
FILC ;
"RTN","PSOCAN3",145,0)
 N PFC,PSOFFLAG
"RTN","PSOCAN3",146,0)
 I $P($G(^PSRX(PSOFC,2)),"^",13) G FILQ
"RTN","PSOCAN3",147,0)
 S PSOFFLAG=0 F PFC=0:0 S PFC=$O(^PSRX(PSOFC,1,PFC)) Q:'PFC!(PSOFFLAG)  I $P($G(^PSRX(PSOFC,1,PFC,0)),"^",18) S PSOFFLAG=1
"RTN","PSOCAN3",148,0)
 I PSOFFLAG G FILQ
"RTN","PSOCAN3",149,0)
 F PFC=0:0 S PFC=$O(^PSRX(PSOFC,"L",PFC)) Q:'PFC!(PSOFFLAG)  I $D(^PSRX(PSOFC,"L",PFC,0)),'$P($G(^(0)),"^",5) S PSOFFLAG=1
"RTN","PSOCAN3",150,0)
 I PSOFFLAG G FILQ
"RTN","PSOCAN3",151,0)
 S PSOFCSUS=$O(^PS(52.5,"B",PSOFC,0))
"RTN","PSOCAN3",152,0)
 I $G(PSOFCSUS),$P($G(^PS(52.5,PSOFCSUS,0)),"^",7)="L"!($P($G(^(0)),"^",7)="X") G FILQ
"RTN","PSOCAN3",153,0)
 S $P(^PSRX(PSOFC,3),"^",8)=$P($G(^PSRX(PSOFC,3)),"^",2)
"RTN","PSOCAN3",154,0)
 S $P(^PSRX(PSOFC,3),"^",2)=$P($G(^PSRX(PSOFC,2)),"^",2)
"RTN","PSOCAN3",155,0)
 I $P($G(^PSRX(PSOFC,"OR1")),"^",3) S $P(^PSRX(PSOFC,3),"^")=$P($G(^PSRX($P(^PSRX(PSOFC,"OR1"),"^",3),3)),"^")
"RTN","PSOCAN3",156,0)
FILQ K PSOFC,PSOFCSUS
"RTN","PSOCAN3",157,0)
 Q
"RTN","PSOCAN3",158,0)
 ;
"RTN","PSOCAN3",159,0)
SETC ;Called from Date of Death
"RTN","PSOCAN3",160,0)
 S $P(^PSRX(PSORX,"STA"),"^")=12,$P(^PSRX(PSORX,3),"^",5)=DT,$P(^PSRX(PSORX,3),"^",10)=$P(^PSRX(PSORX,3),"^") D CAN^PSOTPCAN(PSORX)
"RTN","PSOCAN3",161,0)
 D CHKCMOP^PSOUTL(PSORX,"D")
"RTN","PSOCAN3",162,0)
 Q
"RTN","PSOCAN4")
0^38^B51143319^B49357876
"RTN","PSOCAN4",1,0)
PSOCAN4 ;BIR/SAB - rx speed dc listman ;10/23/06 11:50am
"RTN","PSOCAN4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,24,27,63,88,117,131,259,268,225,358,385,391,508**;DEC 1997;Build 295
"RTN","PSOCAN4",3,0)
 ;External reference to File #200 supported by DBIA 224
"RTN","PSOCAN4",4,0)
 ;External reference NA^ORX1 supported by DBIA 2186
"RTN","PSOCAN4",5,0)
 ;External references to L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOCAN4",6,0)
 ;External reference to PSDRUG supported by DBIA 221
"RTN","PSOCAN4",7,0)
 ;External reference to PS(50.7 supported by DBIA 2223
"RTN","PSOCAN4",8,0)
 ;External reference to PS(50.606 supported by DBIA 2174
"RTN","PSOCAN4",9,0)
 ;External reference to ELIG^VADPT supported by DBIA 10061
"RTN","PSOCAN4",10,0)
SEL I '$D(^XUSEC("PSORPH",DUZ)) S VALMSG="Unauthorized Action Selection.",VALMBCK="" Q
"RTN","PSOCAN4",11,0)
 N VALMCNT I '$G(PSOCNT) S VALMSG="This patient has no Prescriptions!" S VALMBCK="" Q
"RTN","PSOCAN4",12,0)
 S DFNHLD=PSODFN
"RTN","PSOCAN4",13,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSOCAN4",14,0)
 K PSOPLCK S RXCNT=0 K PSOFDR,DIR,DUOUT,DIRUT S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR S LST=Y I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DUOUT S VALMBCK="" D ULP Q
"RTN","PSOCAN4",15,0)
 K DIR,DIRUT,DTOUT,PSOOELSE,DTOUT I +LST S (SPEED,PSOOELSE)=1 D  D KCAN^PSOCAN3
"RTN","PSOCAN4",16,0)
 .S PSOCANRA=1 D RQTEST
"RTN","PSOCAN4",17,0)
 .; The PSOTRIC variable is needed by NOOR, which is called by COM^PSOCAN1, to determine the default Nature of Order.
"RTN","PSOCAN4",18,0)
 .N PSOTRIC S PSOTRIC=$$ELIG(PSODFN)
"RTN","PSOCAN4",19,0)
 .D FULL^VALM1,COM^PSOCAN1 I '$D(INCOM)!($D(DIRUT)) K SPEED S VALMBCK="R" Q
"RTN","PSOCAN4",20,0)
 .D FULL^VALM1 F ORD=1:1:$L(LST,",") Q:$P(LST,",",ORD)']""  S ORN=$P(LST,",",ORD) D @$S(+PSOLST(ORN)=52:"RX",1:"PEN")
"RTN","PSOCAN4",21,0)
 .S VALMBCK="R"
"RTN","PSOCAN4",22,0)
 I '$G(PSOOELSE) S VALMBCK=""
"RTN","PSOCAN4",23,0)
 D ^PSOBUILD,BLD^PSOORUT1,RV^PSOORFL K PSOMSG,RXCNT,DIR,DIRUT,DTOUT,DUOUT,LST,ORD,IEN,ORN,RPH,ST,REFL,REF,PSOACT,ORSV,PSORNW,PSORENW,PSONO,PSOCO,PSOCU,PSODIR,DSMSG,SAVORD,SAVORN,SPEED,DIRUT,PSONOOR
"RTN","PSOCAN4",24,0)
 D INVALD^PSOCAN1 K PSINV,PSOOELSE,INCOM,COM S PSODFN=DFNHLD K DFNHLD D ULP
"RTN","PSOCAN4",25,0)
 Q
"RTN","PSOCAN4",26,0)
ULP D UL^PSSLOCK(+$G(PSODFN)) Q
"RTN","PSOCAN4",27,0)
 ;
"RTN","PSOCAN4",28,0)
RX Q:'$D(^XUSEC("PSORPH",DUZ))
"RTN","PSOCAN4",29,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) D  D PAUSE^VALM1 K PSOMSG Q
"RTN","PSOCAN4",30,0)
 .I $P($G(PSOMSG),"^",2)'="" W $C(7),!!,$P($G(PSOMSG),"^",2),!,"Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^"),! Q
"RTN","PSOCAN4",31,0)
 .W $C(7),!!,"Another person is editing Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^"),!
"RTN","PSOCAN4",32,0)
 I $P($G(^PSRX($P(PSOLST(ORN),"^",2),"PKI")),"^")=1,'$D(^XUSEC("PSDRPH",DUZ)) W $C(7),!!,"Digitally Signed Order - PSDRPH key required" D PAUSE^VALM1 Q
"RTN","PSOCAN4",33,0)
 S RXSP=1 K PSCAN S (EN,X)=$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^") S Y=$P(PSOLST(ORN),"^",2)_"^"_X,Y(0,0)=X,Y(0)=$G(^PSRX($P(PSOLST(ORN),"^",2),0)) D
"RTN","PSOCAN4",34,0)
 .I $P(^PSRX(+Y,"STA"),"^")=1!($P(^("STA"),"^")=4) D  Q
"RTN","PSOCAN4",35,0)
 ..S:$G(PSONOOR)'="" PSONOORA=$G(PSONOOR) D DEL S:$G(PSONOORA)'="" PSONOOR=$G(PSONOORA) K PSONOORA Q
"RTN","PSOCAN4",36,0)
 .S YY=Y,YY(0,0)=Y(0,0),(PSODFN,DFN)=$P(Y(0),"^",2) D:$G(DFN) CHK^PSOCAN I DEAD!($P(^PSRX(+YY,"STA"),"^")>11),$P(^("STA"),"^")<16 S PSINV(EN)="" Q
"RTN","PSOCAN4",37,0)
 .S DA=+YY I $P($G(^PSRX(DA,"STA")),"^")=11!($P($G(^(2)),"^",6)<DT) D EXP^PSOCAN
"RTN","PSOCAN4",38,0)
 .S RX=YY(0,0) D:$D(^PSRX(DA,0)) SPEED1^PSOCAN1
"RTN","PSOCAN4",39,0)
 K YY I '$D(PSCAN) D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSOCAN4",40,0)
 S RX="",RXCNT=0 F  S RX=$O(PSCAN(RX)) Q:RX=""  S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2),RXCNT=RXCNT+1 D SHOW^PSOCAN1
"RTN","PSOCAN4",41,0)
 S RX="" F  S RX=$O(PSCAN(RX)) Q:RX=""  D ACT
"RTN","PSOCAN4",42,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOCAN4",43,0)
 Q
"RTN","PSOCAN4",44,0)
ACT S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2),II=RX,PSODFN=$P(^PSRX(DA,0),"^",2) I REA="R" D REINS^PSOCAN2 Q
"RTN","PSOCAN4",45,0)
 D CAN1^PSOCAN3 Q
"RTN","PSOCAN4",46,0)
PEN ;discontinue pending orders
"RTN","PSOCAN4",47,0)
 S SAVORD=ORD,SAVORN=ORN
"RTN","PSOCAN4",48,0)
 S ORD=$P(PSOLST(ORN),"^",2) D PSOL^PSSLOCK(+ORD_"S") I '$G(PSOMSG) D  D MEDDIS K PSOMSG G OK
"RTN","PSOCAN4",49,0)
 .I $P($G(PSOMSG),"^",2)'="" W $C(7),!!,$P($G(PSOMSG),"^",2)_"  (Pending order)",! Q
"RTN","PSOCAN4",50,0)
 .W $C(7),!!,"Another person is editing this Pending order.",!
"RTN","PSOCAN4",51,0)
 I $P(^PS(52.41,ORD,0),"^",24),'$D(^XUSEC("PSDRPH",DUZ)) W $C(7),!!,"Digitally Signed Order - PSDRPH key required" D PAUSE^VALM1 G OK
"RTN","PSOCAN4",52,0)
 I $P(^PS(52.41,ORD,0),"^",3)="RF" S DA=ORD,DIK="^PS(52.41," D ^DIK K DA,DIK D PSOUL^PSSLOCK(ORD_"S") Q
"RTN","PSOCAN4",53,0)
 K ^PS(52.41,"AOR",$P(^PS(52.41,ORD,0),"^",2),+$P($G(^PS(52.41,ORD,"INI")),"^"),ORD) S $P(^PS(52.41,ORD,0),"^",3)="DC"
"RTN","PSOCAN4",54,0)
 D EN^PSOHLSN(+^PS(52.41,ORD,0),"OC",INCOM,PSONOOR)
"RTN","PSOCAN4",55,0)
 D PSOUL^PSSLOCK(ORD_"S")
"RTN","PSOCAN4",56,0)
OK S ORD=SAVORD,ORN=SAVORN Q
"RTN","PSOCAN4",57,0)
NOOR ;ask nature of order
"RTN","PSOCAN4",58,0)
 N RX
"RTN","PSOCAN4",59,0)
 I '$D(PSOTRIC),$G(ORN) S RX=+$P($G(PSOLST(ORN)),U,2) I RX N PSOTRIC S PSOTRIC=$$TRIC^PSOREJP1(RX)
"RTN","PSOCAN4",60,0)
 D FULL^VALM1
"RTN","PSOCAN4",61,0)
 K DIR,DTOUT,DTOUT,DIRUT I $T(NA^ORX1)]"" D  Q:$D(DIRUT)  G NOORXP
"RTN","PSOCAN4",62,0)
 .S PSONOOR=$$NA^ORX1($S($G(PSOTRIC):"R",1:"S"),0,"B","Nature of Order",0,"WPSDIVR"_$S(+$G(^VA(200,DUZ,"PS")):"E",1:""))
"RTN","PSOCAN4",63,0)
 .I +PSONOOR S PSONOOR=$P(PSONOOR,"^",3) Q
"RTN","PSOCAN4",64,0)
 .S DIRUT=1 K PSONOOR
"RTN","PSOCAN4",65,0)
 ;cnf, PSO*7*358, default to "SERVICE REJECTED" if TRICARE or CHAMPVA
"RTN","PSOCAN4",66,0)
 S DIR("A")="Nature of Order: ",DIR("B")=$S($G(PSOTRIC):"SERVICE REJECTED",$G(DODR):"SERVICE CORRECTED",1:"WRITTEN")
"RTN","PSOCAN4",67,0)
 S DIR(0)="SA^W:WRITTEN;V:VERBAL;P:TELEPHONE;S:SERVICE CORRECTED;D:DUPLICATE;I:POLICY;R:SERVICE REJECTED"_$S(+$G(^VA(200,DUZ,"PS")):";E:PROVIDER ENTERED",1:"")
"RTN","PSOCAN4",68,0)
 D ^DIR K DIR,DTOUT,DTOUT Q:$D(DIRUT)  S PSONOOR=Y
"RTN","PSOCAN4",69,0)
NOORXP I $G(PSOCANRA),'$G(PSOCANRZ) D REQ
"RTN","PSOCAN4",70,0)
NOORX S:$D(DIRUT)&($G(SPEED)) VALMBCK="Q"
"RTN","PSOCAN4",71,0)
 Q
"RTN","PSOCAN4",72,0)
DEL ;deletes non-verified Rxs
"RTN","PSOCAN4",73,0)
 ; PSO*7*508 - if this is an eRx being deleted, do not prompt the user since there is no user to reply
"RTN","PSOCAN4",74,0)
 ;           - since this cancellation will be sent by the provider, PSONOOR is set to "E"
"RTN","PSOCAN4",75,0)
 I $D(ERXDCIEN) S Y="eRx Discontinued by external provider (eRx)." S PSOZVER=1,DA=$P(PSOLST(ORN),"^",2),PSONOOR="E" D ENQ^PSORXDL Q
"RTN","PSOCAN4",76,0)
 D FULL^VALM1
"RTN","PSOCAN4",77,0)
 W ! K DIR,DIRUT,DUOUT S DIR(0)="Y",DIR("B")="No",DIR("A",1)="Rx # "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^")_" is in a Non-Verified Status.",DIR("A")="Are sure you want to mark the Rx as deleted" D ^DIR I 'Y!($D(DIRUT)) S VALMBCK="R" G EX
"RTN","PSOCAN4",78,0)
 I '$G(SPEED) D  I $D(DIRUT) G EX
"RTN","PSOCAN4",79,0)
 .D NOOR I $D(DIRUT) S VALMSG="No Action Taken!",VALMBCK="R" Q
"RTN","PSOCAN4",80,0)
 .K DIR S DIR("A")="Comments",DIR("B")="Per Pharmacy Request",DIR(0)="F^5:100" D ^DIR K DIR I $D(DIRUT) S VALMSG="No Action Taken!" Q
"RTN","PSOCAN4",81,0)
 K PSDEL,PSORX("INTERVENE") S PSOZVER=1,DA=$P(PSOLST(ORN),"^",2)
"RTN","PSOCAN4",82,0)
 D ENQ^PSORXDL
"RTN","PSOCAN4",83,0)
EX Q
"RTN","PSOCAN4",84,0)
REQ ;prompt for requesting provider
"RTN","PSOCAN4",85,0)
 I '$G(PSOCANRD),$G(PSOCANRP),$G(ORD),$D(^PS(52.41,ORD,0)) S PSOCANRD=+$P($G(^PS(52.41,ORD,0)),"^",5)
"RTN","PSOCAN4",86,0)
 I $G(PSOCANRD) D
"RTN","PSOCAN4",87,0)
 .I $D(^VA(200,PSOCANRD,"PS")),$P($G(^("PS")),"^"),$S('$P(^("PS"),"^",4):1,1:$P(^("PS"),"^",4)'<DT) Q
"RTN","PSOCAN4",88,0)
 .K PSOCANRD
"RTN","PSOCAN4",89,0)
 W ! K DIC S DIC=200,DIC(0)="AEQMZ",DIC("A")="Requesting PROVIDER: ",DIC("S")="I $D(^(""PS"")),$P(^(""PS""),""^""),$S('$P(^(""PS""),""^"",4):1,1:$P(^(""PS""),""^"",4)'<DT)" I $G(PSOCANRD) S DIC("B")=PSOCANRD
"RTN","PSOCAN4",90,0)
 D ^DIC K DIC S:$G(Y)<0!($D(DTOUT))!($D(DUOUT)) DIRUT=1 I $G(Y) S PSOCANRC=+$G(Y),PSOCANRN=$P($G(Y),"^",2),PSOCANRZ=1
"RTN","PSOCAN4",91,0)
 Q
"RTN","PSOCAN4",92,0)
RQTEST ;
"RTN","PSOCAN4",93,0)
 N PMIN,PMINZ,PMINFLAG
"RTN","PSOCAN4",94,0)
 S PMINFLAG=0 F PMIN=1:1:$L(LST,",") Q:$P(LST,",",PMIN)']""  S PMINZ=$P(LST,",",PMIN) D
"RTN","PSOCAN4",95,0)
 .I $P($G(PSOLST(PMINZ)),"^")=52 I $P($G(^PSRX(+$P($G(PSOLST(PMINZ)),"^",2),"STA")),"^")'=12,'$G(PMINFLAG) S PSOCANRD=+$P($G(^PSRX(+$P($G(PSOLST(PMINZ)),"^",2),0)),"^",4) S PMINFLAG=1
"RTN","PSOCAN4",96,0)
 .I $P($G(PSOLST(PMINZ)),"^")=52.41,'$G(PMINFLAG) S PSOCANRD=$P($G(^PS(52.41,+$P($G(PSOLST(PMINZ)),"^",2),0)),"^",5) S PMINFLAG=1
"RTN","PSOCAN4",97,0)
 I '$G(PMINFLAG) S PSOCANRZ=1
"RTN","PSOCAN4",98,0)
 Q
"RTN","PSOCAN4",99,0)
MEDDIS ;
"RTN","PSOCAN4",100,0)
 N PSOFMMD
"RTN","PSOCAN4",101,0)
 Q:'$G(ORD)
"RTN","PSOCAN4",102,0)
 Q:'$D(^PS(52.41,ORD,0))
"RTN","PSOCAN4",103,0)
 I $P(^PS(52.41,ORD,0),"^",9) W "Drug: "_$P($G(^PSDRUG(+$P(^PS(52.41,ORD,0),"^",9),0)),"^") D PAUSE^VALM1 Q
"RTN","PSOCAN4",104,0)
 I $P(^PS(52.41,ORD,0),"^",8) S PSOFMMD=$P(^(0),"^",8) W "Orderable Item: "_$P($G(^PS(50.7,PSOFMMD,0)),"^")_"  "_$P($G(^PS(50.606,+$P($G(^PS(50.7,PSOFMMD,0)),"^",2),0)),"^") D PAUSE^VALM1
"RTN","PSOCAN4",105,0)
 Q
"RTN","PSOCAN4",106,0)
 ;
"RTN","PSOCAN4",107,0)
REF ;CONT. FROM REF^PSOCAN2; PSO*7*259
"RTN","PSOCAN4",108,0)
 N PSOSIEN S PSOSIEN=0
"RTN","PSOCAN4",109,0)
 F  S PSOSIEN=$O(^PS(52.5,"B",DA,PSOSIEN)) Q:'PSOSIEN  D  Q:PSONODEL
"RTN","PSOCAN4",110,0)
 .I $P($G(^PS(52.5,PSOSIEN,0)),"^",13)'=IFN Q  ;NOT SAME REFILL
"RTN","PSOCAN4",111,0)
 .I '$P($G(^PS(52.5,PSOSIEN,"P")),"^") Q  ;SUSPENSE LABEL PRINT
"RTN","PSOCAN4",112,0)
 .S PSONODEL=1   ;REFILL NODE SHOULD NOT BE DELETED
"RTN","PSOCAN4",113,0)
 Q
"RTN","PSOCAN4",114,0)
 ;
"RTN","PSOCAN4",115,0)
ELIG(DFN) ; Return primary eligibility
"RTN","PSOCAN4",116,0)
 ; Input:
"RTN","PSOCAN4",117,0)
 ;   DFN: Patient IEN (required)
"RTN","PSOCAN4",118,0)
 ; Output:
"RTN","PSOCAN4",119,0)
 ;   "": No DFN passed in, 0: Veteran, 1: TRICARE, 2: CHAMPVA
"RTN","PSOCAN4",120,0)
 I '$G(DFN) Q ""
"RTN","PSOCAN4",121,0)
 ; Variables VAEL, VAERR, and I are modified by ELIG^VADPT
"RTN","PSOCAN4",122,0)
 N VAEL,VAERR,I,ELIG
"RTN","PSOCAN4",123,0)
 ; ELIG^VADPT assumes DFN is defined and returns arrays VAEL and VAERR
"RTN","PSOCAN4",124,0)
 D ELIG^VADPT ; Supported by IA 10061
"RTN","PSOCAN4",125,0)
 ; VAEL(1) contains the primary eligibility
"RTN","PSOCAN4",126,0)
 S ELIG=$P($G(VAEL(1)),U,2)
"RTN","PSOCAN4",127,0)
 Q $S(ELIG="TRICARE"!(ELIG="SHARING AGREEMENT"):1,ELIG="CHAMPVA":2,1:0)
"RTN","PSOCMOPA")
0^25^B16718315^B16159826
"RTN","PSOCMOPA",1,0)
PSOCMOPA ;BIR/HTW-Utility for Hold/Can ;[ 12/30/96  10:28 AM ]
"RTN","PSOCMOPA",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**61,76,443,508**;DEC 1997;Build 295
"RTN","PSOCMOPA",3,0)
 ;External Referrence to file # 550.2 granted by DBIA 2231
"RTN","PSOCMOPA",4,0)
 ;Required input:  DA - internal entry # -  ^PSRX
"RTN","PSOCMOPA",5,0)
 ;Returns:
"RTN","PSOCMOPA",6,0)
 ;CMOP("L")=LAST FILL... if it is orig Rx =0
"RTN","PSOCMOPA",7,0)
 ;CMOP(FILL #)=CMOP status from 52...Trans/0,DISP/1,RETRAN/2,NOT DISP/3
"RTN","PSOCMOPA",8,0)
 ;If suspended CMOP("S")=CMOP suspense status Q,L,X,P,R
"RTN","PSOCMOPA",9,0)
 ;PSOCMOP=STATUS_^_TRAN DATE_^_LAST FILL
"RTN","PSOCMOPA",10,0)
 ;All returned variables can be killed by K CMOP,PSOCMOP 
"RTN","PSOCMOPA",11,0)
 ;
"RTN","PSOCMOPA",12,0)
 N X,XN,BATCH,TDT,BIEN
"RTN","PSOCMOPA",13,0)
 K PSOCMOP
"RTN","PSOCMOPA",14,0)
 S (CMOP("L"),X)=0  F  S X=$O(^PSRX(DA,1,X)) Q:'X  S CMOP("L")=X
"RTN","PSOCMOPA",15,0)
 I $O(^PSRX(DA,4,0)) F X=0:0 S X=$O(^PSRX(DA,4,X)) Q:'X  D
"RTN","PSOCMOPA",16,0)
 .S XN=$G(^PSRX(DA,4,X,0)),BATCH=$P($G(XN),"^") Q:$G(BATCH)']""
"RTN","PSOCMOPA",17,0)
 .S BIEN=$O(^PSX(550.2,"B",BATCH,"")) Q:$G(BIEN)']""  S TDT=$P(^PSX(550.2,BIEN,0),"^",6)
"RTN","PSOCMOPA",18,0)
 .S CMOP($P($G(XN),"^",3))=$P($G(XN),"^",4),PSOCMOP=$P($G(XN),"^",4)_"^"_$G(TDT)_"^"_CMOP("L")
"RTN","PSOCMOPA",19,0)
 S X=$O(^PS(52.5,"B",DA,0)) I X]"" S CMOP("S")=$P($G(^PS(52.5,X,0)),"^",7),CMOP("52.5")=X
"RTN","PSOCMOPA",20,0)
 K X,XN,BATCH,TDT,BIEN
"RTN","PSOCMOPA",21,0)
 Q
"RTN","PSOCMOPA",22,0)
UNHOLD N FDT S FDT=PSORX("FILL DATE"),XFROM="UNHOLD" G EN1
"RTN","PSOCMOPA",23,0)
REINS S XFROM="REINSTATE"
"RTN","PSOCMOPA",24,0)
EN1 D SUS1^PSOCMOP I '$G(XFLAG) G KILL
"RTN","PSOCMOPA",25,0)
 D PSOCMOPA
"RTN","PSOCMOPA",26,0)
 I $G(REL)]""!($G(CMOP(CMOP("L")))=0)!($G(CMOP(CMOP("L")))=2) D  G KILL
"RTN","PSOCMOPA",27,0)
 .I XFROM="REINSTATE" W !!,RX_" REINSTATED -- ",! Q
"RTN","PSOCMOPA",28,0)
 .I XFROM="UNHOLD" W !!,$P(^PSRX(DA,0),"^")_" Removed from Hold Status",!!
"RTN","PSOCMOPA",29,0)
 I $G(CMOP(CMOP("L")))']"" D S^PSOCMOP G KILL
"RTN","PSOCMOPA",30,0)
 I $G(CMOP(CMOP("L")))=3,(FDT>DT) D S^PSOCMOP G KILL
"RTN","PSOCMOPA",31,0)
KILL D D1^PSOCMOP
"RTN","PSOCMOPA",32,0)
 K CMOP,DIR,X,DIRUT,DUOUT,Y,DTOUT,XFROM
"RTN","PSOCMOPA",33,0)
 Q
"RTN","PSOCMOPA",34,0)
 ;
"RTN","PSOCMOPA",35,0)
QS W !! S DIR("A")="LABEL: QUEUE"_$S($P(PSOPAR,"^",24):"/SUSPEND",1:"")_" or '^' to bypass "
"RTN","PSOCMOPA",36,0)
 S DIR("?",1)="Enter 'Q' to queue labels for printing" S:$P(PSOPAR,"^",24) DIR("?",2)="Enter 'S' to suspend labels for printing at a later date"
"RTN","PSOCMOPA",37,0)
 S DIR(0)="SA^Q:QUEUE"_$S($P(PSOPAR,"^",24):";S:SUSPENSE",1:""),DIR("B")="Q" D ^DIR K DIR
"RTN","PSOCMOPA",38,0)
 I $D(DUOUT)!$D(DIRUT) G KILL
"RTN","PSOCMOPA",39,0)
 I $G(Y)="S" D S^PSOCMOP K CMOP Q
"RTN","PSOCMOPA",40,0)
 I $G(Y)="Q" D D1^PSOCMOP K CMOP I $G(PSOLAP)]"",($G(PSOLAP)'=ION) S PPL=DA,RXLTOP=1 D QLBL^PSORXL Q
"RTN","PSOCMOPA",41,0)
 I $G(Y)="Q" S PPL=DA,RXLTOP=1 D Q1^PSORXL
"RTN","PSOCMOPA",42,0)
 Q
"RTN","PSOCMOPA",43,0)
HLD N PSOFROM S PSOFROM="HOLD"
"RTN","PSOCMOPA",44,0)
EN ;  Called from PSORXDL,HLD+4^PSOHLD, PSOCAN
"RTN","PSOCMOPA",45,0)
 ; if in suspense and "loading" no delete
"RTN","PSOCMOPA",46,0)
 Q:'$G(DA)  D PSOCMOPA
"RTN","PSOCMOPA",47,0)
 I $G(CMOP("S"))="L" D MSG K CMOP Q
"RTN","PSOCMOPA",48,0)
 ; PSO*7*508 - quit before the DIR call if this is an eRx
"RTN","PSOCMOPA",49,0)
 I $G(PSOFROM)="HOLD",($G(CMOP(CMOP("L")))=0!($G(CMOP(CMOP("L")))=2)) D MSG Q:$G(ERXDCIEN)  K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR ;*443
"RTN","PSOCMOPA",50,0)
 I $G(PSOFROM)="DELETE",($G(CMOP(CMOP("L")))=0!($G(CMOP(CMOP("L")))=2)) D MSG
"RTN","PSOCMOPA",51,0)
 K CMOP
"RTN","PSOCMOPA",52,0)
 Q
"RTN","PSOCMOPA",53,0)
 ; PSO*7*508 - if this is an eRx, set the flag and quit.
"RTN","PSOCMOPA",54,0)
MSG I $G(ERXDCIEN) S XFLAG=1 Q
"RTN","PSOCMOPA",55,0)
 W !!,"A CMOP Rx cannot be"_$S($G(PSOFROM)="HOLD":" placed on HOLD",$G(PSOFROM)="CANCEL":" DISCONTINUED",1:" DELETED")
"RTN","PSOCMOPA",56,0)
 W $S($G(PSOFROM)="DELETE":" while in",1:" during")
"RTN","PSOCMOPA",57,0)
 W $S($G(PSOFROM)="DELETE":" transmission status!",1:" transmission! ")_"  Try later.",!!
"RTN","PSOCMOPA",58,0)
 S XFLAG=1
"RTN","PSOCMOPA",59,0)
 Q
"RTN","PSOCMOPA",60,0)
CMOP ;
"RTN","PSOCMOPA",61,0)
 I $D(^PSRX(RXN,4)) F PSXZ=0:0 S PSXZ=$O(^PSRX(RXN,4,PSXZ)) Q:'PSXZ  D
"RTN","PSOCMOPA",62,0)
 .S PSX($P(^PSRX(RXN,4,PSXZ,0),U,3))=$P(^PSRX(RXN,4,PSXZ,0),U,4)
"RTN","PSOCMOPA",63,0)
 K PSXZ
"RTN","PSOCMOPA",64,0)
 Q
"RTN","PSOCMOPA",65,0)
DUPCAN N DA,PSOFROM S DA=+PSOSD(STA,DNM),PSOFROM="CANCEL" G EN
"RTN","PSOCMOPA",66,0)
 ;Called from ASK+4^PSORENW
"RTN","PSOCMOPA",67,0)
MW(PSODIR) ;
"RTN","PSOCMOPA",68,0)
 K DIR,DIC
"RTN","PSOCMOPA",69,0)
 S DIR(0)="52,11"
"RTN","PSOCMOPA",70,0)
 S DIR("B")=$S($G(PSORX("MAIL/WINDOW"))]"":PSORX("MAIL/WINDOW"),1:"WINDOW")
"RTN","PSOCMOPA",71,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") MWX
"RTN","PSOCMOPA",72,0)
 I $G(Y(0))']"" S PSODIR("DFLG")=1 G MWX
"RTN","PSOCMOPA",73,0)
 S PSODIR("MAIL/WINDOW")=Y,PSORX("MAIL/WINDOW")=Y(0)
"RTN","PSOCMOPA",74,0)
MW1 G:PSODIR("MAIL/WINDOW")'="W"!('$P($G(PSOPAR),"^",12)) MWX
"RTN","PSOCMOPA",75,0)
 S DIR(0)="52,35O"
"RTN","PSOCMOPA",76,0)
 S:$G(PSORX("METHOD OF PICK-UP"))]"" DIR("B")=PSORX("METHOD OF PICK-UP")
"RTN","PSOCMOPA",77,0)
 D DIR G:PSODIR("DFLG") MWX
"RTN","PSOCMOPA",78,0)
 I X[U W !,"Cannot jump to another field ..",! G MW1
"RTN","PSOCMOPA",79,0)
 S (PSODIR("METHOD OF PICK-UP"),PSORX("METHOD OF PICK-UP"))=Y
"RTN","PSOCMOPA",80,0)
MWX K X,Y
"RTN","PSOCMOPA",81,0)
 Q
"RTN","PSOCMOPA",82,0)
DIR ;
"RTN","PSOCMOPA",83,0)
 S PSODIR("FIELD")=0
"RTN","PSOCMOPA",84,0)
 G:$G(DIR(0))']"" DIRX
"RTN","PSOCMOPA",85,0)
 D ^DIR K DIR,DIE,DIC,DA
"RTN","PSOCMOPA",86,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)),$L($G(X))'>1!(Y="") S PSODIR("DFLG")=1 G DIRX
"RTN","PSOCMOPA",87,0)
DIRX K DIRUT,DTOUT,DUOUT,DIROUT,PSOX
"RTN","PSOCMOPA",88,0)
 Q
"RTN","PSOERX")
0^1^B122296708^B70347933
"RTN","PSOERX",1,0)
PSOERX ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERX",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,527,508**;DEC 1997;Build 295
"RTN","PSOERX",3,0)
 ;
"RTN","PSOERX",4,0)
EN(SRCH,SORTT,PCV) ; -- main entry point for PSO ERX HOLDING QUEUE
"RTN","PSOERX",5,0)
 N PSOREFSH
"RTN","PSOERX",6,0)
 D EN^VALM("PSO ERX HOLDING QUEUE")
"RTN","PSOERX",7,0)
 Q
"RTN","PSOERX",8,0)
 ;
"RTN","PSOERX",9,0)
HDR ; -- header code
"RTN","PSOERX",10,0)
 S VALMHDR(1)="PSO ERX HOLDING QUEUE"
"RTN","PSOERX",11,0)
 I $G(PSOREFSH) K @VALMAR D INIT
"RTN","PSOERX",12,0)
 Q
"RTN","PSOERX",13,0)
 ;
"RTN","PSOERX",14,0)
INIT ; -- init variables and list array
"RTN","PSOERX",15,0)
 ;/BLB/ PSO*7.0*527 - BEING CHANGE - SIGNIFICANT CHANGES HAVE OCCURED TO FACILITATE FASTER PROCESSING TIMES IN THE ERX HOLDING QUEUE
"RTN","PSOERX",16,0)
 N LINE,LINEVAR,X,SGLOB,EF,ESIEN,CHKSTAT,EARY,SUBS,SUBS2,SVAL,SSTWO,EBDATE,ERXIEN,DTLOOP,PTLOOP,ERXDB,ERXDS,ERX,ERXDAT,P5246IEN,BDOVR,EEDATE
"RTN","PSOERX",17,0)
 N CNT
"RTN","PSOERX",18,0)
 S EF=52.49
"RTN","PSOERX",19,0)
 S SGLOB=$NA(^TMP("PSOERX",$J)) K @SGLOB
"RTN","PSOERX",20,0)
 S PSOSRCH=$S($D(SRCH):1,1:0) I PSOSRCH S PSOSRCH(VALMEVL)=""
"RTN","PSOERX",21,0)
 S PSOSRT=$S($D(SORTT):1,1:0) I PSOSRT S PSOSRT(VALMEVL)=""
"RTN","PSOERX",22,0)
 ; initialize LINE
"RTN","PSOERX",23,0)
 I '$G(PSOPINST) Q
"RTN","PSOERX",24,0)
 F CHKSTAT="RJ","RM","PR","E" D
"RTN","PSOERX",25,0)
 .S ESIEN=$$PRESOLV^PSOERXA1(CHKSTAT,"ERX") Q:'ESIEN
"RTN","PSOERX",26,0)
 .S EARY(ESIEN)=""
"RTN","PSOERX",27,0)
 I $D(SRCH) D
"RTN","PSOERX",28,0)
 .I $D(SRCH(1)) S SUBS="EPAT",SVAL=$P(SRCH(1),U) Q
"RTN","PSOERX",29,0)
 .I $D(SRCH(4)) S SUBS="EPROV",SVAL=$P(SRCH(4),U) Q
"RTN","PSOERX",30,0)
 .I $D(SRCH(2)) S SUBS="F",SUBS2="DOB",SVAL=$P(SRCH(2),U) Q
"RTN","PSOERX",31,0)
 .I $D(SRCH(5)) S SUBS="F",SVAL=$P(SRCH(5),U) Q
"RTN","PSOERX",32,0)
 .I $D(SRCH(7)) S SUBS="MTYPE",SVAL=$P(SRCH(7),U) Q
"RTN","PSOERX",33,0)
 .S SUBS="F"
"RTN","PSOERX",34,0)
 I '$D(SRCH) S SUBS="F"
"RTN","PSOERX",35,0)
 S (LINE,CNT)=0
"RTN","PSOERX",36,0)
 ; Look back 90 days
"RTN","PSOERX",37,0)
 S EBDATE=$S($D(SRCH(3)):$P(SRCH(3),U),1:$$FMADD^XLFDT(DT,-90)),EEDATE=$S($D(SRCH(3)):$P(SRCH(3),U,2),1:DT_".9999")
"RTN","PSOERX",38,0)
 ; get lookback days override. Use it if we are not searching by date range.
"RTN","PSOERX",39,0)
 S BDOVR=$$GET1^DIQ(59,PSOSITE,10.2,"E")
"RTN","PSOERX",40,0)
 I $G(PCV) S BDOVR=365
"RTN","PSOERX",41,0)
 I BDOVR,'$D(SRCH(3)) S EBDATE=$$FMADD^XLFDT(DT,-BDOVR)
"RTN","PSOERX",42,0)
 F  S EBDATE=$O(^PS(52.49,SUBS,PSNPINST,EBDATE)) Q:'EBDATE!(EBDATE>EEDATE)!(CNT>998)  D
"RTN","PSOERX",43,0)
 .I $G(SUBS2)="DOB" D  Q
"RTN","PSOERX",44,0)
 ..S P5246IEN=0 F  S P5246IEN=$O(^PS(52.46,SUBS2,SVAL,P5246IEN)) Q:'P5246IEN!(CNT>998)  D
"RTN","PSOERX",45,0)
 ...S ERXIEN=0 F  S ERXIEN=$O(^PS(EF,"EPAT",PSNPINST,EBDATE,P5246IEN,ERXIEN)) Q:'ERXIEN!(CNT>998)  D
"RTN","PSOERX",46,0)
 ....D BLDITEM(ERXIEN,.CNT)
"RTN","PSOERX",47,0)
 .I $G(SVAL)]"" D  Q
"RTN","PSOERX",48,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(EF,SUBS,PSNPINST,EBDATE,SVAL,ERXIEN)) Q:'ERXIEN!(CNT>998)  D
"RTN","PSOERX",49,0)
 ...I $D(PCV),$D(EARY($$GET1^DIQ(52.49,ERXIEN,1,"I"))) Q
"RTN","PSOERX",50,0)
 ...D BLDITEM(ERXIEN,.CNT)
"RTN","PSOERX",51,0)
 .S SSTWO=0 F  S SSTWO=$O(^PS(EF,SUBS,PSNPINST,EBDATE,SSTWO)) Q:'SSTWO!(CNT>998)  D
"RTN","PSOERX",52,0)
 ..; Filter out RJ, RM, and PR status erx's if we are not searching for a specific eRx status
"RTN","PSOERX",53,0)
 ..I '$D(SRCH(5)),$D(EARY(SSTWO)) Q
"RTN","PSOERX",54,0)
 ..; if we are coming from the patient centric view, block RM, RJ, and PR.
"RTN","PSOERX",55,0)
 ..I $D(SRCH),$D(PCV),$D(EARY(SSTWO)) Q
"RTN","PSOERX",56,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(EF,SUBS,PSNPINST,EBDATE,SSTWO,ERXIEN)) Q:'ERXIEN!(CNT>998)  D
"RTN","PSOERX",57,0)
 ...D BLDITEM(ERXIEN,.CNT)
"RTN","PSOERX",58,0)
 S DTLOOP=0
"RTN","PSOERX",59,0)
 F  S DTLOOP=$O(@SGLOB@(DTLOOP)) Q:'DTLOOP  D
"RTN","PSOERX",60,0)
 .S PTLOOP=$S($G(SORTT)=3:0,1:"")
"RTN","PSOERX",61,0)
 .S PTLOOP="" F  S PTLOOP=$O(@SGLOB@(DTLOOP,PTLOOP),$S($G(SORTT)=3:-1,1:1)) Q:PTLOOP=""  D
"RTN","PSOERX",62,0)
 ..S ERXDB="" F  S ERXDB=$O(@SGLOB@(DTLOOP,PTLOOP,ERXDB)) Q:ERXDB=""  D
"RTN","PSOERX",63,0)
 ...S ERXDS="" F  S ERXDS=$O(@SGLOB@(DTLOOP,PTLOOP,ERXDB,ERXDS)) Q:ERXDS=""  D
"RTN","PSOERX",64,0)
 ....S ERX=0 F  S ERX=$O(@SGLOB@(DTLOOP,PTLOOP,ERXDB,ERXDS,ERX)) Q:'ERX  D
"RTN","PSOERX",65,0)
 .....S LINE=LINE+1,LINEVAR=""
"RTN","PSOERX",66,0)
 .....S ERXDAT=$G(@SGLOB@(DTLOOP,PTLOOP,ERXDB,ERXDS,ERX))
"RTN","PSOERX",67,0)
 .....S LINEVAR=$$SETFLD^VALM1(LINE_".",LINEVAR,"#")
"RTN","PSOERX",68,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U),LINEVAR,"PATIENT NAME")
"RTN","PSOERX",69,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,2),LINEVAR,"DOB")
"RTN","PSOERX",70,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,3),LINEVAR,"DRUG")
"RTN","PSOERX",71,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,4),LINEVAR,"PROVIDER")
"RTN","PSOERX",72,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,8),LINEVAR,"STA")
"RTN","PSOERX",73,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,7),LINEVAR,"RECORD DATE")
"RTN","PSOERX",74,0)
 .....D SET^VALM10(LINE,LINEVAR,ERX)
"RTN","PSOERX",75,0)
 I LINE=0 S LINE=LINE+1 D SET^VALM10(LINE,"No results for current query.")
"RTN","PSOERX",76,0)
 S VALMCNT=LINE
"RTN","PSOERX",77,0)
 K @SGLOB
"RTN","PSOERX",78,0)
 Q
"RTN","PSOERX",79,0)
BLDITEM(ERXIEN,CNT) ;
"RTN","PSOERX",80,0)
 N ERXIENS,ERXDAT,RXSTATN,MTYPE,RESTYPE,PATIEN,ERXQFLG,REQIEN,DELTA,FOUND,NMI,PATNM,NEWRX,PTDOBE,EXDS,EXPRIEN,EXPRNM
"RTN","PSOERX",81,0)
 N AUTOST,MANST,ERXSTAT,ERXISTAT,ERXDT,ERXEDT,PTDOB
"RTN","PSOERX",82,0)
 S ERXIENS=ERXIEN_","
"RTN","PSOERX",83,0)
 K ERXDAT D GETS^DIQ(52.49,ERXIENS,".03;.04;.08;1;4.9;3.1;2.1;1;1.2;1.3;52.1","IE","ERXDAT")
"RTN","PSOERX",84,0)
 S RXSTATN=$G(ERXDAT(EF,ERXIENS,1,"E"))
"RTN","PSOERX",85,0)
 S MTYPE=$G(ERXDAT(EF,ERXIENS,.08,"I"))
"RTN","PSOERX",86,0)
 S RESTYPE=$G(ERXDAT(EF,ERXIENS,52.1,"E"))
"RTN","PSOERX",87,0)
 I '$D(SRCH(5)),'$D(SRCH(7)),((RXSTATN="CAN")!(RXSTATN="CNP")!(RXSTATN="CAA")!(RXSTATN="CNE")) Q
"RTN","PSOERX",88,0)
 ; if the eRx is a new refill request and the status is refill request new, check for a response. if no response within 14 days, change to RRE (refill request expired)
"RTN","PSOERX",89,0)
 ; ChangeRequest messages will be checked for expiration status, but will not be displayed in the holding queue list view.
"RTN","PSOERX",90,0)
 I MTYPE="RR",RXSTATN="RRN" D CHKEXP(ERXIEN)
"RTN","PSOERX",91,0)
 S PATIEN=$G(ERXDAT(EF,ERXIENS,.04,"I")) I 'PATIEN S PATIEN=$$GETPAT^PSOERXU5(ERXIEN)
"RTN","PSOERX",92,0)
 I $D(SRCH(1)),PATIEN'=$P($G(SRCH(1)),U) Q
"RTN","PSOERX",93,0)
 S PTDOB=$$GET1^DIQ(52.46,PATIEN,.08,"I")
"RTN","PSOERX",94,0)
 I $D(SRCH(2)),PTDOB'=$G(SRCH(2)) Q
"RTN","PSOERX",95,0)
 I '$D(SRCH)!($G(PCV)),MTYPE="IE",RXSTATN'="RRE" Q
"RTN","PSOERX",96,0)
 I '$D(SRCH)!($G(PCV)),MTYPE="RR" Q
"RTN","PSOERX",97,0)
 ; if this is not a search, is a refill response, and is a response type of 'approved', do not show in the holding queue.
"RTN","PSOERX",98,0)
 I '$D(SRCH(7)),'$D(SRCH(5))!($G(PCV)),MTYPE="RE",RESTYPE="A" Q
"RTN","PSOERX",99,0)
 ; do not display refill response with 'approved with changes' status in the holding queue.
"RTN","PSOERX",100,0)
 S ERXQFLG=0
"RTN","PSOERX",101,0)
 I '$D(SRCH)!($G(PCV)),MTYPE="RE","RXP,RXC,RXA,"[RXSTATN Q
"RTN","PSOERX",102,0)
 I '$D(SRCH)!($G(PCV)),MTYPE="RE",RESTYPE="AWC" D  Q:ERXQFLG
"RTN","PSOERX",103,0)
 .S REQIEN=$$GETREQ^PSOERXU2(ERXIEN) I 'REQIEN Q
"RTN","PSOERX",104,0)
 .D RRDELTA^PSOERXU2(.DELTA,REQIEN,ERXIEN)
"RTN","PSOERX",105,0)
 .I $D(DELTA(52.49,"EXTERNAL PROVIDER")) Q
"RTN","PSOERX",106,0)
 .S ERXQFLG=1
"RTN","PSOERX",107,0)
 I $D(SRCH(7)),MTYPE="" Q
"RTN","PSOERX",108,0)
 N FOUND,NMI
"RTN","PSOERX",109,0)
 S FOUND=0
"RTN","PSOERX",110,0)
 I $D(SRCH(7)) D  Q:'FOUND
"RTN","PSOERX",111,0)
 .F NMI=1:1 D  Q:$P(SRCH(7),U,NMI)=""!(FOUND)
"RTN","PSOERX",112,0)
 ..I $P(SRCH(7),U,NMI)=MTYPE S FOUND=1 Q
"RTN","PSOERX",113,0)
 ; patient name/dob
"RTN","PSOERX",114,0)
 S PATNM=$$GET1^DIQ(52.46,PATIEN,.01,"E") I MTYPE="IE"!(MTYPE="OE") S PATNM=$$GET1^DIQ(52.49,ERXIEN,.08,"E")
"RTN","PSOERX",115,0)
 I '$L(PATNM) D
"RTN","PSOERX",116,0)
 .S NEWRX=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERX",117,0)
 .I NEWRX S PATNM=$$GET1^DIQ(52.49,ERXIEN,.04,"E")
"RTN","PSOERX",118,0)
 .I '$L(PATNM) S PATNM=$$GET1^DIQ(52.49,ERXIEN,.08,"E")
"RTN","PSOERX",119,0)
 .S PATNM="N/A"
"RTN","PSOERX",120,0)
 S PTDOBE=""
"RTN","PSOERX",121,0)
 I PTDOB]"" S PTDOBE=$$FMTE^XLFDT(PTDOB,"2D")
"RTN","PSOERX",122,0)
 I '$L(PTDOB) S (PTDOB,PTDOBE)="N/A"
"RTN","PSOERX",123,0)
 ; external drug/supply
"RTN","PSOERX",124,0)
 S EXDS=$G(ERXDAT(EF,ERXIENS,3.1,"E")) I '$L(EXDS) S EXDS=$$GETDRUG^PSOERXU5(ERXIEN) I '$L(EXDS) S EXDS="N/A"
"RTN","PSOERX",125,0)
 I $D(SRCH(6)),EXDS'[$P($G(SRCH(6)),U) Q
"RTN","PSOERX",126,0)
 ; external provider ien and name
"RTN","PSOERX",127,0)
 S EXPRIEN=$G(ERXDAT(EF,ERXIENS,2.1,"I")) I 'EXPRIEN S EXPRIEN=$$GETPROV^PSOERXU5(ERXIEN)
"RTN","PSOERX",128,0)
 I $D(SRCH(4)),EXPRIEN'=$P($G(SRCH(4)),U,1) Q
"RTN","PSOERX",129,0)
 ; if there is no external provider, quit - FUTURE ENHANCEMENT - may need to find a way to log, view, and deal with these instances.
"RTN","PSOERX",130,0)
 ; PSO*7*508 - if there is no provider, set it to 'UNKNOWN', and do not quit (may use N/A instead)
"RTN","PSOERX",131,0)
 S EXPRNM=$$GET1^DIQ(52.48,EXPRIEN,.01,"E") I '$L(EXPRNM) S EXPRNM="N/A"
"RTN","PSOERX",132,0)
 ; auto and manual validation status
"RTN","PSOERX",133,0)
 S AUTOST=$G(ERXDAT(EF,ERXIENS,1.2,"E"))
"RTN","PSOERX",134,0)
 S MANST=$G(ERXDAT(EF,ERXIENS,1.3,"E"))
"RTN","PSOERX",135,0)
 S ERXSTAT=$G(ERXDAT(EF,ERXIENS,1,"E"))
"RTN","PSOERX",136,0)
 S ERXISTAT=$G(ERXDAT(EF,ERXIENS,1,"I"))
"RTN","PSOERX",137,0)
 I $D(SRCH(5)),ERXSTAT'=$P(SRCH(5),U,2) Q
"RTN","PSOERX",138,0)
 ; date ERX was received
"RTN","PSOERX",139,0)
 S ERXDT=$G(ERXDAT(EF,ERXIENS,.03,"I")),ERXEDT=$$FMTE^XLFDT($P(ERXDT,"."),"2D")
"RTN","PSOERX",140,0)
 S CNT=CNT+1
"RTN","PSOERX",141,0)
 I $G(SORTT) D  Q
"RTN","PSOERX",142,0)
 .I SORTT=1 S @SGLOB@(1,PATNM,ERXDT-9999999,EXPRNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",143,0)
 .I SORTT=2 S @SGLOB@(1,PTDOB,ERXDT-9999999,PATNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",144,0)
 .I SORTT=3 S @SGLOB@(1,ERXDT-9999999,PATNM,EXPRNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",145,0)
 .I SORTT=4 S @SGLOB@(1,EXPRNM,ERXDT,PATNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",146,0)
 .I SORTT=5 S @SGLOB@(1,ERXSTAT,PATNM,ERXDT-9999999,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",147,0)
 .I SORTT=6 S @SGLOB@(1,EXDS,PATNM,ERXDT-9999999,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",148,0)
 .I SORTT=7 D
"RTN","PSOERX",149,0)
 ..; MTYPE was not defined for 'newrx's from the first release. The post-init converts all rx's to a newRx type
"RTN","PSOERX",150,0)
 ..I MTYPE="" S MTYPE="UNK"
"RTN","PSOERX",151,0)
 ..S @SGLOB@(1,MTYPE,ERXDT-9999999,PATNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",152,0)
 I $D(SRCH(7)) S @SGLOB@(9999999-ERXDT,PATNM,PTDOB,EXDS,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT Q
"RTN","PSOERX",153,0)
 S @SGLOB@(ERXDT,PATNM,PTDOB,EXDS,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",154,0)
 Q
"RTN","PSOERX",155,0)
 ;
"RTN","PSOERX",156,0)
HELP ; -- help code
"RTN","PSOERX",157,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERX",158,0)
 Q
"RTN","PSOERX",159,0)
 ;
"RTN","PSOERX",160,0)
EXIT ; -- exit code
"RTN","PSOERX",161,0)
 K PSOSRCH(VALMEVL),PSOSRT(VALMEVL),@VALMAR,PSOREFSH
"RTN","PSOERX",162,0)
 I VALMEVL=0 K PSOSRCH,PSOSRT
"RTN","PSOERX",163,0)
 ; instruct centric view to refresh
"RTN","PSOERX",164,0)
 I $D(PCV) S VALMBCK="R" S PSOC1RE=1
"RTN","PSOERX",165,0)
 D FULL^VALM1
"RTN","PSOERX",166,0)
 Q
"RTN","PSOERX",167,0)
 ;
"RTN","PSOERX",168,0)
EX ; early exit logic
"RTN","PSOERX",169,0)
 K PSOSRCH,PSOSRT,SRCH,SORTT
"RTN","PSOERX",170,0)
 D EX^PSOORFI1
"RTN","PSOERX",171,0)
 Q
"RTN","PSOERX",172,0)
EXPND ; -- expand code
"RTN","PSOERX",173,0)
 Q
"RTN","PSOERX",174,0)
 ;
"RTN","PSOERX",175,0)
 ; search list and display results
"RTN","PSOERX",176,0)
SEARCH ;
"RTN","PSOERX",177,0)
 N RES,SVAL,I,DONE,SRCHARY,ERXIEN
"RTN","PSOERX",178,0)
 D FULL^VALM1
"RTN","PSOERX",179,0)
 S DONE=0
"RTN","PSOERX",180,0)
 F I=1:1 D  Q:DONE
"RTN","PSOERX",181,0)
 .S RES=$$DIR(,I,.SRCHARY)
"RTN","PSOERX",182,0)
 .I '+RES S DONE=1 Q
"RTN","PSOERX",183,0)
 .S SRCHARY(+RES)=$P(RES,U,2,99)
"RTN","PSOERX",184,0)
 .I $D(SRCHARY(8)) S DONE=1 Q
"RTN","PSOERX",185,0)
 I '$D(SRCHARY) S VALMBCK="R" Q
"RTN","PSOERX",186,0)
 I $G(SRCHARY(8))]"" D  Q
"RTN","PSOERX",187,0)
 .S ERXIEN=$O(^PS(52.49,"B",SRCHARY(8),0))
"RTN","PSOERX",188,0)
 .I 'ERXIEN W !,"eRx could not be found." D DIRE^PSOERXX1 S VALMBCK="R" Q
"RTN","PSOERX",189,0)
 .I '$D(^PS(52.49,ERXIEN)) W !,"eRx could not be found." D DIRE^PSOERXX1 S VALMBCK="R" Q
"RTN","PSOERX",190,0)
 .D EN^PSOERX1(ERXIEN)
"RTN","PSOERX",191,0)
 .S VALMBCK="R"
"RTN","PSOERX",192,0)
 I $D(STYP) D EN(.SRCHARY,STYP) Q
"RTN","PSOERX",193,0)
 D EN(.SRCHARY)
"RTN","PSOERX",194,0)
 ;S VALMBCK="R"
"RTN","PSOERX",195,0)
 Q
"RTN","PSOERX",196,0)
 ; sort target list
"RTN","PSOERX",197,0)
SORT ;
"RTN","PSOERX",198,0)
 N RES,STYP,SVAL
"RTN","PSOERX",199,0)
 D FULL^VALM1
"RTN","PSOERX",200,0)
 S RES=$$DIR(1,0)
"RTN","PSOERX",201,0)
 I '+$P(RES,U) Q
"RTN","PSOERX",202,0)
 S STYP=$P(RES,U)
"RTN","PSOERX",203,0)
 I $D(SRCHARY) D EN(.SRCHARY,STYP) Q
"RTN","PSOERX",204,0)
 D EN(,STYP)
"RTN","PSOERX",205,0)
 Q
"RTN","PSOERX",206,0)
DIR(SORT,CNT,SLIST) ;
"RTN","PSOERX",207,0)
 N DIR,Y,RLINE,STAG,SVAL
"RTN","PSOERX",208,0)
 K DIR
"RTN","PSOERX",209,0)
 S DIR(0)="SO^1:PATIENT NAME;2:DATE OF BIRTH;3:RECEIVED DATE RANGE;4:PROVIDER NAME;5:ERX STATUS;6:DRUG NAME;7:MESSAGE TYPE"
"RTN","PSOERX",210,0)
 I '$D(SORT) S DIR(0)=DIR(0)_";8:ERX REFERENCE NUMBER"
"RTN","PSOERX",211,0)
 I CNT<2 S DIR("L")="Select one of the following "_$S($G(SORT):"sort",1:"search")_" criteria:"
"RTN","PSOERX",212,0)
 I CNT>1 D
"RTN","PSOERX",213,0)
 .S DIR("L")=""
"RTN","PSOERX",214,0)
 .S DIR("L",13)="Select another search criteria or '^' to exit. Press enter to use the currently"
"RTN","PSOERX",215,0)
 .S DIR("L",14)="selected search criteria."
"RTN","PSOERX",216,0)
 S DIR("L",2)=""
"RTN","PSOERX",217,0)
 S DIR("L",3)=" "_$S($D(SLIST(1)):"*",1:"")_"1.) PATIENT NAME"
"RTN","PSOERX",218,0)
 S DIR("L",4)=" "_$S($D(SLIST(2)):"*",1:"")_"2.) DATE OF BIRTH"
"RTN","PSOERX",219,0)
 S DIR("L",5)=" "_$S($D(SLIST(3)):"*",1:"")_"3.) RECEIVED DATE"_$S('$G(SORT):" RANGE",1:"")
"RTN","PSOERX",220,0)
 S DIR("L",6)=" "_$S($D(SLIST(4)):"*",1:"")_"4.) PROVIDER NAME"
"RTN","PSOERX",221,0)
 S DIR("L",7)=" "_$S($D(SLIST(5)):"*",1:"")_"5.) ERX STATUS"
"RTN","PSOERX",222,0)
 S DIR("L",8)=" "_$S($D(SLIST(6)):"*",1:"")_"6.) DRUG NAME"
"RTN","PSOERX",223,0)
 S DIR("L",9)=" "_$S($D(SLIST(7)):"*",1:"")_"7.) MESSAGE TYPE"
"RTN","PSOERX",224,0)
 I '$D(SORT) S DIR("L",10)=" "_$S($D(SLIST(8)):"*",1:"")_"8.) ERX REFERENCE NUMBER"
"RTN","PSOERX",225,0)
 S DIR("L",11)=""
"RTN","PSOERX",226,0)
 S DIR("L",12)=$S($D(SLIST):" * - indicates selected criteria.",1:"")
"RTN","PSOERX",227,0)
 D ^DIR K DIR Q:'Y 0
"RTN","PSOERX",228,0)
 S RES=Y I $G(SORT) Q RES
"RTN","PSOERX",229,0)
 S RLINE=$S(RES=1:"PAT",RES=2:"DOB",RES=3:"RDT",RES=4:"PRVNM",RES=5:"ESTAT",RES=6:"DNAME",RES=7:"MTYPE",RES=8:"EREFNUM",1:"")
"RTN","PSOERX",230,0)
 I RLINE']"" Q 0
"RTN","PSOERX",231,0)
 S STAG=RLINE
"RTN","PSOERX",232,0)
 S SVAL=$$@STAG I SVAL="" Q 0
"RTN","PSOERX",233,0)
 Q RES_U_SVAL
"RTN","PSOERX",234,0)
PAT() ;
"RTN","PSOERX",235,0)
 N Y,DIC
"RTN","PSOERX",236,0)
 S DIC=52.46,DIC(0)="AEMQ" D ^DIC
"RTN","PSOERX",237,0)
 I Y<1 Q ""
"RTN","PSOERX",238,0)
 Q Y
"RTN","PSOERX",239,0)
DOB() ;
"RTN","PSOERX",240,0)
 N %DT,Y
"RTN","PSOERX",241,0)
 S %DT="A"
"RTN","PSOERX",242,0)
 S %DT("A")="Enter the Date of Birth (DOB): "
"RTN","PSOERX",243,0)
 D ^%DT
"RTN","PSOERX",244,0)
 I Y<1 Q ""
"RTN","PSOERX",245,0)
 Q Y
"RTN","PSOERX",246,0)
RDT() ;
"RTN","PSOERX",247,0)
 N BDATE,EDATE,%DT,Y
"RTN","PSOERX",248,0)
 S %DT="A"
"RTN","PSOERX",249,0)
 S %DT("A")="Enter the beginning date: "
"RTN","PSOERX",250,0)
 D ^%DT
"RTN","PSOERX",251,0)
 I Y<0 Q ""
"RTN","PSOERX",252,0)
 S BDATE=Y K Y,%DT
"RTN","PSOERX",253,0)
 S %DT="A"
"RTN","PSOERX",254,0)
 S %DT("A")="Enter the ending date: "
"RTN","PSOERX",255,0)
 S %DT("B")="T"
"RTN","PSOERX",256,0)
 D ^%DT
"RTN","PSOERX",257,0)
 I Y<0 Q ""
"RTN","PSOERX",258,0)
 S EDATE=Y_".999999"
"RTN","PSOERX",259,0)
 Q BDATE_U_EDATE
"RTN","PSOERX",260,0)
PRVNM() ;
"RTN","PSOERX",261,0)
 N Y,DIC
"RTN","PSOERX",262,0)
 S DIC("A")="Select PROVIDER: "
"RTN","PSOERX",263,0)
 S DIC=52.48,DIC(0)="AEQ" D ^DIC
"RTN","PSOERX",264,0)
 I Y<1 Q ""
"RTN","PSOERX",265,0)
 Q Y
"RTN","PSOERX",266,0)
ESTAT() ;
"RTN","PSOERX",267,0)
 ; prompt for erx status
"RTN","PSOERX",268,0)
 N Y,DIC
"RTN","PSOERX",269,0)
 S DIC("A")="Select eRx Status: "
"RTN","PSOERX",270,0)
 S DIC=52.45,DIC(0)="AEQ",DIC("S")="I $D(^PS(52.45,""TYPE"",""ERX"",Y))" D ^DIC
"RTN","PSOERX",271,0)
 I Y<1 Q ""
"RTN","PSOERX",272,0)
 Q Y
"RTN","PSOERX",273,0)
DNAME() ;
"RTN","PSOERX",274,0)
 N DIR,Y
"RTN","PSOERX",275,0)
 S DIR(0)="FO"
"RTN","PSOERX",276,0)
 S DIR("A")="Enter the name or partial name of the incoming eRx drug"
"RTN","PSOERX",277,0)
 D ^DIR
"RTN","PSOERX",278,0)
 I Y=""!(Y="^") Q ""
"RTN","PSOERX",279,0)
 Q $$UP^XLFSTR(Y)
"RTN","PSOERX",280,0)
MTYPE() ;
"RTN","PSOERX",281,0)
 N DIR,Y
"RTN","PSOERX",282,0)
 S DIR(0)="52.49,.08",DIR("A")="Select message type" D ^DIR
"RTN","PSOERX",283,0)
 I Y=""!(Y="^") Q ""
"RTN","PSOERX",284,0)
 Q Y
"RTN","PSOERX",285,0)
MTYPE2 ;
"RTN","PSOERX",286,0)
 N DIR,Y,DONE,SEL
"RTN","PSOERX",287,0)
 S VALMBCK="R"
"RTN","PSOERX",288,0)
 D FULL^VALM1
"RTN","PSOERX",289,0)
 S DIR(0)="52.49,.08",DIR("A")="Select message type" D ^DIR
"RTN","PSOERX",290,0)
 I Y=""!(Y="^") Q
"RTN","PSOERX",291,0)
 S SRCHARY(7)=Y D EN(.SRCHARY)
"RTN","PSOERX",292,0)
 Q
"RTN","PSOERX",293,0)
EREFNUM() ;
"RTN","PSOERX",294,0)
 N DIR,Y
"RTN","PSOERX",295,0)
 S DIR(0)="FO",DIR("A")="Enter the eRx Reference number" D ^DIR
"RTN","PSOERX",296,0)
 I Y=""!(Y="^") Q ""
"RTN","PSOERX",297,0)
 Q $$UP^XLFSTR(Y)
"RTN","PSOERX",298,0)
CHKKEY(DUZ) ;
"RTN","PSOERX",299,0)
 I $D(^XUSEC("PSDRPH",DUZ))!($D(^XUSEC("PSO ERX ADV TECH",DUZ)))!($D(^XUSEC("PSO ERX TECH",DUZ)))!($D(^XUSEC("PSO ERX VIEW",DUZ))) Q 1
"RTN","PSOERX",300,0)
 Q 0
"RTN","PSOERX",301,0)
CHKEXP(IEN) ;
"RTN","PSOERX",302,0)
 N MSGDT,RELMSG,RELMSGT,FOUND
"RTN","PSOERX",303,0)
 S FOUND=0
"RTN","PSOERX",304,0)
 S MSGDT=$$GET1^DIQ(52.49,IEN,.03,"I")
"RTN","PSOERX",305,0)
 S RELMSG=0 F  S RELMSG=$O(^PS(52.49,IEN,201,"B",RELMSG)) Q:'RELMSG  D
"RTN","PSOERX",306,0)
 .S RELMSGT=$$GET1^DIQ(52.49,IEN,.08,"I")
"RTN","PSOERX",307,0)
 .I RELMSGT="RE" S FOUND=1
"RTN","PSOERX",308,0)
 Q:FOUND
"RTN","PSOERX",309,0)
 I $$FMDIFF^XLFDT(DT,MSGDT)>14 S FDA(52.49,IEN_",",1)=$$PRESOLV^PSOERXA1("RRX","ERX") D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX",310,0)
 Q
"RTN","PSOERX1")
0^18^B96375321^B78477879
"RTN","PSOERX1",1,0)
PSOERX1 ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERX1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,527,508**;DEC 1997;Build 295
"RTN","PSOERX1",3,0)
 ;
"RTN","PSOERX1",4,0)
EN(PSOIEN) ; -- main entry point for PSO ERX HOLDING QUEUE
"RTN","PSOERX1",5,0)
 D EN^VALM("PSO ERX HQ DISPLAY")
"RTN","PSOERX1",6,0)
 Q
"RTN","PSOERX1",7,0)
 ;
"RTN","PSOERX1",8,0)
HDR ; -- header code
"RTN","PSOERX1",9,0)
 S VALMHDR(1)="eRx Patient: "_$$GET1^DIQ(52.49,PSOIEN,.04,"E")
"RTN","PSOERX1",10,0)
 S VALMHDR(2)="eRx Reference #: "_$$GET1^DIQ(52.49,PSOIEN,.01,"E")
"RTN","PSOERX1",11,0)
 I VALMBCK="R" K @VALMAR S VALMBCK="" D INIT
"RTN","PSOERX1",12,0)
 Q
"RTN","PSOERX1",13,0)
 ;
"RTN","PSOERX1",14,0)
INIT ;
"RTN","PSOERX1",15,0)
 Q:'$G(PSOIEN)
"RTN","PSOERX1",16,0)
 N PATIEN,PHARMIEN,PRVIEN,PHDAT,PATDAT,SUPDAT,PRVDAT,LINE,PRVLNM,PRVMI,PRVFN,EPAT,EPATDOB,VPATIEN,HARY,HL
"RTN","PSOERX1",17,0)
 N VPATNM,VPATDOB,EPRVIEN,EPRVNM,EPRVNPI,VAPRVIEN,VAPRVNM,VAPRVNPI,SUPIEN,ERXDRUG,ERXQTY,ERXFLS,CSCOMM
"RTN","PSOERX1",18,0)
 N ERXDS,ERXDT,VADRG,LINETXT,ERXCOMM,ERXRFLS,PATIENS,VAHREA,VAQTY,VAREF,VASIG,PATDAT,CURSTATE,CURSTATI
"RTN","PSOERX1",19,0)
 N LHFOUND,LHMATCH,LHSTATI,VAPDEAEX,ERXCOMM,COMFRST,COMARY,SIGDATA,SIGLOOP,SFIRST,SGLOOP,SIGARY,VADAYS,NRXIEN
"RTN","PSOERX1",20,0)
 N SLOOP,VASIG,VASARY,FSSIG,VAHSTA,EDIRECT,VAHPER,PAMANVAL,DRMANVAL,PRMANVAL,VPATINST,VAPIARY,VLOOP,FSVPIN
"RTN","PSOERX1",21,0)
 N DRGARY,DLP,MTYPE,MTYPEE,ERXSTAT,STATIEN,PDIAGTXT,SDIAGTXT,RELIEN,RELMTYPE,ERRIEN,LERXSTAT,LOPSTAT,OPIEN
"RTN","PSOERX1",22,0)
 S LINE=0
"RTN","PSOERX1",23,0)
 S PATIEN=$$GET1^DIQ(52.49,PSOIEN,.04,"I") I 'PATIEN S PATIEN=$$GETPAT^PSOERXU5(PSOIEN)
"RTN","PSOERX1",24,0)
 S PATIENS=PATIEN_","
"RTN","PSOERX1",25,0)
 D GETS^DIQ(52.46,PATIENS,"**","IE","PATDAT")
"RTN","PSOERX1",26,0)
 S EPAT=$G(PATDAT(52.46,PATIENS,.01,"E"))
"RTN","PSOERX1",27,0)
 S EPATDOB=$G(PATDAT(52.46,PATIENS,.08,"I")),EPATDOB=$$FMTE^XLFDT(EPATDOB,"2D")
"RTN","PSOERX1",28,0)
 S VPATIEN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERX1",29,0)
 S VPATNM=$S(VPATIEN:$$GET1^DIQ(2,VPATIEN,.01,"E"),1:"NOT LINKED")
"RTN","PSOERX1",30,0)
 S VPATDOB=$S(VPATIEN:$$GET1^DIQ(2,VPATIEN,.03,"I"),1:"N/A")
"RTN","PSOERX1",31,0)
 I VPATDOB S VPATDOB=$$FMTE^XLFDT(VPATDOB,"2D")
"RTN","PSOERX1",32,0)
 S PHARMIEN=$$GET1^DIQ(52.49,PSOIEN,2.5,"I")
"RTN","PSOERX1",33,0)
 D GETS^DIQ(52.47,PHARMIEN,"**","E","PHDAT")
"RTN","PSOERX1",34,0)
 S EPRVIEN=$$GET1^DIQ(52.49,PSOIEN,2.1,"I") I 'EPRVIEN S EPRVIEN=$$GETPROV^PSOERXU5(PSOIEN)
"RTN","PSOERX1",35,0)
 S EPRVNM=$$GET1^DIQ(52.48,EPRVIEN,.01,"E")
"RTN","PSOERX1",36,0)
 S EPRVNPI=$$GET1^DIQ(52.48,EPRVIEN,1.5,"E")
"RTN","PSOERX1",37,0)
 S VAPRVIEN=$$GET1^DIQ(52.49,PSOIEN,2.3,"I")
"RTN","PSOERX1",38,0)
 S EDIRECT=$$GET1^DIQ(52.49,PSOIEN,7,"E")
"RTN","PSOERX1",39,0)
 S VAPRVNM=$S(VAPRVIEN:$$GET1^DIQ(200,VAPRVIEN,.01,"E"),1:"NOT LINKED")
"RTN","PSOERX1",40,0)
 S VAPRVNPI=$S(VAPRVIEN:$$GET1^DIQ(200,VAPRVIEN,41.99,"E"),1:"N/A")
"RTN","PSOERX1",41,0)
 D GETS^DIQ(52.48,EPRVIEN,"**","E","PRVDAT")
"RTN","PSOERX1",42,0)
 S SUPIEN=$$GET1^DIQ(52.49,PSOIEN,2.6,"I")
"RTN","PSOERX1",43,0)
 D GETS^DIQ(52.48,SUPIEN,"**","E","SUPDAT")
"RTN","PSOERX1",44,0)
 S PAMANVAL=$$GET1^DIQ(52.49,PSOIEN,1.7,"I")
"RTN","PSOERX1",45,0)
 S PRMANVAL=$$GET1^DIQ(52.49,PSOIEN,1.3,"I")
"RTN","PSOERX1",46,0)
 S DRMANVAL=$$GET1^DIQ(52.49,PSOIEN,1.5,"I")
"RTN","PSOERX1",47,0)
 S MTYPE=$$GET1^DIQ(52.49,PSOIEN,.08,"I")
"RTN","PSOERX1",48,0)
 S MTYPEE=$$GET1^DIQ(52.49,PSOIEN,.08,"E")
"RTN","PSOERX1",49,0)
 S STATIEN=$$GET1^DIQ(52.49,PSOIEN,1,"I")
"RTN","PSOERX1",50,0)
 S ERXSTAT=$$GET1^DIQ(52.45,STATIEN,.02,"E")
"RTN","PSOERX1",51,0)
 ; only set the hold reason if the eRx has a hold status
"RTN","PSOERX1",52,0)
 S CURSTATE=$$GET1^DIQ(52.49,PSOIEN,1,"E")
"RTN","PSOERX1",53,0)
 S VAHREA=""
"RTN","PSOERX1",54,0)
 I $E(CURSTATE,1)="H" D
"RTN","PSOERX1",55,0)
 .S CURSTATI=$$GET1^DIQ(52.49,PSOIEN,1,"I")
"RTN","PSOERX1",56,0)
 .S LHMATCH=999999,LHFOUND=0 F  S LHMATCH=$O(^PS(52.49,PSOIEN,19,LHMATCH),-1) Q:'LHMATCH!(LHFOUND)  D
"RTN","PSOERX1",57,0)
 ..S LHSTATI=$$GET1^DIQ(52.4919,LHMATCH_","_PSOIEN_",",.02,"I") I LHSTATI=CURSTATI D  S LHFOUND=LHMATCH Q
"RTN","PSOERX1",58,0)
 ...S VAHREA=$$GET1^DIQ(52.4919,LHMATCH_","_PSOIEN_",",1)
"RTN","PSOERX1",59,0)
 ...S VAHSTA=$$GET1^DIQ(52.45,LHSTATI,.01,"E")_" - "_$$GET1^DIQ(52.45,LHSTATI,.02,"E")
"RTN","PSOERX1",60,0)
 ...S VAHPER=$$GET1^DIQ(52.4919,LHMATCH_","_PSOIEN_",",.03,"E")
"RTN","PSOERX1",61,0)
 I MTYPE="RE"!(MTYPE="CN") S MTYPEE=$G(MTYPEE)_" - "_$$GET1^DIQ(52.49,PSOIEN,52.1,"E")
"RTN","PSOERX1",62,0)
 S LINETXT=""
"RTN","PSOERX1",63,0)
 S LINE=LINE+1 D SET^VALM10(LINE,MTYPEE),CNTRL^VALM10(LINE,1,$L(MTYPEE),IORVON,IORVOFF)
"RTN","PSOERX1",64,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"eRx Status: "_$S($E(CURSTATE,1)="H":VAHSTA,1:ERXSTAT))
"RTN","PSOERX1",65,0)
 I MTYPE="CA" D
"RTN","PSOERX1",66,0)
 .S NRXIEN=$$RESOLV^PSOERXU2(PSOIEN) Q:'NRXIEN
"RTN","PSOERX1",67,0)
 .S LERXSTAT=$$LASTSTAT^PSOERXU5(NRXIEN)
"RTN","PSOERX1",68,0)
 .; over-ride for new rx's that have no status history
"RTN","PSOERX1",69,0)
 .I '$L(LERXSTAT) S LERXSTAT="N - NEW"
"RTN","PSOERX1",70,0)
 .S OPIEN=$$GET1^DIQ(52.49,NRXIEN,.13,"I") Q:'OPIEN
"RTN","PSOERX1",71,0)
 .S LOPSTAT=$$GET1^DIQ(52,OPIEN,100,"E")
"RTN","PSOERX1",72,0)
 .I NRXIEN S CSCOMM=$$CSCOMM^PSOERXU5(NRXIEN)
"RTN","PSOERX1",73,0)
 I MTYPE="CN" D
"RTN","PSOERX1",74,0)
 .S RELIEN=$$RESOLV^PSOERXU2(PSOIEN) Q:'RELIEN
"RTN","PSOERX1",75,0)
 .S NRXIEN=$$RESOLV^PSOERXU2(RELIEN)
"RTN","PSOERX1",76,0)
 .S LERXSTAT=$$LASTSTAT^PSOERXU5(NRXIEN)
"RTN","PSOERX1",77,0)
 .I NRXIEN S CSCOMM=$$CSCOMM^PSOERXU5(NRXIEN)
"RTN","PSOERX1",78,0)
 .I '$L(LERXSTAT) S LERXSTAT="N - NEW"
"RTN","PSOERX1",79,0)
 .S OPIEN=$$GET1^DIQ(52.49,NRXIEN,.13,"I") Q:'OPIEN
"RTN","PSOERX1",80,0)
 .S LOPSTAT=$$GET1^DIQ(52,OPIEN,100,"E")
"RTN","PSOERX1",81,0)
 I $G(CSCOMM)]"" S LINE=LINE+1 D SET^VALM10(LINE,"Current Status Details: "_CSCOMM)
"RTN","PSOERX1",82,0)
 I $D(LERXSTAT) S LINE=LINE+1 D SET^VALM10(LINE,"Last New Rx status: "_LERXSTAT)
"RTN","PSOERX1",83,0)
 I $D(LOPSTAT) S LINE=LINE+1 D SET^VALM10(LINE,"Outpatient Prescription status: "_LOPSTAT)
"RTN","PSOERX1",84,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",85,0)
 I "RRRE"[MTYPE S LINE=LINE+1 D SET^VALM10(LINE,"**************************MEDICATION PRESCRIBED******************************")
"RTN","PSOERX1",86,0)
 S LINE=LINE+1
"RTN","PSOERX1",87,0)
 ;/BLB/ - PSO*7.0*520 BEGIN CHANGE
"RTN","PSOERX1",88,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Patient: ",$E(EPAT,1,39),1,52)
"RTN","PSOERX1",89,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",EPATDOB,57,20)
"RTN","PSOERX1",90,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",91,0)
 I $L(EPAT)>39 D
"RTN","PSOERX1",92,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"             "_$E(EPAT,40,78))
"RTN","PSOERX1",93,0)
 I $L(EPAT)>78 D
"RTN","PSOERX1",94,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"             "_$E(EPAT,79,135))
"RTN","PSOERX1",95,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1",96,0)
 S LINETXT=""
"RTN","PSOERX1",97,0)
 S LINE=LINE+1
"RTN","PSOERX1",98,0)
 I MTYPE'="CA",MTYPE'="CN" D
"RTN","PSOERX1",99,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Vista Patient"_$S(PAMANVAL:"[v]",1:"")_": ",$E(VPATNM,1,55),1,55)
"RTN","PSOERX1",100,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",VPATDOB,57,20)
"RTN","PSOERX1",101,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",102,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",103,0)
 .S LINE=LINE+1
"RTN","PSOERX1",104,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1",105,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Provider: ",$E(EPRVNM,1,39),1,52)
"RTN","PSOERX1",106,0)
 D ADDITEM^PSOERX1A(.LINETXT,"NPI: ",EPRVNPI,57,20)
"RTN","PSOERX1",107,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",108,0)
 I $L(EPRVNM)>39 D
"RTN","PSOERX1",109,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"              "_$E(EPRVNM,40,77))
"RTN","PSOERX1",110,0)
 I $L(EPRVNM)>77 D
"RTN","PSOERX1",111,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"              "_$E(EPRVNM,78,135))
"RTN","PSOERX1",112,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1",113,0)
 I MTYPE'="CA",MTYPE'="CN" D
"RTN","PSOERX1",114,0)
 .S LINE=LINE+1
"RTN","PSOERX1",115,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Vista Provider"_$S(PRMANVAL:"[v]",1:"")_": ",$E(VAPRVNM,1,55),1,55)
"RTN","PSOERX1",116,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"NPI: ",VAPRVNPI,57,20)
"RTN","PSOERX1",117,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",118,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",119,0)
 S ERXDRUG=$$GET1^DIQ(52.49,PSOIEN,3.1,"E") I '$L(ERXDRUG) S ERXDRUG=$$GETDRUG^PSOERXU5(PSOIEN)
"RTN","PSOERX1",120,0)
 S ERXQTY=$$GET1^DIQ(52.49,PSOIEN,5.1,"E")
"RTN","PSOERX1",121,0)
 S ERXRFLS=$$GET1^DIQ(52.49,PSOIEN,5.6,"E")
"RTN","PSOERX1",122,0)
 ; refills for a refill response is # or refills-1
"RTN","PSOERX1",123,0)
 I MTYPE="RE",ERXRFLS S ERXRFLS=ERXRFLS-1
"RTN","PSOERX1",124,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1",125,0)
 I ERXRFLS="" D
"RTN","PSOERX1",126,0)
 .S ERXRFLS=$$GET1^DIQ(52.49,PSOIEN,5.7,"I")
"RTN","PSOERX1",127,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1",128,0)
 ;I MTYPE="RE",ERXRFLS S ERXRFLS=ERXRFLS-1
"RTN","PSOERX1",129,0)
 S ERXDS=$$GET1^DIQ(52.49,PSOIEN,5.5,"E")
"RTN","PSOERX1",130,0)
 S ERXDT=$$GET1^DIQ(52.49,PSOIEN,.03,"E")
"RTN","PSOERX1",131,0)
 S VADRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"E")
"RTN","PSOERX1",132,0)
 S VAREF=$$GET1^DIQ(52.49,PSOIEN,20.5,"E")
"RTN","PSOERX1",133,0)
 S VAQTY=$$GET1^DIQ(52.49,PSOIEN,20.1,"E")
"RTN","PSOERX1",134,0)
 S VADAYS=$$GET1^DIQ(52.49,PSOIEN,20.2,"E")
"RTN","PSOERX1",135,0)
 I VADRG']"" S VADRG="NOT LINKED"
"RTN","PSOERX1",136,0)
 D TXT2ARY^PSOERXD1(.DRGARY,ERXDRUG,,70)
"RTN","PSOERX1",137,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"eRx Drug: "_$G(DRGARY(1)))
"RTN","PSOERX1",138,0)
 S DLP=1
"RTN","PSOERX1",139,0)
 F  S DLP=$O(DRGARY(DLP)) Q:'DLP  D
"RTN","PSOERX1",140,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"          "_$G(DRGARY(DLP)))
"RTN","PSOERX1",141,0)
 S LINE=LINE+1
"RTN","PSOERX1",142,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Qty: ",ERXQTY,1,17)
"RTN","PSOERX1",143,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Refills: ",ERXRFLS,19,16)
"RTN","PSOERX1",144,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Days Supply: ",ERXDS,37,20)
"RTN","PSOERX1",145,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Date: ",$P(ERXDT,"@"),58,22)
"RTN","PSOERX1",146,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",147,0)
 D TXT2ARY^PSOERXD1(.SIGARY,EDIRECT,,70)
"RTN","PSOERX1",148,0)
 S SFIRST=$O(SIGARY(0))
"RTN","PSOERX1",149,0)
 S SGLOOP=0 F  S SGLOOP=$O(SIGARY(SGLOOP)) Q:'SGLOOP  D
"RTN","PSOERX1",150,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,$S(SGLOOP=SFIRST:"eRx Sig: ",1:"         ")_$G(SIGARY(SGLOOP)))
"RTN","PSOERX1",151,0)
 ; PSO*7*508 - if this is a refill request, response, or inbound error build the proper segments, then quit.
"RTN","PSOERX1",152,0)
 I MTYPE="RR" D  S VALMCNT=LINE Q
"RTN","PSOERX1",153,0)
 .D MEDDIS^PSOERXU3(PSOIEN,"D",.LINE),RRRES^PSOERXU3(PSOIEN,.LINE),RRREQ^PSOERXU3(PSOIEN,.LINE),MSGHIS^PSOERXU3(PSOIEN,.LINE)
"RTN","PSOERX1",154,0)
 I MTYPE="RE" D  S VALMCNT=LINE Q
"RTN","PSOERX1",155,0)
 .D RRRES^PSOERXU3(PSOIEN,.LINE),MEDDIS^PSOERXU3(PSOIEN,"D",.LINE),RRREQ^PSOERXU3(PSOIEN,.LINE),MSGHIS^PSOERXU3(PSOIEN,.LINE)
"RTN","PSOERX1",156,0)
 .; if the status is one of the failed status values, display the error details.
"RTN","PSOERX1",157,0)
 .I $$GET1^DIQ(52.49,PSOIEN,1,"E")="RXF" D PROCERR^PSOERXU3(PSOIEN,.LINE)
"RTN","PSOERX1",158,0)
 I MTYPE="IE" D  S VALMCNT=LINE Q
"RTN","PSOERX1",159,0)
 .S RELIEN=$$RESOLV^PSOERXU2(PSOIEN)
"RTN","PSOERX1",160,0)
 .S RELMTYPE=$$GET1^DIQ(52.49,RELIEN,.08,"I")
"RTN","PSOERX1",161,0)
 .I RELMTYPE="RE" D ERRDISP^PSOERXU3(PSOIEN,.LINE),RRREQ^PSOERXU3(PSOIEN,.LINE),MSGHIS^PSOERXU3(PSOIEN,.LINE) Q
"RTN","PSOERX1",162,0)
 .I RELMTYPE="CA" D ERRDISP^PSOERXU3(PSOIEN,.LINE),CANREQ^PSOERXU5(PSOIEN,.LINE),CANRES^PSOERXU5(PSOIEN,.LINE),MSGHIS^PSOERXU3(PSOIEN,.LINE) Q
"RTN","PSOERX1",163,0)
 .I RELMTYPE="CN" D ERRDISP^PSOERXU3(PSOIEN,.LINE),CANRES^PSOERXU5(PSOIEN,.LINE),CANREQ^PSOERXU5(PSOIEN,.LINE) Q
"RTN","PSOERX1",164,0)
 .D ERRDISP^PSOERXU3(PSOIEN,.LINE),MSGHIS^PSOERXU3(PSOIEN,.LINE)
"RTN","PSOERX1",165,0)
 I MTYPE="CA" D  S VALMCNT=LINE Q
"RTN","PSOERX1",166,0)
 .D CANREQ^PSOERXU5(PSOIEN,.LINE),CANRES^PSOERXU5(PSOIEN,.LINE),MSGHIS^PSOERXU3(PSOIEN,.LINE)
"RTN","PSOERX1",167,0)
 I MTYPE="CN" D  S VALMCNT=LINE Q
"RTN","PSOERX1",168,0)
 .I $$GET1^DIQ(52.49,PSOIEN,1,"E")="CNE" D  Q
"RTN","PSOERX1",169,0)
 ..S ERRIEN=$$GETRESP^PSOERXU2(PSOIEN)
"RTN","PSOERX1",170,0)
 ..D ERRDISP^PSOERXU3(ERRIEN,.LINE),CANRES^PSOERXU5(PSOIEN,.LINE),CANREQ^PSOERXU5(PSOIEN,.LINE),MSGHIS^PSOERXU3(PSOIEN,.LINE) Q
"RTN","PSOERX1",171,0)
 .D CANRES^PSOERXU5(PSOIEN,.LINE),CANREQ^PSOERXU5(PSOIEN,.LINE),MSGHIS^PSOERXU3(PSOIEN,.LINE)
"RTN","PSOERX1",172,0)
 I "RR,RE,CA,CN,IE"'[MTYPE!(MTYPE="N") D
"RTN","PSOERX1",173,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",174,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Vista Drug"_$S(DRMANVAL:"[v]",1:"")_": "_VADRG)
"RTN","PSOERX1",175,0)
 .S LINE=LINE+1
"RTN","PSOERX1",176,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Vista Qty: ",$G(VAQTY),1,25)
"RTN","PSOERX1",177,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Vista Refills: ",$G(VAREF),27,18)
"RTN","PSOERX1",178,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Vista Days Supply: ",$G(VADAYS),54,22)
"RTN","PSOERX1",179,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",180,0)
 .S VASIG=""
"RTN","PSOERX1",181,0)
 .S SLOOP=0 F  S SLOOP=$O(^PS(52.49,PSOIEN,"SIG",SLOOP)) Q:'SLOOP  D
"RTN","PSOERX1",182,0)
 ..I '$L($G(VASIG)) S VASIG=$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0)) Q
"RTN","PSOERX1",183,0)
 ..S VASIG=$G(VASIG)_" "_$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0))
"RTN","PSOERX1",184,0)
 .D TXT2ARY^PSOERXD1(.VASARY,VASIG,,68)
"RTN","PSOERX1",185,0)
 .S FSSIG=$O(VASARY(0))
"RTN","PSOERX1",186,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Vista Sig: "_$S(FSSIG:$G(VASARY(FSSIG)),1:""))
"RTN","PSOERX1",187,0)
 .S SLOOP=1 F  S SLOOP=$O(VASARY(SLOOP)) Q:'SLOOP  D
"RTN","PSOERX1",188,0)
 ..S LINE=LINE+1 D SET^VALM10(LINE,"                        "_VASARY(SLOOP))
"RTN","PSOERX1",189,0)
 .S VPATINST=$$GET1^DIQ(52.49,PSOIEN,27,"E")
"RTN","PSOERX1",190,0)
 .I VPATINST]"" S VPATINST=$$LSIG^PSOQUTIL(VPATINST)
"RTN","PSOERX1",191,0)
 .D TXT2ARY^PSOERXD1(.VAPIARY,VPATINST,68)
"RTN","PSOERX1",192,0)
 .S FSVPIN=$O(VAPIARY(0))
"RTN","PSOERX1",193,0)
 .S LINE=LINE+1 D SET^VALM10(LINE," Pat Inst: "_$S(FSVPIN:$G(VAPIARY(FSVPIN)),1:""))
"RTN","PSOERX1",194,0)
 .S VLOOP=1 F  S VLOOP=$O(VAPIARY(VLOOP)) Q:'VLOOP  D
"RTN","PSOERX1",195,0)
 ..S LINE=LINE+1 D SET^VALM10(LINE,"                        "_VAPIARY(VLOOP))
"RTN","PSOERX1",196,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Hold Status: "_$G(VAHSTA))
"RTN","PSOERX1",197,0)
 S VAHREA="Hold Reason: "_$G(VAHREA)
"RTN","PSOERX1",198,0)
 D TXT2ARY^PSOERXD1(.HARY,VAHREA," ",80)
"RTN","PSOERX1",199,0)
 S HL=0 F  S HL=$O(HARY(HL)) Q:'HL  D
"RTN","PSOERX1",200,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,$G(HARY(HL)))
"RTN","PSOERX1",201,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Placed on hold by: "_$G(VAHPER))
"RTN","PSOERX1",202,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",203,0)
 S ERXCOMM=$$GET1^DIQ(52.49,PSOIEN,8,"E")
"RTN","PSOERX1",204,0)
 D TXT2ARY^PSOERXD1(.COMARY,ERXCOMM," ",68)
"RTN","PSOERX1",205,0)
 S COMFRST=$O(COMARY(0)) S LINE=LINE+1 D SET^VALM10(LINE,"eRx Notes: "_$G(ERXCOMM))
"RTN","PSOERX1",206,0)
 F  S COMFRST=$O(COMARY(COMFRST)) Q:'COMFRST  D
"RTN","PSOERX1",207,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"          "_$G(COMARY(COMFRST)))
"RTN","PSOERX1",208,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",209,0)
 ;/BLB/ PSO*7.0*520 - BEGIN
"RTN","PSOERX1",210,0)
 I $$GET1^DIQ(52.49,PSOIEN,.05,"I") D
"RTN","PSOERX1",211,0)
 .D ALG^PSOERXU1(.LINE)
"RTN","PSOERX1",212,0)
 ;/BLB/ - END
"RTN","PSOERX1",213,0)
 D DIAG^PSOERXU1(PSOIEN,.LINE)
"RTN","PSOERX1",214,0)
 S VALMCNT=LINE
"RTN","PSOERX1",215,0)
 Q
"RTN","PSOERX1",216,0)
 ;
"RTN","PSOERX1",217,0)
HELP ; -- help code
"RTN","PSOERX1",218,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERX1",219,0)
 Q
"RTN","PSOERX1",220,0)
 ;
"RTN","PSOERX1",221,0)
EXIT ; -- exit code
"RTN","PSOERX1",222,0)
 K @VALMAR
"RTN","PSOERX1",223,0)
 ; PSO*7*527 - set VALMBCK and PSOREFSH to force refresh when returning to list view
"RTN","PSOERX1",224,0)
 S VALMBCK="R",PSOREFSH=1
"RTN","PSOERX1",225,0)
 Q
"RTN","PSOERX1",226,0)
 ;
"RTN","PSOERX1",227,0)
EXPND ; -- expand code
"RTN","PSOERX1",228,0)
 Q
"RTN","PSOERX1A")
0^19^B140048297^B129260267
"RTN","PSOERX1A",1,0)
PSOERX1A ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERX1A",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,527,508**;DEC 1997;Build 295
"RTN","PSOERX1A",3,0)
 ;
"RTN","PSOERX1A",4,0)
 Q
"RTN","PSOERX1A",5,0)
 ; select an item
"RTN","PSOERX1A",6,0)
SI ;
"RTN","PSOERX1A",7,0)
 N RESP,ERXIEN,ERXDAT,LINE,LINEVAR,ERXPAT,ERXLOCK,DIR,NEWRXIEN,REQIEN,MTYPE,Y
"RTN","PSOERX1A",8,0)
 D FULL^VALM1
"RTN","PSOERX1A",9,0)
 S DIR(0)="N^"_VALMBG_":"_VALMLST_":0" D ^DIR
"RTN","PSOERX1A",10,0)
 I 'Y S VALMBCK="R" Q
"RTN","PSOERX1A",11,0)
 S RESP=Y
"RTN","PSOERX1A",12,0)
 S ERXIEN=$O(@VALMAR@("IDX",RESP,"")) Q:'ERXIEN
"RTN","PSOERX1A",13,0)
 ; Get the patient IEN
"RTN","PSOERX1A",14,0)
 S ERXPAT=$$GETPAT^PSOERXU5(ERXIEN)
"RTN","PSOERX1A",15,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERX1A",16,0)
 I 'ERXPAT,"IEOE"[MTYPE D EN^PSOERX1(ERXIEN) S VALMBCK="R" Q
"RTN","PSOERX1A",17,0)
 S ERXLOCK=$$L(ERXPAT,1)
"RTN","PSOERX1A",18,0)
 I 'ERXLOCK S DIR(0)="E" D ^DIR K DIR S VALMBCK="R" Q
"RTN","PSOERX1A",19,0)
 D EN^PSOERX1(ERXIEN)
"RTN","PSOERX1A",20,0)
 I '$D(PCV) D UL(ERXPAT)
"RTN","PSOERX1A",21,0)
 K %
"RTN","PSOERX1A",22,0)
 S VALMBCK="R"
"RTN","PSOERX1A",23,0)
 Q
"RTN","PSOERX1A",24,0)
SBN ;
"RTN","PSOERX1A",25,0)
 N Y,ERXIEN,ERXPAT,DIR,MTYPE
"RTN","PSOERX1A",26,0)
 D FULL^VALM1
"RTN","PSOERX1A",27,0)
 S Y=+$P(XQORNOD(0),"=",2)
"RTN","PSOERX1A",28,0)
 I 'Y S VALMBCK="R" Q
"RTN","PSOERX1A",29,0)
 S ERXIEN=$O(@VALMAR@("IDX",Y,"")) Q:'ERXIEN
"RTN","PSOERX1A",30,0)
 S ERXPAT=$$GETPAT^PSOERXU5(ERXIEN)
"RTN","PSOERX1A",31,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERX1A",32,0)
 I 'ERXPAT,"IEOE"[MTYPE D EN^PSOERX1(ERXIEN) S VALMBCK="R" Q 
"RTN","PSOERX1A",33,0)
 S ERXLOCK=$$L(ERXPAT,1)
"RTN","PSOERX1A",34,0)
 I 'ERXLOCK S DIR(0)="E" D ^DIR K DIR S VALMBCK="R" Q
"RTN","PSOERX1A",35,0)
 D EN^PSOERX1(ERXIEN)
"RTN","PSOERX1A",36,0)
 I '$D(PCV) D UL(ERXPAT)
"RTN","PSOERX1A",37,0)
 S VALMBCK="R"
"RTN","PSOERX1A",38,0)
 K %
"RTN","PSOERX1A",39,0)
 Q
"RTN","PSOERX1A",40,0)
L(DFN,DIS) ; 
"RTN","PSOERX1A",41,0)
 I $G(PSONOLCK) Q 1
"RTN","PSOERX1A",42,0)
 N FLAG S ^XTMP("PSOERXLOCK",0)=$$PDATE
"RTN","PSOERX1A",43,0)
 I '$D(^XTMP("PSOERXLOCK",DFN)) D  Q FLAG
"RTN","PSOERX1A",44,0)
 . D NOW^%DTC S ^XTMP("PSOERXLOCK",DFN)=DUZ_"^"_%
"RTN","PSOERX1A",45,0)
 . L +^XTMP("PSOERXLOCK",DFN):$S($G(DILOCKTM)>0:DILOCKTM,1:3) S FLAG=$S($T=1:$T,1:0)
"RTN","PSOERX1A",46,0)
 . I FLAG D
"RTN","PSOERX1A",47,0)
 . . S FDA(52.46,DFN_",",6)=DUZ
"RTN","PSOERX1A",48,0)
 . . D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERX1A",49,0)
 I $D(^XTMP("PSOERXLOCK",DFN)) Q $$R
"RTN","PSOERX1A",50,0)
UL(DFN) ; unlock
"RTN","PSOERX1A",51,0)
 I $G(PSONOLCK) Q
"RTN","PSOERX1A",52,0)
 L -^XTMP("PSOERXLOCK",DFN) K ^XTMP("PSOERXLOCK",DFN)
"RTN","PSOERX1A",53,0)
 Q
"RTN","PSOERX1A",54,0)
 ;
"RTN","PSOERX1A",55,0)
R() ; check lock on node
"RTN","PSOERX1A",56,0)
 ;if user has same patient already locked, Q 1, will only lock once
"RTN","PSOERX1A",57,0)
 I $P($G(^XTMP("PSOERXLOCK",DFN)),"^")=DUZ Q 1
"RTN","PSOERX1A",58,0)
 L +^XTMP("PSOERXLOCK",DFN):$S($G(DILOCKTM)>0:DILOCKTM,1:3)
"RTN","PSOERX1A",59,0)
 I $T=1 D  Q 1
"RTN","PSOERX1A",60,0)
 .D NOW^%DTC S ^XTMP("PSOERXLOCK",DFN)=DUZ_"^"_%
"RTN","PSOERX1A",61,0)
 .S FDA(52.46,DFN_",",6)=DUZ
"RTN","PSOERX1A",62,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERX1A",63,0)
 I $T=0 W:DIS=1 !,$$WHO(DFN) S Y=$P($G(^XTMP("PSOERXLOCK",DFN)),"^",2) X ^DD("DD") Q $S(DIS=0:0_"^"_$P($G(^VA(200,+$P($G(^XTMP("PSOERXLOCK",DFN)),"^"),0)),"^")_"^"_Y,1:0)
"RTN","PSOERX1A",64,0)
 ;
"RTN","PSOERX1A",65,0)
PDATE() ;
"RTN","PSOERX1A",66,0)
 N X1,X2 S X1=DT,X2=+14 D C^%DTC
"RTN","PSOERX1A",67,0)
 Q X_"^"_DT_"^eRx Pharmacy patient locks"
"RTN","PSOERX1A",68,0)
 ;
"RTN","PSOERX1A",69,0)
WHO(DFN) ;
"RTN","PSOERX1A",70,0)
 S Y=$P($G(^XTMP("PSOERXLOCK",DFN)),"^",2) X ^DD("DD")
"RTN","PSOERX1A",71,0)
 Q $P($G(^VA(200,+$P($G(^XTMP("PSOERXLOCK",DFN)),"^"),0)),"^")_" is editing orders for this patient ("_Y_")"
"RTN","PSOERX1A",72,0)
 ;
"RTN","PSOERX1A",73,0)
 ;
"RTN","PSOERX1A",74,0)
 ; TEXT - variable where text is stored (passed by reference)
"RTN","PSOERX1A",75,0)
 ; HDR - header text
"RTN","PSOERX1A",76,0)
 ; DATA - data associated with the header
"RTN","PSOERX1A",77,0)
 ; STRT - start location (column)
"RTN","PSOERX1A",78,0)
 ; LEN - total length for header and data
"RTN","PSOERX1A",79,0)
ADDITEM(TEXT,HDR,DATA,STRT,LEN) ;
"RTN","PSOERX1A",80,0)
 N LLEN,FULLDAT,L
"RTN","PSOERX1A",81,0)
 S FULLDAT=$G(HDR)_$G(DATA)
"RTN","PSOERX1A",82,0)
 S TEXT=$G(TEXT,"") I STRT=1 S TEXT=TEXT_$E(FULLDAT,1,LEN) Q
"RTN","PSOERX1A",83,0)
 S LLEN=$L(TEXT)
"RTN","PSOERX1A",84,0)
 I LLEN<STRT D
"RTN","PSOERX1A",85,0)
 .F L=$L(TEXT):1:STRT-1 D
"RTN","PSOERX1A",86,0)
 ..S TEXT=TEXT_" "
"RTN","PSOERX1A",87,0)
 S TEXT=TEXT_$E(FULLDAT,1,LEN)
"RTN","PSOERX1A",88,0)
 Q
"RTN","PSOERX1A",89,0)
 ; provider information display
"RTN","PSOERX1A",90,0)
PROV ;
"RTN","PSOERX1A",91,0)
 I '$$GET1^DIQ(52.49,PSOIEN,2.3,"I") S XQORM("B")="Edit"
"RTN","PSOERX1A",92,0)
 D EN^PSOERXR1
"RTN","PSOERX1A",93,0)
 Q
"RTN","PSOERX1A",94,0)
 ; patient information display
"RTN","PSOERX1A",95,0)
PAT ;
"RTN","PSOERX1A",96,0)
 I '$$GET1^DIQ(52.49,PSOIEN,.05,"I") S XQORM("B")="Edit"
"RTN","PSOERX1A",97,0)
 D EN^PSOERXP1
"RTN","PSOERX1A",98,0)
 Q
"RTN","PSOERX1A",99,0)
 ; drug information display
"RTN","PSOERX1A",100,0)
DRUG ;
"RTN","PSOERX1A",101,0)
 I '$$GET1^DIQ(52.49,PSOIEN,3.2,"I") S XQORM("B")="Edit"
"RTN","PSOERX1A",102,0)
 D EN^PSOERXD1
"RTN","PSOERX1A",103,0)
 Q
"RTN","PSOERX1A",104,0)
 ; edit validation
"RTN","PSOERX1A",105,0)
 ; EDTYPE - D=drug, P=patient, PR=provider
"RTN","PSOERX1A",106,0)
EDIT(EDTYP,SBN) ;
"RTN","PSOERX1A",107,0)
 N DIR,Y,ITEM,RES,TAG,PQUIT,RXSTAT
"RTN","PSOERX1A",108,0)
 D FULL^VALM1
"RTN","PSOERX1A",109,0)
 S SBN=$G(SBN,"")
"RTN","PSOERX1A",110,0)
 S VALMBCK="R"
"RTN","PSOERX1A",111,0)
 Q:'$G(PSOIEN)
"RTN","PSOERX1A",112,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERX1A",113,0)
 .W !!,"Cannot edit a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERX1A",114,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1A",115,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1A",116,0)
 Q:'$D(EDTYP)
"RTN","PSOERX1A",117,0)
 I EDTYP="D" D  Q
"RTN","PSOERX1A",118,0)
 .D PLSTRNG(1,10,.RES,SBN)
"RTN","PSOERX1A",119,0)
 .I '$O(RES(0)) Q
"RTN","PSOERX1A",120,0)
 .D DERX1^PSOERXD2(PSOIEN,PSOIENS)
"RTN","PSOERX1A",121,0)
 .S (ITEM,PQUIT)=0 F  S ITEM=$O(RES(ITEM)) Q:'ITEM!(PQUIT)  D
"RTN","PSOERX1A",122,0)
 ..S TAG="VDRG"_ITEM_"^PSOERXD2(PSOIEN,PSOIENS)" D @TAG
"RTN","PSOERX1A",123,0)
 .K @VALMAR D INIT^PSOERXD1
"RTN","PSOERX1A",124,0)
 I EDTYP="P" D VPAT K @VALMAR D INIT^PSOERXP1 Q
"RTN","PSOERX1A",125,0)
 I EDTYP="PR" D VPROV K @VALMAR D INIT^PSOERXR1 Q
"RTN","PSOERX1A",126,0)
 Q
"RTN","PSOERX1A",127,0)
 ; edit provider
"RTN","PSOERX1A",128,0)
VPROV ;
"RTN","PSOERX1A",129,0)
 N EXPRVIEN,VAPRVIEN,MANVAL,PRVDAT,EXPRNAME,EXPRLNAM,EXPRFNAM,PSOIENS
"RTN","PSOERX1A",130,0)
 N EXPRIENS,SELPRV,QUIT,VAPNM,NEWPIEN,VANPI,MTYPE
"RTN","PSOERX1A",131,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1A",132,0)
 S VAPNM=$$GET1^DIQ(52.49,PSOIEN,2.3,"E")
"RTN","PSOERX1A",133,0)
 S EXPRVIEN=$$GET1^DIQ(52.49,PSOIEN,2.1,"I")
"RTN","PSOERX1A",134,0)
 S EXPRIENS=EXPRVIEN_","
"RTN","PSOERX1A",135,0)
 D GETS^DIQ(52.48,EXPRIENS,".01;.02;.03;1.5;1.6","E","PRVDAT")
"RTN","PSOERX1A",136,0)
 S EXPRNAME=$G(PRVDAT(52.48,EXPRIENS,.01,"E"))
"RTN","PSOERX1A",137,0)
 S EXPRLNAM=$G(PRVDAT(52.48,EXPRIENS,.02,"E"))
"RTN","PSOERX1A",138,0)
 S EXPRFNAM=$G(PRVDAT(52.48,EXPRIENS,.03,"E"))
"RTN","PSOERX1A",139,0)
 S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.3,"I")
"RTN","PSOERX1A",140,0)
 S MTYPE=$$GET1^DIQ(52.49,PSOIEN,.08,"I")
"RTN","PSOERX1A",141,0)
 S VAPIEN=$$GET1^DIQ(52.49,PSOIEN,2.3,"I")
"RTN","PSOERX1A",142,0)
 I VAPIEN D  Q
"RTN","PSOERX1A",143,0)
 .W !,"Current Vista provider: "_VAPNM,!
"RTN","PSOERX1A",144,0)
 .S DIR(0)="YO",DIR("A")="Would you like to modify the current provider"
"RTN","PSOERX1A",145,0)
 .I MANVAL S DIR("A",1)="This provider has already been validated."
"RTN","PSOERX1A",146,0)
 .S DIR("B")="NO" D ^DIR
"RTN","PSOERX1A",147,0)
 .Q:'Y
"RTN","PSOERX1A",148,0)
 .S DIC=200,DIC("A")="Select PROVIDER NAME: ",DIC(0)="AEMQ",DIC("S")="I $$CHKPRV2^PSOERX1A(Y)" D ^DIC
"RTN","PSOERX1A",149,0)
 .Q:Y<1
"RTN","PSOERX1A",150,0)
 .S NEWPIEN=$P(Y,U) K Y
"RTN","PSOERX1A",151,0)
 .S ERXMMFLG=$$PRVWARN(PSOIEN,VAPIEN)
"RTN","PSOERX1A",152,0)
 .S DIR(0)="Y",DIR("A")="Would you like to use this provider"
"RTN","PSOERX1A",153,0)
 .S DIR("A",1)="You have selected provider: "_$$GET1^DIQ(200,NEWPIEN,.01,"E")
"RTN","PSOERX1A",154,0)
 .S DIR("B")=$S(ERXMMFLG:"NO",1:"YES") D ^DIR
"RTN","PSOERX1A",155,0)
 .I Y<1 S QUIT=1 Q
"RTN","PSOERX1A",156,0)
 .; change existing entry
"RTN","PSOERX1A",157,0)
 .S FDA(52.49,PSOIENS,2.3)=NEWPIEN
"RTN","PSOERX1A",158,0)
 .; if the provider is different, clear manual validation
"RTN","PSOERX1A",159,0)
 .I VAPIEN'=NEWPIEN D  Q
"RTN","PSOERX1A",160,0)
 ..S FDA(52.49,PSOIENS,1.3)="",FDA(52.49,PSOIENS,1.8)="",FDA(52.49,PSOIENS,1.9)=""
"RTN","PSOERX1A",161,0)
 ..D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1A",162,0)
 ..I MTYPE="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1A",163,0)
 ..I MTYPE="RE" D UPDSTAT^PSOERXU1(PSOIEN,"RXW")
"RTN","PSOERX1A",164,0)
 ; for now, only list providers that are authorized to write med orders and whose dea is not expired
"RTN","PSOERX1A",165,0)
 S DIC=200,DIC("A")="Select PROVIDER NAME: ",DIC(0)="AEMQ",DIC("S")="I $$CHKPRV2^PSOERX1A(Y)" D ^DIC
"RTN","PSOERX1A",166,0)
 Q:Y<1
"RTN","PSOERX1A",167,0)
 S SELPRV=$P(Y,U)
"RTN","PSOERX1A",168,0)
 S ERXMMFLG=$$PRVWARN(PSOIEN,SELPRV)
"RTN","PSOERX1A",169,0)
 S DIR(0)="Y",DIR("A")="Would you like to use this provider"
"RTN","PSOERX1A",170,0)
 S DIR("A",1)="You have selected provider: "_$$GET1^DIQ(200,SELPRV,.01,"E")
"RTN","PSOERX1A",171,0)
 S DIR("B")=$S(ERXMMFLG:"NO",1:"YES") D ^DIR
"RTN","PSOERX1A",172,0)
 Q:Y<1
"RTN","PSOERX1A",173,0)
 S FDA(52.49,PSOIENS,2.3)=$P(SELPRV,U)
"RTN","PSOERX1A",174,0)
 D FILE^DIE(,"FDA","ERR") K FDA
"RTN","PSOERX1A",175,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1A",176,0)
 ; PSO*7*508 - update status of refill response to RXI - refill response in progress
"RTN","PSOERX1A",177,0)
 I $$GET1^DIQ(52.49,PSOIEN,.08,"I")="RE",$$GET1^DIQ(52.49,PSOIEN,1,"E")="RRN" D UPDSTAT^PSOERXU1(PSOIEN,"RXW")
"RTN","PSOERX1A",178,0)
 Q
"RTN","PSOERX1A",179,0)
PRVWARN(PSOIEN,VAPIEN) ;
"RTN","PSOERX1A",180,0)
 N EXPRVNPI,VANPI,ERXDEA,VADEA,ERXMMFLG,I,ERXMSG,ERXPIEN,EXPRVDEA
"RTN","PSOERX1A",181,0)
 S ERXMMFLG=0
"RTN","PSOERX1A",182,0)
 S ERXPIEN=$$GET1^DIQ(52.49,PSOIEN,2.1,"I")
"RTN","PSOERX1A",183,0)
 S EXPRVNPI=$$GET1^DIQ(52.48,ERXPIEN,1.5,"E")
"RTN","PSOERX1A",184,0)
 S EXPRVDEA=$$GET1^DIQ(52.48,ERXPIEN,1.6,"E")
"RTN","PSOERX1A",185,0)
 I '$G(VAPIEN) S VAPIEN=$$GET1^DIQ(52.49,PSOIEN,2.3,"I") I '$G(VAPIEN) Q 0
"RTN","PSOERX1A",186,0)
 I EXPRVNPI]"",'$D(^VA(200,"ANPI",EXPRVNPI,VAPIEN)) S ERXMMFLG=1,ERXMSG(1)="Provider NPI Mismatch."
"RTN","PSOERX1A",187,0)
 I EXPRVDEA]"",'$D(^VA(200,"PS1",EXPRVDEA,VAPIEN)) S ERXMMFLG=1,ERXMSG(2)="Provider DEA Mismatch."
"RTN","PSOERX1A",188,0)
 I 'ERXMMFLG Q ERXMMFLG
"RTN","PSOERX1A",189,0)
 W !!,"******************************WARNING********************************"
"RTN","PSOERX1A",190,0)
 S I=0 F  S I=$O(ERXMSG(I)) Q:'I  D
"RTN","PSOERX1A",191,0)
 .W !,$G(ERXMSG(I))
"RTN","PSOERX1A",192,0)
 W !,"*********************************************************************"
"RTN","PSOERX1A",193,0)
 Q ERXMMFLG
"RTN","PSOERX1A",194,0)
CHKPRV2(Y) ;
"RTN","PSOERX1A",195,0)
 ;Ref. to ^VA(200 supp. by IA 224
"RTN","PSOERX1A",196,0)
 I '$P($G(^VA(200,Y,"PS")),U) Q 0
"RTN","PSOERX1A",197,0)
 Q 1
"RTN","PSOERX1A",198,0)
 ; validate drug
"RTN","PSOERX1A",199,0)
 ; prompt list or range
"RTN","PSOERX1A",200,0)
 ; LOW - lowest number to prompt for
"RTN","PSOERX1A",201,0)
 ; HIGH - highest number to prompt for
"RTN","PSOERX1A",202,0)
 ; EDIT - returned list of selected values
"RTN","PSOERX1A",203,0)
 ;        EDIT(n1)=""
"RTN","PSOERX1A",204,0)
 ;        EDIT(n2)=""
"RTN","PSOERX1A",205,0)
 ;        EDIT(n3)=""
"RTN","PSOERX1A",206,0)
PLSTRNG(LOW,HIGH,EDIT,SBN) ;
"RTN","PSOERX1A",207,0)
 N DIR,DONE,DONE2,Y,NUMCHK,NUM,VAL,I,LIST
"RTN","PSOERX1A",208,0)
 I '$G(LOW)!'$G(HIGH) S LIST=0 Q
"RTN","PSOERX1A",209,0)
 S DONE=0
"RTN","PSOERX1A",210,0)
 F  D  Q:DONE
"RTN","PSOERX1A",211,0)
 .I $$GET1^DIQ(52.49,PSOIEN,3.2,"I")="" S Y="A"
"RTN","PSOERX1A",212,0)
 .I '$D(Y),'$O(^PS(52.49,PSOIEN,21,0)) S Y="A"
"RTN","PSOERX1A",213,0)
 .I SBN']"",'$D(Y) D
"RTN","PSOERX1A",214,0)
 ..S DIR(0)="FO^",DIR("A")="Which field(s) would you like to edit? ("_LOW_"-"_HIGH_") or 'A'll"
"RTN","PSOERX1A",215,0)
 ..S DIR("?")="Enter a number, range, or a list of numbers (i.e. 3, 1-5, 3,7,9, or 'A'll)"
"RTN","PSOERX1A",216,0)
 ..S DIR("B")="A"
"RTN","PSOERX1A",217,0)
 ..D ^DIR K DIR
"RTN","PSOERX1A",218,0)
 ..I Y="^" S DONE=1 Q
"RTN","PSOERX1A",219,0)
 .;/BLB/ PSO*7.0*527 - BEGIN CHANGE - PREVENTING INVALID VALUES FROM BEING ENTERED IN VD
"RTN","PSOERX1A",220,0)
 .I Y["-",Y["," D  Q
"RTN","PSOERX1A",221,0)
 ..W !!,"Invalid Response."
"RTN","PSOERX1A",222,0)
 ..W !,"Answer must be numeric (1-10), a series of numbers (3,5,7), 'A' or 'ALL'."
"RTN","PSOERX1A",223,0)
 ..S DIR(0)="E" D ^DIR K Y,DIR
"RTN","PSOERX1A",224,0)
 .I (Y[".")!(Y[" ") D  Q
"RTN","PSOERX1A",225,0)
 ..W !!,"Invalid Response."
"RTN","PSOERX1A",226,0)
 ..W !,"Answer must be numeric (1-10), a series of numbers (3,5,7), 'A' or 'ALL'."
"RTN","PSOERX1A",227,0)
 ..S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX1A",228,0)
 ..I Y'[" " K Y
"RTN","PSOERX1A",229,0)
 .;/BLB/ PSO*7.0*527 - END CHANGE
"RTN","PSOERX1A",230,0)
 .I SBN]"",'$D(Y) S Y=SBN
"RTN","PSOERX1A",231,0)
 .Q:Y["."
"RTN","PSOERX1A",232,0)
 .I Y="^" S DONE=1 Q
"RTN","PSOERX1A",233,0)
 .S Y=$$UP^XLFSTR(Y)
"RTN","PSOERX1A",234,0)
 .I Y="A"!(Y="ALL") D  Q
"RTN","PSOERX1A",235,0)
 ..F I=LOW:1:HIGH D
"RTN","PSOERX1A",236,0)
 ...S EDIT(I)=""
"RTN","PSOERX1A",237,0)
 ..S DONE=1
"RTN","PSOERX1A",238,0)
 .; check for a range or list of numbers
"RTN","PSOERX1A",239,0)
 .I Y'["-",Y'[",",Y'<LOW,Y'>HIGH S EDIT(+Y)="" S DONE=1 Q
"RTN","PSOERX1A",240,0)
 .I Y?1.2N1"-"1.2N D
"RTN","PSOERX1A",241,0)
 ..F I=$P(Y,"-"):1:$P(Y,"-",2) D
"RTN","PSOERX1A",242,0)
 ...Q:I<LOW!(I>HIGH)
"RTN","PSOERX1A",243,0)
 ...S EDIT(I)=""
"RTN","PSOERX1A",244,0)
 .I $D(EDIT) S DONE=1 Q
"RTN","PSOERX1A",245,0)
 .I Y["," D
"RTN","PSOERX1A",246,0)
 ..; check to see if there are alpha-numerics if there are, quit and reprompt
"RTN","PSOERX1A",247,0)
 ..S NUMCHK=$TR(Y,",","") I 'NUMCHK W !,"Invalid response." Q
"RTN","PSOERX1A",248,0)
 ..S DONE2=0
"RTN","PSOERX1A",249,0)
 ..F NUM=1:1 D  Q:DONE2
"RTN","PSOERX1A",250,0)
 ...S VAL=$P(Y,",",NUM)
"RTN","PSOERX1A",251,0)
 ...I 'VAL S DONE2=1 Q
"RTN","PSOERX1A",252,0)
 ...I VAL<LOW!(VAL>HIGH) Q
"RTN","PSOERX1A",253,0)
 ...S EDIT(VAL)=""
"RTN","PSOERX1A",254,0)
 .I $D(EDIT) S DONE=1 Q
"RTN","PSOERX1A",255,0)
 .W !,"Invalid Response."
"RTN","PSOERX1A",256,0)
 .W !,"Answer must be numeric (1-10), a series of numbers (3,5,7), 'A' or 'ALL'."
"RTN","PSOERX1A",257,0)
 .S DIR(0)="E" D ^DIR K Y,DIR
"RTN","PSOERX1A",258,0)
 .;S DONE=1
"RTN","PSOERX1A",259,0)
 Q
"RTN","PSOERX1A",260,0)
 ; validate patient
"RTN","PSOERX1A",261,0)
VPAT ;
"RTN","PSOERX1A",262,0)
 N ERXPIEN,VAPIEN,MANVAL,ERXLNAME,ERXFNAME,DIR,Y,PSOIENS,VAPIEN,MANVAL,DIR,DIC,SELPAT,PDONE,DFN,I,VADM
"RTN","PSOERX1A",263,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1A",264,0)
 S ERXPIEN=$$GET1^DIQ(52.49,PSOIEN,.04,"I")
"RTN","PSOERX1A",265,0)
 S ERXLNAME=$$GET1^DIQ(52.46,ERXPIEN,.02,"E")
"RTN","PSOERX1A",266,0)
 S ERXFNAME=$$GET1^DIQ(52.46,ERXPIEN,.03,"E")
"RTN","PSOERX1A",267,0)
 S VAPIEN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERX1A",268,0)
 S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.7,"I")
"RTN","PSOERX1A",269,0)
 ; if there is a patient currently defined
"RTN","PSOERX1A",270,0)
 I VAPIEN D  Q
"RTN","PSOERX1A",271,0)
 .W !,"Current Vista patient: "_$$GET1^DIQ(2,VAPIEN,.01,"E"),!
"RTN","PSOERX1A",272,0)
 .S DIR(0)="YO",DIR("A")="Would you like to edit the patient"
"RTN","PSOERX1A",273,0)
 .S DIR("A",1)="A patient has already matched to a vista patient."
"RTN","PSOERX1A",274,0)
 .S DIR("B")="NO" D ^DIR
"RTN","PSOERX1A",275,0)
 .Q:Y'=1
"RTN","PSOERX1A",276,0)
 .S DIC(0)="AEMQ",SELPAT=$$PATPRMT() K DUOUT Q:'SELPAT
"RTN","PSOERX1A",277,0)
 .S DFN=SELPAT D DEM^VADPT
"RTN","PSOERX1A",278,0)
 .I $P($G(VADM(6)),U)]"" W "[PATIENT DIED ON "_$P($G(VADM(6)),U,2)_"]" Q
"RTN","PSOERX1A",279,0)
 .S ERXMMFLG=$$PATWARN(PSOIEN,SELPAT)
"RTN","PSOERX1A",280,0)
 .S DIR(0)="Y",DIR("A")="Would you like to use this patient"
"RTN","PSOERX1A",281,0)
 .S DIR("A",1)="You have selected patient: "_$$GET1^DIQ(2,SELPAT,.01,"E")
"RTN","PSOERX1A",282,0)
 .S DIR("B")=$S($G(ERXMMFLG):"NO",1:"YES") D ^DIR
"RTN","PSOERX1A",283,0)
 .Q:Y'=1
"RTN","PSOERX1A",284,0)
 .; change existing entry
"RTN","PSOERX1A",285,0)
 .S FDA(52.49,PSOIENS,.05)=SELPAT
"RTN","PSOERX1A",286,0)
 .I SELPAT'=VAPIEN D  Q
"RTN","PSOERX1A",287,0)
 ..S FDA(52.49,PSOIENS,1.7)="",FDA(52.49,PSOIENS,1.13)="",FDA(52.49,PSOIENS,1.14)=""
"RTN","PSOERX1A",288,0)
 ..D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1A",289,0)
 ..D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1A",290,0)
 .I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1A",291,0)
 S DIC(0)="AEMQ",SELPAT=$$PATPRMT() K DUOUT I 'SELPAT S XQORM("B")="Edit" Q
"RTN","PSOERX1A",292,0)
 S DFN=SELPAT D DEM^VADPT
"RTN","PSOERX1A",293,0)
 I $P($G(VADM(6)),U)]"" W "[PATIENT DIED ON "_$P($G(VADM(6)),U,2)_"]" S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX1A",294,0)
 S ERXMMFLG=$$PATWARN(PSOIEN,SELPAT)
"RTN","PSOERX1A",295,0)
 S DIR(0)="Y",DIR("A")="Would you like to use this patient"
"RTN","PSOERX1A",296,0)
 S DIR("A",1)="You have selected patient: "_$$GET1^DIQ(2,SELPAT,.01,"E")
"RTN","PSOERX1A",297,0)
 S DIR("B")=$S($G(ERXMMFLG):"NO",1:"YES") D ^DIR
"RTN","PSOERX1A",298,0)
 I Y'=1 S XQORM("B")="Edit" Q
"RTN","PSOERX1A",299,0)
 S FDA(52.49,PSOIENS,.05)=SELPAT
"RTN","PSOERX1A",300,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1A",301,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1A",302,0)
 Q
"RTN","PSOERX1A",303,0)
PATWARN(PSOIEN,SELPAT) ;
"RTN","PSOERX1A",304,0)
 N ERXPIEN,ERXSSN,ERXDOB,ERXGEN,ERXMMFLG,ERXMSG,EXPRVDEA
"RTN","PSOERX1A",305,0)
 S ERXMMFLG=0
"RTN","PSOERX1A",306,0)
 S ERXPIEN=$$GET1^DIQ(52.49,PSOIEN,.04,"I")
"RTN","PSOERX1A",307,0)
 S ERXSSN=$$GET1^DIQ(52.46,ERXPIEN,1.4,"E"),ERXSSN=$TR(ERXSSN,"-","")
"RTN","PSOERX1A",308,0)
 S ERXDOB=$$GET1^DIQ(52.46,ERXPIEN,.08,"I")
"RTN","PSOERX1A",309,0)
 S ERXGEN=$$GET1^DIQ(52.46,ERXPIEN,.07,"I")
"RTN","PSOERX1A",310,0)
 ; if the selected patient is not defined, use the va matched patient because we are doing this check
"RTN","PSOERX1A",311,0)
 ; during accept validation
"RTN","PSOERX1A",312,0)
 I '$G(SELPAT) S SELPAT=$$GET1^DIQ(52.49,PSOIEN,.05,"I") Q:'$G(SELPAT) 0
"RTN","PSOERX1A",313,0)
 I '$D(VADM) S DFN=SELPAT D DEM^VADPT
"RTN","PSOERX1A",314,0)
 I ERXSSN,'$D(^DPT("SSN",ERXSSN,SELPAT)) S ERXMMFLG=1,ERXMSG(1)="SSN mismatch."
"RTN","PSOERX1A",315,0)
 I ERXDOB,'$D(^DPT("ADOB",ERXDOB,SELPAT)) S ERXMMFLG=1,ERXMSG(2)="Date of Birth mismatch."
"RTN","PSOERX1A",316,0)
 I ERXGEN]"",$P($G(VADM(5)),U)'=ERXGEN S ERXMMFLG=1,ERXMSG(3)="Gender mismatch."
"RTN","PSOERX1A",317,0)
 Q:'ERXMMFLG 0
"RTN","PSOERX1A",318,0)
 W !!,"******************************WARNING********************************"
"RTN","PSOERX1A",319,0)
 S I=0 F  S I=$O(ERXMSG(I)) Q:'I  D
"RTN","PSOERX1A",320,0)
 .W !,$G(ERXMSG(I))
"RTN","PSOERX1A",321,0)
 W !,"*********************************************************************"
"RTN","PSOERX1A",322,0)
 Q 1
"RTN","PSOERX1A",323,0)
PATPRMT() ;
"RTN","PSOERX1A",324,0)
 N Y
"RTN","PSOERX1A",325,0)
 D ^DPTLK
"RTN","PSOERX1A",326,0)
 I $P(Y,U)<1 Q 0
"RTN","PSOERX1A",327,0)
 Q $P(Y,U)
"RTN","PSOERX1B")
0^26^B200556396^B162952220
"RTN","PSOERX1B",1,0)
PSOERX1B ;ALB/BWF - Accept eRx function ; 8/3/2016 5:14pm
"RTN","PSOERX1B",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,506,520,527,508**;DEC 1997;Build 295
"RTN","PSOERX1B",3,0)
 ;
"RTN","PSOERX1B",4,0)
 Q
"RTN","PSOERX1B",5,0)
ACVAL(PSOIEN,TYPE) ;
"RTN","PSOERX1B",6,0)
 N F,VBFLD,VBDTTMF,DIR,TAG,VALPAR,VAL,CURVAL,MVFLD,VBFLD,VBDTTMF,PSOIENS,RXSTAT,QFLG,VDTTM,ERXMMFLG,RXTYPE
"RTN","PSOERX1B",7,0)
 S F=52.49,PSOIENS=PSOIEN_","
"RTN","PSOERX1B",8,0)
 D FULL^VALM1
"RTN","PSOERX1B",9,0)
 S VALMBCK="R"
"RTN","PSOERX1B",10,0)
 ; first check to see if the entry exists. cannot validate something that has no value
"RTN","PSOERX1B",11,0)
 S RXTYPE=$$GET1^DIQ(52.49,PSOIEN,.08,"I")
"RTN","PSOERX1B",12,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERX1B",13,0)
 .W !!,"Cannot accept validation for a prescription with a status of 'Rejected',",!,"'Removed',or 'Processed",!
"RTN","PSOERX1B",14,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",15,0)
 Q:TYPE']""
"RTN","PSOERX1B",16,0)
 S TAG=$S(TYPE="P":"patient",TYPE="PR":"provider",TYPE="D":"drug",1:"")
"RTN","PSOERX1B",17,0)
 S VALPAR=$S(TYPE="P":.05,TYPE="PR":2.3,TYPE="D":3.2,1:"") Q:VALPAR=""
"RTN","PSOERX1B",18,0)
 S VAL=$$GET1^DIQ(F,PSOIEN,VALPAR,"I") I 'VAL D  Q
"RTN","PSOERX1B",19,0)
 .W !,"Vista "_TAG_" has not been matched. Cannot manually validate."
"RTN","PSOERX1B",20,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",21,0)
 S MVFLD=$S(TYPE="P":1.7,TYPE="PR":1.3,TYPE="D":1.5,1:"")
"RTN","PSOERX1B",22,0)
 S VBFLD=$S(TYPE="P":1.13,TYPE="PR":1.8,TYPE="D":1.11,1:"")
"RTN","PSOERX1B",23,0)
 S VBDTTMF=$S(TYPE="P":1.14,TYPE="PR":1.9,TYPE="D":1.12,1:"")
"RTN","PSOERX1B",24,0)
 ; check to see if this is already validated
"RTN","PSOERX1B",25,0)
 I MVFLD S CURVAL=$$GET1^DIQ(F,PSOIEN,MVFLD,"I")
"RTN","PSOERX1B",26,0)
 I CURVAL D  Q
"RTN","PSOERX1B",27,0)
 .W !!,"This "_TAG_" has already been manually validated."
"RTN","PSOERX1B",28,0)
 .W !,"Validated By: "_$$GET1^DIQ(F,PSOIEN,VBFLD,"E")
"RTN","PSOERX1B",29,0)
 .W !,"Validated Date/Time: "_$$GET1^DIQ(F,PSOIEN,VBDTTMF,"E"),!
"RTN","PSOERX1B",30,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",31,0)
 S QFLG=0
"RTN","PSOERX1B",32,0)
 I TYPE="D" D
"RTN","PSOERX1B",33,0)
 .W !
"RTN","PSOERX1B",34,0)
 .I '$O(^PS(52.49,PSOIEN,21,0)) W !,"Dosing information missing." S QFLG=1
"RTN","PSOERX1B",35,0)
 .I $$GET1^DIQ(52.49,PSOIEN,20.1,"E")="" W !,"Quantity missing." S QFLG=1
"RTN","PSOERX1B",36,0)
 .I $$GET1^DIQ(52.49,PSOIEN,20.2,"E")="" W !,"Days supply missing." S QFLG=1
"RTN","PSOERX1B",37,0)
 .;I $$GET1^DIQ(52.49,PSOIEN,20.5,"E")="" W !,"Refills missing."  S QFLG=1
"RTN","PSOERX1B",38,0)
 .I QFLG=1 D
"RTN","PSOERX1B",39,0)
 ..W !!,"Cannot validate drug information."
"RTN","PSOERX1B",40,0)
 ..S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX1B",41,0)
 Q:QFLG
"RTN","PSOERX1B",42,0)
 I TYPE="P" S ERXMMFLG=$$PATWARN^PSOERX1A(PSOIEN)
"RTN","PSOERX1B",43,0)
 I TYPE="PR" S ERXMMFLG=$$PRVWARN^PSOERX1A(PSOIEN)
"RTN","PSOERX1B",44,0)
 W !,"Would you like to mark this "_TAG_" as VALIDATED?"
"RTN","PSOERX1B",45,0)
 S DIR(0)="Y",DIR("B")=$S($G(ERXMMFLG):"NO",1:"YES") D ^DIR Q:Y'=1
"RTN","PSOERX1B",46,0)
 K FDA,DIR
"RTN","PSOERX1B",47,0)
 S VDTTM=$$NOW^XLFDT
"RTN","PSOERX1B",48,0)
 I MVFLD S FDA(F,PSOIENS,MVFLD)=1
"RTN","PSOERX1B",49,0)
 I VBFLD S FDA(F,PSOIENS,VBFLD)=$G(DUZ)
"RTN","PSOERX1B",50,0)
 I VBDTTMF S FDA(F,PSOIENS,VBDTTMF)=VDTTM
"RTN","PSOERX1B",51,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1B",52,0)
 I $D(FDA) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",53,0)
 W !,"Validation Updated!!" S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",54,0)
 ;/BLB/ PSO*7.0*527 - BEGIN CHANGE - VALIDATION/WAIT STATUS CHECK
"RTN","PSOERX1B",55,0)
 ; check validations and update status to 'wait' if all validations have occured.
"RTN","PSOERX1B",56,0)
 I MTYPE="N" D
"RTN","PSOERX1B",57,0)
 .I $$GET1^DIQ(52.49,PSOIEN,1.3,"I"),$$GET1^DIQ(52.49,PSOIEN,1.5,"I"),$$GET1^DIQ(52.49,PSOIEN,1.7,"I") D
"RTN","PSOERX1B",58,0)
 ..D UPDSTAT^PSOERXU1(PSOIEN,"W")
"RTN","PSOERX1B",59,0)
 .;/BLB/ - PSO*7.0*527 END CHANGE
"RTN","PSOERX1B",60,0)
 I MTYPE="RE" D UPDSTAT^PSOERXU1(PSOIEN,"RXW")
"RTN","PSOERX1B",61,0)
 I TYPE="P" D BPROC(PSOIEN,"PA",MVFLD,VBFLD,VBDTTMF,VDTTM) K @VALMAR D INIT^PSOERXP1
"RTN","PSOERX1B",62,0)
 I TYPE="PR" D BPROC(PSOIEN,"PR",MVFLD,VBFLD,VBDTTMF,VDTTM) K @VALMAR D INIT^PSOERXR1
"RTN","PSOERX1B",63,0)
 I TYPE="D" K @VALMAR D INIT^PSOERXD1
"RTN","PSOERX1B",64,0)
 Q
"RTN","PSOERX1B",65,0)
BPROC(PSOIEN,BTYPE,MVFLD,VBFLD,VBDTTMF,VDTTM) ;
"RTN","PSOERX1B",66,0)
 N ERXPAT,ERXSTAT,ERESTAT,ERXDT,ERXIEN,ERXARY,DIR,Y,L,LINE,CNT,EHID,EDRUG,EPROV,EPAT,ERXRDT,ERXRECDT,ERXEDT,I
"RTN","PSOERX1B",67,0)
 N REXEDT,EEPROV,ERXPROV,EXARY
"RTN","PSOERX1B",68,0)
 S ERXPAT=$$GET1^DIQ(52.49,PSOIEN,.04,"I") Q:'ERXPAT
"RTN","PSOERX1B",69,0)
 S ERXPROV=$$GET1^DIQ(52.49,PSOIEN,2.1,"I")
"RTN","PSOERX1B",70,0)
 S ERXRECDT=$P($$GET1^DIQ(52.49,PSOIEN,.03,"I"),".")
"RTN","PSOERX1B",71,0)
 S ERXEDT=ERXRECDT_".2359"
"RTN","PSOERX1B",72,0)
 S ERXSTAT=0 F  S ERXSTAT=$O(^PS(52.49,"PAT",PSNPINST,ERXSTAT)) Q:'ERXSTAT  D
"RTN","PSOERX1B",73,0)
 .S ERESTAT=$$GET1^DIQ(52.45,ERXSTAT,.01,"E")
"RTN","PSOERX1B",74,0)
 .; do not consider rx's that are rejected, removed, processed.
"RTN","PSOERX1B",75,0)
 .I ERESTAT="PR"!(ERESTAT="RM")!(ERESTAT="RJ")!(ERESTAT="CAN") Q
"RTN","PSOERX1B",76,0)
 .S ERXDT=ERXRECDT-.0001 F  S ERXDT=$O(^PS(52.49,"PAT",PSNPINST,ERXSTAT,ERXPAT,ERXDT)) Q:ERXDT>ERXEDT!(ERXDT="")  D
"RTN","PSOERX1B",77,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"PAT",PSNPINST,ERXSTAT,ERXPAT,ERXDT,ERXIEN)) Q:'ERXIEN  D
"RTN","PSOERX1B",78,0)
 ...; do not process any rx's that are not a 'newRx'.
"RTN","PSOERX1B",79,0)
 ...I $$GET1^DIQ(52.49,ERXIEN,.08,"I")'="N" Q
"RTN","PSOERX1B",80,0)
 ...;/BLB/ PSO*7.0*520 -  BEGIN CHANGE
"RTN","PSOERX1B",81,0)
 ...Q:PSOIEN=ERXIEN
"RTN","PSOERX1B",82,0)
 ...;/BLB/ PSO*7.0*520 - END CHANGE
"RTN","PSOERX1B",83,0)
 ...I BTYPE="PR",$$GET1^DIQ(52.49,ERXIEN,2.1,"I")'=ERXPROV Q
"RTN","PSOERX1B",84,0)
 ...S EXARY(ERXIEN)=""
"RTN","PSOERX1B",85,0)
 I '$O(EXARY(0)) Q
"RTN","PSOERX1B",86,0)
 W !!
"RTN","PSOERX1B",87,0)
 I BTYPE="PA" D
"RTN","PSOERX1B",88,0)
 .W !,"This patient has other prescriptions for: "_$$FMTE^XLFDT(ERXRECDT)
"RTN","PSOERX1B",89,0)
 .W !,"Patient: "_$$GET1^DIQ(52.46,ERXPAT,.01,"E")
"RTN","PSOERX1B",90,0)
 I BTYPE="PR" D
"RTN","PSOERX1B",91,0)
 .W !,"There are other prescriptions for this patient, written by this provider on"
"RTN","PSOERX1B",92,0)
 .W !,$$FMTE^XLFDT(ERXRECDT)
"RTN","PSOERX1B",93,0)
 .W !,"Provider: "_$$GET1^DIQ(52.48,ERXPROV,.01,"E")
"RTN","PSOERX1B",94,0)
 .W !,"Patient: "_$$GET1^DIQ(52.46,ERXPAT,.01,"E")
"RTN","PSOERX1B",95,0)
 W !!,?4,"DRUG",?30,"PROVIDER",?60,"REC DATE"
"RTN","PSOERX1B",96,0)
 S $P(LINE,"-",80)="" W !,LINE
"RTN","PSOERX1B",97,0)
 S L=0,CNT=0 F  S L=$O(EXARY(L)) Q:'L  D
"RTN","PSOERX1B",98,0)
 .S CNT=CNT+1
"RTN","PSOERX1B",99,0)
 .S EHID=$$GET1^DIQ(52.49,L,.01,"E")
"RTN","PSOERX1B",100,0)
 .S EDRUG=$$GET1^DIQ(52.49,L,3.1,"E")
"RTN","PSOERX1B",101,0)
 .S EEPROV=$$GET1^DIQ(52.49,L,2.1,"I")
"RTN","PSOERX1B",102,0)
 .S EPROV=$$GET1^DIQ(52.48,EEPROV,.01,"E")
"RTN","PSOERX1B",103,0)
 .S EPAT=$$GET1^DIQ(52.46,ERXPAT,.01,"E")
"RTN","PSOERX1B",104,0)
 .S ERXRDT=$P($$GET1^DIQ(52.49,L,.03,"E"),"@")
"RTN","PSOERX1B",105,0)
 .W !,CNT_".) "_$E(EDRUG,1,28),?30,$E(EPROV,1,28),?60,ERXRDT
"RTN","PSOERX1B",106,0)
 W !!,"Would you like apply the above validation to these prescriptions?"
"RTN","PSOERX1B",107,0)
 K Y S DIR(0)="YO"
"RTN","PSOERX1B",108,0)
 S DIR("B")="N" D ^DIR K DIR
"RTN","PSOERX1B",109,0)
 I Y="^"!(Y=0) Q
"RTN","PSOERX1B",110,0)
 S I=0 F  S I=$O(EXARY(I)) Q:'I  D
"RTN","PSOERX1B",111,0)
 .I BTYPE="PA" S FDA(52.49,I_",",.05)=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERX1B",112,0)
 .I BTYPE="PR" S FDA(52.49,I_",",2.3)=$$GET1^DIQ(52.49,PSOIEN,2.3,"I")
"RTN","PSOERX1B",113,0)
 .S FDA(52.49,I_",",MVFLD)=1,FDA(52.49,I_",",VBFLD)=$G(DUZ),FDA(52.49,I_",",VBDTTMF)=VDTTM
"RTN","PSOERX1B",114,0)
 .D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",115,0)
 .I $$GET1^DIQ(52.49,I,1,"E")="N" D UPDSTAT^PSOERXU1(I,"I")
"RTN","PSOERX1B",116,0)
 .;/BLB/ PSO*7.0*527 - BEGIN CHANGE - BULK PROCESSING/WAIT STATUS CHECK
"RTN","PSOERX1B",117,0)
 .I $$GET1^DIQ(52.49,I,1.3,"I"),$$GET1^DIQ(52.49,I,1.5,"I"),$$GET1^DIQ(52.49,I,1.7,"I") D
"RTN","PSOERX1B",118,0)
 ..D UPDSTAT^PSOERXU1(I,"W")
"RTN","PSOERX1B",119,0)
 .;/BLB/ -  PSO*7.0*527 END CHANGE
"RTN","PSOERX1B",120,0)
 Q
"RTN","PSOERX1B",121,0)
 ;PSOHY("LOC")=IEN of hospital location file (#44) - NOT USED, 
"RTN","PSOERX1B",122,0)
 ;PSOHY("CHNUM")=EXTERNAL PLACER ORDER NUMBER (NEED TO FIND OUT HOW WE SHOULD SET THIS) (25)
"RTN","PSOERX1B",123,0)
 ;PSOHY("PICK")=MAIL/WINDOW (20.4) 
"RTN","PSOERX1B",124,0)
 ;PSOHY("ENTER")=ENTERED BY IEN (2.1)
"RTN","PSOERX1B",125,0)
 ;PSOHY("PROV")=PROVIDER IEN (2.3)
"RTN","PSOERX1B",126,0)
 ;PSOHY("SDT")=EFFECTIVE DATE (6.3)
"RTN","PSOERX1B",127,0)
 ;PSOHY("ITEM")=PHARMACY ORDERABLE ITEM (DERIVED FROM THE DRUG IEN) - NO MAPPING TO 52.49
"RTN","PSOERX1B",128,0)
 ;PSOHY("DRUG")=DRUG IEN (3.2)
"RTN","PSOERX1B",129,0)
 ;PSOHY("QTY")=QUANTITY (20.1)
"RTN","PSOERX1B",130,0)
 ;PSOHY("REF")=# OF REFILLS (20.5)
"RTN","PSOERX1B",131,0)
 ;PSOHY("PAT")=PATIENT IEN (.05)
"RTN","PSOERX1B",132,0)
 ;PSOHY("OCC")=ORDER TYPE (ALWAYS 'NW') - NO MAPPING TO 52.49
"RTN","PSOERX1B",133,0)
 ;PSOHY("EDT")=LOGIN DATE (TODAYS DATE) - NO MAPPING TO 52.49
"RTN","PSOERX1B",134,0)
 ;PSOHY("PRIOR")=PRIORITY (SET OF CODES, 52.41,25 - STAT, EMERGENCY, ROUTINE)
"RTN","PSOERX1B",135,0)
 ;PSOHY("EXAPP")=EXTERNAL APPLICATION (FREE TEXT), LIKELY "PSO" - NO MAPPING TO 52.49
"RTN","PSOERX1B",136,0)
 ;PSOHY("PRCOM",#)=PROVIDER COMMENTS (8- NOTES)
"RTN","PSOERX1B",137,0)
 ;PSOHY("SIG",#)=SIG (52.4911 (STRUCTURED SIG), FIELD 1 (SIG FREE TEXT)
"RTN","PSOERX1B",138,0)
 ;PSOHY("QTSUB",CNT)=QUANTITY TIMING SUBFILE DATA. MERGED IN, FULL SUBFILE DATA
"RTN","PSOERX1B",139,0)
 ; QUANTITY/TIMING MAPS DIRECTLY TO QUANTITY TIMING IN 52.41
"RTN","PSOERX1B",140,0)
SETUP ;
"RTN","PSOERX1B",141,0)
 N PSOIENS,PSODAT,F,PATIEN,PROVIEN,OC,VQTY,EFFDT,VADRUG,VAOI,VAREF,VAROUT,VAPRIOR,PSOHY,LOC,ERXNUM,PRVARY,PRVCOMM
"RTN","PSOERX1B",142,0)
 N PLOOP,PCNT,QTLOOP,QTCNT,PSOEXMS,DIR,ORDERTYP,PSOEXCNT,SCNT,SIGDAT,SLOOP,POORD,PMVAL,PRMVAL,DMVAL,PATINST,RXSTAT
"RTN","PSOERX1B",143,0)
 N VADAYS,UNEXPI,PINARY,WRITDT,SLOOP2,MTYPE,REQIEN,ORXIEN,RESTYPE,DELTAS,RXIEN
"RTN","PSOERX1B",144,0)
 S F=52.49
"RTN","PSOERX1B",145,0)
 Q:'$G(PSOIEN)
"RTN","PSOERX1B",146,0)
 D FULL^VALM1
"RTN","PSOERX1B",147,0)
 S VALMBCK="R"
"RTN","PSOERX1B",148,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERX1B",149,0)
 .W !!,"Cannot accept a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERX1B",150,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",151,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1B",152,0)
 D GETS^DIQ(F,PSOIENS,".01;.05;.07;.08;1;1.3;1.5;1.7;2.1;2.3;3.2;5.9;6.2;6.3;8;20.1;20.2;20.4;20.5;20.6;25;25.2;27;30;52.1","IE","PSODAT")
"RTN","PSOERX1B",153,0)
 S PSOEXCNT=0
"RTN","PSOERX1B",154,0)
 S MTYPE=$G(PSODAT(F,PSOIENS,.08,"I"))
"RTN","PSOERX1B",155,0)
 S RESTYPE=$G(PSODAT(F,PSOIENS,52.1,"I"))
"RTN","PSOERX1B",156,0)
 I MTYPE="RE" D  Q
"RTN","PSOERX1B",157,0)
 .S REQIEN=$$GETREQ^PSOERXU2(PSOIEN)
"RTN","PSOERX1B",158,0)
 .I REQIEN S RXIEN=$$GET1^DIQ(52.49,REQIEN,.13,"I")
"RTN","PSOERX1B",159,0)
 .D PREFRES^PSOERXU3(PSOIEN,.PSOHY,.PSOEXCNT,.PSOEXMS,.PSODAT)
"RTN","PSOERX1B",160,0)
 .D RRDELTA^PSOERXU2(.DELTAS,REQIEN,PSOIEN)
"RTN","PSOERX1B",161,0)
 .I $O(PSOEXMS(0)),RESTYPE="AWC",$D(DELTAS(52.49,"EXTERNAL PROVIDER")) D  Q
"RTN","PSOERX1B",162,0)
 ..D MSGDIR^PSOERXU1(.PSOEXMS)
"RTN","PSOERX1B",163,0)
 .I $O(PSOEXMS(0)),$E(RESTYPE)="A",'$D(DELTAS(52.49,"EXTERNAL PROVIDER")) D  Q
"RTN","PSOERX1B",164,0)
 ..D UPDSTAT^PSOERXU1(PSOIEN,"RXF","Unable to add order to Pending file.") Q
"RTN","PSOERX1B",165,0)
 .I $D(DELTAS(52.49,"EXTERNAL PROVIDER")) D ADD Q
"RTN","PSOERX1B",166,0)
 .; call using silent mode if this is auto-processing
"RTN","PSOERX1B",167,0)
 .D ADD(1)
"RTN","PSOERX1B",168,0)
 S ERXSTA=$G(PSODAT(F,PSOIENS,1,"E")) I ERXSTA="E"!($E(ERXSTA)="H") S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="eRx is in a 'Hold' status." D MSGDIR^PSOERXU1(.PSOEXMS) Q
"RTN","PSOERX1B",169,0)
 I MTYPE="N" D
"RTN","PSOERX1B",170,0)
 .S PMVAL=$G(PSODAT(F,PSOIENS,1.7,"I")) I 'PMVAL S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Patient has not been manually validated."
"RTN","PSOERX1B",171,0)
 .S PRMVAL=$G(PSODAT(F,PSOIENS,1.3,"I")) I 'PRMVAL S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Provider has not been manually validated."
"RTN","PSOERX1B",172,0)
 .S DMVAL=$G(PSODAT(F,PSOIENS,1.5,"I")) I 'DMVAL S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Drug has not been manually validated."
"RTN","PSOERX1B",173,0)
 ; for now, if validations have not occurred, do not check the other fields.
"RTN","PSOERX1B",174,0)
 I $O(PSOEXMS(0)) D MSGDIR^PSOERXU1(.PSOEXMS) Q
"RTN","PSOERX1B",175,0)
 S POORD=$G(PSODAT(F,PSOIENS,25.2,"I")) I POORD S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Pending outpatient order already exists."
"RTN","PSOERX1B",176,0)
 S PATIEN=$G(PSODAT(F,PSOIENS,.05,"I")) I 'PATIEN S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="No matched vista patient."
"RTN","PSOERX1B",177,0)
 S PROVIEN=$G(PSODAT(F,PSOIENS,2.3,"I")) I 'PROVIEN S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Provider not matched to a vista provider."
"RTN","PSOERX1B",178,0)
 S VADRUG=$G(PSODAT(F,PSOIENS,3.2,"I")) I 'VADRUG S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Drug not matched to a vista drug."
"RTN","PSOERX1B",179,0)
 S LOC=$G(PSODAT(F,PSOIENS,20.6,"I"))
"RTN","PSOERX1B",180,0)
 S ERXNUM=$G(PSODAT(F,PSOIENS,.01,"E")) I 'ERXNUM S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="eRx number missing."
"RTN","PSOERX1B",181,0)
 S VQTY=$G(PSODAT(F,PSOIENS,20.1,"E")) I 'VQTY S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Quantity missing."
"RTN","PSOERX1B",182,0)
 S EFFDT=$G(PSODAT(F,PSOIENS,6.3,"I")),WRITDT=$G(PSODAT(F,PSOIENS,5.9,"I"))
"RTN","PSOERX1B",183,0)
 ; if the effective date is passed in and there is no time, add .000001 to the date
"RTN","PSOERX1B",184,0)
 I EFFDT]"" S EFFDT=$P(EFFDT,".")
"RTN","PSOERX1B",185,0)
 I '$L(EFFDT) S EFFDT=WRITDT
"RTN","PSOERX1B",186,0)
 S VADAYS=$G(PSODAT(F,PSOIENS,20.2,"E"))
"RTN","PSOERX1B",187,0)
 S VAOI=$$GET1^DIQ(50,VADRUG,2.1,"I") I 'VAOI S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Orderable item not associated with drug."
"RTN","PSOERX1B",188,0)
 S VAREF=$G(PSODAT(F,PSOIENS,20.5,"E"))
"RTN","PSOERX1B",189,0)
 S VAROUT=$G(PSODAT(F,PSOIENS,20.4,"I")) I '$L(VAROUT) S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Pickup routing missing."
"RTN","PSOERX1B",190,0)
 S PATINST=$G(PSODAT(F,PSOIENS,27,"E"))
"RTN","PSOERX1B",191,0)
 D TXT2ARY^PSOERXD1(.PINARY,$$LSIG^PSOQUTIL(PATINST))
"RTN","PSOERX1B",192,0)
 ; get provider comments from VA PROVIDER COMMENTS field
"RTN","PSOERX1B",193,0)
 S PRVCOMM=$G(PSODAT(F,PSOIENS,30,"E"))
"RTN","PSOERX1B",194,0)
 D TXT2ARY^PSOERXD1(.PRVARY,$$LSIG^PSOQUTIL(PRVCOMM))
"RTN","PSOERX1B",195,0)
 S (PLOOP,PCNT)=0 F  S PLOOP=$O(PRVARY(PLOOP)) Q:'PLOOP  D
"RTN","PSOERX1B",196,0)
 .S PCNT=PCNT+1,PSOHY("PRCOM",PCNT)=$G(PRVARY(PLOOP))
"RTN","PSOERX1B",197,0)
 I '$O(^PS(52.49,PSOIEN,21,0)) S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Dosing information missing."
"RTN","PSOERX1B",198,0)
 S (QTLOOP,QTCNT)=0 F  S QTLOOP=$O(^PS(52.49,PSOIEN,21,QTLOOP)) Q:'QTLOOP  D
"RTN","PSOERX1B",199,0)
 .S QTCNT=QTCNT+1 M PSOHY("QTSUB",QTCNT)=^PS(52.49,PSOIEN,21,QTLOOP)
"RTN","PSOERX1B",200,0)
 ; always 'routine' for now
"RTN","PSOERX1B",201,0)
 S VAPRIOR="R"
"RTN","PSOERX1B",202,0)
 ; always 'new' for this version
"RTN","PSOERX1B",203,0)
 I '$L($G(ORDERTYP)) S ORDERTYP="NW"
"RTN","PSOERX1B",204,0)
 S PSOHY("LOC")=LOC,PSOHY("CHNUM")=$G(ERXNUM)
"RTN","PSOERX1B",205,0)
 S PSOHY("PICK")=VAROUT,PSOHY("ENTER")=PROVIEN
"RTN","PSOERX1B",206,0)
 S PSOHY("PROV")=PROVIEN,PSOHY("SDT")=EFFDT
"RTN","PSOERX1B",207,0)
 S PSOHY("ITEM")=VAOI,PSOHY("DRUG")=VADRUG
"RTN","PSOERX1B",208,0)
 S PSOHY("QTY")=VQTY,PSOHY("REF")=VAREF
"RTN","PSOERX1B",209,0)
 S (PSOHY("PAT"),DFN)=PATIEN,PSOHY("OCC")=ORDERTYP
"RTN","PSOERX1B",210,0)
 ; login date will always be the written date. if there is no written date by chance, use the received date
"RTN","PSOERX1B",211,0)
 S PSOHY("EDT")=DT,PSOHY("PRIOR")=VAPRIOR
"RTN","PSOERX1B",212,0)
 ; ALWAYS PSO as the external application
"RTN","PSOERX1B",213,0)
 S PSOHY("EXAPP")="PHARMACY"
"RTN","PSOERX1B",214,0)
 S PSOHY("DAYS")=VADAYS
"RTN","PSOERX1B",215,0)
 ; sig from eRx
"RTN","PSOERX1B",216,0)
 S (SLOOP,SCNT)=0 F  S SLOOP=$O(^PS(52.49,PSOIEN,"SIG",SLOOP)) Q:'SLOOP  D
"RTN","PSOERX1B",217,0)
 .S SIGDAT=$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0))
"RTN","PSOERX1B",218,0)
 .S SCNT=SCNT+1,PSOHY("SIG",SCNT)=SIGDAT
"RTN","PSOERX1B",219,0)
 S SLOOP2=0 F  S SLOOP2=$O(PINARY(SLOOP2)) Q:'SLOOP2  D
"RTN","PSOERX1B",220,0)
 .S SCNT=SCNT+1,PSOHY("SIG",SCNT)=$G(PINARY(SLOOP2))
"RTN","PSOERX1B",221,0)
 ; if provider, patient or drug is missing, no need to continue.
"RTN","PSOERX1B",222,0)
 ; future consideration - do we need to check more fields?
"RTN","PSOERX1B",223,0)
 ;I $D(PSOEXMS) D MSGDIR^PSOERXU1(.PSOEXMS) Q
"RTN","PSOERX1B",224,0)
 D ADD
"RTN","PSOERX1B",225,0)
 I $G(PSOEXMS)]"" W !,PSOEXMS S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX1B",226,0)
 K DFN
"RTN","PSOERX1B",227,0)
 Q
"RTN","PSOERX1B",228,0)
ADD(QUIET) ;Add CHCS message to Outpatient Pending Orders file
"RTN","PSOERX1B",229,0)
 N PSOHQ,PSOHQT,PSOCPEND,PSOHINI,PSOHINLO,ERXSTA,ORDNUM,ILOOP,IARY,PSSRET
"RTN","PSOERX1B",230,0)
 S (PSOHINI,PSOHINLO)=0 D
"RTN","PSOERX1B",231,0)
 .I $G(PSOHY("LOC")) S PSOHINLO=$P($G(^SC(PSOHY("LOC"),0)),"^",4) I PSOHINLO Q
"RTN","PSOERX1B",232,0)
 .; FUTURE - consider enabling further institution checks. For now the institution is being pulled from either
"RTN","PSOERX1B",233,0)
 .; the institution associated with the hospital location, or below, from the eRx.
"RTN","PSOERX1B",234,0)
 .;I $G(PSOHY("LOC")) S PSOHINI=$P($G(^SC(PSOHY("LOC"),0)),"^",15)
"RTN","PSOERX1B",235,0)
 .;I '$G(PSOHINI) S PSOHINI=$O(^DG(40.8,0))
"RTN","PSOERX1B",236,0)
 .;S PSOHINLO=+$$SITE^VASITE(PSOHINI)
"RTN","PSOERX1B",237,0)
 ; get institution from 52.49 if clinic was not passed in
"RTN","PSOERX1B",238,0)
 I $G(PSOHINLO)<1 S PSOHINLO=$$GET1^DIQ(52.49,PSOIEN,24.1,"I")
"RTN","PSOERX1B",239,0)
 I +$G(PSOHINLO)<1 S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Unable to derive Institution from Clinic." Q
"RTN","PSOERX1B",240,0)
 K DD,DO,DIC S X=PSOHY("CHNUM"),DIC="^PS(52.41,",DIC(0)="L"
"RTN","PSOERX1B",241,0)
 S:$G(PSOHY("PICK"))="" PSOHY("PICK")="M"
"RTN","PSOERX1B",242,0)
 S DIC("DR")="4////"_$G(PSOHY("ENTER"))_";5////"_PSOHY("PROV")_";6////"_$G(PSOHY("SDT"))_";8////"_PSOHY("ITEM")_";11////"_PSOHY("DRUG")
"RTN","PSOERX1B",243,0)
 S DIC("DR")=$G(DIC("DR"))_";12////"_$G(PSOHY("QTY"))_";13////"_$G(PSOHY("REF"))_";22.1////"_$G(PSOHY("PREVORD"))_";101////"_$G(PSOHY("DAYS"))
"RTN","PSOERX1B",244,0)
 D FILE^DICN K DD,DIC,DO I Y<0 D  Q
"RTN","PSOERX1B",245,0)
 .S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Unable to add order to Pending file."
"RTN","PSOERX1B",246,0)
 .I MTYPE="RE" D UPDSTAT^PSOERXU1(PSOIEN,"RXF",PSOEXMS(PSOEXCNT))
"RTN","PSOERX1B",247,0)
 .S REQIEN=$$GETREQ^PSOERXU2(PSOIEN) I REQIEN D UPDSTAT^PSOERXU1(PSOIEN,"RRF",PSOEXMS)
"RTN","PSOERX1B",248,0)
 S PSOCPEND=+Y
"RTN","PSOERX1B",249,0)
 S $P(^PS(52.41,PSOCPEND,0),"^",2)=PSOHY("PAT"),$P(^(0),"^",3)=PSOHY("OCC"),$P(^(0),"^",12)=$G(PSOHY("EDT")),$P(^(0),"^",13)=$G(PSOHY("LOC"))
"RTN","PSOERX1B",250,0)
 S $P(^PS(52.41,PSOCPEND,0),"^",14)=$G(PSOHY("PRIOR")),$P(^(0),"^",17)=$G(PSOHY("PICK"))
"RTN","PSOERX1B",251,0)
 S $P(^PS(52.41,PSOCPEND,"EXT"),"^")=PSOHY("CHNUM"),$P(^("EXT"),"^",2)=0,$P(^("EXT"),"^",3)=PSOHY("EXAPP")
"RTN","PSOERX1B",252,0)
 S DIE="^PS(52.41,",DA=PSOCPEND,DR="104.1///1" D ^DIE K DIE,DA,DR
"RTN","PSOERX1B",253,0)
 ; PSO*7*506
"RTN","PSOERX1B",254,0)
 S FDA(52.41,PSOCPEND_",",104)=$G(PATINST) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",255,0)
 N DA,DIK S DA=PSOCPEND,DIK="^PS(52.41,",DIK(1)="114^C" D EN1^DIK
"RTN","PSOERX1B",256,0)
 I $O(PSOHY("PRCOM",0)) D  I PSOHQT S ^PS(52.41,PSOCPEND,3,0)="^^"_PSOHQT_"^"_PSOHQT_"^"_DT_"^"
"RTN","PSOERX1B",257,0)
 .S PSOHQ="",PSOHQT=0 F  S PSOHQ=$O(PSOHY("PRCOM",PSOHQ)) Q:PSOHQ=""  I $G(PSOHY("PRCOM",PSOHQ))'="" S PSOHQT=PSOHQT+1,^PS(52.41,PSOCPEND,3,PSOHQT,0)=$G(PSOHY("PRCOM",PSOHQ))
"RTN","PSOERX1B",258,0)
 I $O(PSOHY("SIG",0)) D  I PSOHQT S ^PS(52.41,PSOCPEND,"SIG",0)="^52.4124A^"_PSOHQT_"^"_PSOHQT
"RTN","PSOERX1B",259,0)
 .S PSOHQ="",PSOHQT=0 F  S PSOHQ=$O(PSOHY("SIG",PSOHQ)) Q:PSOHQ=""  I $G(PSOHY("SIG",PSOHQ))'="" S PSOHQT=PSOHQT+1,^PS(52.41,PSOCPEND,"SIG",PSOHQT,0)=$G(PSOHY("SIG",PSOHQ))
"RTN","PSOERX1B",260,0)
 S $P(^PS(52.41,PSOCPEND,"INI"),"^")=$G(PSOHINLO)
"RTN","PSOERX1B",261,0)
 ; add quantity/timing subfile information
"RTN","PSOERX1B",262,0)
 I $O(PSOHY("QTSUB",0)) D  I PSOHQT S ^PS(52.41,PSOCPEND,1,0)="^52.413^"_PSOHQT_"^"_PSOHQT
"RTN","PSOERX1B",263,0)
 .S PSOHQ="",PSOHQT=0 F  S PSOHQ=$O(PSOHY("QTSUB",PSOHQ)) Q:PSOHQ=""  D
"RTN","PSOERX1B",264,0)
 ..I $O(PSOHY("QTSUB",PSOHQ,0)) S PSOHQT=PSOHQT+1
"RTN","PSOERX1B",265,0)
 ..S ^PS(52.41,PSOCPEND,1,PSOHQT,0)=PSOHY("QTSUB",PSOHQ,0)
"RTN","PSOERX1B",266,0)
 ..S ^PS(52.41,PSOCPEND,1,PSOHQT,1)=PSOHY("QTSUB",PSOHQ,1)
"RTN","PSOERX1B",267,0)
 ..S ^PS(52.41,PSOCPEND,1,PSOHQT,2)=PSOHY("QTSUB",PSOHQ,2)
"RTN","PSOERX1B",268,0)
 I $O(PINARY(0)) D WP^DIE(52.41,PSOCPEND_",",105,"K","PINARY")
"RTN","PSOERX1B",269,0)
 ;Cross references not set yet preventing Pharmacy from finishing order
"RTN","PSOERX1B",270,0)
 D EN^PSOHLSNC(PSOCPEND,"SN","IP")
"RTN","PSOERX1B",271,0)
 D FULL^VALM1
"RTN","PSOERX1B",272,0)
 ;Just set to DC, don't delete because 52.41 entry would be re-used
"RTN","PSOERX1B",273,0)
 ;I '$P($G(^PS(52.41,PSOCPEND,"EXT")),"^",2) S DA=PSOCPEND,DIK="^PS(52.41," D ^DIK K DIK,DA S PSOEXMS="Unable to send CHCS order to CPRS." D NAK^PSOHLEXC Q
"RTN","PSOERX1B",274,0)
 I '$P($G(^PS(52.41,PSOCPEND,"EXT")),"^",2) D  S $P(^PS(52.41,PSOCPEND,0),"^",3)="DC" S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Unable to send CHCS order to CPRS." Q
"RTN","PSOERX1B",275,0)
 .;x-ref shouldn't be set, but we'll kill them just in case
"RTN","PSOERX1B",276,0)
 .K ^PS(52.41,"AOR",$P(^PS(52.41,PSOCPEND,0),"^",2),+$P($G(^("INI")),"^"),PSOCPEND),^PS(52.41,"AD",$P(^PS(52.41,PSOCPEND,0),"^",12),+$P($G(^("INI")),"^"),PSOCPEND)
"RTN","PSOERX1B",277,0)
 .K ^PS(52.41,"ACL",+$P(^PS(52.41,PSOCPEND,0),"^",13),$P(^(0),"^",12),PSOCPEND),^PS(52.41,"AQ",+$P($G(^PS(52.41,PSOCPEND,0)),"^",21),PSOCPEND)
"RTN","PSOERX1B",278,0)
 .S $P(^PS(52.41,PSOCPEND,4),"^")="External order, unable to successfully transmit to CPRS."
"RTN","PSOERX1B",279,0)
 .I $D(QUIET) S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="External order, unable to successfully transmit to CPRS."
"RTN","PSOERX1B",280,0)
 .I '$D(QUIET) W !!,"External order, unable to successfully transmit to CPRS."
"RTN","PSOERX1B",281,0)
 .I '$D(QUIET) S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",282,0)
 ;Successful transmission to CPRS
"RTN","PSOERX1B",283,0)
 S DA=PSOCPEND,DIK="^PS(52.41," D IX^DIK
"RTN","PSOERX1B",284,0)
 ; add the pending outpatient order number to 52.49 and update status of eRx to PR (Processed)
"RTN","PSOERX1B",285,0)
 S ERXSTA=$O(^PS(52.45,"C","ERX","PR",0))
"RTN","PSOERX1B",286,0)
 S ORDNUM=$P($G(^PS(52.41,PSOCPEND,0)),U)
"RTN","PSOERX1B",287,0)
 S DIE="^PS(52.49,",DR="25.2///"_PSOCPEND_";.12///"_ORDNUM,DA=PSOIEN D ^DIE K DIE,DA,DR
"RTN","PSOERX1B",288,0)
 ; PSO*7*508 - add checks to update refill requests and responses
"RTN","PSOERX1B",289,0)
 ; add activity to status history
"RTN","PSOERX1B",290,0)
 I MTYPE="N" D UPDSTAT^PSOERXU1(PSOIEN,"PR")
"RTN","PSOERX1B",291,0)
 I MTYPE="RE" D UPDSTAT^PSOERXU1(PSOIEN,"RXP")
"RTN","PSOERX1B",292,0)
 S REQIEN=$$GETREQ^PSOERXU2(PSOIEN) I REQIEN D UPDSTAT^PSOERXU1(REQIEN,"RRP")
"RTN","PSOERX1B",293,0)
 ; PSO*7*508 - end
"RTN","PSOERX1B",294,0)
 ; gather the unexpanded sig and file in 52.41
"RTN","PSOERX1B",295,0)
 S ILOOP=0 F  S ILOOP=$O(^PS(52.49,PSOIEN,31,ILOOP)) Q:'ILOOP  D
"RTN","PSOERX1B",296,0)
 .S IARY(ILOOP)=$G(^PS(52.49,PSOIEN,31,ILOOP,0))
"RTN","PSOERX1B",297,0)
 I $D(IARY) D WP^DIE(52.41,PSOCPEND_",",9,"K","IARY","IERR")
"RTN","PSOERX1B",298,0)
 I '$D(QUIET) W !!,"eRx #"_PSOHY("CHNUM")_" sent to PENDING OUTPATIENT ORDERS!"
"RTN","PSOERX1B",299,0)
 ;PSO*7*520 - add sending and warning/information related to RxVerify Message.
"RTN","PSOERX1B",300,0)
 I MTYPE="N" D
"RTN","PSOERX1B",301,0)
 .W !!,"Sending rxVerify Message to prescriber."
"RTN","PSOERX1B",302,0)
 .D POST^PSOERXO1(PSOIEN,.PSSRET,,,,1)
"RTN","PSOERX1B",303,0)
 .; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERX1B",304,0)
 .I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX1B",305,0)
 .I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX1B",306,0)
 ;PSO*7*520 - end rxVerify changes
"RTN","PSOERX1B",307,0)
 I '$D(QUIET) S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX1B",308,0)
 K QUIET
"RTN","PSOERX1B",309,0)
 Q
"RTN","PSOERX1B",310,0)
 ; remove eRx from holding queue
"RTN","PSOERX1B",311,0)
REM ;
"RTN","PSOERX1B",312,0)
 D REM^PSOERXU4
"RTN","PSOERX1B",313,0)
 Q
"RTN","PSOERX1B",314,0)
 ; reject eRx
"RTN","PSOERX1B",315,0)
REJ ;
"RTN","PSOERX1B",316,0)
 D REJ^PSOERXU4
"RTN","PSOERX1C")
0^35^B61030450^B40194088
"RTN","PSOERX1C",1,0)
PSOERX1C ;ALB/BWF - eRx Utilities ; 8/3/2016 5:14pm
"RTN","PSOERX1C",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,527,508**;DEC 1997;Build 295
"RTN","PSOERX1C",3,0)
 ;
"RTN","PSOERX1C",4,0)
 Q
"RTN","PSOERX1C",5,0)
 ; select an item
"RTN","PSOERX1C",6,0)
PRINT(PSOIEN,OP) ;
"RTN","PSOERX1C",7,0)
 N %ZIS,POP
"RTN","PSOERX1C",8,0)
 S OP=$G(OP)
"RTN","PSOERX1C",9,0)
 D FULL^VALM1
"RTN","PSOERX1C",10,0)
 S VALMBCK="R"
"RTN","PSOERX1C",11,0)
 S %ZIS="Q",%ZIS("B")=$G(PSOPROP) D ^%ZIS Q:POP
"RTN","PSOERX1C",12,0)
 ; if queuing, queue it and quit.
"RTN","PSOERX1C",13,0)
 I $D(IO("Q")) D  Q
"RTN","PSOERX1C",14,0)
 .S ZTSAVE("PSOIEN")="",ZTSAVE("OP")=""
"RTN","PSOERX1C",15,0)
 .S ZTRTN="PRINTQ^PSOERX1C(PSOIEN,OP)",ZTDESC="eRx Print" D ^%ZTLOAD
"RTN","PSOERX1C",16,0)
 .K ZTSAVE,ZTRTN
"RTN","PSOERX1C",17,0)
 .D INIT^PSOERX1
"RTN","PSOERX1C",18,0)
 .D TERM^VALM0
"RTN","PSOERX1C",19,0)
 D PRINTQ(PSOIEN,OP)
"RTN","PSOERX1C",20,0)
 D TERM^VALM0
"RTN","PSOERX1C",21,0)
 D INIT^PSOERX1
"RTN","PSOERX1C",22,0)
 Q
"RTN","PSOERX1C",23,0)
 ; fallthrough if no queueing
"RTN","PSOERX1C",24,0)
PRINTQ(PSOIEN,OP) ;
"RTN","PSOERX1C",25,0)
 N %ZIS,POP,RXDAT,PHARIEN,PRVIEN,PATIEN,PHARDAT,PRVDAT,PATDAT,PSOIENS,PHNM,PHAD1,PHAD2,PHCTY,LINE,LOOP
"RTN","PSOERX1C",26,0)
 N PHST,PHZIP,PHNCP,PHTEL,PRFNM,PRLNM,PRMNM,PRAD1,PRAD2,PRCTY,PRST,PRZIP,PRNPI,PRDEA,PRSTL,LTXT,MTYPE,NEWRXIEN
"RTN","PSOERX1C",27,0)
 N PRTEL,PRFAX,PRSUPER,PRAGNT,PTLNM,PTFNM,PTMNM,PTAD1,PTAD2,PTCTY,PTST,PTZIP,PTDOB,PTGEN,PTHPHON,PTPLANID
"RTN","PSOERX1C",28,0)
 N PHARIENS,PATIENS,PRVIENS,PTSSN,PRAGNTFN,PRAGNTMN,PRAGNTLN,TYPE,VALUE,PRFAX,PRTEL,SIEN,REFILL,IENS,CANREQ,CANRES
"RTN","PSOERX1C",29,0)
 S OP=$G(OP,"")
"RTN","PSOERX1C",30,0)
 S PSOIEN=$G(PSOIEN)
"RTN","PSOERX1C",31,0)
 I '$G(PSOIEN) D
"RTN","PSOERX1C",32,0)
 .I $D(RXOR) S PSOIEN=$$CHKERX^PSOERXU1($P(RXOR,U,2)) Q:PSOIEN
"RTN","PSOERX1C",33,0)
 .I $D(OR0) S PSOIEN=$$CHKERX^PSOERXU1(OR0)
"RTN","PSOERX1C",34,0)
 Q:'$G(PSOIEN)
"RTN","PSOERX1C",35,0)
 S MTYPE=$$GET1^DIQ(52.49,PSOIEN,.08,"I")
"RTN","PSOERX1C",36,0)
 I MTYPE="CN"!(MTYPE="RE")!(MTYPE="IE") D
"RTN","PSOERX1C",37,0)
 .S CANRES=PSOIEN
"RTN","PSOERX1C",38,0)
 .S CANREQ=$$GETREQ^PSOERXU2(PSOIEN)
"RTN","PSOERX1C",39,0)
 .I $G(CANREQ) S NEWRXIEN=$$RESOLV^PSOERXU2(CANREQ)
"RTN","PSOERX1C",40,0)
 .; if there is no NewRx related to this request, pull the data from the cancel request itself.
"RTN","PSOERX1C",41,0)
 .I '$P(NEWRXIEN,U) S NEWRXIEN=$G(CANREQ)
"RTN","PSOERX1C",42,0)
 I MTYPE="CA"!(MTYPE="RR") D
"RTN","PSOERX1C",43,0)
 .S CANREQ=PSOIEN,CANRES=$$GETRESP^PSOERXU2(CANREQ)
"RTN","PSOERX1C",44,0)
 .S NEWRXIEN=$$RESOLV^PSOERXU2(CANREQ)
"RTN","PSOERX1C",45,0)
 .I '$P(NEWRXIEN,U) S NEWRXIEN=$G(CANREQ)
"RTN","PSOERX1C",46,0)
 S PSOIENS=$S($G(NEWRXIEN):NEWRXIEN_",",1:PSOIEN_",")
"RTN","PSOERX1C",47,0)
 ; if we found the newrxien because of a different message type, reset PSOIEN to pull rx info from the newrx.
"RTN","PSOERX1C",48,0)
 I $G(NEWRXIEN) S PSOIEN=NEWRXIEN
"RTN","PSOERX1C",49,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","PSOERX1C",50,0)
 U IO
"RTN","PSOERX1C",51,0)
 D GETS^DIQ(52.49,PSOIENS,".04;.08;2.1;2.5","I","RXDAT")
"RTN","PSOERX1C",52,0)
 S PHARIEN=$G(RXDAT(52.49,PSOIENS,2.5,"I")) I PHARIEN S PHARIENS=PHARIEN_","
"RTN","PSOERX1C",53,0)
 S PRVIEN=$G(RXDAT(52.49,PSOIENS,2.1,"I")) I PRVIEN S PRVIENS=PRVIEN_","
"RTN","PSOERX1C",54,0)
 S PATIEN=$G(RXDAT(52.49,PSOIENS,.04,"I")) I PATIEN S PATIENS=PATIEN_","
"RTN","PSOERX1C",55,0)
 I $D(PHARIENS) D GETS^DIQ(52.47,PHARIENS,"**","E","PHARDAT")
"RTN","PSOERX1C",56,0)
 I $D(PRVIENS) D GETS^DIQ(52.48,PRVIENS,"**","E","PRVDAT")
"RTN","PSOERX1C",57,0)
 I $D(PATIENS) D GETS^DIQ(52.46,PATIENS,"**","E","PATDAT")
"RTN","PSOERX1C",58,0)
 ; pharmacy information
"RTN","PSOERX1C",59,0)
 S PHNM=$G(PHARDAT(52.47,PHARIENS,.05,"E"))
"RTN","PSOERX1C",60,0)
 S PHAD1=$G(PHARDAT(52.47,PHARIENS,1.1,"E"))
"RTN","PSOERX1C",61,0)
 S PHAD2=$G(PHARDAT(52.47,PHARIENS,1.2,"E"))
"RTN","PSOERX1C",62,0)
 S PHCTY=$G(PHARDAT(52.47,PHARIENS,1.3,"E"))
"RTN","PSOERX1C",63,0)
 S PHST=$G(PHARDAT(52.47,PHARIENS,1.4,"E"))
"RTN","PSOERX1C",64,0)
 S PHZIP=$G(PHARDAT(52.47,PHARIENS,1.5,"E"))
"RTN","PSOERX1C",65,0)
 S PHNCP=$G(PHARDAT(52.47,PHARIENS,.02,"E"))
"RTN","PSOERX1C",66,0)
 ; future - get telephone
"RTN","PSOERX1C",67,0)
 S PHTEL=""
"RTN","PSOERX1C",68,0)
 ; provider information
"RTN","PSOERX1C",69,0)
 S PRFNM=$G(PRVDAT(52.48,PRVIENS,.03,"E"))
"RTN","PSOERX1C",70,0)
 S PRMNM=$G(PRVDAT(52.48,PRVIENS,.04,"E"))
"RTN","PSOERX1C",71,0)
 S PRLNM=$G(PRVDAT(52.48,PRVIENS,.02,"E"))
"RTN","PSOERX1C",72,0)
 S PRAD1=$G(PRVDAT(52.48,PRVIENS,4.1,"E"))
"RTN","PSOERX1C",73,0)
 S PRAD2=$G(PRVDAT(52.48,PRVIENS,4.2,"E"))
"RTN","PSOERX1C",74,0)
 S PRCTY=$G(PRVDAT(52.48,PRVIENS,4.3,"E"))
"RTN","PSOERX1C",75,0)
 S PRST=$G(PRVDAT(52.48,PRVIENS,4.4,"E"))
"RTN","PSOERX1C",76,0)
 S PRZIP=$G(PRVDAT(52.48,PRVIENS,4.5,"E"))
"RTN","PSOERX1C",77,0)
 S PRNPI=$G(PRVDAT(52.48,PRVIENS,1.5,"E"))
"RTN","PSOERX1C",78,0)
 S PRDEA=$G(PRVDAT(52.48,PRVIENS,1.6,"E"))
"RTN","PSOERX1C",79,0)
 S PRSTL=$G(PRVDAT(52.48,PRVIENS,1.8,"E"))
"RTN","PSOERX1C",80,0)
 I '$G(NEWRXIEN) S PRSUPER=$$GET1^DIQ(52.49,PSOIEN,2.6,"E")
"RTN","PSOERX1C",81,0)
 I $G(NEWRXIEN) S PRSUPER=$$GET1^DIQ(52.49,NEWRXIEN,2.6,"E")
"RTN","PSOERX1C",82,0)
 S PRAGNTFN=$$GET1^DIQ(52.48,PRVIEN,5.2,"E")
"RTN","PSOERX1C",83,0)
 S PRAGNTMN=$$GET1^DIQ(52.48,PRVIEN,5.3,"E")
"RTN","PSOERX1C",84,0)
 S PRAGNTLN=$$GET1^DIQ(52.48,PRVIEN,5.1,"E")
"RTN","PSOERX1C",85,0)
 ;/BLB/ PSO*7.0*520  - BEGIN CHANGE
"RTN","PSOERX1C",86,0)
 S SIEN=0
"RTN","PSOERX1C",87,0)
 F  S SIEN=$O(^PS(52.48,PRVIEN,3,SIEN)) Q:'SIEN  D
"RTN","PSOERX1C",88,0)
 .S IENS=SIEN_","_PRVIEN_","
"RTN","PSOERX1C",89,0)
 .S TYPE=$$GET1^DIQ(52.483,IENS,.02)
"RTN","PSOERX1C",90,0)
 .S VALUE=$$GET1^DIQ(52.483,IENS,.01)
"RTN","PSOERX1C",91,0)
 .I TYPE="FAX" S PRFAX=VALUE
"RTN","PSOERX1C",92,0)
 .I TYPE="TELEPHONE" S PRTEL=VALUE
"RTN","PSOERX1C",93,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",94,0)
 ; patient information
"RTN","PSOERX1C",95,0)
 S PTLNM=$G(PATDAT(52.46,PATIENS,.02,"E"))
"RTN","PSOERX1C",96,0)
 S PTMNM=$G(PATDAT(52.46,PATIENS,.04,"E"))
"RTN","PSOERX1C",97,0)
 S PTFNM=$G(PATDAT(52.46,PATIENS,.03,"E"))
"RTN","PSOERX1C",98,0)
 S PTAD1=$G(PATDAT(52.46,PATIENS,3.1,"E"))
"RTN","PSOERX1C",99,0)
 S PTAD2=$G(PATDAT(52.46,PATIENS,3.2,"E"))
"RTN","PSOERX1C",100,0)
 S PTCTY=$G(PATDAT(52.46,PATIENS,3.3,"E"))
"RTN","PSOERX1C",101,0)
 S PTST=$G(PATDAT(52.46,PATIENS,3.4,"E"))
"RTN","PSOERX1C",102,0)
 S PTZIP=$G(PATDAT(52.46,PATIENS,3.5,"E"))
"RTN","PSOERX1C",103,0)
 S PTDOB=$G(PATDAT(52.46,PATIENS,.08,"E"))
"RTN","PSOERX1C",104,0)
 S PTGEN=$G(PATDAT(52.46,PATIENS,.07,"E"))
"RTN","PSOERX1C",105,0)
 S PTSSN=$G(PATDAT(52.46,PATIENS,1.4,"E"))
"RTN","PSOERX1C",106,0)
 S PTHPHON=""
"RTN","PSOERX1C",107,0)
 S PTPLANID=""
"RTN","PSOERX1C",108,0)
 W !,"*************************PHARMACY INFORMATION****************************"
"RTN","PSOERX1C",109,0)
 W !,$$UP^XLFSTR(PHNM)
"RTN","PSOERX1C",110,0)
 W !,"Address: "_PHAD1
"RTN","PSOERX1C",111,0)
 I $L(PHAD2) W !,"         "_PHAD2
"RTN","PSOERX1C",112,0)
 W !,!,"         "_PHCTY_", "_PHST_" "_PHZIP
"RTN","PSOERX1C",113,0)
 S LTXT=""
"RTN","PSOERX1C",114,0)
 D ADDITEM^PSOERX1A(.LTXT,"Tel: ",PHTEL,1,26)
"RTN","PSOERX1C",115,0)
 D ADDITEM^PSOERX1A(.LTXT,"NCPDP: ",PHNCP,28,26)
"RTN","PSOERX1C",116,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",117,0)
 W !,"******************PRESCRIBER INFORMATION*********************************"
"RTN","PSOERX1C",118,0)
 ; /BLB/ PSO*7.0*520 - CHANGED ORDER OF NAMES TO LAST,FIRST,MIDDLE - BEGIN CHANGE
"RTN","PSOERX1C",119,0)
 W !,"Last: "_PRLNM
"RTN","PSOERX1C",120,0)
 W !,"First: "_PRFNM
"RTN","PSOERX1C",121,0)
 W !,"Mid: "_PRMNM
"RTN","PSOERX1C",122,0)
 ; /BLB/ - END CHANGE
"RTN","PSOERX1C",123,0)
 W !,"Address: "_PRAD1
"RTN","PSOERX1C",124,0)
 I $L(PHAD2) W !,"         "_PRAD2
"RTN","PSOERX1C",125,0)
 W !,"         "_PRCTY_", "_PRST_" "_PRZIP
"RTN","PSOERX1C",126,0)
 S LTXT="" ;/BLB/ PSO*7.0*527 - BEGIN CHANGE - MOVE FIELDS TO THEIR OWN LINE
"RTN","PSOERX1C",127,0)
 W !,"NPI: "_PRNPI
"RTN","PSOERX1C",128,0)
 W !,"DEA: "_PRDEA
"RTN","PSOERX1C",129,0)
 W !,"State Lic: "_PRSTL
"RTN","PSOERX1C",130,0)
 ;/BLB/ - PSO*7.0*527 END CHANGE
"RTN","PSOERX1C",131,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",132,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1C",133,0)
 W !,"Tel: "_$G(PRTEL)
"RTN","PSOERX1C",134,0)
 W !,"Fax: "_$G(PRFAX)
"RTN","PSOERX1C",135,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",136,0)
 W !,"Supervisor: "_$G(PRSUPER)
"RTN","PSOERX1C",137,0)
 W !,"Agent Last Name: "_$G(PRAGNTLN)
"RTN","PSOERX1C",138,0)
 W !,"Agent First Name: "_$G(PRAGNTFN)
"RTN","PSOERX1C",139,0)
 W !,"Agent Middle Name: "_$G(PRAGNTMN)
"RTN","PSOERX1C",140,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",141,0)
 W !,"******************PATIENT INFORMATION************************************"
"RTN","PSOERX1C",142,0)
 S LTXT=""
"RTN","PSOERX1C",143,0)
 ;/BLB/PSO*7.0*520 RESTRUCTURED ORDER OF PATIENT NAME - BEGIN CHANGE
"RTN","PSOERX1C",144,0)
 W !,"Last: "_PTLNM
"RTN","PSOERX1C",145,0)
 W !,"First: "_PTFNM
"RTN","PSOERX1C",146,0)
 W !,"Mid: "_PTMNM
"RTN","PSOERX1C",147,0)
 ;/BLB END CHANGE
"RTN","PSOERX1C",148,0)
 W !,LTXT
"RTN","PSOERX1C",149,0)
 S LTXT=""
"RTN","PSOERX1C",150,0)
 D ADDITEM^PSOERX1A(.LTXT,"SSN: ",PTSSN,1,28)
"RTN","PSOERX1C",151,0)
 D ADDITEM^PSOERX1A(.LTXT,"Sex: ",PTGEN,30,20) W !,LTXT S LTXT=""
"RTN","PSOERX1C",152,0)
 W !,"Address: "_PTAD1
"RTN","PSOERX1C",153,0)
 I $L(PTAD2) W !,"         "_PTAD2
"RTN","PSOERX1C",154,0)
 W !,"         "_PTCTY_", "_PTST_" "_PTZIP
"RTN","PSOERX1C",155,0)
 S LTXT=""
"RTN","PSOERX1C",156,0)
 D ADDITEM^PSOERX1A(.LTXT,"DOB: ",PTDOB,1,26)
"RTN","PSOERX1C",157,0)
 D ADDITEM^PSOERX1A(.LTXT,"Home: ",PTHPHON,28,16)
"RTN","PSOERX1C",158,0)
 D ADDITEM^PSOERX1A(.LTXT,"Plan ID: ",PTPLANID,52,27)
"RTN","PSOERX1C",159,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",160,0)
 W !,"******************PRESCRIPTION INFORMATION*******************************"
"RTN","PSOERX1C",161,0)
 W !,"eRx Drug: "_$$GET1^DIQ(52.49,PSOIEN,3.1,"E")
"RTN","PSOERX1C",162,0)
 S LTXT=""
"RTN","PSOERX1C",163,0)
 D ADDITEM^PSOERX1A(.LTXT,"Qty: ",$$GET1^DIQ(52.49,PSOIEN,5.1,"E"),1,26)
"RTN","PSOERX1C",164,0)
 D ADDITEM^PSOERX1A(.LTXT,"Days Supply: ",$$GET1^DIQ(52.49,PSOIEN,5.5,"E"),28,16)
"RTN","PSOERX1C",165,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE - MOVING "Written Date" TO ITS OWN LINE
"RTN","PSOERX1C",166,0)
 ;D ADDITEM^PSOERX1A(.LTXT,"Date Written: ",$$FMTE^XLFDT($$GET1^DIQ(52.49,PSOIEN,5.9,"E"),"2D"),52,27)
"RTN","PSOERX1C",167,0)
 W !,"Date Written: "_$$FMTE^XLFDT($$GET1^DIQ(52.49,PSOIEN,5.9,"E"),"2D")
"RTN","PSOERX1C",168,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",169,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",170,0)
 ;/BLB/PSO*7.0*520 REMOVED ADDITEM CALLS AND MOVED FIELDS TO INDIVIDUAL LINES - BEGIN CHANGE
"RTN","PSOERX1C",171,0)
 W !,"Qty Qualifier: "_$$GET1^DIQ(52.49,PSOIEN,5.2,"E")
"RTN","PSOERX1C",172,0)
 W !,"Drug Form: "_$$GET1^DIQ(52.49,PSOIEN,41,"E")
"RTN","PSOERX1C",173,0)
 W !,"Strength: "_$$GET1^DIQ(52.49,PSOIEN,43,"E")
"RTN","PSOERX1C",174,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",175,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",176,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1C",177,0)
 S REFILL=$$GET1^DIQ(52.49,PSOIEN,5.6,"E")
"RTN","PSOERX1C",178,0)
 I REFILL'="" D
"RTN","PSOERX1C",179,0)
 .W !,"Refills: "_REFILL
"RTN","PSOERX1C",180,0)
 I REFILL="" D
"RTN","PSOERX1C",181,0)
 .S REFILL=$$GET1^DIQ(52.49,PSOIEN,5.7,"I")
"RTN","PSOERX1C",182,0)
 .W !,"Refills: "_REFILL
"RTN","PSOERX1C",183,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",184,0)
 W !,"SIG: "_$$GET1^DIQ(52.49,PSOIEN,7,"E")
"RTN","PSOERX1C",185,0)
 D ADDITEM^PSOERX1A(.LTXT,"eRx Reference #: ",$$GET1^DIQ(52.49,PSOIEN,.01,"E"),1,40)
"RTN","PSOERX1C",186,0)
 D ADDITEM^PSOERX1A(.LTXT,"Message ID: ",$$GET1^DIQ(52.49,PSOIEN,25,"E"),42,35)
"RTN","PSOERX1C",187,0)
 W !!,LTXT S LTXT=""
"RTN","PSOERX1C",188,0)
 W !,"Dispense Notes: "_$$GET1^DIQ(52.49,PSOIEN,5.8,"E")
"RTN","PSOERX1C",189,0)
 W !,"Comments: "_$$GET1^DIQ(52.49,PSOIEN,8,"E")
"RTN","PSOERX1C",190,0)
 I MTYPE="CA"!(MTYPE="RR") D
"RTN","PSOERX1C",191,0)
 .S LINE=1 K @VALMAR
"RTN","PSOERX1C",192,0)
 .I MTYPE="CA" D CANREQ^PSOERXU5(CANREQ,.LINE,1),CANRES^PSOERXU5(CANREQ,.LINE,1),MSGHIS^PSOERXU3(CANREQ,.LINE)
"RTN","PSOERX1C",193,0)
 .I MTYPE="RR" D MEDDIS^PSOERXU3(CANREQ,"D",.LINE),RRREQ^PSOERXU3(CANREQ,.LINE),RRRES^PSOERXU3(CANREQ,.LINE),MSGHIS^PSOERXU3(CANREQ,.LINE)
"RTN","PSOERX1C",194,0)
 .S LOOP=0 F  S LOOP=$O(@VALMAR@(LOOP)) Q:'LOOP  D
"RTN","PSOERX1C",195,0)
 ..W !,$G(@VALMAR@(LOOP,0))
"RTN","PSOERX1C",196,0)
 .K @VALMAR
"RTN","PSOERX1C",197,0)
 I MTYPE="CN"!(MTYPE="RE") D
"RTN","PSOERX1C",198,0)
 .S LINE=1 K @VALMAR
"RTN","PSOERX1C",199,0)
 .I MTYPE="CN" D CANRES^PSOERXU5(CANRES,.LINE,1),CANREQ^PSOERXU5(CANRES,.LINE,1),MSGHIS^PSOERXU3(CANRES,.LINE)
"RTN","PSOERX1C",200,0)
 .I MTYPE="RE" D MEDDIS^PSOERXU3(CANRES,"D",.LINE),RRRES^PSOERXU3(CANRES,.LINE),RRREQ^PSOERXU3(CANRES,.LINE),MSGHIS^PSOERXU3(CANRES,.LINE)
"RTN","PSOERX1C",201,0)
 .S LOOP=0 F  S LOOP=$O(@VALMAR@(LOOP)) Q:'LOOP  D
"RTN","PSOERX1C",202,0)
 ..W !,$G(@VALMAR@(LOOP,0))
"RTN","PSOERX1C",203,0)
 .K @VALMAR
"RTN","PSOERX1C",204,0)
 W !,"*******************************END OF eRx********************************"
"RTN","PSOERX1C",205,0)
 D:'$D(ZTQUEUED) ^%ZISC
"RTN","PSOERX1C",206,0)
 Q
"RTN","PSOERXA1")
0^2^B188146400^B233267035
"RTN","PSOERXA1",1,0)
PSOERXA1 ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERXA1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,508**;DEC 1997;Build 295
"RTN","PSOERXA1",3,0)
 ;
"RTN","PSOERXA1",4,0)
 Q
"RTN","PSOERXA1",5,0)
 ; File incoming XML into appropriate file
"RTN","PSOERXA1",6,0)
 ; XML - xml text
"RTN","PSOERXA1",7,0)
 ; PRCHK - provider check information
"RTN","PSOERXA1",8,0)
 ; PACHK - patient check information
"RTN","PSOERXA1",9,0)
 ; DACHK - drug auto check
"RTN","PSOERXA1",10,0)
 ; STATION - station #
"RTN","PSOERXA1",11,0)
 ; DIV - institution name^NPI
"RTN","PSOERXA1",12,0)
 ; ERXHID - eRx processing hub id^CANCEL/CHANGE REQUEST DENIED BY HUB (1=YES)
"RTN","PSOERXA1",13,0)
 ; ERXVALS - code values for NIST codes
"RTN","PSOERXA1",14,0)
 ; XML2 - structured sig from the medication prescribed segment
"RTN","PSOERXA1",15,0)
 ; VADAT - DUZ^RXIEN
"RTN","PSOERXA1",16,0)
INCERX(RES,XML,PRCHK,PACHK,DACHK,STATION,DIV,ERXHID,ERXVALS,XML2,VADAT) ;
"RTN","PSOERXA1",17,0)
 N CURREC,FDA,EIEN,ERRTXT,ERRSEQ,PACNT,PASCNT,PAICN,PAIEN,VAINST,NPI,VAOI,VPATINST
"RTN","PSOERXA1",18,0)
 S NPI=$P($G(DIV),U,2)
"RTN","PSOERXA1",19,0)
 S CURREC=$$PARSE(.XML,.ERXVALS,NPI,.XML2)
"RTN","PSOERXA1",20,0)
 I $P(CURREC,U)<1 D  Q
"RTN","PSOERXA1",21,0)
 .I $L($P(CURREC,U,2)) S RES=CURREC Q
"RTN","PSOERXA1",22,0)
 .S RES="0^XML received. Error creating or finding associated record in the ERX Holding queue." Q
"RTN","PSOERXA1",23,0)
 S EIEN=CURREC
"RTN","PSOERXA1",24,0)
 S CURREC=CURREC_","
"RTN","PSOERXA1",25,0)
 ; if this is an outbound message, file the users DUZ and quit back the response. no drug, patient, or provider auto checks will occur
"RTN","PSOERXA1",26,0)
 I $D(VADAT) D  Q
"RTN","PSOERXA1",27,0)
 .I $P($G(VADAT),U)>1 D
"RTN","PSOERXA1",28,0)
 ..S FDA(52.49,CURREC,51.1)=DUZ D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",29,0)
 .I $P(VADAT,U,2) D
"RTN","PSOERXA1",30,0)
 ..S FDA(52.49,CURREC,.13)=$P(VADAT,U,2) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",31,0)
 .S RES="1^Erx Received."
"RTN","PSOERXA1",32,0)
 ; Process auto-validation results. only log positive results for now
"RTN","PSOERXA1",33,0)
 K FDA
"RTN","PSOERXA1",34,0)
 I $P($G(VADAT),U) S RES="1^Message Filed." Q
"RTN","PSOERXA1",35,0)
 I $G(DACHK("success"))="true" D
"RTN","PSOERXA1",36,0)
 .I $G(DACHK("IEN")) D
"RTN","PSOERXA1",37,0)
 ..S FDA(52.49,CURREC,1.4)=1
"RTN","PSOERXA1",38,0)
 ..S FDA(52.49,CURREC,3.2)=DACHK("IEN")
"RTN","PSOERXA1",39,0)
 ..S FDA(52.49,CURREC,44)=1
"RTN","PSOERXA1",40,0)
 ..S VAOI=$$GET1^DIQ(50,DACHK("IEN"),2.1,"I")
"RTN","PSOERXA1",41,0)
 ..S VPATINST=$$GET1^DIQ(50.7,VAOI,7,"E")
"RTN","PSOERXA1",42,0)
 ..I $L(VPATINST) S FDA(52.49,CURREC,27)=VPATINST
"RTN","PSOERXA1",43,0)
 I $G(DACHK("success"))="false" D
"RTN","PSOERXA1",44,0)
 .S ERRTXT=$G(DACHK("error"))
"RTN","PSOERXA1",45,0)
 .S ERRSEQ=$$ERRSEQ^PSOERXU1(EIEN) Q:'ERRSEQ
"RTN","PSOERXA1",46,0)
 .D FILERR^PSOERXU1(CURREC,ERRSEQ,"D","E",ERRTXT)
"RTN","PSOERXA1",47,0)
 I $G(PRCHK("success"))="true" D
"RTN","PSOERXA1",48,0)
 .I PRCHK("IEN") D
"RTN","PSOERXA1",49,0)
 ..S FDA(52.49,CURREC,1.2)=1
"RTN","PSOERXA1",50,0)
 ..S FDA(52.49,CURREC,2.3)=PRCHK("IEN")
"RTN","PSOERXA1",51,0)
 I $G(PRCHK("success"))="false" D
"RTN","PSOERXA1",52,0)
 .S ERRTXT=$G(PRCHK("error"))
"RTN","PSOERXA1",53,0)
 .S ERRSEQ=$$ERRSEQ^PSOERXU1(EIEN) Q:'ERRSEQ
"RTN","PSOERXA1",54,0)
 .D FILERR^PSOERXU1(CURREC,ERRSEQ,"PR","E",ERRTXT)
"RTN","PSOERXA1",55,0)
 I $G(PACHK("MVIerror"))']"" D
"RTN","PSOERXA1",56,0)
 .S PAICN=+$P($G(PACHK("ICN")),"V")
"RTN","PSOERXA1",57,0)
 .I PAICN D
"RTN","PSOERXA1",58,0)
 ..S (PAIEN,PACNT)=0 F  S PAIEN=$O(^DPT("AICN",PAICN,PAIEN)) Q:'PAIEN  D
"RTN","PSOERXA1",59,0)
 ...S PACNT=PACNT+1
"RTN","PSOERXA1",60,0)
 ...; revisit in future build - if we find more than one match in the local system, do we log some sort of an error?
"RTN","PSOERXA1",61,0)
 .I $G(PACNT)=1 D  Q
"RTN","PSOERXA1",62,0)
 ..S FDA(52.49,CURREC,1.6)=1
"RTN","PSOERXA1",63,0)
 ..S FDA(52.49,CURREC,.05)=$O(^DPT("AICN",PAICN,0))
"RTN","PSOERXA1",64,0)
 .I $L(PACHK("ssn")) D
"RTN","PSOERXA1",65,0)
 ..S (PASCNT,PAIEN)=0 F  S PAIEN=$O(^DPT("SSN",$TR(PACHK("ssn"),"-",""),PAIEN)) Q:'PAIEN  D
"RTN","PSOERXA1",66,0)
 ...S PASCNT=PASCNT+1
"RTN","PSOERXA1",67,0)
 .I $G(PASCNT)=1 D  Q
"RTN","PSOERXA1",68,0)
 ..S FDA(52.49,CURREC,1.6)=1
"RTN","PSOERXA1",69,0)
 ..S FDA(52.49,CURREC,.05)=$O(^DPT("SSN",$TR(PACHK("ssn"),"-",""),0))
"RTN","PSOERXA1",70,0)
 I $D(FDA) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",71,0)
 I $G(PACHK("success"))="false" D
"RTN","PSOERXA1",72,0)
 .; file e&e error
"RTN","PSOERXA1",73,0)
 .S ERRTXT=$G(PACHK("EandEerror")) I ERRTXT]"" D
"RTN","PSOERXA1",74,0)
 ..S ERRSEQ=$$ERRSEQ^PSOERXU1(EIEN) Q:'ERRSEQ
"RTN","PSOERXA1",75,0)
 ..D FILERR^PSOERXU1(CURREC,ERRSEQ,"PA","E",ERRTXT)
"RTN","PSOERXA1",76,0)
 .; file mvi error
"RTN","PSOERXA1",77,0)
 .S ERRTXT=$G(PACHK("MVIerror")) I ERRTXT]"" D
"RTN","PSOERXA1",78,0)
 ..S ERRSEQ=$$ERRSEQ^PSOERXU1(EIEN) Q:'ERRSEQ
"RTN","PSOERXA1",79,0)
 ..D FILERR^PSOERXU1(CURREC,ERRSEQ,"PA","E",ERRTXT)
"RTN","PSOERXA1",80,0)
 S RES="1^Erx Received."
"RTN","PSOERXA1",81,0)
 Q
"RTN","PSOERXA1",82,0)
PARSE(STREAM,ERXVALS,NPI,STREAM2) ;
"RTN","PSOERXA1",83,0)
 N %XML,GL,VAINST,MTYPE,HUBDENY
"RTN","PSOERXA1",84,0)
 S GL=$NA(^TMP($J,"PSOERXO1"))
"RTN","PSOERXA1",85,0)
 K @GL
"RTN","PSOERXA1",86,0)
 N STATUS,READER,XOBERR,S,ATTR,READER2,XOBERR2,STATUS2
"RTN","PSOERXA1",87,0)
 S STREAM=$TR(STREAM,"^","")
"RTN","PSOERXA1",88,0)
 I $L(STREAM2) S STREAM2=$TR(STREAM2,"^","")
"RTN","PSOERXA1",89,0)
 S STATUS=##class(%XML.TextReader).ParseStream(STREAM,.READER,,,,,1)
"RTN","PSOERXA1",90,0)
 I $L(STREAM2) S STATUS2=##class(%XML.TextReader).ParseStream(STREAM2,.READER2,,,,,1)
"RTN","PSOERXA1",91,0)
 I $$STATCHK^XOBWLIB(STATUS,.XOBERR,1) D
"RTN","PSOERXA1",92,0)
 .N BREAK
"RTN","PSOERXA1",93,0)
 .S BREAK=0 F  Q:BREAK||READER.EOF||'READER.Read()  D
"RTN","PSOERXA1",94,0)
 ..N X,PUSHED,PARENT
"RTN","PSOERXA1",95,0)
 ..I READER.AttributeCount D
"RTN","PSOERXA1",96,0)
 ...S PARENT=READER.LocalName
"RTN","PSOERXA1",97,0)
 ...D SPUSH(.S,PARENT) S PUSHED=1
"RTN","PSOERXA1",98,0)
 ...F ATTR=1:1:READER.AttributeCount D
"RTN","PSOERXA1",99,0)
 ....D READER.MoveToAttributeIndex(ATTR)
"RTN","PSOERXA1",100,0)
 ....I READER.NodeType="attribute" D APUT(.S,READER.Value,READER.LocalName)
"RTN","PSOERXA1",101,0)
 ..I READER.NodeType="element",'$G(PUSHED) D SPUSH(.S,READER.LocalName)
"RTN","PSOERXA1",102,0)
 ..; PSO*7*508 - if the type is an element, and is an empty element, put it in the global.
"RTN","PSOERXA1",103,0)
 ..I READER.NodeType="element",READER.IsEmptyElement D SPUT(.S,"")
"RTN","PSOERXA1",104,0)
 ..I READER.NodeType="endelement" D SPOP(.S,.X)
"RTN","PSOERXA1",105,0)
 ..I READER.NodeType="chars" D SPUT(.S,READER.Value)
"RTN","PSOERXA1",106,0)
 I $D(STATUS2) D
"RTN","PSOERXA1",107,0)
 .I $$STATCHK^XOBWLIB(STATUS2,.XOBERR2,1) D
"RTN","PSOERXA1",108,0)
 ..N BREAK,S
"RTN","PSOERXA1",109,0)
 ..S BREAK=0 F  Q:BREAK||READER2.EOF||'READER2.Read()  D
"RTN","PSOERXA1",110,0)
 ...N X,PUSHED,PARENT
"RTN","PSOERXA1",111,0)
 ...I READER2.AttributeCount D
"RTN","PSOERXA1",112,0)
 ....S PARENT=READER2.LocalName
"RTN","PSOERXA1",113,0)
 ....D SPUSH(.S,PARENT) S PUSHED=1
"RTN","PSOERXA1",114,0)
 ....F ATTR=1:1:READER2.AttributeCount D
"RTN","PSOERXA1",115,0)
 .....D READER2.MoveToAttributeIndex(ATTR)
"RTN","PSOERXA1",116,0)
 .....I READER2.NodeType="attribute" D APUT(.S,READER2.Value,READER2.LocalName)
"RTN","PSOERXA1",117,0)
 ...I READER2.NodeType="element",'$G(PUSHED) D SPUSH(.S,READER2.LocalName)
"RTN","PSOERXA1",118,0)
 ...; PSO*7*508 - if the type is an element, and is an empty element, put it in the global.
"RTN","PSOERXA1",119,0)
 ...I READER.NodeType="element",READER.IsEmptyElement D SPUT(.S,"")
"RTN","PSOERXA1",120,0)
 ...I READER2.NodeType="endelement" D SPOP(.S,.X)
"RTN","PSOERXA1",121,0)
 ...I READER2.NodeType="chars" D SPUT(.S,READER2.Value)
"RTN","PSOERXA1",122,0)
 S MTYPE=$O(^TMP($J,"PSOERXO1","Message",0,"Body",0,"")) Q:MTYPE']"" "0^Message type could not be identified."
"RTN","PSOERXA1",123,0)
 ;I '$L(NPI) S NPI=$G(^TMP($J,"PSOERXO1","Message",0,"Body",0,"NewRx",0,"Pharmacy",0,"Identification",0,"NPI",0))
"RTN","PSOERXA1",124,0)
 I '$L(NPI) S NPI=$G(^TMP($J,"PSOERXO1","Message",0,"Body",0,MTYPE,0,"Pharmacy",0,"Identification",0,"NPI",0))
"RTN","PSOERXA1",125,0)
 I '$L(NPI) Q "0^Missing NPI. Institution could not be resolved. eRx not filed."
"RTN","PSOERXA1",126,0)
 S VAINST=$$FIND1^DIC(4,,"O",NPI,"ANPI")
"RTN","PSOERXA1",127,0)
 I '$G(VAINST) Q "0^Institution could not be resolved. eRx not filed."
"RTN","PSOERXA1",128,0)
 N NERXIEN,ERR,PATIEN
"RTN","PSOERXA1",129,0)
 S NERXIEN=$$HDR(MTYPE)
"RTN","PSOERXA1",130,0)
 I $P(NERXIEN,U)<1 Q NERXIEN
"RTN","PSOERXA1",131,0)
 I $G(VAINST) S FDA(52.49,NERXIEN_",",24.1)=VAINST D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",132,0)
 ; if message type is 'Error', do not try to file the other components.
"RTN","PSOERXA1",133,0)
 I MTYPE["Error" D  Q NERXIEN
"RTN","PSOERXA1",134,0)
 .S PATIEN=$$GETPAT^PSOERXU5(NERXIEN) Q:'PATIEN
"RTN","PSOERXA1",135,0)
 .S FDA(52.49,NERXIEN_",",.04)=PATIEN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",136,0)
 D PAT(NERXIEN,MTYPE),BFC^PSOERXA5(NERXIEN),PHR^PSOERXA2(NERXIEN,MTYPE),PRE^PSOERXA2(NERXIEN,MTYPE)
"RTN","PSOERXA1",137,0)
 D MED^PSOERXA3(NERXIEN,.ERXVALS,MTYPE),OBS(NERXIEN,MTYPE),SUP^PSOERXA2(NERXIEN,MTYPE)
"RTN","PSOERXA1",138,0)
 D MEDDISP^PSOERXA5(NERXIEN,MTYPE)
"RTN","PSOERXA1",139,0)
 I MTYPE="RefillResponse" D REFRESP^PSOERXA5(NERXIEN,MTYPE)
"RTN","PSOERXA1",140,0)
 I MTYPE["Cancel" D
"RTN","PSOERXA1",141,0)
 .S HUBDENY=$P(ERXHID,U,2)
"RTN","PSOERXA1",142,0)
 .D CANRX^PSOERXA5(NERXIEN,MTYPE,HUBDENY,VAINST)
"RTN","PSOERXA1",143,0)
 ; facility/request have no where to go at this point in time??
"RTN","PSOERXA1",144,0)
 ;/BLB PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXA1",145,0)
 D FAC^PSOERXA2(NERXIEN)
"RTN","PSOERXA1",146,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXA1",147,0)
 Q NERXIEN
"RTN","PSOERXA1",148,0)
HDR(MTYPE) ; header information
"RTN","PSOERXA1",149,0)
 N GL,GL2,FQUAL,TQUAL,FROM,TO,MID,PONUM,SRTID,SSTID,SENTTIME,RTMID,FDA,ERXIEN,FMID,NEWERX,MES,ERXIENS,SSSID,SRSID,MTVALS
"RTN","PSOERXA1",150,0)
 N UPMTYPE,DONE,I,ERXISTAT,MTCODE,COMPSTR,RTHID,RTHIEN,RTMIEN
"RTN","PSOERXA1",151,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Header",0))
"RTN","PSOERXA1",152,0)
 S GL2=$NA(^TMP($J,"PSOERXO1","Message","A","Qualifier","Header","A","Qualifier"))
"RTN","PSOERXA1",153,0)
 ; from and to qualifiers
"RTN","PSOERXA1",154,0)
 S FQUAL=$G(@GL2@("From","A","Qualifier"))
"RTN","PSOERXA1",155,0)
 S TQUAL=$G(@GL2@("To","A","Qualifier"))
"RTN","PSOERXA1",156,0)
 ; from, to, message id, prescriber order number
"RTN","PSOERXA1",157,0)
 S FROM=$G(@GL@("From",0))
"RTN","PSOERXA1",158,0)
 S TO=$G(@GL@("To",0))
"RTN","PSOERXA1",159,0)
 S MID=$G(@GL@("MessageID",0))
"RTN","PSOERXA1",160,0)
 ; set up the full message id
"RTN","PSOERXA1",161,0)
 S FMID=MID
"RTN","PSOERXA1",162,0)
 S ERXIENS="+1,"
"RTN","PSOERXA1",163,0)
 ; quit and return a message back if this eRx exists.
"RTN","PSOERXA1",164,0)
 I $D(^PS(52.49,"FMID",$P(ERXHID,U))) D  Q MES
"RTN","PSOERXA1",165,0)
 .S MES="0^This message already exists. Changes must occur via a change request XML message."
"RTN","PSOERXA1",166,0)
 S PONUM=$G(@GL@("PrescriberOrderNumber",0))
"RTN","PSOERXA1",167,0)
 ; security receiver tertiary identification
"RTN","PSOERXA1",168,0)
 S SRSID=$G(@GL@("Security",0,"Receiver",0,"SecondaryIdentification",0))
"RTN","PSOERXA1",169,0)
 S SRTID=$G(@GL@("Security",0,"Receiver",0,"TertiaryIdentification,",0))
"RTN","PSOERXA1",170,0)
 ; security sender tertiary identification
"RTN","PSOERXA1",171,0)
 S SSSID=$G(@GL@("Security",0,"Sender",0,"SecondaryIdentification",0))
"RTN","PSOERXA1",172,0)
 S SSTID=$G(@GL@("Security",0,"Sender",0,"TertiaryIdentification,",0))
"RTN","PSOERXA1",173,0)
 ; convert senttime to file manager dt/tm
"RTN","PSOERXA1",174,0)
 S SENTTIME=$G(@GL@("SentTime",0)),SENTTIME=$$CONVDTTM^PSOERXA1(SENTTIME)
"RTN","PSOERXA1",175,0)
 S RTMID=$G(@GL@("RelatesToMessageID",0))
"RTN","PSOERXA1",176,0)
 S RTHID=$P(ERXHID,U,3)
"RTN","PSOERXA1",177,0)
 S RTHIEN=""
"RTN","PSOERXA1",178,0)
 I $L(RTHID) S RTHIEN=$O(^PS(52.49,"FMID",RTHID,0))
"RTN","PSOERXA1",179,0)
 D FIELD^DID(52.49,.08,"","POINTER","MTVALS")
"RTN","PSOERXA1",180,0)
 S UPMTYPE=$$UP^XLFSTR(MTYPE)
"RTN","PSOERXA1",181,0)
 S DONE=0
"RTN","PSOERXA1",182,0)
 F I=1:1 D  Q:DONE
"RTN","PSOERXA1",183,0)
 .S COMPSTR=$P(MTVALS("POINTER"),";",I)
"RTN","PSOERXA1",184,0)
 .I COMPSTR="" S DONE=1 Q
"RTN","PSOERXA1",185,0)
 .I COMPSTR[UPMTYPE S MTCODE=$P(COMPSTR,":"),DONE=1
"RTN","PSOERXA1",186,0)
 I $G(MTCODE)']"" Q "0^Message type could not be resolved."
"RTN","PSOERXA1",187,0)
 S FDA(52.49,ERXIENS,.08)=MTCODE
"RTN","PSOERXA1",188,0)
 ; erx hub message id
"RTN","PSOERXA1",189,0)
 S FDA(52.49,ERXIENS,.01)=$P(ERXHID,U)
"RTN","PSOERXA1",190,0)
 ; change healthcare message id
"RTN","PSOERXA1",191,0)
 S FDA(52.49,ERXIENS,25)=FMID
"RTN","PSOERXA1",192,0)
 S FDA(52.49,ERXIENS,.02)=RTMID
"RTN","PSOERXA1",193,0)
 S FDA(52.49,ERXIENS,.03)=$$NOW^XLFDT
"RTN","PSOERXA1",194,0)
 S FDA(52.49,ERXIENS,.09)=PONUM
"RTN","PSOERXA1",195,0)
 ;RELATES TO HUB ID
"RTN","PSOERXA1",196,0)
 S FDA(52.49,ERXIENS,.14)=RTHID
"RTN","PSOERXA1",197,0)
 S ERXISTAT=$$GETSTAT^PSOERXU2(MTCODE,RTHIEN,RTMID)
"RTN","PSOERXA1",198,0)
 S FDA(52.49,ERXIENS,1)=ERXISTAT
"RTN","PSOERXA1",199,0)
 S FDA(52.49,ERXIENS,22.1)=FROM
"RTN","PSOERXA1",200,0)
 S FDA(52.49,ERXIENS,22.2)=FQUAL
"RTN","PSOERXA1",201,0)
 S FDA(52.49,ERXIENS,22.3)=TO
"RTN","PSOERXA1",202,0)
 S FDA(52.49,ERXIENS,22.4)=TQUAL
"RTN","PSOERXA1",203,0)
 S FDA(52.49,ERXIENS,22.5)=SENTTIME
"RTN","PSOERXA1",204,0)
 S FDA(52.49,ERXIENS,24.3)=SSSID
"RTN","PSOERXA1",205,0)
 S FDA(52.49,ERXIENS,24.4)=SSTID
"RTN","PSOERXA1",206,0)
 S FDA(52.49,ERXIENS,24.5)=SRSID
"RTN","PSOERXA1",207,0)
 S FDA(52.49,ERXIENS,24.6)=SRTID
"RTN","PSOERXA1",208,0)
 ; if this is an existing record, file the updates to the erx and return the IEN
"RTN","PSOERXA1",209,0)
 D UPDATE^DIE(,"FDA","NEWERX","EERR") K FDA
"RTN","PSOERXA1",210,0)
 S ERXIEN=""
"RTN","PSOERXA1",211,0)
 S ERXIEN=$O(NEWERX(0)),ERXIEN=$G(NEWERX(ERXIEN))
"RTN","PSOERXA1",212,0)
 I 'ERXIEN Q ""
"RTN","PSOERXA1",213,0)
 I $G(RTHIEN)]"" D
"RTN","PSOERXA1",214,0)
 .N REFREQ,NRXIEN
"RTN","PSOERXA1",215,0)
 .S NRXIEN=$$FINDNRX^PSOERXU6(ERXIEN)
"RTN","PSOERXA1",216,0)
 .I MTCODE="RE" D
"RTN","PSOERXA1",217,0)
 ..S REFREQ=$$GETREQ^PSOERXU2(ERXIEN)
"RTN","PSOERXA1",218,0)
 ..I REFREQ S NRXIEN=$$FINDNRX^PSOERXU6(REFREQ)
"RTN","PSOERXA1",219,0)
 ..I $D(^PS(52.49,NRXIEN,201,"B",ERXIEN)) Q
"RTN","PSOERXA1",220,0)
 ..I $G(NRXIEN) S FDA2(52.49201,"+1,"_NRXIEN_",",.01)=ERXIEN D UPDATE^DIE(,"FDA2") K FDA2
"RTN","PSOERXA1",221,0)
 .; link this message to the original
"RTN","PSOERXA1",222,0)
 .I $G(NRXIEN) D
"RTN","PSOERXA1",223,0)
 ..I $D(^PS(52.49,NRXIEN,201,"B",ERXIEN)) Q
"RTN","PSOERXA1",224,0)
 ..S FDA2(52.49201,"+1,"_NRXIEN_",",.01)=ERXIEN D UPDATE^DIE(,"FDA2") K FDA2
"RTN","PSOERXA1",225,0)
 .I '$D(^PS(52.49,RTHIEN,201,"B",ERXIEN)) D
"RTN","PSOERXA1",226,0)
 ..S FDA2(52.49201,"+1,"_RTHIEN_",",.01)=ERXIEN D UPDATE^DIE(,"FDA2") K FDA2
"RTN","PSOERXA1",227,0)
 .; link original message to this erxien
"RTN","PSOERXA1",228,0)
 .I '$D(^PS(52.49,ERXIEN,201,"B",RTHIEN)) D
"RTN","PSOERXA1",229,0)
 ..S FDA2(52.49201,"+1,"_ERXIEN_",",.01)=RTHIEN D UPDATE^DIE(,"FDA2") K FDA2
"RTN","PSOERXA1",230,0)
 I MTYPE["Error" D ERR^PSOERXU2(ERXIEN,MTYPE)
"RTN","PSOERXA1",231,0)
 ; Future consideration - XSD shows digital signature. Do we need to collect this?
"RTN","PSOERXA1",232,0)
 Q ERXIEN
"RTN","PSOERXA1",233,0)
OBS(ERXIEN,MTYPE) ; Observation
"RTN","PSOERXA1",234,0)
 N GL,I,LAST,DIM,MSOURCE,MUNIT,OBSDT,MVAL,OBSNOTE,OBSCNT,F,EIENS,FDA
"RTN","PSOERXA1",235,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,MTYPE,0,"Observation",0))
"RTN","PSOERXA1",236,0)
 S F=52.4914,EIENS=ERXIEN_","
"RTN","PSOERXA1",237,0)
 S I=-1,OBSCNT=0 F  S I=$O(@GL@("Measurement",I)) Q:I=""  D
"RTN","PSOERXA1",238,0)
 .S OBSCNT=OBSCNT+1,FDA(F,"+1,"_EIENS,.01)=OBSCNT
"RTN","PSOERXA1",239,0)
 .S DIM=$G(@GL@("Measurement",I,"Dimension",0)),FDA(F,"+1,"_EIENS,.02)=DIM
"RTN","PSOERXA1",240,0)
 .S MSOURCE=$G(@GL@("Measurement",I,"MeasurementSourceCode",0)),FDA(F,"+1,"_EIENS,.06)=MSOURCE
"RTN","PSOERXA1",241,0)
 .S MUNIT=$G(@GL@("Measurement",I,"MeasurementUnitCode",0)),FDA(F,"+1,"_EIENS,.07)=MUNIT
"RTN","PSOERXA1",242,0)
 .; Future enhancement - we have a field for MeasurementDataQualifier (.05) - is this valid?
"RTN","PSOERXA1",243,0)
 .S OBSDT=$G(@GL@("Measurement",I,"ObservationDate",0,"Date",0)),OBSDT=$$CONVDTTM^PSOERXA1(OBSDT),FDA(F,"+1,"_EIENS,.04)=OBSDT
"RTN","PSOERXA1",244,0)
 .S MVAL=$G(@GL@("Measurement",I,"Value",0)),FDA(F,"+1,"_EIENS,.03)=MVAL
"RTN","PSOERXA1",245,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",246,0)
 S OBSNOTE=$G(@GL@("ObservationNotes",0)),FDA(52.49,EIENS,15)=OBSNOTE D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",247,0)
 Q
"RTN","PSOERXA1",248,0)
PAT(ERXIEN,MTYPE) ; patient
"RTN","PSOERXA1",249,0)
 N GL,AL1,AL2,CITY,STATE,ZIP,LN,FN,MN,PREF,SUFF,COMQUAL,COMVAL,PLQUAL,DOB,GEN,PRELATE,IDDONE,CDONE,I,C,CQUAL,CVAL
"RTN","PSOERXA1",250,0)
 N IDNM,IDVAL,PFN,ERXPAT,NEWPAT,F,EIENS,FDA,IDFND,SRCH,PIENS,NPIEN,PATSSN,PREL,SIEN
"RTN","PSOERXA1",251,0)
 S F=52.46
"RTN","PSOERXA1",252,0)
 S EIENS=ERXIEN_","
"RTN","PSOERXA1",253,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,MTYPE,0,"Patient",0))
"RTN","PSOERXA1",254,0)
 S PREL=$G(@GL@("PatientRelationship",0))
"RTN","PSOERXA1",255,0)
 S FN=$$UP^XLFSTR($G(@GL@("Name",0,"FirstName",0)))
"RTN","PSOERXA1",256,0)
 S LN=$$UP^XLFSTR($G(@GL@("Name",0,"LastName",0)))
"RTN","PSOERXA1",257,0)
 S MN=$$UP^XLFSTR($G(@GL@("Name",0,"MiddleName",0)))
"RTN","PSOERXA1",258,0)
 S PFN=LN_","_FN_$S(MN]"":" "_MN,1:"")
"RTN","PSOERXA1",259,0)
 S SUFF=$$UP^XLFSTR($G(@GL@("Name",0,"Suffix",0)))
"RTN","PSOERXA1",260,0)
 S PREF=$$UP^XLFSTR($G(@GL@("Name",0,"Prefix",0)))
"RTN","PSOERXA1",261,0)
 S PRELATE=$G(@GL@("PatientRelationship",0))
"RTN","PSOERXA1",262,0)
 S GEN=$G(@GL@("Gender",0))
"RTN","PSOERXA1",263,0)
 S DOB=$G(@GL@("DateOfBirth",0,"Date",0)),DOB=$$CONVDTTM^PSOERXA1(DOB)
"RTN","PSOERXA1",264,0)
 I DOB<1 S DOB=""
"RTN","PSOERXA1",265,0)
 S AL1=$G(@GL@("Address",0,"AddressLine1",0))
"RTN","PSOERXA1",266,0)
 S AL2=$G(@GL@("Address",0,"AddressLine2",0))
"RTN","PSOERXA1",267,0)
 S CITY=$G(@GL@("Address",0,"City",0))
"RTN","PSOERXA1",268,0)
 S STATE=$G(@GL@("Address",0,"State",0))
"RTN","PSOERXA1",269,0)
 S ZIP=$G(@GL@("Address",0,"ZipCode",0))
"RTN","PSOERXA1",270,0)
 S SIEN=$$STRES^PSOERXA2(ZIP,STATE)
"RTN","PSOERXA1",271,0)
 ; need to check for SSN before trying to match the patient. This needs to be stored in an array for later processing
"RTN","PSOERXA1",272,0)
 ; check 52.46 for a match before filing
"RTN","PSOERXA1",273,0)
 S PATSSN=$G(@GL@("Identification",0,"SocialSecurity",0))
"RTN","PSOERXA1",274,0)
 S ERXPAT=$$FINDPAT^PSOERXU2(PFN,DOB,GEN,$G(PATSSN),$G(AL1)) S PIENS=$S(ERXPAT:ERXPAT_",",1:"+1,")
"RTN","PSOERXA1",275,0)
 ; first, lets set up the main part
"RTN","PSOERXA1",276,0)
 S FDA(F,PIENS,.01)=PFN,FDA(F,PIENS,.02)=LN,FDA(F,PIENS,.03)=FN,FDA(F,PIENS,.04)=MN,FDA(F,PIENS,.05)=SUFF,FDA(F,PIENS,.06)=PREF
"RTN","PSOERXA1",277,0)
 S FDA(F,PIENS,.07)=GEN,FDA(F,PIENS,.08)=DOB
"RTN","PSOERXA1",278,0)
 S FDA(F,PIENS,1.4)=PATSSN,FDA(F,PIENS,1.7)=PREL
"RTN","PSOERXA1",279,0)
 S FDA(F,PIENS,3.1)=AL1,FDA(F,PIENS,3.2)=AL2,FDA(F,PIENS,3.3)=CITY
"RTN","PSOERXA1",280,0)
 S FDA(F,PIENS,3.4)=SIEN
"RTN","PSOERXA1",281,0)
 S FDA(F,PIENS,3.5)=ZIP
"RTN","PSOERXA1",282,0)
 I PIENS["+" D  Q
"RTN","PSOERXA1",283,0)
 .D UPDATE^DIE(,"FDA","NEWPAT") K FDA
"RTN","PSOERXA1",284,0)
 .S NPIEN=$O(NEWPAT(0)),NPIEN=$G(NEWPAT(NPIEN))
"RTN","PSOERXA1",285,0)
 .Q:'NPIEN
"RTN","PSOERXA1",286,0)
 .S NPIEN=NPIEN
"RTN","PSOERXA1",287,0)
 .D PATC(NPIEN)
"RTN","PSOERXA1",288,0)
 .S FDA(52.49,EIENS,.04)=NPIEN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",289,0)
 D FILE^DIE(,"FDA") K FDA D PATC(ERXPAT)
"RTN","PSOERXA1",290,0)
 S FDA(52.49,EIENS,.04)=ERXPAT D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",291,0)
 Q
"RTN","PSOERXA1",292,0)
PATC(IEN) ; patient communication
"RTN","PSOERXA1",293,0)
 N IENS,CQUAL,CVAL,COMARY,FDA,SRCH,IDFND,IDNM,IDVAL,IDARY,PATSSN
"RTN","PSOERXA1",294,0)
 Q:'IEN
"RTN","PSOERXA1",295,0)
 S IENS=IEN_","
"RTN","PSOERXA1",296,0)
 ; Kill off existing communication values
"RTN","PSOERXA1",297,0)
 K ^PS(52.46,IEN,3)
"RTN","PSOERXA1",298,0)
 S C=-1 F  S C=$O(@GL@("CommunicationNumbers",0,"Communication",C)) Q:C=""  D
"RTN","PSOERXA1",299,0)
 .S CQUAL=$G(@GL@("CommunicationNumbers",0,"Communication",C,"Qualifier",0))
"RTN","PSOERXA1",300,0)
 .S CVAL=$G(@GL@("CommunicationNumbers",0,"Communication",C,"Number",0))
"RTN","PSOERXA1",301,0)
 .S COMARY(CQUAL)=CVAL
"RTN","PSOERXA1",302,0)
 .S FDA(52.462,"+1,"_IENS,.01)=CVAL
"RTN","PSOERXA1",303,0)
 .S FDA(52.462,"+1,"_IENS,.02)=CQUAL
"RTN","PSOERXA1",304,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",305,0)
 ; kill existing identification values in multiple
"RTN","PSOERXA1",306,0)
 K ^PS(52.46,IEN,5)
"RTN","PSOERXA1",307,0)
 S IDNM="" F  S IDNM=$O(@GL@("Identification",0,IDNM)) Q:IDNM=""  D
"RTN","PSOERXA1",308,0)
 .S IDVAL=$G(@GL@("Identification",0,IDNM,0))
"RTN","PSOERXA1",309,0)
 .I IDNM="SocialSecurity" S PATSSN=IDVAL
"RTN","PSOERXA1",310,0)
 .S IDARY(IDNM)=IDVAL
"RTN","PSOERXA1",311,0)
 .S IDFND=0
"RTN","PSOERXA1",312,0)
 .S SRCH=0 F  S SRCH=$O(^PS(52.46,IEN,5,SRCH)) Q:'SRCH  D
"RTN","PSOERXA1",313,0)
 ..I $$GET1^DIQ(52.465,SRCH_","_IEN_",",.01)=IDNM D
"RTN","PSOERXA1",314,0)
 ...S IDFND=1
"RTN","PSOERXA1",315,0)
 ...S FDA(52.465,SRCH_","_IEN_",",.02)=IDVAL D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",316,0)
 .Q:IDFND
"RTN","PSOERXA1",317,0)
 .S FDA(52.465,"+1,"_IEN_",",.01)=IDNM
"RTN","PSOERXA1",318,0)
 .S FDA(52.465,"+1,"_IEN_",",.02)=IDVAL
"RTN","PSOERXA1",319,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",320,0)
 I $G(PATSSN)]"" S FDA(52.46,IENS,1.4)=PATSSN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",321,0)
 Q
"RTN","PSOERXA1",322,0)
SPUSH(S,X) ;places X on the stack S and returns the current level of the stack
"RTN","PSOERXA1",323,0)
 N I S I=$O(S(""),-1)+1,S(I)=X
"RTN","PSOERXA1",324,0)
 Q I
"RTN","PSOERXA1",325,0)
 ;
"RTN","PSOERXA1",326,0)
SPOP(S,X) ;removes the top item from the stack S and put it into the variable X and returns the level that X was at
"RTN","PSOERXA1",327,0)
 N I S I=$O(S(""),-1)
"RTN","PSOERXA1",328,0)
 I I S X=S(I) K S(I)
"RTN","PSOERXA1",329,0)
 N J S J=$O(S(I),-1) I J S S(J,X)=$G(S(J,X))+1
"RTN","PSOERXA1",330,0)
 Q I
"RTN","PSOERXA1",331,0)
 ;
"RTN","PSOERXA1",332,0)
SPEEK(S,X) ;same as SPOP except the top item is not removed
"RTN","PSOERXA1",333,0)
 N I S I=$O(S(""),-1)
"RTN","PSOERXA1",334,0)
 I I S X=S(I)
"RTN","PSOERXA1",335,0)
 Q I
"RTN","PSOERXA1",336,0)
 ;
"RTN","PSOERXA1",337,0)
SPUT(S,X) ;implementation specific, uses the stack to form a global node
"RTN","PSOERXA1",338,0)
 N I,STR
"RTN","PSOERXA1",339,0)
 S X=$TR(X,";","")
"RTN","PSOERXA1",340,0)
 S STR=$P(GL,")")
"RTN","PSOERXA1",341,0)
 S I=0 F  S I=$O(S(I)) Q:'I  D
"RTN","PSOERXA1",342,0)
 .S STR=STR_","_""""_S(I)_""""_","
"RTN","PSOERXA1",343,0)
 .N NUM S NUM=0
"RTN","PSOERXA1",344,0)
 .I $D(S(I-1,S(I))) S NUM=+$G(S(I-1,S(I)))
"RTN","PSOERXA1",345,0)
 .S STR=STR_NUM
"RTN","PSOERXA1",346,0)
 S STR=STR_")"
"RTN","PSOERXA1",347,0)
 I $D(@STR) S @STR=@STR_X
"RTN","PSOERXA1",348,0)
 I '$D(@STR) S @STR=X
"RTN","PSOERXA1",349,0)
 Q STR
"RTN","PSOERXA1",350,0)
APUT(S,X,LN) ; what am i doing here?
"RTN","PSOERXA1",351,0)
 N I,STR
"RTN","PSOERXA1",352,0)
 S X=$TR(X,";","")
"RTN","PSOERXA1",353,0)
 S STR=$P(GL,")")
"RTN","PSOERXA1",354,0)
 S I=0 F  S I=$O(S(I)) Q:'I  D
"RTN","PSOERXA1",355,0)
 .S STR=STR_","_""""_S(I)_""""_","
"RTN","PSOERXA1",356,0)
 .N NUM S NUM="""A"""
"RTN","PSOERXA1",357,0)
 .;I $D(S(I-1,S(I))) S NUM=+$G(S(I-1,S(I)))
"RTN","PSOERXA1",358,0)
 .;S STR=STR_NUM
"RTN","PSOERXA1",359,0)
 .S STR=STR_NUM_","_""""_LN_""""
"RTN","PSOERXA1",360,0)
 S STR=STR_")"
"RTN","PSOERXA1",361,0)
 I $D(@STR) S @STR=@STR_X
"RTN","PSOERXA1",362,0)
 I '$D(@STR) S @STR=X
"RTN","PSOERXA1",363,0)
 Q STR
"RTN","PSOERXA1",364,0)
 ;
"RTN","PSOERXA1",365,0)
 ; VAL - value to resolve
"RTN","PSOERXA1",366,0)
 ; TYPE - This is the code type, which will tell which 'C' index type to get the code from
"RTN","PSOERXA1",367,0)
PRESOLV(VAL,TYPE) ;
"RTN","PSOERXA1",368,0)
 N MATCH
"RTN","PSOERXA1",369,0)
 S MATCH=""
"RTN","PSOERXA1",370,0)
 Q:'$L(TYPE)!('$L(VAL)) "" ; avoid null subscript
"RTN","PSOERXA1",371,0)
 S MATCH=$O(^PS(52.45,"C",TYPE,VAL,0))
"RTN","PSOERXA1",372,0)
 ; return the match found, null if no match
"RTN","PSOERXA1",373,0)
 Q MATCH
"RTN","PSOERXA1",374,0)
CONVDTTM(VAL) ;
"RTN","PSOERXA1",375,0)
 N EDATE,ETIME,X,ETZ,Y
"RTN","PSOERXA1",376,0)
 I '$L(VAL) Q ""
"RTN","PSOERXA1",377,0)
 S EDATE=$P(VAL,"T"),ETIME=$P(VAL,"T",2)
"RTN","PSOERXA1",378,0)
 ; split off time zone
"RTN","PSOERXA1",379,0)
 S ETZ=$P(ETIME,".",2)
"RTN","PSOERXA1",380,0)
 S ETIME=$P(ETIME,".")
"RTN","PSOERXA1",381,0)
 S X=EDATE D ^%DT I 'Y Q ""
"RTN","PSOERXA1",382,0)
 S VAL=Y_$S($L(ETIME):"."_$TR(ETIME,":",""),1:"")
"RTN","PSOERXA1",383,0)
 Q VAL
"RTN","PSOERXA2")
0^3^B111979280^B104569280
"RTN","PSOERXA2",1,0)
PSOERXA2 ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERXA2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,508**;DEC 1997;Build 295
"RTN","PSOERXA2",3,0)
 ;
"RTN","PSOERXA2",4,0)
 Q
"RTN","PSOERXA2",5,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE ( ADD BOTH THE 'FAC' AND 'FIC' LINETAG TO YOUR ROUTINE )
"RTN","PSOERXA2",6,0)
FAC(ERXIEN) ; facility
"RTN","PSOERXA2",7,0)
 N GL,IDTYPE,IDVAL,F,FIEN,IENS,FNAME,FACFDA,AL1,AL2,CITY,STATE,ZIP,PLQUAL,FACFDA,SIEN
"RTN","PSOERXA2",8,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,"NewRx",0,"Facility",0))
"RTN","PSOERXA2",9,0)
 S F=52.49,FIEN="",IENS=ERXIEN_","
"RTN","PSOERXA2",10,0)
 S FNAME=$G(@GL@("FacilityName",0))
"RTN","PSOERXA2",11,0)
 S FACFDA(F,IENS,70.1)=FNAME
"RTN","PSOERXA2",12,0)
 S AL1=$G(@GL@("Address",0,"AddressLine1",0)),FACFDA(F,IENS,70.2)=AL1
"RTN","PSOERXA2",13,0)
 S AL2=$G(@GL@("Address",0,"AddressLine2",0)),FACFDA(F,IENS,70.3)=AL2
"RTN","PSOERXA2",14,0)
 S CITY=$G(@GL@("Address",0,"City",0)),FACFDA(F,IENS,70.4)=CITY
"RTN","PSOERXA2",15,0)
 S STATE=$G(@GL@("Address",0,"State",0))
"RTN","PSOERXA2",16,0)
 S ZIP=$G(@GL@("Address",0,"ZipCode",0)),FACFDA(F,IENS,70.6)=ZIP
"RTN","PSOERXA2",17,0)
 S SIEN=$$STRES(ZIP,STATE)
"RTN","PSOERXA2",18,0)
 S FACFDA(F,IENS,70.5)=SIEN
"RTN","PSOERXA2",19,0)
 S PLQUAL=$G(@GL@("Address",0,"PlaceLocationQualifier",0)),FACFDA(F,IENS,70.7)=PLQUAL
"RTN","PSOERXA2",20,0)
 D FILE^DIE(,"FACFDA","ERR") K FACFDA ;D FIC($P(FIEN,","))
"RTN","PSOERXA2",21,0)
 D FIC(ERXIEN)
"RTN","PSOERXA2",22,0)
 ; future enhancement - file ID types - requires modification to the current payer information subfile
"RTN","PSOERXA2",23,0)
 ; - THIS REQUIRES RESOLUTION OF THE PAYERID TYPE ISSUE ALONG WITH PRIOR AUTH VALUES, ETC.
"RTN","PSOERXA2",24,0)
 ;S IDTYPE="" F S IDTYPE=$O(@GL@("Identification",0,IDTYPE)) Q:IDTYPE="" D
"RTN","PSOERXA2",25,0)
 ;S IDVAL=$G(@GL@("Identification",0,IDTYPE,0))
"RTN","PSOERXA2",26,0)
 Q
"RTN","PSOERXA2",27,0)
FIC(IEN) ;
"RTN","PSOERXA2",28,0)
 N IDTYP,IDVAL,FDA,I,CCNT,FIEN,FACFDA,IDCNT,ERR
"RTN","PSOERXA2",29,0)
 Q:'IEN
"RTN","PSOERXA2",30,0)
 S IENS=IEN_","
"RTN","PSOERXA2",31,0)
 S IDCNT=0
"RTN","PSOERXA2",32,0)
 K ^PS(52.49,IEN,71)
"RTN","PSOERXA2",33,0)
 S IDNM="" F  S IDNM=$O(@GL@("Identification",0,IDNM)) Q:IDNM=""  D
"RTN","PSOERXA2",34,0)
 .S IDVAL=$G(@GL@("Identification",0,IDNM,0))
"RTN","PSOERXA2",35,0)
 .I IDNM="NCPDPID",$G(NCPDPID)']"" S NCPDPID=$G(IDVAL)
"RTN","PSOERXA2",36,0)
 .S IDARY(IDNM)=IDVAL
"RTN","PSOERXA2",37,0)
 .S IDFND=0
"RTN","PSOERXA2",38,0)
 .S SRCH=0 F  S SRCH=$O(^PS(52.49,IEN,71,SRCH)) Q:'SRCH  D
"RTN","PSOERXA2",39,0)
 ..I $$GET1^DIQ(52.4971,SRCH_","_IEN_",",.01)=IDNM D
"RTN","PSOERXA2",40,0)
 ...S IDFND=1
"RTN","PSOERXA2",41,0)
 ...S FACFDA(52.4971,SRCH_","_IEN_",",.02)=IDVAL D FILE^DIE(,"FACFDA","ERR") K FACFDA
"RTN","PSOERXA2",42,0)
 .Q:IDFND
"RTN","PSOERXA2",43,0)
 .S FACFDA(52.4971,"+1,"_IEN_",",.01)=IDNM
"RTN","PSOERXA2",44,0)
 .S FACFDA(52.4971,"+1,"_IEN_",",.02)=IDVAL
"RTN","PSOERXA2",45,0)
 .D UPDATE^DIE(,"FACFDA") K FACFDA
"RTN","PSOERXA2",46,0)
 ; clear out existing communication Numbers
"RTN","PSOERXA2",47,0)
 K ^PS(52.49,IEN,72)
"RTN","PSOERXA2",48,0)
 S I=-1 F  S I=$O(@GL@("CommunicationNumbers",0,"Communication",I)) Q:I=""  D
"RTN","PSOERXA2",49,0)
 .S CCNT=$G(CCNT)+1
"RTN","PSOERXA2",50,0)
 .S COMVAL=$G(@GL@("CommunicationNumbers",0,"Communication",I,"Number",0))
"RTN","PSOERXA2",51,0)
 .S COMTYP=$G(@GL@("CommunicationNumbers",0,"Communication",I,"Qualifier",0))
"RTN","PSOERXA2",52,0)
 .S FACFDA(52.4972,"+"_CCNT_","_IEN_",",.01)=COMVAL
"RTN","PSOERXA2",53,0)
 .S FACFDA(52.4972,"+"_CCNT_","_IEN_",",.02)=COMTYP
"RTN","PSOERXA2",54,0)
 D UPDATE^DIE(,"FACFDA") K FACFDA
"RTN","PSOERXA2",55,0)
 Q
"RTN","PSOERXA2",56,0)
 ;/BLB/ PSO*7.0*520 - END CHANGE
"RTN","PSOERXA2",57,0)
PHR(ERXIEN,MTYPE) ; pharamcy
"RTN","PSOERXA2",58,0)
 N GL,SNAME,AL1,AL2,CIT,STATE,ZIP,PLQUAL,COMTYP,COMVAL,I,F,EIENS,PHIEN,CCNT,NEW,SPEC,FDA,NEWPHIEN,GL2,FQUAL,FROM,SIEN
"RTN","PSOERXA2",59,0)
 N NCPDPID
"RTN","PSOERXA2",60,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,MTYPE,0,"Pharmacy",0))
"RTN","PSOERXA2",61,0)
 S GL2=$NA(^TMP($J,"PSOERXO1","Message","A","Qualifier","Header","A","Qualifier"))
"RTN","PSOERXA2",62,0)
 S FQUAL=$G(@GL2@("From","A","Qualifier"))
"RTN","PSOERXA2",63,0)
 S FROM=$G(@GL@("From",0))
"RTN","PSOERXA2",64,0)
 I FQUAL="P",FROM]"" S NCPDPID=FROM
"RTN","PSOERXA2",65,0)
 S F=52.47,PHIEN=""
"RTN","PSOERXA2",66,0)
 S EIENS=ERXIEN_","
"RTN","PSOERXA2",67,0)
 S SNAME=$G(@GL@("StoreName",0))
"RTN","PSOERXA2",68,0)
 Q:'$L(SNAME)
"RTN","PSOERXA2",69,0)
 I $D(^PS(52.47,"B",SNAME)) S PHIEN=$O(^PS(52.47,"B",SNAME,0)) I PHIEN S PHIEN=PHIEN_",",NEW=0
"RTN","PSOERXA2",70,0)
 ; if we found a match, clear out the existing communication numbers and identification
"RTN","PSOERXA2",71,0)
 I PHIEN K ^PS(52.47,$P(PHIEN,","),3),^PS(52.47,$P(PHIEN,","),2)
"RTN","PSOERXA2",72,0)
 I '$G(PHIEN) S PHIEN="+1,",NEW=1,FDA(F,PHIEN,.01)=SNAME
"RTN","PSOERXA2",73,0)
 S FDA(F,PHIEN,.05)=SNAME
"RTN","PSOERXA2",74,0)
 S SPEC=$G(@GL@("Specialty",0)),FDA(F,PHIEN,1.8)=SPEC
"RTN","PSOERXA2",75,0)
 S AL1=$G(@GL@("Address",0,"AddressLine1",0)),FDA(F,PHIEN,1.1)=AL1
"RTN","PSOERXA2",76,0)
 S AL2=$G(@GL@("Address",0,"AddressLine2",0)),FDA(F,PHIEN,1.2)=AL2
"RTN","PSOERXA2",77,0)
 S CITY=$G(@GL@("Address",0,"City",0)),FDA(F,PHIEN,1.3)=CITY
"RTN","PSOERXA2",78,0)
 S STATE=$G(@GL@("Address",0,"State",0))
"RTN","PSOERXA2",79,0)
 S ZIP=$G(@GL@("Address",0,"ZipCode",0)),FDA(F,PHIEN,1.5)=ZIP
"RTN","PSOERXA2",80,0)
 S SIEN=$$STRES(ZIP,STATE)
"RTN","PSOERXA2",81,0)
 S FDA(F,PHIEN,1.4)=SIEN
"RTN","PSOERXA2",82,0)
 S PLQUAL=$G(@GL@("Address",0,"PlaceLocationQualifier",0)),FDA(F,PHIEN,1.7)=PLQUAL
"RTN","PSOERXA2",83,0)
 ; if this is an existing pharmacy entry, file the updates, communication values, and identification, then link to 52.49
"RTN","PSOERXA2",84,0)
 I 'NEW D  Q
"RTN","PSOERXA2",85,0)
 .D FILE^DIE(,"FDA") K FDA D PHRIC($P(PHIEN,","))
"RTN","PSOERXA2",86,0)
 .S FDA(52.49,EIENS,2.5)=$P(PHIEN,",") D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",87,0)
 ; for a new entry, file the entry, then file communication/identification and link to 52.49
"RTN","PSOERXA2",88,0)
 D UPDATE^DIE(,"FDA","NEWPHIEN") K FDA
"RTN","PSOERXA2",89,0)
 S PHIEN=$O(NEWPHIEN(0)),PHIEN=$G(NEWPHIEN(PHIEN))
"RTN","PSOERXA2",90,0)
 Q:'PHIEN
"RTN","PSOERXA2",91,0)
 D PHRIC(PHIEN)
"RTN","PSOERXA2",92,0)
 S FDA(52.49,EIENS,2.5)=PHIEN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",93,0)
 Q
"RTN","PSOERXA2",94,0)
PHRIC(IEN) ; pharmacy identification and communication information
"RTN","PSOERXA2",95,0)
 N IDTYP,IDVAL,FDA,I,CCNT,PHIEN,FDA,IDCNT
"RTN","PSOERXA2",96,0)
 Q:'IEN
"RTN","PSOERXA2",97,0)
 S PHIEN=IEN_","
"RTN","PSOERXA2",98,0)
 S IDCNT=0
"RTN","PSOERXA2",99,0)
 K ^PS(52.47,IEN,2)
"RTN","PSOERXA2",100,0)
 S IDNM="" F  S IDNM=$O(@GL@("Identification",0,IDNM)) Q:IDNM=""  D
"RTN","PSOERXA2",101,0)
 .S IDVAL=$G(@GL@("Identification",0,IDNM,0))
"RTN","PSOERXA2",102,0)
 .I IDNM="NCPDPID",$G(NCPDPID)']"" S NCPDPID=$G(IDVAL)
"RTN","PSOERXA2",103,0)
 .S IDARY(IDNM)=IDVAL
"RTN","PSOERXA2",104,0)
 .S IDFND=0
"RTN","PSOERXA2",105,0)
 .S SRCH=0 F  S SRCH=$O(^PS(52.47,IEN,2,SRCH)) Q:'SRCH  D
"RTN","PSOERXA2",106,0)
 ..I $$GET1^DIQ(52.472,SRCH_","_IEN_",",.01)=IDNM D
"RTN","PSOERXA2",107,0)
 ...S IDFND=1
"RTN","PSOERXA2",108,0)
 ...S FDA(52.472,SRCH_","_IEN_",",.02)=IDVAL D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",109,0)
 .Q:IDFND
"RTN","PSOERXA2",110,0)
 .S FDA(52.472,"+1,"_IEN_",",.01)=IDNM
"RTN","PSOERXA2",111,0)
 .S FDA(52.472,"+1,"_IEN_",",.02)=IDVAL
"RTN","PSOERXA2",112,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",113,0)
 I $G(NCPDPID)]"" S FDA(52.47,PHIEN,.02)=NCPDPID D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",114,0)
 ; clear out existing communication Numbers
"RTN","PSOERXA2",115,0)
 K ^PS(52.47,IEN,3)
"RTN","PSOERXA2",116,0)
 S I=-1 F  S I=$O(@GL@("CommunicationNumbers",0,"Communication",I)) Q:I=""  D
"RTN","PSOERXA2",117,0)
 .S CCNT=$G(CCNT)+1
"RTN","PSOERXA2",118,0)
 .S COMVAL=$G(@GL@("CommunicationNumbers",0,"Communication",I,"Number",0))
"RTN","PSOERXA2",119,0)
 .S COMTYP=$G(@GL@("CommunicationNumbers",0,"Communication",I,"Qualifier",0))
"RTN","PSOERXA2",120,0)
 .S FDA(52.473,"+"_CCNT_","_PHIEN,.01)=COMVAL
"RTN","PSOERXA2",121,0)
 .S FDA(52.473,"+"_CCNT_","_PHIEN,.02)=COMTYP
"RTN","PSOERXA2",122,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",123,0)
 Q
"RTN","PSOERXA2",124,0)
PRE(ERXIEN,MTYPE) ; prescriber
"RTN","PSOERXA2",125,0)
 N GL,FN,LN,MN,SUFF,PREF,AL1,AL2,CITY,STATE,ZIP,IDDONE,I,IDNM,IDVAL,C,CQUAL,CVAL,SPEC,AFN,ALN,AMN,APREF,ASUFF,FULLNM
"RTN","PSOERXA2",126,0)
 N EIENS,FDA,NPIEN,NEW,PRVIEN,PRVIENS,NEWIEN,IDFND,SRCH,PNPI,PDEA,GL2,FQUAL,FROM,SIEN
"RTN","PSOERXA2",127,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,MTYPE,0,"Prescriber",0))
"RTN","PSOERXA2",128,0)
 S GL2=$NA(^TMP($J,"PSOERXO1","Message","A","Qualifier","Header","A","Qualifier"))
"RTN","PSOERXA2",129,0)
 S FQUAL=$G(@GL2@("From","A","Qualifier"))
"RTN","PSOERXA2",130,0)
 S FROM=$G(@GL@("From",0))
"RTN","PSOERXA2",131,0)
 I FQUAL="D",FROM]"" S PNPI=FROM
"RTN","PSOERXA2",132,0)
 S F=52.48
"RTN","PSOERXA2",133,0)
 S EIENS=ERXIEN_","
"RTN","PSOERXA2",134,0)
 S FN=$$UP^XLFSTR($G(@GL@("Name",0,"FirstName",0)))
"RTN","PSOERXA2",135,0)
 S LN=$$UP^XLFSTR($G(@GL@("Name",0,"LastName",0)))
"RTN","PSOERXA2",136,0)
 S MN=$$UP^XLFSTR($G(@GL@("Name",0,"MiddleName",0)))
"RTN","PSOERXA2",137,0)
 S FULLNM=LN_","_FN_$S(MN]"":" "_MN,1:"")
"RTN","PSOERXA2",138,0)
 S SUFF=$$UP^XLFSTR($G(@GL@("Name",0,"Suffix",0)))
"RTN","PSOERXA2",139,0)
 S PREF=$$UP^XLFSTR($G(@GL@("Name",0,"Prefix",0)))
"RTN","PSOERXA2",140,0)
 S AL1=$G(@GL@("Address",0,"AddressLine1",0))
"RTN","PSOERXA2",141,0)
 S AL2=$G(@GL@("Address",0,"AddressLine2",0))
"RTN","PSOERXA2",142,0)
 S CITY=$G(@GL@("Address",0,"City",0))
"RTN","PSOERXA2",143,0)
 S STATE=$G(@GL@("Address",0,"State",0))
"RTN","PSOERXA2",144,0)
 S ZIP=$G(@GL@("Address",0,"ZipCode",0))
"RTN","PSOERXA2",145,0)
 S SIEN=$$STRES(ZIP,STATE)
"RTN","PSOERXA2",146,0)
 S SPEC=$G(@GL@("Specialty",0))
"RTN","PSOERXA2",147,0)
 S AFN=$$UP^XLFSTR($G(@GL@("PrescriberAgent",0,"FirstName",0)))
"RTN","PSOERXA2",148,0)
 S ALN=$$UP^XLFSTR($G(@GL@("PrescriberAgent",0,"LastName",0)))
"RTN","PSOERXA2",149,0)
 S AMN=$$UP^XLFSTR($G(@GL@("PrescriberAgent",0,"MiddleName",0)))
"RTN","PSOERXA2",150,0)
 S APREF=$$UP^XLFSTR($G(@GL@("PrescriberAgent",0,"Prefix",0)))
"RTN","PSOERXA2",151,0)
 S ASUFF=$$UP^XLFSTR($G(@GL@("PrescriberAgent",0,"Suffix",0)))
"RTN","PSOERXA2",152,0)
 ; try to match the provider/supervisor. if no match, create a  new entry for this provider
"RTN","PSOERXA2",153,0)
 ; if there is no NPI, grab it from the Identification multiple.
"RTN","PSOERXA2",154,0)
 I '$G(PNPI) S PNPI=$G(@GL@("Identification",0,"NPI",0))
"RTN","PSOERXA2",155,0)
 S PDEA=$G(@GL@("Identification",0,"DEANumber",0))
"RTN","PSOERXA2",156,0)
 S STLIC=$G(@GL@("Identification",0,"StateLicenseNumber",0))
"RTN","PSOERXA2",157,0)
 S PRVIEN=$$FINDPRE^PSOERXU2(FULLNM,$G(PNPI),PDEA) I PRVIEN S NEW=0
"RTN","PSOERXA2",158,0)
 I 'PRVIEN S NEW=1,PRVIEN="+1"
"RTN","PSOERXA2",159,0)
 S PRVIENS=PRVIEN_","
"RTN","PSOERXA2",160,0)
 S FDA(F,PRVIENS,.01)=FULLNM,FDA(F,PRVIENS,.02)=LN,FDA(F,PRVIENS,.03)=FN,FDA(F,PRVIENS,.04)=MN,FDA(F,PRVIENS,.05)=SUFF
"RTN","PSOERXA2",161,0)
 S FDA(F,PRVIENS,.06)=PREF,FDA(F,PRVIENS,4.1)=AL1,FDA(F,PRVIENS,4.2)=AL2,FDA(F,PRVIENS,4.3)=CITY
"RTN","PSOERXA2",162,0)
 S FDA(F,PRVIENS,4.4)=SIEN,FDA(F,PRVIENS,4.5)=ZIP
"RTN","PSOERXA2",163,0)
 S FDA(F,PRVIENS,5.1)=ALN,FDA(F,PRVIENS,5.2)=AFN,FDA(F,PRVIENS,5.3)=AMN,FDA(F,PRVIENS,5.4)=ASUFF,FDA(F,PRVIENS,5.5)=APREF
"RTN","PSOERXA2",164,0)
 S FDA(F,PRVIENS,1.2)=SPEC
"RTN","PSOERXA2",165,0)
 S FDA(F,PRVIENS,1.8)=$G(STLIC)
"RTN","PSOERXA2",166,0)
 S FDA(F,PRVIENS,1.1)="PR"
"RTN","PSOERXA2",167,0)
 I 'NEW D  Q
"RTN","PSOERXA2",168,0)
 .D FILE^DIE(,"FDA")
"RTN","PSOERXA2",169,0)
 .D PRVCI(PRVIEN)
"RTN","PSOERXA2",170,0)
 .S FDA(52.49,EIENS,2.1)=PRVIEN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",171,0)
 D UPDATE^DIE(,"FDA","NEWIEN") K FDA
"RTN","PSOERXA2",172,0)
 S NPIEN=$O(NEWIEN(0)),NPIEN=$G(NEWIEN(NPIEN))
"RTN","PSOERXA2",173,0)
 D PRVCI(NPIEN)
"RTN","PSOERXA2",174,0)
 S FDA(52.49,EIENS,2.1)=NPIEN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",175,0)
 Q
"RTN","PSOERXA2",176,0)
PRVCI(IEN) ;
"RTN","PSOERXA2",177,0)
 N IENS,C,CQUAL,CVAL,FDA,IDNM,IDVAL,IDARY,IDFND,SRCH,NCPDPID,PHIN,DEA,STLIC,PNPI
"RTN","PSOERXA2",178,0)
 S IENS=IEN_","
"RTN","PSOERXA2",179,0)
 ; kill off existing data
"RTN","PSOERXA2",180,0)
 K ^PS(52.48,IEN,3)
"RTN","PSOERXA2",181,0)
 S C=-1 F  S C=$O(@GL@("CommunicationNumbers",0,"Communication",C)) Q:C=""  D
"RTN","PSOERXA2",182,0)
 .S CQUAL=$G(@GL@("CommunicationNumbers",0,"Communication",C,"Qualifier",0))
"RTN","PSOERXA2",183,0)
 .S CVAL=$G(@GL@("CommunicationNumbers",0,"Communication",C,"Number",0))
"RTN","PSOERXA2",184,0)
 .S FDA(52.483,"+1,"_IENS,.01)=CVAL
"RTN","PSOERXA2",185,0)
 .S FDA(52.483,"+1,"_IENS,.02)=CQUAL
"RTN","PSOERXA2",186,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",187,0)
 ; kill existing Identification data.
"RTN","PSOERXA2",188,0)
 K ^PS(52.48,IEN,6)
"RTN","PSOERXA2",189,0)
 S IDNM="" F  S IDNM=$O(@GL@("Identification",0,IDNM)) Q:IDNM=""  D
"RTN","PSOERXA2",190,0)
 .S IDVAL=$G(@GL@("Identification",0,IDNM,0))
"RTN","PSOERXA2",191,0)
 .S IDARY(IDNM)=IDVAL
"RTN","PSOERXA2",192,0)
 .I IDNM="NCPDPID" S NCPDPID=IDVAL
"RTN","PSOERXA2",193,0)
 .I IDNM="HIN" S PHIN=IDVAL
"RTN","PSOERXA2",194,0)
 .I IDNM="DEANumber" S DEA=IDVAL
"RTN","PSOERXA2",195,0)
 .I IDNM="StateLicenseNumber" S STLIC=IDVAL
"RTN","PSOERXA2",196,0)
 .I IDNM="NPI" S PNPI=IDVAL
"RTN","PSOERXA2",197,0)
 .S IDFND=0
"RTN","PSOERXA2",198,0)
 .S SRCH=0 F  S SRCH=$O(^PS(52.48,IEN,6,SRCH)) Q:'SRCH  D
"RTN","PSOERXA2",199,0)
 ..I $$GET1^DIQ(52.486,SRCH_","_IEN_",",.01)=IDNM D
"RTN","PSOERXA2",200,0)
 ...S IDFND=1
"RTN","PSOERXA2",201,0)
 ...S FDA(52.486,SRCH_","_IEN_",",.02)=IDVAL D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",202,0)
 .Q:IDFND
"RTN","PSOERXA2",203,0)
 .S FDA(52.486,"+1,"_IEN_",",.01)=IDNM
"RTN","PSOERXA2",204,0)
 .S FDA(52.486,"+1,"_IEN_",",.02)=IDVAL
"RTN","PSOERXA2",205,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",206,0)
 S FDA(52.48,IENS,1.4)=$G(NCPDPID),FDA(52.48,IENS,1.5)=$G(PNPI),FDA(52.48,IENS,1.6)=$G(DEA),FDA(52.48,IENS,1.7)=$G(PHIN)
"RTN","PSOERXA2",207,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",208,0)
 Q
"RTN","PSOERXA2",209,0)
REQ ; request
"RTN","PSOERXA2",210,0)
 N GL,CRTYPE,RETREC,RRNUM
"RTN","PSOERXA2",211,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,"NewRx",0,"Request",0))
"RTN","PSOERXA2",212,0)
 S CRTYPE=$G(@GL@("ChangeRequestType",0))
"RTN","PSOERXA2",213,0)
 S RETREC=$G(@GL@("ReturnReceipt",0))
"RTN","PSOERXA2",214,0)
 S RRNUM=$G(@GL@("RequestReferenceNumber",0))
"RTN","PSOERXA2",215,0)
 ; FUTURE ENHANCEMENT - file this information when we are getting other request types.
"RTN","PSOERXA2",216,0)
 Q
"RTN","PSOERXA2",217,0)
SUP(ERXIEN,MTYPE) ; supervisor
"RTN","PSOERXA2",218,0)
 N GL,FN,LN,MN,SUFF,PREF,AL1,AL2,CITY,STATE,ZIP,IDDONE,I,IDNM,IDVAL,C,CQUAL,CVAL,SPEC,AFN,ALN,AMN,APREF,ASUFF,EIENS
"RTN","PSOERXA2",219,0)
 N FDA,NPIEN,NEW,PRVIEN,PRVIENS,NEWIEN,FDA,IDFND,SRCH,PNPI,PDEA,STLIC,SIEN
"RTN","PSOERXA2",220,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,MTYPE,0,"Supervisor",0))
"RTN","PSOERXA2",221,0)
 S EIENS=ERXIEN_","
"RTN","PSOERXA2",222,0)
 S FN=$$UP^XLFSTR($G(@GL@("Name",0,"FirstName",0)))
"RTN","PSOERXA2",223,0)
 S LN=$$UP^XLFSTR($G(@GL@("Name",0,"LastName",0))) Q:'$L(LN)
"RTN","PSOERXA2",224,0)
 S MN=$$UP^XLFSTR($G(@GL@("Name",0,"MiddleName",0)))
"RTN","PSOERXA2",225,0)
 S FULLNM=LN_","_FN_$S(MN]"":" "_MN,1:"")
"RTN","PSOERXA2",226,0)
 S SUFF=$$UP^XLFSTR($G(@GL@("Name",0,"Suffix",0)))
"RTN","PSOERXA2",227,0)
 S PREF=$$UP^XLFSTR($G(@GL@("Name",0,"Prefix",0)))
"RTN","PSOERXA2",228,0)
 S AL1=$G(@GL@("Address",0,"AddressLine1",0))
"RTN","PSOERXA2",229,0)
 S AL2=$G(@GL@("Address",0,"AddressLine2",0))
"RTN","PSOERXA2",230,0)
 S CITY=$G(@GL@("Address",0,"City",0))
"RTN","PSOERXA2",231,0)
 S STATE=$G(@GL@("Address",0,"State",0))
"RTN","PSOERXA2",232,0)
 S ZIP=$G(@GL@("Address",0,"ZipCode",0))
"RTN","PSOERXA2",233,0)
 S SIEN=$$STRES(ZIP,STATE)
"RTN","PSOERXA2",234,0)
 S SPEC=$G(@GL@("Specialty",0))
"RTN","PSOERXA2",235,0)
 S PNPI=$G(@GL@("Identification",0,"NPI",0))
"RTN","PSOERXA2",236,0)
 S PDEA=$G(@GL@("Identification",0,"DEANumber",0))
"RTN","PSOERXA2",237,0)
 S STLIC=$G(@GL@("Identification",0,"StateLicenseNumber",0))
"RTN","PSOERXA2",238,0)
 S PRVIEN=$$FINDPRE^PSOERXU2(FULLNM,$G(PNPI),$G(PDEA)) I PRVIEN S NEW=0
"RTN","PSOERXA2",239,0)
 I 'PRVIEN S NEW=1,PRVIEN="+1"
"RTN","PSOERXA2",240,0)
 S PRVIENS=PRVIEN_","
"RTN","PSOERXA2",241,0)
 S FDA(F,PRVIENS,.01)=FULLNM,FDA(F,PRVIENS,.02)=LN,FDA(F,PRVIENS,.03)=FN,FDA(F,PRVIENS,.04)=MN,FDA(F,PRVIENS,.05)=SUFF
"RTN","PSOERXA2",242,0)
 S FDA(F,PRVIENS,.06)=PREF,FDA(F,PRVIENS,4.1)=AL1,FDA(F,PRVIENS,4.2)=AL2,FDA(F,PRVIENS,4.3)=CITY
"RTN","PSOERXA2",243,0)
 ; STATE AND POINTER RESOLUTION
"RTN","PSOERXA2",244,0)
 S FDA(F,PRVIENS,4.4)=SIEN,FDA(F,PRVIENS,4.5)=ZIP
"RTN","PSOERXA2",245,0)
 S FDA(F,PRVIENS,1.2)=SPEC
"RTN","PSOERXA2",246,0)
 S FDA(F,PRVIENS,1.1)="S"
"RTN","PSOERXA2",247,0)
 I 'NEW D  Q
"RTN","PSOERXA2",248,0)
 .D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",249,0)
 .D PRVCI(PRVIEN)
"RTN","PSOERXA2",250,0)
 .S FDA(52.49,EIENS,2.6)=PRVIEN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",251,0)
 D UPDATE^DIE(,"FDA","NEWIEN") K FDA
"RTN","PSOERXA2",252,0)
 S NPIEN=$O(NEWIEN(0)),NPIEN=$G(NEWIEN(NPIEN))
"RTN","PSOERXA2",253,0)
 D PRVCI(NPIEN)
"RTN","PSOERXA2",254,0)
 S FDA(52.49,EIENS,2.6)=NPIEN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA2",255,0)
 Q
"RTN","PSOERXA2",256,0)
STRES(ZIP,STATE) ;
"RTN","PSOERXA2",257,0)
 N ZIPRES,SIEN
"RTN","PSOERXA2",258,0)
 S SIEN=""
"RTN","PSOERXA2",259,0)
 D POSTAL^XIPUTIL($E(ZIP,1,5),.ZIPRES) I $G(ZIPRES("STATE POINTER"))>0 S SIEN=$G(ZIPRES("STATE POINTER"))
"RTN","PSOERXA2",260,0)
 I 'SIEN,STATE]"" S SIEN=$$FIND1^DIC(5,,,STATE,"C")
"RTN","PSOERXA2",261,0)
 I 'SIEN,STATE]"" S SIEN=$O(^DIC(5,"C",STATE,0))
"RTN","PSOERXA2",262,0)
 Q SIEN
"RTN","PSOERXA3")
0^4^B38164072^B37438894
"RTN","PSOERXA3",1,0)
PSOERXA3 ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERXA3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,508**;DEC 1997;Build 295
"RTN","PSOERXA3",3,0)
 ;
"RTN","PSOERXA3",4,0)
 Q
"RTN","PSOERXA3",5,0)
MED(ERXIEN,ERXVALS,MTYPE) ; medication prescribed
"RTN","PSOERXA3",6,0)
 N GL,VALDT,DAYS,CIQUAL,PQUAL,PDIAG,SQUAL,DIAG,SDIAG,DIRECT,DCSTAT,DCSCODE,DDESC,DUE,CAID,CAQUAL,PSC,SREACODE,SRESCODE
"RTN","PSOERXA3",7,0)
 N EFFDT,EXPDT,NOTE,PEDT,PAUTHQ,PAUTHV,PAUTHS,QCLQ,QPUC,QUSC,QTY,REFQUAL,REFILLS,WRITDT,SUBS,STOPIND,CLINSIG,ACKREA
"RTN","PSOERXA3",8,0)
 N F,EIENS,SFDA,FDA,DIENS,DCCNT,VALDATE,DCDBCOD,DCDBCODQ,DCDEASCH,DCFC,DCFSC,DCPCODE,DCPCQUAL,DCSTR,DCSTRC,DCSTSC,GL2
"RTN","PSOERXA3",9,0)
 I 'ERXIEN Q
"RTN","PSOERXA3",10,0)
 S EIENS=ERXIEN_","
"RTN","PSOERXA3",11,0)
 S F=52.49
"RTN","PSOERXA3",12,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,MTYPE,0,"MedicationPrescribed",0))
"RTN","PSOERXA3",13,0)
 S GL2=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,MTYPE,0,"MedicationDispensed",0))
"RTN","PSOERXA3",14,0)
 S VALDT=$G(@GL@("DateValidated",0,"Date",0)),VALDATE=$$CONVDTTM^PSOERXA1(VALDT),FDA(52.49,EIENS,6.6)=VALDATE
"RTN","PSOERXA3",15,0)
 S DAYS=$G(@GL@("DaysSupply",0)) I DAYS S FDA(F,EIENS,5.5)=+$G(DAYS)
"RTN","PSOERXA3",16,0)
 ; force to numeric
"RTN","PSOERXA3",17,0)
 I +$G(DAYS)<366 S FDA(F,EIENS,20.2)=+$G(DAYS)
"RTN","PSOERXA3",18,0)
 S FDA(F,EIENS,20.4)="M"
"RTN","PSOERXA3",19,0)
 S DIRECT=$G(@GL@("Directions",0)),FDA(F,EIENS,7)=DIRECT
"RTN","PSOERXA3",20,0)
 S DDESC=$$UP^XLFSTR($G(@GL@("DrugDescription",0))),FDA(52.49,EIENS,3.1)=DDESC
"RTN","PSOERXA3",21,0)
 ; drugCoded
"RTN","PSOERXA3",22,0)
 S DCPCODE=$G(@GL@("DrugCoded",0,"ProductCode",0)),FDA(F,EIENS,4.1)=DCPCODE
"RTN","PSOERXA3",23,0)
 S DCPCQUAL=$G(@GL@("DrugCoded",0,"ProductCodeQualifier",0)),FDA(F,EIENS,4.2)=DCPCQUAL
"RTN","PSOERXA3",24,0)
 S DCSTR=$G(@GL@("DrugCoded",0,"Strength",0)),FDA(F,EIENS,4.3)=DCSTR
"RTN","PSOERXA3",25,0)
 S DCDBCOD=$G(@GL@("DrugCoded",0,"DrugDBCode",0)),FDA(F,EIENS,4.4)=DCDBCOD
"RTN","PSOERXA3",26,0)
 S DCDBCODQ=$G(@GL@("DrugCoded",0,"DrugDBCodeQualifier",0)),FDA(F,EIENS,4.11)=$$PRESOLV^PSOERXA1(DCDBCODQ,"DDB")
"RTN","PSOERXA3",27,0)
 S DCFSC=$G(@GL@("DrugCoded",0,"FormSourceCode",0)),FDA(F,EIENS,4.5)=DCFSC
"RTN","PSOERXA3",28,0)
 S DCFC=$G(@GL@("DrugCoded",0,"FormCode",0)),FDA(F,EIENS,4.6)=DCFC
"RTN","PSOERXA3",29,0)
 S DCSTSC=$G(@GL@("DrugCoded",0,"StrengthSourceCode",0)),FDA(F,EIENS,4.7)=DCSTSC
"RTN","PSOERXA3",30,0)
 S DCSTRC=$G(@GL@("DrugCoded",0,"StrengthCode",0)),FDA(F,EIENS,4.8)=DCSTRC
"RTN","PSOERXA3",31,0)
 S DCDEASCH=$G(@GL@("DrugCoded",0,"DEASchedule")),FDA(F,EIENS,4.9)=DCDEASCH
"RTN","PSOERXA3",32,0)
 ; end drugCoded
"RTN","PSOERXA3",33,0)
 S EFFDT=$G(@GL@("EffectiveDate",0,"Date",0))
"RTN","PSOERXA3",34,0)
 I EFFDT="" S EFFDT=$G(@GL@("EffectiveDate",0,"DateTime",0))
"RTN","PSOERXA3",35,0)
 S EFFDT=$$CONVDTTM^PSOERXA1(EFFDT),FDA(F,EIENS,6.3)=EFFDT
"RTN","PSOERXA3",36,0)
 S EXPDT=$G(@GL@("ExpirationDate",0,"Date",0))
"RTN","PSOERXA3",37,0)
 I EXPDT="" S EXPDT=$G(@GL@("ExpirationDate",0,"DateTime",0))
"RTN","PSOERXA3",38,0)
 S EXPDT=$$CONVDTTM^PSOERXA1(EXPDT),FDA(F,EIENS,6.2)=EXPDT
"RTN","PSOERXA3",39,0)
 S NOTE=$G(@GL@("Note",0)),FDA(F,EIENS,8)=NOTE
"RTN","PSOERXA3",40,0)
 ; Future enhancement - no place to store period end date as of now, add in the future if needed
"RTN","PSOERXA3",41,0)
 S PEDT=$G(@GL@("PeriodEnd",0,"Date",0))
"RTN","PSOERXA3",42,0)
 I PEDT="" S PEDT=$G(@GL@("PeriodEnd",0,"DateTime",0))
"RTN","PSOERXA3",43,0)
 S PEDT=$$CONVDTTM^PSOERXA1(PEDT),FDA(F,EIENS,6.4)=PEDT
"RTN","PSOERXA3",44,0)
 S WRITDT=$G(@GL@("WrittenDate",0,"Date",0))
"RTN","PSOERXA3",45,0)
 I WRITDT="" S WRITDT=$G(@GL@("WrittenDate",0,"DateTime",0))
"RTN","PSOERXA3",46,0)
 S WRITDT=$$CONVDTTM^PSOERXA1(WRITDT),FDA(F,EIENS,5.9)=WRITDT
"RTN","PSOERXA3",47,0)
 ; dispense notes
"RTN","PSOERXA3",48,0)
 S SUBS=$G(@GL@("Substitutions",0)),FDA(F,EIENS,5.8)=SUBS
"RTN","PSOERXA3",49,0)
 ; Future enhancement - store stop indicator
"RTN","PSOERXA3",50,0)
 ;S STOPIND=$G(@GL@("Stop",0,"StopIndicator",0)),FDA(F,EIENS,12.7)=STOPIND
"RTN","PSOERXA3",51,0)
 ; prior authorization
"RTN","PSOERXA3",52,0)
 S PAUTHQ=$G(@GL@("PriorAuthorization",0,"Qualifier",0)),PAUTHQ=$$PRESOLV^PSOERXA1(PAUTHQ,"PAV"),FDA(F,EIENS,10.3)=PAUTHQ
"RTN","PSOERXA3",53,0)
 S PAUTHV=$G(@GL@("PriorAuthorization",0,"Value",0)),FDA(F,EIENS,10.2)=PAUTHV
"RTN","PSOERXA3",54,0)
 S PAUTHS=$G(@GL@("PriorAuthorizationStatus",0)),FDA(F,EIENS,10.4)=PAUTHS
"RTN","PSOERXA3",55,0)
 ; quantity
"RTN","PSOERXA3",56,0)
 S QCLQ=$G(@GL@("Quantity",0,"CodeListQualifier",0)),FDA(F,EIENS,5.2)=QCLQ
"RTN","PSOERXA3",57,0)
 S QPUC=$G(@GL@("Quantity",0,"PotencyUnitCode",0)),FDA(F,EIENS,5.4)=QPUC
"RTN","PSOERXA3",58,0)
 S QUSC=$G(@GL@("Quantity",0,"UnitSourceCode",0)),FDA(F,EIENS,5.3)=QUSC
"RTN","PSOERXA3",59,0)
 S QTY=$G(@GL@("Quantity",0,"Value",0)),FDA(F,EIENS,5.1)=QTY
"RTN","PSOERXA3",60,0)
 ; future consideration:
"RTN","PSOERXA3",61,0)
 ; need to look into quantity multiplier on the VA side of things. It looks like the 
"RTN","PSOERXA3",62,0)
 ; ncpdp quantity multiplier is for billing purposes only.
"RTN","PSOERXA3",63,0)
 I $L($P(QTY,".",2))<3 S FDA(F,EIENS,20.1)=QTY
"RTN","PSOERXA3",64,0)
 ; refills
"RTN","PSOERXA3",65,0)
 S REFQUAL=$G(@GL@("Refills",0,"Qualifier",0)),FDA(F,EIENS,5.7)=REFQUAL
"RTN","PSOERXA3",66,0)
 S REFILLS=$G(@GL@("Refills",0,"Value",0))
"RTN","PSOERXA3",67,0)
 S FDA(F,EIENS,5.6)=REFILLS
"RTN","PSOERXA3",68,0)
 ; ensure vista refills can be exacly what is passed in, as long as it is not greater than 11
"RTN","PSOERXA3",69,0)
 I REFILLS<12 S FDA(F,EIENS,20.5)=REFILLS
"RTN","PSOERXA3",70,0)
 S FDA(F,EIENS,20.4)="M"
"RTN","PSOERXA3",71,0)
 S FDA(F,EIENS,41)=$P($G(ERXVALS("FormCode")),U,2)
"RTN","PSOERXA3",72,0)
 S FDA(F,EIENS,42)=$P($G(ERXVALS("PotencyUnitCode")),U,2)
"RTN","PSOERXA3",73,0)
 S FDA(F,EIENS,43)=$P($G(ERXVALS("StrengthCode")),U,2)
"RTN","PSOERXA3",74,0)
 ; file what we currently have
"RTN","PSOERXA3",75,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA3",76,0)
 ; diagnosis - primary and secondary
"RTN","PSOERXA3",77,0)
 N DIAGCNT,STORCODE,DIAFDA
"RTN","PSOERXA3",78,0)
 S DIAGCNT=0
"RTN","PSOERXA3",79,0)
 S DIAG=-1 F  S DIAG=$O(@GL@("Diagnosis",DIAG)) Q:DIAG=""  D
"RTN","PSOERXA3",80,0)
 .S DIAGCNT=DIAGCNT+1
"RTN","PSOERXA3",81,0)
 .S DIENS="+"_DIAGCNT_","_EIENS
"RTN","PSOERXA3",82,0)
 .S CIQUAL=$G(@GL@("Diagnosis",DIAG,"ClinicalInformationQualifier",0))
"RTN","PSOERXA3",83,0)
 .S PQUAL=$G(@GL@("Diagnosis",DIAG,"Primary",0,"Qualifier",0))
"RTN","PSOERXA3",84,0)
 .S PDIAG=$G(@GL@("Diagnosis",DIAG,"Primary",0,"Value",0))
"RTN","PSOERXA3",85,0)
 .S SQUAL=$G(@GL@("Diagnosis",DIAG,"Secondary",0,"Qualifier",0))
"RTN","PSOERXA3",86,0)
 .S SDIAG=$G(@GL@("Diagnosis",DIAG,"Secondary",0,"Value",0))
"RTN","PSOERXA3",87,0)
 .S DIAFDA(52.499,"+1,"_EIENS,.01)=DIAGCNT,DIAFDA(52.499,"+1,"_EIENS,.02)=CIQUAL
"RTN","PSOERXA3",88,0)
 .S DIAFDA(52.499,"+1,"_EIENS,.03)=PQUAL,DIAFDA(52.499,"+1,"_EIENS,.04)=PDIAG
"RTN","PSOERXA3",89,0)
 .S DIAFDA(52.499,"+1,"_EIENS,.05)=SQUAL,DIAFDA(52.499,"+1,"_EIENS,.06)=SDIAG
"RTN","PSOERXA3",90,0)
 .D UPDATE^DIE(,"DIAFDA") K DIAFDA
"RTN","PSOERXA3",91,0)
 ; drug coverage status codes
"RTN","PSOERXA3",92,0)
 S DCCNT=0
"RTN","PSOERXA3",93,0)
 S DCSTAT=-1 F  S DCSTAT=$O(@GL@("DrugCoverageStatusCode",DCSTAT)) Q:DCSTAT=""  D
"RTN","PSOERXA3",94,0)
 .S DCSCODE=$G(@GL@("DrugCoverageStatusCode",DCSTAT))
"RTN","PSOERXA3",95,0)
 .S STORCODE=$$PRESOLV^PSOERXA1(DCSCODE,"DCS") Q:'$L(STORCODE)
"RTN","PSOERXA3",96,0)
 .S DCCNT=DCCNT+1
"RTN","PSOERXA3",97,0)
 .S DCFDA(52.4928,"+1,"_EIENS,.01)=DCCNT
"RTN","PSOERXA3",98,0)
 .S DCFDA(52.4928,"+1,"_EIENS,.02)=STORCODE D UPDATE^DIE(,"DCFDA") K DCFDA
"RTN","PSOERXA3",99,0)
 ; if the service reason code (.01) be the same value more than once, convert the .01 field to a sequence
"RTN","PSOERXA3",100,0)
 S DUE=-1 F  S DUE=$O(@GL@("DrugUseEvaluation",DUE)) Q:DUE=""  D
"RTN","PSOERXA3",101,0)
 .S CAID=$G(@GL@("DrugUseEvaluation",DUE,"CoAgent",0,"CoAgentID",0)),DUEFDA(52.4916,"+1,"_EIENS,.04)=CAID
"RTN","PSOERXA3",102,0)
 .S CAQUAL=$G(@GL@("DrugUseEvaluation",DUE,"CoAgent",0,"CoAgentQualifier",0)),CAQUAL=$$PRESOLV^PSOERXA1(CAQUAL,"CAQ"),DUEFDA(52.4916,"+1,"_EIENS,.05)=CAQUAL
"RTN","PSOERXA3",103,0)
 .S PSC=$G(@GL@("DrugUseEvaluation",DUE,"ProfessionalServiceCode",0)),PSC=$$PRESOLV^PSOERXA1(PSC,"PSC"),DUEFDA(52.4916,"+1,"_EIENS,.02)=PSC
"RTN","PSOERXA3",104,0)
 .S SREACODE=$G(@GL@("DrugUseEvaluation",DUE,"ServiceReasonCode",0)),SREACODE=$$PRESOLV^PSOERXA1(SREACODE,"REA"),DUEFDA(52.4916,"+1,"_EIENS,.01)=SREACODE
"RTN","PSOERXA3",105,0)
 .S SRESCODE=$G(@GL@("DrugUseEvaluation",DUE,"ServiceResultCode",0)),SRESCODE=$$PRESOLV^PSOERXA1(SRESCODE,"RES"),DUEFDA(52.4916,"+1,"_EIENS,.03)=SRESCODE
"RTN","PSOERXA3",106,0)
 .S CLINSIG=$G(@GL@("DrugUseEvaluation",DUE,"ClinicalSignificanceCode",0)),DUEFDA(52.4916,"+1,"_EIENS,.06)=CLINSIG
"RTN","PSOERXA3",107,0)
 .S ACKREA=$G(@GL@("DrugUseEvaluation",DUE,"AcknowledgementReason",0)),DUEFDA(52.4916,"+1,"_EIENS,1)=ACKREA
"RTN","PSOERXA3",108,0)
 .D UPDATE^DIE(,"DUEFDA") K DUEFDA
"RTN","PSOERXA3",109,0)
 D SS^PSOERXA4(EIENS)
"RTN","PSOERXA3",110,0)
 Q
"RTN","PSOERXA5")
0^20^B65388361^n/a
"RTN","PSOERXA5",1,0)
PSOERXA5 ;ALB/BWF - eRx Utilities/RPC's ; 1/20/2018 10:28am
"RTN","PSOERXA5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**508**;DEC 1997;Build 295
"RTN","PSOERXA5",3,0)
 ;
"RTN","PSOERXA5",4,0)
 Q
"RTN","PSOERXA5",5,0)
 ; ERXIEN - IEN to file 52.49
"RTN","PSOERXA5",6,0)
 ; MTYPE - message type from field .08 (message type) of file 52.49
"RTN","PSOERXA5",7,0)
MEDDISP(ERXIEN,MTYPE) ;
"RTN","PSOERXA5",8,0)
 N DRUG,DRUGIEN,QTY,CLQ,USC,PUC,DAYS,DIRECT,REFQ,REFILLS,WRITDT,LFDATE,EXDATE,EFDATE,F,IENS,GL
"RTN","PSOERXA5",9,0)
 N ERR,TYPE
"RTN","PSOERXA5",10,0)
 S F=52.4949
"RTN","PSOERXA5",11,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,MTYPE,0,"MedicationDispensed",0))
"RTN","PSOERXA5",12,0)
 Q:'$D(@GL)
"RTN","PSOERXA5",13,0)
 ; this will be enhanced in the future to accept another parameter and loop through medications requested for
"RTN","PSOERXA5",14,0)
 ; the rxChangeRequest message type.
"RTN","PSOERXA5",15,0)
 S DRUG=$G(@GL@("DrugDescription",0))
"RTN","PSOERXA5",16,0)
 S QTY=$G(@GL@("Quantity",0,"Value",0))
"RTN","PSOERXA5",17,0)
 S CLQ=$G(@GL@("Quantity",0,"CodeListQualifier",0))
"RTN","PSOERXA5",18,0)
 S USC=$G(@GL@("Quantity",0,"UnitSourceCode",0))
"RTN","PSOERXA5",19,0)
 S PUC=$G(@GL@("Quantity",0,"PotencyUnitCode",0))
"RTN","PSOERXA5",20,0)
 S DAYS=$G(@GL@("DaysSupply",0))
"RTN","PSOERXA5",21,0)
 S DIRECT=$G(@GL@("Directions",0))
"RTN","PSOERXA5",22,0)
 S REFQ=$G(@GL@("Refills",0,"Qualifier",0))
"RTN","PSOERXA5",23,0)
 S REFILLS=$G(@GL@("Refills",0,"Value",0))
"RTN","PSOERXA5",24,0)
 S WRITDT=$G(@GL@("WrittenDate","Date",0)),WRITDT=$$CONVDTTM^PSOERXA1(WRITDT)
"RTN","PSOERXA5",25,0)
 S LFDATE=$G(@GL@("LastFillDate",0,"Date",0)),LFDATE=$$CONVDTTM^PSOERXA1(LFDATE)
"RTN","PSOERXA5",26,0)
 S EXDATE=$G(@GL@("ExpirationDate",0,"Date",0)),EXDATE=$$CONVDTTM^PSOERXA1(EXDATE)
"RTN","PSOERXA5",27,0)
 S EFDATE=$G(@GL@("EffectiveDate",0,"Date",0)),EFDATE=$$CONVDTTM^PSOERXA1(EFDATE)
"RTN","PSOERXA5",28,0)
 ; type=D is for medication dispensed
"RTN","PSOERXA5",29,0)
 ; this could be enhanced to collect both dispensed and requested (set of codes)
"RTN","PSOERXA5",30,0)
 S TYPE="D"
"RTN","PSOERXA5",31,0)
 S IENS="+1,"_ERXIEN_","
"RTN","PSOERXA5",32,0)
 S FDA(F,IENS,.01)=DRUG
"RTN","PSOERXA5",33,0)
 S DRUGIEN=$$FIND1^DIC(50,,,DRUG,"B",,"ERR")
"RTN","PSOERXA5",34,0)
 ; D = DISPENSED, R = REQUESTED
"RTN","PSOERXA5",35,0)
 S FDA(F,IENS,.02)=TYPE
"RTN","PSOERXA5",36,0)
 S FDA(F,IENS,.03)=DRUGIEN
"RTN","PSOERXA5",37,0)
 S FDA(F,IENS,.04)=QTY
"RTN","PSOERXA5",38,0)
 S FDA(F,IENS,.05)=DAYS
"RTN","PSOERXA5",39,0)
 S FDA(F,IENS,.06)=REFILLS
"RTN","PSOERXA5",40,0)
 S FDA(F,IENS,.07)=REFQ
"RTN","PSOERXA5",41,0)
 S FDA(F,IENS,1)=DIRECT
"RTN","PSOERXA5",42,0)
 S FDA(F,IENS,2.1)=WRITDT
"RTN","PSOERXA5",43,0)
 S FDA(F,IENS,2.2)=LFDATE
"RTN","PSOERXA5",44,0)
 S FDA(F,IENS,2.3)=EXDATE
"RTN","PSOERXA5",45,0)
 S FDA(F,IENS,2.4)=EFDATE
"RTN","PSOERXA5",46,0)
 S FDA(F,IENS,2.5)=CLQ
"RTN","PSOERXA5",47,0)
 S FDA(F,IENS,2.6)=USC
"RTN","PSOERXA5",48,0)
 S FDA(F,IENS,2.7)=PUC
"RTN","PSOERXA5",49,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA5",50,0)
 ; file the # of refills requested separately for ease of access
"RTN","PSOERXA5",51,0)
 S FDA(52.49,ERXIEN_",",51.2)=REFILLS D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA5",52,0)
 Q
"RTN","PSOERXA5",53,0)
REFRESP(ERXIEN,MTYPE) ;
"RTN","PSOERXA5",54,0)
 N GL,REFFDA,RESTYPE,REFNUM,RESNOTE,I,REACODE,IENS,FDA,RESTUP,RESNODE,RESTNODE,REFRES,REFREQ,DELTAS,PSOIEN,RXIEN
"RTN","PSOERXA5",55,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,MTYPE,0,"Response",0))
"RTN","PSOERXA5",56,0)
 S RESTYPE=$O(@GL@("")),RESTUP=$$UP^XLFSTR(RESTYPE),RESTUP=$TR(RESTUP," ",""),RESTUP=$TR(RESTUP,",","")
"RTN","PSOERXA5",57,0)
 S RESTNODE=RESTYPE
"RTN","PSOERXA5",58,0)
 S REFNUM=$G(@GL@(RESTYPE,0,"ReferenceNumber",0))
"RTN","PSOERXA5",59,0)
 S RESTYPE=$S(RESTUP="APPROVED":"A",RESTUP="DENIED":"D",RESTUP="DENIEDNEWPRESCRIPTIONTOFOLLOW":"DNP",RESTUP="APPROVEDWITHCHANGES":"AWC",1:"")
"RTN","PSOERXA5",60,0)
 S RESNODE=$S(RESTYPE="A":"ApprovalReasonCode",1:"DenialReasonCode")
"RTN","PSOERXA5",61,0)
 S RESNOTE=$S(RESTYPE="A"!(RESTYPE="AWC"):$G(@GL@(RESTNODE,0,"Note",0)),1:$G(@GL@(RESTNODE,0,"DenialReason",0)))
"RTN","PSOERXA5",62,0)
 S REFFDA(52.49,ERXIEN_",",52.3)=REFNUM
"RTN","PSOERXA5",63,0)
 S REFFDA(52.49,ERXIEN_",",52.1)=RESTYPE
"RTN","PSOERXA5",64,0)
 S REFFDA(52.49,ERXIEN_",",52.2)=RESNOTE
"RTN","PSOERXA5",65,0)
 D FILE^DIE(,"REFFDA") K REFFDA
"RTN","PSOERXA5",66,0)
 S I=-1 F  S I=$O(@GL@(RESTNODE,0,RESNODE,I)) Q:I=""  D
"RTN","PSOERXA5",67,0)
 .S REACODE=$G(@GL@(RESTNODE,0,RESNODE,I))
"RTN","PSOERXA5",68,0)
 .S REACODE=$$PRESOLV^PSOERXA1(REACODE,"CLQ") Q:'REACODE
"RTN","PSOERXA5",69,0)
 .S IENS="+1,"_ERXIEN_","
"RTN","PSOERXA5",70,0)
 .S REFFDA(52.4955,IENS,.01)=REACODE
"RTN","PSOERXA5",71,0)
 .D UPDATE^DIE(,"REFFDA") K REFFDA
"RTN","PSOERXA5",72,0)
 S REFRES=ERXIEN,REFREQ=$$GETREQ^PSOERXU2(ERXIEN)
"RTN","PSOERXA5",73,0)
 S RXIEN=$$GET1^DIQ(52.49,REFREQ,.13,"I")
"RTN","PSOERXA5",74,0)
 ; If the Rx has been renewed within the VA, update that status to RXD and do not process further.
"RTN","PSOERXA5",75,0)
 I RXIEN,$$VARENEW^PSOERXU6(RXIEN) D  Q
"RTN","PSOERXA5",76,0)
 .I RESTYPE="DNP" D UPDSTAT^PSOERXU1(ERXIEN,"RXD","eRx Renewed within the VA.")
"RTN","PSOERXA5",77,0)
 ; auto-dc original prescription if this is a denied, new rx to follow
"RTN","PSOERXA5",78,0)
 I RESTYPE="DNP" D  Q
"RTN","PSOERXA5",79,0)
 .D RXACT^PSOBPSU2(RXIEN,,"Refill response from external provider - Denied, New prescription to follow.","O")
"RTN","PSOERXA5",80,0)
 .D AUTODC^PSOERXU3(ERXIEN)
"RTN","PSOERXA5",81,0)
 ; if the response type is approved, process the approval into OP.
"RTN","PSOERXA5",82,0)
 I RESTYPE="A" D  Q
"RTN","PSOERXA5",83,0)
 .D RXACT^PSOBPSU2(RXIEN,,"Refill response from external provider - Approved.","O")
"RTN","PSOERXA5",84,0)
 .S PSOIEN=ERXIEN D SETUP^PSOERX1B
"RTN","PSOERXA5",85,0)
 S REFRES=ERXIEN,REFREQ=$$GETREQ^PSOERXU2(ERXIEN)
"RTN","PSOERXA5",86,0)
 I 'REFREQ!('REFRES) Q
"RTN","PSOERXA5",87,0)
 D RRDELTA^PSOERXU2(.DELTAS,REFREQ,REFRES)
"RTN","PSOERXA5",88,0)
 ; if the type is approved with changes, and the provider hasn't changed, auto-process the renewal
"RTN","PSOERXA5",89,0)
 I RESTYPE="AWC",'$D(DELTAS(52.49,"EXTERNAL PROVIDER")) D
"RTN","PSOERXA5",90,0)
 .D RXACT^PSOBPSU2(RXIEN,,"Refill response from external provider - Approved with changes.","O")
"RTN","PSOERXA5",91,0)
 .S PSOIEN=ERXIEN D SETUP^PSOERX1B
"RTN","PSOERXA5",92,0)
 I RESTYPE="AWC",$D(DELTAS(52.49,"EXTERNAL PROVIDER")) D
"RTN","PSOERXA5",93,0)
 .D RXACT^PSOBPSU2(RXIEN,,"Refill response from external provider - Approved with provider changes.","O")
"RTN","PSOERXA5",94,0)
 I RESTYPE="D" D UPDSTAT^PSOERXU1(ERXIEN,"RXD"),RXACT^PSOBPSU2(RXIEN,,"Refill response from external provider - Denied.","O")
"RTN","PSOERXA5",95,0)
 Q
"RTN","PSOERXA5",96,0)
 ; ERXIEN - IEN from 52.49
"RTN","PSOERXA5",97,0)
 ; MTYPE - message type (field .08)
"RTN","PSOERXA5",98,0)
 ; DNB - denied by hub flag
"RTN","PSOERXA5",99,0)
 ; VAINST - institution
"RTN","PSOERXA5",100,0)
CANRX(ERXIEN,MTYPE,DNB,VAINST) ;
"RTN","PSOERXA5",101,0)
 N GL,RELIEN,NODE,ERXIENS,CRTYPE,RETREC,REQREF,CHANGEST,RELIEN,IMTYPE,PSSRET,NRXIEN,NRXSTAT,RXIEN,PENDIEN,ORESP,MES
"RTN","PSOERXA5",102,0)
 S ERXIENS=ERXIEN_","
"RTN","PSOERXA5",103,0)
 S IMTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERXA5",104,0)
 S NODE=$S(MTYPE="CancelRx":"Request",MTYPE="CancelRxResponse":"Response",1:"") Q:NODE=""
"RTN","PSOERXA5",105,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,MTYPE,0,NODE,0))
"RTN","PSOERXA5",106,0)
 S CRTYPE=$G(@GL@("ChangeRequestType",0))
"RTN","PSOERXA5",107,0)
 S RETREC=$G(@GL@("ReturnReceipt",0))
"RTN","PSOERXA5",108,0)
 S REQREF=$G(@GL@("RequestReferenceNumber",0))
"RTN","PSOERXA5",109,0)
 S CHANGEST=$G(@GL@("ChangeofPrescriptionStatusFlag",0))
"RTN","PSOERXA5",110,0)
 D CANFIL(ERXIENS,CRTYPE,RETREC,REQREF,CHANGEST)
"RTN","PSOERXA5",111,0)
 I IMTYPE="CA" S NRXIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXA5",112,0)
 I IMTYPE="CN" S RELIEN=$$GETREQ^PSOERXU2(ERXIEN),NRXIEN=$$RESOLV^PSOERXU2(RELIEN)
"RTN","PSOERXA5",113,0)
 ; if we cannot find the related message, update status, and quit
"RTN","PSOERXA5",114,0)
 I IMTYPE="CA",'$G(NRXIEN) D  Q
"RTN","PSOERXA5",115,0)
 . D UPDSTAT^PSOERXU1(ERXIEN,"CAP")
"RTN","PSOERXA5",116,0)
 Q:'$G(NRXIEN)
"RTN","PSOERXA5",117,0)
 ; Validates if the order is an eRx and Log Activity in AL eRx
"RTN","PSOERXA5",118,0)
 S MES=$S(IMTYPE="CA":"Canceled by external provider (eRx)",IMTYPE="CN":"Cancel Response to external provider (eRx)")
"RTN","PSOERXA5",119,0)
 S RXIEN=$$GET1^DIQ(52.49,NRXIEN,.13,"I")
"RTN","PSOERXA5",120,0)
 I RXIEN D RXACT^PSOBPSU2(RXIEN,,MES,"O")
"RTN","PSOERXA5",121,0)
 S NRXSTAT=$$GET1^DIQ(52.49,NRXIEN,1,"E")
"RTN","PSOERXA5",122,0)
 ;generate automated cancel response on rejected and new status eRxs in the holding queue
"RTN","PSOERXA5",123,0)
 I ",RJ,N,"[NRXSTAT D  Q
"RTN","PSOERXA5",124,0)
 .I NRXSTAT="RJ" D
"RTN","PSOERXA5",125,0)
 ..S ORESP="Rx was never dispensed. Rejected at Pharmacy"
"RTN","PSOERXA5",126,0)
 ..D POST^PSOERXO1(ERXIEN,.PSSRET,,,,3,VAINST,ORESP)
"RTN","PSOERXA5",127,0)
 .I NRXSTAT'="RJ" D POST^PSOERXO1(ERXIEN,.PSSRET,,,,3,VAINST)
"RTN","PSOERXA5",128,0)
  .; if there was an error, quit. we do not want to override the CAX status
"RTN","PSOERXA5",129,0)
 .I $D(PSSRET("errorMessage")) D UPDSTAT^PSOERXU1(NRXIEN,"CAN") Q
"RTN","PSOERXA5",130,0)
 .D UPDSTAT^PSOERXU1(NRXIEN,"CAN")
"RTN","PSOERXA5",131,0)
 .D UPDSTAT^PSOERXU1(ERXIEN,"CAO")
"RTN","PSOERXA5",132,0)
 ;generate automated cancel response on processed eRx's
"RTN","PSOERXA5",133,0)
 I NRXSTAT="PR" D  Q
"RTN","PSOERXA5",134,0)
 .D CANDC^PSOERXU6(ERXIEN,VAINST,.PSSRET)
"RTN","PSOERXA5",135,0)
 ; Do we not build a response for the other canceled items?
"RTN","PSOERXA5",136,0)
 D UPDSTAT^PSOERXU1(ERXIEN,"CAH")
"RTN","PSOERXA5",137,0)
 D UPDSTAT^PSOERXU1(NRXIEN,"CAN")
"RTN","PSOERXA5",138,0)
 Q
"RTN","PSOERXA5",139,0)
CANFIL(ERXIENS,CRTYPE,RETREC,REQREF,CHANGEST,STATUS,DNB) ;
"RTN","PSOERXA5",140,0)
 N FDA
"RTN","PSOERXA5",141,0)
 S FDA(52.49,ERXIENS,80.1)=CRTYPE
"RTN","PSOERXA5",142,0)
 S FDA(52.49,ERXIENS,80.2)=RETREC
"RTN","PSOERXA5",143,0)
 S FDA(52.49,ERXIENS,80.3)=REQREF
"RTN","PSOERXA5",144,0)
 S FDA(52.49,ERXIENS,80.4)=CHANGEST
"RTN","PSOERXA5",145,0)
 S FDA(52.49,ERXIENS,80.5)=$G(DNB)
"RTN","PSOERXA5",146,0)
 I $L($G(STATUS)) S FDA(52.49,ERXIENS,1)=$$PRESOLV^PSOERXA1(STATUS,"ERX")
"RTN","PSOERXA5",147,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA5",148,0)
 Q
"RTN","PSOERXA5",149,0)
BFC(ERXIEN) ; benefits coordination
"RTN","PSOERXA5",150,0)
 N GL,BFCCNT,CHFN,CHLN,CHMN,CHPRE,CHSUFF,CHID,GRPID,PIDTYP,PIDVAL,CHFN,F,PIEN,NEWPAYER,BFCERR,IENS,CHFULLN,FDA,BSEQ,PNAME,PIDCNT
"RTN","PSOERXA5",151,0)
 S F=52.4918
"RTN","PSOERXA5",152,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,"NewRx",0,"BenefitsCoordination"))
"RTN","PSOERXA5",153,0)
 ; cannot start at 0, since the first entry is on the 0 subscript.
"RTN","PSOERXA5",154,0)
 S BSEQ=0
"RTN","PSOERXA5",155,0)
 S BFCCNT=-1 F  S BFCCNT=$O(@GL@(BFCCNT)) Q:BFCCNT=""  D
"RTN","PSOERXA5",156,0)
 .S BSEQ=BSEQ+1
"RTN","PSOERXA5",157,0)
 .S CHFN=$$UP^XLFSTR($G(@GL@(BFCCNT,"CardHolderName",0,"FirstName",0)))
"RTN","PSOERXA5",158,0)
 .S CHLN=$$UP^XLFSTR($G(@GL@(BFCCNT,"CardHolderName",0,"LastName",0)))
"RTN","PSOERXA5",159,0)
 .S CHMN=$$UP^XLFSTR($G(@GL@(BFCCNT,"CardHolderName",0,"MiddleName",0)))
"RTN","PSOERXA5",160,0)
 .; set up full name - last, first, mi
"RTN","PSOERXA5",161,0)
 .S CHFULLN=CHLN_","_CHFN_$S(CHMN]"":" "_CHMN,1:"")
"RTN","PSOERXA5",162,0)
 .S CHPRE=$$UP^XLFSTR($G(@GL@(BFCCNT,"CardHolderName",0,"Prefix",0)))
"RTN","PSOERXA5",163,0)
 .S CHSUFF=$$UP^XLFSTR($G(@GL@(BFCCNT,"CardHolderName",0,"Suffix",0)))
"RTN","PSOERXA5",164,0)
 .S CHID=$G(@GL@(BFCCNT,"CardholderID",0))
"RTN","PSOERXA5",165,0)
 .S GRPID=$G(@GL@(BFCCNT,"GroupID",0))
"RTN","PSOERXA5",166,0)
 .;/BLB/ PSO*7.0*520
"RTN","PSOERXA5",167,0)
 .S PNAME=$G(@GL@(BFCCNT,"PayerName",0))
"RTN","PSOERXA5",168,0)
 .S IENS="+1,"_ERXIEN_","
"RTN","PSOERXA5",169,0)
 .S FDA(F,IENS,.01)=BSEQ,FDA(F,IENS,7)=CHID,FDA(F,IENS,.02)=GRPID,FDA(F,IENS,.03)=PNAME
"RTN","PSOERXA5",170,0)
 .S FDA(F,IENS,1)=CHLN,FDA(F,IENS,2)=CHFN,FDA(F,IENS,3)=CHMN,FDA(F,IENS,4)=CHSUFF,FDA(F,IENS,5)=CHPRE
"RTN","PSOERXA5",171,0)
 .K NEWPAYER
"RTN","PSOERXA5",172,0)
 .D UPDATE^DIE(,"FDA","NEWPAYER") K FDA
"RTN","PSOERXA5",173,0)
 .;/BLB/ - END CHANGE
"RTN","PSOERXA5",174,0)
 .S PIEN=$O(NEWPAYER(0)),PIEN=$G(NEWPAYER(PIEN)) Q:'PIEN
"RTN","PSOERXA5",175,0)
 .S PIDCNT=-1 F  S PIDCNT=$O(@GL@(BFCCNT,"PayerIdentification",PIDCNT)) Q:PIDCNT=""  D
"RTN","PSOERXA5",176,0)
 ..S PIDTYP="" F  S PIDTYP=$O(@GL@(BFCCNT,"PayerIdentification",PIDCNT,PIDTYP)) Q:PIDTYP=""  D
"RTN","PSOERXA5",177,0)
 ...S PIDVAL=$G(@GL@(BFCCNT,"PayerIdentification",PIDCNT,PIDTYP,0))
"RTN","PSOERXA5",178,0)
 ...S FDA(52.49186,"+1,"_PIEN_","_ERXIEN_",",.01)=PIDTYP
"RTN","PSOERXA5",179,0)
 ...S FDA(52.49186,"+1,"_PIEN_","_ERXIEN_",",.02)=PIDVAL
"RTN","PSOERXA5",180,0)
 ...D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA5",181,0)
 .K NEWPAYER,PIEN
"RTN","PSOERXA5",182,0)
 Q
"RTN","PSOERXC1")
0^32^B92546733^n/a
"RTN","PSOERXC1",1,0)
PSOERXC1 ;ALB/BWF - eRx Utilities/RPC's ; 6/1/2018 5:14pm
"RTN","PSOERXC1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**508**;DEC 1997;Build 295
"RTN","PSOERXC1",3,0)
 ;
"RTN","PSOERXC1",4,0)
EN(SRCH,SORTT,PCVSTAT) ; -- main entry point for PSO ERX PATIENT CENTRIC VIEW
"RTN","PSOERXC1",5,0)
 N PSOC1RE
"RTN","PSOERXC1",6,0)
 D EN^VALM("PSO ERX PATIENT CENTRIC VIEW")
"RTN","PSOERXC1",7,0)
 Q
"RTN","PSOERXC1",8,0)
 ;
"RTN","PSOERXC1",9,0)
HDR ; -- header code
"RTN","PSOERXC1",10,0)
 S VALMHDR(1)="                       Patient Centric View"
"RTN","PSOERXC1",11,0)
 I $G(PSOC1RE) K @VALMAR,PSOC1RE D INIT
"RTN","PSOERXC1",12,0)
 Q
"RTN","PSOERXC1",13,0)
 ;
"RTN","PSOERXC1",14,0)
INIT ; -- init variables and list array
"RTN","PSOERXC1",15,0)
 N EBDATE,EDATE,BDATE,RXSTAT,RXDATE,ERXIEN,PATIEN,RDATE,ERXSTAT,COUNT,PNAME,DOB,DOB2,NEW,WAIT,IPR,HOLD,TOTAL,RXDATE2
"RTN","PSOERXC1",16,0)
 N RXSTATE,PATCNT,B,G,VAR,DIRECT,LINEVAR,EDAYS,EDLOOP,GLOB,LASTUSER,PATINFO,EDAYS2,PATLOOP,CCR,LINE,OTH,CNT,BDOVR,MTYPE
"RTN","PSOERXC1",17,0)
 N SVAL,P5246IEN,ESCODE
"RTN","PSOERXC1",18,0)
 S PSOSRCH=$S($D(SRCH):1,1:0) I PSOSRCH S PSOSRCH(VALMEVL)=""
"RTN","PSOERXC1",19,0)
 S PSOSRT=$S($D(SORTT):1,1:0) I PSOSRT S PSOSRT(VALMEVL)=""
"RTN","PSOERXC1",20,0)
 K ^TMP("CENTRIC",$J),^TMP("RDATE",$J),^TMP("PSOERXC1",$J)
"RTN","PSOERXC1",21,0)
 I '$D(PSOINST) D
"RTN","PSOERXC1",22,0)
 .D ^PSOLSET
"RTN","PSOERXC1",23,0)
 Q:'$D(PSOINST)
"RTN","PSOERXC1",24,0)
 S GLOB=$NA(^TMP("PSOERXC1",$J)) K @GLOB
"RTN","PSOERXC1",25,0)
 S BDATE=$$FMADD^XLFDT(DT,-365)
"RTN","PSOERXC1",26,0)
 S CNT=0,PATCNT=0
"RTN","PSOERXC1",27,0)
 S EDATE=DT_".9999"
"RTN","PSOERXC1",28,0)
 S RXDATE=BDATE
"RTN","PSOERXC1",29,0)
 S BDOVR=$$GET1^DIQ(59,PSOSITE,10.2,"E") I BDOVR S RXDATE=$$FMADD^XLFDT(DT,-BDOVR)
"RTN","PSOERXC1",30,0)
 S RXDATE2=BDATE
"RTN","PSOERXC1",31,0)
 F  S RXDATE=$O(^PS(52.49,"F",PSNPINST,RXDATE)) Q:'RXDATE!(RXDATE>EDATE)!(RXDATE="")!(PATCNT>998)  D
"RTN","PSOERXC1",32,0)
 .I $D(SRCH(1)) D  Q
"RTN","PSOERXC1",33,0)
 ..S SVAL=$P(SRCH(1),U)
"RTN","PSOERXC1",34,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"EPAT",PSNPINST,RXDATE,SVAL,ERXIEN)) Q:'ERXIEN!(PATCNT>998)  D
"RTN","PSOERXC1",35,0)
 ...D BLDITEM(ERXIEN,.PATCNT,$G(PCVSTAT))
"RTN","PSOERXC1",36,0)
 .I $D(SRCH(2)) D  Q
"RTN","PSOERXC1",37,0)
 ..S SVAL=$P(SRCH(2),U)
"RTN","PSOERXC1",38,0)
 ..S P5246IEN=0 F  S P5246IEN=$O(^PS(52.46,"DOB",SVAL,P5246IEN)) Q:'P5246IEN!(PATCNT>998)  D
"RTN","PSOERXC1",39,0)
 ...S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"EPAT",PSNPINST,RXDATE,P5246IEN,ERXIEN)) Q:'ERXIEN!(PATCNT>998)  D
"RTN","PSOERXC1",40,0)
 ....D BLDITEM(ERXIEN,.PATCNT,$G(PCVSTAT))
"RTN","PSOERXC1",41,0)
 .S RXSTAT=0 F  S RXSTAT=$O(^PS(52.49,"F",PSNPINST,RXDATE,RXSTAT)) Q:'RXSTAT!(PATCNT=999)  D
"RTN","PSOERXC1",42,0)
 ..I +$G(STAT),STAT'=RXSTAT Q
"RTN","PSOERXC1",43,0)
 ..S RXSTATE=$$GET1^DIQ(52.45,RXSTAT,.01,"E")
"RTN","PSOERXC1",44,0)
 ..I ((RXSTATE="RJ")!(RXSTATE="RM")!(RXSTATE="PR")!(RXSTATE="E")) Q
"RTN","PSOERXC1",45,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"F",PSNPINST,RXDATE,RXSTAT,ERXIEN)) Q:'ERXIEN!(PATCNT=999)  D
"RTN","PSOERXC1",46,0)
 ...D BLDITEM(ERXIEN,.PATCNT,$G(PCVSTAT))
"RTN","PSOERXC1",47,0)
 S PATIEN=0,LINE=0
"RTN","PSOERXC1",48,0)
 I '$O(^TMP("CENTRIC",$J,0)) S LINE=$G(LINE)+1,VALMCNT=LINE D SET^VALM10(LINE,"No records found.") Q
"RTN","PSOERXC1",49,0)
 F  S PATIEN=$O(^TMP("CENTRIC",$J,PATIEN)) Q:'PATIEN  D
"RTN","PSOERXC1",50,0)
 .S PNAME=$$GET1^DIQ(52.46,PATIEN,.01)
"RTN","PSOERXC1",51,0)
 .S DOB=$$GET1^DIQ(52.46,PATIEN,.08,"I"),DOB2=$$FMTE^XLFDT(DOB,"5Z")
"RTN","PSOERXC1",52,0)
 .F  S RXDATE2=$O(^PS(52.49,"PAT2",PATIEN,RXDATE2)) Q:'RXDATE2!(RXDATE2>EDATE)  D
"RTN","PSOERXC1",53,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"PAT2",PATIEN,RXDATE2,ERXIEN)) Q:'ERXIEN  D
"RTN","PSOERXC1",54,0)
 ...Q:$$GET1^DIQ(52.49,ERXIEN,24.1,"I")'=PSNPINST
"RTN","PSOERXC1",55,0)
 ...S ERXSTAT=$$GET1^DIQ(52.49,ERXIEN,1,"E")
"RTN","PSOERXC1",56,0)
 ...I (ERXSTAT="PR")!(ERXSTAT="RM")!(ERXSTAT="RJ")!(ERXSTAT="E") Q
"RTN","PSOERXC1",57,0)
 ...S ESCODE=","_$S($E(ERXSTAT)="H":$E(ERXSTAT),1:ERXSTAT)_"," I ",RRE,RXN,RXW,RXD,RXF,CAO,CAR,CAH,CAP,CAX,CAF,N,I,W,H,"'[ESCODE Q
"RTN","PSOERXC1",58,0)
 ...S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERXC1",59,0)
 ...S RDATE=$E($$GET1^DIQ(52.49,ERXIEN,.03,"I"),1,7)
"RTN","PSOERXC1",60,0)
 ...I '$D(^TMP("RDATE",$J,PATIEN,0)) S ^TMP("RDATE",$J,PATIEN,0)=$G(RDATE)
"RTN","PSOERXC1",61,0)
 ...I $D(^TMP("RDATE",$J,PATIEN,0)),^TMP("RDATE",$J,PATIEN,0)>$G(RDATE) S ^TMP("RDATE",$J,PATIEN,0)=$G(RDATE)
"RTN","PSOERXC1",62,0)
 ...S COUNT=$G(^TMP("CENTRIC",$J,PATIEN,0))
"RTN","PSOERXC1",63,0)
 ...I ERXSTAT="N" S $P(COUNT,U,1)=$P($G(COUNT),U)+1
"RTN","PSOERXC1",64,0)
 ...I ERXSTAT="W" S $P(COUNT,U,2)=$P($G(COUNT),U,2)+1
"RTN","PSOERXC1",65,0)
 ...I ERXSTAT="I" S $P(COUNT,U,3)=$P($G(COUNT),U,3)+1
"RTN","PSOERXC1",66,0)
 ...I $E(ERXSTAT)="H" S $P(COUNT,U,4)=$P($G(COUNT),U,4)+1
"RTN","PSOERXC1",67,0)
 ...I ((ERXSTAT="RXN")!(ERXSTAT="RXW")!(ERXSTAT="RXD")!(ERXSTAT="RXF")!(ERXSTAT="CAO")!(ERXSTAT="CAR")!(ERXSTAT="CAH")!(ERXSTAT="CAP")!(ERXSTAT="CAX")!(ERXSTAT="CAF")) D
"RTN","PSOERXC1",68,0)
 ....S $P(COUNT,U,5)=$P($G(COUNT),U,5)+1
"RTN","PSOERXC1",69,0)
 ...; finialize and display count for 'other' types.
"RTN","PSOERXC1",70,0)
 ...I MTYPE="IE",ERXSTAT="RRE" S $P(COUNT,U,6)=$P($G(COUNT),U,6)+1
"RTN","PSOERXC1",71,0)
 ...S ^TMP("CENTRIC",$J,PATIEN,0)=COUNT
"RTN","PSOERXC1",72,0)
 .S COUNT=$G(^TMP("CENTRIC",$J,PATIEN,0))
"RTN","PSOERXC1",73,0)
 .F G=1:1:6 D
"RTN","PSOERXC1",74,0)
 ..I $P(COUNT,U,G)="" D
"RTN","PSOERXC1",75,0)
 ...S $P(COUNT,U,G)=0
"RTN","PSOERXC1",76,0)
 .S NEW=$P(COUNT,U)
"RTN","PSOERXC1",77,0)
 .S WAIT=$P(COUNT,U,2)
"RTN","PSOERXC1",78,0)
 .S IPR=$P(COUNT,U,3)
"RTN","PSOERXC1",79,0)
 .S HOLD=$P(COUNT,U,4)
"RTN","PSOERXC1",80,0)
 .S CCR=$P(COUNT,U,5)
"RTN","PSOERXC1",81,0)
 .S OTH=$P(COUNT,U,6)
"RTN","PSOERXC1",82,0)
 .S EDAYS=$$FMDIFF^XLFDT(DT,$G(^TMP("RDATE",$J,PATIEN,0)))
"RTN","PSOERXC1",83,0)
 .S LASTUSER=$$GET1^DIQ(52.46,PATIEN,6)
"RTN","PSOERXC1",84,0)
 .S TOTAL=""
"RTN","PSOERXC1",85,0)
 .F B=1:1:6 D
"RTN","PSOERXC1",86,0)
 ..S VAR=$P(COUNT,U,B)
"RTN","PSOERXC1",87,0)
 ..S TOTAL=TOTAL+VAR
"RTN","PSOERXC1",88,0)
 .I TOTAL=0 Q
"RTN","PSOERXC1",89,0)
 .I TOTAL>999 S TOTAL=999
"RTN","PSOERXC1",90,0)
 .S EDAYS2=$S($L(EDAYS)=1:" "_EDAYS,1:EDAYS)
"RTN","PSOERXC1",91,0)
 .I $L(TOTAL)=1 S TOTAL="  "_TOTAL
"RTN","PSOERXC1",92,0)
 .I $L(TOTAL)=2 S TOTAL=" "_TOTAL
"RTN","PSOERXC1",93,0)
 .I NEW>99 S NEW=99
"RTN","PSOERXC1",94,0)
 .I $L(NEW)=1 S NEW=" "_NEW
"RTN","PSOERXC1",95,0)
 .I WAIT>99 S WAIT=99
"RTN","PSOERXC1",96,0)
 .I $L(WAIT)=1 S WAIT=" "_WAIT
"RTN","PSOERXC1",97,0)
 .I IPR>99 S IPR=99
"RTN","PSOERXC1",98,0)
 .I $L(IPR)=1 S IPR=" "_IPR
"RTN","PSOERXC1",99,0)
 .I HOLD>99 S HOLD=99
"RTN","PSOERXC1",100,0)
 .I $L(HOLD)=1 S HOLD=" "_HOLD
"RTN","PSOERXC1",101,0)
 .I CCR>99 S CCR=99
"RTN","PSOERXC1",102,0)
 .I $L(CCR)=1 S CCR="  "_CCR
"RTN","PSOERXC1",103,0)
 .I $L(CCR)=2 S CCR=" "_CCR
"RTN","PSOERXC1",104,0)
 .I OTH>99 S OTH=99
"RTN","PSOERXC1",105,0)
 .I $L(OTH)=1 S OTH="  "_OTH
"RTN","PSOERXC1",106,0)
 .I $L(OTH)=2 S OTH=" "_OTH
"RTN","PSOERXC1",107,0)
 .I $G(SORTT) D  Q
"RTN","PSOERXC1",108,0)
 ..I SORTT=1 S @GLOB@(PNAME,PATIEN)=PNAME_U_DOB2_U_EDAYS2_U_LASTUSER_U_NEW_U_WAIT_U_IPR_U_HOLD_U_CCR_U_OTH_U_TOTAL,DIRECT=1
"RTN","PSOERXC1",109,0)
 ..I SORTT=2 S @GLOB@(DOB,PATIEN)=PNAME_U_DOB2_U_EDAYS2_U_LASTUSER_U_NEW_U_WAIT_U_IPR_U_HOLD_U_CCR_U_OTH_U_TOTAL,DIRECT=1
"RTN","PSOERXC1",110,0)
 ..I SORTT=3 S @GLOB@(TOTAL,PATIEN)=PNAME_U_DOB2_U_EDAYS2_U_LASTUSER_U_NEW_U_WAIT_U_IPR_U_HOLD_U_CCR_U_OTH_U_TOTAL,DIRECT=1
"RTN","PSOERXC1",111,0)
 .S @GLOB@(EDAYS,PATIEN)=PNAME_U_DOB2_U_EDAYS2_U_LASTUSER_U_NEW_U_WAIT_U_IPR_U_HOLD_U_CCR_U_OTH_U_TOTAL
"RTN","PSOERXC1",112,0)
 I '$D(DIRECT) S DIRECT=-1
"RTN","PSOERXC1",113,0)
 S EDLOOP=""
"RTN","PSOERXC1",114,0)
 F  S EDLOOP=$O(@GLOB@(EDLOOP),DIRECT) Q:EDLOOP=""  D
"RTN","PSOERXC1",115,0)
 .S PATLOOP=""
"RTN","PSOERXC1",116,0)
 .F  S PATLOOP=$O(@GLOB@(EDLOOP,PATLOOP)) Q:PATLOOP=""  D
"RTN","PSOERXC1",117,0)
 ..S LINE=LINE+1,LINEVAR=""
"RTN","PSOERXC1",118,0)
 ..S PATINFO=$G(@GLOB@(EDLOOP,PATLOOP))
"RTN","PSOERXC1",119,0)
 ..S LINEVAR=$$SETFLD^VALM1(LINE_".",LINEVAR,"#")
"RTN","PSOERXC1",120,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U),LINEVAR,"ERX PATIENT")
"RTN","PSOERXC1",121,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,2),LINEVAR,"DOB")
"RTN","PSOERXC1",122,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,3),LINEVAR,"ED")
"RTN","PSOERXC1",123,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,4),LINEVAR,"LASTUSER")
"RTN","PSOERXC1",124,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,5),LINEVAR,"NW")
"RTN","PSOERXC1",125,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,6),LINEVAR,"WT")
"RTN","PSOERXC1",126,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,7),LINEVAR,"IP")
"RTN","PSOERXC1",127,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,8),LINEVAR,"HD")
"RTN","PSOERXC1",128,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,9),LINEVAR,"CCR")
"RTN","PSOERXC1",129,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,10),LINEVAR,"OTH")
"RTN","PSOERXC1",130,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,11),LINEVAR,"TOT")
"RTN","PSOERXC1",131,0)
 ..D SET^VALM10(LINE,LINEVAR,PATLOOP)
"RTN","PSOERXC1",132,0)
 S VALMCNT=LINE
"RTN","PSOERXC1",133,0)
 K ^TMP("CENTRIC",$J),^TMP("RDATE",$J),^TMP("PSOERXC1",$J)
"RTN","PSOERXC1",134,0)
 Q
"RTN","PSOERXC1",135,0)
CENTSRCH ;
"RTN","PSOERXC1",136,0)
 N RES,SVAL,I,DONE,SRCHARY
"RTN","PSOERXC1",137,0)
 D FULL^VALM1
"RTN","PSOERXC1",138,0)
 S DONE=0
"RTN","PSOERXC1",139,0)
 S VALMBCK="R",PSOC1RE=1
"RTN","PSOERXC1",140,0)
 F I=1:1 D  Q:DONE
"RTN","PSOERXC1",141,0)
 .S RES=$$DIR(,I,.SRCHARY)
"RTN","PSOERXC1",142,0)
 .I '+RES S DONE=1 Q
"RTN","PSOERXC1",143,0)
 .S SRCHARY(+RES)=$P(RES,U,2,99)
"RTN","PSOERXC1",144,0)
 .I $D(SRCHARY(3)) S DONE=1 Q
"RTN","PSOERXC1",145,0)
 I '$D(SRCHARY) S VALMBCK="R" Q
"RTN","PSOERXC1",146,0)
 I $G(SRCHARY(3))]"" D  Q
"RTN","PSOERXC1",147,0)
 .S ERXIEN=$O(^PS(52.49,"B",SRCHARY(3),0))
"RTN","PSOERXC1",148,0)
 .I 'ERXIEN W !,"eRx could not be found." D DIRE^PSOERXX1 S VALMBCK="R" Q
"RTN","PSOERXC1",149,0)
 .I '$D(^PS(52.49,ERXIEN)) W !,"eRx could not be found." D DIRE^PSOERXX1 S VALMBCK="R" Q
"RTN","PSOERXC1",150,0)
 .D EN^PSOERX1(ERXIEN)
"RTN","PSOERXC1",151,0)
 .S VALMBCK="R"
"RTN","PSOERXC1",152,0)
 I $D(STYP) D EN(.SRCHARY,STYP) Q
"RTN","PSOERXC1",153,0)
 D EN(.SRCHARY)
"RTN","PSOERXC1",154,0)
 Q
"RTN","PSOERXC1",155,0)
CENTSORT ;
"RTN","PSOERXC1",156,0)
 N RES,STYP,SVAL
"RTN","PSOERXC1",157,0)
 D FULL^VALM1
"RTN","PSOERXC1",158,0)
 S VALMBCK="R",PSOC1RE=1
"RTN","PSOERXC1",159,0)
 S RES=$$DIR(1,0)
"RTN","PSOERXC1",160,0)
 I '+$P(RES,U) S VALMBCK="R" Q
"RTN","PSOERXC1",161,0)
 S STYP=$P(RES,U)
"RTN","PSOERXC1",162,0)
 I $D(SRCHARY) D EN(.SRCHARY,STYP) Q
"RTN","PSOERXC1",163,0)
 D EN(,STYP,PCVSTAT)
"RTN","PSOERXC1",164,0)
 Q
"RTN","PSOERXC1",165,0)
SBN ;
"RTN","PSOERXC1",166,0)
 N Y,ERXPAT,PATIEN,ERXLOCK,SRCH
"RTN","PSOERXC1",167,0)
 D FULL^VALM1
"RTN","PSOERXC1",168,0)
 S Y=+$P(XQORNOD(0),"=",2)
"RTN","PSOERXC1",169,0)
 I 'Y S VALMBCK="R" Q
"RTN","PSOERXC1",170,0)
 S PATIEN=$O(@VALMAR@("IDX",Y,"")) Q:'PATIEN
"RTN","PSOERXC1",171,0)
 S ERXLOCK=$$L^PSOERX1A(PATIEN,1)
"RTN","PSOERXC1",172,0)
 I 'ERXLOCK S DIR(0)="E" D ^DIR K DIR S VALMBCK="R" Q
"RTN","PSOERXC1",173,0)
 S SRCH(1)=PATIEN D EN^PSOERX(.SRCH,,1)
"RTN","PSOERXC1",174,0)
 D UL^PSOERX1A(PATIEN)
"RTN","PSOERXC1",175,0)
 S VALMBCK="R"
"RTN","PSOERXC1",176,0)
 K %
"RTN","PSOERXC1",177,0)
 Q
"RTN","PSOERXC1",178,0)
PATDATA ;
"RTN","PSOERXC1",179,0)
 N DIR,Y,RESP,PATIEN,SRCH
"RTN","PSOERXC1",180,0)
 D FULL^VALM1
"RTN","PSOERXC1",181,0)
 S DIR(0)="N^"_VALMBG_":"_VALMLST_":0" D ^DIR
"RTN","PSOERXC1",182,0)
 I 'Y S VALMBCK="R" Q
"RTN","PSOERXC1",183,0)
 S RESP=Y
"RTN","PSOERXC1",184,0)
 S PATIEN=$O(@VALMAR@("IDX",RESP,"")) Q:'PATIEN
"RTN","PSOERXC1",185,0)
 S ERXLOCK=$$L^PSOERX1A(PATIEN,1)
"RTN","PSOERXC1",186,0)
 I 'ERXLOCK S DIR(0)="E" D ^DIR K DIR S VALMBCK="R" Q
"RTN","PSOERXC1",187,0)
 S SRCH(1)=PATIEN D EN^PSOERX(.SRCH,,1)
"RTN","PSOERXC1",188,0)
 D UL^PSOERX1A(PATIEN)
"RTN","PSOERXC1",189,0)
 K %
"RTN","PSOERXC1",190,0)
 S VALMBCK="R"
"RTN","PSOERXC1",191,0)
 Q
"RTN","PSOERXC1",192,0)
DIR(SORT,CNT,SLIST) ;
"RTN","PSOERXC1",193,0)
 N DIR,Y,RLINE,STAG,SVAL
"RTN","PSOERXC1",194,0)
 K DIR
"RTN","PSOERXC1",195,0)
 S DIR(0)="SO^1:PATIENT NAME;2:DATE OF BIRTH"
"RTN","PSOERXC1",196,0)
 I '$D(SORT) S DIR(0)=DIR(0)_";3:ERX REFERENCE NUMBER"
"RTN","PSOERXC1",197,0)
 I CNT<2 S DIR("L")="Select one of the following "_$S($G(SORT):"sort",1:"search")_" criteria:"
"RTN","PSOERXC1",198,0)
 I CNT>1 D
"RTN","PSOERXC1",199,0)
 .S DIR("L")=""
"RTN","PSOERXC1",200,0)
 .S DIR("L",11)="Select another search criteria or '^' to exit. Press enter to use the currently"
"RTN","PSOERXC1",201,0)
 .S DIR("L",12)="selected search criteria."
"RTN","PSOERXC1",202,0)
 S DIR("L",2)=""
"RTN","PSOERXC1",203,0)
 S DIR("L",3)=" "_$S($D(SLIST(1)):"*",1:"")_"1.) PATIENT NAME"
"RTN","PSOERXC1",204,0)
 S DIR("L",4)=" "_$S($D(SLIST(2)):"*",1:"")_"2.) DATE OF BIRTH"
"RTN","PSOERXC1",205,0)
 I '$D(SORT) S DIR("L",5)=" "_$S($D(SLIST(3)):"*",1:"")_"3.) ERX REFERENCE NUMBER"
"RTN","PSOERXC1",206,0)
 S DIR("L",6)=""
"RTN","PSOERXC1",207,0)
 S DIR("L",7)=$S($D(SLIST):" * - indicates selected criteria.",1:"")
"RTN","PSOERXC1",208,0)
 D ^DIR K DIR Q:'Y 0
"RTN","PSOERXC1",209,0)
 S RES=Y I $G(SORT) Q RES
"RTN","PSOERXC1",210,0)
 S RLINE=$S(RES=1:"PAT",RES=2:"DOB",RES=3:"EREFNUM",1:"")
"RTN","PSOERXC1",211,0)
 I RLINE']"" Q 0
"RTN","PSOERXC1",212,0)
 S STAG=RLINE
"RTN","PSOERXC1",213,0)
 S SVAL=$$@STAG I SVAL="" Q 0
"RTN","PSOERXC1",214,0)
 Q RES_U_SVAL
"RTN","PSOERXC1",215,0)
PAT() ;
"RTN","PSOERXC1",216,0)
 N Y,DIC
"RTN","PSOERXC1",217,0)
 S DIC=52.46,DIC(0)="AEMQ" D ^DIC
"RTN","PSOERXC1",218,0)
 I Y<1 Q ""
"RTN","PSOERXC1",219,0)
 Q Y
"RTN","PSOERXC1",220,0)
DOB() ;
"RTN","PSOERXC1",221,0)
 N %DT,Y
"RTN","PSOERXC1",222,0)
 S %DT="A"
"RTN","PSOERXC1",223,0)
 S %DT("A")="Enter the Date of Birth (DOB): "
"RTN","PSOERXC1",224,0)
 D ^%DT
"RTN","PSOERXC1",225,0)
 I Y<1 Q ""
"RTN","PSOERXC1",226,0)
 Q Y
"RTN","PSOERXC1",227,0)
EREFNUM() ;
"RTN","PSOERXC1",228,0)
 N DIR,Y
"RTN","PSOERXC1",229,0)
 S DIR(0)="FO",DIR("A")="Enter the eRx Reference number" D ^DIR
"RTN","PSOERXC1",230,0)
 I Y=""!(Y="^") Q ""
"RTN","PSOERXC1",231,0)
 Q $$UP^XLFSTR(Y)
"RTN","PSOERXC1",232,0)
BLDITEM(IEN,PATCNT,STAT) ;
"RTN","PSOERXC1",233,0)
 N PATIEN,DOB,ERXSTAT,ERXESTAT,ESCODE
"RTN","PSOERXC1",234,0)
 S ERXSTAT=$$GET1^DIQ(52.49,ERXIEN,1,"I")
"RTN","PSOERXC1",235,0)
 S ERXESTAT=$$GET1^DIQ(52.49,ERXIEN,1,"E")
"RTN","PSOERXC1",236,0)
 S ESCODE=","_$S($E(ERXESTAT)="H":$E(ERXESTAT),1:ERXESTAT)_"," I ",RXN,RXW,RXD,RXF,CAO,CAR,CAH,CAP,CAX,CAF,N,I,W,H,"'[ESCODE Q
"RTN","PSOERXC1",237,0)
 I $G(STAT)]"" Q:'$$CHKSTAT(STAT,ERXESTAT,ERXSTAT)
"RTN","PSOERXC1",238,0)
 S PATIEN=$$GET1^DIQ(52.49,ERXIEN,.04,"I") Q:'PATIEN
"RTN","PSOERXC1",239,0)
 I $D(SRCH(1)),PATIEN'=$P($G(SRCH(1)),U) Q
"RTN","PSOERXC1",240,0)
 S DOB=$$GET1^DIQ(52.46,PATIEN,.08,"I")
"RTN","PSOERXC1",241,0)
 I $D(SRCH(2)),DOB'=$G(SRCH(2)) Q
"RTN","PSOERXC1",242,0)
 I $D(^TMP("CENTRIC",$J,PATIEN)) Q
"RTN","PSOERXC1",243,0)
 S ^TMP("CENTRIC",$J,PATIEN)="",PATCNT=$G(PATCNT)+1
"RTN","PSOERXC1",244,0)
 Q
"RTN","PSOERXC1",245,0)
CHKSTAT(FILSTAT,ERXSTAT,ERXISTAT) ;
"RTN","PSOERXC1",246,0)
 N RET
"RTN","PSOERXC1",247,0)
 S RET=0
"RTN","PSOERXC1",248,0)
 I $G(FILSTAT)="CCR",ERXSTAT'="RXN",ERXSTAT'="RXW",ERXSTAT'="RXD",ERXSTAT'="RXF",ERXSTAT'="CAO",ERXSTAT'="CAR",ERXSTAT'="CAH",ERXSTAT'="CAP",ERXSTAT'="CAX",ERXSTAT'="CAF" Q RET
"RTN","PSOERXC1",249,0)
 I $G(FILSTAT)="AH",$E(ERXSTAT)'="H" Q RET
"RTN","PSOERXC1",250,0)
 I $G(FILSTAT)'="A",$G(FILSTAT)'="CCR",$G(FILSTAT)'="AH",FILSTAT'=ERXISTAT Q RET
"RTN","PSOERXC1",251,0)
 Q 1
"RTN","PSOERXC1",252,0)
EX ; early exit logic
"RTN","PSOERXC1",253,0)
 K PSOSRCH,PSOSRT,SRCH,SORTT,PSOPRMPT
"RTN","PSOERXC1",254,0)
 S PSOC1RE=1
"RTN","PSOERXC1",255,0)
 D EX^PSOORFI1
"RTN","PSOERXC1",256,0)
 Q
"RTN","PSOERXC1",257,0)
HELP ; -- help code
"RTN","PSOERXC1",258,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERXC1",259,0)
 Q
"RTN","PSOERXC1",260,0)
 ;
"RTN","PSOERXC1",261,0)
EXIT ; -- exit code
"RTN","PSOERXC1",262,0)
 K PSOPRMPT,@VALMAR
"RTN","PSOERXC1",263,0)
 S PSOC1RE=1
"RTN","PSOERXC1",264,0)
 Q
"RTN","PSOERXC1",265,0)
 ;
"RTN","PSOERXC1",266,0)
EXPND ; -- expand code
"RTN","PSOERXC1",267,0)
 Q
"RTN","PSOERXD2")
0^39^B182647633^B211196189
"RTN","PSOERXD2",1,0)
PSOERXD2 ;ALB/BWF - eRx Drug edit actions ; 5/26/2017 9:57am
"RTN","PSOERXD2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,506,520,508**;DEC 1997;Build 295
"RTN","PSOERXD2",3,0)
 ;
"RTN","PSOERXD2",4,0)
 Q
"RTN","PSOERXD2",5,0)
SBN ;
"RTN","PSOERXD2",6,0)
 N Y,ERXIEN
"RTN","PSOERXD2",7,0)
 S Y=$P(XQORNOD(0),"=",2)
"RTN","PSOERXD2",8,0)
 I Y']"" S VALMBCK="R" Q
"RTN","PSOERXD2",9,0)
 D EDIT^PSOERX1A("D",Y)
"RTN","PSOERXD2",10,0)
 S VALMBCK="R"
"RTN","PSOERXD2",11,0)
 Q
"RTN","PSOERXD2",12,0)
VDRG1(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",13,0)
 N VANDRG,VAODRG,DIE,DA,DR,AUTOVAL,DIC,Y,QTLOOP,SELDRG,VDRG,VANDRG,VAOI,PATINST,FIELD,MTYPE
"RTN","PSOERXD2",14,0)
 Q:'$G(PSOIEN)
"RTN","PSOERXD2",15,0)
 S VAODRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I")
"RTN","PSOERXD2",16,0)
 S AUTOVAL=$$GET1^DIQ(52.49,PSOIEN,1.4,"I")
"RTN","PSOERXD2",17,0)
 S MTYPE=$$GET1^DIQ(52.49,PSOIEN,.08,"I")
"RTN","PSOERXD2",18,0)
 I VAODRG W !,"Current Vista Drug: "_$$GET1^DIQ(50,VAODRG,.01,"E")
"RTN","PSOERXD2",19,0)
 ; for now allow user to search by drug name. may enhance screening in the future.
"RTN","PSOERXD2",20,0)
 S DIC(0)="AEMQ",DIC=50,DIC("S")="I $$ACTIVE^PSOERXA0(Y),($$OUTPAT^PSOERXA0(Y)),('$$INVCOMP^PSOERXA0(Y)),('$$CS^PSOERXA0(Y))"
"RTN","PSOERXD2",21,0)
 I VAODRG]"" S DIC("B")=VAODRG
"RTN","PSOERXD2",22,0)
 D ^DIC K DIC
"RTN","PSOERXD2",23,0)
 I $G(DUOUT)!($P(Y,U)<1) S PQUIT=1 Q
"RTN","PSOERXD2",24,0)
 S SELDRG=Y
"RTN","PSOERXD2",25,0)
 W !!,"You have selected: "_$P(Y,U,2),!,"Would you like to use this drug/supply?" S DIR(0)="YO" D ^DIR K DIR
"RTN","PSOERXD2",26,0)
 I Y="^"!(Y<1) S PQUIT=1 Q
"RTN","PSOERXD2",27,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="3.2///"_$P(SELDRG,U,1) D ^DIE
"RTN","PSOERXD2",28,0)
 ; set the manual validation flag if the drug has been selected.
"RTN","PSOERXD2",29,0)
 S VANDRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I")
"RTN","PSOERXD2",30,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERXD2",31,0)
 ; if the drug has changed, update the manual validation by and date/time
"RTN","PSOERXD2",32,0)
 I VANDRG'="",VAODRG'=VANDRG D
"RTN","PSOERXD2",33,0)
 .S QTLOOP=0 F  S QTLOOP=$O(^PS(52.49,PSOIEN,21,QTLOOP)) Q:'QTLOOP  D
"RTN","PSOERXD2",34,0)
 ..S FDA(52.4921,QTLOOP_","_PSOIENS,.01)="@" D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",35,0)
 .; if the drug is the same, leave the manual validation,otherwise delete it.
"RTN","PSOERXD2",36,0)
 .S FDA(52.49,PSOIENS,1.5)="",FDA(52.49,PSOIENS,1.11)="",FDA(52.49,PSOIENS,1.12)="",FDA(52.49,PSOIENS,20.3)="",FDA(52.49,PSOIENS,20.4)=""
"RTN","PSOERXD2",37,0)
 .S FDA(52.49,PSOIENS,27)="",FDA(52.49,PSOIENS,20.1)="",FDA(52.49,PSOIENS,20.2)="",FDA(52.49,PSOIENS,20.3)="",FDA(52.49,PSOIENS,20.4)="",FDA(52.49,PSOIENS,20.5)=""
"RTN","PSOERXD2",38,0)
 .D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",39,0)
 .I MTYPE="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERXD2",40,0)
 .I MTYPE="RE" D UPDSTAT^PSOERXU1(PSOIEN,"RXW")
"RTN","PSOERXD2",41,0)
 ; get and file patient instructions
"RTN","PSOERXD2",42,0)
 S VDRG=VANDRG
"RTN","PSOERXD2",43,0)
 S VAOI=$$GET1^DIQ(50,VDRG,2.1,"I")
"RTN","PSOERXD2",44,0)
 S PATINST=$$GET1^DIQ(50.7,VAOI,7,"E")
"RTN","PSOERXD2",45,0)
 I $L(PATINST) D
"RTN","PSOERXD2",46,0)
 .S FDA(52.49,PSOIENS,27)=$G(PATINST)
"RTN","PSOERXD2",47,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",48,0)
 Q
"RTN","PSOERXD2",49,0)
VDRG2(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",50,0)
 N PSOQTS,PSOFROM,PSODOSE,PSONEW,PSODRUG,PSORXED,VERB,QTIEN,SFIENS,DOSE,PSODFN
"RTN","PSOERXD2",51,0)
 S PSODFN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXD2",52,0)
 I 'PSODFN D  Q
"RTN","PSOERXD2",53,0)
 .W !,"Cannot continue with dosing instructions until patient has been matched." D DIRE^PSOERXX1
"RTN","PSOERXD2",54,0)
 .S PQUIT=1
"RTN","PSOERXD2",55,0)
 ; drug ien and orderable item ien
"RTN","PSOERXD2",56,0)
 D DERX1(PSOIEN,PSOIENS,1)
"RTN","PSOERXD2",57,0)
 S PSODRUG("IEN")=$$GET1^DIQ(52.49,PSOIEN,3.2,"I") Q:'PSODRUG("IEN")
"RTN","PSOERXD2",58,0)
 S PSODRUG("OI")=$$GET1^DIQ(50,PSODRUG("IEN"),2.1,"I") Q:'PSODRUG("OI")
"RTN","PSOERXD2",59,0)
 S (PSORXED("ENT"),ENT)=1
"RTN","PSOERXD2",60,0)
 ; SET PSOFROM=PENDING so the dosage list will activate and present to the user
"RTN","PSOERXD2",61,0)
 S PSOFROM="PENDING"
"RTN","PSOERXD2",62,0)
 D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN)
"RTN","PSOERXD2",63,0)
 D ASK^PSOBKDED
"RTN","PSOERXD2",64,0)
 I $G(DOSE)']"" S PQUIT=1 Q
"RTN","PSOERXD2",65,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERXD2",66,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOERXD2",67,0)
VER ;
"RTN","PSOERXD2",68,0)
 D DERX1(PSOIEN,PSOIENS,1)
"RTN","PSOERXD2",69,0)
 ;below logic brought over from VER^PSOOREDX
"RTN","PSOERXD2",70,0)
 D KV S DIR(0)="52.0113,8"
"RTN","PSOERXD2",71,0)
 S:$G(PSORXED("VERB",ENT))]"" DIR("B")=PSORXED("VERB",ENT)
"RTN","PSOERXD2",72,0)
 D ^DIR
"RTN","PSOERXD2",73,0)
 I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOERXD2",74,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",75,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOERXD2",76,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOERXD2",77,0)
DUPD ;
"RTN","PSOERXD2",78,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOERXD2",79,0)
 ; below logic brought over from DUPD^PSOOREDX
"RTN","PSOERXD2",80,0)
 D KV S DIR(0)="52.0113,1",DIR("A")="DISPENSE UNITS PER DOSE"_$S($G(PSORXED("NOUN",ENT))]"":"("_PSORXED("NOUN",ENT)_")",1:"")
"RTN","PSOERXD2",81,0)
 I '$G(PSORXED("DOSE",ENT)),$G(PSORXED("DOSE",ENT-1)) S PSORXED("DOSE",ENT)=PSORXED("DOSE",ENT-1)
"RTN","PSOERXD2",82,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:1) S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOERXD2",83,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOERXD2",84,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",85,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOERXD2",86,0)
 ;below logic brought over from STR^PSOOREDX
"RTN","PSOERXD2",87,0)
 S:+STRE>0&(X>0) PSORXED("DOSE",ENT)=(X*STRE) W !,"Dosage Ordered: "_$S($E(PSORXED("DOSE",ENT),1)=".":"0",1:"")_PSORXED("DOSE",ENT)_UNITN,!
"RTN","PSOERXD2",88,0)
 S:X'="" (PSORXED("DOSE ORDERED",ENT),DUPD)=X
"RTN","PSOERXD2",89,0)
NOU1 ;
"RTN","PSOERXD2",90,0)
 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOERXD2",91,0)
 D CNON
"RTN","PSOERXD2",92,0)
 N PSONDEF
"RTN","PSOERXD2",93,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOERXD2",94,0)
NOU ;
"RTN","PSOERXD2",95,0)
 ;below logic brought over from NOU^PSOOREDX
"RTN","PSOERXD2",96,0)
 D KV S DIR(0)="52.0113,3"
"RTN","PSOERXD2",97,0)
 S DIR("B")=$S($G(NOUN)]"":NOUN,1:$G(PSORXED("NOUN",ENT))) K:DIR("B")="" DIR("B")
"RTN","PSOERXD2",98,0)
 S PSONDEF=$G(DIR("B"))
"RTN","PSOERXD2",99,0)
 D ^DIR
"RTN","PSOERXD2",100,0)
 I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOERXD2",101,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",102,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOERXD2",103,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOERXD2",104,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOERXD2",105,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOERXD2",106,0)
 ;
"RTN","PSOERXD2",107,0)
RTE ;
"RTN","PSOERXD2",108,0)
 N CURTE,ERXRTE
"RTN","PSOERXD2",109,0)
 S CURTE=$$GET1^DIQ(52.4921,ENT_","_PSOIEN_",",10,"E") S PSORXED("ROUTE",ENT)=CURTE
"RTN","PSOERXD2",110,0)
 K JUMP
"RTN","PSOERXD2",111,0)
 S ROU="PSOERXD2" D RTE2 K ROU
"RTN","PSOERXD2",112,0)
 K ROU
"RTN","PSOERXD2",113,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOERXD2",114,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",115,0)
 ;
"RTN","PSOERXD2",116,0)
SCH ;
"RTN","PSOERXD2",117,0)
 K PSOSCH,DIR,CURSCH
"RTN","PSOERXD2",118,0)
 I '$D(ENT) S ENT=PSORXED("ENT")
"RTN","PSOERXD2",119,0)
 S CURSCH=$$GET1^DIQ(52.4921,ENT_","_PSOIEN_",",1,"E") I CURSCH]"" S DIR("B")=CURSCH
"RTN","PSOERXD2",120,0)
 S DIR("?")="^D SCHLP^PSOORED4",DIR("A")="Schedule: ",DIR(0)="FA^1:20^I X[""""""""!(X?.E1C.E)!($A(X)=45)!($L(X,"" "")>$S(X[""PRN"":4,1:3))!($L(X)>20)!($L(X)<1) K X"
"RTN","PSOERXD2",121,0)
 D ^DIR
"RTN","PSOERXD2",122,0)
 I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOERXD2",123,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",124,0)
 S SCH=$$SCHASL^PSOORED5(Y) D SCH^PSOSIG I $G(SCH)']""!($D(DTOUT))!($D(DUOUT)) G SCH
"RTN","PSOERXD2",125,0)
 S PSORXED("SCHEDULE",ENT)=SCH IF $G(SCHEX)'="" W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOERXD2",126,0)
 ;S SCH=Y D SCH^PSOSIG I $G(SCH)']"" G SCH
"RTN","PSOERXD2",127,0)
 ;S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOERXD2",128,0)
 S:PSORXED("ENT")<ENT PSORXED("ENT")=ENT
"RTN","PSOERXD2",129,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXD2",130,0)
 S PSORXED("SCHEDULE",ENT)=$$UP^XLFSTR(PSORXED("SCHEDULE",ENT))
"RTN","PSOERXD2",131,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXD2",132,0)
DUR ;
"RTN","PSOERXD2",133,0)
 N SIG,SIGDAT,SLOOP,P01,I,DDONE
"RTN","PSOERXD2",134,0)
 D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN DAYS, HOURS OR MINUTES)"
"RTN","PSOERXD2",135,0)
 S DIR("B")=$S($G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOERXD2",136,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOERXD2",137,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",138,0)
 ;below logic is from DUR1^PSOOREDX
"RTN","PSOERXD2",139,0)
 I X="@" K DUR,PSORXED("DURATION",ENT)
"RTN","PSOERXD2",140,0)
 I Y'="" S PSORXED("DURATION",ENT)=Y W " ("_$S(Y["L":"MONTHS",Y["W":"WEEKS",Y["H":"HOURS",Y["M":"MINUTES",1:"DAYS")_")"
"RTN","PSOERXD2",141,0)
 ;
"RTN","PSOERXD2",142,0)
 ; KEEP THIS CODE! - REMOVE CONJUNCTION FOR NOW, SINCE WE WILL NOT HAVE COMPLEX DOSING - FUTURE ENHANCEMENT
"RTN","PSOERXD2",143,0)
 ;CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOERXD2",144,0)
 ;G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",145,0)
 ;I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOERXD2",146,0)
 ;S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOERXD2",147,0)
 ;I X="@",$D(PSORXED("CONJUNCTION",ENT)) D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOERXD2",148,0)
 ;;
"RTN","PSOERXD2",149,0)
 ;N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOERXD2",150,0)
 ;;*437
"RTN","PSOERXD2",151,0)
 ;I '$$DUROK^PSOORED3(.PSORXED,ENT) D  G DUR
"RTN","PSOERXD2",152,0)
 ;. W !!,"Duration is required for the dosage entered prior to the THEN conjunction.",$C(7),!
"RTN","PSOERXD2",153,0)
 ;I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSONEW("DFLG")) EX S ENT=ENT+1 K DIR G ASK
"RTN","PSOERXD2",154,0)
 ;E  K PSOCKCON D DCHK1^PSODOSUT I $D(DTOUT)!($D(DUOUT)) S PSORX("DFLG")=1,PSONEW("DFLG")=1 G EX  ;don't need to print the full summary, just the last sequence. 
"RTN","PSOERXD2",155,0)
 ;I PSOSAVX="",$G(PSORXED) K PSOCKCON,PSOEDDOS
"RTN","PSOERXD2",156,0)
 ;K PSOSAVX
"RTN","PSOERXD2",157,0)
 ;;
"RTN","PSOERXD2",158,0)
 ;S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOERXD2",159,0)
 ;D EN^PSOFSIG(.PSORXED),VERI I $G(CKX),'$G(PSOSIGFL) D MP1 K CKX
"RTN","PSOERXD2",160,0)
 ;I $G(PSOSIGFL)=1 D  I '$G(PSOSIGFL) Q
"RTN","PSOERXD2",161,0)
 ;.I $D(OR0),$P(OR0,"^",24)=1 S VALMSG="Digitally Signed Order - No such changes allowed." K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D  Q
"RTN","PSOERXD2",162,0)
 ;..I $D(PSOBDR) K PSODRUG M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOERXD2",163,0)
 ;.S PSORXED("ENT")=ENT,SIGOK=1,VALMSG="This change will create a new prescription!",NCPDPFLG=1
"RTN","PSOERXD2",164,0)
 ;K QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOERXD2",165,0)
 ;I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOERXD2",166,0)
 ;K QTYHLD
"RTN","PSOERXD2",167,0)
 ;I '$G(PSORXED("QTY")),$P(OR0,"^",10) S PSORXED("QTY")=$P(OR0,"^",10)
"RTN","PSOERXD2",168,0)
 ;S PSORXED("INS")="TESTING TO SEE HOW LONG WE CAN MAKE THE SIG AND GET THIS TO FORMAT CORRECTLY"
"RTN","PSOERXD2",169,0)
 S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOERXD2",170,0)
 D EN^PSOFSIG(.PSORXED)
"RTN","PSOERXD2",171,0)
 ; delete existing SIG
"RTN","PSOERXD2",172,0)
 S SLOOP=0 F  S SLOOP=$O(^PS(52.49,PSOIEN,"SIG",SLOOP)) Q:'SLOOP  D
"RTN","PSOERXD2",173,0)
 .S FDA(52.4926,SLOOP_","_PSOIEN_",",.01)="@"
"RTN","PSOERXD2",174,0)
 I $D(FDA) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",175,0)
 ; file sig into VA DISPENSING INSTRUCTIONS multiple
"RTN","PSOERXD2",176,0)
 S SLOOP=0 F  S SLOOP=$O(SIG(SLOOP)) Q:'SLOOP  D
"RTN","PSOERXD2",177,0)
 .S SIGDAT=$G(SIG(SLOOP)) Q:SIGDAT=""
"RTN","PSOERXD2",178,0)
 .S SFDA(52.4926,"+1,"_PSOIENS,.01)=SIGDAT D UPDATE^DIE(,"SFDA",,"SERR") K SFDA
"RTN","PSOERXD2",179,0)
 S QTIEN=$O(^PS(52.49,PSOIEN,21,0))
"RTN","PSOERXD2",180,0)
 S SFIENS=$S(QTIEN:QTIEN_",",1:"+1,")
"RTN","PSOERXD2",181,0)
 S P01=$S($L($G(PSORXED("DOSE ORDERED",ENT))):$G(PSORXED("DOSE ORDERED",ENT))_"&"_$G(PSORXED("NOUN",ENT)),1:$G(PSORXED("DOSE",ENT)))
"RTN","PSOERXD2",182,0)
 I '$L(P01) D  Q
"RTN","PSOERXD2",183,0)
 .W !,"Dosage is required. Please re-enter the dosing instructions." S DIR(0)="W" D ^DIR D EX Q 
"RTN","PSOERXD2",184,0)
 S FDA(52.4921,SFIENS_PSOIENS,.01)=P01
"RTN","PSOERXD2",185,0)
 S FDA(52.4921,SFIENS_PSOIENS,1)=$G(PSORXED("SCHEDULE",ENT))
"RTN","PSOERXD2",186,0)
 S FDA(52.4921,SFIENS_PSOIENS,2)=$G(PSORXED("DURATION",ENT))
"RTN","PSOERXD2",187,0)
 S FDA(52.4921,SFIENS_PSOIENS,8)=$G(PSORXED("DOSE",ENT))
"RTN","PSOERXD2",188,0)
 S FDA(52.4921,SFIENS_PSOIENS,9)=$G(PSORXED("DOSE ORDERED",ENT))
"RTN","PSOERXD2",189,0)
 S FDA(52.4921,SFIENS_PSOIENS,10)=$G(PSORXED("ROUTE",ENT))
"RTN","PSOERXD2",190,0)
 S FDA(52.4921,SFIENS_PSOIENS,11)=$G(PSORXED("UNITS",ENT))
"RTN","PSOERXD2",191,0)
 S FDA(52.4921,SFIENS_PSOIENS,12)=$G(PSORXED("NOUN",ENT))
"RTN","PSOERXD2",192,0)
 S FDA(52.4921,SFIENS_PSOIENS,13)=$G(PSORXED("VERB",ENT))
"RTN","PSOERXD2",193,0)
 ; VA INSTRUCTIONS
"RTN","PSOERXD2",194,0)
 N UNEXINS,UNEXARY,DDONE
"RTN","PSOERXD2",195,0)
 I $G(PSORXED("ENT")) D
"RTN","PSOERXD2",196,0)
 .S DDONE=0
"RTN","PSOERXD2",197,0)
 .F I=1:1:PSORXED("ENT")  D  Q:DDONE
"RTN","PSOERXD2",198,0)
 ..I '$D(PSORXED("DOSE ORDERED",I)) S DDONE=1 Q
"RTN","PSOERXD2",199,0)
 ..I '$L($G(UNEXINS)) D  Q
"RTN","PSOERXD2",200,0)
 ...S UNEXINS=$G(PSORXED("VERB",I))_" "_$G(PSORXED("DOSE ORDERED",I))_" "_$G(PSORXED("NOUN",I))_" "_$G(ERXRTE(I))_" "_$G(PSORXED("SCHEDULE",I))
"RTN","PSOERXD2",201,0)
 ...I $L($G(PSORXED("DURATION",I))) S UNEXINS=UNEXINS_" "_$G(PSORXED("DURATION",I))
"RTN","PSOERXD2",202,0)
 ...I $L($G(PSORXED("CONJUNCTION",I))) S UNEXINS=UNEXINS_" "_$G(PSORXED("CONJUNCTION",I))
"RTN","PSOERXD2",203,0)
 ..S UNEXINS=UNEXINS_$G(PSORXED("VERB",I))_" "_$G(PSORXED("DOSE ORDERED",I))_" "_$G(PSORXED("NOUN",I))_" "_$G(ERXRTE(I))_" "_$G(PSORXED("SCHEDULE",I))
"RTN","PSOERXD2",204,0)
 ..I $L($G(PSORXED("DURATION",I))) S UNEXINS=UNEXINS_" "_$G(PSORXED("DURATION",I))
"RTN","PSOERXD2",205,0)
 ..I $L($G(PSORXED("CONJUNCTION",I))) S UNEXINS=UNEXINS_" "_$G(PSORXED("CONJUNCTION",I))
"RTN","PSOERXD2",206,0)
 I $L($G(UNEXINS)) D
"RTN","PSOERXD2",207,0)
 .D TXT2ARY^PSOERXD1(.UNEXARY,UNEXINS,,80)
"RTN","PSOERXD2",208,0)
 .D WP^DIE(52.49,PSOIEN_",",31,"K","UNEXARY","BWFERR")
"RTN","PSOERXD2",209,0)
 I SFIENS["+" D UPDATE^DIE(,"FDA",,"ERR") K FDA
"RTN","PSOERXD2",210,0)
 ; if there is a quantity/timing entry, overwrite the data (we are not using complex dosing in this phase)
"RTN","PSOERXD2",211,0)
 I SFIENS'["+" D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",212,0)
EX ;
"RTN","PSOERXD2",213,0)
 K PSOBDR,PSOBDRG,PSOSCH,DUPD,STRE,UNITN,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSODOSE,OLENT,FIELD,FLDNM,AR,NM,ENT,STRE,UNITN,PSODOSE,ERTE,ROU,AR1,INS1
"RTN","PSOERXD2",214,0)
KV K DTOUT,DUOUT,DIR,DIRUT
"RTN","PSOERXD2",215,0)
 Q
"RTN","PSOERXD2",216,0)
EXQ ;
"RTN","PSOERXD2",217,0)
 K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D MP1
"RTN","PSOERXD2",218,0)
 I $D(PSOBDR) M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOERXD2",219,0)
 S PQUIT=1
"RTN","PSOERXD2",220,0)
 G EX Q
"RTN","PSOERXD2",221,0)
MP1 ;
"RTN","PSOERXD2",222,0)
 S VALMSG="eRx Not Updated!"
"RTN","PSOERXD2",223,0)
 Q
"RTN","PSOERXD2",224,0)
JUMP ;jump to fields
"RTN","PSOERXD2",225,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOERXD2",226,0)
 D FNM
"RTN","PSOERXD2",227,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOERXD2",228,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOERXD2",229,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOERXD2",230,0)
 D JFN G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOERXD2",231,0)
 G EX
"RTN","PSOERXD2",232,0)
 Q
"RTN","PSOERXD2",233,0)
FNM S NM=$E(X,2,4),NM=$TR(NM,"qwertyuioplkjhgfdsazxcvbnm","QWERTYUIOPLKJHGFDSAZXCVBNM")
"RTN","PSOERXD2",234,0)
 S FLDNM=$S(NM="DOS":"DOSE^*Dosage",NM="DIS":"DOSE ORDERED^Dispense Units",NM="ROU":"ROUTE^*Route",NM="SCH":"SCHEDULE^*Schedule",NM="DUR"!(NM="LIM"):"DURATION^*Duration",1:"")
"RTN","PSOERXD2",235,0)
 S:FLDNM="" FLDNM=$S(NM="CON":"CONJUNCTION^*Conjunction",NM="NOU":"NOUN^Noun",NM="VER":"VERB^Verb",1:"")
"RTN","PSOERXD2",236,0)
 Q
"RTN","PSOERXD2",237,0)
JFN K FLDNM,AR S ENT=+Y,FLDNM=$S(NM="NOU":"NOU",NM="VER":"VER",NM="DOS":"ASK",NM="DIS":"DUPD",NM="ROU":"RTE",NM="SCH":"SCH",NM="DUR"!(NM="LIM"):"DUR",NM="CON":"CON",1:"")
"RTN","PSOERXD2",238,0)
 Q
"RTN","PSOERXD2",239,0)
CNON ;
"RTN","PSOERXD2",240,0)
 I $G(NOUN)'="" Q
"RTN","PSOERXD2",241,0)
 I '$G(PSORXED("DOSE ORDERED",ENT)) Q
"RTN","PSOERXD2",242,0)
 N PSONLT,PSONLL,PSONLG
"RTN","PSOERXD2",243,0)
 S PSONLL=$P($G(DOSE("DD",+$G(PSODRUG("IEN")))),"^",9) I PSONLL="" Q
"RTN","PSOERXD2",244,0)
 S PSONLG=$L(PSONLL)
"RTN","PSOERXD2",245,0)
 I PSONLG'>3 Q
"RTN","PSOERXD2",246,0)
 S PSONLT=$E(PSONLL,(PSONLG-2),PSONLG)
"RTN","PSOERXD2",247,0)
 I PSONLT'="(S)",PSONLT'="(s)" Q
"RTN","PSOERXD2",248,0)
 ;test noun of (S)
"RTN","PSOERXD2",249,0)
 K NOUN
"RTN","PSOERXD2",250,0)
 I $G(PSORXED("DOSE ORDERED",ENT))>1 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))_$E(PSONLT,2) Q
"RTN","PSOERXD2",251,0)
 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))
"RTN","PSOERXD2",252,0)
 Q
"RTN","PSOERXD2",253,0)
RTE2 I $G(DRET) S PSORXED("ROUTE",ENT)=""
"RTN","PSOERXD2",254,0)
 I $G(RTE) K RTE
"RTN","PSOERXD2",255,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXD2",256,0)
 K DIR,DIRUT S DIR(0)="F^2:45",DIR("A")="ROUTE",DIR("?")="^D HLP^PSOORED4"
"RTN","PSOERXD2",257,0)
 ;/BLB/ PSO*7.0*520 - END CHANGE
"RTN","PSOERXD2",258,0)
 ;S DIR("B")=$S($G(PSORXED("ROUTE",ENT)):$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),$G(RTE)]"":RTE,$G(DRET):"",1:"PO") K:DIR("B")="" DIR("B")
"RTN","PSOERXD2",259,0)
 S DIR("B")=$G(CURTE)
"RTN","PSOERXD2",260,0)
 ;I '$G(PSORXED("ROUTE",ENT)),$G(PSOREEDT) K DIR("B")
"RTN","PSOERXD2",261,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="RTE",JUMP=1 K DIRUT,DTOUT Q
"RTN","PSOERXD2",262,0)
 Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOERXD2",263,0)
 I X="@"!(X="") K RTE,ERTE S DRET=1,PSORXED("ROUTE",ENT)="" Q
"RTN","PSOERXD2",264,0)
 K DRET I X=$P($G(^PS(51.2,+$G(PSORXED("ROUTE",ENT)),0)),"^") S RTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),ERTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^",2) W X_" "_$G(ERTE) Q
"RTN","PSOERXD2",265,0)
 S DIC=51.2,DIC(0)="QEZM",DIC("S")="I $P(^(0),""^"",4)" D ^DIC Q:X[U  G:Y=-1 RTE2 W "  "_$P(Y(0),"^",2)
"RTN","PSOERXD2",266,0)
 ;S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2)
"RTN","PSOERXD2",267,0)
 S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2),ERXRTE(ENT)=$P(Y(0),U,3)
"RTN","PSOERXD2",268,0)
 Q
"RTN","PSOERXD2",269,0)
VDRG3(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",270,0)
 N DIR,Y,PATINST,ERXDRUG,VDRG,VAOI,FDA
"RTN","PSOERXD2",271,0)
 D DERX1(PSOIEN,PSOIENS,1)
"RTN","PSOERXD2",272,0)
 S ERXDRUG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I")
"RTN","PSOERXD2",273,0)
 S PATINST=$$GET1^DIQ(52.49,PSOIEN,27,"E")
"RTN","PSOERXD2",274,0)
 I '$L(PATINST) D
"RTN","PSOERXD2",275,0)
 .S VDRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I") Q:'VDRG
"RTN","PSOERXD2",276,0)
 .S VAOI=$$GET1^DIQ(50,VDRG,2.1,"I") Q:'VAOI
"RTN","PSOERXD2",277,0)
 .S PATINST=$$GET1^DIQ(50.7,VAOI,7,"E")
"RTN","PSOERXD2",278,0)
 K DIR
"RTN","PSOERXD2",279,0)
 S DIR(0)="52.49,27",DIR("A")="VA PATIENT INSTRUCTIONS"
"RTN","PSOERXD2",280,0)
 I $L(PATINST) S DIR("B")=PATINST
"RTN","PSOERXD2",281,0)
 D ^DIR K DIR
"RTN","PSOERXD2",282,0)
 I Y["^" S PQUIT=1 Q
"RTN","PSOERXD2",283,0)
 S FDA(52.49,PSOIEN_",",27)=$$UP^XLFSTR(Y) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",284,0)
 Q
"RTN","PSOERXD2",285,0)
VDRG4(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",286,0)
 N DIR,Y,USERCOMM,VPATINST,UFLAG,VAPCOMM,ERXPCOMM,FDA
"RTN","PSOERXD2",287,0)
 ; POSSIBLE FUTURE IMPLEMENTATION OF ERX DETAILS
"RTN","PSOERXD2",288,0)
 ;D DERX1(PSOIEN,PSOIENS,1)
"RTN","PSOERXD2",289,0)
 S VPATINST=$$GET1^DIQ(52.49,PSOIEN,27,"E")
"RTN","PSOERXD2",290,0)
 S ERXPCOMM=$$GET1^DIQ(52.49,PSOIEN,8,"E")
"RTN","PSOERXD2",291,0)
 S VAPCOMM=$$GET1^DIQ(52.49,PSOIEN,30,"E")
"RTN","PSOERXD2",292,0)
 S DIR(0)="FO^1:240",DIR("A")="VA Provider Comments",DIR("B")=$S($L(VAPCOMM):VAPCOMM,1:ERXPCOMM)
"RTN","PSOERXD2",293,0)
 D ^DIR K DIR
"RTN","PSOERXD2",294,0)
 I Y["^" S PQUIT=1 Q
"RTN","PSOERXD2",295,0)
 S USERCOMM=$$UP^XLFSTR(Y) K Y
"RTN","PSOERXD2",296,0)
 S FDA(52.49,PSOIEN_",",30)=$$UP^XLFSTR(USERCOMM) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",297,0)
 Q
"RTN","PSOERXD2",298,0)
VDRG5(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",299,0)
 N PATIEN,PS55IEN,Y,DIE,DR,DA,FDA,ANS,PATSTAT,DONE
"RTN","PSOERXD2",300,0)
 S PATIEN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXD2",301,0)
 I 'PATIEN W !!,"Patient has not been validated, cannot edit patient status",! Q
"RTN","PSOERXD2",302,0)
 S PSODFN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXD2",303,0)
 S PATSTAT=$$GET1^DIQ(55,PSODFN,3,"E")
"RTN","PSOERXD2",304,0)
 S DIR("B")=PATSTAT
"RTN","PSOERXD2",305,0)
 S DIR(0)="55,3",DIR("A")="PATIENT STATUS"
"RTN","PSOERXD2",306,0)
 D ^DIR K DIR
"RTN","PSOERXD2",307,0)
 I 'PATSTAT,'+Y D
"RTN","PSOERXD2",308,0)
 .S DONE=0
"RTN","PSOERXD2",309,0)
 .F  D  Q:DONE
"RTN","PSOERXD2",310,0)
 ..W !,"This is a required response. Enter '^' to exit"
"RTN","PSOERXD2",311,0)
 ..S DIR(0)="55,3",DIR("A")="PATIENT STATUS" D ^DIR K DIR
"RTN","PSOERXD2",312,0)
 ..I +Y S DONE=1 Q
"RTN","PSOERXD2",313,0)
 ..I Y["^" S PQUIT=1,DONE=1 Q
"RTN","PSOERXD2",314,0)
 S ANS=$P(Y,"^",1)
"RTN","PSOERXD2",315,0)
 S FDA(55,PSODFN_",",3)=ANS
"RTN","PSOERXD2",316,0)
 D FILE^DIE(,"FDA","ERR") K FDA,ERR
"RTN","PSOERXD2",317,0)
 Q
"RTN","PSOERXD2",318,0)
VDRG7(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",319,0)
 N DIR,PSODRG,DRGMSG,ERXQTY,VAQTY,DIE,DA,DR
"RTN","PSOERXD2",320,0)
 S PSODRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I")
"RTN","PSOERXD2",321,0)
 I PSODRG S DRGMSG=$$GET1^DIQ(50,PSODRG,215,"E")
"RTN","PSOERXD2",322,0)
 S ERXQTY=$$GET1^DIQ(52.49,PSOIEN,5.1,"E")
"RTN","PSOERXD2",323,0)
 W !,"eRx Quantity: "_ERXQTY
"RTN","PSOERXD2",324,0)
 I $P(ERXQTY,".",2)>2 S ERXQTY=""
"RTN","PSOERXD2",325,0)
 S VAQTY=$$GET1^DIQ(52.49,PSOIEN,20.1,"E")
"RTN","PSOERXD2",326,0)
 S PQUIT=$$QTYDSRFL^PSOERXU4(PSOIEN,2)
"RTN","PSOERXD2",327,0)
 Q
"RTN","PSOERXD2",328,0)
VDRG6(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",329,0)
 N Y,ERXDS,DIE,DR,DA
"RTN","PSOERXD2",330,0)
 S ERXDS=$$GET1^DIQ(52.49,PSOIEN,5.5,"E")
"RTN","PSOERXD2",331,0)
 W !,"eRx Days Supply: "_ERXDS
"RTN","PSOERXD2",332,0)
 S PQUIT=$$QTYDSRFL^PSOERXU4(PSOIEN,1)
"RTN","PSOERXD2",333,0)
 Q
"RTN","PSOERXD2",334,0)
VDRG8(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",335,0)
 N Y,ERXRFLS,DIE,DR,DA
"RTN","PSOERXD2",336,0)
 S ERXRFLS=$$GET1^DIQ(52.49,PSOIEN,5.6,"E")
"RTN","PSOERXD2",337,0)
 W !,"eRx Refills: "_ERXRFLS
"RTN","PSOERXD2",338,0)
 S PQUIT=$$QTYDSRFL^PSOERXU4(PSOIEN,3)
"RTN","PSOERXD2",339,0)
 Q
"RTN","PSOERXD2",340,0)
VDRG9(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",341,0)
 N Y,DIR,DIE,DR,DA
"RTN","PSOERXD2",342,0)
 S DIR("A")="PICKUP ROUTING"
"RTN","PSOERXD2",343,0)
 S DIR(0)="SO^M:MAIL;W:WINDOW",DIR("B")="M" D ^DIR K DIR
"RTN","PSOERXD2",344,0)
 I Y["^" S PQUIT=1 Q
"RTN","PSOERXD2",345,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="20.4///"_Y D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",346,0)
 Q
"RTN","PSOERXD2",347,0)
VDRG10(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",348,0)
 N DIC,Y,VACLIN,CURCLIN,DIE,DR,DA
"RTN","PSOERXD2",349,0)
 S CURCLIN=$$GET1^DIQ(52.49,PSOIEN,20.6,"E")
"RTN","PSOERXD2",350,0)
 I '$L(CURCLIN) S CURCLIN=$$GET1^DIQ(59,PSOSITE,10,"E")
"RTN","PSOERXD2",351,0)
 S DIC("B")=CURCLIN
"RTN","PSOERXD2",352,0)
 S DIC="^SC(",DIC(0)="QEAMZ",DIC("A")="Select CLINIC: " D ^DIC K DIC
"RTN","PSOERXD2",353,0)
 I Y<1 Q
"RTN","PSOERXD2",354,0)
 I ($D(DTOUT))!($D(DUOUT)) S PQUIT=1 Q
"RTN","PSOERXD2",355,0)
 S VACLIN=$P(Y,U)
"RTN","PSOERXD2",356,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="20.6///"_VACLIN D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",357,0)
 K DTOUT,DUOUT
"RTN","PSOERXD2",358,0)
 Q
"RTN","PSOERXD2",359,0)
VDRG11(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",360,0)
 N DIE,DR,DA,Y
"RTN","PSOERXD2",361,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="8" D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",362,0)
 I $O(Y(0)) S PQUIT=1
"RTN","PSOERXD2",363,0)
 Q
"RTN","PSOERXD2",364,0)
 ; display erx info
"RTN","PSOERXD2",365,0)
 ; DFLG - display flag
"RTN","PSOERXD2",366,0)
 ;          1 - drug sig comments
"RTN","PSOERXD2",367,0)
 ;          ""- all        
"RTN","PSOERXD2",368,0)
DERX1(PSOIEN,PSOIENS,DFLG) ;
"RTN","PSOERXD2",369,0)
 D DERX1^PSOERXU4(PSOIEN,PSOIENS,$G(DFLG))
"RTN","PSOERXD2",370,0)
 Q
"RTN","PSOERXEN")
0^31^B15625365^n/a
"RTN","PSOERXEN",1,0)
PSOERXEN ;ALB/BWF - eRx Utilities/RPC's ; 6/1/2018 5:14pm
"RTN","PSOERXEN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**508**;DEC 1997;Build 295
"RTN","PSOERXEN",3,0)
 ;
"RTN","PSOERXEN",4,0)
 Q
"RTN","PSOERXEN",5,0)
EN ;
"RTN","PSOERXEN",6,0)
 N PSNPINST,DIR,Y,CODE
"RTN","PSOERXEN",7,0)
 I '$$CHKKEY^PSOERX(DUZ) D  Q
"RTN","PSOERXEN",8,0)
 .W !,"You do not have the appropriate key to access this option." S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXEN",9,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) D MSG^PSODPT D EX^PSOERX Q
"RTN","PSOERXEN",10,0)
 D:'$D(PSOPINST) INST^PSOORFI2 I $G(PSOIQUIT) K PSOIQUIT D EX^PSOERX Q
"RTN","PSOERXEN",11,0)
 S PSNPINST=$$GET1^DIQ(59,PSOSITE,101,"I")
"RTN","PSOERXEN",12,0)
 I 'PSNPINST W !,"NPI Institution must be defined to continue." S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXEN",13,0)
 I '($D(PSOPRMPT)) D
"RTN","PSOERXEN",14,0)
 .S DIR(0)="S^PT:PATIENT(Grouped);RX:PRESCRIPTION RECEIVED DATE;E:EXIT"
"RTN","PSOERXEN",15,0)
 .S DIR("B")="PT"
"RTN","PSOERXEN",16,0)
 .S DIR("?")="     PT - Patient Centric View"
"RTN","PSOERXEN",17,0)
 .S DIR("?",1)="     RX - Traditional Holding Queue View"
"RTN","PSOERXEN",18,0)
 .S DIR("A")="Select By: (PT/RX)"
"RTN","PSOERXEN",19,0)
 .D ^DIR K DIR
"RTN","PSOERXEN",20,0)
 .I $G(Y)="RX" D EN^PSOERX Q
"RTN","PSOERXEN",21,0)
 .I $G(Y)="PT" D
"RTN","PSOERXEN",22,0)
 ..S DIR(0)="SO^A:ALL;1:NEW;2:IN PROGRESS;3:WAIT;4:HOLD;5:CCR"
"RTN","PSOERXEN",23,0)
 ..S DIR("L")=""
"RTN","PSOERXEN",24,0)
 ..S DIR("L",1)="     Select By: Status"
"RTN","PSOERXEN",25,0)
 ..S DIR("L",2)=""
"RTN","PSOERXEN",26,0)
 ..S DIR("L",3)="  A     All"
"RTN","PSOERXEN",27,0)
 ..S DIR("L",4)="  1     New"
"RTN","PSOERXEN",28,0)
 ..S DIR("L",5)="  2     In Process"
"RTN","PSOERXEN",29,0)
 ..S DIR("L",6)="  3     Wait"
"RTN","PSOERXEN",30,0)
 ..S DIR("L",7)="  4     Hold"
"RTN","PSOERXEN",31,0)
 ..S DIR("L",8)="  5     CCR"
"RTN","PSOERXEN",32,0)
 ..S DIR("B")="A"
"RTN","PSOERXEN",33,0)
 ..S DIR("?")=" "
"RTN","PSOERXEN",34,0)
 ..S DIR("?",1)="     All - View all patients with actionable prescriptions"
"RTN","PSOERXEN",35,0)
 ..S DIR("?",2)="     New - View patients with prescriptions in the 'NEW' status"
"RTN","PSOERXEN",36,0)
 ..S DIR("?",3)="     In Process - View patients with prescriptions in the 'IN PROCESS' status"
"RTN","PSOERXEN",37,0)
 ..S DIR("?",4)="     Wait - View patients with prescriptions in the 'WAIT' status"
"RTN","PSOERXEN",38,0)
 ..S DIR("?",5)="     Hold - View patients with prescriptions in the 'HOLD' status"
"RTN","PSOERXEN",39,0)
 ..S DIR("?",6)="     CCR - View patients with prescriptions in the 'CCR' status"
"RTN","PSOERXEN",40,0)
 ..D ^DIR K DIR
"RTN","PSOERXEN",41,0)
 ..I Y["^" S CODE=0 Q
"RTN","PSOERXEN",42,0)
 ..S CODE=$S(Y=1:$$PRESOLV^PSOERXA1("N","ERX"),Y=2:$$PRESOLV^PSOERXA1("I","ERX"),Y=3:$$PRESOLV^PSOERXA1("W","ERX"),1:"A")
"RTN","PSOERXEN",43,0)
 ..I Y=4 D
"RTN","PSOERXEN",44,0)
 ...S DIR(0)="SO^S:SINGLE CODE;A:ALL HOLD CODES",DIR("B")="A"
"RTN","PSOERXEN",45,0)
 ...S DIR("?")=" ",DIR("?",1)="  Single code - Allows selection of a single hold code",DIR("?",2)="  All Hold Codes - Selects all available hold codes"
"RTN","PSOERXEN",46,0)
 ...D ^DIR K DIR
"RTN","PSOERXEN",47,0)
 ...I Y=U S CODE=0 Q
"RTN","PSOERXEN",48,0)
 ...I Y="S" S CODE=$P($$ESTAT(),U)
"RTN","PSOERXEN",49,0)
 ...I Y="A" S CODE="AH"
"RTN","PSOERXEN",50,0)
 ..I Y=5 D
"RTN","PSOERXEN",51,0)
 ...S DIR("B")="A",DIR(0)="SO^S:SINGLE CODE;A:ALL CCR CODES"
"RTN","PSOERXEN",52,0)
 ...S DIR("?")=" ",DIR("?",1)="  Single code - Allows selection of a single CCR code",DIR("?",2)="  All CCR Codes - Selects all available CCR codes"
"RTN","PSOERXEN",53,0)
 ...D ^DIR K DIR
"RTN","PSOERXEN",54,0)
 ...I Y=U S CODE=0 Q
"RTN","PSOERXEN",55,0)
 ...I Y="S" S CODE=$P($$ESTAT2("RXN^RXD^RXW^RXF^CAO^CAH^CAP^CAR^CAX^CAF"),U)
"RTN","PSOERXEN",56,0)
 ...I Y="A" S CODE="CCR"
"RTN","PSOERXEN",57,0)
 ..Q:CODE=0
"RTN","PSOERXEN",58,0)
 ..D EN^PSOERXC1(,,CODE)
"RTN","PSOERXEN",59,0)
 .I $G(Y)="E" Q
"RTN","PSOERXEN",60,0)
 D FULL^VALM1
"RTN","PSOERXEN",61,0)
 Q
"RTN","PSOERXEN",62,0)
ESTAT() ;
"RTN","PSOERXEN",63,0)
 ; prompt for erx status
"RTN","PSOERXEN",64,0)
 N Y,DIC,X
"RTN","PSOERXEN",65,0)
 S DIC("A")="Select eRx Status: "
"RTN","PSOERXEN",66,0)
 S DIC=52.45,DIC(0)="AEQ",DIC("S")="I $D(^PS(52.45,""TYPE"",""ERX"",Y)),$E($P(^PS(52.45,Y,0),U))=""H"""
"RTN","PSOERXEN",67,0)
 S DIC("W")="W "" - "",$P($G(^(0)),""^"",2)"
"RTN","PSOERXEN",68,0)
 D ^DIC K DIC
"RTN","PSOERXEN",69,0)
 I X=U!($D(DUOUT)) Q 0
"RTN","PSOERXEN",70,0)
 I Y<1 Q ""
"RTN","PSOERXEN",71,0)
 Q Y
"RTN","PSOERXEN",72,0)
ESTAT2(LST) ;
"RTN","PSOERXEN",73,0)
 N I,DONE,DIC,Y,X,CODE,CARY,CIEN
"RTN","PSOERXEN",74,0)
 S DONE=0
"RTN","PSOERXEN",75,0)
 F I=1:1 D  Q:DONE
"RTN","PSOERXEN",76,0)
 .S CODE=$P(LST,U,I) I CODE="" S DONE=1 Q
"RTN","PSOERXEN",77,0)
 .S CIEN=$$PRESOLV^PSOERXA1(CODE,"ERX")
"RTN","PSOERXEN",78,0)
 .S CARY(CIEN)=""
"RTN","PSOERXEN",79,0)
 S DIC("A")="Select eRx Status: "
"RTN","PSOERXEN",80,0)
 S DIC=52.45,DIC(0)="AEQ",DIC("S")="I $D(^PS(52.45,""TYPE"",""ERX"",Y)),$D(CARY(Y))"
"RTN","PSOERXEN",81,0)
 S DIC("W")="W "" - "",$P($G(^(0)),""^"",2)"
"RTN","PSOERXEN",82,0)
 D ^DIC K DIC
"RTN","PSOERXEN",83,0)
 I X=U!($D(DUOUT)) Q 0
"RTN","PSOERXEN",84,0)
 I Y<1 Q ""
"RTN","PSOERXEN",85,0)
 Q Y
"RTN","PSOERXH1")
0^33^B17222601^B17222601
"RTN","PSOERXH1",1,0)
PSOERXH1 ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERXH1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,527,508**;DEC 1997;Build 295
"RTN","PSOERXH1",3,0)
 ;
"RTN","PSOERXH1",4,0)
 Q
"RTN","PSOERXH1",5,0)
 ; place eRx on Hold
"RTN","PSOERXH1",6,0)
HOLD ;
"RTN","PSOERXH1",7,0)
 N DIE,DA,DR,CURSTAT,CSTATI,LMATCH,LSTAT,SUBFIEN,NEWSTAT,RESP,DIR,RXSTAT,HCOMM
"RTN","PSOERXH1",8,0)
 Q:'$G(PSOIEN)
"RTN","PSOERXH1",9,0)
 D FULL^VALM1
"RTN","PSOERXH1",10,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERXH1",11,0)
 .W !!,"Cannot hold a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERXH1",12,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERXH1",13,0)
 ; check to see if the erx order status is a hold status
"RTN","PSOERXH1",14,0)
 S CSTATI=$$GET1^DIQ(52.49,PSOIEN,1,"I")
"RTN","PSOERXH1",15,0)
 S CURSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E")
"RTN","PSOERXH1",16,0)
 S VALMBCK="R"
"RTN","PSOERXH1",17,0)
 I $E(CURSTAT,1)="H" D  Q
"RTN","PSOERXH1",18,0)
 .S DIR(0)="YO",DIR("B")="NO"
"RTN","PSOERXH1",19,0)
 .S DIR("A",1)="This eRx is already in a 'HOLD' status."
"RTN","PSOERXH1",20,0)
 .S DIR("A")="Would you like to change the hold status and comments?"
"RTN","PSOERXH1",21,0)
 .D ^DIR
"RTN","PSOERXH1",22,0)
 .Q:'Y
"RTN","PSOERXH1",23,0)
 .K DIR
"RTN","PSOERXH1",24,0)
 .S RESP=$$HDIR(1)
"RTN","PSOERXH1",25,0)
 .I 'RESP D  Q
"RTN","PSOERXH1",26,0)
 ..W "Hold Reason required. eRx not placed in a 'Hold' status."
"RTN","PSOERXH1",27,0)
 ..S DIR(0)="E" D ^DIR
"RTN","PSOERXH1",28,0)
 .S DIR(0)="52.4919,1",DIR("A")="Additional Comments (Optional)" D ^DIR K DIR
"RTN","PSOERXH1",29,0)
 .I Y="^" W !,"eRx NOT placed on hold." D ^DIR K DIR Q
"RTN","PSOERXH1",30,0)
 .S HCOMM=$G(Y)
"RTN","PSOERXH1",31,0)
 .S DIE="52.49",DR="1///"_RESP,DA=PSOIEN D ^DIE K DIE
"RTN","PSOERXH1",32,0)
 .S SUBFIEN=$$NSTAT(PSOIEN,RESP,HCOMM)
"RTN","PSOERXH1",33,0)
 .K @VALMAR D INIT^PSOERX1
"RTN","PSOERXH1",34,0)
 K Y
"RTN","PSOERXH1",35,0)
 S RESP=$$HDIR()
"RTN","PSOERXH1",36,0)
 I 'RESP D  Q
"RTN","PSOERXH1",37,0)
 .W "Hold Reason required. eRx not placed in a 'Hold' status."
"RTN","PSOERXH1",38,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERXH1",39,0)
 S DIR(0)="52.4919,1",DIR("A")="Additional Comments (Optional)" D ^DIR K DIR
"RTN","PSOERXH1",40,0)
 I Y="^" Q
"RTN","PSOERXH1",41,0)
 S HCOMM=Y
"RTN","PSOERXH1",42,0)
 S DIE="52.49",DR="1///"_RESP,DA=PSOIEN D ^DIE K DIE
"RTN","PSOERXH1",43,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",.01)=$$NOW^XLFDT()
"RTN","PSOERXH1",44,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",.02)=RESP
"RTN","PSOERXH1",45,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",.03)=$G(DUZ)
"RTN","PSOERXH1",46,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",1)=HCOMM
"RTN","PSOERXH1",47,0)
 D UPDATE^DIE(,"FDA","NEWSTAT","ERR") K FDA
"RTN","PSOERXH1",48,0)
 S SUBFIEN=$O(NEWSTAT(0)) Q:'SUBFIEN
"RTN","PSOERXH1",49,0)
 S SUBFIEN=$G(NEWSTAT(SUBFIEN))
"RTN","PSOERXH1",50,0)
 K @VALMAR D INIT^PSOERX1
"RTN","PSOERXH1",51,0)
 Q
"RTN","PSOERXH1",52,0)
NSTAT(IEN,STAT,COMM) ;
"RTN","PSOERXH1",53,0)
 N SUBFIEN
"RTN","PSOERXH1",54,0)
 S FDA(52.4919,"+1,"_IEN_",",.01)=$$NOW^XLFDT()
"RTN","PSOERXH1",55,0)
 S FDA(52.4919,"+1,"_IEN_",",.02)=STAT
"RTN","PSOERXH1",56,0)
 S FDA(52.4919,"+1,"_IEN_",",.03)=$G(DUZ)
"RTN","PSOERXH1",57,0)
 S FDA(52.4919,"+1,"_IEN_",",1)=COMM
"RTN","PSOERXH1",58,0)
 D UPDATE^DIE(,"FDA","NEWSTAT") K FDA
"RTN","PSOERXH1",59,0)
 S SUBFIEN=$O(NEWSTAT(0)) Q:'SUBFIEN
"RTN","PSOERXH1",60,0)
 S SUBFIEN=$G(NEWSTAT(SUBFIEN))
"RTN","PSOERXH1",61,0)
 Q SUBFIEN
"RTN","PSOERXH1",62,0)
HDIR(HTYP) ; 
"RTN","PSOERXH1",63,0)
 N DIR,DIC,Y,X
"RTN","PSOERXH1",64,0)
 ;S DIC="^PS(52.45,",X(1)="ERX",X(2)="H",DIC(0)="EMQ",D="C" D IX^DIC K DIC,D
"RTN","PSOERXH1",65,0)
 S DIC("A")="Select HOLD reason code: "
"RTN","PSOERXH1",66,0)
 S DIC="^PS(52.45,",DIC(0)="AEMQ",DIC("S")="I $D(^PS(52.45,""TYPE"",""ERX"",Y)),$E($P(^PS(52.45,Y,0),U),1)=""H"""
"RTN","PSOERXH1",67,0)
 D ^DIC K DIC
"RTN","PSOERXH1",68,0)
 I Y<1 Q 0
"RTN","PSOERXH1",69,0)
 Q:'+$P(Y,U) 0
"RTN","PSOERXH1",70,0)
 Q $P(Y,U)
"RTN","PSOERXH1",71,0)
 ; remove hold from eRx
"RTN","PSOERXH1",72,0)
UNHOLD ;
"RTN","PSOERXH1",73,0)
 N Y,DIR,DIE,DA,DR,NEWSIEN,RXSTAT,RXSTATI
"RTN","PSOERXH1",74,0)
 D FULL^VALM1
"RTN","PSOERXH1",75,0)
 S VALMBCK="R"
"RTN","PSOERXH1",76,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERXH1",77,0)
 .W !!,"Cannot un-hold a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERXH1",78,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERXH1",79,0)
 W !
"RTN","PSOERXH1",80,0)
 I $E($$GET1^DIQ(52.49,PSOIEN,1,"E"),1)'="H" D  Q
"RTN","PSOERXH1",81,0)
 .W !,"This eRx is not currently on hold. Please use the 'Hold'",!,"function to update the hold status and comments.",!!
"RTN","PSOERXH1",82,0)
 .S DIR(0)="E"
"RTN","PSOERXH1",83,0)
 .D ^DIR
"RTN","PSOERXH1",84,0)
 .K @VALMAR D INIT^PSOERX1
"RTN","PSOERXH1",85,0)
 ;/BLB/ PSO*7.0*527 - BEGIN CHANGE - CHECKING FOR THE WAIT STATUS UPON UNHOLDING AN ERX
"RTN","PSOERXH1",86,0)
 I $$GET1^DIQ(52.49,PSOIEN,1.3,"I"),$$GET1^DIQ(52.49,PSOIEN,1.5,"I"),$$GET1^DIQ(52.49,PSOIEN,1.7,"I") D
"RTN","PSOERXH1",87,0)
 .S RXSTATI=$$PRESOLV^PSOERXA1("W","ERX"),RXSTAT=$$GET1^DIQ(52.45,RXSTATI,.01,"E")
"RTN","PSOERXH1",88,0)
 I '$G(RXSTATI) S RXSTATI=$$PRESOLV^PSOERXA1("I","ERX"),RXSTAT=$$GET1^DIQ(52.45,RXSTATI,.01,"E")
"RTN","PSOERXH1",89,0)
 D UPDSTAT^PSOERXU1(PSOIEN,RXSTAT,"HOLD REMOVED BY "_$$NAME^XUSER(DUZ))
"RTN","PSOERXH1",90,0)
 W !,"eRx removed from hold status, and placed to '"_$$SENTENCE^XLFSTR($$GET1^DIQ(52.45,RXSTATI,.02,"E"))_"'."
"RTN","PSOERXH1",91,0)
 ;/BLB/ PSO*7.0*527 - END CHANGE
"RTN","PSOERXH1",92,0)
 S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXH1",93,0)
 K @VALMAR D INIT^PSOERX1
"RTN","PSOERXH1",94,0)
 Q
"RTN","PSOERXO1")
0^17^B115835250^B64732722
"RTN","PSOERXO1",1,0)
PSOERXO1 ;ALB/BWF - eRx Outbound Error messages ; 8/3/2016 5:14pm
"RTN","PSOERXO1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,508**;DEC 1997;Build 295
"RTN","PSOERXO1",3,0)
 ;
"RTN","PSOERXO1",4,0)
 Q
"RTN","PSOERXO1",5,0)
 ;
"RTN","PSOERXO1",6,0)
MSGERR() ;check errors from XML return
"RTN","PSOERXO1",7,0)
 ; note - not currently in use
"RTN","PSOERXO1",8,0)
 ;returns empty string "" if there was no error
"RTN","PSOERXO1",9,0)
 ;returns empty string "" if the only error was "ALL_PATIENT_IDS_EXCLUDED"
"RTN","PSOERXO1",10,0)
 ;otherwise returns the exceptionMessage string from the errorSection
"RTN","PSOERXO1",11,0)
 N ORRET S ORRET=""
"RTN","PSOERXO1",12,0)
 I $D(^TMP($J,"ORRDI","ClinicalData",0,"errorSection")) D
"RTN","PSOERXO1",13,0)
 .N I F I="fatalErrors","errors","warnings" D
"RTN","PSOERXO1",14,0)
 ..N J S J="" F  S J=$O(^TMP($J,"ORRDI","ClinicalData",0,"errorSection",0,I,J)) Q:J=""  D
"RTN","PSOERXO1",15,0)
 ...N ORSTR S ORSTR=$G(^TMP($J,"ORRDI","ClinicalData",0,"errorSection",0,I,J,"errorCode",0))
"RTN","PSOERXO1",16,0)
 ...I ORSTR'="ALL_PATIENT_IDS_EXCLUDED" S ORRET=ORSTR
"RTN","PSOERXO1",17,0)
 Q ORRET
"RTN","PSOERXO1",18,0)
ERRHNDL(DFN) ;handle any errors that may get thrown in call to GET^ORRDI1
"RTN","PSOERXO1",19,0)
 K ^TMP($J,"ORRDI"),^XTMP("ORRDI","PSOO",DFN),^XTMP("ORRDI","ART",DFN)
"RTN","PSOERXO1",20,0)
 D UNWIND^%ZTER
"RTN","PSOERXO1",21,0)
 Q
"RTN","PSOERXO1",22,0)
 ; RXVERIFY - if this is set to 1, then this is an rxVerify message.
"RTN","PSOERXO1",23,0)
 ;          - 0 or null, this is an error message
"RTN","PSOERXO1",24,0)
 ;          - 2 cancel request/response
"RTN","PSOERXO1",25,0)
 ; OVRESP - override response if the response was built elsewhere
"RTN","PSOERXO1",26,0)
POST(ERXIEN,PSSOUT,ECODE,DESCODE,DESC,RXVERIFY,INST,OVRESP) ;
"RTN","PSOERXO1",27,0)
 N PSS,PSSERR,PSSFDBRT,PSREQ,GBL,C,PON,RXREFN,VAR,NEWRXIEN,FFILL,TOTREFL,REFL
"RTN","PSOERXO1",28,0)
 N TOQUAL,FRQUAL,TO,FROM,MID,RTMID,ERXIENS,F,PSODAT,RXIEN,LDDATE,NERXIEN,ERRSEQ
"RTN","PSOERXO1",29,0)
 S F=52.49,C=0
"RTN","PSOERXO1",30,0)
 S PSSFDBRT=1
"RTN","PSOERXO1",31,0)
 S INST=$G(INST,"")
"RTN","PSOERXO1",32,0)
 S GBL=$NA(^TMP("POST^PSOERXO1",$J)) K @GBL
"RTN","PSOERXO1",33,0)
 Q:'$G(ERXIEN)
"RTN","PSOERXO1",34,0)
 S ERXIENS=ERXIEN_","
"RTN","PSOERXO1",35,0)
 S NEWRXIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXO1",36,0)
 ;I NEWRXIEN S RXIEN=$$GET1^DIQ(52.49,NEWRXIEN,.13,"E")
"RTN","PSOERXO1",37,0)
 D GETS^DIQ(F,ERXIENS,".01;.02;.09;.1;.13;22.1:22.4;24.1;25","IE","PSODAT")
"RTN","PSOERXO1",38,0)
 I 'INST S INST=$G(PSODAT(F,ERXIENS,24.1,"I")) I 'INST S PSSOUT(0)=-1_U_"Unable to identify institution. Cannot send message." Q
"RTN","PSOERXO1",39,0)
 ; message ID needs to be unique from vista - Site#.DUZ.erxIEN.date.time??
"RTN","PSOERXO1",40,0)
 S MID=INST_"."_DUZ_"."_ERXIEN_"."_$$NOW^XLFDT
"RTN","PSOERXO1",41,0)
 ; relates to message ID is the incoming message id from CH for outbound messages.
"RTN","PSOERXO1",42,0)
 S RTMID=$G(PSODAT(F,ERXIENS,25,"E"))
"RTN","PSOERXO1",43,0)
 ; from is TO from the erx.
"RTN","PSOERXO1",44,0)
 S FROM=$G(PSODAT(F,ERXIENS,22.3,"E"))
"RTN","PSOERXO1",45,0)
 S FRQUAL=$G(PSODAT(F,ERXIENS,22.4,"I"))
"RTN","PSOERXO1",46,0)
 ; to is FROM from the erx
"RTN","PSOERXO1",47,0)
 S TO=$G(PSODAT(F,ERXIENS,22.1,"E"))
"RTN","PSOERXO1",48,0)
 S TOQUAL=$G(PSODAT(F,ERXIENS,22.2,"I"))
"RTN","PSOERXO1",49,0)
 ; /BLB/ - BEGIN CHANGE PSO*7*520 - adding prescriber order number and rxReferencenumber (.01 in the case of verify and error)
"RTN","PSOERXO1",50,0)
 S PON=$G(PSODAT(F,ERXIENS,.09,"E"))
"RTN","PSOERXO1",51,0)
 S RXREFN=$G(PSODAT(F,ERXIENS,.01,"E"))
"RTN","PSOERXO1",52,0)
 ; encode XML sensitive characters
"RTN","PSOERXO1",53,0)
 F VAR="TOQUAL","TO","FRQUAL","FROM","RTMID","RXREFN","PON","MID","ECODE","DESCODE","DESC" D
"RTN","PSOERXO1",54,0)
 .S @VAR=$$SYMENC^MXMLUTL($G(@VAR))
"RTN","PSOERXO1",55,0)
 D C S @GBL@(C,0)="<?xml version = '1.0' encoding = 'UTF-8'?><Message version=""010"" release=""006"" xmlns=""http://www.ncpdp.org/schema/SCRIPT"">"
"RTN","PSOERXO1",56,0)
 D C S @GBL@(C,0)="<Header><To Qualifier="""_TOQUAL_""">"_TO_"</To><From Qualifier="""_FRQUAL_""">"_FROM_"</From><MessageID>"_MID_"</MessageID>"
"RTN","PSOERXO1",57,0)
 D C S @GBL@(C,0)="<RelatesToMessageID>"_RTMID_"</RelatesToMessageID><SentTime>"_$$EXTIME()_"</SentTime>"
"RTN","PSOERXO1",58,0)
 I $L(RXREFN) D C S @GBL@(C,0)="<RxReferenceNumber>"_RXREFN_"</RxReferenceNumber>"
"RTN","PSOERXO1",59,0)
 I $L(PON) D C S @GBL@(C,0)="<PrescriberOrderNumber>"_PON_"</PrescriberOrderNumber>"
"RTN","PSOERXO1",60,0)
 D C S @GBL@(C,0)="</Header>"
"RTN","PSOERXO1",61,0)
 ; PSO*7*520 - /BLB/ - END CHANGE add handling of rxVerify Messages
"RTN","PSOERXO1",62,0)
 ; rxVerify
"RTN","PSOERXO1",63,0)
 I $G(RXVERIFY)=1 D  Q
"RTN","PSOERXO1",64,0)
 .D C S @GBL@(C,0)="<Body><Verify><VerifyStatus><Code>010</Code><Description>Accepted By Pharmacy.</Description></VerifyStatus></Verify></Body></Message>"
"RTN","PSOERXO1",65,0)
 .D RESTPOST(.PSSOUT,.GBL)
"RTN","PSOERXO1",66,0)
 .K @GBL,C
"RTN","PSOERXO1",67,0)
 ; PSO*7*520 - end
"RTN","PSOERXO1",68,0)
 ; cancel response - denied type
"RTN","PSOERXO1",69,0)
 I $G(RXVERIFY)>1 D  Q
"RTN","PSOERXO1",70,0)
 .N RESPONSE,RESTYP,RESTAG
"RTN","PSOERXO1",71,0)
 .S RESPONSE=$S(RXVERIFY=2:"Rx not canceled - Rx not found in pharmacy system.",RXVERIFY=3:"Rx was never dispensed. Canceled at Pharmacy",1:"Response Unknown")
"RTN","PSOERXO1",72,0)
 .I $D(OVRESP) S RESPONSE=OVRESP
"RTN","PSOERXO1",73,0)
 .I $D(RXIEN),'$D(OVRESP) D
"RTN","PSOERXO1",74,0)
 ..S FFILL=$$GET1^DIQ(52,RXIEN,22,"I") I FFILL]"" S FFILL=$$FMTE^XLFDT(FFILL,"2D")
"RTN","PSOERXO1",75,0)
 ..S TOTREFL=$$GET1^DIQ(52,RXIEN,9,"I")
"RTN","PSOERXO1",76,0)
 ..S REFL=TOTREFL,I=0 F  S I=$O(^PSRX(RXIEN,1,I)) Q:'I  S REFL=REFL-1
"RTN","PSOERXO1",77,0)
 ..S LDDATE=$$GET1^DIQ(52,RXIEN,101,"I") I LDDATE]"" S LDDATE=$$FMTE^XLFDT(LDDATE,"2D")
"RTN","PSOERXO1",78,0)
 ..S RESPONSE="First Fill:"_FFILL_", Last fill:"_LDDATE_", Refills remaining:"_REFL
"RTN","PSOERXO1",79,0)
 .S RESTYP=$S(RXVERIFY=2:"D",RXVERIFY=3:"A",1:"")
"RTN","PSOERXO1",80,0)
 .S RESTAG=$S(RXVERIFY=2:"Denied",RXVERIFY=3:"Approved",1:"") Q:RESTAG=""
"RTN","PSOERXO1",81,0)
 .D C S @GBL@(C,0)="<Body><CancelRxResponse><Response><"_RESTAG_">"
"RTN","PSOERXO1",82,0)
 .I RESTYP="D" D C S @GBL@(C,0)="<DenialReason>"_RESPONSE_"</DenialReason>"
"RTN","PSOERXO1",83,0)
 .I RESTYP="A" D C S @GBL@(C,0)="<Note>"_RESPONSE_"</Note>"
"RTN","PSOERXO1",84,0)
 .D C S @GBL@(C,0)="</"_RESTAG_"></Response></CancelRxResponse></Body></Message>"
"RTN","PSOERXO1",85,0)
 .D RESTPOST(.PSSOUT,.GBL)
"RTN","PSOERXO1",86,0)
 .; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERXO1",87,0)
 .I $P(PSSOUT(0),U)<1 S PSSOUT("errorMessage")=$P(PSSOUT(0),U,2)
"RTN","PSOERXO1",88,0)
 .S HUBID=$G(PSSOUT("outboundMsgId")) I 'HUBID S PSSOUT("errorMessage")="The eRx Processing hub did not return a Hub identification number."
"RTN","PSOERXO1",89,0)
 .I $D(PSSOUT("errorMessage")) D  Q
"RTN","PSOERXO1",90,0)
 ..D UPDSTAT^PSOERXU1(ERXIEN,"CAX")
"RTN","PSOERXO1",91,0)
 ..S ERRSEQ=$$ERRSEQ^PSOERXU1(ERXIEN) Q:'ERRSEQ
"RTN","PSOERXO1",92,0)
 ..D FILERR^PSOERXU1(ERXIENS,ERRSEQ,"PX","V",$G(PSSOUT("errorMessage")))
"RTN","PSOERXO1",93,0)
 .; vista generated message will be V12345 (V concatenated to the hubId)
"RTN","PSOERXO1",94,0)
 .S HUBID="V"_HUBID
"RTN","PSOERXO1",95,0)
 .;file the cancel response in the holding queue.
"RTN","PSOERXO1",96,0)
 .D CMFILE(HUBID,MID,RTMID,TOQUAL,TO,FRQUAL,FROM,RXREFN,PON,RESPONSE,RESTYP,"CN",INST)
"RTN","PSOERXO1",97,0)
 .K @GBL,C
"RTN","PSOERXO1",98,0)
 ; outbound error
"RTN","PSOERXO1",99,0)
 D C S @GBL@(C,0)="<Body><Error><Code>"_$G(ECODE)_"</Code>"
"RTN","PSOERXO1",100,0)
 I $L(DESCODE) D C S @GBL@(C,0)="<DescriptionCode>"_$G(DESCODE)_"</DescriptionCode>"
"RTN","PSOERXO1",101,0)
 D C S @GBL@(C,0)="<Description>"_$G(DESC)_"</Description>"
"RTN","PSOERXO1",102,0)
 D C S @GBL@(C,0)="</Error></Body></Message>"
"RTN","PSOERXO1",103,0)
 D RESTPOST(.PSSOUT,.GBL)
"RTN","PSOERXO1",104,0)
 K @GBL,C
"RTN","PSOERXO1",105,0)
 Q
"RTN","PSOERXO1",106,0)
C ;
"RTN","PSOERXO1",107,0)
 S C=C+1
"RTN","PSOERXO1",108,0)
 Q
"RTN","PSOERXO1",109,0)
RESTPOST(PSSOUT,GBL) ;
"RTN","PSOERXO1",110,0)
 N $ETRAP,$ESTACK,PSREQ
"RTN","PSOERXO1",111,0)
 N PSREQ,PSS,PSSERR,GLOOP,GDAT
"RTN","PSOERXO1",112,0)
 ; Set error trap
"RTN","PSOERXO1",113,0)
 SET $ETRAP="DO ERROR^PSSHTTP"
"RTN","PSOERXO1",114,0)
 K ^TMP($J,"OUT")    ; if exists from previous runs, posting would not execute.
"RTN","PSOERXO1",115,0)
 SET PSS("server")="PSO WEB SERVER"
"RTN","PSOERXO1",116,0)
 SET PSS("webserviceName")="PSO ERX WEB SERVICE"
"RTN","PSOERXO1",117,0)
 SET PSS("path")="services/rest/vistaoutboundMsg/processXMLMessage"
"RTN","PSOERXO1",118,0)
 SET PSS("parameterName")="xmlRequest"
"RTN","PSOERXO1",119,0)
 ;SET PSS("parameterValue")=PSREQ
"RTN","PSOERXO1",120,0)
 ;
"RTN","PSOERXO1",121,0)
 ; get instance of client REST request object
"RTN","PSOERXO1",122,0)
 SET PSS("restObject")=$$GETREST^XOBWLIB(PSS("webserviceName"),PSS("server"))
"RTN","PSOERXO1",123,0)
 IF $DATA(^TMP($JOB,"OUT","EXCEPTION"))>0 S PSSOUT(0)="-1^"_^TMP($JOB,"OUT","EXCEPTION") K ^TMP($JOB,"OUT","EXCEPTION") Q PSSOUT
"RTN","PSOERXO1",124,0)
 ;
"RTN","PSOERXO1",125,0)
 ; insert XML as parameter
"RTN","PSOERXO1",126,0)
 ;DO PSS("restObject").InsertFormData(PSS("parameterName"),PSS("parameterValue"))
"RTN","PSOERXO1",127,0)
 S PSS("restObject").ContentType="application/xml"
"RTN","PSOERXO1",128,0)
 S GLOOP=0 F  S GLOOP=$O(@GBL@(GLOOP)) Q:'GLOOP  D
"RTN","PSOERXO1",129,0)
 .S GDAT=$G(@GBL@(GLOOP,0))
"RTN","PSOERXO1",130,0)
 .;SET PSS("parameterValue")=$G(PSS("parameterValue"))_$G(@GBL@(GLOOP,0))
"RTN","PSOERXO1",131,0)
 .DO PSS("restObject").EntityBody.Write(GDAT)
"RTN","PSOERXO1",132,0)
 ;DO PSS("restObject").InsertFormData(PSS("parameterName"),PSS("parameterValue"))
"RTN","PSOERXO1",133,0)
 IF $DATA(^TMP($JOB,"OUT","EXCEPTION"))>0 S PSSOUT(0)="-1^"_^TMP($JOB,"OUT","EXCEPTION") K ^TMP($JOB,"OUT","EXCEPTION") QUIT PSSOUT
"RTN","PSOERXO1",134,0)
 ;
"RTN","PSOERXO1",135,0)
 ; execute HTTP Post method
"RTN","PSOERXO1",136,0)
 SET PSS("postResult")=$$POST^XOBWLIB(PSS("restObject"),PSS("path"),.PSSERR)
"RTN","PSOERXO1",137,0)
 IF $DATA(^TMP($JOB,"OUT","EXCEPTION"))>0 S PSSOUT(0)="-1^"_^TMP($JOB,"OUT","EXCEPTION") K ^TMP($JOB,"OUT","EXCEPTION") QUIT PSSOUT
"RTN","PSOERXO1",138,0)
 ;
"RTN","PSOERXO1",139,0)
 ; response coming back
"RTN","PSOERXO1",140,0)
 ;<vistaOutboundResponse><success>true</success></vistaOutboundResponse>
"RTN","PSOERXO1",141,0)
 ; error handling
"RTN","PSOERXO1",142,0)
 DO:'PSS("postResult")
"RTN","PSOERXO1",143,0)
 . SET PSSOUT(0)=-1_U_"Unable to make http request."
"RTN","PSOERXO1",144,0)
 . SET PSS("result")=0
"RTN","PSOERXO1",145,0)
 . QUIT
"RTN","PSOERXO1",146,0)
 ;
"RTN","PSOERXO1",147,0)
 ; if everything is ok parse the returned xml result
"RTN","PSOERXO1",148,0)
 I PSS("postResult") S PSS("result")=1 D PRSSTRM(PSS("restObject"),.PSSOUT) S PSSOUT(0)=1
"RTN","PSOERXO1",149,0)
 ; for now we do not pass back the message ID for storage into 52.49
"RTN","PSOERXO1",150,0)
 Q PSS("result")
"RTN","PSOERXO1",151,0)
 ;
"RTN","PSOERXO1",152,0)
PRSSTRM(RESTOBJ,PSSOUT) ;  parse the XML into token
"RTN","PSOERXO1",153,0)
 ;  input: RESTOBJ--a rest object
"RTN","PSOERXO1",154,0)
 ; output: PSSOUT - array containing the list of route names for the given drug.
"RTN","PSOERXO1",155,0)
 ;
"RTN","PSOERXO1",156,0)
 ; parse the XML into tokens. the first part of the token is the type of node being read.
"RTN","PSOERXO1",157,0)
 ; the second part is the data--either the name of the node, or data. these fields are delimited using "<>".
"RTN","PSOERXO1",158,0)
 ; if the node is type attribute, each attribute is separated by a caret ("^").
"RTN","PSOERXO1",159,0)
 ;
"RTN","PSOERXO1",160,0)
 N AREADER
"RTN","PSOERXO1",161,0)
 S AREADER=$$GETREADR(RESTOBJ)
"RTN","PSOERXO1",162,0)
 D PARSXML(AREADER,.PSSOUT)
"RTN","PSOERXO1",163,0)
 Q
"RTN","PSOERXO1",164,0)
 ;
"RTN","PSOERXO1",165,0)
PARSXML(AREADER,PSSOUT) ; extract the list of routes from XML results
"RTN","PSOERXO1",166,0)
 ;  input: AREADER-%XML.TextReader object.
"RTN","PSOERXO1",167,0)
 ; output: PSSOUT - array containing the list of route names for the given drug.
"RTN","PSOERXO1",168,0)
 ;
"RTN","PSOERXO1",169,0)
 N ATOKEN,NODETYPE
"RTN","PSOERXO1",170,0)
 F  D  Q:AREADER.EOF
"RTN","PSOERXO1",171,0)
 .S ATOKEN=$$GETTOKEN(AREADER)
"RTN","PSOERXO1",172,0)
 .I '$L(ATOKEN) Q
"RTN","PSOERXO1",173,0)
 .S NODETYPE=$P(ATOKEN,"<>"),ATOKEN=$P(ATOKEN,"<>",2)
"RTN","PSOERXO1",174,0)
 .I ATOKEN="errorMessage" D POSTERR(AREADER,.PSSOUT)
"RTN","PSOERXO1",175,0)
 .I ATOKEN="success" D POSTRES(AREADER,.PSSOUT,ATOKEN)
"RTN","PSOERXO1",176,0)
 .I ATOKEN="outboundMsgId" D POSTRES(AREADER,.PSSOUT,ATOKEN)
"RTN","PSOERXO1",177,0)
 Q
"RTN","PSOERXO1",178,0)
 ;
"RTN","PSOERXO1",179,0)
POSTRES(AREADER,PSSOUT,ATOKEN) ; get value of success/failure
"RTN","PSOERXO1",180,0)
 N TOKEN,TYPE,QPARAM
"RTN","PSOERXO1",181,0)
 S QPARAM="/"_ATOKEN
"RTN","PSOERXO1",182,0)
 F  D  Q:TOKEN=QPARAM
"RTN","PSOERXO1",183,0)
 .S TOKEN=$$GETTOKEN(AREADER)
"RTN","PSOERXO1",184,0)
 .S TYPE=$P(TOKEN,"<>"),TOKEN=$P(TOKEN,"<>",2)
"RTN","PSOERXO1",185,0)
 .Q:'$L(TOKEN)!(TOKEN=QPARAM)
"RTN","PSOERXO1",186,0)
 .S PSSOUT(ATOKEN)=TOKEN
"RTN","PSOERXO1",187,0)
 Q
"RTN","PSOERXO1",188,0)
POSTERR(AREADER,PSSOUT) ; get error message
"RTN","PSOERXO1",189,0)
 N TOKEN,TYPE
"RTN","PSOERXO1",190,0)
 F  D  Q:TOKEN="/errorMessage"
"RTN","PSOERXO1",191,0)
 .S TOKEN=$$GETTOKEN(AREADER)
"RTN","PSOERXO1",192,0)
 .S TYPE=$P(TOKEN,"<>"),TOKEN=$P(TOKEN,"<>",2)
"RTN","PSOERXO1",193,0)
 .Q:'$L(TOKEN)!(TOKEN="/errorMessage")
"RTN","PSOERXO1",194,0)
 .S PSSOUT("errorMessage")=$TR(TOKEN,$C(10)," ")
"RTN","PSOERXO1",195,0)
 Q
"RTN","PSOERXO1",196,0)
 ;
"RTN","PSOERXO1",197,0)
GETREADR(RESTOBJ) ; set up and return a Textreader object to be used to parse the XML stream
"RTN","PSOERXO1",198,0)
 ;  input: RESTOBJ-  REST object
"RTN","PSOERXO1",199,0)
 ; output: returns a %XML.TextReader object.
"RTN","PSOERXO1",200,0)
 ;
"RTN","PSOERXO1",201,0)
 N AREADER
"RTN","PSOERXO1",202,0)
 S AREADER=##class(%XML.TextReader).%New("%XML.TextReader")
"RTN","PSOERXO1",203,0)
 D ##class(%XML.TextReader).ParseStream(RESTOBJ.HttpResponse.Data,.AREADER)
"RTN","PSOERXO1",204,0)
 Q AREADER
"RTN","PSOERXO1",205,0)
 ;
"RTN","PSOERXO1",206,0)
GETTOKEN(READER) ; get a token at a time
"RTN","PSOERXO1",207,0)
 ;  input: AREADER-%XML.TextReader object
"RTN","PSOERXO1",208,0)
 ; Output: returns a token
"RTN","PSOERXO1",209,0)
 ;
"RTN","PSOERXO1",210,0)
 ;   this is the key to the parsing of the XML stream.
"RTN","PSOERXO1",211,0)
 ;   each element is parsed with its associated data (if any)
"RTN","PSOERXO1",212,0)
 ;   the nodetype is concatenated with "<>" with the Token
"RTN","PSOERXO1",213,0)
 ;   which can be the tag or the data.
"RTN","PSOERXO1",214,0)
 ;   for example each time is called return one of the following:
"RTN","PSOERXO1",215,0)
 ;     . . .
"RTN","PSOERXO1",216,0)
 ;     . . .
"RTN","PSOERXO1",217,0)
 ;     drug(attributes)<>gcnSeqNo=17240
"RTN","PSOERXO1",218,0)
 ;     element<>routes
"RTN","PSOERXO1",219,0)
 ;     element<>route
"RTN","PSOERXO1",220,0)
 ;     element<>id
"RTN","PSOERXO1",221,0)
 ;     chars<>006
"RTN","PSOERXO1",222,0)
 ;     endelement<>/id
"RTN","PSOERXO1",223,0)
 ;     element<>name
"RTN","PSOERXO1",224,0)
 ;     chars<>CONTINUOUS INFUSION
"RTN","PSOERXO1",225,0)
 ;     endelement<>/name
"RTN","PSOERXO1",226,0)
 ;     endelement<>/route
"RTN","PSOERXO1",227,0)
 ;     . . .
"RTN","PSOERXO1",228,0)
 ;     . . .
"RTN","PSOERXO1",229,0)
 ;
"RTN","PSOERXO1",230,0)
 N TOKEN,NODETYPE,SUBTOKEN,ALLTOKEN
"RTN","PSOERXO1",231,0)
 S TOKEN="",SUBTOKEN="",NODETYPE="",ALLTOKEN=""
"RTN","PSOERXO1",232,0)
 D
"RTN","PSOERXO1",233,0)
 .Q:READER.EOF
"RTN","PSOERXO1",234,0)
 .D READER.Read()  ; go to first node
"RTN","PSOERXO1",235,0)
 .Q:READER.EOF     ; try before and after read
"RTN","PSOERXO1",236,0)
 .I READER.HasAttributes D
"RTN","PSOERXO1",237,0)
 ..S NODETYPE=READER.Name_"(attributes)"
"RTN","PSOERXO1",238,0)
 ..S TOKEN=$$GETATTS(READER)
"RTN","PSOERXO1",239,0)
 .I '$L(TOKEN) S NODETYPE=READER.NodeTypeGet() D
"RTN","PSOERXO1",240,0)
 ..I NODETYPE="element" S TOKEN=READER.Name Q
"RTN","PSOERXO1",241,0)
 ..I NODETYPE="chars" S TOKEN=READER.Value Q
"RTN","PSOERXO1",242,0)
 ..I NODETYPE="endelement" S TOKEN="/"_READER.Name Q
"RTN","PSOERXO1",243,0)
 ..I NODETYPE="comment" S TOKEN="^"
"RTN","PSOERXO1",244,0)
 ..I NODETYPE="processinginstruction" S TOKEN=READER.Value Q
"RTN","PSOERXO1",245,0)
 ..I NODETYPE="ignorablewhitespace" S TOKEN="^" Q
"RTN","PSOERXO1",246,0)
 ..I NODETYPE="startprefixmapping" S TOKEN=READER.Value Q
"RTN","PSOERXO1",247,0)
 ..I NODETYPE="warning" S TOKEN=READER.Value Q
"RTN","PSOERXO1",248,0)
 ..I '$L(TOKEN) S TOKEN="^"
"RTN","PSOERXO1",249,0)
 ..;
"RTN","PSOERXO1",250,0)
 .I $L(NODETYPE) S ALLTOKEN=NODETYPE_"<>"_TOKEN
"RTN","PSOERXO1",251,0)
 Q ALLTOKEN
"RTN","PSOERXO1",252,0)
 ;
"RTN","PSOERXO1",253,0)
GETATTS(AREADER) ; get attributes
"RTN","PSOERXO1",254,0)
 ;  input: AREADER-%XML.TextReader object
"RTN","PSOERXO1",255,0)
 ; Output: returns the attributes
"RTN","PSOERXO1",256,0)
 ;
"RTN","PSOERXO1",257,0)
 N I,INDEX,TOKEN,SUBTOKEN,ATTRB
"RTN","PSOERXO1",258,0)
 S (TOKEN,SUBTOKEN)=""
"RTN","PSOERXO1",259,0)
 S INDEX=AREADER.AttributeCountGet()
"RTN","PSOERXO1",260,0)
 FOR I=1:1:INDEX D
"RTN","PSOERXO1",261,0)
 .S ATTRB=AREADER.MoveToAttributeIndex(I) D
"RTN","PSOERXO1",262,0)
 .S SUBTOKEN=AREADER.Name_"="_AREADER.Value
"RTN","PSOERXO1",263,0)
 .I '$L(TOKEN) S TOKEN=SUBTOKEN Q
"RTN","PSOERXO1",264,0)
 .S TOKEN=TOKEN_"^"_SUBTOKEN
"RTN","PSOERXO1",265,0)
 Q TOKEN
"RTN","PSOERXO1",266,0)
EXTIME(IDTTM) ;
"RTN","PSOERXO1",267,0)
 N YY,MM,DD,TIME,EXDT,TLEN,I,TZONE,DTTM
"RTN","PSOERXO1",268,0)
 S IDTTM=$G(IDTTM,"")
"RTN","PSOERXO1",269,0)
 S DTTM=$S($L(IDTTM):$$FMTHL7^XLFDT(IDTTM),1:$$FMTHL7^XLFDT($$NOW^XLFDT()))
"RTN","PSOERXO1",270,0)
 S TZONE=$P(DTTM,"-",2)
"RTN","PSOERXO1",271,0)
 I 'TZONE S TZONE=$P($$FMTHL7^XLFDT($$NOW^XLFDT()),"-",2)
"RTN","PSOERXO1",272,0)
 S DTTM=$P(DTTM,"-"),TZONE=$E(TZONE,1,2)_":"_$E(TZONE,3,4)
"RTN","PSOERXO1",273,0)
 S YY=$E(DTTM,1,4),MM=$E(DTTM,5,6),DD=$E(DTTM,7,8),TIME=$E(DTTM,9,$L(DTTM))
"RTN","PSOERXO1",274,0)
 I $L(TIME)<6 D
"RTN","PSOERXO1",275,0)
 .S TLEN=$L(TIME)
"RTN","PSOERXO1",276,0)
 .F I=TLEN:1:6 D
"RTN","PSOERXO1",277,0)
 ..S TIME=TIME_0
"RTN","PSOERXO1",278,0)
 ; now construct the date
"RTN","PSOERXO1",279,0)
 S EXDT=YY_"-"_MM_"-"_DD_"T"_$E(TIME,1,2)_":"_$E(TIME,3,4)_":"_$E(TIME,5,6)_$S($L(TZONE):"-"_TZONE,1:"")
"RTN","PSOERXO1",280,0)
 Q EXDT
"RTN","PSOERXO1",281,0)
 ;
"RTN","PSOERXO1",282,0)
 ; HUBID - hub identification number returned upon successful transmission
"RTN","PSOERXO1",283,0)
 ; MID - message id
"RTN","PSOERXO1",284,0)
 ; RTMID - relates to message ID
"RTN","PSOERXO1",285,0)
 ; TOQUAL - to qualifier
"RTN","PSOERXO1",286,0)
 ; TO - to value (the 'from' value from the original message)
"RTN","PSOERXO1",287,0)
 ; FRQUAL - from qualifier
"RTN","PSOERXO1",288,0)
 ; FROM - who the message was from the 'to' value from the original message
"RTN","PSOERXO1",289,0)
 ; RXREFN - rx reference number
"RTN","PSOERXO1",290,0)
 ; PON - prescriber order number
"RTN","PSOERXO1",291,0)
 ; RESPONSE - response text in the response XML
"RTN","PSOERXO1",292,0)
 ; RESTYPE - 'A' = approved, 'D' = denied
"RTN","PSOERXO1",293,0)
 ; RELIEN - related message ien
"RTN","PSOERXO1",294,0)
 ; RESTAT - response status
"RTN","PSOERXO1",295,0)
 ; MTYPE - CANCEL REQUEST/CANCEL RESPONSE
"RTN","PSOERXO1",296,0)
CMFILE(HUBID,MID,RTMID,TOQUAL,TO,FRQUAL,FROM,RXREFN,PON,RESPONSE,RESTYPE,MTYPE,INST) ;
"RTN","PSOERXO1",297,0)
 N FDA,F,NRXIEN,CREQ,NEWRX
"RTN","PSOERXO1",298,0)
 S F=52.49
"RTN","PSOERXO1",299,0)
 ; if there is no related message id, use the division passed by the hub for the cancelRx
"RTN","PSOERXO1",300,0)
 S FDA(F,"+1,",.01)=HUBID
"RTN","PSOERXO1",301,0)
 S FDA(F,"+1,",.02)=RTMID
"RTN","PSOERXO1",302,0)
 S FDA(F,"+1,",.03)=$$NOW^XLFDT
"RTN","PSOERXO1",303,0)
 S FDA(F,"+1,",.06)=$G(INST)
"RTN","PSOERXO1",304,0)
 S FDA(F,"+1,",.08)=MTYPE
"RTN","PSOERXO1",305,0)
 S FDA(F,"+1,",1)=$$PRESOLV^PSOERXA1("CNP","ERX")
"RTN","PSOERXO1",306,0)
 S FDA(F,"+1,",.14)=$G(RXREFN)
"RTN","PSOERXO1",307,0)
 S FDA(F,"+1,",22.1)=FROM
"RTN","PSOERXO1",308,0)
 S FDA(F,"+1,",22.2)=FRQUAL
"RTN","PSOERXO1",309,0)
 S FDA(F,"+1,",22.3)=TO
"RTN","PSOERXO1",310,0)
 S FDA(F,"+1,",22.4)=TOQUAL
"RTN","PSOERXO1",311,0)
 S FDA(F,"+1,",24.1)=$G(INST)
"RTN","PSOERXO1",312,0)
 S FDA(F,"+1,",25)=MID
"RTN","PSOERXO1",313,0)
 S FDA(F,"+1,",51.1)=$G(DUZ)
"RTN","PSOERXO1",314,0)
 S FDA(F,"+1,",52.1)=RESTYPE
"RTN","PSOERXO1",315,0)
 S FDA(F,"+1,",52.2)=RESPONSE
"RTN","PSOERXO1",316,0)
 D UPDATE^DIE(,"FDA","NRXIEN","ERR") K FDA
"RTN","PSOERXO1",317,0)
 S NERXIEN=$O(NRXIEN(0)),NERXIEN=$G(NRXIEN(NERXIEN)) Q:'NERXIEN
"RTN","PSOERXO1",318,0)
 S CREQ=$$GETREQ^PSOERXU2(NERXIEN)
"RTN","PSOERXO1",319,0)
 S NEWRX=$$FINDNRX^PSOERXU6(CREQ)
"RTN","PSOERXO1",320,0)
 ; If there is no new Rx, link this to the cancel request
"RTN","PSOERXO1",321,0)
 I 'NEWRX S NEWRX=CREQ
"RTN","PSOERXO1",322,0)
 ; link both records
"RTN","PSOERXO1",323,0)
 I '$D(^PS(52.49,NEWRX,201,"B",NERXIEN)) D
"RTN","PSOERXO1",324,0)
 .S FDA(52.49201,"+1,"_NEWRX_",",.01)=NERXIEN D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXO1",325,0)
 I '$D(^PS(52.49,NERXIEN,201,"B",NEWRX)) D
"RTN","PSOERXO1",326,0)
 .S FDA(52.49201,"+1,"_NERXIEN_",",.01)=NEWRX D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXO1",327,0)
 Q
"RTN","PSOERXU1")
0^11^B144420314^B88661299
"RTN","PSOERXU1",1,0)
PSOERXU1 ;ALB/BWF - eRx utilities ; 5/26/2017 9:57am
"RTN","PSOERXU1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,508**;DEC 1997;Build 295
"RTN","PSOERXU1",3,0)
 ;
"RTN","PSOERXU1",4,0)
 Q
"RTN","PSOERXU1",5,0)
 ; OR0 - OR0 FROM PENDING OUTPATIENT ORDERS OR BACKDOOR ORDERS
"RTN","PSOERXU1",6,0)
 ; OR0 can also be just the order number
"RTN","PSOERXU1",7,0)
CHKERX(OR0) ;
"RTN","PSOERXU1",8,0)
 N ORIEN,ERXIEN
"RTN","PSOERXU1",9,0)
 S ORIEN=$P(OR0,U) Q:'ORIEN 0
"RTN","PSOERXU1",10,0)
 I '$D(^PS(52.49,"ORN",ORIEN)) Q 0
"RTN","PSOERXU1",11,0)
 S ERXIEN=$O(^PS(52.49,"ORN",ORIEN,0))
"RTN","PSOERXU1",12,0)
 I 'ERXIEN Q 0
"RTN","PSOERXU1",13,0)
 Q ERXIEN
"RTN","PSOERXU1",14,0)
PROVPMT(ERXIEN) ;
"RTN","PSOERXU1",15,0)
 N ERXPHYS,ERXPHNM,ERXCON,DIR,Y
"RTN","PSOERXU1",16,0)
 S $P(LINE,"*",80)="" W !!,LINE
"RTN","PSOERXU1",17,0)
 W !!,"This prescription is an inbound electronic prescription (eRx).",!,"Please contact the original provider for approval to renew."
"RTN","PSOERXU1",18,0)
 S ERXPHYS=$$GET1^DIQ(52.49,ERXIEN,2.1,"I")
"RTN","PSOERXU1",19,0)
 S ERXPHNM=$$GET1^DIQ(52.48,ERXPHYS,.01,"E") W !,ERXPHNM
"RTN","PSOERXU1",20,0)
 I '$D(^PS(52.48,ERXPHYS,3,"C","TE")) W !!,"No telephone information on file for this provider." Q
"RTN","PSOERXU1",21,0)
 W !
"RTN","PSOERXU1",22,0)
 S ERXCON=0 F  S ERXCON=$O(^PS(52.48,ERXPHYS,3,"C","TE",ERXCON)) Q:'ERXCON  D
"RTN","PSOERXU1",23,0)
 .W !,"Telephone: "_$$GET1^DIQ(52.483,ERXCON_","_ERXPHYS_",",.01,"E")
"RTN","PSOERXU1",24,0)
 W !!,"Answering 'Yes' indicates you have contacted the prescribing physician"
"RTN","PSOERXU1",25,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("A")="Would you like to proceed with renewing this prescription" D ^DIR K DIR
"RTN","PSOERXU1",26,0)
 I Y=1 Q 1
"RTN","PSOERXU1",27,0)
 Q 0
"RTN","PSOERXU1",28,0)
 ; STORE IN ^TMP("PSOPO",$J,IEN,0)
"RTN","PSOERXU1",29,0)
DERX1(GL,PSOIEN,DFLG,IEN) ;
"RTN","PSOERXU1",30,0)
 N EDRG,ERXDAT,ESIG,COMM,SUBS,DFORM,DSTR,QQUAL,POTUC,QTY,DAYS,REFILL,PSOIENS,LINE,LINETXT,ADLINE,ADARY,ALOOP,COMMARY
"RTN","PSOERXU1",31,0)
 N ERXPAT,ERXPIEN,ERXPDOB,ERXPSSN,ERXPROV,ERXPRIEN,ERXPRDEA,ERXPRNPI,ERXPRSA1,ERXPRSA2,ERXPRCTY,ERXPRST,ERXPRZIP,I
"RTN","PSOERXU1",32,0)
 N PROVDAT,SIGARY,STHIS,STAT,ACBY,FOUND,ACDTTM,DRGARY,DLP,CTYSTZIP,ADLINE1,MTYPE
"RTN","PSOERXU1",33,0)
 Q:'PSOIEN
"RTN","PSOERXU1",34,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERXU1",35,0)
 D GETS^DIQ(52.49,PSOIENS,".04;.08;2.1;3.1;4.6;4.8;5.1;5.2;5.4;5.5;5.6;5.7;5.8;7;8;41;42;43","IE","ERXDAT")
"RTN","PSOERXU1",36,0)
 S DFLG=$G(DFLG,"")
"RTN","PSOERXU1",37,0)
 S EDRG=$G(ERXDAT(52.49,PSOIENS,3.1,"E"))
"RTN","PSOERXU1",38,0)
 S ESIG=$G(ERXDAT(52.49,PSOIENS,7,"E"))
"RTN","PSOERXU1",39,0)
 S COMM=$G(ERXDAT(52.49,PSOIENS,8,"E"))
"RTN","PSOERXU1",40,0)
 S SUBS=$G(ERXDAT(52.49,PSOIENS,5.8,"E"))
"RTN","PSOERXU1",41,0)
 S DFORM=$G(ERXDAT(52.49,PSOIENS,41,"E"))
"RTN","PSOERXU1",42,0)
 S DSTR=$G(ERXDAT(52.49,PSOIENS,43,"E"))
"RTN","PSOERXU1",43,0)
 S QQUAL=$G(ERXDAT(52.49,PSOIENS,5.2,"E"))
"RTN","PSOERXU1",44,0)
 S POTUC=$G(ERXDAT(52.49,PSOIENS,42,"E"))
"RTN","PSOERXU1",45,0)
 S QTY=$G(ERXDAT(52.49,PSOIENS,5.1,"E"))
"RTN","PSOERXU1",46,0)
 S DAYS=$G(ERXDAT(52.49,PSOIENS,5.5,"E"))
"RTN","PSOERXU1",47,0)
 S MTYPE=$G(ERXDAT(52.49,PSOIENS,.08,"I"))
"RTN","PSOERXU1",48,0)
 S REFILL=$G(ERXDAT(52.49,PSOIENS,5.6,"E"))
"RTN","PSOERXU1",49,0)
 I MTYPE="RE",REFILL>0 S REFILL=REFILL-1
"RTN","PSOERXU1",50,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXU1",51,0)
 I REFILL="" D
"RTN","PSOERXU1",52,0)
 .S REFILL=$G(ERXDAT(52.49,PSOIENS,5.7,"I"))
"RTN","PSOERXU1",53,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXU1",54,0)
 S ERXPAT=$G(ERXDAT(52.49,PSOIENS,.04,"E"))
"RTN","PSOERXU1",55,0)
 S ERXPIEN=$G(ERXDAT(52.49,PSOIENS,.04,"I"))
"RTN","PSOERXU1",56,0)
 S ERXPDOB=$$GET1^DIQ(52.46,ERXPIEN,.08,"E")
"RTN","PSOERXU1",57,0)
 S ERXPSSN=$$GET1^DIQ(52.46,ERXPIEN,1.4,"E")
"RTN","PSOERXU1",58,0)
 S ERXPROV=$G(ERXDAT(52.49,PSOIENS,2.1,"E"))
"RTN","PSOERXU1",59,0)
 S ERXPRIEN=$G(ERXDAT(52.49,PSOIENS,2.1,"I"))
"RTN","PSOERXU1",60,0)
 D GETS^DIQ(52.48,ERXPRIEN_",","1.5;1.6;4.1;4.2;4.3;4.4;4.5","E","PROVDAT")
"RTN","PSOERXU1",61,0)
 S ERXPRDEA=$G(PROVDAT(52.48,ERXPRIEN_",",1.6,"E"))
"RTN","PSOERXU1",62,0)
 S ERXPRNPI=$G(PROVDAT(52.48,ERXPRIEN_",",1.5,"E"))
"RTN","PSOERXU1",63,0)
 S ERXPRSA1=$G(PROVDAT(52.48,ERXPRIEN_",",4.1,"E"))
"RTN","PSOERXU1",64,0)
 S ERXPRSA2=$G(PROVDAT(52.48,ERXPRIEN_",",4.2,"E"))
"RTN","PSOERXU1",65,0)
 S ERXPRCTY=$G(PROVDAT(52.48,ERXPRIEN_",",4.3,"E"))
"RTN","PSOERXU1",66,0)
 S ERXPRST=$G(PROVDAT(52.48,ERXPRIEN_",",4.4,"E"))
"RTN","PSOERXU1",67,0)
 S ERXPRZIP=$G(PROVDAT(52.48,ERXPRIEN_",",4.5,"E"))
"RTN","PSOERXU1",68,0)
 D TXT2ARY^PSOERXD1(.SIGARY,ESIG,,69)
"RTN","PSOERXU1",69,0)
 D TXT2ARY^PSOERXD1(.COMMARY,COMM,,65)
"RTN","PSOERXU1",70,0)
 S STHIS=99999,FOUND=0
"RTN","PSOERXU1",71,0)
 F  S STHIS=$O(^PS(52.49,PSOIEN,19,STHIS),-1) Q:'STHIS!(FOUND)  D
"RTN","PSOERXU1",72,0)
 .S STAT=$$GET1^DIQ(52.4919,STHIS_","_PSOIENS,.02,"I")
"RTN","PSOERXU1",73,0)
 .I $$GET1^DIQ(52.45,STAT,.01,"E")'="PR" Q
"RTN","PSOERXU1",74,0)
 .S ACDTTM=$$GET1^DIQ(52.4919,STHIS_","_PSOIENS,.01,"E")
"RTN","PSOERXU1",75,0)
 .S ACBY=$$GET1^DIQ(52.4919,STHIS_","_PSOIENS,.03,"E"),FOUND=1
"RTN","PSOERXU1",76,0)
 I $L($G(ACBY)) S IEN=IEN+1,@GL@(IEN,0)="eRx Accepted By: "_ACBY_" ("_ACDTTM_")"
"RTN","PSOERXU1",77,0)
 S LINETXT=""
"RTN","PSOERXU1",78,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Patient: ",ERXPAT,1,55)
"RTN","PSOERXU1",79,0)
 D ADDITEM^PSOERX1A(.LINETXT,"SSN: ",ERXPSSN,57,15)
"RTN","PSOERXU1",80,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT
"RTN","PSOERXU1",81,0)
 S LINETXT=""
"RTN","PSOERXU1",82,0)
 I $L(ERXPAT)>42 D ADDITEM^PSOERX1A(.LINETXT,"             ",$E(ERXPAT,43,84),1,55)
"RTN","PSOERXU1",83,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",ERXPDOB,57,20)
"RTN","PSOERXU1",84,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT
"RTN","PSOERXU1",85,0)
 I $L(ERXPAT)>84 D
"RTN","PSOERXU1",86,0)
 .S IEN=IEN+1,@GL@(IEN,0)="             "_$E(ERXPAT,85,117)
"RTN","PSOERXU1",87,0)
 S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",88,0)
 I $L(ERXPAT)>117 D
"RTN","PSOERXU1",89,0)
 .S IEN=IEN+1,@GL@(IEN,0)="             "_$E(ERXPAT,118,135)
"RTN","PSOERXU1",90,0)
 S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",91,0)
 S LINETXT=""
"RTN","PSOERXU1",92,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Provider: ",$E(ERXPROV,1,55),1,55)
"RTN","PSOERXU1",93,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DEA: ",ERXPRDEA,57,20)
"RTN","PSOERXU1",94,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT,LINETXT=""
"RTN","PSOERXU1",95,0)
 I $L(ERXPROV)>55 D ADDITEM^PSOERX1A(.LINETXT,"              ",$E(ERXPROV,56,96),1,55)
"RTN","PSOERXU1",96,0)
 D ADDITEM^PSOERX1A(.LINETXT,"NPI: ",ERXPRNPI,57,20)
"RTN","PSOERXU1",97,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT,LINETXT=""
"RTN","PSOERXU1",98,0)
 I $L(ERXPROV)>96 D ADDITEM^PSOERX1A(.LINETXT,"              ",$E(ERXPROV,97,135),1,55)
"RTN","PSOERXU1",99,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT,LINETXT=""
"RTN","PSOERXU1",100,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXU1",101,0)
 S ADLINE1=$S($L(ERXPRSA1):ERXPRSA1,1:"ADDRESS UNKNOWN ")
"RTN","PSOERXU1",102,0)
 S CTYSTZIP=$S($L(ERXPRCTY):ERXPRCTY_",",1:"")
"RTN","PSOERXU1",103,0)
 S CTYSTZIP=CTYSTZIP_$S($L(ERXPRST):ERXPRST_" ",1:"")
"RTN","PSOERXU1",104,0)
 S CTYSTZIP=" "_CTYSTZIP_$S($L(ERXPRZIP):ERXPRZIP,1:"")
"RTN","PSOERXU1",105,0)
 S IEN=IEN+1,@GL@(IEN,0)="Address: "_ADLINE1
"RTN","PSOERXU1",106,0)
 S IEN=IEN+1,@GL@(IEN,0)=CTYSTZIP
"RTN","PSOERXU1",107,0)
 I $L(ERXPRSA2) D
"RTN","PSOERXU1",108,0)
 .S IEN=IEN+1,@GL@(IEN,0)="Address Line 2: "_ERXPRSA2
"RTN","PSOERXU1",109,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXU1",110,0)
 I $O(ADARY(0)) D
"RTN","PSOERXU1",111,0)
 .S ALOOP=1 F  S ALOOP=$O(ADARY(ALOOP)) Q:'ALOOP  D
"RTN","PSOERXU1",112,0)
 ..S IEN=IEN+1,@GL@(IEN,0)="         "_ADARY(ALOOP)
"RTN","PSOERXU1",113,0)
 S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",114,0)
 D TXT2ARY^PSOERXD1(.DRGARY,EDRG,,70)
"RTN","PSOERXU1",115,0)
 S IEN=IEN+1,@GL@(IEN,0)="eRx Drug: "_$G(DRGARY(1))
"RTN","PSOERXU1",116,0)
 S DLP=1
"RTN","PSOERXU1",117,0)
 F  S DLP=$O(DRGARY(DLP)) Q:'DLP  D
"RTN","PSOERXU1",118,0)
 .S IEN=IEN+1,@GL@(IEN,0)="          "_$G(DRGARY(DLP))
"RTN","PSOERXU1",119,0)
 S LINETXT=""
"RTN","PSOERXU1",120,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Qty: ",QTY,1,25)
"RTN","PSOERXU1",121,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Days Supply: ",DAYS,27,16)
"RTN","PSOERXU1",122,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Refills: ",REFILL,58,20)
"RTN","PSOERXU1",123,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT
"RTN","PSOERXU1",124,0)
 S IEN=IEN+1,@GL@(IEN,0)="eRx Sig: "
"RTN","PSOERXU1",125,0)
 S I=0 F  S I=$O(SIGARY(I)) Q:'I  D
"RTN","PSOERXU1",126,0)
 .I I=1 S @GL@(IEN,0)=@GL@(IEN,0)_SIGARY(I) Q
"RTN","PSOERXU1",127,0)
 .S IEN=IEN+1,@GL@(IEN,0)=$S(I>1:"         "_SIGARY(I),1:SIGARY(I))
"RTN","PSOERXU1",128,0)
 I '$L(ESIG) S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",129,0)
 S IEN=IEN+1,@GL@(IEN,0)="eRx Notes: "
"RTN","PSOERXU1",130,0)
 S I=0 F  S I=$O(COMMARY(I)) Q:'I  D
"RTN","PSOERXU1",131,0)
 .I I=1 S @GL@(IEN,0)=@GL@(IEN,0)_$S(I>1:"              "_COMMARY(I),1:COMMARY(I)) Q
"RTN","PSOERXU1",132,0)
 .S IEN=IEN+1,@GL@(IEN,0)=$S(I>1:"              "_COMMARY(I),1:COMMARY(I))
"RTN","PSOERXU1",133,0)
 I '$L(COMM) S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",134,0)
 Q:DFLG=1
"RTN","PSOERXU1",135,0)
 S LINETXT=""
"RTN","PSOERXU1",136,0)
 S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",137,0)
 S IEN=IEN+1,@GL@(IEN,0)="Drug Form: "_DFORM
"RTN","PSOERXU1",138,0)
 S IEN=IEN+1,@GL@(IEN,0)="Strength: "_DSTR
"RTN","PSOERXU1",139,0)
 S LINETXT=""
"RTN","PSOERXU1",140,0)
 S IEN=IEN+1,@GL@(IEN,0)="Qty Qualifier: "_QQUAL
"RTN","PSOERXU1",141,0)
 S IEN=IEN+1,@GL@(IEN,0)="Potency Unit Code: "_POTUC
"RTN","PSOERXU1",142,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT
"RTN","PSOERXU1",143,0)
 S IEN=IEN+1,@GL@(IEN,0)="DAW Code: "_SUBS
"RTN","PSOERXU1",144,0)
 S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",145,0)
 D DIAG(PSOIEN,.IEN,.GL)
"RTN","PSOERXU1",146,0)
 S $P(LINE,"-",80)=""
"RTN","PSOERXU1",147,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINE
"RTN","PSOERXU1",148,0)
 Q
"RTN","PSOERXU1",149,0)
 ; diagnosis information
"RTN","PSOERXU1",150,0)
DIAG(PSOIEN,LINE,GL) ;
"RTN","PSOERXU1",151,0)
 N DIAGIEN,DIAGDAT,DIAGSEQ,PDIAGQ,PDIAGV,SDIAGQ,SDIAGV,DIAGDAT,DIACIC,DRES,SDRES,PDIAGTXT,SDIAGTXT
"RTN","PSOERXU1",152,0)
 N SDRESL,SDRESDAT,DRESL,DRESDAT,PDIAGARY,SDIAGARY,PDFRST,SDFRST,PDLOOP,SDLOOP,DIENS
"RTN","PSOERXU1",153,0)
 S DIAGIEN=0 F  S DIAGIEN=$O(^PS(52.49,PSOIEN,9,DIAGIEN)) Q:'DIAGIEN  D
"RTN","PSOERXU1",154,0)
 .S DIENS=DIAGIEN_","_PSOIEN_"," K PDIAGARY,SDIAGARY,DIAGDAT
"RTN","PSOERXU1",155,0)
 .D GETS^DIQ(52.499,DIENS,".01:.06","IE","DIAGDAT")
"RTN","PSOERXU1",156,0)
 .S DIAGSEQ=$G(DIAGDAT(52.499,DIENS,.01,"E"))
"RTN","PSOERXU1",157,0)
 .S DIACIC=$G(DIAGDAT(52.499,DIENS,.02,"E"))
"RTN","PSOERXU1",158,0)
 .S PDIAGQ=$G(DIAGDAT(52.499,DIENS,.03,"E"))
"RTN","PSOERXU1",159,0)
 .S PDIAGV=$G(DIAGDAT(52.499,DIENS,.04,"E"))
"RTN","PSOERXU1",160,0)
 .I PDIAGQ["ICD" D
"RTN","PSOERXU1",161,0)
 ..K DRES,PDIAGARY
"RTN","PSOERXU1",162,0)
 ..D ICDDESC^ICDXCODE(PDIAGQ,PDIAGV,,.DRES)
"RTN","PSOERXU1",163,0)
 ..I '$O(DRES(0)) D TXT2ARY^PSOERXD1(.PDIAGARY,"Primary Dx:   ("_PDIAGQ_" - "_PDIAGV_")"," ",78) Q
"RTN","PSOERXU1",164,0)
 ..S PDIAGTXT="Primary Dx:   ("_PDIAGQ_" "_PDIAGV_") "
"RTN","PSOERXU1",165,0)
 ..S DRESL=0 F  S DRESL=$O(DRES(DRESL)) Q:'DRESL  D
"RTN","PSOERXU1",166,0)
 ...S DRESDAT=$G(DRES(DRESL)) Q:DRESDAT=""
"RTN","PSOERXU1",167,0)
 ...S PDIAGTXT=$G(PDIAGTXT)_" "_DRESDAT
"RTN","PSOERXU1",168,0)
 ..D TXT2ARY^PSOERXD1(.PDIAGARY,PDIAGTXT," ",78)
"RTN","PSOERXU1",169,0)
 .S SDIAGQ=$G(DIAGDAT(52.499,DIENS,.05,"E"))
"RTN","PSOERXU1",170,0)
 .S SDIAGV=$G(DIAGDAT(52.499,DIENS,.06,"E"))
"RTN","PSOERXU1",171,0)
 .I SDIAGQ["ICD" D
"RTN","PSOERXU1",172,0)
 ..K SDRES,SDIAGARY
"RTN","PSOERXU1",173,0)
 ..D ICDDESC^ICDXCODE(SDIAGQ,SDIAGV,,.SDRES)
"RTN","PSOERXU1",174,0)
 ..I '$O(DRES(0)) D TXT2ARY^PSOERXD1(.SDIAGARY,"Secondary Dx: ("_SDIAGQ_" - "_SDIAGV_")"," ",78) Q
"RTN","PSOERXU1",175,0)
 ..S SDIAGTXT="Secondary Dx: ("_SDIAGQ_" "_SDIAGV_") "
"RTN","PSOERXU1",176,0)
 ..S SDRESL=0 F  S SDRESL=$O(SDRES(SDRESL)) Q:'SDRESL  D
"RTN","PSOERXU1",177,0)
 ...S SDRESDAT=$G(SDRES(SDRESL)) Q:SDRESDAT=""
"RTN","PSOERXU1",178,0)
 ...S SDIAGTXT=$G(SDIAGTXT)_" "_SDRESDAT
"RTN","PSOERXU1",179,0)
 ..D TXT2ARY^PSOERXD1(.SDIAGARY,SDIAGTXT," ",78)
"RTN","PSOERXU1",180,0)
 .I '$D(PDIAGARY) D TXT2ARY^PSOERXD1(.PDIAGARY,"Primary Dx:   ("_PDIAGQ_" - "_PDIAGV_")"," ",78)
"RTN","PSOERXU1",181,0)
 .S PDFRST=$O(PDIAGARY(0))
"RTN","PSOERXU1",182,0)
 .S LINE=LINE+1
"RTN","PSOERXU1",183,0)
 .I $D(GL) D SETGL(LINE,PDIAGARY(PDFRST))
"RTN","PSOERXU1",184,0)
 .I '$D(GL) D SETLOC(LINE,$G(PDIAGARY(PDFRST)))
"RTN","PSOERXU1",185,0)
 .S PDLOOP=PDFRST F  S PDLOOP=$O(PDIAGARY(PDLOOP)) Q:'PDLOOP  D
"RTN","PSOERXU1",186,0)
 ..S LINE=LINE+1
"RTN","PSOERXU1",187,0)
 ..I $D(GL) D SETGL(LINE,"              "_$G(PDIAGARY(PDLOOP)))
"RTN","PSOERXU1",188,0)
 ..I '$D(GL) D SETLOC(LINE,"              "_$G(PDIAGARY(PDLOOP)))
"RTN","PSOERXU1",189,0)
 .S LINE=LINE+1
"RTN","PSOERXU1",190,0)
 .I $D(GL) D SETGL(LINE,"")
"RTN","PSOERXU1",191,0)
 .I '$D(GL) D SETLOC(LINE,"")
"RTN","PSOERXU1",192,0)
 .I '$D(SDIAGARY) D TXT2ARY^PSOERXD1(.SDIAGARY,"Secondary Dx: ("_SDIAGQ_" - "_SDIAGV_")"," ",78)
"RTN","PSOERXU1",193,0)
 .S SDFRST=$O(SDIAGARY(0))
"RTN","PSOERXU1",194,0)
 .S LINE=LINE+1
"RTN","PSOERXU1",195,0)
 .I $D(GL) D SETGL(LINE,$G(SDIAGARY(SDFRST)))
"RTN","PSOERXU1",196,0)
 .I '$D(GL) D SETLOC(LINE,$G(SDIAGARY(SDFRST)))
"RTN","PSOERXU1",197,0)
 .S SDLOOP=SDFRST F  S SDLOOP=$O(SDIAGARY(SDLOOP)) Q:'SDLOOP  D
"RTN","PSOERXU1",198,0)
 ..S LINE=LINE+1
"RTN","PSOERXU1",199,0)
 ..I $D(GL) D SETGL(LINE,"              "_$G(SDIAGARY(SDLOOP)))
"RTN","PSOERXU1",200,0)
 ..I '$D(GL) D SETLOC(LINE,"              "_$G(SDIAGARY(SDLOOP)))
"RTN","PSOERXU1",201,0)
 .I $O(^PS(52.49,PSOIEN,9,DIAGIEN)) D
"RTN","PSOERXU1",202,0)
 ..S LINE=LINE+1
"RTN","PSOERXU1",203,0)
 ..I $D(GL) D SETGL(LINE,"")
"RTN","PSOERXU1",204,0)
 ..I '$D(GL) D SETLOC(LINE,"")
"RTN","PSOERXU1",205,0)
 Q
"RTN","PSOERXU1",206,0)
SETLOC(LINE,TEXT) ;
"RTN","PSOERXU1",207,0)
 D SET^VALM10(LINE,TEXT)
"RTN","PSOERXU1",208,0)
 Q
"RTN","PSOERXU1",209,0)
SETGL(IEN,TEXT) ;
"RTN","PSOERXU1",210,0)
 S @GL@(IEN,0)=TEXT
"RTN","PSOERXU1",211,0)
 Q
"RTN","PSOERXU1",212,0)
OPACCESS(OPTION,DUZ,ERXIEN) ;
"RTN","PSOERXU1",213,0)
 N MTYPE,EVAL,RESVAL,MSTAT,DELTA,RET,RESIEN,REQIEN
"RTN","PSOERXU1",214,0)
 S MTYPE=$$GET1^DIQ(52.49,PSOIEN,.08,"I")
"RTN","PSOERXU1",215,0)
 S MSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E")
"RTN","PSOERXU1",216,0)
 S RESVAL=$$GET1^DIQ(52.49,PSOIEN,52.1,"I")
"RTN","PSOERXU1",217,0)
 I MSTAT="RRE"!(MSTAT="RRN") Q 0
"RTN","PSOERXU1",218,0)
 I MTYPE="RE",((RESVAL="D")!(RESVAL="DNP"))!(RESVAL="A") Q 0
"RTN","PSOERXU1",219,0)
 I MTYPE="RE",(MSTAT="RXP")!(MSTAT="RXC") Q 0
"RTN","PSOERXU1",220,0)
 I MTYPE="RE"!(MTYPE="RR"),(MSTAT="CAN")!(MSTAT="RXD")!(MSTAT="RRP") Q 0
"RTN","PSOERXU1",221,0)
 I MTYPE="CA"!(MTYPE="CN")!(MTYPE="IE") Q 0
"RTN","PSOERXU1",222,0)
 I MTYPE="N",$$GET1^DIQ(52.49,PSOIEN,1,"E")="CAN" Q 0
"RTN","PSOERXU1",223,0)
 I OPTION="PSO ERX ACCEPT ERX",RESVAL="AWC",MTYPE="RE",(MSTAT="RXN"!(MSTAT="RXW")) D  Q RET
"RTN","PSOERXU1",224,0)
 .S RET=0 I ('$D(^XUSEC("PSDRPH",DUZ))),('$D(^XUSEC("PSO ERX ADV TECH",DUZ))) Q
"RTN","PSOERXU1",225,0)
 .I MSTAT="RXW" S RET=1 Q
"RTN","PSOERXU1",226,0)
 .S RESIEN=PSOIEN,REQIEN=$$GETREQ^PSOERXU2(PSOIEN)
"RTN","PSOERXU1",227,0)
 .D RRDELTA^PSOERXU2(.DELTA,REQIEN,RESIEN)
"RTN","PSOERXU1",228,0)
 .I $D(DELTA(52.49,"EXTERNAL PROVIDER")) S RET=1
"RTN","PSOERXU1",229,0)
 ; block all but accept erx on eRx's in RXW status
"RTN","PSOERXU1",230,0)
 I OPTION'="PSO ERX ACCEPT ERX",MSTAT="RXW" Q 0
"RTN","PSOERXU1",231,0)
 I OPTION="PSO ERX REJECT"!(OPTION="PSO ERX REMOVE")!(OPTION="PSO ERX HOLD")!(OPTION="PSO ERX UNHOLD"),MSTAT="RXN" Q 0
"RTN","PSOERXU1",232,0)
 I OPTION="PSO ERX ACCEPT ERX",('$D(^XUSEC("PSDRPH",DUZ))),('$D(^XUSEC("PSO ERX ADV TECH",DUZ))) Q 0
"RTN","PSOERXU1",233,0)
 I OPTION="PSO ERX ACCEPT VALIDATION",($D(^XUSEC("PSO ERX TECH",DUZ))!($D(^XUSEC("PSO ERX VIEW",DUZ)))) Q 0
"RTN","PSOERXU1",234,0)
 I OPTION="PSO ERX REJECT",($D(^XUSEC("PSO ERX VIEW",DUZ))) Q 0
"RTN","PSOERXU1",235,0)
 I OPTION="PSO ERX REMOVE",($D(^XUSEC("PSO ERX VIEW",DUZ))) Q 0
"RTN","PSOERXU1",236,0)
 ; UNREMOVE NEEDS TO BE ADDED IF WE ADD THE OPTION
"RTN","PSOERXU1",237,0)
 I OPTION="PSO ERX VALIDATE PATIENT",$D(^XUSEC("PSO ERX VIEW",DUZ)) Q 0
"RTN","PSOERXU1",238,0)
 I OPTION="PSO ERX VALIDATE PROVIDER",$D(^XUSEC("PSO ERX VIEW",DUZ)) Q 0
"RTN","PSOERXU1",239,0)
 I OPTION="PSO ERX VALIDATE DRUG",$D(^XUSEC("PSO ERX VIEW",DUZ)) Q 0
"RTN","PSOERXU1",240,0)
 I OPTION="PSO ERX HOLD",$D(^XUSEC("PSO ERX VIEW",DUZ)) Q 0
"RTN","PSOERXU1",241,0)
 I OPTION="PSO ERX UNHOLD",$D(^XUSEC("PSO ERX VIEW",DUZ)) Q 0
"RTN","PSOERXU1",242,0)
 Q 1
"RTN","PSOERXU1",243,0)
 ; update the status of an eRx
"RTN","PSOERXU1",244,0)
 ; PSOIEN - ien for file 52.49 (required)
"RTN","PSOERXU1",245,0)
 ; STAT - The status value to change the eRx to (required)
"RTN","PSOERXU1",246,0)
 ; SCOMM - status comments (optional)
"RTN","PSOERXU1",247,0)
UPDSTAT(PSOIEN,STAT,SCOMM) ;
"RTN","PSOERXU1",248,0)
 N DIE,NSTAT,DA,DR
"RTN","PSOERXU1",249,0)
 Q:'PSOIEN!(STAT="")
"RTN","PSOERXU1",250,0)
 Q:'$D(^PS(52.45,"C","ERX",STAT))
"RTN","PSOERXU1",251,0)
 S NSTAT=$O(^PS(52.45,"C","ERX",STAT,0))
"RTN","PSOERXU1",252,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="1///"_NSTAT D ^DIE
"RTN","PSOERXU1",253,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",.01)=$$NOW^XLFDT
"RTN","PSOERXU1",254,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",.02)=NSTAT
"RTN","PSOERXU1",255,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",.03)=$G(DUZ)
"RTN","PSOERXU1",256,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",1)=$G(SCOMM)
"RTN","PSOERXU1",257,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXU1",258,0)
 Q
"RTN","PSOERXU1",259,0)
ERRSEQ(EIEN) ;
"RTN","PSOERXU1",260,0)
 N SEQ
"RTN","PSOERXU1",261,0)
 I '$O(^PS(52.49,EIEN,100,0)) S SEQ=1
"RTN","PSOERXU1",262,0)
 I '$G(SEQ) S SEQ=$O(^PS(52.49,EIEN,100,999999),-1)+1
"RTN","PSOERXU1",263,0)
 Q SEQ
"RTN","PSOERXU1",264,0)
 ;
"RTN","PSOERXU1",265,0)
 ; IENS - ien of the erx holding queue entry
"RTN","PSOERXU1",266,0)
 ;  SEQ - sequence number of the error
"RTN","PSOERXU1",267,0)
 ; TYPE - type (d-drug, pr-provider, pa-patient, a-allergy, o-order check, t-transfer)
"RTN","PSOERXU1",268,0)
 ;  SRC - v - vista, e - erx processing hub
"RTN","PSOERXU1",269,0)
 ;  TXT - error text
"RTN","PSOERXU1",270,0)
FILERR(IENS,SEQ,TYPE,SRC,TXT) ;
"RTN","PSOERXU1",271,0)
 N FDA
"RTN","PSOERXU1",272,0)
 S FDA(52.49101,"+1,"_IENS,.01)=SEQ
"RTN","PSOERXU1",273,0)
 S FDA(52.49101,"+1,"_IENS,.02)=TYPE
"RTN","PSOERXU1",274,0)
 S FDA(52.49101,"+1,"_IENS,.03)=SRC
"RTN","PSOERXU1",275,0)
 ; all new errors are set to pending
"RTN","PSOERXU1",276,0)
 S FDA(52.49101,"+1,"_IENS,.04)="P"
"RTN","PSOERXU1",277,0)
 S FDA(52.49101,"+1,"_IENS,1)=TXT
"RTN","PSOERXU1",278,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXU1",279,0)
 ; now set the eRx entry status to error
"RTN","PSOERXU1",280,0)
 ;S FDA(52.49,IENS,1)=$O(^PS(52.45,"C","ERX","E",0)) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXU1",281,0)
 Q
"RTN","PSOERXU1",282,0)
MSGDIR(MSG) ;
"RTN","PSOERXU1",283,0)
 N DIR,MLOOP,MTXT
"RTN","PSOERXU1",284,0)
 S VALMBCK="R"
"RTN","PSOERXU1",285,0)
 D FULL^VALM1
"RTN","PSOERXU1",286,0)
 W !!,"Errors encountered during processing:",!
"RTN","PSOERXU1",287,0)
 S MLOOP=0 F  S MLOOP=$O(MSG(MLOOP)) Q:'MLOOP  D
"RTN","PSOERXU1",288,0)
 .S MTXT=$G(MSG(MLOOP)) W !,MLOOP_".) ",MTXT
"RTN","PSOERXU1",289,0)
 W !!,"Cannot process eRx.",!
"RTN","PSOERXU1",290,0)
 S DIR(0)="E" D ^DIR
"RTN","PSOERXU1",291,0)
 Q
"RTN","PSOERXU1",292,0)
 ; provider change screen on refill response
"RTN","PSOERXU1",293,0)
CHPRCHG(ERXIEN) ;
"RTN","PSOERXU1",294,0)
 N REQIEN,RESIEN,DELTA,MTYPE,RESVAL,MSTAT
"RTN","PSOERXU1",295,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERXU1",296,0)
 S MSTAT=$$GET1^DIQ(52.49,ERXIEN,1,"E")
"RTN","PSOERXU1",297,0)
 S RESVAL=$$GET1^DIQ(52.49,ERXIEN,52.1,"I")
"RTN","PSOERXU1",298,0)
 I MTYPE="RE",((RESVAL="D")!(RESVAL="DNP")) Q 0
"RTN","PSOERXU1",299,0)
 I MTYPE="RR"!(MTYPE="CA")!(MTYPE="CN")!(MTYPE="IE") Q 0
"RTN","PSOERXU1",300,0)
 I MTYPE'="RE" Q 1
"RTN","PSOERXU1",301,0)
 I MTYPE="RE",MSTAT="RXW" Q 1
"RTN","PSOERXU1",302,0)
 I RESVAL'="AWC",MTYPE="RE",",RXP,RXC,RXD,"[MSTAT Q 0
"RTN","PSOERXU1",303,0)
 I MTYPE="RE",($$GET1^DIQ(52.49,ERXIEN,52.1,"I")'["A") Q 0
"RTN","PSOERXU1",304,0)
 S RESIEN=ERXIEN,REQIEN=$$GETREQ^PSOERXU2(ERXIEN)
"RTN","PSOERXU1",305,0)
 D RRDELTA^PSOERXU2(.DELTA,REQIEN,RESIEN) Q:'$D(DELTA) 0
"RTN","PSOERXU1",306,0)
 I $D(DELTA(52.49,"EXTERNAL PROVIDER")) Q 1
"RTN","PSOERXU1",307,0)
 Q 0
"RTN","PSOERXU1",308,0)
 ;/BLB/ PSO*7.0*520 -BEGIN CHANGE- ALLERGY INFO
"RTN","PSOERXU1",309,0)
ALG(LINE) ;
"RTN","PSOERXU1",310,0)
 N ALGINFO,ALGLINE,DFN,IEN,X,LDAT,GMRAL,PSONOAL
"RTN","PSOERXU1",311,0)
 S ALGLINE=""
"RTN","PSOERXU1",312,0)
 S DFN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXU1",313,0)
 D EN1^GMRADPT
"RTN","PSOERXU1",314,0)
 S IEN=1
"RTN","PSOERXU1",315,0)
 I 'GMRAL D
"RTN","PSOERXU1",316,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Allergies: "_$S(GMRAL=0:"NKA",1:"")
"RTN","PSOERXU1",317,0)
 .I GMRAL'=0 S PSONOAL="" D ALLERGY^PSOORUT2 I PSONOAL'="" S ^TMP("PSOPI",$J,IEN,0)="Allergies: "_PSONOAL K PSONOAL
"RTN","PSOERXU1",318,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOERXU1",319,0)
 .D REMOTE^PSOORUT2
"RTN","PSOERXU1",320,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Adverse Reactions:"
"RTN","PSOERXU1",321,0)
 D:$G(GMRAL) ^PSOORUT3
"RTN","PSOERXU1",322,0)
 S LINE=LINE+1
"RTN","PSOERXU1",323,0)
 S X=0 F  S X=$O(^TMP("PSOPI",$J,X)) Q:'X  D
"RTN","PSOERXU1",324,0)
 .S LDAT=$G(^TMP("PSOPI",$J,X,0))
"RTN","PSOERXU1",325,0)
 .S LINE=LINE+1
"RTN","PSOERXU1",326,0)
 .D SET^VALM10(LINE,LDAT)
"RTN","PSOERXU1",327,0)
 K ^TMP("PSOPI",$J)
"RTN","PSOERXU1",328,0)
 Q
"RTN","PSOERXU1",329,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXU2")
0^16^B50733365^n/a
"RTN","PSOERXU2",1,0)
PSOERXU2 ;ALB/BWF - eRx utilities ; 5/26/2017 9:57am
"RTN","PSOERXU2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**508**;DEC 1997;Build 295
"RTN","PSOERXU2",3,0)
 ;
"RTN","PSOERXU2",4,0)
 Q
"RTN","PSOERXU2",5,0)
 ; look for existing patient
"RTN","PSOERXU2",6,0)
 ; NAME - PATIENT FULL NAME
"RTN","PSOERXU2",7,0)
 ; IDOB - INCOMING PATIENT DOB
"RTN","PSOERXU2",8,0)
 ; IDGEN - INCOMING PATIENT GENDER
"RTN","PSOERXU2",9,0)
 ; SSN - INCOMING PATIENT SSN
"RTN","PSOERXU2",10,0)
 ; AL1 - INCOMING PATIENT ADDRESS LINE 1
"RTN","PSOERXU2",11,0)
FINDPAT(NAME,IDOB,IGEN,SSN,AL1) ;
"RTN","PSOERXU2",12,0)
 N MPAT,MTCHCNT,PIEN,MATCH,PDOB,PGEN,PSSN,PAL1
"RTN","PSOERXU2",13,0)
 ; for now, quit if name match does not occur.
"RTN","PSOERXU2",14,0)
 I '$D(^PS(52.46,"BN",NAME)) Q ""
"RTN","PSOERXU2",15,0)
 S MTCHCNT=0
"RTN","PSOERXU2",16,0)
 S PIEN=0 F  S PIEN=$O(^PS(52.46,"BN",NAME,PIEN)) Q:'PIEN  D
"RTN","PSOERXU2",17,0)
 .S PDOB=$$GET1^DIQ(52.46,PIEN,.08,"I"),PGEN=$$GET1^DIQ(52.46,PIEN,.07,"I")
"RTN","PSOERXU2",18,0)
 .S PSSN=$$GET1^DIQ(52.46,PIEN,1.4),PAL1=$$GET1^DIQ(52.46,PIEN,3.1,"E")
"RTN","PSOERXU2",19,0)
 .; if the ssn exists, and does not match, quit
"RTN","PSOERXU2",20,0)
 .I $L(SSN),SSN'=PSSN Q
"RTN","PSOERXU2",21,0)
 .I PDOB=IDOB,PGEN=IGEN,AL1=PAL1 S MTCHCNT=MTCHCNT+1,MATCH(PIEN)=""
"RTN","PSOERXU2",22,0)
 I MTCHCNT'=1 Q ""
"RTN","PSOERXU2",23,0)
 S MPAT=$O(MATCH(0))
"RTN","PSOERXU2",24,0)
 I MPAT Q MPAT
"RTN","PSOERXU2",25,0)
 Q ""
"RTN","PSOERXU2",26,0)
 ; look for existing provider/prescriber
"RTN","PSOERXU2",27,0)
FINDPRE(NAME,NPI,DEA) ;
"RTN","PSOERXU2",28,0)
 N NPCNT,NPIMTCH,NLIST,NLCNT,NLOOP,NLIST2,NAMEMTCH,NMLOOP,NMCNT,NMLIST,DCNT,DEAMTCH,DLCNT,DLIST,DLIST2
"RTN","PSOERXU2",29,0)
 N DLOOP,DMTCH,NPDEA
"RTN","PSOERXU2",30,0)
 ; if there is an NPI, and DEA#, check both. If only one match, then this is the same provider
"RTN","PSOERXU2",31,0)
 I $L(NPI) D  Q NPIMTCH
"RTN","PSOERXU2",32,0)
 .I '$D(^PS(52.48,"C",NPI)) S NPIMTCH="" Q
"RTN","PSOERXU2",33,0)
 .S NPCNT=0
"RTN","PSOERXU2",34,0)
 .S NPIMTCH=0 F  S NPIMTCH=$O(^PS(52.48,"C",NPI,NPIMTCH)) Q:'NPIMTCH  D
"RTN","PSOERXU2",35,0)
 ..S NPDEA=$$GET1^DIQ(52.48,NPIMTCH,1.6,"E") I $L(DEA),NPDEA'=DEA Q
"RTN","PSOERXU2",36,0)
 ..S NLIST(NPIMTCH)="",NPCNT=NPCNT+1
"RTN","PSOERXU2",37,0)
 .; if we have a single match for NPI and DEA# return the result
"RTN","PSOERXU2",38,0)
 .I NPCNT=0 S NPIMTCH="" Q
"RTN","PSOERXU2",39,0)
 .I NPCNT=1 S NPIMTCH=$O(NLIST(0)) Q
"RTN","PSOERXU2",40,0)
 .S NLCNT=0
"RTN","PSOERXU2",41,0)
 .S NLOOP=0 F  S NLOOP=$O(NLIST(NLOOP)) Q:'NLOOP  D
"RTN","PSOERXU2",42,0)
 ..I $L(NAME),NAME=$$GET1^DIQ(52.48,NLOOP,.01,"E") S NLIST2(NLOOP)="",NLCNT=NLCNT+1
"RTN","PSOERXU2",43,0)
 .I NLCNT=0!(NLCNT>1) S NPIMTCH="" Q
"RTN","PSOERXU2",44,0)
 .I NLCNT=1 S NPIMTCH=$O(NLIST2(0)) Q
"RTN","PSOERXU2",45,0)
 I $L(DEA) D  Q DEAMTCH
"RTN","PSOERXU2",46,0)
 .I '$D(^PS(52.48,"D",DEA)) S DEAMTCH="" Q
"RTN","PSOERXU2",47,0)
 .S (DCNT,DMTCH)=0 F  S DMTCH=$O(^PS(52.48,"D",DEA,DMTCH)) Q:'DMTCH  D
"RTN","PSOERXU2",48,0)
 ..S DLIST(DMTCH)="",DCNT=DCNT+1
"RTN","PSOERXU2",49,0)
 .I DCNT=0 S DEAMTCH="" Q
"RTN","PSOERXU2",50,0)
 .I DCNT=1 S DEAMTCH=$O(DLIST(0)) Q
"RTN","PSOERXU2",51,0)
 .S (DLOOP,DLCNT)=0 F  S DLOOP=$O(DLIST(DLOOP)) Q:'DLOOP  D
"RTN","PSOERXU2",52,0)
 ..I $L(NAME),NAME=$$GET1^DIQ(52.48,DLOOP,.01,"E") S DLIST2(DLOOP)="",DLCNT=DLCNT+1
"RTN","PSOERXU2",53,0)
 .I DLCNT=0!(DLCNT>1) S DEAMTCH="" Q
"RTN","PSOERXU2",54,0)
 .I DLCNT=1 S DEAMTCH=$O(DLIST2(0))
"RTN","PSOERXU2",55,0)
 I $L(NAME) D  Q NAMEMTCH
"RTN","PSOERXU2",56,0)
 .I '$D(^PS(52.48,"BN",NAME)) S NAMEMTCH="" Q
"RTN","PSOERXU2",57,0)
 .S (NMLOOP,NMCNT)=0 F  S NMLOOP=$O(^PS(52.48,"BN",NAME,NMLOOP)) Q:'NMLOOP  D
"RTN","PSOERXU2",58,0)
 ..S NMLIST(NMLOOP)="",NMCNT=NMCNT+1
"RTN","PSOERXU2",59,0)
 .I NMCNT=0!(NMCNT>1) S NAMEMTCH="" Q
"RTN","PSOERXU2",60,0)
 .S NAMEMTCH=$O(NMLIST(0))
"RTN","PSOERXU2",61,0)
 Q ""
"RTN","PSOERXU2",62,0)
ERR(ERXIEN,MTYPE) ;
"RTN","PSOERXU2",63,0)
 N GL,ECODE,DESCODE,ERRTEXT,DONE,I,REQIEN,REQTYP,ERXTYP
"RTN","PSOERXU2",64,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,MTYPE,0))
"RTN","PSOERXU2",65,0)
 S ECODE=$G(@GL@("Code",0))
"RTN","PSOERXU2",66,0)
 S ERRTEXT=$G(@GL@("Description",0))
"RTN","PSOERXU2",67,0)
 S FDA(52.49,ERXIEN_",",60.1)=ECODE
"RTN","PSOERXU2",68,0)
 S FDA(52.49,ERXIEN_",",60)=ERRTEXT
"RTN","PSOERXU2",69,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXU2",70,0)
 S DONE=0
"RTN","PSOERXU2",71,0)
 F I=0:1 D  Q:DONE  D
"RTN","PSOERXU2",72,0)
 .I '$D(@GL@("DescriptionCode",I)) S DONE=1 Q
"RTN","PSOERXU2",73,0)
 .S DESCODE=$G(@GL@("DescriptionCode",I))
"RTN","PSOERXU2",74,0)
 .S DESCODE=$$PRESOLV^PSOERXA1(DESCODE,"ERR") Q:'DESCODE
"RTN","PSOERXU2",75,0)
 .Q:$D(^PS(52.49,ERXIEN,61,"B",DESCODE))
"RTN","PSOERXU2",76,0)
 .S FDA(52.4961,"+1,"_ERXIEN_",",.01)=DESCODE D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXU2",77,0)
 S ERXTYP=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERXU2",78,0)
 S REQIEN=$$RESOLV(ERXIEN)
"RTN","PSOERXU2",79,0)
 I REQIEN D  Q
"RTN","PSOERXU2",80,0)
 .S REQTYP=$$GET1^DIQ(52.49,REQIEN,.08,"I")
"RTN","PSOERXU2",81,0)
 .I REQTYP="RR" D UPDSTAT^PSOERXU1(REQIEN,"RRE"),UPDSTAT^PSOERXU1(ERXIEN,"RRE")
"RTN","PSOERXU2",82,0)
 .I REQTYP="CN" D UPDSTAT^PSOERXU1(REQIEN,"CNE"),UPDSTAT^PSOERXU1(ERXIEN,"CNE")
"RTN","PSOERXU2",83,0)
 D UPDSTAT^PSOERXU1(ERXIEN,"E")
"RTN","PSOERXU2",84,0)
 Q
"RTN","PSOERXU2",85,0)
GETSTAT(MTYPE,RTHID,RTMID) ;
"RTN","PSOERXU2",86,0)
 N ESTAT,RTMTYPE,STFDA,RTMIEN,RESTAT
"RTN","PSOERXU2",87,0)
 ; if this is a cancel request, set the initial status to CAR - cancel request received
"RTN","PSOERXU2",88,0)
 I MTYPE="CA" Q $$PRESOLV^PSOERXA1("CAR","ERX")
"RTN","PSOERXU2",89,0)
 I 'RTHID,'RTMID S ESTAT=$S(MTYPE="RR":"RRN",MTYPE="RE":"RXR",MTYPE="N":"N",1:"N") Q $$PRESOLV^PSOERXA1(ESTAT,"ERX")
"RTN","PSOERXU2",90,0)
 ; old related to message resolving logic - leave in place for change request/response - may be needed
"RTN","PSOERXU2",91,0)
 ;S RTMIEN=$$FIND1^DIC(52.49,,,RTMID,"CHVID",,"ERR") I 'RTMIEN Q ""
"RTN","PSOERXU2",92,0)
 S RTMIEN=RTHID
"RTN","PSOERXU2",93,0)
 I MTYPE="IE",'$L(RTMIEN) S ESTAT="E" Q $$PRESOLV^PSOERXA1(ESTAT,"ERX")
"RTN","PSOERXU2",94,0)
 I MTYPE="IE",$L(RTMIEN) D
"RTN","PSOERXU2",95,0)
 .S RTMTYPE=$$GET1^DIQ(52.49,RTMIEN,.08,"I")
"RTN","PSOERXU2",96,0)
 .I RTMTYPE="RR" S RESTAT=$$PRESOLV^PSOERXA1("RRE","ERX"),STFDA(52.49,RTMIEN_",",1)=RESTAT D UPDATE^DIE(,"STFDA") K STFDA
"RTN","PSOERXU2",97,0)
 I MTYPE="RE",$L(RTMIEN) D
"RTN","PSOERXU2",98,0)
 .S RTMTYPE=$$GET1^DIQ(52.49,RTMIEN,.08,"I")
"RTN","PSOERXU2",99,0)
 .I RTMTYPE="RR" S RESTAT=$$PRESOLV^PSOERXA1("RRR","ERX"),STFDA(52.49,RTMIEN_",",1)=RESTAT D UPDATE^DIE(,"STFDA") K STFDA
"RTN","PSOERXU2",100,0)
 I $G(ESTAT) Q ESTAT
"RTN","PSOERXU2",101,0)
 S ESTAT=$S(MTYPE="RR":"RRN",MTYPE="RE":"RXN",MTYPE="N":"N",1:"N")
"RTN","PSOERXU2",102,0)
 I ESTAT="" Q ""
"RTN","PSOERXU2",103,0)
 I '$D(^PS(52.45,"C","ERX",ESTAT)) Q ""
"RTN","PSOERXU2",104,0)
 Q $$PRESOLV^PSOERXA1(ESTAT,"ERX")
"RTN","PSOERXU2",105,0)
ADDCOMM(ERXIEN) ;
"RTN","PSOERXU2",106,0)
 N DIR,Y,FDA,MTYPE
"RTN","PSOERXU2",107,0)
 D FULL^VALM1
"RTN","PSOERXU2",108,0)
 S VALMBCK="R"
"RTN","PSOERXU2",109,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERXU2",110,0)
 I "RR,RE,CA,CN"'[MTYPE!(MTYPE="N") S DIR(0)="E" W !!,"This option can only be used to add comments to request and response message",!,"types." D ^DIR K DIR Q
"RTN","PSOERXU2",111,0)
 S DIR(0)="52.49,50",DIR("B")=$$GET1^DIQ(52.49,ERXIEN,50,"E") D ^DIR
"RTN","PSOERXU2",112,0)
 Q:Y="^"!(Y="")
"RTN","PSOERXU2",113,0)
 S FDA(52.49,ERXIEN_",",50)=Y
"RTN","PSOERXU2",114,0)
 S FDA(52.49,ERXIEN_",",50.1)=DUZ
"RTN","PSOERXU2",115,0)
 S FDA(52.49,ERXIEN_",",50.2)=$$NOW^XLFDT()
"RTN","PSOERXU2",116,0)
 D FILE^DIE(,"FDA")
"RTN","PSOERXU2",117,0)
 D INIT^PSOERX1
"RTN","PSOERXU2",118,0)
 Q
"RTN","PSOERXU2",119,0)
RESOLV(IEN) ;
"RTN","PSOERXU2",120,0)
 N RTHID,RTHIEN,RES
"RTN","PSOERXU2",121,0)
 S RTHID=$$GET1^DIQ(52.49,IEN,.14,"E")
"RTN","PSOERXU2",122,0)
 S RTHIEN=$$FIND1^DIC(52.49,,,RTHID,"FMID",,"RES")
"RTN","PSOERXU2",123,0)
 I 'RTHIEN,$D(RES) Q "0^Could not find related message."
"RTN","PSOERXU2",124,0)
 Q RTHIEN
"RTN","PSOERXU2",125,0)
GETREQ(IEN) ;
"RTN","PSOERXU2",126,0)
 N RTMID,RTHIEN
"RTN","PSOERXU2",127,0)
 S RTMID=$$GET1^DIQ(52.49,IEN,.02,"E")
"RTN","PSOERXU2",128,0)
 S RTHIEN=$$FIND1^DIC(52.49,,,RTMID,"CHVID",,"RES")
"RTN","PSOERXU2",129,0)
 I 'RTHIEN,$D(RES) Q "0^Could not find related message."
"RTN","PSOERXU2",130,0)
 Q RTHIEN
"RTN","PSOERXU2",131,0)
GETRESP(IEN) ;
"RTN","PSOERXU2",132,0)
 N MID,RTHIEN
"RTN","PSOERXU2",133,0)
 S MID=$$GET1^DIQ(52.49,IEN,.01,"E")
"RTN","PSOERXU2",134,0)
 S RTHIEN=$$FIND1^DIC(52.49,,,MID,"RTHID",,"RES")
"RTN","PSOERXU2",135,0)
 I 'RTHIEN,$D(RES) Q "0^Could not find related message."
"RTN","PSOERXU2",136,0)
 Q RTHIEN
"RTN","PSOERXU2",137,0)
MSGHIST(RES,IEN) ;
"RTN","PSOERXU2",138,0)
 N SIEN,RELIEN
"RTN","PSOERXU2",139,0)
 S SIEN=0
"RTN","PSOERXU2",140,0)
 F  S SIEN=$O(^PS(52.49,IEN,201,SIEN)) Q:'SIEN  D
"RTN","PSOERXU2",141,0)
 .S RELIEN=$$GET1^DIQ(52.49201,SIEN_","_IEN_",",.01,"I")
"RTN","PSOERXU2",142,0)
 .S RES(RELIEN)=""
"RTN","PSOERXU2",143,0)
 Q
"RTN","PSOERXU2",144,0)
 ; REFREQ - erx refill request IEN
"RTN","PSOERXU2",145,0)
 ; REFRES - erx refill response IEN
"RTN","PSOERXU2",146,0)
 ; Determine deltas between refill request and response.
"RTN","PSOERXU2",147,0)
RRDELTA(DELTAS,REFREQ,REFRES) ;
"RTN","PSOERXU2",148,0)
 N FLDS,DONE,I,REQARY,RESARY,FLDNM,SFLDS,REQSIEN,FOUND,REQIENS,RESIENS,REQTYP,RESTYP,SFLD,SFLDS,FLDNM,SFLDNM,SREQVAL,SRESVAL
"RTN","PSOERXU2",149,0)
 N REQDAT,RESDAT,FIELD,SFIELD,FLD,REQVAL,RESVAL,RESSIEN
"RTN","PSOERXU2",150,0)
 ; first check the top level items
"RTN","PSOERXU2",151,0)
 S FLDS=".04;2.1;2.3"
"RTN","PSOERXU2",152,0)
 S DONE=0
"RTN","PSOERXU2",153,0)
 F I=1:1 D  Q:DONE
"RTN","PSOERXU2",154,0)
 .S FLD=$P(FLDS,";",I) I FLD="" S DONE=1 Q
"RTN","PSOERXU2",155,0)
 .S REQVAL=$$GET1^DIQ(52.49,REFREQ,FLD,"E")
"RTN","PSOERXU2",156,0)
 .S RESVAL=$$GET1^DIQ(52.49,REFRES,FLD,"E")
"RTN","PSOERXU2",157,0)
 .I REQVAL=RESVAL Q
"RTN","PSOERXU2",158,0)
 .D FIELD^DID(52.49,FLD,,"LABEL","FIELD")
"RTN","PSOERXU2",159,0)
 .S FLDNM=$G(FIELD("LABEL")) Q:'$L(FLDNM)
"RTN","PSOERXU2",160,0)
 .S DELTAS(52.49,FLDNM)=REQVAL_U_RESVAL
"RTN","PSOERXU2",161,0)
 S SFLDS=".06;.07;2.1"
"RTN","PSOERXU2",162,0)
 S (REQSIEN,FOUND)=0 F  S REQSIEN=$O(^PS(52.49,REFREQ,49,REQSIEN)) Q:'REQSIEN!(FOUND)  D
"RTN","PSOERXU2",163,0)
 .S REQIENS=REQSIEN_","_REFREQ_","
"RTN","PSOERXU2",164,0)
 .S REQTYP=$$GET1^DIQ(52.4949,REQIENS,.02,"I") I REQTYP="D" D  S FOUND=1 Q
"RTN","PSOERXU2",165,0)
 ..D GETS^DIQ(52.4949,REQIENS,SFLDS,"E","REQDAT")
"RTN","PSOERXU2",166,0)
 S (RESSIEN,FOUND)=0 F  S RESSIEN=$O(^PS(52.49,REFRES,49,RESSIEN)) Q:'RESSIEN!(FOUND)  D
"RTN","PSOERXU2",167,0)
 .S RESIENS=RESSIEN_","_REFRES_","
"RTN","PSOERXU2",168,0)
 .S RESTYP=$$GET1^DIQ(52.4949,RESIENS,.02,"I") I RESTYP="D" D  S FOUND=1 Q
"RTN","PSOERXU2",169,0)
 ..D GETS^DIQ(52.4949,RESIENS,SFLDS,"E","RESDAT")
"RTN","PSOERXU2",170,0)
 S DONE=0
"RTN","PSOERXU2",171,0)
 F I=1:1 D  Q:DONE
"RTN","PSOERXU2",172,0)
 .S SFLD=$P(SFLDS,";",I) I SFLD="" S DONE=1 Q
"RTN","PSOERXU2",173,0)
 .S (SREQVAL,SRESVAL)=""
"RTN","PSOERXU2",174,0)
 .I $D(REQIENS) S SREQVAL=$G(REQDAT(52.4949,REQIENS,SFLD,"E"))
"RTN","PSOERXU2",175,0)
 .I $D(RESIENS) S SRESVAL=$G(RESDAT(52.4949,RESIENS,SFLD,"E"))
"RTN","PSOERXU2",176,0)
 .I SREQVAL=SRESVAL Q
"RTN","PSOERXU2",177,0)
 .I $D(SRESVAL),SFLD=.06 S SRESVAL=$G(SRESVAL)-1
"RTN","PSOERXU2",178,0)
 .D FIELD^DID(52.4949,SFLD,,"LABEL","SFIELD")
"RTN","PSOERXU2",179,0)
 .S SFLDNM=$G(SFIELD("LABEL")) Q:'$L(SFLDNM)
"RTN","PSOERXU2",180,0)
 .S DELTAS(52.4949,SFLDNM)=SREQVAL_U_SRESVAL
"RTN","PSOERXU2",181,0)
 Q
"RTN","PSOERXU3")
0^21^B170900975^n/a
"RTN","PSOERXU3",1,0)
PSOERXU3 ;ALB/BWF - eRx utilities ; 5/26/2017 9:57am
"RTN","PSOERXU3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**508**;DEC 1997;Build 295
"RTN","PSOERXU3",3,0)
 ;
"RTN","PSOERXU3",4,0)
 Q
"RTN","PSOERXU3",5,0)
 ; PSO*508 - Added MEDDIS, RRREQ, and RRRES linetags.
"RTN","PSOERXU3",6,0)
 ; ERXIEN - IEN FROM 52.49
"RTN","PSOERXU3",7,0)
 ; DTYPE - R for REQUESTED, or D for dispensed drugs
"RTN","PSOERXU3",8,0)
MEDDIS(ERXIEN,DTYPE,LINE) ;
"RTN","PSOERXU3",9,0)
 N DRUG,DIEN,QTY,DAYS,WDATE,EFDATE,REFILL,EXDATE,LFDATE,DIRECT,CLQ,USC,PUC,F,IENS,I,LTXT
"RTN","PSOERXU3",10,0)
 N RXIEN,RXNUM,INS,DDAT,PARIEN,OREFILL,DLOOP,DIARY
"RTN","PSOERXU3",11,0)
 N DIRARY
"RTN","PSOERXU3",12,0)
 S F=52.4949
"RTN","PSOERXU3",13,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU3",14,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"****************************MEDICATION DISPENSED****************************")
"RTN","PSOERXU3",15,0)
 S PARIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU3",16,0)
 I PARIEN S RXIEN=$$GET1^DIQ(52.49,PARIEN,.13,"I")
"RTN","PSOERXU3",17,0)
 I $G(RXIEN) S OREFILL=$$GET1^DIQ(52,RXIEN,9,"E")
"RTN","PSOERXU3",18,0)
 S I=0 F  S I=$O(^PS(52.49,ERXIEN,49,I)) Q:'I  D
"RTN","PSOERXU3",19,0)
 .S IENS=I_","_ERXIEN_","
"RTN","PSOERXU3",20,0)
 .Q:$$GET1^DIQ(F,IENS,.02,"I")'=DTYPE
"RTN","PSOERXU3",21,0)
 .D GETS^DIQ(F,IENS,"**","IE","DDAT")
"RTN","PSOERXU3",22,0)
 .S DRUG=$G(DDAT(F,IENS,.01,"E"))
"RTN","PSOERXU3",23,0)
 .S DIEN=$G(DDAT(F,IENS,.03,"I"))
"RTN","PSOERXU3",24,0)
 .S QTY=$G(DDAT(F,IENS,.04,"E"))
"RTN","PSOERXU3",25,0)
 .S DAYS=$G(DDAT(F,IENS,.05,"E"))
"RTN","PSOERXU3",26,0)
 .S REFILL=$G(DDAT(F,IENS,.06,"E"))
"RTN","PSOERXU3",27,0)
 .S DIRECT=$G(DDAT(F,IENS,1,"E"))
"RTN","PSOERXU3",28,0)
 .S WDATE=$G(DDAT(F,IENS,2.1,"E"))
"RTN","PSOERXU3",29,0)
 .S LFDATE=$G(DDAT(F,IENS,2.2,"E"))
"RTN","PSOERXU3",30,0)
 .S EXDATE=$G(DDAT(F,IENS,2.3,"E"))
"RTN","PSOERXU3",31,0)
 .S EFDATE=$G(DDAT(F,IENS,2.4,"E"))
"RTN","PSOERXU3",32,0)
 .S CLQ=$G(DDAT(F,IENS,2.5,"E"))
"RTN","PSOERXU3",33,0)
 .S USC=$G(DDAT(F,IENS,2.6,"E"))
"RTN","PSOERXU3",34,0)
 .S PUC=$G(DDAT(F,IENS,2.7,"E"))
"RTN","PSOERXU3",35,0)
 .; if there is an RX ien, reset the refills to that value - may need to adjust other fields as well
"RTN","PSOERXU3",36,0)
 .I $G(RXIEN) S REFILL=$$GET1^DIQ(52,RXIEN,9,"E")
"RTN","PSOERXU3",37,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Vista Drug: "_DRUG)
"RTN","PSOERXU3",38,0)
 .S LINE=LINE+1
"RTN","PSOERXU3",39,0)
 .D ADDITEM^PSOERX1A(.LTXT,"Vista Qty: ",$G(QTY),1,25)
"RTN","PSOERXU3",40,0)
 .D ADDITEM^PSOERX1A(.LTXT,"Vista Refills: ",$G(REFILL),27,18)
"RTN","PSOERXU3",41,0)
 .D ADDITEM^PSOERX1A(.LTXT,"Vista Days Supply: ",$G(DAYS),54,22)
"RTN","PSOERXU3",42,0)
 .D SET^VALM10(LINE,LTXT) S LTXT=""
"RTN","PSOERXU3",43,0)
 .S DIRECT="Vista Sig: "_DIRECT
"RTN","PSOERXU3",44,0)
 .D TXT2ARY^PSOERXD1(.DIRARY,DIRECT," ",75)
"RTN","PSOERXU3",45,0)
 .S DLOOP=0 F  S DLOOP=$O(DIARY(DLOOP)) Q:'DLOOP  D
"RTN","PSOERXU3",46,0)
 ..S LINE=LINE+1
"RTN","PSOERXU3",47,0)
 ..D SET^VALM10(LINE,DIRECT)
"RTN","PSOERXU3",48,0)
 I $G(RXIEN) D
"RTN","PSOERXU3",49,0)
 .S RXNUM=$$GET1^DIQ(52,RXIEN,.01,"E")
"RTN","PSOERXU3",50,0)
 .S INS=0 F  S INS=$O(^PSRX(RXIEN,"INS1",INS)) Q:'INS  D
"RTN","PSOERXU3",51,0)
 ..S LINE=LINE+1 D SET^VALM10(LINE,"Pat Inst: "_$$GET1^DIQ(52.0115,INS_","_RXIEN_",",.01,"E"))
"RTN","PSOERXU3",52,0)
 I '$L($G(RXNUM)) S RXNUM="Unable to resolve."
"RTN","PSOERXU3",53,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"VA Rx#: "_$G(RXNUM))
"RTN","PSOERXU3",54,0)
 Q
"RTN","PSOERXU3",55,0)
 ; refill request information
"RTN","PSOERXU3",56,0)
RRREQ(ERXIEN,LINE) ;
"RTN","PSOERXU3",57,0)
 N REQBY,REQDTTM,REFREQ,COMM,COMMARY,I,COMMBY,COMMDTTM,CTXT,REQIEN
"RTN","PSOERXU3",58,0)
 ; - the next line of code will actually reference the related message for retrieval of the refill request information
"RTN","PSOERXU3",59,0)
 ; - check that this is correct and test.
"RTN","PSOERXU3",60,0)
 S REQIEN=ERXIEN
"RTN","PSOERXU3",61,0)
 I $$GET1^DIQ(52.49,ERXIEN,.08,"I")="RE" S REQIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU3",62,0)
 S REQBY=$$GET1^DIQ(52.49,REQIEN,51.1,"E")
"RTN","PSOERXU3",63,0)
 S REFREQ=$$GET1^DIQ(52.49,REQIEN,51.2,"E")
"RTN","PSOERXU3",64,0)
 S REQDTTM=$$GET1^DIQ(52.49,REQIEN,.03,"E")
"RTN","PSOERXU3",65,0)
 S COMM=$$GET1^DIQ(52.49,REQIEN,50,"E")
"RTN","PSOERXU3",66,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU3",67,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"************************REFILL REQUEST INFORMATION**************************")
"RTN","PSOERXU3",68,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Requested By: "_REQBY)
"RTN","PSOERXU3",69,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Request Date/Time: "_REQDTTM)
"RTN","PSOERXU3",70,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"# of Refills Requested: "_REFREQ)
"RTN","PSOERXU3",71,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU3",72,0)
 S COMM="Refill Request Comments: "_COMM
"RTN","PSOERXU3",73,0)
 D TXT2ARY^PSOERXD1(.COMMARY,COMM," ",80)
"RTN","PSOERXU3",74,0)
 S I=0 F  S I=$O(COMMARY(I)) Q:'I  D
"RTN","PSOERXU3",75,0)
 .S CTXT=$G(COMMARY(I))
"RTN","PSOERXU3",76,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,CTXT)
"RTN","PSOERXU3",77,0)
 S COMMBY=$$GET1^DIQ(52.49,REQIEN,50.1,"E")
"RTN","PSOERXU3",78,0)
 S COMMDTTM=$$GET1^DIQ(52.49,REQIEN,50.2,"E")
"RTN","PSOERXU3",79,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Comments By: "_COMMBY)
"RTN","PSOERXU3",80,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Comments Date/Time: "_COMMDTTM)
"RTN","PSOERXU3",81,0)
 Q
"RTN","PSOERXU3",82,0)
MSGHIS(ERXIEN,LINE) ;
"RTN","PSOERXU3",83,0)
 N ERXREF,RELERX,ERXRES,I,ERXHID,FOUND,REQID,RESID,MTYPE
"RTN","PSOERXU3",84,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERXU3",85,0)
 ; refill request
"RTN","PSOERXU3",86,0)
 I MTYPE="RR"!(MTYPE="CA") S REQIEN=ERXIEN,RESIEN=$$GETRESP^PSOERXU2(ERXIEN)
"RTN","PSOERXU3",87,0)
 ; refill response
"RTN","PSOERXU3",88,0)
 I MTYPE="RE"!(MTYPE="CN") S RESIEN=ERXIEN,REQIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU3",89,0)
 I MTYPE="IE" S RESIEN=ERXIEN,REQIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU3",90,0)
 S RESID=$$GET1^DIQ(52.49,RESIEN,.01,"E")
"RTN","PSOERXU3",91,0)
 S REQID=$$GET1^DIQ(52.49,REQIEN,.01,"E")
"RTN","PSOERXU3",92,0)
 S RELERX=$$GET1^DIQ(52.49,REQIEN,.14)
"RTN","PSOERXU3",93,0)
 S FOUND=0
"RTN","PSOERXU3",94,0)
 ; BWF - consider allowing the loop to continue to the end and find all responses (can there be multiple?)
"RTN","PSOERXU3",95,0)
 S I=ERXIEN F  S I=$O(^PS(52.49,ERXIEN,201,"B",I)) Q:'I!(FOUND)  D
"RTN","PSOERXU3",96,0)
 .I $$GET1^DIQ(52.49,I,.08,"E")="RE",$$GET1^DIQ(52.49,I,.14,"E")=$$GET1^DIQ(52.49,ERXIEN,.01,"E") S ERXRES=$$GET1^DIQ(52.49,I,.14,"E"),FOUND=1
"RTN","PSOERXU3",97,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU3",98,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"*****************************MESSAGE HISTORY********************************")
"RTN","PSOERXU3",99,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Request Reference #: "_$G(REQID))
"RTN","PSOERXU3",100,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"New eRx Reference #: "_RELERX)
"RTN","PSOERXU3",101,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Response eRx Reference #: "_$G(RESID))
"RTN","PSOERXU3",102,0)
 Q
"RTN","PSOERXU3",103,0)
 ; refill response information
"RTN","PSOERXU3",104,0)
RRRES(ERXIEN,LINE) ;
"RTN","PSOERXU3",105,0)
 N RESVAL,RESNOTE,I,RESCODE,RESDTTM,RESDESC,ERXDAT,IENS,RESIEN,RECODE,RESTEXT,MTYPE,REQIEN,CODEIEN
"RTN","PSOERXU3",106,0)
 N STR1ARY,STR2ARY,J,STR1,STR2,DELTA,FN,COMM,COMMARY,COMMBY,COMMDTTM,ERESCODE
"RTN","PSOERXU3",107,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERXU3",108,0)
 I MTYPE="RE"!(MTYPE="CN") S RESIEN=ERXIEN,REQIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU3",109,0)
 I MTYPE="RR"!(MTYPE="CA") S REQIEN=ERXIEN,RESIEN=$$GETRESP^PSOERXU2(ERXIEN) Q:'RESIEN
"RTN","PSOERXU3",110,0)
 S IENS=RESIEN_","
"RTN","PSOERXU3",111,0)
 D GETS^DIQ(52.49,RESIEN,".03;.13;52.1;52.2;52.3","IE","ERXDAT")
"RTN","PSOERXU3",112,0)
 S RESVAL=$G(ERXDAT(52.49,IENS,52.1,"E"))
"RTN","PSOERXU3",113,0)
 S RESCODE=$G(ERXDAT(52.49,IENS,52.1,"I"))
"RTN","PSOERXU3",114,0)
 S RESNOTE=$G(ERXDAT(52.49,IENS,52.2,"E"))
"RTN","PSOERXU3",115,0)
 S RESDTTM=$G(ERXDAT(52.49,IENS,.03,"E"))
"RTN","PSOERXU3",116,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU3",117,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"************************REFILL RESPONSE INFORMATION**************************")
"RTN","PSOERXU3",118,0)
 S LINE=LINE+1 D SET^VALM10(LINE,RESVAL),CNTRL^VALM10(LINE,1,$L(RESVAL),IORVON,IORVOFF)
"RTN","PSOERXU3",119,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Response Date/Time: "_RESDTTM)
"RTN","PSOERXU3",120,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Note: "_RESNOTE)
"RTN","PSOERXU3",121,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU3",122,0)
 S COMM=$$GET1^DIQ(52.49,ERXIEN,50,"E")
"RTN","PSOERXU3",123,0)
 S COMM="Refill Response Comments: "_COMM
"RTN","PSOERXU3",124,0)
 D TXT2ARY^PSOERXD1(.COMMARY,COMM," ",80)
"RTN","PSOERXU3",125,0)
 S I=0 F  S I=$O(COMMARY(I)) Q:'I  D
"RTN","PSOERXU3",126,0)
 .S CTXT=$G(COMMARY(I))
"RTN","PSOERXU3",127,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,CTXT)
"RTN","PSOERXU3",128,0)
 S COMMBY=$$GET1^DIQ(52.49,ERXIEN,50.1,"E")
"RTN","PSOERXU3",129,0)
 S COMMDTTM=$$GET1^DIQ(52.49,ERXIEN,50.2,"E")
"RTN","PSOERXU3",130,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Comments By: "_COMMBY)
"RTN","PSOERXU3",131,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Comments Date/Time: "_COMMDTTM)
"RTN","PSOERXU3",132,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU3",133,0)
 S I=0 F  S I=$O(^PS(52.49,ERXIEN,55,I)) Q:'I  D 
"RTN","PSOERXU3",134,0)
 .S ERESCODE=$$GET1^DIQ(52.4955,I_","_IENS,.01,"E")
"RTN","PSOERXU3",135,0)
 .S CODEIEN=$$GET1^DIQ(52.4955,I_","_IENS,.01,"I")
"RTN","PSOERXU3",136,0)
 .S RESDESC=$$GET1^DIQ(52.45,CODEIEN,.02,"E")
"RTN","PSOERXU3",137,0)
 .S RESTEXT=RESVAL_" reason code: "_ERESCODE
"RTN","PSOERXU3",138,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,RESTEXT),CNTRL^VALM10(LINE,1,$L(RESTEXT),IORVON,IORVOFF)
"RTN","PSOERXU3",139,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Code Description: "_RESDESC)
"RTN","PSOERXU3",140,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU3",141,0)
 I RESCODE="AWC"!(RESCODE="A") D
"RTN","PSOERXU3",142,0)
 .D RRDELTA^PSOERXU2(.DELTA,REQIEN,RESIEN) Q:'$D(DELTA)
"RTN","PSOERXU3",143,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"********************************CHANGED ITEMS***********************************")
"RTN","PSOERXU3",144,0)
 .S I=0 F  S I=$O(DELTA(I)) Q:'I  D
"RTN","PSOERXU3",145,0)
 ..S FN="" F  S FN=$O(DELTA(I,FN)) Q:FN=""  D
"RTN","PSOERXU3",146,0)
 ...K STR1ARY,STR2ARY
"RTN","PSOERXU3",147,0)
 ...S LINE=LINE+1 D SET^VALM10(LINE,"Field: "_FN),CNTRL^VALM10(LINE,1,$L(FN)+7,IORVON,IORVOFF)
"RTN","PSOERXU3",148,0)
 ...S STR1="Refill Request Value  : "_$P(DELTA(I,FN),U)
"RTN","PSOERXU3",149,0)
 ...D TXT2ARY^PSOERXD1(.STR1ARY,STR1," ",78)
"RTN","PSOERXU3",150,0)
 ...S STR2="Refill Response Value : "_$P(DELTA(I,FN),U,2)
"RTN","PSOERXU3",151,0)
 ...D TXT2ARY^PSOERXD1(.STR2ARY,STR2," ",78)
"RTN","PSOERXU3",152,0)
 ...S J=0 F  S J=$O(STR1ARY(J)) Q:'J  D
"RTN","PSOERXU3",153,0)
 ....S LINE=LINE+1 D SET^VALM10(LINE,"  "_$G(STR1ARY(J)))
"RTN","PSOERXU3",154,0)
 ...S J=0 F  S J=$O(STR2ARY(J)) Q:'J  D
"RTN","PSOERXU3",155,0)
 ....S LINE=LINE+1 D SET^VALM10(LINE,"  "_$G(STR2ARY(J)))
"RTN","PSOERXU3",156,0)
 ...S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU3",157,0)
 Q
"RTN","PSOERXU3",158,0)
ERRDISP(ERXIEN,LINE) ;
"RTN","PSOERXU3",159,0)
 N ECODE,ETEXT,EDECODE,EDICODE,I,ERRDTTM
"RTN","PSOERXU3",160,0)
 S ECODE=$$GET1^DIQ(52.49,ERXIEN,60.1,"E")
"RTN","PSOERXU3",161,0)
 S ETEXT=$$GET1^DIQ(52.49,ERXIEN,60,"E")
"RTN","PSOERXU3",162,0)
 S ERRDTTM=$$GET1^DIQ(52.49,ERXIEN,.03,"E")
"RTN","PSOERXU3",163,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU3",164,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"*****************************ERROR DETAILS********************************")
"RTN","PSOERXU3",165,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Error Date/Time: "_ERRDTTM)
"RTN","PSOERXU3",166,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Code: "_ECODE)
"RTN","PSOERXU3",167,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Details: "_ETEXT)
"RTN","PSOERXU3",168,0)
 I $D(^PS(52.49,ERXIEN,61)) D
"RTN","PSOERXU3",169,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU3",170,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Description Codes")
"RTN","PSOERXU3",171,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"=================")
"RTN","PSOERXU3",172,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU3",173,0)
 S I=0 F  S I=$O(^PS(52.49,ERXIEN,61,I)) Q:'I  D
"RTN","PSOERXU3",174,0)
 .S EDECODE=$$GET1^DIQ(52.4961,I_","_ERXIEN_",",.01,"E")
"RTN","PSOERXU3",175,0)
 .S EDICODE=$$GET1^DIQ(52.4961,I_","_ERXIEN_",",.01,"I")
"RTN","PSOERXU3",176,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,EDICODE_" - "_EDECODE)
"RTN","PSOERXU3",177,0)
 Q
"RTN","PSOERXU3",178,0)
 ; displays processing errors
"RTN","PSOERXU3",179,0)
PROCERR(ERXIEN,LINE) ;
"RTN","PSOERXU3",180,0)
 N ERRIEN,ERRIENS,ERRTXT,ERRTARY
"RTN","PSOERXU3",181,0)
 ; quit if there are no processing errors
"RTN","PSOERXU3",182,0)
 Q:'$D(^PS(52.49,ERXIEN,100,"C","PX"))
"RTN","PSOERXU3",183,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU3",184,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"****************************PROCESSING ERRORS*******************************")
"RTN","PSOERXU3",185,0)
 S ERRIEN=0 F  S ERRIEN=$O(^PS(52.49,ERXIEN,100,ERRIEN)) Q:'ERRIEN  D
"RTN","PSOERXU3",186,0)
 .S ERRIENS=ERRIEN_","_ERXIEN_","
"RTN","PSOERXU3",187,0)
 .S ERRTXT=$$GET1^DIQ(52.49101,ERRIENS,1,"E")
"RTN","PSOERXU3",188,0)
 .S ERRTXT="Error Details: "_ERRTXT
"RTN","PSOERXU3",189,0)
 .D TXT2ARY^PSOERXD1(.ERRTARY,ERRTXT," ",78)
"RTN","PSOERXU3",190,0)
 .S I=0 F  S I=$O(ERRTARY(I)) Q:'I  D
"RTN","PSOERXU3",191,0)
 ..S LINE=LINE+1 D SET^VALM10(LINE,$G(ERRTARY(I)))
"RTN","PSOERXU3",192,0)
 .K ERRTXT,ERRTARY
"RTN","PSOERXU3",193,0)
 Q
"RTN","PSOERXU3",194,0)
 ; automatically DC a prescription if a denied, new prescription to follow is recieved
"RTN","PSOERXU3",195,0)
AUTODC(ERXIEN) ;
"RTN","PSOERXU3",196,0)
 N PSODFN,RXIEN,PSOLST,ORN,PSOOPT,PSOSITE,PSODIV,PSOSYS,PSODIV,PSOSYS,NERXIEN,REQIEN,ERRSEQ,VALMSG,ERXIENS,RXSTAT,PSTAT
"RTN","PSOERXU3",197,0)
 Q:'ERXIEN
"RTN","PSOERXU3",198,0)
 S ERXIENS=ERXIEN_","
"RTN","PSOERXU3",199,0)
 ; get the RXIEN
"RTN","PSOERXU3",200,0)
 S REQIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU3",201,0)
 I REQIEN S NERXIEN=$$RESOLV^PSOERXU2(REQIEN)
"RTN","PSOERXU3",202,0)
 Q:'$P(NERXIEN,U)
"RTN","PSOERXU3",203,0)
 S RXIEN=$$GET1^DIQ(52.49,NERXIEN,.13,"I") Q:RXIEN=""
"RTN","PSOERXU3",204,0)
 ;S PENDIEN=$$GET1^DIQ(52.49,NERXIEN,.1,"E")
"RTN","PSOERXU3",205,0)
 ; if already DC'd, do not try to DC again
"RTN","PSOERXU3",206,0)
 S RXSTAT=$$GET1^DIQ(52,RXIEN,100,"I")
"RTN","PSOERXU3",207,0)
 I (RXSTAT=12)!(RXSTAT=14)!(RXSTAT=15) D  Q
"RTN","PSOERXU3",208,0)
 .S ERRSEQ=$$ERRSEQ^PSOERXU1(ERXIEN) Q:'ERRSEQ
"RTN","PSOERXU3",209,0)
 .S VALMSG="eRx auto-discontinue failed. Prescription is already discontinued."
"RTN","PSOERXU3",210,0)
 .D FILERR^PSOERXU1(ERXIENS,ERRSEQ,"PX","V",$G(VALMSG))
"RTN","PSOERXU3",211,0)
 .I REQIEN,$$GET1^DIQ(52.49,REQIEN,1,"E")'="RRR" D UPDSTAT^PSOERXU1(REQIEN,"RRR",$G(VALMSG))
"RTN","PSOERXU3",212,0)
 .D UPDSTAT^PSOERXU1(ERXIEN,"RXF",$G(VALMSG))
"RTN","PSOERXU3",213,0)
 S PSOSITE=$$GET1^DIQ(52,RXIEN,20,"I")
"RTN","PSOERXU3",214,0)
 S PSOSYS=$G(^PS(59.7,1,40.1)) Q:PSOSYS=""
"RTN","PSOERXU3",215,0)
 ; FUTURE ENHANCEMENT/CONSIDERATION- SET PSODIV - PSODIV IS 0 in the test account. need to determine what it is set to.
"RTN","PSOERXU3",216,0)
 S PSODFN=$$GET1^DIQ(52,RXIEN,2,"I") Q:'PSODFN
"RTN","PSOERXU3",217,0)
 ; ORN is set to 1 since we are only building one item into the list. this makes the dc function use PSOLST(ORN)
"RTN","PSOERXU3",218,0)
 ; or PSOLST(1)
"RTN","PSOERXU3",219,0)
 S PSOLST(1)=52_U_RXIEN_U_$$GET1^DIQ(52,RXIEN,100,"E")
"RTN","PSOERXU3",220,0)
 S ORN=1
"RTN","PSOERXU3",221,0)
 ; PSODIV, PSOSITE, AND PSOSYS are used by LMNO^PSOCAN and DIV^PSOCAN - consider setting these if possible 
"RTN","PSOERXU3",222,0)
 ; PSOOPT is checked against a value of 3. find out if we need to set this to a certain value before calling psocan3
"RTN","PSOERXU3",223,0)
 S PSOOPT=0
"RTN","PSOERXU3",224,0)
 D OERR^PSOCAN3(NERXIEN)
"RTN","PSOERXU3",225,0)
 S PSTAT=$$GET1^DIQ(52,RXIEN,100,"I")
"RTN","PSOERXU3",226,0)
 I PSTAT<12!(PSTAT>15) D  Q
"RTN","PSOERXU3",227,0)
 .I '$L($G(VALMSG)) S VALMSG="eRx auto-discontinue failed."
"RTN","PSOERXU3",228,0)
 .D UPDSTAT^PSOERXU1(ERXIEN,"RXF",$G(VALMSG))
"RTN","PSOERXU3",229,0)
 .I REQIEN,$$GET1^DIQ(52.49,REQIEN,.08,"I")'="RRR" D UPDSTAT^PSOERXU1(REQIEN,"RRR",$G(VALMSG))
"RTN","PSOERXU3",230,0)
 .S ERRSEQ=$$ERRSEQ^PSOERXU1(ERXIEN) Q:'ERRSEQ
"RTN","PSOERXU3",231,0)
 .D FILERR^PSOERXU1(ERXIENS,ERRSEQ,"PX","V",$G(VALMSG))
"RTN","PSOERXU3",232,0)
 D UPDSTAT^PSOERXU1(ERXIEN,"RXD")
"RTN","PSOERXU3",233,0)
 I REQIEN D UPDSTAT^PSOERXU1(REQIEN,"RRP")
"RTN","PSOERXU3",234,0)
 Q
"RTN","PSOERXU3",235,0)
 ; screen out options that do not apply to refill request or refill response
"RTN","PSOERXU3",236,0)
RRRESCR(ERXIEN,OPT) ;
"RTN","PSOERXU3",237,0)
 N MTYPE,REFREQ,REFRES,OK,DELTAS
"RTN","PSOERXU3",238,0)
 S OK=1
"RTN","PSOERXU3",239,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERXU3",240,0)
 I MTYPE="RR"!(MTYPE="CA")!(MTYPE="CN") S OK=0 Q OK
"RTN","PSOERXU3",241,0)
 ; if this is a refill response, and we are screening the provider action
"RTN","PSOERXU3",242,0)
 I MTYPE="RE" D  Q OK
"RTN","PSOERXU3",243,0)
 .; if opt is not passed, this is PSO ERX VALIDATE PATIENT
"RTN","PSOERXU3",244,0)
 .I '$D(OPT) S OK=0 Q
"RTN","PSOERXU3",245,0)
 .I $$GET1^DIQ(52.49,ERXIEN,52.1,"I")["D" S OK=0 Q
"RTN","PSOERXU3",246,0)
 .I "RXP,RXC,RXF"[$$GET1^DIQ(52.49,ERXIEN,1,"E") S OK=0 Q
"RTN","PSOERXU3",247,0)
 .S REFRES=ERXIEN,REFREQ=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU3",248,0)
 .I 'REFREQ!('REFRES) S OK=0 Q
"RTN","PSOERXU3",249,0)
 .D RRDELTA^PSOERXU2(.DELTAS,REFREQ,REFRES)
"RTN","PSOERXU3",250,0)
 .I OPT="PROVIDER",$D(DELTAS(52.49,"EXTERNAL PROVIDER")),'$$GET1^DIQ(52.49,ERXIEN,.13,"I") S OK=1
"RTN","PSOERXU3",251,0)
 .; if there were changes to the provider, user will need to revalidate and accept
"RTN","PSOERXU3",252,0)
 .; only unlock if there were deltas on the provider and the provider has been validated on this message
"RTN","PSOERXU3",253,0)
 .I OPT="ACCEPT",'$D(DELTAS(52.49,"EXTERNAL PROVIDER")) S OK=0 Q
"RTN","PSOERXU3",254,0)
 .I OPT="ACCEPT",$D(DELTAS(52.49,"EXTERNAL PROVIDER")),$$GET1^DIQ(52.49,ERXIEN,1.3,"I"),'$$GET1^DIQ(52.49,ERXIEN,.13,"I") S OK=1
"RTN","PSOERXU3",255,0)
 .; if changes are in the drug segment only, no validations or other pharmacist actions needed
"RTN","PSOERXU3",256,0)
 .I OPT="DRUG" S OK=0
"RTN","PSOERXU3",257,0)
 I MTYPE="RE",OPT="DRUG" S OK=0 Q OK
"RTN","PSOERXU3",258,0)
 ;I "RERR"[$$GET1^DIQ(52.49,ERXIEN,.08,"I") Q 0
"RTN","PSOERXU3",259,0)
 Q OK
"RTN","PSOERXU3",260,0)
 ;
"RTN","PSOERXU3",261,0)
 ;Process refill response into pending outpatient orders
"RTN","PSOERXU3",262,0)
PREFRES(PSOIEN,PSOHY,PSOEXCNT,PSOEXMS,PSODAT) ;
"RTN","PSOERXU3",263,0)
 N REQIEN,ORXIEN,PROVIEN,VADRG,PRMVAL,DMVAL,PMVAL,RXIEN,RESTYPE,DELTA,PSOIENS
"RTN","PSOERXU3",264,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERXU3",265,0)
 ; first check all 3 validations on the refill response
"RTN","PSOERXU3",266,0)
 S RESTYPE=$$GET1^DIQ(52.49,PSOIEN,52.1,"I")
"RTN","PSOERXU3",267,0)
 S REQIEN=$$RESOLV^PSOERXU2(PSOIEN) I REQIEN S ORXIEN=$$RESOLV^PSOERXU2(REQIEN)
"RTN","PSOERXU3",268,0)
 I '$G(ORXIEN) S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Could not resolve original eRx. Cannot process response." Q
"RTN","PSOERXU3",269,0)
 S RXIEN=$$GET1^DIQ(52.49,ORXIEN,.13,"I") I 'RXIEN S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Could not resolve original eRx. Cannot process response." Q
"RTN","PSOERXU3",270,0)
 ; for approved response types, rebuild PSOHY and quit, using original Rx for all fields except written date and # of refills
"RTN","PSOERXU3",271,0)
 I RESTYPE="A" D PSOHY(.PSOHY,PSOIEN,ORXIEN,RXIEN) Q
"RTN","PSOERXU3",272,0)
 ; process 'approved with changes' response types
"RTN","PSOERXU3",273,0)
 ; FUTURE CONSIDERATION - if the patient on the response is not the same as the patient on the original Rx, we need to quit and log an error
"RTN","PSOERXU3",274,0)
 ;I $$GET1^DIQ(52.49,PSOIEN,.04,"I")'=$$GET1^DIQ(52.49,ORXIEN,.04,"I") S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="External Patient mismatch. Cannot process response." Q
"RTN","PSOERXU3",275,0)
 ; if this refill response has any validations/linkages, use them. Otherwise, use the validations/linkages from the original (new) rx.
"RTN","PSOERXU3",276,0)
 D RRDELTA^PSOERXU2(.DELTA,REQIEN,PSOIEN)
"RTN","PSOERXU3",277,0)
 S PROVIEN=""
"RTN","PSOERXU3",278,0)
 I $D(DELTA(52.49,"EXTERNAL PROVIDER")) D
"RTN","PSOERXU3",279,0)
 .S PROVIEN=$G(PSODAT(F,PSOIENS,2.3,"I")) ; response message provider IEN
"RTN","PSOERXU3",280,0)
 .I 'PROVIEN S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Provider not linked. Cannot process renewal request." Q
"RTN","PSOERXU3",281,0)
 .; if the provider or drug has been linked, then a change has occured in one of those segments, so they must be validated
"RTN","PSOERXU3",282,0)
 .S PRMVAL=$G(PSODAT(F,PSOIENS,1.3,"I")) I 'PRMVAL S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Provider not validated. Cannot process renewal request." Q
"RTN","PSOERXU3",283,0)
 Q:$O(PSOEXMS(0))
"RTN","PSOERXU3",284,0)
 D PSOHY(.PSOHY,PSOIEN,ORXIEN,RXIEN,PROVIEN) Q
"RTN","PSOERXU3",285,0)
 Q
"RTN","PSOERXU3",286,0)
 ; ERXIEN - refill response IEN from 52.49
"RTN","PSOERXU3",287,0)
 ; ORXIEN - newRx IEN from 52.49
"RTN","PSOERXU3",288,0)
 ; RXIEN - prescription entry from file #52
"RTN","PSOERXU3",289,0)
 ; PROVOVR - provider override, when approved with changes included a change to the provider
"RTN","PSOERXU3",290,0)
PSOHY(PSOHY,ERXIEN,ORXIEN,RXIEN,PROVOVR) ;
"RTN","PSOERXU3",291,0)
 N RXDAT,ERXRFLS,ERXWDATE,LOC,ERXNUM,RXIENS,VAROUT,PROVIEN,EFFDT,VAOI,VADRUG,VAREF,PATIEN,VAPRIOR,ORDERTYP,VADAYS,VQTY
"RTN","PSOERXU3",292,0)
 N WRITDT,SLOOP,SCNT,SLOOP2
"RTN","PSOERXU3",293,0)
 S RXIENS=RXIEN_","
"RTN","PSOERXU3",294,0)
 S ERXNUM=$$GET1^DIQ(52.49,ERXIEN,.01,"E")
"RTN","PSOERXU3",295,0)
 D GETS^DIQ(52,RXIEN,"**","IE","RXDAT")
"RTN","PSOERXU3",296,0)
 S LOC=$G(RXDAT(52,RXIENS,5,"I"))
"RTN","PSOERXU3",297,0)
 S VAROUT=$G(RXDAT(52,RXIENS,11,"I"))
"RTN","PSOERXU3",298,0)
 S PROVIEN=$S($G(PROVOVR):PROVOVR,1:$G(RXDAT(52,RXIENS,4,"I")))
"RTN","PSOERXU3",299,0)
 ; effective date CANNOT be null.. make sure it is set to something. written date is the first fall back, then todays date
"RTN","PSOERXU3",300,0)
 S EFFDT=$$GET1^DIQ(52.49,ERXIEN,6.3,"I") I 'EFFDT S EFFDT=$$GET1^DIQ(52.49,ERXIEN,5.9,"I")
"RTN","PSOERXU3",301,0)
 I 'EFFDT S EFFDT=DT
"RTN","PSOERXU3",302,0)
 S VAOI=$G(RXDAT(52,RXIENS,39.2,"I"))
"RTN","PSOERXU3",303,0)
 S VQTY=$G(RXDAT(52,RXIENS,7,"E"))
"RTN","PSOERXU3",304,0)
 S VADRUG=$G(RXDAT(52,RXIENS,6,"I"))
"RTN","PSOERXU3",305,0)
 ; always decrement 1 from # of refills, because refills is actually total # of fills.
"RTN","PSOERXU3",306,0)
 S VAREF=$$GET1^DIQ(52.49,ERXIEN,5.6,"E")
"RTN","PSOERXU3",307,0)
 I VAREF>0 S VAREF=VAREF-1
"RTN","PSOERXU3",308,0)
 S PATIEN=$G(RXDAT(52,RXIENS,2,"I"))
"RTN","PSOERXU3",309,0)
 ; for now, set priority to routine
"RTN","PSOERXU3",310,0)
 S VAPRIOR="R"
"RTN","PSOERXU3",311,0)
 S VADAYS=$G(RXDAT(52,RXIENS,8,"E"))
"RTN","PSOERXU3",312,0)
 S WRITDT=$$GET1^DIQ(52.49,ERXIEN,5.9,"I")
"RTN","PSOERXU3",313,0)
 S ORDERTYP="RNW"
"RTN","PSOERXU3",314,0)
 S PSOHY("PREVORD")=RXIEN
"RTN","PSOERXU3",315,0)
 S PSOHY("LOC")=LOC,PSOHY("CHNUM")=$G(ERXNUM)
"RTN","PSOERXU3",316,0)
 S PSOHY("PICK")=VAROUT,PSOHY("ENTER")=PROVIEN
"RTN","PSOERXU3",317,0)
 S PSOHY("PROV")=PROVIEN,PSOHY("SDT")=EFFDT
"RTN","PSOERXU3",318,0)
 S PSOHY("ITEM")=VAOI,PSOHY("DRUG")=VADRUG
"RTN","PSOERXU3",319,0)
 S PSOHY("QTY")=VQTY,PSOHY("REF")=VAREF
"RTN","PSOERXU3",320,0)
 ; DFN cannot be newed/killed here because it needs to exist for the subsequent call.
"RTN","PSOERXU3",321,0)
 S (PSOHY("PAT"),DFN)=PATIEN,PSOHY("OCC")=ORDERTYP
"RTN","PSOERXU3",322,0)
 ; login date will always be the written date. if there is no written date by chance, use the received date
"RTN","PSOERXU3",323,0)
 ;S PSOHY("EDT")=$S(WRITDT'="":$P(WRITDT,"."),1:$P($$GET1^DIQ(52.49,PSOIEN,.03,"I"),"."))
"RTN","PSOERXU3",324,0)
 S PSOHY("EDT")=DT,PSOHY("PRIOR")=VAPRIOR
"RTN","PSOERXU3",325,0)
 ; ALWAYS PSO as the external application
"RTN","PSOERXU3",326,0)
 S PSOHY("EXAPP")="PHARMACY"
"RTN","PSOERXU3",327,0)
 S PSOHY("DAYS")=VADAYS
"RTN","PSOERXU3",328,0)
 ; sig from eRx - not needed for rewewal - leave logic here as it may be needed for change response
"RTN","PSOERXU3",329,0)
 ;S (SLOOP,SCNT)=0 F  S SLOOP=$O(^PS(52.49,PSOIEN,"SIG",SLOOP)) Q:'SLOOP  D
"RTN","PSOERXU3",330,0)
 ;.S SIGDAT=$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0))
"RTN","PSOERXU3",331,0)
 ;.S SCNT=SCNT+1,PSOHY("SIG",SCNT)=SIGDAT
"RTN","PSOERXU3",332,0)
 ;S SLOOP2=0 F  S SLOOP2=$O(PINARY(SLOOP2)) Q:'SLOOP2  D
"RTN","PSOERXU3",333,0)
 ;.S SCNT=SCNT+1,PSOHY("SIG",SCNT)=$G(PINARY(SLOOP2))
"RTN","PSOERXU3",334,0)
 Q
"RTN","PSOERXU4")
0^37^B33741259^B35485114
"RTN","PSOERXU4",1,0)
PSOERXU4 ;ALB/BLB - eRx utilities ; 2/21/2018 4:00pm
"RTN","PSOERXU4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**520,508**;DEC 1997;Build 295
"RTN","PSOERXU4",3,0)
 ;
"RTN","PSOERXU4",4,0)
 Q
"RTN","PSOERXU4",5,0)
DERX1(PSOIEN,PSOIENS,DFLG) ;
"RTN","PSOERXU4",6,0)
 N EDRG,ERXDAT,ESIG,COMM,SUBS,DFORM,DSTR,QQUAL,POTUC,QTY,DAYS,REFILL,COMMARY,SIGARY,ERXRFLS,I
"RTN","PSOERXU4",7,0)
 D GETS^DIQ(52.49,PSOIENS,"3.1;4.6;4.8;5.1;5.2;5.4;5.5;5.6;5.7;5.8;7;8;41;42;43","E","ERXDAT")
"RTN","PSOERXU4",8,0)
 S DFLG=$G(DFLG,"")
"RTN","PSOERXU4",9,0)
 S EDRG=$G(ERXDAT(52.49,PSOIENS,3.1,"E"))
"RTN","PSOERXU4",10,0)
 S ESIG=$G(ERXDAT(52.49,PSOIENS,7,"E"))
"RTN","PSOERXU4",11,0)
 S COMM=$G(ERXDAT(52.49,PSOIENS,8,"E"))
"RTN","PSOERXU4",12,0)
 S SUBS=$G(ERXDAT(52.49,PSOIENS,5.8,"E"))
"RTN","PSOERXU4",13,0)
 S DFORM=$G(ERXDAT(52.49,PSOIENS,41,"E"))
"RTN","PSOERXU4",14,0)
 S DSTR=$G(ERXDAT(52.49,PSOIENS,43,"E"))
"RTN","PSOERXU4",15,0)
 S QQUAL=$G(ERXDAT(52.49,PSOIENS,5.2,"E"))
"RTN","PSOERXU4",16,0)
 S POTUC=$G(ERXDAT(52.49,PSOIENS,42,"E"))
"RTN","PSOERXU4",17,0)
 S QTY=$G(ERXDAT(52.49,PSOIENS,5.1,"E"))
"RTN","PSOERXU4",18,0)
 S DAYS=$G(ERXDAT(52.49,PSOIENS,5.5,"E"))
"RTN","PSOERXU4",19,0)
 S REFILL=$G(ERXDAT(52.49,PSOIENS,5.6,"E"))
"RTN","PSOERXU4",20,0)
 I REFILL="" D
"RTN","PSOERXU4",21,0)
 .S REFILL=$G(ERXDAT(52.49,PSOIENS,5.7,"I"))
"RTN","PSOERXU4",22,0)
 D TXT2ARY^PSOERXD1(.SIGARY,ESIG,,69)
"RTN","PSOERXU4",23,0)
 D TXT2ARY^PSOERXD1(.COMMARY,COMM,,65)
"RTN","PSOERXU4",24,0)
 W !!!,"eRx Drug: "_EDRG
"RTN","PSOERXU4",25,0)
 W !,"eRx Sig: "
"RTN","PSOERXU4",26,0)
 S I=0 F  S I=$O(SIGARY(I)) Q:'I  D
"RTN","PSOERXU4",27,0)
 .W $S(I>1:"         "_SIGARY(I),1:SIGARY(I)),!
"RTN","PSOERXU4",28,0)
 I '$L(ESIG) W !
"RTN","PSOERXU4",29,0)
 W "eRx Notes: "
"RTN","PSOERXU4",30,0)
 S I=0 F  S I=$O(COMMARY(I)) Q:'I  D
"RTN","PSOERXU4",31,0)
 .W $S(I>1:"              "_COMMARY(I),1:COMMARY(I)),!
"RTN","PSOERXU4",32,0)
 I '$L(COMM) W !
"RTN","PSOERXU4",33,0)
 Q:DFLG=1
"RTN","PSOERXU4",34,0)
 W "Drug Form: "_DFORM,?40,"Strength: "_DSTR
"RTN","PSOERXU4",35,0)
 W !,"Qty Qualifier: "_QQUAL,?40,"Potency Unit Code: "_POTUC
"RTN","PSOERXU4",36,0)
 W !,"DAW Code: "_SUBS
"RTN","PSOERXU4",37,0)
 W !,"Qty: "_QTY,?25,"Days Supply: "_DAYS,?55,"Refills: "_REFILL,!!
"RTN","PSOERXU4",38,0)
 Q
"RTN","PSOERXU4",39,0)
REM ;
"RTN","PSOERXU4",40,0)
 N DIR,Y,PSSRET,PSOIENS,REMIEN,REMSTA,REMTXT,ERXRMIEN,DIC,X,RXSTAT
"RTN","PSOERXU4",41,0)
 D FULL^VALM1
"RTN","PSOERXU4",42,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERXU4",43,0)
 S VALMBCK="R"
"RTN","PSOERXU4",44,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERXU4",45,0)
 .W !!,"Cannot remove a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERXU4",46,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERXU4",47,0)
 S DIR(0)="YO",DIR("A")="Would you like to 'Remove' eRx #"_$$GET1^DIQ(52.49,PSOIEN,.01,"E"),DIR("B")="Y" D ^DIR K DIR
"RTN","PSOERXU4",48,0)
 Q:'Y
"RTN","PSOERXU4",49,0)
 S DIC="^PS(52.45,",DIC(0)="AEMQ",DIC("S")="I $D(^PS(52.45,""TYPE"",""REM"",Y))",DIC("A")="Select REMOVAL reason code: "
"RTN","PSOERXU4",50,0)
 D ^DIC K DIC
"RTN","PSOERXU4",51,0)
 I $P(Y,U)<1 W !,"Removal reason code required!" S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXU4",52,0)
 S REMIEN=$P(Y,U),REMSTA=$P(Y,U,2)
"RTN","PSOERXU4",53,0)
 K X,Y S DIR(0)="FO^1:70",DIR("A")="Additional Comments (Optional)" D ^DIR K DIR
"RTN","PSOERXU4",54,0)
 Q:Y="^"
"RTN","PSOERXU4",55,0)
 S REMTXT=Y
"RTN","PSOERXU4",56,0)
 S FDA(52.4919,"+1,"_PSOIENS,.01)=$$NOW^XLFDT,FDA(52.4919,"+1,"_PSOIENS,.02)=REMIEN
"RTN","PSOERXU4",57,0)
 S FDA(52.4919,"+1,"_PSOIENS,.03)=DUZ,FDA(52.4919,"+1,"_PSOIENS,1)=REMTXT
"RTN","PSOERXU4",58,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXU4",59,0)
 ; SET THE ERX STATUS TO THE REMOVAL REASON
"RTN","PSOERXU4",60,0)
 D UPDSTAT^PSOERXU1(PSOIEN,"RM")
"RTN","PSOERXU4",61,0)
 Q
"RTN","PSOERXU4",62,0)
 ; reject eRx
"RTN","PSOERXU4",63,0)
REJ ;
"RTN","PSOERXU4",64,0)
 N DIR,DIC,Y,PSSRET,PSOIENS,REMTXT,REJSTA,FULLTXT,ERXRJIEN,REJDESC,REJIEN,REJTXT,X,RXSTAT
"RTN","PSOERXU4",65,0)
 D FULL^VALM1
"RTN","PSOERXU4",66,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERXU4",67,0)
 S VALMBCK="R"
"RTN","PSOERXU4",68,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERXU4",69,0)
 .W !!,"Cannot reject a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERXU4",70,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERXU4",71,0)
 S DIR(0)="YO",DIR("A")="Would you like to 'Reject' eRx #"_$$GET1^DIQ(52.49,PSOIEN,.01,"E"),DIR("B")="Y" D ^DIR K DIR
"RTN","PSOERXU4",72,0)
 Q:'Y
"RTN","PSOERXU4",73,0)
 S DIC="^PS(52.45,",DIC(0)="AEMQ",DIC("S")="I $D(^PS(52.45,""TYPE"",""REJ"",Y))",DIC("A")="Select REJECT reason code: "
"RTN","PSOERXU4",74,0)
 D ^DIC K DIC
"RTN","PSOERXU4",75,0)
 I $P(Y,U)<1 W !,"Reject reason required! eRx NOT rejected." S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXU4",76,0)
 S REJIEN=$P(Y,U),REJSTA=$P(Y,U,2)
"RTN","PSOERXU4",77,0)
 K X,Y,DIR
"RTN","PSOERXU4",78,0)
 S DIR(0)="FO^1:70",DIR("A")="Additional Comments (Optional)" D ^DIR K DIR
"RTN","PSOERXU4",79,0)
 Q:Y="^"
"RTN","PSOERXU4",80,0)
 ; if reject reason was entered, log the activity.
"RTN","PSOERXU4",81,0)
 S REJTXT=Y
"RTN","PSOERXU4",82,0)
 S REJDESC=$$GET1^DIQ(52.45,REJIEN,.02,"E")
"RTN","PSOERXU4",83,0)
 S FULLTXT=REJSTA_"-"_REJDESC
"RTN","PSOERXU4",84,0)
 D POST^PSOERXO1(PSOIEN,.PSSRET,900,"",$E(FULLTXT,1,70))
"RTN","PSOERXU4",85,0)
 ; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERXU4",86,0)
 I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXU4",87,0)
 I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXU4",88,0)
 W !!,"Rejection message sent." S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXU4",89,0)
 ; if post is successful, change the eRx status and log the status activity.
"RTN","PSOERXU4",90,0)
 S FDA(52.4919,"+1,"_PSOIENS,.01)=$$NOW^XLFDT
"RTN","PSOERXU4",91,0)
 S FDA(52.4919,"+1,"_PSOIENS,.02)=REJIEN
"RTN","PSOERXU4",92,0)
 S FDA(52.4919,"+1,"_PSOIENS,.03)=DUZ
"RTN","PSOERXU4",93,0)
 S FDA(52.4919,"+1,"_PSOIENS,1)=REJTXT
"RTN","PSOERXU4",94,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXU4",95,0)
 ; SET THE ERX STATUS TO THE REJECT REASON
"RTN","PSOERXU4",96,0)
 D UPDSTAT^PSOERXU1(PSOIEN,"RJ")
"RTN","PSOERXU4",97,0)
 Q
"RTN","PSOERXU4",98,0)
 ;/BLB/ - BEGIN CHANGE - EDIT IN VD
"RTN","PSOERXU4",99,0)
QTYDSRFL(ERXIEN,EDTYP) ;
"RTN","PSOERXU4",100,0)
 ; ERXIEN - ien from 52.49
"RTN","PSOERXU4",101,0)
 ; EDTYP:
"RTN","PSOERXU4",102,0)
 ;        1 - DAYS SUPPLY
"RTN","PSOERXU4",103,0)
 ;        2 - QUANTITY
"RTN","PSOERXU4",104,0)
 ;        3 - REFILLS
"RTN","PSOERXU4",105,0)
 N PSODRUG,PSODIR,ERXDRUG,PSODFN,ERXIENS,FDA,CLOZPAT,PSOY,PATSTAT,Y,DONE,DIR,ANS
"RTN","PSOERXU4",106,0)
 S ERXIENS=ERXIEN_","
"RTN","PSOERXU4",107,0)
 ; setup drug array
"RTN","PSOERXU4",108,0)
 S ERXDRUG=$$GET1^DIQ(52.49,ERXIEN,3.2,"I") Q:'ERXDRUG 0
"RTN","PSOERXU4",109,0)
 S PSOY=ERXDRUG,PSOY(0)=$G(^PSDRUG(ERXDRUG,0))
"RTN","PSOERXU4",110,0)
 D SET^PSODRG
"RTN","PSOERXU4",111,0)
 S PSODRG=ERXDRUG
"RTN","PSOERXU4",112,0)
 ; set quanity, days supply, refill, and patient information
"RTN","PSOERXU4",113,0)
 S PSODFN=$$GET1^DIQ(52.49,ERXIEN,.05,"I")
"RTN","PSOERXU4",114,0)
 S PSODIR("QTY")=$$GET1^DIQ(52.49,ERXIEN,20.1,"E")
"RTN","PSOERXU4",115,0)
 S PSODIR("DAYS SUPPLY")=$$GET1^DIQ(52.49,ERXIEN,20.2,"E")
"RTN","PSOERXU4",116,0)
 S PSODIR("# OF REFILLS")=$$GET1^DIQ(52.49,ERXIEN,20.5,"E")
"RTN","PSOERXU4",117,0)
 S PSODIR("PATIENT STATUS")=$P(^PS(55,PSODFN,"PS"),U)
"RTN","PSOERXU4",118,0)
 S PSODIR("DFLG")=0
"RTN","PSOERXU4",119,0)
 S PATSTAT=$$GET1^DIQ(55,PSODFN,3,"E")
"RTN","PSOERXU4",120,0)
 I '$L(PATSTAT) D
"RTN","PSOERXU4",121,0)
 .S DONE=0
"RTN","PSOERXU4",122,0)
 .F  D  Q:DONE
"RTN","PSOERXU4",123,0)
 ..W !,"This is a required response. Enter '^' to exit"
"RTN","PSOERXU4",124,0)
 ..S DIR(0)="55,3",DIR("A")="PATIENT STATUS" D ^DIR K DIR
"RTN","PSOERXU4",125,0)
 ..I +Y S DONE=1 Q
"RTN","PSOERXU4",126,0)
 ..I Y["^" S PQUIT=1,DONE=1 Q
"RTN","PSOERXU4",127,0)
 .S ANS=$P(Y,"^",1)
"RTN","PSOERXU4",128,0)
 .S FDA(55,PSODFN_",",3)=ANS
"RTN","PSOERXU4",129,0)
 .D FILE^DIE(,"FDA","ERR") K FDA,ERR
"RTN","PSOERXU4",130,0)
 S PSODIR("PTST NODE")=$G(^PS(55,PSODFN,"PS"))
"RTN","PSOERXU4",131,0)
 I $P($G(^PSDRUG(PSODRG,"CLOZ1")),"^")="PSOCLO1" D
"RTN","PSOERXU4",132,0)
 .S CLOZPAT=$O(^YSCL(603.01,"C",PSODFN,0)) Q:'CLOZPAT
"RTN","PSOERXU4",133,0)
 .S CLOZPAT=$P(^YSCL(603.01,CLOZPAT,0),"^",3)
"RTN","PSOERXU4",134,0)
 .S CLOZPAT=$S(CLOZPAT="M":2,CLOZPAT="B":1,1:0)
"RTN","PSOERXU4",135,0)
 ; once called, PSODIR will be updated with the appropriate information 
"RTN","PSOERXU4",136,0)
 ;(refills/days supply/quantity)
"RTN","PSOERXU4",137,0)
 I EDTYP=1 S PSONEW("FLD")=7 D DAYS^PSODIR1(.PSODIR)
"RTN","PSOERXU4",138,0)
 I EDTYP=2 S PSONEW("FLD")=5 D QTY^PSODIR1(.PSODIR)
"RTN","PSOERXU4",139,0)
 I EDTYP=3 S PSONEW("FLD")=8 D REFILL^PSODIR1(.PSODIR)
"RTN","PSOERXU4",140,0)
 I $G(PSODIR("DFLG"))=1 Q 1
"RTN","PSOERXU4",141,0)
 S FDA(52.49,ERXIENS,20.1)=$G(PSODIR("QTY"))
"RTN","PSOERXU4",142,0)
 S FDA(52.49,ERXIENS,20.2)=$G(PSODIR("DAYS SUPPLY"))
"RTN","PSOERXU4",143,0)
 S FDA(52.49,ERXIENS,20.5)=$G(PSODIR("# OF REFILLS"))
"RTN","PSOERXU4",144,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXU4",145,0)
 Q 0
"RTN","PSOERXU4",146,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXU5")
0^29^B64488961^n/a
"RTN","PSOERXU5",1,0)
PSOERXU5 ;ALB/BWF - eRx utilities ; 4/9/2018 10:55am
"RTN","PSOERXU5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**508**;DEC 1997;Build 295
"RTN","PSOERXU5",3,0)
 ;
"RTN","PSOERXU5",4,0)
 Q
"RTN","PSOERXU5",5,0)
CANREQ(ERXIEN,LINE,PMODE) ;
"RTN","PSOERXU5",6,0)
 N REQIEN,REQDTTM,COMM,HUBID,CANSTAT,DNB,RESTYPE,COMM,COMMARY,COMMBY,COMMDTTM,CTXT,I,REQBY
"RTN","PSOERXU5",7,0)
 ; - the next line of code will actually reference the related message for retrieval of the cancel request information
"RTN","PSOERXU5",8,0)
 ; - check that this is correct and test.
"RTN","PSOERXU5",9,0)
 S REQIEN=ERXIEN
"RTN","PSOERXU5",10,0)
 I $$GET1^DIQ(52.49,ERXIEN,.08,"I")="CN" S REQIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU5",11,0)
 I '$$FINDNRX^PSOERXU6(REQIEN) S DNB=1
"RTN","PSOERXU5",12,0)
 S HUBID=$$GET1^DIQ(52.49,REQIEN,.01,"E")
"RTN","PSOERXU5",13,0)
 S REQBY=$$GET1^DIQ(52.49,REQIEN,2.1,"E")
"RTN","PSOERXU5",14,0)
 S REQDTTM=$$GET1^DIQ(52.49,REQIEN,.03,"E")
"RTN","PSOERXU5",15,0)
 ;S DNB=$$GET1^DIQ(52.49,REQIEN,80.5,"I")
"RTN","PSOERXU5",16,0)
 S COMM=$$GET1^DIQ(52.49,REQIEN,50,"E")
"RTN","PSOERXU5",17,0)
 S RESTYPE=$$GET1^DIQ(52.49,REQIEN,52.1,"E")
"RTN","PSOERXU5",18,0)
 S CANSTAT=$$GET1^DIQ(52.49,REQIEN,1,"I")
"RTN","PSOERXU5",19,0)
 S CANSTAT=$$GET1^DIQ(52.45,CANSTAT,.02,"E")
"RTN","PSOERXU5",20,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU5",21,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"************************CANCEL REQUEST INFORMATION**************************")
"RTN","PSOERXU5",22,0)
 I '$G(PMODE) S LINE=LINE+1 D SET^VALM10(LINE,RESTYPE),CNTRL^VALM10(LINE,1,$L(RESTYPE),IORVON,IORVOFF)
"RTN","PSOERXU5",23,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Request Status: "_CANSTAT)
"RTN","PSOERXU5",24,0)
 I $L(RESTYPE) S LINE=LINE+1 D SET^VALM10(LINE,"Request/Response Type: "_RESTYPE)
"RTN","PSOERXU5",25,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Requested By: "_REQBY)
"RTN","PSOERXU5",26,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Request Date/Time: "_REQDTTM)
"RTN","PSOERXU5",27,0)
 I $G(DNB) S LINE=LINE+1 D SET^VALM10(LINE,"Original eRx not found in Hub and/or in Vista.")
"RTN","PSOERXU5",28,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU5",29,0)
 S COMM=$$GET1^DIQ(52.49,REQIEN,50,"E")
"RTN","PSOERXU5",30,0)
 S COMM="Request Comments: "_COMM
"RTN","PSOERXU5",31,0)
 D TXT2ARY^PSOERXD1(.COMMARY,COMM," ",80)
"RTN","PSOERXU5",32,0)
 S I=0 F  S I=$O(COMMARY(I)) Q:'I  D
"RTN","PSOERXU5",33,0)
 .S CTXT=$G(COMMARY(I))
"RTN","PSOERXU5",34,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,CTXT)
"RTN","PSOERXU5",35,0)
 S COMMBY=$$GET1^DIQ(52.49,REQIEN,50.1,"E")
"RTN","PSOERXU5",36,0)
 S COMMDTTM=$$GET1^DIQ(52.49,REQIEN,50.2,"E")
"RTN","PSOERXU5",37,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Comments By: "_COMMBY)
"RTN","PSOERXU5",38,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Comments Date/Time: "_COMMDTTM)
"RTN","PSOERXU5",39,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU5",40,0)
 Q
"RTN","PSOERXU5",41,0)
CANRES(ERXIEN,LINE,PMODE) ;
"RTN","PSOERXU5",42,0)
 N MTYPE,IENS,RESIEN,REQIEN,HUBID,RESVAL,RESCODE,RESNOTE,RESDTTM,CANSTAT,RESBY,COMM,COMMARY,COMMBY,COMMDTTM,ERXDAT
"RTN","PSOERXU5",43,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERXU5",44,0)
 I MTYPE="CN" S RESIEN=ERXIEN,REQIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU5",45,0)
 I MTYPE="CA" S REQIEN=ERXIEN,RESIEN=$$GETRESP^PSOERXU2(ERXIEN)
"RTN","PSOERXU5",46,0)
 I MTYPE="IE" S RESIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU5",47,0)
 S REQIEN=$$RESOLV^PSOERXU2(RESIEN)
"RTN","PSOERXU5",48,0)
 Q:'RESIEN
"RTN","PSOERXU5",49,0)
 S IENS=RESIEN_","
"RTN","PSOERXU5",50,0)
 D GETS^DIQ(52.49,RESIEN,".01;.03;1;51.1;52.1;52.2;52.3","IE","ERXDAT")
"RTN","PSOERXU5",51,0)
 S HUBID=$G(ERXDAT(52.49,IENS,.01,"E"))
"RTN","PSOERXU5",52,0)
 S RESVAL=$G(ERXDAT(52.49,IENS,52.1,"E"))
"RTN","PSOERXU5",53,0)
 S RESCODE=$G(ERXDAT(52.49,IENS,52.1,"I"))
"RTN","PSOERXU5",54,0)
 S RESNOTE=$G(ERXDAT(52.49,IENS,52.2,"E"))
"RTN","PSOERXU5",55,0)
 S RESDTTM=$G(ERXDAT(52.49,IENS,.03,"E"))
"RTN","PSOERXU5",56,0)
 S CANSTAT=$G(ERXDAT(52.49,IENS,.03,"I"))
"RTN","PSOERXU5",57,0)
 S CANSTAT=$$GET1^DIQ(52.45,CANSTAT,.02,"E")
"RTN","PSOERXU5",58,0)
 S RESBY=$G(ERXDAT(52.49,IENS,51.1,"E"))
"RTN","PSOERXU5",59,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU5",60,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"************************CANCEL RESPONSE INFORMATION**************************")
"RTN","PSOERXU5",61,0)
 I '$G(PMODE) S LINE=LINE+1 D SET^VALM10(LINE,RESVAL),CNTRL^VALM10(LINE,1,$L(RESVAL),IORVON,IORVOFF)
"RTN","PSOERXU5",62,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Response Status: "_CANSTAT)
"RTN","PSOERXU5",63,0)
 I $L(RESVAL) S LINE=LINE+1 D SET^VALM10(LINE,"Request/Response Type: "_RESVAL)
"RTN","PSOERXU5",64,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Response: "_RESNOTE)
"RTN","PSOERXU5",65,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Response by: "_RESBY)
"RTN","PSOERXU5",66,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Response Date/Time: "_RESDTTM)
"RTN","PSOERXU5",67,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU5",68,0)
 S COMM=$$GET1^DIQ(52.49,RESIEN,50,"E")
"RTN","PSOERXU5",69,0)
 S COMM="Response Comments: "_COMM
"RTN","PSOERXU5",70,0)
 D TXT2ARY^PSOERXD1(.COMMARY,COMM," ",80)
"RTN","PSOERXU5",71,0)
 S I=0 F  S I=$O(COMMARY(I)) Q:'I  D
"RTN","PSOERXU5",72,0)
 .S CTXT=$G(COMMARY(I))
"RTN","PSOERXU5",73,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,CTXT)
"RTN","PSOERXU5",74,0)
 S COMMBY=$$GET1^DIQ(52.49,RESIEN,50.1,"E")
"RTN","PSOERXU5",75,0)
 S COMMDTTM=$$GET1^DIQ(52.49,RESIEN,50.2,"E")
"RTN","PSOERXU5",76,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Comments By: "_COMMBY)
"RTN","PSOERXU5",77,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Comments Date/Time: "_COMMDTTM)
"RTN","PSOERXU5",78,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXU5",79,0)
 ;S LINE=LINE+1 D SET^VALM10(LINE,"Note: "_RESNOTE)
"RTN","PSOERXU5",80,0)
 Q
"RTN","PSOERXU5",81,0)
GETPAT(ERXIEN) ;
"RTN","PSOERXU5",82,0)
 N ERXPAT,MTYPE,REQIEN,NEWRXIEN
"RTN","PSOERXU5",83,0)
 S ERXPAT=$$GET1^DIQ(52.49,ERXIEN,.04,"I")
"RTN","PSOERXU5",84,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERXU5",85,0)
 I 'ERXPAT,"RR,CA,"[MTYPE D
"RTN","PSOERXU5",86,0)
 .S NEWRXIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU5",87,0)
 .S ERXPAT=$$GET1^DIQ(52.49,NEWRXIEN,.04,"I")
"RTN","PSOERXU5",88,0)
 I 'ERXPAT,"RE,CN,IE,"[MTYPE D
"RTN","PSOERXU5",89,0)
 .S REQIEN=$$RESOLV^PSOERXU2(ERXIEN) Q:'REQIEN
"RTN","PSOERXU5",90,0)
 .S ERXPAT=$$GET1^DIQ(52.49,REQIEN,.04,"I") I ERXPAT Q
"RTN","PSOERXU5",91,0)
 .S NEWRXIEN=$$RESOLV^PSOERXU2(REQIEN)
"RTN","PSOERXU5",92,0)
 .S ERXPAT=$$GET1^DIQ(52.49,NEWRXIEN,.04,"I")
"RTN","PSOERXU5",93,0)
 Q:'ERXPAT 0
"RTN","PSOERXU5",94,0)
 Q ERXPAT
"RTN","PSOERXU5",95,0)
GETPROV(ERXIEN) ;
"RTN","PSOERXU5",96,0)
 N ERXPRV,MTYPE,REQIEN,NEWRXIEN
"RTN","PSOERXU5",97,0)
 S ERXPRV=$$GET1^DIQ(52.49,ERXIEN,2.1,"I")
"RTN","PSOERXU5",98,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERXU5",99,0)
 I 'ERXPRV,"RR,CA,"[MTYPE D
"RTN","PSOERXU5",100,0)
 .S NEWRXIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU5",101,0)
 .S ERXPRV=$$GET1^DIQ(52.49,NEWRXIEN,2.1,"I")
"RTN","PSOERXU5",102,0)
 I 'ERXPRV,"RE,CN"[MTYPE D
"RTN","PSOERXU5",103,0)
 .S REQIEN=$$RESOLV^PSOERXU2(ERXIEN) Q:'REQIEN
"RTN","PSOERXU5",104,0)
 .S ERXPRV=$$GET1^DIQ(52.49,REQIEN,2.1,"I") I ERXPRV Q
"RTN","PSOERXU5",105,0)
 .S NEWRXIEN=$$RESOLV^PSOERXU2(REQIEN)
"RTN","PSOERXU5",106,0)
 .S ERXPRV=$$GET1^DIQ(52.49,NEWRXIEN,2.1,"I")
"RTN","PSOERXU5",107,0)
 Q:'ERXPRV 0
"RTN","PSOERXU5",108,0)
 Q ERXPRV
"RTN","PSOERXU5",109,0)
GETDRUG(ERXIEN) ;
"RTN","PSOERXU5",110,0)
 N ERXDRG,MTYPE,REQIEN,NEWRXIEN
"RTN","PSOERXU5",111,0)
 S ERXDRG=$$GET1^DIQ(52.49,ERXIEN,3.1,"E")
"RTN","PSOERXU5",112,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERXU5",113,0)
 I ERXDRG="","RR,CA,"[MTYPE D
"RTN","PSOERXU5",114,0)
 .S NEWRXIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU5",115,0)
 .S ERXDRG=$$GET1^DIQ(52.49,NEWRXIEN,3.1,"E")
"RTN","PSOERXU5",116,0)
 I 'ERXDRG,"RE,CN"[MTYPE D
"RTN","PSOERXU5",117,0)
 .S REQIEN=$$RESOLV^PSOERXU2(ERXIEN) Q:'REQIEN
"RTN","PSOERXU5",118,0)
 .S ERXDRG=$$GET1^DIQ(52.49,REQIEN,3.1,"I") I ERXDRG'="" Q
"RTN","PSOERXU5",119,0)
 .S NEWRXIEN=$$RESOLV^PSOERXU2(REQIEN)
"RTN","PSOERXU5",120,0)
 .S ERXDRG=$$GET1^DIQ(52.49,NEWRXIEN,3.1,"I")
"RTN","PSOERXU5",121,0)
 I ERXDRG="" Q ""
"RTN","PSOERXU5",122,0)
 Q ERXDRG
"RTN","PSOERXU5",123,0)
CANACK(ERXIEN) ;
"RTN","PSOERXU5",124,0)
 N DIR,MTYPE,ERXSTAT,INST,RESP,RESID,Y,PSSRET,DIRUT,DTOUT
"RTN","PSOERXU5",125,0)
 D FULL^VALM1 S VALMBCK="R"
"RTN","PSOERXU5",126,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERXU5",127,0)
 I MTYPE="RE"!(MTYPE="IE"),'$D(^XUSEC("PSDRPH",DUZ)),'$D(^XUSEC("PSO ERX ADV TECH",DUZ)),'$D(^XUSEC("PSO ERX TECH",DUZ)) D  Q
"RTN","PSOERXU5",128,0)
 .W !,"You do not have priviledge to use this option." D DIRE^PSOERXX1
"RTN","PSOERXU5",129,0)
 I MTYPE="CA"!(MTYPE="CN"),'$D(^XUSEC("PSDRPH",DUZ)),'$D(^XUSEC("PSO ERX ADV TECH",DUZ)) D  Q
"RTN","PSOERXU5",130,0)
 .W !,"You do not have priviledge to use this option." D DIRE^PSOERXX1
"RTN","PSOERXU5",131,0)
 S ERXSTAT=$$GET1^DIQ(52.49,ERXIEN,1,"E")
"RTN","PSOERXU5",132,0)
 I ",CAO,CAH,CAF,CAP,CAR,CAX,RXD,RRE,RXF,"'[ERXSTAT W !,"Acknowledge cannot be used on this record status." D DIRE^PSOERXX1 Q
"RTN","PSOERXU5",133,0)
 I (ERXSTAT="CAO")!(ERXSTAT="RXD")!(ERXSTAT="RRE")!(ERXSTAT="RXF") D  Q
"RTN","PSOERXU5",134,0)
 .W !,"Would you like to acknowledge this record?"
"RTN","PSOERXU5",135,0)
 .S DIR(0)="YO",DIR("B")="N" D ^DIR K DIR Q:'Y!($D(DIRUT))!($D(DTOUT))
"RTN","PSOERXU5",136,0)
 .K Y
"RTN","PSOERXU5",137,0)
 .I MTYPE="CA" D UPDSTAT^PSOERXU1(ERXIEN,"CAA")
"RTN","PSOERXU5",138,0)
 .I MTYPE="RE" D UPDSTAT^PSOERXU1(ERXIEN,"RXA")
"RTN","PSOERXU5",139,0)
 .I MTYPE="IE" D UPDSTAT^PSOERXU1(ERXIEN,"IRA")
"RTN","PSOERXU5",140,0)
 .W !,$S(MTYPE="CA":"Cancel request",MTYPE="RE":"Refill response",1:"Inbound error")," acknowledged." D DIRE^PSOERXX1
"RTN","PSOERXU5",141,0)
 .K @VALMAR D INIT^PSOERX1
"RTN","PSOERXU5",142,0)
 S INST=$$GET1^DIQ(52.49,ERXIEN,24.1,"I")
"RTN","PSOERXU5",143,0)
 W !,"Would you like to send an 'Approved' or 'Denied' response?"
"RTN","PSOERXU5",144,0)
 K DIR S DIR(0)="SO^A:APPROVED;D:DENIED"
"RTN","PSOERXU5",145,0)
 S DIR("?")="prescription."
"RTN","PSOERXU5",146,0)
 S DIR("?",1)="Approved  - The user was able to Cancel or Discontinue the original"
"RTN","PSOERXU5",147,0)
 S DIR("?",2)="prescription."
"RTN","PSOERXU5",148,0)
 S DIR("?",3)=""
"RTN","PSOERXU5",149,0)
 S DIR("?",4)="Denied  - The user was not able to Cancel or Discontinue the original"
"RTN","PSOERXU5",150,0)
 D ^DIR K DIR Q:Y=""!($D(DIRUT))!($D(DTOUT))
"RTN","PSOERXU5",151,0)
 I Y="A" S RESP="Rx was never dispensed. Canceled at Pharmacy."
"RTN","PSOERXU5",152,0)
 I Y="D" S RESP="Rx Not Canceled - Rx not found in pharmacy system."
"RTN","PSOERXU5",153,0)
 I Y="A",MTYPE="CA" S RESP="Rx canceled at Pharmacy."
"RTN","PSOERXU5",154,0)
 S RESID=$S(Y="A":3,Y="D":2,1:0)
"RTN","PSOERXU5",155,0)
 W !,"Would you like to acknowledge this record?"
"RTN","PSOERXU5",156,0)
 S DIR(0)="YO",DIR("B")="N" D ^DIR K DIR Q:'Y!($D(DIRUT))!($D(DTOUT))
"RTN","PSOERXU5",157,0)
 D POST^PSOERXO1(ERXIEN,.PSSRET,,,,RESID,INST,RESP)
"RTN","PSOERXU5",158,0)
 I $D(PSSRET("errorMessage")) W !!,PSSRET("errorMessage") D DIRE^PSOERXX1 Q
"RTN","PSOERXU5",159,0)
 I MTYPE="CA" D UPDSTAT^PSOERXU1(ERXIEN,"CAA")
"RTN","PSOERXU5",160,0)
 I MTYPE="RE" D UPDSTAT^PSOERXU1(ERXIEN,"RXA")
"RTN","PSOERXU5",161,0)
 I MTYPE="IE" D UPDSTAT^PSOERXU1(ERXIEN,"IRA")
"RTN","PSOERXU5",162,0)
 W !,$S(MTYPE="CA":"Cancel request",MTYPE="RE":"Refill response",1:"Inbound error")," acknowledged." D DIRE^PSOERXX1
"RTN","PSOERXU5",163,0)
 K @VALMAR D INIT^PSOERX1
"RTN","PSOERXU5",164,0)
 Q
"RTN","PSOERXU5",165,0)
LASTSTAT(ERXIEN) ;
"RTN","PSOERXU5",166,0)
 N STAT,DONE,CSTAT,LSTAT,RSTAT
"RTN","PSOERXU5",167,0)
 S DONE=0,RSTAT=""
"RTN","PSOERXU5",168,0)
 S CSTAT=$$GET1^DIQ(52.49,ERXIEN,1,"I")
"RTN","PSOERXU5",169,0)
 S STAT=99999 F  S STAT=$O(^PS(52.49,ERXIEN,19,STAT),-1) Q:'STAT!(DONE)  D
"RTN","PSOERXU5",170,0)
 .S LSTAT=$$GET1^DIQ(52.4919,STAT_","_ERXIEN_",",.02,"I")
"RTN","PSOERXU5",171,0)
 .I LSTAT=CSTAT Q
"RTN","PSOERXU5",172,0)
 .S RSTAT=$$GET1^DIQ(52.45,LSTAT,.01,"E")_" - "_$$GET1^DIQ(52.45,LSTAT,.02,"E"),DONE=1
"RTN","PSOERXU5",173,0)
 Q RSTAT
"RTN","PSOERXU5",174,0)
CSCOMM(ERXIEN) ;
"RTN","PSOERXU5",175,0)
 N STAT,DONE,SCOMM
"RTN","PSOERXU5",176,0)
 S CSTAT=$$GET1^DIQ(52.49,ERXIEN,1,"I")
"RTN","PSOERXU5",177,0)
 S STAT=$O(^PS(52.49,ERXIEN,19,999999),-1) I 'STAT Q ""
"RTN","PSOERXU5",178,0)
 S SCOMM=$$GET1^DIQ(52.4919,STAT_","_ERXIEN_",",1,"E")
"RTN","PSOERXU5",179,0)
 Q SCOMM
"RTN","PSOERXU6")
0^30^B111664391^n/a
"RTN","PSOERXU6",1,0)
PSOERXU6 ;ALB/BWF - eRx utilities ; 5/4/2018 9:57am
"RTN","PSOERXU6",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**508**;DEC 1997;Build 295
"RTN","PSOERXU6",3,0)
 ;
"RTN","PSOERXU6",4,0)
 Q
"RTN","PSOERXU6",5,0)
 ; auto discontinue orders related to cancel request
"RTN","PSOERXU6",6,0)
 ; ERXIEN is the IEN of the cancel request
"RTN","PSOERXU6",7,0)
CANDC(ERXIEN,INST,PSSRET) ;
"RTN","PSOERXU6",8,0)
 N NERXIEN,RXIEN,RELMIEN,NRXOPIEN,NRXPNIEN,REOPIEN,REPNIEN,ACOMACT,ACOMPEND,CANTYPE,NRXVPAT,CNT,ADAT,ARY,ALOOP,DONE
"RTN","PSOERXU6",9,0)
 N PENDIEN,RXIEN,PSSRET,PREVORD,RRRETYPE,RXFAIL,PENFAIL,ARESP,FORORD,PON,VARENEW,LSTMSG,RELIEN,SENDMSG,DELFLG,DELTXT
"RTN","PSOERXU6",10,0)
 S CNT=0
"RTN","PSOERXU6",11,0)
 S NERXIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU6",12,0)
 S NRXVPAT=$$GET1^DIQ(52.49,NERXIEN,.05,"I")
"RTN","PSOERXU6",13,0)
 S NRXOPIEN=$$GET1^DIQ(52.49,NERXIEN,.13,"I")
"RTN","PSOERXU6",14,0)
 S NRXPNIEN=$$GET1^DIQ(52.49,NERXIEN,25.2,"E")
"RTN","PSOERXU6",15,0)
 S CNT=CNT+1,ARY(CNT)=NRXPNIEN_U_NRXOPIEN
"RTN","PSOERXU6",16,0)
 S RELMIEN=0 F  S RELMIEN=$O(^PS(52.49,NERXIEN,201,"B",RELMIEN)) Q:'RELMIEN  D
"RTN","PSOERXU6",17,0)
 .Q:$$GET1^DIQ(52.49,RELMIEN,.08,"I")'="RE"
"RTN","PSOERXU6",18,0)
 .S REOPIEN=$$GET1^DIQ(52.49,RELMIEN,.13,"I")
"RTN","PSOERXU6",19,0)
 .S REPNIEN=$$GET1^DIQ(52.49,RELMIEN,25.2,"E")
"RTN","PSOERXU6",20,0)
 .S CNT=CNT+1,ARY(CNT)=REPNIEN_U_REOPIEN_U_RELMIEN
"RTN","PSOERXU6",21,0)
 ; if there is only one, it is the NewRx
"RTN","PSOERXU6",22,0)
 I CNT=1 D  Q
"RTN","PSOERXU6",23,0)
 .S ADAT=$G(ARY(CNT))
"RTN","PSOERXU6",24,0)
 .S PENDIEN=$P(ADAT,U),RXIEN=$P(ADAT,U,2)
"RTN","PSOERXU6",25,0)
 .; if there is an associated RXIEN, this is active and the pending item no longer exists.
"RTN","PSOERXU6",26,0)
 .I RXIEN D
"RTN","PSOERXU6",27,0)
 ..S ACOMACT=$$CANACT(ERXIEN,RXIEN,INST,.PSSRET)
"RTN","PSOERXU6",28,0)
 ..S FORORD=$$GET1^DIQ(52,RXIEN,39.5,"I")
"RTN","PSOERXU6",29,0)
 ..I FORORD S PON=$$GET1^DIQ(52,FORORD,39.3,"I")
"RTN","PSOERXU6",30,0)
 ..I FORORD,'$$CHKERX^PSOERXU1(FORORD) S VARENEW=1
"RTN","PSOERXU6",31,0)
 .I 'RXIEN,PENDIEN D
"RTN","PSOERXU6",32,0)
 ..I $$GET1^DIQ(52.41,PENDIEN,1,"I")'=NRXVPAT S DONE=1 Q
"RTN","PSOERXU6",33,0)
 ..S ACOMPEND=$$CANPEND(ERXIEN,PENDIEN,INST,.PSSRET)
"RTN","PSOERXU6",34,0)
 .; if either failed, update the status and do not send the response
"RTN","PSOERXU6",35,0)
 .Q:$G(DONE)
"RTN","PSOERXU6",36,0)
 .I $D(ACOMACT),'$P(ACOMACT,U) S RXFAIL=1
"RTN","PSOERXU6",37,0)
 .I $D(ACOMPEND),'$P(ACOMPEND,U) S PENFAIL=1
"RTN","PSOERXU6",38,0)
 .I $G(RXFAIL)!($G(PENFAIL))!($P($G(ACOMACT),U)=2) D  Q
"RTN","PSOERXU6",39,0)
 ..I $G(RXFAIL)!($P($G(ACOMACT),U)=2) S ARESP=$P(ACOMACT,U,2)
"RTN","PSOERXU6",40,0)
 ..I $G(PENFAIL),'$D(ARESP) S ARESP=$P($G(ACOMPEND),U,2)
"RTN","PSOERXU6",41,0)
 ..D UPDSTAT^PSOERXU1(NERXIEN,"CAN",$G(ARESP))
"RTN","PSOERXU6",42,0)
 ..; if this is a 'deleted' rx, update the status, cancel all related and quit.
"RTN","PSOERXU6",43,0)
 ..I $P($G(ACOMACT),U)=2 D  Q
"RTN","PSOERXU6",44,0)
 ...D UPDSTAT^PSOERXU1(ERXIEN,"CAH",$P($G(ACOMACT),U,2)),CANRELHQ(NERXIEN) Q
"RTN","PSOERXU6",45,0)
 ..D UPDSTAT^PSOERXU1(ERXIEN,"CAF",ARESP)
"RTN","PSOERXU6",46,0)
 ..D CANRELHQ(NERXIEN)
"RTN","PSOERXU6",47,0)
 .I $D(ACOMACT),$P(ACOMACT,U) S ARESP=$P(ACOMACT,U,2)
"RTN","PSOERXU6",48,0)
 .I '$L($G(ARESP)),$D(ACOMPEND),$P(ACOMPEND,U) S ARESP=$P(ACOMPEND,U,2)
"RTN","PSOERXU6",49,0)
 .; only send the automated response if the auto-dc was successful, and the rx status is not deleted
"RTN","PSOERXU6",50,0)
 .I '$G(VARENEW) D POST^PSOERXO1(ERXIEN,.PSSRET,,,,3,INST,ARESP)
"RTN","PSOERXU6",51,0)
 .; if there was an error, cancel the related items and quit. we do not want to override the CAX status
"RTN","PSOERXU6",52,0)
 .I $D(PSSRET("errorMessage")) D CANRELHQ(NERXIEN),UPDSTAT^PSOERXU1(NERXIEN,"CAN",ARESP) Q
"RTN","PSOERXU6",53,0)
 .I RXIEN,$$VARENEW(RXIEN) D  Q
"RTN","PSOERXU6",54,0)
 ..D UPDSTAT^PSOERXU1(NERXIEN,"CAN","eRx was renewed within the VA.")
"RTN","PSOERXU6",55,0)
 ..D UPDSTAT^PSOERXU1(ERXIEN,"CAH","eRx was renewed within the VA.")
"RTN","PSOERXU6",56,0)
 ..D CANRELHQ(NERXIEN)
"RTN","PSOERXU6",57,0)
 .D UPDSTAT^PSOERXU1(NERXIEN,"CAN",ARESP)
"RTN","PSOERXU6",58,0)
 .I '$G(FORORD) D UPDSTAT^PSOERXU1(ERXIEN,"CAO",$G(ARESP))
"RTN","PSOERXU6",59,0)
 .I $G(FORORD) D UPDSTAT^PSOERXU1(ERXIEN,"CAH",$G(ARESP))
"RTN","PSOERXU6",60,0)
 .D CANRELHQ(NERXIEN)
"RTN","PSOERXU6",61,0)
 ; if there is more than one, renewals have occured.
"RTN","PSOERXU6",62,0)
 S ALOOP=99999,DONE=0
"RTN","PSOERXU6",63,0)
 F  S ALOOP=$O(ARY(ALOOP),-1) Q:'ALOOP!(DONE)  D
"RTN","PSOERXU6",64,0)
 .S ADAT=$G(ARY(ALOOP))
"RTN","PSOERXU6",65,0)
 .; if there is a pending IEN and no RX IEN, we know this has not yet been processed into a live prescription
"RTN","PSOERXU6",66,0)
 .; and is a renwewal from a previous prescription.
"RTN","PSOERXU6",67,0)
 .S PENDIEN=$P(ADAT,U),RXIEN=$P(ADAT,U,2),RELIEN=$P(ADAT,U,3)
"RTN","PSOERXU6",68,0)
 .I RXIEN D  Q
"RTN","PSOERXU6",69,0)
 ..I $G(PENDIEN),$$GET1^DIQ(52.41,PENDIEN,1,"I")=NRXVPAT D  Q
"RTN","PSOERXU6",70,0)
 ...S ACOMPEND(ALOOP)=$$CANPEND(ERXIEN,PENDIEN,INST,.PSSRET)
"RTN","PSOERXU6",71,0)
 ...S ACOMACT(ALOOP)=$$CANACT(ERXIEN,RXIEN,INST,.PSSRET)
"RTN","PSOERXU6",72,0)
 ...S FORORD=$$GET1^DIQ(52,RXIEN,39.5,"I")
"RTN","PSOERXU6",73,0)
 ...I FORORD S PON=$$GET1^DIQ(52,FORORD,39.3,"I")
"RTN","PSOERXU6",74,0)
 ...I FORORD,'$$CHKERX^PSOERXU1(PON) S VARENEW=1
"RTN","PSOERXU6",75,0)
 ..S ACOMACT(ALOOP)=$$CANACT(ERXIEN,RXIEN,INST,.PSSRET)
"RTN","PSOERXU6",76,0)
 .I PENDIEN,'RXIEN D  Q
"RTN","PSOERXU6",77,0)
 ..; if this pending item is not for the right patient, quit
"RTN","PSOERXU6",78,0)
 ..I $G(PENDIEN),$$GET1^DIQ(52.41,PENDIEN,1,"I")'=NRXVPAT S DONE=1 Q
"RTN","PSOERXU6",79,0)
 ..S PREVORD=$$GET1^DIQ(52.41,PENDIEN,22.1,"E")
"RTN","PSOERXU6",80,0)
 ..I '$G(PREVORD) D  Q
"RTN","PSOERXU6",81,0)
 ...S ACOMPEND(ALOOP)=$$CANPEND(ERXIEN,PENDIEN,INST,.PSSRET)
"RTN","PSOERXU6",82,0)
 ..S ACOMPEND(ALOOP)=$$CANPEND(ERXIEN,PENDIEN,INST,.PSSRET)
"RTN","PSOERXU6",83,0)
 ..S ACOMACT(ALOOP)=$$CANACT(ERXIEN,PREVORD,INST,.PSSRET)
"RTN","PSOERXU6",84,0)
 ; now check all results for failures
"RTN","PSOERXU6",85,0)
 N ACTLP,ACTFL,ACTMSG,PENLP,PENFL,PENMSG
"RTN","PSOERXU6",86,0)
 S (ACTLP,ACTFL)=0 F  S ACTLP=$O(ACOMACT(ACTLP)) Q:'ACTLP  D
"RTN","PSOERXU6",87,0)
 .I $P(ACOMACT(ACTLP),U)=0 S ACTFL=ACTFL+1
"RTN","PSOERXU6",88,0)
 .I $P(ACOMACT(ACTLP),U)=1 S ACTMSG(ACTFL)=$P(ACOMACT(ACTLP),U,2)
"RTN","PSOERXU6",89,0)
 .I $P(ACOMACT(ACTLP),U)=2 S DELFLG=1,DELTXT=$P(ACOMACT(ACTLP),U,2)
"RTN","PSOERXU6",90,0)
 S (PENLP,PENFL)=0 F  S PENLP=$O(ACOMPEND(PENLP)) Q:'PENLP  D
"RTN","PSOERXU6",91,0)
 .I $P(ACOMPEND(PENLP),U)=0 S PENFL=PENFL+1
"RTN","PSOERXU6",92,0)
 .I $P(ACOMPEND(PENLP),U)=1 S PENMSG(PENFL)=$P(ACOMPEND(PENLP),U,2)
"RTN","PSOERXU6",93,0)
 I $G(DELFLG) D  Q
"RTN","PSOERXU6",94,0)
 .D UPDSTAT^PSOERXU1(NERXIEN,"CAN",DELTXT)
"RTN","PSOERXU6",95,0)
 .D UPDSTAT^PSOERXU1(ERXIEN,"CAH",DELTXT)
"RTN","PSOERXU6",96,0)
 .D CANRELHQ(NERXIEN)
"RTN","PSOERXU6",97,0)
 I ACTFL>0!(PENFL>0) D  Q
"RTN","PSOERXU6",98,0)
 .D UPDSTAT^PSOERXU1(NERXIEN,"CAN")
"RTN","PSOERXU6",99,0)
 .D UPDSTAT^PSOERXU1(ERXIEN,"CAF")
"RTN","PSOERXU6",100,0)
 .D CANRELHQ(NERXIEN)
"RTN","PSOERXU6",101,0)
 ; get the last active rx status
"RTN","PSOERXU6",102,0)
 I $D(ACTMSG) D
"RTN","PSOERXU6",103,0)
 .S LSTMSG=$O(ACTMSG(99999),-1)
"RTN","PSOERXU6",104,0)
 .S SENDMSG=$G(ACTMSG(LSTMSG))
"RTN","PSOERXU6",105,0)
 I '$D(SENDMSG) D
"RTN","PSOERXU6",106,0)
 .S LSTMSG=$O(PENMSG(99999),-1)
"RTN","PSOERXU6",107,0)
 .S SENDMSG=$G(PENMSG(LSTMSG))
"RTN","PSOERXU6",108,0)
 I '$G(VARENEW) D POST^PSOERXO1(ERXIEN,.PSSRET,,,,3,INST,SENDMSG)
"RTN","PSOERXU6",109,0)
 I $G(VARENEW) D UPDSTAT^PSOERXU1(NERXIEN,"CAN","eRx was renewed within the VA.")
"RTN","PSOERXU6",110,0)
 I '$G(VARENEW) D UPDSTAT^PSOERXU1(NERXIEN,"CAN",$G(SENDMSG))
"RTN","PSOERXU6",111,0)
 ; if there was an error, cancel the related items and quit. we do not want to override the CAX status
"RTN","PSOERXU6",112,0)
 I $D(PSSRET("errorMessage")) D CANRELHQ(NERXIEN) Q 
"RTN","PSOERXU6",113,0)
 I '$G(VARENEW) D UPDSTAT^PSOERXU1(ERXIEN,"CAO")
"RTN","PSOERXU6",114,0)
 I $G(VARENEW) D UPDSTAT^PSOERXU1(ERXIEN,"CAH","eRx was renewed within the VA.")
"RTN","PSOERXU6",115,0)
 D CANRELHQ(NERXIEN)
"RTN","PSOERXU6",116,0)
 Q
"RTN","PSOERXU6",117,0)
CANRELHQ(NERXIEN) ;
"RTN","PSOERXU6",118,0)
 N RELMIEN,RRRETYPE
"RTN","PSOERXU6",119,0)
 ;I $$GET1^DIQ(52.49,NERXIEN,1,"E")'="CAN" Q
"RTN","PSOERXU6",120,0)
 S RELMIEN=0 F  S RELMIEN=$O(^PS(52.49,NERXIEN,201,"B",RELMIEN)) Q:'RELMIEN  D
"RTN","PSOERXU6",121,0)
 .S RRRETYPE=$$GET1^DIQ(52.49,RELMIEN,.08,"I")
"RTN","PSOERXU6",122,0)
 .I RRRETYPE="RE"!(RRRETYPE="RR") D
"RTN","PSOERXU6",123,0)
 ..D UPDSTAT^PSOERXU1(RELMIEN,"CAN")
"RTN","PSOERXU6",124,0)
 Q
"RTN","PSOERXU6",125,0)
CANACT(ERXIEN,RXIEN,INST,PSSRET) ;
"RTN","PSOERXU6",126,0)
 N NERXIEN,RXSTAT,UPDRXSTAT,ERXIENS,UPDRXSTA,PSOSITE,PSOSYS,PSODFN,ORN,PSOOPT,VALMSG
"RTN","PSOERXU6",127,0)
 S ERXIENS=ERXIEN_","
"RTN","PSOERXU6",128,0)
 S RXSTAT=$$GET1^DIQ(52,RXIEN,100,"I")
"RTN","PSOERXU6",129,0)
 S NERXIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU6",130,0)
 I (RXSTAT=12)!(RXSTAT=13)!(RXSTAT=14)!(RXSTAT=15) D  Q VALMSG
"RTN","PSOERXU6",131,0)
 .S ERRSEQ=$$ERRSEQ^PSOERXU1(ERXIEN) Q:'ERRSEQ
"RTN","PSOERXU6",132,0)
 .I RXSTAT=13 S VALMSG="2^Prescription is already DELETED at the Pharmacy."
"RTN","PSOERXU6",133,0)
 .I '$D(VALMSG) S VALMSG="1^Prescription is already discontinued at the Pharmacy."
"RTN","PSOERXU6",134,0)
 .D FILERR^PSOERXU1(ERXIENS,ERRSEQ,"PX","V",$G(VALMSG))
"RTN","PSOERXU6",135,0)
 S PSOSITE=$$GET1^DIQ(52,RXIEN,20,"I")
"RTN","PSOERXU6",136,0)
 S PSOSYS=$G(^PS(59.7,1,40.1)) Q:PSOSYS="" ""
"RTN","PSOERXU6",137,0)
 ; FUTURE ENHANCEMENT/CONSIDERATION- SET PSODIV - PSODIV IS 0 in the test account. need to determine what it is set to.
"RTN","PSOERXU6",138,0)
 S PSODFN=$$GET1^DIQ(52,RXIEN,2,"I") Q:'PSODFN ""
"RTN","PSOERXU6",139,0)
 ; ORN is set to 1 since we are only building one item into the list. this makes the dc function use PSOLST(ORN)
"RTN","PSOERXU6",140,0)
 ; or PSOLST(1)
"RTN","PSOERXU6",141,0)
 S PSOLST(1)=52_U_RXIEN_U_$$GET1^DIQ(52,RXIEN,100,"E")
"RTN","PSOERXU6",142,0)
 S ORN=1
"RTN","PSOERXU6",143,0)
 ; PSODIV, PSOSITE, AND PSOSYS are used by LMNO^PSOCAN and DIV^PSOCAN - consider setting these if possible 
"RTN","PSOERXU6",144,0)
 ; PSOOPT is checked against a value of 3. find out if we need to set this to a certain value before calling psocan3
"RTN","PSOERXU6",145,0)
 S PSOOPT=0
"RTN","PSOERXU6",146,0)
 D OERR^PSOCAN3(NERXIEN)
"RTN","PSOERXU6",147,0)
 S UPDRXSTA=$$GET1^DIQ(52,RXIEN,100,"I")
"RTN","PSOERXU6",148,0)
 I UPDRXSTA'=12,(UPDRXSTA'=14),(UPDRXSTA'=15) D  Q VALMSG
"RTN","PSOERXU6",149,0)
 .I UPDRXSTA=13 S VALMSG="2^Prescription has been DELETED at the Pharmacy."
"RTN","PSOERXU6",150,0)
 .S ERRSEQ=$$ERRSEQ^PSOERXU1(ERXIEN) Q:'ERRSEQ
"RTN","PSOERXU6",151,0)
 .I $L($G(VALMSG)) S VALMSG=0_U_$G(VALMSG)
"RTN","PSOERXU6",152,0)
 .I '$L($G(VALMSG)) S VALMSG="0^eRx auto-discontinue failed."
"RTN","PSOERXU6",153,0)
 .D FILERR^PSOERXU1(ERXIENS,ERRSEQ,"PX","V",$G(VALMSG))
"RTN","PSOERXU6",154,0)
 S ACOM=$$BLDRESP(RXIEN),ACOM=1_U_ACOM
"RTN","PSOERXU6",155,0)
 Q ACOM
"RTN","PSOERXU6",156,0)
 ; auto discontinue pending orders related to cancel request
"RTN","PSOERXU6",157,0)
 ; ERXIEN - cancel reqeust IEN
"RTN","PSOERXU6",158,0)
 ; PENDIEN - IEN for the pending order in file 52.41
"RTN","PSOERXU6",159,0)
CANPEND(ERXIEN,PENDIEN,INST,PSSRET) ;
"RTN","PSOERXU6",160,0)
 N ERXIENS,CANTYPE,ERRSEQ,VALMSG,PREVORD,NERXIEN,ORD,ACOM,REFL,TOTFILL,LDDATE,FFILL,PSODFN,PSONOOR,PSODFN,CANTYPEA,ORNUM,PSOPLCK
"RTN","PSOERXU6",161,0)
 S ERXIENS=ERXIEN_","
"RTN","PSOERXU6",162,0)
 Q:'PENDIEN
"RTN","PSOERXU6",163,0)
 Q:'$D(^PS(52.41,PENDIEN,0)) "1^Rx no longer in pending file."
"RTN","PSOERXU6",164,0)
 S NERXIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU6",165,0)
 S PSODFN=$$GET1^DIQ(52.41,PENDIEN,1,"I")
"RTN","PSOERXU6",166,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S ACOM=$S($P($G(PSOPLCK),"^",2)'="":"Patient record locked by "_$P($G(PSOPLCK),"^",2)_".",1:"Another person is entering orders for this patient.") K PSOPLCK Q 0_U_ACOM
"RTN","PSOERXU6",167,0)
 S CANTYPE=$$GET1^DIQ(52.41,PENDIEN,2,"I")
"RTN","PSOERXU6",168,0)
 ; if this is already DC'd. update status of the releated messages
"RTN","PSOERXU6",169,0)
 I CANTYPE="DC"!(CANTYPE="DE") D  Q VALMSG
"RTN","PSOERXU6",170,0)
 .S ERRSEQ=$$ERRSEQ^PSOERXU1(ERXIEN) Q:'ERRSEQ
"RTN","PSOERXU6",171,0)
 .S VALMSG="1^Pending Order is already discontinued."
"RTN","PSOERXU6",172,0)
 .D FILERR^PSOERXU1(ERXIENS,ERRSEQ,"PX","V",$G(VALMSG))
"RTN","PSOERXU6",173,0)
 S ACOM="Rx was never dispensed. Canceled at Pharmacy."
"RTN","PSOERXU6",174,0)
 S ORD=PENDIEN
"RTN","PSOERXU6",175,0)
 S PSONOOR="W"
"RTN","PSOERXU6",176,0)
 D DEAD^PSOPTPST
"RTN","PSOERXU6",177,0)
 K ^PS(52.41,"AOR",$P(^PS(52.41,ORD,0),"^",2),+$P($G(^PS(52.41,ORD,"INI")),"^"),ORD),^PS(52.41,"AD",$P(^PS(52.41,ORD,0),"^",12),+$P($G(^PS(52.41,ORD,"INI")),"^"),ORD)
"RTN","PSOERXU6",178,0)
 S $P(^PS(52.41,ORD,0),"^",3)="DC",POERR("PLACER")=$P(^(0),"^"),POERR("STAT")="OC"
"RTN","PSOERXU6",179,0)
 S POERR("COMM")=$S($G(POERR("DEAD")):"Patient died on "_$G(PSOPTPST(2,PSODFN,.351))_".",1:ACOM),$P(^PS(52.41,ORD,4),"^")=POERR("COMM")
"RTN","PSOERXU6",180,0)
 D EN^PSOHLSN(POERR("PLACER"),POERR("STAT"),POERR("COMM"),PSONOOR)
"RTN","PSOERXU6",181,0)
 S CANTYPEA=$$GET1^DIQ(52.41,PENDIEN,2,"I")
"RTN","PSOERXU6",182,0)
 I CANTYPEA'="DC" D  Q VALMSG
"RTN","PSOERXU6",183,0)
 .S ERRSEQ=$$ERRSEQ^PSOERXU1(ERXIEN) Q:'ERRSEQ
"RTN","PSOERXU6",184,0)
 .S VALMSG="0^eRx auto-discontinue failed. Please contact Pharmacy."
"RTN","PSOERXU6",185,0)
 .D FILERR^PSOERXU1(ERXIENS,ERRSEQ,"PX","V",$G(VALMSG))
"RTN","PSOERXU6",186,0)
 ;E   ; Log Auto-Discontinue of Pending Outpatient Orders if this eRx was already processed
"RTN","PSOERXU6",187,0)
 ;. S ORNUM=$$GET1^DIQ(52.49,ERXIEN,.12,"I") ; Validates if the order is an eRx and Log Activity in AL eRx
"RTN","PSOERXU6",188,0)
 ;. I $$CHKERX^PSOERXU1(ORNUM) D RXACT^PSOBPSU2(ERXIEN,0,"eRx Discontinued due to Cancel Request by external provider (eRx)","O")
"RTN","PSOERXU6",189,0)
 K POERR,PSOPTPST
"RTN","PSOERXU6",190,0)
 Q 1_U_ACOM
"RTN","PSOERXU6",191,0)
BLDRESP(RXIEN) ;
"RTN","PSOERXU6",192,0)
 N REFL,TOTFILL,LDDATE,FFILL,ACOM
"RTN","PSOERXU6",193,0)
 S (REFL,TOTFILL)=$$GET1^DIQ(52,RXIEN,9,"I"),I=0 F  S I=$O(^PSRX(RXIEN,1,I)) Q:'I  S REFL=REFL-1
"RTN","PSOERXU6",194,0)
 S LDDATE=$$GET1^DIQ(52,RXIEN,101,"I"),LDDATE=$$FMTE^XLFDT(LDDATE,"2D")
"RTN","PSOERXU6",195,0)
 S FFILL=$$GET1^DIQ(52,RXIEN,22,"I"),FFILL=$$FMTE^XLFDT(FFILL,"2D")
"RTN","PSOERXU6",196,0)
 S ACOM="First Fill:"_FFILL_", Last Fill:"_LDDATE_", Refills Remaining:"_REFL
"RTN","PSOERXU6",197,0)
 Q ACOM
"RTN","PSOERXU6",198,0)
 ; find the newRx related to a message
"RTN","PSOERXU6",199,0)
FINDNRX(ERXIEN) ;
"RTN","PSOERXU6",200,0)
 N DONE,I,PREVIEN
"RTN","PSOERXU6",201,0)
 S DONE=0,PREVIEN=0
"RTN","PSOERXU6",202,0)
 I '$D(^PS(52.49,ERXIEN,201)) Q 0
"RTN","PSOERXU6",203,0)
 F I=1:1 D  Q:DONE
"RTN","PSOERXU6",204,0)
 .S PREVIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU6",205,0)
 .I 'PREVIEN S DONE=1 Q
"RTN","PSOERXU6",206,0)
 .I PREVIEN S ERXIEN=PREVIEN
"RTN","PSOERXU6",207,0)
 .I $$GET1^DIQ(52.49,PREVIEN,.08,"I")="N" S DONE=1 Q
"RTN","PSOERXU6",208,0)
 Q PREVIEN
"RTN","PSOERXU6",209,0)
JTQ(ERXIEN) ;
"RTN","PSOERXU6",210,0)
 N MEDA,XQY0,DFN,PSOFIN,POERR,PSOSORT,PTNM,PSODFN,PAT,MTYPE,PSOFINY,PSOLST
"RTN","PSOERXU6",211,0)
 D FULL^VALM1
"RTN","PSOERXU6",212,0)
 S VALMBCK="R"
"RTN","PSOERXU6",213,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I") I MTYPE'="N" D  Q
"RTN","PSOERXU6",214,0)
 .W !,"Jumping can only be done on 'NewRx' messages." D DIRE^PSOERXX1 Q
"RTN","PSOERXU6",215,0)
 S XQY0="PSO LMOE FINISH"
"RTN","PSOERXU6",216,0)
 I $P($G(PSOPAR),"^",2),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("VERIFY")=1
"RTN","PSOERXU6",217,0)
 S DFN=$$GET1^DIQ(52.49,ERXIEN,.05,"I")
"RTN","PSOERXU6",218,0)
 I 'DFN W !,"Vista patient has not been matched. Cannot jump to outpatient." D DIRE^PSOERXX1 Q
"RTN","PSOERXU6",219,0)
 S (PSOFIN,POERR)=1
"RTN","PSOERXU6",220,0)
 S PSOSORT="PATIENT"
"RTN","PSOERXU6",221,0)
 S PTNM=$$GET1^DIQ(2,DFN,.01,"E")
"RTN","PSOERXU6",222,0)
 S (PSODFN,PAT)=DFN,PSOFINY=DFN_U_PTNM
"RTN","PSOERXU6",223,0)
 ; use the PSNPINST
"RTN","PSOERXU6",224,0)
 I '$D(^PS(52.41,"AOR",PAT,PSNPINST)) W !,"Patient has no pending prescriptions." D DIRE^PSOERXX1 Q
"RTN","PSOERXU6",225,0)
 W !,"Patient: "_PTNM,!
"RTN","PSOERXU6",226,0)
 ; new line SPAT2^PSOORFIN has been created to jump right into pending orders with the patient pre-selected
"RTN","PSOERXU6",227,0)
 D SPAT2^PSOORFIN,EX^PSOORFI1
"RTN","PSOERXU6",228,0)
 K PSORX
"RTN","PSOERXU6",229,0)
 Q
"RTN","PSOERXU6",230,0)
VARENEW(OPIEN) ;
"RTN","PSOERXU6",231,0)
 N FORORD,VARENEW,PON
"RTN","PSOERXU6",232,0)
 S VARENEW=0
"RTN","PSOERXU6",233,0)
 S FORORD=$$GET1^DIQ(52,RXIEN,39.5,"I")
"RTN","PSOERXU6",234,0)
 I FORORD S PON=$$GET1^DIQ(52,FORORD,39.3,"I")
"RTN","PSOERXU6",235,0)
 I FORORD,'$$CHKERX^PSOERXU1(PON) S VARENEW=1
"RTN","PSOERXU6",236,0)
 Q VARENEW
"RTN","PSOERXU6",237,0)
SH(ERXIEN) ;
"RTN","PSOERXU6",238,0)
 N SIEN,IENS,F,LINE,SDTTM,ISTAT,ESTAT,EBY,SCOMM,CARY,ALOOP,STDESC,SDAT
"RTN","PSOERXU6",239,0)
 D FULL^VALM1 S VALMBCK="R"
"RTN","PSOERXU6",240,0)
 S $P(LINE,"-",80)="" W !,LINE
"RTN","PSOERXU6",241,0)
 S F=52.4919
"RTN","PSOERXU6",242,0)
 I '$O(^PS(52.49,ERXIEN,19,0)) W !,"No Status History Available." D DIRE^PSOERXX1 Q
"RTN","PSOERXU6",243,0)
 S SIEN=0 F  S SIEN=$O(^PS(52.49,ERXIEN,19,SIEN)) Q:'SIEN  D
"RTN","PSOERXU6",244,0)
 .S IENS=SIEN_","_ERXIEN_","
"RTN","PSOERXU6",245,0)
 .D GETS^DIQ(F,IENS,"**","IE","SDAT")
"RTN","PSOERXU6",246,0)
 .S SDTTM=$$GET1^DIQ(52.4919,IENS,.01,"I"),SDTTM=$$FMTE^XLFDT(SDTTM,"2Z")
"RTN","PSOERXU6",247,0)
 .S ISTAT=$G(SDAT(F,IENS,.02,"I"))
"RTN","PSOERXU6",248,0)
 .S ESTAT=$G(SDAT(F,IENS,.02,"E"))
"RTN","PSOERXU6",249,0)
 .S STDESC=$$GET1^DIQ(52.45,ISTAT,.02,"E")
"RTN","PSOERXU6",250,0)
 .S EBY=$G(SDAT(F,IENS,.03,"E"))
"RTN","PSOERXU6",251,0)
 .S SCOMM=$G(SDAT(F,IENS,1,"E")),SCOMM="Comments: "_SCOMM
"RTN","PSOERXU6",252,0)
 .K CARY
"RTN","PSOERXU6",253,0)
 .D TXT2ARY^PSOERXD1(.CARY,SCOMM,,80)
"RTN","PSOERXU6",254,0)
 .W !,SDTTM,?19,ESTAT,?26,STDESC,!,"Entered By: "_EBY ;"Comments: "_SCOMM,!
"RTN","PSOERXU6",255,0)
 .S ALOOP=0 F  S ALOOP=$O(CARY(ALOOP)) Q:'ALOOP  D
"RTN","PSOERXU6",256,0)
 ..W !,$G(CARY(ALOOP))
"RTN","PSOERXU6",257,0)
 .W !
"RTN","PSOERXU6",258,0)
 D DIRE^PSOERXX1
"RTN","PSOERXU6",259,0)
 Q
"RTN","PSOERXX1")
0^7^B155540262^B47206629
"RTN","PSOERXX1",1,0)
PSOERXX1 ;ALB/BWF - eRx xml utilities ; 8/3/2016 5:14pm
"RTN","PSOERXX1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,527,508**;DEC 1997;Build 295
"RTN","PSOERXX1",3,0)
 ;
"RTN","PSOERXX1",4,0)
 Q
"RTN","PSOERXX1",5,0)
 ; called by PSO ERX REFILL REQUEST action protocol
"RTN","PSOERXX1",6,0)
RREQLST(PSOLST,PSOSITE,PSOCNT) ;
"RTN","PSOERXX1",7,0)
 N ITEM,SEL,ORD,I,ERXIEN,DONE,ORDER,ORDLST,RXIEN,RXDRUG,RXDRUGN,PRECHECK,DIR
"RTN","PSOERXX1",8,0)
 D FULL^VALM1
"RTN","PSOERXX1",9,0)
 S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DUOUT Q
"RTN","PSOERXX1",10,0)
 S ORDLST=Y
"RTN","PSOERXX1",11,0)
 W !!,"NOTE: If you have selected items that are not inbound eRx Prescriptions,"
"RTN","PSOERXX1",12,0)
 W !,"those entries will be skipped during the refill/renewal process.",!!
"RTN","PSOERXX1",13,0)
 K DIR
"RTN","PSOERXX1",14,0)
 S DONE=0
"RTN","PSOERXX1",15,0)
 F I=1:1 D  Q:DONE
"RTN","PSOERXX1",16,0)
 .S ITEM=$P(ORDLST,",",I) I ITEM="" S DONE=1 Q
"RTN","PSOERXX1",17,0)
 .I $P(PSOLST(ITEM),U)'=52 W !,"This item is "_$P(PSOLST(ITEM),U,3)_" and cannot be renewed.",! D DIRE Q
"RTN","PSOERXX1",18,0)
 .S RXIEN=$P(PSOLST(ITEM),U,2)
"RTN","PSOERXX1",19,0)
 .S ORDER=$$GET1^DIQ(52,RXIEN,39.3,"I")
"RTN","PSOERXX1",20,0)
 .S ERXIEN=$$CHKERX^PSOERXU1(ORDER) Q:'ERXIEN
"RTN","PSOERXX1",21,0)
 .S RXDRUG=$$GET1^DIQ(52,RXIEN,6,"I"),RXDRUGN=$$GET1^DIQ(52,RXIEN,6,"E")
"RTN","PSOERXX1",22,0)
 .W !!,"Now renewing prescription #: "_$$GET1^DIQ(52,RXIEN,.01,"E")
"RTN","PSOERXX1",23,0)
 .W !,"Patient: "_$$GET1^DIQ(52,RXIEN,2,"E")
"RTN","PSOERXX1",24,0)
 .W !,"Drug/Supply: "_RXDRUGN
"RTN","PSOERXX1",25,0)
 .W !,"# of Refills: "_$$GET1^DIQ(52,RXIEN,9,"E"),?30,"Days Supply: "_$$GET1^DIQ(52,RXIEN,8,"E"),?52,"Quantity: "_$$GET1^DIQ(52,RXIEN,7,"E")
"RTN","PSOERXX1",26,0)
 .S PRECHECK=$$RENEW^PSORENW(RXIEN,RXDRUG)
"RTN","PSOERXX1",27,0)
 .I $P(PRECHECK,U)<1 W !,$P(PRECHECK,U,2),! D DIRE Q
"RTN","PSOERXX1",28,0)
 .D RREQOP(ERXIEN,PSOSITE)
"RTN","PSOERXX1",29,0)
 Q
"RTN","PSOERXX1",30,0)
 ; Called by PSO ERX SINGLE REFILL REQUEST action protocol
"RTN","PSOERXX1",31,0)
RREQSIN(RXIEN,PSOSITE) ;
"RTN","PSOERXX1",32,0)
 N ORDER,ERXIEN,RXDRUG,RXDRUGN,PRECHECK
"RTN","PSOERXX1",33,0)
 S ORDER=$$GET1^DIQ(52,RXIEN,39.3,"I") Q:'ORDER
"RTN","PSOERXX1",34,0)
 S ERXIEN=$$CHKERX^PSOERXU1(ORDER) I 'ERXIEN W !!,"eRx Refill request may not be used. This prescription is not an eRx." D DIRE Q
"RTN","PSOERXX1",35,0)
 S RXDRUG=$$GET1^DIQ(52,RXIEN,6,"I"),RXDRUGN=$$GET1^DIQ(52,RXIEN,6,"E")
"RTN","PSOERXX1",36,0)
 W !!,"Now renewing prescription #: "_$$GET1^DIQ(52,RXIEN,.01,"E")
"RTN","PSOERXX1",37,0)
 W !,"Patient: "_$$GET1^DIQ(52,RXIEN,2,"E")
"RTN","PSOERXX1",38,0)
 W !,"Drug/Supply: "_RXDRUGN,!!
"RTN","PSOERXX1",39,0)
 W !,"# of Refills: "_$$GET1^DIQ(52,RXIEN,9,"E"),?30,"Days Supply: "_$$GET1^DIQ(52,RXIEN,8,"E"),?52,"Quantity: "_$$GET1^DIQ(52,RXIEN,7,"E")
"RTN","PSOERXX1",40,0)
 S PRECHECK=$$RENEW^PSORENW(RXIEN,RXDRUG)
"RTN","PSOERXX1",41,0)
 I $P(PRECHECK,U)<1 W !,$P(PRECHECK,U,2),! Q
"RTN","PSOERXX1",42,0)
 D RREQOP(ERXIEN,PSOSITE)
"RTN","PSOERXX1",43,0)
 Q
"RTN","PSOERXX1",44,0)
 ; PSOIEN - ien from 52.49 (erx holding queue)
"RTN","PSOERXX1",45,0)
 ; PSOSITE - site ien from the outpatient site file (59)
"RTN","PSOERXX1",46,0)
 ; REFILL REQUEST VIA PSO LMOE FINISH/BACKDOOR ORDERS
"RTN","PSOERXX1",47,0)
RREQOP(PSOIEN,PSOSITE) ;
"RTN","PSOERXX1",48,0)
 N ORNUM,RXIEN,PSSOUT,GBL,REFL,I,EXDT,PEND,PSSRET,CNT,DIR,Y,REFQTY,REFREQ,DIV,VADAT,RRCNT
"RTN","PSOERXX1",49,0)
 N I,SSSTART,SSSTOP,GBL2,XXL1,XXL2,HUBID,NPIINST,STATION,Y,DIR,DONE,INNAME,NPI,NERXIEN
"RTN","PSOERXX1",50,0)
 N MSGIEN,MSGDT,RESIEN,SIG,SIGLEN,DTCUT,RTHID,PSORENW,EXPFLG
"RTN","PSOERXX1",51,0)
 S VALMBCK="R"
"RTN","PSOERXX1",52,0)
 Q:'PSOIEN!('PSOSITE)
"RTN","PSOERXX1",53,0)
 S NPIINST=$$GET1^DIQ(59,PSOSITE,101,"I")
"RTN","PSOERXX1",54,0)
 S INNAME=$$NAME^XUAF4(NPIINST)
"RTN","PSOERXX1",55,0)
 S STATION=$$WHAT^XUAF4(NPIINST,99)
"RTN","PSOERXX1",56,0)
 D FULL^VALM1
"RTN","PSOERXX1",57,0)
 ; bwf - if the NPI is not coming back from the $$NPI check, we have to pull it from the field
"RTN","PSOERXX1",58,0)
 ;       iteself
"RTN","PSOERXX1",59,0)
 S NPI=$$NPI^XUSNPI("Organization_ID",NPIINST) I $P(NPI,U)<1 D
"RTN","PSOERXX1",60,0)
 .S NPI=$$WHAT^XUAF4(NPIINST,41.99)
"RTN","PSOERXX1",61,0)
 I '$G(NPI) W !!,"NPI could not be established. Cannot create renewal request." D DIRE Q
"RTN","PSOERXX1",62,0)
 S DIV=INNAME_U_NPI
"RTN","PSOERXX1",63,0)
 S ORNUM=$$GET1^DIQ(52.49,PSOIEN,.12,"I") I 'ORNUM W !!,"No OE/RR order number. Cannot create renewal request." D DIRE Q
"RTN","PSOERXX1",64,0)
 S PEND=$O(^PS(52.41,"B",ORNUM,0))
"RTN","PSOERXX1",65,0)
 S RXIEN=$O(^PSRX("APL",ORNUM,0))
"RTN","PSOERXX1",66,0)
 I PEND,'RXIEN W !!,"RX appears to be in Pending Outpatient Orders, but not yet processed to",!,"backdoor orders." D DIRE Q
"RTN","PSOERXX1",67,0)
 I 'PEND,'RXIEN W !!,"Cannot resolve RX#. Please ensure the prescription is in the prescription file."  D DIRE Q
"RTN","PSOERXX1",68,0)
 I $$GET1^DIQ(52,RXIEN,100,"I")=5 W !!,"Rx is in suspense, cannot renew prescription." D DIRE Q
"RTN","PSOERXX1",69,0)
 S PSORENW("ORX #")=$$GET1^DIQ(52,RXIEN,.01,"E")
"RTN","PSOERXX1",70,0)
 I $A($E(PSORENW("ORX #"),$L(PSORENW("ORX #"))))'<90 W !!,"Cannot renew Rx # "_PSORENW("ORX #")_", Max number reached." D DIRE Q
"RTN","PSOERXX1",71,0)
 ;/BLB/ PSO*7.0*520 - correct typo in the word "prescription" - BEGIN CHANGE
"RTN","PSOERXX1",72,0)
 S EXDT=$$GET1^DIQ(52,RXIEN,26,"I")
"RTN","PSOERXX1",73,0)
 I EXDT<$$FMADD^XLFDT(DT,-120) W !!,"Medication has expired, cannot renew prescription." D DIRE Q
"RTN","PSOERXX1",74,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXX1",75,0)
 I EXDT<DT S EXPFLG=1
"RTN","PSOERXX1",76,0)
 S REFL=$$GET1^DIQ(52,RXIEN,9,"I"),I=0 F  S I=$O(^PSRX(RXIEN,1,I)) Q:'I  S REFL=REFL-1
"RTN","PSOERXX1",77,0)
 I REFL>0,'$G(EXPFLG) W !!,"Refills remaining for this prescription. Cannot create refill request." D DIRE Q
"RTN","PSOERXX1",78,0)
 S (SIG,SIGLEN)=0 F  S SIG=$O(^PSRX(RXIEN,"INS1",SIG)) Q:'SIG  D
"RTN","PSOERXX1",79,0)
 .S SIGLEN=$G(SIGLEN)+$L(^PSRX(RXIEN,"INS1",SIG,0))
"RTN","PSOERXX1",80,0)
 I SIGLEN>140 W !!,"Sig is greater than 140 characters. Cannot create renewal request." D DIRE Q
"RTN","PSOERXX1",81,0)
 ; PSO*7*508 - check for previously sent eRx refill request
"RTN","PSOERXX1",82,0)
 S (DONE,RRCNT)=0,DTCUT=$$FMADD^XLFDT(DT,-30)
"RTN","PSOERXX1",83,0)
 S MSGIEN=999999999 F  S MSGIEN=$O(^PS(52.49,PSOIEN,201,"B",MSGIEN),-1) Q:'MSGIEN  D
"RTN","PSOERXX1",84,0)
 .I $$GET1^DIQ(52.49,MSGIEN,.08,"I")'="RR" Q
"RTN","PSOERXX1",85,0)
 .S MSGDT=$$GET1^DIQ(52.49,MSGIEN,.03,"I")
"RTN","PSOERXX1",86,0)
 .I MSGDT<DTCUT S DONE=1 Q
"RTN","PSOERXX1",87,0)
 .S RRCNT=$G(RRCNT)+1
"RTN","PSOERXX1",88,0)
 .S RESIEN=$$GETRESP^PSOERXU2(MSGIEN)
"RTN","PSOERXX1",89,0)
 .W !!,"********************************************************************"
"RTN","PSOERXX1",90,0)
 .W !!,"Previous Refill/Renewal Request Date/Time: "_$$FMTE^XLFDT(MSGDT)
"RTN","PSOERXX1",91,0)
 .W !,"Refill/Renewal Requested by: "_$$GET1^DIQ(52.49,MSGIEN,51.1,"E")
"RTN","PSOERXX1",92,0)
 .W !,"# of Refills Requested: "_$$GET1^DIQ(52.49,MSGIEN,51.2,"E")
"RTN","PSOERXX1",93,0)
 .I 'RESIEN D  Q
"RTN","PSOERXX1",94,0)
 ..W !!,"***No response received from provider.***",!
"RTN","PSOERXX1",95,0)
 ..S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXX1",96,0)
 .W !!,"Refill/Renewal response Date/Time: "_$$GET1^DIQ(52.49,RESIEN,.03,"E")
"RTN","PSOERXX1",97,0)
 .W !!,"Refill/Renewal response status: "_$$GET1^DIQ(52.49,RESIEN,1,"E")
"RTN","PSOERXX1",98,0)
 .W !!,"********************************************************************"
"RTN","PSOERXX1",99,0)
 I RRCNT>0 W !!,"Total Number of Refill/Renewal requests in the last 30 days: "_RRCNT,!!
"RTN","PSOERXX1",100,0)
 I RRCNT D  Q:'Y
"RTN","PSOERXX1",101,0)
 .K DIR S DIR(0)="YO",DIR("B")="N",DIR("A")="Are you sure you would like to send ANOTHER refill/renewal request" D ^DIR
"RTN","PSOERXX1",102,0)
 W !!,"Generating refill/renewal request for Rx #: "_$$GET1^DIQ(52,RXIEN,.01,"E"),!!
"RTN","PSOERXX1",103,0)
 K DIR S DIR(0)="SO^R:REFILL WITH PRE-POPULATED VALUE;C:CHANGE # OF REFILLS;E:EXIT"
"RTN","PSOERXX1",104,0)
 S DIR("?")="     E - Exit"
"RTN","PSOERXX1",105,0)
 S DIR("?",1)="     R - Request the same # of refills as the original Rx"
"RTN","PSOERXX1",106,0)
 S DIR("?",2)="     C - Request desired # of refills (0-11)"
"RTN","PSOERXX1",107,0)
 D ^DIR K DIR
"RTN","PSOERXX1",108,0)
 I Y="E"!$D(DIRUT)!(Y="^") Q
"RTN","PSOERXX1",109,0)
 ;Med Dispensed segments when the Qualifier is 'P' ('n' is the original Refill value sent on NEWRX)
"RTN","PSOERXX1",110,0)
 S REFQTY=$$GET1^DIQ(52,RXIEN,9,"I")
"RTN","PSOERXX1",111,0)
 I Y="R" D
"RTN","PSOERXX1",112,0)
 .S REFREQ=REFQTY
"RTN","PSOERXX1",113,0)
 ;Refill with change Quantity (questions to be displayed to the user such as # of refills, Pharmacist Notes and so on) 
"RTN","PSOERXX1",114,0)
 S DONE=0
"RTN","PSOERXX1",115,0)
 I Y="C" D
"RTN","PSOERXX1",116,0)
 .F  D  Q:DONE!($G(REFREQ)'="")
"RTN","PSOERXX1",117,0)
 ..S DIR(0)="NO^0:11",DIR("A")="Enter # of Refills or '^' to exit" D ^DIR K DIR
"RTN","PSOERXX1",118,0)
 ..Q:Y=""
"RTN","PSOERXX1",119,0)
 ..I Y="^"!$D(DIRUT) S DONE=1 Q
"RTN","PSOERXX1",120,0)
 ..S REFREQ=Y
"RTN","PSOERXX1",121,0)
 Q:DONE=1
"RTN","PSOERXX1",122,0)
 S REFREQ=REFREQ+1
"RTN","PSOERXX1",123,0)
 I '$G(REFREQ) W !!,"Number of Refills is required. Refill request cancelled." S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXX1",124,0)
 ; display information to the user
"RTN","PSOERXX1",125,0)
 W !!,"Sending refill request for:"
"RTN","PSOERXX1",126,0)
 W !!,"Patient: "_$$GET1^DIQ(52,RXIEN,2,"E")
"RTN","PSOERXX1",127,0)
 W !,"Patient Status: "_$$GET1^DIQ(52,RXIEN,3,"E")
"RTN","PSOERXX1",128,0)
 W !,"Drug: "_$$GET1^DIQ(52,RXIEN,6,"E")
"RTN","PSOERXX1",129,0)
 W !,"Orderable Item: "_$$GET1^DIQ(52,RXIEN,39.2,"E")
"RTN","PSOERXX1",130,0)
 W !,"# of Refills Requested: "_REFREQ,?30,"Days Supply: "_$$GET1^DIQ(52,RXIEN,8,"E"),?52,"Quantity: "_$$GET1^DIQ(52,RXIEN,7,"E")
"RTN","PSOERXX1",131,0)
 W !!,"Would you like to send this refill (renewal) request to the prescriber"
"RTN","PSOERXX1",132,0)
 S DIR(0)="YO",DIR("B")="N" D ^DIR K DIR
"RTN","PSOERXX1",133,0)
 I Y<1!(Y=U) S DIR(0)="E" W !!,"Refill Request cancelled! No refill request will be sent." D ^DIR K DIR Q
"RTN","PSOERXX1",134,0)
 S GBL=$$RREQ(PSOIEN,RXIEN,ORNUM,PSOSITE,.MESSID,REFREQ) I '$O(@GBL@(0)) W !!,"Could not create outgoing renewal message structure." D DIRE Q
"RTN","PSOERXX1",135,0)
 S PSSRET=$$RESTPOST^PSOERXO1(.PSSRET,.GBL)
"RTN","PSOERXX1",136,0)
 ; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERXX1",137,0)
 I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",138,0)
 I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",139,0)
 S HUBID=$G(PSSRET("outboundMsgId")) I 'HUBID W !,"The eRx Processing hub did not return a Hub identification number." S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",140,0)
 ; vista generated message will be V12345 (V concatenated to the hubId)
"RTN","PSOERXX1",141,0)
 S HUBID="V"_HUBID
"RTN","PSOERXX1",142,0)
 W !!,"Renewal Request sent." S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXX1",143,0)
 ; Validates if the order is an eRx and Logs Activity in AL eRx for Approved Refill Response Pending Renewal Activity 
"RTN","PSOERXX1",144,0)
 D RXACT^PSOBPSU2(RXIEN,,"Electronic Refill Request sent to External Provider","O")
"RTN","PSOERXX1",145,0)
 S I=0 F  S I=$O(@GBL@(I)) Q:'I!($G(SSSTART))  D
"RTN","PSOERXX1",146,0)
 .I $G(@GBL@(I,0))="<StructuredSIG>" S SSSTART=I Q
"RTN","PSOERXX1",147,0)
 S I=999999999 F  S I=$O(@GBL@(I),-1) Q:'I!$G(SSSTOP)  D
"RTN","PSOERXX1",148,0)
 .I $G(@GBL@(I,0))="</StructuredSIG>" S SSSTOP=I
"RTN","PSOERXX1",149,0)
 S GBL2=$NA(^TMP("STSIG^PSOERXX1",$J)) K @GBL2
"RTN","PSOERXX1",150,0)
 I $D(SSSTART),$D(SSSTOP) D
"RTN","PSOERXX1",151,0)
 .F I=SSSTART:1:SSSTOP D
"RTN","PSOERXX1",152,0)
 ..S @GBL2@(I,0)=@GBL@(I,0) K @GBL@(I,0)
"RTN","PSOERXX1",153,0)
 ; build streams
"RTN","PSOERXX1",154,0)
 S I=0 F  S I=$O(@GBL@(I)) Q:'I  D
"RTN","PSOERXX1",155,0)
 .S XXL1=$G(XXL1)_$G(@GBL@(I,0))
"RTN","PSOERXX1",156,0)
 I $D(@GBL2) D
"RTN","PSOERXX1",157,0)
 .S I=0 F  S I=$O(@GBL2@(I)) Q:'I  D
"RTN","PSOERXX1",158,0)
 ..S XXL2=$G(XXL2)_$G(@GBL2@(I,0))
"RTN","PSOERXX1",159,0)
 .S XXL2="<SIG>"_XXL2_"</SIG>"
"RTN","PSOERXX1",160,0)
 I '$D(XXL2) S XXL2=""
"RTN","PSOERXX1",161,0)
 N RES
"RTN","PSOERXX1",162,0)
 S VADAT=DUZ_U_RXIEN
"RTN","PSOERXX1",163,0)
 S RTHID=$$GET1^DIQ(52.49,PSOIEN,.01,"E")
"RTN","PSOERXX1",164,0)
 S HUBID=HUBID_U_U_RTHID
"RTN","PSOERXX1",165,0)
 D INCERX^PSOERXA1(.RES,.XXL1,"","","",STATION,DIV,HUBID,"",.XXL2,VADAT)
"RTN","PSOERXX1",166,0)
 I $P(RES,U)=0 D
"RTN","PSOERXX1",167,0)
 .W !,"A problem was encountered while trying to file the refill request."
"RTN","PSOERXX1",168,0)
 .W !,"Refill Request was not filed in vista."
"RTN","PSOERXX1",169,0)
 .W !!,"ERROR: "_$P(RES,U,2)
"RTN","PSOERXX1",170,0)
 .S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXX1",171,0)
 K @GBL
"RTN","PSOERXX1",172,0)
 Q
"RTN","PSOERXX1",173,0)
 ; CHANGE REQUEST VIA ERX HOLDING QUEUE
"RTN","PSOERXX1",174,0)
CREQHQ(PSOIEN,PSOSITE) ;
"RTN","PSOERXX1",175,0)
 N ORNUM,RXIEN,DRUG,GBL,DROK,CNT,PSSRET
"RTN","PSOERXX1",176,0)
 Q:'PSOIEN!('PSOSITE)
"RTN","PSOERXX1",177,0)
 ; IF THIS HASN'T BEEN SENT TO THE PRESCRIPTION FILE, WE DONT NEED ORDER OR RXIEN
"RTN","PSOERXX1",178,0)
 S ORNUM=$$GET1^DIQ(52.49,PSOIEN,.12,"I") ;I 'ORNUM W !!,"This order has been Accepted from eRx and cannot be changed." D DIRE Q
"RTN","PSOERXX1",179,0)
 S RXIEN=$O(^PSRX("APL",ORNUM,0)) ;I 'RXIEN W !!,"A current prescription exists for this eRx. Cannot change eRx." D DIRE Q
"RTN","PSOERXX1",180,0)
 ; build drug information into array to be passed into xml builder
"RTN","PSOERXX1",181,0)
 ; for future use
"RTN","PSOERXX1",182,0)
 ; may consider having the user fill in the drug validation screen then issue change request. Or replicate
"RTN","PSOERXX1",183,0)
 ; drug validation section into another 'Change Request' screen.
"RTN","PSOERXX1",184,0)
 S DROK=$$DRGPRMPT(.DRUG) I 'DROK W !!,"Insufficient drug information. Cannot create change request.",!,"Please try again." D DIRE Q
"RTN","PSOERXX1",185,0)
 S GBL=$$CREQ(PSOIEN,.DRUG,PSOSITE,ORNUM,RXIEN) I '$L(GBL) W !!,"Could not create outgoing message structure." D DIRE Q
"RTN","PSOERXX1",186,0)
 S PSSRET=$$RESTPOST^PSOERXO1(.PSSRET,.GBL)
"RTN","PSOERXX1",187,0)
 ; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERXX1",188,0)
 I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",189,0)
 I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",190,0)
 W !!,"Change Request sent." S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXX1",191,0)
 K @GBL
"RTN","PSOERXX1",192,0)
 Q
"RTN","PSOERXX1",193,0)
 ; RXFILL MESSAGE
"RTN","PSOERXX1",194,0)
FMES(PSOIEN) ;
"RTN","PSOERXX1",195,0)
 N ORNUM,RXIEN,DRUG,GBL,FTYPE,PSSRET,CNT
"RTN","PSOERXX1",196,0)
 Q:'PSOIEN
"RTN","PSOERXX1",197,0)
 S ORNUM=$$GET1^DIQ(52.49,PSOIEN,.12,"I") ;I 'ORNUM W !!,"No OE/RR order number. Cannot create refill request." D DIRE Q
"RTN","PSOERXX1",198,0)
 S RXIEN=$O(^PSRX("APL",ORNUM,0)) ;I 'RXIEN W !!,"Could not resolve RX #. Please contact technical support." D DIRE Q
"RTN","PSOERXX1",199,0)
 ; FOR NOW SET NOTE AND FTYPE (FULL/PARTIAL) FOR BUILDING XML
"RTN","PSOERXX1",200,0)
 S NOTE="TESTING NOTE"
"RTN","PSOERXX1",201,0)
 S FTYPE="F"
"RTN","PSOERXX1",202,0)
 S GBL=$$RXFILL(PSOIEN,FTYPE,NOTE,RXIEN,ORNUM) I '$L(GBL) W !!,"Could not create outgoing message structure." D DIRE Q
"RTN","PSOERXX1",203,0)
 ;W !!,"RxFill message sent to prescriber." S DIR(0)="E" D ^DIR K DIR 
"RTN","PSOERXX1",204,0)
 S PSSRET=$$RESTPOST^PSOERXO1(.PSSRET,.GBL)
"RTN","PSOERXX1",205,0)
 ; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERXX1",206,0)
 I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",207,0)
 I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXX1",208,0)
 W !!,"RxFill Message sent." S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXX1",209,0)
 ; if the message was successful, file the outbound message contents into 52.49
"RTN","PSOERXX1",210,0)
 K @GBL
"RTN","PSOERXX1",211,0)
 Q
"RTN","PSOERXX1",212,0)
 ; prompt for drug fields needed to create a change request - not currently used
"RTN","PSOERXX1",213,0)
DRGPRMPT(DRG) ;
"RTN","PSOERXX1",214,0)
 ; Prompt for drug
"RTN","PSOERXX1",215,0)
 N DIC,PSODRUG,DIR,Y
"RTN","PSOERXX1",216,0)
 S DIC(0)="AEMQ",DIC=50,DIC("S")="I $$ACTIVE^PSOERXA0(Y),($$OUTPAT^PSOERXA0(Y)),('$$INVCOMP^PSOERXA0(Y)),('$$CS^PSOERXA0(Y))" D ^DIC
"RTN","PSOERXX1",217,0)
 K DIC
"RTN","PSOERXX1",218,0)
 Q:$P(Y,U)<1 0
"RTN","PSOERXX1",219,0)
 ; FOR FUTURE USE - ADD ROUTE PROMPT
"RTN","PSOERXX1",220,0)
 ; Y=DRUG IEN^DRUG DESCRIPTION
"RTN","PSOERXX1",221,0)
 S DRG("DRUG")=$P(Y,U,2)
"RTN","PSOERXX1",222,0)
 S PSODRUG("IEN")=$P(Y,U)
"RTN","PSOERXX1",223,0)
 ; prompt for days supply
"RTN","PSOERXX1",224,0)
 K DIR S DIR(0)="52.49,20.2" D ^DIR
"RTN","PSOERXX1",225,0)
 Q:$P(Y,U)<1 0
"RTN","PSOERXX1",226,0)
 S DRG("DSUP")=Y
"RTN","PSOERXX1",227,0)
 ; prompt for quantity
"RTN","PSOERXX1",228,0)
 K DIR S DIR(0)="52.49,20.1" D ^DIR
"RTN","PSOERXX1",229,0)
 Q:$P(Y,U)<1 0
"RTN","PSOERXX1",230,0)
 S DRG("QTY")=Y
"RTN","PSOERXX1",231,0)
 ; prompt for refills
"RTN","PSOERXX1",232,0)
 K DIR S DIR(0)="52.49,20.5" D ^DIR
"RTN","PSOERXX1",233,0)
 Q:$P(Y,U)<1 0
"RTN","PSOERXX1",234,0)
 S DRG("REF")=Y
"RTN","PSOERXX1",235,0)
 ; prompt for directions
"RTN","PSOERXX1",236,0)
 K DIR S DIR(0)="52.49,7" D ^DIR
"RTN","PSOERXX1",237,0)
 Q:Y="^" 0
"RTN","PSOERXX1",238,0)
 Q:Y']"" 0
"RTN","PSOERXX1",239,0)
 S DRG("DIR")=Y
"RTN","PSOERXX1",240,0)
 Q 1
"RTN","PSOERXX1",241,0)
 ; CHANGE REQUEST VIA BACKDOOR ORDERS
"RTN","PSOERXX1",242,0)
CREQBD(RXIEN) ;
"RTN","PSOERXX1",243,0)
 Q
"RTN","PSOERXX1",244,0)
 ; CHANGE REQUEST VIA PSO LMOE FINISH
"RTN","PSOERXX1",245,0)
CREQPO(ORIEN) ;
"RTN","PSOERXX1",246,0)
 Q
"RTN","PSOERXX1",247,0)
RREQ(PSOIEN,RXIEN,ORNUM,PSOSITE,MESSID,REFREQ) ;RefillRequest
"RTN","PSOERXX1",248,0)
 N GBL,PSOIENS,CNT
"RTN","PSOERXX1",249,0)
 Q:'PSOIEN ""
"RTN","PSOERXX1",250,0)
 S GBL=$NA(^TMP("RREQ^PSOERXX1",$J)) K @GBL
"RTN","PSOERXX1",251,0)
 S CNT=0
"RTN","PSOERXX1",252,0)
 D MSG^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",253,0)
 ; header
"RTN","PSOERXX1",254,0)
 S MESSID=$$HDR^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",255,0)
 ; body header
"RTN","PSOERXX1",256,0)
 D BHF^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",257,0)
 ; request type header
"RTN","PSOERXX1",258,0)
 D RTYPE^PSOERXX2(.GBL,"RefillRequest",1)
"RTN","PSOERXX1",259,0)
 ; request info - not currently used
"RTN","PSOERXX1",260,0)
 ;D REQUEST^PSOERXX2(.GBL,"ACC","ACC")
"RTN","PSOERXX1",261,0)
 D VAPHARM^PSOERXX2(.GBL,PSOSITE,PSOIEN)
"RTN","PSOERXX1",262,0)
 D PRESCRIB^PSOERXX2(.GBL,PSOSITE,PSOIEN)
"RTN","PSOERXX1",263,0)
 D SUPERVIS^PSOERXX2(.GBL,PSOSITE,PSOIEN)
"RTN","PSOERXX1",264,0)
 D FACIL^PSOERXX2(.GBL,PSOSITE,PSOIEN)
"RTN","PSOERXX1",265,0)
 D PATIENT^PSOERXX3(.GBL,PSOSITE,PSOIEN)
"RTN","PSOERXX1",266,0)
 D MEDPRES^PSOERXX4(.GBL,PSOIEN,REFREQ,REFREQ)
"RTN","PSOERXX1",267,0)
 D MEDDIS^PSOERXX4(.GBL,RXIEN,ORNUM,PSOIEN,REFREQ)
"RTN","PSOERXX1",268,0)
 D OBSERVE^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",269,0)
 D BENEFITS^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",270,0)
 D DRUGEVAL^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",271,0)
 ;D DIAGNOS(.GBL,PSOIEN)
"RTN","PSOERXX1",272,0)
 D RTYPE^PSOERXX2(.GBL,"RefillRequest",2)
"RTN","PSOERXX1",273,0)
 D BHF^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",274,0)
 D MSG^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",275,0)
 Q GBL
"RTN","PSOERXX1",276,0)
 ; PSOIEN - erx IEN from 52.49
"RTN","PSOERXX1",277,0)
CREQ(PSOIEN,REQDRUG,PSOSITE,ORNUM,RXIEN) ;ChangeRequest
"RTN","PSOERXX1",278,0)
 N GBL,PSOIENS,CNT
"RTN","PSOERXX1",279,0)
 Q:'PSOIEN ""
"RTN","PSOERXX1",280,0)
 S GBL=$NA(^TMP("CREQ^PSOERXX1",$J)) K @GBL
"RTN","PSOERXX1",281,0)
 S CNT=0
"RTN","PSOERXX1",282,0)
 D MSG^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",283,0)
 ; header
"RTN","PSOERXX1",284,0)
 D HDR^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",285,0)
 ; body header
"RTN","PSOERXX1",286,0)
 D BHF^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",287,0)
 ; request type header
"RTN","PSOERXX1",288,0)
 D RTYPE^PSOERXX2(.GBL,"RxChangeRequest",1)
"RTN","PSOERXX1",289,0)
 ; request info
"RTN","PSOERXX1",290,0)
 D REQUEST^PSOERXX2(.GBL,"TST","TST")
"RTN","PSOERXX1",291,0)
 D VAPHARM^PSOERXX2(.GBL,PSOSITE,PSOIEN)
"RTN","PSOERXX1",292,0)
 D PRESCRIB^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",293,0)
 D SUPERVIS^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",294,0)
 D FACIL^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",295,0)
 D PATIENT^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",296,0)
 D MEDPRES^PSOERXX4(.GBL,PSOIEN)
"RTN","PSOERXX1",297,0)
 D MEDREQ^PSOERXX4(.GBL,PSOIEN,.REQDRUG)
"RTN","PSOERXX1",298,0)
 D OBSERVE^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",299,0)
 D BENEFITS^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",300,0)
 D DRUGEVAL^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",301,0)
 D DIAGNOS^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",302,0)
 D RTYPE^PSOERXX2(.GBL,"RxChangeRequest",2)
"RTN","PSOERXX1",303,0)
 D BHF^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",304,0)
 D MSG^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",305,0)
 Q GBL
"RTN","PSOERXX1",306,0)
 ; FP - full or partial fill (F/P)
"RTN","PSOERXX1",307,0)
 ; NOTE - fill notes
"RTN","PSOERXX1",308,0)
RXFILL(PSOIEN,FP,NOTE,RXIEN,ORNUM) ;
"RTN","PSOERXX1",309,0)
 N GBL,PSOIENS,CNT
"RTN","PSOERXX1",310,0)
 Q:'PSOIEN ""
"RTN","PSOERXX1",311,0)
 S GBL=$NA(^TMP("RXFILL^PSOERXX1",$J)) K @GBL
"RTN","PSOERXX1",312,0)
 S CNT=0
"RTN","PSOERXX1",313,0)
 D MSG^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",314,0)
 ; header
"RTN","PSOERXX1",315,0)
 D HDR^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",316,0)
 ; body header
"RTN","PSOERXX1",317,0)
 D BHF^PSOERXX2(.GBL,1)
"RTN","PSOERXX1",318,0)
 ; request type header
"RTN","PSOERXX1",319,0)
 D RTYPE^PSOERXX2(.GBL,"RxFill",1)
"RTN","PSOERXX1",320,0)
 ; request info
"RTN","PSOERXX1",321,0)
 ;D REQUEST(.GBL,"TEST1","TEST2")
"RTN","PSOERXX1",322,0)
 ;FP - full or partial fill
"RTN","PSOERXX1",323,0)
 S FP="F"
"RTN","PSOERXX1",324,0)
 S NOTE=$G(NOTE,"TESTING NOTES")
"RTN","PSOERXX1",325,0)
 ; fill status
"RTN","PSOERXX1",326,0)
 D FILLST^PSOERXX3(.GBL,FP,NOTE)
"RTN","PSOERXX1",327,0)
 D VAPHARM^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",328,0)
 D PRESCRIB^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",329,0)
 D SUPERVIS^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",330,0)
 D FACIL^PSOERXX2(.GBL,PSOIEN)
"RTN","PSOERXX1",331,0)
 D PATIENT^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",332,0)
 D MEDPRES^PSOERXX4(.GBL,PSOIEN)
"RTN","PSOERXX1",333,0)
 D MEDDIS^PSOERXX4(.GBL,PSOIEN)
"RTN","PSOERXX1",334,0)
 D OBSERVE^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",335,0)
 D BENEFITS^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",336,0)
 D DRUGEVAL^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",337,0)
 ;D DIAGNOS^PSOERXX3(.GBL,PSOIEN)
"RTN","PSOERXX1",338,0)
 D RTYPE^PSOERXX2(.GBL,"RxFill",2)
"RTN","PSOERXX1",339,0)
 D BHF^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",340,0)
 D MSG^PSOERXX2(.GBL,2)
"RTN","PSOERXX1",341,0)
 Q GBL
"RTN","PSOERXX1",342,0)
DIRE ;
"RTN","PSOERXX1",343,0)
 N DIR S DIR(0)="E" D ^DIR
"RTN","PSOERXX1",344,0)
 Q
"RTN","PSOERXX1",345,0)
CONVXML(ARYNM) ;
"RTN","PSOERXX1",346,0)
 N F,F2,F3,F4,DATA
"RTN","PSOERXX1",347,0)
 S F=0 F  S F=$O(@ARYNM@(F)) Q:F=""  D
"RTN","PSOERXX1",348,0)
 .S F2="" F  S F2=$O(@ARYNM@(F,F2)) Q:F2=""  D
"RTN","PSOERXX1",349,0)
 ..S F3="" F  S F3=$O(@ARYNM@(F,F2,F3)) Q:F3=""  D
"RTN","PSOERXX1",350,0)
 ...S F4="" F  S F4=$O(@ARYNM@(F,F2,F3,F4)) Q:F4=""  D
"RTN","PSOERXX1",351,0)
 ....S DATA=$G(@ARYNM@(F,F2,F3,F4))
"RTN","PSOERXX1",352,0)
 ....S DATA=$$SYMENC^MXMLUTL(DATA)
"RTN","PSOERXX1",353,0)
 ....S @ARYNM@(F,F2,F3,F4)=DATA
"RTN","PSOERXX1",354,0)
 Q
"RTN","PSOERXX2")
0^8^B185958519^B181162473
"RTN","PSOERXX2",1,0)
PSOERXX2 ;ALB/BWF - eRx xml utilities ; 8/3/2016 5:14pm
"RTN","PSOERXX2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,508**;DEC 1997;Build 295
"RTN","PSOERXX2",3,0)
 ;
"RTN","PSOERXX2",4,0)
 Q
"RTN","PSOERXX2",5,0)
MSG(GBL,HF) ;
"RTN","PSOERXX2",6,0)
 Q:'HF
"RTN","PSOERXX2",7,0)
 I HF=1 D C S @GBL@(CNT,0)="<?xml version=""1.0"" encoding=""UTF-8""?><Message version=""010"" release=""006"" HighestVersionSupported="""" xmlns=""http://www.ncpdp.org/schema/SCRIPT"">" Q
"RTN","PSOERXX2",8,0)
 I HF=2 D C S @GBL@(CNT,0)="</Message>"
"RTN","PSOERXX2",9,0)
 Q
"RTN","PSOERXX2",10,0)
HDR(GBL,IEN) ;
"RTN","PSOERXX2",11,0)
 N F,TOQUAL,TOVAL,FRQUAL,FRVAL,MID,STIME,STERTID,RTERTID,PON,RETREC,REQREF,PSDAT,INST,SSECID,RSECID,ERXHID
"RTN","PSOERXX2",12,0)
 N RTMID
"RTN","PSOERXX2",13,0)
 S F=52.49
"RTN","PSOERXX2",14,0)
 S IENS=IEN_","
"RTN","PSOERXX2",15,0)
 D GETS^DIQ(F,IENS,"**","IE","PSDAT")
"RTN","PSOERXX2",16,0)
 D CONVXML^PSOERXX1("PSDAT")
"RTN","PSOERXX2",17,0)
 S ERXHID=$G(PSDAT(F,IENS,.01,"E"))
"RTN","PSOERXX2",18,0)
 ; 'TO' values come from the 'FROM' fields of the eRx.
"RTN","PSOERXX2",19,0)
 S TOQUAL=$G(PSDAT(F,IENS,22.2,"I"))
"RTN","PSOERXX2",20,0)
 S TOVAL=$G(PSDAT(F,IENS,22.1,"E"))
"RTN","PSOERXX2",21,0)
 ; 'FROM' values come from the 'TO' fields of the eRx.
"RTN","PSOERXX2",22,0)
 S FRQUAL=$G(PSDAT(F,IENS,22.4,"I"))
"RTN","PSOERXX2",23,0)
 S FRVAL=$G(PSDAT(F,IENS,22.3,"E"))
"RTN","PSOERXX2",24,0)
 S INST=DUZ(2)
"RTN","PSOERXX2",25,0)
 ; message ID needs to be unique from vista - Site#.DUZ.erxIEN.date.time??
"RTN","PSOERXX2",26,0)
 S MID=INST_"."_DUZ_"."_PSOIEN_"."_$$NOW^XLFDT
"RTN","PSOERXX2",27,0)
 S RTMID=$G(PSDAT(F,IENS,25,"E"))
"RTN","PSOERXX2",28,0)
 ;
"RTN","PSOERXX2",29,0)
 S PON=$G(PSDAT(F,IENS,.09,"E"))
"RTN","PSOERXX2",30,0)
 ; return receipt and request reference # currenly not stored. Do we need to add a field in 52.49?
"RTN","PSOERXX2",31,0)
 S RETREC=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX2",32,0)
 S REQREF=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX2",33,0)
 S RETREC="ACA",REQREF=""
"RTN","PSOERXX2",34,0)
 S SSECID=$G(PSDAT(F,IENS,24.5,"E"))
"RTN","PSOERXX2",35,0)
 ; leaving this in place for now CH wanted the tertiary ID to be TECHNATOMY. I suspect this will
"RTN","PSOERXX2",36,0)
 ; need to be something different in the long run
"RTN","PSOERXX2",37,0)
 ;S STERTID=$G(PSDAT(F,IENS,24.6,"E"))
"RTN","PSOERXX2",38,0)
 S STERTID="TECHNATOMY"
"RTN","PSOERXX2",39,0)
 S RSECID=$G(PSDAT(F,IENS,24.3,"E"))
"RTN","PSOERXX2",40,0)
 ;S RTERTID=$G(PSDAT(F,IENS,24.4,"E"))
"RTN","PSOERXX2",41,0)
 S RTERTID="ERXPAD"
"RTN","PSOERXX2",42,0)
 D C S @GBL@(CNT,0)="<Header><To Qualifier="""_TOQUAL_""">"_TOVAL_"</To>"
"RTN","PSOERXX2",43,0)
 D C S @GBL@(CNT,0)="<From Qualifier="""_FRQUAL_""">"_FRVAL_"</From>"
"RTN","PSOERXX2",44,0)
 D C S @GBL@(CNT,0)="<MessageID>"_MID_"</MessageID>"
"RTN","PSOERXX2",45,0)
 ; relatesToMessageID is the CH messageID - FIELD 25
"RTN","PSOERXX2",46,0)
 I $L(RTMID) D C S @GBL@(CNT,0)="<RelatesToMessageID>"_RTMID_"</RelatesToMessageID>"
"RTN","PSOERXX2",47,0)
 D C S @GBL@(CNT,0)="<SentTime>"_$$EXTIME^PSOERXO1()_"</SentTime>"
"RTN","PSOERXX2",48,0)
 ; bwf - LOOK AT THE SECURITY SECTION AGAIN
"RTN","PSOERXX2",49,0)
 D C S @GBL@(CNT,0)="<Security>"
"RTN","PSOERXX2",50,0)
 ; bwf -  missing UsernameToken - consider as part of v3
"RTN","PSOERXX2",51,0)
 D C S @GBL@(CNT,0)="<Sender>"
"RTN","PSOERXX2",52,0)
 ; for now we are not using secondary identifications, this will stay in place for future activation.
"RTN","PSOERXX2",53,0)
 ;I $L(SSECID) D C S @GBL@(CNT,0)="<SecondaryIdentification>"_SSECID_"</SecondaryIdentification>"
"RTN","PSOERXX2",54,0)
 I $L(STERTID) D C S @GBL@(CNT,0)="<TertiaryIdentification>"_STERTID_"</TertiaryIdentification>"
"RTN","PSOERXX2",55,0)
 D C S @GBL@(CNT,0)="</Sender>"
"RTN","PSOERXX2",56,0)
 D C S @GBL@(CNT,0)="<Receiver>"
"RTN","PSOERXX2",57,0)
 ;I $L(RSECID) D C S @GBL@(CNT,0)="<SecondaryIdentification>"_RSECID_"</SecondaryIdentification>"
"RTN","PSOERXX2",58,0)
 I $L(RTERTID) D C S @GBL@(CNT,0)="<TertiaryIdentification>"_RTERTID_"</TertiaryIdentification>"
"RTN","PSOERXX2",59,0)
 D C S @GBL@(CNT,0)="</Receiver>"
"RTN","PSOERXX2",60,0)
 D C S @GBL@(CNT,0)="</Security>"
"RTN","PSOERXX2",61,0)
 ; missing 'Mailbox' - note for future enhancement. Was not needed for CH certification.
"RTN","PSOERXX2",62,0)
 D C S @GBL@(CNT,0)="<RxReferenceNumber>"_ERXHID_"</RxReferenceNumber>"
"RTN","PSOERXX2",63,0)
 I $L(PON) D C S @GBL@(CNT,0)="<PrescriberOrderNumber>"_PON_"</PrescriberOrderNumber>"
"RTN","PSOERXX2",64,0)
 D C S @GBL@(CNT,0)="</Header>"
"RTN","PSOERXX2",65,0)
 Q MID
"RTN","PSOERXX2",66,0)
 ; body header/footer
"RTN","PSOERXX2",67,0)
BHF(GBL,HF) ;
"RTN","PSOERXX2",68,0)
 Q:'$D(HF)
"RTN","PSOERXX2",69,0)
 D C
"RTN","PSOERXX2",70,0)
 S @GBL@(CNT,0)=$S(HF=1:"<Body>",HF=2:"</Body>",1:"")
"RTN","PSOERXX2",71,0)
 Q
"RTN","PSOERXX2",72,0)
 ;HF   1 - header
"RTN","PSOERXX2",73,0)
 ;     2 - footer
"RTN","PSOERXX2",74,0)
RTYPE(GBL,RTYPE,HF) ;
"RTN","PSOERXX2",75,0)
 Q:'HF
"RTN","PSOERXX2",76,0)
 D C
"RTN","PSOERXX2",77,0)
 S @GBL@(CNT,0)=$S(HF=1:"<"_RTYPE_">",HF=2:"</"_RTYPE_">",1:"")
"RTN","PSOERXX2",78,0)
 Q
"RTN","PSOERXX2",79,0)
REQUEST(GBL,RETREC,REQREF) ;
"RTN","PSOERXX2",80,0)
 D C S @GBL@(CNT,0)="<Request>"
"RTN","PSOERXX2",81,0)
 D C S @GBL@(CNT,0)="<ReturnReceipt>"_RETREC_"</ReturnReceipt>"
"RTN","PSOERXX2",82,0)
 D C S @GBL@(CNT,0)="<RequestReferenceNumber>"_REQREF_"</RequestReferenceNumber>"
"RTN","PSOERXX2",83,0)
 D C S @GBL@(CNT,0)="</Request>"
"RTN","PSOERXX2",84,0)
 Q
"RTN","PSOERXX2",85,0)
VAPHARM(GBL,PSOSITE,PSOIEN) ;
"RTN","PSOERXX2",86,0)
 N F,F2,NCPID,NPI,SPEC,LNAME,FNAME,MNAME,SUFF,PREF,STNM,ADDL1,ADDL2,CITY,STATE,PLQ,TELE,UIENS
"RTN","PSOERXX2",87,0)
 N PHIEN,PHIENS,EXPHIEN,EXPHIENS,PHARDAT,PHARDAT,PSDAT,AREA,FTELE,FULLNM,PDAT,PHRMCIST,SIENS
"RTN","PSOERXX2",88,0)
 N EIEN,EIENS,CMNUM,ID,IDTYP,IDVAL,CMVAL,CMQUAL
"RTN","PSOERXX2",89,0)
 S F=52.47,F2=52.48
"RTN","PSOERXX2",90,0)
 ; this is the vista pharmacy/pharmacist
"RTN","PSOERXX2",91,0)
 S EIEN=$$GET1^DIQ(52.49,PSOIEN,2.5,"I")
"RTN","PSOERXX2",92,0)
 S EIENS=EIEN_","
"RTN","PSOERXX2",93,0)
 S PHIEN=$$GET1^DIQ(52.49,PSOIEN,2.2,"I")
"RTN","PSOERXX2",94,0)
 S PHIENS=PHIEN_","
"RTN","PSOERXX2",95,0)
 D GETS^DIQ(F,EIENS,"**","IE","PHARDAT")
"RTN","PSOERXX2",96,0)
 S NCPID=$G(PHARDAT(F,EIENS,.02,"E"))
"RTN","PSOERXX2",97,0)
 D GETS^DIQ(F2,PHIENS,"**","IE","PHRMCIST")
"RTN","PSOERXX2",98,0)
 D CONVXML^PSOERXX1("PHARDAT"),CONVXML^PSOERXX1("PHRMCIST")
"RTN","PSOERXX2",99,0)
 ;S FULLNM=$G(PHRMCIST(F2,UIENS,.01,"E"))
"RTN","PSOERXX2",100,0)
 S LNAME=$G(PHRMCIST(F2,PHIENS,.02,"E"))
"RTN","PSOERXX2",101,0)
 S FNAME=$G(PHRMCIST(F2,PHIENS,.03,"E"))
"RTN","PSOERXX2",102,0)
 S MNAME=$G(PHRMCIST(F2,PHIENS,.04,"E"))
"RTN","PSOERXX2",103,0)
 S SUFF=$G(PHRMCIST(F2,PHIENS,.05,"E"))
"RTN","PSOERXX2",104,0)
 S PREF=$G(PHRMCIST(F2,PHIENS,.06,"E"))
"RTN","PSOERXX2",105,0)
 S NPI=$G(PHRMCIST(F2,PHIENS,1.5,"E"))
"RTN","PSOERXX2",106,0)
 S STNM=$G(PHARDAT(F,EIENS,.01,"E"))
"RTN","PSOERXX2",107,0)
 S ADDL1=$G(PHARDAT(F,EIENS,1.1,"E"))
"RTN","PSOERXX2",108,0)
 S ADDL2=$G(PHARDAT(F,EIENS,1.2,"E"))
"RTN","PSOERXX2",109,0)
 S CITY=$G(PHARDAT(F,EIENS,1.3,"E"))
"RTN","PSOERXX2",110,0)
 S STATE=$G(PHARDAT(F,EIENS,1.4,"I"))
"RTN","PSOERXX2",111,0)
 S STATE=$$STRES(STATE,PSOSITE)
"RTN","PSOERXX2",112,0)
 S ZIP=$G(PHARDAT(F,EIENS,1.5,"E")),ZIP=$TR(ZIP,"-","")
"RTN","PSOERXX2",113,0)
 ; address missing from NewRx
"RTN","PSOERXX2",114,0)
 I '$L(ADDL1) D
"RTN","PSOERXX2",115,0)
 .S ADDL1=$$GET1^DIQ(59,PSOSITE,.02,"E")
"RTN","PSOERXX2",116,0)
 .S ADDL2=""
"RTN","PSOERXX2",117,0)
 .S CITY=$$GET1^DIQ(59,PSOSITE,.07,"E")
"RTN","PSOERXX2",118,0)
 .S STATE=$$GET1^DIQ(59,PSOSITE,.08,"I")
"RTN","PSOERXX2",119,0)
 .I STATE S STATE=$$GET1^DIQ(5,STATE,1,"E")
"RTN","PSOERXX2",120,0)
 .S ZIP=$E($$GET1^DIQ(59,PSOSITE,.05,"E"),1,5)
"RTN","PSOERXX2",121,0)
 D C S @GBL@(CNT,0)="<Pharmacy>"
"RTN","PSOERXX2",122,0)
 I $O(^PS(52.47,EIEN,2,0)) D
"RTN","PSOERXX2",123,0)
 .D C S @GBL@(CNT,0)="<Identification>"
"RTN","PSOERXX2",124,0)
 .S ID=0 F  S ID=$O(^PS(52.47,EIEN,2,ID)) Q:'ID  D
"RTN","PSOERXX2",125,0)
 ..S IDTYP=$$GET1^DIQ(52.472,ID_","_EIEN_",",.01,"E")
"RTN","PSOERXX2",126,0)
 ..S IDVAL=$$GET1^DIQ(52.472,ID_","_EIEN_",",.02,"E")
"RTN","PSOERXX2",127,0)
 ..F VAR="IDTYP","IDVAL" S @VAR=$$SYMENC^MXMLUTL(@VAR)
"RTN","PSOERXX2",128,0)
 ..D C S @GBL@(CNT,0)="<"_IDTYP_">"_IDVAL_"</"_IDTYP_">"
"RTN","PSOERXX2",129,0)
 .D C S @GBL@(CNT,0)="</Identification>"
"RTN","PSOERXX2",130,0)
 ;D C S @GBL@(CNT,0)="<Specialty>"_SPEC_"</Specialty>"
"RTN","PSOERXX2",131,0)
 I $L(LNAME) D
"RTN","PSOERXX2",132,0)
 .D C S @GBL@(CNT,0)="<Pharmacist>"
"RTN","PSOERXX2",133,0)
 .I $L(LNAME) D C S @GBL@(CNT,0)="<LastName>"_LNAME_"</LastName>"
"RTN","PSOERXX2",134,0)
 .I $L(FNAME) D C S @GBL@(CNT,0)="<FirstName>"_FNAME_"</FirstName>"
"RTN","PSOERXX2",135,0)
 .I $L(MNAME) D C S @GBL@(CNT,0)="<MiddleName>"_MNAME_"</MiddleName>"
"RTN","PSOERXX2",136,0)
 .I $L(SUFF) D C S @GBL@(CNT,0)="<Suffix>"_SUFF_"</Suffix>"
"RTN","PSOERXX2",137,0)
 .I $L(PREF) D C S @GBL@(CNT,0)="<Prefix>"_PREF_"</Prefix>"
"RTN","PSOERXX2",138,0)
 .D C S @GBL@(CNT,0)="</Pharmacist>"
"RTN","PSOERXX2",139,0)
 I $L(STNM) D C S @GBL@(CNT,0)="<StoreName>"_STNM_"</StoreName>"
"RTN","PSOERXX2",140,0)
 I $L(ADDL1)!($L(ADDL2))!($L(CITY))!($L(STATE))!($L(ZIP)) D
"RTN","PSOERXX2",141,0)
 .D C S @GBL@(CNT,0)="<Address>"
"RTN","PSOERXX2",142,0)
 .I $L(ADDL1) D C S @GBL@(CNT,0)="<AddressLine1>"_ADDL1_"</AddressLine1>"
"RTN","PSOERXX2",143,0)
 .I $L(ADDL2) D C S @GBL@(CNT,0)="<AddressLine2>"_ADDL2_"</AddressLine2>"
"RTN","PSOERXX2",144,0)
 .I $L(CITY) D C S @GBL@(CNT,0)="<City>"_CITY_"</City>"
"RTN","PSOERXX2",145,0)
 .I $L(STATE) D C S @GBL@(CNT,0)="<State>"_STATE_"</State>"
"RTN","PSOERXX2",146,0)
 .I $L(ZIP) D C S @GBL@(CNT,0)="<ZipCode>"_ZIP_"</ZipCode>"
"RTN","PSOERXX2",147,0)
 .;D C S @GBL@(CNT,0)="<PlaceLocationQualifier>"_PLQ_"</PlaceLocationQualifier>"
"RTN","PSOERXX2",148,0)
 .D C S @GBL@(CNT,0)="</Address>"
"RTN","PSOERXX2",149,0)
 I '$O(^PS(52.47,EIEN,3,0)) D
"RTN","PSOERXX2",150,0)
 .S CMVAL=$$GET1^DIQ(59,PSOIEN,.03,"E")
"RTN","PSOERXX2",151,0)
 .S CMVAL=CMVAL_$$GET1^DIQ(59,PSOIEN,.04,"E")
"RTN","PSOERXX2",152,0)
 .I '$L(CMVAL) S CMVAL="0000000000"
"RTN","PSOERXX2",153,0)
 .S CMVAL=$TR(CMVAL,"-","")
"RTN","PSOERXX2",154,0)
 .S CMQUAL="TE"
"RTN","PSOERXX2",155,0)
 .D C S @GBL@(CNT,0)="<CommunicationNumbers>"
"RTN","PSOERXX2",156,0)
 .D COMMNUM(.GBL,CMVAL,CMQUAL)
"RTN","PSOERXX2",157,0)
 .D COMMNUM(.GBL,"0000000000","FX")
"RTN","PSOERXX2",158,0)
 .D C S @GBL@(CNT,0)="</CommunicationNumbers>"
"RTN","PSOERXX2",159,0)
 I $O(^PS(52.47,EIEN,3,0)) D
"RTN","PSOERXX2",160,0)
 .D C S @GBL@(CNT,0)="<CommunicationNumbers>"
"RTN","PSOERXX2",161,0)
 .S CMNUM=0 F  S CMNUM=$O(^PS(52.47,EIEN,3,CMNUM)) Q:'CMNUM  D
"RTN","PSOERXX2",162,0)
 ..S CMVAL=$$GET1^DIQ(52.473,CMNUM_","_EIEN_",",.01,"E")
"RTN","PSOERXX2",163,0)
 ..S CMQUAL=$$GET1^DIQ(52.473,CMNUM_","_EIEN_",",.02,"I")
"RTN","PSOERXX2",164,0)
 ..D COMMNUM(.GBL,CMVAL,CMQUAL)
"RTN","PSOERXX2",165,0)
 .D C S @GBL@(CNT,0)="</CommunicationNumbers>"
"RTN","PSOERXX2",166,0)
 D C S @GBL@(CNT,0)="</Pharmacy>"
"RTN","PSOERXX2",167,0)
 Q
"RTN","PSOERXX2",168,0)
 ; GBL - global for xml storage
"RTN","PSOERXX2",169,0)
 ; IENS - ien string for the current entry
"RTN","PSOERXX2",170,0)
 ; FIL - top level file number
"RTN","PSOERXX2",171,0)
 ; SUBFIL - subfile number
"RTN","PSOERXX2",172,0)
COMMNUM(GBL,COMMNUM,QUAL) ;
"RTN","PSOERXX2",173,0)
 D C S @GBL@(CNT,0)="<Communication>"
"RTN","PSOERXX2",174,0)
 D C S @GBL@(CNT,0)="<Number>"_$$SYMENC^MXMLUTL(COMMNUM)_"</Number>"
"RTN","PSOERXX2",175,0)
 D C S @GBL@(CNT,0)="<Qualifier>"_$$SYMENC^MXMLUTL(QUAL)_"</Qualifier>"
"RTN","PSOERXX2",176,0)
 D C S @GBL@(CNT,0)="</Communication>"
"RTN","PSOERXX2",177,0)
 Q
"RTN","PSOERXX2",178,0)
IDENT(GBL,TYPE,VAL) ;
"RTN","PSOERXX2",179,0)
 N VAR
"RTN","PSOERXX2",180,0)
 F VAR="TYPE","VAL" S @VAR=$$SYMENC^MXMLUTL(@VAR)
"RTN","PSOERXX2",181,0)
 D C S @GBL@(CNT,0)="<"_TYPE_">"_VAL_"</"_TYPE_">"
"RTN","PSOERXX2",182,0)
 Q
"RTN","PSOERXX2",183,0)
 ; GBL - GLOBAL WHERE DATA IS STORED
"RTN","PSOERXX2",184,0)
 ; IEN - IEN TO 52.49
"RTN","PSOERXX2",185,0)
PRESCRIB(GBL,PSOSITE,IEN) ;
"RTN","PSOERXX2",186,0)
 N F,DEAN,NPI,SPEC,CLINIC,LNAME,FNAME,MNAME,SUFF,PREF,ADDL1,ADDL2,CITY,STATE,ZIP,PLQ,ALNAME,AFNAME,AMNAME,ASUFF,APREF
"RTN","PSOERXX2",187,0)
 N PSDAT,CLOOP,CNUM,CQUAL,ILOOP,ITYP,IVAL,PIEN,PIENS
"RTN","PSOERXX2",188,0)
 S F=52.48,IENS=IEN_","
"RTN","PSOERXX2",189,0)
 S PIEN=$$GET1^DIQ(52.49,IEN,2.1,"I") Q:'PIEN
"RTN","PSOERXX2",190,0)
 S PIENS=PIEN_","
"RTN","PSOERXX2",191,0)
 D GETS^DIQ(F,PIENS,"**","IE","PSDAT")
"RTN","PSOERXX2",192,0)
 D CONVXML^PSOERXX1("PSDAT")
"RTN","PSOERXX2",193,0)
 S DEAN=$G(PSDAT(F,PIENS,1.6,"E"))
"RTN","PSOERXX2",194,0)
 S NPI=$G(PSDAT(F,PIENS,1.5,"E"))
"RTN","PSOERXX2",195,0)
 S SPEC=$G(PSDAT(F,PIENS,1.2,"E"))
"RTN","PSOERXX2",196,0)
 S CLINIC=$G(PSDAT(F,PIENS,2.1,"E"))
"RTN","PSOERXX2",197,0)
 S LNAME=$G(PSDAT(F,PIENS,.02,"E"))
"RTN","PSOERXX2",198,0)
 S FNAME=$G(PSDAT(F,PIENS,.03,"E"))
"RTN","PSOERXX2",199,0)
 S MNAME=$G(PSDAT(F,PIENS,.04,"E"))
"RTN","PSOERXX2",200,0)
 S SUFF=$G(PSDAT(F,PIENS,.05,"E"))
"RTN","PSOERXX2",201,0)
 S PREF=$G(PSDAT(F,PIENS,.06,"E"))
"RTN","PSOERXX2",202,0)
 S ADDL1=$G(PSDAT(F,PIENS,4.1,"E"))
"RTN","PSOERXX2",203,0)
 S ADDL2=$G(PSDAT(F,PIENS,4.2,"E"))
"RTN","PSOERXX2",204,0)
 S CITY=$G(PSDAT(F,PIENS,4.3,"E"))
"RTN","PSOERXX2",205,0)
 S STATE=$G(PSDAT(F,PIENS,4.4,"I"))
"RTN","PSOERXX2",206,0)
 S STATE=$$STRES(STATE,PSOSITE)
"RTN","PSOERXX2",207,0)
 S ZIP=$G(PSDAT(F,PIENS,4.5,"E"))
"RTN","PSOERXX2",208,0)
 S PLQ=$G(PSDAT(F,PIENS,2.2,"E"))
"RTN","PSOERXX2",209,0)
 S ALNAME=$G(PSDAT(F,PIENS,5.1,"E"))
"RTN","PSOERXX2",210,0)
 S AFNAME=$G(PSDAT(F,PIENS,5.2,"E"))
"RTN","PSOERXX2",211,0)
 S AMNAME=$G(PSDAT(F,PIENS,5.3,"E"))
"RTN","PSOERXX2",212,0)
 S ASUFF=$G(PSDAT(F,PIENS,5.4,"E"))
"RTN","PSOERXX2",213,0)
 S APREF=$G(PSDAT(F,PIENS,5.5,"E"))
"RTN","PSOERXX2",214,0)
 D C S @GBL@(CNT,0)="<Prescriber>"
"RTN","PSOERXX2",215,0)
 I $O(^PS(52.48,PIEN,6,0)) D
"RTN","PSOERXX2",216,0)
 .D C S @GBL@(CNT,0)="<Identification>"
"RTN","PSOERXX2",217,0)
 .S ILOOP=0 F  S ILOOP=$O(^PS(52.48,PIEN,6,ILOOP)) Q:'ILOOP  D
"RTN","PSOERXX2",218,0)
 ..S ITYP=$$GET1^DIQ(52.486,ILOOP_","_PIENS,.01,"E")
"RTN","PSOERXX2",219,0)
 ..S IVAL=$$GET1^DIQ(52.486,ILOOP_","_PIENS,.02,"E")
"RTN","PSOERXX2",220,0)
 ..D IDENT(.GBL,ITYP,IVAL)
"RTN","PSOERXX2",221,0)
 .D C S @GBL@(CNT,0)="</Identification>"
"RTN","PSOERXX2",222,0)
 I $L(SPEC) D C S @GBL@(CNT,0)="<Specialty>"_SPEC_"</Specialty>" ; ***SLASH AT THE END???
"RTN","PSOERXX2",223,0)
 I $L(CLINIC) D C S @GBL@(CNT,0)="<ClinicName>"_CLINIC_"</ClinicName>" ; ***SLASH AT THE END???
"RTN","PSOERXX2",224,0)
 D C S @GBL@(CNT,0)="<Name>"
"RTN","PSOERXX2",225,0)
 I $L(LNAME) D C S @GBL@(CNT,0)="<LastName>"_LNAME_"</LastName>"
"RTN","PSOERXX2",226,0)
 I $L(FNAME) D C S @GBL@(CNT,0)="<FirstName>"_FNAME_"</FirstName>"
"RTN","PSOERXX2",227,0)
 I $L(MNAME) D C S @GBL@(CNT,0)="<MiddleName>"_MNAME_"</MiddleName>"
"RTN","PSOERXX2",228,0)
 I $L(SUFF) D C S @GBL@(CNT,0)="<Suffix>"_SUFF_"</Suffix>"
"RTN","PSOERXX2",229,0)
 I $L(PREF) D C S @GBL@(CNT,0)="<Prefix>"_PREF_"</Prefix>"
"RTN","PSOERXX2",230,0)
 D C S @GBL@(CNT,0)="</Name>"
"RTN","PSOERXX2",231,0)
 D C S @GBL@(CNT,0)="<Address>"
"RTN","PSOERXX2",232,0)
 I $L(ADDL1) D C S @GBL@(CNT,0)="<AddressLine1>"_ADDL1_"</AddressLine1>"
"RTN","PSOERXX2",233,0)
 I $L(ADDL2) D C S @GBL@(CNT,0)="<AddressLine2>"_ADDL2_"</AddressLine2>"
"RTN","PSOERXX2",234,0)
 I $L(CITY) D C S @GBL@(CNT,0)="<City>"_CITY_"</City>"
"RTN","PSOERXX2",235,0)
 I $L(STATE) D C S @GBL@(CNT,0)="<State>"_STATE_"</State>"
"RTN","PSOERXX2",236,0)
 I $L(ZIP) D C S @GBL@(CNT,0)="<ZipCode>"_ZIP_"</ZipCode>"
"RTN","PSOERXX2",237,0)
 I $L(PLQ) D C S @GBL@(CNT,0)="<PlaceLocationQualifier>"_PLQ_"</PlaceLocationQualifier>"
"RTN","PSOERXX2",238,0)
 D C S @GBL@(CNT,0)="</Address>"
"RTN","PSOERXX2",239,0)
 I $O(^PS(52.48,PIEN,3,0)) D
"RTN","PSOERXX2",240,0)
 .D C S @GBL@(CNT,0)="<CommunicationNumbers>"
"RTN","PSOERXX2",241,0)
 .S CLOOP=0 F  S CLOOP=$O(^PS(52.48,PIEN,3,CLOOP)) Q:'CLOOP  D
"RTN","PSOERXX2",242,0)
 ..S CNUM=$$GET1^DIQ(52.483,CLOOP_","_PIENS,.01,"E")
"RTN","PSOERXX2",243,0)
 ..S CQUAL=$$GET1^DIQ(52.483,CLOOP_","_PIENS,.02,"I")
"RTN","PSOERXX2",244,0)
 ..D COMMNUM(.GBL,CNUM,CQUAL)
"RTN","PSOERXX2",245,0)
 .D C S @GBL@(CNT,0)="</CommunicationNumbers>"
"RTN","PSOERXX2",246,0)
 I $L(ALNAME) D
"RTN","PSOERXX2",247,0)
 .D C S @GBL@(CNT,0)="<PrescriberAgent>"
"RTN","PSOERXX2",248,0)
 .I $L(ALNAME) D C S @GBL@(CNT,0)="<LastName>"_ALNAME_"</LastName>"
"RTN","PSOERXX2",249,0)
 .I $L(AFNAME) D C S @GBL@(CNT,0)="<FirstName>"_AFNAME_"</FirstName>"
"RTN","PSOERXX2",250,0)
 .I $L(AMNAME) D C S @GBL@(CNT,0)="<MiddleName>"_AMNAME_"</MiddleName>"
"RTN","PSOERXX2",251,0)
 .I $L(ASUFF) D C S @GBL@(CNT,0)="<Suffix>"_ASUFF_"</Suffix>"
"RTN","PSOERXX2",252,0)
 .I $L(APREF) D C S @GBL@(CNT,0)="<Prefix>"_APREF_"</Prefix>"
"RTN","PSOERXX2",253,0)
 .D C S @GBL@(CNT,0)="</PrescriberAgent>"
"RTN","PSOERXX2",254,0)
 D C S @GBL@(CNT,0)="</Prescriber>"
"RTN","PSOERXX2",255,0)
 Q
"RTN","PSOERXX2",256,0)
SUPERVIS(GBL,PSOSITE,IEN) ;
"RTN","PSOERXX2",257,0)
 N F,SLN,DEAN,SPEC,LNAME,FNAME,MNAME,SUFF,PREF,CLNAME,ADDL1,ADDL2,CITY,STATE,ZIP,PLQ,PSDAT,ILOOP,ITYP,IVAL
"RTN","PSOERXX2",258,0)
 N SIEN,SIENS
"RTN","PSOERXX2",259,0)
 S F=52.48
"RTN","PSOERXX2",260,0)
 S IENS=IEN_","
"RTN","PSOERXX2",261,0)
 S SIEN=$$GET1^DIQ(52.49,IEN,2.6,"I") Q:'SIEN
"RTN","PSOERXX2",262,0)
 S SIENS=SIEN_","
"RTN","PSOERXX2",263,0)
 D GETS^DIQ(F,SIENS,"**","IE","PSDAT")
"RTN","PSOERXX2",264,0)
 D CONVXML^PSOERXX1("PSDAT")
"RTN","PSOERXX2",265,0)
 S SLN=$G(PSDAT(F,SIENS,1.8,"E"))
"RTN","PSOERXX2",266,0)
 S DEAN=$G(PSDAT(F,SIENS,1.6,"E"))
"RTN","PSOERXX2",267,0)
 S SPEC=$G(PSDAT(F,SIENS,1.2,"E"))
"RTN","PSOERXX2",268,0)
 S LNAME=$G(PSDAT(F,SIENS,.02,"E"))
"RTN","PSOERXX2",269,0)
 S FNAME=$G(PSDAT(F,SIENS,.03,"E"))
"RTN","PSOERXX2",270,0)
 S MNAME=$G(PSDAT(F,SIENS,.04,"E"))
"RTN","PSOERXX2",271,0)
 S SUFF=$G(PSDAT(F,SIENS,.05,"E"))
"RTN","PSOERXX2",272,0)
 S PREF=$G(PSDAT(F,SIENS,.06,"E"))
"RTN","PSOERXX2",273,0)
 S CLNAME=$G(PSDAT(F,SIENS,2.1,"E"))
"RTN","PSOERXX2",274,0)
 S ADDL1=$G(PSDAT(F,SIENS,4.1,"E"))
"RTN","PSOERXX2",275,0)
 S ADDL2=$G(PSDAT(F,SIENS,4.2,"E"))
"RTN","PSOERXX2",276,0)
 S CITY=$G(PSDAT(F,SIENS,4.3,"E"))
"RTN","PSOERXX2",277,0)
 S STATE=$G(PSDAT(F,SIENS,4.4,"I"))
"RTN","PSOERXX2",278,0)
 S STATE=$$STRES(STATE)
"RTN","PSOERXX2",279,0)
 S ZIP=$G(PSDAT(F,SIENS,4.5,"E"))
"RTN","PSOERXX2",280,0)
 S PLQ=$G(PSDAT(F,SIENS,2.2,"E"))
"RTN","PSOERXX2",281,0)
 D C S @GBL@(CNT,0)="<Supervisor>"
"RTN","PSOERXX2",282,0)
 I $O(^PS(52.48,SIEN,6,0)) D
"RTN","PSOERXX2",283,0)
 .D C S @GBL@(CNT,0)="<Identification>"
"RTN","PSOERXX2",284,0)
 .S ILOOP=0 F  S ILOOP=$O(^PS(52.48,SIEN,6,ILOOP)) Q:'ILOOP  D
"RTN","PSOERXX2",285,0)
 ..S ITYP=$$GET1^DIQ(52.486,ILOOP_","_SIENS,.01,"E")
"RTN","PSOERXX2",286,0)
 ..S IVAL=$$GET1^DIQ(52.486,ILOOP_","_SIENS,.02,"E")
"RTN","PSOERXX2",287,0)
 ..D IDENT(.GBL,ITYP,IVAL)
"RTN","PSOERXX2",288,0)
 .D C S @GBL@(CNT,0)="</Identification>"
"RTN","PSOERXX2",289,0)
 D C S @GBL@(CNT,0)="<Specialty>"_SPEC_"</Specialty>"
"RTN","PSOERXX2",290,0)
 D C S @GBL@(CNT,0)="<Name>"
"RTN","PSOERXX2",291,0)
 D C S @GBL@(CNT,0)="<LastName>"_LNAME_"</LastName>"
"RTN","PSOERXX2",292,0)
 D C S @GBL@(CNT,0)="<FirstName>"_FNAME_"</FirstName>"
"RTN","PSOERXX2",293,0)
 D C S @GBL@(CNT,0)="<MiddleName>"_MNAME_"</MiddleName>"
"RTN","PSOERXX2",294,0)
 D C S @GBL@(CNT,0)="<Suffix>"_SUFF_"</Suffix>"
"RTN","PSOERXX2",295,0)
 D C S @GBL@(CNT,0)="<Prefix>"_PREF_"</Prefix>"
"RTN","PSOERXX2",296,0)
 D C S @GBL@(CNT,0)="</Name>"
"RTN","PSOERXX2",297,0)
 D C S @GBL@(CNT,0)="<ClinicName>"_CLNAME_"</ClinicName>"
"RTN","PSOERXX2",298,0)
 D C S @GBL@(CNT,0)="<Address>"
"RTN","PSOERXX2",299,0)
 D C S @GBL@(CNT,0)="<AddressLine1>"_ADDL1_"</AddressLine1>"
"RTN","PSOERXX2",300,0)
 D C S @GBL@(CNT,0)="<AddressLine2>"_ADDL2_"</AddressLine2>"
"RTN","PSOERXX2",301,0)
 D C S @GBL@(CNT,0)="<City>"_CITY_"</City>"
"RTN","PSOERXX2",302,0)
 D C S @GBL@(CNT,0)="<State>"_STATE_"</State>"
"RTN","PSOERXX2",303,0)
 I $L(ZIP) D C S @GBL@(CNT,0)="<ZipCode>"_ZIP_"</ZipCode>"
"RTN","PSOERXX2",304,0)
 D C S @GBL@(CNT,0)="<PlaceLocationQualifier>"_PLQ_"</PlaceLocationQualifier>"
"RTN","PSOERXX2",305,0)
 D C S @GBL@(CNT,0)="</Address>"
"RTN","PSOERXX2",306,0)
 D C S @GBL@(CNT,0)="<CommunicationNumbers>"
"RTN","PSOERXX2",307,0)
 S CLOOP=0 F  S CLOOP=$O(^PS(52.48,SIEN,3,CLOOP)) Q:'CLOOP  D
"RTN","PSOERXX2",308,0)
 .S CNUM=$$GET1^DIQ(52.483,CLOOP_","_SIENS,.01,"E")
"RTN","PSOERXX2",309,0)
 .S CQUAL=$$GET1^DIQ(52.483,CLOOP_","_SIENS,.02,"I")
"RTN","PSOERXX2",310,0)
 .D COMMNUM(.GBL,CNUM,CQUAL)
"RTN","PSOERXX2",311,0)
 ; ***COMMUNICATION NUMBERS***
"RTN","PSOERXX2",312,0)
 D C S @GBL@(CNT,0)="</CommunicationNumbers>"
"RTN","PSOERXX2",313,0)
 D C S @GBL@(CNT,0)="</Supervisor>"
"RTN","PSOERXX2",314,0)
 Q
"RTN","PSOERXX2",315,0)
FACIL(GBL,PSOSITE,IENS) ;
"RTN","PSOERXX2",316,0)
 N F,NPI,NAME,ADDL1,ADDL2,CITY,STATE,ZIP,PLQ,PSDAT
"RTN","PSOERXX2",317,0)
 S F=52.49
"RTN","PSOERXX2",318,0)
 ; FOR NOW, JUST BUILD HEADER AND FOOTER
"RTN","PSOERXX2",319,0)
 Q
"RTN","PSOERXX2",320,0)
 D C S @GBL@(CNT,0)="<Facility>"
"RTN","PSOERXX2",321,0)
 D C S @GBL@(CNT,0)="</Facility>"
"RTN","PSOERXX2",322,0)
 Q
"RTN","PSOERXX2",323,0)
 ; complete this as a future enhancement
"RTN","PSOERXX2",324,0)
 D GETS^DIQ(F,IENS,"**","IE","PSDAT")
"RTN","PSOERXX2",325,0)
 D CONVXML^PSOERXX1("PSDAT")
"RTN","PSOERXX2",326,0)
 S NPI=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX2",327,0)
 S NAME=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX2",328,0)
 S ADDL1=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX2",329,0)
 S ADDL2=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX2",330,0)
 S CITY=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX2",331,0)
 S STATE=$G(PSDAT(F,IENS,1,"I"))
"RTN","PSOERXX2",332,0)
 S STATE=$$STRES(STATE)
"RTN","PSOERXX2",333,0)
 S ZIP=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX2",334,0)
 S PLQ=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX2",335,0)
 D C S @GBL@(CNT,0)="<Facility>"
"RTN","PSOERXX2",336,0)
 I $L(NPI) D
"RTN","PSOERXX2",337,0)
 .D C S @GBL@(CNT,0)="<Identification>"
"RTN","PSOERXX2",338,0)
 .D C S @GBL@(CNT,0)="<NPI>"_NPI_"<NPI>"
"RTN","PSOERXX2",339,0)
 .D C S @GBL@(CNT,0)="</Identification>"
"RTN","PSOERXX2",340,0)
 D C S @GBL@(CNT,0)="<FacilityName>"_NAME_"</FacilityName>"
"RTN","PSOERXX2",341,0)
 D C S @GBL@(CNT,0)="<Address>"
"RTN","PSOERXX2",342,0)
 D C S @GBL@(CNT,0)="<AddressLine1>"_ADDL1_"</AddressLine1>"
"RTN","PSOERXX2",343,0)
 D C S @GBL@(CNT,0)="<AddressLine2>"_ADDL2_"</AddressLine2>"
"RTN","PSOERXX2",344,0)
 D C S @GBL@(CNT,0)="<City>"_CITY_"</City>"
"RTN","PSOERXX2",345,0)
 D C S @GBL@(CNT,0)="<State>"_STATE_"</State>"
"RTN","PSOERXX2",346,0)
 I $L(ZIP) D C S @GBL@(CNT,0)="<ZipCode>"_ZIP_"</ZipCode>"
"RTN","PSOERXX2",347,0)
 D C S @GBL@(CNT,0)="<PlaceLocationQualifier>"_PLQ_"</PlaceLocationQualifier>"
"RTN","PSOERXX2",348,0)
 D C S @GBL@(CNT,0)="</Address>"
"RTN","PSOERXX2",349,0)
 ;***COMMUNICATION NUMBERS
"RTN","PSOERXX2",350,0)
 D C S @GBL@(CNT,0)="</Facility>"
"RTN","PSOERXX2",351,0)
 Q
"RTN","PSOERXX2",352,0)
C ;
"RTN","PSOERXX2",353,0)
 S CNT=$G(CNT)+1
"RTN","PSOERXX2",354,0)
 Q
"RTN","PSOERXX2",355,0)
STRES(STATE,PSOSITE) ;
"RTN","PSOERXX2",356,0)
 N SIEN
"RTN","PSOERXX2",357,0)
 S SIEN=""
"RTN","PSOERXX2",358,0)
 I STATE S SIEN=$$GET1^DIQ(5,STATE,1,"E") Q SIEN
"RTN","PSOERXX2",359,0)
 ; if the state cannot be resolved, use the state from file 59
"RTN","PSOERXX2",360,0)
 I 'SIEN S SIEN=$$GET1^DIQ(59,PSOSITE,.08,"I")
"RTN","PSOERXX2",361,0)
 ; if there is still no state, use the state from the physical address of the institution: IA 2171
"RTN","PSOERXX2",362,0)
 I 'SIEN S SIEN=$P($$PADD^XUAF4(DUZ(2)),U,3)
"RTN","PSOERXX2",363,0)
 Q SIEN
"RTN","PSOERXX3")
0^9^B84060041^B81556769
"RTN","PSOERXX3",1,0)
PSOERXX3 ;ALB/BWF - eRx xml utilities ; 8/3/2016 5:14pm
"RTN","PSOERXX3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,508**;DEC 1997;Build 295
"RTN","PSOERXX3",3,0)
 ;
"RTN","PSOERXX3",4,0)
 Q
"RTN","PSOERXX3",5,0)
PATIENT(GBL,PSOISTE,IEN) ;
"RTN","PSOERXX3",6,0)
 N F,PATREL,LNAME,FNAME,MNAME,SUFF,PREF,GENDER,DOB,ADDL1,ADDL2,CITY,STATE,ZIP,PLQ,CUNIT,BED,ROOM,PSDAT,ILOOP
"RTN","PSOERXX3",7,0)
 N ITYP,IVAL,CLOOP,CNUM,CQUAL,PIEN,PIENS,PSSN
"RTN","PSOERXX3",8,0)
 S F=52.46
"RTN","PSOERXX3",9,0)
 S PIEN=$$GET1^DIQ(52.49,IEN,.04,"I") Q:'PIEN
"RTN","PSOERXX3",10,0)
 S PIENS=PIEN_","
"RTN","PSOERXX3",11,0)
 D GETS^DIQ(F,PIENS,"**","IE","PSDAT")
"RTN","PSOERXX3",12,0)
 D CONVXML^PSOERXX1("PSDAT")
"RTN","PSOERXX3",13,0)
 S PATREL=$G(PSDAT(F,PIENS,1.7,"I"))
"RTN","PSOERXX3",14,0)
 S LNAME=$G(PSDAT(F,PIENS,.02,"E"))
"RTN","PSOERXX3",15,0)
 S FNAME=$G(PSDAT(F,PIENS,.03,"E"))
"RTN","PSOERXX3",16,0)
 S MNAME=$G(PSDAT(F,PIENS,.04,"E"))
"RTN","PSOERXX3",17,0)
 S SUFF=$G(PSDAT(F,PIENS,.05,"E"))
"RTN","PSOERXX3",18,0)
 S PREF=$G(PSDAT(F,PIENS,.06,"E"))
"RTN","PSOERXX3",19,0)
 S GENDER=$G(PSDAT(F,PIENS,.07,"I"))
"RTN","PSOERXX3",20,0)
 ; DOB NEEDS TO BE CONVERTED
"RTN","PSOERXX3",21,0)
 S DOB=$G(PSDAT(F,PIENS,.08,"I")) I DOB S DOB=$P($$EXTIME^PSOERXO1(DOB),"T")
"RTN","PSOERXX3",22,0)
 S ADDL1=$G(PSDAT(F,PIENS,3.1,"E"))
"RTN","PSOERXX3",23,0)
 S ADDL2=$G(PSDAT(F,PIENS,3.2,"E"))
"RTN","PSOERXX3",24,0)
 S CITY=$G(PSDAT(F,PIENS,3.3,"E"))
"RTN","PSOERXX3",25,0)
 S STATE=$G(PSDAT(F,PIENS,3.4,"I"))
"RTN","PSOERXX3",26,0)
 S STATE=$$STRES^PSOERXX2(STATE,PSOSITE)
"RTN","PSOERXX3",27,0)
 S ZIP=$G(PSDAT(F,PIENS,3.5,"E"))
"RTN","PSOERXX3",28,0)
 S PLQ=$G(PSDAT(F,PIENS,1.6,"E"))
"RTN","PSOERXX3",29,0)
 S PSSN=$G(PSDAT(F,PIENS,1.4,"E"))
"RTN","PSOERXX3",30,0)
 ; FUTURE ENHANCEMENT, GRAB CUNIT/BED/ROOM FROM CORRECT LOCATIONS. THIS LOGIC IS NOT ACTIVE WITH VERSION 2 
"RTN","PSOERXX3",31,0)
 S CUNIT=$G(PSDAT(F,PIENS,1,"E"))
"RTN","PSOERXX3",32,0)
 S BED=$G(PSDAT(F,PIENS,1,"E"))
"RTN","PSOERXX3",33,0)
 S ROOM=$G(PSDAT(F,PIENS,1,"E"))
"RTN","PSOERXX3",34,0)
 D C S @GBL@(CNT,0)="<Patient>"
"RTN","PSOERXX3",35,0)
 I $L(PATREL) D C S @GBL@(CNT,0)="<PatientRelationship>"_PATREL_"</PatientRelationship>"
"RTN","PSOERXX3",36,0)
 I '$O(^PS(52.46,PIEN,5,0)) D
"RTN","PSOERXX3",37,0)
 .I PSSN D
"RTN","PSOERXX3",38,0)
 ..D C S @GBL@(CNT,0)="<Identification>"
"RTN","PSOERXX3",39,0)
 ..D C S @GBL@(CNT,0)="<SocialSecurity>"_PSSN_"</SocialSecurity>"
"RTN","PSOERXX3",40,0)
 ..D C S @GBL@(CNT,0)="</Identification>"
"RTN","PSOERXX3",41,0)
 I $O(^PS(52.46,PIEN,5,0)) D
"RTN","PSOERXX3",42,0)
 .D C S @GBL@(CNT,0)="<Identification>"
"RTN","PSOERXX3",43,0)
 .S ILOOP=0 F  S ILOOP=$O(^PS(52.46,PIEN,5,ILOOP)) Q:'ILOOP  D
"RTN","PSOERXX3",44,0)
 ..S ITYP=$$GET1^DIQ(52.465,ILOOP_","_PIENS,.01,"E")
"RTN","PSOERXX3",45,0)
 ..S IVAL=$$GET1^DIQ(52.465,ILOOP_","_PIENS,.02,"E")
"RTN","PSOERXX3",46,0)
 ..D IDENT^PSOERXX2(.GBL,ITYP,IVAL)
"RTN","PSOERXX3",47,0)
 .D C S @GBL@(CNT,0)="</Identification>"
"RTN","PSOERXX3",48,0)
 D C S @GBL@(CNT,0)="<Name>"
"RTN","PSOERXX3",49,0)
 I $L(LNAME) D C S @GBL@(CNT,0)="<LastName>"_LNAME_"</LastName>"
"RTN","PSOERXX3",50,0)
 I $L(FNAME) D C S @GBL@(CNT,0)="<FirstName>"_FNAME_"</FirstName>"
"RTN","PSOERXX3",51,0)
 I $L(MNAME) D C S @GBL@(CNT,0)="<MiddleName>"_MNAME_"</MiddleName>"
"RTN","PSOERXX3",52,0)
 I $L(SUFF) D C S @GBL@(CNT,0)="<Suffix>"_SUFF_"</Suffix>"
"RTN","PSOERXX3",53,0)
 I $L(PREF) D C S @GBL@(CNT,0)="<Prefix>"_PREF_"</Prefix>"
"RTN","PSOERXX3",54,0)
 D C S @GBL@(CNT,0)="</Name>"
"RTN","PSOERXX3",55,0)
 I $L(GENDER) D C S @GBL@(CNT,0)="<Gender>"_GENDER_"</Gender>"
"RTN","PSOERXX3",56,0)
 I $L(DOB) D
"RTN","PSOERXX3",57,0)
 .D C S @GBL@(CNT,0)="<DateOfBirth>"
"RTN","PSOERXX3",58,0)
 .D C S @GBL@(CNT,0)="<Date>"_DOB_"</Date>"
"RTN","PSOERXX3",59,0)
 .D C S @GBL@(CNT,0)="</DateOfBirth>"
"RTN","PSOERXX3",60,0)
 I $L(ADDL1) D
"RTN","PSOERXX3",61,0)
 .D C S @GBL@(CNT,0)="<Address>"
"RTN","PSOERXX3",62,0)
 .I $L(ADDL1) D C S @GBL@(CNT,0)="<AddressLine1>"_ADDL1_"</AddressLine1>"
"RTN","PSOERXX3",63,0)
 .I $L(ADDL2) D C S @GBL@(CNT,0)="<AddressLine2>"_ADDL2_"</AddressLine2>"
"RTN","PSOERXX3",64,0)
 .I $L(CITY) D C S @GBL@(CNT,0)="<City>"_CITY_"</City>"
"RTN","PSOERXX3",65,0)
 .I $L(STATE) D C S @GBL@(CNT,0)="<State>"_STATE_"</State>"
"RTN","PSOERXX3",66,0)
 .I $L(ZIP) D C S @GBL@(CNT,0)="<ZipCode>"_ZIP_"</ZipCode>"
"RTN","PSOERXX3",67,0)
 .I $L(PLQ) D C S @GBL@(CNT,0)="<PlaceLocationQualifier>"_PLQ_"</PlaceLocationQualifier>"
"RTN","PSOERXX3",68,0)
 .D C S @GBL@(CNT,0)="</Address>"
"RTN","PSOERXX3",69,0)
 I $O(^PS(52.46,PIEN,3,0)) D
"RTN","PSOERXX3",70,0)
 .D C S @GBL@(CNT,0)="<CommunicationNumbers>"
"RTN","PSOERXX3",71,0)
 .S CLOOP=0 F  S CLOOP=$O(^PS(52.46,PIEN,3,CLOOP)) Q:'CLOOP  D
"RTN","PSOERXX3",72,0)
 ..S CNUM=$$GET1^DIQ(52.462,CLOOP_","_PIENS,.01,"E")
"RTN","PSOERXX3",73,0)
 ..S CQUAL=$$GET1^DIQ(52.462,CLOOP_","_PIENS,.02,"I")
"RTN","PSOERXX3",74,0)
 ..D COMMNUM^PSOERXX2(.GBL,CNUM,CQUAL)
"RTN","PSOERXX3",75,0)
 .D C S @GBL@(CNT,0)="</CommunicationNumbers>"
"RTN","PSOERXX3",76,0)
 I $L(CUNIT)!($L(BED))!($L(ROOM)) D
"RTN","PSOERXX3",77,0)
 .D C S @GBL@(CNT,0)="<PatientLocation>"
"RTN","PSOERXX3",78,0)
 .I $L(CUNIT) D C S @GBL@(CNT,0)="<FacilityUnit>"_CUNIT_"</FacilityUnit>"
"RTN","PSOERXX3",79,0)
 .I $L(BED) D C S @GBL@(CNT,0)="<Bed>"_BED_"</Bed>"
"RTN","PSOERXX3",80,0)
 .I $L(ROOM) D C S @GBL@(CNT,0)="<Room>"_ROOM_"</Room>"
"RTN","PSOERXX3",81,0)
 .D C S @GBL@(CNT,0)="</PatientLocation>"
"RTN","PSOERXX3",82,0)
 D C S @GBL@(CNT,0)="</Patient>"
"RTN","PSOERXX3",83,0)
 Q
"RTN","PSOERXX3",84,0)
FILLST(GBL,FTYPE,FNOTE) ;
"RTN","PSOERXX3",85,0)
 D C S @GBL@(CNT,0)="<FillStatus>"
"RTN","PSOERXX3",86,0)
 D C S @GBL@(CNT,0)=$S(FTYPE="F":"<Filled>",FTYPE="P":"<PartialFill>",1:"")
"RTN","PSOERXX3",87,0)
 D C S @GBL@(CNT,0)="<Note>"_FNOTE_"</Note>"
"RTN","PSOERXX3",88,0)
 D C S @GBL@(CNT,0)=$S(FTYPE="F":"</Filled>",FTYPE="P":"</PartialFill>",1:"")
"RTN","PSOERXX3",89,0)
 D C S @GBL@(CNT,0)="</FillStatus>"
"RTN","PSOERXX3",90,0)
 Q
"RTN","PSOERXX3",91,0)
BENEFITS(GBL,IEN) ;
"RTN","PSOERXX3",92,0)
 N F,NCPDPID,NCPDPID,PAYNAME,CARDID,LNAME,FNAME,MNAME,SUFF,PREF,GID,PSDAT,BIENS,BLOOP
"RTN","PSOERXX3",93,0)
 S IENS=IEN_","
"RTN","PSOERXX3",94,0)
 S F=52.4918
"RTN","PSOERXX3",95,0)
 I '$O(^PS(52.49,IEN,18,0)) Q
"RTN","PSOERXX3",96,0)
 D C S @GBL@(CNT,0)="<BenefitsCoordination>"
"RTN","PSOERXX3",97,0)
 S BLOOP=0 F  S BLOOP=$O(^PS(52.49,IEN,18,BLOOP)) Q:'BLOOP  D
"RTN","PSOERXX3",98,0)
 .S BIENS=BLOOP_","_IENS
"RTN","PSOERXX3",99,0)
 .K PSDAT
"RTN","PSOERXX3",100,0)
 .D GETS^DIQ(F,BIENS,"**","IE","PSDAT")
"RTN","PSOERXX3",101,0)
 .D CONVXML^PSOERXX1("PSDAT")
"RTN","PSOERXX3",102,0)
 .; FUTURE ENHANCEMENT - the IDENTIFICATION multiple is where the NCPDPID info belongs, USE IDENTIFICATION MULTIPLE IN THE PAYER SUBFILE
"RTN","PSOERXX3",103,0)
 .;S NCPDPID=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX3",104,0)
 .;FUTURE ENHANCEMENT - STORE PAYER NAME DIFFERENTLY AN..35
"RTN","PSOERXX3",105,0)
 .S PAYNAME=$E($G(PSDAT(F,BIENS,.03,"E")),1,35)
"RTN","PSOERXX3",106,0)
 .S CARDID=$G(PSDAT(F,BIENS,.01,"E"))
"RTN","PSOERXX3",107,0)
 .S LNAME=$G(PSDAT(F,BIENS,1,"E"))
"RTN","PSOERXX3",108,0)
 .S FNAME=$G(PSDAT(F,BIENS,2,"E"))
"RTN","PSOERXX3",109,0)
 .S MNAME=$G(PSDAT(F,BIENS,3,"E"))
"RTN","PSOERXX3",110,0)
 .S SUFF=$G(PSDAT(F,BIENS,4,"E"))
"RTN","PSOERXX3",111,0)
 .S PREF=$G(PSDAT(F,BIENS,5,"E"))
"RTN","PSOERXX3",112,0)
 .S GID=$G(PSDAT(F,BIENS,.02,"E"))
"RTN","PSOERXX3",113,0)
 .; FUTURE ENHANCEMENT, INCLUDE PAYER IDENTIFICATION INFORMATION
"RTN","PSOERXX3",114,0)
 .;D C S @GBL@(CNT,0)="<PayerIdentification>"
"RTN","PSOERXX3",115,0)
 .;S IDLOOP=0 F  S IDLOOP=$O(^PS(52.49,IEN,18,BLOOP,6,IDLOOP)) Q:'IDLOOP  D
"RTN","PSOERXX3",116,0)
 .;.S ITYP=$$GET1^DIQ(52.49186,IDLOOP_","_BLOOP_","_IENS,.01,"E")
"RTN","PSOERXX3",117,0)
 .;.S IVAL=$$GET1^DIQ(52.49186,IDLOOP_","_BLOOP_","_IENS,.02,"E")
"RTN","PSOERXX3",118,0)
 .;.D IDENT(.GBL,ITYP,IVAL)
"RTN","PSOERXX3",119,0)
 .;D C S @GBL@(CNT,0)="</PayerIdentification>"
"RTN","PSOERXX3",120,0)
 .;D C S @GBL@(CNT,0)="<PayerName>"_PAYNAME_"</PayerName>"
"RTN","PSOERXX3",121,0)
 .I $L(CARDID) D C S @GBL@(CNT,0)="<CardholderID>"_CARDID_"</CardholderID>"
"RTN","PSOERXX3",122,0)
 .D C S @GBL@(CNT,0)="<CardHolderName>"
"RTN","PSOERXX3",123,0)
 .I $L(LNAME) D C S @GBL@(CNT,0)="<LastName>"_LNAME_"</LastName>"
"RTN","PSOERXX3",124,0)
 .I $L(FNAME) D C S @GBL@(CNT,0)="<FirstName>"_FNAME_"</FirstName>"
"RTN","PSOERXX3",125,0)
 .I $L(MNAME) D C S @GBL@(CNT,0)="<MiddleName>"_MNAME_"</MiddleName>"
"RTN","PSOERXX3",126,0)
 .I $L(SUFF) D C S @GBL@(CNT,0)="<Suffix>"_SUFF_"</Suffix>"
"RTN","PSOERXX3",127,0)
 .I $L(PREF) D C S @GBL@(CNT,0)="<Prefix>"_PREF_"</Prefix>"
"RTN","PSOERXX3",128,0)
 .D C S @GBL@(CNT,0)="</CardHolderName>"
"RTN","PSOERXX3",129,0)
 .I $L(GID) D C S @GBL@(CNT,0)="<GroupID>"_GID_"</GroupID>"
"RTN","PSOERXX3",130,0)
 D C S @GBL@(CNT,0)="</BenefitsCoordination>"
"RTN","PSOERXX3",131,0)
 Q
"RTN","PSOERXX3",132,0)
OBSERVE(GBL,IEN) ;
"RTN","PSOERXX3",133,0)
 N F,DIMENS,VALUE,OBDATE,MDQ,MSC,MUC,OBNOTE,PSDAT,OIENS,OLOOP
"RTN","PSOERXX3",134,0)
 S F=52.4914
"RTN","PSOERXX3",135,0)
 S IENS=IEN_","
"RTN","PSOERXX3",136,0)
 S OLOOP=0 F  S OLOOP=$O(^PS(52.49,IEN,14,OLOOP)) Q:'OLOOP  D
"RTN","PSOERXX3",137,0)
 .S OIENS=OLOOP_","_IENS
"RTN","PSOERXX3",138,0)
 .K PSDAT
"RTN","PSOERXX3",139,0)
 .D GETS^DIQ(F,OIENS,"**","IE","PSDAT")
"RTN","PSOERXX3",140,0)
 .D CONVXML^PSOERXX1("PSDAT")
"RTN","PSOERXX3",141,0)
 .S DIMENS=$G(PSDAT(F,OIENS,.02,"E"))
"RTN","PSOERXX3",142,0)
 .S VALUE=$G(PSDAT(F,OIENS,.03,"E"))
"RTN","PSOERXX3",143,0)
 .; convert observation date
"RTN","PSOERXX3",144,0)
 .S OBDATE=$G(PSDAT(F,OIENS,.04,"I")) I OBDATE S OBDATE=$P($$EXTIME^PSOERXO1(OBDATE),"T")
"RTN","PSOERXX3",145,0)
 .S MDQ=$G(PSDAT(F,OIENS,.05,"I"))
"RTN","PSOERXX3",146,0)
 .S MSC=$G(PSDAT(F,OIENS,.06,"E"))
"RTN","PSOERXX3",147,0)
 .S MUC=$G(PSDAT(F,OIENS,.07,"E"))
"RTN","PSOERXX3",148,0)
 .S OBNOTE=$G(PSDAT(F,OIENS,15,"E"))
"RTN","PSOERXX3",149,0)
 .D C S @GBL@(CNT,0)="<Observation>"
"RTN","PSOERXX3",150,0)
 .D C S @GBL@(CNT,0)="<Measurement>"
"RTN","PSOERXX3",151,0)
 .D C S @GBL@(CNT,0)="<Dimension>"_DIMENS_"</Dimension>"
"RTN","PSOERXX3",152,0)
 .D C S @GBL@(CNT,0)="<Value>"_VALUE_"</Value>"
"RTN","PSOERXX3",153,0)
 .I $L(OBDATE) D
"RTN","PSOERXX3",154,0)
 ..D C S @GBL@(CNT,0)="<ObservationDate>"
"RTN","PSOERXX3",155,0)
 ..D C S @GBL@(CNT,0)="<Date>"_OBDATE_"</Date>"
"RTN","PSOERXX3",156,0)
 ..D C S @GBL@(CNT,0)="</ObservationDate>"
"RTN","PSOERXX3",157,0)
 .I $L(MDQ) D C S @GBL@(CNT,0)="<MeasurementDataQualifier>"_MDQ_"</MeasurementDataQualifier>"
"RTN","PSOERXX3",158,0)
 .I $L(MSC) D C S @GBL@(CNT,0)="<MeasurementSourceCode>"_MSC_"</MeasurementSourceCode>"
"RTN","PSOERXX3",159,0)
 .I $L(MUC) D C S @GBL@(CNT,0)="<MeasurementUnitCode>"_MUC_"</MeasurementUnitCode>"
"RTN","PSOERXX3",160,0)
 .D C S @GBL@(CNT,0)="</Measurement>"
"RTN","PSOERXX3",161,0)
 .I $L(OBNOTE) D
"RTN","PSOERXX3",162,0)
 ..D C S @GBL@(CNT,0)="<ObservationNotes>"_OBNOTE_"</ObservationNotes>"
"RTN","PSOERXX3",163,0)
 .D C S @GBL@(CNT,0)="</Observation>"
"RTN","PSOERXX3",164,0)
 Q
"RTN","PSOERXX3",165,0)
DRUGEVAL(GBL,IEN) ;
"RTN","PSOERXX3",166,0)
 N F,SRC,PSC,SERVRC,CAID,CAQ,CSC,AR,PSDAT,DLOOP
"RTN","PSOERXX3",167,0)
 Q
"RTN","PSOERXX3",168,0)
 S F=52.4916
"RTN","PSOERXX3",169,0)
 S DLOOP=0 F  S DLOOP=$O(^PS(52.49,IEN,16,DLOOP)) Q:'DLOOP  D
"RTN","PSOERXX3",170,0)
 .S IENS=IEN_","_DLOOP_","
"RTN","PSOERXX3",171,0)
 .K PSDAT D GETS^DIQ(F,IENS,"**","IE","PSDAT")
"RTN","PSOERXX3",172,0)
 .D CONVXML^PSOERXX1("PSDAT")
"RTN","PSOERXX3",173,0)
 .S SRC=$G(PSDAT(F,IENS,.01,"E"))
"RTN","PSOERXX3",174,0)
 .S PSC=$G(PSDAT(F,IENS,.02,"E"))
"RTN","PSOERXX3",175,0)
 .S SERVRC=$G(PSDAT(F,IENS,.03,"E"))
"RTN","PSOERXX3",176,0)
 .S CAID=$G(PSDAT(F,IENS,.04,"E"))
"RTN","PSOERXX3",177,0)
 .S CAQ=$G(PSDAT(F,IENS,.05,"E"))
"RTN","PSOERXX3",178,0)
 .S CSC=$G(PSDAT(F,IENS,.06,"E"))
"RTN","PSOERXX3",179,0)
 .S AR=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX3",180,0)
 .D C S @GBL@(CNT,0)="<DrugUseEvaluation>"
"RTN","PSOERXX3",181,0)
 .D C S @GBL@(CNT,0)="<ServiceReasonCode>"_SRC_"</ServiceReasonCode>"
"RTN","PSOERXX3",182,0)
 .D C S @GBL@(CNT,0)="<ProfessionalServiceCode>"_PSC_"</ProfessionalServiceCode>"
"RTN","PSOERXX3",183,0)
 .D C S @GBL@(CNT,0)="<ServiceResultCode>"_SERVRC_"</ServiceResultCode>"
"RTN","PSOERXX3",184,0)
 .D C S @GBL@(CNT,0)="<CoAgent>"
"RTN","PSOERXX3",185,0)
 .D C S @GBL@(CNT,0)="<CoAgentID>"_CAID_"</CoAgentID>"
"RTN","PSOERXX3",186,0)
 .D C S @GBL@(CNT,0)="<CoAgentQualifier>"_CAQ_"</CoAgentQualifier>"
"RTN","PSOERXX3",187,0)
 .D C S @GBL@(CNT,0)="</CoAgent>"
"RTN","PSOERXX3",188,0)
 .D C S @GBL@(CNT,0)="<ClinicalSignificanceCode>"_CSC_"</ClinicalSignificanceCode>"
"RTN","PSOERXX3",189,0)
 .D C S @GBL@(CNT,0)="<AcknowledgementReason>"_AR_"</AcknowledgementReason>"
"RTN","PSOERXX3",190,0)
 .D C S @GBL@(CNT,0)="</DrugUseEvaluation>"
"RTN","PSOERXX3",191,0)
 Q
"RTN","PSOERXX3",192,0)
DIAGNOS(GBL,IENS) ;
"RTN","PSOERXX3",193,0)
 N F,CIQ,PQUAL,PVAL,SQUAL,SVAL,PSDAT
"RTN","PSOERXX3",194,0)
 S F=52.499
"RTN","PSOERXX3",195,0)
 D GETS^DIQ(F,IENS,"**","IE","PSDAT")
"RTN","PSOERXX3",196,0)
 D CONVXML^PSOERXX1("PSDAT")
"RTN","PSOERXX3",197,0)
 S CIQ=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX3",198,0)
 S PQUAL=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX3",199,0)
 S PVAL=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX3",200,0)
 S SQUAL=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX3",201,0)
 S SVAL=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX3",202,0)
 ;FUTURE ENHANCEMENT - FOR NOW JUST BUILD HEADER/FOOTER AND QUIT, LATER BUILD THE REST
"RTN","PSOERXX3",203,0)
 D C S @GBL@(CNT,0)="<Diagnosis>"
"RTN","PSOERXX3",204,0)
 D C S @GBL@(CNT,0)="</Diagnosis>"
"RTN","PSOERXX3",205,0)
 Q
"RTN","PSOERXX3",206,0)
 D C S @GBL@(CNT,0)="<Diagnosis>"
"RTN","PSOERXX3",207,0)
 D C S @GBL@(CNT,0)="<ClinicalInformationQualifier>"_CIQ_"</ClinicalInformationQualifier>"
"RTN","PSOERXX3",208,0)
 D C S @GBL@(CNT,0)="<Primary>"
"RTN","PSOERXX3",209,0)
 D C S @GBL@(CNT,0)="<Qualifier>"_PQUAL_"</Qualifier>"
"RTN","PSOERXX3",210,0)
 D C S @GBL@(CNT,0)="<Value>"_PVAL_"</Value>"
"RTN","PSOERXX3",211,0)
 D C S @GBL@(CNT,0)="</Primary>"
"RTN","PSOERXX3",212,0)
 D C S @GBL@(CNT,0)="<Secondary>"
"RTN","PSOERXX3",213,0)
 D C S @GBL@(CNT,0)="<Qualifier>"_SQUAL_"</Qualifier>"
"RTN","PSOERXX3",214,0)
 D C S @GBL@(CNT,0)="<Value>"_SVAL_"</VALUE>"
"RTN","PSOERXX3",215,0)
 D C S @GBL@(CNT,0)="</Secondary>"
"RTN","PSOERXX3",216,0)
 D C S @GBL@(CNT,0)="</Diagnosis>"
"RTN","PSOERXX3",217,0)
 Q
"RTN","PSOERXX3",218,0)
C ;
"RTN","PSOERXX3",219,0)
 S CNT=$G(CNT)+1
"RTN","PSOERXX3",220,0)
 Q
"RTN","PSOERXX4")
0^10^B109158139^B86144240
"RTN","PSOERXX4",1,0)
PSOERXX4 ;ALB/BWF - eRx xml utilities ; 8/3/2016 5:14pm
"RTN","PSOERXX4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,508**;DEC 1997;Build 295
"RTN","PSOERXX4",3,0)
 ;
"RTN","PSOERXX4",4,0)
 Q
"RTN","PSOERXX4",5,0)
 ; GBL - global location
"RTN","PSOERXX4",6,0)
 ; IEN - erx ien
"RTN","PSOERXX4",7,0)
 ; REQOR - refill qualifier override (optional)
"RTN","PSOERXX4",8,0)
 ; REFREQ - refills requested
"RTN","PSOERXX4",9,0)
MEDPRES(GBL,IEN,REQOR,REFREQ) ;
"RTN","PSOERXX4",10,0)
 N F,DRUGDES,PRODCODE,PCQUAL,STRENGTH,DDBCODE,DDBCQUAL,FSCODE,FCODE,SSCODE,SCODE,DEASCH,QTYVAL,CLQUAL,USCODE,PUC,DAYSUPP
"RTN","PSOERXX4",11,0)
 N DIRECT,NOTE,REQUAL,SUB,WDATE,LFDATE,EXDATE,EFDATE,PEND,DOD,DATEVAL,PAQUAL,PAVAL,DCS,PAS,REVAL,PSDAT,DCS,DCSVAL,DCLOOP
"RTN","PSOERXX4",12,0)
 N IENS,SIENS,SLOOP,RXIEN
"RTN","PSOERXX4",13,0)
 S IENS=IEN_","
"RTN","PSOERXX4",14,0)
 S F=52.49
"RTN","PSOERXX4",15,0)
 D GETS^DIQ(F,IENS,"**","IE","PSDAT")
"RTN","PSOERXX4",16,0)
 D CONVXML^PSOERXX1("PSDAT")
"RTN","PSOERXX4",17,0)
 S DRUGDES=$G(PSDAT(F,IENS,3.1,"E"))
"RTN","PSOERXX4",18,0)
 S PRODCODE=$G(PSDAT(F,IENS,4.1,"E"))
"RTN","PSOERXX4",19,0)
 S PCQUAL=$G(PSDAT(F,IENS,4.2,"I"))
"RTN","PSOERXX4",20,0)
 S STRENGTH=$G(PSDAT(F,IENS,4.3,"E"))
"RTN","PSOERXX4",21,0)
 S DDBCODE=$G(PSDAT(F,IENS,4.4,"E"))
"RTN","PSOERXX4",22,0)
 S DDBCQUAL=$G(PSDAT(F,IENS,4.11,"E"))
"RTN","PSOERXX4",23,0)
 S FSCODE=$G(PSDAT(F,IENS,4.5,"I"))
"RTN","PSOERXX4",24,0)
 S FCODE=$G(PSDAT(F,IENS,4.6,"E"))
"RTN","PSOERXX4",25,0)
 S SSCODE=$G(PSDAT(F,IENS,4.7,"I"))
"RTN","PSOERXX4",26,0)
 S SCODE=$G(PSDAT(F,IENS,4.8,"E"))
"RTN","PSOERXX4",27,0)
 S DEASCH=$G(PSDAT(F,IENS,4.9,"E"))
"RTN","PSOERXX4",28,0)
 S QTYVAL=$G(PSDAT(F,IENS,5.1,"E"))
"RTN","PSOERXX4",29,0)
 S CLQUAL=$G(PSDAT(F,IENS,5.2,"I"))
"RTN","PSOERXX4",30,0)
 S USCODE=$G(PSDAT(F,IENS,5.3,"I"))
"RTN","PSOERXX4",31,0)
 S PUC=$G(PSDAT(F,IENS,5.4,"E"))
"RTN","PSOERXX4",32,0)
 S DAYSUPP=$G(PSDAT(F,IENS,5.5,"E"))
"RTN","PSOERXX4",33,0)
 S DIRECT=$G(PSDAT(F,IENS,7,"E"))
"RTN","PSOERXX4",34,0)
 S NOTE=$G(PSDAT(F,IENS,8,"E"))
"RTN","PSOERXX4",35,0)
 ; PSO*508 - added logic to use the refills requeted and 'P' as the qualifier if this section is being built for a refill request.
"RTN","PSOERXX4",36,0)
 ; per guidelines, the refills requested should be sent in both the medication prescribed and med dispensed segments.
"RTN","PSOERXX4",37,0)
 S REVAL=$S($G(REFREQ):REFREQ,1:$G(PSDAT(F,IENS,5.6,"E")))
"RTN","PSOERXX4",38,0)
 I $G(REFREQ) S REQUAL="P"
"RTN","PSOERXX4",39,0)
 I '$G(REFREQ) S REQUAL=$G(PSDAT(F,IENS,5.7,"I")) I REQUAL="R" S REQUAL="P"
"RTN","PSOERXX4",40,0)
 S SUB=$G(PSDAT(F,IENS,5.8,"I"))
"RTN","PSOERXX4",41,0)
 S WDATE=$G(PSDAT(F,IENS,5.9,"I")) I WDATE S WDATE=$P($$EXTIME^PSOERXO1(WDATE),"T")
"RTN","PSOERXX4",42,0)
 S LFDATE=$G(PSDAT(F,IENS,6.1,"I")) I LFDATE S LFDATE=$P($$EXTIME^PSOERXO1(LFDATE),"T")
"RTN","PSOERXX4",43,0)
 S EXDATE=$G(PSDAT(F,IENS,6.2,"I")) I EXDATE S EXDATE=$P($$EXTIME^PSOERXO1(EXDATE),"T")
"RTN","PSOERXX4",44,0)
 S EFDATE=$G(PSDAT(F,IENS,6.3,"I")) I EFDATE S EFDATE=$P($$EXTIME^PSOERXO1(EFDATE),"T")
"RTN","PSOERXX4",45,0)
 S PEND=$G(PSDAT(F,IENS,6.4,"I")) I PEND S PEND=$P($$EXTIME^PSOERXO1(PEND),"T")
"RTN","PSOERXX4",46,0)
 S DOD=$G(PSDAT(F,IENS,6.5,"I")) I DOD S DOD=$P($$EXTIME^PSOERXO1(DOD),"T")
"RTN","PSOERXX4",47,0)
 S DATEVAL=$G(PSDAT(F,IENS,6.6,"I")) I DATEVAL S DATEVAL=$P($$EXTIME^PSOERXO1(DATEVAL),"T")
"RTN","PSOERXX4",48,0)
 S PAQUAL=$G(PSDAT(F,IENS,10.3,"E"))
"RTN","PSOERXX4",49,0)
 S PAVAL=$G(PSDAT(F,IENS,10.2,"E"))
"RTN","PSOERXX4",50,0)
 S PAS=$G(PSDAT(F,IENS,10.4,"I"))
"RTN","PSOERXX4",51,0)
 D C S @GBL@(CNT,0)="<MedicationPrescribed>"
"RTN","PSOERXX4",52,0)
 D C S @GBL@(CNT,0)="<DrugDescription>"_DRUGDES_"</DrugDescription>"
"RTN","PSOERXX4",53,0)
 I $L(PRODCODE)!($L(PCQUAL))!($L(STRENGTH))!($L(DDBCODE))!($L(DDBCQUAL))!($L(FSCODE))!($L(FCODE))!($L(SSCODE))!($L(SCODE))!($L(DEASCH)) D
"RTN","PSOERXX4",54,0)
 .D C S @GBL@(CNT,0)="<DrugCoded>"
"RTN","PSOERXX4",55,0)
 .I $L(PRODCODE) D C S @GBL@(CNT,0)="<ProductCode>"_PRODCODE_"</ProductCode>"
"RTN","PSOERXX4",56,0)
 .I $L(PCQUAL) D C S @GBL@(CNT,0)="<ProductCodeQualifier>"_PCQUAL_"</ProductCodeQualifier>"
"RTN","PSOERXX4",57,0)
 .I $L(STRENGTH) D C S @GBL@(CNT,0)="<Strength>"_STRENGTH_"</Strength>"
"RTN","PSOERXX4",58,0)
 .I $L(DDBCODE) D C S @GBL@(CNT,0)="<DrugDBCode>"_DDBCODE_"</DrugDBCode>"
"RTN","PSOERXX4",59,0)
 .I $L(DDBCQUAL) D C S @GBL@(CNT,0)="<DrugDBCodeQualifier>"_DDBCQUAL_"</DrugDBCodeQualifier>"
"RTN","PSOERXX4",60,0)
 .I $L(FSCODE) D C S @GBL@(CNT,0)="<FormSourceCode>"_FSCODE_"</FormSourceCode>"
"RTN","PSOERXX4",61,0)
 .I $L(FCODE) D C S @GBL@(CNT,0)="<FormCode>"_FCODE_"</FormCode>"
"RTN","PSOERXX4",62,0)
 .I $L(SSCODE) D C S @GBL@(CNT,0)="<StrengthSourceCode>"_SSCODE_"</StrengthSourceCode>"
"RTN","PSOERXX4",63,0)
 .I $L(SCODE) D C S @GBL@(CNT,0)="<StrengthCode>"_SCODE_"</StrengthCode>"
"RTN","PSOERXX4",64,0)
 .I $L(DEASCH) D C S @GBL@(CNT,0)="<DEASchedule>"_DEASCH_"</DEASchedule>"
"RTN","PSOERXX4",65,0)
 .D C S @GBL@(CNT,0)="</DrugCoded>"
"RTN","PSOERXX4",66,0)
 I $L(QTYVAL)!($L(CLQUAL))!($L(USCODE))!($L(PUC)) D
"RTN","PSOERXX4",67,0)
 .D C S @GBL@(CNT,0)="<Quantity>"
"RTN","PSOERXX4",68,0)
 .I $L(QTYVAL) D C S @GBL@(CNT,0)="<Value>"_QTYVAL_"</Value>"
"RTN","PSOERXX4",69,0)
 .I $L(CLQUAL) D C S @GBL@(CNT,0)="<CodeListQualifier>"_CLQUAL_"</CodeListQualifier>"
"RTN","PSOERXX4",70,0)
 .I $L(USCODE) D C S @GBL@(CNT,0)="<UnitSourceCode>"_USCODE_"</UnitSourceCode>"
"RTN","PSOERXX4",71,0)
 .I $L(PUC) D C S @GBL@(CNT,0)="<PotencyUnitCode>"_PUC_"</PotencyUnitCode>"
"RTN","PSOERXX4",72,0)
 .D C S @GBL@(CNT,0)="</Quantity>"
"RTN","PSOERXX4",73,0)
 I $L(DAYSUPP) D C S @GBL@(CNT,0)="<DaysSupply>"_DAYSUPP_"</DaysSupply>"
"RTN","PSOERXX4",74,0)
 I $L(DIRECT) D C S @GBL@(CNT,0)="<Directions>"_DIRECT_"</Directions>"
"RTN","PSOERXX4",75,0)
 I $L(NOTE) D C S @GBL@(CNT,0)="<Note>"_NOTE_"</Note>"
"RTN","PSOERXX4",76,0)
 I $L(REQUAL)!($L(REVAL)) D
"RTN","PSOERXX4",77,0)
 .D C S @GBL@(CNT,0)="<Refills>"
"RTN","PSOERXX4",78,0)
 .I $L(REQUAL) D C S @GBL@(CNT,0)="<Qualifier>"_REQUAL_"</Qualifier>"
"RTN","PSOERXX4",79,0)
 .I $L(REVAL) D C S @GBL@(CNT,0)="<Value>"_REVAL_"</Value>"
"RTN","PSOERXX4",80,0)
 .D C S @GBL@(CNT,0)="</Refills>"
"RTN","PSOERXX4",81,0)
 I $L(SUB) D C S @GBL@(CNT,0)="<Substitutions>"_SUB_"</Substitutions>"
"RTN","PSOERXX4",82,0)
 I $L(WDATE) D
"RTN","PSOERXX4",83,0)
 .D C S @GBL@(CNT,0)="<WrittenDate>"
"RTN","PSOERXX4",84,0)
 .D C S @GBL@(CNT,0)="<Date>"_WDATE_"</Date>"
"RTN","PSOERXX4",85,0)
 .D C S @GBL@(CNT,0)="</WrittenDate>"
"RTN","PSOERXX4",86,0)
 I $L(LFDATE) D
"RTN","PSOERXX4",87,0)
 .D C S @GBL@(CNT,0)="<LastFillDate>"
"RTN","PSOERXX4",88,0)
 .D C S @GBL@(CNT,0)="<Date>"_LFDATE_"</Date>"
"RTN","PSOERXX4",89,0)
 .D C S @GBL@(CNT,0)="</LastFillDate>"
"RTN","PSOERXX4",90,0)
 I $L(EXDATE) D
"RTN","PSOERXX4",91,0)
 .D C S @GBL@(CNT,0)="<ExpirationDate>"
"RTN","PSOERXX4",92,0)
 .D C S @GBL@(CNT,0)="<Date>"_EXDATE_"</Date>"
"RTN","PSOERXX4",93,0)
 .D C S @GBL@(CNT,0)="</ExpirationDate>"
"RTN","PSOERXX4",94,0)
 I $L(EFDATE) D
"RTN","PSOERXX4",95,0)
 .D C S @GBL@(CNT,0)="<EffectiveDate>"
"RTN","PSOERXX4",96,0)
 .D C S @GBL@(CNT,0)="<Date>"_EFDATE_"</Date>"
"RTN","PSOERXX4",97,0)
 .D C S @GBL@(CNT,0)="</EffectiveDate>"
"RTN","PSOERXX4",98,0)
 I $L(PEND) D
"RTN","PSOERXX4",99,0)
 .D C S @GBL@(CNT,0)="<PeriodEnd>"
"RTN","PSOERXX4",100,0)
 .D C S @GBL@(CNT,0)="<Date>"_PEND_"</Date>"
"RTN","PSOERXX4",101,0)
 .D C S @GBL@(CNT,0)="</PeriodEnd>"
"RTN","PSOERXX4",102,0)
 I $L(DOD) D
"RTN","PSOERXX4",103,0)
 .D C S @GBL@(CNT,0)="<DeliveredOnDate>"
"RTN","PSOERXX4",104,0)
 .D C S @GBL@(CNT,0)="<Date>"_DOD_"</Date>"
"RTN","PSOERXX4",105,0)
 .D C S @GBL@(CNT,0)="</DeliveredOnDate>"
"RTN","PSOERXX4",106,0)
 I $L(DATEVAL) D
"RTN","PSOERXX4",107,0)
 .D C S @GBL@(CNT,0)="<DateValidated>"
"RTN","PSOERXX4",108,0)
 .D C S @GBL@(CNT,0)="<Date>"_DATEVAL_"</Date>"
"RTN","PSOERXX4",109,0)
 .D C S @GBL@(CNT,0)="</DateValidated>"
"RTN","PSOERXX4",110,0)
 ;***DO DIAGNOS, IT IS A MULTIPLE***
"RTN","PSOERXX4",111,0)
 I $L(PAQUAL)!($L(PAVAL)) D
"RTN","PSOERXX4",112,0)
 .D C S @GBL@(CNT,0)="<PriorAuthorization>"
"RTN","PSOERXX4",113,0)
 .I $L(PAQUAL) D C S @GBL@(CNT,0)="<Qualifier>"_PAQUAL_"</Qualifier>"
"RTN","PSOERXX4",114,0)
 .I $L(PAVAL) D C S @GBL@(CNT,0)="<Value>"_PAVAL_"</Value>"
"RTN","PSOERXX4",115,0)
 .D C S @GBL@(CNT,0)="</PriorAuthorization>"
"RTN","PSOERXX4",116,0)
 ;***DO DRUG USE EVAL***
"RTN","PSOERXX4",117,0)
 S DCLOOP=0 F  S DCLOOP=$O(^PS(52.49,IEN,28,DCLOOP)) Q:'DCLOOP  D
"RTN","PSOERXX4",118,0)
 .S DCSVAL=$$GET1^DIQ(52.4928,DCLOOP_","_IENS,.02,"E")
"RTN","PSOERXX4",119,0)
 .D C S @GBL@(CNT,0)="<DrugCoverageStatusCode>"_DCSVAL_"</DrugCoverageStatusCode>"
"RTN","PSOERXX4",120,0)
 I $L(PAS) D C S @GBL@(CNT,0)="<PriorAuthorizationStatus>"_PAS_"</PriorAuthorizationStatus>"
"RTN","PSOERXX4",121,0)
 S SLOOP=0 F  S SLOOP=$O(^PS(52.49,IEN,11,SLOOP)) Q:'SLOOP  D
"RTN","PSOERXX4",122,0)
 .S SIENS=SLOOP_","_IEN_","
"RTN","PSOERXX4",123,0)
 .D STRUCSIG^PSOERXX5(.GBL,SIENS)
"RTN","PSOERXX4",124,0)
 D C S @GBL@(CNT,0)="</MedicationPrescribed>"
"RTN","PSOERXX4",125,0)
 Q
"RTN","PSOERXX4",126,0)
 ; IEN - 52.49 IEN
"RTN","PSOERXX4",127,0)
 ; RXIEN - Prescription IEN (file #52)
"RTN","PSOERXX4",128,0)
 ; ORIEN - order IEN
"RTN","PSOERXX4",129,0)
 ; PSOIEN - eRx ien
"RTN","PSOERXX4",130,0)
 ; REFREQ - refills requested
"RTN","PSOERXX4",131,0)
MEDDIS(GBL,RXIEN,ORIEN,PSOIEN,REFREQ) ;
"RTN","PSOERXX4",132,0)
 N DRUGDES,PRODCODE,PCQUAL,STRENGTH,DDBCODE,DDBCQUAL,FSCODE,FCODE,SSCODE,SCODE,DEASCH,VALUE,CLQUAL,USCODE,PUC,DAYSUPP
"RTN","PSOERXX4",133,0)
 N F,DIRECT,NOTE,REQUAL,SUB,WDATE,LFDATE,EXDATE,EFDATE,PEND,DOD,DATEVAL,PAQUAL,PAVAL,DCS,PAS,SIGTXT,SIGLOOP
"RTN","PSOERXX4",134,0)
 N RXDAT,RXIENS,DRUGDES,QTY,RXDAT,RVAL,DRUGIEN,DNDC,SUBST,LESS,I,DCLOOP,DCSVAL
"RTN","PSOERXX4",135,0)
 ;S F=52.49
"RTN","PSOERXX4",136,0)
 ; this is the section we will likely be using
"RTN","PSOERXX4",137,0)
 S RXIENS=RXIEN_","
"RTN","PSOERXX4",138,0)
 D GETS^DIQ(52,RXIENS,"1;6;7;8;9;10;10.2;101","IE","RXDAT")
"RTN","PSOERXX4",139,0)
 D CONVXML^PSOERXX1("RXDAT")
"RTN","PSOERXX4",140,0)
 S DRUGDES=$G(RXDAT(52,RXIENS,6,"E"))
"RTN","PSOERXX4",141,0)
 S DRUGIEN=$G(RXDAT(52,RXIENS,6,"I"))
"RTN","PSOERXX4",142,0)
 I DRUGIEN S DNDC=$TR($$GET1^DIQ(50,DRUGIEN,31,"E"),"-","")
"RTN","PSOERXX4",143,0)
 I DNDC'="" D
"RTN","PSOERXX4",144,0)
 .I $L($G(DNDC)<11) D
"RTN","PSOERXX4",145,0)
 ..S LESS=11-$L(DNDC)
"RTN","PSOERXX4",146,0)
 ..F I=1:1:LESS S DNDC=0_$G(DNDC)
"RTN","PSOERXX4",147,0)
 S QTY=$G(RXDAT(52,RXIENS,7,"E"))
"RTN","PSOERXX4",148,0)
 ; FUTURE ENHANCEMENTS
"RTN","PSOERXX4",149,0)
 ; - the qualifier may change between rxfill and refill request
"RTN","PSOERXX4",150,0)
 ; - consider modifying quantity code list qualifier in 52.49 to be a set of codes.
"RTN","PSOERXX4",151,0)
 ; this is a refill request, so the codelistqualifier will always be 38 - original quantity
"RTN","PSOERXX4",152,0)
 ;38 Original Quantity
"RTN","PSOERXX4",153,0)
 ;40 Remaining Quantity
"RTN","PSOERXX4",154,0)
 ;87 Quantity Received
"RTN","PSOERXX4",155,0)
 ;QS Quantity sufficient as determined by the dispensing pharmacy.
"RTN","PSOERXX4",156,0)
 ;   Quantity to be based on established dispensing protocols between
"RTN","PSOERXX4",157,0)
 ;   the prescriber and pharmacy/pharmacist.
"RTN","PSOERXX4",158,0)
 ; FUTURE - WHEN THIS IS USED, CLQUAL MAY NEED TO BE CALCULATED AND NOT HARD CODED
"RTN","PSOERXX4",159,0)
 S CLQUAL=38
"RTN","PSOERXX4",160,0)
 ; how to determine Unit Source Code?
"RTN","PSOERXX4",161,0)
 ;AA - NCI values of Diagnostic, Therapeutic, and Research Equipment - Pharmaceutical Dosage Form (http://www.cancer.gov/cancertopics/terminologyresources/page4- NCI Thesaurus)
"RTN","PSOERXX4",162,0)
 ;AB - NCI values of Units of Presentation (http://www.cancer.gov/cancertopics/terminologyresources/page4- NCI Thesaurus)
"RTN","PSOERXX4",163,0)
 ;AC - NCI values of Property or Attribute - Unit of Measure - Unit of Category - Potency Unit (http://www.cancer.gov/cancertopics/terminologyresources/page4- NCI Thesaurus)
"RTN","PSOERXX4",164,0)
 ; FOR NOW SET IT TO AA
"RTN","PSOERXX4",165,0)
 S USCODE="AA"
"RTN","PSOERXX4",166,0)
 ; FUTURE ENHANCEMENT - find out how to identify potency unit code, for now use C38046 - Not Stated explicity or in detail
"RTN","PSOERXX4",167,0)
 S PUC="C38046"
"RTN","PSOERXX4",168,0)
 S DAYSUPP=$G(RXDAT(52,RXIENS,8,"E"))
"RTN","PSOERXX4",169,0)
 ; DIRECTIONS COME FROM SIG, FIELD 10
"RTN","PSOERXX4",170,0)
 ; FUTURE ENHANCEMENT - SHOULD WE GRAB ALL INFORMATION FROM THE SIG1 MULTIPLE? 52,10.2
"RTN","PSOERXX4",171,0)
 S SIGLOOP=0 F  S SIGLOOP=$O(^PSRX(RXIEN,"SIG1",SIGLOOP)) Q:'SIGLOOP  D
"RTN","PSOERXX4",172,0)
 .I '$D(SIGTXT) S SIGTXT=$G(^PSRX(RXIEN,"SIG1",SIGLOOP,0)) Q
"RTN","PSOERXX4",173,0)
 .S SIGTXT=SIGTXT_" "_$G(^PSRX(RXIEN,"SIG1",SIGLOOP,0))
"RTN","PSOERXX4",174,0)
 S DIRECT=$E(SIGTXT,1,140),DIRECT=$$SYMENC^MXMLUTL(DIRECT)
"RTN","PSOERXX4",175,0)
 S REQUAL=$$GET1^DIQ(52.49,PSOIEN,5.7,"I")
"RTN","PSOERXX4",176,0)
 I REQUAL="R" S REQUAL="P"
"RTN","PSOERXX4",177,0)
 S SUBST=$$GET1^DIQ(52.49,PSOIEN,5.8,"I")
"RTN","PSOERXX4",178,0)
 S RVAL=$S($D(REFREQ):REFREQ,1:$G(RXDAT(52,RXIENS,9,"E")))
"RTN","PSOERXX4",179,0)
 I $D(REFREQ) S REQUAL="P"
"RTN","PSOERXX4",180,0)
 ; CONVERT DATE types, ALSO MAKE SURE WE NEED TO POPULATE THESE.. MAY NOT BE NEEDED
"RTN","PSOERXX4",181,0)
 S LFDATE=$G(RXDAT(52,RXIENS,101,"I")) I LFDATE S LFDATE=$P($$EXTIME^PSOERXO1(LFDATE),"T")
"RTN","PSOERXX4",182,0)
 S EXDATE=$G(RXDAT(52,RXIENS,26,"I")) I EXDATE S EXDATE=$P($$EXTIME^PSOERXO1(EXDATE),"T")
"RTN","PSOERXX4",183,0)
 S WDATE=$G(RXDAT(52,RXIENS,1,"I")) I WDATE S WDATE=$P($$EXTIME^PSOERXO1(WDATE),"T")
"RTN","PSOERXX4",184,0)
 S EFDATE=""
"RTN","PSOERXX4",185,0)
 D C S @GBL@(CNT,0)="<MedicationDispensed>"
"RTN","PSOERXX4",186,0)
 D C S @GBL@(CNT,0)="<DrugDescription>"_DRUGDES_"</DrugDescription>"
"RTN","PSOERXX4",187,0)
 I $L($G(DNDC)) D
"RTN","PSOERXX4",188,0)
 .D C S @GBL@(CNT,0)="<DrugCoded>"
"RTN","PSOERXX4",189,0)
 .D C S @GBL@(CNT,0)="<ProductCode>"_DNDC_"</ProductCode>"
"RTN","PSOERXX4",190,0)
 .D C S @GBL@(CNT,0)="<ProductCodeQualifier>ND</ProductCodeQualifier>"
"RTN","PSOERXX4",191,0)
 .D C S @GBL@(CNT,0)="</DrugCoded>"
"RTN","PSOERXX4",192,0)
 D C S @GBL@(CNT,0)="<Quantity>"
"RTN","PSOERXX4",193,0)
 D C S @GBL@(CNT,0)="<Value>"_QTY_"</Value>"
"RTN","PSOERXX4",194,0)
 D C S @GBL@(CNT,0)="<CodeListQualifier>"_CLQUAL_"</CodeListQualifier>"
"RTN","PSOERXX4",195,0)
 D C S @GBL@(CNT,0)="<UnitSourceCode>"_USCODE_"</UnitSourceCode>"
"RTN","PSOERXX4",196,0)
 D C S @GBL@(CNT,0)="<PotencyUnitCode>"_PUC_"</PotencyUnitCode>"
"RTN","PSOERXX4",197,0)
 D C S @GBL@(CNT,0)="</Quantity>"
"RTN","PSOERXX4",198,0)
 D C S @GBL@(CNT,0)="<DaysSupply>"_DAYSUPP_"</DaysSupply>"
"RTN","PSOERXX4",199,0)
 D C S @GBL@(CNT,0)="<Directions>"_DIRECT_"</Directions>"
"RTN","PSOERXX4",200,0)
 I $L(REQUAL)!($L(RVAL)) D
"RTN","PSOERXX4",201,0)
 .D C S @GBL@(CNT,0)="<Refills>"
"RTN","PSOERXX4",202,0)
 .I $L(REQUAL) D C S @GBL@(CNT,0)="<Qualifier>"_REQUAL_"</Qualifier>"
"RTN","PSOERXX4",203,0)
 .I $L(RVAL) D C S @GBL@(CNT,0)="<Value>"_RVAL_"</Value>"
"RTN","PSOERXX4",204,0)
 .D C S @GBL@(CNT,0)="</Refills>"
"RTN","PSOERXX4",205,0)
 I $L(SUBST) D C S @GBL@(CNT,0)="<Substitutions>"_SUBST_"</Substitutions>"
"RTN","PSOERXX4",206,0)
 I $L(WDATE) D
"RTN","PSOERXX4",207,0)
 .D C S @GBL@(CNT,0)="<WrittenDate>"
"RTN","PSOERXX4",208,0)
 .D C S @GBL@(CNT,0)="<Date>"_WDATE_"</Date>"
"RTN","PSOERXX4",209,0)
 .D C S @GBL@(CNT,0)="</WrittenDate>"
"RTN","PSOERXX4",210,0)
 I $L(LFDATE) D
"RTN","PSOERXX4",211,0)
 .D C S @GBL@(CNT,0)="<LastFillDate>"
"RTN","PSOERXX4",212,0)
 .D C S @GBL@(CNT,0)="<Date>"_LFDATE_"</Date>"
"RTN","PSOERXX4",213,0)
 .D C S @GBL@(CNT,0)="</LastFillDate>"
"RTN","PSOERXX4",214,0)
 I $L(EXDATE) D
"RTN","PSOERXX4",215,0)
 .D C S @GBL@(CNT,0)="<ExpirationDate>"
"RTN","PSOERXX4",216,0)
 .D C S @GBL@(CNT,0)="<Date>"_EXDATE_"</Date>"
"RTN","PSOERXX4",217,0)
 .D C S @GBL@(CNT,0)="</ExpirationDate>"
"RTN","PSOERXX4",218,0)
 I $L(EFDATE) D
"RTN","PSOERXX4",219,0)
 .D C S @GBL@(CNT,0)="<EffectiveDate>"
"RTN","PSOERXX4",220,0)
 .D C S @GBL@(CNT,0)="<Date>"_EFDATE_"</Date>"
"RTN","PSOERXX4",221,0)
 .D C S @GBL@(CNT,0)="</EffectiveDate>"
"RTN","PSOERXX4",222,0)
 S DCLOOP=0 F  S DCLOOP=$O(^PS(52.49,PSOIEN,28,DCLOOP)) Q:'DCLOOP  D
"RTN","PSOERXX4",223,0)
 .S DCSVAL=$$GET1^DIQ(52.4928,DCLOOP_","_PSOIEN_",",.02,"E")
"RTN","PSOERXX4",224,0)
 .D C S @GBL@(CNT,0)="<DrugCoverageStatusCode>"_DCSVAL_"</DrugCoverageStatusCode>"
"RTN","PSOERXX4",225,0)
 D C S @GBL@(CNT,0)="</MedicationDispensed>"
"RTN","PSOERXX4",226,0)
 Q
"RTN","PSOERXX4",227,0)
MEDREQ(GBL,IEN,DDAT) ;
"RTN","PSOERXX4",228,0)
 N DRUGDES,PRODCODE,PCQUAL,STRENGTH,DDBCODE,DDBCQUAL,FSCODE,FCODE,SSCODE,SCODE,DEASCH,VALUE,CLQUAL,USCODE,PUC,DAYSUPP
"RTN","PSOERXX4",229,0)
 N F,DIRECT,NOTE,REQUAL,SUB,WDATE,LFDATE,EXDATE,EFDATE,PEND,DOD,DATEVAL,PAQUAL,PAVAL,DCS,PAS
"RTN","PSOERXX4",230,0)
 S F=52.49
"RTN","PSOERXX4",231,0)
 ; FUTURE ENHANCEMENT - FOR NOW BUILD HEADER AND FOOTER AND QUIT. tHIS MAY NEED TO LOOK AT 52.41 OR 52 FOR DATA
"RTN","PSOERXX4",232,0)
 S DRUGDES=$G(DDAT("DRUG"))
"RTN","PSOERXX4",233,0)
 S QTY=$G(DDAT("QTY"))
"RTN","PSOERXX4",234,0)
 S DAYSUPP=$G(DDAT("DSUP"))
"RTN","PSOERXX4",235,0)
 S RVAL=$G(DDAT("REF"))
"RTN","PSOERXX4",236,0)
 S DIRECT=$G(DDAT("DIR"))
"RTN","PSOERXX4",237,0)
 S REQUAL="R"
"RTN","PSOERXX4",238,0)
 S CLQUAL="TEST"
"RTN","PSOERXX4",239,0)
 S USCODE="TEST"
"RTN","PSOERXX4",240,0)
 S PUC="TEST"
"RTN","PSOERXX4",241,0)
 D C S @GBL@(CNT,0)="<MedicationRequested>"
"RTN","PSOERXX4",242,0)
 D C S @GBL@(CNT,0)="<DrugDescription>"_DRUGDES_"</DrugDescription>"
"RTN","PSOERXX4",243,0)
 D C S @GBL@(CNT,0)="<Quantity>"
"RTN","PSOERXX4",244,0)
 D C S @GBL@(CNT,0)="<Value>"_QTY_"</Value>"
"RTN","PSOERXX4",245,0)
 D C S @GBL@(CNT,0)="<CodeListQualifier>"_CLQUAL_"</CodeListQualifier>"
"RTN","PSOERXX4",246,0)
 D C S @GBL@(CNT,0)="<UnitSourceCode>"_USCODE_"</UnitSourceCode>"
"RTN","PSOERXX4",247,0)
 D C S @GBL@(CNT,0)="<PotencyUnitCode>"_PUC_"</PotencyUnitCode>"
"RTN","PSOERXX4",248,0)
 D C S @GBL@(CNT,0)="</Quantity>"
"RTN","PSOERXX4",249,0)
 D C S @GBL@(CNT,0)="<DaysSupply>"_DAYSUPP_"</DaysSupply>"
"RTN","PSOERXX4",250,0)
 D C S @GBL@(CNT,0)="<Directions>"_DIRECT_"</Directions>"
"RTN","PSOERXX4",251,0)
 D C S @GBL@(CNT,0)="<Refills>"
"RTN","PSOERXX4",252,0)
 D C S @GBL@(CNT,0)="<Qualifier>"_REQUAL_"</Qualifier>"
"RTN","PSOERXX4",253,0)
 D C S @GBL@(CNT,0)="<Value>"_RVAL_"</Value>"
"RTN","PSOERXX4",254,0)
 D C S @GBL@(CNT,0)="</Refills>"
"RTN","PSOERXX4",255,0)
 D C S @GBL@(CNT,0)="</MedicationRequested>"
"RTN","PSOERXX4",256,0)
 Q
"RTN","PSOERXX4",257,0)
C ;
"RTN","PSOERXX4",258,0)
 S CNT=$G(CNT)+1
"RTN","PSOERXX4",259,0)
 Q
"RTN","PSOERXX5")
0^15^B161348685^B181218192
"RTN","PSOERXX5",1,0)
PSOERXX5 ;ALB/BWF - eRx xml utilities ; 8/3/2016 5:14pm
"RTN","PSOERXX5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,508**;DEC 1997;Build 295
"RTN","PSOERXX5",3,0)
 ;
"RTN","PSOERXX5",4,0)
 Q
"RTN","PSOERXX5",5,0)
STRUCSIG(GBL,IENS) ;
"RTN","PSOERXX5",6,0)
 N SSPN,MSM,SV,FMTV,SFTSI,SFT,DCI,DDM,DDMCQ,DDMC,DDMMT,DDMMCQ,DDMMC,MDRFLG,MDVAR
"RTN","PSOERXX5",7,0)
 N DQ,DFT,DFCQ,DFC,DRM,DBMV,DBUM,DBUMCQ,DBUC,BMQ,BMV,CDM,CDUMT,CDUMCQ,CDUMC,DBRM
"RTN","PSOERXX5",8,0)
 N VN,VNCQ,VUMT,VUMCQ,VUMC,MVM,RAT,RACQ,RAC,MRAM,SAT,SACQ,SAC,MATM,RM,RUMT,INDFLG,INDVAR
"RTN","PSOERXX5",9,0)
 N RUMCQ,RUMC,TPBT,TPBCQ,TPBC,FNV,FUT,FUCQ,FUC,VFM,INV,IUT,IUCQ,IUC,OR,DNV,DTEXT,DTCQ
"RTN","PSOERXX5",10,0)
 N DTC,MDRNV,MDRUT,MDRCQ,MDRUC,MDRVN,MDRVUT,MDRVUCQ,MDRVUC,MDRVDM,IPT,IPCQ,IPC,IT
"RTN","PSOERXX5",11,0)
 N F,ITCQ,ITC,IVT,IVU,IVUMT,IVUMCQ,IVUMC,IVM,STOPI,PDAT,ATC,ATCQ,ATT,TMATM,VIM,VNC,VQ
"RTN","PSOERXX5",12,0)
 N DOSEVAR,DOSEFLG,DCALFLG,DCALVAR,VFLG,VVAR,ROAFLG,ROAVAR,SOAFLG,SOAVAR,TIMFLG,TIMVAR,DURFLG,DURVAR
"RTN","PSOERXX5",13,0)
 S F=52.4911
"RTN","PSOERXX5",14,0)
 D GETS^DIQ(F,IENS,"**","IE","PDAT")
"RTN","PSOERXX5",15,0)
 D CONVXML^PSOERXX1("PDAT")
"RTN","PSOERXX5",16,0)
 S SSPN=$G(PDAT(F,IENS,.01,"E")),MSM=$G(PDAT(F,IENS,.02,"I")),SV=$G(PDAT(F,IENS,.03,"E"))
"RTN","PSOERXX5",17,0)
 S FMTV=$G(PDAT(F,IENS,.04,"E")),SFTSI=$G(PDAT(F,IENS,.05,"E")),SFT=$G(PDAT(F,IENS,1,"E"))
"RTN","PSOERXX5",18,0)
 S DCI=$G(PDAT(F,IENS,2.1,"E")),DDM=$G(PDAT(F,IENS,2.2,"E")),DDMCQ=$G(PDAT(F,IENS,2.3,"I"))
"RTN","PSOERXX5",19,0)
 S DDMC=$G(PDAT(F,IENS,2.4,"E")),DDMMT=$G(PDAT(F,IENS,2.5,"E")),DDMMCQ=$G(PDAT(F,IENS,2.7,"I")),DDMMC=$G(PDAT(F,IENS,2.6,"E"))
"RTN","PSOERXX5",20,0)
 S DQ=$G(PDAT(F,IENS,3.1,"E")),DFT=$G(PDAT(F,IENS,3.2,"E")),DFCQ=$G(PDAT(F,IENS,3.4,"I")),DFC=$G(PDAT(F,IENS,3.3,"E"))
"RTN","PSOERXX5",21,0)
 S DRM=$G(PDAT(F,IENS,3.5,"I")),DBMV=$G(PDAT(F,IENS,4.1,"E")),DBUM=$G(PDAT(F,IENS,4.2,"E")),DBUMCQ=$G(PDAT(F,IENS,4.4,"I"))
"RTN","PSOERXX5",22,0)
 S DBUC=$G(PDAT(F,IENS,4.3,"E")),BMQ=$G(PDAT(F,IENS,4.5,"I")),BMV=$G(PDAT(F,IENS,4.6,"E")),CDM=$G(PDAT(F,IENS,4.7,"E"))
"RTN","PSOERXX5",23,0)
 S CDUMT=$G(PDAT(F,IENS,4.8,"E")),CDUMCQ=$G(PDAT(F,IENS,4.11,"I")),CDUMC=$G(PDAT(F,IENS,4.9,"E")),DBRM=$G(PDAT(F,IENS,4.12,"I"))
"RTN","PSOERXX5",24,0)
 S VN=$G(PDAT(F,IENS,5.1,"E")),VNC=$G(PDAT(F,IENS,5.2,"E")),VNCQ=$G(PDAT(F,IENS,5.3,"I")),VQ=$G(PDAT(F,IENS,5.4,"E"))
"RTN","PSOERXX5",25,0)
 S VUMT=$G(PDAT(F,IENS,5.5,"E")),VUMCQ=$G(PDAT(F,IENS,5.7,"I")),VUMC=$G(PDAT(F,IENS,5.6,"E")),MVM=$G(PDAT(F,IENS,5.8,"I"))
"RTN","PSOERXX5",26,0)
 S RAT=$G(PDAT(F,IENS,6.1,"E")),RACQ=$G(PDAT(F,IENS,6.3,"I")),RAC=$G(PDAT(F,IENS,6.2,"E")),MRAM=$G(PDAT(F,IENS,6.4,"I"))
"RTN","PSOERXX5",27,0)
 S SAT=$G(PDAT(F,IENS,6.5,"E")),SACQ=$G(PDAT(F,IENS,6.7,"I")),SAC=$G(PDAT(F,IENS,6.7,"I")),MATM=$G(PDAT(F,IENS,6.8,"I"))
"RTN","PSOERXX5",28,0)
 S ATT=$G(PDAT(F,IENS,7.1,"E")),ATCQ=$G(PDAT(F,IENS,7.3,"I")),ATC=$G(PDAT(F,IENS,7.2,"E")),TMATM=$G(PDAT(F,IENS,7.4,"I"))
"RTN","PSOERXX5",29,0)
 S RM=$G(PDAT(F,IENS,7.5,"E")),RUMT=$G(PDAT(F,IENS,7.6,"E")),RUMCQ=$G(PDAT(F,IENS,7.8,"I")),RUMC=$G(PDAT(F,IENS,7.7,"E"))
"RTN","PSOERXX5",30,0)
 S TPBT=$G(PDAT(F,IENS,8.1,"E")),TPBCQ=$G(PDAT(F,IENS,8.3,"I")),TPBC=$G(PDAT(F,IENS,8.2,"E")),FNV=$G(PDAT(F,IENS,8.4,"E"))
"RTN","PSOERXX5",31,0)
 S FUT=$G(PDAT(F,IENS,8.5,"E")),FUCQ=$G(PDAT(F,IENS,8.7,"I")),FUC=$G(PDAT(F,IENS,8.6,"E")),VFM=$G(PDAT(F,IENS,8.8,"I")),INV=$G(PDAT(F,IENS,9.1,"E"))
"RTN","PSOERXX5",32,0)
 S IUT=$G(PDAT(F,IENS,9.2,"E")),IUCQ=$G(PDAT(F,IENS,9.4,"I")),IUC=$G(PDAT(F,IENS,9.3,"E")),VIM=$G(PDAT(F,IENS,9.5,"I"))
"RTN","PSOERXX5",33,0)
 S DNV=$G(PDAT(F,IENS,9.6,"E")),DTEXT=$G(PDAT(F,IENS,9.7,"E")),DTCQ=$G(PDAT(F,IENS,9.9,"I")),DTC=$G(PDAT(F,IENS,9.8,"E"))
"RTN","PSOERXX5",34,0)
 S MDRNV=$G(PDAT(F,IENS,10.1,"E")),MDRUT=$G(PDAT(F,IENS,10.2,"E")),MDRCQ=$G(PDAT(F,IENS,10.3,"I")),MDRUC=$G(PDAT(F,IENS,10.4,"E"))
"RTN","PSOERXX5",35,0)
 S MDRVN=$G(PDAT(F,IENS,10.5,"E")),MDRVUT=$G(PDAT(F,IENS,10.6,"E")),MDRVUCQ=$G(PDAT(F,IENS,10.8,"I")),MDRVUC=$G(PDAT(F,IENS,10.7,"E"))
"RTN","PSOERXX5",36,0)
 S MDRVDM=$G(PDAT(F,IENS,10.9,"I")),IPT=$G(PDAT(F,IENS,11.1,"E")),IPCQ=$G(PDAT(F,IENS,11.3,"I")),IPC=$G(PDAT(F,IENS,11.2,"E"))
"RTN","PSOERXX5",37,0)
 S IT=$G(PDAT(F,IENS,11.4,"E")),ITCQ=$G(PDAT(F,IENS,11.6,"I")),ITC=$G(PDAT(F,IENS,11.5,"E")),IVT=$G(PDAT(F,IENS,12.1,"E"))
"RTN","PSOERXX5",38,0)
 S IVU=$G(PDAT(F,IENS,12.2,"E")),IVUMT=$G(PDAT(F,IENS,12.3,"E")),IVUMCQ=$G(PDAT(F,IENS,12.5,"I"))
"RTN","PSOERXX5",39,0)
 S IVUMC=$G(PDAT(F,IENS,12.4,"E")),IVM=$G(PDAT(F,IENS,12.6,"I")),STOPI=$G(PDAT(F,IENS,12.7,"I"))
"RTN","PSOERXX5",40,0)
 D C S @GBL@(CNT,0)="<StructuredSIG>"
"RTN","PSOERXX5",41,0)
 D C S @GBL@(CNT,0)="<RepeatingSIG>"
"RTN","PSOERXX5",42,0)
 D C S @GBL@(CNT,0)="<SigSequencePositionNumber>"_SSPN_"</SigSequencePositionNumber>"
"RTN","PSOERXX5",43,0)
 I $L(MSM) D C S @GBL@(CNT,0)="<MultipleSigModifier>"_MSM_"</MultipleSigModifier>"
"RTN","PSOERXX5",44,0)
 D C S @GBL@(CNT,0)="</RepeatingSIG>"
"RTN","PSOERXX5",45,0)
 D C S @GBL@(CNT,0)="<CodeSystem>"
"RTN","PSOERXX5",46,0)
 I $L(SV) D C S @GBL@(CNT,0)="<SNOMEDVersion>"_SV_"</SNOMEDVersion>"
"RTN","PSOERXX5",47,0)
 I $L(FMTV) D C S @GBL@(CNT,0)="<FMTVersion>"_FMTV_"</FMTVersion>"
"RTN","PSOERXX5",48,0)
 D C S @GBL@(CNT,0)="</CodeSystem>"
"RTN","PSOERXX5",49,0)
 D C S @GBL@(CNT,0)="<FreeText>"
"RTN","PSOERXX5",50,0)
 I $L(SFTSI) D C S @GBL@(CNT,0)="<SigFreeTextStringIndicator>"_SFTSI_"</SigFreeTextStringIndicator>"
"RTN","PSOERXX5",51,0)
 I $L(SFT) D C S @GBL@(CNT,0)="<SigFreeText>"_SFT_"</SigFreeText>"
"RTN","PSOERXX5",52,0)
 D C S @GBL@(CNT,0)="</FreeText>"
"RTN","PSOERXX5",53,0)
 S DOSEFLG=0
"RTN","PSOERXX5",54,0)
 F DOSEVAR="DCI","DDM","DDMCQ","DDMC","DDMMT","DDMMCQ","DDMMC","DQ","DFT","DFCQ","DFC","DRM" D
"RTN","PSOERXX5",55,0)
 .I $L(@DOSEVAR) S DOSEFLG=1
"RTN","PSOERXX5",56,0)
 I DOSEFLG D C S @GBL@(CNT,0)="<Dose>"
"RTN","PSOERXX5",57,0)
 I $L(DCI) D C S @GBL@(CNT,0)="<DoseCompositeIndicator>"_DCI_"</DoseCompositeIndicator>"
"RTN","PSOERXX5",58,0)
 I $L(DDM) D C S @GBL@(CNT,0)="<DoseDeliveryMethodText>"_DDM_"</DoseDeliveryMethodText>"
"RTN","PSOERXX5",59,0)
 I $L(DDMCQ) D C S @GBL@(CNT,0)="<DoseDeliveryMethodCodeQualifier>"_DDMCQ_"</DoseDeliveryMethodCodeQualifier>"
"RTN","PSOERXX5",60,0)
 I $L(DDMC) D C S @GBL@(CNT,0)="<DoseDeliveryMethodCode>"_DDMC_"</DoseDeliveryMethodCode>"
"RTN","PSOERXX5",61,0)
 I $L(DDMMT) D C S @GBL@(CNT,0)="<DoseDeliveryMethodModifierText>"_DDMMT_"</DoseDeliveryMethodModifierText>"
"RTN","PSOERXX5",62,0)
 I $L(DDMMCQ) D C S @GBL@(CNT,0)="<DoseDeliveryMethodModifierCodeQualifier>"_DDMMCQ_"</DoseDeliveryMethodModifierCodeQualifier>"
"RTN","PSOERXX5",63,0)
 I $L(DDMMC) D C S @GBL@(CNT,0)="<DoseDeliveryMethodModifierCode>"_DDMMC_"</DoseDeliveryMethodModifierCode>"
"RTN","PSOERXX5",64,0)
 I $L(DQ) D C S @GBL@(CNT,0)="<DoseQuantity>"_DQ_"</DoseQuantity>"
"RTN","PSOERXX5",65,0)
 I $L(DFT) D C S @GBL@(CNT,0)="<DoseFormText>"_DFT_"</DoseFormText>"
"RTN","PSOERXX5",66,0)
 I $L(DFCQ) D C S @GBL@(CNT,0)="<DoseFormCodeQualifier>"_DFCQ_"</DoseFormCodeQualifier>"
"RTN","PSOERXX5",67,0)
 I $L(DFC) D C S @GBL@(CNT,0)="<DoseFormCode>"_DFC_"</DoseFormCode>"
"RTN","PSOERXX5",68,0)
 I $L(DRM) D C S @GBL@(CNT,0)="<DoseRangeModifier>"_DRM_"</DoseRangeModifier>"
"RTN","PSOERXX5",69,0)
 I DOSEFLG D C S @GBL@(CNT,0)="</Dose>"
"RTN","PSOERXX5",70,0)
 S DCALFLG=0
"RTN","PSOERXX5",71,0)
 F DCALVAR="DBMV","DBUM","DBUMCQ","DBUC","BMQ","BMV","CDM","CDUMT","CDUMCQ","CDUMC","DBRM" D
"RTN","PSOERXX5",72,0)
 .I $L(@DCALVAR) S DCALFLG=1
"RTN","PSOERXX5",73,0)
 I DCALFLG D C S @GBL@(CNT,0)="<DoseCalculation>"
"RTN","PSOERXX5",74,0)
 I $L(DBMV) D C S @GBL@(CNT,0)="<DosingBasisNumericValue>"_DBMV_"</DosingBasisNumericValue>"
"RTN","PSOERXX5",75,0)
 I $L(DBUM) D C S @GBL@(CNT,0)="<DosingBasisUnitofMeasureText>"_DBUM_"</DosingBasisUnitofMeasureText>"
"RTN","PSOERXX5",76,0)
 I $L(DBUMCQ) D C S @GBL@(CNT,0)="<DosingBasisUnitofMeasureCodeQualifier>"_DBUMCQ_"</DosingBasisUnitofMeasureCodeQualifier>"
"RTN","PSOERXX5",77,0)
 I $L(DBUC) D C S @GBL@(CNT,0)="<DosingBasisUnitofMeasureCode>"_DBUC_"</DosingBasisUnitofMeasureCode>"
"RTN","PSOERXX5",78,0)
 I $L(BMQ) D C S @GBL@(CNT,0)="<BodyMetricQualifier>"_BMQ_"</BodyMetricQualifier>"
"RTN","PSOERXX5",79,0)
 I $L(BMV) D C S @GBL@(CNT,0)="<BodyMetricValue>"_BMV_"</BodyMetricValue>"
"RTN","PSOERXX5",80,0)
 I $L(CDM) D C S @GBL@(CNT,0)="<CalculatedDoseNumeric>"_CDM_"</CalculatedDoseNumeric>"
"RTN","PSOERXX5",81,0)
 I $L(CDUMT) D C S @GBL@(CNT,0)="<CalculatedDoseUnitofMeasureText>"_CDUMT_"</CalculatedDoseUnitofMeasureText>"
"RTN","PSOERXX5",82,0)
 I $L(CDUMCQ) D C S @GBL@(CNT,0)="<CalculatedDoseUnitofMeasureCodeQualifier>"_CDUMCQ_"</CalculatedDoseUnitofMeasureCodeQualifier>"
"RTN","PSOERXX5",83,0)
 I $L(CDUMC) D C S @GBL@(CNT,0)="<CalculatedDoseUnitofMeasureCode>"_CDUMC_"</CalculatedDoseUnitofMeasureCode>"
"RTN","PSOERXX5",84,0)
 I $L(DBRM) D C S @GBL@(CNT,0)="<DosingBasisRangeModifier>"_DBRM_"</DosingBasisRangeModifier>"
"RTN","PSOERXX5",85,0)
 I DCALFLG D C S @GBL@(CNT,0)="</DoseCalculation>"
"RTN","PSOERXX5",86,0)
 S VFLG=0
"RTN","PSOERXX5",87,0)
 F VVAR="VN","VNCQ","VNC","VQ","VUMT","VUMCQ","VUMC","MVM" D
"RTN","PSOERXX5",88,0)
 .I $L(@VVAR) S VFLG=1
"RTN","PSOERXX5",89,0)
 I VFLG D C S @GBL@(CNT,0)="<Vehicle>"
"RTN","PSOERXX5",90,0)
 I $L(VN) D C S @GBL@(CNT,0)="<VehicleName>"_VN_"</VehicleName>"
"RTN","PSOERXX5",91,0)
 I $L(VNCQ) D C S @GBL@(CNT,0)="<VehicleNameCodeQualifier>"_VNCQ_"</VehicleNameCodeQualifier>"
"RTN","PSOERXX5",92,0)
 I $L(VNC) D C S @GBL@(CNT,0)="<VehicleNameCode>"_VNC_"</VehicleNameCode>"
"RTN","PSOERXX5",93,0)
 I $L(VQ) D C S @GBL@(CNT,0)="<VehicleQuantity>"_VQ_"</VehicleQuantity>"
"RTN","PSOERXX5",94,0)
 I $L(VUMT) D C S @GBL@(CNT,0)="<VehicleUnitOfMeasureText>"_VUMT_"</VehicleUnitOfMeasureText>"
"RTN","PSOERXX5",95,0)
 I $L(VUMCQ) D C S @GBL@(CNT,0)="<VehicleUnitOfMeasureCodeQualifier>"_VUMCQ_"</VehicleUnitOfMeasureCodeQualifier>"
"RTN","PSOERXX5",96,0)
 I $L(VUMC) D C S @GBL@(CNT,0)="<VehicleUnitOfMeasureCode>"_VUMC_"</VehicleUnitOfMeasureCode>"
"RTN","PSOERXX5",97,0)
 I $L(MVM) D C S @GBL@(CNT,0)="<MultipleVehicleModifier>"_MVM_"</MultipleVehicleModifier>"
"RTN","PSOERXX5",98,0)
 I VFLG D C S @GBL@(CNT,0)="</Vehicle>"
"RTN","PSOERXX5",99,0)
 S ROAFLG=0
"RTN","PSOERXX5",100,0)
 F ROAVAR="RAT","RACQ","RAC","MRAM" D
"RTN","PSOERXX5",101,0)
 .I $L(@ROAVAR) S ROAFLG=1
"RTN","PSOERXX5",102,0)
 I ROAFLG D C S @GBL@(CNT,0)="<RouteofAdministration>"
"RTN","PSOERXX5",103,0)
 I $L(RAT) D C S @GBL@(CNT,0)="<RouteofAdministrationText>"_RAT_"</RouteofAdministrationText>"
"RTN","PSOERXX5",104,0)
 I $L(RACQ) D C S @GBL@(CNT,0)="<RouteofAdministrationCodeQualifier>"_RACQ_"</RouteofAdministrationCodeQualifier>"
"RTN","PSOERXX5",105,0)
 I $L(RAC) D C S @GBL@(CNT,0)="<RouteofAdministrationCode>"_RAC_"</RouteofAdministrationCode>"
"RTN","PSOERXX5",106,0)
 I $L(MRAM) D C S @GBL@(CNT,0)="<MultipleRouteofAdministrationModifier>"_MRAM_"</MultipleRouteofAdministrationModifier>"
"RTN","PSOERXX5",107,0)
 I ROAFLG D C S @GBL@(CNT,0)="</RouteofAdministration>"
"RTN","PSOERXX5",108,0)
 S SOAFLG=0
"RTN","PSOERXX5",109,0)
 F SOAVAR="SAT","SACQ","SAC","MATM" D
"RTN","PSOERXX5",110,0)
 .I $L(@SOAVAR) S SOAFLG=1
"RTN","PSOERXX5",111,0)
 I SOAFLG D C S @GBL@(CNT,0)="<SiteofAdministration>"
"RTN","PSOERXX5",112,0)
 I $L(SAT) D C S @GBL@(CNT,0)="<SiteofAdministrationText>"_SAT_"</SiteofAdministrationText>"
"RTN","PSOERXX5",113,0)
 I $L(SACQ) D C S @GBL@(CNT,0)="<SiteofAdministrationCodeQualifier>"_SACQ_"</SiteofAdministrationCodeQualifier>"
"RTN","PSOERXX5",114,0)
 I $L(SAC) D C S @GBL@(CNT,0)="<SiteofAdministrationCode>"_SAC_"</SiteofAdministrationCode>"
"RTN","PSOERXX5",115,0)
 I $L(MATM) D C S @GBL@(CNT,0)="<MultipleAdministrationTimingModifier>"_MATM_"</MultipleAdministrationTimingModifier>"
"RTN","PSOERXX5",116,0)
 I SOAFLG D C S @GBL@(CNT,0)="</SiteofAdministration>"
"RTN","PSOERXX5",117,0)
 S TIMFLG=0
"RTN","PSOERXX5",118,0)
 F TIMVAR="ATT","ATCQ","ATC","TMATM","RM","RUMT","RUMCQ","RUMC","TPBT","TPBCQ","TPBC","FNV","FUT","FUCQ","FUC","VFM","INV","IUT","IUCQ","IUC","VIM" D
"RTN","PSOERXX5",119,0)
 .I $L(@TIMVAR) S TIMFLG=1
"RTN","PSOERXX5",120,0)
 I TIMFLG D C S @GBL@(CNT,0)="<Timing>"
"RTN","PSOERXX5",121,0)
 I $L(ATT) D C S @GBL@(CNT,0)="<AdministrationTimingText>"_ATT_"</AdministrationTimingText>"
"RTN","PSOERXX5",122,0)
 I $L(ATCQ) D C S @GBL@(CNT,0)="<AdministrationTimingCodeQualifier>"_ATCQ_"</AdministrationTimingCodeQualifier>"
"RTN","PSOERXX5",123,0)
 I $L(ATC) D C S @GBL@(CNT,0)="<AdministrationTimingCode>"_ATC_"</AdministrationTimingCode>"
"RTN","PSOERXX5",124,0)
 I $L(TMATM) D C S @GBL@(CNT,0)="<MultipleAdministrationTimingModifier>"_TMATM_"</MultipleAdministrationTimingModifier>"
"RTN","PSOERXX5",125,0)
 I $L(RM) D C S @GBL@(CNT,0)="<RateofAdministration>"_RM_"</RateofAdministration>"
"RTN","PSOERXX5",126,0)
 I $L(RUMT) D C S @GBL@(CNT,0)="<RateUnitofMeasureText>"_RUMT_"</RateUnitofMeasureText>"
"RTN","PSOERXX5",127,0)
 I $L(RUMCQ) D C S @GBL@(CNT,0)="<RateUnitofMeasureCodeQualifier>"_RUMCQ_"</RateUnitofMeasureCodeQualifier>"
"RTN","PSOERXX5",128,0)
 I $L(RUMC) D C S @GBL@(CNT,0)="<RateUnitofMeasureCode>"_RUMC_"</RateUnitofMeasureCode>"
"RTN","PSOERXX5",129,0)
 I $L(TPBT) D C S @GBL@(CNT,0)="<TimePeriodBasisText>"_TPBT_"</TimePeriodBasisText>"
"RTN","PSOERXX5",130,0)
 I $L(TPBCQ) D C S @GBL@(CNT,0)="<TimePeriodBasisCodeQualifier>"_TPBCQ_"</TimePeriodBasisCodeQualifier>"
"RTN","PSOERXX5",131,0)
 I $L(TPBC) D C S @GBL@(CNT,0)="<TimePeriodBasisCode>"_TPBC_"</TimePeriodBasisCode>"
"RTN","PSOERXX5",132,0)
 I $L(FNV) D C S @GBL@(CNT,0)="<FrequencyNumericValue>"_FNV_"</FrequencyNumericValue>"
"RTN","PSOERXX5",133,0)
 I $L(FUT) D C S @GBL@(CNT,0)="<FrequencyUnitsText>"_FUT_"</FrequencyUnitsText>"
"RTN","PSOERXX5",134,0)
 I $L(FUCQ) D C S @GBL@(CNT,0)="<FrequencyUnitsCodeQualifier>"_FUCQ_"</FrequencyUnitsCodeQualifier>"
"RTN","PSOERXX5",135,0)
 I $L(FUC) D C S @GBL@(CNT,0)="<FrequencyUnitsCode>"_FUC_"</FrequencyUnitsCode>"
"RTN","PSOERXX5",136,0)
 I $L(VFM) D C S @GBL@(CNT,0)="<VariableFrequencyModifier>"_VFM_"</VariableFrequencyModifier>"
"RTN","PSOERXX5",137,0)
 I $L(INV) D C S @GBL@(CNT,0)="<IntervalNumericValue>"_INV_"</IntervalNumericValue>"
"RTN","PSOERXX5",138,0)
 I $L(IUT) D C S @GBL@(CNT,0)="<IntervalUnitsText>"_IUT_"</IntervalUnitsText>"
"RTN","PSOERXX5",139,0)
 I $L(IUCQ) D C S @GBL@(CNT,0)="<IntervalUnitsCodeQualifier>"_IUCQ_"</IntervalUnitsCodeQualifier>"
"RTN","PSOERXX5",140,0)
 I $L(IUC) D C S @GBL@(CNT,0)="<IntervalUnitsCode>"_IUC_"</IntervalUnitsCode>"
"RTN","PSOERXX5",141,0)
 I $L(VIM) D C S @GBL@(CNT,0)="<VariableIntervalModifier>"_VIM_"</VariableIntervalModifier>"
"RTN","PSOERXX5",142,0)
 I TIMFLG D C S @GBL@(CNT,0)="</Timing>"
"RTN","PSOERXX5",143,0)
 S DURFLG=0
"RTN","PSOERXX5",144,0)
 F DURVAR="DNV","MVM","DTCQ","DTC" D
"RTN","PSOERXX5",145,0)
 .I $L(@DURVAR) S DURFLG=1
"RTN","PSOERXX5",146,0)
 I DURFLG D C S @GBL@(CNT,0)="<Duration>"
"RTN","PSOERXX5",147,0)
 I $L(DNV) D C S @GBL@(CNT,0)="<DurationNumericValue>"_DNV_"</DurationNumericValue>"
"RTN","PSOERXX5",148,0)
 I $L(MVM) D C S @GBL@(CNT,0)="<DurationText>"_DTEXT_"</DurationText>"
"RTN","PSOERXX5",149,0)
 I $L(DTCQ) D C S @GBL@(CNT,0)="<DurationTextCodeQualifier>"_DTCQ_"</DurationTextCodeQualifier>"
"RTN","PSOERXX5",150,0)
 I $L(DTC) D C S @GBL@(CNT,0)="<DurationTextCode>"_DTC_"</DurationTextCode>"
"RTN","PSOERXX5",151,0)
 I DURFLG D C S @GBL@(CNT,0)="</Duration>"
"RTN","PSOERXX5",152,0)
 S MDRFLG=0
"RTN","PSOERXX5",153,0)
 F MDVAR="MDRNV","MDRUT","MDRCQ","MDRUC","MDRVN","MDRVUT","MDRVUCQ","MDRVUC","MDRVDM" D
"RTN","PSOERXX5",154,0)
 .I $L(@MDVAR) S MDRFLG=1
"RTN","PSOERXX5",155,0)
 I MDRFLG D C S @GBL@(CNT,0)="<MaximumDoseRestriction>"
"RTN","PSOERXX5",156,0)
 I $L(MDRNV) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionNumericValue>"_MDRNV_"</MaximumDoseRestrictionNumericValue>"
"RTN","PSOERXX5",157,0)
 I $L(MDRUT) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionUnitsText>"_MDRUT_"</MaximumDoseRestrictionUnitsText>"
"RTN","PSOERXX5",158,0)
 I $L(MDRCQ) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionCodeQualifier>"_MDRCQ_"</MaximumDoseRestrictionCodeQualifier>"
"RTN","PSOERXX5",159,0)
 I $L(MDRUC) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionUnitsCode>"_MDRUC_"</MaximumDoseRestrictionUnitsCode>"
"RTN","PSOERXX5",160,0)
 I $L(MDRVN) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionVariableNumericValue>"_MDRVN_"</MaximumDoseRestrictionVariableNumericValue>"
"RTN","PSOERXX5",161,0)
 I $L(MDRVUT) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionVariableUnitsText>"_MDRVUT_"</MaximumDoseRestrictionVariableUnitsText>"
"RTN","PSOERXX5",162,0)
 I $L(MDRVUCQ) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionVariableUnitsCodeQualifier>"_MDRVUCQ_"</MaximumDoseRestrictionVariableUnitsCodeQualifier>"
"RTN","PSOERXX5",163,0)
 I $L(MDRVUC) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionVariableUnitsCode>"_MDRVUC_"</MaximumDoseRestrictionVariableUnitsCode>"
"RTN","PSOERXX5",164,0)
 I $L(MDRVDM) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionVariableDurationModifier>"_MDRVDM_"</MaximumDoseRestrictionVariableDurationModifier>"
"RTN","PSOERXX5",165,0)
 I MDRFLG D C S @GBL@(CNT,0)="</MaximumDoseRestriction>"
"RTN","PSOERXX5",166,0)
 S INDFLG=0
"RTN","PSOERXX5",167,0)
 F INDVAR="IPT","IPCQ","IPC","IT","ITCQ","ITC","IVT","IVU","IVUMT","IVUMCQ","IVM" D
"RTN","PSOERXX5",168,0)
 .I $L(@INDVAR) S INDFLG=1
"RTN","PSOERXX5",169,0)
 I INDFLG D C S @GBL@(CNT,0)="<Indication>"
"RTN","PSOERXX5",170,0)
 I $L(IPT) D C S @GBL@(CNT,0)="<IndicationPrecursorText>"_IPT_"</IndicationPrecursorText>"
"RTN","PSOERXX5",171,0)
 I $L(IPCQ) D C S @GBL@(CNT,0)="<IndicationPrecursorCodeQualifier>"_IPCQ_"</IndicationPrecursorCodeQualifier>"
"RTN","PSOERXX5",172,0)
 I $L(IPC) D C S @GBL@(CNT,0)="<IndicationPrecursorCode>"_IPC_"</IndicationPrecursorCode>"
"RTN","PSOERXX5",173,0)
 I $L(IT) D C S @GBL@(CNT,0)="<IndicationText>"_IT_"</IndicationText>"
"RTN","PSOERXX5",174,0)
 I $L(ITCQ) D C S @GBL@(CNT,0)="<IndicationTextCodeQualifier>"_ITCQ_"</IndicationTextCodeQualifier>"
"RTN","PSOERXX5",175,0)
 I $L(ITC) D C S @GBL@(CNT,0)="<IndicationTextCode>"_ITC_"</IndicationTextCode>"
"RTN","PSOERXX5",176,0)
 I $L(IVT) D C S @GBL@(CNT,0)="<IndicationValueText>"_IVT_"</IndicationValueText>"
"RTN","PSOERXX5",177,0)
 I $L(IVU) D C S @GBL@(CNT,0)="<IndicationValueUnit>"_IVU_"</IndicationValueUnit>"
"RTN","PSOERXX5",178,0)
 I $L(IVUMT) D C S @GBL@(CNT,0)="<IndicationValueUnitofMeasureText>"_IVUMT_"</IndicationValueUnitofMeasureText>"
"RTN","PSOERXX5",179,0)
 I $L(IVUMCQ) D C S @GBL@(CNT,0)="<IndicationValueUnitofMeasureCodeQualifier>"_IVUMCQ_"</IndicationValueUnitofMeasureCodeQualifier>"
"RTN","PSOERXX5",180,0)
 I $L(IVUMC) D C S @GBL@(CNT,0)="<IndicationValueUnitofMeasureCode>"_IVUMC_"</IndicationValueUnitofMeasureCode>"
"RTN","PSOERXX5",181,0)
 I $L(IVM) D C S @GBL@(CNT,0)="<IndicationVariableModifier>"_IVM_"</IndicationVariableModifier>"
"RTN","PSOERXX5",182,0)
 I INDFLG D C S @GBL@(CNT,0)="</Indication>"
"RTN","PSOERXX5",183,0)
 I $L(STOPI) D
"RTN","PSOERXX5",184,0)
 .D C S @GBL@(CNT,0)="<Stop>"
"RTN","PSOERXX5",185,0)
 .D C S @GBL@(CNT,0)="<StopIndicator>"_STOPI_"</StopIndicator>"
"RTN","PSOERXX5",186,0)
 .D C S @GBL@(CNT,0)="</Stop>"
"RTN","PSOERXX5",187,0)
 D C S @GBL@(CNT,0)="</StructuredSIG>"
"RTN","PSOERXX5",188,0)
 Q
"RTN","PSOERXX5",189,0)
C ;
"RTN","PSOERXX5",190,0)
 S CNT=$G(CNT)+1
"RTN","PSOERXX5",191,0)
 Q
"RTN","PSOERXZ1")
0^27^B224204114^n/a
"RTN","PSOERXZ1",1,0)
PSOERXZ1 ;ALB/BWF - patch 508 post-install support ; 2/27/2018 1:43pm
"RTN","PSOERXZ1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**508**;DEC 1997;Build 295
"RTN","PSOERXZ1",3,0)
 ;
"RTN","PSOERXZ1",4,0)
 Q
"RTN","PSOERXZ1",5,0)
 ; error codes
"RTN","PSOERXZ1",6,0)
ERR ;
"RTN","PSOERXZ1",7,0)
 ;;001^Sender ID not on file.
"RTN","PSOERXZ1",8,0)
 ;;002^Receiver ID not on file.
"RTN","PSOERXZ1",9,0)
 ;;003^Invalid password for sender.
"RTN","PSOERXZ1",10,0)
 ;;004^Invalid password for receiver
"RTN","PSOERXZ1",11,0)
 ;;005^No password on file for sender.
"RTN","PSOERXZ1",12,0)
 ;;006^No password on file for receiver.
"RTN","PSOERXZ1",13,0)
 ;;007^Internal processing error has occurred.
"RTN","PSOERXZ1",14,0)
 ;;008^Request timed out before response could be received.
"RTN","PSOERXZ1",15,0)
 ;;009^Required segment UIB is missing.
"RTN","PSOERXZ1",16,0)
 ;;010^Required segment UIH is missing.
"RTN","PSOERXZ1",17,0)
 ;;011^Required segment UIT is missing.
"RTN","PSOERXZ1",18,0)
 ;;012^Required segment UIZ is missing.
"RTN","PSOERXZ1",19,0)
 ;;013^Unknown segment has been encountered.
"RTN","PSOERXZ1",20,0)
 ;;014^Too many UIB segments. CODE DESCRIPTION
"RTN","PSOERXZ1",21,0)
 ;;015^Too many UIH segments.
"RTN","PSOERXZ1",22,0)
 ;;016^Too many UIT segments.
"RTN","PSOERXZ1",23,0)
 ;;017^Too many UIZ segments.
"RTN","PSOERXZ1",24,0)
 ;;018^Password is blank.
"RTN","PSOERXZ1",25,0)
 ;;019^Too many segments.
"RTN","PSOERXZ1",26,0)
 ;;020^Unknown data element encountered.
"RTN","PSOERXZ1",27,0)
 ;;021^Unsupported version in message.
"RTN","PSOERXZ1",28,0)
 ;;022^Unsupported release in message.
"RTN","PSOERXZ1",29,0)
 ;;023^Error found in an unused field.
"RTN","PSOERXZ1",30,0)
 ;;024^Message ending problem.
"RTN","PSOERXZ1",31,0)
 ;;025^UIB trace number is invalid.
"RTN","PSOERXZ1",32,0)
 ;;026^UIB initiator reference is invalid.
"RTN","PSOERXZ1",33,0)
 ;;027^UIB control agency is invalid.
"RTN","PSOERXZ1",34,0)
 ;;028^UIB sender identification is invalid.
"RTN","PSOERXZ1",35,0)
 ;;029^UIB date is invalid.
"RTN","PSOERXZ1",36,0)
 ;;030^UIB time is invalid.
"RTN","PSOERXZ1",37,0)
 ;;031^UIB time offset is invalid.
"RTN","PSOERXZ1",38,0)
 ;;032^UIB duplicate flag is invalid.
"RTN","PSOERXZ1",39,0)
 ;;033^UIB test flag is invalid.
"RTN","PSOERXZ1",40,0)
 ;;034^UIH message type is invalid.
"RTN","PSOERXZ1",41,0)
 ;;035^UIH function is invalid.
"RTN","PSOERXZ1",42,0)
 ;;036^UIH association code is invalid.
"RTN","PSOERXZ1",43,0)
 ;;037^UIH prescription number is invalid.
"RTN","PSOERXZ1",44,0)
 ;;038^UIH initiator reference is invalid.
"RTN","PSOERXZ1",45,0)
 ;;039^UIH initiator reference identifier is invalid.
"RTN","PSOERXZ1",46,0)
 ;;040^UIH control agency is invalid.
"RTN","PSOERXZ1",47,0)
 ;;041^UIH responder control reference is invalid.
"RTN","PSOERXZ1",48,0)
 ;;042^REQ message function is invalid.
"RTN","PSOERXZ1",49,0)
 ;;043^REQ reason code is invalid.
"RTN","PSOERXZ1",50,0)
 ;;044^REQ reference is invalid.
"RTN","PSOERXZ1",51,0)
 ;;045^REQ old password is invalid.
"RTN","PSOERXZ1",52,0)
 ;;046^REQ new password is invalid.
"RTN","PSOERXZ1",53,0)
 ;;047^RES response type is invalid.
"RTN","PSOERXZ1",54,0)
 ;;048^RES response code is invalid.
"RTN","PSOERXZ1",55,0)
 ;;049^RES reference is invalid.
"RTN","PSOERXZ1",56,0)
 ;;050^RES free text is invalid.
"RTN","PSOERXZ1",57,0)
 ;;051^STS status code is invalid.
"RTN","PSOERXZ1",58,0)
 ;;052^STS reject code is invalid.
"RTN","PSOERXZ1",59,0)
 ;;053^STS free text is invalid.
"RTN","PSOERXZ1",60,0)
 ;;054^PVD provider type is invalid.
"RTN","PSOERXZ1",61,0)
 ;;055^PVD reference is invalid.
"RTN","PSOERXZ1",62,0)
 ;;056^PVD reference qualifier is invalid.
"RTN","PSOERXZ1",63,0)
 ;;057^PVD agency qualifier is invalid.
"RTN","PSOERXZ1",64,0)
 ;;058^PVD specialty, coded is invalid.
"RTN","PSOERXZ1",65,0)
 ;;059^PVD prescriber last name is invalid.
"RTN","PSOERXZ1",66,0)
 ;;060^PVD prescriber first name is invalid.
"RTN","PSOERXZ1",67,0)
 ;;061^PVD prescriber middle name is invalid.
"RTN","PSOERXZ1",68,0)
 ;;062^PVD prescriber name suffix is invalid.
"RTN","PSOERXZ1",69,0)
 ;;063^PVD prescriber name prefix is invalid.
"RTN","PSOERXZ1",70,0)
 ;;064^PVD prescriber postal code is invalid.
"RTN","PSOERXZ1",71,0)
 ;;065^PVD clinic name is invalid.
"RTN","PSOERXZ1",72,0)
 ;;066^PVD clinic street is invalid.
"RTN","PSOERXZ1",73,0)
 ;;067^PVD clinic city is invalid.
"RTN","PSOERXZ1",74,0)
 ;;068^PVD clinic country is invalid.
"RTN","PSOERXZ1",75,0)
 ;;069^PVD clinic postal code is invalid.
"RTN","PSOERXZ1",76,0)
 ;;070^PVD clinic place qualifier is invalid.
"RTN","PSOERXZ1",77,0)
 ;;071^PVD clinic place name is invalid.
"RTN","PSOERXZ1",78,0)
 ;;072^PVD communication reference is invalid.
"RTN","PSOERXZ1",79,0)
 ;;073^PVD communication qualifier is invalid.
"RTN","PSOERXZ1",80,0)
 ;;074^PVD agent last name is invalid.
"RTN","PSOERXZ1",81,0)
 ;;075^PVD agent first name is invalid.
"RTN","PSOERXZ1",82,0)
 ;;076^PVD agent middle name is invalid.
"RTN","PSOERXZ1",83,0)
 ;;077^PVD agent name suffix is invalid.
"RTN","PSOERXZ1",84,0)
 ;;078^PVD agent name prefix is invalid.
"RTN","PSOERXZ1",85,0)
 ;;079^PTT patient relationship is invalid.
"RTN","PSOERXZ1",86,0)
 ;;080^PTT patient birth date is invalid.
"RTN","PSOERXZ1",87,0)
 ;;081^PTT patient last name is invalid.
"RTN","PSOERXZ1",88,0)
 ;;082^PTT patient first name is invalid.
"RTN","PSOERXZ1",89,0)
 ;;083^PTT patient middle name is invalid.
"RTN","PSOERXZ1",90,0)
 ;;084^PTT patient name suffix is invalid.
"RTN","PSOERXZ1",91,0)
 ;;085^PTT patient name prefix is invalid.
"RTN","PSOERXZ1",92,0)
 ;;086^PTT patient gender is invalid.
"RTN","PSOERXZ1",93,0)
 ;;087^PTT patient reference is invalid.
"RTN","PSOERXZ1",94,0)
 ;;088^PTT patient reference qualifier is invalid.
"RTN","PSOERXZ1",95,0)
 ;;089^PTT patient street is invalid.
"RTN","PSOERXZ1",96,0)
 ;;090^PTT patient city is invalid.
"RTN","PSOERXZ1",97,0)
 ;;091^PTT patient country is invalid.
"RTN","PSOERXZ1",98,0)
 ;;092^PTT patient postal code is invalid.
"RTN","PSOERXZ1",99,0)
 ;;093^PTT patient place qualifier is invalid.
"RTN","PSOERXZ1",100,0)
 ;;094^PTT patient place name is invalid.
"RTN","PSOERXZ1",101,0)
 ;;095^PTT communication reference is invalid.
"RTN","PSOERXZ1",102,0)
 ;;096^PTT communication reference qualifier is invalid.
"RTN","PSOERXZ1",103,0)
 ;;097^COO payer reference is invalid.
"RTN","PSOERXZ1",104,0)
 ;;098^COO payer reference qualifier is invalid.
"RTN","PSOERXZ1",105,0)
 ;;099^COO payer name is invalid.
"RTN","PSOERXZ1",106,0)
 ;;100^COO service type is invalid.
"RTN","PSOERXZ1",107,0)
 ;;101^COO cardholder reference is invalid.
"RTN","PSOERXZ1",108,0)
 ;;102^COO cardholder reference qualifier is invalid.
"RTN","PSOERXZ1",109,0)
 ;;103^COO cardholder name is invalid.
"RTN","PSOERXZ1",110,0)
 ;;104^COO group reference is invalid.
"RTN","PSOERXZ1",111,0)
 ;;105^COO group name is invalid.
"RTN","PSOERXZ1",112,0)
 ;;106^COO group street is invalid.
"RTN","PSOERXZ1",113,0)
 ;;107^COO group city is invalid.
"RTN","PSOERXZ1",114,0)
 ;;108^COO group country is invalid.
"RTN","PSOERXZ1",115,0)
 ;;109^COO group postal code is invalid.
"RTN","PSOERXZ1",116,0)
 ;;110^COO group place qualifier is invalid.
"RTN","PSOERXZ1",117,0)
 ;;111^COO group place name is invalid.
"RTN","PSOERXZ1",118,0)
 ;;112^COO datetime qualifier is invalid.
"RTN","PSOERXZ1",119,0)
 ;;113^COO datetime is invalid.
"RTN","PSOERXZ1",120,0)
 ;;114^COO datetime format qualifier is invalid.
"RTN","PSOERXZ1",121,0)
 ;;115^COO insurance type is invalid.
"RTN","PSOERXZ1",122,0)
 ;;116^COO holder street is invalid.
"RTN","PSOERXZ1",123,0)
 ;;117^COO holder city is invalid.
"RTN","PSOERXZ1",124,0)
 ;;118^COO holder country is invalid.
"RTN","PSOERXZ1",125,0)
 ;;119^COO holder postal code is invalid.
"RTN","PSOERXZ1",126,0)
 ;;120^COO holder place qualifier is invalid.
"RTN","PSOERXZ1",127,0)
 ;;121^COO holder place name is invalid.
"RTN","PSOERXZ1",128,0)
 ;;122^COO holder reference is invalid.
"RTN","PSOERXZ1",129,0)
 ;;123^COO holder reference qualifier is invalid.
"RTN","PSOERXZ1",130,0)
 ;;124^COO response code is invalid.
"RTN","PSOERXZ1",131,0)
 ;;125^DRU drug disposition code is invalid.
"RTN","PSOERXZ1",132,0)
 ;;126^DRU drug name is invalid.
"RTN","PSOERXZ1",133,0)
 ;;127^DRU drug item number is invalid.
"RTN","PSOERXZ1",134,0)
 ;;128^DRU drug agency is invalid.
"RTN","PSOERXZ1",135,0)
 ;;129^DRU drug agency qualifier is invalid.
"RTN","PSOERXZ1",136,0)
 ;;130^DRU drug strength is invalid.
"RTN","PSOERXZ1",137,0)
 ;;131^DRU drug strength qualifier is invalid.
"RTN","PSOERXZ1",138,0)
 ;;132^DRU drug reference is invalid.
"RTN","PSOERXZ1",139,0)
 ;;133^DRU drug reference qualifier is invalid.
"RTN","PSOERXZ1",140,0)
 ;;134^DRU dosage quantity qualifier is invalid.
"RTN","PSOERXZ1",141,0)
 ;;135^DRU dosage quantity is invalid.
"RTN","PSOERXZ1",142,0)
 ;;136^DRU dosage info qualifier is invalid.
"RTN","PSOERXZ1",143,0)
 ;;137^DRU dosage info is invalid.
"RTN","PSOERXZ1",144,0)
 ;;138^DRU dosage free text is invalid.
"RTN","PSOERXZ1",145,0)
 ;;139^DRU datetime qualifier is invalid.
"RTN","PSOERXZ1",146,0)
 ;;140^DRU datetime is invalid.
"RTN","PSOERXZ1",147,0)
 ;;141^DRU datetime format qualifier is invalid.
"RTN","PSOERXZ1",148,0)
 ;;142^DRU substitution code is invalid.
"RTN","PSOERXZ1",149,0)
 ;;143^DRU refill quantity qualifier is invalid.
"RTN","PSOERXZ1",150,0)
 ;;144^DRU refill quantity is invalid.
"RTN","PSOERXZ1",151,0)
 ;;145^DRU clinical info qualifier is invalid.
"RTN","PSOERXZ1",152,0)
 ;;146^DRU clinical info level1 reference is invalid
"RTN","PSOERXZ1",153,0)
 ;;147^DRU clinical info level1 qualifier is invalid.
"RTN","PSOERXZ1",154,0)
 ;;148^DRU clinical info level2 reference is invalid.
"RTN","PSOERXZ1",155,0)
 ;;149^DRU clinical info level2 qualifier is invalid.
"RTN","PSOERXZ1",156,0)
 ;;150^DRU prior authorization reference is invalid.
"RTN","PSOERXZ1",157,0)
 ;;151^DRU prior authorization qualifier is invalid.
"RTN","PSOERXZ1",158,0)
 ;;152^DRU free text is invalid.
"RTN","PSOERXZ1",159,0)
 ;;153^OBS measurement dimension is invalid.
"RTN","PSOERXZ1",160,0)
 ;;154^OBS measurement value is invalid.
"RTN","PSOERXZ1",161,0)
 ;;155^OBS measurement qualifier is invalid.
"RTN","PSOERXZ1",162,0)
 ;;156^OBS datetime is invalid.
"RTN","PSOERXZ1",163,0)
 ;;157^OBS datetime qualifier is invalid.
"RTN","PSOERXZ1",164,0)
 ;;158^OBS free text is invalid.
"RTN","PSOERXZ1",165,0)
 ;;159^UIT reference number is invalid.
"RTN","PSOERXZ1",166,0)
 ;;160^UIT segment count is invalid.
"RTN","PSOERXZ1",167,0)
 ;;161^UIZ dial reference is invalid.
"RTN","PSOERXZ1",168,0)
 ;;162^UIZ dial identifier is invalid.
"RTN","PSOERXZ1",169,0)
 ;;163^UIZ control agency is invalid.
"RTN","PSOERXZ1",170,0)
 ;;164^UIZ responder control ref is invalid.
"RTN","PSOERXZ1",171,0)
 ;;165^UIZ message count is invalid.
"RTN","PSOERXZ1",172,0)
 ;;166^Too many elements in COO segment.
"RTN","PSOERXZ1",173,0)
 ;;167^Too many elements in DRU segment.
"RTN","PSOERXZ1",174,0)
 ;;168^Too many elements in OBS segment.
"RTN","PSOERXZ1",175,0)
 ;;169^Too many elements in PTT segment.
"RTN","PSOERXZ1",176,0)
 ;;170^Too many elements in PVD segment.
"RTN","PSOERXZ1",177,0)
 ;;171^Too many elements in REQ segment.
"RTN","PSOERXZ1",178,0)
 ;;172^Too many elements in RES segment.
"RTN","PSOERXZ1",179,0)
 ;;173^Too many elements in STS segment.
"RTN","PSOERXZ1",180,0)
 ;;174^Too many elements in UIB segment.
"RTN","PSOERXZ1",181,0)
 ;;175^Too many elements in UIH segment.
"RTN","PSOERXZ1",182,0)
 ;;176^Too many elements in UIT segment.
"RTN","PSOERXZ1",183,0)
 ;;177^Too many elements in UIZ segment.
"RTN","PSOERXZ1",184,0)
 ;;178^Too many COO segments.
"RTN","PSOERXZ1",185,0)
 ;;179^Too many DRU segments.
"RTN","PSOERXZ1",186,0)
 ;;180^Too many OBS segments.
"RTN","PSOERXZ1",187,0)
 ;;181^Too many PTT segments.
"RTN","PSOERXZ1",188,0)
 ;;182^Too many PVD segments.
"RTN","PSOERXZ1",189,0)
 ;;183^Too many REQ segments.
"RTN","PSOERXZ1",190,0)
 ;;184^Too many RES segments.
"RTN","PSOERXZ1",191,0)
 ;;185^Too many STS segments.
"RTN","PSOERXZ1",192,0)
 ;;186^Too many UNA segments.
"RTN","PSOERXZ1",193,0)
 ;;187^Too many COO element repetitions.
"RTN","PSOERXZ1",194,0)
 ;;188^Too many DRU element repetitions.
"RTN","PSOERXZ1",195,0)
 ;;189^Too many OBS element repetitions.
"RTN","PSOERXZ1",196,0)
 ;;190^Too many PTT element repetitions.
"RTN","PSOERXZ1",197,0)
 ;;191^Too many PVD element repetitions.
"RTN","PSOERXZ1",198,0)
 ;;192^Too many REQ element repetitions.
"RTN","PSOERXZ1",199,0)
 ;;193^Too many RES element repetitions.
"RTN","PSOERXZ1",200,0)
 ;;194^Too many STS element repetitions.
"RTN","PSOERXZ1",201,0)
 ;;195^Too many UIB element repetitions.
"RTN","PSOERXZ1",202,0)
 ;;196^Too many UIH element repetitions.
"RTN","PSOERXZ1",203,0)
 ;;197^Too many UIT element repetitions.
"RTN","PSOERXZ1",204,0)
 ;;198^Too many UIZ element repetitions.
"RTN","PSOERXZ1",205,0)
 ;;199^Segment count mismatch in UIT.
"RTN","PSOERXZ1",206,0)
 ;;200^Message missing required REQ segment.
"RTN","PSOERXZ1",207,0)
 ;;201^Message missing required RES segment.
"RTN","PSOERXZ1",208,0)
 ;;202^Message missing required STS segment.
"RTN","PSOERXZ1",209,0)
 ;;203^Message missing required PVD segment.
"RTN","PSOERXZ1",210,0)
 ;;204^Message missing required PTT segment.
"RTN","PSOERXZ1",211,0)
 ;;205^Message missing required COO segment.
"RTN","PSOERXZ1",212,0)
 ;;206^Message missing required DRU segment.
"RTN","PSOERXZ1",213,0)
 ;;207^Message missing required OBS segment.
"RTN","PSOERXZ1",214,0)
 ;;208^Sender no longer active.
"RTN","PSOERXZ1",215,0)
 ;;209^Receiver no longer active.
"RTN","PSOERXZ1",216,0)
 ;;210^Unable to process transaction. Please resubmit.
"RTN","PSOERXZ1",217,0)
 ;;211^DUE Reason For Service Code is invalid.
"RTN","PSOERXZ1",218,0)
 ;;212^DUE Professional Service Code is invalid.
"RTN","PSOERXZ1",219,0)
 ;;213^DUE Result Of Service Code is invalid.
"RTN","PSOERXZ1",220,0)
 ;;214^DUE Co-Agent ID is invalid.
"RTN","PSOERXZ1",221,0)
 ;;215^DUE Co-Agent ID Qualifier is invalid.
"RTN","PSOERXZ1",222,0)
 ;;216^Drug Coverage Status Code is invalid.
"RTN","PSOERXZ1",223,0)
 ;;217^COO Date/Time/Period Expiration date - of needed history is less than Effective Date (Begin) of needed history
"RTN","PSOERXZ1",224,0)
 ;;218^COO Patient Identifier is invalid
"RTN","PSOERXZ1",225,0)
 ;;219^COO Cannot process Medication History due to value of Condition/Response, coded (Patient Consent Indicator)
"RTN","PSOERXZ1",226,0)
 ;;220^Message is a duplicate
"RTN","PSOERXZ1",227,0)
 ;;221^Needed No Later Than Reason Date/Time Period Qualifier is invalid
"RTN","PSOERXZ1",228,0)
 ;;222^Needed No Later Than Reason Date/Time/Period is invalid
"RTN","PSOERXZ1",229,0)
 ;;223^Needed No Later Than Reason Date/Time/Period Format Qualifier is invalid
"RTN","PSOERXZ1",230,0)
 ;;224^DRU Time Zone Identifier is invalid
"RTN","PSOERXZ1",231,0)
 ;;225^DRU Time Zone Difference Quantity is invalid
"RTN","PSOERXZ1",232,0)
 ;;226^Needed No Later Than Reason is invalid
"RTN","PSOERXZ1",233,0)
 ;;227^Message missing required SRC Segment
"RTN","PSOERXZ1",234,0)
 ;;228^SRC Source Qualifier is invalid
"RTN","PSOERXZ1",235,0)
 ;;229^SRC Source Description is invalid
"RTN","PSOERXZ1",236,0)
 ;;230^SRC Source Reference Number is invalid
"RTN","PSOERXZ1",237,0)
 ;;231^SRC Source Reference Qualifier is invalid
"RTN","PSOERXZ1",238,0)
 ;;232^SRC Reference Number is invalid
"RTN","PSOERXZ1",239,0)
 ;;233^SRC Fill Number is invalid
"RTN","PSOERXZ1",240,0)
 ;;234^Too many SRC Segments
"RTN","PSOERXZ1",241,0)
 ;;235^Too many SRC element repetitions
"RTN","PSOERXZ1",242,0)
 ;;236^Too many elements in SRC Segment
"RTN","PSOERXZ1",243,0)
 ;;237^SIG Sig Sequence Position Number is invalid
"RTN","PSOERXZ1",244,0)
 ;;238^SIG Multiple Sig Modifier is invalid
"RTN","PSOERXZ1",245,0)
 ;;239^SIG SNOMED Version is invalid
"RTN","PSOERXZ1",246,0)
 ;;240^SIG FMT Version is invalid
"RTN","PSOERXZ1",247,0)
 ;;241^SIG Sig Free Text String Indicator is invalid CODE DESCRIPTION
"RTN","PSOERXZ1",248,0)
 ;;242^SIG Sig Free Text is invalid
"RTN","PSOERXZ1",249,0)
 ;;243^SIG Dose Composite Indicator is invalid
"RTN","PSOERXZ1",250,0)
 ;;244^SIG Dose Delivery Method Text is invalid
"RTN","PSOERXZ1",251,0)
 ;;245^SIG Dose Delivery Method Code Qualifier is invalid
"RTN","PSOERXZ1",252,0)
 ;;246^SIG Dose Delivery Method Code is invalid
"RTN","PSOERXZ1",253,0)
 ;;247^SIG Dose Delivery Method Modifier Text is invalid
"RTN","PSOERXZ1",254,0)
 ;;248^SIG Dose Delivery Method Modifier Code Qualifier is invalid
"RTN","PSOERXZ1",255,0)
 ;;249^SIG Dose Delivery Method Modifier Code is invalid
"RTN","PSOERXZ1",256,0)
 ;;250^SIG Dose Quantity is invalid
"RTN","PSOERXZ1",257,0)
 ;;251^SIG Dose Form Text is invalid
"RTN","PSOERXZ1",258,0)
 ;;252^SIG Dose Form Code Qualifier is invalid
"RTN","PSOERXZ1",259,0)
 ;;253^SIG Dose Form Code is invalid
"RTN","PSOERXZ1",260,0)
 ;;254^SIG Dose Range Modifier is invalid
"RTN","PSOERXZ1",261,0)
 ;;255^SIG Dosing Basis Numeric Value is invalid
"RTN","PSOERXZ1",262,0)
 ;;256^SIG Dosing Basis Unit of Measure Text is invalid
"RTN","PSOERXZ1",263,0)
 ;;257^SIG Dosing Basis Unit of Measure Code Qualifier is invalid
"RTN","PSOERXZ1",264,0)
 ;;258^SIG Dosing Basis Unit of Measure Code is invalid
"RTN","PSOERXZ1",265,0)
 ;;259^SIG Body Metric Qualifier is invalid
"RTN","PSOERXZ1",266,0)
 ;;260^SIG Body Metric Value is invalid
"RTN","PSOERXZ1",267,0)
 ;;261^SIG Calculated Dose Numeric is invalid
"RTN","PSOERXZ1",268,0)
 ;;262^SIG Calculated Dose Unit of Measure Text is invalid
"RTN","PSOERXZ1",269,0)
 ;;263^SIG Calculated Dose Unit of Measure Code Qualifier is invalid
"RTN","PSOERXZ1",270,0)
 ;;264^SIG Calculated Dose Unit of Measure Code is invalid
"RTN","PSOERXZ1",271,0)
 ;;265^SIG Dosing Basis Range Modifier is invalid
"RTN","PSOERXZ1",272,0)
 ;;266^SIG Vehicle Name is invalid
"RTN","PSOERXZ1",273,0)
 ;;267^SIG Vehicle Name Code Qualifier is invalid
"RTN","PSOERXZ1",274,0)
 ;;268^SIG Vehicle Name Code is invalid
"RTN","PSOERXZ1",275,0)
 ;;269^SIG Vehicle Quantity is invalid
"RTN","PSOERXZ1",276,0)
 ;;270^SIG Vehicle Unit Of Measure Text is invalid
"RTN","PSOERXZ1",277,0)
 ;;271^SIG Vehicle Unit Of Measure Code Qualifier is invalid
"RTN","PSOERXZ1",278,0)
 ;;272^SIG Vehicle Unit Of Measure Code is invalid
"RTN","PSOERXZ1",279,0)
 ;;273^SIG Multiple Vehicle Modifier is invalid
"RTN","PSOERXZ1",280,0)
 ;;274^SIG Route of Administration Text is invalid
"RTN","PSOERXZ1",281,0)
 ;;275^SIG Route of Administration Code Qualifier is invalid
"RTN","PSOERXZ1",282,0)
 ;;276^SIG Route of Administration Code is invalid
"RTN","PSOERXZ1",283,0)
 ;;277^SIG Multiple Route of Administration Modifier is invalid
"RTN","PSOERXZ1",284,0)
 ;;278^SIG Site of Administration Text is invalid
"RTN","PSOERXZ1",285,0)
 ;;279^SIG Site of Administration Code Qualifier is invalid
"RTN","PSOERXZ1",286,0)
 ;;280^SIG Site of Administration Code is invalid
"RTN","PSOERXZ1",287,0)
 ;;281^SIG Multiple Administration Timing Modifier is invalid
"RTN","PSOERXZ1",288,0)
 ;;282^SIG Administration Timing Text is invalid
"RTN","PSOERXZ1",289,0)
 ;;283^SIG Administration Timing Code Qualifier is invalid
"RTN","PSOERXZ1",290,0)
 ;;284^SIG Administration Timing Code is invalid
"RTN","PSOERXZ1",291,0)
 ;;285^SIG Multiple Administration Timing Modifier is invalid
"RTN","PSOERXZ1",292,0)
 ;;286^SIG Rate of Administration is invalid
"RTN","PSOERXZ1",293,0)
 ;;287^SIG Rate Unit of Measure Text is invalid
"RTN","PSOERXZ1",294,0)
 ;;288^SIG Rate Unit of Measure Code Qualifier is invalid
"RTN","PSOERXZ1",295,0)
 ;;289^SIG Rate Unit of Measure Code is invalid
"RTN","PSOERXZ1",296,0)
 ;;290^SIG Time Period Basis Text is invalid
"RTN","PSOERXZ1",297,0)
 ;;291^SIG Time Period Basis Code Qualifier is invalid
"RTN","PSOERXZ1",298,0)
 ;;292^SIG Time Period Basis Code is invalid
"RTN","PSOERXZ1",299,0)
 ;;293^SIG Frequency Numeric Value is invalid
"RTN","PSOERXZ1",300,0)
 ;;294^SIG Frequency Units Text is invalid
"RTN","PSOERXZ1",301,0)
 ;;295^SIG Frequency Units Code Qualifier is invalid
"RTN","PSOERXZ1",302,0)
 ;;296^SIG Frequency Units Code is invalid
"RTN","PSOERXZ1",303,0)
 ;;297^SIG Variable Frequency Modifier is invalid
"RTN","PSOERXZ1",304,0)
 ;;298^Interval Numeric Value is invalid
"RTN","PSOERXZ1",305,0)
 ;;299^SIG Interval Units Text is invalid
"RTN","PSOERXZ1",306,0)
 ;;300^SIG Interval Units Code Qualifier is invalid
"RTN","PSOERXZ1",307,0)
 ;;301^SIG Interval Units Code is invalid
"RTN","PSOERXZ1",308,0)
 ;;302^SIG Variable Interval Modifier is invalid
"RTN","PSOERXZ1",309,0)
 ;;303^SIG Duration Numeric Value is invalid
"RTN","PSOERXZ1",310,0)
 ;;304^SIG Duration Text is invalid
"RTN","PSOERXZ1",311,0)
 ;;305^SIG Duration Text Code Qualifier is invalid
"RTN","PSOERXZ1",312,0)
 ;;306^SIG Duration Text Code is invalid
"RTN","PSOERXZ1",313,0)
 ;;307^SIG Maximum Dose Restriction Numeric Value is invalid
"RTN","PSOERXZ1",314,0)
 ;;308^SIG Maximum Dose Restriction Units Text is invalid
"RTN","PSOERXZ1",315,0)
 ;;309^SIG Maximum Dose Restriction Code Qualifier is invalid
"RTN","PSOERXZ1",316,0)
 ;;310^SIG Maximum Dose Restriction Units Code is invalid
"RTN","PSOERXZ1",317,0)
 ;;311^SIG Maximum Dose Restriction Variable Numeric Value is invalid
"RTN","PSOERXZ1",318,0)
 Q
"RTN","PSOORAL1")
0^36^B141679409^B120026363
"RTN","PSOORAL1",1,0)
PSOORAL1 ;BHAM ISC/SAB - Build Listman activity logs ; 12/4/07 12:25pm
"RTN","PSOORAL1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**71,156,148,247,240,287,354,367,408,482,508**;DEC 1997;Build 295
"RTN","PSOORAL1",3,0)
 N RX0,VALMCNT K DIR,DTOUT,DUOUT,DIRUT,^TMP("PSOAL",$J) S DA=$P(PSOLST(ORN),"^",2),RX0=^PSRX(DA,0),J=DA,RX2=$G(^(2)),R3=$G(^(3)),CMOP=$O(^PSRX(DA,4,0))
"RTN","PSOORAL1",4,0)
 S IEN=0,DIR(0)="LO^1:"_$S(CMOP:10,1:9),DIR("A",1)=" ",DIR("A",2)="Select Activity Log by  number",DIR("A",3)="1.  Refill    2.  Partial     3.  Activity   4.  Labels      5.  Copay"
"RTN","PSOORAL1",5,0)
 S DIR("A")=$S(CMOP:"6.  ECME      7.  SPMP        8.  eRx Log    9.  CMOP Events 10.  All Logs    ",1:"6.  ECME      7.  SPMP        8.  eRx Log    9.  All Logs")
"RTN","PSOORAL1",6,0)
 S DIR("B")=$S(CMOP:10,1:9) D ^DIR S PSOELSE=+Y I +Y S Y=$S(CMOP&(Y[10):"1,2,3,4,5,6,7,8,9",'CMOP&(Y[9):"1,2,3,4,5,6,7,8",1:Y) S ACT=Y D FULL^VALM1 D
"RTN","PSOORAL1",7,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Rx #: "_$P(RX0,"^")_"   Original Fill Released: " I $P(RX2,"^",13) S DTT=$P(RX2,"^",13) D DAT S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_DAT K DAT,DTT
"RTN","PSOORAL1",8,0)
 .I $P(RX2,"^",15) S DTT=$P(RX2,"^",15) D DAT S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"(Returned to Stock "_DAT_")" K DAT,DTT
"RTN","PSOORAL1",9,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Routing: "_$S($P(RX0,"^",11)="W":"Window",1:"Mail")_$S($P($G(^PSRX(DA,"OR1")),"^",5):"      Finished by: "_$P(^VA(200,$P(^PSRX(DA,"OR1"),"^",5),0),"^"),1:"")
"RTN","PSOORAL1",10,0)
 .D:$G(^PSRX(DA,"H"))]""&($P(PSOLST(ORN),"^",3)="HOLD") HLD^PSOORAL2
"RTN","PSOORAL1",11,0)
 .F LOG=1:1:$L(ACT,",") Q:$P(ACT,",",LOG)']""  S LBL=$P(ACT,",",LOG) D @$S(LBL=1:"RF^PSOORAL2",LBL=2:"PAR^PSOORAL2",LBL=3:"ACT",LBL=5:"COPAY",LBL=6:"ECME",LBL=7:"SPMP",LBL=8:"ERX",LBL=9:"^PSORXVW2",1:"LBL")
"RTN","PSOORAL1",12,0)
 I 'PSOELSE S VALMBCK="" K PSOELSE Q 
"RTN","PSOORAL1",13,0)
 K ST0,RFL,RFLL,RFL1,II,J,N,PHYS,L1,DIRUT,PSDIV,PSEXDT,MED,M1,FFX,DTT,DAT,R3,RTN,SIG,STA,P1,PL,P0,Z0,Z1,EXDT,IFN,DIR,DUOUT,DTOUT,PSOELSE
"RTN","PSOORAL1",14,0)
 K LBL,I,RFDATE,%H,%I,RN,RFT
"RTN","PSOORAL1",15,0)
 S PSOAL=IEN K IEN,ACT,LBL,LOG D EN^PSOORAL S VALMBCK="R"
"RTN","PSOORAL1",16,0)
 Q
"RTN","PSOORAL1",17,0)
ACT ;activity log
"RTN","PSOORAL1",18,0)
 N CNT
"RTN","PSOORAL1",19,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Activity Log:"
"RTN","PSOORAL1",20,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#   Date/Time            Reason         Rx Ref         Initiator Of Activity",IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSOORAL1",21,0)
 I '$O(^PSRX(DA,"A",0)) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There's NO Activity to report" Q
"RTN","PSOORAL1",22,0)
 S CNT=0
"RTN","PSOORAL1",23,0)
 F N=0:0 S N=$O(^PSRX(DA,"A",N)) Q:'N  S P1=^(N,0) D
"RTN","PSOORAL1",24,0)
 .I $P(P1,"^",2)="M" Q
"RTN","PSOORAL1",25,0)
 .S DAT=$$FMTE^XLFDT($P(P1,"^"),2)_"             "
"RTN","PSOORAL1",26,0)
 .S IEN=IEN+1,CNT=CNT+1,^TMP("PSOAL",$J,IEN,0)=CNT_"   "_$E(DAT,1,21),$P(RN," ",15)=" ",REA=$P(P1,"^",2)
"RTN","PSOORAL1",27,0)
 .S REA=$F("HUCELPRWSIVDABXGKNO",REA)-1
"RTN","PSOORAL1",28,0)
 .I REA D
"RTN","PSOORAL1",29,0)
 ..S STA=$P("HOLD^UNHOLD^DISCONTINUED^EDIT^RENEWED^PARTIAL^REINSTATE^REPRINT^SUSPENSE^RETURNED^INTERVENTION^DELETED^DRUG INTERACTION^PROCESSED^X-INTERFACE^PATIENT INSTR.^PKI/DEA^DISP COMPLETED^IERX^","^",REA)
"RTN","PSOORAL1",30,0)
 ..S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_STA_$E(RN,$L(STA)+1,15)
"RTN","PSOORAL1",31,0)
 .E  S $P(STA," ",15)=" ",^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_STA
"RTN","PSOORAL1",32,0)
 .K STA,RN S $P(RN," ",15)=" ",RF=+$P(P1,"^",4)
"RTN","PSOORAL1",33,0)
 .S RFT=$S(RF>0&(RF<6):"REFILL "_RF,RF=6:"PARTIAL",RF>6:"REFILL "_(RF-1),1:"ORIGINAL")
"RTN","PSOORAL1",34,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_RFT_$E(RN,$L(RFT)+1,15)_$E($S($D(^VA(200,+$P(P1,"^",3),0)):$P(^(0),"^"),1:$P(P1,"^",3)),1,24)
"RTN","PSOORAL1",35,0)
 .;S:$P(P1,"^",5)]"" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Comments: "_$P(P1,"^",5)
"RTN","PSOORAL1",36,0)
 .I $P(P1,"^",5)]"" N PSOACBRK,PSOACBRV D
"RTN","PSOORAL1",37,0)
 ..S PSOACBRV=$P(P1,"^",5)
"RTN","PSOORAL1",38,0)
 ..;PSO*7*240 Use fileman for parsing
"RTN","PSOORAL1",39,0)
 ..K ^UTILITY($J,"W") S X="Comments: "_PSOACBRV,(DIWR,DIWL)=1,DIWF="C80" D ^DIWP F I=1:1:^UTILITY($J,"W",1) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=$G(^UTILITY($J,"W",1,I,0))
"RTN","PSOORAL1",40,0)
 .I $P($G(^PSRX(DA,"A",N,1)),"^")]"" S IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0)," ",5)=$P($G(^PSRX(DA,"A",N,1)),"^") I $P($G(^PSRX(DA,"A",N,1)),"^",2)]"" S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_":"_$P($G(^PSRX(DA,"A",N,1)),"^",2)
"RTN","PSOORAL1",41,0)
 .I $O(^PSRX(DA,"A",N,2,0)) F I=0:0 S I=$O(^PSRX(DA,"A",N,2,I)) Q:'I  S MIG=^PSRX(DA,"A",N,2,I,0) D
"RTN","PSOORAL1",42,0)
 ..S:MIG["Mail Tracking Info.: " IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0)," ",9)=" "
"RTN","PSOORAL1",43,0)
 ..F SG=1:1:$L(MIG) S:$L(^TMP("PSOAL",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0)," ",9)=" " S:$P(MIG," ",SG)'="" ^TMP("PSOAL",$J,IEN,0)=$G(^TMP("PSOAL",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORAL1",44,0)
 K MIG,SG,I,^UTILITY($J,"W"),DIWF,DIWL,DIWR
"RTN","PSOORAL1",45,0)
 Q
"RTN","PSOORAL1",46,0)
LBL ;label log
"RTN","PSOORAL1",47,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Label Log:"
"RTN","PSOORAL1",48,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#   Date        Rx Ref                    Printed By",IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSOORAL1",49,0)
 I '$O(^PSRX(DA,"L",0)) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There are NO Labels printed." Q
"RTN","PSOORAL1",50,0)
 F L1=0:0 S L1=$O(^PSRX(DA,"L",L1)) Q:'L1  S LBL=^PSRX(DA,"L",L1,0),DTT=$P(^(0),"^") D DAT D
"RTN","PSOORAL1",51,0)
 . S $P(RN," ",26)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=L1_"   "_DAT_"    ",RFT=$S($P(LBL,"^",2):"REFILL "_$P(LBL,"^",2),1:"ORIGINAL"),RFT=RFT_$E(RN,$L(RFT)+1,26)
"RTN","PSOORAL1",52,0)
 . S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_RFT_$P($G(^VA(200,$P(LBL,"^",4),0)),"^"),IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Comments: "_$P(LBL,"^",3)
"RTN","PSOORAL1",53,0)
 . N FDAMGDOC S FDAMGDOC=$G(^PSRX(DA,"L",L1,"FDA"))
"RTN","PSOORAL1",54,0)
 . I FDAMGDOC'="" D
"RTN","PSOORAL1",55,0)
 . . S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="FDA Med Guide: "_$E(FDAMGDOC,1,61)
"RTN","PSOORAL1",56,0)
 . . I $L(FDAMGDOC)>61 D
"RTN","PSOORAL1",57,0)
 . . . F  Q:$E(FDAMGDOC,62,999)=""  D
"RTN","PSOORAL1",58,0)
 . . . . S FDAMGDOC=$E(FDAMGDOC,62,999),IEN=IEN+1
"RTN","PSOORAL1",59,0)
 . . . . S ^TMP("PSOAL",$J,IEN,0)=$E(FDAMGDOC,1,61)
"RTN","PSOORAL1",60,0)
 Q
"RTN","PSOORAL1",61,0)
 ;
"RTN","PSOORAL1",62,0)
COPAY ;Copay activity log
"RTN","PSOORAL1",63,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Copay Activity Log:"
"RTN","PSOORAL1",64,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#   Date        Reason               Rx Ref         Initiator Of Activity",IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSOORAL1",65,0)
 I '$O(^PSRX(DA,"COPAY",0)) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There's NO Copay activity to report" Q
"RTN","PSOORAL1",66,0)
 F N=0:0 S N=$O(^PSRX(DA,"COPAY",N)) Q:'N  S P1=^(N,0),DTT=P1\1 D DAT D
"RTN","PSOORAL1",67,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=N_"   "_DAT_"    ",$P(RN," ",21)=" ",REA=$P(P1,"^",2),REA=$F("ARICE",REA)-1
"RTN","PSOORAL1",68,0)
 .I REA D
"RTN","PSOORAL1",69,0)
 ..S STA=$P("ANNUAL CAP REACHED^COPAY RESET^IB-INITIATED COPAY^REMOVE COPAY CHARGE^RX EDITED^","^",REA)
"RTN","PSOORAL1",70,0)
 ..S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_STA_$E(RN,$L(STA)+1,21)
"RTN","PSOORAL1",71,0)
 .E  S $P(STA," ",21)=" ",^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_STA
"RTN","PSOORAL1",72,0)
 .K STA,RN S $P(RN," ",15)=" ",RF=+$P(P1,"^",4)
"RTN","PSOORAL1",73,0)
 .S RFT=$S(RF>0:"REFILL "_RF,1:"ORIGINAL")
"RTN","PSOORAL1",74,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_RFT_$E(RN,$L(RFT)+1,15)_$S($D(^VA(200,+$P(P1,"^",3),0)):$P(^(0),"^"),1:$P(P1,"^",3))
"RTN","PSOORAL1",75,0)
 .S:$P(P1,"^",5)]""!($P(P1,"^",6)]"")!($P(P1,"^",7)]"") IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Comment: "_$P(P1,"^",5)
"RTN","PSOORAL1",76,0)
 .I $P(P1,"^",6)]"" S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"  Old value="_$P(P1,"^",6)_"   New value="_$P(P1,"^",7)
"RTN","PSOORAL1",77,0)
 Q
"RTN","PSOORAL1",78,0)
 ;
"RTN","PSOORAL1",79,0)
ECME ; ECME activity log
"RTN","PSOORAL1",80,0)
 ;
"RTN","PSOORAL1",81,0)
 N DIWF,DIWL,DIWR,I,II,III,LINE,PSOAR,PSOCNT,PSOCNT1,PSOCOMMENT
"RTN","PSOORAL1",82,0)
 N PSODATA,PSODATE,PSODATE1,PSOFIELDS,PSOFILE,PSOIENS,PSOLINE
"RTN","PSOORAL1",83,0)
 N PSOREFILL,PSOREFILL1,PSOUSER,PSOUSER1
"RTN","PSOORAL1",84,0)
 ;
"RTN","PSOORAL1",85,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" "
"RTN","PSOORAL1",86,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="ECME Log:"
"RTN","PSOORAL1",87,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#   Date/Time           Rx Ref          Initiator Of Activity"
"RTN","PSOORAL1",88,0)
 S IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSOORAL1",89,0)
 ;
"RTN","PSOORAL1",90,0)
 ; The comments from ACTIVITY LOG (#52.3) and REJECT INFO (#52.25)
"RTN","PSOORAL1",91,0)
 ; will be compiled in array PSOAR. This array will allow comments
"RTN","PSOORAL1",92,0)
 ; from each sub-file to be sorted in ascending order by date.
"RTN","PSOORAL1",93,0)
 ; A counter (PSOCNT) will be used to accommodate multiple 
"RTN","PSOORAL1",94,0)
 ; comments with the exact same date/time.
"RTN","PSOORAL1",95,0)
 ;
"RTN","PSOORAL1",96,0)
 ; PSOAR array definition:
"RTN","PSOORAL1",97,0)
 ;
"RTN","PSOORAL1",98,0)
 ;  PSOAR(PSODATE)=PSOCNT
"RTN","PSOORAL1",99,0)
 ;  PSOAR(PSODATE,PSOCNT)=PSODATE^PSOUSER1^PSOREFILL1^PSOCOMMENT
"RTN","PSOORAL1",100,0)
 ;  PSOAR(PSODATE,PSOCNT,PSOCNT1)=Additional Comments (if any)
"RTN","PSOORAL1",101,0)
 ;
"RTN","PSOORAL1",102,0)
 ;   PSODATE ---- Date/time of comment - internal format
"RTN","PSOORAL1",103,0)
 ;   PSOCNT ----- Counter of comments, by date
"RTN","PSOORAL1",104,0)
 ;   PSOCNT1 ---- Counter of additional comments (if any)
"RTN","PSOORAL1",105,0)
 ;   PSOUSER1 --- User who entered comment - external format
"RTN","PSOORAL1",106,0)
 ;   PSOREFILL1 - Refill number - external format
"RTN","PSOORAL1",107,0)
 ;   PSOCOMMENT - Comment
"RTN","PSOORAL1",108,0)
 ;
"RTN","PSOORAL1",109,0)
 ; Kill PSOAR to initialize array
"RTN","PSOORAL1",110,0)
 ;
"RTN","PSOORAL1",111,0)
 K PSOAR
"RTN","PSOORAL1",112,0)
 ;
"RTN","PSOORAL1",113,0)
 ; Loop through ACTIVITY LOG (file #52.3) searching for ECME Entries.
"RTN","PSOORAL1",114,0)
 ; ECME Entries are defined as REASON="M".
"RTN","PSOORAL1",115,0)
 ;
"RTN","PSOORAL1",116,0)
 ; ACTIVITY LOG Fields:
"RTN","PSOORAL1",117,0)
 ;  .01 = Activity Log (Date)
"RTN","PSOORAL1",118,0)
 ;  .02 = Reason
"RTN","PSOORAL1",119,0)
 ;  .03 = Initiator of Activity (User)
"RTN","PSOORAL1",120,0)
 ;  .04 = RX Reference (Refill #)
"RTN","PSOORAL1",121,0)
 ;  .05 = Comment
"RTN","PSOORAL1",122,0)
 ;
"RTN","PSOORAL1",123,0)
 ; The above fields will be stored in array PSODATA via a call to ^DIQ.
"RTN","PSOORAL1",124,0)
 ; 
"RTN","PSOORAL1",125,0)
 S I=0
"RTN","PSOORAL1",126,0)
 F  S I=$O(^PSRX(DA,"A",I)) Q:'I  D
"RTN","PSOORAL1",127,0)
 . ;
"RTN","PSOORAL1",128,0)
 . S PSOCNT=0
"RTN","PSOORAL1",129,0)
 . S PSOFILE=52.3
"RTN","PSOORAL1",130,0)
 . S PSOIENS=I_","_DA_","
"RTN","PSOORAL1",131,0)
 . S PSOFIELDS=".01;.02;.03;.04;.05"
"RTN","PSOORAL1",132,0)
 . K PSODATA
"RTN","PSOORAL1",133,0)
 . ;
"RTN","PSOORAL1",134,0)
 . D GETS^DIQ(PSOFILE,I_","_DA,PSOFIELDS,"IE","PSODATA")
"RTN","PSOORAL1",135,0)
 . ;
"RTN","PSOORAL1",136,0)
 . ; If reason is not M (ECME), do not include comment.
"RTN","PSOORAL1",137,0)
 . ;
"RTN","PSOORAL1",138,0)
 . I $G(PSODATA(PSOFILE,PSOIENS,.02,"I"))'="M" Q
"RTN","PSOORAL1",139,0)
 . ;
"RTN","PSOORAL1",140,0)
 . S PSODATE=$G(PSODATA(PSOFILE,PSOIENS,.01,"I"))
"RTN","PSOORAL1",141,0)
 . S PSOUSER1=$G(PSODATA(PSOFILE,PSOIENS,.03,"E"))
"RTN","PSOORAL1",142,0)
 . S PSOREFILL1=$G(PSODATA(PSOFILE,PSOIENS,.04,"E"))
"RTN","PSOORAL1",143,0)
 . S PSOCOMMENT=$G(PSODATA(PSOFILE,PSOIENS,.05,"I"))
"RTN","PSOORAL1",144,0)
 . ;
"RTN","PSOORAL1",145,0)
 . S PSOCNT=$G(PSOAR(PSODATE))+1
"RTN","PSOORAL1",146,0)
 . S PSOAR(PSODATE)=PSOCNT
"RTN","PSOORAL1",147,0)
 . S PSOAR(PSODATE,PSOCNT)=$$FMTE^XLFDT(PSODATE,2)_U_PSOUSER1_U_PSOREFILL1_U_PSOCOMMENT
"RTN","PSOORAL1",148,0)
 . ;
"RTN","PSOORAL1",149,0)
 . ; Node 2 of the ACTIVITY LOG contains any additional comments.
"RTN","PSOORAL1",150,0)
 . ; Loop through OTHER COMMENTS sub-file (file #52.34) to add to PSOAR 
"RTN","PSOORAL1",151,0)
 . ; for reporting.
"RTN","PSOORAL1",152,0)
 . ;
"RTN","PSOORAL1",153,0)
 . I $D(^PSRX(DA,"A",I,2)) D
"RTN","PSOORAL1",154,0)
 . . S PSOCNT1=0
"RTN","PSOORAL1",155,0)
 . . S II=0
"RTN","PSOORAL1",156,0)
 . . F  S II=$O(^PSRX(DA,"A",I,2,II)) Q:'II  D
"RTN","PSOORAL1",157,0)
 . . . S PSOCNT1=PSOCNT1+1
"RTN","PSOORAL1",158,0)
 . . . S PSOAR(PSODATE,PSOCNT,PSOCNT1)=$$GET1^DIQ(52.34,II_","_I_","_DA,.01)
"RTN","PSOORAL1",159,0)
 ;
"RTN","PSOORAL1",160,0)
 ; Loop through REJECT INFO Comments (File #52.2551) searching for
"RTN","PSOORAL1",161,0)
 ; User Created entries.
"RTN","PSOORAL1",162,0)
 ; User Created entries are defined as User'="POSTMASTER"
"RTN","PSOORAL1",163,0)
 ;
"RTN","PSOORAL1",164,0)
 ; REJECT INFO Comments Fields:
"RTN","PSOORAL1",165,0)
 ;  .01  = Date/Time
"RTN","PSOORAL1",166,0)
 ;  1    = User
"RTN","PSOORAL1",167,0)
 ;  2    = Comments
"RTN","PSOORAL1",168,0)
 ;
"RTN","PSOORAL1",169,0)
 ; The above fields will be stored in array PSODATA via a call to ^DIQ.
"RTN","PSOORAL1",170,0)
 ;
"RTN","PSOORAL1",171,0)
 S I=0 F  S I=$O(^PSRX(DA,"REJ",I)) Q:'I  S PSODATE=0 F  S PSODATE=$O(^PSRX(DA,"REJ",I,"COM","B",PSODATE)) Q:'PSODATE  D
"RTN","PSOORAL1",172,0)
 . S III=0 F  S III=$O(^PSRX(DA,"REJ",I,"COM","B",PSODATE,III)) Q:'III  D 
"RTN","PSOORAL1",173,0)
 . . S REC=$G(^PSRX(DA,"REJ",I,"COM",III,0))
"RTN","PSOORAL1",174,0)
 . . S PSOUSER=$P(REC,U,2),PSOUSER1=$P($G(^VA(200,PSOUSER,0)),U,1)
"RTN","PSOORAL1",175,0)
 . . S PSOCOMMENT=$P(REC,U,3)
"RTN","PSOORAL1",176,0)
 . . ;
"RTN","PSOORAL1",177,0)
 . . S PSOREFILL=$$GET1^DIQ(52.25,I_","_DA,5)
"RTN","PSOORAL1",178,0)
 . . I PSOREFILL=0 S PSOREFILL1="ORIGINAL"
"RTN","PSOORAL1",179,0)
 . . E  S PSOREFILL1="REFILL #"_PSOREFILL
"RTN","PSOORAL1",180,0)
 . . ;
"RTN","PSOORAL1",181,0)
 . . S PSOCNT=$G(PSOAR(PSODATE))+1
"RTN","PSOORAL1",182,0)
 . . S PSOAR(PSODATE)=PSOCNT
"RTN","PSOORAL1",183,0)
 . . S PSOAR(PSODATE,PSOCNT)=$$FMTE^XLFDT(PSODATE,2)_U_PSOUSER1_U_PSOREFILL1_U_PSOCOMMENT
"RTN","PSOORAL1",184,0)
 ;
"RTN","PSOORAL1",185,0)
 ; If PSOAR array contains no data, there is No ECME Activity to report. 
"RTN","PSOORAL1",186,0)
 ;
"RTN","PSOORAL1",187,0)
 I '$D(PSOAR) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There's NO ECME Activity to report" Q
"RTN","PSOORAL1",188,0)
 ;
"RTN","PSOORAL1",189,0)
 ; Loop through PSOAR array and assign data to ^TMP array for reporting.
"RTN","PSOORAL1",190,0)
 ; 
"RTN","PSOORAL1",191,0)
 ; PSOLINE = ECME Log Entry line number.
"RTN","PSOORAL1",192,0)
 ;
"RTN","PSOORAL1",193,0)
 S (PSODATE1,PSOREFILL,PSOUSER)=""
"RTN","PSOORAL1",194,0)
 S PSODATE="" F  S PSODATE=$O(PSOAR(PSODATE)) Q:PSODATE=""  D
"RTN","PSOORAL1",195,0)
 . S PSOCNT="" F  S PSOCNT=$O(PSOAR(PSODATE,PSOCNT)) Q:PSOCNT=""  D
"RTN","PSOORAL1",196,0)
 . . S PSODATA=$G(PSOAR(PSODATE,PSOCNT))
"RTN","PSOORAL1",197,0)
 . . ;
"RTN","PSOORAL1",198,0)
 . . S IEN=IEN+1
"RTN","PSOORAL1",199,0)
 . . I '$D(PSOLINE) S PSOLINE=0
"RTN","PSOORAL1",200,0)
 . . S PSOLINE=PSOLINE+1
"RTN","PSOORAL1",201,0)
 . . S PSODATE1=$P(PSODATA,U)
"RTN","PSOORAL1",202,0)
 . . S PSOUSER=$P(PSODATA,U,2)
"RTN","PSOORAL1",203,0)
 . . S PSOREFILL=$P(PSODATA,U,3)
"RTN","PSOORAL1",204,0)
 . . S LINE=PSOLINE
"RTN","PSOORAL1",205,0)
 . . S $E(LINE,5)=PSODATE1
"RTN","PSOORAL1",206,0)
 . . S $E(LINE,25)=PSOREFILL
"RTN","PSOORAL1",207,0)
 . . S $E(LINE,41)=PSOUSER
"RTN","PSOORAL1",208,0)
 . . S ^TMP("PSOAL",$J,IEN,0)=LINE
"RTN","PSOORAL1",209,0)
 . . ;
"RTN","PSOORAL1",210,0)
 . . ; D ^DIWP formats comments into ^UTILITY($J,"W")
"RTN","PSOORAL1",211,0)
 . . ;
"RTN","PSOORAL1",212,0)
 . . S PSOCOMMENT=$P(PSODATA,"^",4)
"RTN","PSOORAL1",213,0)
 . . ;
"RTN","PSOORAL1",214,0)
 . . K ^UTILITY($J,"W")
"RTN","PSOORAL1",215,0)
 . . ;
"RTN","PSOORAL1",216,0)
 . . S X="Comments: "_PSOCOMMENT
"RTN","PSOORAL1",217,0)
 . . S (DIWR,DIWL)=1,DIWF="C80"
"RTN","PSOORAL1",218,0)
 . . D ^DIWP
"RTN","PSOORAL1",219,0)
 . . ;
"RTN","PSOORAL1",220,0)
 . . ; Additional comments (if any)
"RTN","PSOORAL1",221,0)
 . . ;
"RTN","PSOORAL1",222,0)
 . . S PSOCNT1=""
"RTN","PSOORAL1",223,0)
 . . F  S PSOCNT1=$O(PSOAR(PSODATE,PSOCNT,PSOCNT1)) Q:PSOCNT1=""  D
"RTN","PSOORAL1",224,0)
 . . . S X=PSOAR(PSODATE,PSOCNT,PSOCNT1)
"RTN","PSOORAL1",225,0)
 . . . S DIWF="C80I10"
"RTN","PSOORAL1",226,0)
 . . . D ^DIWP
"RTN","PSOORAL1",227,0)
 . . ;
"RTN","PSOORAL1",228,0)
 . . ; Loop through ^UTILITY($J,"W"), adding comments to ^TMP
"RTN","PSOORAL1",229,0)
 . . ;
"RTN","PSOORAL1",230,0)
 . . F I=1:1:^UTILITY($J,"W",1) D 
"RTN","PSOORAL1",231,0)
 . . . S IEN=IEN+1
"RTN","PSOORAL1",232,0)
 . . . S ^TMP("PSOAL",$J,IEN,0)=$G(^UTILITY($J,"W",1,I,0))
"RTN","PSOORAL1",233,0)
 ;
"RTN","PSOORAL1",234,0)
 D DISPREJ
"RTN","PSOORAL1",235,0)
 ;
"RTN","PSOORAL1",236,0)
 K ^UTILITY($J,"W"),DIWR,DIWF,DIWL
"RTN","PSOORAL1",237,0)
 Q
"RTN","PSOORAL1",238,0)
 ;
"RTN","PSOORAL1",239,0)
SPMP ; SPMP (State Prescription Monitoring Program) Log
"RTN","PSOORAL1",240,0)
 N FILL,BAT,LOG,BAT0,LOG0
"RTN","PSOORAL1",241,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" ",IEN=IEN+1
"RTN","PSOORAL1",242,0)
 S ^TMP("PSOAL",$J,IEN,0)="SPMP (State Prescription Monitoring Program) Log:"
"RTN","PSOORAL1",243,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Date/Time       Fill Type   Exp. Type Bat#  Filename"
"RTN","PSOORAL1",244,0)
 S IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",80)="="
"RTN","PSOORAL1",245,0)
 I '$D(^PS(58.42,"ARX",DA)) D  Q
"RTN","PSOORAL1",246,0)
 . S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There's NO Export Log for this prescription."
"RTN","PSOORAL1",247,0)
 S FILL=""
"RTN","PSOORAL1",248,0)
 F  S FILL=$O(^PS(58.42,"ARX",DA,FILL)) Q:FILL=""  D
"RTN","PSOORAL1",249,0)
 . S BAT=0 F  S BAT=$O(^PS(58.42,"ARX",DA,FILL,BAT)) Q:'BAT  D
"RTN","PSOORAL1",250,0)
 . . S LOG=0 F  S LOG=$O(^PS(58.42,"ARX",DA,FILL,BAT,LOG)) Q:'LOG  D
"RTN","PSOORAL1",251,0)
 . . . S BAT0=$G(^PS(58.42,BAT,0)),LOG0=$G(^PS(58.42,BAT,"RX",LOG,0))
"RTN","PSOORAL1",252,0)
 . . . I '$P(BAT0,"^",10) Q
"RTN","PSOORAL1",253,0)
 . . . S IEN=IEN+1,LINE=$$FMTE^XLFDT($P(BAT0,"^",10),2),$E(LINE,17)=$J($P(LOG0,"^",2),4)
"RTN","PSOORAL1",254,0)
 . . . S $E(LINE,22)=$$GET1^DIQ(58.42001,LOG_","_BAT,2),$E(LINE,29)=$$GET1^DIQ(58.42,BAT,2)
"RTN","PSOORAL1",255,0)
 . . . S $E(LINE,39)=BAT,$E(LINE,45)=$E($$GET1^DIQ(58.42,BAT,6),1,35)
"RTN","PSOORAL1",256,0)
 . . . S ^TMP("PSOAL",$J,IEN,0)=LINE
"RTN","PSOORAL1",257,0)
 Q
"RTN","PSOORAL1",258,0)
 ;
"RTN","PSOORAL1",259,0)
DISPREJ  ;
"RTN","PSOORAL1",260,0)
 N LN,SEQ,REJ,PRI,VAR,X,X1,X2,I,RFT
"RTN","PSOORAL1",261,0)
 I '$D(^PSRX(DA,"REJ")) Q
"RTN","PSOORAL1",262,0)
 S PRI="PSOAL",$P(LN,"=",80)="",SEQ=0
"RTN","PSOORAL1",263,0)
 S IEN=$G(IEN)+1,^TMP(PRI,$J,IEN,0)=" "
"RTN","PSOORAL1",264,0)
 S IEN=IEN+1,^TMP(PRI,$J,IEN,0)="ECME REJECT Log:"
"RTN","PSOORAL1",265,0)
 S IEN=IEN+1,^TMP(PRI,$J,IEN,0)="#  Date/Time Rcvd    Rx Ref    Reject Type     STATUS     Date/Time Resolved"
"RTN","PSOORAL1",266,0)
 S IEN=IEN+1,^TMP(PRI,$J,IEN,0)=LN
"RTN","PSOORAL1",267,0)
 F REJ=0:0 S REJ=$O(^PSRX(DA,"REJ",REJ)) Q:'REJ  D
"RTN","PSOORAL1",268,0)
 . S VAR=$G(^PSRX(DA,"REJ",REJ,0))
"RTN","PSOORAL1",269,0)
 . S RFT=+$P(VAR,"^",4)
"RTN","PSOORAL1",270,0)
 . S SEQ=SEQ+1,X=SEQ,$E(X,4)=$$FMTE^XLFDT($P(VAR,"^",2),2),$E(X,22)=$S(RFT:"REFILL "_RFT,1:"ORIGINAL")
"RTN","PSOORAL1",271,0)
 . S $E(X,32)=$S(+VAR=79:"REFILL TOO SOON",+VAR=88:"DUR",1:$E($$EXP^PSOREJP1($P(VAR,"^",1)),1,15))  ;can't + default because values can be 07, 08, etc.
"RTN","PSOORAL1",272,0)
 . S $E(X,48)=$S($P(VAR,"^",5):"RESOLVED",1:"UNRESOLVED")
"RTN","PSOORAL1",273,0)
 . S:$P(VAR,"^",6) $E(X,59)=$$FMTE^XLFDT($P(VAR,"^",6),2)
"RTN","PSOORAL1",274,0)
 . S IEN=IEN+1,^TMP(PRI,$J,IEN,0)=X
"RTN","PSOORAL1",275,0)
 . I $P(VAR,"^",5) D
"RTN","PSOORAL1",276,0)
 . . S IEN=IEN+1,X=$$GET1^DIQ(52.25,REJ_","_DA,12)
"RTN","PSOORAL1",277,0)
 . . S X1=$$GET1^DIQ(52.25,REJ_","_DA,13) S:X1'="" X=X1_" ("_X_")"
"RTN","PSOORAL1",278,0)
 . . F I=1:1 Q:X=""  D
"RTN","PSOORAL1",279,0)
 . . . S ^TMP(PRI,$J,IEN,0)=$S(I=1:"Comments: ",1:"          ")_$E(X,1,69)
"RTN","PSOORAL1",280,0)
 . . . S X=$E(X,70,999) S:X'="" IEN=IEN+1
"RTN","PSOORAL1",281,0)
 Q
"RTN","PSOORAL1",282,0)
 ;
"RTN","PSOORAL1",283,0)
ERX ; eRx Log
"RTN","PSOORAL1",284,0)
 N CNT,ARR,G,STR,X,I,TMP
"RTN","PSOORAL1",285,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" "
"RTN","PSOORAL1",286,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="eRx Activity Log:"
"RTN","PSOORAL1",287,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#   Date        Reason         Rx Ref         Initiator Of Activity"
"RTN","PSOORAL1",288,0)
 S IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",80)="="
"RTN","PSOORAL1",289,0)
 S IEN=IEN+1
"RTN","PSOORAL1",290,0)
 I '$O(^PSRX(DA,"A",0)) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There are no eRx activity logs." Q
"RTN","PSOORAL1",291,0)
 S CNT=0
"RTN","PSOORAL1",292,0)
 D GETS^DIQ(52,DA_",","**","IE","ARR")
"RTN","PSOORAL1",293,0)
 M TMP=ARR(52.3) K ARR
"RTN","PSOORAL1",294,0)
 S N="",G=$NA(TMP) F  S N=$O(@G@(N)) Q:N=""  D
"RTN","PSOORAL1",295,0)
 . I @G@(N,.02,"I")="O" D
"RTN","PSOORAL1",296,0)
 . . S CNT=CNT+1
"RTN","PSOORAL1",297,0)
 . . S P1=@G@(N,.01,"I"),DTT=P1\1 D DAT
"RTN","PSOORAL1",298,0)
 . . S STR=CNT,$E(STR,5)=DAT,$E(STR,17)=@G@(N,.02,"E"),$E(STR,32)=@G@(N,.04,"E"),$E(STR,47)=@G@(N,.03,"E"),^TMP("PSOAL",$J,IEN,0)=STR,IEN=IEN+1
"RTN","PSOORAL1",299,0)
 . . K ^UTILITY($J,"W") S X="Comments: "_@G@(N,.05,"E"),(DIWR,DIWL)=1,DIWF="C80" D ^DIWP F I=1:1:^UTILITY($J,"W",1) S ^TMP("PSOAL",$J,IEN,0)=$G(^UTILITY($J,"W",1,I,0)),IEN=IEN+1
"RTN","PSOORAL1",300,0)
 . . ;S ^TMP("PSOAL",$J,IEN,0)="Comments: "_@G@(N,.05,"E"),IEN=IEN+1
"RTN","PSOORAL1",301,0)
 K ^UTILITY($J,"W"),DIWF,DIWL,DIWR
"RTN","PSOORAL1",302,0)
 Q
"RTN","PSOORAL1",303,0)
 ;
"RTN","PSOORAL1",304,0)
DAT S DAT="",DTT=DTT\1 Q:DTT'?7N  S DAT=$E(DTT,4,5)_"/"_$E(DTT,6,7)_"/"_$E(DTT,2,3)
"RTN","PSOORAL1",305,0)
 Q
"RTN","PSOORFIN")
0^34^B72090334^B72047260
"RTN","PSOORFIN",1,0)
PSOORFIN ;BIR/SAB-finish cprs orders ;8/27/08 4:57pm
"RTN","PSOORFIN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**7,15,27,32,44,46,84,106,111,117,131,146,139,195,225,315,266,338,391,372,416,446,505,508**;DEC 1997;Build 295
"RTN","PSOORFIN",3,0)
 ;PSSLOCK-2789,PSDRUG-221,50.7-2223,55-2228,50.606-2174
"RTN","PSOORFIN",4,0)
 ;PSO*7*266 Change order of calling ^PSOBING1 and ^PSORXL
"RTN","PSOORFIN",5,0)
 ;
"RTN","PSOORFIN",6,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) D MSG^PSODPT G EX
"RTN","PSOORFIN",7,0)
 D INST^PSOORFI2 I $G(PSOIQUIT) K PSOIQUIT G EX
"RTN","PSOORFIN",8,0)
 I $P($G(PSOPAR),"^",2),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("VERIFY")=1
"RTN","PSOORFIN",9,0)
 S (PSOFIN,POERR)=1
"RTN","PSOORFIN",10,0)
 K PSOBCK,MEDA,MEDP,SRT,DIR D KQ
"RTN","PSOORFIN",11,0)
 S DIR("?")="^D ST^PSOORFI1",DIR("A")="Select By",DIR("B")="PATIENT"
"RTN","PSOORFIN",12,0)
 S DIR(0)="SMB^PA:PATIENT;RT:ROUTE;PR:PRIORITY;CL:CLINIC;FL:FLAGGED;CS:CONTROLLED SUBSTANCES;SU:SUPPLY;E:EXIT"
"RTN","PSOORFIN",13,0)
 D ^DIR I $D(DIRUT)!(Y="E") G EX
"RTN","PSOORFIN",14,0)
 K:Y="FL" ^TMP($J,"PSOFLPO") ;file not needed when selection="FL"
"RTN","PSOORFIN",15,0)
 G:Y="PA" PAT G:Y="PR" PRI^PSOORFI5 G:Y="CL" ^PSOORFI3 G:Y="FL" FLG^PSOORFI5 G:Y="CS" CS^PSOORFI5 G:Y="SU" SUP^PSOORFI5
"RTN","PSOORFIN",16,0)
 K DIR S PSOSORT="ROUTE"
"RTN","PSOORFIN",17,0)
 S DIR("?")="^D RT^PSOORFI1",DIR("A")="Route",DIR(0)="SBM^W:WINDOW;M:MAIL;C:CLINIC;E:EXIT",DIR("B")="WINDOW"
"RTN","PSOORFIN",18,0)
 D ^DIR G:$D(DIRUT)!(Y="E") EX S PSOSORT=PSOSORT_"^"_Y,PSRT=Y
"RTN","PSOORFIN",19,0)
 N SECSORT S SECSORT=$$DIR^PSOORFI6("RT:ROUTE",Y) Q:SECSORT=U
"RTN","PSOORFIN",20,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFIN",21,0)
 .Q:$P($G(^PS(52.41,PSOD,0)),"^",23)
"RTN","PSOORFIN",22,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFIN",23,0)
 .;PSO*7*266
"RTN","PSOORFIN",24,0)
 .I PAT'=PATA D LBL
"RTN","PSOORFIN",25,0)
 .I '$O(^PS(52.41,"AC",PAT,PSRT,0)) S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFIN",26,0)
 .D RTE^PSOORFI2 I $G(PSZFIN) S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFIN",27,0)
 .;PSO*7*505
"RTN","PSOORFIN",28,0)
 .I SECSORT'=0,'$$CHKFLTR^PSOORFI6(PSOD,SECSORT) Q
"RTN","PSOORFIN",29,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFIN",30,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP Q
"RTN","PSOORFIN",31,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFIN",32,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFIN",33,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFIN",34,0)
 .D PP S ORD=0 D @PSRT S PAT(PAT)=PAT
"RTN","PSOORFIN",35,0)
 .S X=PAT D ULP
"RTN","PSOORFIN",36,0)
 ;PSO*7*266
"RTN","PSOORFIN",37,0)
 K POERR("QFLG"),PSOQFLG,PSOPTPST,MAIL,WIN,CLI D LBL
"RTN","PSOORFIN",38,0)
 I $G(PSOQUIT) K PSOQUIT D EX G PSOORFIN
"RTN","PSOORFIN",39,0)
EX D EX^PSOORFI1
"RTN","PSOORFIN",40,0)
 Q
"RTN","PSOORFIN",41,0)
W D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"W",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD S MAIL=1
"RTN","PSOORFIN",42,0)
 Q:$G(POERR("QFLG"))  I $G(MAIL) S ORD=0 D
"RTN","PSOORFIN",43,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"M",ORD)) Q:'ORD!($G(POERR("QFLG")))  D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") LK1,ORD
"RTN","PSOORFIN",44,0)
 .Q:$G(POERR("QFLG"))
"RTN","PSOORFIN",45,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"C",ORD)) Q:'ORD!($G(POERR("QFLG")))  D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") LK1,ORD
"RTN","PSOORFIN",46,0)
 Q
"RTN","PSOORFIN",47,0)
M D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"M",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD S WIN=1
"RTN","PSOORFIN",48,0)
 Q:$G(POERR("QFLG"))  I $G(WIN) S ORD=0 D
"RTN","PSOORFIN",49,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"W",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD
"RTN","PSOORFIN",50,0)
 .Q:$G(POERR("QFLG"))
"RTN","PSOORFIN",51,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"C",ORD)) Q:'ORD!($G(POERR("QFLG")))  D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") LK1,ORD
"RTN","PSOORFIN",52,0)
 Q
"RTN","PSOORFIN",53,0)
C D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"C",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD S CLI=1
"RTN","PSOORFIN",54,0)
 Q:$G(POERR("QFLG"))  I $G(CLI) S ORD=0 D
"RTN","PSOORFIN",55,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"M",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD
"RTN","PSOORFIN",56,0)
 .Q:$G(POERR("QFLG"))
"RTN","PSOORFIN",57,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"W",ORD)) Q:'ORD!($G(POERR("QFLG")))  D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") LK1,ORD
"RTN","PSOORFIN",58,0)
 Q
"RTN","PSOORFIN",59,0)
PAT W ! K MEDP,MEDA,POERR("DFLG"),DIR D KQ S PSOSORT="PATIENT"
"RTN","PSOORFIN",60,0)
 S DIR("?")="^D PT^PSOORFI1",DIR("A")="All Patients or Single Patient",DIR(0)="SBM^A:ALL;S:SINGLE;E:EXIT",DIR("B")="SINGLE"
"RTN","PSOORFIN",61,0)
 D ^DIR K DIR G:$D(DIRUT)!(Y="E") EX I Y="S" S PSOSORT=PSOSORT_"^"_"SINGLE" G SPAT
"RTN","PSOORFIN",62,0)
 S PSOSORT=PSOSORT_"^ALL"
"RTN","PSOORFIN",63,0)
 N SECSORT S SECSORT=$$DIR^PSOORFI6("PA:PATIENT",Y) Q:SECSORT=U
"RTN","PSOORFIN",64,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFIN",65,0)
 .Q:'$D(^PS(52.41,PSOD,0))!($P($G(^PS(52.41,PSOD,0)),"^",23))
"RTN","PSOORFIN",66,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFIN",67,0)
 .;PSO*7*505 - secondary sort filter
"RTN","PSOORFIN",68,0)
 .I SECSORT'=0,'$$CHKFLTR^PSOORFI6(PSOD,SECSORT) Q
"RTN","PSOORFIN",69,0)
 .;PSO*7*266
"RTN","PSOORFIN",70,0)
 .I PAT'=PATA D LBL
"RTN","PSOORFIN",71,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFIN",72,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG,PSOQQ Q
"RTN","PSOORFIN",73,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFIN",74,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFIN",75,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFIN",76,0)
 .S PAT(PAT)=PAT
"RTN","PSOORFIN",77,0)
 .F ORD=0:0 S ORD=$O(^PS(52.41,"AOR",PAT,PSOPINST,ORD)) Q:'ORD!($G(POERR("QFLG")))!($G(PSOQQ))  D
"RTN","PSOORFIN",78,0)
 ..I SECSORT'=0,'$$CHKFLTR^PSOORFI6(ORD,SECSORT) Q
"RTN","PSOORFIN",79,0)
 ..I '$P($G(^PS(52.41,ORD,0)),"^",23) D PP,LK1,ORD
"RTN","PSOORFIN",80,0)
 .S X=PAT D ULP K PSOQQ
"RTN","PSOORFIN",81,0)
 I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL
"RTN","PSOORFIN",82,0)
 I $G(PSOQUIT) K PSOQUIT D EX G PSOORFIN
"RTN","PSOORFIN",83,0)
 G EX
"RTN","PSOORFIN",84,0)
 ;PSO*7*266 kill BINGCRT,BINGRTE when selecting pat.
"RTN","PSOORFIN",85,0)
SPAT K MEDA,MEDP,PSOQFLG,PSORX("FN"),BINGCRT,BINGRTE D KQ,KV^PSOVER1
"RTN","PSOORFIN",86,0)
 S DIR(0)="FO^2:30",DIR("A")="Select Patient",DIR("?")="^D HELP^PSOORFI2" D ^DIR I $E(X)="?" G SPAT
"RTN","PSOORFIN",87,0)
 G:$D(DIRUT) EX D KV^PSOVER1
"RTN","PSOORFIN",88,0)
 S DIC(0)="EQM",DIC=2,DIC("S")="I $D(^PS(52.41,""AOR"",+Y,PSOPINST))"
"RTN","PSOORFIN",89,0)
 D ^DIC K DIC G:"^"[X EX G:Y=-1 SPAT S (PSODFN,PAT)=+Y,PSOFINY=Y
"RTN","PSOORFIN",90,0)
SPAT2 D LK I $G(POERR("QFLG")) G SPAT
"RTN","PSOORFIN",91,0)
 N SNGLPAT S SNGLPAT=1
"RTN","PSOORFIN",92,0)
 ; PSO*7*505 - SECONDARY SORT
"RTN","PSOORFIN",93,0)
 N SECSORT S SECSORT=$$DIR^PSOORFI6("PA:PATIENT",PSODFN) I SECSORT'=0,$P(SECSORT,U,1)="CS" N PSRT S PSRT=$P(SECSORT,U,3)
"RTN","PSOORFIN",94,0)
 Q:SECSORT=U
"RTN","PSOORFIN",95,0)
 ; PSO*7*505 - END
"RTN","PSOORFIN",96,0)
 ;PSO*7*266
"RTN","PSOORFIN",97,0)
 D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSOFINY I $G(MEDP) D SPL D OERR^PSORX1 D LBL S PSOFIN=1,X=PSOPTLOK D KLLP,ULP,KLL G SPAT
"RTN","PSOORFIN",98,0)
 D PP,SDFN,POST^PSOORFI1 D:$G(PSOQFLG)  G:$G(PSOQFLG) EX I $G(PSOQUIT) S:$G(PSOQUIT) POERR("QFLG")=1 S X=PAT D ULP G SPAT
"RTN","PSOORFIN",99,0)
 .S X=PAT D ULP
"RTN","PSOORFIN",100,0)
 S ORD=0 F  S ORD=$O(^PS(52.41,"P",PAT,ORD)) Q:'ORD!($G(POERR("QFLG")))  D:'$P($G(^PS(52.41,ORD,0)),"^",23)
"RTN","PSOORFIN",101,0)
 .;PSO*7*505 - SECONDARY SORT
"RTN","PSOORFIN",102,0)
 .I SECSORT'=0,'$$CHKFLTR^PSOORFI6(ORD,SECSORT) Q
"RTN","PSOORFIN",103,0)
 .;PSO*7*505 - END
"RTN","PSOORFIN",104,0)
 .D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE")&($P(^(0),"^",3)'="HD") LK1,ORD
"RTN","PSOORFIN",105,0)
 ;PSO*7*266
"RTN","PSOORFIN",106,0)
 D LBL
"RTN","PSOORFIN",107,0)
 S PSOFIN=1,X=PAT D ULP G SPAT
"RTN","PSOORFIN",108,0)
ORD I $G(PSOBCK) N LST,ORN
"RTN","PSOORFIN",109,0)
 E  S PSOLOUD=1 D:$P($G(^PS(55,PAT,0)),"^",6)'=2 EN^PSOHLUP(PAT) K PSOLOUD
"RTN","PSOORFIN",110,0)
 K DRET,SIG,^TMP("PSORXDC",$J) Q:'$D(^PS(52.41,ORD,0))
"RTN","PSOORFIN",111,0)
 I $G(PSOFIN),$P($G(^PS(52.41,ORD,"INI")),"^")'=$G(PSOPINST) Q
"RTN","PSOORFIN",112,0)
 D L1^PSOORFI3 I '$G(PSOMSG) K PSOMSG Q
"RTN","PSOORFIN",113,0)
 I '$D(^PS(52.41,ORD,0)) K PSOMSG Q
"RTN","PSOORFIN",114,0)
 K DRET,SIG,PSOPRC,PHI,PRC,PSOSIGFL,OBX,PSOMSG,PSOFOERR S OR0=^PS(52.41,ORD,0)
"RTN","PSOORFIN",115,0)
 I $P(OR0,"^",24),($P(OR0,"^",3)="RNW"!($P(OR0,"^",3)="NW")) N PKI,PKI1,PKIR,PKIE,PKID S PKI=0 D CER^PSOPKIV1 I PKI<1 D UL1^PSOORFI3 K OR0 Q
"RTN","PSOORFIN",116,0)
 S (PSOFOERR,PSOFDR)=1,OI=$P(OR0,"^",8),PSORX("SC")=$P(OR0,"^",16)
"RTN","PSOORFIN",117,0)
 I $O(^PS(52.41,ORD,2,0)) S PHI=^PS(52.41,ORD,2,0),T=0 F  S T=$O(^PS(52.41,ORD,2,T)) Q:'T  S PHI(T)=^PS(52.41,ORD,2,T,0)
"RTN","PSOORFIN",118,0)
 I $P($G(^PS(52.41,ORD,"EXT")),"^")'="" K PHI I $O(^PS(52.41,ORD,"SIG",0)) S PHI=$G(^PS(52.41,ORD,"SIG",0)),T=0 F  S T=$O(^PS(52.41,ORD,"SIG",T)) Q:'T  S PHI(T)=$G(^PS(52.41,ORD,"SIG",T,0))
"RTN","PSOORFIN",119,0)
 I $O(^PS(52.41,ORD,3,0)) S PRC=^PS(52.41,ORD,3,0),T=0 F  S T=$O(^PS(52.41,ORD,3,T)) Q:'T  S PRC(T)=^PS(52.41,ORD,3,T,0)
"RTN","PSOORFIN",120,0)
 I $P(OR0,"^",3)="RNW",$D(^PSRX(+$P(OR0,"^",21),0)) D  G SUCC ;process renews
"RTN","PSOORFIN",121,0)
 .K PSOREEDT S (PSOORRNW,PSOFDR)=1,PSORENW("OIRXN")=$P(OR0,"^",21),PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"))=0 D ^PSOORRNW,SQR
"RTN","PSOORFIN",122,0)
 I $P(OR0,"^",3)="RF",$D(^PSRX(+$P(OR0,"^",19),0)) D RF^PSOORFI2 G SUCC
"RTN","PSOORFIN",123,0)
 N PSODRUG,PSONEW S PSOFROM="PENDING" D:'$G(PSOTPBFG) DSPL^PSOTPCAN(ORD) D DSPL^PSOORFI1,SQN^PSOORFI3
"RTN","PSOORFIN",124,0)
SUCC ;
"RTN","PSOORFIN",125,0)
 D UL1^PSOORFI3,FULL^VALM1
"RTN","PSOORFIN",126,0)
 D:$P($G(^PS(52.41,+$G(ORD),0)),"^",3)'="NW"&($P($G(^(0)),"^",3)'="RNW")&($P($G(^(0)),"^",3)'="HD")&($P($G(^(0)),"^",3)'="RF")
"RTN","PSOORFIN",127,0)
 .K PSOSD("PENDING",$S('$G(OID):$P(^PS(50.7,$P(OR0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(OR0,"^",8),0),"^",2),0),"^"),1:$P(^PSDRUG($P(OR0,"^",9),0),"^")))
"RTN","PSOORFIN",128,0)
 S:$G(POERR("DFLG")) POERR("QFLG")=1 K POERR("DFLG"),PSONEW,ACP,OR0,DRET,SIG,OID,OI
"RTN","PSOORFIN",129,0)
 K PSORX("SC"),PSORX("CLINIC"),PSORX("PROVIDER NAME"),PSODRUG,PSOFOERR
"RTN","PSOORFIN",130,0)
 Q
"RTN","PSOORFIN",131,0)
 ;PSO*7*266 change order of bingo checks.
"RTN","PSOORFIN",132,0)
LBL I $O(PSORX("PSOL",0))!($D(RXRS)) S PSOFROM="NEW" D ^PSORXL K PSORX("PSOL"),PPL,RXRS
"RTN","PSOORFIN",133,0)
 D:$D(BINGCRT)&($D(BINGRTE)&($D(DISGROUP))) ^PSOBING1 K BINGCRT,BINGRTE,PSONEW,BBFLG,BBRX,PSORX("DOSING OFF"),PSOONOFC
"RTN","PSOORFIN",134,0)
 Q
"RTN","PSOORFIN",135,0)
CHK ;
"RTN","PSOORFIN",136,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) W !,$C(7),"Outpatient Division MUST be selected!",! G EX
"RTN","PSOORFIN",137,0)
 D INST1^PSOORFI2
"RTN","PSOORFIN",138,0)
 S PSZCNT=0 F PSZZI=0:0 S PSZZI=$O(^PS(59,PSZZI)) Q:'PSZZI  S PSZCNT=PSZCNT+1
"RTN","PSOORFIN",139,0)
 S TC=0 F TO=0:0 S TO=$O(^PS(52.41,"AOR",TO)) Q:'TO  F TZ=0:0 S TZ=$O(^PS(52.41,"AOR",TO,TZ)) Q:'TZ  F PSTZ=0:0 S PSTZ=$O(^PS(52.41,"AOR",TO,TZ,PSTZ)) Q:'PSTZ  S TC=TC+1
"RTN","PSOORFIN",140,0)
 W !!?10,$C(7),"Orders to be completed"_$S(PSZCNT=1:": ",1:" for all divisions: ")_TC,! Q:'TC
"RTN","PSOORFIN",141,0)
 D SUMM^PSOORNE1 K PSZZI,PSZCNT,PSTZ
"RTN","PSOORFIN",142,0)
 Q
"RTN","PSOORFIN",143,0)
 ;
"RTN","PSOORFIN",144,0)
LK D LOCK^PSOORFI1
"RTN","PSOORFIN",145,0)
 Q
"RTN","PSOORFIN",146,0)
LK1 D LOCK1^PSOORFI1 Q
"RTN","PSOORFIN",147,0)
QU I $G(PSOQUIT) S POERR("QFLG")=1 K PSOQUIT
"RTN","PSOORFIN",148,0)
 S:$G(PSOQFLG) PAT(PAT)=PAT
"RTN","PSOORFIN",149,0)
 Q
"RTN","PSOORFIN",150,0)
ULP K PSORX("MAIL/WINDOW"),PSORX("METHOD OF PICK-UP")
"RTN","PSOORFIN",151,0)
 D CLEAN^PSOVER1
"RTN","PSOORFIN",152,0)
 I '$G(X) Q
"RTN","PSOORFIN",153,0)
 D UL^PSSLOCK(X) Q
"RTN","PSOORFIN",154,0)
KLL K PSOPTLOK Q
"RTN","PSOORFIN",155,0)
KLLP K PSONOLCK Q
"RTN","PSOORFIN",156,0)
SPL D SPL^PSOORFI4 Q
"RTN","PSOORFIN",157,0)
SDFN S PSODFN=+$G(PSODFN) Q
"RTN","PSOORFIN",158,0)
PP D PP^PSOORFI4 Q
"RTN","PSOORFIN",159,0)
KQ K PSOQUIT,POERR("QFLG") Q
"RTN","PSOORFIN",160,0)
SQR ;
"RTN","PSOORFIN",161,0)
 K PSOORRNW,PSOOPT,PSOREEDT,PSOQUIT,VALMSG S POERR("DFLG")=0
"RTN","PSOORFIN",162,0)
 Q
"RTN","PSOORNE6")
0^28^B56294478^B50434819
"RTN","PSOORNE6",1,0)
PSOORNE6 ;ISC-BHAM/SAB-display  orders from backdoor ;5/23/05 2:08pm
"RTN","PSOORNE6",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,103,117,156,210,488,505,508**;DEC 1997;Build 295
"RTN","PSOORNE6",3,0)
 ;External reference to MAIN^TIUEDIT is supported by DBIA 2410
"RTN","PSOORNE6",4,0)
 ;PSO*210 add call to WORDWRAP api
"RTN","PSOORNE6",5,0)
 ;
"RTN","PSOORNE6",6,0)
SIG ;called from psoorne3
"RTN","PSOORNE6",7,0)
 I $G(PSOSIGFL)!$G(PSOCOPY)!($O(SIG(0))) G DOSE
"RTN","PSOORNE6",8,0)
 I '$P(^PSRX(PSORXED("IRXN"),"SIG"),"^",2) D  Q
"RTN","PSOORNE6",9,0)
 .S X=$P(^PSRX(PSORXED("IRXN"),"SIG"),"^") D SIGONE^PSOHELP S SIG=$E($G(INS1),2,250)
"RTN","PSOORNE6",10,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNE6",11,0)
 F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S MIG=$P(^PSRX(PSORXED("IRXN"),"SIG1",I,0),"^") D
"RTN","PSOORNE6",12,0)
 .S SIG(I)=MIG
"RTN","PSOORNE6",13,0)
 .F SG=1:1:$L(MIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " S:$P(MIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORNE6",14,0)
 .S SIGOK=1 K MIG,SG
"RTN","PSOORNE6",15,0)
 Q
"RTN","PSOORNE6",16,0)
DOSE ;displays new SIG with dosing
"RTN","PSOORNE6",17,0)
 F I=0:0 S I=$O(SIG(I)) Q:'$D(SIG(+I))  D
"RTN","PSOORNE6",18,0)
 .F SG=1:1:$L(SIG(I)) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG(I)," ",SG))>75 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " S:$P(SIG(I)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG(I)," ",SG)
"RTN","PSOORNE6",19,0)
 S SIGOK=1 K MIG,I
"RTN","PSOORNE6",20,0)
 Q
"RTN","PSOORNE6",21,0)
K1 ;
"RTN","PSOORNE6",22,0)
 K DRET,SIG,RTE,PRC,PHI,PSONOOR,PSOFDR,PSORXED,REF,DIR,DUOUT,DIRUT,SIGOK
"RTN","PSOORNE6",23,0)
 Q
"RTN","PSOORNE6",24,0)
K2 ;
"RTN","PSOORNE6",25,0)
 K SIG,DRET,RTE,PRC,PHI,DIR,DIRUT,DTOUT,PSOOELSE,DUOUT,PSOFDR,SIGOK,PSORXED,REF,INS1
"RTN","PSOORNE6",26,0)
 Q
"RTN","PSOORNE6",27,0)
K3 ;
"RTN","PSOORNE6",28,0)
 K PSLST,ORD,IEN,ORN,RPH,ST,REFL,REF,PSOACT,ORSV,CC,CRIT,CT,DAYS,DDER,DEA,DSMSG,HDR,PSOAC,PSOFLAG,RFCNT
"RTN","PSOORNE6",29,0)
 K UPMI,RIFN,RX,RXDA,RXOR,RXREF,SEG1,SER,STA,PSOFDR,SIGOK,INCOM,PSONOOR,ACTREF,ACTREN,INS1,RX0,RX2,RX3
"RTN","PSOORNE6",30,0)
 Q
"RTN","PSOORNE6",31,0)
ACP1 ;
"RTN","PSOORNE6",32,0)
 K REA,DA,MSG S REA="C",DA=PSONEW("OIRXN") S MSG="Renewed"_$S($G(PSOFDR):" from CPRS",1:"")
"RTN","PSOORNE6",33,0)
 ; PSO*7*508 added line to adjust MSG for renewal activity.
"RTN","PSOORNE6",34,0)
 N ERXIEN S ERXIEN=$$CHKERX^PSOERXU1($P($G(OR0),U)) I ERXIEN S MSG="Renewed by external provider (eRx)"
"RTN","PSOORNE6",35,0)
 S PSCAN(PSONEW("ORX #"))=DA_"^C" D CAN^PSOCAN,DCORD^PSONEW2 K REA,DA,MSG,PSCAN,RXXN
"RTN","PSOORNE6",36,0)
 S RXXN=$O(^TMP("PSORXN",$J,0)) I RXXN D
"RTN","PSOORNE6",37,0)
 .S RXN1=^TMP("PSORXN",$J,RXXN) D EN^PSOHLSN1(RXXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSOORNE6",38,0)
 .I $P(^PSRX(RXXN,"STA"),"^")=5 D EN^PSOHLSN1(RXXN,"SC","ZS",$P(RXN1,"^",4))
"RTN","PSOORNE6",39,0)
 .; PSO*7*508 - erx enhancement
"RTN","PSOORNE6",40,0)
 .N ERXFDA,ERXREQ
"RTN","PSOORNE6",41,0)
 .I ERXIEN D
"RTN","PSOORNE6",42,0)
 ..S ERXFDA(52.49,ERXIEN_",",.13)=RXXN D FILE^DIE(,"ERXFDA") K ERXFDA
"RTN","PSOORNE6",43,0)
 ..S ERXREQ=$$GETREQ^PSOERXU2(ERXIEN) I ERXREQ D UPDSTAT^PSOERXU1(ERXREQ,"RRC")
"RTN","PSOORNE6",44,0)
 ..D UPDSTAT^PSOERXU1(ERXIEN,"RXC")
"RTN","PSOORNE6",45,0)
 ..; Validates if the order is an eRx and Log Activity in AL eRx
"RTN","PSOORNE6",46,0)
 ..;D RXACT^PSOBPSU2(ERXIEN,0,"Renewed by external provider (eRx)","O")
"RTN","PSOORNE6",47,0)
 I $G(PSONOTE) D FULL^VALM1,MAIN^TIUEDIT(3,.TIUDA,PSODFN,"","","","",1) K PSONOTE
"RTN","PSOORNE6",48,0)
 K VERB,RTE,DRET,RXXN,RXN1,^TMP("PSORXN",$J)
"RTN","PSOORNE6",49,0)
 S BBRN="",BBRN1=$O(^PSRX("B",PSONEW("NRX #"),BBRN)) I $P($G(^PSRX(BBRN1,0)),"^",11)["W" S BINGCRT="Y",BINGRTE="W"
"RTN","PSOORNE6",50,0)
 Q
"RTN","PSOORNE6",51,0)
INST ;formats instruction from front door
"RTN","PSOORNE6",52,0)
 I $O(^PSRX(RXN,"PI",0)) S PHI=^PSRX(RXN,"PI",0),T=0 D
"RTN","PSOORNE6",53,0)
 .F  S T=$O(^PSRX(RXN,"PI",T)) Q:'T  S PHI(T)=^PSRX(RXN,"PI",T,0)
"RTN","PSOORNE6",54,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="        Instructions:"
"RTN","PSOORNE6",55,0)
 .S T=0 F  S T=$O(^PSRX(RXN,"PI",T)) Q:'T  D                  ;PSO*210
"RTN","PSOORNE6",56,0)
 .. S MIG=^PSRX(RXN,"PI",T,0)
"RTN","PSOORNE6",57,0)
 .. D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAO",$J)),21)
"RTN","PSOORNE6",58,0)
 K T,TY,MIG,SG
"RTN","PSOORNE6",59,0)
 Q
"RTN","PSOORNE6",60,0)
PC ;displays provider comments
"RTN","PSOORNE6",61,0)
 I $O(^PSRX(RXN,"PRC",0)) S PRC=^PSRX(RXN,"PRC",0),T=0 D
"RTN","PSOORNE6",62,0)
 .F  S T=$O(^PSRX(RXN,"PRC",T)) Q:'T  S PRC(T)=^PSRX(RXN,"PRC",T,0)
"RTN","PSOORNE6",63,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="   Provider Comments:"
"RTN","PSOORNE6",64,0)
 .S T=0 F  S T=$O(^PSRX(RXN,"PRC",T)) Q:'T  D                 ;PSO*210
"RTN","PSOORNE6",65,0)
 .. S MIG=^PSRX(RXN,"PRC",T,0)
"RTN","PSOORNE6",66,0)
 .. D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAO",$J)),21)
"RTN","PSOORNE6",67,0)
 K T,TY,MIG,SG
"RTN","PSOORNE6",68,0)
 Q
"RTN","PSOORNE6",69,0)
INST1 ;formats instruction from front door
"RTN","PSOORNE6",70,0)
 I $O(^PSRX(RXN,"PI",0)) S PHI=^PSRX(RXN,"PI",0),T=0 D
"RTN","PSOORNE6",71,0)
 .F  S T=$O(^PSRX(RXN,"PI",T)) Q:'T  S PHI(T)=^PSRX(RXN,"PI",T,0)
"RTN","PSOORNE6",72,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="        Instructions:"
"RTN","PSOORNE6",73,0)
 .S T=0 F  S T=$O(^PSRX(RXN,"PI",T)) Q:'T  D                  ;PSO*210
"RTN","PSOORNE6",74,0)
 .. S MIG=^PSRX(RXN,"PI",T,0)
"RTN","PSOORNE6",75,0)
 .. D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOPO",$J)),21)
"RTN","PSOORNE6",76,0)
 K T,TY,MIG,SG
"RTN","PSOORNE6",77,0)
 Q
"RTN","PSOORNE6",78,0)
PC1 ;displays provider comments
"RTN","PSOORNE6",79,0)
 I $O(^PSRX(RXN,"PRC",0)) S PRC=^PSRX(RXN,"PRC",0),T=0 D
"RTN","PSOORNE6",80,0)
 .F  S T=$O(^PSRX(RXN,"PRC",T)) Q:'T  S PRC(T)=^PSRX(RXN,"PRC",T,0)
"RTN","PSOORNE6",81,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Provider Comments:"
"RTN","PSOORNE6",82,0)
 .S T=0 F  S T=$O(^PSRX(RXN,"PRC",T)) Q:'T  D                 ;PSO*210
"RTN","PSOORNE6",83,0)
 .. S MIG=^PSRX(RXN,"PRC",T,0)
"RTN","PSOORNE6",84,0)
 .. D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOPO",$J)),21)
"RTN","PSOORNE6",85,0)
 K T,TY,MIG,SG
"RTN","PSOORNE6",86,0)
 Q
"RTN","PSOORNE6",87,0)
ORCHK ;
"RTN","PSOORNE6",88,0)
 S (PSONEW("QFLG"),PSONEW("DFLG"))=0
"RTN","PSOORNE6",89,0)
 D FULL^VALM1 W !
"RTN","PSOORNE6",90,0)
 I $G(PSODRUG("NAME"))']""  D  S:$D(DIRUT)!($G(PSODRUG("NAME"))']"") ACP=0 Q:$G(PSOQFLG)!($D(DIRUT))
"RTN","PSOORNE6",91,0)
 .W !,"DRUG NAME REQUIRED" D 2^PSOORNW1,FULL^VALM1 I $G(PSODRUG("NAME"))']"" S VALMSG="No Dispense Drug selected."
"RTN","PSOORNE6",92,0)
 S PSOMIS=$S($G(PSONEW("DOSE",1))']"":1,$G(PSONEW("SCHEDULE",1))']"":2,1:0)
"RTN","PSOORNE6",93,0)
 D:PSOMIS  I PSODIR("DFLG")=1 S (PSONEW("QFLG"),POERR("DFLG"))=1 Q
"RTN","PSOORNE6",94,0)
 .W !!,"Incomplete Dosaging Instructions - "_$S(PSOMIS=2:"Schedule",1:"Dosage")_".",! S FDORC=1 D DOSE^PSOORED4(.PSONEW) K FDORC
"RTN","PSOORNE6",95,0)
 .I $G(PSONEW("DOSE",1))']""!($G(PSONEW("SCHEDULE",1))']"") S PSODIR("DFLG")=1 Q
"RTN","PSOORNE6",96,0)
 .D EN^PSOFSIG(.PSONEW) I PSONEW("ENT")>0,$O(SIG(0)) S (SIGOK,NEWDOSE)=1
"RTN","PSOORNE6",97,0)
 .D INS^PSODIR(.PSONEW),EN^PSOFSIG(.PSONEW)
"RTN","PSOORNE6",98,0)
 K PSOMIS,PSODOSE,POERR("DFLG"),PSONEW("QFLG") S I=0
"RTN","PSOORNE6",99,0)
 F  S I=$O(PSONEW("DOSE",I)) Q:'I  I $L(PSONEW("DOSE",I))>60 S (PSONEW("QFLG"),POERR("DFLG"))=1,PSODOSE("MSG",I)="Dosage #"_I_" is greater 60 characters in length!",VALMSG="Dosage Greater than 60 Characters, Please Edit!"
"RTN","PSOORNE6",100,0)
 I $G(POERR("DFLG"))=1 D  K PSODOSE,I Q
"RTN","PSOORNE6",101,0)
 .S I=0 F  S I=$O(PSODOSE("MSG",I)) Q:'I  W !,PSODOSE("MSG",I)
"RTN","PSOORNE6",102,0)
 .H 3
"RTN","PSOORNE6",103,0)
 Q:$G(PSONEW("QFLG"))
"RTN","PSOORNE6",104,0)
 K PSONEW("FLD") F FLD="PATIENT STATUS^5","QTY^9","DAYS SUPPLY^8","# OF REFILLS^10","ISSUE DATE^6","FILL DATE^7","MAIL/WINDOW^11","PROVIDER NAME^13" D  I $G(PSONEW($P(FLD,"^")))']"" S VALMBCK="R",PSONEW("FLD")=1
"RTN","PSOORNE6",105,0)
 .I $G(PSONEW($P(FLD,"^")))']"" W !,$P(FLD,"^")_" is required data" N RTN S RTN=$P(FLD,"^",2)_"^PSOORNEW" D @RTN K RTN
"RTN","PSOORNE6",106,0)
 Q:$G(PSONEW("DFLG"))=1
"RTN","PSOORNE6",107,0)
QTY I PSONEW("QTY")'=+PSONEW("QTY"),PSONEW("QTY")'["." W !,"Quantity must be ALL numeric!",! D 9^PSOORNEW Q:$G(PSONEW("DFLG"))=1  G QTY
"RTN","PSOORNE6",108,0)
 I $G(PSODRUG("MAXDOSE"))]"",(PSONEW("QTY")/PSONEW("DAYS SUPPLY")>PSODRUG("MAXDOSE")) D  Q:$G(PSONEW("DFLG"))=1!($G(PSONEW("QFLG")))  G QTY
"RTN","PSOORNE6",109,0)
 .W !,$C(7)," Greater than Maximum dose of "_PSODRUG("MAXDOSE")_" per day"
"RTN","PSOORNE6",110,0)
 .D KV^PSOVER1 S DIR(0)="Y",DIR("B")="Yes",DIR("A")="Do You Want to Edit Days Supply and Quantity Fields"
"RTN","PSOORNE6",111,0)
 .S DIR("?")="Enter 'Y' for Yes, 'N' for No, '^' to exit."
"RTN","PSOORNE6",112,0)
 .D ^DIR I $D(DIRUT) D KV^PSOVER1 K X,Y S (PSONEW("DFLG"),PSONEW("QFLG"))=1 Q  ;*488
"RTN","PSOORNE6",113,0)
 .D KV^PSOVER1 I 'Y K X,Y Q
"RTN","PSOORNE6",114,0)
 .D 8^PSOORNEW Q:$G(PSONEW("DFLG"))  D 9^PSOORNEW
"RTN","PSOORNE6",115,0)
 I $G(PSONEW("PROVIDER")) D PROV^PSOUTIL(.PSONEW) I $G(PSONEW("DFLG")) S PSODIR("DFLG")=1 Q
"RTN","PSOORNE6",116,0)
 S PSONEW("DFLG")=0 K DIC,X,Y
"RTN","PSOORNE6",117,0)
 Q
"RTN","PSOORNE6",118,0)
DISP ;
"RTN","PSOORNE6",119,0)
 S:$P(RX2,"^",10)&('$G(PSOCOPY)) IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="         Verified By: "_$P(^VA(200,$P(RX2,"^",10),0),"^")
"RTN","PSOORNE6",120,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",5) S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="         Finished By: "_$P(^VA(200,$P(^PSRX(RXN,"OR1"),"^",5),0),"^")
"RTN","PSOORNE6",121,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",6) D
"RTN","PSOORNE6",122,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="           Filled By: "_$P(^VA(200,$P(^PSRX(RXN,"OR1"),"^",6),0),"^")
"RTN","PSOORNE6",123,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",7) D
"RTN","PSOORNE6",124,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="          Checked By: "_$P(^VA(200,$P(^PSRX(RXN,"OR1"),"^",7),0),"^")
"RTN","PSOORNE6",125,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="   Entry By: "_$P(^VA(200,$P(RX0,"^",16),0),"^")_$E(RN,$L($P(^VA(200,$P(RX0,"^",16),0),"^"))+1,35)
"RTN","PSOORNE6",126,0)
 S Y=$P(RX2,"^") X ^DD("DD")
"RTN","PSOORNE6",127,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"Entry Date: "_$E($P(RX2,"^"),4,5)_"/"_$E($P(RX2,"^"),6,7)_"/"_$E($P(RX2,"^"),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORNE6",128,0)
 S (VALMCNT,PSOPF)=IEN S:$P($G(^PSRX(RXN,"PKI")),"^") VALMSG="Digitally Signed Order"
"RTN","PSOORNE6",129,0)
 Q
"RTN","PSOORNEW")
0^5^B119220767^B117010534
"RTN","PSOORNEW",1,0)
PSOORNEW ;BIR/SAB - display orders from oerr ;6/19/06 3:53pm
"RTN","PSOORNEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,55,46,71,90,94,106,131,133,143,237,222,258,206,225,251,386,390,391,372,416,431,313,408,436,411,444,486,446,505,517,508**;DEC 1997;Build 295
"RTN","PSOORNEW",3,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORNEW",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORNEW",5,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOORNEW",6,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORNEW",7,0)
 ;External reference to EN1^ORCFLAG supported by DBIA 3620
"RTN","PSOORNEW",8,0)
 ;
"RTN","PSOORNEW",9,0)
 ;PSO*237 quit Finish if Today > Issue date + 365
"RTN","PSOORNEW",10,0)
 ;
"RTN","PSOORNEW",11,0)
DSPL I $G(PSODSPL) S VALMBCK="Q" K PSODSPL,PSOANSQD Q
"RTN","PSOORNEW",12,0)
 Q:'$D(PSOLMC)  K ^TMP("PSOPO",$J) S PSOLMC=PSOLMC+1
"RTN","PSOORNEW",13,0)
 I $D(CLOZPAT) S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),1:7) G OI
"RTN","PSOORNEW",14,0)
 S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3))&('$G(PSONEW("DAYS SUPPLY"))):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:30)
"RTN","PSOORNEW",15,0)
OI I '$G(PSODRUG("OI")) D
"RTN","PSOORNEW",16,0)
 .N OI,OID S (OI,PSODRUG("OI"))=$P(OR0,"^",8),PSODRUG("OIN")=$P(^PS(50.7,$P(OR0,"^",8),0),"^"),OID=$P(OR0,"^",9)
"RTN","PSOORNEW",17,0)
 .I $P($G(OR0),"^",9) S POERR=1,DREN=$P(OR0,"^",9) D DRG^PSOORDRG K POERR
"RTN","PSOORNEW",18,0)
 I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A",$G(PSODRUG("DEA"))'["B"!($G(PSODRUG("DEA"))["F") S PSONEW("# OF REFILLS")=0
"RTN","PSOORNEW",19,0)
 I $D(CLOZPAT) S PSONEW("# OF REFILLS")=$S($D(PSONEW("# OF REFILLS")):PSONEW("# OF REFILLS"),$G(CLOZPAT)=2&($P(OR0,"^",11)>2):3,$G(CLOZPAT)&($P(OR0,"^",11)>1):1,1:0)
"RTN","PSOORNEW",20,0)
 S IEN=0 D OBX^PSOORFI1,DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:""))
"RTN","PSOORNEW",21,0)
 D LMDISP^PSOORFI5(+$G(ORD)) ; Display Flag/Unflag Information
"RTN","PSOORNEW",22,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="*(1) Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNEW",23,0)
 S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",24,0)
 K LST I $G(PSODRUG("NAME"))]"" D  G PT
"RTN","PSOORNEW",25,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)"_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORNEW",26,0)
 .S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",27,0)
 .I $P($G(^PSDRUG(PSODRUG("IEN"),0)),"^",10)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Drug Message:" D DRGMSG
"RTN","PSOORNEW",28,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)           Drug: No Dispense Drug Selected"
"RTN","PSOORNEW",29,0)
PT D DOSE2^PSOORFI4
"RTN","PSOORNEW",30,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (4)   Pat Instruct:" D:$O(PSONEW("SIG",0)) INST^PSOORFI4
"RTN","PSOORNEW",31,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Provider Comments:" S TY=3 D INST^PSOORFI1
"RTN","PSOORNEW",32,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Instructions:" S TY=2 D INST^PSOORFI1
"RTN","PSOORNEW",33,0)
 K PSOELSE S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                SIG:"
"RTN","PSOORNEW",34,0)
 F I=0:0 S I=$O(SIG(I)) Q:'I  S SIG=SIG(I) D
"RTN","PSOORNEW",35,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNEW",36,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (5) Patient Status: "_$P($G(^PS(53,+PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORNEW",37,0)
 K PSOELSE I $G(PSONEW("ISSUE DATE"))']"" S PSOELSE=1 S IEN=IEN+1,(PSOID,Y)=$E($P(OR0,"^",6),1,7) X ^DD("DD") S PSONEW("ISSUE DATE")=Y,^TMP("PSOPO",$J,IEN,0)=" (4)     Issue Date: "_Y
"RTN","PSOORNEW",38,0)
 I '$G(PSOELSE) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (6)     Issue Date: "_PSONEW("ISSUE DATE")
"RTN","PSOORNEW",39,0)
 K PSOELSE I $G(PSORX("FILL DATE"))']"" S PSOELSE=1 D
"RTN","PSOORNEW",40,0)
 .S (Y,PSORX("FILL DATE"))=$S($E($P(OR0,"^",6),1,7)<DT:DT,1:$E($P(OR0,"^",6),1,7)) X ^DD("DD") S PSONEW("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                  (5) Fill Date: "_Y
"RTN","PSOORNEW",41,0)
 I '$G(PSOELSE) S Y=PSORX("FILL DATE") X ^DD("DD") S PSORX("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"       (7) Fill Date: "_PSORX("FILL DATE")
"RTN","PSOORNEW",42,0)
 I $P(OR0,"^",18) S IEN=IEN+1,Y=$P(OR0,"^",18) X ^DD("DD") S $P(^TMP("PSOPO",$J,IEN,0)," ",39)="Effective Date: "_Y
"RTN","PSOORNEW",43,0)
 I $D(CLOZPAT) D ELIG^PSOORFI2 S:'$D(PSONEW("QTY")) PSONEW("QTY")=0
"RTN","PSOORNEW",44,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (8)    Days Supply: "_PSONEW("DAYS SUPPLY")
"RTN","PSOORNEW",45,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"               (9)   QTY"_$S($P($G(^PSDRUG(+$G(PSODRUG("IEN")),660)),"^",8)]"":" ("_$P($G(^PSDRUG(+PSODRUG("IEN"),660)),"^",8)_")",1:" (  )")
"RTN","PSOORNEW",46,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_": "_$S($G(PSONEW("QTY"))]"":PSONEW("QTY"),1:$P(OR0,"^",10))
"RTN","PSOORNEW",47,0)
 I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),5)),"^")]"" D
"RTN","PSOORNEW",48,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNEW",49,0)
 .S ^TMP("PSOPO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^") K RN
"RTN","PSOORNEW",50,0)
 S IEN=IEN+1
"RTN","PSOORNEW",51,0)
 I $P(OR0,"^",24) S ^TMP("PSOPO",$J,IEN,0)="   Provider ordered: days supply "_+$P(OR0,"^",22)_", quantity "_$P(OR0,"^",10)_" & refills "_+$P(OR0,"^",11)
"RTN","PSOORNEW",52,0)
 E  S ^TMP("PSOPO",$J,IEN,0)="       Provider ordered "_+$P(OR0,"^",11)_" refills"
"RTN","PSOORNEW",53,0)
 D:$D(CLOZPAT) PQTY^PSOORFI4
"RTN","PSOORNEW",54,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(10)   # of Refills: "_$S($G(PSONEW("# OF REFILLS"))]"":PSONEW("# OF REFILLS"),1:$P(OR0,"^",11))_"               (11)   Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORNEW",55,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(12)         Clinic: "_PSORX("CLINIC")
"RTN","PSOORNEW",56,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(13)       Provider: "_PSONEW("PROVIDER NAME")
"RTN","PSOORNEW",57,0)
 D:$P(OR0,"^",24)!((+$G(PSODRUG("DEA"))>1)&(+$G(PSODRUG("DEA"))<6)) PRV^PSOORFI5($G(PSONEW("PROVIDER")),$G(PSODRUG("IEN")),$P(OR0,"^"))
"RTN","PSOORNEW",58,0)
 I $P($G(^VA(200,$S($G(PSONEW("PROVIDER")):PSONEW("PROVIDER"),1:$P(OR0,"^",5)),"PS")),"^",7)&($P($G(^("PS")),"^",8)) D
"RTN","PSOORNEW",59,0)
 .S IEN=IEN+1,PSONEW("COSIGNING PROVIDER")=$S($G(PSONEW("COSIGNING PROVIDER")):PSONEW("COSIGNING PROVIDER"),1:$P(^("PS"),"^",8))
"RTN","PSOORNEW",60,0)
 .S ^TMP("PSOPO",$J,IEN,0)="       Cos-Provider: "_$P(^VA(200,PSONEW("COSIGNING PROVIDER"),0),"^")
"RTN","PSOORNEW",61,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(14)         Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1)
"RTN","PSOORNEW",62,0)
 S PSONEW("REMARKS")=$S($G(PSONEW("REMARKS"))]"":PSONEW("REMARKS"),$P(OR0,"^",17)="C":"Administered in Clinic.",1:"")
"RTN","PSOORNEW",63,0)
 K PSONEW("ADMINCLINIC") S:$P(OR0,"^",17)="C" PSONEW("ADMINCLINIC")=1
"RTN","PSOORNEW",64,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(15)        Remarks:"
"RTN","PSOORNEW",65,0)
 I $G(PSONEW("REMARKS"))]"" D
"RTN","PSOORNEW",66,0)
 .F SG=1:1:$L(PSONEW("REMARKS")) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("REMARKS")," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",67,0)
 ..S:$P(PSONEW("REMARKS")," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("REMARKS")," ",SG)
"RTN","PSOORNEW",68,0)
 I $G(PSOSIGFL)!(PSODRUG("OI")'=$P(OR0,"^",8)) S PSONEW("CLERK CODE")=DUZ,PSORX("CLERK CODE")=$P(^VA(200,DUZ,0),"^"),VALMSG="This change will create a new prescription!"
"RTN","PSOORNEW",69,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,PSONEW("CLERK CODE"),0),"^")_$E(RN,$L($P(^VA(200,PSONEW("CLERK CODE"),0),"^"))+1,35)
"RTN","PSOORNEW",70,0)
 S Y=$P(OR0,"^",12) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$E($P(OR0,"^",12),4,5)_"/"_$E($P(OR0,"^",12),6,7)_"/"_$E($P(OR0,"^",12),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORNEW",71,0)
 I PSOLMC<2 D ^PSOLMPO1 S VALMBCK="Q",PSOLMC=0
"RTN","PSOORNEW",72,0)
 S:PSOLMC>1 VALMBCK="R"
"RTN","PSOORNEW",73,0)
 Q
"RTN","PSOORNEW",74,0)
ORCHK D PROVCOM^PSOORFI4,ORCHK^PSOORFI4
"RTN","PSOORNEW",75,0)
 Q
"RTN","PSOORNEW",76,0)
EDT D KV S DIR("A",1)="* Indicates which fields will create an new Order",DIR("A")="Select Field to Edit by number",DIR(0)="LO^1:15" D ^DIR Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOORNEW",77,0)
EDTSEL N LST,FLD,OUT,CHECK,CSDRG D KV S (OUT,CSDRG)=0 ;/BLB/ PSO*7.0*505/517 MODIFIED EDIT FUNCTIONALITY TO BLOCK CERTAIN FIELDS FOR CONTROLLED SUBSTANCE RX
"RTN","PSOORNEW",78,0)
 I '$D(PSODRG) S PSODRG=$G(PSODRUG("IEN"))
"RTN","PSOORNEW",79,0)
 I PSODRG,$$NDF(PSODRG)!($$CSDRG(PSODRG)) S CSDRG=1
"RTN","PSOORNEW",80,0)
 I +Y S LST=Y D FULL^VALM1 N PSODOSE M PSODOSE=PSONEW D  G DSPL
"RTN","PSOORNEW",81,0)
 .I CSDRG,(","_LST[",1,")!(","_LST[",3,")!(","_LST[",13,") D
"RTN","PSOORNEW",82,0)
 ..W !!,"The selection includes field(s) that are not editable" W !,"for controlled substances. These field(s) will be skipped.",!
"RTN","PSOORNEW",83,0)
 ..S DIR(0)="E" D ^DIR K DIR
"RTN","PSOORNEW",84,0)
 .F FLD=1:1:$L(LST,",") Q:$P(LST,",",FLD)']""!(OUT)  D
"RTN","PSOORNEW",85,0)
 ..S CHECK=","_+$P(LST,",",FLD)_"," I CSDRG,",1,3,13,"[CHECK Q
"RTN","PSOORNEW",86,0)
 ..D @(+$P(LST,",",FLD)) D:$P(LST,",",FLD)=8 REF D KV
"RTN","PSOORNEW",87,0)
 E  S VALMBCK="" Q
"RTN","PSOORNEW",88,0)
ACP ;
"RTN","PSOORNEW",89,0)
 N PSOORNEW,DIR,Y S Y=0,PSOORNEW=1
"RTN","PSOORNEW",90,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 D  Q:$D(DIRUT)!'Y  D EN1^ORCFLAG(+$P($G(^PS(52.41,ORD,0)),"^")) H 1
"RTN","PSOORNEW",91,0)
 . D FULL^VALM1
"RTN","PSOORNEW",92,0)
 . I '$D(^XUSEC("PSORPH",DUZ)) D  S Y=0 Q
"RTN","PSOORNEW",93,0)
 . . S DIR("A",1)="Order must be unflagged by a pharmacist before it can be finished."
"RTN","PSOORNEW",94,0)
 . . S DIR("A",2)=""
"RTN","PSOORNEW",95,0)
 . . S DIR(0)="E",DIR("A")="Enter RETURN to continue" W !,$C(7) D ^DIR
"RTN","PSOORNEW",96,0)
 . . S VALMBCK="R"
"RTN","PSOORNEW",97,0)
 . D KV
"RTN","PSOORNEW",98,0)
 . S DIR("A",1)="This Order is flagged. In order to finish it"
"RTN","PSOORNEW",99,0)
 . S DIR("A",2)="you must unflag it first."
"RTN","PSOORNEW",100,0)
 . S DIR("A",3)=""
"RTN","PSOORNEW",101,0)
 . S DIR(0)="Y",DIR("A")="Unflag Order",DIR("B")="NO"
"RTN","PSOORNEW",102,0)
 . W ! D ^DIR I $D(DIRUT)!'Y S VALMBCK="Q"
"RTN","PSOORNEW",103,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 Q
"RTN","PSOORNEW",104,0)
 ;
"RTN","PSOORNEW",105,0)
 I $D(CLOZPAT),+$G(PSONEW("QTY"))=0 S VALMSG="Unable to calculate the quantity, enter a quantity" G DSPL
"RTN","PSOORNEW",106,0)
 S (PSODIR("DFLG"),PSORX("DFLG"),PSODIR("QFLD"))=0,ACP=1 D ORCHK
"RTN","PSOORNEW",107,0)
 G:$G(PSONEW("QFLG")) DSPL
"RTN","PSOORNEW",108,0)
 I $G(PSODIR("DFLG"))!$G(PSORX("DFLG")) Q
"RTN","PSOORNEW",109,0)
 I $G(PSONEW("FLD"))!($G(PSODRUG("NAME"))']"")!('$O(SIG(0))) G DSPL
"RTN","PSOORNEW",110,0)
 ;PATCH PSO*7*517 - Blocking action FN if issuing a controlled substance to a patient without a zipcode
"RTN","PSOORNEW",111,0)
 S DRGIEN=$G(PSODRUG("IEN"))
"RTN","PSOORNEW",112,0)
 I $$CSBLOCK(PSODFN,DRGIEN) D  S DIR(0)="E" W ! D ^DIR K DIR K Y Q
"RTN","PSOORNEW",113,0)
 .W !,"Controlled substance prescriptions require a patient address. Please update"
"RTN","PSOORNEW",114,0)
 .W !,"patient address information. This action will also invalidate a digitally"
"RTN","PSOORNEW",115,0)
 .W !,"signed prescription and require the provider to re-enter the order."
"RTN","PSOORNEW",116,0)
 ;PSO*7*517 - END
"RTN","PSOORNEW",117,0)
 I $G(PSODRUG("NAME"))]"",'$G(ORCHK)!($G(ORDRG)'=PSODRUG("NAME")) D  I $G(PSORX("DFLG")) D CLEAN^PSOVER1 G DSPL
"RTN","PSOORNEW",118,0)
 . D POST^PSODRG S:'$G(PSORX("DFLG")) ORCHK=1,ORDRG=PSODRUG("NAME")
"RTN","PSOORNEW",119,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("N") I $G(PSORX("DFLG")) G DSPL
"RTN","PSOORNEW",120,0)
 I '$D(PSONEW("RX #")) S PSOFROM="NEW",RTN=$S($P($G(PSOPAR),"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN") D @RTN Q:PSONEW("QFLG")  I '$P($G(PSOPAR),"^",7) S PSOX=PSONEW("RX #") D CHECK^PSONRXN
"RTN","PSOORNEW",121,0)
 D RXNCHK^PSOORNE1 I $G(PSONEW("QFLG")) S PSONEW("DFLG")=1 Q
"RTN","PSOORNEW",122,0)
 I DT>$$FMADD^XLFDT($P(OR0,"^",6),365) D EXPR^PSONEW2 G DSPL
"RTN","PSOORNEW",123,0)
 D STOP^PSONEW2,DISPLAY^PSONEW2,^PSONEWF
"RTN","PSOORNEW",124,0)
 I $G(PSOCPZ("DFLG")) W !!,"No action taken!",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR,KV K PSOCPZ("DFLG"),DRET,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",125,0)
 ;
"RTN","PSOORNEW",126,0)
 K PSOCPZ("DFLG") D KV S DIR(0)="Y",DIR("A")="Are you sure you want to Accept this Order",DIR("B")="NO" D ^DIR I $D(DIRUT) D KV K DRET,PSOANSQ,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",127,0)
 D KV I 'Y K PSOANSQ G DSPL
"RTN","PSOORNEW",128,0)
 I $G(PSONEW("MAIL/WINDOW"))["W" D:$P($G(PSOPAR),"^",12)  S BINGCRT="Y",BINGRTE="W",PSORX("MAIL/WINDOW")="WINDOW" K RTN
"RTN","PSOORNEW",129,0)
 .W ! K DIR,DIRUT S DIR(0)="52,35O"
"RTN","PSOORNEW",130,0)
 .S:$G(PSORX("METHOD OF PICK-UP"))]"" DIR("B")=PSORX("METHOD OF PICK-UP") D ^DIR I $D(DIRUT) K DIR,DIRUT Q
"RTN","PSOORNEW",131,0)
 .S (PSONEW("METHOD OF PICK-UP"),PSORX("METHOD OF PICK-UP"))=Y K X,Y
"RTN","PSOORNEW",132,0)
 S PSONEW("POE")=1 K PSORX("DFLG"),PSONEW("DFLG") D EN^PSON52(.PSONEW) G:$G(PSONEW("DFLG")) ABORT D DCORD^PSONEW2 D:$G(PKI)=89802020 ALERT^PSOPKIV1
"RTN","PSOORNEW",133,0)
 ; - Possible Titration Rx?
"RTN","PSOORNEW",134,0)
 I $G(PSONEW("IRXN")) D MARK^PSOOTMRX(PSONEW("IRXN"),0)
"RTN","PSOORNEW",135,0)
 ;saves drug allergy order chks pso*7*390
"RTN","PSOORNEW",136,0)
 I $D(^TMP("PSODAOC",$J)) D
"RTN","PSOORNEW",137,0)
 .I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSOORNEW",138,0)
 .S RXN=PSONEW("IRXN"),PSODAOC="Finished CPRS Rx "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"Order Acceptance_OP"
"RTN","PSOORNEW",139,0)
 .D DAOC^PSONEW
"RTN","PSOORNEW",140,0)
 D NPSOSD^PSOUTIL(.PSONEW),FULL^VALM1 K PSORX("MAIL/WINDOW")
"RTN","PSOORNEW",141,0)
 ; PSO*7*508 - link the erx to the outpatient prescription
"RTN","PSOORNEW",142,0)
 N ERXIEN
"RTN","PSOORNEW",143,0)
 S ERXIEN=$$CHKERX^PSOERXU1(OR0) I ERXIEN D
"RTN","PSOORNEW",144,0)
 .S ERXFDA(52.49,ERXIEN_",",.13)=PSONEW("IRXN") D FILE^DIE(,"ERXFDA") K ERXFDA
"RTN","PSOORNEW",145,0)
 ; PSO*7*508 - end eRx enhancement
"RTN","PSOORNEW",146,0)
 D EOJ^PSONEW
"RTN","PSOORNEW",147,0)
ABORT S VALMBCK="Q",DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR,CLEAN^PSOVER1,KV
"RTN","PSOORNEW",148,0)
 Q
"RTN","PSOORNEW",149,0)
KV K DIRUT,DUOUT,DTOUT,DIR,PSOEDDOS
"RTN","PSOORNEW",150,0)
 Q
"RTN","PSOORNEW",151,0)
REF ;
"RTN","PSOORNEW",152,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSOORNEW",153,0)
 N MAXRF S MAXRF=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),+$G(PSONEW("DAYS SUPPLY")),+$G(PSONEW("PATIENT STATUS")),.CLOZPAT)
"RTN","PSOORNEW",154,0)
 I ($G(PSONEW("# OF REFILLS"))'="")&($G(PSONEW("# OF REFILLS"))'>MAXRF) D
"RTN","PSOORNEW",155,0)
 . S PSONEW("N# REF")=PSONEW("# OF REFILLS")
"RTN","PSOORNEW",156,0)
 E  D
"RTN","PSOORNEW",157,0)
 . S (PSONEW("N# REF"),PSONEW("# OF REFILLS"))=MAXRF
"RTN","PSOORNEW",158,0)
 Q
"RTN","PSOORNEW",159,0)
1 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",160,0)
 . W !!,"Digitally Signed Order - Orderable Item cannot be changed",! D PZ
"RTN","PSOORNEW",161,0)
 N PSOBDR,PSOBDRG S PSOBDRG=1 D 1^PSOORNW2 Q  ;oi
"RTN","PSOORNEW",162,0)
 ;
"RTN","PSOORNEW",163,0)
4 D INS^PSOORNW2 Q
"RTN","PSOORNEW",164,0)
 ;
"RTN","PSOORNEW",165,0)
3 I $G(LST)["3,",$P(OR0,"^",24) D  Q 
"RTN","PSOORNEW",166,0)
 . W !!,"Digitally Signed Order - Dose cannot be changed",! D PZ
"RTN","PSOORNEW",167,0)
 N PSOEDDOS S PSOEDDOS=1 D DOSE^PSOORED4(.PSONEW) Q
"RTN","PSOORNEW",168,0)
 ;
"RTN","PSOORNEW",169,0)
6 D 4^PSOORNW2 Q  ;idt
"RTN","PSOORNEW",170,0)
 ;
"RTN","PSOORNEW",171,0)
7 D 5^PSOORNW2 Q  ;fdt
"RTN","PSOORNEW",172,0)
 ;
"RTN","PSOORNEW",173,0)
5 D 3^PSOORNW2 Q  ;pstat
"RTN","PSOORNEW",174,0)
 ;
"RTN","PSOORNEW",175,0)
13 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",176,0)
 . W !!,"Digitally Signed Order - Provider cannot be changed",! D PZ
"RTN","PSOORNEW",177,0)
 D 12^PSOORNW2 Q  ;doc
"RTN","PSOORNEW",178,0)
 ;
"RTN","PSOORNEW",179,0)
12 D 11^PSOORNW2 Q  ;cli
"RTN","PSOORNEW",180,0)
 ;
"RTN","PSOORNEW",181,0)
2 N PSOCSIG I '$G(PSOBDRG) N PSOBDR,PSOBDRG S PSOBDRG=1,PSOQFLG=0
"RTN","PSOORNEW",182,0)
 N CPRN S CPRN=+$P($G(OR0),"^",24) D 2^PSOORNW1 Q:$G(PSOQFLG)  D EN^PSODIAG  ;drg/ICD
"RTN","PSOORNEW",183,0)
 I $G(PSOCSIG) K PSOCSIG G 3
"RTN","PSOORNEW",184,0)
 Q
"RTN","PSOORNEW",185,0)
 ;
"RTN","PSOORNEW",186,0)
9 D 8^PSOORNW2 Q  ;qty
"RTN","PSOORNEW",187,0)
 ;
"RTN","PSOORNEW",188,0)
8 N CPRN S CPRN=+$P($G(OR0),"^",24) D 7^PSOORNW2 Q  ;ds
"RTN","PSOORNEW",189,0)
 ;
"RTN","PSOORNEW",190,0)
10 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",191,0)
 . W !!,"Digitally Signed Order - Refills cannot be changed",! D PZ
"RTN","PSOORNEW",192,0)
 D 9^PSOORNW2 Q  ;#rfs
"RTN","PSOORNEW",193,0)
 ;
"RTN","PSOORNEW",194,0)
14 D 13^PSOORNW2 Q  ;cop
"RTN","PSOORNEW",195,0)
 ;
"RTN","PSOORNEW",196,0)
11 D 10^PSOORNW2 Q  ;m/w
"RTN","PSOORNEW",197,0)
 ;
"RTN","PSOORNEW",198,0)
15 D 14^PSOORNW2 Q  ;rem
"RTN","PSOORNEW",199,0)
 ;
"RTN","PSOORNEW",200,0)
DRGMSG ;
"RTN","PSOORNEW",201,0)
 F SG=1:1:$L($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",202,0)
 .S:$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)
"RTN","PSOORNEW",203,0)
 K SG
"RTN","PSOORNEW",204,0)
 Q
"RTN","PSOORNEW",205,0)
 ;
"RTN","PSOORNEW",206,0)
PZ ;
"RTN","PSOORNEW",207,0)
 N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOORNEW",208,0)
 Q
"RTN","PSOORNEW",209,0)
CSDRG(DRGIEN) ;/BLB/ Patch PSO*7*505/517 Controlled Substance drug?
"RTN","PSOORNEW",210,0)
 ; Input: DRGIEN - DRUG file (#50) pointer
"RTN","PSOORNEW",211,0)
 ;Output: $$CS - 1:YES / 0:NO
"RTN","PSOORNEW",212,0)
 N DEA
"RTN","PSOORNEW",213,0)
 Q:'DRGIEN 0
"RTN","PSOORNEW",214,0)
 S DEA=$$GET1^DIQ(50,DRGIEN,3)
"RTN","PSOORNEW",215,0)
 I (DEA'["0"),(DEA'["M"),(DEA["2")!(DEA["3")!(DEA["4")!(DEA["5") Q 1
"RTN","PSOORNEW",216,0)
 Q 0
"RTN","PSOORNEW",217,0)
NDF(DRGIEN) ;PATCH PSO*7*505/517 - 1:YES 0:NO checks the cs federal schedule field of the va product file
"RTN","PSOORNEW",218,0)
 N DEARES,VPROD
"RTN","PSOORNEW",219,0)
 S VPROD=$$GET1^DIQ(50,DRGIEN,22,"I") Q:'VPROD 0
"RTN","PSOORNEW",220,0)
 S DEARES=$$GET1^DIQ(50.68,VPROD,19,"I")
"RTN","PSOORNEW",221,0)
 I +$E(DEARES)>0 Q 1
"RTN","PSOORNEW",222,0)
 Q 0
"RTN","PSOORNEW",223,0)
CSBLOCK(DFN,DIEN) ;
"RTN","PSOORNEW",224,0)
 N VAPA
"RTN","PSOORNEW",225,0)
 D ADD^VADPT
"RTN","PSOORNEW",226,0)
 I DIEN,$$CSDRG(DIEN)!($$NDF(DIEN)),($$UP^XLFSTR($P(VAPA(25),U,2))'="UNITED STATES") Q 0
"RTN","PSOORNEW",227,0)
 I DIEN,$$CSDRG(DIEN)!($$NDF(DIEN)),('$L(VAPA(6))),('$L(VAPA(11))) Q 1
"RTN","PSOORNEW",228,0)
 Q 0
"RTN","PSOORUT1")
0^6^B131536196^B124954661
"RTN","PSOORUT1",1,0)
PSOORUT1 ;BIR/SAB - Utility routine for oerr interface ;8/26/16 1:41pm
"RTN","PSOORUT1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,14,30,46,132,148,233,274,225,305,289,251,387,385,313,427,444,454,508**;DEC 1997;Build 295
"RTN","PSOORUT1",3,0)
 ;
"RTN","PSOORUT1",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORUT1",5,0)
 ;External reference to ^PSXOPUTL supported by DBIA 2203
"RTN","PSOORUT1",6,0)
 ;called from HD^PSOORUTL
"RTN","PSOORUT1",7,0)
REL ;removed order from hold
"RTN","PSOORUT1",8,0)
 S ACT=1,ORS=0
"RTN","PSOORUT1",9,0)
 I POERR("PSOFILNM")["S" S DA=+POERR("PSOFILNM") D  G EXIT^PSOORUTL
"RTN","PSOORUT1",10,0)
 .Q:'$D(^PS(52.41,DA,0))  Q:$P(^PS(52.41,DA,0),"^",3)="RF"
"RTN","PSOORUT1",11,0)
 .S $P(^PS(52.41,DA,0),"^",3)="NW",POERR("STAT")="OR",POERR("FILLER")=DA_"^P"
"RTN","PSOORUT1",12,0)
 .S:$G(POERR("COMM"))']"" POERR("COMM")="Order RELEASED from HOLD by OE/RR before finished." S $P(^PS(52.41,DA,4),"^")=POERR("COMM"),ORS=1
"RTN","PSOORUT1",13,0)
 S DA=POERR("PSOFILNM") I $D(^PSRX(DA,0)) S ORS=1,PSDA=DA D  G EXIT^PSOORUTL
"RTN","PSOORUT1",14,0)
 .S POERR("FILLER")=DA_"^R",POERR("STAT")="OR"
"RTN","PSOORUT1",15,0)
 .S:'$D(POERR("COMM")) POERR("COMM")="Prescription Released from HOLD by OE/RR"
"RTN","PSOORUT1",16,0)
 .I DT>$P(^PSRX(DA,2),"^",6) D
"RTN","PSOORUT1",17,0)
 ..S EXP=$P(^PSRX(DA,2),"^",6) S:$P(^PSRX(DA,"STA"),"^")<12 $P(^PSRX(DA,"STA"),"^")=11,PSOEXFLG=1 S POERR("STAT")="UR",POERR("COMM")="Medication Expired on "_$E(EXP,4,5)_"/"_$E(EXP,6,7)_"/"_$E(EXP,2,3)_".",POERR("PHARMST")="" D ECAN^PSOUTL(DA) Q
"RTN","PSOORUT1",18,0)
 .I $P(^PSRX(DA,"STA"),"^")'=16 S POERR("STAT")="UR",POERR("COMM")="Unable to Release from Hold" Q
"RTN","PSOORUT1",19,0)
 .S RXFL(DA)=0,FDT=$P(^PSRX(DA,2),"^",2)
"RTN","PSOORUT1",20,0)
 .I $O(^PSRX(DA,1,0)) F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S FDT=$P(^PSRX(DA,1,I,0),"^"),RXFL(DA)=I
"RTN","PSOORUT1",21,0)
 .I FDT>DT N PSOSITEZ,ZPSOPAR6 S PSOSITEZ=$S($P($G(^PSRX(DA,2)),"^",9):$P(^(2),"^",9),1:$O(^PS(59,0))),ZPSOPAR6=$P($G(^PS(59,PSOSITEZ,1)),"^",6) I ZPSOPAR6 D  Q
"RTN","PSOORUT1",22,0)
 ..S RXXDA=DA,DA=$O(^PS(52.5,"B",RXXDA,0)) I DA S DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOORUT1",23,0)
 ..S DA=RXXDA
"RTN","PSOORUT1",24,0)
 ..S DIC="^PS(52.5,",DIC(0)="L",DLAYGO=52.5,X=RXXDA,DIC("DR")=".02///"_FDT_";.03////"_$P(^PSRX(DA,0),"^",2)_";.04///M;.05///0;.06////"_PSOSITEZ_";2///0;9///"_RXFL(DA) K DD,DO D FILE^DICN K RXFL,DD,DO
"RTN","PSOORUT1",25,0)
 ..S DA=RXXDA K RXXDA S $P(^PSRX(DA,"STA"),"^")=5,LFD=$E(FDT,4,5)_"-"_$E(FDT,6,7)_"-"_$E(FDT,2,3) D ACT1
"RTN","PSOORUT1",26,0)
 ..S PSOSUSZ=1
"RTN","PSOORUT1",27,0)
 .E  S $P(^PSRX(DA,"STA"),"^")=0
"RTN","PSOORUT1",28,0)
 .S RXF=0 F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S RXF=I S:I>5 RXF=I+1
"RTN","PSOORUT1",29,0)
 .D ACT^PSOORUTL
"RTN","PSOORUT1",30,0)
 .I $$SUBMIT^PSOBPSUT(DA) D ECMESND^PSOBPSU1(DA,"","",$S('$O(^PSRX(DA,1,0)):"OF",1:"RF"))
"RTN","PSOORUT1",31,0)
 G EXIT^PSOORUTL
"RTN","PSOORUT1",32,0)
ACT1 I '$D(RXF) S RXF=0 F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S RXF=I S:I>5 RXF=I+1
"RTN","PSOORUT1",33,0)
 S IR=0 F FDA=0:0 S FDA=$O(^PSRX(DA,"A",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOORUT1",34,0)
 S IR=IR+1,^PSRX(DA,"A",0)="^52.3DA^"_IR_"^"_IR
"RTN","PSOORUT1",35,0)
 D NOW^%DTC S ^PSRX(DA,"A",IR,0)=%_"^S^"_POERR("USER")_"^"_RXF_"^"_"RX Placed on Suspense until "_LFD
"RTN","PSOORUT1",36,0)
 Q
"RTN","PSOORUT1",37,0)
SUS ;
"RTN","PSOORUT1",38,0)
 I $P($G(^PSRX(+$G(FILLER),"STA")),"^")=5 N PSOMSORR,PLACERXX D EN^PSOHLSN1(+$G(FILLER),"SC","ZS","")
"RTN","PSOORUT1",39,0)
 Q
"RTN","PSOORUT1",40,0)
BLD ;builds med profile for Listman
"RTN","PSOORUT1",41,0)
 K PSODCREV,^TMP("PSOPF",$J),PSOLST S:$G(PSOOPT)'=3 PSOOPT=0 I '$G(PSOSD),'$D(^XTMP("PSORRX1",$J,PSODFN)) S ^TMP("PSOPF",$J,1,0)="This patient has no prescriptions" S PSOCNT=0,PSOPF=1 Q
"RTN","PSOORUT1",42,0)
 D EOJ,SHOW
"RTN","PSOORUT1",43,0)
EOJ ;
"RTN","PSOORUT1",44,0)
 K PSOQFLG,PSODRG,PSODATA,PSOLF
"RTN","PSOORUT1",45,0)
 Q
"RTN","PSOORUT1",46,0)
 ;-----------------------------------------------------------------
"RTN","PSOORUT1",47,0)
SHOW ;
"RTN","PSOORUT1",48,0)
 ; - ePharmacy modification to create a section for Rx with REJECTs
"RTN","PSOORUT1",49,0)
 N PSOTMP,PSOSTS,PSODRNM,I,PSORX
"RTN","PSOORUT1",50,0)
 S (PSOSTS,PSODRNM)=""
"RTN","PSOORUT1",51,0)
 F  S PSOSTS=$O(PSOSD(PSOSTS)) Q:PSOSTS=""  D
"RTN","PSOORUT1",52,0)
 . F  S PSODRNM=$O(PSOSD(PSOSTS,PSODRNM)) Q:PSODRNM=""  D
"RTN","PSOORUT1",53,0)
 . . S PSORX=+$G(PSOSD(PSOSTS,PSODRNM))
"RTN","PSOORUT1",54,0)
  . . ; PSO*7*427 - add a new section for open TRICARE/CHAMPVA/RRR rejects after the 79/88 open rejects
"RTN","PSOORUT1",55,0)
 . . I PSOSTS="ACTIVE",$$FIND^PSOREJUT(PSORX,,,"79,88") S PSOTMP(" REJECT",PSODRNM)=PSOSTS Q   ; DUR/RTS
"RTN","PSOORUT1",56,0)
 . . I PSOSTS="ACTIVE",$$TRIC^PSOREJP1(PSORX),$$FIND^PSOREJUT(PSORX,,,,1) S PSOTMP(" REJECT2",PSODRNM)=PSOSTS Q  ; TRI/CVA
"RTN","PSOORUT1",57,0)
 . . I PSOSTS="ACTIVE",'$$TRIC^PSOREJP1(PSORX),$$FIND^PSOREJUT(PSORX,,,,,1) S PSOTMP(" REJECT2",PSODRNM)=PSOSTS Q  ; RRR
"RTN","PSOORUT1",58,0)
 . . S PSOTMP(PSOSTS,PSODRNM)=PSOSTS
"RTN","PSOORUT1",59,0)
 ;
"RTN","PSOORUT1",60,0)
 S (PSOSTS,PSODRG)="",(PSOCNT,PSOQFLG,IEN)=0
"RTN","PSOORUT1",61,0)
 K RN,DL S $P(RN," ",12)=" ",$P(DL," ",40)=" "
"RTN","PSOORUT1",62,0)
 F PSCNT=0:0 S PSOSTS=$O(PSOTMP(PSOSTS)) Q:PSOSTS=""  D
"RTN","PSOORUT1",63,0)
 . D STA
"RTN","PSOORUT1",64,0)
 . F PSOCT=0:0 S PSODRG=$O(PSOTMP(PSOSTS,PSODRG)) Q:PSODRG=""  Q:PSOCNT>1000!PSOQFLG  D
"RTN","PSOORUT1",65,0)
 . . S PSOSTA=PSOTMP(PSOSTS,PSODRG)
"RTN","PSOORUT1",66,0)
 . . S PSODATA=PSOSD(PSOSTA,PSODRG) I PSOSTA="ZNONVA" D NVA Q
"RTN","PSOORUT1",67,0)
 . . S PSOCNT=PSOCNT+1 I PSOSTA="PENDING" D PEN Q
"RTN","PSOORUT1",68,0)
 . . S:'$D(^PSRX(+PSODATA,0)) PSOCNT=PSOCNT-1 D:$D(^(0)) DISPL
"RTN","PSOORUT1",69,0)
 ;S (VALMCNT,PSOPF)=IEN
"RTN","PSOORUT1",70,0)
 ; bwf - 1/9/2014, PHARMACY INNOVATIONS. Adding display of remote rx's.
"RTN","PSOORUT1",71,0)
SHOWREM ;
"RTN","PSOORUT1",72,0)
 N REMSITE,RRXIEN,RRXDAT,RRXDNAME,RRXDNL,RRXQTY,RRXQTYL,RREFILLS,RRXDSUPP,RRXEXP,RRXISSDT,RRXISSDT1,RRXLFDT,RRXLFDT1,RRXDNSP,RRXQSP,REMSIEN,STAT,STATABBR,DLINE,DLEN
"RTN","PSOORUT1",73,0)
 N BSPACE,FSPACE,RSPACE,BDNAME,RRXISP,RXDUPP,PSORRLST
"RTN","PSOORUT1",74,0)
 ; SET UP PSORCNT
"RTN","PSOORUT1",75,0)
 S PSORCNT=$G(PSOCNT)
"RTN","PSOORUT1",76,0)
 I '$D(^TMP("PSOPF",$J)) S ^TMP("PSOPF",$J,1,0)="<No local prescriptions found.>",IEN=$G(IEN)+1
"RTN","PSOORUT1",77,0)
 ;S IEN=$G(IEN)+1,^TMP("PSOPF",$J,IEN,0)="-------------------------------------REMOTE-------------------------------------"
"RTN","PSOORUT1",78,0)
 S REMSITE=0 F  S REMSITE=$O(^XTMP("PSORRX1",$J,PSODFN,REMSITE)) Q:'REMSITE  D
"RTN","PSOORUT1",79,0)
 .I REMSITE=$G(DUZ(2)) Q
"RTN","PSOORUT1",80,0)
 .;S REMSIEN=$O(^DIC(4,"D",REMSITE,0))
"RTN","PSOORUT1",81,0)
 .S REMSIEN=$$FIND1^DIC(4,,"X",REMSITE,"D","I $P(^(0),U,11)=""N"",'$P($G(^(99)),U,4)") Q:'REMSIEN
"RTN","PSOORUT1",82,0)
 .S STAT=0 F  S STAT=$O(^XTMP("PSORRX1",$J,PSODFN,REMSITE,STAT)) Q:STAT=""  D
"RTN","PSOORUT1",83,0)
 ..S STATABBR=$S(STAT="ACTIVE":"A",STAT="HOLD":"H",STAT="PROVIDER HOLD":"PH",STAT="SUSPENDED":"S",STAT["DISCONTINUED":"DC",STAT="EXPIRED":"E",1:"")
"RTN","PSOORUT1",84,0)
 ..S DLINE=$E($$GET1^DIQ(4,REMSIEN,.01,"E"),1,30)_" ("_REMSITE_")"_$S(STAT="ERR":"",1:" "_STAT),DLEN=$L(DLINE)
"RTN","PSOORUT1",85,0)
 ..S (FSPACE,RSPACE)=""
"RTN","PSOORUT1",86,0)
 ..S BSPACE=IOM-$L(DLINE),$P(FSPACE,"-",(BSPACE\2))="-",$P(RSPACE,"-",(BSPACE\2)+$S(BSPACE#2:1,1:0))="-"
"RTN","PSOORUT1",87,0)
 ..S IEN=$G(IEN)+1,^TMP("PSOPF",$J,IEN,0)=FSPACE_$E($$GET1^DIQ(4,REMSIEN,.01,"E"),1,30)_" ("_REMSITE_")"_$S(STAT="ERR":"",1:" "_STAT)_RSPACE
"RTN","PSOORUT1",88,0)
 ..I $D(^XTMP("PSORRX1",$J,PSODFN,REMSITE,"ERR")) S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)=$G(^XTMP("PSORRX1",$J,PSODFN,REMSITE,"ERR"))
"RTN","PSOORUT1",89,0)
 ..S RRXDNAME="" F  S RRXDNAME=$O(^XTMP("PSORRX1",$J,PSODFN,REMSITE,STAT,RRXDNAME)) Q:RRXDNAME=""  D
"RTN","PSOORUT1",90,0)
 ...S RRXDAT=$G(^XTMP("PSORRX1",$J,PSODFN,REMSITE,STAT,RRXDNAME,0))
"RTN","PSOORUT1",91,0)
 ...S BDNAME=$E(RRXDNAME,1,35)
"RTN","PSOORUT1",92,0)
 ...S RRXIEN=$P(RRXDAT,U),RRXDNL=$L(BDNAME),RRXQTY=$P(RRXDAT,U,2),RRXQTYL=$L(RRXQTY),RREFILLS=$P(RRXDAT,U,3),RRXDSUPP=$E($P(RRXDAT,U,4),2,4),RRXEXP=$P(RRXDAT,U,5)
"RTN","PSOORUT1",93,0)
 ...S RRXISSDT=$P($P(RRXDAT,U,6),"."),RRXISSDT1=$E(RRXISSDT,5,6)_"-"_$E(RRXISSDT,7,8),RRXLFDT=$P($P(RRXDAT,U,8),"."),RRXLFDT1=$E(RRXLFDT,5,6)_"-"_$E(RRXLFDT,7,8)
"RTN","PSOORUT1",94,0)
 ...S IEN=$G(IEN)+1,PSORCNT=PSORCNT+1
"RTN","PSOORUT1",95,0)
 ...S (RRXDNSP,RRXISP)=""
"RTN","PSOORUT1",96,0)
 ...S RRXQSP=" "_STATABBR
"RTN","PSOORUT1",97,0)
 ...S $P(RRXISP," ",14-$L(RRXIEN))=" "  ; length of Rx# varies
"RTN","PSOORUT1",98,0)
 ...S:RRXDNL+RRXQTYL>39 BDNAME=$E(BDNAME,1,$L(BDNAME)-(RRXDNL+RRXQTYL-39)),RRXDNL=$L(BDNAME)
"RTN","PSOORUT1",99,0)
 ...S $P(RRXDNSP," ",40-RRXQTYL-RRXDNL)=" "
"RTN","PSOORUT1",100,0)
 ...S $P(RRXQSP," ",4)=""
"RTN","PSOORUT1",101,0)
 ...I $L(STATABBR)=2 S RRXQSP=$E(RRXQSP,1,$L(RRXQSP)-1)
"RTN","PSOORUT1",102,0)
 ...S ^TMP("PSOPF",$J,IEN,0)=$J(PSORCNT,2)_$S($L(PSORCNT)<3:" ",1:"")_RRXIEN_RRXISP_BDNAME_RRXDNSP_RRXQTY_RRXQSP_RRXISSDT1_" "
"RTN","PSOORUT1",103,0)
 ...S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_RRXLFDT1_$S($L(RREFILLS)=1:"   ",$L(RREFILLS=2):"  ")_RREFILLS_$S($L(RRXDSUPP=2):"  ",$L(RXDUPP=1):"   ",1:" ")_RRXDSUPP
"RTN","PSOORUT1",104,0)
 ...S PSORRLST(PSORCNT)=IEN
"RTN","PSOORUT1",105,0)
 ...; PSO*7*454 - Need to specify this differently for remote rx's.
"RTN","PSOORUT1",106,0)
 ...; BWF 20161110 - LOOKING AT COUNT/DISPLAY
"RTN","PSOORUT1",107,0)
 ...;S PSOLST(PSOCNT)="R52^"_RRXIEN_U_"REMOTE"_U_REMSITE
"RTN","PSOORUT1",108,0)
 ...S PSOLST(PSORCNT)="R52^"_RRXIEN_U_"REMOTE"_U_REMSITE
"RTN","PSOORUT1",109,0)
 S (VALMCNT,PSOPF)=IEN
"RTN","PSOORUT1",110,0)
SHOWX K DIRUT,DTOUT,DUOUT,DIROUT,PSODRG
"RTN","PSOORUT1",111,0)
 Q
"RTN","PSOORUT1",112,0)
 ;
"RTN","PSOORUT1",113,0)
DISPL S IEN=IEN+1 N PSOID,PSOCMOP,STATLTH,ECME,TITRX,ORNUM,ERXIEN
"RTN","PSOORUT1",114,0)
 K PSOLNT,PSOQTL,PSOLSP S PSOLRX=$S($G(^PSRX(+PSODATA,"IB")):13,1:14)-$L($P(^PSRX(+PSODATA,0),"^")),$P(PSOLNT," ",PSOLRX)=" ",PSODQL=$L($P(PSODRG,"^"))+$L($P(^PSRX(+PSODATA,0),"^",7))
"RTN","PSOORUT1",115,0)
 I PSODQL<39 S $P(PSOQTL," ",(40-PSODQL))=" "
"RTN","PSOORUT1",116,0)
 E  S $P(PSOQTL," ",(52-$L($P(^PSRX(+PSODATA,0),"^",7))))=" ",$P(PSOLSP," ",(41-$L($P(PSODRG,"^"))))=" "
"RTN","PSOORUT1",117,0)
 S ECME=$$ECME^PSOBPSUT(+PSODATA) I ECME'="" S PSOLNT=$E(PSOLNT,1,$L(PSOLNT)-1)
"RTN","PSOORUT1",118,0)
 S TITRX=$$TITRX^PSOUTL(+PSODATA) I TITRX'="" S PSOLNT=$E(PSOLNT,1,$L(PSOLNT)-1)
"RTN","PSOORUT1",119,0)
 ; PSO*7*508 - eRx check and addition of the '&' character for eRx prescriptions and split line due to xindex lentgh failure
"RTN","PSOORUT1",120,0)
 S ORNUM=$$GET1^DIQ(52,+PSODATA,39.3,"I")
"RTN","PSOORUT1",121,0)
 I ORNUM S ERXIEN=$$CHKERX^PSOERXU1(ORNUM) I $G(ERXIEN) S PSOLNT=$E(PSOLNT,1,$L(PSOLNT)-2)
"RTN","PSOORUT1",122,0)
 S ^TMP("PSOPF",$J,IEN,0)=$J(PSOCNT,2)_$S($L(PSOCNT)<3:" ",1:"")_$S($G(ERXIEN):"& ",1:"")_$P(^PSRX(+PSODATA,0),"^")
"RTN","PSOORUT1",123,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$S($G(^PSRX(+PSODATA,"IB")):"$",1:"")_ECME_TITRX_PSOLNT_$P(PSODRG,"^")_$S(PSODQL<39:PSOQTL_$P(^PSRX(+PSODATA,0),"^",7)_" ",1:$G(PSOLSP))
"RTN","PSOORUT1",124,0)
 ; PSO*7*508 - end eRx modification - consider also checking the Rx index in 52.49 for further accuracy
"RTN","PSOORUT1",125,0)
 S STA="A^N^R^H^N^S^^^^^^E^DC^^DP^DE^HP^P^"
"RTN","PSOORUT1",126,0)
 S PSOCMOP=""
"RTN","PSOORUT1",127,0)
 I $D(^PSDRUG("AQ",$P(^PSRX(+PSODATA,0),"^",6))) S PSOCMOP=">"
"RTN","PSOORUT1",128,0)
 N X S X="PSXOPUTL" X ^%ZOSF("TEST") K X I $T D
"RTN","PSOORUT1",129,0)
 .N DA S DA=+PSODATA D ^PSXOPUTL K DA
"RTN","PSOORUT1",130,0)
 .I $G(PSXZ(PSXZ("L")))=0!($G(PSXZ(PSXZ("L")))=2) S PSOCMOP="T"
"RTN","PSOORUT1",131,0)
 .K PSXZ
"RTN","PSOORUT1",132,0)
 S (STA,STATLTH)=$P(STA,"^",$P(PSODATA,"^",2)+1) D
"RTN","PSOORUT1",133,0)
 .I $G(^PSRX(+PSODATA,"DDSTA"))]"" S (STATLTH,STA)="DD" Q
"RTN","PSOORUT1",134,0)
 .S (STATLTH,STA)=$S($P($G(^PSRX(+PSODATA,7)),"^")=1:"DA",$P($G(^PSRX(+PSODATA,7)),"^")=2:"DF",1:STA)
"RTN","PSOORUT1",135,0)
 S STAPRT=STA_PSOCMOP,STATLTH=$L(STAPRT)
"RTN","PSOORUT1",136,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_STAPRT_$S(STATLTH=0:"   ",STATLTH=1:"  ",STATLTH=2:" ",1:"")
"RTN","PSOORUT1",137,0)
 S PSOID=$P(^PSRX(+PSODATA,0),"^",13),PSOLF=+$G(^(3)),^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$E(PSOID,4,5)_"-"_$E(PSOID,6,7)_" "
"RTN","PSOORUT1",138,0)
 N RFLZRO,PSOLRD S PSOLRD=$P($G(^PSRX(+PSODATA,2)),"^",13)
"RTN","PSOORUT1",139,0)
 F PSOX=0:0 S PSOX=$O(^PSRX(+PSODATA,1,PSOX)) Q:'PSOX  D
"RTN","PSOORUT1",140,0)
 . S RFLZRO=$G(^PSRX(+PSODATA,1,PSOX,0))
"RTN","PSOORUT1",141,0)
 . I +RFLZRO=PSOLF,$P(RFLZRO,"^",16) S PSOLF=PSOLF_"^R"
"RTN","PSOORUT1",142,0)
 . S:$P(RFLZRO,"^",18)'="" PSOLRD=$P(RFLZRO,"^",18) I $P(RFLZRO,"^",16) S PSOLRD=PSOLRD_"^R"
"RTN","PSOORUT1",143,0)
 K PSOX
"RTN","PSOORUT1",144,0)
 I '$O(^PSRX(+PSODATA,1,0)),$P(^PSRX(+PSODATA,2),"^",15) S PSOLF=PSOLF_"^R",PSOLRD=PSOLRD_"^R"
"RTN","PSOORUT1",145,0)
 S PSOLF=$S($G(PSOLF):$E(PSOLF,4,5),1:"  ")_"-"_$S($G(PSOLF):$E(PSOLF,6,7),1:"  ")_$S($P(PSOLF,"^",2)="R":"R ",1:"  ")
"RTN","PSOORUT1",146,0)
 S PSOLRD=$S($G(PSOLRD):$E(PSOLRD,4,5),1:"  ")_"-"_$S($G(PSOLRD):$E(PSOLRD,6,7),1:"  ")_$S($P(PSOLRD,"^",2)="R":"R ",1:"  ")
"RTN","PSOORUT1",147,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$S($G(PSORFG):PSOLRD,1:PSOLF)
"RTN","PSOORUT1",148,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$J($P(PSODATA,"^",6),2)_" "_$J($P(PSODATA,"^",8),3)
"RTN","PSOORUT1",149,0)
 ;recently dc'd rxs
"RTN","PSOORUT1",150,0)
 I $P($G(^PSRX(+PSODATA,3)),"^",5) D  K X
"RTN","PSOORUT1",151,0)
 .S X2=$S($P(PSOPAR,"^",33):$P(PSOPAR,"^",33),1:7),X1=$P(^PSRX(+PSODATA,3),"^",5) D C^%DTC
"RTN","PSOORUT1",152,0)
 .I DT<X S PSODCREV(IEN)=IEN
"RTN","PSOORUT1",153,0)
 ;recently expired rxs
"RTN","PSOORUT1",154,0)
 I $P($G(^PSRX(+PSODATA,2)),"^",6)<DT,'$P($G(^PSRX(+PSODATA,3)),"^",5) D  K X
"RTN","PSOORUT1",155,0)
 .S X2=$S($P(PSOPAR,"^",33):$P(PSOPAR,"^",33),1:7),X1=$P(^PSRX(+PSODATA,2),"^",6) D C^%DTC
"RTN","PSOORUT1",156,0)
 .I DT<X S PSODCREV(IEN)=IEN
"RTN","PSOORUT1",157,0)
 ;
"RTN","PSOORUT1",158,0)
 I (PSODQL>38)!$$BADADDFL^PSOUTIL(+PSODATA) D
"RTN","PSOORUT1",159,0)
 .S IEN=IEN+1
"RTN","PSOORUT1",160,0)
 .I PSODQL>38 S ^TMP("PSOPF",$J,IEN,0)=PSOQTL_"Qty: "_$P(^PSRX(+PSODATA,0),"^",7)
"RTN","PSOORUT1",161,0)
 .I $$BADADDFL^PSOUTIL(+PSODATA) S $E(^TMP("PSOPF",$J,IEN,0),61)="*** Bad Address ***"
"RTN","PSOORUT1",162,0)
 ;
"RTN","PSOORUT1",163,0)
 K PSOLNT,PSOQTL,PSOLSP,PSOLRX,PSODQL
"RTN","PSOORUT1",164,0)
 S PSOLST(PSOCNT)="52^"_+PSODATA_"^"_PSOSTA
"RTN","PSOORUT1",165,0)
 K PSODATA,PSOLF S PSOPF=IEN
"RTN","PSOORUT1",166,0)
 Q
"RTN","PSOORUT1",167,0)
 ;
"RTN","PSOORUT1",168,0)
STA N LABEL,LINE,POS
"RTN","PSOORUT1",169,0)
 S LABEL=PSOSTS,IEN=IEN+1
"RTN","PSOORUT1",170,0)
 I PSOSTS="ZNONVA" S LABEL="Non-VA MEDS (Not dispensed by VA)"
"RTN","PSOORUT1",171,0)
 I PSOSTS=" REJECT" S LABEL="REFILL TOO SOON/DUR REJECTS (Third Party)"
"RTN","PSOORUT1",172,0)
 I PSOSTS=" REJECT2" S LABEL="OTHER REJECTS PENDING RESOLUTION"  ;PSO*7*427 added new section
"RTN","PSOORUT1",173,0)
 S POS=80-$L(LABEL)/2,$P(LINE,"-",81)="",$E(LINE,POS+1,POS+$L(LABEL))=LABEL
"RTN","PSOORUT1",174,0)
 S ^TMP("PSOPF",$J,IEN,0)=LINE
"RTN","PSOORUT1",175,0)
 Q
"RTN","PSOORUT1",176,0)
PENX S PSOLST(PSOCNT)="52.41^"_$P(PSODATA,"^",10)_"^"_PSOSTA
"RTN","PSOORUT1",177,0)
 K PSODATA,PSOLF,RN,PSOLSP,PSOQTL,PSOLNT
"RTN","PSOORUT1",178,0)
 Q
"RTN","PSOORUT1",179,0)
PEN ;
"RTN","PSOORUT1",180,0)
 N PSOQTL,PSOLNT,PSOLNTZ,PSOQTLX,PSCMOPF,SPACEZ,ORNUM,ERXIEN
"RTN","PSOORUT1",181,0)
 Q:'$D(^PS(52.41,$P(PSODATA,"^",10),0))
"RTN","PSOORUT1",182,0)
 S PSCMOPF=0 I $P($G(PSODATA),"^",11),$D(^PSDRUG("AQ",$P(PSODATA,"^",11))) S PSCMOPF=1
"RTN","PSOORUT1",183,0)
 ; PSO*7*508 - eRx check and addition of the '&' character for eRx prescriptions
"RTN","PSOORUT1",184,0)
 S ORNUM=$$GET1^DIQ(52.41,$P(PSODATA,U,10),.01,"I")
"RTN","PSOORUT1",185,0)
 I ORNUM S ERXIEN=$$CHKERX^PSOERXU1(ORNUM)
"RTN","PSOORUT1",186,0)
 S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)=$J(PSOCNT,2)_$S($L(PSOCNT)<3:" ",1:"")_$S($G(ERXIEN):"& ",1:"")_$P(PSODRG,"^")
"RTN","PSOORUT1",187,0)
 ; PSO*7*508 - end eRx modification
"RTN","PSOORUT1",188,0)
 I $P($G(^PS(52.41,+$P(PSODATA,"^",10),0)),"^",23)=1 S ^TMP("PSOPF",$J,IEN,"RV")=""
"RTN","PSOORUT1",189,0)
 S PSOLNT=$L($P(PSODRG,"^")),PSOLNTZ=$L($P(PSODATA,"^",8))
"RTN","PSOORUT1",190,0)
 ; PSO*7*508 - adjust PSOLNT if this is an eRx
"RTN","PSOORUT1",191,0)
 I $G(ERXIEN) S PSOLNT=PSOLNT+2
"RTN","PSOORUT1",192,0)
 S $P(PSOQTLX," ",(11-PSOLNTZ))=" "
"RTN","PSOORUT1",193,0)
 S:PSOLNT<37 $P(PSOQTL," ",(37-PSOLNT))=" "
"RTN","PSOORUT1",194,0)
 I PSOLNT<38 D  G PENX
"RTN","PSOORUT1",195,0)
 .I PSOLNT=37 S PSOQTL=""
"RTN","PSOORUT1",196,0)
 .I $P(^PS(52.41,$P(PSODATA,"^",10),0),"^",3)="RF" S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$G(PSOQTL)_"  Refill Request   Rx #: "_$P(^PSRX($P(^PS(52.41,$P(PSODATA,"^",10),0),"^",19),0),"^") Q
"RTN","PSOORUT1",197,0)
 .S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$G(PSOQTL)_"  "_"QTY: "_$P(PSODATA,"^",8)_$G(PSOQTLX)_" ISDT: "_$S('$P(PSODATA,"^",9):"     ",1:$E($P(PSODATA,"^",9),4,5)_"-"_$E($P(PSODATA,"^",9),6,7))_$S($G(PSCMOPF):"> ",1:"  ")
"RTN","PSOORUT1",198,0)
 .S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_"REF: "_$S($L($P(PSODATA,"^",6))>1:"",1:" ")_$P(PSODATA,"^",6)
"RTN","PSOORUT1",199,0)
 S IEN=IEN+1,$P(SPACEZ," ",42)=" "
"RTN","PSOORUT1",200,0)
 I $P(^PS(52.41,$P(PSODATA,"^",10),0),"^",3)="RF" S ^TMP("PSOPF",$J,IEN,0)=SPACEZ_"Refill Request   Rx #: "_$P(^PSRX($P(^PS(52.41,$P(PSODATA,"^",10),0),"^",19),0),"^") G PENX
"RTN","PSOORUT1",201,0)
 S ^TMP("PSOPF",$J,IEN,0)=SPACEZ_"QTY: "_$P(PSODATA,"^",8)_$G(PSOQTLX)_" ISDT: "_$S('$P(PSODATA,"^",9):"     ",1:$E($P(PSODATA,"^",9),4,5)_"-"_$E($P(PSODATA,"^",9),6,7))_$S($G(PSCMOPF):"> ",1:"  ")_"REF: "_$S($L($P(PSODATA,"^",6))>1:"",1:" ")
"RTN","PSOORUT1",202,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$P(PSODATA,"^",6)
"RTN","PSOORUT1",203,0)
 G PENX
"RTN","PSOORUT1",204,0)
 ;
"RTN","PSOORUT1",205,0)
NVA ; Setting the Non-VA Meds on the Medication Profile Screen (ListMan)
"RTN","PSOORUT1",206,0)
 S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)="  "_$P(PSODRG,"^")_" "
"RTN","PSOORUT1",207,0)
 I ($L(^TMP("PSOPF",$J,IEN,0))+$L($P(PSODATA,"^",6))>70) S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)="    "
"RTN","PSOORUT1",208,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$P(PSODATA,"^",6)_" "
"RTN","PSOORUT1",209,0)
 I ($L(^TMP("PSOPF",$J,IEN,0))+$L($P(PSODATA,"^",8))>70) S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)="    "
"RTN","PSOORUT1",210,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$P(PSODATA,"^",8)
"RTN","PSOORUT1",211,0)
 I ($L(^TMP("PSOPF",$J,IEN,0))+20)>70 D  Q
"RTN","PSOORUT1",212,0)
 . S IEN=IEN+1,$P(^TMP("PSOPF",$J,IEN,0)," ",51)="Date Documented: "_$E($P(PSODATA,"^",9),4,5)_"/"_$E($P(PSODATA,"^",9),6,7)_"/"_$E($P(PSODATA,"^",9),2,3)
"RTN","PSOORUT1",213,0)
 F I=0:0 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_" " Q:$L(^TMP("PSOPF",$J,IEN,0))>49
"RTN","PSOORUT1",214,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_"Date Documented: "_$E($P(PSODATA,"^",9),4,5)_"/"_$E($P(PSODATA,"^",9),6,7)_"/"_$E($P(PSODATA,"^",9),2,3)
"RTN","PSOORUT1",215,0)
 Q
"RTN","PSORENW")
0^12^B49878168^B48759882
"RTN","PSORENW",1,0)
PSORENW ; BIR/SAB - renew main driver ;4/25/07 8:42am
"RTN","PSORENW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,30,46,71,96,100,130,148,206,388,390,417,313,411,508**;DEC 1997;Build 295
"RTN","PSORENW",3,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSORENW",4,0)
 ;External reference to $$L^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",5,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",6,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",7,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",8,0)
 ;External reference to LK^ORX2 supported by DBIA 867
"RTN","PSORENW",9,0)
 ;External reference to ULK^ORX2 supported by DBIA 867
"RTN","PSORENW",10,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORENW",11,0)
 ;External reference to MAIN^TIUEDIT supported by DBIA 2410
"RTN","PSORENW",12,0)
 ;
"RTN","PSORENW",13,0)
ASK ;
"RTN","PSORENW",14,0)
 K PSORENW("FILL DATE"),ZZCOPY D FILLDT^PSODIR2(.PSORENW) S:$G(PSORENW("DFLG")) VALMSG="Renew Rx request canceled",VALMBCK="R"
"RTN","PSORENW",15,0)
 I PSORENW("DFLG")!('$D(PSORENW("FILL DATE"))) S PSORENW("QFLG")=1,PSORENW("DFLG")=0 G ASKX
"RTN","PSORENW",16,0)
 S PSORNW("FILL DATE")=PSORENW("FILL DATE")
"RTN","PSORENW",17,0)
 D MW^PSOCMOPA(.PSORENW)
"RTN","PSORENW",18,0)
 I PSORENW("DFLG") S PSORENW("QFLG")=1,PSORENW("DFLG")=0 G ASKX
"RTN","PSORENW",19,0)
 S PSORNW("MAIL/WINDOW")=PSORENW("MAIL/WINDOW") S PSORX("MAIL/WINDOW")=$S(PSORENW("MAIL/WINDOW")="M":"MAIL",1:"WINDOW")
"RTN","PSORENW",20,0)
 D NOORE^PSONEW(.PSORENW) S:$G(PSORENW("DFLG")) VALMSG="Renew Rx request canceled",VALMBCK="R"
"RTN","PSORENW",21,0)
 I PSORENW("DFLG")!('$D(PSORENW("FILL DATE"))) S PSORENW("QFLG")=1,PSORENW("DFLG")=0
"RTN","PSORENW",22,0)
ASKX Q
"RTN","PSORENW",23,0)
 ;
"RTN","PSORENW",24,0)
EOJ ;
"RTN","PSORENW",25,0)
 K VERB,RTE,DRET,PSOMSG,PSORNW,PSOLIST,PSORENW,PSORX("BAR CODE"),PSORX("FILL DATE"),PSODIR,PSOID,PSONOOR,PSOCOU,PSOCOUU,PSOID,PSOFDMX,PSODRUG,COPY,PSOBCKDR
"RTN","PSORENW",26,0)
 N ZRXN
"RTN","PSORENW",27,0)
 S RXN=$O(^TMP("PSORXN",$J,0)) I RXN S ZRXN=RXN D
"RTN","PSORENW",28,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSORENW",29,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS",$P(RXN1,"^",4))
"RTN","PSORENW",30,0)
 .;saves drug allergy order chks pso*7*411
"RTN","PSORENW",31,0)
 .I $D(^TMP("PSODAOC",$J)) D  Q:$G(PSORX("DFLG"))
"RTN","PSORENW",32,0)
 ..I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSORENW",33,0)
 ..S RXN=ZRXN
"RTN","PSORENW",34,0)
 .S PSOARENW=1 D DAOC^PSONEW K PSOARENW
"RTN","PSORENW",35,0)
 I $G(PSORNEDT),'$O(^TMP("PSORXN",$J,0)),$D(^TMP("PSODAOC",$J)) S ZRXN=PSORNEDT,PSOARENW=1 D DAOC^PSONEW K PSOARENW,PSORNEDT
"RTN","PSORENW",36,0)
 K ZZCOPY,ZRXN,RXN,RXN1,^TMP("PSORXN",$J),^TMP("PSODAOC",$J)
"RTN","PSORENW",37,0)
 I $G(PSONOTE) D MAIN^TIUEDIT(3,.TIUDA,PSODFN,"","","","",1)
"RTN","PSORENW",38,0)
 K PSONOTE
"RTN","PSORENW",39,0)
 Q
"RTN","PSORENW",40,0)
OERR ;entry for renew backdoor
"RTN","PSORENW",41,0)
 N PSORNEDT
"RTN","PSORENW",42,0)
 I $$TITRX^PSOUTL($P(PSOLST(ORN),"^",2))="t" D  Q
"RTN","PSORENW",43,0)
 . S VALMSG="Cannot Renew a 'Titration Rx'.",VALMBCK="R" W $C(7)
"RTN","PSORENW",44,0)
 I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2),,.VALMSG,.VALMBCK) Q
"RTN","PSORENW",45,0)
 ; PSO*7*508 - check if the Rx is an eRx. If so, inform the user and ask to proceed.
"RTN","PSORENW",46,0)
 N ERXORN,ERXIEN,ERXPROC S ERXORN=$$GET1^DIQ(52,$P(PSOLST(ORN),U,2),39.3)
"RTN","PSORENW",47,0)
 S ERXIEN=$$CHKERX^PSOERXU1(ERXORN)
"RTN","PSORENW",48,0)
 I ERXIEN D FULL^VALM1 S ERXPROC=$$PROVPMT^PSOERXU1(ERXIEN) Q:'ERXPROC
"RTN","PSORENW",49,0)
 ; PSO*7*508 - end
"RTN","PSORENW",50,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSORENW",51,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSORENW",52,0)
 K PSOID,PSOFDMX,PSORX("FILL DATE"),PSORENW("FILL DATE"),PSORX("QS"),PSORENW("QS"),PSOBARCD,COPY
"RTN","PSORENW",53,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG D ULPAT Q
"RTN","PSORENW",54,0)
 S PSOBCKDR=1,PSOFROM="NEW",PSORENW("OIRXN")=$P(PSOLST(ORN),"^",2),PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"),PSORX("DFLG"))=0
"RTN","PSORENW",55,0)
 S PSONEW("DAYS SUPPLY")=$P(^PSRX(PSORENW("OIRXN"),0),"^",8),PSONEW("# OF REFILLS")=$P(^(0),"^",9)
"RTN","PSORENW",56,0)
 D FULL^VALM1,ASK D:PSORENW("QFLG") KLIB^PSORENW1 D:PSORENW("QFLG") ULPAT D:PSORENW("QFLG") PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) G:PSORENW("QFLG") EOJ D ^PSORENW0
"RTN","PSORENW",57,0)
 D ULPAT,EOJ,KLIB^PSORENW1 K PSOOPT,PSONEW,PSORX("DFLG"),X,Y
"RTN","PSORENW",58,0)
 Q
"RTN","PSORENW",59,0)
ULPAT K PSOMSG D UL^PSSLOCK(PSODFN) S X=PSODFN_";DPT(" D ULK^ORX2 K X
"RTN","PSORENW",60,0)
 Q
"RTN","PSORENW",61,0)
RENEW(PLACER,PSOCPDRG) ;passes flag to CPRS for front door renews
"RTN","PSORENW",62,0)
 ;-1=couldn't find order, 0=unable to renew, 1=renewable
"RTN","PSORENW",63,0)
 ;Placer=Pharmacy number
"RTN","PSORENW",64,0)
 N PSOSURX,PSORFRM,PSOLC,PSODRG,PSODRUG0,RXN,ST,PSONEWOI,PSOOLDOI,PSOIFLAG,PSOINA,RX0,X1,X2
"RTN","PSORENW",65,0)
 I $G(PLACER)["S"!('$G(PLACER)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSORENW",66,0)
 S RXN=PLACER I '$D(^PSRX(RXN,0)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSORENW",67,0)
 S RX0=^PSRX(RXN,0),PSODRG=+$P(^PSRX(RXN,0),"^",6),ST=+^("STA"),PSODRUG0=^PSDRUG(PSODRG,0)
"RTN","PSORENW",68,0)
 S PSOIFLAG=0,PSOOLDOI=+$P($G(^PSRX(RXN,"OR1")),"^"),PSONEWOI=+$P($G(^PSDRUG(+$G(PSODRG),2)),"^") I PSONEWOI,PSONEWOI'=PSOOLDOI S PSOIFLAG=1
"RTN","PSORENW",69,0)
 S PSOINA=$P($G(^PS(50.7,PSONEWOI,0)),"^",4)
"RTN","PSORENW",70,0)
 I PSOINA,DT>PSOINA Q "0^This Orderable Item has been Inactivated."
"RTN","PSORENW",71,0)
 I ST=5 S PSOSURX=$O(^PS(52.5,"B",RXN,0)) I PSOSURX,$P($G(^PS(52.5,PSOSURX,0)),"^",7)="L" Q "0^Rx loading into a CMOP Transmission."
"RTN","PSORENW",72,0)
 S X1=DT,X2=-120 D C^%DTC I $P($G(^PSRX(RXN,2)),"^",6)<X Q "0^Prescription Expired more than 120 Days."
"RTN","PSORENW",73,0)
 S X1=DT,X2=-120 D C^%DTC I $P($G(^PSRX(RXN,3)),"^",5),$P($G(^(3)),"^",5)<X,$P(^("STA"),"^")=12 Q "0^Prescription Discontinued more than 120 Days."
"RTN","PSORENW",74,0)
 I $G(PSOCPDRG),$G(PSOCPDRG)'=$G(PSODRG) Q "0^Drug Mismatch, Non-Renewable."
"RTN","PSORENW",75,0)
 N PSOOCPRX,PSOOLPF,PSOOLPD,PSONOSIG S PSOOCPRX=RXN D CDOSE^PSORENW0 I PSOOLPF Q "0^Non-Renewable, invalid Dosage of "_$G(PSOOLPD)
"RTN","PSORENW",76,0)
 I PSONOSIG Q "0^Non-Renewable, missing Sig."
"RTN","PSORENW",77,0)
 I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" Q "0^Drug is No longer used by Outpatient Pharmacy."
"RTN","PSORENW",78,0)
 I $G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) Q "0^This Drug has been Inactivated."
"RTN","PSORENW",79,0)
 I ($P(PSODRUG0,"^",3)[1)!($P(PSODRUG0,"^",3)[2)!($P(PSODRUG0,"^",3)["W") Q "0^Non-Renewable "_$S($P(PSODRUG0,"^",3)["A":"Drug Narcotic.",1:"Drug.")
"RTN","PSORENW",80,0)
 I $D(^PS(53,+$P(RX0,"^",3),0)),'$P(^(0),"^",5) Q "0^Non-Renewable Prescription."
"RTN","PSORENW",81,0)
 S PSOLC=$P(RX0,"^"),PSOLC=$E(PSOLC,$L(PSOLC)) I $A(PSOLC)'<90 Q "0^Max number of renewals (26) has been reached."
"RTN","PSORENW",82,0)
 I ST,ST'=2,ST'=5,ST'=6,ST'=11,ST'=12,ST'=14 Q "0^Prescription is in a Non-Renewable Status."
"RTN","PSORENW",83,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",4) Q "0^Duplicate Rx Renewal Request."
"RTN","PSORENW",84,0)
 I $O(^PS(52.41,"AQ",RXN,0)) Q "0^Duplicate Rx Renewal Request."
"RTN","PSORENW",85,0)
 N TITMSG
"RTN","PSORENW",86,0)
 I $$TITRX^PSOUTL(RXN)="t" D  Q TITMSG
"RTN","PSORENW",87,0)
 . S TITMSG="0^Prescription was marked as 'Titration to Maintenance Dose' by Pharmacy and cannot be renewed."
"RTN","PSORENW",88,0)
 . S TITMSG=TITMSG_" To repeat the titration, enter a new prescription or copy the prior titration order."
"RTN","PSORENW",89,0)
 . S TITMSG=TITMSG_" To continue the maintenance dose, refill this prescription if refills are available"
"RTN","PSORENW",90,0)
 . S TITMSG=TITMSG_" or enter a new prescription for the maintenance dose."
"RTN","PSORENW",91,0)
 K PSORFRM,PSOLC,PSODRG,PSODRUG0,RXN,ST,TITMSG
"RTN","PSORENW",92,0)
 Q 1_$S($G(PSOIFLAG):"^"_$G(PSONEWOI),1:"")
"RTN","PSORENW",93,0)
 ;
"RTN","PSORENW",94,0)
INST1 ;Set Pharmacy Instructions array
"RTN","PSORENW",95,0)
 N PSOTZ
"RTN","PSORENW",96,0)
 I $O(^PSRX(RXN,"PI",0)) S PHI=$G(^PSRX(RXN,"PI",0)),PSOTZ=0 D
"RTN","PSORENW",97,0)
 .F  S PSOTZ=$O(^PSRX(RXN,"PI",PSOTZ)) Q:PSOTZ=""  S PHI(PSOTZ)=$G(^PSRX(RXN,"PI",PSOTZ,0))
"RTN","PSORENW",98,0)
 Q
"RTN","PSORENW",99,0)
INST2 ;Set Instructions and Comments
"RTN","PSORENW",100,0)
 I '$G(PSORENW("OIRXN")) Q
"RTN","PSORENW",101,0)
 I $G(PSOFDR) Q
"RTN","PSORENW",102,0)
 N PSOPHL,PSOPRL
"RTN","PSORENW",103,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PI",0)) K PHI S PHI=$G(^PSRX(PSORENW("OIRXN"),"PI",0)),PSOPHL="" D
"RTN","PSORENW",104,0)
 .F  S PSOPHL=$O(^PSRX(PSORENW("OIRXN"),"PI",PSOPHL)) Q:PSOPHL=""  S PHI(PSOPHL)=$G(^PSRX(PSORENW("OIRXN"),"PI",PSOPHL,0))
"RTN","PSORENW",105,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PRC",0)) K PRC S PRC=$G(^PSRX(PSORENW("OIRXN"),"PRC",0)),PSOPRL="" D
"RTN","PSORENW",106,0)
 .F  S PSOPRL=$O(^PSRX(PSORENW("OIRXN"),"PRC",PSOPRL)) Q:PSOPRL=""  S PRC(PSOPRL)=$G(^PSRX(PSORENW("OIRXN"),"PRC",PSOPRL,0))
"RTN","PSORENW",107,0)
 Q
"RTN","PSORENW4")
0^13^B68530272^B73245534
"RTN","PSORENW4",1,0)
PSORENW4 ;BIR/SAB - rx speed renew ;03/06/95
"RTN","PSORENW4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,37,64,46,75,71,100,130,117,152,148,264,225,301,390,313,411,444,508**;DEC 1997;Build 295
"RTN","PSORENW4",3,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSORENW4",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORENW4",5,0)
 ;External reference to $$L^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",6,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",7,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",8,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",9,0)
 ;External reference to LK^ORX2 supported by DBIA 867
"RTN","PSORENW4",10,0)
 ;External reference to ULK^ORX2 supported by DBIA 867
"RTN","PSORENW4",11,0)
SEL K PSODRUG ;PSO*7*301
"RTN","PSORENW4",12,0)
 N PSOSPRNW,PSOIBOLD S PSOSPRNW=1
"RTN","PSORENW4",13,0)
 I $P(PSOPAR,"^",4)=0 S VALMSG="Renewing is NOT Allowed. Check Site Parameters!",VALMBCK="" Q
"RTN","PSORENW4",14,0)
 N VALMCNT I '$G(PSOCNT) S VALMSG="This patient has no Prescriptions!",VALMBCK="" Q
"RTN","PSORENW4",15,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSORENW4",16,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSORENW4",17,0)
 K PRC,PHI,PSORX("EDIT"),PSOFDR,DIR,DUOUT,DIRUT,PSORNSPD S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DUOUT S VALMBCK="" G SELQ
"RTN","PSORENW4",18,0)
 K DIR,DIRUT,DTOUT,PSOOELSE,DTOUT I +Y S (SPEED,PSOOELSE,PSORNSPD)=1 D FULL^VALM1 S LST=Y D
"RTN","PSORENW4",19,0)
 .S (PSODIR("DFLG"),PSODIR("FIELD"))=0,PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"),PSORX("DFLG"))=0 D INIT Q:PSORENW("DFLG")
"RTN","PSORENW4",20,0)
 .F ORD=1:1:$L(LST,",") Q:$P(LST,",",ORD)']""  S ORN=$P(LST,",",ORD) D:+PSOLST(ORN)=52 PROCESS S (PSOQUIT,PSORENW("DFLG"),POERR,POERR("DFLG"),PSORX("DFLG"))=0
"RTN","PSORENW4",21,0)
 I '$G(PSOOELSE) S VALMBCK="" G SELQ
"RTN","PSORENW4",22,0)
 S VALMBCK="R"
"RTN","PSORENW4",23,0)
 D ^PSOBUILD,BLD^PSOORUT1 K DIR,DIRUT,DTOUT,DUOUT,LST,ORD,IEN,ORN,RPH,ST,REFL,REF,PSOACT,ORSV,PSORNW,PSORENW,PSONO,PSOCO,PSOCU,PSODIR,DSMSG,SPEED,PSORENW,PSOOELSE,PSOOPT,PSORX("FILL DATE"),PSORX("ISSUE DATE"),PSOID,PSOMSG,PSORX("DFLG"),PSOQTY
"RTN","PSORENW4",24,0)
SELQ K PSORNSPD,RTE,DRET,PRC,PHI,PSOSPRNW,X S X=PSODFN_";DPT(" D ULK^ORX2,UL^PSSLOCK(PSODFN),CLEAN^PSOVER1
"RTN","PSORENW4",25,0)
 Q
"RTN","PSORENW4",26,0)
 ;
"RTN","PSORENW4",27,0)
PROCESS ; Process one order at a time
"RTN","PSORENW4",28,0)
 ;W !!,"Now Renewing Rx # "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_"   Drug: "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),6),!
"RTN","PSORENW4",29,0)
 I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2)) D  K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",30,0)
 . W $C(7),!,"Rx "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_" has OPEN/UNRESOLVED 3rd Party Payer Rejects!"
"RTN","PSORENW4",31,0)
 I $$TITRX^PSOUTL($P(PSOLST(ORN),"^",2))="t" D  K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",32,0)
 . W $C(7),!,"Rx# "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_" is marked as 'Titration Rx' and cannot be renewed."
"RTN","PSORENW4",33,0)
 ; PSO*7*508 - check if the Rx is an eRx. If so, inform the user and ask to proceed.
"RTN","PSORENW4",34,0)
 N ERXORN,ERXIEN,ERXPROC S ERXORN=$$GET1^DIQ(52,$P(PSOLST(ORN),U,2),39.3)
"RTN","PSORENW4",35,0)
 S ERXIEN=$$CHKERX^PSOERXU1(ERXORN)
"RTN","PSORENW4",36,0)
 I ERXIEN S ERXPROC=$$PROVPMT^PSOERXU1(ERXIEN) Q:'ERXPROC
"RTN","PSORENW4",37,0)
 ; PSO*7*508 - end
"RTN","PSORENW4",38,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) W $C(7),!!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^")),! K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",39,0)
 K RET,DRET,PRC,PHI S PSORENW("OIRXN")=$P(PSOLST(ORN),"^",2),PSOFROM="NEW"
"RTN","PSORENW4",40,0)
 S PSORENW("RX0")=^PSRX(PSORENW("OIRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN")),SIGOK=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^",2)
"RTN","PSORENW4",41,0)
 I SIGOK F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),"SIG1",I)) Q:'I  S SIG(I)=^PSRX(PSORENW("OIRXN"),"SIG1",I,0)
"RTN","PSORENW4",42,0)
 S PSOIBOLD=$G(PSORENW("OIRXN")) D SETIB^PSORENW1
"RTN","PSORENW4",43,0)
 I '$G(PSORENW("PROVIDER")) D
"RTN","PSORENW4",44,0)
 .S PSORENW("PROVIDER")=$P(PSORENW("RX0"),"^",4)
"RTN","PSORENW4",45,0)
 .S:$P(PSORENW("RX3"),"^",3) PSORENW("COSIGNING PROVIDER")=$P(PSORENW("RX3"),"^",3)
"RTN","PSORENW4",46,0)
 S PSORX("PROVIDER NAME")=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSORENW4",47,0)
 I '$G(PSORENW("CLINIC")) S PSORENW("CLINIC")=$P(PSORENW("RX0"),"^",5)
"RTN","PSORENW4",48,0)
 S PSORENW("REMARKS")="RENEWED FROM RX # "_$P(PSORENW("RX0"),"^")
"RTN","PSORENW4",49,0)
 S PSORENW("SIG")=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^")
"RTN","PSORENW4",50,0)
 S PSORENW("PSODFN")=$P(PSORENW("RX0"),"^",2)
"RTN","PSORENW4",51,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSORENW4",52,0)
 S PSORENW("DRUG IEN")=$P(PSORENW("RX0"),"^",6)
"RTN","PSORENW4",53,0)
 S PSORENW("QTY")=$P(PSORENW("RX0"),"^",7)
"RTN","PSORENW4",54,0)
 S PSORENW("INS")=$S($G(PSORENW("ENT"))]"":PSORENW("ENT"),1:$G(^PSRX(PSORENW("OIRXN"),"INS")))
"RTN","PSORENW4",55,0)
 S:$G(PSORENW("ENT"))']"" PSORENW("ENT")=0
"RTN","PSORENW4",56,0)
 N I F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),6,I)) Q:'I  S DOSE=^PSRX(PSORENW("OIRXN"),6,I,0) D
"RTN","PSORENW4",57,0)
 .S PSORENW("ENT")=PSORENW("ENT")+1,PSORENW("DOSE",PSORENW("ENT"))=$P(DOSE,"^")
"RTN","PSORENW4",58,0)
 .S PSORENW("UNITS",PSORENW("ENT"))=$P(DOSE,"^",3),PSORENW("DOSE ORDERED",PSORENW("ENT"))=$P(DOSE,"^",2),PSORENW("ROUTE",PSORENW("ENT"))=$P(DOSE,"^",7)
"RTN","PSORENW4",59,0)
 .S PSORENW("SCHEDULE",PSORENW("ENT"))=$P(DOSE,"^",8),PSORENW("DURATION",PSORENW("ENT"))=$P(DOSE,"^",5),PSORENW("CONJUNCTION",PSORENW("ENT"))=$P(DOSE,"^",6)
"RTN","PSORENW4",60,0)
 .S PSORENW("NOUN",PSORENW("ENT"))=$P(DOSE,"^",4),PSORENW("VERB",PSORENW("ENT"))=$P(DOSE,"^",9)
"RTN","PSORENW4",61,0)
 .I $G(^PSRX(PSORENW("OIRXN"),6,I,1))]"" S PSORENW("ODOSE",PSORENW("ENT"))=^PSRX(PSORENW("OIRXN"),6,I,1)
"RTN","PSORENW4",62,0)
 .K DOSE
"RTN","PSORENW4",63,0)
 I $P($G(^PSDRUG(PSORENW("DRUG IEN"),"CLOZ1")),"^")="PSOCLO1" N PSON S PSON=0 D  I PSON K PSON D POZ,KLIB^PSORENW1 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSORENW4",64,0)
 . I '$L($P(^VA(200,PSORENW("PROVIDER"),"PS"),"^",2)),'$L($P(^VA(200,PSORENW("PROVIDER"),"PS"),"^",3)) D  Q
"RTN","PSORENW4",65,0)
 . . S PSON=1 W $C(7),!!,"Only providers with DEA# or a VA# can write prescriptions for clozapine.",!
"RTN","PSORENW4",66,0)
 . I '$D(^XUSEC("YSCL AUTHORIZED",PSORENW("PROVIDER"))) D 
"RTN","PSORENW4",67,0)
 . . S PSON=1 W $C(7),!!,"Provider must hold YSCL AUTHORIZED key to write prescriptions for clozapine.",!
"RTN","PSORENW4",68,0)
 I $G(PSORNW("MAIL/WINDOW"))]"" S PSORENW("MAIL/WINDOW")=PSORNW("MAIL/WINDOW")
"RTN","PSORENW4",69,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PI",0)) D  K T
"RTN","PSORENW4",70,0)
 .S PHI=^PSRX(PSORENW("OIRXN"),"PI",0),T=0
"RTN","PSORENW4",71,0)
 .F  S T=$O(^PSRX(PSORENW("OIRXN"),"PI",T)) Q:'T  S PHI(T)=^PSRX(PSORENW("OIRXN"),"PI",T,0)
"RTN","PSORENW4",72,0)
 W !!,"Now Renewing Rx # "_PSORENW("ORX #")_"   Drug: "_$P($G(^PSDRUG(+$G(PSORENW("DRUG IEN")),0)),"^"),!
"RTN","PSORENW4",73,0)
 I '$P($G(^PSDRUG($P(PSORENW("RX0"),"^",6),2)),"^") D  G:$G(PSORENW("DFLG")) PROCESSX
"RTN","PSORENW4",74,0)
 .I $P($G(^PSRX(PSORENW("OIRXN"),"OR1")),"^") S PSODRUG("OI")=$P(^PSRX(PSORENW("OIRXN"),"OR1"),"^"),PSODRUG("OIN")=$P(^PS(50.7,+^("OR1"),0),"^") Q
"RTN","PSORENW4",75,0)
 .W !!,"Cannot Renew!!  No Pharmacy Orderable Item!" S VALMSG="Cannot Renew!!  No Pharmacy Orderable Item!",PSORX("DFLG")=1
"RTN","PSORENW4",76,0)
 D POZ
"RTN","PSORENW4",77,0)
 D CHECK^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",78,0)
 D FILDATE^PSORENW0
"RTN","PSORENW4",79,0)
 D DRUG^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",80,0)
 D RXN^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",81,0)
 D STOP^PSORENW1
"RTN","PSORENW4",82,0)
DSPL K PSOEDT,PSOLM,BBFLG,BBRX,BINGCRT,BINGRTE S PSDY=PSORENW("DAYS SUPPLY"),PSRF=PSORENW("# OF REFILLS")
"RTN","PSORENW4",83,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S PSODIR("CS")=1
"RTN","PSORENW4",84,0)
 N MXRFLS
"RTN","PSORENW4",85,0)
 S MXRFLS=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),+$G(PSORENW("DAYS SUPPLY")),+$P(^PSRX(PSORENW("OIRXN"),0),"^",3),.CLOZPAT)
"RTN","PSORENW4",86,0)
 I MXRFLS<PSORENW("# OF REFILLS") S PSORENW("# OF REFILLS")=MXRFLS
"RTN","PSORENW4",87,0)
 D DSPLY^PSORENW3 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",88,0)
 D:$D(^XUSEC("PSORPH",DUZ))!('$P(PSOPAR,"^",2)) VER1^PSOORNE4(.PSORENW) G:PSORENW("DFLG")=1 PROCESSX
"RTN","PSORENW4",89,0)
 I $G(PSOQTY) D QTY^PSODIR1(.PSORENW) G:PSORENW("DFLG")=1 PROCESSX
"RTN","PSORENW4",90,0)
 D EN^PSORN52(.PSORENW)
"RTN","PSORENW4",91,0)
 D RNPSOSD^PSOUTIL
"RTN","PSORENW4",92,0)
 D CAN^PSORENW0,DCORD^PSONEW2
"RTN","PSORENW4",93,0)
 S PSORENW("# OF REFILLS")=PSRF K PSDY,PSRF,PSODIR("CS"),DEA,PSORENW("ENT")
"RTN","PSORENW4",94,0)
 S BBRN="",BBRN1=$O(^PSRX("B",PSORENW("NRX #"),BBRN)) I $P($G(^PSRX(BBRN1,0)),"^",11)["W" S BINGCRT="Y",BINGRTE="W",BBFLG=1,BBRX(1)=$G(BBRX(1))_BBRN1_","
"RTN","PSORENW4",95,0)
PROCESSX I PSORENW("DFLG") D
"RTN","PSORENW4",96,0)
 .K PHI,PRC,PSODRUG,SIG,PSORXED,SIGOK
"RTN","PSORENW4",97,0)
 .K PSORENW("DOSE"),PSORENW("DURATION"),PSORENW("DRUG IEN"),PSORENW("ENT"),PSORENW("INS"),PSORENW("NOUN"),PSORENW("ROUTE"),PSORENW("SCHEDULE"),PSORENW("SIG"),PSORENW("VERB"),PSORENW("UNITS")
"RTN","PSORENW4",98,0)
 .I '$G(POERR) W !,$C(7),"Rx NOT RENEWED. RENEWED RX DELETED",! S POERR("DFLG")=1 D CLEAN^PSOVER1,POZ
"RTN","PSORENW4",99,0)
 K PSORDLOK I PSORENW("DFLG") S PSORDLOK=1
"RTN","PSORENW4",100,0)
 D:$G(PSORENW("OLD FILL DATE"))]"" SUSDATEK^PSOUTIL(.PSORENW)
"RTN","PSORENW4",101,0)
 K BBRN,BBRN1,PSODRUG,PSORX("PROVIDER NAME"),PSORX("CLINIC")
"RTN","PSORENW4",102,0)
 K PSOEDT,PSOLM S:$G(PSORENW("FROM"))="" (PSORENW("DFLG"),PSORENW("QFLG"))=0
"RTN","PSORENW4",103,0)
 I $G(PSORDLOK) D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSORENW4",104,0)
 D KLIB^PSORENW1
"RTN","PSORENW4",105,0)
 K PSORDLOK
"RTN","PSORENW4",106,0)
 S RXN=$O(^TMP("PSORXN",$J,0)) I RXN N ZRXN S ZRXN=RXN D
"RTN","PSORENW4",107,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSORENW4",108,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS",$P(RXN1,"^",4))
"RTN","PSORENW4",109,0)
 .;saves drug allergy order chks pso*7*390
"RTN","PSORENW4",110,0)
 .I $D(^TMP("PSODAOC",$J,"ALLERGY")) D 
"RTN","PSORENW4",111,0)
 ..I $G(PSORX("DFLG"))!$G(PSORENW("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSORENW4",112,0)
 ..S RXN=ZRXN,PSODAOC="Rx Backdoor "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"SPEED RENEW Order Acceptance_OP"
"RTN","PSORENW4",113,0)
 ..S PSOARENW=1 D DAOC^PSONEW K PSOARENW
"RTN","PSORENW4",114,0)
 K ZRXN,RXN,RXN1,^TMP("PSORXN",$J),^TMP("PSODAOC",$J)
"RTN","PSORENW4",115,0)
 Q
"RTN","PSORENW4",116,0)
INIT ;
"RTN","PSORENW4",117,0)
 D ASK Q:PSORENW("DFLG")
"RTN","PSORENW4",118,0)
 D NOORE^PSONEW(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",119,0)
 Q
"RTN","PSORENW4",120,0)
ASK ;upfront questions
"RTN","PSORENW4",121,0)
 W !! D ISSDT^PSODIR2(.PSORENW) Q:PSORENW("DFLG")  S PSORENW("ISSUE DATE")=PSOID
"RTN","PSORENW4",122,0)
 D FILLDT^PSODIR2(.PSORENW) K PSONEW("DAYS SUPPLY"),PSONEW("# OF REFILLS") Q:PSORENW("DFLG")
"RTN","PSORENW4",123,0)
 S PSORNW("FILL DATE")=PSORENW("FILL DATE")
"RTN","PSORENW4",124,0)
 D MW^PSODIR2(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",125,0)
 D PTSTAT^PSODIR1(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",126,0)
 D DAYS^PSODIR1(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",127,0)
 S PSODRUG("DEA")=0 D REFILL^PSODIR1(.PSORENW) K PSODRUG("DEA") Q:PSORENW("DFLG")
"RTN","PSORENW4",128,0)
 K DIR,DIRUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Do you want to edit Renewed Rx(s) QTY " D ^DIR I $D(DIRUT) S PSORENW("DFLG")=1 K DIR,DIRUT Q
"RTN","PSORENW4",129,0)
 S PSOQTY=Y K DIR,DIRUT,Y
"RTN","PSORENW4",130,0)
 D CLINIC^PSODIR2(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",131,0)
 D PROV^PSODIR(.PSORENW) S:PSORENW("DFLG") PSORENW("DFLG")=0
"RTN","PSORENW4",132,0)
 Q
"RTN","PSORENW4",133,0)
 ;
"RTN","PSORENW4",134,0)
POZ ;
"RTN","PSORENW4",135,0)
 K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DTOUT
"RTN","PSORENW4",136,0)
 Q
"UP",52,52.3,-1)
52^A
"UP",52,52.3,0)
52.3
"UP",52.49,52.49101,-1)
52.49^100
"UP",52.49,52.49101,0)
52.49101
"UP",52.49,52.49201,-1)
52.49^201
"UP",52.49,52.49201,0)
52.49201
"UP",52.49,52.4949,-1)
52.49^49
"UP",52.49,52.4949,0)
52.4949
"UP",52.49,52.4955,-1)
52.49^55
"UP",52.49,52.4955,0)
52.4955
"UP",52.49,52.4961,-1)
52.49^61
"UP",52.49,52.4961,0)
52.4961
"VER")
8.0^22.2
"^DD",52,52.3,.02,0)
REASON^S^H:HOLD;U:UNHOLD;C:DISCONTINUED;E:EDIT;L:RENEWED;P:PARTIAL;R:REINSTATE;W:REPRINT;S:SUSPENDED;I:RETURNED;V:INTERVENTION;D:DELETED;A:DRUG INTERACT;B:PROCESSED;X:INTERFACE;G:PATIENT INST;K:PKI/DEA;N:DISPENSE COMPLETION;M:ECME;O:IERX;^0;2^Q
"^DD",52,52.3,.02,3)
Enter code to indicate the activity taking place for this prescription.
"^DD",52,52.3,.02,21,0)
^.001^1^1^3180611^^^^
"^DD",52,52.3,.02,21,1,0)
What was done that caused activity to happen.
"^DD",52,52.3,.02,23,0)
^.001^9^9^3180611^^^^
"^DD",52,52.3,.02,23,1,0)
Set 'H' for Hold, 'U' for Unhold, 'C' for Discontinued, 'E' for Edit,
"^DD",52,52.3,.02,23,2,0)
'L' for Lost, 'P' for Partial, 'R' for Reinstate, 'W' for Reprint,
"^DD",52,52.3,.02,23,3,0)
'S' for Suspended, 'I' for Returned to Stock, 'V' for Intervention
"^DD",52,52.3,.02,23,4,0)
'D' for Deleted, 'A' for Pending due to drug interactions, 'B' for Unpending.
"^DD",52,52.3,.02,23,5,0)
X will stand for External Interface, 'G' will indicate if patient
"^DD",52,52.3,.02,23,6,0)
instructions was added when the order was received from CPRS. 'K' for 
"^DD",52,52.3,.02,23,7,0)
PKI Certificate regarding digitally signed orders, introduced for the
"^DD",52,52.3,.02,23,8,0)
PKI/DEA project, 'N' will indicate that an Rx was dispensed by an external
"^DD",52,52.3,.02,23,9,0)
interface. 'M' indicates an ECME activity (3rd Party Billing).
"^DD",52,52.3,.02,"DT")
3180611
"^DD",52.45,52.45,.02,0)
BRIEF DESCRIPTION^FJ150^^0;2^K:$L(X)>150!($L(X)<3) X
"^DD",52.45,52.45,.02,1,0)
^.1
"^DD",52.45,52.45,.02,1,1,0)
52.45^D
"^DD",52.45,52.45,.02,1,1,1)
S ^PS(52.45,"D",$E(X,1,30),DA)=""
"^DD",52.45,52.45,.02,1,1,2)
K ^PS(52.45,"D",$E(X,1,30),DA)
"^DD",52.45,52.45,.02,1,1,"%D",0)
^^2^2^3170626^
"^DD",52.45,52.45,.02,1,1,"%D",1,0)
Index for this description so file manager can display information when
"^DD",52.45,52.45,.02,1,1,"%D",2,0)
doing a lookup.
"^DD",52.45,52.45,.02,1,1,"DT")
3170329
"^DD",52.45,52.45,.02,3)
Enter the code description. Answer must be 3-150 characters in length.
"^DD",52.45,52.45,.02,21,0)
^.001^1^1^3180307^^
"^DD",52.45,52.45,.02,21,1,0)
This is the brief description of the eRx service reason code.
"^DD",52.45,52.45,.02,"DT")
3180524
"^DD",52.45,52.45,.03,0)
CODE TYPE^S^REA:SERVICE REASON;RES:SERVICE RESULT;PSC:PROFESSIONAL SERVICE;ERX:ERX STATUS;DCS:DRUG COVERAGE;PAV:PRIOR AUTH VALUE;CAQ:CO-AGENT QUALIFIER;REJ:REJECT REASON;REM:REMOVAL REASON;DDB:DRUG DB QUAL;CLQ:CODE LIST;ERR:ERROR;^0;3^Q
"^DD",52.45,52.45,.03,1,0)
^.1
"^DD",52.45,52.45,.03,1,1,0)
52.45^TYPE
"^DD",52.45,52.45,.03,1,1,1)
S ^PS(52.45,"TYPE",$E(X,1,30),DA)=""
"^DD",52.45,52.45,.03,1,1,2)
K ^PS(52.45,"TYPE",$E(X,1,30),DA)
"^DD",52.45,52.45,.03,1,1,"%D",0)
^^1^1^3170516^
"^DD",52.45,52.45,.03,1,1,"%D",1,0)
This creates an index by type and IEN.
"^DD",52.45,52.45,.03,1,1,"DT")
3170516
"^DD",52.45,52.45,.03,3)
Enter the type associated with the eRx service code.
"^DD",52.45,52.45,.03,21,0)
^.001^1^1^3180208^^^^
"^DD",52.45,52.45,.03,21,1,0)
This is the type of the service reason code.
"^DD",52.45,52.45,.03,"DT")
3180208
"^DD",52.46,52.46,6,0)
LAST LOCKED BY^P200'^VA(200,^6;1^Q
"^DD",52.46,52.46,6,3)
Enter the name of the user who last locked this eRx patient.
"^DD",52.46,52.46,6,21,0)
^^2^2^3180524^
"^DD",52.46,52.46,6,21,1,0)
This field keeps track of the last user who succesfully locked the eRx 
"^DD",52.46,52.46,6,21,2,0)
patient. This field is used primarily in the patient centric view.
"^DD",52.46,52.46,6,"DT")
3180524
"^DD",52.49,52.49,.02,0)
RELATED OR PARENT MESSAGE ID^F^^0;2^K:$L(X)>35!($L(X)<3) X
"^DD",52.49,52.49,.02,3)
Answer must be 3-35 characters in length.
"^DD",52.49,52.49,.02,21,0)
^.001^2^2^3180827^^
"^DD",52.49,52.49,.02,21,1,0)
This is the message ID of any related or parent messages that may be 
"^DD",52.49,52.49,.02,21,2,0)
associated with this eRx Holding Queue message.
"^DD",52.49,52.49,.02,"DT")
3180116
"^DD",52.49,52.49,.04,0)
EXTERNAL PATIENT IDENTIFIER^P52.46'^PS(52.46,^0;4^Q
"^DD",52.49,52.49,.04,3)
Enter the patient associated with the incoming eRx.
"^DD",52.49,52.49,.04,21,0)
^.001^1^1^3170626^^^
"^DD",52.49,52.49,.04,21,1,0)
This is the external patient identifier.
"^DD",52.49,52.49,.04,"DT")
3180628
"^DD",52.49,52.49,.08,0)
MESSAGE TYPE^S^RR:REFILLREQUEST;RE:REFILLRESPONSE;N:NEWRX;CR:CHANGEREQUEST;CE:CHANGERESPONSE;RXF:RXFILL;IE:INBOUND ERROR;OE:OUTBOUND ERROR;CA:CANCELRX;CN:CANCELRXRESPONSE;^0;8^Q
"^DD",52.49,52.49,.08,3)
Enter the message type associated with this incoming eRx message.
"^DD",52.49,52.49,.08,21,0)
^.001^2^2^3180326^^^^
"^DD",52.49,52.49,.08,21,1,0)
This is the message type associated with this incoming eRx request 
"^DD",52.49,52.49,.08,21,2,0)
(Change, Cancel, Refill, Partial Fill, etc).
"^DD",52.49,52.49,.08,"DT")
3180904
"^DD",52.49,52.49,.14,0)
RELATES TO HUB ID^FJ30^^0;14^K:$L(X)>30!($L(X)<1) X
"^DD",52.49,52.49,.14,1,0)
^.1
"^DD",52.49,52.49,.14,1,1,0)
52.49^RTHID
"^DD",52.49,52.49,.14,1,1,1)
S ^PS(52.49,"RTHID",$E(X,1,30),DA)=""
"^DD",52.49,52.49,.14,1,1,2)
K ^PS(52.49,"RTHID",$E(X,1,30),DA)
"^DD",52.49,52.49,.14,1,1,"%D",0)
^^2^2^3180410^
"^DD",52.49,52.49,.14,1,1,"%D",1,0)
This index will create a linkage between eRx messages for new, requests, 
"^DD",52.49,52.49,.14,1,1,"%D",2,0)
and response types.
"^DD",52.49,52.49,.14,1,1,"DT")
3180410
"^DD",52.49,52.49,.14,3)
Enter the eRx related processing hub ID. Answer must be 1-30 characters in length.
"^DD",52.49,52.49,.14,21,0)
^^1^1^3180105^
"^DD",52.49,52.49,.14,21,1,0)
This is the eRx processing hub ID that is related to this message.
"^DD",52.49,52.49,.14,"DT")
3180410
"^DD",52.49,52.49,2.1,0)
EXTERNAL PROVIDER^P52.48'^PS(52.48,^2;1^Q
"^DD",52.49,52.49,2.1,3)
Enter the name of the external provider for this eRx holding queue entry.
"^DD",52.49,52.49,2.1,21,0)
^^1^1^3160902^
"^DD",52.49,52.49,2.1,21,1,0)
The external provider for this incoming prescription.
"^DD",52.49,52.49,2.1,"DT")
3180524
"^DD",52.49,52.49,5.7,0)
REFILL QUALIFIER^S^R:NUMBER OF REFILLS;PRN:AS NEEDED;P:PHARMACY REQUESTED REFILLS;A:ADDITIONAL REFILLS AUTHORIZED;^5;7^Q
"^DD",52.49,52.49,5.7,3)
Enter the refill qualifier associated with the eRx prescription.
"^DD",52.49,52.49,5.7,21,0)
^.001^2^2^3180131^^
"^DD",52.49,52.49,5.7,21,1,0)
This is the refill qualifier associated with the eRx incoming 
"^DD",52.49,52.49,5.7,21,2,0)
prescription.
"^DD",52.49,52.49,5.7,"DT")
3180131
"^DD",52.49,52.49,25,0)
CH MESSAGE ID^F^^25;1^K:$L(X)>35!($L(X)<3) X
"^DD",52.49,52.49,25,3)
Enter the Change Healthcare message identification value. Answer must be 3-35 characters in length.
"^DD",52.49,52.49,25,21,0)
^^3^3^3171229^
"^DD",52.49,52.49,25,21,1,0)
This is the Change Healthcare message identifier. This number is not to 
"^DD",52.49,52.49,25,21,2,0)
be considered to be a unique identifier. It is possible that the same 
"^DD",52.49,52.49,25,21,3,0)
message ID could come from more than one provider.
"^DD",52.49,52.49,25,"DT")
3180117
"^DD",52.49,52.49,49,0)
MEDICATION DISPENSED/REQUESTED^52.4949^^49;0
"^DD",52.49,52.49,49,21,0)
^.001^2^2^3180201^^^^
"^DD",52.49,52.49,49,21,1,0)
This multiple holds the medication dispensed/medication(s) requested in 
"^DD",52.49,52.49,49,21,2,0)
support of the refill request and change request message types.
"^DD",52.49,52.49,50,0)
REQUEST/RESPONSE COMMENTS^FJ255^^50;1^K:$L(X)>255!($L(X)<1) X
"^DD",52.49,52.49,50,3)
Enter the refill request/response comments. Answer must be 1-255 characters in length.
"^DD",52.49,52.49,50,21,0)
^.001^2^2^3180201^^^
"^DD",52.49,52.49,50,21,1,0)
This is the refill request/response comments for the eRx refill request 
"^DD",52.49,52.49,50,21,2,0)
or refill response.
"^DD",52.49,52.49,50,"DT")
3180201
"^DD",52.49,52.49,50.1,0)
NOTE ADDED BY^P200'^VA(200,^50.1;1^Q
"^DD",52.49,52.49,50.1,3)
Enter the person who entered this note for a refill request or response.
"^DD",52.49,52.49,50.1,21,0)
^^2^2^3180123^
"^DD",52.49,52.49,50.1,21,1,0)
This is the person who entered the note related to an eRx refill request 
"^DD",52.49,52.49,50.1,21,2,0)
or response.
"^DD",52.49,52.49,50.1,"DT")
3180123
"^DD",52.49,52.49,50.2,0)
NOTE DATE/TIME^D^^50.1;2^S %DT="ESTX" D ^%DT S X=Y K:Y<1 X
"^DD",52.49,52.49,50.2,3)
Enter the date/time the note was entered.
"^DD",52.49,52.49,50.2,21,0)
^^2^2^3180123^
"^DD",52.49,52.49,50.2,21,1,0)
This is the date/time the note was entered for a request or response type 
"^DD",52.49,52.49,50.2,21,2,0)
of message.
"^DD",52.49,52.49,50.2,"DT")
3180123
"^DD",52.49,52.49,51.1,0)
REFILL/CANCEL REQEUST PERSON^P200'^VA(200,^51;1^Q
"^DD",52.49,52.49,51.1,3)
Enter the person who made the outbound refill or cancel request.
"^DD",52.49,52.49,51.1,21,0)
^.001^1^1^3180827^^^
"^DD",52.49,52.49,51.1,21,1,0)
This is the person who made the outbound refill/change request.
"^DD",52.49,52.49,51.1,"DT")
3180827
"^DD",52.49,52.49,51.2,0)
# OF REFILLS REQUESTED^NJ2,0^^51;2^K:+X'=X!(X>11)!(X<0)!(X?.E1"."1N.N) X
"^DD",52.49,52.49,51.2,3)
Enter the number of refills requested. Type a number between 0 and 11, 0 decimal digits.
"^DD",52.49,52.49,51.2,21,0)
^^1^1^3180122^
"^DD",52.49,52.49,51.2,21,1,0)
This is the number of refills requested on an prescription refill request.
"^DD",52.49,52.49,51.2,"DT")
3180122
"^DD",52.49,52.49,52.1,0)
RESPONSE VALUE^S^A:APPROVED;D:DENIED;DNP:DENIED, NEW PRESCRIPTION TO FOLLOW;AWC:APPROVED WITH CHANGES;^52;1^Q
"^DD",52.49,52.49,52.1,3)
Enter the response type for this incoming message.
"^DD",52.49,52.49,52.1,21,0)
^.001^2^2^3180201^^
"^DD",52.49,52.49,52.1,21,1,0)
This is the response type for a refill request. This tells us the status 
"^DD",52.49,52.49,52.1,21,2,0)
of the request, as returned by the provider.
"^DD",52.49,52.49,52.1,"DT")
3180123
"^DD",52.49,52.49,52.2,0)
RESPONSE NOTE^FJ70^^52;2^K:$L(X)>70!($L(X)<1) X
"^DD",52.49,52.49,52.2,3)
Enter the response notes entered by the provider. Answer must be 1-70 characters in length.
"^DD",52.49,52.49,52.2,21,0)
^^2^2^3180123^
"^DD",52.49,52.49,52.2,21,1,0)
This is the note as written by the provider, for a refill or cancel 
"^DD",52.49,52.49,52.2,21,2,0)
response message type.
"^DD",52.49,52.49,52.2,"DT")
3180123
"^DD",52.49,52.49,52.3,0)
RESPONSE REFERENCE NUMBER^FJ35^^52;3^K:$L(X)>35!($L(X)<1) X
"^DD",52.49,52.49,52.3,3)
Enter the response reference number for this refill or change response message. Answer must be 1-35 characters in length.
"^DD",52.49,52.49,52.3,21,0)
^^2^2^3180123^
"^DD",52.49,52.49,52.3,21,1,0)
This is the reference number associated with the refill or change request 
"^DD",52.49,52.49,52.3,21,2,0)
response.
"^DD",52.49,52.49,52.3,"DT")
3180123
"^DD",52.49,52.49,55,0)
RESPONSE CODES^52.4955P^^55;0
"^DD",52.49,52.49,55,21,0)
^^2^2^3180124^
"^DD",52.49,52.49,55,21,1,0)
This multiple holds the response codes related to the refill or change 
"^DD",52.49,52.49,55,21,2,0)
response.
"^DD",52.49,52.49,60,0)
REQUEST/RESPONSE ERROR TEXT^FJ70^^60;1^K:$L(X)>70!($L(X)<1) X
"^DD",52.49,52.49,60,3)
Enter the error text for this request/response error. Answer must be 1-70 characters in length.
"^DD",52.49,52.49,60,21,0)
^^1^1^3180209^
"^DD",52.49,52.49,60,21,1,0)
This is the error text for an inbound or outbound eRx error message.
"^DD",52.49,52.49,60,"DT")
3180209
"^DD",52.49,52.49,60.1,0)
REQUEST/RESPONSE ERROR CODE^S^600:COMMUNICATION PROBLEM - TRY AGAIN LATER;601:RECEIVER UNABLE TO PROCESS - DO NOT RETRY;602:RECEIVER SYSTEM ERROR - TRY AGAIN LATER;900:TRANSACTION REJECTED - DO NOT RETRY;^60;2^Q
"^DD",52.49,52.49,60.1,3)
Enter the error code for this eRx error message.
"^DD",52.49,52.49,60.1,21,0)
^^1^1^3180209^
"^DD",52.49,52.49,60.1,21,1,0)
This is the error code associated with an eRx error message.
"^DD",52.49,52.49,60.1,"DT")
3180209
"^DD",52.49,52.49,61,0)
REQUEST/RESPONSE ERR DCODES^52.4961P^^61;0
"^DD",52.49,52.49,61,21,0)
^^2^2^3180828^
"^DD",52.49,52.49,61,21,1,0)
This multiple holds the error description codes for a request/response 
"^DD",52.49,52.49,61,21,2,0)
message.
"^DD",52.49,52.49,80.1,0)
CHANGE REQUEST TYPE^S^C1:SIGNIFICANT CHANGE;C2:FREQUENCY CHANGE;C3:INSIGNIFICANT CHANGE;^80;1^Q
"^DD",52.49,52.49,80.1,3)
Enter the change request type for this eRx message.
"^DD",52.49,52.49,80.1,21,0)
^^10^10^3180328^
"^DD",52.49,52.49,80.1,21,1,0)
This field identifies the change request type for cancel and change eRx 
"^DD",52.49,52.49,80.1,21,2,0)
messages.
"^DD",52.49,52.49,80.1,21,3,0)
 
"^DD",52.49,52.49,80.1,21,4,0)
C1 Significant change (Any changes to the Drug, form, strength, dosage, 
"^DD",52.49,52.49,80.1,21,5,0)
or route)
"^DD",52.49,52.49,80.1,21,6,0)
 
"^DD",52.49,52.49,80.1,21,7,0)
C2 Frequency Change (Any change to the frequency or hours of 
"^DD",52.49,52.49,80.1,21,8,0)
administration for the drug)
"^DD",52.49,52.49,80.1,21,9,0)
 
"^DD",52.49,52.49,80.1,21,10,0)
C3 Insignificant Change (All other changes)
"^DD",52.49,52.49,80.1,"DT")
3180328
"^DD",52.49,52.49,80.2,0)
RETURN RECEIPT^FJ3^^80;2^K:$L(X)>3!($L(X)<1) X
"^DD",52.49,52.49,80.2,3)
Enter the return receipt value for this eRx message. Answer must be 1-3 characters in length.
"^DD",52.49,52.49,80.2,21,0)
^^1^1^3180328^
"^DD",52.49,52.49,80.2,21,1,0)
This is the return receipt associated with a cancel or change eRx message.
"^DD",52.49,52.49,80.2,"DT")
3180328
"^DD",52.49,52.49,80.3,0)
REQUEST REFERENCE NUMBER^FJ35^^80;3^K:$L(X)>35!($L(X)<1) X
"^DD",52.49,52.49,80.3,3)
Enter the request reference number for this eRx message. Answer must be 1-35 characters in length.
"^DD",52.49,52.49,80.3,21,0)
^^1^1^3180328^
"^DD",52.49,52.49,80.3,21,1,0)
This is the request reference number for a cancel or change eRx message.
"^DD",52.49,52.49,80.3,"DT")
3180328
"^DD",52.49,52.49,80.4,0)
CHANGE RX STATUS FLAG^S^C:CANCEL;D:DISCONTINUE;^80;4^Q
"^DD",52.49,52.49,80.4,3)
Enter the change of prescription status flag for this eRx message.
"^DD",52.49,52.49,80.4,21,0)
^^2^2^3180328^
"^DD",52.49,52.49,80.4,21,1,0)
This is the change of prescription status flag, intended to be used for 
"^DD",52.49,52.49,80.4,21,2,0)
cancel and change eRx message types.
"^DD",52.49,52.49,80.4,"DT")
3180328
"^DD",52.49,52.49,80.5,0)
CHANGE/CANCEL DENIED BY HUB^S^1:YES;^80;5^Q
"^DD",52.49,52.49,80.5,3)
Enter '1' if this change or cancel request was denied by the eRx processing hub.
"^DD",52.49,52.49,80.5,21,0)
^^2^2^3180328^
"^DD",52.49,52.49,80.5,21,1,0)
This flag identifies entries that have been denied by the eRx processing 
"^DD",52.49,52.49,80.5,21,2,0)
hub.
"^DD",52.49,52.49,80.5,"DT")
3180328
"^DD",52.49,52.49,100,0)
PROCESSING ERRORS^52.49101A^^100;0
"^DD",52.49,52.49,100,21,0)
^.001^2^2^3180226^^^
"^DD",52.49,52.49,100,21,1,0)
This sub-file contains the processing errors associated with the eRx
"^DD",52.49,52.49,100,21,2,0)
entry.
"^DD",52.49,52.49,201,0)
MESSAGE HISTORY^52.49201P^^201;0
"^DD",52.49,52.49101,0)
PROCESSING ERRORS SUB-FIELD^^1^7
"^DD",52.49,52.49101,0,"DT")
3180226
"^DD",52.49,52.49101,0,"IX","B",52.49101,.01)

"^DD",52.49,52.49101,0,"IX","C",52.49101,.02)

"^DD",52.49,52.49101,0,"NM","PROCESSING ERRORS")

"^DD",52.49,52.49101,0,"UP")
52.49
"^DD",52.49,52.49101,.01,0)
PROCESSING ERRORS^NJ5,0^^0;1^K:+X'=X!(X>99999)!(X<1)!(X?.E1"."1N.N) X
"^DD",52.49,52.49101,.01,1,0)
^.1
"^DD",52.49,52.49101,.01,1,1,0)
52.49101^B
"^DD",52.49,52.49101,.01,1,1,1)
S ^PS(52.49,DA(1),100,"B",$E(X,1,30),DA)=""
"^DD",52.49,52.49101,.01,1,1,2)
K ^PS(52.49,DA(1),100,"B",$E(X,1,30),DA)
"^DD",52.49,52.49101,.01,3)
Enter the Error ID. Answer must be a number between 1 and 99999, 0 decimal digits.
"^DD",52.49,52.49101,.01,21,0)
^.001^1^1^3170626^^
"^DD",52.49,52.49101,.01,21,1,0)
The processing error ID.
"^DD",52.49,52.49101,.01,"DT")
3161205
"^DD",52.49,52.49101,.02,0)
ERROR TYPE^S^D:DRUG;PR:PROVIDER;PA:PATIENT;A:ALLERGY;O:ORDER CHECK;T:TRANSFER;PX:PROCESSING;^0;2^Q
"^DD",52.49,52.49101,.02,1,0)
^.1
"^DD",52.49,52.49101,.02,1,1,0)
52.49101^C
"^DD",52.49,52.49101,.02,1,1,1)
S ^PS(52.49,DA(1),100,"C",$E(X,1,30),DA)=""
"^DD",52.49,52.49101,.02,1,1,2)
K ^PS(52.49,DA(1),100,"C",$E(X,1,30),DA)
"^DD",52.49,52.49101,.02,1,1,"%D",0)
^^1^1^3180226^
"^DD",52.49,52.49101,.02,1,1,"%D",1,0)
This indexes the error type for quick lookup on specific errors.
"^DD",52.49,52.49101,.02,1,1,"DT")
3180226
"^DD",52.49,52.49101,.02,3)
Enter the error type associated with this eRx entry.
"^DD",52.49,52.49101,.02,21,0)
^.001^1^1^3180226^^
"^DD",52.49,52.49101,.02,21,1,0)
The error type related to the incoming eRx.
"^DD",52.49,52.49101,.02,"DT")
3180226
"^DD",52.49,52.49101,.03,0)
ERROR SOURCE^S^V:VISTA;E:ERX PROCESSING HUB;^0;3^Q
"^DD",52.49,52.49101,.03,3)
Enter the source of the error. This is the origination source of the error.
"^DD",52.49,52.49101,.03,21,0)
^^1^1^3161205^
"^DD",52.49,52.49101,.03,21,1,0)
The origination point/source of the processing error.
"^DD",52.49,52.49101,.03,"DT")
3161205
"^DD",52.49,52.49101,.04,0)
STATUS^S^R:RESOLVED;P:PENDING;^0;4^Q
"^DD",52.49,52.49101,.04,3)
Enter the status of the processing error.
"^DD",52.49,52.49101,.04,21,0)
^.001^1^1^3180226^^
"^DD",52.49,52.49101,.04,21,1,0)
This is the current status of the processing error.
"^DD",52.49,52.49101,.04,"DT")
3180226
"^DD",52.49,52.49101,.05,0)
RESOLVED BY^P200'^VA(200,^0;5^Q
"^DD",52.49,52.49101,.05,3)
Enter the person who resolved this error.
"^DD",52.49,52.49101,.05,21,0)
^^1^1^3161205^
"^DD",52.49,52.49101,.05,21,1,0)
The person who resolved the processing error.
"^DD",52.49,52.49101,.05,"DT")
3161205
"^DD",52.49,52.49101,.06,0)
DATE/TIME RESOLVED^D^^0;6^S %DT="ESTX" D ^%DT S X=Y K:Y<1 X
"^DD",52.49,52.49101,.06,3)
Enter the date/time the processing error was resolved.
"^DD",52.49,52.49101,.06,21,0)
^^1^1^3161205^
"^DD",52.49,52.49101,.06,21,1,0)
The date/time of the processing error resolution.
"^DD",52.49,52.49101,.06,"DT")
3161205
"^DD",52.49,52.49101,1,0)
ERROR TEXT^F^^1;1^K:$L(X)>250!($L(X)<1) X
"^DD",52.49,52.49101,1,3)
Enter the error text for this eRx. Answer must be 1-150 characters in length.
"^DD",52.49,52.49101,1,21,0)
^^2^2^3170307^
"^DD",52.49,52.49101,1,21,1,0)
This is the error description/text that identifies the reason for the 
"^DD",52.49,52.49101,1,21,2,0)
error.
"^DD",52.49,52.49101,1,"DT")
3170307
"^DD",52.49,52.49201,0)
MESSAGE HISTORY SUB-FIELD^^.01^1
"^DD",52.49,52.49201,0,"DT")
3180109
"^DD",52.49,52.49201,0,"IX","B",52.49201,.01)

"^DD",52.49,52.49201,0,"NM","MESSAGE HISTORY")

"^DD",52.49,52.49201,0,"UP")
52.49
"^DD",52.49,52.49201,.01,0)
MESSAGE IEN^MP52.49'^PS(52.49,^0;1^Q
"^DD",52.49,52.49201,.01,1,0)
^.1
"^DD",52.49,52.49201,.01,1,1,0)
52.49201^B
"^DD",52.49,52.49201,.01,1,1,1)
S ^PS(52.49,DA(1),201,"B",$E(X,1,30),DA)=""
"^DD",52.49,52.49201,.01,1,1,2)
K ^PS(52.49,DA(1),201,"B",$E(X,1,30),DA)
"^DD",52.49,52.49201,.01,3)
Enter the IEN of the message that relates to this message.
"^DD",52.49,52.49201,.01,21,0)
^.001^1^1^3180109^^
"^DD",52.49,52.49201,.01,21,1,0)
This holds the eRx messages that are related to this particular message.
"^DD",52.49,52.49201,.01,"DT")
3180109
"^DD",52.49,52.4949,0)
MEDICATION DISPENSED/REQUESTED SUB-FIELD^^2.7^15
"^DD",52.49,52.4949,0,"DT")
3180131
"^DD",52.49,52.4949,0,"IX","B",52.4949,.01)

"^DD",52.49,52.4949,0,"NM","MEDICATION DISPENSED/REQUESTED")

"^DD",52.49,52.4949,0,"UP")
52.49
"^DD",52.49,52.4949,.01,0)
MEDICATION DISPENSED/REQUESTED^MFJ105^^0;1^K:$L(X)>105!($L(X)<1) X
"^DD",52.49,52.4949,.01,1,0)
^.1
"^DD",52.49,52.4949,.01,1,1,0)
52.4949^B
"^DD",52.49,52.4949,.01,1,1,1)
S ^PS(52.49,DA(1),49,"B",$E(X,1,30),DA)=""
"^DD",52.49,52.4949,.01,1,1,2)
K ^PS(52.49,DA(1),49,"B",$E(X,1,30),DA)
"^DD",52.49,52.4949,.01,3)
Enter the name of the medication that is being dispensed or requested. Answer must be 1-105 characters in length.
"^DD",52.49,52.4949,.01,21,0)
^^1^1^3180120^
"^DD",52.49,52.4949,.01,21,1,0)
This field holds the name of the medication dispensed/requested.
"^DD",52.49,52.4949,.01,"DT")
3180120
"^DD",52.49,52.4949,.02,0)
TYPE^S^D:DISPENSED;R:REQUESTED;^0;2^Q
"^DD",52.49,52.4949,.02,3)
Enter the type 'Dispensed' or 'Requested' for this medication.
"^DD",52.49,52.4949,.02,21,0)
^^2^2^3180120^
"^DD",52.49,52.4949,.02,21,1,0)
This field identifies the type of medication, whether it is a dispensed 
"^DD",52.49,52.4949,.02,21,2,0)
or requested medication.
"^DD",52.49,52.4949,.02,"DT")
3180120
"^DD",52.49,52.4949,.03,0)
DRUG IEN^P50'^PSDRUG(^0;3^Q
"^DD",52.49,52.4949,.03,3)
Enter the Vista drug associated with the drug name.
"^DD",52.49,52.4949,.03,21,0)
^^2^2^3180120^
"^DD",52.49,52.4949,.03,21,1,0)
This field points to the drug file entry for the medication dispensed or 
"^DD",52.49,52.4949,.03,21,2,0)
requested.
"^DD",52.49,52.4949,.03,"DT")
3180120
"^DD",52.49,52.4949,.04,0)
QUANTITY^NJ2,0^^0;4^K:+X'=X!(X>99)!(X<0)!(X?.E1"."1N.N) X
"^DD",52.49,52.4949,.04,3)
Enter the quantity for this medication. Type a number between 0 and 99, 0 decimal digits.
"^DD",52.49,52.4949,.04,21,0)
^^1^1^3180120^
"^DD",52.49,52.4949,.04,21,1,0)
This is the quantity associated with the medication dispensed/requested.
"^DD",52.49,52.4949,.04,"DT")
3180120
"^DD",52.49,52.4949,.05,0)
DAYS SUPPLY^NJ3,0^^0;5^K:+X'=X!(X>365)!(X<1)!(X?.E1"."1N.N) X
"^DD",52.49,52.4949,.05,3)
Enter the days supply for this medication dispensed/requested. Type a number between 1 and 365, 0 decimal digits.
"^DD",52.49,52.4949,.05,21,0)
^^1^1^3180120^
"^DD",52.49,52.4949,.05,21,1,0)
This is the days supply for the medication being dispensed or requested.
"^DD",52.49,52.4949,.05,"DT")
3180120
"^DD",52.49,52.4949,.06,0)
REFILLS^NJ2,0^^0;6^K:+X'=X!(X>11)!(X<0)!(X?.E1"."1N.N) X
"^DD",52.49,52.4949,.06,3)
Enter the number of refills for this dispensed/requested medication. Type a number between 0 and 11, 0 decimal digits.
"^DD",52.49,52.4949,.06,21,0)
^^1^1^3180120^
"^DD",52.49,52.4949,.06,21,1,0)
This is the number of refills for the dispensed/requested medication.
"^DD",52.49,52.4949,.06,"DT")
3180120
"^DD",52.49,52.4949,.07,0)
REFILL QUALIFIER^S^R:NUMBER OF REFILLS;PRN:REFILLS FOR 1 YEAR;P:PHARMACY REQUESTED REFILLS;A:ADDITIONAL REFILLS AUTHORIZED;^0;7^Q
"^DD",52.49,52.4949,.07,3)
Enter the refill qualifier for this medication.
"^DD",52.49,52.4949,.07,21,0)
^.001^1^1^3180131^^^
"^DD",52.49,52.4949,.07,21,1,0)
This is the refill qualifier for the medication requested/dispensed.
"^DD",52.49,52.4949,.07,"DT")
3180131
"^DD",52.49,52.4949,1,0)
DIRECTIONS^FJ140^^1;1^K:$L(X)>140!($L(X)<1) X
"^DD",52.49,52.4949,1,3)
Enter the directions for this dispensed/requested medication. Answer must be 1-140 characters in length.
"^DD",52.49,52.4949,1,21,0)
^^2^2^3180120^
"^DD",52.49,52.4949,1,21,1,0)
This field holds the directions for use (SIG) for the medication being 
"^DD",52.49,52.4949,1,21,2,0)
dispensed or requested.
"^DD",52.49,52.4949,1,"DT")
3180120
"^DD",52.49,52.4949,2.1,0)
WRITTEN DATE^D^^2;1^S %DT="ESTX" D ^%DT S X=Y K:Y<1 X
"^DD",52.49,52.4949,2.1,3)
Enter the date written for the medication being dispensed/requested.
"^DD",52.49,52.4949,2.1,21,0)
^^1^1^3180120^
"^DD",52.49,52.4949,2.1,21,1,0)
This is the written date for the requested/dispensed medication.
"^DD",52.49,52.4949,2.1,"DT")
3180120
"^DD",52.49,52.4949,2.2,0)
LAST FILLED DATE^D^^2;2^S %DT="EX" D ^%DT S X=Y K:Y<1 X
"^DD",52.49,52.4949,2.2,3)
Enter the date this dispensed/requested medication was last filled.
"^DD",52.49,52.4949,2.2,21,0)
^^2^2^3180120^
"^DD",52.49,52.4949,2.2,21,1,0)
This is the last fill date for the medication being dispensed. This field 
"^DD",52.49,52.4949,2.2,21,2,0)
may not apply to a medication being requsted.
"^DD",52.49,52.4949,2.2,"DT")
3180120
"^DD",52.49,52.4949,2.3,0)
EXPIRATION DATE^D^^2;3^S %DT="EX" D ^%DT S X=Y K:Y<1 X
"^DD",52.49,52.4949,2.3,3)
Enter the expiration date for the medication being dispensed/requested.
"^DD",52.49,52.4949,2.3,21,0)
^^1^1^3180120^
"^DD",52.49,52.4949,2.3,21,1,0)
This is the expiration date for the medication being dispensed/requested.
"^DD",52.49,52.4949,2.3,"DT")
3180120
"^DD",52.49,52.4949,2.4,0)
EFFECTIVE DATE^D^^2;4^S %DT="EX" D ^%DT S X=Y K:Y<1 X
"^DD",52.49,52.4949,2.4,3)
Enter the effective date for the medication being dispensed/reqquested.
"^DD",52.49,52.4949,2.4,21,0)
^^1^1^3180120^
"^DD",52.49,52.4949,2.4,21,1,0)
This is the effective date for the medication being dispensed/requested.
"^DD",52.49,52.4949,2.4,"DT")
3180120
"^DD",52.49,52.4949,2.5,0)
CODE LIST QUALIFIER^S^38:ORIGINAL QUANTITY;40:REMAINING QUANTITY;87:QUANTITY RECEIVED;QS:QUANTITY SUFFICIENT;^2;5^Q
"^DD",52.49,52.4949,2.5,3)
Enter the code list qualifier for the medication being dispensed/requested.
"^DD",52.49,52.4949,2.5,21,0)
^^1^1^3180120^
"^DD",52.49,52.4949,2.5,21,1,0)
This is the code list qualifier for the medication.
"^DD",52.49,52.4949,2.5,"DT")
3180120
"^DD",52.49,52.4949,2.6,0)
UNIT SOURCE CODE^S^AA:NCI PHARMACEUTICAL DOSAGE FORM;AB:NCI UNITS OF PRESENTATION;AC:NCI VALUES OF PROPERTY;AC:NCI VALUES OF PROPERT OR POTENCY UNIT;^2;6^Q
"^DD",52.49,52.4949,2.6,3)
Enter the unit source code for the medication being dispensed/requested.
"^DD",52.49,52.4949,2.6,21,0)
^^1^1^3180120^
"^DD",52.49,52.4949,2.6,21,1,0)
This is the unit source code for the medication.
"^DD",52.49,52.4949,2.6,"DT")
3180120
"^DD",52.49,52.4949,2.7,0)
POTENCY UNIT CODE^FJ15^^2;7^K:$L(X)>15!($L(X)<1) X
"^DD",52.49,52.4949,2.7,3)
Enter the potency unit code for this medication. Answer must be 1-15 characters in length.
"^DD",52.49,52.4949,2.7,21,0)
^^1^1^3180120^
"^DD",52.49,52.4949,2.7,21,1,0)
This is the potency unit code (if applicable) for the medication.
"^DD",52.49,52.4949,2.7,"DT")
3180120
"^DD",52.49,52.4955,0)
RESPONSE CODES SUB-FIELD^^.01^1
"^DD",52.49,52.4955,0,"DT")
3180124
"^DD",52.49,52.4955,0,"IX","B",52.4955,.01)

"^DD",52.49,52.4955,0,"NM","RESPONSE CODES")

"^DD",52.49,52.4955,0,"UP")
52.49
"^DD",52.49,52.4955,.01,0)
RESPONSE CODES^MP52.45'^PS(52.45,^0;1^Q
"^DD",52.49,52.4955,.01,1,0)
^.1
"^DD",52.49,52.4955,.01,1,1,0)
52.4955^B
"^DD",52.49,52.4955,.01,1,1,1)
S ^PS(52.49,DA(1),55,"B",$E(X,1,30),DA)=""
"^DD",52.49,52.4955,.01,1,1,2)
K ^PS(52.49,DA(1),55,"B",$E(X,1,30),DA)
"^DD",52.49,52.4955,.01,3)
Enter the response code associated with this refill/change response.
"^DD",52.49,52.4955,.01,21,0)
^^2^2^3180124^
"^DD",52.49,52.4955,.01,21,1,0)
This multiple holds the response codes provided with the refill or change 
"^DD",52.49,52.4955,.01,21,2,0)
request response.
"^DD",52.49,52.4955,.01,"DT")
3180124
"^DD",52.49,52.4961,0)
REQUEST/RESPONSE ERR DCODES SUB-FIELD^^.01^1
"^DD",52.49,52.4961,0,"DT")
3180209
"^DD",52.49,52.4961,0,"IX","B",52.4961,.01)

"^DD",52.49,52.4961,0,"NM","REQUEST/RESPONSE ERR DCODES")

"^DD",52.49,52.4961,0,"UP")
52.49
"^DD",52.49,52.4961,.01,0)
REQUEST/RESPONSE ERR DCODES^MP52.45'^PS(52.45,^0;1^Q
"^DD",52.49,52.4961,.01,1,0)
^.1
"^DD",52.49,52.4961,.01,1,1,0)
52.4961^B
"^DD",52.49,52.4961,.01,1,1,1)
S ^PS(52.49,DA(1),61,"B",$E(X,1,30),DA)=""
"^DD",52.49,52.4961,.01,1,1,2)
K ^PS(52.49,DA(1),61,"B",$E(X,1,30),DA)
"^DD",52.49,52.4961,.01,3)
Enter the description codes for the eRx error message.
"^DD",52.49,52.4961,.01,21,0)
^^2^2^3180209^
"^DD",52.49,52.4961,.01,21,1,0)
These are the error description codes (up to 10) describing the eRx error 
"^DD",52.49,52.4961,.01,21,2,0)
message in more detail.
"^DD",52.49,52.4961,.01,"DT")
3180209
"BLD",9591,6)
^444
**END**
**END**

