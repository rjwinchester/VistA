Released PSO*7*318 SEQ #367
Extracted from mail message
**KIDS**:PSO*7.0*318^

**INSTALL NAME**
PSO*7.0*318
"BLD",9465,0)
PSO*7.0*318^OUTPATIENT PHARMACY^0^3140122^y
"BLD",9465,1,0)
^^9^9^3130731^^^^
"BLD",9465,1,1,0)
This patch resolves the following 3 issues:
"BLD",9465,1,2,0)
1. Detailed display in CPRS for an IV shows data from another
"BLD",9465,1,3,0)
   prescription.
"BLD",9465,1,4,0)
                                                           
"BLD",9465,1,5,0)
2. The algorithm used to determine the # of refills for a pending order
"BLD",9465,1,6,0)
   does not take into account the "Rx patient status".
"BLD",9465,1,7,0)
   
"BLD",9465,1,8,0)
                                                           
"BLD",9465,1,9,0)
3. Label is incorrectly designated a REPRINT after printing from suspense.
"BLD",9465,4,0)
^9.64PA^^
"BLD",9465,6.3)
13
"BLD",9465,"ABPKG")
n
"BLD",9465,"KRN",0)
^9.67PA^779.2^20
"BLD",9465,"KRN",.4,0)
.4
"BLD",9465,"KRN",.401,0)
.401
"BLD",9465,"KRN",.402,0)
.402
"BLD",9465,"KRN",.403,0)
.403
"BLD",9465,"KRN",.5,0)
.5
"BLD",9465,"KRN",.84,0)
.84
"BLD",9465,"KRN",3.6,0)
3.6
"BLD",9465,"KRN",3.8,0)
3.8
"BLD",9465,"KRN",9.2,0)
9.2
"BLD",9465,"KRN",9.8,0)
9.8
"BLD",9465,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",9465,"KRN",9.8,"NM",1,0)
PSOTALK1^^0^B4302149
"BLD",9465,"KRN",9.8,"NM",2,0)
PSOLBLN^^0^B63716659
"BLD",9465,"KRN",9.8,"NM",3,0)
PSOLBL1^^0^B31449940
"BLD",9465,"KRN",9.8,"NM",4,0)
PSODIR3^^0^B29211268
"BLD",9465,"KRN",9.8,"NM",5,0)
PSOORRL^^0^B64833222
"BLD",9465,"KRN",9.8,"NM","B","PSODIR3",4)

"BLD",9465,"KRN",9.8,"NM","B","PSOLBL1",3)

"BLD",9465,"KRN",9.8,"NM","B","PSOLBLN",2)

"BLD",9465,"KRN",9.8,"NM","B","PSOORRL",5)

"BLD",9465,"KRN",9.8,"NM","B","PSOTALK1",1)

"BLD",9465,"KRN",19,0)
19
"BLD",9465,"KRN",19,"NM",0)
^9.68A^^
"BLD",9465,"KRN",19.1,0)
19.1
"BLD",9465,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",9465,"KRN",101,0)
101
"BLD",9465,"KRN",101,"NM",0)
^9.68A^^
"BLD",9465,"KRN",409.61,0)
409.61
"BLD",9465,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",9465,"KRN",771,0)
771
"BLD",9465,"KRN",771,"NM",0)
^9.68A^^
"BLD",9465,"KRN",779.2,0)
779.2
"BLD",9465,"KRN",779.2,"NM",0)
^9.68A^^
"BLD",9465,"KRN",870,0)
870
"BLD",9465,"KRN",870,"NM",0)
^9.68A^^
"BLD",9465,"KRN",8989.51,0)
8989.51
"BLD",9465,"KRN",8989.51,"NM",0)
^9.68A^^
"BLD",9465,"KRN",8989.52,0)
8989.52
"BLD",9465,"KRN",8989.52,"NM",0)
^9.68A^^
"BLD",9465,"KRN",8994,0)
8994
"BLD",9465,"KRN",8994,"NM",0)
^9.68A^^
"BLD",9465,"KRN","B",.4,.4)

"BLD",9465,"KRN","B",.401,.401)

"BLD",9465,"KRN","B",.402,.402)

"BLD",9465,"KRN","B",.403,.403)

"BLD",9465,"KRN","B",.5,.5)

"BLD",9465,"KRN","B",.84,.84)

"BLD",9465,"KRN","B",3.6,3.6)

"BLD",9465,"KRN","B",3.8,3.8)

"BLD",9465,"KRN","B",9.2,9.2)

"BLD",9465,"KRN","B",9.8,9.8)

"BLD",9465,"KRN","B",19,19)

"BLD",9465,"KRN","B",19.1,19.1)

"BLD",9465,"KRN","B",101,101)

"BLD",9465,"KRN","B",409.61,409.61)

"BLD",9465,"KRN","B",771,771)

"BLD",9465,"KRN","B",779.2,779.2)

"BLD",9465,"KRN","B",870,870)

"BLD",9465,"KRN","B",8989.51,8989.51)

"BLD",9465,"KRN","B",8989.52,8989.52)

"BLD",9465,"KRN","B",8994,8994)

"BLD",9465,"QUES",0)
^9.62^^
"BLD",9465,"REQB",0)
^9.611^2^2
"BLD",9465,"REQB",1,0)
PSO*7.0*383^2
"BLD",9465,"REQB",2,0)
PSO*7.0*206^2
"BLD",9465,"REQB","B","PSO*7.0*206",2)

"BLD",9465,"REQB","B","PSO*7.0*383",1)

"MBREQ")
0
"PKG",206,-1)
1^1
"PKG",206,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",206,20,0)
^9.402P^^
"PKG",206,22,0)
^9.49I^1^1
"PKG",206,22,1,0)
7.0^3021122^3021202^66481
"PKG",206,22,1,"PAH",1,0)
318^3140122
"PKG",206,22,1,"PAH",1,1,0)
^^9^9^3140122
"PKG",206,22,1,"PAH",1,1,1,0)
This patch resolves the following 3 issues:
"PKG",206,22,1,"PAH",1,1,2,0)
1. Detailed display in CPRS for an IV shows data from another
"PKG",206,22,1,"PAH",1,1,3,0)
   prescription.
"PKG",206,22,1,"PAH",1,1,4,0)
                                                           
"PKG",206,22,1,"PAH",1,1,5,0)
2. The algorithm used to determine the # of refills for a pending order
"PKG",206,22,1,"PAH",1,1,6,0)
   does not take into account the "Rx patient status".
"PKG",206,22,1,"PAH",1,1,7,0)
   
"PKG",206,22,1,"PAH",1,1,8,0)
                                                           
"PKG",206,22,1,"PAH",1,1,9,0)
3. Label is incorrectly designated a REPRINT after printing from suspense.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","PSODIR3")
0^4^B29211268^B27252502
"RTN","PSODIR3",1,0)
PSODIR3 ;ISC-BIRM/SAB - rx order entry contd ; 7/3/13 4:09pm
"RTN","PSODIR3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**3,46,184,222,206,318**;DEC 1997;Build 13
"RTN","PSODIR3",3,0)
 ;
"RTN","PSODIR3",4,0)
EXP(PSODIR) ;
"RTN","PSODIR3",5,0)
 K DIC,DIR
"RTN","PSODIR3",6,0)
 I $G(PSODRUG("EXPIRATION DATE"))]"" S Y=PSODRUG("EXPIRATION DATE") X ^DD("DD") S PSORX("EXPIRATION DATE")=Y
"RTN","PSODIR3",7,0)
 S DIR("A")="EXPIRES",DIR("B")=$S($G(PSORX("EXPIRATION DATE"))]"":PSORX("EXPIRATION DATE"),1:"T+6M")
"RTN","PSODIR3",8,0)
 S DIR(0)="D^NOW::EX",DIR("?")="Both the month and date are required." D ^DIR
"RTN","PSODIR3",9,0)
 G:PSODIR("DFLG")!PSODIR("FIELD") EXPX
"RTN","PSODIR3",10,0)
 S PSODIR("EXPIRATION DATE")=Y
"RTN","PSODIR3",11,0)
EXPX K X,Y
"RTN","PSODIR3",12,0)
 Q
"RTN","PSODIR3",13,0)
 ;
"RTN","PSODIR3",14,0)
MW(PSODIR) ;
"RTN","PSODIR3",15,0)
 K DIR,DIC
"RTN","PSODIR3",16,0)
 S DIR(0)="52,11"
"RTN","PSODIR3",17,0)
 S DIR("B")=$S($G(PSORX("MAIL/WINDOW"))]"":PSORX("MAIL/WINDOW"),1:"WINDOW")
"RTN","PSODIR3",18,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") MWX
"RTN","PSODIR3",19,0)
 I $G(Y(0))']"" S PSODIR("DFLG")=1 G MWX
"RTN","PSODIR3",20,0)
 S PSODIR("MAIL/WINDOW")=Y,PSORX("MAIL/WINDOW")=Y(0)
"RTN","PSODIR3",21,0)
 I $G(PSORX("EDIT"))]"",PSODIR("MAIL/WINDOW")'="W" K PSODIR("METHOD OF PICK-UP")
"RTN","PSODIR3",22,0)
MW1 G:PSODIR("MAIL/WINDOW")'="W"!('$P($G(PSOPAR),"^",12)) MWX
"RTN","PSODIR3",23,0)
 S DIR(0)="52,35O"
"RTN","PSODIR3",24,0)
 S:$G(PSORX("METHOD OF PICK-UP"))]"" DIR("B")=PSORX("METHOD OF PICK-UP")
"RTN","PSODIR3",25,0)
 D DIR G:PSODIR("DFLG") MWX
"RTN","PSODIR3",26,0)
 I X[U W !,"Cannot jump to another field ..",! G MW1
"RTN","PSODIR3",27,0)
 S (PSODIR("METHOD OF PICK-UP"),PSORX("METHOD OF PICK-UP"))=Y
"RTN","PSODIR3",28,0)
MWX K X,Y
"RTN","PSODIR3",29,0)
 Q
"RTN","PSODIR3",30,0)
 ;
"RTN","PSODIR3",31,0)
FILLDT(PSODIR) ;
"RTN","PSODIR3",32,0)
 K DIR,DIC
"RTN","PSODIR3",33,0)
 S DIR("A")="FILL DATE",DIR("B")=$S($G(PSORX("FILL DATE"))]"":PSORX("FILL DATE"),1:"TODAY")
"RTN","PSODIR3",34,0)
 S DIR(0)="D^"_$S($G(PSODIR("ISSUE DATE"))]"":PSODIR("ISSUE DATE"),1:DT)_$S($G(DUZ("AG"))="I":":"_DT_":EX",1:"::EX")
"RTN","PSODIR3",35,0)
 S DIR("?",1)="The earliest fill date allowed is determined by the ISSUE DATE,"
"RTN","PSODIR3",36,0)
 S DIR("?",2)="the FILL DATE cannot be before the ISSUE DATE."
"RTN","PSODIR3",37,0)
 S DIR("?")="Both the month and date are required."
"RTN","PSODIR3",38,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") FILLDTX
"RTN","PSODIR3",39,0)
 S PSODIR("FILL DATE")=Y
"RTN","PSODIR3",40,0)
 X ^DD("DD") S PSORX("FILL DATE")=Y
"RTN","PSODIR3",41,0)
FILLDTX K X,Y
"RTN","PSODIR3",42,0)
 Q
"RTN","PSODIR3",43,0)
 ;
"RTN","PSODIR3",44,0)
CLERK(PSODIR) ;
"RTN","PSODIR3",45,0)
 I $G(DUZ("AG"))'="I",$G(DUZ) S PSODIR("CLERK CODE")=DUZ,PSORX("CLERK CODE")=$P($G(^VA(200,DUZ,0)),"^") G CLERKX
"RTN","PSODIR3",46,0)
 K DIR,DIC
"RTN","PSODIR3",47,0)
 S DIR("A")="CLERK",DIR("B")=$S($G(PSORX("CLERK CODE"))]"":PSORX("CLERK CODE"),1:$P($G(^VA(200,DUZ,0)),"^",2)),DIR(0)="52,16"
"RTN","PSODIR3",48,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") CLERKX
"RTN","PSODIR3",49,0)
 S PSODIR("CLERK CODE")=+Y,PSORX("CLERK CODE")=$P(Y,"^")
"RTN","PSODIR3",50,0)
CLERKX Q
"RTN","PSODIR3",51,0)
 ;
"RTN","PSODIR3",52,0)
DIR ;
"RTN","PSODIR3",53,0)
 S PSODIR("FIELD")=0
"RTN","PSODIR3",54,0)
 G:$G(DIR(0))']"" DIRX
"RTN","PSODIR3",55,0)
 D ^DIR K DIR,DIE,DIC,DA
"RTN","PSODIR3",56,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)),$L($G(X))'>1!(Y="") S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR3",57,0)
 I X[U,$L(X)>1 D JUMP
"RTN","PSODIR3",58,0)
DIRX K DIRUT,DTOUT,DUOUT,DIROUT,PSOX
"RTN","PSODIR3",59,0)
 Q
"RTN","PSODIR3",60,0)
 ;
"RTN","PSODIR3",61,0)
JUMP ;
"RTN","PSODIR3",62,0)
 I $G(PSOEDIT)!($G(OR0)) S PSODIR("DFLG")=1 Q
"RTN","PSODIR3",63,0)
 S X=$P(X,"^",2),DIC="^DD(52,",DIC(0)="QM" D ^DIC K DIC
"RTN","PSODIR3",64,0)
 I Y=-1 S PSODIR("FIELD")=PSODIR("FLD") G JUMPX
"RTN","PSODIR3",65,0)
 I $G(PSONEW1)=0 D JUMP^PSONEW1 G JUMPX
"RTN","PSODIR3",66,0)
 I $G(PSONEW3)=0 D JUMP^PSONEW3 G JUMPX
"RTN","PSODIR3",67,0)
 I $G(PSORENW3)=0 D JUMP^PSORENW3 G JUMPX
"RTN","PSODIR3",68,0)
JUMPX S X="^"_X
"RTN","PSODIR3",69,0)
 Q
"RTN","PSODIR3",70,0)
 ;Continued from PSODIR1, Tag REFOR, Added PSOCS set and changed G REFILLX references to a QUIT
"RTN","PSODIR3",71,0)
REFOR ;
"RTN","PSODIR3",72,0)
 F DEA=1:1 Q:$E($G(PSODRUG("DEA")),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSOCS,"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSOCS,"^",2)=1
"RTN","PSODIR3",73,0)
 I $G(PSOCS) D
"RTN","PSODIR3",74,0)
 .S (PSOX,PSOMAX)=$S($G(CLOZPAT)=2&(PSODIR("DAYS SUPPLY")=14):1,$G(CLOZPAT)=2&(PSODIR("DAYS SUPPLY")=7):3,$G(CLOZPAT)=1&(PSODIR("DAYS SUPPLY")=7):1,$D(CLOZPAT):0,1:5)
"RTN","PSODIR3",75,0)
 .S PSOX=$S('PSOX:0,PSODIR("DAYS SUPPLY")=90:1,1:PSOX),PSDY=PSODIR("DAYS SUPPLY"),PSDY1=$S(PSDY<60:5,PSDY'<60&(PSDY'>89):2,PSDY=90:1,1:0) S PSOX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSODIR3",76,0)
 E  D
"RTN","PSODIR3",77,0)
 .N PSOXX  ;*318
"RTN","PSODIR3",78,0)
 .S PSOXX=11,PSOX1=$S($P($G(PSODIR("PTST NODE")),"^",4)>PSOXX:PSOXX,1:$P($G(PSODIR("PTST NODE")),"^",4)),PSOX=$S(PSOX1=11:PSOXX,1:PSOX1)  ;*318 ADDED THIS LINE
"RTN","PSODIR3",79,0)
 .S (PSOX,PSOMAX)=$S($G(CLOZPAT)=2&(PSODIR("DAYS SUPPLY")=14):1,$G(CLOZPAT)=2&(PSODIR("DAYS SUPPLY")=7):3,$G(CLOZPAT)=1&(PSODIR("DAYS SUPPLY")=7):1,$D(CLOZPAT):0,1:PSOX)  ;*318
"RTN","PSODIR3",80,0)
 .S PSDY=PSODIR("DAYS SUPPLY"),PSDY1=$S(PSDY<60:11,PSDY'<60&(PSDY'>89):5,PSDY=90:3,1:0) S PSOX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSODIR3",81,0)
 K PSOELSE I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A"&($G(PSODRUG("DEA"))'["B")!($G(PSODRUG("DEA"))["F")!($G(PSODRUG("DEA"))[1)!($G(PSODRUG("DEA"))[2) D  Q
"RTN","PSODIR3",82,0)
 .S VALMSG="No refills allowed on "_$S($G(PSODRUG("DEA"))["A":"this narcotic drug.",1:"this drug.")
"RTN","PSODIR3",83,0)
 .W !,VALMSG,!
"RTN","PSODIR3",84,0)
 .S:$D(PSODIR("FIELD")) PSODIR("FIELD")=0 S PSODIR("# OF REFILLS")=0
"RTN","PSODIR3",85,0)
 I $D(CLOZPAT) D
"RTN","PSODIR3",86,0)
 .S PSOX=$S($G(CLOZPAT)=2&(PSODIR("DAYS SUPPLY")=14):1,$G(CLOZPAT)=2&(PSODIR("DAYS SUPPLY")=7):3,$G(CLOZPAT)=1&(PSODIR("DAYS SUPPLY")=7):1,1:0)
"RTN","PSODIR3",87,0)
 .S (PSODIR("# OF REFILLS"),PSODIR("N# REF"))=PSOX
"RTN","PSODIR3",88,0)
 S DIR(0)="N^0:"_PSOX,DIR("A")="# OF REFILLS"
"RTN","PSODIR3",89,0)
 S DIR("B")=$S($G(POERR)&($G(PSODIR("# OF REFILLS"))):PSODIR("# OF REFILLS"),$G(PSODIR("N# REF"))]"":PSODIR("N# REF"),$G(PSODIR("# OF REFILLS"))]"":PSODIR("# OF REFILLS"),$G(PSOX1)]""&(PSOX>PSOX1):PSOX1,1:PSOX)
"RTN","PSODIR3",90,0)
 S DIR("?")="Enter a whole number.  The maximum is set by the DAYS SUPPLY field."
"RTN","PSODIR3",91,0)
 D DIR Q:PSODIR("DFLG")!PSODIR("FIELD")
"RTN","PSODIR3",92,0)
 S (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=Y
"RTN","PSODIR3",93,0)
 Q
"RTN","PSOLBL1")
0^3^B31449940^B31448686
"RTN","PSOLBL1",1,0)
PSOLBL1 ;BHAM ISC/SAB - PRINTS LABEL ; 6/21/13 2:55pm
"RTN","PSOLBL1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**107,110,225,326,367,318**;DEC 1997;Build 13
"RTN","PSOLBL1",3,0)
START S COPIES=COPIES-1
"RTN","PSOLBL1",4,0)
 W $C(13) S $X=0 W "VA (119)",?10,$E(DT,4,5),"/",$E(DT,6,7),"/",$E(DT,2,3) W:('SIDE)&(PRTFL) ?40,"PLEASE REFER ONLY TO '",$S(REF:"1. REFILL REQUEST",1:"2. RENEWAL ORDER"),"'" W:+$G(RXP) ?100,"(PARTIAL)" W:$G(REPRINT) ?110,"(REPRINT)"
"RTN","PSOLBL1",5,0)
 W !,$P(PS,"^",2) W:('SIDE)&(PRTFL) ?40,"INSTRUCTION ON REVERSE SIDE OF THIS FORM" W:'SIDE ?102,"(Filled at ",$P(PS2,"^",2),")"
"RTN","PSOLBL1",6,0)
 W !,$P(PS,"^",7),", ",STATE,"  ",$P(PS,"^",5) W:'SIDE ?83,"*** ",$P(PS2,"^")," ***"
"RTN","PSOLBL1",7,0)
 W !,?22,$S(MW["C":"CERTIFIED MAIL",1:"") W:'SIDE ?38,SSNP,?69,"RX: ",RXN
"RTN","PSOLBL1",8,0)
 W !,?2,PNM W:'SIDE ?38,PNM,?64,"EXPIRES: ",EXDT W:('SIDE)&(PRTFL) ?83,"INDICATE ANY ADDRESS CHANGES"
"RTN","PSOLBL1",9,0)
 W !,?2,$S($D(PSMP(1)):PSMP(1),1:VAPA(1)) W:'SIDE ?38,$E(VAPA(1),1,25),?64,"REFILLS: ",REF ;W:('SIDE)&(PRTFL) ?83,LINE 
"RTN","PSOLBL1",10,0)
 W:('SIDE)&(PRTFL) ?83,"_____PERM.   _____TEMP." W:'PRTFL ?83,"* A 'NEW' RX IS REQUIRED.        *"
"RTN","PSOLBL1",11,0)
 S ADDR(3)=VAPA(4)_", "_$P($G(^DIC(5,+$P(VAPA(5),"^"),0)),"^",2)_"  "_VAPA(6),ADDR(2)="" S:VAPA(2)]"" ADDR(2)=VAPA(2)_" "_VAPA(3)
"RTN","PSOLBL1",12,0)
 I ADDR(2)="" S ADDR(2)=ADDR(3),ADDR(3)=""
"RTN","PSOLBL1",13,0)
 S ADDR(5)=$E(VAPA(4),1,13)_", "_$P($G(^DIC(5,+$P(VAPA(5),"^"),0)),"^",2)_"  "_VAPA(6)
"RTN","PSOLBL1",14,0)
 W !,?2,$S($D(PSMP(2)):PSMP(2),$D(PSMP(1)):"",1:$E(ADDR(2),1,35)) W:'SIDE ?38,$S($G(ADDR(3))="":ADDR(5),1:$E(ADDR(2),1,24)),?62,$S(RFLMSG]"":"*",1:" "),"LST FILL: "
"RTN","PSOLBL1",15,0)
 W:'SIDE $G(PSOLASTF)
"RTN","PSOLBL1",16,0)
 I 'SIDE W:PRTFL ?83,"ADDRESS: ",$E(LINE,1,23) W:'PRTFL ?83,"********** PLEASE NOTE ***********"
"RTN","PSOLBL1",17,0)
 W !,?2,$S($D(PSMP(3)):PSMP(3),$D(PSMP(1)):"",1:ADDR(3)) I 'SIDE W ?38,$S(ADDR(3)'="":ADDR(5),1:""),?64,"ROUTING: ",$S(MW="REGULAR":"MAIL",1:MW) W:PRTFL ?83,"CITY/STATE/ZIP: ",$E(LINE,1,16) W:'PRTFL ?83,"* THIS RX CAN NOT BE 'RENEWED'.  *"
"RTN","PSOLBL1",18,0)
 ;NEW LABEL WHITE SPACE
"RTN","PSOLBL1",19,0)
 I +$G(PSOBARS),'SIDE,$P(PSOPAR,"^",19)'=1 S X="S",X2=PSOINST_"-"_RX W !,?40 S X1=$X W @PSOBAR1,X2,@PSOBAR0,$C(13),!,$S($G(PS55)=2:"***DO NOT MAIL***",1:"**CRITICAL MEDICAL SHIPMENT**")
"RTN","PSOLBL1",20,0)
 E  F NLWS=1:1:5 W ! W:NLWS=5 $S($G(PS55)=2:"***DO NOT MAIL***",1:"**CRITICAL MEDICAL SHIPMENT**")
"RTN","PSOLBL1",21,0)
 ; Printing FDA Medication Guide (if there's one)
"RTN","PSOLBL1",22,0)
 I $$MGONFILE^PSOFDAUT(RX) D
"RTN","PSOLBL1",23,0)
 . W ?83,"Read FDA Med Guide"
"RTN","PSOLBL1",24,0)
 . I $G(REPRINT),'$D(RXRP(RX,"MG")) Q 
"RTN","PSOLBL1",25,0)
 . N FDAMG S FDAMG=$$PRINTMG^PSOFDAMG(RX,$P($G(PSOFDAPT),"^",2))
"RTN","PSOLBL1",26,0)
 W !
"RTN","PSOLBL1",27,0)
 ;
"RTN","PSOLBL1",28,0)
 W !,?8,"VA Medical Center" I 'SIDE W ?38,INT(1)
"RTN","PSOLBL1",29,0)
 W !,$P(PS,"^"),"  ",$P(PS,"^",3),"-",$P(PS,"^",4) W:'SIDE ?38,INT(2) I 'SIDE W:PRTFL ?83 W:'PRTFL ?83,"* PLEASE CONTACT YOUR PHYSICIAN. *"
"RTN","PSOLBL1",30,0)
 W !,?4,RXN,?15,$E(DATE,4,5),"/",$E(DATE,6,7),"/",$E(DATE,2,3),"   (",RXF+1," OF ",1+$P(RXY,"^",9),")" I 'SIDE W ?38,INT(3) W:(PRTFL)&('REF) ?83,"***** FOR PHYSICIAN USE ONLY *****" W:'PRTFL ?83,"**********************************"
"RTN","PSOLBL1",31,0)
 W !,PNM,?29,"#",$P(RXY,"^",7)
"RTN","PSOLBL1",32,0)
 W:'SIDE ?38,"CAP: ",$S(PSCAP:"**NON-SFTY**",1:"SAFETY")," WARN:",WARN,?68,$E(DATE,4,5),"/",$E(DATE,6,7),"/",$E(DATE,2,3)," " S I1=$P($H,",",2)\60 W:'SIDE I1\60,":",(I1#60\10)_(I1#10) W:('SIDE)&(PRTFL) ?83,"SIGNATURE : ",$E(LINE,1,20)
"RTN","PSOLBL1",33,0)
SIG F DR=1:1:$S(SGC<5:4,1:6) D SIG1
"RTN","PSOLBL1",34,0)
 I SGC>4 F I=1:1:22 W ! I I>22-SGC S DR=DR+1,X=$S($D(SGY(DR)):SGY(DR),1:"") W X W:'SIDE ?38,X
"RTN","PSOLBL1",35,0)
 ;I SGC>4 F I=1:1:$S($P($G(PSOPAR),"^",10):22,1:16) W ! I I>($S($P($G(PSOPAR),"^",10):28,1:22)-SGC) S DR=DR+1,X=$S($D(SGY(DR)):SGY(DR),1:"") W X W:'SIDE ?38,X
"RTN","PSOLBL1",36,0)
 W !?3,$E(PHYS,1,14),?25,"(",$P(RXY,"^",16),"/",$S($D(VRPH):VRPH,1:" "),")" W:'SIDE ?38,DRUG,?38+$L(DRUG)," (QTY:",$P(RXY,"^",7)," DAYS:",$P(RXY,"^",8)," FILL: ",RXF+1," OF ",1+$P(RXY,"^",9)," ISD:",ISD,")"
"RTN","PSOLBL1",37,0)
 W !,DRUG W:'SIDE ?38,PHYS,?62,RFLMSG,?100,PATST,"  ",PSCLN
"RTN","PSOLBL1",38,0)
 I $D(PSOBARS),PSOBARS W $C(13),# S $X=0
"RTN","PSOLBL1",39,0)
 E  W !
"RTN","PSOLBL1",40,0)
 I COPIES>0 S SIDE=1 G START
"RTN","PSOLBL1",41,0)
 ;STORE LABEL PRINT NODE
"RTN","PSOLBL1",42,0)
 D NOW^%DTC S NOW=% K %,%H,%I S RXF=0 F I=0:0 S I=$O(^PSRX(RX,1,I)) Q:'I  S RXF=I
"RTN","PSOLBL1",43,0)
 S IR=0 F FDA=0:0 S FDA=$O(^PSRX(RX,"L",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOLBL1",44,0)
 S IR=IR+1,^PSRX(RX,"L",0)="^52.032DA^"_IR_"^"_IR
"RTN","PSOLBL1",45,0)
 S ^PSRX(RX,"L",IR,0)=NOW_"^"_$S($G(RXP):99-RXPI,1:RXF)_"^"_$S($G(PCOMX)]"":$G(PCOMX),1:"From RX number "_$P(^PSRX(RX,0),"^"))_$S($G(RXP):" (Partial)",1:"")_$S($G(REPRINT):" (Reprint)",1:"")_"^"_PDUZ
"RTN","PSOLBL1",46,0)
 ;Storing FDA Medication Guide filename in the Prescription file
"RTN","PSOLBL1",47,0)
 I $$MGONFILE^PSOFDAUT(RX) D
"RTN","PSOLBL1",48,0)
 . I $G(RXRP(RX)),'$G(RXRP(RX,"MG")) Q
"RTN","PSOLBL1",49,0)
 . S ^PSRX(RX,"L",IR,"FDA")=$P($$MGONFILE^PSOFDAUT(RX),"^",2)
"RTN","PSOLBL1",50,0)
 S ^PSRX(RX,"TYPE")=0 K RXF,IR,FDA,NOW,I
"RTN","PSOLBL1",51,0)
 I '$D(PSSPND),$P(PSOPAR,"^",18) D CHCK2^PSOTRLBL
"RTN","PSOLBL1",52,0)
END K PSCLN,%DT,ADDR,DATE,DEA,DR,DR1,DRX,DRUG,FDT,SGY,RXY,RXZ,RYY,RFLMSG,RFL,%H,COPIES,DOB,DRUG,LIM,LMI,LINE,PS,PS1,PS2,INT,ISD,I1,MW,MAIL,STATE,SIDE,SSNP,SS,ST,ST1,PATST,PRTFL,PHYS,PNM,S,SL,SGC,PSMP,PSI,PSJ,VRPH,REPRINT,PS55,PS55X Q
"RTN","PSOLBL1",53,0)
 Q
"RTN","PSOLBL1",54,0)
 ;
"RTN","PSOLBL1",55,0)
SIG1 S X=$S($D(SGY(DR)):SGY(DR),1:"") W !,X
"RTN","PSOLBL1",56,0)
 I 'SIDE W ?38,X I PRTFL W ?83 W:DR=1 ?83,$S('REF:"PRINT NAME: "_$E(LINE,1,25),1:"") W:DR=2 "DATE: ",$E(LINE,1,10) W:(DR=2)&('REF) " DEA# ",$E(LINE,1,6) W:(DR=3)&('REF) "Refills: 0 1 2 3 4 5 6 7 8 9 10 11"
"RTN","PSOLBL1",57,0)
 Q
"RTN","PSOLBL1",58,0)
 ;
"RTN","PSOLBL1",59,0)
OSET I $G(RXFL(RX))']""!($G(RXFL(RX))=0) D  Q
"RTN","PSOLBL1",60,0)
 .S TECH=$P($G(^VA(200,+$P(^PSRX(RX,0),"^",16),0)),"^"),QTY=$P(^PSRX(RX,0),"^",7),PHYS=$S($D(^VA(200,+$P(^PSRX(RX,0),"^",4),0)):$P(^(0),"^"),1:"UKN") D 6^VADPT,PID^VADPT S SSNPN=""
"RTN","PSOLBL1",61,0)
 .S DAYS=$P(^PSRX(RX,0),"^",8),MFG="________",LOT="________"
"RTN","PSOLBL1",62,0)
 I '$D(^PSRX(RX,1,RXFL(RX),0)) K RXFL(RX) Q
"RTN","PSOLBL1",63,0)
 S TECH=$S($D(^VA(200,+$P(^PSRX(RX,1,RXFL(RX),0),"^",7),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSOLBL1",64,0)
 S QTY=$P(^PSRX(RX,1,RXFL(RX),0),"^",4),PHYS=$S($D(^VA(200,+$P(^PSRX(RX,1,RXFL(RX),0),"^",17),0)):$P(^(0),"^"),$D(^VA(200,+$P(^PSRX(RX,0),"^",4),0)):$P(^(0),"^"),1:"UNKNOWN") D 6^VADPT,PID^VADPT S SSNPN=""
"RTN","PSOLBL1",65,0)
 S DAYS=$P(^PSRX(RX,1,RXFL(RX),0),"^",10),LOT="________",MFG="________"
"RTN","PSOLBL1",66,0)
 Q
"RTN","PSOLBLN")
0^2^B63716659^B63718452
"RTN","PSOLBLN",1,0)
PSOLBLN ;BIR/RTR - NEW PRINTS LABEL ;11/18/92
"RTN","PSOLBLN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**16,36,71,107,110,117,135,233,251,387,379,367,383,318**;DEC 1997;Build 13
"RTN","PSOLBLN",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOLBLN",4,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOLBLN",5,0)
 ;External reference to ^VA(200 supported by DBIA 224
"RTN","PSOLBLN",6,0)
 ;External reference to ^SC( supported by DBIA 254
"RTN","PSOLBLN",7,0)
 K PSOSTLK,ZTKDRUG I $L($T(PSOSTALK^PSOTALK1)) D PSOSTALK^PSOTALK1 S PSOSTLK=1 ; PRINT SCRIPTALK LABEL IF APPLICABLE
"RTN","PSOLBLN",8,0)
 I $G(IOS),$G(PSOBARS) I $G(PSOBAR0)=""!($G(PSOBAR1)="") S PSOIOS=IOS D DEVBAR^PSOBMST
"RTN","PSOLBLN",9,0)
 I $G(DFN) D ADD^VADPT
"RTN","PSOLBLN",10,0)
 I '$G(COPIES) S COPIES=""
"RTN","PSOLBLN",11,0)
 S ADDR(33)=$G(VAPA(4))_", "_$P($G(VAPA(5)),"^",2)_"  "_$S($G(VAPA(11))]"":$P($G(VAPA(11)),"^",2),1:$G(VAPA(6))),ADDR(22)=""
"RTN","PSOLBLN",12,0)
 S:$G(VAPA(2))]"" ADDR(22)=$G(VAPA(2))_" "_$G(VAPA(3)),ADDR(22)=$E(ADDR(22),1,46) S:ADDR(22)="" ADDR(22)=ADDR(33),ADDR(33)=""
"RTN","PSOLBLN",13,0)
 S ADDR(4)=$S(ADDR(33)="":ADDR(22),1:ADDR(33)) I $G(VAPA(2))="",$G(VAPA(3))="" S ADDR(2)=ADDR(4),ADDR(3)="",ADDR(4)="" G ST
"RTN","PSOLBLN",14,0)
 I $G(VAPA(2))'="",$G(VAPA(3))="" S ADDR(2)=VAPA(2),ADDR(3)=ADDR(4),ADDR(4)="" G ST
"RTN","PSOLBLN",15,0)
 I $G(VAPA(2))="",$G(VAPA(3))'="" S ADDR(2)=VAPA(3),ADDR(3)=ADDR(4),ADDR(4)="" G ST
"RTN","PSOLBLN",16,0)
 S ADDR(2)=$G(VAPA(2)),ADDR(3)=$G(VAPA(3))
"RTN","PSOLBLN",17,0)
ST I $P($G(^PSRX(RX,3)),"^",3) S PSOPROV=+$P(^(0),"^",4) S PSOPROV=$S($G(RXP):+$P($G(RXP),"^",17),$G(RXF):+$P($G(^PSRX(RX,1,RXF,0)),"^",17),1:PSOPROV) S:'$G(PSOPROV) PSOPROV=+$P(^PSRX(RX,0),"^",4) D
"RTN","PSOLBLN",18,0)
 .I +$P($G(^VA(200,PSOPROV,"PS")),"^",7) S:$P($G(PHYS),"/",2)="" PHYS=$G(PHYS)_"/"_$P($G(^VA(200,+$P($G(^PSRX(RX,3)),"^",3),0)),"^")
"RTN","PSOLBLN",19,0)
 ;
"RTN","PSOLBLN",20,0)
 S:$G(PSOBLALL) PSOBLRX=RX
"RTN","PSOLBLN",21,0)
 S:$D(RXRP(RX)) REPRINT=1 S:$D(RXPR(RX)) RXP=RXPR(RX)
"RTN","PSOLBLN",22,0)
 I $G(PSOSUREP)!($G(PSOEXREP)) S REPRINT=1 S:'$G(RXRP(RX)) RXRP(RX)=1
"RTN","PSOLBLN",23,0)
 S RXY=^PSRX(RX,0),RXSTA=$P(^PSRX(RX,"STA"),"^")
"RTN","PSOLBLN",24,0)
 S RXN=$P(RXY,"^"),ISD=$P(RXY,"^",13),RXF=0,DFN=+$P(RXY,"^",2),SIG=$P($G(^PSRX(RX,"SIG")),"^"),ISD=$E(ISD,4,5)_"/"_$E(ISD,6,7)_"/"_($E(ISD,1,3)+1700),ZY=0,$P(LINE,"_",28)="_"
"RTN","PSOLBLN",25,0)
 S PSOLBLPS=+$P(RXY,"^",3),PSOLBLDR=+$P(RXY,"^",6)
"RTN","PSOLBLN",26,0)
 S NURSE=$S($P($G(^DPT(DFN,"NHC")),"^")="Y":1,$P($G(^PS(55,DFN,40)),"^"):1,1:0) S FDT=$P(^PSRX(RX,2),"^",2),PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:""),PS1=$S($D(^(1)):^(1),1:""),PSOSITE7=$P(^("IB"),"^")
"RTN","PSOLBLN",27,0)
 S PS2=$P(PS,"^")_"^"_$P(PS,"^",6)
"RTN","PSOLBLN",28,0)
 S (EXPDT,EXDT)=$P(^PSRX(RX,2),"^",6),EXDT=$S('EXDT:"",1:$E(EXDT,4,5)_"/"_$E(EXDT,6,7)_"/"_($E(EXDT,1,3)+1700))
"RTN","PSOLBLN",29,0)
 S STATE=$S($D(^DIC(5,+$P(PS,"^",8),0)):$P(^(0),"^",2),1:"UKN")
"RTN","PSOLBLN",30,0)
 S DRUG=$$ZZ^PSOSUTL(RX),DEA=$P($G(^PSDRUG(+$P(RXY,"^",6),0)),"^",3),WARN=$P($G(^(0)),"^",8)
"RTN","PSOLBLN",31,0)
 I $G(^PSRX(RX,"P",+$G(RXP),0))]"" S RXPI=RXP D
"RTN","PSOLBLN",32,0)
 .S RXP=^PSRX(RX,"P",RXP,0)
"RTN","PSOLBLN",33,0)
 .S RXY=$P(RXP,"^")_"^"_$P(RXY,"^",2,6)_"^"_$P(RXP,"^",4)_"^"_$P(RXP,"^",10)_"^"_$P(RXY,"^",9)_"^"_$P($G(^PSRX(RX,"SIG")),"^",2)_"^"_$P(RXP,"^",2)_"^"_$P(RXY,"^",12,14)_"^"_$P(^PSRX(RX,"STA"),"^")_"^"_$P(RXP,"^",7)_"^"_$P(RXY,"^",17,99)
"RTN","PSOLBLN",34,0)
 .S FDT=$P(RXP,"^")
"RTN","PSOLBLN",35,0)
 S MW=$P(RXY,"^",11) I $G(RXFL(RX))'=0 D:$G(RXFL(RX))  I '$G(RXFL(RX)) F I=0:0 S I=$O(^PSRX(RX,1,I)) Q:'I  S RXF=RXF+1 S:'$G(RXP) MW=$P(^PSRX(RX,1,I,0),"^",2) I +^PSRX(RX,1,I,0)'<FDT S FDT=+^(0)
"RTN","PSOLBLN",36,0)
 .I $G(RXFL(RX)),'$D(^PSRX(RX,1,RXFL(RX),0)) K RXFL(RX) Q
"RTN","PSOLBLN",37,0)
 .;PSO*7*266
"RTN","PSOLBLN",38,0)
 .S RXF=RXFL(RX) S:'$G(RXP) MW=$P($G(^PSRX(RX,1,RXF,0)),"^",2) F I=0:0 S I=$O(^PSRX(RX,1,I)) Q:'I  I +^PSRX(RX,1,I,0)'<FDT S FDT=+^(0)
"RTN","PSOLBLN",39,0)
 I MW="W" S PSMP=$G(^PSRX(RX,"MP")) I PSMP]"" D
"RTN","PSOLBLN",40,0)
 .N PSJ S PSJ=0 F PSI=1:1:$L(PSMP) S PSMP(PSI)="",PSJ=PSJ+1 F PSJ=PSJ:1 S PSMP(PSI)=PSMP(PSI)_$P(PSMP," ",PSJ)_" " Q:($L(PSMP(PSI))+$L($P(PSMP," ",PSJ+1))>30)
"RTN","PSOLBLN",41,0)
 .K PSMP(PSI)
"RTN","PSOLBLN",42,0)
 S X=$S($D(^PS(55,DFN,0)):^(0),1:""),PSCAP=$P(X,"^",2),PS55=$P($G(X),"^",3),PS55X=$P($G(X),"^",5)
"RTN","PSOLBLN",43,0)
 I (($G(PS55X)]"")&(PS55>1)&(PS55X<DT)) S PS55=0
"RTN","PSOLBLN",44,0)
 S:MW="M" MW=$S((PS55=1!(PS55=4)):"R",1:MW)
"RTN","PSOLBLN",45,0)
 S MW=$S(MW="M":"REGULAR",MW="R":"CERTIFIED",1:"WINDOW")
"RTN","PSOLBLN",46,0)
 I ($G(PSMP(1))']""&($G(PS55)=2)) S PSMP(1)=$G(SSNPN)
"RTN","PSOLBLN",47,0)
 S DATE=$E(FDT,1,7),REF=$P(RXY,"^",9)-RXF S:'$G(RXP) $P(^PSRX(RX,3),"^")=FDT S:REF<1 REF=0 D ^PSOLBL2 S II=RX D ^PSORFL,RFLDT^PSORFL
"RTN","PSOLBLN",48,0)
 S PATST=$G(^PS(53,+$P(RXY,"^",3),0)) S PRTFL=1 I REF=0 S:('$P(PATST,"^",5))!(DEA["W")!(DEA[1)!(DEA[2) PRTFL=0
"RTN","PSOLBLN",49,0)
 S VRPH=$P(^PSRX(RX,2),"^",10),PSCLN=+$P(RXY,"^",5),PSCLN=$S($D(^SC(PSCLN,0)):$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOLBLN",50,0)
 S PATST=$P(PATST,"^",2),X1=DT,X2=$P(RXY,"^",8)-10 D C^%DTC:REF I $D(^PSRX(RX,2)),$P(^(2),"^",6),REF,X'<$P(^(2),"^",6) S REF=0,VRPH=$P(^(2),"^",10)
"RTN","PSOLBLN",51,0)
 ;
"RTN","PSOLBLN",52,0)
 S COPIES=COPIES-1,$P(ULN,"_",34)="",PSOTRAIL=1 I $G(SIDE) D REP^PSOLBL2 G REP
"RTN","PSOLBLN",53,0)
 S (Y,X1)=EXPDT X ^DD("DD") S EXPDT=Y,Y=$P(^PSRX(RX,0),"^",13) X ^DD("DD") S ISD=Y,X2=DT D ^%DTC S DIFF=X
"RTN","PSOLBLN",54,0)
 S Y=DATE X ^DD("DD") S DATE=Y D NOW^%DTC S Y=% X ^DD("DD") S NOW=Y
"RTN","PSOLBLN",55,0)
 S TECH="("_$S($P($G(^PSRX(+$G(RX),"OR1")),"^",5):$P($G(^PSRX(+$G(RX),"OR1")),"^",5),1:$P(RXY,"^",16))_"/"_$S($G(VRPH)&($P(PSOPAR,"^",32)):VRPH,1:" ")_")"
"RTN","PSOLBLN",56,0)
 S PSZIP=$P(PS,"^",5) S PSOHZIP=$S(PSZIP["-":PSZIP,1:$E(PSZIP,1,5)_$S($E(PSZIP,6,9)]"":"-"_$E(PSZIP,6,9),1:""))
"RTN","PSOLBLN",57,0)
L1 W ?3,"VAMC ",$P(PS,"^",7),", ",STATE,"  ",$G(PSOHZIP),?54,"VAMC ",$P(PS,"^",7),", ",STATE,"  ",$G(PSOHZIP),?102 W $S($G(REPRINT)&($G(PSOBLALL)):"(GROUP REPRINT)",$G(REPRINT):"(REPRINT)",1:"") W:$G(RXP) "(PARTIAL)"
"RTN","PSOLBLN",58,0)
 W !?3,$P(PS2,"^",2),"  ",$P(PS,"^",3),"-",$P(PS,"^",4),"   ",TECH,?54,$P(PS2,"^",2),"  ",$P(PS,"^",3),"-",$P(PS,"^",4),"   ",TECH,?102,$P(PS2,"^",2)," ",TECH," ",NOW
"RTN","PSOLBLN",59,0)
 W !,"Rx# ",RXN,"  ",DATE,"  Fill ",RXF+1," of ",1+$P(RXY,"^",9),?54,"Rx# ",RXN,"  ",DATE,"  Fill ",RXF+1," of ",1+$P(RXY,"^",9),?102,"Rx# ",RXN,"  ",DATE,"  Fill ",RXF+1," of ",1+$P(RXY,"^",9)
"RTN","PSOLBLN",60,0)
 W !,PNM,"  ",$G(SSNPN),?54,PNM,"  ",$G(SSNPN),?102,PNM,"  ",$G(SSNPN)
"RTN","PSOLBLN",61,0)
 F DR=1:1 Q:$G(SGY(DR))=""  D:DR=4!(DR=7)!(DR=10)!(DR=13)  W !,$G(SGY(DR)),?54,$G(SGY(DR)),?102,$S($G(OSGY(DR))]"":OSGY(DR),1:$G(SGY(DR)))
"RTN","PSOLBLN",62,0)
 .F GG=1:1:27 W !
"RTN","PSOLBLN",63,0)
 I DR>4 S KK=$S(DR=5!(DR=8)!(DR=11):2,(DR=6)!(DR=9)!(DR=12):1,1:0) I KK F HH=1:1:KK W !
"RTN","PSOLBLN",64,0)
 I DR=2 W !!
"RTN","PSOLBLN",65,0)
 I DR=3 W !
"RTN","PSOLBLN",66,0)
 W !,$G(PHYS),?54,$G(PHYS),?102,$G(PHYS)
"RTN","PSOLBLN",67,0)
 S PSMF=$S($G(NURSE):"Mfg______Exp______",1:""),PSDU=$P($G(^PSDRUG($P($G(^PSRX(RX,0)),"^",6),660)),"^",8),PSDU=$S(PSDU="":"      "_PSMF,1:PSDU_" "_PSMF)
"RTN","PSOLBLN",68,0)
 W !,"Qty: "_$G(QTY),"  ",$G(PSDU),?54,"Qty: "_$G(QTY),"  ",$G(PSDU),?102,"Qty: "_$G(QTY),"  ",$G(PSDU)
"RTN","PSOLBLN",69,0)
 S ZTKDRUG="XXXXXX   SCRIPTALK RX   XXXXXX"
"RTN","PSOLBLN",70,0)
 I '$G(PSOSTLK) K PSDU,PSMF W !,DRUG,?54,DRUG,?102,DRUG
"RTN","PSOLBLN",71,0)
 I $G(PSOSTLK) K PSDU,PSMF W !,$S($G(PSOSTALK):ZTKDRUG,1:DRUG),?54,DRUG,?102,DRUG
"RTN","PSOLBLN",72,0)
 I $P(RXY,"^",9)-RXF'>0 D ^PSOLBLN1 G L13
"RTN","PSOLBLN",73,0)
 G:DIFF<30 L11
"RTN","PSOLBLN",74,0)
 W !?54,$P(RXY,"^",9)-RXF," Refills remain prior to ",EXPDT,?102,"Mfg "_$G(MFG)_" Lot# "_$G(LOT) G L12
"RTN","PSOLBLN",75,0)
L11 W !?54,"Last fill prior to ",$G(EXPDT),?102,"Mfg "_$G(MFG)_" Lot# "_$G(LOT)
"RTN","PSOLBLN",76,0)
L12 W !,$P(PS,"^",2),?54,$S($L($G(COPAYVAR)):$G(COPAYVAR)_"     ",1:""),"Days Supply: ",$G(DAYS),?102,"Tech__________RPh_________",!,$P(PS,"^",7),", ",STATE,"  ",$G(PSOHZIP)
"RTN","PSOLBLN",77,0)
 ;send a CR for OPTIFIL (P-MT661BC)
"RTN","PSOLBLN",78,0)
 I $G(PSOBARS),$P(PSOPAR,"^",19)'=1 S X="S",X2=PSOINST_"-"_RX S X1=$X W ?54,@PSOBAR1,X2,@PSOBAR0,$C(13) S $X=0 W:IOST["P-MT661BC" !
"RTN","PSOLBLN",79,0)
 E  W !!!
"RTN","PSOLBLN",80,0)
 W !,"ADDRESS SERVICE REQUESTED"
"RTN","PSOLBLN",81,0)
 ;
"RTN","PSOLBLN",82,0)
 ; Printing FDA Medication Guide (if there's one)
"RTN","PSOLBLN",83,0)
 I $$MGONFILE^PSOFDAUT(RX) D
"RTN","PSOLBLN",84,0)
 . W ?102,"Read FDA Med Guide"
"RTN","PSOLBLN",85,0)
 . I $G(REPRINT),'$D(RXRP(RX,"MG")) Q 
"RTN","PSOLBLN",86,0)
 . N FDAMG S FDAMG=$$PRINTMG^PSOFDAMG(RX,$P($G(PSOFDAPT),"^",2))
"RTN","PSOLBLN",87,0)
 ;
"RTN","PSOLBLN",88,0)
 W:"C"[$E(MW) !,?21,"CERTIFIED MAIL" W !?54,$G(VAPA(1))
"RTN","PSOLBLN",89,0)
 W !,$S($G(PS55)=2:"***DO NOT MAIL***",1:"***CRITICAL MEDICAL SHIPMENT***"),?54,$G(ADDR(2)),?102,"Routing: "_$S("W"[$E(MW):MW,1:MW_" MAIL")
"RTN","PSOLBLN",90,0)
 W !?54,$G(ADDR(3)),?102,"Days supply: ",$G(DAYS)," Cap: ",$S(PSCAP:"**NON-SFTY**",1:"SAFETY")
"RTN","PSOLBLN",91,0)
 W !?54,$G(ADDR(4)),?102,"Isd: ",ISD," Exp: ",EXPDT
"RTN","PSOLBLN",92,0)
 W !,PNM,?54,"*Indicate address change on back of this form",?102,"Last Fill: ",$G(PSOLASTF)
"RTN","PSOLBLN",93,0)
 W !,$S($D(PSMP(1)):PSMP(1),1:$G(VAPA(1))),?54,"[ ] Permanent",?102,"Pat. Stat ",PATST," Clinic: ",PSCLN
"RTN","PSOLBLN",94,0)
 W !,$S($D(PSMP(2)):PSMP(2),$D(PSMP(1)):"",1:$G(ADDR(2))),?54,"[ ] Temporary until ",$S($P($G(VAPA(10)),"^",2)]"":$P($G(VAPA(10)),"^",2),1:"__/__/__"),?102,$S($G(WARN)'="":"DRUG WARNING "_$G(WARN),1:"")
"RTN","PSOLBLN",95,0)
 W !,$S($D(PSMP(3)):PSMP(3),$D(PSMP(1)):"",1:$G(ADDR(3))),!,$S($D(PSMP(4)):PSMP(4),$D(PSMP(1)):"",1:$G(ADDR(4))),?54,"Signature",ULN
"RTN","PSOLBLN",96,0)
 I $G(PSOBARS) S X="S",X2=PSOINST_"-"_RX S X1=$X W ?102,@PSOBAR1,X2,@PSOBAR0,$C(13) S $X=0
"RTN","PSOLBLN",97,0)
L13 I $G(WARN)'="",'$G(PSOBLALL) I '$G(PSDFNFLG),'$G(PSOLAPPL) D WARN^PSOLBL2
"RTN","PSOLBLN",98,0)
 W @IOF
"RTN","PSOLBLN",99,0)
REP I COPIES>0 S SIDE=1 G ST
"RTN","PSOLBLN",100,0)
 D NOW^%DTC S NOW=% K %,%H,%I I $G(RXF)="" S RXF=0 F I=0:0 S I=$O(^PSRX(RX,1,I)) Q:'I  S RXF=I
"RTN","PSOLBLN",101,0)
 S IR=0 F FDA=0:0 S FDA=$O(^PSRX(RX,"L",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOLBLN",102,0)
 S IR=IR+1,^PSRX(RX,"L",0)="^52.032DA^"_IR_"^"_IR
"RTN","PSOLBLN",103,0)
 S ^PSRX(RX,"L",IR,0)=NOW_"^"_$S($G(RXP):99-RXPI,1:RXF)_"^"_$S($G(PCOMX)]"":$G(PCOMX),$G(PCOMH(RX))]"":PCOMH(RX),1:"From RX number "_$P(^PSRX(RX,0),"^"))_$S($G(RXP):" (Partial)",1:"")_$S($G(REPRINT):" (Reprint)",1:"")_"^"_PDUZ
"RTN","PSOLBLN",104,0)
 N PSOBADR,PSOTEMP
"RTN","PSOLBLN",105,0)
 S PSOBADR=$$CHKRX^PSOBAI(RX)
"RTN","PSOLBLN",106,0)
 I $G(PSOBADR) S PSOTEMP=$P(PSOBADR,"^",2),PSOBADR=$P(PSOBADR,"^")
"RTN","PSOLBLN",107,0)
 I $G(PSOBADR),'$G(PSOTEMP) D
"RTN","PSOLBLN",108,0)
 .S IR=IR+1,^PSRX(RX,"L",0)="^52.032DA^"_IR_"^"_IR
"RTN","PSOLBLN",109,0)
 .S ^PSRX(RX,"L",IR,0)=NOW_"^"_$S($G(RXP):99-RXPI,1:RXF)_"^"_"ROUTING="_$G(MW)_" (BAD ADDRESS)"_"^"_PDUZ
"RTN","PSOLBLN",110,0)
 ;Storing FDA Medication Guide filename in the Prescription file
"RTN","PSOLBLN",111,0)
 I $$MGONFILE^PSOFDAUT(RX) D
"RTN","PSOLBLN",112,0)
 . I $G(RXRP(RX)),'$G(RXRP(RX,"MG")) Q
"RTN","PSOLBLN",113,0)
 . S ^PSRX(RX,"L",IR,"FDA")=$P($$MGONFILE^PSOFDAUT(RX),"^",2)
"RTN","PSOLBLN",114,0)
 S ^PSRX(RX,"TYPE")=0 K RXF,IR,FDA,NOW,I,PCOMH(RX)
"RTN","PSOLBLN",115,0)
 I $G(WARN)'="" I $G(PSDFNFLG)!($G(PSOLAPPL)) D ALLWARN^PSOLBLN1
"RTN","PSOLBLN",116,0)
 I $G(WARN)="" I $G(PSDFNFLG)!($G(PSOLAPPL)) D ALL^PSOLBLS
"RTN","PSOLBLN",117,0)
 I $G(PSOBLALL) D:$G(WARN)="" ALL^PSOLBLS D:$G(WARN)'="" ALLWARN^PSOLBLN1
"RTN","PSOLBLN",118,0)
 I '$D(PSSPND),$P(PSOPAR,"^",18) I $G(PSDFNFLG)!($G(PSOLAPPL))!($G(PSOBLALL)) D CHCK2^PSOTRLBL
"RTN","PSOLBLN",119,0)
 D:$G(PSOBLALL) TRAIL^PSOLBL2
"RTN","PSOLBLN",120,0)
END ;
"RTN","PSOLBLN",121,0)
 I $D(RXFLX(RX)) S RXFL(RX)=$G(RXFLX(RX)) K RXFLX
"RTN","PSOLBLN",122,0)
 D KILL^PSOLBL2 Q
"RTN","PSOORRL")
0^5^B64833222^B64370128
"RTN","PSOORRL",1,0)
PSOORRL ;BHAM ISC/SAB - returns patient's outpatient meds ; 7/3/13 4:00pm
"RTN","PSOORRL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**4,20,9,34,54,82,124,132,159,214,225,318**;DEC 1997;Build 13
"RTN","PSOORRL",3,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORRL",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORRL",5,0)
 ;External reference to ^VA(200 supported by DBIA 10060
"RTN","PSOORRL",6,0)
 ;External reference to ^PS(51.2 supported by DBIA 2226
"RTN","PSOORRL",7,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORRL",8,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOORRL",9,0)
 ;External reference to OCL^PSJORRE supported by DBIA 2383
"RTN","PSOORRL",10,0)
 ;External reference to OEL^PSJORRE1 supported by DBIA 2384
"RTN","PSOORRL",11,0)
OCL(DFN,BDT,EDT,VIEW) ;entry point to return condensed list
"RTN","PSOORRL",12,0)
 ; VIEW=0   -  This returns the list as it was returned prior to GUI 27
"RTN","PSOORRL",13,0)
 ; VIEW=1   -  This returns the list in original view GUI 27
"RTN","PSOORRL",14,0)
 ; VIEW=2   -  This is the new sort with GUI 27
"RTN","PSOORRL",15,0)
 ; VIEW=3   -  New sort by Sort by Drug Name/status with GUI 27
"RTN","PSOORRL",16,0)
 D @$S($G(VIEW)=3:"OCL^PSOORRL3",$G(VIEW)=1:"OCL^PSOORRLO",$G(VIEW)=2:"OCL^PSOORRLN",1:"ST")
"RTN","PSOORRL",17,0)
 Q
"RTN","PSOORRL",18,0)
 ;BHW;PSO*7*159;New SD* Variables
"RTN","PSOORRL",19,0)
ST N SD,SDT,SDT1
"RTN","PSOORRL",20,0)
 D:$P($G(^PS(55,DFN,0)),"^",6)'=2 EN^PSOHLUP(DFN)
"RTN","PSOORRL",21,0)
 K ^TMP("PS",$J) S TFN=0,PSBDT=$G(BDT),PSEDT=$G(EDT) I +$G(PSBDT)<1 S X1=DT,X2=-120 D C^%DTC S PSBDT=X
"RTN","PSOORRL",22,0)
 S EXDT=PSBDT-1,IFN=0
"RTN","PSOORRL",23,0)
 F  S EXDT=$O(^PS(55,DFN,"P","A",EXDT)) Q:'EXDT  F  S IFN=$O(^PS(55,DFN,"P","A",EXDT,IFN)) Q:'IFN  D:$D(^PSRX(IFN,0))
"RTN","PSOORRL",24,0)
 .Q:$P($G(^PSRX(IFN,"STA")),"^")=13
"RTN","PSOORRL",25,0)
 .S TFN=TFN+1,RX0=^PSRX(IFN,0),RX2=$G(^(2)),RX3=$G(^(3)),STA=+$G(^("STA")),TRM=0,LSTFD=$P(RX2,"^",2),LSTRD=$P(RX2,"^",13),LSTDS=$P(RX0,"^",8)
"RTN","PSOORRL",26,0)
 .F I=0:0 S I=$O(^PSRX(IFN,1,I)) Q:'I  S TRM=TRM+1,LSTFD=$P(^PSRX(IFN,1,I,0),"^"),LSTDS=$P(^(0),"^",10) S:$P(^(0),"^",18)]"" LSTRD=$P(^(0),"^",18)
"RTN","PSOORRL",27,0)
 .S ^TMP("PS",$J,TFN,0)=IFN_"R;O"_"^"_$P($G(^PSDRUG(+$P(RX0,"^",6),0)),"^")_"^^"_$P(RX2,"^",6)_"^"_($P(RX0,"^",9)-TRM)_"^^^"_$P($G(^PSRX(IFN,"OR1")),"^",2)
"RTN","PSOORRL",28,0)
 .S ^TMP("PS",$J,TFN,"P",0)=$P(RX0,"^",4)_"^"_$P($G(^VA(200,+$P(RX0,"^",4),0)),"^")
"RTN","PSOORRL",29,0)
 .S ST0=$S(STA<12&($P(RX2,"^",6)<DT):11,1:STA)
"RTN","PSOORRL",30,0)
 .S ST=$P("ERROR^ACTIVE^NON-VERIFIED^REFILL FILL^HOLD^NON-VERIFIED^ACTIVE/SUSP^^^^^DONE^EXPIRED^DISCONTINUED^DISCONTINUED^DISCONTINUED^DISCONTINUED (EDIT)^HOLD^","^",ST0+2)
"RTN","PSOORRL",31,0)
 .S ^TMP("PS",$J,TFN,0)=^TMP("PS",$J,TFN,0)_"^"_ST_"^"_LSTFD_"^"_$P(RX0,"^",8)_"^"_$P(RX0,"^",7)_"^^^"_$P(RX0,"^",13)_"^"_LSTRD_"^"_LSTDS
"RTN","PSOORRL",32,0)
 .S ^TMP("PS",$J,TFN,"SCH",0)=0
"RTN","PSOORRL",33,0)
 .S (SCH,SC)=0 F  S SC=$O(^PSRX(IFN,"SCH",SC)) Q:'SC  S SCH=SCH+1,^TMP("PS",$J,TFN,"SCH",SCH,0)=$P(^PSRX(IFN,"SCH",SC,0),"^"),^TMP("PS",$J,TFN,"SCH",0)=^TMP("PS",$J,TFN,"SCH",0)+1
"RTN","PSOORRL",34,0)
 .S ^TMP("PS",$J,TFN,"MDR",0)=0,(MDR,MR)=0 F  S MR=$O(^PSRX(IFN,"MEDR",MR)) Q:'MR  D
"RTN","PSOORRL",35,0)
 ..Q:'$D(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0))  S MDR=MDR+1
"RTN","PSOORRL",36,0)
 ..I $P($G(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0)),"^",3)]"" S ^TMP("PS",$J,TFN,"MDR",MDR,0)=$P(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0),"^",3)
"RTN","PSOORRL",37,0)
 ..I $D(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0)),$P($G(^(0)),"^",3)']"" S ^TMP("PS",$J,TFN,"MDR",MDR,0)=$P(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0),"^")
"RTN","PSOORRL",38,0)
 ..S ^TMP("PS",$J,TFN,"MDR",0)=^TMP("PS",$J,TFN,"MDR",0)+1
"RTN","PSOORRL",39,0)
 .S PSOELSE=0 I $D(^PSRX(IFN,"SIG")),'$P(^PSRX(IFN,"SIG"),"^",2) S PSOELSE=1 S X=$P(^PSRX(IFN,"SIG"),"^") D SIG1^PSOORRL1
"RTN","PSOORRL",40,0)
 .I '$G(PSOELSE) S ITFN=1 D
"RTN","PSOORRL",41,0)
 ..S ^TMP("PS",$J,TFN,"SIG",ITFN,0)=$G(^PSRX(IFN,"SIG1",1,0)),^TMP("PS",$J,TFN,"SIG",0)=+$G(^TMP("PS",$J,TFN,"SIG",0))+1
"RTN","PSOORRL",42,0)
 ..F I=1:0 S I=$O(^PSRX(IFN,"SIG1",I)) Q:'I  S ITFN=ITFN+1,^TMP("PS",$J,TFN,"SIG",ITFN,0)=^PSRX(IFN,"SIG1",I,0),^TMP("PS",$J,TFN,"SIG",0)=+$G(^TMP("PS",$J,TFN,"SIG",0))+1
"RTN","PSOORRL",43,0)
 K PSOELSE
"RTN","PSOORRL",44,0)
 S IFN=0 F  S IFN=$O(^PS(52.41,"P",DFN,IFN)) Q:'IFN  S PSOR=^PS(52.41,IFN,0) D:$P(PSOR,"^",3)="" WAIT D:$P(PSOR,"^",3)'="DC"&($P(PSOR,"^",3)'="DE")&($P(PSOR,"^",3)'="")
"RTN","PSOORRL",45,0)
 .Q:$P(PSOR,"^",3)="RF"
"RTN","PSOORRL",46,0)
 .I $P(PSOR,"^",8)="",$P(PSOR,"^",9)="" D WAIT
"RTN","PSOORRL",47,0)
 .I $P(PSOR,"^",8)="",$P(PSOR,"^",9)="" Q  ; QUIT IF STILL NULL AFTER WAITING
"RTN","PSOORRL",48,0)
 .S TFN=TFN+1,^TMP("PS",$J,TFN,0)=IFN_"P;O^"_$S($P(PSOR,"^",9):$P($G(^PSDRUG($P(PSOR,"^",9),0)),"^"),1:$P(^PS(50.7,$P(PSOR,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(PSOR,"^",8),0),"^",2),0),"^"))
"RTN","PSOORRL",49,0)
 .S ^TMP("PS",$J,TFN,0)=^TMP("PS",$J,TFN,0)_"^^^^^^"_$P(PSOR,"^")_"^"_"PENDING^^^"_$P(PSOR,"^",10)_"^"
"RTN","PSOORRL",50,0)
 .S ^TMP("PS",$J,TFN,0)=^TMP("PS",$J,TFN,0)_"^"_$S($P(PSOR,"^",3)="RNW":1,1:0)
"RTN","PSOORRL",51,0)
 .S SD=0 F SCH=0:0 S SCH=$O(^PS(52.41,IFN,1,SCH)) Q:'SCH  S SD=SD+1,^TMP("PS",$J,TFN,"SCH",SD,0)=$P(^PS(52.41,IFN,1,SCH,1),"^"),^TMP("PS",$J,TFN,"SCH",0)=SD
"RTN","PSOORRL",52,0)
 .S SD=0 F SCH=0:0 S SCH=$O(^PS(52.41,IFN,"SIG",SCH)) Q:'SCH  S SD=SD+1,^TMP("PS",$J,TFN,"SIG",SD,0)=$P(^PS(52.41,IFN,"SIG",SCH,0),"^"),^TMP("PS",$J,TFN,"SIG",0)=SD
"RTN","PSOORRL",53,0)
 .S (IEN,SD)=1,INST=0 F  S INST=$O(^PS(52.41,IFN,2,INST)) Q:'INST  S (MIG,INST(INST))=^PS(52.41,IFN,2,INST,0),^TMP("PS",$J,TFN,"SIO",0)=SD D
"RTN","PSOORRL",54,0)
 ..F SG=1:1:$L(MIG," ") S:$L($G(^TMP("PS",$J,TFN,"SIO",IEN,0))_" "_$P(MIG," ",SG))>80 IEN=IEN+1,SD=SD+1,^TMP("PS",$J,TFN,"SIO",0)=SD S ^TMP("PS",$J,TFN,"SIO",IEN,0)=$G(^TMP("PS",$J,TFN,"SIO",IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORRL",55,0)
 D NVA,OCL^PSJORRE(DFN,BDT,EDT,.TFN,+$G(VIEW)),END^PSOORRL1
"RTN","PSOORRL",56,0)
 K SDT,SDT1,EDT,EDT1,BDT,DBT1,X
"RTN","PSOORRL",57,0)
 Q
"RTN","PSOORRL",58,0)
OEL(DFN,RXNUM) ;returns expanded list on specific order
"RTN","PSOORRL",59,0)
 I $P(RXNUM,";",2)="I" D OEL^PSJORRE1(DFN,$P(RXNUM,";")) Q
"RTN","PSOORRL",60,0)
 D:$P($G(^PS(55,DFN,0)),"^",6)'=2 EN^PSOHLUP(DFN) Q:RXNUM=""
"RTN","PSOORRL",61,0)
 ;BHW;PSO*7*159;New SD
"RTN","PSOORRL",62,0)
 N SD
"RTN","PSOORRL",63,0)
 K INST,IFN,^TMP("PS",$J) S FL=$P(RXNUM,";"),IFN=+FL,RXNUM=$P(RXNUM,";",2)
"RTN","PSOORRL",64,0)
 I $G(FL)["P"!($G(FL)["S") D PEN^PSOORRL1 Q
"RTN","PSOORRL",65,0)
 I $G(FL)["N" D NVA^PSOORRL1 Q
"RTN","PSOORRL",66,0)
 I $G(FL)["V" Q  ;QUIT IF IV ORDER  ;*318
"RTN","PSOORRL",67,0)
 Q:'$D(^PSRX(IFN,0))
"RTN","PSOORRL",68,0)
 S RX0=^PSRX(IFN,0),RX2=$G(^(2)),RX3=$G(^(3)),STA=+$G(^("STA")),TRM=0,LSTFD=$P(RX2,"^",2)
"RTN","PSOORRL",69,0)
 S ^TMP("PS",$J,"RXN",0)=$P(RX0,"^")_"^"_$E($P(RX2,"^",13),1,7)_"^"_$S($P(RX0,"^",11)="W":"W",1:"M")_"^"_$P(RX3,"^",7)_"^"_$S($P($G(^PSRX(IFN,"OR1")),"^",5):$P(^PSRX(IFN,"OR1"),"^",5),1:"")_"^"_$E($P(RX2,"^",2),1,7)_"^"_$E($P(RX2,"^",13),1,7)
"RTN","PSOORRL",70,0)
 D RSTC(0) ;set return to stock node for original
"RTN","PSOORRL",71,0)
 F I=0:0 S I=$O(^PSRX(IFN,1,I)) Q:'I  S TRM=TRM+1,LSTFD=$P(^PSRX(IFN,1,I,0),"^") D
"RTN","PSOORRL",72,0)
 .S ^TMP("PS",$J,"REF",I,0)=$P(^PSRX(IFN,1,I,0),"^")_"^"_$P(^(0),"^",10)_"^"_$P(^(0),"^",4)_"^"_$E($P(^(0),"^",18),1,7)_"^"_$S($P(^(0),"^",2)="W":"W",1:"M")_"^"_$P(^(0),"^",3)
"RTN","PSOORRL",73,0)
 .I $P(^PSRX(IFN,1,I,0),"^",18) S $P(^TMP("PS",$J,"RXN",0),"^",2)=$E($P(^PSRX(IFN,1,I,0),"^",18),1,7)
"RTN","PSOORRL",74,0)
 .S ^TMP("PS",$J,"REF",0)=$G(^TMP("PS",$J,"REF",0))+1
"RTN","PSOORRL",75,0)
 .D RSTC(I) ;set return to stock node for refills
"RTN","PSOORRL",76,0)
 F I=0:0 S I=$O(^PSRX(IFN,"P",I)) Q:'I  D
"RTN","PSOORRL",77,0)
 .S ^TMP("PS",$J,"PAR",I,0)=$P(^PSRX(IFN,"P",I,0),"^")_"^"_$P(^(0),"^",10)_"^"_$P(^(0),"^",4)_"^"_$E($P(^(0),"^",19),1,7)_"^"_$S($P(^(0),"^",2)="W":"W",1:"M")_"^"_$P(^(0),"^",3)
"RTN","PSOORRL",78,0)
 .S ^TMP("PS",$J,"PAR",0)=$G(^TMP("PS",$J,"PAR",0))+1
"RTN","PSOORRL",79,0)
 S ^TMP("PS",$J,0)=$P($G(^PSDRUG(+$P(RX0,"^",6),0)),"^")_"^^"_$P(RX2,"^",6)
"RTN","PSOORRL",80,0)
 S ^TMP("PS",$J,"P",0)=$P(RX0,"^",4)_"^"_$P($G(^VA(200,+$P(RX0,"^",4),0)),"^")
"RTN","PSOORRL",81,0)
 S ST0=$S(STA<12&($P(RX2,"^",6)<DT):11,1:STA)
"RTN","PSOORRL",82,0)
 S ST=$P("ERROR^ACTIVE^NON-VERIFIED^REFILL FILL^HOLD^NON-VERIFIED^ACTIVE/SUSP^^^^^DONE^EXPIRED^DISCONTINUE^DISCONTINUED^DISCONTINUED^DISCONTINUED (EDIT)^HOLD^","^",ST0+2)
"RTN","PSOORRL",83,0)
 S ^TMP("PS",$J,0)=^TMP("PS",$J,0)_"^"_($P(RX0,"^",9)-TRM)_"^"_$P(RX0,"^",13)_"^"_ST_"^"_$P(RX0,"^",8)_"^"_$P(RX0,"^",7)_"^^^"_$P($G(^PSRX(IFN,"OR1")),"^",2)_"^"_LSTFD_"^^"
"RTN","PSOORRL",84,0)
 S ^TMP("PS",$J,"DD",0)=1,^TMP("PS",$J,"DD",1,0)=$P(RX0,"^",6)_"^^"
"RTN","PSOORRL",85,0)
 S COD=$S('$G(^PSDRUG(+$P(RX0,"^",6),"I")):1,+$G(^PSDRUG(+$P(RX0,"^",6),"I"))>DT:1,1:0)
"RTN","PSOORRL",86,0)
 S ^TMP("PS",$J,"DD",1,0)=^TMP("PS",$J,"DD",1,0)_$S($P($G(^PSDRUG(+$P(RX0,"^",6),2)),"^",3)["U"&(COD):$P(RX0,"^",6),1:"") K COD
"RTN","PSOORRL",87,0)
 S ^TMP("PS",$J,"SCH",0)=0,(SCH,SC)=0
"RTN","PSOORRL",88,0)
 F  S SC=$O(^PSRX(IFN,"SCH",SC)) Q:'SC  S SCH=SCH+1,^TMP("PS",$J,"SCH",SCH,0)=$P(^PSRX(IFN,"SCH",SC,0),"^") D
"RTN","PSOORRL",89,0)
 .S ^TMP("PS",$J,"SCH",0)=^TMP("PS",$J,"SCH",0)+1
"RTN","PSOORRL",90,0)
 D MDR^PSOORRL1
"RTN","PSOORRL",91,0)
 S PSOELSE=0 I $D(^PSRX(IFN,"SIG")),'$P(^PSRX(IFN,"SIG"),"^",2) S PSOELSE=1 S X=$P(^PSRX(IFN,"SIG"),"^") D SIG^PSOORRL1
"RTN","PSOORRL",92,0)
 I '$G(PSOELSE) S ITFN=1 D
"RTN","PSOORRL",93,0)
 .S ^TMP("PS",$J,"SIG",ITFN,0)=$G(^PSRX(IFN,"SIG1",1,0)),^TMP("PS",$J,"SIG",0)=+$G(^TMP("PS",$J,"SIG",0))+1
"RTN","PSOORRL",94,0)
 .F I=1:0 S I=$O(^PSRX(IFN,"SIG1",I)) Q:'I  S ITFN=ITFN+1,^TMP("PS",$J,"SIG",ITFN,0)=^PSRX(IFN,"SIG1",I,0),^TMP("PS",$J,"SIG",0)=+$G(^TMP("PS",$J,"SIG",0))+1
"RTN","PSOORRL",95,0)
 K PSOELSE
"RTN","PSOORRL",96,0)
 S ^TMP("PS",$J,"PC",0)=0,ITFN=0
"RTN","PSOORRL",97,0)
 F I=0:0 S I=$O(^PSRX(IFN,"PRC",I)) Q:'I  S ITFN=ITFN+1,^TMP("PS",$J,"PC",ITFN,0)=^PSRX(IFN,"PRC",I,0),^TMP("PS",$J,"PC",0)=^TMP("PS",$J,"PC",0)+1
"RTN","PSOORRL",98,0)
 Q
"RTN","PSOORRL",99,0)
 ;
"RTN","PSOORRL",100,0)
WAIT ; IF PENDING ENTRY STILL BEING BUILT SEE IF IT COMPLETES WITHIN ANOTHER SECOND
"RTN","PSOORRL",101,0)
 H 1 S PSOR=$G(^PS(52.41,IFN,0))
"RTN","PSOORRL",102,0)
 Q
"RTN","PSOORRL",103,0)
 ;
"RTN","PSOORRL",104,0)
NVA ; Set Non-VA Med Orders in the ^TMP Global
"RTN","PSOORRL",105,0)
 ;BHW;PSO*7*159;New SDT,SDT1 Variables
"RTN","PSOORRL",106,0)
 N SDT,SDT1
"RTN","PSOORRL",107,0)
 F I=0:0 S I=$O(^PS(55,DFN,"NVA",I)) Q:'I  S X=$G(^PS(55,DFN,"NVA",I,0)) D
"RTN","PSOORRL",108,0)
 .Q:'$P(X,"^")
"RTN","PSOORRL",109,0)
 .S DRG=$S($P(X,"^",2):$P($G(^PSDRUG($P(X,"^",2),0)),"^"),1:$P(^PS(50.7,$P(X,"^"),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(X,"^"),0),"^",2),0),"^"))
"RTN","PSOORRL",110,0)
 .S SDT=$P(X,"^",9) I 'SDT D TMPBLD Q
"RTN","PSOORRL",111,0)
 .I $E(SDT,4,5),$E(SDT,6,7) D
"RTN","PSOORRL",112,0)
 ..;I $P(X,"^",9) D  Q
"RTN","PSOORRL",113,0)
 ..I $G(BDT),SDT<BDT Q
"RTN","PSOORRL",114,0)
 ..I $G(EDT),SDT>EDT Q
"RTN","PSOORRL",115,0)
 ..I $G(BDT),$P(X,"^",7),$P(X,"^",7)<BDT Q
"RTN","PSOORRL",116,0)
 ..D TMPBLD
"RTN","PSOORRL",117,0)
 .I $E(SDT,4,5),'$E(SDT,6,7) D
"RTN","PSOORRL",118,0)
 ..S SDT1=$E(SDT,1,5),BDT1=$E(+$G(BDT),1,5),EDT1=$E(+$G(EDT),1,5)
"RTN","PSOORRL",119,0)
 ..I $G(BDT1),SDT1<BDT1 Q
"RTN","PSOORRL",120,0)
 ..I $G(EDT1),SDT1>EDT1 Q
"RTN","PSOORRL",121,0)
 ..I $G(BDT1),$P(X,"^",7),$E($P(X,"^",7),1,5)<BDT1 Q
"RTN","PSOORRL",122,0)
 ..D TMPBLD
"RTN","PSOORRL",123,0)
 .I '$E(SDT,4,5),'$E($P(X,"^",9),6,7) D
"RTN","PSOORRL",124,0)
 ..;I $P(X,"^",9) D  Q
"RTN","PSOORRL",125,0)
 ..S SDT1=$E(SDT,1,3),BDT1=$E(+$G(BDT),1,3),EDT1=$E(+$G(EDT),1,3)
"RTN","PSOORRL",126,0)
 ..I $G(BDT1),SDT1<BDT1 Q
"RTN","PSOORRL",127,0)
 ..I $G(EDT1),SDT1>EDT1 Q
"RTN","PSOORRL",128,0)
 ..I $G(BDT1),$P(X,"^",7),$E($P(X,"^",7),1,3)<BDT1 Q
"RTN","PSOORRL",129,0)
 ..D TMPBLD
"RTN","PSOORRL",130,0)
 Q
"RTN","PSOORRL",131,0)
TMPBLD S TFN=$G(TFN)+1,^TMP("PS",$J,TFN,0)=I_"N;O^"_DRG
"RTN","PSOORRL",132,0)
 S $P(^TMP("PS",$J,TFN,0),"^",8)=$P(X,"^",8)_"^"_$S($P(X,"^",7):"DISCONTINUED",1:"ACTIVE")
"RTN","PSOORRL",133,0)
 S ^TMP("PS",$J,TFN,"SCH",0)=1,^TMP("PS",$J,TFN,"SCH",1,0)=$P(X,"^",5)
"RTN","PSOORRL",134,0)
 S ^TMP("PS",$J,TFN,"SIG",0)=1,^TMP("PS",$J,TFN,"SIG",1,0)=$P(X,"^",3)_" "_$P(X,"^",4)_" "_$P(X,"^",5)
"RTN","PSOORRL",135,0)
 Q
"RTN","PSOORRL",136,0)
RSTC(REF) ; return to stock
"RTN","PSOORRL",137,0)
 F J=0:0 S J=$O(^PSRX(IFN,"A",J)) Q:'J  S II=$G(^(J,0)) I $P(II,"^",2)="I",$P(II,"^",4)=REF D
"RTN","PSOORRL",138,0)
 .I REF=0,'$$RXRLDT^PSOBPSUT(IFN,0) S ^TMP("PS",$J,"RXN","RSTC")=$P(II,"^")_"^"_$P(II,"^",3)_"^"_$P(II,"^",5) Q
"RTN","PSOORRL",139,0)
 .I REF>0,'$$RXRLDT^PSOBPSUT(IFN,REF) S ^TMP("PS",$J,"REF",REF,"RSTC")=$P(II,"^")_"^"_$P(II,"^",3)_"^"_$P(II,"^",5)
"RTN","PSOORRL",140,0)
 Q
"RTN","PSOTALK1")
0^1^B4302149^B4301681
"RTN","PSOTALK1",1,0)
PSOTALK1 ;BIR/EJW - SCRIPTALK INTERFACE FROM VISTA (CONT'D) ; 6/21/13 2:57pm
"RTN","PSOTALK1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**135,318**;DEC 1997;Build 13
"RTN","PSOTALK1",3,0)
 ;External reference to File ^PS(51 supported by DBIA 2224
"RTN","PSOTALK1",4,0)
 ;ROB SILVERMAN-HINES DEVELOPED ORIGINAL VISTA CUSTOM SOFTWARE FOR SCRIPTALK
"RTN","PSOTALK1",5,0)
INST ;PARSE OUT PRINTED INSTRUCTIONS TO MAX 46 CHAR PER LINE
"RTN","PSOTALK1",6,0)
 K PSOLNE
"RTN","PSOTALK1",7,0)
 S PSOLEN=0,PSOLINE=1,PSOWDS=$L(SIG," ")
"RTN","PSOTALK1",8,0)
 F PSOWORD=1:1 Q:PSOWORD>PSOWDS  D  ;
"RTN","PSOTALK1",9,0)
 . S PSOLNE(PSOLINE)=$G(PSOLNE(PSOLINE))_$P(SIG," ",PSOWORD)_" "
"RTN","PSOTALK1",10,0)
 . S PSOLEN=$G(PSOLEN)+$L($P(SIG," ",PSOWORD))+1
"RTN","PSOTALK1",11,0)
 . I PSOLEN+$L($P(SIG," ",PSOWORD+1))>46 S PSOLINE=PSOLINE+1,PSOLEN=0
"RTN","PSOTALK1",12,0)
 Q
"RTN","PSOTALK1",13,0)
 ;
"RTN","PSOTALK1",14,0)
LSIG(SIG) ;EXPAND A SIG
"RTN","PSOTALK1",15,0)
 S SGY="" F P=1:1:$L(SIG," ") S X=$P(SIG," ",P) D:X]""  ;
"RTN","PSOTALK1",16,0)
 .I $D(^PS(51,"A",X)) S %=^(X),X=$P(%,"^") I $P(%,"^",2)]"" S Y=$P(SIG,"",P-1),Y=$E(Y,$L(Y)) S:Y>1 X=$P(%,"^",2)
"RTN","PSOTALK1",17,0)
 .S SGY=SGY_X_" "
"RTN","PSOTALK1",18,0)
 Q SGY
"RTN","PSOTALK1",19,0)
 ;
"RTN","PSOTALK1",20,0)
READER(ZDIR0,ZDIRA,ZDIRB) ;BASIC SHELL FOR DIR READS
"RTN","PSOTALK1",21,0)
 N X,Y,DIRUT,DIROUT,DTOUT,DUOUT,DIR,ZREAD
"RTN","PSOTALK1",22,0)
 S DIR(0)=ZDIR0 S:$G(ZDIRA)]"" DIR("A")=ZDIRA S:$G(ZDIRB)]"" DIR("B")=ZDIRB
"RTN","PSOTALK1",23,0)
 D ^DIR K DIR
"RTN","PSOTALK1",24,0)
 S:Y]"" ZREAD=Y
"RTN","PSOTALK1",25,0)
 I $D(DTOUT)!($D(DIRUT)) K ZREAD
"RTN","PSOTALK1",26,0)
 Q $G(ZREAD,"")
"RTN","PSOTALK1",27,0)
 ;
"RTN","PSOTALK1",28,0)
PSOSTALK ; SEE IF SCRIPTALK PATIENT AND PRINTER EXISTS AND IS SET TO AUTO-PRINT
"RTN","PSOTALK1",29,0)
 S PSOSTALK=0
"RTN","PSOTALK1",30,0)
 D AUTO^PSOTALK
"RTN","PSOTALK1",31,0)
 I 'PSOSTALK Q
"RTN","PSOTALK1",32,0)
 D NOW^%DTC S NOW=% K %,%H,%I I $G(RXF)="" S RXF=0 F I=0:0 S I=$O(^PSRX(RX,1,I)) Q:'I  S RXF=I
"RTN","PSOTALK1",33,0)
 S IR=0 F FDA=0:0 S FDA=$O(^PSRX(RX,"L",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOTALK1",34,0)
 S IR=IR+1,^PSRX(RX,"L",0)="^52.032DA^"_IR_"^"_IR
"RTN","PSOTALK1",35,0)
 S ^PSRX(RX,"L",IR,0)=NOW_"^"_$S($G(RXP):99-RXPI,1:RXF)_"^"_"ScripTalk label printed"_$S($G(RXP):" (Partial)",1:"")_$S($G(REPRINT):" (Reprint)",1:"")_"^"_PDUZ_"^"_$G(%ZTIO)
"RTN","PSOTALK1",36,0)
 Q
"RTN","PSOTALK1",37,0)
 ;
"VER")
8.0^22.0
"BLD",9465,6)
^367
**END**
**END**

