Released PSO*7*551 SEQ #457
Extracted from mail message
**KIDS**:PSO*7.0*551^

**INSTALL NAME**
PSO*7.0*551
"BLD",9980,0)
PSO*7.0*551^OUTPATIENT PHARMACY^0^3190214^y
"BLD",9980,1,0)
^^1^1^3190102^
"BLD",9980,1,1,0)
INBOUND ERX MAINTENANCE PATCH 1
"BLD",9980,4,0)
^9.64PA^^
"BLD",9980,6.3)
37
"BLD",9980,"KRN",0)
^9.67PA^779.2^20
"BLD",9980,"KRN",.4,0)
.4
"BLD",9980,"KRN",.401,0)
.401
"BLD",9980,"KRN",.402,0)
.402
"BLD",9980,"KRN",.403,0)
.403
"BLD",9980,"KRN",.5,0)
.5
"BLD",9980,"KRN",.84,0)
.84
"BLD",9980,"KRN",3.6,0)
3.6
"BLD",9980,"KRN",3.8,0)
3.8
"BLD",9980,"KRN",9.2,0)
9.2
"BLD",9980,"KRN",9.8,0)
9.8
"BLD",9980,"KRN",9.8,"NM",0)
^9.68A^17^16
"BLD",9980,"KRN",9.8,"NM",1,0)
PSOERX^^0^B132801417
"BLD",9980,"KRN",9.8,"NM",2,0)
PSOERX1^^0^B99497004
"BLD",9980,"KRN",9.8,"NM",3,0)
PSOERX1B^^0^B203269485
"BLD",9980,"KRN",9.8,"NM",4,0)
PSOERX1C^^0^B64623473
"BLD",9980,"KRN",9.8,"NM",5,0)
PSOERXD1^^0^B131924629
"BLD",9980,"KRN",9.8,"NM",6,0)
PSOERXD2^^0^B183875290
"BLD",9980,"KRN",9.8,"NM",7,0)
PSOERXC1^^0^B104037085
"BLD",9980,"KRN",9.8,"NM",8,0)
PSOERXP1^^0^B28678984
"BLD",9980,"KRN",9.8,"NM",9,0)
PSOERXU1^^0^B152819795
"BLD",9980,"KRN",9.8,"NM",10,0)
PSOERXU4^^0^B68679574
"BLD",9980,"KRN",9.8,"NM",11,0)
PSOERXU6^^0^B117656460
"BLD",9980,"KRN",9.8,"NM",12,0)
PSOERXX3^^0^B88483865
"BLD",9980,"KRN",9.8,"NM",14,0)
PSOORAL1^^0^B156831785
"BLD",9980,"KRN",9.8,"NM",15,0)
PSOERX1A^^0^B150463790
"BLD",9980,"KRN",9.8,"NM",16,0)
PSOERXA1^^0^B188036698
"BLD",9980,"KRN",9.8,"NM",17,0)
PSOERXX5^^0^B161912387
"BLD",9980,"KRN",9.8,"NM","B","PSOERX",1)

"BLD",9980,"KRN",9.8,"NM","B","PSOERX1",2)

"BLD",9980,"KRN",9.8,"NM","B","PSOERX1A",15)

"BLD",9980,"KRN",9.8,"NM","B","PSOERX1B",3)

"BLD",9980,"KRN",9.8,"NM","B","PSOERX1C",4)

"BLD",9980,"KRN",9.8,"NM","B","PSOERXA1",16)

"BLD",9980,"KRN",9.8,"NM","B","PSOERXC1",7)

"BLD",9980,"KRN",9.8,"NM","B","PSOERXD1",5)

"BLD",9980,"KRN",9.8,"NM","B","PSOERXD2",6)

"BLD",9980,"KRN",9.8,"NM","B","PSOERXP1",8)

"BLD",9980,"KRN",9.8,"NM","B","PSOERXU1",9)

"BLD",9980,"KRN",9.8,"NM","B","PSOERXU4",10)

"BLD",9980,"KRN",9.8,"NM","B","PSOERXU6",11)

"BLD",9980,"KRN",9.8,"NM","B","PSOERXX3",12)

"BLD",9980,"KRN",9.8,"NM","B","PSOERXX5",17)

"BLD",9980,"KRN",9.8,"NM","B","PSOORAL1",14)

"BLD",9980,"KRN",19,0)
19
"BLD",9980,"KRN",19.1,0)
19.1
"BLD",9980,"KRN",101,0)
101
"BLD",9980,"KRN",101,"NM",0)
^9.68A^^
"BLD",9980,"KRN",409.61,0)
409.61
"BLD",9980,"KRN",409.61,"NM",0)
^9.68A^1^1
"BLD",9980,"KRN",409.61,"NM",1,0)
PSO ERX PATIENT CENTRIC VIEW^^0
"BLD",9980,"KRN",409.61,"NM","B","PSO ERX PATIENT CENTRIC VIEW",1)

"BLD",9980,"KRN",771,0)
771
"BLD",9980,"KRN",779.2,0)
779.2
"BLD",9980,"KRN",870,0)
870
"BLD",9980,"KRN",8989.51,0)
8989.51
"BLD",9980,"KRN",8989.52,0)
8989.52
"BLD",9980,"KRN",8994,0)
8994
"BLD",9980,"KRN","B",.4,.4)

"BLD",9980,"KRN","B",.401,.401)

"BLD",9980,"KRN","B",.402,.402)

"BLD",9980,"KRN","B",.403,.403)

"BLD",9980,"KRN","B",.5,.5)

"BLD",9980,"KRN","B",.84,.84)

"BLD",9980,"KRN","B",3.6,3.6)

"BLD",9980,"KRN","B",3.8,3.8)

"BLD",9980,"KRN","B",9.2,9.2)

"BLD",9980,"KRN","B",9.8,9.8)

"BLD",9980,"KRN","B",19,19)

"BLD",9980,"KRN","B",19.1,19.1)

"BLD",9980,"KRN","B",101,101)

"BLD",9980,"KRN","B",409.61,409.61)

"BLD",9980,"KRN","B",771,771)

"BLD",9980,"KRN","B",779.2,779.2)

"BLD",9980,"KRN","B",870,870)

"BLD",9980,"KRN","B",8989.51,8989.51)

"BLD",9980,"KRN","B",8989.52,8989.52)

"BLD",9980,"KRN","B",8994,8994)

"BLD",9980,"QUES",0)
^9.62^^
"BLD",9980,"REQB",0)
^9.611^3^3
"BLD",9980,"REQB",1,0)
PSO*7.0*520^1
"BLD",9980,"REQB",2,0)
PSO*7.0*527^1
"BLD",9980,"REQB",3,0)
PSO*7.0*508^1
"BLD",9980,"REQB","B","PSO*7.0*508",3)

"BLD",9980,"REQB","B","PSO*7.0*520",1)

"BLD",9980,"REQB","B","PSO*7.0*527",2)

"KRN",409.61,867,-1)
0^1
"KRN",409.61,867,0)
PSO ERX PATIENT CENTRIC VIEW^1^^80^5^20^0^1^^PSO ERX PCV MENU^PSO ERX PATIENT CENTRIC VIEW^1^^1
"KRN",409.61,867,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,867,"COL",0)
^409.621^14^12
"KRN",409.61,867,"COL",1,0)
ERX PATIENT^5^17^ERX PATIENT
"KRN",409.61,867,"COL",2,0)
DOB^24^10^DOB
"KRN",409.61,867,"COL",3,0)
#^1^4^#
"KRN",409.61,867,"COL",6,0)
NW^57^2^NW
"KRN",409.61,867,"COL",7,0)
WT^60^2^WT
"KRN",409.61,867,"COL",8,0)
IP^63^2^IP
"KRN",409.61,867,"COL",9,0)
HD^66^3^HD
"KRN",409.61,867,"COL",10,0)
TOT^77^3^TOT
"KRN",409.61,867,"COL",11,0)
ED^36^3^ED
"KRN",409.61,867,"COL",12,0)
LOCKED BY^40^16^LOCKED BY
"KRN",409.61,867,"COL",13,0)
CCR^69^3^CCR
"KRN",409.61,867,"COL",14,0)
OTH^73^3^OTH
"KRN",409.61,867,"COL","B","#",3)

"KRN",409.61,867,"COL","B","CCR",13)

"KRN",409.61,867,"COL","B","DOB",2)

"KRN",409.61,867,"COL","B","ED",11)

"KRN",409.61,867,"COL","B","ERX PATIENT",1)

"KRN",409.61,867,"COL","B","HD",9)

"KRN",409.61,867,"COL","B","IP",8)

"KRN",409.61,867,"COL","B","LOCKED BY",12)

"KRN",409.61,867,"COL","B","NW",6)

"KRN",409.61,867,"COL","B","OTH",14)

"KRN",409.61,867,"COL","B","TOT",10)

"KRN",409.61,867,"COL","B","WT",7)

"KRN",409.61,867,"FNL")
D EXIT^PSOERXC1
"KRN",409.61,867,"HDR")
D HDR^PSOERXC1
"KRN",409.61,867,"HLP")
D HELP^PSOERXC1
"KRN",409.61,867,"INIT")
D INIT^PSOERXC1
"MBREQ")
0
"ORD",17,409.61)
409.61;17;1;;;;LME1^XPDIA1;;;LMDEL^XPDIA1
"ORD",17,409.61,0)
LIST TEMPLATE
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
551^3190214
"PKG",141,22,1,"PAH",1,1,0)
^^1^1^3190214
"PKG",141,22,1,"PAH",1,1,1,0)
INBOUND ERX MAINTENANCE PATCH 1
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
16
"RTN","PSOERX")
0^1^B132801417^B122296708
"RTN","PSOERX",1,0)
PSOERX ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERX",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,527,508,551**;DEC 1997;Build 37
"RTN","PSOERX",3,0)
 ;
"RTN","PSOERX",4,0)
EN(SRCH,SORTT,PCV) ; -- main entry point for PSO ERX HOLDING QUEUE
"RTN","PSOERX",5,0)
 N PSOREFSH
"RTN","PSOERX",6,0)
 D EN^VALM("PSO ERX HOLDING QUEUE")
"RTN","PSOERX",7,0)
 Q
"RTN","PSOERX",8,0)
 ;
"RTN","PSOERX",9,0)
HDR ; -- header code
"RTN","PSOERX",10,0)
 S VALMHDR(1)="PSO ERX HOLDING QUEUE"
"RTN","PSOERX",11,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE  - ADDING DEFAULT LOOKBACK PARAMETER
"RTN","PSOERX",12,0)
 S VALMHDR(2)="                     ERX LOOK-BACK DAYS: "_$$GET1^DIQ(59,PSOSITE,10.2,"E")_" ("_$$FMTE^XLFDT($$FMADD^XLFDT(DT,-$$GET1^DIQ(59,PSOSITE,10.2,"E")))_")"
"RTN","PSOERX",13,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERX",14,0)
 I $G(PSOREFSH) K @VALMAR D INIT
"RTN","PSOERX",15,0)
 Q
"RTN","PSOERX",16,0)
 ;
"RTN","PSOERX",17,0)
INIT ; -- init variables and list array
"RTN","PSOERX",18,0)
 ;/BLB/ PSO*7.0*527 - BEING CHANGE - SIGNIFICANT CHANGES HAVE OCCURED TO FACILITATE FASTER PROCESSING TIMES IN THE ERX HOLDING QUEUE
"RTN","PSOERX",19,0)
 N LINE,LINEVAR,X,SGLOB,EF,ESIEN,CHKSTAT,EARY,SUBS,SUBS2,SVAL,SSTWO,EBDATE,ERXIEN,DTLOOP,PTLOOP,ERXDB,ERXDS,ERX,ERXDAT,P5246IEN,BDOVR,EEDATE
"RTN","PSOERX",20,0)
 N CNT
"RTN","PSOERX",21,0)
 S EF=52.49
"RTN","PSOERX",22,0)
 S SGLOB=$NA(^TMP("PSOERX",$J)) K @SGLOB
"RTN","PSOERX",23,0)
 S PSOSRCH=$S($D(SRCH):1,1:0) I PSOSRCH S PSOSRCH(VALMEVL)=""
"RTN","PSOERX",24,0)
 S PSOSRT=$S($D(SORTT):1,1:0) I PSOSRT S PSOSRT(VALMEVL)=""
"RTN","PSOERX",25,0)
 ; initialize LINE
"RTN","PSOERX",26,0)
 I '$G(PSOPINST) Q
"RTN","PSOERX",27,0)
 F CHKSTAT="RJ","RM","PR","E" D
"RTN","PSOERX",28,0)
 .S ESIEN=$$PRESOLV^PSOERXA1(CHKSTAT,"ERX") Q:'ESIEN
"RTN","PSOERX",29,0)
 .S EARY(ESIEN)=""
"RTN","PSOERX",30,0)
 I $D(SRCH) D
"RTN","PSOERX",31,0)
 .I $D(SRCH(1)) S SUBS="EPAT",SVAL=$P(SRCH(1),U) Q
"RTN","PSOERX",32,0)
 .I $D(SRCH(4)) S SUBS="EPROV",SVAL=$P(SRCH(4),U) Q
"RTN","PSOERX",33,0)
 .I $D(SRCH(2)) S SUBS="F",SUBS2="DOB",SVAL=$P(SRCH(2),U) Q
"RTN","PSOERX",34,0)
 .I $D(SRCH(5)) S SUBS="F",SVAL=$P(SRCH(5),U) Q
"RTN","PSOERX",35,0)
 .I $D(SRCH(7)) S SUBS="MTYPE",SVAL=$P(SRCH(7),U) Q
"RTN","PSOERX",36,0)
 .S SUBS="F"
"RTN","PSOERX",37,0)
 I '$D(SRCH) S SUBS="F"
"RTN","PSOERX",38,0)
 S (LINE,CNT)=0
"RTN","PSOERX",39,0)
 ; Look back 90 days
"RTN","PSOERX",40,0)
 S EBDATE=$S($D(SRCH(3)):$P(SRCH(3),U),1:$$FMADD^XLFDT(DT,-90)),EEDATE=$S($D(SRCH(3)):$P(SRCH(3),U,2),1:DT_".9999")
"RTN","PSOERX",41,0)
 ; get lookback days override. Use it if we are not searching by date range.
"RTN","PSOERX",42,0)
 S BDOVR=$$GET1^DIQ(59,PSOSITE,10.2,"E")
"RTN","PSOERX",43,0)
 I $G(PCV) S BDOVR=365
"RTN","PSOERX",44,0)
 I BDOVR,'$D(SRCH(3)) S EBDATE=$$FMADD^XLFDT(DT,-BDOVR)
"RTN","PSOERX",45,0)
 F  S EBDATE=$O(^PS(52.49,SUBS,PSNPINST,EBDATE)) Q:'EBDATE!(EBDATE>EEDATE)!(CNT>998)  D
"RTN","PSOERX",46,0)
 .I $G(SUBS2)="DOB" D  Q
"RTN","PSOERX",47,0)
 ..S P5246IEN=0 F  S P5246IEN=$O(^PS(52.46,SUBS2,SVAL,P5246IEN)) Q:'P5246IEN!(CNT>998)  D
"RTN","PSOERX",48,0)
 ...S ERXIEN=0 F  S ERXIEN=$O(^PS(EF,"EPAT",PSNPINST,EBDATE,P5246IEN,ERXIEN)) Q:'ERXIEN!(CNT>998)  D
"RTN","PSOERX",49,0)
 ....D BLDITEM(ERXIEN,.CNT)
"RTN","PSOERX",50,0)
 .I $G(SVAL)]"" D  Q
"RTN","PSOERX",51,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(EF,SUBS,PSNPINST,EBDATE,SVAL,ERXIEN)) Q:'ERXIEN!(CNT>998)  D
"RTN","PSOERX",52,0)
 ...I $D(PCV),$D(EARY($$GET1^DIQ(52.49,ERXIEN,1,"I"))) Q
"RTN","PSOERX",53,0)
 ...D BLDITEM(ERXIEN,.CNT)
"RTN","PSOERX",54,0)
 .S SSTWO=0 F  S SSTWO=$O(^PS(EF,SUBS,PSNPINST,EBDATE,SSTWO)) Q:'SSTWO!(CNT>998)  D
"RTN","PSOERX",55,0)
 ..; Filter out RJ, RM, and PR status erx's if we are not searching for a specific eRx status
"RTN","PSOERX",56,0)
 ..I '$D(SRCH(5)),$D(EARY(SSTWO)) Q
"RTN","PSOERX",57,0)
 ..; if we are coming from the patient centric view, block RM, RJ, and PR.
"RTN","PSOERX",58,0)
 ..I $D(SRCH),$D(PCV),$D(EARY(SSTWO)) Q
"RTN","PSOERX",59,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(EF,SUBS,PSNPINST,EBDATE,SSTWO,ERXIEN)) Q:'ERXIEN!(CNT>998)  D
"RTN","PSOERX",60,0)
 ...D BLDITEM(ERXIEN,.CNT)
"RTN","PSOERX",61,0)
 S DTLOOP=0
"RTN","PSOERX",62,0)
 F  S DTLOOP=$O(@SGLOB@(DTLOOP)) Q:'DTLOOP  D
"RTN","PSOERX",63,0)
 .S PTLOOP=$S($G(SORTT)=3:0,1:"")
"RTN","PSOERX",64,0)
 .S PTLOOP="" F  S PTLOOP=$O(@SGLOB@(DTLOOP,PTLOOP),$S($G(SORTT)=3:-1,1:1)) Q:PTLOOP=""  D
"RTN","PSOERX",65,0)
 ..S ERXDB="" F  S ERXDB=$O(@SGLOB@(DTLOOP,PTLOOP,ERXDB)) Q:ERXDB=""  D
"RTN","PSOERX",66,0)
 ...S ERXDS="" F  S ERXDS=$O(@SGLOB@(DTLOOP,PTLOOP,ERXDB,ERXDS)) Q:ERXDS=""  D
"RTN","PSOERX",67,0)
 ....S ERX=0 F  S ERX=$O(@SGLOB@(DTLOOP,PTLOOP,ERXDB,ERXDS,ERX)) Q:'ERX  D
"RTN","PSOERX",68,0)
 .....S LINE=LINE+1,LINEVAR=""
"RTN","PSOERX",69,0)
 .....S ERXDAT=$G(@SGLOB@(DTLOOP,PTLOOP,ERXDB,ERXDS,ERX))
"RTN","PSOERX",70,0)
 .....S LINEVAR=$$SETFLD^VALM1(LINE_".",LINEVAR,"#")
"RTN","PSOERX",71,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U),LINEVAR,"PATIENT NAME")
"RTN","PSOERX",72,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,2),LINEVAR,"DOB")
"RTN","PSOERX",73,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,3),LINEVAR,"DRUG")
"RTN","PSOERX",74,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,4),LINEVAR,"PROVIDER")
"RTN","PSOERX",75,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,8),LINEVAR,"STA")
"RTN","PSOERX",76,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,7),LINEVAR,"RECORD DATE")
"RTN","PSOERX",77,0)
 .....D SET^VALM10(LINE,LINEVAR,ERX)
"RTN","PSOERX",78,0)
 I LINE=0 S LINE=LINE+1 D SET^VALM10(LINE,"No results for current query.")
"RTN","PSOERX",79,0)
 S VALMCNT=LINE
"RTN","PSOERX",80,0)
 K @SGLOB
"RTN","PSOERX",81,0)
 Q
"RTN","PSOERX",82,0)
BLDITEM(ERXIEN,CNT) ;
"RTN","PSOERX",83,0)
 N ERXIENS,ERXDAT,RXSTATN,MTYPE,RESTYPE,PATIEN,ERXQFLG,REQIEN,DELTA,FOUND,NMI,PATNM,NEWRX,PTDOBE,EXDS,EXPRIEN,EXPRNM
"RTN","PSOERX",84,0)
 N AUTOST,MANST,ERXSTAT,ERXISTAT,ERXDT,ERXEDT,PTDOB
"RTN","PSOERX",85,0)
 S ERXIENS=ERXIEN_","
"RTN","PSOERX",86,0)
 K ERXDAT D GETS^DIQ(52.49,ERXIENS,".03;.04;.08;1;4.9;3.1;2.1;1;1.2;1.3;52.1","IE","ERXDAT")
"RTN","PSOERX",87,0)
 S RXSTATN=$G(ERXDAT(EF,ERXIENS,1,"E"))
"RTN","PSOERX",88,0)
 S MTYPE=$G(ERXDAT(EF,ERXIENS,.08,"I"))
"RTN","PSOERX",89,0)
 S RESTYPE=$G(ERXDAT(EF,ERXIENS,52.1,"E"))
"RTN","PSOERX",90,0)
 I '$D(SRCH(5)),'$D(SRCH(7)),((RXSTATN="CAN")!(RXSTATN="CNP")!(RXSTATN="CAA")!(RXSTATN="CNE")) Q
"RTN","PSOERX",91,0)
 ; if the eRx is a new refill request and the status is refill request new, check for a response. if no response within 14 days, change to RRE (refill request expired)
"RTN","PSOERX",92,0)
 ; ChangeRequest messages will be checked for expiration status, but will not be displayed in the holding queue list view.
"RTN","PSOERX",93,0)
 I MTYPE="RR",RXSTATN="RRN" D CHKEXP(ERXIEN)
"RTN","PSOERX",94,0)
 S PATIEN=$G(ERXDAT(EF,ERXIENS,.04,"I")) I 'PATIEN S PATIEN=$$GETPAT^PSOERXU5(ERXIEN)
"RTN","PSOERX",95,0)
 I $D(SRCH(1)),PATIEN'=$P($G(SRCH(1)),U) Q
"RTN","PSOERX",96,0)
 S PTDOB=$$GET1^DIQ(52.46,PATIEN,.08,"I")
"RTN","PSOERX",97,0)
 I $D(SRCH(2)),PTDOB'=$G(SRCH(2)) Q
"RTN","PSOERX",98,0)
 I '$D(SRCH)!($G(PCV)),MTYPE="IE",RXSTATN'="RRE" Q
"RTN","PSOERX",99,0)
 I '$D(SRCH)!($G(PCV)),MTYPE="RR" Q
"RTN","PSOERX",100,0)
 ; if this is not a search, is a refill response, and is a response type of 'approved', do not show in the holding queue.
"RTN","PSOERX",101,0)
 I '$D(SRCH(7)),'$D(SRCH(5))!($G(PCV)),MTYPE="RE",RESTYPE="A" Q
"RTN","PSOERX",102,0)
 ; do not display refill response with 'approved with changes' status in the holding queue.
"RTN","PSOERX",103,0)
 S ERXQFLG=0
"RTN","PSOERX",104,0)
 I '$D(SRCH)!($G(PCV)),MTYPE="RE","RXP,RXC,RXA,"[RXSTATN Q
"RTN","PSOERX",105,0)
 I '$D(SRCH)!($G(PCV)),MTYPE="RE",RESTYPE="AWC" D  Q:ERXQFLG
"RTN","PSOERX",106,0)
 .S REQIEN=$$GETREQ^PSOERXU2(ERXIEN) I 'REQIEN Q
"RTN","PSOERX",107,0)
 .D RRDELTA^PSOERXU2(.DELTA,REQIEN,ERXIEN)
"RTN","PSOERX",108,0)
 .I $D(DELTA(52.49,"EXTERNAL PROVIDER")) Q
"RTN","PSOERX",109,0)
 .S ERXQFLG=1
"RTN","PSOERX",110,0)
 I $D(SRCH(7)),MTYPE="" Q
"RTN","PSOERX",111,0)
 N FOUND,NMI
"RTN","PSOERX",112,0)
 S FOUND=0
"RTN","PSOERX",113,0)
 I $D(SRCH(7)) D  Q:'FOUND
"RTN","PSOERX",114,0)
 .F NMI=1:1 D  Q:$P(SRCH(7),U,NMI)=""!(FOUND)
"RTN","PSOERX",115,0)
 ..I $P(SRCH(7),U,NMI)=MTYPE S FOUND=1 Q
"RTN","PSOERX",116,0)
 ; patient name/dob
"RTN","PSOERX",117,0)
 S PATNM=$$GET1^DIQ(52.46,PATIEN,.01,"E") I MTYPE="IE"!(MTYPE="OE") S PATNM=$$GET1^DIQ(52.49,ERXIEN,.08,"E")
"RTN","PSOERX",118,0)
 I '$L(PATNM) D
"RTN","PSOERX",119,0)
 .S NEWRX=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERX",120,0)
 .I NEWRX S PATNM=$$GET1^DIQ(52.49,ERXIEN,.04,"E")
"RTN","PSOERX",121,0)
 .I '$L(PATNM) S PATNM=$$GET1^DIQ(52.49,ERXIEN,.08,"E")
"RTN","PSOERX",122,0)
 .S PATNM="N/A"
"RTN","PSOERX",123,0)
 S PTDOBE=""
"RTN","PSOERX",124,0)
 I PTDOB]"" S PTDOBE=$$FMTE^XLFDT(PTDOB,"2D")
"RTN","PSOERX",125,0)
 I '$L(PTDOB) S (PTDOB,PTDOBE)="N/A"
"RTN","PSOERX",126,0)
 ; external drug/supply
"RTN","PSOERX",127,0)
 S EXDS=$G(ERXDAT(EF,ERXIENS,3.1,"E")) I '$L(EXDS) S EXDS=$$GETDRUG^PSOERXU5(ERXIEN) I '$L(EXDS) S EXDS="N/A"
"RTN","PSOERX",128,0)
 I $D(SRCH(6)),EXDS'[$P($G(SRCH(6)),U) Q
"RTN","PSOERX",129,0)
 ; external provider ien and name
"RTN","PSOERX",130,0)
 S EXPRIEN=$G(ERXDAT(EF,ERXIENS,2.1,"I")) I 'EXPRIEN S EXPRIEN=$$GETPROV^PSOERXU5(ERXIEN)
"RTN","PSOERX",131,0)
 I $D(SRCH(4)),EXPRIEN'=$P($G(SRCH(4)),U,1) Q
"RTN","PSOERX",132,0)
 ; if there is no external provider, quit - FUTURE ENHANCEMENT - may need to find a way to log, view, and deal with these instances.
"RTN","PSOERX",133,0)
 ; PSO*7*508 - if there is no provider, set it to 'UNKNOWN', and do not quit (may use N/A instead)
"RTN","PSOERX",134,0)
 S EXPRNM=$$GET1^DIQ(52.48,EXPRIEN,.01,"E") I '$L(EXPRNM) S EXPRNM="N/A"
"RTN","PSOERX",135,0)
 ; auto and manual validation status
"RTN","PSOERX",136,0)
 S AUTOST=$G(ERXDAT(EF,ERXIENS,1.2,"E"))
"RTN","PSOERX",137,0)
 S MANST=$G(ERXDAT(EF,ERXIENS,1.3,"E"))
"RTN","PSOERX",138,0)
 S ERXSTAT=$G(ERXDAT(EF,ERXIENS,1,"E"))
"RTN","PSOERX",139,0)
 S ERXISTAT=$G(ERXDAT(EF,ERXIENS,1,"I"))
"RTN","PSOERX",140,0)
 I $D(SRCH(5)),ERXSTAT'=$P(SRCH(5),U,2) Q
"RTN","PSOERX",141,0)
 ; date ERX was received
"RTN","PSOERX",142,0)
 S ERXDT=$G(ERXDAT(EF,ERXIENS,.03,"I")),ERXEDT=$$FMTE^XLFDT($P(ERXDT,"."),"2D")
"RTN","PSOERX",143,0)
 S CNT=CNT+1
"RTN","PSOERX",144,0)
 I $G(SORTT) D  Q
"RTN","PSOERX",145,0)
 .I SORTT=1 S @SGLOB@(1,PATNM,ERXDT-9999999,EXPRNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",146,0)
 .I SORTT=2 S @SGLOB@(1,PTDOB,ERXDT-9999999,PATNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",147,0)
 .I SORTT=3 S @SGLOB@(1,ERXDT-9999999,PATNM,EXPRNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",148,0)
 .I SORTT=4 S @SGLOB@(1,EXPRNM,ERXDT,PATNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",149,0)
 .I SORTT=5 S @SGLOB@(1,ERXSTAT,PATNM,ERXDT-9999999,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",150,0)
 .I SORTT=6 S @SGLOB@(1,EXDS,PATNM,ERXDT-9999999,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",151,0)
 .I SORTT=7 D
"RTN","PSOERX",152,0)
 ..; MTYPE was not defined for 'newrx's from the first release. The post-init converts all rx's to a newRx type
"RTN","PSOERX",153,0)
 ..I MTYPE="" S MTYPE="UNK"
"RTN","PSOERX",154,0)
 ..S @SGLOB@(1,MTYPE,ERXDT-9999999,PATNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",155,0)
 I $D(SRCH(7)) S @SGLOB@(9999999-ERXDT,PATNM,PTDOB,EXDS,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT Q
"RTN","PSOERX",156,0)
 S @SGLOB@(ERXDT,PATNM,PTDOB,EXDS,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",157,0)
 Q
"RTN","PSOERX",158,0)
 ;
"RTN","PSOERX",159,0)
HELP ; -- help code
"RTN","PSOERX",160,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERX",161,0)
 Q
"RTN","PSOERX",162,0)
 ;
"RTN","PSOERX",163,0)
EXIT ; -- exit code
"RTN","PSOERX",164,0)
 K PSOSRCH(VALMEVL),PSOSRT(VALMEVL),@VALMAR,PSOREFSH
"RTN","PSOERX",165,0)
 I VALMEVL=0 K PSOSRCH,PSOSRT
"RTN","PSOERX",166,0)
 ; instruct centric view to refresh
"RTN","PSOERX",167,0)
 I $D(PCV) S VALMBCK="R" S PSOC1RE=1
"RTN","PSOERX",168,0)
 D FULL^VALM1
"RTN","PSOERX",169,0)
 Q
"RTN","PSOERX",170,0)
 ;
"RTN","PSOERX",171,0)
EX ; early exit logic
"RTN","PSOERX",172,0)
 K PSOSRCH,PSOSRT,SRCH,SORTT
"RTN","PSOERX",173,0)
 D EX^PSOORFI1
"RTN","PSOERX",174,0)
 Q
"RTN","PSOERX",175,0)
EXPND ; -- expand code
"RTN","PSOERX",176,0)
 Q
"RTN","PSOERX",177,0)
 ;
"RTN","PSOERX",178,0)
 ; search list and display results
"RTN","PSOERX",179,0)
SEARCH ;
"RTN","PSOERX",180,0)
 N RES,SVAL,I,DONE,SRCHARY,ERXIEN,ERXLOCK
"RTN","PSOERX",181,0)
 D FULL^VALM1
"RTN","PSOERX",182,0)
 S DONE=0
"RTN","PSOERX",183,0)
 F I=1:1 D  Q:DONE
"RTN","PSOERX",184,0)
 .S RES=$$DIR(,I,.SRCHARY)
"RTN","PSOERX",185,0)
 .I '+RES S DONE=1 Q
"RTN","PSOERX",186,0)
 .S SRCHARY(+RES)=$P(RES,U,2,99)
"RTN","PSOERX",187,0)
 .I $D(SRCHARY(8)) S DONE=1 Q
"RTN","PSOERX",188,0)
 I '$D(SRCHARY) S VALMBCK="R" Q
"RTN","PSOERX",189,0)
 I $G(SRCHARY(8))]"" D  Q
"RTN","PSOERX",190,0)
 .;/BLB PSO*7.0*551 - BEGIN CHANGE - ADDING LOCK FUNCTIONALITY TO SEARCH FUNCTION AND BLOCKING ERX REF# SEARCHES INTO DIFFERENT DIVISIONS
"RTN","PSOERX",191,0)
 .I '$D(^PS(52.49,"B",SRCHARY(8))) W !,"eRx could not be found." D DIRE^PSOERXX1 S VALMBCK="R" Q
"RTN","PSOERX",192,0)
 .S ERXIEN=$O(^PS(52.49,"B",SRCHARY(8),0))
"RTN","PSOERX",193,0)
 .I ERXIEN,$$GET1^DIQ(52.49,ERXIEN,24.1,"I")'=PSNPINST W !!,"eRx does not belong to this division.",! D DIRE^PSOERXX1 S VALMBCK="R" Q
"RTN","PSOERX",194,0)
 .S PATIEN=$$GET1^DIQ(52.49,ERXIEN,.04,"I") Q:'PATIEN
"RTN","PSOERX",195,0)
 .S ERXLOCK=$$L^PSOERX1A(PATIEN,1)
"RTN","PSOERX",196,0)
 .I 'ERXLOCK S DIR(0)="E" D ^DIR K DIR S VALMBCK="R" Q
"RTN","PSOERX",197,0)
 .D EN^PSOERX1(ERXIEN)
"RTN","PSOERX",198,0)
 .D UL^PSOERX1A(PATIEN)
"RTN","PSOERX",199,0)
 .S VALMBCK="R"
"RTN","PSOERX",200,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERX",201,0)
 I $D(STYP) D EN(.SRCHARY,STYP) Q 
"RTN","PSOERX",202,0)
 D EN(.SRCHARY)
"RTN","PSOERX",203,0)
 S VALMBCK="R"
"RTN","PSOERX",204,0)
 Q
"RTN","PSOERX",205,0)
 ; sort target list
"RTN","PSOERX",206,0)
SORT ;
"RTN","PSOERX",207,0)
 N RES,STYP,SVAL
"RTN","PSOERX",208,0)
 D FULL^VALM1
"RTN","PSOERX",209,0)
 S RES=$$DIR(1,0)
"RTN","PSOERX",210,0)
 I '+$P(RES,U) Q
"RTN","PSOERX",211,0)
 S STYP=$P(RES,U)
"RTN","PSOERX",212,0)
 I $D(SRCHARY) D EN(.SRCHARY,STYP) Q
"RTN","PSOERX",213,0)
 D EN(,STYP)
"RTN","PSOERX",214,0)
 Q
"RTN","PSOERX",215,0)
DIR(SORT,CNT,SLIST) ;
"RTN","PSOERX",216,0)
 N DIR,Y,RLINE,STAG,SVAL
"RTN","PSOERX",217,0)
 K DIR
"RTN","PSOERX",218,0)
 S DIR(0)="SO^1:PATIENT NAME;2:DATE OF BIRTH;3:RECEIVED DATE RANGE;4:PROVIDER NAME;5:ERX STATUS;6:DRUG NAME;7:MESSAGE TYPE"
"RTN","PSOERX",219,0)
 I '$D(SORT) S DIR(0)=DIR(0)_";8:ERX REFERENCE NUMBER"
"RTN","PSOERX",220,0)
 I CNT<2 S DIR("L")="Select one of the following "_$S($G(SORT):"sort",1:"search")_" criteria:"
"RTN","PSOERX",221,0)
 I CNT>1 D
"RTN","PSOERX",222,0)
 .S DIR("L")=""
"RTN","PSOERX",223,0)
 .S DIR("L",13)="Select another search criteria or '^' to exit. Press enter to use the currently"
"RTN","PSOERX",224,0)
 .S DIR("L",14)="selected search criteria."
"RTN","PSOERX",225,0)
 S DIR("L",2)=""
"RTN","PSOERX",226,0)
 S DIR("L",3)=" "_$S($D(SLIST(1)):"*",1:"")_"1.) PATIENT NAME"
"RTN","PSOERX",227,0)
 S DIR("L",4)=" "_$S($D(SLIST(2)):"*",1:"")_"2.) DATE OF BIRTH"
"RTN","PSOERX",228,0)
 S DIR("L",5)=" "_$S($D(SLIST(3)):"*",1:"")_"3.) RECEIVED DATE"_$S('$G(SORT):" RANGE",1:"")
"RTN","PSOERX",229,0)
 S DIR("L",6)=" "_$S($D(SLIST(4)):"*",1:"")_"4.) PROVIDER NAME"
"RTN","PSOERX",230,0)
 S DIR("L",7)=" "_$S($D(SLIST(5)):"*",1:"")_"5.) ERX STATUS"
"RTN","PSOERX",231,0)
 S DIR("L",8)=" "_$S($D(SLIST(6)):"*",1:"")_"6.) DRUG NAME"
"RTN","PSOERX",232,0)
 S DIR("L",9)=" "_$S($D(SLIST(7)):"*",1:"")_"7.) MESSAGE TYPE"
"RTN","PSOERX",233,0)
 I '$D(SORT) S DIR("L",10)=" "_$S($D(SLIST(8)):"*",1:"")_"8.) ERX REFERENCE NUMBER"
"RTN","PSOERX",234,0)
 S DIR("L",11)=""
"RTN","PSOERX",235,0)
 S DIR("L",12)=$S($D(SLIST):" * - indicates selected criteria.",1:"")
"RTN","PSOERX",236,0)
 D ^DIR K DIR Q:'Y 0
"RTN","PSOERX",237,0)
 S RES=Y I $G(SORT) Q RES
"RTN","PSOERX",238,0)
 S RLINE=$S(RES=1:"PAT",RES=2:"DOB",RES=3:"RDT",RES=4:"PRVNM",RES=5:"ESTAT",RES=6:"DNAME",RES=7:"MTYPE",RES=8:"EREFNUM",1:"")
"RTN","PSOERX",239,0)
 I RLINE']"" Q 0
"RTN","PSOERX",240,0)
 S STAG=RLINE
"RTN","PSOERX",241,0)
 S SVAL=$$@STAG I SVAL="" Q 0
"RTN","PSOERX",242,0)
 Q RES_U_SVAL
"RTN","PSOERX",243,0)
PAT() ;
"RTN","PSOERX",244,0)
 N Y,DIC
"RTN","PSOERX",245,0)
 S DIC=52.46,DIC(0)="AEMQ" D ^DIC
"RTN","PSOERX",246,0)
 I Y<1 Q ""
"RTN","PSOERX",247,0)
 Q Y
"RTN","PSOERX",248,0)
DOB() ;
"RTN","PSOERX",249,0)
 N %DT,Y
"RTN","PSOERX",250,0)
 S %DT="A"
"RTN","PSOERX",251,0)
 S %DT("A")="Enter the Date of Birth (DOB): "
"RTN","PSOERX",252,0)
 D ^%DT
"RTN","PSOERX",253,0)
 I Y<1 Q ""
"RTN","PSOERX",254,0)
 Q Y
"RTN","PSOERX",255,0)
RDT() ;
"RTN","PSOERX",256,0)
 N BDATE,EDATE,%DT,Y
"RTN","PSOERX",257,0)
 S %DT="A"
"RTN","PSOERX",258,0)
 S %DT("A")="Enter the beginning date: "
"RTN","PSOERX",259,0)
 D ^%DT
"RTN","PSOERX",260,0)
 I Y<0 Q ""
"RTN","PSOERX",261,0)
 S BDATE=Y K Y,%DT
"RTN","PSOERX",262,0)
 S %DT="A"
"RTN","PSOERX",263,0)
 S %DT("A")="Enter the ending date: "
"RTN","PSOERX",264,0)
 S %DT("B")="T"
"RTN","PSOERX",265,0)
 D ^%DT
"RTN","PSOERX",266,0)
 I Y<0 Q ""
"RTN","PSOERX",267,0)
 S EDATE=Y_".999999"
"RTN","PSOERX",268,0)
 Q BDATE_U_EDATE
"RTN","PSOERX",269,0)
PRVNM() ;
"RTN","PSOERX",270,0)
 N Y,DIC
"RTN","PSOERX",271,0)
 S DIC("A")="Select PROVIDER: "
"RTN","PSOERX",272,0)
 S DIC=52.48,DIC(0)="AEQ" D ^DIC
"RTN","PSOERX",273,0)
 I Y<1 Q ""
"RTN","PSOERX",274,0)
 Q Y
"RTN","PSOERX",275,0)
ESTAT() ;
"RTN","PSOERX",276,0)
 ; prompt for erx status
"RTN","PSOERX",277,0)
 N Y,DIC
"RTN","PSOERX",278,0)
 S DIC("A")="Select eRx Status: "
"RTN","PSOERX",279,0)
 S DIC=52.45,DIC(0)="AEQ",DIC("S")="I $D(^PS(52.45,""TYPE"",""ERX"",Y))" D ^DIC
"RTN","PSOERX",280,0)
 I Y<1 Q ""
"RTN","PSOERX",281,0)
 Q Y
"RTN","PSOERX",282,0)
DNAME() ;
"RTN","PSOERX",283,0)
 N DIR,Y
"RTN","PSOERX",284,0)
 S DIR(0)="FO"
"RTN","PSOERX",285,0)
 S DIR("A")="Enter the name or partial name of the incoming eRx drug"
"RTN","PSOERX",286,0)
 D ^DIR
"RTN","PSOERX",287,0)
 I Y=""!(Y="^") Q ""
"RTN","PSOERX",288,0)
 Q $$UP^XLFSTR(Y)
"RTN","PSOERX",289,0)
MTYPE() ;
"RTN","PSOERX",290,0)
 N DIR,Y
"RTN","PSOERX",291,0)
 S DIR(0)="52.49,.08",DIR("A")="Select message type" D ^DIR
"RTN","PSOERX",292,0)
 I Y=""!(Y="^") Q ""
"RTN","PSOERX",293,0)
 Q Y
"RTN","PSOERX",294,0)
MTYPE2 ;
"RTN","PSOERX",295,0)
 N DIR,Y,DONE,SEL
"RTN","PSOERX",296,0)
 S VALMBCK="R"
"RTN","PSOERX",297,0)
 D FULL^VALM1
"RTN","PSOERX",298,0)
 S DIR(0)="52.49,.08",DIR("A")="Select message type" D ^DIR
"RTN","PSOERX",299,0)
 I Y=""!(Y="^") Q
"RTN","PSOERX",300,0)
 S SRCHARY(7)=Y D EN(.SRCHARY)
"RTN","PSOERX",301,0)
 Q
"RTN","PSOERX",302,0)
EREFNUM() ;
"RTN","PSOERX",303,0)
 N DIR,Y
"RTN","PSOERX",304,0)
 S DIR(0)="FO",DIR("A")="Enter the eRx Reference number" D ^DIR
"RTN","PSOERX",305,0)
 I Y=""!(Y="^") Q ""
"RTN","PSOERX",306,0)
 Q $$UP^XLFSTR(Y)
"RTN","PSOERX",307,0)
CHKKEY(DUZ) ;
"RTN","PSOERX",308,0)
 I $D(^XUSEC("PSDRPH",DUZ))!($D(^XUSEC("PSO ERX ADV TECH",DUZ)))!($D(^XUSEC("PSO ERX TECH",DUZ)))!($D(^XUSEC("PSO ERX VIEW",DUZ))) Q 1
"RTN","PSOERX",309,0)
 Q 0
"RTN","PSOERX",310,0)
CHKEXP(IEN) ;
"RTN","PSOERX",311,0)
 N MSGDT,RELMSG,RELMSGT,FOUND
"RTN","PSOERX",312,0)
 S FOUND=0
"RTN","PSOERX",313,0)
 S MSGDT=$$GET1^DIQ(52.49,IEN,.03,"I")
"RTN","PSOERX",314,0)
 S RELMSG=0 F  S RELMSG=$O(^PS(52.49,IEN,201,"B",RELMSG)) Q:'RELMSG  D
"RTN","PSOERX",315,0)
 .S RELMSGT=$$GET1^DIQ(52.49,IEN,.08,"I")
"RTN","PSOERX",316,0)
 .I RELMSGT="RE" S FOUND=1
"RTN","PSOERX",317,0)
 Q:FOUND
"RTN","PSOERX",318,0)
 I $$FMDIFF^XLFDT(DT,MSGDT)>14 S FDA(52.49,IEN_",",1)=$$PRESOLV^PSOERXA1("RRX","ERX") D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX",319,0)
 Q
"RTN","PSOERX1")
0^2^B99497004^B96375321
"RTN","PSOERX1",1,0)
PSOERX1 ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERX1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,527,508,551**;DEC 1997;Build 37
"RTN","PSOERX1",3,0)
 ;
"RTN","PSOERX1",4,0)
EN(PSOIEN) ; -- main entry point for PSO ERX HOLDING QUEUE
"RTN","PSOERX1",5,0)
 D EN^VALM("PSO ERX HQ DISPLAY")
"RTN","PSOERX1",6,0)
 Q
"RTN","PSOERX1",7,0)
 ;
"RTN","PSOERX1",8,0)
HDR ; -- header code
"RTN","PSOERX1",9,0)
 S VALMHDR(1)="eRx Patient: "_$$GET1^DIQ(52.49,PSOIEN,.04,"E")
"RTN","PSOERX1",10,0)
 S VALMHDR(2)="eRx Reference #: "_$$GET1^DIQ(52.49,PSOIEN,.01,"E")
"RTN","PSOERX1",11,0)
 I VALMBCK="R" K @VALMAR S VALMBCK="" D INIT
"RTN","PSOERX1",12,0)
 Q
"RTN","PSOERX1",13,0)
 ;
"RTN","PSOERX1",14,0)
INIT ;
"RTN","PSOERX1",15,0)
 Q:'$G(PSOIEN)
"RTN","PSOERX1",16,0)
 N PATIEN,PHARMIEN,PRVIEN,PHDAT,PATDAT,SUPDAT,PRVDAT,LINE,PRVLNM,PRVMI,PRVFN,EPAT,EPATDOB,VPATIEN,HARY,HL
"RTN","PSOERX1",17,0)
 N VPATNM,VPATDOB,EPRVIEN,EPRVNM,EPRVNPI,VAPRVIEN,VAPRVNM,VAPRVNPI,SUPIEN,ERXDRUG,ERXQTY,ERXFLS,CSCOMM
"RTN","PSOERX1",18,0)
 N ERXDS,ERXDT,VADRG,LINETXT,ERXCOMM,ERXRFLS,PATIENS,VAHREA,VAQTY,VAREF,VASIG,PATDAT,CURSTATE,CURSTATI
"RTN","PSOERX1",19,0)
 N LHFOUND,LHMATCH,LHSTATI,VAPDEAEX,ERXCOMM,COMFRST,COMARY,SIGDATA,SIGLOOP,SFIRST,SGLOOP,SIGARY,VADAYS,NRXIEN
"RTN","PSOERX1",20,0)
 N SLOOP,VASIG,VASARY,FSSIG,VAHSTA,EDIRECT,VAHPER,PAMANVAL,DRMANVAL,PRMANVAL,VPATINST,VAPIARY,VLOOP,FSVPIN
"RTN","PSOERX1",21,0)
 N DRGARY,DLP,MTYPE,MTYPEE,ERXSTAT,STATIEN,PDIAGTXT,SDIAGTXT,RELIEN,RELMTYPE,ERRIEN,LERXSTAT,LOPSTAT,OPIEN,ERXDSUB,COM
"RTN","PSOERX1",22,0)
 S LINE=0
"RTN","PSOERX1",23,0)
 S PATIEN=$$GET1^DIQ(52.49,PSOIEN,.04,"I") I 'PATIEN S PATIEN=$$GETPAT^PSOERXU5(PSOIEN)
"RTN","PSOERX1",24,0)
 S PATIENS=PATIEN_","
"RTN","PSOERX1",25,0)
 D GETS^DIQ(52.46,PATIENS,"**","IE","PATDAT")
"RTN","PSOERX1",26,0)
 S EPAT=$G(PATDAT(52.46,PATIENS,.01,"E"))
"RTN","PSOERX1",27,0)
 S EPATDOB=$G(PATDAT(52.46,PATIENS,.08,"I")),EPATDOB=$$FMTE^XLFDT(EPATDOB,"2D")
"RTN","PSOERX1",28,0)
 S VPATIEN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERX1",29,0)
 S VPATNM=$S(VPATIEN:$$GET1^DIQ(2,VPATIEN,.01,"E"),1:"NOT LINKED")
"RTN","PSOERX1",30,0)
 S VPATDOB=$S(VPATIEN:$$GET1^DIQ(2,VPATIEN,.03,"I"),1:"N/A")
"RTN","PSOERX1",31,0)
 I VPATDOB S VPATDOB=$$FMTE^XLFDT(VPATDOB,"2D")
"RTN","PSOERX1",32,0)
 S PHARMIEN=$$GET1^DIQ(52.49,PSOIEN,2.5,"I")
"RTN","PSOERX1",33,0)
 D GETS^DIQ(52.47,PHARMIEN,"**","E","PHDAT")
"RTN","PSOERX1",34,0)
 S EPRVIEN=$$GET1^DIQ(52.49,PSOIEN,2.1,"I") I 'EPRVIEN S EPRVIEN=$$GETPROV^PSOERXU5(PSOIEN)
"RTN","PSOERX1",35,0)
 S EPRVNM=$$GET1^DIQ(52.48,EPRVIEN,.01,"E")
"RTN","PSOERX1",36,0)
 S EPRVNPI=$$GET1^DIQ(52.48,EPRVIEN,1.5,"E")
"RTN","PSOERX1",37,0)
 S VAPRVIEN=$$GET1^DIQ(52.49,PSOIEN,2.3,"I")
"RTN","PSOERX1",38,0)
 S EDIRECT=$$GET1^DIQ(52.49,PSOIEN,7,"E")
"RTN","PSOERX1",39,0)
 S VAPRVNM=$S(VAPRVIEN:$$GET1^DIQ(200,VAPRVIEN,.01,"E"),1:"NOT LINKED")
"RTN","PSOERX1",40,0)
 S VAPRVNPI=$S(VAPRVIEN:$$GET1^DIQ(200,VAPRVIEN,41.99,"E"),1:"N/A")
"RTN","PSOERX1",41,0)
 D GETS^DIQ(52.48,EPRVIEN,"**","E","PRVDAT")
"RTN","PSOERX1",42,0)
 S SUPIEN=$$GET1^DIQ(52.49,PSOIEN,2.6,"I")
"RTN","PSOERX1",43,0)
 D GETS^DIQ(52.48,SUPIEN,"**","E","SUPDAT")
"RTN","PSOERX1",44,0)
 S PAMANVAL=$$GET1^DIQ(52.49,PSOIEN,1.7,"I")
"RTN","PSOERX1",45,0)
 S PRMANVAL=$$GET1^DIQ(52.49,PSOIEN,1.3,"I")
"RTN","PSOERX1",46,0)
 S DRMANVAL=$$GET1^DIQ(52.49,PSOIEN,1.5,"I")
"RTN","PSOERX1",47,0)
 S MTYPE=$$GET1^DIQ(52.49,PSOIEN,.08,"I")
"RTN","PSOERX1",48,0)
 S MTYPEE=$$GET1^DIQ(52.49,PSOIEN,.08,"E")
"RTN","PSOERX1",49,0)
 S STATIEN=$$GET1^DIQ(52.49,PSOIEN,1,"I")
"RTN","PSOERX1",50,0)
 S ERXSTAT=$$GET1^DIQ(52.45,STATIEN,.02,"E")
"RTN","PSOERX1",51,0)
 ; only set the hold reason if the eRx has a hold status
"RTN","PSOERX1",52,0)
 S CURSTATE=$$GET1^DIQ(52.49,PSOIEN,1,"E")
"RTN","PSOERX1",53,0)
 S VAHREA=""
"RTN","PSOERX1",54,0)
 I $E(CURSTATE,1)="H" D
"RTN","PSOERX1",55,0)
 .S CURSTATI=$$GET1^DIQ(52.49,PSOIEN,1,"I")
"RTN","PSOERX1",56,0)
 .S LHMATCH=999999,LHFOUND=0 F  S LHMATCH=$O(^PS(52.49,PSOIEN,19,LHMATCH),-1) Q:'LHMATCH!(LHFOUND)  D
"RTN","PSOERX1",57,0)
 ..S LHSTATI=$$GET1^DIQ(52.4919,LHMATCH_","_PSOIEN_",",.02,"I") I LHSTATI=CURSTATI D  S LHFOUND=LHMATCH Q
"RTN","PSOERX1",58,0)
 ...S VAHREA=$$GET1^DIQ(52.4919,LHMATCH_","_PSOIEN_",",1)
"RTN","PSOERX1",59,0)
 ...S VAHSTA=$$GET1^DIQ(52.45,LHSTATI,.01,"E")_" - "_$$GET1^DIQ(52.45,LHSTATI,.02,"E")
"RTN","PSOERX1",60,0)
 ...S VAHPER=$$GET1^DIQ(52.4919,LHMATCH_","_PSOIEN_",",.03,"E")
"RTN","PSOERX1",61,0)
 I MTYPE="RE"!(MTYPE="CN") S MTYPEE=$G(MTYPEE)_" - "_$$GET1^DIQ(52.49,PSOIEN,52.1,"E")
"RTN","PSOERX1",62,0)
 S LINETXT=""
"RTN","PSOERX1",63,0)
 S LINE=LINE+1 D SET^VALM10(LINE,MTYPEE),CNTRL^VALM10(LINE,1,$L(MTYPEE),IORVON,IORVOFF)
"RTN","PSOERX1",64,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"eRx Status: "_$S($E(CURSTATE,1)="H":VAHSTA,1:ERXSTAT))
"RTN","PSOERX1",65,0)
 I MTYPE="CA" D
"RTN","PSOERX1",66,0)
 .S NRXIEN=$$RESOLV^PSOERXU2(PSOIEN) Q:'NRXIEN
"RTN","PSOERX1",67,0)
 .S LERXSTAT=$$LASTSTAT^PSOERXU5(NRXIEN)
"RTN","PSOERX1",68,0)
 .; over-ride for new rx's that have no status history
"RTN","PSOERX1",69,0)
 .I '$L(LERXSTAT) S LERXSTAT="N - NEW"
"RTN","PSOERX1",70,0)
 .S OPIEN=$$GET1^DIQ(52.49,NRXIEN,.13,"I") Q:'OPIEN
"RTN","PSOERX1",71,0)
 .S LOPSTAT=$$GET1^DIQ(52,OPIEN,100,"E")
"RTN","PSOERX1",72,0)
 .I NRXIEN S CSCOMM=$$CSCOMM^PSOERXU5(NRXIEN)
"RTN","PSOERX1",73,0)
 I MTYPE="CN" D
"RTN","PSOERX1",74,0)
 .S RELIEN=$$RESOLV^PSOERXU2(PSOIEN) Q:'RELIEN
"RTN","PSOERX1",75,0)
 .S NRXIEN=$$RESOLV^PSOERXU2(RELIEN)
"RTN","PSOERX1",76,0)
 .S LERXSTAT=$$LASTSTAT^PSOERXU5(NRXIEN)
"RTN","PSOERX1",77,0)
 .I NRXIEN S CSCOMM=$$CSCOMM^PSOERXU5(NRXIEN)
"RTN","PSOERX1",78,0)
 .I '$L(LERXSTAT) S LERXSTAT="N - NEW"
"RTN","PSOERX1",79,0)
 .S OPIEN=$$GET1^DIQ(52.49,NRXIEN,.13,"I") Q:'OPIEN
"RTN","PSOERX1",80,0)
 .S LOPSTAT=$$GET1^DIQ(52,OPIEN,100,"E")
"RTN","PSOERX1",81,0)
 I $G(CSCOMM)]"" S LINE=LINE+1 D SET^VALM10(LINE,"Current Status Details: "_CSCOMM)
"RTN","PSOERX1",82,0)
 I $D(LERXSTAT) S LINE=LINE+1 D SET^VALM10(LINE,"Last New Rx status: "_LERXSTAT)
"RTN","PSOERX1",83,0)
 I $D(LOPSTAT) S LINE=LINE+1 D SET^VALM10(LINE,"Outpatient Prescription status: "_LOPSTAT)
"RTN","PSOERX1",84,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",85,0)
 I "RRRE"[MTYPE S LINE=LINE+1 D SET^VALM10(LINE,"**************************MEDICATION PRESCRIBED******************************")
"RTN","PSOERX1",86,0)
 S LINE=LINE+1
"RTN","PSOERX1",87,0)
 ;/BLB/ - PSO*7.0*520 BEGIN CHANGE
"RTN","PSOERX1",88,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Patient: ",$E(EPAT,1,39),1,52)
"RTN","PSOERX1",89,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",EPATDOB,57,20)
"RTN","PSOERX1",90,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",91,0)
 I $L(EPAT)>39 D
"RTN","PSOERX1",92,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"             "_$E(EPAT,40,78))
"RTN","PSOERX1",93,0)
 I $L(EPAT)>78 D
"RTN","PSOERX1",94,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"             "_$E(EPAT,79,135))
"RTN","PSOERX1",95,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1",96,0)
 S LINETXT=""
"RTN","PSOERX1",97,0)
 S LINE=LINE+1
"RTN","PSOERX1",98,0)
 I MTYPE'="CA",MTYPE'="CN" D
"RTN","PSOERX1",99,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Vista Patient"_$S(PAMANVAL:"[v]",1:"")_": ",$E(VPATNM,1,55),1,55)
"RTN","PSOERX1",100,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",VPATDOB,57,20)
"RTN","PSOERX1",101,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",102,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",103,0)
 .S LINE=LINE+1
"RTN","PSOERX1",104,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1",105,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Provider: ",$E(EPRVNM,1,39),1,52)
"RTN","PSOERX1",106,0)
 D ADDITEM^PSOERX1A(.LINETXT,"NPI: ",EPRVNPI,57,20)
"RTN","PSOERX1",107,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",108,0)
 I $L(EPRVNM)>39 D
"RTN","PSOERX1",109,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"              "_$E(EPRVNM,40,77))
"RTN","PSOERX1",110,0)
 I $L(EPRVNM)>77 D
"RTN","PSOERX1",111,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"              "_$E(EPRVNM,78,135))
"RTN","PSOERX1",112,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1",113,0)
 I MTYPE'="CA",MTYPE'="CN" D
"RTN","PSOERX1",114,0)
 .S LINE=LINE+1
"RTN","PSOERX1",115,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Vista Provider"_$S(PRMANVAL:"[v]",1:"")_": ",$E(VAPRVNM,1,55),1,55)
"RTN","PSOERX1",116,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"NPI: ",VAPRVNPI,57,20)
"RTN","PSOERX1",117,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",118,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",119,0)
 S ERXDRUG=$$GET1^DIQ(52.49,PSOIEN,3.1,"E") I '$L(ERXDRUG) S ERXDRUG=$$GETDRUG^PSOERXU5(PSOIEN)
"RTN","PSOERX1",120,0)
 S ERXQTY=$$GET1^DIQ(52.49,PSOIEN,5.1,"E")
"RTN","PSOERX1",121,0)
 S ERXRFLS=$$GET1^DIQ(52.49,PSOIEN,5.6,"E")
"RTN","PSOERX1",122,0)
 ; refills for a refill response is # or refills-1
"RTN","PSOERX1",123,0)
 I MTYPE="RE",ERXRFLS S ERXRFLS=ERXRFLS-1
"RTN","PSOERX1",124,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1",125,0)
 I ERXRFLS="" D
"RTN","PSOERX1",126,0)
 .S ERXRFLS=$$GET1^DIQ(52.49,PSOIEN,5.7,"I")
"RTN","PSOERX1",127,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1",128,0)
 ;I MTYPE="RE",ERXRFLS S ERXRFLS=ERXRFLS-1
"RTN","PSOERX1",129,0)
 S ERXDS=$$GET1^DIQ(52.49,PSOIEN,5.5,"E")
"RTN","PSOERX1",130,0)
 S ERXDT=$$GET1^DIQ(52.49,PSOIEN,.03,"E")
"RTN","PSOERX1",131,0)
 S VADRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"E")
"RTN","PSOERX1",132,0)
 S VAREF=$$GET1^DIQ(52.49,PSOIEN,20.5,"E")
"RTN","PSOERX1",133,0)
 S VAQTY=$$GET1^DIQ(52.49,PSOIEN,20.1,"E")
"RTN","PSOERX1",134,0)
 S VADAYS=$$GET1^DIQ(52.49,PSOIEN,20.2,"E")
"RTN","PSOERX1",135,0)
 I VADRG']"" S VADRG="NOT LINKED"
"RTN","PSOERX1",136,0)
 D TXT2ARY^PSOERXD1(.DRGARY,ERXDRUG,,70)
"RTN","PSOERX1",137,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"eRx Drug: "_$G(DRGARY(1)))
"RTN","PSOERX1",138,0)
 S DLP=1
"RTN","PSOERX1",139,0)
 F  S DLP=$O(DRGARY(DLP)) Q:'DLP  D
"RTN","PSOERX1",140,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"          "_$G(DRGARY(DLP)))
"RTN","PSOERX1",141,0)
 S LINE=LINE+1
"RTN","PSOERX1",142,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Qty: ",ERXQTY,1,17)
"RTN","PSOERX1",143,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Refills: ",ERXRFLS,19,16)
"RTN","PSOERX1",144,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Days Supply: ",ERXDS,37,20)
"RTN","PSOERX1",145,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Date: ",$P(ERXDT,"@"),58,22)
"RTN","PSOERX1",146,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",147,0)
 D TXT2ARY^PSOERXD1(.SIGARY,EDIRECT,,70)
"RTN","PSOERX1",148,0)
 S SFIRST=$O(SIGARY(0))
"RTN","PSOERX1",149,0)
 S SGLOOP=0 F  S SGLOOP=$O(SIGARY(SGLOOP)) Q:'SGLOOP  D
"RTN","PSOERX1",150,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,$S(SGLOOP=SFIRST:"eRx Sig: ",1:"         ")_$G(SIGARY(SGLOOP)))
"RTN","PSOERX1",151,0)
 ; PSO*7*508 - if this is a refill request, response, or inbound error build the proper segments, then quit.
"RTN","PSOERX1",152,0)
 I MTYPE="RR" D  S VALMCNT=LINE Q
"RTN","PSOERX1",153,0)
 .D MEDDIS^PSOERXU3(PSOIEN,"D",.LINE),RRRES^PSOERXU3(PSOIEN,.LINE),RRREQ^PSOERXU3(PSOIEN,.LINE),MSGHIS^PSOERXU3(PSOIEN,.LINE)
"RTN","PSOERX1",154,0)
 I MTYPE="RE" D  S VALMCNT=LINE Q
"RTN","PSOERX1",155,0)
 .D RRRES^PSOERXU3(PSOIEN,.LINE),MEDDIS^PSOERXU3(PSOIEN,"D",.LINE),RRREQ^PSOERXU3(PSOIEN,.LINE),MSGHIS^PSOERXU3(PSOIEN,.LINE)
"RTN","PSOERX1",156,0)
 .; if the status is one of the failed status values, display the error details.
"RTN","PSOERX1",157,0)
 .I $$GET1^DIQ(52.49,PSOIEN,1,"E")="RXF" D PROCERR^PSOERXU3(PSOIEN,.LINE)
"RTN","PSOERX1",158,0)
 I MTYPE="IE" D  S VALMCNT=LINE Q
"RTN","PSOERX1",159,0)
 .S RELIEN=$$RESOLV^PSOERXU2(PSOIEN)
"RTN","PSOERX1",160,0)
 .S RELMTYPE=$$GET1^DIQ(52.49,RELIEN,.08,"I")
"RTN","PSOERX1",161,0)
 .I RELMTYPE="RE" D ERRDISP^PSOERXU3(PSOIEN,.LINE),RRREQ^PSOERXU3(PSOIEN,.LINE),MSGHIS^PSOERXU3(PSOIEN,.LINE) Q
"RTN","PSOERX1",162,0)
 .I RELMTYPE="CA" D ERRDISP^PSOERXU3(PSOIEN,.LINE),CANREQ^PSOERXU5(PSOIEN,.LINE),CANRES^PSOERXU5(PSOIEN,.LINE),MSGHIS^PSOERXU3(PSOIEN,.LINE) Q
"RTN","PSOERX1",163,0)
 .I RELMTYPE="CN" D ERRDISP^PSOERXU3(PSOIEN,.LINE),CANRES^PSOERXU5(PSOIEN,.LINE),CANREQ^PSOERXU5(PSOIEN,.LINE) Q
"RTN","PSOERX1",164,0)
 .D ERRDISP^PSOERXU3(PSOIEN,.LINE),MSGHIS^PSOERXU3(PSOIEN,.LINE)
"RTN","PSOERX1",165,0)
 I MTYPE="CA" D  S VALMCNT=LINE Q
"RTN","PSOERX1",166,0)
 .D CANREQ^PSOERXU5(PSOIEN,.LINE),CANRES^PSOERXU5(PSOIEN,.LINE),MSGHIS^PSOERXU3(PSOIEN,.LINE)
"RTN","PSOERX1",167,0)
 I MTYPE="CN" D  S VALMCNT=LINE Q
"RTN","PSOERX1",168,0)
 .I $$GET1^DIQ(52.49,PSOIEN,1,"E")="CNE" D  Q
"RTN","PSOERX1",169,0)
 ..S ERRIEN=$$GETRESP^PSOERXU2(PSOIEN)
"RTN","PSOERX1",170,0)
 ..D ERRDISP^PSOERXU3(ERRIEN,.LINE),CANRES^PSOERXU5(PSOIEN,.LINE),CANREQ^PSOERXU5(PSOIEN,.LINE),MSGHIS^PSOERXU3(PSOIEN,.LINE) Q
"RTN","PSOERX1",171,0)
 .D CANRES^PSOERXU5(PSOIEN,.LINE),CANREQ^PSOERXU5(PSOIEN,.LINE),MSGHIS^PSOERXU3(PSOIEN,.LINE)
"RTN","PSOERX1",172,0)
 I "RR,RE,CA,CN,IE"'[MTYPE!(MTYPE="N") D
"RTN","PSOERX1",173,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",174,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Vista Drug"_$S(DRMANVAL:"[v]",1:"")_": "_VADRG)
"RTN","PSOERX1",175,0)
 .S LINE=LINE+1
"RTN","PSOERX1",176,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Vista Qty: ",$G(VAQTY),1,25)
"RTN","PSOERX1",177,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Vista Refills: ",$G(VAREF),27,18)
"RTN","PSOERX1",178,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Vista Days Supply: ",$G(VADAYS),54,22)
"RTN","PSOERX1",179,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERX1",180,0)
 .S VASIG=""
"RTN","PSOERX1",181,0)
 .S SLOOP=0 F  S SLOOP=$O(^PS(52.49,PSOIEN,"SIG",SLOOP)) Q:'SLOOP  D
"RTN","PSOERX1",182,0)
 ..I '$L($G(VASIG)) S VASIG=$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0)) Q
"RTN","PSOERX1",183,0)
 ..S VASIG=$G(VASIG)_" "_$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0))
"RTN","PSOERX1",184,0)
 .D TXT2ARY^PSOERXD1(.VASARY,VASIG,,68)
"RTN","PSOERX1",185,0)
 .S FSSIG=$O(VASARY(0))
"RTN","PSOERX1",186,0)
 .;/BLB/ PSO*7.0*551 - BEGIN CHANGE - CHANGED TEXT FROM "DO NOT SUB" TO "SUBSTITUTIONS? :"
"RTN","PSOERX1",187,0)
 .S ERXDSUB=$$GET1^DIQ(52.49,PSOIEN,5.8,"I")
"RTN","PSOERX1",188,0)
 .S ERXDSUB=$S(ERXDSUB=1:"NO",ERXDSUB=0:"YES",1:"")
"RTN","PSOERX1",189,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Substitutions? :"_ERXDSUB)
"RTN","PSOERX1",190,0)
 .;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERX1",191,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Vista Sig: "_$S(FSSIG:$G(VASARY(FSSIG)),1:""))
"RTN","PSOERX1",192,0)
 .S SLOOP=1 F  S SLOOP=$O(VASARY(SLOOP)) Q:'SLOOP  D
"RTN","PSOERX1",193,0)
 ..S LINE=LINE+1 D SET^VALM10(LINE,"                        "_VASARY(SLOOP))
"RTN","PSOERX1",194,0)
 .S VPATINST=$$GET1^DIQ(52.49,PSOIEN,27,"E")
"RTN","PSOERX1",195,0)
 .I VPATINST]"" S VPATINST=$$LSIG^PSOQUTIL(VPATINST)
"RTN","PSOERX1",196,0)
 .D TXT2ARY^PSOERXD1(.VAPIARY,VPATINST,68)
"RTN","PSOERX1",197,0)
 .S FSVPIN=$O(VAPIARY(0))
"RTN","PSOERX1",198,0)
 .S LINE=LINE+1 D SET^VALM10(LINE," Pat Inst: "_$S(FSVPIN:$G(VAPIARY(FSVPIN)),1:""))
"RTN","PSOERX1",199,0)
 .S VLOOP=1 F  S VLOOP=$O(VAPIARY(VLOOP)) Q:'VLOOP  D
"RTN","PSOERX1",200,0)
 ..S LINE=LINE+1 D SET^VALM10(LINE,"                        "_VAPIARY(VLOOP))
"RTN","PSOERX1",201,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Hold Status: "_$G(VAHSTA))
"RTN","PSOERX1",202,0)
 S VAHREA="Hold Reason: "_$G(VAHREA)
"RTN","PSOERX1",203,0)
 D TXT2ARY^PSOERXD1(.HARY,VAHREA," ",80)
"RTN","PSOERX1",204,0)
 S HL=0 F  S HL=$O(HARY(HL)) Q:'HL  D
"RTN","PSOERX1",205,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,$G(HARY(HL)))
"RTN","PSOERX1",206,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Placed on hold by: "_$G(VAHPER))
"RTN","PSOERX1",207,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",208,0)
 S ERXCOMM="eRx Notes: "_$$GET1^DIQ(52.49,PSOIEN,8,"E")
"RTN","PSOERX1",209,0)
 D TXT2ARY^PSOERXD1(.COMARY,ERXCOMM," ",68)
"RTN","PSOERX1",210,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE - CORRECTING DUPLICATE WORD ISSUE ON ERX NOTES
"RTN","PSOERX1",211,0)
 S COM=0 F  S COM=$O(COMARY(COM)) Q:'COM  S LINE=LINE+1 D SET^VALM10(LINE,$G(COMARY(COM)))
"RTN","PSOERX1",212,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERX1",213,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERX1",214,0)
 ;/BLB/ PSO*7.0*520 - BEGIN
"RTN","PSOERX1",215,0)
 I $$GET1^DIQ(52.49,PSOIEN,.05,"I") D
"RTN","PSOERX1",216,0)
 .D ALG^PSOERXU1(.LINE)
"RTN","PSOERX1",217,0)
 ;/BLB/ - END
"RTN","PSOERX1",218,0)
 D DIAG^PSOERXU1(PSOIEN,.LINE)
"RTN","PSOERX1",219,0)
 S VALMCNT=LINE
"RTN","PSOERX1",220,0)
 Q
"RTN","PSOERX1",221,0)
 ;
"RTN","PSOERX1",222,0)
HELP ; -- help code
"RTN","PSOERX1",223,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERX1",224,0)
 Q
"RTN","PSOERX1",225,0)
 ;
"RTN","PSOERX1",226,0)
EXIT ; -- exit code
"RTN","PSOERX1",227,0)
 K @VALMAR
"RTN","PSOERX1",228,0)
 ; PSO*7*527 - set VALMBCK and PSOREFSH to force refresh when returning to list view
"RTN","PSOERX1",229,0)
 S VALMBCK="R",PSOREFSH=1
"RTN","PSOERX1",230,0)
 Q
"RTN","PSOERX1",231,0)
 ;
"RTN","PSOERX1",232,0)
EXPND ; -- expand code
"RTN","PSOERX1",233,0)
 Q
"RTN","PSOERX1A")
0^15^B150463790^B140048297
"RTN","PSOERX1A",1,0)
PSOERX1A ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERX1A",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,527,508,551**;DEC 1997;Build 37
"RTN","PSOERX1A",3,0)
 ;
"RTN","PSOERX1A",4,0)
 Q
"RTN","PSOERX1A",5,0)
 ; select an item
"RTN","PSOERX1A",6,0)
SI ;
"RTN","PSOERX1A",7,0)
 N RESP,ERXIEN,ERXDAT,LINE,LINEVAR,ERXPAT,ERXLOCK,DIR,NEWRXIEN,REQIEN,MTYPE,Y
"RTN","PSOERX1A",8,0)
 D FULL^VALM1
"RTN","PSOERX1A",9,0)
 S DIR(0)="N^"_VALMBG_":"_VALMLST_":0" D ^DIR
"RTN","PSOERX1A",10,0)
 I 'Y S VALMBCK="R" Q
"RTN","PSOERX1A",11,0)
 S RESP=Y
"RTN","PSOERX1A",12,0)
 S ERXIEN=$O(@VALMAR@("IDX",RESP,"")) Q:'ERXIEN
"RTN","PSOERX1A",13,0)
 ; Get the patient IEN
"RTN","PSOERX1A",14,0)
 S ERXPAT=$$GETPAT^PSOERXU5(ERXIEN)
"RTN","PSOERX1A",15,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERX1A",16,0)
 I 'ERXPAT,"IEOE"[MTYPE D EN^PSOERX1(ERXIEN) S VALMBCK="R" Q
"RTN","PSOERX1A",17,0)
 I '$D(PCV) D  Q
"RTN","PSOERX1A",18,0)
 .S ERXLOCK=$$L(ERXPAT,1)
"RTN","PSOERX1A",19,0)
 .I 'ERXLOCK S DIR(0)="E" D ^DIR K DIR S VALMBCK="R" Q
"RTN","PSOERX1A",20,0)
 .D EN^PSOERX1(ERXIEN)
"RTN","PSOERX1A",21,0)
 .D UL(ERXPAT)
"RTN","PSOERX1A",22,0)
 .K % S VALMBCK="R"
"RTN","PSOERX1A",23,0)
 D EN^PSOERX1(ERXIEN)
"RTN","PSOERX1A",24,0)
 K %
"RTN","PSOERX1A",25,0)
 S VALMBCK="R"
"RTN","PSOERX1A",26,0)
 Q
"RTN","PSOERX1A",27,0)
SBN ;
"RTN","PSOERX1A",28,0)
 N Y,ERXIEN,ERXPAT,DIR,MTYPE
"RTN","PSOERX1A",29,0)
 D FULL^VALM1
"RTN","PSOERX1A",30,0)
 S Y=+$P(XQORNOD(0),"=",2)
"RTN","PSOERX1A",31,0)
 I 'Y S VALMBCK="R" Q
"RTN","PSOERX1A",32,0)
 S ERXIEN=$O(@VALMAR@("IDX",Y,"")) Q:'ERXIEN
"RTN","PSOERX1A",33,0)
 S ERXPAT=$$GETPAT^PSOERXU5(ERXIEN)
"RTN","PSOERX1A",34,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERX1A",35,0)
 I 'ERXPAT,"IEOE"[MTYPE D EN^PSOERX1(ERXIEN) S VALMBCK="R" Q
"RTN","PSOERX1A",36,0)
 I '$D(PCV) D  Q
"RTN","PSOERX1A",37,0)
 .S ERXLOCK=$$L(ERXPAT,1)
"RTN","PSOERX1A",38,0)
 .I 'ERXLOCK S DIR(0)="E" D ^DIR K DIR S VALMBCK="R" Q
"RTN","PSOERX1A",39,0)
 .D EN^PSOERX1(ERXIEN)
"RTN","PSOERX1A",40,0)
 .D UL(ERXPAT)
"RTN","PSOERX1A",41,0)
 .S VALMBCK="R" K %
"RTN","PSOERX1A",42,0)
 D EN^PSOERX1(ERXIEN)
"RTN","PSOERX1A",43,0)
 S VALMBCK="R"
"RTN","PSOERX1A",44,0)
 K %
"RTN","PSOERX1A",45,0)
 Q
"RTN","PSOERX1A",46,0)
L(DFN,DIS) ;
"RTN","PSOERX1A",47,0)
 I $G(PSONOLCK) Q 1
"RTN","PSOERX1A",48,0)
 N FLAG S ^XTMP("PSOERXLOCK",0)=$$PDATE
"RTN","PSOERX1A",49,0)
 ; if a lock is already established for this patient and is associated with the current user
"RTN","PSOERX1A",50,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANHE
"RTN","PSOERX1A",51,0)
 I $P($G(^XTMP("PSOERXLOCK",DFN)),"^",1)=DUZ D  Q FLAG
"RTN","PSOERX1A",52,0)
 .L +^XTMP("PSOERXLOCK",DFN):$S($G(DILOCKTM)>0:DILOCKTM,1:3) S FLAG=$S($T=1:$T,1:0)
"RTN","PSOERX1A",53,0)
 .I 'FLAG W !,"You have this patient locked in another open session"
"RTN","PSOERX1A",54,0)
 I '$D(^XTMP("PSOERXLOCK",DFN)) D  Q FLAG
"RTN","PSOERX1A",55,0)
 . ;D NOW^%DTC S ^XTMP("PSOERXLOCK",DFN)=DUZ_"^"_%
"RTN","PSOERX1A",56,0)
 . L +^XTMP("PSOERXLOCK",DFN):$S($G(DILOCKTM)>0:DILOCKTM,1:3) S FLAG=$S($T=1:$T,1:0)
"RTN","PSOERX1A",57,0)
 . I FLAG D
"RTN","PSOERX1A",58,0)
 . . D NOW^%DTC S ^XTMP("PSOERXLOCK",DFN)=DUZ_"^"_%
"RTN","PSOERX1A",59,0)
 . . S FDA(52.46,DFN_",",6)=DUZ
"RTN","PSOERX1A",60,0)
 . . D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERX1A",61,0)
 I $D(^XTMP("PSOERXLOCK",DFN)) Q $$R
"RTN","PSOERX1A",62,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERX1A",63,0)
UL(DFN) ; unlock
"RTN","PSOERX1A",64,0)
 I $G(PSONOLCK) Q
"RTN","PSOERX1A",65,0)
 L -^XTMP("PSOERXLOCK",DFN) K ^XTMP("PSOERXLOCK",DFN)
"RTN","PSOERX1A",66,0)
 Q
"RTN","PSOERX1A",67,0)
 ;
"RTN","PSOERX1A",68,0)
R() ; check lock on node
"RTN","PSOERX1A",69,0)
 ;if user has same patient already locked, Q 1, will only lock once
"RTN","PSOERX1A",70,0)
 I $P($G(^XTMP("PSOERXLOCK",DFN)),"^")=DUZ Q 1
"RTN","PSOERX1A",71,0)
 L +^XTMP("PSOERXLOCK",DFN):$S($G(DILOCKTM)>0:DILOCKTM,1:3)
"RTN","PSOERX1A",72,0)
 I $T=1 D  Q 1
"RTN","PSOERX1A",73,0)
 .D NOW^%DTC S ^XTMP("PSOERXLOCK",DFN)=DUZ_"^"_%
"RTN","PSOERX1A",74,0)
 .S FDA(52.46,DFN_",",6)=DUZ
"RTN","PSOERX1A",75,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERX1A",76,0)
 I $T=0 W:DIS=1 !,$$WHO(DFN) S Y=$P($G(^XTMP("PSOERXLOCK",DFN)),"^",2) X ^DD("DD") Q $S(DIS=0:0_"^"_$P($G(^VA(200,+$P($G(^XTMP("PSOERXLOCK",DFN)),"^"),0)),"^")_"^"_Y,1:0)
"RTN","PSOERX1A",77,0)
 ;
"RTN","PSOERX1A",78,0)
PDATE() ;
"RTN","PSOERX1A",79,0)
 N X1,X2 S X1=DT,X2=+14 D C^%DTC
"RTN","PSOERX1A",80,0)
 Q X_"^"_DT_"^eRx Pharmacy patient locks"
"RTN","PSOERX1A",81,0)
 ;
"RTN","PSOERX1A",82,0)
WHO(DFN) ;
"RTN","PSOERX1A",83,0)
 S Y=$P($G(^XTMP("PSOERXLOCK",DFN)),"^",2) X ^DD("DD")
"RTN","PSOERX1A",84,0)
 Q $P($G(^VA(200,+$P($G(^XTMP("PSOERXLOCK",DFN)),"^"),0)),"^")_" is editing orders for this patient ("_Y_")"
"RTN","PSOERX1A",85,0)
 ;
"RTN","PSOERX1A",86,0)
 ;
"RTN","PSOERX1A",87,0)
 ; TEXT - variable where text is stored (passed by reference)
"RTN","PSOERX1A",88,0)
 ; HDR - header text
"RTN","PSOERX1A",89,0)
 ; DATA - data associated with the header
"RTN","PSOERX1A",90,0)
 ; STRT - start location (column)
"RTN","PSOERX1A",91,0)
 ; LEN - total length for header and data
"RTN","PSOERX1A",92,0)
ADDITEM(TEXT,HDR,DATA,STRT,LEN) ;
"RTN","PSOERX1A",93,0)
 N LLEN,FULLDAT,L
"RTN","PSOERX1A",94,0)
 S FULLDAT=$G(HDR)_$G(DATA)
"RTN","PSOERX1A",95,0)
 S TEXT=$G(TEXT,"") I STRT=1 S TEXT=TEXT_$E(FULLDAT,1,LEN) Q
"RTN","PSOERX1A",96,0)
 S LLEN=$L(TEXT)
"RTN","PSOERX1A",97,0)
 I LLEN<STRT D
"RTN","PSOERX1A",98,0)
 .F L=$L(TEXT):1:STRT-1 D
"RTN","PSOERX1A",99,0)
 ..S TEXT=TEXT_" "
"RTN","PSOERX1A",100,0)
 S TEXT=TEXT_$E(FULLDAT,1,LEN)
"RTN","PSOERX1A",101,0)
 Q
"RTN","PSOERX1A",102,0)
 ; provider information display
"RTN","PSOERX1A",103,0)
PROV ;
"RTN","PSOERX1A",104,0)
 I '$$GET1^DIQ(52.49,PSOIEN,2.3,"I") S XQORM("B")="Edit"
"RTN","PSOERX1A",105,0)
 D EN^PSOERXR1
"RTN","PSOERX1A",106,0)
 Q
"RTN","PSOERX1A",107,0)
 ; patient information display
"RTN","PSOERX1A",108,0)
PAT ;
"RTN","PSOERX1A",109,0)
 I '$$GET1^DIQ(52.49,PSOIEN,.05,"I") S XQORM("B")="Edit"
"RTN","PSOERX1A",110,0)
 D EN^PSOERXP1
"RTN","PSOERX1A",111,0)
 Q
"RTN","PSOERX1A",112,0)
 ; drug information display
"RTN","PSOERX1A",113,0)
DRUG ;
"RTN","PSOERX1A",114,0)
 I '$$GET1^DIQ(52.49,PSOIEN,3.2,"I") S XQORM("B")="Edit"
"RTN","PSOERX1A",115,0)
 D EN^PSOERXD1
"RTN","PSOERX1A",116,0)
 Q
"RTN","PSOERX1A",117,0)
 ; edit validation
"RTN","PSOERX1A",118,0)
 ; EDTYPE - D=drug, P=patient, PR=provider
"RTN","PSOERX1A",119,0)
EDIT(EDTYP,SBN) ;
"RTN","PSOERX1A",120,0)
 N DIR,Y,ITEM,RES,TAG,PQUIT,RXSTAT
"RTN","PSOERX1A",121,0)
 D FULL^VALM1
"RTN","PSOERX1A",122,0)
 S SBN=$G(SBN,"")
"RTN","PSOERX1A",123,0)
 S VALMBCK="R"
"RTN","PSOERX1A",124,0)
 Q:'$G(PSOIEN)
"RTN","PSOERX1A",125,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERX1A",126,0)
 .W !!,"Cannot edit a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERX1A",127,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1A",128,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1A",129,0)
 Q:'$D(EDTYP)
"RTN","PSOERX1A",130,0)
 I EDTYP="D" D  Q
"RTN","PSOERX1A",131,0)
 .D PLSTRNG(1,10,.RES,SBN)
"RTN","PSOERX1A",132,0)
 .I '$O(RES(0)) Q
"RTN","PSOERX1A",133,0)
 .D DERX1^PSOERXD2(PSOIEN,PSOIENS)
"RTN","PSOERX1A",134,0)
 .S (ITEM,PQUIT)=0 F  S ITEM=$O(RES(ITEM)) Q:'ITEM!(PQUIT)  D
"RTN","PSOERX1A",135,0)
 ..S TAG="VDRG"_ITEM_"^PSOERXD2(PSOIEN,PSOIENS)" D @TAG
"RTN","PSOERX1A",136,0)
 .K @VALMAR D INIT^PSOERXD1
"RTN","PSOERX1A",137,0)
 I EDTYP="P" D VPAT K @VALMAR D INIT^PSOERXP1 Q
"RTN","PSOERX1A",138,0)
 I EDTYP="PR" D VPROV K @VALMAR D INIT^PSOERXR1 Q
"RTN","PSOERX1A",139,0)
 Q
"RTN","PSOERX1A",140,0)
 ; edit provider
"RTN","PSOERX1A",141,0)
VPROV ;
"RTN","PSOERX1A",142,0)
 N EXPRVIEN,VAPRVIEN,MANVAL,PRVDAT,EXPRNAME,EXPRLNAM,EXPRFNAM,PSOIENS
"RTN","PSOERX1A",143,0)
 N EXPRIENS,SELPRV,QUIT,VAPNM,NEWPIEN,VANPI,MTYPE
"RTN","PSOERX1A",144,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1A",145,0)
 S VAPNM=$$GET1^DIQ(52.49,PSOIEN,2.3,"E")
"RTN","PSOERX1A",146,0)
 S EXPRVIEN=$$GET1^DIQ(52.49,PSOIEN,2.1,"I")
"RTN","PSOERX1A",147,0)
 S EXPRIENS=EXPRVIEN_","
"RTN","PSOERX1A",148,0)
 D GETS^DIQ(52.48,EXPRIENS,".01;.02;.03;1.5;1.6","E","PRVDAT")
"RTN","PSOERX1A",149,0)
 S EXPRNAME=$G(PRVDAT(52.48,EXPRIENS,.01,"E"))
"RTN","PSOERX1A",150,0)
 S EXPRLNAM=$G(PRVDAT(52.48,EXPRIENS,.02,"E"))
"RTN","PSOERX1A",151,0)
 S EXPRFNAM=$G(PRVDAT(52.48,EXPRIENS,.03,"E"))
"RTN","PSOERX1A",152,0)
 S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.3,"I")
"RTN","PSOERX1A",153,0)
 S MTYPE=$$GET1^DIQ(52.49,PSOIEN,.08,"I")
"RTN","PSOERX1A",154,0)
 S VAPIEN=$$GET1^DIQ(52.49,PSOIEN,2.3,"I")
"RTN","PSOERX1A",155,0)
 I VAPIEN D  Q
"RTN","PSOERX1A",156,0)
 .W !,"Current Vista provider: "_VAPNM,!
"RTN","PSOERX1A",157,0)
 .S DIR(0)="YO",DIR("A")="Would you like to modify the current provider"
"RTN","PSOERX1A",158,0)
 .I MANVAL S DIR("A",1)="This provider has already been validated."
"RTN","PSOERX1A",159,0)
 .S DIR("B")="NO" D ^DIR
"RTN","PSOERX1A",160,0)
 .Q:'Y
"RTN","PSOERX1A",161,0)
 .S DIC=200,DIC("A")="Select PROVIDER NAME: ",DIC(0)="AEMQ",DIC("S")="I $$CHKPRV2^PSOERX1A(Y)" D ^DIC
"RTN","PSOERX1A",162,0)
 .Q:Y<1
"RTN","PSOERX1A",163,0)
 .S NEWPIEN=$P(Y,U) K Y
"RTN","PSOERX1A",164,0)
 .S ERXMMFLG=$$PRVWARN(PSOIEN,VAPIEN)
"RTN","PSOERX1A",165,0)
 .S DIR(0)="Y",DIR("A")="Would you like to use this provider"
"RTN","PSOERX1A",166,0)
 .S DIR("A",1)="You have selected provider: "_$$GET1^DIQ(200,NEWPIEN,.01,"E")
"RTN","PSOERX1A",167,0)
 .S DIR("B")=$S(ERXMMFLG:"NO",1:"YES") D ^DIR
"RTN","PSOERX1A",168,0)
 .I Y<1 S QUIT=1 Q
"RTN","PSOERX1A",169,0)
 .; change existing entry
"RTN","PSOERX1A",170,0)
 .S FDA(52.49,PSOIENS,2.3)=NEWPIEN
"RTN","PSOERX1A",171,0)
 .; if the provider is different, clear manual validation
"RTN","PSOERX1A",172,0)
 .I VAPIEN'=NEWPIEN D  Q
"RTN","PSOERX1A",173,0)
 ..S FDA(52.49,PSOIENS,1.3)="",FDA(52.49,PSOIENS,1.8)="",FDA(52.49,PSOIENS,1.9)=""
"RTN","PSOERX1A",174,0)
 ..D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1A",175,0)
 ..I MTYPE="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1A",176,0)
 ..I MTYPE="RE" D UPDSTAT^PSOERXU1(PSOIEN,"RXW")
"RTN","PSOERX1A",177,0)
 ; for now, only list providers that are authorized to write med orders and whose dea is not expired
"RTN","PSOERX1A",178,0)
 S DIC=200,DIC("A")="Select PROVIDER NAME: ",DIC(0)="AEMQ",DIC("S")="I $$CHKPRV2^PSOERX1A(Y)" D ^DIC
"RTN","PSOERX1A",179,0)
 Q:Y<1
"RTN","PSOERX1A",180,0)
 S SELPRV=$P(Y,U)
"RTN","PSOERX1A",181,0)
 S ERXMMFLG=$$PRVWARN(PSOIEN,SELPRV)
"RTN","PSOERX1A",182,0)
 S DIR(0)="Y",DIR("A")="Would you like to use this provider"
"RTN","PSOERX1A",183,0)
 S DIR("A",1)="You have selected provider: "_$$GET1^DIQ(200,SELPRV,.01,"E")
"RTN","PSOERX1A",184,0)
 S DIR("B")=$S(ERXMMFLG:"NO",1:"YES") D ^DIR
"RTN","PSOERX1A",185,0)
 Q:Y<1
"RTN","PSOERX1A",186,0)
 S FDA(52.49,PSOIENS,2.3)=$P(SELPRV,U)
"RTN","PSOERX1A",187,0)
 D FILE^DIE(,"FDA","ERR") K FDA
"RTN","PSOERX1A",188,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1A",189,0)
 ; PSO*7*508 - update status of refill response to RXI - refill response in progress
"RTN","PSOERX1A",190,0)
 I $$GET1^DIQ(52.49,PSOIEN,.08,"I")="RE",$$GET1^DIQ(52.49,PSOIEN,1,"E")="RRN" D UPDSTAT^PSOERXU1(PSOIEN,"RXW")
"RTN","PSOERX1A",191,0)
 Q
"RTN","PSOERX1A",192,0)
PRVWARN(PSOIEN,VAPIEN) ;
"RTN","PSOERX1A",193,0)
 N EXPRVNPI,VANPI,ERXDEA,VADEA,ERXMMFLG,I,ERXMSG,ERXPIEN,EXPRVDEA
"RTN","PSOERX1A",194,0)
 S ERXMMFLG=0
"RTN","PSOERX1A",195,0)
 S ERXPIEN=$$GET1^DIQ(52.49,PSOIEN,2.1,"I")
"RTN","PSOERX1A",196,0)
 S EXPRVNPI=$$GET1^DIQ(52.48,ERXPIEN,1.5,"E")
"RTN","PSOERX1A",197,0)
 S EXPRVDEA=$$GET1^DIQ(52.48,ERXPIEN,1.6,"E")
"RTN","PSOERX1A",198,0)
 I '$G(VAPIEN) S VAPIEN=$$GET1^DIQ(52.49,PSOIEN,2.3,"I") I '$G(VAPIEN) Q 0
"RTN","PSOERX1A",199,0)
 I EXPRVNPI]"",'$D(^VA(200,"ANPI",EXPRVNPI,VAPIEN)) S ERXMMFLG=1,ERXMSG(1)="Provider NPI Mismatch."
"RTN","PSOERX1A",200,0)
 I EXPRVDEA]"",'$D(^VA(200,"PS1",EXPRVDEA,VAPIEN)) S ERXMMFLG=1,ERXMSG(2)="Provider DEA Mismatch."
"RTN","PSOERX1A",201,0)
 I 'ERXMMFLG Q ERXMMFLG
"RTN","PSOERX1A",202,0)
 W !!,"******************************WARNING********************************"
"RTN","PSOERX1A",203,0)
 S I=0 F  S I=$O(ERXMSG(I)) Q:'I  D
"RTN","PSOERX1A",204,0)
 .W !,$G(ERXMSG(I))
"RTN","PSOERX1A",205,0)
 W !,"*********************************************************************"
"RTN","PSOERX1A",206,0)
 Q ERXMMFLG
"RTN","PSOERX1A",207,0)
CHKPRV2(Y) ;
"RTN","PSOERX1A",208,0)
 ;Ref. to ^VA(200 supp. by IA 224
"RTN","PSOERX1A",209,0)
 I '$P($G(^VA(200,Y,"PS")),U) Q 0
"RTN","PSOERX1A",210,0)
 Q 1
"RTN","PSOERX1A",211,0)
 ; validate drug
"RTN","PSOERX1A",212,0)
 ; prompt list or range
"RTN","PSOERX1A",213,0)
 ; LOW - lowest number to prompt for
"RTN","PSOERX1A",214,0)
 ; HIGH - highest number to prompt for
"RTN","PSOERX1A",215,0)
 ; EDIT - returned list of selected values
"RTN","PSOERX1A",216,0)
 ;        EDIT(n1)=""
"RTN","PSOERX1A",217,0)
 ;        EDIT(n2)=""
"RTN","PSOERX1A",218,0)
 ;        EDIT(n3)=""
"RTN","PSOERX1A",219,0)
PLSTRNG(LOW,HIGH,EDIT,SBN) ;
"RTN","PSOERX1A",220,0)
 N DIR,DONE,DONE2,Y,NUMCHK,NUM,VAL,I,LIST
"RTN","PSOERX1A",221,0)
 I '$G(LOW)!'$G(HIGH) S LIST=0 Q
"RTN","PSOERX1A",222,0)
 S DONE=0
"RTN","PSOERX1A",223,0)
 F  D  Q:DONE
"RTN","PSOERX1A",224,0)
 .I $$GET1^DIQ(52.49,PSOIEN,3.2,"I")="" S Y="A"
"RTN","PSOERX1A",225,0)
 .I '$D(Y),'$O(^PS(52.49,PSOIEN,21,0)) S Y="A"
"RTN","PSOERX1A",226,0)
 .I SBN']"",'$D(Y)!($G(Y)[" ")!($G(Y)[".") D
"RTN","PSOERX1A",227,0)
 ..S DIR(0)="FO^",DIR("A")="Which field(s) would you like to edit? ("_LOW_"-"_HIGH_") or 'A'll"
"RTN","PSOERX1A",228,0)
 ..S DIR("?")="Enter a number, range, or a list of numbers (i.e. 3, 1-5, 3,7,9, or 'A'll)"
"RTN","PSOERX1A",229,0)
 ..S DIR("B")="A"
"RTN","PSOERX1A",230,0)
 ..D ^DIR K DIR
"RTN","PSOERX1A",231,0)
 ..I Y="^" S DONE=1 Q
"RTN","PSOERX1A",232,0)
 .;/BLB/ PSO*7.0*527 - BEGIN CHANGE - PREVENTING INVALID VALUES FROM BEING ENTERED IN VD
"RTN","PSOERX1A",233,0)
 .I SBN']"",Y["-",Y["," D  Q
"RTN","PSOERX1A",234,0)
 ..W !!,"Invalid Response."
"RTN","PSOERX1A",235,0)
 ..W !,"Answer must be numeric (1-10), a series of numbers (3,5,7), 'A' or 'ALL'."
"RTN","PSOERX1A",236,0)
 ..S DIR(0)="E" D ^DIR K Y,DIR
"RTN","PSOERX1A",237,0)
 .I SBN']"",(Y[".")!(Y[" ") D  Q
"RTN","PSOERX1A",238,0)
 ..W !!,"Invalid Response."
"RTN","PSOERX1A",239,0)
 ..W !,"Answer must be numeric (1-10), a series of numbers (3,5,7), 'A' or 'ALL'."
"RTN","PSOERX1A",240,0)
 ..S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX1A",241,0)
 ..I Y'[" " K Y
"RTN","PSOERX1A",242,0)
 .;/BLB/ PSO*7.0*527 - END CHANGE
"RTN","PSOERX1A",243,0)
 .I SBN]"",'$D(Y) S Y=SBN
"RTN","PSOERX1A",244,0)
 .Q:Y["."
"RTN","PSOERX1A",245,0)
 .I Y="^" S DONE=1 Q
"RTN","PSOERX1A",246,0)
 .S Y=$$UP^XLFSTR(Y)
"RTN","PSOERX1A",247,0)
 .I Y="A"!(Y="ALL") D  Q
"RTN","PSOERX1A",248,0)
 ..F I=LOW:1:HIGH D
"RTN","PSOERX1A",249,0)
 ...S EDIT(I)=""
"RTN","PSOERX1A",250,0)
 ..S DONE=1
"RTN","PSOERX1A",251,0)
 .; check for a range or list of numbers
"RTN","PSOERX1A",252,0)
 .I Y'["-",Y'[",",Y'<LOW,Y'>HIGH S EDIT(+Y)="" S DONE=1 Q
"RTN","PSOERX1A",253,0)
 .I Y?1.2N1"-"1.2N D
"RTN","PSOERX1A",254,0)
 ..F I=$P(Y,"-"):1:$P(Y,"-",2) D
"RTN","PSOERX1A",255,0)
 ...Q:I<LOW!(I>HIGH)
"RTN","PSOERX1A",256,0)
 ...S EDIT(I)=""
"RTN","PSOERX1A",257,0)
 .I $D(EDIT) S DONE=1 Q
"RTN","PSOERX1A",258,0)
 .I Y["," D
"RTN","PSOERX1A",259,0)
 ..; check to see if there are alpha-numerics if there are, quit and reprompt
"RTN","PSOERX1A",260,0)
 ..S NUMCHK=$TR(Y,",","") I 'NUMCHK W !,"Invalid response." Q
"RTN","PSOERX1A",261,0)
 ..S DONE2=0
"RTN","PSOERX1A",262,0)
 ..F NUM=1:1 D  Q:DONE2
"RTN","PSOERX1A",263,0)
 ...S VAL=$P(Y,",",NUM)
"RTN","PSOERX1A",264,0)
 ...I 'VAL S DONE2=1 Q
"RTN","PSOERX1A",265,0)
 ...I VAL<LOW!(VAL>HIGH) Q
"RTN","PSOERX1A",266,0)
 ...S EDIT(VAL)=""
"RTN","PSOERX1A",267,0)
 .I $D(EDIT) S DONE=1 Q
"RTN","PSOERX1A",268,0)
 .W !,"Invalid Response."
"RTN","PSOERX1A",269,0)
 .W !,"Answer must be numeric (1-10), a series of numbers (3,5,7), 'A' or 'ALL'."
"RTN","PSOERX1A",270,0)
 .S DIR(0)="E" D ^DIR K Y,DIR
"RTN","PSOERX1A",271,0)
 .;S DONE=1
"RTN","PSOERX1A",272,0)
 Q
"RTN","PSOERX1A",273,0)
 ; validate patient
"RTN","PSOERX1A",274,0)
VPAT ;
"RTN","PSOERX1A",275,0)
 N ERXPIEN,VAPIEN,MANVAL,ERXLNAME,ERXFNAME,DIR,Y,PSOIENS,VAPIEN,MANVAL,DIR,DIC,SELPAT,PDONE,DFN,I,VADM
"RTN","PSOERX1A",276,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1A",277,0)
 S ERXPIEN=$$GET1^DIQ(52.49,PSOIEN,.04,"I")
"RTN","PSOERX1A",278,0)
 S ERXLNAME=$$GET1^DIQ(52.46,ERXPIEN,.02,"E")
"RTN","PSOERX1A",279,0)
 S ERXFNAME=$$GET1^DIQ(52.46,ERXPIEN,.03,"E")
"RTN","PSOERX1A",280,0)
 S VAPIEN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERX1A",281,0)
 S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.7,"I")
"RTN","PSOERX1A",282,0)
 ; if there is a patient currently defined
"RTN","PSOERX1A",283,0)
 I VAPIEN D  Q
"RTN","PSOERX1A",284,0)
 .W !,"Current Vista patient: "_$$GET1^DIQ(2,VAPIEN,.01,"E"),!
"RTN","PSOERX1A",285,0)
 .S DIR(0)="YO",DIR("A")="Would you like to edit the patient"
"RTN","PSOERX1A",286,0)
 .S DIR("A",1)="A patient has already matched to a vista patient."
"RTN","PSOERX1A",287,0)
 .S DIR("B")="NO" D ^DIR
"RTN","PSOERX1A",288,0)
 .Q:Y'=1
"RTN","PSOERX1A",289,0)
 .S DIC(0)="AEMQ",SELPAT=$$PATPRMT() K DUOUT Q:'SELPAT
"RTN","PSOERX1A",290,0)
 .S DFN=SELPAT D DEM^VADPT
"RTN","PSOERX1A",291,0)
 .I $P($G(VADM(6)),U)]"" W "[PATIENT DIED ON "_$P($G(VADM(6)),U,2)_"]" Q
"RTN","PSOERX1A",292,0)
 .S ERXMMFLG=$$PATWARN(PSOIEN,SELPAT)
"RTN","PSOERX1A",293,0)
 .S DIR(0)="Y",DIR("A")="Would you like to use this patient"
"RTN","PSOERX1A",294,0)
 .S DIR("A",1)="You have selected patient: "_$$GET1^DIQ(2,SELPAT,.01,"E")
"RTN","PSOERX1A",295,0)
 .S DIR("B")=$S($G(ERXMMFLG):"NO",1:"YES") D ^DIR
"RTN","PSOERX1A",296,0)
 .Q:Y'=1
"RTN","PSOERX1A",297,0)
 .; change existing entry
"RTN","PSOERX1A",298,0)
 .S FDA(52.49,PSOIENS,.05)=SELPAT
"RTN","PSOERX1A",299,0)
 .I SELPAT'=VAPIEN D  Q
"RTN","PSOERX1A",300,0)
 ..S FDA(52.49,PSOIENS,1.7)="",FDA(52.49,PSOIENS,1.13)="",FDA(52.49,PSOIENS,1.14)=""
"RTN","PSOERX1A",301,0)
 ..D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1A",302,0)
 ..D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1A",303,0)
 .I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1A",304,0)
 S DIC(0)="AEMQ",SELPAT=$$PATPRMT() K DUOUT I 'SELPAT S XQORM("B")="Edit" Q
"RTN","PSOERX1A",305,0)
 S DFN=SELPAT D DEM^VADPT
"RTN","PSOERX1A",306,0)
 I $P($G(VADM(6)),U)]"" W "[PATIENT DIED ON "_$P($G(VADM(6)),U,2)_"]" S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX1A",307,0)
 S ERXMMFLG=$$PATWARN(PSOIEN,SELPAT)
"RTN","PSOERX1A",308,0)
 S DIR(0)="Y",DIR("A")="Would you like to use this patient"
"RTN","PSOERX1A",309,0)
 S DIR("A",1)="You have selected patient: "_$$GET1^DIQ(2,SELPAT,.01,"E")
"RTN","PSOERX1A",310,0)
 S DIR("B")=$S($G(ERXMMFLG):"NO",1:"YES") D ^DIR
"RTN","PSOERX1A",311,0)
 I Y'=1 S XQORM("B")="Edit" Q
"RTN","PSOERX1A",312,0)
 S FDA(52.49,PSOIENS,.05)=SELPAT
"RTN","PSOERX1A",313,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1A",314,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1A",315,0)
 Q
"RTN","PSOERX1A",316,0)
PATWARN(PSOIEN,SELPAT) ;
"RTN","PSOERX1A",317,0)
 N ERXPIEN,ERXSSN,ERXDOB,ERXGEN,ERXMMFLG,ERXMSG,EXPRVDEA
"RTN","PSOERX1A",318,0)
 S ERXMMFLG=0
"RTN","PSOERX1A",319,0)
 S ERXPIEN=$$GET1^DIQ(52.49,PSOIEN,.04,"I")
"RTN","PSOERX1A",320,0)
 S ERXSSN=$$GET1^DIQ(52.46,ERXPIEN,1.4,"E"),ERXSSN=$TR(ERXSSN,"-","")
"RTN","PSOERX1A",321,0)
 S ERXDOB=$$GET1^DIQ(52.46,ERXPIEN,.08,"I")
"RTN","PSOERX1A",322,0)
 S ERXGEN=$$GET1^DIQ(52.46,ERXPIEN,.07,"I")
"RTN","PSOERX1A",323,0)
 ; if the selected patient is not defined, use the va matched patient because we are doing this check
"RTN","PSOERX1A",324,0)
 ; during accept validation
"RTN","PSOERX1A",325,0)
 I '$G(SELPAT) S SELPAT=$$GET1^DIQ(52.49,PSOIEN,.05,"I") Q:'$G(SELPAT) 0
"RTN","PSOERX1A",326,0)
 I '$D(VADM) S DFN=SELPAT D DEM^VADPT
"RTN","PSOERX1A",327,0)
 I ERXSSN,'$D(^DPT("SSN",ERXSSN,SELPAT)) S ERXMMFLG=1,ERXMSG(1)="SSN mismatch."
"RTN","PSOERX1A",328,0)
 I ERXDOB,'$D(^DPT("ADOB",ERXDOB,SELPAT)) S ERXMMFLG=1,ERXMSG(2)="Date of Birth mismatch."
"RTN","PSOERX1A",329,0)
 I ERXGEN]"",$P($G(VADM(5)),U)'=ERXGEN S ERXMMFLG=1,ERXMSG(3)="Gender mismatch."
"RTN","PSOERX1A",330,0)
 Q:'ERXMMFLG 0
"RTN","PSOERX1A",331,0)
 W !!,"******************************WARNING********************************"
"RTN","PSOERX1A",332,0)
 S I=0 F  S I=$O(ERXMSG(I)) Q:'I  D
"RTN","PSOERX1A",333,0)
 .W !,$G(ERXMSG(I))
"RTN","PSOERX1A",334,0)
 W !,"*********************************************************************"
"RTN","PSOERX1A",335,0)
 Q 1
"RTN","PSOERX1A",336,0)
PATPRMT() ;
"RTN","PSOERX1A",337,0)
 N Y
"RTN","PSOERX1A",338,0)
 D ^DPTLK
"RTN","PSOERX1A",339,0)
 I $P(Y,U)<1 Q 0
"RTN","PSOERX1A",340,0)
 Q $P(Y,U)
"RTN","PSOERX1B")
0^3^B203269485^B200556396
"RTN","PSOERX1B",1,0)
PSOERX1B ;ALB/BWF - Accept eRx function ; 8/3/2016 5:14pm
"RTN","PSOERX1B",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,506,520,527,508,551**;DEC 1997;Build 37
"RTN","PSOERX1B",3,0)
 ;
"RTN","PSOERX1B",4,0)
 Q
"RTN","PSOERX1B",5,0)
ACVAL(PSOIEN,TYPE) ; NEW MTYPE, GET IT OFF FIELD .08, IF NOT DEFINED, 
"RTN","PSOERX1B",6,0)
 N F,VBFLD,VBDTTMF,DIR,TAG,VALPAR,VAL,CURVAL,MVFLD,VBFLD,VBDTTMF,PSOIENS,RXSTAT,QFLG,VDTTM,ERXMMFLG,MTYPE
"RTN","PSOERX1B",7,0)
 S F=52.49,PSOIENS=PSOIEN_","
"RTN","PSOERX1B",8,0)
 D FULL^VALM1
"RTN","PSOERX1B",9,0)
 S VALMBCK="R"
"RTN","PSOERX1B",10,0)
 ; first check to see if the entry exists. cannot validate something that has no value
"RTN","PSOERX1B",11,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE - DEFINING MTYPE
"RTN","PSOERX1B",12,0)
 S MTYPE=$$GET1^DIQ(52.49,PSOIEN,.08,"I") ;mtype
"RTN","PSOERX1B",13,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERX1B",14,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERX1B",15,0)
 .W !!,"Cannot accept validation for a prescription with a status of 'Rejected',",!,"'Removed',or 'Processed",!
"RTN","PSOERX1B",16,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",17,0)
 Q:TYPE']""
"RTN","PSOERX1B",18,0)
 S TAG=$S(TYPE="P":"patient",TYPE="PR":"provider",TYPE="D":"drug",1:"")
"RTN","PSOERX1B",19,0)
 S VALPAR=$S(TYPE="P":.05,TYPE="PR":2.3,TYPE="D":3.2,1:"") Q:VALPAR=""
"RTN","PSOERX1B",20,0)
 S VAL=$$GET1^DIQ(F,PSOIEN,VALPAR,"I") I 'VAL D  Q
"RTN","PSOERX1B",21,0)
 .W !,"Vista "_TAG_" has not been matched. Cannot manually validate."
"RTN","PSOERX1B",22,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",23,0)
 S MVFLD=$S(TYPE="P":1.7,TYPE="PR":1.3,TYPE="D":1.5,1:"")
"RTN","PSOERX1B",24,0)
 S VBFLD=$S(TYPE="P":1.13,TYPE="PR":1.8,TYPE="D":1.11,1:"")
"RTN","PSOERX1B",25,0)
 S VBDTTMF=$S(TYPE="P":1.14,TYPE="PR":1.9,TYPE="D":1.12,1:"")
"RTN","PSOERX1B",26,0)
 ; check to see if this is already validated
"RTN","PSOERX1B",27,0)
 I MVFLD S CURVAL=$$GET1^DIQ(F,PSOIEN,MVFLD,"I")
"RTN","PSOERX1B",28,0)
 I CURVAL D  Q
"RTN","PSOERX1B",29,0)
 .W !!,"This "_TAG_" has already been manually validated."
"RTN","PSOERX1B",30,0)
 .W !,"Validated By: "_$$GET1^DIQ(F,PSOIEN,VBFLD,"E")
"RTN","PSOERX1B",31,0)
 .W !,"Validated Date/Time: "_$$GET1^DIQ(F,PSOIEN,VBDTTMF,"E"),!
"RTN","PSOERX1B",32,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",33,0)
 S QFLG=0
"RTN","PSOERX1B",34,0)
 I TYPE="D" D
"RTN","PSOERX1B",35,0)
 .W !
"RTN","PSOERX1B",36,0)
 .I '$O(^PS(52.49,PSOIEN,21,0)) W !,"Dosing information missing." S QFLG=1
"RTN","PSOERX1B",37,0)
 .I $$GET1^DIQ(52.49,PSOIEN,20.1,"E")="" W !,"Quantity missing." S QFLG=1
"RTN","PSOERX1B",38,0)
 .I $$GET1^DIQ(52.49,PSOIEN,20.2,"E")="" W !,"Days supply missing." S QFLG=1
"RTN","PSOERX1B",39,0)
 .;I $$GET1^DIQ(52.49,PSOIEN,20.5,"E")="" W !,"Refills missing."  S QFLG=1
"RTN","PSOERX1B",40,0)
 .I QFLG=1 D
"RTN","PSOERX1B",41,0)
 ..W !!,"Cannot validate drug information."
"RTN","PSOERX1B",42,0)
 ..S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX1B",43,0)
 Q:QFLG
"RTN","PSOERX1B",44,0)
 I TYPE="P" S ERXMMFLG=$$PATWARN^PSOERX1A(PSOIEN)
"RTN","PSOERX1B",45,0)
 I TYPE="PR" S ERXMMFLG=$$PRVWARN^PSOERX1A(PSOIEN)
"RTN","PSOERX1B",46,0)
 W !,"Would you like to mark this "_TAG_" as VALIDATED?"
"RTN","PSOERX1B",47,0)
 S DIR(0)="Y",DIR("B")=$S($G(ERXMMFLG):"NO",1:"YES") D ^DIR Q:Y'=1
"RTN","PSOERX1B",48,0)
 K FDA,DIR
"RTN","PSOERX1B",49,0)
 S VDTTM=$$NOW^XLFDT
"RTN","PSOERX1B",50,0)
 I MVFLD S FDA(F,PSOIENS,MVFLD)=1
"RTN","PSOERX1B",51,0)
 I VBFLD S FDA(F,PSOIENS,VBFLD)=$G(DUZ)
"RTN","PSOERX1B",52,0)
 I VBDTTMF S FDA(F,PSOIENS,VBDTTMF)=VDTTM
"RTN","PSOERX1B",53,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1B",54,0)
 I $D(FDA) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",55,0)
 W !,"Validation Updated!!" S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",56,0)
 ;/BLB/ PSO*7.0*527 - BEGIN CHANGE - VALIDATION/WAIT STATUS CHECK
"RTN","PSOERX1B",57,0)
 ; check validations and update status to 'wait' if all validations have occured.
"RTN","PSOERX1B",58,0)
 I MTYPE="N" D
"RTN","PSOERX1B",59,0)
 .I $$GET1^DIQ(52.49,PSOIEN,1.3,"I"),$$GET1^DIQ(52.49,PSOIEN,1.5,"I"),$$GET1^DIQ(52.49,PSOIEN,1.7,"I") D
"RTN","PSOERX1B",60,0)
 ..D UPDSTAT^PSOERXU1(PSOIEN,"W")
"RTN","PSOERX1B",61,0)
 .;/BLB/ - PSO*7.0*527 END CHANGE
"RTN","PSOERX1B",62,0)
 I MTYPE="RE" D UPDSTAT^PSOERXU1(PSOIEN,"RXW")
"RTN","PSOERX1B",63,0)
 I TYPE="P" D BPROC(PSOIEN,"PA",MVFLD,VBFLD,VBDTTMF,VDTTM) K @VALMAR D INIT^PSOERXP1
"RTN","PSOERX1B",64,0)
 I TYPE="PR" D BPROC(PSOIEN,"PR",MVFLD,VBFLD,VBDTTMF,VDTTM) K @VALMAR D INIT^PSOERXR1
"RTN","PSOERX1B",65,0)
 I TYPE="D" K @VALMAR D INIT^PSOERXD1
"RTN","PSOERX1B",66,0)
 Q
"RTN","PSOERX1B",67,0)
BPROC(PSOIEN,BTYPE,MVFLD,VBFLD,VBDTTMF,VDTTM) ;
"RTN","PSOERX1B",68,0)
 N ERXPAT,ERXSTAT,ERESTAT,ERXDT,ERXIEN,ERXARY,DIR,Y,L,LINE,CNT,EHID,EDRUG,EPROV,EPAT,ERXRDT,ERXRECDT,ERXEDT,I
"RTN","PSOERX1B",69,0)
 N REXEDT,EEPROV,ERXPROV,EXARY
"RTN","PSOERX1B",70,0)
 S ERXPAT=$$GET1^DIQ(52.49,PSOIEN,.04,"I") Q:'ERXPAT
"RTN","PSOERX1B",71,0)
 S ERXPROV=$$GET1^DIQ(52.49,PSOIEN,2.1,"I")
"RTN","PSOERX1B",72,0)
 S ERXRECDT=$P($$GET1^DIQ(52.49,PSOIEN,.03,"I"),".")
"RTN","PSOERX1B",73,0)
 S ERXEDT=ERXRECDT_".2359"
"RTN","PSOERX1B",74,0)
 S ERXSTAT=0 F  S ERXSTAT=$O(^PS(52.49,"PAT",PSNPINST,ERXSTAT)) Q:'ERXSTAT  D
"RTN","PSOERX1B",75,0)
 .S ERESTAT=$$GET1^DIQ(52.45,ERXSTAT,.01,"E")
"RTN","PSOERX1B",76,0)
 .; do not consider rx's that are rejected, removed, processed.
"RTN","PSOERX1B",77,0)
 .I ERESTAT="PR"!(ERESTAT="RM")!(ERESTAT="RJ")!(ERESTAT="CAN") Q
"RTN","PSOERX1B",78,0)
 .S ERXDT=ERXRECDT-.0001 F  S ERXDT=$O(^PS(52.49,"PAT",PSNPINST,ERXSTAT,ERXPAT,ERXDT)) Q:ERXDT>ERXEDT!(ERXDT="")  D
"RTN","PSOERX1B",79,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"PAT",PSNPINST,ERXSTAT,ERXPAT,ERXDT,ERXIEN)) Q:'ERXIEN  D
"RTN","PSOERX1B",80,0)
 ...; do not process any rx's that are not a 'newRx'.
"RTN","PSOERX1B",81,0)
 ...I $$GET1^DIQ(52.49,ERXIEN,.08,"I")'="N" Q
"RTN","PSOERX1B",82,0)
 ...;/BLB/ PSO*7.0*520 -  BEGIN CHANGE
"RTN","PSOERX1B",83,0)
 ...Q:PSOIEN=ERXIEN
"RTN","PSOERX1B",84,0)
 ...;/BLB/ PSO*7.0*520 - END CHANGE
"RTN","PSOERX1B",85,0)
 ...I BTYPE="PR",$$GET1^DIQ(52.49,ERXIEN,2.1,"I")'=ERXPROV Q
"RTN","PSOERX1B",86,0)
 ...S EXARY(ERXIEN)=""
"RTN","PSOERX1B",87,0)
 I '$O(EXARY(0)) Q
"RTN","PSOERX1B",88,0)
 W !!
"RTN","PSOERX1B",89,0)
 I BTYPE="PA" D
"RTN","PSOERX1B",90,0)
 .W !,"This patient has other prescriptions for: "_$$FMTE^XLFDT(ERXRECDT)
"RTN","PSOERX1B",91,0)
 .W !,"Patient: "_$$GET1^DIQ(52.46,ERXPAT,.01,"E")
"RTN","PSOERX1B",92,0)
 I BTYPE="PR" D
"RTN","PSOERX1B",93,0)
 .W !,"There are other prescriptions for this patient, written by this provider on"
"RTN","PSOERX1B",94,0)
 .W !,$$FMTE^XLFDT(ERXRECDT)
"RTN","PSOERX1B",95,0)
 .W !,"Provider: "_$$GET1^DIQ(52.48,ERXPROV,.01,"E")
"RTN","PSOERX1B",96,0)
 .W !,"Patient: "_$$GET1^DIQ(52.46,ERXPAT,.01,"E")
"RTN","PSOERX1B",97,0)
 W !!,?4,"DRUG",?30,"PROVIDER",?60,"REC DATE"
"RTN","PSOERX1B",98,0)
 S $P(LINE,"-",80)="" W !,LINE
"RTN","PSOERX1B",99,0)
 S L=0,CNT=0 F  S L=$O(EXARY(L)) Q:'L  D
"RTN","PSOERX1B",100,0)
 .S CNT=CNT+1
"RTN","PSOERX1B",101,0)
 .S EHID=$$GET1^DIQ(52.49,L,.01,"E")
"RTN","PSOERX1B",102,0)
 .S EDRUG=$$GET1^DIQ(52.49,L,3.1,"E")
"RTN","PSOERX1B",103,0)
 .S EEPROV=$$GET1^DIQ(52.49,L,2.1,"I")
"RTN","PSOERX1B",104,0)
 .S EPROV=$$GET1^DIQ(52.48,EEPROV,.01,"E")
"RTN","PSOERX1B",105,0)
 .S EPAT=$$GET1^DIQ(52.46,ERXPAT,.01,"E")
"RTN","PSOERX1B",106,0)
 .S ERXRDT=$P($$GET1^DIQ(52.49,L,.03,"E"),"@")
"RTN","PSOERX1B",107,0)
 .W !,CNT_".) "_$E(EDRUG,1,28),?30,$E(EPROV,1,28),?60,ERXRDT
"RTN","PSOERX1B",108,0)
 W !!,"Would you like apply the above validation to these prescriptions?"
"RTN","PSOERX1B",109,0)
 K Y S DIR(0)="YO"
"RTN","PSOERX1B",110,0)
 S DIR("B")="N" D ^DIR K DIR
"RTN","PSOERX1B",111,0)
 I Y="^"!(Y=0) Q
"RTN","PSOERX1B",112,0)
 S I=0 F  S I=$O(EXARY(I)) Q:'I  D
"RTN","PSOERX1B",113,0)
 .I BTYPE="PA" S FDA(52.49,I_",",.05)=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERX1B",114,0)
 .I BTYPE="PR" S FDA(52.49,I_",",2.3)=$$GET1^DIQ(52.49,PSOIEN,2.3,"I")
"RTN","PSOERX1B",115,0)
 .S FDA(52.49,I_",",MVFLD)=1,FDA(52.49,I_",",VBFLD)=$G(DUZ),FDA(52.49,I_",",VBDTTMF)=VDTTM
"RTN","PSOERX1B",116,0)
 .D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",117,0)
 .I $$GET1^DIQ(52.49,I,1,"E")="N" D UPDSTAT^PSOERXU1(I,"I")
"RTN","PSOERX1B",118,0)
 .;/BLB/ PSO*7.0*527 - BEGIN CHANGE - BULK PROCESSING/WAIT STATUS CHECK
"RTN","PSOERX1B",119,0)
 .I $$GET1^DIQ(52.49,I,1.3,"I"),$$GET1^DIQ(52.49,I,1.5,"I"),$$GET1^DIQ(52.49,I,1.7,"I") D
"RTN","PSOERX1B",120,0)
 ..D UPDSTAT^PSOERXU1(I,"W")
"RTN","PSOERX1B",121,0)
 .;/BLB/ -  PSO*7.0*527 END CHANGE
"RTN","PSOERX1B",122,0)
 Q
"RTN","PSOERX1B",123,0)
 ;PSOHY("LOC")=IEN of hospital location file (#44) - NOT USED, 
"RTN","PSOERX1B",124,0)
 ;PSOHY("CHNUM")=EXTERNAL PLACER ORDER NUMBER (NEED TO FIND OUT HOW WE SHOULD SET THIS) (25)
"RTN","PSOERX1B",125,0)
 ;PSOHY("PICK")=MAIL/WINDOW (20.4) 
"RTN","PSOERX1B",126,0)
 ;PSOHY("ENTER")=ENTERED BY IEN (2.1)
"RTN","PSOERX1B",127,0)
 ;PSOHY("PROV")=PROVIDER IEN (2.3)
"RTN","PSOERX1B",128,0)
 ;PSOHY("SDT")=EFFECTIVE DATE (6.3)
"RTN","PSOERX1B",129,0)
 ;PSOHY("ITEM")=PHARMACY ORDERABLE ITEM (DERIVED FROM THE DRUG IEN) - NO MAPPING TO 52.49
"RTN","PSOERX1B",130,0)
 ;PSOHY("DRUG")=DRUG IEN (3.2)
"RTN","PSOERX1B",131,0)
 ;PSOHY("QTY")=QUANTITY (20.1)
"RTN","PSOERX1B",132,0)
 ;PSOHY("REF")=# OF REFILLS (20.5)
"RTN","PSOERX1B",133,0)
 ;PSOHY("PAT")=PATIENT IEN (.05)
"RTN","PSOERX1B",134,0)
 ;PSOHY("OCC")=ORDER TYPE (ALWAYS 'NW') - NO MAPPING TO 52.49
"RTN","PSOERX1B",135,0)
 ;PSOHY("EDT")=LOGIN DATE (TODAYS DATE) - NO MAPPING TO 52.49
"RTN","PSOERX1B",136,0)
 ;PSOHY("PRIOR")=PRIORITY (SET OF CODES, 52.41,25 - STAT, EMERGENCY, ROUTINE)
"RTN","PSOERX1B",137,0)
 ;PSOHY("EXAPP")=EXTERNAL APPLICATION (FREE TEXT), LIKELY "PSO" - NO MAPPING TO 52.49
"RTN","PSOERX1B",138,0)
 ;PSOHY("PRCOM",#)=PROVIDER COMMENTS (8- NOTES)
"RTN","PSOERX1B",139,0)
 ;PSOHY("SIG",#)=SIG (52.4911 (STRUCTURED SIG), FIELD 1 (SIG FREE TEXT)
"RTN","PSOERX1B",140,0)
 ;PSOHY("QTSUB",CNT)=QUANTITY TIMING SUBFILE DATA. MERGED IN, FULL SUBFILE DATA
"RTN","PSOERX1B",141,0)
 ; QUANTITY/TIMING MAPS DIRECTLY TO QUANTITY TIMING IN 52.41
"RTN","PSOERX1B",142,0)
SETUP ;
"RTN","PSOERX1B",143,0)
 N PSOIENS,PSODAT,F,PATIEN,PROVIEN,OC,VQTY,EFFDT,VADRUG,VAOI,VAREF,VAROUT,VAPRIOR,PSOHY,LOC,ERXNUM,PRVARY,PRVCOMM
"RTN","PSOERX1B",144,0)
 N PLOOP,PCNT,QTLOOP,QTCNT,PSOEXMS,DIR,ORDERTYP,PSOEXCNT,SCNT,SIGDAT,SLOOP,POORD,PMVAL,PRMVAL,DMVAL,PATINST,RXSTAT
"RTN","PSOERX1B",145,0)
 N VADAYS,UNEXPI,PINARY,WRITDT,SLOOP2,MTYPE,REQIEN,ORXIEN,RESTYPE,DELTAS,RXIEN
"RTN","PSOERX1B",146,0)
 S F=52.49
"RTN","PSOERX1B",147,0)
 Q:'$G(PSOIEN)
"RTN","PSOERX1B",148,0)
 D FULL^VALM1
"RTN","PSOERX1B",149,0)
 S VALMBCK="R"
"RTN","PSOERX1B",150,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERX1B",151,0)
 .W !!,"Cannot accept a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERX1B",152,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",153,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1B",154,0)
 D GETS^DIQ(F,PSOIENS,".01;.05;.07;.08;1;1.3;1.5;1.7;2.1;2.3;3.2;5.9;6.2;6.3;8;20.1;20.2;20.4;20.5;20.6;25;25.2;27;30;52.1","IE","PSODAT")
"RTN","PSOERX1B",155,0)
 S PSOEXCNT=0
"RTN","PSOERX1B",156,0)
 S MTYPE=$G(PSODAT(F,PSOIENS,.08,"I"))
"RTN","PSOERX1B",157,0)
 S RESTYPE=$G(PSODAT(F,PSOIENS,52.1,"I"))
"RTN","PSOERX1B",158,0)
 I MTYPE="RE" D  Q
"RTN","PSOERX1B",159,0)
 .S REQIEN=$$GETREQ^PSOERXU2(PSOIEN)
"RTN","PSOERX1B",160,0)
 .I REQIEN S RXIEN=$$GET1^DIQ(52.49,REQIEN,.13,"I")
"RTN","PSOERX1B",161,0)
 .D PREFRES^PSOERXU3(PSOIEN,.PSOHY,.PSOEXCNT,.PSOEXMS,.PSODAT)
"RTN","PSOERX1B",162,0)
 .D RRDELTA^PSOERXU2(.DELTAS,REQIEN,PSOIEN)
"RTN","PSOERX1B",163,0)
 .I $O(PSOEXMS(0)),RESTYPE="AWC",$D(DELTAS(52.49,"EXTERNAL PROVIDER")) D  Q
"RTN","PSOERX1B",164,0)
 ..D MSGDIR^PSOERXU1(.PSOEXMS)
"RTN","PSOERX1B",165,0)
 .I $O(PSOEXMS(0)),$E(RESTYPE)="A",'$D(DELTAS(52.49,"EXTERNAL PROVIDER")) D  Q
"RTN","PSOERX1B",166,0)
 ..D UPDSTAT^PSOERXU1(PSOIEN,"RXF","Unable to add order to Pending file.") Q
"RTN","PSOERX1B",167,0)
 .I $D(DELTAS(52.49,"EXTERNAL PROVIDER")) D ADD Q
"RTN","PSOERX1B",168,0)
 .; call using silent mode if this is auto-processing
"RTN","PSOERX1B",169,0)
 .D ADD(1)
"RTN","PSOERX1B",170,0)
 S ERXSTA=$G(PSODAT(F,PSOIENS,1,"E")) I ERXSTA="E"!($E(ERXSTA)="H") S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="eRx is in a 'Hold' status." D MSGDIR^PSOERXU1(.PSOEXMS) Q
"RTN","PSOERX1B",171,0)
 I MTYPE="N" D
"RTN","PSOERX1B",172,0)
 .S PMVAL=$G(PSODAT(F,PSOIENS,1.7,"I")) I 'PMVAL S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Patient has not been manually validated."
"RTN","PSOERX1B",173,0)
 .S PRMVAL=$G(PSODAT(F,PSOIENS,1.3,"I")) I 'PRMVAL S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Provider has not been manually validated."
"RTN","PSOERX1B",174,0)
 .S DMVAL=$G(PSODAT(F,PSOIENS,1.5,"I")) I 'DMVAL S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Drug has not been manually validated."
"RTN","PSOERX1B",175,0)
 ; for now, if validations have not occurred, do not check the other fields.
"RTN","PSOERX1B",176,0)
 I $O(PSOEXMS(0)) D MSGDIR^PSOERXU1(.PSOEXMS) Q
"RTN","PSOERX1B",177,0)
 S POORD=$G(PSODAT(F,PSOIENS,25.2,"I")) I POORD S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Pending outpatient order already exists."
"RTN","PSOERX1B",178,0)
 S PATIEN=$G(PSODAT(F,PSOIENS,.05,"I")) I 'PATIEN S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="No matched vista patient."
"RTN","PSOERX1B",179,0)
 S PROVIEN=$G(PSODAT(F,PSOIENS,2.3,"I")) I 'PROVIEN S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Provider not matched to a vista provider."
"RTN","PSOERX1B",180,0)
 S VADRUG=$G(PSODAT(F,PSOIENS,3.2,"I")) I 'VADRUG S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Drug not matched to a vista drug."
"RTN","PSOERX1B",181,0)
 S LOC=$G(PSODAT(F,PSOIENS,20.6,"I"))
"RTN","PSOERX1B",182,0)
 S ERXNUM=$G(PSODAT(F,PSOIENS,.01,"E")) I 'ERXNUM S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="eRx number missing."
"RTN","PSOERX1B",183,0)
 S VQTY=$G(PSODAT(F,PSOIENS,20.1,"E")) I 'VQTY S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Quantity missing."
"RTN","PSOERX1B",184,0)
 S EFFDT=$G(PSODAT(F,PSOIENS,6.3,"I")),WRITDT=$G(PSODAT(F,PSOIENS,5.9,"I"))
"RTN","PSOERX1B",185,0)
 ; if the effective date is passed in and there is no time, add .000001 to the date
"RTN","PSOERX1B",186,0)
 I EFFDT]"" S EFFDT=$P(EFFDT,".")
"RTN","PSOERX1B",187,0)
 I '$L(EFFDT) S EFFDT=WRITDT
"RTN","PSOERX1B",188,0)
 S VADAYS=$G(PSODAT(F,PSOIENS,20.2,"E"))
"RTN","PSOERX1B",189,0)
 S VAOI=$$GET1^DIQ(50,VADRUG,2.1,"I") I 'VAOI S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Orderable item not associated with drug."
"RTN","PSOERX1B",190,0)
 S VAREF=$G(PSODAT(F,PSOIENS,20.5,"E"))
"RTN","PSOERX1B",191,0)
 S VAROUT=$G(PSODAT(F,PSOIENS,20.4,"I")) I '$L(VAROUT) S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Pickup routing missing."
"RTN","PSOERX1B",192,0)
 S PATINST=$G(PSODAT(F,PSOIENS,27,"E"))
"RTN","PSOERX1B",193,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE - CHANGING CALL TO AVOID SPACE CONCATENATION
"RTN","PSOERX1B",194,0)
 D TXT2ARY^PSOERXD1(.PINARY,$$LSIG^PSOERXU6(PATINST))
"RTN","PSOERX1B",195,0)
 ; get provider comments from VA PROVIDER COMMENTS field
"RTN","PSOERX1B",196,0)
 S PRVCOMM=$G(PSODAT(F,PSOIENS,30,"E"))
"RTN","PSOERX1B",197,0)
 D TXT2ARY^PSOERXD1(.PRVARY,$$LSIG^PSOERXU6(PRVCOMM))
"RTN","PSOERX1B",198,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERX1B",199,0)
 S (PLOOP,PCNT)=0 F  S PLOOP=$O(PRVARY(PLOOP)) Q:'PLOOP  D
"RTN","PSOERX1B",200,0)
 .S PCNT=PCNT+1,PSOHY("PRCOM",PCNT)=$G(PRVARY(PLOOP))
"RTN","PSOERX1B",201,0)
 I '$O(^PS(52.49,PSOIEN,21,0)) S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Dosing information missing."
"RTN","PSOERX1B",202,0)
 S (QTLOOP,QTCNT)=0 F  S QTLOOP=$O(^PS(52.49,PSOIEN,21,QTLOOP)) Q:'QTLOOP  D
"RTN","PSOERX1B",203,0)
 .S QTCNT=QTCNT+1 M PSOHY("QTSUB",QTCNT)=^PS(52.49,PSOIEN,21,QTLOOP)
"RTN","PSOERX1B",204,0)
 ; always 'routine' for now
"RTN","PSOERX1B",205,0)
 S VAPRIOR="R"
"RTN","PSOERX1B",206,0)
 ; always 'new' for this version
"RTN","PSOERX1B",207,0)
 I '$L($G(ORDERTYP)) S ORDERTYP="NW"
"RTN","PSOERX1B",208,0)
 S PSOHY("LOC")=LOC,PSOHY("CHNUM")=$G(ERXNUM)
"RTN","PSOERX1B",209,0)
 S PSOHY("PICK")=VAROUT,PSOHY("ENTER")=PROVIEN
"RTN","PSOERX1B",210,0)
 S PSOHY("PROV")=PROVIEN,PSOHY("SDT")=EFFDT
"RTN","PSOERX1B",211,0)
 S PSOHY("ITEM")=VAOI,PSOHY("DRUG")=VADRUG
"RTN","PSOERX1B",212,0)
 S PSOHY("QTY")=VQTY,PSOHY("REF")=VAREF
"RTN","PSOERX1B",213,0)
 S (PSOHY("PAT"),DFN)=PATIEN,PSOHY("OCC")=ORDERTYP
"RTN","PSOERX1B",214,0)
 ; login date will always be the written date. if there is no written date by chance, use the received date
"RTN","PSOERX1B",215,0)
 S PSOHY("EDT")=DT,PSOHY("PRIOR")=VAPRIOR
"RTN","PSOERX1B",216,0)
 ; ALWAYS PSO as the external application
"RTN","PSOERX1B",217,0)
 S PSOHY("EXAPP")="PHARMACY"
"RTN","PSOERX1B",218,0)
 S PSOHY("DAYS")=VADAYS
"RTN","PSOERX1B",219,0)
 ; sig from eRx
"RTN","PSOERX1B",220,0)
 S (SLOOP,SCNT)=0 F  S SLOOP=$O(^PS(52.49,PSOIEN,"SIG",SLOOP)) Q:'SLOOP  D
"RTN","PSOERX1B",221,0)
 .S SIGDAT=$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0))
"RTN","PSOERX1B",222,0)
 .S SCNT=SCNT+1,PSOHY("SIG",SCNT)=SIGDAT
"RTN","PSOERX1B",223,0)
 S SLOOP2=0 F  S SLOOP2=$O(PINARY(SLOOP2)) Q:'SLOOP2  D
"RTN","PSOERX1B",224,0)
 .S SCNT=SCNT+1,PSOHY("SIG",SCNT)=$G(PINARY(SLOOP2))
"RTN","PSOERX1B",225,0)
 ; if provider, patient or drug is missing, no need to continue.
"RTN","PSOERX1B",226,0)
 ; future consideration - do we need to check more fields?
"RTN","PSOERX1B",227,0)
 ;I $D(PSOEXMS) D MSGDIR^PSOERXU1(.PSOEXMS) Q
"RTN","PSOERX1B",228,0)
 D ADD
"RTN","PSOERX1B",229,0)
 I $G(PSOEXMS)]"" W !,PSOEXMS S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX1B",230,0)
 K DFN
"RTN","PSOERX1B",231,0)
 Q
"RTN","PSOERX1B",232,0)
ADD(QUIET) ;Add CHCS message to Outpatient Pending Orders file
"RTN","PSOERX1B",233,0)
 N PSOHQ,PSOHQT,PSOCPEND,PSOHINI,PSOHINLO,ERXSTA,ORDNUM,ILOOP,IARY,PSSRET
"RTN","PSOERX1B",234,0)
 S (PSOHINI,PSOHINLO)=0 D
"RTN","PSOERX1B",235,0)
 .I $G(PSOHY("LOC")) S PSOHINLO=$P($G(^SC(PSOHY("LOC"),0)),"^",4) I PSOHINLO Q
"RTN","PSOERX1B",236,0)
 .; FUTURE - consider enabling further institution checks. For now the institution is being pulled from either
"RTN","PSOERX1B",237,0)
 .; the institution associated with the hospital location, or below, from the eRx.
"RTN","PSOERX1B",238,0)
 .;I $G(PSOHY("LOC")) S PSOHINI=$P($G(^SC(PSOHY("LOC"),0)),"^",15)
"RTN","PSOERX1B",239,0)
 .;I '$G(PSOHINI) S PSOHINI=$O(^DG(40.8,0))
"RTN","PSOERX1B",240,0)
 .;S PSOHINLO=+$$SITE^VASITE(PSOHINI)
"RTN","PSOERX1B",241,0)
 ; get institution from 52.49 if clinic was not passed in
"RTN","PSOERX1B",242,0)
 I $G(PSOHINLO)<1 S PSOHINLO=$$GET1^DIQ(52.49,PSOIEN,24.1,"I")
"RTN","PSOERX1B",243,0)
 I +$G(PSOHINLO)<1 S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Unable to derive Institution from Clinic." Q
"RTN","PSOERX1B",244,0)
 K DD,DO,DIC S X=PSOHY("CHNUM"),DIC="^PS(52.41,",DIC(0)="L"
"RTN","PSOERX1B",245,0)
 S:$G(PSOHY("PICK"))="" PSOHY("PICK")="M"
"RTN","PSOERX1B",246,0)
 S DIC("DR")="4////"_$G(PSOHY("ENTER"))_";5////"_PSOHY("PROV")_";6////"_$G(PSOHY("SDT"))_";8////"_PSOHY("ITEM")_";11////"_PSOHY("DRUG")
"RTN","PSOERX1B",247,0)
 S DIC("DR")=$G(DIC("DR"))_";12////"_$G(PSOHY("QTY"))_";13////"_$G(PSOHY("REF"))_";22.1////"_$G(PSOHY("PREVORD"))_";101////"_$G(PSOHY("DAYS"))
"RTN","PSOERX1B",248,0)
 D FILE^DICN K DD,DIC,DO I Y<0 D  Q
"RTN","PSOERX1B",249,0)
 .S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Unable to add order to Pending file."
"RTN","PSOERX1B",250,0)
 .I MTYPE="RE" D UPDSTAT^PSOERXU1(PSOIEN,"RXF",PSOEXMS(PSOEXCNT))
"RTN","PSOERX1B",251,0)
 .S REQIEN=$$GETREQ^PSOERXU2(PSOIEN) I REQIEN D UPDSTAT^PSOERXU1(PSOIEN,"RRF",PSOEXMS)
"RTN","PSOERX1B",252,0)
 S PSOCPEND=+Y
"RTN","PSOERX1B",253,0)
 S $P(^PS(52.41,PSOCPEND,0),"^",2)=PSOHY("PAT"),$P(^(0),"^",3)=PSOHY("OCC"),$P(^(0),"^",12)=$G(PSOHY("EDT")),$P(^(0),"^",13)=$G(PSOHY("LOC"))
"RTN","PSOERX1B",254,0)
 S $P(^PS(52.41,PSOCPEND,0),"^",14)=$G(PSOHY("PRIOR")),$P(^(0),"^",17)=$G(PSOHY("PICK"))
"RTN","PSOERX1B",255,0)
 S $P(^PS(52.41,PSOCPEND,"EXT"),"^")=PSOHY("CHNUM"),$P(^("EXT"),"^",2)=0,$P(^("EXT"),"^",3)=PSOHY("EXAPP")
"RTN","PSOERX1B",256,0)
 S DIE="^PS(52.41,",DA=PSOCPEND,DR="104.1///1" D ^DIE K DIE,DA,DR
"RTN","PSOERX1B",257,0)
 ; PSO*7*506
"RTN","PSOERX1B",258,0)
 S FDA(52.41,PSOCPEND_",",104)=$G(PATINST) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",259,0)
 N DA,DIK S DA=PSOCPEND,DIK="^PS(52.41,",DIK(1)="114^C" D EN1^DIK
"RTN","PSOERX1B",260,0)
 I $O(PSOHY("PRCOM",0)) D  I PSOHQT S ^PS(52.41,PSOCPEND,3,0)="^^"_PSOHQT_"^"_PSOHQT_"^"_DT_"^"
"RTN","PSOERX1B",261,0)
 .S PSOHQ="",PSOHQT=0 F  S PSOHQ=$O(PSOHY("PRCOM",PSOHQ)) Q:PSOHQ=""  I $G(PSOHY("PRCOM",PSOHQ))'="" S PSOHQT=PSOHQT+1,^PS(52.41,PSOCPEND,3,PSOHQT,0)=$G(PSOHY("PRCOM",PSOHQ))
"RTN","PSOERX1B",262,0)
 I $O(PSOHY("SIG",0)) D  I PSOHQT S ^PS(52.41,PSOCPEND,"SIG",0)="^52.4124A^"_PSOHQT_"^"_PSOHQT
"RTN","PSOERX1B",263,0)
 .S PSOHQ="",PSOHQT=0 F  S PSOHQ=$O(PSOHY("SIG",PSOHQ)) Q:PSOHQ=""  I $G(PSOHY("SIG",PSOHQ))'="" S PSOHQT=PSOHQT+1,^PS(52.41,PSOCPEND,"SIG",PSOHQT,0)=$G(PSOHY("SIG",PSOHQ))
"RTN","PSOERX1B",264,0)
 S $P(^PS(52.41,PSOCPEND,"INI"),"^")=$G(PSOHINLO)
"RTN","PSOERX1B",265,0)
 ; add quantity/timing subfile information
"RTN","PSOERX1B",266,0)
 I $O(PSOHY("QTSUB",0)) D  I PSOHQT S ^PS(52.41,PSOCPEND,1,0)="^52.413^"_PSOHQT_"^"_PSOHQT
"RTN","PSOERX1B",267,0)
 .S PSOHQ="",PSOHQT=0 F  S PSOHQ=$O(PSOHY("QTSUB",PSOHQ)) Q:PSOHQ=""  D
"RTN","PSOERX1B",268,0)
 ..I $O(PSOHY("QTSUB",PSOHQ,0)) S PSOHQT=PSOHQT+1
"RTN","PSOERX1B",269,0)
 ..S ^PS(52.41,PSOCPEND,1,PSOHQT,0)=PSOHY("QTSUB",PSOHQ,0)
"RTN","PSOERX1B",270,0)
 ..S ^PS(52.41,PSOCPEND,1,PSOHQT,1)=PSOHY("QTSUB",PSOHQ,1)
"RTN","PSOERX1B",271,0)
 ..S ^PS(52.41,PSOCPEND,1,PSOHQT,2)=PSOHY("QTSUB",PSOHQ,2)
"RTN","PSOERX1B",272,0)
 I $O(PINARY(0)) D WP^DIE(52.41,PSOCPEND_",",105,"K","PINARY")
"RTN","PSOERX1B",273,0)
 ;Cross references not set yet preventing Pharmacy from finishing order
"RTN","PSOERX1B",274,0)
 D EN^PSOHLSNC(PSOCPEND,"SN","IP")
"RTN","PSOERX1B",275,0)
 D FULL^VALM1
"RTN","PSOERX1B",276,0)
 ;Just set to DC, don't delete because 52.41 entry would be re-used
"RTN","PSOERX1B",277,0)
 ;I '$P($G(^PS(52.41,PSOCPEND,"EXT")),"^",2) S DA=PSOCPEND,DIK="^PS(52.41," D ^DIK K DIK,DA S PSOEXMS="Unable to send CHCS order to CPRS." D NAK^PSOHLEXC Q
"RTN","PSOERX1B",278,0)
 I '$P($G(^PS(52.41,PSOCPEND,"EXT")),"^",2) D  S $P(^PS(52.41,PSOCPEND,0),"^",3)="DC" S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Unable to send CHCS order to CPRS." Q
"RTN","PSOERX1B",279,0)
 .;x-ref shouldn't be set, but we'll kill them just in case
"RTN","PSOERX1B",280,0)
 .K ^PS(52.41,"AOR",$P(^PS(52.41,PSOCPEND,0),"^",2),+$P($G(^("INI")),"^"),PSOCPEND),^PS(52.41,"AD",$P(^PS(52.41,PSOCPEND,0),"^",12),+$P($G(^("INI")),"^"),PSOCPEND)
"RTN","PSOERX1B",281,0)
 .K ^PS(52.41,"ACL",+$P(^PS(52.41,PSOCPEND,0),"^",13),$P(^(0),"^",12),PSOCPEND),^PS(52.41,"AQ",+$P($G(^PS(52.41,PSOCPEND,0)),"^",21),PSOCPEND)
"RTN","PSOERX1B",282,0)
 .S $P(^PS(52.41,PSOCPEND,4),"^")="External order, unable to successfully transmit to CPRS."
"RTN","PSOERX1B",283,0)
 .I $D(QUIET) S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="External order, unable to successfully transmit to CPRS."
"RTN","PSOERX1B",284,0)
 .I '$D(QUIET) W !!,"External order, unable to successfully transmit to CPRS."
"RTN","PSOERX1B",285,0)
 .I '$D(QUIET) S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",286,0)
 ;Successful transmission to CPRS
"RTN","PSOERX1B",287,0)
 S DA=PSOCPEND,DIK="^PS(52.41," D IX^DIK
"RTN","PSOERX1B",288,0)
 ; add the pending outpatient order number to 52.49 and update status of eRx to PR (Processed)
"RTN","PSOERX1B",289,0)
 S ERXSTA=$O(^PS(52.45,"C","ERX","PR",0))
"RTN","PSOERX1B",290,0)
 S ORDNUM=$P($G(^PS(52.41,PSOCPEND,0)),U)
"RTN","PSOERX1B",291,0)
 S DIE="^PS(52.49,",DR="25.2///"_PSOCPEND_";.12///"_ORDNUM,DA=PSOIEN D ^DIE K DIE,DA,DR
"RTN","PSOERX1B",292,0)
 ; PSO*7*508 - add checks to update refill requests and responses
"RTN","PSOERX1B",293,0)
 ; add activity to status history
"RTN","PSOERX1B",294,0)
 I MTYPE="N" D UPDSTAT^PSOERXU1(PSOIEN,"PR")
"RTN","PSOERX1B",295,0)
 I MTYPE="RE" D UPDSTAT^PSOERXU1(PSOIEN,"RXP")
"RTN","PSOERX1B",296,0)
 S REQIEN=$$GETREQ^PSOERXU2(PSOIEN) I REQIEN D UPDSTAT^PSOERXU1(REQIEN,"RRP")
"RTN","PSOERX1B",297,0)
 ; PSO*7*508 - end
"RTN","PSOERX1B",298,0)
 ; gather the unexpanded sig and file in 52.41
"RTN","PSOERX1B",299,0)
 S ILOOP=0 F  S ILOOP=$O(^PS(52.49,PSOIEN,31,ILOOP)) Q:'ILOOP  D
"RTN","PSOERX1B",300,0)
 .S IARY(ILOOP)=$G(^PS(52.49,PSOIEN,31,ILOOP,0))
"RTN","PSOERX1B",301,0)
 I $D(IARY) D WP^DIE(52.41,PSOCPEND_",",9,"K","IARY","IERR")
"RTN","PSOERX1B",302,0)
 I '$D(QUIET) W !!,"eRx #"_PSOHY("CHNUM")_" sent to PENDING OUTPATIENT ORDERS!"
"RTN","PSOERX1B",303,0)
 ;PSO*7*520 - add sending and warning/information related to RxVerify Message.
"RTN","PSOERX1B",304,0)
 I MTYPE="N" D
"RTN","PSOERX1B",305,0)
 .W !!,"Sending rxVerify Message to prescriber."
"RTN","PSOERX1B",306,0)
 .D POST^PSOERXO1(PSOIEN,.PSSRET,,,,1)
"RTN","PSOERX1B",307,0)
 .; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERX1B",308,0)
 .I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX1B",309,0)
 .I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX1B",310,0)
 ;PSO*7*520 - end rxVerify changes
"RTN","PSOERX1B",311,0)
 I '$D(QUIET) S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX1B",312,0)
 K QUIET
"RTN","PSOERX1B",313,0)
 Q
"RTN","PSOERX1B",314,0)
 ; remove eRx from holding queue
"RTN","PSOERX1B",315,0)
REM ;
"RTN","PSOERX1B",316,0)
 D REM^PSOERXU4
"RTN","PSOERX1B",317,0)
 Q
"RTN","PSOERX1B",318,0)
 ; reject eRx
"RTN","PSOERX1B",319,0)
REJ ;
"RTN","PSOERX1B",320,0)
 D REJ^PSOERXU4
"RTN","PSOERX1C")
0^4^B64623473^B61030450
"RTN","PSOERX1C",1,0)
PSOERX1C ;ALB/BWF - eRx Utilities ; 8/3/2016 5:14pm
"RTN","PSOERX1C",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,527,508,551**;DEC 1997;Build 37
"RTN","PSOERX1C",3,0)
 ;
"RTN","PSOERX1C",4,0)
 Q
"RTN","PSOERX1C",5,0)
 ; select an item
"RTN","PSOERX1C",6,0)
PRINT(PSOIEN,OP) ;
"RTN","PSOERX1C",7,0)
 N %ZIS,POP
"RTN","PSOERX1C",8,0)
 S OP=$G(OP)
"RTN","PSOERX1C",9,0)
 D FULL^VALM1
"RTN","PSOERX1C",10,0)
 S VALMBCK="R"
"RTN","PSOERX1C",11,0)
 S %ZIS="Q",%ZIS("B")=$G(PSOPROP) D ^%ZIS Q:POP
"RTN","PSOERX1C",12,0)
 ; if queuing, queue it and quit.
"RTN","PSOERX1C",13,0)
 I $D(IO("Q")) D  Q
"RTN","PSOERX1C",14,0)
 .S ZTSAVE("PSOIEN")="",ZTSAVE("OP")=""
"RTN","PSOERX1C",15,0)
 .S ZTRTN="PRINTQ^PSOERX1C(PSOIEN,OP)",ZTDESC="eRx Print" D ^%ZTLOAD
"RTN","PSOERX1C",16,0)
 .K ZTSAVE,ZTRTN
"RTN","PSOERX1C",17,0)
 .D INIT^PSOERX1
"RTN","PSOERX1C",18,0)
 .D TERM^VALM0
"RTN","PSOERX1C",19,0)
 D PRINTQ(PSOIEN,OP)
"RTN","PSOERX1C",20,0)
 D TERM^VALM0
"RTN","PSOERX1C",21,0)
 D INIT^PSOERX1
"RTN","PSOERX1C",22,0)
 Q
"RTN","PSOERX1C",23,0)
 ; fallthrough if no queueing
"RTN","PSOERX1C",24,0)
PRINTQ(PSOIEN,OP) ;
"RTN","PSOERX1C",25,0)
 N %ZIS,POP,RXDAT,PHARIEN,PRVIEN,PATIEN,PHARDAT,PRVDAT,PATDAT,PSOIENS,PHNM,PHAD1,PHAD2,PHCTY,LINE,LOOP
"RTN","PSOERX1C",26,0)
 N PHST,PHZIP,PHNCP,PHTEL,PRFNM,PRLNM,PRMNM,PRAD1,PRAD2,PRCTY,PRST,PRZIP,PRNPI,PRDEA,PRSTL,LTXT,MTYPE,NEWRXIEN
"RTN","PSOERX1C",27,0)
 N PRTEL,PRFAX,PRSUPER,PRAGNT,PTLNM,PTFNM,PTMNM,PTAD1,PTAD2,PTCTY,PTST,PTZIP,PTDOB,PTGEN,PTHPHON,PTPLANID
"RTN","PSOERX1C",28,0)
 N PHARIENS,PATIENS,PRVIENS,PTSSN,PRAGNTFN,PRAGNTMN,PRAGNTLN,TYPE,VALUE,PRFAX,PRTEL,SIEN,REFILL,IENS,CANREQ,CANRES,ERXDSUB
"RTN","PSOERX1C",29,0)
 S OP=$G(OP,"")
"RTN","PSOERX1C",30,0)
 S PSOIEN=$G(PSOIEN)
"RTN","PSOERX1C",31,0)
 I '$G(PSOIEN) D
"RTN","PSOERX1C",32,0)
 .I $D(RXOR) S PSOIEN=$$CHKERX^PSOERXU1($P(RXOR,U,2)) Q:PSOIEN
"RTN","PSOERX1C",33,0)
 .I $D(OR0) S PSOIEN=$$CHKERX^PSOERXU1(OR0)
"RTN","PSOERX1C",34,0)
 Q:'$G(PSOIEN)
"RTN","PSOERX1C",35,0)
 S MTYPE=$$GET1^DIQ(52.49,PSOIEN,.08,"I")
"RTN","PSOERX1C",36,0)
 I MTYPE="CN"!(MTYPE="RE")!(MTYPE="IE") D
"RTN","PSOERX1C",37,0)
 .S CANRES=PSOIEN
"RTN","PSOERX1C",38,0)
 .S CANREQ=$$GETREQ^PSOERXU2(PSOIEN)
"RTN","PSOERX1C",39,0)
 .I $G(CANREQ) S NEWRXIEN=$$RESOLV^PSOERXU2(CANREQ)
"RTN","PSOERX1C",40,0)
 .; if there is no NewRx related to this request, pull the data from the cancel request itself.
"RTN","PSOERX1C",41,0)
 .I '$P(NEWRXIEN,U) S NEWRXIEN=$G(CANREQ)
"RTN","PSOERX1C",42,0)
 I MTYPE="CA"!(MTYPE="RR") D
"RTN","PSOERX1C",43,0)
 .S CANREQ=PSOIEN,CANRES=$$GETRESP^PSOERXU2(CANREQ)
"RTN","PSOERX1C",44,0)
 .S NEWRXIEN=$$RESOLV^PSOERXU2(CANREQ)
"RTN","PSOERX1C",45,0)
 .I '$P(NEWRXIEN,U) S NEWRXIEN=$G(CANREQ)
"RTN","PSOERX1C",46,0)
 S PSOIENS=$S($G(NEWRXIEN):NEWRXIEN_",",1:PSOIEN_",")
"RTN","PSOERX1C",47,0)
 ; if we found the newrxien because of a different message type, reset PSOIEN to pull rx info from the newrx.
"RTN","PSOERX1C",48,0)
 I $G(NEWRXIEN) S PSOIEN=NEWRXIEN
"RTN","PSOERX1C",49,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","PSOERX1C",50,0)
 U IO
"RTN","PSOERX1C",51,0)
 D GETS^DIQ(52.49,PSOIENS,".04;.08;2.1;2.5","I","RXDAT")
"RTN","PSOERX1C",52,0)
 S PHARIEN=$G(RXDAT(52.49,PSOIENS,2.5,"I")) I PHARIEN S PHARIENS=PHARIEN_","
"RTN","PSOERX1C",53,0)
 S PRVIEN=$G(RXDAT(52.49,PSOIENS,2.1,"I")) I PRVIEN S PRVIENS=PRVIEN_","
"RTN","PSOERX1C",54,0)
 S PATIEN=$G(RXDAT(52.49,PSOIENS,.04,"I")) I PATIEN S PATIENS=PATIEN_","
"RTN","PSOERX1C",55,0)
 I $D(PHARIENS) D GETS^DIQ(52.47,PHARIENS,"**","E","PHARDAT")
"RTN","PSOERX1C",56,0)
 I $D(PRVIENS) D GETS^DIQ(52.48,PRVIENS,"**","E","PRVDAT")
"RTN","PSOERX1C",57,0)
 I $D(PATIENS) D GETS^DIQ(52.46,PATIENS,"**","E","PATDAT")
"RTN","PSOERX1C",58,0)
 ; pharmacy information
"RTN","PSOERX1C",59,0)
 S PHNM=$G(PHARDAT(52.47,PHARIENS,.05,"E"))
"RTN","PSOERX1C",60,0)
 S PHAD1=$G(PHARDAT(52.47,PHARIENS,1.1,"E"))
"RTN","PSOERX1C",61,0)
 S PHAD2=$G(PHARDAT(52.47,PHARIENS,1.2,"E"))
"RTN","PSOERX1C",62,0)
 S PHCTY=$G(PHARDAT(52.47,PHARIENS,1.3,"E"))
"RTN","PSOERX1C",63,0)
 S PHST=$G(PHARDAT(52.47,PHARIENS,1.4,"E"))
"RTN","PSOERX1C",64,0)
 S PHZIP=$G(PHARDAT(52.47,PHARIENS,1.5,"E"))
"RTN","PSOERX1C",65,0)
 S PHNCP=$G(PHARDAT(52.47,PHARIENS,.02,"E"))
"RTN","PSOERX1C",66,0)
 ; future - get telephone
"RTN","PSOERX1C",67,0)
 S PHTEL=""
"RTN","PSOERX1C",68,0)
 ; provider information
"RTN","PSOERX1C",69,0)
 S PRFNM=$G(PRVDAT(52.48,PRVIENS,.03,"E"))
"RTN","PSOERX1C",70,0)
 S PRMNM=$G(PRVDAT(52.48,PRVIENS,.04,"E"))
"RTN","PSOERX1C",71,0)
 S PRLNM=$G(PRVDAT(52.48,PRVIENS,.02,"E"))
"RTN","PSOERX1C",72,0)
 S PRAD1=$G(PRVDAT(52.48,PRVIENS,4.1,"E"))
"RTN","PSOERX1C",73,0)
 S PRAD2=$G(PRVDAT(52.48,PRVIENS,4.2,"E"))
"RTN","PSOERX1C",74,0)
 S PRCTY=$G(PRVDAT(52.48,PRVIENS,4.3,"E"))
"RTN","PSOERX1C",75,0)
 S PRST=$G(PRVDAT(52.48,PRVIENS,4.4,"E"))
"RTN","PSOERX1C",76,0)
 S PRZIP=$G(PRVDAT(52.48,PRVIENS,4.5,"E"))
"RTN","PSOERX1C",77,0)
 S PRNPI=$G(PRVDAT(52.48,PRVIENS,1.5,"E"))
"RTN","PSOERX1C",78,0)
 S PRDEA=$G(PRVDAT(52.48,PRVIENS,1.6,"E"))
"RTN","PSOERX1C",79,0)
 S PRSTL=$G(PRVDAT(52.48,PRVIENS,1.8,"E"))
"RTN","PSOERX1C",80,0)
 I '$G(NEWRXIEN) S PRSUPER=$$GET1^DIQ(52.49,PSOIEN,2.6,"E")
"RTN","PSOERX1C",81,0)
 I $G(NEWRXIEN) S PRSUPER=$$GET1^DIQ(52.49,NEWRXIEN,2.6,"E")
"RTN","PSOERX1C",82,0)
 S PRAGNTFN=$$GET1^DIQ(52.48,PRVIEN,5.2,"E")
"RTN","PSOERX1C",83,0)
 S PRAGNTMN=$$GET1^DIQ(52.48,PRVIEN,5.3,"E")
"RTN","PSOERX1C",84,0)
 S PRAGNTLN=$$GET1^DIQ(52.48,PRVIEN,5.1,"E")
"RTN","PSOERX1C",85,0)
 ;/BLB/ PSO*7.0*520  - BEGIN CHANGE
"RTN","PSOERX1C",86,0)
 S SIEN=0
"RTN","PSOERX1C",87,0)
 F  S SIEN=$O(^PS(52.48,PRVIEN,3,SIEN)) Q:'SIEN  D
"RTN","PSOERX1C",88,0)
 .S IENS=SIEN_","_PRVIEN_","
"RTN","PSOERX1C",89,0)
 .S TYPE=$$GET1^DIQ(52.483,IENS,.02)
"RTN","PSOERX1C",90,0)
 .S VALUE=$$GET1^DIQ(52.483,IENS,.01)
"RTN","PSOERX1C",91,0)
 .I TYPE="FAX" S PRFAX=VALUE
"RTN","PSOERX1C",92,0)
 .I TYPE="TELEPHONE" S PRTEL=VALUE
"RTN","PSOERX1C",93,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",94,0)
 ; patient information
"RTN","PSOERX1C",95,0)
 S PTLNM=$G(PATDAT(52.46,PATIENS,.02,"E"))
"RTN","PSOERX1C",96,0)
 S PTMNM=$G(PATDAT(52.46,PATIENS,.04,"E"))
"RTN","PSOERX1C",97,0)
 S PTFNM=$G(PATDAT(52.46,PATIENS,.03,"E"))
"RTN","PSOERX1C",98,0)
 S PTAD1=$G(PATDAT(52.46,PATIENS,3.1,"E"))
"RTN","PSOERX1C",99,0)
 S PTAD2=$G(PATDAT(52.46,PATIENS,3.2,"E"))
"RTN","PSOERX1C",100,0)
 S PTCTY=$G(PATDAT(52.46,PATIENS,3.3,"E"))
"RTN","PSOERX1C",101,0)
 S PTST=$G(PATDAT(52.46,PATIENS,3.4,"E"))
"RTN","PSOERX1C",102,0)
 S PTZIP=$G(PATDAT(52.46,PATIENS,3.5,"E"))
"RTN","PSOERX1C",103,0)
 S PTDOB=$G(PATDAT(52.46,PATIENS,.08,"E"))
"RTN","PSOERX1C",104,0)
 S PTGEN=$G(PATDAT(52.46,PATIENS,.07,"E"))
"RTN","PSOERX1C",105,0)
 S PTSSN=$G(PATDAT(52.46,PATIENS,1.4,"E"))
"RTN","PSOERX1C",106,0)
 S PTHPHON=""
"RTN","PSOERX1C",107,0)
 S PTPLANID=""
"RTN","PSOERX1C",108,0)
 W !,"*************************PHARMACY INFORMATION****************************"
"RTN","PSOERX1C",109,0)
 W !,$$UP^XLFSTR(PHNM)
"RTN","PSOERX1C",110,0)
 W !,"Address: "_PHAD1
"RTN","PSOERX1C",111,0)
 I $L(PHAD2) W !,"         "_PHAD2
"RTN","PSOERX1C",112,0)
 W !,!,"         "_PHCTY_", "_PHST_" "_PHZIP
"RTN","PSOERX1C",113,0)
 S LTXT=""
"RTN","PSOERX1C",114,0)
 D ADDITEM^PSOERX1A(.LTXT,"Tel: ",PHTEL,1,26)
"RTN","PSOERX1C",115,0)
 D ADDITEM^PSOERX1A(.LTXT,"NCPDP: ",PHNCP,28,26)
"RTN","PSOERX1C",116,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",117,0)
 W !,"******************PRESCRIBER INFORMATION*********************************"
"RTN","PSOERX1C",118,0)
 ; /BLB/ PSO*7.0*520 - CHANGED ORDER OF NAMES TO LAST,FIRST,MIDDLE - BEGIN CHANGE
"RTN","PSOERX1C",119,0)
 W !,"Last: "_PRLNM
"RTN","PSOERX1C",120,0)
 W !,"First: "_PRFNM
"RTN","PSOERX1C",121,0)
 W !,"Mid: "_PRMNM
"RTN","PSOERX1C",122,0)
 ; /BLB/ - END CHANGE
"RTN","PSOERX1C",123,0)
 W !,"Address: "_PRAD1
"RTN","PSOERX1C",124,0)
 I $L(PHAD2) W !,"         "_PRAD2
"RTN","PSOERX1C",125,0)
 W !,"         "_PRCTY_", "_PRST_" "_PRZIP
"RTN","PSOERX1C",126,0)
 S LTXT="" ;/BLB/ PSO*7.0*527 - BEGIN CHANGE - MOVE FIELDS TO THEIR OWN LINE
"RTN","PSOERX1C",127,0)
 W !,"NPI: "_PRNPI
"RTN","PSOERX1C",128,0)
 W !,"DEA: "_PRDEA
"RTN","PSOERX1C",129,0)
 W !,"State Lic: "_PRSTL
"RTN","PSOERX1C",130,0)
 ;/BLB/ - PSO*7.0*527 END CHANGE
"RTN","PSOERX1C",131,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",132,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1C",133,0)
 W !,"Tel: "_$G(PRTEL)
"RTN","PSOERX1C",134,0)
 W !,"Fax: "_$G(PRFAX)
"RTN","PSOERX1C",135,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",136,0)
 W !,"Supervisor: "_$G(PRSUPER)
"RTN","PSOERX1C",137,0)
 W !,"Agent Last Name: "_$G(PRAGNTLN)
"RTN","PSOERX1C",138,0)
 W !,"Agent First Name: "_$G(PRAGNTFN)
"RTN","PSOERX1C",139,0)
 W !,"Agent Middle Name: "_$G(PRAGNTMN)
"RTN","PSOERX1C",140,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",141,0)
 W !,"******************PATIENT INFORMATION************************************"
"RTN","PSOERX1C",142,0)
 S LTXT=""
"RTN","PSOERX1C",143,0)
 ;/BLB/PSO*7.0*520 RESTRUCTURED ORDER OF PATIENT NAME - BEGIN CHANGE
"RTN","PSOERX1C",144,0)
 W !,"Last: "_PTLNM
"RTN","PSOERX1C",145,0)
 W !,"First: "_PTFNM
"RTN","PSOERX1C",146,0)
 W !,"Mid: "_PTMNM
"RTN","PSOERX1C",147,0)
 ;/BLB END CHANGE
"RTN","PSOERX1C",148,0)
 W !,LTXT
"RTN","PSOERX1C",149,0)
 S LTXT=""
"RTN","PSOERX1C",150,0)
 D ADDITEM^PSOERX1A(.LTXT,"SSN: ",PTSSN,1,28)
"RTN","PSOERX1C",151,0)
 D ADDITEM^PSOERX1A(.LTXT,"Sex: ",PTGEN,30,20) W !,LTXT S LTXT=""
"RTN","PSOERX1C",152,0)
 W !,"Address: "_PTAD1
"RTN","PSOERX1C",153,0)
 I $L(PTAD2) W !,"         "_PTAD2
"RTN","PSOERX1C",154,0)
 W !,"         "_PTCTY_", "_PTST_" "_PTZIP
"RTN","PSOERX1C",155,0)
 S LTXT=""
"RTN","PSOERX1C",156,0)
 D ADDITEM^PSOERX1A(.LTXT,"DOB: ",PTDOB,1,26)
"RTN","PSOERX1C",157,0)
 D ADDITEM^PSOERX1A(.LTXT,"Home: ",PTHPHON,28,16)
"RTN","PSOERX1C",158,0)
 D ADDITEM^PSOERX1A(.LTXT,"Plan ID: ",PTPLANID,52,27)
"RTN","PSOERX1C",159,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",160,0)
 W !,"******************PRESCRIPTION INFORMATION*******************************"
"RTN","PSOERX1C",161,0)
 W !,"eRx Drug: "_$$GET1^DIQ(52.49,PSOIEN,3.1,"E")
"RTN","PSOERX1C",162,0)
 S LTXT=""
"RTN","PSOERX1C",163,0)
 D ADDITEM^PSOERX1A(.LTXT,"Qty: ",$$GET1^DIQ(52.49,PSOIEN,5.1,"E"),1,26)
"RTN","PSOERX1C",164,0)
 D ADDITEM^PSOERX1A(.LTXT,"Days Supply: ",$$GET1^DIQ(52.49,PSOIEN,5.5,"E"),28,16)
"RTN","PSOERX1C",165,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE - MOVING "Written Date" TO ITS OWN LINE
"RTN","PSOERX1C",166,0)
 ;D ADDITEM^PSOERX1A(.LTXT,"Date Written: ",$$FMTE^XLFDT($$GET1^DIQ(52.49,PSOIEN,5.9,"E"),"2D"),52,27)
"RTN","PSOERX1C",167,0)
 W !,"Date Written: "_$$FMTE^XLFDT($$GET1^DIQ(52.49,PSOIEN,5.9,"E"),"2D")
"RTN","PSOERX1C",168,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",169,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",170,0)
 ;/BLB/PSO*7.0*520 REMOVED ADDITEM CALLS AND MOVED FIELDS TO INDIVIDUAL LINES - BEGIN CHANGE
"RTN","PSOERX1C",171,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE - CORRECTING QTY QUAL TO CODE LIST QUAL
"RTN","PSOERX1C",172,0)
 W !,"Code List Qualifier: "_$$GET1^DIQ(52.49,PSOIEN,5.2,"E")
"RTN","PSOERX1C",173,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERX1C",174,0)
 W !,"Drug Form: "_$$GET1^DIQ(52.49,PSOIEN,41,"E")
"RTN","PSOERX1C",175,0)
 W !,"Strength: "_$$GET1^DIQ(52.49,PSOIEN,43,"E")
"RTN","PSOERX1C",176,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",177,0)
 W !,LTXT S LTXT=""
"RTN","PSOERX1C",178,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERX1C",179,0)
 S REFILL=$$GET1^DIQ(52.49,PSOIEN,5.6,"E")
"RTN","PSOERX1C",180,0)
 I REFILL'="" D
"RTN","PSOERX1C",181,0)
 .W !,"Refills: "_REFILL
"RTN","PSOERX1C",182,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE - CHANGED TEXT FROM "DO NOT SUB" TO "SUBSTITUTIONS? :"
"RTN","PSOERX1C",183,0)
 S ERXDSUB=$$GET1^DIQ(52.49,PSOIEN,5.8,"I")
"RTN","PSOERX1C",184,0)
 S ERXDSUB=$S(ERXDSUB=1:"NO",ERXDSUB=0:"YES",1:"")
"RTN","PSOERX1C",185,0)
 W !,"Substitutions?: "_ERXDSUB
"RTN","PSOERX1C",186,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERX1C",187,0)
 I REFILL="" D
"RTN","PSOERX1C",188,0)
 .S REFILL=$$GET1^DIQ(52.49,PSOIEN,5.7,"I")
"RTN","PSOERX1C",189,0)
 .W !,"Refills: "_REFILL
"RTN","PSOERX1C",190,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERX1C",191,0)
 W !,"SIG: "_$$GET1^DIQ(52.49,PSOIEN,7,"E")
"RTN","PSOERX1C",192,0)
 D ADDITEM^PSOERX1A(.LTXT,"eRx Reference #: ",$$GET1^DIQ(52.49,PSOIEN,.01,"E"),1,40)
"RTN","PSOERX1C",193,0)
 D ADDITEM^PSOERX1A(.LTXT,"Message ID: ",$$GET1^DIQ(52.49,PSOIEN,25,"E"),42,35)
"RTN","PSOERX1C",194,0)
 W !!,LTXT S LTXT=""
"RTN","PSOERX1C",195,0)
 S ERXDSUB=$$GET1^DIQ(52.49,PSOIEN,5.8,"I")
"RTN","PSOERX1C",196,0)
 S ERXDSUB=$S(ERXDSUB=1:"NO",ERXDSUB=0:"YES",1:"")
"RTN","PSOERX1C",197,0)
 W !,"Substitutions?: "_ERXDSUB
"RTN","PSOERX1C",198,0)
 W !,"Comments: "_$$GET1^DIQ(52.49,PSOIEN,8,"E")
"RTN","PSOERX1C",199,0)
 I MTYPE="CA"!(MTYPE="RR") D
"RTN","PSOERX1C",200,0)
 .S LINE=1 K @VALMAR
"RTN","PSOERX1C",201,0)
 .I MTYPE="CA" D CANREQ^PSOERXU5(CANREQ,.LINE,1),CANRES^PSOERXU5(CANREQ,.LINE,1),MSGHIS^PSOERXU3(CANREQ,.LINE)
"RTN","PSOERX1C",202,0)
 .I MTYPE="RR" D MEDDIS^PSOERXU3(CANREQ,"D",.LINE),RRREQ^PSOERXU3(CANREQ,.LINE),RRRES^PSOERXU3(CANREQ,.LINE),MSGHIS^PSOERXU3(CANREQ,.LINE)
"RTN","PSOERX1C",203,0)
 .S LOOP=0 F  S LOOP=$O(@VALMAR@(LOOP)) Q:'LOOP  D
"RTN","PSOERX1C",204,0)
 ..W !,$G(@VALMAR@(LOOP,0))
"RTN","PSOERX1C",205,0)
 .K @VALMAR
"RTN","PSOERX1C",206,0)
 I MTYPE="CN"!(MTYPE="RE") D
"RTN","PSOERX1C",207,0)
 .S LINE=1 K @VALMAR
"RTN","PSOERX1C",208,0)
 .I MTYPE="CN" D CANRES^PSOERXU5(CANRES,.LINE,1),CANREQ^PSOERXU5(CANRES,.LINE,1),MSGHIS^PSOERXU3(CANRES,.LINE)
"RTN","PSOERX1C",209,0)
 .I MTYPE="RE" D MEDDIS^PSOERXU3(CANRES,"D",.LINE),RRRES^PSOERXU3(CANRES,.LINE),RRREQ^PSOERXU3(CANRES,.LINE),MSGHIS^PSOERXU3(CANRES,.LINE)
"RTN","PSOERX1C",210,0)
 .S LOOP=0 F  S LOOP=$O(@VALMAR@(LOOP)) Q:'LOOP  D
"RTN","PSOERX1C",211,0)
 ..W !,$G(@VALMAR@(LOOP,0))
"RTN","PSOERX1C",212,0)
 .K @VALMAR
"RTN","PSOERX1C",213,0)
 W !,"*******************************END OF eRx********************************"
"RTN","PSOERX1C",214,0)
 D:'$D(ZTQUEUED) ^%ZISC
"RTN","PSOERX1C",215,0)
 Q
"RTN","PSOERXA1")
0^16^B188036698^B188146400
"RTN","PSOERXA1",1,0)
PSOERXA1 ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERXA1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,508,551**;DEC 1997;Build 37
"RTN","PSOERXA1",3,0)
 ;
"RTN","PSOERXA1",4,0)
 Q
"RTN","PSOERXA1",5,0)
 ; File incoming XML into appropriate file
"RTN","PSOERXA1",6,0)
 ; XML - xml text
"RTN","PSOERXA1",7,0)
 ; PRCHK - provider check information
"RTN","PSOERXA1",8,0)
 ; PACHK - patient check information
"RTN","PSOERXA1",9,0)
 ; DACHK - drug auto check
"RTN","PSOERXA1",10,0)
 ; STATION - station #
"RTN","PSOERXA1",11,0)
 ; DIV - institution name^NPI
"RTN","PSOERXA1",12,0)
 ; ERXHID - eRx processing hub id^CANCEL/CHANGE REQUEST DENIED BY HUB (1=YES)
"RTN","PSOERXA1",13,0)
 ; ERXVALS - code values for NIST codes
"RTN","PSOERXA1",14,0)
 ; XML2 - structured sig from the medication prescribed segment
"RTN","PSOERXA1",15,0)
 ; VADAT - DUZ^RXIEN
"RTN","PSOERXA1",16,0)
INCERX(RES,XML,PRCHK,PACHK,DACHK,STATION,DIV,ERXHID,ERXVALS,XML2,VADAT) ;
"RTN","PSOERXA1",17,0)
 N CURREC,FDA,EIEN,ERRTXT,ERRSEQ,PACNT,PASCNT,PAICN,PAIEN,VAINST,NPI,VAOI,VPATINST
"RTN","PSOERXA1",18,0)
 S NPI=$P($G(DIV),U,2)
"RTN","PSOERXA1",19,0)
 S CURREC=$$PARSE(.XML,.ERXVALS,NPI,.XML2)
"RTN","PSOERXA1",20,0)
 I $P(CURREC,U)<1 D  Q
"RTN","PSOERXA1",21,0)
 .I $L($P(CURREC,U,2)) S RES=CURREC Q
"RTN","PSOERXA1",22,0)
 .S RES="0^XML received. Error creating or finding associated record in the ERX Holding queue." Q
"RTN","PSOERXA1",23,0)
 S EIEN=CURREC
"RTN","PSOERXA1",24,0)
 S CURREC=CURREC_","
"RTN","PSOERXA1",25,0)
 ; if this is an outbound message, file the users DUZ and quit back the response. no drug, patient, or provider auto checks will occur
"RTN","PSOERXA1",26,0)
 I $D(VADAT) D  Q
"RTN","PSOERXA1",27,0)
 .I $P($G(VADAT),U)>1 D
"RTN","PSOERXA1",28,0)
 ..S FDA(52.49,CURREC,51.1)=DUZ D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",29,0)
 .I $P(VADAT,U,2) D
"RTN","PSOERXA1",30,0)
 ..S FDA(52.49,CURREC,.13)=$P(VADAT,U,2) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",31,0)
 .S RES="1^Erx Received."
"RTN","PSOERXA1",32,0)
 ; Process auto-validation results. only log positive results for now
"RTN","PSOERXA1",33,0)
 K FDA
"RTN","PSOERXA1",34,0)
 I $P($G(VADAT),U) S RES="1^Message Filed." Q
"RTN","PSOERXA1",35,0)
 I $G(DACHK("success"))="true" D
"RTN","PSOERXA1",36,0)
 .I $G(DACHK("IEN")) D
"RTN","PSOERXA1",37,0)
 ..S FDA(52.49,CURREC,1.4)=1
"RTN","PSOERXA1",38,0)
 ..S FDA(52.49,CURREC,3.2)=DACHK("IEN")
"RTN","PSOERXA1",39,0)
 ..S FDA(52.49,CURREC,44)=1
"RTN","PSOERXA1",40,0)
 ..S VAOI=$$GET1^DIQ(50,DACHK("IEN"),2.1,"I")
"RTN","PSOERXA1",41,0)
 ..S VPATINST=$$GET1^DIQ(50.7,VAOI,7,"E")
"RTN","PSOERXA1",42,0)
 ..I $L(VPATINST) S FDA(52.49,CURREC,27)=VPATINST
"RTN","PSOERXA1",43,0)
 I $G(DACHK("success"))="false" D
"RTN","PSOERXA1",44,0)
 .S ERRTXT=$G(DACHK("error"))
"RTN","PSOERXA1",45,0)
 .S ERRSEQ=$$ERRSEQ^PSOERXU1(EIEN) Q:'ERRSEQ
"RTN","PSOERXA1",46,0)
 .D FILERR^PSOERXU1(CURREC,ERRSEQ,"D","E",ERRTXT)
"RTN","PSOERXA1",47,0)
 I $G(PRCHK("success"))="true" D
"RTN","PSOERXA1",48,0)
 .I PRCHK("IEN") D
"RTN","PSOERXA1",49,0)
 ..S FDA(52.49,CURREC,1.2)=1
"RTN","PSOERXA1",50,0)
 ..S FDA(52.49,CURREC,2.3)=PRCHK("IEN")
"RTN","PSOERXA1",51,0)
 I $G(PRCHK("success"))="false" D
"RTN","PSOERXA1",52,0)
 .S ERRTXT=$G(PRCHK("error"))
"RTN","PSOERXA1",53,0)
 .S ERRSEQ=$$ERRSEQ^PSOERXU1(EIEN) Q:'ERRSEQ
"RTN","PSOERXA1",54,0)
 .D FILERR^PSOERXU1(CURREC,ERRSEQ,"PR","E",ERRTXT)
"RTN","PSOERXA1",55,0)
 I $G(PACHK("MVIerror"))']"" D
"RTN","PSOERXA1",56,0)
 .S PAICN=+$P($G(PACHK("ICN")),"V")
"RTN","PSOERXA1",57,0)
 .I PAICN D
"RTN","PSOERXA1",58,0)
 ..S (PAIEN,PACNT)=0 F  S PAIEN=$O(^DPT("AICN",PAICN,PAIEN)) Q:'PAIEN  D
"RTN","PSOERXA1",59,0)
 ...S PACNT=PACNT+1
"RTN","PSOERXA1",60,0)
 ...; revisit in future build - if we find more than one match in the local system, do we log some sort of an error?
"RTN","PSOERXA1",61,0)
 .I $G(PACNT)=1 D  Q
"RTN","PSOERXA1",62,0)
 ..S FDA(52.49,CURREC,1.6)=1
"RTN","PSOERXA1",63,0)
 ..S FDA(52.49,CURREC,.05)=$O(^DPT("AICN",PAICN,0))
"RTN","PSOERXA1",64,0)
 .I $L(PACHK("ssn")) D
"RTN","PSOERXA1",65,0)
 ..S (PASCNT,PAIEN)=0 F  S PAIEN=$O(^DPT("SSN",$TR(PACHK("ssn"),"-",""),PAIEN)) Q:'PAIEN  D
"RTN","PSOERXA1",66,0)
 ...S PASCNT=PASCNT+1
"RTN","PSOERXA1",67,0)
 .I $G(PASCNT)=1 D  Q
"RTN","PSOERXA1",68,0)
 ..S FDA(52.49,CURREC,1.6)=1
"RTN","PSOERXA1",69,0)
 ..S FDA(52.49,CURREC,.05)=$O(^DPT("SSN",$TR(PACHK("ssn"),"-",""),0))
"RTN","PSOERXA1",70,0)
 I $D(FDA) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",71,0)
 I $G(PACHK("success"))="false" D
"RTN","PSOERXA1",72,0)
 .; file e&e error
"RTN","PSOERXA1",73,0)
 .S ERRTXT=$G(PACHK("EandEerror")) I ERRTXT]"" D
"RTN","PSOERXA1",74,0)
 ..S ERRSEQ=$$ERRSEQ^PSOERXU1(EIEN) Q:'ERRSEQ
"RTN","PSOERXA1",75,0)
 ..D FILERR^PSOERXU1(CURREC,ERRSEQ,"PA","E",ERRTXT)
"RTN","PSOERXA1",76,0)
 .; file mvi error
"RTN","PSOERXA1",77,0)
 .S ERRTXT=$G(PACHK("MVIerror")) I ERRTXT]"" D
"RTN","PSOERXA1",78,0)
 ..S ERRSEQ=$$ERRSEQ^PSOERXU1(EIEN) Q:'ERRSEQ
"RTN","PSOERXA1",79,0)
 ..D FILERR^PSOERXU1(CURREC,ERRSEQ,"PA","E",ERRTXT)
"RTN","PSOERXA1",80,0)
 S RES="1^Erx Received."
"RTN","PSOERXA1",81,0)
 Q
"RTN","PSOERXA1",82,0)
PARSE(STREAM,ERXVALS,NPI,STREAM2) ;
"RTN","PSOERXA1",83,0)
 N %XML,GL,VAINST,MTYPE,HUBDENY
"RTN","PSOERXA1",84,0)
 S GL=$NA(^TMP($J,"PSOERXO1"))
"RTN","PSOERXA1",85,0)
 K @GL
"RTN","PSOERXA1",86,0)
 N STATUS,READER,XOBERR,S,ATTR,READER2,XOBERR2,STATUS2
"RTN","PSOERXA1",87,0)
 S STREAM=$TR(STREAM,"^","")
"RTN","PSOERXA1",88,0)
 I $L(STREAM2) S STREAM2=$TR(STREAM2,"^","")
"RTN","PSOERXA1",89,0)
 S STATUS=##class(%XML.TextReader).ParseStream(STREAM,.READER,,,,,1)
"RTN","PSOERXA1",90,0)
 I $L(STREAM2) S STATUS2=##class(%XML.TextReader).ParseStream(STREAM2,.READER2,,,,,1)
"RTN","PSOERXA1",91,0)
 I $$STATCHK^XOBWLIB(STATUS,.XOBERR,1) D
"RTN","PSOERXA1",92,0)
 .N BREAK
"RTN","PSOERXA1",93,0)
 .S BREAK=0 F  Q:BREAK||READER.EOF||'READER.Read()  D
"RTN","PSOERXA1",94,0)
 ..N X,PUSHED,PARENT
"RTN","PSOERXA1",95,0)
 ..I READER.AttributeCount D
"RTN","PSOERXA1",96,0)
 ...S PARENT=READER.LocalName
"RTN","PSOERXA1",97,0)
 ...D SPUSH(.S,PARENT) S PUSHED=1
"RTN","PSOERXA1",98,0)
 ...F ATTR=1:1:READER.AttributeCount D
"RTN","PSOERXA1",99,0)
 ....D READER.MoveToAttributeIndex(ATTR)
"RTN","PSOERXA1",100,0)
 ....I READER.NodeType="attribute" D APUT(.S,READER.Value,READER.LocalName)
"RTN","PSOERXA1",101,0)
 ..I READER.NodeType="element",'$G(PUSHED) D SPUSH(.S,READER.LocalName)
"RTN","PSOERXA1",102,0)
 ..; PSO*7*508 - if the type is an element, and is an empty element, put it in the global.
"RTN","PSOERXA1",103,0)
 ..I READER.NodeType="element",READER.IsEmptyElement D SPUT(.S,"")
"RTN","PSOERXA1",104,0)
 ..I READER.NodeType="endelement" D SPOP(.S,.X)
"RTN","PSOERXA1",105,0)
 ..I READER.NodeType="chars" D SPUT(.S,READER.Value)
"RTN","PSOERXA1",106,0)
 I $D(STATUS2) D
"RTN","PSOERXA1",107,0)
 .I $$STATCHK^XOBWLIB(STATUS2,.XOBERR2,1) D
"RTN","PSOERXA1",108,0)
 ..N BREAK,S
"RTN","PSOERXA1",109,0)
 ..S BREAK=0 F  Q:BREAK||READER2.EOF||'READER2.Read()  D
"RTN","PSOERXA1",110,0)
 ...N X,PUSHED,PARENT
"RTN","PSOERXA1",111,0)
 ...I READER2.AttributeCount D
"RTN","PSOERXA1",112,0)
 ....S PARENT=READER2.LocalName
"RTN","PSOERXA1",113,0)
 ....D SPUSH(.S,PARENT) S PUSHED=1
"RTN","PSOERXA1",114,0)
 ....F ATTR=1:1:READER2.AttributeCount D
"RTN","PSOERXA1",115,0)
 .....D READER2.MoveToAttributeIndex(ATTR)
"RTN","PSOERXA1",116,0)
 .....I READER2.NodeType="attribute" D APUT(.S,READER2.Value,READER2.LocalName)
"RTN","PSOERXA1",117,0)
 ...I READER2.NodeType="element",'$G(PUSHED) D SPUSH(.S,READER2.LocalName)
"RTN","PSOERXA1",118,0)
 ...; PSO*7*508 - if the type is an element, and is an empty element, put it in the global.
"RTN","PSOERXA1",119,0)
 ...I READER.NodeType="element",READER.IsEmptyElement D SPUT(.S,"")
"RTN","PSOERXA1",120,0)
 ...I READER2.NodeType="endelement" D SPOP(.S,.X)
"RTN","PSOERXA1",121,0)
 ...I READER2.NodeType="chars" D SPUT(.S,READER2.Value)
"RTN","PSOERXA1",122,0)
 S MTYPE=$O(^TMP($J,"PSOERXO1","Message",0,"Body",0,"")) Q:MTYPE']"" "0^Message type could not be identified."
"RTN","PSOERXA1",123,0)
 ;I '$L(NPI) S NPI=$G(^TMP($J,"PSOERXO1","Message",0,"Body",0,"NewRx",0,"Pharmacy",0,"Identification",0,"NPI",0))
"RTN","PSOERXA1",124,0)
 I '$L(NPI) S NPI=$G(^TMP($J,"PSOERXO1","Message",0,"Body",0,MTYPE,0,"Pharmacy",0,"Identification",0,"NPI",0))
"RTN","PSOERXA1",125,0)
 I '$L(NPI) Q "0^Missing NPI. Institution could not be resolved. eRx not filed."
"RTN","PSOERXA1",126,0)
 S VAINST=$$FIND1^DIC(4,,"O",NPI,"ANPI")
"RTN","PSOERXA1",127,0)
 I '$G(VAINST) Q "0^Institution could not be resolved. eRx not filed."
"RTN","PSOERXA1",128,0)
 N NERXIEN,ERR,PATIEN
"RTN","PSOERXA1",129,0)
 S NERXIEN=$$HDR(MTYPE)
"RTN","PSOERXA1",130,0)
 I $P(NERXIEN,U)<1 Q NERXIEN
"RTN","PSOERXA1",131,0)
 I $G(VAINST) S FDA(52.49,NERXIEN_",",24.1)=VAINST D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",132,0)
 ; if message type is 'Error', do not try to file the other components.
"RTN","PSOERXA1",133,0)
 I MTYPE["Error" D  Q NERXIEN
"RTN","PSOERXA1",134,0)
 .S PATIEN=$$GETPAT^PSOERXU5(NERXIEN) Q:'PATIEN
"RTN","PSOERXA1",135,0)
 .S FDA(52.49,NERXIEN_",",.04)=PATIEN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",136,0)
 D PAT(NERXIEN,MTYPE),BFC^PSOERXA5(NERXIEN),PHR^PSOERXA2(NERXIEN,MTYPE),PRE^PSOERXA2(NERXIEN,MTYPE)
"RTN","PSOERXA1",137,0)
 D MED^PSOERXA3(NERXIEN,.ERXVALS,MTYPE),OBS(NERXIEN,MTYPE),SUP^PSOERXA2(NERXIEN,MTYPE)
"RTN","PSOERXA1",138,0)
 D MEDDISP^PSOERXA5(NERXIEN,MTYPE)
"RTN","PSOERXA1",139,0)
 I MTYPE="RefillResponse" D REFRESP^PSOERXA5(NERXIEN,MTYPE)
"RTN","PSOERXA1",140,0)
 I MTYPE["Cancel" D
"RTN","PSOERXA1",141,0)
 .S HUBDENY=$P(ERXHID,U,2)
"RTN","PSOERXA1",142,0)
 .D CANRX^PSOERXA5(NERXIEN,MTYPE,HUBDENY,VAINST)
"RTN","PSOERXA1",143,0)
 ; facility/request have no where to go at this point in time??
"RTN","PSOERXA1",144,0)
 ;/BLB PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXA1",145,0)
 D FAC^PSOERXA2(NERXIEN)
"RTN","PSOERXA1",146,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXA1",147,0)
 Q NERXIEN
"RTN","PSOERXA1",148,0)
HDR(MTYPE) ; header information
"RTN","PSOERXA1",149,0)
 N GL,GL2,FQUAL,TQUAL,FROM,TO,MID,PONUM,SRTID,SSTID,SENTTIME,RTMID,FDA,ERXIEN,FMID,NEWERX,MES,ERXIENS,SSSID,SRSID,MTVALS
"RTN","PSOERXA1",150,0)
 N UPMTYPE,DONE,I,ERXISTAT,MTCODE,COMPSTR,RTHID,RTHIEN,RTMIEN
"RTN","PSOERXA1",151,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Header",0))
"RTN","PSOERXA1",152,0)
 S GL2=$NA(^TMP($J,"PSOERXO1","Message","A","Qualifier","Header","A","Qualifier"))
"RTN","PSOERXA1",153,0)
 ; from and to qualifiers
"RTN","PSOERXA1",154,0)
 S FQUAL=$G(@GL2@("From","A","Qualifier"))
"RTN","PSOERXA1",155,0)
 S TQUAL=$G(@GL2@("To","A","Qualifier"))
"RTN","PSOERXA1",156,0)
 ; from, to, message id, prescriber order number
"RTN","PSOERXA1",157,0)
 S FROM=$G(@GL@("From",0))
"RTN","PSOERXA1",158,0)
 S TO=$G(@GL@("To",0))
"RTN","PSOERXA1",159,0)
 S MID=$G(@GL@("MessageID",0))
"RTN","PSOERXA1",160,0)
 ; set up the full message id
"RTN","PSOERXA1",161,0)
 S FMID=MID
"RTN","PSOERXA1",162,0)
 S ERXIENS="+1,"
"RTN","PSOERXA1",163,0)
 ; quit and return a message back if this eRx exists.
"RTN","PSOERXA1",164,0)
 I $D(^PS(52.49,"FMID",$P(ERXHID,U))) D  Q MES
"RTN","PSOERXA1",165,0)
 .S MES="0^This message already exists. Changes must occur via a change request XML message."
"RTN","PSOERXA1",166,0)
 S PONUM=$G(@GL@("PrescriberOrderNumber",0))
"RTN","PSOERXA1",167,0)
 ; security receiver tertiary identification
"RTN","PSOERXA1",168,0)
 S SRSID=$G(@GL@("Security",0,"Receiver",0,"SecondaryIdentification",0))
"RTN","PSOERXA1",169,0)
 S SRTID=$G(@GL@("Security",0,"Receiver",0,"TertiaryIdentification,",0))
"RTN","PSOERXA1",170,0)
 ; security sender tertiary identification
"RTN","PSOERXA1",171,0)
 S SSSID=$G(@GL@("Security",0,"Sender",0,"SecondaryIdentification",0))
"RTN","PSOERXA1",172,0)
 S SSTID=$G(@GL@("Security",0,"Sender",0,"TertiaryIdentification,",0))
"RTN","PSOERXA1",173,0)
 ; convert senttime to file manager dt/tm
"RTN","PSOERXA1",174,0)
 S SENTTIME=$G(@GL@("SentTime",0)),SENTTIME=$$CONVDTTM^PSOERXA1(SENTTIME)
"RTN","PSOERXA1",175,0)
 S RTMID=$G(@GL@("RelatesToMessageID",0))
"RTN","PSOERXA1",176,0)
 S RTHID=$P(ERXHID,U,3)
"RTN","PSOERXA1",177,0)
 S RTHIEN=""
"RTN","PSOERXA1",178,0)
 I $L(RTHID) S RTHIEN=$O(^PS(52.49,"FMID",RTHID,0))
"RTN","PSOERXA1",179,0)
 D FIELD^DID(52.49,.08,"","POINTER","MTVALS")
"RTN","PSOERXA1",180,0)
 S UPMTYPE=$$UP^XLFSTR(MTYPE)
"RTN","PSOERXA1",181,0)
 S DONE=0
"RTN","PSOERXA1",182,0)
 F I=1:1 D  Q:DONE
"RTN","PSOERXA1",183,0)
 .S COMPSTR=$P(MTVALS("POINTER"),";",I)
"RTN","PSOERXA1",184,0)
 .I COMPSTR="" S DONE=1 Q
"RTN","PSOERXA1",185,0)
 .I COMPSTR[UPMTYPE S MTCODE=$P(COMPSTR,":"),DONE=1
"RTN","PSOERXA1",186,0)
 I $G(MTCODE)']"" Q "0^Message type could not be resolved."
"RTN","PSOERXA1",187,0)
 S FDA(52.49,ERXIENS,.08)=MTCODE
"RTN","PSOERXA1",188,0)
 ; erx hub message id
"RTN","PSOERXA1",189,0)
 S FDA(52.49,ERXIENS,.01)=$P(ERXHID,U)
"RTN","PSOERXA1",190,0)
 ; change healthcare message id
"RTN","PSOERXA1",191,0)
 S FDA(52.49,ERXIENS,25)=FMID
"RTN","PSOERXA1",192,0)
 S FDA(52.49,ERXIENS,.02)=RTMID
"RTN","PSOERXA1",193,0)
 S FDA(52.49,ERXIENS,.03)=$$NOW^XLFDT
"RTN","PSOERXA1",194,0)
 S FDA(52.49,ERXIENS,.09)=PONUM
"RTN","PSOERXA1",195,0)
 ;RELATES TO HUB ID
"RTN","PSOERXA1",196,0)
 S FDA(52.49,ERXIENS,.14)=RTHID
"RTN","PSOERXA1",197,0)
 S ERXISTAT=$$GETSTAT^PSOERXU2(MTCODE,RTHIEN,RTMID)
"RTN","PSOERXA1",198,0)
 S FDA(52.49,ERXIENS,1)=ERXISTAT
"RTN","PSOERXA1",199,0)
 S FDA(52.49,ERXIENS,22.1)=FROM
"RTN","PSOERXA1",200,0)
 S FDA(52.49,ERXIENS,22.2)=FQUAL
"RTN","PSOERXA1",201,0)
 S FDA(52.49,ERXIENS,22.3)=TO
"RTN","PSOERXA1",202,0)
 S FDA(52.49,ERXIENS,22.4)=TQUAL
"RTN","PSOERXA1",203,0)
 S FDA(52.49,ERXIENS,22.5)=SENTTIME
"RTN","PSOERXA1",204,0)
 S FDA(52.49,ERXIENS,24.3)=SSSID
"RTN","PSOERXA1",205,0)
 S FDA(52.49,ERXIENS,24.4)=SSTID
"RTN","PSOERXA1",206,0)
 S FDA(52.49,ERXIENS,24.5)=SRSID
"RTN","PSOERXA1",207,0)
 S FDA(52.49,ERXIENS,24.6)=SRTID
"RTN","PSOERXA1",208,0)
 ; if this is an existing record, file the updates to the erx and return the IEN
"RTN","PSOERXA1",209,0)
 D UPDATE^DIE(,"FDA","NEWERX","EERR") K FDA
"RTN","PSOERXA1",210,0)
 S ERXIEN=""
"RTN","PSOERXA1",211,0)
 S ERXIEN=$O(NEWERX(0)),ERXIEN=$G(NEWERX(ERXIEN))
"RTN","PSOERXA1",212,0)
 I 'ERXIEN Q ""
"RTN","PSOERXA1",213,0)
 I $G(RTHIEN)]"" D
"RTN","PSOERXA1",214,0)
 .N REFREQ,NRXIEN
"RTN","PSOERXA1",215,0)
 .S NRXIEN=$$FINDNRX^PSOERXU6(ERXIEN)
"RTN","PSOERXA1",216,0)
 .I MTCODE="RE" D
"RTN","PSOERXA1",217,0)
 ..S REFREQ=$$GETREQ^PSOERXU2(ERXIEN)
"RTN","PSOERXA1",218,0)
 ..I REFREQ S NRXIEN=$$FINDNRX^PSOERXU6(REFREQ)
"RTN","PSOERXA1",219,0)
 ..I $D(^PS(52.49,NRXIEN,201,"B",ERXIEN)) Q
"RTN","PSOERXA1",220,0)
 ..I $G(NRXIEN) S FDA2(52.49201,"+1,"_NRXIEN_",",.01)=ERXIEN D UPDATE^DIE(,"FDA2") K FDA2
"RTN","PSOERXA1",221,0)
 .; link this message to the original
"RTN","PSOERXA1",222,0)
 .I $G(NRXIEN) D
"RTN","PSOERXA1",223,0)
 ..I $D(^PS(52.49,NRXIEN,201,"B",ERXIEN)) Q
"RTN","PSOERXA1",224,0)
 ..S FDA2(52.49201,"+1,"_NRXIEN_",",.01)=ERXIEN D UPDATE^DIE(,"FDA2") K FDA2
"RTN","PSOERXA1",225,0)
 .I '$D(^PS(52.49,RTHIEN,201,"B",ERXIEN)) D
"RTN","PSOERXA1",226,0)
 ..S FDA2(52.49201,"+1,"_RTHIEN_",",.01)=ERXIEN D UPDATE^DIE(,"FDA2") K FDA2
"RTN","PSOERXA1",227,0)
 .; link original message to this erxien
"RTN","PSOERXA1",228,0)
 .I '$D(^PS(52.49,ERXIEN,201,"B",RTHIEN)) D
"RTN","PSOERXA1",229,0)
 ..S FDA2(52.49201,"+1,"_ERXIEN_",",.01)=RTHIEN D UPDATE^DIE(,"FDA2") K FDA2
"RTN","PSOERXA1",230,0)
 I MTYPE["Error" D ERR^PSOERXU2(ERXIEN,MTYPE)
"RTN","PSOERXA1",231,0)
 ; Future consideration - XSD shows digital signature. Do we need to collect this?
"RTN","PSOERXA1",232,0)
 Q ERXIEN
"RTN","PSOERXA1",233,0)
OBS(ERXIEN,MTYPE) ; Observation
"RTN","PSOERXA1",234,0)
 N GL,I,LAST,DIM,MSOURCE,MUNIT,OBSDT,MVAL,OBSNOTE,OBSCNT,F,EIENS,FDA,MDQUAL
"RTN","PSOERXA1",235,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,MTYPE,0,"Observation",0))
"RTN","PSOERXA1",236,0)
 S F=52.4914,EIENS=ERXIEN_","
"RTN","PSOERXA1",237,0)
 S I=-1,OBSCNT=0 F  S I=$O(@GL@("Measurement",I)) Q:I=""  D
"RTN","PSOERXA1",238,0)
 .S OBSCNT=OBSCNT+1,FDA(F,"+1,"_EIENS,.01)=OBSCNT
"RTN","PSOERXA1",239,0)
 .S DIM=$G(@GL@("Measurement",I,"Dimension",0)),FDA(F,"+1,"_EIENS,.02)=DIM
"RTN","PSOERXA1",240,0)
 .S MDQUAL=$G(@GL@("Measurement",I,"MeasurementDataQualifier",0)),FDA(F,"+1,"_EIENS,.05)=MDQUAL
"RTN","PSOERXA1",241,0)
 .S MSOURCE=$G(@GL@("Measurement",I,"MeasurementSourceCode",0)),FDA(F,"+1,"_EIENS,.06)=MSOURCE
"RTN","PSOERXA1",242,0)
 .S MUNIT=$G(@GL@("Measurement",I,"MeasurementUnitCode",0)),FDA(F,"+1,"_EIENS,.07)=MUNIT
"RTN","PSOERXA1",243,0)
 .S OBSDT=$G(@GL@("Measurement",I,"ObservationDate",0,"Date",0)),OBSDT=$$CONVDTTM^PSOERXA1(OBSDT),FDA(F,"+1,"_EIENS,.04)=OBSDT
"RTN","PSOERXA1",244,0)
 .S MVAL=$G(@GL@("Measurement",I,"Value",0)),FDA(F,"+1,"_EIENS,.03)=MVAL
"RTN","PSOERXA1",245,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",246,0)
 S OBSNOTE=$G(@GL@("ObservationNotes",0)),FDA(52.49,EIENS,15)=OBSNOTE D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",247,0)
 Q
"RTN","PSOERXA1",248,0)
PAT(ERXIEN,MTYPE) ; patient
"RTN","PSOERXA1",249,0)
 N GL,AL1,AL2,CITY,STATE,ZIP,LN,FN,MN,PREF,SUFF,COMQUAL,COMVAL,PLQUAL,DOB,GEN,PRELATE,IDDONE,CDONE,I,C,CQUAL,CVAL
"RTN","PSOERXA1",250,0)
 N IDNM,IDVAL,PFN,ERXPAT,NEWPAT,F,EIENS,FDA,IDFND,SRCH,PIENS,NPIEN,PATSSN,PREL,SIEN
"RTN","PSOERXA1",251,0)
 S F=52.46
"RTN","PSOERXA1",252,0)
 S EIENS=ERXIEN_","
"RTN","PSOERXA1",253,0)
 S GL=$NA(^TMP($J,"PSOERXO1","Message",0,"Body",0,MTYPE,0,"Patient",0))
"RTN","PSOERXA1",254,0)
 S PREL=$G(@GL@("PatientRelationship",0))
"RTN","PSOERXA1",255,0)
 S FN=$$UP^XLFSTR($G(@GL@("Name",0,"FirstName",0)))
"RTN","PSOERXA1",256,0)
 S LN=$$UP^XLFSTR($G(@GL@("Name",0,"LastName",0)))
"RTN","PSOERXA1",257,0)
 S MN=$$UP^XLFSTR($G(@GL@("Name",0,"MiddleName",0)))
"RTN","PSOERXA1",258,0)
 S PFN=LN_","_FN_$S(MN]"":" "_MN,1:"")
"RTN","PSOERXA1",259,0)
 S SUFF=$$UP^XLFSTR($G(@GL@("Name",0,"Suffix",0)))
"RTN","PSOERXA1",260,0)
 S PREF=$$UP^XLFSTR($G(@GL@("Name",0,"Prefix",0)))
"RTN","PSOERXA1",261,0)
 S PRELATE=$G(@GL@("PatientRelationship",0))
"RTN","PSOERXA1",262,0)
 S GEN=$G(@GL@("Gender",0))
"RTN","PSOERXA1",263,0)
 S DOB=$G(@GL@("DateOfBirth",0,"Date",0)),DOB=$$CONVDTTM^PSOERXA1(DOB)
"RTN","PSOERXA1",264,0)
 I DOB<1 S DOB=""
"RTN","PSOERXA1",265,0)
 S AL1=$G(@GL@("Address",0,"AddressLine1",0))
"RTN","PSOERXA1",266,0)
 S AL2=$G(@GL@("Address",0,"AddressLine2",0))
"RTN","PSOERXA1",267,0)
 S CITY=$G(@GL@("Address",0,"City",0))
"RTN","PSOERXA1",268,0)
 S STATE=$G(@GL@("Address",0,"State",0))
"RTN","PSOERXA1",269,0)
 S ZIP=$G(@GL@("Address",0,"ZipCode",0))
"RTN","PSOERXA1",270,0)
 S SIEN=$$STRES^PSOERXA2(ZIP,STATE)
"RTN","PSOERXA1",271,0)
 ; need to check for SSN before trying to match the patient. This needs to be stored in an array for later processing
"RTN","PSOERXA1",272,0)
 ; check 52.46 for a match before filing
"RTN","PSOERXA1",273,0)
 S PATSSN=$G(@GL@("Identification",0,"SocialSecurity",0))
"RTN","PSOERXA1",274,0)
 S ERXPAT=$$FINDPAT^PSOERXU2(PFN,DOB,GEN,$G(PATSSN),$G(AL1)) S PIENS=$S(ERXPAT:ERXPAT_",",1:"+1,")
"RTN","PSOERXA1",275,0)
 ; first, lets set up the main part
"RTN","PSOERXA1",276,0)
 S FDA(F,PIENS,.01)=PFN,FDA(F,PIENS,.02)=LN,FDA(F,PIENS,.03)=FN,FDA(F,PIENS,.04)=MN,FDA(F,PIENS,.05)=SUFF,FDA(F,PIENS,.06)=PREF
"RTN","PSOERXA1",277,0)
 S FDA(F,PIENS,.07)=GEN,FDA(F,PIENS,.08)=DOB
"RTN","PSOERXA1",278,0)
 S FDA(F,PIENS,1.4)=PATSSN,FDA(F,PIENS,1.7)=PREL
"RTN","PSOERXA1",279,0)
 S FDA(F,PIENS,3.1)=AL1,FDA(F,PIENS,3.2)=AL2,FDA(F,PIENS,3.3)=CITY
"RTN","PSOERXA1",280,0)
 S FDA(F,PIENS,3.4)=SIEN
"RTN","PSOERXA1",281,0)
 S FDA(F,PIENS,3.5)=ZIP
"RTN","PSOERXA1",282,0)
 I PIENS["+" D  Q
"RTN","PSOERXA1",283,0)
 .D UPDATE^DIE(,"FDA","NEWPAT") K FDA
"RTN","PSOERXA1",284,0)
 .S NPIEN=$O(NEWPAT(0)),NPIEN=$G(NEWPAT(NPIEN))
"RTN","PSOERXA1",285,0)
 .Q:'NPIEN
"RTN","PSOERXA1",286,0)
 .S NPIEN=NPIEN
"RTN","PSOERXA1",287,0)
 .D PATC(NPIEN)
"RTN","PSOERXA1",288,0)
 .S FDA(52.49,EIENS,.04)=NPIEN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",289,0)
 D FILE^DIE(,"FDA") K FDA D PATC(ERXPAT)
"RTN","PSOERXA1",290,0)
 S FDA(52.49,EIENS,.04)=ERXPAT D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",291,0)
 Q
"RTN","PSOERXA1",292,0)
PATC(IEN) ; patient communication
"RTN","PSOERXA1",293,0)
 N IENS,CQUAL,CVAL,COMARY,FDA,SRCH,IDFND,IDNM,IDVAL,IDARY,PATSSN
"RTN","PSOERXA1",294,0)
 Q:'IEN
"RTN","PSOERXA1",295,0)
 S IENS=IEN_","
"RTN","PSOERXA1",296,0)
 ; Kill off existing communication values
"RTN","PSOERXA1",297,0)
 K ^PS(52.46,IEN,3)
"RTN","PSOERXA1",298,0)
 S C=-1 F  S C=$O(@GL@("CommunicationNumbers",0,"Communication",C)) Q:C=""  D
"RTN","PSOERXA1",299,0)
 .S CQUAL=$G(@GL@("CommunicationNumbers",0,"Communication",C,"Qualifier",0))
"RTN","PSOERXA1",300,0)
 .S CVAL=$G(@GL@("CommunicationNumbers",0,"Communication",C,"Number",0))
"RTN","PSOERXA1",301,0)
 .S COMARY(CQUAL)=CVAL
"RTN","PSOERXA1",302,0)
 .S FDA(52.462,"+1,"_IENS,.01)=CVAL
"RTN","PSOERXA1",303,0)
 .S FDA(52.462,"+1,"_IENS,.02)=CQUAL
"RTN","PSOERXA1",304,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",305,0)
 ; kill existing identification values in multiple
"RTN","PSOERXA1",306,0)
 K ^PS(52.46,IEN,5)
"RTN","PSOERXA1",307,0)
 S IDNM="" F  S IDNM=$O(@GL@("Identification",0,IDNM)) Q:IDNM=""  D
"RTN","PSOERXA1",308,0)
 .S IDVAL=$G(@GL@("Identification",0,IDNM,0))
"RTN","PSOERXA1",309,0)
 .I IDNM="SocialSecurity" S PATSSN=IDVAL
"RTN","PSOERXA1",310,0)
 .S IDARY(IDNM)=IDVAL
"RTN","PSOERXA1",311,0)
 .S IDFND=0
"RTN","PSOERXA1",312,0)
 .S SRCH=0 F  S SRCH=$O(^PS(52.46,IEN,5,SRCH)) Q:'SRCH  D
"RTN","PSOERXA1",313,0)
 ..I $$GET1^DIQ(52.465,SRCH_","_IEN_",",.01)=IDNM D
"RTN","PSOERXA1",314,0)
 ...S IDFND=1
"RTN","PSOERXA1",315,0)
 ...S FDA(52.465,SRCH_","_IEN_",",.02)=IDVAL D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",316,0)
 .Q:IDFND
"RTN","PSOERXA1",317,0)
 .S FDA(52.465,"+1,"_IEN_",",.01)=IDNM
"RTN","PSOERXA1",318,0)
 .S FDA(52.465,"+1,"_IEN_",",.02)=IDVAL
"RTN","PSOERXA1",319,0)
 .D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",320,0)
 I $G(PATSSN)]"" S FDA(52.46,IENS,1.4)=PATSSN D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXA1",321,0)
 Q
"RTN","PSOERXA1",322,0)
SPUSH(S,X) ;places X on the stack S and returns the current level of the stack
"RTN","PSOERXA1",323,0)
 N I S I=$O(S(""),-1)+1,S(I)=X
"RTN","PSOERXA1",324,0)
 Q I
"RTN","PSOERXA1",325,0)
 ;
"RTN","PSOERXA1",326,0)
SPOP(S,X) ;removes the top item from the stack S and put it into the variable X and returns the level that X was at
"RTN","PSOERXA1",327,0)
 N I S I=$O(S(""),-1)
"RTN","PSOERXA1",328,0)
 I I S X=S(I) K S(I)
"RTN","PSOERXA1",329,0)
 N J S J=$O(S(I),-1) I J S S(J,X)=$G(S(J,X))+1
"RTN","PSOERXA1",330,0)
 Q I
"RTN","PSOERXA1",331,0)
 ;
"RTN","PSOERXA1",332,0)
SPEEK(S,X) ;same as SPOP except the top item is not removed
"RTN","PSOERXA1",333,0)
 N I S I=$O(S(""),-1)
"RTN","PSOERXA1",334,0)
 I I S X=S(I)
"RTN","PSOERXA1",335,0)
 Q I
"RTN","PSOERXA1",336,0)
 ;
"RTN","PSOERXA1",337,0)
SPUT(S,X) ;implementation specific, uses the stack to form a global node
"RTN","PSOERXA1",338,0)
 N I,STR
"RTN","PSOERXA1",339,0)
 S X=$TR(X,";","")
"RTN","PSOERXA1",340,0)
 S STR=$P(GL,")")
"RTN","PSOERXA1",341,0)
 S I=0 F  S I=$O(S(I)) Q:'I  D
"RTN","PSOERXA1",342,0)
 .S STR=STR_","_""""_S(I)_""""_","
"RTN","PSOERXA1",343,0)
 .N NUM S NUM=0
"RTN","PSOERXA1",344,0)
 .I $D(S(I-1,S(I))) S NUM=+$G(S(I-1,S(I)))
"RTN","PSOERXA1",345,0)
 .S STR=STR_NUM
"RTN","PSOERXA1",346,0)
 S STR=STR_")"
"RTN","PSOERXA1",347,0)
 I $D(@STR) S @STR=@STR_X
"RTN","PSOERXA1",348,0)
 I '$D(@STR) S @STR=X
"RTN","PSOERXA1",349,0)
 Q STR
"RTN","PSOERXA1",350,0)
APUT(S,X,LN) ; what am i doing here?
"RTN","PSOERXA1",351,0)
 N I,STR
"RTN","PSOERXA1",352,0)
 S X=$TR(X,";","")
"RTN","PSOERXA1",353,0)
 S STR=$P(GL,")")
"RTN","PSOERXA1",354,0)
 S I=0 F  S I=$O(S(I)) Q:'I  D
"RTN","PSOERXA1",355,0)
 .S STR=STR_","_""""_S(I)_""""_","
"RTN","PSOERXA1",356,0)
 .N NUM S NUM="""A"""
"RTN","PSOERXA1",357,0)
 .;I $D(S(I-1,S(I))) S NUM=+$G(S(I-1,S(I)))
"RTN","PSOERXA1",358,0)
 .;S STR=STR_NUM
"RTN","PSOERXA1",359,0)
 .S STR=STR_NUM_","_""""_LN_""""
"RTN","PSOERXA1",360,0)
 S STR=STR_")"
"RTN","PSOERXA1",361,0)
 I $D(@STR) S @STR=@STR_X
"RTN","PSOERXA1",362,0)
 I '$D(@STR) S @STR=X
"RTN","PSOERXA1",363,0)
 Q STR
"RTN","PSOERXA1",364,0)
 ;
"RTN","PSOERXA1",365,0)
 ; VAL - value to resolve
"RTN","PSOERXA1",366,0)
 ; TYPE - This is the code type, which will tell which 'C' index type to get the code from
"RTN","PSOERXA1",367,0)
PRESOLV(VAL,TYPE) ;
"RTN","PSOERXA1",368,0)
 N MATCH
"RTN","PSOERXA1",369,0)
 S MATCH=""
"RTN","PSOERXA1",370,0)
 Q:'$L(TYPE)!('$L(VAL)) "" ; avoid null subscript
"RTN","PSOERXA1",371,0)
 S MATCH=$O(^PS(52.45,"C",TYPE,VAL,0))
"RTN","PSOERXA1",372,0)
 ; return the match found, null if no match
"RTN","PSOERXA1",373,0)
 Q MATCH
"RTN","PSOERXA1",374,0)
CONVDTTM(VAL) ;
"RTN","PSOERXA1",375,0)
 N EDATE,ETIME,X,ETZ,Y
"RTN","PSOERXA1",376,0)
 I '$L(VAL) Q ""
"RTN","PSOERXA1",377,0)
 S EDATE=$P(VAL,"T"),ETIME=$P(VAL,"T",2)
"RTN","PSOERXA1",378,0)
 ; split off time zone
"RTN","PSOERXA1",379,0)
 S ETZ=$P(ETIME,".",2)
"RTN","PSOERXA1",380,0)
 S ETIME=$P(ETIME,".")
"RTN","PSOERXA1",381,0)
 S X=EDATE D ^%DT I 'Y Q ""
"RTN","PSOERXA1",382,0)
 S VAL=Y_$S($L(ETIME):"."_$TR(ETIME,":",""),1:"")
"RTN","PSOERXA1",383,0)
 Q VAL
"RTN","PSOERXC1")
0^7^B104037085^B92546733
"RTN","PSOERXC1",1,0)
PSOERXC1 ;ALB/BWF - eRx Utilities/RPC's ; 6/1/2018 5:14pm
"RTN","PSOERXC1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**508,551**;DEC 1997;Build 37
"RTN","PSOERXC1",3,0)
 ;
"RTN","PSOERXC1",4,0)
EN(SRCH,SORTT,PCVSTAT) ; -- main entry point for PSO ERX PATIENT CENTRIC VIEW
"RTN","PSOERXC1",5,0)
 N PSOC1RE
"RTN","PSOERXC1",6,0)
 D EN^VALM("PSO ERX PATIENT CENTRIC VIEW")
"RTN","PSOERXC1",7,0)
 Q
"RTN","PSOERXC1",8,0)
 ;
"RTN","PSOERXC1",9,0)
HDR ; -- header code
"RTN","PSOERXC1",10,0)
 S VALMHDR(1)="                       Patient Centric View"
"RTN","PSOERXC1",11,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE - ADDING DEFAULT LOOKBACK PARAMETER
"RTN","PSOERXC1",12,0)
 S VALMHDR(2)="                     ERX LOOK-BACK DAYS: "_$$GET1^DIQ(59,PSOSITE,10.2,"E")_" ("_$$FMTE^XLFDT($$FMADD^XLFDT(DT,-$$GET1^DIQ(59,PSOSITE,10.2,"E")))_")"
"RTN","PSOERXC1",13,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXC1",14,0)
 I $G(PSOC1RE) K @VALMAR,PSOC1RE D INIT
"RTN","PSOERXC1",15,0)
 Q
"RTN","PSOERXC1",16,0)
 ;
"RTN","PSOERXC1",17,0)
INIT ; -- init variables and list array
"RTN","PSOERXC1",18,0)
 N EBDATE,EDATE,BDATE,RXSTAT,RXDATE,ERXIEN,PATIEN,RDATE,ERXSTAT,COUNT,PNAME,DOB,DOB2,NEW,WAIT,IPR,HOLD,TOTAL,RXDATE2
"RTN","PSOERXC1",19,0)
 N RXSTATE,PATCNT,B,G,VAR,DIRECT,LINEVAR,EDAYS,EDLOOP,GLOB,LASTUSER,PATINFO,EDAYS2,PATLOOP,CCR,LINE,OTH,CNT,BDOVR,MTYPE
"RTN","PSOERXC1",20,0)
 N SVAL,P5246IEN,ESCODE
"RTN","PSOERXC1",21,0)
 S PSOSRCH=$S($D(SRCH):1,1:0) I PSOSRCH S PSOSRCH(VALMEVL)=""
"RTN","PSOERXC1",22,0)
 S PSOSRT=$S($D(SORTT):1,1:0) I PSOSRT S PSOSRT(VALMEVL)=""
"RTN","PSOERXC1",23,0)
 K ^TMP("CENTRIC",$J),^TMP("RDATE",$J),^TMP("PSOERXC1",$J)
"RTN","PSOERXC1",24,0)
 I '$D(PSOINST) D
"RTN","PSOERXC1",25,0)
 .D ^PSOLSET
"RTN","PSOERXC1",26,0)
 Q:'$D(PSOINST)
"RTN","PSOERXC1",27,0)
 S GLOB=$NA(^TMP("PSOERXC1",$J)) K @GLOB
"RTN","PSOERXC1",28,0)
 S BDATE=$$FMADD^XLFDT(DT,-365)
"RTN","PSOERXC1",29,0)
 S CNT=0,PATCNT=0
"RTN","PSOERXC1",30,0)
 S EDATE=DT_".9999"
"RTN","PSOERXC1",31,0)
 S RXDATE=BDATE
"RTN","PSOERXC1",32,0)
 S BDOVR=$$GET1^DIQ(59,PSOSITE,10.2,"E") I BDOVR S RXDATE=$$FMADD^XLFDT(DT,-BDOVR)
"RTN","PSOERXC1",33,0)
 S RXDATE2=BDATE
"RTN","PSOERXC1",34,0)
 F  S RXDATE=$O(^PS(52.49,"F",PSNPINST,RXDATE)) Q:'RXDATE!(RXDATE>EDATE)!(RXDATE="")!(PATCNT>998)  D
"RTN","PSOERXC1",35,0)
 .I $D(SRCH(1)) D  Q
"RTN","PSOERXC1",36,0)
 ..S SVAL=$P(SRCH(1),U)
"RTN","PSOERXC1",37,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"EPAT",PSNPINST,RXDATE,SVAL,ERXIEN)) Q:'ERXIEN!(PATCNT>998)  D
"RTN","PSOERXC1",38,0)
 ...D BLDITEM(ERXIEN,.PATCNT,$G(PCVSTAT))
"RTN","PSOERXC1",39,0)
 .I $D(SRCH(2)) D  Q
"RTN","PSOERXC1",40,0)
 ..S SVAL=$P(SRCH(2),U)
"RTN","PSOERXC1",41,0)
 ..S P5246IEN=0 F  S P5246IEN=$O(^PS(52.46,"DOB",SVAL,P5246IEN)) Q:'P5246IEN!(PATCNT>998)  D
"RTN","PSOERXC1",42,0)
 ...S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"EPAT",PSNPINST,RXDATE,P5246IEN,ERXIEN)) Q:'ERXIEN!(PATCNT>998)  D
"RTN","PSOERXC1",43,0)
 ....D BLDITEM(ERXIEN,.PATCNT,$G(PCVSTAT))
"RTN","PSOERXC1",44,0)
 .S RXSTAT=0 F  S RXSTAT=$O(^PS(52.49,"F",PSNPINST,RXDATE,RXSTAT)) Q:'RXSTAT!(PATCNT=999)  D
"RTN","PSOERXC1",45,0)
 ..I +$G(STAT),STAT'=RXSTAT Q
"RTN","PSOERXC1",46,0)
 ..S RXSTATE=$$GET1^DIQ(52.45,RXSTAT,.01,"E")
"RTN","PSOERXC1",47,0)
 ..I ((RXSTATE="RJ")!(RXSTATE="RM")!(RXSTATE="PR")!(RXSTATE="E")) Q
"RTN","PSOERXC1",48,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"F",PSNPINST,RXDATE,RXSTAT,ERXIEN)) Q:'ERXIEN!(PATCNT=999)  D
"RTN","PSOERXC1",49,0)
 ...D BLDITEM(ERXIEN,.PATCNT,$G(PCVSTAT))
"RTN","PSOERXC1",50,0)
 S PATIEN=0,LINE=0
"RTN","PSOERXC1",51,0)
 I '$O(^TMP("CENTRIC",$J,0)) S LINE=$G(LINE)+1,VALMCNT=LINE D SET^VALM10(LINE,"No records found.") Q
"RTN","PSOERXC1",52,0)
 F  S PATIEN=$O(^TMP("CENTRIC",$J,PATIEN)) Q:'PATIEN  D
"RTN","PSOERXC1",53,0)
 .S PNAME=$$GET1^DIQ(52.46,PATIEN,.01)
"RTN","PSOERXC1",54,0)
 .S DOB=$$GET1^DIQ(52.46,PATIEN,.08,"I"),DOB2=$$FMTE^XLFDT(DOB,"5Z")
"RTN","PSOERXC1",55,0)
 .F  S RXDATE2=$O(^PS(52.49,"PAT2",PATIEN,RXDATE2)) Q:'RXDATE2!(RXDATE2>EDATE)  D
"RTN","PSOERXC1",56,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"PAT2",PATIEN,RXDATE2,ERXIEN)) Q:'ERXIEN  D
"RTN","PSOERXC1",57,0)
 ...Q:$$GET1^DIQ(52.49,ERXIEN,24.1,"I")'=PSNPINST
"RTN","PSOERXC1",58,0)
 ...S ERXSTAT=$$GET1^DIQ(52.49,ERXIEN,1,"E")
"RTN","PSOERXC1",59,0)
 ...I (ERXSTAT="PR")!(ERXSTAT="RM")!(ERXSTAT="RJ")!(ERXSTAT="E") Q
"RTN","PSOERXC1",60,0)
 ...S ESCODE=","_$S($E(ERXSTAT)="H":$E(ERXSTAT),1:ERXSTAT)_"," I ",RRE,RXN,RXW,RXD,RXF,CAO,CAR,CAH,CAP,CAX,CAF,N,I,W,H,"'[ESCODE Q
"RTN","PSOERXC1",61,0)
 ...S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERXC1",62,0)
 ...S RDATE=$E($$GET1^DIQ(52.49,ERXIEN,.03,"I"),1,7)
"RTN","PSOERXC1",63,0)
 ...I '$D(^TMP("RDATE",$J,PATIEN,0)) S ^TMP("RDATE",$J,PATIEN,0)=$G(RDATE)
"RTN","PSOERXC1",64,0)
 ...I $D(^TMP("RDATE",$J,PATIEN,0)),^TMP("RDATE",$J,PATIEN,0)>$G(RDATE) S ^TMP("RDATE",$J,PATIEN,0)=$G(RDATE)
"RTN","PSOERXC1",65,0)
 ...S COUNT=$G(^TMP("CENTRIC",$J,PATIEN,0))
"RTN","PSOERXC1",66,0)
 ...I ERXSTAT="N" S $P(COUNT,U,1)=$P($G(COUNT),U)+1
"RTN","PSOERXC1",67,0)
 ...I ERXSTAT="W" S $P(COUNT,U,2)=$P($G(COUNT),U,2)+1
"RTN","PSOERXC1",68,0)
 ...I ERXSTAT="I" S $P(COUNT,U,3)=$P($G(COUNT),U,3)+1
"RTN","PSOERXC1",69,0)
 ...I $E(ERXSTAT)="H" S $P(COUNT,U,4)=$P($G(COUNT),U,4)+1
"RTN","PSOERXC1",70,0)
 ...I ((ERXSTAT="RXN")!(ERXSTAT="RXW")!(ERXSTAT="RXD")!(ERXSTAT="RXF")!(ERXSTAT="CAO")!(ERXSTAT="CAR")!(ERXSTAT="CAH")!(ERXSTAT="CAP")!(ERXSTAT="CAX")!(ERXSTAT="CAF")) D
"RTN","PSOERXC1",71,0)
 ....S $P(COUNT,U,5)=$P($G(COUNT),U,5)+1
"RTN","PSOERXC1",72,0)
 ...; finialize and display count for 'other' types.
"RTN","PSOERXC1",73,0)
 ...I MTYPE="IE",ERXSTAT="RRE" S $P(COUNT,U,6)=$P($G(COUNT),U,6)+1
"RTN","PSOERXC1",74,0)
 ...S ^TMP("CENTRIC",$J,PATIEN,0)=COUNT
"RTN","PSOERXC1",75,0)
 .S COUNT=$G(^TMP("CENTRIC",$J,PATIEN,0))
"RTN","PSOERXC1",76,0)
 .F G=1:1:6 D
"RTN","PSOERXC1",77,0)
 ..I $P(COUNT,U,G)="" D
"RTN","PSOERXC1",78,0)
 ...S $P(COUNT,U,G)=0
"RTN","PSOERXC1",79,0)
 .S NEW=$P(COUNT,U)
"RTN","PSOERXC1",80,0)
 .S WAIT=$P(COUNT,U,2)
"RTN","PSOERXC1",81,0)
 .S IPR=$P(COUNT,U,3)
"RTN","PSOERXC1",82,0)
 .S HOLD=$P(COUNT,U,4)
"RTN","PSOERXC1",83,0)
 .S CCR=$P(COUNT,U,5)
"RTN","PSOERXC1",84,0)
 .S OTH=$P(COUNT,U,6)
"RTN","PSOERXC1",85,0)
 .S EDAYS=$$FMDIFF^XLFDT(DT,$G(^TMP("RDATE",$J,PATIEN,0)))
"RTN","PSOERXC1",86,0)
 .;/BLB/ PSO*7.0*551 - BEGIN CHANGE - NEW LOCK INDICATOR
"RTN","PSOERXC1",87,0)
 .S LASTUSER=$S($D(^XTMP("PSOERXLOCK",PATIEN)):$$GET1^DIQ(200,$P(^XTMP("PSOERXLOCK",PATIEN),U),.01,"E"),1:"")
"RTN","PSOERXC1",88,0)
 .;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXC1",89,0)
 .S TOTAL=""
"RTN","PSOERXC1",90,0)
 .F B=1:1:6 D
"RTN","PSOERXC1",91,0)
 ..S VAR=$P(COUNT,U,B)
"RTN","PSOERXC1",92,0)
 ..S TOTAL=TOTAL+VAR
"RTN","PSOERXC1",93,0)
 .I TOTAL=0 Q
"RTN","PSOERXC1",94,0)
 .I TOTAL>999 S TOTAL=999
"RTN","PSOERXC1",95,0)
 .S EDAYS2=$S($L(EDAYS)=1:" "_EDAYS,1:EDAYS)
"RTN","PSOERXC1",96,0)
 .I $L(TOTAL)=1 S TOTAL="  "_TOTAL
"RTN","PSOERXC1",97,0)
 .I $L(TOTAL)=2 S TOTAL=" "_TOTAL
"RTN","PSOERXC1",98,0)
 .I NEW>99 S NEW=99
"RTN","PSOERXC1",99,0)
 .I $L(NEW)=1 S NEW=" "_NEW
"RTN","PSOERXC1",100,0)
 .I WAIT>99 S WAIT=99
"RTN","PSOERXC1",101,0)
 .I $L(WAIT)=1 S WAIT=" "_WAIT
"RTN","PSOERXC1",102,0)
 .I IPR>99 S IPR=99
"RTN","PSOERXC1",103,0)
 .I $L(IPR)=1 S IPR=" "_IPR
"RTN","PSOERXC1",104,0)
 .I HOLD>99 S HOLD=99
"RTN","PSOERXC1",105,0)
 .I $L(HOLD)=1 S HOLD=" "_HOLD
"RTN","PSOERXC1",106,0)
 .I CCR>99 S CCR=99
"RTN","PSOERXC1",107,0)
 .I $L(CCR)=1 S CCR="  "_CCR
"RTN","PSOERXC1",108,0)
 .I $L(CCR)=2 S CCR=" "_CCR
"RTN","PSOERXC1",109,0)
 .I OTH>99 S OTH=99
"RTN","PSOERXC1",110,0)
 .I $L(OTH)=1 S OTH="  "_OTH
"RTN","PSOERXC1",111,0)
 .I $L(OTH)=2 S OTH=" "_OTH
"RTN","PSOERXC1",112,0)
 .I $G(SORTT) D  Q
"RTN","PSOERXC1",113,0)
 ..I SORTT=1 S @GLOB@(PNAME,PATIEN)=PNAME_U_DOB2_U_EDAYS2_U_LASTUSER_U_NEW_U_WAIT_U_IPR_U_HOLD_U_CCR_U_OTH_U_TOTAL,DIRECT=1
"RTN","PSOERXC1",114,0)
 ..I SORTT=2 S @GLOB@(DOB,PATIEN)=PNAME_U_DOB2_U_EDAYS2_U_LASTUSER_U_NEW_U_WAIT_U_IPR_U_HOLD_U_CCR_U_OTH_U_TOTAL,DIRECT=1
"RTN","PSOERXC1",115,0)
 ..I SORTT=3 S @GLOB@(TOTAL,PATIEN)=PNAME_U_DOB2_U_EDAYS2_U_LASTUSER_U_NEW_U_WAIT_U_IPR_U_HOLD_U_CCR_U_OTH_U_TOTAL,DIRECT=1
"RTN","PSOERXC1",116,0)
 .S @GLOB@(EDAYS,PATIEN)=PNAME_U_DOB2_U_EDAYS2_U_LASTUSER_U_NEW_U_WAIT_U_IPR_U_HOLD_U_CCR_U_OTH_U_TOTAL
"RTN","PSOERXC1",117,0)
 I '$D(DIRECT) S DIRECT=-1
"RTN","PSOERXC1",118,0)
 S EDLOOP=""
"RTN","PSOERXC1",119,0)
 F  S EDLOOP=$O(@GLOB@(EDLOOP),DIRECT) Q:EDLOOP=""  D
"RTN","PSOERXC1",120,0)
 .S PATLOOP=""
"RTN","PSOERXC1",121,0)
 .F  S PATLOOP=$O(@GLOB@(EDLOOP,PATLOOP)) Q:PATLOOP=""  D
"RTN","PSOERXC1",122,0)
 ..S LINE=LINE+1,LINEVAR=""
"RTN","PSOERXC1",123,0)
 ..S PATINFO=$G(@GLOB@(EDLOOP,PATLOOP))
"RTN","PSOERXC1",124,0)
 ..S LINEVAR=$$SETFLD^VALM1(LINE_".",LINEVAR,"#")
"RTN","PSOERXC1",125,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U),LINEVAR,"ERX PATIENT")
"RTN","PSOERXC1",126,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,2),LINEVAR,"DOB")
"RTN","PSOERXC1",127,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,3),LINEVAR,"ED")
"RTN","PSOERXC1",128,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,4),LINEVAR,"LOCKED BY")
"RTN","PSOERXC1",129,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,5),LINEVAR,"NW")
"RTN","PSOERXC1",130,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,6),LINEVAR,"WT")
"RTN","PSOERXC1",131,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,7),LINEVAR,"IP")
"RTN","PSOERXC1",132,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,8),LINEVAR,"HD")
"RTN","PSOERXC1",133,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,9),LINEVAR,"CCR")
"RTN","PSOERXC1",134,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,10),LINEVAR,"OTH")
"RTN","PSOERXC1",135,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,11),LINEVAR,"TOT")
"RTN","PSOERXC1",136,0)
 ..D SET^VALM10(LINE,LINEVAR,PATLOOP)
"RTN","PSOERXC1",137,0)
 S VALMCNT=LINE
"RTN","PSOERXC1",138,0)
 K ^TMP("CENTRIC",$J),^TMP("RDATE",$J),^TMP("PSOERXC1",$J)
"RTN","PSOERXC1",139,0)
 Q
"RTN","PSOERXC1",140,0)
CENTSRCH ;
"RTN","PSOERXC1",141,0)
 N RES,SVAL,I,DONE,SRCHARY
"RTN","PSOERXC1",142,0)
 D FULL^VALM1
"RTN","PSOERXC1",143,0)
 S DONE=0
"RTN","PSOERXC1",144,0)
 S VALMBCK="R",PSOC1RE=1
"RTN","PSOERXC1",145,0)
 F I=1:1 D  Q:DONE
"RTN","PSOERXC1",146,0)
 .S RES=$$DIR(,I,.SRCHARY)
"RTN","PSOERXC1",147,0)
 .I '+RES S DONE=1 Q
"RTN","PSOERXC1",148,0)
 .S SRCHARY(+RES)=$P(RES,U,2,99)
"RTN","PSOERXC1",149,0)
 .I $D(SRCHARY(3)) S DONE=1 Q
"RTN","PSOERXC1",150,0)
 I '$D(SRCHARY) S VALMBCK="R" Q
"RTN","PSOERXC1",151,0)
 I $G(SRCHARY(3))]"" D  Q
"RTN","PSOERXC1",152,0)
 .I '$D(^PS(52.49,"B",SRCHARY(3))) W !,"eRx could not be found." D DIRE^PSOERXX1 S VALMBCK="R" Q
"RTN","PSOERXC1",153,0)
 .S ERXIEN=$O(^PS(52.49,"B",SRCHARY(3),0))
"RTN","PSOERXC1",154,0)
 .;/BLB/ PSO*7.0*551 - BEGIN CHANGE - ADDING LOCK FUNCTIONALITY TO SEARCH FUNCTION AND BLOCKING SEARCHING BY ERX REF# INTO DIFFERENT DIVISION
"RTN","PSOERXC1",155,0)
 .I ERXIEN,$$GET1^DIQ(52.49,ERXIEN,24.1,"I")'=PSNPINST W !!,"eRx does not belong to this division.",! D DIRE^PSOERXX1 S VALMBCK="R" Q
"RTN","PSOERXC1",156,0)
 .S PATIEN=$$GET1^DIQ(52.49,ERXIEN,.04,"I") Q:'PATIEN
"RTN","PSOERXC1",157,0)
 .S ERXLOCK=$$L^PSOERX1A(PATIEN,1)
"RTN","PSOERXC1",158,0)
 .I 'ERXLOCK S DIR(0)="E" D ^DIR K DIR S VALMBCK="R" Q
"RTN","PSOERXC1",159,0)
 .D EN^PSOERX1(ERXIEN)
"RTN","PSOERXC1",160,0)
 .D UL^PSOERX1A(PATIEN)
"RTN","PSOERXC1",161,0)
 .S VALMBCK="R"
"RTN","PSOERXC1",162,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXC1",163,0)
 I $D(STYP) D EN(.SRCHARY,STYP) Q
"RTN","PSOERXC1",164,0)
 D EN(.SRCHARY)
"RTN","PSOERXC1",165,0)
 ;/BLB
"RTN","PSOERXC1",166,0)
 Q
"RTN","PSOERXC1",167,0)
CENTSORT ;
"RTN","PSOERXC1",168,0)
 N RES,STYP,SVAL
"RTN","PSOERXC1",169,0)
 D FULL^VALM1
"RTN","PSOERXC1",170,0)
 S VALMBCK="R",PSOC1RE=1
"RTN","PSOERXC1",171,0)
 S RES=$$DIR(1,0)
"RTN","PSOERXC1",172,0)
 I '+$P(RES,U) S VALMBCK="R" Q
"RTN","PSOERXC1",173,0)
 S STYP=$P(RES,U)
"RTN","PSOERXC1",174,0)
 I $D(SRCHARY) D EN(.SRCHARY,STYP) Q
"RTN","PSOERXC1",175,0)
 D EN(,STYP,PCVSTAT)
"RTN","PSOERXC1",176,0)
 Q
"RTN","PSOERXC1",177,0)
SBN ;NOTES: KEEPS UNLOCKING REGARDLESS OF THE USER COMING BACK FROM AN ACTUAL LOCK. MAY NEED TO CONSIDER A TAG THAT DETERMINES WHETHER OR NOT TO
"RTN","PSOERXC1",178,0)
 ;GO TO THE LOCK IN THE FIRST PLACE, OR RE-WRITE THE ENTIRE SBN FUNCTIONS.
"RTN","PSOERXC1",179,0)
 N Y,ERXPAT,PATIEN,ERXLOCK,SRCH
"RTN","PSOERXC1",180,0)
 D FULL^VALM1
"RTN","PSOERXC1",181,0)
 S Y=+$P(XQORNOD(0),"=",2)
"RTN","PSOERXC1",182,0)
 I 'Y S VALMBCK="R" Q
"RTN","PSOERXC1",183,0)
 S PATIEN=$O(@VALMAR@("IDX",Y,"")) Q:'PATIEN
"RTN","PSOERXC1",184,0)
 S ERXLOCK=$$L^PSOERX1A(PATIEN,1)
"RTN","PSOERXC1",185,0)
 I 'ERXLOCK S DIR(0)="E" D ^DIR K DIR S VALMBCK="R" Q
"RTN","PSOERXC1",186,0)
 S SRCH(1)=PATIEN D EN^PSOERX(.SRCH,,1)
"RTN","PSOERXC1",187,0)
 D UL^PSOERX1A(PATIEN)
"RTN","PSOERXC1",188,0)
 S VALMBCK="R"
"RTN","PSOERXC1",189,0)
 K %
"RTN","PSOERXC1",190,0)
 Q
"RTN","PSOERXC1",191,0)
PATDATA ;
"RTN","PSOERXC1",192,0)
 N DIR,Y,RESP,PATIEN,SRCH
"RTN","PSOERXC1",193,0)
 D FULL^VALM1
"RTN","PSOERXC1",194,0)
 S DIR(0)="N^"_VALMBG_":"_VALMLST_":0" D ^DIR
"RTN","PSOERXC1",195,0)
 I 'Y S VALMBCK="R" Q
"RTN","PSOERXC1",196,0)
 S RESP=Y
"RTN","PSOERXC1",197,0)
 S PATIEN=$O(@VALMAR@("IDX",RESP,"")) Q:'PATIEN 
"RTN","PSOERXC1",198,0)
 S ERXLOCK=$$L^PSOERX1A(PATIEN,1)
"RTN","PSOERXC1",199,0)
 I 'ERXLOCK S DIR(0)="E" D ^DIR K DIR S VALMBCK="R" Q
"RTN","PSOERXC1",200,0)
 S SRCH(1)=PATIEN D EN^PSOERX(.SRCH,,1)
"RTN","PSOERXC1",201,0)
 D UL^PSOERX1A(PATIEN)
"RTN","PSOERXC1",202,0)
 K %
"RTN","PSOERXC1",203,0)
 S VALMBCK="R"
"RTN","PSOERXC1",204,0)
 Q
"RTN","PSOERXC1",205,0)
DIR(SORT,CNT,SLIST) ;
"RTN","PSOERXC1",206,0)
 N DIR,Y,RLINE,STAG,SVAL
"RTN","PSOERXC1",207,0)
 K DIR
"RTN","PSOERXC1",208,0)
 S DIR(0)="SO^1:PATIENT NAME;2:DATE OF BIRTH"
"RTN","PSOERXC1",209,0)
 I '$D(SORT) S DIR(0)=DIR(0)_";3:ERX REFERENCE NUMBER"
"RTN","PSOERXC1",210,0)
 I CNT<2 S DIR("L")="Select one of the following "_$S($G(SORT):"sort",1:"search")_" criteria:"
"RTN","PSOERXC1",211,0)
 I CNT>1 D
"RTN","PSOERXC1",212,0)
 .S DIR("L")=""
"RTN","PSOERXC1",213,0)
 .S DIR("L",11)="Select another search criteria or '^' to exit. Press enter to use the currently"
"RTN","PSOERXC1",214,0)
 .S DIR("L",12)="selected search criteria."
"RTN","PSOERXC1",215,0)
 S DIR("L",2)=""
"RTN","PSOERXC1",216,0)
 S DIR("L",3)=" "_$S($D(SLIST(1)):"*",1:"")_"1.) PATIENT NAME"
"RTN","PSOERXC1",217,0)
 S DIR("L",4)=" "_$S($D(SLIST(2)):"*",1:"")_"2.) DATE OF BIRTH"
"RTN","PSOERXC1",218,0)
 I '$D(SORT) S DIR("L",5)=" "_$S($D(SLIST(3)):"*",1:"")_"3.) ERX REFERENCE NUMBER"
"RTN","PSOERXC1",219,0)
 S DIR("L",6)=""
"RTN","PSOERXC1",220,0)
 S DIR("L",7)=$S($D(SLIST):" * - indicates selected criteria.",1:"")
"RTN","PSOERXC1",221,0)
 D ^DIR K DIR Q:'Y 0
"RTN","PSOERXC1",222,0)
 S RES=Y I $G(SORT) Q RES
"RTN","PSOERXC1",223,0)
 S RLINE=$S(RES=1:"PAT",RES=2:"DOB",RES=3:"EREFNUM",1:"")
"RTN","PSOERXC1",224,0)
 I RLINE']"" Q 0
"RTN","PSOERXC1",225,0)
 S STAG=RLINE
"RTN","PSOERXC1",226,0)
 S SVAL=$$@STAG I SVAL="" Q 0
"RTN","PSOERXC1",227,0)
 Q RES_U_SVAL
"RTN","PSOERXC1",228,0)
PAT() ;
"RTN","PSOERXC1",229,0)
 N Y,DIC
"RTN","PSOERXC1",230,0)
 S DIC=52.46,DIC(0)="AEMQ" D ^DIC
"RTN","PSOERXC1",231,0)
 I Y<1 Q ""
"RTN","PSOERXC1",232,0)
 Q Y
"RTN","PSOERXC1",233,0)
DOB() ;
"RTN","PSOERXC1",234,0)
 N %DT,Y
"RTN","PSOERXC1",235,0)
 S %DT="A"
"RTN","PSOERXC1",236,0)
 S %DT("A")="Enter the Date of Birth (DOB): "
"RTN","PSOERXC1",237,0)
 D ^%DT
"RTN","PSOERXC1",238,0)
 I Y<1 Q ""
"RTN","PSOERXC1",239,0)
 Q Y
"RTN","PSOERXC1",240,0)
EREFNUM() ;
"RTN","PSOERXC1",241,0)
 N DIR,Y
"RTN","PSOERXC1",242,0)
 S DIR(0)="FO",DIR("A")="Enter the eRx Reference number" D ^DIR
"RTN","PSOERXC1",243,0)
 I Y=""!(Y="^") Q ""
"RTN","PSOERXC1",244,0)
 Q $$UP^XLFSTR(Y)
"RTN","PSOERXC1",245,0)
BLDITEM(IEN,PATCNT,STAT) ;
"RTN","PSOERXC1",246,0)
 N PATIEN,DOB,ERXSTAT,ERXESTAT,ESCODE
"RTN","PSOERXC1",247,0)
 S ERXSTAT=$$GET1^DIQ(52.49,ERXIEN,1,"I")
"RTN","PSOERXC1",248,0)
 S ERXESTAT=$$GET1^DIQ(52.49,ERXIEN,1,"E")
"RTN","PSOERXC1",249,0)
 S ESCODE=","_$S($E(ERXESTAT)="H":$E(ERXESTAT),1:ERXESTAT)_"," I ",RXN,RXW,RXD,RXF,CAO,CAR,CAH,CAP,CAX,CAF,N,I,W,H,"'[ESCODE Q
"RTN","PSOERXC1",250,0)
 I $G(STAT)]"" Q:'$$CHKSTAT(STAT,ERXESTAT,ERXSTAT)
"RTN","PSOERXC1",251,0)
 S PATIEN=$$GET1^DIQ(52.49,ERXIEN,.04,"I") Q:'PATIEN
"RTN","PSOERXC1",252,0)
 I $D(SRCH(1)),PATIEN'=$P($G(SRCH(1)),U) Q
"RTN","PSOERXC1",253,0)
 S DOB=$$GET1^DIQ(52.46,PATIEN,.08,"I")
"RTN","PSOERXC1",254,0)
 I $D(SRCH(2)),DOB'=$G(SRCH(2)) Q
"RTN","PSOERXC1",255,0)
 I $D(^TMP("CENTRIC",$J,PATIEN)) Q
"RTN","PSOERXC1",256,0)
 S ^TMP("CENTRIC",$J,PATIEN)="",PATCNT=$G(PATCNT)+1
"RTN","PSOERXC1",257,0)
 Q
"RTN","PSOERXC1",258,0)
CHKSTAT(FILSTAT,ERXSTAT,ERXISTAT) ;
"RTN","PSOERXC1",259,0)
 N RET
"RTN","PSOERXC1",260,0)
 S RET=0
"RTN","PSOERXC1",261,0)
 I $G(FILSTAT)="CCR",ERXSTAT'="RXN",ERXSTAT'="RXW",ERXSTAT'="RXD",ERXSTAT'="RXF",ERXSTAT'="CAO",ERXSTAT'="CAR",ERXSTAT'="CAH",ERXSTAT'="CAP",ERXSTAT'="CAX",ERXSTAT'="CAF" Q RET
"RTN","PSOERXC1",262,0)
 I $G(FILSTAT)="AH",$E(ERXSTAT)'="H" Q RET
"RTN","PSOERXC1",263,0)
 I $G(FILSTAT)'="A",$G(FILSTAT)'="CCR",$G(FILSTAT)'="AH",FILSTAT'=ERXISTAT Q RET
"RTN","PSOERXC1",264,0)
 Q 1
"RTN","PSOERXC1",265,0)
EX ; early exit logic
"RTN","PSOERXC1",266,0)
 K PSOSRCH,PSOSRT,SRCH,SORTT,PSOPRMPT
"RTN","PSOERXC1",267,0)
 S PSOC1RE=1
"RTN","PSOERXC1",268,0)
 D EX^PSOORFI1
"RTN","PSOERXC1",269,0)
 Q
"RTN","PSOERXC1",270,0)
HELP ; -- help code
"RTN","PSOERXC1",271,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERXC1",272,0)
 Q
"RTN","PSOERXC1",273,0)
 ;
"RTN","PSOERXC1",274,0)
EXIT ; -- exit code
"RTN","PSOERXC1",275,0)
 K PSOPRMPT,@VALMAR
"RTN","PSOERXC1",276,0)
 S PSOC1RE=1
"RTN","PSOERXC1",277,0)
 Q
"RTN","PSOERXC1",278,0)
 ;
"RTN","PSOERXC1",279,0)
EXPND ; -- expand code
"RTN","PSOERXC1",280,0)
 Q
"RTN","PSOERXD1")
0^5^B131924629^B127051416
"RTN","PSOERXD1",1,0)
PSOERXD1 ;ALB/BWF - eRx Drug display/actions ; 8/3/2016 5:14pm
"RTN","PSOERXD1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,551**;DEC 1997;Build 37
"RTN","PSOERXD1",3,0)
 ;
"RTN","PSOERXD1",4,0)
EN ; -- main entry point for PSO ERX HOLDING QUEUE
"RTN","PSOERXD1",5,0)
 D EN^VALM("PSO ERX DRUG VALIDATION")
"RTN","PSOERXD1",6,0)
 Q
"RTN","PSOERXD1",7,0)
 ;
"RTN","PSOERXD1",8,0)
HDR ; -- header code
"RTN","PSOERXD1",9,0)
 S VALMHDR(1)="eRx Patient: "_$$GET1^DIQ(52.49,PSOIEN,.04,"E")
"RTN","PSOERXD1",10,0)
 S VALMHDR(2)="eRx Reference #: "_$$GET1^DIQ(52.49,PSOIEN,.01,"E")
"RTN","PSOERXD1",11,0)
 I $G(VALMBCK)="R" D INIT
"RTN","PSOERXD1",12,0)
 Q
"RTN","PSOERXD1",13,0)
 ;
"RTN","PSOERXD1",14,0)
INIT ;
"RTN","PSOERXD1",15,0)
 Q:'$G(PSOIEN)
"RTN","PSOERXD1",16,0)
 N LINE,ERXDRG,LINETXT,ERXQTY,ERXQQ,ERXDF,ERXSC,ERXRFLS,ERXDS,ERXDT,ERXDW,ERXDSUB,VADRG,NXTLINE,ORDITEM
"RTN","PSOERXD1",17,0)
 N ERXCOMM,ERXDRUG,ERXSIG,FILLDT,ISSDT,MAILWIN,PATSTAT,SGLOOP,SIGDATA,SIGLINE,SIGLOOP,VACLIN,VACOPIES,VADAYS
"RTN","PSOERXD1",18,0)
 N VADOSE,VADRGIEN,VAENBY,VAENDATE,VAPINST,VAPROV,VAPUS,VAQTY,VAREF,VAREMARK,VAROUTE,VASCHED,VASIG,VAVERB
"RTN","PSOERXD1",19,0)
 N PSODAT,PSONEW,SIGDATA,SGLOOP,PRVCARY,PCRFST,PCLOOP,INSTARY,IFRST,INLOOP,SEPLN,PATINST,PIARY,PILOOP
"RTN","PSOERXD1",20,0)
 N SFIRST,SIGARY,PSOIENS,PSODAT2,PFRST,FN,FSSIG,INST,PATIEN,PCFRST,PRVCOMM,PSODFN,SLOOP,ERXDIR,MANVAL
"RTN","PSOERXD1",21,0)
 N VASIG,VASARY,VALBY,VALDTTM,NFIRST,NLOOP,ERXNARY,DIE,DA,DR,INLOOP,ERXNOTE,PUC,DRGARY,DLP,X,Y,DINUM,DFN
"RTN","PSOERXD1",22,0)
 S LINE=0
"RTN","PSOERXD1",23,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERXD1",24,0)
 S FN=52.49
"RTN","PSOERXD1",25,0)
 D GETS^DIQ(52.49,PSOIEN,"**","IE","PSODAT")
"RTN","PSOERXD1",26,0)
 S PATIEN=$G(PSODAT(FN,PSOIENS,.05,"I"))
"RTN","PSOERXD1",27,0)
 ; stub entry in file 55 if it doesn't exist
"RTN","PSOERXD1",28,0)
 I $G(PATIEN) D
"RTN","PSOERXD1",29,0)
 .Q:$D(^PS(55,PATIEN,0))
"RTN","PSOERXD1",30,0)
 .S DIC="^PS(55,",DLAYGO=55
"RTN","PSOERXD1",31,0)
 .K DD,DO S DIC(0)="L",(DINUM,X)=PATIEN D FILE^DICN D:Y<1  K DIC,DA,DR,DD,DO,DLAYGO
"RTN","PSOERXD1",32,0)
 ..S $P(^PS(55,PATIEN,0),"^")=PATIEN K DIK,DA S DA=PATIEN,DIK="^PS(55,",DIK(1)=.01 D EN^DIK K DIK,DA
"RTN","PSOERXD1",33,0)
 S ERXDRUG=$G(PSODAT(FN,PSOIENS,3.1,"E"))
"RTN","PSOERXD1",34,0)
 ; quantity
"RTN","PSOERXD1",35,0)
 S ERXQTY=$G(PSODAT(FN,PSOIENS,5.1,"E"))
"RTN","PSOERXD1",36,0)
 ; quantity qualifier
"RTN","PSOERXD1",37,0)
 S ERXQQ=$G(PSODAT(FN,PSOIENS,5.2,"E"))
"RTN","PSOERXD1",38,0)
 ; drug form code
"RTN","PSOERXD1",39,0)
 S ERXDF=$G(PSODAT(FN,PSOIENS,41,"E"))
"RTN","PSOERXD1",40,0)
 ; strength code
"RTN","PSOERXD1",41,0)
 S ERXSC=$G(PSODAT(FN,PSOIENS,43,"E"))
"RTN","PSOERXD1",42,0)
 ; refills
"RTN","PSOERXD1",43,0)
 S ERXRFLS=$G(PSODAT(FN,PSOIENS,5.6,"E"))
"RTN","PSOERXD1",44,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXD1",45,0)
 I ERXRFLS="" D
"RTN","PSOERXD1",46,0)
 .S ERXRFLS=$G(PSODAT(FN,PSOIENS,5.7,"I"))
"RTN","PSOERXD1",47,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXD1",48,0)
 ; days supply
"RTN","PSOERXD1",49,0)
 S ERXDS=$G(PSODAT(FN,PSOIENS,5.5,"E"))
"RTN","PSOERXD1",50,0)
 ; erx date
"RTN","PSOERXD1",51,0)
 S ERXDT=$G(PSODAT(FN,PSOIENS,.03,"E"))
"RTN","PSOERXD1",52,0)
 ; written date
"RTN","PSOERXD1",53,0)
 S ERXDW=$G(PSODAT(FN,PSOIENS,5.9,"E"))
"RTN","PSOERXD1",54,0)
 ; substitutions
"RTN","PSOERXD1",55,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE - ADDING SUBSTITUTION DISPLAY
"RTN","PSOERXD1",56,0)
 S ERXDSUB=$G(PSODAT(FN,PSOIENS,5.8,"I"))
"RTN","PSOERXD1",57,0)
 S ERXDSUB=$S(ERXDSUB=1:"NO",ERXDSUB=0:"YES",1:"")
"RTN","PSOERXD1",58,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXD1",59,0)
 ; va (matched) drug
"RTN","PSOERXD1",60,0)
 S ERXDIR=$G(PSODAT(FN,PSOIENS,7,"E"))
"RTN","PSOERXD1",61,0)
 S VADRG=$G(PSODAT(FN,PSOIENS,3.2,"E"))
"RTN","PSOERXD1",62,0)
 I VADRG']"" S VADRG="NOT LINKED"
"RTN","PSOERXD1",63,0)
 S PUC=$G(PSODAT(FN,PSOIENS,42,"E"))
"RTN","PSOERXD1",64,0)
 D TXT2ARY(.DRGARY,ERXDRUG,,70)
"RTN","PSOERXD1",65,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"eRx Drug: "_$G(DRGARY(1)))
"RTN","PSOERXD1",66,0)
 S DLP=1
"RTN","PSOERXD1",67,0)
 F  S DLP=$O(DRGARY(DLP)) Q:'DLP  D
"RTN","PSOERXD1",68,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"          "_$G(DRGARY(DLP)))
"RTN","PSOERXD1",69,0)
 S LINE=LINE+1
"RTN","PSOERXD1",70,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Qty: ",ERXQTY,1,26)
"RTN","PSOERXD1",71,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Days Supply: ",ERXDS,28,26)
"RTN","PSOERXD1",72,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Date Written: ",$P(ERXDW,"@"),54,26)
"RTN","PSOERXD1",73,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",74,0)
 S LINE=LINE+1
"RTN","PSOERXD1",75,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE -CORRECTING QTY QUAL TO CODE LIST QUAL
"RTN","PSOERXD1",76,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Code List Qualifier: "_ERXQQ)
"RTN","PSOERXD1",77,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE - 
"RTN","PSOERXD1",78,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Drug Form: "_ERXDF)
"RTN","PSOERXD1",79,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Strength: "_ERXSC)
"RTN","PSOERXD1",80,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Potency Unit Code: "_PUC)
"RTN","PSOERXD1",81,0)
 S LINE=LINE+1
"RTN","PSOERXD1",82,0)
 S LINE=LINE+1
"RTN","PSOERXD1",83,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Refills: ",ERXRFLS,1,15)
"RTN","PSOERXD1",84,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE - CHANGED TEXT FROM "DO NOT SUB" TO "SUBSTITUTIONS? :"
"RTN","PSOERXD1",85,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Substitutions? : ",ERXDSUB,28,50)
"RTN","PSOERXD1",86,0)
 ;/BLB PSO*7.0*551
"RTN","PSOERXD1",87,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",88,0)
 S SIGDATA=""
"RTN","PSOERXD1",89,0)
 D TXT2ARY(.SIGARY,ERXDIR,,70)
"RTN","PSOERXD1",90,0)
 S SFIRST=$O(SIGARY(0))
"RTN","PSOERXD1",91,0)
 S SGLOOP=0 F  S SGLOOP=$O(SIGARY(SGLOOP)) Q:'SGLOOP  D
"RTN","PSOERXD1",92,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,$S(SGLOOP=SFIRST:"eRx Sig: ",1:"         ")_$G(SIGARY(SGLOOP)))
"RTN","PSOERXD1",93,0)
 S ERXNOTE=$G(PSODAT(FN,PSOIENS,8,"E"))
"RTN","PSOERXD1",94,0)
 D TXT2ARY(.ERXNARY,ERXNOTE,,65)
"RTN","PSOERXD1",95,0)
 S NFIRST=$O(ERXNARY(0))
"RTN","PSOERXD1",96,0)
 S NLOOP=0 F  S NLOOP=$O(ERXNARY(NLOOP)) Q:'NLOOP  D
"RTN","PSOERXD1",97,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,$S(NLOOP=NFIRST:"eRx Notes: ",1:"           ")_$G(ERXNARY(NLOOP)))
"RTN","PSOERXD1",98,0)
 S DFN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXD1",99,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXD1",100,0)
 S $P(SEPLN,"-",80)="-" D SET^VALM10(LINE,SEPLN)
"RTN","PSOERXD1",101,0)
 ; vista drug information
"RTN","PSOERXD1",102,0)
 S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.5,"I")
"RTN","PSOERXD1",103,0)
 S VALBY=$$GET1^DIQ(52.49,PSOIEN,1.11,"E")
"RTN","PSOERXD1",104,0)
 S VALDTTM=$$GET1^DIQ(52.49,PSOIEN,1.12,"E")
"RTN","PSOERXD1",105,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Status: "_$S(MANVAL:"VALIDATED ("_VALBY_" - "_VALDTTM_")",1:"NOT VALIDATED"))
"RTN","PSOERXD1",106,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXD1",107,0)
 I $$GET1^DIQ(52.49,PSOIEN,.05,"I") D
"RTN","PSOERXD1",108,0)
 .D ALG^PSOERXU1(.LINE)
"RTN","PSOERXD1",109,0)
 ;/BLB/ PSO*7.0*520
"RTN","PSOERXD1",110,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXD1",111,0)
 S VADRGIEN=$G(PSODAT(52.49,PSOIENS,3.2,"I"))
"RTN","PSOERXD1",112,0)
 S VADRG=$S(VADRGIEN:$$GET1^DIQ(50,VADRGIEN,.01,"E"),1:"NOT MATCHED")
"RTN","PSOERXD1",113,0)
 S LINE=LINE+1 D SET^VALM10(LINE," (1) Vista Drug: "_VADRG)
"RTN","PSOERXD1",114,0)
 ; may not need clinic or remarks.
"RTN","PSOERXD1",115,0)
 S (VACLIN,VAREMARK)=""
"RTN","PSOERXD1",116,0)
 S VAPROV=$G(PSODAT(52.49,PSOIENS,2.3,"E"))
"RTN","PSOERXD1",117,0)
 S INST=$G(PSODAT(52.49,PSOIENS,26,"E"))
"RTN","PSOERXD1",118,0)
 ; if erx user comments exist, should we display them separately from the erx provider directions?
"RTN","PSOERXD1",119,0)
 I $D(PSODAT(52.49,PSOIENS,30)) S PRVCOMM=$G(PSODAT(52.49,PSOIENS,30,"E"))
"RTN","PSOERXD1",120,0)
 I '$L($G(PRVCOMM)) S PRVCOMM=$G(PSODAT(52.49,PSOIENS,8,"E"))
"RTN","PSOERXD1",121,0)
 S VADAYS=$G(PSODAT(52.49,PSOIENS,20.2,"E"))
"RTN","PSOERXD1",122,0)
 S VAQTY=$G(PSODAT(52.49,PSOIENS,20.1,"E"))
"RTN","PSOERXD1",123,0)
 S VAVERB=$G(PSODAT(52.49,PSOIENS,20.3,"E"))
"RTN","PSOERXD1",124,0)
 S PATSTAT=$$GET1^DIQ(55,PATIEN,3,"E")
"RTN","PSOERXD1",125,0)
 S MAILWIN=$G(PSODAT(52.49,PSOIENS,20.4,"E")) I MAILWIN="" S DIE="^PS(52.49,",DA=PSOIEN,DR="20.4///W" D ^DIE K DIE
"RTN","PSOERXD1",126,0)
 S VAREF=$G(PSODAT(52.49,PSOIENS,20.5,"E"))
"RTN","PSOERXD1",127,0)
 S PATINST=$G(PSODAT(52.49,PSOIENS,27,"E"))
"RTN","PSOERXD1",128,0)
 S PATINST=$$LSIG^PSOQUTIL(PATINST)
"RTN","PSOERXD1",129,0)
 ; testing instruction building
"RTN","PSOERXD1",130,0)
 ; end testing
"RTN","PSOERXD1",131,0)
 S VACLIN=$G(PSODAT(52.49,PSOIENS,20.6,"E")) I VACLIN="" S DIE="^PS(52.49,",DA=PSOIEN,DR="20.6///"_$$GET1^DIQ(59,PSOSITE,10,"I") D ^DIE K DIE
"RTN","PSOERXD1",132,0)
 D TXT2ARY(.PIARY,PATINST,,55)
"RTN","PSOERXD1",133,0)
 D DOSE
"RTN","PSOERXD1",134,0)
 ; pat instructions built from dosage multiple
"RTN","PSOERXD1",135,0)
 S PFRST="",PFRST=$O(PIARY(0)) I 'PFRST S PFRST=0
"RTN","PSOERXD1",136,0)
 S LINE=LINE+1 D SET^VALM10(LINE," (3) Pat Instructions: "_$G(PIARY(PFRST)))
"RTN","PSOERXD1",137,0)
 S PILOOP=PFRST F  S PILOOP=$O(PIARY(PILOOP)) Q:'PILOOP  D
"RTN","PSOERXD1",138,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"                       "_$G(PIARY(PILOOP)))
"RTN","PSOERXD1",139,0)
 ; provider comments come from the 'notes' field in 52.49 (#8)
"RTN","PSOERXD1",140,0)
 D TXT2ARY(.PRVCARY,PRVCOMM,,57)
"RTN","PSOERXD1",141,0)
 S PCFRST=$O(PRVCARY(0))
"RTN","PSOERXD1",142,0)
 S PCLOOP=0 F  S PCLOOP=$O(PRVCARY(PCLOOP)) Q:'PCLOOP  D
"RTN","PSOERXD1",143,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,$S(PCFRST=PCLOOP:" (4) Provider Comments: ",1:"                        ")_PRVCARY(PCLOOP))
"RTN","PSOERXD1",144,0)
 ; instructions are the unaltered SIG.
"RTN","PSOERXD1",145,0)
 ; if the instructions are longer than 57, convert to array for display
"RTN","PSOERXD1",146,0)
 S VASIG=""
"RTN","PSOERXD1",147,0)
 S SLOOP=0 F  S SLOOP=$O(^PS(52.49,PSOIEN,"SIG",SLOOP)) Q:'SLOOP  D
"RTN","PSOERXD1",148,0)
 .I '$L($G(VASIG)) S VASIG=$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0)) Q
"RTN","PSOERXD1",149,0)
 .S VASIG=$G(VASIG)_" "_$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0))
"RTN","PSOERXD1",150,0)
 S INLOOP=0 F  S INLOOP=$O(PSODAT(52.49,PSOIENS,31,INLOOP)) Q:'INLOOP  D
"RTN","PSOERXD1",151,0)
 .I '$L(INST) S INST=$G(PSODAT(52.49,PSOIENS,31,INLOOP)) Q
"RTN","PSOERXD1",152,0)
 .S INST=INST_" "_$G(PSODAT(52.49,PSOIENS,31,INLOOP))
"RTN","PSOERXD1",153,0)
 D TXT2ARY(.INSTARY,INST,,57)
"RTN","PSOERXD1",154,0)
 S IFRST=$O(INSTARY(0))
"RTN","PSOERXD1",155,0)
 S INLOOP=0 F  S INLOOP=$O(INSTARY(INLOOP)) Q:'INLOOP  D
"RTN","PSOERXD1",156,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,$S(IFRST=INLOOP:"          Instructions: ",1:"                        ")_$G(INSTARY(INLOOP)))
"RTN","PSOERXD1",157,0)
 S VASIG=VASIG_" "_PATINST_PRVCOMM
"RTN","PSOERXD1",158,0)
 D TXT2ARY(.VASARY,VASIG,,55)
"RTN","PSOERXD1",159,0)
 S FSSIG=$O(VASARY(0))
"RTN","PSOERXD1",160,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"                   SIG: "_$S(FSSIG:$G(VASARY(FSSIG)),1:""))
"RTN","PSOERXD1",161,0)
 S SLOOP=1 F  S SLOOP=$O(VASARY(SLOOP)) Q:'SLOOP  D
"RTN","PSOERXD1",162,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"                        "_VASARY(SLOOP))
"RTN","PSOERXD1",163,0)
 S LINETXT=""
"RTN","PSOERXD1",164,0)
 S LINE=LINE+1 D SET^VALM10(LINE," (5) Patient Status: "_PATSTAT)
"RTN","PSOERXD1",165,0)
 S LINE=LINE+1
"RTN","PSOERXD1",166,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE - CHANGING ORDER OF QTY AND DAYS SUPPLY
"RTN","PSOERXD1",167,0)
 D ADDITEM^PSOERX1A(.LINETXT," (6) QTY: ",VAQTY,1,25)
"RTN","PSOERXD1",168,0)
 D ADDITEM^PSOERX1A(.LINETXT,"     (7) Days Supply: ",VADAYS,40,30)
"RTN","PSOERXD1",169,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXD1",170,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",171,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"    Provider ordered '"_$S($L(ERXRFLS):ERXRFLS,1:0)_"' refills")
"RTN","PSOERXD1",172,0)
 S LINE=LINE+1
"RTN","PSOERXD1",173,0)
 D ADDITEM^PSOERX1A(.LINETXT," (8) # of Refills: ",VAREF,1,30)
"RTN","PSOERXD1",174,0)
 ; routing defaults to 'M'ail
"RTN","PSOERXD1",175,0)
 D ADDITEM^PSOERX1A(.LINETXT,"(9) Routing: ",MAILWIN,45,25)
"RTN","PSOERXD1",176,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",177,0)
 S LINE=LINE+1 D SET^VALM10(LINE," (10)    Clinic: "_VACLIN)
"RTN","PSOERXD1",178,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"       Provider: "_VAPROV)
"RTN","PSOERXD1",179,0)
 S VALMCNT=LINE
"RTN","PSOERXD1",180,0)
 S EDTYP="D"
"RTN","PSOERXD1",181,0)
 K PSODAT,PSONEW,DOENT,TDUR
"RTN","PSOERXD1",182,0)
 Q
"RTN","PSOERXD1",183,0)
 ;
"RTN","PSOERXD1",184,0)
HELP ; -- help code
"RTN","PSOERXD1",185,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERXD1",186,0)
 Q
"RTN","PSOERXD1",187,0)
 ;
"RTN","PSOERXD1",188,0)
EXIT ; -- exit code
"RTN","PSOERXD1",189,0)
 K @VALMAR,EDTYP
"RTN","PSOERXD1",190,0)
 Q
"RTN","PSOERXD1",191,0)
 ;
"RTN","PSOERXD1",192,0)
EXPND ; -- expand code
"RTN","PSOERXD1",193,0)
 Q
"RTN","PSOERXD1",194,0)
 ; ARY - array to store the output (pass by reference)
"RTN","PSOERXD1",195,0)
 ; TEXT - the text to convert into the array format
"RTN","PSOERXD1",196,0)
 ; DELIM - delimiter for text (default is space)
"RTN","PSOERXD1",197,0)
 ; MAXLEN - maximum length of each array items text, defaults to 80
"RTN","PSOERXD1",198,0)
TXT2ARY(ARY,TEXT,DELIM,MAXLEN) ;
"RTN","PSOERXD1",199,0)
 N WORD,I,LCNT,LINETXT,S
"RTN","PSOERXD1",200,0)
 S S=$S($D(DELIM):DELIM,1:" ")
"RTN","PSOERXD1",201,0)
 I '$G(MAXLEN) S MAXLEN=80
"RTN","PSOERXD1",202,0)
 S LCNT=1,LINETXT=""
"RTN","PSOERXD1",203,0)
 F I=1:1:$L(TEXT,S) D
"RTN","PSOERXD1",204,0)
 .S WORD=$P(TEXT,S,I)
"RTN","PSOERXD1",205,0)
 .I $L(LINETXT)+$L(S)+$L(WORD)>MAXLEN D  Q
"RTN","PSOERXD1",206,0)
 ..S ARY(LCNT)=LINETXT
"RTN","PSOERXD1",207,0)
 ..S LCNT=LCNT+1,LINETXT=WORD
"RTN","PSOERXD1",208,0)
 .I '$L(LINETXT) S LINETXT=WORD Q
"RTN","PSOERXD1",209,0)
 .S LINETXT=LINETXT_S_WORD
"RTN","PSOERXD1",210,0)
 ; if there is information left, set it into the array
"RTN","PSOERXD1",211,0)
 I $L(LINETXT) S ARY(LCNT)=$G(LINETXT)
"RTN","PSOERXD1",212,0)
 Q
"RTN","PSOERXD1",213,0)
DOSE ;displays dosing info for pending orders.  called from psoorfi1
"RTN","PSOERXD1",214,0)
 K II,UNITS S DS=1
"RTN","PSOERXD1",215,0)
 I '$O(^PS(52.49,PSOIEN,21,0)) S LINE=LINE+1,LINETXT="" D ADDITEM^PSOERX1A(.LINETXT," (2)          *Dosage:",,1,30) D SET^VALM10(LINE,LINETXT) S LINETXT="" G DOSEX
"RTN","PSOERXD1",216,0)
 F I=0:0 S I=$O(^PS(52.49,PSOIEN,21,I)) Q:'I  S DOSE=$G(^PS(52.49,PSOIEN,21,I,1)),DOSE1=$G(^(2)) D  D DOSE1
"RTN","PSOERXD1",217,0)
 .S II=$G(II)+1 K PSONEW("UNITS",II)
"RTN","PSOERXD1",218,0)
 .S PSONEW("DOSE",II)=$P(DOSE1,"^"),PSONEW("DOSE ORDERED",II)=$P(DOSE1,"^",2),PSONEW("UNITS",II)=$P(DOSE,"^",9),PSONEW("NOUN",II)=$P(DOSE,"^",5)
"RTN","PSOERXD1",219,0)
 .S:$P(DOSE,"^",9) UNITS=$P(^PS(50.607,$P(DOSE,"^",9),0),"^")
"RTN","PSOERXD1",220,0)
 .S PSONEW("VERB",II)=$P(DOSE,"^",10),PSONEW("ROUTE",II)=$P(DOSE,"^",8)
"RTN","PSOERXD1",221,0)
 .S ROUTE="" S:$P(DOSE,"^",8) ROUTE=$P(^PS(51.2,$P(DOSE,"^",8),0),"^")
"RTN","PSOERXD1",222,0)
 .S PSONEW("SCHEDULE",II)=$P(DOSE,"^"),PSONEW("DURATION",II)=$P(DOSE,"^",2)
"RTN","PSOERXD1",223,0)
 .S DOENT=$G(DOENT)+1 I $P(DOSE,"^",6)]"" S PSONEW("CONJUNCTION",II)=$S($P(DOSE,"^",6)="S":"T",$P(DOSE,"^",6)="X":"X",1:"A")
"RTN","PSOERXD1",224,0)
 .I 'PSONEW("DOSE ORDERED",II),$G(PSONEW("VERB",II))]"" D
"RTN","PSOERXD1",225,0)
 ..S LINETXT="" S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"               Verb: ",$G(PSONEW("VERB",II)),1,40)
"RTN","PSOERXD1",226,0)
 ..D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",227,0)
 .S:$G(DS) LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT," (2)","",1,5)
"RTN","PSOERXD1",228,0)
DOSEX S PSONEW("ENT")=+$G(II) K DOSE,DOSE1,II,I,UNITS,ROUTE,DG
"RTN","PSOERXD1",229,0)
 Q
"RTN","PSOERXD1",230,0)
DOSE1 ;
"RTN","PSOERXD1",231,0)
 I $G(DS)=1 D ADDITEM^PSOERX1A(.LINETXT,"        *Dosage:","",4,30) D FMD G DU
"RTN","PSOERXD1",232,0)
 S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"            *Dosage:","",1,30) D FMD
"RTN","PSOERXD1",233,0)
DU ;
"RTN","PSOERXD1",234,0)
 S PSODFN=$O(^PS(55,"B",PATIEN,0))
"RTN","PSOERXD1",235,0)
 I 'PSONEW("DOSE ORDERED",I),$P($G(^PS(55,PSODFN,"LAN")),"^") D
"RTN","PSOERXD1",236,0)
 .S LINE=LINE+1,LINETXT="" D ADDITEM^PSOERX1A(.LINETXT,"  Oth. Lang. Dosage: ",$G(PSONEW("ODOSE",I)),1,50) D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",237,0)
 I PSONEW("DOSE ORDERED",II),$G(PSONEW("VERB",II))]"" D
"RTN","PSOERXD1",238,0)
 .S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"               Verb: ",$G(PSONEW("VERB",II)),1,50) D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",239,0)
 .S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"     Dispense Units: ",$S($E(PSONEW("DOSE ORDERED",II),1)=".":"0",1:"")_PSONEW("DOSE ORDERED",II),1,50) D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",240,0)
 I PSONEW("NOUN",II)]"" D
"RTN","PSOERXD1",241,0)
 .S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"               Noun: ",PSONEW("NOUN",II),1,50) D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",242,0)
 I $G(ROUTE)]"" D
"RTN","PSOERXD1",243,0)
 .S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"             *Route: ",$G(ROUTE),1,50) D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",244,0)
 S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"          *Schedule: ",PSONEW("SCHEDULE",II),1,50) D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",245,0)
 I $G(PSONEW("DURATION",II))]"" D
"RTN","PSOERXD1",246,0)
 .S PSONEW("DURATION",II)=$S($E(PSONEW("DURATION",II),1)'?.N:$E(PSONEW("DURATION",II),2,99)_$E(PSONEW("DURATION",II),1),1:PSONEW("DURATION",II))
"RTN","PSOERXD1",247,0)
 .S TDUR=PSONEW("DURATION",II)_" ("_$S(PSONEW("DURATION",II)["M":"MINUTES",PSONEW("DURATION",II)["H":"HOURS",PSONEW("DURATION",II)["L":"MONTHS",PSONEW("DURATION",II)["W":"WEEKS",1:"DAYS")_")"
"RTN","PSOERXD1",248,0)
 .S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"          *Duration: ",TDUR,1,50) D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",249,0)
 I $G(PSONEW("CONJUNCTION",II))]"" D
"RTN","PSOERXD1",250,0)
 .S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT,"       *Conjunction: ",$S(PSONEW("CONJUNCTION",II)="T":"THEN",PSONEW("CONJUNCTION",II)="X":"EXCEPT",1:"AND"),1,50) D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",251,0)
 Q
"RTN","PSOERXD1",252,0)
FMD ;
"RTN","PSOERXD1",253,0)
 Q:$G(PSONEW("DOSE",II))']""  S MIG=PSONEW("DOSE",II)
"RTN","PSOERXD1",254,0)
 I $E(MIG,1)=".",$G(PSONEW("DOSE ORDERED",II)) S MIG="0"_MIG
"RTN","PSOERXD1",255,0)
 F SG=1:1:$L(MIG," ") D
"RTN","PSOERXD1",256,0)
 .I $L(LINETXT_" "_$P(MIG," ",SG))>80 D  Q
"RTN","PSOERXD1",257,0)
 ..S LINE=LINE+1 D ADDITEM^PSOERX1A(.LINETXT," ","",20,1)
"RTN","PSOERXD1",258,0)
 ..D ADDITEM^PSOERX1A(.LINETXT," ",$P(MIG," ",SG),$L(LINETXT),$L($P(MIG," ",SG))+1)
"RTN","PSOERXD1",259,0)
 .D ADDITEM^PSOERX1A(.LINETXT," ",$P(MIG," ",SG),$L(LINETXT),$L($P(MIG," ",SG))+1)
"RTN","PSOERXD1",260,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",261,0)
 I $G(UNITS)]"" D
"RTN","PSOERXD1",262,0)
 .I $L(LINETXT_" ("_UNITS_")")>80 D  Q
"RTN","PSOERXD1",263,0)
 ..S LINE=LINE+1,LINETXT=""
"RTN","PSOERXD1",264,0)
 ..D ADDITEM^PSOERX1A(.LINETXT," ","",20,1)
"RTN","PSOERXD1",265,0)
 ..D ADDITEM^PSOERX1A(.LINETXT," ("_UNITS_")",22,50)
"RTN","PSOERXD1",266,0)
 ..D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXD1",267,0)
 K DS,MIG,SG
"RTN","PSOERXD1",268,0)
 ; Consider invoking this as a future enhancement.
"RTN","PSOERXD1",269,0)
 ;I '$G(PSONEW("DOSE ORDERED",II)),$P($G(^PS(55,PSODFN,"LAN")),"^") D LAN^PSOORED5
"RTN","PSOERXD1",270,0)
 Q
"RTN","PSOERXD2")
0^6^B183875290^B182647633
"RTN","PSOERXD2",1,0)
PSOERXD2 ;ALB/BWF - eRx Drug edit actions ; 5/26/2017 9:57am
"RTN","PSOERXD2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,506,520,508,551**;DEC 1997;Build 37
"RTN","PSOERXD2",3,0)
 ;
"RTN","PSOERXD2",4,0)
 Q
"RTN","PSOERXD2",5,0)
SBN ;
"RTN","PSOERXD2",6,0)
 N Y,ERXIEN
"RTN","PSOERXD2",7,0)
 S Y=$P(XQORNOD(0),"=",2)
"RTN","PSOERXD2",8,0)
 I Y']"" S VALMBCK="R" Q
"RTN","PSOERXD2",9,0)
 D EDIT^PSOERX1A("D",Y)
"RTN","PSOERXD2",10,0)
 S VALMBCK="R"
"RTN","PSOERXD2",11,0)
 Q
"RTN","PSOERXD2",12,0)
VDRG1(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",13,0)
 N VANDRG,VAODRG,DIE,DA,DR,AUTOVAL,DIC,Y,QTLOOP,SELDRG,VDRG,VANDRG,VAOI,PATINST,FIELD,MTYPE
"RTN","PSOERXD2",14,0)
 Q:'$G(PSOIEN)
"RTN","PSOERXD2",15,0)
 S VAODRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I")
"RTN","PSOERXD2",16,0)
 S AUTOVAL=$$GET1^DIQ(52.49,PSOIEN,1.4,"I")
"RTN","PSOERXD2",17,0)
 S MTYPE=$$GET1^DIQ(52.49,PSOIEN,.08,"I")
"RTN","PSOERXD2",18,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE - CHANGING DEFAULT PROMPT TO "EDIT"
"RTN","PSOERXD2",19,0)
 I '$$GET1^DIQ(52.49,PSOIEN,3.2,"I") S XQORM("B")="Edit"
"RTN","PSOERXD2",20,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXD2",21,0)
 I VAODRG W !,"Current Vista Drug: "_$$GET1^DIQ(50,VAODRG,.01,"E")
"RTN","PSOERXD2",22,0)
 ; for now allow user to search by drug name. may enhance screening in the future.
"RTN","PSOERXD2",23,0)
 S DIC(0)="AEMQ",DIC=50,DIC("S")="I $$ACTIVE^PSOERXA0(Y),($$OUTPAT^PSOERXA0(Y)),('$$INVCOMP^PSOERXA0(Y)),('$$CS^PSOERXA0(Y))"
"RTN","PSOERXD2",24,0)
 I VAODRG]"" S DIC("B")=VAODRG
"RTN","PSOERXD2",25,0)
 D ^DIC K DIC
"RTN","PSOERXD2",26,0)
 I $G(DUOUT)!($P(Y,U)<1) S PQUIT=1 Q
"RTN","PSOERXD2",27,0)
 S SELDRG=Y
"RTN","PSOERXD2",28,0)
 W !!,"You have selected: "_$P(Y,U,2),!,"Would you like to use this drug/supply?" S DIR(0)="YO" D ^DIR K DIR
"RTN","PSOERXD2",29,0)
 I Y="^"!(Y<1) S PQUIT=1 Q
"RTN","PSOERXD2",30,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="3.2///"_$P(SELDRG,U,1) D ^DIE
"RTN","PSOERXD2",31,0)
 ; set the manual validation flag if the drug has been selected.
"RTN","PSOERXD2",32,0)
 S VANDRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I")
"RTN","PSOERXD2",33,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERXD2",34,0)
 ; if the drug has changed, update the manual validation by and date/time
"RTN","PSOERXD2",35,0)
 I VANDRG'="",VAODRG'=VANDRG D
"RTN","PSOERXD2",36,0)
 .S QTLOOP=0 F  S QTLOOP=$O(^PS(52.49,PSOIEN,21,QTLOOP)) Q:'QTLOOP  D
"RTN","PSOERXD2",37,0)
 ..S FDA(52.4921,QTLOOP_","_PSOIENS,.01)="@" D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",38,0)
 .; if the drug is the same, leave the manual validation,otherwise delete it.
"RTN","PSOERXD2",39,0)
 .S FDA(52.49,PSOIENS,1.5)="",FDA(52.49,PSOIENS,1.11)="",FDA(52.49,PSOIENS,1.12)="",FDA(52.49,PSOIENS,20.3)="",FDA(52.49,PSOIENS,20.4)=""
"RTN","PSOERXD2",40,0)
 .S FDA(52.49,PSOIENS,27)="",FDA(52.49,PSOIENS,20.1)="",FDA(52.49,PSOIENS,20.2)="",FDA(52.49,PSOIENS,20.3)="",FDA(52.49,PSOIENS,20.4)="",FDA(52.49,PSOIENS,20.5)=""
"RTN","PSOERXD2",41,0)
 .D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",42,0)
 .I MTYPE="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERXD2",43,0)
 .I MTYPE="RE" D UPDSTAT^PSOERXU1(PSOIEN,"RXW")
"RTN","PSOERXD2",44,0)
 ; get and file patient instructions
"RTN","PSOERXD2",45,0)
 S VDRG=VANDRG
"RTN","PSOERXD2",46,0)
 S VAOI=$$GET1^DIQ(50,VDRG,2.1,"I")
"RTN","PSOERXD2",47,0)
 S PATINST=$$GET1^DIQ(50.7,VAOI,7,"E")
"RTN","PSOERXD2",48,0)
 I $L(PATINST) D
"RTN","PSOERXD2",49,0)
 .S FDA(52.49,PSOIENS,27)=$G(PATINST)
"RTN","PSOERXD2",50,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",51,0)
 Q
"RTN","PSOERXD2",52,0)
VDRG2(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",53,0)
 N PSOQTS,PSOFROM,PSODOSE,PSONEW,PSODRUG,PSORXED,VERB,QTIEN,SFIENS,DOSE,PSODFN,CURDOSE,NEWDOSE
"RTN","PSOERXD2",54,0)
 S IENS=1_","_PSOIEN_","
"RTN","PSOERXD2",55,0)
 S PSODFN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXD2",56,0)
 I 'PSODFN D  Q
"RTN","PSOERXD2",57,0)
 .W !,"Cannot continue with dosing instructions until patient has been matched." D DIRE^PSOERXX1
"RTN","PSOERXD2",58,0)
 .S PQUIT=1
"RTN","PSOERXD2",59,0)
 ; drug ien and orderable item ien
"RTN","PSOERXD2",60,0)
 D DERX1(PSOIEN,PSOIENS,1)
"RTN","PSOERXD2",61,0)
 S PSODRUG("IEN")=$$GET1^DIQ(52.49,PSOIEN,3.2,"I") Q:'PSODRUG("IEN")
"RTN","PSOERXD2",62,0)
 S PSODRUG("OI")=$$GET1^DIQ(50,PSODRUG("IEN"),2.1,"I") Q:'PSODRUG("OI")
"RTN","PSOERXD2",63,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE - SETTING VARIABLE CURDOSE
"RTN","PSOERXD2",64,0)
 S CURDOSE=$$GET1^DIQ(52.4921,IENS,9,"E")
"RTN","PSOERXD2",65,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXD2",66,0)
 S (PSORXED("ENT"),ENT)=1
"RTN","PSOERXD2",67,0)
 ; SET PSOFROM=PENDING so the dosage list will activate and present to the user
"RTN","PSOERXD2",68,0)
 S PSOFROM="PENDING"
"RTN","PSOERXD2",69,0)
 D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN)
"RTN","PSOERXD2",70,0)
 D ASK^PSOBKDED
"RTN","PSOERXD2",71,0)
 I $G(DOSE)']"" S PQUIT=1 Q
"RTN","PSOERXD2",72,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERXD2",73,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOERXD2",74,0)
VER ;
"RTN","PSOERXD2",75,0)
 D DERX1(PSOIEN,PSOIENS,1)
"RTN","PSOERXD2",76,0)
 ;below logic brought over from VER^PSOOREDX
"RTN","PSOERXD2",77,0)
 D KV S DIR(0)="52.0113,8"
"RTN","PSOERXD2",78,0)
 S:$G(PSORXED("VERB",ENT))]"" DIR("B")=PSORXED("VERB",ENT)
"RTN","PSOERXD2",79,0)
 D ^DIR
"RTN","PSOERXD2",80,0)
 I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOERXD2",81,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",82,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOERXD2",83,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOERXD2",84,0)
DUPD ;
"RTN","PSOERXD2",85,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOERXD2",86,0)
 ; below logic brought over from DUPD^PSOOREDX
"RTN","PSOERXD2",87,0)
 D KV S DIR(0)="52.0113,1",DIR("A")="DISPENSE UNITS PER DOSE"_$S($G(PSORXED("NOUN",ENT))]"":"("_PSORXED("NOUN",ENT)_")",1:"")
"RTN","PSOERXD2",88,0)
 I '$G(PSORXED("DOSE",ENT)),$G(PSORXED("DOSE",ENT-1)) S PSORXED("DOSE",ENT)=PSORXED("DOSE",ENT-1)
"RTN","PSOERXD2",89,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:1) S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOERXD2",90,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOERXD2",91,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",92,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOERXD2",93,0)
 ;below logic brought over from STR^PSOOREDX
"RTN","PSOERXD2",94,0)
 S:+STRE>0&(X>0) PSORXED("DOSE",ENT)=(X*STRE) W !,"Dosage Ordered: "_$S($E(PSORXED("DOSE",ENT),1)=".":"0",1:"")_PSORXED("DOSE",ENT)_UNITN,!
"RTN","PSOERXD2",95,0)
 S:X'="" (PSORXED("DOSE ORDERED",ENT),DUPD)=X
"RTN","PSOERXD2",96,0)
NOU1 ;
"RTN","PSOERXD2",97,0)
 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOERXD2",98,0)
 D CNON
"RTN","PSOERXD2",99,0)
 N PSONDEF
"RTN","PSOERXD2",100,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOERXD2",101,0)
NOU ;
"RTN","PSOERXD2",102,0)
 ;below logic brought over from NOU^PSOOREDX
"RTN","PSOERXD2",103,0)
 D KV S DIR(0)="52.0113,3"
"RTN","PSOERXD2",104,0)
 S DIR("B")=$S($G(NOUN)]"":NOUN,1:$G(PSORXED("NOUN",ENT))) K:DIR("B")="" DIR("B")
"RTN","PSOERXD2",105,0)
 S PSONDEF=$G(DIR("B"))
"RTN","PSOERXD2",106,0)
 D ^DIR
"RTN","PSOERXD2",107,0)
 I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOERXD2",108,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",109,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOERXD2",110,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOERXD2",111,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOERXD2",112,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOERXD2",113,0)
 ;
"RTN","PSOERXD2",114,0)
RTE ;
"RTN","PSOERXD2",115,0)
 N CURTE,ERXRTE
"RTN","PSOERXD2",116,0)
 S CURTE=$$GET1^DIQ(52.4921,ENT_","_PSOIEN_",",10,"E") S PSORXED("ROUTE",ENT)=CURTE
"RTN","PSOERXD2",117,0)
 K JUMP
"RTN","PSOERXD2",118,0)
 S ROU="PSOERXD2" D RTE2 K ROU
"RTN","PSOERXD2",119,0)
 K ROU
"RTN","PSOERXD2",120,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOERXD2",121,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",122,0)
 ;
"RTN","PSOERXD2",123,0)
SCH ;
"RTN","PSOERXD2",124,0)
 K PSOSCH,DIR,CURSCH,NEWSCH
"RTN","PSOERXD2",125,0)
 I '$D(ENT) S ENT=PSORXED("ENT")
"RTN","PSOERXD2",126,0)
 S CURSCH=$$GET1^DIQ(52.4921,ENT_","_PSOIEN_",",1,"E") I CURSCH]"" S DIR("B")=CURSCH
"RTN","PSOERXD2",127,0)
 S DIR("?")="^D SCHLP^PSOORED4",DIR("A")="Schedule: ",DIR(0)="FA^1:20^I X[""""""""!(X?.E1C.E)!($A(X)=45)!($L(X,"" "")>$S(X[""PRN"":4,1:3))!($L(X)>20)!($L(X)<1) K X"
"RTN","PSOERXD2",128,0)
 D ^DIR
"RTN","PSOERXD2",129,0)
 I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOERXD2",130,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",131,0)
 S SCH=$$SCHASL^PSOORED5(Y) D SCH^PSOSIG I $G(SCH)']""!($D(DTOUT))!($D(DUOUT)) G SCH
"RTN","PSOERXD2",132,0)
 S PSORXED("SCHEDULE",ENT)=SCH IF $G(SCHEX)'="" W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOERXD2",133,0)
 ;S SCH=Y D SCH^PSOSIG I $G(SCH)']"" G SCH
"RTN","PSOERXD2",134,0)
 ;S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOERXD2",135,0)
 S:PSORXED("ENT")<ENT PSORXED("ENT")=ENT
"RTN","PSOERXD2",136,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXD2",137,0)
 S PSORXED("SCHEDULE",ENT)=$$UP^XLFSTR(PSORXED("SCHEDULE",ENT))
"RTN","PSOERXD2",138,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXD2",139,0)
DUR ;
"RTN","PSOERXD2",140,0)
 N SIG,SIGDAT,SLOOP,P01,I,DDONE,EDFLG
"RTN","PSOERXD2",141,0)
 ;/BLB/ PSO*7.0*551 -BEGIN CHANGE - REMOVING DURATION PROMPT UNTIL TAPERING DOSES IS IMPLEMENTED
"RTN","PSOERXD2",142,0)
 ;D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN DAYS, HOURS OR MINUTES)"
"RTN","PSOERXD2",143,0)
 ;S DIR("B")=$S($G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOERXD2",144,0)
 ;D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOERXD2",145,0)
 ;G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",146,0)
 ;below logic is from DUR1^PSOOREDX
"RTN","PSOERXD2",147,0)
 ;I X="@" K DUR,PSORXED("DURATION",ENT)
"RTN","PSOERXD2",148,0)
 ;I Y'="" S PSORXED("DURATION",ENT)=Y W " ("_$S(Y["L":"MONTHS",Y["W":"WEEKS",Y["H":"HOURS",Y["M":"MINUTES",1:"DAYS")_")"
"RTN","PSOERXD2",149,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXD2",150,0)
 ; KEEP THIS CODE! - REMOVE CONJUNCTION FOR NOW, SINCE WE WILL NOT HAVE COMPLEX DOSING - FUTURE ENHANCEMENT
"RTN","PSOERXD2",151,0)
 ;CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOERXD2",152,0)
 ;G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",153,0)
 ;I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOERXD2",154,0)
 ;S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOERXD2",155,0)
 ;I X="@",$D(PSORXED("CONJUNCTION",ENT)) D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOERXD2",156,0)
 ;;
"RTN","PSOERXD2",157,0)
 ;N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOERXD2",158,0)
 ;;*437
"RTN","PSOERXD2",159,0)
 ;I '$$DUROK^PSOORED3(.PSORXED,ENT) D  G DUR
"RTN","PSOERXD2",160,0)
 ;. W !!,"Duration is required for the dosage entered prior to the THEN conjunction.",$C(7),!
"RTN","PSOERXD2",161,0)
 ;I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSONEW("DFLG")) EX S ENT=ENT+1 K DIR G ASK
"RTN","PSOERXD2",162,0)
 ;E  K PSOCKCON D DCHK1^PSODOSUT I $D(DTOUT)!($D(DUOUT)) S PSORX("DFLG")=1,PSONEW("DFLG")=1 G EX  ;don't need to print the full summary, just the last sequence. 
"RTN","PSOERXD2",163,0)
 ;I PSOSAVX="",$G(PSORXED) K PSOCKCON,PSOEDDOS
"RTN","PSOERXD2",164,0)
 ;K PSOSAVX
"RTN","PSOERXD2",165,0)
 ;;
"RTN","PSOERXD2",166,0)
 ;S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOERXD2",167,0)
 ;D EN^PSOFSIG(.PSORXED),VERI I $G(CKX),'$G(PSOSIGFL) D MP1 K CKX
"RTN","PSOERXD2",168,0)
 ;I $G(PSOSIGFL)=1 D  I '$G(PSOSIGFL) Q
"RTN","PSOERXD2",169,0)
 ;.I $D(OR0),$P(OR0,"^",24)=1 S VALMSG="Digitally Signed Order - No such changes allowed." K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D  Q
"RTN","PSOERXD2",170,0)
 ;..I $D(PSOBDR) K PSODRUG M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOERXD2",171,0)
 ;.S PSORXED("ENT")=ENT,SIGOK=1,VALMSG="This change will create a new prescription!",NCPDPFLG=1
"RTN","PSOERXD2",172,0)
 ;K QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOERXD2",173,0)
 ;I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOERXD2",174,0)
 ;K QTYHLD
"RTN","PSOERXD2",175,0)
 ;I '$G(PSORXED("QTY")),$P(OR0,"^",10) S PSORXED("QTY")=$P(OR0,"^",10)
"RTN","PSOERXD2",176,0)
 ;S PSORXED("INS")="TESTING TO SEE HOW LONG WE CAN MAKE THE SIG AND GET THIS TO FORMAT CORRECTLY"
"RTN","PSOERXD2",177,0)
 S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOERXD2",178,0)
 D EN^PSOFSIG(.PSORXED)
"RTN","PSOERXD2",179,0)
 ; delete existing SIG
"RTN","PSOERXD2",180,0)
 S SLOOP=0 F  S SLOOP=$O(^PS(52.49,PSOIEN,"SIG",SLOOP)) Q:'SLOOP  D
"RTN","PSOERXD2",181,0)
 .S FDA(52.4926,SLOOP_","_PSOIEN_",",.01)="@"
"RTN","PSOERXD2",182,0)
 I $D(FDA) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",183,0)
 ; file sig into VA DISPENSING INSTRUCTIONS multiple
"RTN","PSOERXD2",184,0)
 S SLOOP=0 F  S SLOOP=$O(SIG(SLOOP)) Q:'SLOOP  D
"RTN","PSOERXD2",185,0)
 .S SIGDAT=$G(SIG(SLOOP)) Q:SIGDAT=""
"RTN","PSOERXD2",186,0)
 .S SFDA(52.4926,"+1,"_PSOIENS,.01)=SIGDAT D UPDATE^DIE(,"SFDA",,"SERR") K SFDA
"RTN","PSOERXD2",187,0)
 S QTIEN=$O(^PS(52.49,PSOIEN,21,0))
"RTN","PSOERXD2",188,0)
 S SFIENS=$S(QTIEN:QTIEN_",",1:"+1,")
"RTN","PSOERXD2",189,0)
 S P01=$S($L($G(PSORXED("DOSE ORDERED",ENT))):$G(PSORXED("DOSE ORDERED",ENT))_"&"_$G(PSORXED("NOUN",ENT)),1:$G(PSORXED("DOSE",ENT)))
"RTN","PSOERXD2",190,0)
 I '$L(P01) D  Q
"RTN","PSOERXD2",191,0)
 .W !,"Dosage is required. Please re-enter the dosing instructions." S DIR(0)="W" D ^DIR D EX Q 
"RTN","PSOERXD2",192,0)
 S FDA(52.4921,SFIENS_PSOIENS,.01)=P01
"RTN","PSOERXD2",193,0)
 S FDA(52.4921,SFIENS_PSOIENS,1)=$G(PSORXED("SCHEDULE",ENT))
"RTN","PSOERXD2",194,0)
 S FDA(52.4921,SFIENS_PSOIENS,2)=$G(PSORXED("DURATION",ENT))
"RTN","PSOERXD2",195,0)
 S FDA(52.4921,SFIENS_PSOIENS,8)=$G(PSORXED("DOSE",ENT))
"RTN","PSOERXD2",196,0)
 S FDA(52.4921,SFIENS_PSOIENS,9)=$G(PSORXED("DOSE ORDERED",ENT))
"RTN","PSOERXD2",197,0)
 S FDA(52.4921,SFIENS_PSOIENS,10)=$G(PSORXED("ROUTE",ENT))
"RTN","PSOERXD2",198,0)
 S FDA(52.4921,SFIENS_PSOIENS,11)=$G(PSORXED("UNITS",ENT))
"RTN","PSOERXD2",199,0)
 S FDA(52.4921,SFIENS_PSOIENS,12)=$G(PSORXED("NOUN",ENT))
"RTN","PSOERXD2",200,0)
 S FDA(52.4921,SFIENS_PSOIENS,13)=$G(PSORXED("VERB",ENT))
"RTN","PSOERXD2",201,0)
 ; VA INSTRUCTIONS
"RTN","PSOERXD2",202,0)
 N UNEXINS,UNEXARY,DDONE
"RTN","PSOERXD2",203,0)
 I $G(PSORXED("ENT")) D
"RTN","PSOERXD2",204,0)
 .S DDONE=0
"RTN","PSOERXD2",205,0)
 .F I=1:1:PSORXED("ENT")  D  Q:DDONE
"RTN","PSOERXD2",206,0)
 ..I '$D(PSORXED("DOSE ORDERED",I)) S DDONE=1 Q
"RTN","PSOERXD2",207,0)
 ..I '$L($G(UNEXINS)) D  Q
"RTN","PSOERXD2",208,0)
 ...S UNEXINS=$G(PSORXED("VERB",I))_" "_$G(PSORXED("DOSE ORDERED",I))_" "_$G(PSORXED("NOUN",I))_" "_$G(ERXRTE(I))_" "_$G(PSORXED("SCHEDULE",I))
"RTN","PSOERXD2",209,0)
 ...I $L($G(PSORXED("DURATION",I))) S UNEXINS=UNEXINS_" "_$G(PSORXED("DURATION",I))
"RTN","PSOERXD2",210,0)
 ...I $L($G(PSORXED("CONJUNCTION",I))) S UNEXINS=UNEXINS_" "_$G(PSORXED("CONJUNCTION",I))
"RTN","PSOERXD2",211,0)
 ..S UNEXINS=UNEXINS_$G(PSORXED("VERB",I))_" "_$G(PSORXED("DOSE ORDERED",I))_" "_$G(PSORXED("NOUN",I))_" "_$G(ERXRTE(I))_" "_$G(PSORXED("SCHEDULE",I))
"RTN","PSOERXD2",212,0)
 ..I $L($G(PSORXED("DURATION",I))) S UNEXINS=UNEXINS_" "_$G(PSORXED("DURATION",I))
"RTN","PSOERXD2",213,0)
 ..I $L($G(PSORXED("CONJUNCTION",I))) S UNEXINS=UNEXINS_" "_$G(PSORXED("CONJUNCTION",I))
"RTN","PSOERXD2",214,0)
 I $L($G(UNEXINS)) D
"RTN","PSOERXD2",215,0)
 .D TXT2ARY^PSOERXD1(.UNEXARY,UNEXINS,,80)
"RTN","PSOERXD2",216,0)
 .D WP^DIE(52.49,PSOIEN_",",31,"K","UNEXARY","BWFERR")
"RTN","PSOERXD2",217,0)
 I SFIENS["+" D UPDATE^DIE(,"FDA",,"ERR") K FDA
"RTN","PSOERXD2",218,0)
 ; if there is a quantity/timing entry, overwrite the data (we are not using complex dosing in this phase)
"RTN","PSOERXD2",219,0)
 I SFIENS'["+" D FILE^DIE(,"FDA") K FDAG
"RTN","PSOERXD2",220,0)
EX ;
"RTN","PSOERXD2",221,0)
 K PSOBDR,PSOBDRG,PSOSCH,DUPD,STRE,UNITN,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSODOSE,OLENT,FIELD,FLDNM,AR,NM,ENT,STRE,UNITN,PSODOSE,ERTE,ROU,AR1,INS1
"RTN","PSOERXD2",222,0)
KV K DTOUT,DUOUT,DIR,DIRUT
"RTN","PSOERXD2",223,0)
 Q
"RTN","PSOERXD2",224,0)
EXQ ;
"RTN","PSOERXD2",225,0)
 K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D MP1
"RTN","PSOERXD2",226,0)
 I $D(PSOBDR) M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOERXD2",227,0)
 S PQUIT=1
"RTN","PSOERXD2",228,0)
 G EX Q
"RTN","PSOERXD2",229,0)
MP1 ;
"RTN","PSOERXD2",230,0)
 S VALMSG="eRx Not Updated!"
"RTN","PSOERXD2",231,0)
 Q
"RTN","PSOERXD2",232,0)
JUMP ;jump to fields
"RTN","PSOERXD2",233,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOERXD2",234,0)
 D FNM
"RTN","PSOERXD2",235,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOERXD2",236,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOERXD2",237,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOERXD2",238,0)
 D JFN G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOERXD2",239,0)
 G EX
"RTN","PSOERXD2",240,0)
 Q
"RTN","PSOERXD2",241,0)
FNM S NM=$E(X,2,4),NM=$TR(NM,"qwertyuioplkjhgfdsazxcvbnm","QWERTYUIOPLKJHGFDSAZXCVBNM")
"RTN","PSOERXD2",242,0)
 S FLDNM=$S(NM="DOS":"DOSE^*Dosage",NM="DIS":"DOSE ORDERED^Dispense Units",NM="ROU":"ROUTE^*Route",NM="SCH":"SCHEDULE^*Schedule",NM="DUR"!(NM="LIM"):"DURATION^*Duration",1:"")
"RTN","PSOERXD2",243,0)
 S:FLDNM="" FLDNM=$S(NM="CON":"CONJUNCTION^*Conjunction",NM="NOU":"NOUN^Noun",NM="VER":"VERB^Verb",1:"")
"RTN","PSOERXD2",244,0)
 Q
"RTN","PSOERXD2",245,0)
JFN K FLDNM,AR S ENT=+Y,FLDNM=$S(NM="NOU":"NOU",NM="VER":"VER",NM="DOS":"ASK",NM="DIS":"DUPD",NM="ROU":"RTE",NM="SCH":"SCH",NM="DUR"!(NM="LIM"):"DUR",NM="CON":"CON",1:"")
"RTN","PSOERXD2",246,0)
 Q
"RTN","PSOERXD2",247,0)
CNON ;
"RTN","PSOERXD2",248,0)
 I $G(NOUN)'="" Q
"RTN","PSOERXD2",249,0)
 I '$G(PSORXED("DOSE ORDERED",ENT)) Q
"RTN","PSOERXD2",250,0)
 N PSONLT,PSONLL,PSONLG
"RTN","PSOERXD2",251,0)
 S PSONLL=$P($G(DOSE("DD",+$G(PSODRUG("IEN")))),"^",9) I PSONLL="" Q
"RTN","PSOERXD2",252,0)
 S PSONLG=$L(PSONLL)
"RTN","PSOERXD2",253,0)
 I PSONLG'>3 Q
"RTN","PSOERXD2",254,0)
 S PSONLT=$E(PSONLL,(PSONLG-2),PSONLG)
"RTN","PSOERXD2",255,0)
 I PSONLT'="(S)",PSONLT'="(s)" Q
"RTN","PSOERXD2",256,0)
 ;test noun of (S)
"RTN","PSOERXD2",257,0)
 K NOUN
"RTN","PSOERXD2",258,0)
 I $G(PSORXED("DOSE ORDERED",ENT))>1 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))_$E(PSONLT,2) Q
"RTN","PSOERXD2",259,0)
 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))
"RTN","PSOERXD2",260,0)
 Q
"RTN","PSOERXD2",261,0)
RTE2 I $G(DRET) S PSORXED("ROUTE",ENT)=""
"RTN","PSOERXD2",262,0)
 I $G(RTE) K RTE
"RTN","PSOERXD2",263,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXD2",264,0)
 K DIR,DIRUT S DIR(0)="F^2:45",DIR("A")="ROUTE",DIR("?")="^D HLP^PSOORED4"
"RTN","PSOERXD2",265,0)
 ;/BLB/ PSO*7.0*520 - END CHANGE
"RTN","PSOERXD2",266,0)
 ;S DIR("B")=$S($G(PSORXED("ROUTE",ENT)):$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),$G(RTE)]"":RTE,$G(DRET):"",1:"PO") K:DIR("B")="" DIR("B")
"RTN","PSOERXD2",267,0)
 S DIR("B")=$G(CURTE)
"RTN","PSOERXD2",268,0)
 ;I '$G(PSORXED("ROUTE",ENT)),$G(PSOREEDT) K DIR("B")
"RTN","PSOERXD2",269,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="RTE",JUMP=1 K DIRUT,DTOUT Q
"RTN","PSOERXD2",270,0)
 Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOERXD2",271,0)
 I X="@"!(X="") K RTE,ERTE S DRET=1,PSORXED("ROUTE",ENT)="" Q
"RTN","PSOERXD2",272,0)
 K DRET I X=$P($G(^PS(51.2,+$G(PSORXED("ROUTE",ENT)),0)),"^") S RTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),ERTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^",2) W X_" "_$G(ERTE) Q
"RTN","PSOERXD2",273,0)
 S DIC=51.2,DIC(0)="QEZM",DIC("S")="I $P(^(0),""^"",4)" D ^DIC Q:X[U  G:Y=-1 RTE2 W "  "_$P(Y(0),"^",2)
"RTN","PSOERXD2",274,0)
 ;S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2)
"RTN","PSOERXD2",275,0)
 S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2),ERXRTE(ENT)=$P(Y(0),U,3)
"RTN","PSOERXD2",276,0)
 Q
"RTN","PSOERXD2",277,0)
VDRG3(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",278,0)
 N DIR,Y,PATINST,ERXDRUG,VDRG,VAOI,FDA
"RTN","PSOERXD2",279,0)
 D DERX1(PSOIEN,PSOIENS,1)
"RTN","PSOERXD2",280,0)
 S ERXDRUG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I")
"RTN","PSOERXD2",281,0)
 S PATINST=$$GET1^DIQ(52.49,PSOIEN,27,"E")
"RTN","PSOERXD2",282,0)
 I '$L(PATINST) D
"RTN","PSOERXD2",283,0)
 .S VDRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I") Q:'VDRG
"RTN","PSOERXD2",284,0)
 .S VAOI=$$GET1^DIQ(50,VDRG,2.1,"I") Q:'VAOI
"RTN","PSOERXD2",285,0)
 .S PATINST=$$GET1^DIQ(50.7,VAOI,7,"E")
"RTN","PSOERXD2",286,0)
 K DIR
"RTN","PSOERXD2",287,0)
 S DIR(0)="52.49,27",DIR("A")="VA PATIENT INSTRUCTIONS"
"RTN","PSOERXD2",288,0)
 I $L(PATINST) S DIR("B")=PATINST
"RTN","PSOERXD2",289,0)
 D ^DIR K DIR
"RTN","PSOERXD2",290,0)
 I Y["^" S PQUIT=1 Q
"RTN","PSOERXD2",291,0)
 S FDA(52.49,PSOIEN_",",27)=$$UP^XLFSTR(Y) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",292,0)
 Q
"RTN","PSOERXD2",293,0)
VDRG4(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",294,0)
 N DIR,Y,USERCOMM,VPATINST,UFLAG,VAPCOMM,ERXPCOMM,FDA
"RTN","PSOERXD2",295,0)
 ; POSSIBLE FUTURE IMPLEMENTATION OF ERX DETAILS
"RTN","PSOERXD2",296,0)
 ;D DERX1(PSOIEN,PSOIENS,1)
"RTN","PSOERXD2",297,0)
 S VPATINST=$$GET1^DIQ(52.49,PSOIEN,27,"E")
"RTN","PSOERXD2",298,0)
 S ERXPCOMM=$$GET1^DIQ(52.49,PSOIEN,8,"E")
"RTN","PSOERXD2",299,0)
 S VAPCOMM=$$GET1^DIQ(52.49,PSOIEN,30,"E")
"RTN","PSOERXD2",300,0)
 S DIR(0)="FO^1:240",DIR("A")="VA Provider Comments",DIR("B")=$S($L(VAPCOMM):VAPCOMM,1:ERXPCOMM)
"RTN","PSOERXD2",301,0)
 D ^DIR K DIR
"RTN","PSOERXD2",302,0)
 I Y["^" S PQUIT=1 Q
"RTN","PSOERXD2",303,0)
 S USERCOMM=$$UP^XLFSTR(Y) K Y
"RTN","PSOERXD2",304,0)
 S FDA(52.49,PSOIEN_",",30)=$$UP^XLFSTR(USERCOMM) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",305,0)
 Q
"RTN","PSOERXD2",306,0)
VDRG5(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",307,0)
 N PATIEN,PS55IEN,Y,DIE,DR,DA,FDA,ANS,PATSTAT,DONE
"RTN","PSOERXD2",308,0)
 S PATIEN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXD2",309,0)
 I 'PATIEN W !!,"Patient has not been validated, cannot edit patient status",! Q
"RTN","PSOERXD2",310,0)
 S PSODFN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXD2",311,0)
 S PATSTAT=$$GET1^DIQ(55,PSODFN,3,"E")
"RTN","PSOERXD2",312,0)
 S DIR("B")=PATSTAT
"RTN","PSOERXD2",313,0)
 S DIR(0)="55,3",DIR("A")="PATIENT STATUS"
"RTN","PSOERXD2",314,0)
 D ^DIR K DIR
"RTN","PSOERXD2",315,0)
 I 'PATSTAT,'+Y D
"RTN","PSOERXD2",316,0)
 .S DONE=0
"RTN","PSOERXD2",317,0)
 .F  D  Q:DONE
"RTN","PSOERXD2",318,0)
 ..W !,"This is a required response. Enter '^' to exit"
"RTN","PSOERXD2",319,0)
 ..S DIR(0)="55,3",DIR("A")="PATIENT STATUS" D ^DIR K DIR
"RTN","PSOERXD2",320,0)
 ..I +Y S DONE=1 Q
"RTN","PSOERXD2",321,0)
 ..I Y["^" S PQUIT=1,DONE=1 Q
"RTN","PSOERXD2",322,0)
 S ANS=$P(Y,"^",1)
"RTN","PSOERXD2",323,0)
 S FDA(55,PSODFN_",",3)=ANS
"RTN","PSOERXD2",324,0)
 D FILE^DIE(,"FDA","ERR") K FDA,ERR
"RTN","PSOERXD2",325,0)
 Q
"RTN","PSOERXD2",326,0)
 ;PSO*7.0*551 - BEGIN CHANGE - SWITCHING THE ORDER OF VDRG6 AND VDRG7. QUANTITY PROMPT WILL NOW COME BEFORE DAY SUPPLY.
"RTN","PSOERXD2",327,0)
VDRG6(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",328,0)
 N DIR,PSODRG,DRGMSG,ERXQTY,VAQTY,DIE,DA,DR
"RTN","PSOERXD2",329,0)
 S PSODRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I")
"RTN","PSOERXD2",330,0)
 I PSODRG S DRGMSG=$$GET1^DIQ(50,PSODRG,215,"E")
"RTN","PSOERXD2",331,0)
 S ERXQTY=$$GET1^DIQ(52.49,PSOIEN,5.1,"E")
"RTN","PSOERXD2",332,0)
 W !,"eRx Quantity: "_ERXQTY
"RTN","PSOERXD2",333,0)
 S VAQTY=$$GET1^DIQ(52.49,PSOIEN,20.1,"E")
"RTN","PSOERXD2",334,0)
 S PQUIT=$$QTYDSRFL^PSOERXU4(PSOIEN,2)
"RTN","PSOERXD2",335,0)
 Q
"RTN","PSOERXD2",336,0)
VDRG7(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",337,0)
 N Y,ERXDS,DIE,DR,DA
"RTN","PSOERXD2",338,0)
 ; dont prompt for days supply if we are editing 'all' fields or quantity (since quantity prompts for days supply)
"RTN","PSOERXD2",339,0)
 S ERXDS=$$GET1^DIQ(52.49,PSOIEN,5.5,"E")
"RTN","PSOERXD2",340,0)
 W !,"eRx Days Supply: "_ERXDS
"RTN","PSOERXD2",341,0)
 S PQUIT=$$QTYDSRFL^PSOERXU4(PSOIEN,1)
"RTN","PSOERXD2",342,0)
 ;/BLB/ END CHANGE
"RTN","PSOERXD2",343,0)
 Q
"RTN","PSOERXD2",344,0)
VDRG8(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",345,0)
 N Y,ERXRFLS,DIE,DR,DA
"RTN","PSOERXD2",346,0)
 S ERXRFLS=$$GET1^DIQ(52.49,PSOIEN,5.6,"E")
"RTN","PSOERXD2",347,0)
 W !,"eRx Refills: "_ERXRFLS
"RTN","PSOERXD2",348,0)
 S PQUIT=$$QTYDSRFL^PSOERXU4(PSOIEN,3)
"RTN","PSOERXD2",349,0)
 Q
"RTN","PSOERXD2",350,0)
VDRG9(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",351,0)
 N Y,DIR,DIE,DR,DA
"RTN","PSOERXD2",352,0)
 S DIR("A")="PICKUP ROUTING"
"RTN","PSOERXD2",353,0)
 S DIR(0)="SO^M:MAIL;W:WINDOW",DIR("B")="M" D ^DIR K DIR
"RTN","PSOERXD2",354,0)
 I Y["^" S PQUIT=1 Q
"RTN","PSOERXD2",355,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="20.4///"_Y D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",356,0)
 Q
"RTN","PSOERXD2",357,0)
VDRG10(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",358,0)
 N DIC,Y,VACLIN,CURCLIN,DIE,DR,DA
"RTN","PSOERXD2",359,0)
 S CURCLIN=$$GET1^DIQ(52.49,PSOIEN,20.6,"E")
"RTN","PSOERXD2",360,0)
 I '$L(CURCLIN) S CURCLIN=$$GET1^DIQ(59,PSOSITE,10,"E")
"RTN","PSOERXD2",361,0)
 S DIC("B")=CURCLIN
"RTN","PSOERXD2",362,0)
 S DIC="^SC(",DIC(0)="QEAMZ",DIC("A")="Select CLINIC: " D ^DIC K DIC
"RTN","PSOERXD2",363,0)
 I Y<1 Q
"RTN","PSOERXD2",364,0)
 I ($D(DTOUT))!($D(DUOUT)) S PQUIT=1 Q
"RTN","PSOERXD2",365,0)
 S VACLIN=$P(Y,U)
"RTN","PSOERXD2",366,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="20.6///"_VACLIN D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",367,0)
 K DTOUT,DUOUT
"RTN","PSOERXD2",368,0)
 Q
"RTN","PSOERXD2",369,0)
VDRG11(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",370,0)
 N DIE,DR,DA,Y
"RTN","PSOERXD2",371,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="8" D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",372,0)
 I $O(Y(0)) S PQUIT=1
"RTN","PSOERXD2",373,0)
 Q
"RTN","PSOERXD2",374,0)
 ; display erx info
"RTN","PSOERXD2",375,0)
 ; DFLG - display flag
"RTN","PSOERXD2",376,0)
 ;          1 - drug sig comments
"RTN","PSOERXD2",377,0)
 ;          ""- all        
"RTN","PSOERXD2",378,0)
DERX1(PSOIEN,PSOIENS,DFLG) ;
"RTN","PSOERXD2",379,0)
 D DERX1^PSOERXU4(PSOIEN,PSOIENS,$G(DFLG))
"RTN","PSOERXD2",380,0)
 Q
"RTN","PSOERXP1")
0^8^B28678984^B30549693
"RTN","PSOERXP1",1,0)
PSOERXP1 ;ALB/BWF - eRx Patient Display/Actions ; 8/3/2016 5:14pm
"RTN","PSOERXP1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,527,551**;DEC 1997;Build 37
"RTN","PSOERXP1",3,0)
 ;
"RTN","PSOERXP1",4,0)
EN ; -- main entry point for PSO ERX HOLDING QUEUE
"RTN","PSOERXP1",5,0)
 D EN^VALM("PSO ERX PATIENT VALIDATION")
"RTN","PSOERXP1",6,0)
 Q
"RTN","PSOERXP1",7,0)
 ;
"RTN","PSOERXP1",8,0)
HDR ; -- header code
"RTN","PSOERXP1",9,0)
 S VALMHDR(1)="eRx Patient: "_$$GET1^DIQ(52.49,PSOIEN,.04,"E")
"RTN","PSOERXP1",10,0)
 S VALMHDR(2)="eRx Reference #: "_$$GET1^DIQ(52.49,PSOIEN,.01,"E")
"RTN","PSOERXP1",11,0)
 I $G(VALMBCK)="R" K @VALMAR D INIT S VALMBCK=""
"RTN","PSOERXP1",12,0)
 Q
"RTN","PSOERXP1",13,0)
 ;
"RTN","PSOERXP1",14,0)
INIT ;
"RTN","PSOERXP1",15,0)
 Q:'$G(PSOIEN)
"RTN","PSOERXP1",16,0)
 N LINE,PATDAT,EXPIEN,EXPIENS,EXPNM,EXPDOB,EXPSSN,EXPADD,EXPGEN,EXPCTY,EXPST,EXPZIP,HFIEN,EXPHPH,CPIEN,EXPCPH,LINETXT
"RTN","PSOERXP1",17,0)
 N MANVAL,VAPATIEN,SEPLN,COMM,COMLINE,DONE,TEXT,VAEL,VAELIEN,VAELIG,VAELNM,WORD,VALBY,VALDTTM,PNAR,NARARY,PL
"RTN","PSOERXP1",18,0)
 S LINE=0,LINETXT=""
"RTN","PSOERXP1",19,0)
 S EXPIEN=$$GET1^DIQ(52.49,PSOIEN,.04,"I")
"RTN","PSOERXP1",20,0)
 S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.13,"I")
"RTN","PSOERXP1",21,0)
 S EXPIENS=EXPIEN_","
"RTN","PSOERXP1",22,0)
 D GETS^DIQ(52.46,EXPIENS,"**","E","PATDAT")
"RTN","PSOERXP1",23,0)
 S EXPNM=$G(PATDAT(52.46,EXPIENS,.01,"E"))
"RTN","PSOERXP1",24,0)
 S EXPDOB=$G(PATDAT(52.46,EXPIENS,.08,"E"))
"RTN","PSOERXP1",25,0)
 S EXPSSN=$G(PATDAT(52.46,EXPIENS,1.4,"E"))
"RTN","PSOERXP1",26,0)
 ;/BLB/ PSO*7.0*527 - BEGIN CHANGE - CORRECTING SSN FORMAT
"RTN","PSOERXP1",27,0)
 I EXPSSN D
"RTN","PSOERXP1",28,0)
 .I EXPSSN'["-" S EXPSSN=$E(EXPSSN,1,3)_"-"_$E(EXPSSN,4,5)_"-"_$E(EXPSSN,6,9)
"RTN","PSOERXP1",29,0)
 ;/BLB/ PSO*7.0*527 - END CHANGE
"RTN","PSOERXP1",30,0)
 S EXPADD=$G(PATDAT(52.46,EXPIENS,3.1,"E"))
"RTN","PSOERXP1",31,0)
 S EXPGEN=$G(PATDAT(52.46,EXPIENS,.07,"E"))
"RTN","PSOERXP1",32,0)
 S EXPCTY=$G(PATDAT(52.46,EXPIENS,3.3,"E"))
"RTN","PSOERXP1",33,0)
 S EXPST=$G(PATDAT(52.46,EXPIENS,3.4,"E"))
"RTN","PSOERXP1",34,0)
 S EXPZIP=$G(PATDAT(52.46,EXPIENS,3.5,"E")),EXPZIP=$E(EXPZIP,1,5)
"RTN","PSOERXP1",35,0)
 S HFIEN=$O(^PS(52.46,EXPIEN,3,"C","HP",0))
"RTN","PSOERXP1",36,0)
 ; home phone
"RTN","PSOERXP1",37,0)
 S EXPHPH=$$GET1^DIQ(52.462,HFIEN_","_EXPIENS,.01,"E")
"RTN","PSOERXP1",38,0)
 ; cellular phone
"RTN","PSOERXP1",39,0)
 S CPIEN=$O(^PS(52.46,EXPIEN,3,"C","CP",0))
"RTN","PSOERXP1",40,0)
 S EXPCPH=$$GET1^DIQ(52.462,CPIEN_","_EXPIENS,.01,"E")
"RTN","PSOERXP1",41,0)
 S LINE=LINE+1,LINETXT=""
"RTN","PSOERXP1",42,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXP1",43,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Patient: ",$E(EXPNM,1,39),1,52)
"RTN","PSOERXP1",44,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",EXPDOB,55,72)
"RTN","PSOERXP1",45,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",46,0)
 I $L(EXPNM)>39 D
"RTN","PSOERXP1",47,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"             "_$E(EXPNM,40,78))
"RTN","PSOERXP1",48,0)
 I $L(EXPNM)>78 D
"RTN","PSOERXP1",49,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"             "_$E(EXPNM,79,135))
"RTN","PSOERXP1",50,0)
 S LINE=LINE+1
"RTN","PSOERXP1",51,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",52,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXP1",53,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Sex: ",EXPGEN,1,15)
"RTN","PSOERXP1",54,0)
 D ADDITEM^PSOERX1A(.LINETXT,"SSN: ",EXPSSN,55,65)
"RTN","PSOERXP1",55,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",56,0)
 S LINE=LINE+1
"RTN","PSOERXP1",57,0)
 ;/BLB/ PSO*7.0*527 - BEGIN CHANGE - CORRECTING FORMAT OF STATE/OTHER FIELDS THAT LACK CONTINUITY
"RTN","PSOERXP1",58,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Addr: ",$E(EXPADD,1,40),1,50)
"RTN","PSOERXP1",59,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",60,0)
 S LINE=LINE+1
"RTN","PSOERXP1",61,0)
 ;/BLB/ PSO*7.0*520 MOVED CITY TO ITS OWN LINE - BEGIN CHANGE
"RTN","PSOERXP1",62,0)
 D ADDITEM^PSOERX1A(.LINETXT,"City: ",$E(EXPCTY,1,35),1,45)
"RTN","PSOERXP1",63,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",64,0)
 S LINE=LINE+1
"RTN","PSOERXP1",65,0)
 D ADDITEM^PSOERX1A(.LINETXT,"St: ",$E(EXPST,1,35),1,45)
"RTN","PSOERXP1",66,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Zip: ",EXPZIP,55,75)
"RTN","PSOERXP1",67,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXP1",68,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",69,0)
 S LINE=LINE+1
"RTN","PSOERXP1",70,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Home Phone: ",EXPHPH,1,25)
"RTN","PSOERXP1",71,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Cell Phone: ",EXPCPH,55,75)
"RTN","PSOERXP1",72,0)
 ;/BLB/ PSO*7.0*527 - END CHANGE
"RTN","PSOERXP1",73,0)
 D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",74,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXP1",75,0)
 ;S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXP1",76,0)
 S $P(SEPLN,"-",80)="-" D SET^VALM10(LINE,SEPLN)
"RTN","PSOERXP1",77,0)
 ; vista patient information
"RTN","PSOERXP1",78,0)
 S VAPATIEN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXP1",79,0)
 I VAPATIEN D
"RTN","PSOERXP1",80,0)
 .S DFN=VAPATIEN D DEM^VADPT,ADD^VADPT,ELIG^VADPT
"RTN","PSOERXP1",81,0)
 .S VAELIG=$G(VAEL(1)),VAELIEN=$P(VAELIG,U),VAELNM=$P(VAELIG,U,2)
"RTN","PSOERXP1",82,0)
 S MANVAL=$$GET1^DIQ(52.49,PSOIEN,1.7,"I")
"RTN","PSOERXP1",83,0)
 S VALBY=$$GET1^DIQ(52.49,PSOIEN,1.13,"E")
"RTN","PSOERXP1",84,0)
 S VALDTTM=$$GET1^DIQ(52.49,PSOIEN,1.14,"E")
"RTN","PSOERXP1",85,0)
 S LINE=LINE+1 D SET^VALM10(LINE,"Status: "_$S(MANVAL:"VALIDATED ("_VALBY_" - "_VALDTTM_")",1:"NOT VALIDATED"))
"RTN","PSOERXP1",86,0)
 ;/BLB/ PSO*7.0*527 - BEGIN CHANGE - REPLACING BLANK LINES WITH ALLERGY FIELDS
"RTN","PSOERXP1",87,0)
 I 'VAPATIEN D
"RTN","PSOERXP1",88,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"PATIENT NOT MATCHED")
"RTN","PSOERXP1",89,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Allergies:")
"RTN","PSOERXP1",90,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Adverse Reactions:")
"RTN","PSOERXP1",91,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXP1",92,0)
 I VAPATIEN D
"RTN","PSOERXP1",93,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",94,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Vista Patient: ",$G(VADM(1)),1,53)
"RTN","PSOERXP1",95,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",$P($G(VADM(3)),U,2),55,20)
"RTN","PSOERXP1",96,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",97,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",98,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Sex: ",$P($G(VADM(5)),U,2),1,20)
"RTN","PSOERXP1",99,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"SSN: ",$P($G(VADM(2)),U,2),55,20)
"RTN","PSOERXP1",100,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",101,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",102,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Addr: ",$P($G(VAPA(1)),U),1,70)
"RTN","PSOERXP1",103,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",104,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",105,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"City: ",$P($G(VAPA(4)),U),1,25)
"RTN","PSOERXP1",106,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",107,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",108,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"St: ",$P(VAPA(5),U,2),1,20)
"RTN","PSOERXP1",109,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Zip: ",$P($G(VAPA(6)),U),55,10)
"RTN","PSOERXP1",110,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",111,0)
 .S LINE=LINE+1
"RTN","PSOERXP1",112,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Home Phone: ",$P($G(VAPA(8)),U),1,25)
"RTN","PSOERXP1",113,0)
 .D ADDITEM^PSOERX1A(.LINETXT,"Cell Phone: ",$$GET1^DIQ(2,VAPATIEN,.134,"E"),55,80)
"RTN","PSOERXP1",114,0)
 .D SET^VALM10(LINE,LINETXT) S LINETXT=""
"RTN","PSOERXP1",115,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"")
"RTN","PSOERXP1",116,0)
 .S LINE=LINE+1 D SET^VALM10(LINE,"Eligibility: "_$G(VAELNM))
"RTN","PSOERXP1",117,0)
 .;/BLB/ PSO*7.0*551 - BEGIN CHANGE - CORRECTING PHARMACY NARRATIVE TRUNCATING ISSUE
"RTN","PSOERXP1",118,0)
 .S PNAR="Pharmacy Narrative: "_$$GET1^DIQ(55,VAPATIEN,1,"E")
"RTN","PSOERXP1",119,0)
 .D TXT2ARY^PSOERXD1(.NARARY,PNAR,,80)
"RTN","PSOERXP1",120,0)
 .S PL=0 F  S PL=$O(NARARY(PL)) Q:'PL  S LINE=LINE+1 D SET^VALM10(LINE,$G(NARARY(PL)))
"RTN","PSOERXP1",121,0)
 .;/BLB/ - PSO*7.0*551 - END CHANGE
"RTN","PSOERXP1",122,0)
 .I $$GET1^DIQ(52.49,PSOIEN,.05,"I") D
"RTN","PSOERXP1",123,0)
 ..D ALG^PSOERXU1(.LINE)
"RTN","PSOERXP1",124,0)
 S VALMCNT=LINE
"RTN","PSOERXP1",125,0)
 S EDTYP="P"
"RTN","PSOERXP1",126,0)
 K VAPA,VADM,DFN,VA
"RTN","PSOERXP1",127,0)
 Q
"RTN","PSOERXP1",128,0)
HELP ; -- help code
"RTN","PSOERXP1",129,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERXP1",130,0)
 Q
"RTN","PSOERXP1",131,0)
 ;
"RTN","PSOERXP1",132,0)
EXIT ; -- exit code
"RTN","PSOERXP1",133,0)
 K EDTYP,@VALMAR
"RTN","PSOERXP1",134,0)
 Q
"RTN","PSOERXP1",135,0)
 ;
"RTN","PSOERXP1",136,0)
EXPND ; -- expand code
"RTN","PSOERXP1",137,0)
 Q
"RTN","PSOERXU1")
0^9^B152819795^B144420314
"RTN","PSOERXU1",1,0)
PSOERXU1 ;ALB/BWF - eRx utilities ; 5/26/2017 9:57am
"RTN","PSOERXU1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,520,508,551**;DEC 1997;Build 37
"RTN","PSOERXU1",3,0)
 ;
"RTN","PSOERXU1",4,0)
 Q
"RTN","PSOERXU1",5,0)
 ; OR0 - OR0 FROM PENDING OUTPATIENT ORDERS OR BACKDOOR ORDERS
"RTN","PSOERXU1",6,0)
 ; OR0 can also be just the order number
"RTN","PSOERXU1",7,0)
CHKERX(OR0) ;
"RTN","PSOERXU1",8,0)
 N ORIEN,ERXIEN
"RTN","PSOERXU1",9,0)
 S ORIEN=$P(OR0,U) Q:'ORIEN 0
"RTN","PSOERXU1",10,0)
 I '$D(^PS(52.49,"ORN",ORIEN)) Q 0
"RTN","PSOERXU1",11,0)
 S ERXIEN=$O(^PS(52.49,"ORN",ORIEN,0))
"RTN","PSOERXU1",12,0)
 I 'ERXIEN Q 0
"RTN","PSOERXU1",13,0)
 Q ERXIEN
"RTN","PSOERXU1",14,0)
PROVPMT(ERXIEN) ;
"RTN","PSOERXU1",15,0)
 N ERXPHYS,ERXPHNM,ERXCON,DIR,Y
"RTN","PSOERXU1",16,0)
 S $P(LINE,"*",80)="" W !!,LINE
"RTN","PSOERXU1",17,0)
 W !!,"This prescription is an inbound electronic prescription (eRx).",!,"Please contact the original provider for approval to renew."
"RTN","PSOERXU1",18,0)
 S ERXPHYS=$$GET1^DIQ(52.49,ERXIEN,2.1,"I")
"RTN","PSOERXU1",19,0)
 S ERXPHNM=$$GET1^DIQ(52.48,ERXPHYS,.01,"E") W !,ERXPHNM
"RTN","PSOERXU1",20,0)
 I '$D(^PS(52.48,ERXPHYS,3,"C","TE")) W !!,"No telephone information on file for this provider." Q
"RTN","PSOERXU1",21,0)
 W !
"RTN","PSOERXU1",22,0)
 S ERXCON=0 F  S ERXCON=$O(^PS(52.48,ERXPHYS,3,"C","TE",ERXCON)) Q:'ERXCON  D
"RTN","PSOERXU1",23,0)
 .W !,"Telephone: "_$$GET1^DIQ(52.483,ERXCON_","_ERXPHYS_",",.01,"E")
"RTN","PSOERXU1",24,0)
 W !!,"Answering 'Yes' indicates you have contacted the prescribing physician"
"RTN","PSOERXU1",25,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("A")="Would you like to proceed with renewing this prescription" D ^DIR K DIR
"RTN","PSOERXU1",26,0)
 I Y=1 Q 1
"RTN","PSOERXU1",27,0)
 Q 0
"RTN","PSOERXU1",28,0)
 ; STORE IN ^TMP("PSOPO",$J,IEN,0)
"RTN","PSOERXU1",29,0)
DERX1(GL,PSOIEN,DFLG,IEN) ;
"RTN","PSOERXU1",30,0)
 N EDRG,ERXDAT,ESIG,COMM,SUBS,DFORM,DSTR,QQUAL,POTUC,QTY,DAYS,REFILL,PSOIENS,LINE,LINETXT,ADLINE,ADARY,ALOOP,COMMARY
"RTN","PSOERXU1",31,0)
 N ERXPAT,ERXPIEN,ERXPDOB,ERXPSSN,ERXPROV,ERXPRIEN,ERXPRDEA,ERXPRNPI,ERXPRSA1,ERXPRSA2,ERXPRCTY,ERXPRST,ERXPRZIP,I
"RTN","PSOERXU1",32,0)
 N PROVDAT,SIGARY,STHIS,STAT,ACBY,FOUND,ACDTTM,DRGARY,DLP,CTYSTZIP,ADLINE1,MTYPE,ERXDSUB
"RTN","PSOERXU1",33,0)
 Q:'PSOIEN
"RTN","PSOERXU1",34,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERXU1",35,0)
 D GETS^DIQ(52.49,PSOIENS,".04;.08;2.1;3.1;4.6;4.8;5.1;5.2;5.4;5.5;5.6;5.7;5.8;7;8;41;42;43","IE","ERXDAT")
"RTN","PSOERXU1",36,0)
 S DFLG=$G(DFLG,"")
"RTN","PSOERXU1",37,0)
 S EDRG=$G(ERXDAT(52.49,PSOIENS,3.1,"E"))
"RTN","PSOERXU1",38,0)
 S ESIG=$G(ERXDAT(52.49,PSOIENS,7,"E"))
"RTN","PSOERXU1",39,0)
 S COMM=$G(ERXDAT(52.49,PSOIENS,8,"E"))
"RTN","PSOERXU1",40,0)
 S SUBS=$G(ERXDAT(52.49,PSOIENS,5.8,"E"))
"RTN","PSOERXU1",41,0)
 S DFORM=$G(ERXDAT(52.49,PSOIENS,41,"E"))
"RTN","PSOERXU1",42,0)
 S DSTR=$G(ERXDAT(52.49,PSOIENS,43,"E"))
"RTN","PSOERXU1",43,0)
 S QQUAL=$G(ERXDAT(52.49,PSOIENS,5.2,"E"))
"RTN","PSOERXU1",44,0)
 S POTUC=$G(ERXDAT(52.49,PSOIENS,42,"E"))
"RTN","PSOERXU1",45,0)
 S QTY=$G(ERXDAT(52.49,PSOIENS,5.1,"E"))
"RTN","PSOERXU1",46,0)
 S DAYS=$G(ERXDAT(52.49,PSOIENS,5.5,"E"))
"RTN","PSOERXU1",47,0)
 S MTYPE=$G(ERXDAT(52.49,PSOIENS,.08,"I"))
"RTN","PSOERXU1",48,0)
 S REFILL=$G(ERXDAT(52.49,PSOIENS,5.6,"E"))
"RTN","PSOERXU1",49,0)
 I MTYPE="RE",REFILL>0 S REFILL=REFILL-1
"RTN","PSOERXU1",50,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXU1",51,0)
 I REFILL="" D
"RTN","PSOERXU1",52,0)
 .S REFILL=$G(ERXDAT(52.49,PSOIENS,5.7,"I"))
"RTN","PSOERXU1",53,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXU1",54,0)
 S ERXPAT=$G(ERXDAT(52.49,PSOIENS,.04,"E"))
"RTN","PSOERXU1",55,0)
 S ERXPIEN=$G(ERXDAT(52.49,PSOIENS,.04,"I"))
"RTN","PSOERXU1",56,0)
 S ERXPDOB=$$GET1^DIQ(52.46,ERXPIEN,.08,"E")
"RTN","PSOERXU1",57,0)
 S ERXPSSN=$$GET1^DIQ(52.46,ERXPIEN,1.4,"E")
"RTN","PSOERXU1",58,0)
 S ERXPROV=$G(ERXDAT(52.49,PSOIENS,2.1,"E"))
"RTN","PSOERXU1",59,0)
 S ERXPRIEN=$G(ERXDAT(52.49,PSOIENS,2.1,"I"))
"RTN","PSOERXU1",60,0)
 D GETS^DIQ(52.48,ERXPRIEN_",","1.5;1.6;4.1;4.2;4.3;4.4;4.5","E","PROVDAT")
"RTN","PSOERXU1",61,0)
 S ERXPRDEA=$G(PROVDAT(52.48,ERXPRIEN_",",1.6,"E"))
"RTN","PSOERXU1",62,0)
 S ERXPRNPI=$G(PROVDAT(52.48,ERXPRIEN_",",1.5,"E"))
"RTN","PSOERXU1",63,0)
 S ERXPRSA1=$G(PROVDAT(52.48,ERXPRIEN_",",4.1,"E"))
"RTN","PSOERXU1",64,0)
 S ERXPRSA2=$G(PROVDAT(52.48,ERXPRIEN_",",4.2,"E"))
"RTN","PSOERXU1",65,0)
 S ERXPRCTY=$G(PROVDAT(52.48,ERXPRIEN_",",4.3,"E"))
"RTN","PSOERXU1",66,0)
 S ERXPRST=$G(PROVDAT(52.48,ERXPRIEN_",",4.4,"E"))
"RTN","PSOERXU1",67,0)
 S ERXPRZIP=$G(PROVDAT(52.48,ERXPRIEN_",",4.5,"E"))
"RTN","PSOERXU1",68,0)
 D TXT2ARY^PSOERXD1(.SIGARY,ESIG,,69)
"RTN","PSOERXU1",69,0)
 D TXT2ARY^PSOERXD1(.COMMARY,COMM,,65)
"RTN","PSOERXU1",70,0)
 S STHIS=99999,FOUND=0
"RTN","PSOERXU1",71,0)
 F  S STHIS=$O(^PS(52.49,PSOIEN,19,STHIS),-1) Q:'STHIS!(FOUND)  D
"RTN","PSOERXU1",72,0)
 .S STAT=$$GET1^DIQ(52.4919,STHIS_","_PSOIENS,.02,"I")
"RTN","PSOERXU1",73,0)
 .I $$GET1^DIQ(52.45,STAT,.01,"E")'="PR" Q
"RTN","PSOERXU1",74,0)
 .S ACDTTM=$$GET1^DIQ(52.4919,STHIS_","_PSOIENS,.01,"E")
"RTN","PSOERXU1",75,0)
 .S ACBY=$$GET1^DIQ(52.4919,STHIS_","_PSOIENS,.03,"E"),FOUND=1
"RTN","PSOERXU1",76,0)
 I $L($G(ACBY)) S IEN=IEN+1,@GL@(IEN,0)="eRx Accepted By: "_ACBY_" ("_ACDTTM_")"
"RTN","PSOERXU1",77,0)
 S LINETXT=""
"RTN","PSOERXU1",78,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Patient: ",ERXPAT,1,55)
"RTN","PSOERXU1",79,0)
 D ADDITEM^PSOERX1A(.LINETXT,"SSN: ",ERXPSSN,57,15)
"RTN","PSOERXU1",80,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT
"RTN","PSOERXU1",81,0)
 S LINETXT=""
"RTN","PSOERXU1",82,0)
 I $L(ERXPAT)>42 D ADDITEM^PSOERX1A(.LINETXT,"             ",$E(ERXPAT,43,84),1,55)
"RTN","PSOERXU1",83,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DOB: ",ERXPDOB,57,20)
"RTN","PSOERXU1",84,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT
"RTN","PSOERXU1",85,0)
 I $L(ERXPAT)>84 D
"RTN","PSOERXU1",86,0)
 .S IEN=IEN+1,@GL@(IEN,0)="             "_$E(ERXPAT,85,117)
"RTN","PSOERXU1",87,0)
 S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",88,0)
 I $L(ERXPAT)>117 D
"RTN","PSOERXU1",89,0)
 .S IEN=IEN+1,@GL@(IEN,0)="             "_$E(ERXPAT,118,135)
"RTN","PSOERXU1",90,0)
 S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",91,0)
 S LINETXT=""
"RTN","PSOERXU1",92,0)
 D ADDITEM^PSOERX1A(.LINETXT,"eRx Provider: ",$E(ERXPROV,1,55),1,55)
"RTN","PSOERXU1",93,0)
 D ADDITEM^PSOERX1A(.LINETXT,"DEA: ",ERXPRDEA,57,20)
"RTN","PSOERXU1",94,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT,LINETXT=""
"RTN","PSOERXU1",95,0)
 I $L(ERXPROV)>55 D ADDITEM^PSOERX1A(.LINETXT,"              ",$E(ERXPROV,56,96),1,55)
"RTN","PSOERXU1",96,0)
 D ADDITEM^PSOERX1A(.LINETXT,"NPI: ",ERXPRNPI,57,20)
"RTN","PSOERXU1",97,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT,LINETXT=""
"RTN","PSOERXU1",98,0)
 I $L(ERXPROV)>96 D ADDITEM^PSOERX1A(.LINETXT,"              ",$E(ERXPROV,97,135),1,55)
"RTN","PSOERXU1",99,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT,LINETXT=""
"RTN","PSOERXU1",100,0)
 ;/BLB/ PSO*7.0*520 - BEGIN CHANGE
"RTN","PSOERXU1",101,0)
 S ADLINE1=$S($L(ERXPRSA1):ERXPRSA1,1:"ADDRESS UNKNOWN ")
"RTN","PSOERXU1",102,0)
 S CTYSTZIP=$S($L(ERXPRCTY):ERXPRCTY_",",1:"")
"RTN","PSOERXU1",103,0)
 S CTYSTZIP=CTYSTZIP_$S($L(ERXPRST):ERXPRST_" ",1:"")
"RTN","PSOERXU1",104,0)
 S CTYSTZIP=" "_CTYSTZIP_$S($L(ERXPRZIP):ERXPRZIP,1:"")
"RTN","PSOERXU1",105,0)
 S IEN=IEN+1,@GL@(IEN,0)="Address: "_ADLINE1
"RTN","PSOERXU1",106,0)
 S IEN=IEN+1,@GL@(IEN,0)=CTYSTZIP
"RTN","PSOERXU1",107,0)
 I $L(ERXPRSA2) D
"RTN","PSOERXU1",108,0)
 .S IEN=IEN+1,@GL@(IEN,0)="Address Line 2: "_ERXPRSA2
"RTN","PSOERXU1",109,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXU1",110,0)
 I $O(ADARY(0)) D
"RTN","PSOERXU1",111,0)
 .S ALOOP=1 F  S ALOOP=$O(ADARY(ALOOP)) Q:'ALOOP  D
"RTN","PSOERXU1",112,0)
 ..S IEN=IEN+1,@GL@(IEN,0)="         "_ADARY(ALOOP)
"RTN","PSOERXU1",113,0)
 S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",114,0)
 D TXT2ARY^PSOERXD1(.DRGARY,EDRG,,70)
"RTN","PSOERXU1",115,0)
 S IEN=IEN+1,@GL@(IEN,0)="eRx Drug: "_$G(DRGARY(1))
"RTN","PSOERXU1",116,0)
 S DLP=1
"RTN","PSOERXU1",117,0)
 F  S DLP=$O(DRGARY(DLP)) Q:'DLP  D
"RTN","PSOERXU1",118,0)
 .S IEN=IEN+1,@GL@(IEN,0)="          "_$G(DRGARY(DLP))
"RTN","PSOERXU1",119,0)
 S LINETXT=""
"RTN","PSOERXU1",120,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Qty: ",QTY,1,25)
"RTN","PSOERXU1",121,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Days Supply: ",DAYS,27,16)
"RTN","PSOERXU1",122,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Refills: ",REFILL,58,20)
"RTN","PSOERXU1",123,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE - CHANGED TEXT FROM "DO NOT SUB" TO "SUBSTITUTIONS? :"
"RTN","PSOERXU1",124,0)
 S ERXDSUB=$$GET1^DIQ(52.49,PSOIEN,5.8,"I")
"RTN","PSOERXU1",125,0)
 S ERXDSUB=$S(ERXDSUB=1:"NO",ERXDSUB=0:"YES",1:"")
"RTN","PSOERXU1",126,0)
 S LINETXT=""
"RTN","PSOERXU1",127,0)
 D ADDITEM^PSOERX1A(.LINETXT,"Substitutions? :",ERXDSUB,1,25)
"RTN","PSOERXU1",128,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXU1",129,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT
"RTN","PSOERXU1",130,0)
 S IEN=IEN+1,@GL@(IEN,0)="eRx Sig: "
"RTN","PSOERXU1",131,0)
 S I=0 F  S I=$O(SIGARY(I)) Q:'I  D
"RTN","PSOERXU1",132,0)
 .I I=1 S @GL@(IEN,0)=@GL@(IEN,0)_SIGARY(I) Q
"RTN","PSOERXU1",133,0)
 .S IEN=IEN+1,@GL@(IEN,0)=$S(I>1:"         "_SIGARY(I),1:SIGARY(I))
"RTN","PSOERXU1",134,0)
 I '$L(ESIG) S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",135,0)
 S IEN=IEN+1,@GL@(IEN,0)="eRx Notes: "
"RTN","PSOERXU1",136,0)
 S I=0 F  S I=$O(COMMARY(I)) Q:'I  D
"RTN","PSOERXU1",137,0)
 .I I=1 S @GL@(IEN,0)=@GL@(IEN,0)_$S(I>1:"              "_COMMARY(I),1:COMMARY(I)) Q
"RTN","PSOERXU1",138,0)
 .S IEN=IEN+1,@GL@(IEN,0)=$S(I>1:"              "_COMMARY(I),1:COMMARY(I))
"RTN","PSOERXU1",139,0)
 I '$L(COMM) S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",140,0)
 Q:DFLG=1
"RTN","PSOERXU1",141,0)
 S LINETXT=""
"RTN","PSOERXU1",142,0)
 S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",143,0)
 S IEN=IEN+1,@GL@(IEN,0)="Drug Form: "_DFORM
"RTN","PSOERXU1",144,0)
 S IEN=IEN+1,@GL@(IEN,0)="Strength: "_DSTR
"RTN","PSOERXU1",145,0)
 S LINETXT=""
"RTN","PSOERXU1",146,0)
 ;/BLB/ PSO*7.0*551 BEGIN CHANGE - CORRECTING QTY QUAL TO CODE LIST QUAL
"RTN","PSOERXU1",147,0)
 S IEN=IEN+1,@GL@(IEN,0)="Code List Qualifier: "_QQUAL
"RTN","PSOERXU1",148,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXU1",149,0)
 S IEN=IEN+1,@GL@(IEN,0)="Potency Unit Code: "_POTUC
"RTN","PSOERXU1",150,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINETXT
"RTN","PSOERXU1",151,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE - ADDING SUBSTITUTION TEXT
"RTN","PSOERXU1",152,0)
 S ERXDSUB=$$GET1^DIQ(52.49,PSOIEN,5.8,"I")
"RTN","PSOERXU1",153,0)
 S ERXDSUB=$S(ERXDSUB=1:"NO",ERXDSUB=0:"YES",1:"")
"RTN","PSOERXU1",154,0)
 S IEN=IEN+1,@GL@(IEN,0)="Substitutions?: "_ERXDSUB
"RTN","PSOERXU1",155,0)
 ;/BLB/ PSO*7.0*551
"RTN","PSOERXU1",156,0)
 S IEN=IEN+1,@GL@(IEN,0)=""
"RTN","PSOERXU1",157,0)
 D DIAG(PSOIEN,.IEN,.GL)
"RTN","PSOERXU1",158,0)
 S $P(LINE,"-",80)=""
"RTN","PSOERXU1",159,0)
 S IEN=IEN+1,@GL@(IEN,0)=LINE
"RTN","PSOERXU1",160,0)
 Q
"RTN","PSOERXU1",161,0)
 ; diagnosis information
"RTN","PSOERXU1",162,0)
DIAG(PSOIEN,LINE,GL) ;
"RTN","PSOERXU1",163,0)
 N DIAGIEN,DIAGDAT,DIAGSEQ,PDIAGQ,PDIAGV,SDIAGQ,SDIAGV,DIAGDAT,DIACIC,DRES,SDRES,PDIAGTXT,SDIAGTXT
"RTN","PSOERXU1",164,0)
 N SDRESL,SDRESDAT,DRESL,DRESDAT,PDIAGARY,SDIAGARY,PDFRST,SDFRST,PDLOOP,SDLOOP,DIENS
"RTN","PSOERXU1",165,0)
 S DIAGIEN=0 F  S DIAGIEN=$O(^PS(52.49,PSOIEN,9,DIAGIEN)) Q:'DIAGIEN  D
"RTN","PSOERXU1",166,0)
 .S DIENS=DIAGIEN_","_PSOIEN_"," K PDIAGARY,SDIAGARY,DIAGDAT
"RTN","PSOERXU1",167,0)
 .D GETS^DIQ(52.499,DIENS,".01:.06","IE","DIAGDAT")
"RTN","PSOERXU1",168,0)
 .S DIAGSEQ=$G(DIAGDAT(52.499,DIENS,.01,"E"))
"RTN","PSOERXU1",169,0)
 .S DIACIC=$G(DIAGDAT(52.499,DIENS,.02,"E"))
"RTN","PSOERXU1",170,0)
 .S PDIAGQ=$G(DIAGDAT(52.499,DIENS,.03,"E"))
"RTN","PSOERXU1",171,0)
 .S PDIAGV=$G(DIAGDAT(52.499,DIENS,.04,"E"))
"RTN","PSOERXU1",172,0)
 .I PDIAGQ["ICD" D
"RTN","PSOERXU1",173,0)
 ..K DRES,PDIAGARY
"RTN","PSOERXU1",174,0)
 ..D ICDDESC^ICDXCODE(PDIAGQ,PDIAGV,,.DRES)
"RTN","PSOERXU1",175,0)
 ..I '$O(DRES(0)) D TXT2ARY^PSOERXD1(.PDIAGARY,"Primary Dx:   ("_PDIAGQ_" - "_PDIAGV_")"," ",78) Q
"RTN","PSOERXU1",176,0)
 ..S PDIAGTXT="Primary Dx:   ("_PDIAGQ_" "_PDIAGV_") "
"RTN","PSOERXU1",177,0)
 ..S DRESL=0 F  S DRESL=$O(DRES(DRESL)) Q:'DRESL  D
"RTN","PSOERXU1",178,0)
 ...S DRESDAT=$G(DRES(DRESL)) Q:DRESDAT=""
"RTN","PSOERXU1",179,0)
 ...S PDIAGTXT=$G(PDIAGTXT)_" "_DRESDAT
"RTN","PSOERXU1",180,0)
 ..D TXT2ARY^PSOERXD1(.PDIAGARY,PDIAGTXT," ",78)
"RTN","PSOERXU1",181,0)
 .S SDIAGQ=$G(DIAGDAT(52.499,DIENS,.05,"E"))
"RTN","PSOERXU1",182,0)
 .S SDIAGV=$G(DIAGDAT(52.499,DIENS,.06,"E"))
"RTN","PSOERXU1",183,0)
 .I SDIAGQ["ICD" D
"RTN","PSOERXU1",184,0)
 ..K SDRES,SDIAGARY
"RTN","PSOERXU1",185,0)
 ..D ICDDESC^ICDXCODE(SDIAGQ,SDIAGV,,.SDRES)
"RTN","PSOERXU1",186,0)
 ..I '$O(DRES(0)) D TXT2ARY^PSOERXD1(.SDIAGARY,"Secondary Dx: ("_SDIAGQ_" - "_SDIAGV_")"," ",78) Q
"RTN","PSOERXU1",187,0)
 ..S SDIAGTXT="Secondary Dx: ("_SDIAGQ_" "_SDIAGV_") "
"RTN","PSOERXU1",188,0)
 ..S SDRESL=0 F  S SDRESL=$O(SDRES(SDRESL)) Q:'SDRESL  D
"RTN","PSOERXU1",189,0)
 ...S SDRESDAT=$G(SDRES(SDRESL)) Q:SDRESDAT=""
"RTN","PSOERXU1",190,0)
 ...S SDIAGTXT=$G(SDIAGTXT)_" "_SDRESDAT
"RTN","PSOERXU1",191,0)
 ..D TXT2ARY^PSOERXD1(.SDIAGARY,SDIAGTXT," ",78)
"RTN","PSOERXU1",192,0)
 .I '$D(PDIAGARY) D TXT2ARY^PSOERXD1(.PDIAGARY,"Primary Dx:   ("_PDIAGQ_" - "_PDIAGV_")"," ",78)
"RTN","PSOERXU1",193,0)
 .S PDFRST=$O(PDIAGARY(0))
"RTN","PSOERXU1",194,0)
 .S LINE=LINE+1
"RTN","PSOERXU1",195,0)
 .I $D(GL) D SETGL(LINE,PDIAGARY(PDFRST))
"RTN","PSOERXU1",196,0)
 .I '$D(GL) D SETLOC(LINE,$G(PDIAGARY(PDFRST)))
"RTN","PSOERXU1",197,0)
 .S PDLOOP=PDFRST F  S PDLOOP=$O(PDIAGARY(PDLOOP)) Q:'PDLOOP  D
"RTN","PSOERXU1",198,0)
 ..S LINE=LINE+1
"RTN","PSOERXU1",199,0)
 ..I $D(GL) D SETGL(LINE,"              "_$G(PDIAGARY(PDLOOP)))
"RTN","PSOERXU1",200,0)
 ..I '$D(GL) D SETLOC(LINE,"              "_$G(PDIAGARY(PDLOOP)))
"RTN","PSOERXU1",201,0)
 .S LINE=LINE+1
"RTN","PSOERXU1",202,0)
 .I $D(GL) D SETGL(LINE,"")
"RTN","PSOERXU1",203,0)
 .I '$D(GL) D SETLOC(LINE,"")
"RTN","PSOERXU1",204,0)
 .I '$D(SDIAGARY) D TXT2ARY^PSOERXD1(.SDIAGARY,"Secondary Dx: ("_SDIAGQ_" - "_SDIAGV_")"," ",78)
"RTN","PSOERXU1",205,0)
 .S SDFRST=$O(SDIAGARY(0))
"RTN","PSOERXU1",206,0)
 .S LINE=LINE+1
"RTN","PSOERXU1",207,0)
 .I $D(GL) D SETGL(LINE,$G(SDIAGARY(SDFRST)))
"RTN","PSOERXU1",208,0)
 .I '$D(GL) D SETLOC(LINE,$G(SDIAGARY(SDFRST)))
"RTN","PSOERXU1",209,0)
 .S SDLOOP=SDFRST F  S SDLOOP=$O(SDIAGARY(SDLOOP)) Q:'SDLOOP  D
"RTN","PSOERXU1",210,0)
 ..S LINE=LINE+1
"RTN","PSOERXU1",211,0)
 ..I $D(GL) D SETGL(LINE,"              "_$G(SDIAGARY(SDLOOP)))
"RTN","PSOERXU1",212,0)
 ..I '$D(GL) D SETLOC(LINE,"              "_$G(SDIAGARY(SDLOOP)))
"RTN","PSOERXU1",213,0)
 .I $O(^PS(52.49,PSOIEN,9,DIAGIEN)) D
"RTN","PSOERXU1",214,0)
 ..S LINE=LINE+1
"RTN","PSOERXU1",215,0)
 ..I $D(GL) D SETGL(LINE,"")
"RTN","PSOERXU1",216,0)
 ..I '$D(GL) D SETLOC(LINE,"")
"RTN","PSOERXU1",217,0)
 Q
"RTN","PSOERXU1",218,0)
SETLOC(LINE,TEXT) ;
"RTN","PSOERXU1",219,0)
 D SET^VALM10(LINE,TEXT)
"RTN","PSOERXU1",220,0)
 Q
"RTN","PSOERXU1",221,0)
SETGL(IEN,TEXT) ;
"RTN","PSOERXU1",222,0)
 S @GL@(IEN,0)=TEXT
"RTN","PSOERXU1",223,0)
 Q
"RTN","PSOERXU1",224,0)
OPACCESS(OPTION,DUZ,ERXIEN) ;
"RTN","PSOERXU1",225,0)
 N MTYPE,EVAL,RESVAL,MSTAT,DELTA,RET,RESIEN,REQIEN
"RTN","PSOERXU1",226,0)
 S MTYPE=$$GET1^DIQ(52.49,PSOIEN,.08,"I")
"RTN","PSOERXU1",227,0)
 S MSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E")
"RTN","PSOERXU1",228,0)
 S RESVAL=$$GET1^DIQ(52.49,PSOIEN,52.1,"I")
"RTN","PSOERXU1",229,0)
 I MSTAT="RRE"!(MSTAT="RRN") Q 0
"RTN","PSOERXU1",230,0)
 I MTYPE="RE",((RESVAL="D")!(RESVAL="DNP"))!(RESVAL="A") Q 0
"RTN","PSOERXU1",231,0)
 I MTYPE="RE",(MSTAT="RXP")!(MSTAT="RXC") Q 0
"RTN","PSOERXU1",232,0)
 I MTYPE="RE"!(MTYPE="RR"),(MSTAT="CAN")!(MSTAT="RXD")!(MSTAT="RRP") Q 0
"RTN","PSOERXU1",233,0)
 I MTYPE="CA"!(MTYPE="CN")!(MTYPE="IE") Q 0
"RTN","PSOERXU1",234,0)
 I MTYPE="N",$$GET1^DIQ(52.49,PSOIEN,1,"E")="CAN" Q 0
"RTN","PSOERXU1",235,0)
 I OPTION="PSO ERX ACCEPT ERX",RESVAL="AWC",MTYPE="RE",(MSTAT="RXN"!(MSTAT="RXW")) D  Q RET
"RTN","PSOERXU1",236,0)
 .S RET=0 I ('$D(^XUSEC("PSDRPH",DUZ))),('$D(^XUSEC("PSO ERX ADV TECH",DUZ))) Q
"RTN","PSOERXU1",237,0)
 .I MSTAT="RXW" S RET=1 Q
"RTN","PSOERXU1",238,0)
 .S RESIEN=PSOIEN,REQIEN=$$GETREQ^PSOERXU2(PSOIEN)
"RTN","PSOERXU1",239,0)
 .D RRDELTA^PSOERXU2(.DELTA,REQIEN,RESIEN)
"RTN","PSOERXU1",240,0)
 .I $D(DELTA(52.49,"EXTERNAL PROVIDER")) S RET=1
"RTN","PSOERXU1",241,0)
 ; block all but accept erx on eRx's in RXW status
"RTN","PSOERXU1",242,0)
 I OPTION'="PSO ERX ACCEPT ERX",MSTAT="RXW" Q 0
"RTN","PSOERXU1",243,0)
 I OPTION="PSO ERX REJECT"!(OPTION="PSO ERX REMOVE")!(OPTION="PSO ERX HOLD")!(OPTION="PSO ERX UNHOLD"),MSTAT="RXN" Q 0
"RTN","PSOERXU1",244,0)
 I OPTION="PSO ERX ACCEPT ERX",('$D(^XUSEC("PSDRPH",DUZ))),('$D(^XUSEC("PSO ERX ADV TECH",DUZ))) Q 0
"RTN","PSOERXU1",245,0)
 I OPTION="PSO ERX ACCEPT VALIDATION",($D(^XUSEC("PSO ERX TECH",DUZ))!($D(^XUSEC("PSO ERX VIEW",DUZ)))) Q 0
"RTN","PSOERXU1",246,0)
 I OPTION="PSO ERX REJECT",($D(^XUSEC("PSO ERX VIEW",DUZ))) Q 0
"RTN","PSOERXU1",247,0)
 I OPTION="PSO ERX REMOVE",($D(^XUSEC("PSO ERX VIEW",DUZ))) Q 0
"RTN","PSOERXU1",248,0)
 ; UNREMOVE NEEDS TO BE ADDED IF WE ADD THE OPTION
"RTN","PSOERXU1",249,0)
 I OPTION="PSO ERX VALIDATE PATIENT",$D(^XUSEC("PSO ERX VIEW",DUZ)) Q 0
"RTN","PSOERXU1",250,0)
 I OPTION="PSO ERX VALIDATE PROVIDER",$D(^XUSEC("PSO ERX VIEW",DUZ)) Q 0
"RTN","PSOERXU1",251,0)
 I OPTION="PSO ERX VALIDATE DRUG",$D(^XUSEC("PSO ERX VIEW",DUZ)) Q 0
"RTN","PSOERXU1",252,0)
 I OPTION="PSO ERX HOLD",$D(^XUSEC("PSO ERX VIEW",DUZ)) Q 0
"RTN","PSOERXU1",253,0)
 I OPTION="PSO ERX UNHOLD",$D(^XUSEC("PSO ERX VIEW",DUZ)) Q 0
"RTN","PSOERXU1",254,0)
 Q 1
"RTN","PSOERXU1",255,0)
 ; update the status of an eRx
"RTN","PSOERXU1",256,0)
 ; PSOIEN - ien for file 52.49 (required)
"RTN","PSOERXU1",257,0)
 ; STAT - The status value to change the eRx to (required)
"RTN","PSOERXU1",258,0)
 ; SCOMM - status comments (optional)
"RTN","PSOERXU1",259,0)
UPDSTAT(PSOIEN,STAT,SCOMM) ;
"RTN","PSOERXU1",260,0)
 N DIE,NSTAT,DA,DR
"RTN","PSOERXU1",261,0)
 Q:'PSOIEN!(STAT="")
"RTN","PSOERXU1",262,0)
 Q:'$D(^PS(52.45,"C","ERX",STAT))
"RTN","PSOERXU1",263,0)
 S NSTAT=$O(^PS(52.45,"C","ERX",STAT,0))
"RTN","PSOERXU1",264,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="1///"_NSTAT D ^DIE
"RTN","PSOERXU1",265,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",.01)=$$NOW^XLFDT
"RTN","PSOERXU1",266,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",.02)=NSTAT
"RTN","PSOERXU1",267,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",.03)=$G(DUZ)
"RTN","PSOERXU1",268,0)
 S FDA(52.4919,"+1,"_PSOIEN_",",1)=$G(SCOMM)
"RTN","PSOERXU1",269,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXU1",270,0)
 Q
"RTN","PSOERXU1",271,0)
ERRSEQ(EIEN) ;
"RTN","PSOERXU1",272,0)
 N SEQ
"RTN","PSOERXU1",273,0)
 I '$O(^PS(52.49,EIEN,100,0)) S SEQ=1
"RTN","PSOERXU1",274,0)
 I '$G(SEQ) S SEQ=$O(^PS(52.49,EIEN,100,999999),-1)+1
"RTN","PSOERXU1",275,0)
 Q SEQ
"RTN","PSOERXU1",276,0)
 ;
"RTN","PSOERXU1",277,0)
 ; IENS - ien of the erx holding queue entry
"RTN","PSOERXU1",278,0)
 ;  SEQ - sequence number of the error
"RTN","PSOERXU1",279,0)
 ; TYPE - type (d-drug, pr-provider, pa-patient, a-allergy, o-order check, t-transfer)
"RTN","PSOERXU1",280,0)
 ;  SRC - v - vista, e - erx processing hub
"RTN","PSOERXU1",281,0)
 ;  TXT - error text
"RTN","PSOERXU1",282,0)
FILERR(IENS,SEQ,TYPE,SRC,TXT) ;
"RTN","PSOERXU1",283,0)
 N FDA
"RTN","PSOERXU1",284,0)
 S FDA(52.49101,"+1,"_IENS,.01)=SEQ
"RTN","PSOERXU1",285,0)
 S FDA(52.49101,"+1,"_IENS,.02)=TYPE
"RTN","PSOERXU1",286,0)
 S FDA(52.49101,"+1,"_IENS,.03)=SRC
"RTN","PSOERXU1",287,0)
 ; all new errors are set to pending
"RTN","PSOERXU1",288,0)
 S FDA(52.49101,"+1,"_IENS,.04)="P"
"RTN","PSOERXU1",289,0)
 S FDA(52.49101,"+1,"_IENS,1)=TXT
"RTN","PSOERXU1",290,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXU1",291,0)
 ; now set the eRx entry status to error
"RTN","PSOERXU1",292,0)
 ;S FDA(52.49,IENS,1)=$O(^PS(52.45,"C","ERX","E",0)) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXU1",293,0)
 Q
"RTN","PSOERXU1",294,0)
MSGDIR(MSG) ;
"RTN","PSOERXU1",295,0)
 N DIR,MLOOP,MTXT
"RTN","PSOERXU1",296,0)
 S VALMBCK="R"
"RTN","PSOERXU1",297,0)
 D FULL^VALM1
"RTN","PSOERXU1",298,0)
 W !!,"Errors encountered during processing:",!
"RTN","PSOERXU1",299,0)
 S MLOOP=0 F  S MLOOP=$O(MSG(MLOOP)) Q:'MLOOP  D
"RTN","PSOERXU1",300,0)
 .S MTXT=$G(MSG(MLOOP)) W !,MLOOP_".) ",MTXT
"RTN","PSOERXU1",301,0)
 W !!,"Cannot process eRx.",!
"RTN","PSOERXU1",302,0)
 S DIR(0)="E" D ^DIR
"RTN","PSOERXU1",303,0)
 Q
"RTN","PSOERXU1",304,0)
 ; provider change screen on refill response
"RTN","PSOERXU1",305,0)
CHPRCHG(ERXIEN) ;
"RTN","PSOERXU1",306,0)
 N REQIEN,RESIEN,DELTA,MTYPE,RESVAL,MSTAT
"RTN","PSOERXU1",307,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERXU1",308,0)
 S MSTAT=$$GET1^DIQ(52.49,ERXIEN,1,"E")
"RTN","PSOERXU1",309,0)
 S RESVAL=$$GET1^DIQ(52.49,ERXIEN,52.1,"I")
"RTN","PSOERXU1",310,0)
 I MTYPE="RE",((RESVAL="D")!(RESVAL="DNP")) Q 0
"RTN","PSOERXU1",311,0)
 I MTYPE="RR"!(MTYPE="CA")!(MTYPE="CN")!(MTYPE="IE") Q 0
"RTN","PSOERXU1",312,0)
 I MTYPE'="RE" Q 1
"RTN","PSOERXU1",313,0)
 I MTYPE="RE",MSTAT="RXW" Q 1
"RTN","PSOERXU1",314,0)
 I RESVAL'="AWC",MTYPE="RE",",RXP,RXC,RXD,"[MSTAT Q 0
"RTN","PSOERXU1",315,0)
 I MTYPE="RE",($$GET1^DIQ(52.49,ERXIEN,52.1,"I")'["A") Q 0
"RTN","PSOERXU1",316,0)
 S RESIEN=ERXIEN,REQIEN=$$GETREQ^PSOERXU2(ERXIEN)
"RTN","PSOERXU1",317,0)
 D RRDELTA^PSOERXU2(.DELTA,REQIEN,RESIEN) Q:'$D(DELTA) 0
"RTN","PSOERXU1",318,0)
 I $D(DELTA(52.49,"EXTERNAL PROVIDER")) Q 1
"RTN","PSOERXU1",319,0)
 Q 0
"RTN","PSOERXU1",320,0)
 ;/BLB/ PSO*7.0*520 -BEGIN CHANGE- ALLERGY INFO
"RTN","PSOERXU1",321,0)
ALG(LINE) ;
"RTN","PSOERXU1",322,0)
 N ALGINFO,ALGLINE,DFN,IEN,X,LDAT,GMRAL,PSONOAL
"RTN","PSOERXU1",323,0)
 S ALGLINE=""
"RTN","PSOERXU1",324,0)
 S DFN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXU1",325,0)
 D EN1^GMRADPT
"RTN","PSOERXU1",326,0)
 S IEN=1
"RTN","PSOERXU1",327,0)
 I 'GMRAL D
"RTN","PSOERXU1",328,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Allergies: "_$S(GMRAL=0:"NKA",1:"")
"RTN","PSOERXU1",329,0)
 .I GMRAL'=0 S PSONOAL="" D ALLERGY^PSOORUT2 I PSONOAL'="" S ^TMP("PSOPI",$J,IEN,0)="Allergies: "_PSONOAL K PSONOAL
"RTN","PSOERXU1",330,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOERXU1",331,0)
 .D REMOTE^PSOORUT2
"RTN","PSOERXU1",332,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Adverse Reactions:"
"RTN","PSOERXU1",333,0)
 D:$G(GMRAL) ^PSOORUT3
"RTN","PSOERXU1",334,0)
 S LINE=LINE+1
"RTN","PSOERXU1",335,0)
 S X=0 F  S X=$O(^TMP("PSOPI",$J,X)) Q:'X  D
"RTN","PSOERXU1",336,0)
 .S LDAT=$G(^TMP("PSOPI",$J,X,0))
"RTN","PSOERXU1",337,0)
 .S LINE=LINE+1
"RTN","PSOERXU1",338,0)
 .D SET^VALM10(LINE,LDAT)
"RTN","PSOERXU1",339,0)
 K ^TMP("PSOPI",$J)
"RTN","PSOERXU1",340,0)
 Q
"RTN","PSOERXU1",341,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXU4")
0^10^B68679574^B33741259
"RTN","PSOERXU4",1,0)
PSOERXU4 ;ALB/BLB - eRx utilities ; 2/21/2018 4:00pm
"RTN","PSOERXU4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**520,508,551**;DEC 1997;Build 37
"RTN","PSOERXU4",3,0)
 ;
"RTN","PSOERXU4",4,0)
 Q
"RTN","PSOERXU4",5,0)
DERX1(PSOIEN,PSOIENS,DFLAG) ;
"RTN","PSOERXU4",6,0)
 N EDRG,ERXDAT,ESIG,COMM,SUBS,DFORM,DSTR,QQUAL,POTUC,QTY,DAYS,REFILL,COMMARY,SIGARY,ERXRFLS,I,ERXDSUB
"RTN","PSOERXU4",7,0)
 D GETS^DIQ(52.49,PSOIENS,"3.1;4.6;4.8;5.1;5.2;5.4;5.5;5.6;5.7;5.8;7;8;41;42;43","E","ERXDAT")
"RTN","PSOERXU4",8,0)
 S DFLG=$G(DFLG,"")
"RTN","PSOERXU4",9,0)
 S EDRG=$G(ERXDAT(52.49,PSOIENS,3.1,"E"))
"RTN","PSOERXU4",10,0)
 S ESIG=$G(ERXDAT(52.49,PSOIENS,7,"E"))
"RTN","PSOERXU4",11,0)
 S COMM=$G(ERXDAT(52.49,PSOIENS,8,"E"))
"RTN","PSOERXU4",12,0)
 S SUBS=$G(ERXDAT(52.49,PSOIENS,5.8,"E"))
"RTN","PSOERXU4",13,0)
 S DFORM=$G(ERXDAT(52.49,PSOIENS,41,"E"))
"RTN","PSOERXU4",14,0)
 S DSTR=$G(ERXDAT(52.49,PSOIENS,43,"E"))
"RTN","PSOERXU4",15,0)
 S QQUAL=$G(ERXDAT(52.49,PSOIENS,5.2,"E"))
"RTN","PSOERXU4",16,0)
 S POTUC=$G(ERXDAT(52.49,PSOIENS,42,"E"))
"RTN","PSOERXU4",17,0)
 S QTY=$G(ERXDAT(52.49,PSOIENS,5.1,"E"))
"RTN","PSOERXU4",18,0)
 S DAYS=$G(ERXDAT(52.49,PSOIENS,5.5,"E"))
"RTN","PSOERXU4",19,0)
 S REFILL=$G(ERXDAT(52.49,PSOIENS,5.6,"E"))
"RTN","PSOERXU4",20,0)
 I REFILL="" D
"RTN","PSOERXU4",21,0)
 .S REFILL=$G(ERXDAT(52.49,PSOIENS,5.7,"I"))
"RTN","PSOERXU4",22,0)
 D TXT2ARY^PSOERXD1(.SIGARY,ESIG,,69)
"RTN","PSOERXU4",23,0)
 D TXT2ARY^PSOERXD1(.COMMARY,COMM,,65)
"RTN","PSOERXU4",24,0)
 W !!!,"eRx Drug: "_EDRG
"RTN","PSOERXU4",25,0)
 W !,"eRx Sig: "
"RTN","PSOERXU4",26,0)
 S I=0 F  S I=$O(SIGARY(I)) Q:'I  D
"RTN","PSOERXU4",27,0)
 .W $S(I>1:"         "_SIGARY(I),1:SIGARY(I)),!
"RTN","PSOERXU4",28,0)
 I '$L(ESIG) W !
"RTN","PSOERXU4",29,0)
 W "eRx Notes: "
"RTN","PSOERXU4",30,0)
 S I=0 F  S I=$O(COMMARY(I)) Q:'I  D
"RTN","PSOERXU4",31,0)
 .W $S(I>1:"              "_COMMARY(I),1:COMMARY(I)),!
"RTN","PSOERXU4",32,0)
 I '$L(COMM) W !
"RTN","PSOERXU4",33,0)
 Q:DFLG=1
"RTN","PSOERXU4",34,0)
 W "Drug Form: "_DFORM,?40,"Strength: "_DSTR
"RTN","PSOERXU4",35,0)
 ;/BLB/ PSO *7.0*551 - BEGIN CHANGE - CORRECTING QTY QUAL TO CODE LIST QUAL
"RTN","PSOERXU4",36,0)
 W !,"Code List Qualifier: "_QQUAL,?40,"Potency Unit Code: "_POTUC
"RTN","PSOERXU4",37,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXU4",38,0)
 ;/BLB/PSO*7.0*551 - BEGIN CHANGE - ADDING SUBSTITUTION TEXT
"RTN","PSOERXU4",39,0)
 S ERXDSUB=$$GET1^DIQ(52.49,PSOIEN,5.8,"I")
"RTN","PSOERXU4",40,0)
 S ERXDSUB=$S(ERXDSUB=1:"NO",ERXDSUB=0:"YES",1:"")
"RTN","PSOERXU4",41,0)
 W !,"Substitutions? :"_ERXDSUB
"RTN","PSOERXU4",42,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXU4",43,0)
 W !,"Qty: "_QTY,?25,"Days Supply: "_DAYS,?55,"Refills: "_REFILL,!!
"RTN","PSOERXU4",44,0)
 Q
"RTN","PSOERXU4",45,0)
REM ;
"RTN","PSOERXU4",46,0)
 N DIR,Y,PSSRET,PSOIENS,REMIEN,REMSTA,REMTXT,ERXRMIEN,DIC,X,RXSTAT
"RTN","PSOERXU4",47,0)
 D FULL^VALM1
"RTN","PSOERXU4",48,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERXU4",49,0)
 S VALMBCK="R"
"RTN","PSOERXU4",50,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERXU4",51,0)
 .W !!,"Cannot remove a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERXU4",52,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERXU4",53,0)
 S DIR(0)="YO",DIR("A")="Would you like to 'Remove' eRx #"_$$GET1^DIQ(52.49,PSOIEN,.01,"E"),DIR("B")="Y" D ^DIR K DIR
"RTN","PSOERXU4",54,0)
 Q:'Y
"RTN","PSOERXU4",55,0)
 S DIC="^PS(52.45,",DIC(0)="AEMQ",DIC("S")="I $D(^PS(52.45,""TYPE"",""REM"",Y))",DIC("A")="Select REMOVAL reason code: "
"RTN","PSOERXU4",56,0)
 D ^DIC K DIC
"RTN","PSOERXU4",57,0)
 I $P(Y,U)<1 W !,"Removal reason code required!" S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXU4",58,0)
 S REMIEN=$P(Y,U),REMSTA=$P(Y,U,2)
"RTN","PSOERXU4",59,0)
 K X,Y S DIR(0)="FO^1:70",DIR("A")="Additional Comments (Optional)" D ^DIR K DIR
"RTN","PSOERXU4",60,0)
 Q:Y="^"
"RTN","PSOERXU4",61,0)
 S REMTXT=Y
"RTN","PSOERXU4",62,0)
 S FDA(52.4919,"+1,"_PSOIENS,.01)=$$NOW^XLFDT,FDA(52.4919,"+1,"_PSOIENS,.02)=REMIEN
"RTN","PSOERXU4",63,0)
 S FDA(52.4919,"+1,"_PSOIENS,.03)=DUZ,FDA(52.4919,"+1,"_PSOIENS,1)=REMTXT
"RTN","PSOERXU4",64,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXU4",65,0)
 ; SET THE ERX STATUS TO THE REMOVAL REASON
"RTN","PSOERXU4",66,0)
 D UPDSTAT^PSOERXU1(PSOIEN,"RM")
"RTN","PSOERXU4",67,0)
 Q
"RTN","PSOERXU4",68,0)
 ; reject eRx
"RTN","PSOERXU4",69,0)
REJ ;
"RTN","PSOERXU4",70,0)
 N DIR,DIC,Y,PSSRET,PSOIENS,REMTXT,REJSTA,FULLTXT,ERXRJIEN,REJDESC,REJIEN,REJTXT,X,RXSTAT
"RTN","PSOERXU4",71,0)
 D FULL^VALM1
"RTN","PSOERXU4",72,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERXU4",73,0)
 S VALMBCK="R"
"RTN","PSOERXU4",74,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERXU4",75,0)
 .W !!,"Cannot reject a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERXU4",76,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERXU4",77,0)
 S DIR(0)="YO",DIR("A")="Would you like to 'Reject' eRx #"_$$GET1^DIQ(52.49,PSOIEN,.01,"E"),DIR("B")="Y" D ^DIR K DIR
"RTN","PSOERXU4",78,0)
 Q:'Y
"RTN","PSOERXU4",79,0)
 S DIC="^PS(52.45,",DIC(0)="AEMQ",DIC("S")="I $D(^PS(52.45,""TYPE"",""REJ"",Y))",DIC("A")="Select REJECT reason code: "
"RTN","PSOERXU4",80,0)
 D ^DIC K DIC
"RTN","PSOERXU4",81,0)
 I $P(Y,U)<1 W !,"Reject reason required! eRx NOT rejected." S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXU4",82,0)
 S REJIEN=$P(Y,U),REJSTA=$P(Y,U,2)
"RTN","PSOERXU4",83,0)
 K X,Y,DIR
"RTN","PSOERXU4",84,0)
 S DIR(0)="FO^1:70",DIR("A")="Additional Comments (Optional)" D ^DIR K DIR
"RTN","PSOERXU4",85,0)
 Q:Y="^"
"RTN","PSOERXU4",86,0)
 ; if reject reason was entered, log the activity.
"RTN","PSOERXU4",87,0)
 S REJTXT=Y
"RTN","PSOERXU4",88,0)
 S REJDESC=$$GET1^DIQ(52.45,REJIEN,.02,"E")
"RTN","PSOERXU4",89,0)
 S FULLTXT=REJSTA_"-"_REJDESC
"RTN","PSOERXU4",90,0)
 D POST^PSOERXO1(PSOIEN,.PSSRET,900,"",$E(FULLTXT,1,70))
"RTN","PSOERXU4",91,0)
 ; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERXU4",92,0)
 I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXU4",93,0)
 I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERXU4",94,0)
 W !!,"Rejection message sent." S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERXU4",95,0)
 ; if post is successful, change the eRx status and log the status activity.
"RTN","PSOERXU4",96,0)
 S FDA(52.4919,"+1,"_PSOIENS,.01)=$$NOW^XLFDT
"RTN","PSOERXU4",97,0)
 S FDA(52.4919,"+1,"_PSOIENS,.02)=REJIEN
"RTN","PSOERXU4",98,0)
 S FDA(52.4919,"+1,"_PSOIENS,.03)=DUZ
"RTN","PSOERXU4",99,0)
 S FDA(52.4919,"+1,"_PSOIENS,1)=REJTXT
"RTN","PSOERXU4",100,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERXU4",101,0)
 ; SET THE ERX STATUS TO THE REJECT REASON
"RTN","PSOERXU4",102,0)
 D UPDSTAT^PSOERXU1(PSOIEN,"RJ")
"RTN","PSOERXU4",103,0)
 Q
"RTN","PSOERXU4",104,0)
 ;/BLB/ - BEGIN CHANGE - EDIT IN VD
"RTN","PSOERXU4",105,0)
QTYDSRFL(ERXIEN,EDTYP) ;
"RTN","PSOERXU4",106,0)
 ; ERXIEN - ien from 52.49
"RTN","PSOERXU4",107,0)
 ; EDTYP:
"RTN","PSOERXU4",108,0)
 ;        1 - DAYS SUPPLY
"RTN","PSOERXU4",109,0)
 ;        2 - QUANTITY
"RTN","PSOERXU4",110,0)
 ;        3 - REFILLS
"RTN","PSOERXU4",111,0)
 ;        4 - SCHEDULE/DOSAGE EDIT
"RTN","PSOERXU4",112,0)
 N PSODRUG,PSODIR,ERXDRUG,PSODFN,ERXIENS,FDA,CLOZPAT,PSOY,PATSTAT,Y,DONE,DIR,ANS,NWDAYSUP,NEWQTY
"RTN","PSOERXU4",113,0)
 S ERXIENS=ERXIEN_","
"RTN","PSOERXU4",114,0)
 ; setup drug array
"RTN","PSOERXU4",115,0)
 S ERXDRUG=$$GET1^DIQ(52.49,ERXIEN,3.2,"I") Q:'ERXDRUG 0
"RTN","PSOERXU4",116,0)
 S PSOY=ERXDRUG,PSOY(0)=$G(^PSDRUG(ERXDRUG,0))
"RTN","PSOERXU4",117,0)
 D SET^PSODRG
"RTN","PSOERXU4",118,0)
 S PSODRG=ERXDRUG
"RTN","PSOERXU4",119,0)
 ; set quanity, days supply, refill, and patient information
"RTN","PSOERXU4",120,0)
 S PSODFN=$$GET1^DIQ(52.49,ERXIEN,.05,"I")
"RTN","PSOERXU4",121,0)
 S PSODIR("QTY")=$$GET1^DIQ(52.49,ERXIEN,20.1,"E")
"RTN","PSOERXU4",122,0)
 S PSODIR("DAYS SUPPLY")=$$GET1^DIQ(52.49,ERXIEN,20.2,"E")
"RTN","PSOERXU4",123,0)
 S PSODIR("# OF REFILLS")=$$GET1^DIQ(52.49,ERXIEN,20.5,"E")
"RTN","PSOERXU4",124,0)
 ;S PSODIR("PATIENT STATUS")=$P(^PS(55,PSODFN,"PS"),U)
"RTN","PSOERXU4",125,0)
 S PSODIR("DFLG")=0
"RTN","PSOERXU4",126,0)
 S PATSTAT=$$GET1^DIQ(55,PSODFN,3,"E")
"RTN","PSOERXU4",127,0)
 I '$L(PATSTAT) D
"RTN","PSOERXU4",128,0)
 .S DONE=0
"RTN","PSOERXU4",129,0)
 .F  D  Q:DONE
"RTN","PSOERXU4",130,0)
 ..W !,"This is a required response. Enter '^' to exit"
"RTN","PSOERXU4",131,0)
 ..S DIR(0)="55,3",DIR("A")="PATIENT STATUS" D ^DIR K DIR
"RTN","PSOERXU4",132,0)
 ..I +Y S DONE=1 Q
"RTN","PSOERXU4",133,0)
 ..I Y["^" S PQUIT=1,DONE=1 Q
"RTN","PSOERXU4",134,0)
 .S ANS=$P(Y,"^",1)
"RTN","PSOERXU4",135,0)
 .S FDA(55,PSODFN_",",3)=ANS
"RTN","PSOERXU4",136,0)
 .D FILE^DIE(,"FDA","ERR") K FDA,ERR
"RTN","PSOERXU4",137,0)
 ; /BLB/ PSO*7.0*551 - BEGIN CHANGE- CLOZAPINE DATA UPDATE
"RTN","PSOERXU4",138,0)
 S PSODIR("PATIENT STATUS")=$P(^PS(55,PSODFN,"PS"),U)
"RTN","PSOERXU4",139,0)
 S X=$G(PSODIR("PATIENT STATUS"))
"RTN","PSOERXU4",140,0)
 I X D
"RTN","PSOERXU4",141,0)
 .S DIC=53,DIC(0)="QXZ" D ^DIC K DIC
"RTN","PSOERXU4",142,0)
 .S:+Y PSODIR("PTST NODE")=Y(0)
"RTN","PSOERXU4",143,0)
 ; BWF 2/1/19 -  MAKE SURE NO OTHER ITEMS ARE SETTING OR MESSING WITH PSODIR("PATIENT STATUS") OR PSODIR("PTST NODE")
"RTN","PSOERXU4",144,0)
 I $P($G(^PSDRUG(PSODRG,"CLOZ1")),"^")="PSOCLO1" D
"RTN","PSOERXU4",145,0)
 .S CLOZPAT=$O(^YSCL(603.01,"C",PSODFN,0)) Q:'CLOZPAT
"RTN","PSOERXU4",146,0)
 .S CLOZPAT=$P(^YSCL(603.01,CLOZPAT,0),"^",3)
"RTN","PSOERXU4",147,0)
 .S CLOZPAT=$S(CLOZPAT="M":2,CLOZPAT="B":1,1:0)
"RTN","PSOERXU4",148,0)
 ; /BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXU4",149,0)
 ; once called, PSODIR will be updated with the appropriate information 
"RTN","PSOERXU4",150,0)
 ;(refills/days supply/quantity)
"RTN","PSOERXU4",151,0)
 ;/BLB/ PSO*7.0*551 BEGIN CHANGE - QTY/DS/RFL AUTO-CALCULATION
"RTN","PSOERXU4",152,0)
 I EDTYP=1 S NWDAYSUP=$$DAYSCHK(.PSODRUG,.PSODIR) D
"RTN","PSOERXU4",153,0)
 .I $G(NWDAYSUP) S PSODIR("DAYS SUPPLY")=NWDAYSUP
"RTN","PSOERXU4",154,0)
 .I PSODIR("DAYS SUPPLY")>$P($G(PSODIR("PTST NODE")),"^",3) S PSODIR("DAYS SUPPLY")=$P($G(PSODIR("PTST NODE")),"^",3)
"RTN","PSOERXU4",155,0)
 .D DAYS^PSODIR1(.PSODIR) D FILE
"RTN","PSOERXU4",156,0)
 .K QTYDSRFL
"RTN","PSOERXU4",157,0)
 I EDTYP=2 S PSONEW("FLD")=7 D
"RTN","PSOERXU4",158,0)
 .S NEWQTY=$$QTYCHECK,PSODIR("QTY")=NEWQTY
"RTN","PSOERXU4",159,0)
 .;I '$$GET1^DIQ(52.49,PSOIEN,20.1) S PSODIR("QTY")=$$GET1^DIQ(52.49,PSOIEN,5.5,"E")
"RTN","PSOERXU4",160,0)
 .D QTY^PSODIR1(.PSODIR),FILE
"RTN","PSOERXU4",161,0)
 .K QTYARY
"RTN","PSOERXU4",162,0)
 I EDTYP=3 S PSONEW("FLD")=9 D REFILL^PSODIR1(.PSODIR)
"RTN","PSOERXU4",163,0)
 I $G(PSODIR("DFLG"))=1 Q 1
"RTN","PSOERXU4",164,0)
 S QTYDSRFL("QTY")=$G(PSODIR("QTY"))
"RTN","PSOERXU4",165,0)
 D FILE
"RTN","PSOERXU4",166,0)
 Q 0
"RTN","PSOERXU4",167,0)
 ;/BLB/ ADDED FILE TAG TO FACILITATE IN QTY AUTO-CALCULATIONS
"RTN","PSOERXU4",168,0)
FILE ;
"RTN","PSOERXU4",169,0)
 S FDA(52.49,ERXIENS,20.1)=$G(PSODIR("QTY"))
"RTN","PSOERXU4",170,0)
 S FDA(52.49,ERXIENS,20.2)=$G(PSODIR("DAYS SUPPLY"))
"RTN","PSOERXU4",171,0)
 S FDA(52.49,ERXIENS,20.5)=$G(PSODIR("# OF REFILLS"))
"RTN","PSOERXU4",172,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXU4",173,0)
 Q
"RTN","PSOERXU4",174,0)
 ;/BLB/ - END CHANGE
"RTN","PSOERXU4",175,0)
DAYSCHK(PSODRUG,PSODIR) ; auto calculate days supply based off quantity.
"RTN","PSOERXU4",176,0)
 N QTYDSRFL,DAYSUP,I,ADUR,IENS
"RTN","PSOERXU4",177,0)
 S IENS=1_","_PSOIEN_","
"RTN","PSOERXU4",178,0)
 S QTYDSRFL("SCHEDULE")=$$GET1^DIQ(52.4921,IENS,1,"E")
"RTN","PSOERXU4",179,0)
 S QTYDSRFL("DOSE ORDERED")=$$GET1^DIQ(52.4921,IENS,9,"E")_"^" ;COMPLEX DOSING LIES IN THE SECOND PIECE OF THE DOSE ORDERED VALUE. FOR NOW, CONCATENATE A CARAT.
"RTN","PSOERXU4",180,0)
 I 'QTYDSRFL("DOSE ORDERED") Q 0
"RTN","PSOERXU4",181,0)
 S QTYDSRFL("DURATION")=$$GET1^DIQ(52.4921,IENS,2,"E")         ;ENHANCEMENTS FOR COMPLEX DOSING WILL REMOVE THE CONCATENATED CARAT AND PASS IN MULTIPLE PIECES.
"RTN","PSOERXU4",182,0)
 S QTYDSRFL("PATIENT")=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXU4",183,0)
 S QTYDSRFL("DRUG")=$G(PSODRUG("IEN"))
"RTN","PSOERXU4",184,0)
 S QTYDSRFL("QTY")=$G(PSODIR("QTY"))
"RTN","PSOERXU4",185,0)
 F I=1:1:$L(QTYDSRFL("DOSE ORDERED"),U)-1 D
"RTN","PSOERXU4",186,0)
 .S QTYDSRFL("DOSE ORDERED",I)=$P(QTYDSRFL("DOSE ORDERED"),U,I)
"RTN","PSOERXU4",187,0)
 .S QTYDSRFL("SCHEDULE",I)=$P(QTYDSRFL("SCHEDULE"),U,I)
"RTN","PSOERXU4",188,0)
 .S ADUR=$P(QTYDSRFL("DURATION"),U,I),X=+ADUR_$E($P(ADUR," ",2))
"RTN","PSOERXU4",189,0)
 .I $L(X) S QTYDSRFL("DURATION",I)=X
"RTN","PSOERXU4",190,0)
 .S X=$E($P(ADUR,"~",2))
"RTN","PSOERXU4",191,0)
 .I $L(X) S QTYDSRFL("CONJUNCTION",I)=X
"RTN","PSOERXU4",192,0)
 D QTYX^PSOSIG(.QTYDSRFL)
"RTN","PSOERXU4",193,0)
 S DAYSUP=$G(QTYDSRFL("DAYS SUPPLY"))
"RTN","PSOERXU4",194,0)
 Q DAYSUP
"RTN","PSOERXU4",195,0)
QTYCHECK(PSODRUG,PSODIR) ; return qty for days supply
"RTN","PSOERXU4",196,0)
 ; VAL: quantity
"RTN","PSOERXU4",197,0)
 N QTYARY,I,X,ADUR,ADURNM,IENS,VAL
"RTN","PSOERXU4",198,0)
 S IENS=1_","_PSOIEN_","
"RTN","PSOERXU4",199,0)
 S QTYARY("DOSE ORDERED")=$$GET1^DIQ(52.4921,IENS,9,"E")_"^"
"RTN","PSOERXU4",200,0)
 S QTYARY("DURATION")=$$GET1^DIQ(52.4921,IENS,2,"E")
"RTN","PSOERXU4",201,0)
 S QTYARY("SCHEDULE")=$$GET1^DIQ(52.4921,IENS,1,"E")
"RTN","PSOERXU4",202,0)
 S QTYARY("DAYS SUPPLY")=$$GET1^DIQ(52.49,ERXIEN,20.2,"E")
"RTN","PSOERXU4",203,0)
 S QTYARY("PATIENT")=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXU4",204,0)
 ;I $G(DRG) S QTYARY("DRUG")=DRG
"RTN","PSOERXU4",205,0)
 S QTYARY("DRUG")=$G(PSODRUG("IEN"))
"RTN","PSOERXU4",206,0)
 F I=1:1:$L(QTYARY("DOSE ORDERED"),U)-1 D
"RTN","PSOERXU4",207,0)
 . S QTYARY("DOSE ORDERED",I)=$P(QTYARY("DOSE ORDERED"),U,I)_"^"
"RTN","PSOERXU4",208,0)
 . S QTYARY("SCHEDULE",I)=$P(QTYARY("SCHEDULE"),U,I)
"RTN","PSOERXU4",209,0)
 . S ADUR=$P(QTYARY("DURATION"),U,I),ADURNM=$P($P(ADUR," ",2),"~")
"RTN","PSOERXU4",210,0)
 . S:ADURNM="MONTHS" X=+ADUR_"L"
"RTN","PSOERXU4",211,0)
 . S:ADURNM'="MONTHS" X=+ADUR_$E($P(ADUR," ",2))
"RTN","PSOERXU4",212,0)
 . I $L(X) S QTYARY("DURATION",I)=X
"RTN","PSOERXU4",213,0)
 . S X=$E($P(ADUR,"~",2))
"RTN","PSOERXU4",214,0)
 . I $L(X) S QTYARY("CONJUNCTION",I)=X
"RTN","PSOERXU4",215,0)
 D QTYX^PSOSIG(.QTYARY)
"RTN","PSOERXU4",216,0)
 S VAL=$G(QTYARY("QTY"))
"RTN","PSOERXU4",217,0)
 Q VAL
"RTN","PSOERXU4",218,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXU6")
0^11^B117656460^B111664391
"RTN","PSOERXU6",1,0)
PSOERXU6 ;ALB/BWF - eRx utilities ; 5/4/2018 9:57am
"RTN","PSOERXU6",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**508,551**;DEC 1997;Build 37
"RTN","PSOERXU6",3,0)
 ;
"RTN","PSOERXU6",4,0)
 Q
"RTN","PSOERXU6",5,0)
 ; auto discontinue orders related to cancel request
"RTN","PSOERXU6",6,0)
 ; ERXIEN is the IEN of the cancel request
"RTN","PSOERXU6",7,0)
CANDC(ERXIEN,INST,PSSRET) ;
"RTN","PSOERXU6",8,0)
 N NERXIEN,RXIEN,RELMIEN,NRXOPIEN,NRXPNIEN,REOPIEN,REPNIEN,ACOMACT,ACOMPEND,CANTYPE,NRXVPAT,CNT,ADAT,ARY,ALOOP,DONE
"RTN","PSOERXU6",9,0)
 N PENDIEN,RXIEN,PSSRET,PREVORD,RRRETYPE,RXFAIL,PENFAIL,ARESP,FORORD,PON,VARENEW,LSTMSG,RELIEN,SENDMSG,DELFLG,DELTXT
"RTN","PSOERXU6",10,0)
 S CNT=0
"RTN","PSOERXU6",11,0)
 S NERXIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU6",12,0)
 S NRXVPAT=$$GET1^DIQ(52.49,NERXIEN,.05,"I")
"RTN","PSOERXU6",13,0)
 S NRXOPIEN=$$GET1^DIQ(52.49,NERXIEN,.13,"I")
"RTN","PSOERXU6",14,0)
 S NRXPNIEN=$$GET1^DIQ(52.49,NERXIEN,25.2,"E")
"RTN","PSOERXU6",15,0)
 S CNT=CNT+1,ARY(CNT)=NRXPNIEN_U_NRXOPIEN
"RTN","PSOERXU6",16,0)
 S RELMIEN=0 F  S RELMIEN=$O(^PS(52.49,NERXIEN,201,"B",RELMIEN)) Q:'RELMIEN  D
"RTN","PSOERXU6",17,0)
 .Q:$$GET1^DIQ(52.49,RELMIEN,.08,"I")'="RE"
"RTN","PSOERXU6",18,0)
 .S REOPIEN=$$GET1^DIQ(52.49,RELMIEN,.13,"I")
"RTN","PSOERXU6",19,0)
 .S REPNIEN=$$GET1^DIQ(52.49,RELMIEN,25.2,"E")
"RTN","PSOERXU6",20,0)
 .S CNT=CNT+1,ARY(CNT)=REPNIEN_U_REOPIEN_U_RELMIEN
"RTN","PSOERXU6",21,0)
 ; if there is only one, it is the NewRx
"RTN","PSOERXU6",22,0)
 I CNT=1 D  Q
"RTN","PSOERXU6",23,0)
 .S ADAT=$G(ARY(CNT))
"RTN","PSOERXU6",24,0)
 .S PENDIEN=$P(ADAT,U),RXIEN=$P(ADAT,U,2)
"RTN","PSOERXU6",25,0)
 .; if there is an associated RXIEN, this is active and the pending item no longer exists.
"RTN","PSOERXU6",26,0)
 .I RXIEN D
"RTN","PSOERXU6",27,0)
 ..S ACOMACT=$$CANACT(ERXIEN,RXIEN,INST,.PSSRET)
"RTN","PSOERXU6",28,0)
 ..S FORORD=$$GET1^DIQ(52,RXIEN,39.5,"I")
"RTN","PSOERXU6",29,0)
 ..I FORORD S PON=$$GET1^DIQ(52,FORORD,39.3,"I")
"RTN","PSOERXU6",30,0)
 ..I FORORD,'$$CHKERX^PSOERXU1(FORORD) S VARENEW=1
"RTN","PSOERXU6",31,0)
 .I 'RXIEN,PENDIEN D
"RTN","PSOERXU6",32,0)
 ..I $$GET1^DIQ(52.41,PENDIEN,1,"I")'=NRXVPAT S DONE=1 Q
"RTN","PSOERXU6",33,0)
 ..S ACOMPEND=$$CANPEND(ERXIEN,PENDIEN,INST,.PSSRET)
"RTN","PSOERXU6",34,0)
 .; if either failed, update the status and do not send the response
"RTN","PSOERXU6",35,0)
 .Q:$G(DONE)
"RTN","PSOERXU6",36,0)
 .I $D(ACOMACT),'$P(ACOMACT,U) S RXFAIL=1
"RTN","PSOERXU6",37,0)
 .I $D(ACOMPEND),'$P(ACOMPEND,U) S PENFAIL=1
"RTN","PSOERXU6",38,0)
 .I $G(RXFAIL)!($G(PENFAIL))!($P($G(ACOMACT),U)=2) D  Q
"RTN","PSOERXU6",39,0)
 ..I $G(RXFAIL)!($P($G(ACOMACT),U)=2) S ARESP=$P(ACOMACT,U,2)
"RTN","PSOERXU6",40,0)
 ..I $G(PENFAIL),'$D(ARESP) S ARESP=$P($G(ACOMPEND),U,2)
"RTN","PSOERXU6",41,0)
 ..D UPDSTAT^PSOERXU1(NERXIEN,"CAN",$G(ARESP))
"RTN","PSOERXU6",42,0)
 ..; if this is a 'deleted' rx, update the status, cancel all related and quit.
"RTN","PSOERXU6",43,0)
 ..I $P($G(ACOMACT),U)=2 D  Q
"RTN","PSOERXU6",44,0)
 ...D UPDSTAT^PSOERXU1(ERXIEN,"CAH",$P($G(ACOMACT),U,2)),CANRELHQ(NERXIEN) Q
"RTN","PSOERXU6",45,0)
 ..D UPDSTAT^PSOERXU1(ERXIEN,"CAF",ARESP)
"RTN","PSOERXU6",46,0)
 ..D CANRELHQ(NERXIEN)
"RTN","PSOERXU6",47,0)
 .I $D(ACOMACT),$P(ACOMACT,U) S ARESP=$P(ACOMACT,U,2)
"RTN","PSOERXU6",48,0)
 .I '$L($G(ARESP)),$D(ACOMPEND),$P(ACOMPEND,U) S ARESP=$P(ACOMPEND,U,2)
"RTN","PSOERXU6",49,0)
 .; only send the automated response if the auto-dc was successful, and the rx status is not deleted
"RTN","PSOERXU6",50,0)
 .I '$G(VARENEW) D POST^PSOERXO1(ERXIEN,.PSSRET,,,,3,INST,ARESP)
"RTN","PSOERXU6",51,0)
 .; if there was an error, cancel the related items and quit. we do not want to override the CAX status
"RTN","PSOERXU6",52,0)
 .I $D(PSSRET("errorMessage")) D CANRELHQ(NERXIEN),UPDSTAT^PSOERXU1(NERXIEN,"CAN",ARESP) Q
"RTN","PSOERXU6",53,0)
 .I RXIEN,$$VARENEW(RXIEN) D  Q
"RTN","PSOERXU6",54,0)
 ..D UPDSTAT^PSOERXU1(NERXIEN,"CAN","eRx was renewed within the VA.")
"RTN","PSOERXU6",55,0)
 ..D UPDSTAT^PSOERXU1(ERXIEN,"CAH","eRx was renewed within the VA.")
"RTN","PSOERXU6",56,0)
 ..D CANRELHQ(NERXIEN)
"RTN","PSOERXU6",57,0)
 .D UPDSTAT^PSOERXU1(NERXIEN,"CAN",ARESP)
"RTN","PSOERXU6",58,0)
 .I '$G(FORORD) D UPDSTAT^PSOERXU1(ERXIEN,"CAO",$G(ARESP))
"RTN","PSOERXU6",59,0)
 .I $G(FORORD) D UPDSTAT^PSOERXU1(ERXIEN,"CAH",$G(ARESP))
"RTN","PSOERXU6",60,0)
 .D CANRELHQ(NERXIEN)
"RTN","PSOERXU6",61,0)
 ; if there is more than one, renewals have occured.
"RTN","PSOERXU6",62,0)
 S ALOOP=99999,DONE=0
"RTN","PSOERXU6",63,0)
 F  S ALOOP=$O(ARY(ALOOP),-1) Q:'ALOOP!(DONE)  D
"RTN","PSOERXU6",64,0)
 .S ADAT=$G(ARY(ALOOP))
"RTN","PSOERXU6",65,0)
 .; if there is a pending IEN and no RX IEN, we know this has not yet been processed into a live prescription
"RTN","PSOERXU6",66,0)
 .; and is a renwewal from a previous prescription.
"RTN","PSOERXU6",67,0)
 .S PENDIEN=$P(ADAT,U),RXIEN=$P(ADAT,U,2),RELIEN=$P(ADAT,U,3)
"RTN","PSOERXU6",68,0)
 .I RXIEN D  Q
"RTN","PSOERXU6",69,0)
 ..I $G(PENDIEN),$$GET1^DIQ(52.41,PENDIEN,1,"I")=NRXVPAT D  Q
"RTN","PSOERXU6",70,0)
 ...S ACOMPEND(ALOOP)=$$CANPEND(ERXIEN,PENDIEN,INST,.PSSRET)
"RTN","PSOERXU6",71,0)
 ...S ACOMACT(ALOOP)=$$CANACT(ERXIEN,RXIEN,INST,.PSSRET)
"RTN","PSOERXU6",72,0)
 ...S FORORD=$$GET1^DIQ(52,RXIEN,39.5,"I")
"RTN","PSOERXU6",73,0)
 ...I FORORD S PON=$$GET1^DIQ(52,FORORD,39.3,"I")
"RTN","PSOERXU6",74,0)
 ...I FORORD,'$$CHKERX^PSOERXU1(PON) S VARENEW=1
"RTN","PSOERXU6",75,0)
 ..S ACOMACT(ALOOP)=$$CANACT(ERXIEN,RXIEN,INST,.PSSRET)
"RTN","PSOERXU6",76,0)
 .I PENDIEN,'RXIEN D  Q
"RTN","PSOERXU6",77,0)
 ..; if this pending item is not for the right patient, quit
"RTN","PSOERXU6",78,0)
 ..I $G(PENDIEN),$$GET1^DIQ(52.41,PENDIEN,1,"I")'=NRXVPAT S DONE=1 Q
"RTN","PSOERXU6",79,0)
 ..S PREVORD=$$GET1^DIQ(52.41,PENDIEN,22.1,"E")
"RTN","PSOERXU6",80,0)
 ..I '$G(PREVORD) D  Q
"RTN","PSOERXU6",81,0)
 ...S ACOMPEND(ALOOP)=$$CANPEND(ERXIEN,PENDIEN,INST,.PSSRET)
"RTN","PSOERXU6",82,0)
 ..S ACOMPEND(ALOOP)=$$CANPEND(ERXIEN,PENDIEN,INST,.PSSRET)
"RTN","PSOERXU6",83,0)
 ..S ACOMACT(ALOOP)=$$CANACT(ERXIEN,PREVORD,INST,.PSSRET)
"RTN","PSOERXU6",84,0)
 ; now check all results for failures
"RTN","PSOERXU6",85,0)
 N ACTLP,ACTFL,ACTMSG,PENLP,PENFL,PENMSG
"RTN","PSOERXU6",86,0)
 S (ACTLP,ACTFL)=0 F  S ACTLP=$O(ACOMACT(ACTLP)) Q:'ACTLP  D
"RTN","PSOERXU6",87,0)
 .I $P(ACOMACT(ACTLP),U)=0 S ACTFL=ACTFL+1
"RTN","PSOERXU6",88,0)
 .I $P(ACOMACT(ACTLP),U)=1 S ACTMSG(ACTFL)=$P(ACOMACT(ACTLP),U,2)
"RTN","PSOERXU6",89,0)
 .I $P(ACOMACT(ACTLP),U)=2 S DELFLG=1,DELTXT=$P(ACOMACT(ACTLP),U,2)
"RTN","PSOERXU6",90,0)
 S (PENLP,PENFL)=0 F  S PENLP=$O(ACOMPEND(PENLP)) Q:'PENLP  D
"RTN","PSOERXU6",91,0)
 .I $P(ACOMPEND(PENLP),U)=0 S PENFL=PENFL+1
"RTN","PSOERXU6",92,0)
 .I $P(ACOMPEND(PENLP),U)=1 S PENMSG(PENFL)=$P(ACOMPEND(PENLP),U,2)
"RTN","PSOERXU6",93,0)
 I $G(DELFLG) D  Q
"RTN","PSOERXU6",94,0)
 .D UPDSTAT^PSOERXU1(NERXIEN,"CAN",DELTXT)
"RTN","PSOERXU6",95,0)
 .D UPDSTAT^PSOERXU1(ERXIEN,"CAH",DELTXT)
"RTN","PSOERXU6",96,0)
 .D CANRELHQ(NERXIEN)
"RTN","PSOERXU6",97,0)
 I ACTFL>0!(PENFL>0) D  Q
"RTN","PSOERXU6",98,0)
 .D UPDSTAT^PSOERXU1(NERXIEN,"CAN")
"RTN","PSOERXU6",99,0)
 .D UPDSTAT^PSOERXU1(ERXIEN,"CAF")
"RTN","PSOERXU6",100,0)
 .D CANRELHQ(NERXIEN)
"RTN","PSOERXU6",101,0)
 ; get the last active rx status
"RTN","PSOERXU6",102,0)
 I $D(ACTMSG) D
"RTN","PSOERXU6",103,0)
 .S LSTMSG=$O(ACTMSG(99999),-1)
"RTN","PSOERXU6",104,0)
 .S SENDMSG=$G(ACTMSG(LSTMSG))
"RTN","PSOERXU6",105,0)
 I '$D(SENDMSG) D
"RTN","PSOERXU6",106,0)
 .S LSTMSG=$O(PENMSG(99999),-1)
"RTN","PSOERXU6",107,0)
 .S SENDMSG=$G(PENMSG(LSTMSG))
"RTN","PSOERXU6",108,0)
 I '$G(VARENEW) D POST^PSOERXO1(ERXIEN,.PSSRET,,,,3,INST,SENDMSG)
"RTN","PSOERXU6",109,0)
 I $G(VARENEW) D UPDSTAT^PSOERXU1(NERXIEN,"CAN","eRx was renewed within the VA.")
"RTN","PSOERXU6",110,0)
 I '$G(VARENEW) D UPDSTAT^PSOERXU1(NERXIEN,"CAN",$G(SENDMSG))
"RTN","PSOERXU6",111,0)
 ; if there was an error, cancel the related items and quit. we do not want to override the CAX status
"RTN","PSOERXU6",112,0)
 I $D(PSSRET("errorMessage")) D CANRELHQ(NERXIEN) Q 
"RTN","PSOERXU6",113,0)
 I '$G(VARENEW) D UPDSTAT^PSOERXU1(ERXIEN,"CAO")
"RTN","PSOERXU6",114,0)
 I $G(VARENEW) D UPDSTAT^PSOERXU1(ERXIEN,"CAH","eRx was renewed within the VA.")
"RTN","PSOERXU6",115,0)
 D CANRELHQ(NERXIEN)
"RTN","PSOERXU6",116,0)
 Q
"RTN","PSOERXU6",117,0)
CANRELHQ(NERXIEN) ;
"RTN","PSOERXU6",118,0)
 N RELMIEN,RRRETYPE
"RTN","PSOERXU6",119,0)
 ;I $$GET1^DIQ(52.49,NERXIEN,1,"E")'="CAN" Q
"RTN","PSOERXU6",120,0)
 S RELMIEN=0 F  S RELMIEN=$O(^PS(52.49,NERXIEN,201,"B",RELMIEN)) Q:'RELMIEN  D
"RTN","PSOERXU6",121,0)
 .S RRRETYPE=$$GET1^DIQ(52.49,RELMIEN,.08,"I")
"RTN","PSOERXU6",122,0)
 .I RRRETYPE="RE"!(RRRETYPE="RR") D
"RTN","PSOERXU6",123,0)
 ..D UPDSTAT^PSOERXU1(RELMIEN,"CAN")
"RTN","PSOERXU6",124,0)
 Q
"RTN","PSOERXU6",125,0)
CANACT(ERXIEN,RXIEN,INST,PSSRET) ;
"RTN","PSOERXU6",126,0)
 N NERXIEN,RXSTAT,UPDRXSTAT,ERXIENS,UPDRXSTA,PSOSITE,PSOSYS,PSODFN,ORN,PSOOPT,VALMSG
"RTN","PSOERXU6",127,0)
 S ERXIENS=ERXIEN_","
"RTN","PSOERXU6",128,0)
 S RXSTAT=$$GET1^DIQ(52,RXIEN,100,"I")
"RTN","PSOERXU6",129,0)
 S NERXIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU6",130,0)
 I (RXSTAT=12)!(RXSTAT=13)!(RXSTAT=14)!(RXSTAT=15) D  Q VALMSG
"RTN","PSOERXU6",131,0)
 .S ERRSEQ=$$ERRSEQ^PSOERXU1(ERXIEN) Q:'ERRSEQ
"RTN","PSOERXU6",132,0)
 .I RXSTAT=13 S VALMSG="2^Prescription is already DELETED at the Pharmacy."
"RTN","PSOERXU6",133,0)
 .I '$D(VALMSG) S VALMSG="1^Prescription is already discontinued at the Pharmacy."
"RTN","PSOERXU6",134,0)
 .D FILERR^PSOERXU1(ERXIENS,ERRSEQ,"PX","V",$G(VALMSG))
"RTN","PSOERXU6",135,0)
 S PSOSITE=$$GET1^DIQ(52,RXIEN,20,"I")
"RTN","PSOERXU6",136,0)
 S PSOSYS=$G(^PS(59.7,1,40.1)) Q:PSOSYS="" ""
"RTN","PSOERXU6",137,0)
 ; FUTURE ENHANCEMENT/CONSIDERATION- SET PSODIV - PSODIV IS 0 in the test account. need to determine what it is set to.
"RTN","PSOERXU6",138,0)
 S PSODFN=$$GET1^DIQ(52,RXIEN,2,"I") Q:'PSODFN ""
"RTN","PSOERXU6",139,0)
 ; ORN is set to 1 since we are only building one item into the list. this makes the dc function use PSOLST(ORN)
"RTN","PSOERXU6",140,0)
 ; or PSOLST(1)
"RTN","PSOERXU6",141,0)
 S PSOLST(1)=52_U_RXIEN_U_$$GET1^DIQ(52,RXIEN,100,"E")
"RTN","PSOERXU6",142,0)
 S ORN=1
"RTN","PSOERXU6",143,0)
 ; PSODIV, PSOSITE, AND PSOSYS are used by LMNO^PSOCAN and DIV^PSOCAN - consider setting these if possible 
"RTN","PSOERXU6",144,0)
 ; PSOOPT is checked against a value of 3. find out if we need to set this to a certain value before calling psocan3
"RTN","PSOERXU6",145,0)
 S PSOOPT=0
"RTN","PSOERXU6",146,0)
 D OERR^PSOCAN3(NERXIEN)
"RTN","PSOERXU6",147,0)
 S UPDRXSTA=$$GET1^DIQ(52,RXIEN,100,"I")
"RTN","PSOERXU6",148,0)
 I UPDRXSTA'=12,(UPDRXSTA'=14),(UPDRXSTA'=15) D  Q VALMSG
"RTN","PSOERXU6",149,0)
 .I UPDRXSTA=13 S VALMSG="2^Prescription has been DELETED at the Pharmacy."
"RTN","PSOERXU6",150,0)
 .S ERRSEQ=$$ERRSEQ^PSOERXU1(ERXIEN) Q:'ERRSEQ
"RTN","PSOERXU6",151,0)
 .I $L($G(VALMSG)) S VALMSG=0_U_$G(VALMSG)
"RTN","PSOERXU6",152,0)
 .I '$L($G(VALMSG)) S VALMSG="0^eRx auto-discontinue failed."
"RTN","PSOERXU6",153,0)
 .D FILERR^PSOERXU1(ERXIENS,ERRSEQ,"PX","V",$G(VALMSG))
"RTN","PSOERXU6",154,0)
 S ACOM=$$BLDRESP(RXIEN),ACOM=1_U_ACOM
"RTN","PSOERXU6",155,0)
 Q ACOM
"RTN","PSOERXU6",156,0)
 ; auto discontinue pending orders related to cancel request
"RTN","PSOERXU6",157,0)
 ; ERXIEN - cancel reqeust IEN
"RTN","PSOERXU6",158,0)
 ; PENDIEN - IEN for the pending order in file 52.41
"RTN","PSOERXU6",159,0)
CANPEND(ERXIEN,PENDIEN,INST,PSSRET) ;
"RTN","PSOERXU6",160,0)
 N ERXIENS,CANTYPE,ERRSEQ,VALMSG,PREVORD,NERXIEN,ORD,ACOM,REFL,TOTFILL,LDDATE,FFILL,PSODFN,PSONOOR,PSODFN,CANTYPEA,ORNUM,PSOPLCK
"RTN","PSOERXU6",161,0)
 S ERXIENS=ERXIEN_","
"RTN","PSOERXU6",162,0)
 Q:'PENDIEN
"RTN","PSOERXU6",163,0)
 Q:'$D(^PS(52.41,PENDIEN,0)) "1^Rx no longer in pending file."
"RTN","PSOERXU6",164,0)
 S NERXIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU6",165,0)
 S PSODFN=$$GET1^DIQ(52.41,PENDIEN,1,"I")
"RTN","PSOERXU6",166,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S ACOM=$S($P($G(PSOPLCK),"^",2)'="":"Patient record locked by "_$P($G(PSOPLCK),"^",2)_".",1:"Another person is entering orders for this patient.") K PSOPLCK Q 0_U_ACOM
"RTN","PSOERXU6",167,0)
 S CANTYPE=$$GET1^DIQ(52.41,PENDIEN,2,"I")
"RTN","PSOERXU6",168,0)
 ; if this is already DC'd. update status of the releated messages
"RTN","PSOERXU6",169,0)
 I CANTYPE="DC"!(CANTYPE="DE") D  Q VALMSG
"RTN","PSOERXU6",170,0)
 .S ERRSEQ=$$ERRSEQ^PSOERXU1(ERXIEN) Q:'ERRSEQ
"RTN","PSOERXU6",171,0)
 .S VALMSG="1^Pending Order is already discontinued."
"RTN","PSOERXU6",172,0)
 .D FILERR^PSOERXU1(ERXIENS,ERRSEQ,"PX","V",$G(VALMSG))
"RTN","PSOERXU6",173,0)
 S ACOM="Rx was never dispensed. Canceled at Pharmacy."
"RTN","PSOERXU6",174,0)
 S ORD=PENDIEN
"RTN","PSOERXU6",175,0)
 S PSONOOR="W"
"RTN","PSOERXU6",176,0)
 D DEAD^PSOPTPST
"RTN","PSOERXU6",177,0)
 K ^PS(52.41,"AOR",$P(^PS(52.41,ORD,0),"^",2),+$P($G(^PS(52.41,ORD,"INI")),"^"),ORD),^PS(52.41,"AD",$P(^PS(52.41,ORD,0),"^",12),+$P($G(^PS(52.41,ORD,"INI")),"^"),ORD)
"RTN","PSOERXU6",178,0)
 S $P(^PS(52.41,ORD,0),"^",3)="DC",POERR("PLACER")=$P(^(0),"^"),POERR("STAT")="OC"
"RTN","PSOERXU6",179,0)
 S POERR("COMM")=$S($G(POERR("DEAD")):"Patient died on "_$G(PSOPTPST(2,PSODFN,.351))_".",1:ACOM),$P(^PS(52.41,ORD,4),"^")=POERR("COMM")
"RTN","PSOERXU6",180,0)
 D EN^PSOHLSN(POERR("PLACER"),POERR("STAT"),POERR("COMM"),PSONOOR)
"RTN","PSOERXU6",181,0)
 S CANTYPEA=$$GET1^DIQ(52.41,PENDIEN,2,"I")
"RTN","PSOERXU6",182,0)
 I CANTYPEA'="DC" D  Q VALMSG
"RTN","PSOERXU6",183,0)
 .S ERRSEQ=$$ERRSEQ^PSOERXU1(ERXIEN) Q:'ERRSEQ
"RTN","PSOERXU6",184,0)
 .S VALMSG="0^eRx auto-discontinue failed. Please contact Pharmacy."
"RTN","PSOERXU6",185,0)
 .D FILERR^PSOERXU1(ERXIENS,ERRSEQ,"PX","V",$G(VALMSG))
"RTN","PSOERXU6",186,0)
 ;E   ; Log Auto-Discontinue of Pending Outpatient Orders if this eRx was already processed
"RTN","PSOERXU6",187,0)
 ;. S ORNUM=$$GET1^DIQ(52.49,ERXIEN,.12,"I") ; Validates if the order is an eRx and Log Activity in AL eRx
"RTN","PSOERXU6",188,0)
 ;. I $$CHKERX^PSOERXU1(ORNUM) D RXACT^PSOBPSU2(ERXIEN,0,"eRx Discontinued due to Cancel Request by external provider (eRx)","O")
"RTN","PSOERXU6",189,0)
 K POERR,PSOPTPST
"RTN","PSOERXU6",190,0)
 Q 1_U_ACOM
"RTN","PSOERXU6",191,0)
BLDRESP(RXIEN) ;
"RTN","PSOERXU6",192,0)
 N REFL,TOTFILL,LDDATE,FFILL,ACOM
"RTN","PSOERXU6",193,0)
 S (REFL,TOTFILL)=$$GET1^DIQ(52,RXIEN,9,"I"),I=0 F  S I=$O(^PSRX(RXIEN,1,I)) Q:'I  S REFL=REFL-1
"RTN","PSOERXU6",194,0)
 S LDDATE=$$GET1^DIQ(52,RXIEN,101,"I"),LDDATE=$$FMTE^XLFDT(LDDATE,"2D")
"RTN","PSOERXU6",195,0)
 S FFILL=$$GET1^DIQ(52,RXIEN,22,"I"),FFILL=$$FMTE^XLFDT(FFILL,"2D")
"RTN","PSOERXU6",196,0)
 S ACOM="First Fill:"_FFILL_", Last Fill:"_LDDATE_", Refills Remaining:"_REFL
"RTN","PSOERXU6",197,0)
 Q ACOM
"RTN","PSOERXU6",198,0)
 ; find the newRx related to a message
"RTN","PSOERXU6",199,0)
FINDNRX(ERXIEN) ;
"RTN","PSOERXU6",200,0)
 N DONE,I,PREVIEN
"RTN","PSOERXU6",201,0)
 S DONE=0,PREVIEN=0
"RTN","PSOERXU6",202,0)
 I '$D(^PS(52.49,ERXIEN,201)) Q 0
"RTN","PSOERXU6",203,0)
 F I=1:1 D  Q:DONE
"RTN","PSOERXU6",204,0)
 .S PREVIEN=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERXU6",205,0)
 .I 'PREVIEN S DONE=1 Q
"RTN","PSOERXU6",206,0)
 .I PREVIEN S ERXIEN=PREVIEN
"RTN","PSOERXU6",207,0)
 .I $$GET1^DIQ(52.49,PREVIEN,.08,"I")="N" S DONE=1 Q
"RTN","PSOERXU6",208,0)
 Q PREVIEN
"RTN","PSOERXU6",209,0)
JTQ(ERXIEN) ;
"RTN","PSOERXU6",210,0)
 N MEDA,XQY0,DFN,PSOFIN,POERR,PSOSORT,PTNM,PSODFN,PAT,MTYPE,PSOFINY,PSOLST
"RTN","PSOERXU6",211,0)
 D FULL^VALM1
"RTN","PSOERXU6",212,0)
 S VALMBCK="R"
"RTN","PSOERXU6",213,0)
 S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I") I MTYPE'="N" D  Q
"RTN","PSOERXU6",214,0)
 .W !,"Jumping can only be done on 'NewRx' messages." D DIRE^PSOERXX1 Q
"RTN","PSOERXU6",215,0)
 S XQY0="PSO LMOE FINISH"
"RTN","PSOERXU6",216,0)
 I $P($G(PSOPAR),"^",2),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("VERIFY")=1
"RTN","PSOERXU6",217,0)
 S DFN=$$GET1^DIQ(52.49,ERXIEN,.05,"I")
"RTN","PSOERXU6",218,0)
 I 'DFN W !,"Vista patient has not been matched. Cannot jump to outpatient." D DIRE^PSOERXX1 Q
"RTN","PSOERXU6",219,0)
 S (PSOFIN,POERR)=1
"RTN","PSOERXU6",220,0)
 S PSOSORT="PATIENT"
"RTN","PSOERXU6",221,0)
 S PTNM=$$GET1^DIQ(2,DFN,.01,"E")
"RTN","PSOERXU6",222,0)
 S (PSODFN,PAT)=DFN,PSOFINY=DFN_U_PTNM
"RTN","PSOERXU6",223,0)
 ; use the PSNPINST
"RTN","PSOERXU6",224,0)
 I '$D(^PS(52.41,"AOR",PAT,PSNPINST)) W !,"Patient has no pending prescriptions." D DIRE^PSOERXX1 Q
"RTN","PSOERXU6",225,0)
 W !,"Patient: "_PTNM,!
"RTN","PSOERXU6",226,0)
 ; new line SPAT2^PSOORFIN has been created to jump right into pending orders with the patient pre-selected
"RTN","PSOERXU6",227,0)
 D SPAT2^PSOORFIN,EX^PSOORFI1
"RTN","PSOERXU6",228,0)
 K PSORX
"RTN","PSOERXU6",229,0)
 Q
"RTN","PSOERXU6",230,0)
VARENEW(OPIEN) ;
"RTN","PSOERXU6",231,0)
 N FORORD,VARENEW,PON
"RTN","PSOERXU6",232,0)
 S VARENEW=0
"RTN","PSOERXU6",233,0)
 S FORORD=$$GET1^DIQ(52,RXIEN,39.5,"I")
"RTN","PSOERXU6",234,0)
 I FORORD S PON=$$GET1^DIQ(52,FORORD,39.3,"I")
"RTN","PSOERXU6",235,0)
 I FORORD,'$$CHKERX^PSOERXU1(PON) S VARENEW=1
"RTN","PSOERXU6",236,0)
 Q VARENEW
"RTN","PSOERXU6",237,0)
SH(ERXIEN) ;
"RTN","PSOERXU6",238,0)
 N SIEN,IENS,F,LINE,SDTTM,ISTAT,ESTAT,EBY,SCOMM,CARY,ALOOP,STDESC,SDAT
"RTN","PSOERXU6",239,0)
 D FULL^VALM1 S VALMBCK="R"
"RTN","PSOERXU6",240,0)
 S $P(LINE,"-",80)="" W !,LINE
"RTN","PSOERXU6",241,0)
 S F=52.4919
"RTN","PSOERXU6",242,0)
 I '$O(^PS(52.49,ERXIEN,19,0)) W !,"No Status History Available." D DIRE^PSOERXX1 Q
"RTN","PSOERXU6",243,0)
 S SIEN=0 F  S SIEN=$O(^PS(52.49,ERXIEN,19,SIEN)) Q:'SIEN  D
"RTN","PSOERXU6",244,0)
 .S IENS=SIEN_","_ERXIEN_","
"RTN","PSOERXU6",245,0)
 .D GETS^DIQ(F,IENS,"**","IE","SDAT")
"RTN","PSOERXU6",246,0)
 .S SDTTM=$$GET1^DIQ(52.4919,IENS,.01,"I"),SDTTM=$$FMTE^XLFDT(SDTTM,"2Z")
"RTN","PSOERXU6",247,0)
 .S ISTAT=$G(SDAT(F,IENS,.02,"I"))
"RTN","PSOERXU6",248,0)
 .S ESTAT=$G(SDAT(F,IENS,.02,"E"))
"RTN","PSOERXU6",249,0)
 .S STDESC=$$GET1^DIQ(52.45,ISTAT,.02,"E")
"RTN","PSOERXU6",250,0)
 .S EBY=$G(SDAT(F,IENS,.03,"E"))
"RTN","PSOERXU6",251,0)
 .S SCOMM=$G(SDAT(F,IENS,1,"E")),SCOMM="Comments: "_SCOMM
"RTN","PSOERXU6",252,0)
 .K CARY
"RTN","PSOERXU6",253,0)
 .D TXT2ARY^PSOERXD1(.CARY,SCOMM,,80)
"RTN","PSOERXU6",254,0)
 .W !,SDTTM,?19,ESTAT,?26,STDESC,!,"Entered By: "_EBY ;"Comments: "_SCOMM,!
"RTN","PSOERXU6",255,0)
 .S ALOOP=0 F  S ALOOP=$O(CARY(ALOOP)) Q:'ALOOP  D
"RTN","PSOERXU6",256,0)
 ..W !,$G(CARY(ALOOP))
"RTN","PSOERXU6",257,0)
 .W !
"RTN","PSOERXU6",258,0)
 D DIRE^PSOERXX1
"RTN","PSOERXU6",259,0)
 Q
"RTN","PSOERXU6",260,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE - ADDED NEW CALL TO AVOID CONCATENATING A SPACE ONTO PATIENT INSTRUCTIONS
"RTN","PSOERXU6",261,0)
LSIG(SIG) ;
"RTN","PSOERXU6",262,0)
  N P,SGY
"RTN","PSOERXU6",263,0)
 S SGY="" F P=1:1:$L(SIG," ") S X=$P(SIG," ",P) D:X]""  ;
"RTN","PSOERXU6",264,0)
 .;PSO*7*282 Intended Use Check
"RTN","PSOERXU6",265,0)
 .N PSOIN S PSOIN=$O(^PS(51,"B",X,0)) I PSOIN,($P(^PS(51,PSOIN,0),"^",4)<2)&($D(^PS(51,"A",X))) S %=^(X),X=$P(%,"^") I $P(%,"^",2)]"" S Y=$P(SIG,"",P-1),Y=$E(Y,$L(Y)) S:Y>1 X=$P(%,"^",2)
"RTN","PSOERXU6",266,0)
 .S SGY=SGY_" "_X
"RTN","PSOERXU6",267,0)
 Q SGY
"RTN","PSOERXU6",268,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXX3")
0^12^B88483865^B84060041
"RTN","PSOERXX3",1,0)
PSOERXX3 ;ALB/BWF - eRx xml utilities ; 8/3/2016 5:14pm
"RTN","PSOERXX3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,508,551**;DEC 1997;Build 37
"RTN","PSOERXX3",3,0)
 ;
"RTN","PSOERXX3",4,0)
 Q
"RTN","PSOERXX3",5,0)
PATIENT(GBL,PSOISTE,IEN) ;
"RTN","PSOERXX3",6,0)
 N F,PATREL,LNAME,FNAME,MNAME,SUFF,PREF,GENDER,DOB,ADDL1,ADDL2,CITY,STATE,ZIP,PLQ,CUNIT,BED,ROOM,PSDAT,ILOOP
"RTN","PSOERXX3",7,0)
 N ITYP,IVAL,CLOOP,CNUM,CQUAL,PIEN,PIENS,PSSN
"RTN","PSOERXX3",8,0)
 S F=52.46
"RTN","PSOERXX3",9,0)
 S PIEN=$$GET1^DIQ(52.49,IEN,.04,"I") Q:'PIEN
"RTN","PSOERXX3",10,0)
 S PIENS=PIEN_","
"RTN","PSOERXX3",11,0)
 D GETS^DIQ(F,PIENS,"**","IE","PSDAT")
"RTN","PSOERXX3",12,0)
 D CONVXML^PSOERXX1("PSDAT")
"RTN","PSOERXX3",13,0)
 S PATREL=$G(PSDAT(F,PIENS,1.7,"I"))
"RTN","PSOERXX3",14,0)
 S LNAME=$G(PSDAT(F,PIENS,.02,"E"))
"RTN","PSOERXX3",15,0)
 S FNAME=$G(PSDAT(F,PIENS,.03,"E"))
"RTN","PSOERXX3",16,0)
 S MNAME=$G(PSDAT(F,PIENS,.04,"E"))
"RTN","PSOERXX3",17,0)
 S SUFF=$G(PSDAT(F,PIENS,.05,"E"))
"RTN","PSOERXX3",18,0)
 S PREF=$G(PSDAT(F,PIENS,.06,"E"))
"RTN","PSOERXX3",19,0)
 S GENDER=$G(PSDAT(F,PIENS,.07,"I"))
"RTN","PSOERXX3",20,0)
 ; DOB NEEDS TO BE CONVERTED
"RTN","PSOERXX3",21,0)
 S DOB=$G(PSDAT(F,PIENS,.08,"I")) I DOB S DOB=$P($$EXTIME^PSOERXO1(DOB),"T")
"RTN","PSOERXX3",22,0)
 S ADDL1=$G(PSDAT(F,PIENS,3.1,"E"))
"RTN","PSOERXX3",23,0)
 S ADDL2=$G(PSDAT(F,PIENS,3.2,"E"))
"RTN","PSOERXX3",24,0)
 S CITY=$G(PSDAT(F,PIENS,3.3,"E"))
"RTN","PSOERXX3",25,0)
 S STATE=$G(PSDAT(F,PIENS,3.4,"I"))
"RTN","PSOERXX3",26,0)
 S STATE=$$STRES^PSOERXX2(STATE,PSOSITE)
"RTN","PSOERXX3",27,0)
 S ZIP=$G(PSDAT(F,PIENS,3.5,"E"))
"RTN","PSOERXX3",28,0)
 S PLQ=$G(PSDAT(F,PIENS,1.6,"E"))
"RTN","PSOERXX3",29,0)
 S PSSN=$G(PSDAT(F,PIENS,1.4,"E"))
"RTN","PSOERXX3",30,0)
 ; FUTURE ENHANCEMENT, GRAB CUNIT/BED/ROOM FROM CORRECT LOCATIONS. THIS LOGIC IS NOT ACTIVE WITH VERSION 2 
"RTN","PSOERXX3",31,0)
 S CUNIT=$G(PSDAT(F,PIENS,1,"E"))
"RTN","PSOERXX3",32,0)
 S BED=$G(PSDAT(F,PIENS,1,"E"))
"RTN","PSOERXX3",33,0)
 S ROOM=$G(PSDAT(F,PIENS,1,"E"))
"RTN","PSOERXX3",34,0)
 D C S @GBL@(CNT,0)="<Patient>"
"RTN","PSOERXX3",35,0)
 I $L(PATREL) D C S @GBL@(CNT,0)="<PatientRelationship>"_PATREL_"</PatientRelationship>"
"RTN","PSOERXX3",36,0)
 I '$O(^PS(52.46,PIEN,5,0)) D
"RTN","PSOERXX3",37,0)
 .I PSSN D
"RTN","PSOERXX3",38,0)
 ..D C S @GBL@(CNT,0)="<Identification>"
"RTN","PSOERXX3",39,0)
 ..D C S @GBL@(CNT,0)="<SocialSecurity>"_PSSN_"</SocialSecurity>"
"RTN","PSOERXX3",40,0)
 ..D C S @GBL@(CNT,0)="</Identification>"
"RTN","PSOERXX3",41,0)
 I $O(^PS(52.46,PIEN,5,0)) D
"RTN","PSOERXX3",42,0)
 .D C S @GBL@(CNT,0)="<Identification>"
"RTN","PSOERXX3",43,0)
 .S ILOOP=0 F  S ILOOP=$O(^PS(52.46,PIEN,5,ILOOP)) Q:'ILOOP  D
"RTN","PSOERXX3",44,0)
 ..S ITYP=$$GET1^DIQ(52.465,ILOOP_","_PIENS,.01,"E")
"RTN","PSOERXX3",45,0)
 ..S IVAL=$$GET1^DIQ(52.465,ILOOP_","_PIENS,.02,"E")
"RTN","PSOERXX3",46,0)
 ..D IDENT^PSOERXX2(.GBL,ITYP,IVAL)
"RTN","PSOERXX3",47,0)
 .D C S @GBL@(CNT,0)="</Identification>"
"RTN","PSOERXX3",48,0)
 D C S @GBL@(CNT,0)="<Name>"
"RTN","PSOERXX3",49,0)
 I $L(LNAME) D C S @GBL@(CNT,0)="<LastName>"_LNAME_"</LastName>"
"RTN","PSOERXX3",50,0)
 I $L(FNAME) D C S @GBL@(CNT,0)="<FirstName>"_FNAME_"</FirstName>"
"RTN","PSOERXX3",51,0)
 I $L(MNAME) D C S @GBL@(CNT,0)="<MiddleName>"_MNAME_"</MiddleName>"
"RTN","PSOERXX3",52,0)
 I $L(SUFF) D C S @GBL@(CNT,0)="<Suffix>"_SUFF_"</Suffix>"
"RTN","PSOERXX3",53,0)
 I $L(PREF) D C S @GBL@(CNT,0)="<Prefix>"_PREF_"</Prefix>"
"RTN","PSOERXX3",54,0)
 D C S @GBL@(CNT,0)="</Name>"
"RTN","PSOERXX3",55,0)
 I $L(GENDER) D C S @GBL@(CNT,0)="<Gender>"_GENDER_"</Gender>"
"RTN","PSOERXX3",56,0)
 I $L(DOB) D
"RTN","PSOERXX3",57,0)
 .D C S @GBL@(CNT,0)="<DateOfBirth>"
"RTN","PSOERXX3",58,0)
 .D C S @GBL@(CNT,0)="<Date>"_DOB_"</Date>"
"RTN","PSOERXX3",59,0)
 .D C S @GBL@(CNT,0)="</DateOfBirth>"
"RTN","PSOERXX3",60,0)
 I $L(ADDL1) D
"RTN","PSOERXX3",61,0)
 .D C S @GBL@(CNT,0)="<Address>"
"RTN","PSOERXX3",62,0)
 .I $L(ADDL1) D C S @GBL@(CNT,0)="<AddressLine1>"_ADDL1_"</AddressLine1>"
"RTN","PSOERXX3",63,0)
 .I $L(ADDL2) D C S @GBL@(CNT,0)="<AddressLine2>"_ADDL2_"</AddressLine2>"
"RTN","PSOERXX3",64,0)
 .I $L(CITY) D C S @GBL@(CNT,0)="<City>"_CITY_"</City>"
"RTN","PSOERXX3",65,0)
 .I $L(STATE) D C S @GBL@(CNT,0)="<State>"_STATE_"</State>"
"RTN","PSOERXX3",66,0)
 .I $L(ZIP) D C S @GBL@(CNT,0)="<ZipCode>"_ZIP_"</ZipCode>"
"RTN","PSOERXX3",67,0)
 .I $L(PLQ) D C S @GBL@(CNT,0)="<PlaceLocationQualifier>"_PLQ_"</PlaceLocationQualifier>"
"RTN","PSOERXX3",68,0)
 .D C S @GBL@(CNT,0)="</Address>"
"RTN","PSOERXX3",69,0)
 I $O(^PS(52.46,PIEN,3,0)) D
"RTN","PSOERXX3",70,0)
 .D C S @GBL@(CNT,0)="<CommunicationNumbers>"
"RTN","PSOERXX3",71,0)
 .S CLOOP=0 F  S CLOOP=$O(^PS(52.46,PIEN,3,CLOOP)) Q:'CLOOP  D
"RTN","PSOERXX3",72,0)
 ..S CNUM=$$GET1^DIQ(52.462,CLOOP_","_PIENS,.01,"E")
"RTN","PSOERXX3",73,0)
 ..S CQUAL=$$GET1^DIQ(52.462,CLOOP_","_PIENS,.02,"I")
"RTN","PSOERXX3",74,0)
 ..D COMMNUM^PSOERXX2(.GBL,CNUM,CQUAL)
"RTN","PSOERXX3",75,0)
 .D C S @GBL@(CNT,0)="</CommunicationNumbers>"
"RTN","PSOERXX3",76,0)
 I $L(CUNIT)!($L(BED))!($L(ROOM)) D
"RTN","PSOERXX3",77,0)
 .D C S @GBL@(CNT,0)="<PatientLocation>"
"RTN","PSOERXX3",78,0)
 .I $L(CUNIT) D C S @GBL@(CNT,0)="<FacilityUnit>"_CUNIT_"</FacilityUnit>"
"RTN","PSOERXX3",79,0)
 .I $L(BED) D C S @GBL@(CNT,0)="<Bed>"_BED_"</Bed>"
"RTN","PSOERXX3",80,0)
 .I $L(ROOM) D C S @GBL@(CNT,0)="<Room>"_ROOM_"</Room>"
"RTN","PSOERXX3",81,0)
 .D C S @GBL@(CNT,0)="</PatientLocation>"
"RTN","PSOERXX3",82,0)
 D C S @GBL@(CNT,0)="</Patient>"
"RTN","PSOERXX3",83,0)
 Q
"RTN","PSOERXX3",84,0)
FILLST(GBL,FTYPE,FNOTE) ;
"RTN","PSOERXX3",85,0)
 D C S @GBL@(CNT,0)="<FillStatus>"
"RTN","PSOERXX3",86,0)
 D C S @GBL@(CNT,0)=$S(FTYPE="F":"<Filled>",FTYPE="P":"<PartialFill>",1:"")
"RTN","PSOERXX3",87,0)
 D C S @GBL@(CNT,0)="<Note>"_FNOTE_"</Note>"
"RTN","PSOERXX3",88,0)
 D C S @GBL@(CNT,0)=$S(FTYPE="F":"</Filled>",FTYPE="P":"</PartialFill>",1:"")
"RTN","PSOERXX3",89,0)
 D C S @GBL@(CNT,0)="</FillStatus>"
"RTN","PSOERXX3",90,0)
 Q
"RTN","PSOERXX3",91,0)
BENEFITS(GBL,IEN) ;
"RTN","PSOERXX3",92,0)
 N F,NCPDPID,NCPDPID,PAYNAME,CARDID,LNAME,FNAME,MNAME,SUFF,PREF,GID,PSDAT,BIENS,BLOOP,IDLOOP
"RTN","PSOERXX3",93,0)
 S IENS=IEN_","
"RTN","PSOERXX3",94,0)
 S F=52.4918
"RTN","PSOERXX3",95,0)
 I '$O(^PS(52.49,IEN,18,0)) Q
"RTN","PSOERXX3",96,0)
 D C S @GBL@(CNT,0)="<BenefitsCoordination>"
"RTN","PSOERXX3",97,0)
 S BLOOP=0 F  S BLOOP=$O(^PS(52.49,IEN,18,BLOOP)) Q:'BLOOP  D
"RTN","PSOERXX3",98,0)
 .S BIENS=BLOOP_","_IENS
"RTN","PSOERXX3",99,0)
 .K PSDAT
"RTN","PSOERXX3",100,0)
 .D GETS^DIQ(F,BIENS,"**","IE","PSDAT")
"RTN","PSOERXX3",101,0)
 .D CONVXML^PSOERXX1("PSDAT")
"RTN","PSOERXX3",102,0)
 .; FUTURE ENHANCEMENT - the IDENTIFICATION multiple is where the NCPDPID info belongs, USE IDENTIFICATION MULTIPLE IN THE PAYER SUBFILE
"RTN","PSOERXX3",103,0)
 .;S NCPDPID=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX3",104,0)
 .;FUTURE ENHANCEMENT - STORE PAYER NAME DIFFERENTLY AN..35
"RTN","PSOERXX3",105,0)
 .S PAYNAME=$E($G(PSDAT(F,BIENS,.03,"E")),1,35)
"RTN","PSOERXX3",106,0)
 .S CARDID=$G(PSDAT(F,BIENS,7,"E"))
"RTN","PSOERXX3",107,0)
 .S LNAME=$G(PSDAT(F,BIENS,1,"E"))
"RTN","PSOERXX3",108,0)
 .S FNAME=$G(PSDAT(F,BIENS,2,"E"))
"RTN","PSOERXX3",109,0)
 .S MNAME=$G(PSDAT(F,BIENS,3,"E"))
"RTN","PSOERXX3",110,0)
 .S SUFF=$G(PSDAT(F,BIENS,4,"E"))
"RTN","PSOERXX3",111,0)
 .S PREF=$G(PSDAT(F,BIENS,5,"E"))
"RTN","PSOERXX3",112,0)
 .S GID=$G(PSDAT(F,BIENS,.02,"E"))
"RTN","PSOERXX3",113,0)
 .; PAYER IDENTIFICATION INFORMATION
"RTN","PSOERXX3",114,0)
 .I $D(^PS(52.49,IEN,18,BLOOP,6)) D
"RTN","PSOERXX3",115,0)
 ..S IDLOOP=0 F  S IDLOOP=$O(^PS(52.49,IEN,18,BLOOP,6,IDLOOP)) Q:'IDLOOP  D
"RTN","PSOERXX3",116,0)
 ...D C S @GBL@(CNT,0)="<PayerIdentification>"
"RTN","PSOERXX3",117,0)
 ...S ITYP=$$GET1^DIQ(52.49186,IDLOOP_","_BLOOP_","_IENS,.01,"E")
"RTN","PSOERXX3",118,0)
 ...S IVAL=$$GET1^DIQ(52.49186,IDLOOP_","_BLOOP_","_IENS,.02,"E")
"RTN","PSOERXX3",119,0)
 ...D C S @GBL@(CNT,0)="<"_ITYP_">"_IVAL_"</"_ITYP_">"
"RTN","PSOERXX3",120,0)
 ...D C S @GBL@(CNT,0)="</PayerIdentification>"
"RTN","PSOERXX3",121,0)
 ..;D C S @GBL@(CNT,0)="</PayerIdentification>"
"RTN","PSOERXX3",122,0)
 .I $L(PAYNAME) D C S @GBL@(CNT,0)="<PayerName>"_PAYNAME_"</PayerName>"
"RTN","PSOERXX3",123,0)
 .I $L(CARDID) D C S @GBL@(CNT,0)="<CardholderID>"_CARDID_"</CardholderID>"
"RTN","PSOERXX3",124,0)
 .I ($L(LNAME))!($L(FNAME))!($L(MNAME))!($L(SUFF))!($L(PREF)) D
"RTN","PSOERXX3",125,0)
 ..D C S @GBL@(CNT,0)="<CardHolderName>"
"RTN","PSOERXX3",126,0)
 ..;/BLB/ - PSO*7*551 BEGIN CHANGE - PREVENT EMPTY SECTIONS
"RTN","PSOERXX3",127,0)
 ..I $L(LNAME) D C S @GBL@(CNT,0)="<LastName>"_LNAME_"</LastName>"
"RTN","PSOERXX3",128,0)
 ..I $L(FNAME) D C S @GBL@(CNT,0)="<FirstName>"_FNAME_"</FirstName>"
"RTN","PSOERXX3",129,0)
 ..I $L(MNAME) D C S @GBL@(CNT,0)="<MiddleName>"_MNAME_"</MiddleName>"
"RTN","PSOERXX3",130,0)
 ..I $L(SUFF) D C S @GBL@(CNT,0)="<Suffix>"_SUFF_"</Suffix>"
"RTN","PSOERXX3",131,0)
 ..I $L(PREF) D C S @GBL@(CNT,0)="<Prefix>"_PREF_"</Prefix>"
"RTN","PSOERXX3",132,0)
 ..D C S @GBL@(CNT,0)="</CardHolderName>"
"RTN","PSOERXX3",133,0)
 .I $L(GID) D C S @GBL@(CNT,0)="<GroupID>"_GID_"</GroupID>"
"RTN","PSOERXX3",134,0)
 D C S @GBL@(CNT,0)="</BenefitsCoordination>"
"RTN","PSOERXX3",135,0)
 Q
"RTN","PSOERXX3",136,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXX3",137,0)
OBSERVE(GBL,IEN) ;
"RTN","PSOERXX3",138,0)
 N F,DIMENS,VALUE,OBDATE,MDQ,MSC,MUC,OBNOTE,PSDAT,OIENS,OLOOP
"RTN","PSOERXX3",139,0)
 S F=52.4914
"RTN","PSOERXX3",140,0)
 S OBNOTE=$$GET1^DIQ(52.49,IEN,15,"E") S OBNOTE=$$SYMENC^MXMLUTL(OBNOTE)
"RTN","PSOERXX3",141,0)
 S IENS=IEN_","
"RTN","PSOERXX3",142,0)
 I '$O(^PS(52.49,IEN,14,0)) Q
"RTN","PSOERXX3",143,0)
 D C S @GBL@(CNT,0)="<Observation>"
"RTN","PSOERXX3",144,0)
 S OLOOP=0 F  S OLOOP=$O(^PS(52.49,IEN,14,OLOOP)) Q:'OLOOP  D
"RTN","PSOERXX3",145,0)
 .S OIENS=OLOOP_","_IENS
"RTN","PSOERXX3",146,0)
 .K PSDAT
"RTN","PSOERXX3",147,0)
 .D GETS^DIQ(F,OIENS,"**","IE","PSDAT")
"RTN","PSOERXX3",148,0)
 .D CONVXML^PSOERXX1("PSDAT")
"RTN","PSOERXX3",149,0)
 .S DIMENS=$G(PSDAT(F,OIENS,.02,"E"))
"RTN","PSOERXX3",150,0)
 .S VALUE=$G(PSDAT(F,OIENS,.03,"E"))
"RTN","PSOERXX3",151,0)
 .; convert observation date
"RTN","PSOERXX3",152,0)
 .S OBDATE=$G(PSDAT(F,OIENS,.04,"I")) I OBDATE S OBDATE=$P($$EXTIME^PSOERXO1(OBDATE),"T")
"RTN","PSOERXX3",153,0)
 .S MDQ=$G(PSDAT(F,OIENS,.05,"I"))
"RTN","PSOERXX3",154,0)
 .S MSC=$G(PSDAT(F,OIENS,.06,"E"))
"RTN","PSOERXX3",155,0)
 .S MUC=$G(PSDAT(F,OIENS,.07,"E"))
"RTN","PSOERXX3",156,0)
 .D C S @GBL@(CNT,0)="<Measurement>"
"RTN","PSOERXX3",157,0)
 .D C S @GBL@(CNT,0)="<Dimension>"_DIMENS_"</Dimension>"
"RTN","PSOERXX3",158,0)
 .D C S @GBL@(CNT,0)="<Value>"_VALUE_"</Value>"
"RTN","PSOERXX3",159,0)
 .I $L(OBDATE) D
"RTN","PSOERXX3",160,0)
 ..D C S @GBL@(CNT,0)="<ObservationDate>"
"RTN","PSOERXX3",161,0)
 ..D C S @GBL@(CNT,0)="<Date>"_OBDATE_"</Date>"
"RTN","PSOERXX3",162,0)
 ..D C S @GBL@(CNT,0)="</ObservationDate>"
"RTN","PSOERXX3",163,0)
 .I $L(MDQ) D C S @GBL@(CNT,0)="<MeasurementDataQualifier>"_MDQ_"</MeasurementDataQualifier>"
"RTN","PSOERXX3",164,0)
 .I $L(MSC) D C S @GBL@(CNT,0)="<MeasurementSourceCode>"_MSC_"</MeasurementSourceCode>"
"RTN","PSOERXX3",165,0)
 .I $L(MUC) D C S @GBL@(CNT,0)="<MeasurementUnitCode>"_MUC_"</MeasurementUnitCode>"
"RTN","PSOERXX3",166,0)
 .D C S @GBL@(CNT,0)="</Measurement>"
"RTN","PSOERXX3",167,0)
 I $L(OBNOTE) D
"RTN","PSOERXX3",168,0)
 .D C S @GBL@(CNT,0)="<ObservationNotes>"_OBNOTE_"</ObservationNotes>"
"RTN","PSOERXX3",169,0)
 D C S @GBL@(CNT,0)="</Observation>"
"RTN","PSOERXX3",170,0)
 Q
"RTN","PSOERXX3",171,0)
DRUGEVAL(GBL,IEN) ;
"RTN","PSOERXX3",172,0)
 N F,SRC,PSC,SERVRC,CAID,CAQ,CSC,AR,PSDAT,DLOOP
"RTN","PSOERXX3",173,0)
 Q
"RTN","PSOERXX3",174,0)
 S F=52.4916
"RTN","PSOERXX3",175,0)
 S DLOOP=0 F  S DLOOP=$O(^PS(52.49,IEN,16,DLOOP)) Q:'DLOOP  D
"RTN","PSOERXX3",176,0)
 .S IENS=IEN_","_DLOOP_","
"RTN","PSOERXX3",177,0)
 .K PSDAT D GETS^DIQ(F,IENS,"**","IE","PSDAT")
"RTN","PSOERXX3",178,0)
 .D CONVXML^PSOERXX1("PSDAT")
"RTN","PSOERXX3",179,0)
 .S SRC=$G(PSDAT(F,IENS,.01,"E"))
"RTN","PSOERXX3",180,0)
 .S PSC=$G(PSDAT(F,IENS,.02,"E"))
"RTN","PSOERXX3",181,0)
 .S SERVRC=$G(PSDAT(F,IENS,.03,"E"))
"RTN","PSOERXX3",182,0)
 .S CAID=$G(PSDAT(F,IENS,.04,"E"))
"RTN","PSOERXX3",183,0)
 .S CAQ=$G(PSDAT(F,IENS,.05,"E"))
"RTN","PSOERXX3",184,0)
 .S CSC=$G(PSDAT(F,IENS,.06,"E"))
"RTN","PSOERXX3",185,0)
 .S AR=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX3",186,0)
 .D C S @GBL@(CNT,0)="<DrugUseEvaluation>"
"RTN","PSOERXX3",187,0)
 .D C S @GBL@(CNT,0)="<ServiceReasonCode>"_SRC_"</ServiceReasonCode>"
"RTN","PSOERXX3",188,0)
 .D C S @GBL@(CNT,0)="<ProfessionalServiceCode>"_PSC_"</ProfessionalServiceCode>"
"RTN","PSOERXX3",189,0)
 .D C S @GBL@(CNT,0)="<ServiceResultCode>"_SERVRC_"</ServiceResultCode>"
"RTN","PSOERXX3",190,0)
 .D C S @GBL@(CNT,0)="<CoAgent>"
"RTN","PSOERXX3",191,0)
 .D C S @GBL@(CNT,0)="<CoAgentID>"_CAID_"</CoAgentID>"
"RTN","PSOERXX3",192,0)
 .D C S @GBL@(CNT,0)="<CoAgentQualifier>"_CAQ_"</CoAgentQualifier>"
"RTN","PSOERXX3",193,0)
 .D C S @GBL@(CNT,0)="</CoAgent>"
"RTN","PSOERXX3",194,0)
 .D C S @GBL@(CNT,0)="<ClinicalSignificanceCode>"_CSC_"</ClinicalSignificanceCode>"
"RTN","PSOERXX3",195,0)
 .D C S @GBL@(CNT,0)="<AcknowledgementReason>"_AR_"</AcknowledgementReason>"
"RTN","PSOERXX3",196,0)
 .D C S @GBL@(CNT,0)="</DrugUseEvaluation>"
"RTN","PSOERXX3",197,0)
 Q
"RTN","PSOERXX3",198,0)
DIAGNOS(GBL,IENS) ;
"RTN","PSOERXX3",199,0)
 N F,CIQ,PQUAL,PVAL,SQUAL,SVAL,PSDAT
"RTN","PSOERXX3",200,0)
 S F=52.499
"RTN","PSOERXX3",201,0)
 D GETS^DIQ(F,IENS,"**","IE","PSDAT")
"RTN","PSOERXX3",202,0)
 D CONVXML^PSOERXX1("PSDAT")
"RTN","PSOERXX3",203,0)
 S CIQ=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX3",204,0)
 S PQUAL=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX3",205,0)
 S PVAL=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX3",206,0)
 S SQUAL=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX3",207,0)
 S SVAL=$G(PSDAT(F,IENS,1,"E"))
"RTN","PSOERXX3",208,0)
 ;FUTURE ENHANCEMENT - FOR NOW JUST BUILD HEADER/FOOTER AND QUIT, LATER BUILD THE REST
"RTN","PSOERXX3",209,0)
 D C S @GBL@(CNT,0)="<Diagnosis>"
"RTN","PSOERXX3",210,0)
 D C S @GBL@(CNT,0)="</Diagnosis>"
"RTN","PSOERXX3",211,0)
 Q
"RTN","PSOERXX3",212,0)
 D C S @GBL@(CNT,0)="<Diagnosis>"
"RTN","PSOERXX3",213,0)
 D C S @GBL@(CNT,0)="<ClinicalInformationQualifier>"_CIQ_"</ClinicalInformationQualifier>"
"RTN","PSOERXX3",214,0)
 D C S @GBL@(CNT,0)="<Primary>"
"RTN","PSOERXX3",215,0)
 D C S @GBL@(CNT,0)="<Qualifier>"_PQUAL_"</Qualifier>"
"RTN","PSOERXX3",216,0)
 D C S @GBL@(CNT,0)="<Value>"_PVAL_"</Value>"
"RTN","PSOERXX3",217,0)
 D C S @GBL@(CNT,0)="</Primary>"
"RTN","PSOERXX3",218,0)
 D C S @GBL@(CNT,0)="<Secondary>"
"RTN","PSOERXX3",219,0)
 D C S @GBL@(CNT,0)="<Qualifier>"_SQUAL_"</Qualifier>"
"RTN","PSOERXX3",220,0)
 D C S @GBL@(CNT,0)="<Value>"_SVAL_"</VALUE>"
"RTN","PSOERXX3",221,0)
 D C S @GBL@(CNT,0)="</Secondary>"
"RTN","PSOERXX3",222,0)
 D C S @GBL@(CNT,0)="</Diagnosis>"
"RTN","PSOERXX3",223,0)
 Q
"RTN","PSOERXX3",224,0)
C ;
"RTN","PSOERXX3",225,0)
 S CNT=$G(CNT)+1
"RTN","PSOERXX3",226,0)
 Q
"RTN","PSOERXX5")
0^17^B161912387^B161348685
"RTN","PSOERXX5",1,0)
PSOERXX5 ;ALB/BWF - eRx xml utilities ; 8/3/2016 5:14pm
"RTN","PSOERXX5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,508,551**;DEC 1997;Build 37
"RTN","PSOERXX5",3,0)
 ;
"RTN","PSOERXX5",4,0)
 Q
"RTN","PSOERXX5",5,0)
STRUCSIG(GBL,IENS) ;
"RTN","PSOERXX5",6,0)
 N SSPN,MSM,SV,FMTV,SFTSI,SFT,DCI,DDM,DDMCQ,DDMC,DDMMT,DDMMCQ,DDMMC,MDRFLG,MDVAR
"RTN","PSOERXX5",7,0)
 N DQ,DFT,DFCQ,DFC,DRM,DBMV,DBUM,DBUMCQ,DBUC,BMQ,BMV,CDM,CDUMT,CDUMCQ,CDUMC,DBRM
"RTN","PSOERXX5",8,0)
 N VN,VNCQ,VUMT,VUMCQ,VUMC,MVM,RAT,RACQ,RAC,MRAM,SAT,SACQ,SAC,MATM,RM,RUMT,INDFLG,INDVAR
"RTN","PSOERXX5",9,0)
 N RUMCQ,RUMC,TPBT,TPBCQ,TPBC,FNV,FUT,FUCQ,FUC,VFM,INV,IUT,IUCQ,IUC,OR,DNV,DTEXT,DTCQ
"RTN","PSOERXX5",10,0)
 N DTC,MDRNV,MDRUT,MDRCQ,MDRUC,MDRVN,MDRVUT,MDRVUCQ,MDRVUC,MDRVDM,IPT,IPCQ,IPC,IT
"RTN","PSOERXX5",11,0)
 N F,ITCQ,ITC,IVT,IVU,IVUMT,IVUMCQ,IVUMC,IVM,STOPI,PDAT,ATC,ATCQ,ATT,TMATM,VIM,VNC,VQ
"RTN","PSOERXX5",12,0)
 N DOSEVAR,DOSEFLG,DCALFLG,DCALVAR,VFLG,VVAR,ROAFLG,ROAVAR,SOAFLG,SOAVAR,TIMFLG,TIMVAR,DURFLG,DURVAR
"RTN","PSOERXX5",13,0)
 S F=52.4911
"RTN","PSOERXX5",14,0)
 D GETS^DIQ(F,IENS,"**","IE","PDAT")
"RTN","PSOERXX5",15,0)
 D CONVXML^PSOERXX1("PDAT")
"RTN","PSOERXX5",16,0)
 S SSPN=$G(PDAT(F,IENS,.01,"E")),MSM=$G(PDAT(F,IENS,.02,"I")),SV=$G(PDAT(F,IENS,.03,"E"))
"RTN","PSOERXX5",17,0)
 S FMTV=$G(PDAT(F,IENS,.04,"E")),SFTSI=$G(PDAT(F,IENS,.05,"E")),SFT=$G(PDAT(F,IENS,1,"E"))
"RTN","PSOERXX5",18,0)
 S DCI=$G(PDAT(F,IENS,2.1,"E")),DDM=$G(PDAT(F,IENS,2.2,"E")),DDMCQ=$G(PDAT(F,IENS,2.3,"I"))
"RTN","PSOERXX5",19,0)
 S DDMC=$G(PDAT(F,IENS,2.4,"E")),DDMMT=$G(PDAT(F,IENS,2.5,"E")),DDMMCQ=$G(PDAT(F,IENS,2.7,"I")),DDMMC=$G(PDAT(F,IENS,2.6,"E"))
"RTN","PSOERXX5",20,0)
 S DQ=$G(PDAT(F,IENS,3.1,"E")),DFT=$G(PDAT(F,IENS,3.2,"E")),DFCQ=$G(PDAT(F,IENS,3.4,"I")),DFC=$G(PDAT(F,IENS,3.3,"E"))
"RTN","PSOERXX5",21,0)
 S DRM=$G(PDAT(F,IENS,3.5,"I")),DBMV=$G(PDAT(F,IENS,4.1,"E")),DBUM=$G(PDAT(F,IENS,4.2,"E")),DBUMCQ=$G(PDAT(F,IENS,4.4,"I"))
"RTN","PSOERXX5",22,0)
 S DBUC=$G(PDAT(F,IENS,4.3,"E")),BMQ=$G(PDAT(F,IENS,4.5,"I")),BMV=$G(PDAT(F,IENS,4.6,"E")),CDM=$G(PDAT(F,IENS,4.7,"E"))
"RTN","PSOERXX5",23,0)
 S CDUMT=$G(PDAT(F,IENS,4.8,"E")),CDUMCQ=$G(PDAT(F,IENS,4.11,"I")),CDUMC=$G(PDAT(F,IENS,4.9,"E")),DBRM=$G(PDAT(F,IENS,4.12,"I"))
"RTN","PSOERXX5",24,0)
 S VN=$G(PDAT(F,IENS,5.1,"E")),VNC=$G(PDAT(F,IENS,5.2,"E")),VNCQ=$G(PDAT(F,IENS,5.3,"I")),VQ=$G(PDAT(F,IENS,5.4,"E"))
"RTN","PSOERXX5",25,0)
 S VUMT=$G(PDAT(F,IENS,5.5,"E")),VUMCQ=$G(PDAT(F,IENS,5.7,"I")),VUMC=$G(PDAT(F,IENS,5.6,"E")),MVM=$G(PDAT(F,IENS,5.8,"I"))
"RTN","PSOERXX5",26,0)
 S RAT=$G(PDAT(F,IENS,6.1,"E")),RACQ=$G(PDAT(F,IENS,6.3,"I")),RAC=$G(PDAT(F,IENS,6.2,"E")),MRAM=$G(PDAT(F,IENS,6.4,"I"))
"RTN","PSOERXX5",27,0)
 S SAT=$G(PDAT(F,IENS,6.5,"E")),SACQ=$G(PDAT(F,IENS,6.7,"I")),SAC=$G(PDAT(F,IENS,6.7,"I")),MATM=$G(PDAT(F,IENS,6.8,"I"))
"RTN","PSOERXX5",28,0)
 S ATT=$G(PDAT(F,IENS,7.1,"E")),ATCQ=$G(PDAT(F,IENS,7.3,"I")),ATC=$G(PDAT(F,IENS,7.2,"E")),TMATM=$G(PDAT(F,IENS,7.4,"I"))
"RTN","PSOERXX5",29,0)
 S RM=$G(PDAT(F,IENS,7.5,"E")),RUMT=$G(PDAT(F,IENS,7.6,"E")),RUMCQ=$G(PDAT(F,IENS,7.8,"I")),RUMC=$G(PDAT(F,IENS,7.7,"E"))
"RTN","PSOERXX5",30,0)
 S TPBT=$G(PDAT(F,IENS,8.1,"E")),TPBCQ=$G(PDAT(F,IENS,8.3,"I")),TPBC=$G(PDAT(F,IENS,8.2,"E")),FNV=$G(PDAT(F,IENS,8.4,"E"))
"RTN","PSOERXX5",31,0)
 S FUT=$G(PDAT(F,IENS,8.5,"E")),FUCQ=$G(PDAT(F,IENS,8.7,"I")),FUC=$G(PDAT(F,IENS,8.6,"E")),VFM=$G(PDAT(F,IENS,8.8,"I")),INV=$G(PDAT(F,IENS,9.1,"E"))
"RTN","PSOERXX5",32,0)
 S IUT=$G(PDAT(F,IENS,9.2,"E")),IUCQ=$G(PDAT(F,IENS,9.4,"I")),IUC=$G(PDAT(F,IENS,9.3,"E")),VIM=$G(PDAT(F,IENS,9.5,"I"))
"RTN","PSOERXX5",33,0)
 S DNV=$G(PDAT(F,IENS,9.6,"E")),DTEXT=$G(PDAT(F,IENS,9.7,"E")),DTCQ=$G(PDAT(F,IENS,9.9,"I")),DTC=$G(PDAT(F,IENS,9.8,"E"))
"RTN","PSOERXX5",34,0)
 S MDRNV=$G(PDAT(F,IENS,10.1,"E")),MDRUT=$G(PDAT(F,IENS,10.2,"E")),MDRCQ=$G(PDAT(F,IENS,10.3,"I")),MDRUC=$G(PDAT(F,IENS,10.4,"E"))
"RTN","PSOERXX5",35,0)
 S MDRVN=$G(PDAT(F,IENS,10.5,"E")),MDRVUT=$G(PDAT(F,IENS,10.6,"E")),MDRVUCQ=$G(PDAT(F,IENS,10.8,"I")),MDRVUC=$G(PDAT(F,IENS,10.7,"E"))
"RTN","PSOERXX5",36,0)
 S MDRVDM=$G(PDAT(F,IENS,10.9,"I")),IPT=$G(PDAT(F,IENS,11.1,"E")),IPCQ=$G(PDAT(F,IENS,11.3,"I")),IPC=$G(PDAT(F,IENS,11.2,"E"))
"RTN","PSOERXX5",37,0)
 S IT=$G(PDAT(F,IENS,11.4,"E")),ITCQ=$G(PDAT(F,IENS,11.6,"I")),ITC=$G(PDAT(F,IENS,11.5,"E")),IVT=$G(PDAT(F,IENS,12.1,"E"))
"RTN","PSOERXX5",38,0)
 S IVU=$G(PDAT(F,IENS,12.2,"E")),IVUMT=$G(PDAT(F,IENS,12.3,"E")),IVUMCQ=$G(PDAT(F,IENS,12.5,"I"))
"RTN","PSOERXX5",39,0)
 S IVUMC=$G(PDAT(F,IENS,12.4,"E")),IVM=$G(PDAT(F,IENS,12.6,"I")),STOPI=$G(PDAT(F,IENS,12.7,"I"))
"RTN","PSOERXX5",40,0)
 D C S @GBL@(CNT,0)="<StructuredSIG>"
"RTN","PSOERXX5",41,0)
 D C S @GBL@(CNT,0)="<RepeatingSIG>"
"RTN","PSOERXX5",42,0)
 D C S @GBL@(CNT,0)="<SigSequencePositionNumber>"_SSPN_"</SigSequencePositionNumber>"
"RTN","PSOERXX5",43,0)
 I $L(MSM) D C S @GBL@(CNT,0)="<MultipleSigModifier>"_MSM_"</MultipleSigModifier>"
"RTN","PSOERXX5",44,0)
 D C S @GBL@(CNT,0)="</RepeatingSIG>"
"RTN","PSOERXX5",45,0)
 D C S @GBL@(CNT,0)="<CodeSystem>"
"RTN","PSOERXX5",46,0)
 I $L(SV) D C S @GBL@(CNT,0)="<SNOMEDVersion>"_SV_"</SNOMEDVersion>"
"RTN","PSOERXX5",47,0)
 I $L(FMTV) D C S @GBL@(CNT,0)="<FMTVersion>"_FMTV_"</FMTVersion>"
"RTN","PSOERXX5",48,0)
 D C S @GBL@(CNT,0)="</CodeSystem>"
"RTN","PSOERXX5",49,0)
 D C S @GBL@(CNT,0)="<FreeText>"
"RTN","PSOERXX5",50,0)
 I $L(SFTSI) D C S @GBL@(CNT,0)="<SigFreeTextStringIndicator>"_SFTSI_"</SigFreeTextStringIndicator>"
"RTN","PSOERXX5",51,0)
 I $L(SFT) D C S @GBL@(CNT,0)="<SigFreeText>"_SFT_"</SigFreeText>"
"RTN","PSOERXX5",52,0)
 D C S @GBL@(CNT,0)="</FreeText>"
"RTN","PSOERXX5",53,0)
 S DOSEFLG=0
"RTN","PSOERXX5",54,0)
 F DOSEVAR="DCI","DDM","DDMCQ","DDMC","DDMMT","DDMMCQ","DDMMC","DQ","DFT","DFCQ","DFC","DRM" D
"RTN","PSOERXX5",55,0)
 .I $L(@DOSEVAR) S DOSEFLG=1
"RTN","PSOERXX5",56,0)
 I DOSEFLG D C S @GBL@(CNT,0)="<Dose>"
"RTN","PSOERXX5",57,0)
 I $L(DCI) D C S @GBL@(CNT,0)="<DoseCompositeIndicator>"_DCI_"</DoseCompositeIndicator>"
"RTN","PSOERXX5",58,0)
 I $L(DDM) D C S @GBL@(CNT,0)="<DoseDeliveryMethodText>"_DDM_"</DoseDeliveryMethodText>"
"RTN","PSOERXX5",59,0)
 I $L(DDMCQ) D C S @GBL@(CNT,0)="<DoseDeliveryMethodCodeQualifier>"_DDMCQ_"</DoseDeliveryMethodCodeQualifier>"
"RTN","PSOERXX5",60,0)
 I $L(DDMC) D C S @GBL@(CNT,0)="<DoseDeliveryMethodCode>"_DDMC_"</DoseDeliveryMethodCode>"
"RTN","PSOERXX5",61,0)
 I $L(DDMMT) D C S @GBL@(CNT,0)="<DoseDeliveryMethodModifierText>"_DDMMT_"</DoseDeliveryMethodModifierText>"
"RTN","PSOERXX5",62,0)
 I $L(DDMMCQ) D C S @GBL@(CNT,0)="<DoseDeliveryMethodModifierCodeQualifier>"_DDMMCQ_"</DoseDeliveryMethodModifierCodeQualifier>"
"RTN","PSOERXX5",63,0)
 I $L(DDMMC) D C S @GBL@(CNT,0)="<DoseDeliveryMethodModifierCode>"_DDMMC_"</DoseDeliveryMethodModifierCode>"
"RTN","PSOERXX5",64,0)
 I $L(DQ) D C S @GBL@(CNT,0)="<DoseQuantity>"_DQ_"</DoseQuantity>"
"RTN","PSOERXX5",65,0)
 I $L(DFT) D C S @GBL@(CNT,0)="<DoseFormText>"_DFT_"</DoseFormText>"
"RTN","PSOERXX5",66,0)
 I $L(DFCQ) D C S @GBL@(CNT,0)="<DoseFormCodeQualifier>"_DFCQ_"</DoseFormCodeQualifier>"
"RTN","PSOERXX5",67,0)
 I $L(DFC) D C S @GBL@(CNT,0)="<DoseFormCode>"_DFC_"</DoseFormCode>"
"RTN","PSOERXX5",68,0)
 I $L(DRM) D C S @GBL@(CNT,0)="<DoseRangeModifier>"_DRM_"</DoseRangeModifier>"
"RTN","PSOERXX5",69,0)
 I DOSEFLG D C S @GBL@(CNT,0)="</Dose>"
"RTN","PSOERXX5",70,0)
 S DCALFLG=0
"RTN","PSOERXX5",71,0)
 F DCALVAR="DBMV","DBUM","DBUMCQ","DBUC","BMQ","BMV","CDM","CDUMT","CDUMCQ","CDUMC","DBRM" D
"RTN","PSOERXX5",72,0)
 .I $L(@DCALVAR) S DCALFLG=1
"RTN","PSOERXX5",73,0)
 I DCALFLG D C S @GBL@(CNT,0)="<DoseCalculation>"
"RTN","PSOERXX5",74,0)
 I $L(DBMV) D C S @GBL@(CNT,0)="<DosingBasisNumericValue>"_DBMV_"</DosingBasisNumericValue>"
"RTN","PSOERXX5",75,0)
 I $L(DBUM) D C S @GBL@(CNT,0)="<DosingBasisUnitofMeasureText>"_DBUM_"</DosingBasisUnitofMeasureText>"
"RTN","PSOERXX5",76,0)
 I $L(DBUMCQ) D C S @GBL@(CNT,0)="<DosingBasisUnitofMeasureCodeQualifier>"_DBUMCQ_"</DosingBasisUnitofMeasureCodeQualifier>"
"RTN","PSOERXX5",77,0)
 I $L(DBUC) D C S @GBL@(CNT,0)="<DosingBasisUnitofMeasureCode>"_DBUC_"</DosingBasisUnitofMeasureCode>"
"RTN","PSOERXX5",78,0)
 I $L(BMQ) D C S @GBL@(CNT,0)="<BodyMetricQualifier>"_BMQ_"</BodyMetricQualifier>"
"RTN","PSOERXX5",79,0)
 I $L(BMV) D C S @GBL@(CNT,0)="<BodyMetricValue>"_BMV_"</BodyMetricValue>"
"RTN","PSOERXX5",80,0)
 I $L(CDM) D C S @GBL@(CNT,0)="<CalculatedDoseNumeric>"_CDM_"</CalculatedDoseNumeric>"
"RTN","PSOERXX5",81,0)
 I $L(CDUMT) D C S @GBL@(CNT,0)="<CalculatedDoseUnitofMeasureText>"_CDUMT_"</CalculatedDoseUnitofMeasureText>"
"RTN","PSOERXX5",82,0)
 I $L(CDUMCQ) D C S @GBL@(CNT,0)="<CalculatedDoseUnitofMeasureCodeQualifier>"_CDUMCQ_"</CalculatedDoseUnitofMeasureCodeQualifier>"
"RTN","PSOERXX5",83,0)
 I $L(CDUMC) D C S @GBL@(CNT,0)="<CalculatedDoseUnitofMeasureCode>"_CDUMC_"</CalculatedDoseUnitofMeasureCode>"
"RTN","PSOERXX5",84,0)
 I $L(DBRM) D C S @GBL@(CNT,0)="<DosingBasisRangeModifier>"_DBRM_"</DosingBasisRangeModifier>"
"RTN","PSOERXX5",85,0)
 I DCALFLG D C S @GBL@(CNT,0)="</DoseCalculation>"
"RTN","PSOERXX5",86,0)
 S VFLG=0
"RTN","PSOERXX5",87,0)
 F VVAR="VN","VNCQ","VNC","VQ","VUMT","VUMCQ","VUMC","MVM" D
"RTN","PSOERXX5",88,0)
 .I $L(@VVAR) S VFLG=1
"RTN","PSOERXX5",89,0)
 I VFLG D C S @GBL@(CNT,0)="<Vehicle>"
"RTN","PSOERXX5",90,0)
 I $L(VN) D C S @GBL@(CNT,0)="<VehicleName>"_VN_"</VehicleName>"
"RTN","PSOERXX5",91,0)
 I $L(VNCQ) D C S @GBL@(CNT,0)="<VehicleNameCodeQualifier>"_VNCQ_"</VehicleNameCodeQualifier>"
"RTN","PSOERXX5",92,0)
 I $L(VNC) D C S @GBL@(CNT,0)="<VehicleNameCode>"_VNC_"</VehicleNameCode>"
"RTN","PSOERXX5",93,0)
 I $L(VQ) D C S @GBL@(CNT,0)="<VehicleQuantity>"_VQ_"</VehicleQuantity>"
"RTN","PSOERXX5",94,0)
 I $L(VUMT) D C S @GBL@(CNT,0)="<VehicleUnitOfMeasureText>"_VUMT_"</VehicleUnitOfMeasureText>"
"RTN","PSOERXX5",95,0)
 I $L(VUMCQ) D C S @GBL@(CNT,0)="<VehicleUnitOfMeasureCodeQualifier>"_VUMCQ_"</VehicleUnitOfMeasureCodeQualifier>"
"RTN","PSOERXX5",96,0)
 I $L(VUMC) D C S @GBL@(CNT,0)="<VehicleUnitOfMeasureCode>"_VUMC_"</VehicleUnitOfMeasureCode>"
"RTN","PSOERXX5",97,0)
 I $L(MVM) D C S @GBL@(CNT,0)="<MultipleVehicleModifier>"_MVM_"</MultipleVehicleModifier>"
"RTN","PSOERXX5",98,0)
 I VFLG D C S @GBL@(CNT,0)="</Vehicle>"
"RTN","PSOERXX5",99,0)
 S ROAFLG=0
"RTN","PSOERXX5",100,0)
 F ROAVAR="RAT","RACQ","RAC","MRAM" D
"RTN","PSOERXX5",101,0)
 .I $L(@ROAVAR) S ROAFLG=1
"RTN","PSOERXX5",102,0)
 I ROAFLG D C S @GBL@(CNT,0)="<RouteofAdministration>"
"RTN","PSOERXX5",103,0)
 I $L(RAT) D C S @GBL@(CNT,0)="<RouteofAdministrationText>"_RAT_"</RouteofAdministrationText>"
"RTN","PSOERXX5",104,0)
 I $L(RACQ) D C S @GBL@(CNT,0)="<RouteofAdministrationCodeQualifier>"_RACQ_"</RouteofAdministrationCodeQualifier>"
"RTN","PSOERXX5",105,0)
 I $L(RAC) D C S @GBL@(CNT,0)="<RouteofAdministrationCode>"_RAC_"</RouteofAdministrationCode>"
"RTN","PSOERXX5",106,0)
 I $L(MRAM) D C S @GBL@(CNT,0)="<MultipleRouteofAdministrationModifier>"_MRAM_"</MultipleRouteofAdministrationModifier>"
"RTN","PSOERXX5",107,0)
 I ROAFLG D C S @GBL@(CNT,0)="</RouteofAdministration>"
"RTN","PSOERXX5",108,0)
 S SOAFLG=0
"RTN","PSOERXX5",109,0)
 F SOAVAR="SAT","SACQ","SAC","MATM" D
"RTN","PSOERXX5",110,0)
 .I $L(@SOAVAR) S SOAFLG=1
"RTN","PSOERXX5",111,0)
 I SOAFLG D C S @GBL@(CNT,0)="<SiteofAdministration>"
"RTN","PSOERXX5",112,0)
 I $L(SAT) D C S @GBL@(CNT,0)="<SiteofAdministrationText>"_SAT_"</SiteofAdministrationText>"
"RTN","PSOERXX5",113,0)
 I $L(SACQ) D C S @GBL@(CNT,0)="<SiteofAdministrationCodeQualifier>"_SACQ_"</SiteofAdministrationCodeQualifier>"
"RTN","PSOERXX5",114,0)
 I $L(SAC) D C S @GBL@(CNT,0)="<SiteofAdministrationCode>"_SAC_"</SiteofAdministrationCode>"
"RTN","PSOERXX5",115,0)
 I $L(MATM) D C S @GBL@(CNT,0)="<MultipleAdministrationTimingModifier>"_MATM_"</MultipleAdministrationTimingModifier>"
"RTN","PSOERXX5",116,0)
 I SOAFLG D C S @GBL@(CNT,0)="</SiteofAdministration>"
"RTN","PSOERXX5",117,0)
 S TIMFLG=0
"RTN","PSOERXX5",118,0)
 F TIMVAR="ATT","ATCQ","ATC","TMATM","RM","RUMT","RUMCQ","RUMC","TPBT","TPBCQ","TPBC","FNV","FUT","FUCQ","FUC","VFM","INV","IUT","IUCQ","IUC","VIM" D
"RTN","PSOERXX5",119,0)
 .I $L(@TIMVAR) S TIMFLG=1
"RTN","PSOERXX5",120,0)
 I TIMFLG D C S @GBL@(CNT,0)="<Timing>"
"RTN","PSOERXX5",121,0)
 I $L(ATT) D C S @GBL@(CNT,0)="<AdministrationTimingText>"_ATT_"</AdministrationTimingText>"
"RTN","PSOERXX5",122,0)
 I $L(ATCQ) D C S @GBL@(CNT,0)="<AdministrationTimingCodeQualifier>"_ATCQ_"</AdministrationTimingCodeQualifier>"
"RTN","PSOERXX5",123,0)
 I $L(ATC) D C S @GBL@(CNT,0)="<AdministrationTimingCode>"_ATC_"</AdministrationTimingCode>"
"RTN","PSOERXX5",124,0)
 I $L(TMATM) D C S @GBL@(CNT,0)="<MultipleAdministrationTimingModifier>"_TMATM_"</MultipleAdministrationTimingModifier>"
"RTN","PSOERXX5",125,0)
 I $L(RM) D C S @GBL@(CNT,0)="<RateofAdministration>"_RM_"</RateofAdministration>"
"RTN","PSOERXX5",126,0)
 I $L(RUMT) D C S @GBL@(CNT,0)="<RateUnitofMeasureText>"_RUMT_"</RateUnitofMeasureText>"
"RTN","PSOERXX5",127,0)
 I $L(RUMCQ) D C S @GBL@(CNT,0)="<RateUnitofMeasureCodeQualifier>"_RUMCQ_"</RateUnitofMeasureCodeQualifier>"
"RTN","PSOERXX5",128,0)
 I $L(RUMC) D C S @GBL@(CNT,0)="<RateUnitofMeasureCode>"_RUMC_"</RateUnitofMeasureCode>"
"RTN","PSOERXX5",129,0)
 I $L(TPBT) D C S @GBL@(CNT,0)="<TimePeriodBasisText>"_TPBT_"</TimePeriodBasisText>"
"RTN","PSOERXX5",130,0)
 I $L(TPBCQ) D C S @GBL@(CNT,0)="<TimePeriodBasisCodeQualifier>"_TPBCQ_"</TimePeriodBasisCodeQualifier>"
"RTN","PSOERXX5",131,0)
 I $L(TPBC) D C S @GBL@(CNT,0)="<TimePeriodBasisCode>"_TPBC_"</TimePeriodBasisCode>"
"RTN","PSOERXX5",132,0)
 I $L(FNV) D C S @GBL@(CNT,0)="<FrequencyNumericValue>"_FNV_"</FrequencyNumericValue>"
"RTN","PSOERXX5",133,0)
 I $L(FUT) D C S @GBL@(CNT,0)="<FrequencyUnitsText>"_FUT_"</FrequencyUnitsText>"
"RTN","PSOERXX5",134,0)
 I $L(FUCQ) D C S @GBL@(CNT,0)="<FrequencyUnitsCodeQualifier>"_FUCQ_"</FrequencyUnitsCodeQualifier>"
"RTN","PSOERXX5",135,0)
 I $L(FUC) D C S @GBL@(CNT,0)="<FrequencyUnitsCode>"_FUC_"</FrequencyUnitsCode>"
"RTN","PSOERXX5",136,0)
 I $L(VFM) D C S @GBL@(CNT,0)="<VariableFrequencyModifier>"_VFM_"</VariableFrequencyModifier>"
"RTN","PSOERXX5",137,0)
 I $L(INV) D C S @GBL@(CNT,0)="<IntervalNumericValue>"_INV_"</IntervalNumericValue>"
"RTN","PSOERXX5",138,0)
 I $L(IUT) D C S @GBL@(CNT,0)="<IntervalUnitsText>"_IUT_"</IntervalUnitsText>"
"RTN","PSOERXX5",139,0)
 I $L(IUCQ) D C S @GBL@(CNT,0)="<IntervalUnitsCodeQualifier>"_IUCQ_"</IntervalUnitsCodeQualifier>"
"RTN","PSOERXX5",140,0)
 I $L(IUC) D C S @GBL@(CNT,0)="<IntervalUnitsCode>"_IUC_"</IntervalUnitsCode>"
"RTN","PSOERXX5",141,0)
 I $L(VIM) D C S @GBL@(CNT,0)="<VariableIntervalModifier>"_VIM_"</VariableIntervalModifier>"
"RTN","PSOERXX5",142,0)
 I TIMFLG D C S @GBL@(CNT,0)="</Timing>"
"RTN","PSOERXX5",143,0)
 S DURFLG=0
"RTN","PSOERXX5",144,0)
 F DURVAR="DNV","DTEXT","DTCQ","DTC" D
"RTN","PSOERXX5",145,0)
 .I $L(@DURVAR) S DURFLG=1
"RTN","PSOERXX5",146,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE
"RTN","PSOERXX5",147,0)
 I DURFLG D C S @GBL@(CNT,0)="<Duration>"
"RTN","PSOERXX5",148,0)
 I $L(DNV) D C S @GBL@(CNT,0)="<DurationNumericValue>"_DNV_"</DurationNumericValue>"
"RTN","PSOERXX5",149,0)
 I $L(DTEXT) D C S @GBL@(CNT,0)="<DurationText>"_DTEXT_"</DurationText>"
"RTN","PSOERXX5",150,0)
 I $L(DTCQ) D C S @GBL@(CNT,0)="<DurationTextCodeQualifier>"_DTCQ_"</DurationTextCodeQualifier>"
"RTN","PSOERXX5",151,0)
 I $L(DTC) D C S @GBL@(CNT,0)="<DurationTextCode>"_DTC_"</DurationTextCode>"
"RTN","PSOERXX5",152,0)
 I DURFLG D C S @GBL@(CNT,0)="</Duration>"
"RTN","PSOERXX5",153,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXX5",154,0)
 S MDRFLG=0
"RTN","PSOERXX5",155,0)
 F MDVAR="MDRNV","MDRUT","MDRCQ","MDRUC","MDRVN","MDRVUT","MDRVUCQ","MDRVUC","MDRVDM" D
"RTN","PSOERXX5",156,0)
 .I $L(@MDVAR) S MDRFLG=1
"RTN","PSOERXX5",157,0)
 I MDRFLG D C S @GBL@(CNT,0)="<MaximumDoseRestriction>"
"RTN","PSOERXX5",158,0)
 I $L(MDRNV) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionNumericValue>"_MDRNV_"</MaximumDoseRestrictionNumericValue>"
"RTN","PSOERXX5",159,0)
 I $L(MDRUT) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionUnitsText>"_MDRUT_"</MaximumDoseRestrictionUnitsText>"
"RTN","PSOERXX5",160,0)
 I $L(MDRCQ) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionCodeQualifier>"_MDRCQ_"</MaximumDoseRestrictionCodeQualifier>"
"RTN","PSOERXX5",161,0)
 I $L(MDRUC) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionUnitsCode>"_MDRUC_"</MaximumDoseRestrictionUnitsCode>"
"RTN","PSOERXX5",162,0)
 I $L(MDRVN) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionVariableNumericValue>"_MDRVN_"</MaximumDoseRestrictionVariableNumericValue>"
"RTN","PSOERXX5",163,0)
 I $L(MDRVUT) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionVariableUnitsText>"_MDRVUT_"</MaximumDoseRestrictionVariableUnitsText>"
"RTN","PSOERXX5",164,0)
 I $L(MDRVUCQ) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionVariableUnitsCodeQualifier>"_MDRVUCQ_"</MaximumDoseRestrictionVariableUnitsCodeQualifier>"
"RTN","PSOERXX5",165,0)
 I $L(MDRVUC) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionVariableUnitsCode>"_MDRVUC_"</MaximumDoseRestrictionVariableUnitsCode>"
"RTN","PSOERXX5",166,0)
 I $L(MDRVDM) D C S @GBL@(CNT,0)="<MaximumDoseRestrictionVariableDurationModifier>"_MDRVDM_"</MaximumDoseRestrictionVariableDurationModifier>"
"RTN","PSOERXX5",167,0)
 I MDRFLG D C S @GBL@(CNT,0)="</MaximumDoseRestriction>"
"RTN","PSOERXX5",168,0)
 S INDFLG=0
"RTN","PSOERXX5",169,0)
 F INDVAR="IPT","IPCQ","IPC","IT","ITCQ","ITC","IVT","IVU","IVUMT","IVUMCQ","IVM" D
"RTN","PSOERXX5",170,0)
 .I $L(@INDVAR) S INDFLG=1
"RTN","PSOERXX5",171,0)
 I INDFLG D C S @GBL@(CNT,0)="<Indication>"
"RTN","PSOERXX5",172,0)
 I $L(IPT) D C S @GBL@(CNT,0)="<IndicationPrecursorText>"_IPT_"</IndicationPrecursorText>"
"RTN","PSOERXX5",173,0)
 I $L(IPCQ) D C S @GBL@(CNT,0)="<IndicationPrecursorCodeQualifier>"_IPCQ_"</IndicationPrecursorCodeQualifier>"
"RTN","PSOERXX5",174,0)
 I $L(IPC) D C S @GBL@(CNT,0)="<IndicationPrecursorCode>"_IPC_"</IndicationPrecursorCode>"
"RTN","PSOERXX5",175,0)
 I $L(IT) D C S @GBL@(CNT,0)="<IndicationText>"_IT_"</IndicationText>"
"RTN","PSOERXX5",176,0)
 I $L(ITCQ) D C S @GBL@(CNT,0)="<IndicationTextCodeQualifier>"_ITCQ_"</IndicationTextCodeQualifier>"
"RTN","PSOERXX5",177,0)
 I $L(ITC) D C S @GBL@(CNT,0)="<IndicationTextCode>"_ITC_"</IndicationTextCode>"
"RTN","PSOERXX5",178,0)
 I $L(IVT) D C S @GBL@(CNT,0)="<IndicationValueText>"_IVT_"</IndicationValueText>"
"RTN","PSOERXX5",179,0)
 I $L(IVU) D C S @GBL@(CNT,0)="<IndicationValueUnit>"_IVU_"</IndicationValueUnit>"
"RTN","PSOERXX5",180,0)
 I $L(IVUMT) D C S @GBL@(CNT,0)="<IndicationValueUnitofMeasureText>"_IVUMT_"</IndicationValueUnitofMeasureText>"
"RTN","PSOERXX5",181,0)
 I $L(IVUMCQ) D C S @GBL@(CNT,0)="<IndicationValueUnitofMeasureCodeQualifier>"_IVUMCQ_"</IndicationValueUnitofMeasureCodeQualifier>"
"RTN","PSOERXX5",182,0)
 I $L(IVUMC) D C S @GBL@(CNT,0)="<IndicationValueUnitofMeasureCode>"_IVUMC_"</IndicationValueUnitofMeasureCode>"
"RTN","PSOERXX5",183,0)
 I $L(IVM) D C S @GBL@(CNT,0)="<IndicationVariableModifier>"_IVM_"</IndicationVariableModifier>"
"RTN","PSOERXX5",184,0)
 I INDFLG D C S @GBL@(CNT,0)="</Indication>"
"RTN","PSOERXX5",185,0)
 I $L(STOPI) D
"RTN","PSOERXX5",186,0)
 .D C S @GBL@(CNT,0)="<Stop>"
"RTN","PSOERXX5",187,0)
 .D C S @GBL@(CNT,0)="<StopIndicator>"_STOPI_"</StopIndicator>"
"RTN","PSOERXX5",188,0)
 .D C S @GBL@(CNT,0)="</Stop>"
"RTN","PSOERXX5",189,0)
 D C S @GBL@(CNT,0)="</StructuredSIG>"
"RTN","PSOERXX5",190,0)
 Q
"RTN","PSOERXX5",191,0)
C ;
"RTN","PSOERXX5",192,0)
 S CNT=$G(CNT)+1
"RTN","PSOERXX5",193,0)
 Q
"RTN","PSOORAL1")
0^14^B156831785^B141679409
"RTN","PSOORAL1",1,0)
PSOORAL1 ;BHAM ISC/SAB - Build Listman activity logs ; 12/4/07 12:25pm
"RTN","PSOORAL1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**71,156,148,247,240,287,354,367,408,482,508,551**;DEC 1997;Build 37
"RTN","PSOORAL1",3,0)
 N RX0,VALMCNT K DIR,DTOUT,DUOUT,DIRUT,^TMP("PSOAL",$J) S DA=$P(PSOLST(ORN),"^",2),RX0=^PSRX(DA,0),J=DA,RX2=$G(^(2)),R3=$G(^(3)),CMOP=$O(^PSRX(DA,4,0))
"RTN","PSOORAL1",4,0)
 S IEN=0,DIR(0)="LO^1:"_$S(CMOP:10,1:9),DIR("A",1)=" ",DIR("A",2)="Select Activity Log by  number",DIR("A",3)="1.  Refill    2.  Partial     3.  Activity   4.  Labels      5.  Copay"
"RTN","PSOORAL1",5,0)
 S DIR("A")=$S(CMOP:"6.  ECME      7.  SPMP        8.  eRx Log    9.  CMOP Events 10.  All Logs    ",1:"6.  ECME      7.  SPMP        8.  eRx Log    9.  All Logs")
"RTN","PSOORAL1",6,0)
 S DIR("B")=$S(CMOP:10,1:9) D ^DIR S PSOELSE=+Y I +Y S Y=$S(CMOP&(Y[10):"1,2,3,4,5,6,7,8,9",'CMOP&(Y[9):"1,2,3,4,5,6,7,8",1:Y) S ACT=Y D FULL^VALM1 D
"RTN","PSOORAL1",7,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Rx #: "_$P(RX0,"^")_"   Original Fill Released: " I $P(RX2,"^",13) S DTT=$P(RX2,"^",13) D DAT S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_DAT K DAT,DTT
"RTN","PSOORAL1",8,0)
 .I $P(RX2,"^",15) S DTT=$P(RX2,"^",15) D DAT S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"(Returned to Stock "_DAT_")" K DAT,DTT
"RTN","PSOORAL1",9,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Routing: "_$S($P(RX0,"^",11)="W":"Window",1:"Mail")_$S($P($G(^PSRX(DA,"OR1")),"^",5):"      Finished by: "_$P(^VA(200,$P(^PSRX(DA,"OR1"),"^",5),0),"^"),1:"")
"RTN","PSOORAL1",10,0)
 .D:$G(^PSRX(DA,"H"))]""&($P(PSOLST(ORN),"^",3)="HOLD") HLD^PSOORAL2
"RTN","PSOORAL1",11,0)
 .F LOG=1:1:$L(ACT,",") Q:$P(ACT,",",LOG)']""  S LBL=$P(ACT,",",LOG) D @$S(LBL=1:"RF^PSOORAL2",LBL=2:"PAR^PSOORAL2",LBL=3:"ACT",LBL=5:"COPAY",LBL=6:"ECME",LBL=7:"SPMP",LBL=8:"ERX",LBL=9:"^PSORXVW2",1:"LBL")
"RTN","PSOORAL1",12,0)
 I 'PSOELSE S VALMBCK="" K PSOELSE Q 
"RTN","PSOORAL1",13,0)
 K ST0,RFL,RFLL,RFL1,II,J,N,PHYS,L1,DIRUT,PSDIV,PSEXDT,MED,M1,FFX,DTT,DAT,R3,RTN,SIG,STA,P1,PL,P0,Z0,Z1,EXDT,IFN,DIR,DUOUT,DTOUT,PSOELSE
"RTN","PSOORAL1",14,0)
 K LBL,I,RFDATE,%H,%I,RN,RFT
"RTN","PSOORAL1",15,0)
 S PSOAL=IEN K IEN,ACT,LBL,LOG D EN^PSOORAL S VALMBCK="R"
"RTN","PSOORAL1",16,0)
 Q
"RTN","PSOORAL1",17,0)
ACT ;activity log
"RTN","PSOORAL1",18,0)
 N CNT
"RTN","PSOORAL1",19,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Activity Log:"
"RTN","PSOORAL1",20,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#   Date/Time            Reason         Rx Ref         Initiator Of Activity",IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSOORAL1",21,0)
 I '$O(^PSRX(DA,"A",0)) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There's NO Activity to report" Q
"RTN","PSOORAL1",22,0)
 S CNT=0
"RTN","PSOORAL1",23,0)
 F N=0:0 S N=$O(^PSRX(DA,"A",N)) Q:'N  S P1=^(N,0) D
"RTN","PSOORAL1",24,0)
 .I $P(P1,"^",2)="M" Q
"RTN","PSOORAL1",25,0)
 .S DAT=$$FMTE^XLFDT($P(P1,"^"),2)_"             "
"RTN","PSOORAL1",26,0)
 .S IEN=IEN+1,CNT=CNT+1,^TMP("PSOAL",$J,IEN,0)=CNT_"   "_$E(DAT,1,21),$P(RN," ",15)=" ",REA=$P(P1,"^",2)
"RTN","PSOORAL1",27,0)
 .S REA=$F("HUCELPRWSIVDABXGKNO",REA)-1
"RTN","PSOORAL1",28,0)
 .I REA D
"RTN","PSOORAL1",29,0)
 ..S STA=$P("HOLD^UNHOLD^DISCONTINUED^EDIT^RENEWED^PARTIAL^REINSTATE^REPRINT^SUSPENSE^RETURNED^INTERVENTION^DELETED^DRUG INTERACTION^PROCESSED^X-INTERFACE^PATIENT INSTR.^PKI/DEA^DISP COMPLETED^IERX^","^",REA)
"RTN","PSOORAL1",30,0)
 ..S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_STA_$E(RN,$L(STA)+1,15)
"RTN","PSOORAL1",31,0)
 .E  S $P(STA," ",15)=" ",^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_STA
"RTN","PSOORAL1",32,0)
 .K STA,RN S $P(RN," ",15)=" ",RF=+$P(P1,"^",4)
"RTN","PSOORAL1",33,0)
 .S RFT=$S(RF>0&(RF<6):"REFILL "_RF,RF=6:"PARTIAL",RF>6:"REFILL "_(RF-1),1:"ORIGINAL")
"RTN","PSOORAL1",34,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_RFT_$E(RN,$L(RFT)+1,15)_$E($S($D(^VA(200,+$P(P1,"^",3),0)):$P(^(0),"^"),1:$P(P1,"^",3)),1,24)
"RTN","PSOORAL1",35,0)
 .;S:$P(P1,"^",5)]"" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Comments: "_$P(P1,"^",5)
"RTN","PSOORAL1",36,0)
 .I $P(P1,"^",5)]"" N PSOACBRK,PSOACBRV D
"RTN","PSOORAL1",37,0)
 ..S PSOACBRV=$P(P1,"^",5)
"RTN","PSOORAL1",38,0)
 ..;PSO*7*240 Use fileman for parsing
"RTN","PSOORAL1",39,0)
 ..K ^UTILITY($J,"W") S X="Comments: "_PSOACBRV,(DIWR,DIWL)=1,DIWF="C80" D ^DIWP F I=1:1:^UTILITY($J,"W",1) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=$G(^UTILITY($J,"W",1,I,0))
"RTN","PSOORAL1",40,0)
 .I $P($G(^PSRX(DA,"A",N,1)),"^")]"" S IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0)," ",5)=$P($G(^PSRX(DA,"A",N,1)),"^") I $P($G(^PSRX(DA,"A",N,1)),"^",2)]"" S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_":"_$P($G(^PSRX(DA,"A",N,1)),"^",2)
"RTN","PSOORAL1",41,0)
 .I $O(^PSRX(DA,"A",N,2,0)) F I=0:0 S I=$O(^PSRX(DA,"A",N,2,I)) Q:'I  S MIG=^PSRX(DA,"A",N,2,I,0) D
"RTN","PSOORAL1",42,0)
 ..S:MIG["Mail Tracking Info.: " IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0)," ",9)=" "
"RTN","PSOORAL1",43,0)
 ..F SG=1:1:$L(MIG) S:$L(^TMP("PSOAL",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0)," ",9)=" " S:$P(MIG," ",SG)'="" ^TMP("PSOAL",$J,IEN,0)=$G(^TMP("PSOAL",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORAL1",44,0)
 K MIG,SG,I,^UTILITY($J,"W"),DIWF,DIWL,DIWR
"RTN","PSOORAL1",45,0)
 Q
"RTN","PSOORAL1",46,0)
LBL ;label log
"RTN","PSOORAL1",47,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Label Log:"
"RTN","PSOORAL1",48,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#   Date        Rx Ref                    Printed By",IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSOORAL1",49,0)
 I '$O(^PSRX(DA,"L",0)) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There are NO Labels printed." Q
"RTN","PSOORAL1",50,0)
 F L1=0:0 S L1=$O(^PSRX(DA,"L",L1)) Q:'L1  S LBL=^PSRX(DA,"L",L1,0),DTT=$P(^(0),"^") D DAT D
"RTN","PSOORAL1",51,0)
 . S $P(RN," ",26)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=L1_"   "_DAT_"    ",RFT=$S($P(LBL,"^",2):"REFILL "_$P(LBL,"^",2),1:"ORIGINAL"),RFT=RFT_$E(RN,$L(RFT)+1,26)
"RTN","PSOORAL1",52,0)
 . S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_RFT_$P($G(^VA(200,$P(LBL,"^",4),0)),"^"),IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Comments: "_$P(LBL,"^",3)
"RTN","PSOORAL1",53,0)
 . N FDAMGDOC S FDAMGDOC=$G(^PSRX(DA,"L",L1,"FDA"))
"RTN","PSOORAL1",54,0)
 . I FDAMGDOC'="" D
"RTN","PSOORAL1",55,0)
 . . S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="FDA Med Guide: "_$E(FDAMGDOC,1,61)
"RTN","PSOORAL1",56,0)
 . . I $L(FDAMGDOC)>61 D
"RTN","PSOORAL1",57,0)
 . . . F  Q:$E(FDAMGDOC,62,999)=""  D
"RTN","PSOORAL1",58,0)
 . . . . S FDAMGDOC=$E(FDAMGDOC,62,999),IEN=IEN+1
"RTN","PSOORAL1",59,0)
 . . . . S ^TMP("PSOAL",$J,IEN,0)=$E(FDAMGDOC,1,61)
"RTN","PSOORAL1",60,0)
 Q
"RTN","PSOORAL1",61,0)
 ;
"RTN","PSOORAL1",62,0)
COPAY ;Copay activity log
"RTN","PSOORAL1",63,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Copay Activity Log:"
"RTN","PSOORAL1",64,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#   Date        Reason               Rx Ref         Initiator Of Activity",IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSOORAL1",65,0)
 I '$O(^PSRX(DA,"COPAY",0)) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There's NO Copay activity to report" Q
"RTN","PSOORAL1",66,0)
 F N=0:0 S N=$O(^PSRX(DA,"COPAY",N)) Q:'N  S P1=^(N,0),DTT=P1\1 D DAT D
"RTN","PSOORAL1",67,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=N_"   "_DAT_"    ",$P(RN," ",21)=" ",REA=$P(P1,"^",2),REA=$F("ARICE",REA)-1
"RTN","PSOORAL1",68,0)
 .I REA D
"RTN","PSOORAL1",69,0)
 ..S STA=$P("ANNUAL CAP REACHED^COPAY RESET^IB-INITIATED COPAY^REMOVE COPAY CHARGE^RX EDITED^","^",REA)
"RTN","PSOORAL1",70,0)
 ..S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_STA_$E(RN,$L(STA)+1,21)
"RTN","PSOORAL1",71,0)
 .E  S $P(STA," ",21)=" ",^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_STA
"RTN","PSOORAL1",72,0)
 .K STA,RN S $P(RN," ",15)=" ",RF=+$P(P1,"^",4)
"RTN","PSOORAL1",73,0)
 .S RFT=$S(RF>0:"REFILL "_RF,1:"ORIGINAL")
"RTN","PSOORAL1",74,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_RFT_$E(RN,$L(RFT)+1,15)_$S($D(^VA(200,+$P(P1,"^",3),0)):$P(^(0),"^"),1:$P(P1,"^",3))
"RTN","PSOORAL1",75,0)
 .S:$P(P1,"^",5)]""!($P(P1,"^",6)]"")!($P(P1,"^",7)]"") IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Comment: "_$P(P1,"^",5)
"RTN","PSOORAL1",76,0)
 .I $P(P1,"^",6)]"" S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"  Old value="_$P(P1,"^",6)_"   New value="_$P(P1,"^",7)
"RTN","PSOORAL1",77,0)
 Q
"RTN","PSOORAL1",78,0)
 ;
"RTN","PSOORAL1",79,0)
ECME ; ECME activity log
"RTN","PSOORAL1",80,0)
 ;
"RTN","PSOORAL1",81,0)
 N DIWF,DIWL,DIWR,I,II,III,LINE,PSOAR,PSOCNT,PSOCNT1,PSOCOMMENT
"RTN","PSOORAL1",82,0)
 N PSODATA,PSODATE,PSODATE1,PSOFIELDS,PSOFILE,PSOIENS,PSOLINE
"RTN","PSOORAL1",83,0)
 N PSOREFILL,PSOREFILL1,PSOUSER,PSOUSER1
"RTN","PSOORAL1",84,0)
 ;
"RTN","PSOORAL1",85,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" "
"RTN","PSOORAL1",86,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="ECME Log:"
"RTN","PSOORAL1",87,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#   Date/Time           Rx Ref          Initiator Of Activity"
"RTN","PSOORAL1",88,0)
 S IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSOORAL1",89,0)
 ;
"RTN","PSOORAL1",90,0)
 ; The comments from ACTIVITY LOG (#52.3) and REJECT INFO (#52.25)
"RTN","PSOORAL1",91,0)
 ; will be compiled in array PSOAR. This array will allow comments
"RTN","PSOORAL1",92,0)
 ; from each sub-file to be sorted in ascending order by date.
"RTN","PSOORAL1",93,0)
 ; A counter (PSOCNT) will be used to accommodate multiple 
"RTN","PSOORAL1",94,0)
 ; comments with the exact same date/time.
"RTN","PSOORAL1",95,0)
 ;
"RTN","PSOORAL1",96,0)
 ; PSOAR array definition:
"RTN","PSOORAL1",97,0)
 ;
"RTN","PSOORAL1",98,0)
 ;  PSOAR(PSODATE)=PSOCNT
"RTN","PSOORAL1",99,0)
 ;  PSOAR(PSODATE,PSOCNT)=PSODATE^PSOUSER1^PSOREFILL1^PSOCOMMENT
"RTN","PSOORAL1",100,0)
 ;  PSOAR(PSODATE,PSOCNT,PSOCNT1)=Additional Comments (if any)
"RTN","PSOORAL1",101,0)
 ;
"RTN","PSOORAL1",102,0)
 ;   PSODATE ---- Date/time of comment - internal format
"RTN","PSOORAL1",103,0)
 ;   PSOCNT ----- Counter of comments, by date
"RTN","PSOORAL1",104,0)
 ;   PSOCNT1 ---- Counter of additional comments (if any)
"RTN","PSOORAL1",105,0)
 ;   PSOUSER1 --- User who entered comment - external format
"RTN","PSOORAL1",106,0)
 ;   PSOREFILL1 - Refill number - external format
"RTN","PSOORAL1",107,0)
 ;   PSOCOMMENT - Comment
"RTN","PSOORAL1",108,0)
 ;
"RTN","PSOORAL1",109,0)
 ; Kill PSOAR to initialize array
"RTN","PSOORAL1",110,0)
 ;
"RTN","PSOORAL1",111,0)
 K PSOAR
"RTN","PSOORAL1",112,0)
 ;
"RTN","PSOORAL1",113,0)
 ; Loop through ACTIVITY LOG (file #52.3) searching for ECME Entries.
"RTN","PSOORAL1",114,0)
 ; ECME Entries are defined as REASON="M".
"RTN","PSOORAL1",115,0)
 ;
"RTN","PSOORAL1",116,0)
 ; ACTIVITY LOG Fields:
"RTN","PSOORAL1",117,0)
 ;  .01 = Activity Log (Date)
"RTN","PSOORAL1",118,0)
 ;  .02 = Reason
"RTN","PSOORAL1",119,0)
 ;  .03 = Initiator of Activity (User)
"RTN","PSOORAL1",120,0)
 ;  .04 = RX Reference (Refill #)
"RTN","PSOORAL1",121,0)
 ;  .05 = Comment
"RTN","PSOORAL1",122,0)
 ;
"RTN","PSOORAL1",123,0)
 ; The above fields will be stored in array PSODATA via a call to ^DIQ.
"RTN","PSOORAL1",124,0)
 ; 
"RTN","PSOORAL1",125,0)
 S I=0
"RTN","PSOORAL1",126,0)
 F  S I=$O(^PSRX(DA,"A",I)) Q:'I  D
"RTN","PSOORAL1",127,0)
 . ;
"RTN","PSOORAL1",128,0)
 . S PSOCNT=0
"RTN","PSOORAL1",129,0)
 . S PSOFILE=52.3
"RTN","PSOORAL1",130,0)
 . S PSOIENS=I_","_DA_","
"RTN","PSOORAL1",131,0)
 . S PSOFIELDS=".01;.02;.03;.04;.05"
"RTN","PSOORAL1",132,0)
 . K PSODATA
"RTN","PSOORAL1",133,0)
 . ;
"RTN","PSOORAL1",134,0)
 . D GETS^DIQ(PSOFILE,I_","_DA,PSOFIELDS,"IE","PSODATA")
"RTN","PSOORAL1",135,0)
 . ;
"RTN","PSOORAL1",136,0)
 . ; If reason is not M (ECME), do not include comment.
"RTN","PSOORAL1",137,0)
 . ;
"RTN","PSOORAL1",138,0)
 . I $G(PSODATA(PSOFILE,PSOIENS,.02,"I"))'="M" Q
"RTN","PSOORAL1",139,0)
 . ;
"RTN","PSOORAL1",140,0)
 . S PSODATE=$G(PSODATA(PSOFILE,PSOIENS,.01,"I"))
"RTN","PSOORAL1",141,0)
 . S PSOUSER1=$G(PSODATA(PSOFILE,PSOIENS,.03,"E"))
"RTN","PSOORAL1",142,0)
 . S PSOREFILL1=$G(PSODATA(PSOFILE,PSOIENS,.04,"E"))
"RTN","PSOORAL1",143,0)
 . S PSOCOMMENT=$G(PSODATA(PSOFILE,PSOIENS,.05,"I"))
"RTN","PSOORAL1",144,0)
 . ;
"RTN","PSOORAL1",145,0)
 . S PSOCNT=$G(PSOAR(PSODATE))+1
"RTN","PSOORAL1",146,0)
 . S PSOAR(PSODATE)=PSOCNT
"RTN","PSOORAL1",147,0)
 . S PSOAR(PSODATE,PSOCNT)=$$FMTE^XLFDT(PSODATE,2)_U_PSOUSER1_U_PSOREFILL1_U_PSOCOMMENT
"RTN","PSOORAL1",148,0)
 . ;
"RTN","PSOORAL1",149,0)
 . ; Node 2 of the ACTIVITY LOG contains any additional comments.
"RTN","PSOORAL1",150,0)
 . ; Loop through OTHER COMMENTS sub-file (file #52.34) to add to PSOAR 
"RTN","PSOORAL1",151,0)
 . ; for reporting.
"RTN","PSOORAL1",152,0)
 . ;
"RTN","PSOORAL1",153,0)
 . I $D(^PSRX(DA,"A",I,2)) D
"RTN","PSOORAL1",154,0)
 . . S PSOCNT1=0
"RTN","PSOORAL1",155,0)
 . . S II=0
"RTN","PSOORAL1",156,0)
 . . F  S II=$O(^PSRX(DA,"A",I,2,II)) Q:'II  D
"RTN","PSOORAL1",157,0)
 . . . S PSOCNT1=PSOCNT1+1
"RTN","PSOORAL1",158,0)
 . . . S PSOAR(PSODATE,PSOCNT,PSOCNT1)=$$GET1^DIQ(52.34,II_","_I_","_DA,.01)
"RTN","PSOORAL1",159,0)
 ;
"RTN","PSOORAL1",160,0)
 ; Loop through REJECT INFO Comments (File #52.2551) searching for
"RTN","PSOORAL1",161,0)
 ; User Created entries.
"RTN","PSOORAL1",162,0)
 ; User Created entries are defined as User'="POSTMASTER"
"RTN","PSOORAL1",163,0)
 ;
"RTN","PSOORAL1",164,0)
 ; REJECT INFO Comments Fields:
"RTN","PSOORAL1",165,0)
 ;  .01  = Date/Time
"RTN","PSOORAL1",166,0)
 ;  1    = User
"RTN","PSOORAL1",167,0)
 ;  2    = Comments
"RTN","PSOORAL1",168,0)
 ;
"RTN","PSOORAL1",169,0)
 ; The above fields will be stored in array PSODATA via a call to ^DIQ.
"RTN","PSOORAL1",170,0)
 ;
"RTN","PSOORAL1",171,0)
 S I=0 F  S I=$O(^PSRX(DA,"REJ",I)) Q:'I  S PSODATE=0 F  S PSODATE=$O(^PSRX(DA,"REJ",I,"COM","B",PSODATE)) Q:'PSODATE  D
"RTN","PSOORAL1",172,0)
 . S III=0 F  S III=$O(^PSRX(DA,"REJ",I,"COM","B",PSODATE,III)) Q:'III  D 
"RTN","PSOORAL1",173,0)
 . . S REC=$G(^PSRX(DA,"REJ",I,"COM",III,0))
"RTN","PSOORAL1",174,0)
 . . S PSOUSER=$P(REC,U,2),PSOUSER1=$P($G(^VA(200,PSOUSER,0)),U,1)
"RTN","PSOORAL1",175,0)
 . . S PSOCOMMENT=$P(REC,U,3)
"RTN","PSOORAL1",176,0)
 . . ;
"RTN","PSOORAL1",177,0)
 . . S PSOREFILL=$$GET1^DIQ(52.25,I_","_DA,5)
"RTN","PSOORAL1",178,0)
 . . I PSOREFILL=0 S PSOREFILL1="ORIGINAL"
"RTN","PSOORAL1",179,0)
 . . E  S PSOREFILL1="REFILL #"_PSOREFILL
"RTN","PSOORAL1",180,0)
 . . ;
"RTN","PSOORAL1",181,0)
 . . S PSOCNT=$G(PSOAR(PSODATE))+1
"RTN","PSOORAL1",182,0)
 . . S PSOAR(PSODATE)=PSOCNT
"RTN","PSOORAL1",183,0)
 . . S PSOAR(PSODATE,PSOCNT)=$$FMTE^XLFDT(PSODATE,2)_U_PSOUSER1_U_PSOREFILL1_U_PSOCOMMENT
"RTN","PSOORAL1",184,0)
 ;
"RTN","PSOORAL1",185,0)
 ; If PSOAR array contains no data, there is No ECME Activity to report. 
"RTN","PSOORAL1",186,0)
 ;
"RTN","PSOORAL1",187,0)
 I '$D(PSOAR) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There's NO ECME Activity to report" Q
"RTN","PSOORAL1",188,0)
 ;
"RTN","PSOORAL1",189,0)
 ; Loop through PSOAR array and assign data to ^TMP array for reporting.
"RTN","PSOORAL1",190,0)
 ; 
"RTN","PSOORAL1",191,0)
 ; PSOLINE = ECME Log Entry line number.
"RTN","PSOORAL1",192,0)
 ;
"RTN","PSOORAL1",193,0)
 S (PSODATE1,PSOREFILL,PSOUSER)=""
"RTN","PSOORAL1",194,0)
 S PSODATE="" F  S PSODATE=$O(PSOAR(PSODATE)) Q:PSODATE=""  D
"RTN","PSOORAL1",195,0)
 . S PSOCNT="" F  S PSOCNT=$O(PSOAR(PSODATE,PSOCNT)) Q:PSOCNT=""  D
"RTN","PSOORAL1",196,0)
 . . S PSODATA=$G(PSOAR(PSODATE,PSOCNT))
"RTN","PSOORAL1",197,0)
 . . ;
"RTN","PSOORAL1",198,0)
 . . S IEN=IEN+1
"RTN","PSOORAL1",199,0)
 . . I '$D(PSOLINE) S PSOLINE=0
"RTN","PSOORAL1",200,0)
 . . S PSOLINE=PSOLINE+1
"RTN","PSOORAL1",201,0)
 . . S PSODATE1=$P(PSODATA,U)
"RTN","PSOORAL1",202,0)
 . . S PSOUSER=$P(PSODATA,U,2)
"RTN","PSOORAL1",203,0)
 . . S PSOREFILL=$P(PSODATA,U,3)
"RTN","PSOORAL1",204,0)
 . . S LINE=PSOLINE
"RTN","PSOORAL1",205,0)
 . . S $E(LINE,5)=PSODATE1
"RTN","PSOORAL1",206,0)
 . . S $E(LINE,25)=PSOREFILL
"RTN","PSOORAL1",207,0)
 . . S $E(LINE,41)=PSOUSER
"RTN","PSOORAL1",208,0)
 . . S ^TMP("PSOAL",$J,IEN,0)=LINE
"RTN","PSOORAL1",209,0)
 . . ;
"RTN","PSOORAL1",210,0)
 . . ; D ^DIWP formats comments into ^UTILITY($J,"W")
"RTN","PSOORAL1",211,0)
 . . ;
"RTN","PSOORAL1",212,0)
 . . S PSOCOMMENT=$P(PSODATA,"^",4)
"RTN","PSOORAL1",213,0)
 . . ;
"RTN","PSOORAL1",214,0)
 . . K ^UTILITY($J,"W")
"RTN","PSOORAL1",215,0)
 . . ;
"RTN","PSOORAL1",216,0)
 . . S X="Comments: "_PSOCOMMENT
"RTN","PSOORAL1",217,0)
 . . S (DIWR,DIWL)=1,DIWF="C80"
"RTN","PSOORAL1",218,0)
 . . D ^DIWP
"RTN","PSOORAL1",219,0)
 . . ;
"RTN","PSOORAL1",220,0)
 . . ; Additional comments (if any)
"RTN","PSOORAL1",221,0)
 . . ;
"RTN","PSOORAL1",222,0)
 . . S PSOCNT1=""
"RTN","PSOORAL1",223,0)
 . . F  S PSOCNT1=$O(PSOAR(PSODATE,PSOCNT,PSOCNT1)) Q:PSOCNT1=""  D
"RTN","PSOORAL1",224,0)
 . . . S X=PSOAR(PSODATE,PSOCNT,PSOCNT1)
"RTN","PSOORAL1",225,0)
 . . . S DIWF="C80I10"
"RTN","PSOORAL1",226,0)
 . . . D ^DIWP
"RTN","PSOORAL1",227,0)
 . . ;
"RTN","PSOORAL1",228,0)
 . . ; Loop through ^UTILITY($J,"W"), adding comments to ^TMP
"RTN","PSOORAL1",229,0)
 . . ;
"RTN","PSOORAL1",230,0)
 . . F I=1:1:^UTILITY($J,"W",1) D 
"RTN","PSOORAL1",231,0)
 . . . S IEN=IEN+1
"RTN","PSOORAL1",232,0)
 . . . S ^TMP("PSOAL",$J,IEN,0)=$G(^UTILITY($J,"W",1,I,0))
"RTN","PSOORAL1",233,0)
 ;
"RTN","PSOORAL1",234,0)
 D DISPREJ
"RTN","PSOORAL1",235,0)
 ;
"RTN","PSOORAL1",236,0)
 K ^UTILITY($J,"W"),DIWR,DIWF,DIWL
"RTN","PSOORAL1",237,0)
 Q
"RTN","PSOORAL1",238,0)
 ;
"RTN","PSOORAL1",239,0)
SPMP ; SPMP (State Prescription Monitoring Program) Log
"RTN","PSOORAL1",240,0)
 N FILL,BAT,LOG,BAT0,LOG0
"RTN","PSOORAL1",241,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" ",IEN=IEN+1
"RTN","PSOORAL1",242,0)
 S ^TMP("PSOAL",$J,IEN,0)="SPMP (State Prescription Monitoring Program) Log:"
"RTN","PSOORAL1",243,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Date/Time       Fill Type   Exp. Type Bat#  Filename"
"RTN","PSOORAL1",244,0)
 S IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",80)="="
"RTN","PSOORAL1",245,0)
 I '$D(^PS(58.42,"ARX",DA)) D  Q
"RTN","PSOORAL1",246,0)
 . S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There's NO Export Log for this prescription."
"RTN","PSOORAL1",247,0)
 S FILL=""
"RTN","PSOORAL1",248,0)
 F  S FILL=$O(^PS(58.42,"ARX",DA,FILL)) Q:FILL=""  D
"RTN","PSOORAL1",249,0)
 . S BAT=0 F  S BAT=$O(^PS(58.42,"ARX",DA,FILL,BAT)) Q:'BAT  D
"RTN","PSOORAL1",250,0)
 . . S LOG=0 F  S LOG=$O(^PS(58.42,"ARX",DA,FILL,BAT,LOG)) Q:'LOG  D
"RTN","PSOORAL1",251,0)
 . . . S BAT0=$G(^PS(58.42,BAT,0)),LOG0=$G(^PS(58.42,BAT,"RX",LOG,0))
"RTN","PSOORAL1",252,0)
 . . . I '$P(BAT0,"^",10) Q
"RTN","PSOORAL1",253,0)
 . . . S IEN=IEN+1,LINE=$$FMTE^XLFDT($P(BAT0,"^",10),2),$E(LINE,17)=$J($P(LOG0,"^",2),4)
"RTN","PSOORAL1",254,0)
 . . . S $E(LINE,22)=$$GET1^DIQ(58.42001,LOG_","_BAT,2),$E(LINE,29)=$$GET1^DIQ(58.42,BAT,2)
"RTN","PSOORAL1",255,0)
 . . . S $E(LINE,39)=BAT,$E(LINE,45)=$E($$GET1^DIQ(58.42,BAT,6),1,35)
"RTN","PSOORAL1",256,0)
 . . . S ^TMP("PSOAL",$J,IEN,0)=LINE
"RTN","PSOORAL1",257,0)
 Q
"RTN","PSOORAL1",258,0)
 ;
"RTN","PSOORAL1",259,0)
DISPREJ  ;
"RTN","PSOORAL1",260,0)
 N LN,SEQ,REJ,PRI,VAR,X,X1,X2,I,RFT
"RTN","PSOORAL1",261,0)
 I '$D(^PSRX(DA,"REJ")) Q
"RTN","PSOORAL1",262,0)
 S PRI="PSOAL",$P(LN,"=",80)="",SEQ=0
"RTN","PSOORAL1",263,0)
 S IEN=$G(IEN)+1,^TMP(PRI,$J,IEN,0)=" "
"RTN","PSOORAL1",264,0)
 S IEN=IEN+1,^TMP(PRI,$J,IEN,0)="ECME REJECT Log:"
"RTN","PSOORAL1",265,0)
 S IEN=IEN+1,^TMP(PRI,$J,IEN,0)="#  Date/Time Rcvd    Rx Ref    Reject Type     STATUS     Date/Time Resolved"
"RTN","PSOORAL1",266,0)
 S IEN=IEN+1,^TMP(PRI,$J,IEN,0)=LN
"RTN","PSOORAL1",267,0)
 F REJ=0:0 S REJ=$O(^PSRX(DA,"REJ",REJ)) Q:'REJ  D
"RTN","PSOORAL1",268,0)
 . S VAR=$G(^PSRX(DA,"REJ",REJ,0))
"RTN","PSOORAL1",269,0)
 . S RFT=+$P(VAR,"^",4)
"RTN","PSOORAL1",270,0)
 . S SEQ=SEQ+1,X=SEQ,$E(X,4)=$$FMTE^XLFDT($P(VAR,"^",2),2),$E(X,22)=$S(RFT:"REFILL "_RFT,1:"ORIGINAL")
"RTN","PSOORAL1",271,0)
 . S $E(X,32)=$S(+VAR=79:"REFILL TOO SOON",+VAR=88:"DUR",1:$E($$EXP^PSOREJP1($P(VAR,"^",1)),1,15))  ;can't + default because values can be 07, 08, etc.
"RTN","PSOORAL1",272,0)
 . S $E(X,48)=$S($P(VAR,"^",5):"RESOLVED",1:"UNRESOLVED")
"RTN","PSOORAL1",273,0)
 . S:$P(VAR,"^",6) $E(X,59)=$$FMTE^XLFDT($P(VAR,"^",6),2)
"RTN","PSOORAL1",274,0)
 . S IEN=IEN+1,^TMP(PRI,$J,IEN,0)=X
"RTN","PSOORAL1",275,0)
 . I $P(VAR,"^",5) D
"RTN","PSOORAL1",276,0)
 . . S IEN=IEN+1,X=$$GET1^DIQ(52.25,REJ_","_DA,12)
"RTN","PSOORAL1",277,0)
 . . S X1=$$GET1^DIQ(52.25,REJ_","_DA,13) S:X1'="" X=X1_" ("_X_")"
"RTN","PSOORAL1",278,0)
 . . F I=1:1 Q:X=""  D
"RTN","PSOORAL1",279,0)
 . . . S ^TMP(PRI,$J,IEN,0)=$S(I=1:"Comments: ",1:"          ")_$E(X,1,69)
"RTN","PSOORAL1",280,0)
 . . . S X=$E(X,70,999) S:X'="" IEN=IEN+1
"RTN","PSOORAL1",281,0)
 Q
"RTN","PSOORAL1",282,0)
 ;
"RTN","PSOORAL1",283,0)
ERX ; eRx Log
"RTN","PSOORAL1",284,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE - ERX LOG 
"RTN","PSOORAL1",285,0)
 N CNT,G,STR,X,I,TMP,N,ERXREC,ERXCHK,DAT,PSOACBRV,P1
"RTN","PSOORAL1",286,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" "
"RTN","PSOORAL1",287,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="eRx Activity Log:"
"RTN","PSOORAL1",288,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#   Date        Reason         Rx Ref         Initiator Of Activity"
"RTN","PSOORAL1",289,0)
 S IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",80)="="
"RTN","PSOORAL1",290,0)
 S ERXCHK=0 F  S ERXCHK=$O(^PSRX(DA,"A",ERXCHK)) Q:'ERXCHK  D
"RTN","PSOORAL1",291,0)
 .I $P(^PSRX(DA,"A",ERXCHK,0),U,2)="O" S ERXREC=1
"RTN","PSOORAL1",292,0)
 I '$G(ERXREC) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There are no eRx activity logs." Q
"RTN","PSOORAL1",293,0)
 S CNT=0
"RTN","PSOORAL1",294,0)
 F N=0:0 S N=$O(^PSRX(DA,"A",N)) Q:'N  S P1=^(N,0) D
"RTN","PSOORAL1",295,0)
 .I $P(P1,"^",2)'="O" Q
"RTN","PSOORAL1",296,0)
 .S DAT=$$FMTE^XLFDT($P(P1,"^"),2)_"             "
"RTN","PSOORAL1",297,0)
 .S IEN=IEN+1,CNT=CNT+1,^TMP("PSOAL",$J,IEN,0)=CNT_"   "_$E(DAT,1,21),$P(RN," ",15)=" ",REA=$P(P1,"^",2)
"RTN","PSOORAL1",298,0)
 .I $P(P1,"^",5)]"" N PSOACBRK,PSOACBRV D
"RTN","PSOORAL1",299,0)
 ..S PSOACBRV=$P(P1,"^",5)
"RTN","PSOORAL1",300,0)
 ..;Use fileman for parsing
"RTN","PSOORAL1",301,0)
 ..K ^UTILITY($J,"W") S X="Comments: "_PSOACBRV,(DIWR,DIWL)=1,DIWF="C80" D ^DIWP F I=1:1:^UTILITY($J,"W",1) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=$G(^UTILITY($J,"W",1,I,0))
"RTN","PSOORAL1",302,0)
 .I $P($G(^PSRX(DA,"A",N,1)),"^")]"" S IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0)," ",5)=$P($G(^PSRX(DA,"A",N,1)),"^") I $P($G(^PSRX(DA,"A",N,1)),"^",2)]"" S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_":"_$P($G(^PSRX(DA,"A",N,1)),"^",2)
"RTN","PSOORAL1",303,0)
 .I $O(^PSRX(DA,"A",N,2,0)) F I=0:0 S I=$O(^PSRX(DA,"A",N,2,I)) Q:'I  S MIG=^PSRX(DA,"A",N,2,I,0) D
"RTN","PSOORAL1",304,0)
 ..S:MIG["Mail Tracking Info.: " IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0)," ",9)=" "
"RTN","PSOORAL1",305,0)
 ..F SG=1:1:$L(MIG) S:$L(^TMP("PSOAL",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0)," ",9)=" " S:$P(MIG," ",SG)'="" ^TMP("PSOAL",$J,IEN,0)=$G(^TMP("PSOAL",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORAL1",306,0)
 K MIG,SG,I,^UTILITY($J,"W"),DIWF,DIWL,DIWR
"RTN","PSOORAL1",307,0)
 Q
"RTN","PSOORAL1",308,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOORAL1",309,0)
DAT S DAT="",DTT=DTT\1 Q:DTT'?7N  S DAT=$E(DTT,4,5)_"/"_$E(DTT,6,7)_"/"_$E(DTT,2,3)
"RTN","PSOORAL1",310,0)
 Q
"VER")
8.0^22.2
"BLD",9980,6)
^457
**END**
**END**

