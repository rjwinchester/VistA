Released PSO*7*476 SEQ #391
Extracted from mail message
**KIDS**:PSO*7.0*476^

**INSTALL NAME**
PSO*7.0*476
"BLD",9632,0)
PSO*7.0*476^OUTPATIENT PHARMACY^0^3170111^y
"BLD",9632,1,0)
^^1^1^3160615^
"BLD",9632,1,1,0)
FIXED MEDICATION COPAYMENT TIER (FMCT)
"BLD",9632,4,0)
^9.64PA^^
"BLD",9632,6)
1^
"BLD",9632,6.3)
35
"BLD",9632,"ABPKG")
n
"BLD",9632,"KRN",0)
^9.67PA^779.2^20
"BLD",9632,"KRN",.4,0)
.4
"BLD",9632,"KRN",.401,0)
.401
"BLD",9632,"KRN",.402,0)
.402
"BLD",9632,"KRN",.403,0)
.403
"BLD",9632,"KRN",.5,0)
.5
"BLD",9632,"KRN",.84,0)
.84
"BLD",9632,"KRN",3.6,0)
3.6
"BLD",9632,"KRN",3.8,0)
3.8
"BLD",9632,"KRN",9.2,0)
9.2
"BLD",9632,"KRN",9.8,0)
9.8
"BLD",9632,"KRN",9.8,"NM",0)
^9.68A^7^2
"BLD",9632,"KRN",9.8,"NM",6,0)
PSOHLNE3^^0^B70373128
"BLD",9632,"KRN",9.8,"NM",7,0)
PSOCPB^^0^B94005590
"BLD",9632,"KRN",9.8,"NM","B","PSOCPB",7)

"BLD",9632,"KRN",9.8,"NM","B","PSOHLNE3",6)

"BLD",9632,"KRN",19,0)
19
"BLD",9632,"KRN",19.1,0)
19.1
"BLD",9632,"KRN",101,0)
101
"BLD",9632,"KRN",409.61,0)
409.61
"BLD",9632,"KRN",771,0)
771
"BLD",9632,"KRN",779.2,0)
779.2
"BLD",9632,"KRN",870,0)
870
"BLD",9632,"KRN",8989.51,0)
8989.51
"BLD",9632,"KRN",8989.52,0)
8989.52
"BLD",9632,"KRN",8994,0)
8994
"BLD",9632,"KRN","B",.4,.4)

"BLD",9632,"KRN","B",.401,.401)

"BLD",9632,"KRN","B",.402,.402)

"BLD",9632,"KRN","B",.403,.403)

"BLD",9632,"KRN","B",.5,.5)

"BLD",9632,"KRN","B",.84,.84)

"BLD",9632,"KRN","B",3.6,3.6)

"BLD",9632,"KRN","B",3.8,3.8)

"BLD",9632,"KRN","B",9.2,9.2)

"BLD",9632,"KRN","B",9.8,9.8)

"BLD",9632,"KRN","B",19,19)

"BLD",9632,"KRN","B",19.1,19.1)

"BLD",9632,"KRN","B",101,101)

"BLD",9632,"KRN","B",409.61,409.61)

"BLD",9632,"KRN","B",771,771)

"BLD",9632,"KRN","B",779.2,779.2)

"BLD",9632,"KRN","B",870,870)

"BLD",9632,"KRN","B",8989.51,8989.51)

"BLD",9632,"KRN","B",8989.52,8989.52)

"BLD",9632,"KRN","B",8994,8994)

"BLD",9632,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9632,"QUES",0)
^9.62^^
"BLD",9632,"REQB",0)
^9.611^2^2
"BLD",9632,"REQB",1,0)
PSO*7.0*431^1
"BLD",9632,"REQB",2,0)
PSO*7.0*460^1
"BLD",9632,"REQB","B","PSO*7.0*431",1)

"BLD",9632,"REQB","B","PSO*7.0*460",2)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
476^3170111
"PKG",141,22,1,"PAH",1,1,0)
^^1^1^3170111
"PKG",141,22,1,"PAH",1,1,1,0)
FIXED MEDICATION COPAYMENT TIER (FMCT)
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSOCPB")
0^7^B94005590^B84573403
"RTN","PSOCPB",1,0)
PSOCPB ;BIR/BaB - pharmacy co-pay application cont'd ;1/30/07 9:08am
"RTN","PSOCPB",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**72,71,85,185,143,219,239,201,263,303,431,476**;DEC 1997;Build 35
"RTN","PSOCPB",3,0)
 ;
"RTN","PSOCPB",4,0)
 ;REF/IA
"RTN","PSOCPB",5,0)
 ;DIS^SDROUT2/112
"RTN","PSOCPB",6,0)
 ;^IBARX/125
"RTN","PSOCPB",7,0)
 ;VADPT/10061
"RTN","PSOCPB",8,0)
 ;SWSTAT^IBBAPI/4663
"RTN","PSOCPB",9,0)
 ;Reference to $$CPTIER^PSNAPIS(P1,P3) supported by DBIA #2531
"RTN","PSOCPB",10,0)
COPAY ;
"RTN","PSOCPB",11,0)
 ;Called by PSON52,PSORN52...Requires PSOCPAY,PSOBILL,DEA=PSDEA,PSOFLAG
"RTN","PSOCPB",12,0)
 ;PSOFLAG=1 NEW, PSOFLAG=0 RENEW
"RTN","PSOCPB",13,0)
 S PSOSAVE=PSOCPAY ; Save original status of PSOCPAY
"RTN","PSOCPB",14,0)
 I '$G(PSOSCP)!('$G(PSOSCA)) D SCP^PSORN52D  ;CIDC-must ask sc if flagged for it in enrollment
"RTN","PSOCPB",15,0)
 I $G(PSODRUG("DEA"))["S"!($G(PSODRUG("DEA"))["I")!($G(PSODRUG("DEA"))["N") S PSOCPAY=0
"RTN","PSOCPB",16,0)
 G:+PSOBILL'=2&('$G(PSOSCA)) COPAY2
"RTN","PSOCPB",17,0)
 D FULL^VALM1
"RTN","PSOCPB",18,0)
 I $G(PSOMESOI)=1,$G(PSORXED) W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESOI=2
"RTN","PSOCPB",19,0)
 I $G(PSOMESFI)=1 W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESFI=2
"RTN","PSOCPB",20,0)
 S DFN=+$G(PSODFN) D CHKPAG^PSOMLLD2,DIS^SDROUT2
"RTN","PSOCPB",21,0)
ASK ;
"RTN","PSOCPB",22,0)
 N PSOUFLAG S PSOUFLAG=0
"RTN","PSOCPB",23,0)
 K PSOCPZ("DFLG"),PSONEW("NEWCOPAY")
"RTN","PSOCPB",24,0)
 W ! K DIR,DTOUT,DIRUT,DUOUT
"RTN","PSOCPB",25,0)
 I $G(PSORX("SC"))="SC"!($G(PSORX("SC"))="NSC")!($G(PSOSCOTH)) D
"RTN","PSOCPB",26,0)
 .W:PSOSCP<50&($G(PSODRUG("DEA"))'["S")&($G(PSODRUG("DEA"))'["I")&($G(PSODRUG("DEA"))'["N") !,"This Rx has been flagged by the provider as: "_$S($G(PSOSCOTH):"NO COPAY",$G(PSORX("SC"))="SC":"NO COPAY",1:"COPAY"),!
"RTN","PSOCPB",27,0)
 .I $G(PSOSCOTX) S PSOSCOTX=2
"RTN","PSOCPB",28,0)
 S DIR("A")="Was treatment for Service Connected condition",DIR(0)="Y"
"RTN","PSOCPB",29,0)
 S DIR("?")="Enter 'Yes' if this prescription is for a Service Connected condition"
"RTN","PSOCPB",30,0)
 I $G(PSORX("SC"))]""!($G(PSORX(+$G(PSORENW("OIRXN")),"SC"))'="") S DIR("B")=$S($G(PSORX("SC"))="SC":"YES",$G(PSORX("SC"))="NSC":"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=1:"YES",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=0:"NO",1:"")
"RTN","PSOCPB",31,0)
 I $G(PSONEWFF),$G(PSOFLAG) I $G(PSOANSQD("SC"))=0!($G(PSOANSQD("SC"))=1) S DIR("B")=$S($G(PSOANSQD("SC"))=1:"YES",1:"NO")
"RTN","PSOCPB",32,0)
 I $G(DIR("B"))="YES"!($G(DIR("B"))="NO") S PSOUFLAG=$G(DIR("B"))
"RTN","PSOCPB",33,0)
 I $G(DIR("B"))="" K DIR("B")
"RTN","PSOCPB",34,0)
 D ^DIR
"RTN","PSOCPB",35,0)
 I $G(Y)=1!($G(Y)=0) S PSOANSQ("SC")=$G(Y) I $G(PSONEWFF),$G(PSOFLAG) S PSOANSQD("SC")=$G(Y)
"RTN","PSOCPB",36,0)
 I PSOFLAG I Y["^"!($D(DTOUT))!($D(DUOUT)) S PSOCPZ("DFLG")=1
"RTN","PSOCPB",37,0)
 S:Y=0 Y=2
"RTN","PSOCPB",38,0)
 S PSOANSR=+Y I 'PSOANSR,'PSOFLAG D  S $P(PSOCPAY,"^")=$S($G(PSOUFLAG)="NO":1,1:0) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR G COPAY2
"RTN","PSOCPB",39,0)
 .W !!,"This Renewal has been designated as "_$S($G(PSOUFLAG)="YES":"SERVICE CONNECTED",1:"NON-SERVICE CONNECTED.")
"RTN","PSOCPB",40,0)
 .W:PSOSCP<50&($G(PSODRUG("DEA"))'["S")&($G(PSODRUG("DEA"))'["I")&($G(PSODRUG("DEA"))'["N") !,"Please use the 'Reset Copay Status/Cancel Charges' option to make corrections."
"RTN","PSOCPB",41,0)
 .S PSOANSQ("SC")=$S($G(PSOUFLAG)="YES":1,1:0)
"RTN","PSOCPB",42,0)
 I $G(PSOFLAG),$G(PSOCPZ("DFLG")) G EXIT
"RTN","PSOCPB",43,0)
 S:PSOANSR=1 PSOCPAY=0 S:PSOANSR=2 $P(PSOCPAY,"^")=1
"RTN","PSOCPB",44,0)
COPAY2 ;
"RTN","PSOCPB",45,0)
 N PSOPFS S PSOPFS=$$SWSTAT^IBBAPI()
"RTN","PSOCPB",46,0)
 ;***** begin - for regression test FMCT - sites must not use this as it will adversely affect billing results - only used by SQA
"RTN","PSOCPB",47,0)
 ; The following is required for testing different effective dates.  If date is less than 02/27/17 bills old way.  Otherwise bills new way.
"RTN","PSOCPB",48,0)
 ;S ^XTMP("PSOTIEREFTST",0)="3201231^3170227^FOR SQA TESTING ONLY" - Defined for SQA testing only.   Delete this XTMP when regression complete
"RTN","PSOCPB",49,0)
 D NOW^%DTC N PSOTIERE
"RTN","PSOCPB",50,0)
 S PSOTIERE=1  ;use copay tiers - new
"RTN","PSOCPB",51,0)
 I $P(%,".")<3170227 S PSOTIERE=0  ;legacy billing - old
"RTN","PSOCPB",52,0)
 I $G(^XTMP("PSOTIEREFTST",0)) S PSOTIERE=1  ;for SQA testing only - bill with copay tiers - new
"RTN","PSOCPB",53,0)
 ;***** end for regression test
"RTN","PSOCPB",54,0)
 G COPAY21:'PSOTIERE
"RTN","PSOCPB",55,0)
 ;Check copay tier. Tier zero does not have copay charges. Tier billing will be effective 2/27/17 and IB rate table decides what amount to bill based on rate effective date
"RTN","PSOCPB",56,0)
 N CPDATE,X,PSOCPT D NOW^%DTC S CPDATE=X,PSOCPT=$$CPTIER^PSNAPIS("",CPDATE,PSODRUG("IEN")) K CPDATE,X
"RTN","PSOCPB",57,0)
 I $P(PSOCPT,"^")=0 S PSOCHG=0 K PSONEW("NEWCOPAY") G EXIT  ;Tier zero do not send to IB for copay charge
"RTN","PSOCPB",58,0)
 ;
"RTN","PSOCPB",59,0)
COPAY21 I +PSOCPAY=1,($P(PSOCPAY,"^",2)=1)!($P(PSOCPAY,"^",2)=2) D
"RTN","PSOCPB",60,0)
 .;set IB node in ^PSRX for copay if xactn type is 1 or 2
"RTN","PSOCPB",61,0)
 .S PSONEW("NEWCOPAY")=$P($G(PSOCPAY),"^",2)_"^^"_$S(+$G(PSOPFS):"",1:$P($G(PSOCPAY),"^",2))
"RTN","PSOCPB",62,0)
EXIT ;
"RTN","PSOCPB",63,0)
 S PSOCPAY=PSOSAVE ;Restore val of PSOCPAY
"RTN","PSOCPB",64,0)
 K PSOSAVE,PSOANSR,DIR,DUOUT,DIRUT,DTOUT,Y,X
"RTN","PSOCPB",65,0)
 Q
"RTN","PSOCPB",66,0)
RESET ;RESET COPAY STATUS
"RTN","PSOCPB",67,0)
 K PSOSUMM,PSOPFS,PSOPFSA,PSOLFIL,PSOPFSG
"RTN","PSOCPB",68,0)
 I '$D(PSOPAR) D ^PSOLSET G RESET
"RTN","PSOCPB",69,0)
 W ! S DIC="^PSRX(",DIC(0)="AEQZ" D ^DIC K DIC G:Y<0 EXT S PSODA=+Y
"RTN","PSOCPB",70,0)
 W !,?17,"PATIENT: ",$P($G(^DPT($P(^PSRX(PSODA,0),"^",2),0)),"^")
"RTN","PSOCPB",71,0)
 D ICN^PSODPT($P(^PSRX(PSODA,0),"^",2))
"RTN","PSOCPB",72,0)
 S PSORXN=$P(^PSRX(PSODA,0),"^"),PREA="R"
"RTN","PSOCPB",73,0)
 S PCOPAY=$G(^PSRX(PSODA,"IB"))
"RTN","PSOCPB",74,0)
 W !!,"Rx # ",PSORXN," is a ",$S(+PCOPAY:"Copay",1:"No Copay")," prescription"
"RTN","PSOCPB",75,0)
 S PSOLFIL=$$LF^PSOPFSU1(PSODA) D PFSA^PSOPFSU1(PSODA,PSOLFIL,3)  ;PSOCPC def PSOPFSA=1 if OP SC/EI's change.
"RTN","PSOCPB",76,0)
 D EXEMCHK^PSOCPC ; CHECK/CHANGE EXEMPTION FLAGS
"RTN","PSOCPB",77,0)
 S PSOIBQ=$G(^PSRX(PSODA,"IBQ"))
"RTN","PSOCPB",78,0)
 I '$G(^PSRX(PSODA,"IB")),PSOIBQ'["1" D  G ASKCAN
"RTN","PSOCPB",79,0)
 . K DIR S DIR(0)="Y",DIR("B")="N",DIR("A")="Do you want to reset the status to COPAY" D ^DIR K DIR
"RTN","PSOCPB",80,0)
 . I Y'=1 Q
"RTN","PSOCPB",81,0)
 . S DIC="^IBE(350.3,",DIC("S")="I $P(^(0),U,3)'=2",DIC(0)="AEQMZ",DIC("A")="Select Reason for Reset : " D ^DIC K DIC I Y'<0 S PSORSN=+Y
"RTN","PSOCPB",82,0)
 . S PREA="R",PSOOLD="No Copay",PSONW="Copay",PSOCOMM="" D ACTLOG^PSOCPA
"RTN","PSOCPB",83,0)
 . S PSI=0,PSOCOMM="Copay status of this Rx has been reset to COPAY." D SETSUMM^PSOCPC
"RTN","PSOCPB",84,0)
 . S $P(^PSRX(PSODA,"IB"),"^")=1 ;Reset flag to COPAY
"RTN","PSOCPB",85,0)
 ;
"RTN","PSOCPB",86,0)
 I $G(^PSRX(PSODA,"IB")) D  G ASKCAN
"RTN","PSOCPB",87,0)
 . K DIR S DIR(0)="Y",DIR("B")="N",DIR("A")="Do you want to reset the status to NO COPAYMENT" D ^DIR K DIR
"RTN","PSOCPB",88,0)
 . I Y'=1 Q
"RTN","PSOCPB",89,0)
 . S DIC="^IBE(350.3,",DIC("S")="I $P(^(0),U,3)'=2",DIC(0)="AEQMZ",DIC("A")="Select Reason for Reset : " D ^DIC K DIC I Y'<0 S PSORSN=+Y
"RTN","PSOCPB",90,0)
 . S PREA="R",PSOOLD="Copay",PSONW="No Copay",PSOCOMM="" D ACTLOG^PSOCPA
"RTN","PSOCPB",91,0)
 . S PSI=0,PSOCOMM="Copay status of this Rx has been reset to NO COPAY." D SETSUMM^PSOCPC
"RTN","PSOCPB",92,0)
 . S $P(^PSRX(PSODA,"IB"),"^")="" ;Reset flag to NO COPAY
"RTN","PSOCPB",93,0)
ASKCAN D ASKCAN^PSOCPD
"RTN","PSOCPB",94,0)
 I '$D(PSOSUMM) S PSI=0,PSOCOMM="No action taken" D SETSUMM^PSOCPC
"RTN","PSOCPB",95,0)
 D PRTSUMM
"RTN","PSOCPB",96,0)
 I $P($G(PSOPFS),"^",3)>0&(+$G(PSOPFSA)) D CHRG^PSOPFSU1(PSODA,PSOLFIL,"CG",PSOPFS)
"RTN","PSOCPB",97,0)
RESETE K PSODA,PSORXN,PSORSN,PSOREF,X,Y,PCOPAY,PREA,PSOCOMM,PSI
"RTN","PSOCPB",98,0)
 G RESET
"RTN","PSOCPB",99,0)
EXT K PSODA,PSORXN,PSORSN,PSOREF,X,Y,PCOPAY,PREA,PSOCOPAY
"RTN","PSOCPB",100,0)
 Q
"RTN","PSOCPB",101,0)
BILLED ;Collect IB nums,cancel chrgs,reset flag.
"RTN","PSOCPB",102,0)
 W !!,"**********Charges are on file for this Rx.**********"
"RTN","PSOCPB",103,0)
 Q
"RTN","PSOCPB",104,0)
BILL2 ;
"RTN","PSOCPB",105,0)
 N PSOPREV ; VAR FOR PREV CANCELLED
"RTN","PSOCPB",106,0)
 S PSOPREV=0
"RTN","PSOCPB",107,0)
 S DIC="^IBE(350.3,",DIC("S")="I $P(^(0),U,3)'=2",DIC(0)="AEQMZ",DIC("A")="Select Reason for Reset or Charge Cancellation : " D ^DIC K DIC G ENDMSG:Y<0 S PSORSN=+Y
"RTN","PSOCPB",108,0)
 S X=PSOPAR7_"^"_+$P(^PSRX(PSODA,0),"^",2)_"^^"_DUZ
"RTN","PSOCPB",109,0)
 S SAVX=X
"RTN","PSOCPB",110,0)
 I $D(PSOCAN) D:'$G(PSOPFS)  I +$G(PSOPFS)!($G(PSOPFSG)) D PFS^PSOPFSU1 G BILL2END:'$D(PSOCAN)
"RTN","PSOCPB",111,0)
 . N III S III="" F  S III=$O(PSOCAN(III)) Q:III=""  I PSOCAN(III)["PFS" S PSOPFSG=1 Q  ;PFSS switch off, check for prev cots billing
"RTN","PSOCPB",112,0)
 D POTBILL2
"RTN","PSOCPB",113,0)
 I '$D(PSOCAN) G BILL2END
"RTN","PSOCPB",114,0)
 I $G(CANTYPE) D PREVCAN I $O(X(""))="" Q
"RTN","PSOCPB",115,0)
 I '$G(CANTYPE) S I="" F  S I=$O(PSOCAN(I)) Q:I=""  S X($P(PSOCAN(I),"^",1))=$P(PSOCAN(I),"^",2)_"^"_PSORSN
"RTN","PSOCPB",116,0)
 D CANCEL^IBARX
"RTN","PSOCPB",117,0)
 I $G(CANTYPE) D MSG
"RTN","PSOCPB",118,0)
 I '$D(Y) Q
"RTN","PSOCPB",119,0)
 I +Y=-1 Q
"RTN","PSOCPB",120,0)
 I $D(Y(PSORXN)),+Y(PSORXN)'=-1 S $P(^PSRX(PSODA,"IB"),"^",2)=+Y(PSORXN) K Y(PSORXN) S PREA="C",PSOREF=0,PSOOLD="",PSONW="" D ACTLOG^PSOCPA I '$G(CANTYPE) D MSG
"RTN","PSOCPB",121,0)
 F PSOREF=0:0 S PSOREF=$O(Y(PSOREF)) Q:PSOREF=""  I +Y(PSOREF)'=-1 S ^PSRX(PSODA,1,PSOREF,"IB")=+Y(PSOREF) S PREA="C",PSOOLD="",PSONW="" D ACTLOG^PSOCPA I '$G(CANTYPE) D MSG
"RTN","PSOCPB",122,0)
BILL2END K X,Y,SAVX,PSOREF,PSOCAN
"RTN","PSOCPB",123,0)
 Q
"RTN","PSOCPB",124,0)
 ;
"RTN","PSOCPB",125,0)
POTBILL2 ;see if any potential charges (entries from file 354.71 -- bills that exceeded cap prev) to be cancelled before cancelling regular charges
"RTN","PSOCPB",126,0)
 N X,I
"RTN","PSOCPB",127,0)
 S X=SAVX
"RTN","PSOCPB",128,0)
 I $T(CANIBAM^IBARX)="" Q
"RTN","PSOCPB",129,0)
 S I="" F  S I=$O(PSOCAN(I)) Q:I=""  I PSOCAN(I)["^CAP" S X($P(PSOCAN(I),"^",1))=$P(PSOCAN(I),"^",2)_"^"_PSORSN K PSOCAN(I)
"RTN","PSOCPB",130,0)
 I $O(X(""))="" Q
"RTN","PSOCPB",131,0)
 S PSOPREV=1
"RTN","PSOCPB",132,0)
 D CANIBAM^IBARX
"RTN","PSOCPB",133,0)
 I $D(X(PSORXN)) S $P(^PSRX(PSODA,"IB"),"^",4)="" S PREA="C",PSOREF=0,PSOCOMM="Potential charge cancelled",PSOOLD="",PSONW="" D ACTLOG^PSOCPA D POTMSG K X(PSORXN)
"RTN","PSOCPB",134,0)
 F PSOREF=0:0 S PSOREF=$O(X(PSOREF)) Q:PSOREF=""  Q:PSOREF>11  S $P(^PSRX(PSODA,1,PSOREF,"IB"),"^",2)="" S PREA="C",PSOCOMM="Potential charge cancelled",PSOOLD="",PSONW="" D ACTLOG^PSOCPA D POTMSG
"RTN","PSOCPB",135,0)
 K PSOREF,PREA,PSOCOMM
"RTN","PSOCPB",136,0)
 Q
"RTN","PSOCPB",137,0)
REFILL S PSOREF=0
"RTN","PSOCPB",138,0)
 F  S PSOREF=$O(^PSRX(PSODA,1,PSOREF)) Q:PSOREF'?1N.N  D
"RTN","PSOCPB",139,0)
 . I $D(^PSRX(PSODA,1,PSOREF,"PFS")) S:$P($G(^PSRX(PSODA,1,PSOREF,"PFS")),"^",2) X(PSOREF)="^"_$G(PSORSN) Q
"RTN","PSOCPB",140,0)
 . I $D(^PSRX(PSODA,1,PSOREF,"IB")),+^("IB")>0 S X(PSOREF)=+^PSRX(PSODA,1,PSOREF,"IB")_"^"_$G(PSORSN)
"RTN","PSOCPB",141,0)
 S PSOREF=0 F  S PSOREF=$O(^PSRX(PSODA,1,PSOREF)) Q:PSOREF'?1N.N  I '$D(X(PSOREF)),+$P($G(^PSRX(PSODA,1,PSOREF,"IB")),"^",2) S XX(PSOREF)=+$P(^PSRX(PSODA,1,PSOREF,"IB"),"^",2)_"^"_$G(PSORSN) ; IF ONLY ENTRY FROM 354.71 SAVE IT
"RTN","PSOCPB",142,0)
 Q
"RTN","PSOCPB",143,0)
SETCP ;IF NOT COPAY MAKE ELIG CALL/SET FLAG FOR FUTURE
"RTN","PSOCPB",144,0)
 W ! S X=PSOPAR7_"^"_+$P(^PSRX(PSODA,0),"^",2)
"RTN","PSOCPB",145,0)
 D XTYPE^IBARX
"RTN","PSOCPB",146,0)
 I +Y=-1 W !!,"Error in processing Copay eligibility, no action taken." Q
"RTN","PSOCPB",147,0)
 S (ACTYP,BL)="",(PSOBILL,PSOCPAY)=0
"RTN","PSOCPB",148,0)
CP ;
"RTN","PSOCPB",149,0)
 S ACTYP=$O(Y(ACTYP)) G:'ACTYP CP1
"RTN","PSOCPB",150,0)
 F I=0:0 S BL=$O(Y(ACTYP,BL)) Q:BL=""  I BL>0 S PSOBILL=BL,PSOCPAY=ACTYP
"RTN","PSOCPB",151,0)
 G CP
"RTN","PSOCPB",152,0)
CP1 K ACTYP,BL,I
"RTN","PSOCPB",153,0)
 I (PSOBILL'>0)!(PSOCPAY=0) G INELIG
"RTN","PSOCPB",154,0)
 S $P(^PSRX(PSODA,"IB"),"^")=PSOCPAY
"RTN","PSOCPB",155,0)
 W !,"COPAY status on this Rx has been reset.",!,"*** Future refills will be classified as COPAY."
"RTN","PSOCPB",156,0)
 S PREA="R",PSOOLD="No Copay",PSONW="Copay"
"RTN","PSOCPB",157,0)
 D ACTLOG^PSOCPA
"RTN","PSOCPB",158,0)
 Q
"RTN","PSOCPB",159,0)
INELIG W !,"This Rx does not meet patient eligibility requirement for Copay.",!,"****** Status unchanged *******"
"RTN","PSOCPB",160,0)
 S Y=-1
"RTN","PSOCPB",161,0)
 Q
"RTN","PSOCPB",162,0)
ENDMSG K X W !,"Unable to process CHARGE REMOVAL without REASON for Reset."
"RTN","PSOCPB",163,0)
 R !,"ENTER a REASON now?  (Y/N) ",X:DTIME Q:'$T
"RTN","PSOCPB",164,0)
 I ($E(X)["?")!("YyNn^"'[$E(X)) W !,"Enter YES to select REASON and RESET STATUS." G ENDMSG
"RTN","PSOCPB",165,0)
 I "Yy"[$E(X) G BILL2
"RTN","PSOCPB",166,0)
 Q
"RTN","PSOCPB",167,0)
MSG ;
"RTN","PSOCPB",168,0)
 S PSI=0
"RTN","PSOCPB",169,0)
 I $G(CANTYPE) S PSOCOMM="Rx # "_PSORXN_" - All copay charges cancelled" D SETSUMM^PSOCPC K PSOCOMM Q
"RTN","PSOCPB",170,0)
 S PSOCOMM="Rx # "_PSORXN_" - "_$S(PSOREF=0:"Original fill",1:"Refill "_PSOREF)_" copay charge cancelled"
"RTN","PSOCPB",171,0)
 D SETSUMM^PSOCPC
"RTN","PSOCPB",172,0)
 K PSOCOMM
"RTN","PSOCPB",173,0)
 Q
"RTN","PSOCPB",174,0)
POTMSG ;
"RTN","PSOCPB",175,0)
 S PSI=0
"RTN","PSOCPB",176,0)
 I $G(CANTYPE) Q  ; (MESSAGE WILL GET SET LATER)
"RTN","PSOCPB",177,0)
 S PSOCOMM="Rx # "_PSORXN_" - "_$S(PSOREF=0:"Original fill",1:"Refill "_PSOREF)_" potential copay charge cancelled"
"RTN","PSOCPB",178,0)
 D SETSUMM^PSOCPC
"RTN","PSOCPB",179,0)
 K PSOCOMM
"RTN","PSOCPB",180,0)
 Q
"RTN","PSOCPB",181,0)
MSGNOCAN ;
"RTN","PSOCPB",182,0)
 S PSI=0
"RTN","PSOCPB",183,0)
 S PSOCOMM="Rx # "_PSORXN_" - All copay charges have already been cancelled." D SETSUMM^PSOCPC K PSOCOMM
"RTN","PSOCPB",184,0)
 Q
"RTN","PSOCPB",185,0)
 ;
"RTN","PSOCPB",186,0)
PRTSUMM ; prt sum of actions in reset/cancel
"RTN","PSOCPB",187,0)
 I '$D(PSOSUMM) Q
"RTN","PSOCPB",188,0)
 W !
"RTN","PSOCPB",189,0)
 S PSI=""
"RTN","PSOCPB",190,0)
 F  S PSI=$O(PSOSUMM(PSI)) Q:PSI=""  W !,PSOSUMM(PSI)
"RTN","PSOCPB",191,0)
 K PSOSUMM
"RTN","PSOCPB",192,0)
 Q
"RTN","PSOCPB",193,0)
PREVCAN ; PREVIEW CANCELS IF "ALL" IS SELECTED
"RTN","PSOCPB",194,0)
 N I,PSOBILL
"RTN","PSOCPB",195,0)
 S I="" F  S I=$O(PSOCAN(I)) Q:I=""  D  I PSOBILL S X($P(PSOCAN(I),"^",1))=$P(PSOCAN(I),"^",2)_"^"_PSORSN
"RTN","PSOCPB",196,0)
 . S PSOBILL=1 I $T(STATUS^IBARX)'="" I PSOCAN(I)'["CAP" S PSOBILL=$$STATUS^IBARX($P(PSOCAN(I),"^",2)) S:PSOBILL=2 PSOBILL=0 ; PREVIOUSLY CANCELLED
"RTN","PSOCPB",197,0)
 I $O(X(""))="" D
"RTN","PSOCPB",198,0)
 . I PSOPREV D MSG Q
"RTN","PSOCPB",199,0)
 . D MSGNOCAN
"RTN","PSOCPB",200,0)
 Q
"RTN","PSOCPB",201,0)
 ;
"RTN","PSOHLNE3")
0^6^B70373128^B69950706
"RTN","PSOHLNE3",1,0)
PSOHLNE3 ;BIR/LE - Process Edit Information from CPRS ;02/27/04
"RTN","PSOHLNE3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**143,239,201,225,303,460,476**;DEC 1997;Build 35
"RTN","PSOHLNE3",3,0)
 ;External reference to ^OR(100 private DBIA 2219
"RTN","PSOHLNE3",4,0)
 ;External reference to $$CPTIER^PSNAPIS(P1,P3) supported by DBIA #2531
"RTN","PSOHLNE3",5,0)
 ;External reference to IBARX supported by DBIA #125
"RTN","PSOHLNE3",6,0)
 ;
"RTN","PSOHLNE3",7,0)
 ;This API is used to update the prescription file when ICD-9 diagnosis and SC/EI's are updated as a result of an e-sig in CPRS.  
"RTN","PSOHLNE3",8,0)
 ;
"RTN","PSOHLNE3",9,0)
EN(DFN,ORITEM,ORIEN,ORDX,ORSCEI) ;ENTRY POINT
"RTN","PSOHLNE3",10,0)
 ;     Used to import edit information from CPRS 
"RTN","PSOHLNE3",11,0)
 ;Where Input:
"RTN","PSOHLNE3",12,0)
 ;DFN = Patient IEN
"RTN","PSOHLNE3",13,0)
 ;ORITEM = Package reference number from file 100
"RTN","PSOHLNE3",14,0)
 ;ORIEN = ien from file 100
"RTN","PSOHLNE3",15,0)
 ;ORDX(1)= (pointer to file 80) up to 8 accepted and first is primary ICD
"RTN","PSOHLNE3",16,0)
 ;ORDX(2)= (pointer to file 80)
"RTN","PSOHLNE3",17,0)
 ;ORSCEI=  seven pieces - where 1=yes, 0=no, null or ? =not asked
"RTN","PSOHLNE3",18,0)
 ;  ORSCEI=AO^IR^SC^EC^MST^HNC^CV^SHAD
"RTN","PSOHLNE3",19,0)
 N %,DX,DX2,DX3,RXN,PSOSCP,PSOX,ORDPROV,PSOSCP2,DA,RET,PSOANSQ,PSORX,PTSTATUS,ARRAY,PSOOI,ORITEM2,ORID,OICHK,PSORENW
"RTN","PSOHLNE3",20,0)
 N PSODCPY,PSONEW,PSOOIBQ,PSOFLD,PSODCZ,PSOSTAZ,PREA,PSOPIBQ,PSOIBQC,PSOSCA,PSOPICD,PSODGUP,PSOOICD,PSOPFS,TYPE,PSONW,PSOOLD,PSODA,PSOCOMM
"RTN","PSOHLNE3",21,0)
 N PSODD,PSOSI,X,PSOSITE,PSOBILL,PSOCPAY,PSOCICD
"RTN","PSOHLNE3",22,0)
 S:'$D(ORIEN) ORIEN="" S:'$D(ORSCEI) ORSCEI="" S:'$D(ORITEM) ORITEM=""
"RTN","PSOHLNE3",23,0)
 ;
"RTN","PSOHLNE3",24,0)
 ;validate prescription IEN with DFN, ord item, and placer#
"RTN","PSOHLNE3",25,0)
 S RET=1,PSODCZ=",12,14,15,"
"RTN","PSOHLNE3",26,0)
 S RXN=ORITEM I '$D(^PSRX(RXN)) S RET="0^1" Q RET  ;invalid RX ien
"RTN","PSOHLNE3",27,0)
 I $D(^PSRX(RXN,"STA")) S PSOSTAZ=^PSRX(RXN,"STA")
"RTN","PSOHLNE3",28,0)
 ; get prescription file patient ien, drug, and placer order #
"RTN","PSOHLNE3",29,0)
 D GETS^DIQ(52,RXN_",","2;6;39.3","I","ARRAY")
"RTN","PSOHLNE3",30,0)
 I '$D(ARRAY(52,RXN_",",2,"I")) S RET="0^3" Q RET  ;quit if you don't have a patient ien
"RTN","PSOHLNE3",31,0)
 I ARRAY(52,RXN_",",2,"I")'=DFN S RET="0^3" Q RET  ;quit if patient dfn is different
"RTN","PSOHLNE3",32,0)
 I '$D(ARRAY(52,RXN_",",39.3,"I")) S ARRAY(52,RXN_",",39.3,"I")=""  ;if don't have it; treat is as null
"RTN","PSOHLNE3",33,0)
 I ARRAY(52,RXN_",",39.3,"I")'="" I ARRAY(52,RXN_",",39.3,"I")'=ORIEN S RET="0^5" Q RET  ;placer # is different
"RTN","PSOHLNE3",34,0)
 I ARRAY(52,RXN_",",39.3,"I")="" S OICHK=0 D CHKOI I OICHK S RET="0^4" Q RET  ;quit if placer # is null and orderable item is different or null.
"RTN","PSOHLNE3",35,0)
 ;end of validation process
"RTN","PSOHLNE3",36,0)
 ;
"RTN","PSOHLNE3",37,0)
 S PSODD=$$GET1^DIQ(52,RXN_",",6,"I") S:($P($G(^PSDRUG(PSODD,0)),"^",3)["S")!($P($G(^(0)),"^",3)["I")!($P($G(^(0)),"^",3)["N") PSOSI=1
"RTN","PSOHLNE3",38,0)
 S PSOPIBQ=$G(^PSRX(RXN,"IBQ")),PSOPICD=$P($G(^PSRX(RXN,"ICD",1,0)),"^",2,8)
"RTN","PSOHLNE3",39,0)
 S PSOX("IRXN")=RXN,PSORENW("IRXN")=RXN
"RTN","PSOHLNE3",40,0)
 S (PSONEW("PATIENT STATUS"),PTSTATUS)=$$GET1^DIQ(52,RXN_",","3","I")
"RTN","PSOHLNE3",41,0)
 I '$D(PTSTATUS) S (PSONEW("PATIENT STATUS"),PTSTATUS)=""
"RTN","PSOHLNE3",42,0)
 ;if patient status is null, treat same as PSONEW2, PSORN52, PSONEWG, AND PSONEWF.  If piece 7 of ^PS(53 doesn't equal 1, it's not exempt from copay.
"RTN","PSOHLNE3",43,0)
 I ORSCEI["?" S ORSCEI=$TR(ORSCEI,"?","")
"RTN","PSOHLNE3",44,0)
 D SCP^PSORN52D
"RTN","PSOHLNE3",45,0)
 S PSOANSQ(PSOX("IRXN"),"VEH")=$P(ORSCEI,U,1)
"RTN","PSOHLNE3",46,0)
 S PSOANSQ(PSOX("IRXN"),"RAD")=$P(ORSCEI,U,2)
"RTN","PSOHLNE3",47,0)
 I PSOSCP<50&($P($G(^PS(53,+$G(PTSTATUS),0)),"^",7)'=1) S PSOANSQ(PSOX("IRXN"),"SC")=$P(ORSCEI,U,3),PSOANSQ("SC")=$P(ORSCEI,U,3)
"RTN","PSOHLNE3",48,0)
 I PSOSCP>49!($P($G(^PS(53,+$G(PTSTATUS),0)),"^",7)=1) S PSOANSQ(PSOX("IRXN"),"SC>50")=$P(ORSCEI,U,3),PSOANSQ("SC>50")=$P(ORSCEI,U,3)
"RTN","PSOHLNE3",49,0)
 I PSOSCP=""&('$D(PSOANSQ("SC")))&($D(^PSRX(RXN,"ICD",1))) S PSOANSQ("SC")=$P(^PSRX(RXN,"ICD",1,0),"^",4),PSOANSQ(PSOX("IRXN"),"SC")=PSOANSQ("SC")  ;for SC with no percentage defined/ legacy
"RTN","PSOHLNE3",50,0)
 S PSOANSQ(PSOX("IRXN"),"PGW")=$P(ORSCEI,U,4)
"RTN","PSOHLNE3",51,0)
 S PSOANSQ(PSOX("IRXN"),"MST")=$P(ORSCEI,U,5)
"RTN","PSOHLNE3",52,0)
 S PSOANSQ(PSOX("IRXN"),"HNC")=$P(ORSCEI,U,6)
"RTN","PSOHLNE3",53,0)
 S PSOANSQ(PSOX("IRXN"),"CV")=$P(ORSCEI,U,7)
"RTN","PSOHLNE3",54,0)
 S PSOANSQ(PSOX("IRXN"),"SHAD")=$P(ORSCEI,U,8)
"RTN","PSOHLNE3",55,0)
 D:'$$PATCH^XPDUTL("OR*3.0*243") SHAD^PSORN52D
"RTN","PSOHLNE3",56,0)
 S DX="",DX2=0 F  S DX=$O(ORDX(DX)) Q:DX=""  S DX2=DX2+1,PSORX("ICD",DX2)=ORDX(DX)  ;Multi signed Rx's come in consecutively and the diagnosis subscript doesn't start with 1 for each Rx
"RTN","PSOHLNE3",57,0)
 S PSOSCP2=1  ;used in PSORN52D
"RTN","PSOHLNE3",58,0)
 ;
"RTN","PSOHLNE3",59,0)
ICD2 ;Check to see if SC/EI changed during CPRS sign order
"RTN","PSOHLNE3",60,0)
 D GETS^DIQ(52,PSOX("IRXN")_",","52311*","I","PSOOICD")
"RTN","PSOHLNE3",61,0)
 S PSODCPY=0,PSOFLD=""
"RTN","PSOHLNE3",62,0)
 F TYPE="VEH","RAD","SC>50","PGW","MST","HNC","CV","SHAD" Q:PSODCPY  F PSOFLD=1:1:8 D  Q:PSODCPY
"RTN","PSOHLNE3",63,0)
 . I TYPE="VEH"&(PSOFLD=1) D CHOC
"RTN","PSOHLNE3",64,0)
 . I TYPE="RAD"&(PSOFLD=2) D CHOC
"RTN","PSOHLNE3",65,0)
 . I TYPE="SC>50"&(PSOFLD=3)&($D(PSOANSQ(PSOX("IRXN"),TYPE))) D CHOC
"RTN","PSOHLNE3",66,0)
 . I TYPE="PGW"&(PSOFLD=4) D CHOC
"RTN","PSOHLNE3",67,0)
 . I TYPE="MST"&(PSOFLD=5) D CHOC
"RTN","PSOHLNE3",68,0)
 . I TYPE="HNC"&(PSOFLD=6) D CHOC
"RTN","PSOHLNE3",69,0)
 . I TYPE="CV"&(PSOFLD=7) D CHOC
"RTN","PSOHLNE3",70,0)
 . I TYPE="SHAD"&(PSOFLD=8) D:$$PATCH^XPDUTL("OR*3.0*243") CHOC
"RTN","PSOHLNE3",71,0)
 I $D(PSOANSQ("SC")) S PSOFLD=3 S:PSOANSQ("SC")'=PSOOICD(52.052311,1_","_PSOX("IRXN")_",",PSOFLD,"I") PSODCPY=1,PSOFLD=""
"RTN","PSOHLNE3",72,0)
 ; IF NO SC/EI DIFFERENCES, CHECK FOR ICD CHANGES.  If there were SC/EI difference, don't need to check ICD because they are sent anyway when copay update is done.
"RTN","PSOHLNE3",73,0)
 I '$G(PSODCPY) D
"RTN","PSOHLNE3",74,0)
 .I '$D(PSORX("ICD"))&($G(PSOOICD(52.052311,1_","_RXN_",",.01,"I"))) S PSODGUP=1 Q  ;if no ICD's passed and ICD's defined in 52, CPRS overrides OP
"RTN","PSOHLNE3",75,0)
 .S (DX3,DX2,DX)="" F  S DX=$O(PSOOICD(52.052311,DX)) Q:DX=""  S DX2=+DX  ;get last entry for file 52
"RTN","PSOHLNE3",76,0)
 .S DX="" F  S DX=$O(PSORX("ICD",DX)) Q:DX=""  S DX3=DX D  ;get last entry for new ICD's from CPRS
"RTN","PSOHLNE3",77,0)
 .. I $G(PSOOICD(52.052311,DX_","_PSOX("IRXN")_",",.01,"I"))'=PSORX("ICD",DX) S PSODGUP=1  ;if ICD'S changed or more new ICD's than old ones.
"RTN","PSOHLNE3",78,0)
 .I DX2>DX3 S PSODGUP=1  ;if more old ICD's than new ones
"RTN","PSOHLNE3",79,0)
 Q:'$G(PSODCPY)&('$G(PSODGUP)) 1
"RTN","PSOHLNE3",80,0)
 D FILE2^PSORN52D  ;file SC/EI/ICD'S into Rx file
"RTN","PSOHLNE3",81,0)
 ;S PSOCIDC=$P($G(^PSRX(RXN,"ICD",1,0)),"^",2,8)
"RTN","PSOHLNE3",82,0)
 ;only do copay if SC/EI changed and SC is less than 50%.
"RTN","PSOHLNE3",83,0)
 I PSODCZ[(","_$G(PSOSTAZ)_",") S RET="0^6" Q RET  ;discontinue's no copay changes allowed.
"RTN","PSOHLNE3",84,0)
 ;
"RTN","PSOHLNE3",85,0)
 ;Get last fill number
"RTN","PSOHLNE3",86,0)
 N PSOLFIL S PSOLFIL=$$LF^PSOPFSU1(RXN)
"RTN","PSOHLNE3",87,0)
 S PSOPFS=$P($S('PSOLFIL:$G(^PSRX(RXN,"PFS")),1:$G(^PSRX(RXN,1,PSOLFIL,"PFS"))),"^",1,2)
"RTN","PSOHLNE3",88,0)
 ; No-copay to copay updates
"RTN","PSOHLNE3",89,0)
 S PSOIBQC=$G(^PSRX(RXN,"IBQ")),PSOCICD=$P($G(^PSRX(RXN,"ICD",1,0)),"^",2,8)
"RTN","PSOHLNE3",90,0)
 D CPAY
"RTN","PSOHLNE3",91,0)
 ; must check IBQ node in case it's a pre-CIDC rx/copay, ICD node for exempt/supply items, and for diagnosis updates for NSC Rx's
"RTN","PSOHLNE3",92,0)
 I (PSOPIBQ[1&(PSOIBQC'[1))!(PSOIBQC=""&(PSOPICD[1&(PSOCICD'[1)))!($G(PSODGUP)) D  Q RET  ;don't do no copay to copay bills, but update status
"RTN","PSOHLNE3",93,0)
 . D ALOG
"RTN","PSOHLNE3",94,0)
 . I (PSOSCP<50)&($G(PSODCPY)) D
"RTN","PSOHLNE3",95,0)
 .. I $P($G(^PS(53,+$G(PTSTATUS),0)),"^",7)'=1&('$G(PSOSI)) D
"RTN","PSOHLNE3",96,0)
 ... S:+$G(PSOCPAY)<1&($D(^PSRX(RXN,"IB"))) $P(^PSRX(RXN,"IB"),"^",1)=""
"RTN","PSOHLNE3",97,0)
 ... I +$G(PSOCPAY)>0 S $P(^PSRX(RXN,"IB"),"^",1)=+$G(PSOCPAY),PSOOLD="No Copay",PSONW="Copay",PREA="R",PSODA=RXN D:'$G(PSOSI) ACTLOG^PSOCPA
"RTN","PSOHLNE3",98,0)
 . I +$G(PSOPFS)>0&('$P($G(PSOPFS),"^",2)) K PSOPFS Q   ;don't send unreleased charge msg
"RTN","PSOHLNE3",99,0)
 . I +$G(PSOPFS)<1 K PSOPFS  ;invalid PFSS ACCT REF/ SEND TO IB
"RTN","PSOHLNE3",100,0)
 . I +$G(PSOPFS)>0 S PSOPFS="1^"_PSOPFS
"RTN","PSOHLNE3",101,0)
 . ;
"RTN","PSOHLNE3",102,0)
 . I +$G(PSOPFS) D CHRG^PSOPFSU1(RXN,PSOLFIL,"CG",PSOPFS) ;always send to external bill sys
"RTN","PSOHLNE3",103,0)
 ;
"RTN","PSOHLNE3",104,0)
 ; Copay to no-copay updates
"RTN","PSOHLNE3",105,0)
 I $G(PSODCPY) D COPAY^PSOHLNE4
"RTN","PSOHLNE3",106,0)
 ;ICD UPDATE ONLY FOR COPAYS
"RTN","PSOHLNE3",107,0)
 I ('$G(PSODCPY)&($G(PSODGUP)))&($P($G(PSOPFS),"^",2)) D CHRG^PSOPFSU1(RXN,PSOLFIL,"CG",PSOPFS) ;DIAGNOSIS UPDATE ONLY
"RTN","PSOHLNE3",108,0)
 I ($G(PSODCPY)!($G(PSODGUP))) D ALOG
"RTN","PSOHLNE3",109,0)
 Q RET
"RTN","PSOHLNE3",110,0)
 ;
"RTN","PSOHLNE3",111,0)
CPAY ;
"RTN","PSOHLNE3",112,0)
 N X,Y,III,ACTYP,BL
"RTN","PSOHLNE3",113,0)
 S PSOSITE=$P(^PSRX(RXN,2),"^",9)
"RTN","PSOHLNE3",114,0)
 S X=$P($G(^PS(59,+PSOSITE,"IB")),"^")_"^"_DFN D XTYPE^IBARX
"RTN","PSOHLNE3",115,0)
 S (ACTYP,BL)="",(PSOBILL,PSOCPAY)=0
"RTN","PSOHLNE3",116,0)
CPAY1 ;
"RTN","PSOHLNE3",117,0)
 N PSOEXMPT
"RTN","PSOHLNE3",118,0)
 S ACTYP=$O(Y(ACTYP)) G:'ACTYP CSKP F III=0:0 S BL=$O(Y(ACTYP,BL)) Q:BL=""  I BL>0 S PSOBILL=BL,PSOCPAY=BL_"^"_Y(ACTYP,BL)
"RTN","PSOHLNE3",119,0)
 G CPAY1
"RTN","PSOHLNE3",120,0)
CSKP ;
"RTN","PSOHLNE3",121,0)
 S:$G(PSOSI) PSOCPAY=0,PSOEXMPT=1  ;Supply item/investigational drug/nutritional supplement
"RTN","PSOHLNE3",122,0)
 S:$P($G(^PS(53,+$G(PTSTATUS),0)),"^",7)=1 PSOCPAY=0  ;Rx Patient Status exempt
"RTN","PSOHLNE3",123,0)
 I PSOIBQC'="" S:PSOIBQC'[1 PSOCPAY=1  ;Yes SC/EI from CPRS
"RTN","PSOHLNE3",124,0)
 I (PSOBILL'>0)!(PSOCPAY=0) S PSOCPAY=0  ;INELIGIBLE
"RTN","PSOHLNE3",125,0)
 ;***** begin - for regression test - sites must not use this as it will adversely affect billing results - only used by SQA
"RTN","PSOHLNE3",126,0)
 ; The following is required for testing different effective dates.  If date is less than 02/27/17 bills old way.  Otherwise bills new way.
"RTN","PSOHLNE3",127,0)
 ;S ^XTMP("PSOTIEREFTST",0)="3201231^3170227^FOR SQA TESTING ONLY" - Defined for SQA testing only.   Delete this XTMP when regression complete
"RTN","PSOHLNE3",128,0)
 D NOW^%DTC N PSOTIERE
"RTN","PSOHLNE3",129,0)
 S PSOTIERE=1  ;use copay tiers - new
"RTN","PSOHLNE3",130,0)
 I $P(%,".")<3170227 S PSOTIERE=0  ;legacy billing - old
"RTN","PSOHLNE3",131,0)
 I $G(^XTMP("PSOTIEREFTST",0)) S PSOTIERE=1  ;for SQA testing only - bill with copay tiers - new
"RTN","PSOHLNE3",132,0)
 ;***** end for regression test
"RTN","PSOHLNE3",133,0)
 G COPAYRE1:'PSOTIERE
"RTN","PSOHLNE3",134,0)
 ; check copay tier. Tier zero does not have copay charges
"RTN","PSOHLNE3",135,0)
 N CPDATE,X,PSOCPT D NOW^%DTC S CPDATE=X S PSOCPT=$$CPTIER^PSNAPIS("",CPDATE,DRG) K CPDATE,X
"RTN","PSOHLNE3",136,0)
 I $P(PSOCPT,"^")=0 S PSOCPAY=0,$P(^PSRX(RXN,"IB"),"^",1)=""   ;Tier zero do not send to IB for copay charge
"RTN","PSOHLNE3",137,0)
 I '$G(PSOEXMPT),$P(PSOCPT,"^")'=0 S PSOCPAY=1
"RTN","PSOHLNE3",138,0)
COPAYRE1 ;
"RTN","PSOHLNE3",139,0)
 Q
"RTN","PSOHLNE3",140,0)
 ;
"RTN","PSOHLNE3",141,0)
CHOC ;check outpatient classifications
"RTN","PSOHLNE3",142,0)
 S:PSOANSQ(PSOX("IRXN"),TYPE)'=PSOOICD(52.052311,1_","_PSOX("IRXN")_",",PSOFLD,"I") PSODCPY=1
"RTN","PSOHLNE3",143,0)
 Q
"RTN","PSOHLNE3",144,0)
 ;
"RTN","PSOHLNE3",145,0)
ALOG ;set activity log with edit info from cprs
"RTN","PSOHLNE3",146,0)
 N ACNT,SUB,RF,RFCNT
"RTN","PSOHLNE3",147,0)
 S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(RXN,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOHLNE3",148,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(RXN,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOHLNE3",149,0)
 D NOW^%DTC S ACNT=ACNT+1
"RTN","PSOHLNE3",150,0)
 S ^PSRX(RXN,"A",0)="^52.3DA^"_ACNT_"^"_ACNT S ^PSRX(RXN,"A",ACNT,0)=%_"^"_"E"_"^^"_RFCNT_"^Clinical Indicators and SC/EI's were updated from a CPRS e-sig edit at "_$E($P(%,".",2),1,2)_":"_$E($P(%,".",2),3,4)_"."
"RTN","PSOHLNE3",151,0)
 Q
"RTN","PSOHLNE3",152,0)
 ;
"RTN","PSOHLNE3",153,0)
CHKOI ;get and compare orderable items in file #100 and #52; don't process
"RTN","PSOHLNE3",154,0)
 ;  if it's different and the placer # is null.
"RTN","PSOHLNE3",155,0)
 I '$D(ARRAY(52,RXN_",",6,"I")) S OICHK=1 Q
"RTN","PSOHLNE3",156,0)
 D GETS^DIQ(50,ARRAY(52,RXN_",",6,"I")_",","2.1","I","PSOOI")
"RTN","PSOHLNE3",157,0)
 S ORITEM2=$$GET1^DIQ(100.001,"1,"_ORIEN_",",".01","I")
"RTN","PSOHLNE3",158,0)
 S ORID=$$GET1^DIQ(101.43,ORITEM2_",","2","I") S ORID=$P(ORID,";",1)
"RTN","PSOHLNE3",159,0)
 I PSOOI(50,ARRAY(52,RXN_",",6,"I")_",",2.1,"I")'="" I PSOOI(50,ARRAY(52,RXN_",",6,"I")_",",2.1,"I")'=ORID S OICHK=1
"RTN","PSOHLNE3",160,0)
 Q
"RTN","PSOHLNE3",161,0)
TEST(ORIEN) ;manually test an individual order record
"RTN","PSOHLNE3",162,0)
 N I,X,ORSCEIS,ORSCEI,ORDX,EDFLG,ORITEM,DFN,JJ
"RTN","PSOHLNE3",163,0)
 S (JJ,I)=0 F  S I=$O(^OR(100,ORIEN,5.1,I)) Q:I=""!(I'?1N.NN)  S JJ=JJ+1,ORDX(JJ)=$G(^OR(100,ORIEN,5.1,I,0))
"RTN","PSOHLNE3",164,0)
 S ORSCEIS=^OR(100,ORIEN,5.2),ORITEM=$P($G(^OR(100,ORIEN,4)),"^",1)
"RTN","PSOHLNE3",165,0)
 S ORSCEI="" F I=3,4,1,5,2,6,7 S ORSCEI=ORSCEI_"^"_$P(ORSCEIS,"^",I)
"RTN","PSOHLNE3",166,0)
 S:$$PATCH^XPDUTL("OR*3.0*243") ORSCEI=ORSCEI_"^"_$P(ORSCEIS,"^",8)
"RTN","PSOHLNE3",167,0)
 S ORSCEI=$E(ORSCEI,2,99)
"RTN","PSOHLNE3",168,0)
 S RXN=ORITEM,DFN=$P($P(^OR(100,ORIEN,0),"^",2),";",1)
"RTN","PSOHLNE3",169,0)
 D EN^PSOHLNE3(DFN,ORITEM,ORIEN,.ORDX,ORSCEI)
"RTN","PSOHLNE3",170,0)
 Q
"RTN","PSOHLNE3",171,0)
OBXNTE ; Called from PSOHLNEW due to it's routine size.
"RTN","PSOHLNE3",172,0)
 S LL=ZZ+1,PSOBCT=2
"RTN","PSOHLNE3",173,0)
 I $P($G(MSG(LL)),"|")="NTE" D
"RTN","PSOHLNE3",174,0)
 .I $P(MSG(LL),"|",4)'="" S PSOBCT=3,OBXAR(OCOUNT,2)=$P(MSG(LL),"|",4)
"RTN","PSOHLNE3",175,0)
 .F LLL=0:0 S LLL=$O(MSG(LL,LLL)) Q:'LLL  D
"RTN","PSOHLNE3",176,0)
 ..I $P($G(MSG(LL,LLL)),"|",4)'="" S OBXAR(OCOUNT,PSOBCT)=$P(MSG(LL,LLL),"|",4),PSOBCT=PSOBCT+1
"RTN","PSOHLNE3",177,0)
 Q
"VER")
8.0^22.0
"BLD",9632,6)
^391
**END**
**END**

