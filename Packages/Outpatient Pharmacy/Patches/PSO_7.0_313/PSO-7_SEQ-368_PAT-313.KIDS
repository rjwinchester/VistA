Released PSO*7*313 SEQ #368
Extracted from mail message
**KIDS**:PSO*7.0*313^

**INSTALL NAME**
PSO*7.0*313
"BLD",8639,0)
PSO*7.0*313^OUTPATIENT PHARMACY^0^3140731^y
"BLD",8639,1,0)
^^260^260^3140731^
"BLD",8639,1,1,0)
This patch PSO*7*313 includes the following enhancements:
"BLD",8639,1,2,0)
  1. Complex Orders Duration Field 
"BLD",8639,1,3,0)
  2. Titration/Maintenance Rx 
"BLD",8639,1,4,0)
    
"BLD",8639,1,5,0)
1. Complex Orders Duration Field 
"BLD",8639,1,6,0)
================================
"BLD",8639,1,7,0)
This Enhancement is related to Patient Safety Issue PSI-07-167 and Remedy 
"BLD",8639,1,8,0)
Ticket # 203088. 
"BLD",8639,1,9,0)
 
"BLD",8639,1,10,0)
The Outpatient Pharmacy application currently allows the entry of a 
"BLD",8639,1,11,0)
complex order, which contains a "THEN" conjunction. This type of order is
"BLD",8639,1,12,0)
allowed to leave the Duration field preceding the "THEN" conjunction 
"BLD",8639,1,13,0)
as null. This null duration field is causing issues when the Outpatient
"BLD",8639,1,14,0)
Pharmacy order was being transferred to an Inpatient Medication Order(s).
"BLD",8639,1,15,0)
The default stop dates were for thirty (30) days for the two (2) new
"BLD",8639,1,16,0)
inpatient orders created and the Start/Stop dates in the sequence were
"BLD",8639,1,17,0)
incorrect. The pharmacist did not notice the incorrect dates and finished
"BLD",8639,1,18,0)
off the orders. Upon transfer of a complex order from Outpatient Pharmacy
"BLD",8639,1,19,0)
to Inpatient Medication order(s), the resulting order will start at the
"BLD",8639,1,20,0)
first step rather than continue at the step the patient was at as an
"BLD",8639,1,21,0)
Outpatient. It looks like a new complex order to the finishing pharmacist,
"BLD",8639,1,22,0)
since the Start date is populated with the date of finishing so that the
"BLD",8639,1,23,0)
patient would be started on the first step, which may not be correct.
"BLD",8639,1,24,0)
This would pertain to complex orders that taper or titrate doses up or
"BLD",8639,1,25,0)
down and potentially impacts patients by receiving too much or too little
"BLD",8639,1,26,0)
medication.  
"BLD",8639,1,27,0)
 
"BLD",8639,1,28,0)
The Outpatient Pharmacy is being modified to require the entry of a 
"BLD",8639,1,29,0)
duration for a dose preceding a THEN conjunction if the schedule for such
"BLD",8639,1,30,0)
dose is not a ONE-TIME type schedule. If the dose preceding the THEN
"BLD",8639,1,31,0)
conjunction is a ONE-TIME type schedule the software will continue to
"BLD",8639,1,32,0)
allow the Duration field to be left blank (optional). The corresponding
"BLD",8639,1,33,0)
change to CPRS will be done in a future CPRS patch.
"BLD",8639,1,34,0)
 
"BLD",8639,1,35,0)
Example of an acceptable SIG ('NOW' is ONE-TIME type schedule): 
"BLD",8639,1,36,0)
--------------------------------------------------------------
"BLD",8639,1,37,0)
TAKE ONE TABLET BY MOUTH NOW THEN TAKE TWO TABLETS EVERY 8 HOURS 
"BLD",8639,1,38,0)
 
"BLD",8639,1,39,0)
No longer acceptable SIG ('Q4H' is not ONE-TIME type schedule): 
"BLD",8639,1,40,0)
--------------------------------------------------------------
"BLD",8639,1,41,0)
TAKE ONE TABLET BY MOUTH EVERY 4 HOURS THEN TAKE TWO TABLETS EVERY 8 
"BLD",8639,1,42,0)
HOURS 
"BLD",8639,1,43,0)
 
"BLD",8639,1,44,0)
Note: The SIG above is not acceptable because it does not have a 
"BLD",8639,1,45,0)
      Duration for the first dose. In order to be acceptable the 
"BLD",8639,1,46,0)
      SIG above would have to have a duration like the one below: 
"BLD",8639,1,47,0)
       
"BLD",8639,1,48,0)
      TAKE ONE TABLET BY MOUTH EVERY 4 HOURS FOR 3 DAYS THEN TAKE TWO 
"BLD",8639,1,49,0)
      TABLETS EVERY 8 HOURS 
"BLD",8639,1,50,0)
   
"BLD",8639,1,51,0)
The Duration field is not required for the dose following the last "THEN"
"BLD",8639,1,52,0)
conjunction.  
"BLD",8639,1,53,0)
  
"BLD",8639,1,54,0)
Below is an example of a complex order being entered via Patient 
"BLD",8639,1,55,0)
Prescription
"BLD",8639,1,56,0)
Processing [PSO LM BACKDOOR ORDERS] 
"BLD",8639,1,57,0)
  
"BLD",8639,1,58,0)
    :       :
"BLD",8639,1,59,0)
  VERB: APPLY 
"BLD",8639,1,60,0)
  ROUTE: PO// PO   ORAL 
"BLD",8639,1,61,0)
  Schedule: QD (EVERY DAY) 
"BLD",8639,1,62,0)
     
"BLD",8639,1,63,0)
  LIMITED DURATION (IN DAYS, HOURS OR MINUTES): 
"BLD",8639,1,64,0)
  CONJUNCTION: THEN 
"BLD",8639,1,65,0)
   
"BLD",8639,1,66,0)
 Duration field required for the dosage entered prior to this THEN 
"BLD",8639,1,67,0)
 conjunction. 
"BLD",8639,1,68,0)
 
"BLD",8639,1,69,0)
  
"BLD",8639,1,70,0)
  LIMITED DURATION (IN DAYS, HOURS OR MINUTES): 
"BLD",8639,1,71,0)
    :       :
"BLD",8639,1,72,0)
 
"BLD",8639,1,73,0)
2. Titration/Maintenance Rx 
"BLD",8639,1,74,0)
===========================
"BLD",8639,1,75,0)
This Enhancement is related to PSI-06-176 and Remedy Ticket #168928.  
"BLD",8639,1,76,0)
 
"BLD",8639,1,77,0)
The Outpatient Pharmacy (OP) application was modified to accommodate 
"BLD",8639,1,78,0)
Titration/Maintenance prescription functionality. The existing software 
"BLD",8639,1,79,0)
presented patient safety risks when prescriptions dispensed with a 
"BLD",8639,1,80,0)
titrating dose followed by a maintenance dose were being copied, renewed
"BLD",8639,1,81,0)
or refilled. The issue was that refills as well as the new prescriptions
"BLD",8639,1,82,0)
(derived from copy, renewals or edits) automatically carried over the
"BLD",8639,1,83,0)
initial titrating dose into the new fill/prescription, which was not
"BLD",8639,1,84,0)
always the user's intention.  
"BLD",8639,1,85,0)
 
"BLD",8639,1,86,0)
The new functionality provides two steps for processing Titration/ 
"BLD",8639,1,87,0)
Maintenance prescriptions.
"BLD",8639,1,88,0)
 
"BLD",8639,1,89,0)
a. First, the user will have the ability to mark prescriptions as 
"BLD",8639,1,90,0)
   'Titration to Maintenance' when finishing prescriptions from CPRS as 
"BLD",8639,1,91,0)
   well as via the Patient Prescription Processing [PSO LM BACKDOOR 
"BLD",8639,1,92,0)
   ORDERS] option by invoking the new hidden action 'TM' - Mark Rx 
"BLD",8639,1,93,0)
   as Titration. This action will result in preventing the following 
"BLD",8639,1,94,0)
   actions to be taken on the prescription: Refill, Renewal (including 
"BLD",8639,1,95,0)
   via CPRS), Copy and editing of any field that requires a new Rx to be 
"BLD",8639,1,96,0)
   created. This action will also set the new field TITRATION RX FLAG 
"BLD",8639,1,97,0)
   (#45.3) in the PRESCRIPTION File (#52) as well as the new field 
"BLD",8639,1,98,0)
   TITRATION DOSE RX (#45.1) in the PRESCRIPTION File (#52).  
"BLD",8639,1,99,0)
   Prescriptions that are marked as Titration/Maintenance will 
"BLD",8639,1,100,0)
   have the letter 't' postfix to the RX # as seen below (entry #1): 
"BLD",8639,1,101,0)
 
"BLD",8639,1,102,0)
           :                   :                            :
"BLD",8639,1,103,0)
                                                   ISSUE  LAST REF DAY 
"BLD",8639,1,104,0)
   #  RX #       DRUG                       QTY ST  DATE  FILL REM SUP 
"BLD",8639,1,105,0)
  -------------------------------ACTIVE------------------------------- 
"BLD",8639,1,106,0)
   1 100005024t  AMOXAPINE 50MG TAB          30 S  09-26 09-26   2  30 
"BLD",8639,1,107,0)
   2 100005022   AMOXICILLIN 250MG CAP       30 A  08-18 08-18  11  30 
"BLD",8639,1,108,0)
   3 100005035   KALETRA                      3 A  09-29 09-29   0   3 
"BLD",8639,1,109,0)
           :                   :                            :
"BLD",8639,1,110,0)
 
"BLD",8639,1,111,0)
   Note: A prescription can be unmarked as Titration/Maintenance by 
"BLD",8639,1,112,0)
         invoking the same TM action on an already marked prescription.  
"BLD",8639,1,113,0)
 
"BLD",8639,1,114,0)
  
"BLD",8639,1,115,0)
b. A new hidden action is being introduced in the Patient Prescription 
"BLD",8639,1,116,0)
   Processing [LM BACKDOOR ORDERS] option called TR (Convert 
"BLD",8639,1,117,0)
   Titration Rx). This action will populate the new field MAINTENANCE 
"BLD",8639,1,118,0)
   DOSE RX (#45.2) in the PRESCRIPTION File (#52).  
"BLD",8639,1,119,0)
   When a titration to maintenance prescription needs to be 
"BLD",8639,1,120,0)
   refilled so the patient can continue on the Maintenance Dose 
"BLD",8639,1,121,0)
   this option will allow the users to create a new prescription with 
"BLD",8639,1,122,0)
   the maintenance dose only. The process works similar to copying an 
"BLD",8639,1,123,0)
   existing prescription, however it can only be used on prescriptions 
"BLD",8639,1,124,0)
   with the following characteristics: 
"BLD",8639,1,125,0)
   
"BLD",8639,1,126,0)
     - Rx is a complex order with a THEN conjunction
"BLD",8639,1,127,0)
     - Rx was not digitally signed
"BLD",8639,1,128,0)
     - Rx is released 
"BLD",8639,1,129,0)
     - Rx status is ACTIVE 
"BLD",8639,1,130,0)
     - Rx does not have refills previously ordered 
"BLD",8639,1,131,0)
     - Rx # Of Refills is greater than 0 (zero) 
"BLD",8639,1,132,0)
   
"BLD",8639,1,133,0)
   Before the new Maintenance Rx can be accepted the Pharmacist is 
"BLD",8639,1,134,0)
   prompted to validate the QTY field for the new Rx, which may or may not
"BLD",8639,1,135,0)
   be automatically re-calculated. Only the last dose from the original
"BLD",8639,1,136,0)
   prescription is carried over to the new Maintenance Rx and the # of 
"BLD",8639,1,137,0)
   Refills field is decreased by 1 because the new Maintenance Rx counts 
"BLD",8639,1,138,0)
   as a fill. The Fill Date for the new Maintenance prescription is 
"BLD",8639,1,139,0)
   automatically set with the next possible fill date from the existing
"BLD",8639,1,140,0)
   prescription, which can be changed by the pharmacist.
"BLD",8639,1,141,0)
   Once the pharmacist verifies the information for the Maintenance Rx is 
"BLD",8639,1,142,0)
   accurate they can accept the Maintenance Rx. This action will trigger 
"BLD",8639,1,143,0)
   a Duplicate Drug check against the original complex order, which must 
"BLD",8639,1,144,0)
   be discontinued before the new Maintenance Rx can be accepted. 
"BLD",8639,1,145,0)
   After the new Maintenance Rx is accepted it will have the new 
"BLD",8639,1,146,0)
   indicator 'm' on the right side of the Rx # in the patient's Medication
"BLD",8639,1,147,0)
   Profile as seen below (entry #1):
"BLD",8639,1,148,0)
 
"BLD",8639,1,149,0)
           :                   :                            :
"BLD",8639,1,150,0)
                                                   ISSUE  LAST REF DAY 
"BLD",8639,1,151,0)
   #  RX #       DRUG                       QTY ST  DATE  FILL REM SUP 
"BLD",8639,1,152,0)
  -------------------------------ACTIVE------------------------------- 
"BLD",8639,1,153,0)
   1 100005436m  AMOXAPINE 50MG TAB          30 S  09-26 09-26   1  30 
"BLD",8639,1,154,0)
   2 100005022   AMOXICILLIN 250MG CAP       30 A  08-18 08-18  11  30 
"BLD",8639,1,155,0)
   3 100005035   KALETRA                      3 A  09-29 09-29   0   3 
"BLD",8639,1,156,0)
           :                   :                            :
"BLD",8639,1,157,0)
 
"BLD",8639,1,158,0)
c. The new Titration/Maintenance indicator (t/m) will be included in the 
"BLD",8639,1,159,0)
   following menu options where the prescription number is displayed: 
"BLD",8639,1,160,0)
 
"BLD",8639,1,161,0)
   View Prescriptions                       [PSO VIEW] 
"BLD",8639,1,162,0)
   Patient Prescription Processing          [PSO LM BACKDOOR ORDERS]    
"BLD",8639,1,163,0)
   Complete Orders from OERR                [PSO LMOE FINISH] 
"BLD",8639,1,164,0)
   ePharmacy Medication Profile (View Only) [PSO PMP] 
"BLD",8639,1,165,0)
   Medication Profile                       [PSO P] 
"BLD",8639,1,166,0)
  
"BLD",8639,1,167,0)
d. External refill requests such as from AudioFax and Internet will not 
"BLD",8639,1,168,0)
   be processed for Titration/Maintenance marked prescriptions. 
"BLD",8639,1,169,0)
 
"BLD",8639,1,170,0)
   Subj: ALBANY External Application Refills: Not processed List  
"BLD",8639,1,171,0)
         [#101509] 01/28/09@13:52  11 lines
"BLD",8639,1,172,0)
   From: POSTMASTER  In 'IN' basket.   Page 1 
"BLD",8639,1,173,0)
   
"BLD",8639,1,174,0)
-------------------------------------------------------------------------
"BLD",8639,1,175,0)
   Refills Not Processed Report for the ALBANY Division.  
"BLD",8639,1,176,0)
 
"BLD",8639,1,177,0)
   The following refill requests were not processed:  
"BLD",8639,1,178,0)
 
"BLD",8639,1,179,0)
   Patient: OPPATIENT,TWO (9999) 
"BLD",8639,1,180,0)
 
"BLD",8639,1,181,0)
     Rx #: 100005122  (REF #1)  Qty: 55 
"BLD",8639,1,182,0)
     Drug: ZINC SULFATE 66MG TAB 
"BLD",8639,1,183,0)
     Reason: 'Titration/Maintenance Rx' cannot be refilled.  
"BLD",8639,1,184,0)
 
"BLD",8639,1,185,0)
e. CPRS refill requests will not be automatically processed for
"BLD",8639,1,186,0)
   Titration/Maintenance marked prescriptions. The refill request will
"BLD",8639,1,187,0)
   remain in the patient's Medication Profile as PENDING and the mailman
"BLD",8639,1,188,0)
   message above (item d) will also be sent to PSOAUTRF security key
"BLD",8639,1,189,0)
   holders.  
"BLD",8639,1,190,0)
  
"BLD",8639,1,191,0)
f. The activity logs for both Titration and Maintenance Rx's will record 
"BLD",8639,1,192,0)
   the corresponding Titration and Maintenance Rx # if they exist as seen 
"BLD",8639,1,193,0)
   below: 
"BLD",8639,1,194,0)
  
"BLD",8639,1,195,0)
Titration Rx: 
"BLD",8639,1,196,0)
------------
"BLD",8639,1,197,0)
#   Date        Reason         Rx Ref         Initiator of Activity  
"BLD",8639,1,198,0)
====================================================================== 
"BLD",8639,1,199,0)
1   09/29/08    EDIT           ORIGINAL       OPUSER,ONE Comments: 
"BLD",8639,1,200,0)
Maintenance
"BLD",8639,1,201,0)
Dose Rx: 100005130 
"BLD",8639,1,202,0)
 
"BLD",8639,1,203,0)
 
"BLD",8639,1,204,0)
Maintenance Rx: 
"BLD",8639,1,205,0)
--------------
"BLD",8639,1,206,0)
#   Date        Reason         Rx Ref         Initiator of Activity  
"BLD",8639,1,207,0)
====================================================================== 
"BLD",8639,1,208,0)
1   09/29/08    EDIT           ORIGINAL       OPUSER,TWO Comments: 
"BLD",8639,1,209,0)
Titration Dose Rx: 100005392
"BLD",8639,1,210,0)
    
"BLD",8639,1,211,0)
 
"BLD",8639,1,212,0)
g. The VistA Integration Control Registration (ICR) #2398 provided to 
"BLD",8639,1,213,0)
   Computerized Patient Record System V. 1.0 (CPRS) was modified to 
"BLD",8639,1,214,0)
   prevent the renewal of a Titration dose order with the following 
"BLD",8639,1,215,0)
   message: 
"BLD",8639,1,216,0)
 
"BLD",8639,1,217,0)
  "Prescription was marked as Titration to Maintenance Dose  by Pharmacy 
"BLD",8639,1,218,0)
  and cannot be renewed. To repeat the titration, enter a new prescription
"BLD",8639,1,219,0)
  or copy the prior titration order. To continue the maintenance dose, 
"BLD",8639,1,220,0)
  refill this prescription if refills are available or enter a new
"BLD",8639,1,221,0)
  prescription for the maintenance dose."
"BLD",8639,1,222,0)
 
"BLD",8639,1,223,0)
 
"BLD",8639,1,224,0)
h. When using the Barcode Batch Prescription Entry option 
"BLD",8639,1,225,0)
   [PSO BATCH BARCODE], if the prescription has been marked 
"BLD",8639,1,226,0)
   as a Titration/Maintenance Rx, and the user attempts to 
"BLD",8639,1,227,0)
   renew or refill the prescription, the following message 
"BLD",8639,1,228,0)
   will display: 
"BLD",8639,1,229,0)
 
"BLD",8639,1,230,0)
   For a renewal: 
"BLD",8639,1,231,0)
   "Rx# XXXXXX is marked as Titration Rx and cannot be renewed." 
"BLD",8639,1,232,0)
 
"BLD",8639,1,233,0)
   For a refill: 
"BLD",8639,1,234,0)
   "Rx# XXXXXX is marked as Titration Rx and cannot be refilled." 
"BLD",8639,1,235,0)
 
"BLD",8639,1,236,0)
 
"BLD",8639,1,237,0)
i. The PSO HIDDEN ACTIONS Protocol in the PROTOCOL File (#101) 
"BLD",8639,1,238,0)
   will be modified to include the two new Hidden Actions 
"BLD",8639,1,239,0)
   introduced by this enhancement.  PSO LM BACKDOOR MARK AS 
"BLD",8639,1,240,0)
   TITRATION and PSO LM BACKDOOR TITRATION RX REFILL are both 
"BLD",8639,1,241,0)
   new protocols added to the PROTOCOL File (#101). 
"BLD",8639,1,242,0)
 
"BLD",8639,1,243,0)
 
"BLD",8639,1,244,0)
 
"BLD",8639,1,245,0)
 ******************************  IMPORTANT  ******************************
"BLD",8639,1,246,0)
 The enhancements related to Titration/Maintenance dose Rx are made only 
"BLD",8639,1,247,0)
 for Outpatient Pharmacy package. The corresponding changes to CPRS 
"BLD",8639,1,248,0)
 package are not included at this time. Therefore, the CPRS Order Copy and
"BLD",8639,1,249,0)
 Order Change functionalities will continue to function as is. 
"BLD",8639,1,250,0)
 Furthermore, there will be no indication of a Titration/Maintenance order
"BLD",8639,1,251,0)
 in the CPRS application.
"BLD",8639,1,252,0)
 *************************************************************************
"BLD",8639,1,253,0)
 
"BLD",8639,1,254,0)
3. Remedy Ticket #1022059 
"BLD",8639,1,255,0)
   This patch fixes an issue that could create duplicate prescriptions on 
"BLD",8639,1,256,0)
   a patient profile. When a complex order is copied and the duration 
"BLD",8639,1,257,0)
   field is edited, upon accepting the order, the message to discontinue
"BLD",8639,1,258,0)
   the original order is not triggered. This causes duplicate 
"BLD",8639,1,259,0)
   prescriptions to appear on the patient profile. This patch corrects
"BLD",8639,1,260,0)
   this problem by prompting the user to discontinue the original order.
"BLD",8639,4,0)
^9.64PA^52^1
"BLD",8639,4,52,0)
52
"BLD",8639,4,52,2,0)
^9.641^52^1
"BLD",8639,4,52,2,52,0)
PRESCRIPTION  (File-top level)
"BLD",8639,4,52,2,52,1,0)
^9.6411^45.3^3
"BLD",8639,4,52,2,52,1,45.1,0)
TITRATION DOSE RX
"BLD",8639,4,52,2,52,1,45.2,0)
MAINTENANCE DOSE RX
"BLD",8639,4,52,2,52,1,45.3,0)
TITRATION RX FLAG
"BLD",8639,4,52,222)
y^y^p^^^^n^^n
"BLD",8639,4,52,224)

"BLD",8639,4,"APDD",52,52)

"BLD",8639,4,"APDD",52,52,45.1)

"BLD",8639,4,"APDD",52,52,45.2)

"BLD",8639,4,"APDD",52,52,45.3)

"BLD",8639,4,"B",52,52)

"BLD",8639,6)
11^
"BLD",8639,6.3)
76
"BLD",8639,"ABPKG")
n
"BLD",8639,"KRN",0)
^9.67PA^779.2^20
"BLD",8639,"KRN",.4,0)
.4
"BLD",8639,"KRN",.401,0)
.401
"BLD",8639,"KRN",.402,0)
.402
"BLD",8639,"KRN",.403,0)
.403
"BLD",8639,"KRN",.5,0)
.5
"BLD",8639,"KRN",.84,0)
.84
"BLD",8639,"KRN",3.6,0)
3.6
"BLD",8639,"KRN",3.8,0)
3.8
"BLD",8639,"KRN",9.2,0)
9.2
"BLD",8639,"KRN",9.8,0)
9.8
"BLD",8639,"KRN",9.8,"NM",0)
^9.68A^64^33
"BLD",8639,"KRN",9.8,"NM",7,0)
PSOP^^0^B45480400
"BLD",8639,"KRN",9.8,"NM",8,0)
PSOP1^^0^B26639080
"BLD",8639,"KRN",9.8,"NM",18,0)
PSOPMP0^^0^B82071360
"BLD",8639,"KRN",9.8,"NM",19,0)
PSORENW^^0^B44953613
"BLD",8639,"KRN",9.8,"NM",20,0)
PSORXEDT^^0^B45205767
"BLD",8639,"KRN",9.8,"NM",21,0)
PSORXVW^^0^B81070397
"BLD",8639,"KRN",9.8,"NM",22,0)
PSOUTL^^0^B132826044
"BLD",8639,"KRN",9.8,"NM",25,0)
PSON52^^0^B91470672
"BLD",8639,"KRN",9.8,"NM",26,0)
PSONEW^^0^B43522881
"BLD",8639,"KRN",9.8,"NM",27,0)
PSOORCPY^^0^B32700347
"BLD",8639,"KRN",9.8,"NM",29,0)
PSOOREDT^^0^B78897328
"BLD",8639,"KRN",9.8,"NM",31,0)
PSOORNE2^^0^B68757551
"BLD",8639,"KRN",9.8,"NM",32,0)
PSOORUT1^^0^B78925499
"BLD",8639,"KRN",9.8,"NM",33,0)
PSOORED3^^0^B65846558
"BLD",8639,"KRN",9.8,"NM",34,0)
PSOORED4^^0^B56835310
"BLD",8639,"KRN",9.8,"NM",35,0)
PSOORED5^^0^B60490141
"BLD",8639,"KRN",9.8,"NM",36,0)
PSOORNEW^^0^B93328649
"BLD",8639,"KRN",9.8,"NM",37,0)
PSORENW4^^0^B62985403
"BLD",8639,"KRN",9.8,"NM",39,0)
PSOLMPO2^^0^B829209
"BLD",8639,"KRN",9.8,"NM",40,0)
PSOORNW1^^0^B45684581
"BLD",8639,"KRN",9.8,"NM",41,0)
PSOORNE1^^0^B77126364
"BLD",8639,"KRN",9.8,"NM",42,0)
PSOORED1^^0^B73633714
"BLD",8639,"KRN",9.8,"NM",43,0)
PSOCPDUP^^0^B33663947
"BLD",8639,"KRN",9.8,"NM",44,0)
PSOOTMRX^^0^B20486782
"BLD",8639,"KRN",9.8,"NM",53,0)
PSOORFI2^^0^B94812114
"BLD",8639,"KRN",9.8,"NM",56,0)
PSOORNE3^^0^B68981522
"BLD",8639,"KRN",9.8,"NM",57,0)
PSOATRF^^0^B82128020
"BLD",8639,"KRN",9.8,"NM",58,0)
PSOATRFC^^0^B47253705
"BLD",8639,"KRN",9.8,"NM",60,0)
PSOSIG^^0^B70480726
"BLD",8639,"KRN",9.8,"NM",61,0)
PSOBBC^^0^B104120785
"BLD",8639,"KRN",9.8,"NM",62,0)
PSOREF^^0^B71972514
"BLD",8639,"KRN",9.8,"NM",63,0)
PSOORNE4^^0^B98202057
"BLD",8639,"KRN",9.8,"NM",64,0)
PSOOREDX^^0^B19747673
"BLD",8639,"KRN",9.8,"NM","B","PSOATRF",57)

"BLD",8639,"KRN",9.8,"NM","B","PSOATRFC",58)

"BLD",8639,"KRN",9.8,"NM","B","PSOBBC",61)

"BLD",8639,"KRN",9.8,"NM","B","PSOCPDUP",43)

"BLD",8639,"KRN",9.8,"NM","B","PSOLMPO2",39)

"BLD",8639,"KRN",9.8,"NM","B","PSON52",25)

"BLD",8639,"KRN",9.8,"NM","B","PSONEW",26)

"BLD",8639,"KRN",9.8,"NM","B","PSOORCPY",27)

"BLD",8639,"KRN",9.8,"NM","B","PSOORED1",42)

"BLD",8639,"KRN",9.8,"NM","B","PSOORED3",33)

"BLD",8639,"KRN",9.8,"NM","B","PSOORED4",34)

"BLD",8639,"KRN",9.8,"NM","B","PSOORED5",35)

"BLD",8639,"KRN",9.8,"NM","B","PSOOREDT",29)

"BLD",8639,"KRN",9.8,"NM","B","PSOOREDX",64)

"BLD",8639,"KRN",9.8,"NM","B","PSOORFI2",53)

"BLD",8639,"KRN",9.8,"NM","B","PSOORNE1",41)

"BLD",8639,"KRN",9.8,"NM","B","PSOORNE2",31)

"BLD",8639,"KRN",9.8,"NM","B","PSOORNE3",56)

"BLD",8639,"KRN",9.8,"NM","B","PSOORNE4",63)

"BLD",8639,"KRN",9.8,"NM","B","PSOORNEW",36)

"BLD",8639,"KRN",9.8,"NM","B","PSOORNW1",40)

"BLD",8639,"KRN",9.8,"NM","B","PSOORUT1",32)

"BLD",8639,"KRN",9.8,"NM","B","PSOOTMRX",44)

"BLD",8639,"KRN",9.8,"NM","B","PSOP",7)

"BLD",8639,"KRN",9.8,"NM","B","PSOP1",8)

"BLD",8639,"KRN",9.8,"NM","B","PSOPMP0",18)

"BLD",8639,"KRN",9.8,"NM","B","PSOREF",62)

"BLD",8639,"KRN",9.8,"NM","B","PSORENW",19)

"BLD",8639,"KRN",9.8,"NM","B","PSORENW4",37)

"BLD",8639,"KRN",9.8,"NM","B","PSORXEDT",20)

"BLD",8639,"KRN",9.8,"NM","B","PSORXVW",21)

"BLD",8639,"KRN",9.8,"NM","B","PSOSIG",60)

"BLD",8639,"KRN",9.8,"NM","B","PSOUTL",22)

"BLD",8639,"KRN",19,0)
19
"BLD",8639,"KRN",19.1,0)
19.1
"BLD",8639,"KRN",101,0)
101
"BLD",8639,"KRN",101,"NM",0)
^9.68A^34^3
"BLD",8639,"KRN",101,"NM",1,0)
PSO LM BACKDOOR TITRATION RX REFILL^^0
"BLD",8639,"KRN",101,"NM",2,0)
PSO HIDDEN ACTIONS^^3
"BLD",8639,"KRN",101,"NM",34,0)
PSO LM BACKDOOR MARK AS TITRATION^^0
"BLD",8639,"KRN",101,"NM","B","PSO HIDDEN ACTIONS",2)

"BLD",8639,"KRN",101,"NM","B","PSO LM BACKDOOR MARK AS TITRATION",34)

"BLD",8639,"KRN",101,"NM","B","PSO LM BACKDOOR TITRATION RX REFILL",1)

"BLD",8639,"KRN",409.61,0)
409.61
"BLD",8639,"KRN",409.61,"NM",0)
^9.68A^^0
"BLD",8639,"KRN",771,0)
771
"BLD",8639,"KRN",779.2,0)
779.2
"BLD",8639,"KRN",870,0)
870
"BLD",8639,"KRN",8989.51,0)
8989.51
"BLD",8639,"KRN",8989.52,0)
8989.52
"BLD",8639,"KRN",8994,0)
8994
"BLD",8639,"KRN","B",.4,.4)

"BLD",8639,"KRN","B",.401,.401)

"BLD",8639,"KRN","B",.402,.402)

"BLD",8639,"KRN","B",.403,.403)

"BLD",8639,"KRN","B",.5,.5)

"BLD",8639,"KRN","B",.84,.84)

"BLD",8639,"KRN","B",3.6,3.6)

"BLD",8639,"KRN","B",3.8,3.8)

"BLD",8639,"KRN","B",9.2,9.2)

"BLD",8639,"KRN","B",9.8,9.8)

"BLD",8639,"KRN","B",19,19)

"BLD",8639,"KRN","B",19.1,19.1)

"BLD",8639,"KRN","B",101,101)

"BLD",8639,"KRN","B",409.61,409.61)

"BLD",8639,"KRN","B",771,771)

"BLD",8639,"KRN","B",779.2,779.2)

"BLD",8639,"KRN","B",870,870)

"BLD",8639,"KRN","B",8989.51,8989.51)

"BLD",8639,"KRN","B",8989.52,8989.52)

"BLD",8639,"KRN","B",8994,8994)

"BLD",8639,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",8639,"QUES",0)
^9.62^^
"BLD",8639,"REQB",0)
^9.611^21^4
"BLD",8639,"REQB",13,0)
PSO*7.0*337^2
"BLD",8639,"REQB",19,0)
PSO*7.0*417^2
"BLD",8639,"REQB",20,0)
PSO*7.0*431^2
"BLD",8639,"REQB",21,0)
PSO*7.0*362^2
"BLD",8639,"REQB","B","PSO*7.0*337",13)

"BLD",8639,"REQB","B","PSO*7.0*362",21)

"BLD",8639,"REQB","B","PSO*7.0*417",19)

"BLD",8639,"REQB","B","PSO*7.0*431",20)

"FIA",52)
PRESCRIPTION
"FIA",52,0)
^PSRX(
"FIA",52,0,0)
52Is
"FIA",52,0,1)
y^y^p^^^^n^^n
"FIA",52,0,10)

"FIA",52,0,11)

"FIA",52,0,"RLRO")

"FIA",52,0,"VR")
7.0^PSO
"FIA",52,52)
1
"FIA",52,52,45.1)

"FIA",52,52,45.2)

"FIA",52,52,45.3)

"KRN",101,3816,-1)
3^2
"KRN",101,3816,0)
PSO HIDDEN ACTIONS^Outpatient Pharmacy Hidden Actions^^M^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,3816,1,0)
^101.06^1^1^3001004^^^^
"KRN",101,3816,1,1,0)
This hidden menu is attached to the the active order list.
"KRN",101,3816,4)
26
"KRN",101,3816,10,0)
^101.01PA^37^37
"KRN",101,3816,10,36,0)
6010^TR^14^
"KRN",101,3816,10,36,"^")
PSO LM BACKDOOR TITRATION RX REFILL
"KRN",101,3816,10,37,0)
6011^TM^15^
"KRN",101,3816,10,37,"^")
PSO LM BACKDOOR MARK AS TITRATION
"KRN",101,3816,24)
I $$ACTIONS^PSOLMUTL
"KRN",101,3816,99)
63202,51763
"KRN",101,6010,-1)
0^1
"KRN",101,6010,0)
PSO LM BACKDOOR TITRATION RX REFILL^Convert Titration Rx^^A^^^^^^^^
"KRN",101,6010,4)
^^^TR
"KRN",101,6010,20)
D TIMTRX^PSOOTMRX
"KRN",101,6010,99)
63202,51763
"KRN",101,6011,-1)
0^34
"KRN",101,6011,0)
PSO LM BACKDOOR MARK AS TITRATION^Titration Mark/Unmark^^A^^^^^^^^
"KRN",101,6011,4)
^^^TM
"KRN",101,6011,20)
D MARKTIT^PSOOTMRX
"KRN",101,6011,99)
63202,51763
"MBREQ")
0
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
313^3140731^11863
"PKG",141,22,1,"PAH",1,1,0)
^^260^260^3140731
"PKG",141,22,1,"PAH",1,1,1,0)
This patch PSO*7*313 includes the following enhancements:
"PKG",141,22,1,"PAH",1,1,2,0)
  1. Complex Orders Duration Field 
"PKG",141,22,1,"PAH",1,1,3,0)
  2. Titration/Maintenance Rx 
"PKG",141,22,1,"PAH",1,1,4,0)
    
"PKG",141,22,1,"PAH",1,1,5,0)
1. Complex Orders Duration Field 
"PKG",141,22,1,"PAH",1,1,6,0)
================================
"PKG",141,22,1,"PAH",1,1,7,0)
This Enhancement is related to Patient Safety Issue PSI-07-167 and Remedy 
"PKG",141,22,1,"PAH",1,1,8,0)
Ticket # 203088. 
"PKG",141,22,1,"PAH",1,1,9,0)
 
"PKG",141,22,1,"PAH",1,1,10,0)
The Outpatient Pharmacy application currently allows the entry of a 
"PKG",141,22,1,"PAH",1,1,11,0)
complex order, which contains a "THEN" conjunction. This type of order is
"PKG",141,22,1,"PAH",1,1,12,0)
allowed to leave the Duration field preceding the "THEN" conjunction 
"PKG",141,22,1,"PAH",1,1,13,0)
as null. This null duration field is causing issues when the Outpatient
"PKG",141,22,1,"PAH",1,1,14,0)
Pharmacy order was being transferred to an Inpatient Medication Order(s).
"PKG",141,22,1,"PAH",1,1,15,0)
The default stop dates were for thirty (30) days for the two (2) new
"PKG",141,22,1,"PAH",1,1,16,0)
inpatient orders created and the Start/Stop dates in the sequence were
"PKG",141,22,1,"PAH",1,1,17,0)
incorrect. The pharmacist did not notice the incorrect dates and finished
"PKG",141,22,1,"PAH",1,1,18,0)
off the orders. Upon transfer of a complex order from Outpatient Pharmacy
"PKG",141,22,1,"PAH",1,1,19,0)
to Inpatient Medication order(s), the resulting order will start at the
"PKG",141,22,1,"PAH",1,1,20,0)
first step rather than continue at the step the patient was at as an
"PKG",141,22,1,"PAH",1,1,21,0)
Outpatient. It looks like a new complex order to the finishing pharmacist,
"PKG",141,22,1,"PAH",1,1,22,0)
since the Start date is populated with the date of finishing so that the
"PKG",141,22,1,"PAH",1,1,23,0)
patient would be started on the first step, which may not be correct.
"PKG",141,22,1,"PAH",1,1,24,0)
This would pertain to complex orders that taper or titrate doses up or
"PKG",141,22,1,"PAH",1,1,25,0)
down and potentially impacts patients by receiving too much or too little
"PKG",141,22,1,"PAH",1,1,26,0)
medication.  
"PKG",141,22,1,"PAH",1,1,27,0)
 
"PKG",141,22,1,"PAH",1,1,28,0)
The Outpatient Pharmacy is being modified to require the entry of a 
"PKG",141,22,1,"PAH",1,1,29,0)
duration for a dose preceding a THEN conjunction if the schedule for such
"PKG",141,22,1,"PAH",1,1,30,0)
dose is not a ONE-TIME type schedule. If the dose preceding the THEN
"PKG",141,22,1,"PAH",1,1,31,0)
conjunction is a ONE-TIME type schedule the software will continue to
"PKG",141,22,1,"PAH",1,1,32,0)
allow the Duration field to be left blank (optional). The corresponding
"PKG",141,22,1,"PAH",1,1,33,0)
change to CPRS will be done in a future CPRS patch.
"PKG",141,22,1,"PAH",1,1,34,0)
 
"PKG",141,22,1,"PAH",1,1,35,0)
Example of an acceptable SIG ('NOW' is ONE-TIME type schedule): 
"PKG",141,22,1,"PAH",1,1,36,0)
--------------------------------------------------------------
"PKG",141,22,1,"PAH",1,1,37,0)
TAKE ONE TABLET BY MOUTH NOW THEN TAKE TWO TABLETS EVERY 8 HOURS 
"PKG",141,22,1,"PAH",1,1,38,0)
 
"PKG",141,22,1,"PAH",1,1,39,0)
No longer acceptable SIG ('Q4H' is not ONE-TIME type schedule): 
"PKG",141,22,1,"PAH",1,1,40,0)
--------------------------------------------------------------
"PKG",141,22,1,"PAH",1,1,41,0)
TAKE ONE TABLET BY MOUTH EVERY 4 HOURS THEN TAKE TWO TABLETS EVERY 8 
"PKG",141,22,1,"PAH",1,1,42,0)
HOURS 
"PKG",141,22,1,"PAH",1,1,43,0)
 
"PKG",141,22,1,"PAH",1,1,44,0)
Note: The SIG above is not acceptable because it does not have a 
"PKG",141,22,1,"PAH",1,1,45,0)
      Duration for the first dose. In order to be acceptable the 
"PKG",141,22,1,"PAH",1,1,46,0)
      SIG above would have to have a duration like the one below: 
"PKG",141,22,1,"PAH",1,1,47,0)
       
"PKG",141,22,1,"PAH",1,1,48,0)
      TAKE ONE TABLET BY MOUTH EVERY 4 HOURS FOR 3 DAYS THEN TAKE TWO 
"PKG",141,22,1,"PAH",1,1,49,0)
      TABLETS EVERY 8 HOURS 
"PKG",141,22,1,"PAH",1,1,50,0)
   
"PKG",141,22,1,"PAH",1,1,51,0)
The Duration field is not required for the dose following the last "THEN"
"PKG",141,22,1,"PAH",1,1,52,0)
conjunction.  
"PKG",141,22,1,"PAH",1,1,53,0)
  
"PKG",141,22,1,"PAH",1,1,54,0)
Below is an example of a complex order being entered via Patient 
"PKG",141,22,1,"PAH",1,1,55,0)
Prescription
"PKG",141,22,1,"PAH",1,1,56,0)
Processing [PSO LM BACKDOOR ORDERS] 
"PKG",141,22,1,"PAH",1,1,57,0)
  
"PKG",141,22,1,"PAH",1,1,58,0)
    :       :
"PKG",141,22,1,"PAH",1,1,59,0)
  VERB: APPLY 
"PKG",141,22,1,"PAH",1,1,60,0)
  ROUTE: PO// PO   ORAL 
"PKG",141,22,1,"PAH",1,1,61,0)
  Schedule: QD (EVERY DAY) 
"PKG",141,22,1,"PAH",1,1,62,0)
     
"PKG",141,22,1,"PAH",1,1,63,0)
  LIMITED DURATION (IN DAYS, HOURS OR MINUTES): 
"PKG",141,22,1,"PAH",1,1,64,0)
  CONJUNCTION: THEN 
"PKG",141,22,1,"PAH",1,1,65,0)
   
"PKG",141,22,1,"PAH",1,1,66,0)
 Duration field required for the dosage entered prior to this THEN 
"PKG",141,22,1,"PAH",1,1,67,0)
 conjunction. 
"PKG",141,22,1,"PAH",1,1,68,0)
 
"PKG",141,22,1,"PAH",1,1,69,0)
  
"PKG",141,22,1,"PAH",1,1,70,0)
  LIMITED DURATION (IN DAYS, HOURS OR MINUTES): 
"PKG",141,22,1,"PAH",1,1,71,0)
    :       :
"PKG",141,22,1,"PAH",1,1,72,0)
 
"PKG",141,22,1,"PAH",1,1,73,0)
2. Titration/Maintenance Rx 
"PKG",141,22,1,"PAH",1,1,74,0)
===========================
"PKG",141,22,1,"PAH",1,1,75,0)
This Enhancement is related to PSI-06-176 and Remedy Ticket #168928.  
"PKG",141,22,1,"PAH",1,1,76,0)
 
"PKG",141,22,1,"PAH",1,1,77,0)
The Outpatient Pharmacy (OP) application was modified to accommodate 
"PKG",141,22,1,"PAH",1,1,78,0)
Titration/Maintenance prescription functionality. The existing software 
"PKG",141,22,1,"PAH",1,1,79,0)
presented patient safety risks when prescriptions dispensed with a 
"PKG",141,22,1,"PAH",1,1,80,0)
titrating dose followed by a maintenance dose were being copied, renewed
"PKG",141,22,1,"PAH",1,1,81,0)
or refilled. The issue was that refills as well as the new prescriptions
"PKG",141,22,1,"PAH",1,1,82,0)
(derived from copy, renewals or edits) automatically carried over the
"PKG",141,22,1,"PAH",1,1,83,0)
initial titrating dose into the new fill/prescription, which was not
"PKG",141,22,1,"PAH",1,1,84,0)
always the user's intention.  
"PKG",141,22,1,"PAH",1,1,85,0)
 
"PKG",141,22,1,"PAH",1,1,86,0)
The new functionality provides two steps for processing Titration/ 
"PKG",141,22,1,"PAH",1,1,87,0)
Maintenance prescriptions.
"PKG",141,22,1,"PAH",1,1,88,0)
 
"PKG",141,22,1,"PAH",1,1,89,0)
a. First, the user will have the ability to mark prescriptions as 
"PKG",141,22,1,"PAH",1,1,90,0)
   'Titration to Maintenance' when finishing prescriptions from CPRS as 
"PKG",141,22,1,"PAH",1,1,91,0)
   well as via the Patient Prescription Processing [PSO LM BACKDOOR 
"PKG",141,22,1,"PAH",1,1,92,0)
   ORDERS] option by invoking the new hidden action 'TM' - Mark Rx 
"PKG",141,22,1,"PAH",1,1,93,0)
   as Titration. This action will result in preventing the following 
"PKG",141,22,1,"PAH",1,1,94,0)
   actions to be taken on the prescription: Refill, Renewal (including 
"PKG",141,22,1,"PAH",1,1,95,0)
   via CPRS), Copy and editing of any field that requires a new Rx to be 
"PKG",141,22,1,"PAH",1,1,96,0)
   created. This action will also set the new field TITRATION RX FLAG 
"PKG",141,22,1,"PAH",1,1,97,0)
   (#45.3) in the PRESCRIPTION File (#52) as well as the new field 
"PKG",141,22,1,"PAH",1,1,98,0)
   TITRATION DOSE RX (#45.1) in the PRESCRIPTION File (#52).  
"PKG",141,22,1,"PAH",1,1,99,0)
   Prescriptions that are marked as Titration/Maintenance will 
"PKG",141,22,1,"PAH",1,1,100,0)
   have the letter 't' postfix to the RX # as seen below (entry #1): 
"PKG",141,22,1,"PAH",1,1,101,0)
 
"PKG",141,22,1,"PAH",1,1,102,0)
           :                   :                            :
"PKG",141,22,1,"PAH",1,1,103,0)
                                                   ISSUE  LAST REF DAY 
"PKG",141,22,1,"PAH",1,1,104,0)
   #  RX #       DRUG                       QTY ST  DATE  FILL REM SUP 
"PKG",141,22,1,"PAH",1,1,105,0)
  -------------------------------ACTIVE------------------------------- 
"PKG",141,22,1,"PAH",1,1,106,0)
   1 100005024t  AMOXAPINE 50MG TAB          30 S  09-26 09-26   2  30 
"PKG",141,22,1,"PAH",1,1,107,0)
   2 100005022   AMOXICILLIN 250MG CAP       30 A  08-18 08-18  11  30 
"PKG",141,22,1,"PAH",1,1,108,0)
   3 100005035   KALETRA                      3 A  09-29 09-29   0   3 
"PKG",141,22,1,"PAH",1,1,109,0)
           :                   :                            :
"PKG",141,22,1,"PAH",1,1,110,0)
 
"PKG",141,22,1,"PAH",1,1,111,0)
   Note: A prescription can be unmarked as Titration/Maintenance by 
"PKG",141,22,1,"PAH",1,1,112,0)
         invoking the same TM action on an already marked prescription.  
"PKG",141,22,1,"PAH",1,1,113,0)
 
"PKG",141,22,1,"PAH",1,1,114,0)
  
"PKG",141,22,1,"PAH",1,1,115,0)
b. A new hidden action is being introduced in the Patient Prescription 
"PKG",141,22,1,"PAH",1,1,116,0)
   Processing [LM BACKDOOR ORDERS] option called TR (Convert 
"PKG",141,22,1,"PAH",1,1,117,0)
   Titration Rx). This action will populate the new field MAINTENANCE 
"PKG",141,22,1,"PAH",1,1,118,0)
   DOSE RX (#45.2) in the PRESCRIPTION File (#52).  
"PKG",141,22,1,"PAH",1,1,119,0)
   When a titration to maintenance prescription needs to be 
"PKG",141,22,1,"PAH",1,1,120,0)
   refilled so the patient can continue on the Maintenance Dose 
"PKG",141,22,1,"PAH",1,1,121,0)
   this option will allow the users to create a new prescription with 
"PKG",141,22,1,"PAH",1,1,122,0)
   the maintenance dose only. The process works similar to copying an 
"PKG",141,22,1,"PAH",1,1,123,0)
   existing prescription, however it can only be used on prescriptions 
"PKG",141,22,1,"PAH",1,1,124,0)
   with the following characteristics: 
"PKG",141,22,1,"PAH",1,1,125,0)
   
"PKG",141,22,1,"PAH",1,1,126,0)
     - Rx is a complex order with a THEN conjunction
"PKG",141,22,1,"PAH",1,1,127,0)
     - Rx was not digitally signed
"PKG",141,22,1,"PAH",1,1,128,0)
     - Rx is released 
"PKG",141,22,1,"PAH",1,1,129,0)
     - Rx status is ACTIVE 
"PKG",141,22,1,"PAH",1,1,130,0)
     - Rx does not have refills previously ordered 
"PKG",141,22,1,"PAH",1,1,131,0)
     - Rx # Of Refills is greater than 0 (zero) 
"PKG",141,22,1,"PAH",1,1,132,0)
   
"PKG",141,22,1,"PAH",1,1,133,0)
   Before the new Maintenance Rx can be accepted the Pharmacist is 
"PKG",141,22,1,"PAH",1,1,134,0)
   prompted to validate the QTY field for the new Rx, which may or may not
"PKG",141,22,1,"PAH",1,1,135,0)
   be automatically re-calculated. Only the last dose from the original
"PKG",141,22,1,"PAH",1,1,136,0)
   prescription is carried over to the new Maintenance Rx and the # of 
"PKG",141,22,1,"PAH",1,1,137,0)
   Refills field is decreased by 1 because the new Maintenance Rx counts 
"PKG",141,22,1,"PAH",1,1,138,0)
   as a fill. The Fill Date for the new Maintenance prescription is 
"PKG",141,22,1,"PAH",1,1,139,0)
   automatically set with the next possible fill date from the existing
"PKG",141,22,1,"PAH",1,1,140,0)
   prescription, which can be changed by the pharmacist.
"PKG",141,22,1,"PAH",1,1,141,0)
   Once the pharmacist verifies the information for the Maintenance Rx is 
"PKG",141,22,1,"PAH",1,1,142,0)
   accurate they can accept the Maintenance Rx. This action will trigger 
"PKG",141,22,1,"PAH",1,1,143,0)
   a Duplicate Drug check against the original complex order, which must 
"PKG",141,22,1,"PAH",1,1,144,0)
   be discontinued before the new Maintenance Rx can be accepted. 
"PKG",141,22,1,"PAH",1,1,145,0)
   After the new Maintenance Rx is accepted it will have the new 
"PKG",141,22,1,"PAH",1,1,146,0)
   indicator 'm' on the right side of the Rx # in the patient's Medication
"PKG",141,22,1,"PAH",1,1,147,0)
   Profile as seen below (entry #1):
"PKG",141,22,1,"PAH",1,1,148,0)
 
"PKG",141,22,1,"PAH",1,1,149,0)
           :                   :                            :
"PKG",141,22,1,"PAH",1,1,150,0)
                                                   ISSUE  LAST REF DAY 
"PKG",141,22,1,"PAH",1,1,151,0)
   #  RX #       DRUG                       QTY ST  DATE  FILL REM SUP 
"PKG",141,22,1,"PAH",1,1,152,0)
  -------------------------------ACTIVE------------------------------- 
"PKG",141,22,1,"PAH",1,1,153,0)
   1 100005436m  AMOXAPINE 50MG TAB          30 S  09-26 09-26   1  30 
"PKG",141,22,1,"PAH",1,1,154,0)
   2 100005022   AMOXICILLIN 250MG CAP       30 A  08-18 08-18  11  30 
"PKG",141,22,1,"PAH",1,1,155,0)
   3 100005035   KALETRA                      3 A  09-29 09-29   0   3 
"PKG",141,22,1,"PAH",1,1,156,0)
           :                   :                            :
"PKG",141,22,1,"PAH",1,1,157,0)
 
"PKG",141,22,1,"PAH",1,1,158,0)
c. The new Titration/Maintenance indicator (t/m) will be included in the 
"PKG",141,22,1,"PAH",1,1,159,0)
   following menu options where the prescription number is displayed: 
"PKG",141,22,1,"PAH",1,1,160,0)
 
"PKG",141,22,1,"PAH",1,1,161,0)
   View Prescriptions                       [PSO VIEW] 
"PKG",141,22,1,"PAH",1,1,162,0)
   Patient Prescription Processing          [PSO LM BACKDOOR ORDERS]    
"PKG",141,22,1,"PAH",1,1,163,0)
   Complete Orders from OERR                [PSO LMOE FINISH] 
"PKG",141,22,1,"PAH",1,1,164,0)
   ePharmacy Medication Profile (View Only) [PSO PMP] 
"PKG",141,22,1,"PAH",1,1,165,0)
   Medication Profile                       [PSO P] 
"PKG",141,22,1,"PAH",1,1,166,0)
  
"PKG",141,22,1,"PAH",1,1,167,0)
d. External refill requests such as from AudioFax and Internet will not 
"PKG",141,22,1,"PAH",1,1,168,0)
   be processed for Titration/Maintenance marked prescriptions. 
"PKG",141,22,1,"PAH",1,1,169,0)
 
"PKG",141,22,1,"PAH",1,1,170,0)
   Subj: ALBANY External Application Refills: Not processed List  
"PKG",141,22,1,"PAH",1,1,171,0)
         [#101509] 01/28/09@13:52  11 lines
"PKG",141,22,1,"PAH",1,1,172,0)
   From: POSTMASTER  In 'IN' basket.   Page 1 
"PKG",141,22,1,"PAH",1,1,173,0)
   
"PKG",141,22,1,"PAH",1,1,174,0)
-------------------------------------------------------------------------
"PKG",141,22,1,"PAH",1,1,175,0)
   Refills Not Processed Report for the ALBANY Division.  
"PKG",141,22,1,"PAH",1,1,176,0)
 
"PKG",141,22,1,"PAH",1,1,177,0)
   The following refill requests were not processed:  
"PKG",141,22,1,"PAH",1,1,178,0)
 
"PKG",141,22,1,"PAH",1,1,179,0)
   Patient: OPPATIENT,TWO (9999) 
"PKG",141,22,1,"PAH",1,1,180,0)
 
"PKG",141,22,1,"PAH",1,1,181,0)
     Rx #: 100005122  (REF #1)  Qty: 55 
"PKG",141,22,1,"PAH",1,1,182,0)
     Drug: ZINC SULFATE 66MG TAB 
"PKG",141,22,1,"PAH",1,1,183,0)
     Reason: 'Titration/Maintenance Rx' cannot be refilled.  
"PKG",141,22,1,"PAH",1,1,184,0)
 
"PKG",141,22,1,"PAH",1,1,185,0)
e. CPRS refill requests will not be automatically processed for
"PKG",141,22,1,"PAH",1,1,186,0)
   Titration/Maintenance marked prescriptions. The refill request will
"PKG",141,22,1,"PAH",1,1,187,0)
   remain in the patient's Medication Profile as PENDING and the mailman
"PKG",141,22,1,"PAH",1,1,188,0)
   message above (item d) will also be sent to PSOAUTRF security key
"PKG",141,22,1,"PAH",1,1,189,0)
   holders.  
"PKG",141,22,1,"PAH",1,1,190,0)
  
"PKG",141,22,1,"PAH",1,1,191,0)
f. The activity logs for both Titration and Maintenance Rx's will record 
"PKG",141,22,1,"PAH",1,1,192,0)
   the corresponding Titration and Maintenance Rx # if they exist as seen 
"PKG",141,22,1,"PAH",1,1,193,0)
   below: 
"PKG",141,22,1,"PAH",1,1,194,0)
  
"PKG",141,22,1,"PAH",1,1,195,0)
Titration Rx: 
"PKG",141,22,1,"PAH",1,1,196,0)
------------
"PKG",141,22,1,"PAH",1,1,197,0)
#   Date        Reason         Rx Ref         Initiator of Activity  
"PKG",141,22,1,"PAH",1,1,198,0)
====================================================================== 
"PKG",141,22,1,"PAH",1,1,199,0)
1   09/29/08    EDIT           ORIGINAL       OPUSER,ONE Comments: 
"PKG",141,22,1,"PAH",1,1,200,0)
Maintenance
"PKG",141,22,1,"PAH",1,1,201,0)
Dose Rx: 100005130 
"PKG",141,22,1,"PAH",1,1,202,0)
 
"PKG",141,22,1,"PAH",1,1,203,0)
 
"PKG",141,22,1,"PAH",1,1,204,0)
Maintenance Rx: 
"PKG",141,22,1,"PAH",1,1,205,0)
--------------
"PKG",141,22,1,"PAH",1,1,206,0)
#   Date        Reason         Rx Ref         Initiator of Activity  
"PKG",141,22,1,"PAH",1,1,207,0)
====================================================================== 
"PKG",141,22,1,"PAH",1,1,208,0)
1   09/29/08    EDIT           ORIGINAL       OPUSER,TWO Comments: 
"PKG",141,22,1,"PAH",1,1,209,0)
Titration Dose Rx: 100005392
"PKG",141,22,1,"PAH",1,1,210,0)
    
"PKG",141,22,1,"PAH",1,1,211,0)
 
"PKG",141,22,1,"PAH",1,1,212,0)
g. The VistA Integration Control Registration (ICR) #2398 provided to 
"PKG",141,22,1,"PAH",1,1,213,0)
   Computerized Patient Record System V. 1.0 (CPRS) was modified to 
"PKG",141,22,1,"PAH",1,1,214,0)
   prevent the renewal of a Titration dose order with the following 
"PKG",141,22,1,"PAH",1,1,215,0)
   message: 
"PKG",141,22,1,"PAH",1,1,216,0)
 
"PKG",141,22,1,"PAH",1,1,217,0)
  "Prescription was marked as Titration to Maintenance Dose  by Pharmacy 
"PKG",141,22,1,"PAH",1,1,218,0)
  and cannot be renewed. To repeat the titration, enter a new prescription
"PKG",141,22,1,"PAH",1,1,219,0)
  or copy the prior titration order. To continue the maintenance dose, 
"PKG",141,22,1,"PAH",1,1,220,0)
  refill this prescription if refills are available or enter a new
"PKG",141,22,1,"PAH",1,1,221,0)
  prescription for the maintenance dose."
"PKG",141,22,1,"PAH",1,1,222,0)
 
"PKG",141,22,1,"PAH",1,1,223,0)
 
"PKG",141,22,1,"PAH",1,1,224,0)
h. When using the Barcode Batch Prescription Entry option 
"PKG",141,22,1,"PAH",1,1,225,0)
   [PSO BATCH BARCODE], if the prescription has been marked 
"PKG",141,22,1,"PAH",1,1,226,0)
   as a Titration/Maintenance Rx, and the user attempts to 
"PKG",141,22,1,"PAH",1,1,227,0)
   renew or refill the prescription, the following message 
"PKG",141,22,1,"PAH",1,1,228,0)
   will display: 
"PKG",141,22,1,"PAH",1,1,229,0)
 
"PKG",141,22,1,"PAH",1,1,230,0)
   For a renewal: 
"PKG",141,22,1,"PAH",1,1,231,0)
   "Rx# XXXXXX is marked as Titration Rx and cannot be renewed." 
"PKG",141,22,1,"PAH",1,1,232,0)
 
"PKG",141,22,1,"PAH",1,1,233,0)
   For a refill: 
"PKG",141,22,1,"PAH",1,1,234,0)
   "Rx# XXXXXX is marked as Titration Rx and cannot be refilled." 
"PKG",141,22,1,"PAH",1,1,235,0)
 
"PKG",141,22,1,"PAH",1,1,236,0)
 
"PKG",141,22,1,"PAH",1,1,237,0)
i. The PSO HIDDEN ACTIONS Protocol in the PROTOCOL File (#101) 
"PKG",141,22,1,"PAH",1,1,238,0)
   will be modified to include the two new Hidden Actions 
"PKG",141,22,1,"PAH",1,1,239,0)
   introduced by this enhancement.  PSO LM BACKDOOR MARK AS 
"PKG",141,22,1,"PAH",1,1,240,0)
   TITRATION and PSO LM BACKDOOR TITRATION RX REFILL are both 
"PKG",141,22,1,"PAH",1,1,241,0)
   new protocols added to the PROTOCOL File (#101). 
"PKG",141,22,1,"PAH",1,1,242,0)
 
"PKG",141,22,1,"PAH",1,1,243,0)
 
"PKG",141,22,1,"PAH",1,1,244,0)
 
"PKG",141,22,1,"PAH",1,1,245,0)
 ******************************  IMPORTANT  ******************************
"PKG",141,22,1,"PAH",1,1,246,0)
 The enhancements related to Titration/Maintenance dose Rx are made only 
"PKG",141,22,1,"PAH",1,1,247,0)
 for Outpatient Pharmacy package. The corresponding changes to CPRS 
"PKG",141,22,1,"PAH",1,1,248,0)
 package are not included at this time. Therefore, the CPRS Order Copy and
"PKG",141,22,1,"PAH",1,1,249,0)
 Order Change functionalities will continue to function as is. 
"PKG",141,22,1,"PAH",1,1,250,0)
 Furthermore, there will be no indication of a Titration/Maintenance order
"PKG",141,22,1,"PAH",1,1,251,0)
 in the CPRS application.
"PKG",141,22,1,"PAH",1,1,252,0)
 *************************************************************************
"PKG",141,22,1,"PAH",1,1,253,0)
 
"PKG",141,22,1,"PAH",1,1,254,0)
3. Remedy Ticket #1022059 
"PKG",141,22,1,"PAH",1,1,255,0)
   This patch fixes an issue that could create duplicate prescriptions on 
"PKG",141,22,1,"PAH",1,1,256,0)
   a patient profile. When a complex order is copied and the duration 
"PKG",141,22,1,"PAH",1,1,257,0)
   field is edited, upon accepting the order, the message to discontinue
"PKG",141,22,1,"PAH",1,1,258,0)
   the original order is not triggered. This causes duplicate 
"PKG",141,22,1,"PAH",1,1,259,0)
   prescriptions to appear on the patient profile. This patch corrects
"PKG",141,22,1,"PAH",1,1,260,0)
   this problem by prompting the user to discontinue the original order.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
33
"RTN","PSOATRF")
0^57^B82128020^B79340036
"RTN","PSOATRF",1,0)
PSOATRF ;BIR/MHA - Automate Internet Refill ;07/09/07
"RTN","PSOATRF",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**264,322,388,313**;DEC 1997;Build 76
"RTN","PSOATRF",3,0)
 ;Reference to ^PSSLOCK supported by DBIA 2789
"RTN","PSOATRF",4,0)
 ;Reference ^PSDRUG supported by DBIA 221
"RTN","PSOATRF",5,0)
 ;Reference ^PS(55 supported by DBIA 2228
"RTN","PSOATRF",6,0)
 ;
"RTN","PSOATRF",7,0)
START ;
"RTN","PSOATRF",8,0)
 N PSOTITFL
"RTN","PSOATRF",9,0)
 S PSOITMG="",U="^",PSOITNS="PSOATRF"  S:'$G(DT) DT=$$DT^XLFDT
"RTN","PSOATRF",10,0)
 I '$D(^PS(52.43,"AINST")) S PSOITMG="There are no internet refills to process." G END
"RTN","PSOATRF",11,0)
 S (SITE,DA)=$P(^XMB(1,1,"XUS"),U,17),DIC="4",DIQ(0)="IE",DR=".01;99",DIQ="PSOUTIL" D EN^DIQ1
"RTN","PSOATRF",12,0)
 S PSOINST=$G(PSOUTIL(4,SITE,99,"I"))
"RTN","PSOATRF",13,0)
 I PSOINST']"" S PSOITMG="The Institution "_SITE_" is not defined in the INSTITUTION file (#4)." G END
"RTN","PSOATRF",14,0)
 S PSXSYS=+$O(^PSX(550,"C",""))_"^"_$G(PSOINST)_"^"_$G(PSOUTIL(4,SITE,.01,"E"))
"RTN","PSOATRF",15,0)
 K SITE,DA,PSOUTIL,DIQ
"RTN","PSOATRF",16,0)
 I $G(PSXSYS) D
"RTN","PSOATRF",17,0)
 . K:($P($G(^PSX(550,+PSXSYS,0)),"^",2)'="A") PSXSYS
"RTN","PSOATRF",18,0)
 . I $$VERSION^XPDUTL("PSO")<7.0 K PSXSYS
"RTN","PSOATRF",19,0)
 I '$O(^XUSEC("PSOAUTRF","")) S PSOITMG="There are no users with PSOAUTRF key, at least one should have this key." G END
"RTN","PSOATRF",20,0)
 I '$D(^PS(52.43,"AINST",PSOINST)) S PSOITMG="There are no internet refills to process for Institution "_PSOINST G END
"RTN","PSOATRF",21,0)
 L +^XTMP(PSOITNS):3 E  S PSOITMG="Automate Internet Refill job is currently running - Try later." G END
"RTN","PSOATRF",22,0)
 K ^XTMP(PSOITNS,$J)
"RTN","PSOATRF",23,0)
 S PSOSYS=$G(^PS(59.7,1,40.1))
"RTN","PSOATRF",24,0)
 S (I,J,PSOITDD)=0 F  S I=$O(^PS(59,I)) Q:'I  I '$P($G(^PS(59,I,"I")),U)!(DT<$P($G(^("I")),U)) S J=J+1 D  G:PSOITMG]"" END
"RTN","PSOATRF",25,0)
 . S PSOSITE(I)=I,PSOSNM(I)=$P(^PS(59,I,0),U),PSORFN(I)=$G(^PS(59,I,"RF")),PSOPAR(I)=$G(^PS(59,I,1)),PSOPRPAS(I)=$P($G(PSOPAR),U,7)
"RTN","PSOATRF",26,0)
 . S PSOPAR7(I)=$G(^PS(59,I,"IB")),PSOPINST(I)=$P($G(^PS(59,I,"INI")),U)
"RTN","PSOATRF",27,0)
 . I J=1 D SDIV S PSOITDD=I
"RTN","PSOATRF",28,0)
 I 'J S PSOITMG="There are no active divisions in File #(59) - At least one division should be active - None processed." G END
"RTN","PSOATRF",29,0)
 D PRORF
"RTN","PSOATRF",30,0)
END ;
"RTN","PSOATRF",31,0)
 I $D(^XTMP(PSOITNS,$J)) D SMAIL^PSOATRF1 G:'$G(PSOITC) KV
"RTN","PSOATRF",32,0)
 S PSOITMG(1)=$S($G(PSOITC):"Total internet refills processed = "_PSOITC,PSOITMG="":"There are no internet refills to process.",1:PSOITMG)
"RTN","PSOATRF",33,0)
 D GRP
"RTN","PSOATRF",34,0)
 S:'$O(XMY(0)) XMY(DUZ)=""
"RTN","PSOATRF",35,0)
 S XMDUZ=.5,XMSUB="Outpatient Pharmacy - PSO AUTO REFILL"
"RTN","PSOATRF",36,0)
 S XMTEXT="PSOITMG(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOATRF",37,0)
KV ;
"RTN","PSOATRF",38,0)
 L -^XTMP(PSOITNS) K ^XTMP(PSOITNS)
"RTN","PSOATRF",39,0)
 K DFN,PSODFN,PSODTCUT,PSOITMG,PSOITNF,PSOITNS,PSOITC,PSOITDD,PSOITF,PSOITP,PSOITR
"RTN","PSOATRF",40,0)
 K PSOINST,PSOPAR,PSOPINST,PSOPRPAS,PSOPAR7,PSOPTPST,PSOSITE,PSOSNM,PSOSYS,PSORFN
"RTN","PSOATRF",41,0)
 K DRG,DIVN,PSXSYS,RX,RX0,RXN,VA,ZZ,LC,PSOS,XMY,PSOREA,PSOSTAT,PSOD
"RTN","PSOATRF",42,0)
 Q
"RTN","PSOATRF",43,0)
 ;
"RTN","PSOATRF",44,0)
PRORF ;
"RTN","PSOATRF",45,0)
 S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X
"RTN","PSOATRF",46,0)
 S PSOITR="",PSOITC=0
"RTN","PSOATRF",47,0)
 F  S PSOITR=$O(^PS(52.43,"AINST",PSOINST,PSOITR)) Q:'PSOITR  D  D:PSOITMG]"" FILE D ULK
"RTN","PSOATRF",48,0)
 . S (PSOITF,PSOITNF,PSOTITFL)=0,PSOITMG="",PSOITRX=+PSOITR,PSOITP=$O(^PS(52.43,"AINST",PSOINST,PSOITRX,""))
"RTN","PSOATRF",49,0)
 . Q:'PSOITP
"RTN","PSOATRF",50,0)
 . I '$D(^PS(52.43,PSOITP))!($P(^(PSOITP,0),U,5)'="") K ^PS(52.43,"AINST",PSOINST,PSOITRX,PSOITP) Q
"RTN","PSOATRF",51,0)
 . I '$D(^PSRX(PSOITRX,0))!($P(^(0),U)="")!('$D(^(2)))!($P(^("STA"),U)=13) S PSOITNF=1,PSOITMG="Rx IEN "_PSOITRX_" not in file (#52)/Incomplete/Deleted" Q
"RTN","PSOATRF",52,0)
 . D PSOL^PSSLOCK(PSOITRX) I '$G(PSOMSG) K PSOMSG Q
"RTN","PSOATRF",53,0)
 . K PSOMSG
"RTN","PSOATRF",54,0)
 . S PSOITRX0=^PSRX(PSOITRX,0),PSOITRX2=^(2),PSOITRX3=^(3),PSOITRXS=^("STA")
"RTN","PSOATRF",55,0)
 . S (DFN,PSODFN)=$P(PSOITRX0,U,2),RXN=$P(PSOITRX0,U),DRG=$P(PSOITRX0,U,6)
"RTN","PSOATRF",56,0)
 . I PSODFN'=$P(^PS(52.43,PSOITP,0),U,9) D  Q
"RTN","PSOATRF",57,0)
 . . S PSOITNF=1,PSOITMG="Can't refill Rx # "_RXN_", it is not for this patient. DFN in file #52="_DFN_", DFN in file #52.43="_$P(^PS(52.43,PSOITP,0),U,9)
"RTN","PSOATRF",58,0)
 . D GET^PSOPTPST
"RTN","PSOATRF",59,0)
 . I $G(PSOPTPST(2,PSODFN,.351))]"" S PSOITNF=1,PSOITMG="Patient Died on "_PSOPTPST(2,PSODFN,.351) Q
"RTN","PSOATRF",60,0)
 . D ICN^PSODPT(DFN)
"RTN","PSOATRF",61,0)
 . S PSOLOUD=1 D:$P($G(^PS(55,DFN,0)),U,6)'=2 EN^PSOHLUP(DFN) K PSOLOUD
"RTN","PSOATRF",62,0)
 . I '$P(PSOPAR,U,11),$G(^PSDRUG(DRG,"I"))]"",DT>$G(^("I")) D  Q
"RTN","PSOATRF",63,0)
 . . S PSOITNF=1,PSOITMG="Drug is inactive for Rx # "_RXN_" cannot be refilled"
"RTN","PSOATRF",64,0)
 . S I=$P(^PSRX(PSOITRX,2),U,9) S:'I I=PSOITDD D SDIV
"RTN","PSOATRF",65,0)
 . ;
"RTN","PSOATRF",66,0)
 . I $G(PSOBDIV) D  Q
"RTN","PSOATRF",67,0)
 . . S PSOITNF=1
"RTN","PSOATRF",68,0)
 . . S PSOITMG="Inactive division for Rx # "_RXN_".  Cannot refill."
"RTN","PSOATRF",69,0)
 . . K PSOBDIV
"RTN","PSOATRF",70,0)
 . ;
"RTN","PSOATRF",71,0)
 . I $G(PSOPTPST(2,PSODFN,.1))]"",'PSORFN S PSOITNF=1,PSOITMG="Patient is an Inpatient on Ward "_PSOPTPST(2,PSODFN,.1) Q
"RTN","PSOATRF",72,0)
 . I $G(PSOPTPST(2,PSODFN,148))="YES",'$P(PSORFN,U,2) S PSOITNF=1,PSOITMG="Patient is in a Contract Nursing Home" Q
"RTN","PSOATRF",73,0)
 . D CHKRF Q:PSOITNF
"RTN","PSOATRF",74,0)
 . I $O(^PS(52.5,"B",PSOITRX,0)),'$G(^PS(52.5,+$O(^PS(52.5,"B",PSOITRX,0)),"P")) S PSOITNF=1,PSOITMG="Rx is in suspense and cannot be refilled" Q
"RTN","PSOATRF",75,0)
 . S PSOY=1+$$LSTRFL^PSOBPSU1(PSOITRX)
"RTN","PSOATRF",76,0)
 . I PSOY>$P(PSOITRX0,U,9) S PSOITNF=1,PSOITMG="Can't refill, no refills remaining" Q
"RTN","PSOATRF",77,0)
 . S (PSOITF,PSOX("NUMBER"))=PSOY
"RTN","PSOATRF",78,0)
 . S PSOX("RX0")=PSOITRX0,PSOX("RX2")=PSOITRX2,PSOX("RX3")=PSOITRX3,PSOX("STA")=PSOITRXS
"RTN","PSOATRF",79,0)
 . S DRG=$P(PSOITRX0,U,6)
"RTN","PSOATRF",80,0)
 . N PSODEA,PSODAY,PSOCHECK
"RTN","PSOATRF",81,0)
 . S PSODEA=$P($G(^PSDRUG(DRG,0)),U,3)
"RTN","PSOATRF",82,0)
 . S PSODAY=$P(PSOITRX0,U,8)
"RTN","PSOATRF",83,0)
 . S PSOCHECK=$$DEACHK^PSOUTLA1(PSOITRX,PSODEA,PSODAY)
"RTN","PSOATRF",84,0)
 . I PSOCHECK S PSOITNF=1 D  Q
"RTN","PSOATRF",85,0)
 . . I PSOCHECK=1 S PSOITMG="Requested refill exceeds maximum allowable days supply for Rx." Q  ;*388
"RTN","PSOATRF",86,0)
 . . S PSOITMG="Current drug DEA/SPECIAL HANDLING code does not allow refills."  ;*388
"RTN","PSOATRF",87,0)
 . D CHKDT Q:PSOITNF
"RTN","PSOATRF",88,0)
 . I $$TITRX^PSOUTL(PSOITRX)="t" D  Q
"RTN","PSOATRF",89,0)
 . . S PSOITNF=1,PSOITMG="'Titration Rx' cannot be refilled."
"RTN","PSOATRF",90,0)
 . . S PSOTITFL=1 D FILE
"RTN","PSOATRF",91,0)
 . D EN^PSOR52(.PSOX) I PSOITF,$D(^PSRX(PSOITRX,1,PSOITF,0)) S PSOITC=PSOITC+1,PSOITMG=PSOITF_" Susp. until "_$$DSP($P(^(0),U))
"RTN","PSOATRF",92,0)
 Q
"RTN","PSOATRF",93,0)
 ;
"RTN","PSOATRF",94,0)
CHKRF ;
"RTN","PSOATRF",95,0)
 D ^PSOBUILD
"RTN","PSOATRF",96,0)
 I '$G(PSOSD) S PSOITNF=1,PSOITMG="This patient has no prescriptions" Q
"RTN","PSOATRF",97,0)
 S (PSOX,PSOY,PSOS)="",PSOX("STA")=PSOITRXS
"RTN","PSOATRF",98,0)
 F  S PSOS=$O(PSOSD(PSOS)) Q:PSOS=""  F  S PSOX=$O(PSOSD(PSOS,PSOX)) Q:PSOX']""  D
"RTN","PSOATRF",99,0)
 . I PSOITRX=+PSOSD(PSOS,PSOX) S PSOY=PSOSD(PSOS,PSOX) I $P(PSOY,U,4)]"" D
"RTN","PSOATRF",100,0)
 . . S PSOITNF=1,PSOITMG="Cannot refill Rx # "_RXN
"RTN","PSOATRF",101,0)
 . . S PSOREA=$P(PSOY,U,4),PSOSTAT=PSOX("STA")
"RTN","PSOATRF",102,0)
 . . I PSOREA["Z" S:PSOSTAT=4 PSOSTAT=1 D  Q
"RTN","PSOATRF",103,0)
 . . . S PSOA=";"_PSOSTAT
"RTN","PSOATRF",104,0)
 . . . D STATUS^PSODI(52,100,"PSOB")
"RTN","PSOATRF",105,0)
 . . . S PSOA=$F(PSOB("POINTER"),PSOA)
"RTN","PSOATRF",106,0)
 . . . S PSOA=$P($E(PSOB("POINTER"),PSOA,999),";",1)
"RTN","PSOATRF",107,0)
 . . . S PSOITMG=PSOITMG_" Rx is in "_$P(PSOA,":",2)_" status"
"RTN","PSOATRF",108,0)
 . . . K PSOA,PSOB
"RTN","PSOATRF",109,0)
 . . I PSOREA["M" S PSOITMG=PSOITMG_" Drug no longer used by Outpatient Pharmacy" Q
"RTN","PSOATRF",110,0)
 . . I PSOREA["B" S PSOITMG=PSOITMG_" Narcotic Drug" Q
"RTN","PSOATRF",111,0)
 . . I PSOREA["C" S PSOITMG=PSOITMG_" Non-Renewable Drug" Q
"RTN","PSOATRF",112,0)
 . . I PSOREA["D" S PSOITMG=PSOITMG_" Non-Renewable Patient Status" Q
"RTN","PSOATRF",113,0)
 . . I PSOREA["E" S PSOITMG=PSOITMG_" Non-Verified Rx" Q
"RTN","PSOATRF",114,0)
 . . I PSOREA["G",PSOREA'["B" S PSOITMG=PSOITMG_" No more refills left"
"RTN","PSOATRF",115,0)
 I PSOY="" S PSOITNF=1,PSOITMG="Cannot refill, Rx is DC/Exp. Later Rx may exist " D
"RTN","PSOATRF",116,0)
 . S (PSOS,PSOX)="",PSOD=$P(^PSDRUG($P(PSOITRX0,U,6),0),U)
"RTN","PSOATRF",117,0)
 . N ZRX S ZRX="" F  S PSOS=$O(PSOSD(PSOS)) Q:PSOS=""  F  S PSOX=$O(PSOSD(PSOS,PSOX)) Q:PSOX']""  I PSOD=PSOX,+PSOSD(PSOS,PSOX) S ZRX=$P($G(^PSRX(+PSOSD(PSOS,PSOX),0)),U)
"RTN","PSOATRF",118,0)
 . S PSOITMG=PSOITMG_ZRX
"RTN","PSOATRF",119,0)
 Q
"RTN","PSOATRF",120,0)
  ;
"RTN","PSOATRF",121,0)
FILE ;
"RTN","PSOATRF",122,0)
 K DIE S DA=PSOITP
"RTN","PSOATRF",123,0)
 S DIE="^PS(52.43,",DR="5////"_DT_";6///"_$S(PSOITNF&'$G(PSOTITFL):"NOT ",1:"")_"FILLED;10////"_PSOITMG D ^DIE
"RTN","PSOATRF",124,0)
 K ^PS(52.43,"AINST",PSOINST,PSOITRX,DA) I PSOITNF  S ^XTMP(PSOITNS,$J,PSOSITE,DFN,PSOITRX)=PSOITMG
"RTN","PSOATRF",125,0)
 Q
"RTN","PSOATRF",126,0)
 ;
"RTN","PSOATRF",127,0)
GRP ;
"RTN","PSOATRF",128,0)
 S MDUZ=0
"RTN","PSOATRF",129,0)
 I '$D(^XUSEC("PSOAUTRF")) D  Q
"RTN","PSOATRF",130,0)
 . F  S MDUZ=$O(^XUSEC("PSORPH",MDUZ)) Q:MDUZ'>0  S XMY(MDUZ)=""
"RTN","PSOATRF",131,0)
 F  S MDUZ=$O(^XUSEC("PSOAUTRF",MDUZ)) Q:MDUZ'>0  S XMY(MDUZ)=""
"RTN","PSOATRF",132,0)
 K MDUZ Q
"RTN","PSOATRF",133,0)
 ;
"RTN","PSOATRF",134,0)
ULK ;
"RTN","PSOATRF",135,0)
 I '$G(PSOITRX) Q
"RTN","PSOATRF",136,0)
 D PSOUL^PSSLOCK(PSOITRX)
"RTN","PSOATRF",137,0)
 K PSOITRX,PSOSD,PSOX,PSORX,PSOITRX0,PSOITRX2,PSOITRX3,PSOITRXS
"RTN","PSOATRF",138,0)
 Q
"RTN","PSOATRF",139,0)
SETUP ;
"RTN","PSOATRF",140,0)
 I '$D(^XUSEC("PSOAUTRF",DUZ)) W !,"You must hold the PSOAUTRF key to run this option!" Q
"RTN","PSOATRF",141,0)
 N PATCH,JOBN
"RTN","PSOATRF",142,0)
 S JOBN="PSO AUTO REFILL"
"RTN","PSOATRF",143,0)
 L +^XTMP("PSOATRF"):5 I '$T D  Q
"RTN","PSOATRF",144,0)
 .D BMES^XPDUTL("The Refill Automation job is currently running, try later.")
"RTN","PSOATRF",145,0)
 .D MES^XPDUTL("")
"RTN","PSOATRF",146,0)
 .S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSOATRF",147,0)
 K %DT,DIC,DTOUT S DIC(0)="XZM",DIC="^DIC(19.2,",X="PSO AUTO REFILL" D ^DIC
"RTN","PSOATRF",148,0)
 I +Y>0 D EDIT^XUTMOPT("PSO AUTO REFILL") G EX
"RTN","PSOATRF",149,0)
 D RESCH^XUTMOPT("PSO AUTO REFILL","","","24H","L"),EDIT^XUTMOPT("PSO AUTO REFILL") K DIC,Y,X
"RTN","PSOATRF",150,0)
EX ;
"RTN","PSOATRF",151,0)
 L -^XTMP("PSOATRF") K Y,C,D,D0,DI,DQ,DA,DIE,DR,DIC,X
"RTN","PSOATRF",152,0)
 Q
"RTN","PSOATRF",153,0)
 ;
"RTN","PSOATRF",154,0)
SDIV ;
"RTN","PSOATRF",155,0)
 S PSOSITE=$G(PSOSITE(I)) I 'PSOSITE S PSOSITE=I,PSOBDIV=1 Q
"RTN","PSOATRF",156,0)
 S PSOPAR=PSOPAR(I),PSOPRPAS=PSOPRPAS(I),PSORFN=PSORFN(I)
"RTN","PSOATRF",157,0)
 S PSOPAR7=PSOPAR7(I),PSOPINST=PSOPINST(I)
"RTN","PSOATRF",158,0)
 Q
"RTN","PSOATRF",159,0)
 ;
"RTN","PSOATRF",160,0)
CHKDT ;
"RTN","PSOATRF",161,0)
 S PSOX("IRXN")=PSOITRX
"RTN","PSOATRF",162,0)
 S PSOX("MAIL/WINDOW")="M",PSOX("FLD")=2,PSOX("QS")="S"
"RTN","PSOATRF",163,0)
 S PSOX("FIELD")=0,(PSORX("FILL DATE"),PSOX("FILL DATE"))=DT,PSOX("FLD")=1,X1=DT,X2=-180
"RTN","PSOATRF",164,0)
 D C^%DTC S PSOX("ISSUE DATE")=X,PSOX("CLERK CODE")=DUZ
"RTN","PSOATRF",165,0)
 S PSOX("STOP DATE")=$P(PSOITRX2,U,6) D NEXT
"RTN","PSOATRF",166,0)
 I PSOX("FILL DATE")<$P(PSOITRX3,U,2) D SUSDATE^PSOUTIL(.PSOX)
"RTN","PSOATRF",167,0)
 I PSOX("FILL DATE")>PSOX("STOP DATE") S PSOITNF=1 D  Q
"RTN","PSOATRF",168,0)
 .S PSOITMG="Can't refill, Refill Date "_$$DSP(PSOX("FILL DATE"))
"RTN","PSOATRF",169,0)
 .S PSOITMG=PSOITMG_" is past Expiration Date "_$$DSP(PSOX("STOP DATE"))
"RTN","PSOATRF",170,0)
 S PSOX("LAST REFILL DATE")=$P(PSOITRX3,U,1)
"RTN","PSOATRF",171,0)
 I PSOX("LAST REFILL DATE"),PSOX("FILL DATE")=PSOX("LAST REFILL DATE") S PSOITNF=1 D  Q
"RTN","PSOATRF",172,0)
 .S PSOITMG="Can't refill, Fill Date already exists for "_$$DSP(PSOX("FILL DATE"))
"RTN","PSOATRF",173,0)
 I PSOX("LAST REFILL DATE"),PSOX("FILL DATE")<PSOX("LAST REFILL DATE") S PSOITNF=1 D  Q
"RTN","PSOATRF",174,0)
 .S PSOITMG="Can't refill, later Refill Date already exists for "_$$DSP(PSOX("LAST REFILL DATE"))
"RTN","PSOATRF",175,0)
 Q
"RTN","PSOATRF",176,0)
 ;
"RTN","PSOATRF",177,0)
NEXT ;
"RTN","PSOATRF",178,0)
 S PSOX1=$P(PSOITRX2,U,2)
"RTN","PSOATRF",179,0)
 I '$O(^PSRX(PSOITRX,1,0)) D  Q
"RTN","PSOATRF",180,0)
 . S $P(PSOITRX3,U)=PSOX1,X1=PSOX1
"RTN","PSOATRF",181,0)
 . S X2=$P(PSOITRX0,U,8)-10\1
"RTN","PSOATRF",182,0)
 . D C^%DTC
"RTN","PSOATRF",183,0)
 . S:'$P(PSOITRX3,U,8) $P(PSOITRX3,U,2)=X K X
"RTN","PSOATRF",184,0)
 S PSOY2=0
"RTN","PSOATRF",185,0)
 F PSOY=0:0 S PSOY=$O(^PSRX(PSOITRX,1,PSOY)) Q:'PSOY  S PSOY1=PSOY,PSOY2=PSOY2+1
"RTN","PSOATRF",186,0)
 S PSOY=^PSRX(PSOITRX,1,PSOY1,0)
"RTN","PSOATRF",187,0)
 S PSOX2=$P(PSOY,U)
"RTN","PSOATRF",188,0)
 S $P(PSOITRX3,U)=PSOX2,X1=PSOX2
"RTN","PSOATRF",189,0)
 S X2=$P(PSOITRX0,U,8)-10\1
"RTN","PSOATRF",190,0)
 D C^%DTC S PSOY3=X
"RTN","PSOATRF",191,0)
 S X1=PSOX1,X2=(PSOY2+1)*$P(PSOITRX0,U,8)-10\1
"RTN","PSOATRF",192,0)
 D C^%DTC S PSOY4=X
"RTN","PSOATRF",193,0)
 S $P(PSOITRX3,U,2)=$S(PSOY3<PSOY4:PSOY4,1:PSOY3)
"RTN","PSOATRF",194,0)
 K X,PSOX1,PSOX2,PSOY,PSOY1,PSOY2,PSOY3,PSOY4
"RTN","PSOATRF",195,0)
 Q
"RTN","PSOATRF",196,0)
 ;
"RTN","PSOATRF",197,0)
DSP(X) ;
"RTN","PSOATRF",198,0)
 Q:'X ""
"RTN","PSOATRF",199,0)
 Q $E(X,4,5)_"/"_$E(X,6,7)_"/"_$E(X,2,3)
"RTN","PSOATRF",200,0)
 ; 
"RTN","PSOATRFC")
0^58^B47253705^B45655839
"RTN","PSOATRFC",1,0)
PSOATRFC ;BIR/MHA - Automate CPRS Refill request ;8/18/08 12:54pm
"RTN","PSOATRFC",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**305,388,313**;DEC 1997;Build 76
"RTN","PSOATRFC",3,0)
 ;Reference to ^PSSLOCK supported by DBIA 2789
"RTN","PSOATRFC",4,0)
 ;Reference ^PSDRUG supported by DBIA 221
"RTN","PSOATRFC",5,0)
 ;Reference ^PS(55 supported by DBIA 2228
"RTN","PSOATRFC",6,0)
 ;
"RTN","PSOATRFC",7,0)
REF(PSORXN,PSOITMG) ;process refill request
"RTN","PSOATRFC",8,0)
 N DFN,PSODFN,PSODTCUT,PSOITNS,PSOITDD,PSOITNF,PSOITF,DIV
"RTN","PSOATRFC",9,0)
 N PSOITP,PSOITR,PSOINST,PSOPAR,PSOPINST,PSOPRPAS,PSOPAR7,PSOPTPST
"RTN","PSOATRFC",10,0)
 N PSOSITE,PSOSNM,PSOSYS,PSORFN,PSOREA,PSOSTAT,PSOD,PSOS,DRG,DIVN
"RTN","PSOATRFC",11,0)
 N PSXSYS,RX,RX0,RXN,VA,ZZ,LC,XMY,PSORXN0,PSORXN2,PSORXN3,PSORXNS
"RTN","PSOATRFC",12,0)
 ;
"RTN","PSOATRFC",13,0)
 S (DIV,PSOSITE)=$P(^PSRX(PSORXN,2),"^",9)
"RTN","PSOATRFC",14,0)
 S (SITE,DA)=$P(^XMB(1,1,"XUS"),U,17),DIC="4",DIQ(0)="IE",DR=".01;99",DIQ="PSOUTIL" D EN^DIQ1
"RTN","PSOATRFC",15,0)
 S PSOINST=$G(PSOUTIL(4,SITE,99,"I"))
"RTN","PSOATRFC",16,0)
 S PSOPAR=$G(^PS(59,DIV,1)),PSORFN=$G(^PS(59,DIV,"RF")),PSOITNF=0
"RTN","PSOATRFC",17,0)
 S PSXSYS=+$O(^PSX(550,"C",""))_"^"_$G(PSOINST)_"^"_$G(PSOUTIL(4,SITE,.01,"E"))
"RTN","PSOATRFC",18,0)
 I $G(PSXSYS) D
"RTN","PSOATRFC",19,0)
 . K:($P($G(^PSX(550,+PSXSYS,0)),"^",2)'="A") PSXSYS
"RTN","PSOATRFC",20,0)
 . I $$VERSION^XPDUTL("PSO")<7.0 K PSXSYS
"RTN","PSOATRFC",21,0)
 S PSOSYS=$G(^PS(59.7,1,40.1))
"RTN","PSOATRFC",22,0)
 ;
"RTN","PSOATRFC",23,0)
 I '$D(^PSRX(PSORXN,0))!($P(^(0),U)="")!('$D(^(2)))!($P(^("STA"),U)=13) D  Q
"RTN","PSOATRFC",24,0)
 . D ERR("Rx IEN "_PSORXN_" not in file (#52)/Incomplete/Deleted")
"RTN","PSOATRFC",25,0)
 S PSORXN0=^PSRX(PSORXN,0),PSORXN2=^(2),PSORXN3=^(3),PSORXNS=^("STA")
"RTN","PSOATRFC",26,0)
 S (DFN,PSODFN)=$P(PSORXN0,U,2),RXN=$P(PSORXN0,U),DRG=$P(PSORXN0,U,6)
"RTN","PSOATRFC",27,0)
 D GET^PSOPTPST
"RTN","PSOATRFC",28,0)
 I $G(PSOPTPST(2,PSODFN,.351))]"" D  Q
"RTN","PSOATRFC",29,0)
 . D ERR("Patient Died on "_PSOPTPST(2,PSODFN,.351))
"RTN","PSOATRFC",30,0)
 D ICN^PSODPT(DFN)
"RTN","PSOATRFC",31,0)
 S PSOLOUD=1 D:$P($G(^PS(55,DFN,0)),U,6)'=2 EN^PSOHLUP(DFN) K PSOLOUD
"RTN","PSOATRFC",32,0)
 I '$P(PSOPAR,U,11),$G(^PSDRUG(DRG,"I"))]"",DT>$G(^("I")) D  Q
"RTN","PSOATRFC",33,0)
 . D ERR("Drug is inactive for Rx # "_RXN_" cannot be refilled")
"RTN","PSOATRFC",34,0)
 I $G(PSOPTPST(2,PSODFN,.1))]"",'PSORFN D  Q
"RTN","PSOATRFC",35,0)
 . D ERR("Patient is an Inpatient on Ward "_PSOPTPST(2,PSODFN,.1))
"RTN","PSOATRFC",36,0)
 I $G(PSOPTPST(2,PSODFN,148))="YES",'$P(PSORFN,U,2) D  Q
"RTN","PSOATRFC",37,0)
 . D ERR("Patient is in a Contract Nursing Home")
"RTN","PSOATRFC",38,0)
 D CHKRF Q:PSOITNF           ;Quit if RX not refillable
"RTN","PSOATRFC",39,0)
 ;
"RTN","PSOATRFC",40,0)
 ;more checks
"RTN","PSOATRFC",41,0)
 I $O(^PS(52.5,"B",PSORXN,0)),'$G(^PS(52.5,+$O(^PS(52.5,"B",PSORXN,0)),"P")) D  Q
"RTN","PSOATRFC",42,0)
 . D ERR("Rx is in suspense and cannot be refilled")
"RTN","PSOATRFC",43,0)
 S PSOY=1+$$LSTRFL^PSOBPSU1(PSORXN)
"RTN","PSOATRFC",44,0)
 I PSOY>$P(PSORXN0,U,9) D  Q
"RTN","PSOATRFC",45,0)
 . D ERR("Can't refill, no refills remaining")
"RTN","PSOATRFC",46,0)
 S (PSOITF,PSOX("NUMBER"))=PSOY
"RTN","PSOATRFC",47,0)
 S PSOX("RX0")=PSORXN0,PSOX("RX2")=PSORXN2,PSOX("RX3")=PSORXN3,PSOX("STA")=PSORXNS
"RTN","PSOATRFC",48,0)
 S DRG=$P(PSORXN0,U,6)
"RTN","PSOATRFC",49,0)
 N PSODEA,PSODAY,PSOCHECK
"RTN","PSOATRFC",50,0)
 S PSODEA=$P($G(^PSDRUG(DRG,0)),U,3)
"RTN","PSOATRFC",51,0)
 S PSODAY=$P(PSORXN0,U,8)
"RTN","PSOATRFC",52,0)
 S PSOCHECK=$$DEACHK^PSOUTLA1(PSORXN,PSODEA,PSODAY)
"RTN","PSOATRFC",53,0)
 I PSOCHECK=1 D ERR("Requested refill exceeds maximum allowable days supply for Rx.") Q  ;*388
"RTN","PSOATRFC",54,0)
 I PSOCHECK=2 D ERR("Current drug DEA/SPECIAL HANDLING code does not allow refills.") Q  ;*388
"RTN","PSOATRFC",55,0)
 D CHKDT Q:PSOITNF           ;Quit if not refillable
"RTN","PSOATRFC",56,0)
 ;
"RTN","PSOATRFC",57,0)
 ; Titration Marked Rx
"RTN","PSOATRFC",58,0)
 I $$TITRX^PSOUTL(PSORXN)="t" D  Q
"RTN","PSOATRFC",59,0)
 . D ERR("'Titration Rx' cannot be refilled.")
"RTN","PSOATRFC",60,0)
 ;
"RTN","PSOATRFC",61,0)
 ;ok to process refill
"RTN","PSOATRFC",62,0)
 D EN^PSOR52(.PSOX)
"RTN","PSOATRFC",63,0)
 ;add additional activity log comment to refill just added
"RTN","PSOATRFC",64,0)
 I PSOITF,$D(^PSRX(PSORXN,1,PSOITF,0)) D
"RTN","PSOATRFC",65,0)
 . N AL,DONE,PSOFDA
"RTN","PSOATRFC",66,0)
 . S AL="",DONE=0
"RTN","PSOATRFC",67,0)
 . F  S AL=$O(^PSRX(PSORXN,"A",AL),-1) Q:'AL  D  Q:DONE
"RTN","PSOATRFC",68,0)
 . . Q:$P(^PSRX(PSORXN,"A",AL,0),U,4)'=PSOITF
"RTN","PSOATRFC",69,0)
 . . S PSOFDA(52.34,"+3,"_AL_","_PSORXN_",",.01)="CPRS Auto Refill"
"RTN","PSOATRFC",70,0)
 . . D UPDATE^DIE("","PSOFDA")
"RTN","PSOATRFC",71,0)
 . . S DONE=1
"RTN","PSOATRFC",72,0)
 Q
"RTN","PSOATRFC",73,0)
 ;
"RTN","PSOATRFC",74,0)
CHKRF ;check precription if still refillable
"RTN","PSOATRFC",75,0)
 S X2=-120,X1=DT D C^%DTC S PSODTCUT=X
"RTN","PSOATRFC",76,0)
 D ^PSOBUILD
"RTN","PSOATRFC",77,0)
 I '$G(PSOSD) D  Q
"RTN","PSOATRFC",78,0)
 .  D ERR("This patient has no prescriptions")
"RTN","PSOATRFC",79,0)
 S (PSOX,PSOY,PSOS)="",PSOX("STA")=PSORXNS
"RTN","PSOATRFC",80,0)
 F  S PSOS=$O(PSOSD(PSOS)) Q:PSOS=""  F  S PSOX=$O(PSOSD(PSOS,PSOX)) Q:PSOX']""  D
"RTN","PSOATRFC",81,0)
 . I PSORXN=+PSOSD(PSOS,PSOX) S PSOY=PSOSD(PSOS,PSOX) I $P(PSOY,U,4)]"" D
"RTN","PSOATRFC",82,0)
 . . D ERR("Cannot refill Rx # "_RXN)
"RTN","PSOATRFC",83,0)
 . . S PSOREA=$P(PSOY,U,4),PSOSTAT=PSOX("STA")
"RTN","PSOATRFC",84,0)
 . . I PSOREA["Z" S:PSOSTAT=4 PSOSTAT=1 D  Q
"RTN","PSOATRFC",85,0)
 . . . S PSOA=";"_PSOSTAT,PSOB=$P(^DD(52,100,0),U,3)
"RTN","PSOATRFC",86,0)
 . . . S PSOA=$F(PSOB,PSOA),PSOA=$P($E(PSOB,PSOA,999),";",1)
"RTN","PSOATRFC",87,0)
 . . . D ERR(" Rx is in "_$P(PSOA,":",2)_" status")
"RTN","PSOATRFC",88,0)
 . . . K PSOA,PSOB
"RTN","PSOATRFC",89,0)
 . . I PSOREA["M" D ERR("Drug no longer used by Outpatient Pharmacy") Q
"RTN","PSOATRFC",90,0)
 . . I PSOREA["B" D ERR("Narcotic Drug") Q
"RTN","PSOATRFC",91,0)
 . . I PSOREA["C" D ERR("Non-Renewable Drug") Q
"RTN","PSOATRFC",92,0)
 . . I PSOREA["D" D ERR("Non-Renewable Patient Status") Q
"RTN","PSOATRFC",93,0)
 . . I PSOREA["E" D ERR("Non-Verified Rx") Q
"RTN","PSOATRFC",94,0)
 . . I PSOREA["G",PSOREA'["B" D ERR("No more refills left")
"RTN","PSOATRFC",95,0)
 I PSOY="" D ERR("Cannot refill, Rx is DC/Exp. Later Rx may exist") D
"RTN","PSOATRFC",96,0)
 . S (PSOS,PSOX)="",PSOD=$P(^PSDRUG($P(PSORXN0,U,6),0),U)
"RTN","PSOATRFC",97,0)
 . N ZRX S ZRX=""
"RTN","PSOATRFC",98,0)
 . F  S PSOS=$O(PSOSD(PSOS)) Q:PSOS=""  D
"RTN","PSOATRFC",99,0)
 . . F  S PSOX=$O(PSOSD(PSOS,PSOX)) Q:PSOX=""  D
"RTN","PSOATRFC",100,0)
 . . . I PSOD=PSOX,+PSOSD(PSOS,PSOX) S ZRX=$P($G(^PSRX(+PSOSD(PSOS,PSOX),0)),U)
"RTN","PSOATRFC",101,0)
 . D ERR(ZRX)
"RTN","PSOATRFC",102,0)
 Q
"RTN","PSOATRFC",103,0)
 ;
"RTN","PSOATRFC",104,0)
CHKDT ;check date on this refill request
"RTN","PSOATRFC",105,0)
 N X1,X2
"RTN","PSOATRFC",106,0)
 S PSOX("IRXN")=PSORXN
"RTN","PSOATRFC",107,0)
 S PSOX("MAIL/WINDOW")="M",PSOX("FLD")=2,PSOX("QS")="S"
"RTN","PSOATRFC",108,0)
 S PSOX("FIELD")=0,(PSORX("FILL DATE"),PSOX("FILL DATE"))=DT,PSOX("FLD")=1,X1=DT,X2=-180
"RTN","PSOATRFC",109,0)
 D C^%DTC S PSOX("ISSUE DATE")=X,PSOX("CLERK CODE")=DUZ
"RTN","PSOATRFC",110,0)
 S PSOX("STOP DATE")=$P(PSORXN2,U,6) D NEXT
"RTN","PSOATRFC",111,0)
 I PSOX("FILL DATE")<$P(PSORXN3,U,2) D SUSDATE^PSOUTIL(.PSOX)
"RTN","PSOATRFC",112,0)
 I PSOX("FILL DATE")>PSOX("STOP DATE") D  Q
"RTN","PSOATRFC",113,0)
 . D ERR("Can't refill, Refill Date "_$$DSP(PSOX("FILL DATE")))
"RTN","PSOATRFC",114,0)
 . D ERR("is past Expiration Date "_$$DSP(PSOX("STOP DATE")))
"RTN","PSOATRFC",115,0)
 S PSOX("LAST REFILL DATE")=$P(PSORXN3,U,1)
"RTN","PSOATRFC",116,0)
 I PSOX("LAST REFILL DATE"),PSOX("FILL DATE")=PSOX("LAST REFILL DATE") D  Q
"RTN","PSOATRFC",117,0)
 . D ERR("Can't refill, Fill Date already exists for "_$$DSP(PSOX("FILL DATE")))
"RTN","PSOATRFC",118,0)
 I PSOX("LAST REFILL DATE"),PSOX("FILL DATE")<PSOX("LAST REFILL DATE") D  Q
"RTN","PSOATRFC",119,0)
 . D ERR("Can't refill, later Refill Date already exists for "_$$DSP(PSOX("LAST REFILL DATE")))
"RTN","PSOATRFC",120,0)
 Q
"RTN","PSOATRFC",121,0)
 ;
"RTN","PSOATRFC",122,0)
NEXT ;
"RTN","PSOATRFC",123,0)
 S PSOX1=$P(PSORXN2,U,2)
"RTN","PSOATRFC",124,0)
 I '$O(^PSRX(PSORXN,1,0)) D  Q
"RTN","PSOATRFC",125,0)
 . S $P(PSORXN3,U)=PSOX1,X1=PSOX1
"RTN","PSOATRFC",126,0)
 . S X2=$P(PSORXN0,U,8)-10\1
"RTN","PSOATRFC",127,0)
 . D C^%DTC
"RTN","PSOATRFC",128,0)
 . S:'$P(PSORXN3,U,8) $P(PSORXN3,U,2)=X K X
"RTN","PSOATRFC",129,0)
 S PSOY2=0
"RTN","PSOATRFC",130,0)
 F PSOY=0:0 S PSOY=$O(^PSRX(PSORXN,1,PSOY)) Q:'PSOY  S PSOY1=PSOY,PSOY2=PSOY2+1
"RTN","PSOATRFC",131,0)
 S PSOY=^PSRX(PSORXN,1,PSOY1,0)
"RTN","PSOATRFC",132,0)
 S PSOX2=$P(PSOY,U)
"RTN","PSOATRFC",133,0)
 S $P(PSORXN3,U)=PSOX2,X1=PSOX2
"RTN","PSOATRFC",134,0)
 S X2=$P(PSORXN0,U,8)-10\1
"RTN","PSOATRFC",135,0)
 D C^%DTC S PSOY3=X
"RTN","PSOATRFC",136,0)
 S X1=PSOX1,X2=(PSOY2+1)*$P(PSORXN0,U,8)-10\1
"RTN","PSOATRFC",137,0)
 D C^%DTC S PSOY4=X
"RTN","PSOATRFC",138,0)
 S $P(PSORXN3,U,2)=$S(PSOY3<PSOY4:PSOY4,1:PSOY3)
"RTN","PSOATRFC",139,0)
 K X,X1,X2,PSOX1,PSOX2,PSOY,PSOY1,PSOY2,PSOY3,PSOY4
"RTN","PSOATRFC",140,0)
 Q
"RTN","PSOATRFC",141,0)
 ;
"RTN","PSOATRFC",142,0)
DSP(X) ;
"RTN","PSOATRFC",143,0)
 Q:'X ""
"RTN","PSOATRFC",144,0)
 Q $E(X,4,5)_"/"_$E(X,6,7)_"/"_$E(X,2,3)
"RTN","PSOATRFC",145,0)
 ;
"RTN","PSOATRFC",146,0)
ERR(TXT) ;Build error text array
"RTN","PSOATRFC",147,0)
 ;  add TXT to end of last line in array, if will fit, else
"RTN","PSOATRFC",148,0)
 ;     add it as a new last line and indented 3.
"RTN","PSOATRFC",149,0)
 ;  and set error flag
"RTN","PSOATRFC",150,0)
 N II S II=$O(PSOITMG(""),-1) S:'II II=1
"RTN","PSOATRFC",151,0)
 S PSOITNF=1
"RTN","PSOATRFC",152,0)
 I $L($G(PSOITMG(II)))+$L(TXT)>79 D
"RTN","PSOATRFC",153,0)
 . S PSOITMG(II+1)="   "_TXT
"RTN","PSOATRFC",154,0)
 E  D
"RTN","PSOATRFC",155,0)
 . S PSOITMG(II)=$G(PSOITMG(II))_" "_TXT
"RTN","PSOATRFC",156,0)
 Q
"RTN","PSOATRFC",157,0)
 ;
"RTN","PSOATRFC",158,0)
MAILMSG(DFN,RXN,ERRTXT) ;send alert via mailman msg to PSOAUTRF key holders
"RTN","PSOATRFC",159,0)
 N MDUZ,XMDUZ,XMTEXT,XMSUB,PTNAME,PTSSN,DIV,DIVN
"RTN","PSOATRFC",160,0)
 D DEM^VADPT
"RTN","PSOATRFC",161,0)
 S PTNAME=$P(VADM(1),"^"),PTSSN=$P($P(VADM(2),"^",2),"-",3) K VADM
"RTN","PSOATRFC",162,0)
 S DIV=$$RXSITE^PSOBPSUT(RXN,0),DIVN=$P($G(^PS(59,DIV,0)),"^")
"RTN","PSOATRFC",163,0)
 S MDUZ=0
"RTN","PSOATRFC",164,0)
 F  S MDUZ=$O(^XUSEC("PSOAUTRF",MDUZ)) Q:MDUZ'>0  S XMY(MDUZ)=""
"RTN","PSOATRFC",165,0)
 S XMDUZ=.5,XMSUB=DIVN_" CPRS AUTO REFILL - Not Processed List"
"RTN","PSOATRFC",166,0)
 S ERRTXT(.1)="CPRS requested an Outpatient refill, but was not allowed for the below reason:"
"RTN","PSOATRFC",167,0)
 S ERRTXT(.2)=""
"RTN","PSOATRFC",168,0)
 S ERRTXT(.3)="   Patient: "_PTNAME_" ("_PTSSN_")"
"RTN","PSOATRFC",169,0)
 S ERRTXT(.4)="      Rx #: "_$$GET1^DIQ(52,RXN,.01)
"RTN","PSOATRFC",170,0)
 S ERRTXT(.5)="      Drug: "_$$GET1^DIQ(52,RXN,6)
"RTN","PSOATRFC",171,0)
 S ERRTXT(.6)=""
"RTN","PSOATRFC",172,0)
 S XMTEXT="ERRTXT(" N DIFROM
"RTN","PSOATRFC",173,0)
 D ^XMD
"RTN","PSOATRFC",174,0)
 Q
"RTN","PSOBBC")
0^61^B104120785^B91849962
"RTN","PSOBBC",1,0)
PSOBBC ;IHS/DSD/JCM-BATCH BARCODE DRIVER ;3/30/06 10:10am
"RTN","PSOBBC",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,22,27,34,46,130,146,185,242,264,300,337,313**;DEC 1997;Build 76
"RTN","PSOBBC",3,0)
 ;External reference to ^IBE(350.1,"ANEW" supported by DBIA 592
"RTN","PSOBBC",4,0)
 ;External references CHPUS^IBACUS and TRI^IBACUS supported by DBIA 2030
"RTN","PSOBBC",5,0)
 ;External references LK^ORX2 and ULK^ORX2 supported by DBIA 867
"RTN","PSOBBC",6,0)
 ;External references ^PS(55 supported by DBIA 2228
"RTN","PSOBBC",7,0)
 ;External references U, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOBBC",8,0)
 ;PSO*242 change default to from Q to S
"RTN","PSOBBC",9,0)
 ;-------------------------------------------------------------------
"RTN","PSOBBC",10,0)
START ;
"RTN","PSOBBC",11,0)
 N PSODFN,PSOBBCNO
"RTN","PSOBBC",12,0)
 D INIT I '$D(PSOPAR) D ^PSOLSET G:'$D(PSOPAR) EOJ
"RTN","PSOBBC",13,0)
 I $P($G(PSOPAR),"^",2),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("VERIFY")=1  ;337
"RTN","PSOBBC",14,0)
 I $G(PSOSITE) S PSOBARID=$G(^PS(59,PSOSITE,"IB")) I '$D(^IBE(350.1,"ANEW",+PSOBARID,1,1)) D  S PSORX("QFLG")=1 K PSOBARID G END
"RTN","PSOBBC",15,0)
 .W $C(7),!!,"WARNING: Pharmacy Copay not working,",!,?10,"Check IB SERVICE/SECTION in Pharmacy Site File.",!!!,"You will not be able to enter any new prescriptions until this is corrected!"
"RTN","PSOBBC",16,0)
 S PSOBBC("QFLG")=0,PSORX("BAR CODE")=1
"RTN","PSOBBC",17,0)
 D FROM I PSOBBC("QFLG") S PSORX("QFLG")=1 G END
"RTN","PSOBBC",18,0)
 D ASK I PSOBBC("QFLG") S PSORX("QFLG")=1 G END
"RTN","PSOBBC",19,0)
 D PROCESS
"RTN","PSOBBC",20,0)
END D EOJ
"RTN","PSOBBC",21,0)
 Q
"RTN","PSOBBC",22,0)
 ;--------------------------------------------------------------------
"RTN","PSOBBC",23,0)
INIT ;
"RTN","PSOBBC",24,0)
 S PSOBBC("QFLG")=0,PSORX("BAR CODE")=1 K PPL
"RTN","PSOBBC",25,0)
 I '$G(PSOINST) D
"RTN","PSOBBC",26,0)
 .K DIC,DR,DIQ S DA=$P($$SITE^VASITE(),"^") I DA D
"RTN","PSOBBC",27,0)
 ..K PSOINST S DIC=4,DIQ(0)="I",DR=99,DIQ="PSOINST" D EN^DIQ1
"RTN","PSOBBC",28,0)
 ..S PSOINST=PSOINST(4,DA,99,"I") K DIC,DA,DIQ,PSOINST(4)
"RTN","PSOBBC",29,0)
 Q
"RTN","PSOBBC",30,0)
FROM ;
"RTN","PSOBBC",31,0)
 S DIR(0)="S^1:REFILLS;2:RENEWS;"
"RTN","PSOBBC",32,0)
 S DIR("A")="Batch Barcode for",DIR("B")="REFILLS"
"RTN","PSOBBC",33,0)
 D DIR G:'Y FROMX
"RTN","PSOBBC",34,0)
 S PSOBBC1("FROM")=$S(Y=1:"REFILL",1:"NEW")
"RTN","PSOBBC",35,0)
FROMX K X,Y,DIR
"RTN","PSOBBC",36,0)
 Q
"RTN","PSOBBC",37,0)
 ;
"RTN","PSOBBC",38,0)
ASK ;
"RTN","PSOBBC",39,0)
 K BINGCRT,BINGRTE,BBRX
"RTN","PSOBBC",40,0)
 W !,"Please answer the following for this session of prescriptions",!
"RTN","PSOBBC",41,0)
 D EN^PSOREF2(.PSOBBC) I PSOBBC("DFLG") S PSOBBC("QFLG")=1 G ASKX
"RTN","PSOBBC",42,0)
 D SUSP
"RTN","PSOBBC",43,0)
 D INPT,CNH
"RTN","PSOBBC",44,0)
 D:'$P($G(PSOPAR),"^",6) EARLY
"RTN","PSOBBC",45,0)
 D SET
"RTN","PSOBBC",46,0)
 D:PSOBBC1("FROM")="NEW" NOORE^PSONEW(.PSOBBC) S:$G(PSOBBC("NOO"))'="" PSOBBCNO=$G(PSOBBC("NOO")) S:$G(PSOBBC("DFLG")) PSOBBC("QFLG")=1
"RTN","PSOBBC",47,0)
ASKX Q
"RTN","PSOBBC",48,0)
 ;
"RTN","PSOBBC",49,0)
SUSP ;
"RTN","PSOBBC",50,0)
 S DIR(0)="SAB^Q:QUEUED;S:SUSPENDED"
"RTN","PSOBBC",51,0)
 S DIR("A")="Will these refills be Queued or Suspended ? "
"RTN","PSOBBC",52,0)
 S DIR("B")="S"   ;PSO*242
"RTN","PSOBBC",53,0)
 D DIR G:PSOBBC("QFLG") SUSPX
"RTN","PSOBBC",54,0)
 S (PSOBBC1("QS"),PSOBBC("QS"))=Y S:PSOBBC1("QS")="S" BINGCRT=0
"RTN","PSOBBC",55,0)
SUSPX K X,Y,DIR
"RTN","PSOBBC",56,0)
 Q
"RTN","PSOBBC",57,0)
 ;
"RTN","PSOBBC",58,0)
INPT ;
"RTN","PSOBBC",59,0)
 S DIR(0)="YA"
"RTN","PSOBBC",60,0)
 S DIR("A")="Allow refills for inpatient ? "
"RTN","PSOBBC",61,0)
 S DIR("B")="N"
"RTN","PSOBBC",62,0)
 D DIR G:PSOBBC("QFLG") INPTX
"RTN","PSOBBC",63,0)
 S (PSOBBC1("INOK"),PSOBBC("INOK"))=Y
"RTN","PSOBBC",64,0)
INPTX K X,Y,DIR
"RTN","PSOBBC",65,0)
 Q
"RTN","PSOBBC",66,0)
CNH ;
"RTN","PSOBBC",67,0)
 S DIR(0)="YA"
"RTN","PSOBBC",68,0)
 S DIR("A")="Allow refills for CNH ? "
"RTN","PSOBBC",69,0)
 S DIR("B")="N"
"RTN","PSOBBC",70,0)
 D DIR G:PSOBBC("QFLG") CNHX
"RTN","PSOBBC",71,0)
 S (PSOBBC1("CNHOK"),PSOBBC("CNHOK"))=Y
"RTN","PSOBBC",72,0)
CNHX K X,Y,DIR
"RTN","PSOBBC",73,0)
 Q
"RTN","PSOBBC",74,0)
 ;
"RTN","PSOBBC",75,0)
EARLY ;
"RTN","PSOBBC",76,0)
 S DIR(0)="YA"
"RTN","PSOBBC",77,0)
 S DIR("A")="Allow early refills ? "
"RTN","PSOBBC",78,0)
 S DIR("B")="N"
"RTN","PSOBBC",79,0)
 D DIR G:PSOBBC("QFLG") EARLYX
"RTN","PSOBBC",80,0)
 S (PSOBBC1("EAOK"),PSOBBC("EAOK"))=Y
"RTN","PSOBBC",81,0)
EARLYX K X,Y,DIR
"RTN","PSOBBC",82,0)
 Q
"RTN","PSOBBC",83,0)
 ;
"RTN","PSOBBC",84,0)
SET ;
"RTN","PSOBBC",85,0)
 S PSOBBC1("MAIL/WINDOW")=PSOBBC("MAIL/WINDOW") S:PSOBBC1("MAIL/WINDOW")="W" BINGRTE="W"
"RTN","PSOBBC",86,0)
 S PSOBBC1("FILL DATE")=PSOBBC("FILL DATE")
"RTN","PSOBBC",87,0)
 S:$G(PSOBBC("CLERK CODE")) PSOBBC1("CLERK CODE")=PSOBBC("CLERK CODE")
"RTN","PSOBBC",88,0)
 S:$G(PSOBBC("EXPIRATION DATE")) PSOBBC1("EXPIRATION DATE")=PSOBBC("EXPIRATION DATE")
"RTN","PSOBBC",89,0)
 Q
"RTN","PSOBBC",90,0)
DIR ;
"RTN","PSOBBC",91,0)
 D ^DIR
"RTN","PSOBBC",92,0)
 S:$D(DIRUT) PSOBBC("QFLG")=1,PSORX("QFLG")=1
"RTN","PSOBBC",93,0)
 K DIRUT,DUOUT,DTOUT,DIROUT
"RTN","PSOBBC",94,0)
 Q
"RTN","PSOBBC",95,0)
 ;
"RTN","PSOBBC",96,0)
PROCESS ;
"RTN","PSOBBC",97,0)
 S PSOBBC("DFLG")=0 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2)
"RTN","PSOBBC",98,0)
 S RXN=$O(^TMP("PSORXN",$J,0)) I RXN D
"RTN","PSOBBC",99,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSOBBC",100,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS","")
"RTN","PSOBBC",101,0)
 K RXN,RXN1,^TMP("PSORXN",$J) D CLEAN^PSOVER1 K ^TMP("PSORXDC",$J)
"RTN","PSOBBC",102,0)
 D GETRXM D:PSOBBC("QFLG") ULK,ULP,ULRX G:PSOBBC("QFLG") PROCESSX
"RTN","PSOBBC",103,0)
 I $G(PSODFN)'=$P(^PSRX(PSOBBC("IRXN"),0),"^",2) D  G:PSOBBC("DFLG") PROCESS
"RTN","PSOBBC",104,0)
 .I $G(PSODFN) D ULK,ULP
"RTN","PSOBBC",105,0)
 .D PT Q:PSOBBC("DFLG")
"RTN","PSOBBC",106,0)
 .D PROFILE^PSORX1
"RTN","PSOBBC",107,0)
 E  D PTC G:PSOBBC("DFLG") PROCESS
"RTN","PSOBBC",108,0)
 D:'$G(PSOSD) ^PSOBUILD
"RTN","PSOBBC",109,0)
 S PSOBBC("DONE")=PSOBBC("IRXN")_","
"RTN","PSOBBC",110,0)
 D @PSOBBC1("FROM") S:$G(PPL)&$D(BINGRTE) BBRX(1)=$S($D(PSOBBC("DONE")):PSOBBC("DONE"),1:BBRX) D:$D(BINGCRT)&($D(BINGRTE)&($D(DISGROUP))) ^PSOBING1 K BBRX D ULRX G PROCESS
"RTN","PSOBBC",111,0)
PROCESSX I $G(PPL) D SETX,TRI,Q^PSORXL K PPL,RXFL
"RTN","PSOBBC",112,0)
 Q
"RTN","PSOBBC",113,0)
GETRXM ;
"RTN","PSOBBC",114,0)
 K DIR,PSOBBC("IRXN"),PSOREFXM
"RTN","PSOBBC",115,0)
 S DIR(0)="FO^5:245^K:X'?3N1""-""1.N X"
"RTN","PSOBBC",116,0)
 S DIR("A")="WAND BARCODE"
"RTN","PSOBBC",117,0)
 S DIR("?",1)="Wand the barcoded number of the prescription to be processed."
"RTN","PSOBBC",118,0)
 S DIR("?",2)="The number should be of the form NNN-NNNNNN"
"RTN","PSOBBC",119,0)
 S DIR("?",3)="where the number before the dash is your station number."
"RTN","PSOBBC",120,0)
 S DIR("?")="Enter ""^"", or a RETURN to quit."
"RTN","PSOBBC",121,0)
 D DIR G:PSOBBC("QFLG") GETRXMX
"RTN","PSOBBC",122,0)
 I $P(X,"-")'=PSOINST W !?7,$C(7),$C(7),$C(7),"Not From this Institution" G GETRXM
"RTN","PSOBBC",123,0)
 S (PSOBBC("IRXN"),PSOBBC("OIRXN"),BBRX)=$P(X,"-",2)
"RTN","PSOBBC",124,0)
 I $G(^PSRX(PSOBBC("IRXN"),0))']"" W !,$C(7),"Rx data is not on file !",! G GETRXM
"RTN","PSOBBC",125,0)
 I $$TITRX^PSOUTL(PSOBBC("IRXN"))="t" D  G GETRXM
"RTN","PSOBBC",126,0)
 . W $C(7),!!,"Rx# "_$$GET1^DIQ(52,PSOBBC("IRXN"),.01)_" is marked as 'Titration Rx' and cannot be "_$S(PSOBBC1("FROM")="REFILL":"refilled.",1:"renewed."),!
"RTN","PSOBBC",127,0)
 S PSOXDFN=+$P($G(^PSRX(PSOBBC("IRXN"),0)),"^",2) I PSOXDFN S PSOLOUD=1 D:$P($G(^PS(55,PSOXDFN,0)),"^",6)'=2 EN^PSOHLUP(PSOXDFN) K PSOLOUD
"RTN","PSOBBC",128,0)
 K PSOXDFN I $P($G(^PSRX(PSOBBC("IRXN"),"STA")),"^")=13 W !,$C(7),"Rx has already been deleted." G GETRXM
"RTN","PSOBBC",129,0)
 I $G(PSOBBC("DONE"))[PSOBBC("IRXN")_"," W !,$C(7),"Rx has already been entered" G GETRXM
"RTN","PSOBBC",130,0)
 I $G(PSOBBC1("FROM"))="REFILL" S PSOREFXM=$G(PSOBBC("IRXN")) I PSOREFXM D PSOL^PSSLOCK(PSOREFXM) I '$G(PSOMSG) D  K PSOMSG G GETRXM
"RTN","PSOBBC",131,0)
 .I $P($G(PSOMSG),"^",2)'="" W $C(7),!!?5,$P(PSOMSG,"^",2),! Q
"RTN","PSOBBC",132,0)
 .W $C(7),!!?5,"Another person is editing Rx "_$P($G(^PSRX(+$G(PSOBBC("IRXN")),0)),"^"),!
"RTN","PSOBBC",133,0)
 I '$D(PSODFNX(+$P(^PSRX(PSOBBC("IRXN"),0),"^",2))),$G(PSOBBC1("FROM"))="NEW" K PSONOERR D  G:'$G(PSOPLCK)!($G(PSONOERR)) GETRXM
"RTN","PSOBBC",134,0)
 .S PSOPLCK=$$L^PSSLOCK(+$P(^PSRX(PSOBBC("IRXN"),0),"^",2),0) I '$G(PSOPLCK) D LOCK^PSOORCPY Q
"RTN","PSOBBC",135,0)
 .S X=+$P(^PSRX(PSOBBC("IRXN"),0),"^",2)_";DPT(" D LK^ORX2 I 'Y S PSONOERR=1 D UL^PSSLOCK(+$P(^PSRX(PSOBBC("IRXN"),0),"^",2)) Q
"RTN","PSOBBC",136,0)
 .S PSODFNX(+$P(^PSRX(PSOBBC("IRXN"),0),"^",2))=""
"RTN","PSOBBC",137,0)
GETRXMX K X,Y,DIR,PSOOPT
"RTN","PSOBBC",138,0)
 Q
"RTN","PSOBBC",139,0)
 ;
"RTN","PSOBBC",140,0)
PT ;
"RTN","PSOBBC",141,0)
 S PSOBBC("DFLG")=0
"RTN","PSOBBC",142,0)
 W !,$C(7),"New Patient, please pause"
"RTN","PSOBBC",143,0)
 I $G(PPL) D SETX,TRI,Q^PSORXL K PPL
"RTN","PSOBBC",144,0)
 K RXFL
"RTN","PSOBBC",145,0)
 S (DFN,PSODFN)=$P(^PSRX(PSOBBC("IRXN"),0),"^",2),PSORX("NAME")=$P(^DPT(PSODFN,0),"^")
"RTN","PSOBBC",146,0)
 D ICN^PSODPT(DFN)
"RTN","PSOBBC",147,0)
 ;CHECK FOR BAD ADDRESS/SAB
"RTN","PSOBBC",148,0)
 S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSOBBC",149,0)
 D ^PSOBUILD
"RTN","PSOBBC",150,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^")
"RTN","PSOBBC",151,0)
 K PSOX
"RTN","PSOBBC",152,0)
PTC S (DFN,PSODFN)=$P(^PSRX(PSOBBC("IRXN"),0),"^",2)
"RTN","PSOBBC",153,0)
 S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSOBBC",154,0)
 S PSOBBC("DFLG")=0 D GET^PSOPTPST
"RTN","PSOBBC",155,0)
 I $G(PSOPTPST(2,PSODFN,.351))]"" S PSOBBC("DFLG")=1 D DEAD^PSOPTPST G PTX
"RTN","PSOBBC",156,0)
 N PSOTPEXT I $G(PSOBBC1("FROM"))="NEW",$D(^PS(52.91,PSODFN,0)) I '$P(^PS(52.91,PSODFN,0),"^",3)!($P(^(0),"^",3)>DT) D PDIR^PSOTPCAN(PSODFN) I $G(PSOTPEXT) K PSOTPEXT S PSOBBC("DFLG")=1 G PTX
"RTN","PSOBBC",157,0)
 K PSOTPEXT
"RTN","PSOBBC",158,0)
 I $G(PSOPTPST(2,PSODFN,.1))]"" D:'PSOBBC("INOK") PID W !,$C(7),?10,"PATIENT IS AN INPATIENT ON WARD ",PSOPTPST(2,PSODFN,.1)," !!" I 'PSOBBC("INOK") S PSOBBC("DFLG")=1 G PTX
"RTN","PSOBBC",159,0)
 K PSORX("CNH")
"RTN","PSOBBC",160,0)
 I $G(PSOPTPST(2,PSODFN,148))="YES" D:'PSOBBC("CNHOK") PID W !,$C(7),?10,"PATIENT IS IN A CONTRACT NURSING HOME !!" S:PSOBBC("CNHOK") PSORX("CNH")=1 I 'PSOBBC("CNHOK") S PSOBBC("DFLG")=1 G PTX
"RTN","PSOBBC",161,0)
 D:PSOBBC1("FROM")="NEW" COPAY^PSOPTPST
"RTN","PSOBBC",162,0)
PTX K PSOPTPST W:PSOBBC("DFLG") !!,$C(7),"Rx not filled"
"RTN","PSOBBC",163,0)
 Q
"RTN","PSOBBC",164,0)
 ;
"RTN","PSOBBC",165,0)
REFILL ;
"RTN","PSOBBC",166,0)
 ; Titration Rx refill request check from AudioFax/Internet
"RTN","PSOBBC",167,0)
 N PSORXIEN
"RTN","PSOBBC",168,0)
 S PSORXIEN=+$G(PSOBBC("IRXN"))
"RTN","PSOBBC",169,0)
 I PSORXIEN,$D(^PSRX(PSORXIEN,0)),$$TITRX^PSOUTL(PSORXIEN)="t" D  Q
"RTN","PSOBBC",170,0)
 . W !!,$C(7),"Rx# "_$$GET1^DIQ(52,PSORXIEN,.01)_" is marked as 'Titration Rx' and cannot be refilled.",!
"RTN","PSOBBC",171,0)
 . D PAUSE^VALM1
"RTN","PSOBBC",172,0)
 N PSOFROM S PSOFROM="REFILL",XFROM="BATCH"
"RTN","PSOBBC",173,0)
 D EN^PSOREF0(.PSOBBC)
"RTN","PSOBBC",174,0)
 Q
"RTN","PSOBBC",175,0)
REFILLX ;
"RTN","PSOBBC",176,0)
 Q
"RTN","PSOBBC",177,0)
 ;
"RTN","PSOBBC",178,0)
NEW ;
"RTN","PSOBBC",179,0)
 ; Titration Rx Renewal request check from AudioFax
"RTN","PSOBBC",180,0)
 N PSORXIEN
"RTN","PSOBBC",181,0)
 S PSORXIEN=+$G(PSOBBC("IRXN"))
"RTN","PSOBBC",182,0)
 I PSORXIEN,$D(^PSRX(PSORXIEN,0)),$$TITRX^PSOUTL(PSORXIEN)="t" D  Q
"RTN","PSOBBC",183,0)
 . W !!,$C(7),"Rx# "_$$GET1^DIQ(52,PSORXIEN,.01)_"    Drug: "_$$GET1^DIQ(52,PSORXIEN,6),!
"RTN","PSOBBC",184,0)
 . W !,"'Titration Rx' cannot be renewed."
"RTN","PSOBBC",185,0)
 . D PAUSE^VALM1
"RTN","PSOBBC",186,0)
 N PSOFROM S (PSOFROM,XFROM)="BATCH"
"RTN","PSOBBC",187,0)
 S PSOBBC("OIRXN")=PSOBBC("IRXN")
"RTN","PSOBBC",188,0)
 S PSORNW("FILL DATE")=PSOBBC1("FILL DATE"),PSOOPT=3
"RTN","PSOBBC",189,0)
 S PSORX("DFLG")=0,PSOBBC("NOO")=$G(PSOBBCNO) D EN^PSORENW0(.PSOBBC)
"RTN","PSOBBC",190,0)
 S PSOBBC("MAIL/WINDOW")=PSOBBC1("MAIL/WINDOW")
"RTN","PSOBBC",191,0)
 S PSOBBC("EAOK")=$G(PSOBBC1("EAOK"))
"RTN","PSOBBC",192,0)
 S PSOBBC("QS")=PSOBBC1("QS")
"RTN","PSOBBC",193,0)
 S PSOBBC("INOK")=PSOBBC1("INOK")
"RTN","PSOBBC",194,0)
 S PSOBBC("CNHOK")=PSOBBC1("CNHOK")
"RTN","PSOBBC",195,0)
 S:$G(PSOBBC1("CLERK CODE")) PSOBBC("CLERK CODE")=PSOBBC1("CLERK CODE")
"RTN","PSOBBC",196,0)
 S:$G(PSOBBC1("EXPIRATION DATE")) PSOBBC("EXPIRATION DATE")=PSOBBC1("EXPIRATION DATE")
"RTN","PSOBBC",197,0)
 K PSORNW,PSOOPT
"RTN","PSOBBC",198,0)
 Q
"RTN","PSOBBC",199,0)
 ;
"RTN","PSOBBC",200,0)
EOJ ;
"RTN","PSOBBC",201,0)
 K PSOMSG,PSOREFXM,PSONOERR,PSOPLCK,PSOSD,PSOBBC,PSOBBC1,PSOBARID,Y,X,XFROM,PSOCOUU,PSOCOU,ACNT,ADFN,CLS,CMOP,CNT,FDR,HDR,PSCAN,JJ,POERR,PSOBCK,PSONEW3,PSORENW3,RXFL,PSOOPT
"RTN","PSOBBC",202,0)
 K PSORX,RFDT,RX1,RXS,SDA,PSONOOR,VALMBCK,VALMSG,SIG,SIGOK,STA,TM,TM1,VA,VADM,VAEL,VAPA
"RTN","PSOBBC",203,0)
 D CLEAN^PSOVER1 K ^TMP("PSORXDC",$J)
"RTN","PSOBBC",204,0)
 Q
"RTN","PSOBBC",205,0)
TRI ;Check for Tricare Rx's
"RTN","PSOBBC",206,0)
 S X="IBACUS" X ^%ZOSF("TEST") I '$T Q
"RTN","PSOBBC",207,0)
 I '$$TRI^IBACUS Q
"RTN","PSOBBC",208,0)
 Q:'$G(PPL)
"RTN","PSOBBC",209,0)
 ;PREV LINE, IN V 7 D ZOSF FIRST
"RTN","PSOBBC",210,0)
 N DA,NEWPPL,WWFLAG,PSOWRX,PSOWW,WWNEXT,WXRX,WPAT,WSITE,WDUZ,WFILL,WLOOP,WBILL,WPPLFLG,WWW
"RTN","PSOBBC",211,0)
 D DEV^PSOCPTRI
"RTN","PSOBBC",212,0)
 S NEWPPL=PPL S PPL=""
"RTN","PSOBBC",213,0)
 S (WWFLAG,WPPLFLG)=0 F PSOWW=1:1 S PSOWRX=$P(NEWPPL,",",PSOWW) D  Q:$G(WWFLAG)
"RTN","PSOBBC",214,0)
 .S WWNEXT=$P(NEWPPL,",",(PSOWW+1)) I WWNEXT=""!(WWNEXT=",") S WWFLAG=1
"RTN","PSOBBC",215,0)
 .I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOBBC",216,0)
 .S WPAT=$P($G(^PSRX(+PSOWRX,0)),"^",2),WSITE=+$G(PSOSITE),WDUZ=+$G(DUZ)
"RTN","PSOBBC",217,0)
 .S WFILL=0 F WLOOP=0:0 S WLOOP=$O(^PSRX(+PSOWRX,1,WLOOP)) Q:'WLOOP  S WFILL=WLOOP
"RTN","PSOBBC",218,0)
 .S WBILL=$$CHPUS^IBACUS(WPAT,DT,PSOWRX,WFILL,PSOLAP,WSITE,WDUZ)
"RTN","PSOBBC",219,0)
 .I '$G(WBILL) S WXRX(PSOWW,PSOWRX)="" Q
"RTN","PSOBBC",220,0)
 .S WPPLFLG=1
"RTN","PSOBBC",221,0)
 .S FLD(99)="99",FLD(99.1)="Awaiting CHAMPUS billing approval"
"RTN","PSOBBC",222,0)
 .N RSDT,ACT,PSUS,RXF,I,PSDA,NOW,IR,FDA,RFN S DA=PSOWRX D H^PSOCPTRH Q
"RTN","PSOBBC",223,0)
 I '$G(WPPLFLG) S PPL=NEWPPL Q
"RTN","PSOBBC",224,0)
 S WWW="" F  S WWW=$O(WXRX(WWW)) Q:WWW=""  D
"RTN","PSOBBC",225,0)
 .I $G(PPL)="" S PPL=$O(WXRX(WWW,0))_"," Q
"RTN","PSOBBC",226,0)
 .S PPL=PPL_$O(WXRX(WWW,0))_","
"RTN","PSOBBC",227,0)
 Q
"RTN","PSOBBC",228,0)
ULK ;
"RTN","PSOBBC",229,0)
 Q:$G(PSOBBC1("FROM"))'="NEW"
"RTN","PSOBBC",230,0)
 I '$G(PSODFN) Q
"RTN","PSOBBC",231,0)
 S X=PSODFN_";DPT(" D ULK^ORX2 K PSODFNX(PSODFN) Q
"RTN","PSOBBC",232,0)
ULP Q:$G(PSOBBC1("FROM"))'="NEW"
"RTN","PSOBBC",233,0)
 Q:'$G(PSODFN)
"RTN","PSOBBC",234,0)
 D UL^PSSLOCK(PSODFN)
"RTN","PSOBBC",235,0)
 Q
"RTN","PSOBBC",236,0)
ULRX ;
"RTN","PSOBBC",237,0)
 Q:$G(PSOBBC1("FROM"))'="REFILL"
"RTN","PSOBBC",238,0)
 Q:'$G(PSOREFXM)
"RTN","PSOBBC",239,0)
 D PSOUL^PSSLOCK(PSOREFXM)
"RTN","PSOBBC",240,0)
 K PSOREFXM
"RTN","PSOBBC",241,0)
 Q
"RTN","PSOBBC",242,0)
 ;
"RTN","PSOBBC",243,0)
SETX ;
"RTN","PSOBBC",244,0)
 S:$G(PSOBBC1("FROM"))="REFILL" XFROM="BATCH"
"RTN","PSOBBC",245,0)
 S:$G(PSOBBC1("FROM"))="NEW" XFROM="BATCH"
"RTN","PSOBBC",246,0)
 Q
"RTN","PSOBBC",247,0)
PID ;
"RTN","PSOBBC",248,0)
 I '$G(DFN) S DFN=+$G(PSODFN)
"RTN","PSOBBC",249,0)
 Q:'$G(DFN)
"RTN","PSOBBC",250,0)
 K VAPTYP D PID^VADPT
"RTN","PSOBBC",251,0)
 W !!,?9,$G(PSORX("NAME"))_"    ",$G(VA("BID"))
"RTN","PSOBBC",252,0)
 K VA("BID"),VA("PID")
"RTN","PSOBBC",253,0)
 Q
"RTN","PSOCPDUP")
0^43^B33663947^B32857063
"RTN","PSOCPDUP",1,0)
PSOCPDUP ;BIR/SAB - Dup drug and class checker for copy orders ;1/3/05 11:34am
"RTN","PSOCPDUP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,32,130,132,192,207,222,243,305,313**;DEC 1997;Build 76
"RTN","PSOCPDUP",3,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOCPDUP",4,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSOCPDUP",5,0)
 ;External references to ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOCPDUP",6,0)
 S $P(PSONULN,"-",79)="-",(STA,DNM)=""
"RTN","PSOCPDUP",7,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""  D  Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",8,0)
 .I STA="PENDING" D ^PSODRDU1 Q
"RTN","PSOCPDUP",9,0)
 .I STA="ZNONVA" D NVA^PSODRDU1 Q
"RTN","PSOCPDUP",10,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&('$D(^XUSEC("PSORPH",DUZ)))  Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",11,0)
 ..I $P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",12,0)
 ..I $P(PSOPAR,"^",2),'$P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",13,0)
 ..I '$P(PSOPAR,"^",2),'$P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",14,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&($D(^XUSEC("PSORPH",DUZ))) DUP Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",15,0)
 .I PSODRUG("VA CLASS")]"",$E(PSODRUG("VA CLASS"),1,4)=$E($P(PSOSD(STA,DNM),"^",5),1,4),PSODRUG("NAME")'=$P(DNM,"^") S PSOCPCLS=1 D CLS K PSOCPCLS
"RTN","PSOCPDUP",16,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI")
"RTN","PSOCPDUP",17,0)
 D REMOTE
"RTN","PSOCPDUP",18,0)
EXIT D ^PSOBUILD K CAN,DA,DIR,DNM,DUPRX0,ISSD,J,LSTFL,MSG,PHYS,PSOCLC,PSONULN,REA,RFLS,RX0,RX2,RXREC,ST,Y,ZZ,ACT,PSOCLOZ,PSOLR,PSOLDT,PSOCD,SIG
"RTN","PSOCPDUP",19,0)
 Q
"RTN","PSOCPDUP",20,0)
DUP ; Duplicate Drug Check
"RTN","PSOCPDUP",21,0)
 S:$P(PSOSD(STA,DNM),"^",2)<10!($P(PSOSD(STA,DNM),"^",2)=16) DUP=1 W !,PSONULN,!,$C(7),"DUPLICATE DRUG "_$P(DNM,"^")_" in Prescription: ",$P(^PSRX(+PSOSD(STA,DNM),0),"^"),$$TITRX^PSOUTL(+PSOSD(STA,DNM))
"RTN","PSOCPDUP",22,0)
 S RXREC=+PSOSD(STA,DNM),MSG="Discontinued During Prescription Entry COPY - Duplicate Drug"
"RTN","PSOCPDUP",23,0)
DATA S DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),SIG=$P($G(^PSRX(RXREC,"SIG")),"^"),$P(RX0,"^",15)=+$G(^PSRX(RXREC,"STA"))
"RTN","PSOCPDUP",24,0)
 W !!,$J("Status: ",24) S J=RXREC D STAT^PSOFUNC W ST K RX0,RX2 W ?40,$J("Issued: ",24),$E(ISSD,4,5)_"/"_$E(ISSD,6,7)_"/"_$E(ISSD,2,3)
"RTN","PSOCPDUP",25,0)
 D PRSTAT^PSODRDUP(RXREC)
"RTN","PSOCPDUP",26,0)
 K FSIG,BSIG I $P($G(^PSRX(RXREC,"SIG")),"^",2) D FSIG^PSOUTLA("R",RXREC,54) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSOCPDUP",27,0)
 K FSIG,PSREV I '$P($G(^PSRX(RXREC,"SIG")),"^",2) D EN2^PSOUTLA1(RXREC,54)
"RTN","PSOCPDUP",28,0)
 W !,$J("SIG: ",24) W $G(BSIG(1))
"RTN","PSOCPDUP",29,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?24,$G(BSIG(PSREV))
"RTN","PSOCPDUP",30,0)
 K BSIG,PSREV
"RTN","PSOCPDUP",31,0)
 W !,$J("QTY: ",24)_$P(DUPRX0,"^",7),?40,$J("# of refills: ",24)_RFLS S PHYS=$S($D(^VA(200,+$P(DUPRX0,"^",4),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSOCPDUP",32,0)
 W !,$J("Provider: ",24)_PHYS,?40,$J("Refills remaining: ",24),RFLS-$S($D(^PSRX(RXREC,1,0)):$P(^(0),"^",4),1:0)
"RTN","PSOCPDUP",33,0)
 S LSTFL=+^PSRX(RXREC,3) W !?40,$J("Last filled on: ",24)_$E(LSTFL,4,5)_"/"_$E(LSTFL,6,7)_"/"_$E(LSTFL,2,3),!?40,$J("Days Supply: ",24)_$P(DUPRX0,"^",8)
"RTN","PSOCPDUP",34,0)
 W !,PSONULN,! I $P($G(^PS(53,+$P($G(PSORX("PATIENT STATUS")),"^"),0)),"^")["AUTH ABS"!($G(PSORX("PATIENT STATUS"))["AUTH ABS")&'$P(PSOPAR,"^",5) W !,"PATIENT ON AUTHORIZED ABSENCE!" Q
"RTN","PSOCPDUP",35,0)
ASKCAN I $P(PSOSD(STA,DNM),"^",2)>10,$P(PSOSD(STA,DNM),"^",2)'=16 Q
"RTN","PSOCPDUP",36,0)
 I '$P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)),'$G(CLS) S PSORX("DFLG")=1 K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR Q
"RTN","PSOCPDUP",37,0)
 I $P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)),'$G(CLS) S PSORX("DFLG")=1 K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR Q
"RTN","PSOCPDUP",38,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(DUP) W !!,"Prescription "_$S(+$G(PSOSD(STA,DNM)):$P($G(^PSRX(+$G(PSOSD(STA,DNM)),0)),"^")_" ",1:"")_"is on Provider Hold, it cannot be discontinued.",! D  Q
"RTN","PSOCPDUP",39,0)
 .S PSORX("DFLG")=1 K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR,DUP
"RTN","PSOCPDUP",40,0)
 I $G(PSOCPCLS),$G(RXRECCOP) D PSOL^PSSLOCK(RXRECCOP) I '$G(PSOMSG) D  K PSOMSG,DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSOCPDUP",41,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2) Q
"RTN","PSOCPDUP",42,0)
 .W !!,"Another person is editing Rx "_$P($G(^PSRX(RXRECCOP,0)),"^")
"RTN","PSOCPDUP",43,0)
 K PSOMSG S DIR("A")="Discontinue Rx # "_$P(^PSRX(+PSOSD(STA,DNM),0),"^"),DIR(0)="Y",DIR("?")="Enter Y to discontinue this Rx."
"RTN","PSOCPDUP",44,0)
 D ^DIR K DIR S DA=RXREC S ACT="Discontinued while entering new Rx"
"RTN","PSOCPDUP",45,0)
 I 'Y W $C(7)," -Prescription was not discontinued..." S:'$D(PSOCLC) PSOCLC=DUZ S MSG=ACT,REA="C" S:$G(DUP) PSORX("DFLG")=1 K DUP,CLS D  Q
"RTN","PSOCPDUP",46,0)
 .I $D(^TMP("PSORXDC",$J,RXREC,0)) K ^TMP("PSORXDC",$J,RXREC,0)
"RTN","PSOCPDUP",47,0)
 .D:$G(PSOCPCLS) ULRX
"RTN","PSOCPDUP",48,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(CLS) W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! D ULRX K CLS,DUP,RXRECLOC S PSORX("DFLG")=1 H 2 Q
"RTN","PSOCPDUP",49,0)
 S PSOCLC=DUZ,MSG=$S($G(MSG)]"":MSG,1:ACT_" During New Rx Entry - DUPLICATE RX"),REA="C"
"RTN","PSOCPDUP",50,0)
 W !!,"Duplicate "_$S($G(CLS):"Class",1:"Drug")_" will be discontinued after the acceptance of the new order.",!
"RTN","PSOCPDUP",51,0)
 S ^TMP("PSORXDC",$J,RXREC,0)="52^"_DA_"^"_MSG_"^"_REA_"^"_ACT_"^"_STA_"^"_DNM,PSONOOR="D"
"RTN","PSOCPDUP",52,0)
 K CLS,DUP,PSOCPCLS Q
"RTN","PSOCPDUP",53,0)
 ;
"RTN","PSOCPDUP",54,0)
CLS ; - Duplicate Drug Class Check
"RTN","PSOCPDUP",55,0)
 K DUP S CLS=1,MSG="Discontinued During New Prescription Entry - Duplicate Class" W !,PSONULN
"RTN","PSOCPDUP",56,0)
 W !?5,$C(7),"*** SAME CLASS *** OF DRUG IN RX #"_$P(^PSRX(+PSOSD(STA,DNM),0),"^")_" FOR "_$P(DNM,"^"),!,"CLASS: "_PSODRUG("VA CLASS")
"RTN","PSOCPDUP",57,0)
 S CAN=$P(PSOSD(STA,DNM),"^",2)'<11!($P(PSOSD(STA,DNM),"^",2)=1) S (RXREC,RXRECCOP)=+PSOSD(STA,DNM) S PSOELSE=$P(PSOPAR,"^",10) I PSOELSE D DATA
"RTN","PSOCPDUP",58,0)
 I 'PSOELSE S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR,DTOUT,DUOUT,DIRUT
"RTN","PSOCPDUP",59,0)
 K PSOELSE,RXRECCOP Q
"RTN","PSOCPDUP",60,0)
ULRX ;
"RTN","PSOCPDUP",61,0)
 I '$G(RXRECCOP) Q
"RTN","PSOCPDUP",62,0)
 D PSOUL^PSSLOCK(RXRECCOP)
"RTN","PSOCPDUP",63,0)
 Q
"RTN","PSOCPDUP",64,0)
 ;
"RTN","PSOCPDUP",65,0)
REMOTE ;
"RTN","PSOCPDUP",66,0)
 Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",67,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOCPDUP",68,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOCPDUP",69,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) G REMOTE2
"RTN","PSOCPDUP",70,0)
 W:$D(IOF) @IOF W !,"Now doing remote order checks. Please wait..."
"RTN","PSOCPDUP",71,0)
 D REMOTE^PSOORRDI(PSODFN,PSODRUG("IEN"))
"RTN","PSOCPDUP",72,0)
 I $D(^TMP($J,"DD")) D DUP^PSOORRD2
"RTN","PSOCPDUP",73,0)
 I $D(^TMP($J,"DC")) D CLS^PSOORRD2
"RTN","PSOCPDUP",74,0)
REMOTE2 ;
"RTN","PSOCPDUP",75,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI")
"RTN","PSOCPDUP",76,0)
 Q
"RTN","PSOLMPO2")
0^39^B829209^B590140
"RTN","PSOLMPO2",1,0)
PSOLMPO2 ;ISC-BHAM/SAB - list template to complete backdoor orders ;03/13/1995
"RTN","PSOLMPO2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,71,225,313**;DEC 1997;Build 76
"RTN","PSOLMPO2",3,0)
EN ; -- main entry point for PSO LM BACKDOOR ORDER
"RTN","PSOLMPO2",4,0)
 D EN^VALM("PSO LM BACKDOOR ORDER")
"RTN","PSOLMPO2",5,0)
 Q
"RTN","PSOLMPO2",6,0)
 ;
"RTN","PSOLMPO2",7,0)
HDR ; -- header code
"RTN","PSOLMPO2",8,0)
 D HDR^PSOLMUTL
"RTN","PSOLMPO2",9,0)
 Q
"RTN","PSOLMPO2",10,0)
 ;
"RTN","PSOLMPO2",11,0)
INIT ; -- init variables and list array
"RTN","PSOLMPO2",12,0)
 S VALMCNT=IEN,VALM("TITLE")="New OP Order ("_$S($G(PSOMTFLG):"Maintenance Rx",$G(COPY):"COPY",1:"ROUTINE")_")"
"RTN","PSOLMPO2",13,0)
 S VALMCNT=PSOPF
"RTN","PSOLMPO2",14,0)
 D RV^PSONFI Q
"RTN","PSOLMPO2",15,0)
 ;
"RTN","PSOLMPO2",16,0)
HELP ; -- help code
"RTN","PSOLMPO2",17,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOLMPO2",18,0)
 Q
"RTN","PSOLMPO2",19,0)
 ;
"RTN","PSOLMPO2",20,0)
EXIT ; -- exit code
"RTN","PSOLMPO2",21,0)
 K PSOANSQD
"RTN","PSOLMPO2",22,0)
 S PSOQFLG=1
"RTN","PSOLMPO2",23,0)
 K FLAGLINE D CLEAN^VALM10
"RTN","PSOLMPO2",24,0)
 Q
"RTN","PSOLMPO2",25,0)
 ;
"RTN","PSOLMPO2",26,0)
EXPND ; -- expand code
"RTN","PSOLMPO2",27,0)
 Q
"RTN","PSOLMPO2",28,0)
 ;
"RTN","PSON52")
0^25^B91470672^B86376192
"RTN","PSON52",1,0)
PSON52 ;BIR/DSD - files new entries in prescription file ;08/09/93
"RTN","PSON52",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,16,23,27,32,46,71,111,124,117,131,139,157,143,219,148,239,201,268,260,225,303,358,251,387,379,390,391,313**;DEC 1997;Build 76
"RTN","PSON52",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSON52",4,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSON52",5,0)
 ;External reference to ^XUSEC supported by DBIA 10076
"RTN","PSON52",6,0)
 ;External reference SWSTAT^IBBAPI supported by DBIA 4663
"RTN","PSON52",7,0)
 ;External reference SAVNDC^PSSNDCUT supported by DBIA 4707
"RTN","PSON52",8,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSON52",9,0)
EN(PSOX) ;Entry Point
"RTN","PSON52",10,0)
START ;
"RTN","PSON52",11,0)
 D:$D(XRTL) T0^%ZOSV ; Start RT Monitor
"RTN","PSON52",12,0)
 D INIT G:PSON52("QFLG") END D NFILE Q:$G(PSONEW("DFLG"))
"RTN","PSON52",13,0)
 D PS55,DIK
"RTN","PSON52",14,0)
 S:$D(XRT0) XRTN=$T(+0) D:$D(XRT0) T1^%ZOSV ; Stop RT Monitor
"RTN","PSON52",15,0)
 D FINISH
"RTN","PSON52",16,0)
 I $P(^PSRX(PSOX("IRXN"),0),"^",11)="W",$G(^("IB")) S ^PSRX("ACP",$P(^PSRX(PSOX("IRXN"),0),"^",2),$P(^(2),"^",2),0,PSOX("IRXN"))=""
"RTN","PSON52",17,0)
END D EOJ
"RTN","PSON52",18,0)
 Q
"RTN","PSON52",19,0)
INIT ;
"RTN","PSON52",20,0)
 K X,%DT S:$G(PSOID) PSOX("ISSUE DATE")=PSOID
"RTN","PSON52",21,0)
 S PSOX("CS")=0 K PSOX("NOPSDRPH")
"RTN","PSON52",22,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSOX("CS"),"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSOX("CS"),"^",2)=1
"RTN","PSON52",23,0)
 I $P($G(PSOX("CS")),"^"),'$D(^XUSEC("PSDRPH",DUZ)) S PSOX("NOPSDRPH")=1
"RTN","PSON52",24,0)
 S PSON52("QFLG")=0,X1=PSOX("ISSUE DATE"),X2=PSOX("DAYS SUPPLY")*(PSOX("# OF REFILLS")+1)\1
"RTN","PSON52",25,0)
 I $D(CLOZPAT) S X2=$S(X2=14:14,X2=7:7,1:X2) G DT
"RTN","PSON52",26,0)
 S X2=$S(PSOX("DAYS SUPPLY")=X2:X2,+$G(PSOX("CS")):184,+$G(DEA("CS")):184,1:366)
"RTN","PSON52",27,0)
 I X2<30 D
"RTN","PSON52",28,0)
 . N % S %=$P($G(PSORX("PATIENT STATUS")),"^"),X2=30
"RTN","PSON52",29,0)
 . S:%?.N %=$P($G(^PS(53,+%,0)),"^") I %["AUTH ABS" S X2=5
"RTN","PSON52",30,0)
DT D C^%DTC S PSOX("STOP DATE")=$P(X,".") K X
"RTN","PSON52",31,0)
 I PSOX("# OF REFILLS")>0 S X1=PSOX("FILL DATE"),X2=$S((PSOX("DAYS SUPPLY")-10\1)<1:1,1:PSOX("DAYS SUPPLY")-10\1) D C^%DTC S PSOX("NEXT POSSIBLE REFILL")=$P(X,".") K X
"RTN","PSON52",32,0)
 S PSOX("TYPE OF RX")=0,PSOX("DISPENSED DATE")=PSOX("FILL DATE") D NOW^%DTC S PSOX("LOGIN DATE")=$S($P($G(OR0),"^",12):$P($G(OR0),"^",12),1:%) K %,X
"RTN","PSON52",33,0)
 S PSOX("STATUS")=$S($G(PSOX("STATUS"))]"":PSOX("STATUS"),$D(PSORX("VERIFY")):1,$D(PSOX("NOPSDRPH")):1,1:0)
"RTN","PSON52",34,0)
 S PSOX("COPIES")=$S($G(PSOX("COPIES"))]"":PSOX("COPIES"),1:1)
"RTN","PSON52",35,0)
 I $G(PSORX("PHARM"))]"" S PSOX("PHARMACIST")=PSORX("PHARM") K PSORX("PHARM")
"RTN","PSON52",36,0)
INITX Q
"RTN","PSON52",37,0)
 ;
"RTN","PSON52",38,0)
NFILE I $G(OR0) D  Q:$G(PSONEW("DFLG"))
"RTN","PSON52",39,0)
 .D NOOR^PSONEW Q:$G(PSONEW("DFLG"))
"RTN","PSON52",40,0)
 .I $G(PSOSIGFL)!($G(PSODRUG("OI"))'=$P(OR0,"^",8)) S PSONEW("CLERK CODE")=DUZ,PSONEW("REMARKS")=$G(PSONEW("REMARKS"))_" CPRS Order #"_$P(OR0,"^")_" Edited."
"RTN","PSON52",41,0)
 S DIC="^PSRX(",DLAYGO=52,DIC(0)="L",X=PSOX("RX #") K DD,DO D FILE^DICN S PSOX("IRXN")=+Y K DLAYGO,X,Y,DIC,DD,DO
"RTN","PSON52",42,0)
 I '$D(^XUSEC("PSORPH",DUZ))!($D(PSOX("NOPSDRPH"))),$$DS^PSSDSAPI&(+$G(^TMP("PSODOSF",$J,0))) S PSON52(PSOX("IRXN"),"STA")=1,PSOX("STATUS")=1
"RTN","PSON52",43,0)
 F PSOX1=0:1 S PSON52=$P($T(DD+PSOX1),";;",2,4) Q:PSON52=""  K PSOY S PSOY=$P(PSON52,";;") I $G(@PSOY)]"" S $P(PSON52(PSOX("IRXN"),$P(PSON52,";;",2)),"^",$P(PSON52,";;",3))=@PSOY
"RTN","PSON52",44,0)
 F I=1:1:PSOX("ENT") S ^PSRX(PSOX("IRXN"),6,I,0)=PSOX("DOSE",I)_"^"_$G(PSOX("DOSE ORDERED",I))_"^"_$G(PSOX("UNITS",I))_"^"_$G(PSOX("NOUN",I))_"^" D
"RTN","PSON52",45,0)
 .S ^PSRX(PSOX("IRXN"),6,I,0)=^PSRX(PSOX("IRXN"),6,I,0)_$G(PSOX("DURATION",I))_"^"_$G(PSOX("CONJUNCTION",I))_"^"_$G(PSOX("ROUTE",I))_"^"_$G(PSOX("SCHEDULE",I))_"^"_$G(PSOX("VERB",I))
"RTN","PSON52",46,0)
 .I $G(PSOX("ODOSE",I))]"" S ^PSRX(PSOX("IRXN"),6,I,1)=PSOX("ODOSE",I)
"RTN","PSON52",47,0)
 S ^PSRX(PSOX("IRXN"),6,0)="^52.0113^"_PSOX("ENT")_"^"_PSOX("ENT")
"RTN","PSON52",48,0)
 K PSOX1,PSOY
"RTN","PSON52",49,0)
 S PSOX1="" F  S PSOX1=$O(PSON52(PSOX("IRXN"),PSOX1)) Q:PSOX1=""  S ^PSRX(PSOX("IRXN"),PSOX1)=$G(PSON52(PSOX("IRXN"),PSOX1))
"RTN","PSON52",50,0)
 I $O(PSOX("SIG",0)) D
"RTN","PSON52",51,0)
 .S D=0 F  S D=$O(PSOX("SIG",D)) Q:'D  S ^PSRX(PSOX("IRXN"),"INS1",D,0)=PSOX("SIG",D),TP=$G(TP)+1
"RTN","PSON52",52,0)
 .S ^PSRX(PSOX("IRXN"),"INS1",0)="^52.0115^"_TP_"^"_TP_"^"_DT_"^^" K TP,D
"RTN","PSON52",53,0)
 I $G(PSOX("SINS"))]"" S ^PSRX(PSOX("IRXN"),"INSS")=PSOX("SINS")
"RTN","PSON52",54,0)
 I $G(SIGOK) D
"RTN","PSON52",55,0)
 .S $P(^PSRX(PSOX("IRXN"),"SIG"),"^",2)=1,^PSRX(PSOX("IRXN"),"SIG1",0)="^52.04A^^"
"RTN","PSON52",56,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSOX("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSOX("IRXN"),"SIG1",0),"^",3)=+$P(^PSRX(PSOX("IRXN"),"SIG1",0),"^",3)+1,$P(^(0),"^",4)=+$P(^(0),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSON52",57,0)
 .K SIG
"RTN","PSON52",58,0)
 I $D(PSOINSFL) S ^PSRX(PSOX("IRXN"),"A",0)="^52.3DA^1^1",^PSRX(PSOX("IRXN"),"A",1,0)=DT_"^G^^0^Patient Instructions "_$S(PSOINSFL=1:"",1:"Not ")_"Sent By Provider."
"RTN","PSON52",59,0)
 I $G(OR0),$P(OR0,"^",24) S ^PSRX(PSOX("IRXN"),"PKI")=$S($G(PSOSIGFL):"^1",1:1) D ACLOG
"RTN","PSON52",60,0)
 I $P($G(PSOX("CS")),"^"),'+$P($G(^PSRX(PSOX("IRXN"),"PKI")),"^") S $P(^PSRX(PSOX("IRXN"),"PKI"),"^",2)=1
"RTN","PSON52",61,0)
 K PSOX1,PSOFINFL,HLDSIG,D,PSOINSFL,D
"RTN","PSON52",62,0)
 D:$G(^TMP("PSODAI",$J,0))
"RTN","PSON52",63,0)
 .S $P(^PSRX(PSOX("IRXN"),3),"^",6)=1
"RTN","PSON52",64,0)
 .I $O(^TMP("PSODAI",$J,0)) S DAI=0 F  S DAI=$O(^TMP("PSODAI",$J,DAI)) Q:'DAI  D
"RTN","PSON52",65,0)
 ..S:'$D(^PSRX(PSOX("IRXN"),"DAI",0)) ^PSRX(PSOX("IRXN"),"DAI",0)="^52.03^^" S ^PSRX(PSOX("IRXN"),"DAI",DAI,0)=^TMP("PSODAI",$J,DAI,0)
"RTN","PSON52",66,0)
 ..S $P(^PSRX(PSOX("IRXN"),"DAI",0),"^",3)=+$P(^PSRX(PSOX("IRXN"),"DAI",0),"^",3)+1,$P(^(0),"^",4)=+$P(^(0),"^",4)+1
"RTN","PSON52",67,0)
 .K ^TMP("PSODAI",$J),DAI
"RTN","PSON52",68,0)
 I $G(PSOX("CHCS NUMBER"))'="" S $P(^PSRX(PSOX("IRXN"),"EXT"),"^")=$G(PSOX("CHCS NUMBER"))
"RTN","PSON52",69,0)
 I $G(PSOX("EXTERNAL SYSTEM"))'="" S $P(^PSRX(PSOX("IRXN"),"EXT"),"^",2)=$G(PSOX("EXTERNAL SYSTEM"))
"RTN","PSON52",70,0)
 I $G(PSOX("NEWCOPAY")) S ^PSRX(PSOX("IRXN"),"IB")=$G(PSOX("NEWCOPAY"))
"RTN","PSON52",71,0)
 ;Next line, set SC question based on Copay status?
"RTN","PSON52",72,0)
IBQ ;I $G(PSOBILL)=2 S ^PSRX(PSOX("IRXN"),"IBQ")=$S($G(PSOX("NEWCOPAY")):0,1:1)
"RTN","PSON52",73,0)
 N PSOSCFLD S PSOSCFLD=$S(PSOSCP'="":$G(PSOANSQ("SC")),1:"")_"^"_$G(PSOANSQ("MST"))_"^"_$G(PSOANSQ("VEH"))_"^"_$G(PSOANSQ("RAD"))_"^"_$G(PSOANSQ("PGW"))_"^"_$G(PSOANSQ("HNC"))_"^"_$G(PSOANSQ("CV"))_"^"_$G(PSOANSQ("SHAD"))
"RTN","PSON52",74,0)
 I PSOSCP<50&($TR(PSOSCFLD,"^")'="")&($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)'=1) D
"RTN","PSON52",75,0)
 . S ^PSRX(PSOX("IRXN"),"IBQ")=PSOSCFLD K PSOSCFLD  ;don't set if SC % is null or 0, just set it in ICD node
"RTN","PSON52",76,0)
 D ICD^PSODIAG
"RTN","PSON52",77,0)
 D:$$SWSTAT^IBBAPI() GACT^PSOPFSU0(PSOX("IRXN"),0)
"RTN","PSON52",78,0)
 D:$G(PSOTITRX) SAVETIT(PSOTITRX,PSOX("IRXN"))
"RTN","PSON52",79,0)
 K PSOTITRX,PSOANSQ,PSOANSQD,PSOX("NEWCOPAY")
"RTN","PSON52",80,0)
 L -^PSRX("B",PSOX("IRXN"))
"RTN","PSON52",81,0)
 Q
"RTN","PSON52",82,0)
 ;
"RTN","PSON52",83,0)
ACLOG ;activity log (digitally signed CS orders)
"RTN","PSON52",84,0)
 N DTTM,CNT,OCNT,XX
"RTN","PSON52",85,0)
 D NOW^%DTC S DTTM=%
"RTN","PSON52",86,0)
 S CNT=0 F XX=0:0 S XX=$O(^PSRX(PSOX("IRXN"),"A",XX)) Q:'XX  S CNT=XX
"RTN","PSON52",87,0)
 S OCNT=CNT
"RTN","PSON52",88,0)
 I $G(PSOCSP("NAME"))'=PSODRUG("NAME") S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^NAME: "_PSOCSP("NAME")
"RTN","PSON52",89,0)
 S XX=0 F  S XX=$O(PSOCSP("DOSE",XX)) Q:'XX  I PSOCSP("DOSE",XX)'=$G(PSONEW("DOSE",XX)) D
"RTN","PSON52",90,0)
 .S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^DOSAGE: "_PSOCSP("DOSE",XX)
"RTN","PSON52",91,0)
 S XX=0 F  S XX=$O(PSOCSP("DOSE ORDERED",XX)) Q:'XX  I PSOCSP("DOSE ORDERED",XX)'=$G(PSONEW("DOSE ORDERED",XX)) D
"RTN","PSON52",92,0)
 .S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^DISPENSE UNITS: "_PSOCSP("DOSE ORDERED",XX)
"RTN","PSON52",93,0)
 I PSOCSP("ISSUE DATE")'=PSONEW("ISSUE DATE") S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^ISSUE DATE: "_$$FMTE^XLFDT(PSOCSP("ISSUE DATE"))
"RTN","PSON52",94,0)
 I PSOCSP("DAYS SUPPLY")'=PSONEW("DAYS SUPPLY") S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^DAYS SUPPLY: "_PSOCSP("DAYS SUPPLY")
"RTN","PSON52",95,0)
 I PSOCSP("QTY")'=PSONEW("QTY") S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^QTY: "_PSOCSP("QTY")
"RTN","PSON52",96,0)
 I PSOCSP("# OF REFILLS")'=PSONEW("# OF REFILLS") S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^# OF REFILLS: "_PSOCSP("# OF REFILLS")
"RTN","PSON52",97,0)
 I '$$SUBSCRIB^ORDEA($P(OR0,"^"),PSOX("IRXN")) S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^ORDER DEA ARCHIVE INFO file entry failure"
"RTN","PSON52",98,0)
 I OCNT'=CNT S ^PSRX(PSOX("IRXN"),"A",0)="^52.3DA^"_CNT_"^"_CNT
"RTN","PSON52",99,0)
 Q
"RTN","PSON52",100,0)
 ;
"RTN","PSON52",101,0)
PS55 ;
"RTN","PSON52",102,0)
 L +^PS(55,PSODFN,"P"):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSON52",103,0)
 S:'$D(^PS(55,PSODFN,"P",0)) ^(0)="^55.03PA^^"
"RTN","PSON52",104,0)
 F PSOX1=$P(^PS(55,PSODFN,"P",0),"^",3):1 Q:'$D(^PS(55,PSODFN,"P",PSOX1))
"RTN","PSON52",105,0)
 S PSOX("55 IEN")=PSOX1
"RTN","PSON52",106,0)
 S ^PS(55,PSODFN,"P",PSOX1,0)=PSOX("IRXN"),$P(^PS(55,PSODFN,"P",0),"^",3,4)=PSOX1_"^"_($P(^PS(55,PSODFN,"P",0),"^",4)+1)
"RTN","PSON52",107,0)
 S ^PS(55,PSODFN,"P","A",PSONEW("STOP DATE"),PSOX("IRXN"))=""
"RTN","PSON52",108,0)
PS55X L -^PS(55,PSODFN,"P")
"RTN","PSON52",109,0)
 K PSOX1
"RTN","PSON52",110,0)
 Q
"RTN","PSON52",111,0)
DIK ;
"RTN","PSON52",112,0)
 I $D(^XUSEC("PSORPH",DUZ)) S DA=PSOX("IRXN"),DIE=52,DR="41////"_PSOCOU_";S:'X Y=""@1"";42////"_PSOCOUU_";@1" D ^DIE K DIE,DR
"RTN","PSON52",113,0)
 K DIK,DA S DIK="^PSRX(",DA=PSOX("IRXN") D IX1^DIK K DIK
"RTN","PSON52",114,0)
 S DA=PSOX("IRXN") D ORC^PSORN52C
"RTN","PSON52",115,0)
 Q
"RTN","PSON52",116,0)
FINISH ;
"RTN","PSON52",117,0)
ANQ I $G(ANQDATA)]"" D NOW^%DTC G:$D(^PS(52.52,"B",%)) ANQ D
"RTN","PSON52",118,0)
 .K DD,DO S DIC="^PS(52.52,",DIC(0)="L",DLAYGO=52.52,X=% D FILE^DICN K DIC,DLAYGO,DD,DO
"RTN","PSON52",119,0)
 .S ^PS(52.52,+Y,0)=$P(Y,"^",2)_"^"_PSOX("IRXN")_"^"_ANQDATA,^PS(52.52,"A",PSOX("IRXN"),+Y)="" K ANQDATA,X,Y,%,ANQREM
"RTN","PSON52",120,0)
 ;
"RTN","PSON52",121,0)
 N PSOTFIN
"RTN","PSON52",122,0)
 I $D(PSOX("NOPSDRPH"))!('$D(^XUSEC("PSORPH",DUZ))) S PSOTFIN="",PSOTFIN=$$TECH2^PSODGDGP(PSOX("IRXN"),PSODFN,DUZ,.PSOX)
"RTN","PSON52",123,0)
 I $D(PSOX("NOPSDRPH"))!('$D(^XUSEC("PSORPH",DUZ))) G FINISHP:$G(PSOTFIN)=1 G FINISHX:$G(PSOTFIN)=2
"RTN","PSON52",124,0)
 ;
"RTN","PSON52",125,0)
 I PSOX("FILL DATE")>DT,$P(PSOPAR,"^",6) S DA=PSOX("IRXN"),RXFL(PSOX("IRXN"))=0 D SUS^PSORXL K DA G FINISHX
"RTN","PSON52",126,0)
 ;
"RTN","PSON52",127,0)
 ; - Calling ECME for claims generation and transmission / REJECT handling
"RTN","PSON52",128,0)
 N ACTION,PSOERX
"RTN","PSON52",129,0)
 S PSOERX=PSOX("IRXN")
"RTN","PSON52",130,0)
 I $$SUBMIT^PSOBPSUT(PSOERX,0) D  I ACTION="Q"!(ACTION="^") Q
"RTN","PSON52",131,0)
 . S ACTION="" D ECMESND^PSOBPSU1(PSOERX,0,"","OF")
"RTN","PSON52",132,0)
 . ; Quit if there is an unresolved Tricare/CHAMPVA non-billable reject code, PSO*7*358
"RTN","PSON52",133,0)
 . I $$PSOET^PSOREJP3(PSOERX,0) S ACTION="Q" Q
"RTN","PSON52",134,0)
 . I $$FIND^PSOREJUT(PSOERX,0) D
"RTN","PSON52",135,0)
 . . S ACTION=$$HDLG^PSOREJU1(PSOERX,0,"79,88","OF","IOQ","Q")
"RTN","PSON52",136,0)
 . I $$STATUS^PSOBPSUT(PSOERX,0)="E PAYABLE" D
"RTN","PSON52",137,0)
 . . D SAVNDC^PSSNDCUT(+$$GET1^DIQ(52,PSOERX,6,"I"),$G(PSOSITE),$$GETNDC^PSONDCUT(PSOERX,0))
"RTN","PSON52",138,0)
 ;
"RTN","PSON52",139,0)
FINISHP ;
"RTN","PSON52",140,0)
 I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=PSOX("IRXN")_",",RXFL(PSOX("IRXN"))=0 G FINISHX
"RTN","PSON52",141,0)
 F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSON52",142,0)
 I $L(PSORX("PSOL",PSOX2))+$L(PSOX("IRXN"))<220 S PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_PSOX("IRXN")_","
"RTN","PSON52",143,0)
 E  S PSORX("PSOL",PSOX2+1)=PSOX("IRXN")_","
"RTN","PSON52",144,0)
 S RXFL(PSOX("IRXN"))=0
"RTN","PSON52",145,0)
FINISHX ;call to build Rx array for bingo board
"RTN","PSON52",146,0)
 I $G(PSORX("MAIL/WINDOW"))["W" S BINGCRT=1,BINGRTE="W",BBFLG=1 D BBRX^PSORN52C
"RTN","PSON52",147,0)
 K PSOX1,PSOX2
"RTN","PSON52",148,0)
 K ^TMP("PSODGI",$J),^TMP("PSOSER",$J),^TMP("PSOSERS",$J),^TMP("PSODGS",$J),^TMP("PSOTDD",$J),^TMP("PSODOSF",$J)
"RTN","PSON52",149,0)
 Q
"RTN","PSON52",150,0)
 ;
"RTN","PSON52",151,0)
SAVETIT(TITRX,MNTRX) ; Save Titration/Maintenance dose Rx information
"RTN","PSON52",152,0)
 I '$D(^PSRX(+$G(TITRX),0))!'$D(^PSRX(+$G(MNTRX),0)) Q
"RTN","PSON52",153,0)
 S $P(^PSRX(TITRX,"TIT"),"^",2,3)=MNTRX_"^1"
"RTN","PSON52",154,0)
 D RXACT^PSOBPSU2(TITRX,0,"Maintenance Rx#: "_$$GET1^DIQ(52,MNTRX,.01),"E")
"RTN","PSON52",155,0)
 S $P(^PSRX(MNTRX,"TIT"),"^",1)=TITRX
"RTN","PSON52",156,0)
 D RXACT^PSOBPSU2(MNTRX,0,"Titration Rx#: "_$$GET1^DIQ(52,TITRX,.01),"E")
"RTN","PSON52",157,0)
 Q
"RTN","PSON52",158,0)
 ;
"RTN","PSON52",159,0)
EOJ ;
"RTN","PSON52",160,0)
 ;B xref locked in routine PSONRXN
"RTN","PSON52",161,0)
 L -^PSRX("B",PSOX("IRXN")) K OTHDOS,DA,PSON52,PSOPRC,RTE,SCH,PSOX("INS"),PSONEW("INS"),PSORXED("INS"),PSONEW("ENT"),PSORXED("ENT"),OLENT
"RTN","PSON52",162,0)
 D PSOUL^PSSLOCK(PSOX("IRXN"))
"RTN","PSON52",163,0)
 Q
"RTN","PSON52",164,0)
 ;
"RTN","PSON52",165,0)
 ;;PSOX("SIG");;SIG;;1
"RTN","PSON52",166,0)
DD ;;PSOX("RX #");;0;;1
"RTN","PSON52",167,0)
 ;;PSOX("ISSUE DATE");;0;;13
"RTN","PSON52",168,0)
 ;;PSODFN;;0;;2
"RTN","PSON52",169,0)
 ;;PSOX("PATIENT STATUS");;0;;3
"RTN","PSON52",170,0)
 ;;PSOX("PROVIDER");;0;;4
"RTN","PSON52",171,0)
 ;;PSOX("CLINIC");;0;;5
"RTN","PSON52",172,0)
 ;;PSODRUG("IEN");;0;;6
"RTN","PSON52",173,0)
 ;;PSODRUG("TRADE NAME");;TN;;1
"RTN","PSON52",174,0)
 ;;PSOX("QTY");;0;;7
"RTN","PSON52",175,0)
 ;;PSOX("DAYS SUPPLY");;0;;8
"RTN","PSON52",176,0)
 ;;PSOX("# OF REFILLS");;0;;9
"RTN","PSON52",177,0)
 ;;PSOX("COPIES");;0;;18
"RTN","PSON52",178,0)
 ;;PSOX("MAIL/WINDOW");;0;;11
"RTN","PSON52",179,0)
 ;;PSOX("REMARKS");;3;;7
"RTN","PSON52",180,0)
 ;;PSOX("CLERK CODE");;0;;16
"RTN","PSON52",181,0)
 ;;PSODRUG("COST");;0;;17
"RTN","PSON52",182,0)
 ;;PSOSITE;;2;;9
"RTN","PSON52",183,0)
 ;;PSOX("LOGIN DATE");;2;;1
"RTN","PSON52",184,0)
 ;;PSOX("FILL DATE");;2;;2
"RTN","PSON52",185,0)
 ;;PSOX("PHARMACIST");;2;;3
"RTN","PSON52",186,0)
 ;;PSOX("LOT #");;2;;4
"RTN","PSON52",187,0)
 ;;PSOX("DISPENSED DATE");;2;;5
"RTN","PSON52",188,0)
 ;;PSOX("STOP DATE");;2;;6
"RTN","PSON52",189,0)
 ;;PSODRUG("NDC");;2;;7
"RTN","PSON52",190,0)
 ;;PSODRUG("DAW");;EPH;;1
"RTN","PSON52",191,0)
 ;;PSODRUG("MANUFACTURER");;2;;8
"RTN","PSON52",192,0)
 ;;PSOX("EXPIRATION DATE");;2;;11
"RTN","PSON52",193,0)
 ;;PSOX("GENERIC PROVIDER");;2;;12
"RTN","PSON52",194,0)
 ;;PSOX("RELEASED DATE/TIME");;2;;13
"RTN","PSON52",195,0)
 ;;PSOX("METHOD OF PICK-UP");;MP;;1
"RTN","PSON52",196,0)
 ;;PSOX("STATUS");;STA;;1
"RTN","PSON52",197,0)
 ;;PSOX("LAST DISPENSED DATE");;3;;1
"RTN","PSON52",198,0)
 ;;PSOX("NEXT POSSIBLE REFILL");;3;;2
"RTN","PSON52",199,0)
 ;;PSOX("COSIGNING PROVIDER");;3;;3
"RTN","PSON52",200,0)
 ;;PSOX("TYPE OF RX");;TYPE;;1
"RTN","PSON52",201,0)
 ;;PSOX("SAND");;SAND;;1
"RTN","PSON52",202,0)
 ;;PSOX("POE");;POE;;1
"RTN","PSON52",203,0)
 ;;PSOX("INS");;INS;;1
"RTN","PSONEW")
0^26^B43522881^B42013827
"RTN","PSONEW",1,0)
PSONEW ;BIR/SAB-new rx order main driver ;07/26/96
"RTN","PSONEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,32,46,94,130,268,225,251,379,390,417,313**;DEC 1997;Build 76
"RTN","PSONEW",3,0)
 ;External references L and UL^PSSLOCK supported by DBIA 2789
"RTN","PSONEW",4,0)
 ;External reference to ^VA(200 supported by DBIA 224
"RTN","PSONEW",5,0)
 ;External reference to ^XUSEC supported by DBIA 10076
"RTN","PSONEW",6,0)
 ;External reference to ^ORX1 supported by DBIA 2186
"RTN","PSONEW",7,0)
 ;External reference to ^ORX2 supported by DBIA 867
"RTN","PSONEW",8,0)
 ;External reference to ^TIUEDIT supported by DBIA 2410
"RTN","PSONEW",9,0)
 ;External reference to SAVEOC4^OROCAPI1 supported by DBIA 5729
"RTN","PSONEW",10,0)
 ;External reference to ^ORD(100.05, supported by DBIA 5731
"RTN","PSONEW",11,0)
 ;---------------------------------------------------------------
"RTN","PSONEW",12,0)
OERR ;backdoor new rx for v7
"RTN","PSONEW",13,0)
 K PSOREEDT,COPY,SPEED,PSOEDIT,DUR,DRET,PSOTITRX,PSOMTFLG N PSOCKCON,PSODAOC
"RTN","PSONEW",14,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSONEW",15,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSONEW",16,0)
AGAIN N VALMCNT K PSODRUG,PSOCOU,PSOCOUU,PSONOOR,PSORX("FN"),PSORX("DFLG"),PSOQUIT,POERR S PSORX("DFLG")=0
"RTN","PSONEW",17,0)
 W ! D HLDHDR^PSOLMUTL S (PSONEW("QFLG"),PSONEW("DFLG"),PSOQUIT)=0,PSOFROM="NEW",PSONOEDT=1
"RTN","PSONEW",18,0)
 K ORD D FULL^VALM1,^PSONEW1 ; Continue order entry
"RTN","PSONEW",19,0)
 I PSONEW("QFLG") G END
"RTN","PSONEW",20,0)
 I PSONEW("DFLG") W !,$C(7),"RX DELETED",! S:$G(POERR) POERR("DFLG")=1,VALMBCK="Q" G END
"RTN","PSONEW",21,0)
 D:$P($G(PSOPAR),"^",7)=1 AUTO^PSONRXN I $P($G(PSOPAR),"^",7)'=1 S PSOX=PSONEW("RX #") D CHECK^PSONRXN
"RTN","PSONEW",22,0)
 I PSONEW("DFLG")!PSONEW("QFLG") D DEL S:$G(POERR) POERR("DFLG")=1,VALMBCK="R" G END
"RTN","PSONEW",23,0)
 D NOOR I PSONEW("DFLG") D DEL G END
"RTN","PSONEW",24,0)
 D ^PSONEW2 I PSONEW("DFLG") D DEL S:$G(POERR) POERR("DFLG")=1,VALMBCK="R" G END ; Asks if correct
"RTN","PSONEW",25,0)
 G:$G(PSORX("FN")) END
"RTN","PSONEW",26,0)
 D EN^PSON52(.PSONEW) ; Files entry in File 52
"RTN","PSONEW",27,0)
 D NPSOSD^PSOUTIL(.PSONEW) ; Adds newly added rx to PSOSD array
"RTN","PSONEW",28,0)
 S VALMBCK="R"
"RTN","PSONEW",29,0)
 ;
"RTN","PSONEW",30,0)
 ; - Possible Titration prescription
"RTN","PSONEW",31,0)
 I $G(PSONEW("IRXN")) D MARK^PSOOTMRX(PSONEW("IRXN"),0)
"RTN","PSONEW",32,0)
 ;
"RTN","PSONEW",33,0)
END D EOJ ; Clean up          
"RTN","PSONEW",34,0)
 I '$G(PSORX("FN")) W ! K DIR,DIRUT,DUOUT,DTOUT S DIR(0)="Y",DIR("B")="YES",DIR("A")="Another New Order for "_PSORX("NAME") D ^DIR K DIR,DIRUT,DUOUT,DTOUT I Y K PSONEW,PSDRUG,ORD G AGAIN
"RTN","PSONEW",35,0)
 D ^PSOBUILD,BLD^PSOORUT1 S X=PSODFN_";DPT(" D ULK^ORX2 D UL^PSSLOCK(PSODFN)
"RTN","PSONEW",36,0)
 D RV^PSOORFL
"RTN","PSONEW",37,0)
 S VALMBCK="R" K PSORX("FN") Q
"RTN","PSONEW",38,0)
 ;----------------------------------------------------------------
"RTN","PSONEW",39,0)
DEL ;
"RTN","PSONEW",40,0)
 W !,$C(7),"RX DELETED",!
"RTN","PSONEW",41,0)
 I $P($G(PSOPAR),"^",7)=1 D
"RTN","PSONEW",42,0)
 . S DIE="^PS(59,",DA=PSOSITE,PSOY=$O(PSONEW("OLD LAST RX#",""))
"RTN","PSONEW",43,0)
 . S PSOX=PSONEW("OLD LAST RX#",PSOY)
"RTN","PSONEW",44,0)
 . L +^PS(59,+PSOSITE,PSOY):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSONEW",45,0)
 . S DR=$S(PSOY=8:"2003////"_PSOX,PSOY=3:"1002.1////"_PSOX,1:"2003////"_PSOX)
"RTN","PSONEW",46,0)
 . D:PSOX<$P(^PS(59,+PSOSITE,PSOY),"^",3) ^DIE K DIE,X,Y
"RTN","PSONEW",47,0)
 . L -^PS(59,+PSOSITE,PSOY)
"RTN","PSONEW",48,0)
 . K PSOX,PSOY Q
"RTN","PSONEW",49,0)
EOJ ;
"RTN","PSONEW",50,0)
 I $D(PSONEW("RX #")) L -^PSRX("B",PSONEW("RX #")) ; +Lock set in PSONRXN
"RTN","PSONEW",51,0)
 K PSONOEDT,PSONEW,PSODRUG,ANQDATA,LSI,C,MAX,MIN,NDF,REF,SIG,SER,PSOFLAG,PSOHI,PSOLO,PSONOOR,PSOCOUU,PSOCOU,PSORX("EDIT")
"RTN","PSONEW",52,0)
 D CLEAN^PSOVER1
"RTN","PSONEW",53,0)
 K ^TMP("PSORXDC",$J),RORD,ACOM,ACNT,CRIT,DEF,F1,GG,I1,IEN,INDT,LAST,MSG,NIEN,STA,DUR,DRET,PSOPRC
"RTN","PSONEW",54,0)
 S (ZRXN,RXN)=$O(^TMP("PSORXN",$J,0)) I RXN D
"RTN","PSONEW",55,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSONEW",56,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS","")
"RTN","PSONEW",57,0)
 .;saves drug allergy order chks pso*7*390
"RTN","PSONEW",58,0)
 .I +$G(^TMP("PSODAOC",$J,1,0)) D
"RTN","PSONEW",59,0)
 ..S RXN=ZRXN,PSODAOC="Rx Backdoor "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"NEW Order Acceptance_OP"
"RTN","PSONEW",60,0)
 ..D DAOC
"RTN","PSONEW",61,0)
 K ZRXN,RXN,RXN1,^TMP("PSORXN",$J),^TMP("PSODAOC",$J),RET,PSODAOC
"RTN","PSONEW",62,0)
 I $G(PSONOTE) D FULL^VALM1,MAIN^TIUEDIT(3,.TIUDA,PSODFN,"","","","",1)
"RTN","PSONEW",63,0)
 K PSONOTE,PSOCKCON
"RTN","PSONEW",64,0)
 ;W !! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR K DIR,DTOUT,DUOUT
"RTN","PSONEW",65,0)
 Q
"RTN","PSONEW",66,0)
NOOR ;asks nature of order
"RTN","PSONEW",67,0)
 N PSONOODF
"RTN","PSONEW",68,0)
 S PSONOODF=0
"RTN","PSONEW",69,0)
 I $G(OR0) D  G NOORX ;front door
"RTN","PSONEW",70,0)
 .S PSOI=$S($G(PSOSIGFL):1,$G(PSODRUG("OI"))'=$P(OR0,"^",8):1,1:0) I 'PSOI S PSONOOR="" D:$D(^XUSEC("PSORPH",DUZ)) COUN Q  ;NoO $P(OR0,"^",7)
"RTN","PSONEW",71,0)
 .S PSONOODF=1
"RTN","PSONEW",72,0)
 .D DIR I $D(DIRUT) S PSONEW("DFLG")=1 Q
"RTN","PSONEW",73,0)
 .S PSONOOR=Y D:$D(^XUSEC("PSORPH",DUZ)) COUN K DIR,DTOUT,DTOUT,DIRUT
"RTN","PSONEW",74,0)
 ;backdoor order
"RTN","PSONEW",75,0)
 D DIR I $D(DIRUT) S PSONEW("DFLG")=1,VALMBCK="Q" Q
"RTN","PSONEW",76,0)
 S PSONOOR=Y K DIK,DA,DIE,DR,PSOI,DIR,DUOUT,DTOUT,DIRUT
"RTN","PSONEW",77,0)
 G:'$D(^XUSEC("PSORPH",DUZ)) NOORX
"RTN","PSONEW",78,0)
COUN ;patient counseling
"RTN","PSONEW",79,0)
 G:$G(PSORX("EDIT"))&('$G(PSOSIGFL)) NOORX K DIR,DUOUT,DTOUT,DIRUT
"RTN","PSONEW",80,0)
 S DIR("B")="NO",DIR(0)="52,41" D ^DIR S PSOCOU=$S(Y:Y,1:0)
"RTN","PSONEW",81,0)
 I $D(DIRUT)!('PSOCOU) S PSOCOUU=0 D:'$G(SPEED) PRONTE Q
"RTN","PSONEW",82,0)
 K:'$G(PSOCOU) PSOCOUU K DIR,DUOUT,DTOUT,DIRUT I Y S DIR(0)="52,42",DIR("B")="NO" D ^DIR S PSOCOUU=$S(Y:Y,1:0)
"RTN","PSONEW",83,0)
PRONTE K PSONOTE,DIR,DIRUT,DUOUT
"RTN","PSONEW",84,0)
 I $T(MAIN^TIUEDIT)]"",'$G(SPEED) D  K DIR,DIRUT,DUOUT
"RTN","PSONEW",85,0)
 .S DIR(0)="Y",DIR("B")="No",DIR("A")="Do you want to enter a Progress Note",DIR("A",1)="" D ^DIR K DIR
"RTN","PSONEW",86,0)
 .S PSONOTE=+Y Q  ;I 'Y!($D(DIRUT)) Q
"RTN","PSONEW",87,0)
NOORX K X,Y,DIR,DUOUT,DTOUT,DIRUT
"RTN","PSONEW",88,0)
 Q
"RTN","PSONEW",89,0)
DIR ;ask nature of order
"RTN","PSONEW",90,0)
 K DIR,DTOUT,DTOUT,DIRUT I $T(NA^ORX1)]""  D  Q
"RTN","PSONEW",91,0)
 .S PSONOOR=$$NA^ORX1($S($G(PSONOODF)!($G(PSONOBCK)):"S",1:"W"),0,"B","Nature of Order",0,"WPSDIVR"_$S(+$G(^VA(200,DUZ,"PS")):"E",1:""))
"RTN","PSONEW",92,0)
 .I +PSONOOR S (Y,PSONOOR)=$P(PSONOOR,"^",3) Q
"RTN","PSONEW",93,0)
 .S DIRUT=1 K PSONOOR
"RTN","PSONEW",94,0)
 I $D(PSONOOR) S DF=PSONOOR,PSONODF=$S(DF="E":"PROVIDER ENTERED",DF="V":"VERBAL",DF="P":"TELEPHONE",DF="D":"DUPLICATE",DF="S":"SERVICE CORRECTED",DF="I":"POLICY",DF="R":"SERVICE REJECTED",1:"WRITTEN")
"RTN","PSONEW",95,0)
 K DIR,DTOUT,DTOUT,DIRUT S DIR("A")="Nature of Order: ",DIR("B")=$S($D(PSONOOR):PSONODF,1:"WRITTEN")
"RTN","PSONEW",96,0)
 S DIR(0)="SA^W:WRITTEN;V:VERBAL;P:TELEPHONE;S:SERVICE CORRECTED;D:DUPLICATE;I:POLICY;R:SERVICE REJECTED"_$S(+$G(^VA(200,DUZ,"PS")):";E:PROVIDER ENTERED",1:"")
"RTN","PSONEW",97,0)
 D ^DIR K DF,PSONODF Q:$D(DIRUT)  S PSONOOR=Y
"RTN","PSONEW",98,0)
DIRX Q
"RTN","PSONEW",99,0)
 ;
"RTN","PSONEW",100,0)
NOORE(PSONEW) ;entry point for renew
"RTN","PSONEW",101,0)
 D NOOR I $D(DIRUT) S PSONEW("DFLG")=1 Q
"RTN","PSONEW",102,0)
 S PSONEW("NOO")=PSONOOR
"RTN","PSONEW",103,0)
 Q
"RTN","PSONEW",104,0)
DAOC ;stores drug allergies w/sign/symptoms
"RTN","PSONEW",105,0)
 Q:'$D(^TMP("PSODAOC",$J,1,0))
"RTN","PSONEW",106,0)
 N DA,OCCDT,ORN,ORL,Z,RET S OCCDT=$$NOW^XLFDT,ORN=$P(^PSRX(RXN,"OR1"),"^",2)
"RTN","PSONEW",107,0)
 S ORL(1,1)=ORN_"^"_PSODAOC_"^"_DUZ_"^"_OCCDT_"^3^"
"RTN","PSONEW",108,0)
 S ORL(1,2)="A Drug-Allergy Reaction exists for this medication and/or class"
"RTN","PSONEW",109,0)
 D SAVEOC^OROCAPI1(.ORL,.RET)
"RTN","PSONEW",110,0)
 S DA=$O(RET(1,0)) Q:'DA
"RTN","PSONEW",111,0)
 S $P(^ORD(100.05,DA,0),"^",2)=6
"RTN","PSONEW",112,0)
 S ^ORD(100.05,DA,4,0)="100.517PA^1^1"
"RTN","PSONEW",113,0)
 S ^ORD(100.05,DA,4,1,0)=^TMP("PSODAOC",$J,1,0)
"RTN","PSONEW",114,0)
 S ^ORD(100.05,DA,4,"B",$P(^TMP("PSODAOC",$J,1,0),"^"),1)=""
"RTN","PSONEW",115,0)
 ;
"RTN","PSONEW",116,0)
 I $O(^TMP("PSODAOC",$J,1,0)) F I=0:0 S I=$O(^TMP("PSODAOC",$J,1,I)) Q:'I  D
"RTN","PSONEW",117,0)
 .S ^ORD(100.05,DA,4,1,1,0)="100.5173PA^"_I_"^"_I
"RTN","PSONEW",118,0)
 .S ^ORD(100.05,DA,4,1,1,I,0)=^TMP("PSODAOC",$J,1,I)
"RTN","PSONEW",119,0)
 .S ^ORD(100.05,DA,4,1,1,"B",^TMP("PSODAOC",$J,1,I),I)=""
"RTN","PSONEW",120,0)
 ;
"RTN","PSONEW",121,0)
 I $O(^TMP("PSODAOC",$J,2,0)) S Z=0 F I=0:0 S I=$O(^TMP("PSODAOC",$J,2,I)) Q:'I  S Z=Z+1 D
"RTN","PSONEW",122,0)
 .S ^ORD(100.05,DA,4,1,2,0)="100.5174PA^"_Z_"^"_Z
"RTN","PSONEW",123,0)
 .S ^ORD(100.05,DA,4,1,2,Z,0)=^TMP("PSODAOC",$J,2,I)
"RTN","PSONEW",124,0)
 .S ^ORD(100.05,DA,4,1,2,"B",^TMP("PSODAOC",$J,2,I),Z)=""
"RTN","PSONEW",125,0)
 ;
"RTN","PSONEW",126,0)
 I $O(^TMP("PSODAOC",$J,3,0)) F I=0:0 S I=$O(^TMP("PSODAOC",$J,3,I)) Q:'I  D
"RTN","PSONEW",127,0)
 .S ^ORD(100.05,DA,4,1,3,0)="100.5175PA^"_I_"^"_I
"RTN","PSONEW",128,0)
 .S ^ORD(100.05,DA,4,1,3,I,0)=^TMP("PSODAOC",$J,3,I)
"RTN","PSONEW",129,0)
 .S ^ORD(100.05,DA,4,1,3,"B",^TMP("PSODAOC",$J,3,I),I)=""
"RTN","PSONEW",130,0)
 K ^TMP("PSODAOC",$J)
"RTN","PSONEW",131,0)
 Q
"RTN","PSOORCPY")
0^27^B32700347^B21376105
"RTN","PSOORCPY",1,0)
PSOORCPY ;BIR/SAB-copy orders from backdoor ;10/17/96
"RTN","PSOORCPY",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,21,27,32,46,100,117,148,313**;DEC 1997;Build 76
"RTN","PSOORCPY",3,0)
 ;External references LK^ORX2 and ULK^ORX2 supported by DBIA 867
"RTN","PSOORCPY",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORCPY",5,0)
 ;External references L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOORCPY",6,0)
 ;I '$D(^XUSEC("PSORPH",DUZ)) S VALMSG="Invalid Action Selection!",VALMBCK="" Q
"RTN","PSOORCPY",7,0)
 ;
"RTN","PSOORCPY",8,0)
 ; Cleaning up Titration/Maintenance variables (they shouldn't be defined - just to be safe)
"RTN","PSOORCPY",9,0)
 K PSOMTFLG,PSOTITRX
"RTN","PSOORCPY",10,0)
COPY ; Rx Copy Functionality 
"RTN","PSOORCPY",11,0)
 I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2),,.VALMSG,.VALMBCK) Q
"RTN","PSOORCPY",12,0)
 I '$G(PSOMTFLG),$$TITRX^PSOUTL($P(PSOLST(ORN),"^",2))="t" S VALMSG="Cannot Copy a 'Titration Rx'.",VALMBCK="" W $C(7) Q
"RTN","PSOORCPY",13,0)
 I $G(PSOBEDT) W $C(7),$C(7) S VALMSG="Invalid Action at this time !",VALMBCK="" Q
"RTN","PSOORCPY",14,0)
 I $G(PSONACT) W $C(7),$C(7) S VALMSG="No Pharmacy Orderable Item !",VALMBCK="" K PSOCOPY D ^PSOBUILD Q
"RTN","PSOORCPY",15,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSOORCPY",16,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSOORCPY",17,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG G EX
"RTN","PSOORCPY",18,0)
 N VALMCNT K PSOEDIT S (PSOCOPY,COPY,PSORXED)=1 D FULL^VALM1
"RTN","PSOORCPY",19,0)
 S PSORXED("DFLG")=0,(RXN,DA,PSORXED("IRXN"))=$P(PSOLST(ORN),"^",2),PSORXED("RX0")=^PSRX(PSORXED("IRXN"),0),PSORXED("RX2")=$G(^(2)),PSORXED("RX3")=$G(^(3)),PSOI=$P($G(^("OR1")),"^"),PSOSIG=$P($G(^("SIG")),"^"),STAT=+^("STA")
"RTN","PSOORCPY",20,0)
 S PSORXED("INS")=$G(^PSRX(PSORXED("IRXN"),"INS"))
"RTN","PSOORCPY",21,0)
 S:$G(^PSRX(PSORXED("IRXN"),"INSS"))]"" PSORXED("SINS")=^PSRX(PSORXED("IRXN"),"INSS")
"RTN","PSOORCPY",22,0)
 S D=0 F  S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORCPY",23,0)
 I '$O(PSORXED("SIG",0)),$G(PSORXED("INS"))]"" S PSORXED("SIG",1)=PSORXED("INS")
"RTN","PSOORCPY",24,0)
 I $G(^PSRX(PSORXED("IRXN"),"TN"))]"" S PSODRUG("TRADE NAME")=^PSRX(PSORXED("IRXN"),"TN")
"RTN","PSOORCPY",25,0)
 ;
"RTN","PSOORCPY",26,0)
 ; - This call copies the dosage into the new order and also split the Maintenance dose (if the case)
"RTN","PSOORCPY",27,0)
 D BLDDOSE(.PSORXED,$G(PSOMTFLG))
"RTN","PSOORCPY",28,0)
 ;
"RTN","PSOORCPY",29,0)
 I $G(^PSDRUG($P(PSORXED("RX0"),"^",6),"I"))]"",^("I")<DT S VALMSG=$S('$G(PSOMTFLG):"Cannot COPY. ",1:"")_"This drug has been inactivated!" S VALMBCK="R" G OUT
"RTN","PSOORCPY",30,0)
 I $P(^PSDRUG($P(PSORXED("RX0"),"^",6),2),"^",3)'["O" S VALMSG=$S('$G(PSOMTFLG):"Cannot COPY. ",1:"")_"Drug no longer used by Outpatient!",VALMBCK="R" G OUT
"RTN","PSOORCPY",31,0)
 ;Check for invalid Dosage
"RTN","PSOORCPY",32,0)
 N PSOOCPRX,PSOOLPF,PSOOLPD,PSONOSIG S PSOOCPRX=PSORXED("IRXN") D CDOSE^PSORENW0
"RTN","PSOORCPY",33,0)
 I PSOOLPF D  S VALMBCK="R" G OUT
"RTN","PSOORCPY",34,0)
 .S VALMSG=$S('$G(PSOMTFLG):"Cannot COPY. ",1:"")_"Invalid Dosage of "_$G(PSOOLPD)
"RTN","PSOORCPY",35,0)
 I PSONOSIG D  S VALMBCK="R" G OUT
"RTN","PSOORCPY",36,0)
 .S VALMSG=$S('$G(PSOMTFLG):"Cannot COPY. ",1:"")_"Missing Sig"
"RTN","PSOORCPY",37,0)
 I '$P($G(^PSDRUG($P(PSORXED("RX0"),"^",6),2)),"^") S VALMBCK="R" G OUT
"RTN","PSOORCPY",38,0)
 S DREN=$P(PSORXED("RX0"),"^",6),PSODAYS=$P(PSORXED("RX0"),"^",8)
"RTN","PSOORCPY",39,0)
 S PSORXST=+$P($G(^PS(53,$P(PSORXED("RX0"),"^",3),0)),"^",7)
"RTN","PSOORCPY",40,0)
 S POERR=1 D DRG^PSOORDRG K POERR
"RTN","PSOORCPY",41,0)
 I $G(PSORX("DFLG")) S VALMBCK="R"
"RTN","PSOORCPY",42,0)
 ;
"RTN","PSOORCPY",43,0)
 I $G(PSOMTFLG) D  I $G(PSORXED("DFLG")) S VALMBCK="R" G OUT
"RTN","PSOORCPY",44,0)
 . S PSORXED("DAYS SUPPLY")=PSODAYS,PSORXED("QTY")=+$$GET1^DIQ(52,PSORXED("IRXN"),7)
"RTN","PSOORCPY",45,0)
 . W !!,"New Maintenance Rx (Review Quantity):",!,"Drug: ",$$GET1^DIQ(52,PSORXED("IRXN"),6)
"RTN","PSOORCPY",46,0)
 . D EN^PSOFSIG(.PSORXED,1) W !,"Days Supply: ",PSODAYS
"RTN","PSOORCPY",47,0)
 . N PSOQTY S PSORXED("FLD")=5 D QTY^PSODIR1(.PSORXED) W !
"RTN","PSOORCPY",48,0)
 ;
"RTN","PSOORCPY",49,0)
 D EN^PSOORED1(.PSORXED) I $G(PSORX("FN")) S VALMBCK="Q",PSOFROM="NEW" D DCORD^PSONEW2
"RTN","PSOORCPY",50,0)
 E  S VALMBCK="R"
"RTN","PSOORCPY",51,0)
OUT ;
"RTN","PSOORCPY",52,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOORCPY",53,0)
 K PSOCOPY D ^PSOBUILD,ACT^PSOORNE2
"RTN","PSOORCPY",54,0)
EX S X=PSODFN_";DPT(" D ULK^ORX2
"RTN","PSOORCPY",55,0)
 D UL^PSSLOCK(PSODFN)
"RTN","PSOORCPY",56,0)
 K PSOMSG,PSONEW,PSOSIG,STA,DREN,PSODAYS,PSORXST,PSOCOPY,PSORXED,FST,FLD,IEN,FLN,INCOM,PSOI,COPY,SIG,SIGOK
"RTN","PSOORCPY",57,0)
 K PSODRUG,^TMP("PSOPO",$J),PSOMTFLG
"RTN","PSOORCPY",58,0)
 D CLEAN^PSOVER1,EOJ^PSONEW
"RTN","PSOORCPY",59,0)
 Q
"RTN","PSOORCPY",60,0)
LOCK ;
"RTN","PSOORCPY",61,0)
 I $P($G(PSOPLCK),"^")'=0 Q
"RTN","PSOORCPY",62,0)
 W !!,$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2),1:"Another person")_" is working on this patient."
"RTN","PSOORCPY",63,0)
 K DIR S DIR(0)="E",DIR("A")="     Press Return to Continue" D ^DIR K DIR
"RTN","PSOORCPY",64,0)
 Q
"RTN","PSOORCPY",65,0)
 ;
"RTN","PSOORCPY",66,0)
BLDDOSE(PSORXED,MAINTRXF) ; Copies the Dose from Original Rx into Copied/Maintenance Dose Rx
"RTN","PSOORCPY",67,0)
 N DOSEIEN,DOSE
"RTN","PSOORCPY",68,0)
 ; - Copying from the last THEN conjunction (Maintenance Dose Rx)
"RTN","PSOORCPY",69,0)
 ; - For Titration/Maintenance, DOSEIEN = the IEN in the prescription of the last THEN conjunction.
"RTN","PSOORCPY",70,0)
 ; - This value is used as a "seed" for the FOR loop starting point.
"RTN","PSOORCPY",71,0)
 I $G(MAINTRXF) D  Q
"RTN","PSOORCPY",72,0)
 . D LASTTHEN
"RTN","PSOORCPY",73,0)
 . S PSORXED("ENT")=0
"RTN","PSOORCPY",74,0)
 . F  S DOSEIEN=$O(^PSRX(PSORXED("IRXN"),6,DOSEIEN))  Q:'DOSEIEN  D
"RTN","PSOORCPY",75,0)
 . . S DOSE=^PSRX(PSORXED("IRXN"),6,DOSEIEN,0) D
"RTN","PSOORCPY",76,0)
 . . Q:$P(DOSE,"^")']""!($P(DOSE,"^",8)']"")
"RTN","PSOORCPY",77,0)
 . . S PSORXED("ENT")=PSORXED("ENT")+1
"RTN","PSOORCPY",78,0)
 . . D SETDOSE(.PSORXED,DOSEIEN,PSORXED("ENT"))
"RTN","PSOORCPY",79,0)
 . . D EN^PSOFSIG(.PSORXED)
"RTN","PSOORCPY",80,0)
 ;
"RTN","PSOORCPY",81,0)
 ; - Copying dose for Regular Rx Copy
"RTN","PSOORCPY",82,0)
 S PSORXED("ENT")=0
"RTN","PSOORCPY",83,0)
 F DOSEIEN=0:0 S DOSEIEN=$O(^PSRX(PSORXED("IRXN"),6,DOSEIEN)) Q:'DOSEIEN  D
"RTN","PSOORCPY",84,0)
 . S DOSE=^PSRX(PSORXED("IRXN"),6,DOSEIEN,0) D
"RTN","PSOORCPY",85,0)
 . Q:$P(DOSE,"^")']""!($P(DOSE,"^",8)']"")
"RTN","PSOORCPY",86,0)
 . S PSORXED("ENT")=PSORXED("ENT")+1
"RTN","PSOORCPY",87,0)
 . D SETDOSE(.PSORXED,DOSEIEN,PSORXED("ENT"))
"RTN","PSOORCPY",88,0)
 Q
"RTN","PSOORCPY",89,0)
 ;
"RTN","PSOORCPY",90,0)
SETDOSE(PSORXED,DOSEIEN,DOSESEQ) ; Sets the Dose in the PSORXED array
"RTN","PSOORCPY",91,0)
 N DOSE
"RTN","PSOORCPY",92,0)
 S DOSE=^PSRX(PSORXED("IRXN"),6,DOSEIEN,0)
"RTN","PSOORCPY",93,0)
 S PSORXED("DOSE",DOSESEQ)=$P(DOSE,"^")
"RTN","PSOORCPY",94,0)
 S PSORXED("UNITS",DOSESEQ)=$P(DOSE,"^",3)
"RTN","PSOORCPY",95,0)
 S PSORXED("DOSE ORDERED",DOSESEQ)=$P(DOSE,"^",2)
"RTN","PSOORCPY",96,0)
 S PSORXED("ROUTE",DOSESEQ)=$P(DOSE,"^",7)
"RTN","PSOORCPY",97,0)
 S PSORXED("SCHEDULE",DOSESEQ)=$P(DOSE,"^",8)
"RTN","PSOORCPY",98,0)
 S PSORXED("DURATION",DOSESEQ)=$P(DOSE,"^",5)
"RTN","PSOORCPY",99,0)
 S PSORXED("CONJUNCTION",DOSESEQ)=$P(DOSE,"^",6)
"RTN","PSOORCPY",100,0)
 S PSORXED("VERB",DOSESEQ)=$P(DOSE,"^",9)
"RTN","PSOORCPY",101,0)
 I $G(^PSRX(PSORXED("IRXN"),6,DOSEIEN,1))]"" D
"RTN","PSOORCPY",102,0)
 . S PSORXED("ODOSE",DOSESEQ)=^PSRX(PSORXED("IRXN"),6,DOSEIEN,1)
"RTN","PSOORCPY",103,0)
 I $G(PSORXED("DURATION",DOSESEQ))]"" D  K DR,DUR1
"RTN","PSOORCPY",104,0)
 . S DUR1=PSORXED("DURATION",DOSESEQ)
"RTN","PSOORCPY",105,0)
 . S PSORXED("DURATION",DOSESEQ)=$S($E(DUR1,1)'?.N:$E(DUR1,2,99)_$E(DUR1,1),1:DUR1)
"RTN","PSOORCPY",106,0)
 S PSORXED("NOUN",DOSESEQ)=$P(DOSE,"^",4)
"RTN","PSOORCPY",107,0)
 Q
"RTN","PSOORCPY",108,0)
 ;
"RTN","PSOORCPY",109,0)
LASTTHEN ; Determine the IEN of the last THEN conjunction on this prescription and set DOSEIEN to its value.
"RTN","PSOORCPY",110,0)
 N LASTTHEN,LAST
"RTN","PSOORCPY",111,0)
 S LASTTHEN="" F  S LASTTHEN=$O(^PSRX(PSORXED("IRXN"),6,LASTTHEN),-1) Q:LASTTHEN=""!($G(DOSEIEN)'="")  D
"RTN","PSOORCPY",112,0)
 . S DOSEIEN=""
"RTN","PSOORCPY",113,0)
 . S LAST=^PSRX(PSORXED("IRXN"),6,LASTTHEN,0)
"RTN","PSOORCPY",114,0)
 . I $P(LAST,"^",6)="T" S DOSEIEN=LASTTHEN Q
"RTN","PSOORCPY",115,0)
 Q
"RTN","PSOORED1")
0^42^B73633714^B68466079
"RTN","PSOORED1",1,0)
PSOORED1 ;ISC-BHAM/SAB - edit orders from backdoor ;5/10/07 8:25am
"RTN","PSOORED1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**5,23,46,78,114,117,131,146,223,148,244,249,268,206,313**;DEC 1997;Build 76
"RTN","PSOORED1",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOORED1",4,0)
 ;External reference ^PS(50.7 supported by DBIA 2223
"RTN","PSOORED1",5,0)
 ;
"RTN","PSOORED1",6,0)
 ;*244 call to remove DC'd Rx's from Rx ien strings
"RTN","PSOORED1",7,0)
 ;
"RTN","PSOORED1",8,0)
EN(PSORENW) ;
"RTN","PSOORED1",9,0)
 N LST,ORD,ORN K VALMBCK,PSORX("FN") S PSOAC=1,(PSORX("QFLG"),PSORX("DFLG"))=0 ;D DREN^PSOORNW2,INIT
"RTN","PSOORED1",10,0)
 D INIT
"RTN","PSOORED1",11,0)
 D @$S($P(PSOPAR,"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN")
"RTN","PSOORED1",12,0)
 I '$D(PSONEW("RX #")),'$P(PSOPAR,"^",7) D PAUSE^VALM1 K VALMSG,PSONEW("QFLG") S VALMBCK="Q" Q
"RTN","PSOORED1",13,0)
 I '$D(PSONEW("RX #")) K VALMSG D DEL^PSONEW,PAUSE^VALM1 S VALMBCK="Q" Q
"RTN","PSOORED1",14,0)
 S PSORENW("RX #")=PSONEW("RX #") I '$P(PSOPAR,"^",7) D  Q:$G(PSONEW("DFLG"))!($G(PSONEW("QFLG")))
"RTN","PSOORED1",15,0)
 .S PSOX=PSORENW("RX #") D CHECK^PSONRXN
"RTN","PSOORED1",16,0)
 I $G(PSONEW("DFLG"))!$G(PSONEW("QFLG")) D DEL^PSONEW,PAUSE^VALM1 S VALMBCK="Q" K PSORENW Q
"RTN","PSOORED1",17,0)
 D EN^PSOORNE1(.PSORENW) I '$G(PSORX("FN")) D:$P($G(PSOPAR),"^",7)=1  S VALMBCK="Q" Q
"RTN","PSOORED1",18,0)
 .S DIE="^PS(59,",DA=PSOSITE,PSOY=$O(PSONEW("OLD LAST RX#","")),PSOX=PSONEW("OLD LAST RX#",PSOY)
"RTN","PSOORED1",19,0)
 .L +^PS(59,+PSOSITE,PSOY):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSOORED1",20,0)
 .S DR=$S(PSOY=8:"2003////"_PSOX,PSOY=3:"1002.1////"_PSOX,1:"2003////"_PSOX)
"RTN","PSOORED1",21,0)
 .D:PSOX<$P(^PS(59,+PSOSITE,PSOY),"^",3) ^DIE K DIE,X,Y L -^PS(59,+PSOSITE,PSOY)
"RTN","PSOORED1",22,0)
 .I $D(PSONEW("RX #")) L -^PSRX("B",PSONEW("RX #"))
"RTN","PSOORED1",23,0)
 .K PSOX,PSOY Q
"RTN","PSOORED1",24,0)
 Q:$G(COPY)
"RTN","PSOORED1",25,0)
TRY S $P(^PSRX(PSORENW("OIRXN"),"STA"),"^")=15,DA=PSORENW("OIRXN")
"RTN","PSOORED1",26,0)
 S $P(^PSRX(DA,3),"^",5)=DT,$P(^PSRX(DA,3),"^",10)=$P(^PSRX(DA,3),"^")
"RTN","PSOORED1",27,0)
 D REVERSE^PSOBPSU1(DA,,"DC",7),CAN^PSOTPCAN(DA)
"RTN","PSOORED1",28,0)
 D RMP^PSOCAN3                ;*244
"RTN","PSOORED1",29,0)
 ;cancel/discontinue action
"RTN","PSOORED1",30,0)
 S PHARM="",STAT="RP",COMM="Prescription discontinued due to editing." D EN^PSOHLSN1(DA,STAT,PHARM,COMM,PSONOOR) K STAT,PHARM,COMM
"RTN","PSOORED1",31,0)
 S ACOM="Discontinued due to editing. New Rx created "_$P(^PSRX(PSORENW("IRXN"),0),"^")_"."
"RTN","PSOORED1",32,0)
 I $G(^PSRX(DA,"H"))]"" D
"RTN","PSOORED1",33,0)
 .I $P(^PSRX(DA,"STA"),"^")=3!($P(^("STA"),"^")=16) D
"RTN","PSOORED1",34,0)
 ..S DIE=52,DR="22///"_$P(^PSRX(DA,3),"^") D ^DIE S ACOM="Discontinued due to editing while on hold. " K:$P(^PSRX(DA,"H"),"^") ^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA)
"RTN","PSOORED1",35,0)
 ..S ^PSRX(DA,"H")=""
"RTN","PSOORED1",36,0)
 S RXDA=DA,(DA,SUSDA)=$O(^PS(52.5,"B",RXDA,0)) D:DA
"RTN","PSOORED1",37,0)
 .S SUSD=$P($G(^PS(52.5,DA,0)),"^",2)
"RTN","PSOORED1",38,0)
 .S:+$G(^PS(52.5,DA,"P"))'=1 ACOM="Discontinued due to editing while suspended."
"RTN","PSOORED1",39,0)
 .I $O(^PSRX(RXDA,1,0)) S DA=RXDA D:'$G(^PS(52.5,+SUSDA,"P")) REF^PSOCAN2
"RTN","PSOORED1",40,0)
 .S DA=SUSDA,DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOORED1",41,0)
 K SUSD,SUSDA S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2) D
"RTN","PSOORED1",42,0)
 .S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOORED1",43,0)
 .S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOORED1",44,0)
 .D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_(ACNT+1)_"^"_(ACNT+1),^PSRX(DA,"A",ACNT+1,0)=%_"^C^"_DUZ_"^"_RFCNT_"^"_$G(ACOM)
"RTN","PSOORED1",45,0)
 .I $G(PSOOIFLG),'$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Pharmacy Orderable Item Edited."
"RTN","PSOORED1",46,0)
 .I '$G(PSOOIFLG),$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Medication Route/Schedule Edited."
"RTN","PSOORED1",47,0)
 .I $G(PSOOIFLG),$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Pharmacy Orderable Item and Medication Route/Schedule Edited."
"RTN","PSOORED1",48,0)
 .S REA="C" D EXP^PSOHELP1
"RTN","PSOORED1",49,0)
 I $G(^PS(52.4,DA,0))]"" S PSCDA=DA,DIK="^PS(52.4," D ^DIK S DA=PSCDA K DIK,PSCDA
"RTN","PSOORED1",50,0)
 Q
"RTN","PSOORED1",51,0)
INS K X,QUIT,Y,DIR,DIRUT,DUOUT,DTOUT,DIC,INSDEL,UPMI,^TMP($J,"INS1")
"RTN","PSOORED1",52,0)
 I '$O(^PSRX(PSORXED("IRXN"),6,0)),'$O(PSORXED("DOSE",0)) D UPMI Q:$G(QUIT)  ;G INS1
"RTN","PSOORED1",53,0)
 I $G(^PSRX(PSORXED("IRXN"),"INS"))]"" S PSORXED("FLD",114)=^PSRX(PSORXED("IRXN"),"INS") K UPMI G INS1
"RTN","PSOORED1",54,0)
 K DD,GG F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"INS1",I)) Q:'I  S DD=$G(DD)+1
"RTN","PSOORED1",55,0)
 I $G(DD)=1 S PSORXED("FLD",114)=^PSRX(PSORXED("IRXN"),"INS1",$O(^PSRX(PSORXED("IRXN"),"INS1",0)),0) K UPMI,DD G INS1
"RTN","PSOORED1",56,0)
 I $O(^PSRX(PSORXED("IRXN"),"INS1",0)) D  G INSX
"RTN","PSOORED1",57,0)
 .F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"INS1",I)) Q:'I  S ^TMP($J,"INS1",I,0)=^PSRX(PSORXED("IRXN"),"INS1",I,0)
"RTN","PSOORED1",58,0)
 .S ^TMP($J,"INS1",0)=^PSRX(PSORXED("IRXN"),"INS1",0)
"RTN","PSOORED1",59,0)
 .S DIC="^TMP($J,""INS1"",",DWPK=2,DWLW=80 D EN^DIWE I $G(X)="^" K ^TMP($J,"INS1") Q
"RTN","PSOORED1",60,0)
 .I '$O(^TMP($J,"INS1",0)) S INSDEL=1
"RTN","PSOORED1",61,0)
 .S D=0 F  S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORED1",62,0)
INS1 K Y,DIR,DIRUT,DUOUT,DTOUT,DIC,X
"RTN","PSOORED1",63,0)
 I $G(UPMI) K UPMI I $G(^PS(50.7,PSODRUG("OI"),"INS"))]"" S PSORXED("FLD",114)=^PS(50.7,PSODRUG("OI"),"INS")
"RTN","PSOORED1",64,0)
 S:$G(PSORXED("FLD",114))]"" DIR("B")=PSORXED("FLD",114)
"RTN","PSOORED1",65,0)
 S DIR("?")="Enter Quick codes or Free Text",DIR(0)="52,114" D ^DIR
"RTN","PSOORED1",66,0)
 I $D(DTOUT)!($D(DUOUT))!($G(PSORXED("FLD",114))=X) K PSORXED("FLD",114) G INSX
"RTN","PSOORED1",67,0)
 I X'="",X'="@" D SIG^PSOHELP G INS1:'$D(X)
"RTN","PSOORED1",68,0)
 S PSORXED("FLD",114)=X
"RTN","PSOORED1",69,0)
 I $G(INS1)]"" W " ("_$E(INS1,2,9999999)_")"
"RTN","PSOORED1",70,0)
 G:(X']""!(X="@")) INSX
"RTN","PSOORED1",71,0)
 S (PSORXED("INS"),PSORXED("SIG",1))=$E(INS1,2,9999999) D EN^PSOFSIG(.PSORXED)
"RTN","PSOORED1",72,0)
INSX I $P($G(^PS(55,PSODFN,"LAN")),"^") K DIR D
"RTN","PSOORED1",73,0)
 .I $G(^PSRX(PSORXED("IRXN"),"INSS"))]"" S PSORXED("SINS")=^PSRX(PSORXED("IRXN"),"INSS")
"RTN","PSOORED1",74,0)
 .D SINS^PSODIR(.PSORXED) I $G(PSORXED("SINS"))']"" K ^PSRX(PSORXED("IRXN"),"INSS") Q
"RTN","PSOORED1",75,0)
 .S PSORXED("FLD",114.1)=PSORXED("SINS")
"RTN","PSOORED1",76,0)
 K DIRUT,DUOUT,DTOUT,DIR,X,Y,DIC,DWPK
"RTN","PSOORED1",77,0)
 Q
"RTN","PSOORED1",78,0)
INIT ;setup psorenw array
"RTN","PSOORED1",79,0)
 S PSORENW("RX0")=^PSRX(PSORENW("IRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN"))
"RTN","PSOORED1",80,0)
 I $G(PSOSIGFL),$G(PSORX("SIG"))]"" S PSORENW("SIG")=PSORX("SIG"),SIGOK=0
"RTN","PSOORED1",81,0)
 E  D
"RTN","PSOORED1",82,0)
 .I '$P($G(^PSRX(PSORENW("IRXN"),"SIG")),"^",2) S PSORENW("SIG")=$P($G(^("SIG")),"^")
"RTN","PSOORED1",83,0)
 .E  D
"RTN","PSOORED1",84,0)
 ..S SIGOK=1 Q:$O(SIG(0))
"RTN","PSOORED1",85,0)
 ..S D=0 F I=0:0 S D=D+1,I=$O(^PSRX(PSORENW("IRXN"),"SIG1",I)) Q:'I  S SIG(D)=^PSRX(PSORENW("IRXN"),"SIG1",I,0)
"RTN","PSOORED1",86,0)
 ..K PSOX1,D
"RTN","PSOORED1",87,0)
 S PSORENW("OIRXN")=PSORENW("IRXN")
"RTN","PSOORED1",88,0)
 S PSORENW("PROVIDER")=$S($G(PSORENW("PROVIDER")):PSORENW("PROVIDER"),1:$P(PSORENW("RX0"),"^",4))
"RTN","PSOORED1",89,0)
 S (PSORENW("PROVIDER NAME"),PSORX("PROVIDER NAME"))=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSOORED1",90,0)
 I $P($G(^VA(200,PSORENW("PROVIDER"),"PS")),"^",7),$P($G(^("PS")),"^",8) S PSORENW("COSIGNING PROVIDER")=$P($G(^("PS")),"^",8)
"RTN","PSOORED1",91,0)
 S PSORENW("CLINIC")=$S($G(PSORENW("CLINIC")):PSORENW("CLINIC"),1:$P(PSORENW("RX0"),"^",5))
"RTN","PSOORED1",92,0)
 S PSORENW("REMARKS")="New Order Created by "_$S($G(COPY)&('$G(PSOEDIT)):"copying",1:"editing")_" Rx # "_$P(PSORENW("RX0"),"^")_"."
"RTN","PSOORED1",93,0)
 ;
"RTN","PSOORED1",94,0)
 ; - Maintenance Dose Rx Remarks field
"RTN","PSOORED1",95,0)
 I $G(PSOMTFLG) S PSORENW("REMARKS")="Maintenance Rx created from Titration Rx# "_$P(PSORENW("RX0"),"^")_"."
"RTN","PSOORED1",96,0)
 ;
"RTN","PSOORED1",97,0)
 S PSORENW("COSIGNER")=$S($G(PSORENW("COSIGNER")):PSORENW("COSIGNER"),$P(PSORENW("RX3"),"^",3):$P(PSORENW("RX3"),"^",3),1:"")
"RTN","PSOORED1",98,0)
 K:PSORENW("COSIGNER")="" PSORENW("COSIGNER")
"RTN","PSOORED1",99,0)
 S PSORENW("PSODFN")=$P(PSORENW("RX0"),"^",2)
"RTN","PSOORED1",100,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSOORED1",101,0)
 S:$G(PSODRUG("IEN")) PSORENW("DRUG IEN")=PSODRUG("IEN")
"RTN","PSOORED1",102,0)
 I $G(PSORENW("DAYS SUPPLY")) G QTY
"RTN","PSOORED1",103,0)
 S PSORENW("DAYS SUPPLY")=$S($D(CLOZPAT):7,1:$P(PSORENW("RX0"),"^",8))
"RTN","PSOORED1",104,0)
QTY S PSORENW("QTY")=$S($G(PSORENW("QTY")):PSORENW("QTY"),1:$P(PSORENW("RX0"),"^",7))
"RTN","PSOORED1",105,0)
RFN S PSORENW("# OF REFILLS")=$S($D(CLOZPAT):0,$G(PSORENW("# OF REFILLS")):PSORENW("# OF REFILLS"),1:$P(PSORENW("RX0"),"^",9))
"RTN","PSOORED1",106,0)
 S (PSOID,Y,PSORENW("FILL DATE"),PSORENW("ISSUE DATE"))=DT
"RTN","PSOORED1",107,0)
 ;
"RTN","PSOORED1",108,0)
 ; - Maintenance Rx Fill Date is set with Next Possible Fill from Titration Rx
"RTN","PSOORED1",109,0)
 I $G(PSOMTFLG),$P($G(PSORENW("RX3")),"^",2)>DT S PSORENW("FILL DATE")=$P(PSORENW("RX3"),"^",2)
"RTN","PSOORED1",110,0)
 ;
"RTN","PSOORED1",111,0)
 S:PSORENW("CLINIC") PSORX("CLINIC")=$P(^SC(+PSORENW("CLINIC"),0),"^")
"RTN","PSOORED1",112,0)
 S PSORENW("PATIENT STATUS")=$S($G(PSORENW("PATIENT STATUS")):PSORENW("PATIENT STATUS"),'$P(PSORENW("RX0"),"^",3):$G(^PS(55,PSORENW("PSODFN"),"PS")),1:$P(PSORENW("RX0"),"^",3))
"RTN","PSOORED1",113,0)
 S PSORENW("PTST NODE")=$G(^PS(53,PSORENW("PATIENT STATUS"),0))
"RTN","PSOORED1",114,0)
 S PSDAYS=$S($G(PSORENW("DAYS SUPPLY")):PSORENW("DAYS SUPPLY"),'$P(PSORENW("RX0"),"^",8):$P(PSORENW("PTST NODE"),"^",3),1:$P(PSORENW("RX0"),"^",8))
"RTN","PSOORED1",115,0)
 I $G(PSODRUG("IEN")) S DREN=PSODRUG("IEN"),POERR=1 D DRG^PSOORDRG K POERR
"RTN","PSOORED1",116,0)
 D:$G(PSORENW("# OF REFILLS"))']"" RF
"RTN","PSOORED1",117,0)
 ;
"RTN","PSOORED1",118,0)
 ; - Maintenance Rx # of Refills adjustment
"RTN","PSOORED1",119,0)
 I $G(PSOMTFLG),$G(PSORENW("# OF REFILLS"))>0 S PSORENW("# OF REFILLS")=PSORENW("# OF REFILLS")-1
"RTN","PSOORED1",120,0)
 ;
"RTN","PSOORED1",121,0)
 S PSORENW("MAIL/WINDOW")=$S($G(PSORENW("MAIL/WINDOW"))]"":PSORENW("MAIL/WINDOW"),1:$P(PSORENW("RX0"),"^",11))
"RTN","PSOORED1",122,0)
 S PSORX("MAIL/WINDOW")=$S(PSORENW("MAIL/WINDOW")="W":"WINDOW",1:"MAIL")
"RTN","PSOORED1",123,0)
 S PSORENW("COPIES")=$S($G(PSORENW("COPIES")):PSORENW("COPIES"),$P(PSORENW("RX0"),"^",18):$P(PSORENW("RX0"),"^",18),1:1)
"RTN","PSOORED1",124,0)
 S PSORENW("CLERK CODE")=DUZ
"RTN","PSOORED1",125,0)
 S:$G(PSORX("CLERK CODE"))']"" PSORX("CLERK CODE")=$P($G(^VA(200,DUZ,0)),"^")
"RTN","PSOORED1",126,0)
 Q:$D(COPY)  S PSORENW("ENT")=0 ;Q:$G(PSOSIGFL)!($D(COPY))
"RTN","PSOORED1",127,0)
 K PSORENW("ENT") F I=0:0 S I=$O(PSORENW("DOSE",I)) Q:'I  S PSORENW("ENT")=$G(PSORENW("ENT"))+1
"RTN","PSOORED1",128,0)
 I $O(^TMP($J,"INS1",0)) D
"RTN","PSOORED1",129,0)
 .K PSORXED("SIG"),DD
"RTN","PSOORED1",130,0)
 .F I=0:0 S I=$O(^TMP($J,"INS1",I)) Q:'I  S PSORENW("SIG",I)=^TMP($J,"INS1",I,0)
"RTN","PSOORED1",131,0)
 .K ^TMP($J,"INS1")
"RTN","PSOORED1",132,0)
 I $G(^PSRX(PSORENW("IRXN"),"INS"))]"" S PSORENW("INS")=^PSRX(PSORENW("IRXN"),"INS")
"RTN","PSOORED1",133,0)
 I $G(^PSRX(PSORENW("IRXN"),"INSS"))]"" S PSORENW("SINS")=^PSRX(PSORENW("IRXN"),"INSS")
"RTN","PSOORED1",134,0)
 I '$G(PSORENW("ENT")),'$G(PSOSIGFL) D DOLST1^PSOORED3(.PSORENW) S PSORENW("ENT")=+$G(OLENT)
"RTN","PSOORED1",135,0)
 Q
"RTN","PSOORED1",136,0)
RF ;# of refills
"RTN","PSOORED1",137,0)
 S PTRF=$S($P(PSORENW("PTST NODE"),"^",4)]"":$P(PSORENW("PTST NODE"),"^",4),1:11)
"RTN","PSOORED1",138,0)
 S CS=0 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S CS=1
"RTN","PSOORED1",139,0)
 I CS D
"RTN","PSOORED1",140,0)
 .S PSOX1=$S(PTRF>5:5,1:PTRF),PSOX=$S(PSOX1=5:5,1:PSOX1)
"RTN","PSOORED1",141,0)
 .S PSOX=$S('PSOX:0,PSDAYS=90:1,1:PSOX),PSDY1=$S(PSDAYS<60:5,PSDAYS'<60&(PSDAYS'>89):2,PSDAYS=90:1,1:0) S PSORENW("# OF REFILLS")=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORED1",142,0)
 E  D
"RTN","PSOORED1",143,0)
 .S PSOX1=PTRF,PSOX=$S(PSOX1=11:11,1:PSOX1),PSOX=$S('PSOX:0,PSDAYS=90:3,1:PSOX)
"RTN","PSOORED1",144,0)
 .S PSDY1=$S(PSDAYS<60:11,PSDAYS'<60&(PSDAYS'>89):5,PSDAYS=90:3,1:0) S PSORENW("# OF REFILLS")=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORED1",145,0)
 I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")["F")!(PSODRUG("DEA")[1)!(PSODRUG("DEA")[2) S PSORENW("# OF REFILLS")=0
"RTN","PSOORED1",146,0)
 K PSDY,PSDY1,PTRF,PSOX,PSOX1,PSDAYS,CS
"RTN","PSOORED1",147,0)
 Q
"RTN","PSOORED1",148,0)
UPMI ;add dosing data for pre-poe rxs
"RTN","PSOORED1",149,0)
 W !! K PSONEW("DFLG"),DIR,DIRUT,DTOUT,DUOUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Dosing Instructions Are Missing!! Do You Want to Add Them"
"RTN","PSOORED1",150,0)
 D ^DIR I 'Y!($D(DIRUT)) S QUIT=1 K DIR,DIRUT,DUOT,DUOUT Q
"RTN","PSOORED1",151,0)
 S UPMI=1,EDTHLD=$G(PSORX("EDIT")) K PSORX("EDIT")
"RTN","PSOORED1",152,0)
 D DOSE1^PSOORED5(.PSORXED) S (PSORXED,PSORX("EDIT"))=EDTHLD K EDTHLD I $G(PSONEW("DFLG")) S QUIT=1
"RTN","PSOORED1",153,0)
 Q
"RTN","PSOORED3")
0^33^B65846558^B61293813
"RTN","PSOORED3",1,0)
PSOORED3 ;BIR/SAB-edit finished orders through backdoor ;10/20/06 11:09am
"RTN","PSOORED3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,78,99,117,133,148,249,251,379,378,372,416,313**;DEC 1997;Build 76
"RTN","PSOORED3",3,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOORED3",4,0)
 ;External reference to PS(51.2 supported by DBIA 2226 
"RTN","PSOORED3",5,0)
 ;called from psoored2
"RTN","PSOORED3",6,0)
 D DOLST
"RTN","PSOORED3",7,0)
 ;
"RTN","PSOORED3",8,0)
DOSE ;adds dosing info
"RTN","PSOORED3",9,0)
 I '$G(PSORXED("ENT")) F  S I=$O(PSORXED("DOSE",I)) Q:'I  S PSORXED("ENT")=$G(PSORXED("ENT"))+1
"RTN","PSOORED3",10,0)
 K ROU,UNITN,STRE,PSODOSE,RTE,NOUN,VERB M PSODOSE=PSORXED
"RTN","PSOORED3",11,0)
 D KV K FIELD,DOSEOR,DOOR,X,Y,UNITS S ENT=1
"RTN","PSOORED3",12,0)
ASK S ROU="PSOORED3" D ASK^PSOBKDED K ROU I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED3",13,0)
 G:$D(DIRUT) EXQ
"RTN","PSOORED3",14,0)
 I $G(QUIT)]"" K QUIT,ROU Q
"RTN","PSOORED3",15,0)
 ;
"RTN","PSOORED3",16,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED3",17,0)
VER D VER^PSOOREDX I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED3",18,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",19,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED3",20,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED3",21,0)
DUPD ;
"RTN","PSOORED3",22,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED3",23,0)
 D DUPD^PSOOREDX
"RTN","PSOORED3",24,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:"") S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED3",25,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED3",26,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",27,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED3",28,0)
 D STR^PSOOREDX
"RTN","PSOORED3",29,0)
NOU1 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOORED3",30,0)
 D CNON
"RTN","PSOORED3",31,0)
 N PSONDEF
"RTN","PSOORED3",32,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOORED3",33,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED3",34,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",35,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED3",36,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED3",37,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED3",38,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED3",39,0)
RTE S:$G(PSORXED("ROUTE",ENT))']"" DRET=1
"RTN","PSOORED3",40,0)
 K JUMP S ROU="PSOORED3" D RTE^PSOBKDED K ROU
"RTN","PSOORED3",41,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED3",42,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",43,0)
 I $G(QUIT) K QUIT,ROU Q
"RTN","PSOORED3",44,0)
 ;
"RTN","PSOORED3",45,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED3",46,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",47,0)
 S SCH=Y D SCH^PSOSIG I $G(SCH)']"" G SCH
"RTN","PSOORED3",48,0)
 S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED3",49,0)
 S:PSORXED("ENT")<ENT PSORXED("ENT")=ENT
"RTN","PSOORED3",50,0)
 ;
"RTN","PSOORED3",51,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN MONTHS, WEEKS, DAYS, HOURS OR MINUTES)"
"RTN","PSOORED3",52,0)
 S DIR("B")=$S($G(DUR)]"":DUR,$G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED3",53,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED3",54,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",55,0)
 D DUR1^PSOOREDX
"RTN","PSOORED3",56,0)
 ;
"RTN","PSOORED3",57,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED3",58,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",59,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED3",60,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED3",61,0)
 I X="@" D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOORED3",62,0)
 ;
"RTN","PSOORED3",63,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED3",64,0)
 I '$$DUROK(.PSORXED,ENT) D  G DUR
"RTN","PSOORED3",65,0)
 . W !!,"Duration is required for the dosage entered prior to the THEN conjunction.",$C(7),!
"RTN","PSOORED3",66,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSORXED("DFLG"))!($G(PSORX("DFLG"))) EXQ S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED3",67,0)
 E  K PSOCKCON I $$DCHK^PSODOSUT S PSOQUIT=1 G EXQ
"RTN","PSOORED3",68,0)
 I PSOSAVX="",$G(PSORXED)!$D(PSOEDDOS) K PSOCKCON
"RTN","PSOORED3",69,0)
 K PSOSAVX
"RTN","PSOORED3",70,0)
 ;
"RTN","PSOORED3",71,0)
 S DENT=$O(PSORXED("DOSE",ENT)) I DENT,(ENT+1)'=DENT D
"RTN","PSOORED3",72,0)
 .K PSORXED("DOSE",DENT),PSORXED("NOUN",DENT),PSORXED("VERB",DENT),PSORXED("DOSE ORDERED",DENT),PSORXED("ROUTE",DENT),PSORXED("ODOSE",DENT)
"RTN","PSOORED3",73,0)
 .K PSORXED("SCHEDULE",DENT),PSORXED("DURATION",DENT),PSORXED("CONJUNCTION",DENT),DENT
"RTN","PSOORED3",74,0)
 I $G(FIELD)]"" K FIELD S QUIT=1
"RTN","PSOORED3",75,0)
 I $O(^PSRX(PSORXED("IRXN"),"INS1",0)) D
"RTN","PSOORED3",76,0)
 .F D=0:0 S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORED3",77,0)
 D EN^PSOFSIG(.PSORXED) D VER^PSOORED7:'$G(PSOVER) I $G(CKX),'$G(PSOSIGFL) D M1 K CKX
"RTN","PSOORED3",78,0)
 ;I $G(PSOSIGFL)=1 S PSORXED("ENT")=ENT,SIGOK=1 G EX1
"RTN","PSOORED3",79,0)
 S:'$D(PSORXED("DAYS SUPPLY")) PSORXED("DAYS SUPPLY")=$P(PSORXED("RX0"),"^",8)
"RTN","PSOORED3",80,0)
 ;Needed to calculate QTY
"RTN","PSOORED3",81,0)
 ;K QTY,QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED3",82,0)
 K QTY,QTYHLD S QTYHLD=$P(PSORXED("RX0"),"^",7) D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED3",83,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED3",84,0)
 I $G(PSOSIGFL)=1 S PSORXED("ENT")=ENT,SIGOK=1 G EX1
"RTN","PSOORED3",85,0)
 K QTYHLD Q:$G(PSOVER)!($G(PSOREEDQ))
"RTN","PSOORED3",86,0)
UDSIG I $O(SIG(0)) D
"RTN","PSOORED3",87,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSOORED3",88,0)
 .S (A,I)=0 F  S I=$O(^PSRX(PSORXED("IRXN"),"A",I)) Q:'I  S A=A+1
"RTN","PSOORED3",89,0)
 .D NOW^%DTC I $G(QTY) S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^Quantity Updated "_"("_$P(^PSRX(PSORXED("IRXN"),0),"^",7)_")",$P(^PSRX(PSORXED("IRXN"),0),"^",7)=$G(PSORXED("QTY")) K QTY
"RTN","PSOORED3",90,0)
 .S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^New Dosing Instructions Added",^PSRX(PSORXED("IRXN"),"A",A,1)="ORIGINAL SIG^" D
"RTN","PSOORED3",91,0)
 ..I '$P($G(^PSRX(PSORXED("IRXN"),"SIG")),"^",2) S $P(^PSRX(PSORXED("IRXN"),"A",A,1),"^",2)=$P($G(^PSRX(PSORXED("IRXN"),"SIG")),"^") Q
"RTN","PSOORED3",92,0)
 ..F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S ^PSRX(PSORXED("IRXN"),"A",A,2,I,0)=^PSRX(PSORXED("IRXN"),"SIG1",I,0),^PSRX(PSORXED("IRXN"),"A",A,2,0)="^52.34A^"_I_"^"_I
"RTN","PSOORED3",93,0)
 .S ^PSRX(PSORXED("IRXN"),"SIG")="^1"
"RTN","PSOORED3",94,0)
 .K SIG,A,I
"RTN","PSOORED3",95,0)
 S ^PSRX(PSORXED("IRXN"),6,0)="^52.0113^"_ENT_"^"_ENT
"RTN","PSOORED3",96,0)
 F I=1:1:ENT S ^PSRX(PSORXED("IRXN"),6,I,0)=PSORXED("DOSE",I)_"^"_$G(PSORXED("DOSE ORDERED",I))_"^"_$G(PSORXED("UNITS",I))_"^"_$G(PSORXED("NOUN",I))_"^" D
"RTN","PSOORED3",97,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,0)=^PSRX(PSORXED("IRXN"),6,I,0)_$G(PSORXED("DURATION",I))_"^"_$G(PSORXED("CONJUNCTION",I))_"^"_$G(PSORXED("ROUTE",I))_"^"_$G(PSORXED("SCHEDULE",I))_"^"_$G(PSORXED("VERB",I))
"RTN","PSOORED3",98,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,1)=$G(PSORXED("ODOSE",I))
"RTN","PSOORED3",99,0)
 S ^PSRX(PSORXED("IRXN"),"POE")=1
"RTN","PSOORED3",100,0)
 G EX
"RTN","PSOORED3",101,0)
 Q
"RTN","PSOORED3",102,0)
EX ;
"RTN","PSOORED3",103,0)
 K PSORXED("DOSE"),DOSE,DUPD,SCH,PSORXED("NOUN"),PSORXED("VERB"),VERB,NOUN,PSORXED("DOSE ORDERED"),DOSEOR,PSORXED("ROUTE"),ENT,PSORTE,SIG,PSODOSE
"RTN","PSOORED3",104,0)
 K PSORXED("SCHEDULE"),PSORXED("DURATION"),PSORXED("CONJUNCTION"),DURA,X,Y,PSORXED("ODOSE")
"RTN","PSOORED3",105,0)
EX1 K STRE,UNITN,DOSE,DUPD,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSOSCH,ERTE,ROU
"RTN","PSOORED3",106,0)
KV K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOORED3",107,0)
 Q
"RTN","PSOORED3",108,0)
EXQ K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) S PSORXED("DFLG")=1 D M1 G EX
"RTN","PSOORED3",109,0)
 Q
"RTN","PSOORED3",110,0)
M1 D M1^PSOOREDX
"RTN","PSOORED3",111,0)
 Q
"RTN","PSOORED3",112,0)
DOLST1(PSORXED) ;
"RTN","PSOORED3",113,0)
 ;
"RTN","PSOORED3",114,0)
DOLST F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),6,I)) Q:'I  S INST=^(I,0) D
"RTN","PSOORED3",115,0)
 .S PSORXED("DOSE",I)=$P(INST,"^"),PSORXED("DOSE ORDERED",I)=$P(INST,"^",2),PSORXED("UNITS",I)=$P(INST,"^",3),PSORXED("NOUN",I)=$P(INST,"^",4)
"RTN","PSOORED3",116,0)
 .I $P(INST,"^",5)]"" D
"RTN","PSOORED3",117,0)
 ..S PSORXED("DURATION",I)=$S($E($P(INST,"^",5),1)'?.N:$E($P(INST,"^",5),2,99)_$E($P(INST,"^",5),1),1:$P(INST,"^",5))
"RTN","PSOORED3",118,0)
 .S PSORXED("ROUTE",I)=$P(INST,"^",7),PSORXED("SCHEDULE",I)=$P(INST,"^",8)
"RTN","PSOORED3",119,0)
 .S PSORXED("CONJUNCTION",I)=$P(INST,"^",6),PSORXED("VERB",I)=$P(INST,"^",9),OLENT=I
"RTN","PSOORED3",120,0)
 .S PSORXED("ODOSE",I)=$G(^PSRX(PSORXED("IRXN"),6,I,1))
"RTN","PSOORED3",121,0)
 K:'$O(PSORXED("DOSE",0)) PSORXED("ENT"),OLENT
"RTN","PSOORED3",122,0)
 S PSORXED("INS")=$G(^PSRX(PSORXED("IRXN"),"INS"))
"RTN","PSOORED3",123,0)
 Q
"RTN","PSOORED3",124,0)
UPDSIG ;updates sig
"RTN","PSOORED3",125,0)
 K ^PSRX(PSORXED("IRXN"),"SIG1") S ^PSRX(PSORXED("IRXN"),"SIG1",0)="^52.04A^^"
"RTN","PSOORED3",126,0)
 S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1
"RTN","PSOORED3",127,0)
 S ^PSRX(PSORXED("IRXN"),"SIG")="^1"
"RTN","PSOORED3",128,0)
 Q
"RTN","PSOORED3",129,0)
JUMP ;jump to fields
"RTN","PSOORED3",130,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED3",131,0)
 D FNM^PSOOREDX
"RTN","PSOORED3",132,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED3",133,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED3",134,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED3",135,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED3",136,0)
 G EX
"RTN","PSOORED3",137,0)
 Q
"RTN","PSOORED3",138,0)
 ;
"RTN","PSOORED3",139,0)
CNON ;
"RTN","PSOORED3",140,0)
 I $G(NOUN)'="" Q
"RTN","PSOORED3",141,0)
 I '$G(PSORXED("DOSE ORDERED",ENT)) Q
"RTN","PSOORED3",142,0)
 N PSONLT,PSONLL,PSONLG
"RTN","PSOORED3",143,0)
 S PSONLL=$P($G(DOSE("DD",+$G(PSODRUG("IEN")))),"^",9) I PSONLL="" Q
"RTN","PSOORED3",144,0)
 S PSONLG=$L(PSONLL)
"RTN","PSOORED3",145,0)
 I PSONLG'>3 Q
"RTN","PSOORED3",146,0)
 S PSONLT=$E(PSONLL,(PSONLG-2),PSONLG)
"RTN","PSOORED3",147,0)
 I PSONLT'="(S)",PSONLT'="(s)" Q
"RTN","PSOORED3",148,0)
 ;test noun of (S)
"RTN","PSOORED3",149,0)
 K NOUN ; NOT SURE ABOUT THIS???
"RTN","PSOORED3",150,0)
 I $G(PSORXED("DOSE ORDERED",ENT))>1 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))_$E(PSONLT,2) Q
"RTN","PSOORED3",151,0)
 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))
"RTN","PSOORED3",152,0)
 Q
"RTN","PSOORED3",153,0)
 ;
"RTN","PSOORED3",154,0)
DUROK(DOSE,ENT) ; Duration OK? (Complex Doses only)
"RTN","PSOORED3",155,0)
 ;Input: PSORXED - array with doses
"RTN","PSOORED3",156,0)
 ;       ENT - dose entry in the PSORXED array
"RTN","PSOORED3",157,0)
 ;Output: 1: Duration OK / 0: Duration not OK (required, but missing)
"RTN","PSOORED3",158,0)
 N SCHIEN
"RTN","PSOORED3",159,0)
 I $G(DOSE("CONJUNCTION",ENT))'="T" Q 1
"RTN","PSOORED3",160,0)
 I $G(DOSE("DURATION",ENT)) Q 1
"RTN","PSOORED3",161,0)
 I $G(DOSE("SCHEDULE",ENT))="" Q 1
"RTN","PSOORED3",162,0)
 S SCHIEN=$O(^PS(51.1,"B",$G(DOSE("SCHEDULE",ENT)),0))
"RTN","PSOORED3",163,0)
 I $$GET1^DIQ(51.1,SCHIEN,5,"I")="O" Q 1
"RTN","PSOORED3",164,0)
 Q 0
"RTN","PSOORED4")
0^34^B56835310^B54845404
"RTN","PSOORED4",1,0)
PSOORED4 ;BIR/SAB - Edit front door dosing ;07/13/00
"RTN","PSOORED4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,91,78,99,111,117,133,159,148,251,391,372,416,313**;DEC 1997;Build 76
"RTN","PSOORED4",3,0)
 ;External reference ^PS(51 supported by DBIA 2224
"RTN","PSOORED4",4,0)
 ;External reference to PS(51.2 supported by DBIA 2226
"RTN","PSOORED4",5,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOORED4",6,0)
 ;called from psoornew
"RTN","PSOORED4",7,0)
 ;
"RTN","PSOORED4",8,0)
DOSE(PSORXED) ;
"RTN","PSOORED4",9,0)
 I '$G(PSODRUG("IEN")) W !,"DRUG NAME REQUIRED!" D 2^PSOORNW1 I '$G(PSODRUG("IEN")) S VALMSG="No Dispense Drug Selected" Q
"RTN","PSOORED4",10,0)
 K ROU,STRE,UNITN,PSODOSE M PSODOSE=PSORXED
"RTN","PSOORED4",11,0)
 D KV K FIELD,DOSEOR,DUPD,X,Y,UNITS S ENT=1,OLENT=$G(PSORXED("ENT"))
"RTN","PSOORED4",12,0)
ASK I $G(ORD) W !!,"Possible SIG: " D
"RTN","PSOORED4",13,0)
 .;Coded only for outside orders with no Patient Instructions
"RTN","PSOORED4",14,0)
 .I $O(SIG(""))="",$G(ORD),$P($G(^PS(52.41,ORD,"EXT")),"^")'="" D SIGS^PSOHCPRS
"RTN","PSOORED4",15,0)
 .S INST=0 F  S INST=$O(SIG(INST)) Q:'INST  S MIG=SIG(INST) D
"RTN","PSOORED4",16,0)
 ..F SG=1:1:$L(MIG," ") W:$X+$L($P(MIG," ",SG)_" ")>IOM !?14 W $P(MIG," ",SG)_" "
"RTN","PSOORED4",17,0)
 K SG,INST,MIG
"RTN","PSOORED4",18,0)
 S ROU="PSOORED4",II=ENT D ASK^PSOBKDED K ROU,II I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED4",19,0)
 G:$D(DIRUT) EXQ
"RTN","PSOORED4",20,0)
 ;
"RTN","PSOORED4",21,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED4",22,0)
VER D VER^PSOOREDX I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED4",23,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",24,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED4",25,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED4",26,0)
DUPD ;
"RTN","PSOORED4",27,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED4",28,0)
 D DUPD^PSOOREDX
"RTN","PSOORED4",29,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:1) S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED4",30,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED4",31,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",32,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED4",33,0)
 D STR^PSOOREDX
"RTN","PSOORED4",34,0)
NOU1 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOORED4",35,0)
 D CNON^PSOORED3
"RTN","PSOORED4",36,0)
 N PSONDEF
"RTN","PSOORED4",37,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOORED4",38,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED4",39,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",40,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED4",41,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED4",42,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED4",43,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED4",44,0)
 ;
"RTN","PSOORED4",45,0)
RTE K JUMP S ROU="PSOORED4" D RTE^PSOBKDED K ROU
"RTN","PSOORED4",46,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED4",47,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",48,0)
 ;
"RTN","PSOORED4",49,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED4",50,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",51,0)
 S SCH=Y D SCH^PSOSIG I $G(SCH)']"" G SCH
"RTN","PSOORED4",52,0)
 S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED4",53,0)
 S:PSORXED("ENT")<ENT PSORXED("ENT")=ENT
"RTN","PSOORED4",54,0)
 ;
"RTN","PSOORED4",55,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN DAYS, HOURS OR MINUTES)"
"RTN","PSOORED4",56,0)
 S DIR("B")=$S($G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED4",57,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED4",58,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",59,0)
 D DUR1^PSOOREDX
"RTN","PSOORED4",60,0)
 ;
"RTN","PSOORED4",61,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED4",62,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",63,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED4",64,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED4",65,0)
 I X="@",$D(PSORXED("CONJUNCTION",ENT)) D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOORED4",66,0)
 ;
"RTN","PSOORED4",67,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED4",68,0)
 I $G(PSORXED("CONJUNCTION",ENT))="T",$G(PSORXED("DURATION",ENT))="" D  G DUR
"RTN","PSOORED4",69,0)
 . W $C(7),!!,"Duration is required for the dosage entered prior to the THEN conjunction.",!
"RTN","PSOORED4",70,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSONEW("DFLG")) EX S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED4",71,0)
 E  K PSOCKCON D DCHK1^PSODOSUT I $D(DTOUT)!($D(DUOUT)) S PSORX("DFLG")=1,PSONEW("DFLG")=1 G EX  ;don't need to print the full summary, just the last sequence. 
"RTN","PSOORED4",72,0)
 I PSOSAVX="",$G(PSORXED) K PSOCKCON,PSOEDDOS
"RTN","PSOORED4",73,0)
 K PSOSAVX
"RTN","PSOORED4",74,0)
 ;
"RTN","PSOORED4",75,0)
 S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOORED4",76,0)
 D EN^PSOFSIG(.PSORXED),VERI I $G(CKX),'$G(PSOSIGFL) D MP1 K CKX
"RTN","PSOORED4",77,0)
 I $G(PSOSIGFL)=1 D  I '$G(PSOSIGFL) Q
"RTN","PSOORED4",78,0)
 .I $D(OR0),$P(OR0,"^",24)=1 S VALMSG="Digitally Signed Order - No such changes allowed." K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D  Q
"RTN","PSOORED4",79,0)
 ..I $D(PSOBDR) K PSODRUG M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOORED4",80,0)
 .S PSORXED("ENT")=ENT,SIGOK=1,VALMSG="This change will create a new prescription!",NCPDPFLG=1
"RTN","PSOORED4",81,0)
 K QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED4",82,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED4",83,0)
 K QTYHLD
"RTN","PSOORED4",84,0)
 I '$G(PSORXED("QTY")),$P(OR0,"^",10) S PSORXED("QTY")=$P(OR0,"^",10)
"RTN","PSOORED4",85,0)
EX ;
"RTN","PSOORED4",86,0)
 K PSOBDR,PSOBDRG,PSOSCH,DUPD,STRE,UNITN,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSODOSE,OLENT,FIELD,FLDNM,AR,NM,ENT,STRE,UNITN,PSODOSE,ERTE,ROU
"RTN","PSOORED4",87,0)
KV K DTOUT,DUOUT,DIR,DIRUT
"RTN","PSOORED4",88,0)
 Q
"RTN","PSOORED4",89,0)
EXQ ;
"RTN","PSOORED4",90,0)
 K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D MP1
"RTN","PSOORED4",91,0)
 I $D(PSOBDR) M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOORED4",92,0)
 G EX Q
"RTN","PSOORED4",93,0)
MP1 D MP1^PSOOREDX
"RTN","PSOORED4",94,0)
 Q
"RTN","PSOORED4",95,0)
VERI ;checks for changes to dosing instructions
"RTN","PSOORED4",96,0)
 S ENTS=0
"RTN","PSOORED4",97,0)
 F I=0:0 S I=$O(PSORXED("DOSE",I)) Q:'I  S ENTS=$G(ENTS)+1
"RTN","PSOORED4",98,0)
 I ENTS<OLENT!(ENTS>OLENT) S PSOSIGFL=1 Q
"RTN","PSOORED4",99,0)
 F I=1:1:OLENT D
"RTN","PSOORED4",100,0)
 .I +PSODOSE("DOSE",I)'=$G(PSORXED("DOSE",I)) S PSOSIGFL=1
"RTN","PSOORED4",101,0)
 .I $G(PSODOSE("DURATION",I))]"" D
"RTN","PSOORED4",102,0)
 ..S DURATION=$S($E(PSODOSE("DURATION",I),1)'?.N:$E(PSODOSE("DURATION",I),2,99)_$E(PSODOSE("DURATION",I),1),1:PSODOSE("DURATION",I))
"RTN","PSOORED4",103,0)
 ..I +DURATION'=+$G(PSORXED("DURATION",I)) S PSOSIGFL=1
"RTN","PSOORED4",104,0)
 .I $G(PSODOSE("CONJUNCTION",I))'=$G(PSORXED("CONJUNCTION",I)) S PSOSIGFL=1
"RTN","PSOORED4",105,0)
 .I PSODOSE("ROUTE",I)'=$G(PSORXED("ROUTE",I)) S PSOSIGFL=1
"RTN","PSOORED4",106,0)
 .I PSODOSE("SCHEDULE",I)'=$G(PSORXED("SCHEDULE",I)) S PSOSIGFL=1
"RTN","PSOORED4",107,0)
 K DURATION Q
"RTN","PSOORED4",108,0)
JUMP ;jump to fields
"RTN","PSOORED4",109,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED4",110,0)
 D FNM^PSOOREDX
"RTN","PSOORED4",111,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED4",112,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED4",113,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED4",114,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED4",115,0)
 G EX
"RTN","PSOORED4",116,0)
 Q
"RTN","PSOORED4",117,0)
HLP ;help text for med route
"RTN","PSOORED4",118,0)
 D FULL^VALM1 W !,"Please enter how patient will use the medication!"
"RTN","PSOORED4",119,0)
 S DIC=51.2,X="??",DIC(0)="M",DIC("S")="I $P(^PS(51.2,+Y,0),""^"",4)" D ^DIC K DIC,X,Y
"RTN","PSOORED4",120,0)
 Q
"RTN","PSOORED4",121,0)
SCHLP ;
"RTN","PSOORED4",122,0)
 D FULL^VALM1 W !,"You can choose an entry from the Administration Schedule File (#51.1),",!,"Medication Instruction File (#51) or enter free text."
"RTN","PSOORED4",123,0)
 W !,"The free text entry cannot contain more than 2 spaces or be greater than 20",!,"characters in length."
"RTN","PSOORED4",124,0)
 W ! S DIR(0)="S^A:Administration Schedule File;M:Medication Instruction File;B:Both;F:Free Text",DIR("B")="Both"
"RTN","PSOORED4",125,0)
 S DIR("A")="Do you want to list from" D ^DIR I Y="F"!($G(DIRUT)) K X,Y G X
"RTN","PSOORED4",126,0)
 S LBL=Y G @LBL
"RTN","PSOORED4",127,0)
A ;display 51.1 entries only
"RTN","PSOORED4",128,0)
B K X,Y,DIC S X="??",DIC="^PS(51.1,",DIC(0)="QES",DIC("W")="D DICW^PSOORED4",D="APPSJ" W ! D IX^DIC
"RTN","PSOORED4",129,0)
 K DIC,X I LBL="A"!($G(DTOUT)) K LBL G X
"RTN","PSOORED4",130,0)
 I Y=-1!($G(DUOUT)) K DIR,DTOUT,DUOUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Do you want to continue with the Medication Instruction File"
"RTN","PSOORED4",131,0)
 D ^DIR I 'Y!($G(DTOUT)) K DIR,X,Y G X
"RTN","PSOORED4",132,0)
M K X,Y,DIC S DIC=51,X="??",DIC(0)="M" D ^DIC K DIC,X,Y,DTOUT,DUOUT,LBL
"RTN","PSOORED4",133,0)
X S DIR("?")="^D SCHLP^PSOORED4",DIR("A")="Schedule: ",DIR(0)="FA^1:20^I X[""""""""!(X?.E1C.E)!($A(X)=45)!($L(X,"" "")>3)!($L(X)>20)!($L(X)<1) K X"
"RTN","PSOORED4",134,0)
 S DIR("B")=$S($D(PSOSCH)&('$D(PSORXED("SCHEDULE",ENT))):PSOSCH,$G(PSORXED("SCHEDULE",ENT))]"":PSORXED("SCHEDULE",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED4",135,0)
 Q
"RTN","PSOORED4",136,0)
DICW ;
"RTN","PSOORED4",137,0)
 S Z=$P(^PS(51.1,+Y,0),"^",5),Z=$S(Z="O":-1,Z="S":1,Z="R":-2,1:0) W:Z "  ",$S(Z>0:"SHIFT",Z=-2:"RANGE",1:"ONE-TIME")
"RTN","PSOORED4",138,0)
 I Z'<0,$D(PSJW),$D(^(PSJPP'="PSJ"+1,PSJW,0)),$P(^(0),"^",Z+2)]"" W "  ",$P(^(0),"^",Z+2)
"RTN","PSOORED4",139,0)
 ;Naked reference on DICW+2 is from DICW+1, ^PS(51.1,+Y,0)
"RTN","PSOORED4",140,0)
 Q
"RTN","PSOORED5")
0^35^B60490141^B58804005
"RTN","PSOORED5",1,0)
PSOORED5 ;BIR/SAB-Rxs without dosing info ;07/20/00
"RTN","PSOORED5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,75,78,100,99,117,133,251,378,372,416,313**;DEC 1997;Build 76
"RTN","PSOORED5",3,0)
 ;^PS(51.2 - DBIA 2226
"RTN","PSOORED5",4,0)
 ;^PS(50.7 - DBIA 2223
"RTN","PSOORED5",5,0)
 ;^PSDRUG - DBIA 221
"RTN","PSOORED5",6,0)
 ;^PS(55 - DBIA 2228
"RTN","PSOORED5",7,0)
 ;called by psoored2 and psodir
"RTN","PSOORED5",8,0)
 ;pre-poe rxs and new backdoor rxs
"RTN","PSOORED5",9,0)
DOSE1(PSORXED) ;for new rxs
"RTN","PSOORED5",10,0)
DOSE ;pre-poe rx
"RTN","PSOORED5",11,0)
 D KV K ROU,STRE,FIELD,DOSEOR,DUPD,X,Y,UNITS S ENT=1,OLENT=ENT
"RTN","PSOORED5",12,0)
ASK S ROU="PSOORED5" D ASK^PSOBKDED K ROU G:$D(DIRUT) EX
"RTN","PSOORED5",13,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED5",14,0)
 I $G(QUIT)]"" K QUIT,ROU Q
"RTN","PSOORED5",15,0)
 ;
"RTN","PSOORED5",16,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED5",17,0)
 I $G(PSORX("EDIT"))']"" W:$G(PSORXED("VERB",ENT))]"" !,"VERB: "_PSORXED("VERB",ENT) G DUPD
"RTN","PSOORED5",18,0)
VER D VER^PSOOREDX
"RTN","PSOORED5",19,0)
 I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED5",20,0)
 G:$D(DTOUT)!($D(DUOUT)) EX I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED5",21,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED5",22,0)
DUPD ;
"RTN","PSOORED5",23,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED5",24,0)
 D KV S DIR(0)="52.0113,1",DIR("A")="DISPENSE UNITS PER DOSE"_$S($G(PSORXED("NOUN",ENT))]"":"("_PSORXED("NOUN",ENT)_")",1:"")
"RTN","PSOORED5",25,0)
 I '$G(PSORXED("DOSE",ENT)),$G(PSORXED("DOSE",ENT-1)) S PSORXED("DOSE",ENT)=PSORXED("DOSE",ENT-1)
"RTN","PSOORED5",26,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),$G(DUPD)]"":DUPD,1:"") S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED5",27,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED5",28,0)
 G:$D(DTOUT)!($D(DUOUT)) EX
"RTN","PSOORED5",29,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED5",30,0)
 D STR^PSOOREDX
"RTN","PSOORED5",31,0)
 ;
"RTN","PSOORED5",32,0)
NOU1 G:'$D(DUPD) RTE D CNON^PSOORED3 N PSONDEF
"RTN","PSOORED5",33,0)
 I $G(NOUN)]"",$G(PSORX("EDIT"))']"" S PSORXED("NOUN",ENT)=NOUN W !,"NOUN: "_$G(NOUN) G RTE
"RTN","PSOORED5",34,0)
 I $G(PSORX("EDIT"))']"",$G(PSORXED("NOUN",ENT))]"" W !,"NOUN: "_PSORXED("NOUN",ENT) G RTE
"RTN","PSOORED5",35,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED5",36,0)
 G:$D(DTOUT)!($D(DUOUT)) EX I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED5",37,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED5",38,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED5",39,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED5",40,0)
 ;
"RTN","PSOORED5",41,0)
RTE I $G(ENT)>1,$G(PSORX("EDIT"))']"",$G(PSORXED("ROUTE",ENT-1)),$G(PSORXED("ROUTE",ENT))']"" S PSORXED("ROUTE",ENT)=PSORXED("ROUTE",ENT-1) G SCH
"RTN","PSOORED5",42,0)
 I '$G(DRET),'$G(PSORXED("ROUTE",ENT)),$P(^PS(50.7,PSODRUG("OI"),0),"^",6) S PSORXED("ROUTE",ENT)=$P(^PS(50.7,PSODRUG("OI"),0),"^",6)
"RTN","PSOORED5",43,0)
 I $G(DRET) S PSORXED("ROUTE",ENT)=""
"RTN","PSOORED5",44,0)
 I $G(RTE) K RTE
"RTN","PSOORED5",45,0)
 D KV S DIR(0)="FO^2:45",DIR("A")="ROUTE",DIR("?")="^D HLP^PSOORED4"
"RTN","PSOORED5",46,0)
 S DIR("B")=$S($G(PSORXED("ROUTE",ENT)):$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),$G(RTE)]"":RTE,$G(DRET):"",1:"PO") K:DIR("B")="" DIR("B")
"RTN","PSOORED5",47,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="RTE" G JUMP
"RTN","PSOORED5",48,0)
 I $D(DTOUT)!($D(DUOUT)) S PSODIR("DFLG")=1 Q
"RTN","PSOORED5",49,0)
 I X="@"!(X="") K RTE,ERTE S DRET=1,PSORXED("ROUTE",ENT)="" G SCH
"RTN","PSOORED5",50,0)
 K DRET I X=$P($G(^PS(51.2,+$G(PSORXED("ROUTE",ENT)),0)),"^") S RTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),ERTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^",2) W X_" "_$G(ERTE) G SCH
"RTN","PSOORED5",51,0)
 S DIC=51.2,DIC(0)="QEZM",DIC("S")="I $P(^(0),""^"",4)" D ^DIC Q:X[U  G:Y=-1 RTE W "  "_$P(Y(0),"^",2)
"RTN","PSOORED5",52,0)
 S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2)
"RTN","PSOORED5",53,0)
 ;
"RTN","PSOORED5",54,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED5",55,0)
 G:$D(DTOUT)!($D(DUOUT)) EX S SCH=Y D SCH^PSOSIG I $G(SCH)']"" G SCH
"RTN","PSOORED5",56,0)
 S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED5",57,0)
 S:$G(PSORXED("ENT"))<ENT PSORXED("ENT")=ENT
"RTN","PSOORED5",58,0)
 ;
"RTN","PSOORED5",59,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN DAYS, HOURS OR MINUTES)"
"RTN","PSOORED5",60,0)
 S DIR("B")=$S($D(DUR):DUR,$G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED5",61,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED5",62,0)
 G:$D(DTOUT)!($D(DUOUT)) EX
"RTN","PSOORED5",63,0)
 D DUR1^PSOOREDX
"RTN","PSOORED5",64,0)
 ;
"RTN","PSOORED5",65,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED5",66,0)
 G:$D(DTOUT)!($D(DUOUT)) EX
"RTN","PSOORED5",67,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED5",68,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED5",69,0)
 I X="@" D CON1^PSOOREDX G:$D(DIRUT) EX G:'Y CON S:'$G(COPY) PSOSIGFL=1 D UPD^PSOOREDX G CON
"RTN","PSOORED5",70,0)
 ;
"RTN","PSOORED5",71,0)
 I '$$DUROK^PSOORED3(.PSORXED,ENT) D  G DUR
"RTN","PSOORED5",72,0)
 . W !!,"Duration is required for the dosage entered prior to the THEN conjunction.",$C(7),!
"RTN","PSOORED5",73,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED5",74,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSORXED("DFLG"))!($G(PSORX("DFLG"))) EX S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED5",75,0)
 E  K PSOCKCON I $$DCHK^PSODOSUT S PSORXED("DFLG")=1,PSORX("DFLG")=1 G EX
"RTN","PSOORED5",76,0)
 I PSOSAVX="",$G(PSORXED)!($D(PSOEDDOS)) K PSOCKCON
"RTN","PSOORED5",77,0)
 K PSOSAVX
"RTN","PSOORED5",78,0)
 ;
"RTN","PSOORED5",79,0)
 S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOORED5",80,0)
 D EN^PSOFSIG(.PSORXED) I $O(SIG(0)) S PSORXED("ENT")=ENT,SIGOK=1
"RTN","PSOORED5",81,0)
 Q:$G(PSOREEDT)!($G(PSOORRNW))
"RTN","PSOORED5",82,0)
 K QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED5",83,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED5",84,0)
 K QTYHLD Q:$G(PSOFROM)="NEW"!($G(COPY))!($G(PSOFROM))!($G(PSOREEDT))
"RTN","PSOORED5",85,0)
 Q:$G(PSOSIGFL)  D
"RTN","PSOORED5",86,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSOORED5",87,0)
 .S (A,I)=0 F  S I=$O(^PSRX(PSORXED("IRXN"),"A",I)) Q:'I  S A=A+1
"RTN","PSOORED5",88,0)
 .S:'$D(^PSRX(PSORXED("IRXN"),"A",0)) ^PSRX(PSORXED("IRXN"),"A",0)="^52.3DA^"
"RTN","PSOORED5",89,0)
 .S $P(^PSRX(PSORXED("IRXN"),"A",0),"^",3)=$P($G(^PSRX(PSORXED("IRXN"),"A",0)),"^",3)+1,$P(^(0),"^",4)=$P($G(^(0)),"^",4)+1
"RTN","PSOORED5",90,0)
 .D NOW^%DTC S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^New Dosing Instructions Added",^PSRX(PSORXED("IRXN"),"A",A,1)="ORIGINAL SIG^" D
"RTN","PSOORED5",91,0)
 ..I '$P(^PSRX(PSORXED("IRXN"),"SIG"),"^",2) S $P(^PSRX(PSORXED("IRXN"),"A",A,1),"^",2)=$P(^PSRX(PSORXED("IRXN"),"SIG"),"^") Q
"RTN","PSOORED5",92,0)
 ..F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S ^PSRX(PSORXED("IRXN"),"A",A,2,I,0)=^PSRX(PSORXED("IRXN"),"SIG1",I,0),^PSRX(PSORXED("IRXN"),"A",A,2,0)="^52.34A^"_I_"^"_I
"RTN","PSOORED5",93,0)
 .S ^PSRX(PSORXED("IRXN"),"SIG")="^1" K SIG,A,I
"RTN","PSOORED5",94,0)
 S ^PSRX(PSORXED("IRXN"),6,0)="^52.0113^"_ENT_"^"_ENT
"RTN","PSOORED5",95,0)
 F I=1:1:ENT S ^PSRX(PSORXED("IRXN"),6,I,0)=PSORXED("DOSE",I)_"^"_$G(PSORXED("DOSE ORDERED",I))_"^"_$G(PSORXED("UNITS",I))_"^"_$G(PSORXED("NOUN",I))_"^" D
"RTN","PSOORED5",96,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,0)=^PSRX(PSORXED("IRXN"),6,I,0)_$G(PSORXED("DURATION",I))_"^"_$G(PSORXED("CONJUNCTION",I))_"^"_$G(PSORXED("ROUTE",I))_"^"_$G(PSORXED("SCHEDULE",I))_"^"_$G(PSORXED("VERB",I))
"RTN","PSOORED5",97,0)
 .I $G(PSORXED("DOSE",I))]"" S ^PSRX(PSORXED("IRXN"),6,I,1)=PSORXED("DOSE",I)
"RTN","PSOORED5",98,0)
 S ^PSRX(PSORXED("IRXN"),"POE")=1 G EX
"RTN","PSOORED5",99,0)
 Q
"RTN","PSOORED5",100,0)
EX I $D(DUOUT)!($D(DTOUT)) S PSONEW("DFLG")=1
"RTN","PSOORED5",101,0)
 ;I $D(DUOUT)!($D(DTOUT)) S:'$G(PSORX("EDIT")) PSONEW("DFLG")=1
"RTN","PSOORED5",102,0)
 G:$G(PSOSIGFL)!($G(PSORX("EDIT")))!($G(PSORXED))!($G(PSOREEDT)) EX1
"RTN","PSOORED5",103,0)
 K PSORXED("DOSE"),PSORXED("NOUN"),PSORXED("VERB"),PSORXED("DOSE ORDERED"),PSORXED("ROUTE"),SIG,PSORXED("SCHEDULE"),PSORXED("DURATION"),PSORXED("CONJUNCTION"),PSORXED("ODOSE")
"RTN","PSOORED5",104,0)
EX1 K UNITN,STRE,DOSE,DUPD,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSOSCH,ENT,PSORTE,DURA,ERTE,ROU
"RTN","PSOORED5",105,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOORED5",106,0)
 Q
"RTN","PSOORED5",107,0)
UPD ;updates dosing array
"RTN","PSOORED5",108,0)
 D UPD^PSOORED6
"RTN","PSOORED5",109,0)
 Q
"RTN","PSOORED5",110,0)
JUMP ;
"RTN","PSOORED5",111,0)
 I $G(PSORXED("SCHEDULE",1))']"" W $C(7),!!,"All Dosing Instructions must be entered before Jumping to other Fields!",!! G @FIELD
"RTN","PSOORED5",112,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED5",113,0)
 D FNM^PSOOREDX
"RTN","PSOORED5",114,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED5",115,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED5",116,0)
 D KV
"RTN","PSOORED5",117,0)
 I $G(PSOFROM)'="NEW",'$G(COPY) S DIR("A",1)="* Indicates which fields will create a New Order"
"RTN","PSOORED5",118,0)
 S DIR("A")="Select Field by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED5",119,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED5",120,0)
 G EX
"RTN","PSOORED5",121,0)
 Q
"RTN","PSOORED5",122,0)
LAN ;
"RTN","PSOORED5",123,0)
 Q:'$G(PSODRUG("IEN"))
"RTN","PSOORED5",124,0)
 I $G(OR0),'$G(PSONEW("DOSE ORDERED",II)),$P($G(^PS(55,PSODFN,"LAN")),"^") D  K QI,QII Q
"RTN","PSOORED5",125,0)
 .Q:$G(OTHDOS(II))
"RTN","PSOORED5",126,0)
 .F QI=0:0 S QI=$O(^PSDRUG(PSODRUG("IEN"),"DOS2",QI)) Q:'QI  D  Q:$G(QII)
"RTN","PSOORED5",127,0)
 ..Q:$G(PSONEW("DOSE",II))']""
"RTN","PSOORED5",128,0)
 ..I PSONEW("DOSE",II)=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",QI,0),"^") S PSONEW("ODOSE",II)=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",QI,0),"^",4),QII=1
"RTN","PSOORED5",129,0)
 I $G(Y),$P($G(DOSE(Y)),"^",13)]"" S PSORXED("ODOSE",ENT)=$P(DOSE(Y),"^",13) Q
"RTN","PSOORED5",130,0)
 K QII F I=0:0 S I=$O(^PSDRUG(PSODRUG("IEN"),"DOS2",I)) Q:'I  I DOSE=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",I,0),"^") D  Q:$G(QII)
"RTN","PSOORED5",131,0)
 .S PSORXED("ODOSE",ENT)=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",I,0),"^",4),QII=1
"RTN","PSOORED5",132,0)
 K QII,I
"RTN","PSOORED5",133,0)
 Q
"RTN","PSOORED5",134,0)
 ;
"RTN","PSOOREDT")
0^29^B78897328^B72615864
"RTN","PSOOREDT",1,0)
PSOOREDT ;BIR/SAB - edit orders from backdoor ;5/8/08 3:27pm
"RTN","PSOOREDT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**4,20,27,37,57,46,78,102,104,119,143,148,260,281,304,289,298,379,377,391,313**;DEC 1997;Build 76
"RTN","PSOOREDT",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOOREDT",4,0)
 ;External reference to PSSLOCK supported by DBIA 2789
"RTN","PSOOREDT",5,0)
 ;External reference to ^VA(200 supported by DBIA 10060
"RTN","PSOOREDT",6,0)
SEL K PSOISLKD,PSOLOKED S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY D SVAL K PSOPLCK S VALMBCK="" Q
"RTN","PSOOREDT",7,0)
 K PSOPLCK D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) D UL^PSSLOCK(+$G(PSODFN)) D SVALO K PSOMSG S VALMBCK="" Q
"RTN","PSOOREDT",8,0)
 K PSOMSG S PSOLOKED=1
"RTN","PSOOREDT",9,0)
 S REF=0 S:$$LSTRFL^PSOBPSU1($P(PSOLST(ORN),"^",2)) REF=1  ;*377
"RTN","PSOOREDT",10,0)
 K PSORX("DFLG"),DIR,DUOUT,DIRUT S DIR("A")="Select fields by number"
"RTN","PSOOREDT",11,0)
 S DIR(0)="LO^1:"_$S($$STATUS^PSOBPSUT($P(PSOLST(ORN),"^",2))'="":21,$G(REF):20,1:19)
"RTN","PSOOREDT",12,0)
 D ^DIR I $D(DIRUT) K DIR,DIRUT,DTOUT S VALMBCK="" D UL K PSOLOKED Q
"RTN","PSOOREDT",13,0)
EDTSEL N VALMCNT K PSOISLKD,PSORX("DFLG"),PSOOIFLG,PSOMRFLG,DIR,DIRUT,DTOUT,DTOUT,ZONE S PSOQUIT=0,(PSOEDIT,PSORXED)=1 I +Y S FST=Y D HLDHDR^PSOLMUTL D  G EX ;PSO LM SELECT MENU protocol
"RTN","PSOOREDT",14,0)
 .I '$G(PSOLOKED) S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY D SVAL K PSOPLCK S VALMBCK="",(PSOISLKD,PSODE)=1 Q
"RTN","PSOOREDT",15,0)
 .I '$G(PSOLOKED) K PSOPLCK D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) D UL^PSSLOCK(+$G(PSODFN)) D SVALO K PSOMSG S VALMBCK="",(PSOISLKD,PSODE)=1 Q
"RTN","PSOOREDT",16,0)
 .K PSOMSG,PSOPLCK S (NEWEDT,PSOLOKED)=1 D EDT
"RTN","PSOOREDT",17,0)
 E  S VALMBCK="",PSODE=1
"RTN","PSOOREDT",18,0)
EX I $G(PSOISLKD)!($G(PSOQUIT)) D UL K PSOISLKD G EX2
"RTN","PSOOREDT",19,0)
 I '$G(PSOSIGFL),'$G(PSORXED("DFLG")) D UPDATE^PSOORED6 D LOG^PSORXED,POST^PSORXED G EX1
"RTN","PSOOREDT",20,0)
 I $G(PSOSIGFL)=1 D  Q:$G(PSORX("FN"))
"RTN","PSOOREDT",21,0)
 .N PSOTMP
"RTN","PSOOREDT",22,0)
 .S PSOTMP=$G(PSOFROM),PSOFROM="NEW"
"RTN","PSOOREDT",23,0)
 .S VALMSG="This change will create a new prescription!",NCPDPFLG=1
"RTN","PSOOREDT",24,0)
 .D EN^PSOORED1(.PSORXED)
"RTN","PSOOREDT",25,0)
 .I $G(PSORX("FN")) D  Q
"RTN","PSOOREDT",26,0)
 ..D ^PSOBUILD
"RTN","PSOOREDT",27,0)
 ..K QUIT,PSORX("DFLG"),FST,FLD,IEN,FLN,INCOM,PSOI,PSODRUG,PSOEDIT
"RTN","PSOOREDT",28,0)
 ..K PSORENW,PSOSIGFL,PSOOIFLG,PSOMRFLG,PSODIR,CHK,PSORX("SIG"),PSODE
"RTN","PSOOREDT",29,0)
 ..K PSOTRN,PSORX("EDIT"),PSORXED("FLD"),NEWEDT
"RTN","PSOOREDT",30,0)
 ..D EOJ^PSONEW
"RTN","PSOOREDT",31,0)
 ..D UL K PSOLOKED S VALMBCK="Q"
"RTN","PSOOREDT",32,0)
 .S PSOFROM=PSOTMP I PSOFROM="" K PSOFROM
"RTN","PSOOREDT",33,0)
 ;
"RTN","PSOOREDT",34,0)
EX1 I '$G(PSODE)!('$G(ZONE)) I $G(PSORENW("OIRXN")) D EN^PSOHLSN1(PSORENW("OIRXN"),"XX","","Order edited")
"RTN","PSOOREDT",35,0)
QUIT D UL K PSOLOKED D ^PSOBUILD,ACT^PSOORNE2 D:+^PSRX($P(PSOLST(ORN),"^",2),"STA")=5 EN^PSOCMOPC($P(PSOLST(ORN),"^",2))
"RTN","PSOOREDT",36,0)
 K:'$O(^PSRX($P(PSOLST(ORN),"^",2),1,0)) REF
"RTN","PSOOREDT",37,0)
EX2 S VALMBCK=$S($G(PSOQUIT):"R",$G(PSORX("FN")):"Q",$G(ZONE):"Q",1:"R")
"RTN","PSOOREDT",38,0)
 K PSORXED,FST,FLD,IEN,FLN,INCOM,PSOI,PSODRUG,PSOEDIT,PSORENW,PSOSIGFL,PSODIR,CHK,PSORX("SIG"),PSODE,PSOTRN,PSORX("DFLG"),RFED,ZONE,PSORX("EDIT"),PSOOIFLG,PSOMRFLG,SIG,QUIT,PSOQUIT
"RTN","PSOOREDT",39,0)
 K NEWEDT I $G(VALMBCK)="R" W ! D CLEAN^PSOVER1 H 2
"RTN","PSOOREDT",40,0)
 Q
"RTN","PSOOREDT",41,0)
 ;
"RTN","PSOOREDT",42,0)
EDT ; Rx Edit (Backdoor)
"RTN","PSOOREDT",43,0)
 K NCPDPFLG,PSOPKI,DEA
"RTN","PSOOREDT",44,0)
 S I=0 F  S I=$O(^PSRX($P(PSOLST(ORN),"^",2),1,I)) Q:'I  S PSORXED("RX1")=^PSRX($P(PSOLST(ORN),"^",2),1,I,0)
"RTN","PSOOREDT",45,0)
 ;*298 Track PI and Oth Lang PI
"RTN","PSOOREDT",46,0)
 S (RX0,PSORXED("RX0"))=^PSRX($P(PSOLST(ORN),"^",2),0),PSORXED("RX2")=$G(^(2)),PSORXED("RX3")=$G(^(3)),PSOSIG=$P(^("SIG"),"^"),PSOPINS=$G(^("INS")),PSOOINS=$G(^("INSS"))
"RTN","PSOOREDT",47,0)
 I '$D(PSODRUG) NEW PSOY S PSOY=$P(RX0,U,6),PSOY(0)=^PSDRUG(PSOY,0) D SET^PSODRG ; *298 moved this line from EDT+2  RX0 was not defined yet
"RTN","PSOOREDT",48,0)
 F FLD=1:1:$L(FST,",") Q:$P(FST,",",FLD)']""!($G(PSORXED("DFLG")))!($G(PSORX("DFLG")))  S FLN=+$P(FST,",",FLD) D
"RTN","PSOOREDT",49,0)
 .S PSORXED("DFLG")=0,(DA,PSORXED("IRXN"),PSORENW("OIRXN"))=$P(PSOLST(ORN),"^",2),RX0=^PSRX(PSORXED("IRXN"),0),PSOPKI=$P($G(^PSRX(PSORXED("IRXN"),"PKI")),"^") S:$G(PSOSIG)="" PSOSIG=$P(^("SIG"),"^")
"RTN","PSOOREDT",50,0)
 .;*298 Track PI and Oth Lang PI
"RTN","PSOOREDT",51,0)
 .S:$G(PSOPINS)="" PSOPINS=$G(^PSRX(DA,"INS")) S:$G(PSOOINS)="" PSOOINS=$G(^PSRX(DA,"INSS"))
"RTN","PSOOREDT",52,0)
 .I '$G(PSOSIGFL) D
"RTN","PSOOREDT",53,0)
 ..S PSOI=+^PSRX(DA,"OR1"),PSODAYS=$P(RX0,"^",8),PSORXST=+$P($G(^PS(53,$P(RX0,"^",3),0)),"^",7)
"RTN","PSOOREDT",54,0)
 ..I 'PSOI S PSOI=+^PSDRUG($P(RX0,"^",6),2),$P(^PSRX(DA,"OR1"),"^")=PSOI
"RTN","PSOOREDT",55,0)
 ..S:'$G(PSODRUG("IEN")) PSODRUG("IEN")=$P(RX0,"^",6),PSODRUG("NAME")=$P(^PSDRUG($P(RX0,"^",6),0),"^")
"RTN","PSOOREDT",56,0)
 ..S PSODRUG("OI")=PSOI
"RTN","PSOOREDT",57,0)
 .S PSORX("PROVIDER")=$P(RX0,"^",4),PSORX("PROVIDER NAME")=$P(^VA(200,$P(RX0,"^",4),0),"^"),PSOTRN=$G(^PSRX(DA,"TN"))
"RTN","PSOOREDT",58,0)
 .D:'$G(CHK) POP^PSOSIGNO(DA),CHK Q:$G(PSORXED("DFLG"))
"RTN","PSOOREDT",59,0)
 .S FDR="39.2^"_$S($P(PSOPAR,"^",3):"6",1:"")_";6.5^113^114^3^1^22R^24^8^7^9^4^11;"_$S($P(RX0,"^",11)="W"&($P(PSOPAR,"^",12)):"35;",1:"")_"^10.6^5^20^23^12^PSOCOU^RF^81"
"RTN","PSOOREDT",60,0)
 .; Titration/Maintenance Rx check
"RTN","PSOOREDT",61,0)
 .I $$REQFLDS(FST),$$TITRX^PSOUTL($P(PSOLST(ORN),"^",2))="t" D  S PSORXED("DFLG")=1 Q
"RTN","PSOOREDT",62,0)
 .. S VALMSG="Cannot edit Drug/Dose fields (Titration Rx).",VALMBCK="R" W $C(7)
"RTN","PSOOREDT",63,0)
 .D:'$G(CHK) POP^PSOSIGNO(DA),CHK Q:$G(PSORXED("DFLG"))
"RTN","PSOOREDT",64,0)
 .S FDR="39.2^"_$S($P(PSOPAR,"^",3):"6",1:"")_";6.5^113^114^3^1^22R^24^8^7^9^4^11;"_$S($P(RX0,"^",11)="W"&($P(PSOPAR,"^",12)):"35;",1:"")_"^10.6^5^20^23^12^PSOCOU^RF^81"
"RTN","PSOOREDT",65,0)
 .I $G(ST)=11!($G(ST)=12)!($G(ST)=14)!($G(ST)=15) D NDCDAWDE^PSOORED7(ST,FLN,$G(RXN)) Q
"RTN","PSOOREDT",66,0)
 .S REF=0 S:$$LSTRFL^PSOBPSU1($P(PSOLST(ORN),"^",2)) REF=1  ;*377
"RTN","PSOOREDT",67,0)
 .I FLN=20,'$G(REF) S VALMSG="There is no Refill Data to be edited." Q
"RTN","PSOOREDT",68,0)
 .S DR=$P(FDR,"^",FLN) I DR="RF" D REF^PSOORED2 Q
"RTN","PSOOREDT",69,0)
 .I DR="PSOCOU" D PSOCOU^PSOORED6 Q
"RTN","PSOOREDT",70,0)
 .I FLN=2,'$P(PSOPAR,"^",3),$$RXRLDT^PSOBPSUT(RXN,0),$$STATUS^PSOBPSUT(RXN,0)'="" D  Q
"RTN","PSOOREDT",71,0)
 ..N NDC D NDC^PSODRG(RXN,0,,.NDC) I $G(NDC)="^"!($G(NDC)="") Q
"RTN","PSOOREDT",72,0)
 ..S (PSODRUG("NDC"),PSORXED("FLD",27))=NDC
"RTN","PSOOREDT",73,0)
 .I FLN'>2,'$P(PSOPAR,"^",3) S VALMSG="Check site parameters, Drug data is not editable." Q
"RTN","PSOOREDT",74,0)
 .I FLN=3 D EDTDOSE^PSOORED2,FULL^VALM1,POST^PSODRG S:$G(PSORX("DFLG")) PSOISLKD=1,PSORX("FN")=1 Q
"RTN","PSOOREDT",75,0)
 .I FLN=4 D INS^PSOORED1 Q
"RTN","PSOOREDT",76,0)
 .I FLN=1 D PSOI^PSOORED6 N PSOX S PSORXED=1,PSOX("IRXN")=$S($D(DA):DA,$D(PSORXED("IRXN")):PSORXED("IRXN"),$D(PSORENW("OIRXN")):PSORENW("OIRXN")) D:'$G(PSORXED("DFLG")) EN^PSODIAG Q
"RTN","PSOOREDT",77,0)
 .I FLN=2 D DRG^PSOORED6 N PSOX S PSORXED=1,PSOX("IRXN")=PSORXED("IRXN") D:'$G(PSORXED("DFLG")) EN^PSODIAG S:$O(^PSRX(PSORXED("IRXN"),1,0)) REF=1 Q
"RTN","PSOOREDT",78,0)
 .I FLN=12,PSOPKI W !!,"Digitally Signed Order - Provider can't be changed" D PAUSE Q
"RTN","PSOOREDT",79,0)
 .I FLN=12 D PROV Q
"RTN","PSOOREDT",80,0)
 .I FLN=6 D ISDT^PSOORED2 Q
"RTN","PSOOREDT",81,0)
 .I FLN=7 D FLDT^PSOORED2 Q
"RTN","PSOOREDT",82,0)
 .I FLN=21,$$STATUS^PSOBPSUT(RXN,0)="" S VALMSG="Invalid selection!" Q
"RTN","PSOOREDT",83,0)
 .I FLN=21 D  Q
"RTN","PSOOREDT",84,0)
 ..N DAW D EDTDAW^PSODAWUT(RXN,0,.DAW) I $G(DAW)="^" Q
"RTN","PSOOREDT",85,0)
 ..S (PSODRUG("DAW"),PSORXED("FLD",81))=DAW
"RTN","PSOOREDT",86,0)
 .I FLN=9!(FLN=10)!(FLN=11) D NOCHG^PSOORED7 Q
"RTN","PSOOREDT",87,0)
 .S DR=+DR
"RTN","PSOOREDT",88,0)
 .K DIR,DIRUT,DIROUT ;S DIE=52 D ^DIE I $D(Y) S PSORXED("DFLG")=1
"RTN","PSOOREDT",89,0)
 .K DIC,DIQ S DIC=52,DA=PSORXED("IRXN"),DIQ="PSORXED" D EN^DIQ1 K DIC,DIQ
"RTN","PSOOREDT",90,0)
 .S DIR("B")=$S($G(PSORXED("FLD",DR))]"":PSORXED("FLD",DR),1:PSORXED(52,DA,DR)),DIR(0)="52,"_DR D ^DIR
"RTN","PSOOREDT",91,0)
 .I DR=24!(DR=12) S PSORXED("FLD",DR)=X
"RTN","PSOOREDT",92,0)
 .I $D(DIRUT) K DIR,DIRUT,DUOUT,DTOUT,PSORXED(52,DA,DR),PSORXED("FLD",DR) Q
"RTN","PSOOREDT",93,0)
 .I DR'=5,X="@" W !,"Data Required!",! K DIC,DIQ,DR,DA,DIR,DIRUT,PSORXED(52,DA,DR),X,Y Q
"RTN","PSOOREDT",94,0)
 .I DR=5,X'="@" S Y=+Y
"RTN","PSOOREDT",95,0)
 .I DR=3!(DR=20)!(DR=23) S Y=+Y
"RTN","PSOOREDT",96,0)
 .S PSORXED("FLD",DR)=$S(X="@":X,1:Y) K DIR,DIRUT,DIROUT,X,Y,PSORXED(52,DA,DR)
"RTN","PSOOREDT",97,0)
 .I DR=11,PSORXED("FLD",DR)="W",$P(PSOPAR,"^",12) D
"RTN","PSOOREDT",98,0)
 ..D FIELD^DID(52,DR,"","LABEL","ZZ") S PSORXED(ZZ("LABEL"))=PSORXED("FLD",DR) K ZZ
"RTN","PSOOREDT",99,0)
 ..S DR=35,DIQ="PSORXED" D EN^DIQ1 K DIC,DIQ,DIRUT,DUOUT,DTOUT
"RTN","PSOOREDT",100,0)
 ..S:$G(PSORXED(52,DA,DR))]"" DIR("B")=PSORXED(52,DA,DR)
"RTN","PSOOREDT",101,0)
 ..S DIR(0)="52,"_(DR) D ^DIR I $D(DIRUT),X'="@" K DIR,DIRUT Q
"RTN","PSOOREDT",102,0)
 ..S PSORXED("FLD",DR)=X K DIR,DIRUT,DIROUT,X,Y,PSORXED(52,DA,DR)
"RTN","PSOOREDT",103,0)
 .I $G(PSORXED("FLD",DR))]"" D FIELD^DID(52,DR,"","LABEL","ZZ") S PSORXED(ZZ("LABEL"))=PSORXED("FLD",DR) K ZZ
"RTN","PSOOREDT",104,0)
 Q:$G(PSOSIGFL)
"RTN","PSOOREDT",105,0)
 S (RX1,I,RFD,RFDT)=0 F  S I=$O(^PSRX(PSORXED("IRXN"),1,I)) Q:'I  S RFD=I,RFDT=$P(^PSRX(PSORXED("IRXN"),1,I,0),"^"),RX1(I)=$G(RX1(I))+1
"RTN","PSOOREDT",106,0)
 Q
"RTN","PSOOREDT",107,0)
CHK S CHK=1 I $G(^PSDRUG($P(PSORXED("RX0"),"^",6),"I"))]"",^("I")<DT S VALMSG="This drug has been inactivated. ",PSORXED("DFLG")=1 Q
"RTN","PSOOREDT",108,0)
 K PSPOP I $G(PSODIV),$P(PSORXED("RX2"),"^",9)'=PSOSITE S PSPRXN=PSORXED("IRXN") D  Q:PSORXED("DFLG")
"RTN","PSOOREDT",109,0)
 .I '$P(PSOSYS,"^",2) S VALMSG="RX# "_$P(^PSRX(PSPRXN,0),"^")_" is not a valid choice. (Different Division)" S PSORXED("DFLG")=1 Q
"RTN","PSOOREDT",110,0)
 .I $P(PSOSYS,"^",3) K DIR,DUOUT,DTOUT D  K DIR,DUOUT,DTOUT Q
"RTN","PSOOREDT",111,0)
 ..W $C(7) S DIR("A",1)="",DIR("A",2)="RX# "_$P(^PSRX(PSPRXN,0),"^")_" is from another division.",DIR("A")="Continue: (Y/N)",DIR(0)="Y",DIR("?",1)="'Y' FOR YES",DIR("?")="'N' FOR NO"
"RTN","PSOOREDT",112,0)
 ..S DIR("B")="N" D ^DIR I 'Y!($D(DIRUT)) S PSORXED("DFLG")=1 W !
"RTN","PSOOREDT",113,0)
 ;
"RTN","PSOOREDT",114,0)
 I $P(^PSRX(PSORXED("IRXN"),"STA"),"^")=16 D  Q
"RTN","PSOOREDT",115,0)
 . S PSORXED("DFLG")=1 S VALMSG="Prescriptions on Provider Hold cannot be edited."
"RTN","PSOOREDT",116,0)
 ;
"RTN","PSOOREDT",117,0)
CHKX K PSPOP,DIR,DTOUT,DUOUT,Y,X Q
"RTN","PSOOREDT",118,0)
 Q
"RTN","PSOOREDT",119,0)
PROV ;select provider
"RTN","PSOOREDT",120,0)
 S PSORXED("PROVIDER")=$P(RX0,"^",4),PSORXED("PROVIDER NAME")=$P(^VA(200,$P(RX0,"^",4),0),"^")
"RTN","PSOOREDT",121,0)
 D PROV^PSODIR(.PSORXED) I PSORXED("PROVIDER")'=$P(RX0,"^",4) D
"RTN","PSOOREDT",122,0)
 .K DIR,DIRUT W ! S DIR(0)="Y",DIR("A",1)="You have changed the name of the provider entered for this Rx."
"RTN","PSOOREDT",123,0)
 .S DIR("A",2)="This edit will cause the provider's name to be update for all fills.",DIR("A")="Do you want to continue" D ^DIR
"RTN","PSOOREDT",124,0)
 .I 'Y!$D(DIRUT) K PSORX("PROVIDER"),PSORX("PROVIDER NAME"),PSORX("COSIGNING PROVIDER") Q
"RTN","PSOOREDT",125,0)
 .S PSORXED("FLD",4)=PSORXED("PROVIDER") K DIR,DIRUT,DUOUT
"RTN","PSOOREDT",126,0)
 .S PSORXED("FLD",109)=$G(PSORXED("COSIGNING PROVIDER"))
"RTN","PSOOREDT",127,0)
 Q
"RTN","PSOOREDT",128,0)
UDPROV ;update provider
"RTN","PSOOREDT",129,0)
 S $P(^PSRX(PSORXED("IRXN"),0),"^",4)=PSORXED("PROVIDER"),$P(^(3),"^",3)=$G(PSORX("COSIGNING PROVIDER"))
"RTN","PSOOREDT",130,0)
 F XTY="1","P" F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),XTY,I)) Q:'I  S $P(^PSRX(PSORXED("IRXN"),XTY,I,0),"^",17)=PSORXED("PROVIDER") S:XTY RFED=I
"RTN","PSOOREDT",131,0)
 K XTY,I
"RTN","PSOOREDT",132,0)
 Q
"RTN","PSOOREDT",133,0)
SIG ;edit medication instructions (SIG)
"RTN","PSOOREDT",134,0)
 S PSOFDR=+$P(^PSRX(PSORXED("IRXN"),"SIG"),"^",2) I PSOFDR D
"RTN","PSOOREDT",135,0)
 .F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S SIG(I)=^PSRX(PSORXED("IRXN"),"SIG1",I,0)
"RTN","PSOOREDT",136,0)
 E  S PSORX("SIG")=$P(^PSRX(PSORXED("IRXN"),"SIG"),"^")
"RTN","PSOOREDT",137,0)
 D SIG^PSODIR1(.PSORX) D:$G(PSORX("SIG"))]"" EN1^PSOSIGNO(PSORXED("IRXN"),PSORX("SIG"))
"RTN","PSOOREDT",138,0)
 I '$G(PSOSIGFL),$G(PSORX("SIG"))]"" S ^PSRX(PSORXED("IRXN"),"SIG")=PSORX("SIG") K ^PSRX(PSORXED("IRXN"),"SIG1") Q
"RTN","PSOOREDT",139,0)
 S PSOMRFLG=1
"RTN","PSOOREDT",140,0)
 Q
"RTN","PSOOREDT",141,0)
UL ;
"RTN","PSOOREDT",142,0)
 I '$G(PSOLOKED) Q
"RTN","PSOOREDT",143,0)
 D UL^PSSLOCK(PSODFN)
"RTN","PSOOREDT",144,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOOREDT",145,0)
 Q
"RTN","PSOOREDT",146,0)
SVAL ;Set message for patient lock
"RTN","PSOOREDT",147,0)
 S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.")
"RTN","PSOOREDT",148,0)
 Q
"RTN","PSOOREDT",149,0)
SVALO ;Set message for order lock
"RTN","PSOOREDT",150,0)
 S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order.")
"RTN","PSOOREDT",151,0)
 Q
"RTN","PSOOREDT",152,0)
 ;
"RTN","PSOOREDT",153,0)
PAUSE     ;
"RTN","PSOOREDT",154,0)
 N DIR,X,Y
"RTN","PSOOREDT",155,0)
 W ! S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR
"RTN","PSOOREDT",156,0)
 Q
"RTN","PSOOREDT",157,0)
REQFLDS(FIELDS) ; Checks if fields 1,2 or 3 are being edited
"RTN","PSOOREDT",158,0)
 N REQFLDS,I
"RTN","PSOOREDT",159,0)
 S REQFLDS=0
"RTN","PSOOREDT",160,0)
 F I=1:1:$L(FIELDS) I ",1,2,3,"[(","_+$P(FIELDS,",",I)_",") S REQFLDS=1 Q
"RTN","PSOOREDT",161,0)
 Q REQFLDS
"RTN","PSOOREDX")
0^64^B19747673^B19671149
"RTN","PSOOREDX",1,0)
PSOOREDX ;BIR/MHA-Rxs dosing common calls ;03/06/03
"RTN","PSOOREDX",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**133,362,313**;DEC 1997;Build 76
"RTN","PSOOREDX",3,0)
 ;External reference to PS(51.2 supported by DBIA 2226
"RTN","PSOOREDX",4,0)
 ;called from psoored4 & psoored5
"RTN","PSOOREDX",5,0)
VER D KV S DIR(0)="52.0113,8"
"RTN","PSOOREDX",6,0)
 S:$G(PSORXED("VERB",ENT))]"" DIR("B")=PSORXED("VERB",ENT)
"RTN","PSOOREDX",7,0)
 D ^DIR Q
"RTN","PSOOREDX",8,0)
DUPD ;
"RTN","PSOOREDX",9,0)
 D KV S DIR(0)="52.0113,1",DIR("A")="DISPENSE UNITS PER DOSE"_$S($G(PSORXED("NOUN",ENT))]"":"("_PSORXED("NOUN",ENT)_")",1:"")
"RTN","PSOOREDX",10,0)
 I '$G(PSORXED("DOSE",ENT)),$G(PSORXED("DOSE",ENT-1)) S PSORXED("DOSE",ENT)=PSORXED("DOSE",ENT-1)
"RTN","PSOOREDX",11,0)
 Q
"RTN","PSOOREDX",12,0)
 ;
"RTN","PSOOREDX",13,0)
STR S:+STRE>0&(X>0) PSORXED("DOSE",ENT)=(X*STRE) W !,"Dosage Ordered: "_$S($E(PSORXED("DOSE",ENT),1)=".":"0",1:"")_PSORXED("DOSE",ENT)_UNITN,!
"RTN","PSOOREDX",14,0)
 S:X'="" (PSORXED("DOSE ORDERED",ENT),DUPD)=X
"RTN","PSOOREDX",15,0)
 Q
"RTN","PSOOREDX",16,0)
 ;
"RTN","PSOOREDX",17,0)
NOU D KV S DIR(0)="52.0113,3"
"RTN","PSOOREDX",18,0)
 S DIR("B")=$S($G(NOUN)]"":NOUN,1:$G(PSORXED("NOUN",ENT))) K:DIR("B")="" DIR("B")
"RTN","PSOOREDX",19,0)
 S PSONDEF=$G(DIR("B"))
"RTN","PSOOREDX",20,0)
 D ^DIR Q
"RTN","PSOOREDX",21,0)
 ;*313
"RTN","PSOOREDX",22,0)
DUR1 I X="@" K DUR,PSORXED("DURATION",ENT) S:'$G(COPY) PSOSIGFL=1  ;*362 - create new order in CPRS
"RTN","PSOOREDX",23,0)
 I Y'="" S PSORXED("DURATION",ENT)=Y W " ("_$S(Y["L":"MONTHS",Y["W":"WEEKS",Y["H":"HOURS",Y["M":"MINUTES",1:"DAYS")_")"
"RTN","PSOOREDX",24,0)
 Q
"RTN","PSOOREDX",25,0)
 ;
"RTN","PSOOREDX",26,0)
CON D KV S DIR(0)="52.0113,5"
"RTN","PSOOREDX",27,0)
 S:$G(PSORXED("CONJUNCTION",ENT))'="" DIR("B")=PSORXED("CONJUNCTION",ENT)
"RTN","PSOOREDX",28,0)
 D ^DIR Q
"RTN","PSOOREDX",29,0)
 ;
"RTN","PSOOREDX",30,0)
CON1 D KV S DIR(0)="Y",DIR("A",1)="Deleting this conjunction will delete the dosing sequence that follows!"
"RTN","PSOOREDX",31,0)
 S DIR("A")="Are you sure you want to delete",DIR("B")="NO" D ^DIR
"RTN","PSOOREDX",32,0)
 Q
"RTN","PSOOREDX",33,0)
 ;
"RTN","PSOOREDX",34,0)
KV K DIR,DIRUT,DTOUT,DUOUT Q
"RTN","PSOOREDX",35,0)
 ;
"RTN","PSOOREDX",36,0)
 ;
"RTN","PSOOREDX",37,0)
FNM S NM=$E(X,2,4),NM=$TR(NM,"qwertyuioplkjhgfdsazxcvbnm","QWERTYUIOPLKJHGFDSAZXCVBNM")
"RTN","PSOOREDX",38,0)
 S FLDNM=$S(NM="DOS":"DOSE^*Dosage",NM="DIS":"DOSE ORDERED^Dispense Units",NM="ROU":"ROUTE^*Route",NM="SCH":"SCHEDULE^*Schedule",NM="DUR"!(NM="LIM"):"DURATION^*Duration",1:"")
"RTN","PSOOREDX",39,0)
 S:FLDNM="" FLDNM=$S(NM="CON":"CONJUNCTION^*Conjunction",NM="NOU":"NOUN^Noun",NM="VER":"VERB^Verb",1:"")
"RTN","PSOOREDX",40,0)
 Q
"RTN","PSOOREDX",41,0)
JFN K FLDNM,AR S ENT=+Y,FLDNM=$S(NM="NOU":"NOU",NM="VER":"VER",NM="DOS":"ASK",NM="DIS":"DUPD",NM="ROU":"RTE",NM="SCH":"SCH",NM="DUR"!(NM="LIM"):"DUR",NM="CON":"CON",1:"")
"RTN","PSOOREDX",42,0)
 Q
"RTN","PSOOREDX",43,0)
JP2 F AR=1:1:PSORXED("ENT") D:$G(PSORXED("SCHEDULE",AR))]""
"RTN","PSOOREDX",44,0)
 .W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOOREDX",45,0)
 Q
"RTN","PSOOREDX",46,0)
UPD ;updates dosing array
"RTN","PSOOREDX",47,0)
 K PSORXED("CONJUNCTION",ENT) S I=ENT+1 D RV
"RTN","PSOOREDX",48,0)
 S HENT=ENT
"RTN","PSOOREDX",49,0)
UPD1 ;
"RTN","PSOOREDX",50,0)
 S I=HENT+1,J=I+1
"RTN","PSOOREDX",51,0)
 I $G(PSORXED("CONJUNCTION",I))]"",'$D(PSORXED("DOSE",J)) K PSORXED("CONJUNCTION",I) Q
"RTN","PSOOREDX",52,0)
 I $G(PSORXED("CONJUNCTION",I))]"" S PSORXED("CONJUNCTION",HENT)=PSORXED("CONJUNCTION",I) D  G UPD1
"RTN","PSOOREDX",53,0)
 .K PSORXED("CONJUNCTION",I) I $D(PSORXED("DOSE",J)) D
"RTN","PSOOREDX",54,0)
 ..S PSORXED("DOSE",I)=PSORXED("DOSE",J)
"RTN","PSOOREDX",55,0)
 ..S PSORXED("DOSE ORDERED",I)=$G(PSORXED("DOSE ORDERED",J))
"RTN","PSOOREDX",56,0)
 ..S PSORXED("UNITS",I)=$G(PSORXED("UNITS",J))
"RTN","PSOOREDX",57,0)
 ..S PSORXED("NOUN",I)=$G(PSORXED("NOUN",J))
"RTN","PSOOREDX",58,0)
 ..S PSORXED("VERB",I)=$G(PSORXED("VERB",J))
"RTN","PSOOREDX",59,0)
 ..S PSORXED("DURATION",I)=$G(PSORXED("DURATION",J))
"RTN","PSOOREDX",60,0)
 ..S PSORXED("CONJUNCTION",I)=$G(PSORXED("CONJUNCTION",J))
"RTN","PSOOREDX",61,0)
 ..S PSORXED("ROUTE",I)=$G(PSORXED("ROUTE",J))
"RTN","PSOOREDX",62,0)
 ..S PSORXED("SCHEDULE",I)=$G(PSORXED("SCHEDULE",J))
"RTN","PSOOREDX",63,0)
 ..S PSORXED("ODOSE",I)=$G(PSORXED("ODOSE",J))
"RTN","PSOOREDX",64,0)
 ..S HENT=HENT+1,I=HENT+1
"RTN","PSOOREDX",65,0)
 ..I $G(PSORXED("CONJUNCTION",I))]"" Q
"RTN","PSOOREDX",66,0)
 ..K PSORXED("CONJUNCTION",I) D RV
"RTN","PSOOREDX",67,0)
 S PSORXED("ENT")=HENT K HENT D EN^PSOFSIG(.PSORXED)
"RTN","PSOOREDX",68,0)
 Q
"RTN","PSOOREDX",69,0)
RV K PSORXED("UNITS",I),PSORXED("NOUN",I),PSORXED("DURATION",I),PSORXED("ROUTE",I),PSORXED("SCHEDULE",I),PSORXED("DOSE",I),PSORXED("DOSE ORDERED",I),PSORXED("VERB",I),PSORXED("ODOSE",I)
"RTN","PSOOREDX",70,0)
 Q
"RTN","PSOOREDX",71,0)
M1 S VALMSG="Prescription Not Updated!"
"RTN","PSOOREDX",72,0)
 Q
"RTN","PSOOREDX",73,0)
M2 S VALMSG="This edit will create a new prescription!"
"RTN","PSOOREDX",74,0)
 Q
"RTN","PSOOREDX",75,0)
M3 S VALMSG=$S($G(COPY):"Copy Request Cancelled!",1:"Prescription Not Updated!")
"RTN","PSOOREDX",76,0)
 Q
"RTN","PSOOREDX",77,0)
MP1 S VALMSG="Pending Order Not Updated!"
"RTN","PSOOREDX",78,0)
 Q
"RTN","PSOORFI2")
0^53^B94812114^B92022247
"RTN","PSOORFI2",1,0)
PSOORFI2 ;BIR/BHW-finish cprs orders cont. ;07/29/96
"RTN","PSOORFI2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**7,15,23,27,46,130,146,177,222,225,338,313**;DEC 1997;Build 76
"RTN","PSOORFI2",3,0)
 ;External reference ^YSCL(603.01 supported by DBIA 2697
"RTN","PSOORFI2",4,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOORFI2",5,0)
HLP W !,"Enter 'S' to process orders with a priority of STAT",!,"      'E' to process orders with an Emergency priority,",!,"      'R' to process Routine orders.",! Q
"RTN","PSOORFI2",6,0)
HELP ;
"RTN","PSOORFI2",7,0)
 W !,"Please enter a minimum of two (2) characters.",!,"Enter Patient's name whose med orders are to be completed.",!
"RTN","PSOORFI2",8,0)
 S (PATN,DPT)=0 F  S DPT=$O(^PS(52.41,"AOR",DPT)) Q:'DPT  I $D(^PS(52.41,"AOR",DPT,PSOPINST)) W !,$P(^DPT(DPT,0),"^") S PATN=PATN+1 I PATN=20 D  I $D(DUOUT)!($D(DTOUT)) G HELPX
"RTN","PSOORFI2",9,0)
 .K DIR,DUOUT,DTOUT,DIRUT S DIR(0)="E" D ^DIR S PATN=0 K DIR
"RTN","PSOORFI2",10,0)
HELPX K DTOUT,DUOUT,DIRUT,PAINST S DIR(0)="FO^2:30",DIR("A")="Select Patient",DIR("?")="^D HELP^PSOORFIN"
"RTN","PSOORFI2",11,0)
 K PATN,DPT Q
"RTN","PSOORFI2",12,0)
RTE ;
"RTN","PSOORFI2",13,0)
 S PSZFIN=1
"RTN","PSOORFI2",14,0)
 F PSZFZZ=0:0 S PSZFZZ=$O(^PS(52.41,"AC",PAT,$E(PSRT),PSZFZZ)) Q:'PSZFZZ!('PSZFIN)  D
"RTN","PSOORFI2",15,0)
 .I $P($G(^PS(52.41,PSZFZZ,0)),"^",3)="NW"!($P($G(^(0)),"^",3)="RNW")!($P($G(^(0)),"^",3)="RF") I $P($G(^PS(52.41,PSZFZZ,"INI")),"^")=$G(PSOPINST) S PSZFIN=0
"RTN","PSOORFI2",16,0)
 Q
"RTN","PSOORFI2",17,0)
PRI ;
"RTN","PSOORFI2",18,0)
 S PSZFIN=1
"RTN","PSOORFI2",19,0)
 F PSZFZZ=0:0 S PSZFZZ=$O(^PS(52.41,"AP",PAT,$E(PSRT),PSZFZZ)) Q:'PSZFZZ!('PSZFIN)  D
"RTN","PSOORFI2",20,0)
 .I $P($G(^PS(52.41,PSZFZZ,0)),"^",3)="NW"!($P($G(^(0)),"^",3)="RNW")!($P($G(^(0)),"^",3)="RF") I $P($G(^PS(52.41,PSZFZZ,"INI")),"^")=$G(PSOPINST) S PSZFIN=0
"RTN","PSOORFI2",21,0)
 Q
"RTN","PSOORFI2",22,0)
PROFILE ;display med profile
"RTN","PSOORFI2",23,0)
 S MEDA=3 ;3=question asked already
"RTN","PSOORFI2",24,0)
 W !!! K MEDP,DIR,DUOUT,DIRUT,DTOUT S DIR(0)="Y",DIR("B")="Yes",DIR("A")="Do you want to see Medication Profile" D ^DIR K DIR Q:$D(DIRUT)!('Y)
"RTN","PSOORFI2",25,0)
 I Y S MEDP=1
"RTN","PSOORFI2",26,0)
 K DIR,DUOUT,DIRUT,DTOUT
"RTN","PSOORFI2",27,0)
 Q
"RTN","PSOORFI2",28,0)
DC I '$G(PSOORRNW),$G(PSOOPT)=3 S PSORENW("DFLG")=1 S:'$D(PSOBBC1("FROM")) VALMBCK="Q",VALMSG="Renew Rx Request Canceled.",Y=-1 Q
"RTN","PSOORFI2",29,0)
 G DC^PSOORFI6
"RTN","PSOORFI2",30,0)
 Q
"RTN","PSOORFI2",31,0)
DE Q:'$D(^PS(52.41,ORD,0))
"RTN","PSOORFI2",32,0)
 K ^PS(52.41,"AOR",$P(^PS(52.41,ORD,0),"^",2),+$P($G(^PS(52.41,ORD,"INI")),"^"),ORD),^PS(52.41,"AD",$P(^PS(52.41,ORD,0),"^",12),+$P($G(^PS(52.41,ORD,"INI")),"^"),ORD)
"RTN","PSOORFI2",33,0)
 S $P(^PS(52.41,ORD,0),"^",3)="DC",POERR("PLACER")=$P(^(0),"^"),POERR("STAT")="OC"
"RTN","PSOORFI2",34,0)
 S POERR("COMM")=$S($G(POERR("DEAD")):"Patient died on "_$G(PSOPTPST(2,PSODFN,.351))_".",1:ACOM),$P(^PS(52.41,ORD,4),"^")=POERR("COMM")
"RTN","PSOORFI2",35,0)
 D EN^PSOHLSN(POERR("PLACER"),POERR("STAT"),POERR("COMM"),PSONOOR)
"RTN","PSOORFI2",36,0)
 I '$G(POERR("DEAD")) S DIR("A")="Press Return to Continue" D PAUSE^VALM1
"RTN","PSOORFI2",37,0)
 K PSONOOR,PDORUG,ACOM,CMOP,DEA,DEF,DREN,FDR,HDR,PHI,PRC,SIGOK,DIR,DTOUT,DUOUT,DIRUT
"RTN","PSOORFI2",38,0)
 S Y=-1 Q
"RTN","PSOORFI2",39,0)
 ;
"RTN","PSOORFI2",40,0)
RF ;process refill request from CPRS
"RTN","PSOORFI2",41,0)
 S PSOREF("IRXN")=$P(OR0,"^",19) D PSOL^PSSLOCK($P(OR0,"^",19)) I '$G(PSOMSG) D  D PAUSE^VALM1 K PSOREF,PSOMSG Q
"RTN","PSOORFI2",42,0)
 .I $P($G(PSOMSG),"^",2)'="" W $C(7),!!,$P(PSOMSG,"^",2),! Q
"RTN","PSOORFI2",43,0)
 .W $C(7),!!,"Another person is editing Rx "_$P(^PSRX($P(OR0,"^",19),0),"^"),!
"RTN","PSOORFI2",44,0)
 ;
"RTN","PSOORFI2",45,0)
 D FULL^VALM1
"RTN","PSOORFI2",46,0)
 I '$P($G(^PS(52.41,ORD,0)),"^",23),+$G(^PS(52.41,ORD,"FLG")) D  I $D(DIRUT)!'Y S VALMBCK="B" Q
"RTN","PSOORFI2",47,0)
 . K DIRUT,DUOUT,DTOUT,DIR
"RTN","PSOORFI2",48,0)
 . S DIR("A",1)="Flagged by "_$$GET1^DIQ(52.41,ORD,34)_" on "_$$GET1^DIQ(52.41,ORD,33)_": "_$$GET1^DIQ(52.41,ORD,35)
"RTN","PSOORFI2",49,0)
 . S DIR("A",2)=""
"RTN","PSOORFI2",50,0)
 . S DIR("A",3)="Unflagged by "_$$GET1^DIQ(52.41,ORD,37)_" on "_$$GET1^DIQ(52.41,ORD,36)_": "_$$GET1^DIQ(52.41,ORD,38)
"RTN","PSOORFI2",51,0)
 . S DIR("A",4)=""
"RTN","PSOORFI2",52,0)
 . S DIR(0)="Y",DIR("B")="YES",DIR("A")="Continue"
"RTN","PSOORFI2",53,0)
 . W ! D ^DIR
"RTN","PSOORFI2",54,0)
 ;
"RTN","PSOORFI2",55,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 D  Q:$D(DIRUT)!'Y  D EN1^ORCFLAG(+$P($G(^PS(52.41,ORD,0)),"^")) H 1
"RTN","PSOORFI2",56,0)
 . K DIRUT,DUOUT,DTOUT,DIR
"RTN","PSOORFI2",57,0)
 . S DIR("A",1)="This Refill Request is flagged. In order to process it"
"RTN","PSOORFI2",58,0)
 . S DIR("A",2)="you must unflag it first."
"RTN","PSOORFI2",59,0)
 . S DIR("A",3)=""
"RTN","PSOORFI2",60,0)
 . S DIR(0)="Y",DIR("A")="Unflag Refill Request",DIR("B")="NO"
"RTN","PSOORFI2",61,0)
 . W ! D ^DIR I $D(DIRUT)!'Y S VALMBCK="B"
"RTN","PSOORFI2",62,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 Q
"RTN","PSOORFI2",63,0)
 ;
"RTN","PSOORFI2",64,0)
 I $$TITRX^PSOUTL(PSOREF("IRXN"))="t" D  D PAUSE^VALM1 K PSOREF Q
"RTN","PSOORFI2",65,0)
 . W !!,$C(7),"Rx# "_$P(^PSRX($P(OR0,"^",19),0),"^")_" is marked as 'Titration Rx' and cannot be refilled."
"RTN","PSOORFI2",66,0)
 ;
"RTN","PSOORFI2",67,0)
 K PSOMSG S (PSOREF("DFLG"),PSOREF("FIELD"),PSOREF1)=0,X="T-6M",%DT="X" D ^%DT
"RTN","PSOORFI2",68,0)
 S (PSOID,PSOREF("ISSUE DATE"))=$S($P(^PSRX(PSOREF("IRXN"),0),"^",13)<Y:Y,1:$P(^PSRX(PSOREF("IRXN"),0),"^",13))
"RTN","PSOORFI2",69,0)
 S:$G(PSORX("BAR CODE"))&($G(PSOBBC1("FROM"))="NEW") PSOREF("ISSUE DATE")=DT K X,X1,X2
"RTN","PSOORFI2",70,0)
 ;
"RTN","PSOORFI2",71,0)
 S PSONEW("DAYS SUPPLY")=$P(^PSRX(PSOREF("IRXN"),0),"^",8),PSONEW("# OF REFILLS")=$P(^(0),"^",9)
"RTN","PSOORFI2",72,0)
 W !!,"Processing Refill Request for Rx "_$P(^PSRX(PSOREF("IRXN"),0),"^")
"RTN","PSOORFI2",73,0)
 D FILLDT^PSODIR2(.PSOREF) I PSOREF("DFLG") S VALMBCK="R" G END
"RTN","PSOORFI2",74,0)
 ;
"RTN","PSOORFI2",75,0)
 S PSORX("MAIL/WINDOW")=$S($P(OR0,"^",17)="M":"MAIL",1:"WINDOW") D MW^PSODIR2(.PSOREF) I PSOREF("DFLG") S VALMBCK="R" G END
"RTN","PSOORFI2",76,0)
 S:'$G(PSOFROM)'="NEW" PSOFROM="REFILL" S PSOREF("DFLG")=0
"RTN","PSOORFI2",77,0)
 D ^PSOREF0
"RTN","PSOORFI2",78,0)
END D PSOUL^PSSLOCK(PSOREF("IRXN")) K PSOREF,NODE,PSOREF1,PSL,PSOERR,PSORX("QFLG")
"RTN","PSOORFI2",79,0)
 Q
"RTN","PSOORFI2",80,0)
S D KPRI,KPRIZ F  S ORD=$O(^PS(52.41,"AP",PAT,"S",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LOCK1^PSOORFI1,ORD^PSOORFIN S PSOSTATZ=1
"RTN","PSOORFI2",81,0)
 D:$G(POERR("QFLG")) KPRI Q:$G(POERR("QFLG"))  I $G(PSOSTATZ) S ORD=0 D
"RTN","PSOORFI2",82,0)
 .D KPRIZ F  S ORD=$O(^PS(52.41,"AP",PAT,"E",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LOCK1^PSOORFI1,ORD^PSOORFIN
"RTN","PSOORFI2",83,0)
 .Q:$G(POERR("QFLG"))
"RTN","PSOORFI2",84,0)
 .D KPRIZ S ORD=0 F  S ORD=$O(^PS(52.41,"AP",PAT,"R",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LOCK1^PSOORFI1,ORD^PSOORFIN
"RTN","PSOORFI2",85,0)
 D KPRI
"RTN","PSOORFI2",86,0)
 Q
"RTN","PSOORFI2",87,0)
E D KPRI,KPRIZ F  S ORD=$O(^PS(52.41,"AP",PAT,"E",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LOCK1^PSOORFI1,ORD^PSOORFIN S PSOEMERZ=1
"RTN","PSOORFI2",88,0)
 D:$G(POERR("QFLG")) KPRI Q:$G(POERR("QFLG"))  I $G(PSOEMERZ) S ORD=0 D
"RTN","PSOORFI2",89,0)
 .D KPRIZ F  S ORD=$O(^PS(52.41,"AP",PAT,"S",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LOCK1^PSOORFI1,ORD^PSOORFIN
"RTN","PSOORFI2",90,0)
 .Q:$G(POERR("QFLG"))
"RTN","PSOORFI2",91,0)
 .D KPRIZ S ORD=0 F  S ORD=$O(^PS(52.41,"AP",PAT,"R",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LOCK1^PSOORFI1,ORD^PSOORFIN
"RTN","PSOORFI2",92,0)
 D KPRI
"RTN","PSOORFI2",93,0)
 Q
"RTN","PSOORFI2",94,0)
R D KPRI,KPRIZ F  S ORD=$O(^PS(52.41,"AP",PAT,"R",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LOCK1^PSOORFI1,ORD^PSOORFIN S PSOROUTZ=1
"RTN","PSOORFI2",95,0)
 D:$G(POERR("QFLG")) KPRI Q:$G(POERR("QFLG"))  I $G(PSOROUTZ) S ORD=0 D
"RTN","PSOORFI2",96,0)
 .D KPRIZ F  S ORD=$O(^PS(52.41,"AP",PAT,"E",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LOCK1^PSOORFI1,ORD^PSOORFIN
"RTN","PSOORFI2",97,0)
 .Q:$G(POERR("QFLG"))
"RTN","PSOORFI2",98,0)
 .D KPRIZ S ORD=0 F  S ORD=$O(^PS(52.41,"AP",PAT,"S",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LOCK1^PSOORFI1,ORD^PSOORFIN
"RTN","PSOORFI2",99,0)
 D KPRI
"RTN","PSOORFI2",100,0)
 Q
"RTN","PSOORFI2",101,0)
KPRI K PSOSTATZ,PSOROUTZ,PSOEMERZ
"RTN","PSOORFI2",102,0)
 Q
"RTN","PSOORFI2",103,0)
KPRIZ K PSOQUIT,POERR("QFLG")
"RTN","PSOORFI2",104,0)
 Q
"RTN","PSOORFI2",105,0)
INST ;Select Institution
"RTN","PSOORFI2",106,0)
 N PSOCNT
"RTN","PSOORFI2",107,0)
 I '$G(PSOSITE) D ^PSOLSET I '$G(PSOSITE) S PSOIQUIT=1 Q
"RTN","PSOORFI2",108,0)
 N PSIR,PSCT,PSINST K PSOPINST
"RTN","PSOORFI2",109,0)
 S PSCT=0 F PSIR=0:0 S PSIR=$O(^PS(59,PSOSITE,"INI1",PSIR)) Q:'PSIR  I $P($G(^PS(59,PSOSITE,"INI1",PSIR,0)),"^") S PSCT=PSCT+1 I PSCT=1 S PSOPINST=$P($G(^(0)),"^")
"RTN","PSOORFI2",110,0)
 I PSCT=0 W !!,"There are no CPRS Ordering Institutions associated with this Outpatient site!",!,"Use the Site Parameter enter/edit option to enter CPRS Ordering Institutions!",! S PSOIQUIT=1 Q
"RTN","PSOORFI2",111,0)
 I PSCT=1 D INSTNM G INSTA
"RTN","PSOORFI2",112,0)
 W !!!,"There are multiple Institutions associated with this Outpatient Site for",!,"finishing orders entered through CPRS. Select the Institution for which to",!,"finish orders from.  Enter '?' to see all choices.",!
"RTN","PSOORFI2",113,0)
 K PSOPNAME D:$G(PSOPINST)  K DIC S DIC(0)="AEQMZ",DIC="^PS(59,"_PSOSITE_",""INI1""," S:$G(PSOPNAME)'="" DIC("B")=$G(PSOPNAME) D ^DIC K DIC,PSOPNAME I Y<1 W !!,"No Institution selected",! S PSOIQUIT=1 Q
"RTN","PSOORFI2",114,0)
 .K ^UTILITY("DIQ1",$J),DIQ S DA=$G(PSOPINST),DIC=4,DIQ(0)="E",DR=".01" D EN^DIQ1 S PSOPNAME=$G(^UTILITY("DIQ1",$J,4,DA,.01,"E")) K ^UTILITY("DIQ1",$J),DA,DR,DIC,DIQ
"RTN","PSOORFI2",115,0)
 W ! S PSOPINST=$P(Y,"^",2) K Y
"RTN","PSOORFI2",116,0)
 D INSTNM W !,"You have selected "_$G(PSODINST)_"."
"RTN","PSOORFI2",117,0)
 W !,"After completing these orders, you may re-enter this option and select again."
"RTN","PSOORFI2",118,0)
INSTA ;
"RTN","PSOORFI2",119,0)
 S PSOCNT=$$CNT(PSOPINST)
"RTN","PSOORFI2",120,0)
 I '$D(IOINORM)!('$D(IOINHI)) S X="IORVOFF;IORVON;IOINHI;IOINORM" D ENDR^%ZISS
"RTN","PSOORFI2",121,0)
 W !!?7,IORVON_IOINHI,"<There ",$S(PSOCNT=1:"is ",1:"are "),$S(PSOCNT>0:PSOCNT,1:"no")," flagged order",$S(PSOCNT=1:"",1:"s")," for ",PSODINST,">",IOINORM_IORVOFF,!
"RTN","PSOORFI2",122,0)
 K PSODINST
"RTN","PSOORFI2",123,0)
 Q
"RTN","PSOORFI2",124,0)
 ;
"RTN","PSOORFI2",125,0)
CNT(SITE)  ; - Counter for flagged pending orders by Site
"RTN","PSOORFI2",126,0)
 N CNT,ORD
"RTN","PSOORFI2",127,0)
 K ^TMP($J,"PSOFLPO")
"RTN","PSOORFI2",128,0)
 S (CNT,LOGIN,ORD)=0
"RTN","PSOORFI2",129,0)
 F  S LOGIN=$O(^PS(52.41,"AD",LOGIN)) Q:'LOGIN  D
"RTN","PSOORFI2",130,0)
 . F  S ORD=$O(^PS(52.41,"AD",LOGIN,SITE,ORD)) Q:'ORD  D
"RTN","PSOORFI2",131,0)
 . . I $P(^PS(52.41,ORD,0),"^",3)="DC"!($P(^PS(52.41,ORD,0),"^",3)="DE") Q
"RTN","PSOORFI2",132,0)
 . . I $P($G(^PS(52.41,ORD,0)),"^",23) S CNT=CNT+1 S:$P(^(0),"^",2) ^TMP($J,"PSOFLPO",$P(^(0),"^",2))=""
"RTN","PSOORFI2",133,0)
 Q CNT
"RTN","PSOORFI2",134,0)
 ;
"RTN","PSOORFI2",135,0)
INST1 ;
"RTN","PSOORFI2",136,0)
 K PSOPINST N PSIR
"RTN","PSOORFI2",137,0)
 F PSIR=0:0 S PSIR=$O(^PS(59,PSOSITE,"INI1",PSIR)) Q:'PSIR!($G(PSOPINST))  I $P($G(^PS(59,PSOSITE,"INI1",PSIR,0)),"^") S PSOPINST=$P($G(^(0)),"^")
"RTN","PSOORFI2",138,0)
 Q
"RTN","PSOORFI2",139,0)
CLOZ ;checks clozapine status of patient 
"RTN","PSOORFI2",140,0)
 S CLOZPAT=$O(^YSCL(603.01,"C",PSODFN,0))
"RTN","PSOORFI2",141,0)
 S CLOZPAT=$P($G(^YSCL(603.01,+CLOZPAT,0)),"^",3)
"RTN","PSOORFI2",142,0)
 S CLOZPAT=$S(CLOZPAT="M":2,CLOZPAT="B":1,1:0)
"RTN","PSOORFI2",143,0)
 S:'$D(PSONEW("# OF REFILLS")) (PSONEW("# OF REFILLS"),PSONEW("N# REF"))=0
"RTN","PSOORFI2",144,0)
 Q
"RTN","PSOORFI2",145,0)
ELIG I $G(CLOZPAT)=1 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Patient Eligible for 14 Day Supply or 7 Day Supply with 1 refill"
"RTN","PSOORFI2",146,0)
 I $G(CLOZPAT)=2 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Patient Eligible for 28 Day Supply or 14 Day Supply with 1 refill or 7 Day Supply with 3 refill"
"RTN","PSOORFI2",147,0)
 Q
"RTN","PSOORFI2",148,0)
USER(USER) ;returns .01 of 200
"RTN","PSOORFI2",149,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="M",X="`"_USER D ^DIC S USER1=$S(+Y:$P(Y,"^",2),1:"Unknown") K DIC,X,Y
"RTN","PSOORFI2",150,0)
 Q
"RTN","PSOORFI2",151,0)
INSTNM ;
"RTN","PSOORFI2",152,0)
 K PSOFINDA,PSODINST I $G(DA) S PSOFINDA=$G(DA)
"RTN","PSOORFI2",153,0)
 K PSODNM S DA=$G(PSOPINST) I DA S DIC=4,DIQ(0)="E",DR=".01",DIQ="PSODNM" D EN^DIQ1 S PSODINST=$G(PSODNM(4,DA,.01,"E")) K PSODNM,DIC,DR,DA
"RTN","PSOORFI2",154,0)
 I $G(PSOFINDA) S DA=$G(PSOFINDA) K PSOFINDA
"RTN","PSOORFI2",155,0)
 Q
"RTN","PSOORFI2",156,0)
POST S PSOFINY=$G(Y) D ^PSOBUILD S Y=$G(PSOFINY) K PSOFINY D OERR^PSORX1 I $G(PSOQUIT) Q
"RTN","PSOORFI2",157,0)
 K PSOQFLG F PT="GET","DEAD","INP","CNH","TPB","ADDRESS","COPAY" S RTN=PT_"^PSOPTPST" D @RTN K PSOXFLG Q:$G(POERR("DEAD"))!($G(PSOQFLG))
"RTN","PSOORFI2",158,0)
 I $G(POERR("DEAD")) S POERR("QFLG")=1 Q
"RTN","PSOORFI2",159,0)
 K PSOERR("DEAD") I $G(PSOQFLG) Q
"RTN","PSOORFI2",160,0)
 D ^PSOORUT2,BLD^PSOORUT1,EN^PSOLMUTL
"RTN","PSOORFI2",161,0)
 Q
"RTN","PSOORFI2",162,0)
SIG ;
"RTN","PSOORFI2",163,0)
 S SIG=0,PSOFINFL=1 F  S SIG=$O(^PS(52.41,ORD,"SIG",SIG)) Q:'SIG  D
"RTN","PSOORFI2",164,0)
 .S (MIG,SIG(SIG))=^PS(52.41,ORD,"SIG",SIG,0)
"RTN","PSOORFI2",165,0)
 .F SG=1:1:$L(MIG," ") S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(MIG," ",SG) D
"RTN","PSOORFI2",166,0)
 ..I $E(^TMP("PSOPO",$J,IEN,0),$L(^TMP("PSOPO",$J,IEN,0)))=" " S ^TMP("PSOPO",$J,IEN,0)=$E(^TMP("PSOPO",$J,IEN,0),1,($L(^TMP("PSOPO",$J,IEN,0))-1))
"RTN","PSOORFI2",167,0)
 S:$O(SIG(0)) SIGOK=1 K MIG
"RTN","PSOORFI2",168,0)
 F D=0:0 S D=$O(^PS(52.41,ORD,"INS1",D)) Q:'D  S PSONEW("INS",D)=^PS(52.41,ORD,"INS1",D,0)
"RTN","PSOORFI2",169,0)
 Q
"RTN","PSOORNE1")
0^41^B77126364^B72891193
"RTN","PSOORNE1",1,0)
PSOORNE1 ;BIR/SAB - Display new orders from backdoor ;03/06/95 10:30am
"RTN","PSOORNE1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,21,27,32,37,46,71,94,104,117,133,148,279,251,372,313**;DEC 1997;Build 76
"RTN","PSOORNE1",3,0)
 ;External reference to ^PS(55 is supported by DBIA 2228
"RTN","PSOORNE1",4,0)
EN(PSONEW) D DSPL^PSOORNE3,^PSOLMPO2
"RTN","PSOORNE1",5,0)
 Q
"RTN","PSOORNE1",6,0)
EDT N FLD,FIELDLST K DIR,DUOUT,DIRUT S DIR("A")="Select Field to Edit by number",DIR(0)="LO^1:14" D ^DIR I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DTOUT S VALMBCK="" Q
"RTN","PSOORNE1",7,0)
EDTSEL S:'$G(COPY) PSOEDIT=1 S (PSONEW("DFLG"),PSONEW("FIELD"),PSONEW3)=0
"RTN","PSOORNE1",8,0)
 I +Y S FIELDLST=Y D HLDHDR^PSOLMUTL D  Q:$G(PSORX("DFLG"))!($G(PSORX("QFLG")))  S VALMBCK="R" G DSPL^PSOORNE3
"RTN","PSOORNE1",9,0)
 .F FLD=1:1:$L(FIELDLST,",") Q:$P(FIELDLST,",",FLD)']""  D @(+$P(FIELDLST,",",FLD)) Q:$G(PSODIR("DFLG"))!($G(PSODIR("QFLG")))
"RTN","PSOORNE1",10,0)
 E  S VALMBCK="" D FULL^VALM1
"RTN","PSOORNE1",11,0)
 D RDSPL G DSPL^PSOORNE3
"RTN","PSOORNE1",12,0)
 Q
"RTN","PSOORNE1",13,0)
ACP K VALMSG,DIR,PSORX("DFLG") D VER I $G(PSONEW2("QFLG"))!($G(PSORX("DFLG"))) S VALMBCK="Q" K PSONEW2 Q
"RTN","PSOORNE1",14,0)
 N PSONOBCK S PSONOBCK=$S($G(PSOSIGFL):1,1:0)
"RTN","PSOORNE1",15,0)
 D NOOR^PSONEW I $D(DIRUT) S PSONEW("DFLG")=1 K DIR,X,Y,DIRUT,DUOUT,DTOUT Q
"RTN","PSOORNE1",16,0)
 D RXNCHK,RDSPL
"RTN","PSOORNE1",17,0)
 I $G(PSONEW("QFLG")) S PSONEW("DFLG")=1 K DIR,X,Y,DIRUT,DUOUT,DTOUT Q
"RTN","PSOORNE1",18,0)
 D DISPLAY^PSONEW2
"RTN","PSOORNE1",19,0)
 D ^PSONEWG I $G(PSOCPZ("DFLG")) S PSONEW("DFLG")=1 K PSOANSQ,DIR,X,Y,DIRUT,DUOUT,DTOUT,PSOCPZ("DFLG"),PSOANSQD Q
"RTN","PSOORNE1",20,0)
 K PSOCPZ("DFLG")
"RTN","PSOORNE1",21,0)
 K DIR,DIRUT,X,Y S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is this correct" D ^DIR
"RTN","PSOORNE1",22,0)
 I $D(DIRUT) S PSONEW("DFLG")=1 K PSOANSQ,PSOANSQD,DIR,X,Y,DIRUT,DUOUT,DTOUT Q
"RTN","PSOORNE1",23,0)
 I 'Y S VALMBCK="R" K PSOANSQ,DIR,X,Y,DIRUT,DUOUT,DTOUT D DSPL^PSOORNE3 Q
"RTN","PSOORNE1",24,0)
 W "..." K PSOANSQD,DIR,X,Y,DIRUT,DUOUT,DTOUT D DCORD^PSONEW2
"RTN","PSOORNE1",25,0)
 I $G(NCPDPFLG) D NCPDP^PSOORED6
"RTN","PSOORNE1",26,0)
 K:$G(COPY)!($G(PSOSIGFL)) PRC,PHI
"RTN","PSOORNE1",27,0)
 S:'$G(PSOID) PSOID=DT S (PSORX("FN"),PSONEW("POE"))=1 D EN^PSON52(.PSONEW) ; Files entry in File 52
"RTN","PSOORNE1",28,0)
 ;
"RTN","PSOORNE1",29,0)
 ; - Possible Titration prescription
"RTN","PSOORNE1",30,0)
 I $G(PSONEW("IRXN")) D MARK^PSOOTMRX(PSONEW("IRXN"),0)
"RTN","PSOORNE1",31,0)
 ;
"RTN","PSOORNE1",32,0)
 I $G(PSOBEDT) D
"RTN","PSOORNE1",33,0)
 .I '$D(^TMP("PSOBEDT",$J,PSODFN,0)) S ^TMP("PSOBEDT",$J,PSODFN,0)=PSORXED("IRXN") S:$G(PSONEW("MAIL/WINDOW"))["W" ^TMP("PSOBEDT",$J,PSODFN,1)=1 Q
"RTN","PSOORNE1",34,0)
 .S ^TMP("PSOBEDT",$J,PSODFN,0)=^TMP("PSOBEDT",$J,PSODFN,0)_","_PSORXED("IRXN")
"RTN","PSOORNE1",35,0)
 .I $G(PSONEW("MAIL/WINDOW"))["W" S ^TMP("PSOBEDT",$J,PSODFN,1)=1
"RTN","PSOORNE1",36,0)
 D NPSOSD^PSOUTIL(.PSONEW) ; Adds newly added rx to PSOSD array
"RTN","PSOORNE1",37,0)
 D ^PSOBUILD S VALMBCK="Q"
"RTN","PSOORNE1",38,0)
 K PSONEW("# OF REFILLS"),PSONEW("DAYS SUPPLY"),SDA,SEG1,SSN1,STA,Z4,ZDA
"RTN","PSOORNE1",39,0)
 Q:$G(COPY)  S PSONEW("DFLG")=0
"RTN","PSOORNE1",40,0)
 Q
"RTN","PSOORNE1",41,0)
VER I $G(PSOAC),$G(PSODRUG("NAME"))']"" D FULL^VALM1,2^PSOORNW1
"RTN","PSOORNE1",42,0)
 I $G(PSODRUG("NAME"))']"" S VALMSG="A Dispense Drug Must be Chosen!" S PSONEW2("QFLG")=1 Q
"RTN","PSOORNE1",43,0)
 I '$G(PSONEW("ENT")) W !,"Dosing Instruction Missing!!",! D  I PSONEW("DFLG")=1 S PSONEW2("QFLG")=1 Q
"RTN","PSOORNE1",44,0)
 .S PSOORRNW=1
"RTN","PSOORNE1",45,0)
 .K VALMSG D FULL^VALM1 W !,"Drug: "_PSODRUG("NAME")
"RTN","PSOORNE1",46,0)
 .I $O(SIG(0)) F I=1:1 Q:$G(SIG(I))']""  W !,SIG(I)
"RTN","PSOORNE1",47,0)
 .E   I $G(^PSRX(PSONEW("OIRXN"),"SIG"))]"" S X=$P(^PSRX(PSONEW("OIRXN"),"SIG"),"^") D SIGONE^PSOHELP W !,$E($G(INS1),2,250)
"RTN","PSOORNE1",48,0)
 .W ! D 5 K PSOORRNW I PSONEW("DFLG")=1 D M3 Q
"RTN","PSOORNE1",49,0)
 .D 6 D:PSONEW("DFLG")=1 M3
"RTN","PSOORNE1",50,0)
 D:$G(COPY) PROV^PSOUTIL(.PSORENW) I PSONEW("DFLG")=1 S PSONEW2("QFLG")=1 Q
"RTN","PSOORNE1",51,0)
 N PSODOSD D FULL^VALM1,POST^PSODRG:'$G(PSOSIGFL)
"RTN","PSOORNE1",52,0)
 I $G(POERR("DFLG"))=1 S (PSONEW("DFLG"),PSONEW2("QFLG"))=1 Q
"RTN","PSOORNE1",53,0)
 I $G(PSODOSD) S (PSONEW("DFLG"),PSONEW2("QFLG"))=1 Q
"RTN","PSOORNE1",54,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("N") K PSONOOR I $G(PSORX("DFLG")) S VALMBCK="Q" Q
"RTN","PSOORNE1",55,0)
 I +$G(PSEXDT) D
"RTN","PSOORNE1",56,0)
 .D FULL^VALM1 S:$G(PSONEW("MAIL/WINDOW"))["W" BINGCRT="Y",BINGRTE="W"
"RTN","PSOORNE1",57,0)
 .D:+$G(PSEXDT)
"RTN","PSOORNE1",58,0)
 ..S Y=PSONEW("FILL DATE") X ^DD("DD") W !!,$C(7),Y_" fill date is greater than possible expiration date of " S Y=$P(PSEXDT,"^",2) X ^DD("DD") W Y_"."
"RTN","PSOORNE1",59,0)
 .S PSONEW2("QFLG")=1,VALMBCK="R" D PAUSE^VALM1
"RTN","PSOORNE1",60,0)
 Q
"RTN","PSOORNE1",61,0)
1 I $G(PSOSIGFL)!$G(PSOMTFLG) D  Q
"RTN","PSOORNE1",62,0)
 . S PSOAC=1 D 2^PSOORNW1 K PSOAC D RDSPL D DSPL^PSOORNE3
"RTN","PSOORNE1",63,0)
 . I $G(PSOMTFLG),$G(PSORXED("DRUG IEN"))'=$G(PSODRUG("IEN")) D
"RTN","PSOORNE1",64,0)
 . . I FIELDLST'["5," D 5 Q:$G(PSODIR("DFLG"))!($G(PSODIR("QFLG")))
"RTN","PSOORNE1",65,0)
 . . I FIELDLST'["6," D 6 Q:$G(PSODIR("DFLG"))!($G(PSODIR("QFLG")))
"RTN","PSOORNE1",66,0)
 . . I FIELDLST'["8," D 8 Q:$G(PSODIR("DFLG"))!($G(PSODIR("QFLG")))
"RTN","PSOORNE1",67,0)
 ;
"RTN","PSOORNE1",68,0)
 D 6^PSOBKDED D RDSPL G DSPL^PSOORNE3 Q
"RTN","PSOORNE1",69,0)
 ;
"RTN","PSOORNE1",70,0)
2 D 3^PSOBKDED Q
"RTN","PSOORNE1",71,0)
 ;
"RTN","PSOORNE1",72,0)
3 D 1^PSOBKDED Q
"RTN","PSOORNE1",73,0)
 ;
"RTN","PSOORNE1",74,0)
4 D 2^PSOBKDED Q
"RTN","PSOORNE1",75,0)
 ;
"RTN","PSOORNE1",76,0)
5 I '$G(PSODRUG("IEN")) W !,"DRUG NAME REQUIRED!" D 2^PSOORNW1 I '$G(PSODRUG("IEN")) S VALMSG="No Dispense Drug Selected" Q
"RTN","PSOORNE1",77,0)
 W !!,"Drug: "_PSODRUG("NAME") D 10^PSOBKDED Q
"RTN","PSOORNE1",78,0)
 ;
"RTN","PSOORNE1",79,0)
6 D INS^PSOBKDED Q:$G(PSONEW("DFLG"))  I $P($G(^PS(55,PSODFN,"LAN")),"^") D SINS^PSODIR(.PSONEW)
"RTN","PSOORNE1",80,0)
 Q
"RTN","PSOORNE1",81,0)
 ;
"RTN","PSOORNE1",82,0)
7 D 8^PSOBKDED Q
"RTN","PSOORNE1",83,0)
 ;
"RTN","PSOORNE1",84,0)
8 D 7^PSOBKDED Q
"RTN","PSOORNE1",85,0)
 ;
"RTN","PSOORNE1",86,0)
9 D 9^PSOBKDED Q
"RTN","PSOORNE1",87,0)
 ;
"RTN","PSOORNE1",88,0)
10 D 12^PSOBKDED Q
"RTN","PSOORNE1",89,0)
 ;
"RTN","PSOORNE1",90,0)
11 D 5^PSOBKDED Q
"RTN","PSOORNE1",91,0)
 ;
"RTN","PSOORNE1",92,0)
12 D 4^PSOBKDED Q
"RTN","PSOORNE1",93,0)
 ;
"RTN","PSOORNE1",94,0)
13 D 11^PSOBKDED Q
"RTN","PSOORNE1",95,0)
 ;
"RTN","PSOORNE1",96,0)
14 D 13^PSOBKDED Q
"RTN","PSOORNE1",97,0)
 ;
"RTN","PSOORNE1",98,0)
SUMM ;print break down of orders to be finished
"RTN","PSOORNE1",99,0)
 K ^TMP($J,"PSOCZT"),^TMP($J,"PSODPAT"),PAT,RT,DIR,DUOUT,DIRUT,PSZLQUIT
"RTN","PSOORNE1",100,0)
 S DIR("A")="Do you want an Order Summary",DIR(0)="Y",DIR("B")="No"
"RTN","PSOORNE1",101,0)
 D ^DIR K DIR I 'Y!($D(DIRUT)) K Y,X,DIRUT Q
"RTN","PSOORNE1",102,0)
 K PSOINPRT,DIQ,^UTILITY("DIQ1",$J) I $G(PSOPINST) S DA=PSOPINST,DIC=4,DIQ(0)="E",DR=".01" D EN^DIQ1 S PSOINPRT=$G(^UTILITY("DIQ1",$J,4,DA,.01,"E")) K ^UTILITY("DIQ1",$J),DA,DR,DIC,DIQ
"RTN","PSOORNE1",103,0)
 I $D(^PS(52.41,"ACL")) N PSOCLSUM D SUMMCL I $G(PSOCLSUM) K PSOINPRT Q
"RTN","PSOORNE1",104,0)
 F PSI=0:0 S PSI=$O(^PS(52.41,"AOR",PSI)) Q:'PSI  F PSID=0:0 S PSID=$O(^PS(52.41,"AOR",PSI,PSID)) Q:'PSID  F PIN=0:0 S PIN=$O(^PS(52.41,"AOR",PSI,PSID,PIN)) Q:'PIN  D
"RTN","PSOORNE1",105,0)
 .I '$D(^TMP($J,"PSOCZT",PSID,"PAT")) F PZA="PAT","WIN","MAIL","CLIN" S ^TMP($J,"PSOCZT",PSID,PZA)=0
"RTN","PSOORNE1",106,0)
 .I '$D(^TMP($J,"PSODPAT",PSID,PSI)) S ^TMP($J,"PSODPAT",PSID,PSI)=1,^TMP($J,"PSOCZT",PSID,"PAT")=^TMP($J,"PSOCZT",PSID,"PAT")+1
"RTN","PSOORNE1",107,0)
 .S PZROUT=$P($G(^PS(52.41,PIN,0)),"^",17) I PZROUT'="" S ^TMP($J,"PSOCZT",PSID,$S(PZROUT="C":"CLIN",PZROUT="M":"MAIL",1:"WIN"))=^TMP($J,"PSOCZT",PSID,$S(PZROUT="C":"CLIN",PZROUT="M":"MAIL",1:"WIN"))+1
"RTN","PSOORNE1",108,0)
 W @IOF W !?20,"Pending Outpatient Medication Orders",! I $G(PSZCNT)>1 W ?20,"(signed in under "_$G(PSOINPRT)_")",!
"RTN","PSOORNE1",109,0)
 F PSOINL=0:0 S PSOINL=$O(^TMP($J,"PSOCZT",PSOINL)) Q:'PSOINL!($G(PSZLQUIT))  D
"RTN","PSOORNE1",110,0)
 .I ($Y+6)>IOSL K DIR S DIR(0)="E" D ^DIR K DIR D:$G(Y)  I '$G(Y) S PSZLQUIT=1 W ! Q
"RTN","PSOORNE1",111,0)
 ..W @IOF W !?20,"Pending Outpatient Medication Orders",! I $G(PSZCNT)>1 W ?20,"(signed in under "_$G(PSOINPRT)_")",!
"RTN","PSOORNE1",112,0)
 .K ^UTILITY("DIQ1",$J),DIQ,PSOINPRX S DA=$G(PSOINL),DIC=4,DIQ(0)="E",DR=".01" D EN^DIQ1 S PSOINPRX=$G(^UTILITY("DIQ1",$J,4,DA,.01,"E")) K ^UTILITY("DIQ1",$J),DA,DR,DIC,DIQ
"RTN","PSOORNE1",113,0)
 .;PSO*7*279 Change division to Institution
"RTN","PSOORNE1",114,0)
 .W !,"Institution: ",$G(PSOINPRX)
"RTN","PSOORNE1",115,0)
 .W !,"Patients: "_$G(^TMP($J,"PSOCZT",PSOINL,"PAT"))_"  Window: "_$G(^("WIN"))_"  Mail: "_$G(^("MAIL"))_"  Clinic: "_$G(^("CLIN")),!
"RTN","PSOORNE1",116,0)
 K DIR S DIR(0)="E",(DIR("A"),DIR("?"))="Press Return to Continue" D ^DIR K DIR
"RTN","PSOORNE1",117,0)
 K ^TMP($J,"PSOCZT"),^TMP($J,"PSODPAT"),RT,PSOINPRT,PSOINPRX,PSI,PSID,PIN,PZA,PZROUT,PSOINL,PSZLQUIT
"RTN","PSOORNE1",118,0)
 Q
"RTN","PSOORNE1",119,0)
SUMMCL ;
"RTN","PSOORNE1",120,0)
 ;PSO*7*279 Change Division to Institution
"RTN","PSOORNE1",121,0)
 W ! K DIR S DIR(0)="SMB^I:INSTITUTION;C:CLINIC",DIR("A")="Do you want the summary by Institution or Clinic",DIR("B")="Institution",DIR("?")=" "
"RTN","PSOORNE1",122,0)
 S DIR("?",1)="Enter 'I' to see the summary by Institution, and within Institution the orders",DIR("?",2)="shown by Mail, Window, or Administered in Clinic.",DIR("?",3)="Enter 'C' to see the summary by Clinic, along with Clinic Sort Groups."
"RTN","PSOORNE1",123,0)
 D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) S PSOCLSUM=1 Q
"RTN","PSOORNE1",124,0)
 Q:$G(Y)="I"
"RTN","PSOORNE1",125,0)
 S PSOCLSUM=1
"RTN","PSOORNE1",126,0)
 K ^TMP($J,"PSOLOC"),^TMP($J,"PSOLOCP") N PSCX,PSCXL,PSLX,PSCIN,PSCPT,PSCNDE,PSNCL,PSNPAT,PSCLOUT,PSCSFLAG,PCCNT,PSOCAG
"RTN","PSOORNE1",127,0)
 F PSCX=0:0 S PSCX=$O(^PS(52.41,"ACL",PSCX)) Q:'PSCX  F PSLX=0:0 S PSLX=$O(^PS(52.41,"ACL",PSCX,PSLX)) Q:'PSLX  F PSCIN=0:0 S PSCIN=$O(^PS(52.41,"ACL",PSCX,PSLX,PSCIN)) Q:'PSCIN  S PSCPT=+$P($G(^PS(52.41,PSCIN,0)),"^",2) D:PSCPT
"RTN","PSOORNE1",128,0)
 .S PSCNDE=$G(^PS(52.41,PSCIN,0))
"RTN","PSOORNE1",129,0)
 .I $P(PSCNDE,"^",3)'="NW",$P(PSCNDE,"^",3)'="RNW",$P(PSCNDE,"^",3)'="RF" Q
"RTN","PSOORNE1",130,0)
 .I $P(PSCNDE,"^",13)="" Q
"RTN","PSOORNE1",131,0)
 .S PSNCL=+$P(PSCNDE,"^",13),PSNPAT=+$P(PSCNDE,"^",2)
"RTN","PSOORNE1",132,0)
 .I '$D(^TMP($J,"PSOLOC",PSNCL)) S ^TMP($J,"PSOLOC",PSNCL)="1^1",^TMP($J,"PSOLOCP",PSNCL,PSNPAT)="" Q
"RTN","PSOORNE1",133,0)
 .S $P(^TMP($J,"PSOLOC",PSNCL),"^",2)=$P(^TMP($J,"PSOLOC",PSNCL),"^",2)+1
"RTN","PSOORNE1",134,0)
 .I '$D(^TMP($J,"PSOLOCP",PSNCL,PSNPAT)) S $P(^TMP($J,"PSOLOC",PSNCL),"^")=$P(^TMP($J,"PSOLOC",PSNCL),"^")+1
"RTN","PSOORNE1",135,0)
 .S ^TMP($J,"PSOLOCP",PSNCL,PSNPAT)=""
"RTN","PSOORNE1",136,0)
 I '$O(^TMP($J,"PSOLOC",0)) G SUMMQ
"RTN","PSOORNE1",137,0)
 W @IOF W !?20,"Pending Outpatient Medication Orders" I $G(PSZCNT)>1 W !?20,"(signed in under "_$G(PSOINPRT)_")"
"RTN","PSOORNE1",138,0)
 F PSCXL=0:0 S PSCXL=$O(^TMP($J,"PSOLOC",PSCXL)) Q:'PSCXL!($G(PSCLOUT))  D
"RTN","PSOORNE1",139,0)
 .I ($Y+7)>IOSL D CLDIR Q:$G(PSCLOUT)
"RTN","PSOORNE1",140,0)
 .W !!,"Clinic:   ",$P($G(^SC(+PSCXL,0)),"^")
"RTN","PSOORNE1",141,0)
 .W !,"Patients: ",$P($G(^TMP($J,"PSOLOC",PSCXL)),"^"),?16,"Orders: ",$P($G(^TMP($J,"PSOLOC",PSCXL)),"^",2)
"RTN","PSOORNE1",142,0)
 .W !,"In Sort Groups:"
"RTN","PSOORNE1",143,0)
 .S (PCCNT,PSCSFLAG)=0 F PSCSORT=0:0 S PSCSORT=$O(^PS(59.8,PSCSORT)) Q:'PSCSORT!($G(PSCLOUT))  I $D(^PS(59.8,PSCSORT,1,"B",PSCXL)) S PSOCAG=0 D
"RTN","PSOORNE1",144,0)
 ..S PSCSFLAG=1 S:($Y+5)>IOSL&(PCCNT) PSOCAG=1 D:($Y+5)>IOSL&(PCCNT) CLDIR Q:$G(PSCLOUT)  W:$G(PSOCAG) !,"Clinic: "_$P($G(^SC(PSCXL,0)),"^")_"   cont." W:$G(PCCNT)>0 ! W ?16,$P($G(^PS(59.8,PSCSORT,0)),"^") S PCCNT=1
"RTN","PSOORNE1",145,0)
 .I '$G(PSCSFLAG) W ?16,"*** NO CLINIC SORT GROUPS ***"
"RTN","PSOORNE1",146,0)
 I '$G(PSCLOUT) K DIR S DIR(0)="E",(DIR("A"),DIR("?"))="Press Return to continue"  D ^DIR K DIR
"RTN","PSOORNE1",147,0)
SUMMQ K ^TMP($J,"PSOLOC"),^TMP($J,"PSOLOCP")
"RTN","PSOORNE1",148,0)
 Q
"RTN","PSOORNE1",149,0)
CLDIR K DIR S DIR(0)="E",(DIR("A"),DIR("?"))="Press Return to continue, '^' to exit" D ^DIR K DIR I Y'=1 S PSCLOUT=1 Q
"RTN","PSOORNE1",150,0)
 W @IOF
"RTN","PSOORNE1",151,0)
 Q
"RTN","PSOORNE1",152,0)
RXNCHK I $G(PSONEW("RX #"))']"" D RXNCHK^PSOORNE5
"RTN","PSOORNE1",153,0)
 Q
"RTN","PSOORNE1",154,0)
RDSPL D RDSPL^PSOORNE5
"RTN","PSOORNE1",155,0)
 Q
"RTN","PSOORNE1",156,0)
M3 D M3^PSOOREDX
"RTN","PSOORNE1",157,0)
 Q
"RTN","PSOORNE2")
0^31^B68757551^B69776712
"RTN","PSOORNE2",1,0)
PSOORNE2 ;BIR/SAB-display finished orders from backdoor ;9/11/06 10:24am
"RTN","PSOORNE2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,21,23,27,32,37,46,84,103,117,131,146,156,210,148,222,238,264,281,289,251,379,391,313**;DEC 1997;Build 76
"RTN","PSOORNE2",3,0)
 ;^PSDRUG( -  221
"RTN","PSOORNE2",4,0)
 ;^YSCL(603.01 - 2697
"RTN","PSOORNE2",5,0)
 ;^PS(50.606 - 2174
"RTN","PSOORNE2",6,0)
 ;^PS(50.7 - 2223
"RTN","PSOORNE2",7,0)
 ;PSO*210 add call to WORDWRAP api
"RTN","PSOORNE2",8,0)
 ;$$DAWEXT^PSSDAWUT - 4708
"RTN","PSOORNE2",9,0)
 ;
"RTN","PSOORNE2",10,0)
SEL N ORN,ORD I '$G(PSOCNT) S VALMSG="This patient has no Prescriptions!" S VALMBCK="" Q
"RTN","PSOORNE2",11,0)
 D K1^PSOORNE6 S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR I $D(DIRUT) D KV^PSOVER1 S VALMBCK="" Q
"RTN","PSOORNE2",12,0)
NEWSEL N ORN,ORD D K2^PSOORNE6
"RTN","PSOORNE2",13,0)
 ;
"RTN","PSOORNE2",14,0)
 I +Y S PSOOELSE=1,PSLST=Y K PSOREEDT F ORD=1:1:$L(PSLST,",") Q:$P(PSLST,",",ORD)']""  D  D UL1 K ^TMP("PSORXPO",$J) I $G(PSOQUIT) K PSOQUIT Q
"RTN","PSOORNE2",15,0)
 .S ORN=+$P(PSLST,",",ORD) D @$S(+PSOLST(ORN)=52:"ACT",1:"PEN^PSOORNE5")
"RTN","PSOORNE2",16,0)
 .K PSOREEDT,PSOSIGFL,PSONACT,SIGOK,PSOFDR,DRET,SIG,INS1
"RTN","PSOORNE2",17,0)
 K PRC,PHI,RTE I '$G(PSOOELSE) S VALMBCK=""
"RTN","PSOORNE2",18,0)
 K PSONACT,PSOOELSE,CLOZPAT D ^PSOBUILD,BLD^PSOORUT1,K3^PSOORNE6
"RTN","PSOORNE2",19,0)
 Q
"RTN","PSOORNE2",20,0)
 ;
"RTN","PSOORNE2",21,0)
ACT N REF,RPHKEY,PKIND K ^TMP("PSOAO",$J),PCOMX,PDA,PHI,PRC,ACOM,ANS,PSOFDR,CLOZPAT,ANQREM,DUR,DRET
"RTN","PSOORNE2",22,0)
 S RXN=$P(PSOLST(ORN),"^",2),RX0=^PSRX(RXN,0),RX2=$G(^(2)),RX3=$G(^(3)),ST=+$G(^("STA")),RXOR=$G(^("OR1")),POE=$G(^("POE")),EXDT=$S($P($G(^(2)),"^",6)>DT:1,1:0)
"RTN","PSOORNE2",23,0)
 I 'RX3 S RX3=$P(RX2,"^",2),$P(^PSRX(RXN,3),"^")=$P(RX2,"^",2)
"RTN","PSOORNE2",24,0)
 S PSODRG=+$P(RX0,"^",6),PSODRUG0=^PSDRUG(PSODRG,0),INDT=$G(^("I"))
"RTN","PSOORNE2",25,0)
 ;PSO*7*238;SET PSODRUG ARRAY ; PSOY KILLED AT END OF SET^PSODRG
"RTN","PSOORNE2",26,0)
 K PSODRUG
"RTN","PSOORNE2",27,0)
 S PSOY=PSODRG,PSOY(0)=PSODRUG0 D SET^PSODRG
"RTN","PSOORNE2",28,0)
 I 'RXOR,$P(^PSDRUG(PSODRG,2),"^") S $P(^PSRX(RXN,"OR1"),"^")=$P(^PSDRUG(PSODRG,2),"^"),RXOR=$P(^PSDRUG(PSODRG,2),"^")
"RTN","PSOORNE2",29,0)
 I $P($G(^PSDRUG(PSODRG,"CLOZ1")),"^")="PSOCLO1" D
"RTN","PSOORNE2",30,0)
 .S CLOZPAT=$O(^YSCL(603.01,"C",PSODFN,0)) Q:'CLOZPAT
"RTN","PSOORNE2",31,0)
 .;S CLOZPAT=$S($P(^YSCL(603.01,CLOZPAT,0),"^",3)="B":1,1:0)
"RTN","PSOORNE2",32,0)
 .S CLOZPAT=$P(^YSCL(603.01,CLOZPAT,0),"^",3)
"RTN","PSOORNE2",33,0)
 .S CLOZPAT=$S(CLOZPAT="M":2,CLOZPAT="B":1,1:0)
"RTN","PSOORNE2",34,0)
 S PKIND=$D(^PSRX(RXN,"PKI")),RPHKEY=$S('PKIND&($D(^XUSEC("PSORPH",DUZ))):1,PKIND&($D(^XUSEC("PSDRPH",DUZ))):1,1:0)
"RTN","PSOORNE2",35,0)
 I RPHKEY S RPH=1 D
"RTN","PSOORNE2",36,0)
 .S PSOACT=$S('ST&($G(INDT)]"")&(DT>$G(INDT)):"DHPLATC",ST=1!(ST=4):"DVE",ST=3:"DU",ST=5:"ELTD",ST=11:"ETDPCL",ST=12&EXDT:"EDCL",ST=12&'EXDT:"ECL",(ST=14!(ST=15))&'EXDT:"ECL",ST=13:"L",ST=16:"DL",1:"DHPEATCL")
"RTN","PSOORNE2",37,0)
 .D GET^PSOORNE5 S PSOACT=PSOACT_$S(ACTREN:"N",1:""),PSOACT=PSOACT_$S(ACTREF:"R",1:"")
"RTN","PSOORNE2",38,0)
 .I ST=5 S SURX=$O(^PS(52.5,"B",RXN,0)) I SURX,$P($G(^PS(52.5,SURX,0)),"^",7)="L" S PSOACT="TL" K SURX Q
"RTN","PSOORNE2",39,0)
 .S:ST'=12&('$D(^PS(50.7,+$P(RXOR,"^"),0))) PSOACT="DL",VALMSG="No Pharmacy Orderable Item !",PSONACT=1
"RTN","PSOORNE2",40,0)
 .S:ST=12&('$D(^PS(50.7,+$P(RXOR,"^"),0))) PSOACT="L",VALMSG="No Pharmacy Orderable Item !",PSONACT=1
"RTN","PSOORNE2",41,0)
 .S:ST=16 VALMSG="Rx Placed on HOLD by Provider."
"RTN","PSOORNE2",42,0)
 E  D
"RTN","PSOORNE2",43,0)
 .I ST=5 S SURX=$O(^PS(52.5,"B",RXN,0)) I SURX,$P($G(^PS(52.5,SURX,0)),"^",7)="L" S PSOACT="TL" Q
"RTN","PSOORNE2",44,0)
 .S PSOACT=$S(ST'<1&(ST'>4)!(ST>12):"",ST=12&EXDT&($P($G(PSOPAR),"^",2)):"CDPLT",1:"CPLT")
"RTN","PSOORNE2",45,0)
 .D GET^PSOORNE5 S PSOACT=PSOACT_$S(ACTREN:"N",1:""),PSOACT=PSOACT_$S(ACTREF:"R",1:"")
"RTN","PSOORNE2",46,0)
 .S:'$D(^PS(50.7,+$P(RXOR,"^"),0)) PSOACT="L",PSONACT=1,VALMSG="No Pharmacy Orderable Item !"
"RTN","PSOORNE2",47,0)
 ;K PSOLKFL D PSOL^PSSLOCK(RXN) I '$G(PSOMSG) K PSOMSG S PSOLKFL=1 S PSOACT="",VALMSG="This Order is being edited by another user."
"RTN","PSOORNE2",48,0)
 K PSOMSG S IEN=0,$P(RN," ",12)=" "
"RTN","PSOORNE2",49,0)
 D DIN^PSONFI(+RXOR,$P(RX0,"^",6))
"RTN","PSOORNE2",50,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=$S($P($G(^PSRX(RXN,"TPB")),"^"):"            TPB Rx #: ",1:"                Rx #: ")
"RTN","PSOORNE2",51,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_$P(RX0,"^")_$S($G(^PSRX(RXN,"IB")):"$",1:"")_$$ECME^PSOBPSUT(RXN)_$$TITRX^PSOUTL(RXN)_$E(RN,$L($P(RX0,"^")_$S($G(^PSRX(RXN,"IB")):"$",1:"")_$$ECME^PSOBPSUT(RXN)_$$TITRX^PSOUTL(RXN))+1,12)
"RTN","PSOORNE2",52,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" ("_$S($P(PSOPAR,"^",3):1,1:"#")_")"_" *Orderable Item: "_$S($D(^PS(50.7,$P(+RXOR,"^"),0)):$P(^PS(50.7,$P(+RXOR,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^"),1:"")_NFIO
"RTN","PSOORNE2",53,0)
 S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOAO",$J,IEN,0))-4)
"RTN","PSOORNE2",54,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" ("_$S($P(PSOPAR,"^",3):2,1:"#")_")"_$S($D(^PSDRUG("AQ",$P(RX0,"^",6))):"       CMOP ",1:"            ")_"Drug: "_$P(^PSDRUG($P(RX0,"^",6),0),"^")_NFID
"RTN","PSOORNE2",55,0)
 S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOAO",$J,IEN,0))-4)
"RTN","PSOORNE2",56,0)
 I $$STATUS^PSOBPSUT(RXN,0)'="",$$RXRLDT^PSOBPSUT(RXN,0) D
"RTN","PSOORNE2",57,0)
 . S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" "_$S('$P(PSOPAR,"^",3):"(2)",1:"   ")_"             NDC: "_$$GETNDC^PSONDCUT(RXN,0)
"RTN","PSOORNE2",58,0)
 S:$G(^PSRX(RXN,"TN"))]"" IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="          Trade Name: "_$G(^PSRX(RXN,"TN"))
"RTN","PSOORNE2",59,0)
 D DOSE^PSOORNE5
"RTN","PSOORNE2",60,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" (4)Pat Instructions:" D INS^PSOORNE5
"RTN","PSOORNE2",61,0)
 D PC^PSOORNE5
"RTN","PSOORNE2",62,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                 SIG:"
"RTN","PSOORNE2",63,0)
 I '$P($G(^PSRX(RXN,"SIG")),"^",2) S SIGOK=0 D  G PTST
"RTN","PSOORNE2",64,0)
 .S X=$P($G(^PSRX(RXN,"SIG")),"^") D SIGONE^PSOHELP S SIG=$E($G(INS1),2,250)
"RTN","PSOORNE2",65,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOAO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOAO",$J,IEN,0)," ",21)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOAO",$J,IEN,0)=$G(^TMP("PSOAO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNE2",66,0)
 S SIGOK=1
"RTN","PSOORNE2",67,0)
 F I=0:0 S I=$O(^PSRX(RXN,"SIG1",I)) Q:'I  D                  ;PSO*210
"RTN","PSOORNE2",68,0)
 . S MIG=$P(^PSRX(RXN,"SIG1",I,0),"^")
"RTN","PSOORNE2",69,0)
 . D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAO",$J)),21)
"RTN","PSOORNE2",70,0)
 S SIGOK=1 K MIG,SG
"RTN","PSOORNE2",71,0)
PTST S $P(RN," ",25)=" ",PTST=$S($G(^PS(53,+$P(RX0,"^",3),0))]"":$P($G(^PS(53,+$P(RX0,"^",3),0)),"^"),1:""),IEN=IEN+1
"RTN","PSOORNE2",72,0)
 S ^TMP("PSOAO",$J,IEN,0)=" (5)  Patient Status: "_PTST_$E(RN,$L(PTST)+1,25)
"RTN","PSOORNE2",73,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" (6)      Issue Date: "_$E($P(RX0,"^",13),4,5)_"/"_$E($P(RX0,"^",13),6,7)_"/"_$E($P(RX0,"^",13),2,3)
"RTN","PSOORNE2",74,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"               (7)  Fill Date: "_$E($P(RX2,"^",2),4,5)_"/"_$E($P(RX2,"^",2),6,7)_"/"_$E($P(RX2,"^",2),2,3)
"RTN","PSOORNE2",75,0)
 S ROU=$S($P(RX0,"^",11)="W":"Window",1:"Mail")
"RTN","PSOORNE2",76,0)
 S REFL=$P(RX0,"^",9),I=0 F  S I=$O(^PSRX(RXN,1,I)) Q:'I  S REFL=REFL-1,ROU=$S($P(^PSRX(RXN,1,I,0),"^",2)="W":"Window",1:"Mail")
"RTN","PSOORNE2",77,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="      Last Fill Date: "_$E($P(RX3,"^"),4,5)_"/"_$E($P(RX3,"^"),6,7)_"/"_$E($P(RX3,"^"),2,3)
"RTN","PSOORNE2",78,0)
 D CMOP^PSOORNE3
"RTN","PSOORNE2",79,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_" ("_ROU_$S($G(PSOCMOP)]"":", "_PSOCMOP,1:"")_")" K ROU,PSOCMOP
"RTN","PSOORNE2",80,0)
 S IEN=IEN+1 I $P(RX2,"^",15) S ^TMP("PSOAO",$J,IEN,0)="   Returned to Stock: "_$E($P(RX2,"^",15),4,5)_"/"_$E($P(RX2,"^",15),6,7)_"/"_$E($P(RX2,"^",15),2,3)_$S($P(RX2,"^",14):" (Reprinted)",1:"")
"RTN","PSOORNE2",81,0)
 E  S ^TMP("PSOAO",$J,IEN,0)="   Last Release Date: " D
"RTN","PSOORNE2",82,0)
 .S RLD=$S($P(RX2,"^",13):$E($P(RX2,"^",13),4,5)_"/"_$E($P(RX2,"^",13),6,7)_"/"_$E($P(RX2,"^",13),2,3),1:"")
"RTN","PSOORNE2",83,0)
 .I $O(^PSRX(RXN,1,0)) F I=0:0 S I=$O(^PSRX(RXN,1,I)) Q:'I  D
"RTN","PSOORNE2",84,0)
 ..I $P(^PSRX(RXN,1,I,0),"^",18) S RLD=$E($P(^(0),"^",18),4,5)_"/"_$E($P(^(0),"^",18),6,7)_"/"_$E($P(^(0),"^",18),2,3)
"RTN","PSOORNE2",85,0)
 .S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_$S($G(RLD)]"":RLD,1:"        ")
"RTN","PSOORNE2",86,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"               (8)      Lot #: "_$P($G(RX2),"^",4)
"RTN","PSOORNE2",87,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="             Expires: "_$E($P(RX2,"^",6),4,5)_"/"_$E($P(RX2,"^",6),6,7)_"/"_$E($P(RX2,"^",6),2,3)
"RTN","PSOORNE2",88,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"                          MFG: "_$P($G(RX2),"^",8)
"RTN","PSOORNE2",89,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(9)      Days Supply: "_$P(RX0,"^",8)_$S($L($P(RX0,"^",8))=1:" ",1:"")
"RTN","PSOORNE2",90,0)
 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"                    (10)  QTY"_$S($P($G(^PSDRUG($P(RX0,"^",6),660)),"^",8)]"":" ("_$P($G(^PSDRUG($P(RX0,"^",6),660)),"^",8)_")",1:" (  )")_": "_$P(RX0,"^",7)
"RTN","PSOORNE2",91,0)
 I $P($G(^PSDRUG($P(RX0,"^",6),5)),"^")]"" D
"RTN","PSOORNE2",92,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNE2",93,0)
 .S ^TMP("PSOAO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG($P(RX0,"^",6),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG($P(RX0,"^",6),5),"^") K RN
"RTN","PSOORNE2",94,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(11)    # of Refills: "_$P(RX0,"^",9)_$S($L($P(RX0,"^",9))=1:" ",1:"")_"                          Remaining: "_REFL
"RTN","PSOORNE2",95,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(12)        Provider: "_$S($D(^VA(200,$P(RX0,"^",4),0)):$P(^VA(200,$P(RX0,"^",4),0),"^"),1:"UNKNOWN")
"RTN","PSOORNE2",96,0)
 I +$P($G(^PSDRUG($P(RX0,"^",6),0)),"^",3)>1,+$P($G(^PSDRUG($P(RX0,"^",6),0)),"^",3)<6 D PRV^PSOORNE5
"RTN","PSOORNE2",97,0)
 I $P(RX3,"^",3) S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="        Cos-Provider: "_$P(^VA(200,$S($G(PSORX("COSIGNING PROVIDER")):PSORX("COSIGNING PROVIDER"),1:$P(RX3,"^",3)),0),"^")
"RTN","PSOORNE2",98,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(13)         Routing: "_$S($P(RX0,"^",11)="M":"MAIL",1:"WINDOW")_"                  (14)     Copies: "_$S($P(RX0,"^",18):$P(RX0,"^",18),1:1)
"RTN","PSOORNE2",99,0)
 S:$P(RX0,"^",11)="W"&($P(PSOPAR,"^",12)) IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="    Method of Pickup: "_$G(^PSRX(RXN,"MP"))
"RTN","PSOORNE2",100,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(15)          Clinic: "_$S($D(^SC(+$P(RX0,"^",5),0)):$P(^SC($P(RX0,"^",5),0),"^"),1:"Not on File")
"RTN","PSOORNE2",101,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(16)        Division: "_$S($G(^PS(59,+$P(RX2,"^",9),0))]"":$P(^PS(59,$P(RX2,"^",9),0),"^")_" ("_$P(^(0),"^",6)_")",1:"UNKNOWN")
"RTN","PSOORNE2",102,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(17)      Pharmacist: "_$S($P(RX2,"^",3):$P(^VA(200,$P(RX2,"^",3),0),"^"),1:"")
"RTN","PSOORNE2",103,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(18)         Remarks:" D RMK^PSOORNE3
"RTN","PSOORNE2",104,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(19)      Counseling: "_$S($P($G(^PSRX(RXN,"PC")),"^"):"YES",1:"NO")_"                      "_$S($P($G(^PSRX(RXN,"PC")),"^"):"Was Counseling Understood: "_$S($P($G(^PSRX(RXN,"PC")),"^",2):"YES",1:"NO"),1:"")
"RTN","PSOORNE2",105,0)
 S:$O(^PSRX(RXN,1,0)) REF=1,IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="(20)     Refill Data"
"RTN","PSOORNE2",106,0)
 I $$STATUS^PSOBPSUT(RXN,0)'="" D
"RTN","PSOORNE2",107,0)
 . N DAW S IEN=IEN+1,DAW=$$GETDAW^PSODAWUT(RXN,0)
"RTN","PSOORNE2",108,0)
 . S ^TMP("PSOAO",$J,IEN,0)="(21)        DAW Code: "_DAW_" - "_$$DAWEXT^PSSDAWUT(DAW)
"RTN","PSOORNE2",109,0)
 D DISP^PSOORNE6
"RTN","PSOORNE2",110,0)
 I $G(PSOBEDT),PSOACT["E" S PSOACT="E"
"RTN","PSOORNE2",111,0)
 I $G(PSOBEDT),PSOACT'["E" S PSOACT=""
"RTN","PSOORNE2",112,0)
 Q:$G(PSORXED)!($G(COPY))!($G(UPMI))
"RTN","PSOORNE2",113,0)
 S:$G(PSOBEDT) (PSOEDIT,PSORXED)=1
"RTN","PSOORNE2",114,0)
RENERR S PSORERR=0 D ^PSOLMLST
"RTN","PSOORNE2",115,0)
 I PSORERR=1 S:$G(PSOBEDT) (PSOEDIT,PSORXED)=1 G RENERR
"RTN","PSOORNE2",116,0)
 K DRET,SIG
"RTN","PSOORNE2",117,0)
 Q
"RTN","PSOORNE2",118,0)
UL1 ;
"RTN","PSOORNE2",119,0)
 Q
"RTN","PSOORNE3")
0^56^B68981522^B68130643
"RTN","PSOORNE3",1,0)
PSOORNE3 ;ISC-BHAM/SAB - display pending orders from backdoor ;2/3/05 1:59pm
"RTN","PSOORNE3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,9,39,59,46,103,124,139,152,194,391,313**;DEC 1997;Build 76
"RTN","PSOORNE3",3,0)
 ;Ext ref to ^SC (File #44) (DBIA 10040),^PSXOPUTL (DBIA 2200)
"RTN","PSOORNE3",4,0)
 ;^PS(50.606 (DBIA 2174),^PS(50.7 DBIA 2223),^PS(55,DBIA 2228)
"RTN","PSOORNE3",5,0)
 ;^PSDRUG (DBIA 221)
"RTN","PSOORNE3",6,0)
 K ^TMP("PSOPO",$J) S ORD=$P(PSOLST(ORN),"^",2) D ORD^PSOORFIN Q
"RTN","PSOORNE3",7,0)
 S PSODRUG("OI")=$P(OR0,"^",8),PSODRUG("OIN")=$P(^PS(50.7,$P(OR0,"^",8),0),"^")
"RTN","PSOORNE3",8,0)
 I $P($G(OR0),"^",9) S DREN=$P(OR0,"^",9) S POERR=1 D DRG^PSOORDRG K POERR ;D POST^PSODRG
"RTN","PSOORNE3",9,0)
 I '$P(OR0,"^",9) D DREN^PSOORNW2
"RTN","PSOORNE3",10,0)
 S PSONEW("# OF REFILLS")=$P(OR0,"^",11)
"RTN","PSOORNE3",11,0)
 S (Y,PSONEW("ISSUE DATE"))=$S($G(PSONEW("ISSUE DATE")):PSONEW("ISSUE DATE"),1:$E($P(OR0,"^",6),1,7)) X ^DD("DD")
"RTN","PSOORNE3",12,0)
 S PSONEW("CLERK CODE")=$P(OR0,"^",4),PSORX("CLERK CODE")=$P(^VA(200,$P(OR0,"^",4),0),"^")
"RTN","PSOORNE3",13,0)
 S (PSONEW("DFLG"),PSONEW("QFLG"))=0,PSODFN=$P(OR0,"^",2)
"RTN","PSOORNE3",14,0)
 I '$G(PSOMTFLG) S PSONEW("QTY")=$P(OR0,"^",10)
"RTN","PSOORNE3",15,0)
 S PSONEW("MAIL/WINDOW")=$S($P(OR0,"^",17)]"":$P(OR0,"^",17),1:"W")
"RTN","PSOORNE3",16,0)
 S:$G(PSONEW("CLINIC"))']"" PSONEW("CLINIC")=$P(OR0,"^",13)
"RTN","PSOORNE3",17,0)
 S:$G(PSORX("CLINIC"))']"" PSORX("CLINIC")=$S($D(^SC(+$P(OR0,"^",13),0)):$P(^SC($P(OR0,"^",13),0),"^"),1:"")
"RTN","PSOORNE3",18,0)
 S PSONEW("CLERK CODE")=$P(OR0,"^",4),PSONEW("PROVIDER")=$P(OR0,"^",5),PSONEW("PROVIDER NAME")=$P(^VA(200,$P(OR0,"^",5),0),"^")
"RTN","PSOORNE3",19,0)
 S PSONEW("PATIENT STATUS")=$S(+$G(^PS(55,PSODFN,"PS")):+$G(^PS(55,PSODFN,"PS")),1:"")
"RTN","PSOORNE3",20,0)
 S PSONEW("DAYS SUPPLY")=$S(+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3)):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:30)
"RTN","PSOORNE3",21,0)
 S IEN=0 D OBX^PSOORFI1,DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:"")) ;Setup for N/F & DIN indicator
"RTN","PSOORNE3",22,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="* (1) Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNE3",23,0)
 S:NFIO["DIN" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNE3",24,0)
 K LST S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (2)           Drug: "_$S($G(PSODRUG("NAME"))]"":PSODRUG("NAME")_NFID,1:"No Dispense Drug Selected")
"RTN","PSOORNE3",25,0)
 S:NFID["DIN" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNE3",26,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (3) Patient Status: "_$P($G(^PS(53,PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORNE3",27,0)
 S IEN=IEN+1,(PSOID,Y)=$E($P(OR0,"^",6),1,7) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)="   (4)     Issue Date: "_Y
"RTN","PSOORNE3",28,0)
 S (Y,PSONEW("FILL DATE"))=$E($P(OR0,"^",6),1,7) X ^DD("DD") S PSONEW("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                       (5) Fill Date: "_Y
"RTN","PSOORNE3",29,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Instructions:" S TY=3 D INST^PSOORFI1
"RTN","PSOORNE3",30,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (6)   Possible SIG: " D:$G(PSONEW("SIG"))']"" SIG^PSOORFI1 S:$G(PSONEW("SIG"))]"" IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$G(PSONEW("SIG")),IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=PSOERR("SIG")
"RTN","PSOORNE3",31,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (7)    Days Supply: "_$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3)):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:"")
"RTN","PSOORNE3",32,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                                 (8)     QTY: "_$P(OR0,"^",10)
"RTN","PSOORNE3",33,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (9)   # of Refills: "_$P(OR0,"^",11)_$E("  ",$L($P(OR0,"^",11))+1,2)_"                                (10) Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORNE3",34,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (11)         Clinic: "_PSORX("CLINIC")
"RTN","PSOORNE3",35,0)
 S $P(RN," ",32)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (12)       Provider: "_PSONEW("PROVIDER NAME")_$E(RN,$L(PSONEW("PROVIDER NAME"))+1,32)_"  (13)  Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1) K RN
"RTN","PSOORNE3",36,0)
 I $P(^VA(200,$S($G(PSONEW("PROVIDER")):PSONEW("PROVIDER"),1:$P(OR0,"^",5)),"PS"),"^",7)&($P(^("PS"),"^",8)) S IEN=IEN+1,PSONEW("COSIGNING PROVIDER")=$P(^("PS"),"^",8) D
"RTN","PSOORNE3",37,0)
 .S ^TMP("PSOPO",$J,IEN,0)="        Cos-Provider: "_$P(^VA(200,+$G(PSONEW("COSIGNING PROVIDER")),0),"^")
"RTN","PSOORNE3",38,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Provider Comments:" S TY=2 D INST^PSOORFI1
"RTN","PSOORNE3",39,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (14)        Remarks: "
"RTN","PSOORNE3",40,0)
 I $G(PSONEW("REMARKS"))]"" D
"RTN","PSOORNE3",41,0)
 .F SG=1:1:$L(PSONEW("REMARKS")) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("REMARKS")," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNE3",42,0)
 ..S:$P(PSONEW("REMARKS")," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("REMARKS")," ",SG)
"RTN","PSOORNE3",43,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,$P(OR0,"^",4),0),"^")_$E(RN,$L($P(^VA(200,$P(OR0,"^",4),0),"^"))+1,35)
"RTN","PSOORNE3",44,0)
 S Y=$P(OR0,"^",12) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$E($P(OR0,"^",12),4,5)_"/"_$E($P(OR0,"^",12),6,7)_"/"_$E($P(OR0,"^",12),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORNE3",45,0)
 G ^PSOLMPO
"RTN","PSOORNE3",46,0)
 Q
"RTN","PSOORNE3",47,0)
DSPL ;backdoor
"RTN","PSOORNE3",48,0)
 K ^TMP("PSOPO",$J) D DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:"")) ;NFI
"RTN","PSOORNE3",49,0)
 I $D(RX0),$D(PSODRUG("IEN")) D
"RTN","PSOORNE3",50,0)
 .I PSODRUG("IEN")=$P(RX0,"^",6)!($P(PSLST,",",2)) D RST
"RTN","PSOORNE3",51,0)
 S IEN=0,IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNE3",52,0)
 S:NFIO["DIN" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNE3",53,0)
 I $G(PSODRUG("NAME"))]"" D  G PST
"RTN","PSOORNE3",54,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (1)"_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORNE3",55,0)
 .S:NFID["DIN" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNE3",56,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (1)           Drug: No Dispense Drug Selected"
"RTN","PSOORNE3",57,0)
PST S:$G(PSODRUG("TRADE NAME"))]"" IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          Trade Name: "_$S($G(PSODRUG("TRADE NAME"))]"":PSODRUG("TRADE NAME"),1:"")
"RTN","PSOORNE3",58,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (2) Patient Status: "_$P($G(^PS(53,PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORNE3",59,0)
 I $G(PSOID) S Y=PSOID X ^DD("DD") S PSONEW("ISSUE DATE")=Y
"RTN","PSOORNE3",60,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (3)     Issue Date: "_PSONEW("ISSUE DATE")
"RTN","PSOORNE3",61,0)
 S X2=PSONEW("DAYS SUPPLY")*(PSONEW("# OF REFILLS")+1)\1
"RTN","PSOORNE3",62,0)
 S X1=$S($G(PSOID):PSOID,1:DT)
"RTN","PSOORNE3",63,0)
 S X2=$S(PSONEW("DAYS SUPPLY")=X2:X2,+$G(PSOX("CS")):184,1:366)
"RTN","PSOORNE3",64,0)
 I X2<30 D
"RTN","PSOORNE3",65,0)
 . N % S %=$P($G(PSORX("PATIENT STATUS")),"^"),X2=30
"RTN","PSOORNE3",66,0)
 . S:%?.N %=$P($G(^PS(53,+%,0)),"^") I %["AUTH ABS" S X2=5
"RTN","PSOORNE3",67,0)
 D C^%DTC I PSONEW("FILL DATE")>X S PSONEW("FILL DATE")=PSONEW("ISSUE DATE")
"RTN","PSOORNE3",68,0)
 S Y=PSONEW("FILL DATE") X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"             (4) Fill Date: "_Y
"RTN","PSOORNE3",69,0)
 D DOSE^PSOBKDED
"RTN","PSOORNE3",70,0)
 I $G(PSORXED("IRXN")),'$G(PSOSIGFL) S RXN=PSORXED("IRXN") D:'$G(COPY) INST1^PSOORNE5 K RXN
"RTN","PSOORNE3",71,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                 SIG:"
"RTN","PSOORNE3",72,0)
 I $G(SIGOK),$O(SIG(0)) D SIG G DSP
"RTN","PSOORNE3",73,0)
 I $D(PSOCOPY),$G(PSONEW("SIG"))']"" D SIG G DSP
"RTN","PSOORNE3",74,0)
 I $G(PSOSIGFL),$G(PSONEW("SIG"))']"" D SIG G DSP
"RTN","PSOORNE3",75,0)
 D:$G(PSONEW("SIG"))]""
"RTN","PSOORNE3",76,0)
 .S X=PSONEW("SIG") D SIGONE^PSOHELP S SIG=$E($G(INS1),2,250)
"RTN","PSOORNE3",77,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNE3",78,0)
DSP S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (7)    Days Supply: "_PSONEW("DAYS SUPPLY")_$S($L(PSONEW("DAYS SUPPLY"))=1:" ",1:"")
"RTN","PSOORNE3",79,0)
 I '$D(PSONEW("FLD")),$D(RX0),'$G(PSOMTFLG) S PSONEW("QTY")=$P(RX0,"^",7)
"RTN","PSOORNE3",80,0)
 ;if sched PSONEW("FLD") not def. qty reset
"RTN","PSOORNE3",81,0)
 ;if qty PSONEW("FLD")=7, qty NOT reset
"RTN","PSOORNE3",82,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                     (8)   QTY"_$S($G(PSODRUG("UNIT"))]"":" ("_PSODRUG("UNIT")_")",1:" ( )")_": "_PSONEW("QTY")
"RTN","PSOORNE3",83,0)
 I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),5)),"^")]"" D
"RTN","PSOORNE3",84,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNE3",85,0)
 .S ^TMP("PSOPO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^") K RN
"RTN","PSOORNE3",86,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (9)   # of Refills: "_PSONEW("# OF REFILLS")_$S($L(PSONEW("# OF REFILLS"))=1:" ",1:"")_"                     (10)  Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORNE3",87,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (11)         Clinic: "_$S($G(PSONEW("CLINIC")):$P(^SC(PSONEW("CLINIC"),0),"^"),1:"")
"RTN","PSOORNE3",88,0)
 S $P(RN," ",31)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (12)       Provider: "_PSONEW("PROVIDER NAME")_$E(RN,$L(PSONEW("PROVIDER NAME"))+1,31)_"(13)   Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1) K RN
"RTN","PSOORNE3",89,0)
 I $G(PKI),+$G(PSODRUG("DEA"))>1,+$G(PSODRUG("DEA"))<6 D PRV^PSOORFI5($G(PSONEW("PROVIDER")),$G(PSODRUG("IEN")),$P(OR0,"^"))
"RTN","PSOORNE3",90,0)
 I $G(PSONEW("COSIGNING PROVIDER"))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="        Cos-Provider: "_$P(^VA(200,PSONEW("COSIGNING PROVIDER"),0),"^")
"RTN","PSOORNE3",91,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (14)        Remarks:"
"RTN","PSOORNE3",92,0)
 I $G(PSONEW("REMARKS"))]"" D
"RTN","PSOORNE3",93,0)
 .F SG=1:1:$L(PSONEW("REMARKS")) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("REMARKS")," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " D
"RTN","PSOORNE3",94,0)
 ..S:$P(PSONEW("REMARKS")," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("REMARKS")," ",SG)
"RTN","PSOORNE3",95,0)
 I $G(PSORXED("IRXN")),'$G(PSOSIGFL) S RXN=PSORXED("IRXN") D:'$G(COPY) PC1^PSOORNE5 K RXN
"RTN","PSOORNE3",96,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,DUZ,0),"^")_$E(RN,$L($P(^VA(200,DUZ,0),"^"))+1,35)
"RTN","PSOORNE3",97,0)
 D NOW^%DTC S PSONEW("LOGIN DATE")=% K %,X S Y=PSONEW("LOGIN DATE") X ^DD("DD")
"RTN","PSOORNE3",98,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$P(Y,"@")_" "_$P(Y,"@",2) K RN,PSOFDR
"RTN","PSOORNE3",99,0)
 S (VALMCNT,PSOPF)=IEN Q
"RTN","PSOORNE3",100,0)
SIG ;
"RTN","PSOORNE3",101,0)
 D SIG^PSOORNE6 Q
"RTN","PSOORNE3",102,0)
CMOP ;
"RTN","PSOORNE3",103,0)
 K PSXZ S X="PSXOPUTL" X ^%ZOSF("TEST") K X I  D
"RTN","PSOORNE3",104,0)
 .S DA=RXN D ^PSXOPUTL K DA,PSOCMOP
"RTN","PSOORNE3",105,0)
 .S PSOCMOP=$S($G(PSXZ(PSXZ("L")))=0!($G(PSXZ(PSXZ("L")))=2):"Transmitted",$G(PSXZ(PSXZ("L")))=1:"Released",$G(PSXZ(PSXZ("L")))=3:"Not Dispensed",1:"")
"RTN","PSOORNE3",106,0)
 .I $G(PSXZ(PSXZ("L")))=3 F LBL=0:0 S LBL=$O(^PSRX(RXN,"L",LBL)) Q:'LBL  I $P(^PSRX(RXN,"L",LBL,0),"^",2)=PSXZ("L"),'$P(^(0),"^",5),$P(^(0),"^",3)'["INTERACTION" S PSOCMOP="Local"
"RTN","PSOORNE3",107,0)
 .K PSXZ
"RTN","PSOORNE3",108,0)
 Q
"RTN","PSOORNE3",109,0)
RST ;
"RTN","PSOORNE3",110,0)
 S PSODRUG("IEN")=$P(RX0,"^",6),PSODRUG("OI")=$P(^PSDRUG(($P(RX0,"^",6)),2),"^")
"RTN","PSOORNE3",111,0)
 S PSODRUG("NAME")=$P(^PSDRUG(($P(RX0,"^",6)),0),"^")
"RTN","PSOORNE3",112,0)
 Q
"RTN","PSOORNE3",113,0)
RMK ;
"RTN","PSOORNE3",114,0)
 I $P(RX3,"^",7)]"" D
"RTN","PSOORNE3",115,0)
 .F SG=1:1:$L($P(RX3,"^",7)) S:$L(^TMP("PSOAO",$J,IEN,0)_" "_$P($P(RX3,"^",7)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOAO",$J,IEN,0)," ",21)=" " D
"RTN","PSOORNE3",116,0)
 ..S:$P($P(RX3,"^",7)," ",SG)'="" ^TMP("PSOAO",$J,IEN,0)=$G(^TMP("PSOAO",$J,IEN,0))_" "_$P($P(RX3,"^",7)," ",SG)
"RTN","PSOORNE3",117,0)
 Q
"RTN","PSOORNE4")
0^63^B98202057^B94257859
"RTN","PSOORNE4",1,0)
PSOORNE4 ;BIR/SAB-display renew RXs from backdoor ;07/29/96
"RTN","PSOORNE4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,32,36,46,75,96,103,99,117,131,225,386,390,391,313**;DEC 1997;Build 76
"RTN","PSOORNE4",3,0)
 ;^SC DBIA-10040;^PS(50.7-2223;^PS(50.606-2174;^PS(50.607-2221;^PS(51.2-2226;^PSDRUG-221;^PS(55-2228
"RTN","PSOORNE4",4,0)
 ;External reference to EN1^ORCFLAG supported by DBIA 3620
"RTN","PSOORNE4",5,0)
 ;
"RTN","PSOORNE4",6,0)
EN(PSONEW) N FLD,LST,VALMCNT
"RTN","PSOORNE4",7,0)
EN1 K PSOQUIT D:$G(PSONEW("ENT"))'>0  I $G(PSORENW("POE"))=1 S PSOREEDT=1 D SV
"RTN","PSOORNE4",8,0)
 .S PSOREEDT=1 D SV
"RTN","PSOORNE4",9,0)
 .K PSONEW("DOSE"),PSONEW("UNITS"),PSONEW("DOSE ORDERED"),PSONEW("ROUTE")
"RTN","PSOORNE4",10,0)
 .K PSONEW("SCHEDULE"),PSONEW("DURATION"),PSONEW("CONJUNCTION"),PSONEW("NOUN"),PSONEW("VERB"),PSOPRC,PSONEW("ODOSE")
"RTN","PSOORNE4",11,0)
RDD D DSPL,^PSOLMRN D:$G(PKI1)=2 DCP^PSOPKIV1 I $G(PSORX("FN")) S VALMBCK="Q" K PSOREEDT Q
"RTN","PSOORNE4",12,0)
 G:'$G(PSOQUIT) RDD
"RTN","PSOORNE4",13,0)
 Q
"RTN","PSOORNE4",14,0)
EDT D KV^PSOVER1 S DIR("A")="Select Field to Edit by number",DIR(0)="LO^1:"_$S($G(PSOREEDT):10,1:8)
"RTN","PSOORNE4",15,0)
 D ^DIR I $D(DTOUT)!($D(DUOUT)) D KV^PSOVER1 S VALMBCK="" Q
"RTN","PSOORNE4",16,0)
EDTSEL S PSOLM=1,(PSONEW("DFLG"),PSONEW("FIELD"),PSONEW3)=0
"RTN","PSOORNE4",17,0)
 I +Y S LST=Y D HLDHDR^PSOLMUTL S PSOEDT=1 D  Q:$G(PSODIR("DFLG"))!($G(PSODIR("QFLG")))
"RTN","PSOORNE4",18,0)
 .F FLD=1:1:$L(LST,",") Q:$P(LST,",",FLD)']""  D @(+$P(LST,",",FLD)) Q:$G(PSODIR("DFLG"))!($G(PSODIR("QFLG")))
"RTN","PSOORNE4",19,0)
 E  S VALMBCK="" D FULL^VALM1
"RTN","PSOORNE4",20,0)
 Q
"RTN","PSOORNE4",21,0)
ACP ; Renewal Accept
"RTN","PSOORNE4",22,0)
 N DIR,Y,DIRUT,DUOUT,DTOUT,DIR S Y=0
"RTN","PSOORNE4",23,0)
 I $$TITRX^PSOUTL(+$G(PSONEW("OIRXN")))="t" D  K DIR,PSOMSG W ! S DIR("A")="Press Return to continue",DIR(0)="E" D ^DIR Q
"RTN","PSOORNE4",24,0)
 . D FULL^VALM1
"RTN","PSOORNE4",25,0)
 . W !!,"Rx "_$P($G(^PSRX(+$G(PSONEW("OIRXN")),0)),"^")_" is marked as 'Titration' and cannot be renewed.",$C(7)
"RTN","PSOORNE4",26,0)
 . S VALMBCK="R"
"RTN","PSOORNE4",27,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 D  Q:$D(DIRUT)!'Y  D EN1^ORCFLAG(+$P($G(^PS(52.41,ORD,0)),"^")) H 1
"RTN","PSOORNE4",28,0)
 . D FULL^VALM1
"RTN","PSOORNE4",29,0)
 . I '$D(^XUSEC("PSORPH",DUZ)) D  S Y=0 Q
"RTN","PSOORNE4",30,0)
 . . S DIR("A",1)="Order must be unflagged by a pharmacist before it can be finished."
"RTN","PSOORNE4",31,0)
 . . S DIR("A",2)=""
"RTN","PSOORNE4",32,0)
 . . S DIR(0)="E",DIR("A")="Enter RETURN to continue" W !,$C(7) D ^DIR
"RTN","PSOORNE4",33,0)
 . . S VALMBCK="R"
"RTN","PSOORNE4",34,0)
 . D FULL^VALM1
"RTN","PSOORNE4",35,0)
 . S DIR("A",1)="This Order is flagged. In order to finish it"
"RTN","PSOORNE4",36,0)
 . S DIR("A",2)="you must unflag it first."
"RTN","PSOORNE4",37,0)
 . S DIR("A",3)=""
"RTN","PSOORNE4",38,0)
 . S DIR(0)="Y",DIR("A")="Unflag Order",DIR("B")="NO"
"RTN","PSOORNE4",39,0)
 . W ! D ^DIR I $D(DIRUT)!'Y S VALMBCK="Q"
"RTN","PSOORNE4",40,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 Q
"RTN","PSOORNE4",41,0)
 ;
"RTN","PSOORNE4",42,0)
 D INST2^PSORENW S PSOFROM1=1 D:$D(^XUSEC("PSORPH",DUZ))!('$P(PSOPAR,"^",2)) VER
"RTN","PSOORNE4",43,0)
 K PSOFROM1
"RTN","PSOORNE4",44,0)
PKI I $G(PSONEW("QFLG")) S POERR("DFLG")=1,VALMBCK="R" K PSONEW2 Q
"RTN","PSOORNE4",45,0)
 I PSONEW("ENT")>0,$G(NEWDOSE) K NEWDOSE G EN1 Q
"RTN","PSOORNE4",46,0)
 S PSORX("FN")=1 D EN^PSORN52(.PSONEW) D:$G(PKI)=89802020 ALERT^PSOPKIV1
"RTN","PSOORNE4",47,0)
 ;saves drug allergy order chks pso*7*390
"RTN","PSOORNE4",48,0)
 I +$G(^TMP("PSODAOC",$J,1,0)) D
"RTN","PSOORNE4",49,0)
 .I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSOORNE4",50,0)
 .S RXN=PSORENW("IRXN"),PSODAOC="Finished CPRS Rx "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"RENEW Order Acceptance_OP"
"RTN","PSOORNE4",51,0)
 .D DAOC^PSONEW
"RTN","PSOORNE4",52,0)
 D RNPSOSD^PSOUTIL,ACP1^PSOORNE6,^PSOBUILD S VALMBCK="Q"
"RTN","PSOORNE4",53,0)
 Q
"RTN","PSOORNE4",54,0)
VER1(PSONEW) ;
"RTN","PSOORNE4",55,0)
VER S (PSONEW("DFLG"),PSONEW("QFLG"))=0 I PSONEW("ENT")=0 D  K PSOORRNW,PSOFROM1 I PSONEW("DFLG")=1 S (PSONEW("QFLG"),POERR("DFLG"))=1 Q
"RTN","PSOORNE4",56,0)
 .S (PSOREEDT,PSOORRNW)=1 W !!,"Dosing Instruction Missing!!",!
"RTN","PSOORNE4",57,0)
 .S PSONEW("IRXN")=PSONEW("OIRXN") K VALMSG D FULL^VALM1 W !,"Drug: "_PSODRUG("NAME") D
"RTN","PSOORNE4",58,0)
 ..I $O(SIG(0)) D  Q
"RTN","PSOORNE4",59,0)
 ...F I=1:1 Q:$G(SIG(I))']""  W !,SIG(I)
"RTN","PSOORNE4",60,0)
 ..I $P($G(^PSRX(PSONEW("OIRXN"),"SIG")),"^")]"" S X=$P(^PSRX(PSONEW("OIRXN"),"SIG"),"^") D SIGONE^PSOHELP W !,$E($G(INS1),2,250)
"RTN","PSOORNE4",61,0)
 .K DIRUT W ! D DOSE^PSODIR(.PSONEW) Q:$G(PSONEW("DFLG"))  D EN^PSOFSIG(.PSONEW)
"RTN","PSOORNE4",62,0)
 .I PSONEW("ENT")>0,$O(SIG(0)) S (SIGOK,NEWDOSE)=1
"RTN","PSOORNE4",63,0)
 .I '$G(SPEED),PSONEW("DFLG")=1 S VALMSG="Renewal Request Cancelled!" W:$G(SPEED) !,"Renewal Request Cancelled!" Q:$G(PSONEW("DFLG"))
"RTN","PSOORNE4",64,0)
 .I +$G(PSONEW("ENT"))'>0 K DIRUT Q
"RTN","PSOORNE4",65,0)
 .D INS^PSODIR(.PSONEW),EN^PSOFSIG(.PSONEW),SINS^PSODIR(.PSONEW):$G(^PS(55,PSODFN,"LAN"))
"RTN","PSOORNE4",66,0)
 .S:'$G(SPEED)&(PSONEW("DFLG")=1) VALMSG="Renewal Request Cancelled!" W:$G(SPEED)&(PSONEW("DFLG")=1) !,"Renewal Request Cancelled!"
"RTN","PSOORNE4",67,0)
 .I $G(SPEED),'$G(PSONEW("DFLG")) D KV^PSOVER1 S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR,KV^PSOVER1 K X,Y
"RTN","PSOORNE4",68,0)
 I +$G(PSONEW("ENT"))'>0 G VER
"RTN","PSOORNE4",69,0)
 D STOP^PSORENW1 I +$G(PSEXDT) D  S PSORENW("QFLG")=1
"RTN","PSOORNE4",70,0)
 .S Y=PSORENW("FILL DATE") X ^DD("DD") S VALMSG=Y_" fill date is past expiration date "
"RTN","PSOORNE4",71,0)
 .S Y=$P(PSEXDT,"^",2) X ^DD("DD") S VALMSG=VALMSG_Y_"."
"RTN","PSOORNE4",72,0)
 Q
"RTN","PSOORNE4",73,0)
DSPL G:$G(PSONEW("ENT"))>0 DSP
"RTN","PSOORNE4",74,0)
 S PSONEW("ENT")=0 F I=0:0 S I=$O(^PSRX(PSONEW("OIRXN"),6,I)) Q:'I  S DOSE=^PSRX(PSONEW("OIRXN"),6,I,0) D
"RTN","PSOORNE4",75,0)
 .S PSONEW("ENT")=PSONEW("ENT")+1,PSONEW("DOSE",PSONEW("ENT"))=$P(DOSE,"^")
"RTN","PSOORNE4",76,0)
 .S PSONEW("UNITS",PSONEW("ENT"))=$P(DOSE,"^",3),PSONEW("DOSE ORDERED",PSONEW("ENT"))=$P(DOSE,"^",2),PSONEW("ROUTE",PSONEW("ENT"))=$P(DOSE,"^",7)
"RTN","PSOORNE4",77,0)
 .S PSONEW("SCHEDULE",PSONEW("ENT"))=$P(DOSE,"^",8),PSONEW("DURATION",PSONEW("ENT"))=$P(DOSE,"^",5),PSONEW("CONJUNCTION",PSONEW("ENT"))=$P(DOSE,"^",6)
"RTN","PSOORNE4",78,0)
 .S PSONEW("NOUN",PSONEW("ENT"))=$P(DOSE,"^",4),PSONEW("VERB",PSONEW("ENT"))=$P(DOSE,"^",9)
"RTN","PSOORNE4",79,0)
 .I $G(^PSRX(PSONEW("OIRXN"),6,I,1))]"" S PSONEW("ODOSE",PSONEW("ENT"))=^PSRX(PSONEW("OIRXN"),6,I,1)
"RTN","PSOORNE4",80,0)
 .K DOSE
"RTN","PSOORNE4",81,0)
DSP D ^PSOORUT2 K ^TMP("PSOPO",$J) S IEN=0
"RTN","PSOORNE4",82,0)
 D:$G(PSONEW("PENDING ORDER")) LMDISP^PSOORFI5(+PSONEW("PENDING ORDER"))
"RTN","PSOORNE4",83,0)
 I $G(PKI1)!($G(PKI)=1) D L1^PSOPKIV1 K:$G(PKI)=1 PKI
"RTN","PSOORNE4",84,0)
 D DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:""))
"RTN","PSOORNE4",85,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                 Rx#: "_PSONEW("NRX #")
"RTN","PSOORNE4",86,0)
 I +$G(PSODRUG("OI")) D
"RTN","PSOORNE4",87,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Orderable Item: "_$P(^PS(50.7,+$G(PSODRUG("OI")),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNE4",88,0)
 .S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNE4",89,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     "_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORNE4",90,0)
 S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNE4",91,0)
 S:$G(PSONEW("TN"))]"" IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          Trade Name: "_$G(PSONEW("TN"))
"RTN","PSOORNE4",92,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Patient Status: "_$P(PSONEW("PTST NODE"),"^"),PSONEW("PATIENT STATUS")=$P(PSONEW("PTST NODE"),"^")
"RTN","PSOORNE4",93,0)
 S (PSOID,Y)=PSONEW("ISSUE DATE") X ^DD("DD") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (1)     Issue Date: "_Y
"RTN","PSOORNE4",94,0)
 S Y=PSONEW("FILL DATE") X ^DD("DD") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (2)      Fill Date: "_Y
"RTN","PSOORNE4",95,0)
 I PSONEW("ENT")=0 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(PSOREEDT):"  (9)",1:"     ")_"         Dosage:" G PAT
"RTN","PSOORNE4",96,0)
 F I=1:1:PSONEW("ENT") D
"RTN","PSOORNE4",97,0)
 .I '$G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOORNE4",98,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(PSOREEDT)&(I'>1):"  (9)",1:"     ")_"         Dosage: "_$S($E(PSONEW("DOSE",I),1)="."&($G(PSONEW("DOSE ORDERED",I))):"0",1:"")_PSONEW("DOSE",I)
"RTN","PSOORNE4",99,0)
 .S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_$S($G(PSONEW("UNITS",I))]"":" ("_$P(^PS(50.607,PSONEW("UNITS",I),0),"^")_")",1:"")
"RTN","PSOORNE4",100,0)
 .I $P($G(^PS(55,PSODFN,"LAN")),"^"),'$G(PSONEW("DOSE ORDERED",I)) D
"RTN","PSOORNE4",101,0)
 ..S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Oth. Lang. Dosage: "_$G(PSONEW("ODOSE",I))
"RTN","PSOORNE4",102,0)
 .I $G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" D
"RTN","PSOORNE4",103,0)
 ..S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOORNE4",104,0)
 ..S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Dispense Units: "_$S($E($G(PSONEW("DOSE ORDERED",I)),1)=".":"0",1:"")_$G(PSONEW("DOSE ORDERED",I))
"RTN","PSOORNE4",105,0)
 ..S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Noun: "_$G(PSONEW("NOUN",I))
"RTN","PSOORNE4",106,0)
 .I $G(PSONEW("ROUTE",I)) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Route: "_$P(^PS(51.2,PSONEW("ROUTE",I),0),"^")
"RTN","PSOORNE4",107,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="            Schedule: "_PSONEW("SCHEDULE",I)
"RTN","PSOORNE4",108,0)
 .I $G(PSONEW("DURATION",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="           *Duration: "_$G(PSONEW("DURATION",I))
"RTN","PSOORNE4",109,0)
 .I $G(PSONEW("CONJUNCTION",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="         Conjunction: "_$S($G(PSONEW("CONJUNCTION",I))="A":"AND",$G(PSONEW("CONJUNCTION",I))="T":"THEN",$G(PSONEW("CONJUNCTION",I))="X":"EXCEPT",1:"")
"RTN","PSOORNE4",110,0)
PAT S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(PSOREEDT):" (10)",1:"     ")_"Pat Instruction:" D INS2^PSOBKDED
"RTN","PSOORNE4",111,0)
 S RXN=PSONEW("OIRXN") D INST1^PSORENW
"RTN","PSOORNE4",112,0)
 ;I $O(PRC(0)) D PC1^PSOORNE5
"RTN","PSOORNE4",113,0)
 K RXN S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                 SIG:"
"RTN","PSOORNE4",114,0)
 I $G(SIGOK),$O(SIG(0)) D  K SG,MIG
"RTN","PSOORNE4",115,0)
 .F I=0:0 S I=$O(SIG(I)) Q:'I  F SG=1:1:$L(SIG(I)) D
"RTN","PSOORNE4",116,0)
 ..S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG(I)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" "
"RTN","PSOORNE4",117,0)
 ..S:$P(SIG(I)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG(I)," ",SG)
"RTN","PSOORNE4",118,0)
 E  D
"RTN","PSOORNE4",119,0)
 .S X=$S($G(PSONEW("SIG"))]"":PSONEW("SIG"),1:$P($G(^PSRX(PSONEW("OIRXN"),"SIG")),"^")) D SIGONE^PSOHELP S SIG=$E($G(INS1),2,250)
"RTN","PSOORNE4",120,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNE4",121,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="         Days Supply: "_PSONEW("DAYS SUPPLY")_$S($L(PSONEW("DAYS SUPPLY"))=1:" ",1:"")
"RTN","PSOORNE4",122,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                 QTY"_$S($G(PSODRUG("UNIT"))]"":" ("_PSODRUG("UNIT")_")",1:" (  )")_": "_PSONEW("QTY")
"RTN","PSOORNE4",123,0)
 I $D(^PSDRUG("AQ",PSODRUG("IEN"))),$P($G(^PSDRUG(PSODRUG("IEN"),5)),"^")]"" D
"RTN","PSOORNE4",124,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNE4",125,0)
 .S ^TMP("PSOPO",$J,IEN,0)="            QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^")
"RTN","PSOORNE4",126,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (3)   # of Refills: "_PSONEW("# OF REFILLS")_$S($L(PSONEW("# OF REFILLS"))=1:" ",1:"")
"RTN","PSOORNE4",127,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (4)        Routing: "_$S($G(PSORENW("MAIL/WINDOW"))["W":"WINDOW",1:"MAIL")
"RTN","PSOORNE4",128,0)
 S:$G(PSONEW("METHOD OF PICK-UP"))]""&($P(PSOPAR,"^",12)) IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="    Method of Pickup: "_PSONEW("METHOD OF PICK-UP")
"RTN","PSOORNE4",129,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (5)         Clinic: "_$S($G(PSONEW("CLINIC")):$P(^SC(PSONEW("CLINIC"),0),"^"),1:"")
"RTN","PSOORNE4",130,0)
 S $P(RN," ",31)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (6)       Provider: "_PSONEW("PROVIDER NAME")_$E(RN,$L(PSONEW("PROVIDER NAME"))+1,31) K RN
"RTN","PSOORNE4",131,0)
 I $G(PSODRUG("DEA")),+PSODRUG("DEA")>1,+PSODRUG("DEA")<6 D PRV^PSOORFI5($G(PSORENW("PROVIDER")),$G(PSODRUG("IEN")))
"RTN","PSOORNE4",132,0)
 I $G(PSONEW("COSIGNING PROVIDER"))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="        Cos-Provider: "_$P(^VA(200,PSONEW("COSIGNING PROVIDER"),0),"^")
"RTN","PSOORNE4",133,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (7)         Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1)
"RTN","PSOORNE4",134,0)
RMK S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (8)        Remarks: "_$S($G(PSONEW("REMARKS"))]"":PSONEW("REMARKS"),1:"")
"RTN","PSOORNE4",135,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,DUZ,0),"^")_$E(RN,$L($P(^VA(200,DUZ,0),"^"))+1,35)
"RTN","PSOORNE4",136,0)
 I $G(PSOFDR) S ^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,$P(OR0,"^",4),0),"^")_$E(RN,$L($P(^VA(200,$P(OR0,"^",4),0),"^"))+1,35)
"RTN","PSOORNE4",137,0)
 D NOW^%DTC S PSONEW("LOGIN DATE")=$S($P($G(OR0),"^",6):$P($G(OR0),"^",6),1:%) K %,X S Y=PSONEW("LOGIN DATE") X ^DD("DD")
"RTN","PSOORNE4",138,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$P(Y,"@")_" "_$P(Y,"@",2) K RN
"RTN","PSOORNE4",139,0)
 S (VALMCNT,PSOPF)=IEN
"RTN","PSOORNE4",140,0)
 I $G(PSOFDR) D:$P(OR0,"^",24)
"RTN","PSOORNE4",141,0)
 .K PSOCSP S PSOCSP("NAME")=$G(PSODRUG("NAME")) M PSOCSP("DOSE")=PSONEW("DOSE"),PSOCSP("DOSE ORDERED")=PSONEW("DOSE ORDERED")
"RTN","PSOORNE4",142,0)
 .S PSOCSP("# OF REFILLS")=PSONEW("# OF REFILLS") ;track original data for dig. orders
"RTN","PSOORNE4",143,0)
 .S PSOCSP("ISSUE DATE")=$E($P(OR0,"^",6),1,7),PSOCSP("QTY")=PSONEW("QTY"),PSOCSP("DAYS SUPPLY")=PSONEW("DAYS SUPPLY")
"RTN","PSOORNE4",144,0)
 Q
"RTN","PSOORNE4",145,0)
1 D 1^PSOBKDED Q
"RTN","PSOORNE4",146,0)
2 D 2^PSOBKDED Q
"RTN","PSOORNE4",147,0)
3 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNE4",148,0)
  . W !!,"Digitally Signed Order - Refills cannot be changed",! D PZ
"RTN","PSOORNE4",149,0)
  D 9^PSOBKDED Q
"RTN","PSOORNE4",150,0)
4 D 12^PSOBKDED Q
"RTN","PSOORNE4",151,0)
5 D 5^PSOBKDED Q
"RTN","PSOORNE4",152,0)
6 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNE4",153,0)
  . W !!,"Digitally Signed Order - Provider cannot be changed",! D PZ
"RTN","PSOORNE4",154,0)
  D 4^PSOBKDED Q
"RTN","PSOORNE4",155,0)
7 D 11^PSOBKDED Q
"RTN","PSOORNE4",156,0)
8 D 13^PSOBKDED Q
"RTN","PSOORNE4",157,0)
9 W !!,"Drug: "_PSODRUG("NAME") S PSOORRNW=1 D DOSE1^PSOORED5(.PSONEW)
"RTN","PSOORNE4",158,0)
 I $G(PSONEW("DFLG")) S PSODIR("DFLG")=1,VALMBCK="Q" Q
"RTN","PSOORNE4",159,0)
 D SV Q
"RTN","PSOORNE4",160,0)
10 D INS^PSODIR(.PSONEW),SINS^PSODIR(.PSONEW) D SV Q
"RTN","PSOORNE4",161,0)
SV D SV^PSOORNE5 Q
"RTN","PSOORNE4",162,0)
 ;
"RTN","PSOORNE4",163,0)
PZ ;
"RTN","PSOORNE4",164,0)
 N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOORNE4",165,0)
 Q
"RTN","PSOORNEW")
0^36^B93328649^B92549598
"RTN","PSOORNEW",1,0)
PSOORNEW ;BIR/SAB - display orders from oerr ;6/19/06 3:53pm
"RTN","PSOORNEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,55,46,71,90,94,106,131,133,143,237,222,258,206,225,251,386,390,391,372,416,431,313**;DEC 1997;Build 76
"RTN","PSOORNEW",3,0)
 ;^PS(50.7 -2223
"RTN","PSOORNEW",4,0)
 ;^PSDRUG -221
"RTN","PSOORNEW",5,0)
 ;^PS(50.606 -2174
"RTN","PSOORNEW",6,0)
 ;^PS(55 -2228
"RTN","PSOORNEW",7,0)
 ;EN1^ORCFLAG -3620
"RTN","PSOORNEW",8,0)
 ;
"RTN","PSOORNEW",9,0)
 ;PSO*237 quit Finish if Today > Issue date + 365
"RTN","PSOORNEW",10,0)
 ;
"RTN","PSOORNEW",11,0)
DSPL I $G(PSODSPL) S VALMBCK="Q" K PSODSPL,PSOANSQD Q
"RTN","PSOORNEW",12,0)
 Q:'$D(PSOLMC)  K ^TMP("PSOPO",$J) S PSOLMC=PSOLMC+1
"RTN","PSOORNEW",13,0)
 I $D(CLOZPAT) S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),1:7) G OI
"RTN","PSOORNEW",14,0)
 S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3))&('$G(PSONEW("DAYS SUPPLY"))):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:30)
"RTN","PSOORNEW",15,0)
OI I '$G(PSODRUG("OI")) D
"RTN","PSOORNEW",16,0)
 .S (OI,PSODRUG("OI"))=$P(OR0,"^",8),PSODRUG("OIN")=$P(^PS(50.7,$P(OR0,"^",8),0),"^"),OID=$P(OR0,"^",9)
"RTN","PSOORNEW",17,0)
 .I $P($G(OR0),"^",9) S POERR=1,DREN=$P(OR0,"^",9) D DRG^PSOORDRG K POERR
"RTN","PSOORNEW",18,0)
 I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A",$G(PSODRUG("DEA"))'["B"!($G(PSODRUG("DEA"))["F") S PSONEW("# OF REFILLS")=0
"RTN","PSOORNEW",19,0)
 I $D(CLOZPAT) S PSONEW("# OF REFILLS")=$S($D(PSONEW("# OF REFILLS")):PSONEW("# OF REFILLS"),$G(CLOZPAT)=2&($P(OR0,"^",11)>2):3,$G(CLOZPAT)&($P(OR0,"^",11)>1):1,1:0)
"RTN","PSOORNEW",20,0)
 S IEN=0 D OBX^PSOORFI1,DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:""))
"RTN","PSOORNEW",21,0)
 D LMDISP^PSOORFI5(+$G(ORD)) ; Display Flag/Unflag Information
"RTN","PSOORNEW",22,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="*(1) Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNEW",23,0)
 S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",24,0)
 K LST I $G(PSODRUG("NAME"))]"" D  G PT
"RTN","PSOORNEW",25,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)"_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORNEW",26,0)
 .S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",27,0)
 .I $P($G(^PSDRUG(PSODRUG("IEN"),0)),"^",10)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Drug Message:" D DRGMSG
"RTN","PSOORNEW",28,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)           Drug: No Dispense Drug Selected"
"RTN","PSOORNEW",29,0)
PT D DOSE2^PSOORFI4
"RTN","PSOORNEW",30,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (4)   Pat Instruct:" D:$O(PSONEW("SIG",0)) INST^PSOORFI4
"RTN","PSOORNEW",31,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Provider Comments:" S TY=3 D INST^PSOORFI1
"RTN","PSOORNEW",32,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Instructions:" S TY=2 D INST^PSOORFI1
"RTN","PSOORNEW",33,0)
 K PSOELSE S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                SIG:"
"RTN","PSOORNEW",34,0)
 F I=0:0 S I=$O(SIG(I)) Q:'I  S SIG=SIG(I) D
"RTN","PSOORNEW",35,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNEW",36,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (5) Patient Status: "_$P($G(^PS(53,+PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORNEW",37,0)
 K PSOELSE I $G(PSONEW("ISSUE DATE"))']"" S PSOELSE=1 S IEN=IEN+1,(PSOID,Y)=$E($P(OR0,"^",6),1,7) X ^DD("DD") S PSONEW("ISSUE DATE")=Y,^TMP("PSOPO",$J,IEN,0)=" (4)     Issue Date: "_Y
"RTN","PSOORNEW",38,0)
 I '$G(PSOELSE) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (6)     Issue Date: "_PSONEW("ISSUE DATE")
"RTN","PSOORNEW",39,0)
 K PSOELSE I $G(PSORX("FILL DATE"))']"" S PSOELSE=1 D
"RTN","PSOORNEW",40,0)
 .S (Y,PSORX("FILL DATE"))=$S($E($P(OR0,"^",6),1,7)<DT:DT,1:$E($P(OR0,"^",6),1,7)) X ^DD("DD") S PSONEW("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                  (5) Fill Date: "_Y
"RTN","PSOORNEW",41,0)
 I '$G(PSOELSE) S Y=PSORX("FILL DATE") X ^DD("DD") S PSORX("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"       (7) Fill Date: "_PSORX("FILL DATE")
"RTN","PSOORNEW",42,0)
 I $P(OR0,"^",18) S IEN=IEN+1,Y=$P(OR0,"^",18) X ^DD("DD") S $P(^TMP("PSOPO",$J,IEN,0)," ",39)="Effective Date: "_Y
"RTN","PSOORNEW",43,0)
 I $D(CLOZPAT) D ELIG^PSOORFI2 S:'$D(PSONEW("QTY")) PSONEW("QTY")=0
"RTN","PSOORNEW",44,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (8)    Days Supply: "_PSONEW("DAYS SUPPLY")
"RTN","PSOORNEW",45,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"               (9)   QTY"_$S($P($G(^PSDRUG(+$G(PSODRUG("IEN")),660)),"^",8)]"":" ("_$P($G(^PSDRUG(+PSODRUG("IEN"),660)),"^",8)_")",1:" (  )")
"RTN","PSOORNEW",46,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_": "_$S($G(PSONEW("QTY"))]"":PSONEW("QTY"),1:$P(OR0,"^",10))
"RTN","PSOORNEW",47,0)
 I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),5)),"^")]"" D
"RTN","PSOORNEW",48,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNEW",49,0)
 .S ^TMP("PSOPO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^") K RN
"RTN","PSOORNEW",50,0)
 S IEN=IEN+1
"RTN","PSOORNEW",51,0)
 I $P(OR0,"^",24) S ^TMP("PSOPO",$J,IEN,0)="   Provider ordered: days supply "_+$P(OR0,"^",22)_", quantity "_+$P(OR0,"^",10)_" & refills "_+$P(OR0,"^",11)
"RTN","PSOORNEW",52,0)
 E  S ^TMP("PSOPO",$J,IEN,0)="       Provider ordered "_+$P(OR0,"^",11)_" refills"
"RTN","PSOORNEW",53,0)
 D:$D(CLOZPAT) PQTY^PSOORFI4
"RTN","PSOORNEW",54,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(10)   # of Refills: "_$S($G(PSONEW("# OF REFILLS"))]"":PSONEW("# OF REFILLS"),1:$P(OR0,"^",11))_"               (11)   Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORNEW",55,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(12)         Clinic: "_PSORX("CLINIC")
"RTN","PSOORNEW",56,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(13)       Provider: "_PSONEW("PROVIDER NAME")
"RTN","PSOORNEW",57,0)
 D:$P(OR0,"^",24)!((+$G(PSODRUG("DEA"))>1)&(+$G(PSODRUG("DEA"))<6)) PRV^PSOORFI5($G(PSONEW("PROVIDER")),$G(PSODRUG("IEN")),$P(OR0,"^"))
"RTN","PSOORNEW",58,0)
 I $P($G(^VA(200,$S($G(PSONEW("PROVIDER")):PSONEW("PROVIDER"),1:$P(OR0,"^",5)),"PS")),"^",7)&($P($G(^("PS")),"^",8)) D
"RTN","PSOORNEW",59,0)
 .S IEN=IEN+1,PSONEW("COSIGNING PROVIDER")=$S($G(PSONEW("COSIGNING PROVIDER")):PSONEW("COSIGNING PROVIDER"),1:$P(^("PS"),"^",8))
"RTN","PSOORNEW",60,0)
 .S ^TMP("PSOPO",$J,IEN,0)="       Cos-Provider: "_$P(^VA(200,PSONEW("COSIGNING PROVIDER"),0),"^")
"RTN","PSOORNEW",61,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(14)         Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1)
"RTN","PSOORNEW",62,0)
 S PSONEW("REMARKS")=$S($G(PSONEW("REMARKS"))]"":PSONEW("REMARKS"),$P(OR0,"^",17)="C":"Administered in Clinic.",1:"")
"RTN","PSOORNEW",63,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(15)        Remarks:"
"RTN","PSOORNEW",64,0)
 I $G(PSONEW("REMARKS"))]"" D
"RTN","PSOORNEW",65,0)
 .F SG=1:1:$L(PSONEW("REMARKS")) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("REMARKS")," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",66,0)
 ..S:$P(PSONEW("REMARKS")," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("REMARKS")," ",SG)
"RTN","PSOORNEW",67,0)
 I $G(PSOSIGFL)!(PSODRUG("OI")'=$P(OR0,"^",8)) S PSONEW("CLERK CODE")=DUZ,PSORX("CLERK CODE")=$P(^VA(200,DUZ,0),"^"),VALMSG="This change will create a new prescription!"
"RTN","PSOORNEW",68,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,PSONEW("CLERK CODE"),0),"^")_$E(RN,$L($P(^VA(200,PSONEW("CLERK CODE"),0),"^"))+1,35)
"RTN","PSOORNEW",69,0)
 S Y=$P(OR0,"^",12) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$E($P(OR0,"^",12),4,5)_"/"_$E($P(OR0,"^",12),6,7)_"/"_$E($P(OR0,"^",12),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORNEW",70,0)
 I PSOLMC<2 D ^PSOLMPO1 S VALMBCK="Q",PSOLMC=0
"RTN","PSOORNEW",71,0)
 S:PSOLMC>1 VALMBCK="R"
"RTN","PSOORNEW",72,0)
 Q
"RTN","PSOORNEW",73,0)
ORCHK D PROVCOM^PSOORFI4,ORCHK^PSOORFI4
"RTN","PSOORNEW",74,0)
 Q
"RTN","PSOORNEW",75,0)
EDT D KV S DIR("A",1)="* Indicates which fields will create an new Order",DIR("A")="Select Field to Edit by number",DIR(0)="LO^1:15" D ^DIR Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOORNEW",76,0)
EDTSEL N LST,FLD,OUT D KV S OUT=0
"RTN","PSOORNEW",77,0)
 I +Y S LST=Y D FULL^VALM1 N PSODOSE M PSODOSE=PSONEW D  G DSPL
"RTN","PSOORNEW",78,0)
 .F FLD=1:1:$L(LST,",") Q:$P(LST,",",FLD)']""!(OUT)  D @(+$P(LST,",",FLD)) D:$P(LST,",",FLD)=8 REF D KV
"RTN","PSOORNEW",79,0)
 E  S VALMBCK="" Q
"RTN","PSOORNEW",80,0)
 Q
"RTN","PSOORNEW",81,0)
ACP ;
"RTN","PSOORNEW",82,0)
 N PSOORNEW,DIR,Y S Y=0,PSOORNEW=1
"RTN","PSOORNEW",83,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 D  Q:$D(DIRUT)!'Y  D EN1^ORCFLAG(+$P($G(^PS(52.41,ORD,0)),"^")) H 1
"RTN","PSOORNEW",84,0)
 . D FULL^VALM1
"RTN","PSOORNEW",85,0)
 . I '$D(^XUSEC("PSORPH",DUZ)) D  S Y=0 Q
"RTN","PSOORNEW",86,0)
 . . S DIR("A",1)="Order must be unflagged by a pharmacist before it can be finished."
"RTN","PSOORNEW",87,0)
 . . S DIR("A",2)=""
"RTN","PSOORNEW",88,0)
 . . S DIR(0)="E",DIR("A")="Enter RETURN to continue" W !,$C(7) D ^DIR
"RTN","PSOORNEW",89,0)
 . . S VALMBCK="R"
"RTN","PSOORNEW",90,0)
 . D KV
"RTN","PSOORNEW",91,0)
 . S DIR("A",1)="This Order is flagged. In order to finish it"
"RTN","PSOORNEW",92,0)
 . S DIR("A",2)="you must unflag it first."
"RTN","PSOORNEW",93,0)
 . S DIR("A",3)=""
"RTN","PSOORNEW",94,0)
 . S DIR(0)="Y",DIR("A")="Unflag Order",DIR("B")="NO"
"RTN","PSOORNEW",95,0)
 . W ! D ^DIR I $D(DIRUT)!'Y S VALMBCK="Q"
"RTN","PSOORNEW",96,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 Q
"RTN","PSOORNEW",97,0)
 ;
"RTN","PSOORNEW",98,0)
 I $D(CLOZPAT),+$G(PSONEW("QTY"))=0 S VALMSG="Unable to calculate the quantity, enter a quantity" G DSPL
"RTN","PSOORNEW",99,0)
 S (PSODIR("DFLG"),PSORX("DFLG"),PSODIR("QFLD"))=0,ACP=1 D ORCHK
"RTN","PSOORNEW",100,0)
 G:$G(PSONEW("QFLG")) DSPL
"RTN","PSOORNEW",101,0)
 I $G(PSODIR("DFLG"))!$G(PSORX("DFLG")) Q
"RTN","PSOORNEW",102,0)
 I $G(PSONEW("FLD"))!($G(PSODRUG("NAME"))']"")!('$O(SIG(0))) G DSPL
"RTN","PSOORNEW",103,0)
 I $G(PSODRUG("NAME"))]"",'$G(ORCHK)!($G(ORDRG)'=PSODRUG("NAME")) D  I $G(PSORX("DFLG")) D CLEAN^PSOVER1 G DSPL
"RTN","PSOORNEW",104,0)
 . D POST^PSODRG S:'$G(PSORX("DFLG")) ORCHK=1,ORDRG=PSODRUG("NAME")
"RTN","PSOORNEW",105,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("N") I $G(PSORX("DFLG")) D CLEAN^PSOVER1 G DSPL
"RTN","PSOORNEW",106,0)
 I '$D(PSONEW("RX #")) S PSOFROM="NEW",RTN=$S($P($G(PSOPAR),"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN") D @RTN Q:PSONEW("QFLG")  I '$P($G(PSOPAR),"^",7) S PSOX=PSONEW("RX #") D CHECK^PSONRXN
"RTN","PSOORNEW",107,0)
 D RXNCHK^PSOORNE1 I $G(PSONEW("QFLG")) S PSONEW("DFLG")=1 Q
"RTN","PSOORNEW",108,0)
 I DT>$$FMADD^XLFDT($P(OR0,"^",6),365) D EXPR^PSONEW2 G DSPL
"RTN","PSOORNEW",109,0)
 D STOP^PSONEW2,DISPLAY^PSONEW2,^PSONEWF
"RTN","PSOORNEW",110,0)
 I $G(PSOCPZ("DFLG")) W !!,"No action taken!",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR,KV K PSOCPZ("DFLG"),DRET,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",111,0)
 ;
"RTN","PSOORNEW",112,0)
 K PSOCPZ("DFLG") D KV S DIR(0)="Y",DIR("A")="Are you sure you want to Accept this Order",DIR("B")="NO" D ^DIR I $D(DIRUT) D KV K DRET,PSOANSQ,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",113,0)
 D KV I 'Y K PSOANSQ G DSPL
"RTN","PSOORNEW",114,0)
 I $G(PSONEW("MAIL/WINDOW"))["W" D:$P($G(PSOPAR),"^",12)  S BINGCRT="Y",BINGRTE="W",PSORX("MAIL/WINDOW")="WINDOW" K RTN
"RTN","PSOORNEW",115,0)
 .W ! K DIR,DIRUT S DIR(0)="52,35O"
"RTN","PSOORNEW",116,0)
 .S:$G(PSORX("METHOD OF PICK-UP"))]"" DIR("B")=PSORX("METHOD OF PICK-UP") D ^DIR I $D(DIRUT) K DIR,DIRUT Q
"RTN","PSOORNEW",117,0)
 .S (PSONEW("METHOD OF PICK-UP"),PSORX("METHOD OF PICK-UP"))=Y K X,Y
"RTN","PSOORNEW",118,0)
 S PSONEW("POE")=1 D EN^PSON52(.PSONEW) G:$G(PSONEW("DFLG")) ABORT D DCORD^PSONEW2 D:$G(PKI)=89802020 ALERT^PSOPKIV1
"RTN","PSOORNEW",119,0)
 ; - Possible Titration Rx?
"RTN","PSOORNEW",120,0)
 I $G(PSONEW("IRXN")) D MARK^PSOOTMRX(PSONEW("IRXN"),0)
"RTN","PSOORNEW",121,0)
 ;saves drug allergy order chks pso*7*390
"RTN","PSOORNEW",122,0)
 I +$G(^TMP("PSODAOC",$J,1,0)) D
"RTN","PSOORNEW",123,0)
 .I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSOORNEW",124,0)
 .S RXN=PSONEW("IRXN"),PSODAOC="Finished CPRS Rx "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"Order Acceptance_OP"
"RTN","PSOORNEW",125,0)
 .D DAOC^PSONEW
"RTN","PSOORNEW",126,0)
 D NPSOSD^PSOUTIL(.PSONEW),FULL^VALM1 K PSORX("MAIL/WINDOW")
"RTN","PSOORNEW",127,0)
 D EOJ^PSONEW
"RTN","PSOORNEW",128,0)
ABORT S VALMBCK="Q",DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR,CLEAN^PSOVER1,KV
"RTN","PSOORNEW",129,0)
 Q
"RTN","PSOORNEW",130,0)
KV K DIRUT,DUOUT,DTOUT,DIR,PSOEDDOS
"RTN","PSOORNEW",131,0)
 Q
"RTN","PSOORNEW",132,0)
REF D REF^PSOORFI4
"RTN","PSOORNEW",133,0)
 Q
"RTN","PSOORNEW",134,0)
1 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",135,0)
 . W !!,"Digitally Signed Order - Orderable Item cannot be changed",! D PZ
"RTN","PSOORNEW",136,0)
 N PSOBDR,PSOBDRG S PSOBDRG=1 D 1^PSOORNW2 Q  ;oi
"RTN","PSOORNEW",137,0)
 ;
"RTN","PSOORNEW",138,0)
4 D INS^PSOORNW2 Q
"RTN","PSOORNEW",139,0)
 ;
"RTN","PSOORNEW",140,0)
3 I $G(LST)["3,",$P(OR0,"^",24) D  Q 
"RTN","PSOORNEW",141,0)
 . W !!,"Digitally Signed Order - Dose cannot be changed",! D PZ
"RTN","PSOORNEW",142,0)
 N PSOEDDOS S PSOEDDOS=1 D DOSE^PSOORED4(.PSONEW) Q
"RTN","PSOORNEW",143,0)
 ;
"RTN","PSOORNEW",144,0)
6 D 4^PSOORNW2 Q  ;idt
"RTN","PSOORNEW",145,0)
 ;
"RTN","PSOORNEW",146,0)
7 D 5^PSOORNW2 Q  ;fdt
"RTN","PSOORNEW",147,0)
 ;
"RTN","PSOORNEW",148,0)
5 D 3^PSOORNW2 Q  ;pstat
"RTN","PSOORNEW",149,0)
 ;
"RTN","PSOORNEW",150,0)
13 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",151,0)
 . W !!,"Digitally Signed Order - Provider cannot be changed",! D PZ
"RTN","PSOORNEW",152,0)
 D 12^PSOORNW2 Q  ;doc
"RTN","PSOORNEW",153,0)
 ;
"RTN","PSOORNEW",154,0)
12 D 11^PSOORNW2 Q  ;cli
"RTN","PSOORNEW",155,0)
 ;
"RTN","PSOORNEW",156,0)
2 N PSOCSIG I '$G(PSOBDRG) N PSOBDR,PSOBDRG S PSOBDRG=1,PSOQFLG=0
"RTN","PSOORNEW",157,0)
 N CPRN S CPRN=+$P($G(OR0),"^",24) D 2^PSOORNW1 Q:$G(PSOQFLG)  D EN^PSODIAG  ;drg/ICD
"RTN","PSOORNEW",158,0)
 I $G(PSOCSIG) K PSOCSIG G 3
"RTN","PSOORNEW",159,0)
 Q
"RTN","PSOORNEW",160,0)
 ;
"RTN","PSOORNEW",161,0)
9 D 8^PSOORNW2 Q  ;qty
"RTN","PSOORNEW",162,0)
 ;
"RTN","PSOORNEW",163,0)
8 N CPRN S CPRN=+$P($G(OR0),"^",24) D 7^PSOORNW2 Q  ;ds
"RTN","PSOORNEW",164,0)
 ;
"RTN","PSOORNEW",165,0)
10 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",166,0)
 . W !!,"Digitally Signed Order - Refills cannot be changed",! D PZ
"RTN","PSOORNEW",167,0)
 D 9^PSOORNW2 Q  ;#rfs
"RTN","PSOORNEW",168,0)
 ;
"RTN","PSOORNEW",169,0)
14 D 13^PSOORNW2 Q  ;cop
"RTN","PSOORNEW",170,0)
 ;
"RTN","PSOORNEW",171,0)
11 D 10^PSOORNW2 Q  ;m/w
"RTN","PSOORNEW",172,0)
 ;
"RTN","PSOORNEW",173,0)
15 D 14^PSOORNW2 Q  ;rem
"RTN","PSOORNEW",174,0)
 ;
"RTN","PSOORNEW",175,0)
DRGMSG ;
"RTN","PSOORNEW",176,0)
 F SG=1:1:$L($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",177,0)
 .S:$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)
"RTN","PSOORNEW",178,0)
 K SG
"RTN","PSOORNEW",179,0)
 Q
"RTN","PSOORNEW",180,0)
 ;
"RTN","PSOORNEW",181,0)
PZ ;
"RTN","PSOORNEW",182,0)
 N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOORNEW",183,0)
 Q
"RTN","PSOORNW1")
0^40^B45684581^B44718806
"RTN","PSOORNW1",1,0)
PSOORNW1 ;ISC BHAM/SAB - continuation of finish of new order ;5/10/07 8:30am
"RTN","PSOORNW1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**23,46,78,117,131,133,172,148,222,268,206,251,379,391,313**;DEC 1997;Build 76
"RTN","PSOORNW1",3,0)
 ;Reference ^YSCL(603.01 supported by DBIA 2697
"RTN","PSOORNW1",4,0)
 ;Reference ^PS(55 supported by DBIA 2228
"RTN","PSOORNW1",5,0)
 ;Reference ^PSDRUG( supported by DBIA 221
"RTN","PSOORNW1",6,0)
 ;Reference to $$GETNDC^PSSNDCUT supported by IA 4707
"RTN","PSOORNW1",7,0)
 ;
"RTN","PSOORNW1",8,0)
2 I $G(ORD),$G(ORSV) W !!,"Instructions: " D
"RTN","PSOORNW1",9,0)
 .S INST=0 F  S INST=$O(^PS(52.41,ORD,2,INST)) Q:'INST  S (MIG,INST(INST))=^PS(52.41,ORD,2,INST,0) D
"RTN","PSOORNW1",10,0)
 ..F SG=1:1:$L(MIG," ") W:$X+$L($P(MIG," ",SG)_" ")>IOM !?14 W $P(MIG," ",SG)_" "
"RTN","PSOORNW1",11,0)
 .S:'$D(PSODRUG("OI")) PSODRUG("OI")=$P(OR0,"^",8)
"RTN","PSOORNW1",12,0)
 .K INST,TY,MIG,SG
"RTN","PSOORNW1",13,0)
 N DEFAULT
"RTN","PSOORNW1",14,0)
 S (PSDC,PSI,DEFAULT)=0 W !!,"The following Drug(s) are available for selection:"
"RTN","PSOORNW1",15,0)
 F PSI=0:0 S PSI=$O(^PSDRUG("ASP",PSODRUG("OI"),PSI)) Q:'PSI  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["O":0,1:1) D
"RTN","PSOORNW1",16,0)
 .S PSDC=PSDC+1 W !,PSDC_". "_$P(^PSDRUG(PSI,0),"^")_$S($P(^(0),"^",9):"     (N/F)",1:"")
"RTN","PSOORNW1",17,0)
 .S PSDC(PSDC)=PSI I $G(PSORXED("DRUG IEN")),PSI=$G(PSORXED("DRUG IEN")) S DEFAULT=PSDC
"RTN","PSOORNW1",18,0)
 I PSDC=0 D
"RTN","PSOORNW1",19,0)
 . N X,DRG
"RTN","PSOORNW1",20,0)
 . S DRG=+$P($G(^PS(52.41,+$G(ORD),0)),"^",9)
"RTN","PSOORNW1",21,0)
 . S X=$$GET1^DIQ(50,DRG,100)
"RTN","PSOORNW1",22,0)
 . I X'="",(DT>X) D
"RTN","PSOORNW1",23,0)
 . . W !!,"   This Dispense Drug is now Inactive. You may select a"
"RTN","PSOORNW1",24,0)
 . . W !,"    new Orderable Item, or you can enter a new Order with"
"RTN","PSOORNW1",25,0)
 . . W !,"    an Active Drug.",!
"RTN","PSOORNW1",26,0)
 . E  W !!,"No drugs available!",!
"RTN","PSOORNW1",27,0)
 . K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press return to continue"
"RTN","PSOORNW1",28,0)
 . D ^DIR K DIR
"RTN","PSOORNW1",29,0)
 G:'PSDC ETX I $G(PSOBDRG),'$D(PSOBDR) M PSOBDR=PSODRUG
"RTN","PSOORNW1",30,0)
 I PSDC'=1 D
"RTN","PSOORNW1",31,0)
 .I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),2)),"^")=$G(PSODRUG("OI")) Q
"RTN","PSOORNW1",32,0)
 .K PSODRUG("NAME"),PSODRUG("IEN")
"RTN","PSOORNW1",33,0)
 W ! D KV
"RTN","PSOORNW1",34,0)
 S DIR(0)="N^1:"_PSDC S:$G(DEFAULT) DIR("B")=DEFAULT
"RTN","PSOORNW1",35,0)
 S DIR("A")="Select Drug by number" D ^DIR
"RTN","PSOORNW1",36,0)
 I $D(DIRUT) S OUT=1 G EX
"RTN","PSOORNW1",37,0)
 D KV K PSOY S PSOY=PSDC(Y),PSOY(0)=^PSDRUG(PSOY,0),PSOCSIG=0
"RTN","PSOORNW1",38,0)
 I $G(PSOBDR("IEN")),PSOBDR("IEN")'=+PSOY D:$G(ORD)  G:$D(DIRUT) EX
"RTN","PSOORNW1",39,0)
 .D KV S DIR(0)="Y",DIR("B")="YES",DIR("A",1)="You have changed the dispense drug from",DIR("A",2)=PSOBDR("NAME")_" to "_$P(^PSDRUG(+PSOY,0),"^")_".",DIR("A")="Do You want to Edit the SIG"
"RTN","PSOORNW1",40,0)
 .D ^DIR I $D(DIRUT) S OUT=1 Q
"RTN","PSOORNW1",41,0)
 .S:Y PSOCSIG=1
"RTN","PSOORNW1",42,0)
 .I 'Y D  Q:$D(DIRUT)
"RTN","PSOORNW1",43,0)
 ..I $P($G(OR0),"^",24) S (OUT,DIRUT)=1 Q
"RTN","PSOORNW1",44,0)
 ..D URX I $D(DIRUT) S OUT=1
"RTN","PSOORNW1",45,0)
 D KV
"RTN","PSOORNW1",46,0)
CT1 I $P($G(^PSDRUG(PSOY,"CLOZ1")),"^")="PSOCLO1",'$O(^YSCL(603.01,"C",PSODFN,0)) D  Q
"RTN","PSOORNW1",47,0)
 .S VALMSG="Patient Not Registered in Clozapine Program",VALMBCK="Q" K PSOY,PSDC
"RTN","PSOORNW1",48,0)
 I $G(ORD) S ^TMP("PSORXPO",$J,ORD,0)=1
"RTN","PSOORNW1",49,0)
 S PSODRUG("IEN")=+PSOY,PSODRUG("VA CLASS")=$P(PSOY(0),"^",2),PSODRUG("NAME")=$P(PSOY(0),"^")
"RTN","PSOORNW1",50,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(+PSOY,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOORNW1",51,0)
 S PSODRUG("MAXDOSE")=$P(PSOY(0),"^",4),PSODRUG("DEA")=$P(PSOY(0),"^",3),PSODRUG("CLN")=$S($D(^PSDRUG(+PSOY,"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSOORNW1",52,0)
 S PSODRUG("SIG")=$P(PSOY(0),"^",5),PSODRUG("NDC")=$$GETNDC^PSSNDCUT(+PSOY,$G(PSOSITE)),PSODRUG("STKLVL")=$G(^PSDRUG(+PSOY,660.1))
"RTN","PSOORNW1",53,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,+PSOY,81)
"RTN","PSOORNW1",54,0)
 S PSOX1=$G(^PSDRUG(+PSOY,660)),PSODRUG("COST")=$P($G(PSOX1),"^",6),PSODRUG("UNIT")=$P($G(PSOX1),"^",8),PSODRUG("EXPIRATION DATE")=$P($G(PSOX1),"^",9)
"RTN","PSOORNW1",55,0)
 I $G(PSORX("DFLG")) K PSODRUG N LST Q:$G(PSOAC)!($G(NEWEDT))  D DSPL^PSOORFI1 S VALMBCK="Q" Q
"RTN","PSOORNW1",56,0)
ETX D REF S VALMBCK="R" I 'PSDC S VALMSG="NO dispense drugs tied to this orderable item!" S PSOQFLG=1
"RTN","PSOORNW1",57,0)
TX D KV K PSDC,PSI,X,Y,PSOX1,PSOY
"RTN","PSOORNW1",58,0)
 Q
"RTN","PSOORNW1",59,0)
EX M PSODRUG=PSOBDR K PSOBDR,PSOBDRG S PSOQFLG=1,VALMBCK="R" D MP1^PSOOREDX
"RTN","PSOORNW1",60,0)
 D TX Q
"RTN","PSOORNW1",61,0)
URX D KV S DIR(0)="Y",DIR("A")="Are You Sure You Want to Update Rx",DIR("B")="Yes"
"RTN","PSOORNW1",62,0)
 D ^DIR S:$D(DIRUT)!('Y) DIRUT=1
"RTN","PSOORNW1",63,0)
 I Y S ^TMP("PSORXPO",$J,ORD,0)=1 ;screens 4 order checks
"RTN","PSOORNW1",64,0)
 Q
"RTN","PSOORNW1",65,0)
REF Q:'$D(PSODRUG("DEA"))!('$G(PSODRUG("IEN")))!('$G(^PS(55,PSODFN,"PS")))
"RTN","PSOORNW1",66,0)
 S PSONEW("CS")=0,PTRF=$S(+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",4)]""):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",4),1:5)
"RTN","PSOORNW1",67,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSONEW("CS"),"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSONEW("CS"),"^",2)=1
"RTN","PSOORNW1",68,0)
 I $P($G(PSONEW("CS")),"^",2)=1 S PSONEW("# OF REFILLS")=0 Q
"RTN","PSOORNW1",69,0)
 I +PSONEW("CS") D
"RTN","PSOORNW1",70,0)
 .S PSOX=$S($P($G(OR0),"^",11)>5:5,1:+$P($G(OR0),"^",11))
"RTN","PSOORNW1",71,0)
 .S PSOX=$S(PSOX>PTRF:PTRF,1:PSOX)
"RTN","PSOORNW1",72,0)
 .S PSONEW("# OF REFILLS")=PSOX
"RTN","PSOORNW1",73,0)
 E  D
"RTN","PSOORNW1",74,0)
 .S PSOX=$S($P($G(OR0),"^",11)'>PTRF&($P($G(OR0),"^",11)'>11):11,1:PTRF)
"RTN","PSOORNW1",75,0)
 I '$D(CLOZPAT) I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")["F")!(PSODRUG("DEA")[1)!(PSODRUG("DEA")[2) S PSOX=0,PSONEW("# OF REFILLS")=0 K PSDY,PSDY1,PTRF Q
"RTN","PSOORNW1",76,0)
 I $D(CLOZPAT) S (PSOX,PSONEW("N# REF"),PSONEW("# OF REFILLS"))=$S(CLOZPAT=2&($G(PSONEW("# OF REFILLS"))>2):3,CLOZPAT&($G(PSONEW("# OF REFILLS"))>1):1,1:0),PSONEW("DAYS SUPPLY")=7,ORCHK=1 K PSDY,PSDY1,PTRF Q
"RTN","PSOORNW1",77,0)
 S PSONEW("# OF REFILLS")=$S($G(PSONEW("# OF REFILLS"))'="":$G(PSONEW("# OF REFILLS")),1:PSOX) K PSDY,PSDY1,PTRF
"RTN","PSOORNW1",78,0)
 Q
"RTN","PSOORNW1",79,0)
EDNEW K PSMAX,PSFMAX F DEA=1:1 Q:$E(PSODEA,DEA)=""  I $E(+PSODEA,DEA)>1,$E(+PSODEA,DEA)<6 S CS=1
"RTN","PSOORNW1",80,0)
 I CS D
"RTN","PSOORNW1",81,0)
 .S PSOX1=$S(PTRF>5:5,1:PTRF),PSOX=$S(PSOX1=5:5,1:PSOX1)
"RTN","PSOORNW1",82,0)
 .S PSOX=$S('PSOX:0,PSDAYS=90:1,1:PSOX),PSDY1=$S(PSDAYS<60:5,PSDAYS'<60&(PSDAYS'>89):2,PSDAYS=90:1,1:0) S MAX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORNW1",83,0)
 E  D
"RTN","PSOORNW1",84,0)
 .S PSOX1=PTRF,PSOX=$S(PSOX1=11:11,1:PSOX1),PSOX=$S('PSOX:0,PSDAYS=90:3,1:PSOX)
"RTN","PSOORNW1",85,0)
 .S PSDY1=$S(PSDAYS<60:11,PSDAYS'<60&(PSDAYS'>89):5,PSDAYS=90:3,1:0) S MAX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORNW1",86,0)
 I PSRF>MAX D
"RTN","PSOORNW1",87,0)
 .W $C(7),!!,PSRF_" refills are not correct for a "_PSDAYS_" day supply.",!,"Please enter correct # of refills for a "_PSDAYS_" day supply. Max refills allowed is "_MAX_".",!
"RTN","PSOORNW1",88,0)
 .S (PSMAX("MAX"),PSFMAX("MAX"))=MAX,(PSMAX("RF"),PSFMAX("RF"))=PSRF,(PSMAX("DAYS"),PSFMAX("DAYS"))=PSDAYS,(PSMAX,PSFMAX)=1
"RTN","PSOORNW1",89,0)
 K PSTMAX D EDSTAT
"RTN","PSOORNW1",90,0)
 Q
"RTN","PSOORNW1",91,0)
STATDAY K PSMAX,PSRMAX,PSFMAX,PSTMAX S PSDAYS=$P(^PSRX(DA,0),"^",8),PSRF=$P(^PSRX(DA,0),"^",9),PTST=$P(^PS(53,X,0),"^"),PTDY=$P(^(0),"^",3),PTRF=$P(^(0),"^",4)
"RTN","PSOORNW1",92,0)
EDSTAT I PSRF>PTRF W !,$C(7),PSRF_" refills are greater than "_PTRF_" allowed for "_$P(PTST,"^")_" Rx Patient Status.",! S PSTMAX=1,PSTMAX("PTRF")=PTRF,PSTMAX("PSRF")=PSRF,PSTMAX("PT")=$P(PTST,"^")
"RTN","PSOORNW1",93,0)
 Q
"RTN","PSOORNW1",94,0)
OERF S DIR(0)="N^0:"_PSOX,DIR("A")="# OF REFILLS"
"RTN","PSOORNW1",95,0)
 S DIR("B")=$S($G(POERR):PSONEW("# OF REFILLS"),$G(PSONEW("N# REF"))]"":PSONEW("N# REF"),$G(PSONEW("# OF REFILLS"))]"":PSONEW("# OF REFILLS"),$G(PSOX1)]""&(PSOX>PSOX1):PSOX1,1:PSOX)
"RTN","PSOORNW1",96,0)
 S DIR("?")="Enter a whole number.  The maximum is set by the Rx Patient Status because there is no Dispense Drug."
"RTN","PSOORNW1",97,0)
 D ^DIR G:$D(DIRUT) REFX
"RTN","PSOORNW1",98,0)
 S (PSONEW("N# REF"),PSONEW("# OF REFILLS"))=Y
"RTN","PSOORNW1",99,0)
REFX S:'$D(PSONEW("# OF REFILLS")) PSONEW("# OF REFILLS")=$S($G(PSONEW("N# REF"))]"":PSONEW("N# REF"),$G(PSOX1)]""&($G(PSOX)>PSOX1):PSOX1,1:PSOX)
"RTN","PSOORNW1",100,0)
 K X,Y,PSOX,PSOX1,PSDY,PSDY1,DEA
"RTN","PSOORNW1",101,0)
KV K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOORNW1",102,0)
 Q
"RTN","PSOORUT1")
0^32^B78925499^B77790582
"RTN","PSOORUT1",1,0)
PSOORUT1 ;BIR/SAB - Utility routine for oerr interface ;6/28/07 7:36am
"RTN","PSOORUT1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,14,30,46,132,148,233,274,225,305,289,251,387,385,313**;DEC 1997;Build 76
"RTN","PSOORUT1",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORUT1",4,0)
 ;External reference to ^PSXOPUTL supported by DBIA 2203
"RTN","PSOORUT1",5,0)
 ;called from HD^PSOORUTL
"RTN","PSOORUT1",6,0)
REL ;removed order from hold
"RTN","PSOORUT1",7,0)
 S ACT=1,ORS=0
"RTN","PSOORUT1",8,0)
 I POERR("PSOFILNM")["S" S DA=+POERR("PSOFILNM") D  G EXIT^PSOORUTL
"RTN","PSOORUT1",9,0)
 .Q:'$D(^PS(52.41,DA,0))  Q:$P(^PS(52.41,DA,0),"^",3)="RF"
"RTN","PSOORUT1",10,0)
 .S $P(^PS(52.41,DA,0),"^",3)="NW",POERR("STAT")="OR",POERR("FILLER")=DA_"^P"
"RTN","PSOORUT1",11,0)
 .S:$G(POERR("COMM"))']"" POERR("COMM")="Order RELEASED from HOLD by OE/RR before finished." S $P(^PS(52.41,DA,4),"^")=POERR("COMM"),ORS=1
"RTN","PSOORUT1",12,0)
 S DA=POERR("PSOFILNM") I $D(^PSRX(DA,0)) S ORS=1,PSDA=DA D  G EXIT^PSOORUTL
"RTN","PSOORUT1",13,0)
 .S POERR("FILLER")=DA_"^R",POERR("STAT")="OR"
"RTN","PSOORUT1",14,0)
 .S:'$D(POERR("COMM")) POERR("COMM")="Prescription Released from HOLD by OE/RR"
"RTN","PSOORUT1",15,0)
 .I DT>$P(^PSRX(DA,2),"^",6) D
"RTN","PSOORUT1",16,0)
 ..S EXP=$P(^PSRX(DA,2),"^",6) S:$P(^PSRX(DA,"STA"),"^")<12 $P(^PSRX(DA,"STA"),"^")=11,PSOEXFLG=1 S POERR("STAT")="UR",POERR("COMM")="Medication Expired on "_$E(EXP,4,5)_"/"_$E(EXP,6,7)_"/"_$E(EXP,2,3)_".",POERR("PHARMST")="" D ECAN^PSOUTL(DA) Q
"RTN","PSOORUT1",17,0)
 .I $P(^PSRX(DA,"STA"),"^")'=16 S POERR("STAT")="UR",POERR("COMM")="Unable to Release from Hold" Q
"RTN","PSOORUT1",18,0)
 .S RXFL(DA)=0,FDT=$P(^PSRX(DA,2),"^",2)
"RTN","PSOORUT1",19,0)
 .I $O(^PSRX(DA,1,0)) F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S FDT=$P(^PSRX(DA,1,I,0),"^"),RXFL(DA)=I
"RTN","PSOORUT1",20,0)
 .I FDT>DT N PSOSITEZ,ZPSOPAR6 S PSOSITEZ=$S($P($G(^PSRX(DA,2)),"^",9):$P(^(2),"^",9),1:$O(^PS(59,0))),ZPSOPAR6=$P($G(^PS(59,PSOSITEZ,1)),"^",6) I ZPSOPAR6 D  Q
"RTN","PSOORUT1",21,0)
 ..S RXXDA=DA,DA=$O(^PS(52.5,"B",RXXDA,0)) I DA S DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOORUT1",22,0)
 ..S DA=RXXDA
"RTN","PSOORUT1",23,0)
 ..S DIC="^PS(52.5,",DIC(0)="L",DLAYGO=52.5,X=RXXDA,DIC("DR")=".02///"_FDT_";.03////"_$P(^PSRX(DA,0),"^",2)_";.04///M;.05///0;.06////"_PSOSITEZ_";2///0;9///"_RXFL(DA) K DD,DO D FILE^DICN K RXFL,DD,DO
"RTN","PSOORUT1",24,0)
 ..S DA=RXXDA K RXXDA S $P(^PSRX(DA,"STA"),"^")=5,LFD=$E(FDT,4,5)_"-"_$E(FDT,6,7)_"-"_$E(FDT,2,3) D ACT1
"RTN","PSOORUT1",25,0)
 ..S PSOSUSZ=1
"RTN","PSOORUT1",26,0)
 .E  S $P(^PSRX(DA,"STA"),"^")=0
"RTN","PSOORUT1",27,0)
 .S RXF=0 F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S RXF=I S:I>5 RXF=I+1
"RTN","PSOORUT1",28,0)
 .D ACT^PSOORUTL
"RTN","PSOORUT1",29,0)
 .I $$SUBMIT^PSOBPSUT(DA) D ECMESND^PSOBPSU1(DA,"","",$S('$O(^PSRX(DA,1,0)):"OF",1:"RF"))
"RTN","PSOORUT1",30,0)
 G EXIT^PSOORUTL
"RTN","PSOORUT1",31,0)
ACT1 I '$D(RXF) S RXF=0 F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S RXF=I S:I>5 RXF=I+1
"RTN","PSOORUT1",32,0)
 S IR=0 F FDA=0:0 S FDA=$O(^PSRX(DA,"A",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOORUT1",33,0)
 S IR=IR+1,^PSRX(DA,"A",0)="^52.3DA^"_IR_"^"_IR
"RTN","PSOORUT1",34,0)
 D NOW^%DTC S ^PSRX(DA,"A",IR,0)=%_"^S^"_POERR("USER")_"^"_RXF_"^"_"RX Placed on Suspense until "_LFD
"RTN","PSOORUT1",35,0)
 Q
"RTN","PSOORUT1",36,0)
SUS ;
"RTN","PSOORUT1",37,0)
 I $P($G(^PSRX(+$G(FILLER),"STA")),"^")=5 N PSOMSORR,PLACERXX D EN^PSOHLSN1(+$G(FILLER),"SC","ZS","")
"RTN","PSOORUT1",38,0)
 Q
"RTN","PSOORUT1",39,0)
BLD ;builds med profile for Listman
"RTN","PSOORUT1",40,0)
 K PSODCREV,^TMP("PSOPF",$J),PSOLST S:$G(PSOOPT)'=3 PSOOPT=0 I '$G(PSOSD) S ^TMP("PSOPF",$J,1,0)="This patient has no prescriptions" S PSOCNT=0,PSOPF=1 Q
"RTN","PSOORUT1",41,0)
 D EOJ,SHOW
"RTN","PSOORUT1",42,0)
EOJ ;
"RTN","PSOORUT1",43,0)
 K PSOQFLG,PSODRG,PSODATA,PSOLF
"RTN","PSOORUT1",44,0)
 Q
"RTN","PSOORUT1",45,0)
 ;-----------------------------------------------------------------
"RTN","PSOORUT1",46,0)
SHOW ;
"RTN","PSOORUT1",47,0)
 ; - ePharmacy modification to create a section for Rx with REJECTs
"RTN","PSOORUT1",48,0)
 N PSOTMP,PSOSTS,PSODRNM,I,PSORX
"RTN","PSOORUT1",49,0)
 S (PSOSTS,PSODRNM)=""
"RTN","PSOORUT1",50,0)
 F  S PSOSTS=$O(PSOSD(PSOSTS)) Q:PSOSTS=""  D
"RTN","PSOORUT1",51,0)
 . F  S PSODRNM=$O(PSOSD(PSOSTS,PSODRNM)) Q:PSODRNM=""  D
"RTN","PSOORUT1",52,0)
 . . S PSORX=+$G(PSOSD(PSOSTS,PSODRNM))
"RTN","PSOORUT1",53,0)
 . . I PSOSTS="ACTIVE",$$FIND^PSOREJUT(PSORX,,,"79,88") D  Q
"RTN","PSOORUT1",54,0)
 . . . S PSOTMP(" REJECT",PSODRNM)=PSOSTS
"RTN","PSOORUT1",55,0)
 . . S PSOTMP(PSOSTS,PSODRNM)=PSOSTS
"RTN","PSOORUT1",56,0)
 ;
"RTN","PSOORUT1",57,0)
 S (PSOSTS,PSODRG)="",(PSOCNT,PSOQFLG,IEN)=0
"RTN","PSOORUT1",58,0)
 K RN,DL S $P(RN," ",12)=" ",$P(DL," ",40)=" "
"RTN","PSOORUT1",59,0)
 F PSCNT=0:0 S PSOSTS=$O(PSOTMP(PSOSTS)) Q:PSOSTS=""  D
"RTN","PSOORUT1",60,0)
 . D STA
"RTN","PSOORUT1",61,0)
 . F PSOCT=0:0 S PSODRG=$O(PSOTMP(PSOSTS,PSODRG)) Q:PSODRG=""  Q:PSOCNT>1000!PSOQFLG  D
"RTN","PSOORUT1",62,0)
 . . S PSOSTA=PSOTMP(PSOSTS,PSODRG)
"RTN","PSOORUT1",63,0)
 . . S PSODATA=PSOSD(PSOSTA,PSODRG) I PSOSTA="ZNONVA" D NVA Q
"RTN","PSOORUT1",64,0)
 . . S PSOCNT=PSOCNT+1 I PSOSTA="PENDING" D PEN Q
"RTN","PSOORUT1",65,0)
 . . S:'$D(^PSRX(+PSODATA,0)) PSOCNT=PSOCNT-1 D:$D(^(0)) DISPL
"RTN","PSOORUT1",66,0)
 S (VALMCNT,PSOPF)=IEN
"RTN","PSOORUT1",67,0)
SHOWX K DIRUT,DTOUT,DUOUT,DIROUT,PSODRG
"RTN","PSOORUT1",68,0)
 Q
"RTN","PSOORUT1",69,0)
 ;
"RTN","PSOORUT1",70,0)
DISPL S IEN=IEN+1 N PSOID,PSOCMOP,STATLTH,ECME,TITRX
"RTN","PSOORUT1",71,0)
 K PSOLNT,PSOQTL,PSOLSP S PSOLRX=$S($G(^PSRX(+PSODATA,"IB")):13,1:14)-$L($P(^PSRX(+PSODATA,0),"^")),$P(PSOLNT," ",PSOLRX)=" ",PSODQL=$L($P(PSODRG,"^"))+$L($P(^PSRX(+PSODATA,0),"^",7))
"RTN","PSOORUT1",72,0)
 I PSODQL<39 S $P(PSOQTL," ",(40-PSODQL))=" "
"RTN","PSOORUT1",73,0)
 E  S $P(PSOQTL," ",(52-$L($P(^PSRX(+PSODATA,0),"^",7))))=" ",$P(PSOLSP," ",(41-$L($P(PSODRG,"^"))))=" "
"RTN","PSOORUT1",74,0)
 S ECME=$$ECME^PSOBPSUT(+PSODATA) I ECME'="" S PSOLNT=$E(PSOLNT,1,$L(PSOLNT)-1)
"RTN","PSOORUT1",75,0)
 S TITRX=$$TITRX^PSOUTL(+PSODATA) I TITRX'="" S PSOLNT=$E(PSOLNT,1,$L(PSOLNT)-1)
"RTN","PSOORUT1",76,0)
 S ^TMP("PSOPF",$J,IEN,0)=$J(PSOCNT,2)_$S($L(PSOCNT)<3:" ",1:"")_$P(^PSRX(+PSODATA,0),"^")_$S($G(^PSRX(+PSODATA,"IB")):"$",1:"")_ECME_TITRX_PSOLNT_$P(PSODRG,"^")_$S(PSODQL<39:PSOQTL_$P(^PSRX(+PSODATA,0),"^",7)_" ",1:$G(PSOLSP))
"RTN","PSOORUT1",77,0)
 S STA="A^N^R^H^N^S^^^^^^E^DC^^DP^DE^HP^P^"
"RTN","PSOORUT1",78,0)
 S PSOCMOP=""
"RTN","PSOORUT1",79,0)
 I $D(^PSDRUG("AQ",$P(^PSRX(+PSODATA,0),"^",6))) S PSOCMOP=">"
"RTN","PSOORUT1",80,0)
 N X S X="PSXOPUTL" X ^%ZOSF("TEST") K X I $T D
"RTN","PSOORUT1",81,0)
 .N DA S DA=+PSODATA D ^PSXOPUTL K DA
"RTN","PSOORUT1",82,0)
 .I $G(PSXZ(PSXZ("L")))=0!($G(PSXZ(PSXZ("L")))=2) S PSOCMOP="T"
"RTN","PSOORUT1",83,0)
 .K PSXZ
"RTN","PSOORUT1",84,0)
 N PSOBADR
"RTN","PSOORUT1",85,0)
 S PSOBADR=$O(^PSRX(+PSODATA,"L",9999),-1)
"RTN","PSOORUT1",86,0)
 I PSOBADR'="" S PSOBADR=$G(^PSRX(+PSODATA,"L",PSOBADR,0)) I PSOBADR["(BAD ADDRESS)" S PSOBADR="B"
"RTN","PSOORUT1",87,0)
 I PSOBADR'="B" S PSOBADR=""
"RTN","PSOORUT1",88,0)
 S (STA,STATLTH)=$P(STA,"^",$P(PSODATA,"^",2)+1) D
"RTN","PSOORUT1",89,0)
 .I $G(^PSRX(+PSODATA,"DDSTA"))]"" S (STATLTH,STA)="DD" Q
"RTN","PSOORUT1",90,0)
 .S (STATLTH,STA)=$S($P($G(^PSRX(+PSODATA,7)),"^")=1:"DA",$P($G(^PSRX(+PSODATA,7)),"^")=2:"DF",1:STA)
"RTN","PSOORUT1",91,0)
 S STAPRT=STA_PSOCMOP_PSOBADR,STATLTH=$L(STAPRT)
"RTN","PSOORUT1",92,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_STAPRT_$S(STATLTH=0:"   ",STATLTH=1:"  ",STATLTH=2:" ",1:"")
"RTN","PSOORUT1",93,0)
 S PSOID=$P(^PSRX(+PSODATA,0),"^",13),PSOLF=+$G(^(3)),^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$E(PSOID,4,5)_"-"_$E(PSOID,6,7)_" "
"RTN","PSOORUT1",94,0)
 N RFLZRO,PSOLRD S PSOLRD=$P($G(^PSRX(+PSODATA,2)),"^",13)
"RTN","PSOORUT1",95,0)
 F PSOX=0:0 S PSOX=$O(^PSRX(+PSODATA,1,PSOX)) Q:'PSOX  D
"RTN","PSOORUT1",96,0)
 . S RFLZRO=$G(^PSRX(+PSODATA,1,PSOX,0))
"RTN","PSOORUT1",97,0)
 . I +RFLZRO=PSOLF,$P(RFLZRO,"^",16) S PSOLF=PSOLF_"^R"
"RTN","PSOORUT1",98,0)
 . S:$P(RFLZRO,"^",18)'="" PSOLRD=$P(RFLZRO,"^",18) I $P(RFLZRO,"^",16) S PSOLRD=PSOLRD_"^R"
"RTN","PSOORUT1",99,0)
 K PSOX
"RTN","PSOORUT1",100,0)
 I '$O(^PSRX(+PSODATA,1,0)),$P(^PSRX(+PSODATA,2),"^",15) S PSOLF=PSOLF_"^R",PSOLRD=PSOLRD_"^R"
"RTN","PSOORUT1",101,0)
 S PSOLF=$S($G(PSOLF):$E(PSOLF,4,5),1:"  ")_"-"_$S($G(PSOLF):$E(PSOLF,6,7),1:"  ")_$S($P(PSOLF,"^",2)="R":"R ",1:"  ")
"RTN","PSOORUT1",102,0)
 S PSOLRD=$S($G(PSOLRD):$E(PSOLRD,4,5),1:"  ")_"-"_$S($G(PSOLRD):$E(PSOLRD,6,7),1:"  ")_$S($P(PSOLRD,"^",2)="R":"R ",1:"  ")
"RTN","PSOORUT1",103,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$S($G(PSORFG):PSOLRD,1:PSOLF)
"RTN","PSOORUT1",104,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$J($P(PSODATA,"^",6),2)_" "_$J($P(PSODATA,"^",8),3)
"RTN","PSOORUT1",105,0)
 ;recently dc'd rxs
"RTN","PSOORUT1",106,0)
 I $P($G(^PSRX(+PSODATA,3)),"^",5) D  K X
"RTN","PSOORUT1",107,0)
 .S X2=$S($P(PSOPAR,"^",33):$P(PSOPAR,"^",33),1:7),X1=$P(^PSRX(+PSODATA,3),"^",5) D C^%DTC
"RTN","PSOORUT1",108,0)
 .I DT<X S PSODCREV(IEN)=IEN
"RTN","PSOORUT1",109,0)
 ;recently expired rxs
"RTN","PSOORUT1",110,0)
 I $P($G(^PSRX(+PSODATA,2)),"^",6)<DT,'$P($G(^PSRX(+PSODATA,3)),"^",5) D  K X
"RTN","PSOORUT1",111,0)
 .S X2=$S($P(PSOPAR,"^",33):$P(PSOPAR,"^",33),1:7),X1=$P(^PSRX(+PSODATA,2),"^",6) D C^%DTC
"RTN","PSOORUT1",112,0)
 .I DT<X S PSODCREV(IEN)=IEN
"RTN","PSOORUT1",113,0)
 ;
"RTN","PSOORUT1",114,0)
 I PSODQL>38 S IEN=IEN+1 S ^TMP("PSOPF",$J,IEN,0)=PSOQTL_"Qty: "_$P(^PSRX(+PSODATA,0),"^",7)
"RTN","PSOORUT1",115,0)
 K PSOLNT,PSOQTL,PSOLSP,PSOLRX,PSODQL
"RTN","PSOORUT1",116,0)
 S PSOLST(PSOCNT)="52^"_+PSODATA_"^"_PSOSTA
"RTN","PSOORUT1",117,0)
 K PSODATA,PSOLF S PSOPF=IEN
"RTN","PSOORUT1",118,0)
 Q
"RTN","PSOORUT1",119,0)
 ;
"RTN","PSOORUT1",120,0)
STA N LABEL,LINE,POS
"RTN","PSOORUT1",121,0)
 S LABEL=PSOSTS,IEN=IEN+1
"RTN","PSOORUT1",122,0)
 I PSOSTS="ZNONVA" S LABEL="Non-VA MEDS (Not dispensed by VA)"
"RTN","PSOORUT1",123,0)
 I PSOSTS=" REJECT" S LABEL="REFILL TOO SOON/DUR REJECTS (Third Party)"
"RTN","PSOORUT1",124,0)
 S POS=80-$L(LABEL)/2,$P(LINE,"-",81)="",$E(LINE,POS+1,POS+$L(LABEL))=LABEL
"RTN","PSOORUT1",125,0)
 S ^TMP("PSOPF",$J,IEN,0)=LINE
"RTN","PSOORUT1",126,0)
 Q
"RTN","PSOORUT1",127,0)
PENX S PSOLST(PSOCNT)="52.41^"_$P(PSODATA,"^",10)_"^"_PSOSTA
"RTN","PSOORUT1",128,0)
 K PSODATA,PSOLF,RN,PSOLSP,PSOQTL,PSOLNT
"RTN","PSOORUT1",129,0)
 Q
"RTN","PSOORUT1",130,0)
PEN ;
"RTN","PSOORUT1",131,0)
 N PSOQTL,PSOLNT,PSOLNTZ,PSOQTLX,PSCMOPF,SPACEZ
"RTN","PSOORUT1",132,0)
 Q:'$D(^PS(52.41,$P(PSODATA,"^",10),0))
"RTN","PSOORUT1",133,0)
 S PSCMOPF=0 I $P($G(PSODATA),"^",11),$D(^PSDRUG("AQ",$P(PSODATA,"^",11))) S PSCMOPF=1
"RTN","PSOORUT1",134,0)
 S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)=$J(PSOCNT,2)_$S($L(PSOCNT)<3:" ",1:"")_$P(PSODRG,"^")
"RTN","PSOORUT1",135,0)
 I $P($G(^PS(52.41,+$P(PSODATA,"^",10),0)),"^",23)=1 S ^TMP("PSOPF",$J,IEN,"RV")=""
"RTN","PSOORUT1",136,0)
 S PSOLNT=$L($P(PSODRG,"^")),PSOLNTZ=$L($P(PSODATA,"^",8))
"RTN","PSOORUT1",137,0)
 S $P(PSOQTLX," ",(11-PSOLNTZ))=" "
"RTN","PSOORUT1",138,0)
 S:PSOLNT<37 $P(PSOQTL," ",(37-PSOLNT))=" "
"RTN","PSOORUT1",139,0)
 I PSOLNT<38 D  G PENX
"RTN","PSOORUT1",140,0)
 .I PSOLNT=37 S PSOQTL=""
"RTN","PSOORUT1",141,0)
 .I $P(^PS(52.41,$P(PSODATA,"^",10),0),"^",3)="RF" S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$G(PSOQTL)_"  Refill Request   Rx #: "_$P(^PSRX($P(^PS(52.41,$P(PSODATA,"^",10),0),"^",19),0),"^") Q
"RTN","PSOORUT1",142,0)
 .S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$G(PSOQTL)_"  "_"QTY: "_$P(PSODATA,"^",8)_$G(PSOQTLX)_" ISDT: "_$S('$P(PSODATA,"^",9):"     ",1:$E($P(PSODATA,"^",9),4,5)_"-"_$E($P(PSODATA,"^",9),6,7))_$S($G(PSCMOPF):"> ",1:"  ")
"RTN","PSOORUT1",143,0)
 .S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_"REF: "_$S($L($P(PSODATA,"^",6))>1:"",1:" ")_$P(PSODATA,"^",6)
"RTN","PSOORUT1",144,0)
 S IEN=IEN+1,$P(SPACEZ," ",42)=" "
"RTN","PSOORUT1",145,0)
 I $P(^PS(52.41,$P(PSODATA,"^",10),0),"^",3)="RF" S ^TMP("PSOPF",$J,IEN,0)=SPACEZ_"Refill Request   Rx #: "_$P(^PSRX($P(^PS(52.41,$P(PSODATA,"^",10),0),"^",19),0),"^") G PENX
"RTN","PSOORUT1",146,0)
 S ^TMP("PSOPF",$J,IEN,0)=SPACEZ_"QTY: "_$P(PSODATA,"^",8)_$G(PSOQTLX)_" ISDT: "_$S('$P(PSODATA,"^",9):"     ",1:$E($P(PSODATA,"^",9),4,5)_"-"_$E($P(PSODATA,"^",9),6,7))_$S($G(PSCMOPF):"> ",1:"  ")_"REF: "_$S($L($P(PSODATA,"^",6))>1:"",1:" ")
"RTN","PSOORUT1",147,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$P(PSODATA,"^",6)
"RTN","PSOORUT1",148,0)
 G PENX
"RTN","PSOORUT1",149,0)
 ;
"RTN","PSOORUT1",150,0)
NVA ; Setting the Non-VA Meds on the Medication Profile Screen (ListMan)
"RTN","PSOORUT1",151,0)
 S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)="  "_$P(PSODRG,"^")_" "
"RTN","PSOORUT1",152,0)
 I ($L(^TMP("PSOPF",$J,IEN,0))+$L($P(PSODATA,"^",6))>70) S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)="    "
"RTN","PSOORUT1",153,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$P(PSODATA,"^",6)_" "
"RTN","PSOORUT1",154,0)
 I ($L(^TMP("PSOPF",$J,IEN,0))+$L($P(PSODATA,"^",8))>70) S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)="    "
"RTN","PSOORUT1",155,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$P(PSODATA,"^",8)
"RTN","PSOORUT1",156,0)
 I ($L(^TMP("PSOPF",$J,IEN,0))+20)>70 D  Q
"RTN","PSOORUT1",157,0)
 . S IEN=IEN+1,$P(^TMP("PSOPF",$J,IEN,0)," ",51)="Date Documented: "_$E($P(PSODATA,"^",9),4,5)_"/"_$E($P(PSODATA,"^",9),6,7)_"/"_$E($P(PSODATA,"^",9),2,3)
"RTN","PSOORUT1",158,0)
 F I=0:0 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_" " Q:$L(^TMP("PSOPF",$J,IEN,0))>49
"RTN","PSOORUT1",159,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_"Date Documented: "_$E($P(PSODATA,"^",9),4,5)_"/"_$E($P(PSODATA,"^",9),6,7)_"/"_$E($P(PSODATA,"^",9),2,3)
"RTN","PSOORUT1",160,0)
 Q
"RTN","PSOOTMRX")
0^44^B20486782^n/a
"RTN","PSOOTMRX",1,0)
PSOOTMRX ;BIR/MFR - Titration/Maintenance Dose Prescription ;10/17/96
"RTN","PSOOTMRX",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**313**;DEC 1997;Build 76
"RTN","PSOOTMRX",3,0)
 ;External reference to ULK^ORX2 supported by DBIA 867
"RTN","PSOOTMRX",4,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSOOTMRX",5,0)
 ;
"RTN","PSOOTMRX",6,0)
TIMTRX ; Titration/Maintenance Dose Rx Hidden Action Entry Point
"RTN","PSOOTMRX",7,0)
 N PSOMTFLG,PSOTITRX,PSORXIEN,LASTDOSE,BEFLST,DOSEINFO,DEA,LAB
"RTN","PSOOTMRX",8,0)
 S PSORXIEN=$P(PSOLST(ORN),"^",2)
"RTN","PSOOTMRX",9,0)
 ;
"RTN","PSOOTMRX",10,0)
 ; - Rx already marked Maintenance
"RTN","PSOOTMRX",11,0)
 I $$TITRX^PSOUTL(PSORXIEN)="m" D  Q
"RTN","PSOOTMRX",12,0)
 . S VALMSG="Prescription already marked as 'Maintenance Rx'.",VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",13,0)
 ;
"RTN","PSOOTMRX",14,0)
 ; - Rx already split into Maintenance Rx
"RTN","PSOOTMRX",15,0)
 I $P($G(^PSRX(PSORXIEN,"TIT")),"^",2) D  Q
"RTN","PSOOTMRX",16,0)
 . S VALMSG="A Maintenance Rx already exists for this Rx ("_$$GET1^DIQ(52,$P($G(^PSRX(PSORXIEN,"TIT")),"^",2),.01)_")"
"RTN","PSOOTMRX",17,0)
 . S VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",18,0)
 ;
"RTN","PSOOTMRX",19,0)
 ; - Rx was Digitally Signed
"RTN","PSOOTMRX",20,0)
 I $$GET1^DIQ(52,PSORXIEN,310,"I") D  Q
"RTN","PSOOTMRX",21,0)
 . S VALMSG="Rx was digitally signed and cannot be converted.",VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",22,0)
 ; 
"RTN","PSOOTMRX",23,0)
 ; - No THEN conjunction for the last dose
"RTN","PSOOTMRX",24,0)
 I '$$LTHEN^PSOUTL(PSORXIEN) D  Q
"RTN","PSOOTMRX",25,0)
 . S VALMSG="A Titration Rx must have a THEN conjunction.",VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",26,0)
 ;
"RTN","PSOOTMRX",27,0)
 ; - Rx is not ACTIVE
"RTN","PSOOTMRX",28,0)
 I $$GET1^DIQ(52,PSORXIEN,100,"I")'=0 D  Q
"RTN","PSOOTMRX",29,0)
 . S VALMSG="Prescription is not ACTIVE.",VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",30,0)
 ;
"RTN","PSOOTMRX",31,0)
 ; - Rx NOT released
"RTN","PSOOTMRX",32,0)
 I '$$RXRLDT^PSOBPSUT(PSORXIEN,0) D  Q
"RTN","PSOOTMRX",33,0)
 . S VALMSG="Prescription must be RELEASED first.",VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",34,0)
 ;
"RTN","PSOOTMRX",35,0)
 ; - Rx already has refills
"RTN","PSOOTMRX",36,0)
 I $O(^PSRX(PSORXIEN,1,0)) D  Q
"RTN","PSOOTMRX",37,0)
 . S VALMSG="Prescription has previously been refilled.",VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",38,0)
 ;
"RTN","PSOOTMRX",39,0)
 ; - Rx already has refills
"RTN","PSOOTMRX",40,0)
 I '$$GET1^DIQ(52,PSORXIEN,9) D  Q
"RTN","PSOOTMRX",41,0)
 . S VALMSG="There are no refills available for this Rx.",VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",42,0)
 ;
"RTN","PSOOTMRX",43,0)
 ; - Rx not been marked as Titration
"RTN","PSOOTMRX",44,0)
 I '$P($G(^PSRX(PSORXIEN,"TIT")),"^",3) D  Q
"RTN","PSOOTMRX",45,0)
 . S VALMSG="Rx has not been marked as Titration",VALMBCK="R" W $C(7)
"RTN","PSOOTMRX",46,0)
 ;
"RTN","PSOOTMRX",47,0)
 S PSOMTFLG=1,PSOTITRX=PSORXIEN
"RTN","PSOOTMRX",48,0)
 D COPY^PSOORCPY K PSOMTFLG,PSOTITRX
"RTN","PSOOTMRX",49,0)
 ;
"RTN","PSOOTMRX",50,0)
 Q
"RTN","PSOOTMRX",51,0)
 ;
"RTN","PSOOTMRX",52,0)
MARKTIT ; Mark Rx as 'Titration' Hidden Action Entry Point
"RTN","PSOOTMRX",53,0)
 N PSORXIEN,CHECK
"RTN","PSOOTMRX",54,0)
 S PSORXIEN=$P(PSOLST(ORN),"^",2)
"RTN","PSOOTMRX",55,0)
 S CHECK=$$CHECK(PSORXIEN)
"RTN","PSOOTMRX",56,0)
 I 'CHECK D  Q
"RTN","PSOOTMRX",57,0)
 . S VALMBCK="R",VALMSG=$P(CHECK,"^",2) W $C(7)
"RTN","PSOOTMRX",58,0)
 ;
"RTN","PSOOTMRX",59,0)
 I $G(PSORXIEN) D MARK(PSORXIEN,1)
"RTN","PSOOTMRX",60,0)
 Q
"RTN","PSOOTMRX",61,0)
 ;
"RTN","PSOOTMRX",62,0)
END ;
"RTN","PSOOTMRX",63,0)
 Q
"RTN","PSOOTMRX",64,0)
 ;
"RTN","PSOOTMRX",65,0)
MARK(PSORXIEN,REFRESH) ; Mark a non-refillable Rx as Titration
"RTN","PSOOTMRX",66,0)
 N CHECK,DIR,PTLOCK,X,Y,DFN,COMM
"RTN","PSOOTMRX",67,0)
 ;
"RTN","PSOOTMRX",68,0)
 I '$$CHECK(PSORXIEN) Q
"RTN","PSOOTMRX",69,0)
 ;
"RTN","PSOOTMRX",70,0)
 D FULL^VALM1
"RTN","PSOOTMRX",71,0)
 W !
"RTN","PSOOTMRX",72,0)
 S DIR("A")="Do you want to "_$S($$TITRX^PSOUTL(PSORXIEN)="t":"UN",1:"")_"MARK this Rx as 'Titration'? "
"RTN","PSOOTMRX",73,0)
 I $$TITRX^PSOUTL(PSORXIEN)'="t" S (DIR("?"),DIR("??"))="^D TITHLP^PSOOTMRX"
"RTN","PSOOTMRX",74,0)
 S DIR(0)="YA" D ^DIR I Y'>0 D UNLK S VALMBCK="R" Q
"RTN","PSOOTMRX",75,0)
 ;
"RTN","PSOOTMRX",76,0)
 W !!,"Updating..."
"RTN","PSOOTMRX",77,0)
 I '$P($G(^PSRX(PSORXIEN,"TIT")),"^",3) D
"RTN","PSOOTMRX",78,0)
 . S $P(^PSRX(PSORXIEN,"TIT"),"^",3)=1,COMM="MARKED as Titration"
"RTN","PSOOTMRX",79,0)
 E  D
"RTN","PSOOTMRX",80,0)
 . S $P(^PSRX(PSORXIEN,"TIT"),"^",3)="",COMM="UNMARKED as Titration"
"RTN","PSOOTMRX",81,0)
 . I ($D(^PSRX(PSORXIEN,"TIT"))=1),$TR($G(^PSRX(PSORXIEN,"TIT")),"^","")="" D
"RTN","PSOOTMRX",82,0)
 . . K ^PSRX(PSORXIEN,"TIT")      ; Cleaning up the "TIT" subscript
"RTN","PSOOTMRX",83,0)
 D RXACT^PSOBPSU2(PSORXIEN,,COMM,"E")
"RTN","PSOOTMRX",84,0)
 H 1 W "OK"
"RTN","PSOOTMRX",85,0)
 ;
"RTN","PSOOTMRX",86,0)
 ; PSORXED is necessary to perform a REFRESH only
"RTN","PSOOTMRX",87,0)
 I $G(REFRESH) N PSORXED S PSORXED=1 D ACT^PSOORNE2 S VALMBCK="R"
"RTN","PSOOTMRX",88,0)
 ;
"RTN","PSOOTMRX",89,0)
 Q
"RTN","PSOOTMRX",90,0)
 ;
"RTN","PSOOTMRX",91,0)
UNLK ; Unlocks the Patient/Rx
"RTN","PSOOTMRX",92,0)
 S X=PSODFN_";DPT(" D ULK^ORX2
"RTN","PSOOTMRX",93,0)
 D UL^PSSLOCK(PSODFN)
"RTN","PSOOTMRX",94,0)
 Q
"RTN","PSOOTMRX",95,0)
 ;
"RTN","PSOOTMRX",96,0)
CHECK(PSORXIEN) ; Checks if Rx is eligible to be Marked as Titration/Maintenance
"RTN","PSOOTMRX",97,0)
 N MSG
"RTN","PSOOTMRX",98,0)
 S MSG=""
"RTN","PSOOTMRX",99,0)
 ; - Rx already marked as  Maintenance
"RTN","PSOOTMRX",100,0)
 I $$TITRX^PSOUTL(PSORXIEN)="m" D  Q ("0^"_MSG)
"RTN","PSOOTMRX",101,0)
 . S MSG="Prescription already marked as 'Maintenance Rx'."
"RTN","PSOOTMRX",102,0)
 ;
"RTN","PSOOTMRX",103,0)
 ; - No THEN conjunction for the last dose
"RTN","PSOOTMRX",104,0)
 I '$$LTHEN^PSOUTL(PSORXIEN) D  Q ("0^"_MSG)
"RTN","PSOOTMRX",105,0)
 . S MSG="A TITRATION Rx must have a THEN conjunction."
"RTN","PSOOTMRX",106,0)
 ;
"RTN","PSOOTMRX",107,0)
 ;
"RTN","PSOOTMRX",108,0)
 ; - Rx is not ACTIVE or SUSPENDED
"RTN","PSOOTMRX",109,0)
 I $$GET1^DIQ(52,PSORXIEN,100,"I")'=0,$$GET1^DIQ(52,PSORXIEN,100,"I")'=5 D  Q ("0^"_MSG)
"RTN","PSOOTMRX",110,0)
 . S MSG="Prescription must be ACTIVE or SUSPENDED."
"RTN","PSOOTMRX",111,0)
 ;
"RTN","PSOOTMRX",112,0)
 Q 1
"RTN","PSOOTMRX",113,0)
 ;
"RTN","PSOOTMRX",114,0)
TITHLP ; Help Text for Mark Rx as Titration/Maintenance prompt
"RTN","PSOOTMRX",115,0)
 W !?5,"Answer YES if this is a Titration to Maintenance prescription."
"RTN","PSOOTMRX",116,0)
 W !?5,"Actions such as Renewal (including from CPRS), Refill, and Copy"
"RTN","PSOOTMRX",117,0)
 W !?5,"are not allowed on prescriptions marked as Titration."
"RTN","PSOOTMRX",118,0)
 W !?5,"However, you will be able to create a Maintenance Rx from this Rx"
"RTN","PSOOTMRX",119,0)
 W !?5,"upon refill request via the TR (Convert Titration Rx) hidden action."
"RTN","PSOOTMRX",120,0)
 Q
"RTN","PSOP")
0^7^B45480400^B45335172
"RTN","PSOP",1,0)
PSOP ;BIR/SAB - Medication profile long or short ;02/25/94
"RTN","PSOP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**2,15,98,132,148,326,313**;DEC 1997;Build 76
"RTN","PSOP",3,0)
 ;External reference to PS(55 supported by DBIA 2228
"RTN","PSOP",4,0)
 ;External reference to PS(59.7 supported by DBIA 694
"RTN","PSOP",5,0)
 ;External reference to PSDRUG supported by DBIA 221
"RTN","PSOP",6,0)
 W !! K ^TMP($J),ZTSK,CLS S DIC(0)="QEAM" D EN^PSOPATLK S Y=PSOPTLK G Q:+Y<1  S PSOLOUD=1,DFN=+Y D:$P($G(^PS(55,+Y,0)),"^",6)'=2 EN^PSOHLUP(+Y) K PSOLOUD S Y=DFN
"RTN","PSOP",7,0)
DOIT S (FN,DFN,D0,DA)=+Y I '$D(^PS(55,+Y,"P")),'$D(^("ARC")),'$D(^("NVA")),'$D(^PS(52.41,"AOR",+Y)) W !?20,$C(7),"NO PHARMACY INFORMATION" H 5 D ^PSODEM G PSOP
"RTN","PSOP",8,0)
 I '$O(^PS(55,+Y,"P",0)),$D(^PS(55,+Y,"ARC")) D ^PSODEM W !!,"PATIENT HAS ARCHIVED PRESCRIPTIONS",! G PSOP
"RTN","PSOP",9,0)
 S DIR("?")="Enter 'L' for a long profile or 'S' for a short profile",DIR("A")="LONG or SHORT: ",DIR(0)="SA^L:LONG;S:SHORT",DIR("B")="SHORT" D ^DIR G:$D(DUOUT)!$D(DIRUT) Q S PLS=Y K DIR
"RTN","PSOP",10,0)
S S DIR(0)="SA^D:DATE;M:MEDICATION;C:CLASS",DIR("A")="Sort by DATE, CLASS or MEDICATION: ",DIR("B")=$S($P($G(PSOPAR),"^",14)=2:"MEDICATION",$P($G(PSOPAR),"^",14)=1:"CLASS",1:"DATE")
"RTN","PSOP",11,0)
 S DIR("?",1)="Enter 'DATE', 'CLASS' or 'MEDICATION' to determine the order in which",DIR("?")="prescriptions will appear on the profile." D ^DIR G:$D(DUOUT)!$D(DIRUT) Q S PSRT=$S(Y="D":"DATE",Y="M":"DRUG",1:"CLSS")
"RTN","PSOP",12,0)
 S HDR=$S(Y="D":"ISSUE DATE",Y="M":"DRUG NAME",1:"DRUG CLASS") K DIR
"RTN","PSOP",13,0)
 K DIR G:PSRT="DATE" DEV S DIR("A")="Profile Expiration/Discontinued cutoff",DIR("B")=120,DIR(0)="N^1:9999:0",DIR("?",1)="Enter the number of days which will cut discontinued and expired Rx's from",DIR("?")="the profile."
"RTN","PSOP",14,0)
 D ^DIR G:$D(DTOUT)!($D(DUOUT)) Q K DIR S X1=DT,X2=-X D C^%DTC S PSODTCT=X
"RTN","PSOP",15,0)
DEV D SORT^PSOP1 G:$D(DUOUT)!($D(DTOUT)) Q
"RTN","PSOP",16,0)
 K %ZIS,IOP,ZTSK S PSOION=ION,%ZIS="MQ" D ^%ZIS K %ZIS I POP S IOP=PSOION D ^%ZIS K IOP,PSOION G Q
"RTN","PSOP",17,0)
 K PSOION I $D(IO("Q")) S ZTDESC="Patient Medication Profile",ZTRTN="P^PSOP" D  G PSOP
"RTN","PSOP",18,0)
 .F G="HDR","TO","FR","SDT","PSFR","PSTO","DTS","CLS","EDT","DRS","PSODTCT","FN","DFN","DA","D0","PLS","PSRT","PSOPAR" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOP",19,0)
 .K IO("Q") D ^%ZTLOAD W:$D(ZTSK) !,"Task Queued to Print",! K Q,ZTSK D Q
"RTN","PSOP",20,0)
 D P,Q G PSOP
"RTN","PSOP",21,0)
P U IO S PAGE=1,$P(PSOPLINE,"-",80)="" K ^TMP($J) D LOOP D ^PSODEM W:$O(^PS(55,DA,"ARC",0)) !!,"Patient Has Archived Prescriptions",!
"RTN","PSOP",22,0)
 I $Y+10>IOSL,$E(IOST)="C" D DIR^PSOP1 Q:$D(PQT)  W @IOF
"RTN","PSOP",23,0)
 W:$P($G(^PS(59.7,1,40.1)),"^") !,"Outpatient prescriptions are discontinued 72 hours after admission"
"RTN","PSOP",24,0)
 W !!?(80-$L("Medication Profile Sorted by "_HDR))/2,"Medication Profile Sorted by "_HDR W:$G(FR)]"" !?(80-$L(FR_" to "_TO))/2,FR_" to "_TO
"RTN","PSOP",25,0)
 I PLS="S" D ^PSOP1 G Q
"RTN","PSOP",26,0)
 W ! S DRUG="" F II=0:0 S DRUG=$O(^TMP($J,DRUG)) Q:DRUG=""!($D(PQT))  F J=0:0 S J=$O(^TMP($J,DRUG,J)) Q:'J  D O W:$G(PQT) @IOF Q:$G(PQT)  I $Y+8>IOSL,$E(IOST)="C" D DIR^PSOP1 W @IOF Q:$D(PQT)
"RTN","PSOP",27,0)
 D PEND^PSOP2,NVA^PSOP2
"RTN","PSOP",28,0)
Q D ^%ZISC K CP,HDR,X1,X2,RX3,^TMP($J),ST0,PSODTCT,ST,D0,DIC,DIR,DIRUT,DUOUT,G,II,K,RXD,RXF,ZX,DRUG,X,DFN,PHYS,PSRT,CT,AL,I1,PLS,REF,LMI,PI,FN,Y,I,J,RX,DRX,ST,RX0,RX2,DA,PSOPLINE,PAGE,PRLBL,PSOPATOK,PSOPTLK
"RTN","PSOP",29,0)
 K PSOLR,PSDIV,PQT,TO,FR,CLS,DRG,DRS,DTS,DTOUT,PSFR,PSTO,SDT,EDT,PPP,FSIG,IIII,STAT,PP,EEEE,PPPCNT,PENDREX,PSOPEND,PPDIS,PPOI,PCOUNT,PPCOUNT,PPP S:$D(ZTQUEUED) ZTREQ="@" Q
"RTN","PSOP",30,0)
 ;
"RTN","PSOP",31,0)
O S RX0=^PSRX(J,0),RX2=$G(^(2)),RX3=$G(^(3)),$P(RX0,"^",15)=$G(^("STA")),DRX="NOT ON FILE",CP=$S(+$G(^PSRX(J,"IB")):"$",1:" ") S:$P(RX0,"^",15)="" $P(RX0,"^",15)=-1
"RTN","PSOP",32,0)
 ;
"RTN","PSOP",33,0)
 I $D(^PSDRUG(+$P(RX0,"^",6),0)) S DRX=$P(^(0),"^")
"RTN","PSOP",34,0)
 I $Y+10>IOSL,IOSL["C-" D DIR^PSOP1 W @IOF Q:$D(PQT)
"RTN","PSOP",35,0)
 I $Y+10>IOSL,$E(IOST)'="C" S PAGE=PAGE+1 D
"RTN","PSOP",36,0)
 .W @IOF,!,$P(^DPT(DFN,0),"^"),?70,"Page: "_PAGE
"RTN","PSOP",37,0)
 .W !?(80-$L("Medication Profile Sorted by "_HDR))/2,"Medication Profile Sorted by "_HDR W:$G(FR)]"" !?(80-$L(FR_" to "_TO))/2,FR_" to "_TO
"RTN","PSOP",38,0)
 .W !,PSOPLINE
"RTN","PSOP",39,0)
 W !!,"Rx #: "_CP_$P(RX0,"^"),$$ECME^PSOBPSUT(J),$$TITRX^PSOUTL(J),?32,"Drug: ",$G(DRX)
"RTN","PSOP",40,0)
 S PSOBRSIG=$P($G(^PSRX(J,"SIG")),"^",2) K FSIG,BSIG D
"RTN","PSOP",41,0)
 .I PSOBRSIG D FSIG^PSOUTLA("R",J,70) Q
"RTN","PSOP",42,0)
 .D EN2^PSOUTLA1(J,70) F IIII=0:0 S IIII=$O(BSIG(IIII)) Q:'IIII  S FSIG(IIII)=BSIG(IIII)
"RTN","PSOP",43,0)
 K PSOBRSIG,IIII,BSIG
"RTN","PSOP",44,0)
 W !?2,"SIG: "_$G(FSIG(1)) D:$O(FSIG(1))
"RTN","PSOP",45,0)
 .F IIII=1:0 S IIII=$O(FSIG(IIII)) Q:'IIII!($G(PQT))  W !?7,$G(FSIG(IIII))  D:($Y+5>IOSL)&($E(IOST)["C") DIR^PSOP1 Q:$G(PQT)  D:$Y+5>IOSL
"RTN","PSOP",46,0)
 ..S PAGE=PAGE+1
"RTN","PSOP",47,0)
 ..W @IOF,!,$P(^DPT(DFN,0),"^"),?70,"Page: "_PAGE
"RTN","PSOP",48,0)
 ..W !?(80-$L("Medication Profile Sorted by "_HDR))/2,"Medication Profile Sorted by "_HDR W:$G(FR)]"" !?(80-$L(FR_" to "_TO))/2,FR_" to "_TO
"RTN","PSOP",49,0)
 ..W !,PSOPLINE
"RTN","PSOP",50,0)
 Q:$G(PQT)
"RTN","PSOP",51,0)
 W !?2,"QTY: ",$P(RX0,"^",7),?23,"# of Refills: ",$P(RX0,"^",9),?45,"Issue/Expr: " S Y=$P(RX0,"^",13) W $E(Y,4,5),"-",$E(Y,6,7),"-",$E(Y,2,3),"/" S Y=$P(RX2,"^",6) W:Y $E(Y,4,5),"-",$E(Y,6,7),"-",$E(Y,2,3)
"RTN","PSOP",52,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="M",X="`"_+$P(RX0,"^",4) D ^DIC S PHYS=$S(+Y:$P(Y,"^",2),1:"Unknown") K DIC,X,Y
"RTN","PSOP",53,0)
 W !?2,"Prov: "_PHYS,?30,"Entry By: "_$P(RX0,"^",16),?45,"Filled: " S Y=$P(RX2,"^",2) W:Y $E(Y,4,5),"-",$E(Y,6,7),"-",$E(Y,2,3) W " (",$P(RX0,"^",11),")"
"RTN","PSOP",54,0)
 I $P(RX3,"^",3) D
"RTN","PSOP",55,0)
 .K DIC,X,Y S DIC="^VA(200,",DIC(0)="M",X="`"_+$P(RX3,"^",3) D ^DIC S PHYS=$S(+Y:$P(Y,"^",2),1:"Unknown") K DIC,X,Y W !?2,"Cosigner: "_PHYS K PHYS
"RTN","PSOP",56,0)
 S PSOLR=$S($P(RX2,"^",13):$P(RX2,"^",13),1:"") F PSOX=0:0 S PSOX=$O(^PSRX(J,1,PSOX)) Q:'PSOX  S:$P(^PSRX(J,1,PSOX,0),"^",18) PSOLR=$P(^(0),"^",18)
"RTN","PSOP",57,0)
 W !?2,"Last Released: " W:PSOLR $E(PSOLR,4,5)_"-"_$E(PSOLR,6,7)_"-"_$E(PSOLR,2,3)
"RTN","PSOP",58,0)
 W ?45,$S($P(RX2,"^",15):"Original Fill Returned to Stock",1:"Original Release: "_$S($P(RX2,"^",13):$E($P(RX2,"^",13),4,5)_"-"_$E($P(RX2,"^",13),6,7)_"-"_$E($P(RX2,"^",13),2,3),1:""))
"RTN","PSOP",59,0)
 S CT=0,REF=$P(RX0,"^",9) F K=0:0 S K=$O(^PSRX(J,1,K)) Q:'K  S RX1=^PSRX(J,1,K,0) D
"RTN","PSOP",60,0)
 .I $Y+5>IOSL,IOSL["C-" D DIR^PSOP1 W @IOF Q:$D(PQT)
"RTN","PSOP",61,0)
 .I $Y+5>IOSL,$E(IOST)'="C" S PAGE=PAGE+1 D
"RTN","PSOP",62,0)
 ..W @IOF,!,$P(^DPT(DFN,0),"^"),?70,"Page: "_PAGE
"RTN","PSOP",63,0)
 ..W !?(80-$L("Medication Profile Sorted by "_HDR))/2,"Medication Profile Sorted by "_HDR W:$G(FR)]"" !?(80-$L(FR_" to "_TO))/2,FR_" to "_TO
"RTN","PSOP",64,0)
 ..W !,PSOPLINE
"RTN","PSOP",65,0)
 .W !?2,"Refilled: "_$E($P(RX1,"^"),4,5)_"-"_$E($P(RX1,"^"),6,7)_"-"_$E($P(RX1,"^"),2,3)_" ("_$P(RX1,"^",2)_")"_$S($P(RX1,"^",16):"(R)",1:"")
"RTN","PSOP",66,0)
 .W ?30,"Released: "_$S($P(RX1,"^",18):$E($P(RX1,"^",18),4,5)_"-"_$E($P(RX1,"^",18),6,7)_"-"_$E($P(RX1,"^",18),2,3),1:"")
"RTN","PSOP",67,0)
 .S REF=REF-1
"RTN","PSOP",68,0)
 I $Y+2>IOSL,IOSL["C-" D DIR^PSOP1 W @IOF Q:$D(PQT)
"RTN","PSOP",69,0)
 I $Y+2>IOSL,$E(IOST)'="C" S PAGE=PAGE+1 W @IOF,!,$P(^DPT(DFN,0),"^"),?70,"Page: "_PAGE
"RTN","PSOP",70,0)
 I $O(^PSRX(J,"P",0)) W !?2,"Partials: " F K=0:0 S K=$O(^PSRX(J,"P",K)) Q:'K  W $E(^(K,0),4,5),"-",$E(^(0),6,7),"-",$E(^(0),2,3)," (",$P(^(0),"^",2),") QTY:",$P(^(0),"^",4)_$S($P(^(0),"^",16):" (R)",1:"")_", "
"RTN","PSOP",71,0)
 W:$P(RX3,"^",7)]"" !?2,"Remarks: ",$P(RX3,"^",7) D STAT^PSOFUNC
"RTN","PSOP",72,0)
 S PSDIV=$S($D(^PS(59,+$P(RX2,"^",9),0)):$P(^(0),"^")_" ("_$P(^(0),"^",6)_")",1:"Unknown")
"RTN","PSOP",73,0)
 W !?2,"Division: "_$E(PSDIV,1,25),?40,ST,?60,REF," Refill"_$S(REF'=1:"s",1:"")," Left"
"RTN","PSOP",74,0)
 Q
"RTN","PSOP",75,0)
LOOP F I=0:0 S I=$O(^PS(55,DFN,"P",I)) Q:'I  S J=+^(I,0) D  I $G(PSOPATOK),$D(^PSRX(J,0)),$P($G(^PSRX(J,"STA")),"^")'=13 S PRLBL=PSRT_"^PSOP2" D @PRLBL
"RTN","PSOP",76,0)
 .S PSOPATOK=1 I $P($G(^PSRX(+$G(J),0)),"^",2),DFN'=$P($G(^(0)),"^",2) K ^PS(55,DFN,"P",I,0) S:$P($G(^PS(55,DFN,"P",0)),"^",4) $P(^PS(55,DFN,"P",0),"^",4)=$P($G(^(0)),"^",4)-1 S PSOPATOK=0
"RTN","PSOP",77,0)
 Q
"RTN","PSOP1")
0^8^B26639080^B26371231
"RTN","PSOP1",1,0)
PSOP1 ;BHAM ISC/SAB - prints short medication profile ;02/25/94
"RTN","PSOP1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**15,46,103,132,148,233,326,251,313**;DEC 1997;Build 76
"RTN","PSOP1",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOP1",4,0)
 ;External reference to ^PS(50.605 supported by DBIA 696
"RTN","PSOP1",5,0)
 K RX,DTOUT,DIRUT,DIROUT,DUOUT
"RTN","PSOP1",6,0)
 D HD S DRUG="" F I=0:0 S DRUG=$O(^TMP($J,DRUG)) Q:DRUG=""!($G(PQT))  D  G:$D(DTOUT)!($D(DUOUT))!($D(DIROUT)) Q
"RTN","PSOP1",7,0)
 .F J=0:0 S J=$O(^TMP($J,DRUG,J)) Q:'J!($G(PQT))  S RX0=^(J),RX2=$G(^PSRX(J,2)),$P(RX0,"^",15)=$G(^("STA")),CP=$S(+$G(^PSRX(J,"IB")):"$",1:" ") S:$P(RX2,"^",15)&($P(RX2,"^",2)) RST($P(RX2,"^",2))=1 S:$P(RX0,"^",15)="" $P(RX0,"^",15)=-1 D W
"RTN","PSOP1",8,0)
 D:'$G(PQT) PEND^PSOP2,NVA^PSOP2
"RTN","PSOP1",9,0)
Q D ^%ZISC K ^TMP($J),PQT,PSODTCT,ST,D0,DIC,DIR,DIRUT,DUOUT,G,II,K,RXD,RXF,ZX,DRUG,X,DFN,PHYS,PSRT,CT,AL,I1,PLS,REF
"RTN","PSOP1",10,0)
 K LMI,PI,FN,Y,I,J,RX,DRX,ST,RX0,RX2,DA,PPPSTAT,PPP,EEEE,PPPCNT,PENDREX,PSOPEND,PPDIS,PPOI,PCOUNT,PP,FSIG,ZZZZ
"RTN","PSOP1",11,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOP1",12,0)
 Q
"RTN","PSOP1",13,0)
W I $Y+6>IOSL,$E(IOST)="C" D DIR W @IOF Q:$D(PQT)  D HD
"RTN","PSOP1",14,0)
 N PSOBADR
"RTN","PSOP1",15,0)
 U IO I IO'=IO(0),$Y+6>IOSL W @IOF D HD
"RTN","PSOP1",16,0)
 I $E(IOST)'="C",$Y+6>IOSL W @IOF D HD
"RTN","PSOP1",17,0)
 D STAT^PSOFUNC S STA="A^N^R^H^N^S^^^^^^E^DC^^DP^DE^PH",ST=$P(STA,"^",(ST0+1)) K STA
"RTN","PSOP1",18,0)
 S PSOBADR=$O(^PSRX(J,"L",9999),-1)
"RTN","PSOP1",19,0)
 I PSOBADR'="" S PSOBADR=$G(^PSRX(J,"L",PSOBADR,0)) I PSOBADR["(BAD ADDRESS)" S PSOBADR="B"
"RTN","PSOP1",20,0)
 I PSOBADR'="B" S PSOBADR=""
"RTN","PSOP1",21,0)
 S ST=ST_PSOBADR
"RTN","PSOP1",22,0)
 W !,CP_$P(RX0,"^"),$$ECME^PSOBPSUT(J),$$TITRX^PSOUTL(J),?14,$S($D(^PSDRUG(+$P(RX0,"^",6),0)):$E($P(^(0),"^"),1,39),1:"NOT ON FILE"),?54,$S($L(ST)=1:" "_ST,1:ST)
"RTN","PSOP1",23,0)
 S RXD=$P($G(^PSRX(J,3)),"^"),RXF=$P(RX0,"^",9) F II=0:0 S II=$O(^PSRX(J,1,II)) Q:'II  S RXF=RXF-1 S:$P(^PSRX(J,1,II,0),"^",16) RST($P(^(0),"^"))=1
"RTN","PSOP1",24,0)
 W ?58,$S($L(RXF)=1:" "_RXF,1:RXF)
"RTN","PSOP1",25,0)
 W ?61,$E($P(RX0,"^",13),4,5)_"-"_$E($P(RX0,"^",13),6,7)_"-"_$E($P(RX0,"^",13),2,3) W:RXD ?70,$E(RXD,4,5)_"-"_$E(RXD,6,7)_"-"_$E(RXD,2,3)_$S($G(RST(RXD)):"R",1:"")
"RTN","PSOP1",26,0)
 S PSOPRSIG=$P($G(^PSRX(J,"SIG")),"^",2) K FSIG,BSIG D
"RTN","PSOP1",27,0)
 .I PSOPRSIG D FSIG^PSOUTLA("R",J,50) Q
"RTN","PSOP1",28,0)
 .D EN2^PSOUTLA1(J,50) F GGGG=0:0 S GGGG=$O(BSIG(GGGG)) Q:'GGGG  S FSIG(GGGG)=BSIG(GGGG)
"RTN","PSOP1",29,0)
 K PSOPRSIG,GGGG,BSIG
"RTN","PSOP1",30,0)
 W !?5,"QTY: ",$P(RX0,"^",7),?24,"SIG: ",$G(FSIG(1)) D:$O(FSIG(1))
"RTN","PSOP1",31,0)
 .F GGGG=1:0 S GGGG=$O(FSIG(GGGG)) Q:'GGGG!($G(PQT))  W !,?29,$G(FSIG(GGGG)) D:$Y+5>IOSL&($E(IOST)="C") DIR Q:$G(PQT)  I '$G(PQT),($Y+5>IOSL) W @IOF D HD
"RTN","PSOP1",32,0)
 K GGGG,FSIG Q:$G(PQT)
"RTN","PSOP1",33,0)
 ;D SIG
"RTN","PSOP1",34,0)
 K RST Q
"RTN","PSOP1",35,0)
HD D:PAGE>1
"RTN","PSOP1",36,0)
 .W !,"Patient: "_$P(^DPT(DFN,0),"^")_" ("_$E($P(^DPT(DFN,0),"^",9),6,9)_")",?70,"Page: "_PAGE
"RTN","PSOP1",37,0)
 .W !?(80-$L("Medication Profile Sorted by "_HDR))/2,"Medication Profile Sorted by "_HDR W:$G(FR)]"" !?(80-$L(FR_" to "_TO))/2,FR_" to "_TO
"RTN","PSOP1",38,0)
 W !?57,"REF",!?1,"Rx#",?14,"Drug",?54,"ST",?57,"REM",?62,"Issued",?70,"Last Fill",!,PSOPLINE S PAGE=PAGE+1
"RTN","PSOP1",39,0)
 Q
"RTN","PSOP1",40,0)
SORT K DIR,DUOUT,DTOUT
"RTN","PSOP1",41,0)
 S DIR("B")="All",DIR("A",1)=" ",DIR("A")="All Medications or Selection (A/S): ",DIR(0)="SAM^A:All;S:Select Range",DIR("?",1)="Enter 'A' to Print Entire Medication Profile",DIR("?")="   or 'S' for Selection Range" D ^DIR
"RTN","PSOP1",42,0)
 K DIR Q:$D(DIRUT)!(Y="A")!(Y="E")  D @PSRT
"RTN","PSOP1",43,0)
 Q
"RTN","PSOP1",44,0)
DATE ;asks date range
"RTN","PSOP1",45,0)
 W ! K %DT S %DT="AEX",%DT("A")="Starting Date: " D ^%DT  I "^"[X S DUOUT=1 Q
"RTN","PSOP1",46,0)
 G:Y<0 DATE S SDT=+Y,%DT(0)=SDT,FR=$E(SDT,4,5)_"/"_$E(SDT,6,7)_"/"_$E(SDT,2,3)
"RTN","PSOP1",47,0)
EDT S %DT("A")="Ending Date: " D ^%DT  I "^"[X S DUOUT=1 Q
"RTN","PSOP1",48,0)
 G:Y<0 EDT S EDT=+Y,DTS=1,TO=$E(EDT,4,5)_"/"_$E(EDT,6,7)_"/"_$E(EDT,2,3)
"RTN","PSOP1",49,0)
 K %DT Q
"RTN","PSOP1",50,0)
DRUG ;asks drug list
"RTN","PSOP1",51,0)
 W ! S DIC("A")="Start with Drug: ",DIC(0)="AEMQ",DIC=50
"RTN","PSOP1",52,0)
 S DIC("S")="I $S('$D(^PSDRUG(Y,""I"")):1,'^(""I""):1,DT'>^(""I""):1,1:0),$S('$D(^PSDRUG(Y,2)):1,$P(^(2),""^"",3)'[""O"":0,1:1)"
"RTN","PSOP1",53,0)
 D ^DIC I "^"[X S DUOUT=1 K DIC Q
"RTN","PSOP1",54,0)
 G:Y<0 DRUG S FR=$P(Y,"^",2)
"RTN","PSOP1",55,0)
 F %=$L($E(FR,1,30)):-1:1 S M=$A(FR,%) I M>32 S Y1=$E(FR,1,%-1)_$C(M-1)_$C(122) Q
"RTN","PSOP1",56,0)
 S PSFR=Y1 K Y1,Y,X
"RTN","PSOP1",57,0)
TO S DIC("A")="To Drug: " D ^DIC I "^"[X S DUOUT=1 K DIC Q
"RTN","PSOP1",58,0)
 G:Y<0 TO I FR]$P(Y,"^",2) W !,$C(7),"Less Than 'Start' Value" K X,Y G TO
"RTN","PSOP1",59,0)
 S TO=$P(Y,"^",2),DRS=1
"RTN","PSOP1",60,0)
 F %=$L($E(TO,1,30)):-1:1 S M=$A(TO,%) I M>32 S Y1=$E(TO,1,%-1)_$C(M+1)_$C(122) Q
"RTN","PSOP1",61,0)
 S PSTO=Y1 K Y1,Y,X,DIC
"RTN","PSOP1",62,0)
 Q
"RTN","PSOP1",63,0)
CLSS ;asks drug class list
"RTN","PSOP1",64,0)
 W ! S DIC("A")="Start with Drug Class: ",DIC(0)="AEQ",DIC=50.605 D ^DIC I "^"[X S DUOUT=1 Q
"RTN","PSOP1",65,0)
 G:Y<0 CLSS S FR=$P(Y,"^",2)
"RTN","PSOP1",66,0)
 F %=$L($E(FR,1,30)):-1:1 S M=$A(FR,%) I M>32 S Y1=$E(FR,1,%-1)_$C(M-1)_$C(122) Q
"RTN","PSOP1",67,0)
 S PSFR=Y1 K Y1,Y,X
"RTN","PSOP1",68,0)
TO1 S DIC("A")="To Drug Class: " D ^DIC I "^"[X S DUOUT=1 Q
"RTN","PSOP1",69,0)
 G:Y<0 TO1 I FR]$P(Y,"^",2) W !,$C(7),"Less Than 'Start' Value" K X,Y G TO1
"RTN","PSOP1",70,0)
 S TO=$P(Y,"^",2)
"RTN","PSOP1",71,0)
 F %=$L($E(TO,1,30)):-1:1 S M=$A(TO,%) I M>32 S Y1=$E(TO,1,%-1)_$C(M+1)_$C(122) Q
"RTN","PSOP1",72,0)
 S PSTO=Y1,CLS=1 K Y,Y1,X
"RTN","PSOP1",73,0)
 Q
"RTN","PSOP1",74,0)
DIR K PQT,DTOUT,DUOUT,DIR,DIRUT S DIR(0)="E" D ^DIR S:$D(DUOUT)!($D(DTOUT)) PQT=1 Q
"RTN","PSOP1",75,0)
SIG I '$P(^PSRX(J,"SIG"),"^",2) D  Q
"RTN","PSOP1",76,0)
 .S X=$P(^PSRX(J,"SIG"),"^") D SIGONE^PSOHELP S SIG=$E($G(INS1),2,250)
"RTN","PSOP1",77,0)
 .F SG=1:1:$L(SIG) W:($X+$L($P(SIG," ",SG)_" "))>$S(IOST["C-":IOM,1:70) !?6 W:$P(SIG," ",SG)]"" $P(SIG," ",SG)_" "
"RTN","PSOP1",78,0)
 S MIG=$P(^PSRX(J,"SIG"),"^"),SIGOK=1 D
"RTN","PSOP1",79,0)
 .F SG=1:1:$L(MIG) Q:$P(MIG," ",SG)=""  W:($X+$L($P(MIG," ",SG)_" "))>$S(IOST["C-":IOM,1:70) !?6 W $P(MIG," ",SG)_" "
"RTN","PSOP1",80,0)
 F I=0:0 S I=$O(^PSRX(RXN,"SIG1",I)) Q:'I  S MIG=$P(^PSRX(RXN,"SIG1",I,0),"^") D
"RTN","PSOP1",81,0)
 .F SG=1:1:$L(MIG) Q:$P(MIG," ",SG)=""  W:($X+$L($P(MIG," ",SG)_" "))>$S(IOST["C-":IOM,1:70) !?6 W $P(MIG," ",SG)_" "
"RTN","PSOP1",82,0)
 Q
"RTN","PSOPMP0")
0^18^B82071360^B81752801
"RTN","PSOPMP0",1,0)
PSOPMP0 ;BIRM/MFR - Patient Medication Profile - Listmanager ;10/28/06
"RTN","PSOPMP0",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**260,281,303,289,382,313**;DEC 1997;Build 76
"RTN","PSOPMP0",3,0)
 ;Reference to EN1^GMRADPT supported by IA #10099
"RTN","PSOPMP0",4,0)
 ;Reference to EN6^GMRVUTL supported by IA #1120
"RTN","PSOPMP0",5,0)
 ;Reference to ^PS(55 supported by DBIA 2228
"RTN","PSOPMP0",6,0)
 ;
"RTN","PSOPMP0",7,0)
EN ;Menu option entry point
"RTN","PSOPMP0",8,0)
 N PSOEXPDC,PSOEXDCE,PSOSRTBY,PSORDER,PSOSIGDP,PSOSTSGP,PSOSTORD,PSORDCNT,PSOSTSEQ,PSORDSEQ,PSOCHNG
"RTN","PSOPMP0",9,0)
 N GRPLN,DIC,Y,DFN,GRPLN,HIGHLN,LASTLINE,VALMCNT
"RTN","PSOPMP0",10,0)
 ;
"RTN","PSOPMP0",11,0)
 ;Division selection
"RTN","PSOPMP0",12,0)
 I '$G(PSOSITE) D ^PSOLSET I '$D(PSOPAR) W $C(7),!!,"Pharmacy Division Must be Selected!",! G EXIT
"RTN","PSOPMP0",13,0)
 ;
"RTN","PSOPMP0",14,0)
 ;Patient selection
"RTN","PSOPMP0",15,0)
 W !! S DIC=2,DIC(0)="QEAM" D ^DIC G EXIT:Y<0  S DFN=+Y
"RTN","PSOPMP0",16,0)
 S PSODFN=DFN D CHKADDR^PSOBAI(DFN,1,1)  ;bad address flag/update
"RTN","PSOPMP0",17,0)
 D LST(PSOSITE,DFN)
"RTN","PSOPMP0",18,0)
 Q
"RTN","PSOPMP0",19,0)
 ;
"RTN","PSOPMP0",20,0)
LST(SITE,PSODFN) ;ListManager entry point
"RTN","PSOPMP0",21,0)
 ; Loading Division/User preferences
"RTN","PSOPMP0",22,0)
 D LOAD^PSOPMPPF(SITE,DUZ)
"RTN","PSOPMP0",23,0)
 W !,"Please wait..."
"RTN","PSOPMP0",24,0)
 D EN^VALM("PSO PMP MAIN")
"RTN","PSOPMP0",25,0)
 D FULL^VALM1
"RTN","PSOPMP0",26,0)
 G EXIT
"RTN","PSOPMP0",27,0)
 ;
"RTN","PSOPMP0",28,0)
HDR      ;Header
"RTN","PSOPMP0",29,0)
 N LINE,POS,LINE1,LINE2,LINE3,LINE4,WT,WTDT,HT,HTDT,VADM,DFN,PNAME,DOB,SEX,X,GMRAL,ADVREA
"RTN","PSOPMP0",30,0)
 K VADM S DFN=PSODFN D DEM^VADPT
"RTN","PSOPMP0",31,0)
 S PNAME=VADM(1)
"RTN","PSOPMP0",32,0)
 S DOB=$S(+VADM(3):$P(VADM(3),"^",2)_" ("_$G(VADM(4))_")",1:"UNKNOWN")
"RTN","PSOPMP0",33,0)
 S SEX=$P(VADM(5),"^",2)
"RTN","PSOPMP0",34,0)
 S (WT,X)="",GMRVSTR="WT" D EN6^GMRVUTL I X'="" S WT=$J($P(X,"^",8)/2.2,6,2),WTDT=$$DAT^PSOPMP1($P(X,"^")\1,"/",1)
"RTN","PSOPMP0",35,0)
 S (HT,X)="",GMRVSTR="HT" D EN6^GMRVUTL I X'="" S HT=$J($P(X,"^",8)*2.54,6,2),HTDT=$$DAT^PSOPMP1($P(X,"^")\1,"/",1)
"RTN","PSOPMP0",36,0)
 S LINE1=PNAME
"RTN","PSOPMP0",37,0)
 S LINE1=$$ALLERGY^PSOPMP1(LINE1,DFN)
"RTN","PSOPMP0",38,0)
 S LINE2="  PID: "_$P(VADM(2),"^",2),$E(LINE2,50)="HEIGHT(cm): "_$S(HT'="":HT_" ("_HTDT_")",1:"NOT AVAILABLE")
"RTN","PSOPMP0",39,0)
 S LINE3="  DOB: "_DOB,$E(LINE3,50)="WEIGHT(kg): "_$S(WT'="":WT_" ("_WTDT_")",1:"NOT AVAILABLE")
"RTN","PSOPMP0",40,0)
 S LINE4="  SEX: "_SEX,$E(LINE4,43)="EXP/CANCEL CUTOFF: "_PSOEXDCE_" DAYS"
"RTN","PSOPMP0",41,0)
 ;
"RTN","PSOPMP0",42,0)
 K VALMHDR S VALMHDR(1)=LINE1,VALMHDR(2)=LINE2,VALMHDR(3)=LINE3,VALMHDR(4)=LINE4
"RTN","PSOPMP0",43,0)
 D SETHDR^PSOPMP1()
"RTN","PSOPMP0",44,0)
 Q
"RTN","PSOPMP0",45,0)
 ;
"RTN","PSOPMP0",46,0)
INIT ;Populates the Body section for ListMan
"RTN","PSOPMP0",47,0)
 K ^TMP("PSOPMP0",$J),^TMP("PSOPMPSR",$J)
"RTN","PSOPMP0",48,0)
 D SETSORT(PSOSRTBY),SETLINE
"RTN","PSOPMP0",49,0)
 S VALMSG="Select the entry # to view or ?? for more actions"
"RTN","PSOPMP0",50,0)
 Q
"RTN","PSOPMP0",51,0)
 ;
"RTN","PSOPMP0",52,0)
SETLINE ;Sets the line to be displayed in ListMan
"RTN","PSOPMP0",53,0)
 N TYPE,STS,SUB,SEQ,LINE,Z,TOTAL,I,X,X1,ORDCNT,LBL,LN,IENSUB,GROUP,GRP,QTYL
"RTN","PSOPMP0",54,0)
 I '$D(^TMP("PSOPMPSR",$J)) D  Q
"RTN","PSOPMP0",55,0)
 . F I=1:1:6 S ^TMP("PSOPMP0",$J,I,0)=""
"RTN","PSOPMP0",56,0)
 . S ^TMP("PSOPMP0",$J,7,0)="                    No prescriptions found for this patient."
"RTN","PSOPMP0",57,0)
 . S VALMCNT=1
"RTN","PSOPMP0",58,0)
 ;
"RTN","PSOPMP0",59,0)
 ;Resetting list to NORMAL video attributes
"RTN","PSOPMP0",60,0)
 F I=1:1:$G(LASTLINE) D RESTORE^VALM10(I)
"RTN","PSOPMP0",61,0)
 K GRPLN,HIGHLN
"RTN","PSOPMP0",62,0)
 ;Building the list (line by line)
"RTN","PSOPMP0",63,0)
 S (GROUP,STS,SUB)="",LINE=0 K ^TMP("PSOPMP0",$J)
"RTN","PSOPMP0",64,0)
 F  S GROUP=$O(^TMP("PSOPMPSR",$J,GROUP)) Q:GROUP=""  D
"RTN","PSOPMP0",65,0)
 . S GRP=$P(GROUP,"^")
"RTN","PSOPMP0",66,0)
 . I GRP'["R"!('PSOSTSGP&($O(^TMP("PSOPMPSR",$J,GROUP),-1)'="")) D
"RTN","PSOPMP0",67,0)
 . . D GROUP^PSOPMP1($P(GROUP,"^",2),+$G(^TMP("PSOPMPSR",$J,GROUP)),.LINE)
"RTN","PSOPMP0",68,0)
 . F  S STS=$O(^TMP("PSOPMPSR",$J,GROUP,STS)) Q:STS=""  D
"RTN","PSOPMP0",69,0)
 . . I STS'="<NULL>" D
"RTN","PSOPMP0",70,0)
 . . . D GROUP^PSOPMP1($P(STS,"^",2),+$G(^TMP("PSOPMPSR",$J,GROUP,STS)),.LINE)
"RTN","PSOPMP0",71,0)
 . . F  S SUB=$O(^TMP("PSOPMPSR",$J,GROUP,STS,SUB),$S(PSORDER="A":1,1:-1)) Q:SUB=""  D
"RTN","PSOPMP0",72,0)
 . . . S Z=$G(^TMP("PSOPMPSR",$J,GROUP,STS,SUB))
"RTN","PSOPMP0",73,0)
 . . . S X1="",SEQ=$G(SEQ)+1,X1=$J(SEQ,3)
"RTN","PSOPMP0",74,0)
 . . . S QTYL=$L($P(Z,"^",4)) S:QTYL<5 QTYL=5
"RTN","PSOPMP0",75,0)
 . . . I GRP["R"!(GRP["T") S $E(X1,5)=$P(Z,"^",2),$E(X1,19)=$E($P(Z,"^",3),1,(32-QTYL))
"RTN","PSOPMP0",76,0)
 . . . I GRP["P"!(GRP["N") S $E(X1,5)=$P(Z,"^",3)
"RTN","PSOPMP0",77,0)
 . . . I GRP["N" S $E(X1,49)="Date Documented:"
"RTN","PSOPMP0",78,0)
 . . . I GRP'["N" S $E(X1,52-QTYL)=$J($P(Z,"^",4),QTYL),$E(X1,53)=$P(Z,"^",5),$E(X1,57)=$P(Z,"^",6)
"RTN","PSOPMP0",79,0)
 . . . S $E(X1,66)=$P(Z,"^",7)
"RTN","PSOPMP0",80,0)
 . . . S $E(X1,74)=$J($P(Z,"^",8),3),$E(X1,78)=$J($P(Z,"^",9),3)
"RTN","PSOPMP0",81,0)
 . . . S LINE=LINE+1,^TMP("PSOPMP0",$J,LINE,0)=X1,HIGHLN(LINE)=""
"RTN","PSOPMP0",82,0)
 . . . S IENSUB=$S(GRP["R"!(GRP["T"):"RX",GRP["P":"PEN",1:"NVA")
"RTN","PSOPMP0",83,0)
 . . . S ^TMP("PSOPMP0",$J,SEQ,IENSUB)=$P(Z,"^")
"RTN","PSOPMP0",84,0)
 . . . I IENSUB="PEN"&($P($G(^PS(52.41,+$P(Z,"^"),0)),"^",23)=1) S ^TMP("PSOPMP0",$J,LINE,"RV")=1
"RTN","PSOPMP0",85,0)
 . . . I $G(PSOSIGDP) D SETSIG^PSOPMP1($S(GRP["R"!(GRP["T"):"R",GRP["P":"P",1:"N"),+Z,.LINE,PSODFN)
"RTN","PSOPMP0",86,0)
 ;
"RTN","PSOPMP0",87,0)
 ;Saving NORMAL video attributes to be reset later
"RTN","PSOPMP0",88,0)
 I LINE>$G(LASTLINE) D
"RTN","PSOPMP0",89,0)
 . F I=($G(LASTLINE)+1):1:LINE D SAVE^VALM10(I)
"RTN","PSOPMP0",90,0)
 . S LASTLINE=LINE
"RTN","PSOPMP0",91,0)
 D VIDEO^PSOPMP1()
"RTN","PSOPMP0",92,0)
 S VALMCNT=+$G(LINE) D RV^PSOPMP1
"RTN","PSOPMP0",93,0)
 Q
"RTN","PSOPMP0",94,0)
 ;
"RTN","PSOPMP0",95,0)
SETSORT(FIELD) ;Sets the data sorted by the FIELD specified
"RTN","PSOPMP0",96,0)
 N SEQ,RX,RXNUM,DRUG,DRNAME,QTY,STATUS,STS,ISSDT,DOCDAT,LSTFD,REFREM,DAYSUP,SIG,Z,ORD,GRPCNT,GROUP,RFRX,OI,PSOBADR
"RTN","PSOPMP0",97,0)
 K ^TMP("PSOPMPSR",$J)
"RTN","PSOPMP0",98,0)
 ;Loading prescription (file #55)
"RTN","PSOPMP0",99,0)
 S SEQ=0
"RTN","PSOPMP0",100,0)
 F  S SEQ=$O(^PS(55,PSODFN,"P",SEQ)) Q:'SEQ  D
"RTN","PSOPMP0",101,0)
 . S RX=+$G(^PS(55,PSODFN,"P",SEQ,0)) I 'RX!($G(^PSRX(RX,0))="") Q
"RTN","PSOPMP0",102,0)
 . I $$FILTER^PSOPMP1(RX) Q
"RTN","PSOPMP0",103,0)
 . S RXNUM=$$GET1^DIQ(52,RX,.01)
"RTN","PSOPMP0",104,0)
 . S DRUG=$$GET1^DIQ(52,RX,6,"I")
"RTN","PSOPMP0",105,0)
 . S DRNAME=$$GET1^DIQ(50,DRUG,.01)
"RTN","PSOPMP0",106,0)
 . S QTY=$$GET1^DIQ(52,RX,7)
"RTN","PSOPMP0",107,0)
 . S STATUS=$$STSINFO^PSOPMP1(RX)
"RTN","PSOPMP0",108,0)
 . S ISSDT=$$ISSDT^PSOPMP1(RX,"R")
"RTN","PSOPMP0",109,0)
 . S LSTFD=$$LSTFD^PSOPMP1(RX)
"RTN","PSOPMP0",110,0)
 . S REFREM=$$REFREM^PSOPMP1(RX)
"RTN","PSOPMP0",111,0)
 . S DAYSUP=$$GET1^DIQ(52,RX,8)
"RTN","PSOPMP0",112,0)
 . S PSOBADR=$O(^PSRX(RX,"L",9999),-1)
"RTN","PSOPMP0",113,0)
 . I PSOBADR'="" S PSOBADR=$G(^PSRX(RX,"L",PSOBADR,0)) I PSOBADR["(BAD ADDRESS)" S PSOBADR="B"
"RTN","PSOPMP0",114,0)
 . I PSOBADR'="B" S PSOBADR=""
"RTN","PSOPMP0",115,0)
 . S Z="",$P(Z,"^")=RX,$P(Z,"^",2)=RXNUM_$$COPAY^PSOPMP1(RX)_$$ECME^PSOBPSUT(RX)_$$TITRX^PSOUTL(RX),$P(Z,"^",3)=$E(DRNAME,1,30)
"RTN","PSOPMP0",116,0)
 . S $P(Z,"^",4)=QTY,$P(Z,"^",5)=$P(STATUS,"^",3)_$$CMOP^PSOPMP1(DRUG,RX)_PSOBADR,$P(Z,"^",6)=$P(ISSDT,"^",2)
"RTN","PSOPMP0",117,0)
 . S $P(Z,"^",7)=$P(LSTFD,"^",2),$P(Z,"^",8)=REFREM,$P(Z,"^",9)=DAYSUP
"RTN","PSOPMP0",118,0)
 . S SORT=$S(FIELD="RX":RXNUM_" ",FIELD="DR":DRNAME_RXNUM,FIELD="ID":+ISSDT_RXNUM_" ",FIELD="LF":+LSTFD_RXNUM_" ")
"RTN","PSOPMP0",119,0)
 . S STS="<NULL>" I $G(PSOSTSGP) S STS=$P(STATUS,"^")_"^"_$P(STATUS,"^",2)
"RTN","PSOPMP0",120,0)
 . S GROUP=$P(PSORDSEQ("R"),"^")_"R^"_$P(PSORDSEQ("R"),"^",2)
"RTN","PSOPMP0",121,0)
 . I $$FIND^PSOREJUT(RX,,,"79,88") S GROUP=$P(PSORDSEQ("T"),"^")_"T^"_$P(PSORDSEQ("T"),"^",2),STS="<NULL>"
"RTN","PSOPMP0",122,0)
 . S ^TMP("PSOPMPSR",$J,GROUP,STS,SORT)=Z
"RTN","PSOPMP0",123,0)
 . S GRPCNT(GROUP)=$G(GRPCNT(GROUP))+1,GRPCNT(GROUP,STS)=$G(GRPCNT(GROUP,STS))+1
"RTN","PSOPMP0",124,0)
 ;
"RTN","PSOPMP0",125,0)
 S GROUP=""
"RTN","PSOPMP0",126,0)
 F  S GROUP=$O(GRPCNT(GROUP)) Q:GROUP=""  D
"RTN","PSOPMP0",127,0)
 . S ^TMP("PSOPMPSR",$J,GROUP)=$G(GRPCNT(GROUP))
"RTN","PSOPMP0",128,0)
 . S STS="" F  S STS=$O(GRPCNT(GROUP,STS)) Q:STS=""  D
"RTN","PSOPMP0",129,0)
 . . S ^TMP("PSOPMPSR",$J,GROUP,STS)=GRPCNT(GROUP,STS)
"RTN","PSOPMP0",130,0)
 ;
"RTN","PSOPMP0",131,0)
 ;Loading pending orders (file #52.41)
"RTN","PSOPMP0",132,0)
 S ORD=0,GROUP=$P(PSORDSEQ("P"),"^")_"P^"_$P(PSORDSEQ("P"),"^",2)
"RTN","PSOPMP0",133,0)
 F  S ORD=$O(^PS(52.41,"P",PSODFN,ORD)) Q:'ORD  D
"RTN","PSOPMP0",134,0)
 . S TYPE=$$GET1^DIQ(52.41,ORD,2,"I")
"RTN","PSOPMP0",135,0)
 . I TYPE="DC"!(TYPE="DE")!(TYPE="HD") Q
"RTN","PSOPMP0",136,0)
 . S DRNAME="",DRUG=+$$GET1^DIQ(52.41,ORD,11,"I") I DRUG S DRNAME=$$GET1^DIQ(50,DRUG,.01)
"RTN","PSOPMP0",137,0)
 . I DRNAME="" D  Q:DRNAME=""
"RTN","PSOPMP0",138,0)
 . . S OI=$$GET1^DIQ(52.41,ORD,8,"I") I 'OI Q
"RTN","PSOPMP0",139,0)
 . . S DRNAME=$$GET1^DIQ(50.7,OI,.01)_" "_$$GET1^DIQ(50.7,OI,.02)
"RTN","PSOPMP0",140,0)
 . S QTY=$$GET1^DIQ(52.41,ORD,12)
"RTN","PSOPMP0",141,0)
 . S STATUS=$$GET1^DIQ(52.41,ORD,2,"I")
"RTN","PSOPMP0",142,0)
 . S ISSDT=$$ISSDT^PSOPMP1(ORD,"P")
"RTN","PSOPMP0",143,0)
 . S REFREM=$$GET1^DIQ(52.41,ORD,13)
"RTN","PSOPMP0",144,0)
 . S DAYSUP=$$GET1^DIQ(52.41,ORD,101)
"RTN","PSOPMP0",145,0)
 . S RFRX="" I STATUS="RF" S RFRX=$$GET1^DIQ(52.41,ORD,21,"I") I RFRX S RFRX=$$GET1^DIQ(52,RFRX,.01)
"RTN","PSOPMP0",146,0)
 . S Z="",$P(Z,"^")=ORD,$P(Z,"^",3)=$E(DRNAME,1,45),$P(Z,"^",4)=QTY,$P(Z,"^",5)=$E(STATUS,1,2)_$$CMOP^PSOPMP1(DRUG)
"RTN","PSOPMP0",147,0)
 . S $P(Z,"^",6)=$S(RFRX'="":"Rx#: "_RFRX,1:$P(ISSDT,"^",2)),$P(Z,"^",8)=REFREM,$P(Z,"^",9)=DAYSUP
"RTN","PSOPMP0",148,0)
 . S SORT=$S(FIELD="RX":DRNAME_ORD,FIELD="DR":DRNAME_ORD,FIELD="ID":+ISSDT_ORD,FIELD="LF":+ISSDT_ORD)
"RTN","PSOPMP0",149,0)
 . S ^TMP("PSOPMPSR",$J,GROUP,"<NULL>",SORT)=Z
"RTN","PSOPMP0",150,0)
 . S GRPCNT(GROUP)=$G(GRPCNT(GROUP))+1
"RTN","PSOPMP0",151,0)
 S:$G(GRPCNT(GROUP)) ^TMP("PSOPMPSR",$J,GROUP)=$G(GRPCNT(GROUP))
"RTN","PSOPMP0",152,0)
 ;
"RTN","PSOPMP0",153,0)
 ;Loading Non-VA Med orders (file #55, sub-file #55.05)
"RTN","PSOPMP0",154,0)
 S ORD=0,GROUP=$P(PSORDSEQ("N"),"^")_"N^"_$P(PSORDSEQ("N"),"^",2)
"RTN","PSOPMP0",155,0)
 F  S ORD=$O(^PS(55,PSODFN,"NVA",ORD)) Q:'ORD  D
"RTN","PSOPMP0",156,0)
 . I $$GET1^DIQ(55.05,ORD_","_PSODFN,5,"I") Q
"RTN","PSOPMP0",157,0)
 . S DRNAME=$$GET1^DIQ(55.05,ORD_","_PSODFN,1)
"RTN","PSOPMP0",158,0)
 . I DRNAME="" D  Q:DRNAME=""
"RTN","PSOPMP0",159,0)
 . . S OI=$$GET1^DIQ(55.05,ORD_","_PSODFN,.01,"I") I 'OI Q
"RTN","PSOPMP0",160,0)
 . . S DRNAME=$$GET1^DIQ(50.7,OI,.01)_" "_$$GET1^DIQ(50.7,OI,.02)
"RTN","PSOPMP0",161,0)
 . S DOCDAT=$P($$GET1^DIQ(55.05,ORD_","_PSODFN_",",11,"I"),".")
"RTN","PSOPMP0",162,0)
 . S Z="",$P(Z,"^")=ORD,$P(Z,"^",3)=$E(DRNAME,1,38),$P(Z,"^",7)=$$DAT^PSOPMP1(DOCDAT,"-")
"RTN","PSOPMP0",163,0)
 . S SORT=$S(FIELD="RX":DRNAME_ORD,FIELD="DR":DRNAME_ORD,FIELD="ID":DOCDAT_ORD,FIELD="LF":DOCDAT_ORD)
"RTN","PSOPMP0",164,0)
 . S ^TMP("PSOPMPSR",$J,GROUP,"<NULL>",SORT)=Z
"RTN","PSOPMP0",165,0)
 . S GRPCNT(GROUP)=$G(GRPCNT(GROUP))+1
"RTN","PSOPMP0",166,0)
 ;
"RTN","PSOPMP0",167,0)
 S:$G(GRPCNT(GROUP)) ^TMP("PSOPMPSR",$J,GROUP)=$G(GRPCNT(GROUP))
"RTN","PSOPMP0",168,0)
 Q
"RTN","PSOPMP0",169,0)
 ;
"RTN","PSOPMP0",170,0)
RX ;Sort by Rx
"RTN","PSOPMP0",171,0)
 D SORT("RX")
"RTN","PSOPMP0",172,0)
 Q
"RTN","PSOPMP0",173,0)
DR ;Sort by Drug
"RTN","PSOPMP0",174,0)
 D SORT("DR")
"RTN","PSOPMP0",175,0)
 Q
"RTN","PSOPMP0",176,0)
ID ;Sort by Issue Date
"RTN","PSOPMP0",177,0)
 D SORT("ID")
"RTN","PSOPMP0",178,0)
 Q
"RTN","PSOPMP0",179,0)
LF ;Sort by Last Fill Date
"RTN","PSOPMP0",180,0)
 D SORT("LF")
"RTN","PSOPMP0",181,0)
 Q
"RTN","PSOPMP0",182,0)
 ;
"RTN","PSOPMP0",183,0)
SORT(FIELD) ;Sort entries by FIELD
"RTN","PSOPMP0",184,0)
 I PSOSRTBY=FIELD S PSORDER=$S(PSORDER="A":"D",1:"A")
"RTN","PSOPMP0",185,0)
 E  S PSOSRTBY=FIELD,PSORDER="A"
"RTN","PSOPMP0",186,0)
 D REF
"RTN","PSOPMP0",187,0)
 Q
"RTN","PSOPMP0",188,0)
 ;
"RTN","PSOPMP0",189,0)
REF ;Screen Refresh
"RTN","PSOPMP0",190,0)
 W ?52,"Please wait..." D INIT,HDR S VALMBCK="R"
"RTN","PSOPMP0",191,0)
 Q
"RTN","PSOPMP0",192,0)
GS ;Group by Status
"RTN","PSOPMP0",193,0)
 W ?52,"Please wait..." S PSOSTSGP=$S($G(PSOSTSGP):0,1:1) D INIT,HDR S VALMBCK="R"
"RTN","PSOPMP0",194,0)
 Q
"RTN","PSOPMP0",195,0)
SIG ;Display SIG
"RTN","PSOPMP0",196,0)
 W ?52,"Please wait..." S PSOSIGDP=$S($G(PSOSIGDP):0,1:1) D INIT,HDR S VALMBCK="R"
"RTN","PSOPMP0",197,0)
 I 'PSOSIGDP S VALMBG=VALMBG\2
"RTN","PSOPMP0",198,0)
 I PSOSIGDP S VALMBG=VALMBG*2-1
"RTN","PSOPMP0",199,0)
 S:VALMBG>(VALMCNT-10) VALMBG=VALMCNT-10 S:VALMBG<1 VALMBG=1
"RTN","PSOPMP0",200,0)
 Q
"RTN","PSOPMP0",201,0)
PI ;Patient Information
"RTN","PSOPMP0",202,0)
 D EN^PSOLMPI S VALMBCK="R"
"RTN","PSOPMP0",203,0)
 Q
"RTN","PSOPMP0",204,0)
CV ;Change View
"RTN","PSOPMP0",205,0)
 D LST^PSOPMPPF(SITE,DUZ) W !?52,"Please wait..." D INIT,HDR
"RTN","PSOPMP0",206,0)
 S VALMBG=1,VALMBCK="R"
"RTN","PSOPMP0",207,0)
 Q
"RTN","PSOPMP0",208,0)
 ;
"RTN","PSOPMP0",209,0)
SEL ;Process selection of one entry
"RTN","PSOPMP0",210,0)
 N PSOSEL,TYPE,XQORM,ORD,TITLE,PSOLIS,XX
"RTN","PSOPMP0",211,0)
 S PSOLIS=$P(XQORNOD(0),"=",2) I 'PSOLIS S VALMSG="Invalid selection!",VALMBCK="R" Q
"RTN","PSOPMP0",212,0)
 F XX=1:1:$L(PSOLIS,",") Q:$P(PSOLIS,",",XX)']""  D
"RTN","PSOPMP0",213,0)
 .S PSOSEL=+$P(PSOLIS,",",XX) I 'PSOSEL S VALMSG="Invalid selection!",VALMBCK="R" Q
"RTN","PSOPMP0",214,0)
 .S TYPE=$O(^TMP("PSOPMP0",$J,PSOSEL,0)) I TYPE="" S VALMSG="Invalid selection!",VALMBCK="R" Q
"RTN","PSOPMP0",215,0)
 .S ORD=$G(^TMP("PSOPMP0",$J,PSOSEL,TYPE))
"RTN","PSOPMP0",216,0)
 .I 'ORD S VALMSG="Invalid selection!",VALMBCK="R" Q
"RTN","PSOPMP0",217,0)
 .S TITLE=VALM("TITLE")
"RTN","PSOPMP0",218,0)
 .;
"RTN","PSOPMP0",219,0)
 .;Regular prescription
"RTN","PSOPMP0",220,0)
 .I TYPE="RX" D  S VALMBCK="R" D REF
"RTN","PSOPMP0",221,0)
 .. N PSOVDA,PSOSAVE,DA,PS
"RTN","PSOPMP0",222,0)
 .. S (PSOVDA,DA)=ORD,PS="REJECTMP"
"RTN","PSOPMP0",223,0)
 .. N LINE,TITLE,PSODFN D DP^PSORXVW
"RTN","PSOPMP0",224,0)
 .;
"RTN","PSOPMP0",225,0)
 .;Pending Order
"RTN","PSOPMP0",226,0)
 .I TYPE="PEN" D  S VALMBCK="R" D REF
"RTN","PSOPMP0",227,0)
 .. N PSOACTOV,OR0
"RTN","PSOPMP0",228,0)
 .. S OR0=^PS(52.41,ORD,0),PSOACTOV=""
"RTN","PSOPMP0",229,0)
 .. N LINE,TITLE D PENHDR^PSOPMP1(PSODFN),DSPL^PSOORFI1
"RTN","PSOPMP0",230,0)
 .;
"RTN","PSOPMP0",231,0)
 .;Pending Order
"RTN","PSOPMP0",232,0)
 .I TYPE="NVA" D
"RTN","PSOPMP0",233,0)
 .. N LINE,TITLE D EN^PSONVAVW(PSODFN,ORD)
"RTN","PSOPMP0",234,0)
 .;
"RTN","PSOPMP0",235,0)
 S VALMBCK="R",VALM("TITLE")=TITLE
"RTN","PSOPMP0",236,0)
 Q
"RTN","PSOPMP0",237,0)
 ;
"RTN","PSOPMP0",238,0)
EXIT ;
"RTN","PSOPMP0",239,0)
 K ^TMP("PSOPMP0",$J),^TMP("PSOPMPSR",$J)
"RTN","PSOPMP0",240,0)
 Q
"RTN","PSOPMP0",241,0)
 ;
"RTN","PSOPMP0",242,0)
HELP Q
"RTN","PSOREF")
0^62^B71972514^B66253301
"RTN","PSOREF",1,0)
PSOREF ;BIR/SAB-refill data entry ;4/25/07 8:45am
"RTN","PSOREF",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,23,27,36,46,78,130,131,148,206,313**;DEC 1997;Build 76
"RTN","PSOREF",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOREF",4,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOREF",5,0)
 ;
"RTN","PSOREF",6,0)
EOJ ;
"RTN","PSOREF",7,0)
 K PSOMSG,PSOREF,PSORX("BAR CODE"),PSOLIST,LFD,MAX,MIN,NODE,PS,PSOERR,REF,RF,RXO,RXN,RXP,RXS,SD,VAERR,PSORX("FILL DATE")
"RTN","PSOREF",8,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOREF",9,0)
 Q
"RTN","PSOREF",10,0)
OERR ;single refil
"RTN","PSOREF",11,0)
 I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2),,.VALMSG,.VALMBCK) Q
"RTN","PSOREF",12,0)
 I $D(RXRP($P(PSOLST(ORN),"^",2))) S VALMBCK="",VALMSG="A Reprint Label has been requested!" W $C(7) Q
"RTN","PSOREF",13,0)
 I $D(RXPR($P(PSOLST(ORN),"^",2))) S VALMBCK="",VALMSG="A Partial has already been requested!" W $C(7) Q
"RTN","PSOREF",14,0)
 I $D(RXRS($P(PSOLST(ORN),"^",2))) S VALMBCK="",VALMSG="Rx is being pulled from suspense!" W $C(7) Q
"RTN","PSOREF",15,0)
 I $D(RXFL($P(PSOLST(ORN),"^",2))) S PTRX=$P(PSOLST(ORN),"^",2) D ^PSOCMOPT I '$G(PSOXFLAG) K PSOXFLAG S VALMBCK="",VALMSG="Fill already requested for CMOP!" Q
"RTN","PSOREF",16,0)
 I $$TITRX^PSOUTL($P(PSOLST(ORN),"^",2))="t" S VALMBCK="",VALMSG="Cannot refill 'Titration Rx'." W $C(7) Q
"RTN","PSOREF",17,0)
 K PSOXFLAG
"RTN","PSOREF",18,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG Q
"RTN","PSOREF",19,0)
 N RXN K PSORX("FILL DATE") D FULL^VALM1 S:$G(PSOFROM)'="NEW" PSOFROM="REFILL" S PSOREF("DFLG")=0,PSOREF("IRXN")=$P(PSOLST(ORN),"^",2),PSOREF("QFLG")=0
"RTN","PSOREF",20,0)
 K PSOID D ^PSOREF1 I PSOREF("DFLG") D EOJ S VALMBCK="R" Q
"RTN","PSOREF",21,0)
 D ^PSOREF0
"RTN","PSOREF",22,0)
 W ! K DIR,DIRUT,DTOUT,DUOUT S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DTOUT,DUOUT S PSORXED=1 D ^PSOBUILD,ACT^PSOORNE2 K PSORXED S VALMBCK="Q" D EOJ
"RTN","PSOREF",23,0)
 Q
"RTN","PSOREF",24,0)
SPEED ;speed refill
"RTN","PSOREF",25,0)
 K LST,PSORX("FILL DATE") N VALMCNT I '$G(PSOCNT) S VALMSG="This patient has no Prescriptions!" S VALMBCK="" Q
"RTN","PSOREF",26,0)
 K DIR,DIRUT S DIR(0)="Y",DIR("B")="NO",DIR("A")="Barcode Refill",DIR("?")="If you want to use a barcode reader to process refills enter 'Y'."
"RTN","PSOREF",27,0)
 D ^DIR K DIR,DUOUT,DTOUT I $D(DIRUT) S VALMBCK="" Q
"RTN","PSOREF",28,0)
 G BCREF:Y
"RTN","PSOREF",29,0)
 K PSOREF,PSOFDR,DIR,DUOUT,DIRUT S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DUOUT S VALMBCK="" Q
"RTN","PSOREF",30,0)
 K DIR,DIRUT,DTOUT,PSOOELSE,DTOUT I +Y S (ASK,SPEED,PSOOELSE)=1 D FULL^VALM1 S LST=Y D  G:$G(PSOREF("DFLG"))!($G(PSOREF("QFLG"))) SPEEDX
"RTN","PSOREF",31,0)
 .F ORD=1:1:$L(LST,",") Q:$P(LST,",",ORD)']""!($G(PSOREF("QFLG")))  S ORN=$P(LST,",",ORD) D:+PSOLST(ORN)=52
"RTN","PSOREF",32,0)
 ..I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2)) W $C(7),!!,"Rx "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_" has OPEN/UNRESOLVED 3rd Party Payer Reject!" K DIR D PAUSE^VALM1 Q
"RTN","PSOREF",33,0)
 ..I $$TITRX^PSOUTL($P(PSOLST(ORN),"^",2))="t" D  Q
"RTN","PSOREF",34,0)
 ...W $C(7),!!,"Rx# "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_" is marked as 'Titration Rx' and cannot be refilled."
"RTN","PSOREF",35,0)
 ...K DIR D PAUSE^VALM1 Q
"RTN","PSOREF",36,0)
 ..D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) W $C(7),!!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^")),! D PAUSE^VALM1 K PSOMSG Q
"RTN","PSOREF",37,0)
 ..K PSOMSG I $D(RXRP($P(PSOLST(ORN),"^",2))) W $C(7),!!,"A Reprint Label has been requested!" D ULK D PAUSE^VALM1 Q
"RTN","PSOREF",38,0)
 ..I $D(RXPR($P(PSOLST(ORN),"^",2))) W $C(7),!!,"A Partial has already been requested!" D ULK D PAUSE^VALM1 Q
"RTN","PSOREF",39,0)
 ..I $D(RXFL($P(PSOLST(ORN),"^",2))) S PTRX=$P(PSOLST(ORN),"^",2) D ^PSOCMOPT I '$G(PSOXFLAG) K PSOXFLAG W $C(7),!!,"A CMOP fill has already been requested for Rx "_$P($G(^PSRX($P(PSOLST(ORN),"^",2),0)),"^") D ULK D PAUSE^VALM1 Q
"RTN","PSOREF",40,0)
 ..K PSOXFLAG I $D(RXRS($P(PSOLST(ORN),"^",2))) W $C(7),!!,"Rx is being pulled from suspense!" D ULK D PAUSE^VALM1 Q
"RTN","PSOREF",41,0)
 ..I $P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=11 D  D ULK Q
"RTN","PSOREF",42,0)
 ...W $C(7),!!?5,"RX "_$P($G(^PSRX($P(PSOLST(ORN),"^",2),0)),"^")_" is in an EXPIRED status." W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSOREF",43,0)
 ..S PSOREF("IRXN")=$P(PSOLST(ORN),"^",2) I ASK D ^PSOREF1 S ASK=0 D:$G(PSOREF("QFLG")) ULK Q:$G(PSOREF("QFLG"))
"RTN","PSOREF",44,0)
 ..N RXN D FULL^VALM1 S:$G(PSOFROM)'="NEW" PSOFROM="REFILL" S PSOREF("DFLG")=0,PSOREF("IRXN")=$P(PSOLST(ORN),"^",2)
"RTN","PSOREF",45,0)
 ..I PSOREF("DFLG") D EOJ S VALMBCK="R" Q
"RTN","PSOREF",46,0)
 ..D ^PSOREF0 D ULK
"RTN","PSOREF",47,0)
 S:'$G(PSOOELSE) VALMBCK=""
"RTN","PSOREF",48,0)
 S PSORXED=1 D ^PSOBUILD,BLD^PSOORUT1
"RTN","PSOREF",49,0)
SPEEDX K PSOREF,PSORX("BAR CODE"),PSOLIST,LFD,MAX,MIN,NODE,PS,PSOERR,REF,RF,RXO,RXN,RXP,RXS,SD,VAERR,PSORX("FILL DATE")
"RTN","PSOREF",50,0)
 K LST,SPEED,PSORXED,PSOREF,PSOFDR,PSOOELSE,ASK S:'$D(VALMBCK) VALMBCK="R"
"RTN","PSOREF",51,0)
 K PSORX("FILL DATE"),PSORX("MAIL/WINDOW"),PSORX("METHOD OF PICK-UP")
"RTN","PSOREF",52,0)
 Q
"RTN","PSOREF",53,0)
BCREF ;barcode refills
"RTN","PSOREF",54,0)
 K LST,DIR,DIRUT,DUOUT,DTOUT D FULL^VALM1
"RTN","PSOREF",55,0)
ASK S DIR(0)="FO^5:245^K:X'?3N1""-""1.N X",DIR("A")="WAND BARCODE"
"RTN","PSOREF",56,0)
 S DIR("?",1)="Wand the barcoded number of the prescription to be processed."
"RTN","PSOREF",57,0)
 S DIR("?",2)="The number should be of the form NNN-NNNNNN",DIR("?",3)="where the number before the dash is your station number."
"RTN","PSOREF",58,0)
 S DIR("?")="Enter ""^"", or a RETURN to quit."
"RTN","PSOREF",59,0)
 D ^DIR I $D(DUOUT)!($D(DTOUT)) S VALMBCK="" G BCREFX
"RTN","PSOREF",60,0)
 I $G(X)']"",'$G(LST) S VALMBCK="" G BCREFX
"RTN","PSOREF",61,0)
 I $D(DIRUT),+$G(LST) D  S VALMBCK="R" G BCREFX
"RTN","PSOREF",62,0)
 .K DIR,DIRUT,DTOUT,PSOOELSE,DTOUT
"RTN","PSOREF",63,0)
 .S (BCREF,ASK,SPEED,PSOOELSE)=1 D FULL^VALM1 D
"RTN","PSOREF",64,0)
 ..F ORD=1:1:$L(LST,",") Q:$P(LST,",",ORD)']""!($G(PSOREF("QFLG")))  S ORN=$P(LST,",",ORD) D:+PSOLST(ORN)=52
"RTN","PSOREF",65,0)
 ...I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2)) W $C(7),!!,"Rx "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_" has OPEN/UNRESOLVED 3rd Party Payer Reject!" K DIR D PAUSE^VALM1 Q
"RTN","PSOREF",66,0)
 ...I $$TITRX^PSOUTL($P(PSOLST(ORN),"^",2))="t" D  Q
"RTN","PSOREF",67,0)
 ....W $C(7),!!,"Rx# "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_" is marked as 'Titration Rx' and cannot be refilled."
"RTN","PSOREF",68,0)
 ....K DIR D PAUSE^VALM1 Q
"RTN","PSOREF",69,0)
 ...D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) W $C(7),!!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^")),! D PAUSE^VALM1 K PSOMSG Q
"RTN","PSOREF",70,0)
 ...K PSOMSG I $D(RXRP($P(PSOLST(ORN),"^",2))) W $C(7),!!,"A Reprint Label has been requested for Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^"),! D ULK D PAUSE^VALM1 Q
"RTN","PSOREF",71,0)
 ...I $D(RXPR($P(PSOLST(ORN),"^",2))) W $C(7),!!,"A Partial has already been requested for Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^"),! D ULK D PAUSE^VALM1 Q
"RTN","PSOREF",72,0)
 ...I $D(RXFL($P(PSOLST(ORN),"^",2))) S PTRX=$P(PSOLST(ORN),"^",2) D ^PSOCMOPT I '$G(PSOXFLAG) K PSOXFLAG W $C(7),!!,"A CMOP fill has already been requested for Rx "_$P($G(^PSRX($P(PSOLST(ORN),"^",2),0)),"^") D ULK D PAUSE^VALM1 Q
"RTN","PSOREF",73,0)
 ...K PSOXFLAG I $D(RXRS($P(PSOLST(ORN),"^",2))) W $C(7),!!,"Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^")_" is being pulled from suspense!" D ULK D PAUSE^VALM1 Q
"RTN","PSOREF",74,0)
 ...S PSOREF("IRXN")=$P(PSOLST(ORN),"^",2) I ASK D ^PSOREF1 S ASK=0 D:$G(PSOREF("DFLG")) ULK Q:$G(PSOREF("DFLG"))
"RTN","PSOREF",75,0)
 ...N RXN D FULL^VALM1 S:$G(PSOFROM)'="NEW" PSOFROM="REFILL" S PSOREF("DFLG")=0,PSOREF("IRXN")=$P(PSOLST(ORN),"^",2)
"RTN","PSOREF",76,0)
 ...I PSOREF("DFLG") D EOJ S VALMBCK="R" Q
"RTN","PSOREF",77,0)
 ...D ^PSOREF0 D ULK
"RTN","PSOREF",78,0)
 F RX=1:1:PSOCNT I $P(PSOLST(RX),"^",2)=$P(X,"-",2) D  Q
"RTN","PSOREF",79,0)
 .I $D(PSOBBC(RX)) Q
"RTN","PSOREF",80,0)
 .S LST=$G(LST)_RX_",",PSOBBC(RX)=1
"RTN","PSOREF",81,0)
 G ASK
"RTN","PSOREF",82,0)
BCREFX K BCREF,ASK,LST,SPEED,RX,PSOBBC,DIR,DIRUT,PSORXED,PSOREF,PSOFDR,PSOOELSE S PSORXED=1 D ^PSOBUILD,BLD^PSOORUT1
"RTN","PSOREF",83,0)
 S VALMBCK="R" Q
"RTN","PSOREF",84,0)
REFILL(PLACER) ;passes flag to CPRS for front door refill request
"RTN","PSOREF",85,0)
 ;PLACER=PHARMACY NUMBER
"RTN","PSOREF",86,0)
 N PSORFRM,PSOLC,PSODRG,PSODRUG0,RXN,ST,PSODEA
"RTN","PSOREF",87,0)
 I $G(PLACER)["S"!('$G(PLACER)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSOREF",88,0)
 S RXN=PLACER I '$D(^PSRX(RXN,0)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSOREF",89,0)
 S RX0=^PSRX(RXN,0),PSODRG=$P(^PSRX(RXN,0),"^",6),ST=+^("STA"),PSODRUG0=^PSDRUG(PSODRG,0),PSODEA=$P($G(^(0)),"^",3),DIV=$P(^PSRX(RXN,2),"^",9),PSORFRM=$P(RX0,"^",9)
"RTN","PSOREF",90,0)
 I PSODEA["2" Q "0^Schedule 2 Drug. Order cannot be refilled."
"RTN","PSOREF",91,0)
 I '$P($G(^PSRX(RXN,"OR1")),"^"),'$P($G(^PSDRUG(PSODRG,2)),"^") Q "0^Cannot Refill. Drug not matched to a Pharmacy Orderable Item."
"RTN","PSOREF",92,0)
 I '$P($G(^PSRX(RXN,"OR1")),"^"),$P($G(^PSDRUG(PSODRG,2)),"^") S $P(^PSRX(RXN,"OR1"),"^")=$P(^PSDRUG(PSODRG,2),"^")
"RTN","PSOREF",93,0)
 S CLOZPAT=$S($P($G(^PSDRUG(PSODRG,"CLOZ1")),"^")="PSOCLO1":1,1:0)
"RTN","PSOREF",94,0)
 I 'CLOZPAT I PSODEA["A"&(PSODEA'["B")!(PSODEA["F")!(PSODEA[1)!(PSODEA[2) Q "0^"_$S(PSODEA["A":"Narcotic Drug. ",1:"")_"Order Non-Refillable."
"RTN","PSOREF",95,0)
 K CLOZPAT I DT>$P($G(^PSRX(RXN,2)),"^",6) Q "0^Non-Refillable.  Prescription has Expired."
"RTN","PSOREF",96,0)
 I $P(^PSRX(RXN,3),"^",2)>$P(^PSRX(RXN,2),"^",6) Q "0^Next Refill Date Past Expiration Date.  New Order Required."
"RTN","PSOREF",97,0)
 I '$P($G(^PS(59,DIV,1)),"^",11),$G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) Q "0^Inactive Drug, Non Refillable."
"RTN","PSOREF",98,0)
 I ST Q "0^Prescription is in a Non-Refillable Status."
"RTN","PSOREF",99,0)
 I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" Q "0^Cannot Refill. Drug No Longer Used by Outpatient Pharmacy."
"RTN","PSOREF",100,0)
 S PSORFRM=$P(RX0,"^",9) F PSOJ=0:0 S PSOJ=$O(^PSRX(RXN,1,PSOJ)) Q:'PSOJ  S PSORFRM=PSORFRM-1
"RTN","PSOREF",101,0)
 I PSORFRM<1 Q "0^No Refills remaining. New Med order required."
"RTN","PSOREF",102,0)
 I $P(^PSRX(RXN,3),"^"),DT=$P(^PSRX(RXN,3),"^") Q "0^Can't Refill, Fill Date already exists for "_$E($P(^PSRX(RXN,3),"^"),4,5)_"/"_$E($P(^PSRX(RXN,3),"^"),6,7)_"/"_$E($P(^PSRX(RXN,3),"^"),2,3)_"."
"RTN","PSOREF",103,0)
 I $P(^PSRX(RXN,3),"^"),DT<$P(^PSRX(RXN,3),"^") Q "0^Can't Refill, later Refill Date already exists for "_$E($P(^PSRX(RXN,3),"^"),4,5)_"/"_$E($P(^PSRX(RXN,3),"^"),6,7)_"/"_$E($P(^PSRX(RXN,3),"^"),2,3)_"."
"RTN","PSOREF",104,0)
 I $O(^PS(52.41,"ARF",RXN,0)) Q "0^Pending Refill Request already exists."
"RTN","PSOREF",105,0)
 Q 1
"RTN","PSOREF",106,0)
 ;
"RTN","PSOREF",107,0)
ULK D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOREF",108,0)
 Q
"RTN","PSORENW")
0^19^B44953613^B38307227
"RTN","PSORENW",1,0)
PSORENW ;BIR/SAB-renew main driver ;4/25/07 8:42am
"RTN","PSORENW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,30,46,71,96,100,130,148,206,388,390,417,313**;DEC 1997;Build 76
"RTN","PSORENW",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSORENW",4,0)
 ;External references L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",5,0)
 ;External reference to LK^ORX2 and ULK^ORX2 supported by DBIA 867
"RTN","PSORENW",6,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORENW",7,0)
 ;External reference to MAIN^TIUEDIT supported by DBIA 2410
"RTN","PSORENW",8,0)
 ;
"RTN","PSORENW",9,0)
ASK ;
"RTN","PSORENW",10,0)
 K PSORENW("FILL DATE") D FILLDT^PSODIR2(.PSORENW) S:$G(PSORENW("DFLG")) VALMSG="Renew Rx request canceled",VALMBCK="R"
"RTN","PSORENW",11,0)
 I PSORENW("DFLG")!('$D(PSORENW("FILL DATE"))) S PSORENW("QFLG")=1,PSORENW("DFLG")=0 G ASKX
"RTN","PSORENW",12,0)
 S PSORNW("FILL DATE")=PSORENW("FILL DATE")
"RTN","PSORENW",13,0)
 D MW^PSOCMOPA(.PSORENW)
"RTN","PSORENW",14,0)
 I PSORENW("DFLG") S PSORENW("QFLG")=1,PSORENW("DFLG")=0 G ASKX
"RTN","PSORENW",15,0)
 S PSORNW("MAIL/WINDOW")=PSORENW("MAIL/WINDOW") S PSORX("MAIL/WINDOW")=$S(PSORENW("MAIL/WINDOW")="M":"MAIL",1:"WINDOW")
"RTN","PSORENW",16,0)
 D NOORE^PSONEW(.PSORENW) S:$G(PSORENW("DFLG")) VALMSG="Renew Rx request canceled",VALMBCK="R"
"RTN","PSORENW",17,0)
 I PSORENW("DFLG")!('$D(PSORENW("FILL DATE"))) S PSORENW("QFLG")=1,PSORENW("DFLG")=0
"RTN","PSORENW",18,0)
ASKX Q
"RTN","PSORENW",19,0)
 ;
"RTN","PSORENW",20,0)
EOJ ;
"RTN","PSORENW",21,0)
 K VERB,RTE,DRET,PSOMSG,PSORNW,PSOLIST,PSORENW,PSORX("BAR CODE"),PSORX("FILL DATE"),PSODIR,PSOID,PSONOOR,PSOCOU,PSOCOUU,PSOID,PSOFDMX,PSODRUG,COPY,PSOBCKDR
"RTN","PSORENW",22,0)
 N ZRXN S ZRXN=$G(RXN)
"RTN","PSORENW",23,0)
 S RXN=$O(^TMP("PSORXN",$J,0)) I RXN S ZRXN=RXN D
"RTN","PSORENW",24,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSORENW",25,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS",$P(RXN1,"^",4))
"RTN","PSORENW",26,0)
 .;saves drug allergy order chks pso*7*390
"RTN","PSORENW",27,0)
 .I +$G(^TMP("PSODAOC",$J,1,0)) D
"RTN","PSORENW",28,0)
 ..I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSORENW",29,0)
 ..S RXN=ZRXN,PSODAOC="Rx Backdoor "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"RENEW Order Acceptance_OP"
"RTN","PSORENW",30,0)
 ..D DAOC^PSONEW
"RTN","PSORENW",31,0)
 K ZRXN,RXN,RXN1,^TMP("PSORXN",$J),^TMP("PSODAOC",$J)
"RTN","PSORENW",32,0)
 I $G(PSONOTE) D MAIN^TIUEDIT(3,.TIUDA,PSODFN,"","","","",1)
"RTN","PSORENW",33,0)
 K PSONOTE
"RTN","PSORENW",34,0)
 Q
"RTN","PSORENW",35,0)
OERR ;entry for renew backdoor
"RTN","PSORENW",36,0)
 I $$TITRX^PSOUTL($P(PSOLST(ORN),"^",2))="t" D  Q
"RTN","PSORENW",37,0)
 . S VALMSG="Cannot Renew a 'Titration Rx'.",VALMBCK="R" W $C(7)
"RTN","PSORENW",38,0)
 I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2),,.VALMSG,.VALMBCK) Q  ; Internally setting VALMSG and VALMBCK
"RTN","PSORENW",39,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSORENW",40,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSORENW",41,0)
 K PSOID,PSOFDMX,PSORX("FILL DATE"),PSORENW("FILL DATE"),PSORX("QS"),PSORENW("QS"),PSOBARCD,COPY
"RTN","PSORENW",42,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG D ULPAT Q
"RTN","PSORENW",43,0)
 S PSOBCKDR=1,PSOFROM="NEW",PSORENW("OIRXN")=$P(PSOLST(ORN),"^",2),PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"),PSORX("DFLG"))=0
"RTN","PSORENW",44,0)
 S PSONEW("DAYS SUPPLY")=$P(^PSRX(PSORENW("OIRXN"),0),"^",8),PSONEW("# OF REFILLS")=$P(^(0),"^",9)
"RTN","PSORENW",45,0)
 D FULL^VALM1,ASK D:PSORENW("QFLG") KLIB^PSORENW1 D:PSORENW("QFLG") ULPAT D:PSORENW("QFLG") PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) G:PSORENW("QFLG") EOJ D ^PSORENW0
"RTN","PSORENW",46,0)
 D ULPAT,EOJ,KLIB^PSORENW1 K PSOOPT,PSONEW,PSORX("DFLG")
"RTN","PSORENW",47,0)
 Q
"RTN","PSORENW",48,0)
ULPAT K PSOMSG D UL^PSSLOCK(PSODFN) S X=PSODFN_";DPT(" D ULK^ORX2
"RTN","PSORENW",49,0)
 Q
"RTN","PSORENW",50,0)
RENEW(PLACER,PSOCPDRG) ;passes flag to CPRS for front door renews
"RTN","PSORENW",51,0)
 ;-1=couldn't find order, 0=unable to renew, 1=renewable
"RTN","PSORENW",52,0)
 ;Placer=Pharmacy number
"RTN","PSORENW",53,0)
 N PSOSURX,PSORFRM,PSOLC,PSODRG,PSODRUG0,RXN,ST,PSONEWOI,PSOOLDOI,PSOIFLAG,PSOINA
"RTN","PSORENW",54,0)
 I $G(PLACER)["S"!('$G(PLACER)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSORENW",55,0)
 S RXN=PLACER I '$D(^PSRX(RXN,0)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSORENW",56,0)
 S RX0=^PSRX(RXN,0),PSODRG=+$P(^PSRX(RXN,0),"^",6),ST=+^("STA"),PSODRUG0=^PSDRUG(PSODRG,0)
"RTN","PSORENW",57,0)
 S PSOIFLAG=0,PSOOLDOI=+$P($G(^PSRX(RXN,"OR1")),"^"),PSONEWOI=+$P($G(^PSDRUG(+$G(PSODRG),2)),"^") I PSONEWOI,PSONEWOI'=PSOOLDOI S PSOIFLAG=1
"RTN","PSORENW",58,0)
 S PSOINA=$P($G(^PS(50.7,PSONEWOI,0)),"^",4)
"RTN","PSORENW",59,0)
 I PSOINA,DT>PSOINA Q "0^This Orderable Item has been Inactivated."
"RTN","PSORENW",60,0)
 I ST=5 S PSOSURX=$O(^PS(52.5,"B",RXN,0)) I PSOSURX,$P($G(^PS(52.5,PSOSURX,0)),"^",7)="L" Q "0^Rx loading into a CMOP Transmission."
"RTN","PSORENW",61,0)
 S X1=DT,X2=-120 D C^%DTC I $P($G(^PSRX(RXN,2)),"^",6)<X Q "0^Prescription Expired more than 120 Days."
"RTN","PSORENW",62,0)
 S X1=DT,X2=-120 D C^%DTC I $P($G(^PSRX(RXN,3)),"^",5),$P($G(^(3)),"^",5)<X,$P(^("STA"),"^")=12 Q "0^Prescription Discontinued more than 120 Days."
"RTN","PSORENW",63,0)
 I $G(PSOCPDRG),$G(PSOCPDRG)'=$G(PSODRG) Q "0^Drug Mismatch, Non-Renewable."
"RTN","PSORENW",64,0)
 N PSOOCPRX,PSOOLPF,PSOOLPD,PSONOSIG S PSOOCPRX=RXN D CDOSE^PSORENW0 I PSOOLPF Q "0^Non-Renewable, invalid Dosage of "_$G(PSOOLPD)
"RTN","PSORENW",65,0)
 I PSONOSIG Q "0^Non-Renewable, missing Sig."
"RTN","PSORENW",66,0)
 I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" Q "0^Drug is No longer used by Outpatient Pharmacy."
"RTN","PSORENW",67,0)
 I $G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) Q "0^This Drug has been Inactivated."
"RTN","PSORENW",68,0)
 I ($P(PSODRUG0,"^",3)[1)!($P(PSODRUG0,"^",3)[2)!($P(PSODRUG0,"^",3)["W") Q "0^Non-Renewable "_$S($P(PSODRUG0,"^",3)["A":"Drug Narcotic.",1:"Drug.")
"RTN","PSORENW",69,0)
 I $D(^PS(53,+$P(RX0,"^",3),0)),'$P(^(0),"^",5) Q "0^Non-Renewable Prescription."
"RTN","PSORENW",70,0)
 S PSOLC=$P(RX0,"^"),PSOLC=$E(PSOLC,$L(PSOLC)) I $A(PSOLC)'<90 Q "0^Max number of renewals (26) has been reached."
"RTN","PSORENW",71,0)
 I ST,ST'=2,ST'=5,ST'=6,ST'=11,ST'=12,ST'=14 Q "0^Prescription is in a Non-Renewable Status."
"RTN","PSORENW",72,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",4) Q "0^Duplicate Rx Renewal Request."
"RTN","PSORENW",73,0)
 I $O(^PS(52.41,"AQ",RXN,0)) Q "0^Duplicate Rx Renewal Request."
"RTN","PSORENW",74,0)
 N TITMSG
"RTN","PSORENW",75,0)
 I $$TITRX^PSOUTL(RXN)="t" D  Q TITMSG
"RTN","PSORENW",76,0)
 . S TITMSG="0^Prescription was marked as 'Titration to Maintenance Dose' by Pharmacy and cannot be renewed."
"RTN","PSORENW",77,0)
 . S TITMSG=TITMSG_" To repeat the titration, enter a new prescription or copy the prior titration order."
"RTN","PSORENW",78,0)
 . S TITMSG=TITMSG_" To continue the maintenance dose, refill this prescription if refills are available"
"RTN","PSORENW",79,0)
 . S TITMSG=TITMSG_" or enter a new prescription for the maintenance dose."
"RTN","PSORENW",80,0)
 K PSORFRM,PSOLC,PSODRG,PSODRUG0,RXN,ST,TITMSG
"RTN","PSORENW",81,0)
 Q 1_$S($G(PSOIFLAG):"^"_$G(PSONEWOI),1:"")
"RTN","PSORENW",82,0)
 ;
"RTN","PSORENW",83,0)
INST1 ;Set Pharmacy Instructions array
"RTN","PSORENW",84,0)
 N PSOTZ
"RTN","PSORENW",85,0)
 I $O(^PSRX(RXN,"PI",0)) S PHI=$G(^PSRX(RXN,"PI",0)),PSOTZ=0 D
"RTN","PSORENW",86,0)
 .F  S PSOTZ=$O(^PSRX(RXN,"PI",PSOTZ)) Q:PSOTZ=""  S PHI(PSOTZ)=$G(^PSRX(RXN,"PI",PSOTZ,0))
"RTN","PSORENW",87,0)
 Q
"RTN","PSORENW",88,0)
INST2 ;Set Instructions and Comments
"RTN","PSORENW",89,0)
 I '$G(PSORENW("OIRXN")) Q
"RTN","PSORENW",90,0)
 I $G(PSOFDR) Q
"RTN","PSORENW",91,0)
 N PSOPHL,PSOPRL
"RTN","PSORENW",92,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PI",0)) K PHI S PHI=$G(^PSRX(PSORENW("OIRXN"),"PI",0)),PSOPHL="" D
"RTN","PSORENW",93,0)
 .F  S PSOPHL=$O(^PSRX(PSORENW("OIRXN"),"PI",PSOPHL)) Q:PSOPHL=""  S PHI(PSOPHL)=$G(^PSRX(PSORENW("OIRXN"),"PI",PSOPHL,0))
"RTN","PSORENW",94,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PRC",0)) K PRC S PRC=$G(^PSRX(PSORENW("OIRXN"),"PRC",0)),PSOPRL="" D
"RTN","PSORENW",95,0)
 .F  S PSOPRL=$O(^PSRX(PSORENW("OIRXN"),"PRC",PSOPRL)) Q:PSOPRL=""  S PRC(PSOPRL)=$G(^PSRX(PSORENW("OIRXN"),"PRC",PSOPRL,0))
"RTN","PSORENW",96,0)
 Q
"RTN","PSORENW4")
0^37^B62985403^B60124334
"RTN","PSORENW4",1,0)
PSORENW4 ;BIR/SAB - rx speed renew ;03/06/95
"RTN","PSORENW4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,37,64,46,75,71,100,130,117,152,148,264,225,301,390,313**;DEC 1997;Build 76
"RTN","PSORENW4",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSORENW4",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORENW4",5,0)
 ;External references L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",6,0)
 ;External reference to LK^ORX2 and ULK^ORX2 supported by DBIA 867
"RTN","PSORENW4",7,0)
SEL K PSODRUG ;PSO*7*301
"RTN","PSORENW4",8,0)
 I $P(PSOPAR,"^",4)=0 S VALMSG="Renewing is NOT Allowed. Check Site Parameters!",VALMBCK="" Q
"RTN","PSORENW4",9,0)
 N VALMCNT I '$G(PSOCNT) S VALMSG="This patient has no Prescriptions!",VALMBCK="" Q
"RTN","PSORENW4",10,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSORENW4",11,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSORENW4",12,0)
 K PRC,PHI,PSORX("EDIT"),PSOFDR,DIR,DUOUT,DIRUT,PSORNSPD S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DUOUT S VALMBCK="" G SELQ
"RTN","PSORENW4",13,0)
 K DIR,DIRUT,DTOUT,PSOOELSE,DTOUT I +Y S (SPEED,PSOOELSE,PSORNSPD)=1 D FULL^VALM1 S LST=Y D
"RTN","PSORENW4",14,0)
 .S (PSODIR("DFLG"),PSODIR("FIELD"))=0,PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"),PSORX("DFLG"))=0 D INIT Q:PSORENW("DFLG")
"RTN","PSORENW4",15,0)
 .F ORD=1:1:$L(LST,",") Q:$P(LST,",",ORD)']""  S ORN=$P(LST,",",ORD) D:+PSOLST(ORN)=52 PROCESS S PSORENW("DFLG")=0
"RTN","PSORENW4",16,0)
 I '$G(PSOOELSE) S VALMBCK="" G SELQ
"RTN","PSORENW4",17,0)
 S VALMBCK="R"
"RTN","PSORENW4",18,0)
 D ^PSOBUILD,BLD^PSOORUT1 K DIR,DIRUT,DTOUT,DUOUT,LST,ORD,IEN,ORN,RPH,ST,REFL,REF,PSOACT,ORSV,PSORNW,PSORENW,PSONO,PSOCO,PSOCU,PSODIR,DSMSG,SPEED,PSORENW,PSOOELSE,PSOOPT,PSORX("FILL DATE"),PSORX("ISSUE DATE"),PSOID,PSOMSG,PSORX("DFLG"),PSOQTY
"RTN","PSORENW4",19,0)
SELQ K PSORNSPD,RTE,DRET,PRC,PHI S X=PSODFN_";DPT(" D ULK^ORX2,UL^PSSLOCK(PSODFN),CLEAN^PSOVER1
"RTN","PSORENW4",20,0)
 Q
"RTN","PSORENW4",21,0)
 ;
"RTN","PSORENW4",22,0)
PROCESS ; Process one order at a time
"RTN","PSORENW4",23,0)
 W !!,"Now Renewing Rx # "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_"   Drug: "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),6),!
"RTN","PSORENW4",24,0)
 I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2)) D  K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",25,0)
 . W $C(7),!,"Rx "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_" has OPEN/UNRESOLVED 3rd Party Payer Rejects!"
"RTN","PSORENW4",26,0)
 I $$TITRX^PSOUTL($P(PSOLST(ORN),"^",2))="t" D  K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",27,0)
 . W $C(7),!,"Rx# "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_" is marked as 'Titration Rx' and cannot be renewed."
"RTN","PSORENW4",28,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) W $C(7),!!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^")),! K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",29,0)
 K RET,DRET,PRC,PHI S PSORENW("OIRXN")=$P(PSOLST(ORN),"^",2),PSOFROM="NEW"
"RTN","PSORENW4",30,0)
 S PSORENW("RX0")=^PSRX(PSORENW("OIRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN")),SIGOK=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^",2)
"RTN","PSORENW4",31,0)
 I SIGOK F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),"SIG1",I)) Q:'I  S SIG(I)=^PSRX(PSORENW("OIRXN"),"SIG1",I,0)
"RTN","PSORENW4",32,0)
 S PSOIBOLD=$G(PSORENW("OIRXN")) D SETIB^PSORENW1
"RTN","PSORENW4",33,0)
 I '$G(PSORENW("PROVIDER")) D
"RTN","PSORENW4",34,0)
 .S PSORENW("PROVIDER")=$P(PSORENW("RX0"),"^",4)
"RTN","PSORENW4",35,0)
 .S:$P(PSORENW("RX3"),"^",3) PSORENW("COSIGNING PROVIDER")=$P(PSORENW("RX3"),"^",3)
"RTN","PSORENW4",36,0)
 S PSORX("PROVIDER NAME")=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSORENW4",37,0)
 I '$G(PSORENW("CLINIC")) S PSORENW("CLINIC")=$P(PSORENW("RX0"),"^",5)
"RTN","PSORENW4",38,0)
 S PSORENW("REMARKS")="RENEWED FROM RX # "_$P(PSORENW("RX0"),"^")
"RTN","PSORENW4",39,0)
 S PSORENW("SIG")=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^")
"RTN","PSORENW4",40,0)
 S PSORENW("PSODFN")=$P(PSORENW("RX0"),"^",2)
"RTN","PSORENW4",41,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSORENW4",42,0)
 S PSORENW("DRUG IEN")=$P(PSORENW("RX0"),"^",6)
"RTN","PSORENW4",43,0)
 S PSORENW("QTY")=$P(PSORENW("RX0"),"^",7)
"RTN","PSORENW4",44,0)
 ;S PSORENW("DAYS SUPPLY")=$P(PSORENW("RX0"),"^",8)
"RTN","PSORENW4",45,0)
 ;S PSORENW("# OF REFILLS")=$P(PSORENW("RX0"),"^",9)
"RTN","PSORENW4",46,0)
 S PSORENW("INS")=$S($G(PSORENW("ENT"))]"":PSORENW("ENT"),1:$G(^PSRX(PSORENW("OIRXN"),"INS")))
"RTN","PSORENW4",47,0)
 S:$G(PSORENW("ENT"))']"" PSORENW("ENT")=0
"RTN","PSORENW4",48,0)
 F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),6,I)) Q:'I  S DOSE=^PSRX(PSORENW("OIRXN"),6,I,0) D
"RTN","PSORENW4",49,0)
 .S PSORENW("ENT")=PSORENW("ENT")+1,PSORENW("DOSE",PSORENW("ENT"))=$P(DOSE,"^")
"RTN","PSORENW4",50,0)
 .S PSORENW("UNITS",PSORENW("ENT"))=$P(DOSE,"^",3),PSORENW("DOSE ORDERED",PSORENW("ENT"))=$P(DOSE,"^",2),PSORENW("ROUTE",PSORENW("ENT"))=$P(DOSE,"^",7)
"RTN","PSORENW4",51,0)
 .S PSORENW("SCHEDULE",PSORENW("ENT"))=$P(DOSE,"^",8),PSORENW("DURATION",PSORENW("ENT"))=$P(DOSE,"^",5),PSORENW("CONJUNCTION",PSORENW("ENT"))=$P(DOSE,"^",6)
"RTN","PSORENW4",52,0)
 .S PSORENW("NOUN",PSORENW("ENT"))=$P(DOSE,"^",4),PSORENW("VERB",PSORENW("ENT"))=$P(DOSE,"^",9)
"RTN","PSORENW4",53,0)
 .I $G(^PSRX(PSORENW("OIRXN"),6,I,1))]"" S PSORENW("ODOSE",PSORENW("ENT"))=^PSRX(PSORENW("OIRXN"),6,I,1)
"RTN","PSORENW4",54,0)
 .K DOSE
"RTN","PSORENW4",55,0)
 I $P($G(^PSDRUG(PSORENW("DRUG IEN"),"CLOZ1")),"^")="PSOCLO1" N PSON S PSON=0 D  I PSON K PSON D POZ,KLIB^PSORENW1 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSORENW4",56,0)
 . I '$L($P(^VA(200,PSORENW("PROVIDER"),"PS"),"^",2)),'$L($P(^VA(200,PSORENW("PROVIDER"),"PS"),"^",3)) D  Q
"RTN","PSORENW4",57,0)
 . . S PSON=1 W $C(7),!!,"Only providers with DEA# or a VA# can write prescriptions for clozapine.",!
"RTN","PSORENW4",58,0)
 . I '$D(^XUSEC("YSCL AUTHORIZED",PSORENW("PROVIDER"))) D 
"RTN","PSORENW4",59,0)
 . . S PSON=1 W $C(7),!!,"Provider must hold YSCL AUTHORIZED key to write prescriptions for clozapine.",!
"RTN","PSORENW4",60,0)
 I $G(PSORNW("MAIL/WINDOW"))]"" S PSORENW("MAIL/WINDOW")=PSORNW("MAIL/WINDOW")
"RTN","PSORENW4",61,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PI",0)) D  K T
"RTN","PSORENW4",62,0)
 .S PHI=^PSRX(PSORENW("OIRXN"),"PI",0),T=0
"RTN","PSORENW4",63,0)
 .F  S T=$O(^PSRX(PSORENW("OIRXN"),"PI",T)) Q:'T  S PHI(T)=^PSRX(PSORENW("OIRXN"),"PI",T,0)
"RTN","PSORENW4",64,0)
 ;I $O(^PSRX(PSORENW("OIRXN"),"PRC",0)) D  K T
"RTN","PSORENW4",65,0)
 ;.S PRC=^PSRX(PSORENW("OIRXN"),"PRC",0),T=0
"RTN","PSORENW4",66,0)
 ;.F  S T=$O(^PSRX(PSORENW("OIRXN"),"PRC",T)) Q:'T  S PRC(T)=^PSRX(PSORENW("OIRXN"),"PRC",T,0)
"RTN","PSORENW4",67,0)
 W !!,"Now Renewing Rx # "_PSORENW("ORX #")_"   Drug: "_$P($G(^PSDRUG(+$G(PSORENW("DRUG IEN")),0)),"^"),!
"RTN","PSORENW4",68,0)
 I '$P($G(^PSDRUG($P(PSORENW("RX0"),"^",6),2)),"^") D  G:$G(PSORENW("DFLG")) PROCESSX
"RTN","PSORENW4",69,0)
 .I $P($G(^PSRX(PSORENW("OIRXN"),"OR1")),"^") S PSODRUG("OI")=$P(^PSRX(PSORENW("OIRXN"),"OR1"),"^"),PSODRUG("OIN")=$P(^PS(50.7,+^("OR1"),0),"^") Q
"RTN","PSORENW4",70,0)
 .W !!,"Cannot Renew!!  No Pharmacy Orderable Item!" S VALMSG="Cannot Renew!!  No Pharmacy Orderable Item!",PSORX("DFLG")=1
"RTN","PSORENW4",71,0)
 D CHECK^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",72,0)
 D FILDATE^PSORENW0
"RTN","PSORENW4",73,0)
 D DRUG^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",74,0)
 D RXN^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",75,0)
 D STOP^PSORENW1
"RTN","PSORENW4",76,0)
DSPL K PSOEDT,PSOLM S PSDY=PSORENW("DAYS SUPPLY"),PSRF=PSORENW("# OF REFILLS")
"RTN","PSORENW4",77,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S PSODIR("CS")=1
"RTN","PSORENW4",78,0)
 I $G(PSODIR("CS")) D
"RTN","PSORENW4",79,0)
 .S PSORENW("# OF REFILLS")=$S(PSDY<60:5,PSDY'<60&(PSDY'>89):2,PSDY=90:1,1:0)
"RTN","PSORENW4",80,0)
 .I PSORENW("# OF REFILLS")>PSRF S PSORENW("# OF REFILLS")=PSRF
"RTN","PSORENW4",81,0)
 D DSPLY^PSORENW3 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",82,0)
 D:$D(^XUSEC("PSORPH",DUZ))!('$P(PSOPAR,"^",2)) VER1^PSOORNE4(.PSORENW) G:PSORENW("DFLG")=1 PROCESSX
"RTN","PSORENW4",83,0)
 I $G(PSOQTY) D QTY^PSODIR1(.PSORENW) G:PSORENW("DFLG")=1 PROCESSX
"RTN","PSORENW4",84,0)
 D EN^PSORN52(.PSORENW)
"RTN","PSORENW4",85,0)
 D RNPSOSD^PSOUTIL
"RTN","PSORENW4",86,0)
 D CAN^PSORENW0,DCORD^PSONEW2
"RTN","PSORENW4",87,0)
 S PSORENW("# OF REFILLS")=PSRF K PSDY,PSRF,PSODIR("CS"),DEA,PSORENW("ENT")
"RTN","PSORENW4",88,0)
 S BBRN="",BBRN1=$O(^PSRX("B",PSORENW("NRX #"),BBRN)) I $P($G(^PSRX(BBRN1,0)),"^",11)["W" S BINGCRT="Y",BINGRTE="W",BBFLG=1,BBRX(1)=$G(BBRX(1))_BBRN1_","
"RTN","PSORENW4",89,0)
PROCESSX I PSORENW("DFLG") D  W:'$G(POERR) !,$C(7),"Rx NOT RENEWED. RENEWED RX DELETED",! S POERR("DFLG")=1 D CLEAN^PSOVER1
"RTN","PSORENW4",90,0)
 .K PHI,PRC,PSODRUG,SIG,PSORXED,SIGOK
"RTN","PSORENW4",91,0)
 .K PSORENW("DOSE"),PSORENW("DURATION"),PSORENW("DRUG IEN"),PSORENW("ENT"),PSORENW("INS"),PSORENW("NOUN"),PSORENW("ROUTE"),PSORENW("SCHEDULE"),PSORENW("SIG"),PSORENW("VERB"),PSORENW("UNITS")
"RTN","PSORENW4",92,0)
 .D POZ
"RTN","PSORENW4",93,0)
 K PSORDLOK I PSORENW("DFLG") S PSORDLOK=1
"RTN","PSORENW4",94,0)
 D:$G(PSORENW("OLD FILL DATE"))]"" SUSDATEK^PSOUTIL(.PSORENW)
"RTN","PSORENW4",95,0)
 K BBRN,BBRN1,PSODRUG,PSORX("PROVIDER NAME"),PSORX("CLINIC")
"RTN","PSORENW4",96,0)
 K PSOEDT,PSOLM S:$G(PSORENW("FROM"))="" (PSORENW("DFLG"),PSORENW("QFLG"))=0
"RTN","PSORENW4",97,0)
 I $G(PSORDLOK) D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSORENW4",98,0)
 D KLIB^PSORENW1
"RTN","PSORENW4",99,0)
 K PSORDLOK
"RTN","PSORENW4",100,0)
 S RXN=$O(^TMP("PSORXN",$J,0)) I RXN N ZRXN S ZRXN=RXN D
"RTN","PSORENW4",101,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSORENW4",102,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS",$P(RXN1,"^",4))
"RTN","PSORENW4",103,0)
 .;saves drug allergy order chks pso*7*390
"RTN","PSORENW4",104,0)
 .I +$G(^TMP("PSODAOC",$J,1,0)) D
"RTN","PSORENW4",105,0)
 .I $G(PSORX("DFLG"))!$G(PSORENW("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSORENW4",106,0)
 .S RXN=ZRXN,PSODAOC="Rx Backdoor "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"SPEED RENEW Order Acceptance_OP"
"RTN","PSORENW4",107,0)
 .D DAOC^PSONEW
"RTN","PSORENW4",108,0)
 K ZRXN,RXN,RXN1,^TMP("PSORXN",$J),^TMP("PSODAOC",$J)
"RTN","PSORENW4",109,0)
 Q
"RTN","PSORENW4",110,0)
INIT ;
"RTN","PSORENW4",111,0)
 D ASK Q:PSORENW("DFLG")
"RTN","PSORENW4",112,0)
 D NOORE^PSONEW(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",113,0)
 Q
"RTN","PSORENW4",114,0)
ASK ;upfront questions
"RTN","PSORENW4",115,0)
 W !! D ISSDT^PSODIR2(.PSORENW) Q:PSORENW("DFLG")  S PSORENW("ISSUE DATE")=PSOID
"RTN","PSORENW4",116,0)
 D FILLDT^PSODIR2(.PSORENW) K PSONEW("DAYS SUPPLY"),PSONEW("# OF REFILLS") Q:PSORENW("DFLG")
"RTN","PSORENW4",117,0)
 S PSORNW("FILL DATE")=PSORENW("FILL DATE")
"RTN","PSORENW4",118,0)
 D MW^PSODIR2(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",119,0)
 D PTSTAT^PSODIR1(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",120,0)
 D DAYS^PSODIR1(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",121,0)
 S PSODRUG("DEA")=0 D REFILL^PSODIR1(.PSORENW) K PSODRUG("DEA") Q:PSORENW("DFLG")
"RTN","PSORENW4",122,0)
 K DIR,DIRUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Do you want to edit Renewed Rx(s) QTY " D ^DIR I $D(DIRUT) S PSORENW("DFLG")=1 K DIR,DIRUT Q
"RTN","PSORENW4",123,0)
 S PSOQTY=Y K DIR,DIRUT
"RTN","PSORENW4",124,0)
 D CLINIC^PSODIR2(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",125,0)
 D PROV^PSODIR(.PSORENW) S:PSORENW("DFLG") PSORENW("DFLG")=0
"RTN","PSORENW4",126,0)
 Q
"RTN","PSORENW4",127,0)
 ;
"RTN","PSORENW4",128,0)
POZ ;
"RTN","PSORENW4",129,0)
 K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DTOUT
"RTN","PSORENW4",130,0)
 Q
"RTN","PSORXEDT")
0^20^B45205767^B45078409
"RTN","PSORXEDT",1,0)
PSORXEDT ;BIR/SAB-edit rx routine ;10/21/98
"RTN","PSORXEDT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**21,23,44,71,146,185,148,253,390,372,416,313**;DEC 1997;Build 76
"RTN","PSORXEDT",3,0)
 ;Ref. ^PS(55 supp. IA 2228
"RTN","PSORXEDT",4,0)
 ;External reference to $$BSA^PSSDSAPI supported by DBIA 5425
"RTN","PSORXEDT",5,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) G EOJ Q
"RTN","PSORXEDT",6,0)
 K PSODRUG,PSOLIST,DIR,DIRUT,DUOUT,X,Y,PSOFROM,^TMP("PSOBEDT",$J),NOPP,CLOZPST,PSOTITRX,PSOMTFLG
"RTN","PSORXEDT",7,0)
 N PSOODOSP
"RTN","PSORXEDT",8,0)
 W !! S DIR(0)="FAO^1:245",DIR("A")="Edit Rx(s) => ",DIR("?",1)="Enter Rx Number or A List of numbers Separated",DIR("?")="by Commas, e.g. 1234A,345,937002Q."
"RTN","PSORXEDT",9,0)
 D ^DIR K DIR G:$D(DIRUT) EOJ
"RTN","PSORXEDT",10,0)
 S END=$L(X,","),BAD=0
"RTN","PSORXEDT",11,0)
 F I=1:1:END S RXM=$P(X,",",I) I +RXM F J=I+1:1:END S DUP=$P(X,",",J) I DUP=RXM S $P(X,",",J)="" W !?5,$C(7),"Duplicate Rx # "_RXM_"  was found in your list, ignoring it!",! S BAD=1
"RTN","PSORXEDT",12,0)
 S PSORLST=$P(X,",") F I=2:1:END S RXM=$P(X,",",I) S:RXM'?1.N.A BAD=1 I RXM?1.N.A S PSORLST=PSORLST_","_RXM
"RTN","PSORXEDT",13,0)
 F I=1:1:$L(PSORLST) S RXM=$P(PSORLST,",",I) I +RXM F J=I+1:1:END S DUP=$P(PSORLST,",",J) I DUP=RXM S $P(PSORLST,",",J)=""
"RTN","PSORXEDT",14,0)
BAD I PSORLST D  I 'Y K Y G PSORXEDT
"RTN","PSORXEDT",15,0)
 .W !?15,"=> "_PSORLST
"RTN","PSORXEDT",16,0)
 .K DIR,DIRUT S DIR(0)="Y",DIR("A")="Is this OKAY ",DIR("B")="Yes"
"RTN","PSORXEDT",17,0)
 .D ^DIR K DIR
"RTN","PSORXEDT",18,0)
 .I 'Y!$D(DIRUT) K X,PSORLST,BAD
"RTN","PSORXEDT",19,0)
 K BAD I 'PSORLST K PSORLST G PSORXEDT
"RTN","PSORXEDT",20,0)
 F I=1:1:$L(PSORLST,",") S RXM=$P(PSORLST,",",I) S GOOD=$D(^PSRX("B",RXM)) D
"RTN","PSORXEDT",21,0)
 .I 'GOOD W !!?5,"Couldn't Find RX # "_RXM H 3 Q
"RTN","PSORXEDT",22,0)
 .S RXN=$O(^PSRX("B",RXM,0)) D  I $P(^PSRX(RXN,"STA"),"^")=13 W !!?5,"Rx # "_RXM_" is marked for Deletion." H 3 Q
"RTN","PSORXEDT",23,0)
 ..I $G(RXN),$P($G(^PS(55,+$P($G(^PSRX(RXN,0)),"^",2),0)),"^",6)'=2 S PSOLOUD=1 D EN^PSOHLUP(+$P($G(^PSRX(RXN,0)),"^",2)) K PSOLOUD
"RTN","PSORXEDT",24,0)
 .D LIST K GOOD
"RTN","PSORXEDT",25,0)
 K GOOD,END
"RTN","PSORXEDT",26,0)
EPH ; - Entry for Epharmacy Rx Edit (PSOREJP1)
"RTN","PSORXEDT",27,0)
 F PSOT1=1:1 Q:'$D(PSOLIST(PSOT1))  F PSOLST2=1:1:$L(PSOLIST(PSOT1),",") S ORN=$P(PSOLIST(PSOT1),",",PSOLST2) D:+ORN PT
"RTN","PSORXEDT",28,0)
 ;call to add bingo board data to file 52.11
"RTN","PSORXEDT",29,0)
 K POP,PSOLIST,TM,TM1 G:'$O(PSORX("PSOL",0)) NX
"RTN","PSORXEDT",30,0)
 D:$G(PSORX("PSOL",1))]"" ^PSORXL K PSORX G:$G(NOBG) NX
"RTN","PSORXEDT",31,0)
PRF G:'$P(PSOPAR,"^",8)!($G(NOPP)="H")!($G(NOPP)="S")!('$D(^TMP("PSOBEDT",$J))) BBG
"RTN","PSORXEDT",32,0)
 I $O(^TMP("PSOBEDT",$J,0)),$P(PSOPAR,"^",8) S PSOFROM="NEW",PSOION=ION K RXRS
"RTN","PSORXEDT",33,0)
 G:$D(PSOPROP)&($G(PSOPROP)'=ION) QUP
"RTN","PSORXEDT",34,0)
 I '$D(PSOPROP)!($G(PSOPROP)=ION) D  G:$G(POP)!($E(IOST)["C")!(PSOION=ION) BBG
"RTN","PSORXEDT",35,0)
 .S PSOION=ION W !,"Profiles must be sent to Printer !!",! K IOP,%ZIS,IO("Q"),POP
"RTN","PSORXEDT",36,0)
 .S %ZIS="MNQ",%ZIS("A")="Select Profile Device: " D ^%ZIS K %ZIS("A")
"RTN","PSORXEDT",37,0)
 .Q:$G(POP)!($E(IOST)["C")!(PSOION=ION)  S PSOPROP=ION
"RTN","PSORXEDT",38,0)
QUP S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X,HOLDRPAS=$G(PSOPRPAS),PSOPRPAS=$P(PSOPAR,"^",13)
"RTN","PSORXEDT",39,0)
 F DFN=0:0 S DFN=$O(^TMP("PSOBEDT",$J,DFN)) Q:'DFN  S PPL=^TMP("PSOBEDT",$J,DFN,0) D
"RTN","PSORXEDT",40,0)
 .S ZTRTN="DQ^PSOPRF",ZTIO=PSOPROP,ZTDESC="Outpatient Pharmacy Patient Profiles",ZTDTH=$H
"RTN","PSORXEDT",41,0)
 .F G="PSOPAR","PSODTCUT","PSOPRPAS","DFN","PSOSITE","NEW1","NEW11","PSOBMST","PFIO","PPL" S:$D(@G) ZTSAVE(G)=""
"RTN","PSORXEDT",42,0)
 .D ^%ZTLOAD
"RTN","PSORXEDT",43,0)
 W:$D(ZTSK) !,"PROFILE(S) QUEUED to PRINT",!! K G,ZTSK D ^%ZISC
"RTN","PSORXEDT",44,0)
 S PSOPRPAS=$G(HOLDRPAS) K:PSOPRPAS']"" PSOPRPAS K HOLDRPAS
"RTN","PSORXEDT",45,0)
BBG K DFN F PSODFN=0:0 S PSODFN=$O(^TMP("PSOBEDT",$J,PSODFN)) Q:'PSODFN  I $G(^TMP("PSOBEDT",$J,PSODFN,1)),$D(DISGROUP) S TM=$P($G(^TMP("PSOBB",$J)),"^"),TM1=$P($G(^($J)),"^",2),PPL=^TMP("PSOBEDT",$J,PSODFN,0) D ^PSOBING1
"RTN","PSORXEDT",46,0)
NX ;
"RTN","PSORXEDT",47,0)
 K %X,%Y,ACTREF,ACTREN,D,D0,DAT,DFN,DIC,DIQ,DQ,DRG,END,FDR,PSOBEDT,TM,TM1,PSOT1,PSOLST2,NOBG,BBFLG,BINGCRT,BINGRTE,C,CC,CMOP,COM,CT,D1,DI,DREN,BBRX,PSOFROM,POP,PSORX("QFLG"),IT,PSOERR,PSOBCK,PSOBM,PPL
"RTN","PSORXEDT",48,0)
 K ^TMP("PSOBEDT",$J),^TMP("PSOBB",$J),ZTSK,NOPP,VALMSG,VALMBCK D EOJ
"RTN","PSORXEDT",49,0)
END Q
"RTN","PSORXEDT",50,0)
 ;---------------------------------------------------------
"RTN","PSORXEDT",51,0)
PT ;
"RTN","PSORXEDT",52,0)
 N PSOTXEDT,PSOTPEXT S PSOTXEDT=$P($G(^PSRX(ORN,0)),"^",2) I PSOTXEDT I $D(^PS(52.91,PSOTXEDT,0)) I '$P(^PS(52.91,PSOTXEDT,0),"^",3)!($P(^(0),"^",3)>DT) D PDIR^PSOTPCAN(PSOTXEDT) I $G(PSOTPEXT) K PSOTPEXT,PSOTXEDT D EOJ Q
"RTN","PSORXEDT",53,0)
 K PSOTXEDT,PSOTPEXT
"RTN","PSORXEDT",54,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSORXEDT",55,0)
 S $P(PSOLST(ORN),"^",2)=ORN,(PSOBEDT)=1
"RTN","PSORXEDT",56,0)
 S (DFN,PSODFN)=+$P(^PSRX(ORN,0),"^",2),PSORX("NAME")=$P(^DPT(DFN,0),"^") I PSODFN'=$G(PSOODOSP) K PSORX("DOSING OFF") S PSOODOSP=PSODFN
"RTN","PSORXEDT",57,0)
 D ICN^PSODPT(DFN)
"RTN","PSORXEDT",58,0)
 S RX0=^PSRX(ORN,0),RX2=$G(^(2)),RX3=$G(^(3))
"RTN","PSORXEDT",59,0)
 D:$G(DUZ("AG"))="V" COPAY^PSOPTPST ; Deals with copay
"RTN","PSORXEDT",60,0)
 K ^TMP("PSOHDR",$J),^TMP("PSOPI",$J) D ^VADPT,ADD^VADPT
"RTN","PSORXEDT",61,0)
 S ^TMP("PSOHDR",$J,1,0)=VADM(1),^TMP("PSOHDR",$J,2,0)=$P(VADM(2),"^",2)
"RTN","PSORXEDT",62,0)
 S ^TMP("PSOHDR",$J,3,0)=$P(VADM(3),"^",2)
"RTN","PSORXEDT",63,0)
 S ^TMP("PSOHDR",$J,4,0)=VADM(4),^TMP("PSOHDR",$J,5,0)=$P(VADM(5),"^",2)
"RTN","PSORXEDT",64,0)
 S POERR=1 D RE^PSODEM K POERR,VALMBCK
"RTN","PSORXEDT",65,0)
 S ^TMP("PSOHDR",$J,6,0)=$S($P(WT,"^",8):$P(WT,"^",9)_" ("_$P(WT,"^")_")",1:"_______ (______)")
"RTN","PSORXEDT",66,0)
 S ^TMP("PSOHDR",$J,7,0)=$S($P(HT,"^",8):$P(HT,"^",9)_" ("_$P(HT,"^")_")",1:"_______ (______)") K VM,WT,HT S PSOHD=7
"RTN","PSORXEDT",67,0)
 S ^TMP("PSOHDR",$J,9,0)="",^TMP("PSOHDR",$J,10,0)=""
"RTN","PSORXEDT",68,0)
 S GMRA="0^0^111" D ^GMRADPT S ^TMP("PSOHDR",$J,8,0)=+$G(GMRAL)
"RTN","PSORXEDT",69,0)
 S PSOBSA=$$BSA^PSSDSAPI(DFN),PSOBSA=$P(PSOBSA,"^",3),PSOBSA=$S(PSOBSA'>0:"_______",1:$J(PSOBSA,4,2)) S ^TMP("PSOHDR",$J,12,0)=PSOBSA
"RTN","PSORXEDT",70,0)
 S RSLT=$$CRCL^PSOORUT2(DFN)
"RTN","PSORXEDT",71,0)
 I $P(RSLT,"^",2)["Not Found" S ZDSPL=" CrCL: "_$P(RSLT,"^",2)
"RTN","PSORXEDT",72,0)
 E  S ZDSPL=" CrCL: "_$P($G(RSLT),"^",2)_"(est.) "_"(CREAT:"_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSORXEDT",73,0)
 S ^TMP("PSOHDR",$J,13,0)=ZDSPL
"RTN","PSORXEDT",74,0)
 K PSOBSA,RSLT,ZDSPL
"RTN","PSORXEDT",75,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSORXEDT",76,0)
 S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSORXEDT",77,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^")
"RTN","PSORXEDT",78,0)
 D CLEAR^VALM1
"RTN","PSORXEDT",79,0)
 S STA="ACTIVE^NON-VERIFIED^REFILL^HOLD^NON-VERIFIED^SUSPENDED^^^^^^EXPIRED^DISCONTINUED^^DISCONTINUED^DISCONTINUED^HOLD"
"RTN","PSORXEDT",80,0)
 S $P(PSOLST(ORN),"^",3)=$P(STA,"^",$P(^PSRX(ORN,"STA"),"^")+1),PSLST=ORN,ORD=1
"RTN","PSORXEDT",81,0)
 D ACT^PSOORNE2
"RTN","PSORXEDT",82,0)
EOJ ;
"RTN","PSORXEDT",83,0)
 K INS1,HDR,IK,INDT,LOG,NODE,ORN,P1,PSI,PSL,PSOLION,PSNP,PSOACT,PSOBM,PSOCLC,PSOCNT,PSODD,PSODFN,PSOHD,PSOJ,PSOLST,PSOOI,PSOPF,PSLST
"RTN","PSORXEDT",84,0)
 K PSOIBQS,PSORLST,PSOSD,PSOSIG,PSPRXN,PSORX0,PSORX1,PTST,REFL,RF,RFD,RIFN,RLD,RPH,RTS,RX0,RX1,RX2,RX3,RXM,RXOR,SIG,SIGOK
"RTN","PSORXEDT",85,0)
 D KVA^VADPT K SLPPL,ST,STA,^TMP("PS",$J),PSOQFLG,PSORXED,PSOEDIT,DIR,DIRUT,DUOUT,DTOUT,PSOLOUD,GMRAL,GG,FEV,ACNT
"RTN","PSORXEDT",86,0)
 D FULL^VALM1 K ^TMP("PSOAL",$J),^TMP("PSOAO",$J),^TMP("PSOSF",$J),^TMP("PSOPF",$J),^TMP("PSOPI",$J),^TMP("PSOPO",$J),^TMP("PSOHDR",$J),PAT
"RTN","PSORXEDT",87,0)
 K JJ,K,MM,PSDAYS,PSOAC,PSOAL,PSOCOU,PSOCOUU,PSONEW,PSODRUG,PSONOOR,PSRX0,QTY,REA,RFCNT,RFDT,RXDA,RXFL,RXREF,SUB,X,Z,ZII
"RTN","PSORXEDT",88,0)
 K ACOM,CRIT,DA,DDH,DGI,DGS,PSONEW3,SER,SERS,ZONE,RN,RXN,PSOX,PSOERR,ORD,PSOBCK,PSOBILL,SURX,PSORX("QFLG"),PSORX("FN"),CLOZPAT
"RTN","PSORXEDT",89,0)
 Q
"RTN","PSORXEDT",90,0)
LIST ;
"RTN","PSORXEDT",91,0)
 I $G(^PSRX(RXN,0))']"" W !,$C(7),"Rx data is not on file !",! G LISTX
"RTN","PSORXEDT",92,0)
 I $P(^PSRX(RXN,0),"^",15)=13 S PSVD=1 W !,$C(7),"Rx # "_RXM_" has been deleted."
"RTN","PSORXEDT",93,0)
 S RXN1=RXN,RXM1=RXM D:'$G(PSVD) LST1 W "." S RXN=RXN1,RXM=RXM1 K RXN1,RXM1
"RTN","PSORXEDT",94,0)
 F  S RXN=$O(^PSRX("B",RXM,RXN)) Q:'RXN  D
"RTN","PSORXEDT",95,0)
 .I $G(^PSRX(RXN,0))']"" Q
"RTN","PSORXEDT",96,0)
 .I $P(^PSRX(RXN,0),"^",15)=13 Q
"RTN","PSORXEDT",97,0)
 .D LST1
"RTN","PSORXEDT",98,0)
 K RXN1 G LISTX
"RTN","PSORXEDT",99,0)
 Q
"RTN","PSORXEDT",100,0)
LST1 I $G(PSOLIST(1))']"" S PSOLIST(1)=RXN_"," G LISTX
"RTN","PSORXEDT",101,0)
 F PSOX1=0:0 S PSOX1=$O(PSOLIST(PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSORXEDT",102,0)
 I $L(PSOLIST(PSOX2))+$L(RXN)<220 S:RXN_","'[PSOLIST(PSOX2) PSOLIST(PSOX2)=PSOLIST(PSOX2)_RXN_","
"RTN","PSORXEDT",103,0)
 E  S:RXN_","'[PSOLIST(PSOX2+1) PSOLIST(PSOX2+1)=RXN_","
"RTN","PSORXEDT",104,0)
LISTX K PSOX1,PSOX2,RXN,PSVD
"RTN","PSORXEDT",105,0)
 Q
"RTN","PSORXVW")
0^21^B81070397^B77494288
"RTN","PSORXVW",1,0)
PSORXVW ;BHAM ISC/SAB - listman view of a prescription ;6/7/12 7:00pm
"RTN","PSORXVW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**14,35,46,96,103,88,117,131,146,156,185,210,148,233,260,264,281,359,385,400,391,313**;DEC 1997;Build 76
"RTN","PSORXVW",3,0)
 ;External reference to File ^PS(55 supported by DBIA 2228
"RTN","PSORXVW",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORXVW",5,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSORXVW",6,0)
 ;External reference to ^VA(200 supported by DBIA 10060
"RTN","PSORXVW",7,0)
 ;External reference to ^SC supported by DBIA 10040
"RTN","PSORXVW",8,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSORXVW",9,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSORXVW",10,0)
 ;External reference to GMRADPT supported by DBIA 10099
"RTN","PSORXVW",11,0)
 ;External reference to $$BADADR^DGUTL3 supported by DBIA 4080
"RTN","PSORXVW",12,0)
 ;
"RTN","PSORXVW",13,0)
 S PS="VIEW"
"RTN","PSORXVW",14,0)
A1 ; - Prescription prompt
"RTN","PSORXVW",15,0)
 S DIR(0)="FAO^1:30",DIR("A")=PS_" PRESCRIPTION: ",(DIR("?"),DIR("??"))="^D HLP^PSORXVW1"
"RTN","PSORXVW",16,0)
 W ! D ^DIR I X=""!$D(DIRUT) K:$G(PS)="VIEW" DA K PS G KILL
"RTN","PSORXVW",17,0)
 S X=$$UP^XLFSTR(X),QUIT=0
"RTN","PSORXVW",18,0)
 I $E(X,1,2)'="E." S (DA,PSOVDA)=+$$LKP^PSORXVW1(X) I DA<0 G A1
"RTN","PSORXVW",19,0)
 I $E(X,1,2)="E." D  I QUIT G A1   ; esg 12/7/10 - ECME# lookup - PSO*7*359
"RTN","PSORXVW",20,0)
 .S (DA,PSOVDA)=+$$RXNUM^PSOBPSU2($E(X,3,$L(X))) I DA<0 W " ??",$C(7) S QUIT=1
"RTN","PSORXVW",21,0)
 ;
"RTN","PSORXVW",22,0)
 ; pso*7*385 - esg - Routine BPSRVX is calling this routine here at entry point DP in order to capture the
"RTN","PSORXVW",23,0)
 ; scratch global data for the View ECME Rx option.  Special variable BPSVRX=1 in this case.
"RTN","PSORXVW",24,0)
DP ; DBIA #4711 entry point from ECME
"RTN","PSORXVW",25,0)
 ;
"RTN","PSORXVW",26,0)
 S (PSODFN,DFN)=+$P(^PSRX(DA,0),"^",2) S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSORXVW",27,0)
 D ICN^PSODPT(PSODFN)
"RTN","PSORXVW",28,0)
 K ^TMP("PSOHDR",$J) D ^VADPT,ADD^VADPT
"RTN","PSORXVW",29,0)
 S ^TMP("PSOHDR",$J,1,0)=VADM(1)
"RTN","PSORXVW",30,0)
 N PSOBADR,PSOTEMP
"RTN","PSORXVW",31,0)
 S PSOBADR=$$BADADR^DGUTL3(DFN) I PSOBADR S PSOTEMP=$$CHKTEMP^PSOBAI(DFN) D
"RTN","PSORXVW",32,0)
 .S ^TMP("PSOHDR",$J,1,0)=^TMP("PSOHDR",$J,1,0)_" ** BAD ADDRESS INDICATED-("_$S(PSOBADR=1:"UNDELIVERABLE",PSOBADR=2:"HOMELESS",1:"OTHER")_")"_$S(PSOTEMP:" Active Temporary Address",1:"")
"RTN","PSORXVW",33,0)
 S ^TMP("PSOHDR",$J,2,0)=$P(VADM(2),"^",2)
"RTN","PSORXVW",34,0)
 S ^TMP("PSOHDR",$J,3,0)=$P(VADM(3),"^",2),^TMP("PSOHDR",$J,4,0)=VADM(4),^TMP("PSOHDR",$J,5,0)=$P(VADM(5),"^",2)
"RTN","PSORXVW",35,0)
 S POERR=1 D RE^PSODEM K PSOERR
"RTN","PSORXVW",36,0)
 S ^TMP("PSOHDR",$J,6,0)=$S(+$P(WT,"^",8):$P(WT,"^",9)_" ("_$P(WT,"^")_")",1:"_______ (______)")
"RTN","PSORXVW",37,0)
 S ^TMP("PSOHDR",$J,7,0)=$S($P(HT,"^",8):$P(HT,"^",9)_" ("_$P(HT,"^")_")",1:"_______ (______)") K VM,WT,HT S PSOHD=7
"RTN","PSORXVW",38,0)
 S GMRA="0^0^111" D EN1^GMRADPT S ^TMP("PSOHDR",$J,8,0)=+$G(GMRAL)
"RTN","PSORXVW",39,0)
 D DEM^VADPT I +VADM(6) D
"RTN","PSORXVW",40,0)
 .S SSN=$P(^DPT(PSODFN,0),"^",9) W !,$C(7),?10,$P(^DPT(PSODFN,0),"^")_" ("_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_") DIED "_$P(VADM(6),"^",2),!
"RTN","PSORXVW",41,0)
 .W "All Active Medications will be Autocanceled!",! H 2 S PSODEATH=1
"RTN","PSORXVW",42,0)
 .S ACOM="Date of Death "_$P(VADM(6),"^",2)_".",ZTRTN="CAN^PSOCAN3",ZTDESC="Outpatient Pharmacy Autocancel Due to Death of Patient",ZTSAVE("ACOM")="",ZTSAVE("PSODFN")="",ZTSAVE("PSODEATH")=""
"RTN","PSORXVW",43,0)
 .S ZTIO="",PSOCLC=DUZ,ZTSAVE("PSOCLC")="",ZTDTH=$H D ^%ZTLOAD K ACOM,ZTSK,PSODEATH
"RTN","PSORXVW",44,0)
 K ^TMP("PSOAL",$J),PCOMX,PDA,PHI,PRC,ACOM,ANS
"RTN","PSORXVW",45,0)
 S (DA,RXN)=PSOVDA K PSOVDA S RX0=^PSRX(RXN,0),RX2=$G(^(2)),RX3=$G(^(3)),ST=+$G(^("STA")),RXOR=$G(^("OR1"))
"RTN","PSORXVW",46,0)
 I 'RXOR,$P(^PSDRUG($P(RX0,"^",6),2),"^") S $P(^PSRX(RXN,"OR1"),"^")=$P(^PSDRUG($P(RX0,"^",6),2),"^"),RXOR=$P(^PSDRUG($P(RX0,"^",6),2),"^")
"RTN","PSORXVW",47,0)
 S IEN=0,$P(RN," ",12)=" "
"RTN","PSORXVW",48,0)
 N APPND,ECME,TITR
"RTN","PSORXVW",49,0)
 S APPND=$S($G(^PSRX(RXN,"IB")):"$",1:"")
"RTN","PSORXVW",50,0)
 S ECME=$$ECME^PSOBPSUT(RXN)  ; Returns "" (non-ECME), or "e" (ECME)
"RTN","PSORXVW",51,0)
 S TITR=$$TITRX^PSOUTL(RXN)  ; Returns "" (non-Titration), "m" (Maintenance) or "t" (titration)
"RTN","PSORXVW",52,0)
 S APPND=APPND_ECME_TITR
"RTN","PSORXVW",53,0)
 I ECME'="" S APPND=APPND_"  (ECME#: "_$$ECMENUM^PSOBPSU2(RXN)_")"
"RTN","PSORXVW",54,0)
 I TITR'="" S APPND=APPND_"  ("_$S(TITR="t":"Titration",1:"Maintenance")_")"
"RTN","PSORXVW",55,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=$S($P($G(^PSRX(RXN,"TPB")),"^"):"            TPB Rx #: ",1:"                Rx #: ")_$P(RX0,"^")_APPND_$E(RN,$L($P(RX0,"^")_APPND)+1,12)
"RTN","PSORXVW",56,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="      Orderable Item: "_$S($D(^PS(50.7,$P(+RXOR,"^"),0)):$P(^PS(50.7,$P(+RXOR,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^"),1:"No Pharmacy Orderable Item")
"RTN","PSORXVW",57,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=$S($D(^PSDRUG("AQ",$P(RX0,"^",6))):"           CMOP ",1:"                ")_"Drug: "_$P(^PSDRUG($P(RX0,"^",6),0),"^")
"RTN","PSORXVW",58,0)
 S:$G(^PSRX(RXN,"TN"))]"" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="          Trade Name: "_$G(^PSRX(RXN,"TN"))
"RTN","PSORXVW",59,0)
 I $$STATUS^PSOBPSUT(RXN,0)'="",$$RXRLDT^PSOBPSUT(RXN,0) D
"RTN","PSORXVW",60,0)
 . S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="                 NDC: "_$$GETNDC^PSONDCUT(RXN,0)
"RTN","PSORXVW",61,0)
 D DOSE^PSORXVW1
"RTN","PSORXVW",62,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Patient Instructions:" I $O(^PSRX(RXN,"INS1",0)) D
"RTN","PSORXVW",63,0)
 . F I=0:0 S I=$O(^PSRX(RXN,"INS1",I)) Q:'I  D
"RTN","PSORXVW",64,0)
 .. S MIG=^PSRX(RXN,"INS1",I,0)
"RTN","PSORXVW",65,0)
 .. D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAL",$J)),21)
"RTN","PSORXVW",66,0)
 K MIG,SG
"RTN","PSORXVW",67,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="  Other Pat. Instruc: "_$S($G(^PSRX(RXN,"INSS"))]"":^PSRX(RXN,"INSS"),1:"")
"RTN","PSORXVW",68,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="                 SIG:"
"RTN","PSORXVW",69,0)
 I '$P($G(^PSRX(RXN,"SIG")),"^",2) D  G PTST
"RTN","PSORXVW",70,0)
 . S X=$P($G(^PSRX(RXN,"SIG")),"^") D SIGONE^PSOHELP S SIG=$E($G(INS1),2,250)
"RTN","PSORXVW",71,0)
 . D WORDWRAP^PSOUTLA2(SIG,.IEN,$NA(^TMP("PSOAL",$J)),21)
"RTN","PSORXVW",72,0)
 S SIGOK=1
"RTN","PSORXVW",73,0)
 F I=0:0 S I=$O(^PSRX(RXN,"SIG1",I)) Q:'I  D
"RTN","PSORXVW",74,0)
 . S MIG=^PSRX(RXN,"SIG1",I,0)
"RTN","PSORXVW",75,0)
 . D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAL",$J)),21)
"RTN","PSORXVW",76,0)
 S SIGOK=1 K MIG,SG
"RTN","PSORXVW",77,0)
PTST S $P(RN," ",25)=" ",PTST=$S($G(^PS(53,+$P(RX0,"^",3),0))]"":$P($G(^PS(53,+$P(RX0,"^",3),0)),"^"),1:""),IEN=IEN+1
"RTN","PSORXVW",78,0)
 S ^TMP("PSOAL",$J,IEN,0)="      Patient Status: "_PTST_$E(RN,$L(PTST)+1,25)
"RTN","PSORXVW",79,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="          Issue Date: "_$E($P(RX0,"^",13),4,5)_"/"_$E($P(RX0,"^",13),6,7)_"/"_$E($P(RX0,"^",13),2,3)
"RTN","PSORXVW",80,0)
 S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"                 Fill Date: "_$E($P(RX2,"^",2),4,5)_"/"_$E($P(RX2,"^",2),6,7)_"/"_$E($P(RX2,"^",2),2,3)
"RTN","PSORXVW",81,0)
 S ROU=$S($P(RX0,"^",11)="W":"Window",1:"Mail")
"RTN","PSORXVW",82,0)
 S REFL=$P(RX0,"^",9),I=0 F  S I=$O(^PSRX(RXN,1,I)) Q:'I  S REFL=REFL-1,ROU=$S($P(^PSRX(RXN,1,I,0),"^",2)="W":"Window",1:"Mail")
"RTN","PSORXVW",83,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="      Last Fill Date: "_$E($P(RX3,"^"),4,5)_"/"_$E($P(RX3,"^"),6,7)_"/"_$E($P(RX3,"^"),2,3)
"RTN","PSORXVW",84,0)
 D CMOP^PSOORNE3 S DA=RXN
"RTN","PSORXVW",85,0)
 S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_" ("_ROU_$S($G(PSOCMOP)]"":", "_PSOCMOP,1:"")_")" K ROU,PSOCMOP
"RTN","PSORXVW",86,0)
 S IEN=IEN+1 I $P(RX2,"^",15) S ^TMP("PSOAL",$J,IEN,0)="   Returned to Stock: "_$E($P(RX2,"^",15),4,5)_"/"_$E($P(RX2,"^",15),6,7)_"/"_$E($P(RX2,"^",15),2,3)
"RTN","PSORXVW",87,0)
 E  S ^TMP("PSOAL",$J,IEN,0)="   Last Release Date: " D
"RTN","PSORXVW",88,0)
 .S RLD=$S($P(RX2,"^",13):$E($P(RX2,"^",13),4,5)_"/"_$E($P(RX2,"^",13),6,7)_"/"_$E($P(RX2,"^",13),2,3),1:"")
"RTN","PSORXVW",89,0)
 .I $O(^PSRX(RXN,1,0)) F I=0:0 S I=$O(^PSRX(RXN,1,I)) Q:'I  D
"RTN","PSORXVW",90,0)
 ..I $P(^PSRX(RXN,1,I,0),"^",18) S RLD=$E($P(^(0),"^",18),4,5)_"/"_$E($P(^(0),"^",18),6,7)_"/"_$E($P(^(0),"^",18),2,3)
"RTN","PSORXVW",91,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_$S($G(RLD)]"":RLD,1:"        ")
"RTN","PSORXVW",92,0)
 S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"                     Lot #: "_$P(RX2,"^",4)
"RTN","PSORXVW",93,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="             Expires: "_$E($P(RX2,"^",6),4,5)_"/"_$E($P(RX2,"^",6),6,7)_"/"_$E($P(RX2,"^",6),2,3)
"RTN","PSORXVW",94,0)
 S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"                       MFG: "_$P($G(RX2),"^",8)
"RTN","PSORXVW",95,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="         Days Supply: "_$P(RX0,"^",8)_$S($L($P(RX0,"^",8))=1:" ",1:"")
"RTN","PSORXVW",96,0)
 S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"                        QTY"_$S($P($G(^PSDRUG($P(RX0,"^",6),660)),"^",8)]"":" ("_$P($G(^PSDRUG($P(RX0,"^",6),660)),"^",8)_")",1:" (  )")_": "_$P(RX0,"^",7)
"RTN","PSORXVW",97,0)
 I $P($G(^PSDRUG($P(RX0,"^",6),5)),"^")]"" D
"RTN","PSORXVW",98,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSORXVW",99,0)
 .S ^TMP("PSOAL",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG($P(RX0,"^",6),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG($P(RX0,"^",6),5),"^") K RN
"RTN","PSORXVW",100,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="        # of Refills: "_$P(RX0,"^",9)_$S($L($P(RX0,"^",9))=1:" ",1:"")_"                       Remaining: "_REFL
"RTN","PSORXVW",101,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="            Provider: "_$S($D(^VA(200,$P(RX0,"^",4),0)):$P(^VA(200,$P(RX0,"^",4),0),"^"),1:"UNKNOWN")
"RTN","PSORXVW",102,0)
 N DEAV S DEAV=+$P($G(^PSDRUG(+$P(RX0,"^",6),0)),"^",3) I DEAV>1,DEAV<6 D PRV K DEAV
"RTN","PSORXVW",103,0)
 I $P(RX3,"^",3) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="        Cos-Provider: "_$P(^VA(200,$P(RX3,"^",3),0),"^")
"RTN","PSORXVW",104,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="             Routing: "_$S($P(RX0,"^",11)="W":"Window",1:"Mail")
"RTN","PSORXVW",105,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="              Copies: "_$S($P(RX0,"^",18):$P(RX0,"^",18),1:1)
"RTN","PSORXVW",106,0)
 S:$P(RX0,"^",11)="W" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="    Method of Pickup: "_$G(^PSRX(RXN,"MP"))
"RTN","PSORXVW",107,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="              Clinic: "_$S($D(^SC(+$P(RX0,"^",5),0)):$P(^SC($P(RX0,"^",5),0),"^"),1:"Not on File")
"RTN","PSORXVW",108,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="            Division: "_$P(^PS(59,$P(RX2,"^",9),0),"^")_" ("_$P(^(0),"^",6)_")"
"RTN","PSORXVW",109,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="          Pharmacist: "_$S($P(RX2,"^",3):$P(^VA(200,$P(RX2,"^",3),0),"^"),1:"")
"RTN","PSORXVW",110,0)
 S:$P(RX2,"^",10)&('$G(PSOCOPY)) IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="         Verified By: "_$P(^VA(200,$P(RX2,"^",10),0),"^")
"RTN","PSORXVW",111,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="  Patient Counseling: "_$S($P($G(^PSRX(RXN,"PC")),"^"):"YES",1:"NO")_"                      "_$S($P($G(^PSRX(RXN,"PC")),"^"):"Was Counseling Understood: "_$S($P($G(^PSRX(RXN,"PC")),"^",2):"YES",1:"NO"),1:"")
"RTN","PSORXVW",112,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="             Remarks: "_$P(RX3,"^",7)
"RTN","PSORXVW",113,0)
 D PC^PSORXVW1
"RTN","PSORXVW",114,0)
 I $P($G(^PSRX(DA,"OR1")),"^",5) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="         Finished By: "_$P(^VA(200,$P(^PSRX(DA,"OR1"),"^",5),0),"^")
"RTN","PSORXVW",115,0)
 D ^PSORXVW1 S PSOAL=IEN K IEN,ACT,LBL,LOG
"RTN","PSORXVW",116,0)
 I ST<12,$P(RX2,"^",6)<DT S ST=11
"RTN","PSORXVW",117,0)
 S VALM("TITLE")="Rx View "_"("_$P("Error^Active^Non-Verified^Refill^Hold^Non-Verified^Suspended^^^^^Done^Expired^Discontinued^Deleted^Discontinued^Discontinued (Edit)^Provider Hold^","^",ST+2)_")"
"RTN","PSORXVW",118,0)
 S:$P($G(^PSRX(DA,"PKI")),"^") VALMSG="Digitally Signed Order"
"RTN","PSORXVW",119,0)
 ;
"RTN","PSORXVW",120,0)
 ; pso*7*385 - esg - if being called by the BPSVRX routine, call HDR^PSOLMUTL to build the VALMHDR array and then Quit
"RTN","PSORXVW",121,0)
 I $G(BPSVRX) D HDR^PSOLMUTL Q
"RTN","PSORXVW",122,0)
 ;
"RTN","PSORXVW",123,0)
 D EN^PSOORAL,KILL I $G(PS)="VIEW" G PSORXVW
"RTN","PSORXVW",124,0)
 K:$G(PS)="VIEW" DA K PS
"RTN","PSORXVW",125,0)
 Q
"RTN","PSORXVW",126,0)
 ;
"RTN","PSORXVW",127,0)
KILL K ^TMP("PSOAL",$J),PSOAL,IEN,^TMP("PSOHDR",$J) I $G(PS)="VIEW" K DA
"RTN","PSORXVW",128,0)
 K ST,RFL,RFLL,RFL1,ST,II,J,N,PHYS,L1,DIRUT,PSDIV,PSEXDT,MED,M1,FFX,DTT,DAT,RX0,RX2,R3,RTN,SIG,STA,P1,PL,P0,Z0,Z1,EXDT,IFN,DIR,DUOUT,DTOUT,PSOELSE
"RTN","PSORXVW",129,0)
 K LBL,I,RFDATE,%H,%I,RN,RFT,%,%I,DFN,GMRA,GMRAL,HDR,POERR,PTST,REFL,RF,RLD,RX3
"RTN","PSORXVW",130,0)
 K RXN,RXOR,SG,VA,VADM,VAERR,VALMBCK,VAPA,X,DIC,REA,ZD,PSOHD,PSOBCK,PSODFN,QUIT
"RTN","PSORXVW",131,0)
 Q
"RTN","PSORXVW",132,0)
 ;
"RTN","PSORXVW",133,0)
PRV       ;
"RTN","PSORXVW",134,0)
 N DETN,DEA,LBL,VADD,SPC,ORN S ORN=$P(^PSRX(RXN,"OR1"),"^",2)
"RTN","PSORXVW",135,0)
 S DEA=$$DEA^XUSER(0,$P(RX0,"^",4))
"RTN","PSORXVW",136,0)
 S LBL=$S(DEA["-":"  VA#: ",1:" DEA#: ")
"RTN","PSORXVW",137,0)
 S $P(SPC," ",(28-$L(DEA)))=" "
"RTN","PSORXVW",138,0)
 I $$DETOX^PSSOPKI($P(RX0,"^",6)) S DETN=$$DETOX^XUSER($P(RX0,"^",4))
"RTN","PSORXVW",139,0)
 I (DEA'="")!($G(DETN)'="") S IEN=IEN+1,$E(^TMP("PSOAL",$J,IEN,0),16)=LBL_DEA_$S($G(DETN)]"":SPC_"DETOX#: "_$G(DETN),1:"")
"RTN","PSORXVW",140,0)
 D PRVAD^PSOPKIV2
"RTN","PSORXVW",141,0)
 I $G(VADD(1))]"" D
"RTN","PSORXVW",142,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="        Site Address: "_VADD(1)
"RTN","PSORXVW",143,0)
 .S:VADD(2)]"" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="                      "_VADD(2) S:VADD(3)]"" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="                      "_VADD(3)
"RTN","PSORXVW",144,0)
 Q
"RTN","PSORXVW",145,0)
 ;
"RTN","PSOSIG")
0^60^B70480726^B70011572
"RTN","PSOSIG",1,0)
PSOSIG ;BIR/RTR-Utility to create SIG ;6/04/00
"RTN","PSOSIG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,99,114,391,313**;DEC 1997;Build 76
"RTN","PSOSIG",3,0)
 ;External reference to PS(51 supported by DBIA 2224
"RTN","PSOSIG",4,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOSIG",5,0)
 ;External reference to PSDRUG( supported by DBIA 221
"RTN","PSOSIG",6,0)
 ;
"RTN","PSOSIG",7,0)
EN(PSOSIGX) ;
"RTN","PSOSIG",8,0)
 N VARIABLE
"RTN","PSOSIG",9,0)
 Q
"RTN","PSOSIG",10,0)
SCH ;SCH = schedule entered     SCHEX = expanded schedule
"RTN","PSOSIG",11,0)
 N SQFLAG,SCLOOP,SCLP,SCLPS,SCLHOLD,SCIN,SODL,SST
"RTN","PSOSIG",12,0)
 K SCHEX S SQFLAG=0
"RTN","PSOSIG",13,0)
 I $G(SCH)="" S SCHEX="" Q
"RTN","PSOSIG",14,0)
 I SCH[""""!($A(SCH)=45)!(SCH?.E1C.E)!($L(SCH," ")>3)!($L(SCH)>20)!($L(SCH)<1) K SCH Q
"RTN","PSOSIG",15,0)
 N PSOSCUP S SCH=$$UPPER(SCH)
"RTN","PSOSIG",16,0)
 F SCLOOP=0:0 S SCLOOP=$O(^PS(51.1,"B",SCH,SCLOOP)) Q:'SCLOOP!(SQFLAG)  I $P($G(^PS(51.1,SCLOOP,0)),"^",8)'="" S SCHEX=$P($G(^(0)),"^",8),SQFLAG=1
"RTN","PSOSIG",17,0)
 Q:SQFLAG
"RTN","PSOSIG",18,0)
 I $P($G(^PS(51,"A",SCH)),"^")'="" S SCHEX=$P(^(SCH),"^") Q
"RTN","PSOSIG",19,0)
 S SCLOOP=0 F SCLP=1:1:$L(SCH) S SCLPS=$E(SCH,SCLP) I SCLPS=" " S SCLOOP=SCLOOP+1
"RTN","PSOSIG",20,0)
 I SCLOOP=0 S SCHEX=SCH Q
"RTN","PSOSIG",21,0)
 S SCLOOP=SCLOOP+1
"RTN","PSOSIG",22,0)
 K SCLHOLD F SCIN=1:1:SCLOOP S (SODL,SCLHOLD(SCIN))=$P(SCH," ",SCIN) D
"RTN","PSOSIG",23,0)
 .Q:$G(SODL)=""
"RTN","PSOSIG",24,0)
 .S SQFLAG=0 F SST=0:0 S SST=$O(^PS(51.1,"B",SODL,SST)) Q:'SST!($G(SQFLAG))  I $P($G(^PS(51.1,SST,0)),"^",8)'="" S SCLHOLD(SCIN)=$P($G(^(0)),"^",8),SQFLAG=1
"RTN","PSOSIG",25,0)
 .Q:$G(SQFLAG)
"RTN","PSOSIG",26,0)
 .I $P($G(^PS(51,"A",SODL)),"^")'="" S SCLHOLD(SCIN)=$P(^(SODL),"^")
"RTN","PSOSIG",27,0)
 S SCHEX="",SQFLAG=0 F SST=1:1:SCLOOP S SCHEX=SCHEX_$S($G(SQFLAG):" ",1:"")_$G(SCLHOLD(SST)),SQFLAG=1
"RTN","PSOSIG",28,0)
 Q
"RTN","PSOSIG",29,0)
QTY(PSOQX) ;
"RTN","PSOSIG",30,0)
 N QDOSE
"RTN","PSOSIG",31,0)
 K PSOQX("QTY")
"RTN","PSOSIG",32,0)
 I $G(PSOFDR),'$G(CPRN) N PSOQTYQT,PSOLPSD S PSOQTYQT=0 D  I $G(PSOQTYQT) Q
"RTN","PSOSIG",33,0)
 .S PSOLPSD="" F  S PSOLPSD=$O(PSONEW("SCHEDULE",PSOLPSD)) Q:PSOLPSD=""!(PSOQTYQT)  I $G(PSONEW("SCHEDULE",PSOLPSD))["PRN"!($G(PSONEW("SCHEDULE",PSOLPSD))["prn")!($G(PSONEW("SCHEDULE",PSOLPSD))["Prn") S PSOQTYQT=1 Q
"RTN","PSOSIG",34,0)
 N PSOOUTQT S PSOOUTQT=1
"RTN","PSOSIG",35,0)
QTYCP ;CPRS qty call comes through here
"RTN","PSOSIG",36,0)
 N PSQQUIT,QTSH,PSQ,PSQMIN,PSQMINZ,PSOQRND,PSOLOWER,PSOLOWX,PSOLOWXL,PSOLOWST
"RTN","PSOSIG",37,0)
 K PSOFRQ S PSQQUIT=0
"RTN","PSOSIG",38,0)
 I '$G(PSOCPRQT) S QDOSE=0 F PSQ=0:0 S PSQ=$O(PSOQX("DOSE",PSQ)) Q:'PSQ  S QDOSE=PSQ S:'$G(PSOQX("DOSE ORDERED",PSQ)) PSQQUIT=1
"RTN","PSOSIG",39,0)
 ;Q:PSQQUIT!('QDOSE)
"RTN","PSOSIG",40,0)
 I '$G(PSOCPRQT) Q:PSQQUIT
"RTN","PSOSIG",41,0)
 Q:'$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",42,0)
 Q:'$G(QDOSE)
"RTN","PSOSIG",43,0)
 G:QDOSE>1 COMP
"RTN","PSOSIG",44,0)
 Q:'$G(PSOQX("DOSE ORDERED",1))
"RTN","PSOSIG",45,0)
 Q:'$G(PSOQX("DAYS SUPPLY"))&('$G(PSOQX("DURATION",1)))
"RTN","PSOSIG",46,0)
 S PSOLOWER=0
"RTN","PSOSIG",47,0)
 I $G(PSOQX("DURATION",1)) D
"RTN","PSOSIG",48,0)
 .S PSOLOWX=$L(PSOQX("DURATION",1))
"RTN","PSOSIG",49,0)
 .S PSOLOWXL=$S($E(PSOQX("DURATION",1),PSOLOWX)="M":1,$E(PSOQX("DURATION",1),PSOLOWX)="H":60,$E(PSOQX("DURATION",1),PSOLOWX)="S":.01666,$E(PSOQX("DURATION",1),PSOLOWX)="W":10080,$E(PSOQX("DURATION",1),PSOLOWX)="L":43200,1:1440)
"RTN","PSOSIG",50,0)
 .S PSOLOWER=PSOLOWXL*(+$G(PSOQX("DURATION",1)))
"RTN","PSOSIG",51,0)
 S PSOLOWX=0 I +$G(PSOQX("DAYS SUPPLY")) S PSOLOWX=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",52,0)
 Q:'$G(PSOLOWER)&('$G(PSOLOWX))
"RTN","PSOSIG",53,0)
 S QTSH=$G(PSOQX("SCHEDULE",1)) D QTS Q:PSQQUIT!('$G(PSOFRQ))
"RTN","PSOSIG",54,0)
 S PSOLOWST=$S('$G(PSOLOWER):$G(PSOLOWX),'$G(PSOLOWX):$G(PSOLOWER),$G(PSOLOWER)>$G(PSOLOWX):$G(PSOLOWX),$G(PSOLOWX)>$G(PSOLOWER):$G(PSOLOWER),$G(PSOLOWX)=$G(PSOLOWER):$G(PSOLOWER),1:0)
"RTN","PSOSIG",55,0)
 Q:'$G(PSOLOWST)
"RTN","PSOSIG",56,0)
 S PSQMIN=+$G(PSOLOWST)
"RTN","PSOSIG",57,0)
 S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIG",58,0)
 S PSOQRND=PSQMINZ*+$G(PSOQX("DOSE ORDERED",1)) Q:'PSOQRND
"RTN","PSOSIG",59,0)
 D ROUND G QEND
"RTN","PSOSIG",60,0)
 Q
"RTN","PSOSIG",61,0)
COMP ;COMPLEX DOSE HERE
"RTN","PSOSIG",62,0)
 N PSOQEXC,PSOQAND,PSOQTHEN,PSQL,PSQMNL,PSQMNLX,PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSQ1,PSODUX,PSODUXX,PSODSMIN
"RTN","PSOSIG",63,0)
 ;PSODUTOT = TOTAL OF ALL DURATIONS
"RTN","PSOSIG",64,0)
 ;PSODUDIF = DIFF. OF DURATION VS DAYS SUPPLY
"RTN","PSOSIG",65,0)
 ;PSODUMIS = # OF SEQUENCES MISSING A DURATION IF >1 CAN'T DEFAULT
"RTN","PSOSIG",66,0)
 ;PSODUREP = SEQUENCE # THAT IS MISSING DURATION
"RTN","PSOSIG",67,0)
 ;PSODSMIN = MINUTES OF DAYS SUPPLY
"RTN","PSOSIG",68,0)
 S (PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSODSMIN,PSOQAND,PSOQTHEN,PSOQEXC)=0
"RTN","PSOSIG",69,0)
 F PSQL=1:1:QDOSE S:$G(PSOQX("CONJUNCTION",PSQL))["A" PSOQAND=1 S:$G(PSOQX("CONJUNCTION",PSQL))["T" PSOQTHEN=1 S:$G(PSOQX("CONJUNCTION",PSQL))["X" PSOQEXC=1
"RTN","PSOSIG",70,0)
 I $G(PSOQEXC) G QEND
"RTN","PSOSIG",71,0)
 I $G(PSOQAND) G COMP^PSOSIGCX
"RTN","PSOSIG",72,0)
 F PSQ1=1:1:QDOSE D  Q:PSODUMIS>1
"RTN","PSOSIG",73,0)
 .I '$G(PSOQX("DURATION",PSQ1)) S PSODUMIS=PSODUMIS+1,PSODUREP=PSQ1 Q
"RTN","PSOSIG",74,0)
 .S PSODUX=$L(PSOQX("DURATION",PSQ1))
"RTN","PSOSIG",75,0)
 .S PSODUXX=$S($E(PSOQX("DURATION",PSQ1),PSODUX)="M":1,$E(PSOQX("DURATION",PSQ1),PSODUX)="H":60,$E(PSOQX("DURATION",PSQ1),PSODUX)="S":.01666,$E(PSOQX("DURATION",PSQ1),PSODUX)="W":10080,$E(PSOQX("DURATION",PSQ1),PSODUX)="L":43200,1:1440)
"RTN","PSOSIG",76,0)
 .S PSODUTOT=PSODUTOT+(PSODUXX*(+$G(PSOQX("DURATION",PSQ1))))
"RTN","PSOSIG",77,0)
 G:PSODUMIS>1 QEND ; More than 1 sequence missing a duration
"RTN","PSOSIG",78,0)
 I $G(PSODUMIS),'$G(PSOQX("DAYS SUPPLY")) G QEND ; missing 1 duration, no days supply
"RTN","PSOSIG",79,0)
 S PSODSMIN=1440*+$G(PSOQX("DAYS SUPPLY"))
"RTN","PSOSIG",80,0)
 I $G(PSODSMIN),$G(PSODSMIN)<$G(PSODUTOT) G QEND
"RTN","PSOSIG",81,0)
 I '$G(PSODUMIS),$G(PSODSMIN),$G(PSODUTOT)>$G(PSODSMIN) G QEND ; no missing durations, but total durations are greater than days supply
"RTN","PSOSIG",82,0)
 I $G(PSODUMIS),$G(PSODSMIN),$G(PSODSMIN)'>$G(PSODUTOT) G QEND ; 1 missing duration, and total of other durations are not less than days supply
"RTN","PSOSIG",83,0)
 I '$G(PSODSMIN),$G(PSODUMIS) G QEND ; no days supply, missing a duration
"RTN","PSOSIG",84,0)
 I $G(PSODUREP) S PSODUDIF=$G(PSODSMIN)-$G(PSODUTOT)
"RTN","PSOSIG",85,0)
 F PSQ=1:1:QDOSE D  Q:$G(PSQQUIT)
"RTN","PSOSIG",86,0)
 .I '$G(PSOQX("DOSE ORDERED",PSQ))!($G(PSOQX("SCHEDULE",PSQ))="") S PSQQUIT=1 Q
"RTN","PSOSIG",87,0)
 .S QTSH=$G(PSOQX("SCHEDULE",PSQ)) D QTS S:'$G(PSOFRQ) PSQQUIT=1 Q:$G(PSQQUIT)
"RTN","PSOSIG",88,0)
 .I $G(PSOQX("DURATION",PSQ)) S PSQMNL=$L(PSOQX("DURATION",PSQ)) D
"RTN","PSOSIG",89,0)
 ..S PSQMNLX=$S($E(PSOQX("DURATION",PSQ),PSQMNL)="M":1,$E(PSOQX("DURATION",PSQ),PSQMNL)="H":60,$E(PSOQX("DURATION",PSQ),PSQMNL)="S":.01666,$E(PSOQX("DURATION",PSQ),PSQMNL)="W":10080,$E(PSOQX("DURATION",PSQ),PSQMNL)="L":43200,1:1440)
"RTN","PSOSIG",90,0)
 ..S PSQMIN=PSQMNLX*(+$G(PSOQX("DURATION",PSQ)))
"RTN","PSOSIG",91,0)
 .I '$G(PSOQX("DURATION",PSQ)) S PSQMIN=$G(PSODUDIF)
"RTN","PSOSIG",92,0)
 .S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIG",93,0)
 .S PSOQRND=$S('$G(PSOQRND):PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ)),1:$G(PSOQRND)+(PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ))))
"RTN","PSOSIG",94,0)
 I $G(PSQQUIT) G QEND
"RTN","PSOSIG",95,0)
 I $G(PSOQRND) D ROUND
"RTN","PSOSIG",96,0)
 G QEND
"RTN","PSOSIG",97,0)
QTS ;Find frequency
"RTN","PSOSIG",98,0)
 ;QTSH = SHCEDULE
"RTN","PSOSIG",99,0)
 ;either return PSOFRQ for frequency or PSSQUIT for no frequency
"RTN","PSOSIG",100,0)
 N SQTFLAG,SQQT,ZZQT,ZZQ,ZZQQ,ZQHOLD,QGLFLAG,PZQT,ZDL,ZZQX
"RTN","PSOSIG",101,0)
 K PSOFRQ
"RTN","PSOSIG",102,0)
 S (QGLFLAG,ZZQX)=0
"RTN","PSOSIG",103,0)
 I $G(QTSH)="" S PSQQUIT=1 Q
"RTN","PSOSIG",104,0)
 S SQTFLAG=0 F SQQT=0:0 S SQQT=$O(^PS(51.1,"B",QTSH,SQQT)) Q:'SQQT!($G(SQTFLAG))  I $P($G(^PS(51.1,SQQT,0)),"^",3) S PSOFRQ=$P($G(^(0)),"^",3),SQTFLAG=1
"RTN","PSOSIG",105,0)
 Q:SQTFLAG
"RTN","PSOSIG",106,0)
 F SQQT=0:0 S SQQT=$O(^PS(51,"B",QTSH,SQQT)) Q:'SQQT!($G(SQTFLAG))  I $P($G(^PS(51,SQQT,0)),"^",8) S PSOFRQ=$P($G(^(0)),"^",8),SQTFLAG=1
"RTN","PSOSIG",107,0)
 Q:SQTFLAG
"RTN","PSOSIG",108,0)
 S ZZQT=0 F ZZQ=1:1:$L(QTSH) S ZZQQ=$E(QTSH,ZZQ) I ZZQQ=" " S ZZQT=ZZQT+1
"RTN","PSOSIG",109,0)
 I 'ZZQT S PSQQUIT=1 Q
"RTN","PSOSIG",110,0)
 S ZZQT=ZZQT+1
"RTN","PSOSIG",111,0)
 K ZQHOLD S QGLFLAG=0 F PZQT=1:1:ZZQT S (ZDL,ZQHOLD)=$P(QTSH," ",PZQT) D
"RTN","PSOSIG",112,0)
 .Q:$G(ZDL)=""
"RTN","PSOSIG",113,0)
 .S ZZQX=0 F SQQT=0:0 S SQQT=$O(^PS(51.1,"B",ZDL,SQQT)) Q:'SQQT!($G(ZZQX))  I $P($G(^PS(51.1,SQQT,0)),"^",3) S PSOFRQ=$P($G(^(0)),"^",3),ZZQX=1,QGLFLAG=QGLFLAG+1
"RTN","PSOSIG",114,0)
 .Q:ZZQX
"RTN","PSOSIG",115,0)
 .S ZZQX=0 F SQQT=0:0 S SQQT=$O(^PS(51,"B",ZDL,SQQT)) Q:'SQQT!($G(ZZQX))  I $P($G(^PS(51,SQQT,0)),"^",8) S PSOFRQ=$P($G(^(0)),"^",8),ZZQX=1,QGLFLAG=QGLFLAG+1
"RTN","PSOSIG",116,0)
 I $G(QGLFLAG)>1 K PSOFRQ
"RTN","PSOSIG",117,0)
 I '$G(PSOFRQ) S PSQQUIT=1
"RTN","PSOSIG",118,0)
 Q
"RTN","PSOSIG",119,0)
QEND ;
"RTN","PSOSIG",120,0)
 ; PSOMTFLG variable indicates a Maintenance Rx (Titration/Maintenance)
"RTN","PSOSIG",121,0)
 K PSOFRQ
"RTN","PSOSIG",122,0)
 I $G(PSOOUTQT),$G(QTYHLD),$G(PSOQX("QTY")),$G(QTYHLD)'=$G(PSOQX("QTY")) W !!!,"Quantity has been changed from "_QTYHLD_" to "_PSOQX("QTY") D  I '$G(PSOMTFLG) W ! N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOSIG",123,0)
 .I $G(PSONEW("FLD"))=8,$P($G(OR0),"^",24),$G(PSODRUG("IEN")),$D(^PSDRUG(+$G(PSODRUG("IEN")),0)) D
"RTN","PSOSIG",124,0)
 ..I $P(^PSDRUG(PSODRUG("IEN"),0),"^",3)[2!($P(^PSDRUG(PSODRUG("IEN"),0),"^",3)["F") Q
"RTN","PSOSIG",125,0)
 ..N ZRFA S ZRFA=$S($G(CLOZPAT)=2&(PSOQX("DAYS SUPPLY")=14):1,$G(CLOZPAT)=2&(PSOQX("DAYS SUPPLY")=7):3,$G(CLOZPAT)=1&(PSOQX("DAYS SUPPLY")=7):1,$D(CLOZPAT):0,1:5)
"RTN","PSOSIG",126,0)
 ..N ZREF,ZTQ S ZREF=QTYHLD\PSOQX("QTY") I ZREF>0 D
"RTN","PSOSIG",127,0)
 ...S ZTQ=QTYHLD*(PSOQX("# OF REFILLS")+1),ZTQ=ZTQ-PSOQX("QTY"),ZREF=ZTQ\PSOQX("QTY") S:ZREF>ZRFA ZREF=ZRFA
"RTN","PSOSIG",128,0)
 ...I ZREF'=PSOQX("# OF REFILLS") W !,"# of Refills has been changed from "_PSOQX("# OF REFILLS")_" to "_ZREF S PSOQX("# OF REFILLS")=ZREF
"RTN","PSOSIG",129,0)
 Q
"RTN","PSOSIG",130,0)
ROUND ;
"RTN","PSOSIG",131,0)
 Q:'$G(PSOQRND)
"RTN","PSOSIG",132,0)
 I PSOQRND'["." S PSOQX("QTY")=PSOQRND Q
"RTN","PSOSIG",133,0)
 S PSOQX("QTY")=$P(PSOQRND,".")+1
"RTN","PSOSIG",134,0)
 Q
"RTN","PSOSIG",135,0)
DAY(DATE) ;First 5 digits of FileMan date
"RTN","PSOSIG",136,0)
 N X
"RTN","PSOSIG",137,0)
 I DATE'?5N Q -1
"RTN","PSOSIG",138,0)
 S X=$E(DATE,4,5) I X<1!(X>12) Q -1
"RTN","PSOSIG",139,0)
 S X=DATE+1+(X=12*88)_"01"
"RTN","PSOSIG",140,0)
 Q $E($$FMADD^XLFDT(X,-1),6,7)
"RTN","PSOSIG",141,0)
 ;
"RTN","PSOSIG",142,0)
QTYX(PSOQX) ;
"RTN","PSOSIG",143,0)
 N PSOQLP,PSOQLN,PSOQAR,PSOCPRQT,QDOSE,QDOSEX S PSOCPRQT=1 F PSOQLP=0:0 S PSOQLP=$O(PSOQX("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIG",144,0)
 .S PSOQAR("DURATION",PSOQLP)=$G(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIG",145,0)
 .I $E(PSOQX("DURATION",PSOQLP))?1A S PSOQLN=$L(PSOQX("DURATION",PSOQLP)) S PSOQX("DURATION",PSOQLP)=$E(PSOQX("DURATION",PSOQLP),2,PSOQLN)_$E(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIG",146,0)
 S QDOSE=0 F QDOSEX=0:0 S QDOSEX=$O(PSOQX("DOSE ORDERED",QDOSEX)) Q:'QDOSEX  S QDOSE=QDOSE+1
"RTN","PSOSIG",147,0)
 I '$G(PSOQX("QTY")) D QTYCP G QPASS
"RTN","PSOSIG",148,0)
 D QTYCP^PSOSIGDS
"RTN","PSOSIG",149,0)
QPASS F PSOQLP=0:0 S PSOQLP=$O(PSOQAR("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIG",150,0)
 .S PSOQX("DURATION",PSOQLP)=$G(PSOQAR("DURATION",PSOQLP))
"RTN","PSOSIG",151,0)
 K PSOCPRQT
"RTN","PSOSIG",152,0)
 Q
"RTN","PSOSIG",153,0)
DAYS(PSOQX) ;Entry point for Days Supply calc for PSO
"RTN","PSOSIG",154,0)
 ;Kill days supply here
"RTN","PSOSIG",155,0)
 Q:'$G(PSOQX("QTY"))
"RTN","PSOSIG",156,0)
 D QTYOPS^PSOSIGDS
"RTN","PSOSIG",157,0)
 Q
"RTN","PSOSIG",158,0)
 ;
"RTN","PSOSIG",159,0)
UPPER(PSOSCUP) ;
"RTN","PSOSIG",160,0)
 Q $TR(PSOSCUP,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSOUTL")
0^22^B132826044^B125518087
"RTN","PSOUTL",1,0)
PSOUTL ;BHAM ISC/SAB - pso utility routine ;4/28/09 4:14pm
"RTN","PSOUTL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,21,126,174,218,259,324,390,313**;DEC 1997;Build 76
"RTN","PSOUTL",3,0)
 ;External reference SERV^IBARX1 supported by DBIA 2245
"RTN","PSOUTL",4,0)
 ;External reference ^PS(55,     supported by DBIA 2228
"RTN","PSOUTL",5,0)
 ;External reference ^PSSDIUTL is supported by DBIA# 5737.
"RTN","PSOUTL",6,0)
 ;
"RTN","PSOUTL",7,0)
 ;*218 prevent refill from being deleted if pending processing via
"RTN","PSOUTL",8,0)
 ; external dispense machines
"RTN","PSOUTL",9,0)
 ;*259 reverse *218 restrictions & Add del only last refill logic.
"RTN","PSOUTL",10,0)
 ;
"RTN","PSOUTL",11,0)
SUSPCAN ;dcl rx from suspense used in new, renew AND verification of Rxs
"RTN","PSOUTL",12,0)
 S PSLAST=0 F PSI=0:0 S PSI=$O(^PSRX(PSRX,1,PSI)) Q:'PSI  S PSLAST=PSI
"RTN","PSOUTL",13,0)
 I PSLAST S PSI=^PSRX(PSRX,1,PSLAST,0) K ^PSRX(PSRX,1,PSLAST),^PSRX(PSRX,1,"B",+PSI,PSLAST) S ^(0)=$P(^PSRX(PSRX,1,0),"^",1,3)_"^"_($P(^(0),"^",4)-1) K PSLAST,PSI,SUSX,SUS1,SUS2 Q
"RTN","PSOUTL",14,0)
 S $P(^PSRX(PSRX,3),"^",7)="DISCONTINUED FROM SUSPENSE BEFORE FILLING" K PSI,SUSX,SUS1,SUS2 Q
"RTN","PSOUTL",15,0)
 ;
"RTN","PSOUTL",16,0)
ACTLOG ;
"RTN","PSOUTL",17,0)
 F PSI=0:0 S PSI=$O(^PSRX(PSRX,"A",PSI)) I 'PSI!'$O(^(PSI)) S ^PSRX(PSRX,"A",+PSI+1,0)=DT_"^"_PSREA_"^"_PSOCLC_"^"_PSRXREF_"^"_PSMSG,^PSRX(PSRX,"A",0)="^52.3DA^"_(+PSI+1)_"^"_(+PSI+1) Q
"RTN","PSOUTL",18,0)
ACTOUT I PSREA="C" S PSI=$S($D(^PSRX(PSRX,2)):+$P(^(2),"^",6),1:0) K:$D(^PS(55,PSDFN,"P","A",PSI,PSRX)) ^(PSRX) S ^PS(55,PSDFN,"P","A",DT,PSRX)="" Q
"RTN","PSOUTL",19,0)
 I PSREA="R" F PSI=0:0 S PSI=$O(^PSRX(PSRX,"A",PSI)) Q:'PSI  I $D(^(PSI,0)),$P(^(0),"^",2)="C" S PSS=+^(0)
"RTN","PSOUTL",20,0)
 I $D(PSS),PSS K:$D(^PS(55,PSDFN,"P","A",PSS,PSRX)) ^(PSRX)
"RTN","PSOUTL",21,0)
 I PSREA="R",$D(^PSRX(PSRX,2))#2 S ^PS(55,PSDFN,"P","A",+$P(^PSRX(PSRX,2),"^",6),PSRX)=""
"RTN","PSOUTL",22,0)
 Q
"RTN","PSOUTL",23,0)
 ;
"RTN","PSOUTL",24,0)
QUES ;INSTRUCTIONS FOR RENEW AND REFILL
"RTN","PSOUTL",25,0)
 W !?5,"Enter the item #(s) or RX #(s) you wish to ",$S(PSFROM="N":"renew ",PSFROM="R":"REFILL "),"separated by commas."
"RTN","PSOUTL",26,0)
 W !?5,"For example: 1,2,5 or 123456,33254A,232323B."
"RTN","PSOUTL",27,0)
 W !?5,"Do not enter the same number twice, duplicates are not allowed."
"RTN","PSOUTL",28,0)
 Q
"RTN","PSOUTL",29,0)
ENDVCHK S PSOPOP=0 Q:'PSODIV  Q:'$P(^PSRX(PSRX,2),"^",9)!($P(^(2),"^",9)=PSOSITE)
"RTN","PSOUTL",30,0)
CHK1 I '$P(PSOSYS,"^",2) W !?10,$C(7),"RX# ",$P(^PSRX(PSRX,0),"^")," is not a valid choice. (Different Division)" S PSPOP=1 Q
"RTN","PSOUTL",31,0)
 I $P(PSOSYS,"^",3) W !?10,$C(7),"RX# ",$P(^PSRX(PSRX,0),"^")," is from another division. Continue? (Y/N) " R ANS:DTIME I ANS="^"!(ANS="") S PSPOP=1 Q
"RTN","PSOUTL",32,0)
 I (ANS']"")!("YNyn"'[$E(ANS)) W !?10,$C(7),"Answer 'YES' or 'NO'." G CHK1
"RTN","PSOUTL",33,0)
 S:$E(ANS)["Nn" PSPOP=1 Q
"RTN","PSOUTL",34,0)
 ;PSO*7*259; SET VAR PSOSFN TO CHECK FOR SUSPENDED REFILL
"RTN","PSOUTL",35,0)
K52 K PSOSFN S SFN=+$O(^PS(52.5,"B",DA(1),0)),PSOSFN=SFN Q:SFN=0
"RTN","PSOUTL",36,0)
 I $P($G(^PS(52.5,SFN,0)),"^",5)=$P($G(^PSRX(+^PS(52.5,SFN,0),"P",0)),"^",3),$P($G(^PSRX($P(^PS(52.5,SFN,0),"^"),"P",0)),"^",4)=0 N PSOXX S PSOXX=1 G KILL
"RTN","PSOUTL",37,0)
 G:X'=""&($G(Y)=1) KILL I $G(Y)'=1,SFN I $D(^PS(52.5,SFN,0)),'$P(^(0),"^",5),'$P($G(^("P")),"^") D
"RTN","PSOUTL",38,0)
 .S SDT=+$P(^PS(52.5,SFN,0),"^",2) K ^PS(52.5,"C",SDT,SFN)
"RTN","PSOUTL",39,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="Q" K ^PS(52.5,"AQ",SDT,+$P(^PS(52.5,SFN,0),"^",3),SFN) D KCMPX^PSOCMOP(SFN,"Q")
"RTN","PSOUTL",40,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="" K ^PS(52.5,"AC",+$P(^PS(52.5,SFN,0),"^",3),SDT,SFN)
"RTN","PSOUTL",41,0)
 .K SFN,SDT
"RTN","PSOUTL",42,0)
 Q
"RTN","PSOUTL",43,0)
S52 S (RIFN,PSOSX)=0 F  S RIFN=$O(^PSRX(DA(1),1,RIFN)) Q:'RIFN  S RFID=$P(^PSRX(DA(1),1,RIFN,0),"^"),PSOSX=PSOSX+1
"RTN","PSOUTL",44,0)
 S SFN=+$O(^PS(52.5,"B",DA(1),0)) I SFN,'$G(^PS(52.5,SFN,"P")),$P($G(^PSRX($P($G(^PS(52.5,SFN,0)),"^"),"STA")),"^")=5 D
"RTN","PSOUTL",45,0)
 .I '$D(^PS(52.5,SFN,0))!($P($G(^(0)),"^",5)) Q
"RTN","PSOUTL",46,0)
 .S $P(^PS(52.5,SFN,0),"^",2)=RFID,^PS(52.5,"C",RFID,SFN)=""
"RTN","PSOUTL",47,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="Q" S ^PS(52.5,"AQ",RFID,+$P(^PS(52.5,SFN,0),"^",3),SFN)="" D SCMPX^PSOCMOP(SFN,"Q")
"RTN","PSOUTL",48,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="" S ^PS(52.5,"AC",+$P(^PS(52.5,SFN,0),"^",3),RFID,SFN)=""
"RTN","PSOUTL",49,0)
 K SFN,RFIN,RFID,PSOSX,PSOSXDT Q
"RTN","PSOUTL",50,0)
KILL N DFN
"RTN","PSOUTL",51,0)
 I SFN D
"RTN","PSOUTL",52,0)
 .S $P(^PSRX(DA(1),"STA"),"^")=0 Q:'$D(^PS(52.5,SFN,0))  S DFN=+$P(^PS(52.5,SFN,0),"^",3),PAT=$P(^DPT(DFN,0),"^")
"RTN","PSOUTL",53,0)
 .;I $P(^PS(52.5,SFN,0),"^",5) Q
"RTN","PSOUTL",54,0)
 .K ^PS(52.5,"B",+$P(^PS(52.5,SFN,0),"^"),SFN),^PS(52.5,"C",+$P(^PS(52.5,SFN,0),"^",2),SFN),^PS(52.5,"D",PAT,SFN),^PS(52.5,"AF",DFN,SFN)
"RTN","PSOUTL",55,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="" D
"RTN","PSOUTL",56,0)
 ..I $G(^PS(52.5,SFN,"P")) K ^PS(52.5,"AS",+$P(^(0),"^",8),+$P(^(0),"^",9),+$P(^(0),"^",6),+$P(^(0),"^",11),SFN),^PS(52.5,"ADL",$E(+$P(^PS(52.5,SFN,0),"^",8),1,7),SFN) Q
"RTN","PSOUTL",57,0)
 ..K ^PS(52.5,"AC",DFN,+$P(^PS(52.5,SFN,0),"^",2),SFN)
"RTN","PSOUTL",58,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)'="" D
"RTN","PSOUTL",59,0)
 ..;Kill CMOP xrefs
"RTN","PSOUTL",60,0)
 ..N PSOC7 S PSOC7=$P($G(^PS(52.5,SFN,0)),"^",7)
"RTN","PSOUTL",61,0)
 ..I PSOC7="Q"!(PSOC7="P") K ^PS(52.5,"AG",+$P(^PS(52.5,SFN,0),"^",3),SFN) D KCMPX^PSOCMOP(SFN,PSOC7)
"RTN","PSOUTL",62,0)
 ..I PSOC7="X"!(PSOC7="P")!(PSOC7="L") K ^PS(52.5,$S(PSOC7="X":"AX",PSOC7="P":"AP",1:"AL"),$P(^PS(52.5,SFN,0),"^",2),$P(^(0),"^",3),SFN) D KCMPX^PSOCMOP(SFN,PSOC7)
"RTN","PSOUTL",63,0)
 ..K ^PS(52.5,"APR",+$P(^PS(52.5,SFN,0),"^",8),+$P(^(0),"^",9),+$P(^(0),"^",6),+$P(^(0),"^",11),SFN),^PS(52.5,"ADL",$E(+$P(^PS(52.5,SFN,0),"^",8),1,7),SFN)
"RTN","PSOUTL",64,0)
 .K ^PS(52.5,SFN,0),^PS(52.5,SFN,"P"),DFN,SFN,PAT
"RTN","PSOUTL",65,0)
 S CNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA(1),"A",SUB)) Q:'SUB  S CNT=SUB
"RTN","PSOUTL",66,0)
 S:DA>5 DA=DA+1 D NOW^%DTC S CNT=CNT+1
"RTN","PSOUTL",67,0)
 S ^PSRX(DA(1),"A",0)="^52.3DA^"_CNT_"^"_CNT,^PSRX(DA(1),"A",CNT,0)=%_"^D^"_DUZ_"^"_DA_"^"
"RTN","PSOUTL",68,0)
 I '$D(PSOXX) S ^PSRX(DA(1),"A",CNT,0)=^PSRX(DA(1),"A",CNT,0)_"Refill "
"RTN","PSOUTL",69,0)
 ;if PSOXX not exist, = refill. otherwise, it is a partial.
"RTN","PSOUTL",70,0)
 S ^PSRX(DA(1),"A",CNT,0)=^PSRX(DA(1),"A",CNT,0)_$S($G(RESK):"returned to stock.",$G(PSOPSDAL):"deleted during Controlled Subs release.",$G(PSOXX)=1:"Partial deleted from suspense file.",1:"deleted during Rx edit.") K CNT,SUB
"RTN","PSOUTL",71,0)
 Q
"RTN","PSOUTL",72,0)
CID ;calculates six months limit on issue dates
"RTN","PSOUTL",73,0)
 S PSID=X,X="T-6M",%DT="X" D ^%DT S %DT(0)=Y,X=PSID,%DT="EX" D ^%DT K PSID
"RTN","PSOUTL",74,0)
 Q
"RTN","PSOUTL",75,0)
CIDH S X="T-6M",%DT="X" D ^%DT X ^DD("DD") D EN^DDIOL("Issue Date must be greater or equal to "_Y,"","!")
"RTN","PSOUTL",76,0)
 Q
"RTN","PSOUTL",77,0)
SPR F RF=0:0 S RF=$O(^PSRX(DA(1),1,RF)) Q:'RF  S NODE=RF
"RTN","PSOUTL",78,0)
 I NODE=1 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) Q
"RTN","PSOUTL",79,0)
SREF I $G(NODE) S NODE=NODE-1 G:'$D(^PSRX(DA(1),1,NODE,0)) SREF
"RTN","PSOUTL",80,0)
 I NODE=0 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) Q
"RTN","PSOUTL",81,0)
 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),1,NODE,0),"^",1) Q
"RTN","PSOUTL",82,0)
 K NODE,RF
"RTN","PSOUTL",83,0)
 Q
"RTN","PSOUTL",84,0)
KPR F RF=0:0 S RF=$O(^PSRX(DA(1),1,RF)) Q:'RF  S NODE=RF
"RTN","PSOUTL",85,0)
 I NODE=DA&(X'="") S NODE=NODE-1 S:NODE=1 NODE=0 G:'NODE ORIG G:NODE>1 KREF
"RTN","PSOUTL",86,0)
 I NODE=1 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) G EX
"RTN","PSOUTL",87,0)
KREF S NODE=NODE-1 G:'NODE EX
"RTN","PSOUTL",88,0)
 I NODE=1 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) G EX
"RTN","PSOUTL",89,0)
 G:NODE=DA&(X'="") KREF G:'$D(^PSRX(DA(1),1,NODE,0)) KREF
"RTN","PSOUTL",90,0)
ORIG I 'NODE S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) G EX
"RTN","PSOUTL",91,0)
 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),1,NODE,0),"^",1) G EX
"RTN","PSOUTL",92,0)
EX K NODE,RF
"RTN","PSOUTL",93,0)
 Q
"RTN","PSOUTL",94,0)
IBSS N PSOHLP S PSOHLP(1,"F")="!!"
"RTN","PSOUTL",95,0)
 S PSOHLP(1)="Entry in this field must match the SERVICE field for pharmacy action"
"RTN","PSOUTL",96,0)
 S PSOHLP(2,"F")="!"
"RTN","PSOUTL",97,0)
 S PSOHLP(2)="types in the IB ACTION TYPE file AND be a valid entry in your"
"RTN","PSOUTL",98,0)
 S PSOHLP(3,"F")="!"
"RTN","PSOUTL",99,0)
 S PSOHLP(3)="SERVICE/SECTION file to generate copay charges!"
"RTN","PSOUTL",100,0)
 S PSOHLP(4,"F")="!!"
"RTN","PSOUTL",101,0)
 D EN^DDIOL(.PSOHLP) K PSOHLP
"RTN","PSOUTL",102,0)
 Q
"RTN","PSOUTL",103,0)
IBSSR S PSOIBFL=0 F PSOIBLP=0:0 S PSOIBLP=$O(^DIC(49,PSOIBLP)) Q:'PSOIBLP!(PSOIBFL)  S Y=PSOIBLP,PSOIBST=$$SERV^IBARX1(+Y) I $G(PSOIBST) S DIE="^PS(59,",DA=PSOSITE,DR="1003////"_PSOIBLP D ^DIE K DIE D  S PSOIBFL=1
"RTN","PSOUTL",104,0)
 .W $C(7),!!,"There was an invalid entry in your IB SERVICE/SECTION field in your Outpatient",!,"Site Parameter file, but we have fixed the problem for you, and you",!,"may continue!" Q
"RTN","PSOUTL",105,0)
 Q
"RTN","PSOUTL",106,0)
WARN ;
"RTN","PSOUTL",107,0)
 I $G(PSOUNHLD) D  Q
"RTN","PSOUTL",108,0)
 .D EN^DDIOL("You cannot delete a refill while removing from Hold! Use the Edit Action.","","$C(7),!!"),EN^DDIOL(" ","","!!")
"RTN","PSOUTL",109,0)
 I $G(CMOP(DA))]""&(+$G(CMOP(DA))<3) D  K CMOP Q
"RTN","PSOUTL",110,0)
 .D EN^DDIOL("You cannot delete a refill that"_$S(+$G(CMOP(DA))=1:" has been released by",1:" is being transmitted to")_" the CMOP","","!!")
"RTN","PSOUTL",111,0)
 .D EN^DDIOL(" ","","!!")
"RTN","PSOUTL",112,0)
 K CMOP
"RTN","PSOUTL",113,0)
 ;
"RTN","PSOUTL",114,0)
 N PSOL,PSR
"RTN","PSOUTL",115,0)
 S PSR=0 F  S PSR=$O(^PSRX(DA(1),1,PSR)) Q:'PSR  S PSOL=PSR
"RTN","PSOUTL",116,0)
 I DA=PSOL,$P(^PSRX(DA(1),1,DA,0),"^",18) D  Q
"RTN","PSOUTL",117,0)
 .D EN^DDIOL("Refill Released! Use the 'Return to Stock' option!","","$C(7),!!"),EN^DDIOL(" ","","!")
"RTN","PSOUTL",118,0)
 ;
"RTN","PSOUTL",119,0)
 ;Only allow deletion if last refill      *259
"RTN","PSOUTL",120,0)
 I $O(^PSRX(DA(1),1,DA)) D  Q
"RTN","PSOUTL",121,0)
 .D EN^DDIOL("Only the last refill can be deleted.  Later refills must be deleted first.","","$C(7),!!")
"RTN","PSOUTL",122,0)
 .D EN^DDIOL("","","!!")
"RTN","PSOUTL",123,0)
 ;
"RTN","PSOUTL",124,0)
 ;Warn of In Process, Only delete if answered Yes         ;*259
"RTN","PSOUTL",125,0)
 I $$REFIP^PSOUTLA1(DA(1),DA,"R") D  I 'Y Q               ;reset $T
"RTN","PSOUTL",126,0)
 . D EN^DDIOL("** Refill has previously been sent to the External Dispense Machine","","!!,?2")
"RTN","PSOUTL",127,0)
 . D EN^DDIOL("** for filling and is still Pending Processing","","$C(7),!,?2")
"RTN","PSOUTL",128,0)
 . D EN^DDIOL("","","!")
"RTN","PSOUTL",129,0)
 . K DIR
"RTN","PSOUTL",130,0)
 . S DIR("A")="Do you want to continue? "
"RTN","PSOUTL",131,0)
 . S DIR("B")="Y"
"RTN","PSOUTL",132,0)
 . S DIR(0)="YA^^"
"RTN","PSOUTL",133,0)
 . S DIR("?")="Enter Y for Yes or N for No."
"RTN","PSOUTL",134,0)
 . D ^DIR
"RTN","PSOUTL",135,0)
 . K DIR
"RTN","PSOUTL",136,0)
 Q
"RTN","PSOUTL",137,0)
 ;
"RTN","PSOUTL",138,0)
WARN1 ;move to PSOUTLA1
"RTN","PSOUTL",139,0)
 D WARN1^PSOUTLA1
"RTN","PSOUTL",140,0)
 Q
"RTN","PSOUTL",141,0)
 ;
"RTN","PSOUTL",142,0)
CAN(PSOXRX) ;Clean up Rx when discontinued
"RTN","PSOUTL",143,0)
 N SUSD,IFN,RF,NODE,DA
"RTN","PSOUTL",144,0)
 Q:'$D(^PSRX(PSOXRX,0))
"RTN","PSOUTL",145,0)
 S DA=$O(^PS(52.5,"B",PSOXRX,0)) I DA S DIK="^PS(52.5,",SUSD=$P($G(^PS(52.5,DA,0)),"^",2) D ^DIK K DIK I $O(^PSRX(PSOXRX,1,0)) S DA=PSOXRX D REF^PSOCAN2
"RTN","PSOUTL",146,0)
 I $D(^PS(52.4,PSOXRX,0)) S DIK="^PS(52.4,",DA=PSOXRX D ^DIK K DIK
"RTN","PSOUTL",147,0)
 I $G(^PSRX(PSOXRX,"H"))]"" K:$P(^PSRX(PSOXRX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSOXRX,"H"),"^"),PSOXRX) S ^PSRX(PSOXRX,"H")=""
"RTN","PSOUTL",148,0)
 I '$P($G(^PSRX(PSOXRX,2)),"^",2) K DIE S DIE="^PSRX(",DA=PSOXRX,DR="22///"_DT D ^DIE
"RTN","PSOUTL",149,0)
 Q
"RTN","PSOUTL",150,0)
ECAN(PSOXRX) ;Clean up Rx when expired
"RTN","PSOUTL",151,0)
 N DA
"RTN","PSOUTL",152,0)
 Q:'$D(^PSRX(PSOXRX,0))
"RTN","PSOUTL",153,0)
 S DA=$O(^PS(52.5,"B",PSOXRX,0)) I DA K DIK S DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOUTL",154,0)
 I $D(^PS(52.4,PSOXRX,0)) K DIK S DIK="^PS(52.4,",DA=PSOXRX D ^DIK K DIK
"RTN","PSOUTL",155,0)
 I $G(^PSRX(PSOXRX,"H"))]"" K:$P(^PSRX(PSOXRX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSOXRX,"H"),"^"),PSOXRX) S ^PSRX(PSOXRX,"H")=""
"RTN","PSOUTL",156,0)
 I '$P($G(^PSRX(PSOXRX,2)),"^",2) K DIE S DIE="^PSRX(",DA=PSOXRX,DR="22///"_DT D ^DIE
"RTN","PSOUTL",157,0)
 Q
"RTN","PSOUTL",158,0)
CMOP ;CMOP("L")=LAST FILL... if it is orig Rx =0
"RTN","PSOUTL",159,0)
 ;CMOP(FILL #)=CMOP status from 52[TRAN=0,DISP=1,RETRAN=2,NOT DISP=3
"RTN","PSOUTL",160,0)
 ;If suspended CMOP("S")=CMOP suspense status Q,L,X,P,R
"RTN","PSOUTL",161,0)
 ;All returned variables can be killed by K CMOP
"RTN","PSOUTL",162,0)
 ;
"RTN","PSOUTL",163,0)
 S CRX=DA
"RTN","PSOUTL",164,0)
CMOP1 N X
"RTN","PSOUTL",165,0)
 S (CMOP("L"),X)=0  F  S X=$O(^PSRX(CRX,1,X)) Q:'X  S CMOP("L")=X
"RTN","PSOUTL",166,0)
 I $O(^PSRX(CRX,4,0)) F X=0:0 S X=$O(^PSRX(CRX,4,X)) Q:'X  D
"RTN","PSOUTL",167,0)
 .S CMOP($P($G(^PSRX(CRX,4,X,0)),"^",3))=$P($G(^(0)),"^",4)
"RTN","PSOUTL",168,0)
 S X=$O(^PS(52.5,"B",CRX,0)) I X]"" S CMOP("S")=$P($G(^PS(52.5,X,0)),"^",7)
"RTN","PSOUTL",169,0)
 K CRX,X
"RTN","PSOUTL",170,0)
 Q
"RTN","PSOUTL",171,0)
 ;
"RTN","PSOUTL",172,0)
CHKCMOP(RX,REA) ;Check if an RX is Transmitted/Retransmitted to CMOP and send alert mail
"RTN","PSOUTL",173,0)
 ;
"RTN","PSOUTL",174,0)
 ; Input:  RX - ien to file #52
"RTN","PSOUTL",175,0)
 ;        REA - reason DC's "A" = admission, "D" = death
"RTN","PSOUTL",176,0)
 ; Output: none
"RTN","PSOUTL",177,0)
 ;
"RTN","PSOUTL",178,0)
 N CMOP,PSOCMOP
"RTN","PSOUTL",179,0)
 S REA=$G(REA)
"RTN","PSOUTL",180,0)
 I $$TRANCMOP(RX),$G(PSOCMOP)]"" D MAILCMOP(RX,PSOCMOP,REA)
"RTN","PSOUTL",181,0)
 Q
"RTN","PSOUTL",182,0)
 ;
"RTN","PSOUTL",183,0)
TRANCMOP(RX) ;check if a fill is Transmitted or Retransmitted
"RTN","PSOUTL",184,0)
 ;
"RTN","PSOUTL",185,0)
 ; Input:          = RX number
"RTN","PSOUTL",186,0)
 ; Function output:= RX number if CMOP status is Trans or Retrans
"RTN","PSOUTL",187,0)
 ;                 = 0 if neither
"RTN","PSOUTL",188,0)
 ; Global parm out:= PSOCMOP = string from call to ^PSOCMOPA
"RTN","PSOUTL",189,0)
 ;
"RTN","PSOUTL",190,0)
 N DA,PSOTRANS
"RTN","PSOUTL",191,0)
 S DA=RX D ^PSOCMOPA
"RTN","PSOUTL",192,0)
 S PSOTRANS=$P($G(PSOCMOP),"^")
"RTN","PSOUTL",193,0)
 Q:PSOTRANS=0!(PSOTRANS=2) RX
"RTN","PSOUTL",194,0)
 Q 0
"RTN","PSOUTL",195,0)
 ;
"RTN","PSOUTL",196,0)
MAILCMOP(RX,STR,REA) ;Send mail message to mail group PSX EXTERNAL DISPENSE ALERTS
"RTN","PSOUTL",197,0)
 ;
"RTN","PSOUTL",198,0)
 ; Input:  RX  = ien of PSRX
"RTN","PSOUTL",199,0)
 ;         STR = CMOP STATUS # ^ TRANSMIT DATE (FM) ^ LAST FILL #
"RTN","PSOUTL",200,0)
 ;         REA = reason DC'd  "A" = admission, "D" = death
"RTN","PSOUTL",201,0)
 ; Output: none
"RTN","PSOUTL",202,0)
 ;
"RTN","PSOUTL",203,0)
 N CMDT,CMST,DFN,VADM,PSOTEXT,PSOIEN,PSOKEYN,XMY,XMDUZ,XMSUB,XMTEXT
"RTN","PSOUTL",204,0)
 N DIV,SSN,RXO,FILL,DRUG,DIVN,MAILGRP,NAME,PRV,RXSTS
"RTN","PSOUTL",205,0)
 S RXO=$$GET1^DIQ(52,RX,.01)
"RTN","PSOUTL",206,0)
 S CMDT=$P(STR,U,2)
"RTN","PSOUTL",207,0)
 S CMDT=$E(CMDT,4,5)_"/"_$E(CMDT,6,7)_"/"_$E(CMDT,2,3)
"RTN","PSOUTL",208,0)
 S FILL=$P(STR,U,3)
"RTN","PSOUTL",209,0)
 S CMST=$P(STR,U),CMST=$S(CMST=2:"RETRANSMITTED",1:"TRANSMITTED")
"RTN","PSOUTL",210,0)
 S DIV=$P(^PSRX(RX,2),"^",9),DIVN=$P($G(^PS(59,DIV,0)),"^")
"RTN","PSOUTL",211,0)
 S MAILGRP="PSX EXTERNAL DISPENSE ALERTS"
"RTN","PSOUTL",212,0)
 S XMY("G."_MAILGRP)=""
"RTN","PSOUTL",213,0)
 ;if no members & no member groups & no remote members, then send to
"RTN","PSOUTL",214,0)
 ; the default: PSXCMOPMGR key holders
"RTN","PSOUTL",215,0)
 S PSOIEN=$O(^XMB(3.8,"B",MAILGRP,0))
"RTN","PSOUTL",216,0)
 I '$O(^XMB(3.8,PSOIEN,1,0))&'$O(^XMB(3.8,PSOIEN,5,0))&'$O(^XMB(3.8,PSOIEN,6,0)) D
"RTN","PSOUTL",217,0)
 . S PSOKEYN=0
"RTN","PSOUTL",218,0)
 . F  S PSOKEYN=$O(^XUSEC("PSXCMOPMGR",PSOKEYN)) Q:'PSOKEYN  D
"RTN","PSOUTL",219,0)
 . . S XMY(PSOKEYN)=""
"RTN","PSOUTL",220,0)
 S DFN=$$GET1^DIQ(52,RX,2,"I") D DEM^VADPT
"RTN","PSOUTL",221,0)
 S NAME=VADM(1)
"RTN","PSOUTL",222,0)
 S SSN=$P($P(VADM(2),"^",2),"-",3)
"RTN","PSOUTL",223,0)
 S RXSTS=$$GET1^DIQ(52,RX,100)
"RTN","PSOUTL",224,0)
 S DRUG=$$GET1^DIQ(52,RX,6)
"RTN","PSOUTL",225,0)
 S PRV=$$GET1^DIQ(52,RX,4)
"RTN","PSOUTL",226,0)
 S XMDUZ=.5
"RTN","PSOUTL",227,0)
 S XMSUB=DIVN_" - DC Alert on CMOP Rx "_RXO_" "_CMST
"RTN","PSOUTL",228,0)
 S PSOTEXT(1)="             Rx #: "_RXO_"   Fill: "_FILL
"RTN","PSOUTL",229,0)
 S PSOTEXT(2)="          Patient: "_NAME_" ("_SSN_")"
"RTN","PSOUTL",230,0)
 S PSOTEXT(3)="             Drug: "_DRUG
"RTN","PSOUTL",231,0)
 S PSOTEXT(4)="        Rx Status: "_RXSTS
"RTN","PSOUTL",232,0)
 S:REA="A" PSOTEXT(4)=PSOTEXT(4)_" (due to Admission)"
"RTN","PSOUTL",233,0)
 S:REA="D" PSOTEXT(4)=PSOTEXT(4)_" (due to Date of Death)"
"RTN","PSOUTL",234,0)
 S PSOTEXT(5)="Processing Status: "_CMST_" to CMOP on "_CMDT
"RTN","PSOUTL",235,0)
 S PSOTEXT(6)="         Provider: "_PRV
"RTN","PSOUTL",236,0)
 S PSOTEXT(7)=""
"RTN","PSOUTL",237,0)
 S PSOTEXT(8)="********    Please contact CMOP or take appropriate action    ********"
"RTN","PSOUTL",238,0)
 S XMTEXT="PSOTEXT(" D ^XMD
"RTN","PSOUTL",239,0)
 D KVA^VADPT
"RTN","PSOUTL",240,0)
 Q
"RTN","PSOUTL",241,0)
 ;
"RTN","PSOUTL",242,0)
PSOCK ;
"RTN","PSOUTL",243,0)
 W !!!,"*The following list of order checks is a comprehensive report of all"
"RTN","PSOUTL",244,0)
 W !,"Outpatient, Non-VA, and Clinic medication orders on this patient's profile."
"RTN","PSOUTL",245,0)
 W !,"It may include orders that are local, remote, active, pending, recently"
"RTN","PSOUTL",246,0)
 W !,"discontinued, or expired. Please note that the sort order and format"
"RTN","PSOUTL",247,0)
 W !,"displayed in this report differs from the display of MOCHA 1.0 order"
"RTN","PSOUTL",248,0)
 W !,"checks which occurs during order processing.*",!
"RTN","PSOUTL",249,0)
 Q
"RTN","PSOUTL",250,0)
 ;
"RTN","PSOUTL",251,0)
PSSDGCK ;
"RTN","PSOUTL",252,0)
 D ^PSSDIUTL
"RTN","PSOUTL",253,0)
 Q
"RTN","PSOUTL",254,0)
 ;
"RTN","PSOUTL",255,0)
PSOSUPCK(CHK) ;
"RTN","PSOUTL",256,0)
 I '($P($G(^PSDRUG(CHK,0)),"^",3)["S"!($E($P($G(^PSDRUG(CHK,0)),"^",2),1,2)="XA")) K CHK Q 0
"RTN","PSOUTL",257,0)
 W !!,"You have selected a supply item, please select another drug"
"RTN","PSOUTL",258,0)
 W !,"or leave blank and hit enter for Profile Order Checks." W !
"RTN","PSOUTL",259,0)
 K CHK
"RTN","PSOUTL",260,0)
 Q 1
"RTN","PSOUTL",261,0)
 ;
"RTN","PSOUTL",262,0)
PRFLP ;ZB POST+18^PSODRG THE RUN D LOOP^ZZME3
"RTN","PSOUTL",263,0)
 N PSODRUG S (DGCKSTA,DGCKDNM)="" S PSODGCKF=1
"RTN","PSOUTL",264,0)
 I $D(PSOSD) F  S DGCKSTA=$O(PSOSD(DGCKSTA)) Q:DGCKSTA=""  F  S DGCKDNM=$O(PSOSD(DGCKSTA,DGCKDNM)) Q:DGCKDNM=""  D
"RTN","PSOUTL",265,0)
 .S DIC=50,DIC(0)="MQZV",X=DGCKDNM D ^DIC K DIC
"RTN","PSOUTL",266,0)
 .S DIC=50,DIC(0)="MQZV",X=+Y D ^DIC K DIC Q:Y=-1
"RTN","PSOUTL",267,0)
 .S PSODRUG("IEN")=DGCKDNM,PSODRUG("VA CLASS")=$P(Y(0),"^",2),PSODRUG("NAME")=$P(Y(0),"^")
"RTN","PSOUTL",268,0)
 .S:+$G(^PSDRUG(+Y,2)) PSODRUG("OI")=+$G(^(2)),PSODRUG("OIN")=$P(^PS(50.7,+$G(^(2)),0),"^")
"RTN","PSOUTL",269,0)
 .S PSODRUG("NDF")=$S($G(^PSDRUG(DGCKDNM,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOUTL",270,0)
 .S PSODFN=DFN D ^PSODGAL1
"RTN","PSOUTL",271,0)
 .K X,Y,DTOUT,DUOUT
"RTN","PSOUTL",272,0)
 K DGCKSTA,DGCKDNM,PSODGCKF,X,Y,DTOUT,DUOUT
"RTN","PSOUTL",273,0)
 Q
"RTN","PSOUTL",274,0)
 ;
"RTN","PSOUTL",275,0)
TITRX(RX) ; Returns the titration/maintenance flags
"RTN","PSOUTL",276,0)
 ;
"RTN","PSOUTL",277,0)
 I '$G(RX) Q ""
"RTN","PSOUTL",278,0)
 I '$D(^PSRX(RX,0)) Q ""
"RTN","PSOUTL",279,0)
 I $$GET1^DIQ(52,RX,45.1,"I") Q "m"
"RTN","PSOUTL",280,0)
 I $$GET1^DIQ(52,RX,45.2,"I")!$$GET1^DIQ(52,RX,45.3,"I") Q "t"
"RTN","PSOUTL",281,0)
 Q ""
"RTN","PSOUTL",282,0)
 ;
"RTN","PSOUTL",283,0)
LTHEN(RX) ; Looks for a THEN anywhere in the Complex Order.
"RTN","PSOUTL",284,0)
 ; Returns: 1 if found and 0 if not found.  Complex Order must contain at least one THEN conjunction
"RTN","PSOUTL",285,0)
 ; in order to mark it as a Titration Rx.
"RTN","PSOUTL",286,0)
 N PSOCOUNT,PSOTHEN,FNDTHEN
"RTN","PSOUTL",287,0)
 S (PSOCOUNT,PSOTHEN,FNDTHEN)=""
"RTN","PSOUTL",288,0)
 F  S PSOCOUNT=$O(^PSRX(RX,6,PSOCOUNT)) Q:PSOCOUNT=""!(FNDTHEN'="")  D
"RTN","PSOUTL",289,0)
 . S PSOTHEN=$P($G(^PSRX(RX,6,PSOCOUNT,0)),"^",6)
"RTN","PSOUTL",290,0)
 . I PSOTHEN="T" S FNDTHEN=1 Q
"RTN","PSOUTL",291,0)
 I $G(FNDTHEN)="" Q 0
"RTN","PSOUTL",292,0)
 Q 1
"VER")
8.0^22.0
"^DD",52,52,45.1,0)
TITRATION DOSE RX^P52'^PSRX(^TIT;1^Q
"^DD",52,52,45.1,3)
Enter the corresponding titration dose prescription number.
"^DD",52,52,45.1,21,0)
^^2^2^3120912^
"^DD",52,52,45.1,21,1,0)
This is the Titration Dose Rx from which the corresponding 
"^DD",52,52,45.1,21,2,0)
Maintenance Dose Rx originated.
"^DD",52,52,45.1,"DT")
3120912
"^DD",52,52,45.2,0)
MAINTENANCE DOSE RX^P52'^PSRX(^TIT;2^Q
"^DD",52,52,45.2,3)
Enter the corresponding maintenance dose prescription.
"^DD",52,52,45.2,21,0)
^^2^2^3120912^
"^DD",52,52,45.2,21,1,0)
This is the Maintenance Dose Rx that was created from the corresponding 
"^DD",52,52,45.2,21,2,0)
Titration Dose Rx.
"^DD",52,52,45.2,"DT")
3120912
"^DD",52,52,45.3,0)
TITRATION RX FLAG^S^1:YES;^TIT;3^Q
"^DD",52,52,45.3,3)
Indicate if the prescription is a Titration Dose Prescription.
"^DD",52,52,45.3,21,0)
^^3^3^3120912^
"^DD",52,52,45.3,21,1,0)
This flag indicates whether the prescription is being dispensed as a 
"^DD",52,52,45.3,21,2,0)
Titration Dose. It is intended to identify a Titration Dose Rx without 
"^DD",52,52,45.3,21,3,0)
a corresponding Maintenance Dose Rx.
"^DD",52,52,45.3,"DT")
3120912
"BLD",8639,6)
^368
**END**
**END**

