EMERGENCY Released PSO*7*475 SEQ #390
Extracted from mail message
**KIDS**:PSO*7.0*475^

**INSTALL NAME**
PSO*7.0*475
"BLD",9803,0)
PSO*7.0*475^OUTPATIENT PHARMACY^0^3161213^y
"BLD",9803,1,0)
^^3^3^3161212^
"BLD",9803,1,1,0)
This patch resolves a problem where a pharmacy user is not prompted for a 
"BLD",9803,1,2,0)
label device. This occurs when the host site does not generate label data 
"BLD",9803,1,3,0)
for a remote refill or partial fill request.
"BLD",9803,4,0)
^9.64PA^^
"BLD",9803,6.3)
5
"BLD",9803,"ABPKG")
n
"BLD",9803,"KRN",0)
^9.67PA^779.2^20
"BLD",9803,"KRN",.4,0)
.4
"BLD",9803,"KRN",.401,0)
.401
"BLD",9803,"KRN",.402,0)
.402
"BLD",9803,"KRN",.403,0)
.403
"BLD",9803,"KRN",.5,0)
.5
"BLD",9803,"KRN",.84,0)
.84
"BLD",9803,"KRN",3.6,0)
3.6
"BLD",9803,"KRN",3.8,0)
3.8
"BLD",9803,"KRN",9.2,0)
9.2
"BLD",9803,"KRN",9.8,0)
9.8
"BLD",9803,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",9803,"KRN",9.8,"NM",1,0)
PSORRPA1^^0^B75343267
"BLD",9803,"KRN",9.8,"NM",2,0)
PSORWRAP^^0^B105667697
"BLD",9803,"KRN",9.8,"NM",3,0)
PSORREF^^0^B44094138
"BLD",9803,"KRN",9.8,"NM","B","PSORREF",3)

"BLD",9803,"KRN",9.8,"NM","B","PSORRPA1",1)

"BLD",9803,"KRN",9.8,"NM","B","PSORWRAP",2)

"BLD",9803,"KRN",19,0)
19
"BLD",9803,"KRN",19.1,0)
19.1
"BLD",9803,"KRN",101,0)
101
"BLD",9803,"KRN",409.61,0)
409.61
"BLD",9803,"KRN",771,0)
771
"BLD",9803,"KRN",779.2,0)
779.2
"BLD",9803,"KRN",870,0)
870
"BLD",9803,"KRN",8989.51,0)
8989.51
"BLD",9803,"KRN",8989.52,0)
8989.52
"BLD",9803,"KRN",8994,0)
8994
"BLD",9803,"KRN","B",.4,.4)

"BLD",9803,"KRN","B",.401,.401)

"BLD",9803,"KRN","B",.402,.402)

"BLD",9803,"KRN","B",.403,.403)

"BLD",9803,"KRN","B",.5,.5)

"BLD",9803,"KRN","B",.84,.84)

"BLD",9803,"KRN","B",3.6,3.6)

"BLD",9803,"KRN","B",3.8,3.8)

"BLD",9803,"KRN","B",9.2,9.2)

"BLD",9803,"KRN","B",9.8,9.8)

"BLD",9803,"KRN","B",19,19)

"BLD",9803,"KRN","B",19.1,19.1)

"BLD",9803,"KRN","B",101,101)

"BLD",9803,"KRN","B",409.61,409.61)

"BLD",9803,"KRN","B",771,771)

"BLD",9803,"KRN","B",779.2,779.2)

"BLD",9803,"KRN","B",870,870)

"BLD",9803,"KRN","B",8989.51,8989.51)

"BLD",9803,"KRN","B",8989.52,8989.52)

"BLD",9803,"KRN","B",8994,8994)

"BLD",9803,"QUES",0)
^9.62^^
"BLD",9803,"REQB",0)
^9.611^1^1
"BLD",9803,"REQB",1,0)
PSO*7.0*454^2
"BLD",9803,"REQB","B","PSO*7.0*454",1)

"MBREQ")
0
"PKG",170,-1)
1^1
"PKG",170,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",170,20,0)
^9.402P^^
"PKG",170,22,0)
^9.49I^1^1
"PKG",170,22,1,0)
7.0^2971216^2981113^1
"PKG",170,22,1,"PAH",1,0)
475^3161213
"PKG",170,22,1,"PAH",1,1,0)
^^3^3^3161213
"PKG",170,22,1,"PAH",1,1,1,0)
This patch resolves a problem where a pharmacy user is not prompted for a 
"PKG",170,22,1,"PAH",1,1,2,0)
label device. This occurs when the host site does not generate label data 
"PKG",170,22,1,"PAH",1,1,3,0)
for a remote refill or partial fill request.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSORREF")
0^3^B44094138^B44063843
"RTN","PSORREF",1,0)
PSORREF ;AITC/BWF - Remote RX retrieval API ;12/12/16 3:21pm
"RTN","PSORREF",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**454,475**;DEC 1997;Build 5
"RTN","PSORREF",3,0)
 ;
"RTN","PSORREF",4,0)
 Q
"RTN","PSORREF",5,0)
 ; RET    - return data
"RTN","PSORREF",6,0)
 ; RXNUM  - RX Number from remote system
"RTN","PSORREF",7,0)
 ; FDATE  - Fill Date
"RTN","PSORREF",8,0)
 ; MW     - Mail/Window - Default of 'W' for now.
"RTN","PSORREF",9,0)
 ; RPHARM - Pharmacist from remote site
"RTN","PSORREF",10,0)
 ; RPHONE - Contact number
"RTN","PSORREF",11,0)
 ; RSITE  - Filling site number
"RTN","PSORREF",12,0)
 ;
"RTN","PSORREF",13,0)
REMREF(RET,RXNUM,FDATE,MW,RPHARM,RPHONE,RSITE,RX0,RX2,RXSTA,RPROV,RSIG,RREF0,ROR1,RX3) ;
"RTN","PSORREF",14,0)
 ;
"RTN","PSORREF",15,0)
 N MSG,BACK,PSOPAR,RRXIEN,PSOSIEN,DSUPP,LASTREF,XTMPLOC,PASSLOC,HFSIEN,FULLPTH,HFSDONE,PTHDAT,PTHPIECE,FOUND,STRT,STATION,FTGOPEN,PPL1,PSOSITE
"RTN","PSORREF",16,0)
 N PSOX,PTHFILE,SITENUM,X,X1,X2,HDRUG,CSVAL,PSISSDT,TFILLS,OFFSET,CHKDT,DINACT,DEL,FTGSTRT,PDIR,PFIL,PSODTCUT,PSOEXREP,PSOPHDUZ
"RTN","PSORREF",17,0)
 N PSODFDIR,PSOFNAME,PAR,DELARR,RREFIEN
"RTN","PSORREF",18,0)
 N PSOBBC,PSOBBC1,PSODIR,PSOMVH
"RTN","PSORREF",19,0)
 ; check 3rd party payer rejects. Send message to initiating site if applicable.
"RTN","PSORREF",20,0)
 S $ETRAP="D ^%ZTER Q"
"RTN","PSORREF",21,0)
 S RET(0)=""
"RTN","PSORREF",22,0)
 S RRXIEN=$O(^PSRX("B",RXNUM,0)),PSOSIEN=$$GET1^DIQ(52,RRXIEN,20,"I")
"RTN","PSORREF",23,0)
 I '$$GET1^DIQ(59,PSOSIEN,3001,"I") D  Q
"RTN","PSORREF",24,0)
 .S RET(1)="The OneVA pharmacy flag is turned 'OFF' at this facility."
"RTN","PSORREF",25,0)
 .S RET(2)="Unable to process refill/partial fill requests."
"RTN","PSORREF",26,0)
 .D RET0
"RTN","PSORREF",27,0)
 S PSOPHDUZ=$$GET1^DIQ(52,RRXIEN,23,"I") I 'PSOPHDUZ S PSOPHDUZ=.5
"RTN","PSORREF",28,0)
 S HDRUG=$$GET1^DIQ(52,RRXIEN,6,"I")
"RTN","PSORREF",29,0)
 ; quit if drug is inactive
"RTN","PSORREF",30,0)
 S DINACT=$$GET1^DIQ(50,HDRUG,100,"I")
"RTN","PSORREF",31,0)
 I DINACT>0,DINACT<$$NOW^XLFDT S RET(1)="Drug is inactive for Rx# "_RXNUM_". Cannot refill." D RET0 Q
"RTN","PSORREF",32,0)
 S CSVAL=$$GET1^DIQ(50,HDRUG,3,"E"),CSVAL=$E(CSVAL,1)
"RTN","PSORREF",33,0)
 I CSVAL,CSVAL>0,CSVAL<6 D RET0 S RET(1)="Rx #"_RXNUM_" cannot be refilled.",RET(2)="The associated drug is considered a controlled substance",RET(3)="at the host facility." Q
"RTN","PSORREF",34,0)
 S PSOPAR=$G(^PS(59,PSOSIEN,1)),PSOSITE=PSOSIEN
"RTN","PSORREF",35,0)
 S RPHONE=$G(RPHONE,"")
"RTN","PSORREF",36,0)
 ; check to see if this action will throw the prescription into suspense. If so, quit and return a message
"RTN","PSORREF",37,0)
 S DSUPP=$$GET1^DIQ(52,RRXIEN,8,"I")
"RTN","PSORREF",38,0)
 S X2=-120,X1=DT D C^%DTC S PSODTCUT=X
"RTN","PSORREF",39,0)
 S (PSODFN,PSOREF("PSODFN"))=$$GET1^DIQ(52,RRXIEN,2,"I") K PSOSD D ^PSOBUILD
"RTN","PSORREF",40,0)
 N RXN K PSORX("FILL DATE") S PSOFROM="REFILL" S PSOREF("DFLG")=0,PSOREF("IRXN")=$O(^PSRX("B",RXNUM,0)),PSOREF("QFLG")=0
"RTN","PSORREF",41,0)
 I $$LMREJ^PSOREJU1(RXNUM,,.MSG,.BACK) S RET(1)=MSG D RET0 Q
"RTN","PSORREF",42,0)
 S PSORX("FILL DATE")=FDATE
"RTN","PSORREF",43,0)
 K PSOID D START^PSORREF1(FDATE) I PSOREF("DFLG") D EOJ Q
"RTN","PSORREF",44,0)
 ; check ability to refill given issue date/days supply
"RTN","PSORREF",45,0)
 S PSISSDT=$$GET1^DIQ(52,RRXIEN,1,"I")
"RTN","PSORREF",46,0)
 S TFILLS=$O(^PSRX(RRXIEN,1,"A"),-1)+1
"RTN","PSORREF",47,0)
 S OFFSET=DSUPP*TFILLS,OFFSET=OFFSET-10
"RTN","PSORREF",48,0)
 S CHKDT=$$FMADD^XLFDT(PSISSDT,OFFSET)
"RTN","PSORREF",49,0)
 I PSORX("FILL DATE")<CHKDT D RET0 S RET(1)="Cannot refill Rx# "_RXNUM_". Next possible fill date is "_$$FMTE^XLFDT(CHKDT,"5D") Q
"RTN","PSORREF",50,0)
 I PSORX("FILL DATE")>$$GET1^DIQ(52,RRXIEN,26,"I") D RET0 S RET(1)="Cannot refill Rx# "_RXNUM_".",RET(2)="Cannot refill after expiration date "_$$GET1^DIQ(52,RRXIEN,11,"E") Q
"RTN","PSORREF",51,0)
 D PROCESS^PSORREF0(.RET)
"RTN","PSORREF",52,0)
 ; make sure not errors are returned
"RTN","PSORREF",53,0)
 I $D(RET(1)) D EOJ Q
"RTN","PSORREF",54,0)
 I '$D(RET(1)) D
"RTN","PSORREF",55,0)
 .; bwf 8/14/14 - set up needed variables for label printing
"RTN","PSORREF",56,0)
 .S PSODFN=$P(^PSRX(RRXIEN,0),U,2)
"RTN","PSORREF",57,0)
 .S PSORX("IRXN")=RXNUM
"RTN","PSORREF",58,0)
 .S PSORX("PSOL",1)=RRXIEN_","
"RTN","PSORREF",59,0)
 .S PSORX("MAIL/WINDOW")="WINDOW"
"RTN","PSORREF",60,0)
 .S PSORX("NAME")=$$GET1^DIQ(2,PSODFN,.01)
"RTN","PSORREF",61,0)
 .S PSORX("QFLG")=0
"RTN","PSORREF",62,0)
 .S PSORX("METHOD OF PICKUP")=""
"RTN","PSORREF",63,0)
 .S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^")
"RTN","PSORREF",64,0)
 .S PPL1=RRXIEN
"RTN","PSORREF",65,0)
 .; bwf 8/14/14 - end setup for label printing.
"RTN","PSORREF",66,0)
 .S PSODFDIR=$$DEFDIR^%ZISH()
"RTN","PSORREF",67,0)
 .S PSOFNAME="PSOLBL_"_RXNUM_"_"_PSOSITE_"_"_DT_".DAT"
"RTN","PSORREF",68,0)
 .S FULLPTH=PSODFDIR_PSOFNAME
"RTN","PSORREF",69,0)
 .S HFSDONE=0,PTHDAT=""
"RTN","PSORREF",70,0)
 .; preserve IO
"RTN","PSORREF",71,0)
 .D SAVDEV^%ZISUTL("ONEVAHLIO")
"RTN","PSORREF",72,0)
 .S DELARR("PSOLBL_"_RXNUM_"_"_PSOSITE_"_"_DT_".DAT")="" S DEL=$$DEL^%ZISH(PSODFDIR,$NA(DELARR))
"RTN","PSORREF",73,0)
 .S PSOEXREP=1
"RTN","PSORREF",74,0)
 .; call out to generate label
"RTN","PSORREF",75,0)
 .D LABEL^PSORWRAP(RRXIEN,"HFS",PSOSITE,PSOPHDUZ,"",PSOFNAME)
"RTN","PSORREF",76,0)
 .S XTMPLOC="^XTMP(""PSORLBL"","_HLINSTN_","_+RXNUM_",1,0)"
"RTN","PSORREF",77,0)
 .S PASSLOC="XTMP(""PSORLBL"","_HLINSTN_","_+RXNUM_")"
"RTN","PSORREF",78,0)
 .K ^XTMP("PSORLBL",HLINSTN,+RXNUM,0)
"RTN","PSORREF",79,0)
 .S ^XTMP("PSORLBL",HLINSTN,+RXNUM,0)=DT_U_$$FMADD^XLFDT(DT,30)
"RTN","PSORREF",80,0)
 .; looks like we have to wait a moment before the file shows up.
"RTN","PSORREF",81,0)
 .S FTGSTRT=$$NOW^XLFDT,(FOUND,FTGOPEN)=0
"RTN","PSORREF",82,0)
 .N PAR S PAR=0
"RTN","PSORREF",83,0)
 .F  D  Q:$$NOW^XLFDT>$$FMADD^XLFDT(FTGSTRT,,,,15)!(FOUND)!(FTGOPEN)
"RTN","PSORREF",84,0)
 ..S FTGOPEN=$$FTG^%ZISH(PSODFDIR,PSOFNAME,XTMPLOC,4)
"RTN","PSORREF",85,0)
 ..I $O(^XTMP("PSORLBL",HLINSTN,+RXNUM,0)) S FOUND=1
"RTN","PSORREF",86,0)
 .S DELARR("PSOLBL_"_RXNUM_"_"_PSOSITE_"_"_DT_".DAT")="" S DEL=$$DEL^%ZISH(PSODFDIR,$NA(DELARR))
"RTN","PSORREF",87,0)
 .; restore IO
"RTN","PSORREF",88,0)
 .D USE^%ZISUTL("ONEVAHLIO"),RMDEV^%ZISUTL("ONEVAHLIO")
"RTN","PSORREF",89,0)
 .D UPDREF(.RET,RRXIEN,RPHARM,RPHONE,RSITE,PASSLOC)
"RTN","PSORREF",90,0)
 .S RET(1)="Rx # "_RXNUM_" refilled."
"RTN","PSORREF",91,0)
 .S RX0=$G(^PSRX(RRXIEN,0)),RX2=$G(^PSRX(RRXIEN,2)),RX3=$G(^PSRX(RRXIEN,3))
"RTN","PSORREF",92,0)
 .S RXSTA=$G(^PSRX(RRXIEN,"STA")),RPROV=$$GET1^DIQ(200,$P(RX0,U,4),.01,"E")_U_$$GET1^DIQ(200,$P(RX0,U,16),.01,"E")
"RTN","PSORREF",93,0)
 .S RSIG=$G(^PSRX(RRXIEN,"SIG"))
"RTN","PSORREF",94,0)
 .S RREFIEN=$O(^PSRX(RRXIEN,1,"A"),-1)
"RTN","PSORREF",95,0)
 .I RREFIEN S RREF0=$G(^PSRX(RRXIEN,1,RREFIEN,0))
"RTN","PSORREF",96,0)
 .S ROR1=$G(^PSRX(RRXIEN,"OR1"))
"RTN","PSORREF",97,0)
 D EOJ
"RTN","PSORREF",98,0)
 Q
"RTN","PSORREF",99,0)
EOJ ;
"RTN","PSORREF",100,0)
 D RET0
"RTN","PSORREF",101,0)
 K PSOMSG,PSOREF,PSORX("BAR CODE"),PSOLIST,LFD,MAX,MIN,NODE,PS,PSOERR,REF,RF,RXO,RXN,RXP,RXS,SD,VAERR,PSORX("FILL DATE")
"RTN","PSORREF",102,0)
 K PSOFROM,PSODFN,PSORX
"RTN","PSORREF",103,0)
 Q
"RTN","PSORREF",104,0)
 ; build ret(0) if needed
"RTN","PSORREF",105,0)
RET0 ;
"RTN","PSORREF",106,0)
 I '$L(RET(0)) S RET(0)=0_U_RXNUM_U_RRXIEN_U_U_FDATE,$P(RET(0),U,15)=$G(RPHARM),$P(RET(0),U,16)=$G(RPHONE),$P(RET(0),U,17)=$G(RSITE)
"RTN","PSORREF",107,0)
 Q
"RTN","PSORREF",108,0)
 ;
"RTN","PSORREF",109,0)
ULK ;
"RTN","PSORREF",110,0)
 Q
"RTN","PSORREF",111,0)
 ; successful refill. Update data, and build response
"RTN","PSORREF",112,0)
UPDREF(PSOMSG,PSOIEN,RPHARM,RPHONE,RSITE,PASSLOC) ;
"RTN","PSORREF",113,0)
 N REFIEN,REFIENS,REFDATA,FIL,RXNUM,RFILLDT,QTY,DSUPP,CLERK,LOGDATE,IDIV,EDIV,DISPDT,NDC,FDA,DNAME,DIEN,DAT
"RTN","PSORREF",114,0)
 S FIL=52.1
"RTN","PSORREF",115,0)
 ; get last refill data node
"RTN","PSORREF",116,0)
 S REFIEN=$O(^PSRX(PSOIEN,1,"B",DT,""),-1)
"RTN","PSORREF",117,0)
 S RXNUM=$$GET1^DIQ(52,PSOIEN,.01,"E")
"RTN","PSORREF",118,0)
 S DNAME=$$GET1^DIQ(52,PSOIEN,6,"E")
"RTN","PSORREF",119,0)
 S DIEN=$$GET1^DIQ(52,PSOIEN,6,"I")
"RTN","PSORREF",120,0)
 S REFIENS=REFIEN_","_PSOIEN_","
"RTN","PSORREF",121,0)
 ; first, set in the remote pharmacist data
"RTN","PSORREF",122,0)
 S FDA(FIL,REFIENS,91)=RSITE
"RTN","PSORREF",123,0)
 S FDA(FIL,REFIENS,92)=RPHARM
"RTN","PSORREF",124,0)
 S FDA(FIL,REFIENS,93)=RPHONE
"RTN","PSORREF",125,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSORREF",126,0)
 ; now query data and build RET(0) holding accurate information from the refill multiple
"RTN","PSORREF",127,0)
 D GETS^DIQ(FIL,REFIENS,"**","IE","REFDATA")
"RTN","PSORREF",128,0)
 S RFILLDT=$G(REFDATA(FIL,REFIENS,.01,"I"))
"RTN","PSORREF",129,0)
 S QTY=$G(REFDATA(FIL,REFIENS,1,"I"))
"RTN","PSORREF",130,0)
 S DSUPP=$G(REFDATA(FIL,REFIENS,1.1,"I"))
"RTN","PSORREF",131,0)
 S CLERK=$G(REFDATA(FIL,REFIENS,6,"E"))
"RTN","PSORREF",132,0)
 S LOGDATE=$G(REFDATA(FIL,REFIENS,7,"I"))
"RTN","PSORREF",133,0)
 ; internal division number (IEN to PSO SITE file)
"RTN","PSORREF",134,0)
 S IDIV=$G(REFDATA(FIL,REFIENS,8,"I"))
"RTN","PSORREF",135,0)
 S EDIV=$G(REFDATA(FIL,REFIENS,8,"E"))
"RTN","PSORREF",136,0)
 S DISPDT=$G(REFDATA(FIL,REFIENS,10.1,"I"))
"RTN","PSORREF",137,0)
 S NDC=$G(REFDATA(FIL,REFIENS,11,"E"))
"RTN","PSORREF",138,0)
 S RSITE=$G(REFDATA(FIL,REFIENS,91,"I"))
"RTN","PSORREF",139,0)
 S RPHARM=$G(REFDATA(FIL,REFIENS,92,"E"))
"RTN","PSORREF",140,0)
 S RPHONE=$G(REFDATA(FIL,REFIENS,93,"E"))
"RTN","PSORREF",141,0)
 S $P(DAT(1),U,3)=RXNUM,$P(DAT(1),U,4)=RSITE,$P(DAT(1),U,7)=QTY,$P(DAT(1),U,8)=DISPDT,$P(DAT(1),U,9)=DNAME,$P(DAT(1),U,10)=DSUPP,$P(DAT(1),U,11)=RPHARM,$P(DAT(1),U,12)=RFILLDT
"RTN","PSORREF",142,0)
 D LOGDATA^PSORWRAP($NA(DAT),"OR",,,PSOIEN)
"RTN","PSORREF",143,0)
 S PSOMSG(0)=1_U_RXNUM_U_PSOIEN_U_REFIEN_U_RFILLDT_U_DNAME_U_QTY_U_DSUPP_U_CLERK_U_LOGDATE_U_IDIV_U_EDIV_U_DISPDT_U_NDC_U_RPHARM_U_RPHONE_U_RSITE_U_PASSLOC
"RTN","PSORREF",144,0)
 Q
"RTN","PSORRPA1")
0^1^B75343267^B75304679
"RTN","PSORRPA1",1,0)
PSORRPA1 ;AITC/BWF - remote partial prescriptions ;12/12/16 3:21pm
"RTN","PSORRPA1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**454,475**;DEC 1997;Build 5
"RTN","PSORRPA1",3,0)
 ;
"RTN","PSORRPA1",4,0)
 ;External references L,UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORRPA1",5,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSORRPA1",6,0)
 ;External reference to ^DD(52 supported by DBIA 999
"RTN","PSORRPA1",7,0)
 ; bwf - Modified copy of PSORXPA1
"RTN","PSORRPA1",8,0)
 ; bwf - 2/24/14 adding PAR refill tag for API usage.
"RTN","PSORRPA1",9,0)
 ; VALMSG  - return data for remote facility
"RTN","PSORRPA1",10,0)
 ; RXNUM   - rx number
"RTN","PSORRPA1",11,0)
 ; PFDATE  - Partial Fill Date
"RTN","PSORRPA1",12,0)
 ; MW      - Mail or Window
"RTN","PSORRPA1",13,0)
 ; QTY     - Quantity
"RTN","PSORRPA1",14,0)
 ; DSUPP   - Days Supply
"RTN","PSORRPA1",15,0)
 ; REMARKS - Remarks entered by 'remote' (filling) facility.
"RTN","PSORRPA1",16,0)
 ; PHARM   - Remote pharmacist's name
"RTN","PSORRPA1",17,0)
 ; PHONE   - remote pharmacists phone number
"RTN","PSORRPA1",18,0)
 ; SITE    - remote filling site.
"RTN","PSORRPA1",19,0)
 ;
"RTN","PSORRPA1",20,0)
PAR(VALMSG,RXNUM,PFDATE,MW,QTY,DSUPP,REMARKS,PHARM,PHONE,SITE,RX0,RX2,RXSTA,RPROV,RSIG,RPAR0,ROR1,RX3,RREF0) ;
"RTN","PSORRPA1",21,0)
 N RRXIEN,PSOPAR,ORN,PSOLST,XTMPLOC,PASSLOC,HFSIEN,FULLPTH,HFSDONE,PTHDAT,PTHPIECE,DEL,DELARR,FTGOPEN,FOUND,FTGSTRT,FTGOPEN,STATION,HDRUG
"RTN","PSORRPA1",22,0)
 N PERR,PDIR,PFIL,CSVAL,C,D,E,NEWPFIEN,PFIEN,PFIENS,PSOEXREP,PSOFROM,DINACT,PSOPHDUZ,PSODFDIR,PSOFNAME,PSOZ1,RREFIEN
"RTN","PSORRPA1",23,0)
 S $ETRAP="D ^%ZTER Q"
"RTN","PSORRPA1",24,0)
 S (RRXIEN,RXN)=$O(^PSRX("B",RXNUM,0)),PSOSIEN=$$GET1^DIQ(52,RRXIEN,20,"I")
"RTN","PSORRPA1",25,0)
 I '$$GET1^DIQ(59,PSOSIEN,3001,"I") D  Q
"RTN","PSORRPA1",26,0)
 .S VALMSG(1)="The OneVA pharmacy flag is turned 'OFF' at this facility."
"RTN","PSORRPA1",27,0)
 .S VALMSG(2)="Unable to process refill/partial fill requests."
"RTN","PSORRPA1",28,0)
 .D PARFAIL(.VALMSG,RRXIEN,PHARM,PHONE,SITE)
"RTN","PSORRPA1",29,0)
 S HDRUG=$$GET1^DIQ(52,RRXIEN,6,"I")
"RTN","PSORRPA1",30,0)
 S DINACT=$$GET1^DIQ(50,HDRUG,100,"I")
"RTN","PSORRPA1",31,0)
 I DINACT>0,DINACT<$$NOW^XLFDT S VALMSG(1)="Drug is inactive for Rx# "_RXNUM_". Cannot process partial fill." D PARFAIL(.VALMSG,RRXIEN,PHARM,PHONE,SITE) Q
"RTN","PSORRPA1",32,0)
 S CSVAL=$$GET1^DIQ(50,HDRUG,3,"E"),CSVAL=$E(CSVAL,1)
"RTN","PSORRPA1",33,0)
 I CSVAL,CSVAL>0,CSVAL<6 D PARFAIL(.VALMSG,RRXIEN,PHARM,PHONE,SITE) S VALMSG(1)="Rx #"_RXNUM_" cannot be partially filled. The associated drug is considered a controlled substance at the host facility." Q
"RTN","PSORRPA1",34,0)
 I $D(^PSRX(RRXIEN,"ADP",PFDATE,RRXIEN)) S VALMSG(1)="A partial fill already exists for "_$$FMTE^XLFDT(PFDATE,"5D")_".",VALMSG(2)="Partial cannot be processed" D PARFAIL(.VALMSG,RRXIEN,PHARM,PHONE,SITE) Q
"RTN","PSORRPA1",35,0)
 S PSOPAR=$G(^PS(59,PSOSIEN,1)),PSOSITE=PSOSIEN
"RTN","PSORRPA1",36,0)
 ; set up PSOLST
"RTN","PSORRPA1",37,0)
 S ORN=1,PSOLST(ORN)=52_U_RRXIEN_U_U
"RTN","PSORRPA1",38,0)
 S PSOPHDUZ=$$GET1^DIQ(52,RRXIEN,23,"I") I 'PSOPHDUZ S PSOPHDUZ=.5
"RTN","PSORRPA1",39,0)
 S PSORPDFN=+$P($G(^PSRX($P(PSOLST(ORN),"^",2),0)),"^",2)
"RTN","PSORRPA1",40,0)
 S DA=$P(PSOLST(ORN),"^",2),RX0=^PSRX(DA,0),J=DA,RX2=$G(^(2)),R3=$G(^(3)) S:'$G(BBFLG) BBRX(1)=""
"RTN","PSORRPA1",41,0)
 N PSORF,PSOTRIC D TRIC^PSORXL1(DA) I PSOTRIC&($$STATUS^PSOBPSUT(DA,PSORF)'["PAYABLE") D  Q
"RTN","PSORRPA1",42,0)
 . S VALMSG(1)="Partial cannot be filled on Tricare non-payable Rx."
"RTN","PSORRPA1",43,0)
 . D PARFAIL(.VALMSG,RRXIEN,PHARM,PHONE,SITE)
"RTN","PSORRPA1",44,0)
 I +$P($G(^PSRX(DA,2)),"^",6)<DT D
"RTN","PSORRPA1",45,0)
 .S:$P($G(^PSRX(DA,"STA")),"^")<12 $P(^PSRX(DA,"STA"),"^")=11
"RTN","PSORRPA1",46,0)
 .S COMM="Medication Expired on "_$E($P(^PSRX(DA,2),"^",6),4,5)_"/"_$E($P(^(2),"^",6),6,7)_"/"_$E($P(^(2),"^",6),2,3)
"RTN","PSORRPA1",47,0)
 .S STAT="SC",PHARMST="ZE" D EN^PSOHLSN1(DA,STAT,PHARMST,COMM) K STAT,PHARMST,COMM,RX0,J,RX2,R3
"RTN","PSORRPA1",48,0)
 I +^PSRX(DA,"STA"),+^("STA")'=5,+^("STA")'=11 D  K DA D ULK Q
"RTN","PSORRPA1",49,0)
 .S C=";"_+^PSRX(DA,"STA")_":",X=$P(^DD(52,100,0),"^",3),E=$F(X,C),D=$P($E(X,E,999),";")   ;IA#999
"RTN","PSORRPA1",50,0)
 .S VALMSG(1)="Prescription is in a "_D_" status."
"RTN","PSORRPA1",51,0)
 .D PARFAIL(.VALMSG,RRXIEN,PHARM,PHONE,SITE)
"RTN","PSORRPA1",52,0)
 I $G(PSXSYS),($O(^PS(52.5,"B",DA,""))) S PSOZ1=$O(^PS(52.5,"B",DA,"")) D
"RTN","PSORRPA1",53,0)
 .I $P($G(^PS(52.5,PSOZ1,0)),"^",7)="Q"!($P($G(^(0)),"^",7)="L") D
"RTN","PSORRPA1",54,0)
 ..S VALMSG(1)="A partial entered for this Rx cannot be suspended."
"RTN","PSORRPA1",55,0)
 ..S VALMSG(2)="A fill for this Rx is already suspended for CMOP transmission."
"RTN","PSORRPA1",56,0)
 ..S VALMSG(3)="You may pull this fill from suspense or enter a partial and print the label."
"RTN","PSORRPA1",57,0)
 ..D PARFAIL(.VALMSG,RRXIEN,PHARM,PHONE,SITE)
"RTN","PSORRPA1",58,0)
CLC S PSOCLC=PSOPHDUZ,PHYS=$P(^PSRX(DA,0),"^",4),DRG=$P(^(0),"^",6)
"RTN","PSORRPA1",59,0)
 I 'PHYS,$O(^PSRX(DA,1,0)) F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S PHYS=$S($P(^PSRX(DA,1,I,0),"^",17):$P(^PSRX(DA,1,I,0),"^",17),1:PHYS)
"RTN","PSORRPA1",60,0)
 S PSOPRZ=0 I $O(^PSRX(DA,"P",0)) N Z2 F Z2=0:0 S Z2=$O(^PSRX(DA,"P",Z2)) Q:'Z2  S PSOPRZ=Z2
"RTN","PSORRPA1",61,0)
 I $D(RXPR(DA)),'$D(^PSRX(DA,"P",$G(RXPR(DA)))) D RMP^PSOCAN3
"RTN","PSORRPA1",62,0)
 ; bwf - save information into database, just as it would be through ^DIE
"RTN","PSORRPA1",63,0)
 S FDA(52.2,"+1,"_RRXIEN_",",.01)=PFDATE D UPDATE^DIE(,"FDA","NEWPFIEN","PERR") K FDA
"RTN","PSORRPA1",64,0)
 I $D(PERR) M VALMSG=PERR
"RTN","PSORRPA1",65,0)
 S PFIEN=$O(NEWPFIEN(0)),PFIEN=$G(NEWPFIEN(PFIEN))
"RTN","PSORRPA1",66,0)
 ; set Z1 variable as was done in the ^DIE call for later use.
"RTN","PSORRPA1",67,0)
 S Z1=PFIEN
"RTN","PSORRPA1",68,0)
 S PFIENS=PFIEN_","_RRXIEN_","
"RTN","PSORRPA1",69,0)
 ; set PM variable as was done in the ^DIE call for later use.
"RTN","PSORRPA1",70,0)
 I MW="M"!('$P($G(PSOPAR),U,12)) S PM=1
"RTN","PSORRPA1",71,0)
 S FDA(52.2,PFIENS,.02)=MW
"RTN","PSORRPA1",72,0)
 S FDA(52.2,PFIENS,.04)=QTY
"RTN","PSORRPA1",73,0)
 S FDA(52.2,PFIENS,.041)=DSUPP
"RTN","PSORRPA1",74,0)
 ; currently we have no local pharmacist. May need to add entry to file 200 for 'REMOTE,PHARMACIST' or 'PHARMACIST,REMOTE'
"RTN","PSORRPA1",75,0)
 S FDA(52.2,PFIENS,.05)=PSOPHDUZ
"RTN","PSORRPA1",76,0)
 ; can we use DUZ as the clerk code, or will this need another value??
"RTN","PSORRPA1",77,0)
 S FDA(52.2,PFIENS,.07)=PSOPHDUZ
"RTN","PSORRPA1",78,0)
 S FDA(52.2,PFIENS,6)=PHYS
"RTN","PSORRPA1",79,0)
 S FDA(52.2,PFIENS,.08)=$$NOW^XLFDT
"RTN","PSORRPA1",80,0)
 S FDA(52.2,PFIENS,.09)=PSOSITE
"RTN","PSORRPA1",81,0)
 S FDA(52.2,PFIENS,.03)=REMARKS
"RTN","PSORRPA1",82,0)
 ;
"RTN","PSORRPA1",83,0)
 ; setting the partial fill date to the dispense date to match the 
"RTN","PSORRPA1",84,0)
 ; HL7 response
"RTN","PSORRPA1",85,0)
 S FDA(52.2,PFIENS,7.5)=PFDATE
"RTN","PSORRPA1",86,0)
 ;
"RTN","PSORRPA1",87,0)
 S RXPR(RRXIEN)=PFIEN,PSOZZ=1,PRMK=REMARKS
"RTN","PSORRPA1",88,0)
 ; file the rest of the data onto the newly created multiple.
"RTN","PSORRPA1",89,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSORRPA1",90,0)
 I Z1,$G(PRMK)]"" D  D:$T(EN^PSOHDR)]"" EN^PSOHDR("PPAR",RXN) K DIE,RXN,RXF
"RTN","PSORRPA1",91,0)
 .D ACT
"RTN","PSORRPA1",92,0)
 .S ZD(RXN)=+^PSRX(RXN,"P",Z1,0),^PSRX(RXN,"TYPE")=Z1,$P(^PSRX(RXN,"P",Z1,0),"^",11)=$P($G(^PSDRUG(DRG,660)),"^",6)
"RTN","PSORRPA1",93,0)
 S:'$D(PSOFROM) PSOFROM="PARTIAL" S BINGCRT=1 ;D:$D(BINGRTE)&($D(DISGROUP)) ^PSOBING1 K BINGRTE,TM,TM1
"RTN","PSORRPA1",94,0)
 ; bwf 8/14/14 - set up needed variables for label printing
"RTN","PSORRPA1",95,0)
 S PSODFN=$P(^PSRX(RRXIEN,0),U,2)
"RTN","PSORRPA1",96,0)
 S PSORX("PSOL",1)=RRXIEN_","
"RTN","PSORRPA1",97,0)
 S PSORX("MAIL/WINDOW")="WINDOW"
"RTN","PSORRPA1",98,0)
 S PSORX("NAME")=$$GET1^DIQ(2,PSODFN,.01)
"RTN","PSORRPA1",99,0)
 S PSORX("QFLG")=0
"RTN","PSORRPA1",100,0)
 S PSORX("METHOD OF PICKUP")=""
"RTN","PSORRPA1",101,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^")
"RTN","PSORRPA1",102,0)
 N PPL1
"RTN","PSORRPA1",103,0)
 S PPL1=RRXIEN
"RTN","PSORRPA1",104,0)
 S HFSDONE=0,PTHDAT=""
"RTN","PSORRPA1",105,0)
 S PSODFDIR=$$DEFDIR^%ZISH()
"RTN","PSORRPA1",106,0)
 S PSOFNAME="PSOLBL_"_RXNUM_"_"_PSOSITE_"_"_DT_".DAT"
"RTN","PSORRPA1",107,0)
 S FULLPTH=PSODFDIR_PSOFNAME
"RTN","PSORRPA1",108,0)
 ; bwf 8/14/14 - end setup for label printing.
"RTN","PSORRPA1",109,0)
 ; preserve IO
"RTN","PSORRPA1",110,0)
 D SAVDEV^%ZISUTL("ONEVAHLIO")
"RTN","PSORRPA1",111,0)
 ; delete the file first to ensure there isn't one lingering around
"RTN","PSORRPA1",112,0)
 S DELARR("PSOLBL_"_RXNUM_"_"_PSOSITE_"_"_DT_".DAT")="" S DEL=$$DEL^%ZISH(PSODFDIR,$NA(DELARR))
"RTN","PSORRPA1",113,0)
 S PSOEXREP=1
"RTN","PSORRPA1",114,0)
 ; call out to generate label
"RTN","PSORRPA1",115,0)
 D LABEL^PSORWRAP(RRXIEN,"HFS",PSOSITE,PSOPHDUZ,"",PSOFNAME)
"RTN","PSORRPA1",116,0)
 S XTMPLOC="^XTMP(""PSORLBL"","_HLINSTN_","_+RXNUM_",1,0)"
"RTN","PSORRPA1",117,0)
 S PASSLOC="XTMP(""PSORLBL"","_HLINSTN_","_+RXNUM_")"
"RTN","PSORRPA1",118,0)
 K ^XTMP("PSORLBL",HLINSTN,+RXNUM)
"RTN","PSORRPA1",119,0)
 S ^XTMP("PSORLBL",HLINSTN,+RXNUM,0)=DT_U_$$FMADD^XLFDT(DT,30)
"RTN","PSORRPA1",120,0)
 ; looks like we have to wait a moment before the file shows up.
"RTN","PSORRPA1",121,0)
 S FTGSTRT=$$NOW^XLFDT,(FOUND,FTGOPEN)=0
"RTN","PSORRPA1",122,0)
 N PAR S PAR=0
"RTN","PSORRPA1",123,0)
 F  D  Q:$$NOW^XLFDT>$$FMADD^XLFDT(FTGSTRT,,,,15)!(FOUND)!(FTGOPEN)
"RTN","PSORRPA1",124,0)
 .S FTGOPEN=$$FTG^%ZISH(PSODFDIR,PSOFNAME,XTMPLOC,4)
"RTN","PSORRPA1",125,0)
 .I $O(^XTMP("PSORLBL",HLINSTN,+RXNUM,0)) S FOUND=1
"RTN","PSORRPA1",126,0)
 S DELARR("PSOLBL_"_RXNUM_"_"_PSOSITE_"_"_DT_".DAT")="" S DEL=$$DEL^%ZISH(PSODFDIR,$NA(DELARR))
"RTN","PSORRPA1",127,0)
 ; restore IO
"RTN","PSORRPA1",128,0)
 D USE^%ZISUTL("ONEVAHLIO"),RMDEV^%ZISUTL("ONEVAHLIO")
"RTN","PSORRPA1",129,0)
 D UPDPAR(.VALMSG,RRXIEN,PHARM,PHONE,SITE,PASSLOC)
"RTN","PSORRPA1",130,0)
 S RX0=$G(^PSRX(RRXIEN,0)),RX2=$G(^PSRX(RRXIEN,2)),RX3=$G(^PSRX(RRXIEN,3))
"RTN","PSORRPA1",131,0)
 S RXSTA=$G(^PSRX(RRXIEN,"STA")),RPROV=$$GET1^DIQ(200,$P(RX0,U,4),.01,"E")_U_$$GET1^DIQ(200,$P(RX0,U,16),.01,"E")
"RTN","PSORRPA1",132,0)
 S RSIG=$G(^PSRX(RRXIEN,"SIG"))
"RTN","PSORRPA1",133,0)
 S RPAR0=$G(^PSRX(RRXIEN,"P",PFIEN,0))
"RTN","PSORRPA1",134,0)
 S ROR1=$G(^PSRX(RRXIEN,"OR1"))
"RTN","PSORRPA1",135,0)
 S RREFIEN=$O(^PSRX(RRXIEN,1,"A"),-1)
"RTN","PSORRPA1",136,0)
 I RREFIEN S RREF0=$G(^PSRX(RRXIEN,1,RREFIEN,0))
"RTN","PSORRPA1",137,0)
CLCX D ULK K DR,DIE,DRG,PPL,RXP,IOP,DA,PHYS,PSOPRZ,PSORX,PSOSIEN,PSOSITE,PSOX,PSOZZ,PSXSYS,RXPR Q
"RTN","PSORRPA1",138,0)
 ;
"RTN","PSORRPA1",139,0)
KILL S DA=Z1,DIK="^PSRX("_RXN_",""P""," D ^DIK S ^PSRX(RXN,"TYPE")=0
"RTN","PSORRPA1",140,0)
 D ULK S VALMSG(1)="No Partial Fill Dispensed" D PARFAIL(.VALMSG,RRXIEN,PHARM,PHONE,SITE) Q
"RTN","PSORRPA1",141,0)
KL K DFN,RFDAT,RLL,%,PRMK,PM,%Y,%X,D0,D1,DA,DI,DIC,DIE,DLAYGO,DQ,DR,I,II,J,JJJ,N,PHYS,PS,PSDATE,RFL,RFL1,RXF,ST,ST0,Z,Z1,X,Y,PDT,PSL,PSNP
"RTN","PSORRPA1",142,0)
 K PSOM,PSOP,PSOD,PSOU,DIK,DUOUT,IFN,RXN,DRG,HRX,I1,PSOCLC,PSOLIST,PSOLST,PSPAR,RXP D KVA^VADPT Q
"RTN","PSORRPA1",143,0)
ACT ;adds activity info for partial rx
"RTN","PSORRPA1",144,0)
 S RXF=0 F I=0:0 S I=$O(^PSRX(RRXIEN,1,I)) Q:'I  S RXF=I S:I>5 RXF=I+1
"RTN","PSORRPA1",145,0)
 S DA=0 F FDA=0:0 S FDA=$O(^PSRX(RRXIEN,"A",FDA)) Q:'FDA  S DA=FDA
"RTN","PSORRPA1",146,0)
 S DA=DA+1,^PSRX(RRXIEN,"A",0)="^52.3DA^"_DA_"^"_DA,^PSRX(RRXIEN,"A",DA,0)=DT_"^"_"P"_"^"_PSOPHDUZ_"^"_RXF_"^"_PRMK
"RTN","PSORRPA1",147,0)
EX K RXF,I,FDA S DA=RXN
"RTN","PSORRPA1",148,0)
 Q
"RTN","PSORRPA1",149,0)
ULK ;
"RTN","PSORRPA1",150,0)
 K PSOMSG,PSOPLCK,PSORPDFN
"RTN","PSORRPA1",151,0)
 Q
"RTN","PSORRPA1",152,0)
PARFAIL(PSOMSG,PSOIEN,RPHARM,RPHONE,RSITE) ;
"RTN","PSORRPA1",153,0)
 S PSOMSG(0)=0_U_$$GET1^DIQ(52,PSOIEN,.01,"I")_U_PSOIEN,$P(PSOMSG(0),U,15)=RPHARM,$P(PSOMSG(0),U,16)=RPHONE,$P(PSOMSG(0),U,17)=RSITE
"RTN","PSORRPA1",154,0)
 Q
"RTN","PSORRPA1",155,0)
UPDPAR(PSOMSG,PSOIEN,RPHARM,RPHONE,RSITE,PASSLOC) ;
"RTN","PSORRPA1",156,0)
 N PARIEN,PARIENS,PARDATA,FIL,RXNUM,RFILLDT,QTY,DSUPP,CLERK,LOGDATE,IDIV,EDIV,DISPDT,NDC,FDA,DNAME,DIEN
"RTN","PSORRPA1",157,0)
 S FIL=52.2
"RTN","PSORRPA1",158,0)
 ; get last partial data node
"RTN","PSORRPA1",159,0)
 S PARIEN=$O(^PSRX(PSOIEN,"P",""),-1)
"RTN","PSORRPA1",160,0)
 S RXNUM=$$GET1^DIQ(52,PSOIEN,.01,"E")
"RTN","PSORRPA1",161,0)
 S DNAME=$$GET1^DIQ(52,PSOIEN,6,"E")
"RTN","PSORRPA1",162,0)
 S DIEN=$$GET1^DIQ(52,PSOIEN,6,"I")
"RTN","PSORRPA1",163,0)
 S PARIENS=PARIEN_","_PSOIEN_","
"RTN","PSORRPA1",164,0)
 ; first, set in the remote pharmacist data
"RTN","PSORRPA1",165,0)
 S FDA(52.2,PARIENS,91)=RSITE
"RTN","PSORRPA1",166,0)
 S FDA(52.2,PARIENS,92)=RPHARM
"RTN","PSORRPA1",167,0)
 S FDA(52.2,PARIENS,93)=RPHONE
"RTN","PSORRPA1",168,0)
 D FILE^DIE(,"FDA","MSG") K FDA,RPHARM,RPHONE,RSITE
"RTN","PSORRPA1",169,0)
 ; now query data and build RET(0) holding accurate information from the refill multiple
"RTN","PSORRPA1",170,0)
 D GETS^DIQ(FIL,PARIENS,"**","IE","PARDATA")
"RTN","PSORRPA1",171,0)
 S RFILLDT=$G(PARDATA(FIL,PARIENS,.01,"I"))
"RTN","PSORRPA1",172,0)
 S QTY=$G(PARDATA(FIL,PARIENS,.04,"I"))
"RTN","PSORRPA1",173,0)
 S DSUPP=$G(PARDATA(FIL,PARIENS,.041,"I"))
"RTN","PSORRPA1",174,0)
 S CLERK=$G(PARDATA(FIL,PARIENS,.07,"E"))
"RTN","PSORRPA1",175,0)
 S LOGDATE=$G(PARDATA(FIL,PARIENS,.08,"I"))
"RTN","PSORRPA1",176,0)
 ; internal division number (IEN to PSO SITE file)
"RTN","PSORRPA1",177,0)
 S IDIV=$G(PARDATA(FIL,PARIENS,.09,"I"))
"RTN","PSORRPA1",178,0)
 S EDIV=$G(PARDATA(FIL,PARIENS,.09,"E"))
"RTN","PSORRPA1",179,0)
 ;
"RTN","PSORRPA1",180,0)
 ; there is nothing in this field.
"RTN","PSORRPA1",181,0)
 ; HL7 is returning refill date in the RXD
"RTN","PSORRPA1",182,0)
 ; but trying to log the blank dispense date from file 52.2 into 52.09
"RTN","PSORRPA1",183,0)
 S DISPDT=$G(PARDATA(FIL,PARIENS,7.5,"I"))
"RTN","PSORRPA1",184,0)
 ;
"RTN","PSORRPA1",185,0)
 S NDC=$G(PARDATA(FIL,PARIENS,1,"E"))
"RTN","PSORRPA1",186,0)
 S RSITE=$G(PARDATA(FIL,PARIENS,91,"I"))
"RTN","PSORRPA1",187,0)
 S RPHARM=$G(PARDATA(FIL,PARIENS,92,"E"))
"RTN","PSORRPA1",188,0)
 S RPHONE=$G(PARDATA(FIL,PARIENS,93,"E"))
"RTN","PSORRPA1",189,0)
 S $P(DAT(1),U,3)=RXNUM,$P(DAT(1),U,4)=RSITE,$P(DAT(1),U,7)=QTY,$P(DAT(1),U,8)=DISPDT,$P(DAT(1),U,9)=DNAME,$P(DAT(1),U,10)=DSUPP,$P(DAT(1),U,11)=RPHARM,$P(DAT(1),U,12)=RFILLDT
"RTN","PSORRPA1",190,0)
 D LOGDATA^PSORWRAP($NA(DAT),"OP",,,PSOIEN)
"RTN","PSORRPA1",191,0)
 S PSOMSG(0)=1_U_RXNUM_U_PSOIEN_U_PARIEN_U_RFILLDT_U_DNAME_U_QTY_U_DSUPP_U_CLERK_U_LOGDATE_U_IDIV_U_EDIV_U_DISPDT_U_NDC_U_RPHARM_U_RPHONE_U_RSITE_U_PASSLOC
"RTN","PSORRPA1",192,0)
 I '$L($G(PSOMSG(1))) S PSOMSG(1)="Partial complete for RX #"_RXNUM_"."
"RTN","PSORRPA1",193,0)
 Q
"RTN","PSORWRAP")
0^2^B105667697^B112263517
"RTN","PSORWRAP",1,0)
PSORWRAP ;AITC/BWF - Remote RX API wrapper ;12/12/16 3:21pm
"RTN","PSORWRAP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**454,475**;DEC 1997;Build 5
"RTN","PSORWRAP",3,0)
 ;
"RTN","PSORWRAP",4,0)
 Q
"RTN","PSORWRAP",5,0)
PROCESS ;
"RTN","PSORWRAP",6,0)
 N I,NUM,HLQUIT,DONE,ORCS,ORRS,ORES,ORSS,RXFTYP,RXNUM,RXFDATE,PHINFO,PHDUZ,PHLN,PHFN,RFSITE,RPHONE,RPHARM,QTY,MW,DSUPP,REMARKS
"RTN","PSORWRAP",7,0)
 N HLFS,RET,RXIEN,ZD,RX0,RX2,RXSTA,RPROV,SIG,RPAR0,RREF0,RREF0,ROR1,RX3
"RTN","PSORWRAP",8,0)
 S (RX0,RX2,RX3,RXSTA,RPROV,SIG,RPAR0,RREF0,RREF0,ROR1)=""
"RTN","PSORWRAP",9,0)
 S $ETRAP="D ^%ZTER Q"
"RTN","PSORWRAP",10,0)
 S HLFS=HL("FS")
"RTN","PSORWRAP",11,0)
 S ORCS=$E($G(HL("ECH")),1),ORRS=$E($G(HL("ECH")),2),ORES=$E($G(HL("ECH")),3),ORSS=$E($G(HL("ECH")),4)
"RTN","PSORWRAP",12,0)
 S (I,DONE,HLQUIT)=0
"RTN","PSORWRAP",13,0)
 F  X HLNEXT Q:DONE!HLQUIT'>0  D
"RTN","PSORWRAP",14,0)
 .I '$L($G(HLNODE)) S DONE=1 Q
"RTN","PSORWRAP",15,0)
 .N LOOP
"RTN","PSORWRAP",16,0)
 .S LOOP=0 F  S LOOP=$O(HLNODE(LOOP)) Q:LOOP=""  S HLNODE=HLNODE_HLNODE(LOOP)
"RTN","PSORWRAP",17,0)
 .I $E(HLNODE,1,3)="ORC" D
"RTN","PSORWRAP",18,0)
 ..S RXFTYP=$P(HLNODE,HLFS,2),RXNUM=$P($P(HLNODE,HLFS,3),ORCS),RXFDATE=$P(HLNODE,HLFS,10),PHINFO=$P(HLNODE,HLFS,11)
"RTN","PSORWRAP",19,0)
 ..S PHDUZ=$P(PHINFO,ORCS),PHLN=$P(PHINFO,ORCS,2),PHFN=$P(PHINFO,ORCS,3),RFSITE=$P($P(HLNODE,HLFS,14),ORCS,4),RPHONE=$P(HLNODE,HLFS,15)
"RTN","PSORWRAP",20,0)
 ..S RPHARM=PHLN_","_PHFN
"RTN","PSORWRAP",21,0)
 .I $E(HLNODE,1,3)="RXO" D
"RTN","PSORWRAP",22,0)
 ..S QTY=$P(HLNODE,HLFS,3),MW=$P($P(HLNODE,HLFS,9),ORCS),DSUPP=$P(HLNODE,HLFS,12)
"RTN","PSORWRAP",23,0)
 .I $E(HLNODE,1,3)="NTE" D
"RTN","PSORWRAP",24,0)
 ..S REMARKS=$P(HLNODE,HLFS,4)
"RTN","PSORWRAP",25,0)
 .S I=I+1
"RTN","PSORWRAP",26,0)
 S RXIEN=$O(^PSRX("B",RXNUM,0))
"RTN","PSORWRAP",27,0)
 S DFN=$$GET1^DIQ(52,RXIEN,2,"I")
"RTN","PSORWRAP",28,0)
 I RXFTYP="RF" D
"RTN","PSORWRAP",29,0)
 .D REMREF^PSORREF(.RET,RXNUM,RXFDATE,MW,RPHARM,RPHONE,RFSITE,.RX0,.RX2,.RXSTA,.RPROV,.SIG,.RREF0,.ROR1,.RX3)
"RTN","PSORWRAP",30,0)
 .D BLDACK(.RET,DFN,RXFTYP,RX0,RX2,RXSTA,RPROV,SIG,RREF0,"",ROR1,RX3)
"RTN","PSORWRAP",31,0)
 I RXFTYP="PF" D
"RTN","PSORWRAP",32,0)
 .D PAR^PSORRPA1(.RET,RXNUM,RXFDATE,MW,QTY,DSUPP,REMARKS,RPHARM,RPHONE,RFSITE,.RX0,.RX2,.RXSTA,.RPROV,.SIG,.RPAR0,.ROR1,.RX3,.RREF0)
"RTN","PSORWRAP",33,0)
 .D BLDACK(.RET,DFN,RXFTYP,RX0,RX2,RXSTA,RPROV,SIG,RREF0,RPAR0,ROR1,RX3)
"RTN","PSORWRAP",34,0)
 Q
"RTN","PSORWRAP",35,0)
 ;
"RTN","PSORWRAP",36,0)
 ;Build Acknowlegement to show Rx was filled or in error
"RTN","PSORWRAP",37,0)
BLDACK(DAT,DFN,TYPE,RX0,RX2,RXSTA,RPROV,SIG,RREF0,RPAR0,ROR1,RX3) ;
"RTN","PSORWRAP",38,0)
 N CNT,PIDLP,DONE,PSOHCNT,PNAME,PLNAME,PFNAME,PSOIEN,LBLGLB,LBLOOP,NTECNT,DATLP,ERR,LBLGBL,LBLOVF,LBTXT,PSACKERR,PSORRDAT
"RTN","PSORWRAP",39,0)
 N NODE,HSITE,T,HSNAM,HMFSADD,HACODE,HPHONE,HMFSZIP,HSNUM,HCITY,HSTATE,OFNAME,OFADD,OFPHONE,NODEDAT
"RTN","PSORWRAP",40,0)
 S (NTECNT,CNT)=0
"RTN","PSORWRAP",41,0)
 ; MSA segment
"RTN","PSORWRAP",42,0)
 K ^TMP("HLA",$J)
"RTN","PSORWRAP",43,0)
 S CNT=CNT+1,^TMP("HLA",$J,CNT)="MSA"_HLFS_"AA"_HLFS_$G(HL("MID"))
"RTN","PSORWRAP",44,0)
 ; ERR segment if error
"RTN","PSORWRAP",45,0)
 I $E($G(DAT(0)))=0 D
"RTN","PSORWRAP",46,0)
 .N ERRSEG
"RTN","PSORWRAP",47,0)
 .S $P(ERRSEG,HLFS)="ERR"
"RTN","PSORWRAP",48,0)
 .S $P(ERRSEG,HLFS,4)=207  ; error code - application internal error
"RTN","PSORWRAP",49,0)
 .S $P(ERRSEG,HLFS,5)="E"  ; severity - "E"rror
"RTN","PSORWRAP",50,0)
 .S $P(ERRSEG,HLFS,9)="Unable to complete transaction" ; User Message
"RTN","PSORWRAP",51,0)
 .S CNT=CNT+1
"RTN","PSORWRAP",52,0)
 .S ^TMP("HLA",$J,CNT)=ERRSEG
"RTN","PSORWRAP",53,0)
 ; NTE segment
"RTN","PSORWRAP",54,0)
 S DATLP=0 F  S DATLP=$O(DAT(DATLP)) Q:'DATLP  D
"RTN","PSORWRAP",55,0)
 .S CNT=CNT+1,NTECNT=NTECNT+1,^TMP("HLA",$J,CNT)="NTE"_HLFS_NTECNT_HLFS_"L"_HLFS_$G(DAT(DATLP))
"RTN","PSORWRAP",56,0)
 S LBLGBL=$P($G(DAT(0)),U,18)
"RTN","PSORWRAP",57,0)
 ; build label data into NTE segments
"RTN","PSORWRAP",58,0)
 I $L(LBLGBL) D
"RTN","PSORWRAP",59,0)
 .S LBLGBL=U_LBLGBL
"RTN","PSORWRAP",60,0)
 .S LBLOOP=0 F  S LBLOOP=$O(@LBLGBL@(LBLOOP)) Q:'LBLOOP  D
"RTN","PSORWRAP",61,0)
 ..S LBTXT=$G(@LBLGBL@(LBLOOP,0))
"RTN","PSORWRAP",62,0)
 ..I $D(@LBLGBL@(LBLOOP,"OVF")) D
"RTN","PSORWRAP",63,0)
 ...S LBLOVF=0 F  S LBLOVF=$O(@LBLGBL@(LBLOOP,"OVF",LBLOVF)) Q:'LBLOVF  D
"RTN","PSORWRAP",64,0)
 ....S LBTXT=$G(LBTXT)_$G(@LBLGBL@(LBLOOP,"OVF",LBLOVF,0))
"RTN","PSORWRAP",65,0)
 ..S CNT=CNT+1,NTECNT=NTECNT+1,^TMP("HLA",$J,CNT)="NTE"_HLFS_NTECNT_HLFS_"O"_HLFS_$G(LBTXT)
"RTN","PSORWRAP",66,0)
 ; end label build
"RTN","PSORWRAP",67,0)
 D BLDPID^PSOTPHL2(DFN,"",.PSORRDAT,.HL,.ERR)
"RTN","PSORWRAP",68,0)
 S PSOIEN=$P(DAT(0),U,3)
"RTN","PSORWRAP",69,0)
 S PNAME=$$GET1^DIQ(52,PSOIEN,2,"E")
"RTN","PSORWRAP",70,0)
 S PLNAME=$P(PNAME,","),PFNAME=$P($P(PNAME,",",2)," ")
"RTN","PSORWRAP",71,0)
 S DONE=0
"RTN","PSORWRAP",72,0)
 S CNT=CNT+1
"RTN","PSORWRAP",73,0)
 ; build PID segment
"RTN","PSORWRAP",74,0)
 F PSOHCNT=1:1 D  Q:DONE
"RTN","PSORWRAP",75,0)
 .I '$D(PSORRDAT(PSOHCNT)) S DONE=1 Q
"RTN","PSORWRAP",76,0)
 .S ^TMP("HLA",$J,CNT)=$G(^TMP("HLA",$J,CNT))_PSORRDAT(PSOHCNT)
"RTN","PSORWRAP",77,0)
 S CNT=CNT+1
"RTN","PSORWRAP",78,0)
 S HSITE=$P(RX2,U,9)
"RTN","PSORWRAP",79,0)
 S HSNAM=$$GET1^DIQ(59,HSITE,.01,"E")
"RTN","PSORWRAP",80,0)
 S HMFSADD=$$GET1^DIQ(59,HSITE,.02,"E")
"RTN","PSORWRAP",81,0)
 S HACODE=$$GET1^DIQ(59,HSITE,.03,"E")
"RTN","PSORWRAP",82,0)
 S HPHONE=$$GET1^DIQ(59,HSITE,.04,"E")
"RTN","PSORWRAP",83,0)
 S HMFSZIP=$$GET1^DIQ(59,HSITE,.05,"E")
"RTN","PSORWRAP",84,0)
 S HSNUM=$$GET1^DIQ(59,HSITE,.06,"E")
"RTN","PSORWRAP",85,0)
 S HCITY=$$GET1^DIQ(59,HSITE,.07,"E")
"RTN","PSORWRAP",86,0)
 S HSTATE=$$GET1^DIQ(59,HSITE,.08,"I"),HSTATE=$$GET1^DIQ(5,HSTATE,1,"E")
"RTN","PSORWRAP",87,0)
 S T="~"
"RTN","PSORWRAP",88,0)
 S OFNAME=HSNAM
"RTN","PSORWRAP",89,0)
 S OFADD=HMFSADD_T_T_HCITY_T_HSTATE_T_HMFSZIP
"RTN","PSORWRAP",90,0)
 S OFPHONE=HACODE_"-"_HPHONE
"RTN","PSORWRAP",91,0)
 ;
"RTN","PSORWRAP",92,0)
 ; build ORC segment
"RTN","PSORWRAP",93,0)
 ;S ^TMP("HLA",$J,CNT)="ORC"_HLFS_TYPE_HLFS_$P(DAT(0),U,2)_ORCS_$P(DAT(0),U,17)_ORCS_$$GET1^DIQ(4,$P(DAT(0),U,17),60,"E")
"RTN","PSORWRAP",94,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,1)="ORC"
"RTN","PSORWRAP",95,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,2)=TYPE
"RTN","PSORWRAP",96,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,3)=$P(DAT(0),U,2)_ORCS_$P(DAT(0),U,17)_ORCS_$$FQDN(,$P(DAT(0),U,17))
"RTN","PSORWRAP",97,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,10)=$P(DAT(0),U,5)
"RTN","PSORWRAP",98,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,11)=DFN_ORCS_PLNAME_ORCS_PFNAME
"RTN","PSORWRAP",99,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,14)=ORCS_ORCS_ORCS_$P($$SITE^VASITE(),U,3)
"RTN","PSORWRAP",100,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,16)=$P(RX0,U,13) ; Issue Date
"RTN","PSORWRAP",101,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,20)="P"_ORCS_$$GET1^DIQ(200,$P(RX0,U,16),.01)   ; seq #1
"RTN","PSORWRAP",102,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,20)=$P(^TMP("HLA",$J,CNT),HLFS,20)_ORRS_"VP"_ORCS_$$GET1^DIQ(200,$P(RX2,U,10),.01)  ; seq #2
"RTN","PSORWRAP",103,0)
 ;
"RTN","PSORWRAP",104,0)
 I $G(RREF0)]"" D
"RTN","PSORWRAP",105,0)
 .S $P(^TMP("HLA",$J,CNT),HLFS,20)=$P(^TMP("HLA",$J,CNT),HLFS,20)_ORRS_"C"_ORCS_$$GET1^DIQ(200,$P(RREF0,U,7),.01)  ; seq #3
"RTN","PSORWRAP",106,0)
 .S $P(^TMP("HLA",$J,CNT),HLFS,20)=$P(^TMP("HLA",$J,CNT),HLFS,20)_ORRS_"RP"_ORCS_$$GET1^DIQ(200,$P(RREF0,U,17),.01)   ; seq #4
"RTN","PSORWRAP",107,0)
 ;
"RTN","PSORWRAP",108,0)
 I $G(RPAR0)]"" D
"RTN","PSORWRAP",109,0)
 .S $P(^TMP("HLA",$J,CNT),HLFS,20)=$P(^TMP("HLA",$J,CNT),HLFS,20)_ORRS_"C"_ORCS_$$GET1^DIQ(200,$P(RPAR0,U,7),.01)  ; seq #3
"RTN","PSORWRAP",110,0)
 .S $P(^TMP("HLA",$J,CNT),HLFS,20)=$P(^TMP("HLA",$J,CNT),HLFS,20)_ORRS_"PP"_ORCS_$$GET1^DIQ(200,$P(RPAR0,U,17),.01)   ; seq #4
"RTN","PSORWRAP",111,0)
 ;
"RTN","PSORWRAP",112,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,20)=$P(^TMP("HLA",$J,CNT),HLFS,20)_ORRS_"FP"_ORCS_$$GET1^DIQ(200,$P(ROR1,U,5),.01)   ; seq #5
"RTN","PSORWRAP",113,0)
 N DATA
"RTN","PSORWRAP",114,0)
 S $P(DATA,ORSS,2)=$$GET1^DIQ(44,$P(RX0,U,5),.01)  ; Clinic 
"RTN","PSORWRAP",115,0)
 S $P(OFNAME,ORCS,8)=DATA
"RTN","PSORWRAP",116,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,22)=OFNAME
"RTN","PSORWRAP",117,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,23)=OFADD
"RTN","PSORWRAP",118,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,24)=OFPHONE
"RTN","PSORWRAP",119,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,26)=$$GET1^DIQ(52,PSOIEN,100,"I")_ORCS_$$GET1^DIQ(52,PSOIEN,100,"E")_ORCS_ORCS_$$GET1^DIQ(53,$P(RX0,U,3),2)_ORCS_$$GET1^DIQ(53,$P(RX0,U,3),.01)  ; Rx Status (ex - 1 ACTIVE)
"RTN","PSORWRAP",120,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,28)=$P(RX3,U)  ; Last dispense date in ORC-27 Fillers expected availability date
"RTN","PSORWRAP",121,0)
 S CNT=CNT+1
"RTN","PSORWRAP",122,0)
 ;
"RTN","PSORWRAP",123,0)
 ; build RXD segment
"RTN","PSORWRAP",124,0)
 ;S ^TMP("HLA",$J,CNT)="RXD"_HLFS_1_HLFS_$P(DAT(0),U,6)_ORCS_"NDC"_HLFS_$P(DAT(0),U,5)_HLFS_$P(DAT(0),U,7)
"RTN","PSORWRAP",125,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,1)="RXD"
"RTN","PSORWRAP",126,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,2)=1
"RTN","PSORWRAP",127,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,3)=$P(DAT(0),U,6)_ORCS_"NDC"
"RTN","PSORWRAP",128,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,4)=$P(DAT(0),U,5) ; Fill date
"RTN","PSORWRAP",129,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,5)=$P(DAT(0),U,7) ; Quantity
"RTN","PSORWRAP",130,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,8)=$P(DAT(0),U,3)_"::"_$P(DAT(0),U,4)
"RTN","PSORWRAP",131,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,9)=$$GET1^DIQ(52,PSOIEN,9,"I") ; # of refills remaining
"RTN","PSORWRAP",132,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,11)=$P(DAT(0),U,15) ; Dispensing Pharmacy
"RTN","PSORWRAP",133,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,13)=$P(DAT(0),U,8) ; Days Supply
"RTN","PSORWRAP",134,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,16)=$$GET1^DIQ(52,PSOIEN,10.1,"I")_ORCS_$$GET1^DIQ(52,PSOIEN,10,"I") ; SIGs
"RTN","PSORWRAP",135,0)
 I $D(^PSRX(PSOIEN,"SIG1",1)) D
"RTN","PSORWRAP",136,0)
 .N SIG1CNT
"RTN","PSORWRAP",137,0)
 .S SIG1CNT=0 F  S SIG1CNT=$O(^PSRX(PSOIEN,"SIG1",SIG1CNT)) Q:'SIG1CNT  D
"RTN","PSORWRAP",138,0)
 ..S DATA="SIG1_"_SIG1CNT_ORCS_$G(^PSRX(PSOIEN,"SIG1",SIG1CNT,0))
"RTN","PSORWRAP",139,0)
 ..S $P(^TMP("HLA",$J,CNT),HLFS,16)=$P(^TMP("HLA",$J,CNT),HLFS,16)_ORRS_DATA
"RTN","PSORWRAP",140,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,20)=$P(RX2,U,6)  ; Rx expiration date
"RTN","PSORWRAP",141,0)
 ;
"RTN","PSORWRAP",142,0)
 S $P(^TMP("HLA",$J,CNT),HLFS,23)=$P(RX0,U,18) ; Number of copies into DISPENSE PACKAGE SIZE
"RTN","PSORWRAP",143,0)
 ;
"RTN","PSORWRAP",144,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"GM",1,.PSACKERR)
"RTN","PSORWRAP",145,0)
 K ^TMP("HLA",$J)
"RTN","PSORWRAP",146,0)
 Q
"RTN","PSORWRAP",147,0)
LABEL(RX,PSOLAP,PSOSITE,DUZ,PSOTRAMT,FNAME) ; Print the label.
"RTN","PSORWRAP",148,0)
 ;  Input:        RX  --  Pointer to the prescription in file #52
"RTN","PSORWRAP",149,0)
 ;            PSOLAP  --  Label printer
"RTN","PSORWRAP",150,0)
 ;           PSOSITE  --  Pointer to the Pharmacy in file #59
"RTN","PSORWRAP",151,0)
 ;               DUZ  --  Pointer to the use in file #200
"RTN","PSORWRAP",152,0)
 ;          PSOTRAMT  --  Amount to be paid
"RTN","PSORWRAP",153,0)
 ;
"RTN","PSORWRAP",154,0)
 ;
"RTN","PSORWRAP",155,0)
 Q:PSOLAP["LAT-TERM"
"RTN","PSORWRAP",156,0)
 Q:'$D(^PSRX(RX,0))
"RTN","PSORWRAP",157,0)
 Q:'$D(^PS(59,PSOSITE,0))
"RTN","PSORWRAP",158,0)
 N CT,II,III,NOW,RXFF,X,Y,PSOSYS,PSOPAR,PSOBARS,PDUZ,PSOBAR0,PSOBAR1,REPRINT,PSOCHAMP,PSHRX,DIQUIET
"RTN","PSORWRAP",159,0)
 S DIQUIET=1 D DT^DICRW
"RTN","PSORWRAP",160,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSORWRAP",161,0)
 S:$P($G(^PSRX(RX,"STA")),"^")'=3 REPRINT=""
"RTN","PSORWRAP",162,0)
 ;
"RTN","PSORWRAP",163,0)
IO D SAVDEV^%ZISUTL("ONEVAHLIO")
"RTN","PSORWRAP",164,0)
 N PAR S PAR="0"
"RTN","PSORWRAP",165,0)
 S PAR("HFSNAME")=FNAME,PAR("HFSMODE")="W"
"RTN","PSORWRAP",166,0)
 D OPEN^%ZISUTL("ONEVALABEL",PSOLAP,.PAR)
"RTN","PSORWRAP",167,0)
 Q:POP
"RTN","PSORWRAP",168,0)
 ;
"RTN","PSORWRAP",169,0)
 D USE^%ZISUTL("ONEVALABEL")
"RTN","PSORWRAP",170,0)
 N PSOIOS S PSOIOS=IOS D DEVBAR^PSOBMST
"RTN","PSORWRAP",171,0)
 S PSOSYS=$G(^PS(59,PSOSITE,1))
"RTN","PSORWRAP",172,0)
 S PSOPAR=$G(^PS(59,PSOSITE,1)),PDUZ=DUZ
"RTN","PSORWRAP",173,0)
 S PPL=RX
"RTN","PSORWRAP",174,0)
 S PSOCHAMP=1
"RTN","PSORWRAP",175,0)
 S PSOBARS=PSOBAR1]""&(PSOBAR0]"")&($P(PSOPAR,"^",19))
"RTN","PSORWRAP",176,0)
 D DQ^PSOLBL
"RTN","PSORWRAP",177,0)
 D CLOSE^%ZISUTL("ONEVALABEL")
"RTN","PSORWRAP",178,0)
 D RMDEV^%ZISUTL("ONEVALABEL")
"RTN","PSORWRAP",179,0)
 K PPL
"RTN","PSORWRAP",180,0)
 ;
"RTN","PSORWRAP",181,0)
 Q
"RTN","PSORWRAP",182,0)
 ; log information about the refill or partial fill locally for reporting
"RTN","PSORWRAP",183,0)
 ;HLDAT(1)=MESSAGE^PATIENT DFN^RX NUMBER^REMOTE SITE#^FILL/PARTIAL DATE^PHARMACIST NAME^QUANTITY^DISPENSE DATE^DRUG NAME^DAYS SUPPLY
"RTN","PSORWRAP",184,0)
LOGDATA(HLDAT,TYPE,LOCDRUG,LBLGBL,PSOIEN) ;
"RTN","PSORWRAP",185,0)
 N F,ERR,FDA,DATA,FILERR,NIEN,MSG,LBL,TMPIEN,REFREM,LIEN,LDCOST,TCOST,DSAV,DSAV2,RRFTYP,RRXPR,RRXFL,RPPL
"RTN","PSORWRAP",186,0)
 N RX0,RX2,RX3,RXSTA,HINFO,RSIG,ROR1,RPAR0,RREF0,RFIEN,PARIEN,RIEN,PATST,RSIG1
"RTN","PSORWRAP",187,0)
 S DATA=$G(@HLDAT@(1))
"RTN","PSORWRAP",188,0)
 ;
"RTN","PSORWRAP",189,0)
 ;Q:'+$P(DATA,U,7)  ; no quantity dispensed. WCJ
"RTN","PSORWRAP",190,0)
 ;
"RTN","PSORWRAP",191,0)
 I '$G(PSODFN) S PSODFN=$$GET1^DIQ(52,PSOIEN,2,"I")
"RTN","PSORWRAP",192,0)
 S F=52.09
"RTN","PSORWRAP",193,0)
 ;set up FDA and file data
"RTN","PSORWRAP",194,0)
 S FDA(F,"+1,",.01)=$$NOW^XLFDT
"RTN","PSORWRAP",195,0)
 S FDA(F,"+1,",.02)=PSODFN
"RTN","PSORWRAP",196,0)
 S FDA(F,"+1,",.03)=$P(@HLDAT@(1),U,3)
"RTN","PSORWRAP",197,0)
 S FDA(F,"+1,",.04)=$$FIND1^DIC(4,,"X",$P(@HLDAT@(1),U,4),"D","I $P(^(0),U,11)=""N"",'$P($G(^(99)),U,4)")
"RTN","PSORWRAP",198,0)
 S FDA(F,"+1,",.05)=TYPE
"RTN","PSORWRAP",199,0)
 I TYPE="PR"!(TYPE="RF") S FDA(F,"+1,",.06)=$G(DUZ)
"RTN","PSORWRAP",200,0)
 I TYPE="OR"!(TYPE="OP") S FDA(F,"+1,",.061)=$P(@HLDAT@(1),U,11)
"RTN","PSORWRAP",201,0)
 S FDA(F,"+1,",.07)=$P(@HLDAT@(1),U,7)
"RTN","PSORWRAP",202,0)
 S FDA(F,"+1,",.08)=$P(@HLDAT@(1),U,10)
"RTN","PSORWRAP",203,0)
 S FDA(F,"+1,",.09)=$P(@HLDAT@(1),U,12)
"RTN","PSORWRAP",204,0)
 S FDA(F,"+1,",.1)=$P(@HLDAT@(1),U,8)
"RTN","PSORWRAP",205,0)
 S FDA(F,"+1,",1)=$P(@HLDAT@(1),U,9)
"RTN","PSORWRAP",206,0)
 ; local drug will not be passed in if this is an OF or OR type.
"RTN","PSORWRAP",207,0)
 I $G(LOCDRUG) D
"RTN","PSORWRAP",208,0)
 .S FDA(F,"+1,",1.1)=LOCDRUG
"RTN","PSORWRAP",209,0)
 .S QTY=$P(@HLDAT@(1),U,7) Q:'QTY
"RTN","PSORWRAP",210,0)
 .S LDCOST=$$GET1^DIQ(50,LOCDRUG,16,"I") Q:LDCOST=""
"RTN","PSORWRAP",211,0)
 .S TCOST=QTY*LDCOST
"RTN","PSORWRAP",212,0)
 .S FDA(F,"+1,",1.2)=TCOST
"RTN","PSORWRAP",213,0)
 .S FDA(F,"+1,",1.3)=$$GET1^DIQ(50,LOCDRUG,22,"I")
"RTN","PSORWRAP",214,0)
 D UPDATE^DIE(,"FDA","NIEN","FILERR")
"RTN","PSORWRAP",215,0)
 ;I $D(FILERR) D  Q
"RTN","PSORWRAP",216,0)
 ;.; display error
"RTN","PSORWRAP",217,0)
 S NIEN=$G(NIEN(1))
"RTN","PSORWRAP",218,0)
 S MSG(1)=$P(@HLDAT@(1),U)
"RTN","PSORWRAP",219,0)
 D WP^DIE(52.09,NIEN_",",2,"K","MSG")
"RTN","PSORWRAP",220,0)
 S RRFTYP=TYPE
"RTN","PSORWRAP",221,0)
 ;
"RTN","PSORWRAP",222,0)
 ; if you have a label, store it in the log and print it out.
"RTN","PSORWRAP",223,0)
 I $D(@HLDAT@("LBL")) D
"RTN","PSORWRAP",224,0)
 .M LBL=@HLDAT@("LBL")
"RTN","PSORWRAP",225,0)
 .D WP^DIE(52.09,NIEN_",",3,"K","LBL")
"RTN","PSORWRAP",226,0)
 N %ZIS,ZTRTN,ZTDESC,ZTDTH,ZTSAVE,ZTSK,ZTREQ,RRXPR,RRXFL,RPPL
"RTN","PSORWRAP",227,0)
 I TYPE="PR" S RRXPR($G(@HLDAT@("RIEN")))=1
"RTN","PSORWRAP",228,0)
 I TYPE="RF" S RRXFL($G(@HLDAT@("RIEN")))=1
"RTN","PSORWRAP",229,0)
 S RPPL=$G(@HLDAT@("RIEN"))
"RTN","PSORWRAP",230,0)
 I 'RPPL Q
"RTN","PSORWRAP",231,0)
 S RPPL=RPPL_","
"RTN","PSORWRAP",232,0)
 N IOP S IOP="Q"  ; default to Queueing this
"RTN","PSORWRAP",233,0)
 W ! K POP S %ZIS("B")="",%ZIS("S")="I $$GET1^DIQ(3.5,Y,3,""I""),$D(^%ZIS(2,$$GET1^DIQ(3.5,Y,3,""I""),55,""B"",""LL""))",%ZIS="QMN",%ZIS("A")="Select LABEL DEVICE: " D ^%ZIS
"RTN","PSORWRAP",234,0)
 Q:POP  ; do not pass GO, do not collect $200 - User wants out - sad cause RX was already filled
"RTN","PSORWRAP",235,0)
 ;I '$G(IO("Q")) D RRXLBL Q  ; user really didn't want to queue it and overrode that
"RTN","PSORWRAP",236,0)
 ;I $P(RSIG,U)="" S $P(RSIG,U)=$G(RSIGSTR)
"RTN","PSORWRAP",237,0)
 F DSAV="RX0","RX2","RX3","RXSTA","HINFO","RSIG","PSODFN","LOCDRUG","ROR1","RPAR0","RREF0","RFIEN","PARIEN","RIEN","PATST" D
"RTN","PSORWRAP",238,0)
 .M @DSAV=@HLDAT@(DSAV)
"RTN","PSORWRAP",239,0)
 .S ZTSAVE(DSAV)=""
"RTN","PSORWRAP",240,0)
 M RSIG1=@HLDAT@("RSIG1")
"RTN","PSORWRAP",241,0)
 F DSAV2="PSOSITE","PSODFN","PSOPAR","PSOSYS","RRFTYP","RRXFL(","RRXPR(","RSIG1(","RPPL" D
"RTN","PSORWRAP",242,0)
 .S ZTSAVE(DSAV2)=""
"RTN","PSORWRAP",243,0)
 ;I '$G(IO("Q")) K ZTSAVE D DQ^PSORLLLI,^%ZISC Q
"RTN","PSORWRAP",244,0)
 ; if you made it here, they picked a queueable device to queue this to
"RTN","PSORWRAP",245,0)
 ;S ZTRTN="RRXLBL^PSORWRAP"
"RTN","PSORWRAP",246,0)
 S ZTDESC="OneVA label print",ZTDTH=$H
"RTN","PSORWRAP",247,0)
 S ZTRTN="DQ^PSORLLLI"
"RTN","PSORWRAP",248,0)
 D ^%ZTLOAD
"RTN","PSORWRAP",249,0)
 I $D(ZTSK)[0 W !!?5,"Problems queuing label!"
"RTN","PSORWRAP",250,0)
 E  W !!?5,"Label queued!"
"RTN","PSORWRAP",251,0)
 D HOME^%ZIS K IO("Q") Q
"RTN","PSORWRAP",252,0)
 Q
"RTN","PSORWRAP",253,0)
 ;
"RTN","PSORWRAP",254,0)
RRXLBL ;Remote RX Label print
"RTN","PSORWRAP",255,0)
 N LBLLOOP,LBLTXT
"RTN","PSORWRAP",256,0)
 U IO
"RTN","PSORWRAP",257,0)
 S LBLOOP=0 F  S LBLOOP=$O(LBL(LBLOOP)) Q:'LBLOOP  D
"RTN","PSORWRAP",258,0)
 .S LBTXT=$G(LBL(LBLOOP))
"RTN","PSORWRAP",259,0)
 .W !,LBTXT
"RTN","PSORWRAP",260,0)
 D ^%ZISC
"RTN","PSORWRAP",261,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSORWRAP",262,0)
 Q
"RTN","PSORWRAP",263,0)
 ;
"RTN","PSORWRAP",264,0)
FQDN(SITE,IEN4) ; get Fully Qualified Domain Name
"RTN","PSORWRAP",265,0)
 ;
"RTN","PSORWRAP",266,0)
 I $G(IEN4)="",$G(SITE)="" Q ""  ; Need site # or institution file IEN
"RTN","PSORWRAP",267,0)
 ;
"RTN","PSORWRAP",268,0)
 I $G(IEN4)="" D  Q:$G(IEN4)="" ""
"RTN","PSORWRAP",269,0)
 .S IEN4=$$FIND1^DIC(4,,"X",SITE,"D","I $P(^(0),U,11)=""N"",'$P($G(^(99)),U,4)")
"RTN","PSORWRAP",270,0)
 ;
"RTN","PSORWRAP",271,0)
 N PSOHLNK,RMSDOM
"RTN","PSORWRAP",272,0)
 S PSOHLNK=$O(^HLCS(870,"C",IEN4,0)) ; get first entry (should only be one but you never know) IA#3550
"RTN","PSORWRAP",273,0)
 Q:'$G(PSOHLNK) ""
"RTN","PSORWRAP",274,0)
 ;
"RTN","PSORWRAP",275,0)
 S RMSDOM=$$GET1^DIQ(870,PSOHLNK,.03,"E")  ; get domain name IA#3335
"RTN","PSORWRAP",276,0)
 Q:$G(RMSDOM)="" ""
"RTN","PSORWRAP",277,0)
 ;
"RTN","PSORWRAP",278,0)
 S:$$PROD^XUPROD() RMSDOM="HL7."_RMSDOM   ; prefix domain name
"RTN","PSORWRAP",279,0)
 Q RMSDOM
"VER")
8.0^22.0
"BLD",9803,6)
^390
**END**
**END**

