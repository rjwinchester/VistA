Released PSO*7*567 SEQ #468
Extracted from mail message
**KIDS**:PSO*7.0*567^

**INSTALL NAME**
PSO*7.0*567
"BLD",11184,0)
PSO*7.0*567^OUTPATIENT PHARMACY^0^3190626^y
"BLD",11184,1,0)
^^2^2^3190621^^
"BLD",11184,1,1,0)
The description of this build can be found in the National Patch Module 
"BLD",11184,1,2,0)
under PSO*7*567.
"BLD",11184,4,0)
^9.64PA^^
"BLD",11184,6.3)
5
"BLD",11184,"KRN",0)
^9.67PA^1.5^24
"BLD",11184,"KRN",.4,0)
.4
"BLD",11184,"KRN",.401,0)
.401
"BLD",11184,"KRN",.402,0)
.402
"BLD",11184,"KRN",.403,0)
.403
"BLD",11184,"KRN",.5,0)
.5
"BLD",11184,"KRN",.84,0)
.84
"BLD",11184,"KRN",1.5,0)
1.5
"BLD",11184,"KRN",1.6,0)
1.6
"BLD",11184,"KRN",1.61,0)
1.61
"BLD",11184,"KRN",1.62,0)
1.62
"BLD",11184,"KRN",3.6,0)
3.6
"BLD",11184,"KRN",3.8,0)
3.8
"BLD",11184,"KRN",9.2,0)
9.2
"BLD",11184,"KRN",9.8,0)
9.8
"BLD",11184,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",11184,"KRN",9.8,"NM",1,0)
PSOERX^^0^B134582097
"BLD",11184,"KRN",9.8,"NM",2,0)
PSOERXC1^^0^B106890934
"BLD",11184,"KRN",9.8,"NM","B","PSOERX",1)

"BLD",11184,"KRN",9.8,"NM","B","PSOERXC1",2)

"BLD",11184,"KRN",19,0)
19
"BLD",11184,"KRN",19.1,0)
19.1
"BLD",11184,"KRN",101,0)
101
"BLD",11184,"KRN",409.61,0)
409.61
"BLD",11184,"KRN",771,0)
771
"BLD",11184,"KRN",779.2,0)
779.2
"BLD",11184,"KRN",870,0)
870
"BLD",11184,"KRN",8989.51,0)
8989.51
"BLD",11184,"KRN",8989.52,0)
8989.52
"BLD",11184,"KRN",8994,0)
8994
"BLD",11184,"KRN","B",.4,.4)

"BLD",11184,"KRN","B",.401,.401)

"BLD",11184,"KRN","B",.402,.402)

"BLD",11184,"KRN","B",.403,.403)

"BLD",11184,"KRN","B",.5,.5)

"BLD",11184,"KRN","B",.84,.84)

"BLD",11184,"KRN","B",1.5,1.5)

"BLD",11184,"KRN","B",1.6,1.6)

"BLD",11184,"KRN","B",1.61,1.61)

"BLD",11184,"KRN","B",1.62,1.62)

"BLD",11184,"KRN","B",3.6,3.6)

"BLD",11184,"KRN","B",3.8,3.8)

"BLD",11184,"KRN","B",9.2,9.2)

"BLD",11184,"KRN","B",9.8,9.8)

"BLD",11184,"KRN","B",19,19)

"BLD",11184,"KRN","B",19.1,19.1)

"BLD",11184,"KRN","B",101,101)

"BLD",11184,"KRN","B",409.61,409.61)

"BLD",11184,"KRN","B",771,771)

"BLD",11184,"KRN","B",779.2,779.2)

"BLD",11184,"KRN","B",870,870)

"BLD",11184,"KRN","B",8989.51,8989.51)

"BLD",11184,"KRN","B",8989.52,8989.52)

"BLD",11184,"KRN","B",8994,8994)

"BLD",11184,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",11184,"QUES",0)
^9.62^^
"BLD",11184,"REQB",0)
^9.611^1^1
"BLD",11184,"REQB",1,0)
PSO*7.0*551^1
"BLD",11184,"REQB","B","PSO*7.0*551",1)

"MBREQ")
0
"PKG",170,-1)
1^1
"PKG",170,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",170,22,0)
^9.49I^1^1
"PKG",170,22,1,0)
7.0^2971216^2981113^1
"PKG",170,22,1,"PAH",1,0)
567^3190626
"PKG",170,22,1,"PAH",1,1,0)
^^2^2^3190626
"PKG",170,22,1,"PAH",1,1,1,0)
The description of this build can be found in the National Patch Module 
"PKG",170,22,1,"PAH",1,1,2,0)
under PSO*7*567.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSOERX")
0^1^B134582097^B132801417
"RTN","PSOERX",1,0)
PSOERX ;ALB/BWF - eRx Utilities/RPC's ; 8/3/2016 5:14pm
"RTN","PSOERX",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,527,508,551,567**;DEC 1997;Build 5
"RTN","PSOERX",3,0)
 ;
"RTN","PSOERX",4,0)
EN(SRCH,SORTT,PCV) ; -- main entry point for PSO ERX HOLDING QUEUE
"RTN","PSOERX",5,0)
 N PSOREFSH
"RTN","PSOERX",6,0)
 D EN^VALM("PSO ERX HOLDING QUEUE")
"RTN","PSOERX",7,0)
 Q
"RTN","PSOERX",8,0)
 ;
"RTN","PSOERX",9,0)
HDR ; -- header code
"RTN","PSOERX",10,0)
 N PSOLBK
"RTN","PSOERX",11,0)
 S VALMHDR(1)="PSO ERX HOLDING QUEUE"
"RTN","PSOERX",12,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE  - ADDING DEFAULT LOOKBACK PARAMETER
"RTN","PSOERX",13,0)
 S PSOLBK=$$GET1^DIQ(59,PSOSITE,10.2,"E")
"RTN","PSOERX",14,0)
 S VALMHDR(2)=$S(PSOLBK:$J(" ",21),1:$J(" ",14))_"ERX LOOK-BACK DAYS: "_$S(PSOLBK:PSOLBK,1:"Default value 365")_" ("_$$FMTE^XLFDT($$FMADD^XLFDT(DT,-$S(PSOLBK:PSOLBK,1:365)))_")"
"RTN","PSOERX",15,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERX",16,0)
 I $G(PSOREFSH) K @VALMAR D INIT
"RTN","PSOERX",17,0)
 Q
"RTN","PSOERX",18,0)
 ;
"RTN","PSOERX",19,0)
INIT ; -- init variables and list array
"RTN","PSOERX",20,0)
 ;/BLB/ PSO*7.0*527 - BEING CHANGE - SIGNIFICANT CHANGES HAVE OCCURED TO FACILITATE FASTER PROCESSING TIMES IN THE ERX HOLDING QUEUE
"RTN","PSOERX",21,0)
 N LINE,LINEVAR,X,SGLOB,EF,ESIEN,CHKSTAT,EARY,SUBS,SUBS2,SVAL,SSTWO,EBDATE,ERXIEN,DTLOOP,PTLOOP,ERXDB,ERXDS,ERX,ERXDAT,P5246IEN,BDOVR,EEDATE
"RTN","PSOERX",22,0)
 N CNT
"RTN","PSOERX",23,0)
 S EF=52.49
"RTN","PSOERX",24,0)
 S SGLOB=$NA(^TMP("PSOERX",$J)) K @SGLOB
"RTN","PSOERX",25,0)
 S PSOSRCH=$S($D(SRCH):1,1:0) I PSOSRCH S PSOSRCH(VALMEVL)=""
"RTN","PSOERX",26,0)
 S PSOSRT=$S($D(SORTT):1,1:0) I PSOSRT S PSOSRT(VALMEVL)=""
"RTN","PSOERX",27,0)
 ; initialize LINE
"RTN","PSOERX",28,0)
 I '$G(PSOPINST) Q
"RTN","PSOERX",29,0)
 F CHKSTAT="RJ","RM","PR","E" D
"RTN","PSOERX",30,0)
 .S ESIEN=$$PRESOLV^PSOERXA1(CHKSTAT,"ERX") Q:'ESIEN
"RTN","PSOERX",31,0)
 .S EARY(ESIEN)=""
"RTN","PSOERX",32,0)
 I $D(SRCH) D
"RTN","PSOERX",33,0)
 .I $D(SRCH(1)) S SUBS="EPAT",SVAL=$P(SRCH(1),U) Q
"RTN","PSOERX",34,0)
 .I $D(SRCH(4)) S SUBS="EPROV",SVAL=$P(SRCH(4),U) Q
"RTN","PSOERX",35,0)
 .I $D(SRCH(2)) S SUBS="F",SUBS2="DOB",SVAL=$P(SRCH(2),U) Q
"RTN","PSOERX",36,0)
 .I $D(SRCH(5)) S SUBS="F",SVAL=$P(SRCH(5),U) Q
"RTN","PSOERX",37,0)
 .I $D(SRCH(7)) S SUBS="MTYPE",SVAL=$P(SRCH(7),U) Q
"RTN","PSOERX",38,0)
 .S SUBS="F"
"RTN","PSOERX",39,0)
 I '$D(SRCH) S SUBS="F"
"RTN","PSOERX",40,0)
 S (LINE,CNT)=0
"RTN","PSOERX",41,0)
 ; Look back 90 days
"RTN","PSOERX",42,0)
 S EBDATE=$S($D(SRCH(3)):$P(SRCH(3),U),1:$$FMADD^XLFDT(DT,-90)),EEDATE=$S($D(SRCH(3)):$P(SRCH(3),U,2),1:DT_".9999")
"RTN","PSOERX",43,0)
 ; get lookback days override. Use it if we are not searching by date range.
"RTN","PSOERX",44,0)
 S BDOVR=$$GET1^DIQ(59,PSOSITE,10.2,"E")
"RTN","PSOERX",45,0)
 I $G(PCV) S BDOVR=365
"RTN","PSOERX",46,0)
 I BDOVR,'$D(SRCH(3)) S EBDATE=$$FMADD^XLFDT(DT,-BDOVR)
"RTN","PSOERX",47,0)
 F  S EBDATE=$O(^PS(52.49,SUBS,PSNPINST,EBDATE)) Q:'EBDATE!(EBDATE>EEDATE)!(CNT>998)  D
"RTN","PSOERX",48,0)
 .I $G(SUBS2)="DOB" D  Q
"RTN","PSOERX",49,0)
 ..S P5246IEN=0 F  S P5246IEN=$O(^PS(52.46,SUBS2,SVAL,P5246IEN)) Q:'P5246IEN!(CNT>998)  D
"RTN","PSOERX",50,0)
 ...S ERXIEN=0 F  S ERXIEN=$O(^PS(EF,"EPAT",PSNPINST,EBDATE,P5246IEN,ERXIEN)) Q:'ERXIEN!(CNT>998)  D
"RTN","PSOERX",51,0)
 ....D BLDITEM(ERXIEN,.CNT)
"RTN","PSOERX",52,0)
 .I $G(SVAL)]"" D  Q
"RTN","PSOERX",53,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(EF,SUBS,PSNPINST,EBDATE,SVAL,ERXIEN)) Q:'ERXIEN!(CNT>998)  D
"RTN","PSOERX",54,0)
 ...I $D(PCV),$D(EARY($$GET1^DIQ(52.49,ERXIEN,1,"I"))) Q
"RTN","PSOERX",55,0)
 ...D BLDITEM(ERXIEN,.CNT)
"RTN","PSOERX",56,0)
 .S SSTWO=0 F  S SSTWO=$O(^PS(EF,SUBS,PSNPINST,EBDATE,SSTWO)) Q:'SSTWO!(CNT>998)  D
"RTN","PSOERX",57,0)
 ..; Filter out RJ, RM, and PR status erx's if we are not searching for a specific eRx status
"RTN","PSOERX",58,0)
 ..I '$D(SRCH(5)),$D(EARY(SSTWO)) Q
"RTN","PSOERX",59,0)
 ..; if we are coming from the patient centric view, block RM, RJ, and PR.
"RTN","PSOERX",60,0)
 ..I $D(SRCH),$D(PCV),$D(EARY(SSTWO)) Q
"RTN","PSOERX",61,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(EF,SUBS,PSNPINST,EBDATE,SSTWO,ERXIEN)) Q:'ERXIEN!(CNT>998)  D
"RTN","PSOERX",62,0)
 ...D BLDITEM(ERXIEN,.CNT)
"RTN","PSOERX",63,0)
 S DTLOOP=0
"RTN","PSOERX",64,0)
 F  S DTLOOP=$O(@SGLOB@(DTLOOP)) Q:'DTLOOP  D
"RTN","PSOERX",65,0)
 .S PTLOOP=$S($G(SORTT)=3:0,1:"")
"RTN","PSOERX",66,0)
 .S PTLOOP="" F  S PTLOOP=$O(@SGLOB@(DTLOOP,PTLOOP),$S($G(SORTT)=3:-1,1:1)) Q:PTLOOP=""  D
"RTN","PSOERX",67,0)
 ..S ERXDB="" F  S ERXDB=$O(@SGLOB@(DTLOOP,PTLOOP,ERXDB)) Q:ERXDB=""  D
"RTN","PSOERX",68,0)
 ...S ERXDS="" F  S ERXDS=$O(@SGLOB@(DTLOOP,PTLOOP,ERXDB,ERXDS)) Q:ERXDS=""  D
"RTN","PSOERX",69,0)
 ....S ERX=0 F  S ERX=$O(@SGLOB@(DTLOOP,PTLOOP,ERXDB,ERXDS,ERX)) Q:'ERX  D
"RTN","PSOERX",70,0)
 .....S LINE=LINE+1,LINEVAR=""
"RTN","PSOERX",71,0)
 .....S ERXDAT=$G(@SGLOB@(DTLOOP,PTLOOP,ERXDB,ERXDS,ERX))
"RTN","PSOERX",72,0)
 .....S LINEVAR=$$SETFLD^VALM1(LINE_".",LINEVAR,"#")
"RTN","PSOERX",73,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U),LINEVAR,"PATIENT NAME")
"RTN","PSOERX",74,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,2),LINEVAR,"DOB")
"RTN","PSOERX",75,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,3),LINEVAR,"DRUG")
"RTN","PSOERX",76,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,4),LINEVAR,"PROVIDER")
"RTN","PSOERX",77,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,8),LINEVAR,"STA")
"RTN","PSOERX",78,0)
 .....S LINEVAR=$$SETFLD^VALM1($P(ERXDAT,U,7),LINEVAR,"RECORD DATE")
"RTN","PSOERX",79,0)
 .....D SET^VALM10(LINE,LINEVAR,ERX)
"RTN","PSOERX",80,0)
 I LINE=0 S LINE=LINE+1 D SET^VALM10(LINE,"No results for current query.")
"RTN","PSOERX",81,0)
 S VALMCNT=LINE
"RTN","PSOERX",82,0)
 K @SGLOB
"RTN","PSOERX",83,0)
 Q
"RTN","PSOERX",84,0)
BLDITEM(ERXIEN,CNT) ;
"RTN","PSOERX",85,0)
 N ERXIENS,ERXDAT,RXSTATN,MTYPE,RESTYPE,PATIEN,ERXQFLG,REQIEN,DELTA,FOUND,NMI,PATNM,NEWRX,PTDOBE,EXDS,EXPRIEN,EXPRNM
"RTN","PSOERX",86,0)
 N AUTOST,MANST,ERXSTAT,ERXISTAT,ERXDT,ERXEDT,PTDOB
"RTN","PSOERX",87,0)
 S ERXIENS=ERXIEN_","
"RTN","PSOERX",88,0)
 K ERXDAT D GETS^DIQ(52.49,ERXIENS,".03;.04;.08;1;4.9;3.1;2.1;1;1.2;1.3;52.1","IE","ERXDAT")
"RTN","PSOERX",89,0)
 S RXSTATN=$G(ERXDAT(EF,ERXIENS,1,"E"))
"RTN","PSOERX",90,0)
 S MTYPE=$G(ERXDAT(EF,ERXIENS,.08,"I"))
"RTN","PSOERX",91,0)
 S RESTYPE=$G(ERXDAT(EF,ERXIENS,52.1,"E"))
"RTN","PSOERX",92,0)
 I '$D(SRCH(5)),'$D(SRCH(7)),((RXSTATN="CAN")!(RXSTATN="CNP")!(RXSTATN="CAA")!(RXSTATN="CNE")) Q
"RTN","PSOERX",93,0)
 ; if the eRx is a new refill request and the status is refill request new, check for a response. if no response within 14 days, change to RRE (refill request expired)
"RTN","PSOERX",94,0)
 ; ChangeRequest messages will be checked for expiration status, but will not be displayed in the holding queue list view.
"RTN","PSOERX",95,0)
 I MTYPE="RR",RXSTATN="RRN" D CHKEXP(ERXIEN)
"RTN","PSOERX",96,0)
 S PATIEN=$G(ERXDAT(EF,ERXIENS,.04,"I")) I 'PATIEN S PATIEN=$$GETPAT^PSOERXU5(ERXIEN)
"RTN","PSOERX",97,0)
 I $D(SRCH(1)),PATIEN'=$P($G(SRCH(1)),U) Q
"RTN","PSOERX",98,0)
 S PTDOB=$$GET1^DIQ(52.46,PATIEN,.08,"I")
"RTN","PSOERX",99,0)
 I $D(SRCH(2)),PTDOB'=$G(SRCH(2)) Q
"RTN","PSOERX",100,0)
 I '$D(SRCH)!($G(PCV)),MTYPE="IE",RXSTATN'="RRE" Q
"RTN","PSOERX",101,0)
 I '$D(SRCH)!($G(PCV)),MTYPE="RR" Q
"RTN","PSOERX",102,0)
 ; if this is not a search, is a refill response, and is a response type of 'approved', do not show in the holding queue.
"RTN","PSOERX",103,0)
 I '$D(SRCH(7)),'$D(SRCH(5))!($G(PCV)),MTYPE="RE",RESTYPE="A" Q
"RTN","PSOERX",104,0)
 ; do not display refill response with 'approved with changes' status in the holding queue.
"RTN","PSOERX",105,0)
 S ERXQFLG=0
"RTN","PSOERX",106,0)
 I '$D(SRCH)!($G(PCV)),MTYPE="RE","RXP,RXC,RXA,"[RXSTATN Q
"RTN","PSOERX",107,0)
 I '$D(SRCH)!($G(PCV)),MTYPE="RE",RESTYPE="AWC" D  Q:ERXQFLG
"RTN","PSOERX",108,0)
 .S REQIEN=$$GETREQ^PSOERXU2(ERXIEN) I 'REQIEN Q
"RTN","PSOERX",109,0)
 .D RRDELTA^PSOERXU2(.DELTA,REQIEN,ERXIEN)
"RTN","PSOERX",110,0)
 .I $D(DELTA(52.49,"EXTERNAL PROVIDER")) Q
"RTN","PSOERX",111,0)
 .S ERXQFLG=1
"RTN","PSOERX",112,0)
 I $D(SRCH(7)),MTYPE="" Q
"RTN","PSOERX",113,0)
 N FOUND,NMI
"RTN","PSOERX",114,0)
 S FOUND=0
"RTN","PSOERX",115,0)
 I $D(SRCH(7)) D  Q:'FOUND
"RTN","PSOERX",116,0)
 .F NMI=1:1 D  Q:$P(SRCH(7),U,NMI)=""!(FOUND)
"RTN","PSOERX",117,0)
 ..I $P(SRCH(7),U,NMI)=MTYPE S FOUND=1 Q
"RTN","PSOERX",118,0)
 ; patient name/dob
"RTN","PSOERX",119,0)
 S PATNM=$$GET1^DIQ(52.46,PATIEN,.01,"E") I MTYPE="IE"!(MTYPE="OE") S PATNM=$$GET1^DIQ(52.49,ERXIEN,.08,"E")
"RTN","PSOERX",120,0)
 I '$L(PATNM) D
"RTN","PSOERX",121,0)
 .S NEWRX=$$RESOLV^PSOERXU2(ERXIEN)
"RTN","PSOERX",122,0)
 .I NEWRX S PATNM=$$GET1^DIQ(52.49,ERXIEN,.04,"E")
"RTN","PSOERX",123,0)
 .I '$L(PATNM) S PATNM=$$GET1^DIQ(52.49,ERXIEN,.08,"E")
"RTN","PSOERX",124,0)
 .S PATNM="N/A"
"RTN","PSOERX",125,0)
 S PTDOBE=""
"RTN","PSOERX",126,0)
 I PTDOB]"" S PTDOBE=$$FMTE^XLFDT(PTDOB,"2D")
"RTN","PSOERX",127,0)
 I '$L(PTDOB) S (PTDOB,PTDOBE)="N/A"
"RTN","PSOERX",128,0)
 ; external drug/supply
"RTN","PSOERX",129,0)
 S EXDS=$G(ERXDAT(EF,ERXIENS,3.1,"E")) I '$L(EXDS) S EXDS=$$GETDRUG^PSOERXU5(ERXIEN) I '$L(EXDS) S EXDS="N/A"
"RTN","PSOERX",130,0)
 I $D(SRCH(6)),EXDS'[$P($G(SRCH(6)),U) Q
"RTN","PSOERX",131,0)
 ; external provider ien and name
"RTN","PSOERX",132,0)
 S EXPRIEN=$G(ERXDAT(EF,ERXIENS,2.1,"I")) I 'EXPRIEN S EXPRIEN=$$GETPROV^PSOERXU5(ERXIEN)
"RTN","PSOERX",133,0)
 I $D(SRCH(4)),EXPRIEN'=$P($G(SRCH(4)),U,1) Q
"RTN","PSOERX",134,0)
 ; if there is no external provider, quit - FUTURE ENHANCEMENT - may need to find a way to log, view, and deal with these instances.
"RTN","PSOERX",135,0)
 ; PSO*7*508 - if there is no provider, set it to 'UNKNOWN', and do not quit (may use N/A instead)
"RTN","PSOERX",136,0)
 S EXPRNM=$$GET1^DIQ(52.48,EXPRIEN,.01,"E") I '$L(EXPRNM) S EXPRNM="N/A"
"RTN","PSOERX",137,0)
 ; auto and manual validation status
"RTN","PSOERX",138,0)
 S AUTOST=$G(ERXDAT(EF,ERXIENS,1.2,"E"))
"RTN","PSOERX",139,0)
 S MANST=$G(ERXDAT(EF,ERXIENS,1.3,"E"))
"RTN","PSOERX",140,0)
 S ERXSTAT=$G(ERXDAT(EF,ERXIENS,1,"E"))
"RTN","PSOERX",141,0)
 S ERXISTAT=$G(ERXDAT(EF,ERXIENS,1,"I"))
"RTN","PSOERX",142,0)
 I $D(SRCH(5)),ERXSTAT'=$P(SRCH(5),U,2) Q
"RTN","PSOERX",143,0)
 ; date ERX was received
"RTN","PSOERX",144,0)
 S ERXDT=$G(ERXDAT(EF,ERXIENS,.03,"I")),ERXEDT=$$FMTE^XLFDT($P(ERXDT,"."),"2D")
"RTN","PSOERX",145,0)
 S CNT=CNT+1
"RTN","PSOERX",146,0)
 I $G(SORTT) D  Q
"RTN","PSOERX",147,0)
 .I SORTT=1 S @SGLOB@(1,PATNM,ERXDT-9999999,EXPRNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",148,0)
 .I SORTT=2 S @SGLOB@(1,PTDOB,ERXDT-9999999,PATNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",149,0)
 .I SORTT=3 S @SGLOB@(1,ERXDT-9999999,PATNM,EXPRNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",150,0)
 .I SORTT=4 S @SGLOB@(1,EXPRNM,ERXDT,PATNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",151,0)
 .I SORTT=5 S @SGLOB@(1,ERXSTAT,PATNM,ERXDT-9999999,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",152,0)
 .I SORTT=6 S @SGLOB@(1,EXDS,PATNM,ERXDT-9999999,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",153,0)
 .I SORTT=7 D
"RTN","PSOERX",154,0)
 ..; MTYPE was not defined for 'newrx's from the first release. The post-init converts all rx's to a newRx type
"RTN","PSOERX",155,0)
 ..I MTYPE="" S MTYPE="UNK"
"RTN","PSOERX",156,0)
 ..S @SGLOB@(1,MTYPE,ERXDT-9999999,PATNM,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",157,0)
 I $D(SRCH(7)) S @SGLOB@(9999999-ERXDT,PATNM,PTDOB,EXDS,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT Q
"RTN","PSOERX",158,0)
 S @SGLOB@(ERXDT,PATNM,PTDOB,EXDS,ERXIEN)=PATNM_U_PTDOBE_U_EXDS_U_EXPRNM_U_AUTOST_U_MANST_U_ERXEDT_U_ERXSTAT
"RTN","PSOERX",159,0)
 Q
"RTN","PSOERX",160,0)
 ;
"RTN","PSOERX",161,0)
HELP ; -- help code
"RTN","PSOERX",162,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERX",163,0)
 Q
"RTN","PSOERX",164,0)
 ;
"RTN","PSOERX",165,0)
EXIT ; -- exit code
"RTN","PSOERX",166,0)
 K PSOSRCH(VALMEVL),PSOSRT(VALMEVL),@VALMAR,PSOREFSH
"RTN","PSOERX",167,0)
 I VALMEVL=0 K PSOSRCH,PSOSRT
"RTN","PSOERX",168,0)
 ; instruct centric view to refresh
"RTN","PSOERX",169,0)
 I $D(PCV) S VALMBCK="R" S PSOC1RE=1
"RTN","PSOERX",170,0)
 D FULL^VALM1
"RTN","PSOERX",171,0)
 Q
"RTN","PSOERX",172,0)
 ;
"RTN","PSOERX",173,0)
EX ; early exit logic
"RTN","PSOERX",174,0)
 K PSOSRCH,PSOSRT,SRCH,SORTT
"RTN","PSOERX",175,0)
 D EX^PSOORFI1
"RTN","PSOERX",176,0)
 Q
"RTN","PSOERX",177,0)
EXPND ; -- expand code
"RTN","PSOERX",178,0)
 Q
"RTN","PSOERX",179,0)
 ;
"RTN","PSOERX",180,0)
 ; search list and display results
"RTN","PSOERX",181,0)
SEARCH ;
"RTN","PSOERX",182,0)
 N RES,SVAL,I,DONE,SRCHARY,ERXIEN,ERXLOCK
"RTN","PSOERX",183,0)
 D FULL^VALM1
"RTN","PSOERX",184,0)
 S DONE=0
"RTN","PSOERX",185,0)
 F I=1:1 D  Q:DONE
"RTN","PSOERX",186,0)
 .S RES=$$DIR(,I,.SRCHARY)
"RTN","PSOERX",187,0)
 .I '+RES S DONE=1 Q
"RTN","PSOERX",188,0)
 .S SRCHARY(+RES)=$P(RES,U,2,99)
"RTN","PSOERX",189,0)
 .I $D(SRCHARY(8)) S DONE=1 Q
"RTN","PSOERX",190,0)
 I '$D(SRCHARY) S VALMBCK="R" Q
"RTN","PSOERX",191,0)
 I $G(SRCHARY(8))]"" D  Q
"RTN","PSOERX",192,0)
 .;/BLB PSO*7.0*551 - BEGIN CHANGE - ADDING LOCK FUNCTIONALITY TO SEARCH FUNCTION AND BLOCKING ERX REF# SEARCHES INTO DIFFERENT DIVISIONS
"RTN","PSOERX",193,0)
 .I '$D(^PS(52.49,"B",SRCHARY(8))) W !,"eRx could not be found." D DIRE^PSOERXX1 S VALMBCK="R" Q
"RTN","PSOERX",194,0)
 .S ERXIEN=$O(^PS(52.49,"B",SRCHARY(8),0))
"RTN","PSOERX",195,0)
 .I ERXIEN,$$GET1^DIQ(52.49,ERXIEN,24.1,"I")'=PSNPINST W !!,"eRx does not belong to this division.",! D DIRE^PSOERXX1 S VALMBCK="R" Q
"RTN","PSOERX",196,0)
 .S PATIEN=$$GET1^DIQ(52.49,ERXIEN,.04,"I") Q:'PATIEN
"RTN","PSOERX",197,0)
 .S ERXLOCK=$$L^PSOERX1A(PATIEN,1)
"RTN","PSOERX",198,0)
 .I 'ERXLOCK S DIR(0)="E" D ^DIR K DIR S VALMBCK="R" Q
"RTN","PSOERX",199,0)
 .D EN^PSOERX1(ERXIEN)
"RTN","PSOERX",200,0)
 .D UL^PSOERX1A(PATIEN)
"RTN","PSOERX",201,0)
 .S VALMBCK="R"
"RTN","PSOERX",202,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERX",203,0)
 I $D(STYP) D EN(.SRCHARY,STYP) Q 
"RTN","PSOERX",204,0)
 D EN(.SRCHARY)
"RTN","PSOERX",205,0)
 S VALMBCK="R"
"RTN","PSOERX",206,0)
 Q
"RTN","PSOERX",207,0)
 ; sort target list
"RTN","PSOERX",208,0)
SORT ;
"RTN","PSOERX",209,0)
 N RES,STYP,SVAL
"RTN","PSOERX",210,0)
 D FULL^VALM1
"RTN","PSOERX",211,0)
 S RES=$$DIR(1,0)
"RTN","PSOERX",212,0)
 I '+$P(RES,U) Q
"RTN","PSOERX",213,0)
 S STYP=$P(RES,U)
"RTN","PSOERX",214,0)
 I $D(SRCHARY) D EN(.SRCHARY,STYP) Q
"RTN","PSOERX",215,0)
 D EN(,STYP)
"RTN","PSOERX",216,0)
 Q
"RTN","PSOERX",217,0)
DIR(SORT,CNT,SLIST) ;
"RTN","PSOERX",218,0)
 N DIR,Y,RLINE,STAG,SVAL
"RTN","PSOERX",219,0)
 K DIR
"RTN","PSOERX",220,0)
 S DIR(0)="SO^1:PATIENT NAME;2:DATE OF BIRTH;3:RECEIVED DATE RANGE;4:PROVIDER NAME;5:ERX STATUS;6:DRUG NAME;7:MESSAGE TYPE"
"RTN","PSOERX",221,0)
 I '$D(SORT) S DIR(0)=DIR(0)_";8:ERX REFERENCE NUMBER"
"RTN","PSOERX",222,0)
 I CNT<2 S DIR("L")="Select one of the following "_$S($G(SORT):"sort",1:"search")_" criteria:"
"RTN","PSOERX",223,0)
 I CNT>1 D
"RTN","PSOERX",224,0)
 .S DIR("L")=""
"RTN","PSOERX",225,0)
 .S DIR("L",13)="Select another search criteria or '^' to exit. Press enter to use the currently"
"RTN","PSOERX",226,0)
 .S DIR("L",14)="selected search criteria."
"RTN","PSOERX",227,0)
 S DIR("L",2)=""
"RTN","PSOERX",228,0)
 S DIR("L",3)=" "_$S($D(SLIST(1)):"*",1:"")_"1.) PATIENT NAME"
"RTN","PSOERX",229,0)
 S DIR("L",4)=" "_$S($D(SLIST(2)):"*",1:"")_"2.) DATE OF BIRTH"
"RTN","PSOERX",230,0)
 S DIR("L",5)=" "_$S($D(SLIST(3)):"*",1:"")_"3.) RECEIVED DATE"_$S('$G(SORT):" RANGE",1:"")
"RTN","PSOERX",231,0)
 S DIR("L",6)=" "_$S($D(SLIST(4)):"*",1:"")_"4.) PROVIDER NAME"
"RTN","PSOERX",232,0)
 S DIR("L",7)=" "_$S($D(SLIST(5)):"*",1:"")_"5.) ERX STATUS"
"RTN","PSOERX",233,0)
 S DIR("L",8)=" "_$S($D(SLIST(6)):"*",1:"")_"6.) DRUG NAME"
"RTN","PSOERX",234,0)
 S DIR("L",9)=" "_$S($D(SLIST(7)):"*",1:"")_"7.) MESSAGE TYPE"
"RTN","PSOERX",235,0)
 I '$D(SORT) S DIR("L",10)=" "_$S($D(SLIST(8)):"*",1:"")_"8.) ERX REFERENCE NUMBER"
"RTN","PSOERX",236,0)
 S DIR("L",11)=""
"RTN","PSOERX",237,0)
 S DIR("L",12)=$S($D(SLIST):" * - indicates selected criteria.",1:"")
"RTN","PSOERX",238,0)
 D ^DIR K DIR Q:'Y 0
"RTN","PSOERX",239,0)
 S RES=Y I $G(SORT) Q RES
"RTN","PSOERX",240,0)
 S RLINE=$S(RES=1:"PAT",RES=2:"DOB",RES=3:"RDT",RES=4:"PRVNM",RES=5:"ESTAT",RES=6:"DNAME",RES=7:"MTYPE",RES=8:"EREFNUM",1:"")
"RTN","PSOERX",241,0)
 I RLINE']"" Q 0
"RTN","PSOERX",242,0)
 S STAG=RLINE
"RTN","PSOERX",243,0)
 S SVAL=$$@STAG I SVAL="" Q 0
"RTN","PSOERX",244,0)
 Q RES_U_SVAL
"RTN","PSOERX",245,0)
PAT() ;
"RTN","PSOERX",246,0)
 N Y,DIC
"RTN","PSOERX",247,0)
 S DIC=52.46,DIC(0)="AEMQ" D ^DIC
"RTN","PSOERX",248,0)
 I Y<1 Q ""
"RTN","PSOERX",249,0)
 Q Y
"RTN","PSOERX",250,0)
DOB() ;
"RTN","PSOERX",251,0)
 N %DT,Y
"RTN","PSOERX",252,0)
 S %DT="A"
"RTN","PSOERX",253,0)
 S %DT("A")="Enter the Date of Birth (DOB): "
"RTN","PSOERX",254,0)
 D ^%DT
"RTN","PSOERX",255,0)
 I Y<1 Q ""
"RTN","PSOERX",256,0)
 Q Y
"RTN","PSOERX",257,0)
RDT() ;
"RTN","PSOERX",258,0)
 N BDATE,EDATE,%DT,Y
"RTN","PSOERX",259,0)
 S %DT="A"
"RTN","PSOERX",260,0)
 S %DT("A")="Enter the beginning date: "
"RTN","PSOERX",261,0)
 D ^%DT
"RTN","PSOERX",262,0)
 I Y<0 Q ""
"RTN","PSOERX",263,0)
 S BDATE=Y K Y,%DT
"RTN","PSOERX",264,0)
 S %DT="A"
"RTN","PSOERX",265,0)
 S %DT("A")="Enter the ending date: "
"RTN","PSOERX",266,0)
 S %DT("B")="T"
"RTN","PSOERX",267,0)
 D ^%DT
"RTN","PSOERX",268,0)
 I Y<0 Q ""
"RTN","PSOERX",269,0)
 S EDATE=Y_".999999"
"RTN","PSOERX",270,0)
 Q BDATE_U_EDATE
"RTN","PSOERX",271,0)
PRVNM() ;
"RTN","PSOERX",272,0)
 N Y,DIC
"RTN","PSOERX",273,0)
 S DIC("A")="Select PROVIDER: "
"RTN","PSOERX",274,0)
 S DIC=52.48,DIC(0)="AEQ" D ^DIC
"RTN","PSOERX",275,0)
 I Y<1 Q ""
"RTN","PSOERX",276,0)
 Q Y
"RTN","PSOERX",277,0)
ESTAT() ;
"RTN","PSOERX",278,0)
 ; prompt for erx status
"RTN","PSOERX",279,0)
 N Y,DIC
"RTN","PSOERX",280,0)
 S DIC("A")="Select eRx Status: "
"RTN","PSOERX",281,0)
 S DIC=52.45,DIC(0)="AEQ",DIC("S")="I $D(^PS(52.45,""TYPE"",""ERX"",Y))" D ^DIC
"RTN","PSOERX",282,0)
 I Y<1 Q ""
"RTN","PSOERX",283,0)
 Q Y
"RTN","PSOERX",284,0)
DNAME() ;
"RTN","PSOERX",285,0)
 N DIR,Y
"RTN","PSOERX",286,0)
 S DIR(0)="FO"
"RTN","PSOERX",287,0)
 S DIR("A")="Enter the name or partial name of the incoming eRx drug"
"RTN","PSOERX",288,0)
 D ^DIR
"RTN","PSOERX",289,0)
 I Y=""!(Y="^") Q ""
"RTN","PSOERX",290,0)
 Q $$UP^XLFSTR(Y)
"RTN","PSOERX",291,0)
MTYPE() ;
"RTN","PSOERX",292,0)
 N DIR,Y
"RTN","PSOERX",293,0)
 S DIR(0)="52.49,.08",DIR("A")="Select message type" D ^DIR
"RTN","PSOERX",294,0)
 I Y=""!(Y="^") Q ""
"RTN","PSOERX",295,0)
 Q Y
"RTN","PSOERX",296,0)
MTYPE2 ;
"RTN","PSOERX",297,0)
 N DIR,Y,DONE,SEL
"RTN","PSOERX",298,0)
 S VALMBCK="R"
"RTN","PSOERX",299,0)
 D FULL^VALM1
"RTN","PSOERX",300,0)
 S DIR(0)="52.49,.08",DIR("A")="Select message type" D ^DIR
"RTN","PSOERX",301,0)
 I Y=""!(Y="^") Q
"RTN","PSOERX",302,0)
 S SRCHARY(7)=Y D EN(.SRCHARY)
"RTN","PSOERX",303,0)
 Q
"RTN","PSOERX",304,0)
EREFNUM() ;
"RTN","PSOERX",305,0)
 N DIR,Y
"RTN","PSOERX",306,0)
 S DIR(0)="FO",DIR("A")="Enter the eRx Reference number" D ^DIR
"RTN","PSOERX",307,0)
 I Y=""!(Y="^") Q ""
"RTN","PSOERX",308,0)
 Q $$UP^XLFSTR(Y)
"RTN","PSOERX",309,0)
CHKKEY(DUZ) ;
"RTN","PSOERX",310,0)
 I $D(^XUSEC("PSDRPH",DUZ))!($D(^XUSEC("PSO ERX ADV TECH",DUZ)))!($D(^XUSEC("PSO ERX TECH",DUZ)))!($D(^XUSEC("PSO ERX VIEW",DUZ))) Q 1
"RTN","PSOERX",311,0)
 Q 0
"RTN","PSOERX",312,0)
CHKEXP(IEN) ;
"RTN","PSOERX",313,0)
 N MSGDT,RELMSG,RELMSGT,FOUND
"RTN","PSOERX",314,0)
 S FOUND=0
"RTN","PSOERX",315,0)
 S MSGDT=$$GET1^DIQ(52.49,IEN,.03,"I")
"RTN","PSOERX",316,0)
 S RELMSG=0 F  S RELMSG=$O(^PS(52.49,IEN,201,"B",RELMSG)) Q:'RELMSG  D
"RTN","PSOERX",317,0)
 .S RELMSGT=$$GET1^DIQ(52.49,IEN,.08,"I")
"RTN","PSOERX",318,0)
 .I RELMSGT="RE" S FOUND=1
"RTN","PSOERX",319,0)
 Q:FOUND
"RTN","PSOERX",320,0)
 I $$FMDIFF^XLFDT(DT,MSGDT)>14 S FDA(52.49,IEN_",",1)=$$PRESOLV^PSOERXA1("RRX","ERX") D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX",321,0)
 Q
"RTN","PSOERXC1")
0^2^B106890934^B104037085
"RTN","PSOERXC1",1,0)
PSOERXC1 ;ALB/BWF - eRx Utilities/RPC's ; 6/1/2018 5:14pm
"RTN","PSOERXC1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**508,551,567**;DEC 1997;Build 5
"RTN","PSOERXC1",3,0)
 ;
"RTN","PSOERXC1",4,0)
EN(SRCH,SORTT,PCVSTAT) ; -- main entry point for PSO ERX PATIENT CENTRIC VIEW
"RTN","PSOERXC1",5,0)
 N PSOC1RE
"RTN","PSOERXC1",6,0)
 D EN^VALM("PSO ERX PATIENT CENTRIC VIEW")
"RTN","PSOERXC1",7,0)
 Q
"RTN","PSOERXC1",8,0)
 ;
"RTN","PSOERXC1",9,0)
HDR ; -- header code
"RTN","PSOERXC1",10,0)
 N PSOLBK
"RTN","PSOERXC1",11,0)
 S VALMHDR(1)="                       Patient Centric View"
"RTN","PSOERXC1",12,0)
 ;/BLB/ PSO*7.0*551 - BEGIN CHANGE - ADDING DEFAULT LOOKBACK PARAMETER
"RTN","PSOERXC1",13,0)
 S PSOLBK=$$GET1^DIQ(59,PSOSITE,10.2,"E")
"RTN","PSOERXC1",14,0)
 S VALMHDR(2)=$S(PSOLBK:$J(" ",21),1:$J(" ",14))_"ERX LOOK-BACK DAYS: "_$S(PSOLBK:PSOLBK,1:"Default value 365")_" ("_$$FMTE^XLFDT($$FMADD^XLFDT(DT,-$S(PSOLBK:PSOLBK,1:365)))_")"
"RTN","PSOERXC1",15,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXC1",16,0)
 I $G(PSOC1RE) K @VALMAR,PSOC1RE D INIT
"RTN","PSOERXC1",17,0)
 Q
"RTN","PSOERXC1",18,0)
 ;
"RTN","PSOERXC1",19,0)
INIT ; -- init variables and list array
"RTN","PSOERXC1",20,0)
 N EBDATE,EDATE,BDATE,RXSTAT,RXDATE,ERXIEN,PATIEN,RDATE,ERXSTAT,COUNT,PNAME,DOB,DOB2,NEW,WAIT,IPR,HOLD,TOTAL,RXDATE2
"RTN","PSOERXC1",21,0)
 N RXSTATE,PATCNT,B,G,VAR,DIRECT,LINEVAR,EDAYS,EDLOOP,GLOB,LASTUSER,PATINFO,EDAYS2,PATLOOP,CCR,LINE,OTH,CNT,BDOVR,MTYPE
"RTN","PSOERXC1",22,0)
 N SVAL,P5246IEN,ESCODE
"RTN","PSOERXC1",23,0)
 S PSOSRCH=$S($D(SRCH):1,1:0) I PSOSRCH S PSOSRCH(VALMEVL)=""
"RTN","PSOERXC1",24,0)
 S PSOSRT=$S($D(SORTT):1,1:0) I PSOSRT S PSOSRT(VALMEVL)=""
"RTN","PSOERXC1",25,0)
 K ^TMP("CENTRIC",$J),^TMP("RDATE",$J),^TMP("PSOERXC1",$J)
"RTN","PSOERXC1",26,0)
 I '$D(PSOINST) D
"RTN","PSOERXC1",27,0)
 .D ^PSOLSET
"RTN","PSOERXC1",28,0)
 Q:'$D(PSOINST)
"RTN","PSOERXC1",29,0)
 S GLOB=$NA(^TMP("PSOERXC1",$J)) K @GLOB
"RTN","PSOERXC1",30,0)
 S BDATE=$$FMADD^XLFDT(DT,-365)
"RTN","PSOERXC1",31,0)
 S CNT=0,PATCNT=0
"RTN","PSOERXC1",32,0)
 S EDATE=DT_".9999"
"RTN","PSOERXC1",33,0)
 S RXDATE=BDATE
"RTN","PSOERXC1",34,0)
 S BDOVR=$$GET1^DIQ(59,PSOSITE,10.2,"E") I BDOVR S RXDATE=$$FMADD^XLFDT(DT,-BDOVR)
"RTN","PSOERXC1",35,0)
 S RXDATE2=BDATE
"RTN","PSOERXC1",36,0)
 F  S RXDATE=$O(^PS(52.49,"F",PSNPINST,RXDATE)) Q:'RXDATE!(RXDATE>EDATE)!(RXDATE="")!(PATCNT>998)  D
"RTN","PSOERXC1",37,0)
 .I $D(SRCH(1)) D  Q
"RTN","PSOERXC1",38,0)
 ..S SVAL=$P(SRCH(1),U)
"RTN","PSOERXC1",39,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"EPAT",PSNPINST,RXDATE,SVAL,ERXIEN)) Q:'ERXIEN!(PATCNT>998)  D
"RTN","PSOERXC1",40,0)
 ...D BLDITEM(ERXIEN,.PATCNT,$G(PCVSTAT))
"RTN","PSOERXC1",41,0)
 .I $D(SRCH(2)) D  Q
"RTN","PSOERXC1",42,0)
 ..S SVAL=$P(SRCH(2),U)
"RTN","PSOERXC1",43,0)
 ..S P5246IEN=0 F  S P5246IEN=$O(^PS(52.46,"DOB",SVAL,P5246IEN)) Q:'P5246IEN!(PATCNT>998)  D
"RTN","PSOERXC1",44,0)
 ...S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"EPAT",PSNPINST,RXDATE,P5246IEN,ERXIEN)) Q:'ERXIEN!(PATCNT>998)  D
"RTN","PSOERXC1",45,0)
 ....D BLDITEM(ERXIEN,.PATCNT,$G(PCVSTAT))
"RTN","PSOERXC1",46,0)
 .S RXSTAT=0 F  S RXSTAT=$O(^PS(52.49,"F",PSNPINST,RXDATE,RXSTAT)) Q:'RXSTAT!(PATCNT=999)  D
"RTN","PSOERXC1",47,0)
 ..I +$G(STAT),STAT'=RXSTAT Q
"RTN","PSOERXC1",48,0)
 ..S RXSTATE=$$GET1^DIQ(52.45,RXSTAT,.01,"E")
"RTN","PSOERXC1",49,0)
 ..I ((RXSTATE="RJ")!(RXSTATE="RM")!(RXSTATE="PR")!(RXSTATE="E")) Q
"RTN","PSOERXC1",50,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"F",PSNPINST,RXDATE,RXSTAT,ERXIEN)) Q:'ERXIEN!(PATCNT=999)  D
"RTN","PSOERXC1",51,0)
 ...D BLDITEM(ERXIEN,.PATCNT,$G(PCVSTAT))
"RTN","PSOERXC1",52,0)
 S PATIEN=0,LINE=0
"RTN","PSOERXC1",53,0)
 I '$O(^TMP("CENTRIC",$J,0)) S LINE=$G(LINE)+1,VALMCNT=LINE D SET^VALM10(LINE,"No records found.") Q
"RTN","PSOERXC1",54,0)
 F  S PATIEN=$O(^TMP("CENTRIC",$J,PATIEN)) Q:'PATIEN  D
"RTN","PSOERXC1",55,0)
 .S PNAME=$$GET1^DIQ(52.46,PATIEN,.01)
"RTN","PSOERXC1",56,0)
 .S DOB=$$GET1^DIQ(52.46,PATIEN,.08,"I"),DOB2=$$FMTE^XLFDT(DOB,"5Z")
"RTN","PSOERXC1",57,0)
 .F  S RXDATE2=$O(^PS(52.49,"PAT2",PATIEN,RXDATE2)) Q:'RXDATE2!(RXDATE2>EDATE)  D
"RTN","PSOERXC1",58,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"PAT2",PATIEN,RXDATE2,ERXIEN)) Q:'ERXIEN  D
"RTN","PSOERXC1",59,0)
 ...Q:$$GET1^DIQ(52.49,ERXIEN,24.1,"I")'=PSNPINST
"RTN","PSOERXC1",60,0)
 ...S ERXSTAT=$$GET1^DIQ(52.49,ERXIEN,1,"E")
"RTN","PSOERXC1",61,0)
 ...I (ERXSTAT="PR")!(ERXSTAT="RM")!(ERXSTAT="RJ")!(ERXSTAT="E") Q
"RTN","PSOERXC1",62,0)
 ...S ESCODE=","_$S($E(ERXSTAT)="H":$E(ERXSTAT),1:ERXSTAT)_"," I ",RRE,RXN,RXW,RXD,RXF,CAO,CAR,CAH,CAP,CAX,CAF,N,I,W,H,"'[ESCODE Q
"RTN","PSOERXC1",63,0)
 ...S MTYPE=$$GET1^DIQ(52.49,ERXIEN,.08,"I")
"RTN","PSOERXC1",64,0)
 ...S RDATE=$E($$GET1^DIQ(52.49,ERXIEN,.03,"I"),1,7)
"RTN","PSOERXC1",65,0)
 ...I '$D(^TMP("RDATE",$J,PATIEN,0)) S ^TMP("RDATE",$J,PATIEN,0)=$G(RDATE)
"RTN","PSOERXC1",66,0)
 ...I $D(^TMP("RDATE",$J,PATIEN,0)),^TMP("RDATE",$J,PATIEN,0)>$G(RDATE) S ^TMP("RDATE",$J,PATIEN,0)=$G(RDATE)
"RTN","PSOERXC1",67,0)
 ...S COUNT=$G(^TMP("CENTRIC",$J,PATIEN,0))
"RTN","PSOERXC1",68,0)
 ...I ERXSTAT="N" S $P(COUNT,U,1)=$P($G(COUNT),U)+1
"RTN","PSOERXC1",69,0)
 ...I ERXSTAT="W" S $P(COUNT,U,2)=$P($G(COUNT),U,2)+1
"RTN","PSOERXC1",70,0)
 ...I ERXSTAT="I" S $P(COUNT,U,3)=$P($G(COUNT),U,3)+1
"RTN","PSOERXC1",71,0)
 ...I $E(ERXSTAT)="H" S $P(COUNT,U,4)=$P($G(COUNT),U,4)+1
"RTN","PSOERXC1",72,0)
 ...I ((ERXSTAT="RXN")!(ERXSTAT="RXW")!(ERXSTAT="RXD")!(ERXSTAT="RXF")!(ERXSTAT="CAO")!(ERXSTAT="CAR")!(ERXSTAT="CAH")!(ERXSTAT="CAP")!(ERXSTAT="CAX")!(ERXSTAT="CAF")) D
"RTN","PSOERXC1",73,0)
 ....S $P(COUNT,U,5)=$P($G(COUNT),U,5)+1
"RTN","PSOERXC1",74,0)
 ...; finialize and display count for 'other' types.
"RTN","PSOERXC1",75,0)
 ...I MTYPE="IE",ERXSTAT="RRE" S $P(COUNT,U,6)=$P($G(COUNT),U,6)+1
"RTN","PSOERXC1",76,0)
 ...S ^TMP("CENTRIC",$J,PATIEN,0)=COUNT
"RTN","PSOERXC1",77,0)
 .S COUNT=$G(^TMP("CENTRIC",$J,PATIEN,0))
"RTN","PSOERXC1",78,0)
 .F G=1:1:6 D
"RTN","PSOERXC1",79,0)
 ..I $P(COUNT,U,G)="" D
"RTN","PSOERXC1",80,0)
 ...S $P(COUNT,U,G)=0
"RTN","PSOERXC1",81,0)
 .S NEW=$P(COUNT,U)
"RTN","PSOERXC1",82,0)
 .S WAIT=$P(COUNT,U,2)
"RTN","PSOERXC1",83,0)
 .S IPR=$P(COUNT,U,3)
"RTN","PSOERXC1",84,0)
 .S HOLD=$P(COUNT,U,4)
"RTN","PSOERXC1",85,0)
 .S CCR=$P(COUNT,U,5)
"RTN","PSOERXC1",86,0)
 .S OTH=$P(COUNT,U,6)
"RTN","PSOERXC1",87,0)
 .S EDAYS=$$FMDIFF^XLFDT(DT,$G(^TMP("RDATE",$J,PATIEN,0)))
"RTN","PSOERXC1",88,0)
 .;/BLB/ PSO*7.0*551 - BEGIN CHANGE - NEW LOCK INDICATOR
"RTN","PSOERXC1",89,0)
 .S LASTUSER=$S($D(^XTMP("PSOERXLOCK",PATIEN)):$$GET1^DIQ(200,$P(^XTMP("PSOERXLOCK",PATIEN),U),.01,"E"),1:"")
"RTN","PSOERXC1",90,0)
 .;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXC1",91,0)
 .S TOTAL=""
"RTN","PSOERXC1",92,0)
 .F B=1:1:6 D
"RTN","PSOERXC1",93,0)
 ..S VAR=$P(COUNT,U,B)
"RTN","PSOERXC1",94,0)
 ..S TOTAL=TOTAL+VAR
"RTN","PSOERXC1",95,0)
 .I TOTAL=0 Q
"RTN","PSOERXC1",96,0)
 .I TOTAL>999 S TOTAL=999
"RTN","PSOERXC1",97,0)
 .S EDAYS2=$S($L(EDAYS)=1:" "_EDAYS,1:EDAYS)
"RTN","PSOERXC1",98,0)
 .I $L(TOTAL)=1 S TOTAL="  "_TOTAL
"RTN","PSOERXC1",99,0)
 .I $L(TOTAL)=2 S TOTAL=" "_TOTAL
"RTN","PSOERXC1",100,0)
 .I NEW>99 S NEW=99
"RTN","PSOERXC1",101,0)
 .I $L(NEW)=1 S NEW=" "_NEW
"RTN","PSOERXC1",102,0)
 .I WAIT>99 S WAIT=99
"RTN","PSOERXC1",103,0)
 .I $L(WAIT)=1 S WAIT=" "_WAIT
"RTN","PSOERXC1",104,0)
 .I IPR>99 S IPR=99
"RTN","PSOERXC1",105,0)
 .I $L(IPR)=1 S IPR=" "_IPR
"RTN","PSOERXC1",106,0)
 .I HOLD>99 S HOLD=99
"RTN","PSOERXC1",107,0)
 .I $L(HOLD)=1 S HOLD=" "_HOLD
"RTN","PSOERXC1",108,0)
 .I CCR>99 S CCR=99
"RTN","PSOERXC1",109,0)
 .I $L(CCR)=1 S CCR="  "_CCR
"RTN","PSOERXC1",110,0)
 .I $L(CCR)=2 S CCR=" "_CCR
"RTN","PSOERXC1",111,0)
 .I OTH>99 S OTH=99
"RTN","PSOERXC1",112,0)
 .I $L(OTH)=1 S OTH="  "_OTH
"RTN","PSOERXC1",113,0)
 .I $L(OTH)=2 S OTH=" "_OTH
"RTN","PSOERXC1",114,0)
 .I $G(SORTT) D  Q
"RTN","PSOERXC1",115,0)
 ..I SORTT=1 S @GLOB@(PNAME,PATIEN)=PNAME_U_DOB2_U_EDAYS2_U_LASTUSER_U_NEW_U_WAIT_U_IPR_U_HOLD_U_CCR_U_OTH_U_TOTAL,DIRECT=1
"RTN","PSOERXC1",116,0)
 ..I SORTT=2 S @GLOB@(DOB,PATIEN)=PNAME_U_DOB2_U_EDAYS2_U_LASTUSER_U_NEW_U_WAIT_U_IPR_U_HOLD_U_CCR_U_OTH_U_TOTAL,DIRECT=1
"RTN","PSOERXC1",117,0)
 ..I SORTT=3 S @GLOB@(TOTAL,PATIEN)=PNAME_U_DOB2_U_EDAYS2_U_LASTUSER_U_NEW_U_WAIT_U_IPR_U_HOLD_U_CCR_U_OTH_U_TOTAL,DIRECT=1
"RTN","PSOERXC1",118,0)
 .S @GLOB@(EDAYS,PATIEN)=PNAME_U_DOB2_U_EDAYS2_U_LASTUSER_U_NEW_U_WAIT_U_IPR_U_HOLD_U_CCR_U_OTH_U_TOTAL
"RTN","PSOERXC1",119,0)
 I '$D(DIRECT) S DIRECT=-1
"RTN","PSOERXC1",120,0)
 S EDLOOP=""
"RTN","PSOERXC1",121,0)
 F  S EDLOOP=$O(@GLOB@(EDLOOP),DIRECT) Q:EDLOOP=""  D
"RTN","PSOERXC1",122,0)
 .S PATLOOP=""
"RTN","PSOERXC1",123,0)
 .F  S PATLOOP=$O(@GLOB@(EDLOOP,PATLOOP)) Q:PATLOOP=""  D
"RTN","PSOERXC1",124,0)
 ..S LINE=LINE+1,LINEVAR=""
"RTN","PSOERXC1",125,0)
 ..S PATINFO=$G(@GLOB@(EDLOOP,PATLOOP))
"RTN","PSOERXC1",126,0)
 ..S LINEVAR=$$SETFLD^VALM1(LINE_".",LINEVAR,"#")
"RTN","PSOERXC1",127,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U),LINEVAR,"ERX PATIENT")
"RTN","PSOERXC1",128,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,2),LINEVAR,"DOB")
"RTN","PSOERXC1",129,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,3),LINEVAR,"ED")
"RTN","PSOERXC1",130,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,4),LINEVAR,"LOCKED BY")
"RTN","PSOERXC1",131,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,5),LINEVAR,"NW")
"RTN","PSOERXC1",132,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,6),LINEVAR,"WT")
"RTN","PSOERXC1",133,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,7),LINEVAR,"IP")
"RTN","PSOERXC1",134,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,8),LINEVAR,"HD")
"RTN","PSOERXC1",135,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,9),LINEVAR,"CCR")
"RTN","PSOERXC1",136,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,10),LINEVAR,"OTH")
"RTN","PSOERXC1",137,0)
 ..S LINEVAR=$$SETFLD^VALM1($P(PATINFO,U,11),LINEVAR,"TOT")
"RTN","PSOERXC1",138,0)
 ..D SET^VALM10(LINE,LINEVAR,PATLOOP)
"RTN","PSOERXC1",139,0)
 S VALMCNT=LINE
"RTN","PSOERXC1",140,0)
 K ^TMP("CENTRIC",$J),^TMP("RDATE",$J),^TMP("PSOERXC1",$J)
"RTN","PSOERXC1",141,0)
 Q
"RTN","PSOERXC1",142,0)
CENTSRCH ;
"RTN","PSOERXC1",143,0)
 N RES,SVAL,I,DONE,SRCHARY
"RTN","PSOERXC1",144,0)
 D FULL^VALM1
"RTN","PSOERXC1",145,0)
 S DONE=0
"RTN","PSOERXC1",146,0)
 S VALMBCK="R",PSOC1RE=1
"RTN","PSOERXC1",147,0)
 F I=1:1 D  Q:DONE
"RTN","PSOERXC1",148,0)
 .S RES=$$DIR(,I,.SRCHARY)
"RTN","PSOERXC1",149,0)
 .I '+RES S DONE=1 Q
"RTN","PSOERXC1",150,0)
 .S SRCHARY(+RES)=$P(RES,U,2,99)
"RTN","PSOERXC1",151,0)
 .I $D(SRCHARY(3)) S DONE=1 Q
"RTN","PSOERXC1",152,0)
 I '$D(SRCHARY) S VALMBCK="R" Q
"RTN","PSOERXC1",153,0)
 I $G(SRCHARY(3))]"" D  Q
"RTN","PSOERXC1",154,0)
 .I '$D(^PS(52.49,"B",SRCHARY(3))) W !,"eRx could not be found." D DIRE^PSOERXX1 S VALMBCK="R" Q
"RTN","PSOERXC1",155,0)
 .S ERXIEN=$O(^PS(52.49,"B",SRCHARY(3),0))
"RTN","PSOERXC1",156,0)
 .;/BLB/ PSO*7.0*551 - BEGIN CHANGE - ADDING LOCK FUNCTIONALITY TO SEARCH FUNCTION AND BLOCKING SEARCHING BY ERX REF# INTO DIFFERENT DIVISION
"RTN","PSOERXC1",157,0)
 .I ERXIEN,$$GET1^DIQ(52.49,ERXIEN,24.1,"I")'=PSNPINST W !!,"eRx does not belong to this division.",! D DIRE^PSOERXX1 S VALMBCK="R" Q
"RTN","PSOERXC1",158,0)
 .S PATIEN=$$GET1^DIQ(52.49,ERXIEN,.04,"I") Q:'PATIEN
"RTN","PSOERXC1",159,0)
 .S ERXLOCK=$$L^PSOERX1A(PATIEN,1)
"RTN","PSOERXC1",160,0)
 .I 'ERXLOCK S DIR(0)="E" D ^DIR K DIR S VALMBCK="R" Q
"RTN","PSOERXC1",161,0)
 .D EN^PSOERX1(ERXIEN)
"RTN","PSOERXC1",162,0)
 .D UL^PSOERX1A(PATIEN)
"RTN","PSOERXC1",163,0)
 .S VALMBCK="R"
"RTN","PSOERXC1",164,0)
 ;/BLB/ PSO*7.0*551 - END CHANGE
"RTN","PSOERXC1",165,0)
 I $D(STYP) D EN(.SRCHARY,STYP) Q
"RTN","PSOERXC1",166,0)
 D EN(.SRCHARY)
"RTN","PSOERXC1",167,0)
 ;/BLB
"RTN","PSOERXC1",168,0)
 Q
"RTN","PSOERXC1",169,0)
CENTSORT ;
"RTN","PSOERXC1",170,0)
 N RES,STYP,SVAL
"RTN","PSOERXC1",171,0)
 D FULL^VALM1
"RTN","PSOERXC1",172,0)
 S VALMBCK="R",PSOC1RE=1
"RTN","PSOERXC1",173,0)
 S RES=$$DIR(1,0)
"RTN","PSOERXC1",174,0)
 I '+$P(RES,U) S VALMBCK="R" Q
"RTN","PSOERXC1",175,0)
 S STYP=$P(RES,U)
"RTN","PSOERXC1",176,0)
 I $D(SRCHARY) D EN(.SRCHARY,STYP) Q
"RTN","PSOERXC1",177,0)
 D EN(,STYP,PCVSTAT)
"RTN","PSOERXC1",178,0)
 Q
"RTN","PSOERXC1",179,0)
SBN ;NOTES: KEEPS UNLOCKING REGARDLESS OF THE USER COMING BACK FROM AN ACTUAL LOCK. MAY NEED TO CONSIDER A TAG THAT DETERMINES WHETHER OR NOT TO
"RTN","PSOERXC1",180,0)
 ;GO TO THE LOCK IN THE FIRST PLACE, OR RE-WRITE THE ENTIRE SBN FUNCTIONS.
"RTN","PSOERXC1",181,0)
 N Y,ERXPAT,PATIEN,ERXLOCK,SRCH
"RTN","PSOERXC1",182,0)
 D FULL^VALM1
"RTN","PSOERXC1",183,0)
 S Y=+$P(XQORNOD(0),"=",2)
"RTN","PSOERXC1",184,0)
 I 'Y S VALMBCK="R" Q
"RTN","PSOERXC1",185,0)
 S PATIEN=$O(@VALMAR@("IDX",Y,"")) Q:'PATIEN
"RTN","PSOERXC1",186,0)
 S ERXLOCK=$$L^PSOERX1A(PATIEN,1)
"RTN","PSOERXC1",187,0)
 I 'ERXLOCK S DIR(0)="E" D ^DIR K DIR S VALMBCK="R" Q
"RTN","PSOERXC1",188,0)
 S SRCH(1)=PATIEN D EN^PSOERX(.SRCH,,1)
"RTN","PSOERXC1",189,0)
 D UL^PSOERX1A(PATIEN)
"RTN","PSOERXC1",190,0)
 S VALMBCK="R"
"RTN","PSOERXC1",191,0)
 K %
"RTN","PSOERXC1",192,0)
 Q
"RTN","PSOERXC1",193,0)
PATDATA ;
"RTN","PSOERXC1",194,0)
 I '$O(@VALMAR@("IDX",0)) S VALMSG="No records found!" S VALMBCK="" Q
"RTN","PSOERXC1",195,0)
 N DIR,Y,RESP,PATIEN,SRCH
"RTN","PSOERXC1",196,0)
 D FULL^VALM1
"RTN","PSOERXC1",197,0)
 S DIR(0)="N^"_VALMBG_":"_VALMLST_":0" D ^DIR
"RTN","PSOERXC1",198,0)
 I 'Y S VALMBCK="R" Q
"RTN","PSOERXC1",199,0)
 S RESP=Y
"RTN","PSOERXC1",200,0)
 S PATIEN=$O(@VALMAR@("IDX",RESP,"")) Q:'PATIEN 
"RTN","PSOERXC1",201,0)
 S ERXLOCK=$$L^PSOERX1A(PATIEN,1)
"RTN","PSOERXC1",202,0)
 I 'ERXLOCK S DIR(0)="E" D ^DIR K DIR S VALMBCK="R" Q
"RTN","PSOERXC1",203,0)
 S SRCH(1)=PATIEN D EN^PSOERX(.SRCH,,1)
"RTN","PSOERXC1",204,0)
 D UL^PSOERX1A(PATIEN)
"RTN","PSOERXC1",205,0)
 K %
"RTN","PSOERXC1",206,0)
 S VALMBCK="R"
"RTN","PSOERXC1",207,0)
 Q
"RTN","PSOERXC1",208,0)
DIR(SORT,CNT,SLIST) ;
"RTN","PSOERXC1",209,0)
 N DIR,Y,RLINE,STAG,SVAL
"RTN","PSOERXC1",210,0)
 K DIR
"RTN","PSOERXC1",211,0)
 S DIR(0)="SO^1:PATIENT NAME;2:DATE OF BIRTH"
"RTN","PSOERXC1",212,0)
 I '$D(SORT) S DIR(0)=DIR(0)_";3:ERX REFERENCE NUMBER"
"RTN","PSOERXC1",213,0)
 I CNT<2 S DIR("L")="Select one of the following "_$S($G(SORT):"sort",1:"search")_" criteria:"
"RTN","PSOERXC1",214,0)
 I CNT>1 D
"RTN","PSOERXC1",215,0)
 .S DIR("L")=""
"RTN","PSOERXC1",216,0)
 .S DIR("L",11)="Select another search criteria or '^' to exit. Press enter to use the currently"
"RTN","PSOERXC1",217,0)
 .S DIR("L",12)="selected search criteria."
"RTN","PSOERXC1",218,0)
 S DIR("L",2)=""
"RTN","PSOERXC1",219,0)
 S DIR("L",3)=" "_$S($D(SLIST(1)):"*",1:"")_"1.) PATIENT NAME"
"RTN","PSOERXC1",220,0)
 S DIR("L",4)=" "_$S($D(SLIST(2)):"*",1:"")_"2.) DATE OF BIRTH"
"RTN","PSOERXC1",221,0)
 I '$D(SORT) S DIR("L",5)=" "_$S($D(SLIST(3)):"*",1:"")_"3.) ERX REFERENCE NUMBER"
"RTN","PSOERXC1",222,0)
 S DIR("L",6)=""
"RTN","PSOERXC1",223,0)
 S DIR("L",7)=$S($D(SLIST):" * - indicates selected criteria.",1:"")
"RTN","PSOERXC1",224,0)
 D ^DIR K DIR Q:'Y 0
"RTN","PSOERXC1",225,0)
 S RES=Y I $G(SORT) Q RES
"RTN","PSOERXC1",226,0)
 S RLINE=$S(RES=1:"PAT",RES=2:"DOB",RES=3:"EREFNUM",1:"")
"RTN","PSOERXC1",227,0)
 I RLINE']"" Q 0
"RTN","PSOERXC1",228,0)
 S STAG=RLINE
"RTN","PSOERXC1",229,0)
 S SVAL=$$@STAG I SVAL="" Q 0
"RTN","PSOERXC1",230,0)
 Q RES_U_SVAL
"RTN","PSOERXC1",231,0)
PAT() ;
"RTN","PSOERXC1",232,0)
 N Y,DIC
"RTN","PSOERXC1",233,0)
 S DIC=52.46,DIC(0)="AEMQ" D ^DIC
"RTN","PSOERXC1",234,0)
 I Y<1 Q ""
"RTN","PSOERXC1",235,0)
 Q Y
"RTN","PSOERXC1",236,0)
DOB() ;
"RTN","PSOERXC1",237,0)
 N %DT,Y
"RTN","PSOERXC1",238,0)
 S %DT="A"
"RTN","PSOERXC1",239,0)
 S %DT("A")="Enter the Date of Birth (DOB): "
"RTN","PSOERXC1",240,0)
 D ^%DT
"RTN","PSOERXC1",241,0)
 I Y<1 Q ""
"RTN","PSOERXC1",242,0)
 Q Y
"RTN","PSOERXC1",243,0)
EREFNUM() ;
"RTN","PSOERXC1",244,0)
 N DIR,Y
"RTN","PSOERXC1",245,0)
 S DIR(0)="FO",DIR("A")="Enter the eRx Reference number" D ^DIR
"RTN","PSOERXC1",246,0)
 I Y=""!(Y="^") Q ""
"RTN","PSOERXC1",247,0)
 Q $$UP^XLFSTR(Y)
"RTN","PSOERXC1",248,0)
BLDITEM(IEN,PATCNT,STAT) ;
"RTN","PSOERXC1",249,0)
 N PATIEN,DOB,ERXSTAT,ERXESTAT,ESCODE
"RTN","PSOERXC1",250,0)
 S ERXSTAT=$$GET1^DIQ(52.49,ERXIEN,1,"I")
"RTN","PSOERXC1",251,0)
 S ERXESTAT=$$GET1^DIQ(52.49,ERXIEN,1,"E")
"RTN","PSOERXC1",252,0)
 S ESCODE=","_$S($E(ERXESTAT)="H":$E(ERXESTAT),1:ERXESTAT)_"," I ",RXN,RXW,RXD,RXF,CAO,CAR,CAH,CAP,CAX,CAF,N,I,W,H,"'[ESCODE Q
"RTN","PSOERXC1",253,0)
 I $G(STAT)]"" Q:'$$CHKSTAT(STAT,ERXESTAT,ERXSTAT)
"RTN","PSOERXC1",254,0)
 S PATIEN=$$GET1^DIQ(52.49,ERXIEN,.04,"I") Q:'PATIEN
"RTN","PSOERXC1",255,0)
 I $D(SRCH(1)),PATIEN'=$P($G(SRCH(1)),U) Q
"RTN","PSOERXC1",256,0)
 S DOB=$$GET1^DIQ(52.46,PATIEN,.08,"I")
"RTN","PSOERXC1",257,0)
 I $D(SRCH(2)),DOB'=$G(SRCH(2)) Q
"RTN","PSOERXC1",258,0)
 I $D(^TMP("CENTRIC",$J,PATIEN)) Q
"RTN","PSOERXC1",259,0)
 S ^TMP("CENTRIC",$J,PATIEN)="",PATCNT=$G(PATCNT)+1
"RTN","PSOERXC1",260,0)
 Q
"RTN","PSOERXC1",261,0)
CHKSTAT(FILSTAT,ERXSTAT,ERXISTAT) ;
"RTN","PSOERXC1",262,0)
 N RET
"RTN","PSOERXC1",263,0)
 S RET=0
"RTN","PSOERXC1",264,0)
 I $G(FILSTAT)="CCR",ERXSTAT'="RXN",ERXSTAT'="RXW",ERXSTAT'="RXD",ERXSTAT'="RXF",ERXSTAT'="CAO",ERXSTAT'="CAR",ERXSTAT'="CAH",ERXSTAT'="CAP",ERXSTAT'="CAX",ERXSTAT'="CAF" Q RET
"RTN","PSOERXC1",265,0)
 I $G(FILSTAT)="AH",$E(ERXSTAT)'="H" Q RET
"RTN","PSOERXC1",266,0)
 I $G(FILSTAT)'="A",$G(FILSTAT)'="CCR",$G(FILSTAT)'="AH",FILSTAT'=ERXISTAT Q RET
"RTN","PSOERXC1",267,0)
 Q 1
"RTN","PSOERXC1",268,0)
EX ; early exit logic
"RTN","PSOERXC1",269,0)
 K PSOSRCH,PSOSRT,SRCH,SORTT,PSOPRMPT
"RTN","PSOERXC1",270,0)
 S PSOC1RE=1
"RTN","PSOERXC1",271,0)
 D EX^PSOORFI1
"RTN","PSOERXC1",272,0)
 Q
"RTN","PSOERXC1",273,0)
HELP ; -- help code
"RTN","PSOERXC1",274,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOERXC1",275,0)
 Q
"RTN","PSOERXC1",276,0)
 ;
"RTN","PSOERXC1",277,0)
EXIT ; -- exit code
"RTN","PSOERXC1",278,0)
 K PSOPRMPT,@VALMAR
"RTN","PSOERXC1",279,0)
 S PSOC1RE=1
"RTN","PSOERXC1",280,0)
 Q
"RTN","PSOERXC1",281,0)
 ;
"RTN","PSOERXC1",282,0)
EXPND ; -- expand code
"RTN","PSOERXC1",283,0)
 Q
"VER")
8.0^22.2
"BLD",11184,6)
^468
**END**
**END**

