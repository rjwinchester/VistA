EMERGENCY Released PSO*7*550 SEQ #447
Extracted from mail message
**KIDS**:PSO*7.0*550^

**INSTALL NAME**
PSO*7.0*550
"BLD",9675,0)
PSO*7.0*550^OUTPATIENT PHARMACY^0^3181211^y
"BLD",9675,1,0)
^^2^2^3181206^
"BLD",9675,1,1,0)
Restoration of changes introduced in patch PSO*7*504. The changes made to 
"BLD",9675,1,2,0)
PSORENW and PSORENW4 were inadvertently left out of patch PSO*7*508.
"BLD",9675,4,0)
^9.64PA^^
"BLD",9675,6.3)
2
"BLD",9675,"ABPKG")
n
"BLD",9675,"KRN",0)
^9.67PA^779.2^20
"BLD",9675,"KRN",.4,0)
.4
"BLD",9675,"KRN",.401,0)
.401
"BLD",9675,"KRN",.402,0)
.402
"BLD",9675,"KRN",.403,0)
.403
"BLD",9675,"KRN",.5,0)
.5
"BLD",9675,"KRN",.84,0)
.84
"BLD",9675,"KRN",3.6,0)
3.6
"BLD",9675,"KRN",3.8,0)
3.8
"BLD",9675,"KRN",9.2,0)
9.2
"BLD",9675,"KRN",9.8,0)
9.8
"BLD",9675,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",9675,"KRN",9.8,"NM",1,0)
PSORENW^^0^B51301339
"BLD",9675,"KRN",9.8,"NM",2,0)
PSORENW4^^0^B76190857
"BLD",9675,"KRN",9.8,"NM","B","PSORENW",1)

"BLD",9675,"KRN",9.8,"NM","B","PSORENW4",2)

"BLD",9675,"KRN",19,0)
19
"BLD",9675,"KRN",19.1,0)
19.1
"BLD",9675,"KRN",101,0)
101
"BLD",9675,"KRN",409.61,0)
409.61
"BLD",9675,"KRN",771,0)
771
"BLD",9675,"KRN",779.2,0)
779.2
"BLD",9675,"KRN",870,0)
870
"BLD",9675,"KRN",8989.51,0)
8989.51
"BLD",9675,"KRN",8989.52,0)
8989.52
"BLD",9675,"KRN",8994,0)
8994
"BLD",9675,"KRN","B",.4,.4)

"BLD",9675,"KRN","B",.401,.401)

"BLD",9675,"KRN","B",.402,.402)

"BLD",9675,"KRN","B",.403,.403)

"BLD",9675,"KRN","B",.5,.5)

"BLD",9675,"KRN","B",.84,.84)

"BLD",9675,"KRN","B",3.6,3.6)

"BLD",9675,"KRN","B",3.8,3.8)

"BLD",9675,"KRN","B",9.2,9.2)

"BLD",9675,"KRN","B",9.8,9.8)

"BLD",9675,"KRN","B",19,19)

"BLD",9675,"KRN","B",19.1,19.1)

"BLD",9675,"KRN","B",101,101)

"BLD",9675,"KRN","B",409.61,409.61)

"BLD",9675,"KRN","B",771,771)

"BLD",9675,"KRN","B",779.2,779.2)

"BLD",9675,"KRN","B",870,870)

"BLD",9675,"KRN","B",8989.51,8989.51)

"BLD",9675,"KRN","B",8989.52,8989.52)

"BLD",9675,"KRN","B",8994,8994)

"BLD",9675,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9675,"QUES",0)
^9.62^^
"BLD",9675,"REQB",0)
^9.611^1^1
"BLD",9675,"REQB",1,0)
PSO*7.0*508^2
"BLD",9675,"REQB","B","PSO*7.0*508",1)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
550^3181211
"PKG",141,22,1,"PAH",1,1,0)
^^2^2^3181211
"PKG",141,22,1,"PAH",1,1,1,0)
Restoration of changes introduced in patch PSO*7*504. The changes made to 
"PKG",141,22,1,"PAH",1,1,2,0)
PSORENW and PSORENW4 were inadvertently left out of patch PSO*7*508.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSORENW")
0^1^B51301339^B49878168
"RTN","PSORENW",1,0)
PSORENW ; BIR/SAB - renew main driver ;4/25/07 8:42am
"RTN","PSORENW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,30,46,71,96,100,130,148,206,388,390,417,313,411,504,508,550**;DEC 1997;Build 2
"RTN","PSORENW",3,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSORENW",4,0)
 ;External reference to $$L^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",5,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",6,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",7,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",8,0)
 ;External reference to LK^ORX2 supported by DBIA 867
"RTN","PSORENW",9,0)
 ;External reference to ULK^ORX2 supported by DBIA 867
"RTN","PSORENW",10,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORENW",11,0)
 ;External reference to MAIN^TIUEDIT supported by DBIA 2410
"RTN","PSORENW",12,0)
 ;
"RTN","PSORENW",13,0)
ASK ;
"RTN","PSORENW",14,0)
 K PSORENW("FILL DATE"),ZZCOPY D FILLDT^PSODIR2(.PSORENW) S:$G(PSORENW("DFLG")) VALMSG="Renew Rx request canceled",VALMBCK="R"
"RTN","PSORENW",15,0)
 I PSORENW("DFLG")!('$D(PSORENW("FILL DATE"))) S PSORENW("QFLG")=1,PSORENW("DFLG")=0 G ASKX
"RTN","PSORENW",16,0)
 S PSORNW("FILL DATE")=PSORENW("FILL DATE")
"RTN","PSORENW",17,0)
 D MW^PSOCMOPA(.PSORENW)
"RTN","PSORENW",18,0)
 I PSORENW("DFLG") S PSORENW("QFLG")=1,PSORENW("DFLG")=0 G ASKX
"RTN","PSORENW",19,0)
 S PSORNW("MAIL/WINDOW")=PSORENW("MAIL/WINDOW") S PSORX("MAIL/WINDOW")=$S(PSORENW("MAIL/WINDOW")="M":"MAIL",1:"WINDOW")
"RTN","PSORENW",20,0)
 D NOORE^PSONEW(.PSORENW) S:$G(PSORENW("DFLG")) VALMSG="Renew Rx request canceled",VALMBCK="R"
"RTN","PSORENW",21,0)
 I PSORENW("DFLG")!('$D(PSORENW("FILL DATE"))) S PSORENW("QFLG")=1,PSORENW("DFLG")=0
"RTN","PSORENW",22,0)
ASKX Q
"RTN","PSORENW",23,0)
 ;
"RTN","PSORENW",24,0)
EOJ ;
"RTN","PSORENW",25,0)
 K VERB,RTE,DRET,PSOMSG,PSORNW,PSOLIST,PSORENW,PSORX("BAR CODE"),PSORX("FILL DATE"),PSODIR,PSOID,PSONOOR,PSOCOU,PSOCOUU,PSOID,PSOFDMX,PSODRUG,COPY,PSOBCKDR
"RTN","PSORENW",26,0)
 N ZRXN
"RTN","PSORENW",27,0)
 S RXN=$O(^TMP("PSORXN",$J,0)) I RXN S ZRXN=RXN D
"RTN","PSORENW",28,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSORENW",29,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS",$P(RXN1,"^",4))
"RTN","PSORENW",30,0)
 .;saves drug allergy order chks pso*7*411
"RTN","PSORENW",31,0)
 .I $D(^TMP("PSODAOC",$J)) D  Q:$G(PSORX("DFLG"))
"RTN","PSORENW",32,0)
 ..I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSORENW",33,0)
 ..S RXN=ZRXN
"RTN","PSORENW",34,0)
 .S PSOARENW=1 D DAOC^PSONEW K PSOARENW
"RTN","PSORENW",35,0)
 I $G(PSORNEDT),'$O(^TMP("PSORXN",$J,0)),$D(^TMP("PSODAOC",$J)) S ZRXN=PSORNEDT,PSOARENW=1 D DAOC^PSONEW K PSOARENW,PSORNEDT
"RTN","PSORENW",36,0)
 K ZZCOPY,ZRXN,RXN,RXN1,^TMP("PSORXN",$J),^TMP("PSODAOC",$J)
"RTN","PSORENW",37,0)
 I $G(PSONOTE) D MAIN^TIUEDIT(3,.TIUDA,PSODFN,"","","","",1)
"RTN","PSORENW",38,0)
 K PSONOTE
"RTN","PSORENW",39,0)
 Q
"RTN","PSORENW",40,0)
OERR ;entry for renew backdoor
"RTN","PSORENW",41,0)
 N PSORNEDT,PSORXIEN,PSOCHECK
"RTN","PSORENW",42,0)
 S PSORXIEN=+$P($G(PSOLST(ORN)),"^",2)
"RTN","PSORENW",43,0)
 ; Checking whether the Provider still qualifies as prescriber for the renewed Rx
"RTN","PSORENW",44,0)
 S PSOCHECK=$$CHKRXPRV^PSOUTIL(PSORXIEN)
"RTN","PSORENW",45,0)
 I 'PSOCHECK S VALMSG=$P(PSOCHECK,"^",2),VALMBCK="R" W $C(7) Q
"RTN","PSORENW",46,0)
 I $$TITRX^PSOUTL(PSORXIEN)="t" D  Q
"RTN","PSORENW",47,0)
 . S VALMSG="Cannot Renew a 'Titration Rx'.",VALMBCK="R" W $C(7)
"RTN","PSORENW",48,0)
 I $$LMREJ^PSOREJU1(PSORXIEN,,.VALMSG,.VALMBCK) Q
"RTN","PSORENW",49,0)
 ; PSO*7*508 - check if the Rx is an eRx. If so, inform the user and ask to proceed.
"RTN","PSORENW",50,0)
 N ERXORN,ERXIEN,ERXPROC S ERXORN=$$GET1^DIQ(52,$P(PSOLST(ORN),U,2),39.3)
"RTN","PSORENW",51,0)
 S ERXIEN=$$CHKERX^PSOERXU1(ERXORN)
"RTN","PSORENW",52,0)
 I ERXIEN D FULL^VALM1 S ERXPROC=$$PROVPMT^PSOERXU1(ERXIEN) Q:'ERXPROC
"RTN","PSORENW",53,0)
 ; PSO*7*508 - end
"RTN","PSORENW",54,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSORENW",55,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSORENW",56,0)
 K PSOID,PSOFDMX,PSORX("FILL DATE"),PSORENW("FILL DATE"),PSORX("QS"),PSORENW("QS"),PSOBARCD,COPY
"RTN","PSORENW",57,0)
 D PSOL^PSSLOCK(PSORXIEN) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG D ULPAT Q
"RTN","PSORENW",58,0)
 S PSOBCKDR=1,PSOFROM="NEW",PSORENW("OIRXN")=PSORXIEN,PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"),PSORX("DFLG"))=0
"RTN","PSORENW",59,0)
 S PSONEW("DAYS SUPPLY")=$P(^PSRX(PSORENW("OIRXN"),0),"^",8),PSONEW("# OF REFILLS")=$P(^(0),"^",9)
"RTN","PSORENW",60,0)
 D FULL^VALM1,ASK D:PSORENW("QFLG") KLIB^PSORENW1 D:PSORENW("QFLG") ULPAT D:PSORENW("QFLG") PSOUL^PSSLOCK(PSORXIEN) G:PSORENW("QFLG") EOJ D ^PSORENW0
"RTN","PSORENW",61,0)
 D ULPAT,EOJ,KLIB^PSORENW1 K PSOOPT,PSONEW,PSORX("DFLG"),X,Y
"RTN","PSORENW",62,0)
 Q
"RTN","PSORENW",63,0)
ULPAT K PSOMSG D UL^PSSLOCK(PSODFN) S X=PSODFN_";DPT(" D ULK^ORX2 K X
"RTN","PSORENW",64,0)
 Q
"RTN","PSORENW",65,0)
RENEW(PLACER,PSOCPDRG) ;passes flag to CPRS for front door renews
"RTN","PSORENW",66,0)
 ;-1=couldn't find order, 0=unable to renew, 1=renewable
"RTN","PSORENW",67,0)
 ;Placer=Pharmacy number
"RTN","PSORENW",68,0)
 N PSOSURX,PSORFRM,PSOLC,PSODRG,PSODRUG0,RXN,ST,PSONEWOI,PSOOLDOI,PSOIFLAG,PSOINA,RX0,X1,X2
"RTN","PSORENW",69,0)
 I $G(PLACER)["S"!('$G(PLACER)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSORENW",70,0)
 S RXN=PLACER I '$D(^PSRX(RXN,0)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSORENW",71,0)
 S RX0=^PSRX(RXN,0),PSODRG=+$P(^PSRX(RXN,0),"^",6),ST=+^("STA"),PSODRUG0=^PSDRUG(PSODRG,0)
"RTN","PSORENW",72,0)
 S PSOIFLAG=0,PSOOLDOI=+$P($G(^PSRX(RXN,"OR1")),"^"),PSONEWOI=+$P($G(^PSDRUG(+$G(PSODRG),2)),"^") I PSONEWOI,PSONEWOI'=PSOOLDOI S PSOIFLAG=1
"RTN","PSORENW",73,0)
 S PSOINA=$P($G(^PS(50.7,PSONEWOI,0)),"^",4)
"RTN","PSORENW",74,0)
 I PSOINA,DT>PSOINA Q "0^This Orderable Item has been Inactivated."
"RTN","PSORENW",75,0)
 I ST=5 S PSOSURX=$O(^PS(52.5,"B",RXN,0)) I PSOSURX,$P($G(^PS(52.5,PSOSURX,0)),"^",7)="L" Q "0^Rx loading into a CMOP Transmission."
"RTN","PSORENW",76,0)
 S X1=DT,X2=-120 D C^%DTC I $P($G(^PSRX(RXN,2)),"^",6)<X Q "0^Prescription Expired more than 120 Days."
"RTN","PSORENW",77,0)
 S X1=DT,X2=-120 D C^%DTC I $P($G(^PSRX(RXN,3)),"^",5),$P($G(^(3)),"^",5)<X,$P(^("STA"),"^")=12 Q "0^Prescription Discontinued more than 120 Days."
"RTN","PSORENW",78,0)
 I $G(PSOCPDRG),$G(PSOCPDRG)'=$G(PSODRG) Q "0^Drug Mismatch, Non-Renewable."
"RTN","PSORENW",79,0)
 N PSOOCPRX,PSOOLPF,PSOOLPD,PSONOSIG S PSOOCPRX=RXN D CDOSE^PSORENW0 I PSOOLPF Q "0^Non-Renewable, invalid Dosage of "_$G(PSOOLPD)
"RTN","PSORENW",80,0)
 I PSONOSIG Q "0^Non-Renewable, missing Sig."
"RTN","PSORENW",81,0)
 I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" Q "0^Drug is No longer used by Outpatient Pharmacy."
"RTN","PSORENW",82,0)
 I $G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) Q "0^This Drug has been Inactivated."
"RTN","PSORENW",83,0)
 I ($P(PSODRUG0,"^",3)[1)!($P(PSODRUG0,"^",3)[2)!($P(PSODRUG0,"^",3)["W") Q "0^Non-Renewable "_$S($P(PSODRUG0,"^",3)["A":"Drug Narcotic.",1:"Drug.")
"RTN","PSORENW",84,0)
 I $D(^PS(53,+$P(RX0,"^",3),0)),'$P(^(0),"^",5) Q "0^Non-Renewable Prescription."
"RTN","PSORENW",85,0)
 S PSOLC=$P(RX0,"^"),PSOLC=$E(PSOLC,$L(PSOLC)) I $A(PSOLC)'<90 Q "0^Max number of renewals (26) has been reached."
"RTN","PSORENW",86,0)
 I ST,ST'=2,ST'=5,ST'=6,ST'=11,ST'=12,ST'=14 Q "0^Prescription is in a Non-Renewable Status."
"RTN","PSORENW",87,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",4) Q "0^Duplicate Rx Renewal Request."
"RTN","PSORENW",88,0)
 I $O(^PS(52.41,"AQ",RXN,0)) Q "0^Duplicate Rx Renewal Request."
"RTN","PSORENW",89,0)
 N TITMSG
"RTN","PSORENW",90,0)
 I $$TITRX^PSOUTL(RXN)="t" D  Q TITMSG
"RTN","PSORENW",91,0)
 . S TITMSG="0^Prescription was marked as 'Titration to Maintenance Dose' by Pharmacy and cannot be renewed."
"RTN","PSORENW",92,0)
 . S TITMSG=TITMSG_" To repeat the titration, enter a new prescription or copy the prior titration order."
"RTN","PSORENW",93,0)
 . S TITMSG=TITMSG_" To continue the maintenance dose, refill this prescription if refills are available"
"RTN","PSORENW",94,0)
 . S TITMSG=TITMSG_" or enter a new prescription for the maintenance dose."
"RTN","PSORENW",95,0)
 K PSORFRM,PSOLC,PSODRG,PSODRUG0,RXN,ST,TITMSG
"RTN","PSORENW",96,0)
 Q 1_$S($G(PSOIFLAG):"^"_$G(PSONEWOI),1:"")
"RTN","PSORENW",97,0)
 ;
"RTN","PSORENW",98,0)
INST1 ;Set Pharmacy Instructions array
"RTN","PSORENW",99,0)
 N PSOTZ
"RTN","PSORENW",100,0)
 I $O(^PSRX(RXN,"PI",0)) S PHI=$G(^PSRX(RXN,"PI",0)),PSOTZ=0 D
"RTN","PSORENW",101,0)
 .F  S PSOTZ=$O(^PSRX(RXN,"PI",PSOTZ)) Q:PSOTZ=""  S PHI(PSOTZ)=$G(^PSRX(RXN,"PI",PSOTZ,0))
"RTN","PSORENW",102,0)
 Q
"RTN","PSORENW",103,0)
INST2 ;Set Instructions and Comments
"RTN","PSORENW",104,0)
 I '$G(PSORENW("OIRXN")) Q
"RTN","PSORENW",105,0)
 I $G(PSOFDR) Q
"RTN","PSORENW",106,0)
 N PSOPHL,PSOPRL
"RTN","PSORENW",107,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PI",0)) K PHI S PHI=$G(^PSRX(PSORENW("OIRXN"),"PI",0)),PSOPHL="" D
"RTN","PSORENW",108,0)
 .F  S PSOPHL=$O(^PSRX(PSORENW("OIRXN"),"PI",PSOPHL)) Q:PSOPHL=""  S PHI(PSOPHL)=$G(^PSRX(PSORENW("OIRXN"),"PI",PSOPHL,0))
"RTN","PSORENW",109,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PRC",0)) K PRC S PRC=$G(^PSRX(PSORENW("OIRXN"),"PRC",0)),PSOPRL="" D
"RTN","PSORENW",110,0)
 .F  S PSOPRL=$O(^PSRX(PSORENW("OIRXN"),"PRC",PSOPRL)) Q:PSOPRL=""  S PRC(PSOPRL)=$G(^PSRX(PSORENW("OIRXN"),"PRC",PSOPRL,0))
"RTN","PSORENW",111,0)
 Q
"RTN","PSORENW4")
0^2^B76190857^B68530272
"RTN","PSORENW4",1,0)
PSORENW4 ;BIR/SAB - rx speed renew ;03/06/95
"RTN","PSORENW4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,37,64,46,75,71,100,130,117,152,148,264,225,301,390,313,411,444,504,508,550**;DEC 1997;Build 2
"RTN","PSORENW4",3,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSORENW4",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORENW4",5,0)
 ;External reference to $$L^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",6,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",7,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",8,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",9,0)
 ;External reference to LK^ORX2 supported by DBIA 867
"RTN","PSORENW4",10,0)
 ;External reference to ULK^ORX2 supported by DBIA 867
"RTN","PSORENW4",11,0)
SEL K PSODRUG ;PSO*7*301
"RTN","PSORENW4",12,0)
 N PSOSPRNW,PSOIBOLD S PSOSPRNW=1
"RTN","PSORENW4",13,0)
 I $P(PSOPAR,"^",4)=0 S VALMSG="Renewing is NOT Allowed. Check Site Parameters!",VALMBCK="" Q
"RTN","PSORENW4",14,0)
 N VALMCNT I '$G(PSOCNT) S VALMSG="This patient has no Prescriptions!",VALMBCK="" Q
"RTN","PSORENW4",15,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSORENW4",16,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSORENW4",17,0)
 K PRC,PHI,PSORX("EDIT"),PSOFDR,DIR,DUOUT,DIRUT,PSORNSPD S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DUOUT S VALMBCK="" G SELQ
"RTN","PSORENW4",18,0)
 K DIR,DIRUT,DTOUT,PSOOELSE,DTOUT I +Y S (SPEED,PSOOELSE,PSORNSPD)=1 D FULL^VALM1 S LST=Y D
"RTN","PSORENW4",19,0)
 .S (PSODIR("DFLG"),PSODIR("FIELD"))=0,PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"),PSORX("DFLG"))=0 D INIT Q:PSORENW("DFLG")
"RTN","PSORENW4",20,0)
 .F ORD=1:1:$L(LST,",") Q:$P(LST,",",ORD)']""  S ORN=$P(LST,",",ORD) D:+PSOLST(ORN)=52 PROCESS S (PSOQUIT,PSORENW("DFLG"),POERR,POERR("DFLG"),PSORX("DFLG"))=0
"RTN","PSORENW4",21,0)
 I '$G(PSOOELSE) S VALMBCK="" G SELQ
"RTN","PSORENW4",22,0)
 S VALMBCK="R"
"RTN","PSORENW4",23,0)
 D ^PSOBUILD,BLD^PSOORUT1 K DIR,DIRUT,DTOUT,DUOUT,LST,ORD,IEN,ORN,RPH,ST,REFL,REF,PSOACT,ORSV,PSORNW,PSORENW,PSONO,PSOCO,PSOCU,PSODIR,DSMSG,SPEED,PSORENW,PSOOELSE,PSOOPT,PSORX("FILL DATE"),PSORX("ISSUE DATE"),PSOID,PSOMSG,PSORX("DFLG"),PSOQTY
"RTN","PSORENW4",24,0)
SELQ K PSORNSPD,RTE,DRET,PRC,PHI,PSOSPRNW,X S X=PSODFN_";DPT(" D ULK^ORX2,UL^PSSLOCK(PSODFN),CLEAN^PSOVER1
"RTN","PSORENW4",25,0)
 Q
"RTN","PSORENW4",26,0)
 ;
"RTN","PSORENW4",27,0)
PROCESS ; Process one order at a time
"RTN","PSORENW4",28,0)
 N PSORXIEN,PSOCHECK,MAXNUMRF
"RTN","PSORENW4",29,0)
 S PSORXIEN=+$P($G(PSOLST(ORN)),"^",2)
"RTN","PSORENW4",30,0)
 I $$LMREJ^PSOREJU1(PSORXIEN) D  K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",31,0)
 . W $C(7),!!,"Rx# "_$$GET1^DIQ(52,PSORXIEN,.01)_" has OPEN/UNRESOLVED 3rd Party Payer Rejects!"
"RTN","PSORENW4",32,0)
 I $$TITRX^PSOUTL(PSORXIEN)="t" D  K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",33,0)
 . W $C(7),!!,"Rx# "_$$GET1^DIQ(52,PSORXIEN,.01)_" is marked as 'Titration Rx' and cannot be renewed."
"RTN","PSORENW4",34,0)
 ; Checking whether the Provider still qualifies as prescriber for the renewed Rx
"RTN","PSORENW4",35,0)
 S PROVIEN=$S($G(PSORENW("PROVIDER")):PSORENW("PROVIDER"),1:+$$GET1^DIQ(52,PSORXIEN,4,"I"))
"RTN","PSORENW4",36,0)
 S PSOCHECK=$$CHKRXPRV^PSOUTIL(PSORXIEN,PROVIEN)
"RTN","PSORENW4",37,0)
 I 'PSOCHECK D  K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",38,0)
 . W $C(7),!!,"Rx# "_$$GET1^DIQ(52,PSORXIEN,.01)_" - "_$P(PSOCHECK,"^",3)
"RTN","PSORENW4",39,0)
 ; Checking the Maximum Number of Refills Allowed
"RTN","PSORENW4",40,0)
 S MAXNUMRF=$$MAXNUMRF^PSOUTIL(+$$GET1^DIQ(52,PSORXIEN,6,"I"),+$G(PSORENW("DAYS SUPPLY")),+$G(PSORENW("PATIENT STATUS")),.CLOZPAT)
"RTN","PSORENW4",41,0)
 I PSORENW("# OF REFILLS")>MAXNUMRF D  K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",42,0)
 . W $C(7),!!,"Rx# "_$$GET1^DIQ(52,PSORXIEN,.01)_" - # of Refills requested exceeds maximum allowed ("_MAXNUMRF_") for this Rx"
"RTN","PSORENW4",43,0)
 ; PSO*7*508 - check if the Rx is an eRx. If so, inform the user and ask to proceed.
"RTN","PSORENW4",44,0)
 N ERXORN,ERXIEN,ERXPROC S ERXORN=$$GET1^DIQ(52,$P(PSOLST(ORN),U,2),39.3)
"RTN","PSORENW4",45,0)
 S ERXIEN=$$CHKERX^PSOERXU1(ERXORN)
"RTN","PSORENW4",46,0)
 I ERXIEN S ERXPROC=$$PROVPMT^PSOERXU1(ERXIEN) Q:'ERXPROC
"RTN","PSORENW4",47,0)
 ; PSO*7*508 - end
"RTN","PSORENW4",48,0)
 ; Checking if Rx is locked by Another person
"RTN","PSORENW4",49,0)
 D PSOL^PSSLOCK(PSORXIEN) I '$G(PSOMSG) W $C(7),!!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing Rx "_$P(^PSRX(PSORXIEN,0),"^")),! K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",50,0)
 K RET,DRET,PRC,PHI S PSORENW("OIRXN")=PSORXIEN,PSOFROM="NEW"
"RTN","PSORENW4",51,0)
 S PSORENW("RX0")=^PSRX(PSORENW("OIRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN")),SIGOK=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^",2)
"RTN","PSORENW4",52,0)
 I SIGOK F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),"SIG1",I)) Q:'I  S SIG(I)=^PSRX(PSORENW("OIRXN"),"SIG1",I,0)
"RTN","PSORENW4",53,0)
 S PSOIBOLD=$G(PSORENW("OIRXN")) D SETIB^PSORENW1
"RTN","PSORENW4",54,0)
 I '$G(PSORENW("PROVIDER")) D
"RTN","PSORENW4",55,0)
 .S PSORENW("PROVIDER")=$P(PSORENW("RX0"),"^",4)
"RTN","PSORENW4",56,0)
 .S:$P(PSORENW("RX3"),"^",3) PSORENW("COSIGNING PROVIDER")=$P(PSORENW("RX3"),"^",3)
"RTN","PSORENW4",57,0)
 S PSORX("PROVIDER NAME")=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSORENW4",58,0)
 I '$G(PSORENW("CLINIC")) S PSORENW("CLINIC")=$P(PSORENW("RX0"),"^",5)
"RTN","PSORENW4",59,0)
 S PSORENW("REMARKS")="RENEWED FROM RX # "_$P(PSORENW("RX0"),"^")
"RTN","PSORENW4",60,0)
 S PSORENW("SIG")=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^")
"RTN","PSORENW4",61,0)
 S PSORENW("PSODFN")=$P(PSORENW("RX0"),"^",2)
"RTN","PSORENW4",62,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSORENW4",63,0)
 S PSORENW("DRUG IEN")=$P(PSORENW("RX0"),"^",6)
"RTN","PSORENW4",64,0)
 S PSORENW("QTY")=$P(PSORENW("RX0"),"^",7)
"RTN","PSORENW4",65,0)
 S PSORENW("INS")=$S($G(PSORENW("ENT"))]"":PSORENW("ENT"),1:$G(^PSRX(PSORENW("OIRXN"),"INS")))
"RTN","PSORENW4",66,0)
 S:$G(PSORENW("ENT"))']"" PSORENW("ENT")=0
"RTN","PSORENW4",67,0)
 N I F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),6,I)) Q:'I  S DOSE=^PSRX(PSORENW("OIRXN"),6,I,0) D
"RTN","PSORENW4",68,0)
 .S PSORENW("ENT")=PSORENW("ENT")+1,PSORENW("DOSE",PSORENW("ENT"))=$P(DOSE,"^")
"RTN","PSORENW4",69,0)
 .S PSORENW("UNITS",PSORENW("ENT"))=$P(DOSE,"^",3),PSORENW("DOSE ORDERED",PSORENW("ENT"))=$P(DOSE,"^",2),PSORENW("ROUTE",PSORENW("ENT"))=$P(DOSE,"^",7)
"RTN","PSORENW4",70,0)
 .S PSORENW("SCHEDULE",PSORENW("ENT"))=$P(DOSE,"^",8),PSORENW("DURATION",PSORENW("ENT"))=$P(DOSE,"^",5),PSORENW("CONJUNCTION",PSORENW("ENT"))=$P(DOSE,"^",6)
"RTN","PSORENW4",71,0)
 .S PSORENW("NOUN",PSORENW("ENT"))=$P(DOSE,"^",4),PSORENW("VERB",PSORENW("ENT"))=$P(DOSE,"^",9)
"RTN","PSORENW4",72,0)
 .I $G(^PSRX(PSORENW("OIRXN"),6,I,1))]"" S PSORENW("ODOSE",PSORENW("ENT"))=^PSRX(PSORENW("OIRXN"),6,I,1)
"RTN","PSORENW4",73,0)
 .K DOSE
"RTN","PSORENW4",74,0)
 I $P($G(^PSDRUG(PSORENW("DRUG IEN"),"CLOZ1")),"^")="PSOCLO1" N PSON S PSON=0 D  I PSON K PSON D POZ,KLIB^PSORENW1 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSORENW4",75,0)
 . I '$L($P(^VA(200,PSORENW("PROVIDER"),"PS"),"^",2)),'$L($P(^VA(200,PSORENW("PROVIDER"),"PS"),"^",3)) D  Q
"RTN","PSORENW4",76,0)
 . . S PSON=1 W $C(7),!!,"Only providers with DEA# or a VA# can write prescriptions for clozapine.",!
"RTN","PSORENW4",77,0)
 . I '$D(^XUSEC("YSCL AUTHORIZED",PSORENW("PROVIDER"))) D 
"RTN","PSORENW4",78,0)
 . . S PSON=1 W $C(7),!!,"Provider must hold YSCL AUTHORIZED key to write prescriptions for clozapine.",!
"RTN","PSORENW4",79,0)
 I $G(PSORNW("MAIL/WINDOW"))]"" S PSORENW("MAIL/WINDOW")=PSORNW("MAIL/WINDOW")
"RTN","PSORENW4",80,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PI",0)) D  K T
"RTN","PSORENW4",81,0)
 .S PHI=^PSRX(PSORENW("OIRXN"),"PI",0),T=0
"RTN","PSORENW4",82,0)
 .F  S T=$O(^PSRX(PSORENW("OIRXN"),"PI",T)) Q:'T  S PHI(T)=^PSRX(PSORENW("OIRXN"),"PI",T,0)
"RTN","PSORENW4",83,0)
 W !!,"Now Renewing Rx # "_PSORENW("ORX #")_"   Drug: "_$P($G(^PSDRUG(+$G(PSORENW("DRUG IEN")),0)),"^"),!
"RTN","PSORENW4",84,0)
 I '$P($G(^PSDRUG($P(PSORENW("RX0"),"^",6),2)),"^") D  G:$G(PSORENW("DFLG")) PROCESSX
"RTN","PSORENW4",85,0)
 .I $P($G(^PSRX(PSORENW("OIRXN"),"OR1")),"^") S PSODRUG("OI")=$P(^PSRX(PSORENW("OIRXN"),"OR1"),"^"),PSODRUG("OIN")=$P(^PS(50.7,+^("OR1"),0),"^") Q
"RTN","PSORENW4",86,0)
 .W !!,"Cannot Renew!!  No Pharmacy Orderable Item!" S VALMSG="Cannot Renew!!  No Pharmacy Orderable Item!",PSORX("DFLG")=1
"RTN","PSORENW4",87,0)
 D POZ
"RTN","PSORENW4",88,0)
 D CHECK^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",89,0)
 D FILDATE^PSORENW0
"RTN","PSORENW4",90,0)
 D DRUG^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",91,0)
 D RXN^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",92,0)
 D STOP^PSORENW1
"RTN","PSORENW4",93,0)
DSPL K PSOEDT,PSOLM,BBFLG,BBRX,BINGCRT,BINGRTE S PSDY=PSORENW("DAYS SUPPLY"),PSRF=PSORENW("# OF REFILLS")
"RTN","PSORENW4",94,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S PSODIR("CS")=1
"RTN","PSORENW4",95,0)
 N MXRFLS
"RTN","PSORENW4",96,0)
 S MXRFLS=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),+$G(PSORENW("DAYS SUPPLY")),+$P(^PSRX(PSORENW("OIRXN"),0),"^",3),.CLOZPAT)
"RTN","PSORENW4",97,0)
 I MXRFLS<PSORENW("# OF REFILLS") S PSORENW("# OF REFILLS")=MXRFLS
"RTN","PSORENW4",98,0)
 D DSPLY^PSORENW3 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",99,0)
 D:$D(^XUSEC("PSORPH",DUZ))!('$P(PSOPAR,"^",2)) VER1^PSOORNE4(.PSORENW) G:PSORENW("DFLG")=1 PROCESSX
"RTN","PSORENW4",100,0)
 I $G(PSOQTY) D QTY^PSODIR1(.PSORENW) G:PSORENW("DFLG")=1 PROCESSX
"RTN","PSORENW4",101,0)
 D EN^PSORN52(.PSORENW)
"RTN","PSORENW4",102,0)
 D RNPSOSD^PSOUTIL
"RTN","PSORENW4",103,0)
 D CAN^PSORENW0,DCORD^PSONEW2
"RTN","PSORENW4",104,0)
 S PSORENW("# OF REFILLS")=PSRF K PSDY,PSRF,PSODIR("CS"),DEA,PSORENW("ENT")
"RTN","PSORENW4",105,0)
 S BBRN="",BBRN1=$O(^PSRX("B",PSORENW("NRX #"),BBRN)) I $P($G(^PSRX(BBRN1,0)),"^",11)["W" S BINGCRT="Y",BINGRTE="W",BBFLG=1,BBRX(1)=$G(BBRX(1))_BBRN1_","
"RTN","PSORENW4",106,0)
PROCESSX I PSORENW("DFLG") D
"RTN","PSORENW4",107,0)
 .K PHI,PRC,PSODRUG,SIG,PSORXED,SIGOK
"RTN","PSORENW4",108,0)
 .K PSORENW("DOSE"),PSORENW("DURATION"),PSORENW("DRUG IEN"),PSORENW("ENT"),PSORENW("INS"),PSORENW("NOUN"),PSORENW("ROUTE"),PSORENW("SCHEDULE"),PSORENW("SIG"),PSORENW("VERB"),PSORENW("UNITS")
"RTN","PSORENW4",109,0)
 .I '$G(POERR) W !,$C(7),"Rx NOT RENEWED. RENEWED RX DELETED",! S POERR("DFLG")=1 D CLEAN^PSOVER1,POZ
"RTN","PSORENW4",110,0)
 K PSORDLOK I PSORENW("DFLG") S PSORDLOK=1
"RTN","PSORENW4",111,0)
 D:$G(PSORENW("OLD FILL DATE"))]"" SUSDATEK^PSOUTIL(.PSORENW)
"RTN","PSORENW4",112,0)
 K BBRN,BBRN1,PSODRUG,PSORX("PROVIDER NAME"),PSORX("CLINIC")
"RTN","PSORENW4",113,0)
 K PSOEDT,PSOLM S:$G(PSORENW("FROM"))="" (PSORENW("DFLG"),PSORENW("QFLG"))=0
"RTN","PSORENW4",114,0)
 I $G(PSORDLOK) D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSORENW4",115,0)
 D KLIB^PSORENW1
"RTN","PSORENW4",116,0)
 K PSORDLOK
"RTN","PSORENW4",117,0)
 S RXN=$O(^TMP("PSORXN",$J,0)) I RXN N ZRXN S ZRXN=RXN D
"RTN","PSORENW4",118,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSORENW4",119,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS",$P(RXN1,"^",4))
"RTN","PSORENW4",120,0)
 .;saves drug allergy order chks pso*7*390
"RTN","PSORENW4",121,0)
 .I $D(^TMP("PSODAOC",$J,"ALLERGY")) D 
"RTN","PSORENW4",122,0)
 ..I $G(PSORX("DFLG"))!$G(PSORENW("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSORENW4",123,0)
 ..S RXN=ZRXN,PSODAOC="Rx Backdoor "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"SPEED RENEW Order Acceptance_OP"
"RTN","PSORENW4",124,0)
 ..S PSOARENW=1 D DAOC^PSONEW K PSOARENW
"RTN","PSORENW4",125,0)
 K ZRXN,RXN,RXN1,^TMP("PSORXN",$J),^TMP("PSODAOC",$J)
"RTN","PSORENW4",126,0)
 Q
"RTN","PSORENW4",127,0)
INIT ;
"RTN","PSORENW4",128,0)
 D ASK Q:PSORENW("DFLG")
"RTN","PSORENW4",129,0)
 D NOORE^PSONEW(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",130,0)
 Q
"RTN","PSORENW4",131,0)
ASK ;upfront questions
"RTN","PSORENW4",132,0)
 W !! D ISSDT^PSODIR2(.PSORENW) Q:PSORENW("DFLG")  S PSORENW("ISSUE DATE")=PSOID
"RTN","PSORENW4",133,0)
 D FILLDT^PSODIR2(.PSORENW) K PSONEW("DAYS SUPPLY"),PSONEW("# OF REFILLS") Q:PSORENW("DFLG")
"RTN","PSORENW4",134,0)
 S PSORNW("FILL DATE")=PSORENW("FILL DATE")
"RTN","PSORENW4",135,0)
 D MW^PSODIR2(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",136,0)
 D PTSTAT^PSODIR1(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",137,0)
 D DAYS^PSODIR1(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",138,0)
 S PSODRUG("DEA")=0 D REFILL^PSODIR1(.PSORENW) K PSODRUG("DEA") Q:PSORENW("DFLG")
"RTN","PSORENW4",139,0)
 K DIR,DIRUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Do you want to edit Renewed Rx(s) QTY " D ^DIR I $D(DIRUT) S PSORENW("DFLG")=1 K DIR,DIRUT Q
"RTN","PSORENW4",140,0)
 S PSOQTY=Y K DIR,DIRUT,Y
"RTN","PSORENW4",141,0)
 D CLINIC^PSODIR2(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",142,0)
 D PROV^PSODIR(.PSORENW) S:PSORENW("DFLG") PSORENW("DFLG")=0
"RTN","PSORENW4",143,0)
 Q
"RTN","PSORENW4",144,0)
 ;
"RTN","PSORENW4",145,0)
POZ ;
"RTN","PSORENW4",146,0)
 K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DTOUT
"RTN","PSORENW4",147,0)
 Q
"VER")
8.0^22.2
"BLD",9675,6)
^447
**END**
**END**

