EMERGENCY Released PSO*7*506 SEQ #417
Extracted from mail message
**KIDS**:PSO*7.0*506^

**INSTALL NAME**
PSO*7.0*506
"BLD",9590,0)
PSO*7.0*506^OUTPATIENT PHARMACY^0^3171211^y
"BLD",9590,1,0)
^^1^1^3171120^
"BLD",9590,1,1,0)
Emergency patch to resolve hard error during drug validation.
"BLD",9590,4,0)
^9.64PA^^
"BLD",9590,6.3)
4
"BLD",9590,"KRN",0)
^9.67PA^779.2^20
"BLD",9590,"KRN",.4,0)
.4
"BLD",9590,"KRN",.401,0)
.401
"BLD",9590,"KRN",.402,0)
.402
"BLD",9590,"KRN",.403,0)
.403
"BLD",9590,"KRN",.5,0)
.5
"BLD",9590,"KRN",.84,0)
.84
"BLD",9590,"KRN",3.6,0)
3.6
"BLD",9590,"KRN",3.8,0)
3.8
"BLD",9590,"KRN",9.2,0)
9.2
"BLD",9590,"KRN",9.8,0)
9.8
"BLD",9590,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",9590,"KRN",9.8,"NM",1,0)
PSOERXD2^^0^B205488607
"BLD",9590,"KRN",9.8,"NM",2,0)
PSOERX1B^^0^B201661947
"BLD",9590,"KRN",9.8,"NM","B","PSOERX1B",2)

"BLD",9590,"KRN",9.8,"NM","B","PSOERXD2",1)

"BLD",9590,"KRN",19,0)
19
"BLD",9590,"KRN",19.1,0)
19.1
"BLD",9590,"KRN",101,0)
101
"BLD",9590,"KRN",409.61,0)
409.61
"BLD",9590,"KRN",771,0)
771
"BLD",9590,"KRN",779.2,0)
779.2
"BLD",9590,"KRN",870,0)
870
"BLD",9590,"KRN",8989.51,0)
8989.51
"BLD",9590,"KRN",8989.52,0)
8989.52
"BLD",9590,"KRN",8994,0)
8994
"BLD",9590,"KRN","B",.4,.4)

"BLD",9590,"KRN","B",.401,.401)

"BLD",9590,"KRN","B",.402,.402)

"BLD",9590,"KRN","B",.403,.403)

"BLD",9590,"KRN","B",.5,.5)

"BLD",9590,"KRN","B",.84,.84)

"BLD",9590,"KRN","B",3.6,3.6)

"BLD",9590,"KRN","B",3.8,3.8)

"BLD",9590,"KRN","B",9.2,9.2)

"BLD",9590,"KRN","B",9.8,9.8)

"BLD",9590,"KRN","B",19,19)

"BLD",9590,"KRN","B",19.1,19.1)

"BLD",9590,"KRN","B",101,101)

"BLD",9590,"KRN","B",409.61,409.61)

"BLD",9590,"KRN","B",771,771)

"BLD",9590,"KRN","B",779.2,779.2)

"BLD",9590,"KRN","B",870,870)

"BLD",9590,"KRN","B",8989.51,8989.51)

"BLD",9590,"KRN","B",8989.52,8989.52)

"BLD",9590,"KRN","B",8994,8994)

"BLD",9590,"QUES",0)
^9.62^^
"BLD",9590,"REQB",0)
^9.611^1^1
"BLD",9590,"REQB",1,0)
PSO*7.0*467^2
"BLD",9590,"REQB","B","PSO*7.0*467",1)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
506^3171211
"PKG",141,22,1,"PAH",1,1,0)
^^1^1^3171211
"PKG",141,22,1,"PAH",1,1,1,0)
Emergency patch to resolve hard error during drug validation.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSOERX1B")
0^2^B201661947^B200406933
"RTN","PSOERX1B",1,0)
PSOERX1B ;ALB/BWF - Accept eRx function ; 8/3/2016 5:14pm
"RTN","PSOERX1B",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,506**;DEC 1997;Build 4
"RTN","PSOERX1B",3,0)
 ;
"RTN","PSOERX1B",4,0)
 Q
"RTN","PSOERX1B",5,0)
ACVAL(PSOIEN,TYPE) ;
"RTN","PSOERX1B",6,0)
 N F,VBFLD,VBDTTMF,DIR,TAG,VALPAR,VAL,CURVAL,MVFLD,VBFLD,VBDTTMF,PSOIENS,RXSTAT,QFLG,VDTTM,ERXMMFLG
"RTN","PSOERX1B",7,0)
 S F=52.49,PSOIENS=PSOIEN_","
"RTN","PSOERX1B",8,0)
 D FULL^VALM1
"RTN","PSOERX1B",9,0)
 S VALMBCK="R"
"RTN","PSOERX1B",10,0)
 ; first check to see if the entry exists. cannot validate something that has no value
"RTN","PSOERX1B",11,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERX1B",12,0)
 .W !!,"Cannot accept validation for a prescription with a status of 'Rejected',",!,"'Removed',or 'Processed",!
"RTN","PSOERX1B",13,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",14,0)
 Q:TYPE']""
"RTN","PSOERX1B",15,0)
 S TAG=$S(TYPE="P":"patient",TYPE="PR":"provider",TYPE="D":"drug",1:"")
"RTN","PSOERX1B",16,0)
 S VALPAR=$S(TYPE="P":.05,TYPE="PR":2.3,TYPE="D":3.2,1:"") Q:VALPAR=""
"RTN","PSOERX1B",17,0)
 S VAL=$$GET1^DIQ(F,PSOIEN,VALPAR,"I") I 'VAL D  Q
"RTN","PSOERX1B",18,0)
 .W !,"Vista "_TAG_" has not been matched. Cannot manually validate."
"RTN","PSOERX1B",19,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",20,0)
 S MVFLD=$S(TYPE="P":1.7,TYPE="PR":1.3,TYPE="D":1.5,1:"")
"RTN","PSOERX1B",21,0)
 S VBFLD=$S(TYPE="P":1.13,TYPE="PR":1.8,TYPE="D":1.11,1:"")
"RTN","PSOERX1B",22,0)
 S VBDTTMF=$S(TYPE="P":1.14,TYPE="PR":1.9,TYPE="D":1.12,1:"")
"RTN","PSOERX1B",23,0)
 ; check to see if this is already validated
"RTN","PSOERX1B",24,0)
 I MVFLD S CURVAL=$$GET1^DIQ(F,PSOIEN,MVFLD,"I")
"RTN","PSOERX1B",25,0)
 I CURVAL D  Q
"RTN","PSOERX1B",26,0)
 .W !!,"This "_TAG_" has already been manually validated."
"RTN","PSOERX1B",27,0)
 .W !,"Validated By: "_$$GET1^DIQ(F,PSOIEN,VBFLD,"E")
"RTN","PSOERX1B",28,0)
 .W !,"Validated Date/Time: "_$$GET1^DIQ(F,PSOIEN,VBDTTMF,"E"),!
"RTN","PSOERX1B",29,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",30,0)
 S QFLG=0
"RTN","PSOERX1B",31,0)
 I TYPE="D" D
"RTN","PSOERX1B",32,0)
 .W !
"RTN","PSOERX1B",33,0)
 .I '$O(^PS(52.49,PSOIEN,21,0)) W !,"Dosing information missing." S QFLG=1
"RTN","PSOERX1B",34,0)
 .I $$GET1^DIQ(52.49,PSOIEN,20.1,"E")="" W !,"Quantity missing." S QFLG=1
"RTN","PSOERX1B",35,0)
 .I $$GET1^DIQ(52.49,PSOIEN,20.2,"E")="" W !,"Days supply missing." S QFLG=1
"RTN","PSOERX1B",36,0)
 .;I $$GET1^DIQ(52.49,PSOIEN,20.5,"E")="" W !,"Refills missing."  S QFLG=1
"RTN","PSOERX1B",37,0)
 .I QFLG=1 D
"RTN","PSOERX1B",38,0)
 ..W !!,"Cannot validate drug information."
"RTN","PSOERX1B",39,0)
 ..S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX1B",40,0)
 Q:QFLG
"RTN","PSOERX1B",41,0)
 I TYPE="P" S ERXMMFLG=$$PATWARN^PSOERX1A(PSOIEN)
"RTN","PSOERX1B",42,0)
 I TYPE="PR" S ERXMMFLG=$$PRVWARN^PSOERX1A(PSOIEN)
"RTN","PSOERX1B",43,0)
 W !,"Would you like to mark this "_TAG_" as VALIDATED?"
"RTN","PSOERX1B",44,0)
 S DIR(0)="Y",DIR("B")=$S($G(ERXMMFLG):"NO",1:"YES") D ^DIR Q:Y'=1
"RTN","PSOERX1B",45,0)
 K FDA,DIR
"RTN","PSOERX1B",46,0)
 S VDTTM=$$NOW^XLFDT
"RTN","PSOERX1B",47,0)
 I MVFLD S FDA(F,PSOIENS,MVFLD)=1
"RTN","PSOERX1B",48,0)
 I VBFLD S FDA(F,PSOIENS,VBFLD)=$G(DUZ)
"RTN","PSOERX1B",49,0)
 I VBDTTMF S FDA(F,PSOIENS,VBDTTMF)=VDTTM
"RTN","PSOERX1B",50,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERX1B",51,0)
 I $D(FDA) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",52,0)
 W !,"Validation Updated!!" S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",53,0)
 I TYPE="P" D BPROC(PSOIEN,"PA",MVFLD,VBFLD,VBDTTMF,VDTTM) K @VALMAR D INIT^PSOERXP1
"RTN","PSOERX1B",54,0)
 I TYPE="PR" D BPROC(PSOIEN,"PR",MVFLD,VBFLD,VBDTTMF,VDTTM) K @VALMAR D INIT^PSOERXR1
"RTN","PSOERX1B",55,0)
 I TYPE="D" K @VALMAR D INIT^PSOERXD1
"RTN","PSOERX1B",56,0)
 Q
"RTN","PSOERX1B",57,0)
BPROC(PSOIEN,BTYPE,MVFLD,VBFLD,VBDTTMF,VDTTM) ;
"RTN","PSOERX1B",58,0)
 N ERXPAT,ERXSTAT,ERESTAT,ERXDT,ERXIEN,ERXARY,DIR,Y,L,LINE,CNT,EHID,EDRUG,EPROV,EPAT,ERXRDT,ERXRECDT,ERXEDT,I
"RTN","PSOERX1B",59,0)
 N REXEDT,EEPROV,ERXPROV,EXARY
"RTN","PSOERX1B",60,0)
 S ERXPAT=$$GET1^DIQ(52.49,PSOIEN,.04,"I") Q:'ERXPAT
"RTN","PSOERX1B",61,0)
 S ERXPROV=$$GET1^DIQ(52.49,PSOIEN,2.1,"I")
"RTN","PSOERX1B",62,0)
 S ERXRECDT=$P($$GET1^DIQ(52.49,PSOIEN,.03,"I"),".")
"RTN","PSOERX1B",63,0)
 S ERXEDT=ERXRECDT_".2359"
"RTN","PSOERX1B",64,0)
 S ERXSTAT=0 F  S ERXSTAT=$O(^PS(52.49,"PAT",PSNPINST,ERXSTAT)) Q:'ERXSTAT  D
"RTN","PSOERX1B",65,0)
 .S ERESTAT=$$GET1^DIQ(52.45,ERXSTAT,.01,"E")
"RTN","PSOERX1B",66,0)
 .; do not consider rx's that are rejected, removed, processed.
"RTN","PSOERX1B",67,0)
 .I ERESTAT="PR"!(ERESTAT="RM")!(ERESTAT="RJ") Q
"RTN","PSOERX1B",68,0)
 .S ERXDT=ERXRECDT-.0001 F  S ERXDT=$O(^PS(52.49,"PAT",PSNPINST,ERXSTAT,ERXPAT,ERXDT)) Q:ERXDT>ERXEDT!(ERXDT="")  D
"RTN","PSOERX1B",69,0)
 ..S ERXIEN=0 F  S ERXIEN=$O(^PS(52.49,"PAT",PSNPINST,ERXSTAT,ERXPAT,ERXDT,ERXIEN)) Q:'ERXIEN  D
"RTN","PSOERX1B",70,0)
 ...I BTYPE="PR",$$GET1^DIQ(52.49,ERXIEN,2.1,"I")'=ERXPROV Q
"RTN","PSOERX1B",71,0)
 ...S EXARY(ERXIEN)=""
"RTN","PSOERX1B",72,0)
 I '$O(EXARY(0)) Q
"RTN","PSOERX1B",73,0)
 W !!
"RTN","PSOERX1B",74,0)
 I BTYPE="PA" D
"RTN","PSOERX1B",75,0)
 .W !,"This patient has other prescriptions for: "_$$FMTE^XLFDT(ERXRECDT)
"RTN","PSOERX1B",76,0)
 .W !,"Patient: "_$$GET1^DIQ(52.46,ERXPAT,.01,"E")
"RTN","PSOERX1B",77,0)
 I BTYPE="PR" D
"RTN","PSOERX1B",78,0)
 .W !,"There are other prescriptions for this patient, written by this provider on"
"RTN","PSOERX1B",79,0)
 .W !,$$FMTE^XLFDT(ERXRECDT)
"RTN","PSOERX1B",80,0)
 .W !,"Provider: "_$$GET1^DIQ(52.48,ERXPROV,.01,"E")
"RTN","PSOERX1B",81,0)
 .W !,"Patient: "_$$GET1^DIQ(52.46,ERXPAT,.01,"E")
"RTN","PSOERX1B",82,0)
 W !!,?4,"DRUG",?30,"PROVIDER",?60,"REC DATE"
"RTN","PSOERX1B",83,0)
 S $P(LINE,"-",80)="" W !,LINE
"RTN","PSOERX1B",84,0)
 S L=0,CNT=0 F  S L=$O(EXARY(L)) Q:'L  D
"RTN","PSOERX1B",85,0)
 .S CNT=CNT+1
"RTN","PSOERX1B",86,0)
 .S EHID=$$GET1^DIQ(52.49,L,.01,"E")
"RTN","PSOERX1B",87,0)
 .S EDRUG=$$GET1^DIQ(52.49,L,3.1,"E")
"RTN","PSOERX1B",88,0)
 .S EEPROV=$$GET1^DIQ(52.49,L,2.1,"I")
"RTN","PSOERX1B",89,0)
 .S EPROV=$$GET1^DIQ(52.48,EEPROV,.01,"E")
"RTN","PSOERX1B",90,0)
 .S EPAT=$$GET1^DIQ(52.46,ERXPAT,.01,"E")
"RTN","PSOERX1B",91,0)
 .S ERXRDT=$P($$GET1^DIQ(52.49,L,.03,"E"),"@")
"RTN","PSOERX1B",92,0)
 .W !,CNT_".) "_$E(EDRUG,1,28),?30,$E(EPROV,1,28),?60,ERXRDT
"RTN","PSOERX1B",93,0)
 W !!,"Would you like apply the above validation to these prescriptions?"
"RTN","PSOERX1B",94,0)
 K Y S DIR(0)="YO"
"RTN","PSOERX1B",95,0)
 S DIR("B")="N" D ^DIR K DIR
"RTN","PSOERX1B",96,0)
 I Y="^"!(Y=0) Q
"RTN","PSOERX1B",97,0)
 S I=0 F  S I=$O(EXARY(I)) Q:'I  D
"RTN","PSOERX1B",98,0)
 .I BTYPE="PA" S FDA(52.49,I_",",.05)=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERX1B",99,0)
 .I BTYPE="PR" S FDA(52.49,I_",",2.3)=$$GET1^DIQ(52.49,PSOIEN,2.3,"I")
"RTN","PSOERX1B",100,0)
 .S FDA(52.49,I_",",MVFLD)=1,FDA(52.49,I_",",VBFLD)=$G(DUZ),FDA(52.49,I_",",VBDTTMF)=VDTTM
"RTN","PSOERX1B",101,0)
 .D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",102,0)
 .I $$GET1^DIQ(52.49,I,1,"E")="N" D UPDSTAT^PSOERXU1(I,"I")
"RTN","PSOERX1B",103,0)
 Q
"RTN","PSOERX1B",104,0)
 ;PSOHY("LOC")=IEN of hospital location file (#44) - NOT USED, 
"RTN","PSOERX1B",105,0)
 ;PSOHY("CHNUM")=EXTERNAL PLACER ORDER NUMBER (NEED TO FIND OUT HOW WE SHOULD SET THIS) (25)
"RTN","PSOERX1B",106,0)
 ;PSOHY("PICK")=MAIL/WINDOW (20.4) 
"RTN","PSOERX1B",107,0)
 ;PSOHY("ENTER")=ENTERED BY IEN (2.1)
"RTN","PSOERX1B",108,0)
 ;PSOHY("PROV")=PROVIDER IEN (2.3)
"RTN","PSOERX1B",109,0)
 ;PSOHY("SDT")=EFFECTIVE DATE (6.3)
"RTN","PSOERX1B",110,0)
 ;PSOHY("ITEM")=PHARMACY ORDERABLE ITEM (DERIVED FROM THE DRUG IEN) - NO MAPPING TO 52.49
"RTN","PSOERX1B",111,0)
 ;PSOHY("DRUG")=DRUG IEN (3.2)
"RTN","PSOERX1B",112,0)
 ;PSOHY("QTY")=QUANTITY (20.1)
"RTN","PSOERX1B",113,0)
 ;PSOHY("REF")=# OF REFILLS (20.5)
"RTN","PSOERX1B",114,0)
 ;PSOHY("PAT")=PATIENT IEN (.05)
"RTN","PSOERX1B",115,0)
 ;PSOHY("OCC")=ORDER TYPE (ALWAYS 'NW') - NO MAPPING TO 52.49
"RTN","PSOERX1B",116,0)
 ;PSOHY("EDT")=LOGIN DATE (TODAYS DATE) - NO MAPPING TO 52.49
"RTN","PSOERX1B",117,0)
 ;PSOHY("PRIOR")=PRIORITY (SET OF CODES, 52.41,25 - STAT, EMERGENCY, ROUTINE)
"RTN","PSOERX1B",118,0)
 ;PSOHY("EXAPP")=EXTERNAL APPLICATION (FREE TEXT), LIKELY "PSO" - NO MAPPING TO 52.49
"RTN","PSOERX1B",119,0)
 ;PSOHY("PRCOM",#)=PROVIDER COMMENTS (8- NOTES)
"RTN","PSOERX1B",120,0)
 ;PSOHY("SIG",#)=SIG (52.4911 (STRUCTURED SIG), FIELD 1 (SIG FREE TEXT)
"RTN","PSOERX1B",121,0)
 ;PSOHY("QTSUB",CNT)=QUANTITY TIMING SUBFILE DATA. MERGED IN, FULL SUBFILE DATA
"RTN","PSOERX1B",122,0)
 ; QUANTITY/TIMING MAPS DIRECTLY TO QUANTITY TIMING IN 52.41
"RTN","PSOERX1B",123,0)
SETUP ;
"RTN","PSOERX1B",124,0)
 N PSOIENS,PSODAT,F,PATIEN,PROVIEN,OC,VQTY,EFFDT,VADRUG,VAOI,VAREF,VAROUT,VAPRIOR,PSOHY,LOC,ERXNUM,PRVARY,PRVCOMM
"RTN","PSOERX1B",125,0)
 N PLOOP,PCNT,QTLOOP,QTCNT,PSOEXMS,DIR,ORDERTYP,PSOEXCNT,SCNT,SIGDAT,SLOOP,POORD,PMVAL,PRMVAL,DMVAL,PATINST,RXSTAT
"RTN","PSOERX1B",126,0)
 N VADAYS,UNEXPI,PINARY,WRITDT,SLOOP2
"RTN","PSOERX1B",127,0)
 S F=52.49
"RTN","PSOERX1B",128,0)
 Q:'$G(PSOIEN)
"RTN","PSOERX1B",129,0)
 D FULL^VALM1
"RTN","PSOERX1B",130,0)
 S VALMBCK="R"
"RTN","PSOERX1B",131,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERX1B",132,0)
 .W !!,"Cannot accept a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERX1B",133,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",134,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1B",135,0)
 D GETS^DIQ(F,PSOIENS,".01;.05;.07;1;1.3;1.5;1.7;2.1;2.3;3.2;5.9;6.2;6.3;8;20.1;20.2;20.4;20.5;20.6;25;25.2;27;30","IE","PSODAT")
"RTN","PSOERX1B",136,0)
 S PSOEXCNT=0
"RTN","PSOERX1B",137,0)
 S ERXSTA=$G(PSODAT(F,PSOIENS,1,"E")) I ERXSTA="E"!($E(ERXSTA)="H") S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="eRx is in a 'Hold' status." D MSGDIR^PSOERXU1(.PSOEXMS) Q
"RTN","PSOERX1B",138,0)
 S PMVAL=$G(PSODAT(F,PSOIENS,1.7,"I")) I 'PMVAL S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Patient has not been manually validated."
"RTN","PSOERX1B",139,0)
 S PRMVAL=$G(PSODAT(F,PSOIENS,1.3,"I")) I 'PRMVAL S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Provider has not been manually validated."
"RTN","PSOERX1B",140,0)
 S DMVAL=$G(PSODAT(F,PSOIENS,1.5,"I")) I 'DMVAL S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Drug has not been manually validated."
"RTN","PSOERX1B",141,0)
 ; for now, if validations have not occured, do not check the other fields.
"RTN","PSOERX1B",142,0)
 I $O(PSOEXMS(0)) D MSGDIR^PSOERXU1(.PSOEXMS) Q
"RTN","PSOERX1B",143,0)
 S POORD=$G(PSODAT(F,PSOIENS,25.2,"I")) I POORD S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Pending outpatient order already exists."
"RTN","PSOERX1B",144,0)
 S PATIEN=$G(PSODAT(F,PSOIENS,.05,"I")) I 'PATIEN S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="No matched vista patient."
"RTN","PSOERX1B",145,0)
 S PROVIEN=$G(PSODAT(F,PSOIENS,2.3,"I")) I 'PROVIEN S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Provider not matched to a vista provider."
"RTN","PSOERX1B",146,0)
 S VADRUG=$G(PSODAT(F,PSOIENS,3.2,"I")) I 'VADRUG S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Drug not matched to a vista drug."
"RTN","PSOERX1B",147,0)
 S LOC=$G(PSODAT(F,PSOIENS,20.6,"I"))
"RTN","PSOERX1B",148,0)
 S ERXNUM=$G(PSODAT(F,PSOIENS,.01,"E")) I 'ERXNUM S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="eRx number missing."
"RTN","PSOERX1B",149,0)
 S VQTY=$G(PSODAT(F,PSOIENS,20.1,"E")) I 'VQTY S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Quantity missing."
"RTN","PSOERX1B",150,0)
 S EFFDT=$G(PSODAT(F,PSOIENS,6.3,"I")),WRITDT=$G(PSODAT(F,PSOIENS,5.9,"I"))
"RTN","PSOERX1B",151,0)
 ; if the effective date is passed in and there is no time, add .000001 to the date
"RTN","PSOERX1B",152,0)
 I EFFDT]"" S EFFDT=$P(EFFDT,".")
"RTN","PSOERX1B",153,0)
 I '$L(EFFDT) S EFFDT=WRITDT
"RTN","PSOERX1B",154,0)
 S VADAYS=$G(PSODAT(F,PSOIENS,20.2,"E"))
"RTN","PSOERX1B",155,0)
 S VAOI=$$GET1^DIQ(50,VADRUG,2.1,"I") I 'VAOI S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Orderable item not associated with drug."
"RTN","PSOERX1B",156,0)
 S VAREF=$G(PSODAT(F,PSOIENS,20.5,"E"))
"RTN","PSOERX1B",157,0)
 S VAROUT=$G(PSODAT(F,PSOIENS,20.4,"I")) I '$L(VAROUT) S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Pickup routing missing."
"RTN","PSOERX1B",158,0)
 S PATINST=$G(PSODAT(F,PSOIENS,27,"E"))
"RTN","PSOERX1B",159,0)
 D TXT2ARY^PSOERXD1(.PINARY,$$LSIG^PSOQUTIL(PATINST))
"RTN","PSOERX1B",160,0)
 ; get provider comments from VA PROVIDER COMMENTS field
"RTN","PSOERX1B",161,0)
 S PRVCOMM=$G(PSODAT(F,PSOIENS,30,"E"))
"RTN","PSOERX1B",162,0)
 D TXT2ARY^PSOERXD1(.PRVARY,$$LSIG^PSOQUTIL(PRVCOMM))
"RTN","PSOERX1B",163,0)
 S (PLOOP,PCNT)=0 F  S PLOOP=$O(PRVARY(PLOOP)) Q:'PLOOP  D
"RTN","PSOERX1B",164,0)
 .S PCNT=PCNT+1,PSOHY("PRCOM",PCNT)=$G(PRVARY(PLOOP))
"RTN","PSOERX1B",165,0)
 I '$O(^PS(52.49,PSOIEN,21,0)) S PSOEXCNT=PSOEXCNT+1,PSOEXMS(PSOEXCNT)="Dosing information missing."
"RTN","PSOERX1B",166,0)
 S (QTLOOP,QTCNT)=0 F  S QTLOOP=$O(^PS(52.49,PSOIEN,21,QTLOOP)) Q:'QTLOOP  D
"RTN","PSOERX1B",167,0)
 .S QTCNT=QTCNT+1 M PSOHY("QTSUB",QTCNT)=^PS(52.49,PSOIEN,21,QTLOOP)
"RTN","PSOERX1B",168,0)
 ; always 'routine' for now
"RTN","PSOERX1B",169,0)
 S VAPRIOR="R"
"RTN","PSOERX1B",170,0)
 ; always 'new' for this version
"RTN","PSOERX1B",171,0)
 S ORDERTYP="NW"
"RTN","PSOERX1B",172,0)
 S PSOHY("LOC")=LOC,PSOHY("CHNUM")=$G(ERXNUM)
"RTN","PSOERX1B",173,0)
 S PSOHY("PICK")=VAROUT,PSOHY("ENTER")=PROVIEN
"RTN","PSOERX1B",174,0)
 S PSOHY("PROV")=PROVIEN,PSOHY("SDT")=EFFDT
"RTN","PSOERX1B",175,0)
 S PSOHY("ITEM")=VAOI,PSOHY("DRUG")=VADRUG
"RTN","PSOERX1B",176,0)
 S PSOHY("QTY")=VQTY,PSOHY("REF")=VAREF
"RTN","PSOERX1B",177,0)
 S (PSOHY("PAT"),DFN)=PATIEN,PSOHY("OCC")=ORDERTYP
"RTN","PSOERX1B",178,0)
 ; login date will always be the written date. if there is no written date by chance, use the received date
"RTN","PSOERX1B",179,0)
 ;S PSOHY("EDT")=$S(WRITDT'="":$P(WRITDT,"."),1:$P($$GET1^DIQ(52.49,PSOIEN,.03,"I"),"."))
"RTN","PSOERX1B",180,0)
 S PSOHY("EDT")=DT,PSOHY("PRIOR")=VAPRIOR
"RTN","PSOERX1B",181,0)
 ; ALWAYS PSO as the external application
"RTN","PSOERX1B",182,0)
 S PSOHY("EXAPP")="PHARMACY"
"RTN","PSOERX1B",183,0)
 S PSOHY("DAYS")=VADAYS
"RTN","PSOERX1B",184,0)
 ; sig from eRx
"RTN","PSOERX1B",185,0)
 S (SLOOP,SCNT)=0 F  S SLOOP=$O(^PS(52.49,PSOIEN,"SIG",SLOOP)) Q:'SLOOP  D
"RTN","PSOERX1B",186,0)
 .S SIGDAT=$G(^PS(52.49,PSOIEN,"SIG",SLOOP,0))
"RTN","PSOERX1B",187,0)
 .S SCNT=SCNT+1,PSOHY("SIG",SCNT)=SIGDAT
"RTN","PSOERX1B",188,0)
 S SLOOP2=0 F  S SLOOP2=$O(PINARY(SLOOP2)) Q:'SLOOP2  D
"RTN","PSOERX1B",189,0)
 .S SCNT=SCNT+1,PSOHY("SIG",SCNT)=$G(PINARY(SLOOP2))
"RTN","PSOERX1B",190,0)
 ; if provider, patient or drug is missing, no need to continue.
"RTN","PSOERX1B",191,0)
 ; future consideration - do we need to check more fields?
"RTN","PSOERX1B",192,0)
 I $D(PSOEXMS) D MSGDIR^PSOERXU1(.PSOEXMS) Q
"RTN","PSOERX1B",193,0)
 D ADD
"RTN","PSOERX1B",194,0)
 I $G(PSOEXMS)]"" W !,PSOEXMS S DIR(0)="E" D ^DIE
"RTN","PSOERX1B",195,0)
 K DFN
"RTN","PSOERX1B",196,0)
 Q
"RTN","PSOERX1B",197,0)
ADD ;Add CHCS message to Outpatient Pending Orders file
"RTN","PSOERX1B",198,0)
 N PSOHQ,PSOHQT,PSOCPEND,PSOHINI,PSOHINLO,ERXSTA,ORDNUM,ILOOP,IARY
"RTN","PSOERX1B",199,0)
 S (PSOHINI,PSOHINLO)=0 D
"RTN","PSOERX1B",200,0)
 .I $G(PSOHY("LOC")) S PSOHINLO=$P($G(^SC(PSOHY("LOC"),0)),"^",4) I PSOHINLO Q
"RTN","PSOERX1B",201,0)
 .; FUTURE - consider enabling further institution checks. For now the institution is being pulled from either
"RTN","PSOERX1B",202,0)
 .; the institution associated with the hospital location, or below, from the eRx.
"RTN","PSOERX1B",203,0)
 .;I $G(PSOHY("LOC")) S PSOHINI=$P($G(^SC(PSOHY("LOC"),0)),"^",15)
"RTN","PSOERX1B",204,0)
 .;I '$G(PSOHINI) S PSOHINI=$O(^DG(40.8,0))
"RTN","PSOERX1B",205,0)
 .;S PSOHINLO=+$$SITE^VASITE(PSOHINI)
"RTN","PSOERX1B",206,0)
 ; get institution from 52.49 if clinic was not passed in
"RTN","PSOERX1B",207,0)
 I $G(PSOHINLO)<1 S PSOHINLO=$$GET1^DIQ(52.49,PSOIEN,24.1,"I")
"RTN","PSOERX1B",208,0)
 I +$G(PSOHINLO)<1 S PSOEXMS="Unable to derive Institution from Clinic." Q
"RTN","PSOERX1B",209,0)
 K DD,DO,DIC S X=PSOHY("CHNUM"),DIC="^PS(52.41,",DIC(0)="L"
"RTN","PSOERX1B",210,0)
 S:$G(PSOHY("PICK"))="" PSOHY("PICK")="M"
"RTN","PSOERX1B",211,0)
 S DIC("DR")="4////"_$G(PSOHY("ENTER"))_";5////"_PSOHY("PROV")_";6////"_$G(PSOHY("SDT"))_";8////"_PSOHY("ITEM")_";11////"_PSOHY("DRUG")_";12////"_$G(PSOHY("QTY"))_";13////"_$G(PSOHY("REF"))_";101////"_$G(PSOHY("DAYS"))
"RTN","PSOERX1B",212,0)
 D FILE^DICN K DD,DIC,DO I Y<0 S PSOEXMS="Unable to add order to Pending file." Q
"RTN","PSOERX1B",213,0)
 S PSOCPEND=+Y
"RTN","PSOERX1B",214,0)
 S $P(^PS(52.41,PSOCPEND,0),"^",2)=PSOHY("PAT"),$P(^(0),"^",3)=PSOHY("OCC"),$P(^(0),"^",12)=$G(PSOHY("EDT")),$P(^(0),"^",13)=$G(PSOHY("LOC"))
"RTN","PSOERX1B",215,0)
 S $P(^PS(52.41,PSOCPEND,0),"^",14)=$G(PSOHY("PRIOR")),$P(^(0),"^",17)=$G(PSOHY("PICK"))
"RTN","PSOERX1B",216,0)
 S $P(^PS(52.41,PSOCPEND,"EXT"),"^")=PSOHY("CHNUM"),$P(^("EXT"),"^",2)=0,$P(^("EXT"),"^",3)=PSOHY("EXAPP")
"RTN","PSOERX1B",217,0)
 S DIE="^PS(52.41,",DA=PSOCPEND,DR="104.1///1" D ^DIE K DIE,DA,DR
"RTN","PSOERX1B",218,0)
 ; PSO*7*506
"RTN","PSOERX1B",219,0)
 S FDA(52.41,PSOCPEND_",",104)=PATINST D FILE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",220,0)
 N DA,DIK S DA=PSOCPEND,DIK="^PS(52.41,",DIK(1)="114^C" D EN1^DIK
"RTN","PSOERX1B",221,0)
 I $O(PSOHY("PRCOM",0)) D  I PSOHQT S ^PS(52.41,PSOCPEND,3,0)="^^"_PSOHQT_"^"_PSOHQT_"^"_DT_"^"
"RTN","PSOERX1B",222,0)
 .S PSOHQ="",PSOHQT=0 F  S PSOHQ=$O(PSOHY("PRCOM",PSOHQ)) Q:PSOHQ=""  I $G(PSOHY("PRCOM",PSOHQ))'="" S PSOHQT=PSOHQT+1,^PS(52.41,PSOCPEND,3,PSOHQT,0)=$G(PSOHY("PRCOM",PSOHQ))
"RTN","PSOERX1B",223,0)
 I $O(PSOHY("SIG",0)) D  I PSOHQT S ^PS(52.41,PSOCPEND,"SIG",0)="^52.4124A^"_PSOHQT_"^"_PSOHQT
"RTN","PSOERX1B",224,0)
 .S PSOHQ="",PSOHQT=0 F  S PSOHQ=$O(PSOHY("SIG",PSOHQ)) Q:PSOHQ=""  I $G(PSOHY("SIG",PSOHQ))'="" S PSOHQT=PSOHQT+1,^PS(52.41,PSOCPEND,"SIG",PSOHQT,0)=$G(PSOHY("SIG",PSOHQ))
"RTN","PSOERX1B",225,0)
 S $P(^PS(52.41,PSOCPEND,"INI"),"^")=$G(PSOHINLO)
"RTN","PSOERX1B",226,0)
 ; add quantity/timing subfile information
"RTN","PSOERX1B",227,0)
 I $O(PSOHY("QTSUB",0)) D  I PSOHQT S ^PS(52.41,PSOCPEND,1,0)="^52.413^"_PSOHQT_"^"_PSOHQT
"RTN","PSOERX1B",228,0)
 .S PSOHQ="",PSOHQT=0 F  S PSOHQ=$O(PSOHY("QTSUB",PSOHQ)) Q:PSOHQ=""  D
"RTN","PSOERX1B",229,0)
 ..I $O(PSOHY("QTSUB",PSOHQ,0)) S PSOHQT=PSOHQT+1
"RTN","PSOERX1B",230,0)
 ..S ^PS(52.41,PSOCPEND,1,PSOHQT,0)=PSOHY("QTSUB",PSOHQ,0)
"RTN","PSOERX1B",231,0)
 ..S ^PS(52.41,PSOCPEND,1,PSOHQT,1)=PSOHY("QTSUB",PSOHQ,1)
"RTN","PSOERX1B",232,0)
 ..S ^PS(52.41,PSOCPEND,1,PSOHQT,2)=PSOHY("QTSUB",PSOHQ,2)
"RTN","PSOERX1B",233,0)
 I $O(PINARY(0)) D WP^DIE(52.41,PSOCPEND_",",105,"K","PINARY")
"RTN","PSOERX1B",234,0)
 ;Cross references not set yet preventing Pharmacy from finishing order
"RTN","PSOERX1B",235,0)
 D EN^PSOHLSNC(PSOCPEND,"SN","IP")
"RTN","PSOERX1B",236,0)
 D FULL^VALM1
"RTN","PSOERX1B",237,0)
 ;Just set to DC, don't delete because 52.41 entry would be re-used
"RTN","PSOERX1B",238,0)
 ;I '$P($G(^PS(52.41,PSOCPEND,"EXT")),"^",2) S DA=PSOCPEND,DIK="^PS(52.41," D ^DIK K DIK,DA S PSOEXMS="Unable to send CHCS order to CPRS." D NAK^PSOHLEXC Q
"RTN","PSOERX1B",239,0)
 I '$P($G(^PS(52.41,PSOCPEND,"EXT")),"^",2) D  S $P(^PS(52.41,PSOCPEND,0),"^",3)="DC" S PSOEXMS="Unable to send CHCS order to CPRS." Q
"RTN","PSOERX1B",240,0)
 .;x-ref shouldn't be set, but we'll kill them just in case
"RTN","PSOERX1B",241,0)
 .K ^PS(52.41,"AOR",$P(^PS(52.41,PSOCPEND,0),"^",2),+$P($G(^("INI")),"^"),PSOCPEND),^PS(52.41,"AD",$P(^PS(52.41,PSOCPEND,0),"^",12),+$P($G(^("INI")),"^"),PSOCPEND)
"RTN","PSOERX1B",242,0)
 .K ^PS(52.41,"ACL",+$P(^PS(52.41,PSOCPEND,0),"^",13),$P(^(0),"^",12),PSOCPEND),^PS(52.41,"AQ",+$P($G(^PS(52.41,PSOCPEND,0)),"^",21),PSOCPEND)
"RTN","PSOERX1B",243,0)
 .S $P(^PS(52.41,PSOCPEND,4),"^")="External order, unable to successfully transmit to CPRS."
"RTN","PSOERX1B",244,0)
 .W !!,"External order, unable to successfully transmit to CPRS."
"RTN","PSOERX1B",245,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",246,0)
 ;Successful transmission to CPRS
"RTN","PSOERX1B",247,0)
 S DA=PSOCPEND,DIK="^PS(52.41," D IX^DIK
"RTN","PSOERX1B",248,0)
 ; add the pending outpatient order number to 52.49 and update status of eRx to PR (Processed)
"RTN","PSOERX1B",249,0)
 S ERXSTA=$O(^PS(52.45,"C","ERX","PR",0))
"RTN","PSOERX1B",250,0)
 S ORDNUM=$P($G(^PS(52.41,PSOCPEND,0)),U)
"RTN","PSOERX1B",251,0)
 S DIE="^PS(52.49,",DR="25.2///"_PSOCPEND_";.12///"_ORDNUM,DA=PSOIEN D ^DIE K DIE,DA,DR
"RTN","PSOERX1B",252,0)
 ; add activity to status history
"RTN","PSOERX1B",253,0)
 D UPDSTAT^PSOERXU1(PSOIEN,"PR")
"RTN","PSOERX1B",254,0)
 ; gather the unexpanded sig and file in 52.41
"RTN","PSOERX1B",255,0)
 S ILOOP=0 F  S ILOOP=$O(^PS(52.49,PSOIEN,31,ILOOP)) Q:'ILOOP  D
"RTN","PSOERX1B",256,0)
 .S IARY(ILOOP)=$G(^PS(52.49,PSOIEN,31,ILOOP,0))
"RTN","PSOERX1B",257,0)
 I $D(IARY) D WP^DIE(52.41,PSOCPEND_",",9,"K","IARY","IERR")
"RTN","PSOERX1B",258,0)
 W !!,"eRx #"_PSOHY("CHNUM")_" sent to PENDING OUTPATIENT ORDERS!"
"RTN","PSOERX1B",259,0)
 S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX1B",260,0)
 Q
"RTN","PSOERX1B",261,0)
 ; remove eRx from holding queue
"RTN","PSOERX1B",262,0)
REM ;
"RTN","PSOERX1B",263,0)
 N DIR,Y,PSSRET,PSOIENS,REMIEN,REMSTA,REMTXT,ERXRMIEN,DIC,X,RXSTAT
"RTN","PSOERX1B",264,0)
 D FULL^VALM1
"RTN","PSOERX1B",265,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1B",266,0)
 S VALMBCK="R"
"RTN","PSOERX1B",267,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERX1B",268,0)
 .W !!,"Cannot remove a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERX1B",269,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",270,0)
 S DIR(0)="YO",DIR("A")="Would you like to 'Remove' eRx #"_$$GET1^DIQ(52.49,PSOIEN,.01,"E"),DIR("B")="Y" D ^DIR K DIR
"RTN","PSOERX1B",271,0)
 Q:'Y
"RTN","PSOERX1B",272,0)
 S DIC="^PS(52.45,",DIC(0)="AEMQ",DIC("S")="I $D(^PS(52.45,""TYPE"",""REM"",Y))",DIC("A")="Select REMOVAL reason code: "
"RTN","PSOERX1B",273,0)
 D ^DIC K DIC
"RTN","PSOERX1B",274,0)
 I $P(Y,U)<1 W !,"Removal reason code required!" S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX1B",275,0)
 S REMIEN=$P(Y,U),REMSTA=$P(Y,U,2)
"RTN","PSOERX1B",276,0)
 K X,Y S DIR(0)="FO^1:70",DIR("A")="Additional Comments (Optional)" D ^DIR K DIR
"RTN","PSOERX1B",277,0)
 Q:Y="^"
"RTN","PSOERX1B",278,0)
 S REMTXT=Y
"RTN","PSOERX1B",279,0)
 S FDA(52.4919,"+1,"_PSOIENS,.01)=$$NOW^XLFDT,FDA(52.4919,"+1,"_PSOIENS,.02)=REMIEN
"RTN","PSOERX1B",280,0)
 S FDA(52.4919,"+1,"_PSOIENS,.03)=DUZ,FDA(52.4919,"+1,"_PSOIENS,1)=REMTXT
"RTN","PSOERX1B",281,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",282,0)
 ; SET THE ERX STATUS TO THE REMOVAL REASON
"RTN","PSOERX1B",283,0)
 S ERXRMIEN=$O(^PS(52.45,"C","ERX","RM",0))
"RTN","PSOERX1B",284,0)
 S DIE="^PS(52.49,",DR="1///"_ERXRMIEN,DA=PSOIEN D ^DIE
"RTN","PSOERX1B",285,0)
 K DIE,DA,DR
"RTN","PSOERX1B",286,0)
 Q
"RTN","PSOERX1B",287,0)
 ; reject eRx
"RTN","PSOERX1B",288,0)
REJ ;
"RTN","PSOERX1B",289,0)
 N DIR,DIC,Y,PSSRET,PSOIENS,REMTXT,REJSTA,FULLTXT,ERXRJIEN,REJDESC,REJIEN,REJTXT,X,RXSTAT
"RTN","PSOERX1B",290,0)
 D FULL^VALM1
"RTN","PSOERX1B",291,0)
 S PSOIENS=PSOIEN_","
"RTN","PSOERX1B",292,0)
 S VALMBCK="R"
"RTN","PSOERX1B",293,0)
 S RXSTAT=$$GET1^DIQ(52.49,PSOIEN,1,"E") I RXSTAT="RJ"!(RXSTAT="RM")!(RXSTAT="PR") D  Q
"RTN","PSOERX1B",294,0)
 .W !!,"Cannot reject a prescription with a status of 'Rejected', 'Removed',",!,"or 'Processed",!
"RTN","PSOERX1B",295,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERX1B",296,0)
 S DIR(0)="YO",DIR("A")="Would you like to 'Reject' eRx #"_$$GET1^DIQ(52.49,PSOIEN,.01,"E"),DIR("B")="Y" D ^DIR K DIR
"RTN","PSOERX1B",297,0)
 Q:'Y
"RTN","PSOERX1B",298,0)
 S DIC="^PS(52.45,",DIC(0)="AEMQ",DIC("S")="I $D(^PS(52.45,""TYPE"",""REJ"",Y))",DIC("A")="Select REJECT reason code: "
"RTN","PSOERX1B",299,0)
 D ^DIC K DIC
"RTN","PSOERX1B",300,0)
 I $P(Y,U)<1 W !,"Reject reason required! eRx NOT rejected." S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX1B",301,0)
 S REJIEN=$P(Y,U),REJSTA=$P(Y,U,2)
"RTN","PSOERX1B",302,0)
 K X,Y,DIR
"RTN","PSOERX1B",303,0)
 S DIR(0)="FO^1:70",DIR("A")="Additional Comments (Optional)" D ^DIR K DIR
"RTN","PSOERX1B",304,0)
 Q:Y="^"
"RTN","PSOERX1B",305,0)
 ;I '$L(Y)!(Y="^") W !,"Reject reason text required. eRx NOT rejected." S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX1B",306,0)
 ; if reject reason was entered, log the activity.
"RTN","PSOERX1B",307,0)
 S REJTXT=Y
"RTN","PSOERX1B",308,0)
 S REJDESC=$$GET1^DIQ(52.45,REJIEN,.02,"E")
"RTN","PSOERX1B",309,0)
 S FULLTXT=REJSTA_"-"_REJDESC
"RTN","PSOERX1B",310,0)
 D POST^PSOERXO1(PSOIEN,.PSSRET,900,"",$E(FULLTXT,1,70))
"RTN","PSOERX1B",311,0)
 ; if the post was unsuccessful, inform the user and quit.
"RTN","PSOERX1B",312,0)
 I $P(PSSRET(0),U)<1 W !,$P(PSSRET(0),U,2) S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX1B",313,0)
 I $D(PSSRET("errorMessage")) W !,PSSRET("errorMessage") S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSOERX1B",314,0)
 W !!,"Rejection message sent." S DIR(0)="E" D ^DIR K DIR
"RTN","PSOERX1B",315,0)
 ; if post is successful, change the eRx status and log the status activity.
"RTN","PSOERX1B",316,0)
 S FDA(52.4919,"+1,"_PSOIENS,.01)=$$NOW^XLFDT
"RTN","PSOERX1B",317,0)
 S FDA(52.4919,"+1,"_PSOIENS,.02)=REJIEN
"RTN","PSOERX1B",318,0)
 S FDA(52.4919,"+1,"_PSOIENS,.03)=DUZ
"RTN","PSOERX1B",319,0)
 S FDA(52.4919,"+1,"_PSOIENS,1)=REJTXT
"RTN","PSOERX1B",320,0)
 D UPDATE^DIE(,"FDA") K FDA
"RTN","PSOERX1B",321,0)
 ; SET THE ERX STATUS TO THE REJECT REASON
"RTN","PSOERX1B",322,0)
 S ERXRJIEN=$O(^PS(52.45,"C","ERX","RJ",0))
"RTN","PSOERX1B",323,0)
 S DIE="^PS(52.49,",DR="1///"_ERXRJIEN,DA=PSOIEN D ^DIE
"RTN","PSOERX1B",324,0)
 K DIE,DR,DA
"RTN","PSOERX1B",325,0)
 Q
"RTN","PSOERXD2")
0^1^B205488607^B205678720
"RTN","PSOERXD2",1,0)
PSOERXD2 ;ALB/BWF - eRx Drug edit actions ; 5/26/2017 9:57am
"RTN","PSOERXD2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**467,506**;DEC 1997;Build 4
"RTN","PSOERXD2",3,0)
 ;
"RTN","PSOERXD2",4,0)
 Q
"RTN","PSOERXD2",5,0)
SBN ;
"RTN","PSOERXD2",6,0)
 N Y,ERXIEN
"RTN","PSOERXD2",7,0)
 S Y=$P(XQORNOD(0),"=",2)
"RTN","PSOERXD2",8,0)
 I Y']"" S VALMBCK="R" Q
"RTN","PSOERXD2",9,0)
 D EDIT^PSOERX1A("D",Y)
"RTN","PSOERXD2",10,0)
 S VALMBCK="R"
"RTN","PSOERXD2",11,0)
 Q
"RTN","PSOERXD2",12,0)
VDRG1(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",13,0)
 N VANDRG,VAODRG,DIE,DA,DR,AUTOVAL,DIC,Y,QTLOOP,SELDRG,VDRG,VANDRG,VAOI,PATINST
"RTN","PSOERXD2",14,0)
 Q:'$G(PSOIEN)
"RTN","PSOERXD2",15,0)
 S VAODRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I")
"RTN","PSOERXD2",16,0)
 S AUTOVAL=$$GET1^DIQ(52.49,PSOIEN,1.4,"I")
"RTN","PSOERXD2",17,0)
 I VAODRG W !,"Current Vista Drug: "_$$GET1^DIQ(50,VAODRG,.01,"E")
"RTN","PSOERXD2",18,0)
 ; for now allow user to search by drug name. may enhance screening in the future.
"RTN","PSOERXD2",19,0)
 S DIC(0)="AEMQ",DIC=50,DIC("S")="I $$ACTIVE^PSOERXA0(Y),($$OUTPAT^PSOERXA0(Y)),('$$INVCOMP^PSOERXA0(Y)),('$$CS^PSOERXA0(Y))"
"RTN","PSOERXD2",20,0)
 I VAODRG]"" S DIC("B")=VAODRG
"RTN","PSOERXD2",21,0)
 D ^DIC K DIC
"RTN","PSOERXD2",22,0)
 I $G(DUOUT)!($P(Y,U)<1) S PQUIT=1 Q
"RTN","PSOERXD2",23,0)
 S SELDRG=Y
"RTN","PSOERXD2",24,0)
 W !!,"You have selected: "_$P(Y,U,2),!,"Would you like to use this drug/supply?" S DIR(0)="YO" D ^DIR K DIR
"RTN","PSOERXD2",25,0)
 I Y="^"!(Y<1) S PQUIT=1 Q
"RTN","PSOERXD2",26,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="3.2///"_$P(SELDRG,U,1) D ^DIE
"RTN","PSOERXD2",27,0)
 ; set the manual validation flag if the drug has been selected.
"RTN","PSOERXD2",28,0)
 S VANDRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I")
"RTN","PSOERXD2",29,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERXD2",30,0)
 ; if the drug has changed, update the manual validation by and date/time
"RTN","PSOERXD2",31,0)
 I VANDRG'="",VAODRG'=VANDRG D
"RTN","PSOERXD2",32,0)
 .S QTLOOP=0 F  S QTLOOP=$O(^PS(52.49,PSOIEN,21,QTLOOP)) Q:'QTLOOP  D
"RTN","PSOERXD2",33,0)
 ..S FDA(52.4921,QTLOOP_","_PSOIENS,.01)="@" D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",34,0)
 .; if the drug is the same, leave the manual validation,otherwise delete it.
"RTN","PSOERXD2",35,0)
 .S FDA(52.49,PSOIENS,1.5)=""
"RTN","PSOERXD2",36,0)
 .S FDA(52.49,PSOIENS,1.11)="",FDA(52.49,PSOIENS,1.12)=""
"RTN","PSOERXD2",37,0)
 .S FDA(52.49,PSOIENS,20.3)="",FDA(52.49,PSOIENS,20.4)=""
"RTN","PSOERXD2",38,0)
 .S FDA(52.49,PSOIENS,27)="",FDA(52.49,PSOIENS,20.1)="",FDA(52.49,PSOIENS,20.2)=""
"RTN","PSOERXD2",39,0)
 .S FDA(52.49,PSOIENS,20.3)="",FDA(52.49,PSOIENS,20.4)="",FDA(52.49,PSOIENS,20.5)=""
"RTN","PSOERXD2",40,0)
 ; get and file patient instructions
"RTN","PSOERXD2",41,0)
 S VDRG=VANDRG
"RTN","PSOERXD2",42,0)
 S VAOI=$$GET1^DIQ(50,VDRG,2.1,"I")
"RTN","PSOERXD2",43,0)
 S PATINST=$$GET1^DIQ(50.7,VAOI,7,"E")
"RTN","PSOERXD2",44,0)
 I $L(PATINST) D
"RTN","PSOERXD2",45,0)
 .S FDA(52.49,PSOIENS,27)=$G(PATINST)
"RTN","PSOERXD2",46,0)
 D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",47,0)
 Q
"RTN","PSOERXD2",48,0)
VDRG2(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",49,0)
 N PSOQTS,PSOFROM
"RTN","PSOERXD2",50,0)
 N PSODOSE,PSONEW,PSODRUG,PSORXED,VERB,QTIEN,SFIENS,DOSE,PSODFN
"RTN","PSOERXD2",51,0)
 ; get patient IEN
"RTN","PSOERXD2",52,0)
 S PSODFN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXD2",53,0)
 I 'PSODFN D  Q
"RTN","PSOERXD2",54,0)
 .W !,"Cannot continue with dosing instructions until patient has been matched."
"RTN","PSOERXD2",55,0)
 .S DIR(0)="E" D ^DIR
"RTN","PSOERXD2",56,0)
 .S PQUIT=1
"RTN","PSOERXD2",57,0)
 ; get drug ien and orderable item ien
"RTN","PSOERXD2",58,0)
 D DERX1(PSOIEN,PSOIENS,1)
"RTN","PSOERXD2",59,0)
 S PSODRUG("IEN")=$$GET1^DIQ(52.49,PSOIEN,3.2,"I") Q:'PSODRUG("IEN")
"RTN","PSOERXD2",60,0)
 S PSODRUG("OI")=$$GET1^DIQ(50,PSODRUG("IEN"),2.1,"I") Q:'PSODRUG("OI")
"RTN","PSOERXD2",61,0)
 S (PSORXED("ENT"),ENT)=1
"RTN","PSOERXD2",62,0)
 ; SET PSOFROM=PENDING so the dosage list will activate and present to the user
"RTN","PSOERXD2",63,0)
 S PSOFROM="PENDING"
"RTN","PSOERXD2",64,0)
 D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN)
"RTN","PSOERXD2",65,0)
 D ASK^PSOBKDED
"RTN","PSOERXD2",66,0)
 I $G(DOSE)']"" S PQUIT=1 Q
"RTN","PSOERXD2",67,0)
 I $$GET1^DIQ(52.49,PSOIEN,1,"E")="N" D UPDSTAT^PSOERXU1(PSOIEN,"I")
"RTN","PSOERXD2",68,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOERXD2",69,0)
VER ;
"RTN","PSOERXD2",70,0)
 D DERX1(PSOIEN,PSOIENS,1)
"RTN","PSOERXD2",71,0)
 ;below logic brought over from VER^PSOOREDX
"RTN","PSOERXD2",72,0)
 D KV S DIR(0)="52.0113,8"
"RTN","PSOERXD2",73,0)
 S:$G(PSORXED("VERB",ENT))]"" DIR("B")=PSORXED("VERB",ENT)
"RTN","PSOERXD2",74,0)
 D ^DIR
"RTN","PSOERXD2",75,0)
 I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOERXD2",76,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",77,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOERXD2",78,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOERXD2",79,0)
DUPD ;
"RTN","PSOERXD2",80,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOERXD2",81,0)
 ; below logic brough over from DUPD^PSOOREDX
"RTN","PSOERXD2",82,0)
 D KV S DIR(0)="52.0113,1",DIR("A")="DISPENSE UNITS PER DOSE"_$S($G(PSORXED("NOUN",ENT))]"":"("_PSORXED("NOUN",ENT)_")",1:"")
"RTN","PSOERXD2",83,0)
 I '$G(PSORXED("DOSE",ENT)),$G(PSORXED("DOSE",ENT-1)) S PSORXED("DOSE",ENT)=PSORXED("DOSE",ENT-1)
"RTN","PSOERXD2",84,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:1) S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOERXD2",85,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOERXD2",86,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",87,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOERXD2",88,0)
 ;below logic brought over from STR^PSOOREDX
"RTN","PSOERXD2",89,0)
 S:+STRE>0&(X>0) PSORXED("DOSE",ENT)=(X*STRE) W !,"Dosage Ordered: "_$S($E(PSORXED("DOSE",ENT),1)=".":"0",1:"")_PSORXED("DOSE",ENT)_UNITN,!
"RTN","PSOERXD2",90,0)
 S:X'="" (PSORXED("DOSE ORDERED",ENT),DUPD)=X
"RTN","PSOERXD2",91,0)
NOU1 ;
"RTN","PSOERXD2",92,0)
 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOERXD2",93,0)
 D CNON
"RTN","PSOERXD2",94,0)
 N PSONDEF
"RTN","PSOERXD2",95,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOERXD2",96,0)
NOU ;
"RTN","PSOERXD2",97,0)
 ;below logic brought over from NOU^PSOOREDX
"RTN","PSOERXD2",98,0)
 D KV S DIR(0)="52.0113,3"
"RTN","PSOERXD2",99,0)
 S DIR("B")=$S($G(NOUN)]"":NOUN,1:$G(PSORXED("NOUN",ENT))) K:DIR("B")="" DIR("B")
"RTN","PSOERXD2",100,0)
 S PSONDEF=$G(DIR("B"))
"RTN","PSOERXD2",101,0)
 D ^DIR
"RTN","PSOERXD2",102,0)
 I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOERXD2",103,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",104,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOERXD2",105,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOERXD2",106,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOERXD2",107,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOERXD2",108,0)
 ;
"RTN","PSOERXD2",109,0)
RTE ;
"RTN","PSOERXD2",110,0)
 N CURTE,ERXRTE
"RTN","PSOERXD2",111,0)
 S CURTE=$$GET1^DIQ(52.4921,ENT_","_PSOIEN_",",10,"E") S PSORXED("ROUTE",ENT)=CURTE
"RTN","PSOERXD2",112,0)
 K JUMP ;S ROU="PSOORED3" D RTE2 K ROU
"RTN","PSOERXD2",113,0)
 S ROU="PSOERXD2" D RTE2 K ROU
"RTN","PSOERXD2",114,0)
 K ROU
"RTN","PSOERXD2",115,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOERXD2",116,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",117,0)
 ;
"RTN","PSOERXD2",118,0)
SCH ;
"RTN","PSOERXD2",119,0)
 K PSOSCH,DIR,CURSCH
"RTN","PSOERXD2",120,0)
 I '$D(ENT) S ENT=PSORXED("ENT")
"RTN","PSOERXD2",121,0)
 S CURSCH=$$GET1^DIQ(52.4921,ENT_","_PSOIEN_",",1,"E") I CURSCH]"" S DIR("B")=CURSCH
"RTN","PSOERXD2",122,0)
 S DIR("?")="^D SCHLP^PSOORED4",DIR("A")="Schedule: ",DIR(0)="FA^1:20^I X[""""""""!(X?.E1C.E)!($A(X)=45)!($L(X,"" "")>$S(X[""PRN"":4,1:3))!($L(X)>20)!($L(X)<1) K X"
"RTN","PSOERXD2",123,0)
 D ^DIR
"RTN","PSOERXD2",124,0)
 I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOERXD2",125,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",126,0)
 S SCH=Y D SCH^PSOSIG I $G(SCH)']"" G SCH
"RTN","PSOERXD2",127,0)
 S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOERXD2",128,0)
 S:PSORXED("ENT")<ENT PSORXED("ENT")=ENT
"RTN","PSOERXD2",129,0)
 ;
"RTN","PSOERXD2",130,0)
DUR ;
"RTN","PSOERXD2",131,0)
 N SIG,SIGDAT,SLOOP,P01,I,DDONE
"RTN","PSOERXD2",132,0)
 D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN DAYS, HOURS OR MINUTES)"
"RTN","PSOERXD2",133,0)
 S DIR("B")=$S($G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOERXD2",134,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOERXD2",135,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",136,0)
 ;below logic is from DUR1^PSOOREDX
"RTN","PSOERXD2",137,0)
 I X="@" K DUR,PSORXED("DURATION",ENT)
"RTN","PSOERXD2",138,0)
 I Y'="" S PSORXED("DURATION",ENT)=Y W " ("_$S(Y["L":"MONTHS",Y["W":"WEEKS",Y["H":"HOURS",Y["M":"MINUTES",1:"DAYS")_")"
"RTN","PSOERXD2",139,0)
 ;
"RTN","PSOERXD2",140,0)
 ; KEEP THIS CODE! - REMOVE CONJUNCTION FOR NOW, SINCE WE WILL NOT HAVE COMPLEX DOSING - FUTURE ENHANCEMENT
"RTN","PSOERXD2",141,0)
 ;CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOERXD2",142,0)
 ;G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOERXD2",143,0)
 ;I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOERXD2",144,0)
 ;S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOERXD2",145,0)
 ;I X="@",$D(PSORXED("CONJUNCTION",ENT)) D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOERXD2",146,0)
 ;;
"RTN","PSOERXD2",147,0)
 ;N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOERXD2",148,0)
 ;;*437
"RTN","PSOERXD2",149,0)
 ;I '$$DUROK^PSOORED3(.PSORXED,ENT) D  G DUR
"RTN","PSOERXD2",150,0)
 ;. W !!,"Duration is required for the dosage entered prior to the THEN conjunction.",$C(7),!
"RTN","PSOERXD2",151,0)
 ;I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSONEW("DFLG")) EX S ENT=ENT+1 K DIR G ASK
"RTN","PSOERXD2",152,0)
 ;E  K PSOCKCON D DCHK1^PSODOSUT I $D(DTOUT)!($D(DUOUT)) S PSORX("DFLG")=1,PSONEW("DFLG")=1 G EX  ;don't need to print the full summary, just the last sequence. 
"RTN","PSOERXD2",153,0)
 ;I PSOSAVX="",$G(PSORXED) K PSOCKCON,PSOEDDOS
"RTN","PSOERXD2",154,0)
 ;K PSOSAVX
"RTN","PSOERXD2",155,0)
 ;;
"RTN","PSOERXD2",156,0)
 ;S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOERXD2",157,0)
 ;D EN^PSOFSIG(.PSORXED),VERI I $G(CKX),'$G(PSOSIGFL) D MP1 K CKX
"RTN","PSOERXD2",158,0)
 ;I $G(PSOSIGFL)=1 D  I '$G(PSOSIGFL) Q
"RTN","PSOERXD2",159,0)
 ;.I $D(OR0),$P(OR0,"^",24)=1 S VALMSG="Digitally Signed Order - No such changes allowed." K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D  Q
"RTN","PSOERXD2",160,0)
 ;..I $D(PSOBDR) K PSODRUG M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOERXD2",161,0)
 ;.S PSORXED("ENT")=ENT,SIGOK=1,VALMSG="This change will create a new prescription!",NCPDPFLG=1
"RTN","PSOERXD2",162,0)
 ;K QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOERXD2",163,0)
 ;I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOERXD2",164,0)
 ;K QTYHLD
"RTN","PSOERXD2",165,0)
 ;I '$G(PSORXED("QTY")),$P(OR0,"^",10) S PSORXED("QTY")=$P(OR0,"^",10)
"RTN","PSOERXD2",166,0)
 ;S PSORXED("INS")="TESTING TO SEE HOW LONG WE CAN MAKE THE SIG AND GET THIS TO FORMAT CORRECTLY"
"RTN","PSOERXD2",167,0)
 S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOERXD2",168,0)
 D EN^PSOFSIG(.PSORXED)
"RTN","PSOERXD2",169,0)
 ; delete existing SIG
"RTN","PSOERXD2",170,0)
 S SLOOP=0 F  S SLOOP=$O(^PS(52.49,PSOIEN,"SIG",SLOOP)) Q:'SLOOP  D
"RTN","PSOERXD2",171,0)
 .S FDA(52.4926,SLOOP_","_PSOIEN_",",.01)="@"
"RTN","PSOERXD2",172,0)
 I $D(FDA) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",173,0)
 ; file sig into appropriate VA DISPENSING INSTRUCTIONS multiple
"RTN","PSOERXD2",174,0)
 S SLOOP=0 F  S SLOOP=$O(SIG(SLOOP)) Q:'SLOOP  D
"RTN","PSOERXD2",175,0)
 .S SIGDAT=$G(SIG(SLOOP)) Q:SIGDAT=""
"RTN","PSOERXD2",176,0)
 .S SFDA(52.4926,"+1,"_PSOIENS,.01)=SIGDAT D UPDATE^DIE(,"SFDA",,"SERR") K SFDA
"RTN","PSOERXD2",177,0)
 S QTIEN=$O(^PS(52.49,PSOIEN,21,0))
"RTN","PSOERXD2",178,0)
 S SFIENS=$S(QTIEN:QTIEN_",",1:"+1,")
"RTN","PSOERXD2",179,0)
 S P01=$S($L($G(PSORXED("DOSE ORDERED",ENT))):$G(PSORXED("DOSE ORDERED",ENT))_"&"_$G(PSORXED("NOUN",ENT)),1:$G(PSORXED("DOSE",ENT)))
"RTN","PSOERXD2",180,0)
 I '$L(P01) D  Q
"RTN","PSOERXD2",181,0)
 .W !,"Dosage is required. Please re-enter the dosing instructions." S DIR(0)="W" D ^DIR D EX Q 
"RTN","PSOERXD2",182,0)
 S FDA(52.4921,SFIENS_PSOIENS,.01)=$G(PSORXED("DOSE ORDERED",ENT))_"&"_$G(PSORXED("NOUN",ENT))
"RTN","PSOERXD2",183,0)
 S FDA(52.4921,SFIENS_PSOIENS,1)=$G(PSORXED("SCHEDULE",ENT))
"RTN","PSOERXD2",184,0)
 S FDA(52.4921,SFIENS_PSOIENS,2)=$G(PSORXED("DURATION",ENT))
"RTN","PSOERXD2",185,0)
 S FDA(52.4921,SFIENS_PSOIENS,8)=$G(PSORXED("DOSE",ENT))
"RTN","PSOERXD2",186,0)
 S FDA(52.4921,SFIENS_PSOIENS,9)=$G(PSORXED("DOSE ORDERED",ENT))
"RTN","PSOERXD2",187,0)
 S FDA(52.4921,SFIENS_PSOIENS,10)=$G(PSORXED("ROUTE",ENT))
"RTN","PSOERXD2",188,0)
 S FDA(52.4921,SFIENS_PSOIENS,11)=$G(PSORXED("UNITS",ENT))
"RTN","PSOERXD2",189,0)
 S FDA(52.4921,SFIENS_PSOIENS,12)=$G(PSORXED("NOUN",ENT))
"RTN","PSOERXD2",190,0)
 S FDA(52.4921,SFIENS_PSOIENS,13)=$G(PSORXED("VERB",ENT))
"RTN","PSOERXD2",191,0)
 ; VA INSTRUCTIONS
"RTN","PSOERXD2",192,0)
 N UNEXINS,UNEXARY,DDONE
"RTN","PSOERXD2",193,0)
 I $G(PSORXED("ENT")) D
"RTN","PSOERXD2",194,0)
 .S DDONE=0
"RTN","PSOERXD2",195,0)
 .F I=1:1:PSORXED("ENT")  D  Q:DDONE
"RTN","PSOERXD2",196,0)
 ..I '$D(PSORXED("DOSE ORDERED",I)) S DDONE=1 Q
"RTN","PSOERXD2",197,0)
 ..I '$L($G(UNEXINS)) D  Q
"RTN","PSOERXD2",198,0)
 ...S UNEXINS=$G(PSORXED("VERB",I))_" "_$G(PSORXED("DOSE ORDERED",I))_" "_$G(PSORXED("NOUN",I))_" "_$G(ERXRTE(I))_" "_$G(PSORXED("SCHEDULE",I))
"RTN","PSOERXD2",199,0)
 ...I $L($G(PSORXED("DURATION",I))) S UNEXINS=UNEXINS_" "_$G(PSORXED("DURATION",I))
"RTN","PSOERXD2",200,0)
 ...I $L($G(PSORXED("CONJUNCTION",I))) S UNEXINS=UNEXINS_" "_$G(PSORXED("CONJUNCTION",I))
"RTN","PSOERXD2",201,0)
 ..S UNEXINS=UNEXINS_$G(PSORXED("VERB",I))_" "_$G(PSORXED("DOSE ORDERED",I))_" "_$G(PSORXED("NOUN",I))_" "_$G(ERXRTE(I))_" "_$G(PSORXED("SCHEDULE",I))
"RTN","PSOERXD2",202,0)
 ..I $L($G(PSORXED("DURATION",I))) S UNEXINS=UNEXINS_" "_$G(PSORXED("DURATION",I))
"RTN","PSOERXD2",203,0)
 ..I $L($G(PSORXED("CONJUNCTION",I))) S UNEXINS=UNEXINS_" "_$G(PSORXED("CONJUNCTION",I))
"RTN","PSOERXD2",204,0)
 I $L($G(UNEXINS)) D
"RTN","PSOERXD2",205,0)
 .D TXT2ARY^PSOERXD1(.UNEXARY,UNEXINS,,80)
"RTN","PSOERXD2",206,0)
 .D WP^DIE(52.49,PSOIEN_",",31,"K","UNEXARY","BWFERR")
"RTN","PSOERXD2",207,0)
 I SFIENS["+" D UPDATE^DIE(,"FDA",,"ERR") K FDA
"RTN","PSOERXD2",208,0)
 ; if there is a quantity/timing entry, overwrite the data (we are not using complex dosing in this phase)
"RTN","PSOERXD2",209,0)
 I SFIENS'["+" D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",210,0)
EX ;
"RTN","PSOERXD2",211,0)
 K PSOBDR,PSOBDRG,PSOSCH,DUPD,STRE,UNITN,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSODOSE,OLENT,FIELD,FLDNM,AR,NM,ENT,STRE,UNITN,PSODOSE,ERTE,ROU,AR1,INS1
"RTN","PSOERXD2",212,0)
KV K DTOUT,DUOUT,DIR,DIRUT
"RTN","PSOERXD2",213,0)
 Q
"RTN","PSOERXD2",214,0)
EXQ ;
"RTN","PSOERXD2",215,0)
 K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D MP1
"RTN","PSOERXD2",216,0)
 I $D(PSOBDR) M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOERXD2",217,0)
 S PQUIT=1
"RTN","PSOERXD2",218,0)
 G EX Q
"RTN","PSOERXD2",219,0)
MP1 ;
"RTN","PSOERXD2",220,0)
 S VALMSG="eRx Not Updated!"
"RTN","PSOERXD2",221,0)
 Q
"RTN","PSOERXD2",222,0)
JUMP ;jump to fields
"RTN","PSOERXD2",223,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOERXD2",224,0)
 D FNM
"RTN","PSOERXD2",225,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOERXD2",226,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOERXD2",227,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOERXD2",228,0)
 D JFN G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOERXD2",229,0)
 G EX
"RTN","PSOERXD2",230,0)
 Q
"RTN","PSOERXD2",231,0)
FNM S NM=$E(X,2,4),NM=$TR(NM,"qwertyuioplkjhgfdsazxcvbnm","QWERTYUIOPLKJHGFDSAZXCVBNM")
"RTN","PSOERXD2",232,0)
 S FLDNM=$S(NM="DOS":"DOSE^*Dosage",NM="DIS":"DOSE ORDERED^Dispense Units",NM="ROU":"ROUTE^*Route",NM="SCH":"SCHEDULE^*Schedule",NM="DUR"!(NM="LIM"):"DURATION^*Duration",1:"")
"RTN","PSOERXD2",233,0)
 S:FLDNM="" FLDNM=$S(NM="CON":"CONJUNCTION^*Conjunction",NM="NOU":"NOUN^Noun",NM="VER":"VERB^Verb",1:"")
"RTN","PSOERXD2",234,0)
 Q
"RTN","PSOERXD2",235,0)
JFN K FLDNM,AR S ENT=+Y,FLDNM=$S(NM="NOU":"NOU",NM="VER":"VER",NM="DOS":"ASK",NM="DIS":"DUPD",NM="ROU":"RTE",NM="SCH":"SCH",NM="DUR"!(NM="LIM"):"DUR",NM="CON":"CON",1:"")
"RTN","PSOERXD2",236,0)
 Q
"RTN","PSOERXD2",237,0)
CNON ;
"RTN","PSOERXD2",238,0)
 I $G(NOUN)'="" Q
"RTN","PSOERXD2",239,0)
 I '$G(PSORXED("DOSE ORDERED",ENT)) Q
"RTN","PSOERXD2",240,0)
 N PSONLT,PSONLL,PSONLG
"RTN","PSOERXD2",241,0)
 S PSONLL=$P($G(DOSE("DD",+$G(PSODRUG("IEN")))),"^",9) I PSONLL="" Q
"RTN","PSOERXD2",242,0)
 S PSONLG=$L(PSONLL)
"RTN","PSOERXD2",243,0)
 I PSONLG'>3 Q
"RTN","PSOERXD2",244,0)
 S PSONLT=$E(PSONLL,(PSONLG-2),PSONLG)
"RTN","PSOERXD2",245,0)
 I PSONLT'="(S)",PSONLT'="(s)" Q
"RTN","PSOERXD2",246,0)
 ;test noun of (S)
"RTN","PSOERXD2",247,0)
 K NOUN
"RTN","PSOERXD2",248,0)
 I $G(PSORXED("DOSE ORDERED",ENT))>1 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))_$E(PSONLT,2) Q
"RTN","PSOERXD2",249,0)
 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))
"RTN","PSOERXD2",250,0)
 Q
"RTN","PSOERXD2",251,0)
RTE2 I $G(DRET) S PSORXED("ROUTE",ENT)=""
"RTN","PSOERXD2",252,0)
 I $G(RTE) K RTE
"RTN","PSOERXD2",253,0)
 K DIR,DIRUT S DIR(0)="FO^2:45",DIR("A")="ROUTE",DIR("?")="^D HLP^PSOORED4"
"RTN","PSOERXD2",254,0)
 ;S DIR("B")=$S($G(PSORXED("ROUTE",ENT)):$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),$G(RTE)]"":RTE,$G(DRET):"",1:"PO") K:DIR("B")="" DIR("B")
"RTN","PSOERXD2",255,0)
 S DIR("B")=$G(CURTE)
"RTN","PSOERXD2",256,0)
 ;I '$G(PSORXED("ROUTE",ENT)),$G(PSOREEDT) K DIR("B")
"RTN","PSOERXD2",257,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="RTE",JUMP=1 K DIRUT,DTOUT Q
"RTN","PSOERXD2",258,0)
 Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOERXD2",259,0)
 I X="@"!(X="") K RTE,ERTE S DRET=1,PSORXED("ROUTE",ENT)="" Q
"RTN","PSOERXD2",260,0)
 K DRET I X=$P($G(^PS(51.2,+$G(PSORXED("ROUTE",ENT)),0)),"^") S RTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),ERTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^",2) W X_" "_$G(ERTE) Q
"RTN","PSOERXD2",261,0)
 S DIC=51.2,DIC(0)="QEZM",DIC("S")="I $P(^(0),""^"",4)" D ^DIC Q:X[U  G:Y=-1 RTE2 W "  "_$P(Y(0),"^",2)
"RTN","PSOERXD2",262,0)
 ;S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2)
"RTN","PSOERXD2",263,0)
 S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2),ERXRTE(ENT)=$P(Y(0),U,3)
"RTN","PSOERXD2",264,0)
 Q
"RTN","PSOERXD2",265,0)
VDRG3(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",266,0)
 N DIR,Y,PATINST,ERXDRUG,VDRG,VAOI,FDA
"RTN","PSOERXD2",267,0)
 D DERX1(PSOIEN,PSOIENS,1)
"RTN","PSOERXD2",268,0)
 S ERXDRUG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I")
"RTN","PSOERXD2",269,0)
 S PATINST=$$GET1^DIQ(52.49,PSOIEN,27,"E")
"RTN","PSOERXD2",270,0)
 I '$L(PATINST) D
"RTN","PSOERXD2",271,0)
 .S VDRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I") Q:'VDRG
"RTN","PSOERXD2",272,0)
 .S VAOI=$$GET1^DIQ(50,VDRG,2.1,"I") Q:'VAOI
"RTN","PSOERXD2",273,0)
 .S PATINST=$$GET1^DIQ(50.7,VAOI,7,"E")
"RTN","PSOERXD2",274,0)
 K DIR
"RTN","PSOERXD2",275,0)
 S DIR(0)="52.49,27",DIR("A")="VA PATIENT INSTRUCTIONS"
"RTN","PSOERXD2",276,0)
 I $L(PATINST) S DIR("B")=PATINST
"RTN","PSOERXD2",277,0)
 D ^DIR K DIR
"RTN","PSOERXD2",278,0)
 I Y["^" S PQUIT=1 Q
"RTN","PSOERXD2",279,0)
 S FDA(52.49,PSOIEN_",",27)=$$UP^XLFSTR(Y) D FILE^DIE(,"FDA","ERR") K FDA
"RTN","PSOERXD2",280,0)
 Q
"RTN","PSOERXD2",281,0)
VDRG4(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",282,0)
 N DIR,Y,USERCOMM,VPATINST,UFLAG,VAPCOMM,ERXPCOMM,FDA
"RTN","PSOERXD2",283,0)
 ; POSSIBLE FUTURE IMPLEMENTATION OF ERX DETAILS
"RTN","PSOERXD2",284,0)
 ;D DERX1(PSOIEN,PSOIENS,1)
"RTN","PSOERXD2",285,0)
 S VPATINST=$$GET1^DIQ(52.49,PSOIEN,27,"E")
"RTN","PSOERXD2",286,0)
 S ERXPCOMM=$$GET1^DIQ(52.49,PSOIEN,8,"E")
"RTN","PSOERXD2",287,0)
 S VAPCOMM=$$GET1^DIQ(52.49,PSOIEN,30,"E")
"RTN","PSOERXD2",288,0)
 S DIR(0)="FO^1:240",DIR("A")="VA Provider Comments",DIR("B")=$S($L(VAPCOMM):VAPCOMM,1:ERXPCOMM)
"RTN","PSOERXD2",289,0)
 D ^DIR K DIR
"RTN","PSOERXD2",290,0)
 I Y["^" S PQUIT=1 Q
"RTN","PSOERXD2",291,0)
 S USERCOMM=$$UP^XLFSTR(Y) K Y
"RTN","PSOERXD2",292,0)
 S FDA(52.49,PSOIEN_",",30)=$$UP^XLFSTR(USERCOMM) D FILE^DIE(,"FDA") K FDA
"RTN","PSOERXD2",293,0)
 Q
"RTN","PSOERXD2",294,0)
VDRG5(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",295,0)
 N PATIEN,PS55IEN,Y,DIE,DR,DA
"RTN","PSOERXD2",296,0)
 S PATIEN=$$GET1^DIQ(52.49,PSOIEN,.05,"I")
"RTN","PSOERXD2",297,0)
 I 'PATIEN W !!,"Patient has not been validated, cannot edit patient status",! Q
"RTN","PSOERXD2",298,0)
 S PS55IEN=$O(^PS(55,"B",PATIEN,0)) Q:'PS55IEN
"RTN","PSOERXD2",299,0)
 S DIE="^PS(55,",DA=PS55IEN,DR="3" D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",300,0)
 I $D(Y) S PQUIT=1
"RTN","PSOERXD2",301,0)
 Q
"RTN","PSOERXD2",302,0)
VDRG6(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",303,0)
 ;S DIE="^PS(52.49,",DA=PSOIEN,DR="20.1" D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",304,0)
 N DIR,PSODRG,DRGMSG,ERXQTY,VAQTY,DIE,DA,DR
"RTN","PSOERXD2",305,0)
 S PSODRG=$$GET1^DIQ(52.49,PSOIEN,3.2,"I")
"RTN","PSOERXD2",306,0)
 I PSODRG S DRGMSG=$$GET1^DIQ(50,PSODRG,215,"E")
"RTN","PSOERXD2",307,0)
 S ERXQTY=$$GET1^DIQ(52.49,PSOIEN,5.1,"E")
"RTN","PSOERXD2",308,0)
 W !,"eRx Quantity: "_ERXQTY
"RTN","PSOERXD2",309,0)
 I $P(ERXQTY,".",2)>2 S ERXQTY=""
"RTN","PSOERXD2",310,0)
 S VAQTY=$$GET1^DIQ(52.49,PSOIEN,20.1,"E")
"RTN","PSOERXD2",311,0)
 S DIR("B")=$S(VAQTY]"":VAQTY,1:ERXQTY)
"RTN","PSOERXD2",312,0)
 S DIR(0)="52.49,20.1",DIR("A")="VISTA QUANTITY"_$S($G(DRGMSG)]"":" <"_DRGMSG_">",1:"") D ^DIR
"RTN","PSOERXD2",313,0)
 I Y["^" S PQUIT=1 Q
"RTN","PSOERXD2",314,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="20.1///"_Y D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",315,0)
 Q
"RTN","PSOERXD2",316,0)
VDRG7(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",317,0)
 N Y,ERXDS,DIE,DR,DA
"RTN","PSOERXD2",318,0)
 S ERXDS=$$GET1^DIQ(52.49,PSOIEN,5.5,"E")
"RTN","PSOERXD2",319,0)
 W !,"eRx Days Supply: "_ERXDS
"RTN","PSOERXD2",320,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="20.2" D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",321,0)
 I $O(Y(0)) S PQUIT=1
"RTN","PSOERXD2",322,0)
 Q
"RTN","PSOERXD2",323,0)
VDRG8(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",324,0)
 N Y,ERXRFLS,DIE,DR,DA
"RTN","PSOERXD2",325,0)
 S ERXRFLS=$$GET1^DIQ(52.49,PSOIEN,5.6,"E")
"RTN","PSOERXD2",326,0)
 W !,"eRx Refills: "_ERXRFLS
"RTN","PSOERXD2",327,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="20.5" D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",328,0)
 I $O(Y(0)) S PQUIT=1
"RTN","PSOERXD2",329,0)
 Q
"RTN","PSOERXD2",330,0)
VDRG9(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",331,0)
 N Y,DIR,DIE,DR,DA
"RTN","PSOERXD2",332,0)
 S DIR("A")="PICKUP ROUTING"
"RTN","PSOERXD2",333,0)
 S DIR(0)="SO^M:MAIL;W:WINDOW",DIR("B")="M" D ^DIR K DIR
"RTN","PSOERXD2",334,0)
 I Y["^" S PQUIT=1 Q
"RTN","PSOERXD2",335,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="20.4///"_Y D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",336,0)
 Q
"RTN","PSOERXD2",337,0)
VDRG10(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",338,0)
 N DIC,Y,VACLIN,CURCLIN,DIE,DR,DA
"RTN","PSOERXD2",339,0)
 S CURCLIN=$$GET1^DIQ(52.49,PSOIEN,20.6,"E")
"RTN","PSOERXD2",340,0)
 I '$L(CURCLIN) S CURCLIN=$$GET1^DIQ(59,PSOSITE,10,"E")
"RTN","PSOERXD2",341,0)
 S DIC("B")=CURCLIN
"RTN","PSOERXD2",342,0)
 S DIC="^SC(",DIC(0)="QEAMZ",DIC("A")="Select CLINIC: " D ^DIC K DIC
"RTN","PSOERXD2",343,0)
 I Y<1 Q
"RTN","PSOERXD2",344,0)
 I ($D(DTOUT))!($D(DUOUT)) S PQUIT=1 Q
"RTN","PSOERXD2",345,0)
 S VACLIN=$P(Y,U)
"RTN","PSOERXD2",346,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="20.6///"_VACLIN D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",347,0)
 K DTOUT,DUOUT
"RTN","PSOERXD2",348,0)
 Q
"RTN","PSOERXD2",349,0)
VDRG11(PSOIEN,PSOIENS) ;
"RTN","PSOERXD2",350,0)
 N DIE,DR,DA,Y
"RTN","PSOERXD2",351,0)
 S DIE="^PS(52.49,",DA=PSOIEN,DR="8" D ^DIE K DIE,DR,DA
"RTN","PSOERXD2",352,0)
 I $O(Y(0)) S PQUIT=1
"RTN","PSOERXD2",353,0)
 Q
"RTN","PSOERXD2",354,0)
 ; display erx info
"RTN","PSOERXD2",355,0)
 ; DFLG - display flag
"RTN","PSOERXD2",356,0)
 ;          1 - drug sig comments
"RTN","PSOERXD2",357,0)
 ;          ""- all
"RTN","PSOERXD2",358,0)
 ;          
"RTN","PSOERXD2",359,0)
DERX1(PSOIEN,PSOIENS,DFLG) ;
"RTN","PSOERXD2",360,0)
 N EDRG,ERXDAT,ESIG,COMM,SUBS,DFORM,DSTR,QQUAL,POTUC,QTY,DAYS,REFILL,COMMARY,SIGARY
"RTN","PSOERXD2",361,0)
 D GETS^DIQ(52.49,PSOIENS,"3.1;4.6;4.8;5.1;5.2;5.4;5.5;5.6;5.8;7;8;41;42;43","E","ERXDAT")
"RTN","PSOERXD2",362,0)
 S DFLG=$G(DFLG,"")
"RTN","PSOERXD2",363,0)
 S EDRG=$G(ERXDAT(52.49,PSOIENS,3.1,"E"))
"RTN","PSOERXD2",364,0)
 S ESIG=$G(ERXDAT(52.49,PSOIENS,7,"E"))
"RTN","PSOERXD2",365,0)
 S COMM=$G(ERXDAT(52.49,PSOIENS,8,"E"))
"RTN","PSOERXD2",366,0)
 S SUBS=$G(ERXDAT(52.49,PSOIENS,5.8,"E"))
"RTN","PSOERXD2",367,0)
 S DFORM=$G(ERXDAT(52.49,PSOIENS,41,"E"))
"RTN","PSOERXD2",368,0)
 S DSTR=$G(ERXDAT(52.49,PSOIENS,43,"E"))
"RTN","PSOERXD2",369,0)
 S QQUAL=$G(ERXDAT(52.49,PSOIENS,5.2,"E"))
"RTN","PSOERXD2",370,0)
 S POTUC=$G(ERXDAT(52.49,PSOIENS,42,"E"))
"RTN","PSOERXD2",371,0)
 S QTY=$G(ERXDAT(52.49,PSOIENS,5.1,"E"))
"RTN","PSOERXD2",372,0)
 S DAYS=$G(ERXDAT(52.49,PSOIENS,5.5,"E"))
"RTN","PSOERXD2",373,0)
 S REFILL=$G(ERXDAT(52.49,PSOIENS,5.6,"E"))
"RTN","PSOERXD2",374,0)
 D TXT2ARY^PSOERXD1(.SIGARY,ESIG,,69)
"RTN","PSOERXD2",375,0)
 D TXT2ARY^PSOERXD1(.COMMARY,COMM,,65)
"RTN","PSOERXD2",376,0)
 W !!!,"eRx Drug: "_EDRG
"RTN","PSOERXD2",377,0)
 W !,"eRx Sig: "
"RTN","PSOERXD2",378,0)
 S I=0 F  S I=$O(SIGARY(I)) Q:'I  D
"RTN","PSOERXD2",379,0)
 .W $S(I>1:"         "_SIGARY(I),1:SIGARY(I)),!
"RTN","PSOERXD2",380,0)
 I '$L(ESIG) W !
"RTN","PSOERXD2",381,0)
 W "eRx Notes: "
"RTN","PSOERXD2",382,0)
 S I=0 F  S I=$O(COMMARY(I)) Q:'I  D
"RTN","PSOERXD2",383,0)
 .W $S(I>1:"              "_COMMARY(I),1:COMMARY(I)),!
"RTN","PSOERXD2",384,0)
 I '$L(COMM) W !
"RTN","PSOERXD2",385,0)
 Q:DFLG=1
"RTN","PSOERXD2",386,0)
 W "Drug Form: "_DFORM,?40,"Strength: "_DSTR
"RTN","PSOERXD2",387,0)
 W !,"Qty Qualifier: "_QQUAL,?40,"Potency Unit Code: "_POTUC
"RTN","PSOERXD2",388,0)
 W !,"DAW Code: "_SUBS
"RTN","PSOERXD2",389,0)
 W !,"Qty: "_QTY,?25,"Days Supply: "_DAYS,?55,"Refills: "_REFILL,!!
"RTN","PSOERXD2",390,0)
 Q
"VER")
8.0^22.2
"BLD",9590,6)
^417
**END**
**END**

