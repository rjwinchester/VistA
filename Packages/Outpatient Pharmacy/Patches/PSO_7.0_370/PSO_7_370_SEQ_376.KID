Released PSO*7*370 SEQ #376
Extracted from mail message
**KIDS**:PSO*7.0*370^

**INSTALL NAME**
PSO*7.0*370
"BLD",9638,0)
PSO*7.0*370^OUTPATIENT PHARMACY^0^3141205^y
"BLD",9638,1,0)
^^9^9^3141205^
"BLD",9638,1,1,0)
This patch will resolve the following issues.
"BLD",9638,1,2,0)
A foreign address is triggered for the Philippines when printing
"BLD",9638,1,3,0)
suspense labels with a Routing of Mail.
"BLD",9638,1,4,0)
The Help Prompt for the Label Date/Time in the Prescription file is 
"BLD",9638,1,5,0)
incorrect.
"BLD",9638,1,6,0)
When editing the Refill Date on a prescription, the internal Fileman
"BLD",9638,1,7,0)
date is stored in the Activity Log entry.
"BLD",9638,1,8,0)
User without PSORPH key can put rx on hold using pharmacist reasons.
"BLD",9638,1,9,0)
The finishing pharmacist's name appears in the released pharmacist's entry
"BLD",9638,4,0)
^9.64PA^^0
"BLD",9638,6.3)
14
"BLD",9638,"INID")
^n
"BLD",9638,"INIT")
RH^PSO7P370
"BLD",9638,"KRN",0)
^9.67PA^779.2^20
"BLD",9638,"KRN",.4,0)
.4
"BLD",9638,"KRN",.401,0)
.401
"BLD",9638,"KRN",.402,0)
.402
"BLD",9638,"KRN",.403,0)
.403
"BLD",9638,"KRN",.5,0)
.5
"BLD",9638,"KRN",.84,0)
.84
"BLD",9638,"KRN",3.6,0)
3.6
"BLD",9638,"KRN",3.8,0)
3.8
"BLD",9638,"KRN",9.2,0)
9.2
"BLD",9638,"KRN",9.8,0)
9.8
"BLD",9638,"KRN",9.8,"NM",0)
^9.68A^7^7
"BLD",9638,"KRN",9.8,"NM",1,0)
PSOLLL1^^0^B74505234
"BLD",9638,"KRN",9.8,"NM",2,0)
PSOSULBL^^0^B77851131
"BLD",9638,"KRN",9.8,"NM",3,0)
PSO7P370^^0^B1411945
"BLD",9638,"KRN",9.8,"NM",4,0)
PSORXED1^^0^B22048628
"BLD",9638,"KRN",9.8,"NM",5,0)
PSODGDGP^^0^B67529993
"BLD",9638,"KRN",9.8,"NM",6,0)
PSOHLD^^0^B87531422
"BLD",9638,"KRN",9.8,"NM",7,0)
PSORXL^^0^B124759619
"BLD",9638,"KRN",9.8,"NM","B","PSO7P370",3)

"BLD",9638,"KRN",9.8,"NM","B","PSODGDGP",5)

"BLD",9638,"KRN",9.8,"NM","B","PSOHLD",6)

"BLD",9638,"KRN",9.8,"NM","B","PSOLLL1",1)

"BLD",9638,"KRN",9.8,"NM","B","PSORXED1",4)

"BLD",9638,"KRN",9.8,"NM","B","PSORXL",7)

"BLD",9638,"KRN",9.8,"NM","B","PSOSULBL",2)

"BLD",9638,"KRN",19,0)
19
"BLD",9638,"KRN",19.1,0)
19.1
"BLD",9638,"KRN",101,0)
101
"BLD",9638,"KRN",409.61,0)
409.61
"BLD",9638,"KRN",771,0)
771
"BLD",9638,"KRN",779.2,0)
779.2
"BLD",9638,"KRN",870,0)
870
"BLD",9638,"KRN",8989.51,0)
8989.51
"BLD",9638,"KRN",8989.52,0)
8989.52
"BLD",9638,"KRN",8994,0)
8994
"BLD",9638,"KRN","B",.4,.4)

"BLD",9638,"KRN","B",.401,.401)

"BLD",9638,"KRN","B",.402,.402)

"BLD",9638,"KRN","B",.403,.403)

"BLD",9638,"KRN","B",.5,.5)

"BLD",9638,"KRN","B",.84,.84)

"BLD",9638,"KRN","B",3.6,3.6)

"BLD",9638,"KRN","B",3.8,3.8)

"BLD",9638,"KRN","B",9.2,9.2)

"BLD",9638,"KRN","B",9.8,9.8)

"BLD",9638,"KRN","B",19,19)

"BLD",9638,"KRN","B",19.1,19.1)

"BLD",9638,"KRN","B",101,101)

"BLD",9638,"KRN","B",409.61,409.61)

"BLD",9638,"KRN","B",771,771)

"BLD",9638,"KRN","B",779.2,779.2)

"BLD",9638,"KRN","B",870,870)

"BLD",9638,"KRN","B",8989.51,8989.51)

"BLD",9638,"KRN","B",8989.52,8989.52)

"BLD",9638,"KRN","B",8994,8994)

"BLD",9638,"QDEF")
^^^^NO^^^^^^NO
"BLD",9638,"QUES",0)
^9.62^^
"BLD",9638,"REQB",0)
^9.611^4^4
"BLD",9638,"REQB",1,0)
PSO*7.0*383^2
"BLD",9638,"REQB",2,0)
PSO*7.0*421^2
"BLD",9638,"REQB",3,0)
PSO*7.0*386^2
"BLD",9638,"REQB",4,0)
PSO*7.0*416^2
"BLD",9638,"REQB","B","PSO*7.0*383",1)

"BLD",9638,"REQB","B","PSO*7.0*386",3)

"BLD",9638,"REQB","B","PSO*7.0*416",4)

"BLD",9638,"REQB","B","PSO*7.0*421",2)

"INIT")
RH^PSO7P370
"MBREQ")
0
"PKG",206,-1)
1^1
"PKG",206,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",206,20,0)
^9.402P^^
"PKG",206,22,0)
^9.49I^1^1
"PKG",206,22,1,0)
7.0^3021122^3021202^66481
"PKG",206,22,1,"PAH",1,0)
370^3141205
"PKG",206,22,1,"PAH",1,1,0)
^^9^9^3141205
"PKG",206,22,1,"PAH",1,1,1,0)
This patch will resolve the following issues.
"PKG",206,22,1,"PAH",1,1,2,0)
A foreign address is triggered for the Philippines when printing
"PKG",206,22,1,"PAH",1,1,3,0)
suspense labels with a Routing of Mail.
"PKG",206,22,1,"PAH",1,1,4,0)
The Help Prompt for the Label Date/Time in the Prescription file is 
"PKG",206,22,1,"PAH",1,1,5,0)
incorrect.
"PKG",206,22,1,"PAH",1,1,6,0)
When editing the Refill Date on a prescription, the internal Fileman
"PKG",206,22,1,"PAH",1,1,7,0)
date is stored in the Activity Log entry.
"PKG",206,22,1,"PAH",1,1,8,0)
User without PSORPH key can put rx on hold using pharmacist reasons.
"PKG",206,22,1,"PAH",1,1,9,0)
The finishing pharmacist's name appears in the released pharmacist's entry
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","PSO7P370")
0^3^B1411945^n/a
"RTN","PSO7P370",1,0)
PSO7P370 ;VGH - Patch 370 Post Install routine;4/1/2014
"RTN","PSO7P370",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**370**;DEC 1997;Build 14
"RTN","PSO7P370",3,0)
 ;
"RTN","PSO7P370",4,0)
 ;External reference ^DD(52 supported by DBIA 6034
"RTN","PSO7P370",5,0)
 ;
"RTN","PSO7P370",6,0)
 Q
"RTN","PSO7P370",7,0)
 ;
"RTN","PSO7P370",8,0)
RH ;Remove HELP-PROMPT for LABEL DATE/TIME - Since this is a multiple, it should not have help text
"RTN","PSO7P370",9,0)
 ;^DD(52,32,3)="Enter date/time when and if medication was returned to inventory due not being icked up or mailed to the patient."
"RTN","PSO7P370",10,0)
 S X1=DT,X2=+30 D C^%DTC
"RTN","PSO7P370",11,0)
 S ^XTMP("PSO7P370",0)=$G(X)_"^"_DT_"^HELP-PROMPT DELETION^"
"RTN","PSO7P370",12,0)
 S ^XTMP("PSO7P370",1)="^DD(52,32,3)=Enter date/time when and if medication was returned to inventory due not being icked up or mailed to the patient."
"RTN","PSO7P370",13,0)
 K ^DD(52,32,3)
"RTN","PSO7P370",14,0)
 Q
"RTN","PSODGDGP")
0^5^B67529993^B67660976
"RTN","PSODGDGP",1,0)
PSODGDGP ;BIR/SAB - drug drug interaction checker ;4/14/93
"RTN","PSODGDGP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,387,379,391,372,416,370**;DEC 1997;Build 14
"RTN","PSODGDGP",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSODGDGP",4,0)
 ;External references PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSODGDGP",5,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSODGDGP",6,0)
 ;External reference ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSODGDGP",7,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSODGDGP",8,0)
 N DRG,PSOREMOT S (CRIT,DRG,LSI,DGI,DGS,SER,SERS,STA,PSOICT)="",PSOREMOT=0
"RTN","PSODGDGP",9,0)
 D BLD Q:+$G(PSORX("DFLG"))!($G(PSODLQT))
"RTN","PSODGDGP",10,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(DGI)]"" S:$G(CRIT) PSONEW("STATUS")=4 W $C(7),!,"DRUG INTERACTON WITH RX #s: "_LSI,!
"RTN","PSODGDGP",11,0)
 I '$D(^XUSEC("PSORPH",DUZ)),(","_$G(^TMP("PSOSER",$J,0))_",")[(",1,") S:$D(^TMP("PSODGI",$J,0)) PSONEW("STATUS")=4
"RTN","PSODGDGP",12,0)
 K DRG,NDF,PSOICT,IT,LSI
"RTN","PSODGDGP",13,0)
 I +$G(PSORX("DFLG")) Q
"RTN","PSODGDGP",14,0)
 I +$G(PSODRUG("NDF"))'=0 D
"RTN","PSODGDGP",15,0)
 .I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSODGDGP",16,0)
 .I '$$HAVEHDR^ORRDI1 Q
"RTN","PSODGDGP",17,0)
 .;D HD^PSODDPR2():(($Y+5)>IOSL)
"RTN","PSODGDGP",18,0)
 .I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !!,"Remote data not available - Only local order checks processed.",!! S PSOREMOT=1 D HD^PSODDPR2():(($Y+5)>IOSL) Q
"RTN","PSODGDGP",19,0)
 .I $D(^TMP($J,"DI"_PSODFN)) K ^TMP($J,"DI") M ^TMP($J,"DI")=^TMP($J,"DI"_PSODFN) D DRGINT^PSOORRD2
"RTN","PSODGDGP",20,0)
 .K ^TMP($J,"DI"_PSODFN),^TMP($J,"DI")
"RTN","PSODGDGP",21,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(PSOREMOT)!($G(DGI)]"") K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue..." D ^DIR K DIR,DUOUT,DTOUT
"RTN","PSODGDGP",22,0)
 Q
"RTN","PSODGDGP",23,0)
TECH ;add tech entry to RX VERIFY file (#52.4); called from new order/copy/renew
"RTN","PSODGDGP",24,0)
 I $$DS^PSSDSAPI,+$G(^TMP("PSODOSF",$J,0)) S ^PS(52.4,PSOXIRXN,1)=^TMP("PSODOSF",$J,0)
"RTN","PSODGDGP",25,0)
 Q:'$D(^TMP("PSODGI",$J,0))
"RTN","PSODGDGP",26,0)
 S $P(^PSRX(PSOXIRXN,"DRI"),"^")=^TMP("PSOSER",$J,0)_"^"_^TMP("PSODGI",$J,0)
"RTN","PSODGDGP",27,0)
 S $P(^PS(52.4,PSOXIRXN,0),"^",8)=1,$P(^PS(52.4,PSOXIRXN,0),"^",9)=^TMP("PSOSER",$J,0),$P(^PS(52.4,PSOXIRXN,0),"^",10)=^TMP("PSODGI",$J,0)
"RTN","PSODGDGP",28,0)
 Q
"RTN","PSODGDGP",29,0)
TECH2(PSOXIRXN,PSODFN,DUZ,PSOX) ;
"RTN","PSODGDGP",30,0)
 I $D(PSOX("NOPSDRPH")) G T3
"RTN","PSODGDGP",31,0)
 Q:$D(^XUSEC("PSORPH",DUZ))
"RTN","PSODGDGP",32,0)
T3 ;
"RTN","PSODGDGP",33,0)
 ; The only time PSOX("NOPSDRPH) key is defined equal to 1 is for controlled substances and the user doesn't hold
"RTN","PSODGDGP",34,0)
 ; the PSDRPH key.
"RTN","PSODGDGP",35,0)
 N PSODWARN,PSOSIGNIF,PSOINTSV,PSOTLBL S (PSODWARN,PSOSIGNIF,PSOTLBL,PSOINTSV)=0
"RTN","PSODGDGP",36,0)
 S:$$DS^PSSDSAPI&(+$G(^TMP("PSODOSF",$J,0))) PSODWARN=1 ;dosing drug warning
"RTN","PSODGDGP",37,0)
 I $D(^TMP("PSOSER",$J,0)) S PSOINTSV=$G(^TMP("PSOSER",$J,0)) S:PSOINTSV[1 PSODWARN=1 S:PSOINTSV[2 PSOSIGNIF=1 ;critical and significant drug interaction drug warnings
"RTN","PSODGDGP",38,0)
 ;
"RTN","PSODGDGP",39,0)
 ; When verification is OFF and there's a significant drug interaction or the user doesn't hold the PSDRPH key,
"RTN","PSODGDGP",40,0)
 ; set file 52 "DRI" node for the significant drug interactions but don't quit.  When the verification switch is off, the bottle label and the tech warning 
"RTN","PSODGDGP",41,0)
 ; a tech warning label and the bottle label must print when significant interactions are present.  However if the
"RTN","PSODGDGP",42,0)
 ; the PSOX("NOPSDRPH") variable is defined, no labels are allowed to print and processing should continue on.
"RTN","PSODGDGP",43,0)
 ;
"RTN","PSODGDGP",44,0)
 I '$G(PSORX("VERIFY")),'PSODWARN&($G(PSOSIGNIF)) D  Q:'$D(PSOX("NOPSDRPH")) PSOTLBL  ;don't set 52.4 when verification is off and only significiant interaction
"RTN","PSODGDGP",45,0)
 .S $P(^PSRX(PSOXIRXN,"DRI"),"^")=^TMP("PSOSER",$J,0)
"RTN","PSODGDGP",46,0)
 .S $P(^PSRX(PSOXIRXN,"DRI"),"^",2)=^TMP("PSODGI",$J,0)
"RTN","PSODGDGP",47,0)
 .I '$P(PSOPAR,"^",2) S PSOTLBL=1
"RTN","PSODGDGP",48,0)
 ;
"RTN","PSODGDGP",49,0)
 ; If verification is ON, set file 52.4.  If there are critical drug interactions or dose warnings, the fields to 
"RTN","PSODGDGP",50,0)
 ; indicate these must be set and a tech warning label should print.  If the PSOX("NOPSDRPH") variable is present,
"RTN","PSODGDGP",51,0)
 ; file 52.4 should be set (along with any drug interaction and dose warning data) and the technician warning label
"RTN","PSODGDGP",52,0)
 ; should print (PSOTLBL=2)
"RTN","PSODGDGP",53,0)
 ;
"RTN","PSODGDGP",54,0)
 I ($D(PSOX("NOPSDRPH")))!($G(PSODWARN))!($G(PSORX("VERIFY"))) D
"RTN","PSODGDGP",55,0)
 .K DIC,DLAYGO,DINUM,DIADD,X,DD,DO S DIC="^PS(52.4,",DLAYGO=52.4,DINUM=PSOXIRXN,DIC(0)="ML",X=PSOXIRXN
"RTN","PSODGDGP",56,0)
 .D FILE^DICN K DD,DO,DIC,DLAYGO,DINUM S ^PS(52.4,PSOXIRXN,0)=PSOXIRXN_"^"_PSODFN_"^"_DUZ_"^"_"^"_$E(PSOX("LOGIN DATE"),1,7)_"^"_PSOXIRXN_"^"_PSOX("STOP DATE")
"RTN","PSODGDGP",57,0)
 .I '$D(PSOX("NOPSDRPH")) Q:PSOINTSV'[1&('PSODWARN)
"RTN","PSODGDGP",58,0)
 .D TECH
"RTN","PSODGDGP",59,0)
 ;
"RTN","PSODGDGP",60,0)
 I $D(^PS(52.4,PSOXIRXN)) K DIK,DA S DIK="^PS(52.4,",DA=PSOX("IRXN") D IX^DIK K DIK,DA
"RTN","PSODGDGP",61,0)
 I '$G(PSORX("VERIFY")) S:(PSOX("STATUS")=4!$G(PSODWARN)) PSOTLBL=1 ;verification off, dose warn or drug interaction, print technician warning label
"RTN","PSODGDGP",62,0)
 I $G(PSORX("VERIFY")) S PSOTLBL=$S('$G(PSODWARN)&('$G(PSOSIGNIF)):2,'$G(PSODWARN)&($G(PSOSIGNIF)):2,$G(PSODWARN):1,1:0)
"RTN","PSODGDGP",63,0)
 ;
"RTN","PSODGDGP",64,0)
 ; If the PSOX("NOPSDRPH") variable is present and regardless of the verification switch, labels cannot be 
"RTN","PSODGDGP",65,0)
 ; printed (i.e. PSOTLBL=2).  A technician warning label will be printed if drug interactions or dose warnings are 
"RTN","PSODGDGP",66,0)
 ; present.
"RTN","PSODGDGP",67,0)
 I $D(PSOX("NOPSDRPH")) S PSOTLBL=2
"RTN","PSODGDGP",68,0)
 Q PSOTLBL
"RTN","PSODGDGP",69,0)
 ;
"RTN","PSODGDGP",70,0)
BLD I $D(^XUSEC("PSORPH",DUZ)) D PHARM Q  ;*370
"RTN","PSODGDGP",71,0)
BLD2 ;
"RTN","PSODGDGP",72,0)
 Q:$P(ON,";")'="O"
"RTN","PSODGDGP",73,0)
 S LSI=$P(^PSRX($P(ON,";",2),0),"^")_"/"_$P(^PSDRUG($P(^PSRX($P(ON,";",2),0),"^",6),0),"^")_","_LSI
"RTN","PSODGDGP",74,0)
 I '$D(^TMP("PSODGI",$J,0)) D
"RTN","PSODGDGP",75,0)
 . S ^TMP("PSODGI",$J,0)=$P(ON,";",2)_","_$G(^TMP("PSODGI",$J,0)),^TMP("PSOSER",$J,0)=IT_","_$G(^TMP("PSOSER",$J,0))
"RTN","PSODGDGP",76,0)
 I ^TMP("PSODGI",$J,0)'[$P(ON,";",2) D
"RTN","PSODGDGP",77,0)
 .S ^TMP("PSODGI",$J,0)=$P(ON,";",2)_","_$G(^TMP("PSODGI",$J,0))
"RTN","PSODGDGP",78,0)
 .S ^TMP("PSOSER",$J,0)=IT_","_$G(^TMP("PSOSER",$J,0))
"RTN","PSODGDGP",79,0)
 I IT=2 S ^TMP("PSOSERS",$J,0)=IT_","_$G(^TMP("PSOSERS",$J,0)),^TMP("PSODGS",$J,0)=$P(ON,";",2)_","_$G(^TMP("PSODGS",$J,0))
"RTN","PSODGDGP",80,0)
 S:IT=1 ^TMP("PSOTDD",$J,1)=1
"RTN","PSODGDGP",81,0)
 Q
"RTN","PSODGDGP",82,0)
PHARM ;pharmacist verification of drug interaction
"RTN","PSODGDGP",83,0)
 S PSODGRLX=$P(ON,";",2)
"RTN","PSODGDGP",84,0)
 S DIR("?",1)="Answer 'YES' if you DO want to "_$S(IT=1:"continue processing",1:"enter an intervention for")_" this medication,"
"RTN","PSODGDGP",85,0)
 S DIR("?")="       'NO' if you DON'T want to "_$S(IT=1:"continue processing",1:"enter an intervention for")_" this medication,"
"RTN","PSODGDGP",86,0)
 W ! S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to "_$S(IT=1:"Continue? ",1:"Intervene? "),DIR("B")="Y" D ^DIR
"RTN","PSODGDGP",87,0)
 I 'Y,IT=1 S PSODLQT=1,DGI="" S:'$G(PSORXED)&('$G(PSOREINS)) PSORX("DFLG")=1 S:$G(PSORXED)!($G(PSOREINS)) PSOQUIT=1 K DIR,DTOUT,DIRUT,DIROUT,DUOUT Q
"RTN","PSODGDGP",88,0)
 I Y,IT=1 S PSORX("INTERVENE")=1,DGI="" K DIR,DTOUT,DIRUT,DIROUT,DUOUT G CRI Q
"RTN","PSODGDGP",89,0)
 I 'Y,IT=2 S:$G(DIRUT) (PSODLQT,PSOQUIT)=1 K DIR,DTOUT,DIRUT,DIROUT,DUOUT D ULRX Q
"RTN","PSODGDGP",90,0)
 I Y,IT=2 S PSORX("INTERVENE")=2,DGI="" K DIR,DTOUT,DIRUT,DIROUT,DUOUT
"RTN","PSODGDGP",91,0)
 D ULRX
"RTN","PSODGDGP",92,0)
 Q
"RTN","PSODGDGP",93,0)
CRI ;process new drug interactions entered by pharmacist
"RTN","PSODGDGP",94,0)
 K DIR ;G:$P(PSOSD(STA,DRG),"^",9) CRITN 
"RTN","PSODGDGP",95,0)
 S DIR("A",1)="",DIR("A",2)="Do you want to Process medication",DIR("A")=PSODRUG("NAME")_": ",DIR(0)="SA^1:PROCESS;0:ABORT ORDER ENTRY",DIR("B")="P"
"RTN","PSODGDGP",96,0)
 S DIR("?",1)="Enter '1' or 'P' to Process medication",DIR("?")="      '^' to EXIT",DIR("?",2)="      '0' or 'A' to Abort Order Entry process" D ^DIR K X1,DIR I 'Y S PSORX("DFLG")=1,DGI="" K DTOUT,DIRUT,DIROUT,DUOUT,PSORX("INTERVENE") D ULRX Q
"RTN","PSODGDGP",97,0)
 I IT=1 D
"RTN","PSODGDGP",98,0)
 .S PSORX("INTERVENE")=IT
"RTN","PSODGDGP",99,0)
 .D SIG^XUSESIG I X1="" K PSORX("INTERVENE") S PSORX("DFLG")=1 Q
"RTN","PSODGDGP",100,0)
 K DUOUT,DTOUT,DIRUT,DIROUT D ULRX Q
"RTN","PSODGDGP",101,0)
CRITN ;process multiple new drug interactions
"RTN","PSODGDGP",102,0)
 K X1,DIR S DIR("A",1)="",DIR("A",2)="Do you want to: ",DIR("A",3)=" 1.  Delete NEW medication "_PSODRUG("NAME"),DIR("A",4)=" 2.  Cancel ACTIVE New Rx #"_$P(^PSRX($P(ON,";",2),0),"^")_" DRUG: "_DRG
"RTN","PSODGDGP",103,0)
 S DIR("A",5)=" 3.  Delete 1 and Cancel 2",DIR("A")=" 4.  Continue ?: ",DIR(0)="SA^1:NEW MEDICATION;2:ACTIVE New Rx "_DRG_";3:BOTH;4:CONTINUE"
"RTN","PSODGDGP",104,0)
 S DIR("?",1)="Enter '1' or 'N' to Delete New Medication and Dispense Rx #"_$P(^PSRX($P(ON,";",2),0),"^")
"RTN","PSODGDGP",105,0)
 S DIR("?",2)="      '2' or 'A' to Cancel Active Rx #"_$P(^PSRX($P(ON,";",2),0),"^")_" and Dispense New Rx"
"RTN","PSODGDGP",106,0)
 S DIR("?",3)="      '3' or 'B' to Delete 1 and Cancel 2",DIR("?")="      '4' or 'C' to do nothing to either Rx" D ^DIR K DIR
"RTN","PSODGDGP",107,0)
 I Y=1 S PSORX("DFLG")=1,DGI="",PSHLDDRG=PSODRUG("IEN") D  D ULRX Q
"RTN","PSODGDGP",108,0)
 .I $G(PSORXED) D  Q
"RTN","PSODGDGP",109,0)
 ..D NOOR^PSOCAN4 I $D(DIRUT) W $C(7)," ACTION NOT TAKEN!",! S PSORX("DFLG")=1 K PSORX("INTERVENE") Q
"RTN","PSODGDGP",110,0)
 ..S DA=$P(ON,";",2) D MESS,ENQ^PSORXDL,FULL^VALM1
"RTN","PSODGDGP",111,0)
 ..K PSOSD($P(PSOLST($P(ON,";",2)),"^",3),PSODRUG("NAME")),DTOUT,DIROUT,DIRUT,DUOUT S:$G(PSOSD) PSOSD=PSOSD-1 S ZONE=1
"RTN","PSODGDGP",112,0)
 .S PSODRUG("IEN")=$P(^PSRX($P(ON,";",2),0),"^",6) D FULL^VALM1,^PSORXI
"RTN","PSODGDGP",113,0)
 .S PSODRUG("IEN")=PSHLDDRG,VALMBCK="R"
"RTN","PSODGDGP",114,0)
 .K DTOUT,DIRUT,DIROUT,DUOUT,PSHLDDRG
"RTN","PSODGDGP",115,0)
 .I $G(OR0) D
"RTN","PSODGDGP",116,0)
 ..D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGP",117,0)
 ...W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGP",118,0)
 ..D DC^PSOORFI2
"RTN","PSODGDGP",119,0)
 I Y=2 S (DA,PSOHOLDA)=$P(ON,";",2) D  D ULRX Q
"RTN","PSODGDGP",120,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGP",121,0)
 ..W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGP",122,0)
 .D MESS,ENQ^PSORXDL
"RTN","PSODGDGP",123,0)
 .S DA=PSOHOLDA D FULL^VALM1,EN1^PSORXI(.DA),PPL
"RTN","PSODGDGP",124,0)
 .K DTOUT,DIROUT,DIRUT,DUOUT,PSOHOLDA
"RTN","PSODGDGP",125,0)
 .S:$G(PSOSD) PSOSD=PSOSD-1 S VALMBCK="R"
"RTN","PSODGDGP",126,0)
 I Y=3 S (DA,PSOHOLDA)=$P(ON,";",2) D  S VALMBCK="R"
"RTN","PSODGDGP",127,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGP",128,0)
 ..W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGP",129,0)
 .S:$G(PSOSD) PSOSD=PSOSD-1 S PSORX("DFLG")=1 D MESS,ENQ^PSORXDL
"RTN","PSODGDGP",130,0)
 .I $G(OR0) D DC^PSOORFI2
"RTN","PSODGDGP",131,0)
 .S DA=PSOHOLDA D FULL^VALM1,EN1^PSORXI(.DA),PPL K PSOHOLDA
"RTN","PSODGDGP",132,0)
 .I $G(PSORXED) D
"RTN","PSODGDGP",133,0)
 ..S DA=$P(ON,";",2) D MESS,ENQ^PSORXDL,FULL^VALM1
"RTN","PSODGDGP",134,0)
 ..K DTOUT,DIROUT,DIRUT,DUOUT S:$G(PSOSD) PSOSD=PSOSD-1 S ZONE=1
"RTN","PSODGDGP",135,0)
 K DTOUT,DIROUT,DIRUT,DUOUT
"RTN","PSODGDGP",136,0)
 D ULRX
"RTN","PSODGDGP",137,0)
 Q
"RTN","PSODGDGP",138,0)
MESS W !!,"Canceling Rx: "_$P($G(^PSRX(DA,0)),"^")_"   "_"Drug: "_$P($G(^PSDRUG($P(^PSRX(DA,0),"^",6),0)),"^"),! Q
"RTN","PSODGDGP",139,0)
PPL F PSOSL=0:0 S PSOSL=$O(PSORX("PSOL",PSOSL)) Q:'PSOSL  S PSOX2=PSOSL
"RTN","PSODGDGP",140,0)
 I $G(PSOX2) D
"RTN","PSODGDGP",141,0)
 .F PSOSL=0:1:PSOX2 S PSOSL=$O(PSORX("PSOL",PSOSL)) Q:'PSOSL  F ENT=1:1:$L(PSORX("PSOL",PSOSL),",") I $P(PSORX("PSOL",PSOSL),",",ENT)=$P(ON,";",2) S PSOL(PSOSL,ENT)=""
"RTN","PSODGDGP",142,0)
 .F PSOL=0:0 S PSOL=$O(PSOL(PSOL)) Q:'PSOL  F ENT=0:0 S ENT=$O(PSOL(PSOL,ENT)) Q:'ENT  D
"RTN","PSODGDGP",143,0)
 ..I ENT=1,'$P(PSORX("PSOL",PSOL),",",2) K PSORX("PSOL",PSOL) Q
"RTN","PSODGDGP",144,0)
 ..I ENT=1,$P(PSORX("PSOL",PSOL),",",2) S PSORX("PSOL",PSOL)=$P(PSORX("PSOL",PSOL),",",2,99) Q
"RTN","PSODGDGP",145,0)
 ..S PSORX("PSOL",PSOL)=$P(PSORX("PSOL",PSOL),",",1,ENT-1)_","_$P(PSORX("PSOL",PSOL),",",ENT+1,99)
"RTN","PSODGDGP",146,0)
 K PSOX2,PSOSL,PSOL,ENT Q
"RTN","PSODGDGP",147,0)
ULRX ;
"RTN","PSODGDGP",148,0)
 I '$G(PSODGRLX) Q
"RTN","PSODGDGP",149,0)
 D PSOUL^PSSLOCK(PSODGRLX) K PSODGRLX
"RTN","PSODGDGP",150,0)
 Q
"RTN","PSOHLD")
0^6^B87531422^B80803768
"RTN","PSOHLD",1,0)
PSOHLD ;BIR/SAB - hold unhold functionality ; 7/23/09 1:16pm
"RTN","PSOHLD",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,16,21,24,27,32,55,82,114,130,166,148,268,281,298,358,353,385,386,370**;DEC 1997;Build 14
"RTN","PSOHLD",3,0)
 ;External reference to ^DD(52-DBIA 999,  VA(200-DBIA 224, NA^ORX1-DBIA 2186,
"RTN","PSOHLD",4,0)
 ; L, UL, PSOL, and PSOUL^PSSLOCK-DBIA 2789, ^%DTC-DBIA 10000, ^DIE-DBIA 10018, ^DIR-DBIA 10026,
"RTN","PSOHLD",5,0)
 ; ^DIK-DBIA 10013, ^VALM1-DBIA 10016, ^XUSEC(-DBIA 10076
"RTN","PSOHLD",6,0)
UHLD ; Rx Unhold
"RTN","PSOHLD",7,0)
 N REASON,RXIEN
"RTN","PSOHLD",8,0)
 I '$D(PSOPAR) D ^PSOLSET G:'$D(PSOPAR) EX
"RTN","PSOHLD",9,0)
 I $G(PSOBEDT) W $C(7),$C(7) S VALMSG="Invalid Action at this time !",VALMBCK="" Q
"RTN","PSOHLD",10,0)
 I $G(PSONACT) W $C(7),$C(7) S VALMSG="No Pharmacy Orderable Item !",VALMBCK="" Q
"RTN","PSOHLD",11,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSOHLD",12,0)
 K PSOPLCK D PSOL^PSSLOCK(DA) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG D ULP Q
"RTN","PSOHLD",13,0)
 S Y(0)=^PSRX(DA,0),STA=+$G(^("STA"))
"RTN","PSOHLD",14,0)
 I STA=16 S VALMSG="Placed on HOLD by Provider!" K Y,STA D PSOUL^PSSLOCK(DA) D ULP S VALMBCK="" Q
"RTN","PSOHLD",15,0)
 I STA'=3!(('$D(^XUSEC("PSORPH",DUZ)))&('$D(^XUSEC("PSO TECH ADV",DUZ)))) S VALMSG="Invalid Action Selection!",VALMBCK="" K Y,STA D PSOUL^PSSLOCK(DA) D ULP Q
"RTN","PSOHLD",16,0)
 S REASON=$$GET1^DIQ(52,DA,99,"I")
"RTN","PSOHLD",17,0)
 I ('$D(^XUSEC("PSORPH",DUZ))),",1,7,8,98,"'[(","_REASON_",") D  K Y,STA D PSOUL^PSSLOCK(DA) D ULP Q
"RTN","PSOHLD",18,0)
 . S VALMSG="The HOLD can only be removed by a pharmacist",VALMBCK=""
"RTN","PSOHLD",19,0)
 D FULL^VALM1 K DIR,DTOUT,DUOUT,DIRUT D NOOR I $D(DIRUT) D ULP G EX
"RTN","PSOHLD",20,0)
 I DT>$P(^PSRX(DA,2),"^",6) D  D ULP G EX
"RTN","PSOHLD",21,0)
 .S VALMSG="Medication Expired on "_$E($P(^PSRX(DA,2),"^",6),4,5)_"-"_$E($P(^(2),"^",6),6,7)_"-"_$E($P(^(2),"^",6),2,3) I $P(^PSRX(DA,"STA"),"^")<11 S $P(^PSRX(DA,"STA"),"^")=11
"RTN","PSOHLD",22,0)
 .S ^PSRX(DA,"H")="",COMM="Medication Expired on "_$E($P(^(2),"^",6),4,5)_"-"_$E($P(^(2),"^",6),6,7)_"-"_$E($P(^(2),"^",6),2,3) D EN^PSOHLSN1(DA,"SC","ZE",COMM,"") K COMM
"RTN","PSOHLD",23,0)
EN S RXF=0 F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S RXF=I,RSDT=$P(^(I,0),"^")
"RTN","PSOHLD",24,0)
 S RXIEN=DA
"RTN","PSOHLD",25,0)
 ; - Asking for UNHOLD Comments
"RTN","PSOHLD",26,0)
 N HLDCOM
"RTN","PSOHLD",27,0)
 S HLDCOM=$$GET1^DIQ(52,RXIEN,99.1)_" (REASON: "_$$GET1^DIQ(52,RXIEN,99)_") on "_$$GET1^DIQ(52,RXIEN,99.2)
"RTN","PSOHLD",28,0)
 W !!,"HOLD COMMENTS: " F I=1:1 Q:HLDCOM=""  W ?15,$E(HLDCOM,1,65),! S HLDCOM=$E(HLDCOM,66,999)
"RTN","PSOHLD",29,0)
 K DIR,DUOUT,DTOUT S DIR(0)="FO^3:200",DIR("A")="UNHOLD COMMENTS" D ^DIR I $D(DTOUT)!$D(DUOUT) D ULP G EX
"RTN","PSOHLD",30,0)
 S OTHCOM=X
"RTN","PSOHLD",31,0)
 ;
"RTN","PSOHLD",32,0)
 K Y I RXF D  I $D(Y) D ULP G EX
"RTN","PSOHLD",33,0)
 .N DA,DIE S DA(1)=RXIEN,DA=RXF,DIE="^PSRX("_DA(1)_",1,",PSOUNHLD=1
"RTN","PSOHLD",34,0)
 .S RLDT=$P(^PSRX(DA(1),1,DA,0),"^",18)
"RTN","PSOHLD",35,0)
 .I 'RLDT D
"RTN","PSOHLD",36,0)
 ..I RSDT<DT D  ;353 Do not display a past date for refill date'
"RTN","PSOHLD",37,0)
 ...N Y,TD S Y=DT X ^DD("DD") S TD=Y
"RTN","PSOHLD",38,0)
 ...S DR=".01R///^S X=TD"
"RTN","PSOHLD",39,0)
 ...D ^DIE
"RTN","PSOHLD",40,0)
 ..S DR=".01R;2"
"RTN","PSOHLD",41,0)
 ..D ^DIE
"RTN","PSOHLD",42,0)
 ..I $D(Y) D  ;User quit the UNHOLD process
"RTN","PSOHLD",43,0)
 ...I RSDT<DT D  ;reset refill date
"RTN","PSOHLD",44,0)
 ....N Y,TD S Y=RSDT X ^DD("DD") S TD=Y
"RTN","PSOHLD",45,0)
 ....S DR=".01R///^S X=TD"
"RTN","PSOHLD",46,0)
 ....D ^DIE
"RTN","PSOHLD",47,0)
 .S ZD(RXIEN)=$P(^PSRX(DA(1),1,DA,0),"^")
"RTN","PSOHLD",48,0)
 .K PSOUNHLD Q:$D(Y)  S PSORX("FILL DATE")=$P(^PSRX(DA(1),1,DA,0),"^"),DA=PSDA K DA(1)
"RTN","PSOHLD",49,0)
 ;
"RTN","PSOHLD",50,0)
 ;PSO*7*298 Require an entry into fill date
"RTN","PSOHLD",51,0)
 S ACT=1,DIE="^PSRX(",FDT=$S($P(^PSRX(RXIEN,2),"^",2):$P(^PSRX(RXIEN,2),"^",2),1:DT)
"RTN","PSOHLD",52,0)
 S RLDT=$P(^PSRX(RXIEN,2),"^",13),DR="",RLDTP1=$P(RLDT,".",1)
"RTN","PSOHLD",53,0)
 I 'RXF&'RLDT S DR="22R//^S X=FDT;11;Q;"
"RTN","PSOHLD",54,0)
 I RLDT&($P(^PSRX(RXIEN,2),"^",2)="") S DR="22R//^S X=RLDTP1;11;Q;"
"RTN","PSOHLD",55,0)
 S DR=DR_"100///0;101///^S X=$S(RXF:$G(ZD(RXIEN)),1:$P(^PSRX(RXIEN,2),""^"",2))"
"RTN","PSOHLD",56,0)
 ;
"RTN","PSOHLD",57,0)
 D ^DIE K FDT I $D(Y) S VALMBCK="R" D ULP G EX
"RTN","PSOHLD",58,0)
 ;
"RTN","PSOHLD",59,0)
 ; - Saving UNHOLD COMMENTS in the Refill REMARKS field.
"RTN","PSOHLD",60,0)
 I $G(OTHCOM)'="" D
"RTN","PSOHLD",61,0)
 . N DA,DIE,DR S DA(1)=RXIEN,DA=RXF,DIE="^PSRX("_DA(1)_",1,",DR="3///"_$E($TR(OTHCOM,";",","),1,60) D ^DIE
"RTN","PSOHLD",62,0)
 ; - Logging Rx Activity Log
"RTN","PSOHLD",63,0)
 D RXACT(RXIEN,"U",,$G(OTHCOM))
"RTN","PSOHLD",64,0)
 ; 
"RTN","PSOHLD",65,0)
 S COMM="Medication Removed from Hold by Pharmacy" D EN^PSOHLSN1(RXIEN,"OE","",COMM,PSONOOR) K COMM,PSONOOR
"RTN","PSOHLD",66,0)
 S PSORX("FILL DATE")=$S('RXF:$P(^PSRX(RXIEN,2),"^",2),1:ZD(RXIEN)) I $G(^PSRX(RXIEN,"H")) K ^PSRX("AH",$P(^PSRX(RXIEN,"H"),"^"),DA)
"RTN","PSOHLD",67,0)
 S ^PSRX(RXIEN,"H")=""
"RTN","PSOHLD",68,0)
 ;D ACT^PSOHLDA
"RTN","PSOHLD",69,0)
 S (NEW1,NEW11)="^^"
"RTN","PSOHLD",70,0)
 S (RXF,RXFL(RXIEN))=0 F JJ=0:0 S JJ=$O(^PSRX(RXIEN,1,JJ)) Q:'JJ  S (RXFL(RXIEN),RXF)=JJ
"RTN","PSOHLD",71,0)
 I $G(PSXSYS) D UNHOLD^PSOCMOPA I $G(XFLAG) D ULP G EX
"RTN","PSOHLD",72,0)
 I $G(RXIEN) D RELC I $G(PSOHRL) D ULP G EX
"RTN","PSOHLD",73,0)
 I PSORX("FILL DATE")>DT,$P(PSOPAR,"^",6) D S^PSORXL,EX,ULP Q
"RTN","PSOHLD",74,0)
 S PCOMH(RXIEN)="Medication Removed from Hold by Pharmacy"
"RTN","PSOHLD",75,0)
 I $G(RXIEN) S RXRH(RXIEN)=RXIEN
"RTN","PSOHLD",76,0)
 I $P($G(^PSRX(RXIEN,2)),"^",15)'="" S $P(^PSRX(RXIEN,2),"^",14)=1,RXRP(RXIEN)=1,$P(RXRP(RXIEN),"^",2)=$P($G(^PSRX(RXIEN,0)),"^",18) ; MARK PRESCRIPTION AND LABEL AS BEING REPRINTED WHEN UNHOLDING A RETURNED TO STOCK PRESCRIPTION
"RTN","PSOHLD",77,0)
 ;
"RTN","PSOHLD",78,0)
 ; - Submitting Rx to ECME
"RTN","PSOHLD",79,0)
 N ACTION
"RTN","PSOHLD",80,0)
 I $$SUBMIT^PSOBPSUT(RXIEN,+$G(RXFL(RXIEN))) D  I ACTION="Q"!(ACTION="^") D ULP G EX
"RTN","PSOHLD",81,0)
 . N RX,RFL S RX=RXIEN,RFL=+$G(RXFL(RXIEN))
"RTN","PSOHLD",82,0)
 . N DA S ACTION=""
"RTN","PSOHLD",83,0)
 . D ECMESND^PSOBPSU1(RX,RFL,,$S(RFL:"RF",1:"OF"))
"RTN","PSOHLD",84,0)
 . ; Quit if there is an unresolved TRICARE/CHAMPVA non-billable reject code, PSO*7*358
"RTN","PSOHLD",85,0)
 . I $$PSOET^PSOREJP3(RX,RFL) S ACTION="Q" Q
"RTN","PSOHLD",86,0)
 . I $$FIND^PSOREJUT(RX,RFL) D
"RTN","PSOHLD",87,0)
 . . S ACTION=$$HDLG^PSOREJU1(RX,RFL,"79,88","ED","IOQ","Q")
"RTN","PSOHLD",88,0)
 ;
"RTN","PSOHLD",89,0)
 I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=RXIEN_"," D ULP G EX
"RTN","PSOHLD",90,0)
 F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSOHLD",91,0)
 I $L(PSORX("PSOL",PSOX2))+$L(RXIEN)<220 S PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_RXIEN_","
"RTN","PSOHLD",92,0)
 E  S PSORX("PSOL",PSOX2+1)=RXIEN_","
"RTN","PSOHLD",93,0)
 ; 
"RTN","PSOHLD",94,0)
 D ULP
"RTN","PSOHLD",95,0)
EX D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) D ^PSOBUILD
"RTN","PSOHLD",96,0)
 K PSOHRL,PSOMSG,PSOPLCK,ST,PSL,PSNP,IR,NOW,DR,NEW1,NEW11,RTN,DA,PPL,RXN,RX0,RXS,DIK,RXP,FLD,ACT,DIE,DIC,DIR,DIE,X,Y,DIRUT,DUOUT,SUSPT,C,D0,LFD,I,RFDATE,DI,DQ,%,RFN,XFLAG
"RTN","PSOHLD",97,0)
 K HRX,PSHLD,PSOLIST,PSORX("FILL DATE"),STA,QTY,RFDT,PSORX0,PSRXN,RXF,JJ Q
"RTN","PSOHLD",98,0)
 ;
"RTN","PSOHLD",99,0)
HLD ;
"RTN","PSOHLD",100,0)
 I $G(PSOBEDT) W $C(7),$C(7) S VALMSG="Invalid Action at this time !",VALMBCK="" Q
"RTN","PSOHLD",101,0)
 I $G(PSONACT) W $C(7),$C(7) S VALMSG="No Pharmacy Orderable Item !",VALMBCK="" Q
"RTN","PSOHLD",102,0)
 I '$D(^XUSEC("PSORPH",DUZ))&'$D(^XUSEC("PSO TECH ADV",DUZ)) S VALMSG="Invalid Action Selection!",VALMBCK="" Q
"RTN","PSOHLD",103,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient."),VALMBCK="" K PSOPLCK Q
"RTN","PSOHLD",104,0)
 K PSOPLCK D PSOL^PSSLOCK(DA) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG D ULP Q
"RTN","PSOHLD",105,0)
 S Y(0)=^PSRX(DA,0),STA=+$G(^("STA")) I DT>$P(^PSRX(DA,2),"^",6) D  D ULP G D1
"RTN","PSOHLD",106,0)
 .S VALMSG="Medication Expired on "_$E($P(^PSRX(DA,2),"^",6),4,5)_"-"_$E($P(^(2),"^",6),6,7)_"-"_$E($P(^(2),"^",6),2,3),VALMBCK="R"
"RTN","PSOHLD",107,0)
 .I $P(^PSRX(DA,"STA"),"^")<11 S $P(^PSRX(DA,"STA"),"^")=11 D
"RTN","PSOHLD",108,0)
 ..S COMM="Medication Expired on "_$E($P(^PSRX(DA,2),"^",6),4,5)_"-"_$E($P(^(2),"^",6),6,7)_"-"_$E($P(^(2),"^",6),2,3) D EN^PSOHLSN1(DA,"SC","ZE",COMM) K COMM
"RTN","PSOHLD",109,0)
 S ST=$P("ERROR^ACTIVE^NON-VERIFIED^REFILL^HOLD^NON-VERIFIED^SUSPENDED^^^^^DONE^EXPIRED^DISCONTINUED^DELETED^DISCONTINUED^DISCONTINUED (EDIT)^PROVIDER HOLD^","^",STA+2)
"RTN","PSOHLD",110,0)
 I STA,STA'>4!(STA>11) D  D ULP G D1
"RTN","PSOHLD",111,0)
 .S VALMSG="Rx: "_$P(Y(0),"^")_" is currently in a status of "_ST,VALMBCK="R" K ST,Y Q
"RTN","PSOHLD",112,0)
 D FULL^VALM1 D NOOR I $D(DIRUT) D ULP G D1
"RTN","PSOHLD",113,0)
 D HLD^PSOCMOPA I $G(XFLAG) K XFLAG D ULP G D1
"RTN","PSOHLD",114,0)
 K DIR S DIR("A")=$P(^DD(52,99,0),"^"),DIR(0)="52,99"
"RTN","PSOHLD",115,0)
 ; A reduced set of HOLD REASON CODEs is available for Pharmacy Techs
"RTN","PSOHLD",116,0)
 I '$D(^XUSEC("PSORPH",DUZ)) D
"RTN","PSOHLD",117,0)
 . S DIR(0)="S^1:INSUFFICIENT QTY IN STOCK;7:BAD ADDRESS;8:PER PATIENT REQUEST;98:OTHER/TECH (NON-CLINICAL)"
"RTN","PSOHLD",118,0)
 . S DIR("L",1)="Enter reason medication is placed in a 'Hold' status."
"RTN","PSOHLD",119,0)
 . S DIR("L",2)="Choose from:"
"RTN","PSOHLD",120,0)
 . S DIR("L",3)="1        INSUFFICIENT QTY IN STOCK"
"RTN","PSOHLD",121,0)
 . S DIR("L",4)="7        BAD ADDRESS"
"RTN","PSOHLD",122,0)
 . S DIR("L",5)="8        PER PATIENT REQUEST"
"RTN","PSOHLD",123,0)
 . S DIR("L")="98       OTHER/TECH (NON-CLINICAL)"
"RTN","PSOHLD",124,0)
 ;
"RTN","PSOHLD",125,0)
 D ^DIR S FLD(99)=Y I $D(DUOUT)!($D(DIRUT)) K DIRUT,DUOUT,DIR D ULP G D1
"RTN","PSOHLD",126,0)
 I ($G(FLD(99))=98!($G(FLD(99))=99)) K DIR S DIR("A")=$P(^DD(52,99.1,0),"^"),DIR(0)="52,99.1" D ^DIR S FLD(99.1)=Y G AR
"RTN","PSOHLD",127,0)
 E  K DIR S DIR(0)="FO^10:100",DIR("A")="HOLD COMMENTS" D ^DIR S FLD(99.1)=Y
"RTN","PSOHLD",128,0)
AR I $D(DUOUT)!($D(DTOUT)) K DIRUT,DUOUT,DIR S VALMBCK="R" D ULP G D1
"RTN","PSOHLD",129,0)
 F PI=1:1 Q:$P(PPL,",",PI)=""  S DA=$P(PPL,",",PI) D H S DA=PSDA K PSDA D:$D(PSORX("PSOL")) RMP^PSOHLDA
"RTN","PSOHLD",130,0)
 K PI D ^PSOBUILD
"RTN","PSOHLD",131,0)
 D ULP
"RTN","PSOHLD",132,0)
D1 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) K PSOMSG,PSOPLCK,RFN,DIR,RSDT,FLD,DA,ACT,X,Y,DIRUT,DUOUT,DTOUT,DIROUT
"RTN","PSOHLD",133,0)
 Q
"RTN","PSOHLD",134,0)
 ;
"RTN","PSOHLD",135,0)
H ; - Rx HOLD update
"RTN","PSOHLD",136,0)
 D HOLD^PSOHLDA
"RTN","PSOHLD",137,0)
 Q
"RTN","PSOHLD",138,0)
 ;
"RTN","PSOHLD",139,0)
FLD N DA K DIR S DIR("A")=$P(^DD(52,99,0),"^"),DIR(0)="52,99" D
"RTN","PSOHLD",140,0)
 .; A reduced set of HOLD REASON CODEs is available for Pharmacy Techs  ;*370
"RTN","PSOHLD",141,0)
 .I $D(^XUSEC("PSORPH",DUZ)) Q
"RTN","PSOHLD",142,0)
 .S DIR(0)="S^1:INSUFFICIENT QTY IN STOCK;7:BAD ADDRESS;8:PER PATIENT REQUEST;98:OTHER/TECH (NON-CLINICAL)"
"RTN","PSOHLD",143,0)
 .S DIR("L",1)="Enter reason medication is placed in a 'Hold' status."
"RTN","PSOHLD",144,0)
 .S DIR("L",2)="Choose from:"
"RTN","PSOHLD",145,0)
 .S DIR("L",3)="1        INSUFFICIENT QTY IN STOCK"
"RTN","PSOHLD",146,0)
 .S DIR("L",4)="7        BAD ADDRESS"
"RTN","PSOHLD",147,0)
 .S DIR("L",5)="8        PER PATIENT REQUEST"
"RTN","PSOHLD",148,0)
 .S DIR("L")="98       OTHER/TECH (NON-CLINICAL)"
"RTN","PSOHLD",149,0)
 D ^DIR Q:$D(DUOUT)!($D(DIRUT))  S FLD(99)=Y
"RTN","PSOHLD",150,0)
 S COMM=Y(0)
"RTN","PSOHLD",151,0)
 I $G(FLD(99))=99 K DIR S DIR("A")=$P(^DD(52,99.1,0),"^"),DIR(0)="52,99.1" D ^DIR Q:$D(DUOUT)!($D(DIRUT))  S (FLD(99.1),COMM)=Y Q
"RTN","PSOHLD",152,0)
 E  S FLD(99.1)=""
"RTN","PSOHLD",153,0)
 Q
"RTN","PSOHLD",154,0)
NOOR ;ask nature of order
"RTN","PSOHLD",155,0)
 K DIR,DTOUT,DTOUT,DIRUT I $T(NA^ORX1)]""  D  Q
"RTN","PSOHLD",156,0)
 .S PSONOOR=$$NA^ORX1("W",0,"B","Nature of Order",0,"WPSDIVR"_$S(+$G(^VA(200,DUZ,"PS")):"E",1:""))
"RTN","PSOHLD",157,0)
 .I +PSONOOR S PSONOOR=$P(PSONOOR,"^",3) Q
"RTN","PSOHLD",158,0)
 .S DIRUT=1 K PSONOOR
"RTN","PSOHLD",159,0)
 S DIR("A")="Nature of Order: ",DIR("B")="WRITTEN"
"RTN","PSOHLD",160,0)
 S DIR(0)="SA^W:WRITTEN;V:VERBAL;P:TELEPHONE;S:SERVICE CORRECTED;D:DUPLICATE;I:POLICY;R:SERVICE REJECTED"_$S(+$G(^VA(200,DUZ,"PS")):";E:PROVIDER ENTERED",1:"")
"RTN","PSOHLD",161,0)
NOORX D ^DIR K DIR,DTOUT,DTOUT Q:$D(DIRUT)  S PSONOOR=Y
"RTN","PSOHLD",162,0)
 Q
"RTN","PSOHLD",163,0)
ULP ;
"RTN","PSOHLD",164,0)
 D UL^PSSLOCK(+$G(PSODFN))
"RTN","PSOHLD",165,0)
 Q
"RTN","PSOHLD",166,0)
RELC ;
"RTN","PSOHLD",167,0)
 S (PSOHRL,PSOHTX)=0  F PSOHT=0:0 S PSOHT=$O(^PSRX(DA,1,PSOHT)) Q:'PSOHT  S:$D(^PSRX(DA,1,PSOHT,0)) PSOHTX=PSOHT
"RTN","PSOHLD",168,0)
 I $G(PSOHTX) S PSOHRL=$S($P($G(^PSRX(DA,1,PSOHTX,0)),"^",18):1,1:0)
"RTN","PSOHLD",169,0)
 I '$G(PSOHTX) S PSOHRL=$S($P($G(^PSRX(DA,2)),"^",13):1,1:0)
"RTN","PSOHLD",170,0)
 K PSOHTX,PSOHT
"RTN","PSOHLD",171,0)
 Q
"RTN","PSOHLD",172,0)
RXACT(RX,ACTION,REASON,OTHCOM,SUS) ; Adds HOLD/UNHOLD comments to the Rx Activity Log
"RTN","PSOHLD",173,0)
 N RFL,X,DIC,DA,DD,DO,DR,DINUM,Y,DLAYGO,COMM
"RTN","PSOHLD",174,0)
 S RFL=$$LSTRFL^PSOBPSU1(RX)
"RTN","PSOHLD",175,0)
 I ACTION="H" S COMM="Rx placed on HOLD (Reason: "_REASON_")"_$S(+$G(SUS):" and removed from SUSPENSE",1:"")
"RTN","PSOHLD",176,0)
 I ACTION="U" S COMM="Rx removed from HOLD"
"RTN","PSOHLD",177,0)
 S DA(1)=RX,DIC="^PSRX("_RX_",""A"",",DLAYGO=52.3,DIC(0)="L" S:$G(OTHCOM)'="" OTHCOM=$TR(OTHCOM,";",","),COMM=COMM_" -"
"RTN","PSOHLD",178,0)
 S DIC("DR")=".02///"_ACTION_";.03////"_DUZ_";.04///"_$S((RFL>5):RFL+1,1:RFL)_";.05///"_COMM_$S($G(OTHCOM)'="":";4///"_OTHCOM,1:"")
"RTN","PSOHLD",179,0)
 S X=$$NOW^XLFDT() D FILE^DICN
"RTN","PSOHLD",180,0)
 Q
"RTN","PSOLLL1")
0^1^B74505234^B72285264
"RTN","PSOLLL1",1,0)
PSOLLL1 ;BIR/BHW - LASER LABELS ;10/24/2002
"RTN","PSOLLL1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**120,141,135,162,161,233,200,264,326,338,367,383,370**;DEC 1997;Build 14
"RTN","PSOLLL1",3,0)
 ;
"RTN","PSOLLL1",4,0)
 ;Reference to ^PSDRUG supported by DBIA 221
"RTN","PSOLLL1",5,0)
 ;Reference ^VA(200,D0,"PS" supported by DBIA 224
"RTN","PSOLLL1",6,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOLLL1",7,0)
 ;
"RTN","PSOLLL1",8,0)
ST I $P($G(^PSRX(RX,3)),"^",3) S PSOPROV=+$P(^(0),"^",4),PSOPROV=$S($G(RXP):+$P($G(RXP),"^",17),$G(RXF):+$P($G(^PSRX(RX,1,RXF,0)),"^",17),1:PSOPROV) S:'$G(PSOPROV) PSOPROV=+$P(^PSRX(RX,0),"^",4) D
"RTN","PSOLLL1",9,0)
 . I +$P($G(^VA(200,PSOPROV,"PS")),"^",7) S:'$P($G(PHYS),"/",2) PHYS=$G(PHYS)_"/"_$P($G(^VA(200,+$P($G(^PSRX(RX,3)),"^",3),0)),"^")
"RTN","PSOLLL1",10,0)
 S $P(ULN,"_",34)="",PSOTRAIL=1
"RTN","PSOLLL1",11,0)
 S (Y,X1)=EXPDT X ^DD("DD") S EXPDT=Y,Y=$P(^PSRX(RX,0),"^",13) X ^DD("DD") S ISD=Y,X2=DT D ^%DTC S DIFF=X
"RTN","PSOLLL1",12,0)
 S Y=DATE X ^DD("DD") S DATE=Y
"RTN","PSOLLL1",13,0)
 S TECH="("_$S($P($G(^PSRX(+$G(RX),"OR1")),"^",5):$P($G(^PSRX(+$G(RX),"OR1")),"^",5),1:$P(RXY,"^",16))_"/"_$S($G(VRPH)&($P(PSOPAR,"^",32)):VRPH,1:" ")_")"
"RTN","PSOLLL1",14,0)
 S PSZIP=$P(PS,"^",5),PSOHZIP=$S(PSZIP["-":PSZIP,1:$E(PSZIP,1,5)_$S($E(PSZIP,6,9)]"":"-"_$E(PSZIP,6,9),1:""))
"RTN","PSOLLL1",15,0)
L1 I $G(PSOIO("BLH"))]"" X PSOIO("BLH")
"RTN","PSOLLL1",16,0)
 I 'SIGF,'SIGM,'PMIM K PSOSTLK,ZTKDRUG I $L($T(PSOSTALK^PSOTALK1)) D PSOSTALK^PSOTALK1 D  S PSOSTLK=1 ; PRINT ONE SCRIPTALK LABEL IF APPLICABLE
"RTN","PSOLLL1",17,0)
 .D 6^VADPT,PID^VADPT6 S SSNPN=""
"RTN","PSOLLL1",18,0)
 S T="VAMC "_$P(PS,"^",7)_", "_STATE_" "_$G(PSOHZIP) S:SIGF!($G(FILLCONT)) T=" " D PRINT(T)
"RTN","PSOLLL1",19,0)
 S T=$P(PS2,"^",2)_"  "_TECH_"  Ph: "_$P(PS,"^",3)_"-"_$P(PS,"^",4) S:SIGF!($G(FILLCONT)) T=" " D PRINT(T)
"RTN","PSOLLL1",20,0)
 S PSDU=$P($G(^PSDRUG($P($G(^PSRX(RX,0)),"^",6),660)),"^",8)
"RTN","PSOLLL1",21,0)
 I $G(PSOIO("BLB"))]"" X PSOIO("BLB")
"RTN","PSOLLL1",22,0)
 S XFONT=$E(PSOFONT,2,99)
"RTN","PSOLLL1",23,0)
 S T="Rx# "_RXN_"  " S:SIGF!($G(FILLCONT)) T=" " D PRINT(T,1)
"RTN","PSOLLL1",24,0)
 D STRT^PSOLLU1("RX#",T,.L) S PSOY=PSOY-PSOYI,OPSOX=PSOX,PSOX=L(XFONT)*300+PSOX
"RTN","PSOLLL1",25,0)
 S DR=$G(SIGF("DR"))
"RTN","PSOLLL1",26,0)
 S T="  "_DATE_"  "_$S('SIGF:"Fill "_(RXF+1)_" of "_(1+$P(RXY,"^",9)),1:"(label continued)") S:SIGF!($G(FILLCONT)) T=" " D PRINT(T)
"RTN","PSOLLL1",27,0)
 S PSOX=OPSOX,T=PNM S:SIGF!($G(FILLCONT)) T=" " I T'=" " D PRINT(T,1)
"RTN","PSOLLL1",28,0)
 I DR>1 S PSOX=OPSOX,T="Rx# "_RXN_"  (label continued)" D PRINT(T)
"RTN","PSOLLL1",29,0)
 D STRT^PSOLLU1("SIG",T,.L)
"RTN","PSOLLL1",30,0)
 S OPSOX=PSOX,PSOX=L(XFONT)*300+PSOX,PSOY=PSOY-PSOYI,T="  "_$G(SSNPN) S:SIGF!($G(FILLCONT)) T=" " D PRINT(T)
"RTN","PSOLLL1",31,0)
 S PSOX=OPSOX,LENGTH=0,PTEXT="",SIGF=0,XFONT=$E(PSOFONT,2,99)
"RTN","PSOLLL1",32,0)
 N DP,TEXTP,TEXTL,MORE
"RTN","PSOLLL1",33,0)
 I 'SIGM,'$G(FILLCONT) D COUNTSG^PSOLLLW
"RTN","PSOLLL1",34,0)
 S DR=SIGF("DR")
"RTN","PSOLLL1",35,0)
 I DR>1,'$D(NSGY(DR,4)) D
"RTN","PSOLLL1",36,0)
 .F I=4:-1:1 Q:$D(NSGY(DR,I))  S T=" " D PRINT(T) ; BOTTOM-JUSTIFY CONTINUED BOTTLE SIG JUST ABOVE 'DISCARD' LINE
"RTN","PSOLLL1",37,0)
 F I=1:1 Q:'$D(NSGY(DR,I))  S TEXT=NSGY(DR,I) D PRINT(TEXT)
"RTN","PSOLLL1",38,0)
 I I>4,$D(NSGY(DR,5)) S SIGF=1,SIGF("DR")=DR+1
"RTN","PSOLLL1",39,0)
 I $G(PSOIO("BLF"))]"" X PSOIO("BLF")
"RTN","PSOLLL1",40,0)
 S PSOY=PSODY-PSOYI,PSOFONT=PSODFONT
"RTN","PSOLLL1",41,0)
 I SIGF G WARN:'SIGM&('$G(FILLCONT)),CONT
"RTN","PSOLLL1",42,0)
 I '$D(NSGY) G CONT
"RTN","PSOLLL1",43,0)
 K NSGY,^TMP($J,"PSOSIG",RX)
"RTN","PSOLLL1",44,0)
 D NOW^%DTC S X1=X,X2=365 D C^%DTC S Y=X X ^DD("DD")
"RTN","PSOLLL1",45,0)
 S DEA=$P($G(^PSDRUG($P(RXY,"^",6),0)),"^",3),T=""
"RTN","PSOLLL1",46,0)
 I DEA'["S" S T="Discard after "_$S(DEA[0!(DEA["M"):"_________",1:Y)_"__________   "
"RTN","PSOLLL1",47,0)
 S T=T_"Mfr_________" D PRINT(T)
"RTN","PSOLLL1",48,0)
 S PSOY=PSOY-5
"RTN","PSOLLL1",49,0)
 D  S PSOFONT="F8"  D PRINT(T)
"RTN","PSOLLL1",50,0)
 . S NOR=$P(RXY,"^",9)-RXF
"RTN","PSOLLL1",51,0)
 . I $P(RXY,"^",9)=0 S T="NO REFILL" Q
"RTN","PSOLLL1",52,0)
 . I NOR=0 S T="NO REFILLS LEFT" Q
"RTN","PSOLLL1",53,0)
 . S T="May refill "_NOR_"X by "_EXPDT
"RTN","PSOLLL1",54,0)
 S PPHYS=$G(PHYS)
"RTN","PSOLLL1",55,0)
 S XFONT=$E(PSOQFONT,2,99)
"RTN","PSOLLL1",56,0)
 S TEXT="Qty: " D STRT^PSOLLU1("SIG",TEXT,.L) S Q(1)=L(XFONT)
"RTN","PSOLLL1",57,0)
 S TEXT=" "_PSDU D STRT^PSOLLU1("SIG",TEXT,.L) S Q(2)=L(XFONT)
"RTN","PSOLLL1",58,0)
 S TEXT="       "_$G(PHYS) D STRT^PSOLLU1("SIG",TEXT,.L) S Q(3)=L(XFONT)
"RTN","PSOLLL1",59,0)
 S TEXT=$G(QTY) D STRT^PSOLLU1("SIG",TEXT,.L) S LENGTH=Q(1)+Q(2)+Q(3)+L(XFONT+2),Q(4)=L(XFONT+2)
"RTN","PSOLLL1",60,0)
 I LENGTH>3 F I=$L(PHYS)-1:-1:1 S PPHYS=$E(PHYS,1,I),TEXT="       "_PPHYS D STRT^PSOLLU1("SIG",TEXT,.L) I Q(1)+Q(2)+Q(4)+L(XFONT)<3.3 Q 
"RTN","PSOLLL1",61,0)
 S PSOFONT=PSOTFONT,OPSOX=PSOX,PSOX=PSOX+(Q(1)*300),PSOY=PSOQY-PSOYI,T=$G(QTY) D PRINT(T)
"RTN","PSOLLL1",62,0)
 S PSOX=OPSOX,PSOFONT=PSOQFONT,PSOY=PSOY-PSOYI,T="Qty: " D PRINT(T)
"RTN","PSOLLL1",63,0)
 S PSOX=PSOX+(Q(1)+Q(4)*300),PSOY=PSOY-PSOYI,T=" "_$G(PSDU)_"       "_$G(PPHYS) D PRINT(T)
"RTN","PSOLLL1",64,0)
 S PSOFONT=PSOTFONT,PSOX=OPSOX,PSOY=PSOTY-PSOYI,T=DRUG D STRT^PSOLLU1("SIG",T,.L)
"RTN","PSOLLL1",65,0)
 I L($E(PSOFONT,2,99))>3 S PSOFONT=$S(PSOFONT="F12":"F10",PSOFONT="F10":"F9",PSOFONT="F9":F8,PSOFONT="F8":"F6")
"RTN","PSOLLL1",66,0)
 S ZTKDRUG="XXXXXX   SCRIPTALK RX   XXXXXX"
"RTN","PSOLLL1",67,0)
 I $G(PSOSTLK) S T=$S($G(PSOSTALK):ZTKDRUG,1:DRUG)
"RTN","PSOLLL1",68,0)
 D PRINT(T,1)
"RTN","PSOLLL1",69,0)
 I SIGM G CONT
"RTN","PSOLLL1",70,0)
 S ^PSRX(RX,"TYPE")=0
"RTN","PSOLLL1",71,0)
WARN ;PRINT WARNING LABELS
"RTN","PSOLLL1",72,0)
 I $G(PSOIO("WLI"))]"" X PSOIO("WLI")
"RTN","PSOLLL1",73,0)
 ; IF <5 WARNINGS, PRINT LABELS BOTTOM-JUSTIFIED
"RTN","PSOLLL1",74,0)
 K PSOWLBL
"RTN","PSOLLL1",75,0)
 S PSOLAN=$P($G(^PS(55,DFN,"LAN")),"^",2)
"RTN","PSOLLL1",76,0)
 S WARN5=WARN F  Q:$L(WARN5,",")>4  S WARN5=" ,"_WARN5
"RTN","PSOLLL1",77,0)
 F WWW=1:1:5 S PSOWARN=$P(WARN5,",",WWW) I PSOWARN'="" D
"RTN","PSOLLL1",78,0)
 . I PSOWARN["N" D NEWWARN^PSOLLLW Q
"RTN","PSOLLL1",79,0)
 . D WARN54^PSOLLLW
"RTN","PSOLLL1",80,0)
 ;RETURN MAIL
"RTN","PSOLLL1",81,0)
 S PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:"") I $P(PSOSYS,"^",4),$D(^PS(59,+$P($G(PSOSYS),"^",4),0)) S PS=^PS(59,$P($G(PSOSYS),"^",4),0)
"RTN","PSOLLL1",82,0)
 S VAADDR1=$P(PS,"^"),VASTREET=$P(PS,"^",2),STATE=$S($D(^DIC(5,+$P(PS,"^",8),0)):$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOLLL1",83,0)
 S PSZIP=$P(PS,"^",5),PSOHZIP=$S(PSZIP["-":PSZIP,1:$E(PSZIP,1,5)_$S($E(PSZIP,6,9)]"":"-"_$E(PSZIP,6,9),1:""))
"RTN","PSOLLL1",84,0)
 I $G(PSOIO("RMI"))]"" X PSOIO("RMI")
"RTN","PSOLLL1",85,0)
 S PSOYI=$G(PSOHYI,40),OFONT=PSOFONT,PSOFONT=$G(PSOHFONT)
"RTN","PSOLLL1",86,0)
 S BLNKLIN="",$P(BLNKLIN," ",40)=" "
"RTN","PSOLLL1",87,0)
 S T="Attn: (119)"_BLNKLIN_$$FMTE^XLFDT(DT) D PRINT(T,0)
"RTN","PSOLLL1",88,0)
 S T=$G(VASTREET) D PRINT(T,0)
"RTN","PSOLLL1",89,0)
 S T=$P(PS,"^",7)_", "_$G(STATE)_"  "_$G(PSOHZIP) D PRINT(T,0)
"RTN","PSOLLL1",90,0)
 S PSOY=PSOY+PSOYI,T=$S(PS55=2:"***DO NOT MAIL***",1:"") I T'="" D PRINT(T,0)
"RTN","PSOLLL1",91,0)
 I T'="***DO NOT MAIL***" S T=$S(PS55[0!(PS55[3)!(PS55=""):"",1:"CERTIFIED MAIL-") S T=T_$G(MAILCOM) S:$L(T)>25 PSOFONT="F8" D PRINT(T,0)
"RTN","PSOLLL1",92,0)
 S PSOFONT=OFONT
"RTN","PSOLLL1",93,0)
 S T=PNM
"RTN","PSOLLL1",94,0)
 S PSOY=PSOY+PSOYI,PSOYI=PSORYI D PRINT(T,0)
"RTN","PSOLLL1",95,0)
 I $G(VAPA(1))=""!(PS55=2) G W
"RTN","PSOLLL1",96,0)
 ; ADD CHECK FOR BAD ADDRESS INDICATOR OR FOREIGN ADDRESS
"RTN","PSOLLL1",97,0)
 N PSOBADR,PSOTEMP,PSOFORGN,I
"RTN","PSOLLL1",98,0)
 S PSOBADR=0,PSOTEMP=0
"RTN","PSOLLL1",99,0)
 S PSOFORGN=$P($G(VAPA(25)),"^",2)
"RTN","PSOLLL1",100,0)
 I PSOFORGN'="" D  ;*370
"RTN","PSOLLL1",101,0)
 . N PSOFOREN S PSOFOREN=1
"RTN","PSOLLL1",102,0)
 . I PSOFORGN["UNITED STATES",$P(PS,"^")'["MANILA" S PSOFOREN=0
"RTN","PSOLLL1",103,0)
 . I PSOFORGN["PHILIPPINES",$P(PS,"^")["MANILA" S PSOFOREN=0
"RTN","PSOLLL1",104,0)
 . S PSOFORGN=PSOFOREN
"RTN","PSOLLL1",105,0)
 I 'PSOFORGN S PSOBADR=$$BADADR^DGUTL3(DFN)
"RTN","PSOLLL1",106,0)
 I 'PSOFORGN,PSOBADR S PSOTEMP=$$CHKTEMP^PSOBAI(DFN)
"RTN","PSOLLL1",107,0)
 F I=1:1:3 I $G(VAPA(I))]"" D
"RTN","PSOLLL1",108,0)
 . S T="" I I=1,'PSOFORGN,PSOBADR,'$G(PSOTEMP) S T="** BAD ADDRESS INDICATED **"
"RTN","PSOLLL1",109,0)
 . I I=1,T="",PSOFORGN S T="*** FOREIGN ADDRESS ***"
"RTN","PSOLLL1",110,0)
 . I T="" I 'PSOFORGN I 'PSOBADR!$G(PSOTEMP) S T=$G(VAPA(I))
"RTN","PSOLLL1",111,0)
 . D STRT^PSOLLU1("ML",T,.L) I L($E(PSOFONT,2,99))<2.37 D PRINT(T,0) Q
"RTN","PSOLLL1",112,0)
 . F F=12,10,9,8,6 I L(F)<2.37 S OFONT=PSOFONT,PSOFONT="F"_F D PRINT(T,0) S PSOFONT=OFONT Q
"RTN","PSOLLL1",113,0)
 S A=+$G(VAPA(5)) I A S A=$S($D(^DIC(5,A,0)):$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOLLL1",114,0)
 S T="" I 'PSOFORGN I 'PSOBADR!$G(PSOTEMP) S T=$G(VAPA(4))_", "_A_"  "_$S($G(VAPA(11)):$P(VAPA(11),"^",2),1:$G(VAPA(6)))
"RTN","PSOLLL1",115,0)
 D PRINT(T,0)
"RTN","PSOLLL1",116,0)
W ;
"RTN","PSOLLL1",117,0)
 S T=$S(MW="WINDOW":"WINDOW -",1:"MAIL -")
"RTN","PSOLLL1",118,0)
 N XFONT
"RTN","PSOLLL1",119,0)
 S OFONT=PSOFONT,PSOYI=$G(PSOTYI,40),PSOFONT=PSOTFONT,XFONT=$E(PSOFONT,2,99),PSOY=PSOTY
"RTN","PSOLLL1",120,0)
 I T["WINDOW" D
"RTN","PSOLLL1",121,0)
 . I $G(^PSRX(RX,"MP"))'="" S PSOY=PSOY-PSOYI ; START 1 LINE HIGHER IF METHOD OF PICK-UP
"RTN","PSOLLL1",122,0)
 . S OPSOX=PSOX D PRINT(T,1) S PSOX=PSOX+200,PSOY=PSOY-PSOYI
"RTN","PSOLLL1",123,0)
 . S T=$G(^PSRX(RX,"MP")) I T="" S PSOFONT=OFONT,PSOX=OPSOX Q
"RTN","PSOLLL1",124,0)
 . N FIRST
"RTN","PSOLLL1",125,0)
 . S FIRST=1
"RTN","PSOLLL1",126,0)
 . D STRT^PSOLLU1("ML",T,.L)
"RTN","PSOLLL1",127,0)
 . I L(XFONT)<1.75 D PRINT(T,0) S PSOFONT=OFONT,PSOX=OPSOX Q
"RTN","PSOLLL1",128,0)
 . F F=10,9,8,6 I L(F)<4.5 Q
"RTN","PSOLLL1",129,0)
 . S XFONT=F,PSOFONT="F"_F,PSOYI=$S(PSOFONT="F12":40,PSOFONT="F10":35,PSOFONT="F9":30,PSOFONT="F8":25,1:20)
"RTN","PSOLLL1",130,0)
 . F J=$L(T," "):-1:1 S PTEXT=$P(T," ",1,J) D STRT^PSOLLU1("ML",PTEXT,.L) D  Q:T=""
"RTN","PSOLLL1",131,0)
 .. I FIRST I L(XFONT)<1.75 D PRINT(PTEXT,0) S T=$P(T," ",J+1,512),J=$L(T," ")+1,PTEXT="",FIRST=0,PSOX=OPSOX,PSOY=PSOY+20 Q
"RTN","PSOLLL1",132,0)
 .. I 'FIRST I L(XFONT)<2.3 D PRINT(PTEXT,0) S T=$P(T," ",J+1,512),J=$L(T," ")+1,PTEXT=""
"RTN","PSOLLL1",133,0)
 . D:PTEXT]"" PRINT(PTEXT,0)
"RTN","PSOLLL1",134,0)
 I T="MAIL -" D PRINT(T,1)
"RTN","PSOLLL1",135,0)
 S PSOFONT=OFONT
"RTN","PSOLLL1",136,0)
CONT I $G(SIDE) G BARC:'L5,CONT2
"RTN","PSOLLL1",137,0)
 I $G(COPIES)>1 G BARC
"RTN","PSOLLL1",138,0)
 I 'L2!PFM D ^PSOLLL2 S L2=1
"RTN","PSOLLL1",139,0)
 I 'L3 D ^PSOLLL3 S L3=1
"RTN","PSOLLL1",140,0)
 I 'L4!PMIM S PIMI=0 D ^PSOLLL4 S L4=1
"RTN","PSOLLL1",141,0)
 I L5 W @IOF G CONT2
"RTN","PSOLLL1",142,0)
BARC I $G(BOTTLBL) G BARCE ; ONLY PRINT BARCODE ON 1ST BOTTLE LABEL
"RTN","PSOLLL1",143,0)
 S BOTTLBL=1
"RTN","PSOLLL1",144,0)
 I $G(PSOIO("BLBC"))]"" X PSOIO("BLBC") I $G(NOBARC) G BARCE
"RTN","PSOLLL1",145,0)
 S X2=PSOINST_"-"_RX W X2
"RTN","PSOLLL1",146,0)
 I $G(PSOIO("EBLBC"))]"" X PSOIO("EBLBC")
"RTN","PSOLLL1",147,0)
BARCE W @IOF
"RTN","PSOLLL1",148,0)
COPY I SIGF S SIGM=1 G L1 ; NEED TO FINISH PRINTING CONTINUED BOTTLE LABEL
"RTN","PSOLLL1",149,0)
 S FILLCONT=0 I PFM!PMIM S FILLCONT=1 G L1
"RTN","PSOLLL1",150,0)
 I $G(COPIES)>1 D  G L1
"RTN","PSOLLL1",151,0)
 . S COPIES=COPIES-1
"RTN","PSOLLL1",152,0)
 . S (SIGM,PFM,PMIM,L2,L3,L4,L5,BOTTLBL)=0
"RTN","PSOLLL1",153,0)
 . K SIGF,PFF,PMIF S (SIGF,PFF,PMIF)=0 F I="DR","T" S (SIGF(I),PFF(I))=1
"RTN","PSOLLL1",154,0)
 . F I="A","B","I" S PMIF(I)=1
"RTN","PSOLLL1",155,0)
 S IR=0 F FDA=0:0 S FDA=$O(^PSRX(RX,"L",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOLLL1",156,0)
 S IR=IR+1,^PSRX(RX,"L",0)="^52.032DA^"_IR_"^"_IR
"RTN","PSOLLL1",157,0)
 S ^PSRX(RX,"L",IR,0)=PSOFNOW_"^"_$S($G(RXP):99-RXPI,1:RXF)_"^"_$S($G(PCOMX)]"":$G(PCOMX),$G(PCOMH(RX))]"":PCOMH(RX),1:"From RX number "_$P(^PSRX(RX,0),"^"))_$S($G(RXP):" (Partial)",1:"")_$S($D(REPRINT):" (Reprint)",1:"")_"^"_PDUZ
"RTN","PSOLLL1",158,0)
 ;
"RTN","PSOLLL1",159,0)
 ;Storing FDA Medication Guide filename in the Prescription file
"RTN","PSOLLL1",160,0)
 I $$MGONFILE^PSOFDAUT(RX) D
"RTN","PSOLLL1",161,0)
 . I $G(RXRP(RX)),'$G(RXRP(RX,"MG")) Q
"RTN","PSOLLL1",162,0)
 . S ^PSRX(RX,"L",IR,"FDA")=$P($$MGONFILE^PSOFDAUT(RX),"^",2)
"RTN","PSOLLL1",163,0)
 ;
"RTN","PSOLLL1",164,0)
 N PSOBADR,PSOTEMP
"RTN","PSOLLL1",165,0)
 S PSOBADR=$$CHKRX^PSOBAI(RX)
"RTN","PSOLLL1",166,0)
 I $G(PSOBADR) S PSOTEMP=$P(PSOBADR,"^",2),PSOBADR=$P(PSOBADR,"^")
"RTN","PSOLLL1",167,0)
 I $G(PSOBADR),'$G(PSOTEMP) D
"RTN","PSOLLL1",168,0)
 .S IR=IR+1,^PSRX(RX,"L",0)="^52.032DA^"_IR_"^"_IR
"RTN","PSOLLL1",169,0)
 .S ^PSRX(RX,"L",IR,0)=PSOFNOW_"^"_$S($G(RXP):99-RXPI,1:RXF)_"^"_"ROUTING="_$G(MW)_" (BAD ADDRESS)"_"^"_PDUZ
"RTN","PSOLLL1",170,0)
 S L5=1
"RTN","PSOLLL1",171,0)
CONT2 I SIGF S SIGM=1 G L1 ; MORE BOTTLE LABEL SIG TO PRINT
"RTN","PSOLLL1",172,0)
 I PMIM G CONT ; MORE PMI INFO TO PRINT
"RTN","PSOLLL1",173,0)
 I $G(PSOBLALL)=1,$P(PPL,",",PI+1)="" D TRAIL
"RTN","PSOLLL1",174,0)
 Q
"RTN","PSOLLL1",175,0)
PRINT(T,B) ;
"RTN","PSOLLL1",176,0)
 S BOLD=$G(B)
"RTN","PSOLLL1",177,0)
 I 'BOLD,$G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT)
"RTN","PSOLLL1",178,0)
 I BOLD,$G(PSOIO(PSOFONT_"B"))]"" X PSOIO(PSOFONT_"B")
"RTN","PSOLLL1",179,0)
 I $G(PSOIO("ST"))]"" X PSOIO("ST")
"RTN","PSOLLL1",180,0)
 W T,!
"RTN","PSOLLL1",181,0)
 I $G(PSOIO("ET"))]"" X PSOIO("ET")
"RTN","PSOLLL1",182,0)
 I BOLD,$G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT) ;TURN OFF BOLDING
"RTN","PSOLLL1",183,0)
 Q
"RTN","PSOLLL1",184,0)
TRAIL I $G(SIDE) G END
"RTN","PSOLLL1",185,0)
 D ^PSOLLL5
"RTN","PSOLLL1",186,0)
 D ^PSOLLLH
"RTN","PSOLLL1",187,0)
 D ^PSOLLL6
"RTN","PSOLLL1",188,0)
 I '$P($G(^PS(59,PSOSITE,1)),"^",18) Q
"RTN","PSOLLL1",189,0)
 I '$G(REPRINT) D ^PSOLLL7
"RTN","PSOLLL1",190,0)
END I '$P(PSOPAR,"^",31) Q
"RTN","PSOLLL1",191,0)
 W @IOF
"RTN","PSOLLL1",192,0)
 I $G(PSOIO("PMII"))]"" X PSOIO("PMII")
"RTN","PSOLLL1",193,0)
 I $G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT)
"RTN","PSOLLL1",194,0)
 S T="NEXT PATIENT"
"RTN","PSOLLL1",195,0)
 S PSOX=1100-(L($E(PSOFONT,2,99))*300/2)
"RTN","PSOLLL1",196,0)
 I $G(PSOIO("ST"))]"" X PSOIO("ST")
"RTN","PSOLLL1",197,0)
 W T,!
"RTN","PSOLLL1",198,0)
 I $G(PSOIO("ET"))]"" X PSOIO("ET")
"RTN","PSOLLL1",199,0)
 Q
"RTN","PSOLLL1",200,0)
 ;
"RTN","PSORXED1")
0^4^B22048628^B21189403
"RTN","PSORXED1",1,0)
PSORXED1 ;BHAM ISC/SAB - Edit prescription utility #2 ; 02/18/98  3:16 PM
"RTN","PSORXED1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**2,16,21,289,370**;DEC 1997;Build 14
"RTN","PSORXED1",3,0)
 ;show edits on last refill
"RTN","PSORXED1",4,0)
 F ZDL=0:0 S ZDL=$O(^PSRX(DA,1,ZDL)) Q:'ZDL  S:$P($G(^PSRX(DA,1,ZDL,0)),"^") ZD(DA)=$P($G(^PSRX(DA,1,ZDL,0)),"^")
"RTN","PSORXED1",5,0)
 G:'$O(^PSRX(DA,1,0))!($G(^PSRX(DA,1,RFED,0))']"") SUS S (PSRX1,RX1)=PSORXED("RX1"),QTY=$P(RX1,"^",4),QTY=QTY-$P(^PSRX(DA,1,RFED,0),"^",4)
"RTN","PSORXED1",6,0)
 S COM1="" F I=1:1:6,9:1:11,17 I $P(PSRX1,"^",I)'=$P(^PSRX(DA,1,RFED,0),"^",I) D
"RTN","PSORXED1",7,0)
 .S PSI=$S(I=1:.01,I=4:1,I=5:4,I=6:5,I=9:8,I=10:1.1,I=11:1.2,I=17:15,1:I)
"RTN","PSORXED1",8,0)
 .I I'=1 S COM1=COM1_$P(^DD(52.1,PSI,0),"^")_" ("_$P(PSRX1,"^",I)_")," Q  ;*370
"RTN","PSORXED1",9,0)
 .N DTT,DAT S DTT=$P(PSRX1,"^",I) D DAT^PSOORAL1 S COM1=COM1_$P(^DD(52.1,PSI,0),"^")_" ("_DAT_"),"  ;*370
"RTN","PSORXED1",10,0)
 .Q
"RTN","PSORXED1",11,0)
 ;
"RTN","PSORXED1",12,0)
 N PSOTRIC,PSOECMES,PSOERFL S (PSOTRIC,PSOERFL,PSOECMES)="",PSOERFL=$$LSTRFL^PSOBPSU1(DA),PSOECMES=$$FIND^PSOREJUT(DA,PSOERFL)
"RTN","PSORXED1",13,0)
 S PSOTRIC="",PSOTRIC=$$TRIC^PSOREJP1(DA,PSOERFL,.PSOTRIC)
"RTN","PSORXED1",14,0)
 I COM1=""&('$G(PSOTRIC)) K COM1 G SUS
"RTN","PSORXED1",15,0)
 I COM1=""&($G(PSOTRIC)) G:'PSOECMES SKPTRIC I PSOECMES K COM1 G SUS
"RTN","PSORXED1",16,0)
 ;
"RTN","PSORXED1",17,0)
 S K=1,D1=0 F Z=0:0 S Z=$O(^PSRX(DA,"A",Z)) Q:'Z  S D1=Z,K=K+1
"RTN","PSORXED1",18,0)
 S D1=D1+1 S:'($D(^PSRX(DA,"A",0))#2) ^(0)="^52.3DA^^^" S ^(0)=$P(^(0),"^",1,2)_"^"_D1_"^"_K
"RTN","PSORXED1",19,0)
 S ^PSRX(DA,"A",D1,0)=DT_"^E^"_DUZ_"^"_$S(RFED'<0&(RFED<6):RFED,1:(RFED+1))_"^"_COM1
"RTN","PSORXED1",20,0)
SKPTRIC ;
"RTN","PSORXED1",21,0)
 I QTY,$P(^PSRX(DA,1,RFED,0),"^",18) S ^PSDRUG($P(^PSRX(DA,0),"^",6),660.1)=$S($D(^PSDRUG(+$P(^PSRX(DA,0),"^",6),660.1)):^(660.1)+QTY,1:QTY)
"RTN","PSORXED1",22,0)
 G:RFD'=RFED EX
"RTN","PSORXED1",23,0)
 D FILL^PSORXED S PSOEDITL=$S($G(PSOEDITF)'=$G(RFED):1,$G(PSOEDITF)=$G(RFED)&('$G(PSOEDITR)):0,1:2)
"RTN","PSORXED1",24,0)
 I $G(PSOTRIC)&(PSOECMES) S PSOEDITL=0 G SUS
"RTN","PSORXED1",25,0)
 I $G(PSOEDITL)=2,'$G(RXRP(DA)),$P($G(^PSRX(DA,"STA")),"^")'=5,'$G(PSOSIGFL) D ASKL^PSORXED
"RTN","PSORXED1",26,0)
 G:+$P(^PSRX(DA,"STA"),"^")!($G(PSOEDITL)=1&('$G(PSOTRIC))) SUS I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=PSORXED("IRXN")_"," S RXFL(DA)=RFED D SETRP^PSORXED G SUS
"RTN","PSORXED1",27,0)
 F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSORXED1",28,0)
 I $L(PSORX("PSOL",PSOX2))+$L(PSORXED("IRXN"))<220 D  G ELSE
"RTN","PSORXED1",29,0)
 .I PSORX("PSOL",PSOX2)'[PSORXED("IRXN")_"," S PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_PSORXED("IRXN")_"," D SETRP^PSORXED
"RTN","PSORXED1",30,0)
 E  I PSORX("PSOL",PSOX2)'[PSORXED("IRXN")_"," S PSORX("PSOL",PSOX2+1)=PSORXED("IRXN")_"," D SETRP^PSORXED
"RTN","PSORXED1",31,0)
ELSE S RXFL(DA)=RFED
"RTN","PSORXED1",32,0)
 K COM1
"RTN","PSORXED1",33,0)
SUS ;update suspense file
"RTN","PSORXED1",34,0)
 K PSOEDITF,PSOEDITR,PSOEDITL
"RTN","PSORXED1",35,0)
 S RXS=$O(^PS(52.5,"B",DA,0)) I RXS,$G(^PS(52.5,RXS,"P"))=1 S ZD=$P(^PSRX(DA,3),"^") Q
"RTN","PSORXED1",36,0)
 G:'RXS EX
"RTN","PSORXED1",37,0)
 N PSOSITE I RFDT,$G(^PSRX(DA,1,RFED,0))]"",RFDT'=+$G(^PSRX(DA,1,RFED,0))!($P(PSORXED("RX1"),"^",9)'=$P(^(0),"^",9)) S SD=$P(^PSRX(DA,1,RFED,0),"^"),PSOSITE=$P(^(0),"^",9) D SUP Q
"RTN","PSORXED1",38,0)
 I 'RFED,$P(PSORXED("RX2"),"^",2)'=$P(^PSRX(DA,2),"^",2)!($P(PSORXED("RX2"),"^",9)'=$P(^(2),"^",9)) S SD=$P(^PSRX(DA,2),"^",2),PSOSITE=$P(^(2),"^",9) D SUP
"RTN","PSORXED1",39,0)
EX K COM1,DIK,K,PSORXED("RX1"),RX1,RXS,SD,IR,FDA,RXN,RFDT,COPIES,J,PSPOP,COM,RX0,RX2,D1,IOP,%,%Y,D0,DA,D1
"RTN","PSORXED1",40,0)
 K DIC,DIE,DIG,DQ,DR,DRUG,I,II,N,PHYS,PS,QTY,RFDATE,RFL,RFL1,RXF,SIG,ST,ST0,Z,Z0,Z1,X,Y,ZDL
"RTN","PSORXED1",41,0)
 Q
"RTN","PSORXED1",42,0)
SUP I $P($G(^PS(52.5,RXS,0)),"^",7)="Q" D SUS^PSOCMOPB Q
"RTN","PSORXED1",43,0)
 S RXN=DA,RX0=^PSRX(DA,0),DA=RXS,DIK="^PS(52.5," D ^DIK S DA=RXN
"RTN","PSORXED1",44,0)
 S DIC="^PS(52.5,",DIC(0)="L",X=RXN,DLAYGO=52.5
"RTN","PSORXED1",45,0)
 S DIC("DR")=".02///"_SD_";.03////"_$P(^PSRX(DA,0),"^",2)_";.04///M;.05///0;.06////"_PSOSITE_";2///0" K DD,DO D FILE^DICN I +$G(Y),$G(RFED)'="" S $P(^PS(52.5,+Y,0),"^",13)=$G(RFED)
"RTN","PSORXED1",46,0)
 S IR=0,DA=RXN F FDA=0:0 S FDA=$O(^PSRX(DA,"A",FDA)) Q:'FDA  S IR=FDA
"RTN","PSORXED1",47,0)
 S IR=IR+1,^PSRX(DA,"A",0)="^52.3DA^"_IR_"^"_IR
"RTN","PSORXED1",48,0)
 D NOW^%DTC S ^PSRX(DA,"A",IR,0)=%_"^E^"_DUZ_"^"_$S(RFED'<0&(RFED<6):RFED,1:(RFED+1))_"^RX Placed on Suspense until "_$E(SD,4,5)_"-"_$E(SD,6,7)_"-"_$E(SD,2,3)
"RTN","PSORXED1",49,0)
 W !,"RX# "_$P(RX0,"^")_" has been Suspended until "_$E(SD,4,5)_"-"_$E(SD,6,7)_"-"_$E(SD,2,3)_".",!
"RTN","PSORXED1",50,0)
 Q
"RTN","PSORXED1",51,0)
 ;
"RTN","PSORXED1",52,0)
DIE W !,"Now Editing Rx # ",$P(PSORXED("RX0"),"^") K DIE,DA,DIC,DR S DIE="^PSRX(",DA=PSORXED("IRXN")
"RTN","PSORXED1",53,0)
 S DR="1;22R;3;Q;4;5"_$S($P(PSOPAR,"^",3):";6",1:"")_";6.5:8;Q;17;9:10;10.6;11;"_$S($P(PSOPAR,"^",12):"35;",1:"")_"12;20" S:RFD DR=DR_";52" S DR=DR_";23;24",DR(2,52.1)=".01:5;8;15"
"RTN","PSORXED1",54,0)
 D ^DIE K DIE,DR,DA,X,Y L -^PSRX(PSORXED("IRXN")) I RFD,$G(^PSRX(PSORXED("IRXN"),1,RFD,0))]"" D
"RTN","PSORXED1",55,0)
 .S:$P(PSORXED("RX1"),"^",17)'=$P(^PSRX(PSORXED("IRXN"),1,RFD,0),"^",17) PSONEW("PROVIDER NAME")=$P(^VA(200,$P(^PSRX(PSORXED("IRXN"),1,RFD,0),"^",17),0),"^")
"RTN","PSORXED1",56,0)
 D EN1^PSONEW2(.PSORXED) I PSORXED("DFLG") S PSORXED("QFLG")=1 G DIEX
"RTN","PSORXED1",57,0)
 G:'PSORXED("QFLG") DIE S PSORXED("QFLG")=0
"RTN","PSORXED1",58,0)
DIEX Q
"RTN","PSORXL")
0^7^B124759619^B123167297
"RTN","PSORXL",1,0)
PSORXL ;BHAM ISC/SAB - action to be taken on prescriptions ;10/15/08 2:12pm
"RTN","PSORXL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**8,21,24,32,47,135,148,287,334,251,354,367,370**;DEC 1997;Build 14
"RTN","PSORXL",3,0)
 ;External reference to File #50 supported by DBIA 221
"RTN","PSORXL",4,0)
 ;External references CHPUS^IBACUS and TRI^IBACUS supported by DBIA 2030
"RTN","PSORXL",5,0)
 I $G(PSOTRVV),$G(PPL) S PSORX("PSOL",1)=PPL K PPL
"RTN","PSORXL",6,0)
 N SLBL,PSOSONE,PSOKLRXS,PSOSKIP S PSOSKIP=1
"RTN","PSORXL",7,0)
 S:'$G(PPL) PPL=$G(PSORX("PSOL",1)) G:$P(PSOPAR,"^",26) P
"RTN","PSORXL",8,0)
LBL ;
"RTN","PSORXL",9,0)
 I $G(PPL) N PSOCKDC S PSOCKDC=1 D ECME^PSORXL1 I '$G(PPL) S PPL="" G RXSQUIT  ;*334 ;don't prompt to print labels for DC'ed Rx's
"RTN","PSORXL",10,0)
 W !! S DIR("A",1)="Label Printer: "_$S($G(SUSPT):PSLION,1:$G(PSOLAP))
"RTN","PSORXL",11,0)
 I $$GET1^DIQ(59,PSOSITE,134)'="" D
"RTN","PSORXL",12,0)
 . I $G(PSOFDAPT)="" S PSOFDAPT=$$DEFPRT^PSOFDAUT(PSOSITE)
"RTN","PSORXL",13,0)
 . S DIR("A",2)="FDA Med Guide Printer: "_$S($G(PSOFDAPT)="":"HOME",1:$P(PSOFDAPT,"^"))
"RTN","PSORXL",14,0)
 S DIR("A")="LABEL: QUEUE/CHANGE PRINTER"_$S($P(PSOPAR,"^",23)&($D(^XUSEC("PSORPH",DUZ))!($D(^XUSEC("PSO TECH ADV",DUZ)))):"/HOLD",1:"")_$S($P(PSOPAR,"^",24):"/SUSPEND",1:"")_$S($P(PSOPAR,"^",26):"/LABEL",1:"")_" or '^' to bypass "
"RTN","PSORXL",15,0)
 S DIR("?",1)="Enter 'Q' to queue labels to print",DIR("?")="Enter '^' to bypass label functions",DIR("?",4)="Enter 'S' to suspend labels to print later"
"RTN","PSORXL",16,0)
 S DIR("?",2)="Enter 'H' to hold label until Rx can be filled",DIR("?",3)="Enter 'P' for Rx profile"
"RTN","PSORXL",17,0)
 S DIR("?",5)="Enter 'C' to select another label printer"
"RTN","PSORXL",18,0)
 S:$P(PSOPAR,"^",26) DIR("?",5)="Enter 'L' to print labels without queuing"
"RTN","PSORXL",19,0)
TRI ;Tricare
"RTN","PSORXL",20,0)
 S X="IBACUS" X ^%ZOSF("TEST") K X I '$T G PASS
"RTN","PSORXL",21,0)
 I '$$TRI^IBACUS() G PASS
"RTN","PSORXL",22,0)
 I '$D(PSORX("PSOL",1))!($G(PSOSUREP))!($G(PSOEXREP)) G PASS
"RTN","PSORXL",23,0)
 N GGG,PBILL,PSTRD,PSTRDZ,PSTRF,PSTRP,TRXI,TRIRX,PSTRIVAR,VV,VVV,VVCT
"RTN","PSORXL",24,0)
 D DEV^PSOCPTRI
"RTN","PSORXL",25,0)
 K ^TMP($J,"PSONOB"),^TMP($J,"PSOBILL")
"RTN","PSORXL",26,0)
 S VVCT=0 F VV=0:0 S VV=$O(PSORX("PSOL",VV)) Q:'VV  F VVV=1:1 S TRXI=$P(PSORX("PSOL",VV),",",VVV) Q:'TRXI  D
"RTN","PSORXL",27,0)
 .I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSORXL",28,0)
 .I $P($G(^PSRX(+TRXI,"STA")),"^")=3 Q
"RTN","PSORXL",29,0)
 .S PSTRP=$P($G(^PSRX(+TRXI,0)),"^",2),PSTRD=+$G(PSOSITE),PSTRDZ=+$G(DUZ)
"RTN","PSORXL",30,0)
 .S PSTRF=0 F GGG=0:0 S GGG=$O(^PSRX(+TRXI,1,GGG)) Q:'GGG  S PSTRF=GGG
"RTN","PSORXL",31,0)
 .S VVCT=VVCT+1
"RTN","PSORXL",32,0)
 .I $G(RXRP(TRXI))!($G(RXPR(TRXI)))!($G(RXRH(TRXI))) S ^TMP($J,"PSONOB",VVCT)=TRXI Q
"RTN","PSORXL",33,0)
 .S PBILL=$$CHPUS^IBACUS(PSTRP,DT,TRXI,PSTRF,PSOLAP,PSTRD,PSTRDZ) S ^TMP($J,$S($G(PBILL):"PSOBILL",1:"PSONOB"),VVCT)=TRXI
"RTN","PSORXL",34,0)
 I '$D(^TMP($J,"PSOBILL")) K ^TMP($J,"PSONOB") G PASS
"RTN","PSORXL",35,0)
 I '$D(^TMP($J,"PSONOB")),$D(^TMP($J,"PSOBILL")) S (Y,LBL)="H" G H1
"RTN","PSORXL",36,0)
 ;If some Rx's are billable, and some are not
"RTN","PSORXL",37,0)
SETP K PSORX("PSOL"),PPL S VVCT=1 F VV=0:0 S VV=$O(^TMP($J,$S($G(PSTRIVAR):"PSONOB",1:"PSOBILL"),VV)) Q:'VV  S TRIRX=^TMP($J,$S($G(PSTRIVAR):"PSONOB",1:"PSOBILL"),VV) I +TRIRX D
"RTN","PSORXL",38,0)
 .I $G(PSORX("PSOL",1))="" S PSORX("PSOL",1)=TRIRX_"," Q
"RTN","PSORXL",39,0)
 .I $L(PSORX("PSOL",VVCT))+$L(TRIRX)<220 S PSORX("PSOL",VVCT)=PSORX("PSOL",VVCT)_TRIRX_"," Q
"RTN","PSORXL",40,0)
 .S VVCT=VVCT+1 S PSORX("PSOL",VVCT)=TRIRX_","
"RTN","PSORXL",41,0)
 I '$G(PSTRIVAR) S (Y,LBL)="H" S PSOKLRXS=1 K PSORSAVE,PSOPSAVE,PSOHSAVE D RSAVE D H1 D RREST K PSORSAVE,PSOPSAVE,PSOHSAVE K PSOKLRXS S PSTRIVAR=1 G SETP
"RTN","PSORXL",42,0)
 K ^TMP($J,"PSONOB") S PPL=$G(PSORX("PSOL",1))
"RTN","PSORXL",43,0)
PASS ;
"RTN","PSORXL",44,0)
 I $E($G(DIR("A")),1,6)'="LABEL:" D RESDIR^PSOCPTRI
"RTN","PSORXL",45,0)
 S DIR(0)="SA^P:PROFILE;Q:QUEUE;C:CHANGE PRINTER"_$S($P(PSOPAR,"^",23)&($D(^XUSEC("PSORPH",DUZ))!($D(^XUSEC("PSO TECH ADV",DUZ)))):";H:HOLD",1:"")
"RTN","PSORXL",46,0)
 S DIR(0)=DIR(0)_$S($P(PSOPAR,"^",24):";S:SUSPENSE",1:"")_$S($P(PSOPAR,"^",26):";L:PRINT",1:""),DIR("B")="Q" D ^DIR D  G:$D(DIRUT)!($D(DUOUT)) EX  ;*370
"RTN","PSORXL",47,0)
 .I $D(DIRUT)!($D(DUOUT)) D AL^PSOLBL("UT") I $G(PSOEXREP) S PSOEXREX=1
"RTN","PSORXL",48,0)
 .I $G(PSOPULL) I $D(DIRUT)!($D(DUOUT)) S PSOQFLAG=1
"RTN","PSORXL",49,0)
 S:$G(PSOBEDT) NOPP=Y
"RTN","PSORXL",50,0)
 I $G(Y)="C" K PSOCLBL,%ZIS("B") S PSOCLBL=1 D @$S('$D(PSOPAR):"^PSOLSET",1:"PLBL^PSOLSET") K PSOCLBL G LBL
"RTN","PSORXL",51,0)
 I $G(Y)="Q",$D(RXRS),'$G(PSOPULL) D PPLADD^PSOSUPOE
"RTN","PSORXL",52,0)
 I $G(PSXSYS),($G(Y)'="H"),($G(Y)'="P"),('$G(PSOEXREP)) S LBL=Y,(RXLTOP,PPL1)=1 S:'$G(PSOPULL) SLBL=Y D A^PSOCMOP G:'$G(PPL) D1
"RTN","PSORXL",53,0)
 K DIR S LBL=Y S:'$G(PSOPULL) SLBL=Y G Q:Y="Q",S:Y="S",H1:Y="H",P:Y="L" I Y="P" W ! S PSDFN=DFN,PSFROM="" D ^PSODSPL K PSDFN,PSFROM G LBL
"RTN","PSORXL",54,0)
EX I $D(DUOUT)!$D(DIRUT) K BINGCRT,BINGRTE,BBRX,BBFLG S:$D(RXRS) SLBL="^" G:$D(RXRS) RXS K DIR,X,DIRUT,DUOUT,ACT,Y,DTOUT,PPL,REPRINT S NOBG=1 G RXSQUIT  ;*334
"RTN","PSORXL",55,0)
Q S PPL1=1 G:$G(PPL)']"" D1 S PSNP=0,PSL=1 D  I $G(PSOFROM)="NEW",$P(PSOPAR,"^",8) S PSNP=1
"RTN","PSORXL",56,0)
 .Q:'$P(PSOPAR,"^",8)!($G(PSONOPRT))
"RTN","PSORXL",57,0)
 .F SLPPL=0:0 S SLPPL=$O(RXRS(SLPPL)) Q:'SLPPL!($G(PSNP))  I '$O(^PSRX(SLPPL,1,0)),'$D(RXPR(SLPPL)) S PSNP=1
"RTN","PSORXL",58,0)
 I $G(PSOLAP)]"",$G(PSOLAP)'=ION G Q2
"RTN","PSORXL",59,0)
Q1 W ! K POP S %ZIS("B")="",%ZIS="MNQ",%ZIS("A")="Select LABEL DEVICE: " D ^%ZIS S PSLION=ION K %ZIS("A")
"RTN","PSORXL",60,0)
 G:$G(POP)&($G(PSPARTXX)) RXSQUIT G:$G(POP)&($G(PSOSONE)) RXSQ D:$G(POP)&($G(PSONOPRT))
"RTN","PSORXL",61,0)
 .S PSOQFLAG=1
"RTN","PSORXL",62,0)
 G:$G(PSOQFLAG) RXSQUIT G:POP!(IO=IO(0)) LBL S PSOLAP=ION  ;*334
"RTN","PSORXL",63,0)
 N PSOIOS S PSOIOS=IOS D DEVBAR^PSOBMST
"RTN","PSORXL",64,0)
 S PSOBARS=PSOBAR1]""&(PSOBAR0]"")&$P(PSOPAR,"^",10)
"RTN","PSORXL",65,0)
 D ^%ZISC S PSL=0
"RTN","PSORXL",66,0)
Q2 ; Checking FDA Med Guide printer
"RTN","PSORXL",67,0)
 I ($$GET1^DIQ(59,PSOSITE,134)="")!($G(PSOEXREP)&'$G(PSOMGREP))!'$$FDARX(PPL)!($G(PSOSKIP)&($G(PSOFDAPT)'="")) G QLBL
"RTN","PSORXL",68,0)
 I $G(PSOEXREP),'$G(PSOMGREP) G QLBL
"RTN","PSORXL",69,0)
 N FDAPRT S FDAPRT=""
"RTN","PSORXL",70,0)
 F  D  Q:FDAPRT'=""!(FDAPRT="^")
"RTN","PSORXL",71,0)
 . S FDAPRT=$$SELPRT^PSOFDAUT($P($G(PSOFDAPT),"^"))
"RTN","PSORXL",72,0)
 . I FDAPRT="" W $C(7),!,"You must select a valid FDA Medication Guide printer."
"RTN","PSORXL",73,0)
 I FDAPRT="^"!(FDAPRT="") G LBL
"RTN","PSORXL",74,0)
 S PSOFDAPT=FDAPRT
"RTN","PSORXL",75,0)
 ;
"RTN","PSORXL",76,0)
QLBL I $G(PSXSYS),('$G(RXLTOP)),('$G(PSOEXREP)) D RXL^PSOCMOP G:'$G(PPL) D1
"RTN","PSORXL",77,0)
 ;
"RTN","PSORXL",78,0)
 ;- Submitting list of Rx to ECME for DUR/79 REJECT check and possible submission to 3rd Pary Payer
"RTN","PSORXL",79,0)
 D ECME^PSORXL1 I '$G(PPL) W !!,"No Label(s) printed.",!! S PSOQFLAG=1 G RXSQUIT  ;*334
"RTN","PSORXL",80,0)
 ;
"RTN","PSORXL",81,0)
 S ZTRTN="DQ^PSOLBL",ZTIO=$S($G(SUSPT):PSLION,1:PSOLAP),ZTDTH=$S($G(PSOTIME):PSOTIME,1:$H),PDUZ=DUZ,OPAIO=ZTIO
"RTN","PSORXL",82,0)
 S ZTDESC="Outpatient Pharmacy "_$S($G(SUSPT):"SUSPENSE ",$G(DG):"DRUG INTERACTION ",1:"")_"LABELS OUTPUT ROUTINE"
"RTN","PSORXL",83,0)
 F G="PPL1","PSOSYS","DFN","PSOPAR","PDUZ","PCOMX",$S($G(SUSPT):"PFION",1:"PSOLAP"),"PPL" S:$D(@G) ZTSAVE(G)=""
"RTN","PSORXL",84,0)
 F G="RXY","PSOSITE","COPIES","SIDE","PSOSUSPR","PSOBARS","PSOBAR1","PSOBAR0","PSODELE" S:$D(@G) ZTSAVE(G)=""
"RTN","PSORXL",85,0)
 F G="PSOPULL","PSTAT","PSODBQ","PSOEXREP","PSOTREP","PSOFDAPT","PSOMGREP" S:$D(@G) ZTSAVE(G)=""
"RTN","PSORXL",86,0)
 S ZTSAVE("PSORX(")="",ZTSAVE("RXRP(")="",ZTSAVE("RXPR(")="",ZTSAVE("RXRS(")="",ZTSAVE("RXFL(")="",ZTSAVE("PCOMH(")=""
"RTN","PSORXL",87,0)
 D ^%ZISC,^%ZTLOAD K:$G(PSOSONE) RXRS
"RTN","PSORXL",88,0)
 I $D(ZTSK)&('$G(SUSPT))&('$G(PSOEXREP)) D
"RTN","PSORXL",89,0)
 . W !!,"LABEL(S) QUEUED TO PRINT",!!
"RTN","PSORXL",90,0)
 . D OPAI
"RTN","PSORXL",91,0)
 K OPAIO
"RTN","PSORXL",92,0)
 G:$G(PSPARTXX) RXSQUIT K G,PDUZ K:'$G(SUSPT) ZTSK G:$G(DG) RXSQUIT  ;*334
"RTN","PSORXL",93,0)
 G:'$G(PSNP) QUEUP G:$G(PSOPRFLG) QUEUP S HOLDRPAS=$G(PSOPRPAS),PSOPRPAS=$P(PSOPAR,"^",13)
"RTN","PSORXL",94,0)
PLBL S PSOION=ION
"RTN","PSORXL",95,0)
 I '$D(PSOPROP)!($G(PSOPROP)=ION) W $C(7),!,"PROFILES MUST BE SENT TO PRINTER !!",! K IOP,%ZIS,IO("Q"),POP S %ZIS="MNQ",%ZIS("A")="Select PROFILE DEVICE: " D ^%ZIS K %ZIS("A") G:POP QUEUP G:$E(IOST)["C"!(PSOION=ION) PLBL S PSOPROP=ION
"RTN","PSORXL",96,0)
QPRF S ZTRTN="DQ^PSOPRF",ZTIO=PSOPROP,ZTDESC="Outpatient Pharmacy "_$S($G(SUSPT):"SUSPENSE ",1:"")_"PATIENT PROFILES",ZTDTH=$S($G(PSOTIME):PSOTIME,1:$H)
"RTN","PSORXL",97,0)
 F G="PSOPAR","PSODTCUT","PSOPRPAS","DFN","PSOSITE","NEW1","NEW11","PSOBMST","PFIO","PPL" S:$D(@G) ZTSAVE(G)=""
"RTN","PSORXL",98,0)
 D ^%ZTLOAD W:$D(ZTSK)&('$G(SUSPT))&('$G(PSOEXREP)) !,"PROFILE IS QUEUED TO PRINT",!! K G K:'$G(SUSPT) ZTSK D ^%ZISC
"RTN","PSORXL",99,0)
QUEUP D:$G(POP)&($G(PSONOPRT))  G:$G(PSOQFLAG) RXSQUIT S PSNP=0,PSOPRPAS=$G(HOLDRPAS) K:PSOPRPAS']"" PSOPRPAS K HOLDRPAS G D1  ;*334
"RTN","PSORXL",100,0)
 .S PSOQFLAG=1
"RTN","PSORXL",101,0)
 Q
"RTN","PSORXL",102,0)
 ;
"RTN","PSORXL",103,0)
S G S^PSORXL1
"RTN","PSORXL",104,0)
SUS S X="IBACUS" X ^%ZOSF("TEST") K X I '$T G SUSL1
"RTN","PSORXL",105,0)
 N TRIDA S TRIDA=DA I '$$TRI^IBACUS() S DA=TRIDA G SUSL1
"RTN","PSORXL",106,0)
 I $G(RXRP(TRIDA))!($G(RXPR(TRIDA)))!($G(RXRH(TRIDA))) S DA=TRIDA G SUSL1
"RTN","PSORXL",107,0)
 N PBILL,PSTRD,PSTRDZ,PSTRF,PSTRP,GGG
"RTN","PSORXL",108,0)
 D DEV^PSOCPTRI
"RTN","PSORXL",109,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSORXL",110,0)
 S PSTRP=$P($G(^PSRX(+TRIDA,0)),"^",2),PSTRD=+$G(PSOSITE),PSTRDZ=+$G(DUZ)
"RTN","PSORXL",111,0)
 S PSTRF=0 F GGG=0:0 S GGG=$O(^PSRX(+TRIDA,1,GGG)) Q:'GGG  S PSTRF=GGG
"RTN","PSORXL",112,0)
 S PBILL=$$CHPUS^IBACUS(PSTRP,DT,TRIDA,PSTRF,PSOLAP,PSTRD,PSTRDZ)
"RTN","PSORXL",113,0)
 I '$G(PBILL) S DA=TRIDA G SUSL1
"RTN","PSORXL",114,0)
 S FLD(99)="99",FLD(99.1)="Awaiting CHAMPUS billing approval"
"RTN","PSORXL",115,0)
 N RSDT,ACT,PSUS,RXF,RFN,I,PSDA,NOW,IR,FDA
"RTN","PSORXL",116,0)
 S DA=TRIDA D H^PSOCPTRH
"RTN","PSORXL",117,0)
 Q
"RTN","PSORXL",118,0)
SUSL1 G SUS^PSORXL1
"RTN","PSORXL",119,0)
H1 S PPL1=1 S:'$G(PPL) PPL=$G(PSORX("PSOL",PPL1))
"RTN","PSORXL",120,0)
 D:'$D(^TMP($J,"PSOBILL")) NOOR^PSOHLD I $D(DIRUT) K DIRUT G PSORXL
"RTN","PSORXL",121,0)
 I $D(^TMP($J,"PSOBILL")) S FLD(99)="99",FLD(99.1)="Awaiting CHAMPUS billing approval" G H
"RTN","PSORXL",122,0)
 G:$G(PPL)']"" D1 D FLD^PSOHLD I $D(DUOUT)!($D(DIRUT)) K DIRUT,DUOUT,FLD,DIR G LBL
"RTN","PSORXL",123,0)
H K SPPL G:$D(DTOUT) D1 S SPPL="" F PI=1:1 Q:$P(PPL,",",PI)=""  D
"RTN","PSORXL",124,0)
 .S DA=$P(PPL,",",PI) I $P(^PSRX(DA,"STA"),"^")<10,$P(^("STA"),"^")'=4 D @$S($D(^TMP($J,"PSOBILL")):"H^PSOCPTRH",1:"H^PSOHLD") Q
"RTN","PSORXL",125,0)
 .I $P(^PSRX(DA,"STA"),"^")=4 S SPPL=SPPL_DA_"," Q
"RTN","PSORXL",126,0)
 I $G(SPPL)]"" D
"RTN","PSORXL",127,0)
 .W !!,$C(7),"Drug Interaction Rx(s) " F I=1:1 Q:$P(SPPL,",",I)=""  W $P(^PSRX($P(SPPL,",",I),0),"^")_", "
"RTN","PSORXL",128,0)
 .S PPL=SPPL,DG=1 D Q K DG,SPPL
"RTN","PSORXL",129,0)
D1 K RXLTOP I $G(PPL1),$O(PSORX("PSOL",$G(PPL1))) S PPL1=$O(PSORX("PSOL",PPL1)),PPL=PSORX("PSOL",PPL1) G @$S(LBL="H":"H",LBL="L":"P1",1:"QLBL")
"RTN","PSORXL",130,0)
RXS I $D(RXRS),'$G(PSOKLRXS) I $G(SLBL)="H"!($G(SLBL)="S")!($G(SLBL)="^")!($G(SLBL)="") D  G:$G(PPL)'="" Q
"RTN","PSORXL",131,0)
 .K PPL,PSORX("PSOL") S PSOSONE=1 D PPLADD^PSOSUPOE
"RTN","PSORXL",132,0)
 .Q:$G(PPL)=""  W !!,"You have selected the following Rx(s) to be pulled from suspense:",!
"RTN","PSORXL",133,0)
 .F RXSS=0:0 S RXSS=$O(RXRS(RXSS)) Q:'RXSS  W !," Rx # ",$P($G(^PSRX(+$G(RXSS),0)),"^"),?23,$P($G(^PSDRUG(+$P($G(^PSRX(+$G(RXSS),0)),"^",6),0)),"^")
"RTN","PSORXL",134,0)
 .K DIR W ! S DIR(0)="Y",DIR("B")="YES",DIR("A")="Do you still want to pull these Rx(s) from suspense" D ^DIR K DIR I Y'=1 W !!,"Rx(s) will remain in Suspense!",! D RESET^PSOSUPOE K RXRS,PPL
"RTN","PSORXL",135,0)
RXSQUIT K:'$G(PSOKLRXS) RXRS K ^TMP($J,"PSOBILL"),RXPR,RXRP,RXRH,RXSS,LBL,PPL1,PPL,DIR,%DT,%,SD,COUNT,EXDT,L,PDUZ,REF,REPRINT,RFDATE,RFL1,RFLL,RXN,WARN,ZY,FLD,PI,ZD,ACT,X,Y,DIRUT,DUOUT,DTOUT,DIROUT Q  ;*334 ADDED TAG NAME
"RTN","PSORXL",136,0)
P S PPL1=1 S:'$G(PPL) PPL=$G(PSORX("PSOL",1)) G:$G(PPL)']"" D1
"RTN","PSORXL",137,0)
 I $G(PSOLAP)']"" W ! K POP,ZTSK S %ZIS="M",%ZIS("A")="Select LABEL DEVICE: " D ^%ZIS K %ZIS("A") G:POP LBL S PSOLAP=ION
"RTN","PSORXL",138,0)
 S IOP=PSOLAP D ^%ZIS
"RTN","PSORXL",139,0)
 N PSOIOS S PSOIOS=IOS D DEVBAR^PSOBMST
"RTN","PSORXL",140,0)
P1 S PSOBARS=PSOBAR1]""&(PSOBAR0]"")&$P(PSOPAR,"^",10),PDUZ=DUZ D DQ1^PSOLBL,^%ZISC
"RTN","PSORXL",141,0)
 G:'$P(PSOPAR,"^",8)!(+$G(REPRINT))!($G(PSOFROM)'="NEW") D1 I $G(PSOPROP)']"" S PSOION=ION,%ZIS="M",%ZIS("A")="Select PROFILE DEVICE: " D ^%ZIS K %ZIS("A") G:POP D1 S PSOPROP=ION
"RTN","PSORXL",142,0)
 S IOP=PSOPROP D ^%ZIS D DQ^PSOPRF,^%ZISC G D1
"RTN","PSORXL",143,0)
 Q
"RTN","PSORXL",144,0)
RXSQ K RXRS G RXS
"RTN","PSORXL",145,0)
 Q
"RTN","PSORXL",146,0)
FDARX(PPL) ; Check if any Rx to be printed has an FDA Med Guide
"RTN","PSORXL",147,0)
 N FDARX,FDARXIEN,I S FDARX=0
"RTN","PSORXL",148,0)
 F I=1:1:$L($G(PPL),",") D  Q:FDARX
"RTN","PSORXL",149,0)
 . S FDARXIEN=+$P(PPL,",",I) I 'FDARXIEN Q
"RTN","PSORXL",150,0)
 . I $D(RXRP(FDARXIEN)),'$D(RXRP(FDARXIEN,"MG")) Q
"RTN","PSORXL",151,0)
 . I FDARXIEN,$$MGONFILE^PSOFDAUT(FDARXIEN) S FDARX=1
"RTN","PSORXL",152,0)
 Q FDARX
"RTN","PSORXL",153,0)
 ;
"RTN","PSORXL",154,0)
RSAVE N PMX
"RTN","PSORXL",155,0)
 S PMX="" F  S PMX=$O(RXRP(PMX)) Q:PMX=""  S PSORSAVE(PMX)=RXRP(PMX)
"RTN","PSORXL",156,0)
 S PMX="" F  S PMX=$O(RXPR(PMX)) Q:PMX=""  S PSOPSAVE(PMX)=RXPR(PMX)
"RTN","PSORXL",157,0)
 S PMX="" F  S PMX=$O(RXRH(PMX)) Q:PMX=""  S PSOHSAVE(PMX)=RXRH(PMX)
"RTN","PSORXL",158,0)
 Q
"RTN","PSORXL",159,0)
RREST N PMXZ
"RTN","PSORXL",160,0)
 S PMXZ="" F  S PMXZ=$O(PSORSAVE(PMXZ)) Q:PMXZ=""  S RXRP(PMXZ)=PSORSAVE(PMXZ)
"RTN","PSORXL",161,0)
 S PMXZ="" F  S PMXZ=$O(PSOPSAVE(PMXZ)) Q:PMXZ=""  S RXPR(PMXZ)=PSOPSAVE(PMXZ)
"RTN","PSORXL",162,0)
 S PMXZ="" F  S PMXZ=$O(PSOHSAVE(PMXZ)) Q:PMXZ=""  S RXRH(PMXZ)=PSOHSAVE(PMXZ)
"RTN","PSORXL",163,0)
 Q
"RTN","PSORXL",164,0)
 ;
"RTN","PSORXL",165,0)
OPAI ;This section of code will display where an RX is routed.
"RTN","PSORXL",166,0)
 ;To determine where an RX will be routed, check:
"RTN","PSORXL",167,0)
 ;1) if the drug for the RX is associated with an ADD device in
"RTN","PSORXL",168,0)
 ;   file #50 and if the printer is in the DISPENSING SYSTEM 
"RTN","PSORXL",169,0)
 ;   PRINTER multiple sub-file #59.02008. If it is then the RX 
"RTN","PSORXL",170,0)
 ;   will display as being routed to that device.  
"RTN","PSORXL",171,0)
 ;2) Otherwise, the category of the ADD associated with the
"RTN","PSORXL",172,0)
 ;   printer in sub-file #59.20081 will be used to determine 
"RTN","PSORXL",173,0)
 ;   where the RX will be routed and the ADD displayed.
"RTN","PSORXL",174,0)
 ;
"RTN","PSORXL",175,0)
 N DIC,X,Y,PN,II,RX,DEV,DDEV,ADD,DAT,DAT1,PDAT,DRG,DRG0,OPAI,CSB,RTE,FLG
"RTN","PSORXL",176,0)
 N ZTIO,MTH,NPPL
"RTN","PSORXL",177,0)
 I ($G(OPAIO)="")!($G(PPL)="") Q
"RTN","PSORXL",178,0)
 S DIC=3.5,DIC(0)="",X=OPAIO D ^DIC K DIC,X Q:Y=-1  S ZTIO=+Y
"RTN","PSORXL",179,0)
 S FLG=1,DEV=0,PN=$O(^PS(59,PSOSITE,"P","B",ZTIO,"")) I PN="" Q 
"RTN","PSORXL",180,0)
 I '$P($G(PSOPAR),"^",30) Q
"RTN","PSORXL",181,0)
 I $$GET1^DIQ(59,PSOSITE_",",105,"I")'=2.4 Q
"RTN","PSORXL",182,0)
 ;
"RTN","PSORXL",183,0)
 ;ADD array built base on category.
"RTN","PSORXL",184,0)
 ; if category is not "S" then 
"RTN","PSORXL",185,0)
 ;               ADD(category)=ADD name^dns^port^inactive date
"RTN","PSORXL",186,0)
 ; if category is "S" then (Category "S" can be multiple)
"RTN","PSORXL",187,0)
 ;               ADD(category,ADD name)=ADD name^dns^port^inactive date
"RTN","PSORXL",188,0)
 ;Array OPAI will be used to display the data on the screen.
"RTN","PSORXL",189,0)
 ;               OPAI(ADD name)=ADD name^dns^port^inactive date
"RTN","PSORXL",190,0)
 ;               OPAI(ADD name,RX)=drug
"RTN","PSORXL",191,0)
 ;
"RTN","PSORXL",192,0)
 F  S DEV=$O(^PS(59,PSOSITE,"P",PN,"OPAI",DEV)) Q:'DEV  D
"RTN","PSORXL",193,0)
 .S DAT=$G(^PS(59,PSOSITE,"P",PN,"OPAI",DEV,0)) I $P(DAT,"^",2)="" Q
"RTN","PSORXL",194,0)
 .S DAT1=$$ADDCHK^PSOHLDS($P(DAT,"^"))
"RTN","PSORXL",195,0)
 .I DAT1 D
"RTN","PSORXL",196,0)
 ..I $P(DAT,"^",2)'="S" S ADD($P(DAT,"^",2))=$P(DAT1,"^",2,99) Q
"RTN","PSORXL",197,0)
 ..S ADD($P(DAT,"^",2),$P(DAT1,"^",2))=$P(DAT1,"^",2,99)
"RTN","PSORXL",198,0)
 S NPPL=""
"RTN","PSORXL",199,0)
 F II=1:1:$L(PPL,",") S RX=$P(PPL,",",II) D:RX'=""
"RTN","PSORXL",200,0)
 .I $G(RXRP(RX,"RP")) Q 
"RTN","PSORXL",201,0)
 .S PDAT=$G(^PSRX(RX,0)),DRG=$P(PDAT,"^",6),RTE=$$RTE()
"RTN","PSORXL",202,0)
 .S DRG0=$G(^PSDRUG(+DRG,0)),DDEV=$G(^PSDRUG(+DRG,"OPAI",PSOSITE,0))
"RTN","PSORXL",203,0)
 .I $S($P(PSOPAR,"^",30)=3:1,$P(PSOPAR,"^",30)=4:1,1:0),'$$GET1^DIQ(50,DRG,28,"I") Q
"RTN","PSORXL",204,0)
 .S NPPL=NPPL_","_RX,DAT1=$$ADDCHK^PSOHLDS($S(RTE="W":$P(DDEV,"^",2),RTE="M":$P(DDEV,"^",3),1:"")) I DAT1 D  Q
"RTN","PSORXL",205,0)
 ..D SETOP($P(DAT1,"^",2,99),$P(PDAT,"^"),$P(DRG0,"^"))
"RTN","PSORXL",206,0)
 .I $D(ADD("A")) D SETOP(ADD("A"),$P(PDAT,"^"),$P(DRG0,"^")) Q
"RTN","PSORXL",207,0)
 .S CSB=+$P(DRG0,"^",3),CSB=$S((CSB>0)&(CSB<6):"CS",1:"NCS")
"RTN","PSORXL",208,0)
 .I $D(ADD(CSB)) D SETOP(ADD(CSB),$P(PDAT,"^"),$P(DRG0,"^")) Q
"RTN","PSORXL",209,0)
 .I $D(ADD(RTE_CSB)) D SETOP(ADD(RTE_CSB),$P(PDAT,"^"),$P(DRG0,"^")) Q
"RTN","PSORXL",210,0)
 .S MTH=$S(RTE="W":"WIND",RTE="M":"MAIL",1:"")
"RTN","PSORXL",211,0)
 .I MTH'="",$D(ADD(MTH)) D SETOP(ADD(MTH),$P(PDAT,"^"),$P(DRG0,"^"))
"RTN","PSORXL",212,0)
 .S FLG=0
"RTN","PSORXL",213,0)
 I FLG Q  ;nothing found to print
"RTN","PSORXL",214,0)
 I ($D(OPAI))!($D(ADD("S"))) W !,"PRESCRIPTIONS SENT TO:" D
"RTN","PSORXL",215,0)
 .S DEV="" F  S DEV=$O(OPAI(DEV)) Q:DEV=""  W !?3,DEV D  W !
"RTN","PSORXL",216,0)
 ..S RX=0 F  S RX=$O(OPAI(DEV,RX)) Q:'RX  W !?5,RX,?20,$P(OPAI(DEV,RX),"^")
"RTN","PSORXL",217,0)
 I $D(ADD("S")) W !,"STORAGE DEVICES" S II="" D
"RTN","PSORXL",218,0)
 .F  S II=$O(ADD("S",II)) Q:II=""  W !?3,II I $D(OPAI) ;W ?20,"The above Prescriptions"
"RTN","PSORXL",219,0)
 .F II=1:1:$L(NPPL,",") S RX=$P(NPPL,",",II) D:RX'=""
"RTN","PSORXL",220,0)
 ..Q:$G(RXRP(RX,"RP"))  S PDAT=$G(^PSRX(RX,0)),DRG=$P($G(^PSDRUG(+$P(PDAT,"^",6),0)),"^")
"RTN","PSORXL",221,0)
 ..W !?5,$P(PDAT,"^"),?20,DRG
"RTN","PSORXL",222,0)
 .W !
"RTN","PSORXL",223,0)
 Q
"RTN","PSORXL",224,0)
 ;
"RTN","PSORXL",225,0)
SETOP(DINF,DRX,DDRG) ; Set OPAI array
"RTN","PSORXL",226,0)
 N DNAM
"RTN","PSORXL",227,0)
 S DNAM=$P(DINF,"^"),OPAI(DNAM)=DINF,OPAI(DNAM,DRX)=DDRG,FLG=0
"RTN","PSORXL",228,0)
 Q
"RTN","PSORXL",229,0)
 ;
"RTN","PSORXL",230,0)
RTE() ; get route for RX
"RTN","PSORXL",231,0)
 N FP,FPN,LRF,MW,XX
"RTN","PSORXL",232,0)
 S FP=$S($G(RXPR(RX)):"P",1:"F")
"RTN","PSORXL",233,0)
 I '$G(RXPR(RX)) S LRF=0 F XX=0:0 S XX=$O(^PSRX(RX,1,XX)) Q:'XX  I +^(XX,0) S LRF=XX
"RTN","PSORXL",234,0)
 I '$G(RXPR(RX)),$G(RXFL(RX))'="" S LRF=$S($G(RXFL(RX))=0:0,$D(^PSRX(RX,1,+$G(RXFL(RX)),0)):+$G(RXFL(RX)),1:$G(LRF))
"RTN","PSORXL",235,0)
 S FPN=$S($G(RXPR(RX)):RXPR(RX),1:$G(LRF))
"RTN","PSORXL",236,0)
 I FP="F"&('FPN) S MW=$P($G(^PSRX(RX,0)),"^",11)       ;original
"RTN","PSORXL",237,0)
 I FP="F"&(FPN) S MW=$P($G(^PSRX(RX,1,FPN,0)),"^",2)   ;refill
"RTN","PSORXL",238,0)
 I FP="P"&(FPN) S MW=$P($G(^PSRX(RX,"P",FPN,0)),"^",2) ;partial
"RTN","PSORXL",239,0)
 Q $G(MW)
"RTN","PSOSULBL")
0^2^B77851131^B75522533
"RTN","PSOSULBL",1,0)
PSOSULBL ;BHAM ISC/RTR,SAB-Print Suspended labels ;4/8/93
"RTN","PSOSULBL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**139,173,174,148,200,260,264,287,289,290,354,421,370**;DEC 1997;Build 14
"RTN","PSOSULBL",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOSULBL",4,0)
 ;Reference to SAVNDC^PSSNDCUT supported by IA 4707
"RTN","PSOSULBL",5,0)
 ;Reference ^PSDRUG( supported by DBIA 221
"RTN","PSOSULBL",6,0)
 K PDUZ,REPRINT G ^PSOSULB1
"RTN","PSOSULBL",7,0)
BEG ;
"RTN","PSOSULBL",8,0)
 K PSORUNIN,PSORETRY N BPSCNT
"RTN","PSOSULBL",9,0)
 S PSORUNIN="^XTMP(""PSOSUSP"")"     ; global lock fix by patch 290
"RTN","PSOSULBL",10,0)
 L +@PSORUNIN:10 I '$T D
"RTN","PSOSULBL",11,0)
 . F PSORETRY=1:1:120 L +@PSORUNIN:60 I $T Q  ;wait Max of 2 hrs before continue
"RTN","PSOSULBL",12,0)
 . Q
"RTN","PSOSULBL",13,0)
 K ^UTILITY($J,"PSOPRO"),^TMP("PSOSBAI",$J) S PSOSEQ=1 F DFN=0:0 S DFN=$O(^PS(52.5,"AC",DFN)) Q:'DFN  D  D:'PSRT PID^VADPT6 D CHKDEAD D:'DEAD&($G(PSOSFLAG)) PRT
"RTN","PSOSULBL",14,0)
 .S PSOSFLAG=0 F ZZ=0:0 S ZZ=$O(^PS(52.5,"AC",DFN,ZZ)) Q:'ZZ!$G(PSOSFLAG)  I ZZ'>PRTDT S PSOSFLAG=1
"RTN","PSOSULBL",15,0)
 D PPL
"RTN","PSOSULBL",16,0)
 D:$D(^UTILITY($J,"PSOPRO"))&($P(PSOPAR,"^",8)) PROF
"RTN","PSOSULBL",17,0)
 G EXIT
"RTN","PSOSULBL",18,0)
PRT F SDT=0:0 S SDT=$O(^PS(52.5,"AC",DFN,SDT)) D:SDT CHK Q:'SDT
"RTN","PSOSULBL",19,0)
 Q
"RTN","PSOSULBL",20,0)
EXIT ;
"RTN","PSOSULBL",21,0)
 I $D(^TMP("PSOSBAI",$J)) D CHKMAIL
"RTN","PSOSULBL",22,0)
 K ^TMP($J),^TMP("PSOSBAI",$J)
"RTN","PSOSULBL",23,0)
 I $D(PSORUNIN) L -@PSORUNIN
"RTN","PSOSULBL",24,0)
 D ^%ZISC
"RTN","PSOSULBL",25,0)
 K %,%ZIS,CNT,COM,DA,DEAD,DFN,DIRUT,DTTM,G,HDPPL,JJ,JJJ,JJJJ,PDUZ,IOP,ORD,PFIOQ,PSLION,PSRT,POP,PRF,PRTDT,PSLIO,PSNP,PSODBQ,PSOSEQ,PSOSFLAG,PSOSU,PSOTIME,PSOOUT,PSOPRFLG,PSOSEQ,PSOSUSPR,PSSPND,PST,PTL,PPLHLD,PSFNIEN,ZTSK
"RTN","PSOSULBL",26,0)
 K PSOBADDR,PSORUNIN,PSORETRY,PSRTONE,PSSRT,PSUSDEA,RF,RFCNT,RX,RXDFN,SDT,SFN,SREC,STOP,SUSPT,VADM,VAPA,X,X1,X2,XAK,XDATE,Y,Z,ZZ,WWW,PSDDDATE,SINRX,RXPR,RXPR1,GGGG,XXX,ZII,ZTDESC,ZTRTN,ZTSAVE,RRRR,RXRP,RXRP1,RXFL,SPR S:$D(ZTQUEUED) ZTREQ="@" Q
"RTN","PSOSULBL",27,0)
CHK I SDT'>XDATE D TMP Q
"RTN","PSOSULBL",28,0)
 Q
"RTN","PSOSULBL",29,0)
TMP F SFN=0:0 S SFN=$O(^PS(52.5,"AC",DFN,SDT,SFN)) Q:'SFN  D
"RTN","PSOSULBL",30,0)
 . I '$D(^PS(52.5,SFN,0))!'$D(^DPT(+DFN,0)) Q
"RTN","PSOSULBL",31,0)
 . N RXSITE,PRINTED,PSDFN,RXSTS,RXIEN,RXFILL,PARTIAL,RXEXPDT,RESP,DSHLD,ESTATUS
"RTN","PSOSULBL",32,0)
 . S RXIEN=+$$GET1^DIQ(52.5,SFN,.01,"I"),RXDFN=$$GET1^DIQ(52,RXIEN,2,"I")
"RTN","PSOSULBL",33,0)
 . S RXSTS=$$GET1^DIQ(52,RXIEN,100,"I"),RXSITE=+$$GET1^DIQ(52.5,SFN,.06,"I"),PRINTED=+$$GET1^DIQ(52.5,SFN,2,"I")
"RTN","PSOSULBL",34,0)
 . S PARTIAL=+$$GET1^DIQ(52.5,SFN,.05,"I"),RXEXPDT=$$GET1^DIQ(52,RXIEN,26,"I")
"RTN","PSOSULBL",35,0)
 . S RXFILL=$$GET1^DIQ(52.5,SFN,9,"I") I RXFILL="" S RXFILL=$$LSTRFL^PSOBPSU1(RXIEN)
"RTN","PSOSULBL",36,0)
 . I RXSITE=$G(PSOSITE),'PRINTED,RXDFN=DFN,RXSTS<9 D
"RTN","PSOSULBL",37,0)
 . . I PARTIAL,'$D(^PSRX(RXIEN,"P",PARTIAL)) Q
"RTN","PSOSULBL",38,0)
 . . I RXEXPDT<DT,RXSTS<11 D  Q
"RTN","PSOSULBL",39,0)
 . . . N RXREC S RXREC=RXIEN D EX^PSOSUTL
"RTN","PSOSULBL",40,0)
 . . . K DIE,DA S DIE=52,DA=RXIEN,DR="100///11" D ^DIE K DIE,DA
"RTN","PSOSULBL",41,0)
 . . . K DIK,DA S DA=SFN,DIK="^PS(52.5," D ^DIK K DIK,DA
"RTN","PSOSULBL",42,0)
 . . S PSOBADDR=0 D CHKBAI I PSOBADDR Q
"RTN","PSOSULBL",43,0)
 . . I PSRT="D" D
"RTN","PSOSULBL",44,0)
 . . . S PSSRT=$S($G(PSRTONE)="I":VA("PID"),1:$P(^DPT(DFN,0),"^")_$P(^(0),"^",9))
"RTN","PSOSULBL",45,0)
 . . . S PSUSDEA=$P($G(^PS(52.5,SFN,0)),"^",10)
"RTN","PSOSULBL",46,0)
 . . . S SRT=$S(PSUSDEA["A"!(PSUSDEA["C"):"A-"_PSSRT,PSUSDEA["S":"S-"_PSSRT,1:"Z-"_PSSRT)
"RTN","PSOSULBL",47,0)
 . . I PSRT'="D" D
"RTN","PSOSULBL",48,0)
 . . . S SRT=$S(PSRT:$P(^DPT(DFN,0),"^")_$P(^(0),"^",9),1:VA("PID"))
"RTN","PSOSULBL",49,0)
 . . ; - If not partial fill, sending Rx to ECME for 3rd Party billing
"RTN","PSOSULBL",50,0)
 . . I 'PARTIAL,$$RETRX^PSOBPSUT(RXIEN,RXFILL),SDT>DT Q
"RTN","PSOSULBL",51,0)
 . . S ESTATUS=$$STATUS^PSOBPSUT(RXIEN,RXFILL)
"RTN","PSOSULBL",52,0)
 . . I 'PARTIAL,ESTATUS'="",ESTATUS'["PAYABLE",'$$ECMESTAT^PSOBPSU2(RXIEN,RXFILL) Q  ;check for existing epharmacy reject codes
"RTN","PSOSULBL",53,0)
 . . I 'PARTIAL,RXFILL>0,$$STATUS^PSOBPSUT(RXIEN,RXFILL-1)'="" S DSHLD=$$DSH^PSOSULB1(SFN) Q:'DSHLD  ;epharmacy-3/4 days supply (refill)
"RTN","PSOSULBL",54,0)
 . . I 'PARTIAL,RXFILL=0 S DSHLD=$$DSH^PSOSULB1(SFN) Q:'DSHLD  ;epharmacy-3/4 days supply (original fill)
"RTN","PSOSULBL",55,0)
 . . I 'PARTIAL,$$FIND^PSOREJUT(RXIEN,RXFILL,,"79,88",,1) Q  ;check for DUR/RTS/RRR (again as it is done in ECMESTAT above)
"RTN","PSOSULBL",56,0)
 . . I 'PARTIAL,($$RETRX^PSOBPSUT(RXIEN,RXFILL)!$$ECMEST2^PSOBPSU2(RXIEN,RXFILL)) D  Q:$$TRISTA^PSOREJU3(RXIEN,RXFILL,.RESP,"PL")
"RTN","PSOSULBL",57,0)
 . . . D ECMESND^PSOBPSU1(RXIEN,RXFILL,,"PL",,,,,,.RESP)
"RTN","PSOSULBL",58,0)
 . . . I $D(RESP),'RESP S BPSCNT=$G(BPSCNT)+1
"RTN","PSOSULBL",59,0)
 . . S ^TMP($J,SRT,SFN)=RXIEN
"RTN","PSOSULBL",60,0)
 Q
"RTN","PSOSULBL",61,0)
PPL ; Wait some time before printing so response from 3rd party payers can be received
"RTN","PSOSULBL",62,0)
 I $G(BPSCNT)>0 H 60+$S((BPSCNT*15)>7200:7200,1:(BPSCNT*15))
"RTN","PSOSULBL",63,0)
 K PPL,PPL1 S ORD="" F  S ORD=$O(^TMP($J,ORD)) Q:ORD=""  D PPL1
"RTN","PSOSULBL",64,0)
 Q
"RTN","PSOSULBL",65,0)
PPL1 ; Printing Labels
"RTN","PSOSULBL",66,0)
 N PARTIAL,REPRINT,REFILL,Z,QUIT,ESTAT
"RTN","PSOSULBL",67,0)
 S (PSOPRFLG,SUSPT)=1 S:$D(PSOPROP) PFIO=PSOPROP
"RTN","PSOSULBL",68,0)
 S:'$D(PDUZ) PDUZ=DUZ K RXPR,RXPR1,PPL
"RTN","PSOSULBL",69,0)
 F SFN=0:0 S SFN=$O(^TMP($J,ORD,SFN)) Q:'SFN  D
"RTN","PSOSULBL",70,0)
 .I '$D(^PS(52.5,SFN,0)) Q
"RTN","PSOSULBL",71,0)
 .S Z=$G(^PS(52.5,SFN,0)),SINRX=+$P(Z,"^"),REFILL=+$P(Z,"^",13)
"RTN","PSOSULBL",72,0)
 .S PARTIAL=$P(Z,"^",5),REPRINT=$P(Z,"^",12)
"RTN","PSOSULBL",73,0)
 .; - Screening out OPEN/UNRESOLVED Rejects (3rd Party Payer) 
"RTN","PSOSULBL",74,0)
 .S QUIT=0
"RTN","PSOSULBL",75,0)
 .I 'PARTIAL,'REPRINT D  I QUIT Q
"RTN","PSOSULBL",76,0)
 ..I $$FIND^PSOREJUT(SINRX,REFILL,,"79,88",,1) S QUIT=1 Q
"RTN","PSOSULBL",77,0)
 ..S ESTAT=$$STATUS^PSOBPSUT(SINRX,REFILL)
"RTN","PSOSULBL",78,0)
 ..I ESTAT'="E PAYABLE",'$$ECMESTAT^PSOBPSU2(SINRX,REFILL) S QUIT=1 Q  ;host reject
"RTN","PSOSULBL",79,0)
 ..I ESTAT="E PAYABLE" D
"RTN","PSOSULBL",80,0)
 ...D SAVNDC^PSSNDCUT(+$$GET1^DIQ(52,SINRX,6,"I"),$$RXSITE^PSOBPSUT(SINRX,REFILL),$$GETNDC^PSONDCUT(SINRX,REFILL))
"RTN","PSOSULBL",81,0)
 .; 
"RTN","PSOSULBL",82,0)
 .I $L($G(PPL))<240 D
"RTN","PSOSULBL",83,0)
 ..S PPL=$P(^TMP($J,ORD,SFN),"^")_","_$G(PPL),RXPR(SINRX)=$P(^PS(52.5,SFN,0),"^",5)
"RTN","PSOSULBL",84,0)
 ..S:$P(^PS(52.5,SFN,0),"^",12) RXRP(SINRX)=1
"RTN","PSOSULBL",85,0)
 .E  D
"RTN","PSOSULBL",86,0)
 ..S PPL1=$P(^TMP($J,ORD,SFN),"^")_","_$G(PPL1),RXPR1(SINRX)=$P(^PS(52.5,SFN,0),"^",5)
"RTN","PSOSULBL",87,0)
 ..S:$P(^PS(52.5,SFN,0),"^",12) RXRP1(SINRX)=1
"RTN","PSOSULBL",88,0)
 .S DFN=$P(^PS(52.5,SFN,0),"^",3)
"RTN","PSOSULBL",89,0)
 .I $P(PSOPAR,"^",8),'$D(^PSRX($P(^PS(52.5,SFN,0),"^"),1)),'$G(RXPR(SINRX)),'$G(RXPR1(SINRX)) S PSOPRFLG=0
"RTN","PSOSULBL",90,0)
 S PSNP=$S($P(PSOPAR,"^",8):1,1:0)
"RTN","PSOSULBL",91,0)
 I $G(PPL) D
"RTN","PSOSULBL",92,0)
 .S PPLHLD=$G(PPL1),HDPPL=PPL K PPL1 S (PSODBQ,PSOSUSPR)=1
"RTN","PSOSULBL",93,0)
 .F GGGG=0:0 S GGGG=$O(RXPR(GGGG)) Q:'GGGG  K:'$G(RXPR(GGGG)) RXPR(GGGG)
"RTN","PSOSULBL",94,0)
 I $G(PPL) S ZTIO=$G(PSLION) D DQ^PSOLBL,SEQ D:'$G(PSOPRFLG) 
"RTN","PSOSULBL",95,0)
 .I $G(PSOPROP)'=$G(PSLION) S ^UTILITY($J,"PSOPRO",DFN)="" Q
"RTN","PSOSULBL",96,0)
 .D DQ^PSOPRFSS
"RTN","PSOSULBL",97,0)
 I $G(PPLHLD) K RXPR S (PPL,HDPPL)=PPLHLD,(PSODBQ,PSOSUSPR)=1,PSNP=0 S:'$D(PDUZ) PDUZ=DUZ F XXX=0:0 S XXX=$O(RXPR1(XXX)) Q:'XXX  S:$G(RXPR1(XXX)) RXPR(XXX)=RXPR1(XXX)
"RTN","PSOSULBL",98,0)
 I $G(PPLHLD) F RRRR=0:0 S RRRR=$O(RXRP1(RRRR)) Q:'RRRR  S:$D(RXRP1(RRRR)) RXRP(RRRR)=1
"RTN","PSOSULBL",99,0)
 I $G(PPLHLD) S ZTIO=$G(PSLION) D DQ^PSOLBL,SEQ D:'$G(PSOPRFLG)
"RTN","PSOSULBL",100,0)
 .I $G(PSOPROP)'=$G(PSLION) S ^UTILITY($J,"PSOPRO",DFN)="" Q
"RTN","PSOSULBL",101,0)
 .D DQ^PSOPRFSS
"RTN","PSOSULBL",102,0)
 K PPL,PPL1,PPLHLD,RXPR,RXPR1,RXFL Q
"RTN","PSOSULBL",103,0)
SEQ ;
"RTN","PSOSULBL",104,0)
 S SQCOUNT=0 F JJJ=1:1:$L(HDPPL) S:$E(HDPPL,JJJ)="," SQCOUNT=SQCOUNT+1
"RTN","PSOSULBL",105,0)
 F JJJJ=1:1:SQCOUNT S PSFNIEN=$P(HDPPL,",",JJJJ) D:PSFNIEN
"RTN","PSOSULBL",106,0)
 .S PSFNIEN=$O(^PS(52.5,"B",PSFNIEN,0)) I PSFNIEN D
"RTN","PSOSULBL",107,0)
 ..S $P(^PS(52.5,PSFNIEN,0),"^",11)=PSOSEQ,PSOSEQ=PSOSEQ+1 S:$P(^PS(52.5,PSFNIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",6)) ^PS(52.5,"AS",$P(^PS(52.5,PSFNIEN,0),"^",8),$P(^(0),"^",9),$P(^(0),"^",6),$P(^(0),"^",11),PSFNIEN)=""
"RTN","PSOSULBL",108,0)
 Q
"RTN","PSOSULBL",109,0)
CHKDEAD D DEM^VADPT I VADM(1)="" S DEAD=0 Q
"RTN","PSOSULBL",110,0)
 I VADM(6)="" S DEAD=0 Q
"RTN","PSOSULBL",111,0)
 S PSDDDATE=$P(VADM(6),"^",2) F WWW=0:0 S WWW=$O(^PS(55,DFN,"P",WWW)) Q:'WWW  I $D(^PS(55,DFN,"P",WWW,0)),$P($G(^(0)),"^") S (DA,RXREC)=$P(^(0),"^") S SFN=$O(^PS(52.5,"B",RXREC,0)) I SFN,$D(^PS(52.5,SFN,0)) S RX=$P(^(0),"^") D DEAD
"RTN","PSOSULBL",112,0)
 Q
"RTN","PSOSULBL",113,0)
DEAD S $P(^PSRX(RX,"STA"),"^")=12,COM="Died ("_$G(PSDDDATE)_")",DA(1)=RX
"RTN","PSOSULBL",114,0)
 S DEAD=1 D ARECD^PSOSUTL S DIK="^PS(52.5,",DA=SFN D ^DIK K DIK
"RTN","PSOSULBL",115,0)
 Q
"RTN","PSOSULBL",116,0)
PROF ;
"RTN","PSOSULBL",117,0)
 S ZTRTN="PRPROF^PSOSULBL",ZTDESC="PRINT PROFILES FROM SUSPENSE",ZTDTH=$H,ZTIO=PSOPROP
"RTN","PSOSULBL",118,0)
 S ZTSAVE("^UTILITY($J,""PSOPRO"",")="",ZTSAVE("PSOPAR")="",ZTSAVE("PSODTCUT")="",ZTSAVE("PSOSITE")="",ZTSAVE("PSOPRPAS")="" D ^%ZTLOAD Q
"RTN","PSOSULBL",119,0)
PRPROF ;
"RTN","PSOSULBL",120,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"PSOPRO",LLL)) Q:'LLL  I $D(^DPT(LLL,0)) S DFN=LLL D DQ^PSOPRFSS
"RTN","PSOSULBL",121,0)
 K PSOPAR,PSODTCUT,PSOSITE,PSOPRPAS,LLL,DFN,^UTILITY($J,"PSOPRO") D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOSULBL",122,0)
 Q
"RTN","PSOSULBL",123,0)
 ;
"RTN","PSOSULBL",124,0)
CHKBAI ; IF BAD ADDRESS INDICATOR, NO ACTIVE TEMPORARY ADDRESS AND ROUTING OF MAIL, DO NOT SEND TO OPAI AND/OR DO NOT PRINT LABEL
"RTN","PSOSULBL",125,0)
 N PSOBADR,ACTSEQ,XX,PSOFIRST,ACTTYPE
"RTN","PSOSULBL",126,0)
 I '$G(RXFILL),$P(^PSRX(RXIEN,0),"^",11)="W" Q
"RTN","PSOSULBL",127,0)
 I $P($G(^PSRX(RXIEN,1,RXFILL,0)),"^",2)="W" Q
"RTN","PSOSULBL",128,0)
 S ACTTYPE="BAD ADDRESS INDICATOR"
"RTN","PSOSULBL",129,0)
 S PSOBADR=$$CHKRX^PSOBAI(RXIEN)
"RTN","PSOSULBL",130,0)
 ; GOOD PERMANENT OR TEMPORARY ADDRESS - CHECK FOR DO NOT MAIL
"RTN","PSOSULBL",131,0)
 I PSOBADR,'$P(PSOBADR,"^",2) D SETTMP(ACTTYPE) Q
"RTN","PSOSULBL",132,0)
 S NOMAIL=0 D NOMAIL I NOMAIL Q
"RTN","PSOSULBL",133,0)
 D FOREIGN
"RTN","PSOSULBL",134,0)
 Q
"RTN","PSOSULBL",135,0)
 ;
"RTN","PSOSULBL",136,0)
SETTMP(ACTTYPE) ;
"RTN","PSOSULBL",137,0)
 N ACTSEQ,XX,PSOFIRST,ZZ
"RTN","PSOSULBL",138,0)
 S PSOFIRST=1
"RTN","PSOSULBL",139,0)
 S PSOBADDR=1
"RTN","PSOSULBL",140,0)
 S ACTSEQ=0 F  S ACTSEQ=$O(^PSRX(RXIEN,"A",ACTSEQ)) Q:ACTSEQ=""  D
"RTN","PSOSULBL",141,0)
 .S XX=$G(^PSRX(RXIEN,"A",ACTSEQ,0)) I $P(XX,"^",2)="S" S ZZ=$P(XX,"^",4),ZZ=$S(ZZ<6:ZZ,1:ZZ-1) I ZZ=RXFILL,$P(XX,"^",5)["due to "_ACTTYPE S PSOFIRST=0 Q
"RTN","PSOSULBL",142,0)
 I PSOFIRST D
"RTN","PSOSULBL",143,0)
 .S ^TMP("PSOSBAI",$J,RXIEN,+RXFILL)=ACTTYPE
"RTN","PSOSULBL",144,0)
 .D ACT(ACTTYPE)
"RTN","PSOSULBL",145,0)
 Q
"RTN","PSOSULBL",146,0)
 ;
"RTN","PSOSULBL",147,0)
NOMAIL ; SEE IF FILE 55 STATUS IS DO NOT MAIL
"RTN","PSOSULBL",148,0)
 N ACTTYPE,DFN,MAILST,MAILEXP
"RTN","PSOSULBL",149,0)
 S ACTTYPE="DO NOT MAIL"
"RTN","PSOSULBL",150,0)
 S DFN=+$P($G(^PSRX(RXIEN,0)),"^",2),MAILST=$P($G(^PS(55,DFN,0)),"^",3) I MAILST'=2 Q
"RTN","PSOSULBL",151,0)
 S MAILEXP=$P(^PS(55,DFN,0),"^",5)
"RTN","PSOSULBL",152,0)
 I MAILEXP=""!(MAILEXP>DT) D SETTMP(ACTTYPE)
"RTN","PSOSULBL",153,0)
 Q
"RTN","PSOSULBL",154,0)
 ;
"RTN","PSOSULBL",155,0)
FOREIGN ;
"RTN","PSOSULBL",156,0)
 N DFN,PSOFORGN
"RTN","PSOSULBL",157,0)
 S DFN=$$GET1^DIQ(52,RXIEN,2,"I")  ;*370
"RTN","PSOSULBL",158,0)
 D ADD^VADPT
"RTN","PSOSULBL",159,0)
 S PSOFORGN=$P($G(VAPA(25)),"^",2) I PSOFORGN'="" D  ; *370
"RTN","PSOSULBL",160,0)
 . N PSON,PSOFOREN S PSOFOREN=1
"RTN","PSOSULBL",161,0)
 . S PSON=$$GET1^DIQ(59,PSOSITE,.01)
"RTN","PSOSULBL",162,0)
 . I PSON'["MANILA",PSOFORGN["UNITED STATES" S PSOFOREN=0
"RTN","PSOSULBL",163,0)
 . I PSON["MANILA",PSOFORGN["PHILIPPINES" S PSOFOREN=0
"RTN","PSOSULBL",164,0)
 . S PSOFORGN=PSOFOREN
"RTN","PSOSULBL",165,0)
 I PSOFORGN D SETTMP("FOREIGN ADDRESS")
"RTN","PSOSULBL",166,0)
 Q
"RTN","PSOSULBL",167,0)
 ;
"RTN","PSOSULBL",168,0)
CHKMAIL ; SEE IF MAILMAN MESSAGE SHOULD BE SENT FOR BAI/MAIL ROUTING
"RTN","PSOSULBL",169,0)
 N RXIEN,RXFILL,ACTSEQ,XX,DFN,SSN,NAME,ACTTYPE,ZZ
"RTN","PSOSULBL",170,0)
 K ^TMP("PSOSM",$J)
"RTN","PSOSULBL",171,0)
 S RXIEN=0 F  S RXIEN=$O(^TMP("PSOSBAI",$J,RXIEN)) Q:'RXIEN  D
"RTN","PSOSULBL",172,0)
 .S RXFILL="" F  S RXFILL=$O(^TMP("PSOSBAI",$J,RXIEN,RXFILL)) Q:RXFILL=""  D
"RTN","PSOSULBL",173,0)
 ..S ACTTYPE=^TMP("PSOSBAI",$J,RXIEN,RXFILL)
"RTN","PSOSULBL",174,0)
 ..S ACTSEQ=0 F  S ACTSEQ=$O(^PSRX(RXIEN,"A",ACTSEQ)) Q:ACTSEQ=""  D
"RTN","PSOSULBL",175,0)
 ...S XX=$G(^PSRX(RXIEN,"A",ACTSEQ,0)) I $P(XX,"^",2)="S" S ZZ=$P(XX,"^",4),ZZ=$S(ZZ<6:ZZ,1:ZZ-1) I ZZ=RXFILL,$P(XX,"^",5)["due to "_ACTTYPE Q
"RTN","PSOSULBL",176,0)
 ...S DFN=$P(^PSRX(RXIEN,0),"^",2),NAME=$P(^DPT(DFN,0),"^"),SSN=$P(^(0),"^",9) I SSN="" S SSN=0
"RTN","PSOSULBL",177,0)
 ...S ^TMP("PSOSM",$J,NAME,SSN,RXIEN,RXFILL)=ACTTYPE
"RTN","PSOSULBL",178,0)
 I $D(^TMP("PSOSM",$J)) D BAIMAIL^PSOSULB1
"RTN","PSOSULBL",179,0)
 K ^TMP("PSOSM",$J)
"RTN","PSOSULBL",180,0)
 Q
"RTN","PSOSULBL",181,0)
 ;
"RTN","PSOSULBL",182,0)
ACT(ACTTYPE) ;adds activity info for rx not printed from suspense/not sent to OPAI
"RTN","PSOSULBL",183,0)
 N NOW,IR,FDA
"RTN","PSOSULBL",184,0)
 D NOW^%DTC S NOW=%
"RTN","PSOSULBL",185,0)
 S IR=0 F FDA=0:0 S FDA=$O(^PSRX(RXIEN,"A",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOSULBL",186,0)
 S IR=IR+1,^PSRX(RXIEN,"A",0)="^52.3DA^"_IR_"^"_IR
"RTN","PSOSULBL",187,0)
 S ^PSRX(RXIEN,"A",IR,0)=NOW_"^"_"S"_"^"_DUZ_"^"_$S(+RXFILL>5:RXFILL+1,1:+RXFILL)_"^"_"RX not printed from suspense due to "_ACTTYPE
"RTN","PSOSULBL",188,0)
 K PSUS,RXF,I,FDA,DIC,DIE,DR,Y,X,%,%I,%H,RSDT
"RTN","PSOSULBL",189,0)
 Q
"RTN","PSOSULBL",190,0)
 ;
"VER")
8.0^22.0
"BLD",9638,6)
^376
**END**
**END**


