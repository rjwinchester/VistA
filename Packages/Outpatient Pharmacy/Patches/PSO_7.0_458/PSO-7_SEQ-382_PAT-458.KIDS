Released PSO*7*458 SEQ #382
Extracted from mail message
**KIDS**:PSO*7.0*458^

**INSTALL NAME**
PSO*7.0*458
"BLD",9419,0)
PSO*7.0*458^OUTPATIENT PHARMACY^0^3160524^y
"BLD",9419,1,0)
^^1^1^3160315^
"BLD",9419,1,1,0)
ME2 Follow Up build for known minor defects.
"BLD",9419,4,0)
^9.64PA^^
"BLD",9419,6.3)
2
"BLD",9419,"KRN",0)
^9.67PA^779.2^20
"BLD",9419,"KRN",.4,0)
.4
"BLD",9419,"KRN",.401,0)
.401
"BLD",9419,"KRN",.402,0)
.402
"BLD",9419,"KRN",.403,0)
.403
"BLD",9419,"KRN",.5,0)
.5
"BLD",9419,"KRN",.84,0)
.84
"BLD",9419,"KRN",3.6,0)
3.6
"BLD",9419,"KRN",3.8,0)
3.8
"BLD",9419,"KRN",9.2,0)
9.2
"BLD",9419,"KRN",9.8,0)
9.8
"BLD",9419,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",9419,"KRN",9.8,"NM",1,0)
PSODDPR2^^0^B132703820
"BLD",9419,"KRN",9.8,"NM",2,0)
PSODGAL3^^0^B175130072
"BLD",9419,"KRN",9.8,"NM",3,0)
PSODRG^^0^B93820988
"BLD",9419,"KRN",9.8,"NM","B","PSODDPR2",1)

"BLD",9419,"KRN",9.8,"NM","B","PSODGAL3",2)

"BLD",9419,"KRN",9.8,"NM","B","PSODRG",3)

"BLD",9419,"KRN",19,0)
19
"BLD",9419,"KRN",19.1,0)
19.1
"BLD",9419,"KRN",101,0)
101
"BLD",9419,"KRN",409.61,0)
409.61
"BLD",9419,"KRN",771,0)
771
"BLD",9419,"KRN",779.2,0)
779.2
"BLD",9419,"KRN",870,0)
870
"BLD",9419,"KRN",8989.51,0)
8989.51
"BLD",9419,"KRN",8989.52,0)
8989.52
"BLD",9419,"KRN",8994,0)
8994
"BLD",9419,"KRN","B",.4,.4)

"BLD",9419,"KRN","B",.401,.401)

"BLD",9419,"KRN","B",.402,.402)

"BLD",9419,"KRN","B",.403,.403)

"BLD",9419,"KRN","B",.5,.5)

"BLD",9419,"KRN","B",.84,.84)

"BLD",9419,"KRN","B",3.6,3.6)

"BLD",9419,"KRN","B",3.8,3.8)

"BLD",9419,"KRN","B",9.2,9.2)

"BLD",9419,"KRN","B",9.8,9.8)

"BLD",9419,"KRN","B",19,19)

"BLD",9419,"KRN","B",19.1,19.1)

"BLD",9419,"KRN","B",101,101)

"BLD",9419,"KRN","B",409.61,409.61)

"BLD",9419,"KRN","B",771,771)

"BLD",9419,"KRN","B",779.2,779.2)

"BLD",9419,"KRN","B",870,870)

"BLD",9419,"KRN","B",8989.51,8989.51)

"BLD",9419,"KRN","B",8989.52,8989.52)

"BLD",9419,"KRN","B",8994,8994)

"BLD",9419,"QUES",0)
^9.62^^
"BLD",9419,"REQB",0)
^9.611^1^1
"BLD",9419,"REQB",1,0)
PSO*7.0*411^2
"BLD",9419,"REQB","B","PSO*7.0*411",1)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
458^3160524
"PKG",141,22,1,"PAH",1,1,0)
^^1^1^3160524
"PKG",141,22,1,"PAH",1,1,1,0)
ME2 Follow Up build for known minor defects.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSODDPR2")
0^1^B132703820^B133640558
"RTN","PSODDPR2",1,0)
PSODDPR2 ;BIR/SAB - display enhanced order checks ;11 May 2010  9:06 AM
"RTN","PSODDPR2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,379,390,372,416,411,458**;DEC 1997;Build 2
"RTN","PSODDPR2",3,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPR2",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPR2",5,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSODDPR2",6,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789 
"RTN","PSODDPR2",7,0)
 K ^UTILITY($J),PSODRUG("BAD"),THER,THERO,^TMP($J,"PSODCOR"),PSOINTV,PSOVAG,PSODD,PSI,PSORDIT,DRGNM,PDODCNT
"RTN","PSODDPR2",8,0)
 I $O(^TMP($J,LIST,"OUT","EXCEPTIONS",""))]"" D EXC^PSODDPR5 G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",9,0)
 N COUNT,DRG,ON,CT,DRGI,PDRG,SEV,STX,INT,CLI,PSONULN,PSONULN1,LST,LSI,DGI,SER,SERS,DUPT,SV,PSOLINES,OLDDRG,PSOOLDD,PSOTSUB,PSODSEQ,ZST,ZHDR,ZSUB,ZZDGDGC,PSOCLNS
"RTN","PSODDPR2",10,0)
 N PSOSEVER,PSODDSEQ,ZMED,COUNT2
"RTN","PSODDPR2",11,0)
 S (ON,DRG,SV,LSI,DGI,SER,SERS,PSOOLDD,PSOSEVER)="",(ZZDGDGC,CT,COUNT)=0,$P(PSONULN,"-",79)="-",$P(PSONULN1,"=",79)="=",ZHDR=1
"RTN","PSODDPR2",12,0)
 D NSRT^PSODDPR5 K ^TMP("PSODGI",$J),^TMP("PSOSER",$J),^TMP("PSOSERS",$J),^TMP("PSODGS",$J),^TMP("PSOTDD",$J,1)
"RTN","PSODDPR2",13,0)
 S (ON,DRG,SV,DGI,SER,SERS,ZVA)="",(ZST,ZORS,CT,COUNT)=0 N ZZOC S ZZOC=0,PSODDSEQ=0 ; PSO*7*411 
"RTN","PSODDPR2",14,0)
 F  S SV=$O(ZZDGDG(SV)) Q:SV=""!$G(PSODLQT)  F  S ZST=$O(ZZDGDG(SV,ZST)) Q:'ZST!$G(PSODLQT)  F  S ZORS=$O(ZZDGDG(SV,ZST,ZORS)) Q:'ZORS!$G(PSODLQT)  D
"RTN","PSODDPR2",15,0)
 .F  S ZVA=$O(ZZDGDG(SV,ZST,ZORS,ZVA)) Q:ZVA=""!$G(PSODLQT)  F  S DRG=$O(ZZDGDG(SV,ZST,ZORS,ZVA,DRG)) Q:DRG=""!$G(PSODLQT)  S COUNT=COUNT+1 D DUP^PSODDPR8,BLD2^PSODGDGP
"RTN","PSODDPR2",16,0)
 K HZVA,ZVA,ZORS,ZZDGDG,PSOCLNS,COUNT,ON,DRG,SV,DGI,PSORX("INTERVENE"),DIR,CDDT ;D HD() G EXIT:$G(PSODLQT) ;PSO*7*411
"RTN","PSODDPR2",17,0)
 Q:$D(PSSDIUTL)
"RTN","PSODDPR2",18,0)
 I +$G(PSOINTV) D INT G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",19,0)
 I $G(PSORX("DFLG")) W:$G(COPY) !,$C(7),"RX DELETED",! S PSORX("DFLG")=1,POERR("DFLG")=1,VALMBCK="R" G EXIT  Q
"RTN","PSODDPR2",20,0)
 I '$D(^XUSEC("PSORPH",DUZ)) K PSORX("INTERVENE")
"RTN","PSODDPR2",21,0)
 ;
"RTN","PSODDPR2",22,0)
 I $G(PSORX("INTERVENE"))]"" D
"RTN","PSODDPR2",23,0)
 .K PSODAL("DA") D FULL^VALM1,^PSORXI S:'$G(POERR) VALMBCK="R" W !
"RTN","PSODDPR2",24,0)
 ;
"RTN","PSODDPR2",25,0)
 I $G(PSORX("DFLG")) G EXIT
"RTN","PSODDPR2",26,0)
 I $O(^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",""))]"" D  G EXIT:PSODLQT  I ($Y+5)>IOSL W @IOF
"RTN","PSODDPR2",27,0)
 .S NODDERR=1 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR
"RTN","PSODDPR2",28,0)
 .I ($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT Q
"RTN","PSODDPR2",29,0)
 .D HD() Q:$G(PSODLQT)  W !,"Drug Interaction Error(s):",! S CT=0,ON=""
"RTN","PSODDPR2",30,0)
 .F  S ON=$O(^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON)) Q:ON=""  F  S CT=$O(^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON,CT)) Q:'CT  D
"RTN","PSODDPR2",31,0)
 ..Q:$G(NODDERR)&($P(ON,";")'="Z")
"RTN","PSODDPR2",32,0)
 ..W ?5,$S($P(ON,";")="N":"",$P(ON,";")="R":"Remote Rx for ",$P(ON,";")="O":"Local Rx for ",1:"Prospective Rx for ")
"RTN","PSODDPR2",33,0)
 ..W " "_^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON,CT,"MSG"),!,"   "_^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON,CT,"TEXT"),!
"RTN","PSODDPR2",34,0)
 ..D HD() Q:$G(PSODLQT)
"RTN","PSODDPR2",35,0)
 ;therapy
"RTN","PSODDPR2",36,0)
THER I '$O(^TMP($J,LIST,"OUT","THERAPY",0)) G EXIT
"RTN","PSODDPR2",37,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$P(PSOPAR,"^",2),$G(PSOTECCK) G EXIT
"RTN","PSODDPR2",38,0)
 D NSRT1^PSODDPR5 K ZPSODCTH ;PSO*7*411
"RTN","PSODDPR2",39,0)
 N ON,DDTH,CLASS,QTHER,ZDRG,ZTHER K DUPT,THER,THERO,SUB,ZOT,ZCLASS,CDDT,ZPSODCTH I '$P(PSOPAR,"^",10) D NOCAN^PSODDPR7 G ERR ;PSO*7*411
"RTN","PSODDPR2",40,0)
 ;W @IOF,"Z"_PSONULN1,! S (SUB,CT,LST,PSOZZ)=0 S (CDDT,THER)=1,THERO=0,QTHER=1 K RXDT ;PSO*7*411
"RTN","PSODDPR2",41,0)
 W @IOF S (SUB,CT,LST,PSOZZ)=0 S (CDDT,THER)=1,THERO=0,QTHER=1 K RXDT ;PSO*7*411
"RTN","PSODDPR2",42,0)
 F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY",CT)) Q:'CT!$G(PSODLQT)  F  S SUB=$O(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB)) Q:'SUB!$G(PSODLQT)  S ON=$P(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB),"^") D
"RTN","PSODDPR2",43,0)
 .I $G(PSODCTH(ON)) Q
"RTN","PSODDPR2",44,0)
 .S RXREC=$P(ON,";",2)
"RTN","PSODDPR2",45,0)
 .I $P(ON,";")="Z" Q
"RTN","PSODDPR2",46,0)
 .I $P(ON,";")="N",$G(^TMP($J,"PSONVADD",RXREC,0)) Q
"RTN","PSODDPR2",47,0)
 .I $P(ON,";")="R",$G(^TMP($J,"PSORMDD",RXREC,0)) Q
"RTN","PSODDPR2",48,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR2",49,0)
 .I $P(ON,";")="P",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR2",50,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDD",$J,RXREC,0)) Q
"RTN","PSODDPR2",51,0)
 .S ZOT=$S($P(ON,";")["C":1,$P(ON,";")="O":2,$P(ON,";")="R":3,$P(ON,";")="P":4,1:5)
"RTN","PSODDPR2",52,0)
 .I $P(ON,";")="P" D  ;PSO*7*411
"RTN","PSODDPR2",53,0)
 ..I $G(ZPSODCTH($P(ON,";",2))) Q
"RTN","PSODDPR2",54,0)
 ..I '$P(^PS(52.41,$P(ON,";",2),0),"^",9) S ZDRG=$P(^PS(50.7,$P(^PS(52.41,$P(ON,";",2),0),"^",8),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR2",55,0)
 ..E  S ZDRG=$P(^PSDRUG($P(^PS(52.41,$P(ON,";",2),0),"^",9),0),"^")
"RTN","PSODDPR2",56,0)
 ..S ZPSODCTH(ON)=$P(ON,";",2)_";PS(52.41"
"RTN","PSODDPR2",57,0)
 .I $P(ON,";")="O" D
"RTN","PSODDPR2",58,0)
 ..I $G(ZPSODCTH($P(ON,";",2))) Q  ;PSO*7*411
"RTN","PSODDPR2",59,0)
 ..S ZDRG=$P(^PSDRUG($P(^PSRX($P(ON,";",2),0),"^",6),0),"^")
"RTN","PSODDPR2",60,0)
 .I $P(ON,";")="N" D
"RTN","PSODDPR2",61,0)
 ..I $G(ZPSODCTH($P(ON,";",2))) Q  ;PSO*7*411
"RTN","PSODDPR2",62,0)
 ..S DUPRX0=^PS(55,PSODFN,"NVA",$P(ON,";",2),0)
"RTN","PSODDPR2",63,0)
 ..S ZPSODCTH(ON)="N;"_$P(ON,";",2)
"RTN","PSODDPR2",64,0)
 ..I '$P(DUPRX0,"^",2) S ZDRG=$P(^PS(50.7,$P(DUPRX0,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^") Q
"RTN","PSODDPR2",65,0)
 ..S ZDRG=$P(^PSDRUG($P(DUPRX0,"^",2),0),"^")
"RTN","PSODDPR2",66,0)
 .I $P(ON,";")="R" D
"RTN","PSODDPR2",67,0)
 ..Q:'$D(^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2)))
"RTN","PSODDPR2",68,0)
 ..I $G(ZPSODCTH($P(ON,";",2))) Q  ;PSO*7*411
"RTN","PSODDPR2",69,0)
 ..S RXREC=^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2)),ZDRG=$P(RXREC,"^",3)
"RTN","PSODDPR2",70,0)
 ..S ZPSODCTH(ON)="R;"_$P(RXREC,"^",5)_";"_$P(RXREC,"^")_"^"_$P(RXREC,"^",3)_"^"_$P(RXREC,"^",2)
"RTN","PSODDPR2",71,0)
 .I $E($P(ON,";"))["C" D  ;PSO*7*411; PIECE 1 of ON can be C1 for IV file 55, C2 for UD file 55, C3 for IV file 53.1 or C4 for UD file 53.1
"RTN","PSODDPR2",72,0)
 ..S ZPSODCTH(ON)=1,RXREC=^TMP($J,LIST,"IN","PROFILE",ON),ZMED=$P(RXREC,U,3),ZDRG=$P(RXREC,U,4) Q:$D(ZTHER(ZOT_"^"_ZDRG_"^"_ON))  ; clinic order
"RTN","PSODDPR2",73,0)
 ..S ZPSODCTH(ON)=$S($P(ON,";")[1!$P(ON,";")[4:"V",1:"U")_";"_$P(ON,";",2)
"RTN","PSODDPR2",74,0)
 .S:$D(ZDRG) ZTHER(ZOT_"^"_ZDRG_"^"_ON,SUB)=ON K ZDRG
"RTN","PSODDPR2",75,0)
THER2 ;
"RTN","PSODDPR2",76,0)
 G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",77,0)
 I $O(ZTHER(""))]"" D
"RTN","PSODDPR2",78,0)
 .S (PSODUPF,PSODUPC,PSODUPC1,PSOTSUB)="" F  S PSODUPF=$O(ZTHER(PSODUPF)) Q:PSODUPF=""  F  S PSOTSUB=$O(ZTHER(PSODUPF,PSOTSUB)) Q:PSOTSUB=""  S PSODUPC1=PSODUPC1+1
"RTN","PSODDPR2",79,0)
 .;get line counts for each duplicate therapy by setting PSODUPF=1 and calling DUPCL to execute therapy code without actually displaying info. ; no breaks in the middle of displaying individual dup therapies.
"RTN","PSODDPR2",80,0)
 .S PSODUPF=1,PSODUPC=0,PSODUPC("CLASS")="" D DUPCL S PSODUPF=0
"RTN","PSODDPR2",81,0)
 .;set PSODUPF=0 then call DUPCL to actually print the duplicate therapies.
"RTN","PSODDPR2",82,0)
 .D DUPCL K DDTH,PSODUPC,PSODUPF,PSODUPC1,PSODUPC2
"RTN","PSODDPR2",83,0)
 G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",84,0)
 K PSODCTH,RXDT,PSOZZ,ZZHDR
"RTN","PSODDPR2",85,0)
 I $P(PSOPAR,"^",10),$O(^TMP($J,"PSODCOR",0)),'$G(PSODGCK) D  G EXIT:$G(PSODLQT) W !,PSONULN1,!  ;ME2-160687
"RTN","PSODDPR2",86,0)
 .D DCOR^PSODDPR3 K ^TMP($J,"PSODCOR")
"RTN","PSODDPR2",87,0)
 .D HD()
"RTN","PSODDPR2",88,0)
 E  I $D(^XUSEC("PSORPH",DUZ)) S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR W @IOF I '$G(PSODUPF),Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR2",89,0)
ERR I $O(^TMP($J,LIST,"OUT","THERAPY","ERROR",""))]"" D  S NODTERR=1 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR
"RTN","PSODDPR2",90,0)
 .D HD() Q:$G(PSODLQT)  W !,"Drug Therapy Error(s):",! S CT=0,ON=""
"RTN","PSODDPR2",91,0)
 .F  S ON=$O(^TMP($J,LIST,"OUT","THERAPY","ERROR",ON)) Q:ON=""!$G(PSODLQT)  F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY","ERROR",ON,CT)) Q:'CT!$G(PSODLQT)  D
"RTN","PSODDPR2",92,0)
 ..Q:$G(NODTERR)&($P(ON,";")'="Z")!$G(PSODLQT)
"RTN","PSODDPR2",93,0)
 ..D HD() Q:$G(PSODLQT)  W ?5,$S($P(ON,";")="P":"Pending Order: ",$P(ON,";")="N":"Non-VA Med Order: ",$P(ON,";")="R":"Remote Rx: ",$P(ON,";")="O":"Rx: ",1:"Prospective Rx: ")
"RTN","PSODDPR2",94,0)
 ..D HD() Q:$G(PSODLQT)  W " "_^TMP($J,LIST,"OUT","THERAPY","ERROR",ON,CT,"MSG"),!,"   "_^TMP($J,LIST,"OUT","THERAPY","ERROR",ON,CT,"TEXT"),!
"RTN","PSODDPR2",95,0)
 K ZON,ZPSOCTH,ZDDT
"RTN","PSODDPR2",96,0)
 I $O(^TMP($J,LIST,"OUT","THERAPY","ERROR",""))]"" S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT Q:$G(PSODLQT)
"RTN","PSODDPR2",97,0)
 D HD()
"RTN","PSODDPR2",98,0)
EXIT ;
"RTN","PSODDPR2",99,0)
 D ^PSOBUILD
"RTN","PSODDPR2",100,0)
 K DSPL,CAN,DA,DIR,DNM,DUPRX0,ISSD,J,LSTFL,MSG,PHYS,PSOCLC,PSONULN,REA,RFLS,RX0,RX2,RXN,RXREC,ST,Y,ZZ,ACT,PSOCLOZ,PSOLR,PSOLDT,PSOCD,SIG,ZCT,ZZCT,ZZZCT,CDDT ;PSO*7*411
"RTN","PSODDPR2",101,0)
 K IT,LST,THER,THERO,^UTILITY($J),DGI,SER,SEV,SERS,BSIG,I,NODDERR,NODTERR,PDRG,DRGI,STATUS,^UTILITY($J,"W"),X,ZX,DIWL,DIWR,DIWF,THER,THERO,PSOINTV,ZTHER,PSOVORD,PSODCTH,ZZDGDG,ZZDGDG2,ZZHDR
"RTN","PSODDPR2",102,0)
 Q
"RTN","PSODDPR2",103,0)
 ;
"RTN","PSODDPR2",104,0)
RX D HD() Q:$G(PSODLQT)  W ! S RXREC=$P(ON,";",2)
"RTN","PSODDPR2",105,0)
 S DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),STATUS=+$G(^PSRX(RXREC,"STA"))
"RTN","PSODDPR2",106,0)
 S RXRECLOC=$G(RXREC)
"RTN","PSODDPR2",107,0)
 S J=RXREC D STAT^PSOFUNC K RX0,RX2
"RTN","PSODDPR2",108,0)
 I $P($G(^PS(53,+$P($G(PSORX("PATIENT STATUS")),"^"),0)),"^")["AUTH ABS"!($G(PSORX("PATIENT STATUS"))["AUTH ABS")&'$P(PSOPAR,"^",5) W !,"PATIENT ON AUTHORIZED ABSENCE!" K RXRECLOC Q
"RTN","PSODDPR2",109,0)
 I STATUS>10,STATUS'=16 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR W @IOF S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT,DIRUT,RXRECLOC Q
"RTN","PSODDPR2",110,0)
 I '$P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("DFLG")=1 K RXRECLOC Q
"RTN","PSODDPR2",111,0)
 I $P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("DFLG")=1 K RXRECLOC Q
"RTN","PSODDPR2",112,0)
 I STATUS=16 W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! K DUP,RXRECLOC S PSORX("DFLG")=1 Q
"RTN","PSODDPR2",113,0)
 D PSOL^PSSLOCK(RXRECLOC) I '$G(PSOMSG) D  K PSOMSG,DIR,DUP,RXRECLOC S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSODDPR2",114,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2),! Q
"RTN","PSODDPR2",115,0)
 .W !!,"Another person is editing Rx #"_$P($G(^PSRX(RXREC,0)),"^"),!
"RTN","PSODDPR2",116,0)
 K PSOMSG S DIR("A")=$S(STATUS=12:"Reinstate",1:"Discontinue")_" RX # "_$P(^PSRX(RXREC,0),"^"),DIR(0)="Y",DIR("?")="Enter Y to "_$S(STATUS=12:"reinstate",1:"discontinue")_" this RX."
"RTN","PSODDPR2",117,0)
 D ^DIR K DIR S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 Q:$G(PSODLQT)
"RTN","PSODDPR2",118,0)
 S DA=RXREC S ACT=$S($D(SPCANC):"Reinstated during Rx cancel.",1:$S(STATUS=12:"Reinstated",1:"Discontinued")_" while "_$S('$G(PSONV):"entering",1:"verifying")_" new RX")
"RTN","PSODDPR2",119,0)
 D CMOP^PSOUTL I $G(CMOP("S"))="L" W !,"A CMOP Rx cannot be discontinued during transmission!",! S Y=0 K CMOP
"RTN","PSODDPR2",120,0)
 I 'Y W $C(7)," -Prescription was not "_$S(STATUS=12:"reinstated",1:"discontinued")_"..." D  Q
"RTN","PSODDPR2",121,0)
 .S:'$D(PSOCLC) PSOCLC=DUZ S MSG=ACT,REA=$S(STATUS=12:"R",1:"C") S:$G(DUP) PSORX("DFLG")=1 K DUP
"RTN","PSODDPR2",122,0)
 .I $D(^TMP("PSORXDC",$J,RXREC,0)) K ^TMP("PSORXDC",$J,RXREC,0)
"RTN","PSODDPR2",123,0)
 S PSOCLC=DUZ,MSG=$S($G(MSG)]"":MSG,1:ACT_" During New RX "_$S('$G(PSONV):"Entry",1:"Verification")_" - Duplicate Rx"),REA=$S(STATUS=12:"R",1:"C")
"RTN","PSODDPR2",124,0)
 W !!,"THERAPEUTIC DUPLICATIONS will be discontinued after the acceptance of the new order.",!!
"RTN","PSODDPR2",125,0)
 S ^TMP("PSORXDC",$J,RXREC,0)="52^"_DA_"^"_MSG_"^"_REA_"^"_ACT_"^"_ST_"^"_DRG,PSONOOR="D"
"RTN","PSODDPR2",126,0)
 K RXRECLOC,DUP,CLS,PSONOOR,STATUS,ACT,PSONV,REA,SPCANC
"RTN","PSODDPR2",127,0)
 Q
"RTN","PSODDPR2",128,0)
 ;
"RTN","PSODDPR2",129,0)
DUPCL ;
"RTN","PSODDPR2",130,0)
 Q:$G(PSODLQT)
"RTN","PSODDPR2",131,0)
 S:$G(PSODUPF) PSODUPC=PSODUPC+1 W:'$G(PSODUPF) @IOF,PSONULN1,!
"RTN","PSODDPR2",132,0)
 I '$G(PSODUPF) W "*** THERAPEUTIC DUPLICATION(S) *** "_PSODRUG("NAME")_" with"
"RTN","PSODDPR2",133,0)
 S:$G(PSODUPF) PSODUPC=PSODUPC+1 N PSODUPCT,PSODUPC2,PSODUPCL
"RTN","PSODDPR2",134,0)
 S (PSODUPC2,PSODUPCT)=0 S:'$G(PSODUPF) PSODUPCT=2
"RTN","PSODDPR2",135,0)
 ;displays order and therapy
"RTN","PSODDPR2",136,0)
 K DDTH S (PSODUPCL,ZSUB,ZCT,PSODSEQ)=""
"RTN","PSODDPR2",137,0)
 F  S ZCT=$O(ZTHER(ZCT)) Q:ZCT=""!($G(PSODLQT))  F  S PSODSEQ=$O(ZTHER(ZCT,PSODSEQ)) Q:PSODSEQ=""!($G(PSODLQT))  S ON=ZTHER(ZCT,PSODSEQ) D
"RTN","PSODDPR2",138,0)
 .S PDODCNT=0,PSODUPC2=PSODUPC2+1 I $G(PSODUPF) S PSODUPC(ZCT)=0
"RTN","PSODDPR2",139,0)
 .I PSODUPC2=PSODUPC2+1
"RTN","PSODDPR2",140,0)
 .I '$G(PSODUPF) D
"RTN","PSODDPR2",141,0)
 ..I PSODUPC2=PSODUPC1,(PSODUPCT+PSODUPC(ZCT)+PSODUPC("CLASS"))>22 D HD(15) Q:$G(PSODLQT)  S PSODUPCT=0
"RTN","PSODDPR2",142,0)
 ..I (PSODUPCT+PSODUPC(ZCT))>22 D HD(15) Q:$G(PSODLQT)  S PSODUPCT=0
"RTN","PSODDPR2",143,0)
 ..S PSODUPCT=PSODUPCT+PSODUPC(ZCT)
"RTN","PSODDPR2",144,0)
 .I $P(ON,";")="O" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! S THER=1 D DDRX^PSODDPR8 D
"RTN","PSODDPR2",145,0)
 ..Q:STATUS>5&(STATUS'=16)
"RTN","PSODDPR2",146,0)
 ..Q:$G(^TMP("PSORXDC",$J,RXREC,0))]""
"RTN","PSODDPR2",147,0)
 ..Q:$G(RXDT("O",RXREC))
"RTN","PSODDPR2",148,0)
 ..S RX0=^PSRX(RXREC,0),J=RXREC,RX2=^PSRX(RXREC,2) D STAT^PSOFUNC K RX0,RX2
"RTN","PSODDPR2",149,0)
 ..S PSOZZ=PSOZZ+1,^TMP($J,"PSODCOR",PSOZZ)="52"_"^"_RXREC_"^"_ST_"^"_DRGNM,RXDT("O",RXREC)=1
"RTN","PSODDPR2",150,0)
 .I $P(ON,";")="N" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! D ^PSODDPR3
"RTN","PSODDPR2",151,0)
 .I $P(ON,";")="P" D
"RTN","PSODDPR2",152,0)
 ..; PSO*7*411
"RTN","PSODDPR2",153,0)
 ..D HD(8) Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! S RXREC=$P(ON,";",2),THER=1 D PEND^PSODDPR8
"RTN","PSODDPR2",154,0)
 ..Q:$G(^TMP("PSORXDC",$J,RXREC,0))]""
"RTN","PSODDPR2",155,0)
 ..Q:$G(RXDT("P",RXREC))
"RTN","PSODDPR2",156,0)
 ..S PSOZZ=PSOZZ+1,DUPRX0=^PS(52.41,RXREC,0)
"RTN","PSODDPR2",157,0)
 ..S ^TMP($J,"PSODCOR",PSOZZ)="P"_"^"_RXREC_"^^"_$S($P(DUPRX0,"^",9):$P(^PSDRUG($P(DUPRX0,"^",9),0),"^"),1:$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^",2),0),"^"))
"RTN","PSODDPR2",158,0)
 ..S ^TMP($J,"PSODCOR",PSOZZ)=^TMP($J,"PSODCOR",PSOZZ)_"^"_$S('$P(DUPRX0,"^",9):$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^",2),0),"^"),1:$P(^PSDRUG($P(DUPRX0,"^",9),0),"^"))
"RTN","PSODDPR2",159,0)
 ..S RXDT("P",RXREC)=1
"RTN","PSODDPR2",160,0)
 .I $P(ON,";")="R" S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! D RDI^PSODDPR3 D HD() Q:$G(PSODLQT)
"RTN","PSODDPR2",161,0)
 .I $E($P(ON,";"))="C" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! D DUP^PSODDPR7  ; clinic order
"RTN","PSODDPR2",162,0)
 .I $O(ZTHER(ZCT,PSODSEQ))'="" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,PSONULN
"RTN","PSODDPR2",163,0)
 D CLASSES^PSODDPR3
"RTN","PSODDPR2",164,0)
 ;format therapy classes pso*7*411
"RTN","PSODDPR2",165,0)
 N X S (ZCT,ZZCT,ZZZCT)=0
"RTN","PSODDPR2",166,0)
 F  S ZZCT=$O(^TMP($J,LIST,"OUT","THERAPY",ZZCT)) Q:'ZZCT  S ZCT=0 F  S ZCT=$O(^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT)) Q:'ZCT  D
"RTN","PSODDPR2",167,0)
 .;S X=^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT,"CLASS")  ; ME2 - 1602256
"RTN","PSODDPR2",168,0)
 .S X=^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT,"CLASS")_$S($O(^TMP($J,LIST,"OUT","THERAPY",ZZCT))!($O(^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT))):", ",1:"")
"RTN","PSODDPR2",169,0)
 Q:$G(PSODLQT)!($D(^XUSEC("PSORPH",DUZ)))
"RTN","PSODDPR2",170,0)
 I '$G(PSODUPF),'$D(^XUSEC("PSORPH",DUZ)) D
"RTN","PSODDPR2",171,0)
 .S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR W @IOF
"RTN","PSODDPR2",172,0)
 .I '$G(PSODUPF),Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR2",173,0)
 .I '$G(PSODUPF),($Y+5)>IOSL W @IOF
"RTN","PSODDPR2",174,0)
 Q
"RTN","PSODDPR2",175,0)
INT ;
"RTN","PSODDPR2",176,0)
 Q:$D(PSSDIUTL)
"RTN","PSODDPR2",177,0)
 D INT^PSODDPR5
"RTN","PSODDPR2",178,0)
 Q
"RTN","PSODDPR2",179,0)
HD(PSOLINES,OVRRID) ;
"RTN","PSODDPR2",180,0)
 S:'$G(PSODLQT) PSODLQT=0  S:'$G(OVRRID) OVRRID=0 S:'$G(PSOLINES) PSOLINES=5
"RTN","PSODDPR2",181,0)
 I '$G(OVRRID),$G(PSODLQT)!(($Y+PSOLINES)'>IOSL) Q
"RTN","PSODDPR2",182,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODDPR2",183,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press return to continue" D ^DIR K DIR
"RTN","PSODDPR2",184,0)
 K PSOLINES,OVRRID
"RTN","PSODDPR2",185,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR2",186,0)
 W:'$G(PSODUPF) @IOF
"RTN","PSODDPR2",187,0)
 Q
"RTN","PSODDPR2",188,0)
 ;
"RTN","PSODDPR2",189,0)
DGSORT ;
"RTN","PSODDPR2",190,0)
 ;this sort is used in monograph and clinic effects display so that they are displayed once per VA generic drug
"RTN","PSODDPR2",191,0)
 S (SEV,TYP,PSOVAG,PSONAM)="" F  S SEV=$O(ZZDGDG3(SEV)) Q:SEV=""  F  S PSOVAG=$O(ZZDGDG3(SEV,PSOVAG)) Q:PSOVAG=""  D
"RTN","PSODDPR2",192,0)
 .S COUNT2=0 F  S PSONAM=$O(ZZDGDG3(SEV,PSOVAG,PSONAM)) Q:PSONAM=""  S COUNT2=COUNT2+1,ZZDGDG2(SEV,PSOVAG)=COUNT2
"RTN","PSODDPR2",193,0)
 K COUNT2,PSONAM
"RTN","PSODDPR2",194,0)
 Q
"RTN","PSODGAL3")
0^2^B175130072^B172651497
"RTN","PSODGAL3",1,0)
PSODGAL3 ; BIR/LC,SAB,CMF - enhanced DRUG ALLERGY REACTION CHECKING continued ;12/09/07  02:22
"RTN","PSODGAL3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**411,458**;DEC 1997;Build 2
"RTN","PSODGAL3",3,0)
 ;External reference to ^XTMP("ORRDI" supported by DBIA 4659
"RTN","PSODGAL3",4,0)
 ;
"RTN","PSODGAL3",5,0)
SORTN ;
"RTN","PSODGAL3",6,0)
 N STYP,INGLOC,ZALL,ZLOC,ZCDATE,PSOSYM,PSOCDATE,PSOCA2,INGREDS,PSOREACT,PSOSDATA,SEVT,PSOAFLG,INGRED,PSOACNT,PSOAFEND
"RTN","PSODGAL3",7,0)
 N INGREDS,INGREDZ,ZXX,PSOSSITE,PSOSARRY,SETTMP,PSOLOC,ZCNT,ZING,ZMSG,PSOATYPE,PSODGCLS,PSODGCL,PSODGCL1 K ZGMRA
"RTN","PSODGAL3",8,0)
 S ZCNT=0
"RTN","PSODGAL3",9,0)
 ;
"RTN","PSODGAL3",10,0)
 I $G(PSOTSTMD) D TSTREM
"RTN","PSODGAL3",11,0)
 ;  
"RTN","PSODGAL3",12,0)
 K PSOSORT,PSOSEV,PSOSEVP,PSOSTYP,PSOCAGNT,PSOCA
"RTN","PSODGAL3",13,0)
 S (ZALL,ZING,ZMSG,PSOSYMS)=""
"RTN","PSODGAL3",14,0)
 ;DRUG INGREDIENTS
"RTN","PSODGAL3",15,0)
 F  S ZMSG=$O(GMRARSLT(ZMSG)) Q:ZMSG=""  D 
"RTN","PSODGAL3",16,0)
 .S ZALL=$$GMSGPTR^PSODGAL1(ZMSG)
"RTN","PSODGAL3",17,0)
 .Q:ZALL=""
"RTN","PSODGAL3",18,0)
 .S PSODRCL=0
"RTN","PSODGAL3",19,0)
 .S PSOATYPE=2
"RTN","PSODGAL3",20,0)
 .S:$D(GMRARSLT(ZMSG,"MESSAGE","OFFENDERS","CLS")) PSODRCL=1,PSOATYPE=1
"RTN","PSODGAL3",21,0)
 .D SORTM
"RTN","PSODGAL3",22,0)
 .Q
"RTN","PSODGAL3",23,0)
 D TMP
"RTN","PSODGAL3",24,0)
 Q
"RTN","PSODGAL3",25,0)
 ;
"RTN","PSODGAL3",26,0)
SORTM ;
"RTN","PSODGAL3",27,0)
 N SITEARY,PSOONEA,ZSITES,ZSITE,ZYALL
"RTN","PSODGAL3",28,0)
 S (PSOSEV,PSOSEVT,PSOSTYP,PSOLOC,PSOSYM,INGREDS,PSOREACT,INGLOC,PSOSDATA,PSOSSITE,PSOSITT)=""
"RTN","PSODGAL3",29,0)
 S PSOSSITE=$P(GMRARSLT(ZMSG,ZALL),U)
"RTN","PSODGAL3",30,0)
 S PSOLOC=PSOSSITE_"|"_$P(GMRARSLT(ZMSG,ZALL),U)
"RTN","PSODGAL3",31,0)
 S PSOSEV=$$GETSEV(PSOSSITE,ZMSG,.GMRARSLT)
"RTN","PSODGAL3",32,0)
 S PSOSEVT=$S(PSOSEV="SEVERE":1,PSOSEV="MODERATE":2,PSOSEV="MILD":3,1:99)
"RTN","PSODGAL3",33,0)
 S PSOSEVP=PSOSEV
"RTN","PSODGAL3",34,0)
 S PSOSTYP=PSOSEVT
"RTN","PSODGAL3",35,0)
 S:PSOSEVT=1 PSOSEVT1("S")=1
"RTN","PSODGAL3",36,0)
 S ZSITES=GMRARSLT(ZMSG,"MESSAGE",1)
"RTN","PSODGAL3",37,0)
 S PSOSDATA=""
"RTN","PSODGAL3",38,0)
 S ZYALL=""
"RTN","PSODGAL3",39,0)
 F ZSITE=1:1:ZSITES D 
"RTN","PSODGAL3",40,0)
 .S ZYALL=$$GMSGPTR^PSODGAL1(ZMSG,ZYALL)
"RTN","PSODGAL3",41,0)
 .S INGLOC=$S($P(GMRARSLT(ZMSG,ZYALL),U,2)="L":"L",1:"R")
"RTN","PSODGAL3",42,0)
 .S PSOCDATE=$P($P(GMRARSLT(ZMSG,ZYALL),U,3),".")
"RTN","PSODGAL3",43,0)
 .S PSOCDATE=$E(PSOCDATE,4,5)_"/"_$E(PSOCDATE,6,7)_"/"_$E(PSOCDATE,2,3)
"RTN","PSODGAL3",44,0)
 .S PSOSYM=$P(GMRARSLT(ZMSG,ZYALL),U,5)
"RTN","PSODGAL3",45,0)
 .S PSOREACT=$P(GMRARSLT(ZMSG,"MESSAGE",2),U,2)
"RTN","PSODGAL3",46,0)
 .S PSOSITT=$P(GMRARSLT(ZMSG,ZYALL),U)
"RTN","PSODGAL3",47,0)
 .S PSOSDATA=ZMSG_"|"_PSOCDATE_"|"_INGLOC_"|"_PSOSITT
"RTN","PSODGAL3",48,0)
 .;S PSOSDATA=PSOSDATA_$S(ZSITE=1:"",1:U)_ZMSG_"|"_PSOCDATE_"|"_INGLOC_"|"_PSOSITT
"RTN","PSODGAL3",49,0)
 .S SITEARY=""
"RTN","PSODGAL3",50,0)
 .S SITEARY=INGLOC_"|"_$E(PSOSSITE,1,16)_"|"_PSOSITT_"|"_$S($D(^DIC(4,PSOSITT)):PSOSITT,1:"")
"RTN","PSODGAL3",51,0)
 .S PSOSARRY(PSOSTYP,SITEARY,PSOATYPE,PSOREACT,ZMSG)=$S(PSOATYPE=1:PSOREACT,1:"")
"RTN","PSODGAL3",52,0)
 .;
"RTN","PSODGAL3",53,0)
 .D:$D(PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE)) 
"RTN","PSODGAL3",54,0)
 ..S (OLDDATA,PSOCA)=""
"RTN","PSODGAL3",55,0)
 ..S OLDDATA=PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE)
"RTN","PSODGAL3",56,0)
 ..D:OLDDATA'[PSOSDATA 
"RTN","PSODGAL3",57,0)
 ...S PSOCA=PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE)_"^"_PSOSDATA
"RTN","PSODGAL3",58,0)
 ...S PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE)=PSOCA
"RTN","PSODGAL3",59,0)
 .D:'$D(PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE)) 
"RTN","PSODGAL3",60,0)
 ..S PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE)=PSOSDATA
"RTN","PSODGAL3",61,0)
 .D SYM
"RTN","PSODGAL3",62,0)
 .;
"RTN","PSODGAL3",63,0)
 .F INGREDZ="CLS","ING" D 
"RTN","PSODGAL3",64,0)
 ..S (INGRED,INGREDS)="",INGREDS=$G(GMRARSLT(ZMSG,"MESSAGE","OFFENDERS",INGREDZ))
"RTN","PSODGAL3",65,0)
 ..N III F III=1:1 S INGRED=$P(INGREDS,"~",III) Q:INGRED=""  D 
"RTN","PSODGAL3",66,0)
 ...S PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE,INGRED)=""
"RTN","PSODGAL3",67,0)
 ...Q:INGREDZ="ING"
"RTN","PSODGAL3",68,0)
 ...I $G(PSODRCL) S PSODRCL1(PSOSTYP,PSOREACT,PSOATYPE,INGRED)="" K PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE,INGRED)
"RTN","PSODGAL3",69,0)
 Q
"RTN","PSODGAL3",70,0)
 ;
"RTN","PSODGAL3",71,0)
SYM ; 
"RTN","PSODGAL3",72,0)
 I PSOSYM'["~"&(PSOSYM'="")&(PSOSYM'="|") D  Q
"RTN","PSODGAL3",73,0)
 .S PSOSYM("Name")=$$GETSYMNM(ZYALL,PSOSYM,1)
"RTN","PSODGAL3",74,0)
 .Q:PSOSYM("Name")=""
"RTN","PSODGAL3",75,0)
 .S PSOSYMS(PSOSTYP,PSOREACT,PSOATYPE,"ZZZSYMPTOMS",PSOSYM("Name"))=PSOSYM
"RTN","PSODGAL3",76,0)
 .S PSOSARRY(PSOSTYP,SITEARY,PSOATYPE,PSOREACT,ZMSG,"ZZZSYMPTOMS",PSOSYM("Name"))=PSOSYM
"RTN","PSODGAL3",77,0)
 Q:PSOSYM="|"
"RTN","PSODGAL3",78,0)
 N PSOQX,PSOY
"RTN","PSODGAL3",79,0)
 I $E(PSOSYM,1)="~" S PSOSYM=$E(PSOSYM,2,9999)
"RTN","PSODGAL3",80,0)
 F PSOQX=1:1:$L(PSOSYM,"~") D 
"RTN","PSODGAL3",81,0)
 .S PSOY=$P(PSOSYM,"~",PSOQX)
"RTN","PSODGAL3",82,0)
 .Q:PSOY=""
"RTN","PSODGAL3",83,0)
 .S PSOSYM("Name")=$$GETSYMNM(ZYALL,PSOY,PSOQX)
"RTN","PSODGAL3",84,0)
 .Q:PSOSYM("Name")=""
"RTN","PSODGAL3",85,0)
 .S PSOSYMS(PSOSTYP,PSOREACT,PSOATYPE,"ZZZSYMPTOMS",PSOSYM("Name"))=PSOY
"RTN","PSODGAL3",86,0)
 .S PSOSARRY(PSOSTYP,SITEARY,PSOATYPE,PSOREACT,ZMSG,"ZZZSYMPTOMS",PSOSYM("Name"))=PSOY
"RTN","PSODGAL3",87,0)
 Q
"RTN","PSODGAL3",88,0)
 ;
"RTN","PSODGAL3",89,0)
TMP ;
"RTN","PSODGAL3",90,0)
 ;PSOPAIEN - IEN TO PATIENT ALLERGY FILE 120.8
"RTN","PSODGAL3",91,0)
 N PSOSEVER,OLDDATA,PSOLCLAC,PSOPAIEN,TYPE,SITENM,PSOLCLAS,PSOLOCAL,PSOREACT,ZCNT2,DACNT,LOCREM,PSOATYP
"RTN","PSODGAL3",92,0)
 N PSOINSTL,PSOSTA,PSOHIS,PSOHISI,PSOASEV,PSOSEVI,PSOSEVT,PSOSTYP,PSOSTYPI,PSOMEDL,PSODGCL,PSOLOCI,SITE
"RTN","PSODGAL3",93,0)
 N PSOREACT,ZMSG
"RTN","PSODGAL3",94,0)
 S (TYPE,SITENM,PSOPAIEN,ZALL,PSOSYM,PSOLCLAC,PSOATYP,PSOSEVER,PSOATYPE,PSOREACT)="",(ZCNT2,DACNT)=0
"RTN","PSODGAL3",95,0)
 F  S PSOSEVER=$O(PSOSARRY(PSOSEVER)) Q:PSOSEVER=""  S TYPE="" F  S TYPE=$O(PSOSARRY(PSOSEVER,TYPE)) Q:TYPE=""  D 
"RTN","PSODGAL3",96,0)
 .S PSOATYPE=""
"RTN","PSODGAL3",97,0)
 .F  S PSOATYPE=$O(PSOSARRY(PSOSEVER,TYPE,PSOATYPE)) Q:PSOATYPE=""  S PSOREACT="" F  S PSOREACT=$O(PSOSARRY(PSOSEVER,TYPE,PSOATYPE,PSOREACT)) Q:PSOREACT=""  D 
"RTN","PSODGAL3",98,0)
 ..S ZMSG=""
"RTN","PSODGAL3",99,0)
 ..S ZMSG=$O(PSOSARRY(PSOSEVER,TYPE,PSOATYPE,PSOREACT,ZMSG))
"RTN","PSODGAL3",100,0)
 ..Q:ZMSG=""
"RTN","PSODGAL3",101,0)
 ..S PSOPAIEN=$$GMSGPTR^PSODGAL1(ZMSG) Q:PSOPAIEN=""  D 
"RTN","PSODGAL3",102,0)
 ...S (PSODRCL,ZALL,SITE,SITENM,LOCREM)=""
"RTN","PSODGAL3",103,0)
 ...S SITE=$P(TYPE,"|",3),LOCREM=$P(TYPE,"|"),SITENM=$P(TYPE,"|",2)
"RTN","PSODGAL3",104,0)
 ...S ZALL=GMRARSLT(ZMSG,PSOPAIEN)
"RTN","PSODGAL3",105,0)
 ...I PSOATYPE=2 S PSOATYP=2
"RTN","PSODGAL3",106,0)
 ...I PSOATYPE=1 S PSOATYP=1,PSODRCL=1
"RTN","PSODGAL3",107,0)
 ...Q:ZALL=""
"RTN","PSODGAL3",108,0)
 ...D TMPSET
"RTN","PSODGAL3",109,0)
 Q
"RTN","PSODGAL3",110,0)
 ;
"RTN","PSODGAL3",111,0)
TMPSET ;
"RTN","PSODGAL3",112,0)
 S DACNT=DACNT+1 N II,III,PTR,DATEI K SETTMP
"RTN","PSODGAL3",113,0)
 S PSOHISI=$P(ZALL,U,8)
"RTN","PSODGAL3",114,0)
 S PSOSEVI=$$GETSEVI(ZALL)
"RTN","PSODGAL3",115,0)
 S PSODGCL="",PSOLOCAL=$P(ZALL,"^",3),PSOLOCI=$P($P(ZALL,"^",3),"|",2)
"RTN","PSODGAL3",116,0)
 S DATEI=$P(ZALL,U,3)
"RTN","PSODGAL3",117,0)
 S PTR=$P(ZALL,U,7)
"RTN","PSODGAL3",118,0)
 ;ZERO NODE OF DRUG ALLERGY MULTIPLE
"RTN","PSODGAL3",119,0)
 S SETTMP(DACNT,0)=$E(PSOREACT,1,64)_U_PTR_U_LOCREM_U_SITE
"RTN","PSODGAL3",120,0)
 S SETTMP(DACNT,0)=SETTMP(DACNT,0)_U_DATEI_U_$$UPPER(PSOHISI)_U_PSOSEVI
"RTN","PSODGAL3",121,0)
 S ^TMP("PSODAOC",$J,"ALLERGY",PSJALGCT,4,DACNT,0)=SETTMP(DACNT,0)
"RTN","PSODGAL3",122,0)
 ;DRUG CLASS
"RTN","PSODGAL3",123,0)
 I PSOATYP'=1 D 
"RTN","PSODGAL3",124,0)
 .S PSODGCL=$G(GMRARSLT(ZMSG,PSOPAIEN,"CLS"))
"RTN","PSODGAL3",125,0)
 .I $E(PSODGCL,1)="~" S PSODGCL=$E(PSODGCL,2,999)
"RTN","PSODGAL3",126,0)
 I PSOATYP=1 D 
"RTN","PSODGAL3",127,0)
 .S PSODGCLS=$G(GMRARSLT(ZMSG,PSOPAIEN,"CLS"))
"RTN","PSODGAL3",128,0)
 .I $E(PSODGCLS,1)="~" S PSODGCLS=$E(PSODGCLS,2,999)
"RTN","PSODGAL3",129,0)
 .S PSODGCL=""
"RTN","PSODGAL3",130,0)
 .N II
"RTN","PSODGAL3",131,0)
 .F II=1:1 S PSODGCL=$P(PSODGCLS,"~",II) Q:PSODGCL=""  D 
"RTN","PSODGAL3",132,0)
 ..S ^TMP("PSODAOC",$J,"ALLERGY",PSJALGCT,4,DACNT,1,II,0)=PSODGCL
"RTN","PSODGAL3",133,0)
 ..Q
"RTN","PSODGAL3",134,0)
 ;DRUG INGREDIENT
"RTN","PSODGAL3",135,0)
 D:$D(GMRARSLT(ZMSG,PSOPAIEN,"ING")) 
"RTN","PSODGAL3",136,0)
 .S INGREDS=GMRARSLT(ZMSG,PSOPAIEN,"ING")
"RTN","PSODGAL3",137,0)
 .I $E(INGREDS,1)="~" S INGREDS=$E(INGREDS,2,999)
"RTN","PSODGAL3",138,0)
 .N II
"RTN","PSODGAL3",139,0)
 .F II=1:1 S INGRED=$P(INGREDS,"~",II) Q:INGRED=""  D 
"RTN","PSODGAL3",140,0)
 ..S ^TMP("PSODAOC",$J,"ALLERGY",PSJALGCT,4,DACNT,2,II,0)=INGRED
"RTN","PSODGAL3",141,0)
 ..Q
"RTN","PSODGAL3",142,0)
 ;SIGN/SYMPTOM
"RTN","PSODGAL3",143,0)
 N PSOSYMN,SYMCNT S SYMCNT=0,PSOSYMN=""
"RTN","PSODGAL3",144,0)
 F  S PSOSYMN=$O(PSOSARRY(PSOSEVER,TYPE,PSOATYPE,PSOREACT,ZMSG,"ZZZSYMPTOMS",PSOSYMN)) Q:PSOSYMN=""  D 
"RTN","PSODGAL3",145,0)
 .S SYMCNT=SYMCNT+1
"RTN","PSODGAL3",146,0)
 .S ^TMP("PSODAOC",$J,"ALLERGY",PSJALGCT,4,DACNT,3,SYMCNT,0)=PSOSARRY(PSOSEVER,TYPE,PSOATYPE,PSOREACT,ZMSG,"ZZZSYMPTOMS",PSOSYMN)
"RTN","PSODGAL3",147,0)
 ;DISPENSE DRUG
"RTN","PSODGAL3",148,0)
 S ^TMP("PSODAOC",$J,"ALLERGY",PSJALGCT,"ALLERGY DD",5,1,0)=$S(PSOATYP=1!(PSOATYP=2):$G(PSODRUG("IEN")),PSOATYP=3:$P(ZALL,"^",2),1:"")
"RTN","PSODGAL3",149,0)
 S ^TMP("PSODAOC",$J,"ALLERGY",PSJALGCT,"ALLERGY PKG")=$S($G(PSJAOC):"IP",1:"OP")
"RTN","PSODGAL3",150,0)
 S ^TMP("PSODAOC",$J,"ALLERGY","PROVR")=""
"RTN","PSODGAL3",151,0)
END ;
"RTN","PSODGAL3",152,0)
 Q
"RTN","PSODGAL3",153,0)
 ;
"RTN","PSODGAL3",154,0)
GETSEV(PSOSSITE,ZMSG,GMRARSLT) ; return external highest severity for possible local multiple
"RTN","PSODGAL3",155,0)
 N RESULT,ARRAY,I,SEV
"RTN","PSODGAL3",156,0)
 S RESULT=""
"RTN","PSODGAL3",157,0)
 Q:'$D(GMRARSLT) RESULT
"RTN","PSODGAL3",158,0)
 Q:'$D(PSOSSITE) RESULT
"RTN","PSODGAL3",159,0)
 Q:'$D(GMRARSLT(ZMSG)) RESULT
"RTN","PSODGAL3",160,0)
 S I=0
"RTN","PSODGAL3",161,0)
 F  S I=$O(GMRARSLT(ZMSG,"MESSAGE",1,PSOSSITE,1,I)) Q:'I  D 
"RTN","PSODGAL3",162,0)
 .S SEV=$P($G(GMRARSLT(ZMSG,"MESSAGE",1,PSOSSITE,1,I)),U,2)
"RTN","PSODGAL3",163,0)
 .S ARRAY($S(SEV="SEVERE":1,SEV="MODERATE":2,SEV="MILD":3,1:99))=SEV
"RTN","PSODGAL3",164,0)
 .Q
"RTN","PSODGAL3",165,0)
 I $D(ARRAY) S I=$O(ARRAY("")),RESULT=ARRAY(I)
"RTN","PSODGAL3",166,0)
 Q RESULT
"RTN","PSODGAL3",167,0)
 ;;
"RTN","PSODGAL3",168,0)
GETSEVI(ZALL) ; return internal highest severity for possible local multiple
"RTN","PSODGAL3",169,0)
 N RESULT,ARRAY,I,J,K,SEV
"RTN","PSODGAL3",170,0)
 S RESULT=""
"RTN","PSODGAL3",171,0)
 S SEV=$P($G(ZALL),U,4)
"RTN","PSODGAL3",172,0)
 I $E(SEV,1)="~" S SEV=$E(SEV,2,999)
"RTN","PSODGAL3",173,0)
 Q:SEV="" RESULT
"RTN","PSODGAL3",174,0)
 F I=1:1 S J=$P(SEV,"~",I) Q:J=""  D 
"RTN","PSODGAL3",175,0)
 .S K=$P(J,"|",2)
"RTN","PSODGAL3",176,0)
 .S:K'="" ARRAY(K)=J
"RTN","PSODGAL3",177,0)
 .Q
"RTN","PSODGAL3",178,0)
 I $D(ARRAY) S I=$O(ARRAY(""),-1),RESULT=I
"RTN","PSODGAL3",179,0)
 Q RESULT
"RTN","PSODGAL3",180,0)
 ;;
"RTN","PSODGAL3",181,0)
GETSYMNM(ZYALL,SYMIEN,SYMINC) ; getSymptomName(allergyResultIEN,symptomIEN,symptomIncrement)
"RTN","PSODGAL3",182,0)
 N RESULT
"RTN","PSODGAL3",183,0)
 S RESULT=""
"RTN","PSODGAL3",184,0)
 Q:$G(ZYALL)="" RESULT
"RTN","PSODGAL3",185,0)
 Q:$G(SYMIEN)="" RESULT
"RTN","PSODGAL3",186,0)
 Q:$G(SYMINC)="" RESULT
"RTN","PSODGAL3",187,0)
 Q:+SYMIEN'=30 $$GET1^DIQ(120.83,SYMIEN,.01)
"RTN","PSODGAL3",188,0)
 I +ZYALL=0 D  Q RESULT
"RTN","PSODGAL3",189,0)
 .;look at ^xtmp("orrdi","art" here for remote data 'OTHER REACTION' text
"RTN","PSODGAL3",190,0)
 .N ORRDIEN
"RTN","PSODGAL3",191,0)
 .S ORRDIEN=$P(ZYALL,"R",2)
"RTN","PSODGAL3",192,0)
 .Q:ORRDIEN=""
"RTN","PSODGAL3",193,0)
 .S:+$G(DFN) RESULT=$P($G(^XTMP("ORRDI","ART",DFN,ORRDIEN,"SIGNS/SYMPTOMS",SYMINC)),U,2)
"RTN","PSODGAL3",194,0)
 .Q
"RTN","PSODGAL3",195,0)
 I +ZYALL>0 D  Q RESULT
"RTN","PSODGAL3",196,0)
 .;call GMRADPT here, look at GMRAL for local data 'OTHER REACTION' text
"RTN","PSODGAL3",197,0)
 .N GMRAL
"RTN","PSODGAL3",198,0)
 .D ^GMRADPT
"RTN","PSODGAL3",199,0)
 .S RESULT=$P($G(GMRAL(ZYALL,"S",SYMINC)),";")
"RTN","PSODGAL3",200,0)
 .K GMRAL
"RTN","PSODGAL3",201,0)
 Q RESULT
"RTN","PSODGAL3",202,0)
 ;
"RTN","PSODGAL3",203,0)
UPPER(PSOUCS) ;
"RTN","PSODGAL3",204,0)
 Q $TR(PSOUCS,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSODGAL3",205,0)
 ;
"RTN","PSODGAL3",206,0)
TSTREM ;For remote developer testing
"RTN","PSODGAL3",207,0)
 ;1. complex mix of local/remote results: set a break at SORTN^PSODGAL3, results will not match the order but will be the complex dummy for all, at the break set S PSOTSTMD=1, type G for Go.
"RTN","PSODGAL3",208,0)
 ;2. Multiple Ingredient allergy:  set a break at SORTN^PSODGAL3, order PROPOFOL, and at the break set S PSOTSTMD=3, type G for Go.
"RTN","PSODGAL3",209,0)
 ;3. Drug class allergy:  set up allergy by drug class ANTILIPEMIC AGENTS and order LIPITOR and at the break set S PSOTSTMD=2, type G for Go.
"RTN","PSODGAL3",210,0)
 ;
"RTN","PSODGAL3",211,0)
 Q:'$G(PSOTSTMD)
"RTN","PSODGAL3",212,0)
 I PSOTSTMD=1 G BIGARRAY
"RTN","PSODGAL3",213,0)
 I PSOTSTMD=2 G DRGCLASS
"RTN","PSODGAL3",214,0)
 I PSOTSTMD=3 G MULTI
"RTN","PSODGAL3",215,0)
 ;
"RTN","PSODGAL3",216,0)
SINGLE ;Test Remote with a single ingredient
"RTN","PSODGAL3",217,0)
 ;ICR:           IEN     NAME          1       2            3                            4          5                 6                7                         8       9     10   11               
"RTN","PSODGAL3",218,0)
 ;PIECE:          1        2           3       4            5                            6          7                 8                9                        10      11     12   13        
"RTN","PSODGAL3",219,0)
 S GMRAING("R1")="GUAIFENESIN|744^MARTINSBURG VAMC|613^REMOTE|R^Jun 20, 2013@15:52|3130620.1552^SEVERE|3^DROWSINESS|66~HIVES|1~ANXIETY|39^GUAIFENESIN^GUAIFENESIN|1671;PSNDF(50.6,^HISTORICAL|h^VISTA|V"
"RTN","PSODGAL3",220,0)
 S GMRAING("R2")="GUAIFENESIN|744^HEARTLAND WEST VAMC|589^REMOTE|R^Aug 28, 2012@11:52|3120828.1552^SEVERE|3^DROWSINESS|66~HIVES|1^GUAIFENESIN^GUAIFENESIN|1671;PSNDF(50.6,^HISTORICAL|h^VISTA|V"
"RTN","PSODGAL3",221,0)
 S GMRAING("R3")="GUAIFENESIN|744^NEW ORLEANS, LA.|629^REMOTE|R^Oct 25, 2013@09:54|3131025.0954^MODERATE|2^DROWSINESS|66~HIVES|1^GUAIFENESIN^GUAIFENESIN|1671;PSNDF(50.6,^HISTORICAL|h^VISTA|V"
"RTN","PSODGAL3",222,0)
 S GMRAING("R4")="GUAIFENESIN|744^NEW YORK, NY|630^REMOTE|R^Apr 9, 2013@15:43|3130409.1143^MILD|1^DROWSINESS|66~HIVES|1^GUAIFENESIN^GUAIFENESIN|1671;PSNDF(50.6,^HISTORICAL|h^VISTA|V"
"RTN","PSODGAL3",223,0)
 Q
"RTN","PSODGAL3",224,0)
 ;
"RTN","PSODGAL3",225,0)
MULTI ;Test Remote with multiple ingredients
"RTN","PSODGAL3",226,0)
 S GMRAING("R7")="SODIUM METABISULFITE|69~PROPOFOL|2114~EGG|2361~SOYBEAN|3156~PEANUT|4048^HEARTLAND WEST VAMC|589^REMOTE|R^Oct 25, 2013@09:52|3131025.0952^SEVERVE|3^ANXIETY|39^PROPOFOL^PROPOFOL|2145;PSNDF(50.6,^OBSERVED|o^VISTA|V"
"RTN","PSODGAL3",227,0)
 S GMRAING("R8")="SODIUM METABISULFITE|69~PROPOFOL|2114~EGG|2361~SOYBEAN|3156~PEANUT|4048^MARTINSBURG VAMC|613^REMOTE|R^SEP 30, 2013@01:52|3130930.1352^SEVERVE|3^ANXIETY|39^PROPOFOL^PROPOFOL|2145;PSNDF(50.6,^OBSERVED|o^VISTA|V"
"RTN","PSODGAL3",228,0)
 S GMRAING("R10")="SODIUM METABISULFITE|69~PROPOFOL|2114~EGG|2361~SOYBEAN|3156~PEANUT|4048^NEW ORLEANS, LA.|629^REMOTE|R^Aug 15, 2013@11:52|3130515.1152^MODERATE|2^ANXIETY|39^PROPOFOL^PROPOFOL|2145;PSNDF(50.6,^OBSERVED|o^VISTA|V"
"RTN","PSODGAL3",229,0)
 S GMRAING("R11")="SODIUM METABISULFITE|69~PROPOFOL|2114~EGG|2361~SOYBEAN|3156~PEANUT|4048^NEW YORK, NY|630^REMOTE|R^Aug 15, 2013@11:52|3130515.1152^MILD|1^ANXIETY|39^PROPOFOL^PROPOFOL|2145;PSNDF(50.6,^OBSERVED|o^VISTA|V"
"RTN","PSODGAL3",230,0)
 S GMRAING("R12")="SODIUM METABISULFITE|69~PROPOFOL|2114~EGG|2361~SOYBEAN|3156~PEANUT|4048^MARTINSBURG VAMC|613^REMOTE|R^DEC 15, 2013@12:52|3131215.1252^MILD|1^ANXIETY|39^PROPOFOL^PROPOFOL|2145;PSNDF(50.6,OBSERVED|o^VISTA|V"
"RTN","PSODGAL3",231,0)
 Q
"RTN","PSODGAL3",232,0)
 ;
"RTN","PSODGAL3",233,0)
DRGCLASS ;Test Remote Interaction by drug class
"RTN","PSODGAL3",234,0)
 K GMRAING,GMRADRCL,GMRAREAC
"RTN","PSODGAL3",235,0)
 S GMRADRCL("R1")="ANTILIPEMIC AGENTS|58^HEARTLAND WEST VAMC|589^REMOTE|R^Jan 28, 2014@10:56|3140128.1056^SEVERE|3^DIARRHEA|9~DROWSINESS|66~DRY NOSE|69^ANTILIPEMIC AGENTS^ANTILIPEMIC AGENTS|58;PS(50.605,^OBSERVED|o^VISTA|V"
"RTN","PSODGAL3",236,0)
 S GMRADRCL("R2")="ANTILIPEMIC AGENTS|58^MARTINSBURG VAMC|613^REMOTE|R^Jan 15, 2014@09:56|3140115.0956^SEVERE|3^DIARRHEA|9~DROWSINESS|66~DRY NOSE|69^ANTILIPEMIC AGENTS^ANTILIPEMIC AGENTS|58;PS(50.605,^OBSERVED|o^VISTA|V"
"RTN","PSODGAL3",237,0)
 Q
"RTN","PSODGAL3",238,0)
 ;
"RTN","PSODGAL3",239,0)
BIGARRAY ;dummy big array with complex local/remote combinations.  Will not match drugs passed in
"RTN","PSODGAL3",240,0)
 K GMRARSLT
"RTN","PSODGAL3",241,0)
 S GMRARSLT=7
"RTN","PSODGAL3",242,0)
 S GMRARSLT(1,106534)="10881^L^3150528.1606^^^AMPICILLIN^79;PSNDF(50.6,^h^V"
"RTN","PSODGAL3",243,0)
 S GMRARSLT(1,106534,"CLS")=249
"RTN","PSODGAL3",244,0)
 S GMRARSLT(1,"MESSAGE",1)=1
"RTN","PSODGAL3",245,0)
 S GMRARSLT(1,"MESSAGE",1,10881)="CLE13 TEST LAB^LOCAL^MAY 28, 2015@16:06^HISTORICAL"
"RTN","PSODGAL3",246,0)
 S GMRARSLT(1,"MESSAGE",2)="^AMPICILLIN^AMPICILLIN"
"RTN","PSODGAL3",247,0)
 S GMRARSLT(1,"MESSAGE","OFFENDERS","CLS")="AM111 PENICILLINS,AMINO DERIVATIVES"
"RTN","PSODGAL3",248,0)
 S GMRARSLT(2,106535)="10881^L^3150528.1607^^^MEROPENEM^3391;PSNDF(50.6,^h^V"
"RTN","PSODGAL3",249,0)
 S GMRARSLT(2,106535,"CLS")=335
"RTN","PSODGAL3",250,0)
 S GMRARSLT(2,"MESSAGE",1)=2
"RTN","PSODGAL3",251,0)
 S GMRARSLT(2,"MESSAGE",1,10881)="CLE13 TEST LAB^LOCAL^MAY 28, 2015@16:07^HISTORICAL"
"RTN","PSODGAL3",252,0)
 S GMRARSLT(2,"MESSAGE",1,10882)="CHEYENNE HDR SQA^REMOTE^MAY 28, 2015@16:02^HISTORICAL"
"RTN","PSODGAL3",253,0)
 S GMRARSLT(2,"MESSAGE",2)="^MEROPENEM^MEROPENEM"
"RTN","PSODGAL3",254,0)
 S GMRARSLT(2,"MESSAGE","OFFENDERS","CLS")="AM119 BETA-LACTAMS ANTIMICROBIALS,OTHER"
"RTN","PSODGAL3",255,0)
 S GMRARSLT(2,"R9")="10882^R^3150528.1602^^^MEROPENEM^3391;PSNDF(50.6,^h^V"
"RTN","PSODGAL3",256,0)
 S GMRARSLT(2,"R9","CLS")=335
"RTN","PSODGAL3",257,0)
 S GMRARSLT(3,"MESSAGE",1)=1
"RTN","PSODGAL3",258,0)
 S GMRARSLT(3,"MESSAGE",1,10882)="CHEYENNE HDR SQA^REMOTE^MAY 28, 2015@16:03^OBSERVED"
"RTN","PSODGAL3",259,0)
 S GMRARSLT(3,"MESSAGE",2)="RASH^CEPHALEXIN^CEPHALEXIN"
"RTN","PSODGAL3",260,0)
 S GMRARSLT(3,"MESSAGE","OFFENDERS","CLS")="AM115 CEPHALOSPORIN 1ST GENERATION"
"RTN","PSODGAL3",261,0)
 S GMRARSLT(3,"R11")="10882^R^3150528.1603^^133^CEPHALEXIN^1290;PSNDF(50.6,^o^V"
"RTN","PSODGAL3",262,0)
 S GMRARSLT(3,"R11","CLS")=12
"RTN","PSODGAL3",263,0)
 S GMRARSLT(4,"MESSAGE",1)=1
"RTN","PSODGAL3",264,0)
 S GMRARSLT(4,"MESSAGE",1,613)="MARTINSBURG VAMC^REMOTE^MAY 28, 2015@15:46^OBSERVED"
"RTN","PSODGAL3",265,0)
 S GMRARSLT(4,"MESSAGE",2)="ANAPHYLAXIS and DYSPNEA^CEFAZOLIN^CEFAZOLIN"
"RTN","PSODGAL3",266,0)
 S GMRARSLT(4,"MESSAGE","OFFENDERS","CLS")="AM115 CEPHALOSPORIN 1ST GENERATION"
"RTN","PSODGAL3",267,0)
 S GMRARSLT(4,"MESSAGE","OFFENDERS","ING")="CEFAZOLIN"
"RTN","PSODGAL3",268,0)
 S GMRARSLT(4,"R13")="613^R^3150528.1546^^5~70^CEFAZOLIN^30;PSNDF(50.6,^o^V"
"RTN","PSODGAL3",269,0)
 S GMRARSLT(4,"R13","CLS")=12
"RTN","PSODGAL3",270,0)
 S GMRARSLT(4,"R13","ING")=2278
"RTN","PSODGAL3",271,0)
 S GMRARSLT(5,"MESSAGE",1)=1
"RTN","PSODGAL3",272,0)
 S GMRARSLT(5,"MESSAGE",1,10882)="CHEYENNE HDR SQA^REMOTE^MAY 28, 2015@16:01^HISTORICAL"
"RTN","PSODGAL3",273,0)
 S GMRARSLT(5,"MESSAGE",2)="ITCHING OF EYE and WHEEZING^PENICILLIN^PENICILLIN"
"RTN","PSODGAL3",274,0)
 S GMRARSLT(5,"MESSAGE","OFFENDERS","CLS")="AM110 PENICILLIN-G RELATED PENICILLINS"
"RTN","PSODGAL3",275,0)
 S GMRARSLT(5,"R2")="10882^R^3150528.1601^^20~311^PENICILLIN^16;PSNDF(50.6,^h^V"
"RTN","PSODGAL3",276,0)
 S GMRARSLT(5,"R2","CLS")=248
"RTN","PSODGAL3",277,0)
 S GMRARSLT(6,"MESSAGE",1)=1
"RTN","PSODGAL3",278,0)
 S GMRARSLT(6,"MESSAGE",1,613)="MARTINSBURG VAMC^REMOTE^MAY 28, 2015@15:50^OBSERVED"
"RTN","PSODGAL3",279,0)
 S GMRARSLT(6,"MESSAGE",2)="ANAPHYLAXIS^PENICILLIN^PENICILLIN"
"RTN","PSODGAL3",280,0)
 S GMRARSLT(6,"MESSAGE","OFFENDERS","CLS")="AM110 PENICILLIN-G RELATED PENICILLINS"
"RTN","PSODGAL3",281,0)
 S GMRARSLT(6,"R4")="613^R^3150528.155^^5~30^PENICILLIN^16;PSNDF(50.6,^o^V"
"RTN","PSODGAL3",282,0)
 S GMRARSLT(6,"R4","CLS")=248
"RTN","PSODGAL3",283,0)
 S ^XTMP("ORRDI","ART",DFN,4,"SIGNS/SYMPTOMS",2)="^Giggles^"
"RTN","PSODGAL3",284,0)
 S GMRARSLT(7,"MESSAGE",1)=1
"RTN","PSODGAL3",285,0)
 S GMRARSLT(7,"MESSAGE",1,613)="MARTINSBURG VAMC^REMOTE^MAY 28, 2015@15:50^HISTORICAL"
"RTN","PSODGAL3",286,0)
 S GMRARSLT(7,"MESSAGE",2)="^CEFEPIME^CEFEPIME"
"RTN","PSODGAL3",287,0)
 S GMRARSLT(7,"MESSAGE","OFFENDERS","CLS")="AM118 CEPHALOSPORIN 4TH GENERATION"
"RTN","PSODGAL3",288,0)
 S GMRARSLT(7,"R5")="613^R^3150528.155^^^CEFEPIME^3392;PSNDF(50.6,^h^V"
"RTN","PSODGAL3",289,0)
 S GMRARSLT(7,"R5","CLS")=524
"RTN","PSODGAL3",290,0)
 Q
"RTN","PSODGAL3",291,0)
 ;
"RTN","PSODRG")
0^3^B93820988^B93593274
"RTN","PSODRG",1,0)
PSODRG ;IHS/DSD/JCM - ORDER ENTRY DRUG SELECTION ;2/16/12 12:50pm
"RTN","PSODRG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,23,36,53,54,46,112,139,207,148,243,268,324,251,375,387,398,390,427,411,458**;DEC 1997;Build 2
"RTN","PSODRG",3,0)
 ;Reference to ^PSDRUG( supported by DBIA 221
"RTN","PSODRG",4,0)
 ;Reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODRG",5,0)
 ;Reference to $$PROMPT^PSSDIN supported by DBIA 3166
"RTN","PSODRG",6,0)
 ;Reference to EN^PSSDIN supported by DBIA 3166
"RTN","PSODRG",7,0)
 ;Reference to $$GETNDC^PSSNDCUT supported by DBIA 4707
"RTN","PSODRG",8,0)
 ;Reference to ^OROCAPI controlled subscription supported by DBIA 5367
"RTN","PSODRG",9,0)
 ;Reference to $$OITM^ORX8 supported by DBIA 5469
"RTN","PSODRG",10,0)
 ;Reference to ^VADPT supported by DBIA 10061
"RTN","PSODRG",11,0)
 ;Reference to IN^PSSHRQ2 supported by DBIA 5369
"RTN","PSODRG",12,0)
 ;Reference to ^XTMP("ORRDI" supported by DBIA 5440
"RTN","PSODRG",13,0)
 ;----------------------------------------------------------
"RTN","PSODRG",14,0)
START ;
"RTN","PSODRG",15,0)
 S (PSONEW("DFLG"),PSONEW("FIELD"),PSODRG("QFLG"))=0 K PSORX("DFLG")
"RTN","PSODRG",16,0)
 D @($S(+$G(PSOEDIT)=1&('$D(DA)):"SELECT^PSODRGN",1:"SELECT"))
"RTN","PSODRG",17,0)
 G:$G(PSORXED("DFLG")) END ; Select Drug
"RTN","PSODRG",18,0)
 I $G(PSORX("EDIT")),$G(PSOY),$G(PSODRUG("IEN"))=+PSOY D  G:$G(PSORXED("DFLG")) END
"RTN","PSODRG",19,0)
 . N NDC D NDC(+$G(PSORXED("IRXN")),0,+PSOY,.NDC) I $G(NDC)="^" S PSORXED("DFLG")=1 Q
"RTN","PSODRG",20,0)
 . I $G(NDC)'="" S (PSODRUG("NDC"),PSORXED("FLD",27))=NDC
"RTN","PSODRG",21,0)
 ;
"RTN","PSODRG",22,0)
 I $G(PSORX("EDIT"))]"",'PSONEW("FIELD") D TRADE
"RTN","PSODRG",23,0)
 G:$G(PSONEW("DFLG"))!($G(PSODRG("QFLG")))!($G(PSORXED("DFLG"))) END
"RTN","PSODRG",24,0)
 D SET ; Set various drug information
"RTN","PSODRG",25,0)
 D NFI ; Display dispense drug/orderable item text
"RTN","PSODRG",26,0)
 D:'$G(PSOEDIT) POST I $G(PSORX("DFLG")) S PSONEW("DFLG")=1 K:'$G(PSORX("EDIT")) PSORX("DFLG") ; Do any post selection action
"RTN","PSODRG",27,0)
END ;D EOJ
"RTN","PSODRG",28,0)
 Q
"RTN","PSODRG",29,0)
 ;------------------------------------------------------------
"RTN","PSODRG",30,0)
 ;
"RTN","PSODRG",31,0)
SELECT ;
"RTN","PSODRG",32,0)
 K:'$G(PSORXED) CLOZPAT
"RTN","PSODRG",33,0)
 K IT,DIC,X,Y,PSODRUG("TRADE NAME"),PSODRUG("NDC"),PSODRUG("DAW"),PSODRUG("BAD") S:$G(POERR)&($P($G(OR0),"^",9)) Y=$P(^PSDRUG($P(OR0,"^",9),0),"^")
"RTN","PSODRG",34,0)
 I $G(PSODRUG("IEN"))]"" S Y=PSODRUG("NAME"),PSONEW("OLD VAL")=PSODRUG("IEN")
"RTN","PSODRG",35,0)
 W !,"DRUG: "_$S($G(Y)]"":Y_"// ",1:"") R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSODRG",36,0)
 I X="",$G(Y)]"" S:Y X=Y S:'X X=$G(PSODRUG("IEN")) S:X X="`"_X
"RTN","PSODRG",37,0)
 G:X="" SELECT
"RTN","PSODRG",38,0)
 I X?1."?" W !!,"Answer with DRUG NUMBER, or GENERIC NAME, or VA PRODUCT NAME, or",!,"NATIONAL DRUG CLASS, or SYNONYM" G SELECT
"RTN","PSODRG",39,0)
 I $G(PSORXED),X["^" S PSORXED("DFLG")=1 G SELECTX
"RTN","PSODRG",40,0)
 I X="^"!(X["^^")!($D(DTOUT)) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODRG",41,0)
 I '$G(POERR),X[U,$L(X)>1 S PSODIR("FLD")=PSONEW("FLD") D JUMP^PSODIR1 S:$G(PSODIR("FIELD")) PSONEW("FIELD")=PSODIR("FIELD") K PSODIR S PSODRG("QFLG")=1 G SELECTX
"RTN","PSODRG",42,0)
 S DIC=50,DIC(0)="EMQZVT",DIC("T")="",D="B^C^VAPN^VAC"
"RTN","PSODRG",43,0)
 S DIC("S")="I $S('$D(^PSDRUG(+Y,""I"")):1,'^(""I""):1,DT'>^(""I""):1,1:0),$S($P($G(^PSDRUG(+Y,2)),""^"",3)'[""O"":0,1:1),$D(^PSDRUG(""ASP"",+$G(^(2)),+Y))"
"RTN","PSODRG",44,0)
 D MIX^DIC1 K DIC,D
"RTN","PSODRG",45,0)
 I $D(DTOUT) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODRG",46,0)
 I $D(DUOUT) K DUOUT G SELECT
"RTN","PSODRG",47,0)
 I Y<0 G SELECT
"RTN","PSODRG",48,0)
 S:$G(PSONEW("OLD VAL"))=+Y&('$G(PSOEDIT)) PSODRG("QFLG")=1
"RTN","PSODRG",49,0)
 K PSOY S PSOY=Y,PSOY(0)=Y(0)
"RTN","PSODRG",50,0)
 I $P(PSOY(0),"^")="OTHER DRUG"!($P(PSOY(0),"^")="OUTSIDE DRUG") D TRADE
"RTN","PSODRG",51,0)
SELECTX K X,Y,DTOUT,DUOUT,PSONEW("OLD VAL")
"RTN","PSODRG",52,0)
 Q
"RTN","PSODRG",53,0)
 ;
"RTN","PSODRG",54,0)
NDC(RX,RFL,DRG,NDC) ; Editing NDC for Released Rx's or for Unresolved ECME Rejects
"RTN","PSODRG",55,0)
 S NDC=$S($G(NDC)'="":$G(NDC),1:$$GETNDC^PSONDCUT(RX,.RFL))
"RTN","PSODRG",56,0)
 ; Check if we should edit the NDC
"RTN","PSODRG",57,0)
 ; Needs to be released or have unresolved billable rejects (PSO*7*427)
"RTN","PSODRG",58,0)
 ;
"RTN","PSODRG",59,0)
 N PSOCONT S PSOCONT=0                         ; continue flag
"RTN","PSODRG",60,0)
 D  Q:'PSOCONT                                 ; get out if NDC edit not allowed
"RTN","PSODRG",61,0)
 . I $$RXRLDT^PSOBPSUT(RX,RFL) S PSOCONT=1 Q   ; Released - continue and allow edit
"RTN","PSODRG",62,0)
 . I $$FIND^PSOREJUT(RX,RFL),$$STATUS^PSOBPSUT(RX,RFL)'="" S PSOCONT=1 Q    ; unreleased w/unresolved billable rejections
"RTN","PSODRG",63,0)
 . Q
"RTN","PSODRG",64,0)
 ;
"RTN","PSODRG",65,0)
 S NDC=$S($G(NDC)'="":$G(NDC),1:$$GETNDC^PSONDCUT(RX,.RFL))
"RTN","PSODRG",66,0)
 D NDCEDT^PSONDCUT(RX,.RFL,$G(DRG),$G(PSOSITE),.NDC)
"RTN","PSODRG",67,0)
 Q
"RTN","PSODRG",68,0)
 ;
"RTN","PSODRG",69,0)
TRADE ;
"RTN","PSODRG",70,0)
 K DIR,DIC,DA,X,Y
"RTN","PSODRG",71,0)
 S DIR(0)="52,6.5" S:$G(PSOTRN)]"" DIR("B")=$G(PSOTRN) D ^DIR K DIR,DIC
"RTN","PSODRG",72,0)
 I X="@" S Y=X K DIRUT
"RTN","PSODRG",73,0)
 I $D(DIRUT) S:$D(DUOUT)!$D(DTOUT)&('$D(PSORX("EDIT"))) PSONEW("DFLG")=1 G TRADEX
"RTN","PSODRG",74,0)
 S PSODRUG("TRADE NAME")=Y
"RTN","PSODRG",75,0)
TRADEX I $G(PSORXED("DFLG")),$D(DIRUT) S PSORXED("DFLG")=1
"RTN","PSODRG",76,0)
 K DIRUT,DTOUT,DUOUT,X,Y,DA,DR,DIE
"RTN","PSODRG",77,0)
 Q
"RTN","PSODRG",78,0)
SET ;
"RTN","PSODRG",79,0)
 N STAT S PSODRUG("IEN")=+PSOY,PSODRUG("VA CLASS")=$P(PSOY(0),"^",2)
"RTN","PSODRG",80,0)
 S PSODRUG("NAME")=$P(PSOY(0),"^")
"RTN","PSODRG",81,0)
 S:+$G(^PSDRUG(+PSOY,2)) PSODRUG("OI")=+$G(^(2)),PSODRUG("OIN")=$P(^PS(50.7,+$G(^(2)),0),"^")
"RTN","PSODRG",82,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(+PSOY,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSODRG",83,0)
 S PSODRUG("MAXDOSE")=$P(PSOY(0),"^",4),PSODRUG("DEA")=$P(PSOY(0),"^",3)
"RTN","PSODRG",84,0)
 S PSODRUG("CLN")=$S($D(^PSDRUG(+PSOY,"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSODRG",85,0)
 S PSODRUG("SIG")=$P(PSOY(0),"^",5)
"RTN","PSODRG",86,0)
 I $G(PSODRUG("NDC"))="" S PSODRUG("NDC")=$$GETNDC^PSSNDCUT(+PSOY,$G(PSOSITE))
"RTN","PSODRG",87,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,+PSOY,81)
"RTN","PSODRG",88,0)
 S PSODRUG("STKLVL")=$G(^PSDRUG(+PSOY,660.1))
"RTN","PSODRG",89,0)
 G:$G(^PSDRUG(+PSOY,660))']"" SETX
"RTN","PSODRG",90,0)
 S PSOX1=$G(^PSDRUG(+PSOY,660))
"RTN","PSODRG",91,0)
 S PSODRUG("COST")=$P($G(PSOX1),"^",6)
"RTN","PSODRG",92,0)
 S PSODRUG("UNIT")=$P($G(PSOX1),"^",8)
"RTN","PSODRG",93,0)
 S PSODRUG("EXPIRATION DATE")=$P($G(PSOX1),"^",9)
"RTN","PSODRG",94,0)
SETX K PSOX1,PSOY
"RTN","PSODRG",95,0)
 Q
"RTN","PSODRG",96,0)
NFI ;display restriction/guidelines
"RTN","PSODRG",97,0)
 D EN^PSSDIN(PSODRUG("OI"),PSODRUG("IEN")) S NFI=$$PROMPT^PSSDIN
"RTN","PSODRG",98,0)
 I NFI]"","ODY"[NFI D TD^PSONFI
"RTN","PSODRG",99,0)
 K NFI Q
"RTN","PSODRG",100,0)
POST ;order checks
"RTN","PSODRG",101,0)
 N LIST S LIST="PSOPEPS"
"RTN","PSODRG",102,0)
 K PSODOSD,^TMP("PSORXDC",$J),^TMP($J,LIST),^TMP("PSODAOC",$J)
"RTN","PSODRG",103,0)
 K ZDGDG,ZTHER,IT,PSODLQT,PSODOSD
"RTN","PSODRG",104,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) S ^TMP("PSODAOC",$J,"NORDI",1,0)="Remote data not available - Only local order checks processed."
"RTN","PSODRG",105,0)
 S ^TMP($J,LIST,"IN","PING")="" D IN^PSSHRQ2(LIST)
"RTN","PSODRG",106,0)
 K DIR I $P(^TMP($J,LIST,"OUT",0),"^")=-1 D
"RTN","PSODRG",107,0)
 .D DATACK^PSODDPRE
"RTN","PSODRG",108,0)
 .S ^TMP("PSODAOC",$J,"NOSYS",1,0)="No Enhanced Order Checks can be performed. Reason(s): "_$P($G(^TMP($J,LIST,"OUT",0)),"^",2)
"RTN","PSODRG",109,0)
 K ^TMP($J,LIST,"IN"),^TMP($J,LIST,"OUT","EXCEPTIONS")
"RTN","PSODRG",110,0)
 G:$G(PSORX("DFLG"))!($G(PSORXED("DFLG"))) POSTX
"RTN","PSODRG",111,0)
 K PSORX("INTERVENE"),PSOQUIT N STAT,SIG,PTR,NDF,VAP S PSORX("DFLG")=0
"RTN","PSODRG",112,0)
 W !! D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",113,0)
 D ^PSOBUILD
"RTN","PSODRG",114,0)
 D:'$D(PSODGCK) @$S($G(COPY):"^PSOCPPRE",1:"^PSODDPRE") ; Duplicate drug check
"RTN","PSODRG",115,0)
 G:$G(PSORX("DFLG")) POSTX
"RTN","PSODRG",116,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",117,0)
 I $P($G(^PSDRUG(PSODRUG("IEN"),"CLOZ1")),"^")="PSOCLO1" W !,"Now doing Clozapine Order checks.  Please wait...",! D CLOZ
"RTN","PSODRG",118,0)
 G:PSORX("DFLG") POSTX
"RTN","PSODRG",119,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",120,0)
 W !,"Now doing allergy checks.  Please wait...",! H 1
"RTN","PSODRG",121,0)
 S PSONOAL="" D ALLERGY^PSOORUT2 D:PSONOAL'="" NOALRGY K PSONOAL
"RTN","PSODRG",122,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",123,0)
 I '$G(PSODGCKX) D ^PSODGAL1 K PSORX("INTERVENE")
"RTN","PSODRG",124,0)
 G:PSORX("DFLG")!$G(PSOQUIT) POSTX
"RTN","PSODRG",125,0)
 ;This is the allergy check for profile drugs CK action
"RTN","PSODRG",126,0)
 I $D(PSODGCK),$D(PSOSD) D PRFLP^PSOUTL
"RTN","PSODRG",127,0)
 G:$G(PSORX("DFLG")) POSTX ;pso*7*412
"RTN","PSODRG",128,0)
 G:$G(PSOSPRNW)&($G(PSORENW("DFLG"))) POSTX ;speed renew
"RTN","PSODRG",129,0)
 ;aminoglycoside
"RTN","PSODRG",130,0)
 N AOC,CROCPFLG S CROCPFLG=0
"RTN","PSODRG",131,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",132,0)
 S AOC=$$AOC^OROCAPI(PSODFN,$P(PSODRUG("NDF"),"A",2)) I $P(AOC,"^",4)]"" D
"RTN","PSODRG",133,0)
 .S CROCPFLG=1
"RTN","PSODRG",134,0)
 .W !!,"***Aminoglycoside Ordered***",!!
"RTN","PSODRG",135,0)
 .K ^UTILITY($J,"W") S DIWL=1,DIWR=78,DIWF="" S X=$P(AOC,"^",4) D ^DIWP
"RTN","PSODRG",136,0)
 .W ! F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W ?2,^UTILITY($J,"W",1,ZX,0),! D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",137,0)
 .K ^UTILITY($J,"W")
"RTN","PSODRG",138,0)
 .S ^TMP("PSODAOC",$J,"CPRS",$P(AOC,"^",2),0)=PSODRUG("IEN")_"^"_$P(AOC,"^",4)
"RTN","PSODRG",139,0)
 .W !
"RTN","PSODRG",140,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",141,0)
 ;dangerous meds for pat >64
"RTN","PSODRG",142,0)
 I $G(PSODRUG("OI")) D
"RTN","PSODRG",143,0)
 .N OI,OIR S OI=$$OITM^ORX8(PSODRUG("OI"),"99PSP") Q:'OI
"RTN","PSODRG",144,0)
 .S OIR=$$DOC^OROCAPI(PSODFN,OI) I $P(OIR,"^",4)]"" D
"RTN","PSODRG",145,0)
 ..S CROCPFLG=1
"RTN","PSODRG",146,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) W !!,"***Dangerous Meds for Patient >64***",!! S DFN=PSODFN D DEM^VADPT
"RTN","PSODRG",147,0)
 ..K ^UTILITY($J,"W") S DIWL=1,DIWR=78,DIWF="" S X=$P(OIR,"^",4) D ^DIWP
"RTN","PSODRG",148,0)
 ..F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W ?2,^UTILITY($J,"W",1,ZX,0),! D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",149,0)
 ..K ^UTILITY($J,"W")
"RTN","PSODRG",150,0)
 ..S ^TMP("PSODAOC",$J,"CPRS",$P(OIR,"^",2),0)=PSODRUG("IEN")_"^"_$P(OIR,"^",4)
"RTN","PSODRG",151,0)
 ..W !
"RTN","PSODRG",152,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",153,0)
 ;metformin lab results
"RTN","PSODRG",154,0)
 N GOC S GOC=$$GOC^OROCAPI(PSODFN,PSODRUG("NAME")) I $P(GOC,"^",4)]"" D
"RTN","PSODRG",155,0)
 .S CROCPFLG=1
"RTN","PSODRG",156,0)
 .W !!,"***Metformin Lab Results***",!!
"RTN","PSODRG",157,0)
 .K ^UTILITY($J,"W") S DIWL=1,DIWR=78,DIWF="" S X=$P(GOC,"^",4) D ^DIWP
"RTN","PSODRG",158,0)
 .F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W ?2,^UTILITY($J,"W",1,ZX,0),! D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",159,0)
 .K ^UTILITY($J,"W")
"RTN","PSODRG",160,0)
 .S ^TMP("PSODAOC",$J,"CPRS",$P(GOC,"^",2),0)=PSODRUG("IEN")_"^"_$P(GOC,"^",4)
"RTN","PSODRG",161,0)
 .W !
"RTN","PSODRG",162,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",163,0)
 ;clinical reminder oc
"RTN","PSODRG",164,0)
 D:'$G(PSONCROC) CK^PSOCROC K CROCPFLG I $G(PSORX("DFLG")) Q
"RTN","PSODRG",165,0)
 K DIWF,DIWL,DIWR,ZX,DFN,CROCPFLG
"RTN","PSODRG",166,0)
 I $G(PSODRUG("DEA"))["S"!($E($G(PSODRUG("VA CLASS")),1,2)="XA"),'$G(PSODGCK) D  G POSTX ;stops if drug is supply
"RTN","PSODRG",167,0)
 .W !,"Now Processing Enhanced Order Checks!  Please wait...",! H 1
"RTN","PSODRG",168,0)
 ;enhanced OC
"RTN","PSODRG",169,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",170,0)
 W ! D @$S($G(COPY):"OBX^PSOCPPRE",1:"OBX^PSODDPRE") ; Set PSORX("DFLG")=1 if process to stop new enhanced order checks
"RTN","PSODRG",171,0)
POSTX ;
"RTN","PSODRG",172,0)
 K IT,^TMP($J,"DI"),PSORX("INTERVENE"),DA,^TMP($J,"PSODRDI"),ZDGDG,ZTHER,^TMP($J,"DI"_PSODFN),PSZZQUIT
"RTN","PSODRG",173,0)
 I '$G(PSORXED),'$G(PSOREINS) K PSOQUIT
"RTN","PSODRG",174,0)
 Q
"RTN","PSODRG",175,0)
 ;
"RTN","PSODRG",176,0)
EOJ ;
"RTN","PSODRG",177,0)
 K PSODRG
"RTN","PSODRG",178,0)
 Q
"RTN","PSODRG",179,0)
WAIT ;
"RTN","PSODRG",180,0)
 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue..." W !
"RTN","PSODRG",181,0)
 D ^DIR K DIRUT,DUOUT,DIR,X,Y
"RTN","PSODRG",182,0)
 Q
"RTN","PSODRG",183,0)
 ;
"RTN","PSODRG",184,0)
CLOZ ;
"RTN","PSODRG",185,0)
 S ANQRTN=$P(^PSDRUG(PSODRUG("IEN"),"CLOZ1"),"^"),ANQX=0
"RTN","PSODRG",186,0)
 S P(5)=PSODRUG("IEN"),DFN=PSODFN,X=ANQRTN
"RTN","PSODRG",187,0)
 X ^%ZOSF("TEST") I  D @("^"_ANQRTN) S:$G(ANQX) PSORX("DFLG")=1
"RTN","PSODRG",188,0)
 K P(5),ANQRTN,ANQX,X,DFN
"RTN","PSODRG",189,0)
 Q
"RTN","PSODRG",190,0)
 ;
"RTN","PSODRG",191,0)
EN(DRG) ;returns lab test identified for clozapine order checking
"RTN","PSODRG",192,0)
 K LAB I $P($G(^PSDRUG(DRG,"CLOZ1")),"^")'="PSOCLO1" S LAB("NOT")=0 Q
"RTN","PSODRG",193,0)
 I $P($G(^PSDRUG(DRG,"CLOZ1")),"^")="PSOCLO1" D
"RTN","PSODRG",194,0)
 .S (CNT,I)=0 F  S I=$O(^PSDRUG(DRG,"CLOZ2",I)) Q:'I  S CNT=$G(CNT)+1
"RTN","PSODRG",195,0)
 .I CNT'=2 S LAB("BAD TEST")=0 K CNT Q
"RTN","PSODRG",196,0)
 .K CNT F I=0:0 S I=$O(^PSDRUG(DRG,"CLOZ2",I)) Q:'I  D
"RTN","PSODRG",197,0)
 ..S LABT=$S($P(^PSDRUG(DRG,"CLOZ2",I,0),"^",4)=1:"WBC",1:"ANC"),LAB(LABT)=$P(^PSDRUG(DRG,"CLOZ2",I,0),"^")_"^"_$P(^(0),"^",3)_"^"_$P(^(0),"^",4)
"RTN","PSODRG",198,0)
 K LABT,I
"RTN","PSODRG",199,0)
 Q
"RTN","PSODRG",200,0)
NOALRGY ;
"RTN","PSODRG",201,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",202,0)
 N DIR S DIR(0)="SA^1:YES;0:NO"
"RTN","PSODRG",203,0)
 I $D(^TMP($J,"PSOINTERVENE",+PSODFN)) D  Q
"RTN","PSODRG",204,0)
 .S DIR("A")="No Allergy Assessment - Do you want to duplicate Intervention?: ",DIR("B")="Yes"
"RTN","PSODRG",205,0)
 .D ^DIR
"RTN","PSODRG",206,0)
 .I 'Y D  Q
"RTN","PSODRG",207,0)
 ..I Y=0 D ^PSORXI Q
"RTN","PSODRG",208,0)
 ..S PSORX("DFLG")=1
"RTN","PSODRG",209,0)
 .D DUPINV^PSORXI
"RTN","PSODRG",210,0)
 W $C(7),!,"There is no allergy assessment on file for this patient."
"RTN","PSODRG",211,0)
 W !,"You will be prompted to intervene if you continue with this prescription"
"RTN","PSODRG",212,0)
 I $D(PSODGCK) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." D ^DIR K DIR
"RTN","PSODRG",213,0)
 Q:$D(PSODGCK)
"RTN","PSODRG",214,0)
 N DUOUT,DTOUT,RXIEN,RXSTA               ;*398
"RTN","PSODRG",215,0)
 S DIR("A")="Do you want to Continue?: ",DIR("B")="N" D ^DIR
"RTN","PSODRG",216,0)
 I 'Y!($D(DUOUT))!($D(DTOUT)) D  Q       ;*398 - Exit/Timeout
"RTN","PSODRG",217,0)
 .I $D(PSONV) S PSZZQUIT=1 Q
"RTN","PSODRG",218,0)
 .S PSORX("DFLG")=1
"RTN","PSODRG",219,0)
 .I '$O(PSCAN(0)) Q                      ;*398 - Array has Rx IEN
"RTN","PSODRG",220,0)
 .I $G(REA)'="R" Q                       ;*398 - Reinstate only
"RTN","PSODRG",221,0)
 .S RXIEN=+$G(PSCAN(RX)) I 'RXIEN Q      ;*398 - Get Rx IEN
"RTN","PSODRG",222,0)
 .S RXSTA=$$GET1^DIQ(52,RXIEN,100,"I")   ;*398 - Get status
"RTN","PSODRG",223,0)
 .I RXSTA=12 Q                           ;*398 - Correct status
"RTN","PSODRG",224,0)
 .S DIE="^PSRX(",DA=RXIEN,DR="100///12"  ;*398 - Discontinued
"RTN","PSODRG",225,0)
 .D ^DIE                                 ;*398 - Update Rx file
"RTN","PSODRG",226,0)
 I $D(PSONV) S PSORX("INTERVENE")=0 D EN1^PSORXI(PSONV) Q
"RTN","PSODRG",227,0)
 D ^PSORXI
"RTN","PSODRG",228,0)
 Q
"VER")
8.0^22.0
"BLD",9419,6)
^382
**END**
**END**

