Released PSO*7*504 SEQ #425
Extracted from mail message
**KIDS**:PSO*7.0*504^

**INSTALL NAME**
PSO*7.0*504
"BLD",10585,0)
PSO*7.0*504^OUTPATIENT PHARMACY^0^3180226^y
"BLD",10585,1,0)
^^10^10^3180223^^^
"BLD",10585,1,1,0)
This patch will resolve the following issues:
"BLD",10585,1,2,0)
 
"BLD",10585,1,3,0)
1. I15848129FY17 - Buprenorphine/naloxone prescription went through when
"BLD",10585,1,4,0)
                   the DEA expiration date was in the past 
"BLD",10585,1,5,0)
 
"BLD",10585,1,6,0)
2. R16854127FY18 - FILL DATE prompt range incorrect
"BLD",10585,1,7,0)
 
"BLD",10585,1,8,0)
3. I5855290FY15  - CK Hidden Option and Remote Order Checks
"BLD",10585,1,9,0)
    
"BLD",10585,1,10,0)
4. I17185111FY18 - Error when changing routing from Window to Mail
"BLD",10585,4,0)
^9.64PA^^
"BLD",10585,6)
1^
"BLD",10585,6.3)
15
"BLD",10585,"ABPKG")
n
"BLD",10585,"KRN",0)
^9.67PA^779.2^20
"BLD",10585,"KRN",.4,0)
.4
"BLD",10585,"KRN",.401,0)
.401
"BLD",10585,"KRN",.402,0)
.402
"BLD",10585,"KRN",.403,0)
.403
"BLD",10585,"KRN",.5,0)
.5
"BLD",10585,"KRN",.84,0)
.84
"BLD",10585,"KRN",3.6,0)
3.6
"BLD",10585,"KRN",3.8,0)
3.8
"BLD",10585,"KRN",9.2,0)
9.2
"BLD",10585,"KRN",9.8,0)
9.8
"BLD",10585,"KRN",9.8,"NM",0)
^9.68A^19^16
"BLD",10585,"KRN",9.8,"NM",1,0)
PSORXVW^^0^B80641069
"BLD",10585,"KRN",9.8,"NM",2,0)
PSOUTIL^^0^B145871756
"BLD",10585,"KRN",9.8,"NM",4,0)
PSOORNE5^^0^B54894231
"BLD",10585,"KRN",9.8,"NM",5,0)
PSOORFI5^^0^B48135325
"BLD",10585,"KRN",9.8,"NM",7,0)
PSOPKIV2^^0^B23372370
"BLD",10585,"KRN",9.8,"NM",9,0)
PSOASAP0^^0^B165083587
"BLD",10585,"KRN",9.8,"NM",10,0)
PSORENW^^0^B48759882
"BLD",10585,"KRN",9.8,"NM",11,0)
PSOORCPY^^0^B37014700
"BLD",10585,"KRN",9.8,"NM",12,0)
PSORENW4^^0^B73245534
"BLD",10585,"KRN",9.8,"NM",13,0)
PSODIR2^^0^B28893582
"BLD",10585,"KRN",9.8,"NM",14,0)
PSON52^^0^B98826270
"BLD",10585,"KRN",9.8,"NM",15,0)
PSONEW2^^0^B42942926
"BLD",10585,"KRN",9.8,"NM",16,0)
PSOBBC^^0^B111560977
"BLD",10585,"KRN",9.8,"NM",17,0)
PSODIR^^0^B42513700
"BLD",10585,"KRN",9.8,"NM",18,0)
PSODRG^^0^B93661712
"BLD",10585,"KRN",9.8,"NM",19,0)
PSOORNE3^^0^B66007798
"BLD",10585,"KRN",9.8,"NM","B","PSOASAP0",9)

"BLD",10585,"KRN",9.8,"NM","B","PSOBBC",16)

"BLD",10585,"KRN",9.8,"NM","B","PSODIR",17)

"BLD",10585,"KRN",9.8,"NM","B","PSODIR2",13)

"BLD",10585,"KRN",9.8,"NM","B","PSODRG",18)

"BLD",10585,"KRN",9.8,"NM","B","PSON52",14)

"BLD",10585,"KRN",9.8,"NM","B","PSONEW2",15)

"BLD",10585,"KRN",9.8,"NM","B","PSOORCPY",11)

"BLD",10585,"KRN",9.8,"NM","B","PSOORFI5",5)

"BLD",10585,"KRN",9.8,"NM","B","PSOORNE3",19)

"BLD",10585,"KRN",9.8,"NM","B","PSOORNE5",4)

"BLD",10585,"KRN",9.8,"NM","B","PSOPKIV2",7)

"BLD",10585,"KRN",9.8,"NM","B","PSORENW",10)

"BLD",10585,"KRN",9.8,"NM","B","PSORENW4",12)

"BLD",10585,"KRN",9.8,"NM","B","PSORXVW",1)

"BLD",10585,"KRN",9.8,"NM","B","PSOUTIL",2)

"BLD",10585,"KRN",19,0)
19
"BLD",10585,"KRN",19,"NM",0)
^9.68A^^
"BLD",10585,"KRN",19.1,0)
19.1
"BLD",10585,"KRN",101,0)
101
"BLD",10585,"KRN",409.61,0)
409.61
"BLD",10585,"KRN",771,0)
771
"BLD",10585,"KRN",779.2,0)
779.2
"BLD",10585,"KRN",870,0)
870
"BLD",10585,"KRN",8989.51,0)
8989.51
"BLD",10585,"KRN",8989.52,0)
8989.52
"BLD",10585,"KRN",8994,0)
8994
"BLD",10585,"KRN","B",.4,.4)

"BLD",10585,"KRN","B",.401,.401)

"BLD",10585,"KRN","B",.402,.402)

"BLD",10585,"KRN","B",.403,.403)

"BLD",10585,"KRN","B",.5,.5)

"BLD",10585,"KRN","B",.84,.84)

"BLD",10585,"KRN","B",3.6,3.6)

"BLD",10585,"KRN","B",3.8,3.8)

"BLD",10585,"KRN","B",9.2,9.2)

"BLD",10585,"KRN","B",9.8,9.8)

"BLD",10585,"KRN","B",19,19)

"BLD",10585,"KRN","B",19.1,19.1)

"BLD",10585,"KRN","B",101,101)

"BLD",10585,"KRN","B",409.61,409.61)

"BLD",10585,"KRN","B",771,771)

"BLD",10585,"KRN","B",779.2,779.2)

"BLD",10585,"KRN","B",870,870)

"BLD",10585,"KRN","B",8989.51,8989.51)

"BLD",10585,"KRN","B",8989.52,8989.52)

"BLD",10585,"KRN","B",8994,8994)

"BLD",10585,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",10585,"QUES",0)
^9.62^^
"BLD",10585,"REQB",0)
^9.611^15^9
"BLD",10585,"REQB",4,0)
PSO*7.0*473^2
"BLD",10585,"REQB",5,0)
PSO*7.0*166^2
"BLD",10585,"REQB",9,0)
PSO*7.0*468^2
"BLD",10585,"REQB",10,0)
PSO*7.0*469^2
"BLD",10585,"REQB",11,0)
PSO*7.0*495^2
"BLD",10585,"REQB",12,0)
PSO*7.0*458^2
"BLD",10585,"REQB",13,0)
PSO*7.0*422^2
"BLD",10585,"REQB",14,0)
PSO*7.0*496^2
"BLD",10585,"REQB",15,0)
PSO*7.0*444^2
"BLD",10585,"REQB","B","PSO*7.0*166",5)

"BLD",10585,"REQB","B","PSO*7.0*422",13)

"BLD",10585,"REQB","B","PSO*7.0*444",15)

"BLD",10585,"REQB","B","PSO*7.0*458",12)

"BLD",10585,"REQB","B","PSO*7.0*468",9)

"BLD",10585,"REQB","B","PSO*7.0*469",10)

"BLD",10585,"REQB","B","PSO*7.0*473",4)

"BLD",10585,"REQB","B","PSO*7.0*495",11)

"BLD",10585,"REQB","B","PSO*7.0*496",14)

"MBREQ")
0
"PKG",170,-1)
1^1
"PKG",170,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",170,20,0)
^9.402P^^
"PKG",170,22,0)
^9.49I^1^1
"PKG",170,22,1,0)
7.0^2971216^2981113^1
"PKG",170,22,1,"PAH",1,0)
504^3180226^520824666
"PKG",170,22,1,"PAH",1,1,0)
^^10^10^3180226
"PKG",170,22,1,"PAH",1,1,1,0)
This patch will resolve the following issues:
"PKG",170,22,1,"PAH",1,1,2,0)
 
"PKG",170,22,1,"PAH",1,1,3,0)
1. I15848129FY17 - Buprenorphine/naloxone prescription went through when
"PKG",170,22,1,"PAH",1,1,4,0)
                   the DEA expiration date was in the past 
"PKG",170,22,1,"PAH",1,1,5,0)
 
"PKG",170,22,1,"PAH",1,1,6,0)
2. R16854127FY18 - FILL DATE prompt range incorrect
"PKG",170,22,1,"PAH",1,1,7,0)
 
"PKG",170,22,1,"PAH",1,1,8,0)
3. I5855290FY15  - CK Hidden Option and Remote Order Checks
"PKG",170,22,1,"PAH",1,1,9,0)
    
"PKG",170,22,1,"PAH",1,1,10,0)
4. I17185111FY18 - Error when changing routing from Window to Mail
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
16
"RTN","PSOASAP0")
0^9^B165083587^B169084201
"RTN","PSOASAP0",1,0)
PSOASAP0 ;BIRM/MFR - American Society for Automation in Pharmacy (ASAP) Segments & Fields ;09/07/12
"RTN","PSOASAP0",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**408,451,496,504**;DEC 1997;Build 15
"RTN","PSOASAP0",3,0)
 ;External reference to $$NATURE^ORUTL3 supported by DBIA 5890
"RTN","PSOASAP0",4,0)
 ;External reference to ^ORDEA is supported by DBIA 5709
"RTN","PSOASAP0",5,0)
 ;External reference to PATIENT file (#2) supported by DBIA 5597
"RTN","PSOASAP0",6,0)
 ;External reference to $$NPI^XUSNPI supported by DBIA 4532
"RTN","PSOASAP0",7,0)
 ;External reference to $$DIV4^XUSER supported by DBIA 2533
"RTN","PSOASAP0",8,0)
 ;            
"RTN","PSOASAP0",9,0)
 ; ******************** ASAP 1995 Version ********************
"RTN","PSOASAP0",10,0)
ASAP95(RXIEN,FILL) ;Returns the entire ASAP 1995 record for the Rx/Fill
"RTN","PSOASAP0",11,0)
 ;Input: (r) RXIEN - Rx IEN (#52) 
"RTN","PSOASAP0",12,0)
 ;       (r) FILL  - Fill #
"RTN","PSOASAP0",13,0)
 N ASAP95,RXNUM
"RTN","PSOASAP0",14,0)
 S RXNUM=$E(RXIEN+10000000,$L(RXIEN+10000000)-6,$L(RXIEN+10000000))
"RTN","PSOASAP0",15,0)
 S $E(ASAP95,1,3)="ASB"                               ;Transmission Type Identifier
"RTN","PSOASAP0",16,0)
 S $E(ASAP95,4,9)="VA"_$E(10000+$$SITE^VASITE(),2,5)  ;Bank Identification Number
"RTN","PSOASAP0",17,0)
 S $E(ASAP95,10,11)="A2"                              ;ASAP Version (A2 = 1995)
"RTN","PSOASAP0",18,0)
 S $E(ASAP95,12,13)="01"                              ;Transaction Code ("01" - Controlled Substance)
"RTN","PSOASAP0",19,0)
 S $E(ASAP95,14,25)=$E($$PHA03^PSOASAP(),1,12)        ;Pharmacy DEA# Number
"RTN","PSOASAP0",20,0)
 S $E(ASAP95,26,45)=$$PAT03^PSOASAP()                 ;Patient ID (SSN)
"RTN","PSOASAP0",21,0)
 S $E(ASAP95,46,48)=$E($$PAT16^PSOASAP(),1,3)         ;Patient's Zip Code (first 3 digits)
"RTN","PSOASAP0",22,0)
 S $E(ASAP95,49,56)=$$PAT18^PSOASAP()                 ;Patient's DOB  (Format: YYYYMMDD)
"RTN","PSOASAP0",23,0)
 S $E(ASAP95,57,57)=$S($$PAT19^PSOASAP()="M":1,1:"2") ;Patient's Gender
"RTN","PSOASAP0",24,0)
 S $E(ASAP95,58,65)=$$DSP05^PSOASAP()                 ;Date Filled (Release/RTS Date) (Format: YYYYMMDD)
"RTN","PSOASAP0",25,0)
 S $E(ASAP95,66,72)=RXNUM                             ;Prescription Number (IEN - Because it must be 7-digit numeric )
"RTN","PSOASAP0",26,0)
 S $E(ASAP95,73,74)=$E(FILL+100,2,3)                  ;Fill Number
"RTN","PSOASAP0",27,0)
 S $E(ASAP95,75,79)=$E(100000+$$DSP09^PSOASAP(),2,6)  ;Quantity
"RTN","PSOASAP0",28,0)
 S $E(ASAP95,80,82)=$E(1000+$$DSP10^PSOASAP(),2,4)    ;Days Supply
"RTN","PSOASAP0",29,0)
 S $E(ASAP95,83,83)="1"                               ;Compound Flag (1=Not compound)
"RTN","PSOASAP0",30,0)
 S $E(ASAP95,84,94)=$E($$DSP08^PSOASAP(),1,11)        ;NDC (Fomart: 99999999999)
"RTN","PSOASAP0",31,0)
 S $E(ASAP95,95,104)=$E($$PRE02^PSOASAP(),1,10)       ;Prescriber's DEA #
"RTN","PSOASAP0",32,0)
 S $E(ASAP95,105,108)=""                              ;DEA Suffix
"RTN","PSOASAP0",33,0)
 S $E(ASAP95,109,116)=$$DSP03^PSOASAP()               ;Date Written (Format: YYYYMMDD)
"RTN","PSOASAP0",34,0)
 S $E(ASAP95,117,118)=$E(100+$$DSP04^PSOASAP(),2,3)   ;Refills Authorized
"RTN","PSOASAP0",35,0)
 S $E(ASAP95,119,119)=$S(+$$DSP12^PSOASAP()>2:0,1:+$$DSP12^PSOASAP()) ;Rx Origin Code (0:Not Specified/1:Written/2:Telephone)
"RTN","PSOASAP0",36,0)
 S $E(ASAP95,120,121)="03"                            ;Customer Location (Always: "03" - Outpatient)
"RTN","PSOASAP0",37,0)
 S $E(ASAP95,122,128)=""                              ;DEA Suffix
"RTN","PSOASAP0",38,0)
 S $E(ASAP95,129,138)=$E($$PRE03^PSOASAP(),1,10)      ;Alternate Prescriber # (VA #)
"RTN","PSOASAP0",39,0)
 S $E(ASAP95,139,153)=$E($$PAT07^PSOASAP(),1,15)      ;Patient's Last Name
"RTN","PSOASAP0",40,0)
 S $E(ASAP95,154,168)=$E($$PAT08^PSOASAP(),1,15)      ;Patient's First Name
"RTN","PSOASAP0",41,0)
 S $E(ASAP95,169,198)=$E($$PAT12^PSOASAP(),1,30)      ;Patient's Address
"RTN","PSOASAP0",42,0)
 S $E(ASAP95,199,200)=$E($$PAT15^PSOASAP(),1,2)       ;Patient's State
"RTN","PSOASAP0",43,0)
 S $E(ASAP95,201,209)=$E($$PAT16^PSOASAP(),1,9)       ;Patient's Zip Code
"RTN","PSOASAP0",44,0)
 S $E(ASAP95,210,222)=""                              ;Filler
"RTN","PSOASAP0",45,0)
 Q ASAP95
"RTN","PSOASAP0",46,0)
 ;
"RTN","PSOASAP0",47,0)
 ; ******************** ASAP 3.0 and above versions ********************
"RTN","PSOASAP0",48,0)
 ; *** TH Segment ***
"RTN","PSOASAP0",49,0)
TH02() ;ASAP 3.0 : Business Partner Implemetation Version (Not Used)
"RTN","PSOASAP0",50,0)
 ;      ASAP 4.0+: Transaction Control Number
"RTN","PSOASAP0",51,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",52,0)
 Q +$$SITE^VASITE()_"-"_+$G(BATCHIEN)
"RTN","PSOASAP0",53,0)
 ;
"RTN","PSOASAP0",54,0)
TH03() ;ASAP 3.0 : Transaction Control Number
"RTN","PSOASAP0",55,0)
 ;      ASAP 4.0+: Transaction Type (Always "01" - Send/Request Transaction)
"RTN","PSOASAP0",56,0)
 I PSOASVER="3.0" Q +$$SITE^VASITE()_"-"_+$G(BATCHIEN)
"RTN","PSOASAP0",57,0)
 Q "01"
"RTN","PSOASAP0",58,0)
 ;
"RTN","PSOASAP0",59,0)
TH05() ;ASAP 3.0 : Message Type (Not Used)
"RTN","PSOASAP0",60,0)
 ;      ASAP 4.0+: Creation Date (Format: YYYYMMDD)
"RTN","PSOASAP0",61,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",62,0)
 Q $$FMTHL7^XLFDT($$HTFM^XLFDT($H)\1)
"RTN","PSOASAP0",63,0)
 ;
"RTN","PSOASAP0",64,0)
TH06() ;ASAP 3.0 : Response ID (Not Used)
"RTN","PSOASAP0",65,0)
 ;      ASAP 4.0+: Creation Time. Format: HHMMSS or HHMM
"RTN","PSOASAP0",66,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",67,0)
 Q $E($P($$HTFM^XLFDT($H),".",2)_"000000",1,6)
"RTN","PSOASAP0",68,0)
 ;
"RTN","PSOASAP0",69,0)
TH07() ;ASAP 3.0 : Project ID (Not Used)
"RTN","PSOASAP0",70,0)
 ;      ASAP 4.0+: File Type. Returns: "T" - Test or "P" - Production
"RTN","PSOASAP0",71,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",72,0)
 Q $S($$PROD^XUPROD(1):"P",1:"T")
"RTN","PSOASAP0",73,0)
 ;
"RTN","PSOASAP0",74,0)
TH08() ;ASAP 3.0: Creation Date (Format: YYYYMMDD)
"RTN","PSOASAP0",75,0)
 ;      ASAP 4.0: Composite Element Separator (:)
"RTN","PSOASAP0",76,0)
 ;      ASAP 4.1+: Routing Number (Real-time transactions only) - Not Used
"RTN","PSOASAP0",77,0)
 I PSOASVER="4.0" Q ":"
"RTN","PSOASAP0",78,0)
 I PSOASVER'="3.0" Q ""
"RTN","PSOASAP0",79,0)
 Q $$FMTHL7^XLFDT($$HTFM^XLFDT($H)\1)
"RTN","PSOASAP0",80,0)
 ;
"RTN","PSOASAP0",81,0)
TH09() ;ASAP 3.0 : Creation Time. Format: HHMMSS or HHMM
"RTN","PSOASAP0",82,0)
 ;      ASAP 4.1+: Segment Terminator Character
"RTN","PSOASAP0",83,0)
 I PSOASVER="3.0" Q $E($P($$HTFM^XLFDT($H),".",2)_"000000",1,6)
"RTN","PSOASAP0",84,0)
 Q $P($$VERDATA^PSOSPMU0(PSOASVER,"B"),"^",3)
"RTN","PSOASAP0",85,0)
 ;
"RTN","PSOASAP0",86,0)
TH10() ;ASAP 3.0 : File Type
"RTN","PSOASAP0",87,0)
 ;      ASAP 4.0+: N/A
"RTN","PSOASAP0",88,0)
 I PSOASVER="3.0" Q $S($$PROD^XUPROD(1):"P",1:"T")
"RTN","PSOASAP0",89,0)
 Q ""
"RTN","PSOASAP0",90,0)
 ;
"RTN","PSOASAP0",91,0)
TH12() ;ASAP 3.0 : Composite Element Separator
"RTN","PSOASAP0",92,0)
 ;      ASAP 4.0+: N/A
"RTN","PSOASAP0",93,0)
 I PSOASVER="3.0" Q ":"
"RTN","PSOASAP0",94,0)
 Q ""
"RTN","PSOASAP0",95,0)
 ;
"RTN","PSOASAP0",96,0)
TH13() ;ASAP 3.0 : Data Segment Terminator Character
"RTN","PSOASAP0",97,0)
 ;      ASAP 4.0+: N/A
"RTN","PSOASAP0",98,0)
 I PSOASVER'="3.0" Q ""
"RTN","PSOASAP0",99,0)
 Q $P($$VERDATA^PSOSPMU0(PSOASVER,"B"),"^",3)
"RTN","PSOASAP0",100,0)
 ;
"RTN","PSOASAP0",101,0)
 ; *** PHA Segment ***
"RTN","PSOASAP0",102,0)
PHA01() ;National Provider Identifier
"RTN","PSOASAP0",103,0)
 N NPINST,NPINUM
"RTN","PSOASAP0",104,0)
 S NPINST=$$GET1^DIQ(59,SITEIEN,101,"I") I 'NPINST Q ""
"RTN","PSOASAP0",105,0)
 S NPINUM=+$$NPI^XUSNPI("Organization_ID",NPINST,DT)
"RTN","PSOASAP0",106,0)
 Q $S(NPINUM>0:NPINUM,1:"")
"RTN","PSOASAP0",107,0)
 ;
"RTN","PSOASAP0",108,0)
PHA03() ;Pharmacy DEA Number
"RTN","PSOASAP0",109,0)
 N PHA03,INST
"RTN","PSOASAP0",110,0)
 ;Primary source: Pharmacy NPI Institution
"RTN","PSOASAP0",111,0)
 S PHA03="",INST=$$GET1^DIQ(59,SITEIEN,101,"I")
"RTN","PSOASAP0",112,0)
 I INST S PHA03=$$WHAT^XUAF4(INST,52)
"RTN","PSOASAP0",113,0)
 ;Backup source: Pharmacy Related Institution
"RTN","PSOASAP0",114,0)
 I PHA03="" D
"RTN","PSOASAP0",115,0)
 . S INST=$$GET1^DIQ(59,SITEIEN,100,"I")
"RTN","PSOASAP0",116,0)
 . I INST S PHA03=$$WHAT^XUAF4(INST,52)
"RTN","PSOASAP0",117,0)
 Q PHA03
"RTN","PSOASAP0",118,0)
 ;
"RTN","PSOASAP0",119,0)
PHA10() ;Phone Number
"RTN","PSOASAP0",120,0)
 Q $$PHONE($$GET1^DIQ(59,SITEIEN,.03)_$$GET1^DIQ(59,SITEIEN,.04))
"RTN","PSOASAP0",121,0)
 ;
"RTN","PSOASAP0",122,0)
 ; *** PAT Segment ***
"RTN","PSOASAP0",123,0)
PAT03() ;ASAP 3.0 : Unique System ID - Patient (Not Used)
"RTN","PSOASAP0",124,0)
 ;       ASAP 4.0+: ID of Patient (SSN)
"RTN","PSOASAP0",125,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",126,0)
 Q $P($G(VADM(2)),"^",1)
"RTN","PSOASAP0",127,0)
 ;
"RTN","PSOASAP0",128,0)
PAT04() ;ASAP 3.0 : SSN
"RTN","PSOASAP0",129,0)
 ;       ASAP 4.0+: ID Qualifier of Additional Patient Identifier (Not Used)
"RTN","PSOASAP0",130,0)
 I PSOASVER="3.0" Q $P($G(VADM(2)),"^",1)
"RTN","PSOASAP0",131,0)
 Q ""
"RTN","PSOASAP0",132,0)
 ;
"RTN","PSOASAP0",133,0)
PAT12() ;Patient Address Information - Line 1
"RTN","PSOASAP0",134,0)
 ; ASAP 4.2: Length = 35 characters (All others: 30 characters)
"RTN","PSOASAP0",135,0)
 N ADDRESS
"RTN","PSOASAP0",136,0)
 I PSOASVER="4.2" D  Q ADDRESS
"RTN","PSOASAP0",137,0)
 .  S ADDRESS=$S($G(VAPA(1))'="":VAPA(1),$G(VAPA(11)):"STREET ADDRESS UNKNOWN",1:"")
"RTN","PSOASAP0",138,0)
 S ADDRESS=$$TRIM^XLFSTR($G(VAPA(1)))_$S($$TRIM^XLFSTR($G(VAPA(2)))'="":" "_VAPA(2),1:"")_$S($$TRIM^XLFSTR($G(VAPA(3)))'="":" "_VAPA(3),1:"")
"RTN","PSOASAP0",139,0)
 I ADDRESS="",$G(VAPA(11)) S ADDRESS="STREET ADDRESS UNKNOWN"
"RTN","PSOASAP0",140,0)
 I $E(ADDRESS,1,30)'[" " Q $E(ADDRESS,1,30)
"RTN","PSOASAP0",141,0)
 Q $$ADDRESS(ADDRESS,1)
"RTN","PSOASAP0",142,0)
 ;
"RTN","PSOASAP0",143,0)
PAT13() ;Patient Address Information - Line 2
"RTN","PSOASAP0",144,0)
 ; ASAP 4.2: Length = 35 characters (All others: 30 characters)
"RTN","PSOASAP0",145,0)
 I PSOASVER="4.2" Q $G(VAPA(2))
"RTN","PSOASAP0",146,0)
 N ADDRESS
"RTN","PSOASAP0",147,0)
 S ADDRESS=$$TRIM^XLFSTR($G(VAPA(1)))_$S($$TRIM^XLFSTR($G(VAPA(2)))'="":" "_VAPA(2),1:"")_$S($$TRIM^XLFSTR($G(VAPA(3)))'="":" "_VAPA(3),1:"")
"RTN","PSOASAP0",148,0)
 I $E(ADDRESS,1,30)'[" " Q $E(ADDRESS,31,999)
"RTN","PSOASAP0",149,0)
 Q $$ADDRESS(ADDRESS,2)
"RTN","PSOASAP0",150,0)
 ;
"RTN","PSOASAP0",151,0)
PAT15() ;Patient State Address
"RTN","PSOASAP0",152,0)
 ; US State Abbreviation
"RTN","PSOASAP0",153,0)
 I $$PAT22()="" Q $$GET1^DIQ(5,+$G(VAPA(5)),1)
"RTN","PSOASAP0",154,0)
 ; International State/Province
"RTN","PSOASAP0",155,0)
 Q $P($G(VAPA(23)),"^")
"RTN","PSOASAP0",156,0)
 ;
"RTN","PSOASAP0",157,0)
PAT16() ;Patient ZIP Code
"RTN","PSOASAP0",158,0)
 ; US Zip Code
"RTN","PSOASAP0",159,0)
 I $$PAT22()="" Q $TR($P($G(VAPA(11)),"^",1),"-")
"RTN","PSOASAP0",160,0)
 ; International Postal Code
"RTN","PSOASAP0",161,0)
 Q $P($G(VAPA(24)),"^")
"RTN","PSOASAP0",162,0)
 ;
"RTN","PSOASAP0",163,0)
PAT17() ;Patient Phone Number
"RTN","PSOASAP0",164,0)
 N PAT17
"RTN","PSOASAP0",165,0)
 ;PHONE NUMBER [RESIDENCE] (Home)
"RTN","PSOASAP0",166,0)
 S PAT17=$$PHONE($P($G(VAPA(8)),"^",1)) I PAT17 Q PAT17
"RTN","PSOASAP0",167,0)
 ;PHONE NUMBER [CELLULAR] (Cell)
"RTN","PSOASAP0",168,0)
 S PAT17=$$PHONE($$GET1^DIQ(2,PATIEN,.134)) I PAT17 Q PAT17
"RTN","PSOASAP0",169,0)
 ;PHONE NUMBER [WORK] (Work)
"RTN","PSOASAP0",170,0)
 S PAT17=$$PHONE($$GET1^DIQ(2,PATIEN,.132)) I PAT17 Q PAT17
"RTN","PSOASAP0",171,0)
 ;K-WORK PHONE NUMBER (Next Of Kin)
"RTN","PSOASAP0",172,0)
 S PAT17=$$PHONE($$GET1^DIQ(2,PATIEN,.21011)) I PAT17 Q PAT17
"RTN","PSOASAP0",173,0)
 ;K2-WORK PHONE NUMBER (Secondary Next Of Kin)
"RTN","PSOASAP0",174,0)
 S PAT17=$$PHONE($$GET1^DIQ(2,PATIEN,.211011)) I PAT17 Q PAT17
"RTN","PSOASAP0",175,0)
 ;E-WORK PHONE NUMBER (Work Emergency)
"RTN","PSOASAP0",176,0)
 S PAT17=$$PHONE($$GET1^DIQ(2,PATIEN,.33011)) I PAT17 Q PAT17
"RTN","PSOASAP0",177,0)
 ;E2-WORK PHONE NUMBER (Secondary Work Emergency)
"RTN","PSOASAP0",178,0)
 S PAT17=$$PHONE($$GET1^DIQ(2,PATIEN,.331011)) I PAT17 Q PAT17
"RTN","PSOASAP0",179,0)
 ;Last resort: Pharmacy Phone #
"RTN","PSOASAP0",180,0)
 Q $$PHA10()
"RTN","PSOASAP0",181,0)
 ;
"RTN","PSOASAP0",182,0)
PAT18() ;ASAP 3.0 : Email Address (Not Used)
"RTN","PSOASAP0",183,0)
 ;       ASAP 4.0+: Patient DOB
"RTN","PSOASAP0",184,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",185,0)
 Q $$FMTHL7^XLFDT($P($G(VADM(3)),"^",1))
"RTN","PSOASAP0",186,0)
 ;
"RTN","PSOASAP0",187,0)
PAT19() ;ASAP 3.0 : Patient DOB
"RTN","PSOASAP0",188,0)
 ;       ASAP 4.0+: Patient Gender Code
"RTN","PSOASAP0",189,0)
 I PSOASVER="3.0" Q $$FMTHL7^XLFDT($P($G(VADM(3)),"^",1))
"RTN","PSOASAP0",190,0)
 Q $S($P($G(VADM(5)),"^",1)'="":$P($G(VADM(5)),"^",1),1:"U")
"RTN","PSOASAP0",191,0)
 ;
"RTN","PSOASAP0",192,0)
PAT20() ;ASAP 3.0 : Patient Gender Code
"RTN","PSOASAP0",193,0)
 ;       ASAP 4.0+: Species Code (Always return "01" for 'Human')
"RTN","PSOASAP0",194,0)
 I PSOASVER="3.0" Q $S($P($G(VADM(5)),"^",1)'="":$P($G(VADM(5)),"^",1),1:"U")
"RTN","PSOASAP0",195,0)
 Q "01"
"RTN","PSOASAP0",196,0)
 ;
"RTN","PSOASAP0",197,0)
PAT22() ;ASAP 3.0 : Primary Prescription Coverage Type (Not Used)
"RTN","PSOASAP0",198,0)
 ;       ASAP 4.0+:Country of Non-U.S. Resident
"RTN","PSOASAP0",199,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",200,0)
 N CNTRYIEN,FIPSCODE
"RTN","PSOASAP0",201,0)
 S CNTRYIEN=+$G(VAPA(25)) I 'CNTRYIEN Q ""
"RTN","PSOASAP0",202,0)
 S FIPSCODE=$$GET1^DIQ(779.004,CNTRYIEN,1.2)
"RTN","PSOASAP0",203,0)
 Q $S(FIPSCODE="US":"",FIPSCODE="CA":"CN",1:FIPSCODE)
"RTN","PSOASAP0",204,0)
 ;
"RTN","PSOASAP0",205,0)
 ; *** RX Segment (ASAP 3.0 only) ***
"RTN","PSOASAP0",206,0)
RX08() ;Date Rx Written (Format: YYYYMMDD)
"RTN","PSOASAP0",207,0)
 N RX08
"RTN","PSOASAP0",208,0)
 S RX08=$$GET1^DIQ(52,+$G(RXIEN),1,"I")
"RTN","PSOASAP0",209,0)
 ; Date Rx Written (ISSUE DATE) cannot be in the future or after Rx Fill Date (Use LOGIN DATE instead)
"RTN","PSOASAP0",210,0)
 I RX08>DT!(RX08>$$RXRLDT^PSOBPSUT(RXIEN,FILLNUM)) D
"RTN","PSOASAP0",211,0)
 . S RX08=$$GET1^DIQ(52,+$G(RXIEN),21,"I")\1
"RTN","PSOASAP0",212,0)
 Q $$FMTHL7^XLFDT(RX08)
"RTN","PSOASAP0",213,0)
 ;
"RTN","PSOASAP0",214,0)
RX14() ;Product ID (NDC - National Drug Code)
"RTN","PSOASAP0",215,0)
 N RX14 S RX14=""
"RTN","PSOASAP0",216,0)
 I RECTYPE="V",$G(RTSDATA("NDC"))'="" S RX14=$$NUMERIC(RTSDATA("NDC"))
"RTN","PSOASAP0",217,0)
 I 'RX14 S RX14=$$NUMERIC($$GET1^DIQ(50,DRUGIEN,31))
"RTN","PSOASAP0",218,0)
 I 'RX14 S RX14=$$NUMERIC($$GETNDC^PSONDCUT(RXIEN,+FILLNUM))
"RTN","PSOASAP0",219,0)
 Q RX14
"RTN","PSOASAP0",220,0)
 ;
"RTN","PSOASAP0",221,0)
 ; *** DSP Segment ***
"RTN","PSOASAP0",222,0)
DSP01() ;ASAP 3.0 : Reporting Status ("01" - Add / "02" - Change / "03" - Delete)
"RTN","PSOASAP0",223,0)
 ;       ASAP 4.0 : Reporting Status ("" - New / "01" - Revise / "02" - Void)
"RTN","PSOASAP0",224,0)
 ;       ASAP 4.1+: Reporting Status ("00" - New / "01" - Revise / "02" - Void)
"RTN","PSOASAP0",225,0)
 I PSOASVER="3.0" Q $S($G(RECTYPE)="N":"01",$G(RECTYPE)="R":"02",$G(RECTYPE)="V":"03",1:"")
"RTN","PSOASAP0",226,0)
 I PSOASVER="4.0",RECTYPE="N" Q ""
"RTN","PSOASAP0",227,0)
 Q $S($G(RECTYPE)="N":"00",$G(RECTYPE)="R":"01",$G(RECTYPE)="V":"02",1:"")
"RTN","PSOASAP0",228,0)
 ;
"RTN","PSOASAP0",229,0)
DSP02() ;ASAP 3.0 : Program Participation Status (Not Used)
"RTN","PSOASAP0",230,0)
 ;       ASAP 4.0+: Prescription Number
"RTN","PSOASAP0",231,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",232,0)
 Q $$GET1^DIQ(52,+$G(RXIEN),.01)
"RTN","PSOASAP0",233,0)
 ;
"RTN","PSOASAP0",234,0)
DSP03() ;ASAP 3.0 : Prescription Number
"RTN","PSOASAP0",235,0)
 ;       ASAP 4.0+: Date Rx Written (Format: YYYYMMDD)
"RTN","PSOASAP0",236,0)
 I PSOASVER="3.0" Q $$GET1^DIQ(52,+$G(RXIEN),.01)
"RTN","PSOASAP0",237,0)
 N DSP03
"RTN","PSOASAP0",238,0)
 S DSP03=$$GET1^DIQ(52,+$G(RXIEN),1,"I")
"RTN","PSOASAP0",239,0)
 ; Date Rx Written (ISSUE DATE) cannot be in the future or after Rx Fill Date (Use LOGIN DATE instead)
"RTN","PSOASAP0",240,0)
 I DSP03>DT!(DSP03>$$RXRLDT^PSOBPSUT(RXIEN,FILLNUM)) D
"RTN","PSOASAP0",241,0)
 . S DSP03=$$GET1^DIQ(52,+$G(RXIEN),21,"I")\1
"RTN","PSOASAP0",242,0)
 Q $$FMTHL7^XLFDT(DSP03)
"RTN","PSOASAP0",243,0)
 ;
"RTN","PSOASAP0",244,0)
DSP04() ;ASAP 3.0 : Refill Number
"RTN","PSOASAP0",245,0)
 ;       ASAP 4.0+: Refills Authorized
"RTN","PSOASAP0",246,0)
 I PSOASVER="3.0" Q +FILLNUM
"RTN","PSOASAP0",247,0)
 Q +$$GET1^DIQ(52,+$G(RXIEN),9)
"RTN","PSOASAP0",248,0)
 ;
"RTN","PSOASAP0",249,0)
DSP05() ;ASAP 3.0 : Unique System ID - RPh (Not Used)
"RTN","PSOASAP0",250,0)
 ;       ASAP 4.0+: Date Filled (Release Date) (Format: YYYYMMDD)
"RTN","PSOASAP0",251,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",252,0)
 N DSP05
"RTN","PSOASAP0",253,0)
 S DSP05=$S(RECTYPE="V":$G(RTSDATA("RELDTTM")),$$RXRLDT^PSOBPSUT(RXIEN,FILLNUM):$$RXRLDT^PSOBPSUT(RXIEN,FILLNUM),1:DT)\1
"RTN","PSOASAP0",254,0)
 Q $S(DSP05:$$FMTHL7^XLFDT(DSP05),1:"")
"RTN","PSOASAP0",255,0)
 ;
"RTN","PSOASAP0",256,0)
DSP06() ;ASAP 3.0 : Unique System ID - Patient (Not Used)
"RTN","PSOASAP0",257,0)
 ;       ASAP 4.0+: Refill Number (Partials are always "0")
"RTN","PSOASAP0",258,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",259,0)
 Q +FILLNUM
"RTN","PSOASAP0",260,0)
 ;
"RTN","PSOASAP0",261,0)
DSP07() ;ASAP 3.0 : Unique System ID - Prescriber (Not Used)
"RTN","PSOASAP0",262,0)
 ;       ASAP 4.0+: Product ID Qualifier (Always return "01" for 'NDC')
"RTN","PSOASAP0",263,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",264,0)
 Q "01"
"RTN","PSOASAP0",265,0)
 ;
"RTN","PSOASAP0",266,0)
DSP08() ;ASAP 3.0 : Unique System ID - Drug (Not Used)
"RTN","PSOASAP0",267,0)
 ;       ASAP 4.0+:Product ID (NDC - National Drug Code)
"RTN","PSOASAP0",268,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",269,0)
 N DSP08 S DSP08=""
"RTN","PSOASAP0",270,0)
 I RECTYPE="V",$G(RTSDATA("NDC"))'="" S DSP08=$$NUMERIC(RTSDATA("NDC"))
"RTN","PSOASAP0",271,0)
 I 'DSP08 S DSP08=$$NUMERIC($$GET1^DIQ(50,DRUGIEN,31))
"RTN","PSOASAP0",272,0)
 I 'DSP08 S DSP08=$$NUMERIC($$GETNDC^PSONDCUT(RXIEN,+FILLNUM))
"RTN","PSOASAP0",273,0)
 Q DSP08
"RTN","PSOASAP0",274,0)
 ;
"RTN","PSOASAP0",275,0)
DSP09() ;ASAP 3.0 : Date Filled
"RTN","PSOASAP0",276,0)
 ;       ASAP 4.0+: Quantity Dispensed
"RTN","PSOASAP0",277,0)
 N DSP09
"RTN","PSOASAP0",278,0)
 I PSOASVER="3.0" D  Q DSP09
"RTN","PSOASAP0",279,0)
 . S DSP09=$S(RECTYPE="V":$G(RTSDATA("RELDTTM")),$$RXRLDT^PSOBPSUT(RXIEN,FILLNUM):$$RXRLDT^PSOBPSUT(RXIEN,FILLNUM),1:DT)\1
"RTN","PSOASAP0",280,0)
 . S DSP09=$S(DSP09'="":$$FMTHL7^XLFDT(DSP09),1:"")
"RTN","PSOASAP0",281,0)
 Q $S(RECTYPE="V":$G(RTSDATA("QTY")),1:$$RXQTY^PSOBPSUT(RXIEN,FILLNUM))
"RTN","PSOASAP0",282,0)
 ;
"RTN","PSOASAP0",283,0)
DSP10() ;ASAP 3.0 : Time Filled (Not Used)
"RTN","PSOASAP0",284,0)
 ;       ASAP 4.0+: Days Supply
"RTN","PSOASAP0",285,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",286,0)
 Q $S(RECTYPE="V":$G(RTSDATA("DAYSUP")),1:$$RXDAYSUP^PSOBPSUT(RXIEN,FILLNUM))
"RTN","PSOASAP0",287,0)
 ;
"RTN","PSOASAP0",288,0)
DSP11() ;ASAP 3.0 : Product ID Qualifier (01:NDC)
"RTN","PSOASAP0",289,0)
 ;       ASAP 4.0+: Drug Dosage Units Code
"RTN","PSOASAP0",290,0)
 I PSOASVER="3.0" Q "01"
"RTN","PSOASAP0",291,0)
 N UNIT
"RTN","PSOASAP0",292,0)
 S UNIT=$$GET1^DIQ(50,DRUGIEN,82,"I")
"RTN","PSOASAP0",293,0)
 Q $S(UNIT="EA":"01",UNIT="ML":"02",UNIT="GM":"03",1:"")
"RTN","PSOASAP0",294,0)
 ;
"RTN","PSOASAP0",295,0)
DSP12() ;ASAP 3.0 : Product ID (NDC)
"RTN","PSOASAP0",296,0)
 ;       ASAP 4.0+: Transmission Form of Rx Origin Code (Nature of Order)
"RTN","PSOASAP0",297,0)
 N DSP12 S DSP12=""
"RTN","PSOASAP0",298,0)
 I PSOASVER="3.0" D  Q DSP12
"RTN","PSOASAP0",299,0)
 . I RECTYPE="V",$G(RTSDATA("NDC"))'="" S DSP12=$$NUMERIC(RTSDATA("NDC"))
"RTN","PSOASAP0",300,0)
 . I 'DSP12 S DSP12=$$NUMERIC($$GET1^DIQ(50,DRUGIEN,31))
"RTN","PSOASAP0",301,0)
 . I 'DSP12 S DSP12=$$NUMERIC($$GETNDC^PSONDCUT(RXIEN,+FILLNUM))
"RTN","PSOASAP0",302,0)
 N NOO,ORDNUM S NOO="W"
"RTN","PSOASAP0",303,0)
 S ORDNUM=$$GET1^DIQ(52,RXIEN,39.3,"I")
"RTN","PSOASAP0",304,0)
 I $G(ORDNUM) D
"RTN","PSOASAP0",305,0)
 . S NOO=$P($$NATURE^ORUTL3(ORDNUM),"^",2)
"RTN","PSOASAP0",306,0)
 Q $S(NOO="W":"01",(NOO="V")!(NOO="P"):"02",NOO="E":"05",1:"99")
"RTN","PSOASAP0",307,0)
 ;
"RTN","PSOASAP0",308,0)
DSP13() ;ASAP 3.0 : Product Description (Not Used)
"RTN","PSOASAP0",309,0)
 ;       ASAP 4.0+: Partial Fill Indicator
"RTN","PSOASAP0",310,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",311,0)
 I PSOASVER="4.0"!(PSOASVER="4.1") Q $S(FILLNUM["P":"01",1:"02")
"RTN","PSOASAP0",312,0)
 Q $S(FILLNUM["P":$E(100+$E(FILLNUM,2,3),2,3),1:"00")
"RTN","PSOASAP0",313,0)
 ;
"RTN","PSOASAP0",314,0)
DSP14() ;ASAP 3.0 : Quantity Dispensed
"RTN","PSOASAP0",315,0)
 ;       ASAP 4.0+: Pharmacist National Provider Identifier (NPI)
"RTN","PSOASAP0",316,0)
 I PSOASVER="3.0" Q $S(RECTYPE="V":$G(RTSDATA("QTY")),1:$$RXQTY^PSOBPSUT(RXIEN,FILLNUM))
"RTN","PSOASAP0",317,0)
 N NPI
"RTN","PSOASAP0",318,0)
 S NPI=+$$NPI^XUSNPI("Individual_ID",RPHIEN,DT)
"RTN","PSOASAP0",319,0)
 Q $S(NPI>0:NPI,1:"")
"RTN","PSOASAP0",320,0)
 ;
"RTN","PSOASAP0",321,0)
DSP15() ;ASAP 3.0 : Days Supply
"RTN","PSOASAP0",322,0)
 ;       ASAP 4.0+: Pharmacist State License Number (Not Used)
"RTN","PSOASAP0",323,0)
 I PSOASVER="3.0" Q $S(RECTYPE="V":$G(RTSDATA("DAYSUP")),1:$$RXDAYSUP^PSOBPSUT(RXIEN,FILLNUM))
"RTN","PSOASAP0",324,0)
 Q ""
"RTN","PSOASAP0",325,0)
 ;
"RTN","PSOASAP0",326,0)
DSP16() ;ASAP 3.0 : Basis of Days Supply Determiniation (Always "3" for 'As directed by doctor')
"RTN","PSOASAP0",327,0)
 ;       ASAP 4.0+: Classification Code for Payment Type (Always return "05" for 'Military Installations and VA')
"RTN","PSOASAP0",328,0)
 I PSOASVER="3.0" Q "3"
"RTN","PSOASAP0",329,0)
 Q "05"
"RTN","PSOASAP0",330,0)
 ;
"RTN","PSOASAP0",331,0)
DSP17() ;ASAP 3.0 : Refills Remaining (Not Used)
"RTN","PSOASAP0",332,0)
 ;       ASAP 4.0 : N/A
"RTN","PSOASAP0",333,0)
 ;       ASAP 4.1+: Date Sold
"RTN","PSOASAP0",334,0)
 I PSOASVER="3.0"!(PSOASVER="4.0") Q ""
"RTN","PSOASAP0",335,0)
 Q $$DSP05()
"RTN","PSOASAP0",336,0)
 ;
"RTN","PSOASAP0",337,0)
 ; *** PRE Segment ***
"RTN","PSOASAP0",338,0)
PRE01() ;ASAP 3.0 : Not Used
"RTN","PSOASAP0",339,0)
 ;       ASAP 4.0+: Prescriber National Provider Identifier (NPI)
"RTN","PSOASAP0",340,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",341,0)
 N PRE01
"RTN","PSOASAP0",342,0)
 S PRE01=+$$NPI^XUSNPI("Individual_ID",PREIEN)
"RTN","PSOASAP0",343,0)
 Q $S(PRE01>0:PRE01,1:"")
"RTN","PSOASAP0",344,0)
 ;
"RTN","PSOASAP0",345,0)
PRE02() ;Prescriber DEA Number
"RTN","PSOASAP0",346,0)
 N PRE02
"RTN","PSOASAP0",347,0)
 S PRE02=$$PRVDEA() I PRE02'="" Q $P(PRE02,"-",1)
"RTN","PSOASAP0",348,0)
 S PRE02=$P($$DEA^XUSER(0,PREIEN),"-",1)
"RTN","PSOASAP0",349,0)
 I (PRE02="")!($P($$DEA^XUSER(0,PREIEN),"-",2,99)'="") S PRE02=$$PHA03()
"RTN","PSOASAP0",350,0)
 Q PRE02
"RTN","PSOASAP0",351,0)
 ;
"RTN","PSOASAP0",352,0)
PRE03() ;ASAP 3.0 : Prescriber NPI
"RTN","PSOASAP0",353,0)
 ;       ASAP 4.0+: Prescriber DEA Number Suffix
"RTN","PSOASAP0",354,0)
 N PRE03
"RTN","PSOASAP0",355,0)
 I PSOASVER="3.0" D  Q PRE03
"RTN","PSOASAP0",356,0)
 . S PRE03=+$$NPI^XUSNPI("Individual_ID",PREIEN)
"RTN","PSOASAP0",357,0)
 . S PRE03=$S(PRE03>0:PRE03,1:"")
"RTN","PSOASAP0",358,0)
 ;
"RTN","PSOASAP0",359,0)
 S PRE03=$$PRVDEA() I PRE03'="" Q $P(PRE03,"-",2,99)
"RTN","PSOASAP0",360,0)
 S PRE03=$P($$DEA^XUSER(0,PREIEN),"-",2,99)
"RTN","PSOASAP0",361,0)
 I $$PRE02()=$$PHA03() S PRE03=$P($$DEA^XUSER(1,PREIEN),"-",1)
"RTN","PSOASAP0",362,0)
 Q PRE03
"RTN","PSOASAP0",363,0)
 ;
"RTN","PSOASAP0",364,0)
PRE04() ;ASAP 3.0 : Prescriber DEA Number
"RTN","PSOASAP0",365,0)
 ;       ASAP 4.0+: Prescriber State License Number (Not Used)
"RTN","PSOASAP0",366,0)
 I PSOASVER'="3.0" Q ""
"RTN","PSOASAP0",367,0)
 ;
"RTN","PSOASAP0",368,0)
 N PRE04
"RTN","PSOASAP0",369,0)
 S PRE04=$$PRVDEA() I PRE04'="" Q $P(PRE04,"-",1)
"RTN","PSOASAP0",370,0)
 S PRE04=$P($$DEA^XUSER(0,PREIEN),"-",1)
"RTN","PSOASAP0",371,0)
 I (PRE04="")!($P($$DEA^XUSER(0,PREIEN),"-",2,99)'="") S PRE04=$$PHA03()
"RTN","PSOASAP0",372,0)
 Q PRE04
"RTN","PSOASAP0",373,0)
 ;
"RTN","PSOASAP0",374,0)
PRE05() ;ASAP 3.0 : Prescriber DEA Number Suffix
"RTN","PSOASAP0",375,0)
 ;       ASAP 4.0+: Prescriber Last Name
"RTN","PSOASAP0",376,0)
 N PRE05
"RTN","PSOASAP0",377,0)
 I PSOASVER="3.0" D  Q PRE05
"RTN","PSOASAP0",378,0)
 . S PRE05=$$PRVDEA() I PRE05'="" S PRE05=$P(PRE05,"-",2,99) Q
"RTN","PSOASAP0",379,0)
 . S PRE05=$P($$DEA^XUSER(0,PREIEN),"-",2,99)
"RTN","PSOASAP0",380,0)
 . I $$PRE04()=$$PHA03() S PRE05=$P($$DEA^XUSER(1,PREIEN),"-",1)
"RTN","PSOASAP0",381,0)
 ;
"RTN","PSOASAP0",382,0)
 Q $P($$GET1^DIQ(200,PREIEN,.01),",",1)
"RTN","PSOASAP0",383,0)
 ;
"RTN","PSOASAP0",384,0)
PRE06() ;ASAP 3.0 : Prescriber State Lince Number (Not Used)
"RTN","PSOASAP0",385,0)
 ;       ASAP 4.0+: Prescriber First Name
"RTN","PSOASAP0",386,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",387,0)
 Q $P($P($$GET1^DIQ(200,PREIEN,.01),",",2)," ",1)
"RTN","PSOASAP0",388,0)
 ;
"RTN","PSOASAP0",389,0)
PRE07() ;ASAP 3.0 : Prescriber Alternate ID (Not Used)
"RTN","PSOASAP0",390,0)
 ;       ASAP 4.0+: Prescriber Middle Name
"RTN","PSOASAP0",391,0)
 I PSOASVER="3.0" Q ""
"RTN","PSOASAP0",392,0)
 Q $P($P($$GET1^DIQ(200,PREIEN,.01),",",2)," ",2)
"RTN","PSOASAP0",393,0)
 ;
"RTN","PSOASAP0",394,0)
PRE08() ;ASAP 3.0 : Prescriber's Last Name
"RTN","PSOASAP0",395,0)
 ;       ASAP 4.0 & 4.1: N/A (up to PRE07 only)
"RTN","PSOASAP0",396,0)
 ;       ASAP 4.2: Prescriber's Phone Number
"RTN","PSOASAP0",397,0)
 I PSOASVER="3.0" Q $P($$GET1^DIQ(200,PREIEN,.01),",",1)
"RTN","PSOASAP0",398,0)
 I PSOASVER="4.0"!(PSOASVER="4.1") Q ""
"RTN","PSOASAP0",399,0)
 N PRE08
"RTN","PSOASAP0",400,0)
 ;Work Phone #
"RTN","PSOASAP0",401,0)
 S PRE08=$$PHONE($$GET1^DIQ(200,PREIEN,.132)) I PRE08 Q PRE08
"RTN","PSOASAP0",402,0)
 ;Institution Phone #
"RTN","PSOASAP0",403,0)
 N DIV,DIVS,CONTACT,CONTACTS,INSPHONE
"RTN","PSOASAP0",404,0)
 I $$DIV4^XUSER(.DIVS,PREIEN) D
"RTN","PSOASAP0",405,0)
 . S DIV=0 F  S DIV=$O(DIVS(DIV)) Q:'DIV  D  I PRE08 Q
"RTN","PSOASAP0",406,0)
 . . K CONTACTS D GETS^DIQ(4,DIV_",","4*","","CONTACTS") I '$D(CONTACTS) Q
"RTN","PSOASAP0",407,0)
 . . S CONTACT="" F  S CONTACT=$O(CONTACTS(4.03,CONTACT)) Q:(CONTACT="")  D  I $G(INSPHONE) Q
"RTN","PSOASAP0",408,0)
 . . . I $$PHONE(CONTACTS(4.03,CONTACT,.03))'="" D
"RTN","PSOASAP0",409,0)
 . . . . S INSPHONE=$$PHONE(CONTACTS(4.03,CONTACT,.03))
"RTN","PSOASAP0",410,0)
 . . ; Default Prescriber Division
"RTN","PSOASAP0",411,0)
 . . I +DIVS(DIV),$G(INSPHONE) S PRE08=INSPHONE Q
"RTN","PSOASAP0",412,0)
 . . I '$O(DIVS(DIV)),'PRE08,$G(INSPHONE) S PRE08=INSPHONE
"RTN","PSOASAP0",413,0)
 I PRE08 Q PRE08
"RTN","PSOASAP0",414,0)
 ;Last resort: Pharmacy Phone #
"RTN","PSOASAP0",415,0)
 Q $$PHA10()
"RTN","PSOASAP0",416,0)
 ;
"RTN","PSOASAP0",417,0)
PRE09() ;ASAP 3.0: Prescriber' First Name
"RTN","PSOASAP0",418,0)
 I PSOASVER'="3.0" Q ""
"RTN","PSOASAP0",419,0)
 Q $P($P($$GET1^DIQ(200,PREIEN,.01),",",2)," ",1)
"RTN","PSOASAP0",420,0)
 ;
"RTN","PSOASAP0",421,0)
PRE10() ;ASAP 3.0: Prescriber' Middle Name
"RTN","PSOASAP0",422,0)
 I PSOASVER'="3.0" Q ""
"RTN","PSOASAP0",423,0)
 Q $P($P($$GET1^DIQ(200,PREIEN,.01),",",2)," ",2)
"RTN","PSOASAP0",424,0)
 ;
"RTN","PSOASAP0",425,0)
 ; *** RPH Pharmacist Information (ASAP 3.0 Only) **
"RTN","PSOASAP0",426,0)
RPH03() ;National Provider Identification (NPI)
"RTN","PSOASAP0",427,0)
 N RPH03
"RTN","PSOASAP0",428,0)
 S RPH03=+$$NPI^XUSNPI("Individual_ID",RPHIEN,DT)
"RTN","PSOASAP0",429,0)
 Q $S(RPH03>0:RPH03,1:"")
"RTN","PSOASAP0",430,0)
 ;
"RTN","PSOASAP0",431,0)
RPH06() ;Pharmacist Last Name
"RTN","PSOASAP0",432,0)
 Q $P($$GET1^DIQ(200,RPHIEN,.01),",",1)
"RTN","PSOASAP0",433,0)
 ;
"RTN","PSOASAP0",434,0)
RPH07() ;Pharmacist First Name
"RTN","PSOASAP0",435,0)
 Q $P($P($$GET1^DIQ(200,RPHIEN,.01),",",2)," ",1)
"RTN","PSOASAP0",436,0)
 ;
"RTN","PSOASAP0",437,0)
RPH08() ;Pharmacist Middle Name
"RTN","PSOASAP0",438,0)
 Q $P($P($$GET1^DIQ(200,RPHIEN,.01),",",2)," ",2)
"RTN","PSOASAP0",439,0)
 ;
"RTN","PSOASAP0",440,0)
TT01() ;Transaction Control Number
"RTN","PSOASAP0",441,0)
 ;      ASAP 3.0 : Same as TH03
"RTN","PSOASAP0",442,0)
 ;      ASAP 4.0+: Same as TH02
"RTN","PSOASAP0",443,0)
 I PSOASVER="3.0" Q $$TH03()
"RTN","PSOASAP0",444,0)
 Q $$TH02()
"RTN","PSOASAP0",445,0)
 ;
"RTN","PSOASAP0",446,0)
PHONE(NUMBER) ;Returns the Phone number (numeric only - max 10 digits)
"RTN","PSOASAP0",447,0)
 N PHONE
"RTN","PSOASAP0",448,0)
 S PHONE=$$NUMERIC(NUMBER)
"RTN","PSOASAP0",449,0)
 I $E(PHONE,1)="1" S $E(PHONE,1)=""
"RTN","PSOASAP0",450,0)
 Q $S($L(PHONE)=10:PHONE,1:"")
"RTN","PSOASAP0",451,0)
 ;
"RTN","PSOASAP0",452,0)
ADDRESS(VALUE,LINE) ;Returns Address Line1 and Line2 (max 30 characters)
"RTN","PSOASAP0",453,0)
 N ADDRESS,I,DIWL,DIWR,X
"RTN","PSOASAP0",454,0)
 K ^UTILITY($J,"W") S X=$$TRIM^XLFSTR(VALUE),DIWL=1,DIWR=30 D ^DIWP
"RTN","PSOASAP0",455,0)
 S ADDRESS=$$TRIM^XLFSTR($G(^UTILITY($J,"W",1,LINE,0)))
"RTN","PSOASAP0",456,0)
 K ^UTILITY($J,"W")
"RTN","PSOASAP0",457,0)
 Q ADDRESS
"RTN","PSOASAP0",458,0)
 ;
"RTN","PSOASAP0",459,0)
PRVDEA() ;Returns the Provider DEA #
"RTN","PSOASAP0",460,0)
 Q $$RXDEA^PSOUTIL(RXIEN)
"RTN","PSOASAP0",461,0)
 ;
"RTN","PSOASAP0",462,0)
NUMERIC(VALUE) ;Returns the Numeric Value
"RTN","PSOASAP0",463,0)
 N NUMERIC,I
"RTN","PSOASAP0",464,0)
 S NUMERIC=""
"RTN","PSOASAP0",465,0)
 F I=1:1:$L(VALUE) I $E(VALUE,I)?1N S NUMERIC=NUMERIC_$E(VALUE,I)
"RTN","PSOASAP0",466,0)
 Q NUMERIC
"RTN","PSOBBC")
0^16^B111560977^B109320592
"RTN","PSOBBC",1,0)
PSOBBC ;IHS/DSD/JCM-BATCH BARCODE DRIVER ;3/30/06 10:10am
"RTN","PSOBBC",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,22,27,34,46,130,146,185,242,264,300,337,313,473,504**;DEC 1997;Build 15
"RTN","PSOBBC",3,0)
 ;External reference to ^IBE(350.1,"ANEW" supported by DBIA 592
"RTN","PSOBBC",4,0)
 ;External references CHPUS^IBACUS and TRI^IBACUS supported by DBIA 2030
"RTN","PSOBBC",5,0)
 ;External references LK^ORX2 and ULK^ORX2 supported by DBIA 867
"RTN","PSOBBC",6,0)
 ;External references ^PS(55 supported by DBIA 2228
"RTN","PSOBBC",7,0)
 ;External references U, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOBBC",8,0)
 ;PSO*242 change default to from Q to S
"RTN","PSOBBC",9,0)
 ;-------------------------------------------------------------------
"RTN","PSOBBC",10,0)
START ;
"RTN","PSOBBC",11,0)
 N PSODFN,PSOBBCNO
"RTN","PSOBBC",12,0)
 D INIT I '$D(PSOPAR) D ^PSOLSET G:'$D(PSOPAR) EOJ
"RTN","PSOBBC",13,0)
 I $P($G(PSOPAR),"^",2),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("VERIFY")=1  ;337
"RTN","PSOBBC",14,0)
 I $G(PSOSITE) S PSOBARID=$G(^PS(59,PSOSITE,"IB")) I '$D(^IBE(350.1,"ANEW",+PSOBARID,1,1)) D  S PSORX("QFLG")=1 K PSOBARID G END
"RTN","PSOBBC",15,0)
 .W $C(7),!!,"WARNING: Pharmacy Copay not working,",!,?10,"Check IB SERVICE/SECTION in Pharmacy Site File.",!!!,"You will not be able to enter any new prescriptions until this is corrected!"
"RTN","PSOBBC",16,0)
 S PSOBBC("QFLG")=0,PSORX("BAR CODE")=1
"RTN","PSOBBC",17,0)
 D FROM I PSOBBC("QFLG") S PSORX("QFLG")=1 G END
"RTN","PSOBBC",18,0)
 D ASK I PSOBBC("QFLG") S PSORX("QFLG")=1 G END
"RTN","PSOBBC",19,0)
 D PROCESS
"RTN","PSOBBC",20,0)
END D EOJ
"RTN","PSOBBC",21,0)
 Q
"RTN","PSOBBC",22,0)
 ;--------------------------------------------------------------------
"RTN","PSOBBC",23,0)
INIT ;
"RTN","PSOBBC",24,0)
 S PSOBBC("QFLG")=0,PSORX("BAR CODE")=1 K PPL
"RTN","PSOBBC",25,0)
 I '$G(PSOINST) D
"RTN","PSOBBC",26,0)
 .K DIC,DR,DIQ S DA=$P($$SITE^VASITE(),"^") I DA D
"RTN","PSOBBC",27,0)
 ..K PSOINST S DIC=4,DIQ(0)="I",DR=99,DIQ="PSOINST" D EN^DIQ1
"RTN","PSOBBC",28,0)
 ..S PSOINST=PSOINST(4,DA,99,"I") K DIC,DA,DIQ,PSOINST(4)
"RTN","PSOBBC",29,0)
 Q
"RTN","PSOBBC",30,0)
FROM ;
"RTN","PSOBBC",31,0)
 S DIR(0)="S^1:REFILLS;2:RENEWS;"
"RTN","PSOBBC",32,0)
 S DIR("A")="Batch Barcode for",DIR("B")="REFILLS"
"RTN","PSOBBC",33,0)
 D DIR G:'Y FROMX
"RTN","PSOBBC",34,0)
 S PSOBBC1("FROM")=$S(Y=1:"REFILL",1:"NEW")
"RTN","PSOBBC",35,0)
FROMX K X,Y,DIR
"RTN","PSOBBC",36,0)
 Q
"RTN","PSOBBC",37,0)
 ;
"RTN","PSOBBC",38,0)
ASK ;
"RTN","PSOBBC",39,0)
 K BINGCRT,BINGRTE,BBRX
"RTN","PSOBBC",40,0)
 W !,"Please answer the following for this session of prescriptions",!
"RTN","PSOBBC",41,0)
 D EN^PSOREF2(.PSOBBC) I PSOBBC("DFLG") S PSOBBC("QFLG")=1 G ASKX
"RTN","PSOBBC",42,0)
 D SUSP
"RTN","PSOBBC",43,0)
 D INPT,CNH
"RTN","PSOBBC",44,0)
 D:'$P($G(PSOPAR),"^",6) EARLY
"RTN","PSOBBC",45,0)
 D SET
"RTN","PSOBBC",46,0)
 D:PSOBBC1("FROM")="NEW" NOORE^PSONEW(.PSOBBC) S:$G(PSOBBC("NOO"))'="" PSOBBCNO=$G(PSOBBC("NOO")) S:$G(PSOBBC("DFLG")) PSOBBC("QFLG")=1
"RTN","PSOBBC",47,0)
ASKX Q
"RTN","PSOBBC",48,0)
 ;
"RTN","PSOBBC",49,0)
SUSP ;
"RTN","PSOBBC",50,0)
 S DIR(0)="SAB^Q:QUEUED;S:SUSPENDED"
"RTN","PSOBBC",51,0)
 S DIR("A")="Will these refills be Queued or Suspended ? "
"RTN","PSOBBC",52,0)
 S DIR("B")="S"   ;PSO*242
"RTN","PSOBBC",53,0)
 D DIR G:PSOBBC("QFLG") SUSPX
"RTN","PSOBBC",54,0)
 S (PSOBBC1("QS"),PSOBBC("QS"))=Y S:PSOBBC1("QS")="S" BINGCRT=0
"RTN","PSOBBC",55,0)
SUSPX K X,Y,DIR
"RTN","PSOBBC",56,0)
 Q
"RTN","PSOBBC",57,0)
 ;
"RTN","PSOBBC",58,0)
INPT ;
"RTN","PSOBBC",59,0)
 S DIR(0)="YA"
"RTN","PSOBBC",60,0)
 S DIR("A")="Allow refills for inpatient ? "
"RTN","PSOBBC",61,0)
 S DIR("B")="N"
"RTN","PSOBBC",62,0)
 D DIR G:PSOBBC("QFLG") INPTX
"RTN","PSOBBC",63,0)
 S (PSOBBC1("INOK"),PSOBBC("INOK"))=Y
"RTN","PSOBBC",64,0)
INPTX K X,Y,DIR
"RTN","PSOBBC",65,0)
 Q
"RTN","PSOBBC",66,0)
CNH ;
"RTN","PSOBBC",67,0)
 S DIR(0)="YA"
"RTN","PSOBBC",68,0)
 S DIR("A")="Allow refills for CNH ? "
"RTN","PSOBBC",69,0)
 S DIR("B")="N"
"RTN","PSOBBC",70,0)
 D DIR G:PSOBBC("QFLG") CNHX
"RTN","PSOBBC",71,0)
 S (PSOBBC1("CNHOK"),PSOBBC("CNHOK"))=Y
"RTN","PSOBBC",72,0)
CNHX K X,Y,DIR
"RTN","PSOBBC",73,0)
 Q
"RTN","PSOBBC",74,0)
 ;
"RTN","PSOBBC",75,0)
EARLY ;
"RTN","PSOBBC",76,0)
 S DIR(0)="YA"
"RTN","PSOBBC",77,0)
 S DIR("A")="Allow early refills ? "
"RTN","PSOBBC",78,0)
 S DIR("B")="N"
"RTN","PSOBBC",79,0)
 D DIR G:PSOBBC("QFLG") EARLYX
"RTN","PSOBBC",80,0)
 S (PSOBBC1("EAOK"),PSOBBC("EAOK"))=Y
"RTN","PSOBBC",81,0)
EARLYX K X,Y,DIR
"RTN","PSOBBC",82,0)
 Q
"RTN","PSOBBC",83,0)
 ;
"RTN","PSOBBC",84,0)
SET ;
"RTN","PSOBBC",85,0)
 S PSOBBC1("MAIL/WINDOW")=PSOBBC("MAIL/WINDOW") S:PSOBBC1("MAIL/WINDOW")="W" BINGRTE="W"
"RTN","PSOBBC",86,0)
 S PSOBBC1("FILL DATE")=PSOBBC("FILL DATE")
"RTN","PSOBBC",87,0)
 S:$G(PSOBBC("CLERK CODE")) PSOBBC1("CLERK CODE")=PSOBBC("CLERK CODE")
"RTN","PSOBBC",88,0)
 S:$G(PSOBBC("EXPIRATION DATE")) PSOBBC1("EXPIRATION DATE")=PSOBBC("EXPIRATION DATE")
"RTN","PSOBBC",89,0)
 Q
"RTN","PSOBBC",90,0)
DIR ;
"RTN","PSOBBC",91,0)
 D ^DIR
"RTN","PSOBBC",92,0)
 S:$D(DIRUT) PSOBBC("QFLG")=1,PSORX("QFLG")=1
"RTN","PSOBBC",93,0)
 K DIRUT,DUOUT,DTOUT,DIROUT
"RTN","PSOBBC",94,0)
 Q
"RTN","PSOBBC",95,0)
 ;
"RTN","PSOBBC",96,0)
PROCESS ;
"RTN","PSOBBC",97,0)
 S PSOBBC("DFLG")=0 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2)
"RTN","PSOBBC",98,0)
 S RXN=$O(^TMP("PSORXN",$J,0)) I RXN D
"RTN","PSOBBC",99,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSOBBC",100,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS","")
"RTN","PSOBBC",101,0)
 K RXN,RXN1,^TMP("PSORXN",$J) D CLEAN^PSOVER1 K ^TMP("PSORXDC",$J)
"RTN","PSOBBC",102,0)
 D GETRXM D:PSOBBC("QFLG") ULK,ULP,ULRX G:PSOBBC("QFLG") PROCESSX
"RTN","PSOBBC",103,0)
 I $G(PSODFN)'=$P(^PSRX(PSOBBC("IRXN"),0),"^",2) D  G:PSOBBC("DFLG") PROCESS
"RTN","PSOBBC",104,0)
 .I $G(PSODFN) D ULK,ULP
"RTN","PSOBBC",105,0)
 .D PT Q:PSOBBC("DFLG")
"RTN","PSOBBC",106,0)
 .D PROFILE^PSORX1
"RTN","PSOBBC",107,0)
 E  D PTC G:PSOBBC("DFLG") PROCESS
"RTN","PSOBBC",108,0)
 D:'$G(PSOSD) ^PSOBUILD
"RTN","PSOBBC",109,0)
 S PSOBBC("DONE")=PSOBBC("IRXN")_","
"RTN","PSOBBC",110,0)
 D @PSOBBC1("FROM") S:$G(PPL)&$D(BINGRTE) BBRX(1)=$S($D(PSOBBC("DONE")):PSOBBC("DONE"),1:BBRX) D:$D(BINGCRT)&($D(BINGRTE)&($D(DISGROUP))) ^PSOBING1 K BBRX D ULRX G PROCESS
"RTN","PSOBBC",111,0)
PROCESSX I $G(PPL) D SETX,TRI,Q^PSORXL K PPL,RXFL
"RTN","PSOBBC",112,0)
 Q
"RTN","PSOBBC",113,0)
GETRXM ;
"RTN","PSOBBC",114,0)
 N PRVCHK
"RTN","PSOBBC",115,0)
 K DIR,PSOBBC("IRXN"),PSOREFXM
"RTN","PSOBBC",116,0)
 S DIR(0)="FO^5:245^K:X'?3N1""-""1.N X"
"RTN","PSOBBC",117,0)
 S DIR("A")="WAND BARCODE"
"RTN","PSOBBC",118,0)
 S DIR("?",1)="Wand the barcoded number of the prescription to be processed."
"RTN","PSOBBC",119,0)
 S DIR("?",2)="The number should be of the form NNN-NNNNNN"
"RTN","PSOBBC",120,0)
 S DIR("?",3)="where the number before the dash is your station number."
"RTN","PSOBBC",121,0)
 S DIR("?")="Enter ""^"", or a RETURN to quit."
"RTN","PSOBBC",122,0)
 D DIR G:PSOBBC("QFLG") GETRXMX
"RTN","PSOBBC",123,0)
 I $P(X,"-")'=PSOINST W !?7,$C(7),$C(7),$C(7),"Not From this Institution" G GETRXM
"RTN","PSOBBC",124,0)
 S (PSOBBC("IRXN"),PSOBBC("OIRXN"),BBRX)=$P(X,"-",2)
"RTN","PSOBBC",125,0)
 I $G(^PSRX(PSOBBC("IRXN"),0))']"" W !,$C(7),"Rx data is not on file !",! G GETRXM
"RTN","PSOBBC",126,0)
 I $G(PSOBBC1("FROM"))="NEW" S PRVCHK=$$CHKRXPRV^PSOUTIL(PSOBBC("IRXN")) I 'PRVCHK W $C(7),!!,$P(PRVCHK,"^",2),! G GETRXM
"RTN","PSOBBC",127,0)
 I $$TITRX^PSOUTL(PSOBBC("IRXN"))="t" D  G GETRXM
"RTN","PSOBBC",128,0)
 . W $C(7),!!,"Rx# "_$$GET1^DIQ(52,PSOBBC("IRXN"),.01)_" is marked as 'Titration Rx' and cannot be "_$S(PSOBBC1("FROM")="REFILL":"refilled.",1:"renewed."),!
"RTN","PSOBBC",129,0)
 S PSOXDFN=+$P($G(^PSRX(PSOBBC("IRXN"),0)),"^",2) I PSOXDFN S PSOLOUD=1 D:$P($G(^PS(55,PSOXDFN,0)),"^",6)'=2 EN^PSOHLUP(PSOXDFN) K PSOLOUD
"RTN","PSOBBC",130,0)
 K PSOXDFN I $P($G(^PSRX(PSOBBC("IRXN"),"STA")),"^")=13 W !,$C(7),"Rx has already been deleted." G GETRXM
"RTN","PSOBBC",131,0)
 I $G(PSOBBC("DONE"))[PSOBBC("IRXN")_"," W !,$C(7),"Rx has already been entered" G GETRXM
"RTN","PSOBBC",132,0)
 I $G(PSOBBC1("FROM"))="REFILL" S PSOREFXM=$G(PSOBBC("IRXN")) I PSOREFXM D PSOL^PSSLOCK(PSOREFXM) I '$G(PSOMSG) D  K PSOMSG G GETRXM
"RTN","PSOBBC",133,0)
 .I $P($G(PSOMSG),"^",2)'="" W $C(7),!!?5,$P(PSOMSG,"^",2),! Q
"RTN","PSOBBC",134,0)
 .W $C(7),!!?5,"Another person is editing Rx "_$P($G(^PSRX(+$G(PSOBBC("IRXN")),0)),"^"),!
"RTN","PSOBBC",135,0)
 I '$D(PSODFNX(+$P(^PSRX(PSOBBC("IRXN"),0),"^",2))),$G(PSOBBC1("FROM"))="NEW" K PSONOERR D  G:'$G(PSOPLCK)!($G(PSONOERR)) GETRXM
"RTN","PSOBBC",136,0)
 .S PSOPLCK=$$L^PSSLOCK(+$P(^PSRX(PSOBBC("IRXN"),0),"^",2),0) I '$G(PSOPLCK) D LOCK^PSOORCPY Q
"RTN","PSOBBC",137,0)
 .S X=+$P(^PSRX(PSOBBC("IRXN"),0),"^",2)_";DPT(" D LK^ORX2 I 'Y S PSONOERR=1 D UL^PSSLOCK(+$P(^PSRX(PSOBBC("IRXN"),0),"^",2)) Q
"RTN","PSOBBC",138,0)
 .S PSODFNX(+$P(^PSRX(PSOBBC("IRXN"),0),"^",2))=""
"RTN","PSOBBC",139,0)
GETRXMX K X,Y,DIR,PSOOPT
"RTN","PSOBBC",140,0)
 Q
"RTN","PSOBBC",141,0)
 ;
"RTN","PSOBBC",142,0)
PT ;
"RTN","PSOBBC",143,0)
 S PSOBBC("DFLG")=0
"RTN","PSOBBC",144,0)
 W !,$C(7),"New Patient, please pause"
"RTN","PSOBBC",145,0)
 I $G(PPL) D SETX,TRI,Q^PSORXL K PPL
"RTN","PSOBBC",146,0)
 K RXFL
"RTN","PSOBBC",147,0)
 S (DFN,PSODFN)=$P(^PSRX(PSOBBC("IRXN"),0),"^",2),PSORX("NAME")=$P(^DPT(PSODFN,0),"^")
"RTN","PSOBBC",148,0)
 D ICN^PSODPT(DFN)
"RTN","PSOBBC",149,0)
 ;CHECK FOR BAD ADDRESS/SAB
"RTN","PSOBBC",150,0)
 S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSOBBC",151,0)
 D ^PSOBUILD
"RTN","PSOBBC",152,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^")
"RTN","PSOBBC",153,0)
 K PSOX
"RTN","PSOBBC",154,0)
PTC S (DFN,PSODFN)=$P(^PSRX(PSOBBC("IRXN"),0),"^",2)
"RTN","PSOBBC",155,0)
 S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSOBBC",156,0)
 S PSOBBC("DFLG")=0 D GET^PSOPTPST
"RTN","PSOBBC",157,0)
 I $G(PSOPTPST(2,PSODFN,.351))]"" S PSOBBC("DFLG")=1 D DEAD^PSOPTPST G PTX
"RTN","PSOBBC",158,0)
 N PSOTPEXT I $G(PSOBBC1("FROM"))="NEW",$D(^PS(52.91,PSODFN,0)) I '$P(^PS(52.91,PSODFN,0),"^",3)!($P(^(0),"^",3)>DT) D PDIR^PSOTPCAN(PSODFN) I $G(PSOTPEXT) K PSOTPEXT S PSOBBC("DFLG")=1 G PTX
"RTN","PSOBBC",159,0)
 K PSOTPEXT
"RTN","PSOBBC",160,0)
 I $G(PSOPTPST(2,PSODFN,.1))]"" D:'PSOBBC("INOK") PID W !,$C(7),?10,"PATIENT IS AN INPATIENT ON WARD ",PSOPTPST(2,PSODFN,.1)," !!" I 'PSOBBC("INOK") S PSOBBC("DFLG")=1 G PTX
"RTN","PSOBBC",161,0)
 K PSORX("CNH")
"RTN","PSOBBC",162,0)
 I $G(PSOPTPST(2,PSODFN,148))="YES" D:'PSOBBC("CNHOK") PID W !,$C(7),?10,"PATIENT IS IN A CONTRACT NURSING HOME !!" S:PSOBBC("CNHOK") PSORX("CNH")=1 I 'PSOBBC("CNHOK") S PSOBBC("DFLG")=1 G PTX
"RTN","PSOBBC",163,0)
 D:PSOBBC1("FROM")="NEW" COPAY^PSOPTPST
"RTN","PSOBBC",164,0)
PTX K PSOPTPST W:PSOBBC("DFLG") !!,$C(7),"Rx not filled"
"RTN","PSOBBC",165,0)
 Q
"RTN","PSOBBC",166,0)
 ;
"RTN","PSOBBC",167,0)
REFILL ;
"RTN","PSOBBC",168,0)
 ; Titration Rx refill request check from AudioFax/Internet
"RTN","PSOBBC",169,0)
 N PSORXIEN
"RTN","PSOBBC",170,0)
 S PSORXIEN=+$G(PSOBBC("IRXN"))
"RTN","PSOBBC",171,0)
 I PSORXIEN,$D(^PSRX(PSORXIEN,0)),$$TITRX^PSOUTL(PSORXIEN)="t" D  Q
"RTN","PSOBBC",172,0)
 . W !!,$C(7),"Rx# "_$$GET1^DIQ(52,PSORXIEN,.01)_" is marked as 'Titration Rx' and cannot be refilled.",!
"RTN","PSOBBC",173,0)
 . D PAUSE^VALM1
"RTN","PSOBBC",174,0)
 N PSOFROM S PSOFROM="REFILL",XFROM="BATCH"
"RTN","PSOBBC",175,0)
 D EN^PSOREF0(.PSOBBC)
"RTN","PSOBBC",176,0)
 Q
"RTN","PSOBBC",177,0)
REFILLX ;
"RTN","PSOBBC",178,0)
 Q
"RTN","PSOBBC",179,0)
 ;
"RTN","PSOBBC",180,0)
NEW ;
"RTN","PSOBBC",181,0)
 ; Titration Rx Renewal request check from AudioFax
"RTN","PSOBBC",182,0)
 N PSORXIEN,PSOACT
"RTN","PSOBBC",183,0)
 S PSORXIEN=+$G(PSOBBC("IRXN"))
"RTN","PSOBBC",184,0)
 I PSORXIEN,$D(^PSRX(PSORXIEN,0)),$$TITRX^PSOUTL(PSORXIEN)="t" D  Q
"RTN","PSOBBC",185,0)
 . W !!,$C(7),"Rx# "_$$GET1^DIQ(52,PSORXIEN,.01)_"    Drug: "_$$GET1^DIQ(52,PSORXIEN,6),!
"RTN","PSOBBC",186,0)
 . W !,"'Titration Rx' cannot be renewed."
"RTN","PSOBBC",187,0)
 . D PAUSE^VALM1
"RTN","PSOBBC",188,0)
 ;
"RTN","PSOBBC",189,0)
 ; Setting PSOACT to determine Listman actions available
"RTN","PSOBBC",190,0)
 I $$GET1^DIQ(52,PSORXIEN,310,"I") D
"RTN","PSOBBC",191,0)
 . S PSOACT=$S($D(^XUSEC("PSDRPH",DUZ)):"DEFX",$D(^XUSEC("PSORPH",DUZ)):"F",'$D(^XUSEC("PSORPH",DUZ))&($P($G(PSOPAR),"^",2)):"F",1:"")
"RTN","PSOBBC",192,0)
 E  D
"RTN","PSOBBC",193,0)
 . S PSOACT=$S($D(^XUSEC("PSORPH",DUZ)):"DEFX",'$D(^XUSEC("PSORPH",DUZ))&($P($G(PSOPAR),"^",2)):"F",1:"")
"RTN","PSOBBC",194,0)
 ;
"RTN","PSOBBC",195,0)
 N PSOFROM S (PSOFROM,XFROM)="BATCH"
"RTN","PSOBBC",196,0)
 S PSOBBC("OIRXN")=PSOBBC("IRXN")
"RTN","PSOBBC",197,0)
 S PSORNW("FILL DATE")=PSOBBC1("FILL DATE"),PSOOPT=3
"RTN","PSOBBC",198,0)
 S PSORX("DFLG")=0,PSOBBC("NOO")=$G(PSOBBCNO) D EN^PSORENW0(.PSOBBC)
"RTN","PSOBBC",199,0)
 S PSOBBC("MAIL/WINDOW")=PSOBBC1("MAIL/WINDOW")
"RTN","PSOBBC",200,0)
 S PSOBBC("EAOK")=$G(PSOBBC1("EAOK"))
"RTN","PSOBBC",201,0)
 S PSOBBC("QS")=PSOBBC1("QS")
"RTN","PSOBBC",202,0)
 S PSOBBC("INOK")=PSOBBC1("INOK")
"RTN","PSOBBC",203,0)
 S PSOBBC("CNHOK")=PSOBBC1("CNHOK")
"RTN","PSOBBC",204,0)
 S:$G(PSOBBC1("CLERK CODE")) PSOBBC("CLERK CODE")=PSOBBC1("CLERK CODE")
"RTN","PSOBBC",205,0)
 S:$G(PSOBBC1("EXPIRATION DATE")) PSOBBC("EXPIRATION DATE")=PSOBBC1("EXPIRATION DATE")
"RTN","PSOBBC",206,0)
 K PSORNW,PSOOPT
"RTN","PSOBBC",207,0)
 Q
"RTN","PSOBBC",208,0)
 ;
"RTN","PSOBBC",209,0)
EOJ ;
"RTN","PSOBBC",210,0)
 K PSOMSG,PSOREFXM,PSONOERR,PSOPLCK,PSOSD,PSOBBC,PSOBBC1,PSOBARID,Y,X,XFROM,PSOCOUU,PSOCOU,ACNT,ADFN,CLS,CMOP,CNT,FDR,HDR,PSCAN,JJ,POERR,PSOBCK,PSONEW3,PSORENW3,RXFL,PSOOPT
"RTN","PSOBBC",211,0)
 K PSORX,RFDT,RX1,RXS,SDA,PSONOOR,VALMBCK,VALMSG,SIG,SIGOK,STA,TM,TM1,VA,VADM,VAEL,VAPA
"RTN","PSOBBC",212,0)
 D CLEAN^PSOVER1 K ^TMP("PSORXDC",$J)
"RTN","PSOBBC",213,0)
 Q
"RTN","PSOBBC",214,0)
TRI ;Check for Tricare Rx's
"RTN","PSOBBC",215,0)
 S X="IBACUS" X ^%ZOSF("TEST") I '$T Q
"RTN","PSOBBC",216,0)
 I '$$TRI^IBACUS Q
"RTN","PSOBBC",217,0)
 Q:'$G(PPL)
"RTN","PSOBBC",218,0)
 ;PREV LINE, IN V 7 D ZOSF FIRST
"RTN","PSOBBC",219,0)
 N DA,NEWPPL,WWFLAG,PSOWRX,PSOWW,WWNEXT,WXRX,WPAT,WSITE,WDUZ,WFILL,WLOOP,WBILL,WPPLFLG,WWW
"RTN","PSOBBC",220,0)
 D DEV^PSOCPTRI
"RTN","PSOBBC",221,0)
 S NEWPPL=PPL S PPL=""
"RTN","PSOBBC",222,0)
 S (WWFLAG,WPPLFLG)=0 F PSOWW=1:1 S PSOWRX=$P(NEWPPL,",",PSOWW) D  Q:$G(WWFLAG)
"RTN","PSOBBC",223,0)
 .S WWNEXT=$P(NEWPPL,",",(PSOWW+1)) I WWNEXT=""!(WWNEXT=",") S WWFLAG=1
"RTN","PSOBBC",224,0)
 .I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOBBC",225,0)
 .S WPAT=$P($G(^PSRX(+PSOWRX,0)),"^",2),WSITE=+$G(PSOSITE),WDUZ=+$G(DUZ)
"RTN","PSOBBC",226,0)
 .S WFILL=0 F WLOOP=0:0 S WLOOP=$O(^PSRX(+PSOWRX,1,WLOOP)) Q:'WLOOP  S WFILL=WLOOP
"RTN","PSOBBC",227,0)
 .S WBILL=$$CHPUS^IBACUS(WPAT,DT,PSOWRX,WFILL,PSOLAP,WSITE,WDUZ)
"RTN","PSOBBC",228,0)
 .I '$G(WBILL) S WXRX(PSOWW,PSOWRX)="" Q
"RTN","PSOBBC",229,0)
 .S WPPLFLG=1
"RTN","PSOBBC",230,0)
 .S FLD(99)="99",FLD(99.1)="Awaiting CHAMPUS billing approval"
"RTN","PSOBBC",231,0)
 .N RSDT,ACT,PSUS,RXF,I,PSDA,NOW,IR,FDA,RFN S DA=PSOWRX D H^PSOCPTRH Q
"RTN","PSOBBC",232,0)
 I '$G(WPPLFLG) S PPL=NEWPPL Q
"RTN","PSOBBC",233,0)
 S WWW="" F  S WWW=$O(WXRX(WWW)) Q:WWW=""  D
"RTN","PSOBBC",234,0)
 .I $G(PPL)="" S PPL=$O(WXRX(WWW,0))_"," Q
"RTN","PSOBBC",235,0)
 .S PPL=PPL_$O(WXRX(WWW,0))_","
"RTN","PSOBBC",236,0)
 Q
"RTN","PSOBBC",237,0)
ULK ;
"RTN","PSOBBC",238,0)
 Q:$G(PSOBBC1("FROM"))'="NEW"
"RTN","PSOBBC",239,0)
 I '$G(PSODFN) Q
"RTN","PSOBBC",240,0)
 S X=PSODFN_";DPT(" D ULK^ORX2 K PSODFNX(PSODFN) Q
"RTN","PSOBBC",241,0)
ULP Q:$G(PSOBBC1("FROM"))'="NEW"
"RTN","PSOBBC",242,0)
 Q:'$G(PSODFN)
"RTN","PSOBBC",243,0)
 D UL^PSSLOCK(PSODFN)
"RTN","PSOBBC",244,0)
 Q
"RTN","PSOBBC",245,0)
ULRX ;
"RTN","PSOBBC",246,0)
 Q:$G(PSOBBC1("FROM"))'="REFILL"
"RTN","PSOBBC",247,0)
 Q:'$G(PSOREFXM)
"RTN","PSOBBC",248,0)
 D PSOUL^PSSLOCK(PSOREFXM)
"RTN","PSOBBC",249,0)
 K PSOREFXM
"RTN","PSOBBC",250,0)
 Q
"RTN","PSOBBC",251,0)
 ;
"RTN","PSOBBC",252,0)
SETX ;
"RTN","PSOBBC",253,0)
 S:$G(PSOBBC1("FROM"))="REFILL" XFROM="BATCH"
"RTN","PSOBBC",254,0)
 S:$G(PSOBBC1("FROM"))="NEW" XFROM="BATCH"
"RTN","PSOBBC",255,0)
 Q
"RTN","PSOBBC",256,0)
PID ;
"RTN","PSOBBC",257,0)
 I '$G(DFN) S DFN=+$G(PSODFN)
"RTN","PSOBBC",258,0)
 Q:'$G(DFN)
"RTN","PSOBBC",259,0)
 K VAPTYP D PID^VADPT
"RTN","PSOBBC",260,0)
 W !!,?9,$G(PSORX("NAME"))_"    ",$G(VA("BID"))
"RTN","PSOBBC",261,0)
 K VA("BID"),VA("PID")
"RTN","PSOBBC",262,0)
 Q
"RTN","PSODIR")
0^17^B42513700^B42450394
"RTN","PSODIR",1,0)
PSODIR ;BHAM ISC/SAB - asks data for rx order entry ; 9/17/07 5:03pm
"RTN","PSODIR",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**37,46,111,117,146,164,211,264,275,391,372,416,422,504**;DEC 1997;Build 15
"RTN","PSODIR",3,0)
 ;External reference PSDRUG( supported by DBIA 221
"RTN","PSODIR",4,0)
 ;External reference PS(50.7 supported by DBIA 2223
"RTN","PSODIR",5,0)
 ;External reference to VA(200 is supported by DBIA 10060
"RTN","PSODIR",6,0)
 ;----------------------------------------------------------------
"RTN","PSODIR",7,0)
 ;
"RTN","PSODIR",8,0)
PROV(PSODIR) ;
"RTN","PSODIR",9,0)
PROVEN ; Entry point for failed lookup
"RTN","PSODIR",10,0)
 K DIC,X,Y S:$G(PSOFDR)&($G(OR0)) DIC("B")=$P(^VA(200,$P($G(OR0),"^",5),0),"^")
"RTN","PSODIR",11,0)
 I '$D(PSODIR("CS")),$D(PSODRUG("DEA")) D
"RTN","PSODIR",12,0)
 .N DEA S PSODIR("CS")=0 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S PSODIR("CS")=1
"RTN","PSODIR",13,0)
 I $G(PSODIR("PROVIDER"))]"" S PSODIR("OLD VAL")=PSODIR("PROVIDER")
"RTN","PSODIR",14,0)
 S DIC="^VA(200,",DIC(0)="QEAM",PSODIR("FIELD")=0
"RTN","PSODIR",15,0)
 S DIC("W")="W ""     "",$P(^(""PS""),""^"",9)"
"RTN","PSODIR",16,0)
 S DIC("A")="PROVIDER: ",DIC("S")="I $D(^(""PS"")),$P(^(""PS""),""^""),$S('$P(^(""PS""),""^"",4):1,1:$P(^(""PS""),""^"",4)'<DT)"
"RTN","PSODIR",17,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" S DIC("S")=DIC("S")_",$P($G(^(""TPB"")),""^""),$P($G(^(""TPB"")),""^"",5)=0"
"RTN","PSODIR",18,0)
 S:$G(PSORX("PROVIDER NAME"))]"" DIC("B")=PSORX("PROVIDER NAME")
"RTN","PSODIR",19,0)
 D ^DIC K DIC
"RTN","PSODIR",20,0)
 I X[U,$L(X)>1 D:'$G(PSOEDIT) JUMP G PROVX
"RTN","PSODIR",21,0)
 I $D(DTOUT)!$D(DUOUT) S PSODIR("DFLG")=1 G PROVX
"RTN","PSODIR",22,0)
 I '$G(SPEED),Y=-1 G PROVEN
"RTN","PSODIR",23,0)
 Q:$G(SPEED)&(Y=-1)
"RTN","PSODIR",24,0)
 ;PSO*7*211; ADD CHECK FOR DEA# AND VA#
"RTN","PSODIR",25,0)
 I $P($G(PSODIR("CS")),"^",1)!($D(CLOZPAT)) N NDEA,SDEA S SDEA=$$DRGSCH() S NDEA=$$SDEA^XUSER(0,+Y,SDEA) I $L($P(NDEA,"^"))<3 D  G PROVEN
"RTN","PSODIR",26,0)
 .I NDEA=2 W $C(7),!!,"Provider not authorized to write Federal Schedule "_SDEA_" prescriptions.",! Q
"RTN","PSODIR",27,0)
 .W $C(7),!!,"Provider must have a valid DEA# or VA# to write prescriptions for this drug.",!
"RTN","PSODIR",28,0)
 ;PSO*7.0*391; Added check for DETOX#
"RTN","PSODIR",29,0)
 I $$DETOX^PSSOPKI($G(PSODRUG("IEN"))),$$DETOX^XUSER(+Y)="" W $C(7),!!,"Provider must have a DETOX# to order this drug.",! G PROVEN
"RTN","PSODIR",30,0)
 I $D(CLOZPAT),'$D(^XUSEC("YSCL AUTHORIZED",+Y)) D  G PROVEN
"RTN","PSODIR",31,0)
 .W $C(7),!!,"Provider must hold YSCL AUTHORIZED key to write prescriptions for clozapine.",!
"RTN","PSODIR",32,0)
 I '$G(PSODRUG("IEN")),'$G(PSORENW("DRUG IEN")) G NODRUG
"RTN","PSODIR",33,0)
NODRUG S PSODIR("PROVIDER")=+Y
"RTN","PSODIR",34,0)
 S (PSODIR("PROVIDER NAME"),PSORX("PROVIDER NAME"))=$P(Y,"^",2)
"RTN","PSODIR",35,0)
 I $G(PSODIR("OLD VAL"))'=+Y K PSODIR("GENERIC PROVIDER"),PSODIR("COSIGNING PROVIDER")
"RTN","PSODIR",36,0)
 I $G(PSODIR("OLD VAL"))'=$G(PSODIR("PROVIDER")),$P(Y,"^",2)="PROVIDER,OTHER"!($P(Y,"^",2)="PROVIDER,OUTSIDE") D GENERIC
"RTN","PSODIR",37,0)
 I $P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",7),$P(^("PS"),"^",8) D COSIGN
"RTN","PSODIR",38,0)
 I $G(PSODIR("COSIGNING PROVIDER")),'$P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",7) K PSODIR("COSIGNING PROVIDER")
"RTN","PSODIR",39,0)
PROVX K X,Y
"RTN","PSODIR",40,0)
 Q
"RTN","PSODIR",41,0)
 ;
"RTN","PSODIR",42,0)
DRGSCH() ; determine the drug schedule
"RTN","PSODIR",43,0)
 N ND3,SCH
"RTN","PSODIR",44,0)
 S SCH="",ND3=$P($G(^PSDRUG(PSODRUG("IEN"),"ND")),"^",3) S:+ND3 SCH=$$GET1^DIQ(50.68,ND3,19,"I")
"RTN","PSODIR",45,0)
 I +SCH>0!($G(PSODRUG("DEA"))="") Q SCH
"RTN","PSODIR",46,0)
 I "^4^5^"[+PSODRUG("DEA") Q +PSODRUG("DEA")
"RTN","PSODIR",47,0)
 Q $S($G(PSODRUG("DEA"))["A":+PSODRUG("DEA"),1:+PSODRUG("DEA")_"n")
"RTN","PSODIR",48,0)
 ;
"RTN","PSODIR",49,0)
GENERIC ;
"RTN","PSODIR",50,0)
 K DIR,DIC,PSODIR("GENERIC PROVIDER")
"RTN","PSODIR",51,0)
 S DIR(0)="52,30"
"RTN","PSODIR",52,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") GENERICX
"RTN","PSODIR",53,0)
 S PSODIR("GENERIC PROVIDER")=Y
"RTN","PSODIR",54,0)
GENERICX K X,Y
"RTN","PSODIR",55,0)
 Q
"RTN","PSODIR",56,0)
 ;
"RTN","PSODIR",57,0)
COSIGN ;
"RTN","PSODIR",58,0)
 K DIC
"RTN","PSODIR",59,0)
 I '$G(PSODIR("COSIGNING PROVIDER")),$P($G(RX3),"^",3) S PSODIR("COSIGNING PROVIDER")=$P(RX3,"^",3) G COSIGN1
"RTN","PSODIR",60,0)
 I $P($G(RX3),"^",3),$P($G(RX3),"^",3)'=$P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",8) D
"RTN","PSODIR",61,0)
 .W !!,"Previous Co-Signing Provider: "_$P(^VA(200,$P(RX3,"^",3),0),"^")
"RTN","PSODIR",62,0)
 .S PSODIR("COSIGNING PROVIDER")=$S($P(RX3,"^",3)'=PSODIR("COSIGNING PROVIDER"):PSODIR("COSIGNING PROVIDER"),1:$P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",8))
"RTN","PSODIR",63,0)
COSIGN1 S DIC(0)="QEAM",DIC="^VA(200,",DIC("B")=$S($G(PSODIR("COSIGNING PROVIDER")):$P(^VA(200,PSODIR("COSIGNING PROVIDER"),0),"^"),1:$P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",8))
"RTN","PSODIR",64,0)
 S DIC("S")="I $D(^(""PS"")),$P(^(""PS""),""^""),$S('$P(^(""PS""),""^"",4):1,1:$P(^(""PS""),""^"",4)'<DT)"
"RTN","PSODIR",65,0)
 S DIC("W")="W ""     "",$P(^(""PS""),""^"",9)",DIC("S")=DIC("S")_",'$P(^(""PS""),""^"",7)"
"RTN","PSODIR",66,0)
 S DIC("A")="COSIGNING PROVIDER: " D ^DIC K DIC
"RTN","PSODIR",67,0)
 I $D(DTOUT)!$D(DUOUT) S PSODIR("DFLG")=1 G COSIGNX
"RTN","PSODIR",68,0)
 S:+Y>0 PSODIR("COSIGNING PROVIDER")=+Y G:Y<0 COSIGN
"RTN","PSODIR",69,0)
COSIGNX K X,Y
"RTN","PSODIR",70,0)
 Q
"RTN","PSODIR",71,0)
DOSE(PSODIR) ;add dosing info
"RTN","PSODIR",72,0)
 N PSODOSNW S PSODOSNW=1
"RTN","PSODIR",73,0)
 D DOSE1^PSOORED5(.PSODIR)
"RTN","PSODIR",74,0)
EX K PSODOSE,PSOSCH,DOSE,DOOR,SCH,VERB,NOUN,DOSEOR,ENT,PSORTE,DRUA,DIR,X,Y,DIRUT,RTE,ERTE,DD,INS1,SINS1
"RTN","PSODIR",75,0)
 Q
"RTN","PSODIR",76,0)
INS(PSODIR) ;patient instructions
"RTN","PSODIR",77,0)
 N DA
"RTN","PSODIR",78,0)
 K INS1,DD,DIR,DIRUT S D=0 F  S D=$O(PSODIR("SIG",D)) Q:'D  S DD=$G(DD)+1
"RTN","PSODIR",79,0)
 I $G(DD)=1 S PSODIR("INS")=$G(PSODIR("SIG",1)) G INSD
"RTN","PSODIR",80,0)
 ;PSO*7*275 remove check for PSOINSFL just check for multi line sig
"RTN","PSODIR",81,0)
 I $G(DD)>1 D  G EX
"RTN","PSODIR",82,0)
 .K ^TMP($J) S D=0 F  S D=$O(PSODIR("SIG",D)) Q:'D  S ^TMP($J,"SIG",D,0)=PSODIR("SIG",D)
"RTN","PSODIR",83,0)
 .S DWPK=2,DWLW=80,DIC="^TMP($J,""SIG""," D EN^DIWE K PSODIR("SIG")
"RTN","PSODIR",84,0)
 .S D=0 F  S D=$O(^TMP($J,"SIG",D)) Q:'D  S PSODIR("SIG",D)=^TMP($J,"SIG",D,0)
"RTN","PSODIR",85,0)
 .D EN^PSOFSIG(.PSODIR,1) K DWLW,D,DWPK,^TMP($J)
"RTN","PSODIR",86,0)
 I $G(PSOINSFL)=0 G INSD
"RTN","PSODIR",87,0)
 I $G(PSOFDR),$G(ORD),$P($G(^PS(52.41,+$G(ORD),"EXT")),"^")'="" G INSD
"RTN","PSODIR",88,0)
 I $G(PSODIR("INS"))']"",$G(^PS(50.7,PSODRUG("OI"),"INS"))]"",'$D(PSODIR("FLD",114)) S (DIR("B"),PSOOEINS)=^PS(50.7,PSODRUG("OI"),"INS") G INSD  ;*422
"RTN","PSODIR",89,0)
 S (DIR("B"),PSOOEINS)=$G(PSODIR("SIG",1))  ;*422
"RTN","PSODIR",90,0)
INSD S DIR(0)="52,114" S:$G(PSODIR("INS"))]"" DIR("B")=PSODIR("INS")
"RTN","PSODIR",91,0)
 D DIR
"RTN","PSODIR",92,0)
 I $G(PSODIR("DFLG")) S (PSODIR("INS"),PSODIR("SIG"),PSODIR("SIG",1))=$G(PSOOEINS),PSODIR("SINS")=$G(PSOOSINS) D EN^PSOFSIG(.PSODIR,0)
"RTN","PSODIR",93,0)
 G:$G(PSODIR("DFLG"))!(PSODIR("FIELD")) EX
"RTN","PSODIR",94,0)
 I X'="",X'="@" S PSODIR("INS")=Y D SIG^PSOHELP G INSD:'$D(X)
"RTN","PSODIR",95,0)
 I $G(INS1)]"" D EN^DDIOL($E(INS1,2,9999999)) S (PSODIR("SIG",1),PSODIR("SIG"))=$E(INS1,2,9999999)
"RTN","PSODIR",96,0)
 I X="@" S PSODELINS=1 D DELINS^PSOHELP3 I $G(PSODELINS) S (PSODIR("FLD",114),PSODIR("FLD",114.1))="" K PSODIR("INS"),PSODIR("SIG"),PSODIR("SINS")  ;*422
"RTN","PSODIR",97,0)
 D EN^PSOFSIG(.PSODIR,1) I $O(SIG(0)) S SIGOK=1
"RTN","PSODIR",98,0)
 G EX
"RTN","PSODIR",99,0)
 Q
"RTN","PSODIR",100,0)
SINS(PSODIR) ;other lang. patient instructions
"RTN","PSODIR",101,0)
 K SINS1,DIR
"RTN","PSODIR",102,0)
 S DIR(0)="52,114.1" S:$G(PSODIR("SINS"))]"" DIR("B")=PSODIR("SINS")
"RTN","PSODIR",103,0)
 I $G(PSODIR("SINS"))']"",$G(^PS(50.7,PSODRUG("OI"),"INS1"))]"",'$D(PSODIR("FLD",114)),$G(PSOOEINS)]"" S (DIR("B"),PSOOSINS)=^PS(50.7,PSODRUG("OI"),"INS1")
"RTN","PSODIR",104,0)
 D DIR I $G(PSODIR("DFLG")) S (PSODIR("INS"),PSODIR("SIG"),PSODIR("SIG",1))=$G(PSOOEINS),PSODIR("SINS")=$G(PSOOSINS) D EN^PSOFSIG(.PSODIR,0) G EX
"RTN","PSODIR",105,0)
 I X'="",X'="@" S PSODIR("SINS")=Y D SSIG^PSOHELP
"RTN","PSODIR",106,0)
 I $G(SINS1)]"" D EN^DDIOL($E(SINS1,2,9999999)) S PSODIR("SINS")=$E(SINS1,2,9999999)
"RTN","PSODIR",107,0)
 I X="@" S PSODELINS=2 D DELINS^PSOHELP3 I $G(PSODELINS) S (PSODIR("FLD",114),PSODIR("FLD",114.1))="" K PSODIR("INS"),PSODIR("SIG"),PSODIR("SINS") D EN^PSOFSIG(.PSODIR,1) ;*422
"RTN","PSODIR",108,0)
 G EX
"RTN","PSODIR",109,0)
 Q
"RTN","PSODIR",110,0)
 ;
"RTN","PSODIR",111,0)
DIR ;
"RTN","PSODIR",112,0)
 S PSODIR("FIELD")=0
"RTN","PSODIR",113,0)
 G:$G(DIR(0))']"" DIRX
"RTN","PSODIR",114,0)
 D ^DIR K DIR,DIE,DIC,DA
"RTN","PSODIR",115,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)),$L($G(X))'>1 S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR",116,0)
 I X[U,$L(X)>1 D:'$G(PSOEDIT) JUMP
"RTN","PSODIR",117,0)
DIRX K DIRUT,DTOUT,DUOUT,DIROUT,PSOX
"RTN","PSODIR",118,0)
 Q
"RTN","PSODIR",119,0)
 ;
"RTN","PSODIR",120,0)
JUMP ;
"RTN","PSODIR",121,0)
 I $G(PSOEDIT)!($G(OR0)) S PSODIR("DFLG")=1 Q
"RTN","PSODIR",122,0)
 S X=$P(X,"^",2),DIC="^DD(52,",DIC(0)="QM" D ^DIC K DIC
"RTN","PSODIR",123,0)
 I Y=-1 S PSODIR("FIELD")=$G(PSODIR("FLD")) G JUMPX
"RTN","PSODIR",124,0)
 I $G(PSONEW1)=0 D JUMP^PSONEW1 G JUMPX
"RTN","PSODIR",125,0)
 I $G(PSOREF1)=0 D JUMP^PSOREF1 G JUMPX
"RTN","PSODIR",126,0)
 I $G(PSONEW3)=0 D JUMP^PSONEW3 G JUMPX
"RTN","PSODIR",127,0)
 I $G(PSORENW3)=0 D JUMP^PSORENW3 G JUMPX
"RTN","PSODIR",128,0)
JUMPX S X="^"_X
"RTN","PSODIR",129,0)
 Q
"RTN","PSODIR2")
0^13^B28893582^B30158277
"RTN","PSODIR2",1,0)
PSODIR2 ;IHS/DSD/JCM - rx order entry contd ;01/27/93 7:12
"RTN","PSODIR2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**3,9,26,46,124,146,139,152,166,504**;DEC 1997;Build 15
"RTN","PSODIR2",3,0)
 ;External reference to ^DD(52 supported by DBIA 999
"RTN","PSODIR2",4,0)
 ;External reference to ^VA(200 supported by DBIA 10060
"RTN","PSODIR2",5,0)
 ;External reference to ^%DTC supported by DBIA 10000
"RTN","PSODIR2",6,0)
 ;External reference to ^DIC supported by DBIA 10006
"RTN","PSODIR2",7,0)
 ;External reference to ^DIR supported by DBIA 10026
"RTN","PSODIR2",8,0)
 ;
"RTN","PSODIR2",9,0)
 ;---------------------------------------------------------------------
"RTN","PSODIR2",10,0)
 ;
"RTN","PSODIR2",11,0)
EXP(PSODIR) ;
"RTN","PSODIR2",12,0)
 K DIR,DIC
"RTN","PSODIR2",13,0)
 I $G(PSODRUG("EXPIRATION DATE"))]"" S Y=PSODRUG("EXPIRATION DATE") X ^DD("DD") S PSORX("EXPIRATION DATE")=Y
"RTN","PSODIR2",14,0)
 S DIR("A")="EXPIRES",DIR("B")=$S($G(PSORX("EXPIRATION DATE"))]"":PSORX("EXPIRATION DATE"),1:"T+6M")
"RTN","PSODIR2",15,0)
 S DIR(0)="D^NOW::EX"
"RTN","PSODIR2",16,0)
 S DIR("?")="Both the month and date are required."
"RTN","PSODIR2",17,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") EXPX
"RTN","PSODIR2",18,0)
 S PSODIR("EXPIRATION DATE")=Y
"RTN","PSODIR2",19,0)
EXPX K X,Y
"RTN","PSODIR2",20,0)
 Q
"RTN","PSODIR2",21,0)
 ;
"RTN","PSODIR2",22,0)
CLINIC(PSODIR) ;
"RTN","PSODIR2",23,0)
 K DIR,DIC S PSODIR("FIELD")=0
"RTN","PSODIR2",24,0)
 S DIR(0)="52,5" S:$G(PSORX("CLINIC"))]"" DIR("B")=PSORX("CLINIC"),DIR("A")="CLINIC"
"RTN","PSODIR2",25,0)
 D ^DIR G:PSODIR("DFLG")!PSODIR("FIELD") CLINICX
"RTN","PSODIR2",26,0)
 I +Y>0 S PSODIR("CLINIC")=+Y,PSORX("CLINIC")=$P(Y,"^",2)
"RTN","PSODIR2",27,0)
 E  S (PSORX("CLINIC"),PSODIR("CLINIC"))=""
"RTN","PSODIR2",28,0)
CLINICX K X,Y,PSOX,DIC
"RTN","PSODIR2",29,0)
 Q
"RTN","PSODIR2",30,0)
 ;
"RTN","PSODIR2",31,0)
MW(PSODIR) ;
"RTN","PSODIR2",32,0)
 K DIR,DIC
"RTN","PSODIR2",33,0)
 S DIR(0)="52,11" S:$G(POERR)&'$D(PSORX("MAIL/WINDOW")) PSORX("MAIL/WINDOW")=$S($P($G(OR0),"^",17)="M":"MAIL",1:"WINDOW")
"RTN","PSODIR2",34,0)
 S DIR("B")=$S($G(PSORX("MAIL/WINDOW"))]"":PSORX("MAIL/WINDOW"),$G(PSOTPBFG)&($G(PSOFROM)="NEW"):"MAIL",1:"WINDOW")
"RTN","PSODIR2",35,0)
 D DIR G:$G(PSODIR("DFLG"))!$G(PSODIR("FIELD")) MWX
"RTN","PSODIR2",36,0)
 I $G(Y(0))']"" S PSODIR("DFLG")=1 G MWX
"RTN","PSODIR2",37,0)
 S PSODIR("MAIL/WINDOW")=Y,PSORX("MAIL/WINDOW")=Y(0)
"RTN","PSODIR2",38,0)
 I $G(PSORX("EDIT"))]"",PSODIR("MAIL/WINDOW")'="W" K PSODIR("METHOD OF PICK-UP")
"RTN","PSODIR2",39,0)
MW1 G:PSODIR("MAIL/WINDOW")'="W"!('$P($G(PSOPAR),"^",12)) MWX
"RTN","PSODIR2",40,0)
 S DIR(0)="52,35O"
"RTN","PSODIR2",41,0)
 S:$G(PSORX("METHOD OF PICK-UP"))]"" DIR("B")=PSORX("METHOD OF PICK-UP")
"RTN","PSODIR2",42,0)
 D DIR G:$G(PSODIR("DFLG")) MWX
"RTN","PSODIR2",43,0)
 I X[U W !,"Cannot jump to another field ..",! G MW1
"RTN","PSODIR2",44,0)
 S (PSODIR("METHOD OF PICK-UP"),PSORX("METHOD OF PICK-UP"))=Y
"RTN","PSODIR2",45,0)
MWX K X,Y
"RTN","PSODIR2",46,0)
 Q
"RTN","PSODIR2",47,0)
 ;
"RTN","PSODIR2",48,0)
RMK(PSODIR) ;
"RTN","PSODIR2",49,0)
RMKEN K DIR,DIC
"RTN","PSODIR2",50,0)
 S DIR(0)="52,12"
"RTN","PSODIR2",51,0)
 S:$G(PSODIR("REMARKS"))]"" DIR("B")=PSODIR("REMARKS")
"RTN","PSODIR2",52,0)
 D DIR G:PSODIR("DFLG") RMKX
"RTN","PSODIR2",53,0)
 I X[U W !,"Cannot jump to another field ..",! G RMKEN
"RTN","PSODIR2",54,0)
 S:$L(X)>0 PSODIR("REMARKS")=X
"RTN","PSODIR2",55,0)
 S:X="@" PSODIR("REMARKS")=""
"RTN","PSODIR2",56,0)
RMKX K X,Y
"RTN","PSODIR2",57,0)
 Q
"RTN","PSODIR2",58,0)
 ;
"RTN","PSODIR2",59,0)
ISSDT(PSODIR) ;
"RTN","PSODIR2",60,0)
 K DIR,DIC
"RTN","PSODIR2",61,0)
 S DIR("A")="ISSUE DATE",DIR("B")=$S($G(POERR)&($G(PSORX("ISSUE DATE"))']"")&($G(PSODIR("ISSUE DATE"))]""):PSODIR("ISSUE DATE"),$G(PSORX("ISSUE DATE"))]"":PSORX("ISSUE DATE"),1:"TODAY")
"RTN","PSODIR2",62,0)
 I DIR("B") S Y=DIR("B") X ^DD("DD") S DIR("B")=Y
"RTN","PSODIR2",63,0)
 S DIR(0)="52,1"
"RTN","PSODIR2",64,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") ISSDTX
"RTN","PSODIR2",65,0)
 S (PSODIR("ISSUE DATE"),PSOID)=Y
"RTN","PSODIR2",66,0)
 X ^DD("DD") S (PSORX("ISSUE DATE"),PSODIR("ISSUE DATE"))=Y
"RTN","PSODIR2",67,0)
ISSDTX K X,Y
"RTN","PSODIR2",68,0)
 Q
"RTN","PSODIR2",69,0)
 ;
"RTN","PSODIR2",70,0)
FILLDT(PSODIR) ;
"RTN","PSODIR2",71,0)
 K DIR,DIC
"RTN","PSODIR2",72,0)
 S:'$G(PSONEW("DAYS SUPPLY")) PSONEW("DAYS SUPPLY")=30,PSONEW("# OF REFILLS")=1
"RTN","PSODIR2",73,0)
 S DIR("A")="FILL DATE",DIR("B")=$S($G(PSORX("FILL DATE"))]"":PSORX("FILL DATE"),1:"TODAY")
"RTN","PSODIR2",74,0)
 S X2=PSONEW("DAYS SUPPLY")*(PSONEW("# OF REFILLS")+1)\1
"RTN","PSODIR2",75,0)
 S X1=$S($G(PSOID):PSOID,1:DT)
"RTN","PSODIR2",76,0)
 S X2=$S(+$G(PSODIR("CS")):184,1:366)
"RTN","PSODIR2",77,0)
 D C^%DTC S PSOFDMX=$P(X,".") I DT>X S Y=$S($G(PSOID):PSOID,1:PSORX("ISSUE DATE")) X ^DD("DD") S DIR("B")=Y
"RTN","PSODIR2",78,0)
 S DIR(0)="D^"_$S($G(PSOID):PSOID,+$G(PSODIR("ISSUE DATE")):PSODIR("ISSUE DATE"),1:DT)_$S($G(DUZ("AG"))="I":":"_DT_":EX",1:":"_PSOFDMX_":EX")
"RTN","PSODIR2",79,0)
 S Y=PSOFDMX X ^DD("DD")
"RTN","PSODIR2",80,0)
 S DIR("?",1)="The earliest fill date allowed is determined by the ISSUE DATE,"
"RTN","PSODIR2",81,0)
 S DIR("?",2)="the FILL DATE cannot be before the ISSUE DATE or AFTER the Expiration Date "
"RTN","PSODIR2",82,0)
 S DIR("?")=Y_".  Both the month and date are required."
"RTN","PSODIR2",83,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") FILLDTX
"RTN","PSODIR2",84,0)
 S PSODIR("FILL DATE")=Y
"RTN","PSODIR2",85,0)
 X ^DD("DD") S PSORX("FILL DATE")=Y
"RTN","PSODIR2",86,0)
FILLDTX K X,Y,PSOFDMX
"RTN","PSODIR2",87,0)
 Q
"RTN","PSODIR2",88,0)
 ;
"RTN","PSODIR2",89,0)
CLERK(PSODIR) ;
"RTN","PSODIR2",90,0)
 I $G(DUZ("AG"))'="I" D  G CLERKX
"RTN","PSODIR2",91,0)
 .S PSODIR("CLERK CODE")=$S($G(PSOFDR):$P(OR0,"^",4),1:DUZ),PSORX("CLERK CODE")=$P($G(^VA(200,PSODIR("CLERK CODE"),0)),"^")
"RTN","PSODIR2",92,0)
 K DIR,DIC
"RTN","PSODIR2",93,0)
 S DIR("A")="CLERK",DIR("B")=$S($G(PSORX("CLERK CODE"))]"":PSORX("CLERK CODE"),1:$P($G(^VA(200,DUZ,0)),"^",2)),DIR(0)="52,16"
"RTN","PSODIR2",94,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") CLERKX
"RTN","PSODIR2",95,0)
 S PSODIR("CLERK CODE")=+Y,PSORX("CLERK CODE")=$P(Y,"^")
"RTN","PSODIR2",96,0)
CLERKX Q
"RTN","PSODIR2",97,0)
 ;
"RTN","PSODIR2",98,0)
DIR ;
"RTN","PSODIR2",99,0)
 S PSODIR("FIELD")=0
"RTN","PSODIR2",100,0)
 G:$G(DIR(0))']"" DIRX
"RTN","PSODIR2",101,0)
 D ^DIR K DIR,DIE,DIC,DA I X="^^" S (PSODIR("QFLG"),PSODIR("DFLG"))=1 G DIRX
"RTN","PSODIR2",102,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)),$L($G(X))'>1!(Y="") S PSODIR("DFLG")=1 S:$G(SPEED) PSODIR("QFLG")=1 G DIRX
"RTN","PSODIR2",103,0)
 I $D(DUOUT)!($D(DTOUT)),$G(SPEED) S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR2",104,0)
 I X[U,$L(X)>1 D JUMP
"RTN","PSODIR2",105,0)
DIRX K DIRUT,DTOUT,DUOUT,DIROUT,PSOX
"RTN","PSODIR2",106,0)
 Q
"RTN","PSODIR2",107,0)
 ;
"RTN","PSODIR2",108,0)
JUMP ;
"RTN","PSODIR2",109,0)
 I $G(PSOEDIT)!($G(OR0)) S PSODIR("DFLG")=1 Q
"RTN","PSODIR2",110,0)
 S X=$P(X,"^",2),DIC="^DD(52,",DIC(0)="QM" D ^DIC K DIC
"RTN","PSODIR2",111,0)
 I Y=-1 S PSODIR("FIELD")=$G(PSODIR("FLD")) G JUMPX
"RTN","PSODIR2",112,0)
 I $G(PSONEW1)=0 D JUMP^PSONEW1 G JUMPX
"RTN","PSODIR2",113,0)
 I $G(PSONEW3)=0 D JUMP^PSONEW3 G JUMPX
"RTN","PSODIR2",114,0)
 I $G(PSORENW3)=0 D JUMP^PSORENW3 G JUMPX
"RTN","PSODIR2",115,0)
JUMPX S X="^"_X
"RTN","PSODIR2",116,0)
 Q
"RTN","PSODIR2",117,0)
 ;Reset refills when drug changed to a controlled sub
"RTN","PSODIR2",118,0)
RFRSET ;
"RTN","PSODIR2",119,0)
 N RFN,RFNC
"RTN","PSODIR2",120,0)
 S (RFN,RFNC)=0
"RTN","PSODIR2",121,0)
 F  S RFN=$O(^PSRX(+$G(PSODIR("IRXN")),1,RFN)) Q:'RFN  S RFNC=RFNC+1
"RTN","PSODIR2",122,0)
 I $D(PSODIR("FIELD")) S PSODIR("FIELD")=0
"RTN","PSODIR2",123,0)
 S PSODIR("# OF REFILLS")=RFNC
"RTN","PSODIR2",124,0)
 S VALMSG="The drug has been changed and no longer allows refills."
"RTN","PSODIR2",125,0)
 W !,VALMSG,!
"RTN","PSODIR2",126,0)
 Q
"RTN","PSODRG")
0^18^B93661712^B93820988
"RTN","PSODRG",1,0)
PSODRG ;IHS/DSD/JCM - ORDER ENTRY DRUG SELECTION ;2/16/12 12:50pm
"RTN","PSODRG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,23,36,53,54,46,112,139,207,148,243,268,324,251,375,387,398,390,427,411,458,504**;DEC 1997;Build 15
"RTN","PSODRG",3,0)
 ;Reference to ^PSDRUG( supported by DBIA 221
"RTN","PSODRG",4,0)
 ;Reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODRG",5,0)
 ;Reference to $$PROMPT^PSSDIN supported by DBIA 3166
"RTN","PSODRG",6,0)
 ;Reference to EN^PSSDIN supported by DBIA 3166
"RTN","PSODRG",7,0)
 ;Reference to $$GETNDC^PSSNDCUT supported by DBIA 4707
"RTN","PSODRG",8,0)
 ;Reference to ^OROCAPI controlled subscription supported by DBIA 5367
"RTN","PSODRG",9,0)
 ;Reference to $$OITM^ORX8 supported by DBIA 5469
"RTN","PSODRG",10,0)
 ;Reference to ^VADPT supported by DBIA 10061
"RTN","PSODRG",11,0)
 ;Reference to IN^PSSHRQ2 supported by DBIA 5369
"RTN","PSODRG",12,0)
 ;Reference to ^XTMP("ORRDI" supported by DBIA 5440
"RTN","PSODRG",13,0)
 ;----------------------------------------------------------
"RTN","PSODRG",14,0)
START ;
"RTN","PSODRG",15,0)
 S (PSONEW("DFLG"),PSONEW("FIELD"),PSODRG("QFLG"))=0 K PSORX("DFLG")
"RTN","PSODRG",16,0)
 D @($S(+$G(PSOEDIT)=1&('$D(DA)):"SELECT^PSODRGN",1:"SELECT"))
"RTN","PSODRG",17,0)
 G:$G(PSORXED("DFLG")) END ; Select Drug
"RTN","PSODRG",18,0)
 I $G(PSORX("EDIT")),$G(PSOY),$G(PSODRUG("IEN"))=+PSOY D  G:$G(PSORXED("DFLG")) END
"RTN","PSODRG",19,0)
 . N NDC D NDC(+$G(PSORXED("IRXN")),0,+PSOY,.NDC) I $G(NDC)="^" S PSORXED("DFLG")=1 Q
"RTN","PSODRG",20,0)
 . I $G(NDC)'="" S (PSODRUG("NDC"),PSORXED("FLD",27))=NDC
"RTN","PSODRG",21,0)
 ;
"RTN","PSODRG",22,0)
 I $G(PSORX("EDIT"))]"",'PSONEW("FIELD") D TRADE
"RTN","PSODRG",23,0)
 G:$G(PSONEW("DFLG"))!($G(PSODRG("QFLG")))!($G(PSORXED("DFLG"))) END
"RTN","PSODRG",24,0)
 D SET ; Set various drug information
"RTN","PSODRG",25,0)
 D NFI ; Display dispense drug/orderable item text
"RTN","PSODRG",26,0)
 D:'$G(PSOEDIT) POST I $G(PSORX("DFLG")) S PSONEW("DFLG")=1 K:'$G(PSORX("EDIT")) PSORX("DFLG") ; Do any post selection action
"RTN","PSODRG",27,0)
END ;D EOJ
"RTN","PSODRG",28,0)
 Q
"RTN","PSODRG",29,0)
 ;------------------------------------------------------------
"RTN","PSODRG",30,0)
 ;
"RTN","PSODRG",31,0)
SELECT ;
"RTN","PSODRG",32,0)
 K:'$G(PSORXED) CLOZPAT
"RTN","PSODRG",33,0)
 K IT,DIC,X,Y,PSODRUG("TRADE NAME"),PSODRUG("NDC"),PSODRUG("DAW"),PSODRUG("BAD") S:$G(POERR)&($P($G(OR0),"^",9)) Y=$P(^PSDRUG($P(OR0,"^",9),0),"^")
"RTN","PSODRG",34,0)
 I $G(PSODRUG("IEN"))]"" S Y=PSODRUG("NAME"),PSONEW("OLD VAL")=PSODRUG("IEN")
"RTN","PSODRG",35,0)
 W !,"DRUG: "_$S($G(Y)]"":Y_"// ",1:"") R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSODRG",36,0)
 I X="",$G(Y)]"" S:Y X=Y S:'X X=$G(PSODRUG("IEN")) S:X X="`"_X
"RTN","PSODRG",37,0)
 G:X="" SELECT
"RTN","PSODRG",38,0)
 I X?1."?" W !!,"Answer with DRUG NUMBER, or GENERIC NAME, or VA PRODUCT NAME, or",!,"NATIONAL DRUG CLASS, or SYNONYM" G SELECT
"RTN","PSODRG",39,0)
 I $G(PSORXED),X["^" S PSORXED("DFLG")=1 G SELECTX
"RTN","PSODRG",40,0)
 I X="^"!(X["^^")!($D(DTOUT)) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODRG",41,0)
 I '$G(POERR),X[U,$L(X)>1 S PSODIR("FLD")=PSONEW("FLD") D JUMP^PSODIR1 S:$G(PSODIR("FIELD")) PSONEW("FIELD")=PSODIR("FIELD") K PSODIR S PSODRG("QFLG")=1 G SELECTX
"RTN","PSODRG",42,0)
 S DIC=50,DIC(0)="EMQZVT",DIC("T")="",D="B^C^VAPN^VAC"
"RTN","PSODRG",43,0)
 S DIC("S")="I $S('$D(^PSDRUG(+Y,""I"")):1,'^(""I""):1,DT'>^(""I""):1,1:0),$S($P($G(^PSDRUG(+Y,2)),""^"",3)'[""O"":0,1:1),$D(^PSDRUG(""ASP"",+$G(^(2)),+Y))"
"RTN","PSODRG",44,0)
 D MIX^DIC1 K DIC,D
"RTN","PSODRG",45,0)
 I $D(DTOUT) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODRG",46,0)
 I $D(DUOUT) K DUOUT G SELECT
"RTN","PSODRG",47,0)
 I Y<0 G SELECT
"RTN","PSODRG",48,0)
 S:$G(PSONEW("OLD VAL"))=+Y&('$G(PSOEDIT)) PSODRG("QFLG")=1
"RTN","PSODRG",49,0)
 K PSOY S PSOY=Y,PSOY(0)=Y(0)
"RTN","PSODRG",50,0)
 I $P(PSOY(0),"^")="OTHER DRUG"!($P(PSOY(0),"^")="OUTSIDE DRUG") D TRADE
"RTN","PSODRG",51,0)
SELECTX K X,Y,DTOUT,DUOUT,PSONEW("OLD VAL")
"RTN","PSODRG",52,0)
 Q
"RTN","PSODRG",53,0)
 ;
"RTN","PSODRG",54,0)
NDC(RX,RFL,DRG,NDC) ; Editing NDC for Released Rx's or for Unresolved ECME Rejects
"RTN","PSODRG",55,0)
 S NDC=$S($G(NDC)'="":$G(NDC),1:$$GETNDC^PSONDCUT(RX,.RFL))
"RTN","PSODRG",56,0)
 ; Check if we should edit the NDC
"RTN","PSODRG",57,0)
 ; Needs to be released or have unresolved billable rejects (PSO*7*427)
"RTN","PSODRG",58,0)
 ;
"RTN","PSODRG",59,0)
 N PSOCONT S PSOCONT=0                         ; continue flag
"RTN","PSODRG",60,0)
 D  Q:'PSOCONT                                 ; get out if NDC edit not allowed
"RTN","PSODRG",61,0)
 . I $$RXRLDT^PSOBPSUT(RX,RFL) S PSOCONT=1 Q   ; Released - continue and allow edit
"RTN","PSODRG",62,0)
 . I $$FIND^PSOREJUT(RX,RFL),$$STATUS^PSOBPSUT(RX,RFL)'="" S PSOCONT=1 Q    ; unreleased w/unresolved billable rejections
"RTN","PSODRG",63,0)
 . Q
"RTN","PSODRG",64,0)
 ;
"RTN","PSODRG",65,0)
 S NDC=$S($G(NDC)'="":$G(NDC),1:$$GETNDC^PSONDCUT(RX,.RFL))
"RTN","PSODRG",66,0)
 D NDCEDT^PSONDCUT(RX,.RFL,$G(DRG),$G(PSOSITE),.NDC)
"RTN","PSODRG",67,0)
 Q
"RTN","PSODRG",68,0)
 ;
"RTN","PSODRG",69,0)
TRADE ;
"RTN","PSODRG",70,0)
 K DIR,DIC,DA,X,Y
"RTN","PSODRG",71,0)
 S DIR(0)="52,6.5" S:$G(PSOTRN)]"" DIR("B")=$G(PSOTRN) D ^DIR K DIR,DIC
"RTN","PSODRG",72,0)
 I X="@" S Y=X K DIRUT
"RTN","PSODRG",73,0)
 I $D(DIRUT) S:$D(DUOUT)!$D(DTOUT)&('$D(PSORX("EDIT"))) PSONEW("DFLG")=1 G TRADEX
"RTN","PSODRG",74,0)
 S PSODRUG("TRADE NAME")=Y
"RTN","PSODRG",75,0)
TRADEX I $G(PSORXED("DFLG")),$D(DIRUT) S PSORXED("DFLG")=1
"RTN","PSODRG",76,0)
 K DIRUT,DTOUT,DUOUT,X,Y,DA,DR,DIE
"RTN","PSODRG",77,0)
 Q
"RTN","PSODRG",78,0)
SET ;
"RTN","PSODRG",79,0)
 N STAT S PSODRUG("IEN")=+PSOY,PSODRUG("VA CLASS")=$P(PSOY(0),"^",2)
"RTN","PSODRG",80,0)
 S PSODRUG("NAME")=$P(PSOY(0),"^")
"RTN","PSODRG",81,0)
 S:+$G(^PSDRUG(+PSOY,2)) PSODRUG("OI")=+$G(^(2)),PSODRUG("OIN")=$P(^PS(50.7,+$G(^(2)),0),"^")
"RTN","PSODRG",82,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(+PSOY,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSODRG",83,0)
 S PSODRUG("MAXDOSE")=$P(PSOY(0),"^",4),PSODRUG("DEA")=$P(PSOY(0),"^",3)
"RTN","PSODRG",84,0)
 S PSODRUG("CLN")=$S($D(^PSDRUG(+PSOY,"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSODRG",85,0)
 S PSODRUG("SIG")=$P(PSOY(0),"^",5)
"RTN","PSODRG",86,0)
 I $G(PSODRUG("NDC"))="" S PSODRUG("NDC")=$$GETNDC^PSSNDCUT(+PSOY,$G(PSOSITE))
"RTN","PSODRG",87,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,+PSOY,81)
"RTN","PSODRG",88,0)
 S PSODRUG("STKLVL")=$G(^PSDRUG(+PSOY,660.1))
"RTN","PSODRG",89,0)
 G:$G(^PSDRUG(+PSOY,660))']"" SETX
"RTN","PSODRG",90,0)
 S PSOX1=$G(^PSDRUG(+PSOY,660))
"RTN","PSODRG",91,0)
 S PSODRUG("COST")=$P($G(PSOX1),"^",6)
"RTN","PSODRG",92,0)
 S PSODRUG("UNIT")=$P($G(PSOX1),"^",8)
"RTN","PSODRG",93,0)
 S PSODRUG("EXPIRATION DATE")=$P($G(PSOX1),"^",9)
"RTN","PSODRG",94,0)
SETX K PSOX1,PSOY
"RTN","PSODRG",95,0)
 Q
"RTN","PSODRG",96,0)
NFI ;display restriction/guidelines
"RTN","PSODRG",97,0)
 D EN^PSSDIN(PSODRUG("OI"),PSODRUG("IEN")) S NFI=$$PROMPT^PSSDIN
"RTN","PSODRG",98,0)
 I NFI]"","ODY"[NFI D TD^PSONFI
"RTN","PSODRG",99,0)
 K NFI Q
"RTN","PSODRG",100,0)
POST ;order checks
"RTN","PSODRG",101,0)
 N LIST S LIST="PSOPEPS"
"RTN","PSODRG",102,0)
 K PSODOSD,^TMP("PSORXDC",$J),^TMP($J,LIST),^TMP("PSODAOC",$J)
"RTN","PSODRG",103,0)
 K ZDGDG,ZTHER,IT,PSODLQT,PSODOSD
"RTN","PSODRG",104,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) S ^TMP("PSODAOC",$J,"NORDI",1,0)="Remote data not available - Only local order checks processed."
"RTN","PSODRG",105,0)
 S ^TMP($J,LIST,"IN","PING")="" D IN^PSSHRQ2(LIST)
"RTN","PSODRG",106,0)
 K DIR I $P(^TMP($J,LIST,"OUT",0),"^")=-1 D
"RTN","PSODRG",107,0)
 .D DATACK^PSODDPRE
"RTN","PSODRG",108,0)
 .S ^TMP("PSODAOC",$J,"NOSYS",1,0)="No Enhanced Order Checks can be performed. Reason(s): "_$P($G(^TMP($J,LIST,"OUT",0)),"^",2)
"RTN","PSODRG",109,0)
 K ^TMP($J,LIST,"IN"),^TMP($J,LIST,"OUT","EXCEPTIONS")
"RTN","PSODRG",110,0)
 G:$G(PSORX("DFLG"))!($G(PSORXED("DFLG"))) POSTX
"RTN","PSODRG",111,0)
 K PSORX("INTERVENE"),PSOQUIT N STAT,SIG,PTR,NDF,VAP S PSORX("DFLG")=0
"RTN","PSODRG",112,0)
 W !! D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",113,0)
 D ^PSOBUILD
"RTN","PSODRG",114,0)
 D @$S($G(COPY):"^PSOCPPRE",1:"^PSODDPRE") ; Duplicate drug check
"RTN","PSODRG",115,0)
 G:$G(PSORX("DFLG")) POSTX
"RTN","PSODRG",116,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",117,0)
 I $P($G(^PSDRUG(PSODRUG("IEN"),"CLOZ1")),"^")="PSOCLO1" W !,"Now doing Clozapine Order checks.  Please wait...",! D CLOZ
"RTN","PSODRG",118,0)
 G:PSORX("DFLG") POSTX
"RTN","PSODRG",119,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",120,0)
 W !,"Now doing allergy checks.  Please wait...",! H 1
"RTN","PSODRG",121,0)
 S PSONOAL="" D ALLERGY^PSOORUT2 D:PSONOAL'="" NOALRGY K PSONOAL
"RTN","PSODRG",122,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",123,0)
 I '$G(PSODGCKX) D ^PSODGAL1 K PSORX("INTERVENE")
"RTN","PSODRG",124,0)
 G:PSORX("DFLG")!$G(PSOQUIT) POSTX
"RTN","PSODRG",125,0)
 ;This is the allergy check for profile drugs CK action
"RTN","PSODRG",126,0)
 I $D(PSODGCK),$D(PSOSD) D PRFLP^PSOUTL
"RTN","PSODRG",127,0)
 G:$G(PSORX("DFLG")) POSTX ;pso*7*412
"RTN","PSODRG",128,0)
 G:$G(PSOSPRNW)&($G(PSORENW("DFLG"))) POSTX ;speed renew
"RTN","PSODRG",129,0)
 ;aminoglycoside
"RTN","PSODRG",130,0)
 N AOC,CROCPFLG S CROCPFLG=0
"RTN","PSODRG",131,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",132,0)
 S AOC=$$AOC^OROCAPI(PSODFN,$P(PSODRUG("NDF"),"A",2)) I $P(AOC,"^",4)]"" D
"RTN","PSODRG",133,0)
 .S CROCPFLG=1
"RTN","PSODRG",134,0)
 .W !!,"***Aminoglycoside Ordered***",!!
"RTN","PSODRG",135,0)
 .K ^UTILITY($J,"W") S DIWL=1,DIWR=78,DIWF="" S X=$P(AOC,"^",4) D ^DIWP
"RTN","PSODRG",136,0)
 .W ! F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W ?2,^UTILITY($J,"W",1,ZX,0),! D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",137,0)
 .K ^UTILITY($J,"W")
"RTN","PSODRG",138,0)
 .S ^TMP("PSODAOC",$J,"CPRS",$P(AOC,"^",2),0)=PSODRUG("IEN")_"^"_$P(AOC,"^",4)
"RTN","PSODRG",139,0)
 .W !
"RTN","PSODRG",140,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",141,0)
 ;dangerous meds for pat >64
"RTN","PSODRG",142,0)
 I $G(PSODRUG("OI")) D
"RTN","PSODRG",143,0)
 .N OI,OIR S OI=$$OITM^ORX8(PSODRUG("OI"),"99PSP") Q:'OI
"RTN","PSODRG",144,0)
 .S OIR=$$DOC^OROCAPI(PSODFN,OI) I $P(OIR,"^",4)]"" D
"RTN","PSODRG",145,0)
 ..S CROCPFLG=1
"RTN","PSODRG",146,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) W !!,"***Dangerous Meds for Patient >64***",!! S DFN=PSODFN D DEM^VADPT
"RTN","PSODRG",147,0)
 ..K ^UTILITY($J,"W") S DIWL=1,DIWR=78,DIWF="" S X=$P(OIR,"^",4) D ^DIWP
"RTN","PSODRG",148,0)
 ..F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W ?2,^UTILITY($J,"W",1,ZX,0),! D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",149,0)
 ..K ^UTILITY($J,"W")
"RTN","PSODRG",150,0)
 ..S ^TMP("PSODAOC",$J,"CPRS",$P(OIR,"^",2),0)=PSODRUG("IEN")_"^"_$P(OIR,"^",4)
"RTN","PSODRG",151,0)
 ..W !
"RTN","PSODRG",152,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",153,0)
 ;metformin lab results
"RTN","PSODRG",154,0)
 N GOC S GOC=$$GOC^OROCAPI(PSODFN,PSODRUG("NAME")) I $P(GOC,"^",4)]"" D
"RTN","PSODRG",155,0)
 .S CROCPFLG=1
"RTN","PSODRG",156,0)
 .W !!,"***Metformin Lab Results***",!!
"RTN","PSODRG",157,0)
 .K ^UTILITY($J,"W") S DIWL=1,DIWR=78,DIWF="" S X=$P(GOC,"^",4) D ^DIWP
"RTN","PSODRG",158,0)
 .F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W ?2,^UTILITY($J,"W",1,ZX,0),! D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",159,0)
 .K ^UTILITY($J,"W")
"RTN","PSODRG",160,0)
 .S ^TMP("PSODAOC",$J,"CPRS",$P(GOC,"^",2),0)=PSODRUG("IEN")_"^"_$P(GOC,"^",4)
"RTN","PSODRG",161,0)
 .W !
"RTN","PSODRG",162,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",163,0)
 ;clinical reminder oc
"RTN","PSODRG",164,0)
 D:'$G(PSONCROC) CK^PSOCROC K CROCPFLG I $G(PSORX("DFLG")) Q
"RTN","PSODRG",165,0)
 K DIWF,DIWL,DIWR,ZX,DFN,CROCPFLG
"RTN","PSODRG",166,0)
 I $G(PSODRUG("DEA"))["S"!($E($G(PSODRUG("VA CLASS")),1,2)="XA"),'$G(PSODGCK) D  G POSTX ;stops if drug is supply
"RTN","PSODRG",167,0)
 .W !,"Now Processing Enhanced Order Checks!  Please wait...",! H 1
"RTN","PSODRG",168,0)
 ;enhanced OC
"RTN","PSODRG",169,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",170,0)
 W ! D @$S($G(COPY):"OBX^PSOCPPRE",1:"OBX^PSODDPRE") ; Set PSORX("DFLG")=1 if process to stop new enhanced order checks
"RTN","PSODRG",171,0)
POSTX ;
"RTN","PSODRG",172,0)
 K IT,^TMP($J,"DI"),PSORX("INTERVENE"),DA,^TMP($J,"PSODRDI"),ZDGDG,ZTHER,^TMP($J,"DI"_PSODFN),PSZZQUIT
"RTN","PSODRG",173,0)
 I '$G(PSORXED),'$G(PSOREINS) K PSOQUIT
"RTN","PSODRG",174,0)
 Q
"RTN","PSODRG",175,0)
 ;
"RTN","PSODRG",176,0)
EOJ ;
"RTN","PSODRG",177,0)
 K PSODRG
"RTN","PSODRG",178,0)
 Q
"RTN","PSODRG",179,0)
WAIT ;
"RTN","PSODRG",180,0)
 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue..." W !
"RTN","PSODRG",181,0)
 D ^DIR K DIRUT,DUOUT,DIR,X,Y
"RTN","PSODRG",182,0)
 Q
"RTN","PSODRG",183,0)
 ;
"RTN","PSODRG",184,0)
CLOZ ;
"RTN","PSODRG",185,0)
 S ANQRTN=$P(^PSDRUG(PSODRUG("IEN"),"CLOZ1"),"^"),ANQX=0
"RTN","PSODRG",186,0)
 S P(5)=PSODRUG("IEN"),DFN=PSODFN,X=ANQRTN
"RTN","PSODRG",187,0)
 X ^%ZOSF("TEST") I  D @("^"_ANQRTN) S:$G(ANQX) PSORX("DFLG")=1
"RTN","PSODRG",188,0)
 K P(5),ANQRTN,ANQX,X,DFN
"RTN","PSODRG",189,0)
 Q
"RTN","PSODRG",190,0)
 ;
"RTN","PSODRG",191,0)
EN(DRG) ;returns lab test identified for clozapine order checking
"RTN","PSODRG",192,0)
 K LAB I $P($G(^PSDRUG(DRG,"CLOZ1")),"^")'="PSOCLO1" S LAB("NOT")=0 Q
"RTN","PSODRG",193,0)
 I $P($G(^PSDRUG(DRG,"CLOZ1")),"^")="PSOCLO1" D
"RTN","PSODRG",194,0)
 .S (CNT,I)=0 F  S I=$O(^PSDRUG(DRG,"CLOZ2",I)) Q:'I  S CNT=$G(CNT)+1
"RTN","PSODRG",195,0)
 .I CNT'=2 S LAB("BAD TEST")=0 K CNT Q
"RTN","PSODRG",196,0)
 .K CNT F I=0:0 S I=$O(^PSDRUG(DRG,"CLOZ2",I)) Q:'I  D
"RTN","PSODRG",197,0)
 ..S LABT=$S($P(^PSDRUG(DRG,"CLOZ2",I,0),"^",4)=1:"WBC",1:"ANC"),LAB(LABT)=$P(^PSDRUG(DRG,"CLOZ2",I,0),"^")_"^"_$P(^(0),"^",3)_"^"_$P(^(0),"^",4)
"RTN","PSODRG",198,0)
 K LABT,I
"RTN","PSODRG",199,0)
 Q
"RTN","PSODRG",200,0)
NOALRGY ;
"RTN","PSODRG",201,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",202,0)
 N DIR S DIR(0)="SA^1:YES;0:NO"
"RTN","PSODRG",203,0)
 I $D(^TMP($J,"PSOINTERVENE",+PSODFN)) D  Q
"RTN","PSODRG",204,0)
 .S DIR("A")="No Allergy Assessment - Do you want to duplicate Intervention?: ",DIR("B")="Yes"
"RTN","PSODRG",205,0)
 .D ^DIR
"RTN","PSODRG",206,0)
 .I 'Y D  Q
"RTN","PSODRG",207,0)
 ..I Y=0 D ^PSORXI Q
"RTN","PSODRG",208,0)
 ..S PSORX("DFLG")=1
"RTN","PSODRG",209,0)
 .D DUPINV^PSORXI
"RTN","PSODRG",210,0)
 W $C(7),!,"There is no allergy assessment on file for this patient."
"RTN","PSODRG",211,0)
 W !,"You will be prompted to intervene if you continue with this prescription"
"RTN","PSODRG",212,0)
 I $D(PSODGCK) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." D ^DIR K DIR
"RTN","PSODRG",213,0)
 Q:$D(PSODGCK)
"RTN","PSODRG",214,0)
 N DUOUT,DTOUT,RXIEN,RXSTA               ;*398
"RTN","PSODRG",215,0)
 S DIR("A")="Do you want to Continue?: ",DIR("B")="N" D ^DIR
"RTN","PSODRG",216,0)
 I 'Y!($D(DUOUT))!($D(DTOUT)) D  Q       ;*398 - Exit/Timeout
"RTN","PSODRG",217,0)
 .I $D(PSONV) S PSZZQUIT=1 Q
"RTN","PSODRG",218,0)
 .S PSORX("DFLG")=1
"RTN","PSODRG",219,0)
 .I '$O(PSCAN(0)) Q                      ;*398 - Array has Rx IEN
"RTN","PSODRG",220,0)
 .I $G(REA)'="R" Q                       ;*398 - Reinstate only
"RTN","PSODRG",221,0)
 .S RXIEN=+$G(PSCAN(RX)) I 'RXIEN Q      ;*398 - Get Rx IEN
"RTN","PSODRG",222,0)
 .S RXSTA=$$GET1^DIQ(52,RXIEN,100,"I")   ;*398 - Get status
"RTN","PSODRG",223,0)
 .I RXSTA=12 Q                           ;*398 - Correct status
"RTN","PSODRG",224,0)
 .S DIE="^PSRX(",DA=RXIEN,DR="100///12"  ;*398 - Discontinued
"RTN","PSODRG",225,0)
 .D ^DIE                                 ;*398 - Update Rx file
"RTN","PSODRG",226,0)
 I $D(PSONV) S PSORX("INTERVENE")=0 D EN1^PSORXI(PSONV) Q
"RTN","PSODRG",227,0)
 D ^PSORXI
"RTN","PSODRG",228,0)
 Q
"RTN","PSON52")
0^14^B98826270^B99620667
"RTN","PSON52",1,0)
PSON52 ;BIR/DSD - files new entries in prescription file ;08/09/93
"RTN","PSON52",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,16,23,27,32,46,71,111,124,117,131,139,157,143,219,148,239,201,268,260,225,303,358,251,387,379,390,391,313,408,473,504**;DEC 1997;Build 15
"RTN","PSON52",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSON52",4,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSON52",5,0)
 ;External reference to ^XUSEC supported by DBIA 10076
"RTN","PSON52",6,0)
 ;External reference SWSTAT^IBBAPI supported by DBIA 4663
"RTN","PSON52",7,0)
 ;External reference SAVNDC^PSSNDCUT supported by DBIA 4707
"RTN","PSON52",8,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSON52",9,0)
EN(PSOX) ;Entry Point
"RTN","PSON52",10,0)
START ;
"RTN","PSON52",11,0)
 D:$D(XRTL) T0^%ZOSV ; Start RT Monitor
"RTN","PSON52",12,0)
 D INIT G:PSON52("QFLG") END D NFILE Q:$G(PSONEW("DFLG"))
"RTN","PSON52",13,0)
 D PS55,DIK
"RTN","PSON52",14,0)
 S:$D(XRT0) XRTN=$T(+0) D:$D(XRT0) T1^%ZOSV ; Stop RT Monitor
"RTN","PSON52",15,0)
 D FINISH
"RTN","PSON52",16,0)
 I $P(^PSRX(PSOX("IRXN"),0),"^",11)="W",$G(^("IB")) S ^PSRX("ACP",$P(^PSRX(PSOX("IRXN"),0),"^",2),$P(^(2),"^",2),0,PSOX("IRXN"))=""
"RTN","PSON52",17,0)
END D EOJ
"RTN","PSON52",18,0)
 Q
"RTN","PSON52",19,0)
INIT ;
"RTN","PSON52",20,0)
 K X,%DT S:$G(PSOID) PSOX("ISSUE DATE")=PSOID
"RTN","PSON52",21,0)
 S PSOX("CS")=0 K PSOX("NOPSDRPH")
"RTN","PSON52",22,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSOX("CS"),"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSOX("CS"),"^",2)=1
"RTN","PSON52",23,0)
 I $P($G(PSOX("CS")),"^"),'$D(^XUSEC("PSDRPH",DUZ)) S PSOX("NOPSDRPH")=1
"RTN","PSON52",24,0)
 S PSON52("QFLG")=0,X1=PSOX("ISSUE DATE"),X2=PSOX("DAYS SUPPLY")*(PSOX("# OF REFILLS")+1)\1
"RTN","PSON52",25,0)
 I $D(CLOZPAT) S X2=$S(X2=14:14,X2=7:7,1:X2) G DT
"RTN","PSON52",26,0)
 S X2=$S(PSOX("DAYS SUPPLY")=X2:X2,+$G(PSOX("CS")):184,+$G(DEA("CS")):184,1:366)
"RTN","PSON52",27,0)
 I X2<30 D
"RTN","PSON52",28,0)
 . N % S %=$P($G(PSORX("PATIENT STATUS")),"^"),X2=30
"RTN","PSON52",29,0)
 . S:%?.N %=$P($G(^PS(53,+%,0)),"^") I %["AUTH ABS" S X2=5
"RTN","PSON52",30,0)
DT D C^%DTC S PSOX("STOP DATE")=$P(X,".") K X
"RTN","PSON52",31,0)
 ;*473 - If Calculated Exp. Date < Fill Date with No refills, reset Exp.
"RTN","PSON52",32,0)
 I '$D(CLOZPAT),'PSOX("# OF REFILLS"),PSOX("FILL DATE")>PSOX("STOP DATE") D
"RTN","PSON52",33,0)
 . N EXP S EXP=$$FMADD^XLFDT(PSOX("FILL DATE"),PSOX("DAYS SUPPLY"))
"RTN","PSON52",34,0)
 . I $$FMDIFF^XLFDT(EXP,PSOX("ISSUE DATE"))>$S(+$G(PSOX("CS")):184,1:366) D
"RTN","PSON52",35,0)
 . . S EXP=$$FMADD^XLFDT(PSOX("ISSUE DATE"),$S(+$G(PSOX("CS")):184,1:366))
"RTN","PSON52",36,0)
 . S PSOX("STOP DATE")=EXP
"RTN","PSON52",37,0)
 ; Titration to Maintenance Rx Conversion - Set Maint. Rx Exp. Date = Original Rx Exp. Date
"RTN","PSON52",38,0)
 I $G(PSOTITRX) D
"RTN","PSON52",39,0)
 . S PSOX("STOP DATE")=$$GET1^DIQ(52,PSOTITRX,26,"I")
"RTN","PSON52",40,0)
 I PSOX("# OF REFILLS")>0 S X1=PSOX("FILL DATE"),X2=$S((PSOX("DAYS SUPPLY")-10\1)<1:1,1:PSOX("DAYS SUPPLY")-10\1) D C^%DTC S PSOX("NEXT POSSIBLE REFILL")=$P(X,".") K X
"RTN","PSON52",41,0)
 S PSOX("TYPE OF RX")=0,PSOX("DISPENSED DATE")=PSOX("FILL DATE") D NOW^%DTC S PSOX("LOGIN DATE")=$S($P($G(OR0),"^",12):$P($G(OR0),"^",12),1:%) K %,X
"RTN","PSON52",42,0)
 S PSOX("STATUS")=$S($G(PSOX("STATUS"))]"":PSOX("STATUS"),$D(PSORX("VERIFY")):1,$D(PSOX("NOPSDRPH")):1,1:0)
"RTN","PSON52",43,0)
 S PSOX("COPIES")=$S($G(PSOX("COPIES"))]"":PSOX("COPIES"),1:1)
"RTN","PSON52",44,0)
 I $G(PSORX("PHARM"))]"" S PSOX("PHARMACIST")=PSORX("PHARM") K PSORX("PHARM")
"RTN","PSON52",45,0)
INITX Q
"RTN","PSON52",46,0)
 ;
"RTN","PSON52",47,0)
NFILE I $G(OR0) D  Q:$G(PSONEW("DFLG"))
"RTN","PSON52",48,0)
 .D NOOR^PSONEW Q:$G(PSONEW("DFLG"))
"RTN","PSON52",49,0)
 .I $G(PSOSIGFL)!($G(PSODRUG("OI"))'=$P(OR0,"^",8)) S PSONEW("CLERK CODE")=DUZ,PSONEW("REMARKS")=$G(PSONEW("REMARKS"))_" CPRS Order #"_$P(OR0,"^")_" Edited."
"RTN","PSON52",50,0)
 S DIC="^PSRX(",DLAYGO=52,DIC(0)="L",X=PSOX("RX #") K DD,DO D FILE^DICN S PSOX("IRXN")=+Y K DLAYGO,X,Y,DIC,DD,DO
"RTN","PSON52",51,0)
 I '$D(^XUSEC("PSORPH",DUZ))!($D(PSOX("NOPSDRPH"))),$$DS^PSSDSAPI&(+$G(^TMP("PSODOSF",$J,0))) S PSON52(PSOX("IRXN"),"STA")=1,PSOX("STATUS")=1
"RTN","PSON52",52,0)
 F PSOX1=0:1 S PSON52=$P($T(DD+PSOX1),";;",2,4) Q:PSON52=""  K PSOY S PSOY=$P(PSON52,";;") I $G(@PSOY)]"" S $P(PSON52(PSOX("IRXN"),$P(PSON52,";;",2)),"^",$P(PSON52,";;",3))=@PSOY
"RTN","PSON52",53,0)
 F I=1:1:PSOX("ENT") S ^PSRX(PSOX("IRXN"),6,I,0)=PSOX("DOSE",I)_"^"_$G(PSOX("DOSE ORDERED",I))_"^"_$G(PSOX("UNITS",I))_"^"_$G(PSOX("NOUN",I))_"^" D
"RTN","PSON52",54,0)
 .S ^PSRX(PSOX("IRXN"),6,I,0)=^PSRX(PSOX("IRXN"),6,I,0)_$G(PSOX("DURATION",I))_"^"_$G(PSOX("CONJUNCTION",I))_"^"_$G(PSOX("ROUTE",I))_"^"_$G(PSOX("SCHEDULE",I))_"^"_$G(PSOX("VERB",I))
"RTN","PSON52",55,0)
 .I $G(PSOX("ODOSE",I))]"" S ^PSRX(PSOX("IRXN"),6,I,1)=PSOX("ODOSE",I)
"RTN","PSON52",56,0)
 S ^PSRX(PSOX("IRXN"),6,0)="^52.0113^"_PSOX("ENT")_"^"_PSOX("ENT")
"RTN","PSON52",57,0)
 K PSOX1,PSOY
"RTN","PSON52",58,0)
 S PSOX1="" F  S PSOX1=$O(PSON52(PSOX("IRXN"),PSOX1)) Q:PSOX1=""  S ^PSRX(PSOX("IRXN"),PSOX1)=$G(PSON52(PSOX("IRXN"),PSOX1))
"RTN","PSON52",59,0)
 I $O(PSOX("SIG",0)) D
"RTN","PSON52",60,0)
 .S D=0 F  S D=$O(PSOX("SIG",D)) Q:'D  S ^PSRX(PSOX("IRXN"),"INS1",D,0)=PSOX("SIG",D),TP=$G(TP)+1
"RTN","PSON52",61,0)
 .S ^PSRX(PSOX("IRXN"),"INS1",0)="^52.0115^"_TP_"^"_TP_"^"_DT_"^^" K TP,D
"RTN","PSON52",62,0)
 I $G(PSOX("SINS"))]"" S ^PSRX(PSOX("IRXN"),"INSS")=PSOX("SINS")
"RTN","PSON52",63,0)
 I $G(SIGOK) D
"RTN","PSON52",64,0)
 .S $P(^PSRX(PSOX("IRXN"),"SIG"),"^",2)=1,^PSRX(PSOX("IRXN"),"SIG1",0)="^52.04A^^"
"RTN","PSON52",65,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSOX("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSOX("IRXN"),"SIG1",0),"^",3)=+$P(^PSRX(PSOX("IRXN"),"SIG1",0),"^",3)+1,$P(^(0),"^",4)=+$P(^(0),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSON52",66,0)
 .K SIG
"RTN","PSON52",67,0)
 I $D(PSOINSFL) S ^PSRX(PSOX("IRXN"),"A",0)="^52.3DA^1^1",^PSRX(PSOX("IRXN"),"A",1,0)=DT_"^G^^0^Patient Instructions "_$S(PSOINSFL=1:"",1:"Not ")_"Sent By Provider."
"RTN","PSON52",68,0)
 I $G(OR0),$P(OR0,"^",24) S ^PSRX(PSOX("IRXN"),"PKI")=$S($G(PSOSIGFL):"^1",1:1) D ACLOG
"RTN","PSON52",69,0)
 I $P($G(PSOX("CS")),"^"),'+$P($G(^PSRX(PSOX("IRXN"),"PKI")),"^") S $P(^PSRX(PSOX("IRXN"),"PKI"),"^",2)=1
"RTN","PSON52",70,0)
 K PSOX1,PSOFINFL,HLDSIG,D,PSOINSFL,D
"RTN","PSON52",71,0)
 D:$G(^TMP("PSODAI",$J,0))
"RTN","PSON52",72,0)
 .S $P(^PSRX(PSOX("IRXN"),3),"^",6)=1
"RTN","PSON52",73,0)
 .I $O(^TMP("PSODAI",$J,0)) S DAI=0 F  S DAI=$O(^TMP("PSODAI",$J,DAI)) Q:'DAI  D
"RTN","PSON52",74,0)
 ..S:'$D(^PSRX(PSOX("IRXN"),"DAI",0)) ^PSRX(PSOX("IRXN"),"DAI",0)="^52.03^^" S ^PSRX(PSOX("IRXN"),"DAI",DAI,0)=^TMP("PSODAI",$J,DAI,0)
"RTN","PSON52",75,0)
 ..S $P(^PSRX(PSOX("IRXN"),"DAI",0),"^",3)=+$P(^PSRX(PSOX("IRXN"),"DAI",0),"^",3)+1,$P(^(0),"^",4)=+$P(^(0),"^",4)+1
"RTN","PSON52",76,0)
 .K ^TMP("PSODAI",$J),DAI
"RTN","PSON52",77,0)
 I $G(PSOX("CHCS NUMBER"))'="" S $P(^PSRX(PSOX("IRXN"),"EXT"),"^")=$G(PSOX("CHCS NUMBER"))
"RTN","PSON52",78,0)
 I $G(PSOX("EXTERNAL SYSTEM"))'="" S $P(^PSRX(PSOX("IRXN"),"EXT"),"^",2)=$G(PSOX("EXTERNAL SYSTEM"))
"RTN","PSON52",79,0)
 I $G(PSOX("NEWCOPAY")) S ^PSRX(PSOX("IRXN"),"IB")=$G(PSOX("NEWCOPAY"))
"RTN","PSON52",80,0)
 ;Next line, set SC question based on Copay status?
"RTN","PSON52",81,0)
IBQ ;I $G(PSOBILL)=2 S ^PSRX(PSOX("IRXN"),"IBQ")=$S($G(PSOX("NEWCOPAY")):0,1:1)
"RTN","PSON52",82,0)
 N PSOSCFLD S PSOSCFLD=$S(PSOSCP'="":$G(PSOANSQ("SC")),1:"")_"^"_$G(PSOANSQ("MST"))_"^"_$G(PSOANSQ("VEH"))_"^"_$G(PSOANSQ("RAD"))_"^"_$G(PSOANSQ("PGW"))_"^"_$G(PSOANSQ("HNC"))_"^"_$G(PSOANSQ("CV"))_"^"_$G(PSOANSQ("SHAD"))
"RTN","PSON52",83,0)
 I PSOSCP<50&($TR(PSOSCFLD,"^")'="")&($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)'=1) D
"RTN","PSON52",84,0)
 . S ^PSRX(PSOX("IRXN"),"IBQ")=PSOSCFLD K PSOSCFLD  ;don't set if SC % is null or 0, just set it in ICD node
"RTN","PSON52",85,0)
 D ICD^PSODIAG
"RTN","PSON52",86,0)
 D:$$SWSTAT^IBBAPI() GACT^PSOPFSU0(PSOX("IRXN"),0)
"RTN","PSON52",87,0)
 D:$G(PSOTITRX) SAVETIT(PSOTITRX,PSOX("IRXN"))
"RTN","PSON52",88,0)
 K PSOTITRX,PSOANSQ,PSOANSQD,PSOX("NEWCOPAY")
"RTN","PSON52",89,0)
 L -^PSRX("B",PSOX("IRXN"))
"RTN","PSON52",90,0)
 Q
"RTN","PSON52",91,0)
 ;
"RTN","PSON52",92,0)
ACLOG ;activity log (digitally signed CS orders)
"RTN","PSON52",93,0)
 N DTTM,CNT,OCNT,XX
"RTN","PSON52",94,0)
 D NOW^%DTC S DTTM=%
"RTN","PSON52",95,0)
 S CNT=0 F XX=0:0 S XX=$O(^PSRX(PSOX("IRXN"),"A",XX)) Q:'XX  S CNT=XX
"RTN","PSON52",96,0)
 S OCNT=CNT
"RTN","PSON52",97,0)
 I $G(PSOCSP("NAME"))'=PSODRUG("NAME") S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^NAME: "_PSOCSP("NAME")
"RTN","PSON52",98,0)
 S XX=0 F  S XX=$O(PSOCSP("DOSE",XX)) Q:'XX  I PSOCSP("DOSE",XX)'=$G(PSONEW("DOSE",XX)) D
"RTN","PSON52",99,0)
 .S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^DOSAGE: "_PSOCSP("DOSE",XX)
"RTN","PSON52",100,0)
 S XX=0 F  S XX=$O(PSOCSP("DOSE ORDERED",XX)) Q:'XX  I PSOCSP("DOSE ORDERED",XX)'=$G(PSONEW("DOSE ORDERED",XX)) D
"RTN","PSON52",101,0)
 .S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^DISPENSE UNITS: "_PSOCSP("DOSE ORDERED",XX)
"RTN","PSON52",102,0)
 I PSOCSP("ISSUE DATE")'=PSONEW("ISSUE DATE") S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^ISSUE DATE: "_$$FMTE^XLFDT(PSOCSP("ISSUE DATE"))
"RTN","PSON52",103,0)
 I PSOCSP("DAYS SUPPLY")'=PSONEW("DAYS SUPPLY") S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^DAYS SUPPLY: "_PSOCSP("DAYS SUPPLY")
"RTN","PSON52",104,0)
 I PSOCSP("QTY")'=PSONEW("QTY") S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^QTY: "_PSOCSP("QTY")
"RTN","PSON52",105,0)
 I PSOCSP("# OF REFILLS")'=PSONEW("# OF REFILLS") S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^# OF REFILLS: "_PSOCSP("# OF REFILLS")
"RTN","PSON52",106,0)
 I '$$SUBSCRIB^ORDEA($P(OR0,"^"),PSOX("IRXN")) S CNT=CNT+1,^PSRX(PSOX("IRXN"),"A",CNT,0)=DTTM_"^K^"_DUZ_"^0^ORDER DEA ARCHIVE INFO file entry failure"
"RTN","PSON52",107,0)
 I OCNT'=CNT S ^PSRX(PSOX("IRXN"),"A",0)="^52.3DA^"_CNT_"^"_CNT
"RTN","PSON52",108,0)
 Q
"RTN","PSON52",109,0)
 ;
"RTN","PSON52",110,0)
PS55 ;
"RTN","PSON52",111,0)
 L +^PS(55,PSODFN,"P"):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSON52",112,0)
 S:'$D(^PS(55,PSODFN,"P",0)) ^(0)="^55.03PA^^"
"RTN","PSON52",113,0)
 F PSOX1=$P(^PS(55,PSODFN,"P",0),"^",3):1 Q:'$D(^PS(55,PSODFN,"P",PSOX1))
"RTN","PSON52",114,0)
 S PSOX("55 IEN")=PSOX1
"RTN","PSON52",115,0)
 S ^PS(55,PSODFN,"P",PSOX1,0)=PSOX("IRXN"),$P(^PS(55,PSODFN,"P",0),"^",3,4)=PSOX1_"^"_($P(^PS(55,PSODFN,"P",0),"^",4)+1)
"RTN","PSON52",116,0)
 S ^PS(55,PSODFN,"P","A",PSONEW("STOP DATE"),PSOX("IRXN"))=""
"RTN","PSON52",117,0)
PS55X L -^PS(55,PSODFN,"P")
"RTN","PSON52",118,0)
 K PSOX1
"RTN","PSON52",119,0)
 Q
"RTN","PSON52",120,0)
DIK ;
"RTN","PSON52",121,0)
 I $D(^XUSEC("PSORPH",DUZ)) S DA=PSOX("IRXN"),DIE=52,DR="41////"_PSOCOU_";S:'X Y=""@1"";42////"_PSOCOUU_";@1" D ^DIE K DIE,DR
"RTN","PSON52",122,0)
 K DIK,DA S DIK="^PSRX(",DA=PSOX("IRXN") D IX1^DIK K DIK
"RTN","PSON52",123,0)
 S DA=PSOX("IRXN") D ORC^PSORN52C
"RTN","PSON52",124,0)
 Q
"RTN","PSON52",125,0)
FINISH ;
"RTN","PSON52",126,0)
ANQ I $G(ANQDATA)]"" D NOW^%DTC G:$D(^PS(52.52,"B",%)) ANQ D
"RTN","PSON52",127,0)
 .K DD,DO S DIC="^PS(52.52,",DIC(0)="L",DLAYGO=52.52,X=% D FILE^DICN K DIC,DLAYGO,DD,DO
"RTN","PSON52",128,0)
 .S ^PS(52.52,+Y,0)=$P(Y,"^",2)_"^"_PSOX("IRXN")_"^"_ANQDATA,^PS(52.52,"A",PSOX("IRXN"),+Y)="" K ANQDATA,X,Y,%,ANQREM
"RTN","PSON52",129,0)
 ;
"RTN","PSON52",130,0)
 N PSOTFIN
"RTN","PSON52",131,0)
 I $D(PSOX("NOPSDRPH"))!('$D(^XUSEC("PSORPH",DUZ))) S PSOTFIN="",PSOTFIN=$$TECH2^PSODGDGP(PSOX("IRXN"),PSODFN,DUZ,.PSOX)
"RTN","PSON52",132,0)
 I $D(PSOX("NOPSDRPH"))!('$D(^XUSEC("PSORPH",DUZ))) G FINISHP:$G(PSOTFIN)=1 G FINISHX:$G(PSOTFIN)=2
"RTN","PSON52",133,0)
 ;
"RTN","PSON52",134,0)
 I PSOX("FILL DATE")>DT,$P(PSOPAR,"^",6) S DA=PSOX("IRXN"),RXFL(PSOX("IRXN"))=0 D SUS^PSORXL K DA G FINISHX
"RTN","PSON52",135,0)
 ;
"RTN","PSON52",136,0)
 ; - Calling ECME for claims generation and transmission / REJECT handling
"RTN","PSON52",137,0)
 N ACTION,PSOERX
"RTN","PSON52",138,0)
 S PSOERX=PSOX("IRXN")
"RTN","PSON52",139,0)
 I $$SUBMIT^PSOBPSUT(PSOERX,0) D  I ACTION="Q"!(ACTION="^") Q
"RTN","PSON52",140,0)
 . S ACTION="" D ECMESND^PSOBPSU1(PSOERX,0,"","OF")
"RTN","PSON52",141,0)
 . ; Quit if there is an unresolved Tricare/CHAMPVA non-billable reject code, PSO*7*358
"RTN","PSON52",142,0)
 . I $$PSOET^PSOREJP3(PSOERX,0) S ACTION="Q" Q
"RTN","PSON52",143,0)
 . I $$FIND^PSOREJUT(PSOERX,0) D
"RTN","PSON52",144,0)
 . . S ACTION=$$HDLG^PSOREJU1(PSOERX,0,"79,88","OF","IOQ","Q")
"RTN","PSON52",145,0)
 . I $$STATUS^PSOBPSUT(PSOERX,0)="E PAYABLE" D
"RTN","PSON52",146,0)
 . . D SAVNDC^PSSNDCUT(+$$GET1^DIQ(52,PSOERX,6,"I"),$G(PSOSITE),$$GETNDC^PSONDCUT(PSOERX,0))
"RTN","PSON52",147,0)
 ;
"RTN","PSON52",148,0)
FINISHP ;
"RTN","PSON52",149,0)
 I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=PSOX("IRXN")_",",RXFL(PSOX("IRXN"))=0 G FINISHX
"RTN","PSON52",150,0)
 F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSON52",151,0)
 I $L(PSORX("PSOL",PSOX2))+$L(PSOX("IRXN"))<220 S PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_PSOX("IRXN")_","
"RTN","PSON52",152,0)
 E  S PSORX("PSOL",PSOX2+1)=PSOX("IRXN")_","
"RTN","PSON52",153,0)
 S RXFL(PSOX("IRXN"))=0
"RTN","PSON52",154,0)
FINISHX ;call to build Rx array for bingo board
"RTN","PSON52",155,0)
 I $G(PSORX("MAIL/WINDOW"))["W" S BINGCRT=1,BINGRTE="W",BBFLG=1 D BBRX^PSORN52C
"RTN","PSON52",156,0)
 K PSOX1,PSOX2
"RTN","PSON52",157,0)
 K ^TMP("PSODGI",$J),^TMP("PSOSER",$J),^TMP("PSOSERS",$J),^TMP("PSODGS",$J),^TMP("PSOTDD",$J),^TMP("PSODOSF",$J)
"RTN","PSON52",158,0)
 Q
"RTN","PSON52",159,0)
 ;
"RTN","PSON52",160,0)
SAVETIT(TITRX,MNTRX) ; Save Titration/Maintenance dose Rx information
"RTN","PSON52",161,0)
 I '$D(^PSRX(+$G(TITRX),0))!'$D(^PSRX(+$G(MNTRX),0)) Q
"RTN","PSON52",162,0)
 S $P(^PSRX(TITRX,"TIT"),"^",2,3)=MNTRX_"^1"
"RTN","PSON52",163,0)
 D RXACT^PSOBPSU2(TITRX,0,"Maintenance Rx#: "_$$GET1^DIQ(52,MNTRX,.01),"E")
"RTN","PSON52",164,0)
 S $P(^PSRX(MNTRX,"TIT"),"^",1)=TITRX
"RTN","PSON52",165,0)
 D RXACT^PSOBPSU2(MNTRX,0,"Titration Rx#: "_$$GET1^DIQ(52,TITRX,.01),"E")
"RTN","PSON52",166,0)
 Q
"RTN","PSON52",167,0)
 ;
"RTN","PSON52",168,0)
EOJ ;
"RTN","PSON52",169,0)
 ;B xref locked in routine PSONRXN
"RTN","PSON52",170,0)
 L -^PSRX("B",PSOX("IRXN")) K OTHDOS,DA,PSON52,PSOPRC,RTE,SCH,PSOX("INS"),PSONEW("INS"),PSORXED("INS"),PSONEW("ENT"),PSORXED("ENT"),OLENT
"RTN","PSON52",171,0)
 D PSOUL^PSSLOCK(PSOX("IRXN"))
"RTN","PSON52",172,0)
 Q
"RTN","PSON52",173,0)
 ;
"RTN","PSON52",174,0)
 ;;PSOX("SIG");;SIG;;1
"RTN","PSON52",175,0)
DD ;;PSOX("RX #");;0;;1
"RTN","PSON52",176,0)
 ;;PSOX("ISSUE DATE");;0;;13
"RTN","PSON52",177,0)
 ;;PSODFN;;0;;2
"RTN","PSON52",178,0)
 ;;PSOX("PATIENT STATUS");;0;;3
"RTN","PSON52",179,0)
 ;;PSOX("PROVIDER");;0;;4
"RTN","PSON52",180,0)
 ;;PSOX("CLINIC");;0;;5
"RTN","PSON52",181,0)
 ;;PSODRUG("IEN");;0;;6
"RTN","PSON52",182,0)
 ;;PSODRUG("TRADE NAME");;TN;;1
"RTN","PSON52",183,0)
 ;;PSOX("QTY");;0;;7
"RTN","PSON52",184,0)
 ;;PSOX("DAYS SUPPLY");;0;;8
"RTN","PSON52",185,0)
 ;;PSOX("# OF REFILLS");;0;;9
"RTN","PSON52",186,0)
 ;;PSOX("COPIES");;0;;18
"RTN","PSON52",187,0)
 ;;PSOX("MAIL/WINDOW");;0;;11
"RTN","PSON52",188,0)
 ;;PSOX("REMARKS");;3;;7
"RTN","PSON52",189,0)
 ;;PSOX("ADMINCLINIC");;0;;15 
"RTN","PSON52",190,0)
 ;;PSOX("CLERK CODE");;0;;16
"RTN","PSON52",191,0)
 ;;PSODRUG("COST");;0;;17
"RTN","PSON52",192,0)
 ;;PSOSITE;;2;;9
"RTN","PSON52",193,0)
 ;;PSOX("LOGIN DATE");;2;;1
"RTN","PSON52",194,0)
 ;;PSOX("FILL DATE");;2;;2
"RTN","PSON52",195,0)
 ;;PSOX("PHARMACIST");;2;;3
"RTN","PSON52",196,0)
 ;;PSOX("LOT #");;2;;4
"RTN","PSON52",197,0)
 ;;PSOX("DISPENSED DATE");;2;;5
"RTN","PSON52",198,0)
 ;;PSOX("STOP DATE");;2;;6
"RTN","PSON52",199,0)
 ;;PSODRUG("NDC");;2;;7
"RTN","PSON52",200,0)
 ;;PSODRUG("DAW");;EPH;;1
"RTN","PSON52",201,0)
 ;;PSODRUG("MANUFACTURER");;2;;8
"RTN","PSON52",202,0)
 ;;PSOX("EXPIRATION DATE");;2;;11
"RTN","PSON52",203,0)
 ;;PSOX("GENERIC PROVIDER");;2;;12
"RTN","PSON52",204,0)
 ;;PSOX("RELEASED DATE/TIME");;2;;13
"RTN","PSON52",205,0)
 ;;PSOX("METHOD OF PICK-UP");;MP;;1
"RTN","PSON52",206,0)
 ;;PSOX("STATUS");;STA;;1
"RTN","PSON52",207,0)
 ;;PSOX("LAST DISPENSED DATE");;3;;1
"RTN","PSON52",208,0)
 ;;PSOX("NEXT POSSIBLE REFILL");;3;;2
"RTN","PSON52",209,0)
 ;;PSOX("COSIGNING PROVIDER");;3;;3
"RTN","PSON52",210,0)
 ;;PSOX("TYPE OF RX");;TYPE;;1
"RTN","PSON52",211,0)
 ;;PSOX("SAND");;SAND;;1
"RTN","PSON52",212,0)
 ;;PSOX("POE");;POE;;1
"RTN","PSON52",213,0)
 ;;PSOX("INS");;INS;;1
"RTN","PSONEW2")
0^15^B42942926^B43830604
"RTN","PSONEW2",1,0)
PSONEW2 ;BIR/DSD - displays new rx information for edit ;7/17/06 6:59pm
"RTN","PSONEW2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**32,37,46,71,94,124,139,157,143,226,237,239,225,251,375,372,504**;DEC 1997;Build 15
"RTN","PSONEW2",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSONEW2",4,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSONEW2",5,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSONEW2",6,0)
 ;External reference VADPT supported by DBIA 10061
"RTN","PSONEW2",7,0)
 ; This routine displays the entered new rx information and
"RTN","PSONEW2",8,0)
 ; asks if correct, if not allows editing of the data.
"RTN","PSONEW2",9,0)
 ;------------------------------------------------------------
"RTN","PSONEW2",10,0)
 ;PSO*237 issue expired error message
"RTN","PSONEW2",11,0)
 ;
"RTN","PSONEW2",12,0)
START ;
"RTN","PSONEW2",13,0)
 S (PSONEW("DFLG"),PSONEW2("QFLG"))=0
"RTN","PSONEW2",14,0)
 D STOP
"RTN","PSONEW2",15,0)
 D DISPLAY ; Displays information
"RTN","PSONEW2",16,0)
 ;Copay exemption checks
"RTN","PSONEW2",17,0)
 D SCP^PSORN52D
"RTN","PSONEW2",18,0)
 S PSONEWFF=1,PSOFLAG=1 K PSOANSQ,PSOANSQD S PSOCPZ("DFLG")=0,PSONEW("NEWCOPAY")=0
"RTN","PSONEW2",19,0)
 ;can't check PSOSCA for <50 here because of PSOBILL check in PSOCPB
"RTN","PSONEW2",20,0)
 I (PSOSCP<50&($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)'=1)),$G(DUZ("AG"))="V" D COPAY^PSOCPB W !
"RTN","PSONEW2",21,0)
 I PSOSCA&(PSOSCP>49)!((PSOSCA!(PSOBILL=2))&($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)=1))!(PSOSCP>49&(PSOBILL=2)) D SC^PSOMLLD2
"RTN","PSONEW2",22,0)
 I $G(PSOCPZ("DFLG")) K PSONEWFF,PSOANSQD,PSOCPZ("DFLG"),PSONEW("NEWCOPAY") S DIRUT="",PSONEW("DFLG")=1 D ASKX G END
"RTN","PSONEW2",23,0)
 ;IF MILL BILL, AND COPAY (*******TEST THE COPAY CHECK)
"RTN","PSONEW2",24,0)
 I $$DT^PSOMLLDT D  I $G(PSOCPZ("DFLG")) K PSONEWFF,PSOANSQD,PSOANSQ,PSOCPZ("DFLG"),PSONEW("NEWCOPAY") S DIRUT="",PSONEW("DFLG")=1 D ASKX G END
"RTN","PSONEW2",25,0)
 .;New prompts Quit after first '^'
"RTN","PSONEW2",26,0)
 .I $D(PSOIBQS(PSODFN,"CV")) D CV^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("CV"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",27,0)
 .I $D(PSOIBQS(PSODFN,"VEH")) D VEH^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("VEH"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",28,0)
 .I $D(PSOIBQS(PSODFN,"RAD")) D RAD^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("RAD"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",29,0)
 .I $D(PSOIBQS(PSODFN,"PGW")) D PGW^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("PGW"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",30,0)
 .I $D(PSOIBQS(PSODFN,"SHAD")) D SHAD^PSOMLLD2 I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("SHAD"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",31,0)
 .I $D(PSOIBQS(PSODFN,"MST")) D MST^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("MST"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",32,0)
 .I $D(PSOIBQS(PSODFN,"HNC")) D HNC^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("HNC"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",33,0)
 K PSOCPZ("DFLG"),PSONEWFF
"RTN","PSONEW2",34,0)
 D ASK K:$G(PSONEW("DFLG")) PSOANSQ G:PSONEW2("QFLG")!PSONEW("DFLG") END
"RTN","PSONEW2",35,0)
 S PSORX("EDIT")=1 D EN^PSOORNE1(.PSONEW),FULL^VALM1 G:$G(PSORX("FN")) END  I '$G(PSORX("FN")) S PSONEW("DFLG")=1 K PSOANSQ G END ;D EDIT
"RTN","PSONEW2",36,0)
 G:'$G(PSONEW("DFLG")) START
"RTN","PSONEW2",37,0)
 S PSONEW("QFLG")=1,PSONEW("DFLG")=0
"RTN","PSONEW2",38,0)
END D EOJ
"RTN","PSONEW2",39,0)
 Q
"RTN","PSONEW2",40,0)
 ;------------------------------------------------------------
"RTN","PSONEW2",41,0)
STOP ; Checks whether the Fill Date is past the Expiration Date 
"RTN","PSONEW2",42,0)
 N ISSDT,X K PSEXDT S PSON52("QFLG")=0
"RTN","PSONEW2",43,0)
 S ISSDT=$G(PSONEW("ISSUE DATE")) I 'ISSDT S X=ISSDT D ^%DT S:Y>0 ISSDT=Y I 'ISSDT S ISSDT=DT
"RTN","PSONEW2",44,0)
 I $$FMDIFF^XLFDT($G(PSONEW("FILL DATE")),ISSDT)>$S(+$G(PSONEW("CS")):184,1:366) D
"RTN","PSONEW2",45,0)
 . S PSEXDT=1_"^"_$$FMADD^XLFDT(ISSDT,$S(+$G(PSONEW("CS")):184,1:366))
"RTN","PSONEW2",46,0)
 Q
"RTN","PSONEW2",47,0)
DISPLAY ;
"RTN","PSONEW2",48,0)
 D:+$$DS^PSSDSAPI&($G(PSOFOERR)) HD3^PSODOSUN()
"RTN","PSONEW2",49,0)
 W !!,"Rx # ",PSONEW("RX #")
"RTN","PSONEW2",50,0)
 W ?23,$E(PSONEW("FILL DATE"),4,5),"/",$E(PSONEW("FILL DATE"),6,7),"/",$E(PSONEW("FILL DATE"),2,3),!,$G(PSORX("NAME")),?30,"#",PSONEW("QTY")
"RTN","PSONEW2",51,0)
 I $G(SIGOK),$O(SIG(0)) D  K D G TRN
"RTN","PSONEW2",52,0)
 .F D=0:0 S D=$O(SIG(D)) W !,SIG(D) Q:'$O(SIG(D))  D:+$$DS^PSSDSAPI&($G(PSOFOERR)) HD3^PSODOSUN(7)
"RTN","PSONEW2",53,0)
 E  S X=PSONEW("SIG") D SIGONE^PSOHELP W !,$G(INS1) D:+$$DS^PSSDSAPI&($G(PSOFOERR)) HD3^PSODOSUN(7)
"RTN","PSONEW2",54,0)
TRN ;I $G(PSOPRC) F I=0:0 S I=$O(PRC(I)) Q:'I  W !,PRC(I)
"RTN","PSONEW2",55,0)
 W !!,$S($G(PSODRUG("TRADE NAME"))]"":PSODRUG("TRADE NAME"),1:PSODRUG("NAME"))
"RTN","PSONEW2",56,0)
 W !,PSONEW("PROVIDER NAME"),?25,PSORX("CLERK CODE"),!,"# of Refills: ",PSONEW("# OF REFILLS"),! D:+$$DS^PSSDSAPI&($G(PSOFOERR)) HD3^PSODOSUN()
"RTN","PSONEW2",57,0)
 Q
"RTN","PSONEW2",58,0)
 ;
"RTN","PSONEW2",59,0)
ASK ;
"RTN","PSONEW2",60,0)
 K DIR,X,Y S DIR("A")="Is this correct"
"RTN","PSONEW2",61,0)
 S DIR(0)="Y",DIR("B")="YES" D ^DIR K DIR I $D(DIRUT) S PSONEW("DFLG")=1 G ASKX
"RTN","PSONEW2",62,0)
ASK1 I Y D  S PSONEW2("QFLG")=1
"RTN","PSONEW2",63,0)
 .S:$G(PSONEW("MAIL/WINDOW"))["W" BINGCRT=Y,BINGRTE="W"
"RTN","PSONEW2",64,0)
 .D:+$G(PSEXDT)
"RTN","PSONEW2",65,0)
 ..S Y=PSONEW("FILL DATE") X ^DD("DD") W !!,$C(7),Y_" fill date is greater than possible expiration date of " S Y=$P(PSEXDT,"^",2) X ^DD("DD") W Y_"."
"RTN","PSONEW2",66,0)
 .D DCORD K RORD,^TMP("PSORXDC",$J)
"RTN","PSONEW2",67,0)
ASKX I $D(DIRUT) D
"RTN","PSONEW2",68,0)
 .I +$G(PSEXDT) K DIRUT S (PSONEW2("QFLG"),PSONEW2("DFLG"),PSONEW("DFLG"),Y)=1
"RTN","PSONEW2",69,0)
 K X,Y,DIRUT,DTOUT,DUOUT
"RTN","PSONEW2",70,0)
 D:+$G(PSEXDT) PAUSE^VALM1
"RTN","PSONEW2",71,0)
 Q
"RTN","PSONEW2",72,0)
DCORD ;dc rxs and pending orders after new order is entered
"RTN","PSONEW2",73,0)
 I $G(PSORX("DFLG")) K ^TMP("PSORXDC",$J) Q
"RTN","PSONEW2",74,0)
 F RORD=0:0 S RORD=$O(^TMP("PSORXDC",$J,RORD)) Q:'RORD  D @$S($P(^TMP("PSORXDC",$J,RORD,0),"^")="P":"PEN",1:"RX52")
"RTN","PSONEW2",75,0)
 I $G(PSORX("FN")) S VALMBCK="Q",PSOFROM="NEW"
"RTN","PSONEW2",76,0)
 K RORD,PSOTECCK H 2
"RTN","PSONEW2",77,0)
 Q
"RTN","PSONEW2",78,0)
PEN ;pending ^tmp("psorxdc",$j,rord,0)="p^"_rord_"^"_msg
"RTN","PSONEW2",79,0)
 N PSOR,DNM S PSOR=^PS(52.41,RORD,0) S $P(^PS(52.41,RORD,0),"^",3)="DC",^PS(52.41,RORD,4)=$P(^TMP("PSORXDC",$J,RORD,0),"^",3)
"RTN","PSONEW2",80,0)
 K ^PS(52.41,"AOR",PSODFN,+$P($G(^PS(52.41,RORD,"INI")),"^"),RORD)
"RTN","PSONEW2",81,0)
 S DNM=$S($P(PSOR,"^",9):$P($G(^PSDRUG($P(PSOR,"^",9),0)),"^"),1:$P(^PS(50.7,$P(PSOR,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(PSOR,"^",8),0),"^",2),0),"^"))
"RTN","PSONEW2",82,0)
 D EN^PSOHLSN($P(^PS(52.41,RORD,0),"^"),"OC",$P(^TMP("PSORXDC",$J,RORD,0),"^",3),"D")
"RTN","PSONEW2",83,0)
 I $G(PSOTECCK),'$D(^XUSEC("PSORPH",DUZ)) G PENX
"RTN","PSONEW2",84,0)
 W $C(7),! K ^UTILITY($J,"W") S DIWL=1,DIWR=75,DIWF=""
"RTN","PSONEW2",85,0)
 S X=" Duplicate "_$S($P(^TMP("PSORXDC",$J,RORD,0),"^",10):"Therapy",1:"Drug")_" Pending Order "_DNM_" has been discontinued..." D ^DIWP
"RTN","PSONEW2",86,0)
 F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W !,^UTILITY($J,"W",1,ZX,0)
"RTN","PSONEW2",87,0)
PENX K ^UTILITY($J,"W"),X,DIWL,DIWR,DIWF W !
"RTN","PSONEW2",88,0)
 D PSOUL^PSSLOCK(RORD_"S") K ^TMP("PSORXDC",$J,RORD,0)
"RTN","PSONEW2",89,0)
 Q
"RTN","PSONEW2",90,0)
RX52 ;rxs in file 52 ^tmp("psorxdc",$j,rord,0)=52^rord^msg^rea^act^sta^dnm
"RTN","PSONEW2",91,0)
 S PSCAN($P(^PSRX(RORD,0),"^"))=RORD_"^"_$P(^TMP("PSORXDC",$J,RORD,0),"^",4)
"RTN","PSONEW2",92,0)
 S MSG=$P(^TMP("PSORXDC",$J,RORD,0),"^",3),REA=$P(^(0),"^",4),ACT=$P(^(0),"^",5)
"RTN","PSONEW2",93,0)
 N PSONOOR S PSONOOR="D",DUP=1,DA=RORD D CAN^PSOCAN K PSONOOR
"RTN","PSONEW2",94,0)
 I $G(PSOTECCK),'$D(^XUSEC("PSORPH",DUZ)) G RX52X
"RTN","PSONEW2",95,0)
 W $C(7),! K ^UTILITY($J,"W") S DIWL=1,DIWR=75,DIWF=""
"RTN","PSONEW2",96,0)
 S X=" Duplicate "_$S($P(^TMP("PSORXDC",$J,RORD,0),"^",10):"Therapy",1:"Drug")_" Rx #"_$P(^PSRX(RORD,0),"^")_" "_$P(^TMP("PSORXDC",$J,RORD,0),"^",7)_" has been discontinued..." D ^DIWP
"RTN","PSONEW2",97,0)
 F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W !,^UTILITY($J,"W",1,ZX,0)
"RTN","PSONEW2",98,0)
RX52X K ^UTILITY($J,"W"),X,DIWL,DIWR,DIWF W !
"RTN","PSONEW2",99,0)
 K PSOSD($P(^TMP("PSORXDC",$J,RORD,0),"^",6),$P(^TMP("PSORXDC",$J,RORD,0),"^",7))
"RTN","PSONEW2",100,0)
 D PSOUL^PSSLOCK(RORD) K ^TMP("PSORXDC",$J,RORD,0)
"RTN","PSONEW2",101,0)
 Q
"RTN","PSONEW2",102,0)
 ;
"RTN","PSONEW2",103,0)
EDIT ;
"RTN","PSONEW2",104,0)
 S PSORX("EDIT")=1
"RTN","PSONEW2",105,0)
 D ^PSONEW3
"RTN","PSONEW2",106,0)
 S PSONEW("DFLG")=$S($G(PSORX("DFLG")):1,1:0)
"RTN","PSONEW2",107,0)
 Q
"RTN","PSONEW2",108,0)
 ;
"RTN","PSONEW2",109,0)
EOJ ;
"RTN","PSONEW2",110,0)
 K PSONEW2,PSORX("EDIT"),PSORX("DFLG"),PSOEDIT,PSOSCA
"RTN","PSONEW2",111,0)
 Q
"RTN","PSONEW2",112,0)
 ;
"RTN","PSONEW2",113,0)
EN1(PSONEW2) ; Entry point to just display and ask if okay
"RTN","PSONEW2",114,0)
 S PSONEW("DFLG")=0
"RTN","PSONEW2",115,0)
 I $G(^PSRX(PSONEW2("IRXN"),0))']"" S PSONEW("DFLG")=1 G EN1X
"RTN","PSONEW2",116,0)
 S PSOX=^PSRX(PSONEW2("IRXN"),0),PSONEW("TRADE NAME")=$G(^("TN")),PSONEW("FILL DATE")=$P($G(^(2)),"^",2)
"RTN","PSONEW2",117,0)
 S PSONEW("RX #")=$P(PSOX,"^"),PSORX("NAME")=$P(^DPT($P(PSOX,"^",2),0),"^")
"RTN","PSONEW2",118,0)
 S PSONEW("QTY")=$P(PSOX,"^",7),PSODRUG("NAME")=$P(^PSDRUG($P(PSOX,"^",6),0),"^"),PSONEW("# OF REFILLS")=$P(PSOX,"^",9)
"RTN","PSONEW2",119,0)
 S PSORX("CLERK CODE")=$P(^VA(200,$P(PSOX,"^",16),0),"^")
"RTN","PSONEW2",120,0)
 S:$G(PSONEW("PROVIDER NAME"))="" PSONEW("PROVIDER NAME")=$P(^VA(200,$P(PSOX,"^",4),0),"^")
"RTN","PSONEW2",121,0)
 S PSONEW("SIG")=$P($G(^PSRX(PSONEW2("IRXN"),"SIG")),"^")
"RTN","PSONEW2",122,0)
 D DISPLAY
"RTN","PSONEW2",123,0)
 D ASK
"RTN","PSONEW2",124,0)
 I PSONEW("DFLG")=1 S PSONEW2("DFLG")=1
"RTN","PSONEW2",125,0)
EN1X ;
"RTN","PSONEW2",126,0)
 Q
"RTN","PSONEW2",127,0)
 ;
"RTN","PSONEW2",128,0)
EXPR ;Display Expired error message                               ;PSO*237
"RTN","PSONEW2",129,0)
 S PSONEW("DFLG")=1
"RTN","PSONEW2",130,0)
 W $C(7)
"RTN","PSONEW2",131,0)
 S VALMSG="Order is older than 365 days and can't be finished"
"RTN","PSONEW2",132,0)
 S XQORM("B")="DC"
"RTN","PSONEW2",133,0)
 Q
"RTN","PSOORCPY")
0^11^B37014700^B35980463
"RTN","PSOORCPY",1,0)
PSOORCPY ;BIR/SAB-copy orders from backdoor ;10/17/96
"RTN","PSOORCPY",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,21,27,32,46,100,117,148,313,411,444,468,504**;DEC 1997;Build 15
"RTN","PSOORCPY",3,0)
 ;External reference to LK^ORX2 supported by DBIA 867
"RTN","PSOORCPY",4,0)
 ;External reference to ULK^ORX2 supported by DBIA 867
"RTN","PSOORCPY",5,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSOORCPY",6,0)
 ;External reference to L^PSSLOCK supported by DBIA 2789
"RTN","PSOORCPY",7,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSOORCPY",8,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789
"RTN","PSOORCPY",9,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOORCPY",10,0)
 ;
"RTN","PSOORCPY",11,0)
 ; Cleaning up Titration/Maintenance variables (they shouldn't be defined - just to be safe)
"RTN","PSOORCPY",12,0)
 K PSOMTFLG,PSOTITRX,PSOSIGFL
"RTN","PSOORCPY",13,0)
COPY ; Rx Copy Functionality
"RTN","PSOORCPY",14,0)
 N PSORXIEN,PSOCHECK
"RTN","PSOORCPY",15,0)
 S PSORXIEN=+$P($G(PSOLST(ORN)),"^",2)
"RTN","PSOORCPY",16,0)
 ; Checking whether the Provider still qualifies as prescriber for the renewed Rx
"RTN","PSOORCPY",17,0)
 S PSOCHECK=$$CHKRXPRV^PSOUTIL(PSORXIEN)
"RTN","PSOORCPY",18,0)
 I 'PSOCHECK S VALMSG=$P(PSOCHECK,"^",2),VALMBCK="R" W $C(7) Q
"RTN","PSOORCPY",19,0)
 I $$LMREJ^PSOREJU1(PSORXIEN,,.VALMSG,.VALMBCK) Q
"RTN","PSOORCPY",20,0)
 I '$G(PSOMTFLG),$$TITRX^PSOUTL(PSORXIEN)="t" S VALMSG="Cannot Copy a 'Titration Rx'.",VALMBCK="" W $C(7) Q
"RTN","PSOORCPY",21,0)
 I $G(PSOBEDT) W $C(7),$C(7) S VALMSG="Invalid Action at this time !",VALMBCK="" Q
"RTN","PSOORCPY",22,0)
 I $G(PSONACT) W $C(7),$C(7) S VALMSG="No Pharmacy Orderable Item !",VALMBCK="" K PSOCOPY D ^PSOBUILD Q
"RTN","PSOORCPY",23,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSOORCPY",24,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSOORCPY",25,0)
 D PSOL^PSSLOCK(PSORXIEN) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG G EX
"RTN","PSOORCPY",26,0)
 N VALMCNT K PSOEDIT S (PSOCOPY,COPY,PSORXED,ZZCOPY)=1 D FULL^VALM1
"RTN","PSOORCPY",27,0)
 S PSORXED("DFLG")=0,(RXN,DA,PSORXED("IRXN"))=PSORXIEN,PSORXED("RX0")=^PSRX(PSORXED("IRXN"),0),PSORXED("RX2")=$G(^(2)),PSORXED("RX3")=$G(^(3)),PSOI=$P($G(^("OR1")),"^"),PSOSIG=$P($G(^("SIG")),"^"),STAT=+^("STA")
"RTN","PSOORCPY",28,0)
 S PSORXED("INS")=$G(^PSRX(PSORXED("IRXN"),"INS"))
"RTN","PSOORCPY",29,0)
 S:$G(^PSRX(PSORXED("IRXN"),"INSS"))]"" PSORXED("SINS")=^PSRX(PSORXED("IRXN"),"INSS")
"RTN","PSOORCPY",30,0)
 S D=0 F  S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORCPY",31,0)
 I '$O(PSORXED("SIG",0)),$G(PSORXED("INS"))]"" S PSORXED("SIG",1)=PSORXED("INS")
"RTN","PSOORCPY",32,0)
 I $G(^PSRX(PSORXED("IRXN"),"TN"))]"" S PSODRUG("TRADE NAME")=^PSRX(PSORXED("IRXN"),"TN")
"RTN","PSOORCPY",33,0)
 ;
"RTN","PSOORCPY",34,0)
 ; - This call copies the dosage into the new order and also split the Maintenance dose (if the case)
"RTN","PSOORCPY",35,0)
 D BLDDOSE(.PSORXED,$G(PSOMTFLG))
"RTN","PSOORCPY",36,0)
 ;
"RTN","PSOORCPY",37,0)
 I $G(^PSDRUG($P(PSORXED("RX0"),"^",6),"I"))]"",^("I")<DT S VALMSG=$S('$G(PSOMTFLG):"Cannot COPY. ",1:"")_"This drug has been inactivated!" S VALMBCK="R" G OUT
"RTN","PSOORCPY",38,0)
 I $P(^PSDRUG($P(PSORXED("RX0"),"^",6),2),"^",3)'["O" S VALMSG=$S('$G(PSOMTFLG):"Cannot COPY. ",1:"")_"Drug no longer used by Outpatient!",VALMBCK="R" G OUT
"RTN","PSOORCPY",39,0)
 ;Check for invalid Dosage
"RTN","PSOORCPY",40,0)
 N PSOOCPRX,PSOOLPF,PSOOLPD,PSONOSIG S PSOOCPRX=PSORXED("IRXN") D CDOSE^PSORENW0
"RTN","PSOORCPY",41,0)
 I PSOOLPF D  S VALMBCK="R" G OUT
"RTN","PSOORCPY",42,0)
 .S VALMSG=$S('$G(PSOMTFLG):"Cannot COPY. ",1:"")_"Invalid Dosage of "_$G(PSOOLPD)
"RTN","PSOORCPY",43,0)
 I PSONOSIG D  S VALMBCK="R" G OUT
"RTN","PSOORCPY",44,0)
 .S VALMSG=$S('$G(PSOMTFLG):"Cannot COPY. ",1:"")_"Missing Sig"
"RTN","PSOORCPY",45,0)
 I '$P($G(^PSDRUG($P(PSORXED("RX0"),"^",6),2)),"^") S VALMBCK="R" G OUT
"RTN","PSOORCPY",46,0)
 S DREN=$P(PSORXED("RX0"),"^",6),PSODAYS=$P(PSORXED("RX0"),"^",8)
"RTN","PSOORCPY",47,0)
 ; Checks if the current Days Supply value is greater than the Maximum Days Supply for the Drug
"RTN","PSOORCPY",48,0)
 I '$G(PSOMTFLG) D
"RTN","PSOORCPY",49,0)
 . S PSORXED("DAYS SUPPLY")=$P(PSORXED("RX0"),"^",8),PSORXED("QTY")=$P(PSORXED("RX0"),"^",7)
"RTN","PSOORCPY",50,0)
 . D DAYSUP^PSOUTIL(DREN,.PSORXED,1)
"RTN","PSOORCPY",51,0)
 S PSORXST=+$P($G(^PS(53,$P(PSORXED("RX0"),"^",3),0)),"^",7)
"RTN","PSOORCPY",52,0)
 S POERR=1 D DRG^PSOORDRG K POERR
"RTN","PSOORCPY",53,0)
 I $G(PSORX("DFLG")) S VALMBCK="R"
"RTN","PSOORCPY",54,0)
 ;
"RTN","PSOORCPY",55,0)
 I $G(PSOMTFLG) D  I $G(PSORXED("DFLG")) S VALMBCK="R" G OUT
"RTN","PSOORCPY",56,0)
 . S PSORXED("DAYS SUPPLY")=PSODAYS,PSORXED("QTY")=+$$GET1^DIQ(52,PSORXED("IRXN"),7)
"RTN","PSOORCPY",57,0)
 . W !!,"New Maintenance Rx (Review Quantity):",!,"Drug: ",$$GET1^DIQ(52,PSORXED("IRXN"),6)
"RTN","PSOORCPY",58,0)
 . D EN^PSOFSIG(.PSORXED,1) W !,"Days Supply: ",PSODAYS
"RTN","PSOORCPY",59,0)
 . N PSOQTY S PSORXED("FLD")=5 D QTY^PSODIR1(.PSORXED) W !
"RTN","PSOORCPY",60,0)
 ;
"RTN","PSOORCPY",61,0)
 D EN^PSOORED1(.PSORXED) I $G(PSORX("FN")) S VALMBCK="Q",PSOFROM="NEW" D DCORD^PSONEW2
"RTN","PSOORCPY",62,0)
 E  S VALMBCK="R"
"RTN","PSOORCPY",63,0)
OUT ;
"RTN","PSOORCPY",64,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOORCPY",65,0)
 K PSOCOPY D ^PSOBUILD,ACT^PSOORNE2
"RTN","PSOORCPY",66,0)
EX S X=PSODFN_";DPT(" D ULK^ORX2
"RTN","PSOORCPY",67,0)
 D UL^PSSLOCK(PSODFN)
"RTN","PSOORCPY",68,0)
 K PSOMSG,PSONEW,PSOSIG,STA,DREN,PSODAYS,PSORXST,PSOCOPY,PSORXED,FST,FLD,IEN,FLN,INCOM,PSOI,COPY,SIG,SIGOK
"RTN","PSOORCPY",69,0)
 K PSODRUG,^TMP("PSOPO",$J),PSOMTFLG
"RTN","PSOORCPY",70,0)
 D CLEAN^PSOVER1,EOJ^PSONEW K ZZCOPY
"RTN","PSOORCPY",71,0)
 Q
"RTN","PSOORCPY",72,0)
 ;
"RTN","PSOORCPY",73,0)
LOCK ;
"RTN","PSOORCPY",74,0)
 I $P($G(PSOPLCK),"^")'=0 Q
"RTN","PSOORCPY",75,0)
 W !!,$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2),1:"Another person")_" is working on this patient."
"RTN","PSOORCPY",76,0)
 K DIR S DIR(0)="E",DIR("A")="     Press Return to Continue" D ^DIR K DIR
"RTN","PSOORCPY",77,0)
 Q
"RTN","PSOORCPY",78,0)
 ;
"RTN","PSOORCPY",79,0)
BLDDOSE(PSORXED,MAINTRXF) ; Copies the Dose from Original Rx into Copied/Maintenance Dose Rx
"RTN","PSOORCPY",80,0)
 N DOSEIEN,DOSE
"RTN","PSOORCPY",81,0)
 ; - Copying from the last THEN conjunction (Maintenance Dose Rx)
"RTN","PSOORCPY",82,0)
 ; - For Titration/Maintenance, DOSEIEN = the IEN in the prescription of the last THEN conjunction.
"RTN","PSOORCPY",83,0)
 ; - This value is used as a "seed" for the FOR loop starting point.
"RTN","PSOORCPY",84,0)
 I $G(MAINTRXF) D  Q
"RTN","PSOORCPY",85,0)
 . D LASTTHEN
"RTN","PSOORCPY",86,0)
 . S PSORXED("ENT")=0
"RTN","PSOORCPY",87,0)
 . F  S DOSEIEN=$O(^PSRX(PSORXED("IRXN"),6,DOSEIEN))  Q:'DOSEIEN  D
"RTN","PSOORCPY",88,0)
 . . S DOSE=^PSRX(PSORXED("IRXN"),6,DOSEIEN,0) D
"RTN","PSOORCPY",89,0)
 . . Q:$P(DOSE,"^")']""!($P(DOSE,"^",8)']"")
"RTN","PSOORCPY",90,0)
 . . S PSORXED("ENT")=PSORXED("ENT")+1
"RTN","PSOORCPY",91,0)
 . . D SETDOSE(.PSORXED,DOSEIEN,PSORXED("ENT"))
"RTN","PSOORCPY",92,0)
 . . D EN^PSOFSIG(.PSORXED)
"RTN","PSOORCPY",93,0)
 ;
"RTN","PSOORCPY",94,0)
 ; - Copying dose for Regular Rx Copy
"RTN","PSOORCPY",95,0)
 S PSORXED("ENT")=0
"RTN","PSOORCPY",96,0)
 F DOSEIEN=0:0 S DOSEIEN=$O(^PSRX(PSORXED("IRXN"),6,DOSEIEN)) Q:'DOSEIEN  D
"RTN","PSOORCPY",97,0)
 . S DOSE=^PSRX(PSORXED("IRXN"),6,DOSEIEN,0) D
"RTN","PSOORCPY",98,0)
 . Q:$P(DOSE,"^")']""!($P(DOSE,"^",8)']"")
"RTN","PSOORCPY",99,0)
 . S PSORXED("ENT")=PSORXED("ENT")+1
"RTN","PSOORCPY",100,0)
 . D SETDOSE(.PSORXED,DOSEIEN,PSORXED("ENT"))
"RTN","PSOORCPY",101,0)
 Q
"RTN","PSOORCPY",102,0)
 ;
"RTN","PSOORCPY",103,0)
SETDOSE(PSORXED,DOSEIEN,DOSESEQ) ; Sets the Dose in the PSORXED array
"RTN","PSOORCPY",104,0)
 N DOSE
"RTN","PSOORCPY",105,0)
 S DOSE=^PSRX(PSORXED("IRXN"),6,DOSEIEN,0)
"RTN","PSOORCPY",106,0)
 S PSORXED("DOSE",DOSESEQ)=$P(DOSE,"^")
"RTN","PSOORCPY",107,0)
 S PSORXED("UNITS",DOSESEQ)=$P(DOSE,"^",3)
"RTN","PSOORCPY",108,0)
 S PSORXED("DOSE ORDERED",DOSESEQ)=$P(DOSE,"^",2)
"RTN","PSOORCPY",109,0)
 S PSORXED("ROUTE",DOSESEQ)=$P(DOSE,"^",7)
"RTN","PSOORCPY",110,0)
 S PSORXED("SCHEDULE",DOSESEQ)=$P(DOSE,"^",8)
"RTN","PSOORCPY",111,0)
 S PSORXED("DURATION",DOSESEQ)=$P(DOSE,"^",5)
"RTN","PSOORCPY",112,0)
 S PSORXED("CONJUNCTION",DOSESEQ)=$P(DOSE,"^",6)
"RTN","PSOORCPY",113,0)
 S PSORXED("VERB",DOSESEQ)=$P(DOSE,"^",9)
"RTN","PSOORCPY",114,0)
 I $G(^PSRX(PSORXED("IRXN"),6,DOSEIEN,1))]"" D
"RTN","PSOORCPY",115,0)
 . S PSORXED("ODOSE",DOSESEQ)=^PSRX(PSORXED("IRXN"),6,DOSEIEN,1)
"RTN","PSOORCPY",116,0)
 I $G(PSORXED("DURATION",DOSESEQ))]"" D  K DR,DUR1
"RTN","PSOORCPY",117,0)
 . S DUR1=PSORXED("DURATION",DOSESEQ)
"RTN","PSOORCPY",118,0)
 . S PSORXED("DURATION",DOSESEQ)=$S($E(DUR1,1)'?.N:$E(DUR1,2,99)_$E(DUR1,1),1:DUR1)
"RTN","PSOORCPY",119,0)
 S PSORXED("NOUN",DOSESEQ)=$P(DOSE,"^",4)
"RTN","PSOORCPY",120,0)
 Q
"RTN","PSOORCPY",121,0)
 ;
"RTN","PSOORCPY",122,0)
LASTTHEN ; Determine the IEN of the last THEN conjunction on this prescription and set DOSEIEN to its value.
"RTN","PSOORCPY",123,0)
 N LASTTHEN,LAST
"RTN","PSOORCPY",124,0)
 S LASTTHEN="" F  S LASTTHEN=$O(^PSRX(PSORXED("IRXN"),6,LASTTHEN),-1) Q:LASTTHEN=""!($G(DOSEIEN)'="")  D
"RTN","PSOORCPY",125,0)
 . S DOSEIEN=""
"RTN","PSOORCPY",126,0)
 . S LAST=^PSRX(PSORXED("IRXN"),6,LASTTHEN,0)
"RTN","PSOORCPY",127,0)
 . I $P(LAST,"^",6)="T" S DOSEIEN=LASTTHEN Q
"RTN","PSOORCPY",128,0)
 Q
"RTN","PSOORFI5")
0^5^B48135325^B47164460
"RTN","PSOORFI5",1,0)
PSOORFI5 ;BIR/SJA-finish cprs orders ; 8/27/08 4:47pm
"RTN","PSOORFI5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**225,315,266,391,372,416,504**;DEC 1997;Build 15
"RTN","PSOORFI5",3,0)
 ;External references UL^PSSLOCK supported by DBIA 2789
"RTN","PSOORFI5",4,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSOORFI5",5,0)
 ;
"RTN","PSOORFI5",6,0)
FLG W ! K MEDP,MEDA,POERR("DFLG"),DIR D KQ S PSOSORT="FLAGGED^FLAGGED"
"RTN","PSOORFI5",7,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFI5",8,0)
 .Q:'$D(^PS(52.41,PSOD,0))!('$P($G(^PS(52.41,PSOD,0)),"^",23))
"RTN","PSOORFI5",9,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFI5",10,0)
 .I PAT'=PATA K PSORX("DOSING OFF") I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",11,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",12,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG,PSOQQ Q
"RTN","PSOORFI5",13,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFI5",14,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFI5",15,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFI5",16,0)
 .S PAT(PAT)=PAT
"RTN","PSOORFI5",17,0)
 .F ORD=0:0 S ORD=$O(^PS(52.41,"AOR",PAT,PSOPINST,ORD)) Q:'ORD!($G(POERR("QFLG")))!($G(PSOQQ))  D
"RTN","PSOORFI5",18,0)
 ..I $P($G(^PS(52.41,ORD,0)),"^",23) D PP,LK1,ORD^PSOORFIN
"RTN","PSOORFI5",19,0)
 .S X=PAT D ULP K PSOQQ
"RTN","PSOORFI5",20,0)
 I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",21,0)
 I $G(PSOQUIT) K PSOQUIT D EX G ^PSOORFIN
"RTN","PSOORFI5",22,0)
 G EX
"RTN","PSOORFI5",23,0)
 ;
"RTN","PSOORFI5",24,0)
PRI ; Called from PSOORFIN due to it's routine size.
"RTN","PSOORFI5",25,0)
 K DIR S PSOSORT="PRIORITY"
"RTN","PSOORFI5",26,0)
 S DIR("A")="Select Priority",DIR(0)="SBM^S:STAT;E:EMERGENCY;R:ROUTINE",DIR("B")="ROUTINE"
"RTN","PSOORFI5",27,0)
 D ^DIR G:$D(DIRUT) EX S PSOSORT=PSOSORT_"^"_Y,PSRT=Y
"RTN","PSOORFI5",28,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFI5",29,0)
 .Q:$P($G(^PS(52.41,PSOD,0)),"^",23)
"RTN","PSOORFI5",30,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFI5",31,0)
 .;PSO*7*266
"RTN","PSOORFI5",32,0)
 .I PAT'=PATA K PSORX("DOSING OFF") D LBL^PSOORFIN
"RTN","PSOORFI5",33,0)
 .I '$O(^PS(52.41,"AP",PAT,PSRT,0)) S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",34,0)
 .D PRI^PSOORFI2 I $G(PSZFIN) S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",35,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",36,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP Q
"RTN","PSOORFI5",37,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFI5",38,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFI5",39,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFI5",40,0)
 .D PP S ORD=0 D @PSRT S PAT(PAT)=PAT
"RTN","PSOORFI5",41,0)
 .S X=PAT D ULP
"RTN","PSOORFI5",42,0)
 ;PSO*7*266
"RTN","PSOORFI5",43,0)
 D LBL^PSOORFIN
"RTN","PSOORFI5",44,0)
 I $G(PSOQUIT) K PSOQUIT D EX G ^PSOORFIN
"RTN","PSOORFI5",45,0)
EX D EX^PSOORFI1
"RTN","PSOORFI5",46,0)
 Q
"RTN","PSOORFI5",47,0)
LK D LOCK^PSOORFI1
"RTN","PSOORFI5",48,0)
 Q
"RTN","PSOORFI5",49,0)
LK1 D LOCK1^PSOORFI1 Q
"RTN","PSOORFI5",50,0)
QU I $G(PSOQUIT) S POERR("QFLG")=1 K PSOQUIT
"RTN","PSOORFI5",51,0)
 S:$G(PSOQFLG) PAT(PAT)=PAT
"RTN","PSOORFI5",52,0)
 Q
"RTN","PSOORFI5",53,0)
ULP K PSORX("MAIL/WINDOW"),PSORX("METHOD OF PICK-UP")
"RTN","PSOORFI5",54,0)
 D CLEAN^PSOVER1
"RTN","PSOORFI5",55,0)
 I '$G(X) Q
"RTN","PSOORFI5",56,0)
 D UL^PSSLOCK(X) Q
"RTN","PSOORFI5",57,0)
KLL K PSOPTLOK
"RTN","PSOORFI5",58,0)
 Q
"RTN","PSOORFI5",59,0)
KLLP K PSONOLCK
"RTN","PSOORFI5",60,0)
 Q
"RTN","PSOORFI5",61,0)
SPL D SPL^PSOORFI4
"RTN","PSOORFI5",62,0)
 Q
"RTN","PSOORFI5",63,0)
SDFN S PSODFN=+$G(PSODFN)
"RTN","PSOORFI5",64,0)
 Q
"RTN","PSOORFI5",65,0)
PP D PP^PSOORFI4
"RTN","PSOORFI5",66,0)
 Q
"RTN","PSOORFI5",67,0)
KQ K PSOQUIT,POERR("QFLG")
"RTN","PSOORFI5",68,0)
 Q
"RTN","PSOORFI5",69,0)
S D S^PSOORFI2 ; Process STAT priority
"RTN","PSOORFI5",70,0)
 Q
"RTN","PSOORFI5",71,0)
 ;
"RTN","PSOORFI5",72,0)
E D E^PSOORFI2 ; Process EMERGENCY priority
"RTN","PSOORFI5",73,0)
 Q
"RTN","PSOORFI5",74,0)
 ;
"RTN","PSOORFI5",75,0)
R D R^PSOORFI2 ; Process ROUTINE priority
"RTN","PSOORFI5",76,0)
 Q
"RTN","PSOORFI5",77,0)
 ;
"RTN","PSOORFI5",78,0)
LMDISP(ORD) ; Backdoor ListManager Display of Flag/Unflag Information
"RTN","PSOORFI5",79,0)
 N FLAG
"RTN","PSOORFI5",80,0)
 K FLAGLINE S ORD=+$G(ORD) I 'ORD Q
"RTN","PSOORFI5",81,0)
 ;
"RTN","PSOORFI5",82,0)
 I '$G(^PS(52.41,ORD,"FLG")) Q
"RTN","PSOORFI5",83,0)
 ; S X=IORVON_"Flagged"_IORVOFF
"RTN","PSOORFI5",84,0)
 D GETS^DIQ(52.41,ORD,"33;34;35;36;37;38","IE","FLAG")
"RTN","PSOORFI5",85,0)
 S L1="Flagged by "_$E(FLAG(52.41,ORD_",",34,"E"),1,30)_" on "_$$FMTE^XLFDT(FLAG(52.41,ORD_",",33,"I"),2)_": "
"RTN","PSOORFI5",86,0)
 S LEN=80-$L(L1),L1=L1_$E(FLAG(52.41,ORD_",",35,"E"),1,LEN),L2=$E(FLAG(52.41,ORD_",",35,"E"),LEN+1,999)
"RTN","PSOORFI5",87,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=L1,FLAGLINE(IEN)=7
"RTN","PSOORFI5",88,0)
 I L2'="" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=L2
"RTN","PSOORFI5",89,0)
 I FLAG(52.41,ORD_",",36,"I")'="" D
"RTN","PSOORFI5",90,0)
 . S L1="Unflagged by "_$E(FLAG(52.41,ORD_",",37,"E"),1,30)_" on "_$$FMTE^XLFDT(FLAG(52.41,ORD_",",36,"I"),2)_": "
"RTN","PSOORFI5",91,0)
 . S LEN=80-$L(L1),L1=L1_$E(FLAG(52.41,ORD_",",38,"E"),1,LEN),L2=$E(FLAG(52.41,ORD_",",38,"E"),LEN+1,999)
"RTN","PSOORFI5",92,0)
 . S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=L1,FLAGLINE(IEN)=9
"RTN","PSOORFI5",93,0)
 . I L2'="" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=L2
"RTN","PSOORFI5",94,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" "
"RTN","PSOORFI5",95,0)
 Q
"RTN","PSOORFI5",96,0)
 ;
"RTN","PSOORFI5",97,0)
CS ; Digitally Signed CS - PSO*7*391
"RTN","PSOORFI5",98,0)
 K DIR N PSOCSRT S DIR("A")="Route",DIR(0)="SBM^W:WINDOW;M:MAIL;B:BOTH;E:EXIT",DIR("B")="BOTH" D ^DIR
"RTN","PSOORFI5",99,0)
 Q:$D(DIRUT)!(Y="E")
"RTN","PSOORFI5",100,0)
 S PSOCSRT=$S(Y="B":1,1:Y)
"RTN","PSOORFI5",101,0)
 W !!,"Select a schedule(s)"
"RTN","PSOORFI5",102,0)
 K DIR S PSOSORT="DIGITALLY SIGNED"
"RTN","PSOORFI5",103,0)
 S DIR("A")="Select Schedule(s)",DIR(0)="S^1:SCHEDULE II;2:SCHEDULES III - V;3:SCHEDULES II - V;E:EXIT",DIR("B")=3
"RTN","PSOORFI5",104,0)
 D ^DIR G:$D(DIRUT)!(Y="E") EX S PSOSORT=PSOSORT_"^"_Y,PSRT=Y
"RTN","PSOORFI5",105,0)
 N PDEA,OR0 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFI5",106,0)
 .Q:'$D(^PS(52.41,PSOD,0))
"RTN","PSOORFI5",107,0)
 .S OR0=^PS(52.41,PSOD,0)
"RTN","PSOORFI5",108,0)
 .Q:$P(OR0,"^",23)!('$P(OR0,"^",24))
"RTN","PSOORFI5",109,0)
 .S PDEA=0 D PDEA Q:'PDEA!(PDEA'=PSRT)
"RTN","PSOORFI5",110,0)
 .I 'PSOCSRT,PSOCSRT'=$P(OR0,"^",17) Q
"RTN","PSOORFI5",111,0)
 .Q:$G(PAT($P(OR0,"^",2)))=$P(OR0,"^",2)  S PAT=$P(OR0,"^",2)
"RTN","PSOORFI5",112,0)
 .I PAT'=PATA K PSORX("DOSING OFF") I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",113,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",114,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG,PSOQQ Q
"RTN","PSOORFI5",115,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFI5",116,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFI5",117,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFI5",118,0)
 .S PAT(PAT)=PAT
"RTN","PSOORFI5",119,0)
 .F ORD=0:0 S ORD=$O(^PS(52.41,"AOR",PAT,PSOPINST,ORD)) Q:'ORD!($G(POERR("QFLG")))!($G(PSOQQ))  D
"RTN","PSOORFI5",120,0)
 ..Q:'$D(^PS(52.41,ORD,0))
"RTN","PSOORFI5",121,0)
 ..S OR0=^PS(52.41,ORD,0)
"RTN","PSOORFI5",122,0)
 ..Q:$P(OR0,"^",23)!('$P(OR0,"^",24))
"RTN","PSOORFI5",123,0)
 ..I 'PSOCSRT,PSOCSRT'=$P(OR0,"^",17) Q
"RTN","PSOORFI5",124,0)
 ..Q:$P(OR0,"^",3)="DC"!($P(OR0,"^",3)="DE")
"RTN","PSOORFI5",125,0)
 ..S PDEA=0 D PDEA Q:'PDEA!(PDEA'=PSRT)
"RTN","PSOORFI5",126,0)
 ..D PP,LK1,ORD^PSOORFIN
"RTN","PSOORFI5",127,0)
 .S X=PAT D ULP K PSOQQ
"RTN","PSOORFI5",128,0)
 I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",129,0)
 I $G(PSOQUIT) K PSOQUIT D EX G ^PSOORFIN
"RTN","PSOORFI5",130,0)
 G EX
"RTN","PSOORFI5",131,0)
 ;
"RTN","PSOORFI5",132,0)
PDEA ;
"RTN","PSOORFI5",133,0)
 I +$P(OR0,"^",9) S PDEA=$P($G(^PSDRUG($P(OR0,"^",9),0)),"^",3),PDEA=$S(PDEA[2:1,PDEA[3!(PDEA[4)!(PDEA[5):2,1:0)
"RTN","PSOORFI5",134,0)
 E  S PDEA=$$OIDEA^PSSUTLA1($P(OR0,"^",8),"O")
"RTN","PSOORFI5",135,0)
 I PDEA,PSRT=3 S PDEA=3
"RTN","PSOORFI5",136,0)
 Q
"RTN","PSOORFI5",137,0)
 ;
"RTN","PSOORFI5",138,0)
PRV(PROV,DRG,ORN) ;
"RTN","PSOORFI5",139,0)
 N DETN,DEA,I,LBL,VADD,SPC
"RTN","PSOORFI5",140,0)
 I PROV="" Q
"RTN","PSOORFI5",141,0)
 S DEA=$S($G(ORN):$$RXDEA^PSOUTIL(,ORN),1:$$DEA^XUSER(0,PROV))
"RTN","PSOORFI5",142,0)
 S LBL=$S(DEA["-":" VA#: ",1:"DEA#: ") I $G(ADDS) S LBL=" "_LBL
"RTN","PSOORFI5",143,0)
 I DRG,$$DETOX^PSSOPKI(DRG) S DETN=$S($G(ORN):$$RXDETOX^PSOUTIL(,ORN),1:$$DETOX^XUSER(PROV))
"RTN","PSOORFI5",144,0)
 S $P(SPC," ",($S($G(ADDS):30,1:33)-$L(DEA)))=" "
"RTN","PSOORFI5",145,0)
 I (DEA'="")!($G(DETN)'="") S IEN=IEN+1,$E(^TMP("PSOPO",$J,IEN,0),16)=LBL_DEA_$S($G(DETN)]"":SPC_"DETOX#: "_$G(DETN),1:"")
"RTN","PSOORFI5",146,0)
 I $G(ORN) D PRVAD^PSOPKIV2 I $G(VADD(1))]"" D
"RTN","PSOORFI5",147,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(ADDS):" ",1:"")_"       Site Address: "_VADD(1)
"RTN","PSOORFI5",148,0)
 .S:VADD(2)'="" IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(ADDS):" ",1:"")_"                     "_VADD(2) S:VADD(3)'="" IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(ADDS):" ",1:"")_"                     "_VADD(3)
"RTN","PSOORFI5",149,0)
 Q
"RTN","PSOORFI5",150,0)
 ;
"RTN","PSOORNE3")
0^19^B66007798^B69565652
"RTN","PSOORNE3",1,0)
PSOORNE3 ;ISC-BHAM/SAB - display pending orders from backdoor ;2/3/05 1:59pm
"RTN","PSOORNE3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,9,39,59,46,103,124,139,152,194,391,313,444,504**;DEC 1997;Build 15
"RTN","PSOORNE3",3,0)
 ;Ext ref to ^SC (File #44) (DBIA 10040),^PSXOPUTL (DBIA 2200)
"RTN","PSOORNE3",4,0)
 ;^PS(50.606 (DBIA 2174),^PS(50.7 DBIA 2223),^PS(55,DBIA 2228)
"RTN","PSOORNE3",5,0)
 ;^PSDRUG (DBIA 221)
"RTN","PSOORNE3",6,0)
 K ^TMP("PSOPO",$J) S ORD=$P(PSOLST(ORN),"^",2) D ORD^PSOORFIN Q
"RTN","PSOORNE3",7,0)
 S PSODRUG("OI")=$P(OR0,"^",8),PSODRUG("OIN")=$P(^PS(50.7,$P(OR0,"^",8),0),"^")
"RTN","PSOORNE3",8,0)
 I $P($G(OR0),"^",9) S DREN=$P(OR0,"^",9) S POERR=1 D DRG^PSOORDRG K POERR ;D POST^PSODRG
"RTN","PSOORNE3",9,0)
 I '$P(OR0,"^",9) D DREN^PSOORNW2
"RTN","PSOORNE3",10,0)
 S PSONEW("# OF REFILLS")=$P(OR0,"^",11)
"RTN","PSOORNE3",11,0)
 S (Y,PSONEW("ISSUE DATE"))=$S($G(PSONEW("ISSUE DATE")):PSONEW("ISSUE DATE"),1:$E($P(OR0,"^",6),1,7)) X ^DD("DD")
"RTN","PSOORNE3",12,0)
 S PSONEW("CLERK CODE")=$P(OR0,"^",4),PSORX("CLERK CODE")=$P(^VA(200,$P(OR0,"^",4),0),"^")
"RTN","PSOORNE3",13,0)
 S (PSONEW("DFLG"),PSONEW("QFLG"))=0,PSODFN=$P(OR0,"^",2)
"RTN","PSOORNE3",14,0)
 I '$G(PSOMTFLG) S PSONEW("QTY")=$S($G(PSONEW("QTY")):PSONEW("QTY"),1:$P(OR0,"^",10))
"RTN","PSOORNE3",15,0)
 S PSONEW("MAIL/WINDOW")=$S($P(OR0,"^",17)]"":$P(OR0,"^",17),1:"W")
"RTN","PSOORNE3",16,0)
 S:$G(PSONEW("CLINIC"))']"" PSONEW("CLINIC")=$P(OR0,"^",13)
"RTN","PSOORNE3",17,0)
 S:$G(PSORX("CLINIC"))']"" PSORX("CLINIC")=$S($D(^SC(+$P(OR0,"^",13),0)):$P(^SC($P(OR0,"^",13),0),"^"),1:"")
"RTN","PSOORNE3",18,0)
 S PSONEW("CLERK CODE")=$P(OR0,"^",4),PSONEW("PROVIDER")=$P(OR0,"^",5),PSONEW("PROVIDER NAME")=$P(^VA(200,$P(OR0,"^",5),0),"^")
"RTN","PSOORNE3",19,0)
 S PSONEW("PATIENT STATUS")=$S(+$G(^PS(55,PSODFN,"PS")):+$G(^PS(55,PSODFN,"PS")),1:"")
"RTN","PSOORNE3",20,0)
 S PSONEW("DAYS SUPPLY")=$S(+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3)):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:30)
"RTN","PSOORNE3",21,0)
 S IEN=0 D OBX^PSOORFI1,DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:"")) ;Setup for N/F & DIN indicator
"RTN","PSOORNE3",22,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="* (1) Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNE3",23,0)
 S:NFIO["DIN" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNE3",24,0)
 K LST S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (2)           Drug: "_$S($G(PSODRUG("NAME"))]"":PSODRUG("NAME")_NFID,1:"No Dispense Drug Selected")
"RTN","PSOORNE3",25,0)
 S:NFID["DIN" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNE3",26,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (3) Patient Status: "_$P($G(^PS(53,PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORNE3",27,0)
 S IEN=IEN+1,(PSOID,Y)=$E($P(OR0,"^",6),1,7) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)="   (4)     Issue Date: "_Y
"RTN","PSOORNE3",28,0)
 S (Y,PSONEW("FILL DATE"))=$E($P(OR0,"^",6),1,7) X ^DD("DD") S PSONEW("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                       (5) Fill Date: "_Y
"RTN","PSOORNE3",29,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Instructions:" S TY=3 D INST^PSOORFI1
"RTN","PSOORNE3",30,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (6)   Possible SIG: " D:$G(PSONEW("SIG"))']"" SIG^PSOORFI1 S:$G(PSONEW("SIG"))]"" IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$G(PSONEW("SIG")),IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=PSOERR("SIG")
"RTN","PSOORNE3",31,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (7)    Days Supply: "_$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3)):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:"")
"RTN","PSOORNE3",32,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                                 (8)     QTY: "_$P(OR0,"^",10)
"RTN","PSOORNE3",33,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (9)   # of Refills: "_$P(OR0,"^",11)_$E("  ",$L($P(OR0,"^",11))+1,2)_"                                (10) Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORNE3",34,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (11)         Clinic: "_PSORX("CLINIC")
"RTN","PSOORNE3",35,0)
 S $P(RN," ",32)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (12)       Provider: "_PSONEW("PROVIDER NAME")_$E(RN,$L(PSONEW("PROVIDER NAME"))+1,32)_"  (13)  Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1) K RN
"RTN","PSOORNE3",36,0)
 I $P(^VA(200,$S($G(PSONEW("PROVIDER")):PSONEW("PROVIDER"),1:$P(OR0,"^",5)),"PS"),"^",7)&($P(^("PS"),"^",8)) S IEN=IEN+1,PSONEW("COSIGNING PROVIDER")=$P(^("PS"),"^",8) D
"RTN","PSOORNE3",37,0)
 .S ^TMP("PSOPO",$J,IEN,0)="        Cos-Provider: "_$P(^VA(200,+$G(PSONEW("COSIGNING PROVIDER")),0),"^")
"RTN","PSOORNE3",38,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Provider Comments:" S TY=2 D INST^PSOORFI1
"RTN","PSOORNE3",39,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (14)        Remarks: "
"RTN","PSOORNE3",40,0)
 I $G(PSONEW("REMARKS"))]"" D
"RTN","PSOORNE3",41,0)
 .F SG=1:1:$L(PSONEW("REMARKS")) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("REMARKS")," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNE3",42,0)
 ..S:$P(PSONEW("REMARKS")," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("REMARKS")," ",SG)
"RTN","PSOORNE3",43,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,$P(OR0,"^",4),0),"^")_$E(RN,$L($P(^VA(200,$P(OR0,"^",4),0),"^"))+1,35)
"RTN","PSOORNE3",44,0)
 S Y=$P(OR0,"^",12) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$E($P(OR0,"^",12),4,5)_"/"_$E($P(OR0,"^",12),6,7)_"/"_$E($P(OR0,"^",12),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORNE3",45,0)
 G ^PSOLMPO
"RTN","PSOORNE3",46,0)
 Q
"RTN","PSOORNE3",47,0)
DSPL ;backdoor
"RTN","PSOORNE3",48,0)
 K ^TMP("PSOPO",$J) D DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:"")) ;NFI
"RTN","PSOORNE3",49,0)
 I $D(RX0),$D(PSODRUG("IEN")) D
"RTN","PSOORNE3",50,0)
 .I PSODRUG("IEN")=$P(RX0,"^",6)!($P(PSLST,",",2)) D RST
"RTN","PSOORNE3",51,0)
 S IEN=0,IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNE3",52,0)
 S:NFIO["DIN" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNE3",53,0)
 I $G(PSODRUG("NAME"))]"" D  G PST
"RTN","PSOORNE3",54,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (1)"_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORNE3",55,0)
 .S:NFID["DIN" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNE3",56,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (1)           Drug: No Dispense Drug Selected"
"RTN","PSOORNE3",57,0)
PST S:$G(PSODRUG("TRADE NAME"))]"" IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          Trade Name: "_$S($G(PSODRUG("TRADE NAME"))]"":PSODRUG("TRADE NAME"),1:"")
"RTN","PSOORNE3",58,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (2) Patient Status: "_$P($G(^PS(53,PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORNE3",59,0)
 I $G(PSOID) S Y=PSOID X ^DD("DD") S PSONEW("ISSUE DATE")=Y
"RTN","PSOORNE3",60,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (3)     Issue Date: "_PSONEW("ISSUE DATE")
"RTN","PSOORNE3",61,0)
 S Y=PSONEW("FILL DATE") X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"             (4) Fill Date: "_Y
"RTN","PSOORNE3",62,0)
 D DOSE^PSOBKDED
"RTN","PSOORNE3",63,0)
 I $G(PSORXED("IRXN")),'$G(PSOSIGFL) S RXN=PSORXED("IRXN") D:'$G(COPY) INST1^PSOORNE5 K RXN
"RTN","PSOORNE3",64,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                 SIG:"
"RTN","PSOORNE3",65,0)
 I $G(SIGOK),$O(SIG(0)) D SIG G DSP
"RTN","PSOORNE3",66,0)
 I $D(PSOCOPY),$G(PSONEW("SIG"))']"" D SIG G DSP
"RTN","PSOORNE3",67,0)
 I $G(PSOSIGFL),$G(PSONEW("SIG"))']"" D SIG G DSP
"RTN","PSOORNE3",68,0)
 D:$G(PSONEW("SIG"))]""
"RTN","PSOORNE3",69,0)
 .S X=PSONEW("SIG") D SIGONE^PSOHELP S SIG=$E($G(INS1),2,250)
"RTN","PSOORNE3",70,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNE3",71,0)
DSP S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (7)    Days Supply: "_PSONEW("DAYS SUPPLY")_$S($L(PSONEW("DAYS SUPPLY"))=1:" ",1:"")
"RTN","PSOORNE3",72,0)
 I '$D(PSONEW("FLD")),$D(RX0),'$G(PSOMTFLG) S PSONEW("QTY")=$S($G(PSONEW("QTY")):PSONEW("QTY"),1:$P(RX0,"^",7))
"RTN","PSOORNE3",73,0)
 ;if sched PSONEW("FLD") not def. qty reset
"RTN","PSOORNE3",74,0)
 ;if qty PSONEW("FLD")=7, qty NOT reset
"RTN","PSOORNE3",75,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                     (8)   QTY"_$S($G(PSODRUG("UNIT"))]"":" ("_PSODRUG("UNIT")_")",1:" ( )")_": "_PSONEW("QTY")
"RTN","PSOORNE3",76,0)
 I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),5)),"^")]"" D
"RTN","PSOORNE3",77,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNE3",78,0)
 .S ^TMP("PSOPO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^") K RN
"RTN","PSOORNE3",79,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (9)   # of Refills: "_PSONEW("# OF REFILLS")_$S($L(PSONEW("# OF REFILLS"))=1:" ",1:"")_"                     (10)  Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORNE3",80,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (11)         Clinic: "_$S($G(PSONEW("CLINIC")):$P(^SC(PSONEW("CLINIC"),0),"^"),1:"")
"RTN","PSOORNE3",81,0)
 S $P(RN," ",31)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (12)       Provider: "_PSONEW("PROVIDER NAME")_$E(RN,$L(PSONEW("PROVIDER NAME"))+1,31)_"(13)   Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1) K RN
"RTN","PSOORNE3",82,0)
 I $G(PKI),+$G(PSODRUG("DEA"))>1,+$G(PSODRUG("DEA"))<6 D PRV^PSOORFI5($G(PSONEW("PROVIDER")),$G(PSODRUG("IEN")),$P(OR0,"^"))
"RTN","PSOORNE3",83,0)
 I $G(PSONEW("COSIGNING PROVIDER"))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="        Cos-Provider: "_$P(^VA(200,PSONEW("COSIGNING PROVIDER"),0),"^")
"RTN","PSOORNE3",84,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (14)        Remarks:"
"RTN","PSOORNE3",85,0)
 I $G(PSONEW("REMARKS"))]"" D
"RTN","PSOORNE3",86,0)
 .F SG=1:1:$L(PSONEW("REMARKS")) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("REMARKS")," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " D
"RTN","PSOORNE3",87,0)
 ..S:$P(PSONEW("REMARKS")," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("REMARKS")," ",SG)
"RTN","PSOORNE3",88,0)
 I $G(PSORXED("IRXN")),'$G(PSOSIGFL) S RXN=PSORXED("IRXN") D:'$G(COPY) PC1^PSOORNE5 K RXN
"RTN","PSOORNE3",89,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,DUZ,0),"^")_$E(RN,$L($P(^VA(200,DUZ,0),"^"))+1,35)
"RTN","PSOORNE3",90,0)
 D NOW^%DTC S PSONEW("LOGIN DATE")=% K %,X S Y=PSONEW("LOGIN DATE") X ^DD("DD")
"RTN","PSOORNE3",91,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$P(Y,"@")_" "_$P(Y,"@",2) K RN,PSOFDR
"RTN","PSOORNE3",92,0)
 S (VALMCNT,PSOPF)=IEN Q
"RTN","PSOORNE3",93,0)
SIG ;
"RTN","PSOORNE3",94,0)
 D SIG^PSOORNE6 Q
"RTN","PSOORNE3",95,0)
CMOP ;
"RTN","PSOORNE3",96,0)
 K PSXZ S X="PSXOPUTL" X ^%ZOSF("TEST") K X I  D
"RTN","PSOORNE3",97,0)
 .S DA=RXN D ^PSXOPUTL K DA,PSOCMOP
"RTN","PSOORNE3",98,0)
 .S PSOCMOP=$S($G(PSXZ(PSXZ("L")))=0!($G(PSXZ(PSXZ("L")))=2):"Transmitted",$G(PSXZ(PSXZ("L")))=1:"Released",$G(PSXZ(PSXZ("L")))=3:"Not Dispensed",1:"")
"RTN","PSOORNE3",99,0)
 .I $G(PSXZ(PSXZ("L")))=3 F LBL=0:0 S LBL=$O(^PSRX(RXN,"L",LBL)) Q:'LBL  I $P(^PSRX(RXN,"L",LBL,0),"^",2)=PSXZ("L"),'$P(^(0),"^",5),$P(^(0),"^",3)'["INTERACTION" S PSOCMOP="Local"
"RTN","PSOORNE3",100,0)
 .K PSXZ
"RTN","PSOORNE3",101,0)
 Q
"RTN","PSOORNE3",102,0)
RST ;
"RTN","PSOORNE3",103,0)
 S PSODRUG("IEN")=$P(RX0,"^",6),PSODRUG("OI")=$P(^PSDRUG(($P(RX0,"^",6)),2),"^")
"RTN","PSOORNE3",104,0)
 S PSODRUG("NAME")=$P(^PSDRUG(($P(RX0,"^",6)),0),"^")
"RTN","PSOORNE3",105,0)
 Q
"RTN","PSOORNE3",106,0)
RMK ;
"RTN","PSOORNE3",107,0)
 I $P(RX3,"^",7)]"" D
"RTN","PSOORNE3",108,0)
 .F SG=1:1:$L($P(RX3,"^",7)) S:$L(^TMP("PSOAO",$J,IEN,0)_" "_$P($P(RX3,"^",7)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOAO",$J,IEN,0)," ",21)=" " D
"RTN","PSOORNE3",109,0)
 ..S:$P($P(RX3,"^",7)," ",SG)'="" ^TMP("PSOAO",$J,IEN,0)=$G(^TMP("PSOAO",$J,IEN,0))_" "_$P($P(RX3,"^",7)," ",SG)
"RTN","PSOORNE3",110,0)
 Q
"RTN","PSOORNE5")
0^4^B54894231^B54881611
"RTN","PSOORNE5",1,0)
PSOORNE5 ;BIR/SAB - display orders from backdoor con't ;5/10/07 8:29am
"RTN","PSOORNE5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,32,46,78,99,117,131,146,171,180,210,222,268,206,225,391,444,504**;DEC 1997;Build 15
"RTN","PSOORNE5",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORNE5",4,0)
 ;External references L and UL^PSSLOCK supported by DBIA 2789
"RTN","PSOORNE5",5,0)
 ;External reference to ^PS(51.2 supported by DBIA 2226
"RTN","PSOORNE5",6,0)
 ;External reference to ^PS(50.607 supported by DBIA 2221
"RTN","PSOORNE5",7,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOORNE5",8,0)
 ;called from PSOORNE2
"RTN","PSOORNE5",9,0)
 ;PSO*210 add call to WORDWRAP api
"RTN","PSOORNE5",10,0)
 ;
"RTN","PSOORNE5",11,0)
PEN ;pending orders
"RTN","PSOORNE5",12,0)
 K ^TMP("PSOPO",$J),PSORX("ISSUE DATE"),PSORX("FILL DATE") S ORSV=ORD,ORD=$P(PSOLST(ORN),"^",2)
"RTN","PSOORNE5",13,0)
 I $P($G(^PS(52.41,ORD,0)),"^",3)="DC"!($P($G(^(0)),"^",3)="DE") S VALMBCK="R" Q
"RTN","PSOORNE5",14,0)
 I $G(PSODFN)'=$P($G(^PS(52.41,ORD,0)),"^",2) S VALMBCK="" Q
"RTN","PSOORNE5",15,0)
 I $G(PSOTPBFG) N PSOTPPEN,PSOTPPEX S PSOTPPEN=ORD,PSOTPPEX=0 D VOPNR^PSOTPCAN I PSOTPPEX K PSOTPPEX,PSOTPPEN S VALMBCK="R" Q
"RTN","PSOORNE5",16,0)
 K PSOTPPEX,PSOTPPEN
"RTN","PSOORNE5",17,0)
 I '$G(PSOFIN) S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient."),VALMBCK="" K PSOPLCK Q
"RTN","PSOORNE5",18,0)
 K PSOPLCK
"RTN","PSOORNE5",19,0)
 S PSODRG=+$P($G(^PS(52.41,ORD,0)),"^",9) I $G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) S VALMSG="This Drug has been Inactivated."
"RTN","PSOORNE5",20,0)
 I $P($G(^PS(52.41,ORD,0)),"^",24) S PSOACT=$S($D(^XUSEC("PSDRPH",DUZ)):"DEFX",$D(^XUSEC("PSORPH",DUZ)):"F",$P($G(PSOPAR),"^",2):"F",1:"")
"RTN","PSOORNE5",21,0)
 E  S PSOACT=$S($D(^XUSEC("PSORPH",DUZ)):"DEFX",'$D(^XUSEC("PSORPH",DUZ))&($P($G(PSOPAR),"^",2)):"F",1:"")
"RTN","PSOORNE5",22,0)
 K PSOMSG
"RTN","PSOORNE5",23,0)
OK S PAT=PSODFN,PSORNSV=ORN,PSORNLT=PSLST D ORD^PSOORFIN S PSLST=PSORNLT,ORD=ORSV,ORN=PSORNSV K ORSV,PSORNSV,PSORNLT,PSODRUG S VALMBCK="R"
"RTN","PSOORNE5",24,0)
 K ORCHK,ORDRG,PSOFDR,SIGOK,PSONEW,PSORX("ISSUE DATE"),PSORX("FILL DATE"),PSORX("FN")
"RTN","PSOORNE5",25,0)
 K:'$G(MEDP) PAT
"RTN","PSOORNE5",26,0)
 D CLEAN^PSOVER1
"RTN","PSOORNE5",27,0)
 I '$G(PSOFIN) D UL^PSSLOCK(PSODFN)
"RTN","PSOORNE5",28,0)
 Q
"RTN","PSOORNE5",29,0)
RXNCHK S PSOY=$O(PSONEW("OLD LAST RX#","")) I PSOY="" D AUTO^PSONRXN Q
"RTN","PSOORNE5",30,0)
 S PSONRXN("TYPE")=$S('+$G(^PS(59,+PSOSITE,2)):8,PSODRUG("DEA")["A"&(+$G(^PS(59,+PSOSITE,2))):3,1:8)
"RTN","PSOORNE5",31,0)
 S PSONEW("QFLG")=0 I PSOY'=PSONRXN("TYPE"),$P($G(PSOPAR),"^",7)=1 D
"RTN","PSOORNE5",32,0)
 .S DIE="^PS(59,",DA=PSOSITE,PSOX=PSONEW("OLD LAST RX#",PSOY)
"RTN","PSOORNE5",33,0)
 .L +^PS(59,+PSOSITE,PSOY):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSOORNE5",34,0)
 .S DR=$S(PSOY=8:"2003////"_PSOX,PSOY=3:"1002.1////"_PSOX,1:"2003////"_PSOX)
"RTN","PSOORNE5",35,0)
 .D:PSOX<$P(^PS(59,+PSOSITE,PSOY),"^",3) ^DIE K DIE,X,Y L -^PS(59,+PSOSITE,PSOY)
"RTN","PSOORNE5",36,0)
 .L +^PS(59,+PSOSITE,PSONRXN("TYPE")):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSOORNE5",37,0)
 .S PSOX1=^PS(59,+PSOSITE,PSONRXN("TYPE")),PSONRXN("LO")=$P(PSOX1,"^")
"RTN","PSOORNE5",38,0)
 .S PSONRXN("HI")=$P(PSOX1,"^",2),PSOI=$P(PSOX1,"^",3),PSONEW("OLD LAST RX#",PSONRXN("TYPE"))=PSOI
"RTN","PSOORNE5",39,0)
 .S:PSOI<PSONRXN("LO") PSOI=PSONRXN("LO")
"RTN","PSOORNE5",40,0)
 .D LOOP2 I PSONEW("QFLG") L -^PS(59,+PSOSITE,PSONRXN("TYPE")),-^PSRX("B",PSOI) Q
"RTN","PSOORNE5",41,0)
 .K DIC,DIE,DA S DIE=59,DA=PSOSITE
"RTN","PSOORNE5",42,0)
 .S DR=$S(PSONRXN("TYPE")=8:"2003////"_PSOI,PSONRXN("TYPE")=3:"1002.1////"_PSOI,1:"2003////"_PSOI)
"RTN","PSOORNE5",43,0)
 .S PSONEW("RX #")=PSOI D ^DIE K DIE,DIC,DR,DA L -^PS(59,+PSOSITE,PSONRXN("TYPE"))
"RTN","PSOORNE5",44,0)
 .K PSOX1,PSONRXN,PSOI,X,Y
"RTN","PSOORNE5",45,0)
 Q
"RTN","PSOORNE5",46,0)
LOOP2 F  S PSOI=PSOI+1 D:PSOI>PSONRXN("HI") FATAL^PSONRXN Q:'$D(^PSRX("B",PSOI))!PSONEW("QFLG")
"RTN","PSOORNE5",47,0)
 L +^PSRX("B",PSOI):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I $D(^PSRX("B",PSOI))!'$T G LOOP2
"RTN","PSOORNE5",48,0)
 L -^PSRX("B",PSOI)
"RTN","PSOORNE5",49,0)
 Q
"RTN","PSOORNE5",50,0)
RDSPL ;
"RTN","PSOORNE5",51,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSOORNE5",52,0)
 N MAXRF S MAXRF=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),+$G(PSONEW("DAYS SUPPLY")),+$G(PSONEW("PATIENT STATUS")),.CLOZPAT)
"RTN","PSOORNE5",53,0)
 S (PSONEW("# OF REFILLS"),PSONEW("N# REF"))=$S(($G(PSONEW("# OF REFILLS"))'="")&($G(PSONEW("# OF REFILLS"))'>MAXRF):PSONEW("# OF REFILLS"),1:MAXRF)
"RTN","PSOORNE5",54,0)
 Q
"RTN","PSOORNE5",55,0)
 ;
"RTN","PSOORNE5",56,0)
GET ;
"RTN","PSOORNE5",57,0)
 I $P(PSODRUG0,"^",3)["2" S (ACTREF,ACTREN)=0 Q
"RTN","PSOORNE5",58,0)
 S (ACTREF,ACTREN)=1
"RTN","PSOORNE5",59,0)
 ;refills
"RTN","PSOORNE5",60,0)
 I ST S ACTREF=0
"RTN","PSOORNE5",61,0)
 I '$P(PSOPAR,"^",11),$G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) S ACTREF=0,VALMSG="Inactive Drug, Non Refillable!"
"RTN","PSOORNE5",62,0)
 S PSORFRM=$P(RX0,"^",9) F PSOJ=0:0 S PSOJ=$O(^PSRX(RXN,1,PSOJ)) Q:'PSOJ  S PSORFRM=PSORFRM-1
"RTN","PSOORNE5",63,0)
 S:PSORFRM<0 PSORFRM=0 S:PSORFRM=0 ACTREF=0
"RTN","PSOORNE5",64,0)
 I $G(RXFL(RXN))]"",'$P(PSOPAR,"^",6) S ACTREF=0
"RTN","PSOORNE5",65,0)
 I $P(PSODRUG0,"^",3)["A"&($P(PSODRUG0,"^",3)'["B")!($P(PSODRUG0,"^",3)["F")!($P(PSODRUG0,"^",3)[1)!($P(PSODRUG0,"^",3)[2) S ACTREF=0
"RTN","PSOORNE5",66,0)
 ;renews
"RTN","PSOORNE5",67,0)
 I $P(PSOPAR,"^",4)=0 S ACTREN=0 Q
"RTN","PSOORNE5",68,0)
 I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" S ACTREN=0
"RTN","PSOORNE5",69,0)
 I $G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) S ACTREN=0,VALMSG="This Drug has been Inactivated."
"RTN","PSOORNE5",70,0)
 I '$P($G(^PSDRUG(PSODRG,2)),"^"),'$P($G(^PSRX(RXN,"OR1")),"^") S ACTREN=0,VALMSG="Drug must be Matched to an Orderable Item!"
"RTN","PSOORNE5",71,0)
 I ($P(PSODRUG0,"^",3)["W")!($P(PSODRUG0,"^",3)[1)!($P(PSODRUG0,"^",3)[2) S ACTREN=0
"RTN","PSOORNE5",72,0)
 I $D(^PS(53,+$P(RX0,"^",3),0)),'$P(^(0),"^",5) S ACTREN=0
"RTN","PSOORNE5",73,0)
 S PSOLC=$P(RX0,"^"),PSOLC=$E(PSOLC,$L(PSOLC)) I $A(PSOLC)'<90 S ACTREN=0
"RTN","PSOORNE5",74,0)
 I ST,ST'=2,ST'=5,ST'=6,ST'=11,ST'=12 S ACTREN=0
"RTN","PSOORNE5",75,0)
 K PSORFRM,PSOLC,PSODRG,PSODRUG0
"RTN","PSOORNE5",76,0)
 Q
"RTN","PSOORNE5",77,0)
INST ;formats instruction from front door
"RTN","PSOORNE5",78,0)
 D INST^PSOORNE6 Q
"RTN","PSOORNE5",79,0)
PC ;displays provider comments
"RTN","PSOORNE5",80,0)
 D PC^PSOORNE6 Q
"RTN","PSOORNE5",81,0)
INST1 ;formats instruction from front door
"RTN","PSOORNE5",82,0)
 D INST1^PSOORNE6 Q
"RTN","PSOORNE5",83,0)
PC1 ;displays provider comments
"RTN","PSOORNE5",84,0)
 D PC1^PSOORNE6 Q
"RTN","PSOORNE5",85,0)
DOSE ;displays dosing instruction for both simple and complex backdoor Rxs.
"RTN","PSOORNE5",86,0)
 I '$O(^PSRX(RXN,6,0))  S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" (3)          Dosage: " Q
"RTN","PSOORNE5",87,0)
 S DS=1 F I=0:0 S I=$O(^PSRX(RXN,6,I)) Q:'I  S DOSE=^PSRX(RXN,6,I,0) D
"RTN","PSOORNE5",88,0)
 .I '$P(DOSE,"^",2),$P(DOSE,"^",9)]"" S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                Verb: "_$P(DOSE,"^",9)
"RTN","PSOORNE5",89,0)
 .I $G(DS)=1 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" (3)"
"RTN","PSOORNE5",90,0)
 .D DOSE1 S PSORXED("ENT")=$G(PSORXED("ENT"))+1
"RTN","PSOORNE5",91,0)
 K DOSE,I
"RTN","PSOORNE5",92,0)
 Q
"RTN","PSOORNE5",93,0)
DOSE1 ;
"RTN","PSOORNE5",94,0)
 I $G(DS)=1 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"         *Dosage: "_$S($E($P(DOSE,"^"),1)="."&($P(DOSE,"^",2)):"0",1:"")_$P(DOSE,"^")_$S($P(DOSE,"^",3)]"":" ("_$P(^PS(50.607,$P(DOSE,"^",3),0),"^")_")",1:"") K DS G DU
"RTN","PSOORNE5",95,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="             *Dosage: "_$S($E($P(DOSE,"^"),1)="."&($P(DOSE,"^",2)):"0",1:"")_$P(DOSE,"^")_$S($P(DOSE,"^",3)]"":" ("_$P(^PS(50.607,$P(DOSE,"^",3),0),"^")_")",1:"")
"RTN","PSOORNE5",96,0)
DU I '$P(DOSE,"^",2),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="   Oth. Lang. Dosage: "_$G(^PSRX(RXN,6,I,1))
"RTN","PSOORNE5",97,0)
 I $P(DOSE,"^",2),$P(DOSE,"^",9)]"" D
"RTN","PSOORNE5",98,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                Verb: "_$P(DOSE,"^",9)
"RTN","PSOORNE5",99,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="      Dispense Units: "_$S($E($P(DOSE,"^",2),1)=".":"0",1:"")_$P(DOSE,"^",2)
"RTN","PSOORNE5",100,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                Noun: "_$P(DOSE,"^",4)
"RTN","PSOORNE5",101,0)
 I $P(DOSE,"^",7) S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="              *Route: "_$P(^PS(51.2,$P(DOSE,"^",7),0),"^")
"RTN","PSOORNE5",102,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="           *Schedule: "_$P(DOSE,"^",8)
"RTN","PSOORNE5",103,0)
 I $P(DOSE,"^",5)]"" D
"RTN","PSOORNE5",104,0)
 .S DUR=$S($E($P(DOSE,"^",5),1)'?.N:$E($P(DOSE,"^",5),2,99)_$E($P(DOSE,"^",5),1),1:$P(DOSE,"^",5))
"RTN","PSOORNE5",105,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="           *Duration: "_DUR_" ("_$S($P(DOSE,"^",5)["M":"MINUTES",$P(DOSE,"^",5)["H":"HOURS",$P(DOSE,"^",5)["L":"MONTHS",$P(DOSE,"^",5)["W":"WEEKS",1:"DAYS")_")" K DUR
"RTN","PSOORNE5",106,0)
 I $P(DOSE,"^",6)]"" S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="        *Conjunction: "_$S($P(DOSE,"^",6)="A":"AND",$P(DOSE,"^",6)="T":"THEN",$P(DOSE,"^",6)="X":"EXCEPT",1:"")
"RTN","PSOORNE5",107,0)
 Q
"RTN","PSOORNE5",108,0)
INS ;patient instructions                                        ;PSO*210
"RTN","PSOORNE5",109,0)
 I $G(^PSRX(RXN,"INS"))]"",'$O(^PSRX(RXN,"INS1",0)) D  K SG G SPINS
"RTN","PSOORNE5",110,0)
 .S PSORXED("SIG",1)=^PSRX(RXN,"INS")
"RTN","PSOORNE5",111,0)
 .D WORDWRAP^PSOUTLA2(^PSRX(RXN,"INS"),.IEN,$NA(^TMP("PSOAO",$J)),21)
"RTN","PSOORNE5",112,0)
 ;
"RTN","PSOORNE5",113,0)
 I $O(^PSRX(RXN,"INS1",0)) D
"RTN","PSOORNE5",114,0)
 .S T=0 F  S T=$O(^PSRX(RXN,"INS1",T)) Q:'T  D
"RTN","PSOORNE5",115,0)
 .. S (PSORXED("SIG",T),MIG)=^PSRX(RXN,"INS1",T,0)
"RTN","PSOORNE5",116,0)
 .. D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAO",$J)),21)
"RTN","PSOORNE5",117,0)
SPINS K T,SG,MIG
"RTN","PSOORNE5",118,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="  Other Pat. Instruc: "_$S($G(^PSRX(RXN,"INSS"))]"":^PSRX(RXN,"INSS"),1:"")
"RTN","PSOORNE5",119,0)
 Q
"RTN","PSOORNE5",120,0)
SV S VALMSG="Pre-POE Rx. Please Compare Dosing Fields with SIG!"
"RTN","PSOORNE5",121,0)
 Q
"RTN","PSOORNE5",122,0)
PRV ;
"RTN","PSOORNE5",123,0)
 N DETN,DEA,I,LBL,VADD,SPC,ORN S ORN=ORD
"RTN","PSOORNE5",124,0)
 S DEA=$$RXDEA^PSOUTIL(+$G(RXN))
"RTN","PSOORNE5",125,0)
 S LBL=$S(DEA["-":"  VA#: ",1:" DEA#: ")
"RTN","PSOORNE5",126,0)
 I $$DETOX^PSSOPKI($P(RX0,"^",6)) S DETN=$$RXDETOX^PSOUTIL(+$G(RXN))
"RTN","PSOORNE5",127,0)
 S $P(SPC," ",(28-$L(DEA)))=" "
"RTN","PSOORNE5",128,0)
 I (DEA'="")!($G(DETN)'="") S IEN=IEN+1,$E(^TMP("PSOAO",$J,IEN,0),16)=LBL_DEA_$S($G(DETN)]"":SPC_"DETOX#: "_$G(DETN),1:"")
"RTN","PSOORNE5",129,0)
 D PRVAD^PSOPKIV2
"RTN","PSOORNE5",130,0)
 I $G(VADD(1))]"" D
"RTN","PSOORNE5",131,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="        Site Address: "_VADD(1)
"RTN","PSOORNE5",132,0)
 .S:VADD(2)'="" IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                      "_VADD(2) S:VADD(3)'="" IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                      "_VADD(3)
"RTN","PSOORNE5",133,0)
 Q
"RTN","PSOPKIV2")
0^7^B23372370^B23138982
"RTN","PSOPKIV2",1,0)
PSOPKIV2 ;BIR/MHA - Dig Signed Pending order Auto-DC message ;08/17/11
"RTN","PSOPKIV2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**391,495,504**;DEC 1997;Build 15
"RTN","PSOPKIV2",3,0)
 ;
"RTN","PSOPKIV2",4,0)
ADCMAIL ;
"RTN","PSOPKIV2",5,0)
 N XX,QQ,ZZ S ZZ="PSOPODC" S:'$G(DFN) DFN=PSODFN D ^VADPT,ADD^VADPT
"RTN","PSOPKIV2",6,0)
 K ^TMP(ZZ,$J)
"RTN","PSOPKIV2",7,0)
 S XMSUB=$P(^PS(59,PSOSITE,0),"^",6)_" - DIGITALLY SIGNED "_$S($P(OR0,"^",3)="RNW":"RE",1:"")_"NEW ORDER AUTO DISCONTINUED",XMDUZ=.5
"RTN","PSOPKIV2",8,0)
 S LC=1,^TMP(ZZ,$J,LC)="",LC=LC+1
"RTN","PSOPKIV2",9,0)
 S ^TMP(ZZ,$J,LC)="Following order was auto discontinued when finishing a pending order due to "_$P(PKIE,": ",2),LC=LC+1
"RTN","PSOPKIV2",10,0)
 S ^TMP(ZZ,$J,LC)="",LC=LC+1
"RTN","PSOPKIV2",11,0)
 S ^TMP(ZZ,$J,LC)="Division      : "_$P(^PS(59,PSOSITE,0),"^"),LC=LC+1
"RTN","PSOPKIV2",12,0)
 S ^TMP(ZZ,$J,LC)="CPRS Order #  : "_$P(OR0,"^"),LC=LC+1
"RTN","PSOPKIV2",13,0)
 S ^TMP(ZZ,$J,LC)="Issue Date    : "_PSONEW("ISSUE DATE"),LC=LC+1
"RTN","PSOPKIV2",14,0)
 S ^TMP(ZZ,$J,LC)="Patient       : "_$P(^DPT(DFN,0),U)_" ("_$G(VA("BID"))_")",LC=LC+1
"RTN","PSOPKIV2",15,0)
 ;S ^TMP(ZZ,$J,LC)="Address       : ",LC=LC+1
"RTN","PSOPKIV2",16,0)
 D PATAD
"RTN","PSOPKIV2",17,0)
 S ^TMP(ZZ,$J,LC)="Drug          : "_$G(PSODRUG("NAME")),LC=LC+1
"RTN","PSOPKIV2",18,0)
 S QQ=PSONEW("DOSE",1) S:PSONEW("UNITS",1) QQ=QQ_"("_$P(^PS(50.607,PSONEW("UNITS",1),0),"^")_")"
"RTN","PSOPKIV2",19,0)
 I $O(PSONEW("DOSE",1)) S XX=1 F  S XX=$O(PSONEW("DOSE",XX)) Q:'XX  D
"RTN","PSOPKIV2",20,0)
 .S QQ=QQ_","_PSONEW("DOSE",XX)
"RTN","PSOPKIV2",21,0)
 .S:PSONEW("UNITS",XX) QQ=QQ_"("_$P(^PS(50.607,PSONEW("UNITS",XX),0),"^")_")"
"RTN","PSOPKIV2",22,0)
 S ^TMP(ZZ,$J,LC)="Dosage Ordered: "_QQ
"RTN","PSOPKIV2",23,0)
 S LC=LC+1
"RTN","PSOPKIV2",24,0)
 S ^TMP(ZZ,$J,LC)="Dosage Form   : "_PSONEW("NOUN",1),LC=LC+1
"RTN","PSOPKIV2",25,0)
 S ^TMP(ZZ,$J,LC)="Quantity      : "_PSONEW("QTY")
"RTN","PSOPKIV2",26,0)
 N TLC K TMP("ZZ") S XX=0,TLC=1,TMP("ZZ",1,0)="SIG           : "
"RTN","PSOPKIV2",27,0)
 F  S XX=$O(^PS(52.41,ORD,"SIG",XX)) Q:'XX  D
"RTN","PSOPKIV2",28,0)
 .S QQ=^PS(52.41,ORD,"SIG",XX,0)
"RTN","PSOPKIV2",29,0)
 .D WORDWRAP^PSOUTLA2(QQ,.TLC,$NA(TMP("ZZ")),15)
"RTN","PSOPKIV2",30,0)
 S XX=0 F  S XX=$O(TMP("ZZ",XX)) Q:'XX  S ^TMP(ZZ,$J,LC+1)=TMP("ZZ",XX,0)
"RTN","PSOPKIV2",31,0)
 S LC=LC+1
"RTN","PSOPKIV2",32,0)
 S ^TMP(ZZ,$J,LC)="Provider      : "_PSONEW("PROVIDER NAME"),LC=LC+1
"RTN","PSOPKIV2",33,0)
 D PRV
"RTN","PSOPKIV2",34,0)
 S LC=LC+1,^TMP(ZZ,$J,LC)=""
"RTN","PSOPKIV2",35,0)
 I $G(PKIOR)=16 D MISMCH
"RTN","PSOPKIV2",36,0)
 D MGRP
"RTN","PSOPKIV2",37,0)
 S XMY(DUZ)="",XMTEXT="^TMP(ZZ,$J," N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOPKIV2",38,0)
 K ^TMP(ZZ,$J)
"RTN","PSOPKIV2",39,0)
 Q
"RTN","PSOPKIV2",40,0)
 ;
"RTN","PSOPKIV2",41,0)
MISMCH ;Reason for mis-match
"RTN","PSOPKIV2",42,0)
 N XX,XY,XZ,X1,X2,XM,PSOARY,HASH
"RTN","PSOPKIV2",43,0)
 S HASH=$$HSHCHK^PSOPKIV1(.PSOARY,ORD) I HASH'=-1 Q
"RTN","PSOPKIV2",44,0)
 I $O(PSOARY(""))="" Q
"RTN","PSOPKIV2",45,0)
 ;I $G(PSOARY)'=-1 Q
"RTN","PSOPKIV2",46,0)
 S $P(XZ," ",80)="",LC=LC+1
"RTN","PSOPKIV2",47,0)
 S ^TMP(ZZ,$J,LC)="Differences in CPRS and Pharmacy Pending File",LC=LC+1,^TMP(ZZ,$J,LC)=""
"RTN","PSOPKIV2",48,0)
 S LC=LC+1,^TMP(ZZ,$J,LC)="Data Name          CPRS File                    Pharmacy Pending File"
"RTN","PSOPKIV2",49,0)
 S LC=LC+1,^TMP(ZZ,$J,LC)="---------          ---------                    ---------------------"
"RTN","PSOPKIV2",50,0)
 S LC=LC+1,XX=""
"RTN","PSOPKIV2",51,0)
 F  S XX=$O(PSOARY(XX)) Q:XX=""  D
"RTN","PSOPKIV2",52,0)
 .S XY=PSOARY(XX),LC=LC+1
"RTN","PSOPKIV2",53,0)
 .S X1=$P(XY,"^"),X2=$P(XY,"^",2)
"RTN","PSOPKIV2",54,0)
 .S XM=$S($L(X1)>$L(X2):X1,1:X2),STR=""
"RTN","PSOPKIV2",55,0)
 .F I=0:1:$L(XM) Q:$E(XM,28*I,$L(XM))=""  D
"RTN","PSOPKIV2",56,0)
 .. S ^TMP(ZZ,$J,LC)=$S(I=0:$E(XX,1,18),1:"")_$$BLNK(19,$S(I=0:$E(XX,1,18),1:""))_$E(X1,(28*I),(28*I+28))_$$BLNK(29,$S($E(X1,(28*I),(28*I+28))]"":$E(X1,(28*I),(28*I+28)),1:""))_$E(X2,(28*I),(28*I+28)),LC=LC+1
"RTN","PSOPKIV2",57,0)
 Q
"RTN","PSOPKIV2",58,0)
 ;
"RTN","PSOPKIV2",59,0)
BLNK(X,STR) ;blank spaces
"RTN","PSOPKIV2",60,0)
 N XZ,SP
"RTN","PSOPKIV2",61,0)
 Q:X="" ""
"RTN","PSOPKIV2",62,0)
 S $P(XZ," ",80)="",SP=X-$L(STR)
"RTN","PSOPKIV2",63,0)
 Q $E(XZ,1,SP)
"RTN","PSOPKIV2",64,0)
MGRP ;
"RTN","PSOPKIV2",65,0)
 N MDUZ S MDUZ=0 F  S MDUZ=$O(^XUSEC("PSDMGR",MDUZ)) Q:MDUZ'>0  S XMY(MDUZ)=""
"RTN","PSOPKIV2",66,0)
 Q
"RTN","PSOPKIV2",67,0)
 ;
"RTN","PSOPKIV2",68,0)
PRV ;
"RTN","PSOPKIV2",69,0)
 N DEA,VADD,PRV,DRG,ORN
"RTN","PSOPKIV2",70,0)
 S PRV=$G(PSONEW("PROVIDER")),DRG=$G(PSODRUG("IEN")),ORN=$P(OR0,"^")
"RTN","PSOPKIV2",71,0)
 I PRV="" Q
"RTN","PSOPKIV2",72,0)
 S DEA=$$DEA^XUSER(0,PRV)
"RTN","PSOPKIV2",73,0)
 S DEA=$S(DEA["-":"VA#           : ",1:"DEA#          : ")_DEA
"RTN","PSOPKIV2",74,0)
 S ^TMP(ZZ,$J,LC)=DEA
"RTN","PSOPKIV2",75,0)
 I $$DETOX^PSSOPKI(DRG),$$RXDETOX^PSOUTIL(,+$G(ORN))'="" S ^TMP(ZZ,$J,LC)=^TMP(ZZ,$J,LC)_"  DETOX#: "_$$RXDETOX^PSOUTIL(,+$G(ORN))
"RTN","PSOPKIV2",76,0)
 D PRVAD
"RTN","PSOPKIV2",77,0)
 I $G(VADD(1))]"" D
"RTN","PSOPKIV2",78,0)
 .S LC=LC+1,^TMP(ZZ,$J,LC)="Site Address  : "_VADD(1)
"RTN","PSOPKIV2",79,0)
 .S:VADD(2)'="" LC=LC+1,^TMP(ZZ,$J,LC)="                "_VADD(2)
"RTN","PSOPKIV2",80,0)
 .S:VADD(3)'="" LC=LC+1,^TMP(ZZ,$J,LC)="                "_VADD(3)
"RTN","PSOPKIV2",81,0)
 Q
"RTN","PSOPKIV2",82,0)
 ;
"RTN","PSOPKIV2",83,0)
PRVAD ;
"RTN","PSOPKIV2",84,0)
 K ^TMP($J,"ORDEA")
"RTN","PSOPKIV2",85,0)
 D ARCHIVE^ORDEA(ORN)
"RTN","PSOPKIV2",86,0)
 I $D(^TMP($J,"ORDEA",ORN,3)) S VADD=^(3) D
"RTN","PSOPKIV2",87,0)
 .S VADD(1)=$P(VADD,"^",2),VADD(2)=$P(VADD,"^",3),VADD(3)=$P(VADD,"^",4)_", "_$P(VADD,"^",5)_" "_$P($P(VADD,"^",6),"-")
"RTN","PSOPKIV2",88,0)
 K ^TMP($J,"ORDEA")
"RTN","PSOPKIV2",89,0)
 Q
"RTN","PSOPKIV2",90,0)
 ;
"RTN","PSOPKIV2",91,0)
PATAD ;
"RTN","PSOPKIV2",92,0)
 N PSOBADR,PSOTEMP,PSOFORGN,I,T
"RTN","PSOPKIV2",93,0)
 S PSOBADR=0,PSOTEMP=0,XX=0
"RTN","PSOPKIV2",94,0)
 S PSOFORGN=$P($G(VAPA(25)),"^",2) I PSOFORGN'="",PSOFORGN'["UNITED STATES" S PSOFORGN=1
"RTN","PSOPKIV2",95,0)
 I 'PSOFORGN S PSOBADR=$$BADADR^DGUTL3(DFN)
"RTN","PSOPKIV2",96,0)
 I 'PSOFORGN,PSOBADR S PSOTEMP=$$CHKTEMP^PSOBAI(DFN)
"RTN","PSOPKIV2",97,0)
 F I=1:1:3 I $G(VAPA(I))]"" D
"RTN","PSOPKIV2",98,0)
 . S T="" I I=1,'PSOFORGN,PSOBADR,'$G(PSOTEMP) S T="** BAD ADDRESS INDICATED **"
"RTN","PSOPKIV2",99,0)
 . I I=1,T="",PSOFORGN S T="*** FOREIGN ADDRESS ***"
"RTN","PSOPKIV2",100,0)
 . I T="" I 'PSOFORGN I 'PSOBADR!$G(PSOTEMP) S T=$G(VAPA(I))
"RTN","PSOPKIV2",101,0)
 . I I=1,T]"" S ^TMP(ZZ,$J,LC)="Address       : "_T,LC=LC+1
"RTN","PSOPKIV2",102,0)
 . I I>1,T]"" S ^TMP(ZZ,$J,LC)="                "_T,LC=LC+1
"RTN","PSOPKIV2",103,0)
 S I=+$G(VAPA(5)) I I S I=$S($D(^DIC(5,I,0)):$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOPKIV2",104,0)
 S T="" I 'PSOFORGN I 'PSOBADR!$G(PSOTEMP) S T=$G(VAPA(4))_", "_I_"  "_$S($G(VAPA(11)):$P(VAPA(11),"^",2),1:$G(VAPA(6)))
"RTN","PSOPKIV2",105,0)
 S:T]"" ^TMP(ZZ,$J,LC)="                "_T,LC=LC+1
"RTN","PSOPKIV2",106,0)
 Q
"RTN","PSOPKIV2",107,0)
 ;
"RTN","PSORENW")
0^10^B48759882^B47375085
"RTN","PSORENW",1,0)
PSORENW ; BIR/SAB - renew main driver ;4/25/07 8:42am
"RTN","PSORENW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,30,46,71,96,100,130,148,206,388,390,417,313,411,504**;DEC 1997;Build 15
"RTN","PSORENW",3,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSORENW",4,0)
 ;External reference to $$L^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",5,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",6,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",7,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",8,0)
 ;External reference to LK^ORX2 supported by DBIA 867
"RTN","PSORENW",9,0)
 ;External reference to ULK^ORX2 supported by DBIA 867
"RTN","PSORENW",10,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORENW",11,0)
 ;External reference to MAIN^TIUEDIT supported by DBIA 2410
"RTN","PSORENW",12,0)
 ;
"RTN","PSORENW",13,0)
ASK ;
"RTN","PSORENW",14,0)
 K PSORENW("FILL DATE"),ZZCOPY D FILLDT^PSODIR2(.PSORENW) S:$G(PSORENW("DFLG")) VALMSG="Renew Rx request canceled",VALMBCK="R"
"RTN","PSORENW",15,0)
 I PSORENW("DFLG")!('$D(PSORENW("FILL DATE"))) S PSORENW("QFLG")=1,PSORENW("DFLG")=0 G ASKX
"RTN","PSORENW",16,0)
 S PSORNW("FILL DATE")=PSORENW("FILL DATE")
"RTN","PSORENW",17,0)
 D MW^PSOCMOPA(.PSORENW)
"RTN","PSORENW",18,0)
 I PSORENW("DFLG") S PSORENW("QFLG")=1,PSORENW("DFLG")=0 G ASKX
"RTN","PSORENW",19,0)
 S PSORNW("MAIL/WINDOW")=PSORENW("MAIL/WINDOW") S PSORX("MAIL/WINDOW")=$S(PSORENW("MAIL/WINDOW")="M":"MAIL",1:"WINDOW")
"RTN","PSORENW",20,0)
 D NOORE^PSONEW(.PSORENW) S:$G(PSORENW("DFLG")) VALMSG="Renew Rx request canceled",VALMBCK="R"
"RTN","PSORENW",21,0)
 I PSORENW("DFLG")!('$D(PSORENW("FILL DATE"))) S PSORENW("QFLG")=1,PSORENW("DFLG")=0
"RTN","PSORENW",22,0)
ASKX Q
"RTN","PSORENW",23,0)
 ;
"RTN","PSORENW",24,0)
EOJ ;
"RTN","PSORENW",25,0)
 K VERB,RTE,DRET,PSOMSG,PSORNW,PSOLIST,PSORENW,PSORX("BAR CODE"),PSORX("FILL DATE"),PSODIR,PSOID,PSONOOR,PSOCOU,PSOCOUU,PSOID,PSOFDMX,PSODRUG,COPY,PSOBCKDR
"RTN","PSORENW",26,0)
 N ZRXN
"RTN","PSORENW",27,0)
 S RXN=$O(^TMP("PSORXN",$J,0)) I RXN S ZRXN=RXN D
"RTN","PSORENW",28,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSORENW",29,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS",$P(RXN1,"^",4))
"RTN","PSORENW",30,0)
 .;saves drug allergy order chks pso*7*411
"RTN","PSORENW",31,0)
 .I $D(^TMP("PSODAOC",$J)) D  Q:$G(PSORX("DFLG"))
"RTN","PSORENW",32,0)
 ..I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSORENW",33,0)
 ..S RXN=ZRXN
"RTN","PSORENW",34,0)
 .S PSOARENW=1 D DAOC^PSONEW K PSOARENW
"RTN","PSORENW",35,0)
 I $G(PSORNEDT),'$O(^TMP("PSORXN",$J,0)),$D(^TMP("PSODAOC",$J)) S ZRXN=PSORNEDT,PSOARENW=1 D DAOC^PSONEW K PSOARENW,PSORNEDT
"RTN","PSORENW",36,0)
 K ZZCOPY,ZRXN,RXN,RXN1,^TMP("PSORXN",$J),^TMP("PSODAOC",$J)
"RTN","PSORENW",37,0)
 I $G(PSONOTE) D MAIN^TIUEDIT(3,.TIUDA,PSODFN,"","","","",1)
"RTN","PSORENW",38,0)
 K PSONOTE
"RTN","PSORENW",39,0)
 Q
"RTN","PSORENW",40,0)
OERR ;entry for renew backdoor
"RTN","PSORENW",41,0)
 N PSORNEDT,PSORXIEN,PSOCHECK
"RTN","PSORENW",42,0)
 S PSORXIEN=+$P($G(PSOLST(ORN)),"^",2)
"RTN","PSORENW",43,0)
 ; Checking whether the Provider still qualifies as prescriber for the renewed Rx
"RTN","PSORENW",44,0)
 S PSOCHECK=$$CHKRXPRV^PSOUTIL(PSORXIEN)
"RTN","PSORENW",45,0)
 I 'PSOCHECK S VALMSG=$P(PSOCHECK,"^",2),VALMBCK="R" W $C(7) Q
"RTN","PSORENW",46,0)
 I $$TITRX^PSOUTL(PSORXIEN)="t" D  Q
"RTN","PSORENW",47,0)
 . S VALMSG="Cannot Renew a 'Titration Rx'.",VALMBCK="R" W $C(7)
"RTN","PSORENW",48,0)
 I $$LMREJ^PSOREJU1(PSORXIEN,,.VALMSG,.VALMBCK) Q
"RTN","PSORENW",49,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSORENW",50,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSORENW",51,0)
 K PSOID,PSOFDMX,PSORX("FILL DATE"),PSORENW("FILL DATE"),PSORX("QS"),PSORENW("QS"),PSOBARCD,COPY
"RTN","PSORENW",52,0)
 D PSOL^PSSLOCK(PSORXIEN) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG D ULPAT Q
"RTN","PSORENW",53,0)
 S PSOBCKDR=1,PSOFROM="NEW",PSORENW("OIRXN")=PSORXIEN,PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"),PSORX("DFLG"))=0
"RTN","PSORENW",54,0)
 S PSONEW("DAYS SUPPLY")=$P(^PSRX(PSORENW("OIRXN"),0),"^",8),PSONEW("# OF REFILLS")=$P(^(0),"^",9)
"RTN","PSORENW",55,0)
 D FULL^VALM1,ASK D:PSORENW("QFLG") KLIB^PSORENW1 D:PSORENW("QFLG") ULPAT D:PSORENW("QFLG") PSOUL^PSSLOCK(PSORXIEN) G:PSORENW("QFLG") EOJ D ^PSORENW0
"RTN","PSORENW",56,0)
 D ULPAT,EOJ,KLIB^PSORENW1 K PSOOPT,PSONEW,PSORX("DFLG"),X,Y
"RTN","PSORENW",57,0)
 Q
"RTN","PSORENW",58,0)
ULPAT K PSOMSG D UL^PSSLOCK(PSODFN) S X=PSODFN_";DPT(" D ULK^ORX2 K X
"RTN","PSORENW",59,0)
 Q
"RTN","PSORENW",60,0)
RENEW(PLACER,PSOCPDRG) ;passes flag to CPRS for front door renews
"RTN","PSORENW",61,0)
 ;-1=couldn't find order, 0=unable to renew, 1=renewable
"RTN","PSORENW",62,0)
 ;Placer=Pharmacy number
"RTN","PSORENW",63,0)
 N PSOSURX,PSORFRM,PSOLC,PSODRG,PSODRUG0,RXN,ST,PSONEWOI,PSOOLDOI,PSOIFLAG,PSOINA,RX0,X1,X2
"RTN","PSORENW",64,0)
 I $G(PLACER)["S"!('$G(PLACER)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSORENW",65,0)
 S RXN=PLACER I '$D(^PSRX(RXN,0)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSORENW",66,0)
 S RX0=^PSRX(RXN,0),PSODRG=+$P(^PSRX(RXN,0),"^",6),ST=+^("STA"),PSODRUG0=^PSDRUG(PSODRG,0)
"RTN","PSORENW",67,0)
 S PSOIFLAG=0,PSOOLDOI=+$P($G(^PSRX(RXN,"OR1")),"^"),PSONEWOI=+$P($G(^PSDRUG(+$G(PSODRG),2)),"^") I PSONEWOI,PSONEWOI'=PSOOLDOI S PSOIFLAG=1
"RTN","PSORENW",68,0)
 S PSOINA=$P($G(^PS(50.7,PSONEWOI,0)),"^",4)
"RTN","PSORENW",69,0)
 I PSOINA,DT>PSOINA Q "0^This Orderable Item has been Inactivated."
"RTN","PSORENW",70,0)
 I ST=5 S PSOSURX=$O(^PS(52.5,"B",RXN,0)) I PSOSURX,$P($G(^PS(52.5,PSOSURX,0)),"^",7)="L" Q "0^Rx loading into a CMOP Transmission."
"RTN","PSORENW",71,0)
 S X1=DT,X2=-120 D C^%DTC I $P($G(^PSRX(RXN,2)),"^",6)<X Q "0^Prescription Expired more than 120 Days."
"RTN","PSORENW",72,0)
 S X1=DT,X2=-120 D C^%DTC I $P($G(^PSRX(RXN,3)),"^",5),$P($G(^(3)),"^",5)<X,$P(^("STA"),"^")=12 Q "0^Prescription Discontinued more than 120 Days."
"RTN","PSORENW",73,0)
 I $G(PSOCPDRG),$G(PSOCPDRG)'=$G(PSODRG) Q "0^Drug Mismatch, Non-Renewable."
"RTN","PSORENW",74,0)
 N PSOOCPRX,PSOOLPF,PSOOLPD,PSONOSIG S PSOOCPRX=RXN D CDOSE^PSORENW0 I PSOOLPF Q "0^Non-Renewable, invalid Dosage of "_$G(PSOOLPD)
"RTN","PSORENW",75,0)
 I PSONOSIG Q "0^Non-Renewable, missing Sig."
"RTN","PSORENW",76,0)
 I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" Q "0^Drug is No longer used by Outpatient Pharmacy."
"RTN","PSORENW",77,0)
 I $G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) Q "0^This Drug has been Inactivated."
"RTN","PSORENW",78,0)
 I ($P(PSODRUG0,"^",3)[1)!($P(PSODRUG0,"^",3)[2)!($P(PSODRUG0,"^",3)["W") Q "0^Non-Renewable "_$S($P(PSODRUG0,"^",3)["A":"Drug Narcotic.",1:"Drug.")
"RTN","PSORENW",79,0)
 I $D(^PS(53,+$P(RX0,"^",3),0)),'$P(^(0),"^",5) Q "0^Non-Renewable Prescription."
"RTN","PSORENW",80,0)
 S PSOLC=$P(RX0,"^"),PSOLC=$E(PSOLC,$L(PSOLC)) I $A(PSOLC)'<90 Q "0^Max number of renewals (26) has been reached."
"RTN","PSORENW",81,0)
 I ST,ST'=2,ST'=5,ST'=6,ST'=11,ST'=12,ST'=14 Q "0^Prescription is in a Non-Renewable Status."
"RTN","PSORENW",82,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",4) Q "0^Duplicate Rx Renewal Request."
"RTN","PSORENW",83,0)
 I $O(^PS(52.41,"AQ",RXN,0)) Q "0^Duplicate Rx Renewal Request."
"RTN","PSORENW",84,0)
 N TITMSG
"RTN","PSORENW",85,0)
 I $$TITRX^PSOUTL(RXN)="t" D  Q TITMSG
"RTN","PSORENW",86,0)
 . S TITMSG="0^Prescription was marked as 'Titration to Maintenance Dose' by Pharmacy and cannot be renewed."
"RTN","PSORENW",87,0)
 . S TITMSG=TITMSG_" To repeat the titration, enter a new prescription or copy the prior titration order."
"RTN","PSORENW",88,0)
 . S TITMSG=TITMSG_" To continue the maintenance dose, refill this prescription if refills are available"
"RTN","PSORENW",89,0)
 . S TITMSG=TITMSG_" or enter a new prescription for the maintenance dose."
"RTN","PSORENW",90,0)
 K PSORFRM,PSOLC,PSODRG,PSODRUG0,RXN,ST,TITMSG
"RTN","PSORENW",91,0)
 Q 1_$S($G(PSOIFLAG):"^"_$G(PSONEWOI),1:"")
"RTN","PSORENW",92,0)
 ;
"RTN","PSORENW",93,0)
INST1 ;Set Pharmacy Instructions array
"RTN","PSORENW",94,0)
 N PSOTZ
"RTN","PSORENW",95,0)
 I $O(^PSRX(RXN,"PI",0)) S PHI=$G(^PSRX(RXN,"PI",0)),PSOTZ=0 D
"RTN","PSORENW",96,0)
 .F  S PSOTZ=$O(^PSRX(RXN,"PI",PSOTZ)) Q:PSOTZ=""  S PHI(PSOTZ)=$G(^PSRX(RXN,"PI",PSOTZ,0))
"RTN","PSORENW",97,0)
 Q
"RTN","PSORENW",98,0)
INST2 ;Set Instructions and Comments
"RTN","PSORENW",99,0)
 I '$G(PSORENW("OIRXN")) Q
"RTN","PSORENW",100,0)
 I $G(PSOFDR) Q
"RTN","PSORENW",101,0)
 N PSOPHL,PSOPRL
"RTN","PSORENW",102,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PI",0)) K PHI S PHI=$G(^PSRX(PSORENW("OIRXN"),"PI",0)),PSOPHL="" D
"RTN","PSORENW",103,0)
 .F  S PSOPHL=$O(^PSRX(PSORENW("OIRXN"),"PI",PSOPHL)) Q:PSOPHL=""  S PHI(PSOPHL)=$G(^PSRX(PSORENW("OIRXN"),"PI",PSOPHL,0))
"RTN","PSORENW",104,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PRC",0)) K PRC S PRC=$G(^PSRX(PSORENW("OIRXN"),"PRC",0)),PSOPRL="" D
"RTN","PSORENW",105,0)
 .F  S PSOPRL=$O(^PSRX(PSORENW("OIRXN"),"PRC",PSOPRL)) Q:PSOPRL=""  S PRC(PSOPRL)=$G(^PSRX(PSORENW("OIRXN"),"PRC",PSOPRL,0))
"RTN","PSORENW",106,0)
 Q
"RTN","PSORENW4")
0^12^B73245534^B65687099
"RTN","PSORENW4",1,0)
PSORENW4 ;BIR/SAB - rx speed renew ;03/06/95
"RTN","PSORENW4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,37,64,46,75,71,100,130,117,152,148,264,225,301,390,313,411,444,504**;DEC 1997;Build 15
"RTN","PSORENW4",3,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSORENW4",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORENW4",5,0)
 ;External reference to $$L^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",6,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",7,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",8,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",9,0)
 ;External reference to LK^ORX2 supported by DBIA 867
"RTN","PSORENW4",10,0)
 ;External reference to ULK^ORX2 supported by DBIA 867
"RTN","PSORENW4",11,0)
SEL K PSODRUG ;PSO*7*301
"RTN","PSORENW4",12,0)
 N PSOSPRNW,PSOIBOLD S PSOSPRNW=1
"RTN","PSORENW4",13,0)
 I $P(PSOPAR,"^",4)=0 S VALMSG="Renewing is NOT Allowed. Check Site Parameters!",VALMBCK="" Q
"RTN","PSORENW4",14,0)
 N VALMCNT I '$G(PSOCNT) S VALMSG="This patient has no Prescriptions!",VALMBCK="" Q
"RTN","PSORENW4",15,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSORENW4",16,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSORENW4",17,0)
 K PRC,PHI,PSORX("EDIT"),PSOFDR,DIR,DUOUT,DIRUT,PSORNSPD S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DUOUT S VALMBCK="" G SELQ
"RTN","PSORENW4",18,0)
 K DIR,DIRUT,DTOUT,PSOOELSE,DTOUT I +Y S (SPEED,PSOOELSE,PSORNSPD)=1 D FULL^VALM1 S LST=Y D
"RTN","PSORENW4",19,0)
 .S (PSODIR("DFLG"),PSODIR("FIELD"))=0,PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"),PSORX("DFLG"))=0 D INIT Q:PSORENW("DFLG")
"RTN","PSORENW4",20,0)
 .F ORD=1:1:$L(LST,",") Q:$P(LST,",",ORD)']""  S ORN=$P(LST,",",ORD) D:+PSOLST(ORN)=52 PROCESS S (PSOQUIT,PSORENW("DFLG"),POERR,POERR("DFLG"),PSORX("DFLG"))=0
"RTN","PSORENW4",21,0)
 I '$G(PSOOELSE) S VALMBCK="" G SELQ
"RTN","PSORENW4",22,0)
 S VALMBCK="R"
"RTN","PSORENW4",23,0)
 D ^PSOBUILD,BLD^PSOORUT1 K DIR,DIRUT,DTOUT,DUOUT,LST,ORD,IEN,ORN,RPH,ST,REFL,REF,PSOACT,ORSV,PSORNW,PSORENW,PSONO,PSOCO,PSOCU,PSODIR,DSMSG,SPEED,PSORENW,PSOOELSE,PSOOPT,PSORX("FILL DATE"),PSORX("ISSUE DATE"),PSOID,PSOMSG,PSORX("DFLG"),PSOQTY
"RTN","PSORENW4",24,0)
SELQ K PSORNSPD,RTE,DRET,PRC,PHI,PSOSPRNW,X S X=PSODFN_";DPT(" D ULK^ORX2,UL^PSSLOCK(PSODFN),CLEAN^PSOVER1
"RTN","PSORENW4",25,0)
 Q
"RTN","PSORENW4",26,0)
 ;
"RTN","PSORENW4",27,0)
PROCESS ; Process one order at a time
"RTN","PSORENW4",28,0)
 N PSORXIEN,PSOCHECK,MAXNUMRF
"RTN","PSORENW4",29,0)
 S PSORXIEN=+$P($G(PSOLST(ORN)),"^",2)
"RTN","PSORENW4",30,0)
 I $$LMREJ^PSOREJU1(PSORXIEN) D  K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",31,0)
 . W $C(7),!!,"Rx# "_$$GET1^DIQ(52,PSORXIEN,.01)_" has OPEN/UNRESOLVED 3rd Party Payer Rejects!"
"RTN","PSORENW4",32,0)
 I $$TITRX^PSOUTL(PSORXIEN)="t" D  K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",33,0)
 . W $C(7),!!,"Rx# "_$$GET1^DIQ(52,PSORXIEN,.01)_" is marked as 'Titration Rx' and cannot be renewed."
"RTN","PSORENW4",34,0)
 ; Checking whether the Provider still qualifies as prescriber for the renewed Rx
"RTN","PSORENW4",35,0)
 S PROVIEN=$S($G(PSORENW("PROVIDER")):PSORENW("PROVIDER"),1:+$$GET1^DIQ(52,PSORXIEN,4,"I"))
"RTN","PSORENW4",36,0)
 S PSOCHECK=$$CHKRXPRV^PSOUTIL(PSORXIEN,PROVIEN)
"RTN","PSORENW4",37,0)
 I 'PSOCHECK D  K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",38,0)
 . W $C(7),!!,"Rx# "_$$GET1^DIQ(52,PSORXIEN,.01)_" - "_$P(PSOCHECK,"^",3)
"RTN","PSORENW4",39,0)
 ; Checking the Maximum Number of Refills Allowed
"RTN","PSORENW4",40,0)
 S MAXNUMRF=$$MAXNUMRF^PSOUTIL(+$$GET1^DIQ(52,PSORXIEN,6,"I"),+$G(PSORENW("DAYS SUPPLY")),+$G(PSORENW("PATIENT STATUS")),.CLOZPAT)
"RTN","PSORENW4",41,0)
 I PSORENW("# OF REFILLS")>MAXNUMRF D  K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",42,0)
 . W $C(7),!!,"Rx# "_$$GET1^DIQ(52,PSORXIEN,.01)_" - # of Refills requested exceeds maximum allowed ("_MAXNUMRF_") for this Rx"
"RTN","PSORENW4",43,0)
 ; Checking if Rx is locked by Another person
"RTN","PSORENW4",44,0)
 D PSOL^PSSLOCK(PSORXIEN) I '$G(PSOMSG) W $C(7),!!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing Rx "_$P(^PSRX(PSORXIEN,0),"^")),! K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",45,0)
 K RET,DRET,PRC,PHI S PSORENW("OIRXN")=PSORXIEN,PSOFROM="NEW"
"RTN","PSORENW4",46,0)
 S PSORENW("RX0")=^PSRX(PSORENW("OIRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN")),SIGOK=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^",2)
"RTN","PSORENW4",47,0)
 I SIGOK F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),"SIG1",I)) Q:'I  S SIG(I)=^PSRX(PSORENW("OIRXN"),"SIG1",I,0)
"RTN","PSORENW4",48,0)
 S PSOIBOLD=$G(PSORENW("OIRXN")) D SETIB^PSORENW1
"RTN","PSORENW4",49,0)
 I '$G(PSORENW("PROVIDER")) D
"RTN","PSORENW4",50,0)
 .S PSORENW("PROVIDER")=$P(PSORENW("RX0"),"^",4)
"RTN","PSORENW4",51,0)
 .S:$P(PSORENW("RX3"),"^",3) PSORENW("COSIGNING PROVIDER")=$P(PSORENW("RX3"),"^",3)
"RTN","PSORENW4",52,0)
 S PSORX("PROVIDER NAME")=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSORENW4",53,0)
 I '$G(PSORENW("CLINIC")) S PSORENW("CLINIC")=$P(PSORENW("RX0"),"^",5)
"RTN","PSORENW4",54,0)
 S PSORENW("REMARKS")="RENEWED FROM RX # "_$P(PSORENW("RX0"),"^")
"RTN","PSORENW4",55,0)
 S PSORENW("SIG")=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^")
"RTN","PSORENW4",56,0)
 S PSORENW("PSODFN")=$P(PSORENW("RX0"),"^",2)
"RTN","PSORENW4",57,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSORENW4",58,0)
 S PSORENW("DRUG IEN")=$P(PSORENW("RX0"),"^",6)
"RTN","PSORENW4",59,0)
 S PSORENW("QTY")=$P(PSORENW("RX0"),"^",7)
"RTN","PSORENW4",60,0)
 S PSORENW("INS")=$S($G(PSORENW("ENT"))]"":PSORENW("ENT"),1:$G(^PSRX(PSORENW("OIRXN"),"INS")))
"RTN","PSORENW4",61,0)
 S:$G(PSORENW("ENT"))']"" PSORENW("ENT")=0
"RTN","PSORENW4",62,0)
 N I F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),6,I)) Q:'I  S DOSE=^PSRX(PSORENW("OIRXN"),6,I,0) D
"RTN","PSORENW4",63,0)
 .S PSORENW("ENT")=PSORENW("ENT")+1,PSORENW("DOSE",PSORENW("ENT"))=$P(DOSE,"^")
"RTN","PSORENW4",64,0)
 .S PSORENW("UNITS",PSORENW("ENT"))=$P(DOSE,"^",3),PSORENW("DOSE ORDERED",PSORENW("ENT"))=$P(DOSE,"^",2),PSORENW("ROUTE",PSORENW("ENT"))=$P(DOSE,"^",7)
"RTN","PSORENW4",65,0)
 .S PSORENW("SCHEDULE",PSORENW("ENT"))=$P(DOSE,"^",8),PSORENW("DURATION",PSORENW("ENT"))=$P(DOSE,"^",5),PSORENW("CONJUNCTION",PSORENW("ENT"))=$P(DOSE,"^",6)
"RTN","PSORENW4",66,0)
 .S PSORENW("NOUN",PSORENW("ENT"))=$P(DOSE,"^",4),PSORENW("VERB",PSORENW("ENT"))=$P(DOSE,"^",9)
"RTN","PSORENW4",67,0)
 .I $G(^PSRX(PSORENW("OIRXN"),6,I,1))]"" S PSORENW("ODOSE",PSORENW("ENT"))=^PSRX(PSORENW("OIRXN"),6,I,1)
"RTN","PSORENW4",68,0)
 .K DOSE
"RTN","PSORENW4",69,0)
 I $P($G(^PSDRUG(PSORENW("DRUG IEN"),"CLOZ1")),"^")="PSOCLO1" N PSON S PSON=0 D  I PSON K PSON D POZ,KLIB^PSORENW1 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSORENW4",70,0)
 . I '$L($P(^VA(200,PSORENW("PROVIDER"),"PS"),"^",2)),'$L($P(^VA(200,PSORENW("PROVIDER"),"PS"),"^",3)) D  Q
"RTN","PSORENW4",71,0)
 . . S PSON=1 W $C(7),!!,"Only providers with DEA# or a VA# can write prescriptions for clozapine.",!
"RTN","PSORENW4",72,0)
 . I '$D(^XUSEC("YSCL AUTHORIZED",PSORENW("PROVIDER"))) D 
"RTN","PSORENW4",73,0)
 . . S PSON=1 W $C(7),!!,"Provider must hold YSCL AUTHORIZED key to write prescriptions for clozapine.",!
"RTN","PSORENW4",74,0)
 I $G(PSORNW("MAIL/WINDOW"))]"" S PSORENW("MAIL/WINDOW")=PSORNW("MAIL/WINDOW")
"RTN","PSORENW4",75,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PI",0)) D  K T
"RTN","PSORENW4",76,0)
 .S PHI=^PSRX(PSORENW("OIRXN"),"PI",0),T=0
"RTN","PSORENW4",77,0)
 .F  S T=$O(^PSRX(PSORENW("OIRXN"),"PI",T)) Q:'T  S PHI(T)=^PSRX(PSORENW("OIRXN"),"PI",T,0)
"RTN","PSORENW4",78,0)
 W !!,"Now Renewing Rx # "_PSORENW("ORX #")_"   Drug: "_$P($G(^PSDRUG(+$G(PSORENW("DRUG IEN")),0)),"^"),!
"RTN","PSORENW4",79,0)
 I '$P($G(^PSDRUG($P(PSORENW("RX0"),"^",6),2)),"^") D  G:$G(PSORENW("DFLG")) PROCESSX
"RTN","PSORENW4",80,0)
 .I $P($G(^PSRX(PSORENW("OIRXN"),"OR1")),"^") S PSODRUG("OI")=$P(^PSRX(PSORENW("OIRXN"),"OR1"),"^"),PSODRUG("OIN")=$P(^PS(50.7,+^("OR1"),0),"^") Q
"RTN","PSORENW4",81,0)
 .W !!,"Cannot Renew!!  No Pharmacy Orderable Item!" S VALMSG="Cannot Renew!!  No Pharmacy Orderable Item!",PSORX("DFLG")=1
"RTN","PSORENW4",82,0)
 D POZ
"RTN","PSORENW4",83,0)
 D CHECK^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",84,0)
 D FILDATE^PSORENW0
"RTN","PSORENW4",85,0)
 D DRUG^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",86,0)
 D RXN^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",87,0)
 D STOP^PSORENW1
"RTN","PSORENW4",88,0)
DSPL K PSOEDT,PSOLM,BBFLG,BBRX,BINGCRT,BINGRTE S PSDY=PSORENW("DAYS SUPPLY"),PSRF=PSORENW("# OF REFILLS")
"RTN","PSORENW4",89,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S PSODIR("CS")=1
"RTN","PSORENW4",90,0)
 N MXRFLS
"RTN","PSORENW4",91,0)
 S MXRFLS=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),+$G(PSORENW("DAYS SUPPLY")),+$P(^PSRX(PSORENW("OIRXN"),0),"^",3),.CLOZPAT)
"RTN","PSORENW4",92,0)
 I MXRFLS<PSORENW("# OF REFILLS") S PSORENW("# OF REFILLS")=MXRFLS
"RTN","PSORENW4",93,0)
 D DSPLY^PSORENW3 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",94,0)
 D:$D(^XUSEC("PSORPH",DUZ))!('$P(PSOPAR,"^",2)) VER1^PSOORNE4(.PSORENW) G:PSORENW("DFLG")=1 PROCESSX
"RTN","PSORENW4",95,0)
 I $G(PSOQTY) D QTY^PSODIR1(.PSORENW) G:PSORENW("DFLG")=1 PROCESSX
"RTN","PSORENW4",96,0)
 D EN^PSORN52(.PSORENW)
"RTN","PSORENW4",97,0)
 D RNPSOSD^PSOUTIL
"RTN","PSORENW4",98,0)
 D CAN^PSORENW0,DCORD^PSONEW2
"RTN","PSORENW4",99,0)
 S PSORENW("# OF REFILLS")=PSRF K PSDY,PSRF,PSODIR("CS"),DEA,PSORENW("ENT")
"RTN","PSORENW4",100,0)
 S BBRN="",BBRN1=$O(^PSRX("B",PSORENW("NRX #"),BBRN)) I $P($G(^PSRX(BBRN1,0)),"^",11)["W" S BINGCRT="Y",BINGRTE="W",BBFLG=1,BBRX(1)=$G(BBRX(1))_BBRN1_","
"RTN","PSORENW4",101,0)
PROCESSX I PSORENW("DFLG") D
"RTN","PSORENW4",102,0)
 .K PHI,PRC,PSODRUG,SIG,PSORXED,SIGOK
"RTN","PSORENW4",103,0)
 .K PSORENW("DOSE"),PSORENW("DURATION"),PSORENW("DRUG IEN"),PSORENW("ENT"),PSORENW("INS"),PSORENW("NOUN"),PSORENW("ROUTE"),PSORENW("SCHEDULE"),PSORENW("SIG"),PSORENW("VERB"),PSORENW("UNITS")
"RTN","PSORENW4",104,0)
 .I '$G(POERR) W !,$C(7),"Rx NOT RENEWED. RENEWED RX DELETED",! S POERR("DFLG")=1 D CLEAN^PSOVER1,POZ
"RTN","PSORENW4",105,0)
 K PSORDLOK I PSORENW("DFLG") S PSORDLOK=1
"RTN","PSORENW4",106,0)
 D:$G(PSORENW("OLD FILL DATE"))]"" SUSDATEK^PSOUTIL(.PSORENW)
"RTN","PSORENW4",107,0)
 K BBRN,BBRN1,PSODRUG,PSORX("PROVIDER NAME"),PSORX("CLINIC")
"RTN","PSORENW4",108,0)
 K PSOEDT,PSOLM S:$G(PSORENW("FROM"))="" (PSORENW("DFLG"),PSORENW("QFLG"))=0
"RTN","PSORENW4",109,0)
 I $G(PSORDLOK) D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSORENW4",110,0)
 D KLIB^PSORENW1
"RTN","PSORENW4",111,0)
 K PSORDLOK
"RTN","PSORENW4",112,0)
 S RXN=$O(^TMP("PSORXN",$J,0)) I RXN N ZRXN S ZRXN=RXN D
"RTN","PSORENW4",113,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSORENW4",114,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS",$P(RXN1,"^",4))
"RTN","PSORENW4",115,0)
 .;saves drug allergy order chks pso*7*390
"RTN","PSORENW4",116,0)
 .I $D(^TMP("PSODAOC",$J,"ALLERGY")) D 
"RTN","PSORENW4",117,0)
 ..I $G(PSORX("DFLG"))!$G(PSORENW("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSORENW4",118,0)
 ..S RXN=ZRXN,PSODAOC="Rx Backdoor "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"SPEED RENEW Order Acceptance_OP"
"RTN","PSORENW4",119,0)
 ..S PSOARENW=1 D DAOC^PSONEW K PSOARENW
"RTN","PSORENW4",120,0)
 K ZRXN,RXN,RXN1,^TMP("PSORXN",$J),^TMP("PSODAOC",$J)
"RTN","PSORENW4",121,0)
 Q
"RTN","PSORENW4",122,0)
INIT ;
"RTN","PSORENW4",123,0)
 D ASK Q:PSORENW("DFLG")
"RTN","PSORENW4",124,0)
 D NOORE^PSONEW(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",125,0)
 Q
"RTN","PSORENW4",126,0)
ASK ;upfront questions
"RTN","PSORENW4",127,0)
 W !! D ISSDT^PSODIR2(.PSORENW) Q:PSORENW("DFLG")  S PSORENW("ISSUE DATE")=PSOID
"RTN","PSORENW4",128,0)
 D FILLDT^PSODIR2(.PSORENW) K PSONEW("DAYS SUPPLY"),PSONEW("# OF REFILLS") Q:PSORENW("DFLG")
"RTN","PSORENW4",129,0)
 S PSORNW("FILL DATE")=PSORENW("FILL DATE")
"RTN","PSORENW4",130,0)
 D MW^PSODIR2(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",131,0)
 D PTSTAT^PSODIR1(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",132,0)
 D DAYS^PSODIR1(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",133,0)
 S PSODRUG("DEA")=0 D REFILL^PSODIR1(.PSORENW) K PSODRUG("DEA") Q:PSORENW("DFLG")
"RTN","PSORENW4",134,0)
 K DIR,DIRUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Do you want to edit Renewed Rx(s) QTY " D ^DIR I $D(DIRUT) S PSORENW("DFLG")=1 K DIR,DIRUT Q
"RTN","PSORENW4",135,0)
 S PSOQTY=Y K DIR,DIRUT,Y
"RTN","PSORENW4",136,0)
 D CLINIC^PSODIR2(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",137,0)
 D PROV^PSODIR(.PSORENW) S:PSORENW("DFLG") PSORENW("DFLG")=0
"RTN","PSORENW4",138,0)
 Q
"RTN","PSORENW4",139,0)
 ;
"RTN","PSORENW4",140,0)
POZ ;
"RTN","PSORENW4",141,0)
 K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DTOUT
"RTN","PSORENW4",142,0)
 Q
"RTN","PSORXVW")
0^1^B80641069^B80713537
"RTN","PSORXVW",1,0)
PSORXVW ;BHAM ISC/SAB - listman view of a prescription ;6/7/12 7:00pm
"RTN","PSORXVW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**14,35,46,96,103,88,117,131,146,156,185,210,148,233,260,264,281,359,385,400,391,313,427,504**;DEC 1997;Build 15
"RTN","PSORXVW",3,0)
 ;External reference to File ^PS(55 supported by DBIA 2228
"RTN","PSORXVW",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORXVW",5,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSORXVW",6,0)
 ;External reference to ^VA(200 supported by DBIA 10060
"RTN","PSORXVW",7,0)
 ;External reference to ^SC supported by DBIA 10040
"RTN","PSORXVW",8,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSORXVW",9,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSORXVW",10,0)
 ;External reference to GMRADPT supported by DBIA 10099
"RTN","PSORXVW",11,0)
 ;External reference to $$BADADR^DGUTL3 supported by DBIA 4080
"RTN","PSORXVW",12,0)
 ;
"RTN","PSORXVW",13,0)
 S PS="VIEW"
"RTN","PSORXVW",14,0)
A1 ; - Prescription prompt
"RTN","PSORXVW",15,0)
 S DIR(0)="FAO^1:30",DIR("A")=PS_" PRESCRIPTION: ",(DIR("?"),DIR("??"))="^D HLP^PSORXVW1"
"RTN","PSORXVW",16,0)
 W ! D ^DIR I X=""!$D(DIRUT) K:$G(PS)="VIEW" DA K PS G KILL
"RTN","PSORXVW",17,0)
 S X=$$UP^XLFSTR(X),QUIT=0
"RTN","PSORXVW",18,0)
 I $E(X,1,2)'="E." S (DA,PSOVDA)=+$$LKP^PSORXVW1(X) I DA<0 G A1
"RTN","PSORXVW",19,0)
 I $E(X,1,2)="E." D  I QUIT G A1   ; esg 12/7/10 - ECME# lookup - PSO*7*359
"RTN","PSORXVW",20,0)
 .S (DA,PSOVDA)=+$$RXNUM^PSOBPSU2($E(X,3,$L(X))) I DA<0 W " ??",$C(7) S QUIT=1
"RTN","PSORXVW",21,0)
 ;
"RTN","PSORXVW",22,0)
 ; pso*7*385 - esg - Routine BPSRVX is calling this routine here at entry point DP in order to capture the
"RTN","PSORXVW",23,0)
 ; scratch global data for the View ECME Rx option.  Special variable BPSVRX=1 in this case.
"RTN","PSORXVW",24,0)
DP ; DBIA #4711 entry point from ECME
"RTN","PSORXVW",25,0)
 ;
"RTN","PSORXVW",26,0)
 S (PSODFN,DFN)=+$P(^PSRX(DA,0),"^",2) S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSORXVW",27,0)
 D ICN^PSODPT(PSODFN)
"RTN","PSORXVW",28,0)
 K ^TMP("PSOHDR",$J) D ^VADPT,ADD^VADPT
"RTN","PSORXVW",29,0)
 S ^TMP("PSOHDR",$J,1,0)=VADM(1)
"RTN","PSORXVW",30,0)
 N PSOBADR,PSOTEMP
"RTN","PSORXVW",31,0)
 S PSOBADR=$$BADADR^DGUTL3(DFN) I PSOBADR S PSOTEMP=$$CHKTEMP^PSOBAI(DFN) D
"RTN","PSORXVW",32,0)
 .S ^TMP("PSOHDR",$J,1,0)=^TMP("PSOHDR",$J,1,0)_" ** BAD ADDRESS INDICATED-("_$S(PSOBADR=1:"UNDELIVERABLE",PSOBADR=2:"HOMELESS",1:"OTHER")_")"_$S(PSOTEMP:" Active Temporary Address",1:"")
"RTN","PSORXVW",33,0)
 S ^TMP("PSOHDR",$J,2,0)=$P(VADM(2),"^",2)
"RTN","PSORXVW",34,0)
 S ^TMP("PSOHDR",$J,3,0)=$P(VADM(3),"^",2),^TMP("PSOHDR",$J,4,0)=VADM(4),^TMP("PSOHDR",$J,5,0)=$P(VADM(5),"^",2)
"RTN","PSORXVW",35,0)
 S POERR=1 D RE^PSODEM K PSOERR
"RTN","PSORXVW",36,0)
 S ^TMP("PSOHDR",$J,6,0)=$S(+$P(WT,"^",8):$P(WT,"^",9)_" ("_$P(WT,"^")_")",1:"_______ (______)")
"RTN","PSORXVW",37,0)
 S ^TMP("PSOHDR",$J,7,0)=$S($P(HT,"^",8):$P(HT,"^",9)_" ("_$P(HT,"^")_")",1:"_______ (______)") K VM,WT,HT S PSOHD=7
"RTN","PSORXVW",38,0)
 S GMRA="0^0^111" D EN1^GMRADPT S ^TMP("PSOHDR",$J,8,0)=+$G(GMRAL)
"RTN","PSORXVW",39,0)
 D DEM^VADPT I +VADM(6) D
"RTN","PSORXVW",40,0)
 .S SSN=$P(^DPT(PSODFN,0),"^",9) W !,$C(7),?10,$P(^DPT(PSODFN,0),"^")_" ("_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_") DIED "_$P(VADM(6),"^",2),!
"RTN","PSORXVW",41,0)
 .W "All Active Medications will be Autocanceled!",! H 2 S PSODEATH=1
"RTN","PSORXVW",42,0)
 .S ACOM="Date of Death "_$P(VADM(6),"^",2)_".",ZTRTN="CAN^PSOCAN3",ZTDESC="Outpatient Pharmacy Autocancel Due to Death of Patient",ZTSAVE("ACOM")="",ZTSAVE("PSODFN")="",ZTSAVE("PSODEATH")=""
"RTN","PSORXVW",43,0)
 .S ZTIO="",PSOCLC=DUZ,ZTSAVE("PSOCLC")="",ZTDTH=$H D ^%ZTLOAD K ACOM,ZTSK,PSODEATH
"RTN","PSORXVW",44,0)
 K ^TMP("PSOAL",$J),PCOMX,PDA,PHI,PRC,ACOM,ANS
"RTN","PSORXVW",45,0)
 S (DA,RXN)=PSOVDA K PSOVDA S RX0=^PSRX(RXN,0),RX2=$G(^(2)),RX3=$G(^(3)),ST=+$G(^("STA")),RXOR=$G(^("OR1"))
"RTN","PSORXVW",46,0)
 I 'RXOR,$P(^PSDRUG($P(RX0,"^",6),2),"^") S $P(^PSRX(RXN,"OR1"),"^")=$P(^PSDRUG($P(RX0,"^",6),2),"^"),RXOR=$P(^PSDRUG($P(RX0,"^",6),2),"^")
"RTN","PSORXVW",47,0)
 S IEN=0,$P(RN," ",12)=" "
"RTN","PSORXVW",48,0)
 N APPND,ECME,TITR
"RTN","PSORXVW",49,0)
 S APPND=$S($G(^PSRX(RXN,"IB")):"$",1:"")
"RTN","PSORXVW",50,0)
 S ECME=$$ECME^PSOBPSUT(RXN)  ; Returns "" (non-ECME), or "e" (ECME)
"RTN","PSORXVW",51,0)
 S TITR=$$TITRX^PSOUTL(RXN)  ; Returns "" (non-Titration), "m" (Maintenance) or "t" (titration)
"RTN","PSORXVW",52,0)
 S APPND=APPND_ECME_TITR
"RTN","PSORXVW",53,0)
 I ECME'="" S APPND=APPND_"  (ECME#: "_$$ECMENUM^PSOBPSU2(RXN)_")"
"RTN","PSORXVW",54,0)
 I TITR'="" S APPND=APPND_"  ("_$S(TITR="t":"Titration",1:"Maintenance")_")"
"RTN","PSORXVW",55,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=$S($P($G(^PSRX(RXN,"TPB")),"^"):"            TPB Rx #: ",1:"                Rx #: ")_$P(RX0,"^")_APPND_$E(RN,$L($P(RX0,"^")_APPND)+1,12)
"RTN","PSORXVW",56,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="      Orderable Item: "_$S($D(^PS(50.7,$P(+RXOR,"^"),0)):$P(^PS(50.7,$P(+RXOR,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^"),1:"No Pharmacy Orderable Item")
"RTN","PSORXVW",57,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=$S($D(^PSDRUG("AQ",$P(RX0,"^",6))):"           CMOP ",1:"                ")_"Drug: "_$P(^PSDRUG($P(RX0,"^",6),0),"^")
"RTN","PSORXVW",58,0)
 S:$G(^PSRX(RXN,"TN"))]"" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="          Trade Name: "_$G(^PSRX(RXN,"TN"))
"RTN","PSORXVW",59,0)
 ; Always display the NDC# - PSO*7*427
"RTN","PSORXVW",60,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="                 NDC: "_$$GETNDC^PSONDCUT(RXN,0)
"RTN","PSORXVW",61,0)
 D DOSE^PSORXVW1
"RTN","PSORXVW",62,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Patient Instructions:" I $O(^PSRX(RXN,"INS1",0)) D
"RTN","PSORXVW",63,0)
 . F I=0:0 S I=$O(^PSRX(RXN,"INS1",I)) Q:'I  D
"RTN","PSORXVW",64,0)
 .. S MIG=^PSRX(RXN,"INS1",I,0)
"RTN","PSORXVW",65,0)
 .. D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAL",$J)),21)
"RTN","PSORXVW",66,0)
 K MIG,SG
"RTN","PSORXVW",67,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="  Other Pat. Instruc: "_$S($G(^PSRX(RXN,"INSS"))]"":^PSRX(RXN,"INSS"),1:"")
"RTN","PSORXVW",68,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="                 SIG:"
"RTN","PSORXVW",69,0)
 I '$P($G(^PSRX(RXN,"SIG")),"^",2) D  G PTST
"RTN","PSORXVW",70,0)
 . S X=$P($G(^PSRX(RXN,"SIG")),"^") D SIGONE^PSOHELP S SIG=$E($G(INS1),2,250)
"RTN","PSORXVW",71,0)
 . D WORDWRAP^PSOUTLA2(SIG,.IEN,$NA(^TMP("PSOAL",$J)),21)
"RTN","PSORXVW",72,0)
 S SIGOK=1
"RTN","PSORXVW",73,0)
 F I=0:0 S I=$O(^PSRX(RXN,"SIG1",I)) Q:'I  D
"RTN","PSORXVW",74,0)
 . S MIG=^PSRX(RXN,"SIG1",I,0)
"RTN","PSORXVW",75,0)
 . D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAL",$J)),21)
"RTN","PSORXVW",76,0)
 S SIGOK=1 K MIG,SG
"RTN","PSORXVW",77,0)
PTST S $P(RN," ",25)=" ",PTST=$S($G(^PS(53,+$P(RX0,"^",3),0))]"":$P($G(^PS(53,+$P(RX0,"^",3),0)),"^"),1:""),IEN=IEN+1
"RTN","PSORXVW",78,0)
 S ^TMP("PSOAL",$J,IEN,0)="      Patient Status: "_PTST_$E(RN,$L(PTST)+1,25)
"RTN","PSORXVW",79,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="          Issue Date: "_$E($P(RX0,"^",13),4,5)_"/"_$E($P(RX0,"^",13),6,7)_"/"_$E($P(RX0,"^",13),2,3)
"RTN","PSORXVW",80,0)
 S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"                 Fill Date: "_$E($P(RX2,"^",2),4,5)_"/"_$E($P(RX2,"^",2),6,7)_"/"_$E($P(RX2,"^",2),2,3)
"RTN","PSORXVW",81,0)
 S ROU=$S($P(RX0,"^",11)="W":"Window",1:"Mail")
"RTN","PSORXVW",82,0)
 S REFL=$P(RX0,"^",9),I=0 F  S I=$O(^PSRX(RXN,1,I)) Q:'I  S REFL=REFL-1,ROU=$S($P(^PSRX(RXN,1,I,0),"^",2)="W":"Window",1:"Mail")
"RTN","PSORXVW",83,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="      Last Fill Date: "_$E($P(RX3,"^"),4,5)_"/"_$E($P(RX3,"^"),6,7)_"/"_$E($P(RX3,"^"),2,3)
"RTN","PSORXVW",84,0)
 D CMOP^PSOORNE3 S DA=RXN
"RTN","PSORXVW",85,0)
 S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_" ("_ROU_$S($G(PSOCMOP)]"":", "_PSOCMOP,1:"")_")" K ROU,PSOCMOP
"RTN","PSORXVW",86,0)
 S IEN=IEN+1 I $P(RX2,"^",15) S ^TMP("PSOAL",$J,IEN,0)="   Returned to Stock: "_$E($P(RX2,"^",15),4,5)_"/"_$E($P(RX2,"^",15),6,7)_"/"_$E($P(RX2,"^",15),2,3)
"RTN","PSORXVW",87,0)
 E  S ^TMP("PSOAL",$J,IEN,0)="   Last Release Date: " D
"RTN","PSORXVW",88,0)
 .S RLD=$S($P(RX2,"^",13):$E($P(RX2,"^",13),4,5)_"/"_$E($P(RX2,"^",13),6,7)_"/"_$E($P(RX2,"^",13),2,3),1:"")
"RTN","PSORXVW",89,0)
 .I $O(^PSRX(RXN,1,0)) F I=0:0 S I=$O(^PSRX(RXN,1,I)) Q:'I  D
"RTN","PSORXVW",90,0)
 ..I $P(^PSRX(RXN,1,I,0),"^",18) S RLD=$E($P(^(0),"^",18),4,5)_"/"_$E($P(^(0),"^",18),6,7)_"/"_$E($P(^(0),"^",18),2,3)
"RTN","PSORXVW",91,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_$S($G(RLD)]"":RLD,1:"        ")
"RTN","PSORXVW",92,0)
 S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"                     Lot #: "_$P(RX2,"^",4)
"RTN","PSORXVW",93,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="             Expires: "_$E($P(RX2,"^",6),4,5)_"/"_$E($P(RX2,"^",6),6,7)_"/"_$E($P(RX2,"^",6),2,3)
"RTN","PSORXVW",94,0)
 S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"                       MFG: "_$P($G(RX2),"^",8)
"RTN","PSORXVW",95,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="         Days Supply: "_$P(RX0,"^",8)_$S($L($P(RX0,"^",8))=1:" ",1:"")
"RTN","PSORXVW",96,0)
 S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"                        QTY"_$S($P($G(^PSDRUG($P(RX0,"^",6),660)),"^",8)]"":" ("_$P($G(^PSDRUG($P(RX0,"^",6),660)),"^",8)_")",1:" (  )")_": "_$P(RX0,"^",7)
"RTN","PSORXVW",97,0)
 I $P($G(^PSDRUG($P(RX0,"^",6),5)),"^")]"" D
"RTN","PSORXVW",98,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSORXVW",99,0)
 .S ^TMP("PSOAL",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG($P(RX0,"^",6),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG($P(RX0,"^",6),5),"^") K RN
"RTN","PSORXVW",100,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="        # of Refills: "_$P(RX0,"^",9)_$S($L($P(RX0,"^",9))=1:" ",1:"")_"                       Remaining: "_REFL
"RTN","PSORXVW",101,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="            Provider: "_$S($D(^VA(200,$P(RX0,"^",4),0)):$P(^VA(200,$P(RX0,"^",4),0),"^"),1:"UNKNOWN")
"RTN","PSORXVW",102,0)
 N DEAV S DEAV=+$P($G(^PSDRUG(+$P(RX0,"^",6),0)),"^",3) I DEAV>1,DEAV<6 D PRV K DEAV
"RTN","PSORXVW",103,0)
 I $P(RX3,"^",3) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="        Cos-Provider: "_$P(^VA(200,$P(RX3,"^",3),0),"^")
"RTN","PSORXVW",104,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="             Routing: "_$S($P(RX0,"^",11)="W":"Window",1:"Mail")
"RTN","PSORXVW",105,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="              Copies: "_$S($P(RX0,"^",18):$P(RX0,"^",18),1:1)
"RTN","PSORXVW",106,0)
 S:$P(RX0,"^",11)="W" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="    Method of Pickup: "_$G(^PSRX(RXN,"MP"))
"RTN","PSORXVW",107,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="              Clinic: "_$S($D(^SC(+$P(RX0,"^",5),0)):$P(^SC($P(RX0,"^",5),0),"^"),1:"Not on File")
"RTN","PSORXVW",108,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="            Division: "_$P(^PS(59,$P(RX2,"^",9),0),"^")_" ("_$P(^(0),"^",6)_")"
"RTN","PSORXVW",109,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="          Pharmacist: "_$S($P(RX2,"^",3):$P(^VA(200,$P(RX2,"^",3),0),"^"),1:"")
"RTN","PSORXVW",110,0)
 S:$P(RX2,"^",10)&('$G(PSOCOPY)) IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="         Verified By: "_$P(^VA(200,$P(RX2,"^",10),0),"^")
"RTN","PSORXVW",111,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="  Patient Counseling: "_$S($P($G(^PSRX(RXN,"PC")),"^"):"YES",1:"NO")_"                      "_$S($P($G(^PSRX(RXN,"PC")),"^"):"Was Counseling Understood: "_$S($P($G(^PSRX(RXN,"PC")),"^",2):"YES",1:"NO"),1:"")
"RTN","PSORXVW",112,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="             Remarks: "_$P(RX3,"^",7)
"RTN","PSORXVW",113,0)
 D PC^PSORXVW1
"RTN","PSORXVW",114,0)
 I $P($G(^PSRX(DA,"OR1")),"^",5) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="         Finished By: "_$P(^VA(200,$P(^PSRX(DA,"OR1"),"^",5),0),"^")
"RTN","PSORXVW",115,0)
 D ^PSORXVW1 S PSOAL=IEN K IEN,ACT,LBL,LOG
"RTN","PSORXVW",116,0)
 I ST<12,$P(RX2,"^",6)<DT S ST=11
"RTN","PSORXVW",117,0)
 S VALM("TITLE")="Rx View "_"("_$P("Error^Active^Non-Verified^Refill^Hold^Non-Verified^Suspended^^^^^Done^Expired^Discontinued^Deleted^Discontinued^Discontinued (Edit)^Provider Hold^","^",ST+2)_")"
"RTN","PSORXVW",118,0)
 S:$P($G(^PSRX(DA,"PKI")),"^") VALMSG="Digitally Signed Order"
"RTN","PSORXVW",119,0)
 ;
"RTN","PSORXVW",120,0)
 ; pso*7*385 - esg - if being called by the BPSVRX routine, call HDR^PSOLMUTL to build the VALMHDR array and then Quit
"RTN","PSORXVW",121,0)
 I $G(BPSVRX) D HDR^PSOLMUTL Q
"RTN","PSORXVW",122,0)
 ;
"RTN","PSORXVW",123,0)
 D EN^PSOORAL,KILL I $G(PS)="VIEW" G PSORXVW
"RTN","PSORXVW",124,0)
 K:$G(PS)="VIEW" DA K PS
"RTN","PSORXVW",125,0)
 Q
"RTN","PSORXVW",126,0)
 ;
"RTN","PSORXVW",127,0)
KILL K ^TMP("PSOAL",$J),PSOAL,IEN,^TMP("PSOHDR",$J) I $G(PS)="VIEW" K DA
"RTN","PSORXVW",128,0)
 K ST,RFL,RFLL,RFL1,ST,II,J,N,PHYS,L1,DIRUT,PSDIV,PSEXDT,MED,M1,FFX,DTT,DAT,RX0,RX2,R3,RTN,SIG,STA,P1,PL,P0,Z0,Z1,EXDT,IFN,DIR,DUOUT,DTOUT,PSOELSE
"RTN","PSORXVW",129,0)
 K LBL,I,RFDATE,%H,%I,RN,RFT,%,%I,DFN,GMRA,GMRAL,HDR,POERR,PTST,REFL,RF,RLD,RX3
"RTN","PSORXVW",130,0)
 K RXN,RXOR,SG,VA,VADM,VAERR,VALMBCK,VAPA,X,DIC,REA,ZD,PSOHD,PSOBCK,PSODFN,QUIT
"RTN","PSORXVW",131,0)
 Q
"RTN","PSORXVW",132,0)
 ;
"RTN","PSORXVW",133,0)
PRV       ;
"RTN","PSORXVW",134,0)
 N DETN,DEA,LBL,VADD,SPC,ORN S ORN=$P(^PSRX(RXN,"OR1"),"^",2)
"RTN","PSORXVW",135,0)
 S DEA=$$RXDEA^PSOUTIL(RXN)
"RTN","PSORXVW",136,0)
 S LBL=$S(DEA["-":"  VA#: ",1:" DEA#: ")
"RTN","PSORXVW",137,0)
 S $P(SPC," ",(28-$L(DEA)))=" "
"RTN","PSORXVW",138,0)
 I $$DETOX^PSSOPKI($P(RX0,"^",6)) S DETN=$$RXDETOX^PSOUTIL(RXN)
"RTN","PSORXVW",139,0)
 I (DEA'="")!($G(DETN)'="") S IEN=IEN+1,$E(^TMP("PSOAL",$J,IEN,0),16)=LBL_DEA_$S($G(DETN)]"":SPC_"DETOX#: "_$G(DETN),1:"")
"RTN","PSORXVW",140,0)
 D PRVAD^PSOPKIV2
"RTN","PSORXVW",141,0)
 I $G(VADD(1))]"" D
"RTN","PSORXVW",142,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="        Site Address: "_VADD(1)
"RTN","PSORXVW",143,0)
 .S:VADD(2)]"" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="                      "_VADD(2) S:VADD(3)]"" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="                      "_VADD(3)
"RTN","PSORXVW",144,0)
 Q
"RTN","PSORXVW",145,0)
 ;
"RTN","PSOUTIL")
0^2^B145871756^B95814120
"RTN","PSOUTIL",1,0)
PSOUTIL ;IHS/DSD/JCM - outpatient pharmacy utility routine ;12/28/15 4:01pm
"RTN","PSOUTIL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**64,456,444,469,504**;DEC 1997;Build 15
"RTN","PSOUTIL",3,0)
 ;External reference $$MXDAYSUP^PSSUTIL1 supported by DBIA 6229
"RTN","PSOUTIL",4,0)
 ;External reference to ^ORDEA is supported by DBIA 5709
"RTN","PSOUTIL",5,0)
 ;
"RTN","PSOUTIL",6,0)
 Q
"RTN","PSOUTIL",7,0)
 ;
"RTN","PSOUTIL",8,0)
NPSOSD(PSORX) ; Entry point to add newly added rx to patients PSOSD array
"RTN","PSOUTIL",9,0)
 S STA="ACTIVE^NON-VERIFIED^R^HOLD^NON-VERIFIED^ACTIVE^^^^^^ACTIVE^DISCONTINUE^^DISCONTINUE^DISCONTINUE^HOLD"
"RTN","PSOUTIL",10,0)
 S STAT=$P(STA,"^",$P(^PSRX(PSORX("IRXN"),"STA"),"^")+1)
"RTN","PSOUTIL",11,0)
 I $D(PSOSD(STAT,PSODRUG("NAME"))),$P(PSOSD(STAT,PSODRUG("NAME")),"^",2)<10 D
"RTN","PSOUTIL",12,0)
 . S PSOSD(STAT,PSODRUG("NAME")_"^"_PSORX("IRXN"))=PSORX("IRXN")_"^"_$P($G(^PSRX(PSORX("IRXN"),"STA")),"^")_"^^^"_PSODRUG("VA CLASS")_"^"_$P(^PSRX(PSORX("IRXN"),0),"^",9)_"^"_PSODRUG("NDF")_"^"_$P(^PSRX(PSORX("IRXN"),0),"^",8)_"^1"
"RTN","PSOUTIL",13,0)
 E  S PSOSD(STAT,PSODRUG("NAME"))=PSORX("IRXN")_"^"_$P($G(^PSRX(PSORX("IRXN"),"STA")),"^")_"^^^"_PSODRUG("VA CLASS")_"^"_$P(^PSRX(PSORX("IRXN"),0),"^",9)_"^"_PSODRUG("NDF")_"^"_$P(^PSRX(PSORX("IRXN"),0),"^",8)_"^1"
"RTN","PSOUTIL",14,0)
 S PSOSD=$S($G(PSOSD)]"":PSOSD+1,1:1),^TMP("PS",$J,STAT,PSODRUG("NAME"))=1
"RTN","PSOUTIL",15,0)
 Q
"RTN","PSOUTIL",16,0)
 ;
"RTN","PSOUTIL",17,0)
RNPSOSD ;update PSOSD array for renewals
"RTN","PSOUTIL",18,0)
 S STA="ACTIVE^NON-VERIFIED^R^HOLD^NON-VERIFIED^ACTIVE^^^^^^ACTIVE^DISCONTINUE^^DISCONTINUE^DISCONTINUE^HOLD"
"RTN","PSOUTIL",19,0)
 S STAT=$P(STA,"^",$P(^PSRX(PSORENW("OIRXN"),"STA"),"^")+1)
"RTN","PSOUTIL",20,0)
 I $D(PSOSD(STAT,PSODRUG("NAME")_"^"_PSORENW("OIRXN"))) D
"RTN","PSOUTIL",21,0)
 . S PSOSD(STAT,PSODRUG("NAME")_"^"_PSORENW("IRXN"))=PSOSD(STAT,PSODRUG("NAME")_"^"_PSORENW("OIRXN")),$P(PSOSD(STAT,PSODRUG("NAME")_"^"_PSORENW("IRXN")),"^",2)=$P($G(^PSRX(PSORENW("IRXN"),"STA")),"^")
"RTN","PSOUTIL",22,0)
 . S $P(PSOSD(STAT,PSODRUG("NAME")_"^"_PSORENW("IRXN")),"^",6)=$P(^PSRX(PSORENW("IRXN"),0),"^",9)
"RTN","PSOUTIL",23,0)
 . K PSOSD(STAT,PSODRUG("NAME")_"^"_PSORENW("OIRXN")) Q
"RTN","PSOUTIL",24,0)
 E  D
"RTN","PSOUTIL",25,0)
 .S $P(PSOSD(STAT,PSODRUG("NAME")),"^")=PSORENW("IRXN"),$P(PSOSD(STAT,PSODRUG("NAME")),"^",2)=$P($G(^PSRX(PSORENW("IRXN"),"STA")),"^")
"RTN","PSOUTIL",26,0)
 .S $P(PSOSD(STAT,PSODRUG("NAME")),"^",6)=$P(^PSRX(PSORENW("IRXN"),0),"^",9)
"RTN","PSOUTIL",27,0)
 .S ^TMP("PS",$J,STAT,PSODRUG("NAME"))=1
"RTN","PSOUTIL",28,0)
 Q
"RTN","PSOUTIL",29,0)
 ;
"RTN","PSOUTIL",30,0)
PROV(PSORENW) ;called from psoornew
"RTN","PSOUTIL",31,0)
CHKPRV ;check inactive providers and cosinging providers called from PSORENW (renew rx)
"RTN","PSOUTIL",32,0)
 N OK
"RTN","PSOUTIL",33,0)
 I '$D(^VA(200,PSORENW("PROVIDER"),0)) D  I 'OK G:PSORENW("DFLG") CHKPRVX
"RTN","PSOUTIL",34,0)
 .W !,$C(7),"Provider not in New Person File .. You must select a new provider"
"RTN","PSOUTIL",35,0)
 .S PSODIR("FIELD")=0 K PSORENW("PROVIDER") D PROV^PSODIR(.PSORENW)
"RTN","PSOUTIL",36,0)
 .S:$G(PSORENW("PROVIDER"))']"" PSORENW("DFLG")=1
"RTN","PSOUTIL",37,0)
 ;
"RTN","PSOUTIL",38,0)
 I '$G(^VA(200,PSORENW("PROVIDER"),"PS")) D   G:PSORENW("DFLG") CHKPRVX
"RTN","PSOUTIL",39,0)
 .I $$ISSPLY(),$D(^XUSEC("ORSUPPLY",PSORENW("PROVIDER"))) S OK=1 Q
"RTN","PSOUTIL",40,0)
 .S OK=0 W !,$C(7),$P(^VA(200,PSORENW("PROVIDER"),0),"^")_" is not a Valid provider .. You must select a new provider"
"RTN","PSOUTIL",41,0)
 .S PSODIR("FIELD")=0 K PSORENW("PROVIDER") D PROV^PSODIR(.PSORENW)
"RTN","PSOUTIL",42,0)
 .S:$G(PSORENW("PROVIDER"))']"" PSORENW("DFLG")=1
"RTN","PSOUTIL",43,0)
 ;
"RTN","PSOUTIL",44,0)
 K PSOX S PSOX=$P($G(^VA(200,PSORENW("PROVIDER"),"PS")),"^",4)
"RTN","PSOUTIL",45,0)
 I PSOX,PSOX<DT D   G:PSORENW("DFLG") CHKPRVX
"RTN","PSOUTIL",46,0)
 .W !,$C(7),$P(^VA(200,PSORENW("PROVIDER"),0),"^")_" is inactive as a provider .. You must select a new provider"
"RTN","PSOUTIL",47,0)
 .S PSODIR("FIELD")=0 K PSORENW("PROVIDER") D PROV^PSODIR(.PSORENW)
"RTN","PSOUTIL",48,0)
 .I $G(PSORENW("PROVIDER"))']"" S PSORENW("DFLG")=1
"RTN","PSOUTIL",49,0)
 ;
"RTN","PSOUTIL",50,0)
 I '$D(PSORENW("COSIGNING PROVIDER")),$D(PSORENW("COSIGNER")) K PSOX S PSOX=$P(^VA(200,PSORENW("COSIGNER"),"PS"),"^",4) I PSOX,PSOX<DT D
"RTN","PSOUTIL",51,0)
 .W !,$C(7),"Inactive Cosigning Provider .. You must select a new cosigner"
"RTN","PSOUTIL",52,0)
 .S PSODIR("FIELD")=0,PSODIR("PROVIDER")=$S($D(PSORENW("PROVIDER")):PSORENW("PROVIDER"),1:PSORENW("PROVIDER"))
"RTN","PSOUTIL",53,0)
 .D COSIGN^PSODIR I '$D(PSODIR("COSIGNING PROVIDER")) S PSORENW("DFLG")=1
"RTN","PSOUTIL",54,0)
 .S PSORENW("COSIGNING PROVIDER")=PSODIR("COSIGNING PROVIDER")
"RTN","PSOUTIL",55,0)
 ;
"RTN","PSOUTIL",56,0)
CHKPRVX K PSODIR,PSOX
"RTN","PSOUTIL",57,0)
 Q
"RTN","PSOUTIL",58,0)
 ;
"RTN","PSOUTIL",59,0)
NEXT(PSOX) ;
"RTN","PSOUTIL",60,0)
 S PSOX("RX0")=^PSRX(PSOX("IRXN"),0)
"RTN","PSOUTIL",61,0)
 S PSOX("RX2")=^PSRX(PSOX("IRXN"),2)
"RTN","PSOUTIL",62,0)
 S PSOX("RX3")=^PSRX(PSOX("IRXN"),3)
"RTN","PSOUTIL",63,0)
 S PSOX1=$P(PSOX("RX2"),"^",2)
"RTN","PSOUTIL",64,0)
 I '$O(^PSRX(PSOX("IRXN"),1,0)) D  G NEXTX
"RTN","PSOUTIL",65,0)
 . S $P(PSOX("RX3"),"^")=PSOX1,X1=PSOX1
"RTN","PSOUTIL",66,0)
 . S X2=$P(PSOX("RX0"),"^",8)-10\1
"RTN","PSOUTIL",67,0)
 . D C^%DTC
"RTN","PSOUTIL",68,0)
 . S:'$P(PSOX("RX3"),"^",8) $P(PSOX("RX3"),"^",2)=X
"RTN","PSOUTIL",69,0)
 . K X Q
"RTN","PSOUTIL",70,0)
 ;
"RTN","PSOUTIL",71,0)
 S PSOY2=0
"RTN","PSOUTIL",72,0)
 F PSOY=0:0 S PSOY=$O(^PSRX(PSOX("IRXN"),1,PSOY)) Q:'PSOY  S PSOY1=PSOY,PSOY2=PSOY2+1
"RTN","PSOUTIL",73,0)
 S PSOY=^PSRX(PSOX("IRXN"),1,PSOY1,0)
"RTN","PSOUTIL",74,0)
 S PSOX2=$P(PSOY,"^")
"RTN","PSOUTIL",75,0)
 S $P(PSOX("RX3"),"^")=PSOX2,X1=PSOX2
"RTN","PSOUTIL",76,0)
 S X2=$P(PSOX("RX0"),"^",8)-10\1
"RTN","PSOUTIL",77,0)
 D C^%DTC S PSOY3=X
"RTN","PSOUTIL",78,0)
 S X1=PSOX1,X2=(PSOY2+1)*$P(PSOX("RX0"),"^",8)-10\1
"RTN","PSOUTIL",79,0)
 D C^%DTC S PSOY4=X
"RTN","PSOUTIL",80,0)
 S $P(PSOX("RX3"),"^",2)=$S(PSOY3<PSOY4:PSOY4,1:PSOY3)
"RTN","PSOUTIL",81,0)
NEXTX ;
"RTN","PSOUTIL",82,0)
 K X,PSOX1,PSOX2,PSOY,PSOY1,PSOY2,PSOY3,PSOY4
"RTN","PSOUTIL",83,0)
 Q
"RTN","PSOUTIL",84,0)
 ;
"RTN","PSOUTIL",85,0)
SUSDATE(PSOX) ;
"RTN","PSOUTIL",86,0)
 S PSOX("OLD FILL DATE")=PSOX("FILL DATE")
"RTN","PSOUTIL",87,0)
 S PSORX("OLD FILL DATE")=PSORX("FILL DATE")
"RTN","PSOUTIL",88,0)
 S PSOX("FILL DATE")=$P(PSOX("RX3"),"^",2)
"RTN","PSOUTIL",89,0)
 I $O(^PS(52.5,"B",PSOX("IRXN"),0)),'$G(^PS(52.5,+$O(^PS(52.5,"B",PSOX("IRXN"),0)),"P")) S PSOX("FILL DATE")=$P(PSOX("RX3"),"^")
"RTN","PSOUTIL",90,0)
 S Y=PSOX("FILL DATE")
"RTN","PSOUTIL",91,0)
 X ^DD("DD") S PSORX("FILL DATE")=Y K Y
"RTN","PSOUTIL",92,0)
 Q
"RTN","PSOUTIL",93,0)
 ;
"RTN","PSOUTIL",94,0)
SUSDATEK(PSOX) ;
"RTN","PSOUTIL",95,0)
 S PSOX("FILL DATE")=PSOX("OLD FILL DATE")
"RTN","PSOUTIL",96,0)
 I $G(PSORX("OLD FILL DATE"))="",$G(PSORENW("OLD FILL DATE")) S Y=PSORENW("OLD FILL DATE") D DD^%DT S PSORX("OLD FILL DATE")=Y K Y
"RTN","PSOUTIL",97,0)
 S PSORX("FILL DATE")=PSORX("OLD FILL DATE")
"RTN","PSOUTIL",98,0)
 K PSOX("OLD FILL DATE"),PSORX("OLD FILL DATE")
"RTN","PSOUTIL",99,0)
 Q
"RTN","PSOUTIL",100,0)
 ;
"RTN","PSOUTIL",101,0)
STATUS(PSOREA,PSOSTAT) ;
"RTN","PSOUTIL",102,0)
 S DSMSG="Cannot "_$S($G(PSOOPT)=3:"renew",1:"refill")_" Rx. " S:$G(OR0) ACOM=DSMSG
"RTN","PSOUTIL",103,0)
 I PSOREA["A" W:$G(SPEED) ", Inactive Drug.",! D
"RTN","PSOUTIL",104,0)
 .S:$G(POERR)&('$G(SPEED)) VALMSG=DSMSG_"Inactive Drug.",VALMBCK="R" W:'$G(POERR) !," Inactive Drug"
"RTN","PSOUTIL",105,0)
 .S:$G(OR0) ACOM=ACOM_" Inactive Drug."
"RTN","PSOUTIL",106,0)
 I PSOREA["M" W:$G(SPEED) ", Drug no longer used by Outpatient.",! D
"RTN","PSOUTIL",107,0)
 .S:$G(POERR)&('$G(SPEED)) VALMSG=DSMSG_"Drug no longer used by Outpatient.",VALMBCK="R" W:'$G(POERR) !," Drug no longer used by Outpatient."
"RTN","PSOUTIL",108,0)
 .S:$G(OR0) ACOM=ACOM_" Drug no longer used by Outpatient."
"RTN","PSOUTIL",109,0)
 ;
"RTN","PSOUTIL",110,0)
 I PSOREA["B" W:$G(SPEED) ", Narcotic Drug." D
"RTN","PSOUTIL",111,0)
 .W:'$G(POERR) !,"Narcotic Drug" S:$G(POERR)&('$G(SPEED)) VALMSG=DSMSG_"Narcotic Drug.",VALMBCK="R"
"RTN","PSOUTIL",112,0)
 .S:$G(OR0) ACOM=ACOM_" Narcotic Drug."
"RTN","PSOUTIL",113,0)
 ;
"RTN","PSOUTIL",114,0)
 I PSOREA["C" W:$G(SPEED) ", Non-Renewable Drug." D
"RTN","PSOUTIL",115,0)
 .W:'$G(POERR) !,"Non-Renewable Drug" S:$G(POERR)&('$G(SPEED)) VALMSG=DSMSG_"Non-Renewable Drug.",VALMBCK="R"
"RTN","PSOUTIL",116,0)
 .S:$G(OR0) ACOM=ACOM_" Non-Renewable Drug."
"RTN","PSOUTIL",117,0)
 ;
"RTN","PSOUTIL",118,0)
 I PSOREA["D" W:$G(SPEED) ", Non-Renewable Patient Status." D
"RTN","PSOUTIL",119,0)
 .W:'$G(POERR) !,"Non-Renewable Patient Status" S:$G(POERR)&('$G(SPEED)) VALMSG=DSMSG_"Non-Renewable Patient Status.",VALMBCK="R"
"RTN","PSOUTIL",120,0)
 .S:$G(OR0) ACOM=ACOM_" Non-Renewable Patient Status."
"RTN","PSOUTIL",121,0)
 ;
"RTN","PSOUTIL",122,0)
 I PSOREA["E" W:$G(SPEED) ", Non-Verified Rx." D
"RTN","PSOUTIL",123,0)
 .W:'$G(POERR) !,"Non-Verified Rx" S:$G(POERR)&('$G(SPEED)) VALMSG=DSMSG_"Non-Verified Rx.",VALMBCK="R"
"RTN","PSOUTIL",124,0)
 .S:$G(OR0) ACOM=ACOM_" Non-Verified Rx."
"RTN","PSOUTIL",125,0)
 ;
"RTN","PSOUTIL",126,0)
 I PSOREA["F" W:$G(SPEED) ", Maximum of 26 Renewals." D
"RTN","PSOUTIL",127,0)
 .W:'$G(POERR) !,"Maximum of 26 Renewals" S:$G(POERR)&('$G(SPEED)) VALMSG=DSMSG_"Maximum of 26 Renewals.",VALMBCK="R"
"RTN","PSOUTIL",128,0)
 .S:$G(OR0) ACOM=ACOM_" Maximum of 26 Renewals."
"RTN","PSOUTIL",129,0)
 ;
"RTN","PSOUTIL",130,0)
 I PSOREA["G",PSOREA'["B" W:$G(SPEED) ", No more refills left." W:'$G(POERR) !,"No more refills left" S:$G(POERR)&('$G(SPEED)) VALMSG=DSMSG_"No more refills left.",VALMBCK="R"
"RTN","PSOUTIL",131,0)
 ;
"RTN","PSOUTIL",132,0)
 I PSOREA["Z" D
"RTN","PSOUTIL",133,0)
 . S:PSOSTAT=4 PSOSTAT=1
"RTN","PSOUTIL",134,0)
 . S PSOA=";"_PSOSTAT,PSOB=$P(^DD(52,100,0),"^",3),PSOA=$F(PSOB,PSOA),PSOA=$P($E(PSOB,PSOA,999),";",1)
"RTN","PSOUTIL",135,0)
 . W:$G(SPEED) ", Rx is in "_$P(PSOA,":",2)_" status."
"RTN","PSOUTIL",136,0)
 . W:'$G(POERR)&('$G(SPEED)) !,"Rx is in "_$P(PSOA,":",2)_" status"
"RTN","PSOUTIL",137,0)
 .S:$G(POERR)&($G(VALMSG)']"")&('$G(SPEED)) VALMSG=DSMSG_"Rx is in "_$P(PSOA,":",2)_" status.",VALMBCK="R"
"RTN","PSOUTIL",138,0)
 . K PSOA,PSOB
"RTN","PSOUTIL",139,0)
 . Q
"RTN","PSOUTIL",140,0)
 I $G(SPEED) K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIRUT,DUOUT,DTOUT,DIR
"RTN","PSOUTIL",141,0)
 Q
"RTN","PSOUTIL",142,0)
ACP I $P(^PSRX(PSOX("IRXN"),0),"^",11)="W",$G(^("IB")) S ^PSRX("ACP",$P(^PSRX(PSOX("IRXN"),0),"^",2),$P(^(2),"^",2),0,PSOX("IRXN"))=""
"RTN","PSOUTIL",143,0)
 Q
"RTN","PSOUTIL",144,0)
 ;
"RTN","PSOUTIL",145,0)
RENFDT(PSOX) ;gets the correct fill date
"RTN","PSOUTIL",146,0)
 S PSOX("OLD FILL DATE")=PSOX("FILL DATE")
"RTN","PSOUTIL",147,0)
 S PSORX("OLD FILL DATE")=PSORX("FILL DATE")
"RTN","PSOUTIL",148,0)
 S PSOX("FILL DATE")=$P(PSOX("RX3"),"^",2)
"RTN","PSOUTIL",149,0)
 N RXY,LBL,SUPN,LBP,RF,RFN,RFD
"RTN","PSOUTIL",150,0)
 S RXY=PSOX("IRXN"),RFN=0
"RTN","PSOUTIL",151,0)
 I '$O(^PSRX(RXY,1,0)) D GFDT G SDTX
"RTN","PSOUTIL",152,0)
 F RF=0:0 S RF=$O(^PSRX(RXY,1,RF)) Q:'RF  S RFN=RF
"RTN","PSOUTIL",153,0)
 S RF=^PSRX(RXY,1,RFN,0) D GFDT
"RTN","PSOUTIL",154,0)
 I PSOX("FILL DATE")<DT,PSOX("FILL DATE")<PSORNW("FILL DATE") S PSOX("FILL DATE")=DT
"RTN","PSOUTIL",155,0)
SDTX ;
"RTN","PSOUTIL",156,0)
 S Y=PSOX("FILL DATE")
"RTN","PSOUTIL",157,0)
 X ^DD("DD") S PSORX("FILL DATE")=Y K Y
"RTN","PSOUTIL",158,0)
 Q
"RTN","PSOUTIL",159,0)
GFDT ;
"RTN","PSOUTIL",160,0)
 I 'RFN,$P(^PSRX(RXY,2),"^",13) Q
"RTN","PSOUTIL",161,0)
 I RFN,$P(RF,"^",18) Q
"RTN","PSOUTIL",162,0)
 F LBL=0:0 S LBL=$O(^PSRX(RXY,"L",LBL)) Q:'LBL  I $P(^PSRX(RXY,"L",LBL,0),"^",2)=RFN S LBP=1 Q
"RTN","PSOUTIL",163,0)
 Q:$G(LBP)
"RTN","PSOUTIL",164,0)
 S SUPN=$O(^PS(52.5,"B",RXY,0))
"RTN","PSOUTIL",165,0)
 I SUPN,$P($G(^PS(52.5,SUPN,0)),"^",7)="L"!($P($G(^(0)),"^",7)="X") Q
"RTN","PSOUTIL",166,0)
 S:RFN RFD=$E($P(RF,"^"),1,7) S:'RFN RFD=$P(PSOX("RX3"),"^")
"RTN","PSOUTIL",167,0)
 I SUPN,RFD,$D(^PS(52.5,"C",RFD,SUPN)),$G(^PS(52.5,SUPN,"P"))=1 Q
"RTN","PSOUTIL",168,0)
 S PSOX("FILL DATE")=$P(PSOX("RX3"),"^")
"RTN","PSOUTIL",169,0)
 Q
"RTN","PSOUTIL",170,0)
 ;
"RTN","PSOUTIL",171,0)
ISSPLY() ;is the drug a supply item
"RTN","PSOUTIL",172,0)
 ;assumes the existence of the PSODRUG array
"RTN","PSOUTIL",173,0)
 I $G(PSODRUG("DEA"))="" Q 0
"RTN","PSOUTIL",174,0)
 I $G(PSODRUG("VA CLASS"))="" Q 0
"RTN","PSOUTIL",175,0)
 I PSODRUG("VA CLASS")?1"XA".E!(PSODRUG("VA CLASS")?1"XX".E)!(PSODRUG("VA CLASS")="DX900"&(PSODRUG("DEA")["S")) Q 1
"RTN","PSOUTIL",176,0)
 Q 0
"RTN","PSOUTIL",177,0)
 ;
"RTN","PSOUTIL",178,0)
DAYSUP(DRUG,RXARR,RCLQTY) ; Adjusts DAYS SUPPLY and QUANTITY based on the maximum allowed
"RTN","PSOUTIL",179,0)
 ; Input: DRUG   - DRUG file (#50) IEN
"RTN","PSOUTIL",180,0)
 ;        RXARR  - Array containing prescription information
"RTN","PSOUTIL",181,0)
 ;        RVWQTY - Re-calculate Quantity (1: YES / 0: NO) 
"RTN","PSOUTIL",182,0)
 ;Output: RXARR  - Array with "DAYS SUPPLY" and "QTY" values modified
"RTN","PSOUTIL",183,0)
 ;
"RTN","PSOUTIL",184,0)
 ; - Invalid Dispense Drug
"RTN","PSOUTIL",185,0)
 I '$D(^PSDRUG(+$G(DRUG),0))!'$D(RXARR) Q
"RTN","PSOUTIL",186,0)
 N MXDAYSUP,RXDAYSUP,RXQTY,NEWQTY
"RTN","PSOUTIL",187,0)
 S MXDAYSUP=$$MXDAYSUP^PSSUTIL1(DRUG)
"RTN","PSOUTIL",188,0)
 S RXDAYSUP=+$G(RXARR("DAYS SUPPLY"))
"RTN","PSOUTIL",189,0)
 I RXDAYSUP>MXDAYSUP D
"RTN","PSOUTIL",190,0)
 . W !!,"The current DAYS SUPPLY value (",RXDAYSUP,") exceeds the Maximum allowed"
"RTN","PSOUTIL",191,0)
 . W !,"for ",$$GET1^DIQ(50,DRUG,.01)," (",MXDAYSUP,") and will be reset.",$C(7)
"RTN","PSOUTIL",192,0)
 . S RXARR("DAYS SUPPLY")=MXDAYSUP
"RTN","PSOUTIL",193,0)
 . S RXQTY=+$G(RXARR("QTY"))
"RTN","PSOUTIL",194,0)
 . I $G(RCLQTY),RXQTY,RCLQTY'=RXQTY D
"RTN","PSOUTIL",195,0)
 . . S NEWQTY=((RXQTY*MXDAYSUP)/RXDAYSUP)+.5\1
"RTN","PSOUTIL",196,0)
 . . W !!,"The Quantity was changed from ",RXQTY," to ",NEWQTY,"."
"RTN","PSOUTIL",197,0)
 . . S RXARR("QTY")=NEWQTY
"RTN","PSOUTIL",198,0)
 . W !!,"Please, review the modified order before accepting it."
"RTN","PSOUTIL",199,0)
 . W ! N DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR
"RTN","PSOUTIL",200,0)
 Q
"RTN","PSOUTIL",201,0)
 ;
"RTN","PSOUTIL",202,0)
MAXNUMRF(DRUG,DAYSUP,PTST,CLOZPAT) ; Returns the Maximum Number of Refills Allowed
"RTN","PSOUTIL",203,0)
 ; Input: DRUG     - DRUG file (#50) IEN
"RTN","PSOUTIL",204,0)
 ;        DAYSUP   - Number of DAYS SUPPLY per fill
"RTN","PSOUTIL",205,0)
 ;        PTST     - RX PATIENT STATUES (#53) IEN
"RTN","PSOUTIL",206,0)
 ;        CLOZPAT  - Clozapine Indicator Variable (used throughout PSO)
"RTN","PSOUTIL",207,0)
 ;Output: MAXNUMRF - Maximum Number of Refills
"RTN","PSOUTIL",208,0)
 ;
"RTN","PSOUTIL",209,0)
 N MAXNUMRF,DEAHDLG,CSDRUG,MAXPTST
"RTN","PSOUTIL",210,0)
 ; - Invalid Drug or DAYS SUPPLY value
"RTN","PSOUTIL",211,0)
 I '$D(^PSDRUG(+$G(DRUG),0)),'$G(DAYSUP) Q 0
"RTN","PSOUTIL",212,0)
 ;
"RTN","PSOUTIL",213,0)
 ; - Calculating Maximum for Clozapine Drug
"RTN","PSOUTIL",214,0)
 I $D(CLOZPAT) Q $S(CLOZPAT=2&(DAYSUP=14):1,CLOZPAT=2&(DAYSUP=7):3,CLOZPAT=1&(DAYSUP=7):1,1:0)
"RTN","PSOUTIL",215,0)
 ;
"RTN","PSOUTIL",216,0)
 ; - Non-Refillable Drugs based on DEA SPECIAL HDLG field
"RTN","PSOUTIL",217,0)
 S DEAHDLG=""
"RTN","PSOUTIL",218,0)
 I $G(DRUG) S DEAHDLG=$$GET1^DIQ(50,DRUG,3) I DEAHDLG["A"&(DEAHDLG'["B")!(DEAHDLG["F")!(DEAHDLG[1)!(DEAHDLG[2) Q 0
"RTN","PSOUTIL",219,0)
 S CSDRUG=0 I (DEAHDLG[3)!(DEAHDLG[4)!(DEAHDLG[5) S CSDRUG=1
"RTN","PSOUTIL",220,0)
 ;
"RTN","PSOUTIL",221,0)
 ; - The Maximum Number of Refills Calculation is different for up to 90 Days Supply Vs. Above 90 Days Supply
"RTN","PSOUTIL",222,0)
 I $G(CSDRUG) D
"RTN","PSOUTIL",223,0)
 . I DAYSUP'>90 D
"RTN","PSOUTIL",224,0)
 . . S MAXNUMRF=$S(DAYSUP<60:5,DAYSUP'<60&(DAYSUP'>89):2,DAYSUP=90:1,1:0)
"RTN","PSOUTIL",225,0)
 . E  D
"RTN","PSOUTIL",226,0)
 . . S MAXNUMRF=182\DAYSUP-1
"RTN","PSOUTIL",227,0)
 E  D
"RTN","PSOUTIL",228,0)
 . I DAYSUP'>90 D
"RTN","PSOUTIL",229,0)
 . . S MAXNUMRF=$S(DAYSUP<60:11,DAYSUP'<60&(DAYSUP'>89):5,DAYSUP=90:3,1:0)
"RTN","PSOUTIL",230,0)
 . E  D
"RTN","PSOUTIL",231,0)
 . . S MAXNUMRF=365\DAYSUP-1
"RTN","PSOUTIL",232,0)
 ;
"RTN","PSOUTIL",233,0)
 ; - Adjusting Maximum based Rx Patient Status 
"RTN","PSOUTIL",234,0)
 I $G(PTST) S MAXPTST=$$GET1^DIQ(53,PTST,4) I MAXNUMRF>MAXPTST S MAXNUMRF=MAXPTST
"RTN","PSOUTIL",235,0)
 ;
"RTN","PSOUTIL",236,0)
 Q MAXNUMRF
"RTN","PSOUTIL",237,0)
 ;
"RTN","PSOUTIL",238,0)
BADADDFL(RXIEN) ; Indicate whether an Rx should be flagged with a Bad Address
"RTN","PSOUTIL",239,0)
 ; Input: RXIEN    - Rx IEN (#52) to be checked
"RTN","PSOUTIL",240,0)
 ;Output: BADADDFL - 1: Rx Flagged for Bad Address / 0: Rx NOT Flagged Bad Address 
"RTN","PSOUTIL",241,0)
 N BADADDFL,LSTLBLSQ,LSTLBLTX
"RTN","PSOUTIL",242,0)
 S BADADDFL=0
"RTN","PSOUTIL",243,0)
 I '$G(^PSRX(+$G(RXIEN),0)) Q BADADDFL
"RTN","PSOUTIL",244,0)
 S LSTLBLSQ=$O(^PSRX(+RXIEN,"L",9999),-1)
"RTN","PSOUTIL",245,0)
 I LSTLBLSQ D
"RTN","PSOUTIL",246,0)
 . S LSTLBLTX=$G(^PSRX(+RXIEN,"L",LSTLBLSQ,0)) I LSTLBLTX["(BAD ADDRESS)" S BADADDFL=1
"RTN","PSOUTIL",247,0)
 Q BADADDFL
"RTN","PSOUTIL",248,0)
 ;
"RTN","PSOUTIL",249,0)
PRVDETOX(PRVIEN) ; Returns the Provider DETOX#, if available and not not expired
"RTN","PSOUTIL",250,0)
 ; Input: (r) PRVIEN   - Provider IEN (Pointer to VA PERSON file (#200))
"RTN","PSOUTIL",251,0)
 ;Output:     PRVDETOX - Provider Detox #
"RTN","PSOUTIL",252,0)
 N PRVDETOX
"RTN","PSOUTIL",253,0)
 S PRVDETOX=$$DETOX^XUSER(PRVIEN) I PRVDETOX?1"X"1A7N Q PRVDETOX
"RTN","PSOUTIL",254,0)
 Q ""
"RTN","PSOUTIL",255,0)
 ;
"RTN","PSOUTIL",256,0)
RXDEA(RXIEN,ORIEN) ; Returns the Provider DEA# associated with the Prescription/CPRS Order (At least one of RXIEN or ORIEN is required)
"RTN","PSOUTIL",257,0)
 ; Input: (o) RXIEN - Prescription IEN (Pointer to the PRESCRIPTION file (#52))
"RTN","PSOUTIL",258,0)
 ;        (o) ORIEN - CPRS Order IEN (Pointer to ORDER file (#100))
"RTN","PSOUTIL",259,0)
 ;Output:     RXDEA - Provider DEA# associated with the Prescription
"RTN","PSOUTIL",260,0)
 N RXDEA
"RTN","PSOUTIL",261,0)
 I $G(RXIEN) S ORIEN=+$$GET1^DIQ(52,RXIEN,39.3,"I")
"RTN","PSOUTIL",262,0)
 I $G(ORIEN) K ^TMP($J,"ORDEA") D ARCHIVE^ORDEA(ORIEN) S RXDEA=$P($G(^TMP($J,"ORDEA",ORIEN,2)),"^",1) K ^TMP($J,"ORDEA")
"RTN","PSOUTIL",263,0)
 Q $G(RXDEA)
"RTN","PSOUTIL",264,0)
 ;
"RTN","PSOUTIL",265,0)
RXDETOX(RXIEN,ORIEN) ; Returns the Provider DETOX# associated with the Prescription/CPRS Order (At least one of RXIEN or ORIEN is required)
"RTN","PSOUTIL",266,0)
 ; Input: (o) RXIEN   - Prescription IEN (Pointer to the PRESCRIPTION file (#52))
"RTN","PSOUTIL",267,0)
 ;        (o) ORIEN   - CPRS Order IEN (Pointer to the ORDER file (#100))
"RTN","PSOUTIL",268,0)
 ;Output:     RXDETOX - Provider DETOX# associated with the Prescription
"RTN","PSOUTIL",269,0)
 N RXDETOX
"RTN","PSOUTIL",270,0)
 I $G(RXIEN) S ORIEN=+$$GET1^DIQ(52,RXIEN,39.3,"I")
"RTN","PSOUTIL",271,0)
 I $G(ORIEN) K ^TMP($J,"ORDEA") D ARCHIVE^ORDEA(ORIEN) S RXDETOX=$P($G(^TMP($J,"ORDEA",ORIEN,2)),"^",2) K ^TMP($J,"ORDEA")
"RTN","PSOUTIL",272,0)
 Q $G(RXDETOX)
"RTN","PSOUTIL",273,0)
 ;
"RTN","PSOUTIL",274,0)
CHKRXPRV(RXIEN,PRVIEN) ; Check if the Provider can be assigned to a specific Prescription (Used for Rx Copy, Rx Renewal, etc.)
"RTN","PSOUTIL",275,0)
 ; Input: (r) RXIEN  - Prescription IEN (Pointer to the PRESCRIPTION file (#52))
"RTN","PSOUTIL",276,0)
 ;        (o) PRVIEN - Provider IEN (Pointer to the NEW PERSON file (#200))
"RTN","PSOUTIL",277,0)
 ;Output: $CHKRXPRV  - 1: YES / 0: NO^Short Reason (Listman)^Long Reason (Write to screen)
"RTN","PSOUTIL",278,0)
 N CHKRXPRV,DRUGIEN,CLOZDRUG,DRUGDEA,REASON
"RTN","PSOUTIL",279,0)
 I '$D(^PSRX(+$G(RXIEN),0)) Q "0^Prescription not found^Prescription not found"
"RTN","PSOUTIL",280,0)
 I '$G(PRVIEN) S PRVIEN=$$GET1^DIQ(52,RXIEN,4,"I")
"RTN","PSOUTIL",281,0)
 I '$D(^VA(200,+$G(PRVIEN),0)) Q "0^Provider not found^Provider not found"
"RTN","PSOUTIL",282,0)
 S DRUGIEN=$$GET1^DIQ(52,RXIEN,6,"I") I 'DRUGIEN Q "0^Invalid Dispense Drug^Invalid Dispense Drug"
"RTN","PSOUTIL",283,0)
 S CLOZDRUG=$S($D(^PSDRUG("ACLOZ",DRUGIEN)):1,1:0)
"RTN","PSOUTIL",284,0)
 I CLOZDRUG,'$D(^XUSEC("YSCL AUTHORIZED",PRVIEN)) Q "0^Provider does not hold YSCL AUTHORIZED key^Provider on the Rx does not hold the YSCL AUTHORIZED key required for clozapine prescriptions."
"RTN","PSOUTIL",285,0)
 S DRUGDEA=$$DRUGSCHD(DRUGIEN)
"RTN","PSOUTIL",286,0)
 I DRUGDEA'="" S REASON="" D  I REASON'="" Q REASON
"RTN","PSOUTIL",287,0)
 . N PRVDEA S PRVDEA=$P($$SDEA^XUSER(0,PRVIEN,DRUGDEA),"^",1)
"RTN","PSOUTIL",288,0)
 . I $L(PRVDEA)<3 D
"RTN","PSOUTIL",289,0)
 . . I PRVDEA=2 S REASON="0^Provider not authorized to write Schedule "_DRUGDEA_" Rx^Provider is not authorized to write Federal Schedule "_DRUGDEA_" prescriptions" Q
"RTN","PSOUTIL",290,0)
 . . S REASON="0^Provider must have a valid DEA# or VA# for this Rx^Provider does not have a valid DEA# or VA# required for this Rx"
"RTN","PSOUTIL",291,0)
 I $$DETOX^PSSOPKI(DRUGIEN),$$PRVDETOX^PSOUTIL(PRVIEN)="" Q "0^Provider must have a valid DETOX# for this Rx^Provider does not have a valid DETOX# required for this Rx"
"RTN","PSOUTIL",292,0)
 Q 1
"RTN","PSOUTIL",293,0)
 ; 
"RTN","PSOUTIL",294,0)
DRUGSCHD(DRUGIEN) ; Return Drug DEA Schedule or "" (blank) for non-controlled substances
"RTN","PSOUTIL",295,0)
 ; Input: (r) DRUGIEN - Dispense Drug IEN (Pointer to the DRUG file (#50))
"RTN","PSOUTIL",296,0)
 ;Output: $DRUGSCHD   - DEA Schedule or "" (blank) for non-controlled substances
"RTN","PSOUTIL",297,0)
 N NDFSCHD,DRUGDEA,NDFIEN
"RTN","PSOUTIL",298,0)
 S NDFSCHD="",DRUGDEA=$$GET1^DIQ(50,DRUGIEN,3)
"RTN","PSOUTIL",299,0)
 S NDFIEN=+$$GET1^DIQ(50,DRUGIEN,22,"I") I NDFIEN S NDFSCHD=$$GET1^DIQ(50.68,NDFIEN,19,"I")
"RTN","PSOUTIL",300,0)
 I +NDFIEN>0!(DRUGDEA="") Q $S('NDFSCHD:"",1:NDFSCHD)
"RTN","PSOUTIL",301,0)
 I "^2^3^"[+DRUGDEA Q $S(DRUGDEA["A":+DRUGDEA,1:+DRUGDEA_"n")
"RTN","PSOUTIL",302,0)
 I "^4^5^"[+DRUGDEA Q +DRUGDEA
"RTN","PSOUTIL",303,0)
 Q ""
"VER")
8.0^22.2
"BLD",10585,6)
^425
**END**
**END**

