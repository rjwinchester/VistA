Released PSO*7*444 SEQ #381
Extracted from mail message
**KIDS**:PSO*7.0*444^

**INSTALL NAME**
PSO*7.0*444
"BLD",9245,0)
PSO*7.0*444^OUTPATIENT PHARMACY^0^3160406^y
"BLD",9245,1,0)
^^141^141^3151027^^^^
"BLD",9245,1,1,0)
This patch is part of the Pharmacy Safety Updates project which was 
"BLD",9245,1,2,0)
established to address specific New Service Requests (NSRs) as well as a
"BLD",9245,1,3,0)
Remedy Ticket and a Patient Safety Issue (PSI) related to the VistA Pharmacy
"BLD",9245,1,4,0)
applications as approved by the Health Systems Enterprise Systems Manager
"BLD",9245,1,5,0)
(ESM).
"BLD",9245,1,6,0)
 
"BLD",9245,1,7,0)
This project is comprised of patches from five different applications, as
"BLD",9245,1,8,0)
shown below:
"BLD",9245,1,9,0)
  
"BLD",9245,1,10,0)
   APPLICATION/VERSION                                  PATCH
"BLD",9245,1,11,0)
   -----------------------------------------------------------------
"BLD",9245,1,12,0)
   OUTPATIENT PHARMACY (OP) V. 7.0                      PSO*7*444
"BLD",9245,1,13,0)
   INTEGRATED BILLING (IB) V. 2.0                       IB*2*545
"BLD",9245,1,14,0)
   PHARMACY DATA MANAGEMENT (PDM) V. 1.0                PSS*1*189
"BLD",9245,1,15,0)
   NATIONAL DRUG FILE (NDF) V. 4.0                      PSN*4*429
"BLD",9245,1,16,0)
   INPATIENT MEDICATIONS (IM) V.5.0                     PSJ*5*313
"BLD",9245,1,17,0)
 
"BLD",9245,1,18,0)
 
"BLD",9245,1,19,0)
The following New service Requests (NSRs), Remedy Ticket and Patient Safety
"BLD",9245,1,20,0)
Issue (PSI) are being addressed by this patch:
"BLD",9245,1,21,0)
 
"BLD",9245,1,22,0)
 NSRs 20060601/20111206 Allow Dispensing of Greater Than 90 Day Supply
"BLD",9245,1,23,0)
 ---------------------------------------------------------------------------
"BLD",9245,1,24,0)
 The Outpatient Pharmacy and supporting VistA applications are being modified
"BLD",9245,1,25,0)
 to allow dispensing of more than 90 day supply fill for outpatient 
"BLD",9245,1,26,0)
 prescriptions. The new limit will be 365 days and will be set for each drug
"BLD",9245,1,27,0)
 individually. See below for more information on specific menu 
"BLD",9245,1,28,0)
 options related to this enhancement.  
"BLD",9245,1,29,0)
 
"BLD",9245,1,30,0)
 PSI PSPO00002793 Patient Prescription Processing error, truncating the 
"BLD",9245,1,31,0)
                  second character of the Days Supply
"BLD",9245,1,32,0)
 Remedy 387051 Patient Medication Profile Bad Address Indicator display
"BLD",9245,1,33,0)
 ----------------------------------------------------------------------------
"BLD",9245,1,34,0)
 The Outpatient Pharmacy Medication Profile has a display problem for a
"BLD",9245,1,35,0)
 prescription with the following characteristics: 2-letter status (e.g., DC), 
"BLD",9245,1,36,0)
 drug marked for Consolidated Mailout Outpatient Pharmacy (CMOP) and Bad
"BLD",9245,1,37,0)
 Address Indicator. When a prescription with all three features is displayed
"BLD",9245,1,38,0)
 the DAY SUP column value is being truncated as illustrated below where the
"BLD",9245,1,39,0)
 Day Supply value is actually 90 and it displays as 9.
"BLD",9245,1,40,0)
 
"BLD",9245,1,41,0)
                                                          ISSUE  LAST REF DAY
"BLD",9245,1,42,0)
 #  RX #         DRUG                              QTY ST  DATE  FILL REM SUP
"BLD",9245,1,43,0)
 --------------------------------DISCONTINUED--------------------------------
"BLD",9245,1,44,0)
 1 100005604$    TOBRAMYCIN 80MG/2ML INJ           100 DC>B01-21 01-21   0  9
"BLD",9245,1,45,0)
  
"BLD",9245,1,46,0)
 
"BLD",9245,1,47,0)
This patch modifies the Outpatient Pharmacy application regarding the
"BLD",9245,1,48,0)
enhancements and issues listed above:
"BLD",9245,1,49,0)
 
"BLD",9245,1,50,0)
1. Patient Prescription Processing [PSO LM BACKDOOR ORDERS] option 
"BLD",9245,1,51,0)
   a) The backdoor pharmacy was modified to accept the new maximum value for
"BLD",9245,1,52,0)
      the DAYS SUPPLY field based on the limit set by the MAXIMUM DAYS SUPPLY
"BLD",9245,1,53,0)
      field (#66) in the DRUG file (#50) or the MAXIMUM DAYS SUPPLY field (#32)
"BLD",9245,1,54,0)
      in the VA PRODUCT (#50.68) file. If alternate maximum values do not
"BLD",9245,1,55,0)
      exist, the current limits will remain the same.
"BLD",9245,1,56,0)
 
"BLD",9245,1,57,0)
      Note: The MAXIMUM DAYS SUPPLY field (#32) added to the VA PRODUCT file
"BLD",9245,1,58,0)
            (#50.68) is being introduced by patch PSN*4*429, however it will
"BLD",9245,1,59,0)
            not be populated initially by the Pharmacy Product System -
"BLD",9245,1,60,0)
            National (PPS-N) as changes will be required to that application to
"BLD",9245,1,61,0)
            edit and export this new field. 
"BLD",9245,1,62,0)
  
"BLD",9245,1,63,0)
   b) The medication profile was modified to display the Bad Address Indicator
"BLD",9245,1,64,0)
      in a different line in order to address the Remedy Ticket 387051 and 
"BLD",9245,1,65,0)
      Patient Safety Issue PSPO00002793 mentioned above. The indicator will be
"BLD",9245,1,66,0)
      placed in the next line, as seen below.
"BLD",9245,1,67,0)
 
"BLD",9245,1,68,0)
    ----------------------------------ACTIVE---------------------------------
"BLD",9245,1,69,0)
    1 100005598   ALSEROXYLON 2MG TAB              400 A> 12-11 03-01   2  90
"BLD",9245,1,70,0)
                                                      **Bad Address**   
"BLD",9245,1,71,0)
    2 100005596   DESIPRAMINE 25MG TAB              90 DC 11-01 11-01  11  30
"BLD",9245,1,72,0)
                                                      **Bad Address**   
"BLD",9245,1,73,0)
    3 100005601A  NAPROXEN 250MG S.T.              170 HP>12-17 12-17   5  30
"BLD",9245,1,74,0)
                                                      **Bad Address**   
"BLD",9245,1,75,0)
    4 100005595   TIMOLOL 0.25% OPTH SOL 10ML       90 S> 11-01 11-21  10  30
"BLD",9245,1,76,0)
  
"BLD",9245,1,77,0)
 
"BLD",9245,1,78,0)
  c) The calculation of the number of refills for a prescription was modified 
"BLD",9245,1,79,0)
     to take into account the new maximum value allowed for the DAYS SUPPLY
"BLD",9245,1,80,0)
     field. The current calculation (up to 90 days supply) will remain the
"BLD",9245,1,81,0)
     same and a new formula will be introduced to calculate the number of
"BLD",9245,1,82,0)
     refills for days supply values of 91 up to 365. The table below shows
"BLD",9245,1,83,0)
     the number of refills allowed based on the days supply value:
"BLD",9245,1,84,0)
 
"BLD",9245,1,85,0)
     ---------------------------------+------------------------------------
"BLD",9245,1,86,0)
        NON-CONTROLLED SUBSTANCES     | CONTROLLED SUBSTANCES (NO CHANGE)
"BLD",9245,1,87,0)
     ---------------+-----------------+------------------+-----------------
"BLD",9245,1,88,0)
      DAYS SUPPLY   |   # OF REFILLS  |   DAYS SUPPLY    |   # OF REFILLS    
"BLD",9245,1,89,0)
     ---------------+-----------------+------------------+-----------------
"BLD",9245,1,90,0)
         1 - 59     |        11       |       1 - 59     |        5
"BLD",9245,1,91,0)
        60 - 89     |         5       |      60 - 89     |        2
"BLD",9245,1,92,0)
        90 - 91     |         3       |        90        |        1
"BLD",9245,1,93,0)
        92 - 121    |         2       |                  |        
"BLD",9245,1,94,0)
       122 - 182    |         1       |                  | 
"BLD",9245,1,95,0)
       183 - 365    |         0       |                  |
"BLD",9245,1,96,0)
     ---------------+-----------------+------------------+----------------
"BLD",9245,1,97,0)
 
"BLD",9245,1,98,0)
2. Complete Orders From OERR [PSO LMOE FINISH] option
"BLD",9245,1,99,0)
   This option was modified to accept the new maximum value for the DAYS
"BLD",9245,1,100,0)
   SUPPLY field based on the limit set by the MAXIMUM DAYS SUPPLY field (#66)
"BLD",9245,1,101,0)
   in the DRUG file (#50) or the MAXIMUM DAYS SUPPLY field (#32) in the VA
"BLD",9245,1,102,0)
   PRODUCT (#50.68) file. If alternate maximum values exist, the current
"BLD",9245,1,103,0)
   limits will remain the same.
"BLD",9245,1,104,0)
 
"BLD",9245,1,105,0)
3. Edit Prescriptions [PSO RXEDIT] option
"BLD",9245,1,106,0)
   This option was also modified to accept the new maximum value for the DAYS
"BLD",9245,1,107,0)
   SUPPLY field based on the limit set by the MAXIMUM DAYS SUPPLY field (#66)
"BLD",9245,1,108,0)
   in the DRUG file (#50) or the MAXIMUM DAYS SUPPLY field (#32) in the VA
"BLD",9245,1,109,0)
   PRODUCT (#50.68) file. If alternate maximum values exist, the current 
"BLD",9245,1,110,0)
   limits will remain the same.
"BLD",9245,1,111,0)
 
"BLD",9245,1,112,0)
4. Barcode Batch Prescription Entry [PSO BATCH BARCODE] option
"BLD",9245,1,113,0)
   The renewal functionality within this option was also modified to accept
"BLD",9245,1,114,0)
   the new maximum value for the DAYS SUPPLY field based on the limit set by
"BLD",9245,1,115,0)
   the MAXIMUM DAYS SUPPLY field (#66) in the DRUG file (#50) or the MAXIMUM
"BLD",9245,1,116,0)
   DAYS SUPPLY field (#32) in the VA PRODUCT (#50.68) file. If alternate
"BLD",9245,1,117,0)
   maximum values exist, the current limits will remain the same.
"BLD",9245,1,118,0)
  
"BLD",9245,1,119,0)
5. Prescription Management Data Compilation   
"BLD",9245,1,120,0)
   The algorithm used to compile prescription management data was modified to
"BLD",9245,1,121,0)
   account for prescriptions with greater than 90 days supply. The OVER 90
"BLD",9245,1,122,0)
   DAYS (#8) field in the OUTPATIENT PHARMACY MANAGEMENT DATA file (#59.12), 
"BLD",9245,1,123,0)
   which is used as a counter for the number of prescription fills with DAYS
"BLD",9245,1,124,0)
   SUPPLY value greater than 90, will now be populated.
"BLD",9245,1,125,0)
  
"BLD",9245,1,126,0)
6. Count of Prescriptions [PSO MGMT REPORT RX COUNTS] option &
"BLD",9245,1,127,0)
   Count of Prescriptions [PSO MGMT MONTHLY RX COUNTS] option
"BLD",9245,1,128,0)
   These daily and monthly reports have been modified to include a new column
"BLD",9245,1,129,0)
   called ">90 DAY", as seen below. This column will display the total number
"BLD",9245,1,130,0)
   of prescription fills with a DAYS SUPPLY value greater than 90, as shown
"BLD",9245,1,131,0)
   below.
"BLD",9245,1,132,0)
 
"BLD",9245,1,133,0)
          30      60      90     >90      EQ             TOT     TOT
"BLD",9245,1,134,0)
         DAY     DAY     DAY     DAY     FLS    METH      RX   EQ FL
"BLD",9245,1,135,0)
      ...===========================================================...
"BLD",9245,1,136,0)
           1       3       0       1      11       0       5      11
"BLD",9245,1,137,0)
           0       0       1       2      14       0       3      14
"BLD",9245,1,138,0)
           0       0       0       0       0       0       0       0
"BLD",9245,1,139,0)
           0       0       0       0       0       0       0       0
"BLD",9245,1,140,0)
      ...=== ======= ======= ======= ======= ======= ======= =======...
"BLD",9245,1,141,0)
           1       3       1       3      25       3       8      25
"BLD",9245,4,0)
^9.64PA^52.41^2
"BLD",9245,4,52,0)
52
"BLD",9245,4,52,2,0)
^9.641^52.07^3
"BLD",9245,4,52,2,52,0)
PRESCRIPTION  (File-top level)
"BLD",9245,4,52,2,52,1,0)
^9.6411^8^1
"BLD",9245,4,52,2,52,1,8,0)
DAYS SUPPLY
"BLD",9245,4,52,2,52.07,0)
RETURN TO STOCK LOG  (sub-file)
"BLD",9245,4,52,2,52.07,1,0)
^9.6411^4^1
"BLD",9245,4,52,2,52.07,1,4,0)
DAYS SUPPLY
"BLD",9245,4,52,2,52.1,0)
REFILL  (sub-file)
"BLD",9245,4,52,2,52.1,1,0)
^9.6411^1.1^1
"BLD",9245,4,52,2,52.1,1,1.1,0)
DAYS SUPPLY
"BLD",9245,4,52,222)
y^n^p^^^^n^^n
"BLD",9245,4,52,224)

"BLD",9245,4,52.41,0)
52.41
"BLD",9245,4,52.41,2,0)
^9.641^52.41^1
"BLD",9245,4,52.41,2,52.41,0)
PENDING OUTPATIENT ORDERS  (File-top level)
"BLD",9245,4,52.41,2,52.41,1,0)
^9.6411^101^1
"BLD",9245,4,52.41,2,52.41,1,101,0)
DAYS SUPPLY
"BLD",9245,4,52.41,222)
y^n^p^^^^n^^n
"BLD",9245,4,52.41,224)

"BLD",9245,4,"APDD",52,52)

"BLD",9245,4,"APDD",52,52,8)

"BLD",9245,4,"APDD",52,52.07)

"BLD",9245,4,"APDD",52,52.07,4)

"BLD",9245,4,"APDD",52,52.1)

"BLD",9245,4,"APDD",52,52.1,1.1)

"BLD",9245,4,"APDD",52.41,52.41)

"BLD",9245,4,"APDD",52.41,52.41,101)

"BLD",9245,4,"B",52,52)

"BLD",9245,4,"B",52.41,52.41)

"BLD",9245,6.3)
34
"BLD",9245,"ABPKG")
n
"BLD",9245,"KRN",0)
^9.67PA^779.2^20
"BLD",9245,"KRN",.4,0)
.4
"BLD",9245,"KRN",.401,0)
.401
"BLD",9245,"KRN",.402,0)
.402
"BLD",9245,"KRN",.403,0)
.403
"BLD",9245,"KRN",.5,0)
.5
"BLD",9245,"KRN",.84,0)
.84
"BLD",9245,"KRN",3.6,0)
3.6
"BLD",9245,"KRN",3.8,0)
3.8
"BLD",9245,"KRN",9.2,0)
9.2
"BLD",9245,"KRN",9.8,0)
9.8
"BLD",9245,"KRN",9.8,"NM",0)
^9.68A^30^26
"BLD",9245,"KRN",9.8,"NM",1,0)
PSODIR1^^0^B95631218
"BLD",9245,"KRN",9.8,"NM",2,0)
PSODIR3^^0^B18185000
"BLD",9245,"KRN",9.8,"NM",3,0)
PSOHELP^^0^B49812789
"BLD",9245,"KRN",9.8,"NM",4,0)
PSOHELP1^^0^B49158758
"BLD",9245,"KRN",9.8,"NM",5,0)
PSOMGCOM^^0^B21894614
"BLD",9245,"KRN",9.8,"NM",6,0)
PSOORED1^^0^B64951982
"BLD",9245,"KRN",9.8,"NM",7,0)
PSOORFI1^^0^B79665537
"BLD",9245,"KRN",9.8,"NM",8,0)
PSOORFI4^^0^B73807105
"BLD",9245,"KRN",9.8,"NM",9,0)
PSOORNE5^^0^B54881611
"BLD",9245,"KRN",9.8,"NM",10,0)
PSOORNW1^^0^B34218715
"BLD",9245,"KRN",9.8,"NM",11,0)
PSORENW4^^0^B65687099
"BLD",9245,"KRN",9.8,"NM",12,0)
PSOSIGDS^^0^B46733813
"BLD",9245,"KRN",9.8,"NM",13,0)
PSOSIGMX^^0^B9129541
"BLD",9245,"KRN",9.8,"NM",14,0)
PSOUTLA^^0^B37861740
"BLD",9245,"KRN",9.8,"NM",15,0)
PSOORUT1^^0^B83321658
"BLD",9245,"KRN",9.8,"NM",16,0)
PSOORCPY^^0^B35592105
"BLD",9245,"KRN",9.8,"NM",20,0)
PSOUTIL^^0^B95292700
"BLD",9245,"KRN",9.8,"NM",21,0)
PSOUTLA1^^0^B66629257
"BLD",9245,"KRN",9.8,"NM",22,0)
PSORENW1^^0^B63022534
"BLD",9245,"KRN",9.8,"NM",23,0)
PSOORED3^^0^B66176959
"BLD",9245,"KRN",9.8,"NM",24,0)
PSOORNEW^^0^B97649814
"BLD",9245,"KRN",9.8,"NM",26,0)
PSORENW3^^0^B40697440
"BLD",9245,"KRN",9.8,"NM",27,0)
PSOMGMN1^^0^B12434382
"BLD",9245,"KRN",9.8,"NM",28,0)
PSOMGRP1^^0^B13150824
"BLD",9245,"KRN",9.8,"NM",29,0)
PSOMGCM1^^0^B39462059
"BLD",9245,"KRN",9.8,"NM",30,0)
PSOORNE3^^0^B69565652
"BLD",9245,"KRN",9.8,"NM","B","PSODIR1",1)

"BLD",9245,"KRN",9.8,"NM","B","PSODIR3",2)

"BLD",9245,"KRN",9.8,"NM","B","PSOHELP",3)

"BLD",9245,"KRN",9.8,"NM","B","PSOHELP1",4)

"BLD",9245,"KRN",9.8,"NM","B","PSOMGCM1",29)

"BLD",9245,"KRN",9.8,"NM","B","PSOMGCOM",5)

"BLD",9245,"KRN",9.8,"NM","B","PSOMGMN1",27)

"BLD",9245,"KRN",9.8,"NM","B","PSOMGRP1",28)

"BLD",9245,"KRN",9.8,"NM","B","PSOORCPY",16)

"BLD",9245,"KRN",9.8,"NM","B","PSOORED1",6)

"BLD",9245,"KRN",9.8,"NM","B","PSOORED3",23)

"BLD",9245,"KRN",9.8,"NM","B","PSOORFI1",7)

"BLD",9245,"KRN",9.8,"NM","B","PSOORFI4",8)

"BLD",9245,"KRN",9.8,"NM","B","PSOORNE3",30)

"BLD",9245,"KRN",9.8,"NM","B","PSOORNE5",9)

"BLD",9245,"KRN",9.8,"NM","B","PSOORNEW",24)

"BLD",9245,"KRN",9.8,"NM","B","PSOORNW1",10)

"BLD",9245,"KRN",9.8,"NM","B","PSOORUT1",15)

"BLD",9245,"KRN",9.8,"NM","B","PSORENW1",22)

"BLD",9245,"KRN",9.8,"NM","B","PSORENW3",26)

"BLD",9245,"KRN",9.8,"NM","B","PSORENW4",11)

"BLD",9245,"KRN",9.8,"NM","B","PSOSIGDS",12)

"BLD",9245,"KRN",9.8,"NM","B","PSOSIGMX",13)

"BLD",9245,"KRN",9.8,"NM","B","PSOUTIL",20)

"BLD",9245,"KRN",9.8,"NM","B","PSOUTLA",14)

"BLD",9245,"KRN",9.8,"NM","B","PSOUTLA1",21)

"BLD",9245,"KRN",19,0)
19
"BLD",9245,"KRN",19,"NM",0)
^9.68A^^
"BLD",9245,"KRN",19.1,0)
19.1
"BLD",9245,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",9245,"KRN",101,0)
101
"BLD",9245,"KRN",409.61,0)
409.61
"BLD",9245,"KRN",771,0)
771
"BLD",9245,"KRN",779.2,0)
779.2
"BLD",9245,"KRN",870,0)
870
"BLD",9245,"KRN",8989.51,0)
8989.51
"BLD",9245,"KRN",8989.52,0)
8989.52
"BLD",9245,"KRN",8994,0)
8994
"BLD",9245,"KRN","B",.4,.4)

"BLD",9245,"KRN","B",.401,.401)

"BLD",9245,"KRN","B",.402,.402)

"BLD",9245,"KRN","B",.403,.403)

"BLD",9245,"KRN","B",.5,.5)

"BLD",9245,"KRN","B",.84,.84)

"BLD",9245,"KRN","B",3.6,3.6)

"BLD",9245,"KRN","B",3.8,3.8)

"BLD",9245,"KRN","B",9.2,9.2)

"BLD",9245,"KRN","B",9.8,9.8)

"BLD",9245,"KRN","B",19,19)

"BLD",9245,"KRN","B",19.1,19.1)

"BLD",9245,"KRN","B",101,101)

"BLD",9245,"KRN","B",409.61,409.61)

"BLD",9245,"KRN","B",771,771)

"BLD",9245,"KRN","B",779.2,779.2)

"BLD",9245,"KRN","B",870,870)

"BLD",9245,"KRN","B",8989.51,8989.51)

"BLD",9245,"KRN","B",8989.52,8989.52)

"BLD",9245,"KRN","B",8994,8994)

"BLD",9245,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9245,"QUES",0)
^9.62^^
"BLD",9245,"REQB",0)
^9.611^8^5
"BLD",9245,"REQB",1,0)
PSO*7.0*221^2
"BLD",9245,"REQB",5,0)
PSS*1.0*189^2
"BLD",9245,"REQB",6,0)
PSO*7.0*456^2
"BLD",9245,"REQB",7,0)
PSO*7.0*427^2
"BLD",9245,"REQB",8,0)
PSO*7.0*411^2
"BLD",9245,"REQB","B","PSO*7.0*221",1)

"BLD",9245,"REQB","B","PSO*7.0*411",8)

"BLD",9245,"REQB","B","PSO*7.0*427",7)

"BLD",9245,"REQB","B","PSO*7.0*456",6)

"BLD",9245,"REQB","B","PSS*1.0*189",5)

"FIA",52)
PRESCRIPTION
"FIA",52,0)
^PSRX(
"FIA",52,0,0)
52Is
"FIA",52,0,1)
y^n^p^^^^n^^n
"FIA",52,0,10)

"FIA",52,0,11)

"FIA",52,0,"RLRO")

"FIA",52,0,"VR")
7.0^PSO
"FIA",52,52)
1
"FIA",52,52,8)

"FIA",52,52.07)
1
"FIA",52,52.07,4)

"FIA",52,52.1)
1
"FIA",52,52.1,1.1)

"FIA",52.41)
PENDING OUTPATIENT ORDERS
"FIA",52.41,0)
^PS(52.41,
"FIA",52.41,0,0)
52.41I
"FIA",52.41,0,1)
y^n^p^^^^n^^n
"FIA",52.41,0,10)

"FIA",52.41,0,11)

"FIA",52.41,0,"RLRO")

"FIA",52.41,0,"VR")
7.0^PSO
"FIA",52.41,52.41)
1
"FIA",52.41,52.41,101)

"IX",52,52,"ACRO",0)
52^ACRO^Clinical Reminders index.^MU^^F^IR^I^52^^^^^A
"IX",52,52,"ACRO",.1,0)
^^9^9^3050224
"IX",52,52,"ACRO",.1,1,0)
This cross-reference builds two indexes, one for finding
"IX",52,52,"ACRO",.1,2,0)
all patients with a particular drug and one for
"IX",52,52,"ACRO",.1,3,0)
finding all the drugs a patient has. The indexes are
"IX",52,52,"ACRO",.1,4,0)
stored in the Clinical Reminders index global as:
"IX",52,52,"ACRO",.1,5,0)
 ^PXRMINDX(52,"IP",DRUG,DFN,START DATE,STOP DATE,DAS)
"IX",52,52,"ACRO",.1,6,0)
 ^PXRMINDX(52,"PI",DFN,DRUG,START DATE,STOP DATE,DAS)
"IX",52,52,"ACRO",.1,7,0)
respectively. START DATE is the RELEASE DATE and STOP DATE is
"IX",52,52,"ACRO",.1,8,0)
calculated by adding the DAYS SUPPLY to the RELEASE DATE.
"IX",52,52,"ACRO",.1,9,0)
For all the details, see the Clinical Reminders Index Technical Guide/Programmer's Manual.
"IX",52,52,"ACRO",1)
D SKIDX^PSOPXRMU(.X,.DA,"O","S")
"IX",52,52,"ACRO",2)
D SKIDX^PSOPXRMU(.X,.DA,"O","K")
"IX",52,52,"ACRO",2.5)
Q
"IX",52,52,"ACRO",11.1,0)
^.114IA^2^2
"IX",52,52,"ACRO",11.1,1,0)
1^F^52^8^^1^F
"IX",52,52,"ACRO",11.1,2,0)
2^F^52^31^^2^F
"IX",52,52,"ACRR",0)
52^ACRR^Clinical Reminders index.^MU^^F^IR^W^52.1^^^^^A
"IX",52,52,"ACRR",.1,0)
^^9^9^3050224
"IX",52,52,"ACRR",.1,1,0)
This cross-reference builds two indexes, one for finding
"IX",52,52,"ACRR",.1,2,0)
all patients with a particular drug and one for
"IX",52,52,"ACRR",.1,3,0)
finding all the drugs a patient has. The indexes are
"IX",52,52,"ACRR",.1,4,0)
stored in the Clinical Reminders index global as:
"IX",52,52,"ACRR",.1,5,0)
 ^PXRMINDX(52,"IP",DRUG,DFN,START DATE,STOP DATE,DAS)
"IX",52,52,"ACRR",.1,6,0)
 ^PXRMINDX(52,"PI",DFN,DRUG,START DATE,STOP DATE,DAS)
"IX",52,52,"ACRR",.1,7,0)
respectively. START DATE is the RELEASE DATE and STOP DATE is
"IX",52,52,"ACRR",.1,8,0)
calculated by adding the DAYS SUPPLY to the RELEASE DATE.
"IX",52,52,"ACRR",.1,9,0)
For all the details, see the Clinical Reminders Index Technical Guide/Programmer's Manual.
"IX",52,52,"ACRR",1)
D SKIDX^PSOPXRMU(.X,.DA,"R","S")
"IX",52,52,"ACRR",2)
D SKIDX^PSOPXRMU(.X,.DA,"R","K")
"IX",52,52,"ACRR",2.5)
Q
"IX",52,52,"ACRR",11.1,0)
^.114IA^2^2
"IX",52,52,"ACRR",11.1,1,0)
1^F^52.1^1.1^^1^F
"IX",52,52,"ACRR",11.1,2,0)
2^F^52.1^17^^2^F
"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
444^3160406
"PKG",141,22,1,"PAH",1,1,0)
^^141^141^3160406
"PKG",141,22,1,"PAH",1,1,1,0)
This patch is part of the Pharmacy Safety Updates project which was 
"PKG",141,22,1,"PAH",1,1,2,0)
established to address specific New Service Requests (NSRs) as well as a
"PKG",141,22,1,"PAH",1,1,3,0)
Remedy Ticket and a Patient Safety Issue (PSI) related to the VistA Pharmacy
"PKG",141,22,1,"PAH",1,1,4,0)
applications as approved by the Health Systems Enterprise Systems Manager
"PKG",141,22,1,"PAH",1,1,5,0)
(ESM).
"PKG",141,22,1,"PAH",1,1,6,0)
 
"PKG",141,22,1,"PAH",1,1,7,0)
This project is comprised of patches from five different applications, as
"PKG",141,22,1,"PAH",1,1,8,0)
shown below:
"PKG",141,22,1,"PAH",1,1,9,0)
  
"PKG",141,22,1,"PAH",1,1,10,0)
   APPLICATION/VERSION                                  PATCH
"PKG",141,22,1,"PAH",1,1,11,0)
   -----------------------------------------------------------------
"PKG",141,22,1,"PAH",1,1,12,0)
   OUTPATIENT PHARMACY (OP) V. 7.0                      PSO*7*444
"PKG",141,22,1,"PAH",1,1,13,0)
   INTEGRATED BILLING (IB) V. 2.0                       IB*2*545
"PKG",141,22,1,"PAH",1,1,14,0)
   PHARMACY DATA MANAGEMENT (PDM) V. 1.0                PSS*1*189
"PKG",141,22,1,"PAH",1,1,15,0)
   NATIONAL DRUG FILE (NDF) V. 4.0                      PSN*4*429
"PKG",141,22,1,"PAH",1,1,16,0)
   INPATIENT MEDICATIONS (IM) V.5.0                     PSJ*5*313
"PKG",141,22,1,"PAH",1,1,17,0)
 
"PKG",141,22,1,"PAH",1,1,18,0)
 
"PKG",141,22,1,"PAH",1,1,19,0)
The following New service Requests (NSRs), Remedy Ticket and Patient Safety
"PKG",141,22,1,"PAH",1,1,20,0)
Issue (PSI) are being addressed by this patch:
"PKG",141,22,1,"PAH",1,1,21,0)
 
"PKG",141,22,1,"PAH",1,1,22,0)
 NSRs 20060601/20111206 Allow Dispensing of Greater Than 90 Day Supply
"PKG",141,22,1,"PAH",1,1,23,0)
 ---------------------------------------------------------------------------
"PKG",141,22,1,"PAH",1,1,24,0)
 The Outpatient Pharmacy and supporting VistA applications are being modified
"PKG",141,22,1,"PAH",1,1,25,0)
 to allow dispensing of more than 90 day supply fill for outpatient 
"PKG",141,22,1,"PAH",1,1,26,0)
 prescriptions. The new limit will be 365 days and will be set for each drug
"PKG",141,22,1,"PAH",1,1,27,0)
 individually. See below for more information on specific menu 
"PKG",141,22,1,"PAH",1,1,28,0)
 options related to this enhancement.  
"PKG",141,22,1,"PAH",1,1,29,0)
 
"PKG",141,22,1,"PAH",1,1,30,0)
 PSI PSPO00002793 Patient Prescription Processing error, truncating the 
"PKG",141,22,1,"PAH",1,1,31,0)
                  second character of the Days Supply
"PKG",141,22,1,"PAH",1,1,32,0)
 Remedy 387051 Patient Medication Profile Bad Address Indicator display
"PKG",141,22,1,"PAH",1,1,33,0)
 ----------------------------------------------------------------------------
"PKG",141,22,1,"PAH",1,1,34,0)
 The Outpatient Pharmacy Medication Profile has a display problem for a
"PKG",141,22,1,"PAH",1,1,35,0)
 prescription with the following characteristics: 2-letter status (e.g., DC), 
"PKG",141,22,1,"PAH",1,1,36,0)
 drug marked for Consolidated Mailout Outpatient Pharmacy (CMOP) and Bad
"PKG",141,22,1,"PAH",1,1,37,0)
 Address Indicator. When a prescription with all three features is displayed
"PKG",141,22,1,"PAH",1,1,38,0)
 the DAY SUP column value is being truncated as illustrated below where the
"PKG",141,22,1,"PAH",1,1,39,0)
 Day Supply value is actually 90 and it displays as 9.
"PKG",141,22,1,"PAH",1,1,40,0)
 
"PKG",141,22,1,"PAH",1,1,41,0)
                                                          ISSUE  LAST REF DAY
"PKG",141,22,1,"PAH",1,1,42,0)
 #  RX #         DRUG                              QTY ST  DATE  FILL REM SUP
"PKG",141,22,1,"PAH",1,1,43,0)
 --------------------------------DISCONTINUED--------------------------------
"PKG",141,22,1,"PAH",1,1,44,0)
 1 100005604$    TOBRAMYCIN 80MG/2ML INJ           100 DC>B01-21 01-21   0  9
"PKG",141,22,1,"PAH",1,1,45,0)
  
"PKG",141,22,1,"PAH",1,1,46,0)
 
"PKG",141,22,1,"PAH",1,1,47,0)
This patch modifies the Outpatient Pharmacy application regarding the
"PKG",141,22,1,"PAH",1,1,48,0)
enhancements and issues listed above:
"PKG",141,22,1,"PAH",1,1,49,0)
 
"PKG",141,22,1,"PAH",1,1,50,0)
1. Patient Prescription Processing [PSO LM BACKDOOR ORDERS] option 
"PKG",141,22,1,"PAH",1,1,51,0)
   a) The backdoor pharmacy was modified to accept the new maximum value for
"PKG",141,22,1,"PAH",1,1,52,0)
      the DAYS SUPPLY field based on the limit set by the MAXIMUM DAYS SUPPLY
"PKG",141,22,1,"PAH",1,1,53,0)
      field (#66) in the DRUG file (#50) or the MAXIMUM DAYS SUPPLY field (#32)
"PKG",141,22,1,"PAH",1,1,54,0)
      in the VA PRODUCT (#50.68) file. If alternate maximum values do not
"PKG",141,22,1,"PAH",1,1,55,0)
      exist, the current limits will remain the same.
"PKG",141,22,1,"PAH",1,1,56,0)
 
"PKG",141,22,1,"PAH",1,1,57,0)
      Note: The MAXIMUM DAYS SUPPLY field (#32) added to the VA PRODUCT file
"PKG",141,22,1,"PAH",1,1,58,0)
            (#50.68) is being introduced by patch PSN*4*429, however it will
"PKG",141,22,1,"PAH",1,1,59,0)
            not be populated initially by the Pharmacy Product System -
"PKG",141,22,1,"PAH",1,1,60,0)
            National (PPS-N) as changes will be required to that application to
"PKG",141,22,1,"PAH",1,1,61,0)
            edit and export this new field. 
"PKG",141,22,1,"PAH",1,1,62,0)
  
"PKG",141,22,1,"PAH",1,1,63,0)
   b) The medication profile was modified to display the Bad Address Indicator
"PKG",141,22,1,"PAH",1,1,64,0)
      in a different line in order to address the Remedy Ticket 387051 and 
"PKG",141,22,1,"PAH",1,1,65,0)
      Patient Safety Issue PSPO00002793 mentioned above. The indicator will be
"PKG",141,22,1,"PAH",1,1,66,0)
      placed in the next line, as seen below.
"PKG",141,22,1,"PAH",1,1,67,0)
 
"PKG",141,22,1,"PAH",1,1,68,0)
    ----------------------------------ACTIVE---------------------------------
"PKG",141,22,1,"PAH",1,1,69,0)
    1 100005598   ALSEROXYLON 2MG TAB              400 A> 12-11 03-01   2  90
"PKG",141,22,1,"PAH",1,1,70,0)
                                                      **Bad Address**   
"PKG",141,22,1,"PAH",1,1,71,0)
    2 100005596   DESIPRAMINE 25MG TAB              90 DC 11-01 11-01  11  30
"PKG",141,22,1,"PAH",1,1,72,0)
                                                      **Bad Address**   
"PKG",141,22,1,"PAH",1,1,73,0)
    3 100005601A  NAPROXEN 250MG S.T.              170 HP>12-17 12-17   5  30
"PKG",141,22,1,"PAH",1,1,74,0)
                                                      **Bad Address**   
"PKG",141,22,1,"PAH",1,1,75,0)
    4 100005595   TIMOLOL 0.25% OPTH SOL 10ML       90 S> 11-01 11-21  10  30
"PKG",141,22,1,"PAH",1,1,76,0)
  
"PKG",141,22,1,"PAH",1,1,77,0)
 
"PKG",141,22,1,"PAH",1,1,78,0)
  c) The calculation of the number of refills for a prescription was modified 
"PKG",141,22,1,"PAH",1,1,79,0)
     to take into account the new maximum value allowed for the DAYS SUPPLY
"PKG",141,22,1,"PAH",1,1,80,0)
     field. The current calculation (up to 90 days supply) will remain the
"PKG",141,22,1,"PAH",1,1,81,0)
     same and a new formula will be introduced to calculate the number of
"PKG",141,22,1,"PAH",1,1,82,0)
     refills for days supply values of 91 up to 365. The table below shows
"PKG",141,22,1,"PAH",1,1,83,0)
     the number of refills allowed based on the days supply value:
"PKG",141,22,1,"PAH",1,1,84,0)
 
"PKG",141,22,1,"PAH",1,1,85,0)
     ---------------------------------+------------------------------------
"PKG",141,22,1,"PAH",1,1,86,0)
        NON-CONTROLLED SUBSTANCES     | CONTROLLED SUBSTANCES (NO CHANGE)
"PKG",141,22,1,"PAH",1,1,87,0)
     ---------------+-----------------+------------------+-----------------
"PKG",141,22,1,"PAH",1,1,88,0)
      DAYS SUPPLY   |   # OF REFILLS  |   DAYS SUPPLY    |   # OF REFILLS    
"PKG",141,22,1,"PAH",1,1,89,0)
     ---------------+-----------------+------------------+-----------------
"PKG",141,22,1,"PAH",1,1,90,0)
         1 - 59     |        11       |       1 - 59     |        5
"PKG",141,22,1,"PAH",1,1,91,0)
        60 - 89     |         5       |      60 - 89     |        2
"PKG",141,22,1,"PAH",1,1,92,0)
        90 - 91     |         3       |        90        |        1
"PKG",141,22,1,"PAH",1,1,93,0)
        92 - 121    |         2       |                  |        
"PKG",141,22,1,"PAH",1,1,94,0)
       122 - 182    |         1       |                  | 
"PKG",141,22,1,"PAH",1,1,95,0)
       183 - 365    |         0       |                  |
"PKG",141,22,1,"PAH",1,1,96,0)
     ---------------+-----------------+------------------+----------------
"PKG",141,22,1,"PAH",1,1,97,0)
 
"PKG",141,22,1,"PAH",1,1,98,0)
2. Complete Orders From OERR [PSO LMOE FINISH] option
"PKG",141,22,1,"PAH",1,1,99,0)
   This option was modified to accept the new maximum value for the DAYS
"PKG",141,22,1,"PAH",1,1,100,0)
   SUPPLY field based on the limit set by the MAXIMUM DAYS SUPPLY field (#66)
"PKG",141,22,1,"PAH",1,1,101,0)
   in the DRUG file (#50) or the MAXIMUM DAYS SUPPLY field (#32) in the VA
"PKG",141,22,1,"PAH",1,1,102,0)
   PRODUCT (#50.68) file. If alternate maximum values exist, the current
"PKG",141,22,1,"PAH",1,1,103,0)
   limits will remain the same.
"PKG",141,22,1,"PAH",1,1,104,0)
 
"PKG",141,22,1,"PAH",1,1,105,0)
3. Edit Prescriptions [PSO RXEDIT] option
"PKG",141,22,1,"PAH",1,1,106,0)
   This option was also modified to accept the new maximum value for the DAYS
"PKG",141,22,1,"PAH",1,1,107,0)
   SUPPLY field based on the limit set by the MAXIMUM DAYS SUPPLY field (#66)
"PKG",141,22,1,"PAH",1,1,108,0)
   in the DRUG file (#50) or the MAXIMUM DAYS SUPPLY field (#32) in the VA
"PKG",141,22,1,"PAH",1,1,109,0)
   PRODUCT (#50.68) file. If alternate maximum values exist, the current 
"PKG",141,22,1,"PAH",1,1,110,0)
   limits will remain the same.
"PKG",141,22,1,"PAH",1,1,111,0)
 
"PKG",141,22,1,"PAH",1,1,112,0)
4. Barcode Batch Prescription Entry [PSO BATCH BARCODE] option
"PKG",141,22,1,"PAH",1,1,113,0)
   The renewal functionality within this option was also modified to accept
"PKG",141,22,1,"PAH",1,1,114,0)
   the new maximum value for the DAYS SUPPLY field based on the limit set by
"PKG",141,22,1,"PAH",1,1,115,0)
   the MAXIMUM DAYS SUPPLY field (#66) in the DRUG file (#50) or the MAXIMUM
"PKG",141,22,1,"PAH",1,1,116,0)
   DAYS SUPPLY field (#32) in the VA PRODUCT (#50.68) file. If alternate
"PKG",141,22,1,"PAH",1,1,117,0)
   maximum values exist, the current limits will remain the same.
"PKG",141,22,1,"PAH",1,1,118,0)
  
"PKG",141,22,1,"PAH",1,1,119,0)
5. Prescription Management Data Compilation   
"PKG",141,22,1,"PAH",1,1,120,0)
   The algorithm used to compile prescription management data was modified to
"PKG",141,22,1,"PAH",1,1,121,0)
   account for prescriptions with greater than 90 days supply. The OVER 90
"PKG",141,22,1,"PAH",1,1,122,0)
   DAYS (#8) field in the OUTPATIENT PHARMACY MANAGEMENT DATA file (#59.12), 
"PKG",141,22,1,"PAH",1,1,123,0)
   which is used as a counter for the number of prescription fills with DAYS
"PKG",141,22,1,"PAH",1,1,124,0)
   SUPPLY value greater than 90, will now be populated.
"PKG",141,22,1,"PAH",1,1,125,0)
  
"PKG",141,22,1,"PAH",1,1,126,0)
6. Count of Prescriptions [PSO MGMT REPORT RX COUNTS] option &
"PKG",141,22,1,"PAH",1,1,127,0)
   Count of Prescriptions [PSO MGMT MONTHLY RX COUNTS] option
"PKG",141,22,1,"PAH",1,1,128,0)
   These daily and monthly reports have been modified to include a new column
"PKG",141,22,1,"PAH",1,1,129,0)
   called ">90 DAY", as seen below. This column will display the total number
"PKG",141,22,1,"PAH",1,1,130,0)
   of prescription fills with a DAYS SUPPLY value greater than 90, as shown
"PKG",141,22,1,"PAH",1,1,131,0)
   below.
"PKG",141,22,1,"PAH",1,1,132,0)
 
"PKG",141,22,1,"PAH",1,1,133,0)
          30      60      90     >90      EQ             TOT     TOT
"PKG",141,22,1,"PAH",1,1,134,0)
         DAY     DAY     DAY     DAY     FLS    METH      RX   EQ FL
"PKG",141,22,1,"PAH",1,1,135,0)
      ...===========================================================...
"PKG",141,22,1,"PAH",1,1,136,0)
           1       3       0       1      11       0       5      11
"PKG",141,22,1,"PAH",1,1,137,0)
           0       0       1       2      14       0       3      14
"PKG",141,22,1,"PAH",1,1,138,0)
           0       0       0       0       0       0       0       0
"PKG",141,22,1,"PAH",1,1,139,0)
           0       0       0       0       0       0       0       0
"PKG",141,22,1,"PAH",1,1,140,0)
      ...=== ======= ======= ======= ======= ======= ======= =======...
"PKG",141,22,1,"PAH",1,1,141,0)
           1       3       1       3      25       3       8      25
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
26
"RTN","PSODIR1")
0^1^B95631218^B94639325
"RTN","PSODIR1",1,0)
PSODIR1 ;IHS/DSD - ASKS DATA FOR RX ORDER ENTRY CONT. ; 5/18/10 2:28pm
"RTN","PSODIR1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**23,46,78,102,121,131,146,166,184,222,268,206,266,340,391,444**;DEC 1997;Build 34
"RTN","PSODIR1",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSODIR1",4,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSODIR1",5,0)
 ;External reference $$MXDAYSUP^PSSUTIL1 supported by DBIA 6229
"RTN","PSODIR1",6,0)
 ;
"RTN","PSODIR1",7,0)
PTSTAT(PSODIR) ;
"RTN","PSODIR1",8,0)
PTSTATEN K DIC,DR,DIE S PSODIR("FIELD")=0
"RTN","PSODIR1",9,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" K PSORX("PATIENT STATUS"),PSODIR("PATIENT STATUS") N PSOFNDRX,PSOFNDFL,PSOFNDPS D
"RTN","PSODIR1",10,0)
 .S PSOFNDFL=0 F PSOFNDPS=0:0 S PSOFNDPS=$O(^PS(53,PSOFNDPS)) Q:'PSOFNDPS!(PSOFNDFL)  D
"RTN","PSODIR1",11,0)
 ..S PSOFNDRX=$P($G(^PS(53,PSOFNDPS,0)),"^") S PSOFNDRX=$$UP^XLFSTR(PSOFNDRX) I PSOFNDRX="NON-VA" S PSOFNDFL=1 S (PSORX("PATIENT STATUS"),DIC("B"))=$P($G(^PS(53,PSOFNDPS,0)),"^")
"RTN","PSODIR1",12,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW",$G(PSORX("PATIENT STATUS"))="" W !,"Could not find a 'NON-VA' Patient Status in the RX PATIENT STATUS file (#53)!" D PSTPB D  S PSODIR("DFLG")=1 G PTSTATX
"RTN","PSODIR1",13,0)
 .K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODIR1",14,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" G TPBB
"RTN","PSODIR1",15,0)
 N PSOX
"RTN","PSODIR1",16,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^"),DIC("B")=PSORX("PATIENT STATUS")
"RTN","PSODIR1",17,0)
 S:$G(PSODIR("PATIENT STATUS"))]"" DIC("B")=PSODIR("PATIENT STATUS")
"RTN","PSODIR1",18,0)
TPBB ;
"RTN","PSODIR1",19,0)
 D ELIG^VADPT W !,"Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:"")
"RTN","PSODIR1",20,0)
 S N=0 F  S N=$O(VAEL(1,N)) Q:'N  W !,?10,$P(VAEL(1,N),"^",2)
"RTN","PSODIR1",21,0)
 S DIC("A")="RX PATIENT STATUS: "
"RTN","PSODIR1",22,0)
 S DIC(0)="QEAMZ",DIC=53 D ^DIC K DIC
"RTN","PSODIR1",23,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" N PSOPSDIR,PSOFNDZZ,PSOPSUPA S (PSOPSDIR,PSOPSUPA)=0 D  I PSOPSDIR S:PSOPSUPA PSODIR("DFLG")=1 G:PSOPSUPA PTSTATX W ! D PSTPB G PTSTATEN
"RTN","PSODIR1",24,0)
 .I +Y'>0!($D(DTOUT))!($D(DUOUT)) S (PSOPSDIR,PSOPSUPA)=1 Q
"RTN","PSODIR1",25,0)
 .S (PSODIR("PATIENT STATUS"),PSORX("PATIENT STATUS"))=+Y,PSODIR("PTST NODE")=Y(0)
"RTN","PSODIR1",26,0)
 .S PSOFNDZZ=$P($G(^PS(53,+Y,0)),"^") S PSOFNDZZ=$$UP^XLFSTR(PSOFNDZZ) I PSOFNDZZ'="NON-VA" S PSOPSDIR=1 K PSODIR("PATIENT STATUS"),PSORX("PATIENT STATUS"),PSODIR("PTST NODE")
"RTN","PSODIR1",27,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" G TPBSC
"RTN","PSODIR1",28,0)
 I X[U,$L(X)>1 D:'$G(PSOEDIT) JUMP G PTSTATX
"RTN","PSODIR1",29,0)
 I $D(DUOUT)!$D(DTOUT) S PSODIR("DFLG")=1 G PTSTATX
"RTN","PSODIR1",30,0)
 I Y=-1 W $C(7)," Required" G PTSTATEN
"RTN","PSODIR1",31,0)
 N PSOFNDX,PSOFNDXY,PSOFNDXX,PSOFNDYY
"RTN","PSODIR1",32,0)
 S PSOFNDXY=$G(Y),PSOFNDYY=$G(Y(0))
"RTN","PSODIR1",33,0)
 I '$G(PSOTPBFG),$G(PSOFROM)="NEW" S PSOFNDX=$P($G(^PS(53,+Y,0)),"^") S PSOFNDXX=$$UP^XLFSTR(PSOFNDX) I PSOFNDXX="NON-VA" K PSOFNDX,PSOFNDXY,PSOFNDYY,PSOFNDXX,Y W !!,"Cannot select 'NON-VA' Rx Patient Status!",! G PTSTATEN
"RTN","PSODIR1",34,0)
 S Y=$G(PSOFNDXY),Y(0)=$G(PSOFNDYY)
"RTN","PSODIR1",35,0)
 K PSOFNDXY,PSOFNDYY,PSOFNDX,PSOFNDXX
"RTN","PSODIR1",36,0)
 S (PSODIR("PATIENT STATUS"),PSORX("PATIENT STATUS"))=+Y
"RTN","PSODIR1",37,0)
 S PSODIR("PTST NODE")=Y(0)
"RTN","PSODIR1",38,0)
TPBSC ;
"RTN","PSODIR1",39,0)
 I $G(PSOFDR),$P($G(OR0),"^",17)="C" G PTSTATX
"RTN","PSODIR1",40,0)
 L +^PS(55,PSODFN):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T G PTSTATX
"RTN","PSODIR1",41,0)
 S DIE="55",DR="3////"_+Y,DA=PSODFN D ^DIE K DIE,DA,D0
"RTN","PSODIR1",42,0)
 L -^PS(55,PSODFN)
"RTN","PSODIR1",43,0)
PTSTATX K DTOUT,DUOUT,X,Y,DA
"RTN","PSODIR1",44,0)
 Q
"RTN","PSODIR1",45,0)
SIG(PSODIR) ;
"RTN","PSODIR1",46,0)
 I $G(PSOFDR),$G(PSODIR("SIG"))']"" D SIGOK G:$G(SIGOK)!($G(PSODIR("DFLG"))) SIGX
"RTN","PSODIR1",47,0)
 K DIR,DIC
"RTN","PSODIR1",48,0)
 S DIR(0)="52,10"
"RTN","PSODIR1",49,0)
 S:$G(PSODRUG("SIG"))]"" DIR("B")=PSODRUG("SIG")
"RTN","PSODIR1",50,0)
 S:$G(PSODIR("SIG"))]"" DIR("B")=PSODIR("SIG")
"RTN","PSODIR1",51,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") SIGX
"RTN","PSODIR1",52,0)
 S PSODIR("SIG")=Y,SIGOK=0 K SIG
"RTN","PSODIR1",53,0)
SIGX K X,Y
"RTN","PSODIR1",54,0)
 Q
"RTN","PSODIR1",55,0)
QTY(PSODIR) ;
"RTN","PSODIR1",56,0)
QTYA K DIR,DIC
"RTN","PSODIR1",57,0)
 I $G(CLOZPAT)=1 S DIR("A",1)="Patient Eligible for 14 day supply or 7 day supply with 1 refill"
"RTN","PSODIR1",58,0)
 I $G(CLOZPAT)=2 S DIR("A",1)="Patient Eligible 28 day supply or 14 day supply with 1 refill or 7 day supply with 3 refill"
"RTN","PSODIR1",59,0)
 S DIR(0)="52,7" S:$G(PSODRUG("IEN")) DIR("A")="QTY ( "_$G(PSODRUG("UNIT"))_" ) "_$S($P($G(^PSDRUG(+PSODRUG("IEN"),5)),"^")]"":$P(^PSDRUG(+PSODRUG("IEN"),5),"^"),1:"")
"RTN","PSODIR1",60,0)
 K QTYHLD I $G(PSODIR("QTY"))]"" S QTYHLD=PSODIR("QTY") K PSODIR("QTY")
"RTN","PSODIR1",61,0)
 D:'$G(PSOQTY) QTY^PSOSIG(.PSODIR)
"RTN","PSODIR1",62,0)
 I '$G(SPEED),$G(QTYHLD),'$G(PSODIR("QTY")) S PSODIR("QTY")=QTYHLD
"RTN","PSODIR1",63,0)
 K QTYHLD K:'$G(PSODIR("QTY")) PSODIR("QTY")
"RTN","PSODIR1",64,0)
 I $G(SPEED),$G(PSODIR("QTY"))']"" S PSODIR("QTY")=$P(^PSRX(PSORENW("OIRXN"),0),"^",7)
"RTN","PSODIR1",65,0)
 S:$G(PSODIR("QTY"))]"" DIR("B")=PSODIR("QTY")
"RTN","PSODIR1",66,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") QTYX
"RTN","PSODIR1",67,0)
 I $G(Y),$G(PSODRUG("MAXDOSE"))]"",$G(PSODIR("DAYS SUPPLY")),(Y/+PSODIR("DAYS SUPPLY")>PSODRUG("MAXDOSE")) D  G:$G(PSODIR("DFLG")) QTYX  G QTYA
"RTN","PSODIR1",68,0)
 .W !,$C(7)," Greater than Maximum dose of "_PSODRUG("MAXDOSE")_" per day" D DAYSEN
"RTN","PSODIR1",69,0)
 I $G(PSOFDR),$P($G(OR0),"^",24),$G(PSODIR("QTY")),+Y>$G(PSODIR("QTY")) D  G QTYX
"RTN","PSODIR1",70,0)
 .W !!,"Digitally Signed Order - QTY cannot be increased",!
"RTN","PSODIR1",71,0)
 .N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSODIR1",72,0)
 S PSODIR("QTY")=Y
"RTN","PSODIR1",73,0)
QTYX K X,Y
"RTN","PSODIR1",74,0)
 Q
"RTN","PSODIR1",75,0)
COPIES(PSODIR) ;
"RTN","PSODIR1",76,0)
 K DIR,DIC
"RTN","PSODIR1",77,0)
 S DIR(0)="52,10.6"
"RTN","PSODIR1",78,0)
 S DIR("B")=$S($G(PSODIR("COPIES"))]"":PSODIR("COPIES"),1:1)
"RTN","PSODIR1",79,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") COPIESX
"RTN","PSODIR1",80,0)
 S PSODIR("COPIES")=Y
"RTN","PSODIR1",81,0)
COPIESX K X,Y
"RTN","PSODIR1",82,0)
 Q
"RTN","PSODIR1",83,0)
DAYS(PSODIR) ;
"RTN","PSODIR1",84,0)
DAYSEN K DIR,DIC N PSORFLS
"RTN","PSODIR1",85,0)
 ;PSO*7*266
"RTN","PSODIR1",86,0)
 N S2DS,MXDAYSUP,DFDAYSUP,CSDRUG,NEWTOTDS S S2DS=0
"RTN","PSODIR1",87,0)
 S MXDAYSUP=90,CSDRUG=0
"RTN","PSODIR1",88,0)
 I $D(PSODRUG("IEN")) D
"RTN","PSODIR1",89,0)
 .S MXDAYSUP=$$MXDAYSUP^PSSUTIL1(PSODRUG("IEN"))
"RTN","PSODIR1",90,0)
 .S S2DS=$$CSDS^PSOSIGDS(PSODRUG("IEN")) I S2DS,$P($G(PSODIR("PTST NODE")),"^",3)>29 S S2DS=30
"RTN","PSODIR1",91,0)
 .S PSORFLS=$S($G(PSODIR("# OF REFILLS")):PSODIR("# OF REFILLS"),1:$P($G(PSODIR("RX0")),"^",9))
"RTN","PSODIR1",92,0)
 .I '$D(PSODRUG("DEA")) S PSODRUG("DEA")=$$GET1^DIQ(50,PSODRUG("IEN"),3,"")
"RTN","PSODIR1",93,0)
 .I (PSODRUG("DEA")["2")!(PSODRUG("DEA")["3")!(PSODRUG("DEA")["4")!(PSODRUG("DEA")["5") S CSDRUG=1
"RTN","PSODIR1",94,0)
 S DIR(0)="N^1:"_$S($G(CLOZPAT)=2:28,$G(CLOZPAT)=1:14,$G(CLOZPAT)=0:7,1:MXDAYSUP)
"RTN","PSODIR1",95,0)
 S DFDAYSUP=$S($D(CLOZPAT)&('$G(PSODIR("DAYS SUPPLY"))):7,$G(PSODIR("DAYS SUPPLY"))]"":PSODIR("DAYS SUPPLY"),S2DS>1:S2DS,$P($G(PSODIR("PTST NODE")),"^",3):$P(PSODIR("PTST NODE"),"^",3),1:30)
"RTN","PSODIR1",96,0)
 I DFDAYSUP>MXDAYSUP D  S DFDAYSUP=MXDAYSUP
"RTN","PSODIR1",97,0)
 .W:$G(PSODIR("DAYS SUPPLY")) !!,$C(7),"Invalid DAYS SUPPLY value (",DFDAYSUP,"), resetting it to ",MXDAYSUP," (maximum allowed).",!
"RTN","PSODIR1",98,0)
 S DIR("B")=DFDAYSUP
"RTN","PSODIR1",99,0)
 S DIR("A")="DAYS SUPPLY",DIR("?")="Enter a whole number between 1 and "_$S($G(CLOZPAT)=2:28,$G(CLOZPAT)=1:14,$G(CLOZPAT)=0:7,1:MXDAYSUP)
"RTN","PSODIR1",100,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") DAYSX
"RTN","PSODIR1",101,0)
 I $G(Y),$G(PSODRUG("MAXDOSE"))]"",$G(PSODIR("QTY"))]"",(+PSODIR("QTY")/Y>PSODRUG("MAXDOSE")) D  G DAYSEN
"RTN","PSODIR1",102,0)
 .W !,$C(7)," Greater than Maximum dose of "_PSODRUG("MAXDOSE")_" per day"
"RTN","PSODIR1",103,0)
 I $G(PSOFDR),$P($G(OR0),"^",24),$G(PSODIR("DAYS SUPPLY")),+Y>$G(PSODIR("DAYS SUPPLY")) D  G DAYSX
"RTN","PSODIR1",104,0)
 .W !!,"Digitally Signed Order - Days Supply cannot be increased",!
"RTN","PSODIR1",105,0)
 .N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSODIR1",106,0)
 I $G(PSONEW("FLD"))=8,PSODIR("DAYS SUPPLY")=Y Q
"RTN","PSODIR1",107,0)
 S PSODIR("DAYS SUPPLY")=Y
"RTN","PSODIR1",108,0)
 ; Checking the # Of Refills field value after the Days Supply field was edited
"RTN","PSODIR1",109,0)
 I $D(PSODRUG("IEN")),$G(Y) D
"RTN","PSODIR1",110,0)
 .N PTST
"RTN","PSODIR1",111,0)
 .S PTST=+$G(PSODIR("PATIENT STATUS")) S:'PTST PTST=$P($G(PSODIR("RX0")),"^",3)
"RTN","PSODIR1",112,0)
 .I 'PTST,$G(PSODFN) S PTST=+$G(^PS(55,PSODFN,"PS"))
"RTN","PSODIR1",113,0)
 .I PSORFLS>$$MAXNUMRF^PSOUTIL(PSODRUG("IEN"),Y,PTST,.CLOZPAT) D
"RTN","PSODIR1",114,0)
 .. W !,$C(7),"Invalid number of REFILLS for amount of DAYS SUPPLY.",!,"REFILL EDIT FORCED." D REFILL(.PSODIR)
"RTN","PSODIR1",115,0)
 .. S PSODIR("FLD",9)=PSODIR("# OF REFILLS")
"RTN","PSODIR1",116,0)
 D:$G(PSOFROM)="NEW"
"RTN","PSODIR1",117,0)
 .K QTYHLD S:$G(PSODIR("QTY")) QTYHLD=PSODIR("QTY") D QTY^PSOSIG(.PSODIR)
"RTN","PSODIR1",118,0)
 .I $G(QTYHLD),'$G(PSODIR("QTY")) S PSODIR("QTY")=QTYHLD
"RTN","PSODIR1",119,0)
 .K QTYHLD K:'$G(PSODIR("QTY")) PSODIR("QTY")
"RTN","PSODIR1",120,0)
 S:$G(CLOZPAT)=0 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=0
"RTN","PSODIR1",121,0)
 D:$G(CLOZPAT)=2
"RTN","PSODIR1",122,0)
 .S:PSODIR("DAYS SUPPLY")=28 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=0
"RTN","PSODIR1",123,0)
 .S:PSODIR("DAYS SUPPLY")=14 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=1
"RTN","PSODIR1",124,0)
 .S:PSODIR("DAYS SUPPLY")=7 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=3
"RTN","PSODIR1",125,0)
 D:$G(CLOZPAT)=1
"RTN","PSODIR1",126,0)
 .S:PSODIR("DAYS SUPPLY")=14 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=0
"RTN","PSODIR1",127,0)
 .S:PSODIR("DAYS SUPPLY")=7 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=1
"RTN","PSODIR1",128,0)
 K QTYHLD S:$G(PSODIR("QTY")) QTYHLD=PSODIR("QTY") D QTY^PSOSIG(.PSODIR)
"RTN","PSODIR1",129,0)
 I $G(QTYHLD),'$G(PSODIR("QTY")) S PSODIR("QTY")=QTYHLD
"RTN","PSODIR1",130,0)
 K QTYHLD K:'$G(PSODIR("QTY")) PSODIR("QTY")
"RTN","PSODIR1",131,0)
DAYSX K X,Y
"RTN","PSODIR1",132,0)
 Q
"RTN","PSODIR1",133,0)
REFILL(PSODIR) ;
"RTN","PSODIR1",134,0)
 N PSODAYS,PSOX
"RTN","PSODIR1",135,0)
 S PSODAYS=+$G(PSODIR("DAYS SUPPLY"))
"RTN","PSODIR1",136,0)
 ;Recalculating RFTT if it doesn't exist
"RTN","PSODIR1",137,0)
 I '$G(PSONEW) D
"RTN","PSODIR1",138,0)
 .N I I '$G(RFTT),$G(PSORXED("IRXN")) F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),1,I)) Q:'I  S RFTT=$G(RFTT)+1
"RTN","PSODIR1",139,0)
 ;
"RTN","PSODIR1",140,0)
 I $G(PSODIR("PTST NODE"))="" D
"RTN","PSODIR1",141,0)
 .N X,Y
"RTN","PSODIR1",142,0)
 .S X=$G(PSODIR("PATIENT STATUS")) S:'X X=$P(RX0,"^",3)
"RTN","PSODIR1",143,0)
 .S DIC=53,DIC(0)="QXZ" D ^DIC K DIC
"RTN","PSODIR1",144,0)
 .S:+Y PSODIR("PTST NODE")=Y(0)
"RTN","PSODIR1",145,0)
 .S:'$G(PSODIR("PATIENT STATUS")) PSODIR("PATIENT STATUS")=+Y
"RTN","PSODIR1",146,0)
 S $P(PSODIR("PTST NODE"),"^",4)=+$P($G(PSODIR("PTST NODE")),"^",4)
"RTN","PSODIR1",147,0)
 I $G(OR0) G REFOR
"RTN","PSODIR1",148,0)
 K DIR,DIC,PSOX
"RTN","PSODIR1",149,0)
 ; Controlled Substance
"RTN","PSODIR1",150,0)
 S PSODIR("CS")=0
"RTN","PSODIR1",151,0)
 I (PSODRUG("DEA")["2")!(PSODRUG("DEA")["3")!(PSODRUG("DEA")["4")!(PSODRUG("DEA")["5") D
"RTN","PSODIR1",152,0)
 . S $P(PSODIR("CS"),"^")=1 S:(PSODRUG("DEA")["2") $P(PSODIR("CS"),"^",2)=1
"RTN","PSODIR1",153,0)
 ;
"RTN","PSODIR1",154,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSODIR1",155,0)
 S PSOX=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),PSODAYS,+$G(PSODIR("PATIENT STATUS")),.CLOZPAT)
"RTN","PSODIR1",156,0)
 ;
"RTN","PSODIR1",157,0)
 I '$D(CLOZPAT) I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")["F")!(PSODRUG("DEA")[1)!(PSODRUG("DEA")[2) D  G REFILLX
"RTN","PSODIR1",158,0)
 .I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")[1)!(PSODRUG("DEA")[2)!'$O(^PSRX(+$G(PSODIR("IRXN")),1,0))!('$G(PSOLOKED)) D  Q
"RTN","PSODIR1",159,0)
 ..S VALMSG="No refills allowed on "_$S(PSODRUG("DEA")["F":"this drug.",1:"Narcotics.") W !,VALMSG,!
"RTN","PSODIR1",160,0)
 ..S:$D(PSODIR("FIELD")) PSODIR("FIELD")=0 S PSODIR("# OF REFILLS")=0
"RTN","PSODIR1",161,0)
 ..Q
"RTN","PSODIR1",162,0)
 .;reset refills to the # given
"RTN","PSODIR1",163,0)
 .D RFRSET^PSODIR2
"RTN","PSODIR1",164,0)
 .Q
"RTN","PSODIR1",165,0)
 I $P($G(PSODIR("CS")),"^",2)=1 W !,"No refills allowed on Schedule 2 drugs...",! S:$D(PSODIR("FIELD")) PSODIR("FIELD")=0 S PSODIR("# OF REFILLS")=0 G REFILLX
"RTN","PSODIR1",166,0)
 ;PSO*7*266 make sure PSOX is greater than RFTT
"RTN","PSODIR1",167,0)
 S DIR(0)="N^"_$S($G(RFTT):RFTT,1:0)_":"_$S(+$G(RFTT)>PSOX:RFTT,1:PSOX),DIR("A")="# OF REFILLS"
"RTN","PSODIR1",168,0)
 ;PSO*7*340 Correct Default Value.
"RTN","PSODIR1",169,0)
 S DIR("B")=$S($G(COPY):PSODIR("# OF REFILLS"),$G(PSODIR("N# REF"))]"":PSODIR("N# REF"),$G(PSODIR("# OF REFILLS"))]"":PSODIR("# OF REFILLS"),$G(RFTT)>PSOX:RFTT,1:PSOX)
"RTN","PSODIR1",170,0)
 S DIR("?",1)="Enter a whole number. The maximum number of refills is based on"
"RTN","PSODIR1",171,0)
 S DIR("?")="the DAYS SUPPLY and the PATIENT STATUS fields."
"RTN","PSODIR1",172,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") REFILLX
"RTN","PSODIR1",173,0)
 S (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=Y
"RTN","PSODIR1",174,0)
REFILLX S:$G(PSODIR("# OF REFILLS"))']"" PSODIR("# OF REFILLS")=$S($G(PSODIR("N# REF"))]"":PSODIR("N# REF"),1:PSOX)
"RTN","PSODIR1",175,0)
 K X,Y,PSOX,DEA,PSOCS,RFTT ;PSO*7*340 Kill RFTT
"RTN","PSODIR1",176,0)
 Q
"RTN","PSODIR1",177,0)
 ;OERR CALL
"RTN","PSODIR1",178,0)
REFOR ;
"RTN","PSODIR1",179,0)
 D REFOR^PSODIR3
"RTN","PSODIR1",180,0)
 G REFILLX
"RTN","PSODIR1",181,0)
 Q
"RTN","PSODIR1",182,0)
DIR ;
"RTN","PSODIR1",183,0)
 S (PSODIR("FIELD"),PSODIR("DFLG"))=0
"RTN","PSODIR1",184,0)
 G:$G(DIR(0))']"" DIRX
"RTN","PSODIR1",185,0)
 D ^DIR K DIR,DIE,DIC,DA
"RTN","PSODIR1",186,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)),$L($G(X))'>1!(Y="") S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR1",187,0)
 I $D(DIRUT)!($D(DIROUT)),$G(SPEED) S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR1",188,0)
 I X[U,$L(X)>1 D JUMP
"RTN","PSODIR1",189,0)
DIRX K DIRUT,DTOUT,DUOUT,DIROUT
"RTN","PSODIR1",190,0)
 Q
"RTN","PSODIR1",191,0)
JUMP ;
"RTN","PSODIR1",192,0)
 I $G(PSOEDIT)!($G(OR0)) S PSODIR("DFLG")=1 Q
"RTN","PSODIR1",193,0)
 S X=$P(X,"^",2),DIC="^DD(52,",DIC(0)="QM" D ^DIC K DIC
"RTN","PSODIR1",194,0)
 I Y=-1 S PSODIR("FIELD")=PSODIR("FLD") G JUMPX
"RTN","PSODIR1",195,0)
 I $G(PSONEW1)=0 D JUMP^PSONEW1 G JUMPX
"RTN","PSODIR1",196,0)
 I $G(PSOREF1)=0 D JUMP^PSOREF1 G JUMPX
"RTN","PSODIR1",197,0)
 I $G(PSONEW3)=0 D JUMP^PSONEW3 G JUMPX
"RTN","PSODIR1",198,0)
 I $G(PSORENW3)=0 D JUMP^PSORENW3 G JUMPX
"RTN","PSODIR1",199,0)
JUMPX S X="^"_X
"RTN","PSODIR1",200,0)
 Q
"RTN","PSODIR1",201,0)
SIGOK ;review and decide on oerr sig
"RTN","PSODIR1",202,0)
 I '$O(SIG(0)) S SIGOK=0 Q
"RTN","PSODIR1",203,0)
 K SIGOK W !,"SIG: "
"RTN","PSODIR1",204,0)
 F SIG=0:0 S SIG=$O(SIG(SIG)) W SIG(SIG)_" ",!?5 Q:'$O(SIG(SIG))
"RTN","PSODIR1",205,0)
 K DIR,DIRUT,DUOUT,DTOUT S DIR("B")="YES",DIR(0)="Y",DIR("A")="Is this SIG correct" D ^DIR K DIR I $D(DIRUT) S PSODIR("DFLG")=1 K DIRUT,DUOUT,DTOUT Q
"RTN","PSODIR1",206,0)
 S SIGOK=Y I Y K PSODIR("SIG")
"RTN","PSODIR1",207,0)
 Q
"RTN","PSODIR1",208,0)
PSTPB ;
"RTN","PSODIR1",209,0)
 W !,"New orders entered through this option must have a Patient Status of 'NON-VA'!",!
"RTN","PSODIR1",210,0)
 Q
"RTN","PSODIR3")
0^2^B18185000^B29211268
"RTN","PSODIR3",1,0)
PSODIR3 ;ISC-BIRM/SAB - rx order entry contd ; 7/3/13 4:09pm
"RTN","PSODIR3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**3,46,184,222,206,318,444**;DEC 1997;Build 34
"RTN","PSODIR3",3,0)
 ;
"RTN","PSODIR3",4,0)
EXP(PSODIR) ;
"RTN","PSODIR3",5,0)
 K DIC,DIR
"RTN","PSODIR3",6,0)
 I $G(PSODRUG("EXPIRATION DATE"))]"" S Y=PSODRUG("EXPIRATION DATE") X ^DD("DD") S PSORX("EXPIRATION DATE")=Y
"RTN","PSODIR3",7,0)
 S DIR("A")="EXPIRES",DIR("B")=$S($G(PSORX("EXPIRATION DATE"))]"":PSORX("EXPIRATION DATE"),1:"T+6M")
"RTN","PSODIR3",8,0)
 S DIR(0)="D^NOW::EX",DIR("?")="Both the month and date are required." D ^DIR
"RTN","PSODIR3",9,0)
 G:PSODIR("DFLG")!PSODIR("FIELD") EXPX
"RTN","PSODIR3",10,0)
 S PSODIR("EXPIRATION DATE")=Y
"RTN","PSODIR3",11,0)
EXPX K X,Y
"RTN","PSODIR3",12,0)
 Q
"RTN","PSODIR3",13,0)
 ;
"RTN","PSODIR3",14,0)
MW(PSODIR) ;
"RTN","PSODIR3",15,0)
 K DIR,DIC
"RTN","PSODIR3",16,0)
 S DIR(0)="52,11"
"RTN","PSODIR3",17,0)
 S DIR("B")=$S($G(PSORX("MAIL/WINDOW"))]"":PSORX("MAIL/WINDOW"),1:"WINDOW")
"RTN","PSODIR3",18,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") MWX
"RTN","PSODIR3",19,0)
 I $G(Y(0))']"" S PSODIR("DFLG")=1 G MWX
"RTN","PSODIR3",20,0)
 S PSODIR("MAIL/WINDOW")=Y,PSORX("MAIL/WINDOW")=Y(0)
"RTN","PSODIR3",21,0)
 I $G(PSORX("EDIT"))]"",PSODIR("MAIL/WINDOW")'="W" K PSODIR("METHOD OF PICK-UP")
"RTN","PSODIR3",22,0)
MW1 G:PSODIR("MAIL/WINDOW")'="W"!('$P($G(PSOPAR),"^",12)) MWX
"RTN","PSODIR3",23,0)
 S DIR(0)="52,35O"
"RTN","PSODIR3",24,0)
 S:$G(PSORX("METHOD OF PICK-UP"))]"" DIR("B")=PSORX("METHOD OF PICK-UP")
"RTN","PSODIR3",25,0)
 D DIR G:PSODIR("DFLG") MWX
"RTN","PSODIR3",26,0)
 I X[U W !,"Cannot jump to another field ..",! G MW1
"RTN","PSODIR3",27,0)
 S (PSODIR("METHOD OF PICK-UP"),PSORX("METHOD OF PICK-UP"))=Y
"RTN","PSODIR3",28,0)
MWX K X,Y
"RTN","PSODIR3",29,0)
 Q
"RTN","PSODIR3",30,0)
 ;
"RTN","PSODIR3",31,0)
FILLDT(PSODIR) ;
"RTN","PSODIR3",32,0)
 K DIR,DIC
"RTN","PSODIR3",33,0)
 S DIR("A")="FILL DATE",DIR("B")=$S($G(PSORX("FILL DATE"))]"":PSORX("FILL DATE"),1:"TODAY")
"RTN","PSODIR3",34,0)
 S DIR(0)="D^"_$S($G(PSODIR("ISSUE DATE"))]"":PSODIR("ISSUE DATE"),1:DT)_$S($G(DUZ("AG"))="I":":"_DT_":EX",1:"::EX")
"RTN","PSODIR3",35,0)
 S DIR("?",1)="The earliest fill date allowed is determined by the ISSUE DATE,"
"RTN","PSODIR3",36,0)
 S DIR("?",2)="the FILL DATE cannot be before the ISSUE DATE."
"RTN","PSODIR3",37,0)
 S DIR("?")="Both the month and date are required."
"RTN","PSODIR3",38,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") FILLDTX
"RTN","PSODIR3",39,0)
 S PSODIR("FILL DATE")=Y
"RTN","PSODIR3",40,0)
 X ^DD("DD") S PSORX("FILL DATE")=Y
"RTN","PSODIR3",41,0)
FILLDTX K X,Y
"RTN","PSODIR3",42,0)
 Q
"RTN","PSODIR3",43,0)
 ;
"RTN","PSODIR3",44,0)
CLERK(PSODIR) ;
"RTN","PSODIR3",45,0)
 I $G(DUZ("AG"))'="I",$G(DUZ) S PSODIR("CLERK CODE")=DUZ,PSORX("CLERK CODE")=$P($G(^VA(200,DUZ,0)),"^") G CLERKX
"RTN","PSODIR3",46,0)
 K DIR,DIC
"RTN","PSODIR3",47,0)
 S DIR("A")="CLERK",DIR("B")=$S($G(PSORX("CLERK CODE"))]"":PSORX("CLERK CODE"),1:$P($G(^VA(200,DUZ,0)),"^",2)),DIR(0)="52,16"
"RTN","PSODIR3",48,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") CLERKX
"RTN","PSODIR3",49,0)
 S PSODIR("CLERK CODE")=+Y,PSORX("CLERK CODE")=$P(Y,"^")
"RTN","PSODIR3",50,0)
CLERKX Q
"RTN","PSODIR3",51,0)
 ;
"RTN","PSODIR3",52,0)
DIR ;
"RTN","PSODIR3",53,0)
 S PSODIR("FIELD")=0
"RTN","PSODIR3",54,0)
 G:$G(DIR(0))']"" DIRX
"RTN","PSODIR3",55,0)
 D ^DIR K DIR,DIE,DIC,DA
"RTN","PSODIR3",56,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)),$L($G(X))'>1!(Y="") S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR3",57,0)
 I X[U,$L(X)>1 D JUMP
"RTN","PSODIR3",58,0)
DIRX K DIRUT,DTOUT,DUOUT,DIROUT,PSOX
"RTN","PSODIR3",59,0)
 Q
"RTN","PSODIR3",60,0)
 ;
"RTN","PSODIR3",61,0)
JUMP ;
"RTN","PSODIR3",62,0)
 I $G(PSOEDIT)!($G(OR0)) S PSODIR("DFLG")=1 Q
"RTN","PSODIR3",63,0)
 S X=$P(X,"^",2),DIC="^DD(52,",DIC(0)="QM" D ^DIC K DIC
"RTN","PSODIR3",64,0)
 I Y=-1 S PSODIR("FIELD")=PSODIR("FLD") G JUMPX
"RTN","PSODIR3",65,0)
 I $G(PSONEW1)=0 D JUMP^PSONEW1 G JUMPX
"RTN","PSODIR3",66,0)
 I $G(PSONEW3)=0 D JUMP^PSONEW3 G JUMPX
"RTN","PSODIR3",67,0)
 I $G(PSORENW3)=0 D JUMP^PSORENW3 G JUMPX
"RTN","PSODIR3",68,0)
JUMPX S X="^"_X
"RTN","PSODIR3",69,0)
 Q
"RTN","PSODIR3",70,0)
 ;Continued from PSODIR1, Tag REFOR, Added PSOCS set and changed G REFILLX references to a QUIT
"RTN","PSODIR3",71,0)
REFOR ;
"RTN","PSODIR3",72,0)
 N PSOX
"RTN","PSODIR3",73,0)
 I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A"&($G(PSODRUG("DEA"))'["B")!($G(PSODRUG("DEA"))["F")!($G(PSODRUG("DEA"))[1)!($G(PSODRUG("DEA"))[2) D  Q
"RTN","PSODIR3",74,0)
 .S VALMSG="No refills allowed on "_$S($G(PSODRUG("DEA"))["A":"this narcotic drug.",1:"this drug.")
"RTN","PSODIR3",75,0)
 .W !,VALMSG,!
"RTN","PSODIR3",76,0)
 .S:$D(PSODIR("FIELD")) PSODIR("FIELD")=0 S PSODIR("# OF REFILLS")=0
"RTN","PSODIR3",77,0)
 ;
"RTN","PSODIR3",78,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSODIR3",79,0)
 S PSOX=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),+$G(PSODIR("DAYS SUPPLY")),+$G(PSODIR("PATIENT STATUS")),.CLOZPAT)
"RTN","PSODIR3",80,0)
 ;
"RTN","PSODIR3",81,0)
 I $D(CLOZPAT) D
"RTN","PSODIR3",82,0)
 .S (PSODIR("# OF REFILLS"),PSODIR("N# REF"))=PSOX
"RTN","PSODIR3",83,0)
 S DIR(0)="N^0:"_PSOX,DIR("A")="# OF REFILLS"
"RTN","PSODIR3",84,0)
 S DIR("B")=$S($G(POERR)&($G(PSODIR("# OF REFILLS"))):PSODIR("# OF REFILLS"),$G(PSODIR("N# REF"))]"":PSODIR("N# REF"),$G(PSODIR("# OF REFILLS"))]"":PSODIR("# OF REFILLS"),1:PSOX)
"RTN","PSODIR3",85,0)
 S DIR("?")="Enter a whole number.  The maximum is set by the DAYS SUPPLY field."
"RTN","PSODIR3",86,0)
 D DIR Q:PSODIR("DFLG")!PSODIR("FIELD")
"RTN","PSODIR3",87,0)
 S (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=Y
"RTN","PSODIR3",88,0)
 Q
"RTN","PSOHELP")
0^3^B49812789^B53907821
"RTN","PSOHELP",1,0)
PSOHELP ;BHAM ISC/SAB-outpatient utility routine ; 10/17/07 7:41am
"RTN","PSOHELP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**3,23,29,48,46,117,131,222,268,206,276,282,444**;DEC 1997;Build 34
"RTN","PSOHELP",3,0)
 ;External reference ^PS(51 supported by DBIA 2224
"RTN","PSOHELP",4,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOHELP",5,0)
 ;External reference ^PS(56 supported by DBIA 2229
"RTN","PSOHELP",6,0)
 ;External reference ^PSNPPIP supported by DBIA 2261
"RTN","PSOHELP",7,0)
 ;
"RTN","PSOHELP",8,0)
XREF D XREF^PSOHELP3
"RTN","PSOHELP",9,0)
 Q
"RTN","PSOHELP",10,0)
SIG ;checks PI for RXs
"RTN","PSOHELP",11,0)
 K VALMSG
"RTN","PSOHELP",12,0)
 I $E(X)=" " D EN^DDIOL("Leading spaces should not entered in the Patient Instructions! ","","$C(7),!") S VALMSG="There are leading spaces in Patient Instructions!"
"RTN","PSOHELP",13,0)
SIGONE K INS1 Q:$L(X)<1  F Z0=1:1:$L(X," ") G:Z0="" EN S Z1=$P(X," ",Z0) D  G:'$D(X) EN
"RTN","PSOHELP",14,0)
 .I $L(Z1)>32 W $C(7),!?5,"MAX OF 32 CHARACTERS ALLOWED BETWEEN SPACES.",! K X Q
"RTN","PSOHELP",15,0)
 .D:$D(X)&($G(Z1)]"")  S INS1=$G(INS1)_" "_Z1
"RTN","PSOHELP",16,0)
 ..S Z1=$$UPPER^PSOSIG(Z1) ;*282 Provider Comments
"RTN","PSOHELP",17,0)
 ..S Y=$O(^PS(51,"B",Z1,0)) Q:'Y!($P($G(^PS(51,+Y,0)),"^",4)>1)  S Z1=$P(^PS(51,Y,0),"^",2)
"RTN","PSOHELP",18,0)
 ..I $G(^PS(51,+Y,9))]"" S Y=$P(X," ",Z0-1),Y=$E(Y,$L(Y)) S:Y>1 Z1=^(9)
"RTN","PSOHELP",19,0)
EN K Z1,Z0
"RTN","PSOHELP",20,0)
 Q
"RTN","PSOHELP",21,0)
SSIG ;other lang. mods
"RTN","PSOHELP",22,0)
 K VALMSG
"RTN","PSOHELP",23,0)
 I $E(X)=" " D EN^DDIOL("Leading spaces should not entered in the Patient Instructions! ","","$C(7),!") S VALMSG="There are leading spaces in Patient Instructions!"
"RTN","PSOHELP",24,0)
 K SINS1 Q:$L(X)<1  F Z0=1:1:$L(X," ") G:Z0="" EX S Z1=$P(X," ",Z0) D  G:'$D(X) EX
"RTN","PSOHELP",25,0)
 .I $L(Z1)>32 W $C(7),!?5,"MAX OF 32 CHARACTERS ALLOWED BETWEEN SPACES.",! K X Q
"RTN","PSOHELP",26,0)
 .D:$D(X)&($G(Z1)]"")  S SINS1=$G(SINS1)_" "_Z1
"RTN","PSOHELP",27,0)
 ..S Z1=$$UPPER^PSOSIG(Z1) ;*282 Provider Comments
"RTN","PSOHELP",28,0)
 ..S Y=$O(^PS(51,"B",Z1,0)) Q:'Y!($P($G(^PS(51,+Y,0)),"^",4)>1)  S Z1=$P(^PS(51,Y,0),"^",2)
"RTN","PSOHELP",29,0)
 ..I $G(^PS(51,+Y,4))]"" S Z1=^PS(51,+Y,4) ;,Y=$P(X," ",Z0-1),Y=$E(Y,$L(Y)) S:Y>1 Z1=^(9)
"RTN","PSOHELP",30,0)
EX K Z1,Z0
"RTN","PSOHELP",31,0)
 Q
"RTN","PSOHELP",32,0)
QTY ;Check quantity dispensed against inventory
"RTN","PSOHELP",33,0)
 Q:'$G(PSODRUG("IEN"))
"RTN","PSOHELP",34,0)
 S Z0=$S($G(PSODRUG("IEN"))]"":PSODRUG("IEN"),$G(PSXYES):$P(^PSRX(ZRX,0),"^",6),$D(^PSRX(DA,0)):+$P(^(0),"^",6),1:0)
"RTN","PSOHELP",35,0)
 I $D(^PSDRUG("AQ",Z0)),(+X'=X) K X,Z0 Q
"RTN","PSOHELP",36,0)
 S Z1=$S($D(^PSDRUG(Z0,660.1)):^(660.1),1:0)+(+X) D:X>Z1 EN^DDIOL("  Greater Than Current Inventory!","","$C(7)") K Z1
"RTN","PSOHELP",37,0)
 S ZX=X,ZZ0=$G(D0),D0=Z0
"RTN","PSOHELP",38,0)
 S Y(18,2)=$S($D(^PSDRUG(D0,660)):^(660),1:""),Y(18,1)=$S($D(^(660.1)):^(660.1),1:"")
"RTN","PSOHELP",39,0)
 S X=$P(Y(18,1),"^",1),X=$S($P(Y(18,2),"^",5):X/$P(Y(18,2),"^",5),1:"*******")
"RTN","PSOHELP",40,0)
 S X=$J(X,0,2)
"RTN","PSOHELP",41,0)
 D:X<$S($D(^PSDRUG(Z0,660)):+^(660),1:1) EN^DDIOL("  Below Reorder Level.","","$C(7)") S X=ZX,D0=$G(ZZ0) K ZZ0,Z0,ZX
"RTN","PSOHELP",42,0)
 Q
"RTN","PSOHELP",43,0)
HELP ;qty help
"RTN","PSOHELP",44,0)
 G:$G(PSOFDR) HLP
"RTN","PSOHELP",45,0)
 S Z0=$S($G(PSODRUG("IEN"))]"":PSODRUG("IEN"),$G(PSXYES):$P(^PSRX(ZRX,0),"^",6),$D(^PSRX(DA,0)):$P(^PSRX(DA,0),"^",6),1:0)
"RTN","PSOHELP",46,0)
HLP S Z0=+$G(PSODRUG("IEN"))  I $D(^PSDRUG("AQ",Z0)) D EN^DDIOL("This is a CMOP drug. The quantity may not contain alpha characters (i.e.; ML)","","!!") D EN^DDIOL("or more than two fractional decimal places (i.e.; .01).","","!") D  K Z0 Q
"RTN","PSOHELP",47,0)
 .D EN^DDIOL("Enter a number between 0 and 99999999 inclusive. The total entry cannot","","!") D EN^DDIOL("exceed 11 characters.","","!")
"RTN","PSOHELP",48,0)
 D EN^DDIOL("Enter a whole number between 0 and 99999999 inclusive.  Alpha characters are","","!!")
"RTN","PSOHELP",49,0)
 D EN^DDIOL("not allowed, and the entry cannot exceed 11 characters, or contain more than","","!") D EN^DDIOL("two fractional decimal places (i.e.; .01).","","!")
"RTN","PSOHELP",50,0)
 K Z0
"RTN","PSOHELP",51,0)
 Q
"RTN","PSOHELP",52,0)
ADD ;add/edited local drug/drug interactions
"RTN","PSOHELP",53,0)
 W ! S DIC("A")="Select Drug Interaction: ",DIC(0)="AEMQL",DLAYGO=56
"RTN","PSOHELP",54,0)
 S (DIC,DIE)="^PS(56,",DIC("S")="I '$P(^(0),""^"",5)" D ^DIC G:"^"[X QU G:Y<0 ADD S DA=+Y,DR="[PSO INTERACT]" L +^PS(56,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !,"Entry is being edited by another user. Try Later!",! G ADD
"RTN","PSOHELP",55,0)
 D ^DIE L:$G(DA) -^PS(56,DA) K DA G ADD
"RTN","PSOHELP",56,0)
QU L -^PS(56,DA) K X,DIC,DIE,DA
"RTN","PSOHELP",57,0)
 Q
"RTN","PSOHELP",58,0)
CRI ;change drug interaction severity to critical from significant
"RTN","PSOHELP",59,0)
 W ! S DIC("A")="Select Drug Interaction: ",DIC(0)="AEQM",(DIC,DIE)="^PS(56,",DIC("S")="I $P(^(0),""^"",4)=2" D ^DIC G:"^"[X QU G:Y<0 CRI S DA=+Y,DR=3
"RTN","PSOHELP",60,0)
 L +^PS(56,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !,"Entry is being edited by another user. Try Later!",! G CRI
"RTN","PSOHELP",61,0)
 D ^DIE L -^PS(56,DA) K DA G CRI
"RTN","PSOHELP",62,0)
 G QU
"RTN","PSOHELP",63,0)
 Q
"RTN","PSOHELP",64,0)
MAX S:$G(EXH) P(7)=$P(^PSRX(DA,0),"^",8),P(5)=$P(^(0),"^",6),P(2)=+$P(^(0),"^",3) S:P(2) PTST=$G(^PS(53,P(2),0)),PTDY=$P($G(^(0)),"^",3),PTRF=$P($G(^(0)),"^",4)
"RTN","PSOHELP",65,0)
 S PSODEA=$P(^PSDRUG(P(5),0),"^",3),CS=0
"RTN","PSOHELP",66,0)
 I $D(CLOZPAT) S MAX=$S(CLOZPAT=2&($P(^PSRX(DA,0),"^",8)=14):1,CLOZPAT=2&($P(^PSRX(DA,0),"^",8)=7):3,CLOZPAT=1&($P(^PSRX(DA,0),"^",8)=7):1,1:0),MIN=0 Q
"RTN","PSOHELP",67,0)
 I PSODEA["A"&(PSODEA'["B")!(PSODEA["F")!(PSODEA[1)!(PSODEA[2) D EN^DDIOL("No refills allowed on "_$S(PSODEA["A":"this narcotic drug.",1:"this drug."),"","!") D EN^DDIOL(" ","","!") S $P(^PSRX(DA,0),"^",9)=0 K X,Y,PSODEA,CS,PTST Q
"RTN","PSOHELP",68,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSOHELP",69,0)
 S MAX=$$MAXNUMRF^PSOUTIL(+$G(P(5)),+$G(P(7)),+$G(P(2)),.CLOZPAT)
"RTN","PSOHELP",70,0)
 I $D(X) S MIN=0 I $D(DA) F REF=0:0 S REF=$O(^PSRX(DA,1,REF)) Q:'REF  I $D(^(REF,0)) S MIN=MIN+1
"RTN","PSOHELP",71,0)
 I $G(EXH) D EN^DDIOL("Enter a number Between "_MIN_" AND "_MAX_".","","!?10") K P(2),P(5),P(7),MAX,MAX1,MIN,REF
"RTN","PSOHELP",72,0)
 Q
"RTN","PSOHELP",73,0)
 ;
"RTN","PSOHELP",74,0)
REF S PSRF=X,P(7)=$P(^PSRX(DA,0),"^",8),P(5)=$P(^(0),"^",6),P(2)=+$P(^(0),"^",3) S:P(2) PTST=$G(^PS(53,P(2),0)) S PTDY=$P(^(0),"^",3),PTRF=$P(^(0),"^",4)
"RTN","PSOHELP",75,0)
 D MAX Q:'$D(X)  I (+X'=X)!(X<0)!(X>MAX)!(X?.E1"."1N.N) D EN^DDIOL(" ** MAX REFILLS ALLOWED ARE "_MAX_" ** ","","$C(7)") K X
"RTN","PSOHELP",76,0)
 I $D(X),X<MIN D EN^DDIOL(" ** PATIENT HAS ALREADY RECEIVED "_MIN_" REFILLS ** ","","$C(7)") K X
"RTN","PSOHELP",77,0)
 D DAYS^PSOUTLA
"RTN","PSOHELP",78,0)
 K PTDY,PTRF,MAX,DAYS,PSDAYS,PSODEA,PSOX,PSOX1,PSDY,PSDY1,DEA,CS,PTST,PSRF,MIN,REF,P(2),P(7),P(5),MAX1
"RTN","PSOHELP",79,0)
 Q
"RTN","PSOHELP",80,0)
PAT ;patient field screen in file 52
"RTN","PSOHELP",81,0)
 N DIC,DIE S DFN=X D INP^VADPT,DEM^VADPT
"RTN","PSOHELP",82,0)
 I $P(VADM(6),"^") D EN^DDIOL("PATIENT DIED "_$P(VADM(6),"^",2),"","$C(7),!?10") D EN^DDIOL(" ","","!") K X,DFN Q
"RTN","PSOHELP",83,0)
 I $P(VAIN(4),"^") D EN^DDIOL("PATIENT IS AN INPATIENT ON WARD "_$P(VAIN(4),"^",2)_" !!","","$C(7),!?10") K DIR D DIR K VA,VADN,VAIN Q
"RTN","PSOHELP",84,0)
 E  S X=DFN K DFN,DIRUT,DTOUT,DUOUT
"RTN","PSOHELP",85,0)
 Q
"RTN","PSOHELP",86,0)
DIR S DIR(0)="Y",DIR("B")="YES",DIR("A")="DO YOU WISH TO CONTINUE" D ^DIR K DIR
"RTN","PSOHELP",87,0)
 K:'Y X S:Y X=DFN K DFN,DIRUT,DTOUT,DUOUT,VA,VADM,VAIN
"RTN","PSOHELP",88,0)
 Q
"RTN","PSOHELP",89,0)
BG ;prevents editing of display groups with patients from name to ticket
"RTN","PSOHELP",90,0)
 S $P(^PS(59.3,DA,0),"^",2)=PDP W !,$C(7),"The display cannot be changed from NAME to TICKET when patients are",!,"already in the Display Group.  All patients must be purged and re-entered.",!,"Ticket numbers must be issued !!",! K Y,PDP
"RTN","PSOHELP",91,0)
 Q
"RTN","PSOHELP",92,0)
CLNAP ;quits action profile
"RTN","PSOHELP",93,0)
 Q
"RTN","PSOHELP",94,0)
PRMI ;prints medication instruction sheets.  select drug.
"RTN","PSOHELP",95,0)
 S X="PSNPPIP" X ^%ZOSF("TEST") I '$T S VALMBCK="",VALMSG="Medication Instruction Sheets Not Installed!" Q
"RTN","PSOHELP",96,0)
 I $G(PSODFN) N PSNDFN S PSNDFN=PSODFN
"RTN","PSOHELP",97,0)
 W !! K PSNPPI("MESSAGE") D FULL^VALM1,^PSNPPIP S VALMBCK="R"
"RTN","PSOHELP",98,0)
 I $G(PSNPPI("MESSAGE"))]"" D
"RTN","PSOHELP",99,0)
 .K DIR W PSNPPI("MESSAGE"),! S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DIRUT,PSNPPI("MESSGAE")
"RTN","PSOHELP",100,0)
 Q
"RTN","PSOHELP",101,0)
PRMID ;prints medication instruction sheets.  pass in drug.
"RTN","PSOHELP",102,0)
 N RX0,RXN  ;*276
"RTN","PSOHELP",103,0)
 S RXN=$P($G(PSOLST(ORN)),"^",2) Q:RXN=""  ;*276
"RTN","PSOHELP",104,0)
 I $T(ENOP^PSNPPIP)']"" S VALMBCK="",VALMSG="Medication Instruction Sheets Not Installed!" Q
"RTN","PSOHELP",105,0)
 K PSNPPI("MESSAGE") D FULL^VALM1
"RTN","PSOHELP",106,0)
 S RX0=$G(^PSRX(RXN,0))  ;*276
"RTN","PSOHELP",107,0)
 W !! D ENOP^PSNPPIP($P(RX0,"^",6),$G(^PSRX(RXN,"TN")),$P(RX0,"^"),PSODFN)
"RTN","PSOHELP",108,0)
 S VALMBCK="R" I $G(PSNPPI("MESSAGE"))]"" D
"RTN","PSOHELP",109,0)
 .K DIR W PSNPPI("MESSAGE"),! S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DIRUT,PSNPPI("MESSGAE")
"RTN","PSOHELP",110,0)
 Q
"RTN","PSOHELP1")
0^4^B49158758^B53295057
"RTN","PSOHELP1",1,0)
PSOHELP1 ;BIR/SAB-OUTPATIENT HELP TEXT/UTILITY ROUTINE 2 ;11/09/92
"RTN","PSOHELP1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**23,36,88,146,227,222,408,444**;DEC 1997;Build 34
"RTN","PSOHELP1",3,0)
 ;External reference ^DIC(19.2 supported by DBIA 1472
"RTN","PSOHELP1",4,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOHELP1",5,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOHELP1",6,0)
 ;External reference $$MXDAYSUP^PSSUTIL1 supported by DBIA 6229
"RTN","PSOHELP1",7,0)
 ;
"RTN","PSOHELP1",8,0)
2001 N PSOHLP S PSOHLP(1,"F")="!!"
"RTN","PSOHELP1",9,0)
 S PSOHLP(1)="Enter the lowest prescription number for this site."
"RTN","PSOHELP1",10,0)
 S PSOHLP(2,"F")="!"
"RTN","PSOHELP1",11,0)
 S PSOHLP(2)="If this is the first time you are entering this field,"
"RTN","PSOHELP1",12,0)
 S PSOHLP(3,"F")="!"
"RTN","PSOHELP1",13,0)
 S PSOHLP(3)="you should pick a number LARGER than the last prescription number used."
"RTN","PSOHELP1",14,0)
 S PSOHLP(4,"F")="!!"
"RTN","PSOHELP1",15,0)
 D WRITE
"RTN","PSOHELP1",16,0)
 Q
"RTN","PSOHELP1",17,0)
 ;
"RTN","PSOHELP1",18,0)
2002 N PSOHLP S PSOHLP(1,"F")="!!"
"RTN","PSOHELP1",19,0)
 S PSOHLP(1)="Enter the largest acceptable prescription number for this site."
"RTN","PSOHELP1",20,0)
 S PSOHLP(2,"F")="!"
"RTN","PSOHELP1",21,0)
 S PSOHLP(2)="The difference between this number and the lowest prescription"
"RTN","PSOHELP1",22,0)
 S PSOHLP(3,"F")="!"
"RTN","PSOHELP1",23,0)
 S PSOHLP(3)="number should be substantial. The system will not allow numbers"
"RTN","PSOHELP1",24,0)
 S PSOHLP(4,"F")="!"
"RTN","PSOHELP1",25,0)
 S PSOHLP(4)="larger than the one you choose. It will give a warning message"
"RTN","PSOHELP1",26,0)
 S PSOHLP(5,"F")="!"
"RTN","PSOHELP1",27,0)
 S PSOHLP(5)="and not allow entry of any more prescriptions."
"RTN","PSOHELP1",28,0)
 S PSOHLP(6,"F")="!!"
"RTN","PSOHELP1",29,0)
 D WRITE
"RTN","PSOHELP1",30,0)
 Q
"RTN","PSOHELP1",31,0)
 ;
"RTN","PSOHELP1",32,0)
2003 N PSOHLP S PSOHLP(1,"F")="!!"
"RTN","PSOHELP1",33,0)
 S PSOHLP(1)="Enter the last prescription number used."
"RTN","PSOHELP1",34,0)
 S PSOHLP(2,"F")="!"
"RTN","PSOHELP1",35,0)
 S PSOHLP(2)="If you are entering this for the first time, this number"
"RTN","PSOHELP1",36,0)
 S PSOHLP(3,"F")="!"
"RTN","PSOHELP1",37,0)
 S PSOHLP(3)="should be the same as the number you entered for LOW RX#."
"RTN","PSOHELP1",38,0)
 S PSOHLP(4,"F")="!"
"RTN","PSOHELP1",39,0)
 S PSOHLP(4)="The system will take this number, increment it by one"
"RTN","PSOHELP1",40,0)
 S PSOHLP(5,"F")="!"
"RTN","PSOHELP1",41,0)
 S PSOHLP(5)="until it finds a number that has not been used, and then"
"RTN","PSOHELP1",42,0)
 S PSOHLP(6,"F")="!"
"RTN","PSOHELP1",43,0)
 S PSOHLP(6)="use that number for the next prescription."
"RTN","PSOHELP1",44,0)
 S PSOHLP(7,"F")="!!"
"RTN","PSOHELP1",45,0)
 D WRITE
"RTN","PSOHELP1",46,0)
 Q
"RTN","PSOHELP1",47,0)
WRITE ;EN^DDIOL call
"RTN","PSOHELP1",48,0)
 D EN^DDIOL(.PSOHLP) K PSOHLP
"RTN","PSOHELP1",49,0)
 Q
"RTN","PSOHELP1",50,0)
AUTOQ ;entry point to queue all background jobs
"RTN","PSOHELP1",51,0)
 D:0 RESET1^PSOTPHL1  ;placed out of order by PSO*7*227
"RTN","PSOHELP1",52,0)
 D AUTO^PSOAUTOC ;ques auto cancel job
"RTN","PSOHELP1",53,0)
 D SETUP^PSOAUTOC ;ques nightly cost compile
"RTN","PSOHELP1",54,0)
 D SETUP1^PSOAUTOC ;ques nightly mgmt compile
"RTN","PSOHELP1",55,0)
 D QUP,CLO ;ques amis compile
"RTN","PSOHELP1",56,0)
 D SETUP^PSOHLEXP ;ques exipration status update
"RTN","PSOHELP1",57,0)
 D AUTO^PSOSUDEL ;ques job to deleted rxs printed from 52.5
"RTN","PSOHELP1",58,0)
 D AUTO^PSOSPML0 ;ques job to transmit CS Rx's to the states
"RTN","PSOHELP1",59,0)
CLO K Y,C,D,D0,DI,DQ,DA,DIE,DR,DIC,Y,X,PSOTM,PSOOPTN,%DT,PSOPTN
"RTN","PSOHELP1",60,0)
 Q
"RTN","PSOHELP1",61,0)
QUP K %DT,DIC,DTOUT S DIC(0)="XZM",DIC="^DIC(19.2,",X="PSO AMIS COMPILE" D ^DIC
"RTN","PSOHELP1",62,0)
 I +Y>0 D EDIT^XUTMOPT("PSO AMIS COMPILE") G CLO
"RTN","PSOHELP1",63,0)
 D RESCH^XUTMOPT("PSO AMIS COMPILE","","","24H","L"),EDIT^XUTMOPT("PSO AMIS COMPILE")
"RTN","PSOHELP1",64,0)
 Q
"RTN","PSOHELP1",65,0)
EXP ;reset "P","A" xref in 55 from cancel option
"RTN","PSOHELP1",66,0)
 Q:$G(REA)="C"
"RTN","PSOHELP1",67,0)
 S PCD=+$P($G(^PSRX(DA,3)),"^",5) I 'PCD D  K EXP,PCD,IFN Q
"RTN","PSOHELP1",68,0)
 .S (IFN,EXP)=0
"RTN","PSOHELP1",69,0)
 .F  S EXP=$O(^PS(55,PSODFN,"P","A",EXP)) Q:'EXP  F  S IFN=$O(^PS(55,PSODFN,"P","A",EXP,IFN)) Q:'IFN  I IFN=DA K ^PS(55,PSODFN,"P","A",EXP,DA) S ^PS(55,PSODFN,"P","A",$P(^PSRX(DA,2),"^",6),DA)=""
"RTN","PSOHELP1",70,0)
 K ^PS(55,PSODFN,"P","A",PCD,DA) S ^PS(55,PSODFN,"P","A",$P(^PSRX(DA,2),"^",6),DA)="",$P(^PSRX(DA,3),"^",5)=""
"RTN","PSOHELP1",71,0)
 K PCD Q
"RTN","PSOHELP1",72,0)
SREF ;set "P","A" xref in 55 from fileman
"RTN","PSOHELP1",73,0)
 I $P($G(^PSRX(X,"STA")),"^")=12,'$P($G(^PSRX(X,3)),"^",5) D  Q
"RTN","PSOHELP1",74,0)
 .F PX=0:0 S PA=$O(^PSRX(X,"A",PX)) Q:'PX  S:$P(^PSRX(X,"A",PX,0),"^",2)="C" PCD=$P($P(^PSRX(X,"A",PX,0),"^"),".")
"RTN","PSOHELP1",75,0)
 .I $G(PCD) S ^PS(55,DA(1),"P","A",PCD,X)="",$P(^PSRX(X,3),"^",5)=PCD
"RTN","PSOHELP1",76,0)
 .E  S:$P($G(^PSRX(X,2)),"^",6) ^PS(55,DA(1),"P","A",$P(^PSRX(X,2),"^",6),X)=""
"RTN","PSOHELP1",77,0)
 .K PCD,PX
"RTN","PSOHELP1",78,0)
 I $P($G(^PSRX(X,"STA")),"^")=12,$P($G(^PSRX(X,3)),"^",5) S ^PS(55,DA(1),"P","A",$P(^PSRX(X,3),"^",5),X)="" Q
"RTN","PSOHELP1",79,0)
 S:$P($G(^PSRX(X,2)),"^",6) ^PS(55,DA(1),"P","A",$P(^PSRX(X,2),"^",6),X)=""
"RTN","PSOHELP1",80,0)
 Q
"RTN","PSOHELP1",81,0)
KREF ;kill "P","A" xref in 55 from fileman
"RTN","PSOHELP1",82,0)
 K:+$P($G(^PSRX(X,2)),"^",6) ^PS(55,DA(1),"P","A",+$P(^PSRX(X,2),"^",6),X)
"RTN","PSOHELP1",83,0)
 I $P($G(^PSRX(X,"STA")),"^")=12,'$P($G(^PSRX(X,3)),"^",5) D  K PCD,PX Q
"RTN","PSOHELP1",84,0)
 .F PX=0:0 S A=$O(^PSRX(X,"A",PX)) Q:'PX  S:$P(^PSRX(X,"A",PX,0),"^",2)="C" PCD=$P($P(^PSRX(X,"A",PX,0),"^"),".")
"RTN","PSOHELP1",85,0)
 .I $G(PCD) K ^PS(55,DA(1),"P","A",PCD,X)
"RTN","PSOHELP1",86,0)
 I $P($G(^PSRX(X,"STA")),"^")=12,$P($G(^PSRX(X,3)),"^",5) K ^PS(55,DA(1),"P","A",$P(^PSRX(X,3),"^",5),X)
"RTN","PSOHELP1",87,0)
 Q
"RTN","PSOHELP1",88,0)
DAYS ; INPUT TRANSFORM for DAYS SUPPLY field (#8) in the PRESCRIPTION file (#52)
"RTN","PSOHELP1",89,0)
 N PSMAX,DRUGIEN
"RTN","PSOHELP1",90,0)
 S DRUGIEN=+$P(^PSRX(DA,0),"^",6)
"RTN","PSOHELP1",91,0)
 I $P($G(^PSDRUG(DRUGIEN,0)),"^",4),$P(^PSRX(DA,0),"^",7)/X>$P($G(^PSDRUG(DRUGIEN,0)),"^",4) D EN^DDIOL("Max Daily Dose of "_$P($G(^(0)),"^",4)_" Exceeded","","$C(7),!?5") D EN^DDIOL(" ","","!")
"RTN","PSOHELP1",92,0)
 S PSDAYS=$P(^PSRX(DA,0),"^",8),PSRF=+$P(^(0),"^",9),PTST=$G(^PS(53,$P(^(0),"^",3),0)),PTDY=$P(PTST,"^",3),PTRF=$P(PTST,"^",4),PSODEA=$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^",3)
"RTN","PSOHELP1",93,0)
 S CS=0 I (PSODEA[2)!(PSODEA[3)!(PSODEA[4)!(PSODEA[5) S CS=1
"RTN","PSOHELP1",94,0)
 I $G(CLOZPAT)=1,'PSRF,X>14 K X D EN^DDIOL("     14 Day Supply Max for Clozapine Prescriptions.","","$C(7),!!") Q
"RTN","PSOHELP1",95,0)
 I $G(CLOZPAT)=0,'PSRF,X>7 K X D EN^DDIOL("     7 Day Supply Max for Clozapine Prescriptions.","","$C(7),!!") Q
"RTN","PSOHELP1",96,0)
 I $G(CLOZPAT)=1,X'=7,PSRF K X D EN^DDIOL("     Day Supply Must Equal 7 with 1 refill for Clozapine Prescriptions.","","$C(7),!!") Q
"RTN","PSOHELP1",97,0)
 I $G(CLOZPAT)=1,'PSRF,X>14 K X D EN^DDIOL("     14 Day Supply Max for Clozapine Prescriptions.","","$C(7),!!") Q
"RTN","PSOHELP1",98,0)
 I $G(CLOZPAT)=2,'PSRF,X>28 K X D EN^DDIOL("     28 Day Supply Max for Clozapine Prescriptions.","","$C(7),!!") Q
"RTN","PSOHELP1",99,0)
 I $G(CLOZPAT)=2,PSRF=1,X>14 K X D EN^DDIOL("     Day Supply Must Equal 14 with 1 refill for Clozapine Prescriptions.","","$C(7),!!") Q
"RTN","PSOHELP1",100,0)
 I $G(CLOZPAT)=2,PSRF=3,X>7 K X D EN^DDIOL("     Day Supply Must Equal 7 with 3 refill for Clozapine Prescriptions.","","$C(7),!!") Q
"RTN","PSOHELP1",101,0)
 ;
"RTN","PSOHELP1",102,0)
 ; Checking Maximum Day Supply value for the Drug
"RTN","PSOHELP1",103,0)
 I X>$$MXDAYSUP^PSSUTIL1(DRUGIEN) D  Q
"RTN","PSOHELP1",104,0)
 . K X D EN^DDIOL("  DAYS SUPPLY exceeds the maximum allowed ("_$$MXDAYSUP^PSSUTIL1(DRUGIEN)_") for "_$$GET1^DIQ(50,DRUGIEN,.01)_".","","$C(7),!!") Q
"RTN","PSOHELP1",105,0)
 ;
"RTN","PSOHELP1",106,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSOHELP1",107,0)
 S MAX=$$MAXNUMRF^PSOUTIL(DRUGIEN,X,+$P(^PSRX(DA,0),"^",3),.CLOZPAT)
"RTN","PSOHELP1",108,0)
 I PSRF>MAX S DS=X D
"RTN","PSOHELP1",109,0)
 .D FULL^VALM1,EN^DDIOL(PSRF_" refills are not correct for a "_DS_" day supply.","","$C(7),!!")
"RTN","PSOHELP1",110,0)
 .D EN^DDIOL("Please enter correct # of refills for a "_DS_" day supply. Max refills allowed is "_MAX_".","","!") D EN^DDIOL(" ","","!")
"RTN","PSOHELP1",111,0)
 .K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,X,Y,DIRUT S VALMBCK="R"
"RTN","PSOHELP1",112,0)
 K PSTMAX,DS D EDSTAT^PSOUTLA
"RTN","PSOHELP1",113,0)
 K MAX,DAYS,PSDAYS,PSODEA,PSOX,PSOX1,PSDY,PSDY1,DEA,CS,PTST,PSRF,PTRF,PTDY
"RTN","PSOHELP1",114,0)
 Q
"RTN","PSOHELP1",115,0)
DAYS1 ; INPUT TRANSFORM for DAYS SUPPLY field (#1.1) in the REFILL sub-file (#52.1) of the PRESCRIPTION file (#52)
"RTN","PSOHELP1",116,0)
 N PSRMAX,DRUGIEN,CS
"RTN","PSOHELP1",117,0)
 S DRUGIEN=+$P(^PSRX(DA(1),0),"^",6)
"RTN","PSOHELP1",118,0)
 S PSRF=$P(^PSRX(DA(1),0),"^",9),PTST=$G(^PS(53,$P(^(0),"^",3),0)),PTDY=$P(PTST,"^",3),PTRF=$P(PTST,"^",4)
"RTN","PSOHELP1",119,0)
 S PSDAYS=$P(^PSRX(DA(1),1,DA,0),"^",10),PSODEA=$P(^PSDRUG(DRUGIEN,0),"^",3)
"RTN","PSOHELP1",120,0)
 S CS=0 I (PSODEA[2)!(PSODEA[3)!(PSODEA[4)!(PSODEA[5) S CS=1
"RTN","PSOHELP1",121,0)
 ;
"RTN","PSOHELP1",122,0)
 ; Checking Maximum Day Supply value for the Drug
"RTN","PSOHELP1",123,0)
 I X>$$MXDAYSUP^PSSUTIL1(DRUGIEN) D  Q
"RTN","PSOHELP1",124,0)
 . K X D EN^DDIOL("     DAYS SUPPLY exceeds the maximum allowed ("_$$MXDAYSUP^PSSUTIL1(DRUGIEN)_") for "_$$GET1^DIQ(50,DRUGIEN,.01)_".","","$C(7),!!") Q
"RTN","PSOHELP1",125,0)
 ;
"RTN","PSOHELP1",126,0)
 K DS,MAX,DAYS,PSDAYS,PSODEA,PSOX,PSOX1,PSDY,PSDY1,DEA,CS,PTST,PSRF,PTDY,PTRF
"RTN","PSOHELP1",127,0)
 Q
"RTN","PSOMGCM1")
0^29^B39462059^B39573969
"RTN","PSOMGCM1",1,0)
PSOMGCM1 ;BHAM ISC/JMB,SAB - management data compile/recompile ;4/15/05 3:10pm
"RTN","PSOMGCM1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,28,175,185,198,444**;DEC 1997;Build 34
"RTN","PSOMGCM1",3,0)
 ;Ref. to $$RXSUM^FBRXUTL supp. by IA# 4395
"RTN","PSOMGCM1",4,0)
 ;Ref. to ^PSDRUG(, supp. by IA# 221
"RTN","PSOMGCM1",5,0)
 ;PSO*198 correct begin date to previous day @ time 999999
"RTN","PSOMGCM1",6,0)
 ;
"RTN","PSOMGCM1",7,0)
END K ^TMP($J),%DT,AVGCAT,AVGEQFL,AVGFEE,AVGST,CAT,CATA,CATC,CATCOST,COST,DA,DATE,DIC,DINUM,DFN,DIRUT,DIV,DV,EQCOST,EQFL,EQPREQ,DRUG,EDT,FEE,FCOST,INV,MAIL,METH,NEW,METH,METHAD,OTH,PCAT,PHYS,PP,PPCOST,PREQ,PDATE,RECOM
"RTN","PSOMGCM1",8,0)
 K QTY30,QTY60,QTY90,QTY90P,QTYOVR90,REC,R,REF,RX0,RXF,RXPREQ,SDT,ST,STAFF,STCOST,SUB,VAEL,WIND,AVGMETH,COSTPST,METHCOST,PCPP,NODE1,X,Y,ZTDESC,ZTDTH,ZTRTN,ZTSAVE
"RTN","PSOMGCM1",9,0)
 K TFIL,TDAYS,TFTY,TFCT,TY,NDT,DAYS,COM,STN S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOMGCM1",10,0)
 Q
"RTN","PSOMGCM1",11,0)
PURG ;purge data for a date range
"RTN","PSOMGCM1",12,0)
 W !,"Purge Management Statistics",!! S SDT=$O(^PS(59.12,0)) I $D(SDT) S Y=SDT D DD^%DT S %DT("B")=Y
"RTN","PSOMGCM1",13,0)
 S %DT(0)=-DT,%DT("A")="Starting date: " S %DT="EPXA" D ^%DT G:"^"[X END G RECOM:'Y S SDT=Y K %DT(0) S Y=SDT D DD^%DT S SY=Y K %DT("B"),Y
"RTN","PSOMGCM1",14,0)
PDT W ! S %DT(0)=SDT,%DT("A")="  Ending date: " D ^%DT G:"^"[X END G:Y<0 PDT S EDT=Y W !
"RTN","PSOMGCM1",15,0)
 W !,$C(7),$C(7) S Y=EDT D DD^%DT W !!!,"Purge from "_SY_" to "_Y,!
"RTN","PSOMGCM1",16,0)
 S DIR("A")="Are you sure",DIR(0)="Y",DIR("B")="N" D ^DIR K DIR I $G(DIRUT)!('Y) K EDT,SDT,SY,Y W !,$C(7),"No data has been purged." Q
"RTN","PSOMGCM1",17,0)
 S ZTDTH="",ZTRTN="P^PSOMGCM1",ZTDESC="Outpatient Pharmacy Management Data Purge",ZTIO="" F G="SDT","EDT" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOMGCM1",18,0)
 D ^%ZTLOAD W:$D(ZTSK) !!,"Task Queued !",! K SDT,EDT,G,ZTSK,ZTIO S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOMGCM1",19,0)
 Q
"RTN","PSOMGCM1",20,0)
P S DIK="^PS(59.12," F DA=SDT-1:0 S DA=$O(^PS(59.12,DA)) Q:'DA!(DA>EDT)  D ^DIK
"RTN","PSOMGCM1",21,0)
 K DIK Q
"RTN","PSOMGCM1",22,0)
TSK ;initialize nightly mgmt. compile job
"RTN","PSOMGCM1",23,0)
 D SETUP1^PSOAUTOC
"RTN","PSOMGCM1",24,0)
 W ! K DIR S DIR("B")="NO",DIR(0)="Y",DIR("A")="Do you want to compile data prior to yesterday" D ^DIR I 'Y!($D(DIRUT)) G EX
"RTN","PSOMGCM1",25,0)
 D RECOM
"RTN","PSOMGCM1",26,0)
EX K DIR,X,Y
"RTN","PSOMGCM1",27,0)
 Q
"RTN","PSOMGCM1",28,0)
TASK ;compile every night
"RTN","PSOMGCM1",29,0)
 S X1=DT,X2=-1 D C^%DTC S (EDT,SDT)=X K X1,X2 D BEG
"RTN","PSOMGCM1",30,0)
 Q
"RTN","PSOMGCM1",31,0)
QUE S ZTDTH=$H+1_",3600",ZTIO="",ZTRTN="TASK^PSOMGCM1",ZTDESC="Outpatient Pharmacy Daily Compile of Management Data",ZTIO=""
"RTN","PSOMGCM1",32,0)
 D ^%ZTLOAD W:$D(ZTSK)&('$D(ZTQUEUED)) !!,"Task Queued !",! K DAY,SDT,EDT,G,ZTSK,ZTIO S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOMGCM1",33,0)
 Q
"RTN","PSOMGCM1",34,0)
DAY ;recompile by day
"RTN","PSOMGCM1",35,0)
 W ! S %DT(0)=-DT,%DT("A")="Date: " S %DT="EPXA" D ^%DT G:"^"[X END G DAY:'Y S (SDT,EDT)=Y K %DT(0) S COM=1 W !
"RTN","PSOMGCM1",36,0)
 G Q
"RTN","PSOMGCM1",37,0)
RECOM ;recompile data for a date range
"RTN","PSOMGCM1",38,0)
 W ! S %DT(0)=-DT,%DT("A")="Starting date: " S %DT="EPXA" D ^%DT G:"^"[X END G RECOM:'Y S SDT=Y K %DT(0)
"RTN","PSOMGCM1",39,0)
REDT W ! S %DT(0)=SDT,%DT("A")="  Ending date: " D ^%DT G:"^"[X END I Y<0!(Y>DT) W " ??" G REDT
"RTN","PSOMGCM1",40,0)
 S EDT=Y S COM="R" W !
"RTN","PSOMGCM1",41,0)
Q S ZTDTH="",ZTRTN="BEG^PSOMGCM1",ZTDESC="Outpatient Pharmacy Management Data Recompile "_$S(COM:"One Day",1:"Range of Days"),ZTIO="" F G="SDT","EDT" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOMGCM1",42,0)
 D ^%ZTLOAD W:$D(ZTSK) !!,"Task Queued !",! K SDT,EDT,G,ZTSK,ZTIO S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOMGCM1",43,0)
 Q
"RTN","PSOMGCM1",44,0)
BEG S DIK="^PS(59.12,",DA=SDT-1 F  S DA=$O(^PS(59.12,DA)) Q:'DA!(DA>EDT)  D ^DIK
"RTN","PSOMGCM1",45,0)
 K DA,DIK F NDT=SDT:1:EDT D BEG1
"RTN","PSOMGCM1",46,0)
 D FBA G END
"RTN","PSOMGCM1",47,0)
 Q
"RTN","PSOMGCM1",48,0)
 ;PSO*198 seed loop to previous day @ time 999999
"RTN","PSOMGCM1",49,0)
BEG1 K ^TMP($J) D CLE^PSOMGCOM F TY="AL","AM" S PDATE=NDT-1+.999999 F  S PDATE=$O(^PSRX(TY,PDATE)) Q:'PDATE!(PDATE>(NDT_".999999"))  D BEG2
"RTN","PSOMGCM1",50,0)
 S PDATE=NDT D:TFIL ADD,BUILD^PSOMGCOM
"RTN","PSOMGCM1",51,0)
 Q 
"RTN","PSOMGCM1",52,0)
BEG2 S REC=0 F  S REC=$O(^PSRX(TY,PDATE,REC)) Q:'REC  D BEG3
"RTN","PSOMGCM1",53,0)
 Q
"RTN","PSOMGCM1",54,0)
BEG3 Q:'$D(^PSRX(REC,0))  S DA="" F  S DA=$O(^PSRX(TY,PDATE,REC,DA)) Q:DA=""  D
"RTN","PSOMGCM1",55,0)
 .S RX0=^PSRX(REC,0),DFN=$P(RX0,"^",2),ST=$P(RX0,"^",3),PHYS=$P(RX0,"^",4),DRUG=$P(RX0,"^",6),DAYS=$P(RX0,"^",8)
"RTN","PSOMGCM1",56,0)
 .Q:'DFN!('DRUG)  D:TY="AL" COM1^PSOMGCOM D:TY="AM" COM2
"RTN","PSOMGCM1",57,0)
 Q
"RTN","PSOMGCM1",58,0)
COM2 Q:'$P($G(^PSRX(REC,"P",DA,0)),"^",19)
"RTN","PSOMGCM1",59,0)
 S RXF=^PSRX(REC,"P",DA,0),DV=$S($P(RXF,"^",9):$P(RXF,"^",9),1:$O(^PS(59,0))),REF(DV)=REF(DV)+1 S:$P(RXF,"^",2)="W" WIND(DV)=WIND(DV)+1 S:$P(RXF,"^",2)="M" MAIL(DV)=MAIL(DV)+1 S DATE=$P(^PSRX(REC,"P",0),"^")-.01
"RTN","PSOMGCM1",60,0)
 S COST=$P(RXF,"^",4)*$S($P(RXF,"^",11):$P(RXF,"^",11),1:+$P($G(^PSDRUG(+$P(^PSRX(REC,0),"^",6),660)),"^",6))
"RTN","PSOMGCM1",61,0)
 D DAYS^PSOMGCOM,STA^PSOMGCOM
"RTN","PSOMGCM1",62,0)
 Q
"RTN","PSOMGCM1",63,0)
FBA S (STN,DV)=0 S:'$G(DT) DT=$$DT^XLFDT
"RTN","PSOMGCM1",64,0)
 F  S DV=$O(^PS(59,DV)) Q:'DV  D  Q:STN
"RTN","PSOMGCM1",65,0)
 .I '$G(^PS(59,DV,"I"))!(DT'>$G(^PS(59,DV,"I"))) S STN=$P(^("INI"),"^"),STN=+$$GET1^DIQ(4,STN,99)
"RTN","PSOMGCM1",66,0)
 I 'STN S PP="Invalid Related Institution in File #59" G MAIL
"RTN","PSOMGCM1",67,0)
 F PDATE=SDT:1:EDT S PP=$$RXSUM^FBRXUTL(PDATE,STN) Q:+PP<0  D:+PP>0
"RTN","PSOMGCM1",68,0)
 .S PPCOST=$P(PP,"^",2),PP=+PP D SET
"RTN","PSOMGCM1",69,0)
 I +PP<0 S PP=$P(PP,"^",3) G MAIL
"RTN","PSOMGCM1",70,0)
 Q
"RTN","PSOMGCM1",71,0)
MAIL F PSO1=0:0 S PSO1=$O(^XUSEC("PSORPH",PSO1)) Q:'PSO1  S XMY(PSO1)=""
"RTN","PSOMGCM1",72,0)
 Q:$O(XMY(""))=""
"RTN","PSOMGCM1",73,0)
 S XMDUZ="Outpatient Pharmacy Package"
"RTN","PSOMGCM1",74,0)
 S XMSUB="FEE Basis Cost Data - Incomplete Nightly Job"
"RTN","PSOMGCM1",75,0)
 S PP=$E(PP_".                              ",1,42)
"RTN","PSOMGCM1",76,0)
 S PSO(1)="**************************************************"
"RTN","PSOMGCM1",77,0)
 S PSO(2)="*** FEE Basis Cost data was not collected for  ***"
"RTN","PSOMGCM1",78,0)
 S PSO(3)="*** the period "_$E(SDT,4,5)_"/"_$E(SDT,6,7)_"/"_$E(SDT,2,3)_" to "_$E(EDT,4,5)_"/"_$E(EDT,6,7)_"/"_$E(EDT,2,3)_".           ***"
"RTN","PSOMGCM1",79,0)
 S PSO(4)="***                                            ***"
"RTN","PSOMGCM1",80,0)
 S PSO(5)="*** The reason reported was:                   ***"
"RTN","PSOMGCM1",81,0)
 S PSO(6)="*** "_PP_" ***"
"RTN","PSOMGCM1",82,0)
 S PSO(7)="***                                            ***"
"RTN","PSOMGCM1",83,0)
 S PSO(8)="*** You may have to manually recompile this    ***"
"RTN","PSOMGCM1",84,0)
 S PSO(9)="*** data at a later date.                      ***"
"RTN","PSOMGCM1",85,0)
 S PSO(10)="**************************************************"
"RTN","PSOMGCM1",86,0)
 S XMTEXT="PSO(" N DIFROM D ^XMD K XMSUB,XMDUZ,XMTEXT,PSO,PSO1
"RTN","PSOMGCM1",87,0)
 Q
"RTN","PSOMGCM1",88,0)
SET I '$D(^PS(59.12,PDATE,0)) D ADD S DV=0 F  S DV=$O(^PS(59,DV)) Q:'+DV  D
"RTN","PSOMGCM1",89,0)
 .S ^PS(59.12,PDATE,1,DV,0)=DV_"^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0",^PS(59.12,PDATE,2,DV,0)=DV_"^0^0^0^0^0^0^0^0^0^0^0^0^0.0",^PS(59.12,PDATE,3,DV,0)=DV_"^0.00^0.00^0.00^0.00^0.00^0.00^0.00^0.00^0.00"
"RTN","PSOMGCM1",90,0)
 S DV=0,DV=$O(^PS(59,DV)),$P(^PS(59.12,PDATE,2,DV,0),"^",13)=PP,FEE=0
"RTN","PSOMGCM1",91,0)
 F DIV=0:0 S DIV=$O(^PS(59.12,PDATE,2,DIV)) Q:'+DIV  S FEE=FEE+$P(^PS(59.12,PDATE,2,DIV,0),"^",3)
"RTN","PSOMGCM1",92,0)
 S $P(^PS(59.12,PDATE,2,DV,0),"^",14)=$FN($S(FEE=0:100.0,$P(^PS(59.12,PDATE,2,DV,0),"^",13)=0:0,1:(FEE/(FEE+$P(^PS(59.12,$P(PDATE,"."),2,DV,0),"^",13)))*100),"",1)
"RTN","PSOMGCM1",93,0)
 S $P(^PS(59.12,PDATE,3,DV,0),"^",9)=$FN(PPCOST,"",2),$P(^PS(59.12,PDATE,3,DV,0),"^",10)=$FN($S(PPCOST=0!(PP=0):0,1:PPCOST/PP),"",2)
"RTN","PSOMGCM1",94,0)
 Q
"RTN","PSOMGCM1",95,0)
ADD S (X,DINUM)=PDATE,DIC="^PS(59.12,",DIC(0)="L" K DD,DO D FILE^DICN F DV=0:0 S DV=$O(^PS(59,DV)) Q:'+DV  D ADDEM
"RTN","PSOMGCM1",96,0)
 Q
"RTN","PSOMGCM1",97,0)
ADDEM S ^PS(59.12,PDATE,1,0)="^59.121A^"_DV_"^"_TFIL,^PS(59.12,PDATE,1,DV,0)=DV,^PS(59.12,PDATE,1,"B",DV,DV)=""
"RTN","PSOMGCM1",98,0)
 S ^PS(59.12,PDATE,2,0)="^59.122A^"_DV_"^"_TFTY,^PS(59.12,PDATE,2,DV,0)=DV,^PS(59.12,PDATE,2,"B",DV,DV)=""
"RTN","PSOMGCM1",99,0)
 S ^PS(59.12,PDATE,3,0)="^59.123A^"_DV_"^"_TFCT,^PS(59.12,PDATE,3,DV,0)=DV,^PS(59.12,PDATE,3,"B",DV,DV)=""
"RTN","PSOMGCM1",100,0)
 Q
"RTN","PSOMGCOM")
0^5^B21894614^B20999263
"RTN","PSOMGCOM",1,0)
PSOMGCOM ;BHAM ISC/JMB,SAB - management compile/recompile routine ;9/13/05 8:54am
"RTN","PSOMGCOM",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,28,174,221,444**;DEC 1997;Build 34
"RTN","PSOMGCOM",3,0)
 ;External Ref. to ELIG^VADPT is supp. by DBIA# 10061
"RTN","PSOMGCOM",4,0)
 ;External Ref. to ^PSDRUG( is supp. by DBIA# 221
"RTN","PSOMGCOM",5,0)
COM1 D:DA=0 ORI D:DA>0 REF Q:'$D(^PSRX(REC,1,DA,0))&(DA>0)  D STA
"RTN","PSOMGCOM",6,0)
 Q
"RTN","PSOMGCOM",7,0)
ORI Q:'$D(^PSRX(REC,0))  S RX0=^PSRX(REC,0),DV=$S($P($G(^PSRX(REC,2)),"^",9):$P(^PSRX(REC,2),"^",9),1:$O(^PS(59,0)))
"RTN","PSOMGCOM",8,0)
 S NEW(DV)=NEW(DV)+1 S:$P(RX0,"^",11)="W" WIND(DV)=WIND(DV)+1 S:$P(RX0,"^",11)="M" MAIL(DV)=MAIL(DV)+1 S DATE=$P(^PSRX(REC,0),"^",2)-.01
"RTN","PSOMGCOM",9,0)
 S COST=$P(RX0,"^",7)*$S(+$P(RX0,"^",17):$P(RX0,"^",17),1:+$P($G(^PSDRUG(+$P(RX0,"^",6),660)),"^",6))
"RTN","PSOMGCOM",10,0)
 ;W !!!!,REC," ",$$GET1^DIQ(52,REC,.01),"  ",$$GET1^DIQ(52,REC,8)
"RTN","PSOMGCOM",11,0)
 D DAYS Q
"RTN","PSOMGCOM",12,0)
DAYS ;
"RTN","PSOMGCOM",13,0)
 S TFIL=TFIL+1,TDAYS(DV)=$G(TDAYS(DV))+DAYS-(DAYS#30),TFCT=TFCT+COST,EQCOST(DV)=EQCOST(DV)+COST
"RTN","PSOMGCOM",14,0)
 ; - Adding up Equivalent Fills (30-Day count) for each Division
"RTN","PSOMGCOM",15,0)
 S EQFL(DV)=EQFL(DV)+$$MIN^XLFMTH((DAYS\30)+((DAYS#30)>0),12)
"RTN","PSOMGCOM",16,0)
 ;
"RTN","PSOMGCOM",17,0)
 ; - Adding up Specific Fills for each Division
"RTN","PSOMGCOM",18,0)
 I DAYS<31 S QTY30(DV)=QTY30(DV)+1 Q
"RTN","PSOMGCOM",19,0)
 I DAYS>30&(DAYS<61) S QTY60(DV)=QTY60(DV)+1 Q
"RTN","PSOMGCOM",20,0)
 I DAYS>60&(DAYS<91) S QTY90(DV)=QTY90(DV)+1 Q
"RTN","PSOMGCOM",21,0)
 I DAYS>90 S QTYOVR90(DV)=QTYOVR90(DV)+1 Q
"RTN","PSOMGCOM",22,0)
 Q
"RTN","PSOMGCOM",23,0)
 ;
"RTN","PSOMGCOM",24,0)
REF Q:'$D(^PSRX(REC,1,DA,0))  S RXF=^PSRX(REC,1,DA,0),DV=$S($P(RXF,"^",9):$P(RXF,"^",9),1:$O(^PS(59,0))),REF(DV)=REF(DV)+1 S:$P(RXF,"^",2)="W" WIND(DV)=WIND(DV)+1 S:$P(RXF,"^",2)="M" MAIL(DV)=MAIL(DV)+1 S DATE=$P(^PSRX(REC,1,DA,0),"^")-.01
"RTN","PSOMGCOM",25,0)
 S COST=$P(RXF,"^",4)*$S($P(RXF,"^",11):$P(RXF,"^",11),1:+$P($G(^PSDRUG(+$P(^PSRX(REC,0),"^",6),660)),"^",6)) D DAYS
"RTN","PSOMGCOM",26,0)
 Q
"RTN","PSOMGCOM",27,0)
CLE F DV=0:0 S DV=$O(^PS(59,DV)) Q:'+DV  D
"RTN","PSOMGCOM",28,0)
 .S METHAD(DV)=$S($D(^PS(59,DV,5)):$P(^PS(59,DV,5),"^",2),1:0)
"RTN","PSOMGCOM",29,0)
 .S (CATA(DV),CATC(DV),OTH(DV),CAT(DV),CATCOST(DV),QTY30(DV),QTY60(DV),QTY90(DV),QTYOVR90(DV),TDAYS(DV),EQFL(DV),EQCOST(DV))=0
"RTN","PSOMGCOM",30,0)
 .S (METH(DV),METHCOST(DV),PCPP(DV),PP(DV),PPCOST(DV),PREQ(DV),FEE(DV),FCOST(DV),STAFF(DV),STCOST(DV),NEW(DV),REF(DV),WIND(DV),MAIL(DV),INV(DV))=0
"RTN","PSOMGCOM",31,0)
 S (TFIL,TFTY,TFCT)=0 Q
"RTN","PSOMGCOM",32,0)
STA S:$P($G(^PSDRUG(+$P(^PSRX(REC,0),"^",6),0)),"^",3)["I" INV(DV)=INV(DV)+1
"RTN","PSOMGCOM",33,0)
 I $D(METHAD(DV)),DRUG=METHAD(DV) S METH(DV)=METH(DV)+1,METHCOST(DV)=METHCOST(DV)+COST
"RTN","PSOMGCOM",34,0)
 E  K PCAT D CAT
"RTN","PSOMGCOM",35,0)
 I $P($G(^VA(200,+$G(PHYS),"PS")),"^",6)=4 S FEE(DV)=FEE(DV)+1,FCOST(DV)=FCOST(DV)+COST
"RTN","PSOMGCOM",36,0)
 E  S STAFF(DV)=STAFF(DV)+1,STCOST(DV)=STCOST(DV)+COST
"RTN","PSOMGCOM",37,0)
 I '$D(^TMP($J,DV,DFN)) S ^TMP($J,DV,DFN)=$G(PCAT),PREQ(DV)=PREQ(DV)+1
"RTN","PSOMGCOM",38,0)
 Q
"RTN","PSOMGCOM",39,0)
CAT I '$D(^TMP($J,DV,DFN)) D ELIG^VADPT S PCAT=$P($G(VAEL(9)),"^"),CATCOST(DV)=CATCOST(DV)+COST S:PCAT="A" CATA(DV)=CATA(DV)+1 S:PCAT="C" CATC(DV)=CATC(DV)+1 S:PCAT'="A"&(PCAT'="C") OTH(DV)=OTH(DV)+1 Q
"RTN","PSOMGCOM",40,0)
 S PCAT=$G(^TMP($J,DV,DFN)),CATCOST(DV)=CATCOST(DV)+COST S:PCAT="A" CATA(DV)=CATA(DV)+1 S:PCAT="C" CATC(DV)=CATC(DV)+1 S:PCAT'="A"&(PCAT'="C") OTH(DV)=OTH(DV)+1
"RTN","PSOMGCOM",41,0)
 Q
"RTN","PSOMGCOM",42,0)
BUILD ;SET GLOBAL NODE
"RTN","PSOMGCOM",43,0)
 F DV=0:0 S DV=$O(^PS(59,DV)) Q:'+DV  D BLD
"RTN","PSOMGCOM",44,0)
 Q
"RTN","PSOMGCOM",45,0)
BLD ;
"RTN","PSOMGCOM",46,0)
 S CAT(DV)=CATA(DV)+CATC(DV)+OTH(DV)
"RTN","PSOMGCOM",47,0)
 S RXPREQ(DV)=$FN($S(CAT(DV)=0!(PREQ(DV)=0):0,1:CAT(DV)/PREQ(DV)),"",1)
"RTN","PSOMGCOM",48,0)
 S EQPREQ(DV)=$FN($S(EQFL(DV)=0!(PREQ(DV)=0):0,1:EQFL(DV)/PREQ(DV)),"",0)
"RTN","PSOMGCOM",49,0)
 S NODE1=EQFL(DV)_"^"_METH(DV)_"^"_(NEW(DV)+REF(DV))_"^"_(EQFL(DV)+METH(DV))_"^"_PREQ(DV)_"^"_RXPREQ(DV)_"^"_EQPREQ(DV)_"^"_INV(DV)
"RTN","PSOMGCOM",50,0)
 S ^PS(59.12,PDATE,1,DV,0)=DV_"^"_CATA(DV)_"^"_CATC(DV)_"^"_OTH(DV)_"^"_CAT(DV)_"^"_QTY30(DV)_"^"_QTY60(DV)_"^"_QTY90(DV)_"^"_QTYOVR90(DV)_"^"_NODE1
"RTN","PSOMGCOM",51,0)
 ;
"RTN","PSOMGCOM",52,0)
 S COSTPST(DV)=$FN($S(STCOST(DV)=0!(STAFF(DV)=0):0,1:STCOST(DV)/STAFF(DV)),"",2)
"RTN","PSOMGCOM",53,0)
 S ^PS(59.12,PDATE,2,DV,0)=DV_"^^"_FEE(DV)_"^"_STAFF(DV)_"^"_(FEE(DV)+STAFF(DV))_"^"_NEW(DV)_"^"_REF(DV)_"^"_(NEW(DV)+REF(DV))_"^"_WIND(DV)_"^"_MAIL(DV)_"^"_(WIND(DV)+MAIL(DV))_"^^"_PP(DV)_"^"_PCPP(DV)
"RTN","PSOMGCOM",54,0)
 ;
"RTN","PSOMGCOM",55,0)
 S AVGFEE(DV)=$FN($S(FCOST(DV)=0!(FEE(DV)=0):0,1:FCOST(DV)/FEE(DV)),"",2)
"RTN","PSOMGCOM",56,0)
 S AVGST(DV)=$FN($S(STCOST(DV)=0!(STAFF(DV)=0):0,1:STCOST(DV)/STAFF(DV)),"",2)
"RTN","PSOMGCOM",57,0)
 S AVGCAT(DV)=$FN($S(CATCOST(DV)=0!(CAT(DV)=0):0,1:CATCOST(DV)/CAT(DV)),"",2)
"RTN","PSOMGCOM",58,0)
 S AVGEQFL(DV)=$FN($S(EQCOST(DV)=0!(EQFL(DV)=0):0,1:(EQCOST(DV)-METHCOST(DV)/EQFL(DV))),"",2)
"RTN","PSOMGCOM",59,0)
 S AVGMETH(DV)=$FN($S(METHCOST(DV)=0!(METH(DV)=0):0,1:METHCOST(DV)/METH(DV)),"",2)
"RTN","PSOMGCOM",60,0)
 S ^PS(59.12,PDATE,3,DV,0)=DV_"^"_AVGST(DV)_"^"_AVGFEE(DV)_"^"_AVGCAT(DV)_"^"_AVGEQFL(DV)_"^"_AVGMETH(DV)_"^"_$FN((CATCOST(DV)+METHCOST(DV)),"",2)_"^"_$FN(METHCOST(DV),"",2)_"^0.00^0.00"
"RTN","PSOMGCOM",61,0)
 Q
"RTN","PSOMGMN1")
0^27^B12434382^B12723391
"RTN","PSOMGMN1",1,0)
PSOMGMN1 ;BHAM ISC/JMB - MONTHLY MANAGEMENT PRESCRIPTION COUNTS REPORT ; 1/30/93
"RTN","PSOMGMN1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**14,444**;DEC 1997;Build 34
"RTN","PSOMGMN1",3,0)
EN S (CNT,PG)=0 D:ANS="A" PRI D:ANS="S" DV W:ANS="S" @IOF Q
"RTN","PSOMGMN1",4,0)
ENQ S CNT=0 I ANS="A" D PRI,PRI^PSOMGMN2,PRI^PSOMGMN3
"RTN","PSOMGMN1",5,0)
 I ANS="S" S PG=0 D DV S (CNT,PG)=0 D EN^PSOMGMN2 S (CNT,PG)=0 D EN^PSOMGMN3
"RTN","PSOMGMN1",6,0)
 D ^PSOMGMN4 Q
"RTN","PSOMGMN1",7,0)
RPT W:CNT @IOF S PG=PG+1,CNT=CNT+1 U IO W !!?30,"O U T P A T I E N T   P H A R M A C Y   M A N A G E M E N T   R E P O R T",!?56,"PRESCRIPTION COUNTS",?112,"PAGE ",PG
"RTN","PSOMGMN1",8,0)
 W !!?45,"FROM "_$E(SDT,4,5)_"/"_$E(SDT,2,3),?60,"TO "_$E(EDT,4,5)_"/"_$E(EDT,2,3)_"      "_$S('PRT:"DIVISION: "_$P(^PS(59,DIV,0),"^"),1:"ALL DIVISIONS")
"RTN","PSOMGMN1",9,0)
 W !!?9 F K=1:1:15 W $J($P("^^^TOT^30^60^90^>90^EQ^^TOT^TOT^MED^RX/^EQ FL/","^",K),8)
"RTN","PSOMGMN1",10,0)
 W !,"DATE",?9 F K=1:1:15 W $J($P("CAT A^CAT C^OTH^CAT^DAY^DAY^DAY^DAY^FLS^METH^RX^EQ FL^REQ^REQ^REQ","^",K),8)
"RTN","PSOMGMN1",11,0)
 W ! F K=1:1:129 W "="
"RTN","PSOMGMN1",12,0)
 Q
"RTN","PSOMGMN1",13,0)
PRI S T1="0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0",CNT=0,PG=0 F DIV=0:0 S DIV=$O(^PS(59,DIV)) Q:'DIV  D DV
"RTN","PSOMGMN1",14,0)
 D TOT
"RTN","PSOMGMN1",15,0)
 Q
"RTN","PSOMGMN1",16,0)
DV S (BEG,PRT)=0 D RPT S S1(DIV)="0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0" F PDATE=SDT-1:0 S PDATE=$O(^PS(59.12,PDATE)) D:$Y+6>IOSL RPT D:'PDATE!(PDATE>EDT) SUB Q:'PDATE!(PDATE>EDT)  D
"RTN","PSOMGMN1",17,0)
 .S DVMN=DIV_"^"_$E(PDATE,1,5) S:'BEG PRV=DIV_"^"_$E(PDATE,1,5),M1(DVMN)="0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0",BEG=1 I DVMN'=PRV D MON S PRV=DIV_"^"_$E(PDATE,1,5),M1(DVMN)="0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0"
"RTN","PSOMGMN1",18,0)
 .Q:'$G(^PS(59.12,PDATE,1,DIV,0))
"RTN","PSOMGMN1",19,0)
 .D:$G(^PS(59.12,PDATE,1,DIV,0))'=DIV_"^0^0^0^0^0^0^0^^0^0^0^0^0^0^0^0^0" LN
"RTN","PSOMGMN1",20,0)
 I ANS="S" W !!!?17,"FINISHED PRINTING ON: " D NOW^%DTC S Y=% X ^DD("DD") W Y W:RUN="A"&(ANS="S") @IOF
"RTN","PSOMGMN1",21,0)
 Q
"RTN","PSOMGMN1",22,0)
LN F K=2:1:16 D
"RTN","PSOMGMN1",23,0)
 .S $P(M1(DVMN),"^",K)=$P(M1(DVMN),"^",K)+$P(^PS(59.12,PDATE,1,DIV,0),"^",K)
"RTN","PSOMGMN1",24,0)
 .S $P(S1(DIV),"^",K)=$P(S1(DIV),"^",K)+$P(^PS(59.12,PDATE,1,DIV,0),"^",K) S:$D(T1) $P(T1,"^",K)=$P(T1,"^",K)+$P(^PS(59.12,PDATE,1,DIV,0),"^",K)
"RTN","PSOMGMN1",25,0)
 Q
"RTN","PSOMGMN1",26,0)
MON ;PRINT MONTHLY TOTALS
"RTN","PSOMGMN1",27,0)
 W !,$E($P(PRV,"^",2),4,5)_"/"_$E($P(PRV,"^",2),2,3),?9 F K=2:1:14 W $J($P(M1(PRV),"^",K),8)
"RTN","PSOMGMN1",28,0)
 W $J($S($P(M1(PRV),"^",12)=0!($P(M1(PRV),"^",14)=0):0,1:$P(M1(PRV),"^",12)/$P(M1(PRV),"^",14)),8,2)
"RTN","PSOMGMN1",29,0)
 W $J($S($P(M1(PRV),"^",13)=0!($P(M1(PRV),"^",14)=0):0,1:$P(M1(PRV),"^",13)/$P(M1(PRV),"^",14)),8,2)
"RTN","PSOMGMN1",30,0)
 Q
"RTN","PSOMGMN1",31,0)
SUB ;PRINT SUB TOTALS
"RTN","PSOMGMN1",32,0)
 I 'PRT D MON W !?9 F K=1:1:15 W $J("=======",8)
"RTN","PSOMGMN1",33,0)
 W !,$S('PRT:"DIV TOTAL",1:$E($P(^PS(59,DIV,0),"^"),1,8)),?9 F K=2:1:14 W $J($P(S1(DIV),"^",K),8)
"RTN","PSOMGMN1",34,0)
 W $J($S($P(S1(DIV),"^",12)=0!($P(S1(DIV),"^",14)=0):0,1:$P(S1(DIV),"^",12)/$P(S1(DIV),"^",14)),8,2)
"RTN","PSOMGMN1",35,0)
 W $J($S($P(S1(DIV),"^",13)=0!($P(S1(DIV),"^",14)=0):0,1:$P(S1(DIV),"^",13)/$P(S1(DIV),"^",14)),8,2)
"RTN","PSOMGMN1",36,0)
 Q
"RTN","PSOMGMN1",37,0)
TOT ;PRINT GRAND TOTALS
"RTN","PSOMGMN1",38,0)
 S PRT=1 D RPT F DIV=0:0 S DIV=$O(^PS(59,DIV)) Q:'DIV  D SUB
"RTN","PSOMGMN1",39,0)
 W !?9 F K=1:1:15 W $J("=======",8)
"RTN","PSOMGMN1",40,0)
 W !,"GR TOTAL",?9 F K=2:1:14 W $J($P(T1,"^",K),8)
"RTN","PSOMGMN1",41,0)
 W $J($S($P(T1,"^",12)=0!($P(T1,"^",14)=0):0,1:$P(T1,"^",12)/$P(T1,"^",14)),8,2)
"RTN","PSOMGMN1",42,0)
 W $J($S($P(T1,"^",13)=0!($P(T1,"^",14)=0):0,1:$P(T1,"^",13)/$P(T1,"^",14)),8,2)
"RTN","PSOMGMN1",43,0)
 W !!!?17,"FINISHED PRINTING ON: " D NOW^%DTC S Y=% X ^DD("DD") W Y W:RUN'="A" @IOF
"RTN","PSOMGMN1",44,0)
 Q
"RTN","PSOMGRP1")
0^28^B13150824^B13479977
"RTN","PSOMGRP1",1,0)
PSOMGRP1 ;BHAM ISC/JMB - DAILY MANAGEMENT PRESCRIPTION COUNTS REPORT ; 4/1/93
"RTN","PSOMGRP1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**14,444**;DEC 1997;Build 34
"RTN","PSOMGRP1",3,0)
EN S (CNT,PG)=0 D:ANS="A" PRI D:ANS="S" DV W:ANS="S" @IOF Q
"RTN","PSOMGRP1",4,0)
ENQ S CNT=0 S PSOELSE=ANS I ANS="A" D PRI,PRI^PSOMGRP2,PRI^PSOMGRP3
"RTN","PSOMGRP1",5,0)
 I PSOELSE'="A" S PG=0 D DV S (CNT,PG)=0 D EN^PSOMGRP2 S (CNT,PG)=0 D EN^PSOMGRP3
"RTN","PSOMGRP1",6,0)
 K PSOELSE D ^PSOMGRP4 Q
"RTN","PSOMGRP1",7,0)
RPT W:CNT @IOF S PG=PG+1,CNT=CNT+1 U IO W !!?30,"O U T P A T I E N T   P H A R M A C Y   M A N A G E M E N T   R E P O R T",!?56,"PRESCRIPTION COUNTS",?112,"PAGE ",PG
"RTN","PSOMGRP1",8,0)
 W !!?40,"FROM "_$E(SDT,4,5)_"-"_$E(SDT,6,7)_"-"_$E(SDT,2,3),?60,"TO "_$E(EDT,4,5)_"-"_$E(EDT,6,7)_"-"_$E(EDT,2,3)_"      "_$S('PRT:"DIVISION: "_$P(^PS(59,DIV,0),"^"),1:"ALL DIVISIONS")
"RTN","PSOMGRP1",9,0)
 W !!?9 F K=1:1:15 W $J($P("^^^TOT^30^60^90^>90^EQ^^TOT^TOT^MED^RX/^EQ FL/","^",K),8)
"RTN","PSOMGRP1",10,0)
 W !,"DATE",?9 F K=1:1:15 W $J($P("CAT A^CAT C^OTH^CAT^DAY^DAY^DAY^DAY^FLS^METH^RX^EQ FL^REQ^REQ^REQ","^",K),8)
"RTN","PSOMGRP1",11,0)
 W ! F K=1:1:129 W "="
"RTN","PSOMGRP1",12,0)
 Q
"RTN","PSOMGRP1",13,0)
PRI S T1="0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0",CNT=0,PG=0 F DIV=0:0 S DIV=$O(^PS(59,DIV)) Q:'DIV  D DV
"RTN","PSOMGRP1",14,0)
 D TOT
"RTN","PSOMGRP1",15,0)
 Q
"RTN","PSOMGRP1",16,0)
DV S (BEG,PRT)=0 D RPT S S1(DIV)="0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0" F PDATE=SDT-1:0 S PDATE=$O(^PS(59.12,PDATE)) D:$Y+6>IOSL RPT D:'PDATE!(PDATE>EDT) SUB Q:'PDATE!(PDATE>EDT)  D
"RTN","PSOMGRP1",17,0)
 .S DVMN=DIV_"^"_$E(PDATE,1,5) S:'BEG PRV=DIV_"^"_$E(PDATE,1,5),M1(DVMN)="0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0",BEG=1 I DVMN'=PRV D MON S PRV=DIV_"^"_$E(PDATE,1,5),M1(DVMN)="0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0"
"RTN","PSOMGRP1",18,0)
 .W !,$E(PDATE,4,5)_"-"_$E(PDATE,6,8)_"-"_$E(PDATE,2,3),?9
"RTN","PSOMGRP1",19,0)
 .D:$G(^PS(59.12,PDATE,1,DIV,0))'=DIV_"^0^0^0^0^0^0^0^^0^0^0^0^0^0^0^0^0" LN
"RTN","PSOMGRP1",20,0)
 I ANS="S" W !!!?17,"FINISHED PRINTING ON: " D NOW^%DTC S Y=% X ^DD("DD") W Y W:RUN="A"&(ANS="S") @IOF
"RTN","PSOMGRP1",21,0)
 Q
"RTN","PSOMGRP1",22,0)
LN F K=2:1:16 W $J(+$P($G(^PS(59.12,PDATE,1,DIV,0)),"^",K),8) D
"RTN","PSOMGRP1",23,0)
 .S $P(M1(DVMN),"^",K)=$P(M1(DVMN),"^",K)+$P($G(^PS(59.12,PDATE,1,DIV,0)),"^",K)
"RTN","PSOMGRP1",24,0)
 .S $P(S1(DIV),"^",K)=$P(S1(DIV),"^",K)+$P($G(^PS(59.12,PDATE,1,DIV,0)),"^",K) S:$D(T1) $P(T1,"^",K)=$P(T1,"^",K)+$P($G(^PS(59.12,PDATE,1,DIV,0)),"^",K)
"RTN","PSOMGRP1",25,0)
 Q
"RTN","PSOMGRP1",26,0)
MON ;PRINT MONTHLY TOTALS
"RTN","PSOMGRP1",27,0)
 W !?9 F K=1:1:15 W $J("-------",8)
"RTN","PSOMGRP1",28,0)
 W !,"MON TOTAL",?9 F K=2:1:14 W $J($P(M1(PRV),"^",K),8)
"RTN","PSOMGRP1",29,0)
 W $J($S($P(M1(PRV),"^",12)=0!($P(M1(PRV),"^",14)=0):0,1:$P(M1(PRV),"^",12)/$P(M1(PRV),"^",14)),8,2)
"RTN","PSOMGRP1",30,0)
 W $J($S($P(M1(PRV),"^",13)=0!($P(M1(PRV),"^",14)=0):0,1:$P(M1(PRV),"^",13)/$P(M1(PRV),"^",14)),8,2)
"RTN","PSOMGRP1",31,0)
 Q
"RTN","PSOMGRP1",32,0)
SUB ;PRINT SUB TOTALS
"RTN","PSOMGRP1",33,0)
 I 'PRT D MON W !?9 F K=1:1:15 W $J("=======",8)
"RTN","PSOMGRP1",34,0)
 W !,$S('PRT:"DIV TOTAL",1:$E($P(^PS(59,DIV,0),"^"),1,8)),?9 F K=2:1:14 W $J($P(S1(DIV),"^",K),8)
"RTN","PSOMGRP1",35,0)
 W $J($S($P(S1(DIV),"^",12)=0!($P(S1(DIV),"^",14)=0):0,1:$P(S1(DIV),"^",12)/$P(S1(DIV),"^",14)),8,2)
"RTN","PSOMGRP1",36,0)
 W $J($S($P(S1(DIV),"^",13)=0!($P(S1(DIV),"^",14)=0):0,1:$P(S1(DIV),"^",13)/$P(S1(DIV),"^",14)),8,2)
"RTN","PSOMGRP1",37,0)
 Q
"RTN","PSOMGRP1",38,0)
TOT ;PRINT GRAND TOTALS
"RTN","PSOMGRP1",39,0)
 S PRT=1 D RPT F DIV=0:0 S DIV=$O(^PS(59,DIV)) Q:'DIV  D SUB
"RTN","PSOMGRP1",40,0)
 W !?9 F K=1:1:15 W $J("=======",8)
"RTN","PSOMGRP1",41,0)
 W !,"GR TOTAL",?9 F K=2:1:14 W $J($P(T1,"^",K),8)
"RTN","PSOMGRP1",42,0)
 W $J($S($P(T1,"^",12)=0!($P(T1,"^",14)=0):0,1:$P(T1,"^",12)/$P(T1,"^",14)),8,2)
"RTN","PSOMGRP1",43,0)
 W $J($S($P(T1,"^",13)=0!($P(T1,"^",14)=0):0,1:$P(T1,"^",13)/$P(T1,"^",14)),8,2)
"RTN","PSOMGRP1",44,0)
 W !!!?17,"FINISHED PRINTING ON: " D NOW^%DTC S Y=% X ^DD("DD") W Y W:RUN'="A" @IOF
"RTN","PSOMGRP1",45,0)
 Q
"RTN","PSOORCPY")
0^16^B35592105^B34153930
"RTN","PSOORCPY",1,0)
PSOORCPY ;BIR/SAB-copy orders from backdoor ;10/17/96
"RTN","PSOORCPY",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,21,27,32,46,100,117,148,313,411,444**;DEC 1997;Build 34
"RTN","PSOORCPY",3,0)
 ;External reference to LK^ORX2 supported by DBIA 867
"RTN","PSOORCPY",4,0)
 ;External reference to ULK^ORX2 supported by DBIA 867
"RTN","PSOORCPY",5,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSOORCPY",6,0)
 ;External reference to L^PSSLOCK supported by DBIA 2789
"RTN","PSOORCPY",7,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSOORCPY",8,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789
"RTN","PSOORCPY",9,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOORCPY",10,0)
 ;I '$D(^XUSEC("PSORPH",DUZ)) S VALMSG="Invalid Action Selection!",VALMBCK="" Q
"RTN","PSOORCPY",11,0)
 ;
"RTN","PSOORCPY",12,0)
 ; Cleaning up Titration/Maintenance variables (they shouldn't be defined - just to be safe)
"RTN","PSOORCPY",13,0)
 K PSOMTFLG,PSOTITRX
"RTN","PSOORCPY",14,0)
COPY ; Rx Copy Functionality 
"RTN","PSOORCPY",15,0)
 I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2),,.VALMSG,.VALMBCK) Q
"RTN","PSOORCPY",16,0)
 I '$G(PSOMTFLG),$$TITRX^PSOUTL($P(PSOLST(ORN),"^",2))="t" S VALMSG="Cannot Copy a 'Titration Rx'.",VALMBCK="" W $C(7) Q
"RTN","PSOORCPY",17,0)
 I $G(PSOBEDT) W $C(7),$C(7) S VALMSG="Invalid Action at this time !",VALMBCK="" Q
"RTN","PSOORCPY",18,0)
 I $G(PSONACT) W $C(7),$C(7) S VALMSG="No Pharmacy Orderable Item !",VALMBCK="" K PSOCOPY D ^PSOBUILD Q
"RTN","PSOORCPY",19,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSOORCPY",20,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSOORCPY",21,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG G EX
"RTN","PSOORCPY",22,0)
 N VALMCNT K PSOEDIT S (PSOCOPY,COPY,PSORXED,ZZCOPY)=1 D FULL^VALM1
"RTN","PSOORCPY",23,0)
 S PSORXED("DFLG")=0,(RXN,DA,PSORXED("IRXN"))=$P(PSOLST(ORN),"^",2),PSORXED("RX0")=^PSRX(PSORXED("IRXN"),0),PSORXED("RX2")=$G(^(2)),PSORXED("RX3")=$G(^(3)),PSOI=$P($G(^("OR1")),"^"),PSOSIG=$P($G(^("SIG")),"^"),STAT=+^("STA")
"RTN","PSOORCPY",24,0)
 S PSORXED("INS")=$G(^PSRX(PSORXED("IRXN"),"INS"))
"RTN","PSOORCPY",25,0)
 S:$G(^PSRX(PSORXED("IRXN"),"INSS"))]"" PSORXED("SINS")=^PSRX(PSORXED("IRXN"),"INSS")
"RTN","PSOORCPY",26,0)
 S D=0 F  S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORCPY",27,0)
 I '$O(PSORXED("SIG",0)),$G(PSORXED("INS"))]"" S PSORXED("SIG",1)=PSORXED("INS")
"RTN","PSOORCPY",28,0)
 I $G(^PSRX(PSORXED("IRXN"),"TN"))]"" S PSODRUG("TRADE NAME")=^PSRX(PSORXED("IRXN"),"TN")
"RTN","PSOORCPY",29,0)
 ;
"RTN","PSOORCPY",30,0)
 ; - This call copies the dosage into the new order and also split the Maintenance dose (if the case)
"RTN","PSOORCPY",31,0)
 D BLDDOSE(.PSORXED,$G(PSOMTFLG))
"RTN","PSOORCPY",32,0)
 ;
"RTN","PSOORCPY",33,0)
 I $G(^PSDRUG($P(PSORXED("RX0"),"^",6),"I"))]"",^("I")<DT S VALMSG=$S('$G(PSOMTFLG):"Cannot COPY. ",1:"")_"This drug has been inactivated!" S VALMBCK="R" G OUT
"RTN","PSOORCPY",34,0)
 I $P(^PSDRUG($P(PSORXED("RX0"),"^",6),2),"^",3)'["O" S VALMSG=$S('$G(PSOMTFLG):"Cannot COPY. ",1:"")_"Drug no longer used by Outpatient!",VALMBCK="R" G OUT
"RTN","PSOORCPY",35,0)
 ;Check for invalid Dosage
"RTN","PSOORCPY",36,0)
 N PSOOCPRX,PSOOLPF,PSOOLPD,PSONOSIG S PSOOCPRX=PSORXED("IRXN") D CDOSE^PSORENW0
"RTN","PSOORCPY",37,0)
 I PSOOLPF D  S VALMBCK="R" G OUT
"RTN","PSOORCPY",38,0)
 .S VALMSG=$S('$G(PSOMTFLG):"Cannot COPY. ",1:"")_"Invalid Dosage of "_$G(PSOOLPD)
"RTN","PSOORCPY",39,0)
 I PSONOSIG D  S VALMBCK="R" G OUT
"RTN","PSOORCPY",40,0)
 .S VALMSG=$S('$G(PSOMTFLG):"Cannot COPY. ",1:"")_"Missing Sig"
"RTN","PSOORCPY",41,0)
 I '$P($G(^PSDRUG($P(PSORXED("RX0"),"^",6),2)),"^") S VALMBCK="R" G OUT
"RTN","PSOORCPY",42,0)
 S DREN=$P(PSORXED("RX0"),"^",6),PSODAYS=$P(PSORXED("RX0"),"^",8)
"RTN","PSOORCPY",43,0)
 ; Checks if the current Days Supply value is greater than the Maximum Days Supply for the Drug
"RTN","PSOORCPY",44,0)
 I '$G(PSOMTFLG) D
"RTN","PSOORCPY",45,0)
 . S PSORXED("DAYS SUPPLY")=$P(PSORXED("RX0"),"^",8),PSORXED("QTY")=$P(PSORXED("RX0"),"^",7)
"RTN","PSOORCPY",46,0)
 . D DAYSUP^PSOUTIL(DREN,.PSORXED,1)
"RTN","PSOORCPY",47,0)
 S PSORXST=+$P($G(^PS(53,$P(PSORXED("RX0"),"^",3),0)),"^",7)
"RTN","PSOORCPY",48,0)
 S POERR=1 D DRG^PSOORDRG K POERR
"RTN","PSOORCPY",49,0)
 I $G(PSORX("DFLG")) S VALMBCK="R"
"RTN","PSOORCPY",50,0)
 ;
"RTN","PSOORCPY",51,0)
 I $G(PSOMTFLG) D  I $G(PSORXED("DFLG")) S VALMBCK="R" G OUT
"RTN","PSOORCPY",52,0)
 . S PSORXED("DAYS SUPPLY")=PSODAYS,PSORXED("QTY")=+$$GET1^DIQ(52,PSORXED("IRXN"),7)
"RTN","PSOORCPY",53,0)
 . W !!,"New Maintenance Rx (Review Quantity):",!,"Drug: ",$$GET1^DIQ(52,PSORXED("IRXN"),6)
"RTN","PSOORCPY",54,0)
 . D EN^PSOFSIG(.PSORXED,1) W !,"Days Supply: ",PSODAYS
"RTN","PSOORCPY",55,0)
 . N PSOQTY S PSORXED("FLD")=5 D QTY^PSODIR1(.PSORXED) W !
"RTN","PSOORCPY",56,0)
 ;
"RTN","PSOORCPY",57,0)
 D EN^PSOORED1(.PSORXED) I $G(PSORX("FN")) S VALMBCK="Q",PSOFROM="NEW" D DCORD^PSONEW2
"RTN","PSOORCPY",58,0)
 E  S VALMBCK="R"
"RTN","PSOORCPY",59,0)
OUT ;
"RTN","PSOORCPY",60,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOORCPY",61,0)
 K PSOCOPY D ^PSOBUILD,ACT^PSOORNE2
"RTN","PSOORCPY",62,0)
EX S X=PSODFN_";DPT(" D ULK^ORX2
"RTN","PSOORCPY",63,0)
 D UL^PSSLOCK(PSODFN)
"RTN","PSOORCPY",64,0)
 K PSOMSG,PSONEW,PSOSIG,STA,DREN,PSODAYS,PSORXST,PSOCOPY,PSORXED,FST,FLD,IEN,FLN,INCOM,PSOI,COPY,SIG,SIGOK
"RTN","PSOORCPY",65,0)
 K PSODRUG,^TMP("PSOPO",$J),PSOMTFLG
"RTN","PSOORCPY",66,0)
 D CLEAN^PSOVER1,EOJ^PSONEW K ZZCOPY
"RTN","PSOORCPY",67,0)
 Q
"RTN","PSOORCPY",68,0)
LOCK ;
"RTN","PSOORCPY",69,0)
 I $P($G(PSOPLCK),"^")'=0 Q
"RTN","PSOORCPY",70,0)
 W !!,$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2),1:"Another person")_" is working on this patient."
"RTN","PSOORCPY",71,0)
 K DIR S DIR(0)="E",DIR("A")="     Press Return to Continue" D ^DIR K DIR
"RTN","PSOORCPY",72,0)
 Q
"RTN","PSOORCPY",73,0)
 ;
"RTN","PSOORCPY",74,0)
BLDDOSE(PSORXED,MAINTRXF) ; Copies the Dose from Original Rx into Copied/Maintenance Dose Rx
"RTN","PSOORCPY",75,0)
 N DOSEIEN,DOSE
"RTN","PSOORCPY",76,0)
 ; - Copying from the last THEN conjunction (Maintenance Dose Rx)
"RTN","PSOORCPY",77,0)
 ; - For Titration/Maintenance, DOSEIEN = the IEN in the prescription of the last THEN conjunction.
"RTN","PSOORCPY",78,0)
 ; - This value is used as a "seed" for the FOR loop starting point.
"RTN","PSOORCPY",79,0)
 I $G(MAINTRXF) D  Q
"RTN","PSOORCPY",80,0)
 . D LASTTHEN
"RTN","PSOORCPY",81,0)
 . S PSORXED("ENT")=0
"RTN","PSOORCPY",82,0)
 . F  S DOSEIEN=$O(^PSRX(PSORXED("IRXN"),6,DOSEIEN))  Q:'DOSEIEN  D
"RTN","PSOORCPY",83,0)
 . . S DOSE=^PSRX(PSORXED("IRXN"),6,DOSEIEN,0) D
"RTN","PSOORCPY",84,0)
 . . Q:$P(DOSE,"^")']""!($P(DOSE,"^",8)']"")
"RTN","PSOORCPY",85,0)
 . . S PSORXED("ENT")=PSORXED("ENT")+1
"RTN","PSOORCPY",86,0)
 . . D SETDOSE(.PSORXED,DOSEIEN,PSORXED("ENT"))
"RTN","PSOORCPY",87,0)
 . . D EN^PSOFSIG(.PSORXED)
"RTN","PSOORCPY",88,0)
 ;
"RTN","PSOORCPY",89,0)
 ; - Copying dose for Regular Rx Copy
"RTN","PSOORCPY",90,0)
 S PSORXED("ENT")=0
"RTN","PSOORCPY",91,0)
 F DOSEIEN=0:0 S DOSEIEN=$O(^PSRX(PSORXED("IRXN"),6,DOSEIEN)) Q:'DOSEIEN  D
"RTN","PSOORCPY",92,0)
 . S DOSE=^PSRX(PSORXED("IRXN"),6,DOSEIEN,0) D
"RTN","PSOORCPY",93,0)
 . Q:$P(DOSE,"^")']""!($P(DOSE,"^",8)']"")
"RTN","PSOORCPY",94,0)
 . S PSORXED("ENT")=PSORXED("ENT")+1
"RTN","PSOORCPY",95,0)
 . D SETDOSE(.PSORXED,DOSEIEN,PSORXED("ENT"))
"RTN","PSOORCPY",96,0)
 Q
"RTN","PSOORCPY",97,0)
 ;
"RTN","PSOORCPY",98,0)
SETDOSE(PSORXED,DOSEIEN,DOSESEQ) ; Sets the Dose in the PSORXED array
"RTN","PSOORCPY",99,0)
 N DOSE
"RTN","PSOORCPY",100,0)
 S DOSE=^PSRX(PSORXED("IRXN"),6,DOSEIEN,0)
"RTN","PSOORCPY",101,0)
 S PSORXED("DOSE",DOSESEQ)=$P(DOSE,"^")
"RTN","PSOORCPY",102,0)
 S PSORXED("UNITS",DOSESEQ)=$P(DOSE,"^",3)
"RTN","PSOORCPY",103,0)
 S PSORXED("DOSE ORDERED",DOSESEQ)=$P(DOSE,"^",2)
"RTN","PSOORCPY",104,0)
 S PSORXED("ROUTE",DOSESEQ)=$P(DOSE,"^",7)
"RTN","PSOORCPY",105,0)
 S PSORXED("SCHEDULE",DOSESEQ)=$P(DOSE,"^",8)
"RTN","PSOORCPY",106,0)
 S PSORXED("DURATION",DOSESEQ)=$P(DOSE,"^",5)
"RTN","PSOORCPY",107,0)
 S PSORXED("CONJUNCTION",DOSESEQ)=$P(DOSE,"^",6)
"RTN","PSOORCPY",108,0)
 S PSORXED("VERB",DOSESEQ)=$P(DOSE,"^",9)
"RTN","PSOORCPY",109,0)
 I $G(^PSRX(PSORXED("IRXN"),6,DOSEIEN,1))]"" D
"RTN","PSOORCPY",110,0)
 . S PSORXED("ODOSE",DOSESEQ)=^PSRX(PSORXED("IRXN"),6,DOSEIEN,1)
"RTN","PSOORCPY",111,0)
 I $G(PSORXED("DURATION",DOSESEQ))]"" D  K DR,DUR1
"RTN","PSOORCPY",112,0)
 . S DUR1=PSORXED("DURATION",DOSESEQ)
"RTN","PSOORCPY",113,0)
 . S PSORXED("DURATION",DOSESEQ)=$S($E(DUR1,1)'?.N:$E(DUR1,2,99)_$E(DUR1,1),1:DUR1)
"RTN","PSOORCPY",114,0)
 S PSORXED("NOUN",DOSESEQ)=$P(DOSE,"^",4)
"RTN","PSOORCPY",115,0)
 Q
"RTN","PSOORCPY",116,0)
 ;
"RTN","PSOORCPY",117,0)
LASTTHEN ; Determine the IEN of the last THEN conjunction on this prescription and set DOSEIEN to its value.
"RTN","PSOORCPY",118,0)
 N LASTTHEN,LAST
"RTN","PSOORCPY",119,0)
 S LASTTHEN="" F  S LASTTHEN=$O(^PSRX(PSORXED("IRXN"),6,LASTTHEN),-1) Q:LASTTHEN=""!($G(DOSEIEN)'="")  D
"RTN","PSOORCPY",120,0)
 . S DOSEIEN=""
"RTN","PSOORCPY",121,0)
 . S LAST=^PSRX(PSORXED("IRXN"),6,LASTTHEN,0)
"RTN","PSOORCPY",122,0)
 . I $P(LAST,"^",6)="T" S DOSEIEN=LASTTHEN Q
"RTN","PSOORCPY",123,0)
 Q
"RTN","PSOORED1")
0^6^B64951982^B73633714
"RTN","PSOORED1",1,0)
PSOORED1 ;ISC-BHAM/SAB - edit orders from backdoor ;5/10/07 8:25am
"RTN","PSOORED1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**5,23,46,78,114,117,131,146,223,148,244,249,268,206,313,444**;DEC 1997;Build 34
"RTN","PSOORED1",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOORED1",4,0)
 ;External reference ^PS(50.7 supported by DBIA 2223
"RTN","PSOORED1",5,0)
 ;
"RTN","PSOORED1",6,0)
 ;*244 call to remove DC'd Rx's from Rx ien strings
"RTN","PSOORED1",7,0)
 ;
"RTN","PSOORED1",8,0)
EN(PSORENW) ;
"RTN","PSOORED1",9,0)
 N LST,ORD,ORN K VALMBCK,PSORX("FN") S PSOAC=1,(PSORX("QFLG"),PSORX("DFLG"))=0 ;D DREN^PSOORNW2,INIT
"RTN","PSOORED1",10,0)
 D INIT
"RTN","PSOORED1",11,0)
 D @$S($P(PSOPAR,"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN")
"RTN","PSOORED1",12,0)
 I '$D(PSONEW("RX #")),'$P(PSOPAR,"^",7) D PAUSE^VALM1 K VALMSG,PSONEW("QFLG") S VALMBCK="Q" Q
"RTN","PSOORED1",13,0)
 I '$D(PSONEW("RX #")) K VALMSG D DEL^PSONEW,PAUSE^VALM1 S VALMBCK="Q" Q
"RTN","PSOORED1",14,0)
 S PSORENW("RX #")=PSONEW("RX #") I '$P(PSOPAR,"^",7) D  Q:$G(PSONEW("DFLG"))!($G(PSONEW("QFLG")))
"RTN","PSOORED1",15,0)
 .S PSOX=PSORENW("RX #") D CHECK^PSONRXN
"RTN","PSOORED1",16,0)
 I $G(PSONEW("DFLG"))!$G(PSONEW("QFLG")) D DEL^PSONEW,PAUSE^VALM1 S VALMBCK="Q" K PSORENW Q
"RTN","PSOORED1",17,0)
 D EN^PSOORNE1(.PSORENW) I '$G(PSORX("FN")) D:$P($G(PSOPAR),"^",7)=1  S VALMBCK="Q" Q
"RTN","PSOORED1",18,0)
 .S DIE="^PS(59,",DA=PSOSITE,PSOY=$O(PSONEW("OLD LAST RX#","")),PSOX=PSONEW("OLD LAST RX#",PSOY)
"RTN","PSOORED1",19,0)
 .L +^PS(59,+PSOSITE,PSOY):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSOORED1",20,0)
 .S DR=$S(PSOY=8:"2003////"_PSOX,PSOY=3:"1002.1////"_PSOX,1:"2003////"_PSOX)
"RTN","PSOORED1",21,0)
 .D:PSOX<$P(^PS(59,+PSOSITE,PSOY),"^",3) ^DIE K DIE,X,Y L -^PS(59,+PSOSITE,PSOY)
"RTN","PSOORED1",22,0)
 .I $D(PSONEW("RX #")) L -^PSRX("B",PSONEW("RX #"))
"RTN","PSOORED1",23,0)
 .K PSOX,PSOY Q
"RTN","PSOORED1",24,0)
 Q:$G(COPY)
"RTN","PSOORED1",25,0)
TRY S $P(^PSRX(PSORENW("OIRXN"),"STA"),"^")=15,DA=PSORENW("OIRXN")
"RTN","PSOORED1",26,0)
 S $P(^PSRX(DA,3),"^",5)=DT,$P(^PSRX(DA,3),"^",10)=$P(^PSRX(DA,3),"^")
"RTN","PSOORED1",27,0)
 D REVERSE^PSOBPSU1(DA,,"DC",7),CAN^PSOTPCAN(DA)
"RTN","PSOORED1",28,0)
 D RMP^PSOCAN3                ;*244
"RTN","PSOORED1",29,0)
 ;cancel/discontinue action
"RTN","PSOORED1",30,0)
 S PHARM="",STAT="RP",COMM="Prescription discontinued due to editing." D EN^PSOHLSN1(DA,STAT,PHARM,COMM,PSONOOR) K STAT,PHARM,COMM
"RTN","PSOORED1",31,0)
 S ACOM="Discontinued due to editing. New Rx created "_$P(^PSRX(PSORENW("IRXN"),0),"^")_"."
"RTN","PSOORED1",32,0)
 I $G(^PSRX(DA,"H"))]"" D
"RTN","PSOORED1",33,0)
 .I $P(^PSRX(DA,"STA"),"^")=3!($P(^("STA"),"^")=16) D
"RTN","PSOORED1",34,0)
 ..S DIE=52,DR="22///"_$P(^PSRX(DA,3),"^") D ^DIE S ACOM="Discontinued due to editing while on hold. " K:$P(^PSRX(DA,"H"),"^") ^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA)
"RTN","PSOORED1",35,0)
 ..S ^PSRX(DA,"H")=""
"RTN","PSOORED1",36,0)
 S RXDA=DA,(DA,SUSDA)=$O(^PS(52.5,"B",RXDA,0)) D:DA
"RTN","PSOORED1",37,0)
 .S SUSD=$P($G(^PS(52.5,DA,0)),"^",2)
"RTN","PSOORED1",38,0)
 .S:+$G(^PS(52.5,DA,"P"))'=1 ACOM="Discontinued due to editing while suspended."
"RTN","PSOORED1",39,0)
 .I $O(^PSRX(RXDA,1,0)) S DA=RXDA D:'$G(^PS(52.5,+SUSDA,"P")) REF^PSOCAN2
"RTN","PSOORED1",40,0)
 .S DA=SUSDA,DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOORED1",41,0)
 K SUSD,SUSDA S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2) D
"RTN","PSOORED1",42,0)
 .S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOORED1",43,0)
 .S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOORED1",44,0)
 .D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_(ACNT+1)_"^"_(ACNT+1),^PSRX(DA,"A",ACNT+1,0)=%_"^C^"_DUZ_"^"_RFCNT_"^"_$G(ACOM)
"RTN","PSOORED1",45,0)
 .I $G(PSOOIFLG),'$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Pharmacy Orderable Item Edited."
"RTN","PSOORED1",46,0)
 .I '$G(PSOOIFLG),$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Medication Route/Schedule Edited."
"RTN","PSOORED1",47,0)
 .I $G(PSOOIFLG),$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Pharmacy Orderable Item and Medication Route/Schedule Edited."
"RTN","PSOORED1",48,0)
 .S REA="C" D EXP^PSOHELP1
"RTN","PSOORED1",49,0)
 I $G(^PS(52.4,DA,0))]"" S PSCDA=DA,DIK="^PS(52.4," D ^DIK S DA=PSCDA K DIK,PSCDA
"RTN","PSOORED1",50,0)
 Q
"RTN","PSOORED1",51,0)
INS K X,QUIT,Y,DIR,DIRUT,DUOUT,DTOUT,DIC,INSDEL,UPMI,^TMP($J,"INS1")
"RTN","PSOORED1",52,0)
 I '$O(^PSRX(PSORXED("IRXN"),6,0)),'$O(PSORXED("DOSE",0)) D UPMI Q:$G(QUIT)  ;G INS1
"RTN","PSOORED1",53,0)
 I $G(^PSRX(PSORXED("IRXN"),"INS"))]"" S PSORXED("FLD",114)=^PSRX(PSORXED("IRXN"),"INS") K UPMI G INS1
"RTN","PSOORED1",54,0)
 K DD,GG F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"INS1",I)) Q:'I  S DD=$G(DD)+1
"RTN","PSOORED1",55,0)
 I $G(DD)=1 S PSORXED("FLD",114)=^PSRX(PSORXED("IRXN"),"INS1",$O(^PSRX(PSORXED("IRXN"),"INS1",0)),0) K UPMI,DD G INS1
"RTN","PSOORED1",56,0)
 I $O(^PSRX(PSORXED("IRXN"),"INS1",0)) D  G INSX
"RTN","PSOORED1",57,0)
 .F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"INS1",I)) Q:'I  S ^TMP($J,"INS1",I,0)=^PSRX(PSORXED("IRXN"),"INS1",I,0)
"RTN","PSOORED1",58,0)
 .S ^TMP($J,"INS1",0)=^PSRX(PSORXED("IRXN"),"INS1",0)
"RTN","PSOORED1",59,0)
 .S DIC="^TMP($J,""INS1"",",DWPK=2,DWLW=80 D EN^DIWE I $G(X)="^" K ^TMP($J,"INS1") Q
"RTN","PSOORED1",60,0)
 .I '$O(^TMP($J,"INS1",0)) S INSDEL=1
"RTN","PSOORED1",61,0)
 .S D=0 F  S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORED1",62,0)
INS1 K Y,DIR,DIRUT,DUOUT,DTOUT,DIC,X
"RTN","PSOORED1",63,0)
 I $G(UPMI) K UPMI I $G(^PS(50.7,PSODRUG("OI"),"INS"))]"" S PSORXED("FLD",114)=^PS(50.7,PSODRUG("OI"),"INS")
"RTN","PSOORED1",64,0)
 S:$G(PSORXED("FLD",114))]"" DIR("B")=PSORXED("FLD",114)
"RTN","PSOORED1",65,0)
 S DIR("?")="Enter Quick codes or Free Text",DIR(0)="52,114" D ^DIR
"RTN","PSOORED1",66,0)
 I $D(DTOUT)!($D(DUOUT))!($G(PSORXED("FLD",114))=X) K PSORXED("FLD",114) G INSX
"RTN","PSOORED1",67,0)
 I X'="",X'="@" D SIG^PSOHELP G INS1:'$D(X)
"RTN","PSOORED1",68,0)
 S PSORXED("FLD",114)=X
"RTN","PSOORED1",69,0)
 I $G(INS1)]"" W " ("_$E(INS1,2,9999999)_")"
"RTN","PSOORED1",70,0)
 G:(X']""!(X="@")) INSX
"RTN","PSOORED1",71,0)
 S (PSORXED("INS"),PSORXED("SIG",1))=$E(INS1,2,9999999) D EN^PSOFSIG(.PSORXED)
"RTN","PSOORED1",72,0)
INSX I $P($G(^PS(55,PSODFN,"LAN")),"^") K DIR D
"RTN","PSOORED1",73,0)
 .I $G(^PSRX(PSORXED("IRXN"),"INSS"))]"" S PSORXED("SINS")=^PSRX(PSORXED("IRXN"),"INSS")
"RTN","PSOORED1",74,0)
 .D SINS^PSODIR(.PSORXED) I $G(PSORXED("SINS"))']"" K ^PSRX(PSORXED("IRXN"),"INSS") Q
"RTN","PSOORED1",75,0)
 .S PSORXED("FLD",114.1)=PSORXED("SINS")
"RTN","PSOORED1",76,0)
 K DIRUT,DUOUT,DTOUT,DIR,X,Y,DIC,DWPK
"RTN","PSOORED1",77,0)
 Q
"RTN","PSOORED1",78,0)
INIT ;setup psorenw array
"RTN","PSOORED1",79,0)
 S PSORENW("RX0")=^PSRX(PSORENW("IRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN"))
"RTN","PSOORED1",80,0)
 I $G(PSOSIGFL),$G(PSORX("SIG"))]"" S PSORENW("SIG")=PSORX("SIG"),SIGOK=0
"RTN","PSOORED1",81,0)
 E  D
"RTN","PSOORED1",82,0)
 .I '$P($G(^PSRX(PSORENW("IRXN"),"SIG")),"^",2) S PSORENW("SIG")=$P($G(^("SIG")),"^")
"RTN","PSOORED1",83,0)
 .E  D
"RTN","PSOORED1",84,0)
 ..S SIGOK=1 Q:$O(SIG(0))
"RTN","PSOORED1",85,0)
 ..S D=0 F I=0:0 S D=D+1,I=$O(^PSRX(PSORENW("IRXN"),"SIG1",I)) Q:'I  S SIG(D)=^PSRX(PSORENW("IRXN"),"SIG1",I,0)
"RTN","PSOORED1",86,0)
 ..K PSOX1,D
"RTN","PSOORED1",87,0)
 S PSORENW("OIRXN")=PSORENW("IRXN")
"RTN","PSOORED1",88,0)
 S PSORENW("PROVIDER")=$S($G(PSORENW("PROVIDER")):PSORENW("PROVIDER"),1:$P(PSORENW("RX0"),"^",4))
"RTN","PSOORED1",89,0)
 S (PSORENW("PROVIDER NAME"),PSORX("PROVIDER NAME"))=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSOORED1",90,0)
 I $P($G(^VA(200,PSORENW("PROVIDER"),"PS")),"^",7),$P($G(^("PS")),"^",8) S PSORENW("COSIGNING PROVIDER")=$P($G(^("PS")),"^",8)
"RTN","PSOORED1",91,0)
 S PSORENW("CLINIC")=$S($G(PSORENW("CLINIC")):PSORENW("CLINIC"),1:$P(PSORENW("RX0"),"^",5))
"RTN","PSOORED1",92,0)
 S PSORENW("REMARKS")="New Order Created by "_$S($G(COPY)&('$G(PSOEDIT)):"copying",1:"editing")_" Rx # "_$P(PSORENW("RX0"),"^")_"."
"RTN","PSOORED1",93,0)
 ;
"RTN","PSOORED1",94,0)
 ; - Maintenance Dose Rx Remarks field
"RTN","PSOORED1",95,0)
 I $G(PSOMTFLG) S PSORENW("REMARKS")="Maintenance Rx created from Titration Rx# "_$P(PSORENW("RX0"),"^")_"."
"RTN","PSOORED1",96,0)
 ;
"RTN","PSOORED1",97,0)
 S PSORENW("COSIGNER")=$S($G(PSORENW("COSIGNER")):PSORENW("COSIGNER"),$P(PSORENW("RX3"),"^",3):$P(PSORENW("RX3"),"^",3),1:"")
"RTN","PSOORED1",98,0)
 K:PSORENW("COSIGNER")="" PSORENW("COSIGNER")
"RTN","PSOORED1",99,0)
 S PSORENW("PSODFN")=$P(PSORENW("RX0"),"^",2)
"RTN","PSOORED1",100,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSOORED1",101,0)
 S:$G(PSODRUG("IEN")) PSORENW("DRUG IEN")=PSODRUG("IEN")
"RTN","PSOORED1",102,0)
 I $G(PSORENW("DAYS SUPPLY")) G QTY
"RTN","PSOORED1",103,0)
 S PSORENW("DAYS SUPPLY")=$S($D(CLOZPAT):7,1:$P(PSORENW("RX0"),"^",8))
"RTN","PSOORED1",104,0)
QTY S PSORENW("QTY")=$S($G(PSORENW("QTY")):PSORENW("QTY"),1:$P(PSORENW("RX0"),"^",7))
"RTN","PSOORED1",105,0)
RFN S PSORENW("# OF REFILLS")=$S($D(CLOZPAT):0,$G(PSORENW("# OF REFILLS")):PSORENW("# OF REFILLS"),1:$P(PSORENW("RX0"),"^",9))
"RTN","PSOORED1",106,0)
 S (PSOID,Y,PSORENW("FILL DATE"),PSORENW("ISSUE DATE"))=DT
"RTN","PSOORED1",107,0)
 ;
"RTN","PSOORED1",108,0)
 ; - Maintenance Rx Fill Date is set with Next Possible Fill from Titration Rx
"RTN","PSOORED1",109,0)
 I $G(PSOMTFLG),$P($G(PSORENW("RX3")),"^",2)>DT S PSORENW("FILL DATE")=$P(PSORENW("RX3"),"^",2)
"RTN","PSOORED1",110,0)
 ;
"RTN","PSOORED1",111,0)
 S:PSORENW("CLINIC") PSORX("CLINIC")=$P(^SC(+PSORENW("CLINIC"),0),"^")
"RTN","PSOORED1",112,0)
 S PSORENW("PATIENT STATUS")=$S($G(PSORENW("PATIENT STATUS")):PSORENW("PATIENT STATUS"),'$P(PSORENW("RX0"),"^",3):$G(^PS(55,PSORENW("PSODFN"),"PS")),1:$P(PSORENW("RX0"),"^",3))
"RTN","PSOORED1",113,0)
 S PSORENW("PTST NODE")=$G(^PS(53,PSORENW("PATIENT STATUS"),0))
"RTN","PSOORED1",114,0)
 S PSDAYS=$S($G(PSORENW("DAYS SUPPLY")):PSORENW("DAYS SUPPLY"),'$P(PSORENW("RX0"),"^",8):$P(PSORENW("PTST NODE"),"^",3),1:$P(PSORENW("RX0"),"^",8))
"RTN","PSOORED1",115,0)
 I $G(PSODRUG("IEN")) S DREN=PSODRUG("IEN"),POERR=1 D DRG^PSOORDRG K POERR
"RTN","PSOORED1",116,0)
 D:$G(PSORENW("# OF REFILLS"))']"" RF
"RTN","PSOORED1",117,0)
 ;
"RTN","PSOORED1",118,0)
 ; - Maintenance Rx # of Refills adjustment
"RTN","PSOORED1",119,0)
 I $G(PSOMTFLG),$G(PSORENW("# OF REFILLS"))>0 S PSORENW("# OF REFILLS")=PSORENW("# OF REFILLS")-1
"RTN","PSOORED1",120,0)
 ;
"RTN","PSOORED1",121,0)
 S PSORENW("MAIL/WINDOW")=$S($G(PSORENW("MAIL/WINDOW"))]"":PSORENW("MAIL/WINDOW"),1:$P(PSORENW("RX0"),"^",11))
"RTN","PSOORED1",122,0)
 S PSORX("MAIL/WINDOW")=$S(PSORENW("MAIL/WINDOW")="W":"WINDOW",1:"MAIL")
"RTN","PSOORED1",123,0)
 S PSORENW("COPIES")=$S($G(PSORENW("COPIES")):PSORENW("COPIES"),$P(PSORENW("RX0"),"^",18):$P(PSORENW("RX0"),"^",18),1:1)
"RTN","PSOORED1",124,0)
 S PSORENW("CLERK CODE")=DUZ
"RTN","PSOORED1",125,0)
 S:$G(PSORX("CLERK CODE"))']"" PSORX("CLERK CODE")=$P($G(^VA(200,DUZ,0)),"^")
"RTN","PSOORED1",126,0)
 Q:$D(COPY)  S PSORENW("ENT")=0
"RTN","PSOORED1",127,0)
 K PSORENW("ENT") F I=0:0 S I=$O(PSORENW("DOSE",I)) Q:'I  S PSORENW("ENT")=$G(PSORENW("ENT"))+1
"RTN","PSOORED1",128,0)
 I $O(^TMP($J,"INS1",0)) D
"RTN","PSOORED1",129,0)
 .K PSORXED("SIG"),DD
"RTN","PSOORED1",130,0)
 .F I=0:0 S I=$O(^TMP($J,"INS1",I)) Q:'I  S PSORENW("SIG",I)=^TMP($J,"INS1",I,0)
"RTN","PSOORED1",131,0)
 .K ^TMP($J,"INS1")
"RTN","PSOORED1",132,0)
 I $G(^PSRX(PSORENW("IRXN"),"INS"))]"" S PSORENW("INS")=^PSRX(PSORENW("IRXN"),"INS")
"RTN","PSOORED1",133,0)
 I $G(^PSRX(PSORENW("IRXN"),"INSS"))]"" S PSORENW("SINS")=^PSRX(PSORENW("IRXN"),"INSS")
"RTN","PSOORED1",134,0)
 I '$G(PSORENW("ENT")),'$G(PSOSIGFL) D DOLST1^PSOORED3(.PSORENW) S PSORENW("ENT")=+$G(OLENT)
"RTN","PSOORED1",135,0)
 Q
"RTN","PSOORED1",136,0)
RF ;# of refills
"RTN","PSOORED1",137,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSOORED1",138,0)
 S PSORENW("# OF REFILLS")=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),PSDAYS,+$G(PSORENW("PATIENT STATUS")),.CLOZPAT)
"RTN","PSOORED1",139,0)
 Q
"RTN","PSOORED1",140,0)
UPMI ;add dosing data for pre-poe rxs
"RTN","PSOORED1",141,0)
 W !! K PSONEW("DFLG"),DIR,DIRUT,DTOUT,DUOUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Dosing Instructions Are Missing!! Do You Want to Add Them"
"RTN","PSOORED1",142,0)
 D ^DIR I 'Y!($D(DIRUT)) S QUIT=1 K DIR,DIRUT,DUOT,DUOUT Q
"RTN","PSOORED1",143,0)
 S UPMI=1,EDTHLD=$G(PSORX("EDIT")) K PSORX("EDIT")
"RTN","PSOORED1",144,0)
 D DOSE1^PSOORED5(.PSORXED) S (PSORXED,PSORX("EDIT"))=EDTHLD K EDTHLD I $G(PSONEW("DFLG")) S QUIT=1
"RTN","PSOORED1",145,0)
 Q
"RTN","PSOORED3")
0^23^B66176959^B65846558
"RTN","PSOORED3",1,0)
PSOORED3 ;BIR/SAB-edit finished orders through backdoor ;10/20/06 11:09am
"RTN","PSOORED3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,78,99,117,133,148,249,251,379,378,372,416,313,444**;DEC 1997;Build 34
"RTN","PSOORED3",3,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOORED3",4,0)
 ;External reference to PS(51.2 supported by DBIA 2226 
"RTN","PSOORED3",5,0)
 ;called from psoored2
"RTN","PSOORED3",6,0)
 D DOLST
"RTN","PSOORED3",7,0)
 ;
"RTN","PSOORED3",8,0)
DOSE ;adds dosing info
"RTN","PSOORED3",9,0)
 I '$G(PSORXED("ENT")) F  S I=$O(PSORXED("DOSE",I)) Q:'I  S PSORXED("ENT")=$G(PSORXED("ENT"))+1
"RTN","PSOORED3",10,0)
 K ROU,UNITN,STRE,PSODOSE,RTE,NOUN,VERB M PSODOSE=PSORXED
"RTN","PSOORED3",11,0)
 D KV K FIELD,DOSEOR,DOOR,X,Y,UNITS S ENT=1
"RTN","PSOORED3",12,0)
ASK S ROU="PSOORED3" D ASK^PSOBKDED K ROU I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED3",13,0)
 G:$D(DIRUT) EXQ
"RTN","PSOORED3",14,0)
 I $G(QUIT)]"" K QUIT,ROU Q
"RTN","PSOORED3",15,0)
 ;
"RTN","PSOORED3",16,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED3",17,0)
VER D VER^PSOOREDX I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED3",18,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",19,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED3",20,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED3",21,0)
DUPD ;
"RTN","PSOORED3",22,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED3",23,0)
 D DUPD^PSOOREDX
"RTN","PSOORED3",24,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:"") S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED3",25,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED3",26,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",27,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED3",28,0)
 D STR^PSOOREDX
"RTN","PSOORED3",29,0)
NOU1 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOORED3",30,0)
 D CNON
"RTN","PSOORED3",31,0)
 N PSONDEF
"RTN","PSOORED3",32,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOORED3",33,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED3",34,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",35,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED3",36,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED3",37,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED3",38,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED3",39,0)
RTE S:$G(PSORXED("ROUTE",ENT))']"" DRET=1
"RTN","PSOORED3",40,0)
 K JUMP S ROU="PSOORED3" D RTE^PSOBKDED K ROU
"RTN","PSOORED3",41,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED3",42,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",43,0)
 I $G(QUIT) K QUIT,ROU Q
"RTN","PSOORED3",44,0)
 ;
"RTN","PSOORED3",45,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED3",46,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",47,0)
 S SCH=Y D SCH^PSOSIG I $G(SCH)']"" G SCH
"RTN","PSOORED3",48,0)
 S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED3",49,0)
 S:PSORXED("ENT")<ENT PSORXED("ENT")=ENT
"RTN","PSOORED3",50,0)
 ;
"RTN","PSOORED3",51,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN MONTHS, WEEKS, DAYS, HOURS OR MINUTES)"
"RTN","PSOORED3",52,0)
 S DIR("B")=$S($G(DUR)]"":DUR,$G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED3",53,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED3",54,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",55,0)
 D DUR1^PSOOREDX
"RTN","PSOORED3",56,0)
 ;
"RTN","PSOORED3",57,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED3",58,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",59,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED3",60,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED3",61,0)
 I X="@" D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOORED3",62,0)
 ;
"RTN","PSOORED3",63,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED3",64,0)
 I '$$DUROK(.PSORXED,ENT) D  G DUR
"RTN","PSOORED3",65,0)
 . W !!,"Duration is required for the dosage entered prior to the THEN conjunction.",$C(7),!
"RTN","PSOORED3",66,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSORXED("DFLG"))!($G(PSORX("DFLG"))) EXQ S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED3",67,0)
 E  K PSOCKCON I $$DCHK^PSODOSUT S PSOQUIT=1 G EXQ
"RTN","PSOORED3",68,0)
 I PSOSAVX="",$G(PSORXED)!$D(PSOEDDOS) K PSOCKCON
"RTN","PSOORED3",69,0)
 K PSOSAVX
"RTN","PSOORED3",70,0)
 ;
"RTN","PSOORED3",71,0)
 S DENT=$O(PSORXED("DOSE",ENT)) I DENT,(ENT+1)'=DENT D
"RTN","PSOORED3",72,0)
 .K PSORXED("DOSE",DENT),PSORXED("NOUN",DENT),PSORXED("VERB",DENT),PSORXED("DOSE ORDERED",DENT),PSORXED("ROUTE",DENT),PSORXED("ODOSE",DENT)
"RTN","PSOORED3",73,0)
 .K PSORXED("SCHEDULE",DENT),PSORXED("DURATION",DENT),PSORXED("CONJUNCTION",DENT),DENT
"RTN","PSOORED3",74,0)
 I $G(FIELD)]"" K FIELD S QUIT=1
"RTN","PSOORED3",75,0)
 I $O(^PSRX(PSORXED("IRXN"),"INS1",0)) D
"RTN","PSOORED3",76,0)
 .F D=0:0 S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORED3",77,0)
 D EN^PSOFSIG(.PSORXED) D VER^PSOORED7:'$G(PSOVER) I $G(CKX),'$G(PSOSIGFL) D M1 K CKX
"RTN","PSOORED3",78,0)
 S:'$D(PSORXED("DAYS SUPPLY")) PSORXED("DAYS SUPPLY")=$P(PSORXED("RX0"),"^",8)
"RTN","PSOORED3",79,0)
 ; Checks if the current Days Supply value is greater than the Maximum Days Supply for the Drug, if so, reset
"RTN","PSOORED3",80,0)
 D DAYSUP^PSOUTIL(+$G(PSODRUG("IEN")),.PSORXED,0)
"RTN","PSOORED3",81,0)
 ;Needed to calculate QTY
"RTN","PSOORED3",82,0)
 K QTY,QTYHLD S QTYHLD=$P(PSORXED("RX0"),"^",7) D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED3",83,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED3",84,0)
 I $G(PSOSIGFL)=1 S PSORXED("ENT")=ENT,SIGOK=1 G EX1
"RTN","PSOORED3",85,0)
 K QTYHLD Q:$G(PSOVER)!($G(PSOREEDQ))
"RTN","PSOORED3",86,0)
UDSIG I $O(SIG(0)) D
"RTN","PSOORED3",87,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSOORED3",88,0)
 .S (A,I)=0 F  S I=$O(^PSRX(PSORXED("IRXN"),"A",I)) Q:'I  S A=A+1
"RTN","PSOORED3",89,0)
 .D NOW^%DTC I $G(QTY) S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^Quantity Updated "_"("_$P(^PSRX(PSORXED("IRXN"),0),"^",7)_")",$P(^PSRX(PSORXED("IRXN"),0),"^",7)=$G(PSORXED("QTY")) K QTY
"RTN","PSOORED3",90,0)
 .S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^New Dosing Instructions Added",^PSRX(PSORXED("IRXN"),"A",A,1)="ORIGINAL SIG^" D
"RTN","PSOORED3",91,0)
 ..I '$P($G(^PSRX(PSORXED("IRXN"),"SIG")),"^",2) S $P(^PSRX(PSORXED("IRXN"),"A",A,1),"^",2)=$P($G(^PSRX(PSORXED("IRXN"),"SIG")),"^") Q
"RTN","PSOORED3",92,0)
 ..F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S ^PSRX(PSORXED("IRXN"),"A",A,2,I,0)=^PSRX(PSORXED("IRXN"),"SIG1",I,0),^PSRX(PSORXED("IRXN"),"A",A,2,0)="^52.34A^"_I_"^"_I
"RTN","PSOORED3",93,0)
 .S ^PSRX(PSORXED("IRXN"),"SIG")="^1"
"RTN","PSOORED3",94,0)
 .K SIG,A,I
"RTN","PSOORED3",95,0)
 S ^PSRX(PSORXED("IRXN"),6,0)="^52.0113^"_ENT_"^"_ENT
"RTN","PSOORED3",96,0)
 F I=1:1:ENT S ^PSRX(PSORXED("IRXN"),6,I,0)=PSORXED("DOSE",I)_"^"_$G(PSORXED("DOSE ORDERED",I))_"^"_$G(PSORXED("UNITS",I))_"^"_$G(PSORXED("NOUN",I))_"^" D
"RTN","PSOORED3",97,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,0)=^PSRX(PSORXED("IRXN"),6,I,0)_$G(PSORXED("DURATION",I))_"^"_$G(PSORXED("CONJUNCTION",I))_"^"_$G(PSORXED("ROUTE",I))_"^"_$G(PSORXED("SCHEDULE",I))_"^"_$G(PSORXED("VERB",I))
"RTN","PSOORED3",98,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,1)=$G(PSORXED("ODOSE",I))
"RTN","PSOORED3",99,0)
 S ^PSRX(PSORXED("IRXN"),"POE")=1
"RTN","PSOORED3",100,0)
 G EX
"RTN","PSOORED3",101,0)
 Q
"RTN","PSOORED3",102,0)
EX ;
"RTN","PSOORED3",103,0)
 K PSORXED("DOSE"),DOSE,DUPD,SCH,PSORXED("NOUN"),PSORXED("VERB"),VERB,NOUN,PSORXED("DOSE ORDERED"),DOSEOR,PSORXED("ROUTE"),ENT,PSORTE,SIG,PSODOSE
"RTN","PSOORED3",104,0)
 K PSORXED("SCHEDULE"),PSORXED("DURATION"),PSORXED("CONJUNCTION"),DURA,X,Y,PSORXED("ODOSE")
"RTN","PSOORED3",105,0)
EX1 K STRE,UNITN,DOSE,DUPD,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSOSCH,ERTE,ROU
"RTN","PSOORED3",106,0)
KV K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOORED3",107,0)
 Q
"RTN","PSOORED3",108,0)
EXQ K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) S PSORXED("DFLG")=1 D M1 G EX
"RTN","PSOORED3",109,0)
 Q
"RTN","PSOORED3",110,0)
M1 D M1^PSOOREDX
"RTN","PSOORED3",111,0)
 Q
"RTN","PSOORED3",112,0)
DOLST1(PSORXED) ;
"RTN","PSOORED3",113,0)
 ;
"RTN","PSOORED3",114,0)
DOLST F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),6,I)) Q:'I  S INST=^(I,0) D
"RTN","PSOORED3",115,0)
 .S PSORXED("DOSE",I)=$P(INST,"^"),PSORXED("DOSE ORDERED",I)=$P(INST,"^",2),PSORXED("UNITS",I)=$P(INST,"^",3),PSORXED("NOUN",I)=$P(INST,"^",4)
"RTN","PSOORED3",116,0)
 .I $P(INST,"^",5)]"" D
"RTN","PSOORED3",117,0)
 ..S PSORXED("DURATION",I)=$S($E($P(INST,"^",5),1)'?.N:$E($P(INST,"^",5),2,99)_$E($P(INST,"^",5),1),1:$P(INST,"^",5))
"RTN","PSOORED3",118,0)
 .S PSORXED("ROUTE",I)=$P(INST,"^",7),PSORXED("SCHEDULE",I)=$P(INST,"^",8)
"RTN","PSOORED3",119,0)
 .S PSORXED("CONJUNCTION",I)=$P(INST,"^",6),PSORXED("VERB",I)=$P(INST,"^",9),OLENT=I
"RTN","PSOORED3",120,0)
 .S PSORXED("ODOSE",I)=$G(^PSRX(PSORXED("IRXN"),6,I,1))
"RTN","PSOORED3",121,0)
 K:'$O(PSORXED("DOSE",0)) PSORXED("ENT"),OLENT
"RTN","PSOORED3",122,0)
 S PSORXED("INS")=$G(^PSRX(PSORXED("IRXN"),"INS"))
"RTN","PSOORED3",123,0)
 Q
"RTN","PSOORED3",124,0)
UPDSIG ;updates sig
"RTN","PSOORED3",125,0)
 K ^PSRX(PSORXED("IRXN"),"SIG1") S ^PSRX(PSORXED("IRXN"),"SIG1",0)="^52.04A^^"
"RTN","PSOORED3",126,0)
 S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1
"RTN","PSOORED3",127,0)
 S ^PSRX(PSORXED("IRXN"),"SIG")="^1"
"RTN","PSOORED3",128,0)
 Q
"RTN","PSOORED3",129,0)
JUMP ;jump to fields
"RTN","PSOORED3",130,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED3",131,0)
 D FNM^PSOOREDX
"RTN","PSOORED3",132,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED3",133,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED3",134,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED3",135,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED3",136,0)
 G EX
"RTN","PSOORED3",137,0)
 Q
"RTN","PSOORED3",138,0)
 ;
"RTN","PSOORED3",139,0)
CNON ;
"RTN","PSOORED3",140,0)
 I $G(NOUN)'="" Q
"RTN","PSOORED3",141,0)
 I '$G(PSORXED("DOSE ORDERED",ENT)) Q
"RTN","PSOORED3",142,0)
 N PSONLT,PSONLL,PSONLG
"RTN","PSOORED3",143,0)
 S PSONLL=$P($G(DOSE("DD",+$G(PSODRUG("IEN")))),"^",9) I PSONLL="" Q
"RTN","PSOORED3",144,0)
 S PSONLG=$L(PSONLL)
"RTN","PSOORED3",145,0)
 I PSONLG'>3 Q
"RTN","PSOORED3",146,0)
 S PSONLT=$E(PSONLL,(PSONLG-2),PSONLG)
"RTN","PSOORED3",147,0)
 I PSONLT'="(S)",PSONLT'="(s)" Q
"RTN","PSOORED3",148,0)
 ;test noun of (S)
"RTN","PSOORED3",149,0)
 K NOUN ; NOT SURE ABOUT THIS???
"RTN","PSOORED3",150,0)
 I $G(PSORXED("DOSE ORDERED",ENT))>1 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))_$E(PSONLT,2) Q
"RTN","PSOORED3",151,0)
 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))
"RTN","PSOORED3",152,0)
 Q
"RTN","PSOORED3",153,0)
 ;
"RTN","PSOORED3",154,0)
DUROK(DOSE,ENT) ; Duration OK? (Complex Doses only)
"RTN","PSOORED3",155,0)
 ;Input: PSORXED - array with doses
"RTN","PSOORED3",156,0)
 ;       ENT - dose entry in the PSORXED array
"RTN","PSOORED3",157,0)
 ;Output: 1: Duration OK / 0: Duration not OK (required, but missing)
"RTN","PSOORED3",158,0)
 N SCHIEN
"RTN","PSOORED3",159,0)
 I $G(DOSE("CONJUNCTION",ENT))'="T" Q 1
"RTN","PSOORED3",160,0)
 I $G(DOSE("DURATION",ENT)) Q 1
"RTN","PSOORED3",161,0)
 I $G(DOSE("SCHEDULE",ENT))="" Q 1
"RTN","PSOORED3",162,0)
 S SCHIEN=$O(^PS(51.1,"B",$G(DOSE("SCHEDULE",ENT)),0))
"RTN","PSOORED3",163,0)
 I $$GET1^DIQ(51.1,SCHIEN,5,"I")="O" Q 1
"RTN","PSOORED3",164,0)
 Q 0
"RTN","PSOORFI1")
0^7^B79665537^B84234137
"RTN","PSOORFI1",1,0)
PSOORFI1 ;BIR/SAB - finish OP orders from OE/RR continued ; 10/23/15 4:14pm
"RTN","PSOORFI1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**7,15,23,27,32,44,51,46,71,90,108,131,152,186,210,222,258,260,225,391,408,444**;DEC 1997;Build 34
"RTN","PSOORFI1",3,0)
 ;Ref. ^PS(50.7 supp. DBIA 2223
"RTN","PSOORFI1",4,0)
 ;Ref. ^PSDRUG( supp. DBIA 221
"RTN","PSOORFI1",5,0)
 ;Ref. L^PSSLOCK supp. DBIA 2789
"RTN","PSOORFI1",6,0)
 ;Ref. ^PS(50.606 supp. DBIA 2174
"RTN","PSOORFI1",7,0)
 ;Ref. ^PS(55 supp. DBIA 2228
"RTN","PSOORFI1",8,0)
 ;Ref. ULK^ORX2 supp. DBIA 867
"RTN","PSOORFI1",9,0)
 ;
"RTN","PSOORFI1",10,0)
 ;PSO*186 add call to function $$DEACHK
"RTN","PSOORFI1",11,0)
 ;PSO*210 add call to WORDWRAP api
"RTN","PSOORFI1",12,0)
 ;
"RTN","PSOORFI1",13,0)
 S SIGOK=1
"RTN","PSOORFI1",14,0)
DSPL K ^TMP("PSOPO",$J),CLOZPAT,PSOPRC,PSODSPL
"RTN","PSOORFI1",15,0)
 S (OI,PSODRUG("OI"))=$P(OR0,"^",8),PSODRUG("OIN")=$P(^PS(50.7,$P(OR0,"^",8),0),"^"),OID=$P(OR0,"^",9)
"RTN","PSOORFI1",16,0)
 I $P($G(OR0),"^",9) S POERR=1,DREN=$P(OR0,"^",9) D DRG^PSOORDRG K POERR G DRG
"RTN","PSOORFI1",17,0)
 I '$P(OR0,"^",9) D DREN^PSOORNW2
"RTN","PSOORFI1",18,0)
DRG I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),"CLOZ1")),"^")="PSOCLO1" D CLOZ^PSOORFI2
"RTN","PSOORFI1",19,0)
 ;PSO*186 modify If/Else below to use DEACHK
"RTN","PSOORFI1",20,0)
 I $G(PSODRUG("DEA"))]"" D
"RTN","PSOORFI1",21,0)
 .S PSOCS=0 K DIR,DIC,PSOX
"RTN","PSOORFI1",22,0)
 .N PSDEA,PSDAYS S PSDEA=PSODRUG("DEA"),PSDAYS=+$P(OR0,"^",22)
"RTN","PSOORFI1",23,0)
 .I $$DEACHK^PSOUTLA1("*",PSDEA,PSDAYS,$G(CLOZPAT),.PSOCS,.PSOMAX)
"RTN","PSOORFI1",24,0)
 E  D
"RTN","PSOORFI1",25,0)
 .S PSOMAX=$S($G(CLOZPAT)=2:3,$G(CLOZPAT)=1:1,1:$P(OR0,"^",11))
"RTN","PSOORFI1",26,0)
ISSDT S (PSOID,Y,PSONEW("ISSUE DATE"))=$S($G(PSONEW("ISSUE DATE")):PSONEW("ISSUE DATE"),$P($G(OR0),"^",6):$E($P(OR0,"^",6),1,7),1:DT)
"RTN","PSOORFI1",27,0)
 X ^DD("DD") S PSONEW("ISSUE DATE")=Y
"RTN","PSOORFI1",28,0)
 D USER^PSOORFI2($P(OR0,"^",4)) S PSONEW("CLERK CODE")=$P(OR0,"^",4),PSORX("CLERK CODE")=USER1
"RTN","PSOORFI1",29,0)
 S (PSONEW("DFLG"),PSONEW("QFLG"))=0,PSODFN=$P(OR0,"^",2),PSONEW("QTY")=$P(OR0,"^",10),PSONEW("MAIL/WINDOW")=$S($P(OR0,"^",17)="M":"M",1:"W")
"RTN","PSOORFI1",30,0)
 S:$G(PSONEW("CLINIC"))']"" PSONEW("CLINIC")=+$P(OR0,"^",13),PSORX("CLINIC")=$S($D(^SC(PSONEW("CLINIC"),0)):$P(^SC(PSONEW("CLINIC"),0),"^"),1:"")
"RTN","PSOORFI1",31,0)
 S:$G(PSORX("CLINIC"))']"" PSORX("CLINIC")=$S($D(^SC(+$P(OR0,"^",13),0)):$P(^SC($P(OR0,"^",13),0),"^"),1:"")
"RTN","PSOORFI1",32,0)
 D USER^PSOORFI2($P(OR0,"^",5))
"RTN","PSOORFI1",33,0)
 S PSONEW("CLERK CODE")=$P(OR0,"^",4),PSONEW("PROVIDER")=$P(OR0,"^",5),PSONEW("PROVIDER NAME")=USER1
"RTN","PSOORFI1",34,0)
 S PSONEW("PATIENT STATUS")=$S(+$G(^PS(55,PSODFN,"PS")):+$G(^PS(55,PSODFN,"PS")),1:"")
"RTN","PSOORFI1",35,0)
 S PSONEW("CHCS NUMBER")=$S($P($G(^PS(52.41,+$G(ORD),"EXT")),"^")'="":$P($G(^("EXT")),"^"),1:"")
"RTN","PSOORFI1",36,0)
 S PSONEW("EXTERNAL SYSTEM")=$S($P($G(^PS(52.41,+$G(ORD),"EXT")),"^",3)'="":$P($G(^("EXT")),"^",3),1:"")
"RTN","PSOORFI1",37,0)
 I $P(OR0,"^",22)>0 S PSONEW("DAYS SUPPLY")=$P(OR0,"^",22) G DS
"RTN","PSOORFI1",38,0)
 S PSONEW("DAYS SUPPLY")=$S(+$G(^PS(55,PSODFN,"PS"))&($P($G(^PS(53,+$G(^PS(55,PSODFN,"PS")),0)),"^",3)):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:30)
"RTN","PSOORFI1",39,0)
DS ;
"RTN","PSOORFI1",40,0)
 S:$D(CLOZPAT) PSONEW("DAYS SUPPLY")=$S(CLOZPAT=2&(PSONEW("DAYS SUPPLY")>28):28,CLOZPAT=1&(PSONEW("DAYS SUPPLY")>14):14,'CLOZPAT&(PSONEW("DAYS SUPPLY")>7):7,1:PSONEW("DAYS SUPPLY"))
"RTN","PSOORFI1",41,0)
 S IEN=0 D OBX                ; Display Order Checks Information
"RTN","PSOORFI1",42,0)
 D LMDISP^PSOORFI5(+$G(ORD))  ; Display Flag/Unflag Information
"RTN","PSOORFI1",43,0)
 D DIN^PSONFI(PSODRUG("OI"),$S($D(PSODRUG("IEN")):PSODRUG("IEN"),1:"")) ;Setup for N/F & DIN indicator
"RTN","PSOORFI1",44,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="*(1) Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORFI1",45,0)
 S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORFI1",46,0)
 ;
"RTN","PSOORFI1",47,0)
 K LST I $G(PSODRUG("NAME"))]"" D  G PST
"RTN","PSOORFI1",48,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)"_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORFI1",49,0)
 .S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORFI1",50,0)
 .I $P(^PSDRUG(PSODRUG("IEN"),0),"^",10)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Drug Message:" D DRGMSG^PSOORNEW
"RTN","PSOORFI1",51,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)           Drug: No Dispense Drug Selected"
"RTN","PSOORFI1",52,0)
PST D DOSE^PSOORFI4 K PSOINSFL
"RTN","PSOORFI1",53,0)
 S PSOINSFL=$P($G(^PS(52.41,ORD,"INS")),"^",2)
"RTN","PSOORFI1",54,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (4)   Pat Instruct:" D INST^PSOORFI4
"RTN","PSOORFI1",55,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Provider Comments:" S TY=3 D INST
"RTN","PSOORFI1",56,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Instructions:" S TY=2 D INST
"RTN","PSOORFI1",57,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                SIG:" D SIG
"RTN","PSOORFI1",58,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (5) Patient Status: "_$P($G(^PS(53,+PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORFI1",59,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (6)     Issue Date: "_PSONEW("ISSUE DATE")
"RTN","PSOORFI1",60,0)
 S (Y,PSONEW("FILL DATE"))=$S($E($P(OR0,"^",6),1,7)<DT:DT,1:$E($P(OR0,"^",6),1,7)) X ^DD("DD") S PSORX("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"        (7) Fill Date: "_Y
"RTN","PSOORFI1",61,0)
 I $P(OR0,"^",18) D
"RTN","PSOORFI1",62,0)
 .S IEN=IEN+1,Y=$P(OR0,"^",18) X ^DD("DD") S $P(^TMP("PSOPO",$J,IEN,0)," ",39)="Effective Date: "_Y
"RTN","PSOORFI1",63,0)
 D:$D(CLOZPAT) ELIG^PSOORFI2,CLQTY^PSOORFI4
"RTN","PSOORFI1",64,0)
 N PSDAYS,MAXRF
"RTN","PSOORFI1",65,0)
 S PSDAYS=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3)):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:"")
"RTN","PSOORFI1",66,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (8)    Days Supply: "_PSDAYS
"RTN","PSOORFI1",67,0)
 S RXPT=+$G(^PS(55,PSODFN,"PS"))
"RTN","PSOORFI1",68,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSOORFI1",69,0)
 S MAXRF=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),PSDAYS,RXPT,.CLOZPAT)
"RTN","PSOORFI1",70,0)
 S PSONEW("# OF REFILLS")=$S(+$P(OR0,"^",11)>MAXRF:MAXRF,1:+$P(OR0,"^",11))
"RTN","PSOORFI1",71,0)
 KILL RXPT
"RTN","PSOORFI1",72,0)
 ;
"RTN","PSOORFI1",73,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                (9)   QTY"_$S($P($G(^PSDRUG(+$G(PSODRUG("IEN")),660)),"^",8)]"":" ("_$P($G(^PSDRUG(+$G(PSODRUG("IEN")),660)),"^",8)_")",1:" (  )")_": "_+$G(PSONEW("QTY"))
"RTN","PSOORFI1",74,0)
 I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),5)),"^")]"" D
"RTN","PSOORFI1",75,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORFI1",76,0)
 .S ^TMP("PSOPO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^") K RN
"RTN","PSOORFI1",77,0)
 S IEN=IEN+1
"RTN","PSOORFI1",78,0)
 I $P(OR0,"^",24) S ^TMP("PSOPO",$J,IEN,0)="   Provider ordered: days supply "_+$P(OR0,"^",22)_", quantity "_+$P(OR0,"^",10)_" & refills "_+$P(OR0,"^",11)
"RTN","PSOORFI1",79,0)
 E  S ^TMP("PSOPO",$J,IEN,0)="       Provider ordered "_+$P(OR0,"^",11)_" refills"
"RTN","PSOORFI1",80,0)
 D:$D(CLOZPAT) PQTY^PSOORFI4
"RTN","PSOORFI1",81,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(10)   # of Refills: "_PSONEW("# OF REFILLS")_$E("  ",$L(PSONEW("# OF REFILLS"))+1,2)_"               (11)   Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORFI1",82,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(12)         Clinic: "_PSORX("CLINIC")
"RTN","PSOORFI1",83,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(13)       Provider: "_PSONEW("PROVIDER NAME")
"RTN","PSOORFI1",84,0)
 I $G(PKI),+$G(PSODRUG("DEA"))>1,+$G(PSODRUG("DEA"))<6 D PRV^PSOORFI5($P(OR0,"^",5),$P(OR0,"^",9),$P(OR0,"^"))
"RTN","PSOORFI1",85,0)
 I $P($G(^VA(200,$S($G(PSONEW("PROVIDER")):PSONEW("PROVIDER"),1:$P(OR0,"^",5)),"PS")),"^",7)&($P($G(^("PS")),"^",8)) S PSONEW("COSIGNING PROVIDER")=$P(^("PS"),"^",8) D
"RTN","PSOORFI1",86,0)
 .D USER^PSOORFI2(PSONEW("COSIGNING PROVIDER"))
"RTN","PSOORFI1",87,0)
 .S IEN=IEN+1 S ^TMP("PSOPO",$J,IEN,0)="        Cos-Provider: "_USER1
"RTN","PSOORFI1",88,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(14)         Copies: 1"
"RTN","PSOORFI1",89,0)
 S PSONEW("REMARKS")=$S($P(OR0,"^",17)="C":"Administered in Clinic.",1:"")
"RTN","PSOORFI1",90,0)
 K PSONEW("ADMINCLINIC") S:$P(OR0,"^",17)="C" PSONEW("ADMINCLINIC")=1
"RTN","PSOORFI1",91,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(15)        Remarks: "_$S($G(PSONEW("REMARKS"))]"":PSONEW("REMARKS"),1:"")
"RTN","PSOORFI1",92,0)
 D USER^PSOORFI2($P(OR0,"^",4))
"RTN","PSOORFI1",93,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_USER1_$E(RN,$L(USER1)+1,35)
"RTN","PSOORFI1",94,0)
 S Y=$P(OR0,"^",12) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$E($P(OR0,"^",12),4,5)_"/"_$E($P(OR0,"^",12),6,7)_"/"_$E($P(OR0,"^",12),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORFI1",95,0)
 I $P(OR0,"^",24) S PSOACT=$S($D(^XUSEC("PSDRPH",DUZ)):"DEFX",$D(^XUSEC("PSORPH",DUZ)):"F",$P($G(PSOPAR),"^",2):"F",1:"") D
"RTN","PSOORFI1",96,0)
 .K PSOCSP S PSOCSP("NAME")=$G(PSODRUG("NAME")) M PSOCSP("DOSE")=PSONEW("DOSE"),PSOCSP("DOSE ORDERED")=PSONEW("DOSE ORDERED")
"RTN","PSOORFI1",97,0)
 .S PSOCSP("# OF REFILLS")=PSONEW("# OF REFILLS") ;track original data for dig. orders
"RTN","PSOORFI1",98,0)
 .S PSOCSP("ISSUE DATE")=$E($P(OR0,"^",6),1,7),PSOCSP("QTY")=PSONEW("QTY"),PSOCSP("DAYS SUPPLY")=PSONEW("DAYS SUPPLY")
"RTN","PSOORFI1",99,0)
 E  S PSOACT=$S($D(^XUSEC("PSORPH",DUZ)):"DEFX",'$D(^XUSEC("PSORPH",DUZ))&($P($G(PSOPAR),"^",2)):"F",1:"")
"RTN","PSOORFI1",100,0)
 ; - PSOACTOV is used to force the Pending Order to be Read-Only (no updates) even if invoked by a Pharmacist
"RTN","PSOORFI1",101,0)
 I $G(PSOACTOV) S PSOACT=""
"RTN","PSOORFI1",102,0)
 D:'$G(ACP) EN^PSOLMPO S:$G(ACP) VALMBCK="Q" D:$G(PKI1)=2 DCP^PSOPKIV1
"RTN","PSOORFI1",103,0)
 Q
"RTN","PSOORFI1",104,0)
POST ;post patient selection
"RTN","PSOORFI1",105,0)
 D POST^PSOORFI2 Q
"RTN","PSOORFI1",106,0)
SIG ;displays possible sig
"RTN","PSOORFI1",107,0)
 D SIG^PSOORFI2 Q
"RTN","PSOORFI1",108,0)
INST ;displays provider comments and pharmacy instructions
"RTN","PSOORFI1",109,0)
 S INST=0 F  S INST=$O(^PS(52.41,ORD,TY,INST)) Q:'INST  D     ;PSO*210
"RTN","PSOORFI1",110,0)
 . S (MIG,INST(INST))=^PS(52.41,ORD,TY,INST,0)
"RTN","PSOORFI1",111,0)
 . D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOPO",$J)),20)
"RTN","PSOORFI1",112,0)
 K INST,TY,MIG,SG
"RTN","PSOORFI1",113,0)
 Q
"RTN","PSOORFI1",114,0)
OBX ;formats obx section
"RTN","PSOORFI1",115,0)
 D OBX^PSOORFI4
"RTN","PSOORFI1",116,0)
 Q
"RTN","PSOORFI1",117,0)
ST ;sort by route or patient
"RTN","PSOORFI1",118,0)
 W !!,"Enter 'PA' to process orders by patients",!,"      'RT' to process orders by route (mail/window)",!,"      'PR' to process orders by priority",!,"      'CL' to process orders by clinic"
"RTN","PSOORFI1",119,0)
 W !,"      'FL' to process flagged orders",!,"      'CS' to process digitally signed CS orders",!,"   or 'E' or '^' to exit" W ! Q
"RTN","PSOORFI1",120,0)
RT ;which route to sort by
"RTN","PSOORFI1",121,0)
 W !!,"Enter 'W' to process window orders first",!,"      'M' to process mail orders first",!,"      'C' to process orders administered in clinic first",!,"   or 'E' or '^' to exit" Q
"RTN","PSOORFI1",122,0)
PT ;process for all or one patient
"RTN","PSOORFI1",123,0)
 W !!,"Enter 'A' to process all patient orders",!,"      'S' to process orders for a patient",!,"      or 'E' or '^' to exit" Q
"RTN","PSOORFI1",124,0)
EP ;continue processing or not
"RTN","PSOORFI1",125,0)
 W !,"If you want to continue processing orders Press RETURN or enter '^' to exit" Q
"RTN","PSOORFI1",126,0)
LOCK S PSOPLCK=$$L^PSSLOCK(PAT,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S POERR("QFLG")=1
"RTN","PSOORFI1",127,0)
 K PSOPLCK
"RTN","PSOORFI1",128,0)
 Q
"RTN","PSOORFI1",129,0)
ULK S X=PAT_";DPT(" D ULK^ORX2 S:$G(PSOQUIT) POERR("QFLG")=1 ; not called anymore
"RTN","PSOORFI1",130,0)
 Q
"RTN","PSOORFI1",131,0)
LOCK1 ;
"RTN","PSOORFI1",132,0)
 I $P($G(^PS(52.41,ORD,0)),"^",24) S PSOACT=$S($D(^XUSEC("PSDRPH",DUZ)):"DEFX",$D(^XUSEC("PSORPH",DUZ)):"F",'$D(^XUSEC("PSORPH",DUZ))&($P($G(PSOPAR),"^",2)):"F",1:"")
"RTN","PSOORFI1",133,0)
 E  S PSOACT=$S($D(^XUSEC("PSORPH",DUZ)):"DEFX",'$D(^XUSEC("PSORPH",DUZ))&($P($G(PSOPAR),"^",2)):"F",1:"")
"RTN","PSOORFI1",134,0)
 Q
"RTN","PSOORFI1",135,0)
EX K DRET,SIG,PSODRUG,PRC,PHI
"RTN","PSOORFI1",136,0)
 K DIR,DIRUT,DUOUT,DIRUT,X,Y,DIC,POERR,PSONEW,PSOSD,MAIL,CLI,WIN,OR0,OR1,OR2,ORD,SRT,PSRT,PSODFN,PSOFROM,T,OR3,PAT,%,%T,%Y,DI,DQ,DR,DRG,STA,I,T1,PSOSORT,PSOCSP
"RTN","PSOORFI1",137,0)
 K TO,TC,TZ,PSOCPAY,PSOBILL,PSOIBQS,GROUPCNT,AGROUP,AGROUP1,OBX,%,%I,%H,D0,DFN,PSORX,PSOPTPST,PSOQFLG,PT,RTN,TM,TM1,DIPGM,PSOID,PSOCNT,PSOLK,PSZFIN,PSZFZZ D KVA^VADPT
"RTN","PSOORFI1",138,0)
 K PSOFDR,PSOQUIT,PSOFIN,^TMP("PSOAO",$J),^TMP("PSODA",$J),^TMP("PSOPO",$J),^TMP("PSOPF",$J),^TMP("PSOPI",$J),^TMP("PSOHDR",$J),MEDA,MEDP
"RTN","PSOORFI1",139,0)
 K C,CC,CNT,CRIT,D,DGI,DGS,DREN,IT,JJ,LG,MM,NIEN,PSOD,PATA,PSDAYS,PSOACT,PSOBM,PSOCOU,PSOCOUU,PSOFLAG,PSON,PSONOOR,PSOOPT,PSOPF,PSOPI,PSRF,RXFL,SDA,SEG1,SER,SERS,SLPPL,STAT,Z,Z4,ZDA
"RTN","PSOORFI1",140,0)
 D FULL^VALM1
"RTN","PSOORFI1",141,0)
 Q
"RTN","PSOORFI4")
0^8^B73807105^B81023299
"RTN","PSOORFI4",1,0)
PSOORFI4 ;BIR/SAB-CPRS order checks and display con't ;6/17/09 1:11pm
"RTN","PSOORFI4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,74,78,99,117,131,207,258,274,300,308,251,384,391,444**;DEC 1997;Build 34
"RTN","PSOORFI4",3,0)
 ;External reference to ^PS(51.2 supported by DBIA 2226
"RTN","PSOORFI4",4,0)
 ;External reference to ^PS(50.607 supported by DBIA 2221
"RTN","PSOORFI4",5,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOORFI4",6,0)
 ;External reference to ^PS(50.7 is supported by DBIA 2223
"RTN","PSOORFI4",7,0)
 ;
"RTN","PSOORFI4",8,0)
ORCHK D ORCHK^PSOORNE6
"RTN","PSOORFI4",9,0)
 Q
"RTN","PSOORFI4",10,0)
INST ;displays patient instructions
"RTN","PSOORFI4",11,0)
 I $O(PSONEW("SIG",0)) G INST1
"RTN","PSOORFI4",12,0)
 S INST=0 F  S INST=$O(^PS(52.41,ORD,"INS1",INST)) Q:'INST  S (MIG,PSONEW("SIG",INST))=^PS(52.41,ORD,"INS1",INST,0) D
"RTN","PSOORFI4",13,0)
 .F SG=1:1:$L(MIG," ") S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORFI4",14,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^"),$O(^PS(52.41,ORD,"INS1",0)) D
"RTN","PSOORFI4",15,0)
 .I $G(^PS(50.7,PSODRUG("OI"),"INS1"))]"" S (X,PSONEW("SINS"))=^PS(50.7,PSODRUG("OI"),"INS1") D SSIG^PSOHELP
"RTN","PSOORFI4",16,0)
 .I $G(SINS1)]"" S PSONEW("SINS")=$E(SINS1,2,250)
"RTN","PSOORFI4",17,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" Other Pat Instruct: "_$S($G(PSONEW("SINS"))]"":PSONEW("SINS"),1:"")
"RTN","PSOORFI4",18,0)
 K INST,TY,MIG,SG,SINS1
"RTN","PSOORFI4",19,0)
 Q
"RTN","PSOORFI4",20,0)
INST1 ;
"RTN","PSOORFI4",21,0)
 S INS=0 F  S INS=$O(PSONEW("SIG",INS)) Q:'INS  S MIG=PSONEW("SIG",INS) D
"RTN","PSOORFI4",22,0)
 .F SG=1:1:$L(MIG," ") S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORFI4",23,0)
 K INST,TY,MIG,SG
"RTN","PSOORFI4",24,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" Other Pat Instruct: "_$S($G(PSONEW("SINS"))]"":PSONEW("SINS"),1:"")
"RTN","PSOORFI4",25,0)
 Q
"RTN","PSOORFI4",26,0)
PROVCOM ;
"RTN","PSOORFI4",27,0)
 I $O(PRC(0)),'$G(PSOPRC) D  D KV^PSOVER1
"RTN","PSOORFI4",28,0)
 .D EN^DDIOL("Provider Comments: ","","!")
"RTN","PSOORFI4",29,0)
 .F I=0:0 S I=$O(PRC(I)) Q:'I  D EN^DDIOL(PRC(I),"","!")
"RTN","PSOORFI4",30,0)
 .D KV^PSOVER1 S DIR(0)="Y",DIR("A")="Copy Provider Comments into the Patient Instructions",DIR("B")="No"
"RTN","PSOORFI4",31,0)
 .D ^DIR Q:'Y!($D(DIRUT))
"RTN","PSOORFI4",32,0)
 .;Check Provider Comments.  If any line contains more than 32
"RTN","PSOORFI4",33,0)
 .;characters with no spaces, display error message and quit.
"RTN","PSOORFI4",34,0)
 .;*308
"RTN","PSOORFI4",35,0)
 .I $$CHKCOM(.PRC) D  Q
"RTN","PSOORFI4",36,0)
 ..N X,Y,DIR,DIRUT,DUOUT,MSG
"RTN","PSOORFI4",37,0)
 ..S MSG(1)="*** Provider Comments CANNOT be copied ***"
"RTN","PSOORFI4",38,0)
 ..S MSG(1,"F")="!,$C(7)"
"RTN","PSOORFI4",39,0)
 ..S MSG(2)="They contain a word longer than 32 characters, which is not allowed in"
"RTN","PSOORFI4",40,0)
 ..S MSG(3)="the Patient Instructions.  You need to enter this manually."
"RTN","PSOORFI4",41,0)
 ..D EN^DDIOL(.MSG)
"RTN","PSOORFI4",42,0)
 ..S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR
"RTN","PSOORFI4",43,0)
 .S PSOPRC=1,NI=0 F I=0:0 S I=$O(PSONEW("SIG",I)) Q:'I  S NI=I
"RTN","PSOORFI4",44,0)
 .S NC=0 F I=0:0 S I=$O(PRC(I)) Q:'I  S NC=NC+1
"RTN","PSOORFI4",45,0)
 .I NI'>1,NC=1,($L($G(PSONEW("SIG",NI)))+$L(PRC(1)))'>250 D  Q 
"RTN","PSOORFI4",46,0)
 ..S X=PRC(1) D SIGONE^PSOHELP
"RTN","PSOORFI4",47,0)
 ..S PSONEW("SIG",1)=$G(PSONEW("SIG",NI))_INS1 K INS1,X
"RTN","PSOORFI4",48,0)
 ..S:$E(PSONEW("SIG",1))=" " PSONEW("SIG",1)=$E(PSONEW("SIG",1),2,250) S PSONEW("INS")=PSONEW("SIG",1) D EN^PSOFSIG(.PSONEW,1) K NI,NC
"RTN","PSOORFI4",49,0)
 .F I=0:0 S I=$O(PRC(I)) Q:'I  S NI=NI+1,(PSONEW("INS",NI),X)=PRC(I) D SIGONE^PSOHELP S PSONEW("SIG",NI)=INS1 K INS1
"RTN","PSOORFI4",50,0)
 .I $E(PSONEW("SIG",1))=" " S PSONEW("SIG",1)=$E(PSONEW("SIG",1),2,250)
"RTN","PSOORFI4",51,0)
 .D EN^PSOFSIG(.PSONEW,1) K NI,NC,X
"RTN","PSOORFI4",52,0)
 Q
"RTN","PSOORFI4",53,0)
CHKCOM(PRC) ;Check provider comments array PRC. If any comment line is longer than 32 characters with no spaces, return 1
"RTN","PSOORFI4",54,0)
 ;*308
"RTN","PSOORFI4",55,0)
 ;INPUT:  PRC( = Provider Comments array
"RTN","PSOORFI4",56,0)
 ;OUTPUT: PSOERR  = O - OK
"RTN","PSOORFI4",57,0)
 ;                = 1 - Error (Comments > 32 chars. w/ no spaces)
"RTN","PSOORFI4",58,0)
 N PSOX,PSOY,PSOZ,PSOERR
"RTN","PSOORFI4",59,0)
 S PSOERR=0
"RTN","PSOORFI4",60,0)
 I '$D(PRC) Q PSOERR
"RTN","PSOORFI4",61,0)
 S PSOX=0
"RTN","PSOORFI4",62,0)
 F  S PSOX=$O(PRC(PSOX)) Q:PSOX=""!PSOERR  I $L(PRC(PSOX))>32 D
"RTN","PSOORFI4",63,0)
 .S PSOZ=$L(PRC(PSOX)," ") F PSOY=1:1:PSOZ I $L($P(PRC(PSOX)," ",PSOY))>32 S PSOERR=1 Q
"RTN","PSOORFI4",64,0)
 Q PSOERR
"RTN","PSOORFI4",65,0)
DOSE ;displays dosing info for pending orders.  called from psoorfi1
"RTN","PSOORFI4",66,0)
 K II,UNITS S DS=1
"RTN","PSOORFI4",67,0)
 I '$O(^PS(52.41,ORD,1,0)) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (3)        *Dosage:" G DOSEX
"RTN","PSOORFI4",68,0)
 F I=0:0 S I=$O(^PS(52.41,ORD,1,I)) Q:'I  S DOSE=$G(^PS(52.41,ORD,1,I,1)),DOSE1=$G(^(2)) D  D DOSE1
"RTN","PSOORFI4",69,0)
 .S II=$G(II)+1 K PSONEW("UNITS",II)
"RTN","PSOORFI4",70,0)
 .S PSONEW("DOSE",II)=$P(DOSE1,"^"),PSONEW("DOSE ORDERED",II)=$P(DOSE1,"^",2),PSONEW("UNITS",II)=$P(DOSE,"^",9),PSONEW("NOUN",II)=$P(DOSE,"^",5)
"RTN","PSOORFI4",71,0)
 .S:$P(DOSE,"^",9) UNITS=$P(^PS(50.607,$P(DOSE,"^",9),0),"^")
"RTN","PSOORFI4",72,0)
 .S PSONEW("VERB",II)=$P(DOSE,"^",10),PSONEW("ROUTE",II)=$P(DOSE,"^",8)
"RTN","PSOORFI4",73,0)
 .S ROUTE="" S:$P(DOSE,"^",8) ROUTE=$P(^PS(51.2,$P(DOSE,"^",8),0),"^")
"RTN","PSOORFI4",74,0)
 .S PSONEW("SCHEDULE",II)=$P(DOSE,"^"),PSONEW("DURATION",II)=$P(DOSE,"^",2)
"RTN","PSOORFI4",75,0)
 .S DOENT=$G(DOENT)+1 I $P(DOSE,"^",6)]"" S PSONEW("CONJUNCTION",II)=$S($P(DOSE,"^",6)="S":"T",$P(DOSE,"^",6)="X":"X",1:"A")
"RTN","PSOORFI4",76,0)
 .I 'PSONEW("DOSE ORDERED",II),$G(PSONEW("VERB",II))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Verb: "_$G(PSONEW("VERB",II))
"RTN","PSOORFI4",77,0)
 .S:$G(DS) IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (3)"
"RTN","PSOORFI4",78,0)
DOSEX S PSONEW("ENT")=+$G(II) K DOSE,DOSE1,II,I,UNITS,ROUTE,DG
"RTN","PSOORFI4",79,0)
 Q
"RTN","PSOORFI4",80,0)
DOSE1 I $G(DS)=1 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"        *Dosage:" D FMD^PSOORFI3 G DU
"RTN","PSOORFI4",81,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="            *Dosage:" D FMD^PSOORFI3
"RTN","PSOORFI4",82,0)
DU I 'PSONEW("DOSE ORDERED",I),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" *Oth. Lang. Dosage: "_$G(PSONEW("ODOSE",I))
"RTN","PSOORFI4",83,0)
 I PSONEW("DOSE ORDERED",II),$G(PSONEW("VERB",II))]"" D
"RTN","PSOORFI4",84,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Verb: "_$G(PSONEW("VERB",II))
"RTN","PSOORFI4",85,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     Dispense Units: "_$S($E(PSONEW("DOSE ORDERED",II),1)=".":"0",1:"")_PSONEW("DOSE ORDERED",II)
"RTN","PSOORFI4",86,0)
 I PSONEW("NOUN",II)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Noun: "_PSONEW("NOUN",II)
"RTN","PSOORFI4",87,0)
 I $G(ROUTE)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="             *Route: "_$G(ROUTE)
"RTN","PSOORFI4",88,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          *Schedule: "_PSONEW("SCHEDULE",II)
"RTN","PSOORFI4",89,0)
 I $G(PSONEW("DURATION",II))]"" D
"RTN","PSOORFI4",90,0)
 .S PSONEW("DURATION",II)=$S($E(PSONEW("DURATION",II),1)'?.N:$E(PSONEW("DURATION",II),2,99)_$E(PSONEW("DURATION",II),1),1:PSONEW("DURATION",II))
"RTN","PSOORFI4",91,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          *Duration: "_PSONEW("DURATION",II)_" ("_$S(PSONEW("DURATION",II)["M":"MINUTES",PSONEW("DURATION",II)["H":"HOURS",PSONEW("DURATION",II)["L":"MONTHS",PSONEW("DURATION",II)["W":"WEEKS",1:"DAYS")_")"
"RTN","PSOORFI4",92,0)
 I $G(PSONEW("CONJUNCTION",II))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       *Conjunction: "_$S(PSONEW("CONJUNCTION",II)="T":"THEN",PSONEW("CONJUNCTION",II)="X":"EXCEPT",1:"AND")
"RTN","PSOORFI4",93,0)
 Q
"RTN","PSOORFI4",94,0)
DOSE2 ;displays pending order after edits.  called from psoornew
"RTN","PSOORFI4",95,0)
 I '$O(PSONEW("DOSE",0))!($O(PSONEW("DOSE",0))="") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (3)        *Dosage:" Q
"RTN","PSOORFI4",96,0)
 S DS=1
"RTN","PSOORFI4",97,0)
 F I=1:1:PSONEW("ENT") Q:'I  D  D DOSE3 K COJ
"RTN","PSOORFI4",98,0)
 .S:$G(PSONEW("UNITS",I))]"" UNITS=$P(^PS(50.607,PSONEW("UNITS",I),0),"^")
"RTN","PSOORFI4",99,0)
 .I $G(PSONEW("ROUTE",I))]"",$G(^PS(51.2,PSONEW("ROUTE",I),0))]"" S ROUTE=$P(^PS(51.2,PSONEW("ROUTE",I),0),"^")
"RTN","PSOORFI4",100,0)
 .S DUR=$G(PSONEW("DURATION",I)) S:$G(PSONEW("CONJUNCTION",I))]"" COJ=PSONEW("CONJUNCTION",I)
"RTN","PSOORFI4",101,0)
 .S NOUN=$G(PSONEW("NOUN",I)),VERB=$G(PSONEW("VERB",I))
"RTN","PSOORFI4",102,0)
 .I '$G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOORFI4",103,0)
 .S:$G(DS) IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (3)"
"RTN","PSOORFI4",104,0)
 K I,UNITS,ROUTE,DUR,COJ,VERB,NOUN,DG
"RTN","PSOORFI4",105,0)
 Q
"RTN","PSOORFI4",106,0)
DOSE3 I $G(DS)=1 S II=I,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"        *Dosage:" D FMD^PSOORFI3 G DO
"RTN","PSOORFI4",107,0)
 S II=I,IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="            *Dosage:" D FMD^PSOORFI3
"RTN","PSOORFI4",108,0)
DO I '$G(PSONEW("DOSE ORDERED",I)),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" *Oth. Lang. Dosage: "_$G(PSONEW("ODOSE",I))
"RTN","PSOORFI4",109,0)
 I $G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOORFI4",110,0)
 I $G(PSONEW("DOSE ORDERED",I)) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     Dispense Units: "_$S($E(PSONEW("DOSE ORDERED",I),1)=".":"0",1:"")_PSONEW("DOSE ORDERED",I)
"RTN","PSOORFI4",111,0)
 I $G(PSONEW("NOUN",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               NOUN: "_PSONEW("NOUN",I)
"RTN","PSOORFI4",112,0)
 I $G(ROUTE)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="             *Route: "_$G(ROUTE)
"RTN","PSOORFI4",113,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          *Schedule: "_PSONEW("SCHEDULE",I)
"RTN","PSOORFI4",114,0)
 I $G(PSONEW("DURATION",I))]"" D
"RTN","PSOORFI4",115,0)
 .S PSONEW("DURATION",I)=$S($E(PSONEW("DURATION",I),1)'?.N:$E(PSONEW("DURATION",I),2,99)_$E(PSONEW("DURATION",I),1),1:PSONEW("DURATION",I))
"RTN","PSOORFI4",116,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          *Duration: "_PSONEW("DURATION",I)_" ("_$S(PSONEW("DURATION",I)["M":"MINUTES",PSONEW("DURATION",I)["H":"HOURS",PSONEW("DURATION",I)["L":"MONTHS",PSONEW("DURATION",I)["W":"WEEKS",1:"DAYS")_")"
"RTN","PSOORFI4",117,0)
 I $G(PSONEW("CONJUNCTION",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       *Conjunction: "_$S(PSONEW("CONJUNCTION",I)="T":"THEN",PSONEW("CONJUNCTION",I)="X":"EXCEPT",1:"AND")
"RTN","PSOORFI4",118,0)
 Q
"RTN","PSOORFI4",119,0)
OBX ;formats obx section
"RTN","PSOORFI4",120,0)
 N COM,II
"RTN","PSOORFI4",121,0)
 S IEN=0
"RTN","PSOORFI4",122,0)
 D:$G(PKI1) L1^PSOPKIV1
"RTN","PSOORFI4",123,0)
 I $O(^PS(52.41,ORD,"OBX",0)) S T=0,IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="CPRS Order Checks:" F  S T=$O(^PS(52.41,ORD,"OBX",T)) Q:'T  D  S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" "
"RTN","PSOORFI4",124,0)
 .S COM=$G(^PS(52.41,ORD,"OBX",T,0))
"RTN","PSOORFI4",125,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     " F II=1:1:$L(COM," ") D
"RTN","PSOORFI4",126,0)
 ..I $L(^TMP("PSOPO",$J,IEN,0)_" "_$P(COM," ",II))>80 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     "
"RTN","PSOORFI4",127,0)
 ..S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_" "_$P(COM," ",II)
"RTN","PSOORFI4",128,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     Overriding Provider: "_$G(^PS(52.41,ORD,"OBX",T,1))
"RTN","PSOORFI4",129,0)
 .I $O(^PS(52.41,ORD,"OBX",T,2,0)) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     Overriding Reason:"
"RTN","PSOORFI4",130,0)
 .F T1=0:0 S T1=$O(^PS(52.41,ORD,"OBX",T,2,T1)) Q:'T1  D
"RTN","PSOORFI4",131,0)
 ..S MIG=^PS(52.41,ORD,"OBX",T,2,T1,0)
"RTN","PSOORFI4",132,0)
 ..F SG=1:1:$L(MIG," ") S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",23)=" " S ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORFI4",133,0)
 Q
"RTN","PSOORFI4",134,0)
PP S PSODFN=PAT D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2)
"RTN","PSOORFI4",135,0)
 Q
"RTN","PSOORFI4",136,0)
SPL K PSOFIN S POERR("QFLG")=0 S PSONOLCK=1,PSOPTLOK=PAT
"RTN","PSOORFI4",137,0)
 Q
"RTN","PSOORFI4",138,0)
CLQTY ;
"RTN","PSOORFI4",139,0)
 K PSONEW("QTY")
"RTN","PSOORFI4",140,0)
 D QTY^PSOSIG(.PSONEW)
"RTN","PSOORFI4",141,0)
 S:'$G(PSONEW("QTY")) PSONEW("QTY")=0
"RTN","PSOORFI4",142,0)
 Q
"RTN","PSOORFI4",143,0)
PQTY ;
"RTN","PSOORFI4",144,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_", days supply of "_+$P(OR0,"^",22)_" and a qty of "_+$P(OR0,"^",10)
"RTN","PSOORFI4",145,0)
 Q
"RTN","PSOORNE3")
0^30^B69565652^B68981522
"RTN","PSOORNE3",1,0)
PSOORNE3 ;ISC-BHAM/SAB - display pending orders from backdoor ;2/3/05 1:59pm
"RTN","PSOORNE3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,9,39,59,46,103,124,139,152,194,391,313,444**;DEC 1997;Build 34
"RTN","PSOORNE3",3,0)
 ;Ext ref to ^SC (File #44) (DBIA 10040),^PSXOPUTL (DBIA 2200)
"RTN","PSOORNE3",4,0)
 ;^PS(50.606 (DBIA 2174),^PS(50.7 DBIA 2223),^PS(55,DBIA 2228)
"RTN","PSOORNE3",5,0)
 ;^PSDRUG (DBIA 221)
"RTN","PSOORNE3",6,0)
 K ^TMP("PSOPO",$J) S ORD=$P(PSOLST(ORN),"^",2) D ORD^PSOORFIN Q
"RTN","PSOORNE3",7,0)
 S PSODRUG("OI")=$P(OR0,"^",8),PSODRUG("OIN")=$P(^PS(50.7,$P(OR0,"^",8),0),"^")
"RTN","PSOORNE3",8,0)
 I $P($G(OR0),"^",9) S DREN=$P(OR0,"^",9) S POERR=1 D DRG^PSOORDRG K POERR ;D POST^PSODRG
"RTN","PSOORNE3",9,0)
 I '$P(OR0,"^",9) D DREN^PSOORNW2
"RTN","PSOORNE3",10,0)
 S PSONEW("# OF REFILLS")=$P(OR0,"^",11)
"RTN","PSOORNE3",11,0)
 S (Y,PSONEW("ISSUE DATE"))=$S($G(PSONEW("ISSUE DATE")):PSONEW("ISSUE DATE"),1:$E($P(OR0,"^",6),1,7)) X ^DD("DD")
"RTN","PSOORNE3",12,0)
 S PSONEW("CLERK CODE")=$P(OR0,"^",4),PSORX("CLERK CODE")=$P(^VA(200,$P(OR0,"^",4),0),"^")
"RTN","PSOORNE3",13,0)
 S (PSONEW("DFLG"),PSONEW("QFLG"))=0,PSODFN=$P(OR0,"^",2)
"RTN","PSOORNE3",14,0)
 I '$G(PSOMTFLG) S PSONEW("QTY")=$S($G(PSONEW("QTY")):PSONEW("QTY"),1:$P(OR0,"^",10))
"RTN","PSOORNE3",15,0)
 S PSONEW("MAIL/WINDOW")=$S($P(OR0,"^",17)]"":$P(OR0,"^",17),1:"W")
"RTN","PSOORNE3",16,0)
 S:$G(PSONEW("CLINIC"))']"" PSONEW("CLINIC")=$P(OR0,"^",13)
"RTN","PSOORNE3",17,0)
 S:$G(PSORX("CLINIC"))']"" PSORX("CLINIC")=$S($D(^SC(+$P(OR0,"^",13),0)):$P(^SC($P(OR0,"^",13),0),"^"),1:"")
"RTN","PSOORNE3",18,0)
 S PSONEW("CLERK CODE")=$P(OR0,"^",4),PSONEW("PROVIDER")=$P(OR0,"^",5),PSONEW("PROVIDER NAME")=$P(^VA(200,$P(OR0,"^",5),0),"^")
"RTN","PSOORNE3",19,0)
 S PSONEW("PATIENT STATUS")=$S(+$G(^PS(55,PSODFN,"PS")):+$G(^PS(55,PSODFN,"PS")),1:"")
"RTN","PSOORNE3",20,0)
 S PSONEW("DAYS SUPPLY")=$S(+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3)):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:30)
"RTN","PSOORNE3",21,0)
 S IEN=0 D OBX^PSOORFI1,DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:"")) ;Setup for N/F & DIN indicator
"RTN","PSOORNE3",22,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="* (1) Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNE3",23,0)
 S:NFIO["DIN" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNE3",24,0)
 K LST S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (2)           Drug: "_$S($G(PSODRUG("NAME"))]"":PSODRUG("NAME")_NFID,1:"No Dispense Drug Selected")
"RTN","PSOORNE3",25,0)
 S:NFID["DIN" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNE3",26,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (3) Patient Status: "_$P($G(^PS(53,PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORNE3",27,0)
 S IEN=IEN+1,(PSOID,Y)=$E($P(OR0,"^",6),1,7) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)="   (4)     Issue Date: "_Y
"RTN","PSOORNE3",28,0)
 S (Y,PSONEW("FILL DATE"))=$E($P(OR0,"^",6),1,7) X ^DD("DD") S PSONEW("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                       (5) Fill Date: "_Y
"RTN","PSOORNE3",29,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Instructions:" S TY=3 D INST^PSOORFI1
"RTN","PSOORNE3",30,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (6)   Possible SIG: " D:$G(PSONEW("SIG"))']"" SIG^PSOORFI1 S:$G(PSONEW("SIG"))]"" IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$G(PSONEW("SIG")),IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=PSOERR("SIG")
"RTN","PSOORNE3",31,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (7)    Days Supply: "_$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3)):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:"")
"RTN","PSOORNE3",32,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                                 (8)     QTY: "_$P(OR0,"^",10)
"RTN","PSOORNE3",33,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (9)   # of Refills: "_$P(OR0,"^",11)_$E("  ",$L($P(OR0,"^",11))+1,2)_"                                (10) Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORNE3",34,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (11)         Clinic: "_PSORX("CLINIC")
"RTN","PSOORNE3",35,0)
 S $P(RN," ",32)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (12)       Provider: "_PSONEW("PROVIDER NAME")_$E(RN,$L(PSONEW("PROVIDER NAME"))+1,32)_"  (13)  Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1) K RN
"RTN","PSOORNE3",36,0)
 I $P(^VA(200,$S($G(PSONEW("PROVIDER")):PSONEW("PROVIDER"),1:$P(OR0,"^",5)),"PS"),"^",7)&($P(^("PS"),"^",8)) S IEN=IEN+1,PSONEW("COSIGNING PROVIDER")=$P(^("PS"),"^",8) D
"RTN","PSOORNE3",37,0)
 .S ^TMP("PSOPO",$J,IEN,0)="        Cos-Provider: "_$P(^VA(200,+$G(PSONEW("COSIGNING PROVIDER")),0),"^")
"RTN","PSOORNE3",38,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Provider Comments:" S TY=2 D INST^PSOORFI1
"RTN","PSOORNE3",39,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (14)        Remarks: "
"RTN","PSOORNE3",40,0)
 I $G(PSONEW("REMARKS"))]"" D
"RTN","PSOORNE3",41,0)
 .F SG=1:1:$L(PSONEW("REMARKS")) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("REMARKS")," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNE3",42,0)
 ..S:$P(PSONEW("REMARKS")," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("REMARKS")," ",SG)
"RTN","PSOORNE3",43,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,$P(OR0,"^",4),0),"^")_$E(RN,$L($P(^VA(200,$P(OR0,"^",4),0),"^"))+1,35)
"RTN","PSOORNE3",44,0)
 S Y=$P(OR0,"^",12) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$E($P(OR0,"^",12),4,5)_"/"_$E($P(OR0,"^",12),6,7)_"/"_$E($P(OR0,"^",12),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORNE3",45,0)
 G ^PSOLMPO
"RTN","PSOORNE3",46,0)
 Q
"RTN","PSOORNE3",47,0)
DSPL ;backdoor
"RTN","PSOORNE3",48,0)
 K ^TMP("PSOPO",$J) D DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:"")) ;NFI
"RTN","PSOORNE3",49,0)
 I $D(RX0),$D(PSODRUG("IEN")) D
"RTN","PSOORNE3",50,0)
 .I PSODRUG("IEN")=$P(RX0,"^",6)!($P(PSLST,",",2)) D RST
"RTN","PSOORNE3",51,0)
 S IEN=0,IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNE3",52,0)
 S:NFIO["DIN" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNE3",53,0)
 I $G(PSODRUG("NAME"))]"" D  G PST
"RTN","PSOORNE3",54,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (1)"_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORNE3",55,0)
 .S:NFID["DIN" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNE3",56,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (1)           Drug: No Dispense Drug Selected"
"RTN","PSOORNE3",57,0)
PST S:$G(PSODRUG("TRADE NAME"))]"" IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          Trade Name: "_$S($G(PSODRUG("TRADE NAME"))]"":PSODRUG("TRADE NAME"),1:"")
"RTN","PSOORNE3",58,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (2) Patient Status: "_$P($G(^PS(53,PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORNE3",59,0)
 I $G(PSOID) S Y=PSOID X ^DD("DD") S PSONEW("ISSUE DATE")=Y
"RTN","PSOORNE3",60,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (3)     Issue Date: "_PSONEW("ISSUE DATE")
"RTN","PSOORNE3",61,0)
 S X2=PSONEW("DAYS SUPPLY")*(PSONEW("# OF REFILLS")+1)\1
"RTN","PSOORNE3",62,0)
 S X1=$S($G(PSOID):PSOID,1:DT)
"RTN","PSOORNE3",63,0)
 S X2=$S(PSONEW("DAYS SUPPLY")=X2:X2,+$G(PSOX("CS")):184,1:366)
"RTN","PSOORNE3",64,0)
 I X2<30 D
"RTN","PSOORNE3",65,0)
 . N % S %=$P($G(PSORX("PATIENT STATUS")),"^"),X2=30
"RTN","PSOORNE3",66,0)
 . S:%?.N %=$P($G(^PS(53,+%,0)),"^") I %["AUTH ABS" S X2=5
"RTN","PSOORNE3",67,0)
 D C^%DTC I PSONEW("FILL DATE")>X S PSONEW("FILL DATE")=PSONEW("ISSUE DATE")
"RTN","PSOORNE3",68,0)
 S Y=PSONEW("FILL DATE") X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"             (4) Fill Date: "_Y
"RTN","PSOORNE3",69,0)
 D DOSE^PSOBKDED
"RTN","PSOORNE3",70,0)
 I $G(PSORXED("IRXN")),'$G(PSOSIGFL) S RXN=PSORXED("IRXN") D:'$G(COPY) INST1^PSOORNE5 K RXN
"RTN","PSOORNE3",71,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                 SIG:"
"RTN","PSOORNE3",72,0)
 I $G(SIGOK),$O(SIG(0)) D SIG G DSP
"RTN","PSOORNE3",73,0)
 I $D(PSOCOPY),$G(PSONEW("SIG"))']"" D SIG G DSP
"RTN","PSOORNE3",74,0)
 I $G(PSOSIGFL),$G(PSONEW("SIG"))']"" D SIG G DSP
"RTN","PSOORNE3",75,0)
 D:$G(PSONEW("SIG"))]""
"RTN","PSOORNE3",76,0)
 .S X=PSONEW("SIG") D SIGONE^PSOHELP S SIG=$E($G(INS1),2,250)
"RTN","PSOORNE3",77,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNE3",78,0)
DSP S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (7)    Days Supply: "_PSONEW("DAYS SUPPLY")_$S($L(PSONEW("DAYS SUPPLY"))=1:" ",1:"")
"RTN","PSOORNE3",79,0)
 I '$D(PSONEW("FLD")),$D(RX0),'$G(PSOMTFLG) S PSONEW("QTY")=$S($G(PSONEW("QTY")):PSONEW("QTY"),1:$P(RX0,"^",7))
"RTN","PSOORNE3",80,0)
 ;if sched PSONEW("FLD") not def. qty reset
"RTN","PSOORNE3",81,0)
 ;if qty PSONEW("FLD")=7, qty NOT reset
"RTN","PSOORNE3",82,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                     (8)   QTY"_$S($G(PSODRUG("UNIT"))]"":" ("_PSODRUG("UNIT")_")",1:" ( )")_": "_PSONEW("QTY")
"RTN","PSOORNE3",83,0)
 I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),5)),"^")]"" D
"RTN","PSOORNE3",84,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNE3",85,0)
 .S ^TMP("PSOPO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^") K RN
"RTN","PSOORNE3",86,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (9)   # of Refills: "_PSONEW("# OF REFILLS")_$S($L(PSONEW("# OF REFILLS"))=1:" ",1:"")_"                     (10)  Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORNE3",87,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (11)         Clinic: "_$S($G(PSONEW("CLINIC")):$P(^SC(PSONEW("CLINIC"),0),"^"),1:"")
"RTN","PSOORNE3",88,0)
 S $P(RN," ",31)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (12)       Provider: "_PSONEW("PROVIDER NAME")_$E(RN,$L(PSONEW("PROVIDER NAME"))+1,31)_"(13)   Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1) K RN
"RTN","PSOORNE3",89,0)
 I $G(PKI),+$G(PSODRUG("DEA"))>1,+$G(PSODRUG("DEA"))<6 D PRV^PSOORFI5($G(PSONEW("PROVIDER")),$G(PSODRUG("IEN")),$P(OR0,"^"))
"RTN","PSOORNE3",90,0)
 I $G(PSONEW("COSIGNING PROVIDER"))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="        Cos-Provider: "_$P(^VA(200,PSONEW("COSIGNING PROVIDER"),0),"^")
"RTN","PSOORNE3",91,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (14)        Remarks:"
"RTN","PSOORNE3",92,0)
 I $G(PSONEW("REMARKS"))]"" D
"RTN","PSOORNE3",93,0)
 .F SG=1:1:$L(PSONEW("REMARKS")) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("REMARKS")," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " D
"RTN","PSOORNE3",94,0)
 ..S:$P(PSONEW("REMARKS")," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("REMARKS")," ",SG)
"RTN","PSOORNE3",95,0)
 I $G(PSORXED("IRXN")),'$G(PSOSIGFL) S RXN=PSORXED("IRXN") D:'$G(COPY) PC1^PSOORNE5 K RXN
"RTN","PSOORNE3",96,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,DUZ,0),"^")_$E(RN,$L($P(^VA(200,DUZ,0),"^"))+1,35)
"RTN","PSOORNE3",97,0)
 D NOW^%DTC S PSONEW("LOGIN DATE")=% K %,X S Y=PSONEW("LOGIN DATE") X ^DD("DD")
"RTN","PSOORNE3",98,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$P(Y,"@")_" "_$P(Y,"@",2) K RN,PSOFDR
"RTN","PSOORNE3",99,0)
 S (VALMCNT,PSOPF)=IEN Q
"RTN","PSOORNE3",100,0)
SIG ;
"RTN","PSOORNE3",101,0)
 D SIG^PSOORNE6 Q
"RTN","PSOORNE3",102,0)
CMOP ;
"RTN","PSOORNE3",103,0)
 K PSXZ S X="PSXOPUTL" X ^%ZOSF("TEST") K X I  D
"RTN","PSOORNE3",104,0)
 .S DA=RXN D ^PSXOPUTL K DA,PSOCMOP
"RTN","PSOORNE3",105,0)
 .S PSOCMOP=$S($G(PSXZ(PSXZ("L")))=0!($G(PSXZ(PSXZ("L")))=2):"Transmitted",$G(PSXZ(PSXZ("L")))=1:"Released",$G(PSXZ(PSXZ("L")))=3:"Not Dispensed",1:"")
"RTN","PSOORNE3",106,0)
 .I $G(PSXZ(PSXZ("L")))=3 F LBL=0:0 S LBL=$O(^PSRX(RXN,"L",LBL)) Q:'LBL  I $P(^PSRX(RXN,"L",LBL,0),"^",2)=PSXZ("L"),'$P(^(0),"^",5),$P(^(0),"^",3)'["INTERACTION" S PSOCMOP="Local"
"RTN","PSOORNE3",107,0)
 .K PSXZ
"RTN","PSOORNE3",108,0)
 Q
"RTN","PSOORNE3",109,0)
RST ;
"RTN","PSOORNE3",110,0)
 S PSODRUG("IEN")=$P(RX0,"^",6),PSODRUG("OI")=$P(^PSDRUG(($P(RX0,"^",6)),2),"^")
"RTN","PSOORNE3",111,0)
 S PSODRUG("NAME")=$P(^PSDRUG(($P(RX0,"^",6)),0),"^")
"RTN","PSOORNE3",112,0)
 Q
"RTN","PSOORNE3",113,0)
RMK ;
"RTN","PSOORNE3",114,0)
 I $P(RX3,"^",7)]"" D
"RTN","PSOORNE3",115,0)
 .F SG=1:1:$L($P(RX3,"^",7)) S:$L(^TMP("PSOAO",$J,IEN,0)_" "_$P($P(RX3,"^",7)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOAO",$J,IEN,0)," ",21)=" " D
"RTN","PSOORNE3",116,0)
 ..S:$P($P(RX3,"^",7)," ",SG)'="" ^TMP("PSOAO",$J,IEN,0)=$G(^TMP("PSOAO",$J,IEN,0))_" "_$P($P(RX3,"^",7)," ",SG)
"RTN","PSOORNE3",117,0)
 Q
"RTN","PSOORNE5")
0^9^B54881611^B68801944
"RTN","PSOORNE5",1,0)
PSOORNE5 ;BIR/SAB - display orders from backdoor con't ;5/10/07 8:29am
"RTN","PSOORNE5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,32,46,78,99,117,131,146,171,180,210,222,268,206,225,391,444**;DEC 1997;Build 34
"RTN","PSOORNE5",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORNE5",4,0)
 ;External references L and UL^PSSLOCK supported by DBIA 2789
"RTN","PSOORNE5",5,0)
 ;External reference to ^PS(51.2 supported by DBIA 2226
"RTN","PSOORNE5",6,0)
 ;External reference to ^PS(50.607 supported by DBIA 2221
"RTN","PSOORNE5",7,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOORNE5",8,0)
 ;called from PSOORNE2
"RTN","PSOORNE5",9,0)
 ;PSO*210 add call to WORDWRAP api
"RTN","PSOORNE5",10,0)
 ;
"RTN","PSOORNE5",11,0)
PEN ;pending orders
"RTN","PSOORNE5",12,0)
 K ^TMP("PSOPO",$J),PSORX("ISSUE DATE"),PSORX("FILL DATE") S ORSV=ORD,ORD=$P(PSOLST(ORN),"^",2)
"RTN","PSOORNE5",13,0)
 I $P($G(^PS(52.41,ORD,0)),"^",3)="DC"!($P($G(^(0)),"^",3)="DE") S VALMBCK="R" Q
"RTN","PSOORNE5",14,0)
 I $G(PSODFN)'=$P($G(^PS(52.41,ORD,0)),"^",2) S VALMBCK="" Q
"RTN","PSOORNE5",15,0)
 I $G(PSOTPBFG) N PSOTPPEN,PSOTPPEX S PSOTPPEN=ORD,PSOTPPEX=0 D VOPNR^PSOTPCAN I PSOTPPEX K PSOTPPEX,PSOTPPEN S VALMBCK="R" Q
"RTN","PSOORNE5",16,0)
 K PSOTPPEX,PSOTPPEN
"RTN","PSOORNE5",17,0)
 I '$G(PSOFIN) S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient."),VALMBCK="" K PSOPLCK Q
"RTN","PSOORNE5",18,0)
 K PSOPLCK
"RTN","PSOORNE5",19,0)
 S PSODRG=+$P($G(^PS(52.41,ORD,0)),"^",9) I $G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) S VALMSG="This Drug has been Inactivated."
"RTN","PSOORNE5",20,0)
 I $P($G(^PS(52.41,ORD,0)),"^",24) S PSOACT=$S($D(^XUSEC("PSDRPH",DUZ)):"DEFX",$D(^XUSEC("PSORPH",DUZ)):"F",$P($G(PSOPAR),"^",2):"F",1:"")
"RTN","PSOORNE5",21,0)
 E  S PSOACT=$S($D(^XUSEC("PSORPH",DUZ)):"DEFX",'$D(^XUSEC("PSORPH",DUZ))&($P($G(PSOPAR),"^",2)):"F",1:"")
"RTN","PSOORNE5",22,0)
 K PSOMSG
"RTN","PSOORNE5",23,0)
OK S PAT=PSODFN,PSORNSV=ORN,PSORNLT=PSLST D ORD^PSOORFIN S PSLST=PSORNLT,ORD=ORSV,ORN=PSORNSV K ORSV,PSORNSV,PSORNLT,PSODRUG S VALMBCK="R"
"RTN","PSOORNE5",24,0)
 K ORCHK,ORDRG,PSOFDR,SIGOK,PSONEW,PSORX("ISSUE DATE"),PSORX("FILL DATE"),PSORX("FN")
"RTN","PSOORNE5",25,0)
 K:'$G(MEDP) PAT
"RTN","PSOORNE5",26,0)
 D CLEAN^PSOVER1
"RTN","PSOORNE5",27,0)
 I '$G(PSOFIN) D UL^PSSLOCK(PSODFN)
"RTN","PSOORNE5",28,0)
 Q
"RTN","PSOORNE5",29,0)
RXNCHK S PSOY=$O(PSONEW("OLD LAST RX#","")) I PSOY="" D AUTO^PSONRXN Q
"RTN","PSOORNE5",30,0)
 S PSONRXN("TYPE")=$S('+$G(^PS(59,+PSOSITE,2)):8,PSODRUG("DEA")["A"&(+$G(^PS(59,+PSOSITE,2))):3,1:8)
"RTN","PSOORNE5",31,0)
 S PSONEW("QFLG")=0 I PSOY'=PSONRXN("TYPE"),$P($G(PSOPAR),"^",7)=1 D
"RTN","PSOORNE5",32,0)
 .S DIE="^PS(59,",DA=PSOSITE,PSOX=PSONEW("OLD LAST RX#",PSOY)
"RTN","PSOORNE5",33,0)
 .L +^PS(59,+PSOSITE,PSOY):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSOORNE5",34,0)
 .S DR=$S(PSOY=8:"2003////"_PSOX,PSOY=3:"1002.1////"_PSOX,1:"2003////"_PSOX)
"RTN","PSOORNE5",35,0)
 .D:PSOX<$P(^PS(59,+PSOSITE,PSOY),"^",3) ^DIE K DIE,X,Y L -^PS(59,+PSOSITE,PSOY)
"RTN","PSOORNE5",36,0)
 .L +^PS(59,+PSOSITE,PSONRXN("TYPE")):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSOORNE5",37,0)
 .S PSOX1=^PS(59,+PSOSITE,PSONRXN("TYPE")),PSONRXN("LO")=$P(PSOX1,"^")
"RTN","PSOORNE5",38,0)
 .S PSONRXN("HI")=$P(PSOX1,"^",2),PSOI=$P(PSOX1,"^",3),PSONEW("OLD LAST RX#",PSONRXN("TYPE"))=PSOI
"RTN","PSOORNE5",39,0)
 .S:PSOI<PSONRXN("LO") PSOI=PSONRXN("LO")
"RTN","PSOORNE5",40,0)
 .D LOOP2 I PSONEW("QFLG") L -^PS(59,+PSOSITE,PSONRXN("TYPE")),-^PSRX("B",PSOI) Q
"RTN","PSOORNE5",41,0)
 .K DIC,DIE,DA S DIE=59,DA=PSOSITE
"RTN","PSOORNE5",42,0)
 .S DR=$S(PSONRXN("TYPE")=8:"2003////"_PSOI,PSONRXN("TYPE")=3:"1002.1////"_PSOI,1:"2003////"_PSOI)
"RTN","PSOORNE5",43,0)
 .S PSONEW("RX #")=PSOI D ^DIE K DIE,DIC,DR,DA L -^PS(59,+PSOSITE,PSONRXN("TYPE"))
"RTN","PSOORNE5",44,0)
 .K PSOX1,PSONRXN,PSOI,X,Y
"RTN","PSOORNE5",45,0)
 Q
"RTN","PSOORNE5",46,0)
LOOP2 F  S PSOI=PSOI+1 D:PSOI>PSONRXN("HI") FATAL^PSONRXN Q:'$D(^PSRX("B",PSOI))!PSONEW("QFLG")
"RTN","PSOORNE5",47,0)
 L +^PSRX("B",PSOI):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I $D(^PSRX("B",PSOI))!'$T G LOOP2
"RTN","PSOORNE5",48,0)
 L -^PSRX("B",PSOI)
"RTN","PSOORNE5",49,0)
 Q
"RTN","PSOORNE5",50,0)
RDSPL ;
"RTN","PSOORNE5",51,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSOORNE5",52,0)
 N MAXRF S MAXRF=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),+$G(PSONEW("DAYS SUPPLY")),+$G(PSONEW("PATIENT STATUS")),.CLOZPAT)
"RTN","PSOORNE5",53,0)
 S (PSONEW("# OF REFILLS"),PSONEW("N# REF"))=$S(($G(PSONEW("# OF REFILLS"))'="")&($G(PSONEW("# OF REFILLS"))'>MAXRF):PSONEW("# OF REFILLS"),1:MAXRF)
"RTN","PSOORNE5",54,0)
 Q
"RTN","PSOORNE5",55,0)
 ;
"RTN","PSOORNE5",56,0)
GET ;
"RTN","PSOORNE5",57,0)
 I $P(PSODRUG0,"^",3)["2" S (ACTREF,ACTREN)=0 Q
"RTN","PSOORNE5",58,0)
 S (ACTREF,ACTREN)=1
"RTN","PSOORNE5",59,0)
 ;refills
"RTN","PSOORNE5",60,0)
 I ST S ACTREF=0
"RTN","PSOORNE5",61,0)
 I '$P(PSOPAR,"^",11),$G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) S ACTREF=0,VALMSG="Inactive Drug, Non Refillable!"
"RTN","PSOORNE5",62,0)
 S PSORFRM=$P(RX0,"^",9) F PSOJ=0:0 S PSOJ=$O(^PSRX(RXN,1,PSOJ)) Q:'PSOJ  S PSORFRM=PSORFRM-1
"RTN","PSOORNE5",63,0)
 S:PSORFRM<0 PSORFRM=0 S:PSORFRM=0 ACTREF=0
"RTN","PSOORNE5",64,0)
 I $G(RXFL(RXN))]"",'$P(PSOPAR,"^",6) S ACTREF=0
"RTN","PSOORNE5",65,0)
 I $P(PSODRUG0,"^",3)["A"&($P(PSODRUG0,"^",3)'["B")!($P(PSODRUG0,"^",3)["F")!($P(PSODRUG0,"^",3)[1)!($P(PSODRUG0,"^",3)[2) S ACTREF=0
"RTN","PSOORNE5",66,0)
 ;renews
"RTN","PSOORNE5",67,0)
 I $P(PSOPAR,"^",4)=0 S ACTREN=0 Q
"RTN","PSOORNE5",68,0)
 I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" S ACTREN=0
"RTN","PSOORNE5",69,0)
 I $G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) S ACTREN=0,VALMSG="This Drug has been Inactivated."
"RTN","PSOORNE5",70,0)
 I '$P($G(^PSDRUG(PSODRG,2)),"^"),'$P($G(^PSRX(RXN,"OR1")),"^") S ACTREN=0,VALMSG="Drug must be Matched to an Orderable Item!"
"RTN","PSOORNE5",71,0)
 I ($P(PSODRUG0,"^",3)["W")!($P(PSODRUG0,"^",3)[1)!($P(PSODRUG0,"^",3)[2) S ACTREN=0
"RTN","PSOORNE5",72,0)
 I $D(^PS(53,+$P(RX0,"^",3),0)),'$P(^(0),"^",5) S ACTREN=0
"RTN","PSOORNE5",73,0)
 S PSOLC=$P(RX0,"^"),PSOLC=$E(PSOLC,$L(PSOLC)) I $A(PSOLC)'<90 S ACTREN=0
"RTN","PSOORNE5",74,0)
 I ST,ST'=2,ST'=5,ST'=6,ST'=11,ST'=12 S ACTREN=0
"RTN","PSOORNE5",75,0)
 K PSORFRM,PSOLC,PSODRG,PSODRUG0
"RTN","PSOORNE5",76,0)
 Q
"RTN","PSOORNE5",77,0)
INST ;formats instruction from front door
"RTN","PSOORNE5",78,0)
 D INST^PSOORNE6 Q
"RTN","PSOORNE5",79,0)
PC ;displays provider comments
"RTN","PSOORNE5",80,0)
 D PC^PSOORNE6 Q
"RTN","PSOORNE5",81,0)
INST1 ;formats instruction from front door
"RTN","PSOORNE5",82,0)
 D INST1^PSOORNE6 Q
"RTN","PSOORNE5",83,0)
PC1 ;displays provider comments
"RTN","PSOORNE5",84,0)
 D PC1^PSOORNE6 Q
"RTN","PSOORNE5",85,0)
DOSE ;displays dosing instruction for both simple and complex backdoor Rxs.
"RTN","PSOORNE5",86,0)
 I '$O(^PSRX(RXN,6,0))  S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" (3)          Dosage: " Q
"RTN","PSOORNE5",87,0)
 S DS=1 F I=0:0 S I=$O(^PSRX(RXN,6,I)) Q:'I  S DOSE=^PSRX(RXN,6,I,0) D
"RTN","PSOORNE5",88,0)
 .I '$P(DOSE,"^",2),$P(DOSE,"^",9)]"" S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                Verb: "_$P(DOSE,"^",9)
"RTN","PSOORNE5",89,0)
 .I $G(DS)=1 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" (3)"
"RTN","PSOORNE5",90,0)
 .D DOSE1 S PSORXED("ENT")=$G(PSORXED("ENT"))+1
"RTN","PSOORNE5",91,0)
 K DOSE,I
"RTN","PSOORNE5",92,0)
 Q
"RTN","PSOORNE5",93,0)
DOSE1 ;
"RTN","PSOORNE5",94,0)
 I $G(DS)=1 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"         *Dosage: "_$S($E($P(DOSE,"^"),1)="."&($P(DOSE,"^",2)):"0",1:"")_$P(DOSE,"^")_$S($P(DOSE,"^",3)]"":" ("_$P(^PS(50.607,$P(DOSE,"^",3),0),"^")_")",1:"") K DS G DU
"RTN","PSOORNE5",95,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="             *Dosage: "_$S($E($P(DOSE,"^"),1)="."&($P(DOSE,"^",2)):"0",1:"")_$P(DOSE,"^")_$S($P(DOSE,"^",3)]"":" ("_$P(^PS(50.607,$P(DOSE,"^",3),0),"^")_")",1:"")
"RTN","PSOORNE5",96,0)
DU I '$P(DOSE,"^",2),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="   Oth. Lang. Dosage: "_$G(^PSRX(RXN,6,I,1))
"RTN","PSOORNE5",97,0)
 I $P(DOSE,"^",2),$P(DOSE,"^",9)]"" D
"RTN","PSOORNE5",98,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                Verb: "_$P(DOSE,"^",9)
"RTN","PSOORNE5",99,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="      Dispense Units: "_$S($E($P(DOSE,"^",2),1)=".":"0",1:"")_$P(DOSE,"^",2)
"RTN","PSOORNE5",100,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                Noun: "_$P(DOSE,"^",4)
"RTN","PSOORNE5",101,0)
 I $P(DOSE,"^",7) S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="              *Route: "_$P(^PS(51.2,$P(DOSE,"^",7),0),"^")
"RTN","PSOORNE5",102,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="           *Schedule: "_$P(DOSE,"^",8)
"RTN","PSOORNE5",103,0)
 I $P(DOSE,"^",5)]"" D
"RTN","PSOORNE5",104,0)
 .S DUR=$S($E($P(DOSE,"^",5),1)'?.N:$E($P(DOSE,"^",5),2,99)_$E($P(DOSE,"^",5),1),1:$P(DOSE,"^",5))
"RTN","PSOORNE5",105,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="           *Duration: "_DUR_" ("_$S($P(DOSE,"^",5)["M":"MINUTES",$P(DOSE,"^",5)["H":"HOURS",$P(DOSE,"^",5)["L":"MONTHS",$P(DOSE,"^",5)["W":"WEEKS",1:"DAYS")_")" K DUR
"RTN","PSOORNE5",106,0)
 I $P(DOSE,"^",6)]"" S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="        *Conjunction: "_$S($P(DOSE,"^",6)="A":"AND",$P(DOSE,"^",6)="T":"THEN",$P(DOSE,"^",6)="X":"EXCEPT",1:"")
"RTN","PSOORNE5",107,0)
 Q
"RTN","PSOORNE5",108,0)
INS ;patient instructions                                        ;PSO*210
"RTN","PSOORNE5",109,0)
 I $G(^PSRX(RXN,"INS"))]"",'$O(^PSRX(RXN,"INS1",0)) D  K SG G SPINS
"RTN","PSOORNE5",110,0)
 .S PSORXED("SIG",1)=^PSRX(RXN,"INS")
"RTN","PSOORNE5",111,0)
 .D WORDWRAP^PSOUTLA2(^PSRX(RXN,"INS"),.IEN,$NA(^TMP("PSOAO",$J)),21)
"RTN","PSOORNE5",112,0)
 ;
"RTN","PSOORNE5",113,0)
 I $O(^PSRX(RXN,"INS1",0)) D
"RTN","PSOORNE5",114,0)
 .S T=0 F  S T=$O(^PSRX(RXN,"INS1",T)) Q:'T  D
"RTN","PSOORNE5",115,0)
 .. S (PSORXED("SIG",T),MIG)=^PSRX(RXN,"INS1",T,0)
"RTN","PSOORNE5",116,0)
 .. D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAO",$J)),21)
"RTN","PSOORNE5",117,0)
SPINS K T,SG,MIG
"RTN","PSOORNE5",118,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="  Other Pat. Instruc: "_$S($G(^PSRX(RXN,"INSS"))]"":^PSRX(RXN,"INSS"),1:"")
"RTN","PSOORNE5",119,0)
 Q
"RTN","PSOORNE5",120,0)
SV S VALMSG="Pre-POE Rx. Please Compare Dosing Fields with SIG!"
"RTN","PSOORNE5",121,0)
 Q
"RTN","PSOORNE5",122,0)
PRV ;
"RTN","PSOORNE5",123,0)
 N DETN,DEA,I,LBL,VADD,SPC,ORN S ORN=ORD
"RTN","PSOORNE5",124,0)
 S DEA=$$DEA^XUSER(0,$P(RX0,"^",4))
"RTN","PSOORNE5",125,0)
 S LBL=$S(DEA["-":"  VA#: ",1:" DEA#: ")
"RTN","PSOORNE5",126,0)
 I $$DETOX^PSSOPKI($P(RX0,"^",6)) S DETN=$$DETOX^XUSER($P(RX0,"^",4))
"RTN","PSOORNE5",127,0)
 S $P(SPC," ",(28-$L(DEA)))=" "
"RTN","PSOORNE5",128,0)
 I (DEA'="")!($G(DETN)'="") S IEN=IEN+1,$E(^TMP("PSOAO",$J,IEN,0),16)=LBL_DEA_$S($G(DETN)]"":SPC_"DETOX#: "_$G(DETN),1:"")
"RTN","PSOORNE5",129,0)
 D PRVAD^PSOPKIV2
"RTN","PSOORNE5",130,0)
 I $G(VADD(1))]"" D
"RTN","PSOORNE5",131,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="        Site Address: "_VADD(1)
"RTN","PSOORNE5",132,0)
 .S:VADD(2)'="" IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                      "_VADD(2) S:VADD(3)'="" IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                      "_VADD(3)
"RTN","PSOORNE5",133,0)
 Q
"RTN","PSOORNEW")
0^24^B97649814^B94643833
"RTN","PSOORNEW",1,0)
PSOORNEW ;BIR/SAB - display orders from oerr ;6/19/06 3:53pm
"RTN","PSOORNEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,55,46,71,90,94,106,131,133,143,237,222,258,206,225,251,386,390,391,372,416,431,313,408,436,411,444**;DEC 1997;Build 34
"RTN","PSOORNEW",3,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORNEW",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORNEW",5,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOORNEW",6,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORNEW",7,0)
 ;External reference to EN1^ORCFLAG supported by DBIA 3620
"RTN","PSOORNEW",8,0)
 ;
"RTN","PSOORNEW",9,0)
 ;PSO*237 quit Finish if Today > Issue date + 365
"RTN","PSOORNEW",10,0)
 ;
"RTN","PSOORNEW",11,0)
DSPL I $G(PSODSPL) S VALMBCK="Q" K PSODSPL,PSOANSQD Q
"RTN","PSOORNEW",12,0)
 Q:'$D(PSOLMC)  K ^TMP("PSOPO",$J) S PSOLMC=PSOLMC+1
"RTN","PSOORNEW",13,0)
 I $D(CLOZPAT) S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),1:7) G OI
"RTN","PSOORNEW",14,0)
 S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3))&('$G(PSONEW("DAYS SUPPLY"))):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:30)
"RTN","PSOORNEW",15,0)
OI I '$G(PSODRUG("OI")) D
"RTN","PSOORNEW",16,0)
 .N OI,OID S (OI,PSODRUG("OI"))=$P(OR0,"^",8),PSODRUG("OIN")=$P(^PS(50.7,$P(OR0,"^",8),0),"^"),OID=$P(OR0,"^",9)
"RTN","PSOORNEW",17,0)
 .I $P($G(OR0),"^",9) S POERR=1,DREN=$P(OR0,"^",9) D DRG^PSOORDRG K POERR
"RTN","PSOORNEW",18,0)
 I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A",$G(PSODRUG("DEA"))'["B"!($G(PSODRUG("DEA"))["F") S PSONEW("# OF REFILLS")=0
"RTN","PSOORNEW",19,0)
 I $D(CLOZPAT) S PSONEW("# OF REFILLS")=$S($D(PSONEW("# OF REFILLS")):PSONEW("# OF REFILLS"),$G(CLOZPAT)=2&($P(OR0,"^",11)>2):3,$G(CLOZPAT)&($P(OR0,"^",11)>1):1,1:0)
"RTN","PSOORNEW",20,0)
 S IEN=0 D OBX^PSOORFI1,DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:""))
"RTN","PSOORNEW",21,0)
 D LMDISP^PSOORFI5(+$G(ORD)) ; Display Flag/Unflag Information
"RTN","PSOORNEW",22,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="*(1) Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNEW",23,0)
 S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",24,0)
 K LST I $G(PSODRUG("NAME"))]"" D  G PT
"RTN","PSOORNEW",25,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)"_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORNEW",26,0)
 .S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",27,0)
 .I $P($G(^PSDRUG(PSODRUG("IEN"),0)),"^",10)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Drug Message:" D DRGMSG
"RTN","PSOORNEW",28,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)           Drug: No Dispense Drug Selected"
"RTN","PSOORNEW",29,0)
PT D DOSE2^PSOORFI4
"RTN","PSOORNEW",30,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (4)   Pat Instruct:" D:$O(PSONEW("SIG",0)) INST^PSOORFI4
"RTN","PSOORNEW",31,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Provider Comments:" S TY=3 D INST^PSOORFI1
"RTN","PSOORNEW",32,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Instructions:" S TY=2 D INST^PSOORFI1
"RTN","PSOORNEW",33,0)
 K PSOELSE S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                SIG:"
"RTN","PSOORNEW",34,0)
 F I=0:0 S I=$O(SIG(I)) Q:'I  S SIG=SIG(I) D
"RTN","PSOORNEW",35,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNEW",36,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (5) Patient Status: "_$P($G(^PS(53,+PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORNEW",37,0)
 K PSOELSE I $G(PSONEW("ISSUE DATE"))']"" S PSOELSE=1 S IEN=IEN+1,(PSOID,Y)=$E($P(OR0,"^",6),1,7) X ^DD("DD") S PSONEW("ISSUE DATE")=Y,^TMP("PSOPO",$J,IEN,0)=" (4)     Issue Date: "_Y
"RTN","PSOORNEW",38,0)
 I '$G(PSOELSE) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (6)     Issue Date: "_PSONEW("ISSUE DATE")
"RTN","PSOORNEW",39,0)
 K PSOELSE I $G(PSORX("FILL DATE"))']"" S PSOELSE=1 D
"RTN","PSOORNEW",40,0)
 .S (Y,PSORX("FILL DATE"))=$S($E($P(OR0,"^",6),1,7)<DT:DT,1:$E($P(OR0,"^",6),1,7)) X ^DD("DD") S PSONEW("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                  (5) Fill Date: "_Y
"RTN","PSOORNEW",41,0)
 I '$G(PSOELSE) S Y=PSORX("FILL DATE") X ^DD("DD") S PSORX("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"       (7) Fill Date: "_PSORX("FILL DATE")
"RTN","PSOORNEW",42,0)
 I $P(OR0,"^",18) S IEN=IEN+1,Y=$P(OR0,"^",18) X ^DD("DD") S $P(^TMP("PSOPO",$J,IEN,0)," ",39)="Effective Date: "_Y
"RTN","PSOORNEW",43,0)
 I $D(CLOZPAT) D ELIG^PSOORFI2 S:'$D(PSONEW("QTY")) PSONEW("QTY")=0
"RTN","PSOORNEW",44,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (8)    Days Supply: "_PSONEW("DAYS SUPPLY")
"RTN","PSOORNEW",45,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"               (9)   QTY"_$S($P($G(^PSDRUG(+$G(PSODRUG("IEN")),660)),"^",8)]"":" ("_$P($G(^PSDRUG(+PSODRUG("IEN"),660)),"^",8)_")",1:" (  )")
"RTN","PSOORNEW",46,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_": "_$S($G(PSONEW("QTY"))]"":PSONEW("QTY"),1:$P(OR0,"^",10))
"RTN","PSOORNEW",47,0)
 I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),5)),"^")]"" D
"RTN","PSOORNEW",48,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNEW",49,0)
 .S ^TMP("PSOPO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^") K RN
"RTN","PSOORNEW",50,0)
 S IEN=IEN+1
"RTN","PSOORNEW",51,0)
 I $P(OR0,"^",24) S ^TMP("PSOPO",$J,IEN,0)="   Provider ordered: days supply "_+$P(OR0,"^",22)_", quantity "_+$P(OR0,"^",10)_" & refills "_+$P(OR0,"^",11)
"RTN","PSOORNEW",52,0)
 E  S ^TMP("PSOPO",$J,IEN,0)="       Provider ordered "_+$P(OR0,"^",11)_" refills"
"RTN","PSOORNEW",53,0)
 D:$D(CLOZPAT) PQTY^PSOORFI4
"RTN","PSOORNEW",54,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(10)   # of Refills: "_$S($G(PSONEW("# OF REFILLS"))]"":PSONEW("# OF REFILLS"),1:$P(OR0,"^",11))_"               (11)   Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORNEW",55,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(12)         Clinic: "_PSORX("CLINIC")
"RTN","PSOORNEW",56,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(13)       Provider: "_PSONEW("PROVIDER NAME")
"RTN","PSOORNEW",57,0)
 D:$P(OR0,"^",24)!((+$G(PSODRUG("DEA"))>1)&(+$G(PSODRUG("DEA"))<6)) PRV^PSOORFI5($G(PSONEW("PROVIDER")),$G(PSODRUG("IEN")),$P(OR0,"^"))
"RTN","PSOORNEW",58,0)
 I $P($G(^VA(200,$S($G(PSONEW("PROVIDER")):PSONEW("PROVIDER"),1:$P(OR0,"^",5)),"PS")),"^",7)&($P($G(^("PS")),"^",8)) D
"RTN","PSOORNEW",59,0)
 .S IEN=IEN+1,PSONEW("COSIGNING PROVIDER")=$S($G(PSONEW("COSIGNING PROVIDER")):PSONEW("COSIGNING PROVIDER"),1:$P(^("PS"),"^",8))
"RTN","PSOORNEW",60,0)
 .S ^TMP("PSOPO",$J,IEN,0)="       Cos-Provider: "_$P(^VA(200,PSONEW("COSIGNING PROVIDER"),0),"^")
"RTN","PSOORNEW",61,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(14)         Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1)
"RTN","PSOORNEW",62,0)
 S PSONEW("REMARKS")=$S($G(PSONEW("REMARKS"))]"":PSONEW("REMARKS"),$P(OR0,"^",17)="C":"Administered in Clinic.",1:"")
"RTN","PSOORNEW",63,0)
 K PSONEW("ADMINCLINIC") S:$P(OR0,"^",17)="C" PSONEW("ADMINCLINIC")=1
"RTN","PSOORNEW",64,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(15)        Remarks:"
"RTN","PSOORNEW",65,0)
 I $G(PSONEW("REMARKS"))]"" D
"RTN","PSOORNEW",66,0)
 .F SG=1:1:$L(PSONEW("REMARKS")) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("REMARKS")," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",67,0)
 ..S:$P(PSONEW("REMARKS")," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("REMARKS")," ",SG)
"RTN","PSOORNEW",68,0)
 I $G(PSOSIGFL)!(PSODRUG("OI")'=$P(OR0,"^",8)) S PSONEW("CLERK CODE")=DUZ,PSORX("CLERK CODE")=$P(^VA(200,DUZ,0),"^"),VALMSG="This change will create a new prescription!"
"RTN","PSOORNEW",69,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,PSONEW("CLERK CODE"),0),"^")_$E(RN,$L($P(^VA(200,PSONEW("CLERK CODE"),0),"^"))+1,35)
"RTN","PSOORNEW",70,0)
 S Y=$P(OR0,"^",12) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$E($P(OR0,"^",12),4,5)_"/"_$E($P(OR0,"^",12),6,7)_"/"_$E($P(OR0,"^",12),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORNEW",71,0)
 I PSOLMC<2 D ^PSOLMPO1 S VALMBCK="Q",PSOLMC=0
"RTN","PSOORNEW",72,0)
 S:PSOLMC>1 VALMBCK="R"
"RTN","PSOORNEW",73,0)
 Q
"RTN","PSOORNEW",74,0)
ORCHK D PROVCOM^PSOORFI4,ORCHK^PSOORFI4
"RTN","PSOORNEW",75,0)
 Q
"RTN","PSOORNEW",76,0)
EDT D KV S DIR("A",1)="* Indicates which fields will create an new Order",DIR("A")="Select Field to Edit by number",DIR(0)="LO^1:15" D ^DIR Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOORNEW",77,0)
EDTSEL N LST,FLD,OUT D KV S OUT=0
"RTN","PSOORNEW",78,0)
 I +Y S LST=Y D FULL^VALM1 N PSODOSE M PSODOSE=PSONEW D  G DSPL
"RTN","PSOORNEW",79,0)
 .F FLD=1:1:$L(LST,",") Q:$P(LST,",",FLD)']""!(OUT)  D @(+$P(LST,",",FLD)) D:$P(LST,",",FLD)=8 REF D KV
"RTN","PSOORNEW",80,0)
 E  S VALMBCK="" Q
"RTN","PSOORNEW",81,0)
 Q
"RTN","PSOORNEW",82,0)
ACP ;
"RTN","PSOORNEW",83,0)
 N PSOORNEW,DIR,Y S Y=0,PSOORNEW=1
"RTN","PSOORNEW",84,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 D  Q:$D(DIRUT)!'Y  D EN1^ORCFLAG(+$P($G(^PS(52.41,ORD,0)),"^")) H 1
"RTN","PSOORNEW",85,0)
 . D FULL^VALM1
"RTN","PSOORNEW",86,0)
 . I '$D(^XUSEC("PSORPH",DUZ)) D  S Y=0 Q
"RTN","PSOORNEW",87,0)
 . . S DIR("A",1)="Order must be unflagged by a pharmacist before it can be finished."
"RTN","PSOORNEW",88,0)
 . . S DIR("A",2)=""
"RTN","PSOORNEW",89,0)
 . . S DIR(0)="E",DIR("A")="Enter RETURN to continue" W !,$C(7) D ^DIR
"RTN","PSOORNEW",90,0)
 . . S VALMBCK="R"
"RTN","PSOORNEW",91,0)
 . D KV
"RTN","PSOORNEW",92,0)
 . S DIR("A",1)="This Order is flagged. In order to finish it"
"RTN","PSOORNEW",93,0)
 . S DIR("A",2)="you must unflag it first."
"RTN","PSOORNEW",94,0)
 . S DIR("A",3)=""
"RTN","PSOORNEW",95,0)
 . S DIR(0)="Y",DIR("A")="Unflag Order",DIR("B")="NO"
"RTN","PSOORNEW",96,0)
 . W ! D ^DIR I $D(DIRUT)!'Y S VALMBCK="Q"
"RTN","PSOORNEW",97,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 Q
"RTN","PSOORNEW",98,0)
 ;
"RTN","PSOORNEW",99,0)
 I $D(CLOZPAT),+$G(PSONEW("QTY"))=0 S VALMSG="Unable to calculate the quantity, enter a quantity" G DSPL
"RTN","PSOORNEW",100,0)
 S (PSODIR("DFLG"),PSORX("DFLG"),PSODIR("QFLD"))=0,ACP=1 D ORCHK
"RTN","PSOORNEW",101,0)
 G:$G(PSONEW("QFLG")) DSPL
"RTN","PSOORNEW",102,0)
 I $G(PSODIR("DFLG"))!$G(PSORX("DFLG")) Q
"RTN","PSOORNEW",103,0)
 I $G(PSONEW("FLD"))!($G(PSODRUG("NAME"))']"")!('$O(SIG(0))) G DSPL
"RTN","PSOORNEW",104,0)
 I $G(PSODRUG("NAME"))]"",'$G(ORCHK)!($G(ORDRG)'=PSODRUG("NAME")) D  I $G(PSORX("DFLG")) D CLEAN^PSOVER1 G DSPL
"RTN","PSOORNEW",105,0)
 . D POST^PSODRG S:'$G(PSORX("DFLG")) ORCHK=1,ORDRG=PSODRUG("NAME")
"RTN","PSOORNEW",106,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("N") I $G(PSORX("DFLG")) G DSPL
"RTN","PSOORNEW",107,0)
 I '$D(PSONEW("RX #")) S PSOFROM="NEW",RTN=$S($P($G(PSOPAR),"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN") D @RTN Q:PSONEW("QFLG")  I '$P($G(PSOPAR),"^",7) S PSOX=PSONEW("RX #") D CHECK^PSONRXN
"RTN","PSOORNEW",108,0)
 D RXNCHK^PSOORNE1 I $G(PSONEW("QFLG")) S PSONEW("DFLG")=1 Q
"RTN","PSOORNEW",109,0)
 I DT>$$FMADD^XLFDT($P(OR0,"^",6),365) D EXPR^PSONEW2 G DSPL
"RTN","PSOORNEW",110,0)
 D STOP^PSONEW2,DISPLAY^PSONEW2,^PSONEWF
"RTN","PSOORNEW",111,0)
 I $G(PSOCPZ("DFLG")) W !!,"No action taken!",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR,KV K PSOCPZ("DFLG"),DRET,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",112,0)
 ;
"RTN","PSOORNEW",113,0)
 K PSOCPZ("DFLG") D KV S DIR(0)="Y",DIR("A")="Are you sure you want to Accept this Order",DIR("B")="NO" D ^DIR I $D(DIRUT) D KV K DRET,PSOANSQ,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",114,0)
 D KV I 'Y K PSOANSQ G DSPL
"RTN","PSOORNEW",115,0)
 I $G(PSONEW("MAIL/WINDOW"))["W" D:$P($G(PSOPAR),"^",12)  S BINGCRT="Y",BINGRTE="W",PSORX("MAIL/WINDOW")="WINDOW" K RTN
"RTN","PSOORNEW",116,0)
 .W ! K DIR,DIRUT S DIR(0)="52,35O"
"RTN","PSOORNEW",117,0)
 .S:$G(PSORX("METHOD OF PICK-UP"))]"" DIR("B")=PSORX("METHOD OF PICK-UP") D ^DIR I $D(DIRUT) K DIR,DIRUT Q
"RTN","PSOORNEW",118,0)
 .S (PSONEW("METHOD OF PICK-UP"),PSORX("METHOD OF PICK-UP"))=Y K X,Y
"RTN","PSOORNEW",119,0)
 S PSONEW("POE")=1 D EN^PSON52(.PSONEW) G:$G(PSONEW("DFLG")) ABORT D DCORD^PSONEW2 D:$G(PKI)=89802020 ALERT^PSOPKIV1
"RTN","PSOORNEW",120,0)
 ; - Possible Titration Rx?
"RTN","PSOORNEW",121,0)
 I $G(PSONEW("IRXN")) D MARK^PSOOTMRX(PSONEW("IRXN"),0)
"RTN","PSOORNEW",122,0)
 ;saves drug allergy order chks pso*7*390
"RTN","PSOORNEW",123,0)
 I $D(^TMP("PSODAOC",$J)) D
"RTN","PSOORNEW",124,0)
 .I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSOORNEW",125,0)
 .S RXN=PSONEW("IRXN"),PSODAOC="Finished CPRS Rx "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"Order Acceptance_OP"
"RTN","PSOORNEW",126,0)
 .D DAOC^PSONEW
"RTN","PSOORNEW",127,0)
 D NPSOSD^PSOUTIL(.PSONEW),FULL^VALM1 K PSORX("MAIL/WINDOW")
"RTN","PSOORNEW",128,0)
 D EOJ^PSONEW
"RTN","PSOORNEW",129,0)
ABORT S VALMBCK="Q",DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR,CLEAN^PSOVER1,KV
"RTN","PSOORNEW",130,0)
 Q
"RTN","PSOORNEW",131,0)
KV K DIRUT,DUOUT,DTOUT,DIR,PSOEDDOS
"RTN","PSOORNEW",132,0)
 Q
"RTN","PSOORNEW",133,0)
REF ;
"RTN","PSOORNEW",134,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSOORNEW",135,0)
 N MAXRF S MAXRF=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),+$G(PSONEW("DAYS SUPPLY")),+$G(PSONEW("PATIENT STATUS")),.CLOZPAT)
"RTN","PSOORNEW",136,0)
 I ($G(PSONEW("# OF REFILLS"))'="")&($G(PSONEW("# OF REFILLS"))'>MAXRF) D
"RTN","PSOORNEW",137,0)
 . S PSONEW("N# REF")=PSONEW("# OF REFILLS")
"RTN","PSOORNEW",138,0)
 E  D
"RTN","PSOORNEW",139,0)
 . S (PSONEW("N# REF"),PSONEW("# OF REFILLS"))=MAXRF
"RTN","PSOORNEW",140,0)
 Q
"RTN","PSOORNEW",141,0)
1 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",142,0)
 . W !!,"Digitally Signed Order - Orderable Item cannot be changed",! D PZ
"RTN","PSOORNEW",143,0)
 N PSOBDR,PSOBDRG S PSOBDRG=1 D 1^PSOORNW2 Q  ;oi
"RTN","PSOORNEW",144,0)
 ;
"RTN","PSOORNEW",145,0)
4 D INS^PSOORNW2 Q
"RTN","PSOORNEW",146,0)
 ;
"RTN","PSOORNEW",147,0)
3 I $G(LST)["3,",$P(OR0,"^",24) D  Q 
"RTN","PSOORNEW",148,0)
 . W !!,"Digitally Signed Order - Dose cannot be changed",! D PZ
"RTN","PSOORNEW",149,0)
 N PSOEDDOS S PSOEDDOS=1 D DOSE^PSOORED4(.PSONEW) Q
"RTN","PSOORNEW",150,0)
 ;
"RTN","PSOORNEW",151,0)
6 D 4^PSOORNW2 Q  ;idt
"RTN","PSOORNEW",152,0)
 ;
"RTN","PSOORNEW",153,0)
7 D 5^PSOORNW2 Q  ;fdt
"RTN","PSOORNEW",154,0)
 ;
"RTN","PSOORNEW",155,0)
5 D 3^PSOORNW2 Q  ;pstat
"RTN","PSOORNEW",156,0)
 ;
"RTN","PSOORNEW",157,0)
13 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",158,0)
 . W !!,"Digitally Signed Order - Provider cannot be changed",! D PZ
"RTN","PSOORNEW",159,0)
 D 12^PSOORNW2 Q  ;doc
"RTN","PSOORNEW",160,0)
 ;
"RTN","PSOORNEW",161,0)
12 D 11^PSOORNW2 Q  ;cli
"RTN","PSOORNEW",162,0)
 ;
"RTN","PSOORNEW",163,0)
2 N PSOCSIG I '$G(PSOBDRG) N PSOBDR,PSOBDRG S PSOBDRG=1,PSOQFLG=0
"RTN","PSOORNEW",164,0)
 N CPRN S CPRN=+$P($G(OR0),"^",24) D 2^PSOORNW1 Q:$G(PSOQFLG)  D EN^PSODIAG  ;drg/ICD
"RTN","PSOORNEW",165,0)
 I $G(PSOCSIG) K PSOCSIG G 3
"RTN","PSOORNEW",166,0)
 Q
"RTN","PSOORNEW",167,0)
 ;
"RTN","PSOORNEW",168,0)
9 D 8^PSOORNW2 Q  ;qty
"RTN","PSOORNEW",169,0)
 ;
"RTN","PSOORNEW",170,0)
8 N CPRN S CPRN=+$P($G(OR0),"^",24) D 7^PSOORNW2 Q  ;ds
"RTN","PSOORNEW",171,0)
 ;
"RTN","PSOORNEW",172,0)
10 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",173,0)
 . W !!,"Digitally Signed Order - Refills cannot be changed",! D PZ
"RTN","PSOORNEW",174,0)
 D 9^PSOORNW2 Q  ;#rfs
"RTN","PSOORNEW",175,0)
 ;
"RTN","PSOORNEW",176,0)
14 D 13^PSOORNW2 Q  ;cop
"RTN","PSOORNEW",177,0)
 ;
"RTN","PSOORNEW",178,0)
11 D 10^PSOORNW2 Q  ;m/w
"RTN","PSOORNEW",179,0)
 ;
"RTN","PSOORNEW",180,0)
15 D 14^PSOORNW2 Q  ;rem
"RTN","PSOORNEW",181,0)
 ;
"RTN","PSOORNEW",182,0)
DRGMSG ;
"RTN","PSOORNEW",183,0)
 F SG=1:1:$L($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",184,0)
 .S:$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)
"RTN","PSOORNEW",185,0)
 K SG
"RTN","PSOORNEW",186,0)
 Q
"RTN","PSOORNEW",187,0)
 ;
"RTN","PSOORNEW",188,0)
PZ ;
"RTN","PSOORNEW",189,0)
 N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOORNEW",190,0)
 Q
"RTN","PSOORNW1")
0^10^B34218715^B45684581
"RTN","PSOORNW1",1,0)
PSOORNW1 ;ISC BHAM/SAB - continuation of finish of new order ;5/10/07 8:30am
"RTN","PSOORNW1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**23,46,78,117,131,133,172,148,222,268,206,251,379,391,313,444**;DEC 1997;Build 34
"RTN","PSOORNW1",3,0)
 ;Reference ^YSCL(603.01 supported by DBIA 2697
"RTN","PSOORNW1",4,0)
 ;Reference ^PS(55 supported by DBIA 2228
"RTN","PSOORNW1",5,0)
 ;Reference ^PSDRUG( supported by DBIA 221
"RTN","PSOORNW1",6,0)
 ;Reference to $$GETNDC^PSSNDCUT supported by IA 4707
"RTN","PSOORNW1",7,0)
 ;
"RTN","PSOORNW1",8,0)
2 I $G(ORD),$G(ORSV) W !!,"Instructions: " D
"RTN","PSOORNW1",9,0)
 .S INST=0 F  S INST=$O(^PS(52.41,ORD,2,INST)) Q:'INST  S (MIG,INST(INST))=^PS(52.41,ORD,2,INST,0) D
"RTN","PSOORNW1",10,0)
 ..F SG=1:1:$L(MIG," ") W:$X+$L($P(MIG," ",SG)_" ")>IOM !?14 W $P(MIG," ",SG)_" "
"RTN","PSOORNW1",11,0)
 .S:'$D(PSODRUG("OI")) PSODRUG("OI")=$P(OR0,"^",8)
"RTN","PSOORNW1",12,0)
 .K INST,TY,MIG,SG
"RTN","PSOORNW1",13,0)
 N DEFAULT
"RTN","PSOORNW1",14,0)
 S (PSDC,PSI,DEFAULT)=0 W !!,"The following Drug(s) are available for selection:"
"RTN","PSOORNW1",15,0)
 F PSI=0:0 S PSI=$O(^PSDRUG("ASP",PSODRUG("OI"),PSI)) Q:'PSI  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["O":0,1:1) D
"RTN","PSOORNW1",16,0)
 .S PSDC=PSDC+1 W !,PSDC_". "_$P(^PSDRUG(PSI,0),"^")_$S($P(^(0),"^",9):"     (N/F)",1:"")
"RTN","PSOORNW1",17,0)
 .S PSDC(PSDC)=PSI I $G(PSORXED("DRUG IEN")),PSI=$G(PSORXED("DRUG IEN")) S DEFAULT=PSDC
"RTN","PSOORNW1",18,0)
 I PSDC=0 D
"RTN","PSOORNW1",19,0)
 . N X,DRG
"RTN","PSOORNW1",20,0)
 . S DRG=+$P($G(^PS(52.41,+$G(ORD),0)),"^",9)
"RTN","PSOORNW1",21,0)
 . S X=$$GET1^DIQ(50,DRG,100)
"RTN","PSOORNW1",22,0)
 . I X'="",(DT>X) D
"RTN","PSOORNW1",23,0)
 . . W !!,"   This Dispense Drug is now Inactive. You may select a"
"RTN","PSOORNW1",24,0)
 . . W !,"    new Orderable Item, or you can enter a new Order with"
"RTN","PSOORNW1",25,0)
 . . W !,"    an Active Drug.",!
"RTN","PSOORNW1",26,0)
 . E  W !!,"No drugs available!",!
"RTN","PSOORNW1",27,0)
 . K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press return to continue"
"RTN","PSOORNW1",28,0)
 . D ^DIR K DIR
"RTN","PSOORNW1",29,0)
 G:'PSDC ETX I $G(PSOBDRG),'$D(PSOBDR) M PSOBDR=PSODRUG
"RTN","PSOORNW1",30,0)
 I PSDC'=1 D
"RTN","PSOORNW1",31,0)
 .I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),2)),"^")=$G(PSODRUG("OI")) Q
"RTN","PSOORNW1",32,0)
 .K PSODRUG("NAME"),PSODRUG("IEN")
"RTN","PSOORNW1",33,0)
 W ! D KV
"RTN","PSOORNW1",34,0)
 S DIR(0)="N^1:"_PSDC S:$G(DEFAULT) DIR("B")=DEFAULT
"RTN","PSOORNW1",35,0)
 S DIR("A")="Select Drug by number" D ^DIR
"RTN","PSOORNW1",36,0)
 I $D(DIRUT) S OUT=1 G EX
"RTN","PSOORNW1",37,0)
 D KV K PSOY S PSOY=PSDC(Y),PSOY(0)=^PSDRUG(PSOY,0),PSOCSIG=0
"RTN","PSOORNW1",38,0)
 I $G(PSOBDR("IEN")),PSOBDR("IEN")'=+PSOY D:$G(ORD)  G:$D(DIRUT) EX
"RTN","PSOORNW1",39,0)
 .D KV S DIR(0)="Y",DIR("B")="YES",DIR("A",1)="You have changed the dispense drug from",DIR("A",2)=PSOBDR("NAME")_" to "_$P(^PSDRUG(+PSOY,0),"^")_".",DIR("A")="Do You want to Edit the SIG"
"RTN","PSOORNW1",40,0)
 .D ^DIR I $D(DIRUT) S OUT=1 Q
"RTN","PSOORNW1",41,0)
 .S:Y PSOCSIG=1
"RTN","PSOORNW1",42,0)
 .I 'Y D  Q:$D(DIRUT)
"RTN","PSOORNW1",43,0)
 ..I $P($G(OR0),"^",24) S (OUT,DIRUT)=1 Q
"RTN","PSOORNW1",44,0)
 ..D URX I $D(DIRUT) S OUT=1
"RTN","PSOORNW1",45,0)
 D KV
"RTN","PSOORNW1",46,0)
CT1 I $P($G(^PSDRUG(PSOY,"CLOZ1")),"^")="PSOCLO1",'$O(^YSCL(603.01,"C",PSODFN,0)) D  Q
"RTN","PSOORNW1",47,0)
 .S VALMSG="Patient Not Registered in Clozapine Program",VALMBCK="Q" K PSOY,PSDC
"RTN","PSOORNW1",48,0)
 I $G(ORD) S ^TMP("PSORXPO",$J,ORD,0)=1
"RTN","PSOORNW1",49,0)
 S PSODRUG("IEN")=+PSOY,PSODRUG("VA CLASS")=$P(PSOY(0),"^",2),PSODRUG("NAME")=$P(PSOY(0),"^")
"RTN","PSOORNW1",50,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(+PSOY,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOORNW1",51,0)
 S PSODRUG("MAXDOSE")=$P(PSOY(0),"^",4),PSODRUG("DEA")=$P(PSOY(0),"^",3),PSODRUG("CLN")=$S($D(^PSDRUG(+PSOY,"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSOORNW1",52,0)
 S PSODRUG("SIG")=$P(PSOY(0),"^",5),PSODRUG("NDC")=$$GETNDC^PSSNDCUT(+PSOY,$G(PSOSITE)),PSODRUG("STKLVL")=$G(^PSDRUG(+PSOY,660.1))
"RTN","PSOORNW1",53,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,+PSOY,81)
"RTN","PSOORNW1",54,0)
 S PSOX1=$G(^PSDRUG(+PSOY,660)),PSODRUG("COST")=$P($G(PSOX1),"^",6),PSODRUG("UNIT")=$P($G(PSOX1),"^",8),PSODRUG("EXPIRATION DATE")=$P($G(PSOX1),"^",9)
"RTN","PSOORNW1",55,0)
 I $G(PSORX("DFLG")) K PSODRUG N LST Q:$G(PSOAC)!($G(NEWEDT))  D DSPL^PSOORFI1 S VALMBCK="Q" Q
"RTN","PSOORNW1",56,0)
ETX D REF S VALMBCK="R" I 'PSDC S VALMSG="NO dispense drugs tied to this orderable item!" S PSOQFLG=1
"RTN","PSOORNW1",57,0)
TX D KV K PSDC,PSI,X,Y,PSOX1,PSOY
"RTN","PSOORNW1",58,0)
 Q
"RTN","PSOORNW1",59,0)
EX M PSODRUG=PSOBDR K PSOBDR,PSOBDRG S PSOQFLG=1,VALMBCK="R" D MP1^PSOOREDX
"RTN","PSOORNW1",60,0)
 D TX Q
"RTN","PSOORNW1",61,0)
URX D KV S DIR(0)="Y",DIR("A")="Are You Sure You Want to Update Rx",DIR("B")="Yes"
"RTN","PSOORNW1",62,0)
 D ^DIR S:$D(DIRUT)!('Y) DIRUT=1
"RTN","PSOORNW1",63,0)
 I Y S ^TMP("PSORXPO",$J,ORD,0)=1 ;screens 4 order checks
"RTN","PSOORNW1",64,0)
 Q
"RTN","PSOORNW1",65,0)
REF ;
"RTN","PSOORNW1",66,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSOORNW1",67,0)
 N MAXRF S MAXRF=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),+$G(PSONEW("DAYS SUPPLY")),+$G(PSONEW("PATIENT STATUS")),.CLOZPAT)
"RTN","PSOORNW1",68,0)
 I ($G(PSONEW("# OF REFILLS"))'="")&($G(PSONEW("# OF REFILLS"))'>MAXRF) D
"RTN","PSOORNW1",69,0)
 . S PSONEW("N# REF")=PSONEW("# OF REFILLS")
"RTN","PSOORNW1",70,0)
 E  D
"RTN","PSOORNW1",71,0)
 . S (PSONEW("N# REF"),PSONEW("# OF REFILLS"))=MAXRF
"RTN","PSOORNW1",72,0)
 Q
"RTN","PSOORNW1",73,0)
 ;
"RTN","PSOORNW1",74,0)
EDNEW ;
"RTN","PSOORNW1",75,0)
 N MAXRF S MAXRF=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),+$G(PSONEW("DAYS SUPPLY")),+$G(PSONEW("PATIENT STATUS")),.CLOZPAT)
"RTN","PSOORNW1",76,0)
 I PSRF>MAXRF D
"RTN","PSOORNW1",77,0)
 .W $C(7),!!,PSRF_" refills are not correct for a "_PSDAYS_" day supply.",!,"Please enter correct # of refills for a "_PSDAYS_" day supply. Max refills allowed is "_MAX_".",!
"RTN","PSOORNW1",78,0)
 .S (PSMAX("MAX"),PSFMAX("MAX"))=MAXRF,(PSMAX("RF"),PSFMAX("RF"))=PSRF,(PSMAX("DAYS"),PSFMAX("DAYS"))=PSDAYS,(PSMAX,PSFMAX)=1
"RTN","PSOORNW1",79,0)
 K PSTMAX D EDSTAT
"RTN","PSOORNW1",80,0)
 Q
"RTN","PSOORNW1",81,0)
STATDAY K PSMAX,PSRMAX,PSFMAX,PSTMAX S PSDAYS=$P(^PSRX(DA,0),"^",8),PSRF=$P(^PSRX(DA,0),"^",9),PTST=$P(^PS(53,X,0),"^"),PTDY=$P(^(0),"^",3),PTRF=$P(^(0),"^",4)
"RTN","PSOORNW1",82,0)
EDSTAT I PSRF>PTRF W !,$C(7),PSRF_" refills are greater than "_PTRF_" allowed for "_$P(PTST,"^")_" Rx Patient Status.",! S PSTMAX=1,PSTMAX("PTRF")=PTRF,PSTMAX("PSRF")=PSRF,PSTMAX("PT")=$P(PTST,"^")
"RTN","PSOORNW1",83,0)
 Q
"RTN","PSOORNW1",84,0)
OERF S DIR(0)="N^0:"_PSOX,DIR("A")="# OF REFILLS"
"RTN","PSOORNW1",85,0)
 S DIR("B")=$S($G(POERR):PSONEW("# OF REFILLS"),$G(PSONEW("N# REF"))]"":PSONEW("N# REF"),$G(PSONEW("# OF REFILLS"))]"":PSONEW("# OF REFILLS"),$G(PSOX1)]""&(PSOX>PSOX1):PSOX1,1:PSOX)
"RTN","PSOORNW1",86,0)
 S DIR("?")="Enter a whole number.  The maximum is set by the Rx Patient Status because there is no Dispense Drug."
"RTN","PSOORNW1",87,0)
 D ^DIR G:$D(DIRUT) REFX
"RTN","PSOORNW1",88,0)
 S (PSONEW("N# REF"),PSONEW("# OF REFILLS"))=Y
"RTN","PSOORNW1",89,0)
REFX S:'$D(PSONEW("# OF REFILLS")) PSONEW("# OF REFILLS")=$S($G(PSONEW("N# REF"))]"":PSONEW("N# REF"),$G(PSOX1)]""&($G(PSOX)>PSOX1):PSOX1,1:PSOX)
"RTN","PSOORNW1",90,0)
 K X,Y,PSOX,PSOX1,PSDY,PSDY1,DEA
"RTN","PSOORNW1",91,0)
KV K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOORNW1",92,0)
 Q
"RTN","PSOORUT1")
0^15^B83321658^B83981960
"RTN","PSOORUT1",1,0)
PSOORUT1 ;BIR/SAB - Utility routine for oerr interface ;1/20/16 3:48pm
"RTN","PSOORUT1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,14,30,46,132,148,233,274,225,305,289,251,387,385,313,427,444**;DEC 1997;Build 34
"RTN","PSOORUT1",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORUT1",4,0)
 ;External reference to ^PSXOPUTL supported by DBIA 2203
"RTN","PSOORUT1",5,0)
 ;called from HD^PSOORUTL
"RTN","PSOORUT1",6,0)
REL ;removed order from hold
"RTN","PSOORUT1",7,0)
 S ACT=1,ORS=0
"RTN","PSOORUT1",8,0)
 I POERR("PSOFILNM")["S" S DA=+POERR("PSOFILNM") D  G EXIT^PSOORUTL
"RTN","PSOORUT1",9,0)
 .Q:'$D(^PS(52.41,DA,0))  Q:$P(^PS(52.41,DA,0),"^",3)="RF"
"RTN","PSOORUT1",10,0)
 .S $P(^PS(52.41,DA,0),"^",3)="NW",POERR("STAT")="OR",POERR("FILLER")=DA_"^P"
"RTN","PSOORUT1",11,0)
 .S:$G(POERR("COMM"))']"" POERR("COMM")="Order RELEASED from HOLD by OE/RR before finished." S $P(^PS(52.41,DA,4),"^")=POERR("COMM"),ORS=1
"RTN","PSOORUT1",12,0)
 S DA=POERR("PSOFILNM") I $D(^PSRX(DA,0)) S ORS=1,PSDA=DA D  G EXIT^PSOORUTL
"RTN","PSOORUT1",13,0)
 .S POERR("FILLER")=DA_"^R",POERR("STAT")="OR"
"RTN","PSOORUT1",14,0)
 .S:'$D(POERR("COMM")) POERR("COMM")="Prescription Released from HOLD by OE/RR"
"RTN","PSOORUT1",15,0)
 .I DT>$P(^PSRX(DA,2),"^",6) D
"RTN","PSOORUT1",16,0)
 ..S EXP=$P(^PSRX(DA,2),"^",6) S:$P(^PSRX(DA,"STA"),"^")<12 $P(^PSRX(DA,"STA"),"^")=11,PSOEXFLG=1 S POERR("STAT")="UR",POERR("COMM")="Medication Expired on "_$E(EXP,4,5)_"/"_$E(EXP,6,7)_"/"_$E(EXP,2,3)_".",POERR("PHARMST")="" D ECAN^PSOUTL(DA) Q
"RTN","PSOORUT1",17,0)
 .I $P(^PSRX(DA,"STA"),"^")'=16 S POERR("STAT")="UR",POERR("COMM")="Unable to Release from Hold" Q
"RTN","PSOORUT1",18,0)
 .S RXFL(DA)=0,FDT=$P(^PSRX(DA,2),"^",2)
"RTN","PSOORUT1",19,0)
 .I $O(^PSRX(DA,1,0)) F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S FDT=$P(^PSRX(DA,1,I,0),"^"),RXFL(DA)=I
"RTN","PSOORUT1",20,0)
 .I FDT>DT N PSOSITEZ,ZPSOPAR6 S PSOSITEZ=$S($P($G(^PSRX(DA,2)),"^",9):$P(^(2),"^",9),1:$O(^PS(59,0))),ZPSOPAR6=$P($G(^PS(59,PSOSITEZ,1)),"^",6) I ZPSOPAR6 D  Q
"RTN","PSOORUT1",21,0)
 ..S RXXDA=DA,DA=$O(^PS(52.5,"B",RXXDA,0)) I DA S DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOORUT1",22,0)
 ..S DA=RXXDA
"RTN","PSOORUT1",23,0)
 ..S DIC="^PS(52.5,",DIC(0)="L",DLAYGO=52.5,X=RXXDA,DIC("DR")=".02///"_FDT_";.03////"_$P(^PSRX(DA,0),"^",2)_";.04///M;.05///0;.06////"_PSOSITEZ_";2///0;9///"_RXFL(DA) K DD,DO D FILE^DICN K RXFL,DD,DO
"RTN","PSOORUT1",24,0)
 ..S DA=RXXDA K RXXDA S $P(^PSRX(DA,"STA"),"^")=5,LFD=$E(FDT,4,5)_"-"_$E(FDT,6,7)_"-"_$E(FDT,2,3) D ACT1
"RTN","PSOORUT1",25,0)
 ..S PSOSUSZ=1
"RTN","PSOORUT1",26,0)
 .E  S $P(^PSRX(DA,"STA"),"^")=0
"RTN","PSOORUT1",27,0)
 .S RXF=0 F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S RXF=I S:I>5 RXF=I+1
"RTN","PSOORUT1",28,0)
 .D ACT^PSOORUTL
"RTN","PSOORUT1",29,0)
 .I $$SUBMIT^PSOBPSUT(DA) D ECMESND^PSOBPSU1(DA,"","",$S('$O(^PSRX(DA,1,0)):"OF",1:"RF"))
"RTN","PSOORUT1",30,0)
 G EXIT^PSOORUTL
"RTN","PSOORUT1",31,0)
ACT1 I '$D(RXF) S RXF=0 F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S RXF=I S:I>5 RXF=I+1
"RTN","PSOORUT1",32,0)
 S IR=0 F FDA=0:0 S FDA=$O(^PSRX(DA,"A",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOORUT1",33,0)
 S IR=IR+1,^PSRX(DA,"A",0)="^52.3DA^"_IR_"^"_IR
"RTN","PSOORUT1",34,0)
 D NOW^%DTC S ^PSRX(DA,"A",IR,0)=%_"^S^"_POERR("USER")_"^"_RXF_"^"_"RX Placed on Suspense until "_LFD
"RTN","PSOORUT1",35,0)
 Q
"RTN","PSOORUT1",36,0)
SUS ;
"RTN","PSOORUT1",37,0)
 I $P($G(^PSRX(+$G(FILLER),"STA")),"^")=5 N PSOMSORR,PLACERXX D EN^PSOHLSN1(+$G(FILLER),"SC","ZS","")
"RTN","PSOORUT1",38,0)
 Q
"RTN","PSOORUT1",39,0)
BLD ;builds med profile for Listman
"RTN","PSOORUT1",40,0)
 K PSODCREV,^TMP("PSOPF",$J),PSOLST S:$G(PSOOPT)'=3 PSOOPT=0 I '$G(PSOSD) S ^TMP("PSOPF",$J,1,0)="This patient has no prescriptions" S PSOCNT=0,PSOPF=1 Q
"RTN","PSOORUT1",41,0)
 D EOJ,SHOW
"RTN","PSOORUT1",42,0)
EOJ ;
"RTN","PSOORUT1",43,0)
 K PSOQFLG,PSODRG,PSODATA,PSOLF
"RTN","PSOORUT1",44,0)
 Q
"RTN","PSOORUT1",45,0)
 ;-----------------------------------------------------------------
"RTN","PSOORUT1",46,0)
SHOW ;
"RTN","PSOORUT1",47,0)
 ; - ePharmacy modification to create a section for Rx with REJECTs
"RTN","PSOORUT1",48,0)
 N PSOTMP,PSOSTS,PSODRNM,I,PSORX
"RTN","PSOORUT1",49,0)
 S (PSOSTS,PSODRNM)=""
"RTN","PSOORUT1",50,0)
 F  S PSOSTS=$O(PSOSD(PSOSTS)) Q:PSOSTS=""  D
"RTN","PSOORUT1",51,0)
 . F  S PSODRNM=$O(PSOSD(PSOSTS,PSODRNM)) Q:PSODRNM=""  D
"RTN","PSOORUT1",52,0)
 . . S PSORX=+$G(PSOSD(PSOSTS,PSODRNM))
"RTN","PSOORUT1",53,0)
  . . ; PSO*7*427 - add a new section for open TRICARE/CHAMPVA/RRR rejects after the 79/88 open rejects
"RTN","PSOORUT1",54,0)
 . . I PSOSTS="ACTIVE",$$FIND^PSOREJUT(PSORX,,,"79,88") S PSOTMP(" REJECT",PSODRNM)=PSOSTS Q   ; DUR/RTS
"RTN","PSOORUT1",55,0)
 . . I PSOSTS="ACTIVE",$$TRIC^PSOREJP1(PSORX),$$FIND^PSOREJUT(PSORX,,,,1) S PSOTMP(" REJECT2",PSODRNM)=PSOSTS Q  ; TRI/CVA
"RTN","PSOORUT1",56,0)
 . . I PSOSTS="ACTIVE",'$$TRIC^PSOREJP1(PSORX),$$FIND^PSOREJUT(PSORX,,,,,1) S PSOTMP(" REJECT2",PSODRNM)=PSOSTS Q  ; RRR
"RTN","PSOORUT1",57,0)
 . . S PSOTMP(PSOSTS,PSODRNM)=PSOSTS
"RTN","PSOORUT1",58,0)
 ;
"RTN","PSOORUT1",59,0)
 S (PSOSTS,PSODRG)="",(PSOCNT,PSOQFLG,IEN)=0
"RTN","PSOORUT1",60,0)
 K RN,DL S $P(RN," ",12)=" ",$P(DL," ",40)=" "
"RTN","PSOORUT1",61,0)
 F PSCNT=0:0 S PSOSTS=$O(PSOTMP(PSOSTS)) Q:PSOSTS=""  D
"RTN","PSOORUT1",62,0)
 . D STA
"RTN","PSOORUT1",63,0)
 . F PSOCT=0:0 S PSODRG=$O(PSOTMP(PSOSTS,PSODRG)) Q:PSODRG=""  Q:PSOCNT>1000!PSOQFLG  D
"RTN","PSOORUT1",64,0)
 . . S PSOSTA=PSOTMP(PSOSTS,PSODRG)
"RTN","PSOORUT1",65,0)
 . . S PSODATA=PSOSD(PSOSTA,PSODRG) I PSOSTA="ZNONVA" D NVA Q
"RTN","PSOORUT1",66,0)
 . . S PSOCNT=PSOCNT+1 I PSOSTA="PENDING" D PEN Q
"RTN","PSOORUT1",67,0)
 . . S:'$D(^PSRX(+PSODATA,0)) PSOCNT=PSOCNT-1 D:$D(^(0)) DISPL
"RTN","PSOORUT1",68,0)
 S (VALMCNT,PSOPF)=IEN
"RTN","PSOORUT1",69,0)
SHOWX K DIRUT,DTOUT,DUOUT,DIROUT,PSODRG
"RTN","PSOORUT1",70,0)
 Q
"RTN","PSOORUT1",71,0)
 ;
"RTN","PSOORUT1",72,0)
DISPL S IEN=IEN+1 N PSOID,PSOCMOP,STATLTH,ECME,TITRX
"RTN","PSOORUT1",73,0)
 K PSOLNT,PSOQTL,PSOLSP S PSOLRX=$S($G(^PSRX(+PSODATA,"IB")):13,1:14)-$L($P(^PSRX(+PSODATA,0),"^")),$P(PSOLNT," ",PSOLRX)=" ",PSODQL=$L($P(PSODRG,"^"))+$L($P(^PSRX(+PSODATA,0),"^",7))
"RTN","PSOORUT1",74,0)
 I PSODQL<39 S $P(PSOQTL," ",(40-PSODQL))=" "
"RTN","PSOORUT1",75,0)
 E  S $P(PSOQTL," ",(52-$L($P(^PSRX(+PSODATA,0),"^",7))))=" ",$P(PSOLSP," ",(41-$L($P(PSODRG,"^"))))=" "
"RTN","PSOORUT1",76,0)
 S ECME=$$ECME^PSOBPSUT(+PSODATA) I ECME'="" S PSOLNT=$E(PSOLNT,1,$L(PSOLNT)-1)
"RTN","PSOORUT1",77,0)
 S TITRX=$$TITRX^PSOUTL(+PSODATA) I TITRX'="" S PSOLNT=$E(PSOLNT,1,$L(PSOLNT)-1)
"RTN","PSOORUT1",78,0)
 S ^TMP("PSOPF",$J,IEN,0)=$J(PSOCNT,2)_$S($L(PSOCNT)<3:" ",1:"")_$P(^PSRX(+PSODATA,0),"^")_$S($G(^PSRX(+PSODATA,"IB")):"$",1:"")_ECME_TITRX_PSOLNT_$P(PSODRG,"^")_$S(PSODQL<39:PSOQTL_$P(^PSRX(+PSODATA,0),"^",7)_" ",1:$G(PSOLSP))
"RTN","PSOORUT1",79,0)
 S STA="A^N^R^H^N^S^^^^^^E^DC^^DP^DE^HP^P^"
"RTN","PSOORUT1",80,0)
 S PSOCMOP=""
"RTN","PSOORUT1",81,0)
 I $D(^PSDRUG("AQ",$P(^PSRX(+PSODATA,0),"^",6))) S PSOCMOP=">"
"RTN","PSOORUT1",82,0)
 N X S X="PSXOPUTL" X ^%ZOSF("TEST") K X I $T D
"RTN","PSOORUT1",83,0)
 .N DA S DA=+PSODATA D ^PSXOPUTL K DA
"RTN","PSOORUT1",84,0)
 .I $G(PSXZ(PSXZ("L")))=0!($G(PSXZ(PSXZ("L")))=2) S PSOCMOP="T"
"RTN","PSOORUT1",85,0)
 .K PSXZ
"RTN","PSOORUT1",86,0)
 S (STA,STATLTH)=$P(STA,"^",$P(PSODATA,"^",2)+1) D
"RTN","PSOORUT1",87,0)
 .I $G(^PSRX(+PSODATA,"DDSTA"))]"" S (STATLTH,STA)="DD" Q
"RTN","PSOORUT1",88,0)
 .S (STATLTH,STA)=$S($P($G(^PSRX(+PSODATA,7)),"^")=1:"DA",$P($G(^PSRX(+PSODATA,7)),"^")=2:"DF",1:STA)
"RTN","PSOORUT1",89,0)
 S STAPRT=STA_PSOCMOP,STATLTH=$L(STAPRT)
"RTN","PSOORUT1",90,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_STAPRT_$S(STATLTH=0:"   ",STATLTH=1:"  ",STATLTH=2:" ",1:"")
"RTN","PSOORUT1",91,0)
 S PSOID=$P(^PSRX(+PSODATA,0),"^",13),PSOLF=+$G(^(3)),^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$E(PSOID,4,5)_"-"_$E(PSOID,6,7)_" "
"RTN","PSOORUT1",92,0)
 N RFLZRO,PSOLRD S PSOLRD=$P($G(^PSRX(+PSODATA,2)),"^",13)
"RTN","PSOORUT1",93,0)
 F PSOX=0:0 S PSOX=$O(^PSRX(+PSODATA,1,PSOX)) Q:'PSOX  D
"RTN","PSOORUT1",94,0)
 . S RFLZRO=$G(^PSRX(+PSODATA,1,PSOX,0))
"RTN","PSOORUT1",95,0)
 . I +RFLZRO=PSOLF,$P(RFLZRO,"^",16) S PSOLF=PSOLF_"^R"
"RTN","PSOORUT1",96,0)
 . S:$P(RFLZRO,"^",18)'="" PSOLRD=$P(RFLZRO,"^",18) I $P(RFLZRO,"^",16) S PSOLRD=PSOLRD_"^R"
"RTN","PSOORUT1",97,0)
 K PSOX
"RTN","PSOORUT1",98,0)
 I '$O(^PSRX(+PSODATA,1,0)),$P(^PSRX(+PSODATA,2),"^",15) S PSOLF=PSOLF_"^R",PSOLRD=PSOLRD_"^R"
"RTN","PSOORUT1",99,0)
 S PSOLF=$S($G(PSOLF):$E(PSOLF,4,5),1:"  ")_"-"_$S($G(PSOLF):$E(PSOLF,6,7),1:"  ")_$S($P(PSOLF,"^",2)="R":"R ",1:"  ")
"RTN","PSOORUT1",100,0)
 S PSOLRD=$S($G(PSOLRD):$E(PSOLRD,4,5),1:"  ")_"-"_$S($G(PSOLRD):$E(PSOLRD,6,7),1:"  ")_$S($P(PSOLRD,"^",2)="R":"R ",1:"  ")
"RTN","PSOORUT1",101,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$S($G(PSORFG):PSOLRD,1:PSOLF)
"RTN","PSOORUT1",102,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$J($P(PSODATA,"^",6),2)_" "_$J($P(PSODATA,"^",8),3)
"RTN","PSOORUT1",103,0)
 ;recently dc'd rxs
"RTN","PSOORUT1",104,0)
 I $P($G(^PSRX(+PSODATA,3)),"^",5) D  K X
"RTN","PSOORUT1",105,0)
 .S X2=$S($P(PSOPAR,"^",33):$P(PSOPAR,"^",33),1:7),X1=$P(^PSRX(+PSODATA,3),"^",5) D C^%DTC
"RTN","PSOORUT1",106,0)
 .I DT<X S PSODCREV(IEN)=IEN
"RTN","PSOORUT1",107,0)
 ;recently expired rxs
"RTN","PSOORUT1",108,0)
 I $P($G(^PSRX(+PSODATA,2)),"^",6)<DT,'$P($G(^PSRX(+PSODATA,3)),"^",5) D  K X
"RTN","PSOORUT1",109,0)
 .S X2=$S($P(PSOPAR,"^",33):$P(PSOPAR,"^",33),1:7),X1=$P(^PSRX(+PSODATA,2),"^",6) D C^%DTC
"RTN","PSOORUT1",110,0)
 .I DT<X S PSODCREV(IEN)=IEN
"RTN","PSOORUT1",111,0)
 ;
"RTN","PSOORUT1",112,0)
 I (PSODQL>38)!$$BADADDFL^PSOUTIL(+PSODATA) D
"RTN","PSOORUT1",113,0)
 .S IEN=IEN+1
"RTN","PSOORUT1",114,0)
 .I PSODQL>38 S ^TMP("PSOPF",$J,IEN,0)=PSOQTL_"Qty: "_$P(^PSRX(+PSODATA,0),"^",7)
"RTN","PSOORUT1",115,0)
 .I $$BADADDFL^PSOUTIL(+PSODATA) S $E(^TMP("PSOPF",$J,IEN,0),61)="*** Bad Address ***"
"RTN","PSOORUT1",116,0)
 ;
"RTN","PSOORUT1",117,0)
 K PSOLNT,PSOQTL,PSOLSP,PSOLRX,PSODQL
"RTN","PSOORUT1",118,0)
 S PSOLST(PSOCNT)="52^"_+PSODATA_"^"_PSOSTA
"RTN","PSOORUT1",119,0)
 K PSODATA,PSOLF S PSOPF=IEN
"RTN","PSOORUT1",120,0)
 Q
"RTN","PSOORUT1",121,0)
 ;
"RTN","PSOORUT1",122,0)
STA N LABEL,LINE,POS
"RTN","PSOORUT1",123,0)
 S LABEL=PSOSTS,IEN=IEN+1
"RTN","PSOORUT1",124,0)
 I PSOSTS="ZNONVA" S LABEL="Non-VA MEDS (Not dispensed by VA)"
"RTN","PSOORUT1",125,0)
 I PSOSTS=" REJECT" S LABEL="REFILL TOO SOON/DUR REJECTS (Third Party)"
"RTN","PSOORUT1",126,0)
 I PSOSTS=" REJECT2" S LABEL="OTHER REJECTS PENDING RESOLUTION"  ;PSO*7*427 added new section
"RTN","PSOORUT1",127,0)
 S POS=80-$L(LABEL)/2,$P(LINE,"-",81)="",$E(LINE,POS+1,POS+$L(LABEL))=LABEL
"RTN","PSOORUT1",128,0)
 S ^TMP("PSOPF",$J,IEN,0)=LINE
"RTN","PSOORUT1",129,0)
 Q
"RTN","PSOORUT1",130,0)
PENX S PSOLST(PSOCNT)="52.41^"_$P(PSODATA,"^",10)_"^"_PSOSTA
"RTN","PSOORUT1",131,0)
 K PSODATA,PSOLF,RN,PSOLSP,PSOQTL,PSOLNT
"RTN","PSOORUT1",132,0)
 Q
"RTN","PSOORUT1",133,0)
PEN ;
"RTN","PSOORUT1",134,0)
 N PSOQTL,PSOLNT,PSOLNTZ,PSOQTLX,PSCMOPF,SPACEZ
"RTN","PSOORUT1",135,0)
 Q:'$D(^PS(52.41,$P(PSODATA,"^",10),0))
"RTN","PSOORUT1",136,0)
 S PSCMOPF=0 I $P($G(PSODATA),"^",11),$D(^PSDRUG("AQ",$P(PSODATA,"^",11))) S PSCMOPF=1
"RTN","PSOORUT1",137,0)
 S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)=$J(PSOCNT,2)_$S($L(PSOCNT)<3:" ",1:"")_$P(PSODRG,"^")
"RTN","PSOORUT1",138,0)
 I $P($G(^PS(52.41,+$P(PSODATA,"^",10),0)),"^",23)=1 S ^TMP("PSOPF",$J,IEN,"RV")=""
"RTN","PSOORUT1",139,0)
 S PSOLNT=$L($P(PSODRG,"^")),PSOLNTZ=$L($P(PSODATA,"^",8))
"RTN","PSOORUT1",140,0)
 S $P(PSOQTLX," ",(11-PSOLNTZ))=" "
"RTN","PSOORUT1",141,0)
 S:PSOLNT<37 $P(PSOQTL," ",(37-PSOLNT))=" "
"RTN","PSOORUT1",142,0)
 I PSOLNT<38 D  G PENX
"RTN","PSOORUT1",143,0)
 .I PSOLNT=37 S PSOQTL=""
"RTN","PSOORUT1",144,0)
 .I $P(^PS(52.41,$P(PSODATA,"^",10),0),"^",3)="RF" S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$G(PSOQTL)_"  Refill Request   Rx #: "_$P(^PSRX($P(^PS(52.41,$P(PSODATA,"^",10),0),"^",19),0),"^") Q
"RTN","PSOORUT1",145,0)
 .S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$G(PSOQTL)_"  "_"QTY: "_$P(PSODATA,"^",8)_$G(PSOQTLX)_" ISDT: "_$S('$P(PSODATA,"^",9):"     ",1:$E($P(PSODATA,"^",9),4,5)_"-"_$E($P(PSODATA,"^",9),6,7))_$S($G(PSCMOPF):"> ",1:"  ")
"RTN","PSOORUT1",146,0)
 .S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_"REF: "_$S($L($P(PSODATA,"^",6))>1:"",1:" ")_$P(PSODATA,"^",6)
"RTN","PSOORUT1",147,0)
 S IEN=IEN+1,$P(SPACEZ," ",42)=" "
"RTN","PSOORUT1",148,0)
 I $P(^PS(52.41,$P(PSODATA,"^",10),0),"^",3)="RF" S ^TMP("PSOPF",$J,IEN,0)=SPACEZ_"Refill Request   Rx #: "_$P(^PSRX($P(^PS(52.41,$P(PSODATA,"^",10),0),"^",19),0),"^") G PENX
"RTN","PSOORUT1",149,0)
 S ^TMP("PSOPF",$J,IEN,0)=SPACEZ_"QTY: "_$P(PSODATA,"^",8)_$G(PSOQTLX)_" ISDT: "_$S('$P(PSODATA,"^",9):"     ",1:$E($P(PSODATA,"^",9),4,5)_"-"_$E($P(PSODATA,"^",9),6,7))_$S($G(PSCMOPF):"> ",1:"  ")_"REF: "_$S($L($P(PSODATA,"^",6))>1:"",1:" ")
"RTN","PSOORUT1",150,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$P(PSODATA,"^",6)
"RTN","PSOORUT1",151,0)
 G PENX
"RTN","PSOORUT1",152,0)
 ;
"RTN","PSOORUT1",153,0)
NVA ; Setting the Non-VA Meds on the Medication Profile Screen (ListMan)
"RTN","PSOORUT1",154,0)
 S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)="  "_$P(PSODRG,"^")_" "
"RTN","PSOORUT1",155,0)
 I ($L(^TMP("PSOPF",$J,IEN,0))+$L($P(PSODATA,"^",6))>70) S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)="    "
"RTN","PSOORUT1",156,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$P(PSODATA,"^",6)_" "
"RTN","PSOORUT1",157,0)
 I ($L(^TMP("PSOPF",$J,IEN,0))+$L($P(PSODATA,"^",8))>70) S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)="    "
"RTN","PSOORUT1",158,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$P(PSODATA,"^",8)
"RTN","PSOORUT1",159,0)
 I ($L(^TMP("PSOPF",$J,IEN,0))+20)>70 D  Q
"RTN","PSOORUT1",160,0)
 . S IEN=IEN+1,$P(^TMP("PSOPF",$J,IEN,0)," ",51)="Date Documented: "_$E($P(PSODATA,"^",9),4,5)_"/"_$E($P(PSODATA,"^",9),6,7)_"/"_$E($P(PSODATA,"^",9),2,3)
"RTN","PSOORUT1",161,0)
 F I=0:0 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_" " Q:$L(^TMP("PSOPF",$J,IEN,0))>49
"RTN","PSOORUT1",162,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_"Date Documented: "_$E($P(PSODATA,"^",9),4,5)_"/"_$E($P(PSODATA,"^",9),6,7)_"/"_$E($P(PSODATA,"^",9),2,3)
"RTN","PSOORUT1",163,0)
 Q
"RTN","PSORENW1")
0^22^B63022534^B60533620
"RTN","PSORENW1",1,0)
PSORENW1 ;BIR/DSD - Renew Main Driver Continuation ;03/29/93
"RTN","PSORENW1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,37,51,46,71,117,157,143,219,239,225,444**;DEC 1997;Build 34
"RTN","PSORENW1",3,0)
 ;External reference ^VA(200 supported by DBIA 10060
"RTN","PSORENW1",4,0)
 ;
"RTN","PSORENW1",5,0)
START ;
"RTN","PSORENW1",6,0)
 S PSORENW("RX0")=^PSRX(PSORENW("OIRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN")),SIGOK=+$P($G(^("SIG")),"^",2)
"RTN","PSORENW1",7,0)
 S PSOIBOLD=$G(PSORENW("OIRXN"))
"RTN","PSORENW1",8,0)
 D SETIB
"RTN","PSORENW1",9,0)
 S PSORENW("PROVIDER")=$P(PSORENW("RX0"),"^",4)
"RTN","PSORENW1",10,0)
 S PSORX("PROVIDER NAME")=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSORENW1",11,0)
 S PSORENW("CLINIC")=$P(PSORENW("RX0"),"^",5),PSORENW("COPIES")=$P(PSORENW("RX0"),"^",18)
"RTN","PSORENW1",12,0)
 I $G(PSOFDR),$P($G(OR0),"^",13) S PSORENW("CLINIC")=$P($G(OR0),"^",13)
"RTN","PSORENW1",13,0)
 S PSORENW("REMARKS")="RENEWED FROM RX # "_$P(PSORENW("RX0"),"^")
"RTN","PSORENW1",14,0)
 S PSORENW("SIG")=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^")
"RTN","PSORENW1",15,0)
 S:$P(PSORENW("RX3"),"^",3) PSORENW("COSIGNING PROVIDER")=$P(PSORENW("RX3"),"^",3)
"RTN","PSORENW1",16,0)
 S (PSODFN,PSORENW("PSODFN"))=$P(PSORENW("RX0"),"^",2)
"RTN","PSORENW1",17,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSORENW1",18,0)
 S PSORENW("DRUG IEN")=$P(PSORENW("RX0"),"^",6)
"RTN","PSORENW1",19,0)
 S PSORENW("INS")=$S($G(PSORENW("INS"))]"":PSORENW("INS"),1:$G(^PSRX(PSORENW("OIRXN"),"INS")))
"RTN","PSORENW1",20,0)
 S D=0 F  S D=$O(^PSRX(PSORENW("OIRXN"),"INS1",D)) Q:'D  S PSORENW("SIG",D)=^PSRX(PSORENW("OIRXN"),"INS1",D,0)
"RTN","PSORENW1",21,0)
 I '$O(PSORENW("SIG",0)),$G(PSORENW("INS"))]"" S PSORENW("SIG",1)=PSORENW("INS")
"RTN","PSORENW1",22,0)
 G:$G(PSORENW("ENT")) FDR
"RTN","PSORENW1",23,0)
 I $G(PSORENW("ENT"))'>0,'$O(^PSRX(PSORENW("OIRXN"),6,0)) S PSORENW("ENT")=0 G FDR
"RTN","PSORENW1",24,0)
 F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),6,I)) Q:'I  S DOSE=^PSRX(PSORENW("OIRXN"),6,I,0) D
"RTN","PSORENW1",25,0)
 .S PSORENW("ENT")=$G(PSORENW("ENT"))+1,PSORENW("DOSE",PSORENW("ENT"))=$P(DOSE,"^")
"RTN","PSORENW1",26,0)
 .S PSORENW("UNITS",PSORENW("ENT"))=$P(DOSE,"^",3),PSORENW("DOSE ORDERED",PSORENW("ENT"))=$P(DOSE,"^",2),PSORENW("ROUTE",PSORENW("ENT"))=$P(DOSE,"^",7)
"RTN","PSORENW1",27,0)
 .S PSORENW("SCHEDULE",PSORENW("ENT"))=$P(DOSE,"^",8),PSORENW("DURATION",PSORENW("ENT"))=$P(DOSE,"^",5),PSORENW("CONJUNCTION",PSORENW("ENT"))=$P(DOSE,"^",6)
"RTN","PSORENW1",28,0)
 .S PSORENW("NOUN",PSORENW("ENT"))=$P(DOSE,"^",4),PSORENW("VERB",PSORENW("ENT"))=$P(DOSE,"^",9)
"RTN","PSORENW1",29,0)
 .I $G(^PSRX(PSORENW("OIRXN"),6,I,1))]"" S PSORENW("ODOSE",PSORENW("ENT"))=^PSRX(PSORENW("OIRXN"),6,I,1)
"RTN","PSORENW1",30,0)
 .K DOSE
"RTN","PSORENW1",31,0)
FDR I $G(PSOFDR) D
"RTN","PSORENW1",32,0)
 .F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),6,I)) Q:'I  I $G(^PSRX(PSORENW("OIRXN"),6,I,1))]"" S PSORENW("ODOSE",I)=^PSRX(PSORENW("OIRXN"),6,I,1)
"RTN","PSORENW1",33,0)
 .S $P(PSORENW("RX0"),"^",7)=$P(OR0,"^",10),$P(PSORENW("RX0"),"^",11)=$P(OR0,"^",17)
"RTN","PSORENW1",34,0)
 .S (PSORX("PROVIDER NAME"),PSORENW("PROVIDER NAME"))=$P(^VA(200,$P(OR0,"^",5),0),"^"),PSORENW("PROVIDER")=$P(OR0,"^",5)
"RTN","PSORENW1",35,0)
 .K PSORENW("COSIGNING PROVIDER")
"RTN","PSORENW1",36,0)
 .I $G(PSORENW("PROVIDER")),$P($G(^VA(200,PSORENW("PROVIDER"),"PS")),"^",7),$P($G(^("PS")),"^",8) S PSORENW("COSIGNING PROVIDER")=$P($G(^("PS")),"^",8)
"RTN","PSORENW1",37,0)
 .S (PSDY,PSORENW("DAYS SUPPLY"))=$P(PSORENW("RX0"),"^",8)
"RTN","PSORENW1",38,0)
 .S POERR=1,DREN=$P(PSORENW("RX0"),"^",6) D DRG^PSOORDRG K POERR S PSODIR("CS")=0
"RTN","PSORENW1",39,0)
 .F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S PSODIR("CS")=1
"RTN","PSORENW1",40,0)
 .; Retrieving the Maximum Number of Refills allowed
"RTN","PSORENW1",41,0)
 .S RFMX=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),+$G(PSORENW("DAYS SUPPLY")),+$P(^PSRX(PSORENW("OIRXN"),0),"^",3),.CLOZPAT)
"RTN","PSORENW1",42,0)
 .S $P(PSORENW("RX0"),"^",9)=$S($P(OR0,"^",11)'>RFMX:$P(OR0,"^",11),1:RFMX),$P(OR0,"^",11)=$P(PSORENW("RX0"),"^",9)
"RTN","PSORENW1",43,0)
 .K RFMX,PSODIR("CS"),PSDY
"RTN","PSORENW1",44,0)
 S:'$G(PSORENW("QTY")) PSORENW("QTY")=$P(PSORENW("RX0"),"^",7)
"RTN","PSORENW1",45,0)
 S:'$G(PSORENW("DAYS SUPPLY")) PSORENW("DAYS SUPPLY")=$P(PSORENW("RX0"),"^",8)
"RTN","PSORENW1",46,0)
 D DAYSUP^PSOUTIL($P(PSORENW("RX0"),"^",6),.PSORENW,1)
"RTN","PSORENW1",47,0)
END Q
"RTN","PSORENW1",48,0)
STOP K PSEXDT,X,%DT S PSON52("QFLG")=0,DAYS=$S($G(PSORENW("DAYS SUPPLY")):PSORENW("DAYS SUPPLY"),1:$P(PSORENW("RX0"),"^",8))
"RTN","PSORENW1",49,0)
 S DEA("CS")=0 K DIR,DIC
"RTN","PSORENW1",50,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S DEA("CS")=1
"RTN","PSORENW1",51,0)
 S X1=$S($G(PSORENW("ISSUE DATE")):$G(PSORENW("ISSUE DATE")),1:DT),X2=DAYS*($P(PSORENW("RX0"),"^",9)+1)\1
"RTN","PSORENW1",52,0)
 S X2=$S(DAYS=X2&('DEA("CS")):X2,DEA("CS"):184,1:366) D C^%DTC
"RTN","PSORENW1",53,0)
 I PSORENW("FILL DATE")>$P(X,".") S PSEXDT=1_"^"_$P(X,".")
"RTN","PSORENW1",54,0)
 K X1,X2,X,%DT
"RTN","PSORENW1",55,0)
 Q
"RTN","PSORENW1",56,0)
OERR ;renewal finish from oe/rr
"RTN","PSORENW1",57,0)
 S PSORENW("RX0")=^PSRX(PSORENW("OIRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN"))
"RTN","PSORENW1",58,0)
 S $P(PSORENW("RX0"),"^",4)=$P(OR0,"^",5)
"RTN","PSORENW1",59,0)
 S PSORENW("PROVIDER")=$P(OR0,"^",5)
"RTN","PSORENW1",60,0)
 S PSORX("PROVIDER NAME")=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSORENW1",61,0)
 S $P(PSORENW("RX0"),"^",5)=$P(OR0,"^",13)
"RTN","PSORENW1",62,0)
 S PSORENW("CLINIC")=$P(OR0,"^",13)
"RTN","PSORENW1",63,0)
 S PSORENW("REMARKS")="RENEWED FROM RX # "_$P(PSORENW("RX0"),"^")_"."_$S($P(OR0,"^",17)="C":" Administered in Clinic.",1:"")
"RTN","PSORENW1",64,0)
 S PSORENW("SIG")=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^"),SIGOK=$P(^("SIG"),"^",2) I SIGOK D
"RTN","PSORENW1",65,0)
 .F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),"SIG1",I)) Q:'I  S SIG(I)=^PSRX(PSORENW("OIRXN"),"SIG1",I,0)
"RTN","PSORENW1",66,0)
 S:$P(PSORENW("RX3"),"^",3) PSORENW("COSIGNING PROVIDER")=$P(PSORENW("RX3"),"^",3)
"RTN","PSORENW1",67,0)
 S PSORENW("PSODFN")=$P(PSORENW("RX0"),"^",2)
"RTN","PSORENW1",68,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSORENW1",69,0)
 S PSORENW("DRUG IEN")=$P(PSORENW("RX0"),"^",6),$P(PSORENW("RX0"),"^",11)=$P(OR0,"^",17)
"RTN","PSORENW1",70,0)
 S PSORENW("INS")=$S($G(PSORENW("INS"))]"":PSORENW("INS"),1:$G(^PSRX(PSORENW("OIRXN"),"INS")))
"RTN","PSORENW1",71,0)
 Q:$G(PSORENW("ENT"))>0
"RTN","PSORENW1",72,0)
 F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),6,I)) Q:'I  S DOSE=^PSRX(PSORENW("OIRXN"),6,I,0) D
"RTN","PSORENW1",73,0)
 .S PSORENW("ENT")=PSORENW("ENT")+1,PSORENW("DOSE",PSORENW("ENT"))=$P(DOSE,"^")
"RTN","PSORENW1",74,0)
 .S PSORENW("UNITS",PSORENW("ENT"))=$P(DOSE,"^",3),PSORENW("DOSE ORDERED",PSORENW("ENT"))=$P(DOSE,"^",2),PSORENW("ROUTE",PSORENW("ENT"))=$P(DOSE,"^",7)
"RTN","PSORENW1",75,0)
 .S PSORENW("SCHEDULE",PSORENW("ENT"))=$P(DOSE,"^",8),PSORENW("DURATION",PSORENW("ENT"))=$P(DOSE,"^",5),PSORENW("CONJUNCTION",PSORENW("ENT"))=$P(DOSE,"^",6)
"RTN","PSORENW1",76,0)
 .S PSORENW("NOUN",PSORENW("ENT"))=$P(DOSE,"^",4),PSORENW("VERB",PSORENW("ENT"))=$P(DOSE,"^",9)
"RTN","PSORENW1",77,0)
 .I $G(^PSRX(PSORENW("OIRXN"),6,I,1))]"" S PSORENW("ODOSE",PSORENW("ENT"))=^PSRX(PSORENW("OIRXN"),6,I,1)
"RTN","PSORENW1",78,0)
 .K DOSE
"RTN","PSORENW1",79,0)
 Q
"RTN","PSORENW1",80,0)
 ;
"RTN","PSORENW1",81,0)
SETIB ;Set defaults on Renewals with Copay information
"RTN","PSORENW1",82,0)
 ;If answer is in Pending File, use that, else look in Prescription file
"RTN","PSORENW1",83,0)
 N PSOOICD,JJJ
"RTN","PSORENW1",84,0)
 K PSOSCP,PSOANSQ("SC>50") D SCP^PSORN52D S PSOANSQ("SC>50")="" K PSOSCA
"RTN","PSORENW1",85,0)
 I '$G(PSOIBOLD) Q
"RTN","PSORENW1",86,0)
 I $G(PSOFDR),$G(ORD) D SETIBP Q
"RTN","PSORENW1",87,0)
 ;I '$$DT^PSOMLLDT Q
"RTN","PSORENW1",88,0)
 I $G(PSORX(PSOIBOLD,"SC"))'=0,$G(PSORX(PSOIBOLD,"SC"))'=1 S PSORX(PSOIBOLD,"SC")=$S($P($G(^PSRX(PSOIBOLD,"IBQ")),"^")'="":$P($G(^("IBQ")),"^"),$P($G(^PSRX(PSOIBOLD,"IB")),"^"):0,1:"")
"RTN","PSORENW1",89,0)
 I $G(PSORX(PSOIBOLD,"SC"))="" K PSORX(PSOIBOLD,"SC")
"RTN","PSORENW1",90,0)
 I '$$DT^PSOMLLDT Q
"RTN","PSORENW1",91,0)
 I $G(PSORX(PSOIBOLD,"MST"))'=0,$G(PSORX(PSOIBOLD,"MST"))'=1,$P($G(^PSRX(PSOIBOLD,"IBQ")),"^",2)'="" S PSORX(PSOIBOLD,"MST")=$P($G(^("IBQ")),"^",2)
"RTN","PSORENW1",92,0)
 I $G(PSORX(PSOIBOLD,"VEH"))'=0,$G(PSORX(PSOIBOLD,"VEH"))'=1,$P($G(^PSRX(PSOIBOLD,"IBQ")),"^",3)'="" S PSORX(PSOIBOLD,"VEH")=$P($G(^("IBQ")),"^",3)
"RTN","PSORENW1",93,0)
 I $G(PSORX(PSOIBOLD,"RAD"))'=0,$G(PSORX(PSOIBOLD,"RAD"))'=1,$P($G(^PSRX(PSOIBOLD,"IBQ")),"^",4)'="" S PSORX(PSOIBOLD,"RAD")=$P($G(^("IBQ")),"^",4)
"RTN","PSORENW1",94,0)
 I $G(PSORX(PSOIBOLD,"PGW"))'=0,$G(PSORX(PSOIBOLD,"PGW"))'=1,$P($G(^PSRX(PSOIBOLD,"IBQ")),"^",5)'="" S PSORX(PSOIBOLD,"PGW")=$P($G(^("IBQ")),"^",5)
"RTN","PSORENW1",95,0)
 I $G(PSORX(PSOIBOLD,"HNC"))'=0,$G(PSORX(PSOIBOLD,"HNC"))'=1,$P($G(^PSRX(PSOIBOLD,"IBQ")),"^",6)'="" S PSORX(PSOIBOLD,"HNC")=$P($G(^("IBQ")),"^",6)
"RTN","PSORENW1",96,0)
 I $G(PSORX(PSOIBOLD,"CV"))'=0,$G(PSORX(PSOIBOLD,"CV"))'=1,$P($G(^PSRX(PSOIBOLD,"IBQ")),"^",7)'="" S PSORX(PSOIBOLD,"CV")=$P($G(^("IBQ")),"^",7)
"RTN","PSORENW1",97,0)
 I $G(PSORX(PSOIBOLD,"SHAD"))'=0,$G(PSORX(PSOIBOLD,"SHAD"))'=1,$P($G(^PSRX(PSOIBOLD,"IBQ")),"^",8)'="" S PSORX(PSOIBOLD,"SHAD")=$P($G(^("IBQ")),"^",8)
"RTN","PSORENW1",98,0)
 ;
"RTN","PSORENW1",99,0)
SET2 ;for when patient status is exempt or SC>50
"RTN","PSORENW1",100,0)
 I $TR($G(^PSRX(PSOIBOLD,"IBQ")),"^")="" S PSOOICD=$G(^PSRX(PSOIBOLD,"ICD",1,0)) D SET3:PSOOICD'=""
"RTN","PSORENW1",101,0)
 ;
"RTN","PSORENW1",102,0)
ICD I $D(^PSRX(PSORENW("OIRXN"),"ICD",0)) D
"RTN","PSORENW1",103,0)
 . N JJ,ICD,II,FLD,RXN S RXN=PSOIBOLD
"RTN","PSORENW1",104,0)
 . S II=0 F  S II=$O(^PSRX(PSORENW("OIRXN"),"ICD",II)) Q:II=""!(II'?1N.N)  D
"RTN","PSORENW1",105,0)
 .. S ICD=^PSRX(PSORENW("OIRXN"),"ICD",II,0),FLD=$P(ICD,U) D ICD^PSONEWF
"RTN","PSORENW1",106,0)
 Q
"RTN","PSORENW1",107,0)
SET3 ;for when patient status is exempt or SC>50
"RTN","PSORENW1",108,0)
 D SET3^PSORN52D
"RTN","PSORENW1",109,0)
 Q
"RTN","PSORENW1",110,0)
 ;
"RTN","PSORENW1",111,0)
SETIBP ;
"RTN","PSORENW1",112,0)
 I $P($G(^PS(52.41,ORD,0)),"^",16)="SC"!($P($G(^(0)),"^",16)="NSC") S PSORX(PSOIBOLD,"SC")=$S($P($G(^(0)),"^",16)="SC":1,1:0)
"RTN","PSORENW1",113,0)
 I $G(PSORX(PSOIBOLD,"SC"))="" K PSORX(PSOIBOLD,"SC")
"RTN","PSORENW1",114,0)
 I '$$DT^PSOMLLDT Q
"RTN","PSORENW1",115,0)
 N PSOIBQFN S PSOIBQFN=$G(^PS(52.41,ORD,"IBQ"))
"RTN","PSORENW1",116,0)
 I $P(PSOIBQFN,"^",1)=0!($P(PSOIBQFN,"^",1)=1) S PSORX(PSOIBOLD,"MST")=$P(PSOIBQFN,"^")
"RTN","PSORENW1",117,0)
 I $P(PSOIBQFN,"^",2)=0!($P(PSOIBQFN,"^",2)=1) S PSORX(PSOIBOLD,"VEH")=$P(PSOIBQFN,"^",2)
"RTN","PSORENW1",118,0)
 I $P(PSOIBQFN,"^",3)=0!($P(PSOIBQFN,"^",3)=1) S PSORX(PSOIBOLD,"RAD")=$P(PSOIBQFN,"^",3)
"RTN","PSORENW1",119,0)
 I $P(PSOIBQFN,"^",4)=0!($P(PSOIBQFN,"^",4)=1) S PSORX(PSOIBOLD,"PGW")=$P(PSOIBQFN,"^",4)
"RTN","PSORENW1",120,0)
 I $P(PSOIBQFN,"^",5)=0!($P(PSOIBQFN,"^",5)=1) S PSORX(PSOIBOLD,"HNC")=$P(PSOIBQFN,"^",5)
"RTN","PSORENW1",121,0)
 I $P(PSOIBQFN,"^",6)=0!($P(PSOIBQFN,"^",6)=1) S PSORX(PSOIBOLD,"CV")=$P(PSOIBQFN,"^",6)
"RTN","PSORENW1",122,0)
 I $P(PSOIBQFN,"^",7)=0!($P(PSOIBQFN,"^",7)=1) S PSORX(PSOIBOLD,"SHAD")=$P(PSOIBQFN,"^",7)
"RTN","PSORENW1",123,0)
 ;for when patient status is exempt, null IBQ node was set for exempts or SC>50 - data is in ICD node
"RTN","PSORENW1",124,0)
 I $TR($G(^PS(52.41,ORD,"IBQ")),"^")="" S PSOOICD=$G(^PS(52.41,ORD,"ICD",1,0)) D SET3:PSOOICD'=""
"RTN","PSORENW1",125,0)
 ;
"RTN","PSORENW1",126,0)
ICD2 ;
"RTN","PSORENW1",127,0)
 I $D(^PS(52.41,ORD,"ICD",0)) D
"RTN","PSORENW1",128,0)
 . N JJ,ICD,II,FLD,RXN S RXN=ORD
"RTN","PSORENW1",129,0)
 . S II=0 F  S II=$O(^PS(52.41,ORD,"ICD",II)) Q:II=""!(II'?1N.N)  D
"RTN","PSORENW1",130,0)
 .. S ICD="",ICD=^PS(52.41,ORD,"ICD",II,0)
"RTN","PSORENW1",131,0)
 .. I $G(PSOSCP)>49&(II=1) S PSORX(PSOIBOLD,"SC>50")=$P(ICD,"^",4)
"RTN","PSORENW1",132,0)
 .. S JJ="" F JJ=1:1:9 S FLD=$P(ICD,U,JJ) D ICD^PSONEWF
"RTN","PSORENW1",133,0)
 K PSOIBQFN
"RTN","PSORENW1",134,0)
 Q
"RTN","PSORENW1",135,0)
KLIB ;Kill renewal IB array
"RTN","PSORENW1",136,0)
 I '$G(PSOIBOLD) Q
"RTN","PSORENW1",137,0)
 K PSORX(PSOIBOLD,"SC"),PSORX(PSOIBOLD,"MST"),PSORX(PSOIBOLD,"VEH"),PSORX(PSOIBOLD,"RAD"),PSORX(PSOIBOLD,"PGW"),PSORX(PSOIBOLD,"HNC"),PSORX(PSOIBOLD,"CV"),PSORX(PSOIBOLD,"SHAD")
"RTN","PSORENW1",138,0)
 K PSOIBOLD
"RTN","PSORENW1",139,0)
 Q
"RTN","PSORENW3")
0^26^B40697440^B40461998
"RTN","PSORENW3",1,0)
PSORENW3 ;IHS/DSD/JCM - EDIT TEMPLATE FOR RENEW RX ORDER ENTRY ; 03/28/93 20:59
"RTN","PSORENW3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,20,46,100,117,444**;DEC 1997;Build 34
"RTN","PSORENW3",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSORENW3",4,0)
 ;External reference to ^SC supported by DBIA 10040
"RTN","PSORENW3",5,0)
 ;
"RTN","PSORENW3",6,0)
START ;
"RTN","PSORENW3",7,0)
 D INIT
"RTN","PSORENW3",8,0)
 ;
"RTN","PSORENW3",9,0)
1 S PSORENW("FLD")=1 D ISSDT^PSODIR2(.PSORENW) ; Get Issue Date
"RTN","PSORENW3",10,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",11,0)
 ;
"RTN","PSORENW3",12,0)
2 S PSORENW("FLD")=2 D FILLDT^PSODIR2(.PSORENW) ; Get Fill date
"RTN","PSORENW3",13,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",14,0)
 ;
"RTN","PSORENW3",15,0)
3 S PSORENW("FLD")=3 D PROV^PSODIR(.PSORENW) ; Get Provider
"RTN","PSORENW3",16,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",17,0)
 ;
"RTN","PSORENW3",18,0)
4 S PSORENW("FLD")=4,PSORENW("DAYS SUPPLY")=$P(PSORENW("RX0"),"^",8)
"RTN","PSORENW3",19,0)
 K PSORENW("# OF REFILLS") D REFILL^PSODIR1(.PSORENW) ; Get # of refills
"RTN","PSORENW3",20,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",21,0)
 ;
"RTN","PSORENW3",22,0)
5 S PSORENW("FLD")=5 D RMK^PSODIR2(.PSORENW) ; Get Remarks
"RTN","PSORENW3",23,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",24,0)
 ;
"RTN","PSORENW3",25,0)
6 S PSORENW("FLD")=6 D MW^PSODIR2(.PSORENW) ; Get Mail/Window Info
"RTN","PSORENW3",26,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",27,0)
 ;
"RTN","PSORENW3",28,0)
7 I $G(DUZ("AG"))="I" S PSORENW("FLD")=7 D EXP^PSODIR2(.PSORENW) ; Get Expiration Date - Indian Health Service ONLY
"RTN","PSORENW3",29,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",30,0)
 ;
"RTN","PSORENW3",31,0)
8 I $G(DUZ("AG"))="I" S PSORENW("FLD")=8 D CLERK^PSODIR2(.PSORENW) ; Get Clerk Code
"RTN","PSORENW3",32,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",33,0)
 ;
"RTN","PSORENW3",34,0)
9 S PSORENW("FLD")=9 D CLINIC^PSODIR2(.PSORENW)
"RTN","PSORENW3",35,0)
 G:PSORENW("DFLG") END G:PSORENW("FIELD") @PSORENW("FIELD")
"RTN","PSORENW3",36,0)
 ;
"RTN","PSORENW3",37,0)
END ;
"RTN","PSORENW3",38,0)
 K PSORENW3 S PSORENW("EDIT")=1
"RTN","PSORENW3",39,0)
 Q
"RTN","PSORENW3",40,0)
 ;
"RTN","PSORENW3",41,0)
INIT ;
"RTN","PSORENW3",42,0)
 S:'$G(PSORENW("QTY")) PSORENW("QTY")=$P(PSORENW("RX0"),"^",7)
"RTN","PSORENW3",43,0)
 S:'$G(PSORENW("DAYS SUPPLY")) PSORENW("DAYS SUPPLY")=$P(PSORENW("RX0"),"^",8)
"RTN","PSORENW3",44,0)
 S (PSORENW("DFLG"),PSORENW("FIELD"),PSORENW3)=0
"RTN","PSORENW3",45,0)
 G:$G(PSORENW("EDIT")) INITX
"RTN","PSORENW3",46,0)
 S PSORENW("ISSUE DATE")=$S(DT>PSORENW("FILL DATE"):PSORENW("FILL DATE"),1:DT)
"RTN","PSORENW3",47,0)
 S PSORENW("CLINIC")=$P(PSORENW("RX0"),"^",5)
"RTN","PSORENW3",48,0)
 I $G(PSOFDR),$P($G(OR0),"^",13) S PSORENW("CLINIC")=$P($G(OR0),"^",13)
"RTN","PSORENW3",49,0)
 S:PSORENW("CLINIC") PSORX("CLINIC")=$P(^SC(PSORENW("CLINIC"),0),"^")
"RTN","PSORENW3",50,0)
 S Y=PSORENW("FILL DATE") X ^DD("DD") S PSORX("FILL DATE")=Y K Y
"RTN","PSORENW3",51,0)
 S PSORENW("PROVIDER")=$S($G(PSORENW("PROVIDER")):PSORENW("PROVIDER"),1:$P(PSORENW("RX0"),"^",4))
"RTN","PSORENW3",52,0)
 S PSORENW("PROVIDER NAME")=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSORENW3",53,0)
 S PSORENW("PTST NODE")=$G(^PS(53,$P(PSORENW("RX0"),"^",3),0))
"RTN","PSORENW3",54,0)
 S PSORENW("# OF REFILLS")=$S($G(PSORENW("# OF REFILLS")):PSORENW("# OF REFILLS"),1:$P(PSORENW("RX0"),"^",9))
"RTN","PSORENW3",55,0)
 S PSORENW("REMARKS")="RENEWED FROM RX # "_$P(PSORENW("RX0"),"^")
"RTN","PSORENW3",56,0)
 S PSORX("MAIL/WINDOW")=$S($G(PSORX("MAIL/WINDOW"))]"":PSORX("MAIL/WINDOW"),$P(PSORENW("RX0"),"^",11)="W":"WINDOW",1:"MAIL")
"RTN","PSORENW3",57,0)
 S:$G(PSORX("CLERK CODE"))']"" PSORX("CLERK CODE")=$P($G(^VA(200,DUZ,0)),"^")
"RTN","PSORENW3",58,0)
 S PSORENW("INS")=$S($G(PSORENW("INS"))]"":PSORENW("INS"),1:$G(^PSRX(PSORENW("OIRXN"),"INS")))
"RTN","PSORENW3",59,0)
 F D=0:0 S D=$O(^PSRX(PSORENW("OIRXN"),"INS1",D)) Q:'D  S PSORENW("SIG",D)=^PSRX(PSORENW("OIRXN"),"INS1",D,0)
"RTN","PSORENW3",60,0)
 I '$O(PSORENW("DOSE",0)) F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),6,I)) Q:'I  S DOSE=^PSRX(PSORENW("OIRXN"),6,I,0) D
"RTN","PSORENW3",61,0)
 .S PSORENW("ENT")=$G(PSORENW("ENT"))+1,PSORENW("DOSE",PSORENW("ENT"))=$P(DOSE,"^")
"RTN","PSORENW3",62,0)
 .S PSORENW("UNITS",PSORENW("ENT"))=$P(DOSE,"^",3),PSORENW("DOSE ORDERED",PSORENW("ENT"))=$P(DOSE,"^",2),PSORENW("ROUTE",PSORENW("ENT"))=$P(DOSE,"^",7)
"RTN","PSORENW3",63,0)
 .S PSORENW("SCHEDULE",PSORENW("ENT"))=$P(DOSE,"^",8),PSORENW("DURATION",PSORENW("ENT"))=$P(DOSE,"^",5),PSORENW("CONJUNCTION",PSORENW("ENT"))=$P(DOSE,"^",6)
"RTN","PSORENW3",64,0)
 .S PSORENW("NOUN",PSORENW("ENT"))=$P(DOSE,"^",4),PSORENW("VERB",PSORENW("ENT"))=$P(DOSE,"^",9)
"RTN","PSORENW3",65,0)
 .I $G(^PSRX(PSORENW("OIRXN"),6,I,1))]"" S PSORENW("ODOSE",PSORENW("ENT"))=^PSRX(PSORENW("OIRXN"),6,I,1)
"RTN","PSORENW3",66,0)
 .K DOSE
"RTN","PSORENW3",67,0)
 I $P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^",2),'$O(SIG(0)) S SIGOK=1 D  Q
"RTN","PSORENW3",68,0)
 .F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),"SIG1",I)) Q:'I  S SIG(I)=^PSRX(PSORENW("OIRXN"),"SIG1",I,0)
"RTN","PSORENW3",69,0)
 .I '$O(SIG(0)),$G(ORD),$G(PSOORRNW) F I=0:0 S I=$O(^PS(52.41,ORD,"SIG",I)) Q:'I  S SIG(I)=^PS(52.41,ORD,"SIG",I,0)
"RTN","PSORENW3",70,0)
 .I '$O(SIG(0)) S SIG(1)="This Prescription is MISSING Required Medication Instructions for the Patient.  Please Review Dosaging Instructions."
"RTN","PSORENW3",71,0)
 I $P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^")]"",'$P(^("SIG"),"^",2),'$O(SIG(0)) S SIGOK=1 D
"RTN","PSORENW3",72,0)
 .S X=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^") D SIG^PSOHELP I $G(INS1)]"" S SIG(1)=$E(INS1,2,999)
"RTN","PSORENW3",73,0)
 .I '$O(SIG(0)) S (PSORENW("SIG"),SIG(1))="This Prescription is MISSING Required Usable Medication Instructions for the Patient.  Please Review Dosaging Instructions."
"RTN","PSORENW3",74,0)
INITX Q
"RTN","PSORENW3",75,0)
JUMP ;
"RTN","PSORENW3",76,0)
 S PSORENW("FIELD")=$S(+Y=1:1,+Y=22:2,+Y=4:3,+Y=5:9,+Y=9:4,+Y=12:5,+Y=11:6,+Y=29:7,+Y=16:8,1:PSORENW("FLD"))
"RTN","PSORENW3",77,0)
 Q
"RTN","PSORENW3",78,0)
DSPLY ;called from PSORENW0
"RTN","PSORENW3",79,0)
 W !!,PSORENW("NRX #"),?12," ",$P(^PSDRUG(PSORENW("DRUG IEN"),0),"^"),?46," QTY: ",$S($G(PSORENW("QTY")):PSORENW("QTY"),1:$P(PSORENW("RX0"),"^",7))
"RTN","PSORENW3",80,0)
 W !,"# OF REFILLS: "_$S($G(PSORENW("# OF REFILLS")):PSORENW("# OF REFILLS"),1:$P(PSORENW("RX0"),"^",9))
"RTN","PSORENW3",81,0)
 W "  ISSUED: "_$S(DT>PSORENW("FILL DATE"):$E(PSORENW("FILL DATE"),4,5)_"-"_$E(PSORENW("FILL DATE"),6,7)_"-"_$E(PSORENW("FILL DATE"),2,3),1:$E(DT,4,5)_"-"_$E(DT,6,7)_"-"_$E(DT,2,3))
"RTN","PSORENW3",82,0)
 F DR=1:1:PSORENW("ENT") I $G(PSORENW("DURATION",DR))]"" D
"RTN","PSORENW3",83,0)
 .S DUR1=PSORENW("DURATION",DR)
"RTN","PSORENW3",84,0)
 .S PSORENW("DURATION",DR)=$S($E(DUR1,1)'?.N:$E(DUR1,2,99)_$E(DUR1,1),1:DUR1)
"RTN","PSORENW3",85,0)
 F D=0:0 S D=$O(^PSRX(PSORENW("OIRXN"),"INS1",D)) Q:'D  S PSORENW("SIG",D)=^PSRX(PSORENW("OIRXN"),"INS1",D,0)
"RTN","PSORENW3",86,0)
 K DR,DUR1 ;D EN^PSOFSIG(.PSORENW)
"RTN","PSORENW3",87,0)
 I $G(SIGOK) D:'$O(SIG(0))  W !,"SIG: " F D=0:0 Q:'$O(SIG(D))  S D=$O(SIG(D)) W SIG(D),!
"RTN","PSORENW3",88,0)
 .F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),"SIG1",I)) Q:'I  S SIG(I)=^PSRX(PSORENW("OIRXN"),"SIG1",I,0)
"RTN","PSORENW3",89,0)
 .I '$O(SIG(0)) S SIG(1)="This Prescription is MISSING Required Usable Medication Instructions",SIG(2)="for the Patient.  Please Review Dosaging Instructions.",PSORENW("DFLG")=1
"RTN","PSORENW3",90,0)
 E  W "  SIG: "_PSORENW("SIG")_"  "
"RTN","PSORENW3",91,0)
 W "FILLED: "_$E(PSORENW("FILL DATE"),4,5)_"-"_$E(PSORENW("FILL DATE"),6,7)_"-"_$E(PSORENW("FILL DATE"),2,3)
"RTN","PSORENW3",92,0)
 W !,"ROUTING: "_$S($G(PSORENW("MAIL/WINDOW"))["W":"WINDOW",1:"MAIL")
"RTN","PSORENW3",93,0)
 W "     PHYS: "_PSORX("PROVIDER NAME"),!
"RTN","PSORENW3",94,0)
 I $G(PSORENW("DFLG")),'$G(SPEED) K DIR S DIR(0)="E",DIR("A")="Rx NOT Renewed. Press Return to Continue" D ^DIR K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSORENW3",95,0)
DSPLYX Q
"RTN","PSORENW4")
0^11^B65687099^B66539714
"RTN","PSORENW4",1,0)
PSORENW4 ;BIR/SAB - rx speed renew ;03/06/95
"RTN","PSORENW4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,37,64,46,75,71,100,130,117,152,148,264,225,301,390,313,411,444**;DEC 1997;Build 34
"RTN","PSORENW4",3,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSORENW4",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORENW4",5,0)
 ;External reference to $$L^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",6,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",7,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",8,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",9,0)
 ;External reference to LK^ORX2 supported by DBIA 867
"RTN","PSORENW4",10,0)
 ;External reference to ULK^ORX2 supported by DBIA 867
"RTN","PSORENW4",11,0)
SEL K PSODRUG ;PSO*7*301
"RTN","PSORENW4",12,0)
 N PSOSPRNW,PSOIBOLD S PSOSPRNW=1
"RTN","PSORENW4",13,0)
 I $P(PSOPAR,"^",4)=0 S VALMSG="Renewing is NOT Allowed. Check Site Parameters!",VALMBCK="" Q
"RTN","PSORENW4",14,0)
 N VALMCNT I '$G(PSOCNT) S VALMSG="This patient has no Prescriptions!",VALMBCK="" Q
"RTN","PSORENW4",15,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSORENW4",16,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSORENW4",17,0)
 K PRC,PHI,PSORX("EDIT"),PSOFDR,DIR,DUOUT,DIRUT,PSORNSPD S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DUOUT S VALMBCK="" G SELQ
"RTN","PSORENW4",18,0)
 K DIR,DIRUT,DTOUT,PSOOELSE,DTOUT I +Y S (SPEED,PSOOELSE,PSORNSPD)=1 D FULL^VALM1 S LST=Y D
"RTN","PSORENW4",19,0)
 .S (PSODIR("DFLG"),PSODIR("FIELD"))=0,PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"),PSORX("DFLG"))=0 D INIT Q:PSORENW("DFLG")
"RTN","PSORENW4",20,0)
 .F ORD=1:1:$L(LST,",") Q:$P(LST,",",ORD)']""  S ORN=$P(LST,",",ORD) D:+PSOLST(ORN)=52 PROCESS S (PSOQUIT,PSORENW("DFLG"),POERR,POERR("DFLG"),PSORX("DFLG"))=0
"RTN","PSORENW4",21,0)
 I '$G(PSOOELSE) S VALMBCK="" G SELQ
"RTN","PSORENW4",22,0)
 S VALMBCK="R"
"RTN","PSORENW4",23,0)
 D ^PSOBUILD,BLD^PSOORUT1 K DIR,DIRUT,DTOUT,DUOUT,LST,ORD,IEN,ORN,RPH,ST,REFL,REF,PSOACT,ORSV,PSORNW,PSORENW,PSONO,PSOCO,PSOCU,PSODIR,DSMSG,SPEED,PSORENW,PSOOELSE,PSOOPT,PSORX("FILL DATE"),PSORX("ISSUE DATE"),PSOID,PSOMSG,PSORX("DFLG"),PSOQTY
"RTN","PSORENW4",24,0)
SELQ K PSORNSPD,RTE,DRET,PRC,PHI,PSOSPRNW,X S X=PSODFN_";DPT(" D ULK^ORX2,UL^PSSLOCK(PSODFN),CLEAN^PSOVER1
"RTN","PSORENW4",25,0)
 Q
"RTN","PSORENW4",26,0)
 ;
"RTN","PSORENW4",27,0)
PROCESS ; Process one order at a time
"RTN","PSORENW4",28,0)
 ;W !!,"Now Renewing Rx # "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_"   Drug: "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),6),!
"RTN","PSORENW4",29,0)
 I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2)) D  K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",30,0)
 . W $C(7),!,"Rx "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_" has OPEN/UNRESOLVED 3rd Party Payer Rejects!"
"RTN","PSORENW4",31,0)
 I $$TITRX^PSOUTL($P(PSOLST(ORN),"^",2))="t" D  K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",32,0)
 . W $C(7),!,"Rx# "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_" is marked as 'Titration Rx' and cannot be renewed."
"RTN","PSORENW4",33,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) W $C(7),!!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^")),! K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",34,0)
 K RET,DRET,PRC,PHI S PSORENW("OIRXN")=$P(PSOLST(ORN),"^",2),PSOFROM="NEW"
"RTN","PSORENW4",35,0)
 S PSORENW("RX0")=^PSRX(PSORENW("OIRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN")),SIGOK=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^",2)
"RTN","PSORENW4",36,0)
 I SIGOK F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),"SIG1",I)) Q:'I  S SIG(I)=^PSRX(PSORENW("OIRXN"),"SIG1",I,0)
"RTN","PSORENW4",37,0)
 S PSOIBOLD=$G(PSORENW("OIRXN")) D SETIB^PSORENW1
"RTN","PSORENW4",38,0)
 I '$G(PSORENW("PROVIDER")) D
"RTN","PSORENW4",39,0)
 .S PSORENW("PROVIDER")=$P(PSORENW("RX0"),"^",4)
"RTN","PSORENW4",40,0)
 .S:$P(PSORENW("RX3"),"^",3) PSORENW("COSIGNING PROVIDER")=$P(PSORENW("RX3"),"^",3)
"RTN","PSORENW4",41,0)
 S PSORX("PROVIDER NAME")=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSORENW4",42,0)
 I '$G(PSORENW("CLINIC")) S PSORENW("CLINIC")=$P(PSORENW("RX0"),"^",5)
"RTN","PSORENW4",43,0)
 S PSORENW("REMARKS")="RENEWED FROM RX # "_$P(PSORENW("RX0"),"^")
"RTN","PSORENW4",44,0)
 S PSORENW("SIG")=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^")
"RTN","PSORENW4",45,0)
 S PSORENW("PSODFN")=$P(PSORENW("RX0"),"^",2)
"RTN","PSORENW4",46,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSORENW4",47,0)
 S PSORENW("DRUG IEN")=$P(PSORENW("RX0"),"^",6)
"RTN","PSORENW4",48,0)
 S PSORENW("QTY")=$P(PSORENW("RX0"),"^",7)
"RTN","PSORENW4",49,0)
 S PSORENW("INS")=$S($G(PSORENW("ENT"))]"":PSORENW("ENT"),1:$G(^PSRX(PSORENW("OIRXN"),"INS")))
"RTN","PSORENW4",50,0)
 S:$G(PSORENW("ENT"))']"" PSORENW("ENT")=0
"RTN","PSORENW4",51,0)
 N I F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),6,I)) Q:'I  S DOSE=^PSRX(PSORENW("OIRXN"),6,I,0) D
"RTN","PSORENW4",52,0)
 .S PSORENW("ENT")=PSORENW("ENT")+1,PSORENW("DOSE",PSORENW("ENT"))=$P(DOSE,"^")
"RTN","PSORENW4",53,0)
 .S PSORENW("UNITS",PSORENW("ENT"))=$P(DOSE,"^",3),PSORENW("DOSE ORDERED",PSORENW("ENT"))=$P(DOSE,"^",2),PSORENW("ROUTE",PSORENW("ENT"))=$P(DOSE,"^",7)
"RTN","PSORENW4",54,0)
 .S PSORENW("SCHEDULE",PSORENW("ENT"))=$P(DOSE,"^",8),PSORENW("DURATION",PSORENW("ENT"))=$P(DOSE,"^",5),PSORENW("CONJUNCTION",PSORENW("ENT"))=$P(DOSE,"^",6)
"RTN","PSORENW4",55,0)
 .S PSORENW("NOUN",PSORENW("ENT"))=$P(DOSE,"^",4),PSORENW("VERB",PSORENW("ENT"))=$P(DOSE,"^",9)
"RTN","PSORENW4",56,0)
 .I $G(^PSRX(PSORENW("OIRXN"),6,I,1))]"" S PSORENW("ODOSE",PSORENW("ENT"))=^PSRX(PSORENW("OIRXN"),6,I,1)
"RTN","PSORENW4",57,0)
 .K DOSE
"RTN","PSORENW4",58,0)
 I $P($G(^PSDRUG(PSORENW("DRUG IEN"),"CLOZ1")),"^")="PSOCLO1" N PSON S PSON=0 D  I PSON K PSON D POZ,KLIB^PSORENW1 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSORENW4",59,0)
 . I '$L($P(^VA(200,PSORENW("PROVIDER"),"PS"),"^",2)),'$L($P(^VA(200,PSORENW("PROVIDER"),"PS"),"^",3)) D  Q
"RTN","PSORENW4",60,0)
 . . S PSON=1 W $C(7),!!,"Only providers with DEA# or a VA# can write prescriptions for clozapine.",!
"RTN","PSORENW4",61,0)
 . I '$D(^XUSEC("YSCL AUTHORIZED",PSORENW("PROVIDER"))) D 
"RTN","PSORENW4",62,0)
 . . S PSON=1 W $C(7),!!,"Provider must hold YSCL AUTHORIZED key to write prescriptions for clozapine.",!
"RTN","PSORENW4",63,0)
 I $G(PSORNW("MAIL/WINDOW"))]"" S PSORENW("MAIL/WINDOW")=PSORNW("MAIL/WINDOW")
"RTN","PSORENW4",64,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PI",0)) D  K T
"RTN","PSORENW4",65,0)
 .S PHI=^PSRX(PSORENW("OIRXN"),"PI",0),T=0
"RTN","PSORENW4",66,0)
 .F  S T=$O(^PSRX(PSORENW("OIRXN"),"PI",T)) Q:'T  S PHI(T)=^PSRX(PSORENW("OIRXN"),"PI",T,0)
"RTN","PSORENW4",67,0)
 W !!,"Now Renewing Rx # "_PSORENW("ORX #")_"   Drug: "_$P($G(^PSDRUG(+$G(PSORENW("DRUG IEN")),0)),"^"),!
"RTN","PSORENW4",68,0)
 I '$P($G(^PSDRUG($P(PSORENW("RX0"),"^",6),2)),"^") D  G:$G(PSORENW("DFLG")) PROCESSX
"RTN","PSORENW4",69,0)
 .I $P($G(^PSRX(PSORENW("OIRXN"),"OR1")),"^") S PSODRUG("OI")=$P(^PSRX(PSORENW("OIRXN"),"OR1"),"^"),PSODRUG("OIN")=$P(^PS(50.7,+^("OR1"),0),"^") Q
"RTN","PSORENW4",70,0)
 .W !!,"Cannot Renew!!  No Pharmacy Orderable Item!" S VALMSG="Cannot Renew!!  No Pharmacy Orderable Item!",PSORX("DFLG")=1
"RTN","PSORENW4",71,0)
 D POZ
"RTN","PSORENW4",72,0)
 D CHECK^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",73,0)
 D FILDATE^PSORENW0
"RTN","PSORENW4",74,0)
 D DRUG^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",75,0)
 D RXN^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",76,0)
 D STOP^PSORENW1
"RTN","PSORENW4",77,0)
DSPL K PSOEDT,PSOLM,BBFLG,BBRX,BINGCRT,BINGRTE S PSDY=PSORENW("DAYS SUPPLY"),PSRF=PSORENW("# OF REFILLS")
"RTN","PSORENW4",78,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S PSODIR("CS")=1
"RTN","PSORENW4",79,0)
 N MXRFLS
"RTN","PSORENW4",80,0)
 S MXRFLS=$$MAXNUMRF^PSOUTIL(+$G(PSODRUG("IEN")),+$G(PSORENW("DAYS SUPPLY")),+$P(^PSRX(PSORENW("OIRXN"),0),"^",3),.CLOZPAT)
"RTN","PSORENW4",81,0)
 I MXRFLS<PSORENW("# OF REFILLS") S PSORENW("# OF REFILLS")=MXRFLS
"RTN","PSORENW4",82,0)
 D DSPLY^PSORENW3 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",83,0)
 D:$D(^XUSEC("PSORPH",DUZ))!('$P(PSOPAR,"^",2)) VER1^PSOORNE4(.PSORENW) G:PSORENW("DFLG")=1 PROCESSX
"RTN","PSORENW4",84,0)
 I $G(PSOQTY) D QTY^PSODIR1(.PSORENW) G:PSORENW("DFLG")=1 PROCESSX
"RTN","PSORENW4",85,0)
 D EN^PSORN52(.PSORENW)
"RTN","PSORENW4",86,0)
 D RNPSOSD^PSOUTIL
"RTN","PSORENW4",87,0)
 D CAN^PSORENW0,DCORD^PSONEW2
"RTN","PSORENW4",88,0)
 S PSORENW("# OF REFILLS")=PSRF K PSDY,PSRF,PSODIR("CS"),DEA,PSORENW("ENT")
"RTN","PSORENW4",89,0)
 S BBRN="",BBRN1=$O(^PSRX("B",PSORENW("NRX #"),BBRN)) I $P($G(^PSRX(BBRN1,0)),"^",11)["W" S BINGCRT="Y",BINGRTE="W",BBFLG=1,BBRX(1)=$G(BBRX(1))_BBRN1_","
"RTN","PSORENW4",90,0)
PROCESSX I PSORENW("DFLG") D
"RTN","PSORENW4",91,0)
 .K PHI,PRC,PSODRUG,SIG,PSORXED,SIGOK
"RTN","PSORENW4",92,0)
 .K PSORENW("DOSE"),PSORENW("DURATION"),PSORENW("DRUG IEN"),PSORENW("ENT"),PSORENW("INS"),PSORENW("NOUN"),PSORENW("ROUTE"),PSORENW("SCHEDULE"),PSORENW("SIG"),PSORENW("VERB"),PSORENW("UNITS")
"RTN","PSORENW4",93,0)
 .I '$G(POERR) W !,$C(7),"Rx NOT RENEWED. RENEWED RX DELETED",! S POERR("DFLG")=1 D CLEAN^PSOVER1,POZ
"RTN","PSORENW4",94,0)
 K PSORDLOK I PSORENW("DFLG") S PSORDLOK=1
"RTN","PSORENW4",95,0)
 D:$G(PSORENW("OLD FILL DATE"))]"" SUSDATEK^PSOUTIL(.PSORENW)
"RTN","PSORENW4",96,0)
 K BBRN,BBRN1,PSODRUG,PSORX("PROVIDER NAME"),PSORX("CLINIC")
"RTN","PSORENW4",97,0)
 K PSOEDT,PSOLM S:$G(PSORENW("FROM"))="" (PSORENW("DFLG"),PSORENW("QFLG"))=0
"RTN","PSORENW4",98,0)
 I $G(PSORDLOK) D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSORENW4",99,0)
 D KLIB^PSORENW1
"RTN","PSORENW4",100,0)
 K PSORDLOK
"RTN","PSORENW4",101,0)
 S RXN=$O(^TMP("PSORXN",$J,0)) I RXN N ZRXN S ZRXN=RXN D
"RTN","PSORENW4",102,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSORENW4",103,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS",$P(RXN1,"^",4))
"RTN","PSORENW4",104,0)
 .;saves drug allergy order chks pso*7*390
"RTN","PSORENW4",105,0)
 .I $D(^TMP("PSODAOC",$J,"ALLERGY")) D 
"RTN","PSORENW4",106,0)
 ..I $G(PSORX("DFLG"))!$G(PSORENW("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSORENW4",107,0)
 ..S RXN=ZRXN,PSODAOC="Rx Backdoor "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"SPEED RENEW Order Acceptance_OP"
"RTN","PSORENW4",108,0)
 ..S PSOARENW=1 D DAOC^PSONEW K PSOARENW
"RTN","PSORENW4",109,0)
 K ZRXN,RXN,RXN1,^TMP("PSORXN",$J),^TMP("PSODAOC",$J)
"RTN","PSORENW4",110,0)
 Q
"RTN","PSORENW4",111,0)
INIT ;
"RTN","PSORENW4",112,0)
 D ASK Q:PSORENW("DFLG")
"RTN","PSORENW4",113,0)
 D NOORE^PSONEW(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",114,0)
 Q
"RTN","PSORENW4",115,0)
ASK ;upfront questions
"RTN","PSORENW4",116,0)
 W !! D ISSDT^PSODIR2(.PSORENW) Q:PSORENW("DFLG")  S PSORENW("ISSUE DATE")=PSOID
"RTN","PSORENW4",117,0)
 D FILLDT^PSODIR2(.PSORENW) K PSONEW("DAYS SUPPLY"),PSONEW("# OF REFILLS") Q:PSORENW("DFLG")
"RTN","PSORENW4",118,0)
 S PSORNW("FILL DATE")=PSORENW("FILL DATE")
"RTN","PSORENW4",119,0)
 D MW^PSODIR2(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",120,0)
 D PTSTAT^PSODIR1(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",121,0)
 D DAYS^PSODIR1(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",122,0)
 S PSODRUG("DEA")=0 D REFILL^PSODIR1(.PSORENW) K PSODRUG("DEA") Q:PSORENW("DFLG")
"RTN","PSORENW4",123,0)
 K DIR,DIRUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Do you want to edit Renewed Rx(s) QTY " D ^DIR I $D(DIRUT) S PSORENW("DFLG")=1 K DIR,DIRUT Q
"RTN","PSORENW4",124,0)
 S PSOQTY=Y K DIR,DIRUT,Y
"RTN","PSORENW4",125,0)
 D CLINIC^PSODIR2(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",126,0)
 D PROV^PSODIR(.PSORENW) S:PSORENW("DFLG") PSORENW("DFLG")=0
"RTN","PSORENW4",127,0)
 Q
"RTN","PSORENW4",128,0)
 ;
"RTN","PSORENW4",129,0)
POZ ;
"RTN","PSORENW4",130,0)
 K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DTOUT
"RTN","PSORENW4",131,0)
 Q
"RTN","PSOSIGDS")
0^12^B46733813^B46304418
"RTN","PSOSIGDS",1,0)
PSOSIGDS ;BIR/RTR-Utility to calculate Days Supply ;6/04/00
"RTN","PSOSIGDS",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,222,391,282,444**;DEC 1997;Build 34
"RTN","PSOSIGDS",3,0)
 ;External reference to PS(51 supported by DBIA 2224
"RTN","PSOSIGDS",4,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOSIGDS",5,0)
 ;External reference to PS(55 supported by DBIA 2228
"RTN","PSOSIGDS",6,0)
 ;External reference to PSDRUG( supported by DBIA 221
"RTN","PSOSIGDS",7,0)
 ;External reference to YSCL(603.01 supported by DBIA 2697
"RTN","PSOSIGDS",8,0)
 ;External reference to PSNDF(50.68 supported by DBIA 3735
"RTN","PSOSIGDS",9,0)
 ;External reference $$MXDAYSUP^PSSUTIL1 supported by DBIA 6229
"RTN","PSOSIGDS",10,0)
 ;
"RTN","PSOSIGDS",11,0)
EN(PSOSIGX) ;
"RTN","PSOSIGDS",12,0)
 N VARIABLE
"RTN","PSOSIGDS",13,0)
 Q
"RTN","PSOSIGDS",14,0)
SCH ;*282 Centralized Call
"RTN","PSOSIGDS",15,0)
 D SCH^PSOSIG
"RTN","PSOSIGDS",16,0)
 Q
"RTN","PSOSIGDS",17,0)
QTY(PSOQX) ;
"RTN","PSOSIGDS",18,0)
 Q
"RTN","PSOSIGDS",19,0)
QTYOPS ;
"RTN","PSOSIGDS",20,0)
 N QDOSE
"RTN","PSOSIGDS",21,0)
QTYCP ;CPRS days supply call comes through here
"RTN","PSOSIGDS",22,0)
 N PSOZMIN,PSQQUIT,QTSH,PSQ,PSQMIN,PSQMINZ,PSOQRND,PSOLOWER,PSOLOWX,PSOLOWXL,PSOLOWST
"RTN","PSOSIGDS",23,0)
 K PSOFRQ S PSQQUIT=0
"RTN","PSOSIGDS",24,0)
 I '$G(PSOCPRQT) S QDOSE=0 F PSQ=0:0 S PSQ=$O(PSOQX("DOSE",PSQ)) Q:'PSQ  S QDOSE=PSQ S:'$G(PSOQX("DOSE ORDERED",PSQ)) PSQQUIT=1
"RTN","PSOSIGDS",25,0)
 ;Q:PSQQUIT!('QDOSE)
"RTN","PSOSIGDS",26,0)
 I '$G(PSOCPRQT) Q:PSQQUIT
"RTN","PSOSIGDS",27,0)
 Q:'$G(QDOSE)
"RTN","PSOSIGDS",28,0)
 G:QDOSE>1 COMP
"RTN","PSOSIGDS",29,0)
 Q:'$G(PSOQX("DOSE ORDERED",1))
"RTN","PSOSIGDS",30,0)
 S PSOLOWER=0
"RTN","PSOSIGDS",31,0)
 I $G(PSOQX("DURATION",1)) D
"RTN","PSOSIGDS",32,0)
 .S PSOLOWX=$L(PSOQX("DURATION",1))
"RTN","PSOSIGDS",33,0)
 .S PSOLOWXL=$S($E(PSOQX("DURATION",1),PSOLOWX)="M":1,$E(PSOQX("DURATION",1),PSOLOWX)="H":60,$E(PSOQX("DURATION",1),PSOLOWX)="S":.01666,$E(PSOQX("DURATION",1),PSOLOWX)="W":10080,$E(PSOQX("DURATION",1),PSOLOWX)="L":43200,1:1440)
"RTN","PSOSIGDS",34,0)
 .S PSOLOWER=PSOLOWXL*(+$G(PSOQX("DURATION",1)))
"RTN","PSOSIGDS",35,0)
 S QTSH=$G(PSOQX("SCHEDULE",1)) D QTS Q:PSQQUIT!('$G(PSOFRQ))
"RTN","PSOSIGDS",36,0)
 S PSQMIN=$S($G(PSOLOWER):$G(PSOLOWER),1:0) ; PSQMIN=Minutes based in duration, or 0 if no duration
"RTN","PSOSIGDS",37,0)
 ;If Duration, determine using QTY how many days, regardless of duration, then use what is lower, that # of days or the duration, ROund that up, and check against Rx patient status
"RTN","PSOSIGDS",38,0)
 ;if no duration, just figure out using QTY # of days, then compare that against Rx patient status
"RTN","PSOSIGDS",39,0)
 S PSOZMIN=0
"RTN","PSOSIGDS",40,0)
 S PSOZMIN=PSOQX("QTY")/PSOQX("DOSE ORDERED",1)
"RTN","PSOSIGDS",41,0)
 S PSOZMIN=PSOZMIN*PSOFRQ
"RTN","PSOSIGDS",42,0)
 I $G(PSOLOWER) S PSOZMIN=$S(PSOLOWER<PSOZMIN:PSOLOWER,1:PSOZMIN)
"RTN","PSOSIGDS",43,0)
 S PSOZMIN=PSOZMIN/1440
"RTN","PSOSIGDS",44,0)
 D ROUND G QEND
"RTN","PSOSIGDS",45,0)
 Q
"RTN","PSOSIGDS",46,0)
COMP ;COMPLEX DOSE HERE
"RTN","PSOSIGDS",47,0)
 N PSQMNL,PSQMNLX,PSODUTOT,PSOLEFT,PSOZMIN,PSODUPTT,PSODUDIF,PSODUMIS,PSODUREP,PSQ1,PSODUX,PSODUXX,PSODSMIN,PSOFRQZ,PSOQUTOT
"RTN","PSOSIGDS",48,0)
 N PSOQLD,PSOQLDA,PSOQLDT,PSOQLDX
"RTN","PSOSIGDS",49,0)
 ;PSODUTOT = TOTAL OF ALL DURATIONS
"RTN","PSOSIGDS",50,0)
 ;PSODUPTT = TOTAL OF DISPENSE UNITS PER DOSE
"RTN","PSOSIGDS",51,0)
 ;PSODUDIF = DIFF. OF DURATION VS DAYS SUPPLY
"RTN","PSOSIGDS",52,0)
 ;PSOQUTOT=QTY
"RTN","PSOSIGDS",53,0)
 ;PSODUMIS = # OF SEQUENCES MISSING A DURATION IF >1 CAN'T DEFAULT
"RTN","PSOSIGDS",54,0)
 ;PSODUREP = SEQUENCE # THAT IS MISSING DURATION
"RTN","PSOSIGDS",55,0)
 ;PSODSMIN = MINUTES OF DAYS SUPPLY
"RTN","PSOSIGDS",56,0)
 S (PSODUTOT,PSODUDIF,PSODUMIS,PSODUREP,PSODSMIN,PSOQLDA,PSOQLDT,PSOQLDX)=0
"RTN","PSOSIGDS",57,0)
 ;next lines, add complex dose days supply calculation with ANDs
"RTN","PSOSIGDS",58,0)
 F PSOQLD=1:1:QDOSE S:$G(PSOQX("CONJUNCTION",PSOQLD))["A" PSOQLDA=1 S:$G(PSOQX("CONJUNCTION",PSOQLD))["T" PSOQLDT=1 S:$G(PSOQX("CONJUNCTION",PSOQLD))["X" PSOQLDX=1
"RTN","PSOSIGDS",59,0)
 I $G(PSOQLDA)!($G(PSOQLDX)) G QEND
"RTN","PSOSIGDS",60,0)
 S PSOQUTOT=+$G(PSOQX("QTY"))
"RTN","PSOSIGDS",61,0)
 F PSQ1=1:1:QDOSE D  Q:PSODUMIS>1
"RTN","PSOSIGDS",62,0)
 .I '$G(PSOQX("DURATION",PSQ1)) S PSODUMIS=PSODUMIS+1,PSODUREP=PSQ1 Q
"RTN","PSOSIGDS",63,0)
 G:PSODUMIS>1 QEND ; More than 1 sequence missing a duration
"RTN","PSOSIGDS",64,0)
 F PSQ=1:1:QDOSE D  Q:$G(PSQQUIT)
"RTN","PSOSIGDS",65,0)
 .I '$G(PSOQX("DOSE ORDERED",PSQ))!($G(PSOQX("SCHEDULE",PSQ))="") S PSQQUIT=1 Q
"RTN","PSOSIGDS",66,0)
 .S QTSH=$G(PSOQX("SCHEDULE",PSQ)) D QTS S:'$G(PSOFRQ) PSQQUIT=1 Q:$G(PSQQUIT)
"RTN","PSOSIGDS",67,0)
 .I $G(PSOQX("DURATION",PSQ)) S PSQMNL=$L(PSOQX("DURATION",PSQ)) D
"RTN","PSOSIGDS",68,0)
 ..S PSQMNLX=$S($E(PSOQX("DURATION",PSQ),PSQMNL)="M":1,$E(PSOQX("DURATION",PSQ),PSQMNL)="H":60,$E(PSOQX("DURATION",PSQ),PSQMNL)="S":.01666,$E(PSOQX("DURATION",PSQ),PSQMNL)="W":10080,$E(PSOQX("DURATION",PSQ),PSQMNL)="L":43200,1:1440)
"RTN","PSOSIGDS",69,0)
 ..S PSQMIN=PSQMNLX*(+$G(PSOQX("DURATION",PSQ)))
"RTN","PSOSIGDS",70,0)
 ..S PSODUTOT=PSODUTOT+(PSQMNLX*(+$G(PSOQX("DURATION",PSQ))))
"RTN","PSOSIGDS",71,0)
 .I '$G(PSOQX("DURATION",PSQ)) S PSOFRQZ=PSOFRQ Q
"RTN","PSOSIGDS",72,0)
 .S PSQMINZ=PSQMIN/PSOFRQ
"RTN","PSOSIGDS",73,0)
 .S PSODUPTT=$S($G(PSODUPTT):$G(PSODUPTT),1:0)+(PSQMINZ*+$G(PSOQX("DOSE ORDERED",PSQ)))
"RTN","PSOSIGDS",74,0)
 I $G(PSQQUIT) G QEND
"RTN","PSOSIGDS",75,0)
 I $G(PSOQUTOT)<0 G QEND
"RTN","PSOSIGDS",76,0)
 I '$G(PSODUMIS),$G(PSODUPTT)>$G(PSOQUTOT) G QEND
"RTN","PSOSIGDS",77,0)
 I '$G(PSODUMIS) S PSOZMIN=+$G(PSODUTOT)/1440 D ROUND G QEND
"RTN","PSOSIGDS",78,0)
 I PSODUPTT'<PSOQUTOT!('$G(PSOFRQZ)) G QEND
"RTN","PSOSIGDS",79,0)
 S PSODUPTT=PSOQUTOT-PSODUPTT S PSOLEFT=(PSODUPTT/+$G(PSOQX("DOSE ORDERED",PSODUREP)))*(+$G(PSOFRQZ))
"RTN","PSOSIGDS",80,0)
 S PSODUTOT=PSODUTOT+PSOLEFT S PSOZMIN=PSODUTOT/1440 D ROUND
"RTN","PSOSIGDS",81,0)
 G QEND
"RTN","PSOSIGDS",82,0)
QTS ;*282 Centralized Call
"RTN","PSOSIGDS",83,0)
 D QTS^PSOSIG
"RTN","PSOSIGDS",84,0)
 Q
"RTN","PSOSIGDS",85,0)
QEND ;
"RTN","PSOSIGDS",86,0)
 K PSOFRQ
"RTN","PSOSIGDS",87,0)
 Q
"RTN","PSOSIGDS",88,0)
ROUND ;
"RTN","PSOSIGDS",89,0)
 Q:'$G(PSOZMIN)
"RTN","PSOSIGDS",90,0)
 I PSOZMIN'["." S PSOQX("DAYS SUPPLY")=PSOZMIN G RXP
"RTN","PSOSIGDS",91,0)
 S PSOQX("DAYS SUPPLY")=$P(PSOZMIN,".")+1
"RTN","PSOSIGDS",92,0)
RXP ;Compare against Rx Patient Status
"RTN","PSOSIGDS",93,0)
 Q:'$G(PSOQX("PATIENT"))
"RTN","PSOSIGDS",94,0)
 N PSO55,PSO553
"RTN","PSOSIGDS",95,0)
 S PSO55=$P($G(^PS(55,PSOQX("PATIENT"),"PS")),"^") I 'PSO55 G CLOZ
"RTN","PSOSIGDS",96,0)
 S PSO553=$P($G(^PS(53,PSO55,0)),"^",3) I 'PSO553 G CLOZ
"RTN","PSOSIGDS",97,0)
 I PSO553<$G(PSOQX("DAYS SUPPLY")) S PSOQX("DAYS SUPPLY")=PSO553
"RTN","PSOSIGDS",98,0)
CLOZ ;check for clozapine
"RTN","PSOSIGDS",99,0)
 N PSOCLPAT,PSOCLMAX
"RTN","PSOSIGDS",100,0)
 Q:'$G(PSOQX("DRUG"))
"RTN","PSOSIGDS",101,0)
 I $P($G(^PSDRUG(PSOQX("DRUG"),"CLOZ1")),"^")="PSOCLO1" D
"RTN","PSOSIGDS",102,0)
 .S PSOCLPAT=$O(^YSCL(603.01,"C",PSOQX("PATIENT"),0)) Q:'PSOCLPAT
"RTN","PSOSIGDS",103,0)
 .S PSOCLPAT=$P($G(^YSCL(603.01,PSOCLPAT,0)),"^",3)
"RTN","PSOSIGDS",104,0)
 .S PSOCLMAX=$S(PSOCLPAT="M":28,PSOCLPAT="B":14,PSOCLPAT="W":7,1:0)
"RTN","PSOSIGDS",105,0)
 .I PSOCLMAX,PSOCLMAX<$G(PSOQX("DAYS SUPPLY")) S PSOQX("DAYS SUPPLY")=PSOCLMAX
"RTN","PSOSIGDS",106,0)
 Q
"RTN","PSOSIGDS",107,0)
DAY(DATE) ;First 5 digits of FileMan date
"RTN","PSOSIGDS",108,0)
 N X
"RTN","PSOSIGDS",109,0)
 I DATE'?5N Q -1
"RTN","PSOSIGDS",110,0)
 S X=$E(DATE,4,5) I X<1!(X>12) Q -1
"RTN","PSOSIGDS",111,0)
 S X=DATE+1+(X=12*88)_"01"
"RTN","PSOSIGDS",112,0)
 Q $E($$FMADD^XLFDT(X,-1),6,7)
"RTN","PSOSIGDS",113,0)
 ;
"RTN","PSOSIGDS",114,0)
QTYX(PSOQX) ;
"RTN","PSOSIGDS",115,0)
 N PSOQLP,PSOQLN,PSOQAR,PSOCPRQT,QDOSE,QDOSEX S PSOCPRQT=1 F PSOQLP=0:0 S PSOQLP=$O(PSOQX("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIGDS",116,0)
 .S PSOQAR("DURATION",PSOQLP)=$G(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIGDS",117,0)
 .I $E(PSOQX("DURATION",PSOQLP))?1A S PSOQLN=$L(PSOQX("DURATION",PSOQLP)) S PSOQX("DURATION",PSOQLP)=$E(PSOQX("DURATION",PSOQLP),2,PSOQLN)_$E(PSOQX("DURATION",PSOQLP))
"RTN","PSOSIGDS",118,0)
 S QDOSE=0 F QDOSEX=0:0 S QDOSEX=$O(PSOQX("DOSE ORDERED",QDOSEX)) Q:'QDOSEX  S QDOSE=QDOSE+1
"RTN","PSOSIGDS",119,0)
 D QTYCP
"RTN","PSOSIGDS",120,0)
 F PSOQLP=0:0 S PSOQLP=$O(PSOQAR("DURATION",PSOQLP)) Q:'PSOQLP  D
"RTN","PSOSIGDS",121,0)
 .S PSOQX("DURATION",PSOQLP)=$G(PSOQAR("DURATION",PSOQLP))
"RTN","PSOSIGDS",122,0)
 K PSOCPRQT
"RTN","PSOSIGDS",123,0)
 Q
"RTN","PSOSIGDS",124,0)
DSUP(PSOQX) ;Default Days Supply for CPRS, without QTY (just patient and drug)
"RTN","PSOSIGDS",125,0)
 ;Should we add to accept # of refills?
"RTN","PSOSIGDS",126,0)
 ;If no Drug, should we base on Orderable Item
"RTN","PSOSIGDS",127,0)
 N CS,DR,OI,MXDS,DRMXDS S CS=0,MXDS=90,DR=$G(PSOQX("DRUG"))
"RTN","PSOSIGDS",128,0)
 I DR S CS=$$CSDS(DR),MXDS=$$MXDAYSUP^PSSUTIL1(DR)
"RTN","PSOSIGDS",129,0)
 I 'DR S OI=$G(PSOQX("OI")) D:OI
"RTN","PSOSIGDS",130,0)
 .N IDT,PAC S DR=0 F  S DR=$O(^PSDRUG("ASP",OI,DR)) Q:'DR   D
"RTN","PSOSIGDS",131,0)
 ..S DRMXDS=$$MXDAYSUP^PSSUTIL1(DR) I DRMXDS>MXDS S MXDS=DRMXDS
"RTN","PSOSIGDS",132,0)
 ..I CS Q
"RTN","PSOSIGDS",133,0)
 ..S IDT=$P($G(^PSDRUG(DR,"I")),"^"),PAC=$P($G(^(2)),"^",3)
"RTN","PSOSIGDS",134,0)
 ..I IDT,IDT<DT Q
"RTN","PSOSIGDS",135,0)
 ..I PAC'["O" Q
"RTN","PSOSIGDS",136,0)
 ..S CS=$$CSDS(DR)
"RTN","PSOSIGDS",137,0)
 S PSOQX("DAYS SUPPLY")=$S(CS:30,1:90)
"RTN","PSOSIGDS",138,0)
 I PSOQX("DAYS SUPPLY")>MXDS S PSOQX("DAYS SUPPLY")=MXDS
"RTN","PSOSIGDS",139,0)
 Q:'$G(PSOQX("PATIENT"))
"RTN","PSOSIGDS",140,0)
 N PSO55,PSO553
"RTN","PSOSIGDS",141,0)
 S PSO55=$P($G(^PS(55,PSOQX("PATIENT"),"PS")),"^") I 'PSO55 G DSUPDG
"RTN","PSOSIGDS",142,0)
 S PSO553=$P($G(^PS(53,PSO55,0)),"^",3) I 'PSO553 G DSUPDG
"RTN","PSOSIGDS",143,0)
 I PSO553<$G(PSOQX("DAYS SUPPLY")) S PSOQX("DAYS SUPPLY")=PSO553
"RTN","PSOSIGDS",144,0)
DSUPDG ;
"RTN","PSOSIGDS",145,0)
 N PSOCLPAT,PSOCLMAX
"RTN","PSOSIGDS",146,0)
 Q:'DR
"RTN","PSOSIGDS",147,0)
 I $P($G(^PSDRUG(DR,"CLOZ1")),"^")="PSOCLO1" D
"RTN","PSOSIGDS",148,0)
 .S PSOCLPAT=$O(^YSCL(603.01,"C",PSOQX("PATIENT"),0)) Q:'PSOCLPAT
"RTN","PSOSIGDS",149,0)
 .S PSOCLPAT=$P($G(^YSCL(603.01,PSOCLPAT,0)),"^",3)
"RTN","PSOSIGDS",150,0)
 .S PSOCLMAX=$S(PSOCLPAT="M":28,PSOCLPAT="B":14,$P($G(^(0)),"^",3)="W":7,1:0)
"RTN","PSOSIGDS",151,0)
 .I PSOCLMAX,PSOCLMAX<$G(PSOQX("DAYS SUPPLY")) S PSOQX("DAYS SUPPLY")=PSOCLMAX
"RTN","PSOSIGDS",152,0)
 Q
"RTN","PSOSIGDS",153,0)
MAX(PSOQX) ;
"RTN","PSOSIGDS",154,0)
 G EN^PSOSIGMX
"RTN","PSOSIGDS",155,0)
 Q
"RTN","PSOSIGDS",156,0)
 ;
"RTN","PSOSIGDS",157,0)
CSDS(DR) ;
"RTN","PSOSIGDS",158,0)
 Q:'DR 0
"RTN","PSOSIGDS",159,0)
 I $P($G(^PSDRUG(DR,"ND")),"^",3) S CS=+$P($G(^PSNDF(50.68,$P(^("ND"),"^",3),7)),"^")
"RTN","PSOSIGDS",160,0)
 E  S CS=$P($G(^PSDRUG(DR,0)),"^",3),CS=$S(CS[1:1,CS[2:2,CS[3:3,CS[4:4,CS[5:5,1:0)
"RTN","PSOSIGDS",161,0)
 I CS=1!(CS=2)!(CS=3)!(CS=4)!(CS=5) Q 1
"RTN","PSOSIGDS",162,0)
 Q 0
"RTN","PSOSIGMX")
0^13^B9129541^B14811697
"RTN","PSOSIGMX",1,0)
PSOSIGMX ;BIR/RTR-Utility routine to calculate Max Refills for CPRS ; 7/25/07 11:17am
"RTN","PSOSIGMX",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,78,108,131,222,206,444**;DEC 1997;Build 34
"RTN","PSOSIGMX",3,0)
 ;External reference to PS(55 supported by DBIA 2228
"RTN","PSOSIGMX",4,0)
 ;External reference to PSDRUG( supported by DBIA 221
"RTN","PSOSIGMX",5,0)
 ;External reference to YSCL(603.01 supported by DBIA 2697
"RTN","PSOSIGMX",6,0)
 ;External reference to PS(50.7 supported by DBIA 2223
"RTN","PSOSIGMX",7,0)
 ;
"RTN","PSOSIGMX",8,0)
 ;PSOQX("PATIENT")=patient DFN
"RTN","PSOSIGMX",9,0)
 ;PSOQX("DAYS SUPPLY")=Days Supply ->Optional ??
"RTN","PSOSIGMX",10,0)
 ;PSOQX("DRUG")=File 50 ien ->Optional
"RTN","PSOSIGMX",11,0)
 ;PSOQX("ITEM")=File 50.7 ien -> we may not use this
"RTN","PSOSIGMX",12,0)
 ;PSOQX("DISCHARGE")=1 if the order is for a Discharge
"RTN","PSOSIGMX",13,0)
 ;
"RTN","PSOSIGMX",14,0)
 ;PSOQX("MAX")=Returned max refills allowed
"RTN","PSOSIGMX",15,0)
 ;
"RTN","PSOSIGMX",16,0)
EN ;
"RTN","PSOSIGMX",17,0)
 S PSOQX("MAX")=11
"RTN","PSOSIGMX",18,0)
 N DFN,VAROOT,PSOWRF,PSOMXAUT,PSOMXAUX,PSOCDEA,PSOCSX,PSOMXRX,PSOMX1,PSODYX,PSODYX1,PSOMXPAT,PSOMXSTA,MXRFLS
"RTN","PSOSIGMX",19,0)
 S PSOMXAUT=0
"RTN","PSOSIGMX",20,0)
 S PSOMXAUX=+$P($G(^PS(55,+$G(PSOQX("PATIENT")),"PS")),"^")
"RTN","PSOSIGMX",21,0)
 I PSOMXAUX,$P($G(^PS(53,+$G(PSOMXAUX),0)),"^")["AUTH ABS" S VAROOT="PSOWRF",DFN=$G(PSOQX("PATIENT")) D IN5^VADPT I '$G(PSOWRF(5)) S PSOMXAUT=1
"RTN","PSOSIGMX",22,0)
 S PSOMXSTA=$S($G(PSOQX("DISCHARGE")):0,$G(PSOMXAUT):0,1:+$P($G(^PS(55,+$G(PSOQX("PATIENT")),"PS")),"^")) I PSOMXSTA S PSOMXRX=$P($G(^PS(53,PSOMXSTA,0)),"^",4)
"RTN","PSOSIGMX",23,0)
 I 'PSOMXSTA S PSOMXRX=11
"RTN","PSOSIGMX",24,0)
 K PSOCDEA S PSOCSX=0
"RTN","PSOSIGMX",25,0)
 S PSONODD=0 I '$G(PSOQX("DRUG")),$G(PSOQX("ITEM")) D  S PSONODD=1
"RTN","PSOSIGMX",26,0)
 . N A,B,PSOCDEA,DEA,PSOAPP,PSOINA,%,%H,%I,X,PSOFIRST
"RTN","PSOSIGMX",27,0)
 . S DEA=99,(A,PSOFIRST)=""
"RTN","PSOSIGMX",28,0)
 . F  S A=$O(^PS(50.7,"A50",PSOQX("ITEM"),A)) Q:'A  D
"RTN","PSOSIGMX",29,0)
 .. S PSOCDEA=$P($G(^PSDRUG(A,0)),"^",3),PSOAPP=$P($G(^(2)),"^",3),PSOINA=$G(^("I"))
"RTN","PSOSIGMX",30,0)
 .. I PSOAPP'["O" Q
"RTN","PSOSIGMX",31,0)
 .. D NOW^%DTC I PSOINA]"",PSOINA'>% Q
"RTN","PSOSIGMX",32,0)
 .. I PSOFIRST="" S PSOFIRST=A
"RTN","PSOSIGMX",33,0)
 .. I PSOCDEA?1N.E,PSOCDEA<DEA S DEA=PSOCDEA,PSOQX("DRUG")=A
"RTN","PSOSIGMX",34,0)
 . I $G(PSOQX("DRUG"))="" S PSOQX("DRUG")=PSOFIRST
"RTN","PSOSIGMX",35,0)
 I $G(PSOQX("DRUG")) D
"RTN","PSOSIGMX",36,0)
 .S PSOCDEA=$P($G(^PSDRUG(PSOQX("DRUG"),0)),"^",3)
"RTN","PSOSIGMX",37,0)
 .I PSOCDEA["2"!(PSOCDEA["3")!(PSOCDEA["4")!(PSOCDEA["5") S PSOCSX=1
"RTN","PSOSIGMX",38,0)
 ;
"RTN","PSOSIGMX",39,0)
 S PSOQX("MAX")=$$MAXNUMRF^PSOUTIL($G(PSOQX("DRUG")),$G(PSOQX("DAYS SUPPLY")),PSOMXAUX,.CLOZPAT)
"RTN","PSOSIGMX",40,0)
 ;
"RTN","PSOSIGMX",41,0)
 I $P($G(^PSDRUG(+$G(PSOQX("DRUG")),"CLOZ1")),"^")="PSOCLO1" D  Q
"RTN","PSOSIGMX",42,0)
 .S PSOMXPAT=$O(^YSCL(603.01,"C",+$G(PSOQX("PATIENT")),0)) I 'PSOMXPAT S PSOQX("MAX")=0 Q
"RTN","PSOSIGMX",43,0)
 .S PSOMXPAT=$P($G(^YSCL(603.01,PSOMXPAT,0)),"^",3)
"RTN","PSOSIGMX",44,0)
 .I $D(PSOQX("DAYS SUPPLY")) S PSOQX("MAX")=$S(PSOMXPAT="M"&($G(PSOQX("DAYS SUPPLY"))<8):3,PSOMXPAT="M"&($G(PSOQX("DAYS SUPPLY"))<15):1,PSOMXPAT="B"&($G(PSOQX("DAYS SUPPLY"))<8):1,1:0) Q
"RTN","PSOSIGMX",45,0)
 .S PSOQX("MAX")=$S(PSOMXPAT="M":3,PSOMXPAT="B":1,1:0)
"RTN","PSOSIGMX",46,0)
 I $G(PSOQX("DRUG")) I PSOCDEA["A"&(PSOCDEA'["B")!(PSOCDEA["F")!(PSOCDEA[1)!(PSOCDEA[2) S PSOQX("MAX")=0
"RTN","PSOSIGMX",47,0)
 I PSONODD S PSOQX("DRUG")=0
"RTN","PSOSIGMX",48,0)
 Q
"RTN","PSOUTIL")
0^20^B95292700^B67041213
"RTN","PSOUTIL",1,0)
PSOUTIL ;IHS/DSD/JCM - outpatient pharmacy utility routine ;12/28/15 4:01pm
"RTN","PSOUTIL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**64,456,444**;DEC 1997;Build 34
"RTN","PSOUTIL",3,0)
 ;External reference $$MXDAYSUP^PSSUTIL1 supported by DBIA 6229
"RTN","PSOUTIL",4,0)
 ;
"RTN","PSOUTIL",5,0)
 W !!,$C(7),"This routine not callable from PSOUTIL.."
"RTN","PSOUTIL",6,0)
 Q
"RTN","PSOUTIL",7,0)
 ;
"RTN","PSOUTIL",8,0)
NPSOSD(PSORX) ; Entry point to add newly added rx to patients PSOSD array
"RTN","PSOUTIL",9,0)
 S STA="ACTIVE^NON-VERIFIED^R^HOLD^NON-VERIFIED^ACTIVE^^^^^^ACTIVE^DISCONTINUE^^DISCONTINUE^DISCONTINUE^HOLD"
"RTN","PSOUTIL",10,0)
 S STAT=$P(STA,"^",$P(^PSRX(PSORX("IRXN"),"STA"),"^")+1)
"RTN","PSOUTIL",11,0)
 I $D(PSOSD(STAT,PSODRUG("NAME"))),$P(PSOSD(STAT,PSODRUG("NAME")),"^",2)<10 D
"RTN","PSOUTIL",12,0)
 . S PSOSD(STAT,PSODRUG("NAME")_"^"_PSORX("IRXN"))=PSORX("IRXN")_"^"_$P($G(^PSRX(PSORX("IRXN"),"STA")),"^")_"^^^"_PSODRUG("VA CLASS")_"^"_$P(^PSRX(PSORX("IRXN"),0),"^",9)_"^"_PSODRUG("NDF")_"^"_$P(^PSRX(PSORX("IRXN"),0),"^",8)_"^1"
"RTN","PSOUTIL",13,0)
 E  S PSOSD(STAT,PSODRUG("NAME"))=PSORX("IRXN")_"^"_$P($G(^PSRX(PSORX("IRXN"),"STA")),"^")_"^^^"_PSODRUG("VA CLASS")_"^"_$P(^PSRX(PSORX("IRXN"),0),"^",9)_"^"_PSODRUG("NDF")_"^"_$P(^PSRX(PSORX("IRXN"),0),"^",8)_"^1"
"RTN","PSOUTIL",14,0)
 S PSOSD=$S($G(PSOSD)]"":PSOSD+1,1:1),^TMP("PS",$J,STAT,PSODRUG("NAME"))=1
"RTN","PSOUTIL",15,0)
 Q
"RTN","PSOUTIL",16,0)
 ;
"RTN","PSOUTIL",17,0)
RNPSOSD ;update PSOSD array for renewals
"RTN","PSOUTIL",18,0)
 S STA="ACTIVE^NON-VERIFIED^R^HOLD^NON-VERIFIED^ACTIVE^^^^^^ACTIVE^DISCONTINUE^^DISCONTINUE^DISCONTINUE^HOLD"
"RTN","PSOUTIL",19,0)
 S STAT=$P(STA,"^",$P(^PSRX(PSORENW("OIRXN"),"STA"),"^")+1)
"RTN","PSOUTIL",20,0)
 I $D(PSOSD(STAT,PSODRUG("NAME")_"^"_PSORENW("OIRXN"))) D
"RTN","PSOUTIL",21,0)
 . S PSOSD(STAT,PSODRUG("NAME")_"^"_PSORENW("IRXN"))=PSOSD(STAT,PSODRUG("NAME")_"^"_PSORENW("OIRXN")),$P(PSOSD(STAT,PSODRUG("NAME")_"^"_PSORENW("IRXN")),"^",2)=$P($G(^PSRX(PSORENW("IRXN"),"STA")),"^")
"RTN","PSOUTIL",22,0)
 . S $P(PSOSD(STAT,PSODRUG("NAME")_"^"_PSORENW("IRXN")),"^",6)=$P(^PSRX(PSORENW("IRXN"),0),"^",9)
"RTN","PSOUTIL",23,0)
 . K PSOSD(STAT,PSODRUG("NAME")_"^"_PSORENW("OIRXN")) Q
"RTN","PSOUTIL",24,0)
 E  D
"RTN","PSOUTIL",25,0)
 .S $P(PSOSD(STAT,PSODRUG("NAME")),"^")=PSORENW("IRXN"),$P(PSOSD(STAT,PSODRUG("NAME")),"^",2)=$P($G(^PSRX(PSORENW("IRXN"),"STA")),"^")
"RTN","PSOUTIL",26,0)
 .S $P(PSOSD(STAT,PSODRUG("NAME")),"^",6)=$P(^PSRX(PSORENW("IRXN"),0),"^",9)
"RTN","PSOUTIL",27,0)
 .S ^TMP("PS",$J,STAT,PSODRUG("NAME"))=1
"RTN","PSOUTIL",28,0)
 Q
"RTN","PSOUTIL",29,0)
 ;
"RTN","PSOUTIL",30,0)
PROV(PSORENW) ;called from psoornew
"RTN","PSOUTIL",31,0)
CHKPRV ;check inactive providers and cosinging providers called from PSORENW (renew rx)
"RTN","PSOUTIL",32,0)
 N OK
"RTN","PSOUTIL",33,0)
 I '$D(^VA(200,PSORENW("PROVIDER"),0)) D  I 'OK G:PSORENW("DFLG") CHKPRVX
"RTN","PSOUTIL",34,0)
 .W !,$C(7),"Provider not in New Person File .. You must select a new provider"
"RTN","PSOUTIL",35,0)
 .S PSODIR("FIELD")=0 K PSORENW("PROVIDER") D PROV^PSODIR(.PSORENW)
"RTN","PSOUTIL",36,0)
 .S:$G(PSORENW("PROVIDER"))']"" PSORENW("DFLG")=1
"RTN","PSOUTIL",37,0)
 ;
"RTN","PSOUTIL",38,0)
 I '$G(^VA(200,PSORENW("PROVIDER"),"PS")) D   G:PSORENW("DFLG") CHKPRVX
"RTN","PSOUTIL",39,0)
 .I $$ISSPLY(),$D(^XUSEC("ORSUPPLY",PSORENW("PROVIDER"))) S OK=1 Q
"RTN","PSOUTIL",40,0)
 .S OK=0 W !,$C(7),$P(^VA(200,PSORENW("PROVIDER"),0),"^")_" is not a Valid provider .. You must select a new provider"
"RTN","PSOUTIL",41,0)
 .S PSODIR("FIELD")=0 K PSORENW("PROVIDER") D PROV^PSODIR(.PSORENW)
"RTN","PSOUTIL",42,0)
 .S:$G(PSORENW("PROVIDER"))']"" PSORENW("DFLG")=1
"RTN","PSOUTIL",43,0)
 ;
"RTN","PSOUTIL",44,0)
 K PSOX S PSOX=$P($G(^VA(200,PSORENW("PROVIDER"),"PS")),"^",4)
"RTN","PSOUTIL",45,0)
 I PSOX,PSOX<DT D   G:PSORENW("DFLG") CHKPRVX
"RTN","PSOUTIL",46,0)
 .W !,$C(7),$P(^VA(200,PSORENW("PROVIDER"),0),"^")_" is inactive as a provider .. You must select a new provider"
"RTN","PSOUTIL",47,0)
 .S PSODIR("FIELD")=0 K PSORENW("PROVIDER") D PROV^PSODIR(.PSORENW)
"RTN","PSOUTIL",48,0)
 .I $G(PSORENW("PROVIDER"))']"" S PSORENW("DFLG")=1
"RTN","PSOUTIL",49,0)
 ;
"RTN","PSOUTIL",50,0)
 I '$D(PSORENW("COSIGNING PROVIDER")),$D(PSORENW("COSIGNER")) K PSOX S PSOX=$P(^VA(200,PSORENW("COSIGNER"),"PS"),"^",4) I PSOX,PSOX<DT D
"RTN","PSOUTIL",51,0)
 .W !,$C(7),"Inactive Cosigning Provider .. You must select a new cosigner"
"RTN","PSOUTIL",52,0)
 .S PSODIR("FIELD")=0,PSODIR("PROVIDER")=$S($D(PSORENW("PROVIDER")):PSORENW("PROVIDER"),1:PSORENW("PROVIDER"))
"RTN","PSOUTIL",53,0)
 .D COSIGN^PSODIR I '$D(PSODIR("COSIGNING PROVIDER")) S PSORENW("DFLG")=1
"RTN","PSOUTIL",54,0)
 .S PSORENW("COSIGNING PROVIDER")=PSODIR("COSIGNING PROVIDER")
"RTN","PSOUTIL",55,0)
 ;
"RTN","PSOUTIL",56,0)
CHKPRVX K PSODIR,PSOX
"RTN","PSOUTIL",57,0)
 Q
"RTN","PSOUTIL",58,0)
 ;
"RTN","PSOUTIL",59,0)
NEXT(PSOX) ;
"RTN","PSOUTIL",60,0)
 S PSOX("RX0")=^PSRX(PSOX("IRXN"),0)
"RTN","PSOUTIL",61,0)
 S PSOX("RX2")=^PSRX(PSOX("IRXN"),2)
"RTN","PSOUTIL",62,0)
 S PSOX("RX3")=^PSRX(PSOX("IRXN"),3)
"RTN","PSOUTIL",63,0)
 S PSOX1=$P(PSOX("RX2"),"^",2)
"RTN","PSOUTIL",64,0)
 I '$O(^PSRX(PSOX("IRXN"),1,0)) D  G NEXTX
"RTN","PSOUTIL",65,0)
 . S $P(PSOX("RX3"),"^")=PSOX1,X1=PSOX1
"RTN","PSOUTIL",66,0)
 . S X2=$P(PSOX("RX0"),"^",8)-10\1
"RTN","PSOUTIL",67,0)
 . D C^%DTC
"RTN","PSOUTIL",68,0)
 . S:'$P(PSOX("RX3"),"^",8) $P(PSOX("RX3"),"^",2)=X
"RTN","PSOUTIL",69,0)
 . K X Q
"RTN","PSOUTIL",70,0)
 ;
"RTN","PSOUTIL",71,0)
 S PSOY2=0
"RTN","PSOUTIL",72,0)
 F PSOY=0:0 S PSOY=$O(^PSRX(PSOX("IRXN"),1,PSOY)) Q:'PSOY  S PSOY1=PSOY,PSOY2=PSOY2+1
"RTN","PSOUTIL",73,0)
 S PSOY=^PSRX(PSOX("IRXN"),1,PSOY1,0)
"RTN","PSOUTIL",74,0)
 S PSOX2=$P(PSOY,"^")
"RTN","PSOUTIL",75,0)
 S $P(PSOX("RX3"),"^")=PSOX2,X1=PSOX2
"RTN","PSOUTIL",76,0)
 S X2=$P(PSOX("RX0"),"^",8)-10\1
"RTN","PSOUTIL",77,0)
 D C^%DTC S PSOY3=X
"RTN","PSOUTIL",78,0)
 S X1=PSOX1,X2=(PSOY2+1)*$P(PSOX("RX0"),"^",8)-10\1
"RTN","PSOUTIL",79,0)
 D C^%DTC S PSOY4=X
"RTN","PSOUTIL",80,0)
 S $P(PSOX("RX3"),"^",2)=$S(PSOY3<PSOY4:PSOY4,1:PSOY3)
"RTN","PSOUTIL",81,0)
NEXTX ;
"RTN","PSOUTIL",82,0)
 K X,PSOX1,PSOX2,PSOY,PSOY1,PSOY2,PSOY3,PSOY4
"RTN","PSOUTIL",83,0)
 Q
"RTN","PSOUTIL",84,0)
 ;
"RTN","PSOUTIL",85,0)
SUSDATE(PSOX) ;
"RTN","PSOUTIL",86,0)
 S PSOX("OLD FILL DATE")=PSOX("FILL DATE")
"RTN","PSOUTIL",87,0)
 S PSORX("OLD FILL DATE")=PSORX("FILL DATE")
"RTN","PSOUTIL",88,0)
 S PSOX("FILL DATE")=$P(PSOX("RX3"),"^",2)
"RTN","PSOUTIL",89,0)
 I $O(^PS(52.5,"B",PSOX("IRXN"),0)),'$G(^PS(52.5,+$O(^PS(52.5,"B",PSOX("IRXN"),0)),"P")) S PSOX("FILL DATE")=$P(PSOX("RX3"),"^")
"RTN","PSOUTIL",90,0)
 S Y=PSOX("FILL DATE")
"RTN","PSOUTIL",91,0)
 X ^DD("DD") S PSORX("FILL DATE")=Y K Y
"RTN","PSOUTIL",92,0)
 Q
"RTN","PSOUTIL",93,0)
 ;
"RTN","PSOUTIL",94,0)
SUSDATEK(PSOX) ;
"RTN","PSOUTIL",95,0)
 S PSOX("FILL DATE")=PSOX("OLD FILL DATE")
"RTN","PSOUTIL",96,0)
 I $G(PSORX("OLD FILL DATE"))="",$G(PSORENW("OLD FILL DATE")) S Y=PSORENW("OLD FILL DATE") D DD^%DT S PSORX("OLD FILL DATE")=Y K Y
"RTN","PSOUTIL",97,0)
 S PSORX("FILL DATE")=PSORX("OLD FILL DATE")
"RTN","PSOUTIL",98,0)
 K PSOX("OLD FILL DATE"),PSORX("OLD FILL DATE")
"RTN","PSOUTIL",99,0)
 Q
"RTN","PSOUTIL",100,0)
 ;
"RTN","PSOUTIL",101,0)
STATUS(PSOREA,PSOSTAT) ;
"RTN","PSOUTIL",102,0)
 S DSMSG="Cannot "_$S($G(PSOOPT)=3:"renew",1:"refill")_" Rx. " S:$G(OR0) ACOM=DSMSG
"RTN","PSOUTIL",103,0)
 I PSOREA["A" W:$G(SPEED) ", Inactive Drug.",! D
"RTN","PSOUTIL",104,0)
 .S:$G(POERR)&('$G(SPEED)) VALMSG=DSMSG_"Inactive Drug.",VALMBCK="R" W:'$G(POERR) !," Inactive Drug"
"RTN","PSOUTIL",105,0)
 .S:$G(OR0) ACOM=ACOM_" Inactive Drug."
"RTN","PSOUTIL",106,0)
 I PSOREA["M" W:$G(SPEED) ", Drug no longer used by Outpatient.",! D
"RTN","PSOUTIL",107,0)
 .S:$G(POERR)&('$G(SPEED)) VALMSG=DSMSG_"Drug no longer used by Outpatient.",VALMBCK="R" W:'$G(POERR) !," Drug no longer used by Outpatient."
"RTN","PSOUTIL",108,0)
 .S:$G(OR0) ACOM=ACOM_" Drug no longer used by Outpatient."
"RTN","PSOUTIL",109,0)
 ;
"RTN","PSOUTIL",110,0)
 I PSOREA["B" W:$G(SPEED) ", Narcotic Drug." D
"RTN","PSOUTIL",111,0)
 .W:'$G(POERR) !,"Narcotic Drug" S:$G(POERR)&('$G(SPEED)) VALMSG=DSMSG_"Narcotic Drug.",VALMBCK="R"
"RTN","PSOUTIL",112,0)
 .S:$G(OR0) ACOM=ACOM_" Narcotic Drug."
"RTN","PSOUTIL",113,0)
 ;
"RTN","PSOUTIL",114,0)
 I PSOREA["C" W:$G(SPEED) ", Non-Renewable Drug." D
"RTN","PSOUTIL",115,0)
 .W:'$G(POERR) !,"Non-Renewable Drug" S:$G(POERR)&('$G(SPEED)) VALMSG=DSMSG_"Non-Renewable Drug.",VALMBCK="R"
"RTN","PSOUTIL",116,0)
 .S:$G(OR0) ACOM=ACOM_" Non-Renewable Drug."
"RTN","PSOUTIL",117,0)
 ;
"RTN","PSOUTIL",118,0)
 I PSOREA["D" W:$G(SPEED) ", Non-Renewable Patient Status." D
"RTN","PSOUTIL",119,0)
 .W:'$G(POERR) !,"Non-Renewable Patient Status" S:$G(POERR)&('$G(SPEED)) VALMSG=DSMSG_"Non-Renewable Patient Status.",VALMBCK="R"
"RTN","PSOUTIL",120,0)
 .S:$G(OR0) ACOM=ACOM_" Non-Renewable Patient Status."
"RTN","PSOUTIL",121,0)
 ;
"RTN","PSOUTIL",122,0)
 I PSOREA["E" W:$G(SPEED) ", Non-Verified Rx." D
"RTN","PSOUTIL",123,0)
 .W:'$G(POERR) !,"Non-Verified Rx" S:$G(POERR)&('$G(SPEED)) VALMSG=DSMSG_"Non-Verified Rx.",VALMBCK="R"
"RTN","PSOUTIL",124,0)
 .S:$G(OR0) ACOM=ACOM_" Non-Verified Rx."
"RTN","PSOUTIL",125,0)
 ;
"RTN","PSOUTIL",126,0)
 I PSOREA["F" W:$G(SPEED) ", Maximum of 26 Renewals." D
"RTN","PSOUTIL",127,0)
 .W:'$G(POERR) !,"Maximum of 26 Renewals" S:$G(POERR)&('$G(SPEED)) VALMSG=DSMSG_"Maximum of 26 Renewals.",VALMBCK="R"
"RTN","PSOUTIL",128,0)
 .S:$G(OR0) ACOM=ACOM_" Maximum of 26 Renewals."
"RTN","PSOUTIL",129,0)
 ;
"RTN","PSOUTIL",130,0)
 I PSOREA["G",PSOREA'["B" W:$G(SPEED) ", No more refills left." W:'$G(POERR) !,"No more refills left" S:$G(POERR)&('$G(SPEED)) VALMSG=DSMSG_"No more refills left.",VALMBCK="R"
"RTN","PSOUTIL",131,0)
 ;
"RTN","PSOUTIL",132,0)
 I PSOREA["Z" D
"RTN","PSOUTIL",133,0)
 . S:PSOSTAT=4 PSOSTAT=1
"RTN","PSOUTIL",134,0)
 . S PSOA=";"_PSOSTAT,PSOB=$P(^DD(52,100,0),"^",3),PSOA=$F(PSOB,PSOA),PSOA=$P($E(PSOB,PSOA,999),";",1)
"RTN","PSOUTIL",135,0)
 . W:$G(SPEED) ", Rx is in "_$P(PSOA,":",2)_" status."
"RTN","PSOUTIL",136,0)
 . W:'$G(POERR)&('$G(SPEED)) !,"Rx is in "_$P(PSOA,":",2)_" status"
"RTN","PSOUTIL",137,0)
 .S:$G(POERR)&($G(VALMSG)']"")&('$G(SPEED)) VALMSG=DSMSG_"Rx is in "_$P(PSOA,":",2)_" status.",VALMBCK="R"
"RTN","PSOUTIL",138,0)
 . K PSOA,PSOB
"RTN","PSOUTIL",139,0)
 . Q
"RTN","PSOUTIL",140,0)
 I $G(SPEED) K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIRUT,DUOUT,DTOUT,DIR
"RTN","PSOUTIL",141,0)
 Q
"RTN","PSOUTIL",142,0)
ACP I $P(^PSRX(PSOX("IRXN"),0),"^",11)="W",$G(^("IB")) S ^PSRX("ACP",$P(^PSRX(PSOX("IRXN"),0),"^",2),$P(^(2),"^",2),0,PSOX("IRXN"))=""
"RTN","PSOUTIL",143,0)
 Q
"RTN","PSOUTIL",144,0)
 ;
"RTN","PSOUTIL",145,0)
RENFDT(PSOX) ;gets the correct fill date
"RTN","PSOUTIL",146,0)
 S PSOX("OLD FILL DATE")=PSOX("FILL DATE")
"RTN","PSOUTIL",147,0)
 S PSORX("OLD FILL DATE")=PSORX("FILL DATE")
"RTN","PSOUTIL",148,0)
 S PSOX("FILL DATE")=$P(PSOX("RX3"),"^",2)
"RTN","PSOUTIL",149,0)
 N RXY,LBL,SUPN,LBP,RF,RFN,RFD
"RTN","PSOUTIL",150,0)
 S RXY=PSOX("IRXN"),RFN=0
"RTN","PSOUTIL",151,0)
 I '$O(^PSRX(RXY,1,0)) D GFDT G SDTX
"RTN","PSOUTIL",152,0)
 F RF=0:0 S RF=$O(^PSRX(RXY,1,RF)) Q:'RF  S RFN=RF
"RTN","PSOUTIL",153,0)
 S RF=^PSRX(RXY,1,RFN,0) D GFDT
"RTN","PSOUTIL",154,0)
 I PSOX("FILL DATE")<DT,PSOX("FILL DATE")<PSORNW("FILL DATE") S PSOX("FILL DATE")=DT
"RTN","PSOUTIL",155,0)
SDTX ;
"RTN","PSOUTIL",156,0)
 S Y=PSOX("FILL DATE")
"RTN","PSOUTIL",157,0)
 X ^DD("DD") S PSORX("FILL DATE")=Y K Y
"RTN","PSOUTIL",158,0)
 Q
"RTN","PSOUTIL",159,0)
GFDT ;
"RTN","PSOUTIL",160,0)
 I 'RFN,$P(^PSRX(RXY,2),"^",13) Q
"RTN","PSOUTIL",161,0)
 I RFN,$P(RF,"^",18) Q
"RTN","PSOUTIL",162,0)
 F LBL=0:0 S LBL=$O(^PSRX(RXY,"L",LBL)) Q:'LBL  I $P(^PSRX(RXY,"L",LBL,0),"^",2)=RFN S LBP=1 Q
"RTN","PSOUTIL",163,0)
 Q:$G(LBP)
"RTN","PSOUTIL",164,0)
 S SUPN=$O(^PS(52.5,"B",RXY,0))
"RTN","PSOUTIL",165,0)
 I SUPN,$P($G(^PS(52.5,SUPN,0)),"^",7)="L"!($P($G(^(0)),"^",7)="X") Q
"RTN","PSOUTIL",166,0)
 S:RFN RFD=$E($P(RF,"^"),1,7) S:'RFN RFD=$P(PSOX("RX3"),"^")
"RTN","PSOUTIL",167,0)
 I SUPN,RFD,$D(^PS(52.5,"C",RFD,SUPN)),$G(^PS(52.5,SUPN,"P"))=1 Q
"RTN","PSOUTIL",168,0)
 S PSOX("FILL DATE")=$P(PSOX("RX3"),"^")
"RTN","PSOUTIL",169,0)
 Q
"RTN","PSOUTIL",170,0)
 ;
"RTN","PSOUTIL",171,0)
ISSPLY() ;is the drug a supply item
"RTN","PSOUTIL",172,0)
 ;assumes the existence of the PSODRUG array
"RTN","PSOUTIL",173,0)
 I $G(PSODRUG("DEA"))="" Q 0
"RTN","PSOUTIL",174,0)
 I $G(PSODRUG("VA CLASS"))="" Q 0
"RTN","PSOUTIL",175,0)
 I PSODRUG("VA CLASS")?1"XA".E!(PSODRUG("VA CLASS")?1"XX".E)!(PSODRUG("VA CLASS")="DX900"&(PSODRUG("DEA")["S")) Q 1
"RTN","PSOUTIL",176,0)
 Q 0
"RTN","PSOUTIL",177,0)
 ;
"RTN","PSOUTIL",178,0)
DAYSUP(DRUG,RXARR,RCLQTY) ; Adjusts DAYS SUPPLY and QUANTITY based on the maximum allowed
"RTN","PSOUTIL",179,0)
 ; Input: DRUG   - DRUG file (#50) IEN
"RTN","PSOUTIL",180,0)
 ;        RXARR  - Array containing prescription information
"RTN","PSOUTIL",181,0)
 ;        RVWQTY - Re-calculate Quantity (1: YES / 0: NO) 
"RTN","PSOUTIL",182,0)
 ;Output: RXARR  - Array with "DAYS SUPPLY" and "QTY" values modified
"RTN","PSOUTIL",183,0)
 ;
"RTN","PSOUTIL",184,0)
 ; - Invalid Dispense Drug
"RTN","PSOUTIL",185,0)
 I '$D(^PSDRUG(+$G(DRUG),0))!'$D(RXARR) Q
"RTN","PSOUTIL",186,0)
 N MXDAYSUP,RXDAYSUP,RXQTY,NEWQTY
"RTN","PSOUTIL",187,0)
 S MXDAYSUP=$$MXDAYSUP^PSSUTIL1(DRUG)
"RTN","PSOUTIL",188,0)
 S RXDAYSUP=+$G(RXARR("DAYS SUPPLY"))
"RTN","PSOUTIL",189,0)
 I RXDAYSUP>MXDAYSUP D
"RTN","PSOUTIL",190,0)
 . W !!,"The current DAYS SUPPLY value (",RXDAYSUP,") exceeds the Maximum allowed"
"RTN","PSOUTIL",191,0)
 . W !,"for ",$$GET1^DIQ(50,DRUG,.01)," (",MXDAYSUP,") and will be reset.",$C(7)
"RTN","PSOUTIL",192,0)
 . S RXARR("DAYS SUPPLY")=MXDAYSUP
"RTN","PSOUTIL",193,0)
 . S RXQTY=+$G(RXARR("QTY"))
"RTN","PSOUTIL",194,0)
 . I $G(RCLQTY),RXQTY,RCLQTY'=RXQTY D
"RTN","PSOUTIL",195,0)
 . . S NEWQTY=((RXQTY*MXDAYSUP)/RXDAYSUP)+.5\1
"RTN","PSOUTIL",196,0)
 . . W !!,"The Quantity was changed from ",RXQTY," to ",NEWQTY,"."
"RTN","PSOUTIL",197,0)
 . . S RXARR("QTY")=NEWQTY
"RTN","PSOUTIL",198,0)
 . W !!,"Please, review the modified order before accepting it."
"RTN","PSOUTIL",199,0)
 . W ! N DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR
"RTN","PSOUTIL",200,0)
 Q
"RTN","PSOUTIL",201,0)
 ;
"RTN","PSOUTIL",202,0)
MAXNUMRF(DRUG,DAYSUP,PTST,CLOZPAT) ; Returns the Maximum Number of Refills Allowed
"RTN","PSOUTIL",203,0)
 ; Input: DRUG     - DRUG file (#50) IEN
"RTN","PSOUTIL",204,0)
 ;        DAYSUP   - Number of DAYS SUPPLY per fill
"RTN","PSOUTIL",205,0)
 ;        PTST     - RX PATIENT STATUES (#53) IEN
"RTN","PSOUTIL",206,0)
 ;        CLOZPAT  - Clozapine Indicator Variable (used throughout PSO)
"RTN","PSOUTIL",207,0)
 ;Output: MAXNUMRF - Maximum Number of Refills
"RTN","PSOUTIL",208,0)
 ;
"RTN","PSOUTIL",209,0)
 N MAXNUMRF,DEAHDLG,CSDRUG,MAXPTST
"RTN","PSOUTIL",210,0)
 ; - Invalid Drug or DAYS SUPPLY value
"RTN","PSOUTIL",211,0)
 I '$D(^PSDRUG(+$G(DRUG),0))!'$G(DAYSUP) Q 0
"RTN","PSOUTIL",212,0)
 ;
"RTN","PSOUTIL",213,0)
 ; - Calculating Maximum for Clozapine Drug
"RTN","PSOUTIL",214,0)
 I $D(CLOZPAT) Q $S(CLOZPAT=2&(DAYSUP=14):1,CLOZPAT=2&(DAYSUP=7):3,CLOZPAT=1&(DAYSUP=7):1,1:0)
"RTN","PSOUTIL",215,0)
 ;
"RTN","PSOUTIL",216,0)
 ; - Non-Refillable Drugs based on DEA SPECIAL HDLG field
"RTN","PSOUTIL",217,0)
 S DEAHDLG=$$GET1^DIQ(50,DRUG,3)
"RTN","PSOUTIL",218,0)
 I DEAHDLG["A"&(DEAHDLG'["B")!(DEAHDLG["F")!(DEAHDLG[1)!(DEAHDLG[2) Q 0
"RTN","PSOUTIL",219,0)
 S CSDRUG=0 I (DEAHDLG[3)!(DEAHDLG[4)!(DEAHDLG[5) S CSDRUG=1
"RTN","PSOUTIL",220,0)
 ;
"RTN","PSOUTIL",221,0)
 ; - The Maximum Number of Refills Calculation is different for up to 90 Days Supply Vs. Above 90 Days Supply
"RTN","PSOUTIL",222,0)
 I $G(CSDRUG) D
"RTN","PSOUTIL",223,0)
 . I DAYSUP'>90 D
"RTN","PSOUTIL",224,0)
 . . S MAXNUMRF=$S(DAYSUP<60:5,DAYSUP'<60&(DAYSUP'>89):2,DAYSUP=90:1,1:0)
"RTN","PSOUTIL",225,0)
 . E  D
"RTN","PSOUTIL",226,0)
 . . S MAXNUMRF=182\DAYSUP-1
"RTN","PSOUTIL",227,0)
 E  D
"RTN","PSOUTIL",228,0)
 . I DAYSUP'>90 D
"RTN","PSOUTIL",229,0)
 . . S MAXNUMRF=$S(DAYSUP<60:11,DAYSUP'<60&(DAYSUP'>89):5,DAYSUP=90:3,1:0)
"RTN","PSOUTIL",230,0)
 . E  D
"RTN","PSOUTIL",231,0)
 . . S MAXNUMRF=365\DAYSUP-1
"RTN","PSOUTIL",232,0)
 ;
"RTN","PSOUTIL",233,0)
 ; - Adjusting Maximum based Rx Patient Status 
"RTN","PSOUTIL",234,0)
 I $G(PTST) S MAXPTST=$$GET1^DIQ(53,PTST,4) I MAXNUMRF>MAXPTST S MAXNUMRF=MAXPTST
"RTN","PSOUTIL",235,0)
 ;
"RTN","PSOUTIL",236,0)
 Q MAXNUMRF
"RTN","PSOUTIL",237,0)
 ;
"RTN","PSOUTIL",238,0)
BADADDFL(RXIEN) ; Indicate whether an Rx should be flagged with a Bad Address
"RTN","PSOUTIL",239,0)
 ; Input: RXIEN    - Rx IEN (#52) to be checked
"RTN","PSOUTIL",240,0)
 ;Output: BADADDFL - 1: Rx Flagged for Bad Address / 0: Rx NOT Flagged Bad Address 
"RTN","PSOUTIL",241,0)
 N BADADDFL,LSTLBLSQ,LSTLBLTX
"RTN","PSOUTIL",242,0)
 S BADADDFL=0
"RTN","PSOUTIL",243,0)
 I '$G(^PSRX(+$G(RXIEN),0)) Q BADADDFL
"RTN","PSOUTIL",244,0)
 S LSTLBLSQ=$O(^PSRX(+RXIEN,"L",9999),-1)
"RTN","PSOUTIL",245,0)
 I LSTLBLSQ D
"RTN","PSOUTIL",246,0)
 . S LSTLBLTX=$G(^PSRX(+RXIEN,"L",LSTLBLSQ,0)) I LSTLBLTX["(BAD ADDRESS)" S BADADDFL=1
"RTN","PSOUTIL",247,0)
 Q BADADDFL
"RTN","PSOUTLA")
0^14^B37861740^B43668686
"RTN","PSOUTLA",1,0)
PSOUTLA ;BHAM ISC/AMC - pharmacy utility program ;07/24/96  1:13 pm
"RTN","PSOUTLA",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,15,23,56,126,222,354,444**;DEC 1997;Build 34
"RTN","PSOUTLA",3,0)
 ;External reference ^PS(54 supported by DBIA 2227
"RTN","PSOUTLA",4,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOUTLA",5,0)
CHK I '$D(PY(PSPR)) W !?10,$C(7),"  # ",PSPR," is not a valid choice." S PSPOP=1 Q
"RTN","PSOUTLA",6,0)
 I $D(PSDUP(PY(PSPR))) W !?10,$C(7),"RX# ",$P(^PSRX(+$P(PY(PSPR),"^"),0),"^")," is a duplicate choice." S PSPOP=1 Q
"RTN","PSOUTLA",7,0)
 S PSDUP(PY(PSPR))="" Q:'PSODIV  Q:'$P(^PSRX(+PY(PSPR),2),"^",9)  Q:+$P(^(2),"^",9)=PSOSITE
"RTN","PSOUTLA",8,0)
 S PSPRXN=+$P(PY(PSPR),"^")
"RTN","PSOUTLA",9,0)
CHK1 I '$P(PSOSYS,"^",2) W !!,$C(7),"RX# "_$P(^PSRX(PSPRXN,0),"^")_" is not a valid choice. (Different Division)",! S PSPOP=1 Q
"RTN","PSOUTLA",10,0)
 I $P(PSOSYS,"^",3) K DIR,DUOUT,DTOUT D
"RTN","PSOUTLA",11,0)
 .W $C(7) S DIR("A",1)="",DIR("A",2)="RX# "_$P(^PSRX(PSPRXN,0),"^")_" is from another division.",DIR("A")="Continue: (Y/N)",DIR(0)="Y",DIR("?",1)="'Y' FOR YES",DIR("?")="'N' FOR NO"
"RTN","PSOUTLA",12,0)
 .S DIR("B")="N" D ^DIR I 'Y!($D(DUOUT))!($D(DTOUT)) S PSPOP=1 W !
"RTN","PSOUTLA",13,0)
 K DIR,DUOUT,DTOUT Q
"RTN","PSOUTLA",14,0)
 ;
"RTN","PSOUTLA",15,0)
ZIPIN ; input transform for ZIP field in file #59 internal format (no '-'s)
"RTN","PSOUTLA",16,0)
 ;  Input:  X as user entered value
"RTN","PSOUTLA",17,0)
 ; Output:  X as internal value of user input OR
"RTN","PSOUTLA",18,0)
 ;            undefined if input from user was invalid
"RTN","PSOUTLA",19,0)
 N % I X'?.N F %=1:1:$L(X) I $E(X,%)?1P S X=$E(X,0,%-1)_$E(X,%+1,20),%=%-1
"RTN","PSOUTLA",20,0)
 I X'?5N,(X'?9N) K X
"RTN","PSOUTLA",21,0)
 Q
"RTN","PSOUTLA",22,0)
 ;
"RTN","PSOUTLA",23,0)
ZIPOUT ; output transform for ZIP - prints either ZIP or ZIP+4 (in 12345-1234)
"RTN","PSOUTLA",24,0)
 ; format.
"RTN","PSOUTLA",25,0)
 ; Input:  Y internal value
"RTN","PSOUTLA",26,0)
 ; Output:  Y external (12345 or 12345-1234)
"RTN","PSOUTLA",27,0)
 S Y=$E(Y,1,5)_$S($E(Y,6,9)]"":"-"_$E(Y,6,9),1:"")
"RTN","PSOUTLA",28,0)
 Q
"RTN","PSOUTLA",29,0)
YN ;YES/NO PROMPT
"RTN","PSOUTLA",30,0)
 W !?5,"'Y' FOR YES",!?5,"'N' FOR NO",!
"RTN","PSOUTLA",31,0)
 Q
"RTN","PSOUTLA",32,0)
DAYS ;
"RTN","PSOUTLA",33,0)
 K PSFMAX S ED=1,PSODEA=$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^",3),PSDAYS=$P(^PSRX(DA,0),"^",8),CS=0
"RTN","PSOUTLA",34,0)
 D EDNEW K:ED PSFMAX,ED K:$P(^PSRX(DA,0),"^",9)'>MAX PSMAX
"RTN","PSOUTLA",35,0)
 Q
"RTN","PSOUTLA",36,0)
EDNEW ;
"RTN","PSOUTLA",37,0)
 K PSMAX,PSFMAX
"RTN","PSOUTLA",38,0)
 ; Retrieving the Maximum Number of Refills allowed
"RTN","PSOUTLA",39,0)
 S PSMAX=$$MAXNUMRF^PSOUTIL(+$P(^PSRX(DA,0),"^",6),PSDAYS,+$P(^PSRX(DA,0),"^",3),.CLOZPAT)
"RTN","PSOUTLA",40,0)
 ;
"RTN","PSOUTLA",41,0)
 I PSRF>PSMAX D
"RTN","PSOUTLA",42,0)
 .W $C(7),!!,PSRF_" refills are not correct for a "_PSDAYS_" day supply.",!,"Please enter correct # of refills for a "_PSDAYS_" day supply. Max refills allowed is "_PSMAX_".",!
"RTN","PSOUTLA",43,0)
 K PSTMAX D EDSTAT
"RTN","PSOUTLA",44,0)
 Q
"RTN","PSOUTLA",45,0)
STATDAY K PSMAX,PSRMAX,PSFMAX,PSTMAX S PSDAYS=$P(^PSRX(DA,0),"^",8),PSRF=$P(^PSRX(DA,0),"^",9),PTST=$P(^PS(53,X,0),"^"),PTDY=$P(^(0),"^",3),PTRF=$P(^(0),"^",4)
"RTN","PSOUTLA",46,0)
EDSTAT I PSRF>PTRF D EN^DDIOL(PSRF_" refills are greater than "_PTRF_" allowed for "_$P(PTST,"^")_" Rx Patient Status.","","$C(7),!") D EN^DDIOL(" ","","!")
"RTN","PSOUTLA",47,0)
 Q
"RTN","PSOUTLA",48,0)
PARKILL S CNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA(1),"A",SUB)) Q:'SUB  S CNT=SUB
"RTN","PSOUTLA",49,0)
 I '$G(RESK) D  G:$D(DIRUT) PARKILL
"RTN","PSOUTLA",50,0)
 .D EN^DDIOL(" ","","!") K DIR S DIR(0)="FO^10:75",DIR("A",1)="Enter Reason for Edit:",DIR("A")="=>",DIR("?",1)="This is a required response.  No Up-arrowing allowed."
"RTN","PSOUTLA",51,0)
 .S DIR("?")="Response must be 10-75 characters in length.",DIR("B")="Entered In Error"
"RTN","PSOUTLA",52,0)
 .D ^DIR I $D(DIRUT) D EN^DDIOL("This is a required response.  No Up-arrowing allowed.","","!") Q
"RTN","PSOUTLA",53,0)
 .S ACOM=$S($G(Y)]""&('$D(DIRUT)):Y,1:"Partial Entered In Error.")
"RTN","PSOUTLA",54,0)
 .S PSOPRZ=$G(PSOPRZ)-1 S:PSOPRZ<0 PSOPRZ=0
"RTN","PSOUTLA",55,0)
 S:$G(RESK) ACOM="Partial fill returned to stock."
"RTN","PSOUTLA",56,0)
 D NOW^%DTC S CNT=CNT+1 S ^PSRX(DA(1),"A",0)="^52.3DA^"_CNT_"^"_CNT,^PSRX(DA(1),"A",CNT,0)=%_"^D^"_DUZ_"^6^"_ACOM K CNT,SUB,DIR,DTOUT,DUOUT
"RTN","PSOUTLA",57,0)
 Q
"RTN","PSOUTLA",58,0)
SETUP ;enter/edit clinic sort groups
"RTN","PSOUTLA",59,0)
 W ! S (DLAYGO,DIC,DIE)=59.8,DIC("A")="Select Clinic Sort Group: ",DIC(0)="AEQML" D ^DIC G:"^"[$E(X) SETUPX G:Y<1 SETUP S DA=+Y,DR=".01;1" D ^DIE
"RTN","PSOUTLA",60,0)
SETUPX K DIE,DIC,DA,DLAYGO,Y,X,DR
"RTN","PSOUTLA",61,0)
 Q
"RTN","PSOUTLA",62,0)
FSIG(PSOFILE,PSOINTR,PSOLENTH) ;Format front door sig
"RTN","PSOUTLA",63,0)
 ;PSOFILE is 'P' if in Pending File, 'R' if in Prescription File
"RTN","PSOUTLA",64,0)
 ;PSOINTR is internal number for either file
"RTN","PSOUTLA",65,0)
 ;PSOLENTH is length of each line of the Sig
"RTN","PSOUTLA",66,0)
 ;returned in the FSIG array
"RTN","PSOUTLA",67,0)
 K FSIG I $G(PSOFILE)=""!('$G(PSOINTR))!('$G(PSOLENTH)) G FQUIT
"RTN","PSOUTLA",68,0)
 I PSOFILE'="P",PSOFILE'="R" G FQUIT
"RTN","PSOUTLA",69,0)
 I PSOFILE="P",'$D(^PS(52.41,+PSOINTR,0)) G FQUIT
"RTN","PSOUTLA",70,0)
 I PSOFILE="R",'$D(^PSRX(+PSOINTR,0)) G FQUIT
"RTN","PSOUTLA",71,0)
 I PSOFILE="R",'$P($G(^PSRX(+PSOINTR,"SIG")),"^",2) G FQUIT
"RTN","PSOUTLA",72,0)
 N FFF,NNN,CNT,FVAR,FVAR1,FLIM,HSIG,II
"RTN","PSOUTLA",73,0)
 I PSOFILE="P" F NNN=0:0 S NNN=$O(^PS(52.41,PSOINTR,"SIG",NNN)) Q:'NNN  S:$G(^(NNN,0))'="" HSIG(NNN)=^(0)
"RTN","PSOUTLA",74,0)
 I PSOFILE="P" G:'$O(HSIG(0)) FQUIT G FSTART
"RTN","PSOUTLA",75,0)
 ;S HSIG(1)=$P($G(^PSRX(PSOINTR,"SIG")),"^") S FFF=2 F NNN=0:0 S NNN=$O(^PSRX(PSOINTR,"SIG1",NNN)) Q:'NNN  I $G(^(NNN,0))'="" S HSIG(FFF)=$G(^(0)),FFF=FFF+1
"RTN","PSOUTLA",76,0)
 S FFF=1 F NNN=0:0 S NNN=$O(^PSRX(PSOINTR,"SIG1",NNN)) Q:'NNN  I $G(^(NNN,0))'="" S HSIG(FFF)=^(0) S FFF=FFF+1
"RTN","PSOUTLA",77,0)
 G:'$O(HSIG(0)) FQUIT
"RTN","PSOUTLA",78,0)
FSTART S (FVAR,FVAR1)="",II=1
"RTN","PSOUTLA",79,0)
 F FFF=0:0 S FFF=$O(HSIG(FFF)) Q:'FFF  S CNT=0 F NNN=1:1:$L(HSIG(FFF)) I $E(HSIG(FFF),NNN)=" "!($L(HSIG(FFF))=NNN) S CNT=CNT+1 D  I $L(FVAR)>PSOLENTH S FSIG(II)=FLIM_" ",II=II+1,FVAR=FVAR1
"RTN","PSOUTLA",80,0)
 .S FVAR1=$P(HSIG(FFF)," ",(CNT))
"RTN","PSOUTLA",81,0)
 .S FLIM=FVAR
"RTN","PSOUTLA",82,0)
 .S FVAR=$S(FVAR="":FVAR1,1:FVAR_" "_FVAR1)
"RTN","PSOUTLA",83,0)
 I $G(FVAR)'="" S FSIG(II)=FVAR
"RTN","PSOUTLA",84,0)
 I $G(FSIG(1))=""!($G(FSIG(1))=" ") S FSIG(1)=$G(FSIG(2)) K FSIG(2)
"RTN","PSOUTLA",85,0)
FQUIT Q
"RTN","PSOUTLA",86,0)
DRUGW ;
"RTN","PSOUTLA",87,0)
 F Z0=1:1 Q:$P(X,",",Z0,99)=""  S Z1=$P(X,",",Z0) W:$D(^PS(54,Z1,0)) ?35,$P(^(0),"^"),! I '$D(^(0)) W ?35,"NO SUCH WARNING LABEL" K X Q
"RTN","PSOUTLA",88,0)
 Q
"RTN","PSOUTLA",89,0)
HLNEW ;formats provider instructions in FSIG for front door order
"RTN","PSOUTLA",90,0)
 K FSIG N FFF,NNN,CNT,FVAR,FVAR1,FLIM,HSIG,II,LLP,PSOLENTH
"RTN","PSOUTLA",91,0)
 S PSOLENTH=59,LLP=1 F LLL=0:0 S LLL=$O(WPARRAY(7,LLL)) Q:'LLL  S HSIG(LLP)=$G(WPARRAY(7,LLL)),LLP=LLP+1
"RTN","PSOUTLA",92,0)
 D FSTART Q
"RTN","PSOUTLA",93,0)
HLNEWX ;
"RTN","PSOUTLA",94,0)
 K FSIG N FFF,NNN,CNT,FVAR,FVAR1,FLIM,HSIG,II,LLP,PSOLENTH
"RTN","PSOUTLA",95,0)
 S PSOLENTH=59,LLP=1 F LLL=0:0 S LLL=$O(WPARRAY(6,LLL)) Q:'LLL  S HSIG(LLP)=$G(WPARRAY(6,LLL)),LLP=LLP+1
"RTN","PSOUTLA",96,0)
 D FSTART Q
"RTN","PSOUTLA",97,0)
 ;
"RTN","PSOUTLA",98,0)
SUSFDS ;
"RTN","PSOUTLA",99,0)
 N SUSIEN
"RTN","PSOUTLA",100,0)
 Q:$O(^PSRX(DA,1,0))
"RTN","PSOUTLA",101,0)
 S SUSIEN=+$O(^PS(52.5,"B",DA,0)) Q:'$G(SUSIEN)
"RTN","PSOUTLA",102,0)
 Q:'$D(^PS(52.5,SUSIEN,0))!($G(^PS(52.5,SUSIEN,"P")))
"RTN","PSOUTLA",103,0)
 I '$P($G(^PS(52.5,SUSIEN,0)),"^",5),'$P($G(^(0)),"^",13) S $P(^PS(52.5,SUSIEN,0),"^",2)=X,^PS(52.5,"C",X,SUSIEN)="" D
"RTN","PSOUTLA",104,0)
 .I $P($G(^PS(52.5,SUSIEN,0)),"^",7)="Q" S ^PS(52.5,"AQ",X,+$P($G(^PS(52.5,SUSIEN,0)),"^",3),SUSIEN)="" D SCMPX^PSOCMOP(SUSIEN,"Q") Q
"RTN","PSOUTLA",105,0)
 .S ^PS(52.5,"AC",+$P($G(^PS(52.5,SUSIEN,0)),"^",3),X,SUSIEN)=""
"RTN","PSOUTLA",106,0)
 Q
"RTN","PSOUTLA",107,0)
SUSFDK ;
"RTN","PSOUTLA",108,0)
 N SUSIEN
"RTN","PSOUTLA",109,0)
 Q:$O(^PSRX(DA,1,0))
"RTN","PSOUTLA",110,0)
 S SUSIEN=+$O(^PS(52.5,"B",DA,0)) Q:'$G(SUSIEN)
"RTN","PSOUTLA",111,0)
 Q:'$D(^PS(52.5,SUSIEN,0))!($G(^PS(52.5,SUSIEN,"P")))
"RTN","PSOUTLA",112,0)
 I '$P($G(^PS(52.5,SUSIEN,0)),"^",5),'$P($G(^(0)),"^",13) K ^PS(52.5,"C",X,SUSIEN) D
"RTN","PSOUTLA",113,0)
 .I $P($G(^PS(52.5,SUSIEN,0)),"^",7)="Q" K ^PS(52.5,"AQ",X,+$P($G(^PS(52.5,SUSIEN,0)),"^",3),SUSIEN) D KCMPX^PSOCMOP(SUSIEN,"Q") Q
"RTN","PSOUTLA",114,0)
 .K ^PS(52.5,"AC",+$P($G(^PS(52.5,SUSIEN,0)),"^",3),X,SUSIEN)
"RTN","PSOUTLA",115,0)
 Q
"RTN","PSOUTLA",116,0)
ADD ;enter/edit automated devices - OPAI
"RTN","PSOUTLA",117,0)
 W ! S (DLAYGO,DIC,DIE)=52.53,DIC("A")="Select ADD Name: ",DIC(0)="AEQML" D ^DIC G:"^"[$E(X) ADDX G:Y<1 ADD S DA=+Y,DR=".01;1;2;3" D ^DIE G ADD
"RTN","PSOUTLA",118,0)
ADDX K DIE,DIC,DA,Y,X,DR
"RTN","PSOUTLA",119,0)
 Q
"RTN","PSOUTLA1")
0^21^B66629257^B59550372
"RTN","PSOUTLA1",1,0)
PSOUTLA1 ;BHAM ISC/RTR-Pharmacy utility program cont. ; 17 Jun 2011  2:21 PM
"RTN","PSOUTLA1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**35,186,218,259,206,388,444**;DEC 1997;Build 34
"RTN","PSOUTLA1",3,0)
 ;External reference to File ^PS(55 supported by DBIA 2228
"RTN","PSOUTLA1",4,0)
 ;External reference to File ^PSDRUG supported by DBIA 221
"RTN","PSOUTLA1",5,0)
 ;External reference to File ^PS(59.7 supported by DBIA 694
"RTN","PSOUTLA1",6,0)
 ;External reference to File ^PS(51 supported by DBIA 2224
"RTN","PSOUTLA1",7,0)
 ;
"RTN","PSOUTLA1",8,0)
 ;*186 - add DEACHK function
"RTN","PSOUTLA1",9,0)
 ;*218 - add REFIP function
"RTN","PSOUTLA1",10,0)
 ;*259 - reverse *218 delete restriction only warn of deleting
"RTN","PSOUTLA1",11,0)
 ;       also add del of last refill only
"RTN","PSOUTLA1",12,0)
 ;
"RTN","PSOUTLA1",13,0)
EN1 ;Formats condensed, back door sig in BSIG array
"RTN","PSOUTLA1",14,0)
 ;pass in  1) Internal Rx from 52
"RTN","PSOUTLA1",15,0)
 ;         2) max length of BSIG array
"RTN","PSOUTLA1",16,0)
 ;Returned, still condensed, in BSIG array, when looping through, check for array=null, if so, juist don't print it
"RTN","PSOUTLA1",17,0)
EN2(PSOBINTR,PSOBLGTH) ;
"RTN","PSOUTLA1",18,0)
 K BSIG
"RTN","PSOUTLA1",19,0)
 N BBSIG,BVAR,BVAR1,III,CNT,NNN,BLIM
"RTN","PSOUTLA1",20,0)
 S BBSIG=$P($G(^PSRX(PSOBINTR,"SIG")),"^") Q:BBSIG=""!($P($G(^("SIG")),"^",2))
"RTN","PSOUTLA1",21,0)
 S (BVAR,BVAR1)="",III=1
"RTN","PSOUTLA1",22,0)
 S CNT=0 F NNN=1:1:$L(BBSIG) I $E(BBSIG,NNN)=" "!($L(BBSIG)=NNN) S CNT=CNT+1 D  I $L(BVAR)>PSOBLGTH S BSIG(III)=BLIM_" ",III=III+1,BVAR=BVAR1
"RTN","PSOUTLA1",23,0)
 .S BVAR1=$P(BBSIG," ",(CNT))
"RTN","PSOUTLA1",24,0)
 .S BLIM=BVAR
"RTN","PSOUTLA1",25,0)
 .S BVAR=$S(BVAR="":BVAR1,1:BVAR_" "_BVAR1)
"RTN","PSOUTLA1",26,0)
 I $G(BVAR)'="" S BSIG(III)=BVAR
"RTN","PSOUTLA1",27,0)
 I $G(BSIG(1))=""!($G(BSIG(1))=" ") S BSIG(1)=$G(BSIG(2)) K BSIG(2)
"RTN","PSOUTLA1",28,0)
 Q
"RTN","PSOUTLA1",29,0)
 ;
"RTN","PSOUTLA1",30,0)
EN3(PSOBINTR,PSOBLGTH) ;
"RTN","PSOUTLA1",31,0)
 ;Pass in to EN3 the internal Rx number from 52, and the length of
"RTN","PSOUTLA1",32,0)
 ;the array you want. Returns expanded Sig, or warning from PSOHELP
"RTN","PSOUTLA1",33,0)
 ;concantenated with the condensed Sig in the BSIG array
"RTN","PSOUTLA1",34,0)
 ;BACK DOOR ONLY
"RTN","PSOUTLA1",35,0)
 K BSIG,X N BBSIG,BVAR,BVAR1,III,CNT,NNN,BLIM,Y,SIG,Z0,Z1,BBWARN
"RTN","PSOUTLA1",36,0)
 S BBSIG=$P($G(^PSRX(PSOBINTR,"SIG")),"^") Q:BBSIG=""!($P($G(^("SIG")),"^",2))
"RTN","PSOUTLA1",37,0)
 S (SIG,X)=BBSIG
"RTN","PSOUTLA1",38,0)
 I $E(BBSIG)=" " S BBWARN="Leading spaces are not allowed in the SIG!" G START
"RTN","PSOUTLA1",39,0)
 S SIG="" Q:$L(X)<1  F Z0=1:1:$L(X," ") G:Z0="" START S Z1=$P(X," ",Z0) D  G:'$D(X) START
"RTN","PSOUTLA1",40,0)
 .I $L(Z1)>32 S BBWARN="MAX OF 32 CHARACTERS ALLOWED BETWEEN SPACES!" K X Q
"RTN","PSOUTLA1",41,0)
 .D:$D(X)&($G(Z1)]"")  S SIG=SIG_" "_Z1
"RTN","PSOUTLA1",42,0)
 ..S Y=$O(^PS(51,"B",Z1,0)) Q:'Y!($P($G(^PS(51,+Y,0)),"^",4)>1)  S Z1=$P(^PS(51,Y,0),"^",2) Q:'$D(^(9))  S Y=$P(X," ",Z0-1),Y=$E(Y,$L(Y)) S:Y>1 Z1=^(9)
"RTN","PSOUTLA1",43,0)
START ;
"RTN","PSOUTLA1",44,0)
 S BBSIG=$S($G(BBWARN)="":SIG,1:BBWARN_"  "_BBSIG)
"RTN","PSOUTLA1",45,0)
 S (BVAR,BVAR1)="",III=1
"RTN","PSOUTLA1",46,0)
 S CNT=0 F NNN=1:1:$L(BBSIG) I $E(BBSIG,NNN)=" "!($L(BBSIG)=NNN) S CNT=CNT+1 D  I $L(BVAR)>PSOBLGTH S BSIG(III)=BLIM_" ",III=III+1,BVAR=BVAR1
"RTN","PSOUTLA1",47,0)
 .S BVAR1=$P(BBSIG," ",(CNT))
"RTN","PSOUTLA1",48,0)
 .S BLIM=BVAR
"RTN","PSOUTLA1",49,0)
 .S BVAR=$S(BVAR="":BVAR1,1:BVAR_" "_BVAR1)
"RTN","PSOUTLA1",50,0)
 I $G(BVAR)'="" S BSIG(III)=BVAR
"RTN","PSOUTLA1",51,0)
 I $G(BSIG(1))=""!($G(BSIG(1))=" ") S BSIG(1)=$G(BSIG(2)) K BSIG(2)
"RTN","PSOUTLA1",52,0)
 Q
"RTN","PSOUTLA1",53,0)
PATCH ;Allow sites to backfill more than what was done at install
"RTN","PSOUTLA1",54,0)
 N PSOBACKL,PSOBACKI,PSOBACKS,PSOBACKB,PSOBACKD,PSOBACKA
"RTN","PSOUTLA1",55,0)
 S PSOBACKL=$O(^PS(59.7,0)),PSOBACKI=$E($P($G(^PS(59.7,+$G(PSOBACKL),49.99)),"^",7),1,7)
"RTN","PSOUTLA1",56,0)
 I '$G(PSOBACKI) S PSOBACKI=$P($G(^PS(59.7,+$G(PSOBACKL),49.99)),"^",4)
"RTN","PSOUTLA1",57,0)
 I $G(PSOBACKI) S Y=PSOBACKI D DD^%DT S PSOBACKS=Y S X1=PSOBACKI,X2=-120 D C^%DTC S (Y,PSOBACKB)=X D DD^%DT S PSOBACKD=Y
"RTN","PSOUTLA1",58,0)
 I $G(PSOBACKD)'="" W !!,"Your CPRS/Outpatient installation date is "_$G(PSOBACKS)_","_" which",!,"means we have already backfilled all active prescriptions and all",!,"prescriptions canceled or expired after "_$G(PSOBACKD)_"."
"RTN","PSOUTLA1",59,0)
 I  W !!,"If you want to backfill orders that were canceled or expired prior to this",!,"date of "_$G(PSOBACKD)_", enter an earlier date and those orders",!,"will be backfilled to CPRS.",!
"RTN","PSOUTLA1",60,0)
 I $G(PSOBACKD)="" W !!,"We cannot determine the date of the CPRS/Outpatient installation.",!
"RTN","PSOUTLA1",61,0)
 W !,"If you choose to backfill more orders to CPRS by utilizing this option,",!,"we remind you that disk storage can be significantly affected, depending on",!,"how many orders are backfilled.",!
"RTN","PSOUTLA1",62,0)
 K DIR S DIR(0)="Y",DIR("B")="N",DIR("A")="Do you want to backfill more prescriptions",DIR("?")="Enter Yes to backfill prescriptions canceled or expired before "_$G(PSOBACKD) D ^DIR K DIR I Y'=1 W ! G PATCHQ
"RTN","PSOUTLA1",63,0)
 W ! S %DT="AEPX",%DT("A")="Enter Date to begin backfill: " S:$G(PSOBACKB) %DT(0)=-PSOBACKB D ^%DT G:Y<0!($D(DTOUT)) PATCHQ S PSOBACKA=$E(Y,1,7)
"RTN","PSOUTLA1",64,0)
 W ! K ZTDTH S ZTSAVE("PSOBACKB")="",ZTSAVE("PSOBACKA")="",ZTRTN="PATCHR^PSOUTLA1",ZTDESC="BACKFILL PRSCRIPTIONS TO CPRS",ZTIO="" D ^%ZTLOAD W ! G PATCHQ
"RTN","PSOUTLA1",65,0)
PATCHR ;Begin task
"RTN","PSOUTLA1",66,0)
 N PSOPAL,PSOLPD,PSOLPRX
"RTN","PSOUTLA1",67,0)
 S PSOBACKA=PSOBACKA-.01
"RTN","PSOUTLA1",68,0)
 I '$G(PSOBACKB) S PSOBACKB=DT
"RTN","PSOUTLA1",69,0)
 F PSOPAL=0:0 S PSOPAL=$O(^PS(55,PSOPAL)) Q:'PSOPAL  F PSOLPD=PSOBACKA:0 S PSOLPD=$O(^PS(55,PSOPAL,"P","A",PSOLPD)) Q:'PSOLPD!(PSOLPD>PSOBACKB)  F PSOLPRX=0:0 S PSOLPRX=$O(^PS(55,PSOPAL,"P","A",PSOLPD,PSOLPRX)) Q:'PSOLPRX  D
"RTN","PSOUTLA1",70,0)
 .I $P($G(^PSRX(PSOLPRX,0)),"^")=""!('$P($G(^(0)),"^",2))!('$P($G(^(0)),"^",6)) Q
"RTN","PSOUTLA1",71,0)
 .I $P($G(^PSRX(PSOLPRX,"OR1")),"^",2) Q
"RTN","PSOUTLA1",72,0)
 .I '$P($G(^PSRX(PSOLPRX,0)),"^",19) D
"RTN","PSOUTLA1",73,0)
 ..I $P($G(^PSRX(PSOLPRX,"OR1")),"^")="",+$G(^PSDRUG(+$P($G(^PSRX(PSOLPRX,0)),"^",6),2)) S $P(^PSRX(PSOLPRX,"OR1"),"^")=+$G(^PSDRUG(+$P($G(^PSRX(PSOLPRX,0)),"^",6),2))
"RTN","PSOUTLA1",74,0)
 ..I $P($G(^PSRX(PSOLPRX,0)),"^",10)'="",$G(^PSRX(PSOLPRX,"SIG"))']"",'$O(^PSRX(PSOLPRX,"SIG1",0)) S ^PSRX(PSOLPRX,"SIG")=$P($G(^PSRX(PSOLPRX,0)),"^",10)_"^"_0 S $P(^PSRX(PSOLPRX,0),"^",10)=""
"RTN","PSOUTLA1",75,0)
 ..I $P($G(^PSRX(PSOLPRX,"STA")),"^")="",$P($G(^PSRX(PSOLPRX,0)),"^",15)'="" S $P(^PSRX(PSOLPRX,"STA"),"^")=$P($G(^PSRX(PSOLPRX,0)),"^",15) S $P(^PSRX(PSOLPRX,0),"^",15)=""
"RTN","PSOUTLA1",76,0)
 ..S $P(^PSRX(PSOLPRX,0),"^",19)=1
"RTN","PSOUTLA1",77,0)
 .S PSOLPSTA=$P($G(^PSRX(PSOLPRX,"STA")),"^") Q:PSOLPSTA=""!(PSOLPSTA=13)!(PSOLPSTA=10)
"RTN","PSOUTLA1",78,0)
 .D EN^PSOHLSN1(PSOLPRX,"ZC","")
"RTN","PSOUTLA1",79,0)
 .I PSOLPSTA'="",PSOLPSTA<10 D
"RTN","PSOUTLA1",80,0)
 ..I +$P($G(^PSRX(PSOLPRX,2)),"^",6),+$P($G(^(2)),"^",6)<DT S $P(^PSRX(PSOLPRX,"STA"),"^")=11,PSOLPSTA=11
"RTN","PSOUTLA1",81,0)
 .S PSOLPSTX=$S(PSOLPSTA=3:"OH",PSOLPSTA=16:"OH",PSOLPSTA=12:"OD",PSOLPSTA=15:"OD",PSOLPSTA=14:"OD",1:"SC"),PSOLPSTZ=$S(PSOLPSTA=0:"CM",PSOLPSTA=1:"IP",PSOLPSTA=4:"IP",PSOLPSTA=5:"ZS",PSOLPSTA=11:"ZE",1:"")
"RTN","PSOUTLA1",82,0)
 .D EN^PSOHLSN1(PSOLPRX,PSOLPSTX,PSOLPSTZ,"")
"RTN","PSOUTLA1",83,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOUTLA1",84,0)
PATCHQ Q
"RTN","PSOUTLA1",85,0)
 ;
"RTN","PSOUTLA1",86,0)
 ;PSO*186
"RTN","PSOUTLA1",87,0)
DEACHK(PSIRXN,PSDEA,PSDAYS,PCLOZ,PSOCS,PSMAXRF) ;Apply DEA restrictions
"RTN","PSOUTLA1",88,0)
 ;
"RTN","PSOUTLA1",89,0)
 ; If no refills allowed indicate that and set Max refills to number
"RTN","PSOUTLA1",90,0)
 ; of fills thus far, or if new order, then num of refills will not be
"RTN","PSOUTLA1",91,0)
 ; found and Max refills will be 0.
"RTN","PSOUTLA1",92,0)
 ;
"RTN","PSOUTLA1",93,0)
 ;  Function returns: 1 = no refills allowed
"RTN","PSOUTLA1",94,0)
 ;  Function returns: 2 = no refills allowed
"RTN","PSOUTLA1",95,0)
 ;                    0 = ok to refill
"RTN","PSOUTLA1",96,0)
 ;  Input Variables: PSIRXN = internal RX number or "*"=(new order)
"RTN","PSOUTLA1",97,0)
 ;                   PSDEA  = DEA special handling for drug ordered
"RTN","PSOUTLA1",98,0)
 ;                   PSDAYS = Days supply ordered
"RTN","PSOUTLA1",99,0)
 ;                   PCLOZ  = Clozapine patient? (Optional)
"RTN","PSOUTLA1",100,0)
 ; Output Variables: PSOCS  = Controlled sub flag  (Optional)
"RTN","PSOUTLA1",101,0)
 ;                   PSMAXRF= Max Refill allowed by DEA restriction
"RTN","PSOUTLA1",102,0)
 ;                                                 (Optional)
"RTN","PSOUTLA1",103,0)
 ;
"RTN","PSOUTLA1",104,0)
 S PSIRXN=+$G(PSIRXN),PSDEA=$G(PSDEA),PSDAYS=+$G(PSDAYS)
"RTN","PSOUTLA1",105,0)
 S PSOCS=+$G(PSOCS),PSMAXRF=+$G(PSMAXRF),PCLOZ=$G(PCLOZ)
"RTN","PSOUTLA1",106,0)
 ;
"RTN","PSOUTLA1",107,0)
 ;if clozapine patient (passed in 0 or 1),  set max refills and quit
"RTN","PSOUTLA1",108,0)
 I PCLOZ=0 S PSMAXRF=0 Q 1
"RTN","PSOUTLA1",109,0)
 I PCLOZ=1 S PSMAXRF=1 Q 0
"RTN","PSOUTLA1",110,0)
 ;
"RTN","PSOUTLA1",111,0)
 ;no refills if PSDEA = 'A' & not 'B' or 'F',
"RTN","PSOUTLA1",112,0)
 I (PSDEA["A")&(PSDEA'["B")!(PSDEA["F")!(PSDEA[1)!(PSDEA[2) D  Q 2  ;*388
"RTN","PSOUTLA1",113,0)
 . S PSMAXRF=$$NUMFILLS(PSIRXN)
"RTN","PSOUTLA1",114,0)
 ;
"RTN","PSOUTLA1",115,0)
 N QQ
"RTN","PSOUTLA1",116,0)
 F QQ=1:1 Q:$E(PSDEA,QQ)=""  I $E(+PSDEA,QQ)>1,$E(+PSDEA,QQ)<6 D
"RTN","PSOUTLA1",117,0)
 . S PSOCS=1
"RTN","PSOUTLA1",118,0)
 . S:$E(+PSDEA,QQ)=2 $P(PSOCS,"^",2)=1
"RTN","PSOUTLA1",119,0)
 ;
"RTN","PSOUTLA1",120,0)
 ;no refills allowed on sched 2
"RTN","PSOUTLA1",121,0)
 I $P(PSOCS,"^",2)=1 S PSMAXRF=$$NUMFILLS(PSIRXN) Q 2  ;*388
"RTN","PSOUTLA1",122,0)
 ;
"RTN","PSOUTLA1",123,0)
 ; Checking past dispensed DAYS SUPPLY to make sure the refill does not exceed maximum allowed (PSO*7*444)
"RTN","PSOUTLA1",124,0)
 S PSDAYS=+$G(PSDAYS)
"RTN","PSOUTLA1",125,0)
 I PSOCS,$$TOTALDS+PSDAYS>184 Q 1
"RTN","PSOUTLA1",126,0)
 I 'PSOCS,$$TOTALDS+PSDAYS>365 Q 1
"RTN","PSOUTLA1",127,0)
 ;
"RTN","PSOUTLA1",128,0)
 ;set max refill for controlled substance & other based on days supply
"RTN","PSOUTLA1",129,0)
 I $G(PSIRXN) D
"RTN","PSOUTLA1",130,0)
 . S PSMAXRF=$$MAXNUMRF^PSOUTIL(+$P(^PSRX(PSIRXN,0),"^",6),PSDAYS,+$P(^PSRX(PSIRXN,0),"^",3))
"RTN","PSOUTLA1",131,0)
 E  D
"RTN","PSOUTLA1",132,0)
 . I PSOCS D
"RTN","PSOUTLA1",133,0)
 . . I PSDAYS'>90 S PSMAXRF=$S(PSDAYS<60:5,PSDAYS'<60&(PSDAYS'>89):2,PSDAYS=90:1,1:0)
"RTN","PSOUTLA1",134,0)
 . . I PSDAYS>90 S PSMAXRF=182\PSDAYS-1
"RTN","PSOUTLA1",135,0)
 . E  D
"RTN","PSOUTLA1",136,0)
 . . I PSDAYS'>90 S PSMAXRF=$S(PSDAYS<60:11,PSDAYS'<60&(PSDAYS'>89):5,PSDAYS=90:3,1:0)
"RTN","PSOUTLA1",137,0)
 . . I PSDAYS>90 S PSMAXRF=365\PSDAYS-1
"RTN","PSOUTLA1",138,0)
 ;
"RTN","PSOUTLA1",139,0)
 ;get number of fills if applies & compare to Max refills
"RTN","PSOUTLA1",140,0)
 N PNFILLS S PNFILLS=$$NUMFILLS(PSIRXN)
"RTN","PSOUTLA1",141,0)
 I PNFILLS'<PSMAXRF S PSMAXRF=PNFILLS Q 1
"RTN","PSOUTLA1",142,0)
 ;
"RTN","PSOUTLA1",143,0)
 Q 0
"RTN","PSOUTLA1",144,0)
 ;
"RTN","PSOUTLA1",145,0)
NUMFILLS(PSIRXN) ;Return number of fills thus far, or 0 if doesn't apply
"RTN","PSOUTLA1",146,0)
 ; function returns: if   Active drug, then number of refills thus far
"RTN","PSOUTLA1",147,0)
 ;                   else return 0 for does not apply
"RTN","PSOUTLA1",148,0)
 ;  Input Variables: PSIRXN = internal RX number (Optional)
"RTN","PSOUTLA1",149,0)
 Q:'$G(PSIRXN) 0
"RTN","PSOUTLA1",150,0)
 N RFN,RFNC
"RTN","PSOUTLA1",151,0)
 S (RFN,RFNC)=0
"RTN","PSOUTLA1",152,0)
 F  S RFN=$O(^PSRX(PSIRXN,1,RFN)) Q:'RFN  S RFNC=RFNC+1
"RTN","PSOUTLA1",153,0)
 Q RFNC
"RTN","PSOUTLA1",154,0)
 ;
"RTN","PSOUTLA1",155,0)
TOTALDS(RXIEN) ; Return the Total number of Days Supply for a prescription
"RTN","PSOUTLA1",156,0)
 ; Input: RXIEN   - PRESCRIPTION file (#52) IEN (Internal Entry Number)
"RTN","PSOUTLA1",157,0)
 ;Output: TOTALDS - Sum of DAYS SUPPLY field from all Rx Fills (original + Refills only)
"RTN","PSOUTLA1",158,0)
 ;
"RTN","PSOUTLA1",159,0)
 Q:'$G(RXIEN) 0
"RTN","PSOUTLA1",160,0)
 N TOTALDS,RXFILL
"RTN","PSOUTLA1",161,0)
 S TOTALDS=$$GET1^DIQ(52,RXIEN,8)
"RTN","PSOUTLA1",162,0)
 S RXFILL=0
"RTN","PSOUTLA1",163,0)
 F  S RXFILL=$O(^PSRX(RXIEN,1,RXFILL)) Q:'RXFILL  D
"RTN","PSOUTLA1",164,0)
 . S TOTALDS=TOTALDS+$$GET1^DIQ(52.1,RXFILL_","_RXIEN,1.1)
"RTN","PSOUTLA1",165,0)
 Q TOTALDS
"RTN","PSOUTLA1",166,0)
 ;
"RTN","PSOUTLA1",167,0)
REFIP(RXI,RFIL,TYP) ;Check if refill is Not Released and In Process and
"RTN","PSOUTLA1",168,0)
 ;           pending Auto Release by an external dispense machine.
"RTN","PSOUTLA1",169,0)
 ; Input: RXI = internal Prescription no.
"RTN","PSOUTLA1",170,0)
 ;        RFIL= refill number
"RTN","PSOUTLA1",171,0)
 ;        TYP ="R"-refill or "P"-partial
"RTN","PSOUTLA1",172,0)
 ; Returns 1 = In Process      (Not OK to delete)
"RTN","PSOUTLA1",173,0)
 ;         0 = Not In Process  (OK to delete)
"RTN","PSOUTLA1",174,0)
 ;
"RTN","PSOUTLA1",175,0)
 ;assumes a refill is Not In Process by the external dispense machine
"RTN","PSOUTLA1",176,0)
 ;unless it finds a record in this file and is marked to the contrary
"RTN","PSOUTLA1",177,0)
 ;
"RTN","PSOUTLA1",178,0)
 N PSIEN,IP,FOUND,EXDATA,EXDIV
"RTN","PSOUTLA1",179,0)
 S (IP,FOUND)=0,PSIEN=""
"RTN","PSOUTLA1",180,0)
 ;find first specified refill processing backwards, in case dupes
"RTN","PSOUTLA1",181,0)
 F  S PSIEN=$O(^PS(52.51,"B",RXI,PSIEN),-1) Q:PSIEN=""  D  Q:FOUND
"RTN","PSOUTLA1",182,0)
 . S EXDATA=^PS(52.51,PSIEN,0)
"RTN","PSOUTLA1",183,0)
 . I $P(EXDATA,"^",9)=RFIL D
"RTN","PSOUTLA1",184,0)
 . . S EXDIV=$P(EXDATA,"^",11)
"RTN","PSOUTLA1",185,0)
 . . Q:'$P($G(^PS(59,EXDIV,"DISP")),"^",2)     ;quit, not auto release
"RTN","PSOUTLA1",186,0)
 . . S FOUND=1
"RTN","PSOUTLA1",187,0)
 . I FOUND,$P(^PS(52.51,PSIEN,0),"^",10)'=2 S IP=1
"RTN","PSOUTLA1",188,0)
 Q IP
"RTN","PSOUTLA1",189,0)
 ;
"RTN","PSOUTLA1",190,0)
WARN1 ;partial del checks    *259
"RTN","PSOUTLA1",191,0)
 N PSR,PSOL
"RTN","PSOUTLA1",192,0)
 S PSR=0 F  S PSR=$O(^PSRX(DA(1),"P",PSR)) Q:'PSR  S PSOL=PSR
"RTN","PSOUTLA1",193,0)
 I DA=PSOL,$P(^PSRX(DA(1),"P",DA,0),"^",19) D  Q
"RTN","PSOUTLA1",194,0)
 .D EN^DDIOL("Partial Released! Use the 'Return to Stock' option!","","$C(7),!!"),EN^DDIOL(" ","","!")
"RTN","PSOUTLA1",195,0)
 ;
"RTN","PSOUTLA1",196,0)
 ;Warn of In Process, Only delete if answered Yes         ;*259
"RTN","PSOUTLA1",197,0)
 I $$REFIP^PSOUTLA1(DA(1),DA,"P") D  I 'Y Q               ;reset $T
"RTN","PSOUTLA1",198,0)
 . D EN^DDIOL("** Partial refill has previously been sent to the External Dispense Machine","","!!,?2")
"RTN","PSOUTLA1",199,0)
 . D EN^DDIOL("** for filling and is still Pending Processing","","$C(7),!,?2")
"RTN","PSOUTLA1",200,0)
 . D EN^DDIOL("","","!")
"RTN","PSOUTLA1",201,0)
 . K DIR
"RTN","PSOUTLA1",202,0)
 . S DIR("A")="Do you want to continue? "
"RTN","PSOUTLA1",203,0)
 . S DIR("B")="Y"
"RTN","PSOUTLA1",204,0)
 . S DIR(0)="YA^^"
"RTN","PSOUTLA1",205,0)
 . S DIR("?")="Enter Y for Yes or N for No."
"RTN","PSOUTLA1",206,0)
 . D ^DIR
"RTN","PSOUTLA1",207,0)
 . K DIR
"RTN","PSOUTLA1",208,0)
 Q
"UP",52,52.07,-1)
52^RTS
"UP",52,52.07,0)
52.07
"UP",52,52.1,-1)
52^1
"UP",52,52.1,0)
52.1
"VER")
8.0^22.0
"^DD",52,52,8,0)
DAYS SUPPLY^RNJ2,0X^^0;8^K:+X'=X!(X>365)!(X<1)!(X?.E1"."1N.N) X D:$G(X) DAYS^PSOHELP1
"^DD",52,52,8,3)
Type a Number between 1 and 365, 0 Decimal Digits
"^DD",52,52,8,21,0)
^^2^2^3150318^^^^
"^DD",52,52,8,21,1,0)
Enter a whole number between 1 and 365. The maximum upper limit is 365, but may be lower based on the maximum specified for the drug in this prescription. The maximum value for the  drug can be found in the DRUG file (#50) or the VA PRODUCT
"^DD",52,52,8,21,2,0)
file (#50.68) for drugs matched to NDF. 
"^DD",52,52,8,23,0)
^^1^1^2951107^^^^
"^DD",52,52,8,23,1,0)
Numeric.
"^DD",52,52,8,"DT")
3150318
"^DD",52,52.07,4,0)
DAYS SUPPLY^NJ3,0^^0;5^K:+X'=X!(X>365)!(X<1)!(X?.E1"."1.N) X
"^DD",52,52.07,4,3)
Type a number between 1 and 365, 0 decimal digits.
"^DD",52,52.07,4,21,0)
^^1^1^3121212^^
"^DD",52,52.07,4,21,1,0)
This is the number of days of supply dispensed with the fill.
"^DD",52,52.07,4,"DT")
3150318
"^DD",52,52.1,1.1,0)
DAYS SUPPLY^RNJ2,0X^^0;10^K:+X'=X!(X>365)!(X<1)!(X?.E1"."1N.N) X D:$G(X) DAYS1^PSOHELP1
"^DD",52,52.1,1.1,3)
Type a Number between 1 and 365, 0 Decimal Digits
"^DD",52,52.1,1.1,21,0)
^^1^1^2940815^^
"^DD",52,52.1,1.1,21,1,0)
This field is used to show days of supply of refill.
"^DD",52,52.1,1.1,"DT")
3150318
"^DD",52.41,52.41,101,0)
DAYS SUPPLY^NJ3,0^^0;22^K:+X'=X!(X>365)!(X<1)!(X?.E1"."1.N) X
"^DD",52.41,52.41,101,3)
Type a number between 1 and 365, 0 decimal digits.
"^DD",52.41,52.41,101,21,0)
^^2^2^3150318^^
"^DD",52.41,52.41,101,21,1,0)
Enter a whole number between 1 and 365. The maximum upper limit is 365, but may be lower based on the maximum specified for the drug in this pending order. The maximum value for the  drug can be found in the DRUG file (#50) or the VA PRODUCT
"^DD",52.41,52.41,101,21,2,0)
file (#50.68) for drugs matched to NDF.
"^DD",52.41,52.41,101,"DT")
3150318
"BLD",9245,6)
^381
**END**
**END**

