Released PRC*5.1*181 SEQ #160
Extracted from mail message
**KIDS**:PRC*5.1*181^

**INSTALL NAME**
PRC*5.1*181
"BLD",7357,0)
PRC*5.1*181^IFCAP^0^3140115^y
"BLD",7357,1,0)
^^6^6^3140115^
"BLD",7357,1,1,0)
 
"BLD",7357,1,2,0)
 
"BLD",7357,1,3,0)
1. Purchase Card Orders - duplicate transction numbers occur 
"BLD",7357,1,4,0)
 
"BLD",7357,1,5,0)
2. Amendment of purchase order for Prompt Pay Type creates incorrect FCP 
"BLD",7357,1,6,0)
   adjustment as seen on Running Balance report
"BLD",7357,4,0)
^9.64PA^^
"BLD",7357,6.3)
6
"BLD",7357,"ABPKG")
n
"BLD",7357,"KRN",0)
^9.67PA^779.2^20
"BLD",7357,"KRN",.4,0)
.4
"BLD",7357,"KRN",.401,0)
.401
"BLD",7357,"KRN",.402,0)
.402
"BLD",7357,"KRN",.403,0)
.403
"BLD",7357,"KRN",.5,0)
.5
"BLD",7357,"KRN",.84,0)
.84
"BLD",7357,"KRN",3.6,0)
3.6
"BLD",7357,"KRN",3.8,0)
3.8
"BLD",7357,"KRN",9.2,0)
9.2
"BLD",7357,"KRN",9.8,0)
9.8
"BLD",7357,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",7357,"KRN",9.8,"NM",1,0)
PRCH410^^0^B48806860
"BLD",7357,"KRN",9.8,"NM",2,0)
PRCFFUD^^0^B40042829
"BLD",7357,"KRN",9.8,"NM","B","PRCFFUD",2)

"BLD",7357,"KRN",9.8,"NM","B","PRCH410",1)

"BLD",7357,"KRN",19,0)
19
"BLD",7357,"KRN",19.1,0)
19.1
"BLD",7357,"KRN",101,0)
101
"BLD",7357,"KRN",409.61,0)
409.61
"BLD",7357,"KRN",771,0)
771
"BLD",7357,"KRN",779.2,0)
779.2
"BLD",7357,"KRN",870,0)
870
"BLD",7357,"KRN",8989.51,0)
8989.51
"BLD",7357,"KRN",8989.52,0)
8989.52
"BLD",7357,"KRN",8994,0)
8994
"BLD",7357,"KRN","B",.4,.4)

"BLD",7357,"KRN","B",.401,.401)

"BLD",7357,"KRN","B",.402,.402)

"BLD",7357,"KRN","B",.403,.403)

"BLD",7357,"KRN","B",.5,.5)

"BLD",7357,"KRN","B",.84,.84)

"BLD",7357,"KRN","B",3.6,3.6)

"BLD",7357,"KRN","B",3.8,3.8)

"BLD",7357,"KRN","B",9.2,9.2)

"BLD",7357,"KRN","B",9.8,9.8)

"BLD",7357,"KRN","B",19,19)

"BLD",7357,"KRN","B",19.1,19.1)

"BLD",7357,"KRN","B",101,101)

"BLD",7357,"KRN","B",409.61,409.61)

"BLD",7357,"KRN","B",771,771)

"BLD",7357,"KRN","B",779.2,779.2)

"BLD",7357,"KRN","B",870,870)

"BLD",7357,"KRN","B",8989.51,8989.51)

"BLD",7357,"KRN","B",8989.52,8989.52)

"BLD",7357,"KRN","B",8994,8994)

"BLD",7357,"QDEF")
^^^^^^^^^^YES
"BLD",7357,"QUES",0)
^9.62^^
"BLD",7357,"REQB",0)
^9.611^1^1
"BLD",7357,"REQB",1,0)
PRC*5.1*171^2
"BLD",7357,"REQB","B","PRC*5.1*171",1)

"MBREQ")
0
"PKG",455,-1)
1^1
"PKG",455,0)
IFCAP^PRC^IFCAP System Files
"PKG",455,20,0)
^9.402P^^
"PKG",455,22,0)
^9.49I^1^1
"PKG",455,22,1,0)
5.1^3001012^3001019^68
"PKG",455,22,1,"PAH",1,0)
181^3140115
"PKG",455,22,1,"PAH",1,1,0)
^^6^6^3140115
"PKG",455,22,1,"PAH",1,1,1,0)
 
"PKG",455,22,1,"PAH",1,1,2,0)
 
"PKG",455,22,1,"PAH",1,1,3,0)
1. Purchase Card Orders - duplicate transction numbers occur 
"PKG",455,22,1,"PAH",1,1,4,0)
 
"PKG",455,22,1,"PAH",1,1,5,0)
2. Amendment of purchase order for Prompt Pay Type creates incorrect FCP 
"PKG",455,22,1,"PAH",1,1,6,0)
   adjustment as seen on Running Balance report
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PRCFFUD")
0^2^B40042829^B37053317
"RTN","PRCFFUD",1,0)
PRCFFUD ;WISC/SJG-UTILITY FOR CARRY FORWARD ;7/24/00  23:14
"RTN","PRCFFUD",2,0)
V ;;5.1;IFCAP;**181**;Oct 20, 2000;Build 6
"RTN","PRCFFUD",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRCFFUD",4,0)
 ;
"RTN","PRCFFUD",5,0)
 ;PRC*5.1*181 Added calc for regular POs to calc the correct amount
"RTN","PRCFFUD",6,0)
 ;            between original PO and amended PO
"RTN","PRCFFUD",7,0)
 ;
"RTN","PRCFFUD",8,0)
 QUIT
"RTN","PRCFFUD",9,0)
 ; No top level entry
"RTN","PRCFFUD",10,0)
 ;
"RTN","PRCFFUD",11,0)
OBDT() ; Check if obligation processing date is valid for the open quarter
"RTN","PRCFFUD",12,0)
 N GOFLAG,MOP,STNQTR,PODATE,PRIMARY,SDATE1,SDATE2,SDATE3,SDATE4,SPIECE1,SPIECE2,SPIECE3,SPIECE4,RBQTR,AMDDATE
"RTN","PRCFFUD",13,0)
 S GOFLAG=0
"RTN","PRCFFUD",14,0)
 S MOP=$$NP^PRC0B("^PRC(442,"_+PO_",",0,2)
"RTN","PRCFFUD",15,0)
 S PRIMARY=$$NP^PRC0B("^PRC(442,"_+PO_",",0,12)
"RTN","PRCFFUD",16,0)
 S STNQTR=$$NP^PRC0B("^PRC(420,"_+PRC("SITE")_",",0,9)
"RTN","PRCFFUD",17,0)
 ; If obligation is an original entry, use PO date
"RTN","PRCFFUD",18,0)
 ; If obligation is an amendment, use amendment date
"RTN","PRCFFUD",19,0)
 I '$D(PRCFA("AMEND#")) S PODATE=$$NP^PRC0B("^PRC(442,"_+PO_",",1,15)
"RTN","PRCFFUD",20,0)
 I $D(PRCFA("AMEND#")),MOP'=21 D  S PODATE=$G(AMDDATE)
"RTN","PRCFFUD",21,0)
 .; If amendment is initial document, get info from file 443.6
"RTN","PRCFFUD",22,0)
 .I PRCFA("RETRAN")=0 D  Q
"RTN","PRCFFUD",23,0)
 ..N SUBINFO S SUBINFO="443.67^1^"_PRCFA("AMEND#")
"RTN","PRCFFUD",24,0)
 ..K PRCTMP(443.67,PRCFA("AMEND#"),1)
"RTN","PRCFFUD",25,0)
 ..D GENDIQ^PRCFFU7(443.6,PRCFA("PODA"),50,"IEN",SUBINFO)
"RTN","PRCFFUD",26,0)
 ..S AMDDATE=$G(PRCTMP(443.67,PRCFA("AMEND#"),1,"I"))
"RTN","PRCFFUD",27,0)
 ..K PRCTMP(443.67,PRCFA("AMEND#"),1)
"RTN","PRCFFUD",28,0)
 ..Q
"RTN","PRCFFUD",29,0)
 .; If amendment is rebuild, get info from file 442
"RTN","PRCFFUD",30,0)
 .I PRCFA("RETRAN")=1 D  Q
"RTN","PRCFFUD",31,0)
 ..N SUBINFO S SUBINFO="442.07^1^"_PRCFA("AMEND#")
"RTN","PRCFFUD",32,0)
 ..K PRCTMP(442.07,PRCFA("AMEND#"),1)
"RTN","PRCFFUD",33,0)
 ..D GENDIQ^PRCFFU7(442,PRCFA("PODA"),50,"IEN",SUBINFO)
"RTN","PRCFFUD",34,0)
 ..S AMDDATE=$G(PRCTMP(442.07,PRCFA("AMEND#"),1,"I"))
"RTN","PRCFFUD",35,0)
 ..K PRCTMP(442.07,PRCFA("AMEND#"),1)
"RTN","PRCFFUD",36,0)
 ..Q
"RTN","PRCFFUD",37,0)
 .Q
"RTN","PRCFFUD",38,0)
 S SDATE1=$$DATE^PRC0C(PODATE,"I"),SDATE2=$$DATE^PRC0C(PRCFA("OBLDATE"),"I"),SDATE3=$$DATE^PRC0C(STNQTR,"I")
"RTN","PRCFFUD",39,0)
 S SPIECE1=$P(SDATE1,U,1,2),SPIECE2=$P(SDATE2,U,1,2),SPIECE3=$P(SDATE3,U,1,2)
"RTN","PRCFFUD",40,0)
 ; Check if transaction is a 1358
"RTN","PRCFFUD",41,0)
 I MOP=21 D  G QUIT
"RTN","PRCFFUD",42,0)
 .S RBQTR=$$NP^PRC0B("^PRCS(410,"_PRIMARY_",",0,11)
"RTN","PRCFFUD",43,0)
 .S SDATE4=$$DATE^PRC0C(RBQTR,"I"),SPIECE4=$P(SDATE4,U,1,2)
"RTN","PRCFFUD",44,0)
 .I SPIECE2=SPIECE4 S GOFLAG=1 Q
"RTN","PRCFFUD",45,0)
 ; Check if transaction has a 2237 request
"RTN","PRCFFUD",46,0)
 I $G(PRIMARY)="" D  G QUIT
"RTN","PRCFFUD",47,0)
 .; allow PO/oblig date from current qtr
"RTN","PRCFFUD",48,0)
 .I SPIECE1=SPIECE2,SPIECE2=SPIECE3 S GOFLAG=1 Q
"RTN","PRCFFUD",49,0)
 .; allow PO/oblig date for fut qtr if PO date qtr same as oblig qtr
"RTN","PRCFFUD",50,0)
 .I SPIECE3=SPIECE2,SPIECE2]SPIECE1 S GOFLAG=1 Q
"RTN","PRCFFUD",51,0)
 .; allow PO/oblig date for fut qtr if oblig qtr later than stn open qtr
"RTN","PRCFFUD",52,0)
 .I SPIECE2]SPIECE3 S GOFLAG=1 Q
"RTN","PRCFFUD",53,0)
 I $G(PRIMARY)]"" D  G QUIT
"RTN","PRCFFUD",54,0)
 .; allow PO/oblig date from current qtr
"RTN","PRCFFUD",55,0)
 .I SPIECE1=SPIECE2,SPIECE2=SPIECE3 S GOFLAG=1 Q
"RTN","PRCFFUD",56,0)
 .; allow PO/oblig date from future qtr
"RTN","PRCFFUD",57,0)
 .I SPIECE1=SPIECE2,SPIECE2]SPIECE3 S GOFLAG=1 Q
"RTN","PRCFFUD",58,0)
 .; allow PO/oblig date from prior qtr if open qtr same as oblig qtr
"RTN","PRCFFUD",59,0)
 .I SPIECE2=SPIECE3,SPIECE3]SPIECE1 S GOFLAG=1 Q
"RTN","PRCFFUD",60,0)
QUIT QUIT GOFLAG
"RTN","PRCFFUD",61,0)
 ;
"RTN","PRCFFUD",62,0)
NEW410 ; Create an entry in File 410 for any PO that does not have a request
"RTN","PRCFFUD",63,0)
 Q:$G(PRCFA("RETRAN"))=1
"RTN","PRCFFUD",64,0)
 W ! D EN^DDIOL("...now creating entry in File 410...")
"RTN","PRCFFUD",65,0)
 N POAMT,P410,NEW410
"RTN","PRCFFUD",66,0)
 S POAMT=+$S($P(PRCFMO,"^",12)="N":$P(PO(0),"^",16),1:$P(PO(0),"^",15))
"RTN","PRCFFUD",67,0)
 S P410=+PRCFA("REF")_U_+$P(PO(0),U,3)_U_"A"_U_2_U_PRCFA("OBLDATE")_U_POAMT_U_$P(PRCFA("REF"),"-",2)_"WR"_U_"ST"_U_+PO
"RTN","PRCFFUD",68,0)
 S $P(P410,U,10,11)=PRC("FYQDT")_U_PRC("BBFY")
"RTN","PRCFFUD",69,0)
 D A410^PRC0F(.NEW410,P410) S PRCFA("NEW410")=NEW410
"RTN","PRCFFUD",70,0)
 QUIT
"RTN","PRCFFUD",71,0)
 ;
"RTN","PRCFFUD",72,0)
AMEND ; Create an entry in File 410 for each amendment to a purchase order
"RTN","PRCFFUD",73,0)
 ; Case 1 - amendment with no cancelled documents
"RTN","PRCFFUD",74,0)
 Q:$G(PRCFA("RETRAN"))=1
"RTN","PRCFFUD",75,0)
 N AMDEXT S AMDEXT="-"_$G(PRCFA("AMEND#"))
"RTN","PRCFFUD",76,0)
 W ! D EN^DDIOL("...now creating entry in File 410 for the amendment...")
"RTN","PRCFFUD",77,0)
 I '$D(PRCFA("CANCEL")) D  Q
"RTN","PRCFFUD",78,0)
 .N AMDAMT,P410,NEW410 S AMDAMT=$$AMDAMT()
"RTN","PRCFFUD",79,0)
 .S P410=+PRCFA("REF")_U_+$P(PO(0),U,3)_U_"A"_U_2_U_PRCFA("OBLDATE")_U_AMDAMT_U_$P(PRCFA("REF"),"-",2)_AMDEXT_U_"ST"_U_+PO
"RTN","PRCFFUD",80,0)
 .S $P(P410,U,10,11)=PRC("FYQDT")_U_PRC("BBFY")
"RTN","PRCFFUD",81,0)
 .I $G(PRCHAUTH)'=1,$P(^PRC(442,PRCHPO,0),U,2)'=25 D
"RTN","PRCFFUD",82,0)
 ..S $P(P410,U,6)=$P(^PRC(442,PRCFA("PODA"),0),U,16)-$P(PO(0),U,16)    ;PRC*5.1*181 Fix for 410 adj between amend $$ and prior PO $$
"RTN","PRCFFUD",83,0)
 .D A410^PRC0F(.NEW410,P410) S PRCFA("NEW410")=NEW410
"RTN","PRCFFUD",84,0)
 .Q
"RTN","PRCFFUD",85,0)
 ; Case 2 - amendment types: vendor change, FCP change, PO number change
"RTN","PRCFFUD",86,0)
 I $D(PRCFA("CANCEL")),'PRCFA("AUTHE") D  Q
"RTN","PRCFFUD",87,0)
 .; First update for the old record
"RTN","PRCFFUD",88,0)
 .N AMDAMT,POREF,AMDNO,FCP,OLDFCP
"RTN","PRCFFUD",89,0)
 .S AMDAMT=$$AMDAMT1()
"RTN","PRCFFUD",90,0)
 .I $G(PRCFA("PO"))=1 S POREF=PRCFA("OLDPODA")_U_PRCFA("OLDREF")
"RTN","PRCFFUD",91,0)
 .I $G(PRCFA("PO"))="" S POREF=PRCFA("PODA")_U_PRCFA("REF")
"RTN","PRCFFUD",92,0)
 .I $G(PRCFA("FCP"))=1 D  S FCP=+OLDFCP
"RTN","PRCFFUD",93,0)
 ..N LOOP ; "AC" cross ref sorts changes by field# (1=FCP) and amendment type (30=FCP edit)
"RTN","PRCFFUD",94,0)
 ..S LOOP=$O(^PRC(442,PRCFA("PODA"),6,PRCFA("AMEND#"),3,"AC",30,1,0))
"RTN","PRCFFUD",95,0)
 ..I LOOP]"" S OLDFCP=^PRC(442,PRCFA("PODA"),6,PRCFA("AMEND#"),3,LOOP,1,1,0)
"RTN","PRCFFUD",96,0)
 ..Q
"RTN","PRCFFUD",97,0)
 .I $G(PRCFA("FCP"))="" S FCP=+$P(PO(0),U,3)
"RTN","PRCFFUD",98,0)
 .S P410=+$P(POREF,U,2)_U_FCP_U_"A"_U_2_U_PRCFA("OBLDATE")_U_AMDAMT_U_$P($P(POREF,U,2),"-",2)_AMDEXT_U_"ST"_U_+POREF
"RTN","PRCFFUD",99,0)
 .S $P(P410,U,10,11)=PRC("FYQDT")_U_PRC("BBFY")
"RTN","PRCFFUD",100,0)
 .D A410^PRC0F(.NEW410,P410)
"RTN","PRCFFUD",101,0)
 .; Then update for new record
"RTN","PRCFFUD",102,0)
 .S AMDAMT=-AMDAMT
"RTN","PRCFFUD",103,0)
 .I $G(PRCFA("PO"))=1 S POREF=PRCFA("NEWPODA")_U_PRCFA("NEWREF"),AMDEXT=""
"RTN","PRCFFUD",104,0)
 .I $G(PRCFA("PO"))="" S POREF=PRCFA("PODA")_U_PRCFA("REF")
"RTN","PRCFFUD",105,0)
 .S P410=+$P(POREF,U,2)_U_+$P(PO(0),U,3)_U_"A"_U_2_U_PRCFA("OBLDATE")_U_AMDAMT_U_$P($P(POREF,U,2),"-",2)_AMDEXT_U_"ST"_U_+POREF
"RTN","PRCFFUD",106,0)
 .S $P(P410,U,10,11)=PRC("FYQDT")_U_PRC("BBFY")
"RTN","PRCFFUD",107,0)
 .D A410^PRC0F(.NEW410,P410)
"RTN","PRCFFUD",108,0)
 .Q
"RTN","PRCFFUD",109,0)
 ; Case 3 - amendments type - cancel by Authority E
"RTN","PRCFFUD",110,0)
 I $D(PRCFA("CANCEL")),PRCFA("AUTHE") D  Q
"RTN","PRCFFUD",111,0)
 .N AMDAMT S AMDAMT=$$AMDAMT1(),AMDEXT=AMDEXT_"#"
"RTN","PRCFFUD",112,0)
 .S P410=+PRCFA("REF")_U_+$P(PO(0),U,3)_U_"A"_U_2_U_PRCFA("OBLDATE")_U_AMDAMT_U_$P(PRCFA("REF"),"-",2)_AMDEXT_U_"ST"_U_+PO
"RTN","PRCFFUD",113,0)
 .S $P(P410,U,10,11)=PRC("FYQDT")_U_PRC("BBFY")
"RTN","PRCFFUD",114,0)
 .D A410^PRC0F(.NEW410,P410) S PRCFA("NEW410")=NEW410
"RTN","PRCFFUD",115,0)
 .Q
"RTN","PRCFFUD",116,0)
 QUIT
"RTN","PRCFFUD",117,0)
PO ; Updating Running Balance Status Field (#449) in File 410 for 
"RTN","PRCFFUD",118,0)
 ; purchase order
"RTN","PRCFFUD",119,0)
 Q:$G(PRCFA("RETRAN"))=1
"RTN","PRCFFUD",120,0)
 Q:$G(PRCTMP(442,+PO,.07,"I"))=""
"RTN","PRCFFUD",121,0)
 I $G(PRCTMP(442,+PO,.07,"I"))]""  D  Q
"RTN","PRCFFUD",122,0)
 .W !!,"...updating running balance status fields in 410...WITH 2237"
"RTN","PRCFFUD",123,0)
 .N LOOP S LOOP=0
"RTN","PRCFFUD",124,0)
 .F  S LOOP=$O(^PRC(442,+PO,13,LOOP)) Q:LOOP=""!(LOOP'>0)  I LOOP>0 D EDIT410(LOOP,"O")
"RTN","PRCFFUD",125,0)
 .Q
"RTN","PRCFFUD",126,0)
 QUIT
"RTN","PRCFFUD",127,0)
AMD ; Updating Running Balance Status Field (#449) in File 410 for
"RTN","PRCFFUD",128,0)
 ; purchase order amendment
"RTN","PRCFFUD",129,0)
 Q:$G(PRCFA("RETRAN"))=1
"RTN","PRCFFUD",130,0)
 W !!,"...updating running balance status fields in 410...FOR AMENDMENT"
"RTN","PRCFFUD",131,0)
 D EDIT410(NEW410,"O")
"RTN","PRCFFUD",132,0)
 QUIT
"RTN","PRCFFUD",133,0)
 ;
"RTN","PRCFFUD",134,0)
EDIT410(TRDAIEN,TRSTAT) ; Edit running balance status and running balance quarter fields in 410
"RTN","PRCFFUD",135,0)
 D ERS410^PRC0G(TRDAIEN_"^"_TRSTAT)
"RTN","PRCFFUD",136,0)
 QUIT
"RTN","PRCFFUD",137,0)
 ;
"RTN","PRCFFUD",138,0)
 ; Message processing
"RTN","PRCFFUD",139,0)
AMDAMT() ; Get dollar amount for AMENDMENT from amendment multiple
"RTN","PRCFFUD",140,0)
 N SUBINFO,AMDAMT S SUBINFO="442.07^2^"_PRCFA("AMEND#")
"RTN","PRCFFUD",141,0)
 D GENDIQ^PRCFFU7(442,PRCFA("PODA"),50,"IEN",SUBINFO)
"RTN","PRCFFUD",142,0)
 S AMDAMT=$G(PRCTMP(442.07,PRCFA("AMEND#"),2,"E"))
"RTN","PRCFFUD",143,0)
 Q AMDAMT
"RTN","PRCFFUD",144,0)
AMDAMT1() ; Get dollar amount for AMENDMENT from zero node
"RTN","PRCFFUD",145,0)
 N AMDAMT
"RTN","PRCFFUD",146,0)
 S AMDAMT=-$S($P(PRCFMO,"^",12)="N":$P(PO(0),"^",16),1:$P(PO(0),"^",15))
"RTN","PRCFFUD",147,0)
 Q AMDAMT
"RTN","PRCFFUD",148,0)
MSG1 ;
"RTN","PRCFFUD",149,0)
 K MSG W !
"RTN","PRCFFUD",150,0)
 S MSG(1)="The Obligation Processing Date is not a valid date for this transaction."
"RTN","PRCFFUD",151,0)
 S MSG(2)="Please enter a date which matches the requests or p.o. quarter."
"RTN","PRCFFUD",152,0)
 D EN^DDIOL(.MSG) K MSG W !
"RTN","PRCFFUD",153,0)
 QUIT
"RTN","PRCH410")
0^1^B48806860^B43608419
"RTN","PRCH410",1,0)
PRCH410 ;WISC/KMB/DXH/DGL - CREATE 2237 FROM PURCHASE CARD ORDER ; 4/4/00 7:56am
"RTN","PRCH410",2,0)
 ;;5.1;IFCAP;**123,171,181**;Oct 20, 2000;Build 6
"RTN","PRCH410",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRCH410",4,0)
 ;
"RTN","PRCH410",5,0)
 ; prcsip is package-wide variable for inv pt that may or may not be
"RTN","PRCH410",6,0)
 ; passed to this routine
"RTN","PRCH410",7,0)
 ;
"RTN","PRCH410",8,0)
 ;PRC*5.1*181 Split the update for setting File 442, node 23 piece 23
"RTN","PRCH410",9,0)
 ;            (410 pointer) and piece 13 (sort group) into two sets,
"RTN","PRCH410",10,0)
 ;            410 pointer before the Sort Group query and Sort Group
"RTN","PRCH410",11,0)
 ;            after. This eliminates a user crashing at Sort Group
"RTN","PRCH410",12,0)
 ;            query and creating 2 410 entries due to missing 410 
"RTN","PRCH410",13,0)
 ;            pointer in file 442 that was not set due to Sort
"RTN","PRCH410",14,0)
 ;            Group query failure. 
"RTN","PRCH410",15,0)
 ;
"RTN","PRCH410",16,0)
START ;
"RTN","PRCH410",17,0)
 N VV,ST,Y,Z,Z0,Z1,Z2,I,J,CCEN,ESTS,NET,SERV,EMER,COUNT,COUNT1,L,PDUZ,FY,QTR,CP,LOC,ADATE,TDATE,SDATE,LL,PC,PCREF,XDA
"RTN","PRCH410",18,0)
 N SCP,SGRP,COR,VEN,VEND
"RTN","PRCH410",19,0)
 Q:'$D(DA)  Q:+DA=0  S XDA=DA
"RTN","PRCH410",20,0)
 S Z0=$G(^PRC(442,XDA,0)),PRC("SITE")=$P(Z0,"-"),CP=$P(Z0,"^",3),SCP=$P(CP," "),PRC("SST")=$P($G(^PRC(442,XDA,23)),"^",7),PCREF=$P(Z0,"^"),PCREF=$P(PCREF,"-",2)
"RTN","PRCH410",21,0)
 S TDATE=$$DATE^PRC0C($P($G(^PRC(442,XDA,1)),"^",15),"I"),PRC("FY")=$E(TDATE,3,4),PRC("QTR")=$P(TDATE,"^",2),(TDATE,SDATE)=$P($$DATE^PRC0C("T","E"),"^",7)
"RTN","PRCH410",22,0)
 S CCEN=$P(Z0,"^",5),ESTS=$P(Z0,"^",13),ADATE=$P(Z0,"^",10)
"RTN","PRCH410",23,0)
 I CCEN'="" S CCEN=$E($P(^PRCD(420.1,CCEN,0),"^"),1,30)
"RTN","PRCH410",24,0)
 S Z1=$G(^PRC(442,XDA,1)),(VV,VEND)=$P(Z1,"^"),SERV=$P(Z1,"^",2),EMER=$P(Z1,"^",17),LOC=$P(Z1,"^",11),PDUZ=DUZ
"RTN","PRCH410",25,0)
 S ST="ST" S:EMER="Y" ST="EM"
"RTN","PRCH410",26,0)
 S PRC("CP")=+SCP
"RTN","PRCH410",27,0)
 I $G(PRCSIP) I '$O(^PRC(420,PRC("SITE"),1,PRC("CP"),7,"B",PRCSIP,0)) K PRCSIP ; Kill inventory point if not match FCP
"RTN","PRCH410",28,0)
 I '$G(PRCSIP) S J=0 F  S J=$O(^PRC(442,XDA,2,J)) Q:'J!($G(PRCSIP))  S K=0 F  S K=$O(^PRC(442,XDA,2,J,5,0)) Q:'K!($G(PRCSIP))  S PRCSIP=$P($G(^PRC(442,XDA,2,J,5,K,0)),U)
"RTN","PRCH410",29,0)
IP D:'$G(PRCSIP) IP^PRCSUT
"RTN","PRCH410",30,0)
 I '$G(PRCSIP),$O(^PRC(420,PRC("SITE"),1,PRC("CP"),7,0)) D  I Y=0 G IP
"RTN","PRCH410",31,0)
 . K DIR S DIR("A")="** WARNING ** No inventory point selected - Continue anyway",DIR("B")="NO",DIR(0)="Y"
"RTN","PRCH410",32,0)
 . S DIR("?",1)="The FCP you entered has Inventory points associated with it, but none have been selected."
"RTN","PRCH410",33,0)
 . S DIR("?")="Press 'Y' to return to the inventory point prompt or 'N' to continue the order without one."
"RTN","PRCH410",34,0)
 . D ^DIR K DIR
"RTN","PRCH410",35,0)
 . I $E(X)="^"!(Y=1) W !,"No inventory point was attached.",! Q
"RTN","PRCH410",36,0)
 . Q
"RTN","PRCH410",37,0)
 S PC=$P($G(^PRC(442,XDA,23)),"^",8)
"RTN","PRCH410",38,0)
 S COUNT=$P($G(^PRC(442,XDA,2,0)),"^",4) I +COUNT'=0 D ITEM I $G(X)="#",$G(PRCRMPR)=1 Q
"RTN","PRCH410",39,0)
 S CDA=$P($G(^PRC(442,XDA,23)),"^",23)
"RTN","PRCH410",40,0)
 S:$G(PRCHPC)=3 CDA=$P($G(^PRC(442,XDA,13,0)),U,3)
"RTN","PRCH410",41,0)
 I CDA="" D REC Q:CDA=""
"RTN","PRCH410",42,0)
 S CCDA=CDA
"RTN","PRCH410",43,0)
SET ;set item data and vendor on record
"RTN","PRCH410",44,0)
 L +^PRCS(410,CDA):15 Q:'$T
"RTN","PRCH410",45,0)
 ;
"RTN","PRCH410",46,0)
 I VEND'="",$P($G(^PRC(440,VEND,0)),"^")'="SIMPLIFIED" S ^PRCS(410,CDA,2)=$G(^PRC(440,VEND,0))
"RTN","PRCH410",47,0)
 I $P($G(^PRC(440,+VEND,0)),"^")="SIMPLIFIED" S VEND="SIMPLIFIED" S:$P($G(^PRC(442,XDA,24)),"^",2)'="" VEND=$P($G(^PRC(442,XDA,24)),"^",2) S ^PRCS(410,CDA,2)=VEND
"RTN","PRCH410",48,0)
 S VEN=$P(^PRCS(410,CDA,2),"^")
"RTN","PRCH410",49,0)
 S COR=$P($G(^PRC(442,XDA,23)),"^",12),SGRP=$P($G(^PRC(442,XDA,23)),"^",13)
"RTN","PRCH410",50,0)
 S DA=CDA,DIE="^PRCS(410,",DR="3////4"_";"_"5///"_TDATE_";"_"7////"_SDATE_";"_"15////"_CP_";"_"15.5////"_CCEN_";"_"21////"_TDATE_";"_"12////"_VV D ^DIE
"RTN","PRCH410",51,0)
 S DR="1////O"_";"_"6.3////"_SERV_";"_"7.5////"_ST_";"_"40////"_DUZ_";"_"68////"_DUZ_";"_"8////"_COR D ^DIE
"RTN","PRCH410",52,0)
 S DR="46////^S X=LOC"_";"_"47////"_ADATE_";"_"48.1////"_ESTS_";"_"52///"_XDA_";"_"24///"_PCREF D ^DIE
"RTN","PRCH410",53,0)
 I $G(PRCSIP) S DR="4////^S X=PRCSIP" D ^DIE
"RTN","PRCH410",54,0)
 I PC="" S PC=9999999
"RTN","PRCH410",55,0)
 S DR="451////^S X=PC" D ^DIE
"RTN","PRCH410",56,0)
 I +COUNT'=0 F IT=1:1:COUNT D
"RTN","PRCH410",57,0)
 .S ^PRCS(410,CDA,"IT",IT,0)=BB(IT)
"RTN","PRCH410",58,0)
 .I +COUNT1'=0 F J=1:1:COUNT1 D
"RTN","PRCH410",59,0)
 ..S:$D(BB(IT,J)) ^PRCS(410,CDA,"IT",IT,1,J,0)=BB(IT,J)
"RTN","PRCH410",60,0)
 .I COUNT1="" S ^PRCS(410,CDA,"IT",IT,1,0)="^^1^1^"_TDATE_"^^"
"RTN","PRCH410",61,0)
 .F LL="AB","B" S ^PRCS(410,CDA,"IT",LL,IT,IT)=""
"RTN","PRCH410",62,0)
 .I $P(BB(IT),"^",4)'="" S ^PRCS(410,CDA,"IT","AG",$P(BB(IT),"^",4),IT)=""
"RTN","PRCH410",63,0)
 .S:+COUNT1'=0 ^PRCS(410,CDA,"IT",IT,1,0)="^410.03^"_COUNT1_"^"_COUNT1
"RTN","PRCH410",64,0)
 I $D(VEN) S ^PRCS(410,"E",$E(VEN,1,30),CDA)=""
"RTN","PRCH410",65,0)
 S ^PRCS(410,"AQ",1,CDA)="" S:COUNT'="" ^PRCS(410,CDA,"IT",0)="^410.02AI^"_COUNT_"^"_COUNT
"RTN","PRCH410",66,0)
 L +^PRC(442,XDA):$S(DILOCKTM>15:DILOCKTM,1:15) Q:'$T  S $P(^PRC(442,XDA,23),"^",23)=CDA L -^PRC(442,XDA)   ;PRC*5.1*181  Set 410 pointer prior to Sort Group query
"RTN","PRCH410",67,0)
 I '$G(PRCPROST),$G(RPUSE)'=1,$G(COMMENT)'="delivery",$G(PRCHPC)'="" S DA=CDA,DR=49 D ^DIE
"RTN","PRCH410",68,0)
 L -^PRCS(410,CDA)
"RTN","PRCH410",69,0)
 L +^PRC(442,XDA):15 Q:'$T  S $P(^PRC(442,XDA,23),"^",13)=$P($G(^PRCS(410,CDA,11)),"^") L -^PRC(442,XDA)
"RTN","PRCH410",70,0)
 S DA=XDA K DIE QUIT
"RTN","PRCH410",71,0)
ITEM ;
"RTN","PRCH410",72,0)
 F IT=1:1:COUNT D
"RTN","PRCH410",73,0)
 .F J=1,2,3,4,5,6,8 S $P(BB(IT),"^",J)=$P($G(^PRC(442,XDA,2,IT,0)),"^",J)
"RTN","PRCH410",74,0)
 .S $P(BB(IT),"^",7)=$P($G(^PRC(442,XDA,2,IT,0)),"^",9)
"RTN","PRCH410",75,0)
 .S COUNT1=$P($G(^PRC(442,XDA,2,IT,1,0)),"^",4) I +COUNT1'=0 F J=1:1:COUNT1 S BB(IT,J)=$G(^PRC(442,XDA,2,IT,1,J,0))
"RTN","PRCH410",76,0)
 QUIT
"RTN","PRCH410",77,0)
REC ;create skeleton 410 record
"RTN","PRCH410",78,0)
 S:$G(XDA)'="" PRC("CP")=$P($G(^PRC(442,XDA,0)),U,3)
"RTN","PRCH410",79,0)
 Q:+$G(PRC("CP"))=0
"RTN","PRCH410",80,0)
 S T(2)="",Z=PRC("SITE")_"-"_PRC("FY")_"-"_PRC("QTR")_"-"_$P(PRC("CP")," ")
"RTN","PRCH410",81,0)
 S PRC("BBFY")=$$BBFY^PRCSUT(PRC("SITE"),PRC("FY"),$P(PRC("CP")," "),1)
"RTN","PRCH410",82,0)
 S X=$P(Z,"-",1,2)_"-"_$P(PRC("CP")," ")
"RTN","PRCH410",83,0)
 D EN1^PRCSUT3 Q:'$D(X)  Q:$G(X)="#"&($G(PRCRMPR)=1)  S X1=X D EN2^PRCSUT3 Q:$G(DA)=""  Q:'$D(X1)  S CDA=DA
"RTN","PRCH410",84,0)
 K X,T(2) QUIT
"RTN","PRCH410",85,0)
ESIG ;put ESIG on record, update due-ins
"RTN","PRCH410",86,0)
 N PRCHOBL     ;PRC*171 D.O. auto obligate flags
"RTN","PRCH410",87,0)
 S NET=$P($G(^PRC(442,PODA,0)),"^",15) L +^PRCS(410,DA):15 Q:'$T  F I=1,8 S $P(^PRCS(410,DA,4),"^",I)=NET
"RTN","PRCH410",88,0)
 I $D(PRCHDELV) D SWCHK   ;PRC*171 D.O. auto obligate check for EDI and All/Delivery flags on
"RTN","PRCH410",89,0)
 I $D(PRCHDELV),PRCHOBL=1 S $P(^PRCS(410,DA,4),"^",3)=NET,$P(^PRCS(410,DA,4),"^",4)=$P(^PRCS(410,DA,1),"^")   ;PRC*171 auto obligate sets for D.O. flag sets
"RTN","PRCH410",90,0)
 S:'$D(PRC("CP")) ZIP=$P(^PRC(442,PODA,0),"^",3),PRC("CP")=$P(ZIP," ") Q:PRC("CP")=""
"RTN","PRCH410",91,0)
 S BAL=$P($G(^PRC(420,PRC("SITE"),1,+PRC("CP"),4,PRC("FY"),0)),"^",PRC("QTR")+1)
"RTN","PRCH410",92,0)
 L -^PRCS(410,DA)
"RTN","PRCH410",93,0)
 D ERS410^PRC0G(DA_"^A")
"RTN","PRCH410",94,0)
 S MESSAGE="" D ENCODE^PRCSC1(DA,DUZ,.MESSAGE)
"RTN","PRCH410",95,0)
 S:'$D(PRC("CP")) ZIP=$P(^PRC(442,PODA,0),"^",3),PRC("CP")=$P(ZIP," ") Q:PRC("CP")=""
"RTN","PRCH410",96,0)
 D:'$D(PRC("FY")) FY^PRCH442
"RTN","PRCH410",97,0)
 N KTEMP S KTEMP=X
"RTN","PRCH410",98,0)
 S AA=PRC("SITE")_"^"_+PRC("CP")_"^"_PRC("FY")_"^"_PRC("QTR")_"^"_NET D EBAL^PRCSEZ(AA,"C") I $D(PRCHDELV),PRCHOBL=1 D EBAL^PRCSEZ(AA,"O")   ;PRC*171 auto obligate sets for D.O. flag sets
"RTN","PRCH410",99,0)
 S X=KTEMP
"RTN","PRCH410",100,0)
 S BAL=$P($G(^PRC(420,PRC("SITE"),1,+PRC("CP"),4,PRC("FY"),0)),"^",PRC("QTR")+1)
"RTN","PRCH410",101,0)
 W !,"Cost of this request: $",$J(X,0,2),!,"Current Control Point Balance: $",$J(BAL,0,2),!
"RTN","PRCH410",102,0)
 S PRCSN=$G(^PRCS(410,DA,0))
"RTN","PRCH410",103,0)
 I $P(PRCSN,U,4)>1 S X=$P(PRCSN,U,1),DIC="^PRC(443,",DIC(0)="L",DLAYGO=443 D ^DIC K DIC,DLAYGO,X
"RTN","PRCH410",104,0)
 I $P(PRCSN,U,4)>1 S X=$O(^PRCD(442.3,"C",60,0)) S $P(^PRC(443,DA,0),U,7)=X,^PRC(443,"AC",X,DA)="",$P(^PRC(443,DA,0),U,11)=$P(PRCSN,U,6)
"RTN","PRCH410",105,0)
 I '$G(PRCHPHAM),$G(PRCHPC)'=1 D EN2^PRCPWI
"RTN","PRCH410",106,0)
 S PRCSINV=$P(^PRCS(410,DA,0),U,6)
"RTN","PRCH410",107,0)
 S DIE="^PRC(443,",DR="9///^S X=1;10///^S X=4;11////^S X=PRCSINV;13///^S X=""E"";3.7///^S X=5730;3.5///^S X=1;2////^S X=DUZ"
"RTN","PRCH410",108,0)
 D ^DIE K DIE,DR
"RTN","PRCH410",109,0)
 S BAL=$P($G(^PRC(420,PRC("SITE"),1,+PRC("CP"),4,PRC("FY"),0)),"^",PRC("QTR")+1)
"RTN","PRCH410",110,0)
 D ES1^PRCHG
"RTN","PRCH410",111,0)
 S PRCHSY(0)=^PRC(443,CDA,0) ;After Signature use 443 entry
"RTN","PRCH410",112,0)
 S PRCHS="",PRCHSY=DA,PRCHSP="" D LST1^PRCHNPO2
"RTN","PRCH410",113,0)
 S BAL=$P($G(^PRC(420,PRC("SITE"),1,+PRC("CP"),4,PRC("FY"),0)),"^",PRC("QTR")+1)
"RTN","PRCH410",114,0)
 S DA=CDA,DIK="^PRC(443," D ^DIK K DIK
"RTN","PRCH410",115,0)
 K BAL,ZIP,PRCSN,X,MESSAGE QUIT
"RTN","PRCH410",116,0)
SWCHK ;CHECK EDI AND ALL/DEL FLAGS FOR DELIVERY ORDERS    ;PRC*171 D.O. auto obligate check for EDI and All/Delivery flags on
"RTN","PRCH410",117,0)
 N PRCHFUND,PRCEDICK,PRCVEND
"RTN","PRCH410",118,0)
 S PRCHOBL=0
"RTN","PRCH410",119,0)
 S PRCVEND=$P($G(^PRC(442,PODA,1)),U) S:PRCVEND'="" PRCEDICK=$P($G(^PRC(440,PRCVEND,3)),U,2)
"RTN","PRCH410",120,0)
 S PRCHFUND=$P(^PRC(442,PODA,0),U,3) Q:PRCHFUND=""  S PRCHFUND=+$P(PRCHFUND," ")
"RTN","PRCH410",121,0)
 I $P($G(^PRC(442,PODA,23)),U,11)="D"!$D(PRCHDELV) D
"RTN","PRCH410",122,0)
 . I $P($G(^PRC(420,PRC("SITE"),3)),U,2)="",$P($G(^PRC(420,PRC("SITE"),1,PRCHFUND,6)),U,2)="" S PRCHOBL=0
"RTN","PRCH410",123,0)
 . I $P(^PRC(442,PODA,0),U,2)=26 S PRCHOBL=1
"RTN","PRCH410",124,0)
 I '$G(PRCHOBL) D
"RTN","PRCH410",125,0)
 . I ($P($G(^PRC(420,PRC("SITE"),1,PRCHFUND,6)),U)="Y")!($P($G(^PRC(420,PRC("SITE"),3)),U)="Y"),PRCEDICK="Y" S PRCHOBL=1
"RTN","PRCH410",126,0)
 Q
"VER")
8.0^22.0
"BLD",7357,6)
^160
**END**
**END**

