EMERGENCY Released IVM*2*177 SEQ #147
Extracted from mail message
**KIDS**:IVM*2.0*177^

**INSTALL NAME**
IVM*2.0*177
"BLD",10904,0)
IVM*2.0*177^INCOME VERIFICATION MATCH^0^3181228^y
"BLD",10904,1,0)
^^1^1^3181128^^^
"BLD",10904,1,1,0)
Please refer to the Patch Description in FORUM for patch IVM*2.0*177
"BLD",10904,4,0)
^9.64PA^^
"BLD",10904,6.3)
3
"BLD",10904,"ABPKG")
n
"BLD",10904,"INIT")

"BLD",10904,"KRN",0)
^9.67PA^779.2^20
"BLD",10904,"KRN",.4,0)
.4
"BLD",10904,"KRN",.401,0)
.401
"BLD",10904,"KRN",.402,0)
.402
"BLD",10904,"KRN",.403,0)
.403
"BLD",10904,"KRN",.5,0)
.5
"BLD",10904,"KRN",.84,0)
.84
"BLD",10904,"KRN",3.6,0)
3.6
"BLD",10904,"KRN",3.8,0)
3.8
"BLD",10904,"KRN",9.2,0)
9.2
"BLD",10904,"KRN",9.8,0)
9.8
"BLD",10904,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",10904,"KRN",9.8,"NM",1,0)
IVMLDEM9^^0^B65121028
"BLD",10904,"KRN",9.8,"NM",2,0)
IVMLDEM6^^0^B99598805
"BLD",10904,"KRN",9.8,"NM","B","IVMLDEM6",2)

"BLD",10904,"KRN",9.8,"NM","B","IVMLDEM9",1)

"BLD",10904,"KRN",19,0)
19
"BLD",10904,"KRN",19,"NM",0)
^9.68A^^
"BLD",10904,"KRN",19.1,0)
19.1
"BLD",10904,"KRN",101,0)
101
"BLD",10904,"KRN",409.61,0)
409.61
"BLD",10904,"KRN",771,0)
771
"BLD",10904,"KRN",779.2,0)
779.2
"BLD",10904,"KRN",870,0)
870
"BLD",10904,"KRN",8989.51,0)
8989.51
"BLD",10904,"KRN",8989.52,0)
8989.52
"BLD",10904,"KRN",8994,0)
8994
"BLD",10904,"KRN","B",.4,.4)

"BLD",10904,"KRN","B",.401,.401)

"BLD",10904,"KRN","B",.402,.402)

"BLD",10904,"KRN","B",.403,.403)

"BLD",10904,"KRN","B",.5,.5)

"BLD",10904,"KRN","B",.84,.84)

"BLD",10904,"KRN","B",3.6,3.6)

"BLD",10904,"KRN","B",3.8,3.8)

"BLD",10904,"KRN","B",9.2,9.2)

"BLD",10904,"KRN","B",9.8,9.8)

"BLD",10904,"KRN","B",19,19)

"BLD",10904,"KRN","B",19.1,19.1)

"BLD",10904,"KRN","B",101,101)

"BLD",10904,"KRN","B",409.61,409.61)

"BLD",10904,"KRN","B",771,771)

"BLD",10904,"KRN","B",779.2,779.2)

"BLD",10904,"KRN","B",870,870)

"BLD",10904,"KRN","B",8989.51,8989.51)

"BLD",10904,"KRN","B",8989.52,8989.52)

"BLD",10904,"KRN","B",8994,8994)

"BLD",10904,"QDEF")
^^^^NO^^^^NO^^YES
"BLD",10904,"QUES",0)
^9.62^^
"BLD",10904,"REQB",0)
^9.611^1^1
"BLD",10904,"REQB",1,0)
IVM*2.0*164^1
"BLD",10904,"REQB","B","IVM*2.0*164",1)

"MBREQ")
0
"PKG",120,-1)
1^1
"PKG",120,0)
INCOME VERIFICATION MATCH^IVM^IVM Software for interface with the IVM Center
"PKG",120,20,0)
^9.402P^^
"PKG",120,22,0)
^9.49I^1^1
"PKG",120,22,1,0)
2.0^2941021^2960823
"PKG",120,22,1,"PAH",1,0)
177^3181228
"PKG",120,22,1,"PAH",1,1,0)
^^1^1^3181228
"PKG",120,22,1,"PAH",1,1,1,0)
Please refer to the Patch Description in FORUM for patch IVM*2.0*177
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","IVMLDEM6")
0^2^B99598805^B100336132
"RTN","IVMLDEM6",1,0)
IVMLDEM6 ;ALB/KCL,BRM,PHH,CKN,LBD,KUM - IVM DEMOGRAPHIC UPLOAD FILE ADDRESS ;11/16/18 8:24pm
"RTN","IVMLDEM6",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**10,58,73,79,108,106,105,124,115,152,164,177**;21-OCT-94;Build 3
"RTN","IVMLDEM6",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IVMLDEM6",4,0)
 ;
"RTN","IVMLDEM6",5,0)
 ;
"RTN","IVMLDEM6",6,0)
ADDR(DFN,IVMDA2,IVMDA1,IVMDA,IVMPPICK) ; - function to check if uploadable field
"RTN","IVMLDEM6",7,0)
 ;                          is an address field and return a flag
"RTN","IVMLDEM6",8,0)
 ;
"RTN","IVMLDEM6",9,0)
 ;  Input:      DFN  -  as patient IEN
"RTN","IVMLDEM6",10,0)
 ;           IVMDA2  -  pointer to case record in (#301.5) file
"RTN","IVMLDEM6",11,0)
 ;           IVMDA1  -  pointer to PID msg in (#301.501) sub-file
"RTN","IVMLDEM6",12,0)
 ;            IVMDA  -  pointer to record in (#301.511) sub-file
"RTN","IVMLDEM6",13,0)
 ;         IVMPPICK  -  residence phone number and/or another address
"RTN","IVMLDEM6",14,0)
 ;                        field selected
"RTN","IVMLDEM6",15,0)
 ;                      0 - phone or an address field not selected 
"RTN","IVMLDEM6",16,0)
 ;                      1 - address field(s) selected
"RTN","IVMLDEM6",17,0)
 ;                      2 - phone selected
"RTN","IVMLDEM6",18,0)
 ;                      3 - both address field(s) and phone selected
"RTN","IVMLDEM6",19,0)
 ;
"RTN","IVMLDEM6",20,0)
 ; Output: IVMFLAG   -  1 if address field
"RTN","IVMLDEM6",21,0)
 ;                      0 if not an address field
"RTN","IVMLDEM6",22,0)
 ;
"RTN","IVMLDEM6",23,0)
 ;
"RTN","IVMLDEM6",24,0)
 N IVMFLAG,IVMI,IVMJ,IVMNODE,IVMPTR,Y,IVMAFLD,IVMAVAL,IVMFNAM
"RTN","IVMLDEM6",25,0)
 ;
"RTN","IVMLDEM6",26,0)
 ; - initialize flags
"RTN","IVMLDEM6",27,0)
 S IVMFLAG=0
"RTN","IVMLDEM6",28,0)
 ;
"RTN","IVMLDEM6",29,0)
 ; - check for required parameters
"RTN","IVMLDEM6",30,0)
 I '$G(DFN)!('$G(IVMDA))!('$G(IVMDA1))!'($G(IVMDA2)) G ADDRQ
"RTN","IVMLDEM6",31,0)
 ;
"RTN","IVMLDEM6",32,0)
 ; - get pointer to (#301.92) file from (#301.511) sub-file
"RTN","IVMLDEM6",33,0)
 S IVMPTR=+$G(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM",IVMDA,0)) G ADDRQ:'IVMPTR
"RTN","IVMLDEM6",34,0)
 ;
"RTN","IVMLDEM6",35,0)
ASK I '$D(^IVM(301.92,"AD",+IVMPTR)) G ADDRQ
"RTN","IVMLDEM6",36,0)
 I IVMPPICK=2 G ASK1
"RTN","IVMLDEM6",37,0)
 W ! S DIR("A")="Do you wish to proceed with this action"
"RTN","IVMLDEM6",38,0)
 S DIR("A",1)="You have selected to update an address field."
"RTN","IVMLDEM6",39,0)
 S DIR("A",2)="You will be required to upload the entire address."
"RTN","IVMLDEM6",40,0)
 S DIR("?")="Enter 'YES' to continue or 'NO' to abort."
"RTN","IVMLDEM6",41,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","IVMLDEM6",42,0)
 D ^DIR K DIR
"RTN","IVMLDEM6",43,0)
 S IVMFLAG=1
"RTN","IVMLDEM6",44,0)
 I 'Y,IVMPPICK=1 G ADDRQ    ;only address selected so quit
"RTN","IVMLDEM6",45,0)
 I 'Y S IVMPPICK=2 G ASK1   ;check if phone should be updated
"RTN","IVMLDEM6",46,0)
 W ! S DIR("A")="Are you sure that you want to update the complete address"
"RTN","IVMLDEM6",47,0)
 S:$$PHARM(+$G(DFN)) DIR("A",1)="*** WARNING: This patient has ACTIVE PRESCRIPTIONS on file."
"RTN","IVMLDEM6",48,0)
 S DIR("A",2)=""
"RTN","IVMLDEM6",49,0)
 I $$ADRDTCK^IVMLDEM9(+$G(DFN),IVMDA2,IVMDA1) S DIR("A",2)="*** WARNING: The address that you are attempting to file is OLDER than",DIR("A",3)="             the address on file.",DIR("A",4)=""
"RTN","IVMLDEM6",50,0)
 S DIR("?",1)="Enter 'YES' to update the complete address that was received from"
"RTN","IVMLDEM6",51,0)
 S DIR("?")="HEC.  Enter 'NO' to quit."
"RTN","IVMLDEM6",52,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","IVMLDEM6",53,0)
 D ^DIR K DIR
"RTN","IVMLDEM6",54,0)
 S IVMFLAG=1
"RTN","IVMLDEM6",55,0)
 I 'Y,IVMPPICK=1 G ADDRQ     ;only address selected so quit
"RTN","IVMLDEM6",56,0)
 I 'Y S IVMPPICK=2 G ASK1    ;check if phone should be updated
"RTN","IVMLDEM6",57,0)
 ;
"RTN","IVMLDEM6",58,0)
 ; determine correct address change date/time to use
"RTN","IVMLDEM6",59,0)
 D ADDRDT(DFN,IVMDA2,IVMDA1)
"RTN","IVMLDEM6",60,0)
 ;
"RTN","IVMLDEM6",61,0)
 I IVMPPICK=3 G ASK1   ;phone number also selected
"RTN","IVMLDEM6",62,0)
 ;
"RTN","IVMLDEM6",63,0)
 G LOOP  ;only address selected, proceed to filing
"RTN","IVMLDEM6",64,0)
 ;
"RTN","IVMLDEM6",65,0)
ASK1 ; - phone selected to be uploaded
"RTN","IVMLDEM6",66,0)
 W !! S DIR("A")="OK to update"
"RTN","IVMLDEM6",67,0)
 S DIR("A",1)="You have selected to update the PHONE NUMBER [RESIDENCE] field."
"RTN","IVMLDEM6",68,0)
 I $$PHNDTCK^IVMLDEM9(+$G(DFN),IVMDA2,IVMDA1) D
"RTN","IVMLDEM6",69,0)
 .S DIR("A",2)="*** WARNING: The phone number that you are attempting to file is OLDER than"
"RTN","IVMLDEM6",70,0)
 .S DIR("A",3)="             the phone number on file."
"RTN","IVMLDEM6",71,0)
 .S DIR("A",4)=""
"RTN","IVMLDEM6",72,0)
 S DIR("?",1)="Enter 'YES' to update the patient's Phone Number [Residence] that was"
"RTN","IVMLDEM6",73,0)
 S DIR("?",2)="received from HEC.  Enter 'NO' to quit."
"RTN","IVMLDEM6",74,0)
 S DIR(0)="Y",DIR("B")="YES"
"RTN","IVMLDEM6",75,0)
 D ^DIR K DIR
"RTN","IVMLDEM6",76,0)
 S IVMFLAG=1
"RTN","IVMLDEM6",77,0)
 I 'Y,IVMPPICK=2 G ADDRQ   ;no phone or address updates, just quit
"RTN","IVMLDEM6",78,0)
 I 'Y S IVMPPICK=1 G LOOP  ;address still needs to be filed
"RTN","IVMLDEM6",79,0)
 ;
"RTN","IVMLDEM6",80,0)
 ; determine correct phone # change date/time to use
"RTN","IVMLDEM6",81,0)
 D PHONDT(DFN,IVMDA2,IVMDA1)
"RTN","IVMLDEM6",82,0)
 ;
"RTN","IVMLDEM6",83,0)
 W !,"Filing PHONE NUMBER [RESIDENCE] field... "
"RTN","IVMLDEM6",84,0)
 ;
"RTN","IVMLDEM6",85,0)
LOOP ;
"RTN","IVMLDEM6",86,0)
 N DGPRIOR D GETPRIOR^DGADDUTL(DFN,.DGPRIOR)
"RTN","IVMLDEM6",87,0)
 ;
"RTN","IVMLDEM6",88,0)
 I IVMPPICK'=2 D
"RTN","IVMLDEM6",89,0)
 .W !,"Filing address fields... "
"RTN","IVMLDEM6",90,0)
 .D EN^DGCLEAR(DFN,"PERM") ;Deleting existing address before updating
"RTN","IVMLDEM6",91,0)
 ; - loop thru fields in ^IVM(301.92,"AD" x-ref
"RTN","IVMLDEM6",92,0)
 S IVMI=0 F  S IVMI=$O(^IVM(301.92,"AD",IVMI)) Q:IVMI']""  D
"RTN","IVMLDEM6",93,0)
 .S IVMJ=0 F  S IVMJ=$O(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM","B",IVMI,IVMJ)) Q:IVMJ']""  D
"RTN","IVMLDEM6",94,0)
 ..;
"RTN","IVMLDEM6",95,0)
 ..; - check for data node in (#301.511) sub-file
"RTN","IVMLDEM6",96,0)
 ..S IVMNODE=$G(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM",IVMJ,0)) Q:IVMNODE']""
"RTN","IVMLDEM6",97,0)
 ..Q:'(+IVMNODE)!($P(IVMNODE,"^",2)']"")
"RTN","IVMLDEM6",98,0)
 ..;
"RTN","IVMLDEM6",99,0)
 ..S IVMFNAM=$P($G(^IVM(301.92,+IVMNODE,0)),U) Q:IVMFNAM=""
"RTN","IVMLDEM6",100,0)
 ..; - check if residence phone number and not selected to upload
"RTN","IVMLDEM6",101,0)
 ..I IVMPPICK=1&(IVMFNAM="PHONE NUMBER [RESIDENCE]"!(IVMFNAM["RESIDENCE NUMBER CHANGE")) Q
"RTN","IVMLDEM6",102,0)
 ..; - check if not residence phone number and only phone selected to upload
"RTN","IVMLDEM6",103,0)
 ..I IVMPPICK=2&(IVMFNAM'="PHONE NUMBER [RESIDENCE]"&(IVMFNAM'["RESIDENCE NUMBER CHANGE")) Q
"RTN","IVMLDEM6",104,0)
 ..;
"RTN","IVMLDEM6",105,0)
 ..;Store Address change Date/time, source and site in ^TMP to file at the end of process.
"RTN","IVMLDEM6",106,0)
 ..S IVMAFLD=$P($G(^IVM(301.92,+IVMNODE,0)),"^",5),IVMAVAL=$P(IVMNODE,"^",2)
"RTN","IVMLDEM6",107,0)
 ..I ((IVMAFLD=.118)!(IVMAFLD=.119)!(IVMAFLD=.12)) S ^TMP($J,"CHANGE UPDATE",IVMAFLD)=IVMAVAL
"RTN","IVMLDEM6",108,0)
 ..;Store Residence Number change Date/time, source and site in ^TMP to file at the end of process.
"RTN","IVMLDEM6",109,0)
 ..I ((IVMAFLD=.1321)!(IVMAFLD=.1322)!(IVMAFLD=.1323)) S ^TMP($J,"CHANGE UPDATE",IVMAFLD)=IVMAVAL
"RTN","IVMLDEM6",110,0)
 ..; - perform any necessary address field manipulation and
"RTN","IVMLDEM6",111,0)
 ..;   load addr field rec'd from IVM into DHCP (#2) file
"RTN","IVMLDEM6",112,0)
 ..D UPLOAD(+DFN,$P($G(^IVM(301.92,+IVMNODE,0)),"^",5),$P(IVMNODE,"^",2)) S IVMFLAG=1
"RTN","IVMLDEM6",113,0)
 ..;
"RTN","IVMLDEM6",114,0)
 ..; - remove entry from (#301.511) sub-file
"RTN","IVMLDEM6",115,0)
 ..D DELENT^IVMLDEMU(IVMDA2,IVMDA1,IVMJ)
"RTN","IVMLDEM6",116,0)
 ;
"RTN","IVMLDEM6",117,0)
 D ADDRCHNG^IVMPREC6(DFN) ;Update Address change date/time,source,site if necessary
"RTN","IVMLDEM6",118,0)
 I IVMFLAG W "completed.",! D
"RTN","IVMLDEM6",119,0)
 .N DGCURR
"RTN","IVMLDEM6",120,0)
 .D GETUPDTS^DGADDUTL(DFN,.DGCURR)
"RTN","IVMLDEM6",121,0)
 .D UPDADDLG^DGADDUTL(DFN,.DGPRIOR,.DGCURR)
"RTN","IVMLDEM6",122,0)
 ;
"RTN","IVMLDEM6",123,0)
 ; - if addr is uploaded and phone # is not - ask user delete phone
"RTN","IVMLDEM6",124,0)
 ;I IVMFLAG,$P($G(^DPT(+DFN,.13)),"^")]"",(2>IVMPPICK) D PHONE
"RTN","IVMLDEM6",125,0)
 S VALMBCK="R"
"RTN","IVMLDEM6",126,0)
 ;
"RTN","IVMLDEM6",127,0)
 ;
"RTN","IVMLDEM6",128,0)
ADDRQ ; - return  -->  1 if uploadable field is an address field
"RTN","IVMLDEM6",129,0)
 ;           -->  0 if uploadable field is not an address field
"RTN","IVMLDEM6",130,0)
 ;
"RTN","IVMLDEM6",131,0)
 I IVMFLAG D RESET^IVMLDEMU
"RTN","IVMLDEM6",132,0)
 Q IVMFLAG
"RTN","IVMLDEM6",133,0)
 ;
"RTN","IVMLDEM6",134,0)
 ;
"RTN","IVMLDEM6",135,0)
UPLOAD(DFN,IVMFIELD,IVMVALUE) ; - file address fields received from IVM
"RTN","IVMLDEM6",136,0)
 ;
"RTN","IVMLDEM6",137,0)
 ;  Input:       DFN  -  as patient IEN
"RTN","IVMLDEM6",138,0)
 ;          IVMFIELD  -  as the field number to be updated
"RTN","IVMLDEM6",139,0)
 ;          IVMVALUE  -  as the value of the field
"RTN","IVMLDEM6",140,0)
 ;
"RTN","IVMLDEM6",141,0)
 ; Output: None
"RTN","IVMLDEM6",142,0)
 ;
"RTN","IVMLDEM6",143,0)
 ;
"RTN","IVMLDEM6",144,0)
 ; - update specified address field in the Patient (#2) file
"RTN","IVMLDEM6",145,0)
 N DIE,DA,DR,IENS,FDA
"RTN","IVMLDEM6",146,0)
 ; KUM - IVM*2.0*164 
"RTN","IVMLDEM6",147,0)
 ; To bypass DELETE TEST node test in DD for TEMP ADDRESS LINE2 AND TEMP ADDRESS LINE3
"RTN","IVMLDEM6",148,0)
 ; In Some production accounts, DELETE TEST node is set for .1212 and .1213
"RTN","IVMLDEM6",149,0)
 I ((IVMFIELD=.1212)!(IVMFIELD=.1213)),(IVMVALUE="@") D  Q
"RTN","IVMLDEM6",150,0)
 .S IENS=DFN_","
"RTN","IVMLDEM6",151,0)
 .S FDA(2,IENS,IVMFIELD)="@"
"RTN","IVMLDEM6",152,0)
 .D FILE^DIE("","FDA")
"RTN","IVMLDEM6",153,0)
 ; IVM*2.0*164 - Allow updating null values in Confidential start and end dates
"RTN","IVMLDEM6",154,0)
 I ((IVMFIELD=.1417)!(IVMFIELD=.1418)) D
"RTN","IVMLDEM6",155,0)
 .S IENS=DFN_","
"RTN","IVMLDEM6",156,0)
 .S FDA(2,IENS,IVMCAFG)="Y"
"RTN","IVMLDEM6",157,0)
 .D FILE^DIE("","FDA")
"RTN","IVMLDEM6",158,0)
 I ((IVMFIELD=.1417)!(IVMFIELD=.1418)),(IVMVALUE="@") D  Q
"RTN","IVMLDEM6",159,0)
 .S IENS=DFN_","
"RTN","IVMLDEM6",160,0)
 .S FDA(2,IENS,IVMFIELD)="@"
"RTN","IVMLDEM6",161,0)
 .D FILE^DIE("","FDA")
"RTN","IVMLDEM6",162,0)
 I IVMFIELD=.14112 D  Q
"RTN","IVMLDEM6",163,0)
 .S IENS=DFN_","
"RTN","IVMLDEM6",164,0)
 .S FDA(2,IENS,IVMCAFG)=IVMCAVL
"RTN","IVMLDEM6",165,0)
 .D FILE^DIE("","FDA")
"RTN","IVMLDEM6",166,0)
 .S IENS=DFN_","
"RTN","IVMLDEM6",167,0)
 .S FDA(2,IENS,IVMFIELD)=IVMVALUE
"RTN","IVMLDEM6",168,0)
 .D FILE^DIE("","FDA")
"RTN","IVMLDEM6",169,0)
 S DIE="^DPT(",DA=DFN,DR=IVMFIELD_"////^S X=IVMVALUE"
"RTN","IVMLDEM6",170,0)
 D ^DIE K DA,DIE,DR
"RTN","IVMLDEM6",171,0)
 ;
"RTN","IVMLDEM6",172,0)
 ; - delete inaccurate Addr Change Site data if Source is not VAMC
"RTN","IVMLDEM6",173,0)
 ;   (trigger x-ref does not fire with 4 slash stuff)
"RTN","IVMLDEM6",174,0)
 I IVMFIELD=.119,IVMVALUE'="VAMC" S FDA(2,+DFN_",",.12)="@" D UPDATE^DIE("E","FDA")
"RTN","IVMLDEM6",175,0)
 ; KUM - IVM*2.0*164 
"RTN","IVMLDEM6",176,0)
 ; If Source is not VAMC, delete the Site
"RTN","IVMLDEM6",177,0)
 I IVMFIELD=.11582,IVMVALUE'="VAMC" S FDA(2,+DFN_",",.11581)="@" D UPDATE^DIE("E","FDA")
"RTN","IVMLDEM6",178,0)
 Q
"RTN","IVMLDEM6",179,0)
 ;
"RTN","IVMLDEM6",180,0)
 ;
"RTN","IVMLDEM6",181,0)
PHONE ; - ask user to delete phone # [Residence] from Patient (#2) file
"RTN","IVMLDEM6",182,0)
 D PHONE^IVMPREC9 ;Moved this tag to IVMPREC9 due to routine size limit.
"RTN","IVMLDEM6",183,0)
 Q
"RTN","IVMLDEM6",184,0)
 ;
"RTN","IVMLDEM6",185,0)
AUTOADDR(DFN,IVMPPICK,NOUPDT,NOPHUP) ;
"RTN","IVMLDEM6",186,0)
 ; this functionality is copied from above and modified to allow
"RTN","IVMLDEM6",187,0)
 ; an automated upload of patient address information as stipulated
"RTN","IVMLDEM6",188,0)
 ; in the business requirements for Address Indexing to support GMT
"RTN","IVMLDEM6",189,0)
 ;
"RTN","IVMLDEM6",190,0)
 ;  Input:      DFN  -  as patient IEN
"RTN","IVMLDEM6",191,0)
 ;         IVMPPICK  -  residence phone number and/or another address
"RTN","IVMLDEM6",192,0)
 ;                        field selected
"RTN","IVMLDEM6",193,0)
 ;                      1 - address field(s) selected
"RTN","IVMLDEM6",194,0)
 ;                      3 - both address field(s) and phone selected
"RTN","IVMLDEM6",195,0)
 ;           NOUPDT  -  (optional) this flag is set when the incoming
"RTN","IVMLDEM6",196,0)
 ;                      address data is older than the existing
"RTN","IVMLDEM6",197,0)
 ;                      address in the Patient (#2) file
"RTN","IVMLDEM6",198,0)
 ;           NOPHUP  -  (optional) this flag is set when the incoming
"RTN","IVMLDEM6",199,0)
 ;                      home phone number is older than the existing
"RTN","IVMLDEM6",200,0)
 ;                      home phone number in the Patient (#2) file
"RTN","IVMLDEM6",201,0)
 ; Output: IVMFLAG   -  1 if address fields updated
"RTN","IVMLDEM6",202,0)
 ;                      0 if address fields not updated
"RTN","IVMLDEM6",203,0)
 ;
"RTN","IVMLDEM6",204,0)
 ;
"RTN","IVMLDEM6",205,0)
 ;
"RTN","IVMLDEM6",206,0)
 N IVMFLAG,IVMI,IVMJ,IVMNODE,IVMPTR,Y,IVMAFLD,IVMAVAL,DELFLG
"RTN","IVMLDEM6",207,0)
 ;
"RTN","IVMLDEM6",208,0)
 ; - initialize flags
"RTN","IVMLDEM6",209,0)
 S IVMFLAG=0,DELFLG=1
"RTN","IVMLDEM6",210,0)
 S:'$G(NOUPDT) NOUPDT=0
"RTN","IVMLDEM6",211,0)
 S:'$G(NOPHUP) NOPHUP=0   ;Added for IVM*2*152
"RTN","IVMLDEM6",212,0)
 ;
"RTN","IVMLDEM6",213,0)
 ; - check for required parameters
"RTN","IVMLDEM6",214,0)
 Q:'$G(DFN) IVMFLAG
"RTN","IVMLDEM6",215,0)
 ;
"RTN","IVMLDEM6",216,0)
 N DGPRIOR D GETPRIOR^DGADDUTL(DFN,.DGPRIOR)
"RTN","IVMLDEM6",217,0)
 ; Set the flag to don't auto-update if there is an active Prescription record and the Bad Address Indicator is null
"RTN","IVMLDEM6",218,0)
 ; IVM*2.0*177; jam; - Auto upload even if patient has active prescription and bad address indicator is null
"RTN","IVMLDEM6",219,0)
 ;I ('NOUPDT),$$PHARM(+DFN),'$$BADADR^DGUTL3(+DFN) S DELFLG=0
"RTN","IVMLDEM6",220,0)
 I 'NOUPDT,DELFLG D EN^DGCLEAR(DFN,"PERM") ;Deleting existing address before updating
"RTN","IVMLDEM6",221,0)
 ;
"RTN","IVMLDEM6",222,0)
 S IVMDA2=$G(IVM3015)
"RTN","IVMLDEM6",223,0)
 Q:'$G(IVMDA2) IVMFLAG
"RTN","IVMLDEM6",224,0)
 S IVMDA1=$O(^HL(771.3,"B","PID",""))
"RTN","IVMLDEM6",225,0)
 S IVMDA1=$O(^IVM(301.5,IVMDA2,"IN","B",IVMDA1,""),-1)
"RTN","IVMLDEM6",226,0)
 Q:'IVMDA1 IVMFLAG
"RTN","IVMLDEM6",227,0)
 ;
"RTN","IVMLDEM6",228,0)
 S IVMI=0 F  S IVMI=$O(^IVM(301.92,"AD",IVMI)) Q:IVMI']""  D
"RTN","IVMLDEM6",229,0)
 .S IVMJ=0 F  S IVMJ=$O(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM","B",IVMI,IVMJ)) Q:IVMJ']""  D
"RTN","IVMLDEM6",230,0)
 ..;
"RTN","IVMLDEM6",231,0)
 ..; - check for data node in (#301.511) sub-file
"RTN","IVMLDEM6",232,0)
 ..S IVMNODE=$G(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM",IVMJ,0))
"RTN","IVMLDEM6",233,0)
 ..I ('+IVMNODE)!($P(IVMNODE,"^",2)']"") Q
"RTN","IVMLDEM6",234,0)
 ..;
"RTN","IVMLDEM6",235,0)
 ..; - check if residence phone number -> do not auto-upload
"RTN","IVMLDEM6",236,0)
 ..;   If NOPHUP=1 delete entry from #301.511 sub-file, otherwise quit
"RTN","IVMLDEM6",237,0)
 ..;   (IVM*2*152)
"RTN","IVMLDEM6",238,0)
 ..I $P($G(^IVM(301.92,+IVMNODE,0)),U)="PHONE NUMBER [RESIDENCE]"!($P($G(^IVM(301.92,+IVMNODE,0)),U)["RESIDENCE NUMBER CHANGE") D  Q
"RTN","IVMLDEM6",239,0)
 ...I NOPHUP D DELENT^IVMLDEMU(IVMDA2,IVMDA1,IVMJ)
"RTN","IVMLDEM6",240,0)
 ..;
"RTN","IVMLDEM6",241,0)
 ..; don't auto-update if there is an active Prescription record and
"RTN","IVMLDEM6",242,0)
 ..; the Bad Address Indicator is null
"RTN","IVMLDEM6",243,0)
 ..I 'DELFLG D DEMBULL^IVMPREC6 Q
"RTN","IVMLDEM6",244,0)
 ..;Store Address change Date/time, source and site in ^TMP to file at the end of process.
"RTN","IVMLDEM6",245,0)
 ..S IVMAFLD=$P($G(^IVM(301.92,+IVMNODE,0)),"^",5),IVMAVAL=$P(IVMNODE,"^",2)
"RTN","IVMLDEM6",246,0)
 ..I 'NOUPDT,((IVMAFLD=.118)!(IVMAFLD=.119)!(IVMAFLD=.12)) S ^TMP($J,"CHANGE UPDATE",IVMAFLD)=IVMAVAL
"RTN","IVMLDEM6",247,0)
 ..;
"RTN","IVMLDEM6",248,0)
 ..; - load addr field rec'd from IVM into DHCP (#2) file
"RTN","IVMLDEM6",249,0)
 ..I 'NOUPDT D UPLOAD(+DFN,IVMAFLD,IVMAVAL) S IVMFLAG=1
"RTN","IVMLDEM6",250,0)
 ..;
"RTN","IVMLDEM6",251,0)
 ..; - remove entry from (#301.511) sub-file
"RTN","IVMLDEM6",252,0)
 ..D DELENT^IVMLDEMU(IVMDA2,IVMDA1,IVMJ)
"RTN","IVMLDEM6",253,0)
 ..; - if no display or uploadable fields left, then delete the PID
"RTN","IVMLDEM6",254,0)
 ..;   segment
"RTN","IVMLDEM6",255,0)
 ..I '$$DEMO^IVMLDEM5(IVMDA2,IVMDA1,0),'$$DEMO^IVMLDEM5(IVMDA2,IVMDA1,1) D
"RTN","IVMLDEM6",256,0)
 ...D DELETE^IVMLDEM5(IVMDA2,IVMDA1," ") ; Dummy up name parameter
"RTN","IVMLDEM6",257,0)
 D ADDRCHNG^IVMPREC6(DFN) ;Update Address change date/time,source,site if necessary
"RTN","IVMLDEM6",258,0)
 I IVMFLAG D
"RTN","IVMLDEM6",259,0)
 .N DGCURR
"RTN","IVMLDEM6",260,0)
 .D GETUPDTS^DGADDUTL(DFN,.DGCURR)
"RTN","IVMLDEM6",261,0)
 .D UPDADDLG^DGADDUTL(DFN,.DGPRIOR,.DGCURR)
"RTN","IVMLDEM6",262,0)
 Q IVMFLAG
"RTN","IVMLDEM6",263,0)
 ;
"RTN","IVMLDEM6",264,0)
ADDRDT(DFN,IVMDA2,IVMDA1) ;
"RTN","IVMLDEM6",265,0)
 ; - validate Address Change Dt/Tm before filing
"RTN","IVMLDEM6",266,0)
 ;   if incoming address is accepted and the change date is older
"RTN","IVMLDEM6",267,0)
 ;   than what's on file, then use today's date for Addr Chg Dt/Tm
"RTN","IVMLDEM6",268,0)
 ;
"RTN","IVMLDEM6",269,0)
 Q:'$$ADRDTCK^IVMLDEM9(DFN,IVMDA2,IVMDA1)
"RTN","IVMLDEM6",270,0)
 N FDA,IEN92,IVMDA,IENS,ERR
"RTN","IVMLDEM6",271,0)
 S IEN92=$O(^IVM(301.92,"C","RF171","")) Q:'IEN92
"RTN","IVMLDEM6",272,0)
 Q:'$D(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM","B",IEN92))
"RTN","IVMLDEM6",273,0)
 S IVMDA=$O(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM","B",IEN92,"")) Q:'IVMDA
"RTN","IVMLDEM6",274,0)
 S IENS=IVMDA_","_IVMDA1_","_IVMDA2_","
"RTN","IVMLDEM6",275,0)
 S FDA(301.511,IENS,.02)=$$NOW^XLFDT
"RTN","IVMLDEM6",276,0)
 D FILE^DIE("","FDA","ERR")
"RTN","IVMLDEM6",277,0)
 Q
"RTN","IVMLDEM6",278,0)
 ;
"RTN","IVMLDEM6",279,0)
PHONDT(DFN,IVMDA2,IVMDA1) ;
"RTN","IVMLDEM6",280,0)
 ; - validate Residence Number Change Dt/Tm before filing
"RTN","IVMLDEM6",281,0)
 ;   if incoming phone number is accepted and the change date is
"RTN","IVMLDEM6",282,0)
 ;   older than what's on file, then use today's date for
"RTN","IVMLDEM6",283,0)
 ;   Residence Number Change Dt/Tm (IVM*2*152)
"RTN","IVMLDEM6",284,0)
 ;
"RTN","IVMLDEM6",285,0)
 Q:'$$PHNDTCK^IVMLDEM9(DFN,IVMDA2,IVMDA1)
"RTN","IVMLDEM6",286,0)
 N FDA,IEN92,IVMDA,IENS,ERR
"RTN","IVMLDEM6",287,0)
 S IEN92=$O(^IVM(301.92,"C","RF171P","")) Q:'IEN92
"RTN","IVMLDEM6",288,0)
 Q:'$D(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM","B",IEN92))
"RTN","IVMLDEM6",289,0)
 S IVMDA=$O(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM","B",IEN92,"")) Q:'IVMDA
"RTN","IVMLDEM6",290,0)
 S IENS=IVMDA_","_IVMDA1_","_IVMDA2_","
"RTN","IVMLDEM6",291,0)
 S FDA(301.511,IENS,.02)=$$NOW^XLFDT
"RTN","IVMLDEM6",292,0)
 D FILE^DIE("","FDA","ERR")
"RTN","IVMLDEM6",293,0)
 Q
"RTN","IVMLDEM6",294,0)
 ;
"RTN","IVMLDEM6",295,0)
PHARM(DFN) ;does this patient have active pharmacy prescriptions?
"RTN","IVMLDEM6",296,0)
 ;
"RTN","IVMLDEM6",297,0)
 ;External reference to $$EN^PSSRXACT supported by IA #4237
"RTN","IVMLDEM6",298,0)
 ;
"RTN","IVMLDEM6",299,0)
 Q $S('$G(DFN):0,1:$$EN^PSSRXACT(DFN))
"RTN","IVMLDEM9")
0^1^B65121028^B62902959
"RTN","IVMLDEM9",1,0)
IVMLDEM9 ;ALB/BRM/PHH/LBD/JAM - IVM ADDRESS UPDATES PENDING REVIEW RPT ;4/18/12 4:43pm
"RTN","IVMLDEM9",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**79,93,119,126,133,152,177**;21-OCT-94;Build 3
"RTN","IVMLDEM9",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IVMLDEM9",4,0)
 ;
"RTN","IVMLDEM9",5,0)
 Q
"RTN","IVMLDEM9",6,0)
 ;
"RTN","IVMLDEM9",7,0)
EN2 ;entry point for IVM ADDR UPDT PENDING REVIEW menu option
"RTN","IVMLDEM9",8,0)
 K ^TMP("IVMLDEM9",$J)
"RTN","IVMLDEM9",9,0)
 K ^TMP($J,"IVMLDEM9")
"RTN","IVMLDEM9",10,0)
 ;If mail group has no member or remote-member
"RTN","IVMLDEM9",11,0)
 I '$$MEMBER() D  Q
"RTN","IVMLDEM9",12,0)
 . I '$D(ZTQUEUED) W !!,"IVM ADDR UPDT REPORT does not have a member. Report not sent." K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","IVMLDEM9",13,0)
 I +$G(ZTSK) D PRINT,EXIT Q  ;started by Taskman job
"RTN","IVMLDEM9",14,0)
 ;User runs the option
"RTN","IVMLDEM9",15,0)
 I '$D(ZTQUEUED) D
"RTN","IVMLDEM9",16,0)
 . W !!,"The report will be sent to mail group IVM ADDR UPDT REPORT"
"RTN","IVMLDEM9",17,0)
 . D QUE
"RTN","IVMLDEM9",18,0)
 . D EXIT
"RTN","IVMLDEM9",19,0)
 . K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","IVMLDEM9",20,0)
 Q
"RTN","IVMLDEM9",21,0)
 ;
"RTN","IVMLDEM9",22,0)
LOOP(DTPARAM,FILDAT) ;main loop
"RTN","IVMLDEM9",23,0)
 N DFN,IVMDT,IVMDA,IVMDA1,IVMDA2,RF171,TODAY,AUTODT,DTDIFF,NAME,UPLDT
"RTN","IVMLDEM9",24,0)
 N X1,X2,Y,SSN,DFN
"RTN","IVMLDEM9",25,0)
 D DT^DILF("X","T"_$G(DTPARAM),.AUTODT)
"RTN","IVMLDEM9",26,0)
 S TODAY=$$DT^XLFDT S:'$G(FILDAT) FILDAT=0
"RTN","IVMLDEM9",27,0)
 Q:'$G(AUTODT)  ;this should never occur, but just in case
"RTN","IVMLDEM9",28,0)
 S RF171=$O(^IVM(301.92,"C","RF171","")),IVMDA2=""
"RTN","IVMLDEM9",29,0)
 Q:'RF171
"RTN","IVMLDEM9",30,0)
 F  S IVMDA2=$O(^IVM(301.5,IVMDA2)) Q:IVMDA2=""  D
"RTN","IVMLDEM9",31,0)
 .S DFN=$P($G(^IVM(301.5,IVMDA2,0)),"^"),IVMDA1=""
"RTN","IVMLDEM9",32,0)
 .Q:('DFN)!('$D(^DPT(+DFN)))!('$D(^IVM(301.5,IVMDA2,"IN")))
"RTN","IVMLDEM9",33,0)
 .F  S IVMDA1=$O(^IVM(301.5,IVMDA2,"IN",IVMDA1)) Q:IVMDA1=""  D
"RTN","IVMLDEM9",34,0)
 ..Q:'$D(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM","B",RF171))
"RTN","IVMLDEM9",35,0)
 ..S IVMDA=""
"RTN","IVMLDEM9",36,0)
 ..F  S IVMDA=$O(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM","B",RF171,IVMDA)) Q:'IVMDA  D
"RTN","IVMLDEM9",37,0)
 ...S IVMDT=$P($G(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM",IVMDA,0)),"^",3)
"RTN","IVMLDEM9",38,0)
 ...Q:('IVMDT)!(IVMDT>AUTODT)
"RTN","IVMLDEM9",39,0)
 ...; report addresses that will be auto-uploaded in DTDIFF days
"RTN","IVMLDEM9",40,0)
 ...S X1=TODAY,X2=IVMDT D ^%DTC S DTDIFF=+$G(X)
"RTN","IVMLDEM9",41,0)
 ...S NAME=$P($G(^DPT(DFN,0)),"^"),SSN=$P($G(^DPT(DFN,0)),"^",9)
"RTN","IVMLDEM9",42,0)
 ...S X1=IVMDT,X2=14 D C^%DTC S UPLDT=$G(X)
"RTN","IVMLDEM9",43,0)
 ...I '$D(^IVM(301.5,"ASEG","PID",IVMDA2)) Q
"RTN","IVMLDEM9",44,0)
 ...S ^TMP("IVMLDEM9",$J,DTDIFF,SSN,IVMDA)=$G(NAME)_"^"_$P(IVMDT,".")_"^"_$P(UPLDT,".")_"^"_DFN_"^"_IVMDA2_"^"_IVMDA1
"RTN","IVMLDEM9",45,0)
 Q
"RTN","IVMLDEM9",46,0)
 ;
"RTN","IVMLDEM9",47,0)
AUTOLOAD(DFN,IVMDA2,IVMDA1) ;auto-upload records that not been reviewed
"RTN","IVMLDEM9",48,0)
 ; this tag is called from ^IVMLDEMC
"RTN","IVMLDEM9",49,0)
 ;
"RTN","IVMLDEM9",50,0)
 Q:('$G(DFN))!('$G(IVMDA2))!('$G(IVMDA1))
"RTN","IVMLDEM9",51,0)
 N IVMI,IVMJ,IVMFIELD,IVMVALUE,IVMNODE,IVMFLAG,DUZ
"RTN","IVMLDEM9",52,0)
 S DUZ=.5
"RTN","IVMLDEM9",53,0)
 ;
"RTN","IVMLDEM9",54,0)
 ; determine appropriate address change dt/tm to be used
"RTN","IVMLDEM9",55,0)
 D ADDRDT^IVMLDEM6(DFN,IVMDA2,IVMDA1)
"RTN","IVMLDEM9",56,0)
 ;
"RTN","IVMLDEM9",57,0)
 N DGPRIOR D GETPRIOR^DGADDUTL(DFN,.DGPRIOR)
"RTN","IVMLDEM9",58,0)
 ;
"RTN","IVMLDEM9",59,0)
 ; loop through the record to be uploaded
"RTN","IVMLDEM9",60,0)
 S IVMI=0 F  S IVMI=$O(^IVM(301.92,"AD",IVMI)) Q:IVMI']""  D
"RTN","IVMLDEM9",61,0)
 .S IVMJ=0 F  S IVMJ=$O(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM","B",IVMI,IVMJ)) Q:IVMJ']""  D
"RTN","IVMLDEM9",62,0)
 ..;
"RTN","IVMLDEM9",63,0)
 ..; check for data node in (#301.511) sub-file
"RTN","IVMLDEM9",64,0)
 ..S IVMNODE=$G(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM",IVMJ,0))
"RTN","IVMLDEM9",65,0)
 ..Q:('+IVMNODE)!($P(IVMNODE,"^",2)']"")
"RTN","IVMLDEM9",66,0)
 ..;
"RTN","IVMLDEM9",67,0)
 ..; check for residence phone number -> do not auto-upload
"RTN","IVMLDEM9",68,0)
 ..Q:(+IVMNODE=$O(^IVM(301.92,"B","PHONE NUMBER [RESIDENCE]",0)))
"RTN","IVMLDEM9",69,0)
 ..;
"RTN","IVMLDEM9",70,0)
 ..; IVM*2.0*177 ; jam; Comment lines below to skip over reject/upload logic for these records and just do cleanup
"RTN","IVMLDEM9",71,0)
 ..;
"RTN","IVMLDEM9",72,0)
 ..; do not auto-upload if there is an active prescription
"RTN","IVMLDEM9",73,0)
 ..;I $$PHARM^IVMLDEM6(+DFN) D REJTADD Q
"RTN","IVMLDEM9",74,0)
 ..;
"RTN","IVMLDEM9",75,0)
 ..; set upload parameters
"RTN","IVMLDEM9",76,0)
 ..;S IVMFIELD=$P($G(^IVM(301.92,+IVMNODE,0)),"^",5)
"RTN","IVMLDEM9",77,0)
 ..;S IVMVALUE=$P(IVMNODE,"^",2)
"RTN","IVMLDEM9",78,0)
 ..;
"RTN","IVMLDEM9",79,0)
 ..; load addr field into the Patient (#2) file
"RTN","IVMLDEM9",80,0)
 ..;D UPLOAD^IVMLDEM6(DFN,IVMFIELD,IVMVALUE) S IVMFLAG=1
"RTN","IVMLDEM9",81,0)
 ..;
"RTN","IVMLDEM9",82,0)
 ..; remove entry from (#301.511) sub-file
"RTN","IVMLDEM9",83,0)
 ..D DELENT^IVMLDEMU(IVMDA2,IVMDA1,IVMJ)
"RTN","IVMLDEM9",84,0)
 ..;
"RTN","IVMLDEM9",85,0)
 ..; if no display or uploadable fields, delete PID segment
"RTN","IVMLDEM9",86,0)
 ..I ('$$DEMO^IVMLDEM5(IVMDA2,IVMDA1,0))&('$$DEMO^IVMLDEM5(IVMDA2,IVMDA1,1)) D DELETE^IVMLDEM5(IVMDA2,IVMDA1," ")
"RTN","IVMLDEM9",87,0)
 ;
"RTN","IVMLDEM9",88,0)
 I +$G(IVMFLAG) D
"RTN","IVMLDEM9",89,0)
 .N DGCURR
"RTN","IVMLDEM9",90,0)
 .D GETUPDTS^DGADDUTL(DFN,.DGCURR)
"RTN","IVMLDEM9",91,0)
 .D UPDADDLG^DGADDUTL(DFN,.DGPRIOR,.DGCURR)
"RTN","IVMLDEM9",92,0)
 Q
"RTN","IVMLDEM9",93,0)
REJTADD ;Reject the address
"RTN","IVMLDEM9",94,0)
 ;
"RTN","IVMLDEM9",95,0)
 ; update the ADDRESS CHANGE DT/TM field #.118 in PATIENT file #2
"RTN","IVMLDEM9",96,0)
 D UPDDTTM^DGADDUTL(DFN,"PERM")
"RTN","IVMLDEM9",97,0)
 ;
"RTN","IVMLDEM9",98,0)
 ; trigger the record to transmit the existing address on file to HEC
"RTN","IVMLDEM9",99,0)
 N DGENUPLD   ; Used in SETSTAT^IVMPLOG to prevent filing.
"RTN","IVMLDEM9",100,0)
 N DA,X,IVMX
"RTN","IVMLDEM9",101,0)
 S (DA,X)=DFN
"RTN","IVMLDEM9",102,0)
 S IVMX=X,X="IVMPXFR" X ^%ZOSF("TEST") D:$T DPT^IVMPXFR S X=IVMX
"RTN","IVMLDEM9",103,0)
 Q
"RTN","IVMLDEM9",104,0)
PRINT ;report output
"RTN","IVMLDEM9",105,0)
 N DAYS,SSN,DATA,EX,PAGE,IVMDA,DATA,IVMLN,XMY,XMSUB,XMDUZ,XMTEXT
"RTN","IVMLDEM9",106,0)
 D LOOP("",0)
"RTN","IVMLDEM9",107,0)
 D HDR
"RTN","IVMLDEM9",108,0)
 D DISPLAY
"RTN","IVMLDEM9",109,0)
 D EMAIL
"RTN","IVMLDEM9",110,0)
 Q
"RTN","IVMLDEM9",111,0)
DISPLAY ;Display the report
"RTN","IVMLDEM9",112,0)
 S DAYS=""
"RTN","IVMLDEM9",113,0)
 I '$D(^TMP("IVMLDEM9",$J)) Q
"RTN","IVMLDEM9",114,0)
 F  S DAYS=$O(^TMP("IVMLDEM9",$J,DAYS),-1) Q:DAYS=""!($G(EX))  D
"RTN","IVMLDEM9",115,0)
 .S SSN=""
"RTN","IVMLDEM9",116,0)
 .F  S SSN=$O(^TMP("IVMLDEM9",$J,DAYS,SSN)) Q:SSN=""!($G(EX))  D
"RTN","IVMLDEM9",117,0)
 ..S IVMDA=""
"RTN","IVMLDEM9",118,0)
 ..F  S IVMDA=$O(^TMP("IVMLDEM9",$J,DAYS,SSN,IVMDA)) Q:(IVMDA="")!($G(EX))  D
"RTN","IVMLDEM9",119,0)
 ...S DATA=$G(^TMP("IVMLDEM9",$J,DAYS,SSN,IVMDA))
"RTN","IVMLDEM9",120,0)
 ... D LNPLUS
"RTN","IVMLDEM9",121,0)
 ... S ^TMP($J,"IVMLDEM9",IVMLN)="       "_$$FMTE^XLFDT($P(DATA,"^",3))_"      "_$$FMTE^XLFDT($P(DATA,"^",2))_"      "_SSN_"     "_$P(DATA,"^")
"RTN","IVMLDEM9",122,0)
 ... S ^TMP($J,"IVMLDEM9","TOTAL")=$G(^TMP($J,"IVMLDEM9","TOTAL"))+1
"RTN","IVMLDEM9",123,0)
 D TOTAL
"RTN","IVMLDEM9",124,0)
 D
"RTN","IVMLDEM9",125,0)
 . D LNPLUS
"RTN","IVMLDEM9",126,0)
 . S ^TMP($J,"IVMLDEM9",IVMLN)=""
"RTN","IVMLDEM9",127,0)
 . D LNPLUS
"RTN","IVMLDEM9",128,0)
 . S ^TMP($J,"IVMLDEM9",IVMLN)="                    <<END OF REPORT>>"
"RTN","IVMLDEM9",129,0)
 I $E(IOST)="C" W ! K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","IVMLDEM9",130,0)
 Q
"RTN","IVMLDEM9",131,0)
HDR ;print header
"RTN","IVMLDEM9",132,0)
 N IVMDT,Y,DLINE
"RTN","IVMLDEM9",133,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S (ZTSTOP,EX)=1 Q
"RTN","IVMLDEM9",134,0)
 S Y=DT X ^DD("DD") S IVMDT=Y
"RTN","IVMLDEM9",135,0)
 D
"RTN","IVMLDEM9",136,0)
 . D LNPLUS
"RTN","IVMLDEM9",137,0)
 . S ^TMP($J,"IVMLDEM9",IVMLN)=""
"RTN","IVMLDEM9",138,0)
 . D LNPLUS
"RTN","IVMLDEM9",139,0)
 . S ^TMP($J,"IVMLDEM9",IVMLN)=" IVM ADDRESS UPDATES PENDING REVIEW          "_IVMDT
"RTN","IVMLDEM9",140,0)
 . D LNPLUS
"RTN","IVMLDEM9",141,0)
 . S $P(^TMP($J,"IVMLDEM9",IVMLN),"=",78)=""
"RTN","IVMLDEM9",142,0)
 . D LNPLUS
"RTN","IVMLDEM9",143,0)
 . S ^TMP($J,"IVMLDEM9",IVMLN)=""
"RTN","IVMLDEM9",144,0)
 . D LNPLUS
"RTN","IVMLDEM9",145,0)
 . S ^TMP($J,"IVMLDEM9",IVMLN)="     Auto-Upload Date    Date Received        SSN        Patient Name"
"RTN","IVMLDEM9",146,0)
 . D LNPLUS
"RTN","IVMLDEM9",147,0)
 . S ^TMP($J,"IVMLDEM9",IVMLN)="     ----------------    -------------     ---------     ------------"
"RTN","IVMLDEM9",148,0)
 Q
"RTN","IVMLDEM9",149,0)
EXIT D ^%ZISC,HOME^%ZIS Q
"RTN","IVMLDEM9",150,0)
 K ^TMP($J,"IVMLDEM9")
"RTN","IVMLDEM9",151,0)
 K ^TMP("IVMLDEM9",$J)
"RTN","IVMLDEM9",152,0)
 ;
"RTN","IVMLDEM9",153,0)
ADRDTCK(DFN,IVMDA2,IVMDA1) ;is the incoming address older than #2 address?
"RTN","IVMLDEM9",154,0)
 Q:'$G(DFN)!('$G(IVMDA2))!('$G(IVMDA1)) "0^MISSING INPUT PARAMETER"
"RTN","IVMLDEM9",155,0)
 N OADDRDT,NADDRDT,ERR,IVMDA,IEN92,IENS
"RTN","IVMLDEM9",156,0)
 S OADDRDT=$$GET1^DIQ(2,DFN_",",.118,"I","","ERR") Q:$D(ERR) "0^OLD ADDR ERROR"
"RTN","IVMLDEM9",157,0)
 S IEN92=$O(^IVM(301.92,"C","RF171","")) Q:'IEN92 "0^BAD #301.92 ENTRY FOR RF171"
"RTN","IVMLDEM9",158,0)
 I '$D(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM","B",IEN92)) Q "0^ADDR DT NOT PRESENT"
"RTN","IVMLDEM9",159,0)
 S IVMDA=$O(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM","B",IEN92,"")) Q:'IVMDA "0^MISSING ADDR DT IN 301.5"
"RTN","IVMLDEM9",160,0)
 S IENS=IVMDA_","_IVMDA1_","_IVMDA2_","
"RTN","IVMLDEM9",161,0)
 S NADDRDT=$$GET1^DIQ(301.511,IENS,.02,"I","","ERR") Q:$D(ERR) "0^NEW ADDR ERROR"
"RTN","IVMLDEM9",162,0)
 Q:(OADDRDT="")&(NADDRDT="") 0
"RTN","IVMLDEM9",163,0)
 Q:(NADDRDT="")!(OADDRDT'<NADDRDT) 1
"RTN","IVMLDEM9",164,0)
 Q "0^INCOMING ADDRESS IS NEWER THAN PATIENT FILE ADDR"
"RTN","IVMLDEM9",165,0)
 ;
"RTN","IVMLDEM9",166,0)
PHNDTCK(DFN,IVMDA2,IVMDA1) ;is the incoming phone # older than #2 phone #?
"RTN","IVMLDEM9",167,0)
 Q:'$G(DFN)!('$G(IVMDA2))!('$G(IVMDA1)) "0^MISSING INPUT PARAMETER"
"RTN","IVMLDEM9",168,0)
 N OPHNDT,NPHNDT,ERR,IVMDA,IEN92,IENS
"RTN","IVMLDEM9",169,0)
 S OPHNDT=$$GET1^DIQ(2,DFN_",",.1321,"I","","ERR") Q:$D(ERR) "0^OLD PHN ERROR"
"RTN","IVMLDEM9",170,0)
 S IEN92=$O(^IVM(301.92,"C","RF171P","")) Q:'IEN92 "0^BAD #301.92 ENTRY FOR RF171P"
"RTN","IVMLDEM9",171,0)
 I '$D(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM","B",IEN92)) Q "0^PHN DT NOT PRESENT"
"RTN","IVMLDEM9",172,0)
 S IVMDA=$O(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM","B",IEN92,"")) Q:'IVMDA "0^MISSING PHN DT IN 301.5"
"RTN","IVMLDEM9",173,0)
 S IENS=IVMDA_","_IVMDA1_","_IVMDA2_","
"RTN","IVMLDEM9",174,0)
 S NPHNDT=$$GET1^DIQ(301.511,IENS,.02,"I","","ERR") Q:$D(ERR) "0^NEW PHN ERROR"
"RTN","IVMLDEM9",175,0)
 Q:(OPHNDT="")&(NPHNDT="") 0
"RTN","IVMLDEM9",176,0)
 Q:(NPHNDT="")!(OPHNDT'<NPHNDT) 1
"RTN","IVMLDEM9",177,0)
 Q "0^INCOMING PHONE # IS NEWER THAN PATIENT FILE PHONE #"
"RTN","IVMLDEM9",178,0)
 ;
"RTN","IVMLDEM9",179,0)
MEMBER() ;Return 0 if mail group has no local or remote member
"RTN","IVMLDEM9",180,0)
 N RESULT,IVMIEN,IVMRMT
"RTN","IVMLDEM9",181,0)
 S RESULT=1
"RTN","IVMLDEM9",182,0)
 S IVMIEN=$$FIND1^DIC(3.8,"","X","IVM ADDR UPDT REPORT")
"RTN","IVMLDEM9",183,0)
 D LIST^DIC(3.812,","_IVMIEN_",",.01,"P","","","","","","","IVMRMT")
"RTN","IVMLDEM9",184,0)
 I ($P($G(IVMRMT("DILIST",0)),U)'>0),('$$GOTLOCAL^XMXAPIG("IVM ADDR UPDT REPORT")) S RESULT=0
"RTN","IVMLDEM9",185,0)
 Q RESULT
"RTN","IVMLDEM9",186,0)
EMAIL ;Set up parameters to email the report
"RTN","IVMLDEM9",187,0)
 ;If called within a task, protect variables
"RTN","IVMLDEM9",188,0)
 I $D(ZTQUEUED) N %,DIFROM
"RTN","IVMLDEM9",189,0)
 N RDT
"RTN","IVMLDEM9",190,0)
 D NOW^%DTC S Y=% X ^DD("DD")
"RTN","IVMLDEM9",191,0)
 S RDT=$P(Y,"@",1)_"@"_$P($P(Y,"@",2),":",1,2)
"RTN","IVMLDEM9",192,0)
 S XMSUB="IVM Address Pending Review ("_RDT_")"
"RTN","IVMLDEM9",193,0)
 S XMY("G.IVM ADDR UPDT REPORT")=""
"RTN","IVMLDEM9",194,0)
 I $G(^TMP($J,"IVMLDEM9","TOTAL"))<1 D
"RTN","IVMLDEM9",195,0)
 . D LNPLUS
"RTN","IVMLDEM9",196,0)
 . S ^TMP($J,"IVMLDEM9",IVMLN)=""
"RTN","IVMLDEM9",197,0)
 . D LNPLUS
"RTN","IVMLDEM9",198,0)
 . S ^TMP($J,"IVMLDEM9",IVMLN)="*** NO RECORDS TO PRINT ***"
"RTN","IVMLDEM9",199,0)
 S XMTEXT="^TMP($J,""IVMLDEM9"","
"RTN","IVMLDEM9",200,0)
 D ^XMD
"RTN","IVMLDEM9",201,0)
 Q
"RTN","IVMLDEM9",202,0)
QUE ;Que the task if user invokes option
"RTN","IVMLDEM9",203,0)
 N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTSK,ZUSR,POP,X,ERR,IOP
"RTN","IVMLDEM9",204,0)
 W !
"RTN","IVMLDEM9",205,0)
 S ZTIO=""
"RTN","IVMLDEM9",206,0)
 S ZTRTN="PRINT^IVMLDEM9"
"RTN","IVMLDEM9",207,0)
 S ZTDESC="IVM AUTO ADDRESS UPLOAD RPT"
"RTN","IVMLDEM9",208,0)
 D ^%ZTLOAD
"RTN","IVMLDEM9",209,0)
 D ^%ZISC,HOME^%ZIS
"RTN","IVMLDEM9",210,0)
 W !,$S($D(ZTSK):"REQUEST QUEUED AS TASK#"_ZTSK,1:"REQUEST CANCELLED!")
"RTN","IVMLDEM9",211,0)
 Q
"RTN","IVMLDEM9",212,0)
TOTAL ;Display record total on the report
"RTN","IVMLDEM9",213,0)
 N IVMTOTAL
"RTN","IVMLDEM9",214,0)
 S IVMTOTAL=$G(^TMP($J,"IVMLDEM9","TOTAL"))
"RTN","IVMLDEM9",215,0)
 D
"RTN","IVMLDEM9",216,0)
 . D LNPLUS
"RTN","IVMLDEM9",217,0)
 . S ^TMP($J,"IVMLDEM9",IVMLN)=""
"RTN","IVMLDEM9",218,0)
 . D LNPLUS
"RTN","IVMLDEM9",219,0)
 . S ^TMP($J,"IVMLDEM9",IVMLN)="TOTAL RECORD(S): "_$G(IVMTOTAL)
"RTN","IVMLDEM9",220,0)
 Q
"RTN","IVMLDEM9",221,0)
LNPLUS ;Increase line number for the email text
"RTN","IVMLDEM9",222,0)
 S IVMLN=$G(IVMLN)+1
"RTN","IVMLDEM9",223,0)
 Q
"VER")
8.0^22.2
"BLD",10904,6)
^147
**END**
**END**

