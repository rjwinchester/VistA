Released IVM*2*172 SEQ #146
Extracted from mail message
**KIDS**:IVM*2.0*172^

**INSTALL NAME**
IVM*2.0*172
"BLD",10495,0)
IVM*2.0*172^INCOME VERIFICATION MATCH^0^3181012^y
"BLD",10495,1,0)
^^2^2^3180910^
"BLD",10495,1,1,0)
Please see the IVM*2.0*172 patch description for detailed information 
"BLD",10495,1,2,0)
regarding this patch.
"BLD",10495,4,0)
^9.64PA^^
"BLD",10495,6.3)
27
"BLD",10495,"ABPKG")
n
"BLD",10495,"KRN",0)
^9.67PA^779.2^20
"BLD",10495,"KRN",.4,0)
.4
"BLD",10495,"KRN",.4,"NM",0)
^9.68A^^
"BLD",10495,"KRN",.401,0)
.401
"BLD",10495,"KRN",.401,"NM",0)
^9.68A^^
"BLD",10495,"KRN",.402,0)
.402
"BLD",10495,"KRN",.402,"NM",0)
^9.68A^^
"BLD",10495,"KRN",.403,0)
.403
"BLD",10495,"KRN",.403,"NM",0)
^9.68A^^
"BLD",10495,"KRN",.5,0)
.5
"BLD",10495,"KRN",.5,"NM",0)
^9.68A^^
"BLD",10495,"KRN",.84,0)
.84
"BLD",10495,"KRN",.84,"NM",0)
^9.68A^^
"BLD",10495,"KRN",3.6,0)
3.6
"BLD",10495,"KRN",3.6,"NM",0)
^9.68A^^
"BLD",10495,"KRN",3.8,0)
3.8
"BLD",10495,"KRN",3.8,"NM",0)
^9.68A^^0
"BLD",10495,"KRN",9.2,0)
9.2
"BLD",10495,"KRN",9.2,"NM",0)
^9.68A^^
"BLD",10495,"KRN",9.8,0)
9.8
"BLD",10495,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",10495,"KRN",9.8,"NM",1,0)
IVMPREC3^^0^B25802932
"BLD",10495,"KRN",9.8,"NM",2,0)
IVMLINS3^^0^B15147489
"BLD",10495,"KRN",9.8,"NM","B","IVMLINS3",2)

"BLD",10495,"KRN",9.8,"NM","B","IVMPREC3",1)

"BLD",10495,"KRN",19,0)
19
"BLD",10495,"KRN",19,"NM",0)
^9.68A^^0
"BLD",10495,"KRN",19.1,0)
19.1
"BLD",10495,"KRN",19.1,"NM",0)
^9.68A^^0
"BLD",10495,"KRN",101,0)
101
"BLD",10495,"KRN",101,"NM",0)
^9.68A^^0
"BLD",10495,"KRN",409.61,0)
409.61
"BLD",10495,"KRN",409.61,"NM",0)
^9.68A^^0
"BLD",10495,"KRN",771,0)
771
"BLD",10495,"KRN",771,"NM",0)
^9.68A^^0
"BLD",10495,"KRN",779.2,0)
779.2
"BLD",10495,"KRN",779.2,"NM",0)
^9.68A^^
"BLD",10495,"KRN",870,0)
870
"BLD",10495,"KRN",870,"NM",0)
^9.68A^^
"BLD",10495,"KRN",8989.51,0)
8989.51
"BLD",10495,"KRN",8989.51,"NM",0)
^9.68A^^
"BLD",10495,"KRN",8989.52,0)
8989.52
"BLD",10495,"KRN",8989.52,"NM",0)
^9.68A^^
"BLD",10495,"KRN",8994,0)
8994
"BLD",10495,"KRN",8994,"NM",0)
^9.68A^^
"BLD",10495,"KRN","B",.4,.4)

"BLD",10495,"KRN","B",.401,.401)

"BLD",10495,"KRN","B",.402,.402)

"BLD",10495,"KRN","B",.403,.403)

"BLD",10495,"KRN","B",.5,.5)

"BLD",10495,"KRN","B",.84,.84)

"BLD",10495,"KRN","B",3.6,3.6)

"BLD",10495,"KRN","B",3.8,3.8)

"BLD",10495,"KRN","B",9.2,9.2)

"BLD",10495,"KRN","B",9.8,9.8)

"BLD",10495,"KRN","B",19,19)

"BLD",10495,"KRN","B",19.1,19.1)

"BLD",10495,"KRN","B",101,101)

"BLD",10495,"KRN","B",409.61,409.61)

"BLD",10495,"KRN","B",771,771)

"BLD",10495,"KRN","B",779.2,779.2)

"BLD",10495,"KRN","B",870,870)

"BLD",10495,"KRN","B",8989.51,8989.51)

"BLD",10495,"KRN","B",8989.52,8989.52)

"BLD",10495,"KRN","B",8994,8994)

"BLD",10495,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",10495,"QUES",0)
^9.62^^
"BLD",10495,"REQB",0)
^9.611^2^2
"BLD",10495,"REQB",1,0)
IVM*2.0*115^1
"BLD",10495,"REQB",2,0)
IVM*2.0*121^1
"BLD",10495,"REQB","B","IVM*2.0*115",1)

"BLD",10495,"REQB","B","IVM*2.0*121",2)

"MBREQ")
0
"PKG",120,-1)
1^1
"PKG",120,0)
INCOME VERIFICATION MATCH^IVM^IVM Software for interface with the IVM Center
"PKG",120,20,0)
^9.402P^^
"PKG",120,22,0)
^9.49I^1^1
"PKG",120,22,1,0)
2.0^2941021^2960823
"PKG",120,22,1,"PAH",1,0)
172^3181012
"PKG",120,22,1,"PAH",1,1,0)
^^2^2^3181012
"PKG",120,22,1,"PAH",1,1,1,0)
Please see the IVM*2.0*172 patch description for detailed information 
"PKG",120,22,1,"PAH",1,1,2,0)
regarding this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","IVMLINS3")
0^2^B15147489^B12231839
"RTN","IVMLINS3",1,0)
IVMLINS3 ;ALB/KCL,TDM,HM - IVM INSURANCE POLICY TRANSFER ;3/9/09 2:01pm
"RTN","IVMLINS3",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**14,111,121,172**;21-OCT-94;Build 27
"RTN","IVMLINS3",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IVMLINS3",4,0)
 ;
"RTN","IVMLINS3",5,0)
 ;
"RTN","IVMLINS3",6,0)
 ;
"RTN","IVMLINS3",7,0)
TRANSFER(IVMAUTO) ; user has chosen to transfer insurance information,
"RTN","IVMLINS3",8,0)
 ; received from HEC, to the MCCR insurance buffer.  this routine
"RTN","IVMLINS3",9,0)
 ; will call $$ADDSTF^IBCNBES(3,DFN,IVMIBDAT) to place HEC's insurance
"RTN","IVMLINS3",10,0)
 ; information in the MCCR insurance buffer where authorized insurance
"RTN","IVMLINS3",11,0)
 ; personnel will either upload or reject the data.
"RTN","IVMLINS3",12,0)
 ;      3 indicates that source of information is IVM
"RTN","IVMLINS3",13,0)
 ;      IVMIBDAT = data, to be filed in the MCCR buffer, in an array
"RTN","IVMLINS3",14,0)
 ;                 subscripted by field number of the data field in
"RTN","IVMLINS3",15,0)
 ;                 the INSURANCE BUFFER file (#355.33) 
"RTN","IVMLINS3",16,0)
 ; INPUT: IVMAUTO = 1 if auto-filing directly from upload
"RTN","IVMLINS3",17,0)
 ;                  0 if using list manager interface to file
"RTN","IVMLINS3",18,0)
 ;        THE FOLLOWING ARE ASSUMED TO BE DEFINED:
"RTN","IVMLINS3",19,0)
 ;          IVMIN1 (ST/ST1 segment string nodes of file 301.5)
"RTN","IVMLINS3",20,0)
 ;          IVMADD (5th "^" piece of IVMIN1 for ins co address data)
"RTN","IVMLINS3",21,0)
 ;
"RTN","IVMLINS3",22,0)
 ; Supported ICR #2537: Supports use of ADDSTF^IBCNBES to add a
"RTN","IVMLINS3",23,0)
 ;                      new entry to the INSURANCE BUFFER file (#355.33)
"RTN","IVMLINS3",24,0)
 ;
"RTN","IVMLINS3",25,0)
 N IVMIB,IVMIBDAT,IVMNOI,IVMPRTI
"RTN","IVMLINS3",26,0)
 ;
"RTN","IVMLINS3",27,0)
 I '$G(IVMAUTO) W !!,"Transferring HEC'S insurance data to the MCCR insurance buffer",!
"RTN","IVMLINS3",28,0)
 S IVMNOI=$S($P(IVMIN1,HLFS,17)="v":$P($$PT^IVMUFNC4(DFN),"^"),1:$P(IVMIN1,HLFS,16))
"RTN","IVMLINS3",29,0)
 S IVMPRTI=$S($P(IVMIN1,HLFS,17)="v":"01",1:"02")
"RTN","IVMLINS3",30,0)
 ;
"RTN","IVMLINS3",31,0)
 S IVMIBDAT(20.01)=$E($P(IVMIN1,HLFS,4),1,30) ;ins co name
"RTN","IVMLINS3",32,0)
 S IVMIBDAT(20.02)=$E($P(IVMIN1,HLFS,7),1,20) ;phone number
"RTN","IVMLINS3",33,0)
 S IVMIBDAT(21.01)=$E($P(IVMADD,"~",1),1,35) ;street add [line 1]
"RTN","IVMLINS3",34,0)
 S IVMIBDAT(21.02)=$E($P(IVMADD,"~",2),1,30) ;street add [line 2]
"RTN","IVMLINS3",35,0)
 S IVMIBDAT(21.03)=$E($P(IVMADD,"~",8),1,30) ;street add [line 3]
"RTN","IVMLINS3",36,0)
 S IVMIBDAT(21.04)=$E($P(IVMADD,"~",3),1,25) ;city
"RTN","IVMLINS3",37,0)
 S IVMIBDAT(21.05)=$$STATE1^IVMUFNC4($P(IVMADD,"~",4)) ;state
"RTN","IVMLINS3",38,0)
 S IVMIBDAT(21.06)=$E($P(IVMADD,"~",5),1,20) ;zip
"RTN","IVMLINS3",39,0)
 S IVMIBDAT(40.02)=$E($P(IVMIN1,HLFS,9),1,20) ;group name
"RTN","IVMLINS3",40,0)
 S IVMIBDAT(40.03)=$E($P(IVMIN1,HLFS,8),1,17) ;group number
"RTN","IVMLINS3",41,0)
 S IVMIBDAT(40.05)=$S($P(IVMIN1,HLFS,28)=1:1,1:0) ;precertification required
"RTN","IVMLINS3",42,0)
 S IVMIBDAT(40.09)=$P(IVMIN1,HLFS,15) ;type of plan
"RTN","IVMLINS3",43,0)
 S IVMIBDAT(60.01)=DFN ;patient name
"RTN","IVMLINS3",44,0)
 S IVMIBDAT(60.02)=$$FMDATE^HLFNC($P(IVMIN1,HLFS,12)) ;effective date
"RTN","IVMLINS3",45,0)
 S IVMIBDAT(60.03)=$$FMDATE^HLFNC($P(IVMIN1,HLFS,13)) ;expiration date
"RTN","IVMLINS3",46,0)
 S IVMIBDAT(60.04)=$E($P(IVMIN1,HLFS,36),1,20) ;subcriber id
"RTN","IVMLINS3",47,0)
 S IVMIBDAT(60.05)=$P(IVMIN1,HLFS,17) ;whose insurance
"RTN","IVMLINS3",48,0)
 S IVMIBDAT(60.06)=IVMPRTI ;pt relationship to insured
"RTN","IVMLINS3",49,0)
 S IVMIBDAT(60.07)=IVMNOI ;name of insured
"RTN","IVMLINS3",50,0)
 S IVMIBDAT(60.08)=$P(IVMIN1,HLFS,18) ;insured's date of birth IVM*2.0*172 HM
"RTN","IVMLINS3",51,0)
 ;
"RTN","IVMLINS3",52,0)
 I '$G(IVMSOI) S IVMSOI=$P(IVMZIV,HLFS,13) ;set Source of Information if missing IVM*2.0*172 HM
"RTN","IVMLINS3",53,0)
 S IVMIB=$$ADDSTF^IBCNBES(IVMSOI,DFN,.IVMIBDAT) ;updated to pass in IVMSOI from ZIV sequence 13 IVM*2.0*172 HM
"RTN","IVMLINS3",54,0)
 I 'IVMIB D  Q
"RTN","IVMLINS3",55,0)
 .Q:$G(IVMAUTO)
"RTN","IVMLINS3",56,0)
 .W !,"The following error occurred when transferring data:"
"RTN","IVMLINS3",57,0)
 .W !,$P(IVMIB,"^",2)
"RTN","IVMLINS3",58,0)
 .W !,"Please contact your IRM staff for help"
"RTN","IVMLINS3",59,0)
 ;
"RTN","IVMLINS3",60,0)
 N DA,DIE,DR
"RTN","IVMLINS3",61,0)
 S DA=IVMJ,DA(1)=IVMI
"RTN","IVMLINS3",62,0)
 ;
"RTN","IVMLINS3",63,0)
 ; - delete segment name (.02 field of 301.501 multiple) from IVM PATIENT
"RTN","IVMLINS3",64,0)
 ;   file to remove from ASEG cross-reference
"RTN","IVMLINS3",65,0)
 S DIE="^IVM(301.5,"_DA(1)_",""IN"",",DR=".02////@" D ^DIE
"RTN","IVMLINS3",66,0)
 ;
"RTN","IVMLINS3",67,0)
 I $G(IVMAUTO) G IVMQ
"RTN","IVMLINS3",68,0)
 ;
"RTN","IVMLINS3",69,0)
 W "completed.",!
"RTN","IVMLINS3",70,0)
 ;
"RTN","IVMLINS3",71,0)
 S DIR(0)="E",DIR("A")="Press RETURN to continue" D ^DIR K DIR
"RTN","IVMLINS3",72,0)
 ;
"RTN","IVMLINS3",73,0)
REMOVE ; - remove entry from the List Manager display after transferring
"RTN","IVMLINS3",74,0)
 K ^TMP("IVMIUPL",$J,IVMNAME,IVMI,IVMJ)
"RTN","IVMLINS3",75,0)
 ;
"RTN","IVMLINS3",76,0)
 ; - action completed
"RTN","IVMLINS3",77,0)
 S IVMDONE=1
"RTN","IVMLINS3",78,0)
 ;
"RTN","IVMLINS3",79,0)
IVMQ K DIRUT,DTOUT,DUOUT,IVMACT,IVMDA,IVMFLAG,IVMREPTR,IVMSOI,IVMZIV,X,Y ;IVM*2.0*172 HM
"RTN","IVMLINS3",80,0)
 Q
"RTN","IVMLINS3",81,0)
 ;
"RTN","IVMLINS3",82,0)
AUTO ; Auto-upload all Z04 entries pending in file 301.501
"RTN","IVMLINS3",83,0)
 ; Called by the patch IVM*2*111 post-install
"RTN","IVMLINS3",84,0)
 N DFN,IVMI,IVMJ,IVMIN1,IVMADD,IVM0NOD,HLFS
"RTN","IVMLINS3",85,0)
 S HLFS=U
"RTN","IVMLINS3",86,0)
 ;
"RTN","IVMLINS3",87,0)
 S IVMI=0 F  S IVMI=$O(^IVM(301.5,"ASEG","IN1",IVMI)) Q:'IVMI  D
"RTN","IVMLINS3",88,0)
 . S IVMJ=0 F  S IVMJ=$O(^IVM(301.5,"ASEG","IN1",IVMI,IVMJ)) Q:'IVMJ  D
"RTN","IVMLINS3",89,0)
 .. S IVM0NOD=$G(^IVM(301.5,IVMI,0)) I IVM0NOD']"" Q
"RTN","IVMLINS3",90,0)
 .. S DFN=+IVM0NOD
"RTN","IVMLINS3",91,0)
 .. I $G(^DPT(+DFN,0))']"" Q
"RTN","IVMLINS3",92,0)
 .. Q:$P($G(^IVM(301.5,IVMI,"IN",IVMJ,0)),U,2)'="IN1"
"RTN","IVMLINS3",93,0)
 .. S IVMIN1=$$GETIN1^IVMLINS1(IVMI,IVMJ)
"RTN","IVMLINS3",94,0)
 .. Q:IVMIN1=""
"RTN","IVMLINS3",95,0)
 .. S IVMADD=$P(IVMIN1,U,5)
"RTN","IVMLINS3",96,0)
 .. D TRANSFER(1)
"RTN","IVMLINS3",97,0)
 ;
"RTN","IVMLINS3",98,0)
 Q
"RTN","IVMLINS3",99,0)
 ;
"RTN","IVMPREC3")
0^1^B25802932^B20718682
"RTN","IVMPREC3",1,0)
IVMPREC3 ;ALB/KCL/CKN,TDM,HM - PROCESS INCOMING (Z04 EVENT TYPE) HL7 MESSAGES ;8/15/08 10:21am
"RTN","IVMPREC3",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**3,17,34,111,115,172**;21-OCT-94;Build 27
"RTN","IVMPREC3",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IVMPREC3",4,0)
 ;
"RTN","IVMPREC3",5,0)
 ;
"RTN","IVMPREC3",6,0)
 ; This routine will process batch ORU insurance(event type Z04) HL7
"RTN","IVMPREC3",7,0)
 ; messages received from the IVM center.  Format of batch:
"RTN","IVMPREC3",8,0)
 ;       BHS
"RTN","IVMPREC3",9,0)
 ;       {MSH
"RTN","IVMPREC3",10,0)
 ;        PID
"RTN","IVMPREC3",11,0)
 ;        IN1    could be a continuation of IN1
"RTN","IVMPREC3",12,0)
 ;        ZIV
"RTN","IVMPREC3",13,0)
 ;       }
"RTN","IVMPREC3",14,0)
 ;       BTS
"RTN","IVMPREC3",15,0)
 ;
"RTN","IVMPREC3",16,0)
EN ; - entry point to process insurance messages
"RTN","IVMPREC3",17,0)
 ;
"RTN","IVMPREC3",18,0)
 N IVMPID,PIDSTR,COMP,CNTR,NOPID,TMPARY,PID3ARY,ICN,DFN,CNTR2,IVMZIV,IVMIDOB ;IVM*2.0*172 HM
"RTN","IVMPREC3",19,0)
 F IVMDA=1:0 S IVMDA=$O(^TMP($J,IVMRTN,IVMDA)) Q:'IVMDA  S IVMSEG=$G(^(IVMDA,0)) I $E(IVMSEG,1,3)="MSH" D
"RTN","IVMPREC3",20,0)
 .K HLERR
"RTN","IVMPREC3",21,0)
 .;
"RTN","IVMPREC3",22,0)
 .; - message control id from MSH segment
"RTN","IVMPREC3",23,0)
 .S MSGID=$P(IVMSEG,HLFS,10)
"RTN","IVMPREC3",24,0)
 .;
"RTN","IVMPREC3",25,0)
 .; - get message segments from (#772) file
"RTN","IVMPREC3",26,0)
 .S IVMDA=$O(^TMP($J,IVMRTN,IVMDA)),IVMSEG=$G(^(+IVMDA,0)) I $E(IVMSEG,1,3)'="PID" D  Q
"RTN","IVMPREC3",27,0)
 ..S HLERR="Missing PID segment" D ACK^IVMPREC
"RTN","IVMPREC3",28,0)
 .S CNTR=1,NOPID=0,PIDSTR(CNTR)=$P(IVMSEG,HLFS,2,999)
"RTN","IVMPREC3",29,0)
 .;Handle wrapped PID segment
"RTN","IVMPREC3",30,0)
 .F I=1:1 D  Q:NOPID
"RTN","IVMPREC3",31,0)
 ..S IVMDA=$O(^TMP($J,IVMRTN,IVMDA)),IVMSEG=$G(^(+IVMDA,0))
"RTN","IVMPREC3",32,0)
 ..I $E(IVMSEG,1,4)="IN1^" S NOPID=1,IVMDA=IVMDA-1 Q
"RTN","IVMPREC3",33,0)
 ..S CNTR=CNTR+1,PIDSTR(CNTR)=IVMSEG
"RTN","IVMPREC3",34,0)
 .D BLDPID^IVMPREC6(.PIDSTR,.IVMPID)  ;Create IVMPID subscripted by seq #
"RTN","IVMPREC3",35,0)
 .;convert "" to null for PID segment
"RTN","IVMPREC3",36,0)
 .S CNTR="" F  S CNTR=$O(IVMPID(CNTR)) Q:CNTR=""  D
"RTN","IVMPREC3",37,0)
 ..I $O(IVMPID(CNTR,"")) D  Q
"RTN","IVMPREC3",38,0)
 ...S CNTR2="" F  S CNTR2=$O(IVMPID(CNTR,CNTR2)) Q:CNTR2=""  D
"RTN","IVMPREC3",39,0)
 ....S IVMPID(CNTR,CNTR2)=$$CLEARF^IVMPRECA(IVMPID(CNTR,CNTR2),$E(HLECH))
"RTN","IVMPREC3",40,0)
 ..I IVMPID(CNTR)=HLQ S IVMPID(CNTR)=""
"RTN","IVMPREC3",41,0)
 .M TMPARY(3)=IVMPID(3) D PARSPID3^IVMUFNC(.TMPARY,.PID3ARY)
"RTN","IVMPREC3",42,0)
 .S DFN=$G(PID3ARY("PI")),ICN=$G(PID3ARY("NI"))
"RTN","IVMPREC3",43,0)
 .K TMPARY,PID3ARY
"RTN","IVMPREC3",44,0)
 .I '$$MATCH^IVMUFNC(DFN,ICN,"","","I",.ERRMSG) S HLERR=ERRMSG D ACK^IVMPREC Q
"RTN","IVMPREC3",45,0)
 .S IVMDA=$O(^TMP($J,IVMRTN,IVMDA)),IVMSEG=$G(^(+IVMDA,0)) I $E(IVMSEG,1,3)'="IN1" D  Q
"RTN","IVMPREC3",46,0)
 ..S HLERR="Missing IN1 segment" D ACK^IVMPREC
"RTN","IVMPREC3",47,0)
 .S IVMSEG1=$$CLEARF^IVMPRECA($P(IVMSEG,HLFS,2,999),HLFS,",5,")
"RTN","IVMPREC3",48,0)
 .S $P(IVMSEG1,HLFS,5)=$$CLEARF^IVMPRECA($P(IVMSEG1,HLFS,5),$E(HLECH))
"RTN","IVMPREC3",49,0)
 .I $P(IVMSEG1,HLFS,4)']"" D  Q
"RTN","IVMPREC3",50,0)
 ..S HLERR="Missing insurance company name" D ACK^IVMPREC
"RTN","IVMPREC3",51,0)
 .I $P(IVMSEG1,HLFS,8)']"",($P(IVMSEG1,HLFS,9)']"") D  Q
"RTN","IVMPREC3",52,0)
 ..S HLERR=$S($P(IVMSEG1,HLFS,7)']"":"Missing group number",1:"Missing group name") D ACK^IVMPREC
"RTN","IVMPREC3",53,0)
 .I $P(IVMSEG1,HLFS,17)']"" D  Q
"RTN","IVMPREC3",54,0)
 ..S HLERR="Missing insured's relation to patient" D ACK^IVMPREC
"RTN","IVMPREC3",55,0)
 .I $P(IVMSEG1,HLFS,17)'="v",($P(IVMSEG1,HLFS,16)']"") D  Q
"RTN","IVMPREC3",56,0)
 ..S HLERR="Missing name of insured" D ACK^IVMPREC
"RTN","IVMPREC3",57,0)
 .I $P(IVMSEG1,HLFS,17)'="v",($P(IVMSEG1,HLFS,18)="") D  Q
"RTN","IVMPREC3",58,0)
 ..S HLERR="Missing Insured's Date of Birth" D ACK^IVMPREC
"RTN","IVMPREC3",59,0)
 .; - IVM Insured's Date of Birth IVM*2.0*172 HM
"RTN","IVMPREC3",60,0)
 .I $P(IVMSEG1,HLFS,17)'="v",($P(IVMSEG1,HLFS,18)]"") S IVMIDOB=$$FMDATE^HLFNC($P(IVMSEG1,HLFS,18))
"RTN","IVMPREC3",61,0)
 .S IVMDA=$O(^TMP($J,IVMRTN,IVMDA)),IVMSEG=$G(^(+IVMDA,0)) I $E(IVMSEG,1,3)'="ZIV",$L(IVMSEG1)'=241 D  Q
"RTN","IVMPREC3",62,0)
 ..S HLERR="Missing ZIV segment" D ACK^IVMPREC
"RTN","IVMPREC3",63,0)
 .S IVMSEG=$$CLEARF^IVMPRECA(IVMSEG,HLFS)
"RTN","IVMPREC3",64,0)
 .I $P(IVMSEG,HLFS,10)']"" D  Q
"RTN","IVMPREC3",65,0)
 ..S HLERR="Missing IVM internal entry number" D ACK^IVMPREC
"RTN","IVMPREC3",66,0)
 .I $L(IVMSEG1)=241 D  Q:$D(IVMERR)
"RTN","IVMPREC3",67,0)
 ..K IVMERR
"RTN","IVMPREC3",68,0)
 ..S IVMSEG3=IVMSEG
"RTN","IVMPREC3",69,0)
 ..S IVMDA=$O(^TMP($J,IVMRTN,IVMDA)),IVMSEG=$$CLEARF^IVMPRECA($G(^(+IVMDA,0)),HLFS)
"RTN","IVMPREC3",70,0)
 ..I $E(IVMSEG,1,3)'="ZIV" S HLERR="Missing ZIV segment",IVMERR="" D ACK^IVMPREC
"RTN","IVMPREC3",71,0)
 .;S IVMSEG2=$P(IVMSEG,"^",10)
"RTN","IVMPREC3",72,0)
 .; - set IVM ZIV segment data IVM*2.0*172 HM
"RTN","IVMPREC3",73,0)
 .I $E(IVMSEG,1,3)="ZIV" S IVMZIV=IVMSEG
"RTN","IVMPREC3",74,0)
 .;
"RTN","IVMPREC3",75,0)
 .; - check for date of death from IVM
"RTN","IVMPREC3",76,0)
 .I $P(IVMSEG,"^",13)]"" S $P(IVMSEG,"^",13)=$$FMDATE^HLFNC($P(IVMSEG,"^",13))
"RTN","IVMPREC3",77,0)
 .;
"RTN","IVMPREC3",78,0)
 .; - ivm ien/fm date of death
"RTN","IVMPREC3",79,0)
 .S IVMSEG2=$S($P(IVMSEG,"^",13)']"":$P(IVMSEG,"^",10),1:$P(IVMSEG,"^",10)_"/"_$P(IVMSEG,"^",13))
"RTN","IVMPREC3",80,0)
 .S IVMDOD=IVMSEG2
"RTN","IVMPREC3",81,0)
 .;
"RTN","IVMPREC3",82,0)
 .; - IVM Source of Information IVM*2.0*172 HM
"RTN","IVMPREC3",83,0)
 .N IVMSOI
"RTN","IVMPREC3",84,0)
 .S IVMSOI=$P(IVMSEG,"^",14)
"RTN","IVMPREC3",85,0)
 .I IVMSOI'=3&(IVMSOI'=14) D  Q
"RTN","IVMPREC3",86,0)
 ..S HLERR="Invalid Source of Information code expecting 3 or 14" D ACK^IVMPREC
"RTN","IVMPREC3",87,0)
 .;
"RTN","IVMPREC3",88,0)
 .; - if no error encountered - store insurance fields in VistA
"RTN","IVMPREC3",89,0)
 .I '$D(HLERR) D
"RTN","IVMPREC3",90,0)
 ..N IVMRTN,IVMDA
"RTN","IVMPREC3",91,0)
 ..D STORE
"RTN","IVMPREC3",92,0)
 ;
"RTN","IVMPREC3",93,0)
 Q
"RTN","IVMPREC3",94,0)
 ;
"RTN","IVMPREC3",95,0)
 ;
"RTN","IVMPREC3",96,0)
STORE ; - store IN1 segment fields in (#301.5) file and in buffer file
"RTN","IVMPREC3",97,0)
 ;  (remove data from 301.5 'ASEG' xref on successful buffer file filing)
"RTN","IVMPREC3",98,0)
 ;
"RTN","IVMPREC3",99,0)
 N IVMI,IVMJ,IVMIN1,IVMADD
"RTN","IVMPREC3",100,0)
 S DA(1)=$O(^IVM(301.5,"B",DFN,0)),X=$$IEN^IVMUFNC4("IN1")
"RTN","IVMPREC3",101,0)
 I DA(1)']"" S HLERR="patient missing from IVM PATIENT file" D ACK^IVMPREC Q
"RTN","IVMPREC3",102,0)
 I X<0 S HLERR="IN1 segment not in HL7 SEGMENT NAME file" D ACK^IVMPREC Q
"RTN","IVMPREC3",103,0)
 I $G(^IVM(301.5,DA(1),"IN",0))']"" S ^(0)="^301.501PA^^"
"RTN","IVMPREC3",104,0)
 S DIC="^IVM(301.5,"_DA(1)_",""IN"",",DIC(0)="L"
"RTN","IVMPREC3",105,0)
 S DIC("DR")=".03///NOW;.07////^S X=IVMSEG2;10////^S X=IVMSEG1",DLAYGO=301.501
"RTN","IVMPREC3",106,0)
 S:$D(IVMSEG3) DIC("DR")=".03///NOW;.07////^S X=IVMSEG2;10////^S X=IVMSEG1;11////^S X=IVMSEG3"
"RTN","IVMPREC3",107,0)
 K DD,DO D FILE^DICN K DIC,DLAYGO
"RTN","IVMPREC3",108,0)
 Q:Y'>0
"RTN","IVMPREC3",109,0)
 S IVMI=DA(1),IVMJ=+Y
"RTN","IVMPREC3",110,0)
 ; Patch IVMB*2*111 automatically files the record into the buffer file
"RTN","IVMPREC3",111,0)
 ; and removes the notification bulletin to IVM and the segment from
"RTN","IVMPREC3",112,0)
 ; file 301.501
"RTN","IVMPREC3",113,0)
 K DA,X,Y
"RTN","IVMPREC3",114,0)
 S IVMIN1=$$GETIN1^IVMLINS1(IVMI,IVMJ),IVMADD=$P(IVMIN1,U,5)
"RTN","IVMPREC3",115,0)
 D TRANSFER^IVMLINS3(1),IVMQ^IVMLINS1
"RTN","IVMPREC3",116,0)
 Q
"RTN","IVMPREC3",117,0)
 ;
"VER")
8.0^22.2
"BLD",10495,6)
^146
**END**
**END**

