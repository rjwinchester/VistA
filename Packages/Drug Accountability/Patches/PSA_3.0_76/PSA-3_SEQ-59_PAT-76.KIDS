Released PSA*3*76 SEQ #59
Extracted from mail message
**KIDS**:PSA*3.0*76^

**INSTALL NAME**
PSA*3.0*76
"BLD",9399,0)
PSA*3.0*76^DRUG ACCOUNTABILITY^0^3130620^y
"BLD",9399,1,0)
^^16^16^3130620^
"BLD",9399,1,1,0)
This patch addresses the following problems:
"BLD",9399,1,2,0)
 
"BLD",9399,1,3,0)
1. INC000000443727 - Verify invoices and no action is taken
"BLD",9399,1,4,0)
When a Controlled Substance follows a drug that has a quantity of 0,
"BLD",9399,1,5,0)
the Invoice Verify routine does not create the Controlled Substance 
"BLD",9399,1,6,0)
transaction in the Drug Accountability Transaction file (#58.81).
"BLD",9399,1,7,0)
 
"BLD",9399,1,8,0)
2. INC000000212726 - Outpatient Dispensing (All Drugs) Option not working
"BLD",9399,1,9,0)
When the Outpatient Dispensing (All Drugs) [PSA OP ALL DRUGS] option is
"BLD",9399,1,10,0)
Run no updates are being made to the Drug Accountability Transaction file
"BLD",9399,1,11,0)
(#58.81) or the Drug Accountability Stats file (#58.8).
"BLD",9399,1,12,0)
 
"BLD",9399,1,13,0)
3. INC000000842761 - Drug Accountability - Drug File Updates
"BLD",9399,1,14,0)
When the invoiced Price Per Order Unit is .01 and Dispense Units Per
"BLD",9399,1,15,0)
Order Unit is 100, the Price Per Dispense Unit is calculating it at 0
"BLD",9399,1,16,0)
when it should be .0001 during invoice processing/verifying.
"BLD",9399,4,0)
^9.64PA^^
"BLD",9399,6.3)
1
"BLD",9399,"ABPKG")
n
"BLD",9399,"KRN",0)
^9.67PA^779.2^20
"BLD",9399,"KRN",.4,0)
.4
"BLD",9399,"KRN",.401,0)
.401
"BLD",9399,"KRN",.402,0)
.402
"BLD",9399,"KRN",.403,0)
.403
"BLD",9399,"KRN",.5,0)
.5
"BLD",9399,"KRN",.84,0)
.84
"BLD",9399,"KRN",3.6,0)
3.6
"BLD",9399,"KRN",3.8,0)
3.8
"BLD",9399,"KRN",9.2,0)
9.2
"BLD",9399,"KRN",9.8,0)
9.8
"BLD",9399,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",9399,"KRN",9.8,"NM",1,0)
PSAOP2^^0^B33713808
"BLD",9399,"KRN",9.8,"NM",2,0)
PSAOP4^^0^B6589601
"BLD",9399,"KRN",9.8,"NM",3,0)
PSAVER6^^0^B57426665
"BLD",9399,"KRN",9.8,"NM",4,0)
PSAVER7^^0^B24126749
"BLD",9399,"KRN",9.8,"NM","B","PSAOP2",1)

"BLD",9399,"KRN",9.8,"NM","B","PSAOP4",2)

"BLD",9399,"KRN",9.8,"NM","B","PSAVER6",3)

"BLD",9399,"KRN",9.8,"NM","B","PSAVER7",4)

"BLD",9399,"KRN",19,0)
19
"BLD",9399,"KRN",19.1,0)
19.1
"BLD",9399,"KRN",101,0)
101
"BLD",9399,"KRN",409.61,0)
409.61
"BLD",9399,"KRN",771,0)
771
"BLD",9399,"KRN",779.2,0)
779.2
"BLD",9399,"KRN",870,0)
870
"BLD",9399,"KRN",8989.51,0)
8989.51
"BLD",9399,"KRN",8989.52,0)
8989.52
"BLD",9399,"KRN",8994,0)
8994
"BLD",9399,"KRN","B",.4,.4)

"BLD",9399,"KRN","B",.401,.401)

"BLD",9399,"KRN","B",.402,.402)

"BLD",9399,"KRN","B",.403,.403)

"BLD",9399,"KRN","B",.5,.5)

"BLD",9399,"KRN","B",.84,.84)

"BLD",9399,"KRN","B",3.6,3.6)

"BLD",9399,"KRN","B",3.8,3.8)

"BLD",9399,"KRN","B",9.2,9.2)

"BLD",9399,"KRN","B",9.8,9.8)

"BLD",9399,"KRN","B",19,19)

"BLD",9399,"KRN","B",19.1,19.1)

"BLD",9399,"KRN","B",101,101)

"BLD",9399,"KRN","B",409.61,409.61)

"BLD",9399,"KRN","B",771,771)

"BLD",9399,"KRN","B",779.2,779.2)

"BLD",9399,"KRN","B",870,870)

"BLD",9399,"KRN","B",8989.51,8989.51)

"BLD",9399,"KRN","B",8989.52,8989.52)

"BLD",9399,"KRN","B",8994,8994)

"BLD",9399,"QDEF")
^^^^NO^^^^^^NO
"BLD",9399,"QUES",0)
^9.62^^
"BLD",9399,"REQB",0)
^9.611^3^2
"BLD",9399,"REQB",2,0)
PSA*3.0*15^1
"BLD",9399,"REQB",3,0)
PSA*3.0*66^1
"BLD",9399,"REQB","B","PSA*3.0*15",2)

"BLD",9399,"REQB","B","PSA*3.0*66",3)

"MBREQ")
0
"PKG",487,-1)
1^1
"PKG",487,0)
DRUG ACCOUNTABILITY^PSA^Drug Accountability Inventory and Tracking module.
"PKG",487,20,0)
^9.402P^^
"PKG",487,22,0)
^9.49I^1^1
"PKG",487,22,1,0)
3.0^2971024^2981028^66481
"PKG",487,22,1,"PAH",1,0)
76^3130620^100104
"PKG",487,22,1,"PAH",1,1,0)
^^16^16^3130620
"PKG",487,22,1,"PAH",1,1,1,0)
This patch addresses the following problems:
"PKG",487,22,1,"PAH",1,1,2,0)
 
"PKG",487,22,1,"PAH",1,1,3,0)
1. INC000000443727 - Verify invoices and no action is taken
"PKG",487,22,1,"PAH",1,1,4,0)
When a Controlled Substance follows a drug that has a quantity of 0,
"PKG",487,22,1,"PAH",1,1,5,0)
the Invoice Verify routine does not create the Controlled Substance 
"PKG",487,22,1,"PAH",1,1,6,0)
transaction in the Drug Accountability Transaction file (#58.81).
"PKG",487,22,1,"PAH",1,1,7,0)
 
"PKG",487,22,1,"PAH",1,1,8,0)
2. INC000000212726 - Outpatient Dispensing (All Drugs) Option not working
"PKG",487,22,1,"PAH",1,1,9,0)
When the Outpatient Dispensing (All Drugs) [PSA OP ALL DRUGS] option is
"PKG",487,22,1,"PAH",1,1,10,0)
Run no updates are being made to the Drug Accountability Transaction file
"PKG",487,22,1,"PAH",1,1,11,0)
(#58.81) or the Drug Accountability Stats file (#58.8).
"PKG",487,22,1,"PAH",1,1,12,0)
 
"PKG",487,22,1,"PAH",1,1,13,0)
3. INC000000842761 - Drug Accountability - Drug File Updates
"PKG",487,22,1,"PAH",1,1,14,0)
When the invoiced Price Per Order Unit is .01 and Dispense Units Per
"PKG",487,22,1,"PAH",1,1,15,0)
Order Unit is 100, the Price Per Dispense Unit is calculating it at 0
"PKG",487,22,1,"PAH",1,1,16,0)
when it should be .0001 during invoice processing/verifying.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSAOP2")
0^1^B33713808^B33216667
"RTN","PSAOP2",1,0)
PSAOP2 ;BIR/LTL-Outpatient Dispensing (All Drugs) ;7/23/97
"RTN","PSAOP2",2,0)
 ;;3.0;DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,15,76**; 10/24/97;Build 1
"RTN","PSAOP2",3,0)
 ;This routine gathers outpatient dispensing for all drugs in a location
"RTN","PSAOP2",4,0)
 ;from the PRESCRIPTION file. If present, the last outpatient dispensing
"RTN","PSAOP2",5,0)
 ;date is used as a starting point. Otherwise the user selected date is
"RTN","PSAOP2",6,0)
 ;used.
"RTN","PSAOP2",7,0)
 ;
"RTN","PSAOP2",8,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAOP2",9,0)
 ;References to ^PSRX( are covered by IA #254
"RTN","PSAOP2",10,0)
 ;
"RTN","PSAOP2",11,0)
 D PSAWARN^PSAPSI I $D(PSAQUIT) K PSAQUIT Q
"RTN","PSAOP2",12,0)
 D Q
"RTN","PSAOP2",13,0)
 S $P(PSALN,"-",79)="-"
"RTN","PSAOP2",14,0)
LOOK D OP^PSADA
"RTN","PSAOP2",15,0)
 G:'$G(PSALOC) Q W !,$G(PSALOCN)
"RTN","PSAOP2",16,0)
 S DIR(0)="Y",DIR("A")="OK",DIR("B")="Yes",DIR("?")="Answering no will allow you to change Location." D ^DIR K DIR S:$D(DIRUT) PSAOUT=1 G:$D(DIRUT) Q I Y=0 K PSALOC D OP^PSADA G:'$G(PSALOC) Q
"RTN","PSAOP2",17,0)
 I '$O(^PSD(58.8,+PSALOC,1,0)) W !!,"There are no drugs in ",PSALOCN,!! G Q
"RTN","PSAOP2",18,0)
 D NOW^%DTC S PSADT=X,X="T-6000" D ^%DT S PSADT(1)=Y,(PSAPG,PSAOUT,PSADRUG)=0
"RTN","PSAOP2",19,0)
 S DIR(0)="D^"_PSADT(1)_":"_PSADT_":AEX",DIR("A")="How far back would you like to collect",DIR("B")="T-6000"  D ^DIR K DIR S (PSADT(2),PSADT(22),PSAR,PSAP,PSAN)=Y,(PSADT(3),PSAR(1),PSAP(1),PSAN(1))=0 I Y<1 S PSAOUT=1 Q
"RTN","PSAOP2",20,0)
 S (PSAOP,PSAS)=$P($G(^PSD(58.8,+PSALOC,0)),U,10)
"RTN","PSAOP2",21,0)
 S DIR(0)="Y",DIR("A")="Would you like a report of daily dispensing totals",DIR("B")="Yes" D ^DIR K DIR S:$D(DIRUT) PSAOUT=1 G:$D(DIRUT) STOP
"RTN","PSAOP2",22,0)
 I Y=1 S PSADAILY=1
"RTN","PSAOP2",23,0)
DEV K IO("Q") K %ZIS,IOP,POP S %ZIS="Q" I Y=1 W ! D ^%ZIS
"RTN","PSAOP2",24,0)
 I $G(POP) W !,"NO DEVICE SELECTED OR ACTION TAKEN!" S PSAOUT=1 G Q
"RTN","PSAOP2",25,0)
 I $D(IO("Q")) K ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="LUP^PSAOP2",ZTDESC="Drug Acct-Daily Drug Dispensing Log",ZTSAVE("PSA*")="" D ^%ZTLOAD G Q
"RTN","PSAOP2",26,0)
 ;
"RTN","PSAOP2",27,0)
LUP ;Starting point
"RTN","PSAOP2",28,0)
 S PSADRUG=0 W @IOF
"RTN","PSAOP2",29,0)
PROCESS F PSAHOW="AL","AJ","AM","AN" S PSADT=PSADT(22)-.00001 D LOOP
"RTN","PSAOP2",30,0)
 G DONE
"RTN","PSAOP2",31,0)
 ;
"RTN","PSAOP2",32,0)
LOOP ;
"RTN","PSAOP2",33,0)
 I $E(IOST)="C" W !,"Processing ",$S(PSAHOW="AL":"dispensing",PSAHOW="AJ":"returns",PSAHOW="AM":"partials",1:"returns")
"RTN","PSAOP2",34,0)
 ;
"RTN","PSAOP2",35,0)
1 S PSADT=$O(^PSRX(PSAHOW,PSADT)) Q:PSADT'>0  K PSAIEN
"RTN","PSAOP2",36,0)
2 S PSAIEN=$S('$D(PSAIEN):$O(^PSRX(PSAHOW,PSADT,0)),1:$O(^PSRX(PSAHOW,PSADT,PSAIEN))) G 1:PSAIEN'>0 K PSARX
"RTN","PSAOP2",37,0)
3 S PSARX=$S('$D(PSARX):$O(^PSRX(PSAHOW,PSADT,PSAIEN,"")),1:$O(^PSRX(PSAHOW,PSADT,PSAIEN,PSARX))) G 2:PSARX="" W "."
"RTN","PSAOP2",38,0)
 I $D(^PSRX("AR",PSADT,PSAIEN,PSARX)) G 3
"RTN","PSAOP2",39,0)
 S PSADRUG=$P($G(^PSRX(PSAIEN,0)),"^",6) I $G(PSADRUG)="" G 3
"RTN","PSAOP2",40,0)
 S PSADRUGN=$P($G(^PSDRUG(PSADRUG,0)),"^")
"RTN","PSAOP2",41,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRUG)) G 3
"RTN","PSAOP2",42,0)
 I $P($G(^PSRX(PSAIEN,2)),"^",9)'=PSAS G 3
"RTN","PSAOP2",43,0)
 ;
"RTN","PSAOP2",44,0)
 S PSAQTY=$S(+PSARX:$P($G(^PSRX(PSAIEN,1,PSARX,0)),"^",4),1:$P($G(^PSRX(PSAIEN,0)),"^",7)) ;either refill or fill
"RTN","PSAOP2",45,0)
 ;
"RTN","PSAOP2",46,0)
 I '$D(^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7))) S ^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7))=""
"RTN","PSAOP2",47,0)
 S DATA=^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7))
"RTN","PSAOP2",48,0)
 S $P(^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7)),"^",1)=$S(PSAHOW="AL":$P(DATA,"^")+PSAQTY,PSAHOW="AJ":$P(DATA,"^")-PSAQTY,PSAHOW="AM":$P(DATA,"^")+$P($G(^PSRX(PSAIEN,"P",PSARX,0)),"^",4),1:$P(DATA,"^")-$P($G(^PSRX(PSAIEN,"P",PSARX,0)),"^",4))
"RTN","PSAOP2",49,0)
 ;
"RTN","PSAOP2",50,0)
 S $P(^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7)),"^",$S(PSAHOW="AL":2,PSAHOW="AJ":4,PSAHOW="AM":6,1:8))=PSAIEN
"RTN","PSAOP2",51,0)
 S $P(^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7)),"^",$S(PSAHOW="AL":3,PSAHOW="AJ":5,PSAHOW="AM":7,1:9))=PSARX
"RTN","PSAOP2",52,0)
 G 3
"RTN","PSAOP2",53,0)
 ;
"RTN","PSAOP2",54,0)
DONE ;All dispensing data retrieved, print it.
"RTN","PSAOP2",55,0)
 D HEADER
"RTN","PSAOP2",56,0)
 S XX=0 F  S XX=$O(^PSD(58.88,PSALOC,1,XX)) Q:XX'>0  S XXX=$P($G(^PSDRUG,XX),"^") I '$D(^TMP("PSA",$J,XXX)) S ^TMP("PSA",$J,XXX)=0
"RTN","PSAOP2",57,0)
 S PSADRUGN=0
"RTN","PSAOP2",58,0)
4 S PSADRUGN=$O(^TMP("PSA",$J,PSADRUGN)) G STOP:PSADRUGN=""
"RTN","PSAOP2",59,0)
 S PSADRUG=$O(^PSDRUG("B",PSADRUGN,0))
"RTN","PSAOP2",60,0)
 I $Y>(IOSL+4) D HEADER G Q:$G(PSAOUT)=1
"RTN","PSAOP2",61,0)
 I '$D(^TMP("PSA",$J,PSADRUGN)) W !,PSADRUGN,?36,"has not been dispensed since: " S Y=$S($P($G(^PSD(58.8,PSALOC,1,PSADRUG,6)),"^"):$P(^PSD(58.8,PSALOC,1,PSADRUG,6),"^"),1:PSADT(22)) X ^DD("DD") W Y,"." G 4
"RTN","PSAOP2",62,0)
 W !,PSADRUGN
"RTN","PSAOP2",63,0)
 K PNTDATA,PSADATE,PSATTLP,DAYS
"RTN","PSAOP2",64,0)
5 S PSADATE=$S('$D(PSADATE):$O(^TMP("PSA",$J,PSADRUGN,0)),1:$O(^TMP("PSA",$J,PSADRUGN,PSADATE))) G PNTQ:PSADATE'>0 S DATA=^TMP("PSA",$J,PSADRUGN,PSADATE) S DAYS=$G(DAYS)+1
"RTN","PSAOP2",65,0)
 S Y=PSADATE X ^DD("DD") S PRINTDT=Y
"RTN","PSAOP2",66,0)
 S PSAQTY=$P(DATA,"^")
"RTN","PSAOP2",67,0)
 ;
"RTN","PSAOP2",68,0)
 S PSAPRICE=$P($G(^PSDRUG(PSADRUG,660)),"^",6) ;Price per dispense Unit
"RTN","PSAOP2",69,0)
 S PSADISPU=$P($G(^PSDRUG(PSADRUG,660)),"^",8) ;Dispense Unit
"RTN","PSAOP2",70,0)
 ;
"RTN","PSAOP2",71,0)
 S Y=PSAQTY,X2=0 D COMMA^%DTC S PNTQTY=Y
"RTN","PSAOP2",72,0)
 S TTLQTY=$G(TTLQTY)+PSAQTY ;total quantity
"RTN","PSAOP2",73,0)
 S PSAPRICE(2)=$G(PSAPRICE(2))+(PSAPRICE*PSAQTY) ;Total Cost
"RTN","PSAOP2",74,0)
 S Y=PSAPRICE,X2="3$" D COMMA^%DTC S PNTPRICE=Y
"RTN","PSAOP2",75,0)
 S Y=PSAPRICE*PSAQTY,X2="3$" D COMMA^%DTC S PSAQP=Y
"RTN","PSAOP2",76,0)
 I $D(PSADAILY) W !,$G(DAYS),?3,PRINTDT,?23,PNTQTY,?40,PNTPRICE,"/",PSADISPU,?63,PSAQP K PSAQP G 5
"RTN","PSAOP2",77,0)
 G 5
"RTN","PSAOP2",78,0)
 ;
"RTN","PSAOP2",79,0)
PNTQ W !,PSALN,!,DAYS," DAY TOTALS: " S Y=TTLQTY,X2="2$" D COMMA^%DTC W Y S Y=PSAPRICE(2),X2="2$" D COMMA^%DTC W ?63,Y
"RTN","PSAOP2",80,0)
 K TTLQTY,PSAPRICE,PSAQTY,PNTQTY
"RTN","PSAOP2",81,0)
 G 4
"RTN","PSAOP2",82,0)
 ;
"RTN","PSAOP2",83,0)
HEADER I $E(IOST,1,2)'="P-",$G(PSAPG) S DIR(0)="E" D ^DIR K DIR I '+Y S PSAOUT=1 Q
"RTN","PSAOP2",84,0)
 I $$S^%ZTLOAD S PSAOUT=1 Q
"RTN","PSAOP2",85,0)
 W:$Y @IOF S PSAPG=$G(PSAPG)+1 W ?2,"DAILY DISPENSING TOTALS FOR ",$E($G(PSALOCN),1,30),?70,"PAGE: ",PSAPG,!,PSALN,!
"RTN","PSAOP2",86,0)
 W "  DATE",?23,"TOTAL",?45,"$/DISP",?67,"TOTAL",!," DISPENSED",?23,"DISP",?46,"UNIT",?68,"COST",!,PSALN
"RTN","PSAOP2",87,0)
 Q
"RTN","PSAOP2",88,0)
Q D ^%ZISC K PNTDATA,PNTDATE,PNTPRICE,PNTQTY,POP,PRINTDT,PSA,PSADAILY,PSADATE,PDADISPU,PSADR,PSADREC,PSADRUG,PSACNT,PSAPG,PSAOSIT
"RTN","PSAOP2",89,0)
 K PSADRUGN,PSADT,PSAG,PSAHOW,PSAIEN,PSALN,PSALOC,PSALOCN,PSAN,PSAOP,PSAOUT,PSAP,PSAPRICE,PSAQ,PSAQTY,PSAR,PSAREC,PSARELDT,PSARX,PSAS,PSAT,PSATTLP,TTLQTY,^TMP("PSA",$J),^TMP($J)
"RTN","PSAOP2",90,0)
 Q
"RTN","PSAOP2",91,0)
STOP W:$E(IOST)'="C" @IOF
"RTN","PSAOP2",92,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAOP2",93,0)
 I $D(^TMP("PSA",$J)) D
"RTN","PSAOP2",94,0)
 .W !!,"Updating history and dispensing totals."
"RTN","PSAOP2",95,0)
 .D ^PSAOP4
"RTN","PSAOP2",96,0)
 G Q
"RTN","PSAOP4")
0^2^B6589601^B6478536
"RTN","PSAOP4",1,0)
PSAOP4 ;BIR/LTL-Outpatient Dispensing (Single Drug) & (All Drugs) - CONT'D ;7/23/97
"RTN","PSAOP4",2,0)
 ;;3.0;DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,76**; 10/24/97;Build 1
"RTN","PSAOP4",3,0)
 ;This routine gathers outpatient dispensing and is called by PSAOP2.
"RTN","PSAOP4",4,0)
 ;
"RTN","PSAOP4",5,0)
 N PSADRUGN S PSADRUGN=0
"RTN","PSAOP4",6,0)
 F  S PSADRUGN=$O(^TMP("PSA",$J,PSADRUGN)) Q:PSADRUGN=""  S PSADRUG=$O(^PSDRUG("B",PSADRUGN,0))  D  ;;<< RJS-*76
"RTN","PSAOP4",7,0)
 .S PSA(2)=0 F  S PSA(2)=$O(^TMP("PSA",$J,PSADRUGN,PSA(2))) Q:'PSA(2)  D
"RTN","PSAOP4",8,0)
 ..S PSA(3)=+^TMP("PSA",$J,PSADRUGN,PSA(2)) D TMP^PSAOP1
"RTN","PSAOP4",9,0)
 ..K:$D(^XTMP("PSA",PSAS,PSADRUGN)) ^XTMP("PSA",PSAS,PSADRUGN)
"RTN","PSAOP4",10,0)
QUIT K ^TMP("PSA",$J) S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSAOP4",11,0)
 Q
"RTN","PSAOP4",12,0)
 ;
"RTN","PSAOP4",13,0)
AM ;Collects partial fills released & returned to stock.
"RTN","PSAOP4",14,0)
 F  S PSAP=$O(^PSRX("AM",PSAP)) Q:'PSAP  F  S PSAP(1)=$O(^PSRX("AM",+PSAP,PSAP(1))) Q:'PSAP(1)  D:$P($G(^PSRX(+PSAP(1),0)),U,6)=PSADRUG&($P($G(^PSRX(+PSAP(1),2)),U,9)=PSAS)
"RTN","PSAOP4",15,0)
 .S PSAP(2)="" F  S PSAP(2)=$O(^PSRX("AM",+PSAP,+PSAP(1),PSAP(2))) Q:'PSAP(2)  S $P(^TMP("PSA",$J,+PSADRUG,$E(PSAP,1,7)),U)=$P($G(^TMP("PSA",$J,+PSADRUG,$E(PSAP,1,7))),U)+$P($G(^PSRX(+PSAP(1),"P",+PSAP(2),0)),U,4) D
"RTN","PSAOP4",16,0)
 ..S $P(^TMP("PSA",$J,+PSADRUG,$E(PSAP,1,7)),U,6)=PSAP,$P(^($E(PSAP,1,7)),U,7)=PSAP(1)
"RTN","PSAOP4",17,0)
 F  S PSAN=$O(^PSRX("AN",PSAN)) Q:'PSAN  F  S PSAN(1)=$O(^PSRX("AN",+PSAN,PSAN(1))) Q:'PSAN(1)  D:$P($G(^PSRX(+PSAN(1),0)),U,6)=PSADRUG&($P($G(^PSRX(+PSAN(1),2)),U,0)=PSAS)
"RTN","PSAOP4",18,0)
 .S PSAN(2)="" F  S PSAN(2)=$O(^PSRX("AN",+PSAN,+PSAN(1),PSAN(2))) Q:'PSAN(2)  S $P(^TMP("PSA",$J,+PSADRUG,$E(PSAN,1,7)),U)=$P($G(^($E(PSAN,1,7))),U)-$P($G(^PSRX(+PSAN(1),"P",+PSAN(2),0)),U,4) D
"RTN","PSAOP4",19,0)
 ..S $P(^TMP("PSA",$J,+PSADRUG,$E(PSAN,1,7)),U,8)=PSAN,$P(^($E(PSAN,1,7)),U,9)=PSAN(1)
"RTN","PSAOP4",20,0)
 Q
"RTN","PSAVER6")
0^3^B57426665^B57278289
"RTN","PSAVER6",1,0)
PSAVER6 ;BIR/JMB-Verify Invoices - CONT'D ;10/3/97
"RTN","PSAVER6",2,0)
 ;;3.0;DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**1,3,21,42,53,57,61,64,76**; 10/24/97;Build 1
"RTN","PSAVER6",3,0)
 ;Background Job:
"RTN","PSAVER6",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVER6",5,0)
 ;This routine increments pharmacy location and master vault balances
"RTN","PSAVER6",6,0)
 ;in 58.8 after invoices have been verified.
"RTN","PSAVER6",7,0)
 ;
"RTN","PSAVER6",8,0)
START ;|=> *42 add Post Verify variance report
"RTN","PSAVER6",9,0)
 K ^TMP($J,"PSADD")
"RTN","PSAVER6",10,0)
 K DIC,DA,DR,DIE  ;|=> *52 MOVE POST VERIFY E-MAIL LOGIC FROM START+17
"RTN","PSAVER6",11,0)
 S PSAIEN=0  F  S PSAIEN=+$O(PSAVBKG(PSAIEN)) Q:'PSAIEN  D
"RTN","PSAVER6",12,0)
 .Q:'$D(^PSD(58.811,PSAIEN,0))
"RTN","PSAVER6",13,0)
 .S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^"),PSAVEND=$P(^(0),"^",2),PSAIEN1=0
"RTN","PSAVER6",14,0)
 .F  S PSAIEN1=+$O(PSAVBKG(PSAIEN,PSAIEN1)) Q:'PSAIEN1  D
"RTN","PSAVER6",15,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSAVER6",16,0)
 ..D SCANDIF  ; *57 <=|
"RTN","PSAVER6",17,0)
 S PSAIEN=0  F  S PSAIEN=+$O(PSAVBKG(PSAIEN)) Q:'PSAIEN  D
"RTN","PSAVER6",18,0)
 .Q:'$D(^PSD(58.811,PSAIEN,0))
"RTN","PSAVER6",19,0)
 .S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^"),PSAVEND=$P(^(0),"^",2),PSAIEN1=0
"RTN","PSAVER6",20,0)
 .F  S PSAIEN1=+$O(PSAVBKG(PSAIEN,PSAIEN1)) Q:'PSAIEN1  D
"RTN","PSAVER6",21,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSAVER6",22,0)
 ..S PSAIN=^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER6",23,0)
 ..K DIC,DA,DR,DIE
"RTN","PSAVER6",24,0)
 ..I +$P(PSAIN,"^",13) K DA S DIE="^PSD(58.811,"_PSAIEN_",1,",DA(1)=PSAIEN,DA=PSAIEN1,DR="2////C" D ^DIE K DIE,DA,DR Q
"RTN","PSAVER6",25,0)
 ..S PSAINV=$P(PSAIN,"^"),PSAINVDT=$P(PSAIN,"^",2),PSALINE=0
"RTN","PSAVER6",26,0)
 ..F  S PSALINE=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:'PSALINE  D
"RTN","PSAVER6",27,0)
 ...Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0))
"RTN","PSAVER6",28,0)
 ...S PSADATA=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0) D GETDATA I 'PSASUP,'$D(PSA0QTY) D FILE ;PSA*3*42
"RTN","PSAVER6",29,0)
 ..K DIC,DA,DR,DIE
"RTN","PSAVER6",30,0)
 ..K DA S DIE="^PSD(58.811,"_PSAIEN_",1,",DA(1)=PSAIEN,DA=PSAIEN1,DR="2////C" D ^DIE K DIE,DA,DR
"RTN","PSAVER6",31,0)
 ;;*57 => START+17 THRU START+22 MOVED TO START+3 <=|
"RTN","PSAVER6",32,0)
 ; *42 <=|
"RTN","PSAVER6",33,0)
EXIT ;Kills variables
"RTN","PSAVER6",34,0)
 K %,DA,DD,DIC,DIE,DINUM,DLAYGO,DO,PSA,PSAA,PSABAL,PSACBAL,PSACNT,PSACNT,PSACOD,PSACOST,PSACS,PSADASH,PSADATA,PSADJ,PSADJD,PSADJO,PSADJP,PSADJQ
"RTN","PSAVER6",35,0)
 K PSADRG,PSADT,PSADUOU,PSADUQTY,PSADUREC,PSAIEN,PSAIEN1,PSAIN,PSAINV,PSAINVDT,PSALEN,PSALINE,PSALOC,PSAMSG,PSANDC,PSANODE,PSANPDU,PSANPOU
"RTN","PSAVER6",36,0)
 K PSAODASH,PSAONDC,PSAORD,PSAOU,PSAPDU,PSAPOU,PSAQTY,PSAREORD,PSASET,PSASTOCK,PSASUP,PSAT,PSATDRG,PSATEMP,PSAVBKG,PSAVDUZ,PSAVEND,PSAVSN,X,XMDUZ,XMSUB,XMTEXT,XMY,XMZ,Y
"RTN","PSAVER6",37,0)
 K PSA0QTY
"RTN","PSAVER6",38,0)
 Q
"RTN","PSAVER6",39,0)
 ;
"RTN","PSAVER6",40,0)
GETDATA ;Gets invoice data to help file the data
"RTN","PSAVER6",41,0)
 S PSAVDUZ=$P(PSADATA,"^",9),PSASUP=0 K PSA0QTY  ;; <<RJS-3*76??
"RTN","PSAVER6",42,0)
 S PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","D",0))
"RTN","PSAVER6",43,0)
 I '$G(PSADJ) S PSADRG=$S(+$P(PSADATA,"^",2):+$P(PSADATA,"^",2),1:0) G CS
"RTN","PSAVER6",44,0)
 I $G(PSADJ) D
"RTN","PSAVER6",45,0)
 .S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSAVER6",46,0)
 .S PSADJD=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",47,0)
 .I PSADJD'?1.N S PSASUP=1
"RTN","PSAVER6",48,0)
 .S PSADRG=$S(PSADJ&('PSASUP):+PSADJD,PSADJ&(PSASUP):0,1:+$P(PSADATA,"^",2))
"RTN","PSAVER6",49,0)
 .I +PSADJD,$L(PSADJD)=$L(+PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")'="" S PSADRG=+PSADJD Q
"RTN","PSAVER6",50,0)
 .I +PSADJD,$L(PSADJD)=$L(+PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")="" S (PSADJ,PSADRG)=0 Q
"RTN","PSAVER6",51,0)
CS Q:PSASUP!('PSADRG)
"RTN","PSAVER6",52,0)
 S PSACS=$S(+$P(PSADATA,"^",10):1,1:0)
"RTN","PSAVER6",53,0)
 S PSADJQ=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","Q",0))
"RTN","PSAVER6",54,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",55,0)
 ;
"RTN","PSAVER6",56,0)
 ;PSA*3*1  (DAVE B)
"RTN","PSAVER6",57,0)
 S PSAQTY=$S(($G(PSADJQ)'=""&(+PSADJ)):PSADJQ,1:+$P(PSADATA,"^",3))
"RTN","PSAVER6",58,0)
 S PSAOU=$S(+$P(PSADATA,"^",4):+$P(PSADATA,"^",4),1:"")
"RTN","PSAVER6",59,0)
 ;
"RTN","PSAVER6",60,0)
 ;DAVE B (PSA*3*3)
"RTN","PSAVER6",61,0)
 ;I +$P($P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),"^",5),"~",2) S PSAOU=$P($P($G(^(2)),"^",5),"~",2)
"RTN","PSAVER6",62,0)
 ;
"RTN","PSAVER6",63,0)
 S PSADJO=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","O",0))
"RTN","PSAVER6",64,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJO=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",65,0)
 S:$G(PSADJO) PSAOU=$G(PSADJO)
"RTN","PSAVER6",66,0)
 S PSANDC=$P(PSADATA,"^",11) D PSANDC1^PSAHELP S PSADASH=PSANDCX K PSANDCX
"RTN","PSAVER6",67,0)
 S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","P",0))
"RTN","PSAVER6",68,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJP=$S(+$P(PSANODE,"^",6):+$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSAVER6",69,0)
 S (PSAPOU,PSANPOU)=$S($G(PSADJP):PSADJP,1:+$P(PSADATA,"^",5)),PSALEN=$L($P(PSANPOU,".")),(PSAPOU,PSANPOU)=$J(PSANPOU,PSALEN,2)
"RTN","PSAVER6",70,0)
 S PSAVSN=$P(PSADATA,"^",12)
"RTN","PSAVER6",71,0)
 S PSALOC=$S(+PSACS:+$P(PSAIN,"^",12),1:+$P(PSAIN,"^",5))
"RTN","PSAVER6",72,0)
TEMP S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2))
"RTN","PSAVER6",73,0)
 S PSADUOU=+$P(PSATEMP,"^"),PSAREORD=+$P(PSATEMP,"^",2),PSASUB=+$P(PSATEMP,"^",3),PSASTOCK=+$P(PSATEMP,"^",4)
"RTN","PSAVER6",74,0)
 S PSADUOU=$S(+PSADUOU:+PSADUOU,+PSASUB&(+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7),1:1)
"RTN","PSAVER6",75,0)
 S PSADUREC=$S(PSADUOU:PSAQTY*PSADUOU,1:0)
"RTN","PSAVER6",76,0)
 ;
"RTN","PSAVER6",77,0)
 ;DAVE B (18NOV98)
"RTN","PSAVER6",78,0)
 I PSADUREC=0,$D(PSAQTY),$P($G(^PSDRUG(PSADRG,660)),"^",5)'="" S PSADUREC=(PSAQTY*($P(^PSDRUG(PSADRG,660),"^",5)))
"RTN","PSAVER6",79,0)
 Q:'+$P($G(^PSD(58.8,PSALOC,0)),"^",14)
"RTN","PSAVER6",80,0)
 S PSAREORD=$S(+PSAREORD:+PSAREORD,+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5):+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5),1:0)
"RTN","PSAVER6",81,0)
 S PSASTOCK=$S(+PSASTOCK:+PSASTOCK,+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3):+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3),1:0)
"RTN","PSAVER6",82,0)
 K PSA0QTY I '$G(PSAQTY),'$G(PSADJQ) S PSA0QTY=1 Q  ;PSA*3*42 (0 QTY)
"RTN","PSAVER6",83,0)
 Q
"RTN","PSAVER6",84,0)
 ;
"RTN","PSAVER6",85,0)
FILE ;File data in 58.8
"RTN","PSAVER6",86,0)
 I $D(PSADUREC),PSADUREC'>0 S PSADUREC=$S($D(PSADJQ):PSADJQ,$D(PSAQTY):PSAQTY,1:0)
"RTN","PSAVER6",87,0)
 D NOW^%DTC S PSADT=+$E(%,1,14)
"RTN","PSAVER6",88,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,0)) D
"RTN","PSAVER6",89,0)
 .K DIC,DA,DR,DIE
"RTN","PSAVER6",90,0)
 .S:'$D(^PSD(58.8,PSALOC,1,0)) DIC("P")=$P(^DD(58.8,10,0),"^",2)
"RTN","PSAVER6",91,0)
 .S DA(1)=PSALOC,DIC="^PSD(58.8,"_DA(1)_",1,",(DA,DINUM,X)=PSADRG,DIC(0)="L",DLAYGO=58.8
"RTN","PSAVER6",92,0)
 .F  L +^PSD(58.8,PSALOC,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER6",93,0)
 .D FILE^DICN L -^PSD(58.8,PSALOC,0) K DIC,DA,DLAYGO
"RTN","PSAVER6",94,0)
 .D MM ;*42 send mailmessage
"RTN","PSAVER6",95,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER6",96,0)
 S PSABAL=+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",4)
"RTN","PSAVER6",97,0)
 ;
"RTN","PSAVER6",98,0)
 ;DAVE B (PSA*3*3)
"RTN","PSAVER6",99,0)
 I $P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",1)'=PSADRG S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",1)=PSADRG
"RTN","PSAVER6",100,0)
 S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",4)=PSADUREC+PSABAL
"RTN","PSAVER6",101,0)
 I +$P($G(^PSD(58.8,PSALOC,0)),"^",14) D
"RTN","PSAVER6",102,0)
 .I PSASTOCK'=$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3) S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3)=PSASTOCK
"RTN","PSAVER6",103,0)
 .I PSAREORD'=$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",5) S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",5)=PSAREORD
"RTN","PSAVER6",104,0)
 S:'$D(^PSD(58.8,PSALOC,1,PSADRG,5,0)) DIC("P")=$P(^DD(58.8001,20,0),"^",2)
"RTN","PSAVER6",105,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,5,$E(DT,1,5)*100,0)) D
"RTN","PSAVER6",106,0)
 .K DIC,DA,DR,DIE
"RTN","PSAVER6",107,0)
 .S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DIC(0)="L",DIC("DR")="1////^S X=$G(PSABAL)"
"RTN","PSAVER6",108,0)
 .S (X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRG,DLAYGO=58.8 D ^DIC K DIC("DR")
"RTN","PSAVER6",109,0)
 .S X="T-1M" D ^%DT S (X,DINUM)=$E(Y,1,5)*100,DA=PSADRG D ^DIC K DIC,DLAYGO
"RTN","PSAVER6",110,0)
 .K DIC,DA,DR,DIE
"RTN","PSAVER6",111,0)
 .S DA=+Y,DA(2)=PSALOC,DA(1)=PSADRG,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",5,",DR="3////^S X=$G(PSABAL)" D ^DIE K DIE
"RTN","PSAVER6",112,0)
 K DIC,DA,DR,DIE
"RTN","PSAVER6",113,0)
 S DA=$E(DT,1,5)*100
"RTN","PSAVER6",114,0)
 S DA(2)=PSALOC,DA(1)=PSADRG,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",5,",DA=$E(DT,1,5)*100,DR="3////^S X=($G(PSABAL)+$G(PSADUREC));5////^S X="_($P($G(^(0)),"^",3)+PSADUREC) D ^DIE K DIE
"RTN","PSAVER6",115,0)
 L -^PSD(58.8,PSALOC,1,PSADRG,0)
"RTN","PSAVER6",116,0)
 G TR^PSAVER7
"RTN","PSAVER6",117,0)
MM ;
"RTN","PSAVER6",118,0)
 ;*42 Mail Message to holders of PSDMGR, PSAMGR key
"RTN","PSAVER6",119,0)
 ;*53 Consolidate messages
"RTN","PSAVER6",120,0)
 N PSACS S PSACS=$S($$GET1^DIQ(50,PSADRG,63)["N":" Controlled Substance ",1:"")
"RTN","PSAVER6",121,0)
 S ^TMP($J,"PSADD",$$GET1^DIQ(58.8,PSALOC,.01),$$GET1^DIQ(50,PSADRG,.01))=""
"RTN","PSAVER6",122,0)
 Q
"RTN","PSAVER6",123,0)
SCANDIF ;*42 inspect invoice for noted differences in OU,DUOU,PPDU,NDC
"RTN","PSAVER6",124,0)
 ;NEEDS PSAIEN, PSAIEN1
"RTN","PSAVER6",125,0)
 K ^TMP($J,"PSADIF"),PSADIFLC
"RTN","PSAVER6",126,0)
 S PSALINE=0 F  S PSALINE=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:PSALINE'>0  D CHECK^PSAPROC7 ;checks and stores differences in ^TMP($J,
"RTN","PSAVER6",127,0)
 I $D(^TMP($J,"PSADD")) D ADDMM
"RTN","PSAVER6",128,0)
 I $D(^TMP($J,"PSADIF")) D MESSAGE
"RTN","PSAVER6",129,0)
 Q
"RTN","PSAVER6",130,0)
MESSAGE ;differences found, notify user and send message to g.PSA NDC UPDATES.
"RTN","PSAVER6",131,0)
 K DIR N IENS
"RTN","PSAVER6",132,0)
 S PSAORD=$$GET1^DIQ(58.811,PSAIEN,.01),IENS=PSAIEN1_","_PSAIEN
"RTN","PSAVER6",133,0)
 S PSAINV=$$GET1^DIQ(58.8112,IENS,.01)
"RTN","PSAVER6",134,0)
 S XMSUB="POST Verify  Variance Report Ord: "_PSAORD_" Inv: "_PSAINV ;*52
"RTN","PSAVER6",135,0)
 S ^TMP($J,"PSADIF",1,0)=XMSUB,^TMP($J,"PSADIF",2,0)=" "
"RTN","PSAVER6",136,0)
 S XMTEXT="^TMP($J,""PSADIF"",",XMY("G.PSA NDC UPDATES")=""
"RTN","PSAVER6",137,0)
 S XMDUZ="Price & NDC Updater"
"RTN","PSAVER6",138,0)
 D ^XMD
"RTN","PSAVER6",139,0)
 K PSADIFLC,^TMP($J,"PSADIF")
"RTN","PSAVER6",140,0)
 Q
"RTN","PSAVER6",141,0)
ADDMM ; SEND MESSAGE REGARDING DRUGS ADDED TO PHARMACY LOCATIONS
"RTN","PSAVER6",142,0)
 K ^TMP($J,"PSADDMM")
"RTN","PSAVER6",143,0)
 S XMSUB="New Drugs Added by Order: "_$G(PSAORD)_" Invoice: "_$G(PSAINV)
"RTN","PSAVER6",144,0)
 S XMDUZ="Verified by: "_$$GET1^DIQ(200,DUZ,.01)
"RTN","PSAVER6",145,0)
 S LC=0,X=XMSUB D MMLINE S X=XMDUZ D MMLINE
"RTN","PSAVER6",146,0)
 S X="Please use DA and CS menus to populate the balances, stock and re-order levels." D MMLINE
"RTN","PSAVER6",147,0)
 S PSALOC="" F  S PSALOC=$O(^TMP($J,"PSADD",PSALOC)) Q:PSALOC=""  D
"RTN","PSAVER6",148,0)
 . S X=PSALOC D MMLINE
"RTN","PSAVER6",149,0)
 . S PSADRG="" F  S PSADRG=$O(^TMP($J,"PSADD",PSALOC,PSADRG)) Q:PSADRG=""  S X="     "_PSADRG D MMLINE
"RTN","PSAVER6",150,0)
 S XMTEXT="^TMP($J,""PSADDMM"","
"RTN","PSAVER6",151,0)
 S XMY("G.PSA NDC UPDATES")=""
"RTN","PSAVER6",152,0)
 D ^XMD
"RTN","PSAVER6",153,0)
 K ^TMP($J,"PSADD"),^TMP($J,"PSADDMM"),LC
"RTN","PSAVER6",154,0)
 Q
"RTN","PSAVER6",155,0)
MMLINE S LC=LC+1,^TMP($J,"PSADDMM",LC,0)=X W !,X Q
"RTN","PSAVER7")
0^4^B24126749^B23883307
"RTN","PSAVER7",1,0)
PSAVER7 ;BIR/JMB-Verify Invoices - CONT'D ;7/23/97
"RTN","PSAVER7",2,0)
 ;;3.0;DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**12,21,42,56,64,66,76**; 10/24/97;Build 1
"RTN","PSAVER7",3,0)
 ;Background Job
"RTN","PSAVER7",4,0)
 ;This routine increments pharmacy location and master vault balances
"RTN","PSAVER7",5,0)
 ;in 58.8 after invoices have been verified. This routine is called
"RTN","PSAVER7",6,0)
 ;by PSAVER6.
"RTN","PSAVER7",7,0)
 ;
"RTN","PSAVER7",8,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVER7",9,0)
TR ;File transaction data in 58.81
"RTN","PSAVER7",10,0)
 I $D(PSADUREC),'PSADUREC Q  ;*56 block '0' quantity edits
"RTN","PSAVER7",11,0)
 I $D(PSAQTY),'PSAQTY Q  ;*56 block '0' quantity edits
"RTN","PSAVER7",12,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER7",13,0)
FIND S PSAT=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSAT)) S $P(^PSD(58.81,0),"^",3)=$P(^PSD(58.81,0),"^",3)+1 G FIND
"RTN","PSAVER7",14,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAT D ^DIC K DIC,DINUM,DLAYGO L -^PSD(58.81,0)
"RTN","PSAVER7",15,0)
 S DIE="^PSD(58.81,",DA=PSAT,DR="1////1;2////^S X=PSALOC;3////^S X=PSADT;4////^S X=PSADRG;5////^S X=PSADUREC;6////^S X=PSAVDUZ;9////^S X=PSABAL;71////^S X=PSAINV;106////^S X=PSAORD"
"RTN","PSAVER7",16,0)
 I $G(PSACS) S DR=DR_";100////^S X=PSACS"
"RTN","PSAVER7",17,0)
 F  L +^PSD(58.81,DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER7",18,0)
 D ^DIE L -^PSD(58.81,DA,0) K DIE
"RTN","PSAVER7",19,0)
 S:'$D(^PSD(58.8,PSALOC,1,PSADRG,4,0)) DIC("P")=$P(^DD(58.8001,19,0),"^",2)
"RTN","PSAVER7",20,0)
 S DA(2)=PSALOC,DA(1)=PSADRG,(X,DINUM)=PSAT,DIC="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",4,",DIC(0)="L",DLAYGO=58.8
"RTN","PSAVER7",21,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER7",22,0)
 D ^DIC L -^PSD(58.8,PSALOC,1,PSADRG,0) K DIC,DINUM,DLAYGO
"RTN","PSAVER7",23,0)
 ;
"RTN","PSAVER7",24,0)
50 S PSAODASH=$P($G(^PSDRUG(PSADRG,2)),"^",4)
"RTN","PSAVER7",25,0)
 S PSAONDC=$P(PSAODASH,"-")_$P(PSAODASH,"-",2)_$P(PSAODASH,"-",3)
"RTN","PSAVER7",26,0)
 ;(PSA*3*21) NDC & PRICING UPDATES (DAVE BLOCKER 10NOV99)
"RTN","PSAVER7",27,0)
 S PSADUOU=$S($G(PSADUOU)'>0:1,1:PSADUOU)
"RTN","PSAVER7",28,0)
 S PSADUREC=(PSAQTY*PSADUOU)
"RTN","PSAVER7",29,0)
 S DIE="^PSDRUG(",DA=PSADRG,DR="50////^S X="_(PSADUREC+$G(^PSDRUG(PSADRG,660.1)))
"RTN","PSAVER7",30,0)
 F  L +^PSDRUG(DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER7",31,0)
 D ^DIE L -^PSDRUG(DA,0) K DIE,DA,DR
"RTN","PSAVER7",32,0)
 ;This section replaces most of the routine
"RTN","PSAVER7",33,0)
 ;PSAOU = order unit from invoice
"RTN","PSAVER7",34,0)
 ;PSAPOU & PSANPOU = Price of Order Unit from invoice
"RTN","PSAVER7",35,0)
 ;PSADUOU=Dispense Units per OU form invoice data
"RTN","PSAVER7",36,0)
 ;PSANPDU= Price of Dispense Units per Order Unit
"RTN","PSAVER7",37,0)
 ;
"RTN","PSAVER7",38,0)
 ;Drug file Information
"RTN","PSAVER7",39,0)
 K DRUG
"RTN","PSAVER7",40,0)
 S PSANODE=$G(^PSDRUG(PSADRG,660))
"RTN","PSAVER7",41,0)
 F X=2,3,5,6 S DRUG(X)=$P($G(PSANODE),"^",X)
"RTN","PSAVER7",42,0)
 ;
"RTN","PSAVER7",43,0)
 S PSANPDU=$J(($G(PSAPOU)/$G(PSADUOU)),0,4) ;Price of Order Unit divide by Disp. Units per Order Unit
"RTN","PSAVER7",44,0)
 ;PSA*3*42 |>  (let changes happen and file, put changes into mail message)
"RTN","PSAVER7",45,0)
 S DIE="^PSDRUG(",(DA,OLDDA)=PSADRG,DR="12////^S X=PSAOU;15////^S X=PSADUOU;16///^S X=PSANPDU;13////^S X=PSAPOU" ;*42;*56;*76
"RTN","PSAVER7",46,0)
 F  L +^PSDRUG(DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER7",47,0)
 D ^DIE K DIE,DA,DR
"RTN","PSAVER7",48,0)
 ; <| PSA*42
"RTN","PSAVER7",49,0)
PTCH21 ;PSA*3*21 (Vendor's VSN changing to 8 digits, check also)
"RTN","PSAVER7",50,0)
 ;If NDC or VSN changes should it create to synonym entry ?
"RTN","PSAVER7",51,0)
 I $G(^PSDRUG(PSADRG,1,PSASUB,0))="" G NDC
"RTN","PSAVER7",52,0)
 I $G(^PSDRUG(PSADRG,1,PSASUB,0)) S PSAEDTT=0,DATA=^PSDRUG(PSADRG,1,PSASUB,0) D
"RTN","PSAVER7",53,0)
 .I PSAVSN'=$P(DATA,"^",4) S PSAEDTT=1 ;VSN
"RTN","PSAVER7",54,0)
 .I PSAPOU'=$P(DATA,"^",6) S PSAEDTT=1 ;Price per order unit
"RTN","PSAVER7",55,0)
 .I PSADUOU'=$P(DATA,"^",7) S PSAEDTT=1 ;Dispense Units per Order Unit
"RTN","PSAVER7",56,0)
 .I PSANPDU'=$P(DATA,"^",8) S PSAEDTT=1 ;New Price per dispense unit
"RTN","PSAVER7",57,0)
 .I $G(PSAEDTT)>0 D
"RTN","PSAVER7",58,0)
 ..S DA=PSASUB,DA(1)=PSADRG,DIE="^PSDRUG("_DA(1)_",1,"
"RTN","PSAVER7",59,0)
 ..S DR="2////^S X=PSADASH"_$S(PSACS:";1////C",1:";1////D")_";400////^S X=PSAVSN;401////^S X=PSAOU"_$S(+PSAPOU:";402////^S X=PSAPOU",1:"")_";403////^S X=PSADUOU"_";404///^S X=PSANPDU"_";405///^S X=PSAVEND"
"RTN","PSAVER7",60,0)
 ..D ^DIE K DIE,DR,DA
"RTN","PSAVER7",61,0)
NDC ;NDC UPDATE
"RTN","PSAVER7",62,0)
 I PSANDC'="",PSANDC'=PSAONDC D  ;*42
"RTN","PSAVER7",63,0)
 .S DIE="^PSDRUG(",DA=PSADRG,DR="31////^S X=PSADASH"
"RTN","PSAVER7",64,0)
 .F  L +^PSDRUG(DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER7",65,0)
 .D ^DIE L -^PSDRUG(DA,0) K DIE,DA,DR
"RTN","PSAVER7",66,0)
SYNONYM ;Adds/edits the SYNONYM multiple in DRUG file  >>*66 RJS
"RTN","PSAVER7",67,0)
 G:PSANDC="" END
"RTN","PSAVER7",68,0)
 S DA(1)=PSADRG  ;;  << *66 RJS
"RTN","PSAVER7",69,0)
 ;
"RTN","PSAVER7",70,0)
 S PSANPDU=$J(($G(PSAPOU)/$G(PSADUOU)),0,4) ;Price of Order Unit divide by Disp. Units per Order Unit ;*76
"RTN","PSAVER7",71,0)
 S:'$D(^PSDRUG(PSADRG,1,0)) DIC("P")="50.1A"
"RTN","PSAVER7",72,0)
 ; *56 Search for earliest best match of synonyms, start at bottom go up
"RTN","PSAVER7",73,0)
 ; if VSN use it, if several VSNs use the first, IF VSN match NDCs must match also.
"RTN","PSAVER7",74,0)
 ; if no VSN, make a new synonym
"RTN","PSAVER7",75,0)
 ; no "B" synonym index exists
"RTN","PSAVER7",76,0)
T0 N PSYNDA,PSYN0,PSTNDC,PSTVSN,PSMNDC,PSMBTH S (PSMNDC,PSMBTH)=0
"RTN","PSAVER7",77,0)
 S PSYNDA="" F  S PSYNDA=$O(^PSDRUG(PSADRG,1,PSYNDA),-1) Q:PSYNDA'>0  D
"RTN","PSAVER7",78,0)
 . S PSYN0=^PSDRUG(PSADRG,1,PSYNDA,0),PSTNDC=$P(PSYN0,U),PSTVSN=$P(PSYN0,U,4) ;zero node, test values of NDC VSN
"RTN","PSAVER7",79,0)
 . I PSTNDC'=PSANDC Q
"RTN","PSAVER7",80,0)
 . I PSTVSN=PSAVSN S PSMBTH=PSYNDA Q  ;both VSN & NDC matches
"RTN","PSAVER7",81,0)
T1 S PSASUB=$S(PSMBTH:PSMBTH,1:0) ;PSAMBTH Match both vsn,ndc
"RTN","PSAVER7",82,0)
 ;end *56
"RTN","PSAVER7",83,0)
 I 'PSASUB!(PSASUB&('$D(^PSDRUG(PSADRG,1,PSASUB,0)))) D
"RTN","PSAVER7",84,0)
 .S DIC="^PSDRUG("_DA(1)_",1,",DIC(0)="Z",X=PSANDC,DLAYGO=50
"RTN","PSAVER7",85,0)
 .F  L +^PSDRUG(PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER7",86,0)
 .D FILE^DICN L -^PSDRUG(PSADRG,0) K DIC,DLAYGO S PSASUB=+Y
"RTN","PSAVER7",87,0)
 .K DIC,DA,DR,DIE
"RTN","PSAVER7",88,0)
 I PSASUB,$D(^PSDRUG(PSADRG,1,PSASUB,0)) S DA=PSASUB
"RTN","PSAVER7",89,0)
 S DA(1)=PSADRG,DIE="^PSDRUG("_DA(1)_",1,"
"RTN","PSAVER7",90,0)
 S DR="2////^S X=PSADASH"_$S($G(PSACS)>0:";1////C",1:";1////D")_";400////^S X=PSAVSN;401////^S X=PSAOU"_$S(+PSAPOU:";402////^S X=PSAPOU",1:"")_";403////^S X=PSADUOU"_";404///^S X=PSANPDU;405///^S X=PSAVEND"
"RTN","PSAVER7",91,0)
 F  L +^PSDRUG(PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER7",92,0)
 D ^DIE L -^PSDRUG(PSADRG,0)
"RTN","PSAVER7",93,0)
 K DIE,DR,X1,X2,DATA
"RTN","PSAVER7",94,0)
END ; FINAL CLEANUP  << *66 RJS
"RTN","PSAVER7",95,0)
 L -^PSDRUG(OLDDA,0) K OLDDA  ;; >> *66 RJS
"RTN","PSAVER7",96,0)
 Q
"VER")
8.0^22.0
"BLD",9399,6)
^59
**END**
**END**

