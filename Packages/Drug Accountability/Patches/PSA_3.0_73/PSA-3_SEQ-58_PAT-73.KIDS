Released PSA*3*73 SEQ #58
Extracted from mail message
**KIDS**:PSA*3.0*73^

**INSTALL NAME**
PSA*3.0*73
"BLD",8915,0)
PSA*3.0*73^DRUG ACCOUNTABILITY^0^3111220^y
"BLD",8915,1,0)
^^8^8^3100322^
"BLD",8915,1,1,0)
This patch addresses the following problems:
"BLD",8915,1,2,0)
 
"BLD",8915,1,3,0)
1.  SUBSCRIPT>LINE+45^PSAPROC7
"BLD",8915,1,4,0)
 
"BLD",8915,1,5,0)
2.  Only Outpatient Figures on Reports
"BLD",8915,1,6,0)
 
"BLD",8915,1,7,0)
3.  DRUG TRANsaction History does not cleanup variables if up caret at 
"BLD",8915,1,8,0)
    the device prompt.
"BLD",8915,4,0)
^9.64PA^^
"BLD",8915,6)
2^
"BLD",8915,6.3)
3
"BLD",8915,"ABPKG")
n
"BLD",8915,"KRN",0)
^9.67PA^779.2^20
"BLD",8915,"KRN",.4,0)
.4
"BLD",8915,"KRN",.401,0)
.401
"BLD",8915,"KRN",.402,0)
.402
"BLD",8915,"KRN",.403,0)
.403
"BLD",8915,"KRN",.5,0)
.5
"BLD",8915,"KRN",.84,0)
.84
"BLD",8915,"KRN",3.6,0)
3.6
"BLD",8915,"KRN",3.8,0)
3.8
"BLD",8915,"KRN",9.2,0)
9.2
"BLD",8915,"KRN",9.8,0)
9.8
"BLD",8915,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",8915,"KRN",9.8,"NM",1,0)
PSAPROC7^^0^B59467507
"BLD",8915,"KRN",9.8,"NM",2,0)
PSAPTCH^^0^B16300377
"BLD",8915,"KRN",9.8,"NM",3,0)
PSAUDP^^0^B17663962
"BLD",8915,"KRN",9.8,"NM",4,0)
PSAHIS^^0^B23635859
"BLD",8915,"KRN",9.8,"NM","B","PSAHIS",4)

"BLD",8915,"KRN",9.8,"NM","B","PSAPROC7",1)

"BLD",8915,"KRN",9.8,"NM","B","PSAPTCH",2)

"BLD",8915,"KRN",9.8,"NM","B","PSAUDP",3)

"BLD",8915,"KRN",19,0)
19
"BLD",8915,"KRN",19.1,0)
19.1
"BLD",8915,"KRN",101,0)
101
"BLD",8915,"KRN",409.61,0)
409.61
"BLD",8915,"KRN",771,0)
771
"BLD",8915,"KRN",779.2,0)
779.2
"BLD",8915,"KRN",870,0)
870
"BLD",8915,"KRN",8989.51,0)
8989.51
"BLD",8915,"KRN",8989.52,0)
8989.52
"BLD",8915,"KRN",8994,0)
8994
"BLD",8915,"KRN","B",.4,.4)

"BLD",8915,"KRN","B",.401,.401)

"BLD",8915,"KRN","B",.402,.402)

"BLD",8915,"KRN","B",.403,.403)

"BLD",8915,"KRN","B",.5,.5)

"BLD",8915,"KRN","B",.84,.84)

"BLD",8915,"KRN","B",3.6,3.6)

"BLD",8915,"KRN","B",3.8,3.8)

"BLD",8915,"KRN","B",9.2,9.2)

"BLD",8915,"KRN","B",9.8,9.8)

"BLD",8915,"KRN","B",19,19)

"BLD",8915,"KRN","B",19.1,19.1)

"BLD",8915,"KRN","B",101,101)

"BLD",8915,"KRN","B",409.61,409.61)

"BLD",8915,"KRN","B",771,771)

"BLD",8915,"KRN","B",779.2,779.2)

"BLD",8915,"KRN","B",870,870)

"BLD",8915,"KRN","B",8989.51,8989.51)

"BLD",8915,"KRN","B",8989.52,8989.52)

"BLD",8915,"KRN","B",8994,8994)

"BLD",8915,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",8915,"QUES",0)
^9.62^^
"BLD",8915,"REQB",0)
^9.611^3^3
"BLD",8915,"REQB",1,0)
PSA*3.0*15^1
"BLD",8915,"REQB",2,0)
PSA*3.0*66^1
"BLD",8915,"REQB",3,0)
PSA*3.0*71^1
"BLD",8915,"REQB","B","PSA*3.0*15",1)

"BLD",8915,"REQB","B","PSA*3.0*66",2)

"BLD",8915,"REQB","B","PSA*3.0*71",3)

"MBREQ")
0
"PKG",487,-1)
1^1
"PKG",487,0)
DRUG ACCOUNTABILITY^PSA^Drug Accountability Inventory and Tracking module.
"PKG",487,20,0)
^9.402P^^
"PKG",487,22,0)
^9.49I^1^1
"PKG",487,22,1,0)
3.0^2971024^2981028^66481
"PKG",487,22,1,"PAH",1,0)
73^3111220^100104
"PKG",487,22,1,"PAH",1,1,0)
^^8^8^3111220
"PKG",487,22,1,"PAH",1,1,1,0)
This patch addresses the following problems:
"PKG",487,22,1,"PAH",1,1,2,0)
 
"PKG",487,22,1,"PAH",1,1,3,0)
1.  SUBSCRIPT>LINE+45^PSAPROC7
"PKG",487,22,1,"PAH",1,1,4,0)
 
"PKG",487,22,1,"PAH",1,1,5,0)
2.  Only Outpatient Figures on Reports
"PKG",487,22,1,"PAH",1,1,6,0)
 
"PKG",487,22,1,"PAH",1,1,7,0)
3.  DRUG TRANsaction History does not cleanup variables if up caret at 
"PKG",487,22,1,"PAH",1,1,8,0)
    the device prompt.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSAHIS")
0^4^B23635859^B23525089
"RTN","PSAHIS",1,0)
PSAHIS ;BIR/LTL,JMB-Drug Transaction History ;7/23/97
"RTN","PSAHIS",2,0)
 ;;3.0;DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,15,73**; 10/24/97;Build 3
"RTN","PSAHIS",3,0)
 ;This routine prints a report of all or specific drugs in a pharmacy
"RTN","PSAHIS",4,0)
 ;location for a user-specified number of days.
"RTN","PSAHIS",5,0)
 ;
"RTN","PSAHIS",6,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAHIS",7,0)
 ;
"RTN","PSAHIS",8,0)
LOC ;Gets locations & drugs to print
"RTN","PSAHIS",9,0)
 S (PSACNT,PSAOUT)=0 D ^PSAUTL3 G:PSAOUT EXIT1
"RTN","PSAHIS",10,0)
 S PSACNT=0,PSACHK=$O(PSALOC(""))
"RTN","PSAHIS",11,0)
 I PSACHK="",'PSALOC W !,"There are no active pharmacy locations." G EXIT1
"RTN","PSAHIS",12,0)
 W ! S PSALOCN="" F  S PSALOCN=$O(PSALOC(PSALOCN)) Q:PSALOCN=""!(PSAOUT)  S PSALOC=0 F  S PSALOC=$O(PSALOC(PSALOCN,PSALOC)) Q:'PSALOC!(PSAOUT)  D
"RTN","PSAHIS",13,0)
 .W @IOF W:$L(PSALOCN)>79 !,$P(PSALOCN,"(IP)",1)_"(IP)",!?17,$P(PSALOCN,"(IP)",2) W:$L(PSALOCN)<80 !,PSALOCN
"RTN","PSAHIS",14,0)
 .D DRUG Q:PSAOUT  Q:X["^A"
"RTN","PSAHIS",15,0)
 G:PSAOUT EXIT G DAYS
"RTN","PSAHIS",16,0)
DRUG ;Gets drugs to print
"RTN","PSAHIS",17,0)
 W !!,"You may select one, several, or ^ALL drugs."
"RTN","PSAHIS",18,0)
 F  S DIC="^PSD(58.8,"_+PSALOC_",1,",DIC(0)="AEMQ",DIC("A")="Select Drug: " D  Q:PSAOUT!(Y<0)!(X["^A")
"RTN","PSAHIS",19,0)
 .D ^DIC K DIC I X'["^A"&(Y<1)&('PSACNT) S PSAOUT=1 Q
"RTN","PSAHIS",20,0)
 .I X["^A" D ALL^PSAHIS1 Q
"RTN","PSAHIS",21,0)
 .Q:Y<0  I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAHIS",22,0)
 .S ^TMP("PSADRG",$J,PSALOC,$P($G(^PSDRUG(+Y,0)),"^"),+Y)="" S PSACNT=PSACNT+1
"RTN","PSAHIS",23,0)
 .I PSACNT=1,'$O(^PSD(58.81,"F",+$O(^TMP("PSADRG",$J,PSALOC,$P($G(^PSDRUG(+Y,0)),"^"),0)),0)) W !!,"There have been no transactions for this drug.",!
"RTN","PSAHIS",24,0)
 I '$D(PSALOC) W !!,"There are no drugs in all the selected location(s)." G EXIT
"RTN","PSAHIS",25,0)
 Q
"RTN","PSAHIS",26,0)
 ;
"RTN","PSAHIS",27,0)
DAYS G:$O(^TMP("PSADRG",$J,""))="" EXIT
"RTN","PSAHIS",28,0)
 S DIR(0)="D:AEP",DIR("A")="How many days back do you want to search for the drug: ",DIR("B")="T-6M",DIR("?")="I will list transactions for your selected drug(s) within the last six months if you press return" W ! D ^DIR K DIR
"RTN","PSAHIS",29,0)
 S PSABDT=Y G:$G(DIRUT) EXIT
"RTN","PSAHIS",30,0)
 ;
"RTN","PSAHIS",31,0)
DEV ;Asks device & queueing info
"RTN","PSAHIS",32,0)
 K IO("Q") N %ZIS,IOP,POP S %ZIS="Q" W !
"RTN","PSAHIS",33,0)
 D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" G EXIT  ;;<*73 - RJS
"RTN","PSAHIS",34,0)
 I $D(IO("Q")) D  G EXIT
"RTN","PSAHIS",35,0)
 .N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK
"RTN","PSAHIS",36,0)
 .S ZTRTN="START^PSAHIS",ZTDESC="Drug Acct.-Drug Transaction History"
"RTN","PSAHIS",37,0)
 .S ZTSAVE("PSALOC(")="",ZTSAVE("PSABDT")="",ZTSAVE("^TMP(""PSADRG"",$J,")="" D ^%ZTLOAD
"RTN","PSAHIS",38,0)
 ;
"RTN","PSAHIS",39,0)
START ;Compiles & prints output data
"RTN","PSAHIS",40,0)
 S PSARPDT=$E($$HTFM^XLFDT($H),1,12),PSADT=$P(PSARPDT,"."),PSATM=$P(PSARPDT,".",2)
"RTN","PSAHIS",41,0)
 S PSARPDT=$E(PSADT,4,5)_"-"_$E(PSADT,6,7)_"-"_$E(PSADT,2,3),PSARUN=PSARPDT_"@"_PSATM
"RTN","PSAHIS",42,0)
 S PSADLN="=====================================|==========|=====|=====|==========|========"
"RTN","PSAHIS",43,0)
 S PSABDTR=$E(PSABDT,4,5)_"-"_$E(PSABDT,6,7)_"-"_$E(PSABDT,2,3),PSAOUT=0
"RTN","PSAHIS",44,0)
 S PSALOCN="" F  S PSALOCN=$O(PSALOC(PSALOCN)) Q:PSALOCN=""  D  G:PSAOUT EXIT
"RTN","PSAHIS",45,0)
 .S PSALOC=0 F  S PSALOC=$O(PSALOC(PSALOCN,PSALOC)) Q:'PSALOC  D SITES^PSAUTL1,FIND Q:PSAOUT
"RTN","PSAHIS",46,0)
 ;
"RTN","PSAHIS",47,0)
EXIT W:$E(IOST,1,2)="C-" @IOF D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSAHIS",48,0)
 K IO("Q"),^TMP("PSA",$J),^TMP("PSADRG",$J),^TMP("PSAHIS",$J),PSALOC,PSALOCA,PSALOCN
"RTN","PSAHIS",49,0)
 ;G:'PSAOUT LOC
"RTN","PSAHIS",50,0)
EXIT1 K %ZIS,DIC,DIR,DIRUT,DTOUT,DUOUT,PSA50,PSABAD,PSABAD1,PSABAL,PSABDT,PSABDTR,PSACHK,PSACNT,PSACOMB,PSADJT,PSADJDT,PSADLN,PSADRG,PSADRUG,PSADT
"RTN","PSAHIS",51,0)
 K PSAFIRST,PSAHOLD,PSAHOLDN,PSAIPT,PSAISIT,PSAISITN,PSALN,PSALOC,PSALOCA,PSALOCN,PSANONE,PSAOPT,PSAOSIT,PSAOSITN,PSAOUT,PSAPC,PSAPC1,PSAPCS,PSAPG
"RTN","PSAHIS",52,0)
 K PSAREA,PSARECT,PSARPDT,PSARPDT,PSARUN,PSAS,PSASEL,PSASITES,PSASS,PSATM,PSATR,PSATR0,PSATRANL,PSATRCNT,PSAWRT,X,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSAHIS",53,0)
 Q
"RTN","PSAHIS",54,0)
FIND ;Finds drugs & puts in alpha order in ^TMP("PSAHIS",$J)
"RTN","PSAHIS",55,0)
 K ^TMP("PSAHIS",$J),^TMP("PSA",$J),PSAFIRST
"RTN","PSAHIS",56,0)
 S (PSACNT,PSAPG)=0,PSADRG=""
"RTN","PSAHIS",57,0)
 F  S PSADRG=$O(^TMP("PSADRG",$J,PSALOC,PSADRG)) Q:PSADRG=""  S (PSABAD,PSA50)=0 F  S PSA50=$O(^TMP("PSADRG",$J,PSALOC,PSADRG,PSA50)) Q:'PSA50  D
"RTN","PSAHIS",58,0)
 .;I '$G(PSATR),$O(^TMP("PSADRG",$J,PSALOC,PSADRG,0)) S PSA50=$O(^TMP("PSADRG",$J,PSALOC,PSADRG,0))
"RTN","PSAHIS",59,0)
 .S (PSAFIRST,PSATR)=0 F  S PSATR=+$O(^PSD(58.81,"F",PSA50,PSATR)) Q:'PSATR!(PSAOUT)  D  Q:PSAOUT
"RTN","PSAHIS",60,0)
 ..S PSATR0=$G(^PSD(58.81,PSATR,0)) Q:$P(PSATR0,"^",3)'=PSALOC
"RTN","PSAHIS",61,0)
 ..I $P(PSATR0,"^",4)'<PSABDT S ^TMP("PSAHIS",$J,PSADRG,$E($P(PSATR0,"^",4),1,7),PSATR)="" S:'PSAFIRST PSAFIRST=PSATR,^TMP("PSA",$J,PSADRG)=PSATR Q
"RTN","PSAHIS",62,0)
 ..I PSAFIRST,PSATR>PSAFIRST S PSABAD1=$S($P(PSATR0,"^",2)=2!($P(PSATR0,"^",2)=15)!($P(PSATR0,"^",2)=6):-$P(PSATR0,"^",6),1:$P(PSATR0,"^",6)) S PSABAD(PSADRG)=$G(PSABAD(PSADRG))+PSABAD1
"RTN","PSAHIS",63,0)
 I $D(^TMP("PSAHIS",$J)) D ^PSAHIS1 Q
"RTN","PSAHIS",64,0)
 I '$D(^TMP("PSAHIS",$J)) W !!,"No transactions were found for the pharmacy location." H 1
"RTN","PSAHIS",65,0)
 Q
"RTN","PSAPROC7")
0^1^B59467507^B59246490
"RTN","PSAPROC7",1,0)
PSAPROC7 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;9/6/97
"RTN","PSAPROC7",2,0)
 ;;3.0;DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,12,27,21,42,61,64,67,68,71,73**; 10/24/97;Build 3
"RTN","PSAPROC7",3,0)
 ;This routine takes the data in XTMP and moves it to DA ORDERS file.
"RTN","PSAPROC7",4,0)
 ;It deletes the data in XTMP after it is copies.
"RTN","PSAPROC7",5,0)
 ;
"RTN","PSAPROC7",6,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAPROC7",7,0)
INVOICE ;PSA*3*21 (3JAN01) - FILE INVOICE IMMEDIATELY
"RTN","PSAPROC7",8,0)
 ;
"RTN","PSAPROC7",9,0)
 S PSAIN=$G(^XTMP("PSAPV",PSACTRL,"IN")) Q:PSAIN=""
"RTN","PSAPROC7",10,0)
 Q:$P(PSAIN,"^",8)'="P"
"RTN","PSAPROC7",11,0)
 S PSAORD=$P(PSAIN,"^",4),PSAIEN=+$O(^PSD(58.811,"B",PSAORD,0)),PSACRED=0
"RTN","PSAPROC7",12,0)
 I 'PSAIEN D
"RTN","PSAPROC7",13,0)
 .F  L +^PSD(58.811,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAPROC7",14,0)
 .;(PSA*3*24 - Dave B. Jun 2 00 - Improper DIC call)
"RTN","PSAPROC7",15,0)
 .;(PSA*3*61 - add N DO. DICN will use DO if defined, we do not want to use it since DIC is defined.
"RTN","PSAPROC7",16,0)
 .N DO S DIC="^PSD(58.811,",DIC(0)="L",X=PSAORD D FILE^DICN K DIC L -^PSD(58.811,0) S PSAIEN=+Y
"RTN","PSAPROC7",17,0)
 F  L +^PSD(58.811,PSAIEN,0):10 I  Q
"RTN","PSAPROC7",18,0)
 S:'$D(^PSD(58.811,PSAIEN,1,0)) DIC("P")=$P(^DD(58.811,2,0),"^",2)
"RTN","PSAPROC7",19,0)
 S DA(1)=PSAIEN,DIC="^PSD(58.811,"_DA(1)_",1,",DIC(0)="L",X=$P(PSAIN,"^",2),DLAYGO=58.811 D ^DIC K DA,DLAYGO S PSAIEN1=+Y
"RTN","PSAPROC7",20,0)
 S DA(1)=PSAIEN,DA=PSAIEN1,DIE=DIC K DIC
"RTN","PSAPROC7",21,0)
 S PSALOCDR=$P($G(PSAIN),"^",7)
"RTN","PSAPROC7",22,0)
 S PSADELDR=$P($G(PSAIN),"^",6)
"RTN","PSAPROC7",23,0)
 S PSACSDR=$S($P(PSAIN,"^",10)="ALL CS":"A",$P(PSAIN,"^",9)="CS":"S",1:"N")
"RTN","PSAPROC7",24,0)
 S PSARECD=$P($G(PSAIN),"^",11)
"RTN","PSAPROC7",25,0)
 S PSAMV=$S(+$P(PSAIN,"^",12):$P(PSAIN,"^",12),1:"")
"RTN","PSAPROC7",26,0)
 S PSASUP=$S($P(PSAIN,"^",13)="SUP":1,1:"")
"RTN","PSAPROC7",27,0)
 ;DAVE B ( PSA*3*12) Invalid Concatenation of zero node
"RTN","PSAPROC7",28,0)
 S ^PSD(58.811,DA(1),1,DA,0)=$P(^(0),"^")_"^"_$P(PSAIN,"^",1)_"^P^"_$P(PSAIN,"^",3)_"^"_$G(PSALOCDR)_"^"_$G(PSADELDR)_"^"_$G(PSARECD)_"^"_$G(PSACSDR)_"^^"_DUZ_"^^"_$G(PSAMV)_"^"_$G(PSASUP)
"RTN","PSAPROC7",29,0)
 S DIK=DIE D IX^DIK
"RTN","PSAPROC7",30,0)
 K ^TMP($J,"PSADIF"),PSADIFLC ;*42 pre verify storage for  OU, DUOU, Cost, NDC changes
"RTN","PSAPROC7",31,0)
 S PSALINE=0 F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:PSALINE=""  D LINE
"RTN","PSAPROC7",32,0)
 D SCANDIF,MM ;*42 look for differences to drug file SEND EMAIL
"RTN","PSAPROC7",33,0)
 I PSACRED K DA S DA(1)=PSAIEN,DA=PSAIEN1,DIE="^PSD(58.811,"_DA(1)_",1,",DR="10///^S X=1" D ^DIE K DIE
"RTN","PSAPROC7",34,0)
 S $P(^PSD(58.811,PSAIEN,0),"^",2)=$P($G(^XTMP("PSAPV",PSACTRL,"DS")),"^")
"RTN","PSAPROC7",35,0)
 L -^PSD(58.811,PSAIEN,0)
"RTN","PSAPROC7",36,0)
 K ^XTMP("PSAPV",PSACTRL)
"RTN","PSAPROC7",37,0)
 Q
"RTN","PSAPROC7",38,0)
 ;
"RTN","PSAPROC7",39,0)
LINE ;Files line items.
"RTN","PSAPROC7",40,0)
 S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE) S:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,0)) DIC("P")=$P(^DD(58.8112,5,0),"^",2)
"RTN","PSAPROC7",41,0)
 ;PSA*3*31 Dave B - Check for invoice already in file
"RTN","PSAPROC7",42,0)
 S DA(2)=PSAIEN,DA(1)=PSAIEN1,(DA,X)=PSALINE,DIC="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",1,",DIC(0)="L",DLAYGO=58.811 D ^DIC S PSAIEN2=+Y K DA,DIC,DLAYGO
"RTN","PSAPROC7",43,0)
 ;
"RTN","PSAPROC7",44,0)
 ;DAVEB PSA*3*3 (5may98)
"RTN","PSAPROC7",45,0)
 S PSADRG=$P($G(PSADATA),"^",6)
"RTN","PSAPROC7",46,0)
 S PSASYN=$P($G(PSADATA),"^",7)
"RTN","PSAPROC7",47,0)
 K PSAUNIT
"RTN","PSAPROC7",48,0)
 I $G(PSASYN)'="",$G(PSADRG)'="" S PSAUNIT=+$P($G(^PSDRUG(PSADRG,1,PSASYN,0)),"^",5)
"RTN","PSAPROC7",49,0)
 ;
"RTN","PSAPROC7",50,0)
 ;DAVE B (PSA*3*12) Assignment of order unit didn't take into 
"RTN","PSAPROC7",51,0)
 ;account the adjusted order unit.
"RTN","PSAPROC7",52,0)
 S PSAUNIT=$S($G(PSAUNIT):PSAUNIT,$P(PSADATA,"^",12)'="":$P(PSADATA,"^",12),+$P($P(PSADATA,"^",2),"~",2):+$P($P(PSADATA,"^",2),"~",2),1:0)  ;;*71
"RTN","PSAPROC7",53,0)
 S PSACS=$S($P(PSADATA,"^",19)="CS":1,1:0),PSANDC=$P($P(PSADATA,"^",4),"~"),PSAVSN=$P($P(PSADATA,"^",5),"~"),PSAUPC=$P($P(PSADATA,"^",26),"~")
"RTN","PSAPROC7",54,0)
 I PSANDC="",$P($P(PSADATA,"^",26),"~")'="" S PSANDC="S"_$P($P(PSADATA,"^",26),"~")
"RTN","PSAPROC7",55,0)
 S DA(2)=PSAIEN,DA(1)=PSAIEN1,DA=$S($D(PSAIEN2):PSAIEN2,1:PSALINE),DIE="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",1,"
"RTN","PSAPROC7",56,0)
 ;DaveB (4may98) hard code filing data
"RTN","PSAPROC7",57,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",3)=+PSADATA
"RTN","PSAPROC7",58,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",11)=PSANDC
"RTN","PSAPROC7",59,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",12)=PSAVSN
"RTN","PSAPROC7",60,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",13)=PSAUPC
"RTN","PSAPROC7",61,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",10)=PSACS
"RTN","PSAPROC7",62,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",2)=PSADRG
"RTN","PSAPROC7",63,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",4)=PSAUNIT
"RTN","PSAPROC7",64,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",5)=$P(PSADATA,"^",3)
"RTN","PSAPROC7",65,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",6)=DT
"RTN","PSAPROC7",66,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",7)=DUZ
"RTN","PSAPROC7",67,0)
 ;BGN 67
"RTN","PSAPROC7",68,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),3,DA,0),"^",1)=$P(PSADATA,"^",28)
"RTN","PSAPROC7",69,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),3,DA,0),"^",2)=$P(PSADATA,"^",29)
"RTN","PSAPROC7",70,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),3,DA,0),"^",3)=$P(PSADATA,"^",30)
"RTN","PSAPROC7",71,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),3,DA,0),"^",4)=$P(PSADATA,"^",31)
"RTN","PSAPROC7",72,0)
 ;END 67
"RTN","PSAPROC7",73,0)
 S DIK=DIE D IX^DIK
"RTN","PSAPROC7",74,0)
 ;End PSA*3*7
"RTN","PSAPROC7",75,0)
 ;
"RTN","PSAPROC7",76,0)
 I +$P(PSADATA,"^",15)!($D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP"))) D ADJDRUG
"RTN","PSAPROC7",77,0)
 I $P(PSADATA,"^",8)'="" D QTY
"RTN","PSAPROC7",78,0)
 I +$P(PSADATA,"^",12) D OU
"RTN","PSAPROC7",79,0)
 I +$P(PSADATA,"^",23) D PRICE
"RTN","PSAPROC7",80,0)
 ;Adds the reorder level and/or dispense units per order unit
"RTN","PSAPROC7",81,0)
 I +$P(PSADATA,"^",7)!(+$P(PSADATA,"^",20))!(+$P(PSADATA,"^",21))!(+$P(PSADATA,"^",27)) D
"RTN","PSAPROC7",82,0)
 .S ^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,2)=$P(PSADATA,"^",20)_"^"_$P(PSADATA,"^",21)_"^"_$S(+$P(PSADATA,"^",7):+$P(PSADATA,"^",7),1:0)_"^"_+$P(PSADATA,"^",27)
"RTN","PSAPROC7",83,0)
 ;Bgn 67
"RTN","PSAPROC7",84,0)
 I $P($P(PSADATA,"^",5),"~")'="" S ^XTMP("PSAVSN",$P($P(PSADATA,"^",5),"~"))=$P(PSADATA,"^",28)_"^"_$P(PSADATA,"^",29)_"^"_$P(PSADATA,"^",30)_"^"_$P(PSADATA,"^",31)
"RTN","PSAPROC7",85,0)
 ;End 67
"RTN","PSAPROC7",86,0)
 K ^XTMP("PSAPV",PSACTRL,"IT",PSALINE)
"RTN","PSAPROC7",87,0)
 Q
"RTN","PSAPROC7",88,0)
ADJDRUG ;Records adjusted drug received
"RTN","PSAPROC7",89,0)
 S PSAFLD="D"
"RTN","PSAPROC7",90,0)
 I +$P(PSADATA,"^",15) S PSADJ=+$P(PSADATA,"^",15),PSADUZ=+$P(PSADATA,"^",16),PSADT=+$P(PSADATA,"^",17),PSAREA="" D RECORD Q
"RTN","PSAPROC7",91,0)
 I $D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP")) S PSASNODE=^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP"),PSADJ=$P(PSASNODE,"^",3),PSADUZ=+$P(PSASNODE,"^"),PSADT=+$P(PSASNODE,"^",2),PSAREA="" D RECORD
"RTN","PSAPROC7",92,0)
 Q
"RTN","PSAPROC7",93,0)
OU ;Records adjusted order unit
"RTN","PSAPROC7",94,0)
 S PSAFLD="O",PSADJ=+$P(PSADATA,"^",12),PSADUZ=+$P(PSADATA,"^",13),PSADT=+$P(PSADATA,"^",14),PSAREA=""
"RTN","PSAPROC7",95,0)
 D RECORD
"RTN","PSAPROC7",96,0)
 Q
"RTN","PSAPROC7",97,0)
PRICE ;Records adjusted price per order unit
"RTN","PSAPROC7",98,0)
 S PSAFLD="P",PSADJ=+$P(PSADATA,"^",23),PSADUZ=+$P(PSADATA,"^",24),PSADT=+$P(PSADATA,"^",25),PSAREA=""
"RTN","PSAPROC7",99,0)
 S:PSADJ'=+$P(PSADATA,"^",3) PSACRED=1
"RTN","PSAPROC7",100,0)
 D RECORD
"RTN","PSAPROC7",101,0)
 Q
"RTN","PSAPROC7",102,0)
QTY ;Records adjusted quantity received.
"RTN","PSAPROC7",103,0)
 S PSAFLD="Q",PSADJ=+$P(PSADATA,"^",8),PSADUZ=+$P(PSADATA,"^",9),PSADT=+$P(PSADATA,"^",10),PSAREA=$P(PSADATA,"^",11)
"RTN","PSAPROC7",104,0)
 S:PSADJ'=+$P(PSADATA,"^") PSACRED=1
"RTN","PSAPROC7",105,0)
 D RECORD
"RTN","PSAPROC7",106,0)
 Q
"RTN","PSAPROC7",107,0)
RECORD ;Adds adjusted data to DA ORDERS file
"RTN","PSAPROC7",108,0)
 K DA S DA(3)=PSAIEN,DA(2)=PSAIEN1,DA(1)=PSAIEN2,X=PSAFLD
"RTN","PSAPROC7",109,0)
 S:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,0)) DIC("P")=$P(^DD(58.81125,9,0),"^",2)
"RTN","PSAPROC7",110,0)
 ;PSA*3*27 (DAVE B) removed killing of DA variable on next line
"RTN","PSAPROC7",111,0)
 S DIC="^PSD(58.811,"_DA(3)_",1,"_DA(2)_",1,"_DA(1)_",1,",DIC(0)="L",DLAYGO=58.811 D ^DIC S PSAIEN3=+Y K DLAYGO
"RTN","PSAPROC7",112,0)
 ;
"RTN","PSAPROC7",113,0)
 ;PSA*3*3
"RTN","PSAPROC7",114,0)
 ;DAVEB Hard code filing
"RTN","PSAPROC7",115,0)
 S DIE=DIC,DA=PSAIEN3
"RTN","PSAPROC7",116,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",2)=PSADJ
"RTN","PSAPROC7",117,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",3)=$G(PSAREA)
"RTN","PSAPROC7",118,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",4)=DT
"RTN","PSAPROC7",119,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",5)=DUZ
"RTN","PSAPROC7",120,0)
 ;
"RTN","PSAPROC7",121,0)
 S DIK=DIE,DA=PSAIEN3 D IX1^DIK K DA,DIE,DIK,PSAFLD
"RTN","PSAPROC7",122,0)
 Q
"RTN","PSAPROC7",123,0)
 ;*42 CHANGES
"RTN","PSAPROC7",124,0)
SCANDIF ; inspect invoice for noted differences in OU,DUOU,PPDU,NDC
"RTN","PSAPROC7",125,0)
 ;NEEDS PSAIEN, PSAIEN1
"RTN","PSAPROC7",126,0)
 K ^TMP($J,"PSADIF"),PSADIFLC
"RTN","PSAPROC7",127,0)
 S PSALINE=0 F  S PSALINE=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:PSALINE'>0  D CHECK
"RTN","PSAPROC7",128,0)
 Q
"RTN","PSAPROC7",129,0)
MM ;
"RTN","PSAPROC7",130,0)
 I $D(^TMP($J,"PSADIF")) D MESSAGE
"RTN","PSAPROC7",131,0)
 Q
"RTN","PSAPROC7",132,0)
CHECK ;Check line item for differences to drug file *42
"RTN","PSAPROC7",133,0)
 N ITM,ITMI,DRG,DRIEN,DIF,ZZ,XX,XXX,PCNT,PDIF,T,IENS
"RTN","PSAPROC7",134,0)
 ; use new API call to retrieve item fields see PSAUTL6
"RTN","PSAPROC7",135,0)
 D ITEM^PSAUTL6(PSAIEN,PSAIEN1,PSALINE,.ITM)
"RTN","PSAPROC7",136,0)
 D ITEM^PSAUTL6(PSAIEN,PSAIEN1,PSALINE,.ITMI,"I")
"RTN","PSAPROC7",137,0)
 I ITM(2)'>0 Q  ;zero quantity will not be filed
"RTN","PSAPROC7",138,0)
 S ITM("OU")=ITM(3),ITM("DUOU")=ITM(10),ITM("NDC")=ITM(13),ITM("PPOU")=ITM(4),ITM("PPDU")=$J(ITM("PPOU")/ITM("DUOU"),1,4)
"RTN","PSAPROC7",139,0)
 I ITMI(1)'?1.N S DRIEN=ITMI(1)
"RTN","PSAPROC7",140,0)
 I ITMI(1)?1.N S DRIEN=+ITMI(1)
"RTN","PSAPROC7",141,0)
 Q:'$D(^PSDRUG(DRIEN))
"RTN","PSAPROC7",142,0)
 S DRG("OU")=$$GET1^DIQ(50,DRIEN,12),DRG("DUOU")=$$GET1^DIQ(50,DRIEN,15),DRG("NDC")=$$GET1^DIQ(50,DRIEN,31),DRG("PPDU")=$$GET1^DIQ(50,DRIEN,16)
"RTN","PSAPROC7",143,0)
 K DIF
"RTN","PSAPROC7",144,0)
 F XX="OU","DUOU","NDC" I $D(DRG(XX)),ITM(XX)'=DRG(XX) S DIF(XX)=""
"RTN","PSAPROC7",145,0)
 I $G(DRG("PPDU")),ITM("PPDU")'=DRG("PPDU") S PCNT=.05*DRG("PPDU"),PDIF=DRG("PPDU")-ITM("PPDU") S:PDIF<0 PDIF=-1*PDIF S:PDIF>PCNT DIF("PPDU")=""
"RTN","PSAPROC7",146,0)
 S:ITM("OU")=""!(ITM("OU")=0) ITM("OU")="Blank",DIF("OU")=""  ;;*71
"RTN","PSAPROC7",147,0)
 S:DRG("OU")=""!(DRG("OU")=0) DRG("OU")="Blank",DIF("OU")=""  ;;*71
"RTN","PSAPROC7",148,0)
 I $D(DIF) D
"RTN","PSAPROC7",149,0)
 . F ZZ=" ",$J(ITM(.01),3)_"   "_ITM(1) D SET
"RTN","PSAPROC7",150,0)
 . S XXX="" F  S XXX=$O(DIF(XXX)) Q:XXX=""  D
"RTN","PSAPROC7",151,0)
 .. S ZZ="  ",T=XXX,ZZ=$$SETSTR^VALM1(T,ZZ,4,$L(T))
"RTN","PSAPROC7",152,0)
 .. S T="Old: "_DRG(XXX),ZZ=$$SETSTR^VALM1(T,ZZ,13,$L(T))
"RTN","PSAPROC7",153,0)
 .. S T="New: "_ITM(XXX),ZZ=$$SETSTR^VALM1(T,ZZ,36,$L(T))
"RTN","PSAPROC7",154,0)
 .. D SET
"RTN","PSAPROC7",155,0)
 Q
"RTN","PSAPROC7",156,0)
SET ;set differences into ^TMP
"RTN","PSAPROC7",157,0)
 S:'$G(PSADIFLC) PSADIFLC=3
"RTN","PSAPROC7",158,0)
 S ^TMP($J,"PSADIF",PSADIFLC,0)=ZZ,PSADIFLC=PSADIFLC+1
"RTN","PSAPROC7",159,0)
 Q
"RTN","PSAPROC7",160,0)
MESSAGE ;differences found, notify user and send message to g.PSA NDC UPDATES.
"RTN","PSAPROC7",161,0)
 K DIR N IENS
"RTN","PSAPROC7",162,0)
 S PSAORD=$$GET1^DIQ(58.811,PSAIEN,.01),IENS=PSAIEN1_","_PSAIEN
"RTN","PSAPROC7",163,0)
 S PSAINV=$$GET1^DIQ(58.8112,IENS,.01)
"RTN","PSAPROC7",164,0)
 S XMSUB="PRE Verify "_PSAORD_" : "_PSAINV_" Variance Report"
"RTN","PSAPROC7",165,0)
 S ^TMP($J,"PSADIF",1,0)=XMSUB,^TMP($J,"PSADIF",2,0)=" "
"RTN","PSAPROC7",166,0)
 W !,XMSUB,!
"RTN","PSAPROC7",167,0)
 W !,"Noted differences between the invoice line items and the drug file have",!,"been found. A mail message is being sent to G.PSA NDC UPDATES."
"RTN","PSAPROC7",168,0)
 W !!,"    Please check the message for accuracy.",!
"RTN","PSAPROC7",169,0)
 K DIR S DIR(0)="E",DIR("A")="<cr> - continue" D ^DIR
"RTN","PSAPROC7",170,0)
 K DIR
"RTN","PSAPROC7",171,0)
 S XMTEXT="^TMP($J,""PSADIF"",",XMY("G.PSA NDC UPDATES")=""
"RTN","PSAPROC7",172,0)
 D ^XMD
"RTN","PSAPROC7",173,0)
 K PSADIFLC,^TMP($J,"PSADIF")
"RTN","PSAPROC7",174,0)
 Q
"RTN","PSAPTCH")
0^2^B16300377^B15281511
"RTN","PSAPTCH",1,0)
PSAPTCH ;BHM/DAV - FIND INVOICES PROCESSED BY CONTROLLED SUBS;
"RTN","PSAPTCH",2,0)
 ;;3.0;DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**21,73**; 10/24/97;Build 3
"RTN","PSAPTCH",3,0)
 ;CS() = array contains item numbers of processed CS invoice
"RTN","PSAPTCH",4,0)
 ;PSACSERR =error flag set
"RTN","PSAPTCH",5,0)
 ;
"RTN","PSAPTCH",6,0)
 D Q
"RTN","PSAPTCH",7,0)
 ;
"RTN","PSAPTCH",8,0)
1 ;Check for uploaded CS invoice
"RTN","PSAPTCH",9,0)
 ;PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPTCH",10,0)
 S PSAUPORD=$P(PSAIN,"^",4) ;Incoming Order Number
"RTN","PSAPTCH",11,0)
 S PSAUPINV=$P(PSAIN,"^",2) ;Incoming Invoice Number
"RTN","PSAPTCH",12,0)
 I '$D(^XTMP("PSAPV",PSACTRL,"IT")) K ^XTMP("PSAPV",PSACTRL) S PSAINVDL=1 Q
"RTN","PSAPTCH",13,0)
 I $G(PSAUPORD)="" K ^XTMP("PSAPV",PSACTRL) S PSAINVDL=1 Q
"RTN","PSAPTCH",14,0)
 I $G(PSAUPINV)="" K ^XTMP("PSAPV",PSACTRL) S PSAINVDL=1 Q
"RTN","PSAPTCH",15,0)
 I $L(PSAIN)'>10 K ^XTMP("PSAPV",PSACTRL) S PSAINVDL=1 Q
"RTN","PSAPTCH",16,0)
 S Y=$P(PSAIN,"^",1) X ^DD("DD") S PSAUPDT1=Y ;Invoice Date
"RTN","PSAPTCH",17,0)
 S Y=$P(PSAIN,"^",3) X ^DD("DD") S PSAUPDT2=Y ;Order Date
"RTN","PSAPTCH",18,0)
 S INVITM=0 F  S INVITM=$O(^XTMP("PSAPV",PSACTRL,"IT",INVITM)) Q:INVITM'>0  S INV(INVITM)=^XTMP("PSAPV",PSACTRL,"IT",INVITM),INVCNT=INVITM
"RTN","PSAPTCH",19,0)
 I '$D(^PSD(58.811,"AORD",PSAUPORD,PSAUPINV)) G Q
"RTN","PSAPTCH",20,0)
 K PSAORD,ORDIEN,INVIEN,CSINV
"RTN","PSAPTCH",21,0)
 S ORDIEN=$O(^PSD(58.811,"AORD",PSAUPORD,PSAUPINV,0)) ;Order # IEN
"RTN","PSAPTCH",22,0)
 S INVIEN=$O(^PSD(58.811,"AORD",PSAUPORD,PSAUPINV,ORDIEN,0)) ;Invoice # IEN
"RTN","PSAPTCH",23,0)
 S PSDCNT=0,X=0 F  S X=$O(^PSD(58.811,ORDIEN,1,INVIEN,1,X)) Q:X'>0  S PSDCNT=$G(PSDCNT)+1
"RTN","PSAPTCH",24,0)
 I INVCNT=PSDCNT K ^XTMP("PSAPV",PSACTRL) Q
"RTN","PSAPTCH",25,0)
 W @IOF,!,"** WARNING **",!!,"P.O. Number    : ",PSAUPORD,!,"Invoice Number : ",PSAUPINV,!
"RTN","PSAPTCH",26,0)
 ;
"RTN","PSAPTCH",27,0)
 S PSASTAS=$P($G(^PSD(58.811,ORDIEN,1,INVIEN,0)),"^",3),PSASTAS=$S(PSASTAS="P":"PROCESSED",PSASTAS="V":"VERIFIED",PSASTAS="C":"COMPLETED",1:"UNKNOWN")
"RTN","PSAPTCH",28,0)
 W !,"Incoming",?40,"Already Marked as "_" * "_PSASTAS_" *",!,"Invoice file",?40,"in Drug Accountability Order file",! F X=1:1:(IOM-1) W "="
"RTN","PSAPTCH",29,0)
 S Y=$P($G(^PSD(58.811,ORDIEN,1,INVIEN,0)),"^",4) X ^DD("DD") W !,PSAUPDT2,?16," <-- Order Date --> ",?40,Y
"RTN","PSAPTCH",30,0)
 S Y=$P($G(^PSD(58.811,ORDIEN,1,INVIEN,0)),"^",2) X ^DD("DD") W !,PSAUPDT1,?15," <-- Invoice Date --> ",?40,Y
"RTN","PSAPTCH",31,0)
CHECK W !,?3,$J($G(INVCNT),8),?16," <-- Line Items -->",?40,$G(PSDCNT),!!
"RTN","PSAPTCH",32,0)
 ;
"RTN","PSAPTCH",33,0)
CMPRE R !,"Do you want to compare item? NO// ",AN:DTIME I AN["^"!(AN="") G ASK
"RTN","PSAPTCH",34,0)
 S AN=$E(AN) I "yYnN"'[AN W !,"Answer 'Y'es to display the items from the invoice file, as well as the items",!,"already uploaded.",! G CMPRE
"RTN","PSAPTCH",35,0)
 I "nN"[AN G ASK
"RTN","PSAPTCH",36,0)
 S X=0 F  S X=$O(^XTMP("PSAPV",PSACTRL,"IT",X)) Q:X=""  S DATA=$G(^XTMP("PSAPV",PSACTRL,"IT",X)),PSAITM(X)=DATA
"RTN","PSAPTCH",37,0)
 S X=0 F  S X=$O(^PSD(58.811,ORDIEN,1,INVIEN,1,X)) Q:X=""  S DATA=$G(^PSD(58.811,ORDIEN,1,INVIEN,1,X,0)),PSAUPITM(+DATA)=DATA
"RTN","PSAPTCH",38,0)
 S:INVCNT'=PSDCNT $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",8)="OK"
"RTN","PSAPTCH",39,0)
 G Q
"RTN","PSAPTCH",40,0)
 ;
"RTN","PSAPTCH",41,0)
ASK R !!,"Do you want to delete the incoming invoice ? NO// ",AN:DTIME G Q:AN["^" I "Nn"[AN G Q
"RTN","PSAPTCH",42,0)
 I "?"[AN W !!,"Answer 'Y'es, and the incoming invoice will be deleted.",! G ASK
"RTN","PSAPTCH",43,0)
 I AN="" G Q
"RTN","PSAPTCH",44,0)
 I "Yy"[AN K ^XTMP("PSAPV",PSACTRL) S PSAINVDL=1 Q
"RTN","PSAPTCH",45,0)
 ;
"RTN","PSAPTCH",46,0)
 ;Kill incoming invoice.
"RTN","PSAPTCH",47,0)
Q K AN,CS,CSCNT,CSIEN,CSINV,DATA,FOUND,INV,INVCNT,INVDEL,INVIEN,INVITM,LINEITM,ORDIEN,PSAORD,PSAUPDT1,PSAUPDT2,PSAUPINV,PSAUPORD,PSDCNT,X,XX,Y Q
"RTN","PSAPTCH",48,0)
PSAOLD ;Entry point for deleting old invoices
"RTN","PSAPTCH",49,0)
 I '$D(^XTMP("PSAPV")) W !,"Sorry, there aren't any invoices on file." G Q
"RTN","PSAPTCH",50,0)
ASKDT S %DT="A",%DT("A")="Delete invoices older than what date: " D ^%DT
"RTN","PSAPTCH",51,0)
 I Y'<DT W !,"Sorry, the date has to be in the past." K Y G ASKDT
"RTN","PSAPTCH",52,0)
 S PSAKLDT=Y
"RTN","PSAPTCH",53,0)
 ;
"RTN","PSAPTCH",54,0)
 S PSACTRL=0 F  S PSACTRL=$O(^XTMP("PSAPV",PSACTRL)) Q:PSACTRL'>0  S DATA=$G(^XTMP("PSAPV",PSACTRL,"IN")) D
"RTN","PSAPTCH",55,0)
 .I $G(DATA)="" Q
"RTN","PSAPTCH",56,0)
 .S PSAINVDT=$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",1)
"RTN","PSAPTCH",57,0)
 .I PSAINVDT<PSAKLDT K ^XTMP("PSAPV",PSACTRL) W "."
"RTN","PSAPTCH",58,0)
 W !,"Finished" K PSACTRL,PSAINVDT,PSAKLDT Q
"RTN","PSAUDP")
0^3^B17663962^B17006589
"RTN","PSAUDP",1,0)
PSAUDP ;BIR/LTL,JMB-Nightly Background Job - CONT'D ;7/23/97
"RTN","PSAUDP",2,0)
 ;;3.0;DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**6,3,12,14,25,64,66,73**; 10/24/97;Build 3
"RTN","PSAUDP",3,0)
 ;
"RTN","PSAUDP",4,0)
 ;Reference to ^PS(57.6 are covered by IA #772
"RTN","PSAUDP",5,0)
PICKLST ;ask for parameters PSA*3*25
"RTN","PSAUDP",6,0)
 I '$D(^PSD(58.812,1,"T","B","UNIT DOSE"))!('$D(^PSD(58.812,1,"T"))) D
"RTN","PSAUDP",7,0)
 .S ^PSD(58.812,1,"T",0)="^58.8123A^1^1"
"RTN","PSAUDP",8,0)
 .S X="T-2W" D ^%DT S ^PSD(58.812,1,"T",1,0)="UNIT DOSE^"_Y_"^",X="T-1W" D ^%DT S $P(^PSD(58.812,1,"T",1,0),"^",3)=Y K X,Y
"RTN","PSAUDP",9,0)
 .S ^PSD(58.812,1,"T","B","UNIT DOSE",1)=""
"RTN","PSAUDP",10,0)
 S XX=$O(^PSD(58.812,1,"T","B","UNIT DOSE",0)) Q:XX'>0  S JOBIEN=XX D NOW^%DTC S STRTDATE=%,PARDATA=$G(^PSD(58.812,1,"T",JOBIEN,0))
"RTN","PSAUDP",11,0)
 S PSABGN=$P(PARDATA,"^",2),PSAEND=$P(PARDATA,"^",3)
"RTN","PSAUDP",12,0)
 S X="T-7" D ^%DT I Y'=PSAEND G DONE
"RTN","PSAUDP",13,0)
 S $P(^PSD(58.812,1,"T",JOBIEN,0),"^",2)=PSAEND,X1=PSAEND,X2=7 D C^%DTC S $P(^PSD(58.812,1,"T",JOBIEN,0),"^",3)=X ;Reset date parameters
"RTN","PSAUDP",14,0)
 ;Go back two weeks, gather 1 weeks worth of data
"RTN","PSAUDP",15,0)
 S PSAD0=PSABGN-.000001
"RTN","PSAUDP",16,0)
 S PSAEND=PSAEND_".2359"
"RTN","PSAUDP",17,0)
DATE ;Loop through dates
"RTN","PSAUDP",18,0)
 S PSAD0=$O(^PS(57.6,PSAD0)) G DONE:PSAD0'>0 G DONE:PSAD0>PSAEND K PSAD1
"RTN","PSAUDP",19,0)
WRD S PSAD1=$S('$D(PSAD1):$O(^PS(57.6,PSAD0,1,0)),1:$O(^PS(57.6,PSAD0,1,PSAD1))) G DATE:PSAD1'>0 K PSAD2
"RTN","PSAUDP",20,0)
PVDR ;Loop through providers
"RTN","PSAUDP",21,0)
 S PSAD2=$S('$D(PSAD2):$O(^PS(57.6,PSAD0,1,PSAD1,1,0)),1:$O(^PS(57.6,PSAD0,1,PSAD1,1,PSAD2))) G WRD:PSAD2'>0 K PSAD3
"RTN","PSAUDP",22,0)
DRG S PSAD3=$S('$D(PSAD3):$O(^PS(57.6,PSAD0,1,PSAD1,1,PSAD2,1,0)),1:$O(^PS(57.6,PSAD0,1,PSAD1,1,PSAD2,1,PSAD3))) G PVDR:PSAD3'>0 S DATA=$G(^PS(57.6,PSAD0,1,PSAD1,1,PSAD2,1,PSAD3,0))
"RTN","PSAUDP",23,0)
 S PSAIP=PSAD1,PSA50=PSAD3,PSADT=PSAD0 K PSALOC
"RTN","PSAUDP",24,0)
LOC S PSALOC=$S('$D(PSALOC):$O(^PSD(58.8,"AB",PSAD1,0)),1:$O(^PSD(58.8,"AB",PSAD1,PSALOC))) G DRG:PSALOC'>0 I $D(^PSD(58.8,PSALOC,"I")),+$P($G(^PSD(58.8,PSALOC,"I")),"^")'=0,$P($G(^PSD(58.8,PSALOC,"I")),"^")'>DT G LOC  ;;<*73-RJS>
"RTN","PSAUDP",25,0)
 S PSAQTY=$P($G(DATA),"^",2)-$P($G(DATA),"^",4)
"RTN","PSAUDP",26,0)
 I $D(^PSD(58.8,PSALOC,1,PSA50)) D PROCESS
"RTN","PSAUDP",27,0)
 G LOC
"RTN","PSAUDP",28,0)
 ;
"RTN","PSAUDP",29,0)
 Q
"RTN","PSAUDP",30,0)
DONE ;
"RTN","PSAUDP",31,0)
END K DA,DATA,DIC,DIE,DR,PSA50,PSAD0,PSAD1,PSAD2,PSAD3,PSADT,PSAIP,PSALOC,PSANUM,PSAQTY,X,Y,PSABGN,PSAEND,PARDATA,JOBIEN,X
"RTN","PSAUDP",32,0)
 Q
"RTN","PSAUDP",33,0)
PROCESS ;Stuff last UD dispensing fld with DT
"RTN","PSAUDP",34,0)
 F  L +^PSD(58.8,PSALOC,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAUDP",35,0)
 S DIE="^PSD(58.8,",DA=PSALOC,DR="27////"_PSADT D ^DIE K DIE,DA,DR
"RTN","PSAUDP",36,0)
 ;Subtract dispensing from balance
"RTN","PSAUDP",37,0)
 S PSABAL=$P($G(^PSD(58.8,PSALOC,1,PSA50,0)),"^",4)
"RTN","PSAUDP",38,0)
 S $P(^PSD(58.8,PSALOC,1,PSA50,0),"^",4)=PSABAL-$G(PSAQTY)
"RTN","PSAUDP",39,0)
 ;If no monthly activity node, add node with beginning balance.
"RTN","PSAUDP",40,0)
 I '$D(^PSD(58.8,PSALOC,1,PSA50,5,+$E(PSADT,1,5)*100,0)) D
"RTN","PSAUDP",41,0)
 .S DIC="^PSD(58.8,PSALOC,1,PSA50,5,",DIC(0)="L",DIC("P")=$P(^DD(58.8001,20,0),U,2),(X,DINUM)=$E(PSADT,1,5)*100,DA(2)=PSALOC,DA(1)=PSA50
"RTN","PSAUDP",42,0)
 .S DIC("DR")="1////^S X=$G(PSABAL)",DLAYGO=58.8 D ^DIC K DIC,DLAYGO
"RTN","PSAUDP",43,0)
 .;Add current month's node and stuff beginning & ending balance.
"RTN","PSAUDP",44,0)
 .S DIC="^PSD(58.8,PSALOC,1,PSA50,5,",DIC(0)="L",(X,DINUM)=$E(PSADT-100-(+$E(PSADT,4,5)=1*8800),1,5)*100,DA(2)=PSALOC,DA(1)=PSA50,DLAYGO=58.8 D ^DIC K DIC,DLAYGO S DA=+Y
"RTN","PSAUDP",45,0)
 .S DIE="^PSD(58.8,PSALOC,1,PSA50,5,",DA(2)=PSALOC,DA(1)=PSA50,DR="3////^S X=$G(PSABAL)" D ^DIE K DIE
"RTN","PSAUDP",46,0)
 ;Stuff total dispensed
"RTN","PSAUDP",47,0)
 S DIE="^PSD(58.8,PSALOC,1,PSA50,5,",DA(2)=PSALOC,DA(1)=PSA50,DA=$E(PSADT,1,5)*100,DR="9////^S X=$P($G(^(0)),U,6)+PSAQTY" D ^DIE K DIE,DA
"RTN","PSAUDP",48,0)
 ;Get next transaction node number
"RTN","PSAUDP",49,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q  ;; << *66 RJS
"RTN","PSAUDP",50,0)
FIND S PSANUM=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSANUM)) S $P(^PSD(58.81,0),"^",3)=$P(^PSD(58.81,0),"^",3)+1 G FIND
"RTN","PSAUDP",51,0)
 ;Add next transaction node with data.
"RTN","PSAUDP",52,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSANUM D ^DIC K DIC,DLAYGO
"RTN","PSAUDP",53,0)
 S DIE="^PSD(58.81,",DA=PSANUM
"RTN","PSAUDP",54,0)
 S DR="1////2;2////^S X=PSALOC;3////^S X=PSADT;4////^S X=PSA50;5////^S X=PSAQTY;9////^S X=$G(PSABAL)" D ^DIE K DIE,DA
"RTN","PSAUDP",55,0)
 L -^PSD(58.81,0)  ;; >> *66 RJS
"RTN","PSAUDP",56,0)
 ;Add activity node
"RTN","PSAUDP",57,0)
 S DIC="^PSD(58.8,PSALOC,1,PSA50,4,",DIC(0)="L",(X,DINUM)=PSANUM,DIC("P")=$P(^DD(58.8001,19,0),"^",2),DA(2)=PSALOC,DA(1)=PSA50,DLAYGO=58.8 D ^DIC K DA,DIC,DLAYGO
"RTN","PSAUDP",58,0)
 L -^PSD(58.8,PSALOC,0)
"RTN","PSAUDP",59,0)
 Q
"VER")
8.0^22.0
"BLD",8915,6)
^58
**END**
**END**

