Released RA*5*125 SEQ #112
Extracted from mail message
**KIDS**:RA*5.0*125^

**INSTALL NAME**
RA*5.0*125
"BLD",9327,0)
RA*5.0*125^RADIOLOGY/NUCLEAR MEDICINE^0^3160127^y
"BLD",9327,1,0)
^^3^3^3151209^
"BLD",9327,1,1,0)
Patch one hundred and twenty-five for the VistA Radiology/Nuclear 
"BLD",9327,1,2,0)
Medicine 5.0 application. Please review FORUM's Patch Module description
"BLD",9327,1,3,0)
and installation instructions for RA*5.0*125 before installing this patch.
"BLD",9327,4,0)
^9.64PA^^
"BLD",9327,6.3)
1
"BLD",9327,"KRN",0)
^9.67PA^779.2^20
"BLD",9327,"KRN",.4,0)
.4
"BLD",9327,"KRN",.401,0)
.401
"BLD",9327,"KRN",.402,0)
.402
"BLD",9327,"KRN",.402,"NM",0)
^9.68A^^0
"BLD",9327,"KRN",.403,0)
.403
"BLD",9327,"KRN",.5,0)
.5
"BLD",9327,"KRN",.84,0)
.84
"BLD",9327,"KRN",3.6,0)
3.6
"BLD",9327,"KRN",3.8,0)
3.8
"BLD",9327,"KRN",9.2,0)
9.2
"BLD",9327,"KRN",9.8,0)
9.8
"BLD",9327,"KRN",9.8,"NM",0)
^9.68A^4^3
"BLD",9327,"KRN",9.8,"NM",1,0)
RADLQ3^^0^B24380581
"BLD",9327,"KRN",9.8,"NM",2,0)
RAHLR1^^0^B25001746
"BLD",9327,"KRN",9.8,"NM",4,0)
RAHLRU^^0^B50865830
"BLD",9327,"KRN",9.8,"NM","B","RADLQ3",1)

"BLD",9327,"KRN",9.8,"NM","B","RAHLR1",2)

"BLD",9327,"KRN",9.8,"NM","B","RAHLRU",4)

"BLD",9327,"KRN",19,0)
19
"BLD",9327,"KRN",19.1,0)
19.1
"BLD",9327,"KRN",101,0)
101
"BLD",9327,"KRN",409.61,0)
409.61
"BLD",9327,"KRN",771,0)
771
"BLD",9327,"KRN",779.2,0)
779.2
"BLD",9327,"KRN",870,0)
870
"BLD",9327,"KRN",8989.51,0)
8989.51
"BLD",9327,"KRN",8989.52,0)
8989.52
"BLD",9327,"KRN",8994,0)
8994
"BLD",9327,"KRN","B",.4,.4)

"BLD",9327,"KRN","B",.401,.401)

"BLD",9327,"KRN","B",.402,.402)

"BLD",9327,"KRN","B",.403,.403)

"BLD",9327,"KRN","B",.5,.5)

"BLD",9327,"KRN","B",.84,.84)

"BLD",9327,"KRN","B",3.6,3.6)

"BLD",9327,"KRN","B",3.8,3.8)

"BLD",9327,"KRN","B",9.2,9.2)

"BLD",9327,"KRN","B",9.8,9.8)

"BLD",9327,"KRN","B",19,19)

"BLD",9327,"KRN","B",19.1,19.1)

"BLD",9327,"KRN","B",101,101)

"BLD",9327,"KRN","B",409.61,409.61)

"BLD",9327,"KRN","B",771,771)

"BLD",9327,"KRN","B",779.2,779.2)

"BLD",9327,"KRN","B",870,870)

"BLD",9327,"KRN","B",8989.51,8989.51)

"BLD",9327,"KRN","B",8989.52,8989.52)

"BLD",9327,"KRN","B",8994,8994)

"BLD",9327,"QUES",0)
^9.62^^
"BLD",9327,"REQB",0)
^9.611^2^2
"BLD",9327,"REQB",1,0)
RA*5.0*47^2
"BLD",9327,"REQB",2,0)
RA*5.0*106^2
"BLD",9327,"REQB","B","RA*5.0*106",2)

"BLD",9327,"REQB","B","RA*5.0*47",1)

"MBREQ")
0
"PKG",18,-1)
1^1
"PKG",18,0)
RADIOLOGY/NUCLEAR MEDICINE^RA^REGISTERS PATIENTS,RECORDS EXAMS,PROFILES,AMIS REPORTS
"PKG",18,20,0)
^9.402P^^
"PKG",18,22,0)
^9.49I^1^1
"PKG",18,22,1,0)
5.0^3051109^2980407^50
"PKG",18,22,1,"PAH",1,0)
125^3160127
"PKG",18,22,1,"PAH",1,1,0)
^^3^3^3160127
"PKG",18,22,1,"PAH",1,1,1,0)
Patch one hundred and twenty-five for the VistA Radiology/Nuclear 
"PKG",18,22,1,"PAH",1,1,2,0)
Medicine 5.0 application. Please review FORUM's Patch Module description
"PKG",18,22,1,"PAH",1,1,3,0)
and installation instructions for RA*5.0*125 before installing this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","RADLQ3")
0^1^B24380581^B23869496
"RTN","RADLQ3",1,0)
RADLQ3 ;HISC/GJC-Delq Status/Incomplete Rpt's ;5/7/97  15:58
"RTN","RADLQ3",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**87,93,47,125**;Mar 16, 1998;Build 1
"RTN","RADLQ3",3,0)
 ; 11/15/07 BAY/KAM RA*5*87 Rem Call 217642 change pat ssn to display last four
"RTN","RADLQ3",4,0)
 ; 05/09/08 BAY/KAM RA*5*93 Rem Call 246868 correct printing of *** OUTPATIENT ***
"RTN","RADLQ3",5,0)
DISPXAM ; Display exam statuses for selected Imaging Types.  These exam
"RTN","RADLQ3",6,0)
 ; statuses need the 'DELINQUENT STATUS REPORT?' field tripped to
"RTN","RADLQ3",7,0)
 ; 'yes' in file 72.
"RTN","RADLQ3",8,0)
 N RA,RAHD,UNDRLN,X,Y,Z
"RTN","RADLQ3",9,0)
 S RAHD(0)="The entries printed for this report will be based only"
"RTN","RADLQ3",10,0)
 S RAHD(1)="on exams that are in one of the following statuses:"
"RTN","RADLQ3",11,0)
 I '$D(RALL) D
"RTN","RADLQ3",12,0)
 . W !!?(IOM-$L(RAHD(0))\2),RAHD(0)
"RTN","RADLQ3",13,0)
 . W !?(IOM-$L(RAHD(1))\2),RAHD(1)
"RTN","RADLQ3",14,0)
 . Q
"RTN","RADLQ3",15,0)
 S X="" F  S X=$O(^TMP($J,"RA I-TYPE",X)) Q:X']""  D  Q:RAXIT
"RTN","RADLQ3",16,0)
 . I $D(^RA(72,"AA",X)) S Y="" K UNDRLN D
"RTN","RADLQ3",17,0)
 .. I '$D(RALL),($Y>(IOSL-4)) S RAXIT=$$EOS^RAUTL5() Q:RAXIT  W @IOF
"RTN","RADLQ3",18,0)
 .. I '$D(RALL) S $P(UNDRLN,"-",($L(X)+1))="" W !!?10,X,!?10,UNDRLN
"RTN","RADLQ3",19,0)
 .. F  S Y=$O(^RA(72,"AA",X,Y)) Q:Y']""  D  Q:RAXIT
"RTN","RADLQ3",20,0)
 ... S Z=0 F  S Z=+$O(^RA(72,"AA",X,Y,Z)) Q:'Z  D  Q:RAXIT
"RTN","RADLQ3",21,0)
 .... S RA(0)=$G(^RA(72,Z,0)),RA(.3)=$G(^RA(72,Z,.3))
"RTN","RADLQ3",22,0)
 .... S RA(.3,15)=$P(RA(.3),"^",15)
"RTN","RADLQ3",23,0)
 .... I RA(0)]"",(RA(.3)]""),(RA(.3,15)]""),("Yy"[RA(.3,15)) D
"RTN","RADLQ3",24,0)
 ..... S RACRT(Z)=""
"RTN","RADLQ3",25,0)
 ..... I '$D(RALL),($Y>(IOSL-4)) S RAXIT=$$EOS^RAUTL5() Q:RAXIT  D
"RTN","RADLQ3",26,0)
 ...... W @IOF,!?10,X,!?10,UNDRLN
"RTN","RADLQ3",27,0)
 ...... Q
"RTN","RADLQ3",28,0)
 ..... W:'$D(RALL) !?15,$P(RA(0),"^")
"RTN","RADLQ3",29,0)
 ..... Q
"RTN","RADLQ3",30,0)
 .... Q
"RTN","RADLQ3",31,0)
 ... Q
"RTN","RADLQ3",32,0)
 .. Q
"RTN","RADLQ3",33,0)
 . Q
"RTN","RADLQ3",34,0)
 Q
"RTN","RADLQ3",35,0)
OUTPUT ; Print out the results
"RTN","RADLQ3",36,0)
 N RAEOS I $D(RAVAR(0)),(RAVAR(0)'=RAVAR) S RAEOS=6
"RTN","RADLQ3",37,0)
 E  S RAEOS=4
"RTN","RADLQ3",38,0)
 N RACN ;RA5P125 RACN overwrite
"RTN","RADLQ3",39,0)
 ; Remedy 1287775
"RTN","RADLQ3",40,0)
 F I=1:1:$L(RANODE,"^") D
"RTN","RADLQ3",41,0)
 . S @$P("RACN^RAPRC^RAST^RADT^RAWHE^RARP^RASSN^RAVRFIED^RAIPHY^RATECH","^",I)=$P(RANODE,"^",I)
"RTN","RADLQ3",42,0)
 . Q
"RTN","RADLQ3",43,0)
 I $Y>(IOSL-RAEOS) D  Q:RAXIT
"RTN","RADLQ3",44,0)
 . S RAXIT=$$EOS^RAUTL5() D:'RAXIT HDR^RADLQ2
"RTN","RADLQ3",45,0)
 . Q
"RTN","RADLQ3",46,0)
 ; 05/09/08 BAY/KAM RA*5*93 Rem Call 246868 Added RAVAR Check to next
"RTN","RADLQ3",47,0)
 ;                                          line
"RTN","RADLQ3",48,0)
 I RAEOS=6,RAVAR="O" D
"RTN","RADLQ3",49,0)
 . N RASTR S RASTR="*** OUTPATIENT ***"
"RTN","RADLQ3",50,0)
 . S RASTR(0)=$$REPEAT^XLFSTR(" ",((IOM-($L(RASTR)*3))\2))
"RTN","RADLQ3",51,0)
 . S RASTR(1)=RASTR_RASTR(0)_RASTR_RASTR(0)_RASTR
"RTN","RADLQ3",52,0)
 . W !!,RASTR(1)
"RTN","RADLQ3",53,0)
 . Q
"RTN","RADLQ3",54,0)
 ; Note: Inform the user that the following data will be for outpatients.
"RTN","RADLQ3",55,0)
 ;       Since only inpatient and outpatient is possibly stored, any
"RTN","RADLQ3",56,0)
 ;       change in the variable RAVAR will be a change to 'outpatient'.
"RTN","RADLQ3",57,0)
 ; 11/15/07 BAY/KAM RA*5*87 Rem Call 217642 Added next line
"RTN","RADLQ3",58,0)
 S RASSN=$E(RASSN,8,11)
"RTN","RADLQ3",59,0)
 I IOM=132 D  ;132 column format
"RTN","RADLQ3",60,0)
 . I $$USESSAN^RAHLRU1() D
"RTN","RADLQ3",61,0)
 .. W !,RANME,?RATAB(1),RACN,?RATAB(2)+7,RASSN,?RATAB(3),RADT,?RATAB(4)
"RTN","RADLQ3",62,0)
 .. W $E(RAWHE,1,25),?RATAB(5),RAVRFIED
"RTN","RADLQ3",63,0)
 .. W !?RATAB(6),$E(RAPRC,1,30),?RATAB(7),$E(RAST,1,30)
"RTN","RADLQ3",64,0)
 .. W ?RATAB(8),RARP,?RATAB(9),$E(RAIPHY,1,20),?RATAB(10),RATECH
"RTN","RADLQ3",65,0)
 . I '$$USESSAN^RAHLRU1() D
"RTN","RADLQ3",66,0)
 .. W !,RANME,?RATAB(1),RACN,?RATAB(2),RASSN,?RATAB(3),RADT,?RATAB(4)
"RTN","RADLQ3",67,0)
 .. W $E(RAWHE,1,25),?RATAB(5),RAVRFIED
"RTN","RADLQ3",68,0)
 .. W !?RATAB(6),$E(RAPRC,1,30),?RATAB(7),$E(RAST,1,30)
"RTN","RADLQ3",69,0)
 .. W ?RATAB(8),RARP,?RATAB(9),$E(RAIPHY,1,20),?RATAB(10),RATECH
"RTN","RADLQ3",70,0)
 . Q
"RTN","RADLQ3",71,0)
 E  D  ;default to 80 column
"RTN","RADLQ3",72,0)
 . I $$USESSAN^RAHLRU1() D
"RTN","RADLQ3",73,0)
 .. W !,$E(RANME,1,20),?RATAB(1),RACN,?RATAB(2)+7,RASSN,?RATAB(3),RADT
"RTN","RADLQ3",74,0)
 .. W ?RATAB(4),$E(RAWHE,1,15),?RATAB(5),RAVRFIED
"RTN","RADLQ3",75,0)
 .. W !?RATAB(6),$E(RAPRC,1,20),?RATAB(7),$E(RAST,1,11)
"RTN","RADLQ3",76,0)
 .. W ?RATAB(8),RARP,?RATAB(9),$E(RAIPHY,1,15),?RATAB(10),RATECH
"RTN","RADLQ3",77,0)
 . I '$$USESSAN^RAHLRU1() D
"RTN","RADLQ3",78,0)
 .. W !,$E(RANME,1,20),?RATAB(1),RACN,?RATAB(2),RASSN,?RATAB(3),RADT
"RTN","RADLQ3",79,0)
 .. W ?RATAB(4),$E(RAWHE,1,15),?RATAB(5),RAVRFIED
"RTN","RADLQ3",80,0)
 .. W !?RATAB(6),$E(RAPRC,1,20),?RATAB(7),$E(RAST,1,11)
"RTN","RADLQ3",81,0)
 .. W ?RATAB(8),RARP,?RATAB(9),$E(RAIPHY,1,15),?RATAB(10),RATECH
"RTN","RADLQ3",82,0)
 . Q
"RTN","RADLQ3",83,0)
 W !,RALN1
"RTN","RADLQ3",84,0)
 S RAVAR(0)=RAVAR ; track the patient status: inpatient -or- outpatient
"RTN","RADLQ3",85,0)
 Q
"RTN","RADLQ3",86,0)
CHECK(DUZ) ; Check for the existence of RACCESS.  Pass in user's DUZ!
"RTN","RADLQ3",87,0)
 S RAPSTX="" D SETVARS^RAPSET1(0)
"RTN","RADLQ3",88,0)
 Q
"RTN","RADLQ3",89,0)
LIST ; List divisions and I-Types
"RTN","RADLQ3",90,0)
 N A,B S A=""
"RTN","RADLQ3",91,0)
 F  S A=$O(^TMP($J,"RADLQ",A)) Q:A']""  D
"RTN","RADLQ3",92,0)
 . W !!,"Division: ",$P($G(^DIC(4,A,0)),"^"),!?3,"Imaging Type(s): "
"RTN","RADLQ3",93,0)
 . S B="" F  S B=$O(^TMP($J,"RADLQ",A,B)) Q:B']""  D  Q:RAXIT
"RTN","RADLQ3",94,0)
 .. I $Y>(IOSL-4) S RAXIT=$$EOS^RAUTL5() D:'RAXIT HDR^RADLQ2 Q:RAXIT
"RTN","RADLQ3",95,0)
 .. W:$X>(IOM-30) !?($X+$L("Imaging Type(s): ")+3) W B,?($X+3)
"RTN","RADLQ3",96,0)
 .. Q
"RTN","RADLQ3",97,0)
 . Q
"RTN","RADLQ3",98,0)
 I $Y>(IOSL-4) S RAXIT=$$EOS^RAUTL5() D:'RAXIT HDR^RADLQ2 Q:RAXIT
"RTN","RADLQ3",99,0)
 W !!?RATAB(6),"Total Over All Divisions: ",+$G(^TMP($J,"RADLQ"))
"RTN","RADLQ3",100,0)
 Q
"RTN","RADLQ3",101,0)
EXIT ; Kill and quit
"RTN","RADLQ3",102,0)
 K %DT,BEGDATE,DIROUT,DIRUT,DTOUT,DUOUT,ENDDATE,I,INVMAXDT,RA,RA1,RA2
"RTN","RADLQ3",103,0)
 K RABEG,RACN,RACNI,RACRT,RADFN,RADIV,RADIVNM,RADT,RADTE,RADTI,RAEND
"RTN","RADLQ3",104,0)
 K RAEXAM,RAFLAG,RAHD,RAHEAD,RAIPHY,RAITYPE,RALN1,RALN2,RAMES,RANME
"RTN","RADLQ3",105,0)
 K RANODE,RAPAT,RAPG,RAPOP,RAPRC,RAQUIT,RAREGEX,RARP,RASORT1,RASORT2
"RTN","RADLQ3",106,0)
 K RASSN,RAST,RASTI,RASV,RATAB,RATECH,RAVAR,RAVRFIED,RAWHE,RAXIT
"RTN","RADLQ3",107,0)
 K X,Y,ZTDESC,ZTRTN,ZTSAVE
"RTN","RADLQ3",108,0)
 K ^TMP($J,"RA D-TYPE"),^TMP($J,"RA I-TYPE"),^TMP($J,"RADLQ")
"RTN","RADLQ3",109,0)
 K:$D(RAPSTX) RACCESS,RAPSTX D CLOSE^RAUTL
"RTN","RADLQ3",110,0)
 K DISYS,I,POP
"RTN","RADLQ3",111,0)
 Q
"RTN","RADLQ3",112,0)
ZEROUT(SUB) ; Zero out the ^TMP($J global.
"RTN","RADLQ3",113,0)
 N X,Y,Z
"RTN","RADLQ3",114,0)
 S X="" F  S X=$O(RACCESS(DUZ,"DIV-IMG",X)) Q:X']""  D
"RTN","RADLQ3",115,0)
 . Q:'$D(^TMP($J,"RA D-TYPE",X))  S Y=0
"RTN","RADLQ3",116,0)
 . F  S Y=+$O(^TMP($J,"RA D-TYPE",X,Y)) Q:'Y  D 
"RTN","RADLQ3",117,0)
 .. S ^TMP($J,SUB,Y)=0,Z=""
"RTN","RADLQ3",118,0)
 .. F  S Z=$O(RACCESS(DUZ,"DIV-IMG",X,Z)) Q:Z']""  D
"RTN","RADLQ3",119,0)
 ... Q:'$D(^TMP($J,"RA I-TYPE",Z))  S ^TMP($J,SUB,Y,Z)=0
"RTN","RADLQ3",120,0)
 ... I SUB="RADLQ" D
"RTN","RADLQ3",121,0)
 .... S:RASORT1'="B" ^TMP($J,SUB,Y,Z,RASORT1)=0
"RTN","RADLQ3",122,0)
 .... S:RASORT1="B" ^TMP($J,SUB,Y,Z,"I")=0,^TMP($J,SUB,Y,Z,"O")=0
"RTN","RADLQ3",123,0)
 .... Q
"RTN","RADLQ3",124,0)
 ... Q
"RTN","RADLQ3",125,0)
 .. Q
"RTN","RADLQ3",126,0)
 . Q
"RTN","RADLQ3",127,0)
 Q
"RTN","RAHLR1")
0^2^B25001746^B24833741
"RTN","RAHLR1",1,0)
RAHLR1 ;HISC/GJC - Generate Common Order (ORM) Message ;11/10/99  10:42
"RTN","RAHLR1",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**47,125**;Mar 16, 1998;Build 1
"RTN","RAHLR1",3,0)
 ;Generates msg whenever a case is registered or cancelled or examined
"RTN","RAHLR1",4,0)
 ;              registered   cancelled   examined   complete
"RTN","RAHLR1",5,0)
 ; Order control : NW            CA         XO         XO
"RTN","RAHLR1",6,0)
 ; Order status  : IP            CA         IP         CM
"RTN","RAHLR1",7,0)
 ;
"RTN","RAHLR1",8,0)
 ;Integration Agreements
"RTN","RAHLR1",9,0)
 ;----------------------
"RTN","RAHLR1",10,0)
 ;$$GET1^DIQ(10060); NPFON^MAG7UFO(5021); $$FMTHL7^XLFDT(10103)
"RTN","RAHLR1",11,0)
 ;$$HLNAME^XLFNAME(3065); $$NS^XUAF4(2171); $$KSP^XUPARAM(2541)
"RTN","RAHLR1",12,0)
 ;
"RTN","RAHLR1",13,0)
 ;IA: 767 global read on ^DGSL(38.1,D0,0)
"RTN","RAHLR1",14,0)
 ;IA: 10039 global read on ^DIC(42,D0,44)
"RTN","RAHLR1",15,0)
 ;IA: 10040 global read on ^SC(D0
"RTN","RAHLR1",16,0)
 ;
"RTN","RAHLR1",17,0)
EN(RADFN,RADTI,RACNI,RAEID) ;Called from RA REG*, RA EXAMINED*, & RA CANCEL*
"RTN","RAHLR1",18,0)
 ;event driver protocols whose HL7 version exceeds version 2.3.
"RTN","RAHLR1",19,0)
 ;
"RTN","RAHLR1",20,0)
 ; Input Variables (from RAHLR):
"RTN","RAHLR1",21,0)
 ;  RADFN=file 2 IEN (DFN)
"RTN","RAHLR1",22,0)
 ;  RADTI=file 70 Exam subrec IEN (inverse date/time of exam)
"RTN","RAHLR1",23,0)
 ;  RACNI=file 70 Case subrecord IEN
"RTN","RAHLR1",24,0)
 ;  RAEID=ien of the event driver protocol (defined in RAHLRPC)
"RTN","RAHLR1",25,0)
 ;  RACN0=^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)
"RTN","RAHLR1",26,0)
 ; Output variables:
"RTN","RAHLR1",27,0)
 ;  HLA("HLS", array containing HL7 msg
"RTN","RAHLR1",28,0)
 ;
"RTN","RAHLR1",29,0)
 N RAPID,RAPV1,RAORC,RAOBR,RAOBX,RAX,X,XX,I,I1,I2,I3,II
"RTN","RAHLR1",30,0)
 ;initialize Rad/Nuc Med specific variables
"RTN","RAHLR1",31,0)
 D:'$D(HLFS)!'$D(HL) INIT^RAHLRU
"RTN","RAHLR1",32,0)
 D INIT
"RTN","RAHLR1",33,0)
 ;RA*5*82 RAEXEDT= Override the EXM conditions if Case edited
"RTN","RAHLR1",34,0)
 I '$G(RAEXEDT),$G(RAEXMDUN)=1,$P(RAZXAM,U,30)'="" Q  ;last chance to stop exm'd msg if it's already been sent
"RTN","RAHLR1",35,0)
 ;
"RTN","RAHLR1",36,0)
PID ;compile the PID segment
"RTN","RAHLR1",37,0)
 D PID^RAHLRU1(+RADFN)
"RTN","RAHLR1",38,0)
 ;
"RTN","RAHLR1",39,0)
PV1 ;compile the PV1 segment determine if the patient is
"RTN","RAHLR1",40,0)
 ;an inpatient or outpatient by looking at the exam record
"RTN","RAHLR1",41,0)
 D PV1^RAHLRU1(+RADFN)
"RTN","RAHLR1",42,0)
 ;
"RTN","RAHLR1",43,0)
ORC ;build the 'common order segment (ORC) segment
"RTN","RAHLR1",44,0)
 ;RACANC is the status of the exam 'cancelled'? If ORDER (#3) field in
"RTN","RAHLR1",45,0)
 ;the EXAMINATION STATUS (#72) file is set to zero, the exam has been
"RTN","RAHLR1",46,0)
 ;cancelled. If order is set to nine, the exam is complete.
"RTN","RAHLR1",47,0)
 S RAXAMSTS=$P($G(^RA(72,+$P(RAZXAM,U,3),0)),U,3)
"RTN","RAHLR1",48,0)
 S RACANC=$S(RAXAMSTS=0:1,1:0),RACOMP=$S(RAXAMSTS=9:1,1:0)
"RTN","RAHLR1",49,0)
 S RAORC(2)=$S(RACANC:"CA",$G(RAEXMDUN)=1:"XO",1:"NW")
"RTN","RAHLR1",50,0)
 ; define ORC-2 & ORC-3 to 'site id-mmddyy-case#' ex: 141-041106-6
"RTN","RAHLR1",51,0)
 ; 9/2008 -- check Site Acc Number division parameter (79,.131) and only
"RTN","RAHLR1",52,0)
 ; use the long site specific acc num if set to YES, else use old form
"RTN","RAHLR1",53,0)
 S (RAORC(3),RAORC(4))=RAZDAYCS
"RTN","RAHLR1",54,0)
 S RAORC(6)=$S(RACANC:"CA",RACOMP:"CM",1:"IP")
"RTN","RAHLR1",55,0)
 ;
"RTN","RAHLR1",56,0)
 ;new logic in determining the value of order status (ORC-5)
"RTN","RAHLR1",57,0)
 ;discovered in the development and testing of p47 on 01/14/2010
"RTN","RAHLR1",58,0)
 ;Variables:
"RTN","RAHLR1",59,0)
 ;  RA101Z - defined in RAHLRPC
"RTN","RAHLR1",60,0)
 ;   RAOPT - array set/killed in the entry/exit actions in options:
"RTN","RAHLR1",61,0)
 ;- [RA HL7 MESSAGE RESEND]
"RTN","RAHLR1",62,0)
 ;- [RA HL7 RESEND BY DATE RANGE]
"RTN","RAHLR1",63,0)
 ;  these two options may impact the definition of ORC-5
"RTN","RAHLR1",64,0)
 I $E($O(RAOPT("")),1,6)="RESEND",($E($G(RA101Z),1,6)="RA REG") S RAORC(6)="IP"
"RTN","RAHLR1",65,0)
 ;Executing the RA REG* event driver(s) should send an order control (ORC-1)
"RTN","RAHLR1",66,0)
 ;value of 'NW' & an order status value of 'IP' when the aforementioned options
"RTN","RAHLR1",67,0)
 ;are exercised.
"RTN","RAHLR1",68,0)
 ;
"RTN","RAHLR1",69,0)
 ;Quantity/Timing ORC-7.4 SCHEDULED DATE (TIME optional) 75.1;23
"RTN","RAHLR1",70,0)
 ;Priority ORC-7.6 REQUEST URGENCY of order 75.1;6
"RTN","RAHLR1",71,0)
 S RAORC(8)=$$REPEAT^RAHLRU1($E(HLECH,1),3)_$$FMTHL7^XLFDT($P(RAZORD,U,23))_$$REPEAT^RAHLRU1($E(HLECH,1),2)_$S($P(RAZORD,U,6)=1:"S",$P(RAZORD,U,6)=2:"A",1:"R")
"RTN","RAHLR1",72,0)
 ;Parent ORC-8 MEMBER OF SET (70.03;25); PURGED DATE (70.03,40)
"RTN","RAHLR1",73,0)
 S RAORC(9)=$$PARENT(RAPURGE,$P(RAZXAM,U,25))
"RTN","RAHLR1",74,0)
 ;Note: ORC-8 & OBR-29 share the same value
"RTN","RAHLR1",75,0)
 ;
"RTN","RAHLR1",76,0)
 ;S RAORC(10)=$$FMTHL7^XLFDT($P(RAZORD,U,16)) ;transaction d/t (order)
"RTN","RAHLR1",77,0)
 S RAORC(10)=$$FMTHL7^XLFDT($P(RAZRXAM,U)) ;transaction d/t (exam d/t registered)
"RTN","RAHLR1",78,0)
 ;
"RTN","RAHLR1",79,0)
 ;Entered By ORC-10 (USER ENTERING REQUEST) 75.1;15
"RTN","RAHLR1",80,0)
 I $P(RAZORD,U,15),($$GET1^DIQ(200,$P(RAZORD,U,15),.01)'="") D
"RTN","RAHLR1",81,0)
 .S RAZNME("FILE")=200,RAZNME("IENS")=$P(RAZORD,U,15)
"RTN","RAHLR1",82,0)
 .S RAZNME("FIELD")=.01
"RTN","RAHLR1",83,0)
 .S RAORC(11)=$P(RAZORD,U,15)_$E(HLECH)_$$HLNAME^XLFNAME(.RAZNME,"S",$E($G(HLECH)))
"RTN","RAHLR1",84,0)
 .Q
"RTN","RAHLR1",85,0)
 ;Ordering Provider ORC-12 (REQUESTING PHYSICIAN) 75.1;14
"RTN","RAHLR1",86,0)
 I $P(RAZORD,U,14),($$GET1^DIQ(200,$P(RAZORD,U,14),.01)'="") D
"RTN","RAHLR1",87,0)
 .K RAZNME S RAZNME("FILE")=200,RAZNME("IENS")=$P(RAZORD,U,14)
"RTN","RAHLR1",88,0)
 .S RAZNME("FIELD")=.01
"RTN","RAHLR1",89,0)
 .S RAORC(13)=$P(RAZORD,U,14)_$E(HLECH)_$$HLNAME^XLFNAME(.RAZNME,"S",$E($G(HLECH)))
"RTN","RAHLR1",90,0)
 .Q
"RTN","RAHLR1",91,0)
 ;Enterer's Location ORC-13 (USER ENTERING REQUEST)
"RTN","RAHLR1",92,0)
 S RASERSEC=$$ESCAPE^RAHLRU($$GET1^DIQ(200,$P(RAZORD,U,15),29))
"RTN","RAHLR1",93,0)
 S RAORC(14)=RASERSEC ;SERVICE/SECTION
"RTN","RAHLR1",94,0)
 ;
"RTN","RAHLR1",95,0)
 ;Call Back Phone numbers of Ordering Provider ORC-14
"RTN","RAHLR1",96,0)
 D
"RTN","RAHLR1",97,0)
 .N RAX,I,M S M="",I=0
"RTN","RAHLR1",98,0)
 .D NPFON^MAG7UFO("RAX",$P(RAZORD,U,14))
"RTN","RAHLR1",99,0)
 .F  S I=$O(RAX(I)) Q:'I  S M=M_$$ESCAPE^RAHLRU($G(RAX(I,1,1)))_$E(HLECH)_$G(RAX(I,2,1))_$E(HLECH)_$G(RAX(I,3,1))_$E(HLECH,2)
"RTN","RAHLR1",100,0)
 .S:$L(M) RAORC(15)=$E(M,1,$L(M)-1)
"RTN","RAHLR1",101,0)
 ;
"RTN","RAHLR1",102,0)
 ;Enterer's Organization ORC-17 (USER ENTERING REQUEST)
"RTN","RAHLR1",103,0)
 S RASERSEC(0)=+$$GET1^DIQ(200,$P(RAZORD,U,15),29,"I") ;pointer to 49
"RTN","RAHLR1",104,0)
 S RASERSEC(1)=$$GET1^DIQ(49,RASERSEC(0),1) ;abbr. of service/section
"RTN","RAHLR1",105,0)
 S RAORC(18)=RASERSEC(1)_$E(HLECH)_RASERSEC_$E(HLECH)_"VISTA49"
"RTN","RAHLR1",106,0)
 ;build the ORC segment; set the HLA array
"RTN","RAHLR1",107,0)
 D BLSEG^RAHLRU1("ORC",.RAORC)
"RTN","RAHLR1",108,0)
 K RACANC,RACOMP,RASERSEC,RAXAMSTS,RAZNME,RAZPHONE
"RTN","RAHLR1",109,0)
 ;
"RTN","RAHLR1",110,0)
 D:$T(EN^RAHLR1A)]"" EN^RAHLR1A ;continue building the OBR, OBX, & ZDS segments
"RTN","RAHLR1",111,0)
 ;
"RTN","RAHLR1",112,0)
 ; Broadcast the HL7 message and cleanup the symbol table
"RTN","RAHLR1",113,0)
 D GENERATE^RAHLRU
"RTN","RAHLR1",114,0)
 Q
"RTN","RAHLR1",115,0)
 ;
"RTN","RAHLR1",116,0)
INIT ;initialize some basic package specific variables
"RTN","RAHLR1",117,0)
 S:'($D(U)#2) U="^"
"RTN","RAHLR1",118,0)
 S RAZRXAM=$G(^RADPT(RADFN,"DT",RADTI,0)) ;reg. exam zero node
"RTN","RAHLR1",119,0)
 S RAZXAM=$G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)) ;exam zero node
"RTN","RAHLR1",120,0)
 S RAPURGE=+$G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,"PURGE"))
"RTN","RAHLR1",121,0)
 S RAZDTE=9999999.9999-RADTI ;FM internal date/time
"RTN","RAHLR1",122,0)
 ; Check if SSAN exists for the exam:
"RTN","RAHLR1",123,0)
 ;     Field:  [^DD(70.03,31,0)=SITE ACCESSION NUMBER^RFI^^0;31]
"RTN","RAHLR1",124,0)
 ; This check should NOT be dependent on the current state of the
"RTN","RAHLR1",125,0)
 ; SSAN Switch (ON or OFF), don't build RAZDAYCS on the fly, use the
"RTN","RAHLR1",126,0)
 ; data stored in the exam (legacy accession number or SSAN)
"RTN","RAHLR1",127,0)
 ; if SSAN          exists set RAZDAYCS=SSAN
"RTN","RAHLR1",128,0)
 ; if SSAN does not exist  set RAZDAYCS=legacy accession number 
"RTN","RAHLR1",129,0)
 I $P(RAZXAM,"^",31)="" S RAZDAYCS=$E(RAZDTE,4,7)_$E(RAZDTE,2,3)_"-"_+RAZXAM ;Legacy Accession Number:  mmddyy-case#
"RTN","RAHLR1",130,0)
 I $P(RAZXAM,"^",31)'="" S RAZDAYCS=$P(RAZXAM,"^",31) ;SSAN: sss-mmddyy-case#
"RTN","RAHLR1",131,0)
 ;
"RTN","RAHLR1",132,0)
 S RAZORD=$G(^RAO(75.1,+$P(RAZXAM,U,11),0)) ;rad/nuc med order zero node
"RTN","RAHLR1",133,0)
 S RAZORD1=$P($G(^RAO(75.1,+$P(RAZXAM,U,11),.1)),U) ;rad/nuc  reason for study
"RTN","RAHLR1",134,0)
 S RAZPROC=$G(^RAMIS(71,+$P(RAZXAM,U,2),0)) ;exam specific procedure
"RTN","RAHLR1",135,0)
 Q
"RTN","RAHLR1",136,0)
 ;
"RTN","RAHLR1",137,0)
PARENT(PRGE,PRNT) ;Define fields ORC-8 & OBR-29 known as PARENT
"RTN","RAHLR1",138,0)
 ; input: PRGE=purge date of the exam (if applicable)
"RTN","RAHLR1",139,0)
 ;        PRNT=parent/descendant if yes, specify if exam or printset
"RTN","RAHLR1",140,0)
 ;return: VALUE=ORIGINAL ORDER PURGED if purged, EXAMSET: proc_name
"RTN","RAHLR1",141,0)
 ;        if examset, PRINTSET: proc_name if printset, or null.
"RTN","RAHLR1",142,0)
 N VALUE ;RA5P125
"RTN","RAHLR1",143,0)
 I PRGE,(PRGE'>DT) S VALUE="ORIGINAL ORDER PURGED"
"RTN","RAHLR1",144,0)
 I PRNT S VALUE=$S(PRNT=1:"Examset: ",1:"Printset: ")_$P($G(^RAMIS(71,+$P(RAZORD,U,2),0)),U)
"RTN","RAHLR1",145,0)
 Q $G(VALUE)
"RTN","RAHLR1",146,0)
 ;
"RTN","RAHLRU")
0^4^B50865830^B44912236
"RTN","RAHLRU",1,0)
RAHLRU ;HISC/GJC - utilities for HL7 messaging ;03/16/98  11:03
"RTN","RAHLRU",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**10,25,81,103,47,125**;Mar 16, 1998;Build 1
"RTN","RAHLRU",3,0)
 ;
"RTN","RAHLRU",4,0)
 ; 08/13/2010 BP/KAM RA*5*103 Outside Report Status Code needs 'F'
"RTN","RAHLRU",5,0)
 ;Integration Agreements
"RTN","RAHLRU",6,0)
 ;----------------------
"RTN","RAHLRU",7,0)
 ;$$GET1^DIQ(2056); $$HLDATE^HLFNC(10106); INIT^HLFNC2(2161)
"RTN","RAHLRU",8,0)
 ;GENERATE^HLMA(2164); $$NOW^XLFDT(10103); $$PATCH^XPDUTL(10141)
"RTN","RAHLRU",9,0)
 ;$$VERSION^XPDUTL(10141)
"RTN","RAHLRU",10,0)
 ;
"RTN","RAHLRU",11,0)
 ;IA:  global read .01 field, file ^HL(771,
"RTN","RAHLRU",12,0)
 ;IA:  global read .01 field, file ^HL(771.2,
"RTN","RAHLRU",13,0)
 ;IA:  global read .01 field, file ^HL(771.5,
"RTN","RAHLRU",14,0)
 ;IA:  global read .01 field, file ^HL(779.001,
"RTN","RAHLRU",15,0)
 ;
"RTN","RAHLRU",16,0)
OBX11 ; set OBX-11, = 12th piece of string where piece 1 is "OBX"
"RTN","RAHLRU",17,0)
 N RARPTIEN,Y
"RTN","RAHLRU",18,0)
 S RARPTIEN=+$G(RARPT)
"RTN","RAHLRU",19,0)
 S Y=$P($G(^RARPT(RARPTIEN,0)),U,5)
"RTN","RAHLRU",20,0)
 ; 08/13/2010 BP/KAM RA*5*103 Remedy Call 363538 Changed next line to
"RTN","RAHLRU",21,0)
 ;                                               test for 'EF' or 'V'
"RTN","RAHLRU",22,0)
 ;S $P(HLA("HLS",RAN),HLFS,12)=$S(Y="R":"P",Y="V":"F",1:"I")
"RTN","RAHLRU",23,0)
 S $P(HLA("HLS",RAN),HLFS,12)=$S(Y="R":"P",(Y="V")!(Y="EF"):"F",1:"I")
"RTN","RAHLRU",24,0)
 ; END *103 CHANGE
"RTN","RAHLRU",25,0)
 I $D(^RARPT(RARPTIEN,"ERR")) D  Q
"RTN","RAHLRU",26,0)
 .S $P(HLA("HLS",RAN),HLFS,12)="C"
"RTN","RAHLRU",27,0)
 Q
"RTN","RAHLRU",28,0)
 ;
"RTN","RAHLRU",29,0)
ESCAPE(XDTA) ;apply the appropriate escape sequence to a string of data
"RTN","RAHLRU",30,0)
 ; Insert a escape sequence place holder, then swap the escape sequence
"RTN","RAHLRU",31,0)
 ; place holder with the real escape sequence. This action requires two
"RTN","RAHLRU",32,0)
 ; passes because the escape sequence uses the escape ("\") character.
"RTN","RAHLRU",33,0)
 ; Input:  XDTA=data string to be escaped (if necessary)
"RTN","RAHLRU",34,0)
 ;         HLFS=field separator     (global scope; set in INIT^RAHLR)
"RTN","RAHLRU",35,0)
 ;        HLECH=encoding characters (global scope; set in INIT^RAHLR)
"RTN","RAHLRU",36,0)
 ; Return: XDTA=an escaped data string
"RTN","RAHLRU",37,0)
 ;
"RTN","RAHLRU",38,0)
 N UFS,UCS,URS,UEC,USS ;field, component, repetition, escape, & subcomponent
"RTN","RAHLRU",39,0)
 S UFS=HLFS,UCS=$E(HLECH),URS=$E(HLECH,2),UEC=$E(HLECH,3),USS=$E(HLECH,4)
"RTN","RAHLRU",40,0)
 F  Q:XDTA'[UFS  S XDTA=$P(XDTA,UFS)_$C(1)_$P(XDTA,UFS,2,999)
"RTN","RAHLRU",41,0)
 F  Q:XDTA'[UCS  S XDTA=$P(XDTA,UCS)_$C(2)_$P(XDTA,UCS,2,999)
"RTN","RAHLRU",42,0)
 F  Q:XDTA'[URS  S XDTA=$P(XDTA,URS)_$C(3)_$P(XDTA,URS,2,999)
"RTN","RAHLRU",43,0)
 F  Q:XDTA'[UEC  S XDTA=$P(XDTA,UEC)_$C(4)_$P(XDTA,UEC,2,999)
"RTN","RAHLRU",44,0)
 F  Q:XDTA'[USS  S XDTA=$P(XDTA,USS)_$C(5)_$P(XDTA,USS,2,999)
"RTN","RAHLRU",45,0)
 F  Q:XDTA'[$C(1)  S XDTA=$P(XDTA,$C(1))_UEC_"F"_UEC_$P(XDTA,$C(1),2,999)
"RTN","RAHLRU",46,0)
 F  Q:XDTA'[$C(2)  S XDTA=$P(XDTA,$C(2))_UEC_"S"_UEC_$P(XDTA,$C(2),2,999)
"RTN","RAHLRU",47,0)
 F  Q:XDTA'[$C(3)  S XDTA=$P(XDTA,$C(3))_UEC_"R"_UEC_$P(XDTA,$C(3),2,999)
"RTN","RAHLRU",48,0)
 F  Q:XDTA'[$C(4)  S XDTA=$P(XDTA,$C(4))_UEC_"E"_UEC_$P(XDTA,$C(4),2,999)
"RTN","RAHLRU",49,0)
 F  Q:XDTA'[$C(5)  S XDTA=$P(XDTA,$C(5))_UEC_"T"_UEC_$P(XDTA,$C(5),2,999)
"RTN","RAHLRU",50,0)
 Q XDTA
"RTN","RAHLRU",51,0)
 ;
"RTN","RAHLRU",52,0)
OBXPRC ;Compile 'OBX' Segment for Procedure
"RTN","RAHLRU",53,0)
 S HLA("HLS",RAN)="OBX"_HLFS_HLFS_"CE"_HLFS_"P"_$E(HLECH)_"PROCEDURE"_$E(HLECH)_"L"_HLFS_HLFS_$P(RACN0,"^",2)
"RTN","RAHLRU",54,0)
 S X=$S($D(^RAMIS(71,+$P(RACN0,"^",2),0)):$P(^(0),"^"),1:""),HLA("HLS",RAN)=HLA("HLS",RAN)_$E(HLECH)_X_$E(HLECH)_"L" D OBX11
"RTN","RAHLRU",55,0)
 ; Replace above with following when Imaging can cope with ESC chars
"RTN","RAHLRU",56,0)
 ; S X=$S($D(^RAMIS(71,+$P(RACN0,"^",2),0)):$P(^(0),"^"),1:""),HLA("HLS",RAN)=HLA("HLS",RAN)_$E(HLECH)_$$ESCAPE(X)_$E(HLECH)_"L" D OBX11
"RTN","RAHLRU",57,0)
 Q
"RTN","RAHLRU",58,0)
OBXMOD ; Compile 'OBX' segments for both types of modifiers
"RTN","RAHLRU",59,0)
 ; Procedure modifiers
"RTN","RAHLRU",60,0)
 N X3
"RTN","RAHLRU",61,0)
 D MODS^RAUTL2 S HLA("HLS",RAN)="OBX"_HLFS_HLFS_"TX"_HLFS_"M"_$E(HLECH)_"MODIFIERS"_$E(HLECH)_"L"_HLFS_HLFS_Y D OBX11
"RTN","RAHLRU",62,0)
 Q:Y(1)="None"
"RTN","RAHLRU",63,0)
 ; CPT Modifiers
"RTN","RAHLRU",64,0)
 F RAI=1:1 S X0=$P(Y(1),", ",RAI),X1=$P(Y(2),", ",RAI) Q:X0=""  D
"RTN","RAHLRU",65,0)
 . S RAN=RAN+1
"RTN","RAHLRU",66,0)
 . S X3=$$BASICMOD^RACPTMSC(X1,DT)
"RTN","RAHLRU",67,0)
 . S HLA("HLS",RAN)="OBX"_HLFS_HLFS_"CE"_HLFS_"C4"_$E(HLECH)_"CPT MODIFIERS"_$E(HLECH)_"C4"_HLFS_HLFS_X0_$E(HLECH)_$P(X3,"^",3)_$E(HLECH)_"C4"
"RTN","RAHLRU",68,0)
 . ; Replace above with following when Imaging can cope with ESC chars
"RTN","RAHLRU",69,0)
 . ;S HLA("HLS",RAN)="OBX"_HLFS_HLFS_"CE"_HLFS_"C4"_$E(HLECH)_"CPT MODIFIERS"_$E(HLECH)_"C4"_HLFS_HLFS_X0_$E(HLECH)_$$ESCAPE($P(X3,"^",3))_$E(HLECH)_"C4"
"RTN","RAHLRU",70,0)
 . I $P(X3,"^",4)]"" S HLA("HLS",RAN)=HLA("HLS",RAN)_$E(HLECH)_$P(X3,"^",4)_$E(HLECH)_$P(X3,"^",3)_$E(HLECH)_"C4"
"RTN","RAHLRU",71,0)
 . ; Replace above with following when Imaging can cope with ESC chars
"RTN","RAHLRU",72,0)
 . ;I $P(X3,"^",4)]"" S HLA("HLS",RAN)=HLA("HLS",RAN)_$E(HLECH)_$P(X3,"^",4)_$E(HLECH)_$$ESCAPE($P(X3,"^",3))_$E(HLECH)_"C4"
"RTN","RAHLRU",73,0)
 . D OBX11
"RTN","RAHLRU",74,0)
 . Q
"RTN","RAHLRU",75,0)
 Q
"RTN","RAHLRU",76,0)
 ;
"RTN","RAHLRU",77,0)
OBXTCM ; Compile 'OBX' segment for latest TECH COMMENT
"RTN","RAHLRU",78,0)
 ;
"RTN","RAHLRU",79,0)
 ; Only Released version of Imaging 2.5 able to handle Tech Comments
"RTN","RAHLRU",80,0)
 Q:'($$PATCH^XPDUTL("MAG*2.5*1")!(+$$VERSION^XPDUTL("MAG")>2.5))
"RTN","RAHLRU",81,0)
 ;
"RTN","RAHLRU",82,0)
 N X4,X3
"RTN","RAHLRU",83,0)
 S X4=$$GETTCOM^RAUTL11(RADFN,RADTI,RACNI)
"RTN","RAHLRU",84,0)
 Q:X4=""
"RTN","RAHLRU",85,0)
 S RAN=RAN+1
"RTN","RAHLRU",86,0)
 S HLA("HLS",RAN)="OBX"_HLFS_HLFS_"TX"_HLFS_"TCM"_$E(HLECH)_"TECH COMMENT"_$E(HLECH)_"L"_HLFS_HLFS
"RTN","RAHLRU",87,0)
 D OBX11
"RTN","RAHLRU",88,0)
 I $L(X4)+$L(HLA("HLS",RAN))'>245 D  Q
"RTN","RAHLRU",89,0)
 .S $P(HLA("HLS",RAN),HLFS,6)=X4
"RTN","RAHLRU",90,0)
 ;
"RTN","RAHLRU",91,0)
 ; If Tech Comment is v. long it will need to be
"RTN","RAHLRU",92,0)
 ; split into two parts. Do not split words if possible....
"RTN","RAHLRU",93,0)
 ;
"RTN","RAHLRU",94,0)
 S X3=$E(X4,1,245-$L(HLA("HLS",RAN)))
"RTN","RAHLRU",95,0)
 I $L(X3," ")>1 S X3=$P(X3," ",1,$L(X3," ")-1)
"RTN","RAHLRU",96,0)
 S X4=$P(X4,X3,2)
"RTN","RAHLRU",97,0)
 S $P(HLA("HLS",RAN),HLFS,6)=X3
"RTN","RAHLRU",98,0)
 S HLA("HLS",RAN,1)=X4_HLFS_$P(HLA("HLS",RAN),HLFS,7,12)
"RTN","RAHLRU",99,0)
 S HLA("HLS",RAN)=$P(HLA("HLS",RAN),HLFS,1,6)
"RTN","RAHLRU",100,0)
 Q
"RTN","RAHLRU",101,0)
 ;
"RTN","RAHLRU",102,0)
INIT ; initialize HL7 variables; called from RAHLR & RAHLRPT
"RTN","RAHLRU",103,0)
 Q:'$G(RAEID)  ;undefined server application
"RTN","RAHLRU",104,0)
 S HLDT=$$NOW^XLFDT(),HLDT1=$$HLDATE^HLFNC(HLDT),EID=RAEID
"RTN","RAHLRU",105,0)
 S HL="HLS(""HLS"")",INT=1
"RTN","RAHLRU",106,0)
 D INIT^HLFNC2(EID,.HL,INT)
"RTN","RAHLRU",107,0)
 Q:'$D(HL("Q"))  ;improperly defined server application
"RTN","RAHLRU",108,0)
 S HLQ=HL("Q"),HLFS=HL("FS"),HLECH=HL("ECH") K EID,INT
"RTN","RAHLRU",109,0)
 S HLCS=$E(HL("ECH"))
"RTN","RAHLRU",110,0)
 S HLSCS=$E(HL("ECH"),4)
"RTN","RAHLRU",111,0)
 S HLREP=$E(HL("ECH"),2)
"RTN","RAHLRU",112,0)
 Q
"RTN","RAHLRU",113,0)
 ;
"RTN","RAHLRU",114,0)
DOB(X) ;strip off trailing "0"'s from the date of birth
"RTN","RAHLRU",115,0)
 I $E(X,5,6)="00" S X=$E(X,1,4) ;if no month then no day, return year
"RTN","RAHLRU",116,0)
 E  I $E(X,7,8)="00" S X=$E(X,1,6) ;if month & no day, return month/year
"RTN","RAHLRU",117,0)
 Q X
"RTN","RAHLRU",118,0)
 ;
"RTN","RAHLRU",119,0)
CPTMOD(RAIEN,HLECH,DT) ;return OBX-5 as it pertains to CPT Modifiers
"RTN","RAHLRU",120,0)
 ;called from: RAHLRPT2 & RAHLR1A
"RTN","RAHLRU",121,0)
 ;input: RAIEN=IEN of the record in file 81.3
"RTN","RAHLRU",122,0)
 ;       HLECH=HL7 encoding characters
"RTN","RAHLRU",123,0)
 ;          DT=today's date
"RTN","RAHLRU",124,0)
 N X S X=$$BASICMOD^RACPTMSC(RAIEN,DT)
"RTN","RAHLRU",125,0)
 ;1st piece=IEN #81.3; 3rd piece=versioned name; 5th piece=coding sys
"RTN","RAHLRU",126,0)
 ;Q RAIEN_$E(HLECH,1)_$$ESCAPE^RAHLRU($P(X,U,3))_$E(HLECH,1)_$P(X,U,5)
"RTN","RAHLRU",127,0)
 ;9/5/08 the above line changed to below per IMAGING
"RTN","RAHLRU",128,0)
 Q $P(X,U,2)_$E(HLECH,1)_$$ESCAPE^RAHLRU($P(X,U,3))_$E(HLECH,1)_"C4"
"RTN","RAHLRU",129,0)
 ;
"RTN","RAHLRU",130,0)
GETSFLAG(SAN,MTN,ETN,VER) ;Return HL message flag (79.721,1)
"RTN","RAHLRU",131,0)
 Q:'$L(SAN)!'$L(MTN)!'$L(ETN)!'$L(VER) 0
"RTN","RAHLRU",132,0)
 S SAN=$O(^HL(771,"B",SAN,0)) Q:'SAN 0
"RTN","RAHLRU",133,0)
 S MTN=$O(^HL(771.2,"B",MTN,0)) Q:'MTN 0
"RTN","RAHLRU",134,0)
 S ETN=$O(^HL(779.001,"B",ETN,0)) Q:'ETN 0
"RTN","RAHLRU",135,0)
 S VER=$O(^HL(771.5,"B",VER,0)) Q:'VER 0
"RTN","RAHLRU",136,0)
 Q +$P($G(^RA(79.7,SAN,1,MTN,1,ETN,1,VER,0)),U,2)
"RTN","RAHLRU",137,0)
 ;
"RTN","RAHLRU",138,0)
OBR21(HLECH,RA7002) ;builds the OBR-21 field; called from RAHLR1A
"RTN","RAHLRU",139,0)
 ;Input
"RTN","RAHLRU",140,0)
 ;  HLECH=encoding characters (required for $$ESCAPE^RAHLRU)
"RTN","RAHLRU",141,0)
 ; RA7002=zero node of the REGISTERED EXAMS sub-file of the RAD/NUC MED
"RTN","RAHLRU",142,0)
 ;        PATIENT (#70) file.
"RTN","RAHLRU",143,0)
 ;Return:
"RTN","RAHLRU",144,0)
 ; Component one (derived from file #79.2)
"RTN","RAHLRU",145,0)
 ;   ABBREVIATION(#3)_NAME(#.01)
"RTN","RAHLRU",146,0)
 ; Component two (derived from file #79.1)
"RTN","RAHLRU",147,0)
 ;   File 79.1 IEN_NAME(#.01) of the HOSPITAL LOCATION(#44) record.
"RTN","RAHLRU",148,0)
 ; Component three (derived from file #79)
"RTN","RAHLRU",149,0)
 ;   DIVISION(#.01)_NAME(#.01) of the INSTITUTION(#4) record.
"RTN","RAHLRU",150,0)
 ;
"RTN","RAHLRU",151,0)
 ;Components as separated by the accent grave "`" (RAPCS); subcomponents by the
"RTN","RAHLRU",152,0)
 ;underscore "_" (RAPSS)
"RTN","RAHLRU",153,0)
 ;
"RTN","RAHLRU",154,0)
 ; Ex: RAD_GENERAL RADIOLOGY`1_TD-RAD`660_SALT LAKE CITY
"RTN","RAHLRU",155,0)
 ;
"RTN","RAHLRU",156,0)
 N RAX S RAPCS="`",RAPSS="_",RAX=""
"RTN","RAHLRU",157,0)
 S RA792Q=+$P(RA7002,U,2) ;imaging type pointer
"RTN","RAHLRU",158,0)
 S RA792Q(0)=$G(^RA(79.2,RA792Q,0)) ;imaging type zero node
"RTN","RAHLRU",159,0)
 ;create the i-type abbreviation, component separator, and full name string
"RTN","RAHLRU",160,0)
 S RAX=$P(RA792Q(0),U,3)_RAPSS_$P(RA792Q(0),U)
"RTN","RAHLRU",161,0)
 ;get hospital location and institution file data...
"RTN","RAHLRU",162,0)
 S RA791Q=+$P(RA7002,U,4) ;imaging location pointer
"RTN","RAHLRU",163,0)
 S RA44Q=+$P($G(^RA(79.1,RA791Q,0)),U) ;hospital location pointer
"RTN","RAHLRU",164,0)
 S RA44Q(0)=$$GET1^DIQ(44,RA44Q,.01) ;hospital location name
"RTN","RAHLRU",165,0)
 S RA4Q=+$P(RA7002,U,3) ;rad/nuc med division pointer dinum'd to INSTITUTION (#4) file
"RTN","RAHLRU",166,0)
 S RA4Q(0)=$$GET1^DIQ(4,RA4Q,.01) ;institution name
"RTN","RAHLRU",167,0)
 S RAX=RAX_RAPCS_RA791Q_RAPSS_RA44Q(0)_RAPCS_RA4Q_RAPSS_RA4Q(0)
"RTN","RAHLRU",168,0)
 K RA4Q,RA44Q,RA791Q,RA792Q,RAPCS,RAPSS
"RTN","RAHLRU",169,0)
 Q $$ESCAPE^RAHLRU(RAX)
"RTN","RAHLRU",170,0)
 ;
"RTN","RAHLRU",171,0)
BLDHLP ;build the HLP("EXCLUDE SUBSCRIBER",n) array
"RTN","RAHLRU",172,0)
 ; is HLP("EXCLUDE SUBSCRIBER",n) defined? If yes get 'n'
"RTN","RAHLRU",173,0)
 N RAX,RAY S RAX="EXCLUDE SUBSCRIBER"
"RTN","RAHLRU",174,0)
 S RAY=$$HLPEXSUB(.HLP)
"RTN","RAHLRU",175,0)
 I RAY="" M HLP(RAX)=RASSS(RAX) Q
"RTN","RAHLRU",176,0)
 N RAI S RAI=0
"RTN","RAHLRU",177,0)
 F  S RAI=$O(RASSS(RAX,RAI)) Q:RAI'>0  D
"RTN","RAHLRU",178,0)
 .S RAY=RAY+1,HLP(RAX,RAY)=RASSS(RAX,RAI)
"RTN","RAHLRU",179,0)
 .Q
"RTN","RAHLRU",180,0)
 Q
"RTN","RAHLRU",181,0)
 ;
"RTN","RAHLRU",182,0)
HLPEXSUB(A) ;determine the last subscript (n) of a local array
"RTN","RAHLRU",183,0)
 ;whose format is: A("EXCLUDE SUBSCRIBER",n)
"RTN","RAHLRU",184,0)
 ;Input: A = local array name;
"RTN","RAHLRU",185,0)
 Q $O(A("EXCLUDE SUBSCRIBER",$C(32)),-1)
"RTN","RAHLRU",186,0)
 ;
"RTN","RAHLRU",187,0)
GENERATE ;Broadcast the HL7 message (courtesy of the VistA HL7 application)
"RTN","RAHLRU",188,0)
 N HLEID,HLARYTYP,HLFORMAT,HLMTIEN,HLP
"RTN","RAHLRU",189,0)
 S HLEID=RAEID,HLARYTYP="LM",HLFORMAT=1,HLMTIEN="",HLP("PRIORITY")="I"
"RTN","RAHLRU",190,0)
 ;
"RTN","RAHLRU",191,0)
 ;1 - RASSSX is set by the 'Resend Radiology HL7 Messages By Date Range'
"RTN","RAHLRU",192,0)
 ;    option. GETHLP sets the HLP("EXCLUDE SUBSCRIBER" array
"RTN","RAHLRU",193,0)
 D:$D(RASSSX(HLEID)) GETHLP^RAHLRS1(HLEID,.HLP,"RASSSX") ;RA5P125
"RTN","RAHLRU",194,0)
 ;
"RTN","RAHLRU",195,0)
 ;2 - Do we return this HL7 message to the application that broadcasted
"RTN","RAHLRU",196,0)
 ;    it? The following code also sets the HLP("EXCLUDE SUBSCRIBER" array
"RTN","RAHLRU",197,0)
 D:$D(RASSS("EXCLUDE SUBSCRIBER"))\10 BLDHLP ;RA5P125
"RTN","RAHLRU",198,0)
 ;
"RTN","RAHLRU",199,0)
 ;Note: Events 1 & 2 are independent of one another. They will never
"RTN","RAHLRU",200,0)
 ;      set the HLP array in the same process.
"RTN","RAHLRU",201,0)
 ;
"RTN","RAHLRU",202,0)
 D GENERATE^HLMA(RAEID,HLARYTYP,HLFORMAT,.HLRESLT,HLMTIEN,.HLP)
"RTN","RAHLRU",203,0)
 D GSTATUS^RAHLACK(.HLRESLT,RAEID) K HLRESLT
"RTN","RAHLRU",204,0)
 ;
"RTN","RAHLRU",205,0)
EXIT ;kill the variables; exit the process...
"RTN","RAHLRU",206,0)
 K HL771RF,HL771SF,HL7STRG,HLA,HLARYTYP,HLCS,HLDOM,HLECH,HLEID,HLES,HLES2,HLFORMAT
"RTN","RAHLRU",207,0)
 K HLFS,HLINSTN,HLMTIEN,HLN,HLP,HLPARAM,HLPID,HLQ,HLREC,HLREP,HLRFREQ,HLSAN,HLSCS
"RTN","RAHLRU",208,0)
 K HLSFREQ,HLTYPE,HLX,OCXSEG,OCXTSPI,RAOBR,RAORC,RAPID,RAPURGE,RAPV1,RAREFDOC,RAZCPT
"RTN","RAHLRU",209,0)
 K RAZDAYCS,RAZDTE,RAZMODE,RAZNME,RAZORD,RAZORD1,RAZPHONE,RAZPMOD,RAZPREG,RAZPROC
"RTN","RAHLRU",210,0)
 K RAZRPT,RAZRXAM,RAZTRANS,RAZXAM,HLRESLT
"RTN","RAHLRU",211,0)
 K ^UTILITY($J,"W") ;note HLCS, HLREP, & HLSCS are set in INIT^RAHLRU
"RTN","RAHLRU",212,0)
 Q
"RTN","RAHLRU",213,0)
 ;
"VER")
8.0^22.0
"BLD",9327,6)
^112
**END**
**END**

