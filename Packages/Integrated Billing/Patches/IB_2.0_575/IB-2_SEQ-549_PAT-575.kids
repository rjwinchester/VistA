Released IB*2*575 SEQ #549
Extracted from mail message
**KIDS**:IB*2.0*575^

**INSTALL NAME**
IB*2.0*575
"BLD",10339,0)
IB*2.0*575^INTEGRATED BILLING^0^3170330^y
"BLD",10339,1,0)
^^6^6^3170327^
"BLD",10339,1,1,0)
ECME won't submit a claim with a Service-Connected (SC) issue, even
"BLD",10339,1,2,0)
after the user indicates that the issue has been resolved.  Same 
"BLD",10339,1,3,0)
issue is reset again and again, with RNB (Reason Not Billed) 
"BLD",10339,1,4,0)
message of "Needs SC Determination".  This occurs with any of the 
"BLD",10339,1,5,0)
possible SC conditions. This patch corrects this issue, and also 
"BLD",10339,1,6,0)
updates line 3 with the newer VA Directive reference.
"BLD",10339,4,0)
^9.64PA^^
"BLD",10339,6.3)
1
"BLD",10339,"ABPKG")
n
"BLD",10339,"KRN",0)
^9.67PA^779.2^20
"BLD",10339,"KRN",.4,0)
.4
"BLD",10339,"KRN",.401,0)
.401
"BLD",10339,"KRN",.402,0)
.402
"BLD",10339,"KRN",.403,0)
.403
"BLD",10339,"KRN",.5,0)
.5
"BLD",10339,"KRN",.84,0)
.84
"BLD",10339,"KRN",3.6,0)
3.6
"BLD",10339,"KRN",3.8,0)
3.8
"BLD",10339,"KRN",9.2,0)
9.2
"BLD",10339,"KRN",9.8,0)
9.8
"BLD",10339,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",10339,"KRN",9.8,"NM",1,0)
IBNCPBB^^0^B95799702
"BLD",10339,"KRN",9.8,"NM","B","IBNCPBB",1)

"BLD",10339,"KRN",19,0)
19
"BLD",10339,"KRN",19.1,0)
19.1
"BLD",10339,"KRN",101,0)
101
"BLD",10339,"KRN",409.61,0)
409.61
"BLD",10339,"KRN",771,0)
771
"BLD",10339,"KRN",779.2,0)
779.2
"BLD",10339,"KRN",870,0)
870
"BLD",10339,"KRN",8989.51,0)
8989.51
"BLD",10339,"KRN",8989.52,0)
8989.52
"BLD",10339,"KRN",8994,0)
8994
"BLD",10339,"KRN","B",.4,.4)

"BLD",10339,"KRN","B",.401,.401)

"BLD",10339,"KRN","B",.402,.402)

"BLD",10339,"KRN","B",.403,.403)

"BLD",10339,"KRN","B",.5,.5)

"BLD",10339,"KRN","B",.84,.84)

"BLD",10339,"KRN","B",3.6,3.6)

"BLD",10339,"KRN","B",3.8,3.8)

"BLD",10339,"KRN","B",9.2,9.2)

"BLD",10339,"KRN","B",9.8,9.8)

"BLD",10339,"KRN","B",19,19)

"BLD",10339,"KRN","B",19.1,19.1)

"BLD",10339,"KRN","B",101,101)

"BLD",10339,"KRN","B",409.61,409.61)

"BLD",10339,"KRN","B",771,771)

"BLD",10339,"KRN","B",779.2,779.2)

"BLD",10339,"KRN","B",870,870)

"BLD",10339,"KRN","B",8989.51,8989.51)

"BLD",10339,"KRN","B",8989.52,8989.52)

"BLD",10339,"KRN","B",8994,8994)

"BLD",10339,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",10339,"QUES",0)
^9.62^^
"BLD",10339,"REQB",0)
^9.611^1^1
"BLD",10339,"REQB",1,0)
IB*2.0*435^2
"BLD",10339,"REQB","B","IB*2.0*435",1)

"MBREQ")
0
"PKG",200,-1)
1^1
"PKG",200,0)
INTEGRATED BILLING^IB^INTEGRATED BILLING
"PKG",200,20,0)
^9.402P^1^1
"PKG",200,20,1,0)
2^^IBAXDR
"PKG",200,20,1,1)

"PKG",200,20,"B",2,1)

"PKG",200,22,0)
^9.49I^1^1
"PKG",200,22,1,0)
2.0^2940321^2990406^2447
"PKG",200,22,1,"PAH",1,0)
575^3170330
"PKG",200,22,1,"PAH",1,1,0)
^^6^6^3170330
"PKG",200,22,1,"PAH",1,1,1,0)
ECME won't submit a claim with a Service-Connected (SC) issue, even
"PKG",200,22,1,"PAH",1,1,2,0)
after the user indicates that the issue has been resolved.  Same 
"PKG",200,22,1,"PAH",1,1,3,0)
issue is reset again and again, with RNB (Reason Not Billed) 
"PKG",200,22,1,"PAH",1,1,4,0)
message of "Needs SC Determination".  This occurs with any of the 
"PKG",200,22,1,"PAH",1,1,5,0)
possible SC conditions. This patch corrects this issue, and also 
"PKG",200,22,1,"PAH",1,1,6,0)
updates line 3 with the newer VA Directive reference.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","IBNCPBB")
0^1^B95799702^B95588054
"RTN","IBNCPBB",1,0)
IBNCPBB ;DALOI/AAT - ECME BACKBILLING ;24-JUN-2003
"RTN","IBNCPBB",2,0)
 ;;2.0;INTEGRATED BILLING;**276,347,384,435,575**;21-MAR-94;Build 1
"RTN","IBNCPBB",3,0)
 ;;Per VA Directive 6402, this routine should not be modified.
"RTN","IBNCPBB",4,0)
 ;
"RTN","IBNCPBB",5,0)
 ; Reference to file #9002313.29 supported by IA# 4222
"RTN","IBNCPBB",6,0)
 ; Reference to DIC^PSODI supported by IA# 4858
"RTN","IBNCPBB",7,0)
 ;
"RTN","IBNCPBB",8,0)
 Q
"RTN","IBNCPBB",9,0)
EN ;[IB GENERATE ECME RX BILLS] entry
"RTN","IBNCPBB",10,0)
 N IBMOD1,IBMOD3,IBPAT,IBRX,IBBDT,IBEDT,IBSEL,IBREF,IBPAUSE
"RTN","IBNCPBB",11,0)
 S IBREF=$NA(^TMP($J,"IBNCPBB"))
"RTN","IBNCPBB",12,0)
 S IBPAUSE=1
"RTN","IBNCPBB",13,0)
 K @IBREF D
"RTN","IBNCPBB",14,0)
 . N IBEXIT
"RTN","IBNCPBB",15,0)
 . S IBEXIT=0
"RTN","IBNCPBB",16,0)
 . D MODE I IBEXIT Q
"RTN","IBNCPBB",17,0)
 . I IBMOD1="P" D SELECT I IBEXIT Q
"RTN","IBNCPBB",18,0)
 . I IBMOD1="R" D SELECT2 I IBEXIT Q
"RTN","IBNCPBB",19,0)
 . D CONFIRM I IBEXIT Q
"RTN","IBNCPBB",20,0)
 . D PROCESS^IBNCPBB1 I IBEXIT Q
"RTN","IBNCPBB",21,0)
 I IBPAUSE W ! D PAUSE()
"RTN","IBNCPBB",22,0)
 K @IBREF
"RTN","IBNCPBB",23,0)
 Q
"RTN","IBNCPBB",24,0)
 ;
"RTN","IBNCPBB",25,0)
CT(IBTRN) ;CT ENTRY
"RTN","IBNCPBB",26,0)
 N IBDELAY,IBZ,IBRX,IBRXN,IBFIL,IBEXIT,IBPAT,IBRDT,IBFDT,IBRES,IBBIL,IBBN,IBQ,IBSCRES,IBERR
"RTN","IBNCPBB",27,0)
 S IBQ=0
"RTN","IBNCPBB",28,0)
 D FULL^VALM1
"RTN","IBNCPBB",29,0)
 W !!,"This option sends electronic Pharmacy Claims to the Payer"
"RTN","IBNCPBB",30,0)
 S VALMBCK="R"
"RTN","IBNCPBB",31,0)
 S IBZ=$G(^IBT(356,IBTRN,0)) Q:IBZ=""
"RTN","IBNCPBB",32,0)
 S IBRX=$P(IBZ,U,8),IBFIL=$P(IBZ,U,10)
"RTN","IBNCPBB",33,0)
 I 'IBRX D  Q
"RTN","IBNCPBB",34,0)
 . W !!,"This is not a Pharmacy Claims Tracking record",*7,!
"RTN","IBNCPBB",35,0)
 . D PAUSE("Cannot submit to ECME")
"RTN","IBNCPBB",36,0)
 ;
"RTN","IBNCPBB",37,0)
 ;Release date:
"RTN","IBNCPBB",38,0)
 I IBFIL=0 S IBRDT=$$FILE^IBRXUTL(IBRX,31)
"RTN","IBNCPBB",39,0)
 E  S IBRDT=$$SUBFILE^IBRXUTL(IBRX,IBFIL,52,17)
"RTN","IBNCPBB",40,0)
 I 'IBRDT D  Q
"RTN","IBNCPBB",41,0)
 . W !!,"The Prescription is not released.",!
"RTN","IBNCPBB",42,0)
 . D PAUSE("Cannot submit to ECME")
"RTN","IBNCPBB",43,0)
 ; -- Drug DEA ROI check.
"RTN","IBNCPBB",44,0)
 S IBPAT=$P(IBZ,U,2)
"RTN","IBNCPBB",45,0)
 S IBDRUG=$$FILE^IBRXUTL(IBRX,6)
"RTN","IBNCPBB",46,0)
 ; Fill/Refill Date:
"RTN","IBNCPBB",47,0)
 S IBFDT=$S('IBFIL:$$FILE^IBRXUTL(IBRX,22),1:$$SUBFILE^IBRXUTL(IBRX,IBFIL,52,.01))
"RTN","IBNCPBB",48,0)
 I $$INSUR^IBBAPI(IBPAT,IBFDT,"P",.IBANY,1) S IBINS=+$G(IBANY("IBBAPI","INSUR",1,1)) S IBQ=$$ROICHK^IBNCPDR4(IBPAT,IBDRUG,IBINS,IBFDT) D:IBQ=1 ROICLN^IBNCPDR4(IBTRN) I 'IBQ D PAUSE() Q  ;Requires ROI
"RTN","IBNCPBB",49,0)
 ;
"RTN","IBNCPBB",50,0)
 S IBQ=0 I $$SC($P(IBZ,U,19)) D  Q:IBQ  ;575: Reset IBQ flag to 0
"RTN","IBNCPBB",51,0)
 . N DIR,DIE,DA,DR,Y
"RTN","IBNCPBB",52,0)
 . W !!,"The Rx is marked 'non-billable' in CT: ",$P($G(^IBE(356.8,+$P(IBZ,U,19),0)),U)
"RTN","IBNCPBB",53,0)
 . W !,"If you continue, the NON-BILLABLE REASON will be deleted.",!
"RTN","IBNCPBB",54,0)
 . S DIR(0)="Y",DIR("A")="Are you sure you want to bill this episode"
"RTN","IBNCPBB",55,0)
 . S DIR("B")="NO"
"RTN","IBNCPBB",56,0)
 . S DIR("?")="If you want to bill this Rx, enter 'Yes' - otherwise, enter 'No'"
"RTN","IBNCPBB",57,0)
 . W ! D ^DIR K DIR
"RTN","IBNCPBB",58,0)
 . I 'Y S IBQ=1 Q
"RTN","IBNCPBB",59,0)
 . S DIE="^IBT(356,",DA=IBTRN,DR=".19///@" D ^DIE ;clean NB reason
"RTN","IBNCPBB",60,0)
 . S IBSCRES(IBRX,IBFIL)=1 ; sc resolved flag
"RTN","IBNCPBB",61,0)
 ;
"RTN","IBNCPBB",62,0)
 S IBZ=$G(^IBT(356,IBTRN,0)) ; refresh
"RTN","IBNCPBB",63,0)
 I $P(IBZ,U,19) D  Q
"RTN","IBNCPBB",64,0)
 . W !!,"The Prescription is marked 'non-billable' in Claims Tracking",*7
"RTN","IBNCPBB",65,0)
 . W !,"Reason non-billable: ",$P($G(^IBE(356.8,+$P(IBZ,U,19),0),"Unknown"),U),!
"RTN","IBNCPBB",66,0)
 . D PAUSE("Cannot submit to ECME")
"RTN","IBNCPBB",67,0)
 ; Is the patient billable at the released date?
"RTN","IBNCPBB",68,0)
 S IBRES=$$ECMEBIL^IBNCPDPU(IBPAT,IBFDT)
"RTN","IBNCPBB",69,0)
 I 'IBRES D  Q
"RTN","IBNCPBB",70,0)
 . W !!,"The patient is not ECME Billable at the ",$S(IBFIL:"re",1:""),"fill date."
"RTN","IBNCPBB",71,0)
 . W !,"Reason: ",$P(IBRES,U,2,255),!
"RTN","IBNCPBB",72,0)
 . D PAUSE("Cannot submit to ECME")
"RTN","IBNCPBB",73,0)
 ;
"RTN","IBNCPBB",74,0)
 S IBRXN=$$FILE^IBRXUTL(IBRX,.01)
"RTN","IBNCPBB",75,0)
 S IBBIL=$$BILL(IBRXN,IBRDT)
"RTN","IBNCPBB",76,0)
 I IBBIL,'$P($G(^DGCR(399,IBBIL,"S")),U,16) D  Q
"RTN","IBNCPBB",77,0)
 . W !!,"Rx# ",IBRXN," was previously billed."
"RTN","IBNCPBB",78,0)
 . W !,"Please manually cancel the bill# ",$P($G(^DGCR(399,IBBIL,0)),U)," before submitting claim to ECME.",!
"RTN","IBNCPBB",79,0)
 . D PAUSE("Cannot submit to ECME")
"RTN","IBNCPBB",80,0)
 I IBBIL W !,"The bill# ",$P($G(^DGCR(399,IBBIL,0)),U)," has been cancelled.",!
"RTN","IBNCPBB",81,0)
 ;
"RTN","IBNCPBB",82,0)
 S IBDELAY=$$DLYRC() ; get delay reason code with optional parameter, IB*2.0*435
"RTN","IBNCPBB",83,0)
 ;
"RTN","IBNCPBB",84,0)
 D CONFRX(IBRXN) Q:$G(IBEXIT)
"RTN","IBNCPBB",85,0)
 ;
"RTN","IBNCPBB",86,0)
 W !!,"Submitting Rx# ",IBRXN W:IBFIL ", Refill# ",IBFIL W " ..."
"RTN","IBNCPBB",87,0)
 S IBRES=$$SUBMIT^IBNCPDPU(IBRX,IBFIL,IBDELAY) W !,"  ",$S(+IBRES=0:"S",1:"Not s")_"ent through ECME."
"RTN","IBNCPBB",88,0)
 I +IBRES'=0 W !,"  *** ECME returned status: ",$$STAT(IBRES),!
"RTN","IBNCPBB",89,0)
 I +IBRES=0 W !!,"The Rx have been submitted to ECME for electronic billing",!
"RTN","IBNCPBB",90,0)
 D PAUSE()
"RTN","IBNCPBB",91,0)
 Q
"RTN","IBNCPBB",92,0)
 ;
"RTN","IBNCPBB",93,0)
MODE ;
"RTN","IBNCPBB",94,0)
 ; IBMOD1: "P"-Single Patient, "R"-Single Rx
"RTN","IBNCPBB",95,0)
 ; IBMOD3 (if IBMOD1="P"): "U"-Unbilled, "A"-All Rx
"RTN","IBNCPBB",96,0)
 ; IBPAT (if IBMOD1="P"): Patient's DFN
"RTN","IBNCPBB",97,0)
 ; IBBDT,IBEDT (if IBMOD1="P"): From/To dates inclusive
"RTN","IBNCPBB",98,0)
 N DIR,DIC,DIRUT,DUOUT,Y,PSOFILE
"RTN","IBNCPBB",99,0)
 S (IBMOD1,IBMOD3)=""
"RTN","IBNCPBB",100,0)
 S DIR(0)="S^P:SINGLE (P)ATIENT;R:SINGLE (R)X"
"RTN","IBNCPBB",101,0)
 S DIR("A")="SINGLE (P)ATIENT, SINGLE (R)X"
"RTN","IBNCPBB",102,0)
 S DIR("B")="P"
"RTN","IBNCPBB",103,0)
 D ^DIR K DIR I $D(DIRUT) S IBEXIT=1,IBPAUSE=0 Q
"RTN","IBNCPBB",104,0)
 S IBMOD1=Y
"RTN","IBNCPBB",105,0)
 ; Enter Rx
"RTN","IBNCPBB",106,0)
 I IBMOD1="R" W ! S PSOFILE=52,DIC="^PSRX(",DIC(0)="AEQMN" D DIC^PSODI(PSOFILE,.DIC) S:$D(DUOUT) IBEXIT=1 S IBRX=$S(Y>0:+Y,1:0) S:'IBRX IBEXIT=1,IBPAUSE=0
"RTN","IBNCPBB",107,0)
 K PSODIY
"RTN","IBNCPBB",108,0)
 I IBMOD1="R" Q
"RTN","IBNCPBB",109,0)
 ;
"RTN","IBNCPBB",110,0)
 I IBMOD1'="P" W !,"???" S IBEXIT=1 Q  ; Invalid mode
"RTN","IBNCPBB",111,0)
 ;Enter Patient
"RTN","IBNCPBB",112,0)
 S DIC="^DPT(",DIC(0)="AEQMN" D ^DIC S:$D(DUOUT) IBEXIT=1 S IBPAT=$S(Y>0:+Y,1:0) S:'IBPAT IBEXIT=1,IBPAUSE=0
"RTN","IBNCPBB",113,0)
 Q:IBEXIT
"RTN","IBNCPBB",114,0)
 I '$$ECMEBIL^IBNCPDPU(IBPAT,DT) W *7,!!,"Warning! The patient is currently not ECME billable!"
"RTN","IBNCPBB",115,0)
 ;
"RTN","IBNCPBB",116,0)
 D DATE I IBEXIT S IBPAUSE=0 Q
"RTN","IBNCPBB",117,0)
 ;
"RTN","IBNCPBB",118,0)
 S DIR(0)="S^U:UNBILLED;A:ALL RX"
"RTN","IBNCPBB",119,0)
 S DIR("A")="(U)NBILLED, (A)LL RX"
"RTN","IBNCPBB",120,0)
 S DIR("B")="U"
"RTN","IBNCPBB",121,0)
 D ^DIR K DIR I $D(DIRUT) S IBEXIT=1,IBPAUSE=0 Q
"RTN","IBNCPBB",122,0)
 S IBMOD3=Y
"RTN","IBNCPBB",123,0)
 Q
"RTN","IBNCPBB",124,0)
 ;
"RTN","IBNCPBB",125,0)
 ;begin/end date
"RTN","IBNCPBB",126,0)
DATE ;
"RTN","IBNCPBB",127,0)
 N Y,%DT
"RTN","IBNCPBB",128,0)
 S (IBBDT,IBEDT)=DT
"RTN","IBNCPBB",129,0)
 W !
"RTN","IBNCPBB",130,0)
 S %DT="AEX"
"RTN","IBNCPBB",131,0)
 S %DT("A")="START WITH DATE: ",%DT("B")="TODAY"
"RTN","IBNCPBB",132,0)
 D ^%DT K %DT
"RTN","IBNCPBB",133,0)
 I Y'>0 S IBEXIT=1 Q
"RTN","IBNCPBB",134,0)
 S IBBDT=+Y
"RTN","IBNCPBB",135,0)
 S %DT="AEX"
"RTN","IBNCPBB",136,0)
 S %DT("A")="GO TO DATE: ",%DT("B")="TODAY" ;$$DAT2^IBOUTL(IBBDT)
"RTN","IBNCPBB",137,0)
 D ^%DT K %DT
"RTN","IBNCPBB",138,0)
 I Y'>0 S IBEXIT=1 Q
"RTN","IBNCPBB",139,0)
 S IBEDT=+Y
"RTN","IBNCPBB",140,0)
 Q
"RTN","IBNCPBB",141,0)
 ;
"RTN","IBNCPBB",142,0)
SELECT ;Select from patient's list
"RTN","IBNCPBB",143,0)
 ; (IBPAT,IBBDT,IBEDT,IBMOD3)
"RTN","IBNCPBB",144,0)
 N IBD,IBRX,IBZ,IBDATA,IBCNT,Y,PDFN,LIST,LIST2,NODE,RXNUMEXT,LIST,IBDATE,CNT1,CNT2,RFNUM
"RTN","IBNCPBB",145,0)
 S CNT1=0,CNT2=0,IBCNT=0
"RTN","IBNCPBB",146,0)
 S LIST="IBRXSELARR"
"RTN","IBNCPBB",147,0)
 S NODE=2
"RTN","IBNCPBB",148,0)
 D RX^PSO52API(IBPAT,LIST,,,NODE,,)
"RTN","IBNCPBB",149,0)
 S RXNUMEXT=0 F  S RXNUMEXT=$O(^TMP($J,LIST,"B",RXNUMEXT)) Q:'RXNUMEXT  D
"RTN","IBNCPBB",150,0)
 . S IBRX=0 F  S IBRX=$O(^TMP($J,LIST,"B",RXNUMEXT,IBRX)) Q:'IBRX  D
"RTN","IBNCPBB",151,0)
 .. S IBDATE=$P(^TMP($J,LIST,IBPAT,IBRX,31),"^",1)
"RTN","IBNCPBB",152,0)
 .. I (IBDATE>IBBDT)&(IBDATE<IBEDT) D
"RTN","IBNCPBB",153,0)
 ... S IBZ=$$RXZERO^IBRXUTL(IBPAT,IBRX) Q:IBZ=""
"RTN","IBNCPBB",154,0)
 ... I $P(IBZ,U,2)'=IBPAT Q
"RTN","IBNCPBB",155,0)
 ... I '$$FILE^IBRXUTL(IBRX,31) Q  ; not released
"RTN","IBNCPBB",156,0)
 ... S IBDATA=$$RXDATA(IBRX,0)
"RTN","IBNCPBB",157,0)
 ... I ('$P(IBDATA,U,6))!(IBMOD3="A") S IBCNT=IBCNT+1,@IBREF@(IBCNT)=IBDATA
"RTN","IBNCPBB",158,0)
 ... S LIST2="IBCPBBRF"
"RTN","IBNCPBB",159,0)
 ... S NODE="R"
"RTN","IBNCPBB",160,0)
 ... D RX^PSO52API(IBPAT,LIST2,IBRX,,NODE,,)
"RTN","IBNCPBB",161,0)
 ... S RFNUM=0 F  S RFNUM=$O(^TMP($J,LIST2,IBPAT,IBRX,"RF",RFNUM)) Q:RFNUM'>0  D:$$SUBFILE^IBRXUTL(IBRX,RFNUM,52,17)
"RTN","IBNCPBB",162,0)
 .... S IBDATA=$$RXDATA(IBRX,RFNUM)
"RTN","IBNCPBB",163,0)
 .... I $P(IBDATA,U,6),IBMOD3'="A" Q  ; unbilled only
"RTN","IBNCPBB",164,0)
 .... S IBCNT=IBCNT+1,@IBREF@(IBCNT)=IBDATA
"RTN","IBNCPBB",165,0)
 ... K ^TMP($J,LIST2)
"RTN","IBNCPBB",166,0)
 K ^TMP($J,LIST)
"RTN","IBNCPBB",167,0)
 D MKCHOICE
"RTN","IBNCPBB",168,0)
 Q
"RTN","IBNCPBB",169,0)
SELECT2 ;Select from Rx list
"RTN","IBNCPBB",170,0)
 ; (IBRX)
"RTN","IBNCPBB",171,0)
 N IBCNT,Y,PDFN,RIFN,LST
"RTN","IBNCPBB",172,0)
 S RIFN=0
"RTN","IBNCPBB",173,0)
 W ! S IBPAUSE=1
"RTN","IBNCPBB",174,0)
 S PDFN=$$FILE^IBRXUTL(IBRX,2)
"RTN","IBNCPBB",175,0)
 S LST="SEL2LST"
"RTN","IBNCPBB",176,0)
 I $$RXZERO^IBRXUTL(PDFN,IBRX)="" W !,"The Rx does not exist. Please try again." S IBEXIT=1 Q
"RTN","IBNCPBB",177,0)
 I $$FILE^IBRXUTL(IBRX,31)="" W !,"The Rx has not been released. Please try again." S IBEXIT=1 Q
"RTN","IBNCPBB",178,0)
 S IBCNT=1,@IBREF@(IBCNT)=$$RXDATA(IBRX,0)
"RTN","IBNCPBB",179,0)
 D RX^PSO52API(PDFN,LST,IBRX,,"R",,)
"RTN","IBNCPBB",180,0)
 S RIFN=0 F  S RIFN=$O(^TMP($J,LST,PDFN,IBRX,"RF",RIFN)) Q:RIFN'>0  D:$$SUBFILE^IBRXUTL(IBRX,RIFN,52,17)
"RTN","IBNCPBB",181,0)
 .S IBCNT=IBCNT+1,@IBREF@(IBCNT)=$$RXDATA(IBRX,RIFN)
"RTN","IBNCPBB",182,0)
 K ^TMP($J,LST)
"RTN","IBNCPBB",183,0)
 D MKCHOICE
"RTN","IBNCPBB",184,0)
 Q
"RTN","IBNCPBB",185,0)
 ;
"RTN","IBNCPBB",186,0)
MKCHOICE ;
"RTN","IBNCPBB",187,0)
 N Y
"RTN","IBNCPBB",188,0)
 W !
"RTN","IBNCPBB",189,0)
 S Y=0 F  S Y=$O(@IBREF@(Y)) Q:'Y  D DISP(Y)
"RTN","IBNCPBB",190,0)
 ;
"RTN","IBNCPBB",191,0)
 I $O(@IBREF@(0))="" S IBEXIT=1 W !!," No Rxs meet the entered criteria. Please try again." Q
"RTN","IBNCPBB",192,0)
 I $O(@IBREF@(""),-1)=1 S IBSEL(1)="" Q  ; one item only
"RTN","IBNCPBB",193,0)
 F  W !!,"Enter Line Item(s) to submit to ECME or (A)LL :" R IBSEL:DTIME S:'$T IBEXIT=1 Q:IBEXIT  Q:IBSEL'["?"  D
"RTN","IBNCPBB",194,0)
 . W !?10,"Enter number(s) or item range(s) separated by comma."
"RTN","IBNCPBB",195,0)
 . W !?10,"Example: 1,3,7-11"
"RTN","IBNCPBB",196,0)
 Q:IBEXIT
"RTN","IBNCPBB",197,0)
 I IBSEL'="",$TR(IBSEL,"al","AL")=$E("ALL",1,$L(IBSEL)),$L(IBSEL)<3 W $E("ALL",$L(IBSEL)+1,3) S IBSEL="ALL"
"RTN","IBNCPBB",198,0)
 I IBSEL="" S IBEXIT=1 W " Nothing selected" Q
"RTN","IBNCPBB",199,0)
 I IBSEL="^" S IBEXIT=1 W " Cancelled" Q
"RTN","IBNCPBB",200,0)
 ;Collect the required into the IBSEL(i) local array
"RTN","IBNCPBB",201,0)
 D PARSE(.IBSEL)
"RTN","IBNCPBB",202,0)
 I $O(IBSEL(0))="" S IBEXIT=1 W !!,"No item(s) match the selection." Q
"RTN","IBNCPBB",203,0)
 Q
"RTN","IBNCPBB",204,0)
 ;
"RTN","IBNCPBB",205,0)
CONFIRM ;
"RTN","IBNCPBB",206,0)
 N DIR,Y
"RTN","IBNCPBB",207,0)
 W !
"RTN","IBNCPBB",208,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("A")="Submit the selected RX(s) to ECME for electronic billing"
"RTN","IBNCPBB",209,0)
 D ^DIR I Y'=1 S IBEXIT=1
"RTN","IBNCPBB",210,0)
 Q
"RTN","IBNCPBB",211,0)
 ;
"RTN","IBNCPBB",212,0)
CONFRX(IBRX) ;
"RTN","IBNCPBB",213,0)
 N DIR,Y
"RTN","IBNCPBB",214,0)
 W !
"RTN","IBNCPBB",215,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("A")="Submit the Rx# "_IBRX_" to ECME for electronic billing"
"RTN","IBNCPBB",216,0)
 D ^DIR I Y'=1 S IBEXIT=1
"RTN","IBNCPBB",217,0)
 Q
"RTN","IBNCPBB",218,0)
 ;
"RTN","IBNCPBB",219,0)
STAT(X) ;
"RTN","IBNCPBB",220,0)
 I +X<6 Q $P(X,"^",2)
"RTN","IBNCPBB",221,0)
 Q "Unknown Status"
"RTN","IBNCPBB",222,0)
 ;
"RTN","IBNCPBB",223,0)
BILL(IBRXN,IBDT) ;Bill IEN (if any) or null
"RTN","IBNCPBB",224,0)
 N RES,X,IBZ
"RTN","IBNCPBB",225,0)
 S IBDT=$P(IBDT,".")
"RTN","IBNCPBB",226,0)
 S RES=""
"RTN","IBNCPBB",227,0)
 S X="" F  S X=$O(^IBA(362.4,"B",IBRXN,X),-1) Q:X=""  D:X  Q:RES
"RTN","IBNCPBB",228,0)
 . S IBZ=$G(^IBA(362.4,X,0))
"RTN","IBNCPBB",229,0)
 . I $P($P(IBZ,U,3),".")=IBDT,$P(IBZ,U,2) S RES=+$P(IBZ,U,2)
"RTN","IBNCPBB",230,0)
 Q RES
"RTN","IBNCPBB",231,0)
 ;
"RTN","IBNCPBB",232,0)
 ;
"RTN","IBNCPBB",233,0)
RXDATA(IBRX,IBFIL) ;
"RTN","IBNCPBB",234,0)
 ;RxIEN^Rx#^Fill#^RelDate^DrugIEN^BillIEN
"RTN","IBNCPBB",235,0)
 N IBRXN,IBDT,IBDRUG,IBBIL,DATRET
"RTN","IBNCPBB",236,0)
 S IBRXN=$$FILE^IBRXUTL(IBRX,.01)
"RTN","IBNCPBB",237,0)
 I IBFIL=0 S IBDT=$$FILE^IBRXUTL(IBRX,22)
"RTN","IBNCPBB",238,0)
 E  S IBDT=$$SUBFILE^IBRXUTL(IBRX,IBFIL,52,.01)
"RTN","IBNCPBB",239,0)
 S IBDT=$P(IBDT,".")
"RTN","IBNCPBB",240,0)
 S IBDRUG=$$FILE^IBRXUTL(IBRX,6)
"RTN","IBNCPBB",241,0)
 S IBBIL=$$BILL(IBRXN,IBDT)
"RTN","IBNCPBB",242,0)
 S DATRET=IBRX_"^"_IBRXN_"^"_IBFIL_"^"_IBDT_"^"_IBDRUG_"^"_IBBIL
"RTN","IBNCPBB",243,0)
 Q DATRET
"RTN","IBNCPBB",244,0)
 ;
"RTN","IBNCPBB",245,0)
DISP(IBITEM) ;
"RTN","IBNCPBB",246,0)
 N IBD,IBBILN,IBDRUG,IBBIL
"RTN","IBNCPBB",247,0)
 S IBD=$G(@IBREF@(IBITEM)) Q:IBD=""
"RTN","IBNCPBB",248,0)
 W !,IBITEM," ",?4,$P(IBD,U,2)," ",?15,$P(IBD,U,3)," ",?20,$$DAT2^IBOUTL($P(IBD,U,4))," "
"RTN","IBNCPBB",249,0)
 W ?32,$E($$DRUG^IBRXUTL1(+$P(IBD,U,5)),1,30)
"RTN","IBNCPBB",250,0)
 S IBBIL=$P(IBD,U,6)
"RTN","IBNCPBB",251,0)
 I IBBIL W ?64,$P($G(^DGCR(399,+IBBIL,0)),U) I $P($G(^DGCR(399,IBBIL,"S")),U,16) W "(canc)"
"RTN","IBNCPBB",252,0)
 Q
"RTN","IBNCPBB",253,0)
 ;
"RTN","IBNCPBB",254,0)
PARSE(X) ;
"RTN","IBNCPBB",255,0)
 N I,J,N
"RTN","IBNCPBB",256,0)
 S X=$TR(X," ")
"RTN","IBNCPBB",257,0)
 S X=$TR(X,";",",")
"RTN","IBNCPBB",258,0)
 I $TR(IBSEL,"al","AL")="ALL" D  Q
"RTN","IBNCPBB",259,0)
 . F I=1:1 Q:'$D(@IBREF@(I))  S IBSEL(I)=""
"RTN","IBNCPBB",260,0)
 F I=1:1:$L(X,",") S N=$P(X,",",I) D:N'=""
"RTN","IBNCPBB",261,0)
 . I N'["-" D:N  Q
"RTN","IBNCPBB",262,0)
 . . I $D(@IBREF@(N)) S X(N)=""
"RTN","IBNCPBB",263,0)
 . ; Processing range
"RTN","IBNCPBB",264,0)
 . N N1,N2
"RTN","IBNCPBB",265,0)
 . S N1=+$P(N,"-",1),N2=+$P(N,"-",2)
"RTN","IBNCPBB",266,0)
 . F J=N1:$S(N2<N1:-1,1:1):N2 I $D(@IBREF@(J)) S X(J)=""
"RTN","IBNCPBB",267,0)
 Q
"RTN","IBNCPBB",268,0)
 ;
"RTN","IBNCPBB",269,0)
PAUSE(MESSAGE) ;
"RTN","IBNCPBB",270,0)
 D EN^DDIOL("","","!")
"RTN","IBNCPBB",271,0)
 I $G(MESSAGE)'="" D EN^DDIOL(MESSAGE) D EN^DDIOL(". ","","?0")
"RTN","IBNCPBB",272,0)
 D EN^DDIOL("Press RETURN to continue: ")
"RTN","IBNCPBB",273,0)
 R %:DTIME
"RTN","IBNCPBB",274,0)
 Q
"RTN","IBNCPBB",275,0)
 ;
"RTN","IBNCPBB",276,0)
SC(IEN) ;Service connected
"RTN","IBNCPBB",277,0)
 N IBT
"RTN","IBNCPBB",278,0)
 I 'IEN Q 0
"RTN","IBNCPBB",279,0)
 S IBT=$P($G(^IBE(356.8,IEN,0)),U)
"RTN","IBNCPBB",280,0)
 I IBT="NEEDS SC DETERMINATION" Q 1
"RTN","IBNCPBB",281,0)
 I IBT="OTHER" Q 1
"RTN","IBNCPBB",282,0)
 Q 0
"RTN","IBNCPBB",283,0)
 ;
"RTN","IBNCPBB",284,0)
 ;
"RTN","IBNCPBB",285,0)
DLYRC(DFLT) ; function, ask for NCPDP field 357-NV Delay Reason Code
"RTN","IBNCPBB",286,0)
 ; DFLT = optional default value (integer from 1-14)
"RTN","IBNCPBB",287,0)
 ; returns code or "^" on time-out, etc.
"RTN","IBNCPBB",288,0)
 N IBDELAY,C,DIC,DIR,DIRUT,DIROUT,DUOUT,DTOUT,X,Y
"RTN","IBNCPBB",289,0)
 S IBDELAY=""
"RTN","IBNCPBB",290,0)
 I $G(DFLT)?1.2N,DFLT>0,DFLT<15 S DIR("B")=DFLT
"RTN","IBNCPBB",291,0)
 S DIR(0)="PO^9002313.29:EMZ" D ^DIR K DIR ; IA# TBD
"RTN","IBNCPBB",292,0)
 S IBDELAY=$S($D(DTOUT)!$D(DUOUT)!$D(DIROUT)!$D(DIRUT):"^",1:Y)
"RTN","IBNCPBB",293,0)
 S IBDELAY=+$P((IBDELAY),"^",1)
"RTN","IBNCPBB",294,0)
 Q IBDELAY
"RTN","IBNCPBB",295,0)
 ;
"RTN","IBNCPBB",296,0)
 ;IBNCPBB
"VER")
8.0^22.0
"BLD",10339,6)
^549
**END**
**END**

