Released IB*2*651 SEQ #591
Extracted from mail message
**KIDS**:IB*2.0*651^

**INSTALL NAME**
IB*2.0*651
"BLD",11341,0)
IB*2.0*651^INTEGRATED BILLING^0^3190814^y
"BLD",11341,4,0)
^9.64PA^^
"BLD",11341,6.3)
9
"BLD",11341,"KRN",0)
^9.67PA^1.5^24
"BLD",11341,"KRN",.4,0)
.4
"BLD",11341,"KRN",.401,0)
.401
"BLD",11341,"KRN",.402,0)
.402
"BLD",11341,"KRN",.403,0)
.403
"BLD",11341,"KRN",.5,0)
.5
"BLD",11341,"KRN",.84,0)
.84
"BLD",11341,"KRN",1.5,0)
1.5
"BLD",11341,"KRN",1.6,0)
1.6
"BLD",11341,"KRN",1.61,0)
1.61
"BLD",11341,"KRN",1.62,0)
1.62
"BLD",11341,"KRN",3.6,0)
3.6
"BLD",11341,"KRN",3.8,0)
3.8
"BLD",11341,"KRN",9.2,0)
9.2
"BLD",11341,"KRN",9.8,0)
9.8
"BLD",11341,"KRN",9.8,"NM",0)
^9.68A^10^10
"BLD",11341,"KRN",9.8,"NM",1,0)
IBECEA3^^0^B93936119
"BLD",11341,"KRN",9.8,"NM",2,0)
IBECEA0^^0^B12419872
"BLD",11341,"KRN",9.8,"NM",3,0)
IBECEAU^^0^B26973128
"BLD",11341,"KRN",9.8,"NM",4,0)
IBARX1^^0^B34529140
"BLD",11341,"KRN",9.8,"NM",5,0)
IBOHLD1^^0^B22293700
"BLD",11341,"KRN",9.8,"NM",6,0)
IBJDF41^^0^B109334665
"BLD",11341,"KRN",9.8,"NM",7,0)
IBJDF42^^0^B65746972
"BLD",11341,"KRN",9.8,"NM",8,0)
IBOMTP1^^0^B21766402
"BLD",11341,"KRN",9.8,"NM",9,0)
IBOHLD2^^0^B32743857
"BLD",11341,"KRN",9.8,"NM",10,0)
IBRREL^^0^B29016408
"BLD",11341,"KRN",9.8,"NM","B","IBARX1",4)

"BLD",11341,"KRN",9.8,"NM","B","IBECEA0",2)

"BLD",11341,"KRN",9.8,"NM","B","IBECEA3",1)

"BLD",11341,"KRN",9.8,"NM","B","IBECEAU",3)

"BLD",11341,"KRN",9.8,"NM","B","IBJDF41",6)

"BLD",11341,"KRN",9.8,"NM","B","IBJDF42",7)

"BLD",11341,"KRN",9.8,"NM","B","IBOHLD1",5)

"BLD",11341,"KRN",9.8,"NM","B","IBOHLD2",9)

"BLD",11341,"KRN",9.8,"NM","B","IBOMTP1",8)

"BLD",11341,"KRN",9.8,"NM","B","IBRREL",10)

"BLD",11341,"KRN",19,0)
19
"BLD",11341,"KRN",19.1,0)
19.1
"BLD",11341,"KRN",101,0)
101
"BLD",11341,"KRN",409.61,0)
409.61
"BLD",11341,"KRN",771,0)
771
"BLD",11341,"KRN",779.2,0)
779.2
"BLD",11341,"KRN",870,0)
870
"BLD",11341,"KRN",8989.51,0)
8989.51
"BLD",11341,"KRN",8989.52,0)
8989.52
"BLD",11341,"KRN",8994,0)
8994
"BLD",11341,"KRN","B",.4,.4)

"BLD",11341,"KRN","B",.401,.401)

"BLD",11341,"KRN","B",.402,.402)

"BLD",11341,"KRN","B",.403,.403)

"BLD",11341,"KRN","B",.5,.5)

"BLD",11341,"KRN","B",.84,.84)

"BLD",11341,"KRN","B",1.5,1.5)

"BLD",11341,"KRN","B",1.6,1.6)

"BLD",11341,"KRN","B",1.61,1.61)

"BLD",11341,"KRN","B",1.62,1.62)

"BLD",11341,"KRN","B",3.6,3.6)

"BLD",11341,"KRN","B",3.8,3.8)

"BLD",11341,"KRN","B",9.2,9.2)

"BLD",11341,"KRN","B",9.8,9.8)

"BLD",11341,"KRN","B",19,19)

"BLD",11341,"KRN","B",19.1,19.1)

"BLD",11341,"KRN","B",101,101)

"BLD",11341,"KRN","B",409.61,409.61)

"BLD",11341,"KRN","B",771,771)

"BLD",11341,"KRN","B",779.2,779.2)

"BLD",11341,"KRN","B",870,870)

"BLD",11341,"KRN","B",8989.51,8989.51)

"BLD",11341,"KRN","B",8989.52,8989.52)

"BLD",11341,"KRN","B",8994,8994)

"BLD",11341,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",11341,"QUES",0)
^9.62^^
"BLD",11341,"REQB",0)
^9.611^2^2
"BLD",11341,"REQB",1,0)
IB*2.0*645^1
"BLD",11341,"REQB",2,0)
IB*2.0*646^1
"BLD",11341,"REQB","B","IB*2.0*645",1)

"BLD",11341,"REQB","B","IB*2.0*646",2)

"MBREQ")
0
"PKG",230,-1)
1^1
"PKG",230,0)
INTEGRATED BILLING^IB^INTEGRATED BILLING
"PKG",230,22,0)
^9.49I^1^1
"PKG",230,22,1,0)
2.0^2940321^2940525
"PKG",230,22,1,"PAH",1,0)
651^3190814
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","IBARX1")
0^4^B34529140^B34169462
"RTN","IBARX1",1,0)
IBARX1 ;ALB/AAS - INTEGRATED BILLING, PHARMACY COPAY INTERFACE (CONT.) ;21-FEB-91
"RTN","IBARX1",2,0)
 ;;2.0;INTEGRATED BILLING;**34,101,150,158,156,234,247,563,614,651**;21-MAR-94;Build 9
"RTN","IBARX1",3,0)
 ;;Per VA Directive 6402, this routine should not be modified.
"RTN","IBARX1",4,0)
 ;
"RTN","IBARX1",5,0)
 ;  - process 1 rx entry and accumulate totals
"RTN","IBARX1",6,0)
 ;  ICR 2056   - $$GET1^DIQ
"RTN","IBARX1",7,0)
 ;  ICR 4820     RX^PSO52API
"RTN","IBARX1",8,0)
 ;
"RTN","IBARX1",9,0)
RX N IBAM,IBNOCH,IBTIER
"RTN","IBARX1",10,0)
 ;if Combat Vet send alert e-mail to mailgroup "IB COMBAT VET RX COPAY"
"RTN","IBARX1",11,0)
 D
"RTN","IBARX1",12,0)
 . N Y D NOW^%DTC S Y=%\1
"RTN","IBARX1",13,0)
 . D RXALRT^IBACV(DFN,Y,+$P($P($G(IBSAVX(1)),"^",1),":",2))
"RTN","IBARX1",14,0)
 ;
"RTN","IBARX1",15,0)
 I $P(IBX,"^")'?1.N1":"1.N.ANP S Y="-1^IB012" G RXQ
"RTN","IBARX1",16,0)
 I $P(IBX,"^",2)<1 S Y="-1^IB013" G RXQ
"RTN","IBARX1",17,0)
 ;
"RTN","IBARX1",18,0)
 D BDESC
"RTN","IBARX1",19,0)
 ;
"RTN","IBARX1",20,0)
 ; make sure effective date defined
"RTN","IBARX1",21,0)
 S IBEFDT=$G(IBEFDT,DT)
"RTN","IBARX1",22,0)
 ; determine rx copay copay tier
"RTN","IBARX1",23,0)
 S IBTIER=$$RXTIER^IBAUTL(DFN,+$P($P(IBX,"^"),":",2),IBEFDT)
"RTN","IBARX1",24,0)
 ; determine rx cost
"RTN","IBARX1",25,0)
 S DA=IBATYP D COST^IBAUTL I $P($G(Y),"^")=-1 G RXQ
"RTN","IBARX1",26,0)
 ;
"RTN","IBARX1",27,0)
 ; IB*2.0*614  Prorate rx's with less than 30 day supply if National HRfS flag is active
"RTN","IBARX1",28,0)
 ; Check for an original fill or a refill.
"RTN","IBARX1",29,0)
 N IBISDT,IBRXN,IBRFN,SHRPEDT,IBLIST,IBDATA,IBLSRF S IBRXN=+$P($P(IBX,"^"),":",2)  ;IBRXN = IEN of the Drug file
"RTN","IBARX1",30,0)
 S IBLIST="IBARX1" K ^TMP($J,IBLIST)
"RTN","IBARX1",31,0)
 D RX^PSO52API(DFN,IBLIST,IBRXN,,"2,R,I") S IBDATA=$NA(^TMP($J,IBLIST,DFN,IBRXN))
"RTN","IBARX1",32,0)
 S IBISDT=+@IBDATA@(1)  ;Get original released date (field 31)
"RTN","IBARX1",33,0)
 S SHRPEDT=$$GET1^DIQ(350.9,1,70.02,"I")   ;Get SHRPE activation date
"RTN","IBARX1",34,0)
 ;
"RTN","IBARX1",35,0)
 S IBLSRF=$O(@IBDATA@("RF","A"),-1)  ;get last refill
"RTN","IBARX1",36,0)
 I IBLSRF D   ;If this is a refill use the refill date to prorate amount billed
"RTN","IBARX1",37,0)
 . I $G(@IBDATA@("RF",IBLSRF,17))="" Q   ;Check released date/time quit if not released
"RTN","IBARX1",38,0)
 . S IBISDT=+@IBDATA@("RF",IBLSRF,17)  ;Reset fill date to date of refill
"RTN","IBARX1",39,0)
 ;
"RTN","IBARX1",40,0)
 ; X1 - standard  calculated amount for this tier #
"RTN","IBARX1",41,0)
 I X1,$$CHKHRFS^IBAMTS3(DFN,IBISDT) D   ;X1 is above 0 and the Pt has a valid HRfS flag at the date of fill/refill
"RTN","IBARX1",42,0)
 . N IBDAYS S IBDAYS=@IBDATA@(8)  ;IBDAYS = the days supply, prorate if less than 30 days
"RTN","IBARX1",43,0)
 . I $G(IBDAYS)<30 S X1=$$PRORATE^IBAMTS3(.X1,IBDAYS)
"RTN","IBARX1",44,0)
 K ^TMP($J,"IBARX1")
"RTN","IBARX1",45,0)
 ;
"RTN","IBARX1",46,0)
 ; compute amount above cap
"RTN","IBARX1",47,0)
 D NEW^IBARXMC($P(IBX,"^",2),X1,DT,.IBCHRG,.IBNOCH)
"RTN","IBARX1",48,0)
 ;
"RTN","IBARX1",49,0)
 S IBTCH=$P(IBX,"^",2)*X1
"RTN","IBARX1",50,0)
 ;
"RTN","IBARX1",51,0)
 ; add to 354.71
"RTN","IBARX1",52,0)
 S IBAM=$$ADD^IBARXMN(DFN,"^^"_IBEFDT_"^^P^"_$P(IBX,"^")_"^"_$P(IBX,"^",2)_"^"_IBTCH_"^"_IBDESC_"^"_$S($G(IBAMP):IBAMP,1:"")_"^"_IBCHRG_"^"_IBNOCH_"^"_(+$P($$SITE^IBARXMU,"^",3))_"^^^^^^^"_$G(IBTIER),IBATYP) I IBAM<1 S Y="-1^IB316" G RXQ
"RTN","IBARX1",53,0)
 ;
"RTN","IBARX1",54,0)
 ; setup new pieces (4, 5, 6, and 7), quit if above cap
"RTN","IBARX1",55,0)
 S $P(IBSAVY(IBJ),"^",4,7)=$S(IBNOCH:1,1:0)_"^"_$S(IBNOCH&(IBCHRG):"P",IBCHRG:"F",1:"")_"^"_(+$G(IBEXMP))_"^"_IBAM G:'IBCHRG RXQ
"RTN","IBARX1",56,0)
 ;
"RTN","IBARX1",57,0)
 S IBTOTL=IBTOTL+IBCHRG
"RTN","IBARX1",58,0)
 S IBWHER=2
"RTN","IBARX1",59,0)
 D ADD^IBAUTL
"RTN","IBARX1",60,0)
 I +Y<1 G RXQ
"RTN","IBARX1",61,0)
 S IBPARNT=$S($D(IBPARNT):IBPARNT,1:IBN)
"RTN","IBARX1",62,0)
 ;IB*2.0*651 - Add now as event date
"RTN","IBARX1",63,0)
 S $P(^IB(IBN,1),"^")=IBDUZ
"RTN","IBARX1",64,0)
 S $P(^IB(IBN,0),"^",2,17)=DFN_"^"_IBATYP_"^"_$P(IBX,"^")_"^2^"_$P(IBX,"^",2)_"^"_IBCHRG_"^"_IBDESC_"^"_IBPARNT_"^^"_IBIL_"^"_IBTRAN_"^"_IBFAC_"^"_IBEFDT_"^"_IBEFDT_"^^"_$$NOW^XLFDT(),$P(^(0),"^",19,22)=IBAM_"^^^"_$G(IBTIER)
"RTN","IBARX1",65,0)
 K IBPARNT,^IB("AC",1,IBN) ;S ^IB("AC",2,IBN)=""
"RTN","IBARX1",66,0)
 D INDEX
"RTN","IBARX1",67,0)
 S $P(IBSAVY(IBJ),"^",1,3)=IBN_"^"_IBCHRG_"^"_IBIL
"RTN","IBARX1",68,0)
 S:'$D(IBNOS) IBNOS="" S IBNOS=IBN_"^"_IBNOS
"RTN","IBARX1",69,0)
RXQ Q
"RTN","IBARX1",70,0)
 ;
"RTN","IBARX1",71,0)
CANRX ;  - ibx = ibn for parent entry
"RTN","IBARX1",72,0)
 ;  - ibn = new cancellation entry
"RTN","IBARX1",73,0)
 N IBAM,IBAMY,IBEFDT,IBTIER
"RTN","IBARX1",74,0)
 S IBY(IBJ)=1
"RTN","IBARX1",75,0)
 I '$D(^IBE(350.3,+$P(IBX,"^",2),0)) S (Y,IBY(IBJ))="-1^IB020" G CANRXQ
"RTN","IBARX1",76,0)
 I '$D(^IB(+IBX,0)) S (Y,IBY(IBJ))="-1^IB021" G CANRXQ
"RTN","IBARX1",77,0)
 S IBND=^IB(+IBX,0)
"RTN","IBARX1",78,0)
 S IBCRES=$P(IBX,"^",2)
"RTN","IBARX1",79,0)
 ;  -find most recent entry for parent ibx
"RTN","IBARX1",80,0)
 ;  -if status isn't an update or new, error already cancelled?
"RTN","IBARX1",81,0)
 D LAST I IBLAST'=IBPARNT,$D(^IB(IBLAST,0)),$P(^IBE(350.1,$P(^IB(IBLAST,0),"^",3),0),"^",5)=2 S (Y,IBY(IBJ))="-1^IB026^ Ref. No: "_+^IB(+IBLAST,0) G CANRXQ ;already cancelled
"RTN","IBARX1",82,0)
 ;
"RTN","IBARX1",83,0)
 ; cancel 354.71
"RTN","IBARX1",84,0)
 S IBAM=$$CANCEL^IBARXMN(DFN,$P(IBND,"^",19),.IBAMY,IBCRES) I $G(IBAMY)<0 S (Y,IBY(IBJ))=IBAMY G CANRXQ
"RTN","IBARX1",85,0)
 ;
"RTN","IBARX1",86,0)
 I $P(IBND,"^",5)=8 D  QUIT  ;Cancel a charge with a status of HOLD
"RTN","IBARX1",87,0)
 . N DIE,DA,DR
"RTN","IBARX1",88,0)
 . S DIE="^IB(",DA=+IBX,DR=".05////10;.1////"_IBCRES
"RTN","IBARX1",89,0)
 . DO ^DIE
"RTN","IBARX1",90,0)
 . S Y=1,IBY(IBJ)=1,Y(IBJ)=+IBX
"RTN","IBARX1",91,0)
 ;
"RTN","IBARX1",92,0)
 S IBPARNT=$P(IBND,"^",9) I '$D(^IB(IBPARNT,0)) S (Y,IBY(IBJ))="-1^IB027" G CANRXQ
"RTN","IBARX1",93,0)
 S IBATYP=$P(^IBE(350.1,$P(IBND,"^",3),0),"^",6) ;cancellation action type for parent
"RTN","IBARX1",94,0)
 I '$D(^IBE(350.1,+IBATYP,0)) S (Y,IBY(IBJ))="-1^IB022" G CANRXQ
"RTN","IBARX1",95,0)
 S IBSEQNO=$P(^IBE(350.1,+IBATYP,0),"^",5) I 'IBSEQNO S (Y,IBY(IBJ))="-1^IB023" G CANRXQ
"RTN","IBARX1",96,0)
 S IBIL=$P(IBND,"^",11) I IBIL="" S (Y,IBY(IBJ))="-1^IB024" G CANRXQ
"RTN","IBARX1",97,0)
 S IBUNIT=$S($D(^IB(+IBLAST,0)):$P(^(0),"^",6),1:$P(IBND,"^",6)) I IBUNIT<1 S (Y,IBY(IBJ))="-1^IB025" G CANRXQ
"RTN","IBARX1",98,0)
 S IBCHRG=$S($D(^IB(+IBLAST,0)):$P(^(0),"^",7),1:$P(IBND,"^",7)) I IBCHRG<1 S (Y,IBY(IBJ))="-1^IB025" G CANRXQ
"RTN","IBARX1",99,0)
 S IBEFDT=$S($P(IBND,"^",14):$P(IBND,"^",14),1:$P($G(^IB(+IBX,1)),"^",2))
"RTN","IBARX1",100,0)
 S IBTIER=$P(IBND,"^",22)
"RTN","IBARX1",101,0)
 S IBTOTL=IBTOTL+IBCHRG
"RTN","IBARX1",102,0)
 S IBWHER=2
"RTN","IBARX1",103,0)
 D ADD^IBAUTL I +Y<1 S IBY(IBJ)=Y G CANRXQ
"RTN","IBARX1",104,0)
 S $P(^IB(IBN,1),"^",1)=IBDUZ
"RTN","IBARX1",105,0)
 S $P(^IB(IBN,0),"^",2,15)=DFN_"^"_IBATYP_"^"_$P(IBND,"^",4)_"^2^"_IBUNIT_"^"_IBCHRG_"^"_$P(IBND,"^",8)_"^"_IBPARNT_"^"_IBCRES_"^"_IBIL_"^^"_IBFAC_"^"_IBEFDT_"^"_IBEFDT S:IBAM $P(^(0),"^",19)=IBAM S:IBTIER $P(^(0),"^",22)=IBTIER
"RTN","IBARX1",106,0)
 K ^IB("AC",1,IBN) ;S ^IB("AC",2,IBN)=""
"RTN","IBARX1",107,0)
 D INDEX
"RTN","IBARX1",108,0)
 S Y(IBJ)=IBN_"^"_IBCHRG_"^"_IBIL
"RTN","IBARX1",109,0)
 S IBNOS=IBN
"RTN","IBARX1",110,0)
CANRXQ Q
"RTN","IBARX1",111,0)
 ;
"RTN","IBARX1",112,0)
BDESC ;  -return brief description
"RTN","IBARX1",113,0)
 N X,Y S IBDESC="",X=$P(IBX,"^")
"RTN","IBARX1",114,0)
 I $D(^IBE(350.1,IBATYP,20)) X ^(20) S IBDESC=X
"RTN","IBARX1",115,0)
 Q
"RTN","IBARX1",116,0)
LAST ;find last entry
"RTN","IBARX1",117,0)
 S IBLAST=""
"RTN","IBARX1",118,0)
 S IBPARNT=$P(^IB(+IBX,0),"^",9) I 'IBPARNT S IBPARNT=+IBX
"RTN","IBARX1",119,0)
 S IBLDT=$O(^IB("APDT",IBPARNT,"")) I +IBLDT F IBL=0:0 S IBL=$O(^IB("APDT",IBPARNT,IBLDT,IBL)) Q:'IBL  S IBLAST=IBL
"RTN","IBARX1",120,0)
 I IBLAST="" S IBLAST=IBPARNT
"RTN","IBARX1",121,0)
 Q
"RTN","IBARX1",122,0)
 ;
"RTN","IBARX1",123,0)
INDEX ;cross-reference entry
"RTN","IBARX1",124,0)
 N X,Y
"RTN","IBARX1",125,0)
 S DA=IBN,DIK="^IB(" D IX^DIK
"RTN","IBARX1",126,0)
 K DIK Q
"RTN","IBARX1",127,0)
 ;
"RTN","IBARX1",128,0)
SERV(Y) ; -- Service check for Pharmacy
"RTN","IBARX1",129,0)
 ;    called by the screen in the input transform for the IB SERVICE/SECTION
"RTN","IBARX1",130,0)
 ;    field of the PHARMACY SITE file.
"RTN","IBARX1",131,0)
 ;    input = Y internal entry number in service section file
"RTN","IBARX1",132,0)
 ;    output = 1 if okay to use (service matches) or 0 if not okay
"RTN","IBARX1",133,0)
 ;
"RTN","IBARX1",134,0)
 ; -- screen logic for field 1003 in file 59 should be 
"RTN","IBARX1",135,0)
 ;    S DIC("S")="I $$SERV^IBARX1(+Y)"
"RTN","IBARX1",136,0)
 ;
"RTN","IBARX1",137,0)
 Q $S('$G(Y):0,1:$D(^IBE(350.1,"ANEW",Y,1,1))&$D(^IBE(350.1,"ANEW",Y,1,2)))
"RTN","IBECEA0")
0^2^B12419872^B11992930
"RTN","IBECEA0",1,0)
IBECEA0 ;ALB/CPM - Cancel/Edit/Add... Build List ; 22-APR-93
"RTN","IBECEA0",2,0)
 ;;2.0;INTEGRATED BILLING;**167,563,651**;21-MAR-94;Build 9
"RTN","IBECEA0",3,0)
 ;;Per VA Directive 6402, this routine should not be modified.
"RTN","IBECEA0",4,0)
 ;
"RTN","IBECEA0",5,0)
ARRAY ; Build list for the List Manager.
"RTN","IBECEA0",6,0)
 N C,IBATYP,IBAX,IBCHG,IBD,IBN,IBND,IBSTAT,Y
"RTN","IBECEA0",7,0)
 S VALMBG=1,VALMCNT=0,VALMBCK="R"
"RTN","IBECEA0",8,0)
 K @IBACMAR,@IBACMIDX,@VALMIDX,^TMP("IBACM",$J),^TMP("IBECEA",$J)
"RTN","IBECEA0",9,0)
 D APDT,APTDT:$G(IBRX)
"RTN","IBECEA0",10,0)
 S IBD="" F  S IBD=$O(^TMP("IBECEA",$J,IBD)) Q:'IBD  D
"RTN","IBECEA0",11,0)
 .S IBN="" F  S IBN=$O(^TMP("IBECEA",$J,IBD,IBN)) Q:'IBN  D 
"RTN","IBECEA0",12,0)
 ..S IBND=^IB(IBN,0) Q:$P(IBND,"^",7)=""
"RTN","IBECEA0",13,0)
 ..S VALMCNT=VALMCNT+1,Y=$P(IBND,"^",5),C=$P(^DD(350,.05,0),"^",2) D Y^DIQ S IBSTAT=Y
"RTN","IBECEA0",14,0)
 ..S IBATYP=$P($G(^IBE(350.1,+$P(IBND,"^",3),0)),"^") S:$E(IBATYP,1,2)="DG" IBATYP=$E(IBATYP,4,99)
"RTN","IBECEA0",15,0)
 ..;  if ouptatient charge and clinic stop, show it
"RTN","IBECEA0",16,0)
 ..I $E(IBATYP,1,3)="OPT",$P(IBND,"^",20) S IBATYP=$E(IBATYP_"                 ",1,17)_" "_$P($G(^IBE(352.5,+$P(IBND,"^",20),0)),"^")
"RTN","IBECEA0",17,0)
 ..S IBCHG=$S(IBATYP["CANCEL":"(",1:" ")_"$"_$P(IBND,"^",7)_$S(IBATYP["CANCEL":")",1:"")
"RTN","IBECEA0",18,0)
 ..S IBAX=$$SETSTR^VALM1(VALMCNT,"",+$P(VALMDDF("CHG#"),"^",2),+$P(VALMDDF("CHG#"),"^",3))
"RTN","IBECEA0",19,0)
 ..S IBAX=$$SETSTR^VALM1($$DAT1^IBOUTL(IBD),IBAX,+$P(VALMDDF("FDATE"),"^",2),+$P(VALMDDF("FDATE"),"^",3))
"RTN","IBECEA0",20,0)
 ..S IBAX=$$SETSTR^VALM1($$DAT1^IBOUTL($S($P(IBND,"^",8)["RX COPAY":IBD,1:$P(IBND,"^",15))),IBAX,+$P(VALMDDF("TDATE"),"^",2),+$P(VALMDDF("TDATE"),"^",3))
"RTN","IBECEA0",21,0)
 ..S IBAX=$$SETSTR^VALM1(IBATYP,IBAX,+$P(VALMDDF("ENTRY"),"^",2),+$P(VALMDDF("ENTRY"),"^",3))
"RTN","IBECEA0",22,0)
 ..S IBAX=$$SETSTR^VALM1($P($P(IBND,"^",11),"-",2),IBAX,+$P(VALMDDF("BILL#"),"^",2),+$P(VALMDDF("BILL#"),"^",3))
"RTN","IBECEA0",23,0)
 ..S IBAX=$$SETSTR^VALM1(IBSTAT,IBAX,+$P(VALMDDF("STATUS"),"^",2),+$P(VALMDDF("STATUS"),"^",3))
"RTN","IBECEA0",24,0)
 ..S IBAX=$$SETSTR^VALM1(IBCHG,IBAX,+$P(VALMDDF("CHARGE"),"^",2),+$P(VALMDDF("CHARGE"),"^",3))
"RTN","IBECEA0",25,0)
 ..S @IBACMAR@(VALMCNT,0)=IBAX,@IBACMAR@("IDX",VALMCNT,VALMCNT)="",@VALMIDX@(VALMCNT)=VALMCNT
"RTN","IBECEA0",26,0)
 ..S @IBACMIDX@(VALMCNT)=VALMCNT_"^"_DFN_"^"_IBATYP_"^"_IBN_"^"_IBCHG_"^"_IBSTAT
"RTN","IBECEA0",27,0)
 I '$O(@IBACMAR@(0)) S @IBACMAR@(1,0)=" ",@IBACMAR@(2,0)="No charges meet criteria",VALMCNT=2,@VALMIDX@(1)=1,@VALMIDX@(2)=2
"RTN","IBECEA0",28,0)
 Q
"RTN","IBECEA0",29,0)
 ;
"RTN","IBECEA0",30,0)
APDT ; Gather Means Test and CHAMPVA charges.
"RTN","IBECEA0",31,0)
 N IBN,IBX,Y,Y1
"RTN","IBECEA0",32,0)
 S Y="" F  S Y=$O(^IB("AFDT",DFN,Y)) Q:'Y  I -Y'>IBAEND S Y1=0 F  S Y1=$O(^IB("AFDT",DFN,Y,Y1)) Q:'Y1  D
"RTN","IBECEA0",33,0)
 .S IBN=0 F  S IBN=$O(^IB("AF",Y1,IBN)) Q:'IBN  D
"RTN","IBECEA0",34,0)
 ..Q:'$D(^IB(IBN,0))  S IBX=^(0)
"RTN","IBECEA0",35,0)
 ..Q:$P(IBX,"^",8)["ADMISSION"
"RTN","IBECEA0",36,0)
 ..I $P(IBX,"^",15)<IBABEG!($P(IBX,"^",14)>IBAEND) Q
"RTN","IBECEA0",37,0)
 ..S ^TMP("IBECEA",$J,+$P(IBX,"^",14),IBN)=""
"RTN","IBECEA0",38,0)
 ;
"RTN","IBECEA0",39,0)
 S Y=0  F  S Y=$O(^IB("ACVA",DFN,Y)) Q:'Y  I Y'>IBAEND S Y1=0 F  S Y1=$O(^IB("ACVA",DFN,Y,Y1)) Q:'Y1  D
"RTN","IBECEA0",40,0)
 .S IBN=0 F  S IBN=$O(^IB("AD",Y1,IBN)) Q:'IBN  D
"RTN","IBECEA0",41,0)
 ..Q:'$D(^IB(IBN,0))  S IBX=^(0)
"RTN","IBECEA0",42,0)
 ..I $P(IBX,"^",15)<IBABEG!($P(IBX,"^",14)>IBAEND) Q
"RTN","IBECEA0",43,0)
 ..S ^TMP("IBECEA",$J,Y,IBN)=""
"RTN","IBECEA0",44,0)
 Q
"RTN","IBECEA0",45,0)
 ;
"RTN","IBECEA0",46,0)
APTDT ; Gather Rx copay charges entered through Cancel/Edit/Add.
"RTN","IBECEA0",47,0)
 N IBN,IBDT,IBZ
"RTN","IBECEA0",48,0)
 S IBN=0 F  S IBN=$O(^IB("C",DFN,IBN)) Q:'IBN  S IBZ=$G(^IB(IBN,0)) I $P(^IBE(350.1,$P(IBZ,"^",3),0),U)["RX" S IBDT=$S($P(IBZ,"^",14):$P(IBZ,"^",14),1:$P($G(^IB(IBN,1)),"^",2))\1 I IBDT,IBDT'<IBABEG,IBDT'>IBAEND S ^TMP("IBECEA",$J,IBDT\1,IBN)=""
"RTN","IBECEA0",49,0)
 Q
"RTN","IBECEA3")
0^1^B93936119^B85667020
"RTN","IBECEA3",1,0)
IBECEA3 ;ALB/CPM - Cancel/Edit/Add... Add a Charge ;30-MAR-93
"RTN","IBECEA3",2,0)
 ;;2.0;INTEGRATED BILLING;**7,57,52,132,150,153,166,156,167,176,198,188,183,202,240,312,402,454,563,614,618,646,651**;21-MAR-94;Build 9
"RTN","IBECEA3",3,0)
 ;;Per VA Directive 6402, this routine should not be modified.
"RTN","IBECEA3",4,0)
 ;
"RTN","IBECEA3",5,0)
ADD ; Add a Charge protocol
"RTN","IBECEA3",6,0)
 N IBGMT,IBGMTR,IBUSNM,IBUC    ;IB*2.0*618 Add IBUSNM IB*2.0*646 Add IBUC
"RTN","IBECEA3",7,0)
 S (IBGMT,IBGMTR,IBUC)=0
"RTN","IBECEA3",8,0)
 S IBCOMMIT=0,IBEXSTAT=$$RXST^IBARXEU(DFN,DT),IBCATC=$$BILST^DGMTUB(DFN),IBCVAEL=$$CVA^IBAUTL5(DFN),IBLTCST=$$LTCST^IBAECU(DFN,DT,1)
"RTN","IBECEA3",9,0)
 ;I 'IBCVAEL,'IBCATC,'$G(IBRX),+IBEXSTAT<1 W !!,"This patient has never been Means Test billable." S VALMBCK="" D PAUSE^VALM1 G ADDQ1
"RTN","IBECEA3",10,0)
 ;
"RTN","IBECEA3",11,0)
 ; - clear screen and begin
"RTN","IBECEA3",12,0)
 D CLOCK^IBAUTL3 I 'IBCLDA S (IBMED,IBCLDAY,IBCLDOL,IBCLDT)=0
"RTN","IBECEA3",13,0)
 D HDR^IBECEAU("A D D")
"RTN","IBECEA3",14,0)
 I IBY<0 D NODED^IBECEAU3 G ADDQ
"RTN","IBECEA3",15,0)
 ;
"RTN","IBECEA3",16,0)
 ; - ask for the charge type
"RTN","IBECEA3",17,0)
 D CHTYP^IBECEA33 G:IBY<0 ADDQ
"RTN","IBECEA3",18,0)
 ;
"RTN","IBECEA3",19,0)
 ;***IB*2.0*618 change to add more Action Types to this list...
"RTN","IBECEA3",20,0)
 ; Allow user to add an extra "co-payment" charge if the Action Type
"RTN","IBECEA3",21,0)
 ; selected is an Outpatient FEE BASIS, CHOICE, CC or CCN charge type
"RTN","IBECEA3",22,0)
 N IBAFEE
"RTN","IBECEA3",23,0)
 S IBUSNM=$P($G(^IBE(350.1,+$G(IBATYP),0)),"^",8)
"RTN","IBECEA3",24,0)
 I IBUSNM'="" D
"RTN","IBECEA3",25,0)
 . I IBUSNM="FEE SERVICE/OUTPATIENT" S IBAFEE=IBATYP Q
"RTN","IBECEA3",26,0)
 . I (IBUSNM["CC")!(IBUSNM["CHOICE") D 
"RTN","IBECEA3",27,0)
 . . I (IBUSNM["OPT")!(IBUSNM["OUTPATIENT")!(IBUSNM["URGENT") S IBAFEE=IBATYP  ;IB*2.0*646  added URGENT 
"RTN","IBECEA3",28,0)
 ;*** END IB*2.0*618 ***
"RTN","IBECEA3",29,0)
 ;
"RTN","IBECEA3",30,0)
 ; - process CHAMPVA charges
"RTN","IBECEA3",31,0)
 I IBXA=6 D CHMPVA^IBECEA32 G ADDQ
"RTN","IBECEA3",32,0)
 ;
"RTN","IBECEA3",33,0)
 ; - process TRICARE charges
"RTN","IBECEA3",34,0)
 I IBXA=7 D CUS^IBECEA35 G ADDQ
"RTN","IBECEA3",35,0)
 ;
"RTN","IBECEA3",36,0)
 ; - display MT billing clock data
"RTN","IBECEA3",37,0)
 I IBXA=2,$P($G(^IBE(350.1,+IBATYP,0)),"^",8)'["NHCU",IBCLDAY>90 S IBMED=IBMED/2
"RTN","IBECEA3",38,0)
 I IBXA=1,IBCLDAY>90 D MED^IBECEA34 G:IBY<0 ADDQ
"RTN","IBECEA3",39,0)
 I "^1^2^3^"[("^"_IBXA_"^"),IBCLDA W !!,"  ** Active Billing Clock **   # Inpt Days: ",IBCLDAY,"    ",$$INPT^IBECEAU(IBCLDAY)," 90 days: $",+IBCLDOL,!
"RTN","IBECEA3",40,0)
 ;
"RTN","IBECEA3",41,0)
 ; - if LTC OPT (non-institutional) and CD display message of warning
"RTN","IBECEA3",42,0)
 I IBXA=8,$$CDEXMPT^IBAECU(DFN,DT) W !!,"  ** Patient is currently Catastrophically Disabled",!
"RTN","IBECEA3",43,0)
 ;
"RTN","IBECEA3",44,0)
 ; - display LTC billing clock data
"RTN","IBECEA3",45,0)
 I IBXA>7,IBXA<10 D  G:IBCLDA<1 ADDQ
"RTN","IBECEA3",46,0)
 . N IBCLZ
"RTN","IBECEA3",47,0)
 . S IBCLDA=$O(^IBA(351.81,"AE",DFN,9999999),-1)
"RTN","IBECEA3",48,0)
 . S:IBCLDA IBCLDA=$O(^IBA(351.81,"AE",DFN,IBCLDA,0))
"RTN","IBECEA3",49,0)
 . I 'IBCLDA W !!,"  ** Patient has no LTC billing clock **" Q
"RTN","IBECEA3",50,0)
 . S IBCLZ=^IBA(351.81,IBCLDA,0)
"RTN","IBECEA3",51,0)
 . W !!,"  **Last LTC Billing Clock    Start Date: ",$$FMTE^XLFDT($P(IBCLZ,"^",3)),"  Free Days Remaining: ",+$P(IBCLZ,"^",6)
"RTN","IBECEA3",52,0)
 . I $P(IBCLZ,"^",6) W !,"The patient must use his free days first." S IBCLDA=0
"RTN","IBECEA3",53,0)
 ;
"RTN","IBECEA3",54,0)
 ; - ask date, units and maybe tier for rx copay charge
"RTN","IBECEA3",55,0)
 I IBXA=5 D  G ADDQ:IBY<0,PROC
"RTN","IBECEA3",56,0)
 . N IBA,IBB,IBC,IBX
"RTN","IBECEA3",57,0)
 . S IBLIM=DT D FR^IBECEAU2(0) Q:IBY<0
"RTN","IBECEA3",58,0)
 . S (IBTO,IBEFDT)=IBFR
"RTN","IBECEA3",59,0)
 . ;
"RTN","IBECEA3",60,0)
 . ;PRCA*4.5*338 - if Community Care RX copay, set event date
"RTN","IBECEA3",61,0)
 . I (IBXA=5),(IBUSNM["RX"),((IBUSNM["CC")!(IBUSNM["CHOICE")) S IBEVDA="*",IBEVDT=IBEFDT
"RTN","IBECEA3",62,0)
 . ;
"RTN","IBECEA3",63,0)
 . ; ask tier if needed
"RTN","IBECEA3",64,0)
 . S IBTIER=$$TIER^IBECEAU2(IBATYP,IBEFDT) Q:IBY<0
"RTN","IBECEA3",65,0)
 . ;
"RTN","IBECEA3",66,0)
 . ; ask units
"RTN","IBECEA3",67,0)
 . D UNIT^IBECEAU2(0) Q:IBY<0
"RTN","IBECEA3",68,0)
 . ;
"RTN","IBECEA3",69,0)
 . ; has patient been previously tracked for cap info
"RTN","IBECEA3",70,0)
 . D TRACK^IBARXMN(DFN)
"RTN","IBECEA3",71,0)
 . ;
"RTN","IBECEA3",72,0)
 . D CTBB^IBECEAU3
"RTN","IBECEA3",73,0)
 . ;
"RTN","IBECEA3",74,0)
 . ; check if above cap
"RTN","IBECEA3",75,0)
 . I IBY'<0 D
"RTN","IBECEA3",76,0)
 .. N IBB,IBN,DIR,DIRUT,DUOUT,DTOUT,X,Y
"RTN","IBECEA3",77,0)
 .. D NEW^IBARXMC(1,IBCHG,IBFR,.IBB,.IBN) Q:'IBN
"RTN","IBECEA3",78,0)
 .. ;
"RTN","IBECEA3",79,0)
 .. ; display message ask to proceed
"RTN","IBECEA3",80,0)
 .. W !!,"This charge will put the patient > $",$J(IBN,0,2)," above their cap amount."
"RTN","IBECEA3",81,0)
 .. S DIR(0)="Y",DIR("A")="Okay to proceed" D ^DIR S:'Y IBY=-1
"RTN","IBECEA3",82,0)
 .. ;
"RTN","IBECEA3",83,0)
 S IBLIM=$S(IBXA=4!(IBXA=3):DT,1:$$FMADD^XLFDT(DT,-1))
"RTN","IBECEA3",84,0)
 ;
"RTN","IBECEA3",85,0)
FR ; - ask 'bill from' date
"RTN","IBECEA3",86,0)
 D FR^IBECEAU2(0) G:IBY<0 ADDQ
"RTN","IBECEA3",87,0)
 ;
"RTN","IBECEA3",88,0)
 ;IB*2.0*646
"RTN","IBECEA3",89,0)
 ; If Urgent Care copay, skip clock checks, go to prompt for copay amount.
"RTN","IBECEA3",90,0)
 G:$G(IBUC) UCPAY
"RTN","IBECEA3",91,0)
 ; end IB*2.0*646
"RTN","IBECEA3",92,0)
 S IBGMT=$$ISGMTPT^IBAGMT(DFN,IBFR),IBGMTR=0 ;GMT Copayment Status
"RTN","IBECEA3",93,0)
 I IBGMT>0,IBXA>0,IBXA<4 W !,"The patient has GMT Copayment Status."
"RTN","IBECEA3",94,0)
 ; - check the MT billing clock
"RTN","IBECEA3",95,0)
 I IBXA'=8,IBXA'=9 D CLMSG^IBECEA33 G:IBY<0 ADDQ
"RTN","IBECEA3",96,0)
 ;Adjust Deductible for GMT patient
"RTN","IBECEA3",97,0)
 I IBGMT>0,IBXA>0,IBXA<4,$G(IBMED) S IBMED=$$REDUCE^IBAGMT(IBMED) W !,"Medicare Deductible reduced due to GMT Copayment Status ($",$J(IBMED,"",2),")."
"RTN","IBECEA3",98,0)
 ;
"RTN","IBECEA3",99,0)
 ; - check LTC non-institutional (opt) for CD exemption
"RTN","IBECEA3",100,0)
 I IBXA=8,$$CDEXMPT^IBAECU(DFN,IBFR) W !,"Patient is LTC non-institutional exempt, Catastrophically Disabled" G ADDQ
"RTN","IBECEA3",101,0)
 ;
"RTN","IBECEA3",102,0)
 ; - check the LTC billing clock
"RTN","IBECEA3",103,0)
 I IBXA>7,IBXA<10 D  I IBY<0 W !!,"The patient has no LTC clock active for the date.",! G ADDQ
"RTN","IBECEA3",104,0)
 . N IBCLZ S IBCLZ=^IBA(351.81,IBCLDA,0)
"RTN","IBECEA3",105,0)
 . ;
"RTN","IBECEA3",106,0)
 . ; is this the clock and within the date range
"RTN","IBECEA3",107,0)
 . I IBFR'<$P(IBCLZ,"^",3),$$YR^IBAECU($P(IBCLZ,"^",3),IBFR) S IBY=-1 Q
"RTN","IBECEA3",108,0)
 . ;
"RTN","IBECEA3",109,0)
 . ; look for another clock that might fit the date
"RTN","IBECEA3",110,0)
 . I IBFR<$P(IBCLZ,"^",3) S IBCLDA=$O(^IBA(351.81,"AE",DFN,IBFR+1),-1) I 'IBCLDA!($$YR^IBAECU($P($G(^IBA(351.81,+IBCLDA,0)),"^",3),IBFR)) S IBY=-1
"RTN","IBECEA3",111,0)
 ;
"RTN","IBECEA3",112,0)
 ; - calculate the MT inpt copay charge
"RTN","IBECEA3",113,0)
 I IBXA=2 S IBDT=IBFR D COPAY^IBAUTL2 G ADDQ:IBY<0 S:IBGMT>0 IBGMTR=1,IBCHG=$$REDUCE^IBAGMT(IBCHG) I IBCHG+IBCLDOL<IBMED W *7,"   ($",IBCHG,"/day)" W:IBGMTR " GMT Rate"
"RTN","IBECEA3",114,0)
 ;
"RTN","IBECEA3",115,0)
 ; - find the correct clock from the 'bill from' date (ignore LTC)
"RTN","IBECEA3",116,0)
 I IBXA'=8,IBXA'=9,('IBCLDA!(IBCLDA&(IBFR<IBCLDT))) D NOCL^IBECEA33 G:IBY<0 ADDQ
"RTN","IBECEA3",117,0)
 ;
"RTN","IBECEA3",118,0)
UCPAY ;IB*2.0*646 Added to allow for skip of clock checks - required for Urgent Care Copays
"RTN","IBECEA3",119,0)
 ; - perform outpatient edits
"RTN","IBECEA3",120,0)
 N IBSTOPDA
"RTN","IBECEA3",121,0)
 ;
"RTN","IBECEA3",122,0)
 ;Start- IB*2.0*651
"RTN","IBECEA3",123,0)
 ;Check to see if there is another medical copay (inpatient or outpatient) on that same day for this patient.
"RTN","IBECEA3",124,0)
 ;If there is, print warning message to user and abort copay entry.
"RTN","IBECEA3",125,0)
 I ((IBXA=4)!(IBXA=8)),$$BFCHK^IBECEAU(DFN,IBFR) D PRTWRN G ADDQ
"RTN","IBECEA3",126,0)
 ;end IB*2.0*651
"RTN","IBECEA3",127,0)
 ;
"RTN","IBECEA3",128,0)
 ;IB*2.0*646 If urgent care, process using UC criteria and go to process
"RTN","IBECEA3",129,0)
 I IBXA=4,IBUC D UCCHRG^IBECEA36 G ADDQ:IBY<0,PROC
"RTN","IBECEA3",130,0)
 ;end IB*2.0*646
"RTN","IBECEA3",131,0)
 ;
"RTN","IBECEA3",132,0)
 I IBXA=4,$$CHKHRFS^IBAMTS3(DFN,IBFR,IBFR) W !!,"This patient is 'Exempt' from Outpatient Visit charges on that date of service.",! G ADDQ  ;IB*2.0*614 (no copayment if HRfS flag)
"RTN","IBECEA3",133,0)
 I IBXA=4 D  G ADDQ:IBY<0,PROC
"RTN","IBECEA3",134,0)
 .   ;  for visits prior to 12/6/01 or FEE
"RTN","IBECEA3",135,0)
 .   I IBFR<3011206!($G(IBAFEE)) D OPT^IBECEA33 Q
"RTN","IBECEA3",136,0)
 .   ;  for visits on or after 12/5/01
"RTN","IBECEA3",137,0)
 .   D OPT^IBEMTSCU
"RTN","IBECEA3",138,0)
 ;
"RTN","IBECEA3",139,0)
 ; - if LTC outpatient calculate the charge
"RTN","IBECEA3",140,0)
 I IBXA=8 D  G:IBY<0 ADDQ S (IBDT,IBTO,IBEVDT)=IBFR,IBDESC=$P(^IBE(350.1,IBATYP,0),"^",8),IBUNIT=1,IBEVDA="*" D COST^IBAUTL2,CALC^IBAECO,CTBB^IBECEAU3 G @$S(IBCHG:"PROC",1:"ADDQ")
"RTN","IBECEA3",141,0)
 . ;
"RTN","IBECEA3",142,0)
 . ; is this day already a free day
"RTN","IBECEA3",143,0)
 . I $D(^IBA(351.81,IBCLDA,1,"AC",IBFR)) W !!,"This day is already marked as a Free Day." S IBY=-1
"RTN","IBECEA3",144,0)
 . ;
"RTN","IBECEA3",145,0)
 . ; have we already billed for this day
"RTN","IBECEA3",146,0)
 . I $$BFO^IBECEAU(DFN,IBFR) W !!,"This patient has already been billed for this date." S IBY=-1
"RTN","IBECEA3",147,0)
 ;
"RTN","IBECEA3",148,0)
 ; - find per diem charge and description
"RTN","IBECEA3",149,0)
 I IBXA=3 D  I 'IBCHG W !!,"Unable to determine the per diem rate.  Please check your rate table." G ADDQ
"RTN","IBECEA3",150,0)
 .N IBDT S IBDT=IBFR,IBGMTR=0 D COST^IBAUTL2
"RTN","IBECEA3",151,0)
 .I IBGMT>0 S IBGMTR=1,IBCHG=$$REDUCE^IBAGMT(IBCHG)
"RTN","IBECEA3",152,0)
 .S IBDESC="" X:$D(^IBE(350.1,IBATYP,20)) ^(20)
"RTN","IBECEA3",153,0)
 ;
"RTN","IBECEA3",154,0)
 ; - calculate charge for the inpatient copay
"RTN","IBECEA3",155,0)
 I IBXA=2,IBCHG+IBCLDOL'<IBMED S IBCHG=IBMED-IBCLDOL,IBUNIT=1,IBTO=IBFR D CTBB^IBECEAU3 G EV
"RTN","IBECEA3",156,0)
 ;
"RTN","IBECEA3",157,0)
TO ; - ask 'bill to' date
"RTN","IBECEA3",158,0)
 D TO^IBECEAU2(0) G:IBY<0 ADDQ
"RTN","IBECEA3",159,0)
 ;
"RTN","IBECEA3",160,0)
 ;Start- IB*2.0*651
"RTN","IBECEA3",161,0)
 ;Check to see if there is another medical copay (inpatient or outpatient) on that same day for this patient.
"RTN","IBECEA3",162,0)
 ;If there is, print warning message to user and abort copay entry.
"RTN","IBECEA3",163,0)
 I ((IBXA<4)!(IBXA=9)),$$BFCHK^IBECEAU(DFN,IBFR) D PRTWRN G ADDQ
"RTN","IBECEA3",164,0)
 ;end IB*2.0*651
"RTN","IBECEA3",165,0)
 ;
"RTN","IBECEA3",166,0)
 I IBXA>0,IBXA<4,IBGMT'=$$ISGMTPT^IBAGMT(DFN,IBTO) W !!,"The patient's GMT Copayment status changed within the specified period!",! G ADDQ
"RTN","IBECEA3",167,0)
 ;
"RTN","IBECEA3",168,0)
 ; - calculate unit charge for LTC inpatient in IBCHG
"RTN","IBECEA3",169,0)
 I IBXA=9 S IBDT=IBFR,IBEVDA=$$EVF^IBECEA31(DFN,IBFR,IBTO,IBNH),IBEVDT=$E(IBFR,1,5)_"01" D:IBEVDA<1  G ADDQ:IBY<0 D COST^IBAUTL2 I $E(IBFR,1,5)'=$E(IBTO,1,5) W !!,"  LTC Copayment charges cannot go from one month to another." G ADDQ
"RTN","IBECEA3",170,0)
 . D NOEV^IBECEA31 I '$G(IBDG)!(IBY<0) S IBY=-1 Q
"RTN","IBECEA3",171,0)
 . ; - build the event record
"RTN","IBECEA3",172,0)
 . N IBNHLTC S IBNHLTC=1 D ADEV^IBECEA31
"RTN","IBECEA3",173,0)
 ;
"RTN","IBECEA3",174,0)
 ;
"RTN","IBECEA3",175,0)
 ; - calculate units and total charge
"RTN","IBECEA3",176,0)
 S IBUNIT=$$FMDIFF^XLFDT(IBTO,IBFR) S:IBXA'=3!(IBFR=IBTO) IBUNIT=IBUNIT+1
"RTN","IBECEA3",177,0)
 I IBXA=1 D:IBGMT>0  D FEPR^IBECEA32 G ADDQ:IBY<0,EV
"RTN","IBECEA3",178,0)
 . S IBGMTR=1
"RTN","IBECEA3",179,0)
 . W !,"The patient has GMT Copayment Status! GMT rate must be applied.",!
"RTN","IBECEA3",180,0)
 S IBCHG=IBCHG*IBUNIT S:IBXA=2 IBCHG=$S(IBCLDOL+IBCHG>IBMED:IBMED-IBCLDOL,1:IBCHG)
"RTN","IBECEA3",181,0)
 ;
"RTN","IBECEA3",182,0)
 ; adjust the LTC charge based on the calculated copay cap
"RTN","IBECEA3",183,0)
 I IBXA=9 D CALC^IBAECI G:IBY<1!('IBCHG) ADDQ S IBDESC="LTC INPATIENT COPAY"
"RTN","IBECEA3",184,0)
 ;
"RTN","IBECEA3",185,0)
 D CTBB^IBECEAU3 W:IBXA=3!(IBXA=9) "  (for ",IBUNIT," day",$E("s",IBUNIT>1),")" W:IBGMTR " GMT Rate"
"RTN","IBECEA3",186,0)
 ;
"RTN","IBECEA3",187,0)
EV ; - find event record, or select admission for linkage
"RTN","IBECEA3",188,0)
 I IBXA'=9 S IBEVDA=$$EVF^IBECEA31(DFN,IBFR,IBTO,IBNH)
"RTN","IBECEA3",189,0)
 I IBEVDA'>0 D NOEV^IBECEA31 G ADDQ:IBY<0,PROC
"RTN","IBECEA3",190,0)
 S IBSL=$P($G(^IB(+IBEVDA,0)),"^",4)
"RTN","IBECEA3",191,0)
 W !!,"Linked charge to ",$$TYP(),"admission on ",$$DAT1^IBOUTL($P(IBEVDA,"^",2)),"  ("
"RTN","IBECEA3",192,0)
 W $S($P(IBEVDA,"^",3)=9999999:"Still admitted)",1:"Discharged on "_$$DAT1^IBOUTL($P(IBEVDA,"^",3))_$S($P(IBEVDA,"^",3)>DT:" [pseudo])",1:")"))," ..."
"RTN","IBECEA3",193,0)
 S IBEVDA=+IBEVDA
"RTN","IBECEA3",194,0)
 I '$G(IBSIBC) D SPEC^IBECEA32(0,$O(^IBE(351.2,"AD",IBEVDA,0)))
"RTN","IBECEA3",195,0)
 ;
"RTN","IBECEA3",196,0)
 ;
"RTN","IBECEA3",197,0)
PROC ; - okay to proceed?
"RTN","IBECEA3",198,0)
 D PROC^IBECEAU4("add") G:IBY<0 ADDQ
"RTN","IBECEA3",199,0)
 ;
"RTN","IBECEA3",200,0)
 ; - build the event record first if necessary
"RTN","IBECEA3",201,0)
 I $G(IBDG),IBXA'=9 D @("ADEV^IBECEA3"_$S($G(IBFEEV):4,1:1)) G:IBY<0 ADDQ
"RTN","IBECEA3",202,0)
 ;
"RTN","IBECEA3",203,0)
 ; - disposition the special inpatient billing case, if necessary
"RTN","IBECEA3",204,0)
 I $G(IBSIBC) D CEA^IBAMTI1(IBSIBC,IBEVDA)
"RTN","IBECEA3",205,0)
 ;
"RTN","IBECEA3",206,0)
 ; - generate entry in file #354.71 (for VA RX only per IB*2.0*618) and #350
"RTN","IBECEA3",207,0)
 I IBXA=5,(IBUSNM'["CC"),(IBUSNM'["CHOICE") W !!,"Building the new transaction...  " S IBAM=$$ADD^IBARXMN(DFN,"^^"_IBEFDT_"^^P^^"_IBUNIT_"^"_IBCHG_"^"_IBDESC_"^^"_IBCHG_"^0^"_IBSITE_"^^^^^^^"_$G(IBTIER)) G:IBAM<0 ADDQ
"RTN","IBECEA3",208,0)
 D ADD^IBECEAU3 G:IBY<0 ADDQ W "done."
"RTN","IBECEA3",209,0)
 ;
"RTN","IBECEA3",210,0)
 ; - pass the charge off to AR on-line
"RTN","IBECEA3",211,0)
 W !,"Passing the charge directly to Accounts Receivable... "
"RTN","IBECEA3",212,0)
 D PASSCH^IBECEA22 W:IBY>0 "done." G:IBY<0 ADDQ
"RTN","IBECEA3",213,0)
 ;
"RTN","IBECEA3",214,0)
 ; - review the special inpatient billing case
"RTN","IBECEA3",215,0)
 I $G(IBSIBC1) D CHK^IBAMTI1(IBSIBC1,IBEVDA)
"RTN","IBECEA3",216,0)
 ;
"RTN","IBECEA3",217,0)
 ; - handle updating of clock
"RTN","IBECEA3",218,0)
 I IBXA'=8,IBXA'=9,'IBUC D CLUPD^IBECEA32  ;IB*2.0*646
"RTN","IBECEA3",219,0)
 ;
"RTN","IBECEA3",220,0)
ADDQ ; - display error, rebuild list, and quit
"RTN","IBECEA3",221,0)
 D ERR^IBECEAU4:IBY<0,PAUSE^IBECEAU S VALMBCK="R"
"RTN","IBECEA3",222,0)
 I IBCOMMIT S IBBG=VALMBG W !,"Rebuilding list of charges..." D ARRAY^IBECEA0 S VALMBG=IBBG
"RTN","IBECEA3",223,0)
 K IBMED,IBCLDA,IBCLDT,IBCLDOL,IBCLDAY,IBATYP,IBDG,IBSEQNO,IBXA,IBNH,IBBS,IBLIM,IBFR,IBTO,IBRTED,IBSIBC,IBSIBC1,IBBG,IBFEEV,IBAM
"RTN","IBECEA3",224,0)
 K IBX,IBCHG,IBUNIT,IBDESC,IBDT,IBEVDT,IBEVDA,IBSL,IBNOS,IBN,IBTOTL,IBARTYP,IBIL,IBTRAN,IBAFY,IBCVA,IBCLSF,IBDD,IBND,VADM,VA,VAERR,IBADJMED
"RTN","IBECEA3",225,0)
ADDQ1 K IBEXSTAT,IBCOMMIT,IBCATC,IBCVAEL,IBLTCST,IBTIER,IBEFDT
"RTN","IBECEA3",226,0)
 Q
"RTN","IBECEA3",227,0)
 ;
"RTN","IBECEA3",228,0)
 ;
"RTN","IBECEA3",229,0)
TYP() ; Return descriptive admission type.
"RTN","IBECEA3",230,0)
 N X S X=""
"RTN","IBECEA3",231,0)
 I IBNH'=2 G TYPQ
"RTN","IBECEA3",232,0)
 I $G(IBADJMED) S X=$S(IBADJMED=1:"C",1:"H")
"RTN","IBECEA3",233,0)
 E  S X=$S($P($G(^IBE(350.1,+IBATYP,0)),"^")["NHCU":"C",1:"H")
"RTN","IBECEA3",234,0)
 S X=$S(X="C":"CNH ",1:"Contract Hospital ")
"RTN","IBECEA3",235,0)
TYPQ Q X
"RTN","IBECEA3",236,0)
 ;
"RTN","IBECEA3",237,0)
 ;IB*2.0*651
"RTN","IBECEA3",238,0)
PRTWRN ; Print warning message about medical copayment already applied 
"RTN","IBECEA3",239,0)
 ;
"RTN","IBECEA3",240,0)
 W !!!,"This patient has already been billed a medical copayment for this date."
"RTN","IBECEA3",241,0)
 W !,"Please review the associated dates and charges for this patient.",!
"RTN","IBECEA3",242,0)
 Q
"RTN","IBECEAU")
0^3^B26973128^B14113115
"RTN","IBECEAU",1,0)
IBECEAU ;ALB/CPM - Cancel/Edit/Add... Utilities ;11-MAR-93
"RTN","IBECEAU",2,0)
 ;;2.0;INTEGRATED BILLING;**91,249,402,651**;21-MAR-94;Build 9
"RTN","IBECEAU",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBECEAU",4,0)
 ;
"RTN","IBECEAU",5,0)
CHECK(TALK) ; Retrieve the institution and MAS Service pointer.
"RTN","IBECEAU",6,0)
 ; Input:   TALK  --  1 : do i/o (writes)
"RTN","IBECEAU",7,0)
 ;                    0 : no i/o
"RTN","IBECEAU",8,0)
 N IBY,Y S (IBY,Y)=1
"RTN","IBECEAU",9,0)
 D SITE^IBAUTL I Y<1 S IBY=Y W:$G(TALK) !!,"You must define your facility in the IB SITE PARAMETER file before proceeding!",!
"RTN","IBECEAU",10,0)
 I IBY>0 D SERV^IBAUTL2 I IBY<1 W:$G(TALK) !!,"You must define the MAS Service Pointer in the IB SITE PARAMETER file",!,"before proceeding!",!
"RTN","IBECEAU",11,0)
 Q IBY>0
"RTN","IBECEAU",12,0)
 ;
"RTN","IBECEAU",13,0)
PAUSE ; Go to end of page to pause.
"RTN","IBECEAU",14,0)
 N DIR,DIRUT,DUOUT,DTOUT,X,Y
"RTN","IBECEAU",15,0)
 W ! F Y=$Y:1:21 W !
"RTN","IBECEAU",16,0)
 S DIR("A")="Press RETURN to process the next charge or to return to the list"
"RTN","IBECEAU",17,0)
 S DIR(0)="E" D ^DIR K DIR
"RTN","IBECEAU",18,0)
 Q
"RTN","IBECEAU",19,0)
 ;
"RTN","IBECEAU",20,0)
INPT(DAYS) ; Return a description for Billing Clock days.
"RTN","IBECEAU",21,0)
 ; Input:   DAYS  --  Number of days in a billing clock
"RTN","IBECEAU",22,0)
 ; Output:  "1st", "2nd", "3rd", "4th"
"RTN","IBECEAU",23,0)
 Q $S(DAYS>270:"4th",DAYS>180:"3rd",DAYS>90:"2nd",1:"1st")
"RTN","IBECEAU",24,0)
 ;
"RTN","IBECEAU",25,0)
LAST(PAR) ; Find last action filed for any parent action.
"RTN","IBECEAU",26,0)
 ; Input:    PAR  --  Parent IB Action
"RTN","IBECEAU",27,0)
 ; Output:   Last action filed for parent (or parent if none)
"RTN","IBECEAU",28,0)
 N IBL,IBLDT,IBLAST
"RTN","IBECEAU",29,0)
 S IBLAST="",IBLDT=$O(^IB("APDT",PAR,"")) I +IBLDT S IBL=0 F  S IBL=$O(^IB("APDT",PAR,IBLDT,IBL)) Q:'IBL  S IBLAST=IBL
"RTN","IBECEAU",30,0)
 Q $S(IBLAST:IBLAST,1:PAR)
"RTN","IBECEAU",31,0)
 ;
"RTN","IBECEAU",32,0)
BFO(DFN,DATE) ; Patient Billed For OPT Copay on a specified date?
"RTN","IBECEAU",33,0)
 ; Input:    DFN  --  Pointer to the patient in file #2
"RTN","IBECEAU",34,0)
 ;          DATE  --  Date of the Outpatient Visit
"RTN","IBECEAU",35,0)
 ; Output:     0  --  Not billed the OPT copay on the visit date
"RTN","IBECEAU",36,0)
 ;            >0  --  Pointer to charge in file #350 that was billed
"RTN","IBECEAU",37,0)
 N IBATYP,IBATYPN,IBL,IBND,IBN,Y
"RTN","IBECEAU",38,0)
 I '$G(DFN)!'$G(DATE) G BFOQ
"RTN","IBECEAU",39,0)
 S IBN=0 F  S IBN=$O(^IB("AFDT",DFN,-DATE,IBN)) Q:'IBN  D  I ($P(IBATYPN,"^",11)=4)!($P(IBATYPN,"^",11)=8),"^1^3^"[("^"_$P(IBATYP,"^",5)_"^"),"^1^2^3^4^8^20^"[("^"_+$P(IBND,"^",5)_"^") S Y=IBL Q
"RTN","IBECEAU",40,0)
 .S IBL=$$LAST(+$P($G(^IB(IBN,0)),"^",9)),IBND=$G(^IB(IBL,0))
"RTN","IBECEAU",41,0)
 .S IBATYP=$G(^IBE(350.1,+$P(IBND,"^",3),0))
"RTN","IBECEAU",42,0)
 .S IBATYPN=$G(^IBE(350.1,+$P(IBATYP,"^",9),0))
"RTN","IBECEAU",43,0)
BFOQ Q +$G(Y)
"RTN","IBECEAU",44,0)
 ;
"RTN","IBECEAU",45,0)
CNP(DFN,DATE) ; Did the patient have a C&P Exam on a specified date?
"RTN","IBECEAU",46,0)
 ; Input:    DFN  --  Pointer to the patient in file #2
"RTN","IBECEAU",47,0)
 ;          DATE  --  Date of the Outpatient Visit
"RTN","IBECEAU",48,0)
 ; Output:     0  --  Patient did not have a C&P Exam on the visit date
"RTN","IBECEAU",49,0)
 ;             1  --  Patient had a C&P Exam on the visit date
"RTN","IBECEAU",50,0)
 N I,IBD,IBSD,Y,IBVAL,IBCBK,IBFILTER,IBCNP,Z
"RTN","IBECEAU",51,0)
 I '$G(DFN)!'$G(DATE) G CNPQ
"RTN","IBECEAU",52,0)
 ; - check appts, stop codes
"RTN","IBECEAU",53,0)
 S IBVAL("DFN")=DFN,IBVAL("BDT")=DATE,IBVAL("EDT")=DATE+.9999
"RTN","IBECEAU",54,0)
 ; Only parent appt or add/edit encounters
"RTN","IBECEAU",55,0)
 S IBFILTER=""
"RTN","IBECEAU",56,0)
 S IBCBK="I '$P(Y0,U,6),$P(Y0,U,8)<3 N Z S Z=$P(Y0,U,8) I $S(Z=1:$P(Y0,U,10)=1&($P(Y0,U,12)<3),Z=2:$P(Y0,U,10)=1,1:0) S (IBCNP,SDSTOP)=1"
"RTN","IBECEAU",57,0)
 S IBCNP=0
"RTN","IBECEAU",58,0)
 D SCAN^IBSDU("PATIENT/DATE",.IBVAL,IBFILTER,IBCBK,1) K ^TMP("DIERR",$J)
"RTN","IBECEAU",59,0)
 I IBCNP S Y=1
"RTN","IBECEAU",60,0)
CNPQ Q +$G(Y)
"RTN","IBECEAU",61,0)
 ;
"RTN","IBECEAU",62,0)
HDR(OPT) ; Display the header for an action
"RTN","IBECEAU",63,0)
 ; Input:    OPT  --  Action Header
"RTN","IBECEAU",64,0)
 N ADD,HDR S ADD=OPT="A D D"
"RTN","IBECEAU",65,0)
 D CLEAR^VALM1 S IBY=1,HDR=OPT_"   A   C H A R G E"
"RTN","IBECEAU",66,0)
 I 'ADD S IBIDX=$G(^TMP("IBACMIDX",$J,IBNBR)),IBN=+$P(IBIDX,"^",4),IBND=$G(^IB(IBN,0))
"RTN","IBECEAU",67,0)
 W !?(80-$L(HDR)\2),HDR W:'ADD !?29,"Processing Charge #",IBNBR
"RTN","IBECEAU",68,0)
 W !,$$LINE,!?3,"Name: ",$P(IBNAM,"^") W:'ADD ?41,"Type: ",$P(IBIDX,"^",3)
"RTN","IBECEAU",69,0)
 I ADD W ?41,"** " W:'IBCLDA "NO " W "ACTIVE BILLING CLOCK **"
"RTN","IBECEAU",70,0)
 W !?5,"ID: ",$P(IBNAM,"^",2) W:'ADD ?42,"Amt:",$P(IBIDX,"^",5)," (",$P(IBIDX,"^",6),")"
"RTN","IBECEAU",71,0)
 I ADD,IBCLDA W ?44,"Clock Begin Date: ",$$DAT1^IBOUTL(IBCLDT)
"RTN","IBECEAU",72,0)
 W !,$$LINE,!
"RTN","IBECEAU",73,0)
 Q
"RTN","IBECEAU",74,0)
 ;
"RTN","IBECEAU",75,0)
LINE() ; Write a line.
"RTN","IBECEAU",76,0)
 Q $TR($J("",80)," ","-")
"RTN","IBECEAU",77,0)
 ;
"RTN","IBECEAU",78,0)
CLOCK(IBDOL,IBDAYPR,IBDAY) ; Display and update clock data.
"RTN","IBECEAU",79,0)
 ; Input:     IBDOL  --  Dollar amount to add or subtract
"RTN","IBECEAU",80,0)
 ;          IBDAYPR  --  Existing number of inpatient days
"RTN","IBECEAU",81,0)
 ;            IBDAY  --  Inpatient days to add or subtract
"RTN","IBECEAU",82,0)
 ; Also assumes that IBCLST,IBNAM, IBCLDA, and IBXA are defined.
"RTN","IBECEAU",83,0)
 D CLDSP^IBECEAU1(IBCLST,IBNAM) I $P(IBCLST,"^",4)'=1 W !,"** Please note that an active billing clock was not selected for updating **"
"RTN","IBECEAU",84,0)
 I IBXA=1!(IBXA=2) D CLAMT^IBECEAU1(IBCLST,IBDOL,IBCLDA)
"RTN","IBECEAU",85,0)
 I IBXA=3 D CLINP^IBECEAU1(IBDAYPR,IBDAY,IBCLDA)
"RTN","IBECEAU",86,0)
 Q
"RTN","IBECEAU",87,0)
 ;
"RTN","IBECEAU",88,0)
 ;IB*2.0*651 - added new duplicate check for medical copays for the date period listed by the copay.
"RTN","IBECEAU",89,0)
 ;
"RTN","IBECEAU",90,0)
BFCHK(DFN,DATE) ;
"RTN","IBECEAU",91,0)
 ; Input:    DFN  --  Pointer to the patient in file #2
"RTN","IBECEAU",92,0)
 ;         SDATE  --  Start Date of the Patient Visit (inpatient or outpatient)
"RTN","IBECEAU",93,0)
 ;         EDATE  --  (Optional) End Date of the Patient Visit (inpatient only)
"RTN","IBECEAU",94,0)
 ;
"RTN","IBECEAU",95,0)
 ; Output:     0  --  Not billed the OPT copay on the visit date
"RTN","IBECEAU",96,0)
 ;            >0  --  Pointer to charge in file #350 that was billed
"RTN","IBECEAU",97,0)
 ;
"RTN","IBECEAU",98,0)
 N IBATYP,IBATYPN,IBL,IBND,IBN,Y,SDATE,IBFLG,EDATEH,DATEH,IBLPDT
"RTN","IBECEAU",99,0)
 I '$G(DFN)!'$G(DATE) G BFCHKQ
"RTN","IBECEAU",100,0)
 S EDATE=$G(IBTO)  ; ensuring optional end date is initialized.
"RTN","IBECEAU",101,0)
 I EDATE="" S EDATE=DATE    ;define it
"RTN","IBECEAU",102,0)
 ;
"RTN","IBECEAU",103,0)
 ;Set the correct starting date for the lookup
"RTN","IBECEAU",104,0)
 ;S SDATE=$S($D(^IB("AFDT",DFN,-DATE)):-DATE,1:$O(^IB("AFDT",DFN,-DATE)))
"RTN","IBECEAU",105,0)
 ;
"RTN","IBECEAU",106,0)
 ; Check for entries within the given start and end date range
"RTN","IBECEAU",107,0)
 ;convert to internal dates
"RTN","IBECEAU",108,0)
 S DATEH=$P($$F2H^XLFDT(DATE),","),EDATEH=$P($$F2H^XLFDT(EDATE),",")
"RTN","IBECEAU",109,0)
 F IBLPDT=DATEH:1:EDATEH D  Q:Y
"RTN","IBECEAU",110,0)
 . S Y=0
"RTN","IBECEAU",111,0)
 . ;Convert looping date back to Fileman Date Format
"RTN","IBECEAU",112,0)
 . S SDATE=$$H2F^XLFDT(IBLPDT)
"RTN","IBECEAU",113,0)
 . ;Set the correct starting date for the lookup
"RTN","IBECEAU",114,0)
 . S SDATE=$S($D(^IB("AFDT",DFN,-SDATE)):-SDATE,1:$O(^IB("AFDT",DFN,-SDATE)))
"RTN","IBECEAU",115,0)
 . Q:SDATE=""
"RTN","IBECEAU",116,0)
 . S IBN=0 F  S IBN=$O(^IB("AFDT",DFN,SDATE,IBN)) Q:'IBN  D  I 'IBFLG I $P(IBATYPN,"^",11)'=5,"^1^3^"[("^"_$P(IBATYP,"^",5)_"^"),"^1^2^3^4^8^20^"[("^"_+$P(IBND,"^",5)_"^") S Y=IBL Q
"RTN","IBECEAU",117,0)
 .. S IBFLG=0
"RTN","IBECEAU",118,0)
 .. S IBL=$$LAST(+$P($G(^IB(IBN,0)),"^",9)),IBND=$G(^IB(IBL,0)),IBFDT=$P(IBND,U,14),IBTDT=$P(IBND,U,15)
"RTN","IBECEAU",119,0)
 .. S DATEL=-SDATE
"RTN","IBECEAU",120,0)
 .. I (DATE<IBFDT)!(DATE>IBTDT) S IBFLG=1 Q    ;DATE BEING CHECK
"RTN","IBECEAU",121,0)
 .. S IBATYP=$G(^IBE(350.1,+$P(IBND,"^",3),0))      ;Grab the action type for the Copay
"RTN","IBECEAU",122,0)
 .. S IBATYPN=$G(^IBE(350.1,+$P(IBATYP,"^",9),0))   ;Grab the associated new Action Type for the Copay
"RTN","IBECEAU",123,0)
 .. I IBXA=3,$P(IBATYPN,U,11)<3 S IBFLG=1 Q    ;Allow Inpatient Per Diem on an Inpatient Copay
"RTN","IBECEAU",124,0)
 ;
"RTN","IBECEAU",125,0)
BFCHKQ Q +$G(Y)
"RTN","IBJDF41")
0^6^B109334665^B109334634
"RTN","IBJDF41",1,0)
IBJDF41 ;ALB/RB - FIRST PARTY FOLLOW-UP REPORT (COMPILE) ;15-APR-00
"RTN","IBJDF41",2,0)
 ;;2.0;INTEGRATED BILLING;**123,159,204,356,451,473,568,618,651**;21-MAR-94;Build 9
"RTN","IBJDF41",3,0)
 ;;Per VA Directive 6402, this routine should not be modified.
"RTN","IBJDF41",4,0)
 ;
"RTN","IBJDF41",5,0)
ST ; - Tasked entry point.
"RTN","IBJDF41",6,0)
 K IB,IBCAT,^TMP("IBJDF4",$J)
"RTN","IBJDF41",7,0)
 S IBQ=0
"RTN","IBJDF41",8,0)
 ;
"RTN","IBJDF41",9,0)
 ; - Set selected categories for report.
"RTN","IBJDF41",10,0)
 I IBSEL[1 S IBCAT(2)=1
"RTN","IBJDF41",11,0)
 I IBSEL[2 S IBCAT(1)=2
"RTN","IBJDF41",12,0)
 I IBSEL[3 S IBCAT(18)=3 F X=22,23 S IBCAT(X)=3
"RTN","IBJDF41",13,0)
 I IBSEL[4 F X=33:1:39 S IBCAT(X)=4
"RTN","IBJDF41",14,0)
 ; *** new code
"RTN","IBJDF41",15,0)
 I IBSEL[5 D
"RTN","IBJDF41",16,0)
 . F X=61:1:74 S IBCAT(X)=5
"RTN","IBJDF41",17,0)
 . F X=81:1:85 S IBCAT(X)=5
"RTN","IBJDF41",18,0)
 ;
"RTN","IBJDF41",19,0)
 ; - Print the header line for the Excel spreadsheet
"RTN","IBJDF41",20,0)
 I $G(IBEXCEL) D PHDL
"RTN","IBJDF41",21,0)
 ;
"RTN","IBJDF41",22,0)
 ; - Find data required for report.
"RTN","IBJDF41",23,0)
 F IB=16,19,40 D  G:IBQ ENQ
"RTN","IBJDF41",24,0)
 . I IBSTA="A",IB'=16 Q  ;      Active AR's only.
"RTN","IBJDF41",25,0)
 . I IBSTA="S",IB=16 Q   ;      Suspended AR's only.
"RTN","IBJDF41",26,0)
 . I IB'=40 D 
"RTN","IBJDF41",27,0)
 . . S IBCAT=""
"RTN","IBJDF41",28,0)
 . . F  S IBCAT=$O(IBCAT(IBCAT)) Q:IBCAT=""  D
"RTN","IBJDF41",29,0)
 . . . D INIT^IBJDF43
"RTN","IBJDF41",30,0)
 . S IBA=0
"RTN","IBJDF41",31,0)
 . F  S IBA=$O(^PRCA(430,"AC",IB,IBA)) Q:'IBA  D  Q:IBQ
"RTN","IBJDF41",32,0)
 . . D PROC
"RTN","IBJDF41",33,0)
 ;
"RTN","IBJDF41",34,0)
 I 'IBQ,'$G(IBEXCEL) D EN^IBJDF42 ; Print the report.
"RTN","IBJDF41",35,0)
 ;
"RTN","IBJDF41",36,0)
ENQ K ^TMP("IBJDF4",$J)
"RTN","IBJDF41",37,0)
 I $D(ZTQUEUED) S ZTREQ="@" G ENQ1
"RTN","IBJDF41",38,0)
 ;
"RTN","IBJDF41",39,0)
 D ^%ZISC
"RTN","IBJDF41",40,0)
ENQ1 K IB,IB0,IBA,IBA1,IBADM,IBAGE,IBAR,IBAR1,IBBA,IBBN,IBBU,IBC,IBCAT,IBCAT1
"RTN","IBJDF41",41,0)
 K IBELIG,IBEXCEL,IBFLG,IBAI,IBAIQ,IBIDX,IBIO,IBINT,IBN,IBPA,IBPD,IBPAT
"RTN","IBJDF41",42,0)
 K IBPT,IBQ,IBRFD,IBRFT,IBSRC,IBRP,IBVA,COM,COM1,DAT,DFN,X,X1,X2,Y,Z
"RTN","IBJDF41",43,0)
 Q
"RTN","IBJDF41",44,0)
 ;
"RTN","IBJDF41",45,0)
PROC ; - Process data for report(s).
"RTN","IBJDF41",46,0)
 I IBA#100=0 D  Q:IBQ
"RTN","IBJDF41",47,0)
 . S IBQ=$$STOP^IBOUTL("First Party Follow-Up Report")
"RTN","IBJDF41",48,0)
 S IBAR=$G(^PRCA(430,IBA,0)) I 'IBAR Q
"RTN","IBJDF41",49,0)
 S IBCAT=+$P(IBAR,U,2) I '$D(IBCAT(IBCAT)) Q  ; Get valid AR category.
"RTN","IBJDF41",50,0)
 I '$$CLMACT^IBJD(IBA,IBCAT) Q  ;               Invalid IB claim/action.
"RTN","IBJDF41",51,0)
 S IBSUSTYP=""
"RTN","IBJDF41",52,0)
 I IB=40 S IBSUSTYP=$$SUST(IBA)
"RTN","IBJDF41",53,0)
 I IBSTA="S",IBSELST'[(","_IBSUSTYP_",") Q  ;   Filter by suspended type IB*2*568/DRF
"RTN","IBJDF41",54,0)
 S IBPT=$$PAT(IBA) I IBPT="" Q  ;               Get patient info.
"RTN","IBJDF41",55,0)
 S DFN=$P(IBPT,U,2)
"RTN","IBJDF41",56,0)
 S IBAGE=$$FMDIFF^XLFDT(DT,+$P(IBAR,U,10))
"RTN","IBJDF41",57,0)
 I IBSMN,IBAGE<IBSMN!(IBAGE>IBSMX) Q  ;         AR outside age range.
"RTN","IBJDF41",58,0)
 S IBVA=$$VA^IBJD1(DFN),IBBN=$P(IBAR,U),IBPD=$P($$PYMT^IBJD1(IBA),U)
"RTN","IBJDF41",59,0)
 S IBPAT=$P(IBPT,U)_"@@"_DFN
"RTN","IBJDF41",60,0)
 ;
"RTN","IBJDF41",61,0)
 ; - Check the AR balance amounts, if necessary.
"RTN","IBJDF41",62,0)
 S (IBADM,IBBA,IBINT,IBPA)=0,IBN=$G(^PRCA(430,IBA,7))
"RTN","IBJDF41",63,0)
 F X=1:1:5 D
"RTN","IBJDF41",64,0)
 . S IBBA=IBBA+$P(IBN,U,X)
"RTN","IBJDF41",65,0)
 . S:X=1 IBPA=+IBN S:X=2 IBINT=$P(IBN,U,2) S:X=3 IBADM=$P(IBN,U,3)
"RTN","IBJDF41",66,0)
 ;
"RTN","IBJDF41",67,0)
 I '$G(IBEXCEL) D EN^IBJDF43 I IBRPT="S" Q  ;   Get summary stats.
"RTN","IBJDF41",68,0)
 ;
"RTN","IBJDF41",69,0)
 I IBSAM,IBBA<IBSAM Q
"RTN","IBJDF41",70,0)
 ;
"RTN","IBJDF41",71,0)
 ; - Check if AR was referred to R-Regional Counsel, D-DMC, T-TOP,
"RTN","IBJDF41",72,0)
 ;   or C-CROSS SERVICING and exclude, if necessary.
"RTN","IBJDF41",73,0)
 S IB0=$S(IB=40:19,1:IB),IBIDX=0,IBRFT=""
"RTN","IBJDF41",74,0)
 S IBAIQ=0,IBAI=$G(^TMP("IBJDF4",$J,IBPAT,0,"A"))
"RTN","IBJDF41",75,0)
 S IBRFD=$P($G(^PRCA(430,IBA,6)),U,4)
"RTN","IBJDF41",76,0)
 I IBRPT="D",IBRFD D  I IBAIQ Q                   ; Referred to RC
"RTN","IBJDF41",77,0)
 . S IBRFT="R" I IBAI'["R" S IBAI=IBAI_"R"
"RTN","IBJDF41",78,0)
 . I 'IBSRC S IBAIQ=1 Q
"RTN","IBJDF41",79,0)
 . D SREF("R",IBRFD,IB0,,.IBIDX)
"RTN","IBJDF41",80,0)
 S IBRFD=+$G(^PRCA(430,IBA,12))
"RTN","IBJDF41",81,0)
 I IBRPT="D",IBRFD D                              ; Referred to DMC
"RTN","IBJDF41",82,0)
 . S IBRFT=IBRFT_"D" I IBAI'["D" S IBAI=IBAI_"D"
"RTN","IBJDF41",83,0)
 . D SREF("D",IBRFD,IB0,,.IBIDX)
"RTN","IBJDF41",84,0)
 S IBRFD=+$G(^PRCA(430,IBA,14))
"RTN","IBJDF41",85,0)
 I IBRPT="D",IBRFD D                              ; Referred to TOP
"RTN","IBJDF41",86,0)
 . S IBRFT=IBRFT_"T" I IBAI'["T" S IBAI=IBAI_"T"
"RTN","IBJDF41",87,0)
 . D SREF("T",IBRFD,IB0,,.IBIDX)
"RTN","IBJDF41",88,0)
 ; PRCA*4.5*338 added CS 
"RTN","IBJDF41",89,0)
 S IBRFD=+$G(^PRCA(430,IBA,15))
"RTN","IBJDF41",90,0)
 I IBRPT="D",IBRFD D                              ; Referred to CS 
"RTN","IBJDF41",91,0)
 . S IBRFT=IBRFT_"C" I IBAI'["C" S IBAI=IBAI_"C"
"RTN","IBJDF41",92,0)
 . D SREF("C",IBRFD,IB0,,.IBIDX)
"RTN","IBJDF41",93,0)
 ;
"RTN","IBJDF41",94,0)
 ; - Check if AR is on P-Repayment plan or F-Defaulted repayment plan.
"RTN","IBJDF41",95,0)
 ;   and exclude if repayment plan is active.
"RTN","IBJDF41",96,0)
 S IBRP=$$RP(IBA)
"RTN","IBJDF41",97,0)
 I IBRP D
"RTN","IBJDF41",98,0)
 . I IBRP=2 S IBRFT=IBRFT_"F"  I IBAI'["F" S IBAI=IBAI_"F"
"RTN","IBJDF41",99,0)
 . I IBRP=1 S IBRFT=IBRFT_"P" I IBAI'["P"&(IBAI'["F") S IBAI=IBAI_"P"
"RTN","IBJDF41",100,0)
 . D SREF("P",$P(IBRP,"^",2),IB0,$S(+IBRP=2:1,1:0),.IBIDX)
"RTN","IBJDF41",101,0)
 ;
"RTN","IBJDF41",102,0)
 I IBIDX S IBFLG=1
"RTN","IBJDF41",103,0)
 ;
"RTN","IBJDF41",104,0)
 ; - Check if VA Employee
"RTN","IBJDF41",105,0)
 I $P(IBVA,"^")["*",IBAI'["V" S IBAI=IBAI_"V"
"RTN","IBJDF41",106,0)
 ;
"RTN","IBJDF41",107,0)
 I IBAI'="" S ^TMP("IBJDF4",$J,IBPAT,0,"A")=IBAI
"RTN","IBJDF41",108,0)
 ;
"RTN","IBJDF41",109,0)
 ; IB*2.0*451 - Check for EEOB on associated 3rd party bills and attach EOB indicator '%' if applicable
"RTN","IBJDF41",110,0)
 S IBBN=$$IBEEOBCK(IBBN,DFN)_IBBN  ; Pass AR BILL#, Pat ID
"RTN","IBJDF41",111,0)
 ;
"RTN","IBJDF41",112,0)
 ; - Set up indexes for detail report.
"RTN","IBJDF41",113,0)
 I $G(IBEXCEL) D  Q
"RTN","IBJDF41",114,0)
 . S IBEXCEL1=$P($G(^PRCA(430.2,IBCAT,0)),U,2)_U_$P(IBPT,U,3)_U_$P(IBVA,U)_U_$P(IBPT,U,4)_U_$$DT^IBJD($P(IBPT,U,6),1)_U_$$ELIG^IBJDF42(+$P(IBPT,U,5))_U
"RTN","IBJDF41",115,0)
 . S IBEXCEL1=IBEXCEL1_$$GET1^DIQ(2,DFN,.381)_U_$$MTRX(DFN)_U_IBBN_U_$S(IB=16:"A",1:"S")_U_$S("BS"[IBSTA:$$ABBR($G(IBSUSTYP)),1:"")_U_IBRFT_U_$$DT^IBJD($P(IBAR,U,10),1)_U_$$DT^IBJD(IBPD,1)_U_IBBA_U_IBPA_U_IBINT_U_IBADM_U
"RTN","IBJDF41",116,0)
 . I IBSH D COM
"RTN","IBJDF41",117,0)
 . S IBD=0 I DAT!IBPD S IBD=$$FMDIFF^XLFDT(DT,$S('DAT:IBPD,1:$G(DAT)))
"RTN","IBJDF41",118,0)
 . S IBEXCEL1=IBEXCEL1_U_IBD
"RTN","IBJDF41",119,0)
 . W !,IBEXCEL1 K IBD,IBEXCEL1
"RTN","IBJDF41",120,0)
 ;
"RTN","IBJDF41",121,0)
 I '($D(^TMP("IBJDF4",$J,IBPAT))#10) D
"RTN","IBJDF41",122,0)
 . S ^TMP("IBJDF4",$J,IBPAT)=$P(IBPT,U,3,5)_U_$$MTRX(DFN)_U_$P(IBPT,U,6)_"^"_$P(IBVA,"^",2)_"^"_$$ACCBAL($P(IBPT,U,7))
"RTN","IBJDF41",123,0)
 S ^TMP("IBJDF4",$J,IBPAT,IB0,IBCAT,IBBN)=IBPD_U_IBBA_U_IBPA_U_IBINT_U_IBADM_U_IBIDX_U_$S($D(IBSUSTYP):IBSUSTYP,1:"")
"RTN","IBJDF41",124,0)
 ;
"RTN","IBJDF41",125,0)
 I IBSH D COM
"RTN","IBJDF41",126,0)
 Q
"RTN","IBJDF41",127,0)
 ;
"RTN","IBJDF41",128,0)
ACCBAL(DFN) ; Calculates the Account Balance for the Bill
"RTN","IBJDF41",129,0)
 ; Input: DFN - Patient/Debtor internal number
"RTN","IBJDF41",130,0)
 ; Output: BAL - Patient/Debtor Account Balance
"RTN","IBJDF41",131,0)
 ;
"RTN","IBJDF41",132,0)
 N B0,B7,BAL,BILL,I
"RTN","IBJDF41",133,0)
 S (BAL,BILL)=0
"RTN","IBJDF41",134,0)
 F  S BILL=$O(^PRCA(430,"C",DFN,BILL)) Q:BILL=""  D
"RTN","IBJDF41",135,0)
 . S B0=$G(^PRCA(430,BILL,0)) I $P(B0,"^",8)'=16 Q
"RTN","IBJDF41",136,0)
 . S B7=$G(^PRCA(430,BILL,7))
"RTN","IBJDF41",137,0)
 . F I=1:1:5 S BAL=BAL+$P(B7,"^",I)
"RTN","IBJDF41",138,0)
 Q BAL
"RTN","IBJDF41",139,0)
 ;
"RTN","IBJDF41",140,0)
PHDL ; - Print the header line for the Excel spreadsheet
"RTN","IBJDF41",141,0)
 N X
"RTN","IBJDF41",142,0)
 S X="Cat^Patient^VA Empl.?^SSN^Dt Death^Prim.Elig.^Med.Elig.?^"
"RTN","IBJDF41",143,0)
 S X=X_"Means Tst Sts^Means Tst Dt^RX Copay Exemp.Sts^RX Copay Exemp.Dt^"
"RTN","IBJDF41",144,0)
 S X=X_"Bill #^Act/Susp^Reason^Refer. to^Dt Bill prep.^Last Pymt Dt^" ;Added reason IB*2*568/DRF
"RTN","IBJDF41",145,0)
 S X=X_"Curr.Bal.^Princ.Bal.^Int.^Admin.^Last Comm.Dt^Days Lst Comm.^"
"RTN","IBJDF41",146,0)
 W !,X
"RTN","IBJDF41",147,0)
 Q
"RTN","IBJDF41",148,0)
 ;
"RTN","IBJDF41",149,0)
PAT(X) ; - Find the AR patient and decide to include the AR.
"RTN","IBJDF41",150,0)
 ;    Input: X=AR pointer to file #430 and pre-set variables IBS*
"RTN","IBJDF41",151,0)
 ;   Output: Y=Sort key (name or last 4) ^ Patient pointer to file #2 
"RTN","IBJDF41",152,0)
 ;             ^ Name ^ SSN ^ Eligibilities ^ Date of death (if any)
"RTN","IBJDF41",153,0)
 ;             ^ Debtor pointer to file #340
"RTN","IBJDF41",154,0)
 N PAT,KEY,DBTR,DFN,DEATH,NAME,SSN,VAEL,VADM,X1,X2
"RTN","IBJDF41",155,0)
 S PAT="" G:'$G(X) PATQ
"RTN","IBJDF41",156,0)
 S DBTR=+$P($G(^PRCA(430,X,0)),U,9)
"RTN","IBJDF41",157,0)
 S X1=$P($G(^RCD(340,DBTR,0)),U) G:X1'["DPT" PATQ
"RTN","IBJDF41",158,0)
 S DFN=+X1 G:'DFN PATQ D DEM^VADPT
"RTN","IBJDF41",159,0)
 S NAME=VADM(1),SSN=$P(VADM(2),"^"),DEATH=VADM(6)\1
"RTN","IBJDF41",160,0)
 S KEY=$S(IBSN="N":NAME,1:$E(SSN,6,9))
"RTN","IBJDF41",161,0)
 I KEY=""!(IBSNF'="@"&('DFN)) G PATQ
"RTN","IBJDF41",162,0)
 I $D(IBSNA) G:IBSNA="ALL"&('DFN) PATQ G:IBSNA="NULL"&(DFN) PATQ
"RTN","IBJDF41",163,0)
 I $G(IBSNA)="ALL" G PATC
"RTN","IBJDF41",164,0)
 I IBSNF="@",IBSNL="zzzzz" G PATC
"RTN","IBJDF41",165,0)
 I IBSNF'=KEY,IBSNF]KEY G PATQ
"RTN","IBJDF41",166,0)
 I IBSNL'=KEY,KEY]IBSNL G PATQ
"RTN","IBJDF41",167,0)
 ;
"RTN","IBJDF41",168,0)
PATC ; - Set patient eligibilities.
"RTN","IBJDF41",169,0)
 D ELIG^VADPT S X2=+$G(VAEL(1))_";"
"RTN","IBJDF41",170,0)
 I +X2 S X1=0 F  S X1=$O(VAEL(1,X1)) Q:'X1  S X2=X2_X1_";"
"RTN","IBJDF41",171,0)
 ;
"RTN","IBJDF41",172,0)
 S PAT=KEY_U_DFN_U_$E(NAME,1,26)_U_SSN_U_X2_U_DEATH
"RTN","IBJDF41",173,0)
 S PAT=PAT_U_DBTR
"RTN","IBJDF41",174,0)
PATQ Q PAT
"RTN","IBJDF41",175,0)
 ;
"RTN","IBJDF41",176,0)
RP(X) ; - Check if claim/receivable is under a repayment plan.
"RTN","IBJDF41",177,0)
 ;    Input: X=Bill pointer to file #399/#430
"RTN","IBJDF41",178,0)
 ;   Output: 0-Not on repay plan, 1-On repay plan, 2-On defaulted plan
"RTN","IBJDF41",179,0)
 N Z
"RTN","IBJDF41",180,0)
 S Z=$$REPDATA^RCBECHGA(X,1) I Z="" Q 0
"RTN","IBJDF41",181,0)
 I '$P(Z,"^",7) Q ("1^"_$P(Z,"^"))
"RTN","IBJDF41",182,0)
 Q ("2^"_$P(Z,"^"))
"RTN","IBJDF41",183,0)
 ;
"RTN","IBJDF41",184,0)
MTRX(X) ; - Return patient's means test and/or RX copay status and most recent
"RTN","IBJDF41",185,0)
 ;   test dates for both.
"RTN","IBJDF41",186,0)
 ;    Input: X=Patient pointer to file #2 and opt. variable IBEXCEL
"RTN","IBJDF41",187,0)
 ;   Output: Y=Means test status ^ Date ^ RX copay status ^ Date 
"RTN","IBJDF41",188,0)
 N MTST,RXST,Y
"RTN","IBJDF41",189,0)
 S Y="^^^",MTST=$$LST^DGMTU(X),RXST=$$RXST^IBARXEU(X)
"RTN","IBJDF41",190,0)
 I '$G(IBEXCEL) D
"RTN","IBJDF41",191,0)
 . S $P(Y,"^",1,2)=$P(MTST,"^",3)_"^"_$$DAT1^IBOUTL($P(MTST,"^",2))
"RTN","IBJDF41",192,0)
 . S $P(Y,"^",3)=$S('RXST:"NON-EXEMPT",+RXST=1:"EXEMPT",1:"")
"RTN","IBJDF41",193,0)
 . I $P(Y,"^",3)'="" S $P(Y,"^",4)=$$DAT1^IBOUTL($P(RXST,"^",5))
"RTN","IBJDF41",194,0)
 I $G(IBEXCEL) D
"RTN","IBJDF41",195,0)
 . S $P(Y,"^",1,2)=$P(MTST,"^",4)_"^"_$$DT^IBJD($P(MTST,"^",2),1)
"RTN","IBJDF41",196,0)
 . S $P(Y,"^",3)=$S('RXST:"M",+RXST=1:"E",1:"")
"RTN","IBJDF41",197,0)
 . I $P(Y,"^",3)'="" S $P(Y,"^",4)=$$DT^IBJD($P(RXST,"^",5),1)
"RTN","IBJDF41",198,0)
 Q Y
"RTN","IBJDF41",199,0)
 ;
"RTN","IBJDF41",200,0)
SREF(RFT,DAT,STS,DEF,IDX) ; Set the "referred to" information on the 
"RTN","IBJDF41",201,0)
 ;                         temporary global ^TMP
"RTN","IBJDF41",202,0)
 ;Input: RFT: "R": RC, "D": DMC, "T": TOP, "C": CROSS SERVICING, "P": REPAYMENT PLAN
"RTN","IBJDF41",203,0)
 ;       DAT: Date it was referred/established
"RTN","IBJDF41",204,0)
 ;       STS: Receivable status (16-Active,19-Suspended)
"RTN","IBJDF41",205,0)
 ;       DEF: Repayment Plan in Default? (1 - YES, 0 - NO)
"RTN","IBJDF41",206,0)
 ;       IDX: Subscript to be set in the Temporary global ^TMP
"RTN","IBJDF41",207,0)
 ;Output: IDX: Subscript set in the Temporary global ^TMP
"RTN","IBJDF41",208,0)
 ;
"RTN","IBJDF41",209,0)
 N SREF,IDX1
"RTN","IBJDF41",210,0)
 S DEF=+$G(DEF),IDX=+$G(IDX)
"RTN","IBJDF41",211,0)
 I RFT="R" S SREF="REFERRED TO RC"
"RTN","IBJDF41",212,0)
 I RFT="D" S SREF="REFERRED TO DMC"
"RTN","IBJDF41",213,0)
 I RFT="T" S SREF="REFERRED TO TOP"
"RTN","IBJDF41",214,0)
 I RFT="C" S SREF="REFERRED TO CS" ; PRCA*4.5*338
"RTN","IBJDF41",215,0)
 I RFT="P" D
"RTN","IBJDF41",216,0)
 . S SREF="REPAYMENT PLAN ESTABLISHED"
"RTN","IBJDF41",217,0)
 . I $G(DEF) S SREF=SREF_" (CURRENTLY IN DEFAULT)"
"RTN","IBJDF41",218,0)
 ;
"RTN","IBJDF41",219,0)
 I 'IDX S IDX=$O(^TMP("IBJDF4",$J,IBPAT,0,"C",STS,""),-1)+1
"RTN","IBJDF41",220,0)
 S IDX1=$O(^TMP("IBJDF4",$J,IBPAT,0,"C",STS,IDX,""),-1)+1
"RTN","IBJDF41",221,0)
 S ^TMP("IBJDF4",$J,IBPAT,0,"C",STS,IDX,IDX1)=DAT
"RTN","IBJDF41",222,0)
 S ^TMP("IBJDF4",$J,IBPAT,0,"C",STS,IDX,IDX1,1)=SREF
"RTN","IBJDF41",223,0)
 Q
"RTN","IBJDF41",224,0)
 ;
"RTN","IBJDF41",225,0)
COM ; - Get bill comments.
"RTN","IBJDF41",226,0)
 I 'IBIDX,'$G(IBEXCEL) D
"RTN","IBJDF41",227,0)
 . S IBFLG=0,IBIDX=$O(^TMP("IBJDF4",$J,IBPAT,0,"C",IB0,""),-1)+1
"RTN","IBJDF41",228,0)
 ;
"RTN","IBJDF41",229,0)
 S DAT=0,IBA1=$S(IBSH1="M":999999999,1:0)
"RTN","IBJDF41",230,0)
 F  S IBA1=$S(IBSH1="M":$O(^PRCA(433,"C",IBA,IBA1),-1),1:$O(^PRCA(433,"C",IBA,IBA1))) Q:'IBA1  D  I IBSH1="M",DAT Q
"RTN","IBJDF41",231,0)
 . S IBC=$G(^PRCA(433,IBA1,1)) Q:'IBC
"RTN","IBJDF41",232,0)
 . I $G(IBSH2),$$FMDIFF^XLFDT(DT,+IBC)>IBSH2 Q  ; Comment age not minimum.
"RTN","IBJDF41",233,0)
 . I $P(IBC,U,2)'=35,$P(IBC,U,2)'=45 Q  ;   Not decrease/comment transact.
"RTN","IBJDF41",234,0)
 . S DAT=$S(IBC:+IBC\1,1:+$P(IBC,U,9)\1)
"RTN","IBJDF41",235,0)
 . I $G(IBEXCEL),IBSH1="M" S IBEXCEL1=IBEXCEL1_$$DT^IBJD(DAT,1) Q
"RTN","IBJDF41",236,0)
 . ;
"RTN","IBJDF41",237,0)
 . ; - Append brief and transaction comments.
"RTN","IBJDF41",238,0)
 . K COM,COM1 S COM(0)=DAT,X1=0
"RTN","IBJDF41",239,0)
 . S COM1(1)=$P($G(^PRCA(433,IBA1,5)),U,2)
"RTN","IBJDF41",240,0)
 . S COM1(2)=$E($P($G(^PRCA(433,IBA1,8)),U,6),1,70)
"RTN","IBJDF41",241,0)
 . S COM(1)=COM1(1)_$S(COM1(1)]""&(COM1(2)]""):"|",1:"")_COM1(2)
"RTN","IBJDF41",242,0)
 . I COM(1)]"" S COM(1)="**"_COM(1)_"**",X1=1
"RTN","IBJDF41",243,0)
 . ;
"RTN","IBJDF41",244,0)
 . ; - Get main comments.
"RTN","IBJDF41",245,0)
 . S X2=0
"RTN","IBJDF41",246,0)
 . F  S X2=$O(^PRCA(433,IBA1,7,X2)) Q:'X2  D
"RTN","IBJDF41",247,0)
 . . S COM($S(X1:X2+1,1:X2))=^PRCA(433,IBA1,7,X2,0)
"RTN","IBJDF41",248,0)
 . ;
"RTN","IBJDF41",249,0)
 . I $G(IBEXCEL) Q
"RTN","IBJDF41",250,0)
 . ;
"RTN","IBJDF41",251,0)
 . S IBFLG=1,^TMP("IBJDF4",$J,IBPAT,0,"C",IB0,IBIDX,IBA1)=$G(COM(0)),X1=0
"RTN","IBJDF41",252,0)
 . F  S X1=$O(COM(X1)) Q:X1=""  D
"RTN","IBJDF41",253,0)
 . . S ^TMP("IBJDF4",$J,IBPAT,0,"C",IB0,IBIDX,IBA1,X1)=COM(X1)
"RTN","IBJDF41",254,0)
 ;
"RTN","IBJDF41",255,0)
 I '$G(IBEXCEL),IBFLG D
"RTN","IBJDF41",256,0)
 . S $P(^TMP("IBJDF4",$J,IBPAT,IB0,IBCAT,IBBN),"^",6)=IBIDX
"RTN","IBJDF41",257,0)
 Q
"RTN","IBJDF41",258,0)
 ; IB*2.0*451 -  Use Event Date to find an associated 3rd Party bill with an associated EEOB
"RTN","IBJDF41",259,0)
IBEEOBCK(IBBN,DFN) ; Passed AR Bill, Patient ID
"RTN","IBJDF41",260,0)
 ; Function will quit as soon as a 3rd party bill is located that has an associated EEOB
"RTN","IBJDF41",261,0)
 ;
"RTN","IBJDF41",262,0)
 ; Find 3rd Party Bills with an Event Date
"RTN","IBJDF41",263,0)
 N IBREF,IBEEOB,IBDT
"RTN","IBJDF41",264,0)
 S IBEEOB=""
"RTN","IBJDF41",265,0)
 ; Loop through Xref of ARbill (#430) to Action file (#350)
"RTN","IBJDF41",266,0)
 I +$G(IBBN) S IBREF=0 F  S IBREF=$O(^IB("ABIL",IBBN,IBREF)) Q:'IBREF  D  Q:IBEEOB="%"
"RTN","IBJDF41",267,0)
 . S IBDT=$P($G(^IB(IBREF,0)),"^",17) ;Get event Date
"RTN","IBJDF41",268,0)
 . I IBDT S IBEEOB=$$TPEVDT(DFN,IBDT)
"RTN","IBJDF41",269,0)
 . I IBDT S IBEEOB=$$TPOPV(DFN,IBDT)
"RTN","IBJDF41",270,0)
 ;
"RTN","IBJDF41",271,0)
 Q IBEEOB
"RTN","IBJDF41",272,0)
 ;
"RTN","IBJDF41",273,0)
 ; IB*2.0*451 - Traverse all THIRD PARTY bills for a patient with a specific Event Date (399,.03)
"RTN","IBJDF41",274,0)
TPEVDT(DFN,EVDT) ;
"RTN","IBJDF41",275,0)
 ; Function will quit as soon as a 3rd party bill is located that has an associated EEOB
"RTN","IBJDF41",276,0)
 ; IB*2.0*473 - Use the 399,"APDT" (by patient) index instead of the 399,"D" index for efficiency
"RTN","IBJDF41",277,0)
 I '$G(DFN)!'$G(EVDT) Q ""
"RTN","IBJDF41",278,0)
 N IBIFN,IBEEOB
"RTN","IBJDF41",279,0)
 S IBEEOB="",IBIFN=""
"RTN","IBJDF41",280,0)
 F  S IBIFN=$O(^DGCR(399,"APDT",DFN,IBIFN),-1) Q:'IBIFN  D  Q:IBEEOB="%"
"RTN","IBJDF41",281,0)
 . I $D(^DGCR(399,"APDT",DFN,IBIFN,9999999-EVDT)) S IBEEOB=$$EEOBCK(IBIFN)
"RTN","IBJDF41",282,0)
 Q IBEEOB
"RTN","IBJDF41",283,0)
 ; 
"RTN","IBJDF41",284,0)
 ; IB*2.0*451 - Traverse all THIRD PARTY bills for a patient with any Opt Visit Dates same as Event Date (399,43)
"RTN","IBJDF41",285,0)
TPOPV(DFN,EVDT) ;
"RTN","IBJDF41",286,0)
 ; Function will quit as soon as a 3rd party bill is located that has an associated EEOB
"RTN","IBJDF41",287,0)
 N IBIFN,IBEEOB
"RTN","IBJDF41",288,0)
 S IBEEOB=""
"RTN","IBJDF41",289,0)
 I +$G(DFN),+$G(EVDT) S IBIFN=0 F  S IBIFN=$O(^DGCR(399,"AOPV",DFN,EVDT,IBIFN)) Q:'IBIFN  D  Q:IBEEOB="%"
"RTN","IBJDF41",290,0)
 . ; attach EOB indicator '%' to bill # when applicable
"RTN","IBJDF41",291,0)
 . S IBEEOB=$$EEOBCK(IBIFN)
"RTN","IBJDF41",292,0)
 Q IBEEOB
"RTN","IBJDF41",293,0)
 ;
"RTN","IBJDF41",294,0)
 ; IB*2.0*451 - Check for EEOB indicator
"RTN","IBJDF41",295,0)
EEOBCK(IBBILL)  ;
"RTN","IBJDF41",296,0)
 ; Check for 1st and 3rd party payment activity on bill
"RTN","IBJDF41",297,0)
 ; IBBILL is the IEN for the bill # in files #399/#430 and must be valid,
"RTN","IBJDF41",298,0)
 ; check the EOB type and exclude it if it is an MRA. Otherwise,
"RTN","IBJDF41",299,0)
 ; returns the EEOB indicator '%' if payment activity was found.
"RTN","IBJDF41",300,0)
 ; Access to file #361.1 covered by IA #4051.
"RTN","IBJDF41",301,0)
 ; Access to file #399 covered by IA #3820.
"RTN","IBJDF41",302,0)
 N IBOUT,IBVAL,Z
"RTN","IBJDF41",303,0)
 I $G(IBBILL)=0 Q ""
"RTN","IBJDF41",304,0)
 I '$O(^IBM(361.1,"B",IBBILL,0)) Q ""  ; no entry here
"RTN","IBJDF41",305,0)
 I $P($G(^DGCR(399,IBBILL,0)),"^",13)=1 Q ""  ;avoid 'ENTERED/NOT REVIEWED' status
"RTN","IBJDF41",306,0)
 ; handle both single and multiple bill entries in file #361.1
"RTN","IBJDF41",307,0)
 S Z=0 F  S Z=$O(^IBM(361.1,"B",IBBILL,Z)) Q:'Z  D  Q:$G(IBOUT)="%"
"RTN","IBJDF41",308,0)
 . S IBVAL=$G(^IBM(361.1,Z,0))
"RTN","IBJDF41",309,0)
 . S IBOUT=$S($P(IBVAL,"^",4)=1:"",$P(IBVAL,"^",4)=0:"%",1:"")
"RTN","IBJDF41",310,0)
 Q IBOUT  ; EOB indicator for either 1st or 3rd party payment on bill
"RTN","IBJDF41",311,0)
 ;
"RTN","IBJDF41",312,0)
 ;
"RTN","IBJDF41",313,0)
SUST(IBA) ;Look for suspended type for a suspended bill IB*2*568/DRF
"RTN","IBJDF41",314,0)
 N TRANS,ST
"RTN","IBJDF41",315,0)
 S IBA=$G(IBA) I IBA="" Q ""
"RTN","IBJDF41",316,0)
 S ST=""
"RTN","IBJDF41",317,0)
 S TRANS=$O(^PRCA(433,"C",IBA,""),-1)
"RTN","IBJDF41",318,0)
 S ST=$P($G(^PRCA(433,TRANS,1)),U,11)
"RTN","IBJDF41",319,0)
 I ST="" S ST=12 ;Added option for NONE
"RTN","IBJDF41",320,0)
 Q ST
"RTN","IBJDF41",321,0)
 ;
"RTN","IBJDF41",322,0)
 ;
"RTN","IBJDF41",323,0)
ABBR(SUSP) ;Return abbreviation for suspended bill types IB*2*568/DRF
"RTN","IBJDF41",324,0)
 S SUSP=$G(SUSP)
"RTN","IBJDF41",325,0)
 I SUSP=0 Q "NonCoS"
"RTN","IBJDF41",326,0)
 I SUSP=1 Q "IniCoS"
"RTN","IBJDF41",327,0)
 I SUSP=2 Q "AplCoW"
"RTN","IBJDF41",328,0)
 I SUSP=3 Q "AdminS"
"RTN","IBJDF41",329,0)
 I SUSP=4 Q "Compro"
"RTN","IBJDF41",330,0)
 I SUSP=5 Q "Termin"
"RTN","IBJDF41",331,0)
 I SUSP=6 Q "BnkCh7"
"RTN","IBJDF41",332,0)
 I SUSP=7 Q "BnkC13"
"RTN","IBJDF41",333,0)
 I SUSP=8 Q "BnkOth"
"RTN","IBJDF41",334,0)
 I SUSP=9 Q "Probat"
"RTN","IBJDF41",335,0)
 I SUSP=10 Q "Choice"
"RTN","IBJDF41",336,0)
 I SUSP=11 Q "Disput"
"RTN","IBJDF41",337,0)
 I SUSP=12 Q "None"
"RTN","IBJDF41",338,0)
 Q ""
"RTN","IBJDF42")
0^7^B65746972^B65167304
"RTN","IBJDF42",1,0)
IBJDF42 ;ALB/RB - FIRST PARTY FOLLOW-UP REPORT (PRINT);15-APR-00
"RTN","IBJDF42",2,0)
 ;;2.0;INTEGRATED BILLING;**123,204,568,618,651**;21-MAR-94;Build 9
"RTN","IBJDF42",3,0)
 ;;Per VA Directive 6402, this routine should not be modified.
"RTN","IBJDF42",4,0)
 ;
"RTN","IBJDF42",5,0)
EN ; - Print the Follow-up report.
"RTN","IBJDF42",6,0)
 ;
"RTN","IBJDF42",7,0)
 S IBCT(1)="INELIGIBLE",IBCT(2)="EMERG/HUMAN.",IBCT(18)="C MEANS TEST"
"RTN","IBJDF42",8,0)
 S IBCT(22)="RX COPAY/SC",IBCT(23)="RX COPAY/NSC"
"RTN","IBJDF42",9,0)
 S IBCT(33)="ADHC LTC"
"RTN","IBJDF42",10,0)
 S IBCT(34)="DOM LTC"
"RTN","IBJDF42",11,0)
 S IBCT(35)="RESPITE INPT LTC"
"RTN","IBJDF42",12,0)
 S IBCT(36)="RESPITE OPT LTC"
"RTN","IBJDF42",13,0)
 S IBCT(37)="GERIATRIC INPT LTC"
"RTN","IBJDF42",14,0)
 S IBCT(38)="GERIATRIC OPT LTC"
"RTN","IBJDF42",15,0)
 S IBCT(39)="NURSING HOME LTC"
"RTN","IBJDF42",16,0)
 ;
"RTN","IBJDF42",17,0)
 ; PRCA*4.5*338 Adding new categories for community care
"RTN","IBJDF42",18,0)
 ;
"RTN","IBJDF42",19,0)
 ; next are the new AR categories
"RTN","IBJDF42",20,0)
 S IBCT(61)="CHOICE INPT"
"RTN","IBJDF42",21,0)
 S IBCT(62)="CHOICE RX CO-PAYMENT"
"RTN","IBJDF42",22,0)
 S IBCT(63)="CC INPT"
"RTN","IBJDF42",23,0)
 S IBCT(64)="CC RX CO-PAYMENT"
"RTN","IBJDF42",24,0)
 S IBCT(65)="CCN INPT"
"RTN","IBJDF42",25,0)
 S IBCT(66)="CCN RX CO-PAYMENT"
"RTN","IBJDF42",26,0)
 S IBCT(67)="CC MTF INPT"
"RTN","IBJDF42",27,0)
 S IBCT(68)="CC MTF RX CO-PAYMENT"
"RTN","IBJDF42",28,0)
 S IBCT(69)="CC NURSING HOME CARE - LTC"
"RTN","IBJDF42",29,0)
 S IBCT(70)="CC RESPITE CARE"
"RTN","IBJDF42",30,0)
 S IBCT(71)="CCN NURSING HOME CARE - LTC"
"RTN","IBJDF42",31,0)
 S IBCT(72)="CCN RESPITE CARE"
"RTN","IBJDF42",32,0)
 S IBCT(73)="CHOICE NURSING HOME CARE - LTC"
"RTN","IBJDF42",33,0)
 S IBCT(74)="CHOICE RESPITE CARE"
"RTN","IBJDF42",34,0)
 S IBCT(81)="CHOICE OPT"
"RTN","IBJDF42",35,0)
 S IBCT(82)="CC OPT"
"RTN","IBJDF42",36,0)
 S IBCT(83)="CCN OPT"
"RTN","IBJDF42",37,0)
 S IBCT(84)="CC MTF OPT"
"RTN","IBJDF42",38,0)
 S IBCT(85)="CC URGENT CARE"     ;IB*2.0*651 - added
"RTN","IBJDF42",39,0)
 ;
"RTN","IBJDF42",40,0)
 S IBQ=0 D NOW^%DTC S IBRUN=$$DAT2^IBOUTL(%) G:IBRPT="S" SUM
"RTN","IBJDF42",41,0)
 S IBPRTFLG=0 D DET D PAUSE:'IBPRTFLG I IBQ!'IBPRTFLG G ENQ
"RTN","IBJDF42",42,0)
 ;
"RTN","IBJDF42",43,0)
 D PAUSE I IBQ G ENQ
"RTN","IBJDF42",44,0)
 ;
"RTN","IBJDF42",45,0)
SUM I 'IBQ D PRT^IBJDF43 ; Print summary.
"RTN","IBJDF42",46,0)
ENQ K IB0,IBAI,IBC,IBCAT,IBCD,IBC1,IBC2,IBCT,IBCNT,IBN,IBP,IBPAG,IBQ,IBRUN,IBS
"RTN","IBJDF42",47,0)
 K IBST,IBTOT,%,DFN,IBPRTFLG
"RTN","IBJDF42",48,0)
 Q
"RTN","IBJDF42",49,0)
 ;
"RTN","IBJDF42",50,0)
DET ; - Print report for a specific category.
"RTN","IBJDF42",51,0)
 ;
"RTN","IBJDF42",52,0)
 D HDR1 G:IBQ DETQ
"RTN","IBJDF42",53,0)
 S (IBPT,IB,IBCAT,IB0)=""
"RTN","IBJDF42",54,0)
 F  S IBPT=$O(^TMP("IBJDF4",$J,IBPT)) Q:IBPT=""  D  Q:IBQ
"RTN","IBJDF42",55,0)
 . I $O(^TMP("IBJDF4",$J,IBPT,0))="" Q
"RTN","IBJDF42",56,0)
 . S IBP=$G(^TMP("IBJDF4",$J,IBPT))
"RTN","IBJDF42",57,0)
 . I $Y>(IOSL-14) D PAUSE Q:IBQ  D HDR1 Q:IBQ
"RTN","IBJDF42",58,0)
 . D WPAT
"RTN","IBJDF42",59,0)
 . F IB=16,19 D  Q:IBQ
"RTN","IBJDF42",60,0)
 . . I IBSTA="A",IB'=16 Q
"RTN","IBJDF42",61,0)
 . . I IBSTA="S",IB=16 Q
"RTN","IBJDF42",62,0)
 . . I '$D(^TMP("IBJDF4",$J,IBPT,IB)) D  Q
"RTN","IBJDF42",63,0)
 . . . I $Y>(IOSL-5) D PAUSE Q:IBQ  D HDR1,WPAT,HDR2 Q:IBQ
"RTN","IBJDF42",64,0)
 . . . W !,"-> NO "_$S(IB=16:"ACTIVE",1:"SUSPENDED")_" BILLS."
"RTN","IBJDF42",65,0)
 . . I $Y>(IOSL-9) D PAUSE Q:IBQ  D HDR1,WPAT Q:IBQ
"RTN","IBJDF42",66,0)
 . . D HDR2
"RTN","IBJDF42",67,0)
 . . K IBFLG S IBTOT="",IBCNT=0
"RTN","IBJDF42",68,0)
 . . F  S IBCAT=$O(^TMP("IBJDF4",$J,IBPT,IB,IBCAT)) Q:IBCAT=""  D  Q:IBQ
"RTN","IBJDF42",69,0)
 . . . F  S IB0=$O(^TMP("IBJDF4",$J,IBPT,IB,IBCAT,IB0)) Q:IB0=""  D  Q:IBQ
"RTN","IBJDF42",70,0)
 . . . . S IBN=$G(^TMP("IBJDF4",$J,IBPT,IB,IBCAT,IB0))
"RTN","IBJDF42",71,0)
 . . . . I $Y>(IOSL-5) D PAUSE Q:IBQ  D HDR1,WPAT,HDR2 Q:IBQ
"RTN","IBJDF42",72,0)
 . . . . D WBIL Q:IBQ
"RTN","IBJDF42",73,0)
 . . . . S IBCNT=IBCNT+1
"RTN","IBJDF42",74,0)
 . . . I 'IBQ,$O(^TMP("IBJDF4",$J,IBPT,IB,IBCAT))="" D
"RTN","IBJDF42",75,0)
 . . . . D TOT W !
"RTN","IBJDF42",76,0)
 . . ; - Display bill comment history, if selected.
"RTN","IBJDF42",77,0)
 . . S IBPRTFLG=1
"RTN","IBJDF42",78,0)
 . . D WCOM(IBPT,IB)
"RTN","IBJDF42",79,0)
 ;
"RTN","IBJDF42",80,0)
 I 'IBPRTFLG D
"RTN","IBJDF42",81,0)
 . W !!!!!!,"There are no receivables for the parameters entered."
"RTN","IBJDF42",82,0)
 ;
"RTN","IBJDF42",83,0)
DETQ Q
"RTN","IBJDF42",84,0)
 ;
"RTN","IBJDF42",85,0)
WPAT ; - Write patient data.
"RTN","IBJDF42",86,0)
 N I,X
"RTN","IBJDF42",87,0)
 S DFN=$P(IBPT,"@@",2),IBAI=$G(^TMP("IBJDF4",$J,IBPT,0,"A"))
"RTN","IBJDF42",88,0)
 W !!,"Patient Name     : ",$P(IBP,U) W:IBAI["V" " *"
"RTN","IBJDF42",89,0)
 W ?63,"SSN: ",$$SSN($P(IBP,U,2)),!,"Means Test Status: ",$P(IBP,U,4)
"RTN","IBJDF42",90,0)
 W:$P(IBP,U,5)'="" " ("_$P(IBP,U,5)_")"
"RTN","IBJDF42",91,0)
 W ?58,"Medicaid: ",$$GET1^DIQ(2,DFN,.381)
"RTN","IBJDF42",92,0)
 W !,"RX Copay Status  : ",$P(IBP,U,6)
"RTN","IBJDF42",93,0)
 W:$P(IBP,U,7)'="" " ("_$P(IBP,U,7)_")"
"RTN","IBJDF42",94,0)
 W:$P(IBP,U,8) ?53,"Date of Death: ",$$DAT1^IBOUTL($P(IBP,U,8))
"RTN","IBJDF42",95,0)
 W !,"Eligibilities    : " S X=$$ELIG($P(IBP,U,3))
"RTN","IBJDF42",96,0)
 F I=1:1 Q:X=""  W ?19,$E(X,1,61) S X=$E(X,62,999) I X'="" W !
"RTN","IBJDF42",97,0)
 S X=$$INFO(IBAI)
"RTN","IBJDF42",98,0)
 I X'="" D
"RTN","IBJDF42",99,0)
 . W !,"Additional Info  : "
"RTN","IBJDF42",100,0)
 . F I=1:1 Q:X=""  W ?19,$E(X,1,61) S X=$E(X,62,999) I X'="" W !
"RTN","IBJDF42",101,0)
 ;
"RTN","IBJDF42",102,0)
 Q
"RTN","IBJDF42",103,0)
 ;
"RTN","IBJDF42",104,0)
WBIL ; - Write bill data.
"RTN","IBJDF42",105,0)
 W ! W:'$D(IBFLG(IBCAT)) $E(IBCT(IBCAT),1,11) W ?13,IB0   ;IB*2.0*618 - Limit length to 11 chars
"RTN","IBJDF42",106,0)
 W:$P(IBN,"^",6) ?25,$J("("_$P(IBN,"^",6)_")",4)
"RTN","IBJDF42",107,0)
 W ?30,$$DAT1^IBOUTL(+IBN)
"RTN","IBJDF42",108,0)
 W ?39,$J($FN($P(IBN,U,2),",",2),10),?50,$J($FN($P(IBN,U,3),",",2),10)
"RTN","IBJDF42",109,0)
 W ?61,$J($FN($P(IBN,U,4),",",2),9),?71,$J($FN($P(IBN,U,5),",",2),9)
"RTN","IBJDF42",110,0)
 I "SB"[IBSTA,$P(IBN,U,7)]"" W ?82,IBSUS($P(IBN,U,7))
"RTN","IBJDF42",111,0)
 S $P(IBTOT,"^")=$P(IBTOT,"^")+$P(IBN,U,2)
"RTN","IBJDF42",112,0)
 S $P(IBTOT,"^",2)=$P(IBTOT,"^",2)+$P(IBN,U,3)
"RTN","IBJDF42",113,0)
 S $P(IBTOT,"^",3)=$P(IBTOT,"^",3)+$P(IBN,U,4)
"RTN","IBJDF42",114,0)
 S $P(IBTOT,"^",4)=$P(IBTOT,"^",4)+$P(IBN,U,5)
"RTN","IBJDF42",115,0)
 S IBFLG(IBCAT)=""
"RTN","IBJDF42",116,0)
 Q
"RTN","IBJDF42",117,0)
 ;
"RTN","IBJDF42",118,0)
WCOM(IBPT,IB) ; - Write bill comments.
"RTN","IBJDF42",119,0)
 N CMDT,CONT,DIWL,DIWR,IBIDX,IBTR,IBLN,IBX,X
"RTN","IBJDF42",120,0)
 ;
"RTN","IBJDF42",121,0)
 S (IBIDX,IBTR,IBLN)="",DIWL=1,DIWR=64 K ^UTILITY($J,"W")
"RTN","IBJDF42",122,0)
 F  S IBIDX=$O(^TMP("IBJDF4",$J,IBPT,0,"C",IB,IBIDX)) Q:IBIDX=""  D  Q:IBQ
"RTN","IBJDF42",123,0)
 . I $Y>(IOSL-6) D WCPB Q:IBQ
"RTN","IBJDF42",124,0)
 . D WCD(IBIDX)
"RTN","IBJDF42",125,0)
 . F  S IBTR=$O(^TMP("IBJDF4",$J,IBPT,0,"C",IB,IBIDX,IBTR)) Q:IBTR=""  D  Q:IBQ
"RTN","IBJDF42",126,0)
 . . S CMDT=$G(^TMP("IBJDF4",$J,IBPT,0,"C",IB,IBIDX,IBTR))
"RTN","IBJDF42",127,0)
 . . I $Y>(IOSL-4) D WCPB Q:IBQ
"RTN","IBJDF42",128,0)
 . . S CONT=0 D WCD(,1,)
"RTN","IBJDF42",129,0)
 . . F  S IBLN=$O(^TMP("IBJDF4",$J,IBPT,0,"C",IB,IBIDX,IBTR,IBLN)) Q:IBLN=""  D  Q:IBQ
"RTN","IBJDF42",130,0)
 . . . S IBX=$G(^TMP("IBJDF4",$J,IBPT,0,"C",IB,IBIDX,IBTR,IBLN))
"RTN","IBJDF42",131,0)
 . . . I $E(IBX)=" ",$L(IBX)>1 S $E(IBX)=""
"RTN","IBJDF42",132,0)
 . . . S X=IBX D ^DIWP
"RTN","IBJDF42",133,0)
 . . . I 'CONT,$L(IBX)<66 D WCTX
"RTN","IBJDF42",134,0)
 . . . S CONT=$L(IBX)>65
"RTN","IBJDF42",135,0)
 . . . I '$O(^TMP("IBJDF4",$J,IBPT,0,"C",IB,IBIDX,IBTR,IBLN)) D
"RTN","IBJDF42",136,0)
 . . . . D:$D(^UTILITY($J,"W")) WCTX
"RTN","IBJDF42",137,0)
 K ^UTILITY($J,"W")
"RTN","IBJDF42",138,0)
 Q
"RTN","IBJDF42",139,0)
 ;
"RTN","IBJDF42",140,0)
WCD(I,D,C) ; - Write the comment date.
"RTN","IBJDF42",141,0)
 ; Input: I - Index #         "(I)"
"RTN","IBJDF42",142,0)
 ;        D - Print the Date  " - MM/DD/YY"
"RTN","IBJDF42",143,0)
 ;        C - Print the Cont. "(Continued)"
"RTN","IBJDF42",144,0)
 ;
"RTN","IBJDF42",145,0)
 W:$G(I) !,"(",I,")" W:$G(D) ?3," - ",$$DAT1^IBOUTL(CMDT),": "
"RTN","IBJDF42",146,0)
 W:$G(C) "(Continued)",!
"RTN","IBJDF42",147,0)
 Q
"RTN","IBJDF42",148,0)
 ;
"RTN","IBJDF42",149,0)
WCTX ; - Write the comment text.
"RTN","IBJDF42",150,0)
 N LIN,WLIN,Z
"RTN","IBJDF42",151,0)
 S LIN=""
"RTN","IBJDF42",152,0)
 F  S LIN=$O(^UTILITY($J,"W",1,LIN)) Q:LIN=""  D  Q:IBQ
"RTN","IBJDF42",153,0)
 . S WLIN=$G(^UTILITY($J,"W",1,LIN,0)) Q:WLIN=""
"RTN","IBJDF42",154,0)
 . W ?16,WLIN
"RTN","IBJDF42",155,0)
 . I '$O(^UTILITY($J,"W",1,LIN)) W ! Q
"RTN","IBJDF42",156,0)
 . I $Y>(IOSL-4) D WCPB,WCD(IBIDX,1,1) Q
"RTN","IBJDF42",157,0)
 . W !
"RTN","IBJDF42",158,0)
 K ^UTILITY($J,"W")
"RTN","IBJDF42",159,0)
 Q
"RTN","IBJDF42",160,0)
 ;
"RTN","IBJDF42",161,0)
WCPB ; - Page Break in the middle of the Comments
"RTN","IBJDF42",162,0)
 D PAUSE Q:IBQ  D HDR1,WPAT W !!
"RTN","IBJDF42",163,0)
 Q
"RTN","IBJDF42",164,0)
 ;
"RTN","IBJDF42",165,0)
HDR1 ; - Write the report header.
"RTN","IBJDF42",166,0)
 N X,I
"RTN","IBJDF42",167,0)
 W:'$G(IBPAG) ! I $E(IOST,1,2)="C-"!$G(IBPAG) W @IOF,*13
"RTN","IBJDF42",168,0)
 S IBPAG=$G(IBPAG)+1 W "First Party Follow-Up Report"
"RTN","IBJDF42",169,0)
 W ?34,"Run Date: ",IBRUN,?71,"Page: ",$J(IBPAG,3)
"RTN","IBJDF42",170,0)
 S X="ALL "_$S(IBSTA'="S":"ACTIVE",1:"")_$S(IBSTA="B":" AND ",1:"")
"RTN","IBJDF42",171,0)
 S X=X_$S(IBSTA'="A":"SUSPENDED",1:"")_" RECEIVABLES"
"RTN","IBJDF42",172,0)
 I IBSMN'="A" S X=X_" OVER "_IBSMN_" AND UNDER "_IBSMX_" DAYS OLD"
"RTN","IBJDF42",173,0)
 S X=X_" / BY "_$S(IBSN="N":"NAME",1:"LAST 4 SSN")
"RTN","IBJDF42",174,0)
 S X=X_" ("_$S($G(IBSNA)="ALL":"ALL",1:"From "_$S(IBSNF="":"FIRST",1:IBSNF)_" to "_$S(IBSNL="zzzzz":"LAST",1:IBSNL))_")"
"RTN","IBJDF42",175,0)
 S X=X_" / "_$S('IBSAM:"NO ",1:"")_"MINIMUM BALANCE"
"RTN","IBJDF42",176,0)
 S X=X_$S(IBSAM:": $"_$FN(IBSAM,",",2),1:"")
"RTN","IBJDF42",177,0)
 S X=X_" / "_$S('IBSH:"NO ",IBSH1="A":"ALL ",1:"ONLY ")_"COMMENTS"
"RTN","IBJDF42",178,0)
 S X=X_$S($G(IBSH2):" LESS THAN "_IBSH2_" DAYS OLD",1:"")
"RTN","IBJDF42",179,0)
 S X=X_" / RECEIVABLES REFERRED TO RC "_$S('IBSRC:"NOT ",1:"")_"INCLUDED"
"RTN","IBJDF42",180,0)
 F I=1:1 W !,$E(X,1,80) S X=$E(X,81,999) I X="" Q
"RTN","IBJDF42",181,0)
 ;
"RTN","IBJDF42",182,0)
 S IBQ=$$STOP^IBOUTL("First Party Follow-Up Report")
"RTN","IBJDF42",183,0)
 Q
"RTN","IBJDF42",184,0)
 ;
"RTN","IBJDF42",185,0)
TYPE(SEL) ; Returns a string with the type of receivables (description)
"RTN","IBJDF42",186,0)
 ; selected or NULL if ALL receivable type have been selected.
"RTN","IBJDF42",187,0)
 ; SEL - User input for the parameter "Type of Receivable"
"RTN","IBJDF42",188,0)
 ;
"RTN","IBJDF42",189,0)
 N TYPE,I,X
"RTN","IBJDF42",190,0)
 I SEL="1,2,3," Q ""
"RTN","IBJDF42",191,0)
 S TYPE="",X="EMERGENCY/HUMANITARIAN^INELIGIBLE^C-MEANS TEST & RX COPAY"
"RTN","IBJDF42",192,0)
 F I=2:1:($L(SEL,",")-1) D
"RTN","IBJDF42",193,0)
 . S TYPE=TYPE_$S(I=($L(SEL,",")-1)&(TYPE'=""):" AND ",1:", ")
"RTN","IBJDF42",194,0)
 . S TYPE=TYPE_$P(X,"^",+$P(SEL,",",I))
"RTN","IBJDF42",195,0)
 S $E(TYPE,1)=""
"RTN","IBJDF42",196,0)
 ;
"RTN","IBJDF42",197,0)
 Q TYPE
"RTN","IBJDF42",198,0)
 ;
"RTN","IBJDF42",199,0)
HDR2 ; - Write bill sub-header.
"RTN","IBJDF42",200,0)
 W ! I IBSTA="B" W !,$S(IB=16:"ACTIVE",1:"SUSPENDED")
"RTN","IBJDF42",201,0)
 W ! I IBSTA="B" W $S(IB=16:"======",1:"=========")
"RTN","IBJDF42",202,0)
 W:IBSH ?26,"COM" W ?30,"Last",?40,"Current",?51,"Principal"
"RTN","IBJDF42",203,0)
 W !,"Category",?13,"Bill Number",?26,"REF"
"RTN","IBJDF42",204,0)
 W ?30,"Payment",?40,"Balance",?51,"Balance",?62,"Interest",?72,"Admin."
"RTN","IBJDF42",205,0)
 I "BS"[IBSTA W ?82,"Suspended Type"
"RTN","IBJDF42",206,0)
 W !,$$DASH(96,1)
"RTN","IBJDF42",207,0)
 Q
"RTN","IBJDF42",208,0)
 ;
"RTN","IBJDF42",209,0)
TOT ; - Write balance total for patient.
"RTN","IBJDF42",210,0)
 N I,J
"RTN","IBJDF42",211,0)
 I IBCNT>1 W ! F I=40,51,62,72 W ?I,$E("---------",1,$S(I>60:8,1:9))
"RTN","IBJDF42",212,0)
 W:IBCNT'>1 !
"RTN","IBJDF42",213,0)
 W !,"Account Balance: $"_$FN($P(IBP,"^",10),",",2)
"RTN","IBJDF42",214,0)
 I IBCNT'>1 Q
"RTN","IBJDF42",215,0)
 S J=1 F I=39,50,60,70 W ?I,$J($FN($P(IBTOT,"^",J),",",2),10) S J=J+1
"RTN","IBJDF42",216,0)
 Q
"RTN","IBJDF42",217,0)
 ;
"RTN","IBJDF42",218,0)
DASH(X,Y) ; - Return a dashed line.
"RTN","IBJDF42",219,0)
 Q $TR($J("",X)," ",$S(Y:"-",1:"="))
"RTN","IBJDF42",220,0)
 ;
"RTN","IBJDF42",221,0)
ELIG(X) ; - Return eligibility code name.
"RTN","IBJDF42",222,0)
 ; X - Eligibility codes separated by semi-collon (;)
"RTN","IBJDF42",223,0)
 ;
"RTN","IBJDF42",224,0)
 N ELIG,I
"RTN","IBJDF42",225,0)
 S ELIG="" F I=1:1:$L(X,";") D
"RTN","IBJDF42",226,0)
 . I '$P(X,";",I) Q
"RTN","IBJDF42",227,0)
 . S ELIG=ELIG_", "_$E($P($G(^DIC(8,+$P(X,";",I),0)),U),1,20)
"RTN","IBJDF42",228,0)
 S $E(ELIG,1,2)=""
"RTN","IBJDF42",229,0)
 ;
"RTN","IBJDF42",230,0)
 Q ELIG
"RTN","IBJDF42",231,0)
 ;
"RTN","IBJDF42",232,0)
INFO(X) ; - Return the patient Additional Information about the Patient Accout
"RTN","IBJDF42",233,0)
 ; X - Flags representing the observations
"RTN","IBJDF42",234,0)
 ;
"RTN","IBJDF42",235,0)
 N INFO,I
"RTN","IBJDF42",236,0)
 S INFO="" F I=1:1:$L(X) D
"RTN","IBJDF42",237,0)
 . I $E(X,I)="V" S INFO=INFO_", '*' - VA EMPLOYEE"
"RTN","IBJDF42",238,0)
 . I $E(X,I)="R" S INFO=INFO_", REFERRED TO RC"
"RTN","IBJDF42",239,0)
 . I $E(X,I)="D" S INFO=INFO_", REFERRED TO DMC"
"RTN","IBJDF42",240,0)
 . I $E(X,I)="T" S INFO=INFO_", REFERRED TO TOP"
"RTN","IBJDF42",241,0)
 . I $E(X,I)="P" S INFO=INFO_", UNDER REPAYMENT PLAN"
"RTN","IBJDF42",242,0)
 . I $E(X,I)="F" S INFO=INFO_", UNDER DEFAULTED REPAYMENT PLAN"
"RTN","IBJDF42",243,0)
 S $E(INFO,1,2)=""
"RTN","IBJDF42",244,0)
 ;
"RTN","IBJDF42",245,0)
 Q INFO
"RTN","IBJDF42",246,0)
 ;
"RTN","IBJDF42",247,0)
SSN(X) ; - Format the SSN.
"RTN","IBJDF42",248,0)
 Q $S(X]"":$E(X,1,3)_"-"_$E(X,4,5)_"-"_$E(X,6,10),1:"")
"RTN","IBJDF42",249,0)
 ;
"RTN","IBJDF42",250,0)
PAUSE ; - Page break.
"RTN","IBJDF42",251,0)
 I $E(IOST,1,2)'="C-" Q
"RTN","IBJDF42",252,0)
 N IBX,DIR,DIRUT,DUOUT,DTOUT,DIROUT,X,Y
"RTN","IBJDF42",253,0)
 F IBX=$Y:1:(IOSL-3) W !
"RTN","IBJDF42",254,0)
 S DIR(0)="E" D ^DIR S:$D(DIRUT)!($D(DUOUT)) IBQ=1
"RTN","IBJDF42",255,0)
 Q
"RTN","IBOHLD1")
0^5^B22293700^B21577919
"RTN","IBOHLD1",1,0)
IBOHLD1 ;ALB/CJM -  REPORT OF CHARGES ON HOLD W/INS INFO ;MARCH 3 1992
"RTN","IBOHLD1",2,0)
 ;;2.0;INTEGRATED BILLING;**70,95,133,356,347,618,651**;21-MAR-94;Build 9
"RTN","IBOHLD1",3,0)
 ;;Per VA Directive 6402, this routine should not be modified.
"RTN","IBOHLD1",4,0)
 ;
"RTN","IBOHLD1",5,0)
 ; modified HELD CHARGES REPORT - includes INS info
"RTN","IBOHLD1",6,0)
 ;
"RTN","IBOHLD1",7,0)
MAIN ;
"RTN","IBOHLD1",8,0)
 N IBQUIT,IBII,DIRUT,DUOUT,DTOUT,ZTIO,Y S IBQUIT=0
"RTN","IBOHLD1",9,0)
 S DIR(0)="Y",DIR("A")="Include Insurance information on this report",DIR("B")="NO"
"RTN","IBOHLD1",10,0)
 S DIR("?",1)="     Enter:  'Y'  -  to include patient insurance information on this report"
"RTN","IBOHLD1",11,0)
 S DIR("?",2)="             'N'  -  to exclude patient insurance information on this report"
"RTN","IBOHLD1",12,0)
 S DIR("?",3)="             '^'  -  to exit this option"
"RTN","IBOHLD1",13,0)
 D ^DIR K DIR G:$D(DIRUT) EXIT S IBII=+Y
"RTN","IBOHLD1",14,0)
 ;
"RTN","IBOHLD1",15,0)
QUEUED ; entry point if queued
"RTN","IBOHLD1",16,0)
 ;***
"RTN","IBOHLD1",17,0)
 K ^TMP($J)
"RTN","IBOHLD1",18,0)
 D:'$G(IBQUIT) DEVICE D:'$G(IBQUIT) CHRGS,REPORT^IBOHLD2
"RTN","IBOHLD1",19,0)
 D EXIT
"RTN","IBOHLD1",20,0)
 ;***
"RTN","IBOHLD1",21,0)
 Q
"RTN","IBOHLD1",22,0)
EXIT ;
"RTN","IBOHLD1",23,0)
 K ^TMP($J)
"RTN","IBOHLD1",24,0)
 K IBRDT,IBRF,IBRX,IBRXN
"RTN","IBOHLD1",25,0)
 I $D(ZTQUEUED) S ZTREQ="@" Q
"RTN","IBOHLD1",26,0)
 D ^%ZISC
"RTN","IBOHLD1",27,0)
 Q
"RTN","IBOHLD1",28,0)
DEVICE ;
"RTN","IBOHLD1",29,0)
 I $D(ZTQUEUED) Q
"RTN","IBOHLD1",30,0)
 W !!,*7,"*** Margin width of this output is 132 ***"
"RTN","IBOHLD1",31,0)
 W !,"*** This output should be queued ***"
"RTN","IBOHLD1",32,0)
 S %ZIS="QM" D ^%ZIS I POP S IBQUIT=1 Q
"RTN","IBOHLD1",33,0)
 I $D(IO("Q")) D  Q
"RTN","IBOHLD1",34,0)
 . S ZTRTN="QUEUED^IBOHLD1"
"RTN","IBOHLD1",35,0)
 . S ZTIO=ION_";"_IOST_";"_IOM_";"_IOSL
"RTN","IBOHLD1",36,0)
 . S ZTDESC="HELD CHARGES RPT W/INS"
"RTN","IBOHLD1",37,0)
 . S ZTSAVE("IB*")=""
"RTN","IBOHLD1",38,0)
 . D ^%ZTLOAD
"RTN","IBOHLD1",39,0)
 . W !,$S($D(ZTSK):"REQUEST QUEUED TASK="_ZTSK,1:"REQUEST CANCELLED")
"RTN","IBOHLD1",40,0)
 . D HOME^%ZIS K ZTSK S IBQUIT=1
"RTN","IBOHLD1",41,0)
 U IO
"RTN","IBOHLD1",42,0)
 Q
"RTN","IBOHLD1",43,0)
 ; indexes records that should be included in report
"RTN","IBOHLD1",44,0)
 ;
"RTN","IBOHLD1",45,0)
CHRGS ; charges on hold
"RTN","IBOHLD1",46,0)
 N IBN,DFN,IBNAME,IBND
"RTN","IBOHLD1",47,0)
 S DFN=0 F  S DFN=$O(^IB("AH",DFN)) Q:'DFN  D PAT S IBN=0 F  S IBN=$O(^IB("AH",DFN,IBN)) Q:'IBN  D
"RTN","IBOHLD1",48,0)
 .S IBND=$G(^IB(IBN,0)) Q:'IBND
"RTN","IBOHLD1",49,0)
 .S ^TMP($J,"HOLD",IBNAME,DFN,IBN)=""
"RTN","IBOHLD1",50,0)
 .D BILLS
"RTN","IBOHLD1",51,0)
 Q
"RTN","IBOHLD1",52,0)
PAT ; patient name
"RTN","IBOHLD1",53,0)
 N VAERR,VADM D DEM^VADPT I VAERR K VADM
"RTN","IBOHLD1",54,0)
 S IBNAME=$G(VADM(1)) S:IBNAME="" IBNAME=" "
"RTN","IBOHLD1",55,0)
 Q
"RTN","IBOHLD1",56,0)
BILLS ; find bills for charges on hold
"RTN","IBOHLD1",57,0)
 N IBFR,IBT,IBATYPE,IBTO
"RTN","IBOHLD1",58,0)
 ;***IB*2.0*618
"RTN","IBOHLD1",59,0)
 ; Look up the type to match to using the Action Type name
"RTN","IBOHLD1",60,0)
 S IBATYPE=$$FNDBTYP($P(IBND,"^",3))   ;end IB*2.0*618
"RTN","IBOHLD1",61,0)
 S IBFR=$P(IBND,"^",14),IBTO=$P(IBND,"^",15)
"RTN","IBOHLD1",62,0)
 I IBATYPE="I" D INP
"RTN","IBOHLD1",63,0)
 I IBATYPE="O" D OTP
"RTN","IBOHLD1",64,0)
 E  D RX
"RTN","IBOHLD1",65,0)
 Q
"RTN","IBOHLD1",66,0)
 ;
"RTN","IBOHLD1",67,0)
FNDBTYP(IBACTIEN) ;Determine what type of 3rd party bill to try and match the
"RTN","IBOHLD1",68,0)
 ;                 held charge to.
"RTN","IBOHLD1",69,0)
 ; INPUT - IB Action Type IEN (350.1,.01)
"RTN","IBOHLD1",70,0)
 ;
"RTN","IBOHLD1",71,0)
 N IBACTPNM
"RTN","IBOHLD1",72,0)
 ;
"RTN","IBOHLD1",73,0)
 S IBACTPNM=$P($G(^IBE(350.1,IBACTIEN,0)),"^")
"RTN","IBOHLD1",74,0)
 I IBACTPNM["OPT" Q "O"
"RTN","IBOHLD1",75,0)
 I IBACTPNM["URGENT" Q "O"   ;IB*2.0*651 - add CC URGENT CARE as an outpatient
"RTN","IBOHLD1",76,0)
 I IBACTPNM["PSO" Q "RX"
"RTN","IBOHLD1",77,0)
 I IBACTPNM["RX" Q "O"  ;any other RX after PSO link to Outpatient
"RTN","IBOHLD1",78,0)
 Q "I"  ;assume inpatient if not matched above
"RTN","IBOHLD1",79,0)
 ;
"RTN","IBOHLD1",80,0)
INP ; inpatient bills
"RTN","IBOHLD1",81,0)
 N IBEV,IBBILL,IBT,X,X1,X2,IBEND,IBOK
"RTN","IBOHLD1",82,0)
 S IBEV=$P(IBND,"^",16) Q:'IBEV  ; parent event
"RTN","IBOHLD1",83,0)
 S IBEV=($P($G(^IB(IBEV,0)),"^",17)\1) Q:'IBEV  ; date of parent event
"RTN","IBOHLD1",84,0)
 S X1=IBEV,X2=1 D C^%DTC S IBEND=X
"RTN","IBOHLD1",85,0)
 S IBT=(IBEV-.0001) F  S IBT=$O(^DGCR(399,"D",IBT)) Q:'IBT!(IBT'<IBEND)  S IBBILL=0 F  S IBBILL=$O(^DGCR(399,"D",IBT,IBBILL)) Q:IBBILL=""  D
"RTN","IBOHLD1",86,0)
 .D INPTCK
"RTN","IBOHLD1",87,0)
 .I IBOK S ^TMP($J,"HOLD",IBNAME,DFN,IBN,IBBILL)=""
"RTN","IBOHLD1",88,0)
 Q
"RTN","IBOHLD1",89,0)
 ;
"RTN","IBOHLD1",90,0)
INPTCK ; does bill belong to charge? returns IBOK=0 if no
"RTN","IBOHLD1",91,0)
 N IBBILL0,IBBILLU
"RTN","IBOHLD1",92,0)
 S IBBILL0=$G(^DGCR(399,IBBILL,0)),IBBILLU=$G(^("U"))
"RTN","IBOHLD1",93,0)
 S IBOK=1
"RTN","IBOHLD1",94,0)
CK1 ; for same patient?
"RTN","IBOHLD1",95,0)
 I DFN=$P(IBBILL0,"^",2)
"RTN","IBOHLD1",96,0)
 S IBOK=$T
"RTN","IBOHLD1",97,0)
 Q:'IBOK
"RTN","IBOHLD1",98,0)
CK2 ; same type- inp or opt?
"RTN","IBOHLD1",99,0)
 N B S B=$S(+$P(IBBILL0,"^",5)<3:"I",1:"O")
"RTN","IBOHLD1",100,0)
 I B=IBATYPE
"RTN","IBOHLD1",101,0)
 S IBOK=$T
"RTN","IBOHLD1",102,0)
 Q:'IBOK
"RTN","IBOHLD1",103,0)
CK3 ; overlap in date range?
"RTN","IBOHLD1",104,0)
 N F,T
"RTN","IBOHLD1",105,0)
 S F=+IBBILLU,T=$P(IBBILLU,"^",2)
"RTN","IBOHLD1",106,0)
 I (IBTO<F)!(IBFR>T)
"RTN","IBOHLD1",107,0)
 S IBOK='$T
"RTN","IBOHLD1",108,0)
 Q:'IBOK
"RTN","IBOHLD1",109,0)
CK4 ; insurance bill?
"RTN","IBOHLD1",110,0)
 I $P(IBBILL0,"^",11)="i"
"RTN","IBOHLD1",111,0)
 S IBOK=$T
"RTN","IBOHLD1",112,0)
 Q
"RTN","IBOHLD1",113,0)
OTP ; outpatient bills
"RTN","IBOHLD1",114,0)
 N X,IBV,IBBILL,IBOK,IBBILL0
"RTN","IBOHLD1",115,0)
 S IBV=(IBFR\1)-.0001 F  S IBV=$O(^DGCR(399,"AOPV",DFN,IBV)) Q:'IBV!(IBV>IBTO)  S IBBILL=0 D
"RTN","IBOHLD1",116,0)
 .F  S IBBILL=$O(^DGCR(399,"AOPV",DFN,IBV,IBBILL)) Q:('IBBILL)  D
"RTN","IBOHLD1",117,0)
 ..Q:$D(^TMP($J,"HOLD",IBNAME,DFN,IBN,IBBILL))
"RTN","IBOHLD1",118,0)
 ..S IBBILL0=$G(^DGCR(399,IBBILL,0)) D CK4 Q:'IBOK
"RTN","IBOHLD1",119,0)
 ..S ^TMP($J,"HOLD",IBNAME,DFN,IBN,IBBILL)=""
"RTN","IBOHLD1",120,0)
 Q
"RTN","IBOHLD1",121,0)
RX ; rx refill bills
"RTN","IBOHLD1",122,0)
 S (IBRX,IBRXN,IBRF,IBRDT)=0 N IENS
"RTN","IBOHLD1",123,0)
 I $P(IBND,"^",4)'["52:" Q
"RTN","IBOHLD1",124,0)
 ;
"RTN","IBOHLD1",125,0)
 S IBRXN=$P($P(IBND,"^",4),":",2),IBRX=$P($P(IBND,"^",8),"-"),IBRF=$P($P(IBND,"^",4),":",3)
"RTN","IBOHLD1",126,0)
 ;
"RTN","IBOHLD1",127,0)
 I +IBRF>0 S IBRDT=$$SUBFILE^IBRXUTL(+IBRXN,IBRF,52,.01)
"RTN","IBOHLD1",128,0)
 I +IBRF=0 S IBRDT=$$FILE^IBRXUTL(+IBRXN,22)
"RTN","IBOHLD1",129,0)
 ;
"RTN","IBOHLD1",130,0)
 Q:(IBRX="")!('IBRDT)
"RTN","IBOHLD1",131,0)
 N X,IBBILL,IBBILL0,IBFILL,IBFILL0,IBOK S IBBILL=0
"RTN","IBOHLD1",132,0)
 S IBFILL=0 F  S IBFILL=$O(^IBA(362.4,"B",IBRX,IBFILL)) Q:IBFILL=""  D
"RTN","IBOHLD1",133,0)
 .S IBFILL0=$G(^IBA(362.4,IBFILL,0)) I $P(IBFILL0,"^",3)'=IBRDT Q
"RTN","IBOHLD1",134,0)
 .S IBBILL=+$P(IBFILL0,"^",2) I 'IBBILL Q
"RTN","IBOHLD1",135,0)
 .S IBBILL0=$G(^DGCR(399,IBBILL,0)) D CK4 I 'IBOK Q
"RTN","IBOHLD1",136,0)
 .S ^TMP($J,"HOLD",IBNAME,DFN,IBN,IBBILL)=""
"RTN","IBOHLD1",137,0)
 Q
"RTN","IBOHLD2")
0^9^B32743857^B32477589
"RTN","IBOHLD2",1,0)
IBOHLD2 ;ALB/CJM  -  REPORT OF CHARGES ON HOLD W/INS ;MAR 6,1991
"RTN","IBOHLD2",2,0)
 ;;2.0;INTEGRATED BILLING;**70,95,133,153,347,452,618,651**;21-MAR-94;Build 9
"RTN","IBOHLD2",3,0)
 ;;Per VA Directive 6402, this routine should not be modified.
"RTN","IBOHLD2",4,0)
 ;
"RTN","IBOHLD2",5,0)
 ; Reference to $$CLAIM^BPSBUTL supported by DBIA# 4719
"RTN","IBOHLD2",6,0)
REPORT ;
"RTN","IBOHLD2",7,0)
 N IBQUIT,IBPAGE,IBNOW,IBLINE,IBLINE2,IBCRT,IBBOT,DFN,IBNAME,IBN
"RTN","IBOHLD2",8,0)
 S IBCRT=0,IBBOT=7,IBQUIT=0 I $E(IOST,1,2)="C-" S IBCRT=1,IBBOT=7
"RTN","IBOHLD2",9,0)
 S IBLINE="",$P(IBLINE,"=",86)="||",IBLINE=IBLINE_$E(IBLINE,1,45)
"RTN","IBOHLD2",10,0)
 S IBLINE2="",$P(IBLINE2,"-",75)="--"
"RTN","IBOHLD2",11,0)
 D NOW^%DTC S Y=X X ^DD("DD") S IBNOW=Y
"RTN","IBOHLD2",12,0)
 I IBCRT W @IOF
"RTN","IBOHLD2",13,0)
LOOP ;
"RTN","IBOHLD2",14,0)
 S IBPAGE=1 D HEADER Q:IBQUIT
"RTN","IBOHLD2",15,0)
 S IBNAME="" F  S IBNAME=$O(^TMP($J,"HOLD",IBNAME)) Q:IBNAME=""!(IBQUIT)  S DFN=0 F  S DFN=$O(^TMP($J,"HOLD",IBNAME,DFN)) Q:'DFN!(IBQUIT)  D
"RTN","IBOHLD2",16,0)
 .D PRNTPAT,PRNTINS W:IBII ?35,IBLINE2,! Q:IBQUIT  S IBN=0 F  S IBN=$O(^TMP($J,"HOLD",IBNAME,DFN,IBN)) Q:'IBN!(IBQUIT)  D
"RTN","IBOHLD2",17,0)
 ..D PRNTCHG,PRNTBILL:'IBQUIT
"RTN","IBOHLD2",18,0)
 Q
"RTN","IBOHLD2",19,0)
PRNTBILL ; prints bills for a charge
"RTN","IBOHLD2",20,0)
 N IB,IB0,IBSTAT,IBCHG,IBPD,C,Y,I,IBT
"RTN","IBOHLD2",21,0)
 D:$Y+IBBOT>IOSL HEADER Q:IBQUIT
"RTN","IBOHLD2",22,0)
 S IB="" F I=1:1 S IB=$O(^TMP($J,"HOLD",IBNAME,DFN,IBN,IB)) W:'IB&(I<2) ?85,"||",! Q:'IB!(IBQUIT)  D
"RTN","IBOHLD2",23,0)
 .W ?85,"||"
"RTN","IBOHLD2",24,0)
 .S IB0=$G(^DGCR(399,IB,0)) Q:IB0=""
"RTN","IBOHLD2",25,0)
 .W ?88,$P(IB0,"^",1) ; bill #
"RTN","IBOHLD2",26,0)
 .S IBSTAT=$$STA^PRCAFN(IB)
"RTN","IBOHLD2",27,0)
 .W:+IBSTAT>0 ?97,$E($P(IBSTAT,"^",2),1,14)
"RTN","IBOHLD2",28,0)
 .S IBT=$J((+^DGCR(399,IB,"U1")-$P(^("U1"),"^",2)),9,2)
"RTN","IBOHLD2",29,0)
 .W ?112,IBT ; total charges
"RTN","IBOHLD2",30,0)
 .S IBPD=$$TPR^PRCAFN(IB) S:IBPD<0 IBPD="" S IBPD=$J(IBPD,9,2) W ?123,IBPD,! D:$Y+IBBOT>IOSL HEADER
"RTN","IBOHLD2",31,0)
 Q
"RTN","IBOHLD2",32,0)
PRNTPAT ; prints patient data
"RTN","IBOHLD2",33,0)
 N VAERR,VADM,IBSSN D DEM^VADPT S:'VAERR IBSSN=VA("BID") ; pt id,brief
"RTN","IBOHLD2",34,0)
 D:$Y+IBBOT>IOSL HEADER Q:IBQUIT
"RTN","IBOHLD2",35,0)
 W IBLINE,!
"RTN","IBOHLD2",36,0)
 W $E(IBNAME,1,20),?22,IBSSN
"RTN","IBOHLD2",37,0)
 W:IBII ?35,"Insurance Co.",?53,"Subscriber ID",?71,"Group",?88,"Eff Dt",?102,"Exp Dt",!
"RTN","IBOHLD2",38,0)
 Q
"RTN","IBOHLD2",39,0)
PRNTINS ; prints insurance information
"RTN","IBOHLD2",40,0)
 Q:'$D(DFN)!(IBII=0)
"RTN","IBOHLD2",41,0)
 N X,IBINS,IBX
"RTN","IBOHLD2",42,0)
 D ALL^IBCNS1(DFN,"IBINS")
"RTN","IBOHLD2",43,0)
 D:$Y+IBBOT>IOSL HEADER Q:IBQUIT
"RTN","IBOHLD2",44,0)
 W IBLINE,!
"RTN","IBOHLD2",45,0)
 I '$D(IBINS) W ?35,"No Insurance Information"
"RTN","IBOHLD2",46,0)
 S X=0 F  S X=$O(IBINS(X)) Q:'X  S IBINS=IBINS(X,0) D
"RTN","IBOHLD2",47,0)
 .D:$Y+IBBOT>IOSL HEADER Q:IBQUIT
"RTN","IBOHLD2",48,0)
 .N COV,COVD,COVFN,IBCNT,LEDT,LIM,PLN,SP,X,X1,X2,Z0 Q:'$D(IBINS)
"RTN","IBOHLD2",49,0)
 .W ?36,$S($D(^DIC(36,+IBINS,0)):$E($P(^(0),"^",1),1,16),1:"UNKNOWN")
"RTN","IBOHLD2",50,0)
 .W ?54,$E($P(IBINS,"^",2),1,16)
"RTN","IBOHLD2",51,0)
 .W ?72,$E($$GRP($P(IBINS,"^",18)),1,10) S PLN=$P(IBINS,"^",18)
"RTN","IBOHLD2",52,0)
 .W ?88,$$DAT1^IBOUTL($P(IBINS,"^",8)),?102,$$DAT1^IBOUTL($P(IBINS,"^",4))
"RTN","IBOHLD2",53,0)
 .I PLN="" W !,?38,"* No Group Plan Information for this Patient - Verify Insurance Info!",! Q
"RTN","IBOHLD2",54,0)
 .W !,?40,"Plan Coverage   Effective Date   Covered?     Limit Comments",!
"RTN","IBOHLD2",55,0)
 .W ?40,"-------------   --------------   --------     --------------",!
"RTN","IBOHLD2",56,0)
 .S LIM=0 F  S LIM=$O(^IBE(355.31,LIM)) Q:'LIM  S COV=$P($G(^(LIM,0)),U),IBCNT=0,LEDT="" F  S LEDT=$O(^IBA(355.32,"APCD",PLN,LIM,LEDT)) Q:$S(LEDT="":IBCNT,1:0)  D  Q:LEDT=""
"RTN","IBOHLD2",57,0)
 ..D:$Y+IBBOT>IOSL HEADER Q:IBQUIT
"RTN","IBOHLD2",58,0)
 ..S COVFN=+$O(^IBA(355.32,"APCD",PLN,LIM,+LEDT,"")),COVD=$G(^IBA(355.32,+COVFN,0))
"RTN","IBOHLD2",59,0)
 ..I COVD="" W ?40,COV,?86,"BY DEFAULT",! Q
"RTN","IBOHLD2",60,0)
 ..S IBCNT=IBCNT+1
"RTN","IBOHLD2",61,0)
 ..S X1="  "_$S(IBCNT=1:COV,1:"") ;Don't duplicate category
"RTN","IBOHLD2",62,0)
 ..S X2=$$PR(X1,18)_$$PR($$DAT1^IBOUTL($P(LEDT,"-",2)),16)_$$PR($S($P(COVD,U,4):$S($P(COVD,U,4)<2:"YES",$P(COVD,U,4)=2:"CONDITIONAL",1:"UNKNOWN"),1:"NO"),14)
"RTN","IBOHLD2",63,0)
 ..I '$O(^IBA(355.32,COVFN,2,0)) W ?40,X2,! Q
"RTN","IBOHLD2",64,0)
 ..S Z0=0 F  S Z0=$O(^IBA(355.32,COVFN,2,Z0)) Q:'Z0  S SP="" W ?40,$S(Z0=1:X2_$G(^IBA(355.32,COVFN,2,Z0,0)),1:$$PR(SP,48)_$G(^IBA(355.32,COVFN,2,Z0,0))),!
"RTN","IBOHLD2",65,0)
 Q
"RTN","IBOHLD2",66,0)
GRP(IBCPOL) ; get group name/group policy
"RTN","IBOHLD2",67,0)
 N X,Y S X=""
"RTN","IBOHLD2",68,0)
 S X=$G(^IBA(355.3,+$G(IBCPOL),0))
"RTN","IBOHLD2",69,0)
 S Y=$S($P(X,"^",4)'="":$P(X,"^",4),1:$P(X,"^",3))
"RTN","IBOHLD2",70,0)
 I $P(X,"^",10) S Y="Ind Plan "_Y
"RTN","IBOHLD2",71,0)
GRPQ Q Y
"RTN","IBOHLD2",72,0)
PR(STR,LEN) ; pad right
"RTN","IBOHLD2",73,0)
 N B S STR=$E(STR,1,LEN),$P(B," ",LEN-$L(STR))=" "
"RTN","IBOHLD2",74,0)
 Q STR_$G(B)
"RTN","IBOHLD2",75,0)
PRNTCHG ; prints a charge
"RTN","IBOHLD2",76,0)
 N IBACT,IBTYPE,IBBILL,IBFR,IBTO,IBCHG,IBND,IBND1
"RTN","IBOHLD2",77,0)
 N IBRX,IBRXN,IBRF,IBRDT,IBX,IENS,IBECME
"RTN","IBOHLD2",78,0)
 S IBND=$G(^IB(IBN,0))
"RTN","IBOHLD2",79,0)
 S IBND1=$G(^IB(IBN,1))
"RTN","IBOHLD2",80,0)
 S (IBRX,IBRXN,IBRF,IBRDT,IBX,IBECME)=0
"RTN","IBOHLD2",81,0)
 ; action id
"RTN","IBOHLD2",82,0)
 S IBACT=+IBND
"RTN","IBOHLD2",83,0)
 ; type
"RTN","IBOHLD2",84,0)
 ; begin of Patch IB*2.0*618 - added community care - action types to HELD CHARGES report
"RTN","IBOHLD2",85,0)
 S IBTYPE=$P(IBND,"^",3),IBTYPE=$P($G(^IBE(350.1,IBTYPE,0)),"^",1)
"RTN","IBOHLD2",86,0)
 S IBTYPE=$$IBACTYPE(IBTYPE)
"RTN","IBOHLD2",87,0)
 ; end of Patch IB*2.0*618
"RTN","IBOHLD2",88,0)
 ; bill #
"RTN","IBOHLD2",89,0)
 S IBBILL=$P($P(IBND,"^",11),"-",2)
"RTN","IBOHLD2",90,0)
 ; rx info
"RTN","IBOHLD2",91,0)
 I $P(IBND,"^",4)["52:" D
"RTN","IBOHLD2",92,0)
 . S IBRXN=+$P($P(IBND,"^",4),":",2)       ; Rx ien
"RTN","IBOHLD2",93,0)
 . S IBRX=$P($P(IBND,"^",8),"-")           ; external Rx#
"RTN","IBOHLD2",94,0)
 . S IBRF=+$P($P(IBND,"^",4),":",3)        ; fill# or 0 for original fill
"RTN","IBOHLD2",95,0)
 . S IBECME=$P($$CLAIM^BPSBUTL(IBRXN,IBRF),U,6)   ; ecme#  DBIA# 4719
"RTN","IBOHLD2",96,0)
 . I IBRF S IENS=+IBRF,IBRDT=$$SUBFILE^IBRXUTL(+IBRXN,+IENS,52,.01)    ; refill date
"RTN","IBOHLD2",97,0)
 . I 'IBRF S IENS=+IBRXN,IBRDT=$$FILE^IBRXUTL(+IENS,22)                ; orig fill date
"RTN","IBOHLD2",98,0)
 . Q
"RTN","IBOHLD2",99,0)
 ;
"RTN","IBOHLD2",100,0)
 S IBX=$$APPT^IBCU3(IBRDT,DFN)
"RTN","IBOHLD2",101,0)
 ; from/rx fill date
"RTN","IBOHLD2",102,0)
 S IBFR=$$DAT1^IBOUTL($S(IBRXN>0:IBRDT,1:$P(IBND,"^",15)))
"RTN","IBOHLD2",103,0)
 ; to date
"RTN","IBOHLD2",104,0)
 S IBTO=$$DAT1^IBOUTL($S($P(IBND,"^",15)'="":($P(IBND,"^",15)),1:$P(IBND1,"^",2)))
"RTN","IBOHLD2",105,0)
 ; charge$
"RTN","IBOHLD2",106,0)
 S IBCHG=$J(+$P(IBND,"^",7),9,2)
"RTN","IBOHLD2",107,0)
 W ?29,IBACT,?39,IBTYPE,?46,IBBILL
"RTN","IBOHLD2",108,0)
 I IBRX>0 W ?55,"Rx #: "_IBRX_$S(IBRF>0:"("_IBRF_")",1:""),?85,"||",! I IBECME W ?55,"ECME #: ",IBECME,?85,"||",!
"RTN","IBOHLD2",109,0)
 W:IBX=1 ?54,"*"
"RTN","IBOHLD2",110,0)
 W ?55,IBFR,?66,IBTO,?75,IBCHG
"RTN","IBOHLD2",111,0)
 Q
"RTN","IBOHLD2",112,0)
HEADER ; writes the report header
"RTN","IBOHLD2",113,0)
 Q:IBQUIT
"RTN","IBOHLD2",114,0)
 I IBCRT,$Y>1 D  Q:IBQUIT  ;F  Q:$Y>(IOSL-1)  W !
"RTN","IBOHLD2",115,0)
 .W ! N T R "    Press RETURN to continue",T:DTIME I '$T!(T["^") S IBQUIT=1 Q
"RTN","IBOHLD2",116,0)
 I IBPAGE>1 W !,@IOF
"RTN","IBOHLD2",117,0)
 W ?53,"MEANS TEST CHARGES ON HOLD",?110,IBNOW,"  PAGE ",IBPAGE,!,"HELD CHARGES",?87,"CORRESPONDING THIRD PARTY BILLS",!,IBLINE
"RTN","IBOHLD2",118,0)
 W !,"Name",?22,"Pt.ID",?29,"Act.ID",?39,"Type",?46,"Bill#",?55,"Fr/Fl Dt",?66,"To/Rls Dt",?78,"Charge",?85,"||",?88,"Bill#",?97,"AR-Status",?115,"Charge",?128,"Paid"
"RTN","IBOHLD2",119,0)
 W !,IBLINE,!
"RTN","IBOHLD2",120,0)
 W ?20,"'*' = outpt visit on same day as Rx fill date",?85,"||",!,IBLINE,!
"RTN","IBOHLD2",121,0)
 S IBPAGE=IBPAGE+1
"RTN","IBOHLD2",122,0)
 Q
"RTN","IBOHLD2",123,0)
IBACTYPE(IBTYPE) ; Patch IB*2.0*618 - added community care - action types to HELD CHARGES report
"RTN","IBOHLD2",124,0)
 I IBTYPE["URGENT " Q "NVCUC"
"RTN","IBOHLD2",125,0)
 I IBTYPE["CC " Q "NVC"
"RTN","IBOHLD2",126,0)
 I IBTYPE["CCN " Q "NVC"
"RTN","IBOHLD2",127,0)
 I IBTYPE["CHOICE" Q "NVC"
"RTN","IBOHLD2",128,0)
 I IBTYPE["PSO NSC" Q "RXNSC"
"RTN","IBOHLD2",129,0)
 I IBTYPE["PSO SC" Q "RX SC"
"RTN","IBOHLD2",130,0)
 Q $E(IBTYPE,4,7)
"RTN","IBOHLD2",131,0)
 ;
"RTN","IBOMTP1")
0^8^B21766402^B17900558
"RTN","IBOMTP1",1,0)
IBOMTP1 ;ALB/CPM-MEANS TEST BILLING PROFILE (CON'T);10-DEC-91
"RTN","IBOMTP1",2,0)
 ;;2.0;INTEGRATED BILLING;**15,153,176,183,651**;21-MAR-94;Build 9
"RTN","IBOMTP1",3,0)
 ;; Per VHA Directive 10-93-142, this routine should not be modified
"RTN","IBOMTP1",4,0)
 ;
"RTN","IBOMTP1",5,0)
 N IBLEG,IBCHK,IBBLG,IBATYP
"RTN","IBOMTP1",6,0)
 ;***
"RTN","IBOMTP1",7,0)
 ;S XRTL=$ZU(0),XRTN="IBOMTP1-2" D T0^%ZOSV ;start rt clock
"RTN","IBOMTP1",8,0)
 ; Begin compilation.  Start with billing clocks.
"RTN","IBOMTP1",9,0)
 S Y=-(IBEDT+.1),X=0 F  Q:-Y<IBBDT  S Y=$O(^IBE(351,"AIVDT",IBDFN,Y)) Q:'Y  F  S X=$O(^IBE(351,"AIVDT",IBDFN,Y,X)) Q:'X  S:$P($G(^IBE(351,X,0)),U,4)'=3 ^TMP($J,"IBOMTP",-Y,"C")=""
"RTN","IBOMTP1",10,0)
 ;
"RTN","IBOMTP1",11,0)
 ; Get O/P visits from file #399.
"RTN","IBOMTP1",12,0)
 S X1=IBBDT,X2=-1 D C^%DTC S Y=X
"RTN","IBOMTP1",13,0)
 F  S Y=$O(^DGCR(399,"AOPV",IBDFN,Y)) Q:'Y!(Y>IBEDT)  D
"RTN","IBOMTP1",14,0)
 . S IBDA=0 F  S IBDA=$O(^DGCR(399,"AOPV",IBDFN,Y,IBDA)) Q:'IBDA  D
"RTN","IBOMTP1",15,0)
 ..  I $D(^DGCR(399,+IBDA,0)),'$P($G(^("S")),U,16),$P($G(^DGCR(399.3,+$P(^(0),U,7),0)),U)["MEANS" S ^TMP($J,"IBOMTP",Y,"M"_IBDA)=""
"RTN","IBOMTP1",16,0)
 ;
"RTN","IBOMTP1",17,0)
 ;IB*2.0*651 - Add Automated Pharmacy RX copays to the report.
"RTN","IBOMTP1",18,0)
 ; Get the rest of the charges from file #350.
"RTN","IBOMTP1",19,0)
 S IBCHK=0
"RTN","IBOMTP1",20,0)
 S Y="" F  S Y=$O(^IB("AFDT",IBDFN,Y)) Q:'Y  I -Y'>IBEDT S Y1=0 F  S Y1=$O(^IB("AFDT",IBDFN,Y,Y1)) Q:'Y1  D
"RTN","IBOMTP1",21,0)
 . S (IBDA,IBCHK)=0 F  S IBDA=$O(^IB("AF",Y1,IBDA)) Q:'IBDA  D  Q:IBCHK
"RTN","IBOMTP1",22,0)
 ..  S IBCHK=0
"RTN","IBOMTP1",23,0)
 ..  Q:'$D(^IB(IBDA,0))  S IBX=^IB(IBDA,0)
"RTN","IBOMTP1",24,0)
 ..  Q:$P(IBX,U,8)["ADMISSION"
"RTN","IBOMTP1",25,0)
 ..  I $P(IBX,U,15)<IBBDT!($P(IBX,U,14)>IBEDT) Q
"RTN","IBOMTP1",26,0)
 ..  N Y,Y1
"RTN","IBOMTP1",27,0)
 ..  ; Action type. We don't include LTC actions to the report
"RTN","IBOMTP1",28,0)
 ..  I $P(IBX,U,3) I $$ACTNM^IBOUTL(+$P(IBX,U,3))["LTC " Q  ; Exclude LTC action type
"RTN","IBOMTP1",29,0)
 ..  S ^TMP($J,"IBOMTP",+$P(IBX,U,14),"I"_IBDA)="",IBCHK=1
"RTN","IBOMTP1",30,0)
 . Q:IBCHK     ;If an entry already found its not a pharmacy RX
"RTN","IBOMTP1",31,0)
 . S IBX=$G(^IB(Y1,0))
"RTN","IBOMTP1",32,0)
 . S IBATYP=$P(IBX,U,3),IBBLG=$$GET1^DIQ(350.1,IBATYP_",",.11,"I")
"RTN","IBOMTP1",33,0)
 . I IBBLG=5 D             ;Is this an RX copay
"RTN","IBOMTP1",34,0)
 ..  I $P(IBX,U,15)<IBBDT!($P(IBX,U,14)>IBEDT) Q      ;Check to ensure the visit is in the correct search range
"RTN","IBOMTP1",35,0)
 ..  S ^TMP($J,"IBOMTP",+$P(IBX,U,14),"I"_Y1)=""      ;Store in reporting array.
"RTN","IBOMTP1",36,0)
 ;End IB*2.0*651
"RTN","IBOMTP1",37,0)
 ;
"RTN","IBOMTP1",38,0)
 ; Print report.
"RTN","IBOMTP1",39,0)
 S IBLEG=0 ; Legend not required
"RTN","IBOMTP1",40,0)
 D NOW^%DTC S IBHDT=$$DAT2^IBOUTL($E(%,1,12))
"RTN","IBOMTP1",41,0)
 S IBLINE="",$P(IBLINE,"-",IOM+1)="",(IBPAG,IBCHGT,IBQUIT)=0
"RTN","IBOMTP1",42,0)
 S IBPT=$$PT^IBEFUNC(IBDFN)
"RTN","IBOMTP1",43,0)
 S IBH="Means Test Billing Profile for "_$P(IBPT,U)_"  "_$P(IBPT,U,2) D HDR
"RTN","IBOMTP1",44,0)
 I '$D(^TMP($J,"IBOMTP")) W !,"This patient has no Means Test bills." D PAUSE^IBOUTL G END
"RTN","IBOMTP1",45,0)
 ; - first, print detail lines
"RTN","IBOMTP1",46,0)
 S IBD="" F  S IBD=$O(^TMP($J,"IBOMTP",IBD)) Q:'IBD  D  G:IBQUIT END
"RTN","IBOMTP1",47,0)
 . S IBTY="" F  S IBTY=$O(^TMP($J,"IBOMTP",IBD,IBTY)) Q:IBTY=""  D  Q:IBQUIT
"RTN","IBOMTP1",48,0)
 ..  I $Y>(IOSL-5) D PAUSE^IBOUTL Q:IBQUIT  D HDR
"RTN","IBOMTP1",49,0)
 ..  W !,$$DAT1^IBOUTL(IBD)
"RTN","IBOMTP1",50,0)
 ..  I IBTY="C" W ?12,"Begin Means Test Billing Clock" Q
"RTN","IBOMTP1",51,0)
 ..  S IBDA=+$E(IBTY,2,99),IBD0=$S($E(IBTY)="M":$G(^DGCR(399,IBDA,0)),1:$G(^IB(IBDA,0))),IBSEQ=0
"RTN","IBOMTP1",52,0)
 ..  I $E(IBTY)="I" S IBSEQ=$P($G(^IBE(350.1,+$P(IBD0,U,3),0)),U,5)
"RTN","IBOMTP1",53,0)
 ..  W ?14,$S($E(IBTY)="M":"OPT COPAYMENT (UB-82)",1:$$ACTNM^IBOUTL(+$P(IBD0,U,3)))
"RTN","IBOMTP1",54,0)
 ..  W ?44,$S($E(IBTY)="M":$P(IBD0,U),1:$$STAT())
"RTN","IBOMTP1",55,0)
 ..  I $E(IBTY)="I",$P(IBD0,U,14)'=$P(IBD0,U,15) W ?54,$$DAT1^IBOUTL($P(IBD0,U,15))
"RTN","IBOMTP1",56,0)
 ..  I $E(IBTY)="M" S X=+$O(^DGCR(399,IBDA,"RC","B",500,0)),IBCHG=+$P($G(^DGCR(399,IBDA,"RC",X,0)),U,2)
"RTN","IBOMTP1",57,0)
 ..  E  S IBCHG=+$P(IBD0,U,7)
"RTN","IBOMTP1",58,0)
 ..  I IBSEQ=2 S IBCHG=-IBCHG
"RTN","IBOMTP1",59,0)
 ..  I $E(IBTY)="I",$P(IBD0,U,11)="",$P($G(^IBE(350.21,+$P(IBD0,U,5),0)),U,5) S IBCHG=0
"RTN","IBOMTP1",60,0)
 ..  S X=IBCHG,X2="2$",X3=10 D COMMA^%DTC W ?65,X
"RTN","IBOMTP1",61,0)
 ..  I $P(IBD0,U,21) W " *" S IBLEG=1 ;Print legend at the bottom
"RTN","IBOMTP1",62,0)
 ..  S IBCHGT=IBCHGT+IBCHG
"RTN","IBOMTP1",63,0)
 ..  I IBSEQ=2!($P(IBD0,U,11)=""&($P($G(^IBE(350.21,+$P(IBD0,U,5),0)),U,5))) W !?5,"Charge Removal Reason: ",$S($D(^IBE(350.3,+$P(IBD0,U,10),0)):$P(^(0),U),1:"UNKNOWN")
"RTN","IBOMTP1",64,0)
 ; - print totals line
"RTN","IBOMTP1",65,0)
 I ($Y-IBLEG)>(IOSL-5) D LEGEND,PAUSE^IBOUTL G:IBQUIT END D HDR
"RTN","IBOMTP1",66,0)
 W !?63,"-----------" S X=IBCHGT,X2="2$",X3=12 D COMMA^%DTC W !?63,X
"RTN","IBOMTP1",67,0)
 D LEGEND,PAUSE^IBOUTL
"RTN","IBOMTP1",68,0)
 ; - close device and quit
"RTN","IBOMTP1",69,0)
END K ^TMP($J)
"RTN","IBOMTP1",70,0)
 ;***
"RTN","IBOMTP1",71,0)
 ;I $D(XRT0) S:'$D(XRTN) XRTN="IBOMTP1" D T1^%ZOSV ;stop rt clock
"RTN","IBOMTP1",72,0)
 I $D(ZTQUEUED) S ZTREQ="@" Q
"RTN","IBOMTP1",73,0)
 K IBJ,IBD,IBH,IBHDT,IBTY,IBDA,IBD0,IBSEQ,IBQUIT,IBCHG,IBCHGT,IBPAG,IBLINE,IBX,IBPT,X,X2,X3,Y,Y1
"RTN","IBOMTP1",74,0)
 D ^%ZISC Q
"RTN","IBOMTP1",75,0)
 ;
"RTN","IBOMTP1",76,0)
 ;
"RTN","IBOMTP1",77,0)
HDR ; Print header.
"RTN","IBOMTP1",78,0)
 S IBLEG=0
"RTN","IBOMTP1",79,0)
 I $E(IOST,1,2)["C-"!(IBPAG) W @IOF,*13
"RTN","IBOMTP1",80,0)
 S IBPAG=IBPAG+1 W ?(80-$L(IBH)\2),IBH
"RTN","IBOMTP1",81,0)
 W !,"From ",$$DAT1^IBOUTL(IBBDT)," through ",$$DAT1^IBOUTL(IBEDT)
"RTN","IBOMTP1",82,0)
 W ?IOM-36,IBHDT,?IOM-9,"Page: ",IBPAG
"RTN","IBOMTP1",83,0)
 W !,"BILL DATE   BILL TYPE",?44,"BILL #    BILL TO   TOT CHARGE"
"RTN","IBOMTP1",84,0)
 W !,IBLINE,! Q
"RTN","IBOMTP1",85,0)
 ;
"RTN","IBOMTP1",86,0)
STAT() ; Display bill number or status
"RTN","IBOMTP1",87,0)
 N IBSTAT S IBSTAT=$G(^IBE(350.21,+$P(IBD0,U,5),0))
"RTN","IBOMTP1",88,0)
 Q $S($P(IBSTAT,U,6):$$HLD(+$P(IBD0,U,5)),$P(IBD0,U,5)=99:"Converted",$P(IBD0,U,11)]"":$P($P(IBD0,U,11),"-",2),$P(IBSTAT,U,5):"Cancelled",1:"Pending")
"RTN","IBOMTP1",89,0)
 ;
"RTN","IBOMTP1",90,0)
HLD(STAT) ; Return an 'on hold' status string
"RTN","IBOMTP1",91,0)
 Q "Hold "_$S(STAT=20:"Rate",STAT=21:"Rev",1:"Ins")
"RTN","IBOMTP1",92,0)
 ;
"RTN","IBOMTP1",93,0)
LEGEND I $G(IBLEG) W !,"    '*' - Geographic Means Test rates"
"RTN","IBOMTP1",94,0)
 Q
"RTN","IBRREL")
0^10^B29016408^B29208696
"RTN","IBRREL",1,0)
IBRREL ;ALB/CPM - RELEASE MEANS TEST CHARGES 'ON HOLD' ; 03-MAR-92
"RTN","IBRREL",2,0)
 ;;2.0;INTEGRATED BILLING;**95,153,199,347,452,651**;21-MAR-94;Build 9
"RTN","IBRREL",3,0)
 ;;Per VA Directive 6402, this routine should not be modified.
"RTN","IBRREL",4,0)
 ;
"RTN","IBRREL",5,0)
EN ; Entry point for stand-alone 'release' option
"RTN","IBRREL",6,0)
 I '$D(^IB("AH")) W !!,"There are no patients with charges 'on hold' at this time.",! Q
"RTN","IBRREL",7,0)
 ;
"RTN","IBRREL",8,0)
 D HOME^%ZIS
"RTN","IBRREL",9,0)
 W !!,"This option is used to release Means Test charges which have been"
"RTN","IBRREL",10,0)
 W !,"placed 'on hold.'  Please enter a patient with charges 'on hold,' and these"
"RTN","IBRREL",11,0)
 W !,"charges will be displayed and may be selected to be released to Accounts",!,"Receivable.",!
"RTN","IBRREL",12,0)
 ;
"RTN","IBRREL",13,0)
ASK ;
"RTN","IBRREL",14,0)
 R !,"Select PATIENT NAME: ",X:DTIME G END:"^"[$E(X)
"RTN","IBRREL",15,0)
 I $E(X,1,2)="??" D HLP1 G ASK
"RTN","IBRREL",16,0)
 I $E(X)="?" D HLP G ASK
"RTN","IBRREL",17,0)
 N DPTNOFZY S DPTNOFZY=1  ;Suppress PATIENT file fuzzy lookups
"RTN","IBRREL",18,0)
 S DIC="^DPT(",DIC(0)="QME" D ^DIC K DIC G ASK:Y<1 S DFN=+Y
"RTN","IBRREL",19,0)
 ;
"RTN","IBRREL",20,0)
 K IBA,PRCABN
"RTN","IBRREL",21,0)
 S IBI=0 F IBNUM=1:1 S IBI=$O(^IB("AH",DFN,IBI)) Q:'IBI  S IBA(IBNUM)=IBI
"RTN","IBRREL",22,0)
 I '$D(IBA) W !!,"This patient does not have any charges 'on hold.'",! G ASK
"RTN","IBRREL",23,0)
 ;
"RTN","IBRREL",24,0)
 S IBPT=$$PT^IBEFUNC(DFN) W @IOF,$P(IBPT,"^"),"      Pt ID: ",$P(IBPT,"^",2),! S I="",$P(I,"-",80)="" W I K I
"RTN","IBRREL",25,0)
 ;
"RTN","IBRREL",26,0)
RESUME ; - display header and list charges
"RTN","IBRREL",27,0)
 ;
"RTN","IBRREL",28,0)
 ; *** This tag is also called by ECME routine IBNCPDPR ***
"RTN","IBRREL",29,0)
 ; Special variable IBNCPDPR will be set to 1 when called from ECME.
"RTN","IBRREL",30,0)
 ; If this variable is set, then processing in this routine will GOTO tag END and quit rather than go back up
"RTN","IBRREL",31,0)
 ; and ask for another patient.
"RTN","IBRREL",32,0)
 ; Also, special variable IBNCPDPRDEF is the entry# in the list if a specific Rx# was chosen from the ECME screen.
"RTN","IBRREL",33,0)
 ; 
"RTN","IBRREL",34,0)
 ;
"RTN","IBRREL",35,0)
 W !!,"The following IB Actions ",$S($D(PRCABN):"associated with this bill",1:"for this patient")," are ON HOLD:"
"RTN","IBRREL",36,0)
 D HDR
"RTN","IBRREL",37,0)
 ;
"RTN","IBRREL",38,0)
 ; display the list of IB charges on hold
"RTN","IBRREL",39,0)
 S IBQ=0 F IBNUM=1:1 Q:'$D(IBA(IBNUM))!IBQ  D  Q:IBQ
"RTN","IBRREL",40,0)
 . I $Y+5>IOSL D PAUSE^VALM1 S:$D(DIRUT) IBQ=1 Q:IBQ  S $Y=0 D HDR
"RTN","IBRREL",41,0)
 . S IBN=IBA(IBNUM) D LST
"RTN","IBRREL",42,0)
 . Q
"RTN","IBRREL",43,0)
 ;
"RTN","IBRREL",44,0)
 ; - prompt user to select IB Actions
"RTN","IBRREL",45,0)
 S DIR(0)="LA^1:"_(IBNUM-1)_"^K:X[""."" X"
"RTN","IBRREL",46,0)
 S DIR("A")="Select IB Action"_$E("s",IBNUM>2)_" (REF #) to release (or '^' to exit): "
"RTN","IBRREL",47,0)
 I $G(IBNCPDPRDEF) S DIR("B")=IBNCPDPRDEF    ; default value if coming in from ECME
"RTN","IBRREL",48,0)
 S DIR("?")="^D HELP^IBRREL"
"RTN","IBRREL",49,0)
 W ! D ^DIR K DIR
"RTN","IBRREL",50,0)
 I $D(DIRUT)!($D(DUOUT)) G END:($D(PRCABN)!$G(IBNCPDPR)) D END W ! G ASK
"RTN","IBRREL",51,0)
 ;
"RTN","IBRREL",52,0)
 S IBRANGE=Y,IBSEQNO=1,IBDUZ=DUZ
"RTN","IBRREL",53,0)
 ;
"RTN","IBRREL",54,0)
 S DIR(0)="Y",DIR("A")="OK to pass "_$S($P(Y,",",2):"these charges",1:"this charge")_" to Accounts Receivable"
"RTN","IBRREL",55,0)
 D ^DIR K DIR I 'Y!($D(DIRUT))!($D(DUOUT)) G END:($D(PRCABN)!$G(IBNCPDPR)) D END W ! G ASK
"RTN","IBRREL",56,0)
 ;
"RTN","IBRREL",57,0)
 ; - pass charges to Accounts Receivable
"RTN","IBRREL",58,0)
 W !!,"Passing charges to Accounts Receivable...",! D HDR
"RTN","IBRREL",59,0)
 F IBCTR=1:1 S IBNUM=$P(IBRANGE,",",IBCTR) Q:'IBNUM  I $D(IBA(IBNUM)) S IBNOS=IBA(IBNUM) D ^IBR,ERR:Y<1 I Y>0 S IBN=IBA(IBNUM) D LST
"RTN","IBRREL",60,0)
 W !!,"The charge"_$E("s",$P(IBRANGE,",",2)>0)_" listed above "_$S($P(IBRANGE,",",2):"have",1:"has")_" been passed to Accounts Receivable.",!
"RTN","IBRREL",61,0)
 ;
"RTN","IBRREL",62,0)
 I $G(IBNCPDPR) W !! S DIR(0)="E" D ^DIR K DIR G END   ; exit for ECME
"RTN","IBRREL",63,0)
 ;
"RTN","IBRREL",64,0)
 I '$D(PRCABN) W !! S DIR(0)="E" D ^DIR K DIR D END W ! G ASK
"RTN","IBRREL",65,0)
 ;
"RTN","IBRREL",66,0)
END K DIC,DIRUT,DUOUT,DTOUT,IBA,IBAFY,IBARTYP,IBATYP,IBCTR,IBN,IBDA,IBDUZ
"RTN","IBRREL",67,0)
 K IBFAC,IBI,IBIL,IBRANGE,IBNOS,IBNUM,IBPT,IBQ,IBSEQNO,IBSERV,IBSITE
"RTN","IBRREL",68,0)
 K IBTOTL,IBTRAN,IBWHER,VA,VAERR,VADM
"RTN","IBRREL",69,0)
 K:'$D(PRCABN) DFN
"RTN","IBRREL",70,0)
 Q
"RTN","IBRREL",71,0)
 ;
"RTN","IBRREL",72,0)
 ;
"RTN","IBRREL",73,0)
HDR ; Display charge header.
"RTN","IBRREL",74,0)
 N IBLINE S $P(IBLINE,"=",81)=""
"RTN","IBRREL",75,0)
 W !,IBLINE,!," REF  Action ID    Bill Type",?42,"Bill #",?51,"Fr/Fl Dt",?61,"To/Rls Dt",?73,"Charge"
"RTN","IBRREL",76,0)
 W !,IBLINE Q
"RTN","IBRREL",77,0)
 ;
"RTN","IBRREL",78,0)
LST ; Display individual IB Action.
"RTN","IBRREL",79,0)
 N IBND,IBND1,IBRXN,IBRX,IBRF,IBRDT,IENS,IBECME
"RTN","IBRREL",80,0)
 S IBND=$G(^IB(IBN,0)),IBND1=$G(^IB(IBN,1)),(IBRXN,IBRX,IBRF,IBRDT,IBECME)=0
"RTN","IBRREL",81,0)
 I $P(IBND,"^",4)["52:" D
"RTN","IBRREL",82,0)
 . S IBRXN=+$P($P(IBND,"^",4),":",2)   ; Rx ien
"RTN","IBRREL",83,0)
 . S IBRX=$P($P(IBND,"^",8),"-")       ; external Rx#
"RTN","IBRREL",84,0)
 . S IBRF=+$P($P(IBND,"^",4),":",3)    ; fill# or 0 for original fill
"RTN","IBRREL",85,0)
 . S IBECME=$P($$CLAIM^BPSBUTL(IBRXN,IBRF),U,6)   ; ecme#  DBIA# 4719
"RTN","IBRREL",86,0)
 . I IBRF S IENS=+IBRF,IBRDT=$$SUBFILE^IBRXUTL(+IBRXN,+IENS,52,.01)
"RTN","IBRREL",87,0)
 . I 'IBRF S IENS=+IBRXN,IBRDT=$$FILE^IBRXUTL(+IENS,22)
"RTN","IBRREL",88,0)
 . Q
"RTN","IBRREL",89,0)
 ;
"RTN","IBRREL",90,0)
 W !?1,$J(IBNUM,2),?6,$J(+IBND,9)
"RTN","IBRREL",91,0)
 W ?19,$S(IBRXN>0:"Rx #: "_IBRX_$S(IBRF>0:"("_IBRF_")",1:""),1:$P(IBND,"^",8)) ;IB*2.0*651
"RTN","IBRREL",92,0)
 W ?42,$P($P(IBND,"^",11),"-",2)
"RTN","IBRREL",93,0)
 W ?51,$$DAT1^IBOUTL($S(IBRXN>0:IBRDT,1:$P(IBND,"^",14)))
"RTN","IBRREL",94,0)
 W ?61,$$DAT1^IBOUTL($S($P(IBND,"^",15)'="":($P(IBND,"^",15)),1:$P(IBND1,"^",2)))
"RTN","IBRREL",95,0)
 W ?70,$J(+$P(IBND,"^",7),9,2)
"RTN","IBRREL",96,0)
 I IBECME W !?19,"ECME #: ",IBECME
"RTN","IBRREL",97,0)
 Q
"RTN","IBRREL",98,0)
 ;
"RTN","IBRREL",99,0)
ERR ; Display error message.
"RTN","IBRREL",100,0)
 W !?1,$J(IBNUM,2),?7,"Error encountered - a separate bulletin has been posted"
"RTN","IBRREL",101,0)
 Q
"RTN","IBRREL",102,0)
 ;
"RTN","IBRREL",103,0)
HLP ; Display basic help message.
"RTN","IBRREL",104,0)
 W !!,"Enter:    the name of a patient with charges 'on hold,' or"
"RTN","IBRREL",105,0)
 W !?10,"'??' --  to see all patients with charges 'on hold,' or"
"RTN","IBRREL",106,0)
 W !?10,"'^'  --  to quit this option.",!
"RTN","IBRREL",107,0)
 Q
"RTN","IBRREL",108,0)
 ;
"RTN","IBRREL",109,0)
HLP1 ; Display all patients with charges 'on hold.'
"RTN","IBRREL",110,0)
 N DFN,I,IBQ,PID
"RTN","IBRREL",111,0)
 W !!,"The following patients have charges 'on hold:'"
"RTN","IBRREL",112,0)
 S (DFN,IBQ)=0 F I=1:1 S DFN=$O(^IB("AH",DFN)) Q:'DFN  D:'(I#15)  Q:IBQ  S PID=$$PT^IBEFUNC(DFN) W !?3,$P(PID,"^"),$J("",10),$P(PID,"^",2)
"RTN","IBRREL",113,0)
 . R !,"Enter RETURN to continue or '^' to stop: ",X:DTIME S:X["^"!('$T) IBQ=1 Q
"RTN","IBRREL",114,0)
 W ! Q
"RTN","IBRREL",115,0)
 ;
"RTN","IBRREL",116,0)
HELP ; Help for the 'Select' prompt.
"RTN","IBRREL",117,0)
 W !!?4,"Please enter a list or range of IB Actions (i.e. 1,3,5 or 2-4,8), none"
"RTN","IBRREL",118,0)
 W !?4,"greater than ",IBNUM-1,", to be passed to Accounts Receivable, or '^' to quit."
"RTN","IBRREL",119,0)
 Q
"RTN","IBRREL",120,0)
 ;
"RTN","IBRREL",121,0)
 ;
"RTN","IBRREL",122,0)
AR ; Accounts Receivable entry point to release charges.
"RTN","IBRREL",123,0)
 ;   Input: PRCABN -- ien of Bill/Accounts Receivable
"RTN","IBRREL",124,0)
 Q:$D(PRCABN)[0  Q:'$$IB^IBRUTL(PRCABN,1)  G RESUME
"VER")
8.0^22.2
"BLD",11341,6)
^591
**END**
**END**

