Released MPIF*1*68 SEQ #65
Extracted from mail message
**KIDS**:MPIF*1.0*68^

**INSTALL NAME**
MPIF*1.0*68
"BLD",3357,0)
MPIF*1.0*68^MASTER PATIENT INDEX VISTA^0^3180924^y
"BLD",3357,1,0)
^^3^3^3180924^^
"BLD",3357,1,1,0)
MASTER VETERAN INDEX VISTA ENHANCEMENTS - MVI SENSITIVITY
"BLD",3357,1,2,0)
Refer to patch MPIF*1.0*68 in the FORUM Patch Module for a complete
"BLD",3357,1,3,0)
description.
"BLD",3357,4,0)
^9.64PA^^
"BLD",3357,6.3)
2
"BLD",3357,"KRN",0)
^9.67PA^779.2^20
"BLD",3357,"KRN",.4,0)
.4
"BLD",3357,"KRN",.401,0)
.401
"BLD",3357,"KRN",.402,0)
.402
"BLD",3357,"KRN",.403,0)
.403
"BLD",3357,"KRN",.5,0)
.5
"BLD",3357,"KRN",.84,0)
.84
"BLD",3357,"KRN",3.6,0)
3.6
"BLD",3357,"KRN",3.8,0)
3.8
"BLD",3357,"KRN",9.2,0)
9.2
"BLD",3357,"KRN",9.8,0)
9.8
"BLD",3357,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",3357,"KRN",9.8,"NM",1,0)
MPIFA31B^^0^B29876482
"BLD",3357,"KRN",9.8,"NM",2,0)
MPIFBT3^^0^B16211266
"BLD",3357,"KRN",9.8,"NM",3,0)
MPIFA24B^^0^B11791107
"BLD",3357,"KRN",9.8,"NM","B","MPIFA24B",3)

"BLD",3357,"KRN",9.8,"NM","B","MPIFA31B",1)

"BLD",3357,"KRN",9.8,"NM","B","MPIFBT3",2)

"BLD",3357,"KRN",19,0)
19
"BLD",3357,"KRN",19.1,0)
19.1
"BLD",3357,"KRN",101,0)
101
"BLD",3357,"KRN",409.61,0)
409.61
"BLD",3357,"KRN",771,0)
771
"BLD",3357,"KRN",779.2,0)
779.2
"BLD",3357,"KRN",870,0)
870
"BLD",3357,"KRN",8989.51,0)
8989.51
"BLD",3357,"KRN",8989.52,0)
8989.52
"BLD",3357,"KRN",8994,0)
8994
"BLD",3357,"KRN","B",.4,.4)

"BLD",3357,"KRN","B",.401,.401)

"BLD",3357,"KRN","B",.402,.402)

"BLD",3357,"KRN","B",.403,.403)

"BLD",3357,"KRN","B",.5,.5)

"BLD",3357,"KRN","B",.84,.84)

"BLD",3357,"KRN","B",3.6,3.6)

"BLD",3357,"KRN","B",3.8,3.8)

"BLD",3357,"KRN","B",9.2,9.2)

"BLD",3357,"KRN","B",9.8,9.8)

"BLD",3357,"KRN","B",19,19)

"BLD",3357,"KRN","B",19.1,19.1)

"BLD",3357,"KRN","B",101,101)

"BLD",3357,"KRN","B",409.61,409.61)

"BLD",3357,"KRN","B",771,771)

"BLD",3357,"KRN","B",779.2,779.2)

"BLD",3357,"KRN","B",870,870)

"BLD",3357,"KRN","B",8989.51,8989.51)

"BLD",3357,"KRN","B",8989.52,8989.52)

"BLD",3357,"KRN","B",8994,8994)

"BLD",3357,"QDEF")
^^^^^^^^^^YES
"BLD",3357,"QUES",0)
^9.62^^
"BLD",3357,"REQB",0)
^9.611^5^4
"BLD",3357,"REQB",1,0)
DG*5.3*967^2
"BLD",3357,"REQB",3,0)
MPIF*1.0*60^2
"BLD",3357,"REQB",4,0)
MPIF*1.0*61^2
"BLD",3357,"REQB",5,0)
MPIF*1.0*64^2
"BLD",3357,"REQB","B","DG*5.3*967",1)

"BLD",3357,"REQB","B","MPIF*1.0*60",3)

"BLD",3357,"REQB","B","MPIF*1.0*61",4)

"BLD",3357,"REQB","B","MPIF*1.0*64",5)

"MBREQ")
0
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
68^3180924
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3180924
"PKG",282,22,1,"PAH",1,1,1,0)
MASTER VETERAN INDEX VISTA ENHANCEMENTS - MVI SENSITIVITY
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1.0*68 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","MPIFA24B")
0^3^B11791107^B11454543
"RTN","MPIFA24B",1,0)
MPIFA24B ;BP/CMC-BUILD A24 ADD ME MSGS ;JULY 22, 2002
"RTN","MPIFA24B",2,0)
 ;;1.0;MASTER PATIENT INDEX VISTA;**22,28,31,25,43,44,51,61,68**;30 Apr 99;Build 2
"RTN","MPIFA24B",3,0)
 ;
"RTN","MPIFA24B",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA24B",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA24B",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA24B",7,0)
 ;
"RTN","MPIFA24B",8,0)
A24(DFN,PID2,NOA31) ;BUILD AND SEND A24 **43 added PID2 as a parameter - not required.
"RTN","MPIFA24B",9,0)
 ; if PID2 is defined it will contain the previous ICN data, passed by reference
"RTN","MPIFA24B",10,0)
 ; **51 ADDED NOA31 as a parameter to stop the sending of an A31 if set to 1
"RTN","MPIFA24B",11,0)
 N RESLT,CNT,MPI,EVN,TCNT,ERR,PD1,PID
"RTN","MPIFA24B",12,0)
 K HLA("HLA"),HLA("HLS")
"RTN","MPIFA24B",13,0)
 S CNT=1
"RTN","MPIFA24B",14,0)
 D INIT^HLFNC2("MPIF ADT-A24 SERVER",.HL)
"RTN","MPIFA24B",15,0)
 I $O(HL(""))="" Q "-1^"_$P(HL,"^",2)
"RTN","MPIFA24B",16,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),COMP=$E(HL("ECH"),1),REP=$E(HL("ECH"),2),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA24B",17,0)
 S ERR="",TCNT=0
"RTN","MPIFA24B",18,0)
 D BLDEVN^VAFCQRY(DFN,"1,2",.EVN,.HL,"A24",.ERR)
"RTN","MPIFA24B",19,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",20,0)
 D BLDPID^VAFCQRY(DFN,1,"ALL",.PID,.HL,.ERR)
"RTN","MPIFA24B",21,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",22,0)
 D BLDPD1^VAFCQRY(DFN,"3",.PD1,.HL,.ERR)
"RTN","MPIFA24B",23,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",24,0)
 I '$D(PID2) D BLDPID^VAFCQRY(DFN,2,"ALL",.PID2,.HL,.ERR) ;**43 TO ONLY BUILD 2ND PID SEGMENT IF NOT PASSED
"RTN","MPIFA24B",25,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",26,0)
 S HLA("HLS",1)=EVN(1)
"RTN","MPIFA24B",27,0)
 S HLA("HLS",3)=PD1(1)
"RTN","MPIFA24B",28,0)
 S CNT=0 F  S CNT=$O(PID(CNT)) Q:CNT=""  D
"RTN","MPIFA24B",29,0)
 .I CNT=1 S HLA("HLS",2)=PID(CNT)
"RTN","MPIFA24B",30,0)
 .I CNT>1 S HLA("HLS",2,CNT-1)=PID(CNT)
"RTN","MPIFA24B",31,0)
 S CNT=0 F  S CNT=$O(PID2(CNT)) Q:CNT=""  D
"RTN","MPIFA24B",32,0)
 .I CNT=1 S HLA("HLS",4)=PID2(CNT)
"RTN","MPIFA24B",33,0)
 .I CNT>1 S HLA("HLS",4,CNT-1)=PID2(CNT)
"RTN","MPIFA24B",34,0)
 S HLA("HLS",5)=$$EN1^VAFHLZPD(DFN,"1,17,21,34") ;25 ;**44 Adding Pseudo SSN Reason, 1 and 21 to ZPD segment
"RTN","MPIFA24B",35,0)
 K HLL("LINKS")
"RTN","MPIFA24B",36,0)
 D GENERATE^HLMA("MPIF ADT-A24 SERVER","LM",1,.MPIFRSLT,"","")
"RTN","MPIFA24B",37,0)
 S RESLT=$S(+MPIFRSLT:MPIFRSLT,1:"-1^"_$P(MPIFRSLT,"^",3))  ;**68 Story 827754 (jfw) - Make Error Data Consistent (-1^msg)
"RTN","MPIFA24B",38,0)
 ;**68 Story 827754 (jfw) - Check for value < 0 instead of '+RESLT
"RTN","MPIFA24B",39,0)
 I +RESLT<0 S ^XTMP("MPIFA24%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"A24 message to MPI for DFN "_DFN,^XTMP("MPIFA24%"_DFN,"MPI",0)="A"
"RTN","MPIFA24B",40,0)
 K HLA,HLEID,HLL("LINKS"),COMP,REP,SUBCOMP,HLECH,HLFS,HLA("HLA"),HLA("HLS"),MPIFRSLT
"RTN","MPIFA24B",41,0)
 ;**44 TRIGGER A31 TO UPDATE ANY DEMOGRAPHIC CHANGES
"RTN","MPIFA24B",42,0)
 ;**51 IF NOT SENDING A31 STOP PROCESSING
"RTN","MPIFA24B",43,0)
 I $G(NOA31)=1 Q RESLT
"RTN","MPIFA24B",44,0)
 N A31 S A31=$$A31^MPIFA31B(DFN)
"RTN","MPIFA24B",45,0)
 I +A31<0 D
"RTN","MPIFA24B",46,0)
 .;log exception about A31 not being sent
"RTN","MPIFA24B",47,0)
 .D START^RGHLLOG()
"RTN","MPIFA24B",48,0)
 .D EXC^RGHLLOG(208,$P(A31,"^",2)_" : Unable to generate A31 for DFN "_DFN,DFN)  ;68, Story 827754 (jfw) - Combine error msgs as 1 param
"RTN","MPIFA24B",49,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIFA24B",50,0)
 ;68, Story 827754 (jfw) - Remove redundancy as previously set in MPIFA31B.
"RTN","MPIFA24B",51,0)
 ;I $P(A31,"^",2)="" S ^XTMP("MPIFA31%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"A31 message to MPI for DFN "_DFN,^XTMP("MPIFA31%"_DFN,"MPI",0)="A"
"RTN","MPIFA24B",52,0)
 Q RESLT
"RTN","MPIFA24B",53,0)
 ;
"RTN","MPIFA24B",54,0)
RT ;
"RTN","MPIFA24B",55,0)
 S MPI=$$MPILINK^MPIFAPI()
"RTN","MPIFA24B",56,0)
 I $P($G(MPI),"^")=-1 D START^RGHLLOG(),EXC^RGHLLOG(224,"No logical link defined for the MPI",$G(DFN)),STOP^RGHLLOG() Q
"RTN","MPIFA24B",57,0)
 S HLL("LINKS",1)="MPIF ADT-A24 CLIENT^"_MPI
"RTN","MPIFA24B",58,0)
 Q
"RTN","MPIFA24B",59,0)
RES ;
"RTN","MPIFA24B",60,0)
 N NXT,DFN
"RTN","MPIFA24B",61,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA24B",62,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA24B",63,0)
 .I $E(HLNODE,1,3)="MSA"&($P(HLNODE,HL("FS"),4)'="") D
"RTN","MPIFA24B",64,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION --**44 stopped logging exception as MPI has already logged it.
"RTN","MPIFA24B",65,0)
 ..;D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA24B",66,0)
 ..;D EXC^RGHLLOG(208,$P(HLNODE,HL("FS"),4)_" for HL msg# "_HLMTIEN,DFN)
"RTN","MPIFA24B",67,0)
 ..;D STOP^RGHLLOG(0)
"RTN","MPIFA24B",68,0)
 K ^XTMP("MPIFA24%"_DFN)
"RTN","MPIFA24B",69,0)
 ;**61 Story 181213 (elz) let DG know A24 done
"RTN","MPIFA24B",70,0)
 K ^XTMP("DPTLK7 A24 IN-PROCESS",DFN)
"RTN","MPIFA24B",71,0)
 Q
"RTN","MPIFA31B")
0^1^B29876482^B26688072
"RTN","MPIFA31B",1,0)
MPIFA31B ;BP/CMC-BUILD A31 MSGS ; 8/14/18 4:15pm
"RTN","MPIFA31B",2,0)
 ;;1.0;MASTER PATIENT INDEX VISTA;**22,24,27,28,31,25,44,46,54,59,60,64,68**;30 Apr 99;Build 2
"RTN","MPIFA31B",3,0)
 ;
"RTN","MPIFA31B",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA31B",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA31B",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA31B",7,0)
 ;  $$PV1^VAFCSB, $$RADE^VAFCSB, $$LABE^VAFCSB, $$PHARA^VAFCSB, $$PV2^VAFCSB - #4921
"RTN","MPIFA31B",8,0)
TA31 ; Tasked entry point
"RTN","MPIFA31B",9,0)
 N TMP
"RTN","MPIFA31B",10,0)
 S TMP=$$A31(DFN)
"RTN","MPIFA31B",11,0)
 Q
"RTN","MPIFA31B",12,0)
 ;
"RTN","MPIFA31B",13,0)
A31(DFN) ;BUILD AND SEND A31
"RTN","MPIFA31B",14,0)
 I $P($$SITE^VASITE,"^",3)=200 Q 1
"RTN","MPIFA31B",15,0)
 ; ^ PATCH 25 IF this is the FHIE Host system, don't build A31 messages
"RTN","MPIFA31B",16,0)
 N RESLT,CNT,MPI,EVN,TCNT,ERR,PD1,PID,EN,LAB,PV1,PV2,RAD,PRE,OLD,ZPD
"RTN","MPIFA31B",17,0)
 N ZEL,ZSP,SIDG,NAMECOMP,DODF,DODD,DODNP,DODOPT,DODDISDT,SECLVL
"RTN","MPIFA31B",18,0)
 K HLA("HLA"),HLA("HLS")
"RTN","MPIFA31B",19,0)
 Q:$E($$GETICN^MPIF001(DFN),1,3)=$P($$SITE^VASITE(),"^",3) 0
"RTN","MPIFA31B",20,0)
 ; ^ LOCAL ICN DON'T SEND
"RTN","MPIFA31B",21,0)
 Q:+$$GETICN^MPIF001(DFN)=-1 0
"RTN","MPIFA31B",22,0)
 ; ^ NO ICN DON'T SEND
"RTN","MPIFA31B",23,0)
 S CNT=1
"RTN","MPIFA31B",24,0)
 D INIT^HLFNC2("MPIF ADT-A31 SERVER",.HL)
"RTN","MPIFA31B",25,0)
 I $O(HL(""))="" Q "-1^"_$P(HL,"^",2)
"RTN","MPIFA31B",26,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),COMP=$E(HL("ECH"),1),REP=$E(HL("ECH"),2),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA31B",27,0)
 S ERR="",TCNT=0
"RTN","MPIFA31B",28,0)
 D BLDEVN^VAFCQRY(DFN,"1,2",.EVN,.HL,"A31",.ERR)
"RTN","MPIFA31B",29,0)
 Q:ERR'="" ERR
"RTN","MPIFA31B",30,0)
 D BLDPID^VAFCQRY(DFN,1,"ALL",.PID,.HL,.ERR) ;**25
"RTN","MPIFA31B",31,0)
 Q:ERR'="" ERR
"RTN","MPIFA31B",32,0)
 D BLDPD1^VAFCQRY(DFN,"3",.PD1,.HL,.ERR) ;**44 NEW PD1 SEGMENT VALUES -- SENDING CMOR AGAIN AS WITHOUT 40 ON THE MPI SIDE THIS IS A PROBLEM.
"RTN","MPIFA31B",33,0)
 ;S PD1=$$PD1^VAFCSB ;**44 NEW PD1 SEGMENT VALUES -- IMDQ DECIDED NOT TO SEND PREFERRED FACILITY 9/7/06
"RTN","MPIFA31B",34,0)
 N X S X="VAFCSB" X ^%ZOSF("TEST") I $T D
"RTN","MPIFA31B",35,0)
 .;**44 VAFCSB coming in with DG*5.3*707
"RTN","MPIFA31B",36,0)
 .S PV1=$$PV1^VAFCSB ;**44 PV1 segment
"RTN","MPIFA31B",37,0)
 .S RAD=$$RADE^VAFCSB ;**44 OBX FOR LAST RADIOLOGY EXAM
"RTN","MPIFA31B",38,0)
 .S LAB=$$LABE^VAFCSB ;**44 OBX FOR LAST LAB EXAM
"RTN","MPIFA31B",39,0)
 .S PRE=$$PHARA^VAFCSB ;**44 OBX FOR ACTIVE PRESCRIPTIONS
"RTN","MPIFA31B",40,0)
 .S SIDG=$$SIG^VAFCSB(DFN)  ;**59 OBX FOR SELF ID GENDER
"RTN","MPIFA31B",41,0)
 .S NAMECOMP=$$NAMEOBX^VAFCSB(DFN) ;**59,MVI_3975 (mko): OBX for Patient .01 and Name Components
"RTN","MPIFA31B",42,0)
 .S SECLVL=$$SECLOG^VAFCSB(DFN) ;**68 Story 783361 (ckn) - OBX for Security Level
"RTN","MPIFA31B",43,0)
 .S PV2=$$PV2^VAFCSB ;**44 PV2 segment
"RTN","MPIFA31B",44,0)
 S DODF=$$DODF^VAFCSB(DFN)  ;**60 OBX for DOD fields
"RTN","MPIFA31B",45,0)
 ;**64 Story 323009 (ckn) : OBX for Additional DOD fields
"RTN","MPIFA31B",46,0)
 S DODD=$$DODD^VAFCSB(DFN)  ;Date Of Death Documents
"RTN","MPIFA31B",47,0)
 S DODOPT=$$DODOPT^VAFCSB(DFN)  ; Date Of Death Option used
"RTN","MPIFA31B",48,0)
 S DODNP=$$DODNTPRV^VAFCSB(DFN)  ; Date Of Death Notification provider
"RTN","MPIFA31B",49,0)
 S OLD=$$OLD ;**54,MVI_913: OBX to mark an older record
"RTN","MPIFA31B",50,0)
 S ZPD=$$EN1^VAFHLZPD(DFN,"1,17,21,34") ;25 ;**44 ADDED PSEUDO SSN REASON (34), 1 and 21 TO ZPD SEGMENT
"RTN","MPIFA31B",51,0)
 S ZSP=$$EN^VAFHLZSP(DFN)  ;**59
"RTN","MPIFA31B",52,0)
 S ZEL=$$EN^VAFHLZEL(DFN,"1,8,9",1)  ;**59
"RTN","MPIFA31B",53,0)
 S EN=1
"RTN","MPIFA31B",54,0)
 S HLA("HLS",EN)=EVN(1),EN=EN+1
"RTN","MPIFA31B",55,0)
 S CNT=0 F  S CNT=$O(PID(CNT)) Q:CNT=""  D
"RTN","MPIFA31B",56,0)
 .I CNT=1 S HLA("HLS",EN)=PID(CNT)
"RTN","MPIFA31B",57,0)
 .I CNT>1 S HLA("HLS",EN,CNT-1)=PID(CNT)
"RTN","MPIFA31B",58,0)
 S EN=EN+1
"RTN","MPIFA31B",59,0)
 I $G(PD1(1))'="" S HLA("HLS",EN)=PD1(1),EN=EN+1 ;**44 only pass PD1 segment if has values -- SENDING CMOR AGAIN AS WITHOUT 40 ON MPI SIDE THIS IS A PROBLEM.
"RTN","MPIFA31B",60,0)
 I $G(PV1)'="" S HLA("HLS",EN)=PV1,EN=EN+1 ;**44 only pass PV1 segment if has values
"RTN","MPIFA31B",61,0)
 I $G(PV2)'="" S HLA("HLS",EN)=PV2,EN=EN+1 ;**44 only pass PV2 segment if has values
"RTN","MPIFA31B",62,0)
 I $G(RAD)'="" S HLA("HLS",EN)=RAD,EN=EN+1 ;**44 only pass RADIOLOGY IN OBX segment if has values
"RTN","MPIFA31B",63,0)
 I $G(LAB)'="" S HLA("HLS",EN)=LAB,EN=EN+1 ;**44 only pass LAB IN OBX segment if has values
"RTN","MPIFA31B",64,0)
 I $G(PRE)'="" S HLA("HLS",EN)=PRE,EN=EN+1 ;**44 only pass PRESCRIPTION IN OBX segment if has values
"RTN","MPIFA31B",65,0)
 I $G(OLD)'="" S HLA("HLS",EN)=OLD,EN=EN+1 ;**54,MVI_913: pass OLDER RECORD in OBX if flagged as such
"RTN","MPIFA31B",66,0)
 I $G(SIDG)'="" S HLA("HLS",EN)=SIDG,EN=EN+1  ;**59
"RTN","MPIFA31B",67,0)
 I $G(DODF)'="" S HLA("HLS",EN)=DODF,EN=EN+1  ;**60 MVI_4733 (ckn) Pass DOD fields in OBX
"RTN","MPIFA31B",68,0)
 ;**64 Story 323009 (ckn) : Pass additional DOD fields in OBX
"RTN","MPIFA31B",69,0)
 I $G(DODD)'="" S HLA("HLS",EN)=DODD,EN=EN+1
"RTN","MPIFA31B",70,0)
 I $G(DODOPT)'="" S HLA("HLS",EN)=DODOPT,EN=EN+1
"RTN","MPIFA31B",71,0)
 I $G(DODNP)'="" S HLA("HLS",EN)=DODNP,EN=EN+1
"RTN","MPIFA31B",72,0)
 I $G(NAMECOMP)'="" S HLA("HLS",EN)=NAMECOMP,EN=EN+1 ;**59,MVI_3975 (mko): pass NAME COMPONENTS in OBX
"RTN","MPIFA31B",73,0)
 I $G(SECLVL)'="" S HLA("HLS",EN)=SECLVL,EN=EN+1 ;**68,Story 783361 (ckn)- Security
"RTN","MPIFA31B",74,0)
 S HLA("HLS",EN)=ZPD,EN=EN+1 ;**44 ZPD SEGMENT
"RTN","MPIFA31B",75,0)
 I $G(ZSP)'="" S HLA("HLS",EN)=ZSP,EN=EN+1 ;**59 ZSP segment
"RTN","MPIFA31B",76,0)
 I $G(ZEL)'="" S HLA("HLS",EN)=ZEL,EN=EN+1 ;**59 ZEL segment
"RTN","MPIFA31B",77,0)
 S MPI=$$MPILINK^MPIFAPI()
"RTN","MPIFA31B",78,0)
 Q:$P($G(MPI),"^")=-1 "-1^No logical link defined for the MPI"
"RTN","MPIFA31B",79,0)
 S HLL("LINKS",1)="MPIF ADT-A31 CLIENT^"_MPI
"RTN","MPIFA31B",80,0)
 D GENERATE^HLMA("MPIF ADT-A31 SERVER","LM",1,.MPIFRSLT,"","")
"RTN","MPIFA31B",81,0)
 S RESLT=$S(+MPIFRSLT:MPIFRSLT,1:"-1^"_$P(MPIFRSLT,"^",3))  ;**68 Story 827754 (jfw) - Make Error Data Consistent (-1^msg)
"RTN","MPIFA31B",82,0)
 S ^XTMP("MPIFA31%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"MPIA31 msg to MPI for DFN "_DFN
"RTN","MPIFA31B",83,0)
 I +RESLT<0 S ^XTMP("MPIFA31%"_DFN,"MPI",0)="A"  ;**68 Story 827754 (jfw) - Check for value < 0 instead of '+RESLT
"RTN","MPIFA31B",84,0)
 K HLA,HLL("LINKS"),COMP,REP,SUBCOMP,HLA("HLA"),HLA("HLS"),MPIFRSLT
"RTN","MPIFA31B",85,0)
 ;**44 REMOVED HLEID, HLECH AND HLFS from Kill line above
"RTN","MPIFA31B",86,0)
 Q RESLT
"RTN","MPIFA31B",87,0)
 ;
"RTN","MPIFA31B",88,0)
RES ;
"RTN","MPIFA31B",89,0)
 N NXT,DFN,ERROR,CODE S CODE=""
"RTN","MPIFA31B",90,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA31B",91,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2),ERROR=$P(HLNODE,HL("FS"),4),CODE=$P(HLNODE,HL("FS"),2)
"RTN","MPIFA31B",92,0)
 .I $E(HLNODE,1,3)="MSA"&(CODE="AR") D
"RTN","MPIFA31B",93,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION
"RTN","MPIFA31B",94,0)
 ..D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA31B",95,0)
 ..;**44 check which type of exception to be logged
"RTN","MPIFA31B",96,0)
 ..D EXC^RGHLLOG(234,ERROR,DFN) ;**46
"RTN","MPIFA31B",97,0)
 ..D STOP^RGHLLOG(0)
"RTN","MPIFA31B",98,0)
 K:$G(DFN)>0 ^XTMP("MPIF OLD RECORDS",DFN) ;**54,MVI_913: Delete the old record designation
"RTN","MPIFA31B",99,0)
 K ^XTMP("MPIFA31%"_DFN)
"RTN","MPIFA31B",100,0)
 Q
"RTN","MPIFA31B",101,0)
OLD() ; Return OBX segment to flag a record as "old"
"RTN","MPIFA31B",102,0)
 ;**54,MVI_913: New subroutine
"RTN","MPIFA31B",103,0)
 Q $S($D(^XTMP("MPIF OLD RECORDS",DFN))#2:"OBX"_HL("FS")_HL("FS")_"CE"_HL("FS")_"OLDER RECORD"_HL("FS")_HL("FS")_"Y",1:"")
"RTN","MPIFBT3")
0^2^B16211266^B16907329
"RTN","MPIFBT3",1,0)
MPIFBT3 ;SLC/ARS-BATCH RESPONSE FROM MPI ;FEB 4, 1997
"RTN","MPIFBT3",2,0)
 ;;1.0;MASTER PATIENT INDEX VISTA;**1,3,10,17,21,24,28,31,33,35,43,52,58,60,68**;30 Apr 99;Build 2
"RTN","MPIFBT3",3,0)
 ;
"RTN","MPIFBT3",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFBT3",5,0)
 ;  ^DPT("AICN", ^DPT("AICNL", ^DPT("AMPIMIS" - #2070
"RTN","MPIFBT3",6,0)
 ;  EXC^RGHLLOG - #2796
"RTN","MPIFBT3",7,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFBT3",8,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFBT3",9,0)
 ;  EN1^DGPFMPI - #6002
"RTN","MPIFBT3",10,0)
 ;
"RTN","MPIFBT3",11,0)
MULT(CNTR,ACK5,SEP,MPIMSG,PATID) ;multiple RDT segments
"RTN","MPIFBT3",12,0)
 N NEXTTF,MPITMP S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)),NEXTTF=$P(ACK5,SEP,8)
"RTN","MPIFBT3",13,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:MPITMP'>0
"RTN","MPIFBT3",14,0)
 S ACK5=^XTMP($J,"MPIF","MPIIN",MPITMP) K NEXTTF,MPITMP
"RTN","MPIFBT3",15,0)
 I $P(ACK5,SEP)="RDT" D MULT(.CNTR,ACK5,SEP,MPIMSG,PATID) ; ^ add to treating facility list.  If not RDT continue on processing next msh
"RTN","MPIFBT3",16,0)
 Q
"RTN","MPIFBT3",17,0)
VFYRDT(ACK4,SEP,CNTR,PATID,SITE,MPIMSG) ;Here is the meat
"RTN","MPIFBT3",18,0)
 N MPIY,IEN,MPICMOR,MPICOMP S DGSENFLG=""
"RTN","MPIFBT3",19,0)
 S MPICOMP=$E(HL("ECH"),1)
"RTN","MPIFBT3",20,0)
 D RDT^MPIFSA3(.CNTR,.HL,.ACK4)
"RTN","MPIFBT3",21,0)
 D FINDHM(PATID,SEP,.MPIY,MPIMSG,CNTR)
"RTN","MPIFBT3",22,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",23,0)
 N MPINUM,MPICKG,MPIIT,DR,DIE,X,MPIIPPF,MPIPPF,RESLT,MPIFICN
"RTN","MPIFBT3",24,0)
 S MPIFICN=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",6),MPICKG=$P(MPIFICN,"V",2),MPINUM=$P(MPIFICN,"V",1)
"RTN","MPIFBT3",25,0)
 ;check if ICN already in use in Patient file
"RTN","MPIFBT3",26,0)
 I $D(^DPT("AICN",MPINUM)) D
"RTN","MPIFBT3",27,0)
 .Q:PATID=$O(^DPT("AICN",MPINUM,""))   ; same patient
"RTN","MPIFBT3",28,0)
 .S ^XTMP($J,"MPIF","MSHERR")="ICN already in use"
"RTN","MPIFBT3",29,0)
 .N DFN2 S DFN2=$O(^DPT("AICN",MPINUM,""))
"RTN","MPIFBT3",30,0)
 .D TWODFNS^MPIF002(DFN2,PATID,MPINUM)
"RTN","MPIFBT3",31,0)
 .;**52 need to trigger A28 add as if not found
"RTN","MPIFBT3",32,0)
 .S MPIFRPC=1 D A28^MPIFQ3(PATID) K MPIFRPC
"RTN","MPIFBT3",33,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",34,0)
 ;**60 (elz) MVI_793 need to store full ICN in new field
"RTN","MPIFBT3",35,0)
 S DIE="^DPT(",DA=$P(MPIY,"^",1),MPIIT=$P(MPIY,"^",1),DR="991.01////^S X=MPINUM;991.02////^S X=MPICKG;991.1////^S X=MPIFICN" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",36,0)
 S IEN=$P(MPIY,"^") ; check if need to kill Local/MISSING ICN field
"RTN","MPIFBT3",37,0)
 I $D(^DPT("AMPIMIS",IEN)) K ^DPT("AMPIMIS",IEN)
"RTN","MPIFBT3",38,0)
 I $D(^DPT("AICNL",1,IEN)) D
"RTN","MPIFBT3",39,0)
 .S DIE="^DPT(",DA=IEN,DR="991.04///@" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",40,0)
 S MPIIPPF=""
"RTN","MPIFBT3",41,0)
 S MPIPPF=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",5),MPICMOR=$$LKUP^XUAF4(MPIPPF)
"RTN","MPIFBT3",42,0)
 I MPICMOR'="" S MPIIPPF=$$CHANGE^MPIF001(MPIIT,MPICMOR)
"RTN","MPIFBT3",43,0)
 I +MPIIPPF<0 D EXC^RGHLLOG(211,"Around line number "_(CNTR*2)_"  CMOR= "_MPIPPF_" DFN= "_MPIIT_"  MESSAGE# "_MPIMSG,MPIIT)
"RTN","MPIFBT3",44,0)
 Q:+MPIIPPF<0
"RTN","MPIFBT3",45,0)
 I $D(^TMP("MPIFVQQ",$J,CNTR,"TF")) D
"RTN","MPIFBT3",46,0)
 . N MPINTFI,MPINTF,TFSTRG,TFIEN
"RTN","MPIFBT3",47,0)
 . S MPINTFI=0,MPINTF="",TFIEN="",TFSTRG=""
"RTN","MPIFBT3",48,0)
 . F  S MPINTFI=$O(^TMP("MPIFVQQ",$J,CNTR,"TF",MPINTFI)) Q:'MPINTFI  D
"RTN","MPIFBT3",49,0)
 .. S MPINTF=^TMP("MPIFVQQ",$J,CNTR,"TF",MPINTFI)
"RTN","MPIFBT3",50,0)
 .. S TFIEN=$$IEN^XUAF4($P(MPINTF,MPICOMP,1))
"RTN","MPIFBT3",51,0)
 .. Q:'TFIEN
"RTN","MPIFBT3",52,0)
 .. S TFSTRG=TFIEN_"^"_$$FMDATE^HLFNC($P(MPINTF,MPICOMP,2))_"^"_$P(MPINTF,MPICOMP,3)
"RTN","MPIFBT3",53,0)
 .. D FILE^VAFCTFU(PATID,TFSTRG,1)
"RTN","MPIFBT3",54,0)
 . ;**58 MVI 2593 To trigger the Patient Record Flag process as in DGREG and DG10
"RTN","MPIFBT3",55,0)
 . N PRF S PRF=$$EN1^DGPFMPI(PATID)
"RTN","MPIFBT3",56,0)
 S RESLT=$$A24^MPIFA24B(PATID)
"RTN","MPIFBT3",57,0)
 ;**68, Story 827754 (jfw) - Remove Duplicate A31 Logic (A24 call also sending A31)
"RTN","MPIFBT3",58,0)
 I +RESLT<0 D EXC^RGHLLOG(208,"Problem building A24 (ADD TF) for DFN= "_PATID,PATID)
"RTN","MPIFBT3",59,0)
 ;K RESLT N RESLT
"RTN","MPIFBT3",60,0)
 ;S RESLT=$$A31^MPIFA31B(PATID)
"RTN","MPIFBT3",61,0)
 ;I +RESLT<0 D EXC^RGHLLOG(208,"Problem building A31 for DFN= "_PATID,PATID)
"RTN","MPIFBT3",62,0)
 K ^TMP("MPIFVQQ",$J)
"RTN","MPIFBT3",63,0)
 Q
"RTN","MPIFBT3",64,0)
FINDHM(PATID,SEP,MPIY,MPIMSG,CNTR) ;LOOKUP
"RTN","MPIFBT3",65,0)
 N DIC,X,Y,NM,YTMP,MPIN,EXACT
"RTN","MPIFBT3",66,0)
 Q:'$D(^TMP("MPIFVQQ",$J,CNTR,"DATA"))
"RTN","MPIFBT3",67,0)
 ;added I to DIC(0) allow processing of sensitive patients when DUZ=0
"RTN","MPIFBT3",68,0)
 S DGSENFLG="",DIC="^DPT(",DIC(0)="OISZ",X="`"_PATID D ^DIC K DIC
"RTN","MPIFBT3",69,0)
 S YTMP=Y
"RTN","MPIFBT3",70,0)
 I YTMP=-1 S ^XTMP($J,"MPIF","MSHERR")="LOOKUP FAILED" D EXC^RGHLLOG(210,"SSN = "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3)_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",71,0)
 Q:YTMP=-1
"RTN","MPIFBT3",72,0)
 S NM=$P(Y(0),"^"),YTMP=$G(Y(0)),MPIY=Y ; check if ICN already populated
"RTN","MPIFBT3",73,0)
 N ICN S ICN=$$GETICN^MPIF001(PATID)
"RTN","MPIFBT3",74,0)
 I +ICN'=-1,$E(+ICN,1,3)'=$P($$SITE^VASITE,"^",3) S ^XTMP($J,"MPIF","MSHERR")="Patient "_PATID_" Already has an ICN"
"RTN","MPIFBT3",75,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",76,0)
 S Y(0)=$G(YTMP)
"RTN","MPIFBT3",77,0)
 ;**43 ONLY EXACT MATCHES BEING RETURNED NO LONGER MAKE THESE CHECKES IN VISTA
"RTN","MPIFBT3",78,0)
 ;Q:$P(Y(0),"^",9)["P"&($P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3)="")
"RTN","MPIFBT3",79,0)
 ;I $P(Y(0),"^",9)'=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3) D
"RTN","MPIFBT3",80,0)
 ;.S ^XTMP($J,"MPIF","MSHERR")="SSN MISMATCH"
"RTN","MPIFBT3",81,0)
 ;.D EXC^RGHLLOG(213,"SSN on File = "_$P(Y(0),"^",9)_" SSN in Message = "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3)_"    MESSAGE # "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",82,0)
 ;.N LICN S LICN=$$ICNLC^MPIF001(PATID) ; create local ICN
"RTN","MPIFBT3",83,0)
 ;Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",84,0)
 ;D NAME^VAFCPID2(0,.NM,0) ; reformat name in DG 149 fashion for comparison
"RTN","MPIFBT3",85,0)
 ;S MPIN=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",2)_","_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",7)
"RTN","MPIFBT3",86,0)
 ;I $P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",10)'="" S MPIN=MPIN_" "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",10)
"RTN","MPIFBT3",87,0)
 ;I $P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",15)'="" S MPIN=MPIN_" "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",15)
"RTN","MPIFBT3",88,0)
 ;I $P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",14)'="" S MPIN=MPIN_" "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",14)
"RTN","MPIFBT3",89,0)
 ;D NAME^VAFCPID2(0,.MPIN,0)
"RTN","MPIFBT3",90,0)
 ; check if Last and First Match--yes-- then check if middle name vs initial
"RTN","MPIFBT3",91,0)
 ;I $P(NM,",")=$P(MPIN,",")&($P($P(MPIN,",",2)," ")=$P($P(NM,",",2)," ")) D
"RTN","MPIFBT3",92,0)
 ;.N MPIMID,NMMN S MPIMID=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",10)
"RTN","MPIFBT3",93,0)
 ;.S NMMN=$P($P(NM,",",2)," ",2)
"RTN","MPIFBT3",94,0)
 ;.I $L(NMMN)>1&($L(MPIMID)=1),($E(NMMN,1)=MPIMID) S EXACT=1
"RTN","MPIFBT3",95,0)
 ;.I $L(MPIMID)>1&($L(NMMN)=1),($E(MPIMID,1)=NMMN) S EXACT=1
"RTN","MPIFBT3",96,0)
 ;I NM'=MPIN,'$D(EXACT) D
"RTN","MPIFBT3",97,0)
 ;.S ^XTMP($J,"MPIF","MSHERR")="NAME MISMATCH"
"RTN","MPIFBT3",98,0)
 ;.D EXC^RGHLLOG(214,"Name on File = "_$P(Y(0),"^")_"  Name in Message = "_MPIN_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",99,0)
 ;.N LICN S LICN=$$ICNLC^MPIF001(PATID) ;create local ICN
"RTN","MPIFBT3",100,0)
 ;check to see if SEX on MPI and local site match - no exception
"RTN","MPIFBT3",101,0)
 ;I $P($G(^DPT(PATID,0)),"^",2)'=$P($G(^TMP("MPIFVQQ",$J,CNTR,"DATA")),"^",11) D
"RTN","MPIFBT3",102,0)
 ;.S ^XTMP($J,"MPIF","MSHERR")="SEX MISMATCH"
"RTN","MPIFBT3",103,0)
 ;.D EXC^RGHLLOG(209,"PT on MPI "_MPIN_" has gender as "_$P($G(^TMP("MPIFVQQ",$J,CNTR,"DATA")),"^",10)_" While the Patient DFN= "_PATID_" has "_$P($G(^DPT(PATID,0)),"^",2)_" msg # "_MPIMSG_" about line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",104,0)
 ;.N LICN S LICN=$$ICNLC^MPIF001(PATID) ;create local ICN
"RTN","MPIFBT3",105,0)
 ;
"RTN","MPIFBT3",106,0)
 ;check to see if MPI has Date of Death or if VistA has DOD
"RTN","MPIFBT3",107,0)
 ;N MPIDTH,VISTDTH K %DT
"RTN","MPIFBT3",108,0)
 ;I $P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",9)'="" S X=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",9) D ^%DT S MPIDTH=Y
"RTN","MPIFBT3",109,0)
 ;I $D(^DPT(PATID,.35)),$P($G(^DPT(PATID,.35)),"^")'="" S VISTDTH=$P($G(^DPT(PATID,.35)),"^")\1
"RTN","MPIFBT3",110,0)
 ;I $D(MPIDTH)&$D(VISTDTH),MPIDTH'=VISTDTH D
"RTN","MPIFBT3",111,0)
 ;.N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y,Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",112,0)
 ;.D EXC^RGHLLOG(217,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",113,0)
 ; ^ BOTH HAVE DOD BUT THEY DON'T MATCH
"RTN","MPIFBT3",114,0)
 ;I '$D(MPIDTH)&($D(VISTDTH)) D
"RTN","MPIFBT3",115,0)
 ;.N Y S Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",116,0)
 ;.D EXC^RGHLLOG(216,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",117,0)
 ; ^ VISTA HAS DOD BUT MPI DOESN'T
"RTN","MPIFBT3",118,0)
 ;I $D(MPIDTH)&('$D(VISTDTH)) D
"RTN","MPIFBT3",119,0)
 ;.N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y
"RTN","MPIFBT3",120,0)
 ;.D EXC^RGHLLOG(215,"Around line "_(CNTR*2)_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",121,0)
 ; ^ MPI HAS DOD BUT VISTA DOESN'T
"RTN","MPIFBT3",122,0)
 Q
"VER")
8.0^22.2
"BLD",3357,6)
^65
**END**
**END**

