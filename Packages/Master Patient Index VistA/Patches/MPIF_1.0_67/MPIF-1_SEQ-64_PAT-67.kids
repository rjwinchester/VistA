Released MPIF*1*67 SEQ #64
Extracted from mail message
**KIDS**:MPIF*1.0*67^

**INSTALL NAME**
MPIF*1.0*67
"BLD",3326,0)
MPIF*1.0*67^MASTER PATIENT INDEX VISTA^0^3180529^y
"BLD",3326,1,0)
^^3^3^3180507^
"BLD",3326,1,1,0)
MASTER VETERAN INDEX VISTA ENHANCEMENTS - DATE OF DEATH UPDATES 
"BLD",3326,1,2,0)
Refer to patch MPIF*1.0*67 in the FORUM Patch Module for a complete
"BLD",3326,1,3,0)
description.
"BLD",3326,4,0)
^9.64PA^^
"BLD",3326,6.3)
2
"BLD",3326,"KRN",0)
^9.67PA^779.2^20
"BLD",3326,"KRN",.4,0)
.4
"BLD",3326,"KRN",.401,0)
.401
"BLD",3326,"KRN",.402,0)
.402
"BLD",3326,"KRN",.403,0)
.403
"BLD",3326,"KRN",.5,0)
.5
"BLD",3326,"KRN",.84,0)
.84
"BLD",3326,"KRN",3.6,0)
3.6
"BLD",3326,"KRN",3.8,0)
3.8
"BLD",3326,"KRN",9.2,0)
9.2
"BLD",3326,"KRN",9.8,0)
9.8
"BLD",3326,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",3326,"KRN",9.8,"NM",1,0)
MPIFDODC^^0^B51569177
"BLD",3326,"KRN",9.8,"NM",2,0)
MPIFVER^^0^B62395107
"BLD",3326,"KRN",9.8,"NM",3,0)
MPIFXMLP^^0^B94624059
"BLD",3326,"KRN",9.8,"NM","B","MPIFDODC",1)

"BLD",3326,"KRN",9.8,"NM","B","MPIFVER",2)

"BLD",3326,"KRN",9.8,"NM","B","MPIFXMLP",3)

"BLD",3326,"KRN",19,0)
19
"BLD",3326,"KRN",19.1,0)
19.1
"BLD",3326,"KRN",101,0)
101
"BLD",3326,"KRN",409.61,0)
409.61
"BLD",3326,"KRN",771,0)
771
"BLD",3326,"KRN",779.2,0)
779.2
"BLD",3326,"KRN",870,0)
870
"BLD",3326,"KRN",8989.51,0)
8989.51
"BLD",3326,"KRN",8989.52,0)
8989.52
"BLD",3326,"KRN",8994,0)
8994
"BLD",3326,"KRN","B",.4,.4)

"BLD",3326,"KRN","B",.401,.401)

"BLD",3326,"KRN","B",.402,.402)

"BLD",3326,"KRN","B",.403,.403)

"BLD",3326,"KRN","B",.5,.5)

"BLD",3326,"KRN","B",.84,.84)

"BLD",3326,"KRN","B",3.6,3.6)

"BLD",3326,"KRN","B",3.8,3.8)

"BLD",3326,"KRN","B",9.2,9.2)

"BLD",3326,"KRN","B",9.8,9.8)

"BLD",3326,"KRN","B",19,19)

"BLD",3326,"KRN","B",19.1,19.1)

"BLD",3326,"KRN","B",101,101)

"BLD",3326,"KRN","B",409.61,409.61)

"BLD",3326,"KRN","B",771,771)

"BLD",3326,"KRN","B",779.2,779.2)

"BLD",3326,"KRN","B",870,870)

"BLD",3326,"KRN","B",8989.51,8989.51)

"BLD",3326,"KRN","B",8989.52,8989.52)

"BLD",3326,"KRN","B",8994,8994)

"BLD",3326,"QDEF")
^^^^^^^^^^YES
"BLD",3326,"QUES",0)
^9.62^^
"BLD",3326,"REQB",0)
^9.611^2^2
"BLD",3326,"REQB",1,0)
MPIF*1.0*61^2
"BLD",3326,"REQB",2,0)
MPIF*1.0*66^2
"BLD",3326,"REQB","B","MPIF*1.0*61",1)

"BLD",3326,"REQB","B","MPIF*1.0*66",2)

"MBREQ")
0
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
67^3180529
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3180529
"PKG",282,22,1,"PAH",1,1,1,0)
MASTER VETERAN INDEX VISTA ENHANCEMENTS - DATE OF DEATH UPDATES 
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1.0*67 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","MPIFDODC")
0^1^B51569177^B48253214
"RTN","MPIFDODC",1,0)
MPIFDODC ;OAK/ELZ- DOD ACTIVITY CHECK ;6/9/2016
"RTN","MPIFDODC",2,0)
 ;;1.0;MASTER PATIENT INDEX VISTA;**64,66,67**;30 Apr 99;Build 2
"RTN","MPIFDODC",3,0)
 ; Integration Agreements Utilized:
"RTN","MPIFDODC",4,0)
 ;   IA #4433  $$SDAPI^SDAMA301
"RTN","MPIFDODC",5,0)
 ;   IA #4820  RX^PSO52API
"RTN","MPIFDODC",6,0)
 ;   IA #10062 IN5^VADPT and KVAR^VADPT
"RTN","MPIFDODC",7,0)
 ;   IA #92    ^DGPT("B",DFN), ^DGPT(PTF,0), ^DGPT(PTF,70)
"RTN","MPIFDODC",8,0)
 ;   IA #2548  OPEN^SDQ, INDEX^SDQ, PAT^SDQ, DATE^SDQ, SCANCB^SDQ,
"RTN","MPIFDODC",9,0)
 ;             ACTIVE^SDQ, SCAN^SDQ, CLOSE^SDQ
"RTN","MPIFDODC",10,0)
 ;   IA #6420  $$ACTIVITY^FBUTLMVI 
"RTN","MPIFDODC",11,0)
 ;   IA #2028  ^AUPNVSIT(
"RTN","MPIFDODC",12,0)
 ;   IA #3035  $$GETIENS^PXAAVCPT, $$CPT^PXAAVCPT
"RTN","MPIFDODC",13,0)
 ;
"RTN","MPIFDODC",14,0)
 ;
"RTN","MPIFDODC",15,0)
SITECK(RETURN,DFN,MPIDOD) ; - check various packages for activity after the
"RTN","MPIFDODC",16,0)
 ; date of death, called via RPC from the MPI
"RTN","MPIFDODC",17,0)
 ;
"RTN","MPIFDODC",18,0)
 N X,MPI52LST,MPINODE,MPIFB,VRETURN,MPIC,MPISDAR
"RTN","MPIFDODC",19,0)
 S RETURN=0
"RTN","MPIFDODC",20,0)
 ;
"RTN","MPIFDODC",21,0)
 ; Story 718545 (elz) check to make sure patient exists at site and return no activity if they are not there to have activity
"RTN","MPIFDODC",22,0)
 I '$D(^DPT(DFN,0)) Q
"RTN","MPIFDODC",23,0)
 ;
"RTN","MPIFDODC",24,0)
 ; Patients with appointments scheduled for dates after the current date,
"RTN","MPIFDODC",25,0)
 ; appointments that are cancelled should not be included.  The 
"RTN","MPIFDODC",26,0)
 ; appointment status should be set to blank, I, or NT.
"RTN","MPIFDODC",27,0)
 ; NOTE:  BLANK status is translated to R by the SDAMA301 call.
"RTN","MPIFDODC",28,0)
 K ^TMP($J,"SDAMA301")
"RTN","MPIFDODC",29,0)
 S MPISDAR("FLDS")=1
"RTN","MPIFDODC",30,0)
 S MPISDAR("MAX")=1
"RTN","MPIFDODC",31,0)
 S MPISDAR("SORT")="P"
"RTN","MPIFDODC",32,0)
 S MPISDAR(1)=$$FMADD^XLFDT(DT,1)
"RTN","MPIFDODC",33,0)
 S MPISDAR(3)="I;NT;R"
"RTN","MPIFDODC",34,0)
 S MPISDAR(4)=DFN
"RTN","MPIFDODC",35,0)
 S X=$$SDAPI^SDAMA301(.MPISDAR)
"RTN","MPIFDODC",36,0)
 I X S RETURN="1^"_($O(^TMP($J,"SDAMA301",DFN,0))\1)_"^Appointment Found"
"RTN","MPIFDODC",37,0)
 K ^TMP($J,"SDAMA301")
"RTN","MPIFDODC",38,0)
 Q:RETURN
"RTN","MPIFDODC",39,0)
 ;
"RTN","MPIFDODC",40,0)
 ;
"RTN","MPIFDODC",41,0)
 ; Patients with prescription fills requested after death.  The Log In
"RTN","MPIFDODC",42,0)
 ; date is the date the prescription was requested.
"RTN","MPIFDODC",43,0)
 ; Searching back 365 days + 90 days to ensure all possible prescriptions
"RTN","MPIFDODC",44,0)
 ; are included in the query since prescriptions can be set for up to 1
"RTN","MPIFDODC",45,0)
 ; year and initially filed within the first 90 days.
"RTN","MPIFDODC",46,0)
 ;
"RTN","MPIFDODC",47,0)
 S MPI52LST="MPIPSO",MPINODE="0,2,P,R"
"RTN","MPIFDODC",48,0)
 K ^TMP($J,MPI52LST,DFN)
"RTN","MPIFDODC",49,0)
 D RX^PSO52API(DFN,MPI52LST,,,MPINODE,$$FMADD^XLFDT(MPIDOD,-455))
"RTN","MPIFDODC",50,0)
 ; Story 718542 (elz) only use the login date (not time) for the comparison
"RTN","MPIFDODC",51,0)
 S X=0 F  S X=$O(^TMP($J,MPI52LST,DFN,X)) Q:'X!(RETURN)  D
"RTN","MPIFDODC",52,0)
 . N RF,P
"RTN","MPIFDODC",53,0)
 . I $P($P($G(^TMP($J,MPI52LST,DFN,X,21)),"^"),".")>MPIDOD S RETURN="1^"_($P(^(21),"^")\1)_"^Initial Rx Login" Q
"RTN","MPIFDODC",54,0)
 . S RF=0 F  S RF=$O(^TMP($J,MPI52LST,DFN,X,"RF",RF)) Q:'RF!(RETURN)  D
"RTN","MPIFDODC",55,0)
 .. I $P($G(^TMP($J,MPI52LST,DFN,X,"RF",RF,7)),".")>MPIDOD S RETURN="1^"_($P(^(7),"^")\1)_"^Refill Rx Login" Q
"RTN","MPIFDODC",56,0)
 . Q:RETURN
"RTN","MPIFDODC",57,0)
 . S P=0 F  S P=$O(^TMP($J,MPI52LST,DFN,X,"P",P)) Q:'P!(RETURN)  D
"RTN","MPIFDODC",58,0)
 .. I $P($G(^TMP($J,MPI52LST,DFN,X,"P",P,.08)),".")>MPIDOD S RETURN="1^"_($P(^(.08),"^")\1)_"^Partial Rx Login" Q
"RTN","MPIFDODC",59,0)
 I RETURN K ^TMP($J,MPI52LST,DFN) Q
"RTN","MPIFDODC",60,0)
 ;
"RTN","MPIFDODC",61,0)
 ; Rx part #2 (elz) MPIF*1*66
"RTN","MPIFDODC",62,0)
 ; the prescription was requested on or before the date of death, the fill date (FillDateTime)
"RTN","MPIFDODC",63,0)
 ; is after the current date, there is no date of death in the patient record at the
"RTN","MPIFDODC",64,0)
 ; corresponding station(Sta3n), and the prescription status (RxStatus) is ACTIVE, NON-VERIFIED,
"RTN","MPIFDODC",65,0)
 ; REFILL, HOLD, DRUG INTERACTIONS, SUSPENDED, 0, 1, 2, 3, 4, or 5
"RTN","MPIFDODC",66,0)
 ;- If there is no DOD at current site (I'd do this first just to quickly eliminate)
"RTN","MPIFDODC",67,0)
 I '$P($G(^DPT(DFN,.35)),"^") D
"RTN","MPIFDODC",68,0)
 . ;- Then loop through rx's
"RTN","MPIFDODC",69,0)
 . S X=0 F  S X=$O(^TMP($J,MPI52LST,DFN,X)) Q:'X!(RETURN)  D
"RTN","MPIFDODC",70,0)
 .. ; Check status 0,1,2,3,4,5 (also quickly eliminate rx's based on status early
"RTN","MPIFDODC",71,0)
 .. I $P($G(^TMP($J,MPI52LST,DFN,X,100)),"^")'="",$P($G(^TMP($J,MPI52LST,DFN,X,100)),"^")<6 D
"RTN","MPIFDODC",72,0)
 ... N RF,P
"RTN","MPIFDODC",73,0)
 ... ; if Rx initial Rx requested on or before DOD (login date/time #21) AND if Fill Date>DT (#22) return activity
"RTN","MPIFDODC",74,0)
 ... I $P($G(^TMP($J,MPI52LST,DFN,X,21)),".")'>MPIDOD,$G(^(21)),$P($G(^(22)),".")>DT S RETURN="1^"_(^(21)\1)_"^Initial Rx'>DOD,"_(^(22)\1)_">DT" Q
"RTN","MPIFDODC",75,0)
 ... ; loop through refills
"RTN","MPIFDODC",76,0)
 ... S RF=0 F  S RF=$O(^TMP($J,MPI52LST,DFN,X,"RF",RF)) Q:'RF!(RETURN)  D
"RTN","MPIFDODC",77,0)
 .... ;if refill requested on or before DOD (login date/time #7) AND if Fill Date>DT (#.01) return activity
"RTN","MPIFDODC",78,0)
 .... I $P($G(^TMP($J,MPI52LST,DFN,X,"RF",RF,7)),".")'>MPIDOD,$G(^(7)),$P($G(^(.01)),".")>DT S RETURN="1^"_(^(7)\1)_"^Refill'>DOD,"_(^(.01)\1)_">DT" Q
"RTN","MPIFDODC",79,0)
 ... ; loop through partials
"RTN","MPIFDODC",80,0)
 ... S P=0 F  S P=$O(^TMP($J,MPI52LST,DFN,X,"P",P)) Q:'P!(RETURN)  D
"RTN","MPIFDODC",81,0)
 .... ;if partial requested on or before DOD (login date/time #.08) AND if Fill Date>DT (#.01) return activiy
"RTN","MPIFDODC",82,0)
 .... I $P($G(^TMP($J,MPI52LST,DFN,X,"P",P,.08)),".")'>MPIDOD,$G(^(.08)),$P($G(^(.01)),".")>DT S RETURN="1^"_(^(.08)\1)_"Partial'>DOD,"_(^(.01)\1)_">DT" Q
"RTN","MPIFDODC",83,0)
 K ^TMP($J,MPI52LST,DFN)
"RTN","MPIFDODC",84,0)
 Q:RETURN
"RTN","MPIFDODC",85,0)
 ;
"RTN","MPIFDODC",86,0)
 ;
"RTN","MPIFDODC",87,0)
 ; Note: The next two categories are only considered when:
"RTN","MPIFDODC",88,0)
 ;  (1) the VistA patient record being checked for activity has no death
"RTN","MPIFDODC",89,0)
 ;      date or
"RTN","MPIFDODC",90,0)
 ;  (2) the VistA patient record being checked for activity has a death
"RTN","MPIFDODC",91,0)
 ;      date, and the source is other than INPATIENT AT VAMC.
"RTN","MPIFDODC",92,0)
 S X=$G(^DPT(DFN,35)) I 'X!(X&($P(X,"^",3)'=1)) D  Q:RETURN
"RTN","MPIFDODC",93,0)
 . ;
"RTN","MPIFDODC",94,0)
 . N VAIP,MPIARR,PTF
"RTN","MPIFDODC",95,0)
 . ; i. Patients with an inpatient discharge date more than one day after
"RTN","MPIFDODC",96,0)
 . ;    the date of death, VHA facility: The discharge date is more than
"RTN","MPIFDODC",97,0)
 . ;    one day after the date of death or the patient has not been
"RTN","MPIFDODC",98,0)
 . ;    discharged (currently an inpatient).
"RTN","MPIFDODC",99,0)
 . S VAIP("D")="LAST",VAIP("M")=0 D IN5^VADPT
"RTN","MPIFDODC",100,0)
 . I VAIP(1),'VAIP(17) S RETURN="1^^No Discharge Movement" Q
"RTN","MPIFDODC",101,0)
 . I $P(VAIP(17,1),".")>$$FMADD^XLFDT(MPIDOD,1) S RETURN="1^"_(VAIP(17,1)\1)_"^Last Discharge > DOD" Q
"RTN","MPIFDODC",102,0)
 . D KVAR^VADPT
"RTN","MPIFDODC",103,0)
 . ;
"RTN","MPIFDODC",104,0)
 . ;
"RTN","MPIFDODC",105,0)
 . ;ii. Purchased care: The discharge date is more than one day after
"RTN","MPIFDODC",106,0)
 . ;    the date of death. If there is no discharge date, use the
"RTN","MPIFDODC",107,0)
 . ;    admission date.  Have to go to the PTF as the FEE ones don't
"RTN","MPIFDODC",108,0)
 . ;    create movements and don't show in the VADPT calls.
"RTN","MPIFDODC",109,0)
 . ; get the last ptf record.
"RTN","MPIFDODC",110,0)
 . S PTF=$O(^DGPT("B",DFN,":"),-1)_","
"RTN","MPIFDODC",111,0)
 . I PTF D GETS^DIQ(45,PTF_",","2;70","I","MPIARR")
"RTN","MPIFDODC",112,0)
 . ; really we don't care if it was FEE or not, it was after the DOD
"RTN","MPIFDODC",113,0)
 . ; Story 722864 (elz) update return text to include PTF file (#45) IEN=nnnn
"RTN","MPIFDODC",114,0)
 . I $P($G(MPIARR(45,PTF,70,"I")),".")>$$FMADD^XLFDT(MPIDOD,1) S RETURN="1^"_(MPIARR(45,PTF,70,"I")\1)_"^PTF Record with discharge after DOD, PTF file (#45) IEN="_+PTF Q
"RTN","MPIFDODC",115,0)
 . E  I $P($G(MPIARR(45,PTF,2,"I")),".")>$$FMADD^XLFDT(MPIDOD,1) S RETURN="1^"_(MPIARR(45,PTF,2,"I")\1)_"^PTF with admission after DOD, PTF file (#45) IEN="_+PTF
"RTN","MPIFDODC",116,0)
 ;
"RTN","MPIFDODC",117,0)
 ; Patients with two or more of the following health care events after
"RTN","MPIFDODC",118,0)
 ; death
"RTN","MPIFDODC",119,0)
 S MPIC=0
"RTN","MPIFDODC",120,0)
 ; i. Visits that are not historical entries, are not non-count, and have
"RTN","MPIFDODC",121,0)
 ;    a procedure code recorded on the visit
"RTN","MPIFDODC",122,0)
 K ^TMP("DIERR",$J) D
"RTN","MPIFDODC",123,0)
 . N MPIQ
"RTN","MPIFDODC",124,0)
 . D OPEN^SDQ(.MPIQ) Q:'$G(MPIQ)
"RTN","MPIFDODC",125,0)
 . D INDEX^SDQ(.MPIQ,"PATIENT/DATE","SET")
"RTN","MPIFDODC",126,0)
 . D SCANCB^SDQ(.MPIQ,"D CALLBACK^MPIFDODC(Y0)","SET")
"RTN","MPIFDODC",127,0)
 . D PAT^SDQ(.MPIQ,DFN,"SET")
"RTN","MPIFDODC",128,0)
 . D DATE^SDQ(.MPIQ,$$FMADD^XLFDT(MPIDOD,1),9999999,"SET")
"RTN","MPIFDODC",129,0)
 . D ACTIVE^SDQ(.MPIQ,"TRUE","SET")
"RTN","MPIFDODC",130,0)
 . D SCAN^SDQ(.MPIQ,"FORWARD")
"RTN","MPIFDODC",131,0)
 . D CLOSE^SDQ(.MPIQ)
"RTN","MPIFDODC",132,0)
 K ^TMP("DIERR",$J)
"RTN","MPIFDODC",133,0)
 ;
"RTN","MPIFDODC",134,0)
 I MPIC>1,$G(VRETURN) S RETURN=VRETURN Q
"RTN","MPIFDODC",135,0)
 ;
"RTN","MPIFDODC",136,0)
 ; ii. Purchased Care with treatment dates after date of death
"RTN","MPIFDODC",137,0)
 S MPIFB=$$ACTIVITY^FBUTLMVI(DFN,MPIDOD,.MPIFB)
"RTN","MPIFDODC",138,0)
 I MPIFB+MPIC>1 S RETURN="1^"_MPIFB(+$O(MPIFB(0)))
"RTN","MPIFDODC",139,0)
 ;
"RTN","MPIFDODC",140,0)
 Q
"RTN","MPIFDODC",141,0)
 ;
"RTN","MPIFDODC",142,0)
CALLBACK(MPIOE) ; - Called back from the SDQ
"RTN","MPIFDODC",143,0)
 N MPIVISIT,MPICPT,MPICPTV,MPIARR,MPIS
"RTN","MPIFDODC",144,0)
 Q:$P(MPIOE,"^",12)=12  ; non-count encounter
"RTN","MPIFDODC",145,0)
 S MPIVISIT=$P(MPIOE,"^",5)_"," Q:'MPIVISIT
"RTN","MPIFDODC",146,0)
 D GETS^DIQ(9000010,MPIVISIT,".07","I","MPIARR")
"RTN","MPIFDODC",147,0)
 Q:$G(MPIARR(9000010,"4,",.07,"I"))="E"  ; historical
"RTN","MPIFDODC",148,0)
 S MPICPT=$$GETIENS^PXAAVCPT(+MPIVISIT,.MPICPT)
"RTN","MPIFDODC",149,0)
 Q:'MPICPT  ; no procedures found
"RTN","MPIFDODC",150,0)
 S MPIS=0
"RTN","MPIFDODC",151,0)
 S MPICPT=0 F  S MPICPT=$O(MPICPT(MPICPT)) Q:'MPICPT!(MPIS)  D
"RTN","MPIFDODC",152,0)
 . S MPICPTV=$$CPT^PXAAVCPT(MPICPT)
"RTN","MPIFDODC",153,0)
 . Q:$L($T(@MPICPTV))  ; cpt on the exclude list
"RTN","MPIFDODC",154,0)
 . S MPIC=MPIC+1,VRETURN="1^"_(MPIOE\1)_"^Multiple visits found",MPIS=1
"RTN","MPIFDODC",155,0)
 I MPIC>1 S SDSTOP=1
"RTN","MPIFDODC",156,0)
 Q
"RTN","MPIFDODC",157,0)
CPTS ; - list of cpt codes to ignore
"RTN","MPIFDODC",158,0)
98966 ;;HC PRO PHONE CALL 5-10 MIN
"RTN","MPIFDODC",159,0)
98967 ;;HC PRO PHONE CALL 11-20 MIN
"RTN","MPIFDODC",160,0)
98968 ;;HC PRO PHONE CALL 21-30 MIN
"RTN","MPIFDODC",161,0)
99441 ;;PHONE E/M PHYS/QHP 5-10 MIN
"RTN","MPIFDODC",162,0)
99373 ;;PHYSICIAN PHONE CONSULTATION
"RTN","MPIFDODC",163,0)
99442 ;;PHONE E/M PHYS/QHP 11-20 MIN
"RTN","MPIFDODC",164,0)
99371 ;;PHYSICIAN PHONE CONSULTATION
"RTN","MPIFDODC",165,0)
99377 ;;HOSPICE CARE SUPERVISION
"RTN","MPIFDODC",166,0)
99378 ;;HOSPICE CARE SUPERVISION
"RTN","MPIFDODC",167,0)
99372 ;;PHYSICIAN PHONE CONSULTATION
"RTN","MPIFDODC",168,0)
G0182 ;;HOSPICE CARE SUPERVISION
"RTN","MPIFDODC",169,0)
99443 ;;PHONE E/M PHYS/QHP 21-30 MIN
"RTN","MPIFDODC",170,0)
99380 ;;NURSING FAC CARE SUPERVISION
"RTN","MPIFDODC",171,0)
S0320 ;;RN TELEPHONE CALLS TO DMP
"RTN","MPIFDODC",172,0)
99339 ;;DOMICIL/R-HOME CARE SUPERVIS
"RTN","MPIFDODC",173,0)
99447 ;;INTERPROF PHONE/ONLINE 11-20
"RTN","MPIFDODC",174,0)
99448 ;;INTERPROF PHONE/ONLINE 21-30
"RTN","MPIFVER")
0^2^B62395107^B55653915
"RTN","MPIFVER",1,0)
MPIFVER ;ALB/CKN,VISTA ENTERPRISE REGISTRATION ; 7/26/17 2:18pm
"RTN","MPIFVER",2,0)
 ;;1.0;MASTER PATIENT INDEX VISTA;**61,62,65,66,67**;30 Apr 99;Build 2
"RTN","MPIFVER",3,0)
 Q
"RTN","MPIFVER",4,0)
ENP(RESULTS,ALTRSHLD,TKTRSHLD) ;
"RTN","MPIFVER",5,0)
 N XCNT,XCNTR,DFN,TMPRESLT
"RTN","MPIFVER",6,0)
 S XCNT="",XCNTR="",DFN=""
"RTN","MPIFVER",7,0)
 D DISPLAY
"RTN","MPIFVER",8,0)
 I XCNTR'="" D
"RTN","MPIFVER",9,0)
 . M TMPRESLT(1)=RESULTS(XCNTR)
"RTN","MPIFVER",10,0)
 . K RESULTS M RESULTS=TMPRESLT
"RTN","MPIFVER",11,0)
 S DFN=$$BR(XCNTR)
"RTN","MPIFVER",12,0)
 Q DFN
"RTN","MPIFVER",13,0)
BR(XCNTR) ;Business rules
"RTN","MPIFVER",14,0)
 N ICN,SSN,MPIIDS
"RTN","MPIFVER",15,0)
 ;If no record is selected by user, return empty RESULTS and no DFN
"RTN","MPIFVER",16,0)
 I XCNTR="" K RESULTS  Q ""
"RTN","MPIFVER",17,0)
 ;
"RTN","MPIFVER",18,0)
 S ICN=$G(RESULTS(1,"ICN")),SSN=$G(RESULTS(1,"SSN"))
"RTN","MPIFVER",19,0)
 ;If user select record with NO ICN value, return no DFN and single
"RTN","MPIFVER",20,0)
 ;record in RESULTS
"RTN","MPIFVER",21,0)
 I ICN="" Q DFN
"RTN","MPIFVER",22,0)
 ;If user select record with ICN value, check PATIENT file for
"RTN","MPIFVER",23,0)
 ;ICN. If it exist, return DFN. If it does not exist, check for
"RTN","MPIFVER",24,0)
 ;SSN. If SSN exist, Notify user and return empty DFN and RESULTS to
"RTN","MPIFVER",25,0)
 ;go back to select patient prompt.
"RTN","MPIFVER",26,0)
 I $D(^DPT("AICN",+ICN)) D  Q DFN
"RTN","MPIFVER",27,0)
 . S DFN=$O(^DPT("AICN",+ICN,""))
"RTN","MPIFVER",28,0)
 . K RESULTS
"RTN","MPIFVER",29,0)
 I SSN'="",($D(^DPT("SSN",SSN))) D  Q DFN
"RTN","MPIFVER",30,0)
 . N IEN,NAME
"RTN","MPIFVER",31,0)
 . S IEN=$O(^DPT("SSN",SSN,"")),NAME=$P($G(^DPT(IEN,0)),"^"),DFN=-1
"RTN","MPIFVER",32,0)
 . W !,"SSN in selected record already exist in PATIENT file..."
"RTN","MPIFVER",33,0)
 . K RESULTS
"RTN","MPIFVER",34,0)
 ;If existing patient not found in VistA,
"RTN","MPIFVER",35,0)
 ;Call Enterprise Get Corresponding IDs, confirm MVI doesn't know
"RTN","MPIFVER",36,0)
 ;this site already (active record) - if the site is already known
"RTN","MPIFVER",37,0)
 ;need use that DFN.
"RTN","MPIFVER",38,0)
 D GETIDS^MPIFXMLG(.MPIIDS,RESULTS(1,"ICN"))
"RTN","MPIFVER",39,0)
 N ID,CN,STNUM,QFLG
"RTN","MPIFVER",40,0)
 S STNUM=$P($$SITE^VASITE(),"^",3),QFLG=0
"RTN","MPIFVER",41,0)
 S CN=0 F  S CN=$O(MPIIDS(CN)) Q:+CN=0!(QFLG)  D
"RTN","MPIFVER",42,0)
 . I $G(MPIIDS(CN,"IDType"))="PI",($G(MPIIDS(CN,"Source"))=STNUM) D  Q
"RTN","MPIFVER",43,0)
 .. S DFN=$G(MPIIDS(CN,"ID")),QFLG=1
"RTN","MPIFVER",44,0)
 .. K RESULTS
"RTN","MPIFVER",45,0)
 .;If 200ESR is one of the site, set a flag to trigger Z11 query.
"RTN","MPIFVER",46,0)
 . I $G(MPIIDS(CN,"Source"))="200ESR" S RESULTS(1,"Z11")=1
"RTN","MPIFVER",47,0)
 Q DFN
"RTN","MPIFVER",48,0)
DISPLAY ;
"RTN","MPIFVER",49,0)
 N CNT1,NAME,FNAME,MNAME,SCORE,SSN,DOB,ICN,SEX,LNAME,M,XMPIVER,EFLG,ECNT,DOD,DODFLG
"RTN","MPIFVER",50,0)
 S CNT1=0,EFLG=0,DODFLG=0
"RTN","MPIFVER",51,0)
 F  S CNT1=$O(RESULTS(CNT1)) Q:+CNT1=0  D
"RTN","MPIFVER",52,0)
 . N DOD
"RTN","MPIFVER",53,0)
 . S FNAME=$G(RESULTS(CNT1,"FirstName")),SSN=$G(RESULTS(CNT1,"SSN"))
"RTN","MPIFVER",54,0)
 . S DOB=$G(RESULTS(CNT1,"DOB")),ICN=$G(RESULTS(CNT1,"ICN"))
"RTN","MPIFVER",55,0)
 . ; Story 722746 (elz) need dod if there is one and set flag
"RTN","MPIFVER",56,0)
 . I $D(RESULTS(CNT1,"DOD")) S DOD=RESULTS(CNT1,"DOD"),DODFLG=1
"RTN","MPIFVER",57,0)
 . S SEX=$G(RESULTS(CNT1,"Gender")),LNAME=$G(RESULTS(CNT1,"Surname"))
"RTN","MPIFVER",58,0)
 . S MNAME=$G(RESULTS(CNT1,"MiddleName"))
"RTN","MPIFVER",59,0)
 . S SCORE=+$G(RESULTS(CNT1,"Score")),NAME=LNAME_","_FNAME_" "_MNAME
"RTN","MPIFVER",60,0)
 . I ICN="",($D(RESULTS(CNT1,"IDS"))) D
"RTN","MPIFVER",61,0)
 .. S EFLG=1,ECNT=0 F  S ECNT=$O(RESULTS(CNT1,"IDS",ECNT)) Q:+ECNT=0  D
"RTN","MPIFVER",62,0)
 ... I $G(RESULTS(CNT1,"IDS",ECNT,"SOURCE"))="200DOD" S ICN=$G(RESULTS(CNT1,"IDS",ECNT,"ID"))  ;Get EDIPI instead of ICN if from DoD
"RTN","MPIFVER",63,0)
 . S M=$S(SCORE>=ALTRSHLD:"E",1:"P")
"RTN","MPIFVER",64,0)
 . ;Rearranging array for sectional view display
"RTN","MPIFVER",65,0)
 . ;Story 722746 (elz) add "*" to ICN for display if deceased
"RTN","MPIFVER",66,0)
 . S XMPIVER("MPIVER",M,SCORE,CNT1)=NAME_"^"_SSN_"^"_DOB_"^"_SEX_"^"_$S($D(DOD):"*",1:"")_ICN
"RTN","MPIFVER",67,0)
DISP2 ;
"RTN","MPIFVER",68,0)
 N DIR,DA,DR,Y,X,DATA,ENOUGH,COUNT,I,SCORE,CNTR
"RTN","MPIFVER",69,0)
 S COUNT=0
"RTN","MPIFVER",70,0)
 W @IOF
"RTN","MPIFVER",71,0)
 F I="E","P" D
"RTN","MPIFVER",72,0)
 . I $D(XMPIVER("MPIVER",I)) D HDR($S(I="E":"",I="P":" POTENTIAL",1:""))
"RTN","MPIFVER",73,0)
 . S SCORE=9999999 F  S SCORE=$O(XMPIVER("MPIVER",I,SCORE),-1) Q:SCORE=""  D
"RTN","MPIFVER",74,0)
 .. S CNTR=0 F  S CNTR=$O(XMPIVER("MPIVER",I,SCORE,CNTR)) Q:CNTR=""  D
"RTN","MPIFVER",75,0)
 ... S COUNT=COUNT+1
"RTN","MPIFVER",76,0)
 ... S XMPIVER("MPIVER",I,SCORE,CNTR,COUNT)=""
"RTN","MPIFVER",77,0)
 ... S DATA=$G(XMPIVER("MPIVER",I,SCORE,CNTR))
"RTN","MPIFVER",78,0)
 ... D HDR1
"RTN","MPIFVER",79,0)
 ... ; Story 722746 (elz) increase space to allow for * for dod patients
"RTN","MPIFVER",80,0)
 ... W !,COUNT_") ",?3,$P(DATA,"^",5),?22,$P(DATA,"^"),?53,$P(DATA,"^",2),?64,$$FMTE^XLFDT($P(DATA,"^",3),2),?76,$P(DATA,"^",4)
"RTN","MPIFVER",81,0)
 ; Story 722746 (elz) if any are deceased, display message
"RTN","MPIFVER",82,0)
 I DODFLG W !!,"*Candidate list includes a deceased patient"
"RTN","MPIFVER",83,0)
 S XMPIVER("COUNT")=$G(COUNT)
"RTN","MPIFVER",84,0)
 S ENOUGH=0
"RTN","MPIFVER",85,0)
 W !
"RTN","MPIFVER",86,0)
 D ASK I ENOUGH G ASK2
"RTN","MPIFVER",87,0)
 I XCNT'="" W !,"Please wait..." D EXDISP(XCNT)
"RTN","MPIFVER",88,0)
 W !!
"RTN","MPIFVER",89,0)
 K DIR,DA S DIR(0)="Y",DIR("B")="NO",DIR("A")="Would you like to see another record" D ^DIR
"RTN","MPIFVER",90,0)
 I $D(DTOUT)!($D(DUOUT))!(Y=0) S ENOUGH=1 G ASK2
"RTN","MPIFVER",91,0)
 I Y G DISP2
"RTN","MPIFVER",92,0)
EXIT K DA,X,Y,XMPIVER("MPIVER") W !! Q
"RTN","MPIFVER",93,0)
HDR(HDL) ;Header
"RTN","MPIFVER",94,0)
 W !,"--- Records meet the"_HDL_" MATCH criteria ---"
"RTN","MPIFVER",95,0)
 Q
"RTN","MPIFVER",96,0)
HDR1 ;Repeating header
"RTN","MPIFVER",97,0)
 ; Story 503957 (elz) Added 'Birth' above 'Sex'
"RTN","MPIFVER",98,0)
 W:$X>50 ! W ?74,"BIRTH"
"RTN","MPIFVER",99,0)
 ; Stroy 722746 space out name for dod patients
"RTN","MPIFVER",100,0)
 W !,?3,$S(EFLG=1:"EDIPI",1:"ICN"),?22,"NAME",?53,"SSN",?64,"DOB",?75,"SEX"
"RTN","MPIFVER",101,0)
 Q
"RTN","MPIFVER",102,0)
ASK ;
"RTN","MPIFVER",103,0)
 N COUNT,DIR,DA,DR,ND,SC,CNTR,BC,QFLG
"RTN","MPIFVER",104,0)
 S BC=1,COUNT=$G(XMPIVER("COUNT"))
"RTN","MPIFVER",105,0)
 K DIR,X,Y S DIR(0)="NA^"_BC_":"_COUNT,DIR("A")="Enter the Number to display the details: ",DIR("?")="Enter the number from range of "_BC_" to "_COUNT D ^DIR
"RTN","MPIFVER",106,0)
 I $D(DTOUT)!($D(DUOUT)) S ENOUGH=1 Q
"RTN","MPIFVER",107,0)
 I Y S XCNT=$$CNTR(Y)
"RTN","MPIFVER",108,0)
 Q
"RTN","MPIFVER",109,0)
 ;
"RTN","MPIFVER",110,0)
CNTR(Y) ;
"RTN","MPIFVER",111,0)
 N SC,ND,CNTR,QFLG
"RTN","MPIFVER",112,0)
 S QFLG=0,XCNT=""
"RTN","MPIFVER",113,0)
 F I="E","P" D
"RTN","MPIFVER",114,0)
 . S SC=0 F  S SC=$O(XMPIVER("MPIVER",I,SC)) Q:+SC=0!(QFLG)  D
"RTN","MPIFVER",115,0)
 .. S CNTR=0 F  S CNTR=$O(XMPIVER("MPIVER",I,SC,CNTR)) Q:+CNTR=0!(QFLG)  D
"RTN","MPIFVER",116,0)
 ... S ND=$O(XMPIVER("MPIVER",I,SC,CNTR,""))
"RTN","MPIFVER",117,0)
 ... I ND=+Y S QFLG=1,XCNT=CNTR
"RTN","MPIFVER",118,0)
 Q XCNT
"RTN","MPIFVER",119,0)
ASK2 ;
"RTN","MPIFVER",120,0)
 N X,Y,DIR,DA,DR,BC,COUNT
"RTN","MPIFVER",121,0)
 S BC=1
"RTN","MPIFVER",122,0)
 S COUNT=$G(XMPIVER("COUNT"))
"RTN","MPIFVER",123,0)
 ;**65 - Story 557826 (ckn)
"RTN","MPIFVER",124,0)
 ;For below prompt - set default value to YES only if any query result
"RTN","MPIFVER",125,0)
 ;have at least one Exact match returned. set to NO if only Potential
"RTN","MPIFVER",126,0)
 ;matches are returned.
"RTN","MPIFVER",127,0)
 K DIR,X,Y S DIR(0)="Y",DIR("B")=$S($D(XMPIVER("MPIVER","E")):"YES",1:"NO"),DIR("A")="Would you like to select a patient from above Enterprise Search" D ^DIR
"RTN","MPIFVER",128,0)
 I $D(DTOUT)!($D(DUOUT)) S ENOUGH=1 G EXIT
"RTN","MPIFVER",129,0)
 I Y D
"RTN","MPIFVER",130,0)
 .K DIR,X,Y S DIR(0)="NA^"_BC_":"_COUNT,DIR("A")="Enter the Number to select the patient: ",DIR("?")="Enter the number from range of "_BC_" to "_COUNT D ^DIR
"RTN","MPIFVER",131,0)
 I $D(DTOUT)!($D(DUOUT)) Q
"RTN","MPIFVER",132,0)
 I Y S XCNTR=$$CNTR(Y) D
"RTN","MPIFVER",133,0)
 .;W !,"Patient: "_XCNTR_" selected"
"RTN","MPIFVER",134,0)
 Q
"RTN","MPIFVER",135,0)
EXDISP(XCNT) ;Extended display for selected patient
"RTN","MPIFVER",136,0)
 ;Get all traits from original results
"RTN","MPIFVER",137,0)
 N FNAME,LNAME,MNAME,CITY,COUNTRY,DOB,GENDER,ICN,L1,L2,L3,MMN,PCODE,DOD
"RTN","MPIFVER",138,0)
 N POBCTY,POBCNTRY,POBST,PREF,SUFFIX,PROVINCE,RESCITY,RESCNTRY
"RTN","MPIFVER",139,0)
 N RESADD1,RESADD2,RESADD3,RESPCODE,RESPROV,RESST,RESZIP,RESPHN
"RTN","MPIFVER",140,0)
 N SSN,ALFNM,ALLNM,ALSSN,ALSFX,ALCNT,ALMNM
"RTN","MPIFVER",141,0)
 S FNAME=$G(RESULTS(XCNT,"FirstName")),LNAME=$G(RESULTS(XCNT,"Surname"))
"RTN","MPIFVER",142,0)
 S MNAME=$G(RESULTS(XCNT,"MiddleName")),DOB=$G(RESULTS(XCNT,"DOB"))
"RTN","MPIFVER",143,0)
 ; Story 722746 (elz) need dod if there is one
"RTN","MPIFVER",144,0)
 I $G(RESULTS(XCNT,"DOD")) S DOD=RESULTS(XCNT,"DOD")
"RTN","MPIFVER",145,0)
 S GENDER=$G(RESULTS(XCNT,"Gender")),ICN=$G(RESULTS(XCNT,"ICN"))
"RTN","MPIFVER",146,0)
 S MMN=$G(RESULTS(XCNT,"MMN")),POBCTY=$G(RESULTS(XCNT,"POBCity"))
"RTN","MPIFVER",147,0)
 S POBCNTRY=$G(RESULTS(XCNT,"POBCountry")),POBST=$G(RESULTS(XCNT,"POBState"))
"RTN","MPIFVER",148,0)
 S PREF=$G(RESULTS(XCNT,"Prefix")),SUFFIX=$G(RESULTS(XCNT,"Suffix"))
"RTN","MPIFVER",149,0)
 S RESCITY=$G(RESULTS(XCNT,"ResAddCity")),RESCNTRY=$G(RESULTS(XCNT,"ResAddCountry"))
"RTN","MPIFVER",150,0)
 S RESADD1=$G(RESULTS(XCNT,"ResAddL1")),RESADD2=$G(RESULTS(XCNT,"ResAddL2"))
"RTN","MPIFVER",151,0)
 S RESADD3=$G(RESULTS(XCNT,"ResAddL3")),RESPCODE=$G(RESULTS(XCNT,"ResAddPCode"))
"RTN","MPIFVER",152,0)
 S RESPROV=$G(RESULTS(XCNT,"ResAddProvince")),SSN=$G(RESULTS(XCNT,"SSN"))
"RTN","MPIFVER",153,0)
 S RESST=$G(RESULTS(XCNT,"ResAddState")),RESZIP=$G(RESULTS(XCNT,"ResAddZip4"))
"RTN","MPIFVER",154,0)
 S RESPHN=$G(RESULTS(XCNT,"ResPhone"))
"RTN","MPIFVER",155,0)
 W !
"RTN","MPIFVER",156,0)
 W !,?5,"ICN",?17,": "_ICN
"RTN","MPIFVER",157,0)
 W !,?5,"Name",?17,": "_LNAME_","_FNAME_" "_MNAME
"RTN","MPIFVER",158,0)
 W !,?5,"SSN",?17,": "_SSN
"RTN","MPIFVER",159,0)
 W !,?5,"DOB",?17,": "_$$FMTE^XLFDT(DOB)
"RTN","MPIFVER",160,0)
 ; Story 722746 (elz) if patient is deceased display dod
"RTN","MPIFVER",161,0)
 I $D(DOD) W !,?5,"*DOD",?17,": "_$$FMTE^XLFDT(DOD)
"RTN","MPIFVER",162,0)
 ; Story 603957 (elz) changed Gender to Birth Sex
"RTN","MPIFVER",163,0)
 W !,?5,"Birth Sex",?17,": "_GENDER
"RTN","MPIFVER",164,0)
 W !,?5,"MMN",?17,": "_MMN
"RTN","MPIFVER",165,0)
 I POBCTY'="" W !,?5,"POB City",?17,": "_POBCTY
"RTN","MPIFVER",166,0)
 I POBST'="" W !,?5,"POB State",?17,": "_POBST
"RTN","MPIFVER",167,0)
 I POBCNTRY'="" W !,?5,"POB Country",?17,": "_POBCNTRY
"RTN","MPIFVER",168,0)
 I RESADD1'=""!(RESADD2'="")!(RESADD3'="")!(RESCNTRY'="")!(RESCITY'="")!(RESST'="")!(RESPCODE'="")!(RESPROV'="")!(RESZIP'="") D
"RTN","MPIFVER",169,0)
 . W !!,"Address:"
"RTN","MPIFVER",170,0)
 . I RESADD1'="" W !,?5,RESADD1
"RTN","MPIFVER",171,0)
 . I RESADD2'="" W !,?5,RESADD2
"RTN","MPIFVER",172,0)
 . I RESADD3'="" W !,?5,RESADD3
"RTN","MPIFVER",173,0)
 . I RESCNTRY'="",(RESCNTRY="USA") D
"RTN","MPIFVER",174,0)
 .. W !,?5,RESCITY_","_RESST_" "_RESZIP
"RTN","MPIFVER",175,0)
 . I RESCNTRY'="",(RESCNTRY'="USA") D
"RTN","MPIFVER",176,0)
 .. W !,?5,RESCITY_","_RESPROV_" "_RESPCODE
"RTN","MPIFVER",177,0)
 I RESCNTRY'="" W !,?5,RESCNTRY
"RTN","MPIFVER",178,0)
 I RESPHN'="" W !,?5,"Phone: "_RESPHN
"RTN","MPIFVER",179,0)
 I $D(RESULTS(XCNT,"ALIAS")) D
"RTN","MPIFVER",180,0)
 . W !!,"ALIAS Information"
"RTN","MPIFVER",181,0)
 . W !,?5,"NAME",?45,"SSN"
"RTN","MPIFVER",182,0)
 . S ALCNT=0 F  S ALCNT=$O(RESULTS(XCNT,"ALIAS",ALCNT)) Q:+ALCNT=0  D
"RTN","MPIFVER",183,0)
 .. S ALFNM=$G(RESULTS(XCNT,"ALIAS",ALCNT,"FirstName"))
"RTN","MPIFVER",184,0)
 .. S ALLNM=$G(RESULTS(XCNT,"ALIAS",ALCNT,"Surname"))
"RTN","MPIFVER",185,0)
 .. S ALSSN=$G(RESULTS(XCNT,"ALIAS",ALCNT,"SSN"))
"RTN","MPIFVER",186,0)
 .. S ALSFX=$G(RESULTS(XCNT,"ALIAS",ALCNT,"Suffix"))
"RTN","MPIFVER",187,0)
 .. S ALMNM=$G(RESULTS(XCNT,"ALIAS",ALCNT,"MiddleName"))
"RTN","MPIFVER",188,0)
 .. W !,?5,ALLNM_","_ALFNM_" "_ALMNM_" "_ALSFX,?45,ALSSN
"RTN","MPIFVER",189,0)
 Q
"RTN","MPIFXMLP")
0^3^B94624059^B91197563
"RTN","MPIFXMLP",1,0)
MPIFXMLP ;OAK/ELZ - MPIF PROBLISTIC SEARCH ; 5/21/15 4:22pm
"RTN","MPIFXMLP",2,0)
 ;;1.0;MASTER PATIENT INDEX VISTA;**61,67**;30 Apr 99;Build 2
"RTN","MPIFXMLP",3,0)
 ;
"RTN","MPIFXMLP",4,0)
 ;
"RTN","MPIFXMLP",5,0)
PATIENT(RETURN,MPIARR) ; - query for patients based on traits
"RTN","MPIFXMLP",6,0)
 ;  MPIARR("")=""
"RTN","MPIFXMLP",7,0)
 ;
"RTN","MPIFXMLP",8,0)
 ;
"RTN","MPIFXMLP",9,0)
 N MPIXML,MPIXMLR,MPID,MPIPAT
"RTN","MPIFXMLP",10,0)
 K RETURN
"RTN","MPIFXMLP",11,0)
 S MPIXML=$$XMLBLD(.MPIARR)
"RTN","MPIFXMLP",12,0)
 D POST^MPIFHWSC(MPIXML,.MPIXMLR)
"RTN","MPIFXMLP",13,0)
 I '$D(MPIXMLR) S RETURN="-1^Query to Person Search returned nothing." Q
"RTN","MPIFXMLP",14,0)
 D PARSE(.RETURN,.MPIXMLR)
"RTN","MPIFXMLP",15,0)
 ;
"RTN","MPIFXMLP",16,0)
 ; convert dob to fm format
"RTN","MPIFXMLP",17,0)
 ; Story 722746 need DOD formatted as well if there is one
"RTN","MPIFXMLP",18,0)
 S MPIPAT=0 F  S MPIPAT=$O(RETURN(MPIPAT)) Q:'MPIPAT  S:$D(RETURN(MPIPAT,"DOD")) RETURN(MPIPAT,"DOD")=$$HL7TFM^XLFDT(RETURN(MPIPAT,"DOD")) I $D(RETURN(MPIPAT,"DOB")) S RETURN(MPIPAT,"DOB")=$$HL7TFM^XLFDT(RETURN(MPIPAT,"DOB"))
"RTN","MPIFXMLP",19,0)
 ;
"RTN","MPIFXMLP",20,0)
 ;
"RTN","MPIFXMLP",21,0)
 Q
"RTN","MPIFXMLP",22,0)
 ;
"RTN","MPIFXMLP",23,0)
XMLBLD(MPIARR) ; setup xml to search
"RTN","MPIFXMLP",24,0)
 ; MPIARR - Array of traits for seach
"RTN","MPIFXMLP",25,0)
 ;    Returns XML for the search
"RTN","MPIFXMLP",26,0)
 ;
"RTN","MPIFXMLP",27,0)
 ; $$SITE^VASITE - #10112
"RTN","MPIFXMLP",28,0)
 ;
"RTN","MPIFXMLP",29,0)
 N MPIXML,MPISITE,QUOTE,MPITHRES,MPIDT,MPIDUZ,MPIPRID
"RTN","MPIFXMLP",30,0)
 S QUOTE=""""
"RTN","MPIFXMLP",31,0)
 S MPISITE=$P($$SITE^VASITE,"^",3)
"RTN","MPIFXMLP",32,0)
 S MPIPRID=$P($$PARAM^HLCS2,"^",3)
"RTN","MPIFXMLP",33,0)
 S MPIDT=$$FMTHL7^XLFDT($$NOW^XLFDT)
"RTN","MPIFXMLP",34,0)
 S MPIDUZ=$P(^VA(200,DUZ,0),"^") D STDNAME^XLFNAME(.MPIDUZ,"C")
"RTN","MPIFXMLP",35,0)
 S MPITHRES=80
"RTN","MPIFXMLP",36,0)
 ;
"RTN","MPIFXMLP",37,0)
 ; heading
"RTN","MPIFXMLP",38,0)
 S MPIXML="<IDM_REQUEST type="_QUOTE_"SEARCH_PROFILE"_QUOTE_"><METADATA>"
"RTN","MPIFXMLP",39,0)
 S MPIXML=MPIXML_"<FIELD name="_QUOTE_"SENDINGFACILITY"_QUOTE_" value="
"RTN","MPIFXMLP",40,0)
 S MPIXML=MPIXML_QUOTE_MPISITE_QUOTE_"/><FIELD name="_QUOTE_"matchType"
"RTN","MPIFXMLP",41,0)
 S MPIXML=MPIXML_QUOTE_" value="_QUOTE_"VISTA_REG"_QUOTE_"/><FIELD name="
"RTN","MPIFXMLP",42,0)
 S MPIXML=MPIXML_QUOTE_"returnMax"_QUOTE_" value="_QUOTE_"100"_QUOTE_"/>"
"RTN","MPIFXMLP",43,0)
 S MPIXML=MPIXML_"<FIELD name="_QUOTE_"algorithm"_QUOTE_" value="_QUOTE
"RTN","MPIFXMLP",44,0)
 S MPIXML=MPIXML_"PROB"_QUOTE_"/><FIELD name="_QUOTE_"minScore"_QUOTE
"RTN","MPIFXMLP",45,0)
 S MPIXML=MPIXML_" value="_QUOTE_MPITHRES_QUOTE_"/><FIELD name="_QUOTE
"RTN","MPIFXMLP",46,0)
 S MPIXML=MPIXML_"scopingOrganization"_QUOTE_" value="_QUOTE_"VA_DOD"
"RTN","MPIFXMLP",47,0)
 S MPIXML=MPIXML_QUOTE_"/><FIELD name="_QUOTE_"versionCode"_QUOTE
"RTN","MPIFXMLP",48,0)
 S MPIXML=MPIXML_" value="_QUOTE_"3.0"_QUOTE_"/><FIELD name="_QUOTE
"RTN","MPIFXMLP",49,0)
 S MPIXML=MPIXML_"sendingApplicationName"_QUOTE_" value="_QUOTE
"RTN","MPIFXMLP",50,0)
 S MPIXML=MPIXML_"VISTA_REG"_QUOTE_"/><FIELD name="_QUOTE_"PROCESSINGID"
"RTN","MPIFXMLP",51,0)
 S MPIXML=MPIXML_QUOTE_" value="_QUOTE_MPIPRID_QUOTE_"/></METADATA>"
"RTN","MPIFXMLP",52,0)
 S MPIXML=MPIXML_"<ARGUMENTS><ARGUMENT name="_QUOTE
"RTN","MPIFXMLP",53,0)
 S MPIXML=MPIXML_"searchProfile"_QUOTE_"><IDMHEADER>"
"RTN","MPIFXMLP",54,0)
 S MPIXML=MPIXML_"<SENDING_APP>VISTA_REG</SENDING_APP><MSG_DATE_TIME>"
"RTN","MPIFXMLP",55,0)
 S MPIXML=MPIXML_MPIDT_"</MSG_DATE_TIME><MSG_CONTROL_ID>"_$J
"RTN","MPIFXMLP",56,0)
 S MPIXML=MPIXML_"</MSG_CONTROL_ID><PROCESSING_ID>"_MPIPRID
"RTN","MPIFXMLP",57,0)
 S MPIXML=MPIXML_"</PROCESSING_ID><TRIGGER><EVENT>Local Client</EVENT>"
"RTN","MPIFXMLP",58,0)
 S MPIXML=MPIXML_"<ACTOR>"_DUZ_"~PN~"_MPISITE_"~USVHA^"
"RTN","MPIFXMLP",59,0)
 S MPIXML=MPIXML_$G(MPIDUZ("FAMILY"))_"^"_$G(MPIDUZ("GIVEN"))_"</ACTOR>"
"RTN","MPIFXMLP",60,0)
 S MPIXML=MPIXML_"<DATETIME>"_MPIDT_"</DATETIME><SOURCE>VISTA</SOURCE>"
"RTN","MPIFXMLP",61,0)
 S MPIXML=MPIXML_"</TRIGGER></IDMHEADER><PROFILE>"
"RTN","MPIFXMLP",62,0)
 ;
"RTN","MPIFXMLP",63,0)
 ; name traits
"RTN","MPIFXMLP",64,0)
 S MPIXML=MPIXML_"<NAME type="_QUOTE_"L"_QUOTE_">"
"RTN","MPIFXMLP",65,0)
 D IFADD("FirstName",.MPIARR,.MPIXML,"FIRSTNAME")
"RTN","MPIFXMLP",66,0)
 D IFADD("MiddleName",.MPIARR,.MPIXML,"MIDDLENAME")
"RTN","MPIFXMLP",67,0)
 D IFADD("Suffix",.MPIARR,.MPIXML,"SUFFIX")
"RTN","MPIFXMLP",68,0)
 D IFADD("Surname",.MPIARR,.MPIXML,"LASTNAME")
"RTN","MPIFXMLP",69,0)
 S MPIXML=MPIXML_"</NAME>"
"RTN","MPIFXMLP",70,0)
 ;
"RTN","MPIFXMLP",71,0)
 ; other traits
"RTN","MPIFXMLP",72,0)
 I $G(MPIARR("SSN"))'="" D
"RTN","MPIFXMLP",73,0)
 . S MPIXML=MPIXML_"<IDENTIFIER type="_QUOTE_"SS"_QUOTE_" subtype="
"RTN","MPIFXMLP",74,0)
 . S MPIXML=MPIXML_QUOTE_"ACTIVE"_QUOTE_"><ID>"_MPIARR("SSN")
"RTN","MPIFXMLP",75,0)
 . S MPIXML=MPIXML_"</ID></IDENTIFIER>"
"RTN","MPIFXMLP",76,0)
 I $G(MPIARR("DOB"))'="" D
"RTN","MPIFXMLP",77,0)
 . S MPIXML=MPIXML_"<ATTRIBUTE type="_QUOTE_"DOB"_QUOTE_"><VALUE>"
"RTN","MPIFXMLP",78,0)
 . S MPIXML=MPIXML_$$FMTHL7^XLFDT(MPIARR("DOB"))_"</VALUE></ATTRIBUTE>"
"RTN","MPIFXMLP",79,0)
 I $G(MPIARR("Gender"))'="" D
"RTN","MPIFXMLP",80,0)
 . S MPIXML=MPIXML_"<ATTRIBUTE type="_QUOTE_"GENDER"_QUOTE_">"
"RTN","MPIFXMLP",81,0)
 . S MPIXML=MPIXML_"<VALUE>"_MPIARR("Gender")_"</VALUE></ATTRIBUTE>"
"RTN","MPIFXMLP",82,0)
 I $G(MPIARR("MMN"))'="" D
"RTN","MPIFXMLP",83,0)
 . S MPIXML=MPIXML_"<ATTRIBUTE type="_QUOTE_"MMN"_QUOTE_">"
"RTN","MPIFXMLP",84,0)
 . S MPIXML=MPIXML_"<VALUE>"_MPIARR("MMN")_"</VALUE></ATTRIBUTE>"
"RTN","MPIFXMLP",85,0)
 I $G(MPIARR("MBI"))'="" D
"RTN","MPIFXMLP",86,0)
 . S MPIXML=MPIXML_"<ATTRIBUTE type="_QUOTE_"MULTIBIRTH"_QUOTE_">"
"RTN","MPIFXMLP",87,0)
 . S MPIXML=MPIXML_"<VALUE>"_MPIARR("MBI")_"</VALUE></ATTRIBUTE>"
"RTN","MPIFXMLP",88,0)
 ;
"RTN","MPIFXMLP",89,0)
 ;POB stuff
"RTN","MPIFXMLP",90,0)
 S MPIARR("MPIVar")=$$CONV($G(MPIARR("POBCity")))
"RTN","MPIFXMLP",91,0)
 I MPIARR("MPIVar")'=""!($G(MPIARR("POBState"))'="") D
"RTN","MPIFXMLP",92,0)
 . S MPIXML=MPIXML_"<ADDRESS type="_QUOTE_"N"_QUOTE_">"
"RTN","MPIFXMLP",93,0)
 . D IFADD("MPIVar",.MPIARR,.MPIXML,"CITY")
"RTN","MPIFXMLP",94,0)
 . D IFADD("POBState",.MPIARR,.MPIXML,"STATE")
"RTN","MPIFXMLP",95,0)
 . S MPIXML=MPIXML_"</ADDRESS>"
"RTN","MPIFXMLP",96,0)
 ;
"RTN","MPIFXMLP",97,0)
 ;address stuff
"RTN","MPIFXMLP",98,0)
 I $G(MPIARR("ResAddL1"))'=""!($G(MPIARR("ResAddL2"))'="")!($G(MPIARR("ResAddCity"))'="")!($G(MPIARR("ResAddZip4"))'="")!($G(MPIARR("ResAddL3"))'="")!($G(MPIARR("ResAddState"))'="") D
"RTN","MPIFXMLP",99,0)
 . S MPIXML=MPIXML_"<ADDRESS type="_QUOTE_"P"_QUOTE_">"
"RTN","MPIFXMLP",100,0)
 . S MPIARR("MPIVar")=$$CONV($G(MPIARR("ResAddL1")))
"RTN","MPIFXMLP",101,0)
 . D IFADD("MPIVar",.MPIARR,.MPIXML,"STREET1")
"RTN","MPIFXMLP",102,0)
 . S MPIARR("MPIVar")=$$CONV($G(MPIARR("ResAddL2")))
"RTN","MPIFXMLP",103,0)
 . D IFADD("MPIVar",.MPIARR,.MPIXML,"STREET2")
"RTN","MPIFXMLP",104,0)
 . S MPIARR("MPIVar")=$$CONV($G(MPIARR("ResAddL3")))
"RTN","MPIFXMLP",105,0)
 . D IFADD("MPIVar",.MPIARR,.MPIXML,"STREET3")
"RTN","MPIFXMLP",106,0)
 . S MPIARR("MPIVar")=$$CONV($G(MPIARR("ResAddCity")))
"RTN","MPIFXMLP",107,0)
 . D IFADD("MPIVar",.MPIARR,.MPIXML,"CITY")
"RTN","MPIFXMLP",108,0)
 . D IFADD("ResAddState",.MPIARR,.MPIXML,"STATE")
"RTN","MPIFXMLP",109,0)
 . D IFADD("ResAddZip4",.MPIARR,.MPIXML,"ZIPCODE")
"RTN","MPIFXMLP",110,0)
 . D IFADD("ResAddProvince",.MPIARR,.MPIXML,"PROVINCECODE")
"RTN","MPIFXMLP",111,0)
 . D IFADD("ResAddPCode",.MPIARR,.MPIXML,"POSTALCODE")
"RTN","MPIFXMLP",112,0)
 . D IFADD("ResAddCountry",.MPIARR,.MPIXML,"COUNTRY")
"RTN","MPIFXMLP",113,0)
 . S MPIXML=MPIXML_"</ADDRESS>"
"RTN","MPIFXMLP",114,0)
 ;
"RTN","MPIFXMLP",115,0)
 ; phone
"RTN","MPIFXMLP",116,0)
 I $G(MPIARR("ResPhone"))'=""&($G(MPIARR("ResPhone"))'["""") D
"RTN","MPIFXMLP",117,0)
 . S MPIARR("MPIVar")=$$CONV($G(MPIARR("ResPhone")))
"RTN","MPIFXMLP",118,0)
 . I MPIARR("MPIVar")'="" D
"RTN","MPIFXMLP",119,0)
 .. S MPIXML=MPIXML_"<PHONE type="_QUOTE_"HOME"_QUOTE_"><NUMBER>"
"RTN","MPIFXMLP",120,0)
 .. S MPIXML=MPIXML_MPIARR("MPIVar")_"</NUMBER></PHONE>"
"RTN","MPIFXMLP",121,0)
 ;
"RTN","MPIFXMLP",122,0)
 ; dod
"RTN","MPIFXMLP",123,0)
 I $G(MPIARR("DOD"))'="" D
"RTN","MPIFXMLP",124,0)
 . S MPIXML=MPIXML_"<ATTRIBUTE type="_QUOTE_"DOD"_QUOTE_"><VALUE>"
"RTN","MPIFXMLP",125,0)
 . S MPIXML=MPIXML_$$FMTHL7^XLFDT(MPIARR("DOD"))_"</VALUE></ATTRIBUTE>"
"RTN","MPIFXMLP",126,0)
 ;
"RTN","MPIFXMLP",127,0)
 ; end data
"RTN","MPIFXMLP",128,0)
 S MPIXML=MPIXML_"</PROFILE></ARGUMENT></ARGUMENTS></IDM_REQUEST>"
"RTN","MPIFXMLP",129,0)
 K MPIARR("MPIVar")
"RTN","MPIFXMLP",130,0)
 Q MPIXML
"RTN","MPIFXMLP",131,0)
 ;
"RTN","MPIFXMLP",132,0)
IFADD(MPIVAR,MPIARR,MPIXML,MPIXMLN) ;check if there, if so add it to the XML
"RTN","MPIFXMLP",133,0)
 ; MPIVAR is the MPIARR variable name
"RTN","MPIFXMLP",134,0)
 ; MPIXMLN is the name of the XML to encase
"RTN","MPIFXMLP",135,0)
 ; modifies MPIXML to add if it is there
"RTN","MPIFXMLP",136,0)
 I $G(MPIARR(MPIVAR))'="" D
"RTN","MPIFXMLP",137,0)
 . S MPIXML=MPIXML_"<"_MPIXMLN_">"_MPIARR(MPIVAR)_"</"_MPIXMLN_">"
"RTN","MPIFXMLP",138,0)
 Q
"RTN","MPIFXMLP",139,0)
 ;
"RTN","MPIFXMLP",140,0)
CONV(FIELD) ;check for &, ', > and <
"RTN","MPIFXMLP",141,0)
 I FIELD["&" S FIELD=$P(FIELD,"&")_"&amp;"_$P(FIELD,"&",2)
"RTN","MPIFXMLP",142,0)
 I FIELD["'" S FIELD=$P(FIELD,"'")_"&apos;"_$P(FIELD,"'",2)
"RTN","MPIFXMLP",143,0)
 S:(FIELD["<") FIELD=$$CONVA(FIELD,"<")
"RTN","MPIFXMLP",144,0)
 S:(FIELD[">") FIELD=$$CONVA(FIELD,">")
"RTN","MPIFXMLP",145,0)
 Q FIELD
"RTN","MPIFXMLP",146,0)
 ;
"RTN","MPIFXMLP",147,0)
CONVA(FIELD,ENCHAR) ;handle <<pob city>>
"RTN","MPIFXMLP",148,0)
 N I,X,VAL
"RTN","MPIFXMLP",149,0)
 S VAL="",I=$L(FIELD,ENCHAR) F X=1:1:I S VAL=VAL_$P(FIELD,ENCHAR,X)
"RTN","MPIFXMLP",150,0)
 Q VAL
"RTN","MPIFXMLP",151,0)
 ;
"RTN","MPIFXMLP",152,0)
PARSE(MPIDATA,MPIXML) ; - parse the data
"RTN","MPIFXMLP",153,0)
 ;
"RTN","MPIFXMLP",154,0)
 ; EN^MXMLPRSE - #4149
"RTN","MPIFXMLP",155,0)
 ;
"RTN","MPIFXMLP",156,0)
 K ^TMP($J,"MPIFXMLP")
"RTN","MPIFXMLP",157,0)
 N MPICB,MPIUSE,MPIVAR,MPIPAT,MPIALIAS,MPILOC,MPIIDS
"RTN","MPIFXMLP",158,0)
 S (MPIPAT,MPIIDS)=0
"RTN","MPIFXMLP",159,0)
 S MPICB("STARTELEMENT")="SE^MPIFXMLP"
"RTN","MPIFXMLP",160,0)
 S MPICB("CHARACTERS")="VALUE^MPIFXMLP"
"RTN","MPIFXMLP",161,0)
 S ^TMP($J,"MPIFXMLP",1)=MPIXML
"RTN","MPIFXMLP",162,0)
 D EN^MXMLPRSE($NA(^TMP($J,"MPIFXMLP")),.MPICB)
"RTN","MPIFXMLP",163,0)
 K ^TMP($J,"MPIFXMLP")
"RTN","MPIFXMLP",164,0)
 Q
"RTN","MPIFXMLP",165,0)
 ;
"RTN","MPIFXMLP",166,0)
SE(MPIN,MPIA) ; - used for the parser to call back with STARTELEMENT
"RTN","MPIFXMLP",167,0)
 ;
"RTN","MPIFXMLP",168,0)
 ; just to protect the process
"RTN","MPIFXMLP",169,0)
 S MPIN=$G(MPIN)
"RTN","MPIFXMLP",170,0)
 S MPIA("type")=$G(MPIA("type"))
"RTN","MPIFXMLP",171,0)
 S MPIA("subtype")=$G(MPIA("subtype"))
"RTN","MPIFXMLP",172,0)
 S MPIA("name")=$G(MPIA("name"))
"RTN","MPIFXMLP",173,0)
 S MPIA("value")=$G(MPIA("value"))
"RTN","MPIFXMLP",174,0)
 ; my variable to protect
"RTN","MPIFXMLP",175,0)
 S MPIUSE=$G(MPIUSE)
"RTN","MPIFXMLP",176,0)
 ;
"RTN","MPIFXMLP",177,0)
 ; got a business rule error
"RTN","MPIFXMLP",178,0)
 I MPIN="RESULT",MPIA("type")="AA",MPIA("subtype")="QE" S MPIDATA("Result")="QE" Q
"RTN","MPIFXMLP",179,0)
 ; don't use these
"RTN","MPIFXMLP",180,0)
 I MPIN="IDM_RESPONSE"!(MPIN="METADATA")!(MPIN="IDATTR") Q
"RTN","MPIFXMLP",181,0)
 I MPIN="RESULT"!(MPIN="ISSUER")!(MPIN="STATUS") Q
"RTN","MPIFXMLP",182,0)
 I MPIN="EFFECTIVE"!(MPIN="BADADDRESSCODE")!(MPIN="BADADDRESSTEXT") Q
"RTN","MPIFXMLP",183,0)
 I MPIN="IDATTR",MPIA("type")="PSEUDO_SSN",MPIA("subtype")="CODE" Q
"RTN","MPIFXMLP",184,0)
 I MPIN="ASSOC",MPIA("type")="ALIAS_SSN" Q
"RTN","MPIFXMLP",185,0)
 ;
"RTN","MPIFXMLP",186,0)
 ; save some field data
"RTN","MPIFXMLP",187,0)
 I MPIN="FIELD" S:MPIA("name")]"" MPIDATA(MPIA("name"))=MPIA("value") Q
"RTN","MPIFXMLP",188,0)
 ;
"RTN","MPIFXMLP",189,0)
 I MPIN="PROFILE" S MPIPAT=MPIPAT+1,MPIALIAS=0,MPILOC="MPIDATA("_MPIPAT Q
"RTN","MPIFXMLP",190,0)
 I MPIN="NAME" D  Q
"RTN","MPIFXMLP",191,0)
 . S MPIUSE=MPIA("type")
"RTN","MPIFXMLP",192,0)
 . S:MPIUSE="A" MPIALIAS=MPIALIAS+1
"RTN","MPIFXMLP",193,0)
 I MPIN="FIRSTNAME",MPIUSE="L" S MPIVAR=",""FirstName"")" Q
"RTN","MPIFXMLP",194,0)
 I MPIN="LASTNAME",MPIUSE="L" S MPIVAR=",""Surname"")" Q
"RTN","MPIFXMLP",195,0)
 I MPIN="MIDDLENAME",MPIUSE="L" S MPIVAR=",""MiddleName"")" Q
"RTN","MPIFXMLP",196,0)
 I MPIN="SUFFIX",MPIUSE="L" S MPIVAR=",""Suffix"")" Q
"RTN","MPIFXMLP",197,0)
 I MPIN="PREFIX",MPIUSE="L" S MPIVAR=",""Prefix"")" Q
"RTN","MPIFXMLP",198,0)
 I MPIN="FIRSTNAME",MPIUSE="A" S MPIVAR=",""ALIAS"","_MPIALIAS_",""FirstName"")" Q
"RTN","MPIFXMLP",199,0)
 I MPIN="LASTNAME",MPIUSE="A" S MPIVAR=",""ALIAS"","_MPIALIAS_",""Surname"")" Q
"RTN","MPIFXMLP",200,0)
 I MPIN="MIDDLENAME",MPIUSE="A" S MPIVAR=",""ALIAS"","_MPIALIAS_",""MiddleName"")" Q
"RTN","MPIFXMLP",201,0)
 I MPIN="SUFFIX",MPIUSE="A" S MPIVAR=",""ALIAS"","_MPIALIAS_",""Suffix"")" Q
"RTN","MPIFXMLP",202,0)
 I MPIN="PREFIX",MPIUSE="A" S MPIVAR=",""ALIAS"","_MPIALIAS_",""Prefix"")" Q
"RTN","MPIFXMLP",203,0)
 I MPIN="IDENTIFIER" D  Q
"RTN","MPIFXMLP",204,0)
 . I MPIA("type")="SS",MPIA("subtype")="ALIAS" S MPIUSE="ALIASSSN" Q
"RTN","MPIFXMLP",205,0)
 . I MPIA("type")="SS" S MPIUSE="SSN" Q
"RTN","MPIFXMLP",206,0)
 . I MPIA("type")="NI",MPIA("subtype")="IDM" S MPIUSE="ICN" Q
"RTN","MPIFXMLP",207,0)
 . I MPIA("type")="NI",MPIA("subtype")="" S MPIIDS=MPIIDS+1,MPIUSE="IDS" Q
"RTN","MPIFXMLP",208,0)
 I MPIN="ID" D  Q
"RTN","MPIFXMLP",209,0)
 . I MPIUSE="ALIASSSN" S MPIVAR=",""ALIAS"","_MPIALIAS_",""SSN"")" Q
"RTN","MPIFXMLP",210,0)
 . I MPIUSE="SSN" S MPIVAR=",""SSN"")" K MPIUSE Q
"RTN","MPIFXMLP",211,0)
 . I MPIUSE="ICN" S MPIVAR=",""ICN"")" K MPIUSE Q
"RTN","MPIFXMLP",212,0)
 . I MPIUSE="EDIPI" S MPIVAR=",""EDIPI"")" K MPIUSE Q
"RTN","MPIFXMLP",213,0)
 . I MPIUSE="IDS" S MPIVAR=",""IDS"","_MPIIDS_",""ID"")" Q
"RTN","MPIFXMLP",214,0)
 I MPIN="SOURCE" S MPIVAR=",""IDS"","_MPIIDS_",""SOURCE"")" Q
"RTN","MPIFXMLP",215,0)
 I MPIN="ATTRIBUTE" D  Q
"RTN","MPIFXMLP",216,0)
 . I MPIA("type")="SCORE" S MPIUSE="Score" Q
"RTN","MPIFXMLP",217,0)
 . I MPIA("type")="MMN" S MPIUSE="MMN" Q
"RTN","MPIFXMLP",218,0)
 . I MPIA("type")="DOB" S MPIUSE="DOB" Q
"RTN","MPIFXMLP",219,0)
 . I MPIA("type")="GENDER" S MPIUSE="Gender" Q
"RTN","MPIFXMLP",220,0)
 . ; Story 722746 (elz) need DOD if there is one
"RTN","MPIFXMLP",221,0)
 . I MPIA("type")="DEATHDATE" S MPIUSE="DOD" Q
"RTN","MPIFXMLP",222,0)
 I MPIN="VALUE" D  K MPIUSE Q
"RTN","MPIFXMLP",223,0)
 . I $L(MPIUSE) S MPIVAR=","""_MPIUSE_""")"
"RTN","MPIFXMLP",224,0)
 I MPIN="ADDRESS" D  Q
"RTN","MPIFXMLP",225,0)
 . I MPIA("type")="N" S MPIUSE="POB"
"RTN","MPIFXMLP",226,0)
 . I MPIA("type")="P" S MPIUSE="ResAdd"
"RTN","MPIFXMLP",227,0)
 . I MPIA("type")="BA" S MPIUSE="BA"
"RTN","MPIFXMLP",228,0)
 I MPIN="CITY" S MPIVAR=","""_MPIUSE_"City"")" Q
"RTN","MPIFXMLP",229,0)
 I MPIN="STATE" S MPIVAR=","""_MPIUSE_"State"")" Q
"RTN","MPIFXMLP",230,0)
 I MPIN="PROVINCECODE" S MPIVAR=","""_MPIUSE_"Province"")" Q
"RTN","MPIFXMLP",231,0)
 I MPIN="COUNTRY" S MPIVAR=","""_MPIUSE_"Country"")" Q
"RTN","MPIFXMLP",232,0)
 I MPIN="PHONE",MPIA("type")="Home" S MPIUSE="ResPhone" Q
"RTN","MPIFXMLP",233,0)
 I MPIN="NUMBER" S MPIVAR=","""_MPIUSE_""")" Q
"RTN","MPIFXMLP",234,0)
 I MPIN="STREET1" S MPIVAR=","""_MPIUSE_"L1"")" Q
"RTN","MPIFXMLP",235,0)
 I MPIN="STREET2" S MPIVAR=","""_MPIUSE_"L2"")" Q
"RTN","MPIFXMLP",236,0)
 I MPIN="STREET3" S MPIVAR=","""_MPIUSE_"L3"")" Q
"RTN","MPIFXMLP",237,0)
 I MPIN="ZIPCODE" S MPIVAR=","""_MPIUSE_"Zip4"")" Q
"RTN","MPIFXMLP",238,0)
 I MPIN="POSTALCODE" S MPIVAR=","""_MPIUSE_"PCode"")" Q
"RTN","MPIFXMLP",239,0)
 ;
"RTN","MPIFXMLP",240,0)
 Q
"RTN","MPIFXMLP",241,0)
 ;
"RTN","MPIFXMLP",242,0)
VALUE(MPIT) ; - used by the parser to call back with CHARACTERS
"RTN","MPIFXMLP",243,0)
 S:$D(MPIVAR) @(MPILOC_MPIVAR)=MPIT K MPIVAR Q
"RTN","MPIFXMLP",244,0)
 Q
"VER")
8.0^22.2
"BLD",3326,6)
^64
**END**
**END**

