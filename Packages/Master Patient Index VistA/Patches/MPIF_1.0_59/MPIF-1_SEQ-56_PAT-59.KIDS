Released MPIF*1*59 SEQ #56
Extracted from mail message
**KIDS**:MPIF*1.0*59^

**INSTALL NAME**
MPIF*1.0*59
"BLD",3008,0)
MPIF*1.0*59^MASTER PATIENT INDEX VISTA^0^3140623^y
"BLD",3008,1,0)
^^3^3^3140605^
"BLD",3008,1,1,0)
MASTER VETERAN INDEX VISTA ISSUES - ITERATION 12
"BLD",3008,1,2,0)
Refer to patch MPIF*1.0*59 in the FORUM Patch Module for a complete
"BLD",3008,1,3,0)
description.
"BLD",3008,4,0)
^9.64PA^^
"BLD",3008,6.3)
1
"BLD",3008,"KRN",0)
^9.67PA^779.2^20
"BLD",3008,"KRN",.4,0)
.4
"BLD",3008,"KRN",.401,0)
.401
"BLD",3008,"KRN",.402,0)
.402
"BLD",3008,"KRN",.403,0)
.403
"BLD",3008,"KRN",.5,0)
.5
"BLD",3008,"KRN",.84,0)
.84
"BLD",3008,"KRN",3.6,0)
3.6
"BLD",3008,"KRN",3.8,0)
3.8
"BLD",3008,"KRN",9.2,0)
9.2
"BLD",3008,"KRN",9.8,0)
9.8
"BLD",3008,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",3008,"KRN",9.8,"NM",1,0)
MPIFA31B^^0^B22496134
"BLD",3008,"KRN",9.8,"NM",2,0)
MPIFA24^^0^B23156573
"BLD",3008,"KRN",9.8,"NM",3,0)
MPIFSA2^^0^B86870493
"BLD",3008,"KRN",9.8,"NM","B","MPIFA24",2)

"BLD",3008,"KRN",9.8,"NM","B","MPIFA31B",1)

"BLD",3008,"KRN",9.8,"NM","B","MPIFSA2",3)

"BLD",3008,"KRN",19,0)
19
"BLD",3008,"KRN",19.1,0)
19.1
"BLD",3008,"KRN",101,0)
101
"BLD",3008,"KRN",409.61,0)
409.61
"BLD",3008,"KRN",771,0)
771
"BLD",3008,"KRN",779.2,0)
779.2
"BLD",3008,"KRN",870,0)
870
"BLD",3008,"KRN",8989.51,0)
8989.51
"BLD",3008,"KRN",8989.52,0)
8989.52
"BLD",3008,"KRN",8994,0)
8994
"BLD",3008,"KRN","B",.4,.4)

"BLD",3008,"KRN","B",.401,.401)

"BLD",3008,"KRN","B",.402,.402)

"BLD",3008,"KRN","B",.403,.403)

"BLD",3008,"KRN","B",.5,.5)

"BLD",3008,"KRN","B",.84,.84)

"BLD",3008,"KRN","B",3.6,3.6)

"BLD",3008,"KRN","B",3.8,3.8)

"BLD",3008,"KRN","B",9.2,9.2)

"BLD",3008,"KRN","B",9.8,9.8)

"BLD",3008,"KRN","B",19,19)

"BLD",3008,"KRN","B",19.1,19.1)

"BLD",3008,"KRN","B",101,101)

"BLD",3008,"KRN","B",409.61,409.61)

"BLD",3008,"KRN","B",771,771)

"BLD",3008,"KRN","B",779.2,779.2)

"BLD",3008,"KRN","B",870,870)

"BLD",3008,"KRN","B",8989.51,8989.51)

"BLD",3008,"KRN","B",8989.52,8989.52)

"BLD",3008,"KRN","B",8994,8994)

"BLD",3008,"QDEF")
^^^^NO^^^^NO^^YES
"BLD",3008,"QUES",0)
^9.62^^
"BLD",3008,"REQB",0)
^9.611^3^3
"BLD",3008,"REQB",1,0)
MPIF*1.0*52^2
"BLD",3008,"REQB",2,0)
MPIF*1.0*54^2
"BLD",3008,"REQB",3,0)
MPIF*1.0*57^2
"BLD",3008,"REQB","B","MPIF*1.0*52",1)

"BLD",3008,"REQB","B","MPIF*1.0*54",2)

"BLD",3008,"REQB","B","MPIF*1.0*57",3)

"MBREQ")
0
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
59^3140623
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3140623
"PKG",282,22,1,"PAH",1,1,1,0)
MASTER VETERAN INDEX VISTA ISSUES - ITERATION 12
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1.0*59 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","MPIFA24")
0^2^B23156573^B22867722
"RTN","MPIFA24",1,0)
MPIFA24 ;BPOFO/CMC-A24 PROCESSING ROUTINE ;18 Mar 02
"RTN","MPIFA24",2,0)
 ;;1.0;MASTER PATIENT INDEX VISTA;**22,24,27,31,25,41,39,48,52,59**;30 Apr 99;Build 1
"RTN","MPIFA24",3,0)
 ;
"RTN","MPIFA24",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA24",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA24",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA24",7,0)
 ;  ^DPT("AICN" - #2070
"RTN","MPIFA24",8,0)
 ;  DELETETF^VAFCTFU, FILE^VAFCTFU - #2988
"RTN","MPIFA24",9,0)
 ;
"RTN","MPIFA24",10,0)
 ;PROCESS A24 RESULTING FROM A28 ADD TO MPI MESSAGE OR FROM A40 MERGE
"RTN","MPIFA24",11,0)
A24 ;
"RTN","MPIFA24",12,0)
 N MPII,MPIJ,ARRY,SEG,CNT,ERR,SITE,MSG,DFN,IEN,LIST,RARRY
"RTN","MPIFA24",13,0)
 S (CNT,ERR,FIRST)=1
"RTN","MPIFA24",14,0)
 F MPII=1:1 X HLNEXT Q:HLQUIT'>0  S MSG=HLNODE D
"RTN","MPIFA24",15,0)
 .S MPIJ=0 F  S MPIJ=$O(HLNODE(MPIJ)) Q:'MPIJ  S MSG(MPIJ)=HLNODE(MPIJ)
"RTN","MPIFA24",16,0)
 .S SEG=$E(HLNODE,1,3)
"RTN","MPIFA24",17,0)
 .I SEG="MSH" D MSH(.ARRY,.MSG) Q
"RTN","MPIFA24",18,0)
 .I SEG="EVN" D EVN(.ARRY,.MSG) Q
"RTN","MPIFA24",19,0)
 .I SEG="PID" D PID(.ARRY,.MSG,FIRST) D:FIRST=1  S FIRST=2 Q
"RTN","MPIFA24",20,0)
 ..;preserve the retained ICN values 991.01 and 991.02
"RTN","MPIFA24",21,0)
 .. S RARRY(991.01)=ARRY(991.01),RARRY(991.02)=ARRY(991.02)
"RTN","MPIFA24",22,0)
 .I SEG="PD1" D PD1(.ARRY,.MSG) Q
"RTN","MPIFA24",23,0)
 ;
"RTN","MPIFA24",24,0)
 ;restore the retained ICN values
"RTN","MPIFA24",25,0)
 S ARRY(991.01)=RARRY(991.01),ARRY(991.02)=RARRY(991.02)
"RTN","MPIFA24",26,0)
 ;UPDATE 991.01, 991.02, 991.03
"RTN","MPIFA24",27,0)
 ;**41 first check for DFN, if this DFN location is here
"RTN","MPIFA24",28,0)
 I $G(ARRY("DFN",2))'=""&($G(ARRY("DFNLOC"))=$P($$SITE^VASITE,"^",3)) S DFN=ARRY("DFN",2)
"RTN","MPIFA24",29,0)
 ;**41 if dfn is not passed set DFN from ICN
"RTN","MPIFA24",30,0)
 I $G(DFN)="" D
"RTN","MPIFA24",31,0)
 . I $G(ARRY("ICN",2))'="" S DFN=$$GETDFN^MPIF001(ARRY("ICN",2))
"RTN","MPIFA24",32,0)
 . I $G(ARRY("ICN",2))=""!(+$G(DFN)'>0) D
"RTN","MPIFA24",33,0)
 .. I $G(ARRY("DFN",2))'="" S DFN=ARRY("DFN",2)
"RTN","MPIFA24",34,0)
 .. I $G(ARRY("DFN",2))="" S DFN=ARRY("DFN",1)
"RTN","MPIFA24",35,0)
 S ARRY(991.03)=$S(ARRY(991.03)="":"@",1:$$LKUP^XUAF4(ARRY(991.03))) ;**59 - MVI_2688 (dri)
"RTN","MPIFA24",36,0)
 I +$G(DFN)'>0 S ERR="-1^Unknown Identifier(s) ICN#"_$G(ARRY("ICN",2))_" and DFN#"_$G(ARRY("DFN",2))
"RTN","MPIFA24",37,0)
 I +$G(DFN)>0 S ERR=$$UPDATE^MPIFAPI(DFN,"ARRY",0) D
"RTN","MPIFA24",38,0)
 .;remove ALL Treating Facilities except your sites and add the CMOR
"RTN","MPIFA24",39,0)
 .D TFL^VAFCTFU1(.LIST,DFN) I $O(LIST(0)) D
"RTN","MPIFA24",40,0)
 .. N LOC,MPINODE,LOCIEN,CMOR,MPIFX,ERROR
"RTN","MPIFA24",41,0)
 .. S (CMOR,MPIFX)=0 F  S MPIFX=$O(LIST(MPIFX)) Q:'MPIFX  I $P(LIST(MPIFX),"^",5)="VAMC" D
"RTN","MPIFA24",42,0)
 ... ;get MPI node
"RTN","MPIFA24",43,0)
 ... S MPINODE=$$MPINODE^MPIFAPI(DFN),LOC=$P(LIST(MPIFX),"^"),LOCIEN=$$IEN^XUAF4(LOC)
"RTN","MPIFA24",44,0)
 ... I LOC=$P($$SITE^VASITE,"^",3) Q  ;do not delete own site
"RTN","MPIFA24",45,0)
 ... I LOCIEN=$P(MPINODE,"^",3) S CMOR=LOCIEN Q  ;do not delete CMOR site
"RTN","MPIFA24",46,0)
 ... S ERROR=$$DELETETF^VAFCTFU($P(MPINODE,"^",1),LOCIEN)
"RTN","MPIFA24",47,0)
 .. ;add CMOR site to TF list if it did not already exist
"RTN","MPIFA24",48,0)
 .. I CMOR'=0 D FILE^VAFCTFU(DFN,CMOR,1)
"RTN","MPIFA24",49,0)
 .; trigger A31 to MPI incase there have been edits since the ICN was created -- tasked off
"RTN","MPIFA24",50,0)
 .; **39 DON'T TASK OFF A31 IF MOVING FROM ONE NATIONAL ICN TO A DIFFERENT NATIONAL ICN
"RTN","MPIFA24",51,0)
 .I ARRY("ICN",1)=ARRY("ICN",2) D
"RTN","MPIFA24",52,0)
 ..S ZTRTN="TA31^MPIFA31B",ZTDESC="A31 triggered from A24 for DFN "_DFN ;**39 added DFN to text
"RTN","MPIFA24",53,0)
 ..S ZTSAVE("DFN")=DFN,ZTIO="",ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFA24",54,0)
 ..D ^%ZTLOAD
"RTN","MPIFA24",55,0)
 .I ARRY("ICN",1)'=ARRY("ICN",2) D RESEX^MPIFDUP(DFN,2) ;**48
"RTN","MPIFA24",56,0)
 .K ZTRTN,ZTDESC,ZTIO,ZTSAVE,ZTDTH,ZTREQ
"RTN","MPIFA24",57,0)
 ;
"RTN","MPIFA24",58,0)
 N AA S AA="AA"
"RTN","MPIFA24",59,0)
 I $G(ERR)'>0,$P($G(ERR),"^",2)["is already in use for pt DFN" S AA="AE" ;**52 MPIC_1681/1753
"RTN","MPIFA24",60,0)
 S HLA("HLA",1)="MSA"_HL("FS")_AA_HL("FS")_HL("MID")_HL("FS")_$S(+$G(ERR)'>0:$P(ERR,"^",2),1:"")
"RTN","MPIFA24",61,0)
 S $P(HLA("HLA",1),HL("FS"),7)="ICN="_ARRY("ICN",1)
"RTN","MPIFA24",62,0)
 D LINK^HLUTIL3(ARRY("SITE"),.LINK) S IEN=$O(LINK(0)),HLL("LINKS",1)="^"_LINK(IEN)
"RTN","MPIFA24",63,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.MPIFRSLT,"",.HL)
"RTN","MPIFA24",64,0)
 K LINK,MPIFRSLT
"RTN","MPIFA24",65,0)
 ;PATCH 25
"RTN","MPIFA24",66,0)
 I ARRY("ICN",1)'=ARRY("ICN",2),ARRY("ICN",2)'="" D
"RTN","MPIFA24",67,0)
 .; ^ checking if this is a result of a "merge" of ICNs from the MPI
"RTN","MPIFA24",68,0)
 .; to trigger if this is station 200 the MERGE for the FHIE Framework
"RTN","MPIFA24",69,0)
 .Q:$P($$SITE^VASITE,"^",3)'=200
"RTN","MPIFA24",70,0)
 .N FHIE S FHIE=$$MERGE^OMGPIDMI(ARRY("ICN",2),ARRY("ICN",1))
"RTN","MPIFA24",71,0)
 .;       ^^ THIS API IS ONLY AVAILABLE ON THE FHIE HOST SYSTEM
"RTN","MPIFA24",72,0)
 .I +FHIE=-1 D START^RGHLLOG(),EXC^RGHLLOG(208,$P(FHIE,"^",2),DFN),STOP^RGHLLOG()
"RTN","MPIFA24",73,0)
 Q
"RTN","MPIFA24",74,0)
 ;
"RTN","MPIFA24",75,0)
MSH(ARY,MSG) ;processing MSH fields
"RTN","MPIFA24",76,0)
 N COMP
"RTN","MPIFA24",77,0)
 S COMP=$E(HL("ECH"),1)
"RTN","MPIFA24",78,0)
 S ARY("SITE")=$$LKUP^XUAF4($P($P(MSG,HL("FS"),4),COMP))
"RTN","MPIFA24",79,0)
 Q
"RTN","MPIFA24",80,0)
 ;
"RTN","MPIFA24",81,0)
EVN(ARY,MSG) ;processing EVN fields
"RTN","MPIFA24",82,0)
 S ARY("EVTR")=$P(MSG,HL("FS"),2) ;not currently used
"RTN","MPIFA24",83,0)
 S ARY("DLT")=$$FMDATE^HLFNC($P(MSG,HL("FS"),3))
"RTN","MPIFA24",84,0)
 Q
"RTN","MPIFA24",85,0)
 ;
"RTN","MPIFA24",86,0)
PID(ARY,MSG,FIRST) ;processing PID fields
"RTN","MPIFA24",87,0)
 N REP,PID,COMP,SUBCOMP,MPIDFN,MPISSN,ICN
"RTN","MPIFA24",88,0)
 S REP=$E(HL("ECH"),2),COMP=$E(HL("ECH"),1),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA24",89,0)
 S MPISSN="",MPIDFN=""
"RTN","MPIFA24",90,0)
 ;**41 replaced with line below D PIDPROC^MPIFA43(.ICN,.MPISSN,.MPIDFN,.PID)
"RTN","MPIFA24",91,0)
 D PIDP^RGADTP1(.MSG,.ARY,.HL)
"RTN","MPIFA24",92,0)
 I FIRST=1 S ARY(991.01)=+ARY("ICN"),ARY(991.02)=$P(ARY("ICN"),"V",2)
"RTN","MPIFA24",93,0)
 S ARY("ICN",FIRST)=ARY("ICN")
"RTN","MPIFA24",94,0)
 S ARY("SSN",FIRST)=ARY("SSN")
"RTN","MPIFA24",95,0)
 S ARY("DFN",FIRST)=ARY("DFN")
"RTN","MPIFA24",96,0)
 Q
"RTN","MPIFA24",97,0)
 ;
"RTN","MPIFA24",98,0)
PD1(ARY,MSG) ;processing PD1 fields
"RTN","MPIFA24",99,0)
 N COMP
"RTN","MPIFA24",100,0)
 S COMP=$E(HL("ECH"),1)
"RTN","MPIFA24",101,0)
 S ARY(991.03)=$P($P(HLNODE,HL("FS"),4),COMP,3)
"RTN","MPIFA24",102,0)
 Q
"RTN","MPIFA24",103,0)
 ;
"RTN","MPIFA24",104,0)
PROC ;
"RTN","MPIFA24",105,0)
 N NXT,DFN
"RTN","MPIFA24",106,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA24",107,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA24",108,0)
 .I $E(HLNODE,1,3)="MSA"&($P(HLNODE,HL("FS"),4)'="") D
"RTN","MPIFA24",109,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION
"RTN","MPIFA24",110,0)
 ..D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA24",111,0)
 ..D EXC^RGHLLOG(208,$P(HLNODE,HL("FS"),4)_" for HL msg# "_HLMTIEN,DFN)
"RTN","MPIFA24",112,0)
 ..D STOP^RGHLLOG(0)
"RTN","MPIFA24",113,0)
 K ^XTMP("MPIFA24%"_DFN)
"RTN","MPIFA24",114,0)
 Q
"RTN","MPIFA31B")
0^1^B22496134^B18454677
"RTN","MPIFA31B",1,0)
MPIFA31B ;BP/CMC-BUILD A31 MSGS ;13 May 2014  4:38 PM
"RTN","MPIFA31B",2,0)
 ;;1.0;MASTER PATIENT INDEX VISTA;**22,24,27,28,31,25,44,46,54,59**;30 Apr 99;Build 1
"RTN","MPIFA31B",3,0)
 ;
"RTN","MPIFA31B",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA31B",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA31B",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA31B",7,0)
 ;  $$PV1^VAFCSB, $$RADE^VAFCSB, $$LABE^VAFCSB, $$PHARA^VAFCSB, $$PV2^VAFCSB - #4921
"RTN","MPIFA31B",8,0)
TA31 ; Tasked entry point
"RTN","MPIFA31B",9,0)
 N TMP
"RTN","MPIFA31B",10,0)
 S TMP=$$A31(DFN)
"RTN","MPIFA31B",11,0)
 Q
"RTN","MPIFA31B",12,0)
 ;
"RTN","MPIFA31B",13,0)
A31(DFN) ;BUILD AND SEND A31
"RTN","MPIFA31B",14,0)
 I $P($$SITE^VASITE,"^",3)=200 Q 1
"RTN","MPIFA31B",15,0)
 ; ^ PATCH 25 IF this is the FHIE Host system, don't build A31 messages
"RTN","MPIFA31B",16,0)
 N RESLT,CNT,MPI,EVN,TCNT,ERR,PD1,PID,EN,LAB,PV1,PV2,RAD,PRE,OLD,ZPD
"RTN","MPIFA31B",17,0)
 N ZEL,ZSP,SIDG,NAMECOMP
"RTN","MPIFA31B",18,0)
 K HLA("HLA"),HLA("HLS")
"RTN","MPIFA31B",19,0)
 Q:$E($$GETICN^MPIF001(DFN),1,3)=$P($$SITE^VASITE(),"^",3) 0
"RTN","MPIFA31B",20,0)
 ; ^ LOCAL ICN DON'T SEND
"RTN","MPIFA31B",21,0)
 Q:+$$GETICN^MPIF001(DFN)=-1 0
"RTN","MPIFA31B",22,0)
 ; ^ NO ICN DON'T SEND
"RTN","MPIFA31B",23,0)
 S CNT=1
"RTN","MPIFA31B",24,0)
 D INIT^HLFNC2("MPIF ADT-A31 SERVER",.HL)
"RTN","MPIFA31B",25,0)
 I $O(HL(""))="" Q "-1^"_$P(HL,"^",2)
"RTN","MPIFA31B",26,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),COMP=$E(HL("ECH"),1),REP=$E(HL("ECH"),2),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA31B",27,0)
 S ERR="",TCNT=0
"RTN","MPIFA31B",28,0)
 D BLDEVN^VAFCQRY(DFN,"1,2",.EVN,.HL,"A31",.ERR)
"RTN","MPIFA31B",29,0)
 Q:ERR'="" ERR
"RTN","MPIFA31B",30,0)
 D BLDPID^VAFCQRY(DFN,1,"ALL",.PID,.HL,.ERR) ;**25
"RTN","MPIFA31B",31,0)
 Q:ERR'="" ERR
"RTN","MPIFA31B",32,0)
 D BLDPD1^VAFCQRY(DFN,"3",.PD1,.HL,.ERR) ;**44 NEW PD1 SEGMENT VALUES -- SENDING CMOR AGAIN AS WITHOUT 40 ON THE MPI SIDE THIS IS A PROBLEM.
"RTN","MPIFA31B",33,0)
 ;S PD1=$$PD1^VAFCSB ;**44 NEW PD1 SEGMENT VALUES -- IMDQ DECIDED NOT TO SEND PREFERRED FACILITY 9/7/06
"RTN","MPIFA31B",34,0)
 N X S X="VAFCSB" X ^%ZOSF("TEST") I $T D
"RTN","MPIFA31B",35,0)
 .;**44 VAFCSB coming in with DG*5.3*707
"RTN","MPIFA31B",36,0)
 .S PV1=$$PV1^VAFCSB ;**44 PV1 segment
"RTN","MPIFA31B",37,0)
 .S RAD=$$RADE^VAFCSB ;**44 OBX FOR LAST RADIOLOGY EXAM
"RTN","MPIFA31B",38,0)
 .S LAB=$$LABE^VAFCSB ;**44 OBX FOR LAST LAB EXAM
"RTN","MPIFA31B",39,0)
 .S PRE=$$PHARA^VAFCSB ;**44 OBX FOR ACTIVE PRESCRIPTIONS
"RTN","MPIFA31B",40,0)
 .S SIDG=$$SIG^VAFCSB(DFN)  ;**59 OBX FOR SELF ID GENDER
"RTN","MPIFA31B",41,0)
 .S NAMECOMP=$$NAMEOBX^VAFCSB(DFN) ;**59,MVI_3975 (mko): OBX for Patient .01 and Name Components
"RTN","MPIFA31B",42,0)
 .S PV2=$$PV2^VAFCSB ;**44 PV2 segment
"RTN","MPIFA31B",43,0)
 S OLD=$$OLD ;**54,MVI_913: OBX to mark an older record
"RTN","MPIFA31B",44,0)
 S ZPD=$$EN1^VAFHLZPD(DFN,"1,17,21,34") ;25 ;**44 ADDED PSEUDO SSN REASON (34), 1 and 21 TO ZPD SEGMENT
"RTN","MPIFA31B",45,0)
 S ZSP=$$EN^VAFHLZSP(DFN)  ;**59
"RTN","MPIFA31B",46,0)
 S ZEL=$$EN^VAFHLZEL(DFN,"1,8,9",1)  ;**59
"RTN","MPIFA31B",47,0)
 S EN=1
"RTN","MPIFA31B",48,0)
 S HLA("HLS",EN)=EVN(1),EN=EN+1
"RTN","MPIFA31B",49,0)
 S CNT=0 F  S CNT=$O(PID(CNT)) Q:CNT=""  D
"RTN","MPIFA31B",50,0)
 .I CNT=1 S HLA("HLS",EN)=PID(CNT)
"RTN","MPIFA31B",51,0)
 .I CNT>1 S HLA("HLS",EN,CNT-1)=PID(CNT)
"RTN","MPIFA31B",52,0)
 S EN=EN+1
"RTN","MPIFA31B",53,0)
 I $G(PD1(1))'="" S HLA("HLS",EN)=PD1(1),EN=EN+1 ;**44 only pass PD1 segment if has values -- SENDING CMOR AGAIN AS WITHOUT 40 ON MPI SIDE THIS IS A PROBLEM.
"RTN","MPIFA31B",54,0)
 I $G(PV1)'="" S HLA("HLS",EN)=PV1,EN=EN+1 ;**44 only pass PV1 segment if has values
"RTN","MPIFA31B",55,0)
 I $G(PV2)'="" S HLA("HLS",EN)=PV2,EN=EN+1 ;**44 only pass PV2 segment if has values
"RTN","MPIFA31B",56,0)
 I $G(RAD)'="" S HLA("HLS",EN)=RAD,EN=EN+1 ;**44 only pass RADIOLOGY IN OBX segment if has values
"RTN","MPIFA31B",57,0)
 I $G(LAB)'="" S HLA("HLS",EN)=LAB,EN=EN+1 ;**44 only pass LAB IN OBX segment if has values
"RTN","MPIFA31B",58,0)
 I $G(PRE)'="" S HLA("HLS",EN)=PRE,EN=EN+1 ;**44 only pass PRESCRIPTION IN OBX segment if has values
"RTN","MPIFA31B",59,0)
 I $G(OLD)'="" S HLA("HLS",EN)=OLD,EN=EN+1 ;**54,MVI_913: pass OLDER RECORD in OBX if flagged as such
"RTN","MPIFA31B",60,0)
 I $G(SIDG)'="" S HLA("HLS",EN)=SIDG,EN=EN+1  ;**59
"RTN","MPIFA31B",61,0)
 I $G(NAMECOMP)'="" S HLA("HLS",EN)=NAMECOMP,EN=EN+1 ;**59,MVI_3975 (mko): pass NAME COMPONENTS in OBX
"RTN","MPIFA31B",62,0)
 S HLA("HLS",EN)=ZPD,EN=EN+1 ;**44 ZPD SEGMENT
"RTN","MPIFA31B",63,0)
 I $G(ZSP)'="" S HLA("HLS",EN)=ZSP,EN=EN+1 ;**59 ZSP segment
"RTN","MPIFA31B",64,0)
 I $G(ZEL)'="" S HLA("HLS",EN)=ZEL,EN=EN+1 ;**59 ZEL segment
"RTN","MPIFA31B",65,0)
 S MPI=$$MPILINK^MPIFAPI()
"RTN","MPIFA31B",66,0)
 Q:$P($G(MPI),"^")=-1 "-1^No logical link defined for the MPI"
"RTN","MPIFA31B",67,0)
 S HLL("LINKS",1)="MPIF ADT-A31 CLIENT^"_MPI
"RTN","MPIFA31B",68,0)
 D GENERATE^HLMA("MPIF ADT-A31 SERVER","LM",1,.MPIFRSLT,"","")
"RTN","MPIFA31B",69,0)
 S RESLT=$S(+MPIFRSLT:MPIFRSLT,1:$P(MPIFRSLT,"^",3))
"RTN","MPIFA31B",70,0)
 S ^XTMP("MPIFA31%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"MPIA31 msg to MPI for DFN "_DFN
"RTN","MPIFA31B",71,0)
 I '+RESLT S ^XTMP("MPIFA31%"_DFN,"MPI",0)="A"
"RTN","MPIFA31B",72,0)
 K HLA,HLL("LINKS"),COMP,REP,SUBCOMP,HLA("HLA"),HLA("HLS"),MPIFRSLT
"RTN","MPIFA31B",73,0)
 ;**44 REMOVED HLEID, HLECH AND HLFS from Kill line above
"RTN","MPIFA31B",74,0)
 Q RESLT
"RTN","MPIFA31B",75,0)
 ;
"RTN","MPIFA31B",76,0)
RES ;
"RTN","MPIFA31B",77,0)
 N NXT,DFN,ERROR,CODE S CODE=""
"RTN","MPIFA31B",78,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA31B",79,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2),ERROR=$P(HLNODE,HL("FS"),4),CODE=$P(HLNODE,HL("FS"),2)
"RTN","MPIFA31B",80,0)
 .I $E(HLNODE,1,3)="MSA"&(CODE="AR") D
"RTN","MPIFA31B",81,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION
"RTN","MPIFA31B",82,0)
 ..D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA31B",83,0)
 ..;**44 check which type of exception to be logged
"RTN","MPIFA31B",84,0)
 ..D EXC^RGHLLOG(234,ERROR,DFN) ;**46
"RTN","MPIFA31B",85,0)
 ..D STOP^RGHLLOG(0)
"RTN","MPIFA31B",86,0)
 K:$G(DFN)>0 ^XTMP("MPIF OLD RECORDS",DFN) ;**54,MVI_913: Delete the old record designation
"RTN","MPIFA31B",87,0)
 K ^XTMP("MPIFA31%"_DFN)
"RTN","MPIFA31B",88,0)
 Q
"RTN","MPIFA31B",89,0)
OLD() ; Return OBX segment to flag a record as "old"
"RTN","MPIFA31B",90,0)
 ;**54,MVI_913: New subroutine
"RTN","MPIFA31B",91,0)
 Q $S($D(^XTMP("MPIF OLD RECORDS",DFN))#2:"OBX"_HL("FS")_HL("FS")_"CE"_HL("FS")_"OLDER RECORD"_HL("FS")_HL("FS")_"Y",1:"")
"RTN","MPIFSA2")
0^3^B86870493^B83766711
"RTN","MPIFSA2",1,0)
MPIFSA2 ;SF/CMC,CKN-STAND ALONE QUERY PART 2 ; 4/29/14 1:34pm
"RTN","MPIFSA2",2,0)
 ;;1.0;MASTER PATIENT INDEX VISTA;**28,29,35,38,43,52,55,57,59**;30 Apr 99;Build 1
"RTN","MPIFSA2",3,0)
 ;
"RTN","MPIFSA2",4,0)
 ;Integration Agreements: $$EN^HLCSAC - #3471
"RTN","MPIFSA2",5,0)
 ;
"RTN","MPIFSA2",6,0)
FIELD ;
"RTN","MPIFSA2",7,0)
 ;;@00108.1;LAST NAME;ST;30
"RTN","MPIFSA2",8,0)
 ;;@00122;SSN;ST;9
"RTN","MPIFSA2",9,0)
 ;;@00110;DOB;TS;8
"RTN","MPIFSA2",10,0)
 ;;@00756;PRIMARY CARE SITE;ST;6
"RTN","MPIFSA2",11,0)
 ;;@00105;ICN;ST;19
"RTN","MPIFSA2",12,0)
 ;;@00108.2;FIRST NAME;ST;30
"RTN","MPIFSA2",13,0)
 ;;@00169;TREATING FACILITY (MULTIPLE--FILE 985.5);ST;999
"RTN","MPIFSA2",14,0)
 ;;@00740;DATE OF DEATH;TS;8
"RTN","MPIFSA2",15,0)
 ;;@00108.3;MIDDLE;ST;16
"RTN","MPIFSA2",16,0)
 ;;@00111;SEX;ST;1
"RTN","MPIFSA2",17,0)
 ;;@00126.1;BIRTH PLACE CITY;ST;30
"RTN","MPIFSA2",18,0)
 ;;@00126.2;BIRTH PLACE STATE;ST;3
"RTN","MPIFSA2",19,0)
 ;;@00108.5;NAME PREFIX;ST;15
"RTN","MPIFSA2",20,0)
 ;;@00108.4;NAME SUFFIX;ST;10
"RTN","MPIFSA2",21,0)
 ;;@00109.1;MOTHER'S MAIDEN NAME;ST;20
"RTN","MPIFSA2",22,0)
 ;;@ZEL6;CLAIM NUMBER;ST;9
"RTN","MPIFSA2",23,0)
 ;;@CASE#;MPI DUP CASE#;ST;69
"RTN","MPIFSA2",24,0)
 ;;@POW;POW STATUS;ST;1
"RTN","MPIFSA2",25,0)
 ;;@00127;MULTIPLE BIRTH INDICATOR;ST;1
"RTN","MPIFSA2",26,0)
 ;;@00112.1;ALIAS LAST NAME;ST;30
"RTN","MPIFSA2",27,0)
 ;;@00112.2;ALIAS FIRST NAME;ST;25
"RTN","MPIFSA2",28,0)
 ;;@00112.3;ALIAS MIDDLE NAME;ST;25
"RTN","MPIFSA2",29,0)
 ;;@00112.5;ALIAS PREFIX;ST;10
"RTN","MPIFSA2",30,0)
 ;;@00112.4;ALIAS SUFFIX;ST;10
"RTN","MPIFSA2",31,0)
 ;;@00114.1;STREET ADDRESS LINE 1;ST;35
"RTN","MPIFSA2",32,0)
 ;;@00114.2;STREET ADDRESS LINE 2;ST;30
"RTN","MPIFSA2",33,0)
 ;;@00114.3;CITY;ST;28
"RTN","MPIFSA2",34,0)
 ;;@00114.8;STREET ADDRESS LINE 3;ST;30
"RTN","MPIFSA2",35,0)
 ;;@00116;PHONE NUMBER (RESIDENCE);ST;23
"RTN","MPIFSA2",36,0)
 ;;@SCORE;SCORE;ST;8
"RTN","MPIFSA2",37,0)
 ;;@ALTRSHLD;AUTOLINK THRESHOLD;ST;5
"RTN","MPIFSA2",38,0)
 ;;@TKTRSHLD;TASK THRESHOLD;ST;5
"RTN","MPIFSA2",39,0)
 ;;
"RTN","MPIFSA2",40,0)
VTQ(MPIVAR) ;
"RTN","MPIFSA2",41,0)
 N TIME,% D NOW^%DTC S TIME=%
"RTN","MPIFSA2",42,0)
 W !!,"Attempting to connect to the Master Patient Index in Austin...",!,"If DOB is inexact or if SSN is not passed or if common name,",!,"this could take some time - please be patient...."
"RTN","MPIFSA2",43,0)
 N HL,MPIQRYNM,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER,RDF,QUERY,TEST,SITE,MPIDC,MPINM,MPI1NM,MPI2NM,MPIESC,MPIHDOB,MPIRS,MPISCS,QUEDDOB,MPIFLDV
"RTN","MPIFSA2",44,0)
 S HLP("ACKTIME")=300,HL("ECH")="^~\&",HL("FS")="|",MPIIN="",MPICNT=1,MPICS=$E(HL("ECH"),1)
"RTN","MPIFSA2",45,0)
 ;**43 CHANGING QUERY NAME FROM VTQ_PID_ICN_NO_LOAD TO VTQ_DISPLAY_ONLY_QUERY to enable the returning of potential matches and not just exact matches
"RTN","MPIFSA2",46,0)
 S MPIQRYNM="VTQ_DISPLAY_ONLY_QUERY"
"RTN","MPIFSA2",47,0)
 I '$D(MPIVAR("DFN")) S MPIVAR("DFN")=""
"RTN","MPIFSA2",48,0)
 S MPIMCNT=MPIVAR("DFN")
"RTN","MPIFSA2",49,0)
 ;SETUP VTQ
"RTN","MPIFSA2",50,0)
 S MPICS=$E(HL("ECH"),1),MPIRS=$E(HL("ECH"),2),MPISCS=$E(HL("ECH"),4),MPIESC=$E(HL("ECH"),3)
"RTN","MPIFSA2",51,0)
 D BLDRDF(.MPIOUT,3,MPIRS,MPICS)
"RTN","MPIFSA2",52,0)
 ; ^ fields to be returned in query response
"RTN","MPIFSA2",53,0)
 S QUERY="VTQ"_HL("FS")_$G(MPIVAR("DFN"))_HL("FS")_"T"_HL("FS")_MPIQRYNM_HL("FS")_"ICN"_HL("FS")
"RTN","MPIFSA2",54,0)
 S MPI2NM=$P($G(MPIVAR("NM")),",",1),QUERY=QUERY_"@00108.1"_MPICS_"EQ"_MPICS_MPI2NM ; ^ sending last name
"RTN","MPIFSA2",55,0)
 I MPIVAR("SSN")'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00122"_MPICS_"EQ"_MPICS_$G(MPIVAR("SSN")) ; ^ sending SSN
"RTN","MPIFSA2",56,0)
 S MPI1NM=$P($G(MPIVAR("NM")),",",2),MPI1NM=$P(MPI1NM," ",1) I MPI1NM'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.2"_MPICS_"EQ"_MPICS_MPI1NM
"RTN","MPIFSA2",57,0)
 ; ^ sending first name
"RTN","MPIFSA2",58,0)
 I $G(MPIVAR("DOB"))>0 D
"RTN","MPIFSA2",59,0)
 .S MPIHDOB=$$HLDATE^HLFNC(MPIVAR("DOB")) ; send date of birth (convert to hl7 date format)
"RTN","MPIFSA2",60,0)
 .S QUEDDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB,QUERY=QUERY_QUEDDOB ; ^ sending date of birth
"RTN","MPIFSA2",61,0)
 S MPI1NM=$P($G(MPIVAR("NM")),",",2),MPIMID=$P(MPI1NM," ",2) I MPIMID'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.3"_MPICS_"EQ"_MPICS_MPIMID ; sending middle name
"RTN","MPIFSA2",62,0)
 S MPISUF=$P(MPI1NM," ",3) I MPISUF'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.4"_MPICS_"EQ"_MPICS_MPISUF ; sending suffix
"RTN","MPIFSA2",63,0)
 S MPIPRE=$P(MPI1NM," ",4) I MPIPRE'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.5"_MPICS_"EQ"_MPICS_MPIPRE ; sending prefix
"RTN","MPIFSA2",64,0)
 I $G(MPIVAR("SEX"))'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00111"_MPICS_"EQ"_MPICS_$G(MPIVAR("SEX")) ;sending sex
"RTN","MPIFSA2",65,0)
 I $G(MPIVAR("ADDR1"))'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00114.1"_MPICS_"EQ"_MPICS_$G(MPIVAR("ADDR1")) ;sending Address 1
"RTN","MPIFSA2",66,0)
 I $G(MPIVAR("ADDR2"))'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00114.2"_MPICS_"EQ"_MPICS_$G(MPIVAR("ADDR2")) ;sending Address 2
"RTN","MPIFSA2",67,0)
 I $G(MPIVAR("CITY"))'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00114.3"_MPICS_"EQ"_MPICS_$G(MPIVAR("CITY")) ;sending City
"RTN","MPIFSA2",68,0)
 I $G(MPIVAR("ADDR3"))'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00114.8"_MPICS_"EQ"_MPICS_$G(MPIVAR("ADDR3")) ;sending Address 3
"RTN","MPIFSA2",69,0)
 I $G(MPIVAR("PHONE"))'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00116"_MPICS_"EQ"_MPICS_$G(MPIVAR("PHONE")) ;sending Residence Phone
"RTN","MPIFSA2",70,0)
 ;keep following traits for future use
"RTN","MPIFSA2",71,0)
 ;I $G(MPIVAR("MMN"))'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00109.1"_MPICS_"EQ"_MPICS_$G(MPIVAR("MMN")) ;sending Mother's maiden name
"RTN","MPIFSA2",72,0)
 ;I $G(MPIVAR("CLAIM"))'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@ZEL6"_MPICS_"EQ"_MPICS_$G(MPIVAR("CLAIM")) ;sending Claim #
"RTN","MPIFSA2",73,0)
 ;I $G(MPIVAR("POBCITY"))'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00126.1"_MPICS_"EQ"_MPICS_$G(MPIVAR("POBCITY")) ;sending POB city
"RTN","MPIFSA2",74,0)
 ;I $G(MPIVAR("POBSTATE"))'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00126.2"_MPICS_"EQ"_MPICS_$G(MPIVAR("POBSTATE")) ;sending POB State
"RTN","MPIFSA2",75,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3) ;**29
"RTN","MPIFSA2",76,0)
 S HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VQQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS") ;create msh **38 changed VTQ to VQQ
"RTN","MPIFSA2",77,0)
 S MPIOUT(1)=HEADER K MPIOUT(0) S MPIOUT(2)=QUERY
"RTN","MPIFSA2",78,0)
 ;Attempt to connect to MPI and send message,receive message. Message is returned in MPIDC array
"RTN","MPIFSA2",79,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","MPIDC")
"RTN","MPIFSA2",80,0)
 K HLP("ACKTIME") ;Clean up the ack timeout HLP array variable
"RTN","MPIFSA2",81,0)
 I +TEST<0 W !!,"Could not connect to MPI or Time-out occured, try again later." G EXIT
"RTN","MPIFSA2",82,0)
 K ^TMP("MPIFVQQ",$J),^TMP("MPIDOQ",$J)
"RTN","MPIFSA2",83,0)
INIPARS ;
"RTN","MPIFSA2",84,0)
 N SEG,INDEX,SKIP,CHECK,AL,TTF2,TFLL,TF,TF2,MPIREP,MPICOMP
"RTN","MPIFSA2",85,0)
 S INDEX=0 K CHECK
"RTN","MPIFSA2",86,0)
LOOP1 ;
"RTN","MPIFSA2",87,0)
 ;process in ADT type messages
"RTN","MPIFSA2",88,0)
 N MPIX S MPIX=0 N REP,SG,MSG,MPIQUIT,MPINODE
"RTN","MPIFSA2",89,0)
 S MPIQUIT=0
"RTN","MPIFSA2",90,0)
 F MPIX=0:1 X "D LOOP2" D  K MPINODE,MSG Q:MPIQUIT'>0
"RTN","MPIFSA2",91,0)
 . I $D(MPINODE(1)) S SG=$E(MPINODE(1),1,3) S MSG(1)=MPINODE(1) D
"RTN","MPIFSA2",92,0)
 ..  S MPIJ=1 F  S MPIJ=$O(MPINODE(MPIJ)) Q:'MPIJ  S MSG(MPIJ)=MPINODE(MPIJ)
"RTN","MPIFSA2",93,0)
 .. D:SG?2A1(1A,1N) @SG
"RTN","MPIFSA2",94,0)
 I '$D(^TMP("MPIFVQQ",$J)) W !!,"Patient was not found in the MPI." G EXIT
"RTN","MPIFSA2",95,0)
 I INDEX>9 W !!,"More Identity Traits Required to Make a Match." G EXIT
"RTN","MPIFSA2",96,0)
DISPLAY ; display data found
"RTN","MPIFSA2",97,0)
 I INDEX>1 W !!,"Found potential matches"
"RTN","MPIFSA2",98,0)
 I INDEX=1 W !!,"Found One Match"
"RTN","MPIFSA2",99,0)
 N CNT1,CNT2,STOP,CNTR2,TTF,CNT3,DIR,X,Y,DATA,PREFIX,ANAME,APRE,ALN,AFN,NAME,SSN,BIRTHDAY,CMOR,TF,ICN,POBC,POBS,PAST,XXX,AMID,ASUF
"RTN","MPIFSA2",100,0)
 N MNAME,SUFFIX,SEX,IEN,CMOR2,TF2,CLAIM,CASE,NOIS,CUSER,TFN,CMOR3,POW,MBIRTH,TIEN,MIDDLE,SCORE,ALTRSHLD,TKTRSHLD,I
"RTN","MPIFSA2",101,0)
 S (CNT1)=0
"RTN","MPIFSA2",102,0)
 F  S CNT1=$O(^TMP("MPIFVQQ",$J,CNT1)) Q:CNT1'>0!($D(STOP))  D
"RTN","MPIFSA2",103,0)
 . S DATA=$G(^TMP("MPIFVQQ",$J,CNT1,"DATA"))
"RTN","MPIFSA2",104,0)
 . Q:DATA=""
"RTN","MPIFSA2",105,0)
 . K CHECK S NAME=$P(DATA,"^"),SSN=$P(DATA,"^",3),BIRTHDAY=$P(DATA,"^",4),ICN=$P(DATA,"^",6)
"RTN","MPIFSA2",106,0)
 . S SEX=$P(DATA,"^",11),SCORE=$P(DATA,"^",21),ALTRSHLD=$P(DATA,"^",22),TKTRSHLD=$P(DATA,"^",23)
"RTN","MPIFSA2",107,0)
 . I $G(SCORE)="" W !!,"IdM System uavailable, try again later!" S STOP=1 Q  ;Quit if no score is returned.
"RTN","MPIFSA2",108,0)
 . ;**55 MPIC_2218  Commented the following two lines, added the third
"RTN","MPIFSA2",109,0)
 . ;I SCORE>=ALTRSHLD S M="E"
"RTN","MPIFSA2",110,0)
 . ;I SCORE<ALTRSHLD,(SCORE>=TKTRSHLD) S M="P"
"RTN","MPIFSA2",111,0)
 . S M=$S(SCORE>=ALTRSHLD:"E",1:"P")
"RTN","MPIFSA2",112,0)
 . ;Rearranging array for sectional view display
"RTN","MPIFSA2",113,0)
 . ;S FULLICN=ICN   ;**57 - MVI_2350 (cml)
"RTN","MPIFSA2",114,0)
 . ;**59 - MVI_3785 (ckn) - Storing full ICN in TMP global so it
"RTN","MPIFSA2",115,0)
 . ;display full ICN correctly. Removing + sign in front of ICN
"RTN","MPIFSA2",116,0)
 . ;in below lines.
"RTN","MPIFSA2",117,0)
 . S ^TMP("MPIDOQ",$J,M,SCORE,ICN)=NAME_"^"_SSN_"^"_BIRTHDAY_"^"_SEX
"RTN","MPIFSA2",118,0)
 . M ^TMP("MPIDOQ",$J,M,SCORE,ICN,"TF")=^TMP("MPIFVQQ",$J,CNT1,"TF")
"RTN","MPIFSA2",119,0)
 I $D(STOP) Q  ;Quit if no score is returned
"RTN","MPIFSA2",120,0)
DISP2 ;
"RTN","MPIFSA2",121,0)
 S COUNT=0
"RTN","MPIFSA2",122,0)
 W @IOF
"RTN","MPIFSA2",123,0)
 F I="E","P" D
"RTN","MPIFSA2",124,0)
 . I $D(^TMP("MPIDOQ",$J,I)) D HDR($S(I="E":"",I="P":" POTENTIAL",1:""))
"RTN","MPIFSA2",125,0)
 . S SCORE=9999999 F  S SCORE=$O(^TMP("MPIDOQ",$J,I,SCORE),-1) Q:SCORE=""  D
"RTN","MPIFSA2",126,0)
 . . S ICN=0 F  S ICN=$O(^TMP("MPIDOQ",$J,I,SCORE,ICN)) Q:ICN=""  D
"RTN","MPIFSA2",127,0)
 . . . S ICNARR(ICN)="",COUNT=COUNT+1
"RTN","MPIFSA2",128,0)
 . . . S DATA=$G(^TMP("MPIDOQ",$J,I,SCORE,ICN))
"RTN","MPIFSA2",129,0)
 . . . D HDR1
"RTN","MPIFSA2",130,0)
 . . . ;**59 - MVI_3785 (ckn) - replacing FULLICN with ICN
"RTN","MPIFSA2",131,0)
 . . . W !,COUNT_") ",?4,ICN,?22,$P(DATA,"^"),?54,$P(DATA,"^",2),?65,$P(DATA,"^",3),?76,$P(DATA,"^",4)  ;**57 - MVI_2350 (cml)
"RTN","MPIFSA2",132,0)
 . . . W ! N TMP S XXX=0 F  S XXX=$O(^TMP("MPIDOQ",$J,I,SCORE,ICN,"TF",XXX)) Q:XXX=""  S TMP=$G(^TMP("MPIDOQ",$J,I,SCORE,ICN,"TF",XXX)) Q:TMP=""  D
"RTN","MPIFSA2",133,0)
 . . . . S TMP=$P(TMP,"^",1) W !,?10,"Treating Facility: ",$P($$NS^XUAF4($$LKUP^XUAF4(TMP)),"^")," (",TMP,")"
"RTN","MPIFSA2",134,0)
 . . . W !
"RTN","MPIFSA2",135,0)
 S ENOUGH=0
"RTN","MPIFSA2",136,0)
 W !
"RTN","MPIFSA2",137,0)
 D ASK I ENOUGH G EXIT
"RTN","MPIFSA2",138,0)
 ;**59 - MVI_3785 (ckn) - send short ICN in ENRPC tag.
"RTN","MPIFSA2",139,0)
 I TMPICN'="" W !,"Please wait..." D ENRPC(+TMPICN)
"RTN","MPIFSA2",140,0)
 W !!
"RTN","MPIFSA2",141,0)
 K DIR,DA S DIR(0)="Y",DIR("B")="NO",DIR("A")="Would you like to see another record" D ^DIR
"RTN","MPIFSA2",142,0)
 I $D(DTOUT)!($D(DUOUT)) S ENOUGH=1 G EXIT
"RTN","MPIFSA2",143,0)
 I Y G DISP2
"RTN","MPIFSA2",144,0)
EXIT K DA,X,Y,^TMP("MPIDOQ",$J) W !! Q
"RTN","MPIFSA2",145,0)
HDR(HDL) ;Header
"RTN","MPIFSA2",146,0)
 W !,"--- All ICNs Below meet the"_HDL_" Match criteria ---"
"RTN","MPIFSA2",147,0)
 Q
"RTN","MPIFSA2",148,0)
HDR1 ;Repeating header
"RTN","MPIFSA2",149,0)
 W !,?4,"ICN",?22,"NAME",?54,"SSN",?65,"DOB",?76,"SEX"  ;**57 - MVI_2350 (cml)
"RTN","MPIFSA2",150,0)
 Q
"RTN","MPIFSA2",151,0)
ASK ;
"RTN","MPIFSA2",152,0)
 N DIR,DA,DR,ND,SC,CNTR,BC,EC,ICN
"RTN","MPIFSA2",153,0)
 S EC=0,BC=1
"RTN","MPIFSA2",154,0)
 S TMP=0 F  S TMP=$O(ICNARR(TMP)) Q:TMP=""  S EC=EC+1
"RTN","MPIFSA2",155,0)
 K DIR,X,Y S DIR(0)="NA^"_BC_":"_EC,DIR("A")="Enter the Number to display the details: ",DIR("?")="Enter the number from range of "_BC_" to "_EC D ^DIR
"RTN","MPIFSA2",156,0)
 I $D(DTOUT)!($D(DUOUT)) S ENOUGH=1 Q
"RTN","MPIFSA2",157,0)
 S QFLG=0,CNTR=0
"RTN","MPIFSA2",158,0)
 F I="E","P" D
"RTN","MPIFSA2",159,0)
 . S SC=10000 F  S SC=$O(^TMP("MPIDOQ",$J,I,SC),-1) Q:SC=""!(QFLG)  D
"RTN","MPIFSA2",160,0)
 ..S ICN=0 F  S ICN=$O(^TMP("MPIDOQ",$J,I,SC,ICN)) Q:ICN=""!(QFLG)  D
"RTN","MPIFSA2",161,0)
 ...S CNTR=CNTR+1 I CNTR=+Y S QFLG=1,TMPICN=ICN
"RTN","MPIFSA2",162,0)
 Q
"RTN","MPIFSA2",163,0)
ENRPC(ICN) ;RPC Call
"RTN","MPIFSA2",164,0)
 N LOC,HNDL,RETURN,I,ND
"RTN","MPIFSA2",165,0)
 S LOC="200M"
"RTN","MPIFSA2",166,0)
 D EN1^XWB2HL7(.RETURN,LOC,"MPIF EDAT REMOTE",1,ICN)
"RTN","MPIFSA2",167,0)
 S HNDL=$G(RETURN(0))
"RTN","MPIFSA2",168,0)
 ;**57,MVI_1414: Check whether EN^XWB2HL7 call succeeded
"RTN","MPIFSA2",169,0)
 I HNDL="" W:+$G(RETURN(1))=-1 !,$P(RETURN(1),"^",2) Q
"RTN","MPIFSA2",170,0)
 I +HNDL=-1 W !,$P(HNDL,"^",2) Q
"RTN","MPIFSA2",171,0)
 F I=1:1:20 K RETURN D RPCCHK^XWB2HL7(.RETURN,HNDL) Q:+RETURN(0)=1  Q:+RETURN(0)=-1  W "." H 5
"RTN","MPIFSA2",172,0)
 I +RETURN(0)=-1 W !,$P(RETURN(0),"^",2) Q
"RTN","MPIFSA2",173,0)
 I +RETURN(0)'=1 W !,"MPI system is unavailable to display the record, Try again later." Q
"RTN","MPIFSA2",174,0)
 ;S DONE=0
"RTN","MPIFSA2",175,0)
 ;F I=1:1:20 D  Q:DONE
"RTN","MPIFSA2",176,0)
 ;. H 5 W "."
"RTN","MPIFSA2",177,0)
 ;. D RTNDATA^XWBDRPC(.RETURN,HNDL)
"RTN","MPIFSA2",178,0)
 ;. Q:$P(RETURN(0),"^")=0
"RTN","MPIFSA2",179,0)
 ;. I $P(RETURN(0),"^")=-1 D  Q
"RTN","MPIFSA2",180,0)
 ;. . I RETURN(0)["Not DONE" Q
"RTN","MPIFSA2",181,0)
 ;. S DONE=1
"RTN","MPIFSA2",182,0)
 ;I 'DONE W !,"MPI system is unavailable to display the record, Try again later." Q
"RTN","MPIFSA2",183,0)
 ;I DONE,$G(^XTMP(HNDL,"D",1))'="" D
"RTN","MPIFSA2",184,0)
 I $G(^XTMP(HNDL,"D",1))'="" D
"RTN","MPIFSA2",185,0)
 . W @IOF S $Y=1
"RTN","MPIFSA2",186,0)
 . S ND=0 F  S ND=$O(^XTMP(HNDL,"D",ND)) Q:ND=""  D
"RTN","MPIFSA2",187,0)
 ..W !,^XTMP(HNDL,"D",ND)
"RTN","MPIFSA2",188,0)
 K ^XTMP(HNDL),RETURN
"RTN","MPIFSA2",189,0)
 Q
"RTN","MPIFSA2",190,0)
LOOP2 ;
"RTN","MPIFSA2",191,0)
 N MPIDONE,MPII,MPIJ
"RTN","MPIFSA2",192,0)
 S MPII=0,MPIDONE=0
"RTN","MPIFSA2",193,0)
 F  S MPIQUIT=$O(MPIDC(MPIQUIT)) Q:'MPIQUIT  D  Q:MPIDONE
"RTN","MPIFSA2",194,0)
 . I MPIDC(MPIQUIT)="" S MPIDONE=1 Q
"RTN","MPIFSA2",195,0)
 . S MPII=MPII+1,MPINODE(MPII)=$G(MPIDC(MPIQUIT)) Q
"RTN","MPIFSA2",196,0)
 Q
"RTN","MPIFSA2",197,0)
MSH ;
"RTN","MPIFSA2",198,0)
 S MPIREP=$E(HL("ECH"),2),MPICOMP=$E(HL("ECH"),1)
"RTN","MPIFSA2",199,0)
 Q
"RTN","MPIFSA2",200,0)
MSA ;
"RTN","MPIFSA2",201,0)
 Q
"RTN","MPIFSA2",202,0)
RDF ;
"RTN","MPIFSA2",203,0)
 Q
"RTN","MPIFSA2",204,0)
QAK ;
"RTN","MPIFSA2",205,0)
 Q
"RTN","MPIFSA2",206,0)
RDT ;
"RTN","MPIFSA2",207,0)
 S INDEX=$G(INDEX)+1
"RTN","MPIFSA2",208,0)
 D RDT^MPIFSA3(.INDEX,.HL,.MSG)
"RTN","MPIFSA2",209,0)
 Q
"RTN","MPIFSA2",210,0)
BLDRDF(MPIOUT,MPICNT,MPIRS,MPICS) ;
"RTN","MPIFSA2",211,0)
 S MPIOUT(MPICNT)="RDF"_HL("FS")_32_HL("FS") N T,I F I=1:1 S T=$T(FIELD+I) Q:$P(T,";",3)=""  D
"RTN","MPIFSA2",212,0)
 . I I=1 S MPIFLDV=$P(T,";",3)_MPICS_$P(T,";",5)_MPICS_$P(T,";",6)
"RTN","MPIFSA2",213,0)
 . I I'=1 S MPIFLDV=MPIRS_$P(T,";",3)_MPICS_$P(T,";",5)_MPICS_$P(T,";",6)
"RTN","MPIFSA2",214,0)
 .N XLEN,TOTLEN
"RTN","MPIFSA2",215,0)
 . S TOTLEN=$L($G(MPIOUT(MPICNT)))+$L(MPIFLDV)
"RTN","MPIFSA2",216,0)
 . I TOTLEN'>245 S MPIOUT(MPICNT)=$G(MPIOUT(MPICNT))_MPIFLDV Q
"RTN","MPIFSA2",217,0)
 . I TOTLEN>245 D
"RTN","MPIFSA2",218,0)
 .. S XLEN=245-$L($G(MPIOUT(MPICNT)))
"RTN","MPIFSA2",219,0)
 .. S MPIOUT(MPICNT)=$G(MPIOUT(MPICNT))_$E(MPIFLDV,1,XLEN),MPICNT=MPICNT+1
"RTN","MPIFSA2",220,0)
 .. S MPIOUT(MPICNT)=$E(MPIFLDV,XLEN+1,245)
"RTN","MPIFSA2",221,0)
 Q
"VER")
8.0^22.0
"BLD",3008,6)
^56
**END**
**END**

