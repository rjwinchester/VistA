Released MD*1*60 SEQ #47
Extracted from mail message
**KIDS**:MD*1.0*60^

**INSTALL NAME**
MD*1.0*60
"BLD",21621,0)
MD*1.0*60^CLINICAL PROCEDURES^0^3180719^y
"BLD",21621,1,0)
^^15^15^3180416^
"BLD",21621,1,1,0)
Clinical Procedures and DICOM Consult Request Tracking.
"BLD",21621,1,2,0)
 
"BLD",21621,1,3,0)
This patch and MAG*3.0*208 work together to greatly imnprove 
"BLD",21621,1,4,0)
interoperability between Clinical Procedures and Vist Imaging
"BLD",21621,1,5,0)
CPRS Consult Request Tracking DICOM.
"BLD",21621,1,6,0)
 
"BLD",21621,1,7,0)
The CP studies have the same Instrument Order Number as the
"BLD",21621,1,8,0)
regular consult and procedure Accession Number (sss-GMR-nnnnnnnn).
"BLD",21621,1,9,0)
 
"BLD",21621,1,10,0)
This allows DICOM objects created during a CP examination to be sent
"BLD",21621,1,11,0)
to VistA Imaging and be processed automatically.  It also allows them
"BLD",21621,1,12,0)
to be used with all of the other DICOM services, like query/retrieve
"BLD",21621,1,13,0)
and export.
"BLD",21621,1,14,0)
 
"BLD",21621,1,15,0)
Reports in DICOM Encapsulated PDF are highly recommended.
"BLD",21621,4,0)
^9.64PA^702.09^1
"BLD",21621,4,702.09,0)
702.09
"BLD",21621,4,702.09,2,0)
^9.641^702.09^1
"BLD",21621,4,702.09,2,702.09,0)
CP INSTRUMENT  (File-top level)
"BLD",21621,4,702.09,2,702.09,1,0)
^9.6411^.19^1
"BLD",21621,4,702.09,2,702.09,1,.19,0)
VISTA IMAGING PARAMETER
"BLD",21621,4,702.09,222)
y^y^p^^^^n^^n
"BLD",21621,4,702.09,224)

"BLD",21621,4,"APDD",702.09,702.09)

"BLD",21621,4,"APDD",702.09,702.09,.19)

"BLD",21621,4,"B",702.09,702.09)

"BLD",21621,6.3)
1
"BLD",21621,"ABPKG")
n
"BLD",21621,"KRN",0)
^9.67PA^779.2^20
"BLD",21621,"KRN",.4,0)
.4
"BLD",21621,"KRN",.401,0)
.401
"BLD",21621,"KRN",.402,0)
.402
"BLD",21621,"KRN",.403,0)
.403
"BLD",21621,"KRN",.5,0)
.5
"BLD",21621,"KRN",.84,0)
.84
"BLD",21621,"KRN",3.6,0)
3.6
"BLD",21621,"KRN",3.8,0)
3.8
"BLD",21621,"KRN",9.2,0)
9.2
"BLD",21621,"KRN",9.8,0)
9.8
"BLD",21621,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",21621,"KRN",9.8,"NM",1,0)
MDRPCOT1^^0^B62839525
"BLD",21621,"KRN",9.8,"NM",2,0)
MDHL7BH^^0^B27805892
"BLD",21621,"KRN",9.8,"NM","B","MDHL7BH",2)

"BLD",21621,"KRN",9.8,"NM","B","MDRPCOT1",1)

"BLD",21621,"KRN",19,0)
19
"BLD",21621,"KRN",19,"NM",0)
^9.68A^5^5
"BLD",21621,"KRN",19,"NM",1,0)
MD CARTCL^^0
"BLD",21621,"KRN",19,"NM",2,0)
MD COORDINATOR^^0
"BLD",21621,"KRN",19,"NM",3,0)
MD DICOM^^0
"BLD",21621,"KRN",19,"NM",4,0)
MD AUTO CHECK-IN SETUP^^4^
"BLD",21621,"KRN",19,"NM",5,0)
MD HIGH VOLUME PROCEDURE SETUP^^4^
"BLD",21621,"KRN",19,"NM","B","MD AUTO CHECK-IN SETUP",4)

"BLD",21621,"KRN",19,"NM","B","MD CARTCL",1)

"BLD",21621,"KRN",19,"NM","B","MD COORDINATOR",2)

"BLD",21621,"KRN",19,"NM","B","MD DICOM",3)

"BLD",21621,"KRN",19,"NM","B","MD HIGH VOLUME PROCEDURE SETUP",5)

"BLD",21621,"KRN",19.1,0)
19.1
"BLD",21621,"KRN",101,0)
101
"BLD",21621,"KRN",409.61,0)
409.61
"BLD",21621,"KRN",771,0)
771
"BLD",21621,"KRN",779.2,0)
779.2
"BLD",21621,"KRN",870,0)
870
"BLD",21621,"KRN",8989.51,0)
8989.51
"BLD",21621,"KRN",8989.52,0)
8989.52
"BLD",21621,"KRN",8994,0)
8994
"BLD",21621,"KRN","B",.4,.4)

"BLD",21621,"KRN","B",.401,.401)

"BLD",21621,"KRN","B",.402,.402)

"BLD",21621,"KRN","B",.403,.403)

"BLD",21621,"KRN","B",.5,.5)

"BLD",21621,"KRN","B",.84,.84)

"BLD",21621,"KRN","B",3.6,3.6)

"BLD",21621,"KRN","B",3.8,3.8)

"BLD",21621,"KRN","B",9.2,9.2)

"BLD",21621,"KRN","B",9.8,9.8)

"BLD",21621,"KRN","B",19,19)

"BLD",21621,"KRN","B",19.1,19.1)

"BLD",21621,"KRN","B",101,101)

"BLD",21621,"KRN","B",409.61,409.61)

"BLD",21621,"KRN","B",771,771)

"BLD",21621,"KRN","B",779.2,779.2)

"BLD",21621,"KRN","B",870,870)

"BLD",21621,"KRN","B",8989.51,8989.51)

"BLD",21621,"KRN","B",8989.52,8989.52)

"BLD",21621,"KRN","B",8994,8994)

"BLD",21621,"PRE")

"BLD",21621,"QUES",0)
^9.62^^
"BLD",21621,"REQB",0)
^9.611^3^3
"BLD",21621,"REQB",1,0)
MD*1.0*20^2
"BLD",21621,"REQB",2,0)
MD*1.0*41^2
"BLD",21621,"REQB",3,0)
MAG*3.0*208^2
"BLD",21621,"REQB","B","MAG*3.0*208",3)

"BLD",21621,"REQB","B","MD*1.0*20",1)

"BLD",21621,"REQB","B","MD*1.0*41",2)

"FIA",702.09)
CP INSTRUMENT
"FIA",702.09,0)
^MDS(702.09,
"FIA",702.09,0,0)
702.09I
"FIA",702.09,0,1)
y^y^p^^^^n^^n
"FIA",702.09,0,10)

"FIA",702.09,0,11)

"FIA",702.09,0,"RLRO")

"FIA",702.09,0,"VR")
1.0^MD
"FIA",702.09,702.09)
1
"FIA",702.09,702.09,.19)

"KRN",19,12780,-1)
4^4
"KRN",19,12780,0)
MD AUTO CHECK-IN SETUP
"KRN",19,12917,-1)
4^5
"KRN",19,12917,0)
MD HIGH VOLUME PROCEDURE SETUP
"KRN",19,13857,-1)
0^3
"KRN",19,13857,0)
MD DICOM^CP - DICOM Interoperability^^E^^^^^^^^CLINICAL PROCEDURES
"KRN",19,13857,1,0)
^^17^17^3180530^
"KRN",19,13857,1,1,0)
This option improves interoperability between Clinical Procedures and
"KRN",19,13857,1,2,0)
VistA Imaging CPRS Consult Request Tracking DICOM. There are three
"KRN",19,13857,1,3,0)
capabilities: 
"KRN",19,13857,1,4,0)
 
"KRN",19,13857,1,5,0)
First, the VistA Imaging consult accession number sss-GMR-nnnnnnnn can be
"KRN",19,13857,1,6,0)
used for the Clinical Procedures Instrument Order Number.    
"KRN",19,13857,1,7,0)
 
"KRN",19,13857,1,8,0)
Second, the timing of the DICOM Modality Worklist creation is changed from
"KRN",19,13857,1,9,0)
order release to check-in, making it much more useful.   
"KRN",19,13857,1,10,0)
 
"KRN",19,13857,1,11,0)
Third, the VistA Imaging HL7 message body can be used instead of the CP
"KRN",19,13857,1,12,0)
HL7 message body. (The VistA Imaging HL7 has much more information than
"KRN",19,13857,1,13,0)
the CP HL7.) 
"KRN",19,13857,1,14,0)
 
"KRN",19,13857,1,15,0)
Note: This is for bidirectional CP instruments only. Also, the CP must
"KRN",19,13857,1,16,0)
have an entry in the CLINICAL SPECIALTY DICOM & HL7 file (#2006.5831) to
"KRN",19,13857,1,17,0)
have DICOM Modality Worklist and HL7.
"KRN",19,13857,30)
MDS(702.09,
"KRN",19,13857,31)
AEQM
"KRN",19,13857,50)
MDS(702.09,
"KRN",19,13857,51)
.19
"KRN",19,13857,"U")
CP - DICOM INTEROPERABILITY
"KRN",19,13858,-1)
0^1
"KRN",19,13858,0)
MD CARTCL^Keep Consult Open for CART-CL^^E^^^^^^^^CLINICAL PROCEDURES
"KRN",19,13858,1,0)
^^20^20^3180530^
"KRN",19,13858,1,1,0)
This Clinical Procedures Uni-directional Configuration flag 'CONSULT KEEP 
"KRN",19,13858,1,2,0)
OPEN' provides the following functionality:
"KRN",19,13858,1,3,0)
 
"KRN",19,13858,1,4,0)
The CP procedure is automatically placed in Completed status
"KRN",19,13858,1,5,0)
after the HL7 message is sent, thus preventing an "inbound" HL7 message
"KRN",19,13858,1,6,0)
containing the test results from being sent back to the CPRS Consult
"KRN",19,13858,1,7,0)
Note.
"KRN",19,13858,1,8,0)
 
"KRN",19,13858,1,9,0)
The physician can then edit the Consult Note by manually pasting in data
"KRN",19,13858,1,10,0)
from a test result reporting system to complete the Consult.
"KRN",19,13858,1,11,0)
 
"KRN",19,13858,1,12,0)
This modification is beneficial for users of reporting systems-such as
"KRN",19,13858,1,13,0)
the Clinical Assessment, Reporting, and Tracking System for Cardiac
"KRN",19,13858,1,14,0)
Catheterization Laboratories (CART-CL) application-who do not want the
"KRN",19,13858,1,15,0)
test results from the medical instrument to populate the CPRS Consult
"KRN",19,13858,1,16,0)
Note, but prefer to manually paste the test results from the reporting
"KRN",19,13858,1,17,0)
system into the Consult Note.
"KRN",19,13858,1,18,0)
 
"KRN",19,13858,1,19,0)
The 'CONSULT KEEP OPEN' flag must be set to Yes for this functionality 
"KRN",19,13858,1,20,0)
to work.
"KRN",19,13858,30)
MDS(702.09,
"KRN",19,13858,31)
AEQM
"KRN",19,13858,50)
MDS(702.09,
"KRN",19,13858,51)
.401
"KRN",19,13858,"U")
KEEP CONSULT OPEN FOR CART-CL
"KRN",19,13859,-1)
0^2
"KRN",19,13859,0)
MD COORDINATOR^CP Coordinator Menu^^M^^^^^^^^CLINICAL PROCEDURES
"KRN",19,13859,1,0)
^^2^2^3180530^
"KRN",19,13859,1,1,0)
This is the menu for the person that is the ADPAC for Clinical Procedures.
"KRN",19,13859,1,2,0)
It includes all of the user interface options.
"KRN",19,13859,10,0)
^19.01IP^4^4
"KRN",19,13859,10,1,0)
12780
"KRN",19,13859,10,1,"^")
MD AUTO CHECK-IN SETUP
"KRN",19,13859,10,2,0)
12917
"KRN",19,13859,10,2,"^")
MD HIGH VOLUME PROCEDURE SETUP
"KRN",19,13859,10,3,0)
13857
"KRN",19,13859,10,3,"^")
MD DICOM
"KRN",19,13859,10,4,0)
13858
"KRN",19,13859,10,4,"^")
MD CARTCL
"KRN",19,13859,99)
64834,35690
"KRN",19,13859,"U")
CP COORDINATOR MENU
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",412,-1)
1^1
"PKG",412,0)
CLINICAL PROCEDURES^MD^Clinical Procedures
"PKG",412,20,0)
^9.402P^^
"PKG",412,22,0)
^9.49I^1^1
"PKG",412,22,1,0)
1.0^3070222^3090506^4558
"PKG",412,22,1,"PAH",1,0)
60^3180719^1866
"PKG",412,22,1,"PAH",1,1,0)
^^15^15^3180719
"PKG",412,22,1,"PAH",1,1,1,0)
Clinical Procedures and DICOM Consult Request Tracking.
"PKG",412,22,1,"PAH",1,1,2,0)
 
"PKG",412,22,1,"PAH",1,1,3,0)
This patch and MAG*3.0*208 work together to greatly imnprove 
"PKG",412,22,1,"PAH",1,1,4,0)
interoperability between Clinical Procedures and Vist Imaging
"PKG",412,22,1,"PAH",1,1,5,0)
CPRS Consult Request Tracking DICOM.
"PKG",412,22,1,"PAH",1,1,6,0)
 
"PKG",412,22,1,"PAH",1,1,7,0)
The CP studies have the same Instrument Order Number as the
"PKG",412,22,1,"PAH",1,1,8,0)
regular consult and procedure Accession Number (sss-GMR-nnnnnnnn).
"PKG",412,22,1,"PAH",1,1,9,0)
 
"PKG",412,22,1,"PAH",1,1,10,0)
This allows DICOM objects created during a CP examination to be sent
"PKG",412,22,1,"PAH",1,1,11,0)
to VistA Imaging and be processed automatically.  It also allows them
"PKG",412,22,1,"PAH",1,1,12,0)
to be used with all of the other DICOM services, like query/retrieve
"PKG",412,22,1,"PAH",1,1,13,0)
and export.
"PKG",412,22,1,"PAH",1,1,14,0)
 
"PKG",412,22,1,"PAH",1,1,15,0)
Reports in DICOM Encapsulated PDF are highly recommended.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","MDHL7BH")
0^2^B27805892^B22948615
"RTN","MDHL7BH",1,0)
MDHL7BH ; HOIFO/WAA,WOIFO/PMK -Bi-directional interface (HL7) routine ;15 Jun 2018 12:46 PM
"RTN","MDHL7BH",2,0)
 ;;1.0;CLINICAL PROCEDURES;**11,21,20,60**;Apr 01, 2004;Build 1
"RTN","MDHL7BH",3,0)
 ;
"RTN","MDHL7BH",4,0)
 ; This routine will build the HL7 Message and store that message.
"RTN","MDHL7BH",5,0)
 ; After the message has been created then it will call the
"RTN","MDHL7BH",6,0)
 ; The actual HL7package to start the processing of the message
"RTN","MDHL7BH",7,0)
 ;
"RTN","MDHL7BH",8,0)
 ; Reference DBIA #2056 [Supported] reference $$GET1^DIQ function call
"RTN","MDHL7BH",9,0)
 ; Reference DBIA #2161 [Supported] call to INIT^HLFCN2
"RTN","MDHL7BH",10,0)
 ; Reference DBIA #2164 [Supported] call to GENERATE^HLMA
"RTN","MDHL7BH",11,0)
 ; Reference DBIA #6932 [Private] call to CLINPROC^MAGDHLWP
"RTN","MDHL7BH",12,0)
 ; Reference DBIA #10061 [Supported] call to ADD^VADPT
"RTN","MDHL7BH",13,0)
 ; Reference DBIA #10103 [Supported] calls to $$NOW^XLFDT
"RTN","MDHL7BH",14,0)
 ; Reference DBIA #3062 [Supported] calls to $$HLNAME^XLFNAME
"RTN","MDHL7BH",15,0)
 ; Reference DBIA #2263 [Supported] calls to $$GET^XPAR
"RTN","MDHL7BH",16,0)
 ; Reference DBIA #3067 [Private] Read Consult Data with FM call.
"RTN","MDHL7BH",17,0)
 ; Reference DBIA #10035[Supported] Patient File Access
"RTN","MDHL7BH",18,0)
 ; Reference DBIA #10040[Supported] Access ^SC
"RTN","MDHL7BH",19,0)
 ; Reference DBIA #10056[Supported] Direct read STATE (5)
"RTN","MDHL7BH",20,0)
 Q
"RTN","MDHL7BH",21,0)
EN1 ;Main Entry point.
"RTN","MDHL7BH",22,0)
 N MDMSG,MD101,CNT,HLA,LINE,MDHL,DFN,MDLINK
"RTN","MDHL7BH",23,0)
 Q:RESULT<1  ; This tells the study is not a BDi
"RTN","MDHL7BH",24,0)
 S MDLINK=$$GET1^DIQ(702.09,DEVIEN,.18,"E")
"RTN","MDHL7BH",25,0)
 I MDLINK="" S RESULT=-1,MSG="No HL Logical Link has been defined." Q  ; No link has been defined
"RTN","MDHL7BH",26,0)
 S MDERROR="0"
"RTN","MDHL7BH",27,0)
 D INIT^HLFNC2("MCAR ORM SERVER",.MDMSG)
"RTN","MDHL7BH",28,0)
 I +$G(MDMSG)>0 S RESULT=-1,MSG="Unable to produce a message." Q  ; something is wrong and no MSH was created
"RTN","MDHL7BH",29,0)
 S DFN=$$GET1^DIQ(702,MDD702,.01,"I")
"RTN","MDHL7BH",30,0)
 S DEVNAME=$$GET1^DIQ(702.09,DEVIEN,.16,"I")
"RTN","MDHL7BH",31,0)
 S CNT=0
"RTN","MDHL7BH",32,0)
 D PID S CNT=CNT+1,HLA("HLS",CNT)=LINE
"RTN","MDHL7BH",33,0)
 D PV1 S CNT=CNT+1,HLA("HLS",CNT)=LINE
"RTN","MDHL7BH",34,0)
 D ORC S CNT=CNT+1,HLA("HLS",CNT)=LINE
"RTN","MDHL7BH",35,0)
 D OBR I LINE'="" S CNT=CNT+1,HLA("HLS",CNT)=LINE
"RTN","MDHL7BH",36,0)
 S HLP("SUBSCRIBER")="^^VISTA^^"_DEVNAME_"^M"
"RTN","MDHL7BH",37,0)
 S HLL("LINKS",1)="MCAR ORM CLIENT"_"^"_MDLINK
"RTN","MDHL7BH",38,0)
 ;
"RTN","MDHL7BH",39,0)
 ; MD*1.0*60 - 16 April 2018 - Peter Kuzmak, VistA Imaging
"RTN","MDHL7BH",40,0)
 ; VistA Imaging code to generate CPRS Consult Request Tracking
"RTN","MDHL7BH",41,0)
 ; HL7 message for the DICOM Text Gateway to put the CP study
"RTN","MDHL7BH",42,0)
 ; on the DICOM Modality Worklist.  This usually happens when
"RTN","MDHL7BH",43,0)
 ; the study is ordered, but is deferred for CP to check-in time.
"RTN","MDHL7BH",44,0)
 ; 
"RTN","MDHL7BH",45,0)
 ; This considerably improves interoperability between Clinical Procedure
"RTN","MDHL7BH",46,0)
 ; and VistA Imaging CPRS Consult Request Tracking DICOM.
"RTN","MDHL7BH",47,0)
 ; 
"RTN","MDHL7BH",48,0)
 ; If the CP - DICOM INTEROPERABILITY (field #.19) of the CP Instrument
"RTN","MDHL7BH",49,0)
 ; file (#702.09) is set to 2, then the VistA Imaging HL7 will replace
"RTN","MDHL7BH",50,0)
 ; the just-created CP HL7 in HLA("HLS"). The benefit for this is the
"RTN","MDHL7BH",51,0)
 ; VistA Imaging HL7 has much more data than does the CP HL7.  The VistA
"RTN","MDHL7BH",52,0)
 ; Imaging HL7 would be transmitted to the instrument identically the same
"RTN","MDHL7BH",53,0)
 ; as the CP HL7, using the 1.6 HL7 package software (i.e., not HLO).
"RTN","MDHL7BH",54,0)
 ; 
"RTN","MDHL7BH",55,0)
 I $T(CLINPROC^MAGDHOWP)'="" D CLINPROC^MAGDHOWP(MDD702,MDORFLG) ; invoke VistA Imaging to generate HL7
"RTN","MDHL7BH",56,0)
 ;
"RTN","MDHL7BH",57,0)
 D GENERATE^HLMA("MCAR ORM SERVER","LM",1,.MDHL,,.HLP)
"RTN","MDHL7BH",58,0)
 I $P(MDHL,U,2) S MDERROR=MDHL
"RTN","MDHL7BH",59,0)
 Q
"RTN","MDHL7BH",60,0)
OBR ; Send the procedure to the correct device
"RTN","MDHL7BH",61,0)
 S LINE="OBR|"
"RTN","MDHL7BH",62,0)
 S DEVIEN=$$GET1^DIQ(702,MDD702,.11,"I")
"RTN","MDHL7BH",63,0)
 S USC=$$GET1^DIQ(702.09,DEVIEN,.17,"I")
"RTN","MDHL7BH",64,0)
 I USC="" S LINE="" Q
"RTN","MDHL7BH",65,0)
 E  S USC=$TR(USC,"=","^")
"RTN","MDHL7BH",66,0)
 S $P(LINE,"|",5)=USC_"|"
"RTN","MDHL7BH",67,0)
 Q
"RTN","MDHL7BH",68,0)
PID ;get the patient information and build the PID
"RTN","MDHL7BH",69,0)
 ;PID|||SSN||Last^First||DOB|SEX|||||||||||SSN
"RTN","MDHL7BH",70,0)
 N MDSSN,NAME,DOB,ADDR,TMP,MDADD,VAPA,VAERR,VAROOT,MDPCOD
"RTN","MDHL7BH",71,0)
 S LINE="PID|",$P(LINE,"|",21)=""
"RTN","MDHL7BH",72,0)
 S MDSSN=$$GET1^DIQ(702,MDD702,.011) ; Get the ssn for the patient
"RTN","MDHL7BH",73,0)
 S NAME=$$GET1^DIQ(702,MDD702,.01,"E") ; get the patient name
"RTN","MDHL7BH",74,0)
 S NAME=$$HLNAME^XLFNAME($P(NAME,"^"),"",$E(HLECH,1))
"RTN","MDHL7BH",75,0)
 I $P(NAME,$E(HLECH,1),7)'="L" S $P(NAME,$E(HLECH,1),7)="L"
"RTN","MDHL7BH",76,0)
 S DOB=$$GET1^DIQ(2,DFN,.03,"I") S DOB=$$FTOHL7^MDHL7U2(DOB)
"RTN","MDHL7BH",77,0)
 S VAROOT="MDADD" D ADD^VADPT
"RTN","MDHL7BH",78,0)
 S ADDR=$G(MDADD(1))_"^" ; Address 1
"RTN","MDHL7BH",79,0)
 S TMP=$G(MDADD(2)) I TMP'="" S ADDR=ADDR_TMP ; Add 2
"RTN","MDHL7BH",80,0)
 S TMP=$G(MDADD(3)) I TMP'="" S ADDR=ADDR_" "_TMP ; Add 3
"RTN","MDHL7BH",81,0)
 S ADDR=ADDR_"^"_$G(MDADD(4)) ; City
"RTN","MDHL7BH",82,0)
 S MDPCOD=$P($G(MDADD(5)),"^",1) I MDPCOD'="" S MDPCOD=$P($G(^DIC(5,MDPCOD,0)),"^",2)
"RTN","MDHL7BH",83,0)
 ; ^^^^^^ Setting MDPCODE to Postal code Via direct supported lookup.
"RTN","MDHL7BH",84,0)
 S ADDR=ADDR_"^"_MDPCOD ; State Postal Code
"RTN","MDHL7BH",85,0)
 S ADDR=ADDR_"^"_$G(MDADD(6)) ; Zip
"RTN","MDHL7BH",86,0)
 K MDADD
"RTN","MDHL7BH",87,0)
 S $P(LINE,"|",2)="1"
"RTN","MDHL7BH",88,0)
 S $P(LINE,"|",4)=MDSSN
"RTN","MDHL7BH",89,0)
 S $P(LINE,"|",6)=NAME
"RTN","MDHL7BH",90,0)
 S $P(LINE,"|",8)=DOB
"RTN","MDHL7BH",91,0)
 S $P(LINE,"|",9)=$$GET1^DIQ(2,DFN,.02,"I")
"RTN","MDHL7BH",92,0)
 S $P(LINE,"|",12)=ADDR
"RTN","MDHL7BH",93,0)
 S $P(LINE,"|",20)=MDSSN
"RTN","MDHL7BH",94,0)
 Q
"RTN","MDHL7BH",95,0)
PV1 ;Get the ward location for PV1
"RTN","MDHL7BH",96,0)
 ;PV1||In or out|Ward location
"RTN","MDHL7BH",97,0)
 N CWARD,WARD,INOUT,CONSULT,REF,NREF,WARD1,WARD2,MDPR1,MDPNAM,MDSV
"RTN","MDHL7BH",98,0)
 S WARD=$$GET1^DIQ(2,DFN,.1,"E"),(WARD1,WARD2)=""
"RTN","MDHL7BH",99,0)
 S INOUT=$S(WARD'="":"I",1:"O")
"RTN","MDHL7BH",100,0)
 S:WARD'="" WARD=WARD_U_WARD
"RTN","MDHL7BH",101,0)
 S CONSULT=$$GET123^MDHL7U2(MDD702)
"RTN","MDHL7BH",102,0)
 S CWARD=$P($G(^MDD(702,+MDD702,0)),U,7),CWARD=$P(CWARD,";",3)
"RTN","MDHL7BH",103,0)
 S:+CWARD WARD2=$$GET1^DIQ(44,+CWARD_",",.01,"E")
"RTN","MDHL7BH",104,0)
 S MDPR1=$$GET1^DIQ(702,+MDD702_",",.04,"I")
"RTN","MDHL7BH",105,0)
 S:+MDPR1 WARD1=$$GET1^DIQ(702.01,+MDPR1_",",.05,"E")
"RTN","MDHL7BH",106,0)
 S MDPNAM=$$GET1^DIQ(702.09,DEVIEN,.06,"I")
"RTN","MDHL7BH",107,0)
 I INOUT="O" D
"RTN","MDHL7BH",108,0)
 .;S WARD=WARD1 S:WARD="" WARD=WARD2
"RTN","MDHL7BH",109,0)
 .S WARD=WARD2 S:WARD="" WARD=WARD1
"RTN","MDHL7BH",110,0)
 .I WARD="" S WARD=$$GET1^DIQ(123,CONSULT_",",.04,"E"),MDSV="A;"_$$NOW^XLFDT()_";"_$$GET1^DIQ(123,CONSULT_",",.04,"I"),$P(^MDD(702,+MDD702,0),U,7)=MDSV
"RTN","MDHL7BH",111,0)
 .I MDPNAM["Olympus" D
"RTN","MDHL7BH",112,0)
 ..S WARD1=$O(^SC("B",WARD,0)),CWARD=$P($G(^SC(+WARD1,0)),U,2)
"RTN","MDHL7BH",113,0)
 ..S WARD=$S(+$$GET^XPAR("SYS","MD OLYMPUS 7",1)>0:$E(WARD,1,7),1:$E(WARD,1,4))_"^"_CWARD
"RTN","MDHL7BH",114,0)
 I INOUT="I" D
"RTN","MDHL7BH",115,0)
 .S:WARD="" WARD=WARD2 S:WARD="" WARD=WARD1
"RTN","MDHL7BH",116,0)
 .S:WARD="" WARD=$$GET1^DIQ(123,CONSULT_",",.04,"E")
"RTN","MDHL7BH",117,0)
 .S WARD=WARD_"^"_$S($G(^DPT(2,.101))'="":$G(^DPT(2,.101)),1:"") Q
"RTN","MDHL7BH",118,0)
 ;V--- NEW CODE THis code is
"RTN","MDHL7BH",119,0)
 I $P($P(^MDD(702,+MDD702,0),U,7),";",3)="" D
"RTN","MDHL7BH",120,0)
 . I +MDPR1 Q:+$$GET1^DIQ(702.01,+MDPR1_",",.05,"I")
"RTN","MDHL7BH",121,0)
 . S MDSV="A;"_$$NOW^XLFDT()_";"_$$GET1^DIQ(123,CONSULT_",",.04,"I"),$P(^MDD(702,+MDD702,0),U,7)=MDSV
"RTN","MDHL7BH",122,0)
 . Q
"RTN","MDHL7BH",123,0)
 ;^--- NEW CODE
"RTN","MDHL7BH",124,0)
 S LINE="PV1||"_INOUT_"|"_WARD
"RTN","MDHL7BH",125,0)
 Q:CONSULT<1
"RTN","MDHL7BH",126,0)
 S NREF=$$GETREF^MDHL7U2(CONSULT) Q:NREF="-1"
"RTN","MDHL7BH",127,0)
 S $P(LINE,"|",9)=NREF
"RTN","MDHL7BH",128,0)
 Q
"RTN","MDHL7BH",129,0)
ORC ;get ORC onformation
"RTN","MDHL7BH",130,0)
 ;ORC|NA|Order Number|||||||date/time ordered
"RTN","MDHL7BH",131,0)
 N DATE,SDATE
"RTN","MDHL7BH",132,0)
 S DATE=$$GET1^DIQ(702,MDD702,.02,"I")
"RTN","MDHL7BH",133,0)
 S DATE=$$FTOHL7^MDHL7U2(DATE)
"RTN","MDHL7BH",134,0)
 S SDATE=$$GET1^DIQ(702,MDD702,.07,"I")
"RTN","MDHL7BH",135,0)
 I SDATE[";" S SDATE=$P(SDATE,";",2)
"RTN","MDHL7BH",136,0)
 I SDATE="" D NOW^%DTC S SDATE=% S $P(^MDD(702,MDD702,0),"^",7)=SDATE
"RTN","MDHL7BH",137,0)
 I SDATE<DT D NOW^%DTC S SDATE=%
"RTN","MDHL7BH",138,0)
 S SDATE=$$FTOHL7^MDHL7U2(SDATE)
"RTN","MDHL7BH",139,0)
 S LINE="ORC|"_$S(MDORFLG=1:"NW",MDORFLG=0:"CA",1:"")_"|"_MDIORD
"RTN","MDHL7BH",140,0)
 S $P(LINE,"|",6)=$S(MDORFLG=1:"NW",MDORFLG=0:"CA",1:"")
"RTN","MDHL7BH",141,0)
 S $P(LINE,"|",10)=DATE,$P(LINE,"|",16)=SDATE
"RTN","MDHL7BH",142,0)
 Q
"RTN","MDRPCOT1")
0^1^B62839525^B44379273
"RTN","MDRPCOT1",1,0)
MDRPCOT1 ; HOIFO/NCA/DP,WOIFO/PMK - Object RPCs (TMDTransaction) - Continued ;03 Jul 2018 9:09 AM
"RTN","MDRPCOT1",2,0)
 ;;1.0;CLINICAL PROCEDURES;**5,11,21,41,60**;Apr 01, 2004;Build 1
"RTN","MDRPCOT1",3,0)
 ; Integration Agreements:
"RTN","MDRPCOT1",4,0)
 ; IA# 2053 [Supported] calls to FILE^DIE
"RTN","MDRPCOT1",5,0)
 ; IA# 10013 [Supported] calls to DIK
"RTN","MDRPCOT1",6,0)
 ; IA# 2056 [Supported] calls to $$GET1^DIQ
"RTN","MDRPCOT1",7,0)
 ; IA# 2056 [Supported] calls to GETS^DIQ
"RTN","MDRPCOT1",8,0)
 ; IA# 3468 [Subscription] $$CPDOC^GMRCCP
"RTN","MDRPCOT1",9,0)
 ; IA# 6931 [Private] call to $$GMRCACN^MAGDFCNV
"RTN","MDRPCOT1",10,0)
 ; IA# 3567 [Subscription] IMPORT^MAGGSIUI
"RTN","MDRPCOT1",11,0)
 ; IA# 10061 [Supported] Calls to IN5^VADPT
"RTN","MDRPCOT1",12,0)
 ; IA# 10103 [Supported] Calls to $$NOW^XLFDT.
"RTN","MDRPCOT1",13,0)
 ; IA# 5844 [Supported] Calls to $$CONVERT^XLFIPV
"RTN","MDRPCOT1",14,0)
 ; IA# 2263 [Supported] calls to $$GET^XPAR and GETLST^XPAR
"RTN","MDRPCOT1",15,0)
 ; IA# 3067 [Private] Reads fields in Consults file (#123).
"RTN","MDRPCOT1",16,0)
 ; IA# 10040 [Supported] Hospital Location File Access
"RTN","MDRPCOT1",17,0)
 ;
"RTN","MDRPCOT1",18,0)
 ; 09/25/15 KAM Remedy Call 1095728  Patch MD*1*41 IPv6 modifications
"RTN","MDRPCOT1",19,0)
 ;
"RTN","MDRPCOT1",20,0)
DELERR(MDTIEN) ; [Procedure] Delete Imaging Error Messages
"RTN","MDRPCOT1",21,0)
 S MDLP=0 F  S MDLP=$O(^MDD(702,MDTIEN,.091,MDLP)) Q:'MDLP  D
"RTN","MDRPCOT1",22,0)
 .K DA,DIK
"RTN","MDRPCOT1",23,0)
 .S DA=+MDLP,DA(1)=+MDTIEN,DIK="^MDD(702,"_DA(1)_",.091," D ^DIK
"RTN","MDRPCOT1",24,0)
 .Q
"RTN","MDRPCOT1",25,0)
 Q
"RTN","MDRPCOT1",26,0)
 ;
"RTN","MDRPCOT1",27,0)
IMGSTAT(STUDY,MDSTAT) ; [Procedure] Update the Image Status.
"RTN","MDRPCOT1",28,0)
 N MDL
"RTN","MDRPCOT1",29,0)
 S MDL=0 F  S MDL=$O(^MDD(702,STUDY,.1,MDL)) Q:MDL<1  S $P(^(MDL,0),"^",9)=MDSTAT
"RTN","MDRPCOT1",30,0)
 Q
"RTN","MDRPCOT1",31,0)
 ;
"RTN","MDRPCOT1",32,0)
GETVSTR(DFN,MDSSTR,MDPR,MDTR) ; [Function] Check the Visit String
"RTN","MDRPCOT1",33,0)
 N MDCLOC,MDHOLD,MDLOC,MDINPT,VAIP
"RTN","MDRPCOT1",34,0)
 N MDPR12,MDAPP ; Patch 11
"RTN","MDRPCOT1",35,0)
 I '$G(MDTR) Q 0
"RTN","MDRPCOT1",36,0)
 I '$G(MDPR) Q 0
"RTN","MDRPCOT1",37,0)
 I $G(MDSSTR)="" Q 0
"RTN","MDRPCOT1",38,0)
 S VAIP("D")=MDTR ; DT of Transaction Created
"RTN","MDRPCOT1",39,0)
 D IN5^VADPT S MDINPT=$S(+VAIP(13):1,1:0)
"RTN","MDRPCOT1",40,0)
 S (MDCLOC,MDHOLD)=$$GET1^DIQ(702.01,+MDPR_",",.05,"I")
"RTN","MDRPCOT1",41,0)
 ; Patch 11
"RTN","MDRPCOT1",42,0)
 S MDPR12=$$GET1^DIQ(702.01,+MDPR_",",.12,"I")
"RTN","MDRPCOT1",43,0)
 S:MDPR12=1 MDCLOC=""
"RTN","MDRPCOT1",44,0)
 S MDAPP=$$GET^XPAR("SYS","MD USE APPOINTMENT",1)
"RTN","MDRPCOT1",45,0)
 ; End Patch 11 code
"RTN","MDRPCOT1",46,0)
 I 'MDCLOC S MDCLOC=+$P(MDSSTR,";",3) I 'MDCLOC S MDCLOC=MDHOLD I 'MDCLOC Q 0
"RTN","MDRPCOT1",47,0)
 I +MDAPP S MDCLOC=$S(+$P(MDSSTR,";",3)>1:+$P(MDSSTR,";",3),1:MDCLOC) I 'MDCLOC Q 0
"RTN","MDRPCOT1",48,0)
 S Y=MDCLOC_";"_$P(MDSSTR,";",2)_";"_$P(MDSSTR,";")
"RTN","MDRPCOT1",49,0)
 I $P(Y,";",3)="A" Q Y
"RTN","MDRPCOT1",50,0)
 S:$P(Y,";",3)="" $P(Y,";",3)="A"
"RTN","MDRPCOT1",51,0)
 S:+MDINPT $P(Y,";",3)="A"
"RTN","MDRPCOT1",52,0)
 S:$P(Y,";",3)="V" $P(Y,";",3)="A"
"RTN","MDRPCOT1",53,0)
 Q Y
"RTN","MDRPCOT1",54,0)
 ;
"RTN","MDRPCOT1",55,0)
PDT(STUDIE) ; [Function] Loop through the attachments for Date/Time Performed.
"RTN","MDRPCOT1",56,0)
 N MDL,MDDT
"RTN","MDRPCOT1",57,0)
 S MDL=0,MDDT=""
"RTN","MDRPCOT1",58,0)
 F  S MDL=$O(^MDD(702,STUDIE,.1,MDL)) Q:'MDL  D  Q:MDDT
"RTN","MDRPCOT1",59,0)
 .S MDDT=$P($G(^MDD(702,STUDIE,.1,MDL,0)),"^",3)
"RTN","MDRPCOT1",60,0)
 I MDDT S MDDT=$P($G(^MDD(703.1,+MDDT,0)),"^",3) ; Get Date/Time Performed
"RTN","MDRPCOT1",61,0)
 ;S:'MDDT MDDT=$$NOW^XLFDT()
"RTN","MDRPCOT1",62,0)
 Q MDDT
"RTN","MDRPCOT1",63,0)
 ;
"RTN","MDRPCOT1",64,0)
SUBMIT(STUDY) ; [Function] Submit all non-pending/uncomplete images in transaction to Imaging
"RTN","MDRPCOT1",65,0)
 N DATA,DEVIEN,MDACQ,MDC,MDCRES,MDCTR,MDLOC,MDAR,MDARR,MDDT,MDFDA,MDDEL,MDIEN,MDIENS,MDIMG,MDL,MDLPB,MDMAG,MDMULT,MDR,MDST,MDX,MDY,MDZ
"RTN","MDRPCOT1",66,0)
 S MDIEN=+STUDY,MDIENS=MDIEN_",",MDLPB=0
"RTN","MDRPCOT1",67,0)
 S DEVIEN=$P(^MDD(702,STUDY,0),U,11)
"RTN","MDRPCOT1",68,0)
 ;
"RTN","MDRPCOT1",69,0)
 ; 09/25/15 KAM Remedy Ticket 1095728 IPv6 modifications
"RTN","MDRPCOT1",70,0)
 ; Changed next line to use API
"RTN","MDRPCOT1",71,0)
 ;S:$$GET1^DIQ(702.09,DEVIEN_",",.14)="127.0.0.1" MDLPB=1
"RTN","MDRPCOT1",72,0)
 S:$$CONVERT^XLFIPV($$GET1^DIQ(702.09,DEVIEN_",",.14))=$$CONVERT^XLFIPV("127.0.0.1") MDLPB=1
"RTN","MDRPCOT1",73,0)
 ;
"RTN","MDRPCOT1",74,0)
 S MDMULT=$$MULT(+MDIEN)
"RTN","MDRPCOT1",75,0)
 S MDST=$$GET1^DIQ(702,MDIEN,.09,"I") ; I 'MDMULT&('MDLPB)&("13"[MDST) Q "-1^Study not in proper status"
"RTN","MDRPCOT1",76,0)
 I MDMULT&(MDST=1) Q "-1^Study not in proper status"
"RTN","MDRPCOT1",77,0)
 I MDMULT&(MDST=3) D STATUS^MDRPCOT(MDIENS,5,"")
"RTN","MDRPCOT1",78,0)
 D DELERR(+MDIEN)
"RTN","MDRPCOT1",79,0)
 I $$GET1^DIQ(702,MDIEN,.01)="" Q "-1^No Entry in file (#702)."
"RTN","MDRPCOT1",80,0)
 D NOW^%DTC S MDDT=%
"RTN","MDRPCOT1",81,0)
 S MDMAG("IDFN")=+$$GET1^DIQ(702,MDIEN,.01,"I")
"RTN","MDRPCOT1",82,0)
 I 'MDMAG("IDFN") Q "-1^No Patient DFN."
"RTN","MDRPCOT1",83,0)
 S MDMAG("PXPKG")=8925
"RTN","MDRPCOT1",84,0)
 S MDMAG("PXIEN")=+$$GET1^DIQ(702,MDIEN,.06,"I")
"RTN","MDRPCOT1",85,0)
 I 'MDMAG("PXIEN") Q "-1^No TIU IEN"
"RTN","MDRPCOT1",86,0)
 I '$O(^MDD(702,MDIEN,.1,0)) D  Q $S(+MDR<0:MDR,1:"3^Transaction Complete")
"RTN","MDRPCOT1",87,0)
 .S MDC=$$GET1^DIQ(702,MDIEN,.05,"I")
"RTN","MDRPCOT1",88,0)
 .S MDR=$$UPDCONS(MDC,MDMAG("PXIEN"))
"RTN","MDRPCOT1",89,0)
 S MDMAG("STSCB")="ISTAT^MDAPI"
"RTN","MDRPCOT1",90,0)
 S MDMAG("TRKID")="CP;"_MDIEN_"-"_MDDT
"RTN","MDRPCOT1",91,0)
 S MDLOC=$$GET1^DIQ(702,MDIEN,.07,"I"),MDLOC=$P(MDLOC,";",3)
"RTN","MDRPCOT1",92,0)
 I 'MDLOC Q "-1^No Hospital Location."
"RTN","MDRPCOT1",93,0)
 S MDMAG("ACQS")=$S(+$$GET1^DIQ(44,MDLOC_",",3,"I"):+$$GET1^DIQ(44,MDLOC_",",3,"I"),1:+$G(DUZ(2)))
"RTN","MDRPCOT1",94,0)
 S MDMAG("ACQL")=MDLOC
"RTN","MDRPCOT1",95,0)
 S MDX=$$GET1^DIQ(702,MDIEN,.04,"I")
"RTN","MDRPCOT1",96,0)
 S MDZ=$P(^MDS(702.01,+MDX,0),"^",1)
"RTN","MDRPCOT1",97,0)
 S (MDACQ,MDX,MDDEL)="",MDCTR=0
"RTN","MDRPCOT1",98,0)
 N MDTOT S MDTOT=$$GET1^DIQ(702,MDIENS,.991)
"RTN","MDRPCOT1",99,0)
 S MDL=0 F  S MDL=$O(^MDD(702,MDIEN,.1,MDL)) Q:MDL<1  S MDX=$G(^(MDL,0)) D
"RTN","MDRPCOT1",100,0)
 .S:'MDDEL MDDEL=$P(MDX,"^",3)
"RTN","MDRPCOT1",101,0)
 .S MDY=$G(^MDD(702,MDIEN,.1,MDL,.1)) Q:MDY=""
"RTN","MDRPCOT1",102,0)
 .S:MDACQ="" MDACQ=$P($P(MDY,"\\",2),"\")
"RTN","MDRPCOT1",103,0)
 .S:"12"[$P(MDX,"^",9) $P(MDX,"^",9)=""
"RTN","MDRPCOT1",104,0)
 .I $P(MDX,"^",9)="" S MDCTR=MDCTR+1,MDARR(MDCTR)=MDY_"^"_MDZ_" image "_MDCTR_" out of "_MDTOT
"RTN","MDRPCOT1",105,0)
 .Q
"RTN","MDRPCOT1",106,0)
 I '$O(MDARR(0)) Q "-1^No UNC."
"RTN","MDRPCOT1",107,0)
 S MDMAG("GDESC")=MDZ_" Result"
"RTN","MDRPCOT1",108,0)
 I MDDEL S MDY=$P($G(^MDD(703.1,+MDDEL,0)),"^",3,4),MDMAG("PXDT")=$P(MDY,"^",1),MDY=+$P(MDY,"^",2),MDMAG("ACQD")=$P($G(^MDS(702.09,+MDY,0)),"^"),MDMAG("DFLG")=+$P($G(^MDS(702.09,+MDY,0)),"^",5)
"RTN","MDRPCOT1",109,0)
 S:$G(MDMAG("ACQD"))="" MDMAG("ACQD")=MDACQ
"RTN","MDRPCOT1",110,0)
 S:'$G(MDMAG("PXDT")) MDMAG("PXDT")=MDDT ; If no date, use NOW in MDDT
"RTN","MDRPCOT1",111,0)
 S MDMAG("TRTYPE")="NEW"
"RTN","MDRPCOT1",112,0)
 D IMPORT^MAGGSIUI(.MDIMG,.MDARR,.MDMAG)
"RTN","MDRPCOT1",113,0)
 I '(+$G(MDIMG(0))) D  Q "-1^"_$P(MDIMG(0),"^",2)
"RTN","MDRPCOT1",114,0)
 .D IMGSTAT(+MDIENS,1)
"RTN","MDRPCOT1",115,0)
 .F MDAR=0:0 S MDAR=$O(MDIMG(MDAR)) Q:'MDAR  I $G(MDIMG(MDAR))'="" D
"RTN","MDRPCOT1",116,0)
 ..S DATA("MESSAGE")=$$TRANS^MDAPI(MDIMG(MDAR)) D ADDMSG^MDRPCOT
"RTN","MDRPCOT1",117,0)
 D IMGSTAT(+MDIENS,0)
"RTN","MDRPCOT1",118,0)
 Q "1^Images Submitted"
"RTN","MDRPCOT1",119,0)
 ;
"RTN","MDRPCOT1",120,0)
UPDCONS(MDC,MDDOC) ; [Function] Update Consults Procedure Status
"RTN","MDRPCOT1",121,0)
 N MDCRES,MDKK,MDSDY,MDPDEF,MDF,MDH,MDX3,MDX4,MDXC,MDXD S (MDF,MDXD)=0,MDX4=""
"RTN","MDRPCOT1",122,0)
 D GETLST^XPAR(.MDH,"SYS","MD GET HIGH VOLUME")
"RTN","MDRPCOT1",123,0)
 S MDSDY=$O(^MDD(702,"ACON",MDC,""),-1) Q:'+MDSDY 1
"RTN","MDRPCOT1",124,0)
 S MDPDEF=+$P($G(^MDD(702,+MDSDY,0)),"^",4) Q:'+MDPDEF 1
"RTN","MDRPCOT1",125,0)
 F MDKK=0:0 S MDKK=$O(MDH(MDKK)) Q:MDKK<1  I $P($G(MDH(MDKK)),"^")=+MDPDEF S MDF=1 Q
"RTN","MDRPCOT1",126,0)
 I $P($G(^MDS(702.01,+MDPDEF,0)),U,6)=2 Q 1
"RTN","MDRPCOT1",127,0)
 D GETS^DIQ(123,MDC_",","50*","I","MDXC")
"RTN","MDRPCOT1",128,0)
 S MDX3="" F  S MDX3=$O(MDXC(123.03,MDX3)) Q:MDX3<1  S MDX4=$G(MDXC(123.03,MDX3,.01,"I")) I MDX4["TIU" S:+MDX4=+$P($G(^MDD(702,+MDSDY,0)),"^",6) MDXD=1 Q
"RTN","MDRPCOT1",129,0)
 I +$P($G(^MDS(702.01,+MDPDEF,0)),U,10)!(+MDF) Q:+MDXD 1
"RTN","MDRPCOT1",130,0)
 S MDCRES=$$CPDOC^GMRCCP(MDC,MDDOC,2)
"RTN","MDRPCOT1",131,0)
 I '(+MDCRES) Q "-1^"_$P(MDCRES,"^",2)
"RTN","MDRPCOT1",132,0)
 Q 1
"RTN","MDRPCOT1",133,0)
 ;
"RTN","MDRPCOT1",134,0)
GETIORD(MDIEN) ; [Function] Return the Instrument order number for this study
"RTN","MDRPCOT1",135,0)
 ; Called from instrument interface routines
"RTN","MDRPCOT1",136,0)
 Q:'$D(^MDD(702,MDIEN,0))#2 -1  ; No such study
"RTN","MDRPCOT1",137,0)
 Q:'$P(^MDD(702,MDIEN,0),U,12) $$NEWIORD(MDIEN)  ; Create a new one
"RTN","MDRPCOT1",138,0)
 Q $P(^MDD(702,MDIEN,0),U,12)  ; Return the existing one
"RTN","MDRPCOT1",139,0)
 ;
"RTN","MDRPCOT1",140,0)
NEWIORD(MDIEN) ; [Function] Generate & return new unique instrument order number
"RTN","MDRPCOT1",141,0)
 ; Notice: will overwrite existing order number if it exists
"RTN","MDRPCOT1",142,0)
 N MDFDA
"RTN","MDRPCOT1",143,0)
 Q:'$D(^MDD(702,MDIEN,0))#2 -1  ; No such study
"RTN","MDRPCOT1",144,0)
 L +^MDD(702,"AION"):15 E  Q -1  ; Unable to lock and guarantee uniqueness
"RTN","MDRPCOT1",145,0)
 F  D  Q:'$D(^MDD(702,"AION",X))  H 1  ; Loop until unique
"RTN","MDRPCOT1",146,0)
 . S X=$$NOW^XLFDT() ; Current DateTime
"RTN","MDRPCOT1",147,0)
 . S X=$TR($J(X,14,6),".","") ; Pad with 0's and strip the decimal
"RTN","MDRPCOT1",148,0)
 . Q
"RTN","MDRPCOT1",149,0)
 I $E($G(^MDS(702.09,DEVIEN,0)),1,4)="Muse" D
"RTN","MDRPCOT1",150,0)
 . ; Due to current limitation to the Muse can only except 9
"RTN","MDRPCOT1",151,0)
 . S X=$E($TR($H,",",""),2,10) ; Using $E($H) only for the MUSE
"RTN","MDRPCOT1",152,0)
 . I '$D(^MDD(702,"AION",X)) Q  ; It is unique and quit
"RTN","MDRPCOT1",153,0)
 . N I,FLG ; Not unique
"RTN","MDRPCOT1",154,0)
 . S FLG=0
"RTN","MDRPCOT1",155,0)
 . F I=1:1 D  Q:FLG
"RTN","MDRPCOT1",156,0)
 . . S X=X+1
"RTN","MDRPCOT1",157,0)
 . . I '$D(^MDD(702,"AION",X)) S FLG=1
"RTN","MDRPCOT1",158,0)
 . . Q
"RTN","MDRPCOT1",159,0)
 . Q
"RTN","MDRPCOT1",160,0)
 S MDFDA(702,MDIEN_",",.12)=X  ; Build FDA
"RTN","MDRPCOT1",161,0)
 D FILE^DIE("","MDFDA")  ; File it
"RTN","MDRPCOT1",162,0)
 L -(^MDD(702,"AION"))  ; Unlock it
"RTN","MDRPCOT1",163,0)
 ;
"RTN","MDRPCOT1",164,0)
 ; MD*1.0*60 - 25 April 2018 - Peter Kuzmak, VistA Imaging
"RTN","MDRPCOT1",165,0)
 ; VistA Imaging code to replace the CP Instrument Order Number
"RTN","MDRPCOT1",166,0)
 ; with the VistA Imaging consult Accession Number.
"RTN","MDRPCOT1",167,0)
 ; 
"RTN","MDRPCOT1",168,0)
 ; This greatly improves interoperability between Clinical Procedure
"RTN","MDRPCOT1",169,0)
 ; and VistA Imaging CPRS Consult Request Tracking DICOM because
"RTN","MDRPCOT1",170,0)
 ; it allows DICOM objects created during a Clinical Procedure
"RTN","MDRPCOT1",171,0)
 ; examination to be automatically associated in VistA.
"RTN","MDRPCOT1",172,0)
 ;
"RTN","MDRPCOT1",173,0)
 N MDS70209,MDFDA,MDGMRCIEN,MDIORD,MDCPDICOM
"RTN","MDRPCOT1",174,0)
 S MDS70209=$$GET1^DIQ(702,MDD702,.11,"I") ; get instrument
"RTN","MDRPCOT1",175,0)
 S MDCPDICOM=$$GET1^DIQ(702.09,MDS70209,.19,"I") ; get CP - DICOM Interoperability
"RTN","MDRPCOT1",176,0)
 I MDCPDICOM D  ; replace CP's accession number with VistA's
"RTN","MDRPCOT1",177,0)
 . S MDGMRCIEN=$P(^MDD(702,MDIEN,0),U,5) ; consult number
"RTN","MDRPCOT1",178,0)
 . S MDIORD=$$GMRCACN^MAGDFCNV(MDGMRCIEN) ; VI accession number
"RTN","MDRPCOT1",179,0)
 . S MDFDA(702,MDIEN_",",.12)=MDIORD  ; Build FDA
"RTN","MDRPCOT1",180,0)
 . D FILE^DIE("","MDFDA")  ; File it
"RTN","MDRPCOT1",181,0)
 . Q
"RTN","MDRPCOT1",182,0)
 ;
"RTN","MDRPCOT1",183,0)
 Q $P(^MDD(702,MDIEN,0),U,12)  ; Return it from the file
"RTN","MDRPCOT1",184,0)
 ;
"RTN","MDRPCOT1",185,0)
GETSTDY(MDION) ; [Function] Return study from instrument order number
"RTN","MDRPCOT1",186,0)
 ; Called from instrument interface routines
"RTN","MDRPCOT1",187,0)
 Q:'$D(^MDD(702,"AION",MDION)) ""  ; No such order number
"RTN","MDRPCOT1",188,0)
 ;
"RTN","MDRPCOT1",189,0)
 ; KLM/MD*1.0*60 - 27 June 2018
"RTN","MDRPCOT1",190,0)
 ; Return the most recent transaction.  We will look for a pending status on finals,
"RTN","MDRPCOT1",191,0)
 ; and complete status on amendments. Failing that, return the most recent no matter
"RTN","MDRPCOT1",192,0)
 ; what status as CP will check the transaction status later.
"RTN","MDRPCOT1",193,0)
 ; Expected variable X contains the OBR segment
"RTN","MDRPCOT1",194,0)
 ; If DEVIEN is not defined, or not using CP-VI accession number, get ION the old way
"RTN","MDRPCOT1",195,0)
 I '$G(DEVIEN)!($$GET1^DIQ(702.09,DEVIEN,.19,"I")<1) Q $O(^MDD(702,"AION",MDION,""),-1) ; Return the 702 ien
"RTN","MDRPCOT1",196,0)
 ;
"RTN","MDRPCOT1",197,0)
 N MDQ,MDIEN,MDTST,MD25,MDX,MDS
"RTN","MDRPCOT1",198,0)
 S MD25=$P($G(X),"|",26) ; OBR-25 Result status (CP uses F,C,X only)
"RTN","MDRPCOT1",199,0)
 S (MDX,MDS,MDQ)=0
"RTN","MDRPCOT1",200,0)
 S MDIEN="" F  Q:MDQ  S MDIEN=$O(^MDD(702,"AION",MDION,MDIEN),-1) Q:MDIEN=""  D
"RTN","MDRPCOT1",201,0)
 . S MDX=MDX+1 I MDX=1 S MDS=MDIEN ;save off first one
"RTN","MDRPCOT1",202,0)
 . S MDTST=$P($G(^MDD(702,MDIEN,0)),U,9) ; Transaction Status
"RTN","MDRPCOT1",203,0)
 . I MDTST=5,MD25="F" S MDQ=MDIEN ; check if status is 'Pending Instrument Data' for Final
"RTN","MDRPCOT1",204,0)
 . I MDTST=3,MD25="C" S MDQ=MDIEN ; check if status is 'Complete' for Amendment
"RTN","MDRPCOT1",205,0)
 . Q
"RTN","MDRPCOT1",206,0)
 I MDQ=0,MDS S MDQ=MDS
"RTN","MDRPCOT1",207,0)
 Q $S(MDQ>0:MDQ,1:"")
"RTN","MDRPCOT1",208,0)
 ;
"RTN","MDRPCOT1",209,0)
MULT(MDIN) ; [Function] Return whether result is multiple or final
"RTN","MDRPCOT1",210,0)
 N MDDEF
"RTN","MDRPCOT1",211,0)
 S MDDEF=+$$GET1^DIQ(702,MDIN,.04,"I")
"RTN","MDRPCOT1",212,0)
 I 'MDDEF Q 0
"RTN","MDRPCOT1",213,0)
 Q +$$GET1^DIQ(702.01,MDDEF,.12,"I")
"VER")
8.0^22.2
"^DD",702.09,702.09,.19,0)
CP - DICOM INTEROPERABILITY^S^0:No special action;1:Use VistA Imaging accession number sss-GMR-nnnnnnnn;2:Use VistA Imaging HL7 instead of CP's HL7;^.1;9^Q
"^DD",702.09,702.09,.19,3)
Select special VistA Imaging processing
"^DD",702.09,702.09,.19,21,0)
13^.001^13^13^3180606^^^^
"^DD",702.09,702.09,.19,21,1,0)
This option improves interoperability between Clinical Procedures and
"^DD",702.09,702.09,.19,21,2,0)
VistA Imaging CPRS Consult Request Tracking DICOM.
"^DD",702.09,702.09,.19,21,3,0)

"^DD",702.09,702.09,.19,21,4,0)
There are three capabilities:
"^DD",702.09,702.09,.19,21,5,0)
  First, the VistA Imaging consult accession number sss-GMR-nnnnnnnn can be used for the Clinical Procedures Instrument Order Number.
"^DD",702.09,702.09,.19,21,6,0)
   Second, the timing of the DICOM Modality Worklist creation is changed from order release to check-in, making it much more useful.
"^DD",702.09,702.09,.19,21,7,0)
  Third, the VistA Imaging HL7 message body can be used instead of the CP HL7 message body.
"^DD",702.09,702.09,.19,21,8,0)
(The VistA Imaging HL7 has much more information than the CP HL7.)
"^DD",702.09,702.09,.19,21,9,0)
 
"^DD",702.09,702.09,.19,21,10,0)
Note: This is for bidirectional CP instruments only.
"^DD",702.09,702.09,.19,21,11,0)
Also, the CP must have an entry in the CLINICAL SPECIALTY
"^DD",702.09,702.09,.19,21,12,0)
DICOM & HL7 file (#2006.5831) to have DICOM Modality
"^DD",702.09,702.09,.19,21,13,0)
Worklist and HL7.
"^DD",702.09,702.09,.19,"DT")
3180606
"BLD",21621,6)
^47
**END**
**END**

