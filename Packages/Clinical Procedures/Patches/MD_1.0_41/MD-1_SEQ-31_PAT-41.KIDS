Released MD*1*41 SEQ #31
Extracted from mail message
**KIDS**:MD*1.0*41^

**INSTALL NAME**
MD*1.0*41
"BLD",10055,0)
MD*1.0*41^CLINICAL PROCEDURES^0^3151005^y
"BLD",10055,1,0)
^^1^1^3150923^
"BLD",10055,1,1,0)
IPv6 MODIFICATIONS
"BLD",10055,4,0)
^9.64PA^702.09^1
"BLD",10055,4,702.09,0)
702.09
"BLD",10055,4,702.09,2,0)
^9.641^702.09^1
"BLD",10055,4,702.09,2,702.09,0)
CP INSTRUMENT  (File-top level)
"BLD",10055,4,702.09,2,702.09,1,0)
^9.6411^.14^1
"BLD",10055,4,702.09,2,702.09,1,.14,0)
IP ADDRESS
"BLD",10055,4,702.09,222)
y^n^p^^^^n^^n
"BLD",10055,4,702.09,224)

"BLD",10055,4,"APDD",702.09,702.09)

"BLD",10055,4,"APDD",702.09,702.09,.14)

"BLD",10055,4,"B",702.09,702.09)

"BLD",10055,6.3)
3
"BLD",10055,"ABPKG")
n
"BLD",10055,"KRN",0)
^9.67PA^779.2^20
"BLD",10055,"KRN",.4,0)
.4
"BLD",10055,"KRN",.401,0)
.401
"BLD",10055,"KRN",.402,0)
.402
"BLD",10055,"KRN",.403,0)
.403
"BLD",10055,"KRN",.5,0)
.5
"BLD",10055,"KRN",.84,0)
.84
"BLD",10055,"KRN",3.6,0)
3.6
"BLD",10055,"KRN",3.8,0)
3.8
"BLD",10055,"KRN",9.2,0)
9.2
"BLD",10055,"KRN",9.8,0)
9.8
"BLD",10055,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",10055,"KRN",9.8,"NM",1,0)
MDRPCOT1^^0^B44379273
"BLD",10055,"KRN",9.8,"NM",2,0)
MDHL7B^^0^B10882680
"BLD",10055,"KRN",9.8,"NM","B","MDHL7B",2)

"BLD",10055,"KRN",9.8,"NM","B","MDRPCOT1",1)

"BLD",10055,"KRN",19,0)
19
"BLD",10055,"KRN",19,"NM",0)
^9.68A^^
"BLD",10055,"KRN",19.1,0)
19.1
"BLD",10055,"KRN",101,0)
101
"BLD",10055,"KRN",409.61,0)
409.61
"BLD",10055,"KRN",771,0)
771
"BLD",10055,"KRN",779.2,0)
779.2
"BLD",10055,"KRN",870,0)
870
"BLD",10055,"KRN",8989.51,0)
8989.51
"BLD",10055,"KRN",8989.52,0)
8989.52
"BLD",10055,"KRN",8994,0)
8994
"BLD",10055,"KRN","B",.4,.4)

"BLD",10055,"KRN","B",.401,.401)

"BLD",10055,"KRN","B",.402,.402)

"BLD",10055,"KRN","B",.403,.403)

"BLD",10055,"KRN","B",.5,.5)

"BLD",10055,"KRN","B",.84,.84)

"BLD",10055,"KRN","B",3.6,3.6)

"BLD",10055,"KRN","B",3.8,3.8)

"BLD",10055,"KRN","B",9.2,9.2)

"BLD",10055,"KRN","B",9.8,9.8)

"BLD",10055,"KRN","B",19,19)

"BLD",10055,"KRN","B",19.1,19.1)

"BLD",10055,"KRN","B",101,101)

"BLD",10055,"KRN","B",409.61,409.61)

"BLD",10055,"KRN","B",771,771)

"BLD",10055,"KRN","B",779.2,779.2)

"BLD",10055,"KRN","B",870,870)

"BLD",10055,"KRN","B",8989.51,8989.51)

"BLD",10055,"KRN","B",8989.52,8989.52)

"BLD",10055,"KRN","B",8994,8994)

"BLD",10055,"QUES",0)
^9.62^^
"BLD",10055,"REQB",0)
^9.611^1^1
"BLD",10055,"REQB",1,0)
MD*1.0*21^2
"BLD",10055,"REQB","B","MD*1.0*21",1)

"FIA",702.09)
CP INSTRUMENT
"FIA",702.09,0)
^MDS(702.09,
"FIA",702.09,0,0)
702.09I
"FIA",702.09,0,1)
y^n^p^^^^n^^n
"FIA",702.09,0,10)

"FIA",702.09,0,11)

"FIA",702.09,0,"RLRO")

"FIA",702.09,0,"VR")
1.0^MD
"FIA",702.09,702.09)
1
"FIA",702.09,702.09,.14)

"MBREQ")
0
"PKG",572,-1)
1^1
"PKG",572,0)
CLINICAL PROCEDURES^MD^Clinical Procedures
"PKG",572,20,0)
^9.402P^^
"PKG",572,22,0)
^9.49I^1^1
"PKG",572,22,1,0)
1.0^3040521^3150407^66481
"PKG",572,22,1,"PAH",1,0)
41^3151005
"PKG",572,22,1,"PAH",1,1,0)
^^1^1^3151005
"PKG",572,22,1,"PAH",1,1,1,0)
IPv6 MODIFICATIONS
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","MDHL7B")
0^2^B10882680^B9814726
"RTN","MDHL7B",1,0)
MDHL7B ; HOIFO/WAA -Bi-directional interface routine ;7/23/01  11:41
"RTN","MDHL7B",2,0)
 ;;1.0;CLINICAL PROCEDURES;**41**;Apr 01, 2004;Build 3
"RTN","MDHL7B",3,0)
 ;
"RTN","MDHL7B",4,0)
 ; IA# 5844 [Supported] Calls to XLFIPV
"RTN","MDHL7B",5,0)
 ; This routine will take an entry from 702 and submit that data
"RTN","MDHL7B",6,0)
 ; to the instrument that was indicated by the user
"RTN","MDHL7B",7,0)
 ; SUB is a submit function
"RTN","MDHL7B",8,0)
 ;    MDD702 is the IEN for the Entry from 702 that
"RTN","MDHL7B",9,0)
 ;           needs to be sent.
"RTN","MDHL7B",10,0)
 ;    The function will return -1^Submission failed and why
"RTN","MDHL7B",11,0)
 ;                              0^Device not Bi-Directional
"RTN","MDHL7B",12,0)
 ;                              1^Study submitted
"RTN","MDHL7B",13,0)
 ;
"RTN","MDHL7B",14,0)
 ; 09/25/15 KAM Remedy ticket 1095728 patch MD*1*41 IPv6 modifications
"RTN","MDHL7B",15,0)
 ;
"RTN","MDHL7B",16,0)
TMPSUB(MDD702) ; Process a submitted entry from user.
"RTN","MDHL7B",17,0)
 ; drp 16-JUL-2002 13:30:32 
"RTN","MDHL7B",18,0)
 N DEVICE
"RTN","MDHL7B",19,0)
 S DEVICE=+$P(^MDD(702,MDD702,0),U,11) Q:'DEVICE "0^No Device - TEST"
"RTN","MDHL7B",20,0)
 I +$P($G(^MDS(702.09,DEVICE,.1)),U,3) Q "1^Study Submitted - TEST"
"RTN","MDHL7B",21,0)
 Q "0^No Bi Di Cap - TEST"
"RTN","MDHL7B",22,0)
 ;
"RTN","MDHL7B",23,0)
SUB(MDD702) ; Change to SUB when working
"RTN","MDHL7B",24,0)
 N MDORFLG,RESULT,MSG,MDERROR
"RTN","MDHL7B",25,0)
 S MDORFLG=1
"RTN","MDHL7B",26,0)
 D EN1
"RTN","MDHL7B",27,0)
 Q RESULT_U_MSG
"RTN","MDHL7B",28,0)
 ;
"RTN","MDHL7B",29,0)
CANCEL(MDD702) ; Cancel Orders
"RTN","MDHL7B",30,0)
 N MDORFLG,RESULT,MSG,MDERROR
"RTN","MDHL7B",31,0)
 S MDORFLG=0
"RTN","MDHL7B",32,0)
 D EN1
"RTN","MDHL7B",33,0)
 Q RESULT_U_MSG
"RTN","MDHL7B",34,0)
 ;
"RTN","MDHL7B",35,0)
EN1 ; The main entry point for the order to be processed.
"RTN","MDHL7B",36,0)
 N DEVIEN,WORKING,MDIORD
"RTN","MDHL7B",37,0)
 ; Get the device that will process this study
"RTN","MDHL7B",38,0)
 ; Build an HL7 Message based in the device.
"RTN","MDHL7B",39,0)
 ; After the device has processed the message this routine will
"RTN","MDHL7B",40,0)
 ; update the status with in 702.
"RTN","MDHL7B",41,0)
 S RESULT=1,MSG=$S(MDORFLG=1:"Study Submitted.",1:"Study Cancelled")
"RTN","MDHL7B",42,0)
 I '$D(^MDD(702,MDD702,0)) S MSG="There is no study in 702 for entry "_MDD702_".",RESULT=-1
"RTN","MDHL7B",43,0)
 I RESULT'=-1 D  ;Get the device based on the CP def
"RTN","MDHL7B",44,0)
 . S DEF=$P(^MDD(702,MDD702,0),U,4) I DEF<1 S RESULT=-1,MSG="No CP DEFINITION for this entry in file 702.01."
"RTN","MDHL7B",45,0)
 . Q
"RTN","MDHL7B",46,0)
 I RESULT'=-1 D  ; Check to see that there is a device entered for this procedure
"RTN","MDHL7B",47,0)
 . S DEVIEN=$P(^MDD(702,MDD702,0),U,11) I DEVIEN>0 Q
"RTN","MDHL7B",48,0)
 . S RESULT=0,MSG="No DEVICE is defined." Q
"RTN","MDHL7B",49,0)
 . Q
"RTN","MDHL7B",50,0)
 ;
"RTN","MDHL7B",51,0)
 ; DRP/16-MAY-2003 14:44:36 - Check for Loopback IP
"RTN","MDHL7B",52,0)
 ; 09/25/15 KAM Remedy ticket 1095728 patch MD*1*41 IPv6 modifications
"RTN","MDHL7B",53,0)
 ; Changed next line to use new IPv6 API
"RTN","MDHL7B",54,0)
 ;
"RTN","MDHL7B",55,0)
 ;I $$GET1^DIQ(702.09,DEVIEN_",",.14)="127.0.0.1" D  Q
"RTN","MDHL7B",56,0)
 I $$CONVERT^XLFIPV($$GET1^DIQ(702.09,DEVIEN_",",.14))=$$CONVERT^XLFIPV("127.0.0.1") D  Q
"RTN","MDHL7B",57,0)
 . D LOOPBACK^MDHL7XXX(MDD702,DEVIEN)
"RTN","MDHL7B",58,0)
 . S RESULT=+$$GET1^DIQ(702.09,DEVIEN_",",.13,"I"),MSG="OK"
"RTN","MDHL7B",59,0)
 . Q
"RTN","MDHL7B",60,0)
 ;
"RTN","MDHL7B",61,0)
 I RESULT>0 D  ; Check to see that the device is a active and working
"RTN","MDHL7B",62,0)
 . S WORKING="" D INST^MDHL7U2(DEVIEN,.WORKING)
"RTN","MDHL7B",63,0)
 . Q:WORKING
"RTN","MDHL7B",64,0)
 . S RESULT=-1,MSG="There is a problem with the device entry in file 702.09."
"RTN","MDHL7B",65,0)
 . Q
"RTN","MDHL7B",66,0)
 I RESULT>0 D  ; Check to see if the device is bi-directional
"RTN","MDHL7B",67,0)
 . N LINE
"RTN","MDHL7B",68,0)
 . S LINE=$G(^MDS(702.09,DEVIEN,.1))
"RTN","MDHL7B",69,0)
 . I $P(LINE,U,3)'=1 D  Q  ; The Device is not Bi-Directional 
"RTN","MDHL7B",70,0)
 . . S RESULT=0,MSG="Device not Bi-Directional."
"RTN","MDHL7B",71,0)
 . . Q
"RTN","MDHL7B",72,0)
 . ; The device is Bi-Directional and we are getting an MDIORD number.
"RTN","MDHL7B",73,0)
 . S MDIORD=$$GETIORD^MDRPCOT1(MDD702) I MDIORD=-1 D
"RTN","MDHL7B",74,0)
 . . S RESULT=-1,MSG="Unable to create Instrument Order Number."
"RTN","MDHL7B",75,0)
 . . Q
"RTN","MDHL7B",76,0)
 . Q
"RTN","MDHL7B",77,0)
 I RESULT=1 D  ; Process the message to be sent
"RTN","MDHL7B",78,0)
 . D EN1^MDHL7BH ; Build HL7 Message
"RTN","MDHL7B",79,0)
 . I $P(MDERROR,U,2) S RESULT="-1",MSG=$P(MDERROR,U,3)
"RTN","MDHL7B",80,0)
 . Q
"RTN","MDHL7B",81,0)
 Q
"RTN","MDRPCOT1")
0^1^B44379273^B41706537
"RTN","MDRPCOT1",1,0)
MDRPCOT1 ; HOIFO/NCA/DP - Object RPCs (TMDTransaction) - Continued ;3/13/09  11:18
"RTN","MDRPCOT1",2,0)
 ;;1.0;CLINICAL PROCEDURES;**5,11,21,41**;Apr 01, 2004;Build 3
"RTN","MDRPCOT1",3,0)
 ; Integration Agreements:
"RTN","MDRPCOT1",4,0)
 ; IA# 2263 [Supported] calls to XPAR
"RTN","MDRPCOT1",5,0)
 ; IA# 3067 [Private] Reads fields in Consults file (#123).
"RTN","MDRPCOT1",6,0)
 ; IA# 3468 [Subscription] GMRCCP API.
"RTN","MDRPCOT1",7,0)
 ; IA# 3567 [Subscription] MAGGSIUI API
"RTN","MDRPCOT1",8,0)
 ; IA# 10040 [Supported] Hospital Location File Access
"RTN","MDRPCOT1",9,0)
 ; IA# 10061 [Supported] Calls to VADPT
"RTN","MDRPCOT1",10,0)
 ; IA# 10103 [Supported] Calls to XLFDT.
"RTN","MDRPCOT1",11,0)
 ; IA# 5844 [Supported] Calls to XLFIPV
"RTN","MDRPCOT1",12,0)
 ;
"RTN","MDRPCOT1",13,0)
 ; 09/25/15 KAM Remedy Call 1095728  Patch MD*1*41 IPv6 modifications
"RTN","MDRPCOT1",14,0)
 ;
"RTN","MDRPCOT1",15,0)
DELERR(MDTIEN) ; [Procedure] Delete Imaging Error Messages
"RTN","MDRPCOT1",16,0)
 S MDLP=0 F  S MDLP=$O(^MDD(702,MDTIEN,.091,MDLP)) Q:'MDLP  D
"RTN","MDRPCOT1",17,0)
 .K DA,DIK
"RTN","MDRPCOT1",18,0)
 .S DA=+MDLP,DA(1)=+MDTIEN,DIK="^MDD(702,"_DA(1)_",.091," D ^DIK
"RTN","MDRPCOT1",19,0)
 .Q
"RTN","MDRPCOT1",20,0)
 Q
"RTN","MDRPCOT1",21,0)
 ;
"RTN","MDRPCOT1",22,0)
IMGSTAT(STUDY,MDSTAT) ; [Procedure] Update the Image Status.
"RTN","MDRPCOT1",23,0)
 N MDL
"RTN","MDRPCOT1",24,0)
 S MDL=0 F  S MDL=$O(^MDD(702,STUDY,.1,MDL)) Q:MDL<1  S $P(^(MDL,0),"^",9)=MDSTAT
"RTN","MDRPCOT1",25,0)
 Q
"RTN","MDRPCOT1",26,0)
 ;
"RTN","MDRPCOT1",27,0)
GETVSTR(DFN,MDSSTR,MDPR,MDTR) ; [Function] Check the Visit String
"RTN","MDRPCOT1",28,0)
 N MDCLOC,MDHOLD,MDLOC,MDINPT,VAIP
"RTN","MDRPCOT1",29,0)
 N MDPR12,MDAPP ; Patch 11
"RTN","MDRPCOT1",30,0)
 I '$G(MDTR) Q 0
"RTN","MDRPCOT1",31,0)
 I '$G(MDPR) Q 0
"RTN","MDRPCOT1",32,0)
 I $G(MDSSTR)="" Q 0
"RTN","MDRPCOT1",33,0)
 S VAIP("D")=MDTR ; DT of Transaction Created
"RTN","MDRPCOT1",34,0)
 D IN5^VADPT S MDINPT=$S(+VAIP(13):1,1:0)
"RTN","MDRPCOT1",35,0)
 S (MDCLOC,MDHOLD)=$$GET1^DIQ(702.01,+MDPR_",",.05,"I")
"RTN","MDRPCOT1",36,0)
 ; Patch 11
"RTN","MDRPCOT1",37,0)
 S MDPR12=$$GET1^DIQ(702.01,+MDPR_",",.12,"I")
"RTN","MDRPCOT1",38,0)
 S:MDPR12=1 MDCLOC=""
"RTN","MDRPCOT1",39,0)
 S MDAPP=$$GET^XPAR("SYS","MD USE APPOINTMENT",1)
"RTN","MDRPCOT1",40,0)
 ; End Patch 11 code
"RTN","MDRPCOT1",41,0)
 I 'MDCLOC S MDCLOC=+$P(MDSSTR,";",3) I 'MDCLOC S MDCLOC=MDHOLD I 'MDCLOC Q 0
"RTN","MDRPCOT1",42,0)
 I +MDAPP S MDCLOC=$S(+$P(MDSSTR,";",3)>1:+$P(MDSSTR,";",3),1:MDCLOC) I 'MDCLOC Q 0
"RTN","MDRPCOT1",43,0)
 S Y=MDCLOC_";"_$P(MDSSTR,";",2)_";"_$P(MDSSTR,";")
"RTN","MDRPCOT1",44,0)
 I $P(Y,";",3)="A" Q Y
"RTN","MDRPCOT1",45,0)
 S:$P(Y,";",3)="" $P(Y,";",3)="A"
"RTN","MDRPCOT1",46,0)
 S:+MDINPT $P(Y,";",3)="A"
"RTN","MDRPCOT1",47,0)
 S:$P(Y,";",3)="V" $P(Y,";",3)="A"
"RTN","MDRPCOT1",48,0)
 Q Y
"RTN","MDRPCOT1",49,0)
 ;
"RTN","MDRPCOT1",50,0)
PDT(STUDIE) ; [Function] Loop through the attachments for Date/Time Performed.
"RTN","MDRPCOT1",51,0)
 N MDL,MDDT
"RTN","MDRPCOT1",52,0)
 S MDL=0,MDDT=""
"RTN","MDRPCOT1",53,0)
 F  S MDL=$O(^MDD(702,STUDIE,.1,MDL)) Q:'MDL  D  Q:MDDT
"RTN","MDRPCOT1",54,0)
 .S MDDT=$P($G(^MDD(702,STUDIE,.1,MDL,0)),"^",3)
"RTN","MDRPCOT1",55,0)
 I MDDT S MDDT=$P($G(^MDD(703.1,+MDDT,0)),"^",3) ; Get Date/Time Performed
"RTN","MDRPCOT1",56,0)
 ;S:'MDDT MDDT=$$NOW^XLFDT()
"RTN","MDRPCOT1",57,0)
 Q MDDT
"RTN","MDRPCOT1",58,0)
 ;
"RTN","MDRPCOT1",59,0)
SUBMIT(STUDY) ; [Function] Submit all non-pending/uncomplete images in transaction to Imaging
"RTN","MDRPCOT1",60,0)
 N DATA,DEVIEN,MDACQ,MDC,MDCRES,MDCTR,MDLOC,MDAR,MDARR,MDDT,MDFDA,MDDEL,MDIEN,MDIENS,MDIMG,MDL,MDLPB,MDMAG,MDMULT,MDR,MDST,MDX,MDY,MDZ
"RTN","MDRPCOT1",61,0)
 S MDIEN=+STUDY,MDIENS=MDIEN_",",MDLPB=0
"RTN","MDRPCOT1",62,0)
 S DEVIEN=$P(^MDD(702,STUDY,0),U,11)
"RTN","MDRPCOT1",63,0)
 ;
"RTN","MDRPCOT1",64,0)
 ; 09/25/15 KAM Remedy Ticket 1095728 IPv6 modifications
"RTN","MDRPCOT1",65,0)
 ; Changed next line to use API
"RTN","MDRPCOT1",66,0)
 ;S:$$GET1^DIQ(702.09,DEVIEN_",",.14)="127.0.0.1" MDLPB=1
"RTN","MDRPCOT1",67,0)
 S:$$CONVERT^XLFIPV($$GET1^DIQ(702.09,DEVIEN_",",.14))=$$CONVERT^XLFIPV("127.0.0.1") MDLPB=1
"RTN","MDRPCOT1",68,0)
 ;
"RTN","MDRPCOT1",69,0)
 S MDMULT=$$MULT(+MDIEN)
"RTN","MDRPCOT1",70,0)
 S MDST=$$GET1^DIQ(702,MDIEN,.09,"I") ; I 'MDMULT&('MDLPB)&("13"[MDST) Q "-1^Study not in proper status"
"RTN","MDRPCOT1",71,0)
 I MDMULT&(MDST=1) Q "-1^Study not in proper status"
"RTN","MDRPCOT1",72,0)
 I MDMULT&(MDST=3) D STATUS^MDRPCOT(MDIENS,5,"")
"RTN","MDRPCOT1",73,0)
 D DELERR(+MDIEN)
"RTN","MDRPCOT1",74,0)
 I $$GET1^DIQ(702,MDIEN,.01)="" Q "-1^No Entry in file (#702)."
"RTN","MDRPCOT1",75,0)
 D NOW^%DTC S MDDT=%
"RTN","MDRPCOT1",76,0)
 S MDMAG("IDFN")=+$$GET1^DIQ(702,MDIEN,.01,"I")
"RTN","MDRPCOT1",77,0)
 I 'MDMAG("IDFN") Q "-1^No Patient DFN."
"RTN","MDRPCOT1",78,0)
 S MDMAG("PXPKG")=8925
"RTN","MDRPCOT1",79,0)
 S MDMAG("PXIEN")=+$$GET1^DIQ(702,MDIEN,.06,"I")
"RTN","MDRPCOT1",80,0)
 I 'MDMAG("PXIEN") Q "-1^No TIU IEN"
"RTN","MDRPCOT1",81,0)
 I '$O(^MDD(702,MDIEN,.1,0)) D  Q $S(+MDR<0:MDR,1:"3^Transaction Complete")
"RTN","MDRPCOT1",82,0)
 .S MDC=$$GET1^DIQ(702,MDIEN,.05,"I")
"RTN","MDRPCOT1",83,0)
 .S MDR=$$UPDCONS(MDC,MDMAG("PXIEN"))
"RTN","MDRPCOT1",84,0)
 S MDMAG("STSCB")="ISTAT^MDAPI"
"RTN","MDRPCOT1",85,0)
 S MDMAG("TRKID")="CP;"_MDIEN_"-"_MDDT
"RTN","MDRPCOT1",86,0)
 S MDLOC=$$GET1^DIQ(702,MDIEN,.07,"I"),MDLOC=$P(MDLOC,";",3)
"RTN","MDRPCOT1",87,0)
 I 'MDLOC Q "-1^No Hospital Location."
"RTN","MDRPCOT1",88,0)
 S MDMAG("ACQS")=$S(+$$GET1^DIQ(44,MDLOC_",",3,"I"):+$$GET1^DIQ(44,MDLOC_",",3,"I"),1:+$G(DUZ(2)))
"RTN","MDRPCOT1",89,0)
 S MDMAG("ACQL")=MDLOC
"RTN","MDRPCOT1",90,0)
 S MDX=$$GET1^DIQ(702,MDIEN,.04,"I")
"RTN","MDRPCOT1",91,0)
 S MDZ=$P(^MDS(702.01,+MDX,0),"^",1)
"RTN","MDRPCOT1",92,0)
 S (MDACQ,MDX,MDDEL)="",MDCTR=0
"RTN","MDRPCOT1",93,0)
 N MDTOT S MDTOT=$$GET1^DIQ(702,MDIENS,.991)
"RTN","MDRPCOT1",94,0)
 S MDL=0 F  S MDL=$O(^MDD(702,MDIEN,.1,MDL)) Q:MDL<1  S MDX=$G(^(MDL,0)) D
"RTN","MDRPCOT1",95,0)
 .S:'MDDEL MDDEL=$P(MDX,"^",3)
"RTN","MDRPCOT1",96,0)
 .S MDY=$G(^MDD(702,MDIEN,.1,MDL,.1)) Q:MDY=""
"RTN","MDRPCOT1",97,0)
 .S:MDACQ="" MDACQ=$P($P(MDY,"\\",2),"\")
"RTN","MDRPCOT1",98,0)
 .S:"12"[$P(MDX,"^",9) $P(MDX,"^",9)=""
"RTN","MDRPCOT1",99,0)
 .I $P(MDX,"^",9)="" S MDCTR=MDCTR+1,MDARR(MDCTR)=MDY_"^"_MDZ_" image "_MDCTR_" out of "_MDTOT
"RTN","MDRPCOT1",100,0)
 .Q
"RTN","MDRPCOT1",101,0)
 I '$O(MDARR(0)) Q "-1^No UNC."
"RTN","MDRPCOT1",102,0)
 S MDMAG("GDESC")=MDZ_" Result"
"RTN","MDRPCOT1",103,0)
 I MDDEL S MDY=$P($G(^MDD(703.1,+MDDEL,0)),"^",3,4),MDMAG("PXDT")=$P(MDY,"^",1),MDY=+$P(MDY,"^",2),MDMAG("ACQD")=$P($G(^MDS(702.09,+MDY,0)),"^"),MDMAG("DFLG")=+$P($G(^MDS(702.09,+MDY,0)),"^",5)
"RTN","MDRPCOT1",104,0)
 S:$G(MDMAG("ACQD"))="" MDMAG("ACQD")=MDACQ
"RTN","MDRPCOT1",105,0)
 S:'$G(MDMAG("PXDT")) MDMAG("PXDT")=MDDT ; If no date, use NOW in MDDT
"RTN","MDRPCOT1",106,0)
 S MDMAG("TRTYPE")="NEW"
"RTN","MDRPCOT1",107,0)
 D IMPORT^MAGGSIUI(.MDIMG,.MDARR,.MDMAG)
"RTN","MDRPCOT1",108,0)
 I '(+$G(MDIMG(0))) D  Q "-1^"_$P(MDIMG(0),"^",2)
"RTN","MDRPCOT1",109,0)
 .D IMGSTAT(+MDIENS,1)
"RTN","MDRPCOT1",110,0)
 .F MDAR=0:0 S MDAR=$O(MDIMG(MDAR)) Q:'MDAR  I $G(MDIMG(MDAR))'="" D
"RTN","MDRPCOT1",111,0)
 ..S DATA("MESSAGE")=$$TRANS^MDAPI(MDIMG(MDAR)) D ADDMSG^MDRPCOT
"RTN","MDRPCOT1",112,0)
 D IMGSTAT(+MDIENS,0)
"RTN","MDRPCOT1",113,0)
 Q "1^Images Submitted"
"RTN","MDRPCOT1",114,0)
 ;
"RTN","MDRPCOT1",115,0)
UPDCONS(MDC,MDDOC) ; [Function] Update Consults Procedure Status
"RTN","MDRPCOT1",116,0)
 N MDCRES,MDKK,MDSDY,MDPDEF,MDF,MDH,MDX3,MDX4,MDXC,MDXD S (MDF,MDXD)=0,MDX4=""
"RTN","MDRPCOT1",117,0)
 D GETLST^XPAR(.MDH,"SYS","MD GET HIGH VOLUME")
"RTN","MDRPCOT1",118,0)
 S MDSDY=$O(^MDD(702,"ACON",MDC,""),-1) Q:'+MDSDY 1
"RTN","MDRPCOT1",119,0)
 S MDPDEF=+$P($G(^MDD(702,+MDSDY,0)),"^",4) Q:'+MDPDEF 1
"RTN","MDRPCOT1",120,0)
 F MDKK=0:0 S MDKK=$O(MDH(MDKK)) Q:MDKK<1  I $P($G(MDH(MDKK)),"^")=+MDPDEF S MDF=1 Q
"RTN","MDRPCOT1",121,0)
 I $P($G(^MDS(702.01,+MDPDEF,0)),U,6)=2 Q 1
"RTN","MDRPCOT1",122,0)
 D GETS^DIQ(123,MDC_",","50*","I","MDXC")
"RTN","MDRPCOT1",123,0)
 S MDX3="" F  S MDX3=$O(MDXC(123.03,MDX3)) Q:MDX3<1  S MDX4=$G(MDXC(123.03,MDX3,.01,"I")) I MDX4["TIU" S:+MDX4=+$P($G(^MDD(702,+MDSDY,0)),"^",6) MDXD=1 Q
"RTN","MDRPCOT1",124,0)
 I +$P($G(^MDS(702.01,+MDPDEF,0)),U,10)!(+MDF) Q:+MDXD 1
"RTN","MDRPCOT1",125,0)
 S MDCRES=$$CPDOC^GMRCCP(MDC,MDDOC,2)
"RTN","MDRPCOT1",126,0)
 I '(+MDCRES) Q "-1^"_$P(MDCRES,"^",2)
"RTN","MDRPCOT1",127,0)
 Q 1
"RTN","MDRPCOT1",128,0)
 ;
"RTN","MDRPCOT1",129,0)
GETIORD(MDIEN) ; [Function] Return the Instrument order number for this study
"RTN","MDRPCOT1",130,0)
 ; Called from instrument interface routines
"RTN","MDRPCOT1",131,0)
 Q:'$D(^MDD(702,MDIEN,0))#2 -1  ; No such study
"RTN","MDRPCOT1",132,0)
 Q:'$P(^MDD(702,MDIEN,0),U,12) $$NEWIORD(MDIEN)  ; Create a new one
"RTN","MDRPCOT1",133,0)
 Q $P(^MDD(702,MDIEN,0),U,12)  ; Return the existing one
"RTN","MDRPCOT1",134,0)
 ;
"RTN","MDRPCOT1",135,0)
NEWIORD(MDIEN) ; [Function] Generate & return new unique instrument order number
"RTN","MDRPCOT1",136,0)
 ; Notice: will overwrite existing order number if it exists
"RTN","MDRPCOT1",137,0)
 N MDFDA
"RTN","MDRPCOT1",138,0)
 Q:'$D(^MDD(702,MDIEN,0))#2 -1  ; No such study
"RTN","MDRPCOT1",139,0)
 L +^MDD(702,"AION"):15 E  Q -1  ; Unable to lock and guarantee uniqueness
"RTN","MDRPCOT1",140,0)
 F  D  Q:'$D(^MDD(702,"AION",X))  H 1  ; Loop until unique
"RTN","MDRPCOT1",141,0)
 . S X=$$NOW^XLFDT() ; Current DateTime
"RTN","MDRPCOT1",142,0)
 . S X=$TR($J(X,14,6),".","") ; Pad with 0's and strip the decimal
"RTN","MDRPCOT1",143,0)
 . Q
"RTN","MDRPCOT1",144,0)
 I $E($G(^MDS(702.09,DEVIEN,0)),1,4)="Muse" D
"RTN","MDRPCOT1",145,0)
 . ; Due to current limitation to the Muse can only except 9
"RTN","MDRPCOT1",146,0)
 . S X=$E($TR($H,",",""),2,10) ; Using $E($H) only for the MUSE
"RTN","MDRPCOT1",147,0)
 . I '$D(^MDD(702,"AION",X)) Q  ; It is unique and quit
"RTN","MDRPCOT1",148,0)
 . N I,FLG ; Not unique
"RTN","MDRPCOT1",149,0)
 . S FLG=0
"RTN","MDRPCOT1",150,0)
 . F I=1:1 D  Q:FLG
"RTN","MDRPCOT1",151,0)
 . . S X=X+1
"RTN","MDRPCOT1",152,0)
 . . I '$D(^MDD(702,"AION",X)) S FLG=1
"RTN","MDRPCOT1",153,0)
 . . Q
"RTN","MDRPCOT1",154,0)
 . Q
"RTN","MDRPCOT1",155,0)
 S MDFDA(702,MDIEN_",",.12)=X  ; Build FDA
"RTN","MDRPCOT1",156,0)
 D FILE^DIE("","MDFDA")  ; File it
"RTN","MDRPCOT1",157,0)
 L -(^MDD(702,"AION"))  ; Unlock it
"RTN","MDRPCOT1",158,0)
 Q $P(^MDD(702,MDIEN,0),U,12)  ; Return it from the file
"RTN","MDRPCOT1",159,0)
GETSTDY(MDION) ; [Function] Return study from instrument order number
"RTN","MDRPCOT1",160,0)
 ; Called from instrument interface routines
"RTN","MDRPCOT1",161,0)
 Q:'$D(^MDD(702,"AION",MDION)) ""  ; No such order number
"RTN","MDRPCOT1",162,0)
 Q $O(^MDD(702,"AION",MDION,""),-1) ; Return the 702 ien
"RTN","MDRPCOT1",163,0)
 ;
"RTN","MDRPCOT1",164,0)
MULT(MDIN) ; [Function] Return whether result is mulitple or final
"RTN","MDRPCOT1",165,0)
 N MDDEF
"RTN","MDRPCOT1",166,0)
 S MDDEF=+$$GET1^DIQ(702,MDIN,.04,"I")
"RTN","MDRPCOT1",167,0)
 I 'MDDEF Q 0
"RTN","MDRPCOT1",168,0)
 Q +$$GET1^DIQ(702.01,MDDEF,.12,"I")
"VER")
8.0^22.0
"^DD",702.09,702.09,.14,0)
IP ADDRESS^FX^^.1;4^K:'($$VALIDATE^XLFIPV(X)) X
"^DD",702.09,702.09,.14,.1)
IP Address
"^DD",702.09,702.09,.14,3)
Enter a valid IP address in the form: nn.nn.nn.nn (IPv4) or hhhh:hhhh:hhhh:hhhh:hhhh:hhhh:hhhh:hhhh (IPv6)
"^DD",702.09,702.09,.14,21,0)
^^1^1^3021112^
"^DD",702.09,702.09,.14,21,1,0)
This field contains the IP address of this instrument.
"^DD",702.09,702.09,.14,"DT")
3150925
"BLD",10055,6)
^31
**END**
**END**

