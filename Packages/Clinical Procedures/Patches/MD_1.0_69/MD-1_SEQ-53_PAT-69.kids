Released MD*1*69 SEQ #53
Extracted from mail message
**KIDS**:MD*1.0*69^

**INSTALL NAME**
MD*1.0*69
"BLD",11013,0)
MD*1.0*69^CLINICAL PROCEDURES^0^3190220^y
"BLD",11013,1,0)
^^3^3^3190130^
"BLD",11013,1,1,0)
This patch will address the issues in the following tickets:
"BLD",11013,1,2,0)
INC3431411, INC3430523, INC3525351, INC3559705
"BLD",11013,1,3,0)
Hemodialysis CPs are failing to auto check-in after the first day.
"BLD",11013,4,0)
^9.64PA^^
"BLD",11013,6.3)
2
"BLD",11013,"ABPKG")
n
"BLD",11013,"KRN",0)
^9.67PA^1.61^23
"BLD",11013,"KRN",.4,0)
.4
"BLD",11013,"KRN",.401,0)
.401
"BLD",11013,"KRN",.402,0)
.402
"BLD",11013,"KRN",.403,0)
.403
"BLD",11013,"KRN",.5,0)
.5
"BLD",11013,"KRN",.84,0)
.84
"BLD",11013,"KRN",1.6,0)
1.6
"BLD",11013,"KRN",1.61,0)
1.61
"BLD",11013,"KRN",1.62,0)
1.62
"BLD",11013,"KRN",3.6,0)
3.6
"BLD",11013,"KRN",3.8,0)
3.8
"BLD",11013,"KRN",9.2,0)
9.2
"BLD",11013,"KRN",9.8,0)
9.8
"BLD",11013,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",11013,"KRN",9.8,"NM",1,0)
MDWOR^^0^B50562959
"BLD",11013,"KRN",9.8,"NM",2,0)
MDWORSR^^0^B59105822
"BLD",11013,"KRN",9.8,"NM","B","MDWOR",1)

"BLD",11013,"KRN",9.8,"NM","B","MDWORSR",2)

"BLD",11013,"KRN",19,0)
19
"BLD",11013,"KRN",19,"NM",0)
^9.68A^^
"BLD",11013,"KRN",19.1,0)
19.1
"BLD",11013,"KRN",101,0)
101
"BLD",11013,"KRN",409.61,0)
409.61
"BLD",11013,"KRN",771,0)
771
"BLD",11013,"KRN",779.2,0)
779.2
"BLD",11013,"KRN",870,0)
870
"BLD",11013,"KRN",8989.51,0)
8989.51
"BLD",11013,"KRN",8989.52,0)
8989.52
"BLD",11013,"KRN",8994,0)
8994
"BLD",11013,"KRN","B",.4,.4)

"BLD",11013,"KRN","B",.401,.401)

"BLD",11013,"KRN","B",.402,.402)

"BLD",11013,"KRN","B",.403,.403)

"BLD",11013,"KRN","B",.5,.5)

"BLD",11013,"KRN","B",.84,.84)

"BLD",11013,"KRN","B",1.6,1.6)

"BLD",11013,"KRN","B",1.61,1.61)

"BLD",11013,"KRN","B",1.62,1.62)

"BLD",11013,"KRN","B",3.6,3.6)

"BLD",11013,"KRN","B",3.8,3.8)

"BLD",11013,"KRN","B",9.2,9.2)

"BLD",11013,"KRN","B",9.8,9.8)

"BLD",11013,"KRN","B",19,19)

"BLD",11013,"KRN","B",19.1,19.1)

"BLD",11013,"KRN","B",101,101)

"BLD",11013,"KRN","B",409.61,409.61)

"BLD",11013,"KRN","B",771,771)

"BLD",11013,"KRN","B",779.2,779.2)

"BLD",11013,"KRN","B",870,870)

"BLD",11013,"KRN","B",8989.51,8989.51)

"BLD",11013,"KRN","B",8989.52,8989.52)

"BLD",11013,"KRN","B",8994,8994)

"BLD",11013,"QUES",0)
^9.62^^
"BLD",11013,"REQB",0)
^9.611^1^1
"BLD",11013,"REQB",1,0)
MD*1.0*54^1
"BLD",11013,"REQB","B","MD*1.0*54",1)

"MBREQ")
0
"PKG",635,-1)
1^1
"PKG",635,0)
CLINICAL PROCEDURES^MD^Clinical Procedures
"PKG",635,22,0)
^9.49I^1^1
"PKG",635,22,1,0)
1.0^3040521^3061024^568
"PKG",635,22,1,"PAH",1,0)
69^3190220
"PKG",635,22,1,"PAH",1,1,0)
^^3^3^3190220
"PKG",635,22,1,"PAH",1,1,1,0)
This patch will address the issues in the following tickets:
"PKG",635,22,1,"PAH",1,1,2,0)
INC3431411, INC3430523, INC3525351, INC3559705
"PKG",635,22,1,"PAH",1,1,3,0)
Hemodialysis CPs are failing to auto check-in after the first day.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","MDWOR")
0^1^B50562959^B51417126
"RTN","MDWOR",1,0)
MDWOR ; HOIFO/NCA - Main Routine to Decode HL7 ; 1/29/19 4:55pm
"RTN","MDWOR",2,0)
 ;;1.0;CLINICAL PROCEDURES;**14,11,21,20,37,42,54,69**;Apr 01,2004;Build 2
"RTN","MDWOR",3,0)
 ; Reference IA# 2263 [Supported] XPAR calls
"RTN","MDWOR",4,0)
 ;               3468 [Subscription] Call GMRCCP.
"RTN","MDWOR",5,0)
 ;               3071 [Subscription] Call $$PKGID^ORX8.
"RTN","MDWOR",6,0)
 ;              10035 [Supported] Access DPT("B"
"RTN","MDWOR",7,0)
 ;              10040 [Supported] Access SC(
"RTN","MDWOR",8,0)
 ;              10061 [Supported] VADPT call
"RTN","MDWOR",9,0)
 ;              10103 [Supported] XLFDT calls
"RTN","MDWOR",10,0)
 ; 03/18/2014 KAM MD*1*37 Rem Ticket 451758 Auto Check-in issue
"RTN","MDWOR",11,0)
EN(MDMSG) ; Entry Point for CPRS and pass MSG in MDMSG
"RTN","MDWOR",12,0)
 N DFN,MDCON,MDCPROC,MDCANC,MDCANR,MDFN,MDIFN,MDINST,MDFLG,MDINT,MDL,MDIN,MDINP,MDINST,MDLOC,MDNAM,MDOBC,MDOBX,MDOPRO,MDPROC,MDPAT
"RTN","MDWOR",13,0)
 N MDLL,MDK1,MDPROV,MDREQ,MDQTIM,MDROOT,MDRR,MDSINP,MDVSTD,MDX S MDVSTD=""
"RTN","MDWOR",14,0)
 S (MDFLG,MDINP,MDINST,MDCANC,MDOBC)=0 F MDL=0:0 S MDL=$O(MDMSG(MDL)) Q:MDL<1!(+MDFLG>0)  S MDX=$G(MDMSG(MDL)) D
"RTN","MDWOR",15,0)
 .I $E(MDX,1,3)="MSH" D MSH Q
"RTN","MDWOR",16,0)
 .I $E(MDX,1,3)="PID" D PID Q
"RTN","MDWOR",17,0)
 .I $E(MDX,1,3)="PV1" D PV1 Q
"RTN","MDWOR",18,0)
 .I $E(MDX,1,3)="ORC" D ORC Q
"RTN","MDWOR",19,0)
 .I $E(MDX,1,3)="OBR" D OBR Q
"RTN","MDWOR",20,0)
 .I $E(MDX,1,3)="OBX" D:MDOBC<1 OBX Q
"RTN","MDWOR",21,0)
 .Q
"RTN","MDWOR",22,0)
 D GETLST^XPAR(.MDLL,"SYS","MD CLINIC ASSOCIATION")
"RTN","MDWOR",23,0)
 I +MDFLG<1&(+MDCANC<1)&(MDVSTD="") F MDK1=0:0 S MDK1=$O(MDLL(MDK1)) Q:MDK1<1  S MDROOT=$G(MDLL(MDK1)) I +$P(MDROOT,";",2)=MDPROC D  Q:+MDRR
"RTN","MDWOR",24,0)
 .S MDRR=0,MDIFN=MDFN,MDRR=$$GETAPPT(MDIFN,+$P(MDROOT,"^",2))
"RTN","MDWOR",25,0)
 .S:+MDRR MDVSTD="A"_";"_$P(MDRR,"^",1)_";"_+$P(MDROOT,"^",2)
"RTN","MDWOR",26,0)
 I +MDFLG<1&(MDVSTD'="") F MDK1=0:0 S MDK1=$O(MDLL(MDK1)) Q:MDK1<1  S MDROOT=$P($G(MDLL(MDK1)),"^",2) I +$P(MDROOT,";",2)=MDPROC D
"RTN","MDWOR",27,0)
 .I +$P(MDVSTD,";",3)>0&(+MDROOT=$P(MDVSTD,";",3)) S MDFLG=0 Q
"RTN","MDWOR",28,0)
 ;
"RTN","MDWOR",29,0)
 ; 03/18/2014 KAM MD*1*37 Rem Ticket 451758
"RTN","MDWOR",30,0)
 ; Commented out the next line - setting the MDFLG to 1 on a clinic
"RTN","MDWOR",31,0)
 ; change is not needed
"RTN","MDWOR",32,0)
 ;.I +$P(MDVSTD,";",3)>0&(+MDROOT'=$P(MDVSTD,";",3)) S MDFLG=1 Q
"RTN","MDWOR",33,0)
 ;
"RTN","MDWOR",34,0)
 I +MDFLG<1&(+MDCANC<1) S MDATA="+1,^"_MDPROC_"^"_+MDCON_"^"_MDINST_"^"_MDVSTD D CHKIN(MDFN,MDREQ,MDPROV,MDATA,MDVSTD)
"RTN","MDWOR",35,0)
 Q
"RTN","MDWOR",36,0)
MSH ; Decode MSH
"RTN","MDWOR",37,0)
 I $P(MDX,"|",2)'="^~\&" S MDFLG=1 Q
"RTN","MDWOR",38,0)
 I $P(MDX,"|",3)'="ORDER ENTRY" S MDFLG=1 Q
"RTN","MDWOR",39,0)
 I $P(MDX,"|",9)'="ORM" S MDFLG=1 Q
"RTN","MDWOR",40,0)
 Q
"RTN","MDWOR",41,0)
PID ; Check PID
"RTN","MDWOR",42,0)
 S MDNAM=$P(MDX,"|",6),DFN=$P(MDX,"|",4)
"RTN","MDWOR",43,0)
 I '$D(^DPT("B",$E(MDNAM,1,30),DFN)) S MDFLG=1
"RTN","MDWOR",44,0)
 S MDFN=DFN
"RTN","MDWOR",45,0)
 Q
"RTN","MDWOR",46,0)
PV1 ; Check PV1
"RTN","MDWOR",47,0)
 S MDPAT=$P(MDX,"|",3) I MDPAT'?1U!("IO"'[MDPAT) S MDFLG=1 Q
"RTN","MDWOR",48,0)
 I MDPAT="I" S MDINP=1
"RTN","MDWOR",49,0)
 S MDLOC=+$P(MDX,"|",4) I $G(^SC(MDLOC,0))="" S MDFLG=1 Q
"RTN","MDWOR",50,0)
 S:MDINP>0 MDLOC=""
"RTN","MDWOR",51,0)
 Q
"RTN","MDWOR",52,0)
ORC ; Check ORC
"RTN","MDWOR",53,0)
 I $P(MDX,"|",2)="NW" D NEW Q
"RTN","MDWOR",54,0)
 I $P(MDX,"|",2)="DC" D CANCEL Q
"RTN","MDWOR",55,0)
 S MDFLG=1
"RTN","MDWOR",56,0)
 Q
"RTN","MDWOR",57,0)
OBX ; Check OBX
"RTN","MDWOR",58,0)
 N %,ANSWER,MDCV,MDOBX
"RTN","MDWOR",59,0)
 S MDOBX=$P(MDX,"|",6)
"RTN","MDWOR",60,0)
 I '+$$GET^XPAR("SYS","MD USE APPT WITH PROCEDURE",1) S MDOBC=MDOBC+1 Q
"RTN","MDWOR",61,0)
 S MDVSTD=$P(MDOBX,"Visit Date: ",2)
"RTN","MDWOR",62,0)
 S MDCV=$P(MDVSTD," ",1,2)
"RTN","MDWOR",63,0)
 I MDCV=""!(MDCV["UNKNOWN") S MDFLG=1 Q
"RTN","MDWOR",64,0)
 S MDVSTD=$P(MDCV," ")_"@"_$P(MDCV," ",2)
"RTN","MDWOR",65,0)
 D DT^DILF("T",MDVSTD,.ANSWER)
"RTN","MDWOR",66,0)
 S:ANSWER<0 ANSWER=""
"RTN","MDWOR",67,0)
 S MDVSTD=ANSWER I MDVSTD="" S MDFLG=1 Q
"RTN","MDWOR",68,0)
 I +MDLOC>0 S MDVSTD="A;"_MDVSTD_";"_MDLOC
"RTN","MDWOR",69,0)
 E  D NOW^%DTC S MDVSTD=%
"RTN","MDWOR",70,0)
 S MDOBC=MDOBC+1
"RTN","MDWOR",71,0)
 Q
"RTN","MDWOR",72,0)
NEW ; New Order Segment
"RTN","MDWOR",73,0)
 S MDIFN=+$P(MDX,"|",3) I 'MDIFN S MDFLG=1 Q
"RTN","MDWOR",74,0)
 S MDPROV=+$P(MDX,"|",11) I 'MDPROV S MDFLG=1 Q
"RTN","MDWOR",75,0)
 S MDQTIM=$P(MDX,"|",8),MDQTIM=$P(MDQTIM,"^",6)
"RTN","MDWOR",76,0)
 S MDREQ=$P(MDX,"|",16) S MDREQ=$$FMDTE(MDREQ) I 'MDREQ S MDFLG=1 Q
"RTN","MDWOR",77,0)
 S MDREQ=$S(MDQTIM="Z24":$$FMADD^XLFDT(MDREQ,0,24),MDQTIM="Z48":$$FMADD^XLFDT(MDREQ,0,48),MDQTIM="Z72":$$FMADD^XLFDT(MDREQ,0,72),MDQTIM="ZW":$$FMADD^XLFDT(MDREQ,7),MDQTIM="ZM":$$FMADD^XLFDT(MDREQ,30),1:MDREQ)
"RTN","MDWOR",78,0)
 ; Retrieve Consult Number
"RTN","MDWOR",79,0)
 N MDFDA
"RTN","MDWOR",80,0)
 S MDCON=$$PKGID^ORX8(MDIFN) I 'MDCON S MDFLG=1 Q
"RTN","MDWOR",81,0)
 Q
"RTN","MDWOR",82,0)
OBR ; Check OBR
"RTN","MDWOR",83,0)
 S MDPROC=$P(MDX,"|",5)
"RTN","MDWOR",84,0)
 I $E($P(MDPROC,"^",6),3,5)'["PRC" S MDFLG=1 Q
"RTN","MDWOR",85,0)
 S MDCPROC=$P(MDPROC,"^",4) I 'MDCPROC S MDFLG=1 Q
"RTN","MDWOR",86,0)
 ; Get Procedure for CP IEN
"RTN","MDWOR",87,0)
 S MDPROC=$$CPROC^GMRCCP(MDCPROC) I 'MDPROC S MDFLG=1 Q
"RTN","MDWOR",88,0)
 S MDSINP=$$HIGHV(MDPROC) I +MDSINP'>0 S MDFLG=1 Q
"RTN","MDWOR",89,0)
 S (MDINST,MDINT)=0 F MDIN=0:0 S MDIN=$O(^MDS(702.01,MDPROC,.1,MDIN)) Q:MDIN<1!(+MDINST)  S MDINT=+$G(^(MDIN,0)) D
"RTN","MDWOR",90,0)
 .I +$$GET1^DIQ(702.09,+MDINT,".13","I") S MDINST=MDINT Q
"RTN","MDWOR",91,0)
 I +$P(MDSINP,"^",2)=2 D  Q
"RTN","MDWOR",92,0)
 .I +MDINP S MDVSTD="",MDOBC=MDOBC+1 Q
"RTN","MDWOR",93,0)
 .S MDVSTD=MDREQ,MDOBC=MDOBC+1 Q
"RTN","MDWOR",94,0)
 I +$P(MDSINP,"^",2)=3 D  Q
"RTN","MDWOR",95,0)
 .I +MDINP S MDVSTD="",MDOBC=MDOBC+1 Q
"RTN","MDWOR",96,0)
 I +$P(MDSINP,"^",2)=1 D  Q
"RTN","MDWOR",97,0)
 .I '+MDINP S MDVSTD="" Q
"RTN","MDWOR",98,0)
 .S MDVSTD=MDREQ,MDOBC=MDOBC+1 Q
"RTN","MDWOR",99,0)
 ;I +MDINP&('$P(^MDS(702.01,MDPROC,0),"^",5)) S MDFLG=1 Q
"RTN","MDWOR",100,0)
 I +MDINP S MDVSTD=MDREQ,MDOBC=MDOBC+1 Q
"RTN","MDWOR",101,0)
 S MDVSTD=MDREQ,MDOBC=MDOBC+1 Q
"RTN","MDWOR",102,0)
 Q
"RTN","MDWOR",103,0)
CANCEL ; Cancel/Discontinue
"RTN","MDWOR",104,0)
 K MDR S MDIFN=+$P(MDX,"|",3),MDCON=+$P(MDX,"|",4),MDCANC=1
"RTN","MDWOR",105,0)
 I 'MDIFN S MDFLG=1 Q
"RTN","MDWOR",106,0)
 I 'MDCON S MDFLG=1 Q
"RTN","MDWOR",107,0)
 S MDPROV=+$P(MDX,"|",13) I 'MDPROV S MDFLG=1 Q
"RTN","MDWOR",108,0)
 S MDREQ=$P(MDX,"|",16) I 'MDREQ S MDFLG=1 Q
"RTN","MDWOR",109,0)
 ;
"RTN","MDWOR",110,0)
 ;MDINST is set to 0 initially, but setting again in case it was reset
"RTN","MDWOR",111,0)
 ;previously
"RTN","MDWOR",112,0)
 ;
"RTN","MDWOR",113,0)
 S MDINST=0
"RTN","MDWOR",114,0)
 F  S MDINST=$O(^MDD(702,"ACON",MDCON,MDINST)) Q:'MDINST  D
"RTN","MDWOR",115,0)
 . Q:$G(^MDD(702,+MDINST,0))=""
"RTN","MDWOR",116,0)
 . I "5"[$P(^MDD(702,+MDINST,0),U,9) S MDCANR=$$CANCEL^MDHL7B(+MDINST)
"RTN","MDWOR",117,0)
 . N MDFDA S MDFDA(702,MDINST_",",.09)=6
"RTN","MDWOR",118,0)
 . D FILE^DIE("K","MDFDA") K MDFDA
"RTN","MDWOR",119,0)
 . N MDHEMO S MDHEMO=+$$GET1^DIQ(702,+MDINST,".04:.06","I")
"RTN","MDWOR",120,0)
 . Q:MDHEMO<2
"RTN","MDWOR",121,0)
 . Q:$G(^MDK(704.202,+MDINST,0))=""
"RTN","MDWOR",122,0)
 . S MDFDA(704.202,+MDINST_",",.09)=0
"RTN","MDWOR",123,0)
 . D FILE^DIE("","MDFDA")
"RTN","MDWOR",124,0)
 . K ^MDK(704.202,"AS",1,+MDINST)
"RTN","MDWOR",125,0)
 . S ^MDK(704.202,"AS",0,+MDINST)=""
"RTN","MDWOR",126,0)
 Q
"RTN","MDWOR",127,0)
CHKIN(MDFN,MDREQ,MDPROV,MDATA,MDVSTD) ; [Procedure] Check In Study
"RTN","MDWOR",128,0)
 N MDCART,MDREZ,MDX1,MDFDA,MDIEN,MDIENS,MDERR,MDHL7,MDHOLD,MDSCHD,MDMAXD,MDXY,MDNOW S MDCART=0
"RTN","MDWOR",129,0)
 F MDX1=2:1:5 D
"RTN","MDWOR",130,0)
 .I $P(MDATA,U,MDX1)]"" S MDFDA(702,$P(MDATA,U,1),$P("^.04^.05^.11^.07",U,MDX1))=$P(MDATA,U,MDX1)
"RTN","MDWOR",131,0)
 ; Remove code after instrument testing available
"RTN","MDWOR",132,0)
 ; End of code removal after instrument available for testin
"RTN","MDWOR",133,0)
 S MDSCHD=$S($L(MDVSTD,";")=1:MDVSTD,1:$P(MDVSTD,";",2)),MDMAXD=DT+.24
"RTN","MDWOR",134,0)
 S MDFDA(702,$P(MDATA,U,1),.09)=$S(MDSCHD="":0,MDSCHD>MDMAXD:0,1:5)  ; Status = Checked-In
"RTN","MDWOR",135,0)
 I +$P(MDATA,U,4),+$G(^MDS(702.09,+$P(MDATA,U,4),"CS")) S MDCART=1
"RTN","MDWOR",136,0)
 I $P(MDATA,U,1)="+1," D
"RTN","MDWOR",137,0)
 .S MDFDA(702,"+1,",.01)=MDFN
"RTN","MDWOR",138,0)
 .S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDWOR",139,0)
 .S MDFDA(702,"+1,",.03)=MDPROV
"RTN","MDWOR",140,0)
 .S:+MDSCHD MDFDA(702,"+1,",.14)=MDSCHD
"RTN","MDWOR",141,0)
 .D UPDATE^DIE("","MDFDA","MDIEN","MDERR") Q:$D(MDERR)
"RTN","MDWOR",142,0)
 .Q:MDSCHD>MDMAXD!(MDSCHD="")
"RTN","MDWOR",143,0)
 .S MDIENS=MDIEN(1)_",",MDXY=+$P(MDATA,U,2),MDHOLD="" I +MDXY D
"RTN","MDWOR",144,0)
 ..Q:$P(^MDS(702.01,MDXY,0),U,6)'=2
"RTN","MDWOR",145,0)
 ..S MDHOLD=$P($G(^MDD(702,MDIEN(1),0)),"^",7),MDNOW=$$NOW^XLFDT()
"RTN","MDWOR",146,0)
 ..S $P(^MDD(702,MDIEN(1),0),"^",7)=MDSCHD
"RTN","MDWOR",147,0)
 .S MDHL7=$$SUB^MDHL7B(MDIEN(1))
"RTN","MDWOR",148,0)
 .I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDWOR",149,0)
 .I +MDHL7=1 S MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDWOR",150,0)
 .D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDWOR",151,0)
 I +MDCART>0 D
"RTN","MDWOR",152,0)
 .S MDREZ=$$NEWTIUN^MDRPCOT(+MDIEN(1))
"RTN","MDWOR",153,0)
 .I +MDREZ<0 D FILEMSG^MDRPCOT(+MDIEN(1),"TIU",2,MDREZ)
"RTN","MDWOR",154,0)
 .S MDREZ=$$SUBMIT^MDRPCOT1(MDIEN(1))
"RTN","MDWOR",155,0)
 .D FILEMSG^MDRPCOT(+MDIEN(1),"IMAGING",$S(+MDREZ>0:+MDREZ,1:2),MDREZ)
"RTN","MDWOR",156,0)
 Q:MDSCHD>MDMAXD!(MDSCHD="")
"RTN","MDWOR",157,0)
 D:+$G(MDIENS)
"RTN","MDWOR",158,0)
 .S MDXY=+$P(MDATA,U,2) Q:'MDXY
"RTN","MDWOR",159,0)
 .I $P(^MDS(702.01,MDXY,0),U,6)=2 D  Q  ; Renal Check-In
"RTN","MDWOR",160,0)
 ..D CP^MDKUTL(+MDIENS)
"RTN","MDWOR",161,0)
 ..S:$G(MDHOLD)'="" MDFDA(702,+MDIENS_",",.07)=MDHOLD
"RTN","MDWOR",162,0)
 ..S MDFDA(702,+MDIENS_",",.09)=5
"RTN","MDWOR",163,0)
 ..D FILE^DIE("","MDFDA","MDERR")
"RTN","MDWOR",164,0)
 Q
"RTN","MDWOR",165,0)
FMDTE(DATE) ; Convert HL-7 formatted date to a Fileman formatted date
"RTN","MDWOR",166,0)
 N X
"RTN","MDWOR",167,0)
 S X="" I DATE D
"RTN","MDWOR",168,0)
 .S X=$$HL7TFM^XLFDT(DATE,"L")
"RTN","MDWOR",169,0)
 Q X
"RTN","MDWOR",170,0)
HIGHV(MDHV) ; Return flag indicator whether procedure is use for auto check-in
"RTN","MDWOR",171,0)
 N MDANS,MDK,MDKY,MDLST S MDANS=0
"RTN","MDWOR",172,0)
 D GETLST^XPAR(.MDLST,"SYS","MD CHECK-IN PROCEDURE LIST")
"RTN","MDWOR",173,0)
 F MDK=0:0 S MDK=$O(MDLST(MDK)) Q:MDK<1  S MDKY=$G(MDLST(MDK)) D
"RTN","MDWOR",174,0)
 .I MDHV=+$P(MDKY,"^") S MDANS=MDKY
"RTN","MDWOR",175,0)
 Q MDANS
"RTN","MDWOR",176,0)
GETAPPT(MDDPAT,MDDA) ; Get appointment
"RTN","MDWOR",177,0)
 N DFN,MDALP,MDARES,MDCKDT K ^UTILITY("VASD",$J) S DFN=MDDPAT
"RTN","MDWOR",178,0)
 S X1=DT,X2=365 D C^%DTC S VASD("T")=X+.24,VASD("F")=DT,VASD("W")="129",VASD("C",+MDDA)=+MDDA D SDA^VADPT
"RTN","MDWOR",179,0)
 S MDARES=0 F MDALP=0:0 S MDALP=$O(^UTILITY("VASD",$J,MDALP)) Q:MDALP<1  D
"RTN","MDWOR",180,0)
 . S MDCKDT=$G(^(MDALP,"I")) ;this naked reference refers to the full reference to ^UTILITY("VASD" above
"RTN","MDWOR",181,0)
 . S MDARES=MDCKDT
"RTN","MDWOR",182,0)
 K ^UTILITY("VASD",$J),VASD,X1,X2,X
"RTN","MDWOR",183,0)
 Q MDARES
"RTN","MDWORSR")
0^2^B59105822^B59164885
"RTN","MDWORSR",1,0)
MDWORSR ; HOIFO/NCA - Daily Schedule Studies;Apr 4, 2018@11:53 ; 2/11/19 10:35am
"RTN","MDWORSR",2,0)
 ;;1.0;CLINICAL PROCEDURES;**14,11,21,20,54,69**;Apr 01,2004;Build 2
"RTN","MDWORSR",3,0)
 ; Reference IA# 2263 [Supported] XPAR calls
"RTN","MDWORSR",4,0)
 ;               3067 [Private] Read fields in Consult file (#123) w/FM
"RTN","MDWORSR",5,0)
 ;               3468 [Subscription] Call GMRCCP
"RTN","MDWORSR",6,0)
 ;               3869 [Subscription] SDAMA202 calls
"RTN","MDWORSR",7,0)
 ;               10035 [Supported] Patient File Access
"RTN","MDWORSR",8,0)
 ;               10103 [Supported] XLFDT calls
"RTN","MDWORSR",9,0)
 ;
"RTN","MDWORSR",10,0)
EN1 ; Entry Point to process scheduled studies
"RTN","MDWORSR",11,0)
 N MDACL,MDCON,MDCV,MDERR,MDFDA,MDHOLD,MDKK,MDL,MDL1,MDLSP,MDMAXD,MDNOW,MDSTAT,MDV,MDX,MDXY
"RTN","MDWORSR",12,0)
 S MDMAXD=DT+.24 K ^TMP("MDACLN",$J)
"RTN","MDWORSR",13,0)
 D GETLST^XPAR(.MDLSP,"SYS","MD CLINIC ASSOCIATION")
"RTN","MDWORSR",14,0)
 F MDKK=0:0 S MDKK=$O(MDLSP(MDKK)) Q:MDKK<1  S MDV=$P($G(MDLSP(MDKK)),"^",2) I +$P(MDV,";",2)>0 S MDACL=+MDV D
"RTN","MDWORSR",15,0)
 .S ^TMP("MDACLN",$J,+MDACL,+$P(MDV,";",2))=+$P(MDV,";",2)
"RTN","MDWORSR",16,0)
 S MDL=DT F  S MDL=$O(^MDD(702,"ASD",MDL)) Q:MDL<1!(MDL>MDMAXD)  F MDL1=0:0 S MDL1=$O(^MDD(702,"ASD",MDL,MDL1)) Q:MDL1<1  S MDX=$G(^MDD(702,MDL1,0)) D
"RTN","MDWORSR",17,0)
 .K MDFDA
"RTN","MDWORSR",18,0)
 .S MDCON=+$P(MDX,"^",5) Q:'MDCON
"RTN","MDWORSR",19,0)
 .S MDSTAT=$$GET1^DIQ(123,MDCON_",",8,"E")
"RTN","MDWORSR",20,0)
 .Q:MDSTAT="DISCONTINUED"!(MDSTAT="CANCELLED")
"RTN","MDWORSR",21,0)
 .Q:+$P(MDX,"^",9)>0
"RTN","MDWORSR",22,0)
 .S MDIENS=MDL1_",",MDXY=+$P(MDX,"^",4),MDHOLD="" I MDXY D
"RTN","MDWORSR",23,0)
 ..S MDHOLD=$P($G(^MDD(702,+MDL1,0)),"^",7),MDNOW=$$NOW^XLFDT()
"RTN","MDWORSR",24,0)
 ..S $P(^MDD(702,+MDL1,0),"^",7)=MDHOLD
"RTN","MDWORSR",25,0)
 .S MDCV=$P(MDHOLD,";",3)
"RTN","MDWORSR",26,0)
 .I +MDXY&(+MDCV) Q:$G(^TMP("MDACLN",$J,+MDCV,+MDXY))=""
"RTN","MDWORSR",27,0)
 .S MDHL7=$$SUB^MDHL7B(MDL1)
"RTN","MDWORSR",28,0)
 .I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDWORSR",29,0)
 .I +MDHL7=1 S MDFDA(702,MDIENS,.02)=$$NOW^XLFDT(),MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDWORSR",30,0)
 .D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",31,0)
 .S MDXY=+$P(MDX,"^",4) Q:'MDXY
"RTN","MDWORSR",32,0)
 .I $P(^MDS(702.01,MDXY,0),U,6)=2 D  Q  ; Renal Check-In
"RTN","MDWORSR",33,0)
 ..D CP^MDKUTL(+MDIENS)
"RTN","MDWORSR",34,0)
 ..S:$G(MDHOLD)'="" MDFDA(702,MDIENS,.07)=MDHOLD
"RTN","MDWORSR",35,0)
 ..S MDFDA(702,MDIENS,.09)=5
"RTN","MDWORSR",36,0)
 ..D FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",37,0)
 K ^TMP("MDACLN",$J)
"RTN","MDWORSR",38,0)
 Q
"RTN","MDWORSR",39,0)
CLINICPT ; Check-in CP study with multiple results
"RTN","MDWORSR",40,0)
 N MD,MDCDT,MDCL,MDCOM,MDCON,MDDT,MDDX,MDEND,MDERR,MDFDA,MDHEMO,MDHL7,MDIEN,MDIENS,MDK,MDLP,MDLST,MDMULT,MDNODE,MDNUM,MDPT,MDRET,MDSCHD,MDVSTR,MDY,MDY1,MDYR,X,X1,X2
"RTN","MDWORSR",41,0)
 N MDATYP,MDHOLD,MDLST1,MDLST2,MDNEW,MDT,MDY3,MDY4 S MDDT=DT\1,MDEND=DT+.24 N MDINP K ^TMP($J,"SDAMA202","GETPLIST"),^TMP("MDSTATUS",$J) S MDCOM=0,MDHOLD=""
"RTN","MDWORSR",42,0)
 K ^TMP("MDMULT",$J),^TMP("MDCLINIC",$J),^TMP("MDLST",$J)
"RTN","MDWORSR",43,0)
 S MDNUM=$$GET^XPAR("SYS","MD COMPL PROC DISPLAY DAYS",1)
"RTN","MDWORSR",44,0)
 I +MDNUM>0 S X1=DT,X2=-MDNUM D C^%DTC S MDCOM=X
"RTN","MDWORSR",45,0)
 D GETLST^XPAR(.MDLST,"SYS","MD CLINIC ASSOCIATION")
"RTN","MDWORSR",46,0)
 F MDLP=0:0 S MDLP=$O(^MDD(702,"AS",0,MDLP)) Q:MDLP<1  D
"RTN","MDWORSR",47,0)
 .S MDY=$G(^MDD(702,MDLP,0)) Q:+$P(MDY,"^",9)>0
"RTN","MDWORSR",48,0)
 .Q:$P(MDY,"^",7)'=""
"RTN","MDWORSR",49,0)
 .Q:'+$P(MDY,"^",5)!($P(MDY,"^",6)'="")
"RTN","MDWORSR",50,0)
 .Q:'+MDY
"RTN","MDWORSR",51,0)
 .I '+$G(^TMP("MDSTATUS",$J,+MDY,+$P(MDY,"^",4))) S ^TMP("MDSTATUS",$J,+MDY,+$P(MDY,"^",4))=+MDLP
"RTN","MDWORSR",52,0)
 .Q
"RTN","MDWORSR",53,0)
 ; Combine clinics with multiple procedures to regular clinics
"RTN","MDWORSR",54,0)
 S MDLST2=$S(+MDLST>0:MDLST,1:0)
"RTN","MDWORSR",55,0)
 ; Match new studies with 0 status to appointments
"RTN","MDWORSR",56,0)
 N MDXX K MDY F MDK=0:0 S MDK=$O(MDLST(MDK)) Q:MDK<1  S MDY=$P($G(MDLST(MDK)),"^",2) I +$P(MDY,";",2)>0 S MDCL=+MDY D
"RTN","MDWORSR",57,0)
 .S:$G(^TMP("MDCLINIC",$J,+MDCL))="" ^TMP("MDCLINIC",$J,+MDCL)=+MDCL
"RTN","MDWORSR",58,0)
 .S ^TMP("MDLST",$J,+MDCL,+$P(MDY,";",2))=+$P(MDY,";",2)
"RTN","MDWORSR",59,0)
 .S MDMULT=+$$GET1^DIQ(702.01,+$P(MDY,";",2)_",",.12,"I")
"RTN","MDWORSR",60,0)
 .S MDHEMO=+$$GET1^DIQ(702.01,+$P(MDY,";",2)_",",.06,"I")
"RTN","MDWORSR",61,0)
 .Q:MDMULT'=1&(MDHEMO<2)
"RTN","MDWORSR",62,0)
 .S ^TMP("MDMULT",$J,+MDK)=+MDCL_";"_+$P(MDY,";",2)
"RTN","MDWORSR",63,0)
 .Q
"RTN","MDWORSR",64,0)
 K MDLST,MDY F MDK=0:0 S MDK=$O(^TMP("MDCLINIC",$J,MDK)) Q:MDK<1  S MDY=MDK D
"RTN","MDWORSR",65,0)
 .K ^TMP($J,"SDAMA202","GETPLIST") S MDCL=+MDY
"RTN","MDWORSR",66,0)
 .D GETPLIST^SDAMA202(+MDY,"1;4;3","R",MDDT,MDEND,.MDRET,"")
"RTN","MDWORSR",67,0)
 .F MD=0:0 S MD=$O(^TMP($J,"SDAMA202","GETPLIST",MD)) Q:'MD  D
"RTN","MDWORSR",68,0)
 ..S MDY1=+$G(^TMP($J,"SDAMA202","GETPLIST",MD,4)) Q:MDY1<1
"RTN","MDWORSR",69,0)
 ..S MDSCHD=+$G(^TMP($J,"SDAMA202","GETPLIST",MD,1))
"RTN","MDWORSR",70,0)
 ..S MDATYP=$G(^TMP($J,"SDAMA202","GETPLIST",MD,3)) Q:MDATYP=""
"RTN","MDWORSR",71,0)
 ..Q:"RINT"'[MDATYP
"RTN","MDWORSR",72,0)
 ..S MDT=MDK,MDDX=+$$MATCH(+MDY1,MDT) Q:'MDDX
"RTN","MDWORSR",73,0)
 ..S MDMULT=+$$GET1^DIQ(702,+MDDX,".04:.12","I")
"RTN","MDWORSR",74,0)
 ..S MDHEMO=+$$GET1^DIQ(702,+MDDX,".04:.06","I"),MDIENS=+MDDX_","
"RTN","MDWORSR",75,0)
 ..S MDFDA(702,MDIENS,.02)=$$NOW^XLFDT()
"RTN","MDWORSR",76,0)
 ..S MDFDA(702,MDIENS,.07)="A;"_MDSCHD_";"_MDCL
"RTN","MDWORSR",77,0)
 ..S MDFDA(702,MDIENS,.14)=MDSCHD
"RTN","MDWORSR",78,0)
 ..D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR") K MDFDA
"RTN","MDWORSR",79,0)
 ..I MDHEMO=2 S MDHOLD=$P($G(^MDD(702,+MDIENS,0)),"^",7),MDNEW=$$NOW^XLFDT(),$P(^MDD(702,+MDIENS,0),"^",7)=MDSCHD
"RTN","MDWORSR",80,0)
 ..S MDHL7=$$SUB^MDHL7B(+MDIENS)
"RTN","MDWORSR",81,0)
 ..I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDWORSR",82,0)
 ..I +MDHL7=1 S MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDWORSR",83,0)
 ..D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",84,0)
 ..Q:'+$G(MDIENS)
"RTN","MDWORSR",85,0)
 ..I MDHEMO=2 D CP^MDKUTL(+MDIENS) S:$G(MDHOLD)'="" MDFDA(702,+MDIENS_",",.07)=MDHOLD S MDFDA(702,+MDIENS_",",.09)=5 D FILE^DIE("","MDFDA","MDERR") K MDFDA
"RTN","MDWORSR",86,0)
 ..Q
"RTN","MDWORSR",87,0)
 .Q
"RTN","MDWORSR",88,0)
 ; Match the rest of appointments with previous studies
"RTN","MDWORSR",89,0)
 N MDGET,MDINST S X1=DT,X2=-365 D C^%DTC S MDCDT=X
"RTN","MDWORSR",90,0)
 K MDY F MDK=0:0 S MDK=$O(^TMP("MDMULT",$J,MDK)) Q:MDK<1  S MDY=$G(^(MDK)) I +$P(MDY,";",2)>0 S MDCL=+MDY D
"RTN","MDWORSR",91,0)
 .K ^TMP($J,"SDAMA202","GETPLIST")
"RTN","MDWORSR",92,0)
 .D GETPLIST^SDAMA202(+MDY,"1;4;3","R",MDDT,MDEND,.MDRET,"")
"RTN","MDWORSR",93,0)
 .F MD=0:0 S MD=$O(^TMP($J,"SDAMA202","GETPLIST",MD)) Q:'MD  D
"RTN","MDWORSR",94,0)
 ..S MDINP=0
"RTN","MDWORSR",95,0)
 ..S MDY1=+$G(^TMP($J,"SDAMA202","GETPLIST",MD,4)) Q:MDY1<1
"RTN","MDWORSR",96,0)
 ..S MDSCHD=+$G(^TMP($J,"SDAMA202","GETPLIST",MD,1))
"RTN","MDWORSR",97,0)
 ..S MDATYP=$G(^TMP($J,"SDAMA202","GETPLIST",MD,3))
"RTN","MDWORSR",98,0)
 ..Q:"RINT"'[MDATYP
"RTN","MDWORSR",99,0)
 ..S MDPT=MDY1 Q:+$$GSTUDY(MDPT,MDSCHD)
"RTN","MDWORSR",100,0)
 ..S MDDX=$$GETC(MDPT,+$P(MDY,";",2)) Q:'+MDDX
"RTN","MDWORSR",101,0)
 ..S MDNODE=$G(^MDD(702,+MDDX,0))
"RTN","MDWORSR",102,0)
 ..S:$G(^DPT(MDY1,.105))'="" MDINP=1
"RTN","MDWORSR",103,0)
 ..S MDCON=$P(MDNODE,"^",5) Q:'MDCON
"RTN","MDWORSR",104,0)
 ..S MDVSTR=$P(MDNODE,"^",7) Q:MDVSTR=""
"RTN","MDWORSR",105,0)
 ..S MDMULT=+$$GET1^DIQ(702,+MDDX,".04:.12","I")
"RTN","MDWORSR",106,0)
 ..S MDHEMO=+$$GET1^DIQ(702,+MDDX,".04:.06","I")
"RTN","MDWORSR",107,0)
 ..S MDYR=$S(MDMULT<1:MDCOM,1:MDCDT)
"RTN","MDWORSR",108,0)
 ..Q:$P(MDNODE,"^",2)<MDYR
"RTN","MDWORSR",109,0)
 ..Q:'$P(MDNODE,"^",9)
"RTN","MDWORSR",110,0)
 ..Q:$P(MDNODE,"^",9)>3
"RTN","MDWORSR",111,0)
 ..Q:$P(MDVSTR,";",2)=MDSCHD
"RTN","MDWORSR",112,0)
 ..S MDINST=+$$GINST(+$P(MDNODE,"^",4)) Q:'MDINST
"RTN","MDWORSR",113,0)
 ..K MDFDA,MDERR,MDIEN
"RTN","MDWORSR",114,0)
 ..S MDFDA(702,"+1,",.01)=MDY1
"RTN","MDWORSR",115,0)
 ..S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDWORSR",116,0)
 ..S MDFDA(702,"+1,",.03)=$P(MDNODE,"^",3)
"RTN","MDWORSR",117,0)
 ..S MDFDA(702,"+1,",.04)=$P(MDNODE,"^",4)
"RTN","MDWORSR",118,0)
 ..S MDFDA(702,"+1,",.05)=MDCON
"RTN","MDWORSR",119,0)
 ..S MDFDA(702,"+1,",.07)="A;"_MDSCHD_";"_MDCL
"RTN","MDWORSR",120,0)
 ..S MDFDA(702,"+1,",.11)=+MDINST
"RTN","MDWORSR",121,0)
 ..S MDFDA(702,"+1,",.14)=MDSCHD
"RTN","MDWORSR",122,0)
 ..D UPDATE^DIE("","MDFDA","MDIEN","MDERR") Q:$D(MDERR)  K MDFDA
"RTN","MDWORSR",123,0)
 ..S MDIENS=MDIEN(1)_"," I MDHEMO=2 S MDHOLD=$P($G(^MDD(702,MDIEN(1),0)),"^",7),MDNOW=$$NOW^XLFDT(),$P(^MDD(702,MDIEN(1),0),"^",7)=MDSCHD
"RTN","MDWORSR",124,0)
 ..S MDHL7=$$SUB^MDHL7B(MDIEN(1))
"RTN","MDWORSR",125,0)
 ..I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDWORSR",126,0)
 ..I +MDHL7=1 S MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDWORSR",127,0)
 ..D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",128,0)
 ..Q:'+$G(MDIENS)
"RTN","MDWORSR",129,0)
 ..I MDHEMO=2 D CP^MDKUTL(+MDIENS) K MDFDA S:$G(MDHOLD)'="" MDFDA(702,+MDIENS_",",.07)=MDHOLD S MDFDA(702,+MDIENS_",",.09)=5 D FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",130,0)
 K ^TMP($J,"SDAMA202","GETPLIST"),^TMP("MDSTATUS",$J),MDFDA
"RTN","MDWORSR",131,0)
 K ^TMP("MDCLINIC",$J),^TMP("MDMULT",$J),^TMP("MDLST",$J)
"RTN","MDWORSR",132,0)
 Q
"RTN","MDWORSR",133,0)
GETC(MDPAT,MDDA) ; Get consult date
"RTN","MDWORSR",134,0)
 N MDX,MDCF S MDCF=0 K ^TMP("MDTMP",$J) D CPLIST^GMRCCP(MDPAT,+MDDA,$NA(^TMP("MDTMP",$J)))
"RTN","MDWORSR",135,0)
 S MDX=$O(^TMP("MDTMP",$J,""),-1) Q:'+MDX 0
"RTN","MDWORSR",136,0)
 I "saprc"'[$P($G(^TMP("MDTMP",$J,MDX)),U,4) S MDX=$O(^TMP("MDTMP",$J,MDX),-1) Q:'+MDX 0
"RTN","MDWORSR",137,0)
 I "saprc"[$P($G(^TMP("MDTMP",$J,MDX)),U,4) S MDCF=$P($G(^TMP("MDTMP",$J,MDX)),U,5)_"^"_$P($G(^TMP("MDTMP",$J,MDX)),U,1)
"RTN","MDWORSR",138,0)
 K ^TMP("MDTMP",$J)
"RTN","MDWORSR",139,0)
 Q $S(+MDCF:+$O(^MDD(702,"ACON",+MDCF,""),-1)_"^"_$P(MDCF,"^",2)_"^"_+MDCF_"^"_$P(MDCF,"^",6),1:0)
"RTN","MDWORSR",140,0)
GINST(MDDA) ; Get instrument from CP Definition
"RTN","MDWORSR",141,0)
 N MDIN,MDINT,Y1 S (MDINT,Y1)=0
"RTN","MDWORSR",142,0)
 F MDIN=0:0 S MDIN=$O(^MDS(702.01,+MDDA,.1,MDIN)) Q:MDIN<1!(+Y1)  S MDINT=+$G(^(MDIN,0)) I +$$GET1^DIQ(702.09,MDINT,".13","I") S Y1=MDINT
"RTN","MDWORSR",143,0)
 Q Y1
"RTN","MDWORSR",144,0)
GSTUDY(MDPAT,MDDA) ;Get study for scheduled date/time
"RTN","MDWORSR",145,0)
 N MDIN,Y1 S Y1=0
"RTN","MDWORSR",146,0)
 F MDIN=0:0 S MDIN=$O(^MDD(702,"ASD",MDDA,MDIN)) Q:MDIN<1!(Y1>0)  D
"RTN","MDWORSR",147,0)
 .S:$P($G(^MDD(702,MDIN,0)),"^")=MDPAT Y1=1
"RTN","MDWORSR",148,0)
 Q Y1
"RTN","MDWORSR",149,0)
GPRO(MDPAT,MDCLIN) ; Get procedure for study
"RTN","MDWORSR",150,0)
 N MDX,MDCF,MDCFX S MDCF="" K ^TMP("MDTMP",$J) D CPLIST^GMRCCP(MDPAT,,$NA(^TMP("MDTMP",$J)))
"RTN","MDWORSR",151,0)
 S MDX=0 F  S MDX=$O(^TMP("MDTMP",$J,MDX)) Q:'MDX!(MDCF'="")  D:"sap"[$P(^(MDX),U,4)
"RTN","MDWORSR",152,0)
 .S MDCFX=$G(^TMP("MDTMP",$J,MDX)) Q:'+$G(^TMP("MDLST",$J,MDCLIN,+$P(MDCFX,"^",6)))
"RTN","MDWORSR",153,0)
 .Q:+$O(^MDD(702,"ACON",+$P(MDCFX,"^",5),0))  S MDCF=MDCFX Q
"RTN","MDWORSR",154,0)
 K ^TMP("MDTMP",$J)
"RTN","MDWORSR",155,0)
 Q $S(MDCF'="":MDCF,1:0)
"RTN","MDWORSR",156,0)
MATCH(MDPAT,MDCLIN) ; Match study to appointment
"RTN","MDWORSR",157,0)
 N MDI,MDY2 S MDY2=0
"RTN","MDWORSR",158,0)
 F MDI=0:0 S MDI=$O(^TMP("MDSTATUS",$J,MDPAT,MDI)) Q:MDI<1!(+MDY2)  D
"RTN","MDWORSR",159,0)
 .I +$G(^TMP("MDLST",$J,MDCLIN,MDI)) S MDY2=+$G(^TMP("MDSTATUS",$J,MDPAT,MDI))
"RTN","MDWORSR",160,0)
 Q MDY2
"RTN","MDWORSR",161,0)
ADD(MDPAT,MDY3,MDY4,MDCLIN,MDSC) ; Add study, if none exist
"RTN","MDWORSR",162,0)
 N MDFDA,MDERR,MDIENS,MDP,MDPS
"RTN","MDWORSR",163,0)
 Q:'MDY3
"RTN","MDWORSR",164,0)
 K MDFDA,MDERR,MDIENN
"RTN","MDWORSR",165,0)
 S MDP=$O(^MDD(702,"B",MDPAT,0)),MDPS=$G(^MDD(702,+MDP,0))
"RTN","MDWORSR",166,0)
 S MDFDA(702,"+1,",.01)=MDPAT
"RTN","MDWORSR",167,0)
 S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDWORSR",168,0)
 S MDFDA(702,"+1,",.03)=$S(+$P(MDPS,"^",3):$P(MDPS,"^",3),1:DUZ)
"RTN","MDWORSR",169,0)
 S MDFDA(702,"+1,",.04)=+MDY3
"RTN","MDWORSR",170,0)
 S MDFDA(702,"+1,",.05)=+MDY4
"RTN","MDWORSR",171,0)
 S MDFDA(702,"+1,",.07)="A;"_MDSC_";"_MDCLIN
"RTN","MDWORSR",172,0)
 S MDFDA(702,"+1,",.11)=+$$GINST(+MDY3)
"RTN","MDWORSR",173,0)
 D UPDATE^DIE("","MDFDA","MDIENN","MDERR") Q:$D(MDERR) 0
"RTN","MDWORSR",174,0)
 K MDFDA
"RTN","MDWORSR",175,0)
 Q MDIENN(1)
"VER")
8.0^22.2
"BLD",11013,6)
^53
**END**
**END**

