Released MD*1*43 SEQ #45
Extracted from mail message
**KIDS**:MD*1.0*43^

**INSTALL NAME**
MD*1.0*43
"BLD",9944,0)
MD*1.0*43^CLINICAL PROCEDURES^0^3180907^y
"BLD",9944,1,0)
^^4^4^3180906^
"BLD",9944,1,1,0)
The purpose of this patch is to provide a software bug fix for Clinical 
"BLD",9944,1,2,0)
Procedures functionality.  This patch addresses the following issues:
"BLD",9944,1,3,0)
 
"BLD",9944,1,4,0)
-Duplicate reports with the same time stamp
"BLD",9944,4,0)
^9.64PA^^
"BLD",9944,6)
4^
"BLD",9944,6.3)
7
"BLD",9944,"ABPKG")
n
"BLD",9944,"KRN",0)
^9.67PA^779.2^20
"BLD",9944,"KRN",.4,0)
.4
"BLD",9944,"KRN",.401,0)
.401
"BLD",9944,"KRN",.402,0)
.402
"BLD",9944,"KRN",.403,0)
.403
"BLD",9944,"KRN",.5,0)
.5
"BLD",9944,"KRN",.84,0)
.84
"BLD",9944,"KRN",3.6,0)
3.6
"BLD",9944,"KRN",3.8,0)
3.8
"BLD",9944,"KRN",9.2,0)
9.2
"BLD",9944,"KRN",9.8,0)
9.8
"BLD",9944,"KRN",9.8,"NM",0)
^9.68A^3^1
"BLD",9944,"KRN",9.8,"NM",3,0)
MDRPCOT^^0^B89860576
"BLD",9944,"KRN",9.8,"NM","B","MDRPCOT",3)

"BLD",9944,"KRN",19,0)
19
"BLD",9944,"KRN",19,"NM",0)
^9.68A^^
"BLD",9944,"KRN",19.1,0)
19.1
"BLD",9944,"KRN",101,0)
101
"BLD",9944,"KRN",409.61,0)
409.61
"BLD",9944,"KRN",771,0)
771
"BLD",9944,"KRN",779.2,0)
779.2
"BLD",9944,"KRN",870,0)
870
"BLD",9944,"KRN",8989.51,0)
8989.51
"BLD",9944,"KRN",8989.52,0)
8989.52
"BLD",9944,"KRN",8994,0)
8994
"BLD",9944,"KRN","B",.4,.4)

"BLD",9944,"KRN","B",.401,.401)

"BLD",9944,"KRN","B",.402,.402)

"BLD",9944,"KRN","B",.403,.403)

"BLD",9944,"KRN","B",.5,.5)

"BLD",9944,"KRN","B",.84,.84)

"BLD",9944,"KRN","B",3.6,3.6)

"BLD",9944,"KRN","B",3.8,3.8)

"BLD",9944,"KRN","B",9.2,9.2)

"BLD",9944,"KRN","B",9.8,9.8)

"BLD",9944,"KRN","B",19,19)

"BLD",9944,"KRN","B",19.1,19.1)

"BLD",9944,"KRN","B",101,101)

"BLD",9944,"KRN","B",409.61,409.61)

"BLD",9944,"KRN","B",771,771)

"BLD",9944,"KRN","B",779.2,779.2)

"BLD",9944,"KRN","B",870,870)

"BLD",9944,"KRN","B",8989.51,8989.51)

"BLD",9944,"KRN","B",8989.52,8989.52)

"BLD",9944,"KRN","B",8994,8994)

"BLD",9944,"QUES",0)
^9.62^^
"BLD",9944,"REQB",0)
^9.611^1^1
"BLD",9944,"REQB",1,0)
MD*1.0*21^1
"BLD",9944,"REQB","B","MD*1.0*21",1)

"MBREQ")
0
"PKG",569,-1)
1^1
"PKG",569,0)
CLINICAL PROCEDURES^MD^Clinical Procedures
"PKG",569,20,0)
^9.402P^^
"PKG",569,22,0)
^9.49I^1^1
"PKG",569,22,1,0)
1.0^3040521^3040615^1017
"PKG",569,22,1,"PAH",1,0)
43^3180907^15000044
"PKG",569,22,1,"PAH",1,1,0)
^^4^4^3180907
"PKG",569,22,1,"PAH",1,1,1,0)
The purpose of this patch is to provide a software bug fix for Clinical 
"PKG",569,22,1,"PAH",1,1,2,0)
Procedures functionality.  This patch addresses the following issues:
"PKG",569,22,1,"PAH",1,1,3,0)
 
"PKG",569,22,1,"PAH",1,1,4,0)
-Duplicate reports with the same time stamp
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","MDRPCOT")
0^3^B89860576^B85701277
"RTN","MDRPCOT",1,0)
MDRPCOT ; HOIFO/DP/NCA - Object RPCs (TMDTransaction) ; 5/9/18 1:07pm
"RTN","MDRPCOT",2,0)
 ;;1.0;CLINICAL PROCEDURES;**5,6,11,21,43**;Apr 01, 2004;Build 7
"RTN","MDRPCOT",3,0)
 ; Integration Agreements:
"RTN","MDRPCOT",4,0)
 ; IA# 2693 [Subscription] TIU Extractions.
"RTN","MDRPCOT",5,0)
 ; IA# 2944 [Subscription] Calls to TIUSRVR1.
"RTN","MDRPCOT",6,0)
 ; IA# 3535 [Subscription] Calls to TIUSRVP.
"RTN","MDRPCOT",7,0)
 ; IA# 10103 [Supported] Call to XLFDT
"RTN","MDRPCOT",8,0)
 ; IA# 10104 [Supported] Routine XLFSTR calls
"RTN","MDRPCOT",9,0)
ADDMSG ; [Procedure] Add message to transaction
"RTN","MDRPCOT",10,0)
 N MDIEN,MDIENS,MDRET
"RTN","MDRPCOT",11,0)
 Q:'$G(DATA("TRANSACTION"))
"RTN","MDRPCOT",12,0)
 Q:$G(DATA("MESSAGE"))=""
"RTN","MDRPCOT",13,0)
 S MDIEN=+DATA("TRANSACTION"),MDIENS="+1,"_MDIEN_","
"RTN","MDRPCOT",14,0)
 D NOW^%DTC S DATA("DATE")=% K %
"RTN","MDRPCOT",15,0)
 S MDFDA(702.091,MDIENS,.01)=+$O(^MDD(702,+MDIEN,.091,"A"),-1)+1
"RTN","MDRPCOT",16,0)
 S MDFDA(702.091,MDIENS,.02)=DATA("DATE")
"RTN","MDRPCOT",17,0)
 S MDFDA(702.091,MDIENS,.03)=$G(DATA("PKG"),"UNKNOWN")
"RTN","MDRPCOT",18,0)
 S MDFDA(702.091,MDIENS,.09)=DATA("MESSAGE")
"RTN","MDRPCOT",19,0)
 D UPDATE^DIE("","MDFDA","MDRET")
"RTN","MDRPCOT",20,0)
 Q
"RTN","MDRPCOT",21,0)
 ;
"RTN","MDRPCOT",22,0)
DELETE ; [Procedure] Delete Study
"RTN","MDRPCOT",23,0)
 ; Sets @RESULTS@(0)="-1^Reason for not deleting" or "1^Study Deleted"
"RTN","MDRPCOT",24,0)
 ;
"RTN","MDRPCOT",25,0)
 N MDAST,MDHOLD,MDNOTE,MDRES,MDSIEN,BODY,SUBJECT,DEVIEN
"RTN","MDRPCOT",26,0)
 S (MDHOLD,MDSIEN)=+DATA,MDRES=0,MDNOTE=""
"RTN","MDRPCOT",27,0)
 D ALERT^MDHL7U3(MDSIEN) ; Builds the body of the mail message
"RTN","MDRPCOT",28,0)
 I $G(^MDD(702,+MDSIEN,0))="" S @RESULTS@(0)="1^Study Deleted." D NOTICE^MDHL7U3(SUBJECT,.BODY,DEVIEN,DUZ) Q  ;deleting message
"RTN","MDRPCOT",29,0)
 S:+$P(^MDD(702,MDSIEN,0),U,6) MDNOTE=$P(^MDD(702,MDSIEN,0),U,6)
"RTN","MDRPCOT",30,0)
 I "13"[$P(^MDD(702,MDSIEN,0),U,9) S @RESULTS@(0)="-1^Can't Delete TIU Note from a "_$$GET1^DIQ(702,MDSIEN,.09,"E")_" Study." Q
"RTN","MDRPCOT",31,0)
 I "5"[$P(^MDD(702,MDSIEN,0),U,9) S MDCANR=$$CANCEL^MDHL7B(MDHOLD) I +MDCANR<0 S @RESULTS@(0)="-1^"_$P(MDCANR,"^",2) Q
"RTN","MDRPCOT",32,0)
 I +MDNOTE S MDRES="" D DELETE^TIUSRVP(.MDRES,MDNOTE)
"RTN","MDRPCOT",33,0)
 I MDRES D  Q
"RTN","MDRPCOT",34,0)
 .D STATUS(MDSIEN_",",2,$P(MDRES,"^",2))
"RTN","MDRPCOT",35,0)
 .S DATA("TRANSACTION")=MDSIEN,DATA("PKG")="TIU"
"RTN","MDRPCOT",36,0)
 .S DATA("MESSAGE")=$P(MDRES,"^",2) D ADDMSG
"RTN","MDRPCOT",37,0)
 .S @RESULTS@(0)="-1^"_$P(MDRES,"^",2)
"RTN","MDRPCOT",38,0)
 .Q
"RTN","MDRPCOT",39,0)
 E  D
"RTN","MDRPCOT",40,0)
 .I $D(^MDD(702.001,"ASTUDY",MDSIEN)) S @RESULTS@(0)="-1^Note associated with study, can not delete." Q
"RTN","MDRPCOT",41,0)
 .S MDAST=$$HL7CHK^MDHL7U3(+MDSIEN) I +MDAST<1 S @RESULTS@(0)=MDAST Q
"RTN","MDRPCOT",42,0)
 .D NOTICE^MDHL7U3(SUBJECT,.BODY,DEVIEN,DUZ) ; delete message
"RTN","MDRPCOT",43,0)
 .S MDFDA(702,DATA_",",.01)=""
"RTN","MDRPCOT",44,0)
 .; Check for renal study to delete as well
"RTN","MDRPCOT",45,0)
 .S:$D(^MDK(704.202,DATA)) MDFDA(704.202,DATA_",",.01)=""
"RTN","MDRPCOT",46,0)
 .D FILE^DIE("","MDFDA")
"RTN","MDRPCOT",47,0)
 .N DA,DIK S DA=+MDSIEN,DIK="^MDD(702," D ^DIK
"RTN","MDRPCOT",48,0)
 .S @RESULTS@(0)="1^Study Deleted."
"RTN","MDRPCOT",49,0)
 .Q
"RTN","MDRPCOT",50,0)
 Q
"RTN","MDRPCOT",51,0)
 ;
"RTN","MDRPCOT",52,0)
FILEMSG(STUDY,MDPKG,MDSTAT,MDMSG) ; [Procedure] File Study Status and Message.
"RTN","MDRPCOT",53,0)
 S DATA("TRANSACTION")=STUDY,DATA("PKG")=MDPKG
"RTN","MDRPCOT",54,0)
 S DATA("MESSAGE")=$P(MDMSG,"^",2)
"RTN","MDRPCOT",55,0)
 D STATUS(STUDY_",",MDSTAT,$P(MDMSG,"^",2)),ADDMSG
"RTN","MDRPCOT",56,0)
 Q
"RTN","MDRPCOT",57,0)
 ;
"RTN","MDRPCOT",58,0)
FILES ; [Procedure] Add/remove an attachment to this transaction
"RTN","MDRPCOT",59,0)
 NEW MDFDA,MDIEN,MDIENS,MDRET,MDT,MDT1,P1,P2,P3,P4
"RTN","MDRPCOT",60,0)
 S P1=$P(DATA,U,1),P2=$P(DATA,U,2),P3=$P(DATA,U,3),P4=$P(DATA,U,4)
"RTN","MDRPCOT",61,0)
 S MDIEN=0 I $G(^MDD(702,+P1,0))="" Q
"RTN","MDRPCOT",62,0)
 S MDT=+P1,MDT1=$$MULT^MDRPCOT1(MDT),MDT=$S('MDT1:1,MDT1=1:1,1:0)
"RTN","MDRPCOT",63,0)
 ;I +MDT,$P($G(^MDD(702,+P1,0)),"^",9)=3 S @RESULTS@(0)="1^Study is already complete" Q
"RTN","MDRPCOT",64,0)
 I $P($G(^MDD(702,+P1,0)),"^",9)=6 S @RESULTS@(0)="1^Study is already cancelled" Q
"RTN","MDRPCOT",65,0)
 ; Look for file (All comparisons done on lower case values)
"RTN","MDRPCOT",66,0)
 F  S MDIEN=$O(^MDD(702,P1,.1,MDIEN)) Q:'MDIEN  D  Q:X=P3
"RTN","MDRPCOT",67,0)
 .S X=$$LOW^XLFSTR($G(^MDD(702,P1,.1,MDIEN,.1)))
"RTN","MDRPCOT",68,0)
 I +MDT,MDIEN,P4 S @RESULTS@(0)="1^File already assigned" Q
"RTN","MDRPCOT",69,0)
 I 'MDIEN&'P4 S @RESULTS@(0)="1^File not assigned" Q
"RTN","MDRPCOT",70,0)
 I P4 D  Q  ; Add a file
"RTN","MDRPCOT",71,0)
 .S MDIENS="+1,"_P1_","
"RTN","MDRPCOT",72,0)
 .L +^MDD(702,P1,0):0 I '$T S @RESULTS@(0)="1^Study locked" Q  ;43 - add lock
"RTN","MDRPCOT",73,0)
 .S MDFDA(702.1,MDIENS,.01)=$O(^MDD(702,P1,.1,"B",""),-1)+1
"RTN","MDRPCOT",74,0)
 .S MDFDA(702.1,MDIENS,.02)=$S(P2:"I",1:"U")
"RTN","MDRPCOT",75,0)
 .I P2 S MDFDA(702.1,MDIENS,.03)=P2
"RTN","MDRPCOT",76,0)
 .S MDFDA(702.1,MDIENS,.1)=P3
"RTN","MDRPCOT",77,0)
 .D UPDATE^DIE("","MDFDA","MDIEN")
"RTN","MDRPCOT",78,0)
 .S @RESULTS@(0)=+$G(MDIEN(1),-1)
"RTN","MDRPCOT",79,0)
 .L -^MDD(702,P1,0)  ;43 - add unlock
"RTN","MDRPCOT",80,0)
 I 'P4 D  Q  ; Remove the file
"RTN","MDRPCOT",81,0)
 .S MDFDA(702.1,MDIEN_","_P1_",",.01)="@"
"RTN","MDRPCOT",82,0)
 .D FILE^DIE("","MDFDA","MDRET")
"RTN","MDRPCOT",83,0)
 .S @RESULTS@(0)=$S($D(MDRET):-1,1:1)
"RTN","MDRPCOT",84,0)
 Q
"RTN","MDRPCOT",85,0)
 ;
"RTN","MDRPCOT",86,0)
GETATT ; [Procedure] Get Attachments
"RTN","MDRPCOT",87,0)
 F X=0:0 S X=$O(^MDD(702,DATA,.1,X)) Q:'X  D
"RTN","MDRPCOT",88,0)
 .S Y=$O(@RESULTS@(""),-1)+1
"RTN","MDRPCOT",89,0)
 .S @RESULTS@(Y)=$P(^MDD(702,DATA,.1,X,0),U,1,3)
"RTN","MDRPCOT",90,0)
 .S $P(@RESULTS@(Y),U,4)=$G(^MDD(702,DATA,.1,X,.1))
"RTN","MDRPCOT",91,0)
 S @RESULTS@(0)=+$O(@RESULTS@(""),-1)
"RTN","MDRPCOT",92,0)
 Q
"RTN","MDRPCOT",93,0)
 ;
"RTN","MDRPCOT",94,0)
GETERR ; [Procedure] Return list of Imaging Errors
"RTN","MDRPCOT",95,0)
 ; DATA = Transaction IEN
"RTN","MDRPCOT",96,0)
 F MDX=0:0 S MDX=$O(^MDD(702,DATA,.091,MDX)) Q:'MDX  D
"RTN","MDRPCOT",97,0)
 .S MDY=+^MDD(702,DATA,.091,MDX,0)_U,Y=$P(^(0),U,2)
"RTN","MDRPCOT",98,0)
 .D D^DIQ S MDY=MDY_Y_U
"RTN","MDRPCOT",99,0)
 .S MDY=MDY_$P(^MDD(702,DATA,.091,MDX,0),U,3)_U_$P(^(0),U,9)
"RTN","MDRPCOT",100,0)
 .S ^TMP($J,$O(^TMP($J,""),-1)+1)=MDY
"RTN","MDRPCOT",101,0)
 S ^TMP($J,0)=+$O(^TMP($J,""),-1)
"RTN","MDRPCOT",102,0)
 Q
"RTN","MDRPCOT",103,0)
 ;
"RTN","MDRPCOT",104,0)
NEWSTAT ; [Procedure] RPC Call to set status
"RTN","MDRPCOT",105,0)
 S MDFDA(702,DATA,.09)=TYPE
"RTN","MDRPCOT",106,0)
 D FILE^DIE("","MDFDA")
"RTN","MDRPCOT",107,0)
 I TYPE=3&($G(^MDK(704.202,+DATA,0))'="") K MDFDA S MDFDA(704.202,DATA,.09)=0 D FILE^DIE("","MDFDA") K MDFDA
"RTN","MDRPCOT",108,0)
 I TYPE=5 D
"RTN","MDRPCOT",109,0)
 .N MDHL7,MDERR S MDHL7=$$SUB^MDHL7B(+DATA)
"RTN","MDRPCOT",110,0)
 .I +MDHL7=-1 S MDFDA(702,DATA,.09)=2,MDFDA(702,DATA,.08)=$P(MDHL7,U,2)
"RTN","MDRPCOT",111,0)
 .I +MDHL7=1 S MDFDA(702,DATA,.09)=5,MDFDA(702,DATA,.08)=""
"RTN","MDRPCOT",112,0)
 .I $L($P($G(^MDD(702,+DATA,0)),"^",7),";")=1 S MDFDA(702,DATA,.07)=$$NOW^XLFDT(),MDFDA(702,DATA,.14)=$$NOW^XLFDT()
"RTN","MDRPCOT",113,0)
 .D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDRPCOT",114,0)
 Q
"RTN","MDRPCOT",115,0)
 ;
"RTN","MDRPCOT",116,0)
RPC(RESULTS,OPTION,DATA,TYPE,FILE,RESREP) ; [Procedure] Main RPC call
"RTN","MDRPCOT",117,0)
 N MDCANR,MDCON,MDDOC,MDFDA,MDFN,MDGST,MDHOLD,MDIEN,MDIENS,MDL,MDLOC,MDMSG,MDNEWV,MDNOTE,MDNVST,MDPDT,MDPKG,MDPROC,MDRES,MDRESU,MDRESUL,MDRET,MDS,MDSIEN,MDSTAT,MDSTUDY,MDTITL,MDTIUER,MDTRAN,MDTST,MDTSTR,MDVST,MDVSTR,MDWP,MDX,MDY
"RTN","MDRPCOT",118,0)
 S RESULTS=$NA(^TMP($J)) K @RESULTS
"RTN","MDRPCOT",119,0)
 D:$T(@OPTION)]"" @OPTION
"RTN","MDRPCOT",120,0)
 D:'$D(@RESULTS) BADRPC^MDRPCU("MD TMDTRANSACTION","MDRPCOT",OPTION)
"RTN","MDRPCOT",121,0)
 D CLEAN^DILF
"RTN","MDRPCOT",122,0)
 Q
"RTN","MDRPCOT",123,0)
 ;
"RTN","MDRPCOT",124,0)
STATUS(MDIENS,MDSTAT,MDMSG) ; [Procedure] Update transaction status
"RTN","MDRPCOT",125,0)
 S MDFDA(702,MDIENS,.08)=$G(MDMSG)
"RTN","MDRPCOT",126,0)
 S MDFDA(702,MDIENS,.09)=MDSTAT
"RTN","MDRPCOT",127,0)
 D FILE^DIE("","MDFDA") K MDFDA
"RTN","MDRPCOT",128,0)
 Q
"RTN","MDRPCOT",129,0)
 ;
"RTN","MDRPCOT",130,0)
SUBMIT ; [Procedure] Process the Image(s) Submission.
"RTN","MDRPCOT",131,0)
 ; Output: -1^Error Message or
"RTN","MDRPCOT",132,0)
 ;          1^Successful Message
"RTN","MDRPCOT",133,0)
 N MDRESUL,MDSTUDY
"RTN","MDRPCOT",134,0)
 S MDSTUDY=+DATA,MDRESUL=""
"RTN","MDRPCOT",135,0)
 L +^MDD(702,MDSTUDY,0):0 I '$T S @RESULTS@(0)="1^Study locked" Q  ;43 - add lock
"RTN","MDRPCOT",136,0)
 ; Create New TIU Document
"RTN","MDRPCOT",137,0)
 S MDRESUL=$$NEWTIUN(MDSTUDY)
"RTN","MDRPCOT",138,0)
 ; File TIU Error messages
"RTN","MDRPCOT",139,0)
 I +MDRESUL<0 D  Q
"RTN","MDRPCOT",140,0)
 .D FILEMSG(MDSTUDY,"TIU",2,MDRESUL)
"RTN","MDRPCOT",141,0)
 .S @RESULTS@(0)=MDRESUL
"RTN","MDRPCOT",142,0)
 .L -^MDD(702,MDSTUDY,0)  ;43 - add unlock
"RTN","MDRPCOT",143,0)
 ; Submit and export the images
"RTN","MDRPCOT",144,0)
 S MDRESUL=$$SUBMIT^MDRPCOT1(MDSTUDY)
"RTN","MDRPCOT",145,0)
 ; File message
"RTN","MDRPCOT",146,0)
 D FILEMSG(MDSTUDY,"IMAGING",$S(+MDRESUL>0:+MDRESUL,1:2),MDRESUL)
"RTN","MDRPCOT",147,0)
 S @RESULTS@(0)=MDRESUL
"RTN","MDRPCOT",148,0)
 L -^MDD(702,MDSTUDY,0)  ;43 - add unlock
"RTN","MDRPCOT",149,0)
 Q
"RTN","MDRPCOT",150,0)
 ;
"RTN","MDRPCOT",151,0)
VIEWTIU ; [Procedure] VIew the associated tiu document
"RTN","MDRPCOT",152,0)
 I '$P(^MDD(702,+DATA,0),U,6) D  Q
"RTN","MDRPCOT",153,0)
 .S @RESULTS@(0)="NO TIU NOTE FOR THIS STUDY"
"RTN","MDRPCOT",154,0)
 D TGET^TIUSRVR1(.RESULTS,+$P(^MDD(702,+DATA,0),U,6))
"RTN","MDRPCOT",155,0)
 Q
"RTN","MDRPCOT",156,0)
 ;
"RTN","MDRPCOT",157,0)
GETDATA(STUDY) ; [Function] Return the Necessary data for creating a TIU note.
"RTN","MDRPCOT",158,0)
 ; Return: Patient DFN_"^"_TIU title_"^"_Hospital Location_"^"_TIU Note
"RTN","MDRPCOT",159,0)
 ;         IEN_"^"_Consult #_"^"_CP Definition IEN_"^"_Visit String_"^"
"RTN","MDRPCOT",160,0)
 ;         New Visit Flag
"RTN","MDRPCOT",161,0)
 ;         or
"RTN","MDRPCOT",162,0)
 ;         -1^Error Message
"RTN","MDRPCOT",163,0)
 N DFN,MDCON,MDFN,MDIEN,MDDPT,MDIENS,MDLOC,MDNEWV,MDNOTE,MDNVST,MDPROC,MDVSTR,MDTITL,MDX,MDTST
"RTN","MDRPCOT",164,0)
 S MDIEN=+STUDY,MDIENS=MDIEN_",",MDNVST=0
"RTN","MDRPCOT",165,0)
 I $$GET1^DIQ(702,MDIENS,.01)="" Q "-1^No such study entry."
"RTN","MDRPCOT",166,0)
 ; Get DFN
"RTN","MDRPCOT",167,0)
 S DFN=$$GET1^DIQ(702,MDIEN,.01,"I")
"RTN","MDRPCOT",168,0)
 I 'DFN Q "-1^No DFN."
"RTN","MDRPCOT",169,0)
 ; Get CP Def
"RTN","MDRPCOT",170,0)
 S MDPROC=$$GET1^DIQ(702,MDIEN,.04,"I")
"RTN","MDRPCOT",171,0)
 I 'MDPROC Q "-1^No CP Def."
"RTN","MDRPCOT",172,0)
 ; Get Consult
"RTN","MDRPCOT",173,0)
 S MDCON=$$GET1^DIQ(702,MDIEN,.05,"I")
"RTN","MDRPCOT",174,0)
 I 'MDCON Q "-1^No Consult #."
"RTN","MDRPCOT",175,0)
 ; Get TIU Note Title
"RTN","MDRPCOT",176,0)
 S MDTITL=$$GET1^DIQ(702.01,+MDPROC_",",.04,"I")
"RTN","MDRPCOT",177,0)
 I 'MDTITL Q "-1^No TIU Note Title."
"RTN","MDRPCOT",178,0)
 S MDVSTR=$$GET1^DIQ(702,MDIEN,.07)
"RTN","MDRPCOT",179,0)
 I MDVSTR=""  Q "-1^No Visit String."
"RTN","MDRPCOT",180,0)
 I $L(MDVSTR,";")=1 S MDNVST=1,MDDPT=$$PDT^MDRPCOT1(MDIEN),MDVSTR=";"_MDVSTR ; If new visit is selected
"RTN","MDRPCOT",181,0)
 ; MDLOC is Hospital Location
"RTN","MDRPCOT",182,0)
 I MDVSTR'="" D
"RTN","MDRPCOT",183,0)
 .S MDVSTR=$$GETVSTR^MDRPCOT1(DFN,MDVSTR,MDPROC,$$GET1^DIQ(702,MDIEN,.02,"I"))
"RTN","MDRPCOT",184,0)
 .S MDLOC=$P(MDVSTR,";",1)
"RTN","MDRPCOT",185,0)
 I $$GET1^DIQ(702.01,+MDPROC_",",.12,"I")=1 Q DFN_"^"_MDTITL_"^"_MDLOC_"^^"_MDCON_"^"_MDPROC_"^"_MDVSTR_"^"_MDNVST
"RTN","MDRPCOT",186,0)
 ; Does TIU doc already exist?
"RTN","MDRPCOT",187,0)
 I $$GET1^DIQ(702,MDIEN,.06,"I") Q DFN_"^"_MDTITL_"^"_MDLOC_"^"_+$$GET1^DIQ(702,MDIEN,.06,"I")_"^"_MDCON_"^"_MDPROC_"^"_MDVSTR_"^"_MDNVST
"RTN","MDRPCOT",188,0)
 ; Does TIU doc exist for previous transaction of this consult?
"RTN","MDRPCOT",189,0)
 I MDCON S MDNOTE=$$PREV(MDCON,MDIEN)
"RTN","MDRPCOT",190,0)
 Q DFN_"^"_MDTITL_"^"_MDLOC_"^"_+MDNOTE_"^"_MDCON_"^"_MDPROC_"^"_MDVSTR_"^"_MDNVST
"RTN","MDRPCOT",191,0)
 ;
"RTN","MDRPCOT",192,0)
NEWTIUN(STUDY) ; [Function] Create a new TIU for transaction
"RTN","MDRPCOT",193,0)
 ; Input: STUDY - IENS of CP study entry
"RTN","MDRPCOT",194,0)
 ; Return: TIU Document IEN
"RTN","MDRPCOT",195,0)
 N CTR,DFN,MDCON,MDFDA,MDGST,MDL,MDLOC,MDNOTE,MDPDT,MDPROC,MDRESU,MDTITL,MDTSTR,MDVST,MDVSTR,MDWP,MDPT S CTR=0,MDGST=+STUDY,MDRESU=""
"RTN","MDRPCOT",196,0)
 ; Get data for TIU Note Creation
"RTN","MDRPCOT",197,0)
 S (MDTSTR,MDRESU)=$$GETDATA(MDGST)
"RTN","MDRPCOT",198,0)
 ; File Error message
"RTN","MDRPCOT",199,0)
 I +MDRESU<0 D FILEMSG(MDGST,"CP",2,MDRESU) Q MDRESU
"RTN","MDRPCOT",200,0)
 I $G(MDTSTR)="" Q "-1^No Data to Create TIU Document"
"RTN","MDRPCOT",201,0)
 F MDL="DFN","MDTITL","MDLOC","MDNOTE","MDCON","MDPROC","MDVSTR","MDNVST" D
"RTN","MDRPCOT",202,0)
 .S CTR=CTR+1,@MDL=$P(MDTSTR,"^",CTR)
"RTN","MDRPCOT",203,0)
 S MDVST=""
"RTN","MDRPCOT",204,0)
 ; If previous TIU document exists, quit
"RTN","MDRPCOT",205,0)
 I MDNOTE Q MDNOTE
"RTN","MDRPCOT",206,0)
 I $$GET^XPAR("SYS","MD GET HIGH VOLUME",MDPROC,"I")'=""&(+$P(^MDD(702,+MDGST,0),"^",6)) Q $P(^MDD(702,+MDGST,0),"^",6)
"RTN","MDRPCOT",207,0)
 I 'MDLOC Q "-1^No Hospital Location."
"RTN","MDRPCOT",208,0)
 ; Create new visit, if no vstring
"RTN","MDRPCOT",209,0)
 S MDPDT=$$PDT^MDRPCOT1(MDGST)
"RTN","MDRPCOT",210,0)
 I 'MDPDT S MDPT=$O(^MDD(703.1,"ASTUDYID",+MDGST,0)),MDPDT=$P($G(^MDD(703.1,+MDPT,0)),U,3)
"RTN","MDRPCOT",211,0)
 S:'MDPDT MDPDT=$P(MDVSTR,";",2) ; If No D/T Performed grab visit D/T
"RTN","MDRPCOT",212,0)
 I $P(MDVSTR,";",3)="V" S $P(MDVSTR,";",3)="A"
"RTN","MDRPCOT",213,0)
 ; Build variables for TIU Call
"RTN","MDRPCOT",214,0)
 S MDWP(.05)=1 ; Undicated Status
"RTN","MDRPCOT",215,0)
 S MDWP(1405)=+MDCON_";GMR(123," ; Package Reference
"RTN","MDRPCOT",216,0)
 S MDWP(70201)=5 ; Default Procedure Summary Code "Machine Resulted"
"RTN","MDRPCOT",217,0)
 I MDPDT S MDWP(70202)=MDPDT ; Date/Time Performed
"RTN","MDRPCOT",218,0)
 ; File PCE Error message
"RTN","MDRPCOT",219,0)
 I MDNVST S MDRESU=$$EN1^MDPCE(MDGST,$P(MDVSTR,";",2),MDPROC,$P(MDVSTR,";",3),"P") I +MDRESU S MDVST=+MDRESU,MDVSTR=$P(MDRESU,"^",2)
"RTN","MDRPCOT",220,0)
 I MDNVST&(+MDRESU<0) D FILEMSG(MDGST,"PCE",2,$P(MDRESU,"^",2)) Q MDRESU
"RTN","MDRPCOT",221,0)
 ; Create the TIU note stub
"RTN","MDRPCOT",222,0)
 S MDNOTE="" D MAKE^TIUSRVP(.MDNOTE,DFN,MDTITL,$P(MDVSTR,";",2),MDLOC,$S(MDVST:MDVST,1:""),.MDWP,MDVSTR,1,1)
"RTN","MDRPCOT",223,0)
 I '(+MDNOTE) S $P(MDNOTE,"^")=-1 Q MDNOTE
"RTN","MDRPCOT",224,0)
 ; Finalize the transaction
"RTN","MDRPCOT",225,0)
 S MDFDA(702,STUDY_",",.06)=+MDNOTE
"RTN","MDRPCOT",226,0)
 S MDFDA(702,STUDY_",",.08)=""
"RTN","MDRPCOT",227,0)
 S:MDVST>0 MDFDA(702,STUDY_",",.13)=MDVST
"RTN","MDRPCOT",228,0)
 D FILE^DIE("","MDFDA")
"RTN","MDRPCOT",229,0)
 D UPD^MDKUTLR(STUDY,+MDNOTE)
"RTN","MDRPCOT",230,0)
 Q 1
"RTN","MDRPCOT",231,0)
 ;
"RTN","MDRPCOT",232,0)
PREV(MDC,MDS) ; [Function] Return the Previous TIU document.
"RTN","MDRPCOT",233,0)
 N MDNEWV,MDDOC,MDTRAN,MDTIUER,MDTST
"RTN","MDRPCOT",234,0)
 S (MDDOC,MDNEWV,MDTRAN,MDTIUER,MDTST)="" K ^TMP("MDTIUST",$J)
"RTN","MDRPCOT",235,0)
 F  S MDTRAN=$O(^MDD(702,"ACON",MDC,MDTRAN)) Q:'MDTRAN  D  Q:'MDTRAN
"RTN","MDRPCOT",236,0)
 .I $P(^MDD(702,MDTRAN,0),U,6) D
"RTN","MDRPCOT",237,0)
 ..D EXTRACT^TIULQ($P(^MDD(702,MDTRAN,0),U,6),"^TMP(""MDTIUST"",$J)",MDTIUER,".01;.05;1406") Q:+MDTIUER
"RTN","MDRPCOT",238,0)
 ..S MDTST=$G(^TMP("MDTIUST",$J,$P(^MDD(702,MDTRAN,0),U,6),.05,"E"))
"RTN","MDRPCOT",239,0)
 ..I MDTST'="UNDICTATED"&(MDTST'="UNSIGNED") K ^TMP("MDTIUST",$J) Q
"RTN","MDRPCOT",240,0)
 ..I MDTST="UNSIGNED"&'($G(^TMP("MDTIUST",$J,$P(^MDD(702,MDTRAN,0),U,6),1406,"I"))) K ^TMP("MDTIUST",$J) Q
"RTN","MDRPCOT",241,0)
 ..S MDDOC=$P(^MDD(702,MDTRAN,0),U,6),MDNEWV=$P(^MDD(702,MDTRAN,0),U,7)
"RTN","MDRPCOT",242,0)
 ..Q:'MDS
"RTN","MDRPCOT",243,0)
 ..S MDFDA(702,MDS_",",.06)=MDDOC
"RTN","MDRPCOT",244,0)
 ..S MDFDA(702,MDS_",",.07)=MDNEWV
"RTN","MDRPCOT",245,0)
 ..D FILE^DIE("","MDFDA")
"RTN","MDRPCOT",246,0)
 ..S MDTRAN=""
"RTN","MDRPCOT",247,0)
 Q MDDOC
"RTN","MDRPCOT",248,0)
 ;
"VER")
8.0^22.2
"BLD",9944,6)
^45
**END**
**END**

