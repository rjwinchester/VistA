EMERGENCY Released DG*5.3*970 SEQ #845
Extracted from mail message
**KIDS**:DG*5.3*970^

**INSTALL NAME**
DG*5.3*970
"BLD",10496,0)
DG*5.3*970^REGISTRATION^0^3180918^y
"BLD",10496,1,0)
^^1^1^3180905^
"BLD",10496,1,1,0)
Please refer to the Patch Description in FORUM for patch DG*5.3*970
"BLD",10496,4,0)
^9.64PA^^
"BLD",10496,6.3)
14
"BLD",10496,"ABPKG")
n
"BLD",10496,"INIT")
EP^DG53970P
"BLD",10496,"KRN",0)
^9.67PA^779.2^20
"BLD",10496,"KRN",.4,0)
.4
"BLD",10496,"KRN",.401,0)
.401
"BLD",10496,"KRN",.402,0)
.402
"BLD",10496,"KRN",.403,0)
.403
"BLD",10496,"KRN",.5,0)
.5
"BLD",10496,"KRN",.84,0)
.84
"BLD",10496,"KRN",3.6,0)
3.6
"BLD",10496,"KRN",3.8,0)
3.8
"BLD",10496,"KRN",9.2,0)
9.2
"BLD",10496,"KRN",9.8,0)
9.8
"BLD",10496,"KRN",19,0)
19
"BLD",10496,"KRN",19.1,0)
19.1
"BLD",10496,"KRN",101,0)
101
"BLD",10496,"KRN",409.61,0)
409.61
"BLD",10496,"KRN",771,0)
771
"BLD",10496,"KRN",779.2,0)
779.2
"BLD",10496,"KRN",870,0)
870
"BLD",10496,"KRN",8989.51,0)
8989.51
"BLD",10496,"KRN",8989.52,0)
8989.52
"BLD",10496,"KRN",8994,0)
8994
"BLD",10496,"KRN","B",.4,.4)

"BLD",10496,"KRN","B",.401,.401)

"BLD",10496,"KRN","B",.402,.402)

"BLD",10496,"KRN","B",.403,.403)

"BLD",10496,"KRN","B",.5,.5)

"BLD",10496,"KRN","B",.84,.84)

"BLD",10496,"KRN","B",3.6,3.6)

"BLD",10496,"KRN","B",3.8,3.8)

"BLD",10496,"KRN","B",9.2,9.2)

"BLD",10496,"KRN","B",9.8,9.8)

"BLD",10496,"KRN","B",19,19)

"BLD",10496,"KRN","B",19.1,19.1)

"BLD",10496,"KRN","B",101,101)

"BLD",10496,"KRN","B",409.61,409.61)

"BLD",10496,"KRN","B",771,771)

"BLD",10496,"KRN","B",779.2,779.2)

"BLD",10496,"KRN","B",870,870)

"BLD",10496,"KRN","B",8989.51,8989.51)

"BLD",10496,"KRN","B",8989.52,8989.52)

"BLD",10496,"KRN","B",8994,8994)

"BLD",10496,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",10496,"QUES",0)
^9.62^^
"BLD",10496,"REQB",0)
^9.611^^
"INIT")
EP^DG53970P
"MBREQ")
0
"PKG",47,-1)
1^1
"PKG",47,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",47,20,0)
^9.402P^^
"PKG",47,22,0)
^9.49I^1^1
"PKG",47,22,1,0)
5.3^2930813^2960613
"PKG",47,22,1,"PAH",1,0)
970^3180918
"PKG",47,22,1,"PAH",1,1,0)
^^1^1^3180918
"PKG",47,22,1,"PAH",1,1,1,0)
Please refer to the Patch Description in FORUM for patch DG*5.3*970
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","DG53970P")
0^^B25664528^n/a
"RTN","DG53970P",1,0)
DG53970P ;ALB/JAM - REGISTRATION EMERGENCY PATCH POST-INSTALL TO FIX BLANK SSN IN PERSON INCOME FILE ;9/4/2018 3:21pm
"RTN","DG53970P",2,0)
 ;;5.3;Registration;**970**;Aug 13,1993;Build 14
"RTN","DG53970P",3,0)
 ;
"RTN","DG53970P",4,0)
 Q
"RTN","DG53970P",5,0)
EP ; Entry Point
"RTN","DG53970P",6,0)
 D BMES^XPDUTL(">>> Cleanup of SSNs in INCOME PERSON file (#408.13)...")
"RTN","DG53970P",7,0)
 ; Quit if already installed and ^XTMP exists
"RTN","DG53970P",8,0)
 I $$PATCH^XPDUTL("DG*5.3*970"),$D(^XTMP("DG53970P")) D MES^XPDUTL("    Job does not need to be run since patch has been installed previously.") Q
"RTN","DG53970P",9,0)
 ;queue off SSN cleanup
"RTN","DG53970P",10,0)
 N ZTRTN,ZTDESC,ZTDTH,DGTEXT,ZTIO,ZTSK
"RTN","DG53970P",11,0)
 S ZTRTN="CLEANUP^DG53970P"
"RTN","DG53970P",12,0)
 S ZTDESC="DG*5.3*970 Emergency patch to clean up SSNs in INCOME PERSON file (#408.13)."
"RTN","DG53970P",13,0)
 S ZTDTH=$$NOW^XLFDT
"RTN","DG53970P",14,0)
 S ZTIO=""
"RTN","DG53970P",15,0)
 D ^%ZTLOAD
"RTN","DG53970P",16,0)
 S DGTEXT(1)=" Cleanup of SSN fields queued."
"RTN","DG53970P",17,0)
 S DGTEXT(2)=" The task number is "_$G(ZTSK)_"."
"RTN","DG53970P",18,0)
 D MES^XPDUTL(.DGTEXT)
"RTN","DG53970P",19,0)
 Q
"RTN","DG53970P",20,0)
CLEANUP ; Entry point
"RTN","DG53970P",21,0)
 ; sweep through 408.13 file looking at SSN field (Piece 9) for values " " OR " P"
"RTN","DG53970P",22,0)
 ; - modify the SSN field to NULL
"RTN","DG53970P",23,0)
 ; - clean up the xrefs
"RTN","DG53970P",24,0)
 ; - get the associated DFN and store it
"RTN","DG53970P",25,0)
 ;
"RTN","DG53970P",26,0)
 ; Information from the cleanup will be placed in ^XTMP (120 day expiration) and sent in a Mailman message
"RTN","DG53970P",27,0)
 K ^XTMP("DG53970P")
"RTN","DG53970P",28,0)
 S ^XTMP("DG53970P",0)=$$FMADD^XLFDT(DT,120)_U_DT_U_"EMERGENCY PATCH DG*5.3*970-SSN CLEANUP"
"RTN","DG53970P",29,0)
 ; Collect stats: start/end time and the number of records scanned and number of SSNs cleaned
"RTN","DG53970P",30,0)
 N %,ZTDTS,ZTDTE,PCNT,SSN,SSNCNT,DFN,IEN,DGFIL,Y
"RTN","DG53970P",31,0)
 D NOW^%DTC S Y=% D DD^%DT
"RTN","DG53970P",32,0)
 S ZTDTS=Y
"RTN","DG53970P",33,0)
 S (PCNT,SSNCNT)=0
"RTN","DG53970P",34,0)
 S IEN=0,DGFIL=408.13
"RTN","DG53970P",35,0)
 F  S IEN=$O(^DGPR(DGFIL,IEN)) Q:'IEN  D
"RTN","DG53970P",36,0)
 . S PCNT=PCNT+1
"RTN","DG53970P",37,0)
 . S SSN=$P(^DGPR(DGFIL,IEN,0),"^",9)
"RTN","DG53970P",38,0)
 . I SSN=" "!(SSN=" P") D
"RTN","DG53970P",39,0)
 . . S $P(^DGPR(DGFIL,IEN,0),"^",9)=""
"RTN","DG53970P",40,0)
 . . ; we have to assume the xrefs are bad and need to be cleaned up
"RTN","DG53970P",41,0)
 . . D XREF(IEN,DGFIL)
"RTN","DG53970P",42,0)
 . . ; track number of records with SSN data cleaned
"RTN","DG53970P",43,0)
 . . S SSNCNT=SSNCNT+1
"RTN","DG53970P",44,0)
 . . ; Place IEN affected in ^XTMP global
"RTN","DG53970P",45,0)
 . . S ^XTMP("DG53970P",$J,"SSN",SSNCNT)=IEN
"RTN","DG53970P",46,0)
 . . ; retrieve the associated patient (DFN) for this record from the PATIENT RELATION file (#408.12)
"RTN","DG53970P",47,0)
 . . S DFN=$$GETDFN(IEN)
"RTN","DG53970P",48,0)
 . . ; we should always get a DFN but just in case we don't, log this and quit
"RTN","DG53970P",49,0)
 . . I 'DFN S ^XTMP("DG53970P",$J,"ERR",IEN)="" Q
"RTN","DG53970P",50,0)
 . . ; log the DFN in ^XTMP
"RTN","DG53970P",51,0)
 . . S ^XTMP("DG53970P",$J,"DFN",DFN)=""
"RTN","DG53970P",52,0)
 ; job completed, capture stats and send mailman message
"RTN","DG53970P",53,0)
 D NOW^%DTC S Y=% D DD^%DT
"RTN","DG53970P",54,0)
 S ZTDTE=Y
"RTN","DG53970P",55,0)
 D SENDMSG
"RTN","DG53970P",56,0)
 ; Place job data into ^XTMP Global
"RTN","DG53970P",57,0)
 S ^XTMP("DG53970P",$J,"DGSTART")=$G(ZTDTS) ;job start date/time
"RTN","DG53970P",58,0)
 S ^XTMP("DG53970P",$J,"DGEND")=$G(ZTDTE) ;job end date/time
"RTN","DG53970P",59,0)
 S ^XTMP("DG53970P",$J,"TOTAL")=SSNCNT ; total records affected
"RTN","DG53970P",60,0)
 Q
"RTN","DG53970P",61,0)
XREF(IEN,DGFIL) ; clean "SSN", "BS" and "BS5" xrefs for this INCOME PERSON file (#408.13) record
"RTN","DG53970P",62,0)
 N VAL,XREF
"RTN","DG53970P",63,0)
 F XREF="SSN","BS","BS5" D
"RTN","DG53970P",64,0)
 . S VAL=""
"RTN","DG53970P",65,0)
 . F  S VAL=$O(^DGPR(DGFIL,XREF,VAL)) Q:VAL=""  D
"RTN","DG53970P",66,0)
 . . I $D(^DGPR(DGFIL,XREF,VAL,IEN)) K ^DGPR(DGFIL,XREF,VAL,IEN)
"RTN","DG53970P",67,0)
 Q
"RTN","DG53970P",68,0)
GETDFN(IEN) ; retrieve DFN for this IEN from 408.12
"RTN","DG53970P",69,0)
 N DFN,VAL,GLOC,XIEN,RELIEN
"RTN","DG53970P",70,0)
 S VAL="",DFN=""
"RTN","DG53970P",71,0)
 ; step through "C" xref
"RTN","DG53970P",72,0)
 F  S VAL=$O(^DGPR(408.12,"C",VAL)) Q:VAL=""  D  Q:DFN
"RTN","DG53970P",73,0)
 . ; the format of VAL we are looking for is IEN;GLOBAL REFERENCE
"RTN","DG53970P",74,0)
 . ; where the IEN matches the IEN passed in and the GLOBAL REF is "DGRP(408.13,"
"RTN","DG53970P",75,0)
 . S GLOC=$P(VAL,";",2),XIEN=+VAL
"RTN","DG53970P",76,0)
 . ; if we have what we are looking for, the next node in the xref will be the 408.12 IEN we want 
"RTN","DG53970P",77,0)
 . I XIEN=IEN,GLOC="DGPR(408.13," D
"RTN","DG53970P",78,0)
 . . S RELIEN=$O(^DGPR(408.12,"C",VAL,""))
"RTN","DG53970P",79,0)
 . . Q:RELIEN=""
"RTN","DG53970P",80,0)
 . . ; the DFN will be piece 1 of this IEN record
"RTN","DG53970P",81,0)
 . . S DFN=$P(^DGPR(408.12,RELIEN,0),"^",1)
"RTN","DG53970P",82,0)
 Q DFN
"RTN","DG53970P",83,0)
SENDMSG ;Send MailMan message when process completes
"RTN","DG53970P",84,0)
 N XMSUB,XMDUZ,XMY,XMTEXT,MSG,LN
"RTN","DG53970P",85,0)
 S XMY(DUZ)="",XMTEXT="MSG("
"RTN","DG53970P",86,0)
 S XMDUZ=.5,XMSUB="DG*5.3*970 JOB TO CORRECT SSNs IN INCOME PERSON FILE (#408.13)"
"RTN","DG53970P",87,0)
 S MSG($$LN)="The DG*5.3*970 process has completed."
"RTN","DG53970P",88,0)
 S MSG($$LN)=""
"RTN","DG53970P",89,0)
 S MSG($$LN)="This process ran through the INCOME PERSON file #408.13 and checked each"
"RTN","DG53970P",90,0)
 S MSG($$LN)="record for the Social Security Number (#.09) field having a 'space' or"
"RTN","DG53970P",91,0)
 S MSG($$LN)="a 'space' followed by a 'P' and deleted the field."
"RTN","DG53970P",92,0)
 S MSG($$LN)=""
"RTN","DG53970P",93,0)
 S MSG($$LN)="The process statistics:"
"RTN","DG53970P",94,0)
 S MSG($$LN)=""
"RTN","DG53970P",95,0)
 S MSG($$LN)="Job Start Date/Time: "_$G(ZTDTS)
"RTN","DG53970P",96,0)
 S MSG($$LN)="  Job End Date/Time: "_$G(ZTDTE)
"RTN","DG53970P",97,0)
 S MSG($$LN)=""
"RTN","DG53970P",98,0)
 S MSG($$LN)="Total INCOME PERSON file (#408.13) records searched: "_+$G(PCNT)
"RTN","DG53970P",99,0)
 S MSG($$LN)="Total records with SSN data updated: "_+$G(SSNCNT)
"RTN","DG53970P",100,0)
 S MSG($$LN)=""
"RTN","DG53970P",101,0)
 S MSG($$LN)=" View global ^XTMP(""DG53970P"","_$J_",""SSN"" for the list of records in the"
"RTN","DG53970P",102,0)
 S MSG($$LN)="  INCOME PERSON file that had SSN data updated."
"RTN","DG53970P",103,0)
 S MSG($$LN)=" View global ^XTMP(""DG53970P"","_$J_",""DFN"" for the list of Patients (DFNs)"
"RTN","DG53970P",104,0)
 S MSG($$LN)="  associated with the updated INCOME PERSON file records."
"RTN","DG53970P",105,0)
 S MSG($$LN)=" View global ^XTMP(""DG53970P"","_$J_",""ERR"" for the list of records in the"
"RTN","DG53970P",106,0)
 S MSG($$LN)="  INCOME PERSON file for which a DFN was not found."
"RTN","DG53970P",107,0)
 D ^XMD
"RTN","DG53970P",108,0)
 Q
"RTN","DG53970P",109,0)
LN() ;Increment line counter
"RTN","DG53970P",110,0)
 S LN=$G(LN)+1
"RTN","DG53970P",111,0)
 Q LN
"VER")
8.0^22.2
"BLD",10496,6)
^845
**END**
**END**

