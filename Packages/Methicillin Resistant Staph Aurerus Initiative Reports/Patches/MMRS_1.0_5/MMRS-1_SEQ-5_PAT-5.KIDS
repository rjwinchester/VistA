Released MMRS*1*5 SEQ #5
Extracted from mail message
**KIDS**:MMRS*1.0*5^

**INSTALL NAME**
MMRS*1.0*5
"BLD",9428,0)
MMRS*1.0*5^MDRO INITIATIVE REPORTS^0^3170412^y
"BLD",9428,1,0)
^^1^1^3170307^^^
"BLD",9428,1,1,0)
Refer to National Patch Module.
"BLD",9428,4,0)
^9.64PA^^0
"BLD",9428,6)
6^
"BLD",9428,6.3)
146
"BLD",9428,"ABPKG")
n
"BLD",9428,"INIT")

"BLD",9428,"KRN",0)
^9.67PA^779.2^20
"BLD",9428,"KRN",.4,0)
.4
"BLD",9428,"KRN",.4,"NM",0)
^9.68A^^
"BLD",9428,"KRN",.401,0)
.401
"BLD",9428,"KRN",.402,0)
.402
"BLD",9428,"KRN",.403,0)
.403
"BLD",9428,"KRN",.403,"NM",0)
^9.68A^^0
"BLD",9428,"KRN",.5,0)
.5
"BLD",9428,"KRN",.84,0)
.84
"BLD",9428,"KRN",3.6,0)
3.6
"BLD",9428,"KRN",3.8,0)
3.8
"BLD",9428,"KRN",9.2,0)
9.2
"BLD",9428,"KRN",9.8,0)
9.8
"BLD",9428,"KRN",9.8,"NM",0)
^9.68A^20^10
"BLD",9428,"KRN",9.8,"NM",1,0)
MMRSCDI^^0^B224996705
"BLD",9428,"KRN",9.8,"NM",2,0)
MMRSCDI1^^0^B42768912
"BLD",9428,"KRN",9.8,"NM",12,0)
MMRSCRE^^0^B98037887
"BLD",9428,"KRN",9.8,"NM",13,0)
MMRSCRE2^^0^B15423408
"BLD",9428,"KRN",9.8,"NM",14,0)
MMRSCRE3^^0^B174713935
"BLD",9428,"KRN",9.8,"NM",15,0)
MMRSCRE4^^0^B37634944
"BLD",9428,"KRN",9.8,"NM",17,0)
MMRSCDI2^^0^B164313738
"BLD",9428,"KRN",9.8,"NM",18,0)
MMRSIPC^^0^B103279928
"BLD",9428,"KRN",9.8,"NM",19,0)
MMRSIPC2^^0^B111101050
"BLD",9428,"KRN",9.8,"NM",20,0)
MMRSORD^^0^B47235280
"BLD",9428,"KRN",9.8,"NM","B","MMRSCDI",1)

"BLD",9428,"KRN",9.8,"NM","B","MMRSCDI1",2)

"BLD",9428,"KRN",9.8,"NM","B","MMRSCDI2",17)

"BLD",9428,"KRN",9.8,"NM","B","MMRSCRE",12)

"BLD",9428,"KRN",9.8,"NM","B","MMRSCRE2",13)

"BLD",9428,"KRN",9.8,"NM","B","MMRSCRE3",14)

"BLD",9428,"KRN",9.8,"NM","B","MMRSCRE4",15)

"BLD",9428,"KRN",9.8,"NM","B","MMRSIPC",18)

"BLD",9428,"KRN",9.8,"NM","B","MMRSIPC2",19)

"BLD",9428,"KRN",9.8,"NM","B","MMRSORD",20)

"BLD",9428,"KRN",19,0)
19
"BLD",9428,"KRN",19,"NM",0)
^9.68A^8^8
"BLD",9428,"KRN",19,"NM",1,0)
MMRS CRE REPORT^^1^
"BLD",9428,"KRN",19,"NM",2,0)
MMRS CRE SITE PARAMETER SETUP^^1^
"BLD",9428,"KRN",19,"NM",3,0)
MMRS MDRO TOOLS SETUP MENU^^0
"BLD",9428,"KRN",19,"NM",4,0)
MMRS MRSA SITE PARAMETER SETUP^^0
"BLD",9428,"KRN",19,"NM",5,0)
MMRS MDRO LAB PARAMETER SETUP^^0
"BLD",9428,"KRN",19,"NM",6,0)
MMRS MRSA WARD MAPPING SETUP^^0
"BLD",9428,"KRN",19,"NM",7,0)
MMRS MDRO HIST DAYS EDIT^^0
"BLD",9428,"KRN",19,"NM",8,0)
MMRS ISLT ORD EDIT^^0
"BLD",9428,"KRN",19,"NM","B","MMRS CRE REPORT",1)

"BLD",9428,"KRN",19,"NM","B","MMRS CRE SITE PARAMETER SETUP",2)

"BLD",9428,"KRN",19,"NM","B","MMRS ISLT ORD EDIT",8)

"BLD",9428,"KRN",19,"NM","B","MMRS MDRO HIST DAYS EDIT",7)

"BLD",9428,"KRN",19,"NM","B","MMRS MDRO LAB PARAMETER SETUP",5)

"BLD",9428,"KRN",19,"NM","B","MMRS MDRO TOOLS SETUP MENU",3)

"BLD",9428,"KRN",19,"NM","B","MMRS MRSA SITE PARAMETER SETUP",4)

"BLD",9428,"KRN",19,"NM","B","MMRS MRSA WARD MAPPING SETUP",6)

"BLD",9428,"KRN",19.1,0)
19.1
"BLD",9428,"KRN",19.1,"NM",0)
^9.68A^^0
"BLD",9428,"KRN",101,0)
101
"BLD",9428,"KRN",101,"NM",0)
^9.68A^^
"BLD",9428,"KRN",409.61,0)
409.61
"BLD",9428,"KRN",771,0)
771
"BLD",9428,"KRN",779.2,0)
779.2
"BLD",9428,"KRN",870,0)
870
"BLD",9428,"KRN",8989.51,0)
8989.51
"BLD",9428,"KRN",8989.52,0)
8989.52
"BLD",9428,"KRN",8994,0)
8994
"BLD",9428,"KRN","B",.4,.4)

"BLD",9428,"KRN","B",.401,.401)

"BLD",9428,"KRN","B",.402,.402)

"BLD",9428,"KRN","B",.403,.403)

"BLD",9428,"KRN","B",.5,.5)

"BLD",9428,"KRN","B",.84,.84)

"BLD",9428,"KRN","B",3.6,3.6)

"BLD",9428,"KRN","B",3.8,3.8)

"BLD",9428,"KRN","B",9.2,9.2)

"BLD",9428,"KRN","B",9.8,9.8)

"BLD",9428,"KRN","B",19,19)

"BLD",9428,"KRN","B",19.1,19.1)

"BLD",9428,"KRN","B",101,101)

"BLD",9428,"KRN","B",409.61,409.61)

"BLD",9428,"KRN","B",771,771)

"BLD",9428,"KRN","B",779.2,779.2)

"BLD",9428,"KRN","B",870,870)

"BLD",9428,"KRN","B",8989.51,8989.51)

"BLD",9428,"KRN","B",8989.52,8989.52)

"BLD",9428,"KRN","B",8994,8994)

"BLD",9428,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9428,"QUES",0)
^9.62^^
"BLD",9428,"REQB",0)
^9.611^3^2
"BLD",9428,"REQB",3,0)
MMRS*1.0*4^2
"BLD",9428,"REQB","B","MMRS*1.0*4",3)

"KRN",19,2921188,-1)
0^4
"KRN",19,2921188,0)
MMRS MRSA SITE PARAMETER SETUP^MRSA Tools Site Parameter Setup^^R^^MMRS SETUP^^^^^^MDRO INITIATIVE REPORTS
"KRN",19,2921188,1,0)
^^3^3^3161031^
"KRN",19,2921188,1,1,0)
This option is used to add/edit the parameters which will modify the 
"KRN",19,2921188,1,2,0)
operation of the MRSA Program Tools application. This option defines the 
"KRN",19,2921188,1,3,0)
division(s) and business rules for MRSA nares screening.
"KRN",19,2921188,25)
DIV^MMRSIPCP
"KRN",19,2921188,99.1)
61572,33678
"KRN",19,2921188,"U")
MRSA TOOLS SITE PARAMETER SETU
"KRN",19,2921189,-1)
0^5
"KRN",19,2921189,0)
MMRS MDRO LAB PARAMETER SETUP^MDRO Tools Lab Parameter Setup^^R^^MMRS SETUP^^^^^^MDRO INITIATIVE REPORTS
"KRN",19,2921189,1,0)
^19.06^4^4^3161031^^^^
"KRN",19,2921189,1,1,0)
This option allows the user to define parameters for the multi-drug 
"KRN",19,2921189,1,2,0)
resistant organism (MDRO) that is to be searched for.  This information 
"KRN",19,2921189,1,3,0)
is used to obtain prior history of MDRO and to display precaution 
"KRN",19,2921189,1,4,0)
measures for the selected organism(s).
"KRN",19,2921189,25)
LAB^MMRSIPCP
"KRN",19,2921189,99.1)
61781,59955
"KRN",19,2921189,"U")
MDRO TOOLS LAB PARAMETER SETUP
"KRN",19,2921190,-1)
0^3
"KRN",19,2921190,0)
MMRS MDRO TOOLS SETUP MENU^MDRO Tools Setup Menu^^M^^MMRS SETUP^^^^^^MDRO INITIATIVE REPORTS
"KRN",19,2921190,10,0)
^19.01IP^5^5
"KRN",19,2921190,10,1,0)
2921188^1^1
"KRN",19,2921190,10,1,"^")
MMRS MRSA SITE PARAMETER SETUP
"KRN",19,2921190,10,2,0)
2921189^2^2
"KRN",19,2921190,10,2,"^")
MMRS MDRO LAB PARAMETER SETUP
"KRN",19,2921190,10,3,0)
2921191^3^3
"KRN",19,2921190,10,3,"^")
MMRS MRSA WARD MAPPING SETUP
"KRN",19,2921190,10,4,0)
2921192^4^4
"KRN",19,2921190,10,4,"^")
MMRS MDRO HIST DAYS EDIT
"KRN",19,2921190,10,5,0)
2921193^5^5
"KRN",19,2921190,10,5,"^")
MMRS ISLT ORD EDIT
"KRN",19,2921190,99)
64374,42075
"KRN",19,2921190,99.1)
64250,72571
"KRN",19,2921190,"U")
MDRO TOOLS SETUP MENU
"KRN",19,2921191,-1)
0^6
"KRN",19,2921191,0)
MMRS MRSA WARD MAPPING SETUP^MRSA Tools Ward Mapping Setup^^R^^MMRS SETUP^^^^^^MDRO INITIATIVE REPORTS
"KRN",19,2921191,1,0)
^19.06^2^2^3160804^^^^
"KRN",19,2921191,1,1,0)
This option allows the user to define geographical units for the 
"KRN",19,2921191,1,2,0)
division(s). It will allow the user to map units together.
"KRN",19,2921191,25)
WARDMAP^MMRSIPCP
"KRN",19,2921191,"U")
MRSA TOOLS WARD MAPPING SETUP
"KRN",19,2921192,-1)
0^7
"KRN",19,2921192,0)
MMRS MDRO HIST DAYS EDIT^MDRO Historical Days Edit^^R^^MMRS SETUP^^^^^^MDRO INITIATIVE REPORTS
"KRN",19,2921192,1,0)
^^2^2^3160723^
"KRN",19,2921192,1,1,0)
This option allows the user to define the timeframe to search the history 
"KRN",19,2921192,1,2,0)
of the selected MDRO for the MDRO Tools Isolation Report.
"KRN",19,2921192,25)
HISTDAY^MMRSIPCP
"KRN",19,2921192,"U")
MDRO HISTORICAL DAYS EDIT
"KRN",19,2921193,-1)
0^8
"KRN",19,2921193,0)
MMRS ISLT ORD EDIT^Isolation Orders Add/Edit^^R^^MMRS SETUP^^^^^^
"KRN",19,2921193,1,0)
^19.06^3^3^3161206^^^^
"KRN",19,2921193,1,1,0)
This option will allow you to enter the orders at your site that are used 
"KRN",19,2921193,1,2,0)
for isolation purposes. This will be used to populate the MRSA Tools 
"KRN",19,2921193,1,3,0)
Isolation Report.
"KRN",19,2921193,25)
ISLTORD^MMRSIPCP
"KRN",19,2921193,"U")
ISOLATION ORDERS ADD/EDIT
"KRN",19,2921698,-1)
1^1
"KRN",19,2921698,0)
MMRS CRE REPORT
"KRN",19,2921699,-1)
1^2
"KRN",19,2921699,0)
MMRS CRE SITE PARAMETER SETUP
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",656,-1)
1^1
"PKG",656,0)
MDRO INITIATIVE REPORTS^MMRS^MRSA PREVENTION INITIATIVE
"PKG",656,20,0)
^9.402P^^
"PKG",656,22,0)
^9.49I^1^1
"PKG",656,22,1,0)
1.0^3160720^3100224^520736433
"PKG",656,22,1,"PAH",1,0)
5^3170412^520736433
"PKG",656,22,1,"PAH",1,1,0)
^^1^1^3170412
"PKG",656,22,1,"PAH",1,1,1,0)
Refer to National Patch Module.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","MMRSCDI")
0^1^B224996705^B219284495
"RTN","MMRSCDI",1,0)
MMRSCDI ;LEIDOS/TCK - Print CDI report ; 4/10/17 2:08pm
"RTN","MMRSCDI",2,0)
 ;;1.0;MRSA TOOLS REPORTS MENU;**4,5**;Mar 22, 2009;Build 146
"RTN","MMRSCDI",3,0)
 ;
"RTN","MMRSCDI",4,0)
MAIN ;
"RTN","MMRSCDI",5,0)
 N EXTFLG,MMRSDIV,MMRSLOC
"RTN","MMRSCDI",6,0)
 ;check if parameters are setup.
"RTN","MMRSCDI",7,0)
 D CLEAN
"RTN","MMRSCDI",8,0)
 D CHECK^MMRSIPC Q:$D(EXTFLG)
"RTN","MMRSCDI",9,0)
 S NUMDIV=1
"RTN","MMRSCDI",10,0)
 D CHECK Q:$D(EXTFLG)
"RTN","MMRSCDI",11,0)
 D PROMPT
"RTN","MMRSCDI",12,0)
 I $D(EXTFLG) D CLEAN K MMRSSUM,DIVARY,DVSN,MDIV Q
"RTN","MMRSCDI",13,0)
 Q:'CHK
"RTN","MMRSCDI",14,0)
 K EXTFLG
"RTN","MMRSCDI",15,0)
 Q:'CHK
"RTN","MMRSCDI",16,0)
 D ASKDVC Q:$D(EXTFLG)
"RTN","MMRSCDI",17,0)
 S MMRSNOW=$$NOW^XLFDT()
"RTN","MMRSCDI",18,0)
 D CLEAN
"RTN","MMRSCDI",19,0)
 D END^MMRSCDI1
"RTN","MMRSCDI",20,0)
 D QUIT
"RTN","MMRSCDI",21,0)
 Q
"RTN","MMRSCDI",22,0)
 ;
"RTN","MMRSCDI",23,0)
PROMPT ;Prompt for division
"RTN","MMRSCDI",24,0)
 N STID,STNM,SIEN
"RTN","MMRSCDI",25,0)
 S (STP,ALL)=0
"RTN","MMRSCDI",26,0)
 I $G(MDROETIO)'>0 S MDROETIO=""
"RTN","MMRSCDI",27,0)
 S MMRSMDRO="",MMRSMDRO=$O(^MMRS(104.2,"B","C. diff",0))
"RTN","MMRSCDI",28,0)
 W !
"RTN","MMRSCDI",29,0)
 S DIR(0)="YA",DIR("A")="Do you want to select all divisions: ",DIR("B")="NO"
"RTN","MMRSCDI",30,0)
 D ^DIR K DIR
"RTN","MMRSCDI",31,0)
 I $D(DIRUT) S EXTFLG=1 Q
"RTN","MMRSCDI",32,0)
 I Y=1 S ALL=1 D  Q:'CHK
"RTN","MMRSCDI",33,0)
 .S CHK=1
"RTN","MMRSCDI",34,0)
 .S DIV=0 F  S DIV=$O(^MMRS(104,DIV)) Q:DIV'>0  D  Q:STP!('CHK)
"RTN","MMRSCDI",35,0)
 ..S WR=$$GET1^DIQ(104,+DIV,.01,"I")
"RTN","MMRSCDI",36,0)
 ..S IEN="",IEN=$O(^MMRS(104.1,"C",+DIV,MMRSMDRO,IEN))
"RTN","MMRSCDI",37,0)
 ..Q:$G(IEN)'>0
"RTN","MMRSCDI",38,0)
 ..S ORGP=$$GET1^DIQ(104.1,IEN,.01,"I")
"RTN","MMRSCDI",39,0)
 ..D CHKPAR(ORGP,+DIV,.CHK)
"RTN","MMRSCDI",40,0)
 ..I 'CHK S (MDROETIO,TSTSTP)=0 D ERROR  Q
"RTN","MMRSCDI",41,0)
 ..S FID=$$GET1^DIQ(40.8,WR,1,"E"),STID=$$GET1^DIQ(40.8,WR,.01,"E")
"RTN","MMRSCDI",42,0)
 ..S MMRSLOC(FID)=STID,DIVARY(STID)=+DIV
"RTN","MMRSCDI",43,0)
 ..I $G(NUMDIV)'>0 S STP=1 Q
"RTN","MMRSCDI",44,0)
 ..;I $G(SPCM)'>0 S STP=1 Q
"RTN","MMRSCDI",45,0)
 Q:STP
"RTN","MMRSCDI",46,0)
 I 'Y D  Q:'CHK
"RTN","MMRSCDI",47,0)
 .N DLAYGO,DTOUT,DUOUT
"RTN","MMRSCDI",48,0)
 .S CHK=1
"RTN","MMRSCDI",49,0)
 .W !
"RTN","MMRSCDI",50,0)
 .S DIC("A")="Select Division: "
"RTN","MMRSCDI",51,0)
 .S DIC="^MMRS(104,",DIC(0)="QEAM" D ^DIC
"RTN","MMRSCDI",52,0)
 .I (Y=-1)!($D(DTOUT))!($D(DUOUT)) S EXTFLG=1 Q
"RTN","MMRSCDI",53,0)
 .S IEN="",IEN=$O(^MMRS(104.1,"C",+Y,MMRSMDRO,IEN))
"RTN","MMRSCDI",54,0)
 .Q:$G(IEN)'>0
"RTN","MMRSCDI",55,0)
 .S ORGP=$$GET1^DIQ(104.1,IEN,.01,"I")
"RTN","MMRSCDI",56,0)
 .D CHKPAR(ORGP,+Y,.CHK)
"RTN","MMRSCDI",57,0)
 .I 'CHK S (MDROETIO,TSTSTP)=0 D ERROR  Q
"RTN","MMRSCDI",58,0)
 .S STID=$$GET1^DIQ(104,+Y,.01,"E"),FID=$$GET1^DIQ(104,+Y,1,"E")
"RTN","MMRSCDI",59,0)
 .S MMRSLOC(FID)=STID,DIVARY(STID)=+Y
"RTN","MMRSCDI",60,0)
 .S CHK=1
"RTN","MMRSCDI",61,0)
 .S Y=""
"RTN","MMRSCDI",62,0)
 .S DIC("A")="Select another Division: " F  D ^DIC Q:Y=-1  D  Q:'CHK
"RTN","MMRSCDI",63,0)
 ..S IEN="",IEN=$O(^MMRS(104.1,"C",+Y,MMRSMDRO,IEN))
"RTN","MMRSCDI",64,0)
 ..Q:$G(IEN)'>0
"RTN","MMRSCDI",65,0)
 ..S ORGP=$$GET1^DIQ(104.1,IEN,.01,"I")
"RTN","MMRSCDI",66,0)
 ..D CHKPAR(ORGP,Y,.CHK)
"RTN","MMRSCDI",67,0)
 ..I 'CHK S (MDROETIO,TSTSTP)=0 D ERROR  Q
"RTN","MMRSCDI",68,0)
 ..S STID=$$GET1^DIQ(104,+Y,.01,"E")
"RTN","MMRSCDI",69,0)
 ..S FID=$$GET1^DIQ(104,+Y,1,"E"),MMRSLOC(FID)=STID,DIVARY(STID)=+Y
"RTN","MMRSCDI",70,0)
 ..I $G(NUMDIV)'>0 S STP=1 Q
"RTN","MMRSCDI",71,0)
 .I ($D(DTOUT))!($D(DUOUT)) S EXTFLG=1 Q
"RTN","MMRSCDI",72,0)
 K DIC
"RTN","MMRSCDI",73,0)
 Q:$G(NUMDIV)'>0
"RTN","MMRSCDI",74,0)
 ;Q:$G(SPCM)'>0
"RTN","MMRSCDI",75,0)
 Q:$D(EXTFLG)
"RTN","MMRSCDI",76,0)
 I ($D(DTOUT))!($D(DUOUT)) S EXTFLG=1 Q
"RTN","MMRSCDI",77,0)
DATE ;
"RTN","MMRSCDI",78,0)
 N DATE,%DT
"RTN","MMRSCDI",79,0)
 S DATE=$$FMADD^XLFDT(DT,-364),%DT("B")=$$FMTE^XLFDT(DATE,"L")
"RTN","MMRSCDI",80,0)
 W ! S %DT="AEPX",%DT("A")="Beginning POS CDI Lab ID Event (Collection) Date: " D ^%DT
"RTN","MMRSCDI",81,0)
 I Y<0 S EXTFLG=1 Q
"RTN","MMRSCDI",82,0)
 S STRTDT=Y
"RTN","MMRSCDI",83,0)
 I STRTDT<DATE W !!,"The start date of the range cannot be greater than one year from today." G DATE
"RTN","MMRSCDI",84,0)
 S DFLTDT=$$FMADD^XLFDT(STRTDT,-56)
"RTN","MMRSCDI",85,0)
DATE1 ;
"RTN","MMRSCDI",86,0)
 S %DT("A")="Ending POS CDI Lab ID Event (Collection) Date: " K %DT("B") D ^%DT
"RTN","MMRSCDI",87,0)
 I Y<0 S EXTFLG=1 Q
"RTN","MMRSCDI",88,0)
 S ENDDT=Y
"RTN","MMRSCDI",89,0)
 I '$P(ENDDT,".",2) S ENDDT=Y+.24
"RTN","MMRSCDI",90,0)
 I ENDDT<STRTDT W !!,"The end date of the range must be later than the starting date." G DATE1
"RTN","MMRSCDI",91,0)
 Q
"RTN","MMRSCDI",92,0)
 ;
"RTN","MMRSCDI",93,0)
CHKPAR(ORG,Y,CHK) ;
"RTN","MMRSCDI",94,0)
 ;
"RTN","MMRSCDI",95,0)
 N I,TST,ETI
"RTN","MMRSCDI",96,0)
 S (TSTSTP,MDROETIO)=0
"RTN","MMRSCDI",97,0)
 I '$D(^MMRS(104.1,"C",+Y,ORG)) S CHK=0 Q
"RTN","MMRSCDI",98,0)
 S I="",I=$O(^MMRS(104.1,"C",+Y,ORG,I))
"RTN","MMRSCDI",99,0)
 S LIEN=1_","_I_","
"RTN","MMRSCDI",100,0)
 S TST=$$GET1^DIQ(104.15,LIEN,.01,"I")
"RTN","MMRSCDI",101,0)
 I $G(TST)>0 S TSTSTP=1 Q
"RTN","MMRSCDI",102,0)
 S ETI=$$GET1^DIQ(104.109,LIEN,.01,"I")
"RTN","MMRSCDI",103,0)
 I $G(ETI)>0 S MDROETIO=1 Q
"RTN","MMRSCDI",104,0)
 S CHK=0
"RTN","MMRSCDI",105,0)
 Q
"RTN","MMRSCDI",106,0)
 ;
"RTN","MMRSCDI",107,0)
CHECK ; Check if lab tests and etiologies are setup
"RTN","MMRSCDI",108,0)
 N II,XX,TST,MRSASTAP,ORG,ETIONAME,MMRSET,MMRSI
"RTN","MMRSCDI",109,0)
 S (MDROETIO,TSTSTP)=0
"RTN","MMRSCDI",110,0)
 I $D(^MMRS(104.1)) D
"RTN","MMRSCDI",111,0)
 .S II=0 F  S II=$O(^MMRS(104.1,II)) Q:II'>0  D  Q:MDROETIO!(TSTSTP)
"RTN","MMRSCDI",112,0)
 ..Q:'$D(^MMRS(104.1,II,0))
"RTN","MMRSCDI",113,0)
 ..S ORGP=$P(^MMRS(104.1,II,0),"^")
"RTN","MMRSCDI",114,0)
 ..Q:$G(ORGP)'>0
"RTN","MMRSCDI",115,0)
 ..S ETIO=$$GET1^DIQ(104.2,ORGP,.01,"E")
"RTN","MMRSCDI",116,0)
 ..S ETIO=$$UPPER^DGUTL(ETIO)
"RTN","MMRSCDI",117,0)
 ..Q:ETIO'["DIFF"
"RTN","MMRSCDI",118,0)
 ..S IX=0
"RTN","MMRSCDI",119,0)
 ..F  S IX=$O(^MMRS(104.1,II,3,IX)) Q:IX'>0  D  Q:TSTSTP
"RTN","MMRSCDI",120,0)
 ...I $G(IX)>0 D
"RTN","MMRSCDI",121,0)
 ....Q:'$D(^MMRS(104.1,II,3,IX,0))
"RTN","MMRSCDI",122,0)
 ....S III=IX_","_II_","
"RTN","MMRSCDI",123,0)
 ....Q:III=""
"RTN","MMRSCDI",124,0)
 ....S TST=$$GET1^DIQ(104.15,III,.01,"E")
"RTN","MMRSCDI",125,0)
 ....;I $G(TST)'=""&(TST["DIFF") S TSTSTP=1
"RTN","MMRSCDI",126,0)
 ....I $G(TST)'="" S TSTSTP=1
"RTN","MMRSCDI",127,0)
 ....;Q:$G(TST)'["DIFF"
"RTN","MMRSCDI",128,0)
 ....;S TSTSTP=1
"RTN","MMRSCDI",129,0)
 ...I $D(^MMRS(104.1,II,6)) D
"RTN","MMRSCDI",130,0)
 ....S IXI=0 F  S IXI=$O(^MMRS(104.1,II,6,IXI)) Q:IXI'>0  D  Q:MDROETIO
"RTN","MMRSCDI",131,0)
 .....Q:IXI=""
"RTN","MMRSCDI",132,0)
 .....Q:'IXI
"RTN","MMRSCDI",133,0)
 .....S III=IXI_","_II_","
"RTN","MMRSCDI",134,0)
 .....S XX=$$GET1^DIQ(104.109,III,.01,"E")
"RTN","MMRSCDI",135,0)
 .....Q:XX'["CLOSTRIDIUM"
"RTN","MMRSCDI",136,0)
 .....S ETIONAME=XX,ORG=II,MDROETIO=ORG
"RTN","MMRSCDI",137,0)
 Q
"RTN","MMRSCDI",138,0)
 ;
"RTN","MMRSCDI",139,0)
ERROR ;
"RTN","MMRSCDI",140,0)
 I 'TSTSTP&'MDROETIO D
"RTN","MMRSCDI",141,0)
 .S EXTFLG=1
"RTN","MMRSCDI",142,0)
 .W !!,"   >>>The report cannot be run because the Laboratory Test(s) or"
"RTN","MMRSCDI",143,0)
 .W !,"       the Etiology is not configured in the MDRO TOOLS LAB "
"RTN","MMRSCDI",144,0)
 .W !,"       SEARCH/EXTRACT file, (104.1).  Use the MDRO Tools "
"RTN","MMRSCDI",145,0)
 .W !,"       Lab Parameter Setup option to configure."
"RTN","MMRSCDI",146,0)
 Q
"RTN","MMRSCDI",147,0)
 ;
"RTN","MMRSCDI",148,0)
MAIN2 ;
"RTN","MMRSCDI",149,0)
 S MMRSNOW=$$NOW^XLFDT()
"RTN","MMRSCDI",150,0)
 D GETPARAM ; Load parameters in temp global
"RTN","MMRSCDI",151,0)
 D PRT
"RTN","MMRSCDI",152,0)
 Q
"RTN","MMRSCDI",153,0)
CLEAN ;
"RTN","MMRSCDI",154,0)
 K ^TMP($J,"MMRSCDI")
"RTN","MMRSCDI",155,0)
 K ^TMP($J,"MMRS")
"RTN","MMRSCDI",156,0)
 K ^TMP($J,"MMRSCD"),DIVARY,DVSN
"RTN","MMRSCDI",157,0)
 Q
"RTN","MMRSCDI",158,0)
 ;
"RTN","MMRSCDI",159,0)
GETPARAM ; Loads lab search/extract parameters from file 104.1
"RTN","MMRSCDI",160,0)
 N TSTNM,TST,TEST,IEN,TIEN,ITOP,TOP,ETOP,IBACT,BACT,EBACT
"RTN","MMRSCDI",161,0)
 N ETIOL,ETIOLOGY,ANTI,ANTIM,INC,MRSASTAP,ETIONAME,MMRSI,MMRSET,ORG
"RTN","MMRSCDI",162,0)
 N MDRO
"RTN","MMRSCDI",163,0)
 Q:'$D(DIVARY)
"RTN","MMRSCDI",164,0)
 S (TSTSTP,MMRSETIO,MMRSDIV)=0,DIVSN=""
"RTN","MMRSCDI",165,0)
 S MMRSMDRO=$O(^MMRS(104.2,"B","C. diff",0))
"RTN","MMRSCDI",166,0)
 F  S DIVSN=$O(DIVARY(DIVSN)) Q:DIVSN=""  D
"RTN","MMRSCDI",167,0)
 .K ^TMP($J,"MMRSCD")
"RTN","MMRSCDI",168,0)
 .S Y=DIVARY(DIVSN)
"RTN","MMRSCDI",169,0)
 .S IEN="",IEN=$O(^MMRS(104.1,"C",Y,MMRSMDRO,IEN))
"RTN","MMRSCDI",170,0)
 .Q:$G(IEN)'>0
"RTN","MMRSCDI",171,0)
 .S (FND,TST,INC)=0
"RTN","MMRSCDI",172,0)
 .;I $G(TSTSTP)'>0 S TSTSTP=1
"RTN","MMRSCDI",173,0)
 .;I TSTSTP D
"RTN","MMRSCDI",174,0)
 .S MDRO=MMRSMDRO
"RTN","MMRSCDI",175,0)
 .S TIEN=0 F  S TIEN=$O(^MMRS(104.1,IEN,3,TIEN)) Q:'TIEN  D
"RTN","MMRSCDI",176,0)
 ..S TEST=$P($G(^MMRS(104.1,IEN,3,TIEN,0)),U,1)
"RTN","MMRSCDI",177,0)
 ..Q:'TEST
"RTN","MMRSCDI",178,0)
 ..S INC=INC+1
"RTN","MMRSCDI",179,0)
 ..S TSTSTP=1
"RTN","MMRSCDI",180,0)
 ..S ^TMP($J,"MMRSCD","T",MDRO,TEST,0)=$P($G(^MMRS(104.1,IEN,3,TIEN,0)),U,2,3)
"RTN","MMRSCDI",181,0)
 .S IBACT=0 F  S IBACT=$O(^MMRS(104.1,IEN,4,IBACT)) Q:'IBACT  D
"RTN","MMRSCDI",182,0)
 ..S BACT=$G(^MMRS(104.1,IEN,4,IBACT,0))
"RTN","MMRSCDI",183,0)
 ..I BACT'="" S ^TMP($J,"MMRSCD","BACT",MDRO,"INC_REMARK",IBACT)=BACT
"RTN","MMRSCDI",184,0)
 .S EBACT=0 F  S EBACT=$O(^MMRS(104.1,IEN,5,EBACT)) Q:'EBACT  D
"RTN","MMRSCDI",185,0)
 ..S BACT=$G(^MMRS(104.1,MMRSMDRO,5,EBACT,0))
"RTN","MMRSCDI",186,0)
 ..I BACT'="" S ^TMP($J,"MMRSCD","BACT",MDRO,"EXC_REMARK",EBACT)=BACT
"RTN","MMRSCDI",187,0)
 .S ETIOL=0 F  S ETIOL=$O(^MMRS(104.1,IEN,6,ETIOL)) Q:'ETIOL  D
"RTN","MMRSCDI",188,0)
 ..S ETIOLOGY=$G(^MMRS(104.1,IEN,6,ETIOL,0))
"RTN","MMRSCDI",189,0)
 ..Q:'ETIOLOGY
"RTN","MMRSCDI",190,0)
 ..S ^TMP($J,"MMRSCD","ETIOL",MDRO,+ETIOLOGY)=""
"RTN","MMRSCDI",191,0)
 ..S ANTI=0 F  S ANTI=$O(^MMRS(104.1,IEN,6,ETIOL,1,ANTI)) Q:'ANTI  D
"RTN","MMRSCDI",192,0)
 ...S ANTIM=$P($G(^MMRS(104.1,IEN,6,ETIOL,1,ANTI,0)),U)
"RTN","MMRSCDI",193,0)
 ...I ANTIM S ^TMP($J,"MMRSCD","ETIOL",MDRO,ETIOLOGY,ANTI)=$G(^MMRS(104.1,IEN,6,ETIOL,1,ANTI,0))
"RTN","MMRSCDI",194,0)
 ..I $G(ETIOLOGY)'="" D
"RTN","MMRSCDI",195,0)
 ...D FIND^DIC(61.2,,".01E;@","PM","CLOSTRIDIUM DIFFICILE",,"B",,,"MMRSET")
"RTN","MMRSCDI",196,0)
 .S MMRSI="" F  S MMRSI=$O(MMRSET("DILIST",MMRSI)) Q:MMRSI=""  I +MMRSI>0  D
"RTN","MMRSCDI",197,0)
 ..S ETIONAME=$P($G(MMRSET("DILIST",MMRSI,0)),U,2)
"RTN","MMRSCDI",198,0)
 ..S ORG=$P($G(MMRSET("DILIST",MMRSI,0)),U,1)
"RTN","MMRSCDI",199,0)
 ..I ETIONAME'["CLOSTRIDIUM DIFFICILE" Q
"RTN","MMRSCDI",200,0)
 ..K ^TMP($J,"MMRSCD","ETIOL",MMRSMDRO,ORG)
"RTN","MMRSCDI",201,0)
 ..S ^TMP($J,"MMRSCD","ETIOL",MMRSMDRO,ORG)="",MDROETIO=1
"RTN","MMRSCDI",202,0)
 .K MMRSET
"RTN","MMRSCDI",203,0)
 .D SETDATA
"RTN","MMRSCDI",204,0)
 Q
"RTN","MMRSCDI",205,0)
 ;
"RTN","MMRSCDI",206,0)
SETDATA ;
"RTN","MMRSCDI",207,0)
 N LOCATION,LOCNAME,DFN,LOCTYPE,MMRSI,SDRESULT,Y,WLOC,WARD,WARDNAME,VAIP,WRDNME
"RTN","MMRSCDI",208,0)
 S DFN=0 F  S DFN=$O(^DPT(DFN)) Q:'DFN  D
"RTN","MMRSCDI",209,0)
 .Q:'$D(^PXRMINDX(63,"PI",DFN))
"RTN","MMRSCDI",210,0)
 .Q:$G(DFN)'>0
"RTN","MMRSCDI",211,0)
 .D SETDATA2(DFN)
"RTN","MMRSCDI",212,0)
 Q
"RTN","MMRSCDI",213,0)
 ;
"RTN","MMRSCDI",214,0)
SETDATA2(DFN) ;
"RTN","MMRSCDI",215,0)
 N INTT,IEN,INDATE,INIFN,MRSA,MRSACULT,LABORDER,TSTNM,LABTEST,ORDITM,ORDTEMP,PATNM,VADM,DCDATE
"RTN","MMRSCDI",216,0)
 S LOC=""
"RTN","MMRSCDI",217,0)
 S (CDIVT,PCD)=""
"RTN","MMRSCDI",218,0)
 ;Get MRSA history
"RTN","MMRSCDI",219,0)
 D GETLAB^MMRSCDI1(DFN,.MRSA,MMRSMDRO,MMRSNOW,"CD")
"RTN","MMRSCDI",220,0)
 Q:'$D(MRSA)
"RTN","MMRSCDI",221,0)
 S I="" F  S I=$O(MRSA(I)) Q:I=""  D
"RTN","MMRSCDI",222,0)
 .Q:I=""
"RTN","MMRSCDI",223,0)
 .S CDIVT=I
"RTN","MMRSCDI",224,0)
 .S MRSA=$P(MRSA(I),"^",1,2)
"RTN","MMRSCDI",225,0)
 .S LOC=+$P(MRSA(I),"^",3)
"RTN","MMRSCDI",226,0)
 .S DVSN=$$GET1^DIQ(44,+LOC,3.5,"E")
"RTN","MMRSCDI",227,0)
 .Q:DVSN'=DIVSN
"RTN","MMRSCDI",228,0)
 .Q:'$D(DIVARY(DVSN))
"RTN","MMRSCDI",229,0)
 .S WARDNAME=$$GET1^DIQ(44,+LOC,.01,"E")
"RTN","MMRSCDI",230,0)
 .;Get Order info
"RTN","MMRSCDI",231,0)
 .S LABORDER="^^"
"RTN","MMRSCDI",232,0)
 .Q:'CDIVT
"RTN","MMRSCDI",233,0)
 .S MRSA=$P(MRSA(I),"^",2)
"RTN","MMRSCDI",234,0)
 .S LRFILE=44
"RTN","MMRSCDI",235,0)
 .S STPCD=$$GET1^DIQ(LRFILE,+LOC,8,"I")
"RTN","MMRSCDI",236,0)
 .S TYPE=$$GET1^DIQ(LRFILE,+LOC,2,"E")
"RTN","MMRSCDI",237,0)
 .S SERV=$$GET1^DIQ(LRFILE,+LOC,9,"E")
"RTN","MMRSCDI",238,0)
 .D GTDATE(DFN,CDIVT,.INDATE,.DCDATE)
"RTN","MMRSCDI",239,0)
 .I $G(TYPE)'="",TYPE'="WARD" S (INDATE,DCDATE)=""
"RTN","MMRSCDI",240,0)
 .I $D(^TMP($J,"MMRSCD","T")) D
"RTN","MMRSCDI",241,0)
 ..S MDRO="" F  S MDRO=$O(^TMP($J,"MMRSCD","T",MDRO)) Q:MDRO=""  D
"RTN","MMRSCDI",242,0)
 ...Q:$G(MDRO)'>0
"RTN","MMRSCDI",243,0)
 ...S TST="" F  S TST=$O(^TMP($J,"MMRSCD","T",MDRO,TST)) Q:TST=""  D
"RTN","MMRSCDI",244,0)
 ....N TESTS D GORDITM(TST,.LABORDER,.TESTS) ;MIA/LMT - Added with patch MMRS*1*1
"RTN","MMRSCDI",245,0)
 .S PCD="",PATNM=$$GET1^DIQ(2,DFN,.01,"E")
"RTN","MMRSCDI",246,0)
 .Q:$D(^TMP($J,"MMRSCDI",DVSN,WARDNAME,PATNM,DFN,CDIVT))
"RTN","MMRSCDI",247,0)
 .I $D(^TMP($J,"MMRSCDI",DVSN,WARDNAME,PATNM,DFN)) D
"RTN","MMRSCDI",248,0)
 ..S PCD=999999999999999
"RTN","MMRSCDI",249,0)
 ..S PCD=$O(^TMP($J,"MMRSCDI",DVSN,WARDNAME,PATNM,DFN,PCD),-1)
"RTN","MMRSCDI",250,0)
 .S CD=CDIVT,CD=$O(MRSA(CD),-1)
"RTN","MMRSCDI",251,0)
 .I $G(CD)>0,CD<CDIVT S PCD=CD
"RTN","MMRSCDI",252,0)
 .Q:CDIVT<STRTDT
"RTN","MMRSCDI",253,0)
 .S ^TMP($J,"MMRSCDI",DVSN,WARDNAME,PATNM,DFN,CDIVT)=$G(TYPE)_U_$G(SERV)_U_$G(STPCD)_U_$G(CDIVT)_U_$G(INDATE)_U_$G(DCDATE)_U_$G(MRSA)_U_$G(PCD),PCD=""
"RTN","MMRSCDI",254,0)
 K MRSA
"RTN","MMRSCDI",255,0)
 Q
"RTN","MMRSCDI",256,0)
 ;
"RTN","MMRSCDI",257,0)
GTDATE(DFN,CDIVT,IND,DCDT) ;
"RTN","MMRSCDI",258,0)
 N DATE,IEN
"RTN","MMRSCDI",259,0)
 S (IND,DCDT)="",FND=0
"RTN","MMRSCDI",260,0)
 Q:$G(CDIVT)=""
"RTN","MMRSCDI",261,0)
 Q:'$D(^DGPM("APTT1",DFN))
"RTN","MMRSCDI",262,0)
 S DATE=9999999999,TT=1
"RTN","MMRSCDI",263,0)
 F  S DATE=$O(^DGPM("APTT"_TT,DFN,DATE),-1) Q:DATE=""  D  Q:FND
"RTN","MMRSCDI",264,0)
 .Q:DATE=""
"RTN","MMRSCDI",265,0)
 .I CDIVT<DATE Q
"RTN","MMRSCDI",266,0)
 .S IEN="",IEN=$O(^DGPM("APTT"_TT,DFN,DATE,IEN))
"RTN","MMRSCDI",267,0)
 .Q:$G(IEN)'>0
"RTN","MMRSCDI",268,0)
 .I $G(IEN)>0 D
"RTN","MMRSCDI",269,0)
 ..S IND=$$GET1^DIQ(405,IEN,.01,"I")
"RTN","MMRSCDI",270,0)
 ..S WRD=$$GET1^DIQ(405,IEN,.06,"E")
"RTN","MMRSCDI",271,0)
 ..S LOCNME="",LOCNME=$$GET1^DIQ(44,LOC,.01,"E")
"RTN","MMRSCDI",272,0)
 .I WRD=LOCNME S FND=1
"RTN","MMRSCDI",273,0)
 .S NXDT=$O(^DGPM("APTT"_TT,DFN,DATE),-1)
"RTN","MMRSCDI",274,0)
 .I $G(NXDT)'>0 K NXDT S FND=1
"RTN","MMRSCDI",275,0)
 .I $G(NXDT)>0 S DATE=NXDT,NXDT=""
"RTN","MMRSCDI",276,0)
 .Q:$G(DATE)'>0
"RTN","MMRSCDI",277,0)
 .S IEN="",IEN=$O(^DGPM("APTT"_TT,DFN,DATE,IEN))
"RTN","MMRSCDI",278,0)
 .S TIEN=$$GET1^DIQ(405,IEN,.17,"I")
"RTN","MMRSCDI",279,0)
 .I $G(TIEN)'>0 Q
"RTN","MMRSCDI",280,0)
 .S DCDT=$$GET1^DIQ(405,TIEN,.01,"I")
"RTN","MMRSCDI",281,0)
 .I DCDT>CDIVT S FND=1,DCDT="" Q
"RTN","MMRSCDI",282,0)
 .I DCDT'="" S FND=1 Q
"RTN","MMRSCDI",283,0)
 Q
"RTN","MMRSCDI",284,0)
 ;
"RTN","MMRSCDI",285,0)
GORDITM(LABTEST,LABORDER,TESTS) ;MIA/LMT - Added with patch MMRS*1*1 - Include panels in search
"RTN","MMRSCDI",286,0)
 N ORDITM,ORDTEMP,LABPANEL
"RTN","MMRSCDI",287,0)
 I $D(TESTS(LABTEST)) Q  ;prevent infinite recursion; if site has Panel A within Panel B, and Panel B within Panel A
"RTN","MMRSCDI",288,0)
 S TESTS(LABTEST)=1 ;mark that we have searched this test (to prevent infinite recursion)
"RTN","MMRSCDI",289,0)
 S ORDITM=0 F  S ORDITM=$O(^ORD(101.43,"ID",LABTEST_";99LRT",ORDITM)) Q:'ORDITM  D
"RTN","MMRSCDI",290,0)
 .S ORDTEMP=$$GETORD(DFN,ORDITM,INDATE)
"RTN","MMRSCDI",291,0)
 .I $P(LABORDER,U,1)'="YES"!(($P(LABORDER,U,3)'="YES")&($P(ORDTEMP,U,3)="YES")) S LABORDER=ORDTEMP
"RTN","MMRSCDI",292,0)
 S LABPANEL=0 F  S LABPANEL=$O(^LAB(60,"AB",LABTEST,LABPANEL)) Q:'LABPANEL  D
"RTN","MMRSCDI",293,0)
 .D GORDITM(LABPANEL,.LABORDER,.TESTS) ;Recursive call to check for tests within panels
"RTN","MMRSCDI",294,0)
 Q
"RTN","MMRSCDI",295,0)
GETORD(DFN,ORDITM,INDATE) ;
"RTN","MMRSCDI",296,0)
 N RESULT,START,STOP,DAS,STATUS,ORUPCHUK,LABREC
"RTN","MMRSCDI",297,0)
 S RESULT="^^"
"RTN","MMRSCDI",298,0)
 S START=$$FMADD^XLFDT(INDATE,-1)-.0000001
"RTN","MMRSCDI",299,0)
 F  S START=$O(^PXRMINDX(100,"PI",DFN,ORDITM,START)) Q:'START  D
"RTN","MMRSCDI",300,0)
 .S STOP="" F  S STOP=$O(^PXRMINDX(100,"PI",DFN,ORDITM,START,STOP)) Q:STOP=""  D
"RTN","MMRSCDI",301,0)
 ..S DAS="" F  S DAS=$O(^PXRMINDX(100,"PI",DFN,ORDITM,START,STOP,DAS)) Q:DAS=""  D
"RTN","MMRSCDI",302,0)
 ...D EN^ORX8(+DAS)
"RTN","MMRSCDI",303,0)
 ...S STATUS=$P(ORUPCHUK("ORSTS"),U,1)
"RTN","MMRSCDI",304,0)
 ...I STATUS'=2,STATUS'=5,STATUS'=6 Q
"RTN","MMRSCDI",305,0)
 ...S LABREC="NO"
"RTN","MMRSCDI",306,0)
 ...I STATUS=6!(STATUS=2) S LABREC="YES"
"RTN","MMRSCDI",307,0)
 ...I $P(RESULT,U,3)'="YES" S RESULT="YES^"_START_U_LABREC
"RTN","MMRSCDI",308,0)
 Q RESULT
"RTN","MMRSCDI",309,0)
PRT ;
"RTN","MMRSCDI",310,0)
 N LN,PG,LOCNAME,PATNM,DFN,NODE,LAST4,INTT,ADT,ORDDATE,VADM,QUIT,COUNT,DOB,PRVCDI
"RTN","MMRSCDI",311,0)
 K ^TMP($J,"MMRSCDI","T")
"RTN","MMRSCDI",312,0)
 K ^TMP($J,"MMRSCDI","ETIOL")
"RTN","MMRSCDI",313,0)
 S $P(LN,"-",160)=""
"RTN","MMRSCDI",314,0)
 S PG=1,QUIT=0
"RTN","MMRSCDI",315,0)
 S DVS=""
"RTN","MMRSCDI",316,0)
 F  S DVS=$O(DIVARY(DVS)) Q:DVS=""  D
"RTN","MMRSCDI",317,0)
 .I '$D(^TMP($J,"MMRSCDI",DVS)) D  Q
"RTN","MMRSCDI",318,0)
 ..S WARDNAME=""
"RTN","MMRSCDI",319,0)
 ..D PRTHDRS
"RTN","MMRSCDI",320,0)
 ..W !!!,"NO RECORDS FOUND FOR REPORTING PERIOD."
"RTN","MMRSCDI",321,0)
 .S WARDNAME="" F  S WARDNAME=$O(^TMP($J,"MMRSCDI",DVS,WARDNAME)) Q:WARDNAME=""  D  Q:QUIT
"RTN","MMRSCDI",322,0)
 ..I WARDNAME="" S QUIT=1 Q
"RTN","MMRSCDI",323,0)
 ..Q:'$D(^TMP($J,"MMRSCDI",DVS,WARDNAME))
"RTN","MMRSCDI",324,0)
 ..D PRTHDRS
"RTN","MMRSCDI",325,0)
 ..S PATNM="" F  S PATNM=$O(^TMP($J,"MMRSCDI",DVS,WARDNAME,PATNM)) Q:PATNM=""  D
"RTN","MMRSCDI",326,0)
 ...I PATNM?.N K ^TMP($J,"MMRSCDI",DVS,WARDNAME,PATNM) Q
"RTN","MMRSCDI",327,0)
 ...S DFN=0 F  S DFN=$O(^TMP($J,"MMRSCDI",DVS,WARDNAME,PATNM,DFN)) Q:'DFN  D  Q:'DFN
"RTN","MMRSCDI",328,0)
 ....S CD=0 F  S CD=$O(^TMP($J,"MMRSCDI",DVS,WARDNAME,PATNM,DFN,CD)) Q:'CD  D
"RTN","MMRSCDI",329,0)
 .....S NODE=$G(^TMP($J,"MMRSCDI",DVS,WARDNAME,PATNM,DFN,CD))
"RTN","MMRSCDI",330,0)
 .....S TYPE=$P(NODE,"^")
"RTN","MMRSCDI",331,0)
 .....S SERV=$P(NODE,"^",2)
"RTN","MMRSCDI",332,0)
 .....S STPCD=$P(NODE,"^",3)
"RTN","MMRSCDI",333,0)
 .....S CDIVT=$P(NODE,"^",4) I $G(CDIVT)>0 D
"RTN","MMRSCDI",334,0)
 ......S CDIVT=$$FMTE^XLFDT(CDIVT,2)
"RTN","MMRSCDI",335,0)
 ......I CDIVT["@" S CDIVT=$TR(CDIVT,"@"," ")
"RTN","MMRSCDI",336,0)
 .....S INDATE=$P(NODE,"^",5) I $G(INDATE)>0 D
"RTN","MMRSCDI",337,0)
 ......S INDATE=$$FMTE^XLFDT(INDATE,2)
"RTN","MMRSCDI",338,0)
 ......I INDATE["@" S INDATE=$TR(INDATE,"@"," ")
"RTN","MMRSCDI",339,0)
 .....S DCDT=$P(NODE,U,6) I $G(DCDT)>0 D
"RTN","MMRSCDI",340,0)
 ......S DCDT=$$FMTE^XLFDT(DCDT,2)
"RTN","MMRSCDI",341,0)
 ......I DCDT["@" S DCDT=$TR(DCDT,"@"," ")
"RTN","MMRSCDI",342,0)
 .....S PRVCDI=$P(NODE,U,8) I $G(PRVCDI)>0 D
"RTN","MMRSCDI",343,0)
 ......S PRVCDI=$$FMTE^XLFDT(PRVCDI,2)
"RTN","MMRSCDI",344,0)
 ......I PRVCDI["@" S PRVCDI=$TR(PRVCDI,"@"," ")
"RTN","MMRSCDI",345,0)
 .....D KVA^VADPT
"RTN","MMRSCDI",346,0)
 .....D DEM^VADPT
"RTN","MMRSCDI",347,0)
 .....S LAST4=$E($P(VADM(2),U),6,9)
"RTN","MMRSCDI",348,0)
 .....D KVA^VADPT
"RTN","MMRSCDI",349,0)
 .....S ORDDATE=$P(NODE,"^",5)
"RTN","MMRSCDI",350,0)
 .....I ORDDATE S ORDDATE=$$FMTE^XLFDT(ORDDATE,"2M")
"RTN","MMRSCDI",351,0)
 .....S DOB=$$GET1^DIQ(2,DFN,.03,"E")
"RTN","MMRSCDI",352,0)
 .....W !,$E(PATNM,1,30),?25,LAST4,?30,DOB,?42,$G(CDIVT),?70,$G(INDATE),?90,$G(WARDNAME),?106,$G(DCDT),?130,$G(PRVCDI)
"RTN","MMRSCDI",353,0)
 .....S COUNT=$G(COUNT)+1
"RTN","MMRSCDI",354,0)
 .....S DL="^"
"RTN","MMRSCDI",355,0)
 .....S ^TMP($J,"MMRS",COUNT)=PATNM_DL_LAST4_DL_DOB_DL_$G(CDIVT)_DL_$G(INDATE)_DL_$G(WARDNAME)_DL_$G(TYPE)_DL_$G(SERV)_DL_$G(STPCD)_DL_$G(DCDT)_DL_$G(PRVCDI)
"RTN","MMRSCDI",356,0)
 ....S PRVCDI=""
"RTN","MMRSCDI",357,0)
 I '$D(ZTSK)&($G(ION)'["P-MESS") D
"RTN","MMRSCDI",358,0)
 .D PRINTCDI
"RTN","MMRSCDI",359,0)
 W !!,"END OF REPORT."
"RTN","MMRSCDI",360,0)
 Q
"RTN","MMRSCDI",361,0)
 ;
"RTN","MMRSCDI",362,0)
PRINTCDI ;
"RTN","MMRSCDI",363,0)
 W !!
"RTN","MMRSCDI",364,0)
 I '$D(^TMP($J,"MMRS")) W !!!,"No CDI cases found during specified date range" Q
"RTN","MMRSCDI",365,0)
 N DIR,DUOUT,DTOUT,DIRUT,Y
"RTN","MMRSCDI",366,0)
 S PRINT=0
"RTN","MMRSCDI",367,0)
 S DIR("A")="Print a delimited report to the screen? (Y/N): "
"RTN","MMRSCDI",368,0)
 S DIR(0)="YA" D ^DIR
"RTN","MMRSCDI",369,0)
 I $D(DIRUT)!($D(DUOUT)!$D(DTOUT)) S PRINT=0
"RTN","MMRSCDI",370,0)
 I Y>0 S PRINT=1
"RTN","MMRSCDI",371,0)
 S CDI=1
"RTN","MMRSCDI",372,0)
 Q:'PRINT
"RTN","MMRSCDI",373,0)
 W !!,"Delimited Report will now be printed to the screen..." H 3
"RTN","MMRSCDI",374,0)
 D ^%ZIS
"RTN","MMRSCDI",375,0)
 W @IOF
"RTN","MMRSCDI",376,0)
 N C,I,DL
"RTN","MMRSCDI",377,0)
 S (C,I)="",DL="^",CNT=0
"RTN","MMRSCDI",378,0)
 F  S C=$O(^TMP($J,"MMRS",C)) Q:C=""  D
"RTN","MMRSCDI",379,0)
 .S X1=$P(^TMP($J,"MMRS",C),DL)
"RTN","MMRSCDI",380,0)
 .S X2=$P(^TMP($J,"MMRS",C),DL,2)
"RTN","MMRSCDI",381,0)
 .S X3=$P(^TMP($J,"MMRS",C),DL,3)
"RTN","MMRSCDI",382,0)
 .S X4=$P(^TMP($J,"MMRS",C),DL,4)
"RTN","MMRSCDI",383,0)
 .S X5=$P(^TMP($J,"MMRS",C),DL,5)
"RTN","MMRSCDI",384,0)
 .S X6=$P(^TMP($J,"MMRS",C),DL,6)
"RTN","MMRSCDI",385,0)
 .S X7=$P(^TMP($J,"MMRS",C),DL,7)
"RTN","MMRSCDI",386,0)
 .S X8=$P(^TMP($J,"MMRS",C),DL,8)
"RTN","MMRSCDI",387,0)
 .S X9=$P(^TMP($J,"MMRS",C),DL,9)
"RTN","MMRSCDI",388,0)
 .S X10=""
"RTN","MMRSCDI",389,0)
 .S X11=$P(^TMP($J,"MMRS",C),DL,10)
"RTN","MMRSCDI",390,0)
 .S X12=$P(^TMP($J,"MMRS",C),DL,11)
"RTN","MMRSCDI",391,0)
 .W !,X1_DL_X2_DL_X3_DL_X4_DL_X5_DL_X6_DL_X7_DL_X8_DL_X9_DL_X10_DL_X11_DL_X12
"RTN","MMRSCDI",392,0)
 Q
"RTN","MMRSCDI",393,0)
 ;
"RTN","MMRSCDI",394,0)
PRTHDRS ; Helper Function for PRT - Prints report headers
"RTN","MMRSCDI",395,0)
 W @IOF
"RTN","MMRSCDI",396,0)
 W ?13,"FACILITY CDI CASES REPORT"
"RTN","MMRSCDI",397,0)
 W !,?13,"Division: ",DVS
"RTN","MMRSCDI",398,0)
 W !,?13,"Geographical Location: ",WARDNAME
"RTN","MMRSCDI",399,0)
 W !,?13,"Report period: ",$$FMTE^XLFDT(STRTDT)," to ",$$FMTE^XLFDT(ENDDT)
"RTN","MMRSCDI",400,0)
 W !,?13,"Report printed on: ",$$FMTE^XLFDT(MMRSNOW),?75,"PAGE: ",PG
"RTN","MMRSCDI",401,0)
 W !,"PATIENT",?25,"SSN",?30,"DOB",?42,"CDI Event D/T",?70,"ADM D/T",?90,"LOCATION",?105,"DC D/T",?130,"PREV CDI Event D/T"
"RTN","MMRSCDI",402,0)
 W !,LN
"RTN","MMRSCDI",403,0)
 S PG=PG+1
"RTN","MMRSCDI",404,0)
 Q
"RTN","MMRSCDI",405,0)
ASKDVC ;Prompts user for device of output (allows queuing)
"RTN","MMRSCDI",406,0)
 W !!
"RTN","MMRSCDI",407,0)
 N MMRSVAR
"RTN","MMRSCDI",408,0)
 W !!!,"This report is designed for a 132 column format (compressed).",!
"RTN","MMRSCDI",409,0)
 S MMRSVAR("MMRSLOC")="",MMRS("MMRSLOC(")="",MMRSVAR("MMRSDIV")="",MMRSVAR("STRTDT")=""
"RTN","MMRSCDI",410,0)
 S MMRSVAR("ENDDT")="",MMRSVAR("TSTSTP")="",MMRSVAR("MDROETIO")="",MMRSVAR("DFLTDT")="",MMRSVAR("DIVARY")="",MMRSVAR("DIVARY(")=""
"RTN","MMRSCDI",411,0)
 D EN^XUTMDEVQ("MAIN2^MMRSCDI","Print CDI report (MMRSCDI)",.MMRSVAR,"QM",1)
"RTN","MMRSCDI",412,0)
 W:$D(ZTSK) !,"Report Queued to Print ("_ZTSK_").",!
"RTN","MMRSCDI",413,0)
 Q
"RTN","MMRSCDI",414,0)
 ;
"RTN","MMRSCDI",415,0)
QUIT ;
"RTN","MMRSCDI",416,0)
 K ALL,DFLDT,DIV,DIVSN,DVS,FID,IXI,LIEN,LOCNME,MMRS
"RTN","MMRSCDI",417,0)
 K MMRSETIO,NUMDIV,STP,TSTSTP,TT,WR,WRD,DFLTDT
"RTN","MMRSCDI",418,0)
 K ENDDT,FND,CDI,LCPTR,LRFILE,MMRSMDRO,PCDIVT,PRINT,PCDIVT,SERV
"RTN","MMRSCDI",419,0)
 K STPCD,STRTDT,TYPE,WPTR,WRDPTR,X2,X10,X12,X2,X3,X4,X5,X6,X7,X8,X9
"RTN","MMRSCDI",420,0)
 K X1,X11,MRSA,^TMP($J),ORGP,MDROETIO,CNT,PCD,CD,ETIO,III,IX,I
"RTN","MMRSCDI",421,0)
 K LOC,MMRSNOW,PTR,TSTSTP,ZTSK,DVSN,DIVARY
"RTN","MMRSCDI",422,0)
 Q
"RTN","MMRSCDI",423,0)
 ;
"RTN","MMRSCDI1")
0^2^B42768912^B47343212
"RTN","MMRSCDI1",1,0)
MMRSCDI1 ;LEIDOS/TCK - Print CDI Report Cont. (Contains functions to collect patient labs and swabbing rate) ; 3/8/17 11:39am
"RTN","MMRSCDI1",2,0)
 ;;1.0;MDRO TOOLS REPORTS MENU;**4,5**;Mar 22, 2009;Build 146
"RTN","MMRSCDI1",3,0)
 ;
"RTN","MMRSCDI1",4,0)
GETLAB(DFN,MRSA,LRMDRO,LREND,LRDTTYP) ;RETURN YES/NO^RESULT
"RTN","MMRSCDI1",5,0)
 N LRRSLT,LRTST,TMPRSLT,NUMB,TSTRSLT
"RTN","MMRSCDI1",6,0)
 S LRRSLT="^",NUMB=0
"RTN","MMRSCDI1",7,0)
 I $G(DFN)=""!($G(LRMDRO)="")!($G(LREND)="") Q LRRSLT
"RTN","MMRSCDI1",8,0)
 ;CHECK FOR MI RSULTS
"RTN","MMRSCDI1",9,0)
 I MDROETIO D
"RTN","MMRSCDI1",10,0)
 .D GETMI(DFN,LRMDRO,LREND,LRDTTYP,.MRSA)
"RTN","MMRSCDI1",11,0)
 .Q:'$D(MRSA)
"RTN","MMRSCDI1",12,0)
 ;CHECK FOR CH RESULTS
"RTN","MMRSCDI1",13,0)
 I TSTSTP D
"RTN","MMRSCDI1",14,0)
 .S LRRSLT="^"
"RTN","MMRSCDI1",15,0)
 .S LRTST=0 F  S LRTST=$O(^TMP($J,"MMRSCD","T",LRMDRO,LRTST)) Q:'LRTST  D
"RTN","MMRSCDI1",16,0)
 ..S SUBS=$$GET1^DIQ(60,+LRTST,4,"I")
"RTN","MMRSCDI1",17,0)
 ..I SUBS="CH" D GETCH(DFN,LRMDRO,+LRTST,LREND,LRDTTYP,.MRSA)
"RTN","MMRSCDI1",18,0)
 Q
"RTN","MMRSCDI1",19,0)
 ;
"RTN","MMRSCDI1",20,0)
GETCH(DFN,LRMDRO,LRTST,LREND,LRDTTYP,MRSA) ;RETURN YES^RESULT
"RTN","MMRSCDI1",21,0)
 N LIENS,LOC,LRRSLT,LRDFN,LRDATE,LRRADEND,DAS,LRIDT,LRSITE,TSTRSLT,LRRAD
"RTN","MMRSCDI1",22,0)
 S LRRSLT="^",CDIVT=""
"RTN","MMRSCDI1",23,0)
 S LRDATE=""
"RTN","MMRSCDI1",24,0)
 I LRDTTYP="RAD" S LRDATE=0,LRRADEND=LREND,LREND=9999999
"RTN","MMRSCDI1",25,0)
 Q:'$D(^PXRMINDX(63,"PI",DFN,+LRTST))
"RTN","MMRSCDI1",26,0)
 F  S LRDATE=$O(^PXRMINDX(63,"PI",DFN,+LRTST,LRDATE)) Q:'LRDATE  D
"RTN","MMRSCDI1",27,0)
 .Q:LRDATE>ENDDT
"RTN","MMRSCDI1",28,0)
 .Q:LRDATE<DFLTDT
"RTN","MMRSCDI1",29,0)
 .S DAS=0 F  S DAS=$O(^PXRMINDX(63,"PI",DFN,+LRTST,LRDATE,DAS)) Q:'DAS  D
"RTN","MMRSCDI1",30,0)
 ..S LRDFN=$P(DAS,";")
"RTN","MMRSCDI1",31,0)
 ..Q:'$D(^LR(LRDFN,"CH"))
"RTN","MMRSCDI1",32,0)
 ..S LRIDT=$P(DAS,";",3)
"RTN","MMRSCDI1",33,0)
 ..I LRDTTYP="RAD" S LRRAD=$P($G(^LR(LRDFN,"CH",LRIDT,0)),U,3) I LRRAD<STRTDT!(LRRAD>LRRADEND) Q
"RTN","MMRSCDI1",34,0)
 ..Q:LRDATE<DFLTDT
"RTN","MMRSCDI1",35,0)
 ..Q:LRDATE>ENDDT
"RTN","MMRSCDI1",36,0)
 ..Q:$P($G(^LR(LRDFN,"CH",LRIDT,0)),U,3)=""
"RTN","MMRSCDI1",37,0)
 ..S LIEN=LRIDT_","_LRDFN_","
"RTN","MMRSCDI1",38,0)
 ..S CDIVT=$$GET1^DIQ(63.04,LIEN,.01,"I")
"RTN","MMRSCDI1",39,0)
 ..S LOC=+$$GET1^DIQ(63.04,LIEN,.111,"I")
"RTN","MMRSCDI1",40,0)
 ..S LRLOC=$G(LOC)
"RTN","MMRSCDI1",41,0)
 ..S $P(LRRSLT,"^",1)="Y"
"RTN","MMRSCDI1",42,0)
 ..S TSTRSLT=$$CHRSLT(LRDFN,LRIDT,LRMDRO,LRTST)
"RTN","MMRSCDI1",43,0)
 ..I TSTRSLT["POS",(($P(LRRSLT,"^",2)="")!($P($P(LRRSLT,"^",2),";",3)>LRIDT)) D
"RTN","MMRSCDI1",44,0)
 ...S $P(LRRSLT,"^",2)=(TSTRSLT_";"_LRDFN_";"_LRIDT_";CH")
"RTN","MMRSCDI1",45,0)
 ...S LRRSLT=LRRSLT_"^"_LOC
"RTN","MMRSCDI1",46,0)
 ...S MRSA(CDIVT)=LRRSLT,LRRSLT="^"
"RTN","MMRSCDI1",47,0)
 Q
"RTN","MMRSCDI1",48,0)
 ;
"RTN","MMRSCDI1",49,0)
GETMI(DFN,LRMDRO,LREND,LRDTTYP,MRSA) ;RETURN YES^RESULT
"RTN","MMRSCDI1",50,0)
 N LRRSLT,LRDFN,LRDATE,LRRADEND,DAS,LRIDT,LRSITE,TSTRSLT,LRRAD,RSARY
"RTN","MMRSCDI1",51,0)
 S LRRSLT="^"
"RTN","MMRSCDI1",52,0)
 I '$D(^TMP($J,"MMRSCD","BACT",LRMDRO,"INC_REMARK")),'$D(^TMP($J,"MMRSCD","ETIOL",LRMDRO)) Q LRRSLT
"RTN","MMRSCDI1",53,0)
 S LRDFN=$$LRDFN^LR7OR1(DFN)
"RTN","MMRSCDI1",54,0)
 Q:'LRDFN LRRSLT
"RTN","MMRSCDI1",55,0)
 Q:'$D(^LR(LRDFN,"MI"))
"RTN","MMRSCDI1",56,0)
 S LRIDT=(9999999-LREND)-.0000001,COUNT=0
"RTN","MMRSCDI1",57,0)
 I LRDTTYP="RAD" S LRIDT=0,LREND=99999999
"RTN","MMRSCDI1",58,0)
 F  S LRIDT=$O(^LR(LRDFN,"MI",LRIDT)) Q:'LRIDT!(LRIDT<LREND)  D
"RTN","MMRSCDI1",59,0)
 .I LRDTTYP="RAD" S LRRAD=$P($G(^LR(LRDFN,"MI",LRIDT,0)),U,3) I LRRAD<STRTDT!(LRRAD>LREND) Q
"RTN","MMRSCDI1",60,0)
 .;CHECK FOR PRELIM
"RTN","MMRSCDI1",61,0)
 .S LIEN=LRIDT_","_LRDFN_","
"RTN","MMRSCDI1",62,0)
 .Q:$$GET1^DIQ(63.05,LIEN,11.5,"I")="P"
"RTN","MMRSCDI1",63,0)
 .;GET LOCATION AND COLLECTION DATE/TIME FROM 63
"RTN","MMRSCDI1",64,0)
 .S LOC=+$$GET1^DIQ(63.05,LIEN,.111,"I")
"RTN","MMRSCDI1",65,0)
 .S CDIVT=$$GET1^DIQ(63.05,LIEN,.01,"I")
"RTN","MMRSCDI1",66,0)
 .Q:$G(CDIVT)<DFLTDT
"RTN","MMRSCDI1",67,0)
 .Q:$G(CDIVT)>ENDDT
"RTN","MMRSCDI1",68,0)
 .S LRSITE=$P($G(^LR(LRDFN,"MI",LRIDT,0)),U,5)
"RTN","MMRSCDI1",69,0)
 .S $P(LRRSLT,"^",1)="Y"
"RTN","MMRSCDI1",70,0)
 .S TSTRSLT=$$MIRSLT(LRDFN,LRIDT,LRMDRO)
"RTN","MMRSCDI1",71,0)
 .I TSTRSLT["POS",(($P(LRRSLT,"^",2)="")!($P($P(LRRSLT,"^",2),";",3)>LRIDT)) D
"RTN","MMRSCDI1",72,0)
 ..S $P(LRRSLT,"^",2)=(TSTRSLT_";"_LRDFN_";"_LRIDT_";MI")
"RTN","MMRSCDI1",73,0)
 ..S LRRSLT=LRRSLT_"^"_LOC
"RTN","MMRSCDI1",74,0)
 ..S MRSA(CDIVT)=LRRSLT,LRRSLT="^"
"RTN","MMRSCDI1",75,0)
 Q
"RTN","MMRSCDI1",76,0)
 ;
"RTN","MMRSCDI1",77,0)
CHRSLT(LRDFN,LRIDT,LRMDRO,LRTST) ;RETURNS 'POS' OR NULL STRING (IF NOT POSITIVE)
"RTN","MMRSCDI1",78,0)
 N RESULT,LRLOC,LRND,LRPC,LRRES,LRIND,LRINDVAL,LRSPEC,LRLOW,LRHIG
"RTN","MMRSCDI1",79,0)
 S RESULT=""
"RTN","MMRSCDI1",80,0)
 S LRLOC=$P($G(^LAB(60,+LRTST,0)),U,5)
"RTN","MMRSCDI1",81,0)
 S LRND=$P(LRLOC,";",2) Q:+LRND'>0 RESULT
"RTN","MMRSCDI1",82,0)
 S LRPC=$P(LRLOC,";",3) Q:+LRPC'>0 RESULT
"RTN","MMRSCDI1",83,0)
 S LRRES=$P($G(^LR(LRDFN,"CH",LRIDT,LRND)),U,LRPC) Q:LRRES="" RESULT
"RTN","MMRSCDI1",84,0)
 S LRIND=$P($G(^TMP($J,"MMRSCD","T",LRMDRO,LRTST,0)),U,1)
"RTN","MMRSCDI1",85,0)
 S LRINDVAL=$P($G(^TMP($J,"MMRSCD","T",LRMDRO,LRTST,0)),U,2)
"RTN","MMRSCDI1",86,0)
 Q:LRIND="" RESULT
"RTN","MMRSCDI1",87,0)
 I LRIND=1 D  Q RESULT
"RTN","MMRSCDI1",88,0)
 .Q:'LRRES
"RTN","MMRSCDI1",89,0)
 .S LRSPEC=$P($G(^LR(LRDFN,"CH",LRIDT,0)),U,5) Q:LRSPEC=""
"RTN","MMRSCDI1",90,0)
 .Q:'$D(^LAB(60,LRTST,1,LRSPEC,0))
"RTN","MMRSCDI1",91,0)
 .S LRLOW=$P(^LAB(60,LRTST,1,LRSPEC,0),U,2),LRHIG=$P(^LAB(60,LRTST,1,LRSPEC,0),U,3)
"RTN","MMRSCDI1",92,0)
 .Q:'LRLOW!('LRHIG)
"RTN","MMRSCDI1",93,0)
 .I LRRES<LRLOW!(LRRES>LRHIG) S RESULT="POS" Q
"RTN","MMRSCDI1",94,0)
 I LRINDVAL="" Q RESULT
"RTN","MMRSCDI1",95,0)
 S LRRES=$$UP^XLFSTR(LRRES),LRINDVAL=$$UP^XLFSTR(LRINDVAL)
"RTN","MMRSCDI1",96,0)
 I LRIND=2,(LRRES[LRINDVAL) Q "POS"
"RTN","MMRSCDI1",97,0)
 I LRIND=3,(LRRES>LRINDVAL) Q "POS"
"RTN","MMRSCDI1",98,0)
 I LRIND=4,(LRRES<LRINDVAL) Q "POS"
"RTN","MMRSCDI1",99,0)
 I LRIND=5,(LRRES=LRINDVAL) Q "POS"
"RTN","MMRSCDI1",100,0)
 Q RESULT
"RTN","MMRSCDI1",101,0)
 ;
"RTN","MMRSCDI1",102,0)
MIRSLT(LRDFN,LRIDT,LRMDRO) ;RETURNS 'POS' OR NULL STRING (IF NOT POSITIVE)
"RTN","MMRSCDI1",103,0)
 N RESULT,LRETND,LRETI,LRANTI,LRANTIND,LRANTINV,LRAND,LRRES,BACTRPT,RPTRMRK
"RTN","MMRSCDI1",104,0)
 S RESULT=""
"RTN","MMRSCDI1",105,0)
 ;Check Etiology
"RTN","MMRSCDI1",106,0)
 I $D(^TMP($J,"MMRSCD","ETIOL",LRMDRO)) D  Q:RESULT="POS" RESULT
"RTN","MMRSCDI1",107,0)
 .S LRETND=0 F  S LRETND=$O(^LR(LRDFN,"MI",LRIDT,3,LRETND)) Q:'LRETND!(RESULT="POS")  D
"RTN","MMRSCDI1",108,0)
 ..S LRETI=$P($G(^LR(LRDFN,"MI",LRIDT,3,LRETND,0)),U)
"RTN","MMRSCDI1",109,0)
 ..Q:+LRETI'>0
"RTN","MMRSCDI1",110,0)
 ..I ('$O(^TMP($J,"MMRSCD","ETIOL",LRMDRO,LRETI,0))) D  Q
"RTN","MMRSCDI1",111,0)
 ...I $D(^TMP($J,"MMRSCD","ETIOL",LRMDRO,LRETI)) S RESULT="POS"
"RTN","MMRSCDI1",112,0)
 ..S LRANTI=0 F  S LRANTI=$O(^TMP($J,"MMRSCD","ETIOL",LRMDRO,LRETI,LRANTI)) Q:'LRANTI  D
"RTN","MMRSCDI1",113,0)
 ...S LRANTIND=$P(^TMP($J,"MMRSCD","ETIOL",LRMDRO,LRETI,LRANTI),U,1)
"RTN","MMRSCDI1",114,0)
 ...S LRANTINV=$P(^TMP($J,"MMRSCD","ETIOL",LRMDRO,LRETI,LRANTI),U,2)
"RTN","MMRSCDI1",115,0)
 ...;S LRAND=$P($G(^LAB(62.06,LRANTI,0)),U,2) Q:LRAND=""
"RTN","MMRSCDI1",116,0)
 ...Q:$P($G(^LR(LRDFN,"MI",LRIDT,3,LRETND,LRAND)),U,2)=""
"RTN","MMRSCDI1",117,0)
 ...Q:$$UP^XLFSTR($E($P($G(^LR(LRDFN,"MI",LRIDT,3,LRETND,LRAND)),U,2),1,1))="S"
"RTN","MMRSCDI1",118,0)
 ...I LRANTIND=""!(LRANTINV="") Q
"RTN","MMRSCDI1",119,0)
 ...S LRRES=$$UP^XLFSTR($P($G(^LR(LRDFN,"MI",LRIDT,3,LRETND,LRAND)),U,2))
"RTN","MMRSCDI1",120,0)
 ...S LRANTINV=$$UP^XLFSTR(LRANTINV)
"RTN","MMRSCDI1",121,0)
 ...S LRANTIND=$$UP^XLFSTR(LRANTIND)
"RTN","MMRSCDI1",122,0)
 ...I LRANTIND=1,(LRRES[LRANTINV) S RESULT="POS" Q
"RTN","MMRSCDI1",123,0)
 ...I LRANTIND=2,(LRRES>LRANTINV) S RESULT="POS" Q
"RTN","MMRSCDI1",124,0)
 ...I LRANTIND=3,(LRRES<LRANTINV) S RESULT="POS" Q
"RTN","MMRSCDI1",125,0)
 ...I LRANTIND=4,(LRRES=LRANTINV) S RESULT="POS" Q
"RTN","MMRSCDI1",126,0)
 Q:RESULT="POS" "POS"
"RTN","MMRSCDI1",127,0)
 ;Check Bacteriology Report Remarks
"RTN","MMRSCDI1",128,0)
 I '$D(^TMP($J,"MMRSCD","BACT",LRMDRO,"INC_REMARK")) Q RESULT
"RTN","MMRSCDI1",129,0)
 S BACTRPT=0 F  S BACTRPT=$O(^LR(LRDFN,"MI",LRIDT,4,BACTRPT)) Q:'BACTRPT!(RESULT="POS")  D
"RTN","MMRSCDI1",130,0)
 .S RPTRMRK=$P($G(^LR(LRDFN,"MI",LRIDT,4,BACTRPT,0)),U,1)
"RTN","MMRSCDI1",131,0)
 .Q:RPTRMRK=""
"RTN","MMRSCDI1",132,0)
 .I $$BACTRPT(LRMDRO,"INC_REMARK",RPTRMRK)&('$$BACTRPT(LRMDRO,"EXC_REMARK",RPTRMRK)) S RESULT="POS"
"RTN","MMRSCDI1",133,0)
 Q RESULT
"RTN","MMRSCDI1",134,0)
 ;
"RTN","MMRSCDI1",135,0)
SCRNTOP(LRSITE,LRMDRO) ;CHECK TO SEE IF SCREEN ON SITE
"RTN","MMRSCDI1",136,0)
 Q:+LRSITE'>0 0
"RTN","MMRSCDI1",137,0)
 I $D(^TMP($J,"MMRSCD","TOP",LRMDRO,"INC_TOP"))&$D(^TMP($J,"MMRSCD","TOP",LRMDRO,"EXC_TOP")) Q 0
"RTN","MMRSCDI1",138,0)
 I '$D(^TMP($J,"MMRSCD","TOP",LRMDRO,"INC_TOP"))&'$D(^TMP($J,"MMRSCD","TOP",LRMDRO,"EXC_TOP")) Q 0
"RTN","MMRSCDI1",139,0)
 I ($D(^TMP($J,"MMRSCD","TOP",LRMDRO,"INC_TOP")))&($D(^TMP($J,"MMRSCD","TOP",LRMDRO,"INC_TOP",LRSITE))) Q 0
"RTN","MMRSCDI1",140,0)
 I ($D(^TMP($J,"MMRSCD","TOP",LRMDRO,"EXC_TOP")))&('$D(^TMP($J,"MMRSCD","TOP",LRMDRO,"EXC_TOP",LRSITE))) Q 0
"RTN","MMRSCDI1",141,0)
 Q 1
"RTN","MMRSCDI1",142,0)
 ;
"RTN","MMRSCDI1",143,0)
BACTRPT(LRMDRO,RPTTYPE,RPTRMRK) ;Is this comment contained in the parameters
"RTN","MMRSCDI1",144,0)
 N RESULT,MMRSI,LRINDVAL
"RTN","MMRSCDI1",145,0)
 S RESULT=0
"RTN","MMRSCDI1",146,0)
 S MMRSI=0 F  S MMRSI=$O(^TMP($J,"MMRSCD","BACT",LRMDRO,RPTTYPE,MMRSI)) Q:'MMRSI!(RESULT=1)  D
"RTN","MMRSCDI1",147,0)
 .S LRINDVAL=$G(^TMP($J,"MMRSCD","BACT",LRMDRO,RPTTYPE,MMRSI))
"RTN","MMRSCDI1",148,0)
 .I ($$UP^XLFSTR(RPTRMRK))[($$UP^XLFSTR(LRINDVAL)) S RESULT=1
"RTN","MMRSCDI1",149,0)
 Q RESULT
"RTN","MMRSCDI1",150,0)
 ;
"RTN","MMRSCDI1",151,0)
END ;
"RTN","MMRSCDI1",152,0)
 K CDIVT,COUNT,DFLTDT,ENDDT,LIEN,STRTDT,SUBS,TSTSTP,MDROETIO
"RTN","MMRSCDI1",153,0)
 Q
"RTN","MMRSCDI2")
0^17^B164313738^B162714137
"RTN","MMRSCDI2",1,0)
MMRSCDI2 ;LEIDOS/TCK - Print CDI report ; 4/12/17 11:57am
"RTN","MMRSCDI2",2,0)
 ;;1.0;MRSA TOOLS REPORTS MENU;**4,5**;Mar 22, 2009;Build 146
"RTN","MMRSCDI2",3,0)
 ;
"RTN","MMRSCDI2",4,0)
MAIN ;
"RTN","MMRSCDI2",5,0)
 N EXTFLG,MMRSLOC
"RTN","MMRSCDI2",6,0)
 S NOCONF=0
"RTN","MMRSCDI2",7,0)
 ;check if parameters are setup.
"RTN","MMRSCDI2",8,0)
 I '$D(ZTQUEUED) D  Q
"RTN","MMRSCDI2",9,0)
 .W !!,"This option can only be run via TaskMan"
"RTN","MMRSCDI2",10,0)
 .W !
"RTN","MMRSCDI2",11,0)
 D CLEAN
"RTN","MMRSCDI2",12,0)
 D CHECK^MMRSIPC
"RTN","MMRSCDI2",13,0)
 D CHECK
"RTN","MMRSCDI2",14,0)
 I $D(EXTFLG) W ! H 2 Q
"RTN","MMRSCDI2",15,0)
 S NOW=$$NOW^XLFDT(),MMRSNOW=NOW
"RTN","MMRSCDI2",16,0)
 S FIRST=$E(NOW,1,5)_"01"
"RTN","MMRSCDI2",17,0)
 S ENDDT=$$FMADD^XLFDT(FIRST,-1,0,0,0)_".24"
"RTN","MMRSCDI2",18,0)
 S STRTDT=$E(ENDDT,1,5)_"01",DFLTDT=STRTDT
"RTN","MMRSCDI2",19,0)
 S DFLTDT=STRTDT
"RTN","MMRSCDI2",20,0)
 K EXTFLG
"RTN","MMRSCDI2",21,0)
 S MMRSNOW=$$NOW^XLFDT()
"RTN","MMRSCDI2",22,0)
 D MAIN2
"RTN","MMRSCDI2",23,0)
 D QUIT
"RTN","MMRSCDI2",24,0)
 Q
"RTN","MMRSCDI2",25,0)
 ;
"RTN","MMRSCDI2",26,0)
CHECK ; Check if lab tests and etiologies are setup
"RTN","MMRSCDI2",27,0)
 N II,XX,TST,MRSASTAP,ORG,ETIONAME,MMRSET,MMRSI
"RTN","MMRSCDI2",28,0)
 S (MDROETIO,TSTSTP)=0
"RTN","MMRSCDI2",29,0)
 I $D(^MMRS(104.1)) D
"RTN","MMRSCDI2",30,0)
 .S II=0 F  S II=$O(^MMRS(104.1,II)) Q:II'>0  D  Q:MDROETIO!(TSTSTP)
"RTN","MMRSCDI2",31,0)
 ..Q:'$D(^MMRS(104.1,II,0))
"RTN","MMRSCDI2",32,0)
 ..S ORGP=$P(^MMRS(104.1,II,0),"^")
"RTN","MMRSCDI2",33,0)
 ..Q:$G(ORGP)'>0
"RTN","MMRSCDI2",34,0)
 ..S ETIO=$$GET1^DIQ(104.2,ORGP,.01,"E")
"RTN","MMRSCDI2",35,0)
 ..S ETIO=$$UPPER^DGUTL(ETIO)
"RTN","MMRSCDI2",36,0)
 ..Q:ETIO'["DIFF"
"RTN","MMRSCDI2",37,0)
 ..S IX=0
"RTN","MMRSCDI2",38,0)
 ..F  S IX=$O(^MMRS(104.1,II,3,IX)) Q:IX'>0  D  Q:TSTSTP
"RTN","MMRSCDI2",39,0)
 ...I $G(IX)>0 D
"RTN","MMRSCDI2",40,0)
 ....Q:'$D(^MMRS(104.1,II,3,IX,0))
"RTN","MMRSCDI2",41,0)
 ....S III=IX_","_II_","
"RTN","MMRSCDI2",42,0)
 ....Q:III=""
"RTN","MMRSCDI2",43,0)
 ....S TST=$$GET1^DIQ(104.15,III,.01,"E")
"RTN","MMRSCDI2",44,0)
 ....I $G(TST)'=""&(TST["DIFF") S TSTSTP=1
"RTN","MMRSCDI2",45,0)
 ....Q:$G(TST)'["DIFF"
"RTN","MMRSCDI2",46,0)
 ....S TSTSTP=1
"RTN","MMRSCDI2",47,0)
 ..I $D(^MMRS(104.1,II,6)) D
"RTN","MMRSCDI2",48,0)
 ...S IXI=0 F  S IXI=$O(^MMRS(104.1,II,6,IXI)) Q:IXI'>0  D  Q:MDROETIO
"RTN","MMRSCDI2",49,0)
 ....Q:IXI=""
"RTN","MMRSCDI2",50,0)
 ....Q:'IXI
"RTN","MMRSCDI2",51,0)
 ....S III=IXI_","_II_","
"RTN","MMRSCDI2",52,0)
 ....S XX=$$GET1^DIQ(104.109,III,.01,"E")
"RTN","MMRSCDI2",53,0)
 ....Q:XX'["CLOSTRIDIUM"
"RTN","MMRSCDI2",54,0)
 ....S ETIONAME=XX,ORG=II,MDROETIO=ORG
"RTN","MMRSCDI2",55,0)
 ;
"RTN","MMRSCDI2",56,0)
ERROR ;
"RTN","MMRSCDI2",57,0)
 I 'TSTSTP&'MDROETIO D
"RTN","MMRSCDI2",58,0)
 .S EXTFLG=1
"RTN","MMRSCDI2",59,0)
 .W !!,"   >>>The report cannot be run because either the Laboratory Test(s) "
"RTN","MMRSCDI2",60,0)
 .W !,"       or the 'CLOSTRIDIUM DIFFICLE' Etiology are not setup "
"RTN","MMRSCDI2",61,0)
 .W !,"       in the LAB SEARCH/EXTRACT parameters file, (104.1)."
"RTN","MMRSCDI2",62,0)
 Q
"RTN","MMRSCDI2",63,0)
 ;
"RTN","MMRSCDI2",64,0)
MAIN2 ; Entry for queuing
"RTN","MMRSCDI2",65,0)
 S MMRSNOW=$$NOW^XLFDT()
"RTN","MMRSCDI2",66,0)
 I '$D(MMRSDIV) D PRT  Q
"RTN","MMRSCDI2",67,0)
 D GETPARAM ; Load parameters in temp global
"RTN","MMRSCDI2",68,0)
 D PRT
"RTN","MMRSCDI2",69,0)
 Q
"RTN","MMRSCDI2",70,0)
 ;
"RTN","MMRSCDI2",71,0)
GTDIV(MMRSDIV) ;
"RTN","MMRSCDI2",72,0)
 N I,TST,ETI,DPTR,STAID,DIV,DPTR
"RTN","MMRSCDI2",73,0)
 S I=0
"RTN","MMRSCDI2",74,0)
 F  S I=$O(^MMRS(104.1,I)) Q:$G(I)'>0  D  Q:$G(I)'>0
"RTN","MMRSCDI2",75,0)
 .I $P(^MMRS(104.1,I,3,0),"^",3)>0 D
"RTN","MMRSCDI2",76,0)
 ..S LIEN=1_","_I_","
"RTN","MMRSCDI2",77,0)
 ..S TST=$$GET1^DIQ(104.15,LIEN,.01,"I")
"RTN","MMRSCDI2",78,0)
 .I $P(^MMRS(104.1,I,6,0),"^",3)>0 D
"RTN","MMRSCDI2",79,0)
 ..S LIEN=1_","_I_","
"RTN","MMRSCDI2",80,0)
 ..S ETI=$$GET1^DIQ(104.109,LIEN,.01,"I")
"RTN","MMRSCDI2",81,0)
 .I $G(TST)'>0&($G(ETI)'>0) K LIEN Q
"RTN","MMRSCDI2",82,0)
 .S DPTR=$$GET1^DIQ(104.1,I,1,"I") Q:DPTR=""
"RTN","MMRSCDI2",83,0)
 .S DIV=$$GET1^DIQ(104,DPTR,.01,"I") Q:DIV=""
"RTN","MMRSCDI2",84,0)
 .S STAID=$$GET1^DIQ(40.8,DIV,.01,"E") Q:STAID=""
"RTN","MMRSCDI2",85,0)
 .S MMRSDIV(STAID)=DIV
"RTN","MMRSCDI2",86,0)
 .S (STAID,DIV,DPTR)=""
"RTN","MMRSCDI2",87,0)
 Q
"RTN","MMRSCDI2",88,0)
 ;
"RTN","MMRSCDI2",89,0)
CLEAN ;
"RTN","MMRSCDI2",90,0)
 K ^TMP($J,"MMRSCDI")
"RTN","MMRSCDI2",91,0)
 K ^TMP($J,"MMRS")
"RTN","MMRSCDI2",92,0)
 K ^TMP($J,"MMRSCD")
"RTN","MMRSCDI2",93,0)
 Q
"RTN","MMRSCDI2",94,0)
 ;
"RTN","MMRSCDI2",95,0)
GETPARAM ; Loads lab search/extract parameters from file 104.1
"RTN","MMRSCDI2",96,0)
 N TSTNM,TST,TEST,IEN,TIEN,ITOP,TOP,ETOP,IBACT,BACT,EBACT
"RTN","MMRSCDI2",97,0)
 N ETIOL,ETIOLOGY,ANTI,ANTIM,INC,MRSASTAP,ETIONAME,MMRSI,MMRSET,ORG
"RTN","MMRSCDI2",98,0)
 N MDRO
"RTN","MMRSCDI2",99,0)
 Q:'$D(MMRSDIV)
"RTN","MMRSCDI2",100,0)
 S DIVN="",CHK=1,NOCONF=0
"RTN","MMRSCDI2",101,0)
 S MMRSMDRO=$O(^MMRS(104.2,"B","C. diff",0))
"RTN","MMRSCDI2",102,0)
 I $G(MMRSDIV)="ALL" D GETDIV(.MMRSDIV)
"RTN","MMRSCDI2",103,0)
 F  S DIVN=$O(MMRSDIV(DIVN)) Q:DIVN'?.N  D  Q:NOCONF
"RTN","MMRSCDI2",104,0)
 .Q:DIVN=""
"RTN","MMRSCDI2",105,0)
 .S PTR=$$GET1^DIQ(104,DIVN,.01,"I")
"RTN","MMRSCDI2",106,0)
 .S DIVSN=$$GET1^DIQ(40.8,PTR,.01,"E")
"RTN","MMRSCDI2",107,0)
 .I $G(DIVSN)="" S NOCONF=1 Q
"RTN","MMRSCDI2",108,0)
 .K MMRSDIV(DIVN)
"RTN","MMRSCDI2",109,0)
 .S MMRSDIV(DIVSN)=DIVN
"RTN","MMRSCDI2",110,0)
 S DIVSN=""
"RTN","MMRSCDI2",111,0)
 F  S DIVSN=$O(MMRSDIV(DIVSN)) Q:DIVSN=""!(NOCONF)  D  Q:NOCONF
"RTN","MMRSCDI2",112,0)
 .K ^TMP($J,"MMRSCD")
"RTN","MMRSCDI2",113,0)
 .S MDRO=MMRSMDRO
"RTN","MMRSCDI2",114,0)
 .S DIVN=MMRSDIV(DIVSN)
"RTN","MMRSCDI2",115,0)
 .I $G(DIVN)'>0 S DIVSN="" S NOCONF=1 Q
"RTN","MMRSCDI2",116,0)
 .S IEN="",IEN=$O(^MMRS(104.1,"C",DIVN,MMRSMDRO,IEN))
"RTN","MMRSCDI2",117,0)
 .Q:$G(IEN)'>0
"RTN","MMRSCDI2",118,0)
 .S ORGP=$$GET1^DIQ(104.1,IEN,.01,"I")
"RTN","MMRSCDI2",119,0)
 .D CHKPAR^MMRSCDI(ORGP,DIVN,.CHK)
"RTN","MMRSCDI2",120,0)
 .I 'CHK S NOCONF=1 Q
"RTN","MMRSCDI2",121,0)
 .S (FND,TST,INC)=0
"RTN","MMRSCDI2",122,0)
 .I TSTSTP D
"RTN","MMRSCDI2",123,0)
 ..S TIEN=0 F  S TIEN=$O(^MMRS(104.1,IEN,3,TIEN)) Q:'TIEN  D
"RTN","MMRSCDI2",124,0)
 ...S TEST=$P($G(^MMRS(104.1,IEN,3,TIEN,0)),U,1)
"RTN","MMRSCDI2",125,0)
 ...Q:'TEST
"RTN","MMRSCDI2",126,0)
 ...S INC=INC+1
"RTN","MMRSCDI2",127,0)
 ...S ^TMP($J,"MMRSCD","T",MDRO,TEST,0)=$P($G(^MMRS(104.1,IEN,3,TIEN,0)),U,2,3)
"RTN","MMRSCDI2",128,0)
 .I MDROETIO D
"RTN","MMRSCDI2",129,0)
 ..S IBACT=0 F  S IBACT=$O(^MMRS(104.1,MMRSMDRO,4,IBACT)) Q:'IBACT  D
"RTN","MMRSCDI2",130,0)
 ...S BACT=$G(^MMRS(104.1,MMRSMDRO,4,IBACT,0))
"RTN","MMRSCDI2",131,0)
 ...I BACT'="" S ^TMP($J,"MMRSCD","BACT",MDRO,"INC_REMARK",IBACT)=BACT
"RTN","MMRSCDI2",132,0)
 ..S EBACT=0 F  S EBACT=$O(^MMRS(104.1,MMRSMDRO,5,EBACT)) Q:'EBACT  D
"RTN","MMRSCDI2",133,0)
 ...S BACT=$G(^MMRS(104.1,MMRSMDRO,5,EBACT,0))
"RTN","MMRSCDI2",134,0)
 ...I BACT'="" S ^TMP($J,"MMRSCD","BACT",MDRO,"EXC_REMARK",EBACT)=BACT
"RTN","MMRSCDI2",135,0)
 ..S ETIOL=0 F  S ETIOL=$O(^MMRS(104.1,IEN,6,ETIOL)) Q:'ETIOL  D
"RTN","MMRSCDI2",136,0)
 ...S ETIOLOGY=$G(^MMRS(104.1,IEN,6,ETIOL,0))
"RTN","MMRSCDI2",137,0)
 ...I 'ETIOLOGY K ^TMP($J,"MMRSCD","ETIOL")
"RTN","MMRSCDI2",138,0)
 ...S ^TMP($J,"MMRSCD","ETIOL",MDRO,+ETIOLOGY)=""
"RTN","MMRSCDI2",139,0)
 ...S ANTI=0 F  S ANTI=$O(^MMRS(104.1,MMRSMDRO,6,ETIOL,1,ANTI)) Q:'ANTI  D
"RTN","MMRSCDI2",140,0)
 ....S ANTIM=$P($G(^MMRS(104.1,MMRSMDRO,6,ETIOL,1,ANTI,0)),U)
"RTN","MMRSCDI2",141,0)
 ....I ANTIM S ^TMP($J,"MMRSCD","ETIOL",MDRO,ETIOLOGY,ANTI)=$G(^MMRS(104.1,IEN,6,ETIOL,1,ANTI,0))
"RTN","MMRSCDI2",142,0)
 ...I $G(ETIOLOGY)'="" D
"RTN","MMRSCDI2",143,0)
 ....D FIND^DIC(61.2,,".01E;@","PM","CLOSTRIDIUM DIFFICILE",,"B",,,"MMRSET")
"RTN","MMRSCDI2",144,0)
 ..S MMRSI="" F  S MMRSI=$O(MMRSET("DILIST",MMRSI)) Q:MMRSI=""  I +MMRSI>0  D
"RTN","MMRSCDI2",145,0)
 ...S ETIONAME=$P($G(MMRSET("DILIST",MMRSI,0)),U,2)
"RTN","MMRSCDI2",146,0)
 ...S ORG=$P($G(MMRSET("DILIST",MMRSI,0)),U,1)
"RTN","MMRSCDI2",147,0)
 ...I ETIONAME'["CLOSTRIDIUM DIFFICILE" Q
"RTN","MMRSCDI2",148,0)
 ...K ^TMP($J,"MMRSCD","ETIOL",MMRSMDRO,ORG)
"RTN","MMRSCDI2",149,0)
 ...S ^TMP($J,"MMRSCD","ETIOL",MMRSMDRO,ORG)=""
"RTN","MMRSCDI2",150,0)
 .D SETDATA
"RTN","MMRSCDI2",151,0)
 Q
"RTN","MMRSCDI2",152,0)
 ;
"RTN","MMRSCDI2",153,0)
GETDIV(MMRSDIV) ;
"RTN","MMRSCDI2",154,0)
 N I,TST,ETI,DPTR,STAID,DIV,DPTR
"RTN","MMRSCDI2",155,0)
 S I=0
"RTN","MMRSCDI2",156,0)
 F  S I=$O(^MMRS(104,I)) Q:$G(I)'>0  D  Q:$G(I)'>0
"RTN","MMRSCDI2",157,0)
 .S MMRSDIV(I)=""
"RTN","MMRSCDI2",158,0)
 Q
"RTN","MMRSCDI2",159,0)
 ;
"RTN","MMRSCDI2",160,0)
SETDATA ;
"RTN","MMRSCDI2",161,0)
 N LOCATION,LOCNAME,DFN,LOCTYPE,MMRSI,SDRESULT,Y,WLOC,WARD,WARDNAME,VAIP,WRDNME
"RTN","MMRSCDI2",162,0)
 S DFN=0 F  S DFN=$O(^DPT(DFN)) Q:'DFN  D
"RTN","MMRSCDI2",163,0)
 .Q:'$D(^PXRMINDX(63,"PI",DFN))
"RTN","MMRSCDI2",164,0)
 .Q:$G(DFN)'>0
"RTN","MMRSCDI2",165,0)
 .D SETDATA2(DFN)
"RTN","MMRSCDI2",166,0)
 Q
"RTN","MMRSCDI2",167,0)
 ;
"RTN","MMRSCDI2",168,0)
SETDATA2(DFN) ;
"RTN","MMRSCDI2",169,0)
 N INTT,IEN,INDATE,INIFN,MRSA,MRSACULT,LABORDER,TSTNM,LABTEST,ORDITM,ORDTEMP,PATNM,VADM,DCDATE
"RTN","MMRSCDI2",170,0)
 S LOC=""
"RTN","MMRSCDI2",171,0)
 S (CDIVT,PCD)=""
"RTN","MMRSCDI2",172,0)
 ;Get MRSA history
"RTN","MMRSCDI2",173,0)
 D GETLAB^MMRSCDI1(DFN,.MRSA,MMRSMDRO,MMRSNOW,"CD")
"RTN","MMRSCDI2",174,0)
 Q:'$D(MRSA)
"RTN","MMRSCDI2",175,0)
 S I="" F  S I=$O(MRSA(I)) Q:I=""  D
"RTN","MMRSCDI2",176,0)
 .Q:I=""
"RTN","MMRSCDI2",177,0)
 .S CDIVT=I
"RTN","MMRSCDI2",178,0)
 .S MRSA=$P(MRSA(I),"^",1,2)
"RTN","MMRSCDI2",179,0)
 .S LOC=+$P(MRSA(I),"^",3)
"RTN","MMRSCDI2",180,0)
 .S DVSN=$$GET1^DIQ(44,+LOC,3.5,"E")
"RTN","MMRSCDI2",181,0)
 .Q:DVSN'=DIVSN
"RTN","MMRSCDI2",182,0)
 .S WARDNAME=$$GET1^DIQ(44,+LOC,.01,"E")
"RTN","MMRSCDI2",183,0)
 .;Get Order info
"RTN","MMRSCDI2",184,0)
 .S LABORDER="^^"
"RTN","MMRSCDI2",185,0)
 .Q:'CDIVT
"RTN","MMRSCDI2",186,0)
 .S MRSA=$P(MRSA(I),"^",2)
"RTN","MMRSCDI2",187,0)
 .S LRFILE=44
"RTN","MMRSCDI2",188,0)
 .S STPCD=$$GET1^DIQ(LRFILE,+LOC,8,"I")
"RTN","MMRSCDI2",189,0)
 .S TYPE=$$GET1^DIQ(LRFILE,+LOC,2,"E")
"RTN","MMRSCDI2",190,0)
 .S SERV=$$GET1^DIQ(LRFILE,+LOC,9,"E")
"RTN","MMRSCDI2",191,0)
 .D GTDATE(DFN,CDIVT,.INDATE,.DCDATE)
"RTN","MMRSCDI2",192,0)
 .I $G(TYPE)'="",TYPE'="WARD" S (INDATE,DCDATE)=""
"RTN","MMRSCDI2",193,0)
 .I $D(^TMP($J,"MMRSCD","T")) D
"RTN","MMRSCDI2",194,0)
 ..S MDRO="" F  S MDRO=$O(^TMP($J,"MMRSCD","T",MDRO)) Q:MDRO=""  D
"RTN","MMRSCDI2",195,0)
 ...Q:$G(MDRO)'>0
"RTN","MMRSCDI2",196,0)
 ...S TST="" F  S TST=$O(^TMP($J,"MMRSCD","T",MDRO,TST)) Q:TST=""  D
"RTN","MMRSCDI2",197,0)
 ....N TESTS D GORDITM(TST,.LABORDER,.TESTS) ;MIA/LMT - Added with patch MMRS*1*1
"RTN","MMRSCDI2",198,0)
 .S PCD="",PATNM=$$GET1^DIQ(2,DFN,.01,"E")
"RTN","MMRSCDI2",199,0)
 .Q:$D(^TMP($J,"MMRSCDI",WARDNAME,PATNM,DFN,CDIVT))
"RTN","MMRSCDI2",200,0)
 .I $D(^TMP($J,"MMRSCDI",WARDNAME,PATNM,DFN)) D
"RTN","MMRSCDI2",201,0)
 ..S PCD=999999999999999
"RTN","MMRSCDI2",202,0)
 ..S PCD=$O(^TMP($J,"MMRSCDI",WARDNAME,PATNM,DFN,PCD),-1)
"RTN","MMRSCDI2",203,0)
 .S CD=CDIVT,CD=$O(MRSA(CD),-1)
"RTN","MMRSCDI2",204,0)
 .I $G(CD)>0,CD<CDIVT S PCD=CD
"RTN","MMRSCDI2",205,0)
 .Q:CDIVT<STRTDT
"RTN","MMRSCDI2",206,0)
 .S ^TMP($J,"MMRSCDI",DIVSN,WARDNAME,PATNM,DFN,CDIVT)=$G(TYPE)_U_$G(SERV)_U_$G(STPCD)_U_$G(CDIVT)_U_$G(INDATE)_U_$G(DCDATE)_U_$G(MRSA)_U_$G(PCD),PCD=""
"RTN","MMRSCDI2",207,0)
 K MRSA
"RTN","MMRSCDI2",208,0)
 Q
"RTN","MMRSCDI2",209,0)
 ;
"RTN","MMRSCDI2",210,0)
GTDATE(DFN,CDIVT,IND,DCDT) ;
"RTN","MMRSCDI2",211,0)
 N DATE,IEN
"RTN","MMRSCDI2",212,0)
 S (IND,DCDT)="",FND=0
"RTN","MMRSCDI2",213,0)
 Q:$G(CDIVT)=""
"RTN","MMRSCDI2",214,0)
 Q:'$D(^DGPM("APTT1",DFN))
"RTN","MMRSCDI2",215,0)
 S DATE=9999999999,TT=1
"RTN","MMRSCDI2",216,0)
 F  S DATE=$O(^DGPM("APTT"_TT,DFN,DATE),-1) Q:DATE=""  D  Q:FND
"RTN","MMRSCDI2",217,0)
 .Q:DATE=""
"RTN","MMRSCDI2",218,0)
 .I CDIVT<DATE Q
"RTN","MMRSCDI2",219,0)
 .S IEN="",IEN=$O(^DGPM("APTT"_TT,DFN,DATE,IEN))
"RTN","MMRSCDI2",220,0)
 .Q:$G(IEN)'>0
"RTN","MMRSCDI2",221,0)
 .I $G(IEN)>0 D
"RTN","MMRSCDI2",222,0)
 ..S IND=$$GET1^DIQ(405,IEN,.01,"I")
"RTN","MMRSCDI2",223,0)
 ..S WRD=$$GET1^DIQ(405,IEN,.06,"E")
"RTN","MMRSCDI2",224,0)
 ..S LOCNME="",LOCNME=$$GET1^DIQ(44,LOC,.01,"E")
"RTN","MMRSCDI2",225,0)
 .I WRD=LOCNME S FND=1
"RTN","MMRSCDI2",226,0)
 .S NXDT=$O(^DGPM("APTT"_TT,DFN,DATE),-1)
"RTN","MMRSCDI2",227,0)
 .I $G(NXDT)'>0 K NXDT S FND=1
"RTN","MMRSCDI2",228,0)
 .I $G(NXDT)>0 S DATE=NXDT,NXDT=""
"RTN","MMRSCDI2",229,0)
 .Q:$G(DATE)'>0
"RTN","MMRSCDI2",230,0)
 .S IEN="",IEN=$O(^DGPM("APTT"_TT,DFN,DATE,IEN))
"RTN","MMRSCDI2",231,0)
 .S TIEN=$$GET1^DIQ(405,IEN,.17,"I")
"RTN","MMRSCDI2",232,0)
 .I $G(TIEN)'>0 Q
"RTN","MMRSCDI2",233,0)
 .S DCDT=$$GET1^DIQ(405,TIEN,.01,"I")
"RTN","MMRSCDI2",234,0)
 .I DCDT>CDIVT S FND=1,DCDT="" Q
"RTN","MMRSCDI2",235,0)
 .I DCDT'="" S FND=1 Q
"RTN","MMRSCDI2",236,0)
 Q
"RTN","MMRSCDI2",237,0)
 ;
"RTN","MMRSCDI2",238,0)
GORDITM(LABTEST,LABORDER,TESTS) ;MIA/LMT - Added with patch MMRS*1*1 - Include panels in search
"RTN","MMRSCDI2",239,0)
 N ORDITM,ORDTEMP,LABPANEL
"RTN","MMRSCDI2",240,0)
 I $D(TESTS(LABTEST)) Q  ;prevent infinite recursion; if site has Panel A within Panel B, and Panel B within Panel A
"RTN","MMRSCDI2",241,0)
 S TESTS(LABTEST)=1 ;mark that we have searched this test (to prevent infinite recursion)
"RTN","MMRSCDI2",242,0)
 S ORDITM=0 F  S ORDITM=$O(^ORD(101.43,"ID",LABTEST_";99LRT",ORDITM)) Q:'ORDITM  D
"RTN","MMRSCDI2",243,0)
 .S ORDTEMP=$$GETORD(DFN,ORDITM,INDATE)
"RTN","MMRSCDI2",244,0)
 .I $P(LABORDER,U,1)'="YES"!(($P(LABORDER,U,3)'="YES")&($P(ORDTEMP,U,3)="YES")) S LABORDER=ORDTEMP
"RTN","MMRSCDI2",245,0)
 S LABPANEL=0 F  S LABPANEL=$O(^LAB(60,"AB",LABTEST,LABPANEL)) Q:'LABPANEL  D
"RTN","MMRSCDI2",246,0)
 .D GORDITM(LABPANEL,.LABORDER,.TESTS) ;Recursive call to check for tests within panels
"RTN","MMRSCDI2",247,0)
 Q
"RTN","MMRSCDI2",248,0)
GETORD(DFN,ORDITM,INDATE) ;
"RTN","MMRSCDI2",249,0)
 N RESULT,START,STOP,DAS,STATUS,ORUPCHUK,LABREC
"RTN","MMRSCDI2",250,0)
 S RESULT="^^"
"RTN","MMRSCDI2",251,0)
 S START=$$FMADD^XLFDT(INDATE,-1)-.0000001
"RTN","MMRSCDI2",252,0)
 F  S START=$O(^PXRMINDX(100,"PI",DFN,ORDITM,START)) Q:'START  D
"RTN","MMRSCDI2",253,0)
 .S STOP="" F  S STOP=$O(^PXRMINDX(100,"PI",DFN,ORDITM,START,STOP)) Q:STOP=""  D
"RTN","MMRSCDI2",254,0)
 ..S DAS="" F  S DAS=$O(^PXRMINDX(100,"PI",DFN,ORDITM,START,STOP,DAS)) Q:DAS=""  D
"RTN","MMRSCDI2",255,0)
 ...D EN^ORX8(+DAS)
"RTN","MMRSCDI2",256,0)
 ...S STATUS=$P(ORUPCHUK("ORSTS"),U,1)
"RTN","MMRSCDI2",257,0)
 ...I STATUS'=2,STATUS'=5,STATUS'=6 Q
"RTN","MMRSCDI2",258,0)
 ...S LABREC="NO"
"RTN","MMRSCDI2",259,0)
 ...I STATUS=6!(STATUS=2) S LABREC="YES"
"RTN","MMRSCDI2",260,0)
 ...I $P(RESULT,U,3)'="YES" S RESULT="YES^"_START_U_LABREC
"RTN","MMRSCDI2",261,0)
 Q RESULT
"RTN","MMRSCDI2",262,0)
PRT ;
"RTN","MMRSCDI2",263,0)
 I '$D(MMRSDIV) D  Q
"RTN","MMRSCDI2",264,0)
 .W !!,"    >>>Divisions are not setup in Taskman. You must configure the"
"RTN","MMRSCDI2",265,0)
 .W !,"        the Divisions for this report in TaskMan in order for the "
"RTN","MMRSCDI2",266,0)
 .W !,"        report to run."
"RTN","MMRSCDI2",267,0)
 .W !!
"RTN","MMRSCDI2",268,0)
 I NOCONF D  Q
"RTN","MMRSCDI2",269,0)
 .W !!,"   >>>The report cannot be run because either the Laboratory Tests "
"RTN","MMRSCDI2",270,0)
 .W !,"       or the 'CLOSTRIDIUM DIFFICILE' Etiology are not setup "
"RTN","MMRSCDI2",271,0)
 .W !,"       in the LAB SEARCH/EXTRACT parameters file, (104.1)."
"RTN","MMRSCDI2",272,0)
 .W !!
"RTN","MMRSCDI2",273,0)
 N LN,PG,LOCNAME,PATNM,DFN,NODE,LAST4,INTT,ADT,ORDDATE,VADM,QUIT,COUNT,DOB,PRVCDI
"RTN","MMRSCDI2",274,0)
 K ^TMP($J,"MMRSCDI","T")
"RTN","MMRSCDI2",275,0)
 K ^TMP($J,"MMRSCDI","ETIOL")
"RTN","MMRSCDI2",276,0)
 S $P(LN,"-",160)=""
"RTN","MMRSCDI2",277,0)
 S PG=1,QUIT=0,DVS=""
"RTN","MMRSCDI2",278,0)
 F  S DVS=$O(MMRSDIV(DVS)) Q:DVS=""  D
"RTN","MMRSCDI2",279,0)
 .S DIVSN=DVS
"RTN","MMRSCDI2",280,0)
 .I '$D(^TMP($J,"MMRSCDI",DIVSN)) D  Q
"RTN","MMRSCDI2",281,0)
 ..S WARDNAME=""
"RTN","MMRSCDI2",282,0)
 ..D PRTHDRS
"RTN","MMRSCDI2",283,0)
 ..W !!,"NO RECORDS FOUND FOR REPORTING PERIOD."
"RTN","MMRSCDI2",284,0)
 .S WARDNAME="" F  S WARDNAME=$O(^TMP($J,"MMRSCDI",DIVSN,WARDNAME)) Q:WARDNAME=""  D  Q:QUIT
"RTN","MMRSCDI2",285,0)
 ..I WARDNAME="" S QUIT=1 Q
"RTN","MMRSCDI2",286,0)
 ..Q:'$D(^TMP($J,"MMRSCDI",DIVSN,WARDNAME))
"RTN","MMRSCDI2",287,0)
 ..D PRTHDRS
"RTN","MMRSCDI2",288,0)
 ..S PATNM="" F  S PATNM=$O(^TMP($J,"MMRSCDI",DIVSN,WARDNAME,PATNM)) Q:PATNM=""  D
"RTN","MMRSCDI2",289,0)
 ...I PATNM?.N K ^TMP($J,"MMRSCDI",DIVSN,WARDNAME,PATNM) Q
"RTN","MMRSCDI2",290,0)
 ...S DFN=0 F  S DFN=$O(^TMP($J,"MMRSCDI",DIVSN,WARDNAME,PATNM,DFN)) Q:'DFN  D  Q:'DFN
"RTN","MMRSCDI2",291,0)
 ....S CD=0 F  S CD=$O(^TMP($J,"MMRSCDI",DIVSN,WARDNAME,PATNM,DFN,CD)) Q:'CD  D
"RTN","MMRSCDI2",292,0)
 .....S NODE=$G(^TMP($J,"MMRSCDI",DIVSN,WARDNAME,PATNM,DFN,CD))
"RTN","MMRSCDI2",293,0)
 .....S TYPE=$P(NODE,"^")
"RTN","MMRSCDI2",294,0)
 .....S SERV=$P(NODE,"^",2)
"RTN","MMRSCDI2",295,0)
 .....S STPCD=$P(NODE,"^",3)
"RTN","MMRSCDI2",296,0)
 .....S CDIVT=$P(NODE,"^",4) I $G(CDIVT)>0 D
"RTN","MMRSCDI2",297,0)
 ......S CDIVT=$$FMTE^XLFDT(CDIVT,2)
"RTN","MMRSCDI2",298,0)
 ......I CDIVT["@" S CDIVT=$TR(CDIVT,"@"," ")
"RTN","MMRSCDI2",299,0)
 .....S INDATE=$P(NODE,"^",5) I $G(INDATE)>0 D
"RTN","MMRSCDI2",300,0)
 ......S INDATE=$$FMTE^XLFDT(INDATE,2)
"RTN","MMRSCDI2",301,0)
 ......I INDATE["@" S INDATE=$TR(INDATE,"@"," ")
"RTN","MMRSCDI2",302,0)
 .....S DCDT=$P(NODE,U,6) I $G(DCDT)>0 D
"RTN","MMRSCDI2",303,0)
 ......S DCDT=$$FMTE^XLFDT(DCDT,2)
"RTN","MMRSCDI2",304,0)
 ......I DCDT["@" S DCDT=$TR(DCDT,"@"," ")
"RTN","MMRSCDI2",305,0)
 .....S PRVCDI=$P(NODE,U,8) I $G(PRVCDI)>0 D
"RTN","MMRSCDI2",306,0)
 ......S PRVCDI=$$FMTE^XLFDT(PRVCDI,2)
"RTN","MMRSCDI2",307,0)
 ......I PRVCDI["@" S PRVCDI=$TR(PRVCDI,"@"," ")
"RTN","MMRSCDI2",308,0)
 .....D KVA^VADPT
"RTN","MMRSCDI2",309,0)
 .....D DEM^VADPT
"RTN","MMRSCDI2",310,0)
 .....S LAST4=$E($P(VADM(2),U),6,9)
"RTN","MMRSCDI2",311,0)
 .....D KVA^VADPT
"RTN","MMRSCDI2",312,0)
 .....S ORDDATE=$P(NODE,"^",5)
"RTN","MMRSCDI2",313,0)
 .....I ORDDATE S ORDDATE=$$FMTE^XLFDT(ORDDATE,"2M")
"RTN","MMRSCDI2",314,0)
 .....S DOB=$$GET1^DIQ(2,DFN,.03,"E")
"RTN","MMRSCDI2",315,0)
 .....W !,$E(PATNM,1,30),?25,LAST4,?30,DOB,?42,$G(CDIVT),?70,$G(INDATE),?90,$G(WARDNAME),?106,$G(DCDT),?130,$G(PRVCDI)
"RTN","MMRSCDI2",316,0)
 .....S COUNT=$G(COUNT)+1
"RTN","MMRSCDI2",317,0)
 .....S DL="^"
"RTN","MMRSCDI2",318,0)
 ....S PRVCDI=""
"RTN","MMRSCDI2",319,0)
 ....I $Y+2>IOSL D PRTHDRS
"RTN","MMRSCDI2",320,0)
 W !!,"END OF REPORT"
"RTN","MMRSCDI2",321,0)
 Q
"RTN","MMRSCDI2",322,0)
 ;
"RTN","MMRSCDI2",323,0)
PRTHDRS ; Helper Function for PRT - Prints report headers
"RTN","MMRSCDI2",324,0)
 W @IOF
"RTN","MMRSCDI2",325,0)
 W ?13,"FACILITY CDI CASES REPORT"
"RTN","MMRSCDI2",326,0)
 W !,?13,"Division: ",DIVSN
"RTN","MMRSCDI2",327,0)
 W !,?13,"Geographical Location: ",WARDNAME
"RTN","MMRSCDI2",328,0)
 W !,?13,"Report period: ",$$FMTE^XLFDT(STRTDT)," to ",$$FMTE^XLFDT(ENDDT)
"RTN","MMRSCDI2",329,0)
 W !,?13,"Report printed on: ",$$FMTE^XLFDT(MMRSNOW),?75,"PAGE: ",PG
"RTN","MMRSCDI2",330,0)
 W !,"PATIENT",?25,"SSN",?30,"DOB",?42,"CDI Event D/T",?70,"ADM D/T",?90,"LOCATION",?105,"DC D/T",?130,"PREV CDI Event D/T"
"RTN","MMRSCDI2",331,0)
 W !,LN
"RTN","MMRSCDI2",332,0)
 S PG=PG+1
"RTN","MMRSCDI2",333,0)
 Q
"RTN","MMRSCDI2",334,0)
ASKDVC ;Prompts user for device of output (allows queuing)
"RTN","MMRSCDI2",335,0)
 W !!
"RTN","MMRSCDI2",336,0)
 N MMRSVAR,ZTSK
"RTN","MMRSCDI2",337,0)
 W !!!,"This report is designed for a 132 column format (compressed).",!
"RTN","MMRSCDI2",338,0)
 S MMRSVAR("STRTDT")="",MMRSVAR("DFLTDT")="",MMRSVAR("ENDDT")=""
"RTN","MMRSCDI2",339,0)
 S MMRSVAR("MMRSNOW")="",MMRSVAR("TSTSTP")="",MMRSVAR("MDROETIO")=""
"RTN","MMRSCDI2",340,0)
 S MMRSVAR("MMRSDIV")="",MMRSVAR("MMRSDIV(")=""
"RTN","MMRSCDI2",341,0)
 D EN^XUTMDEVQ("MAIN2^MMRSCDI2","Print CDI report (MMRSCDI2)",.MMRSVAR,"QM",1)
"RTN","MMRSCDI2",342,0)
 W:$D(ZTSK) !,"Report Queued to Print ("_ZTSK_").",!
"RTN","MMRSCDI2",343,0)
 Q
"RTN","MMRSCDI2",344,0)
 ;
"RTN","MMRSCDI2",345,0)
QUIT ;
"RTN","MMRSCDI2",346,0)
 K ENDDT,FND,CDI,LCPTR,LRFILE,MMRSMDRO,PCDIVT,PRINT,PCDIVT,SERV
"RTN","MMRSCDI2",347,0)
 K STPCD,STRTDT,TYPE,WPTR,WRDPTR,X2,X10,X12,X2,X3,X4,X5,X6,X7,X8,X9
"RTN","MMRSCDI2",348,0)
 K X1,X11,MRSA,^TMP($J),ORGP,MDROETIO,CNT,PCD,CD,ETIO,III,IX,I
"RTN","MMRSCDI2",349,0)
 K LOC,MMRSNOW,PTR,TSTSTP,MMRSDIV,NOCONF,CHK,DFLTDT,DIVN,DIVSN,DL
"RTN","MMRSCDI2",350,0)
 K DVS,DVSN,FIRST,IXI,LOCNME,NOW,TT,WRD,ZTQUEUED
"RTN","MMRSCDI2",351,0)
 Q
"RTN","MMRSCDI2",352,0)
 ;
"RTN","MMRSCRE")
0^12^B98037887^B90369826
"RTN","MMRSCRE",1,0)
MMRSCRE ;TCK - Print CRE Acute Care IPEC Report ; 3/22/17 3:02pm
"RTN","MMRSCRE",2,0)
 ;;1.0;MDRO PROGRAM TOOLS;**4,5**;June 01, 2016;Build 146
"RTN","MMRSCRE",3,0)
 ;
"RTN","MMRSCRE",4,0)
 ;This is the main routine to print the CRE Acute Care IPEC Report.
"RTN","MMRSCRE",5,0)
 ;This routine uses functions contained in MMRSCRE2, MMRSCRE3, and MMRSCRE4.
"RTN","MMRSCRE",6,0)
MAIN ;
"RTN","MMRSCRE",7,0)
 N NUMDIV,MMRSDIV,MMRSLOC,EXTFLG,STRTDT,ENDDT,PRTSUM,BYADM
"RTN","MMRSCRE",8,0)
 D CLEAN
"RTN","MMRSCRE",9,0)
 D CHECK2
"RTN","MMRSCRE",10,0)
 I $D(EXTFLG) W ! H 2 Q
"RTN","MMRSCRE",11,0)
 W !
"RTN","MMRSCRE",12,0)
 D CHECK3
"RTN","MMRSCRE",13,0)
 I $D(EXTFLG) W ! H 2 Q
"RTN","MMRSCRE",14,0)
 D PROMPT
"RTN","MMRSCRE",15,0)
 I $D(EXTFLG) D CLEAN K MMRSSUM,DIVARY,DVSN,MDIV Q
"RTN","MMRSCRE",16,0)
 D ASKDVC Q:$D(EXTFLG)
"RTN","MMRSCRE",17,0)
 D CLEAN
"RTN","MMRSCRE",18,0)
 D END
"RTN","MMRSCRE",19,0)
 Q
"RTN","MMRSCRE",20,0)
 ;
"RTN","MMRSCRE",21,0)
CHKPAR(ORG,Y,CHK) ;
"RTN","MMRSCRE",22,0)
 N I,TST,ETI
"RTN","MMRSCRE",23,0)
 I '$D(^MMRS(104.1,"C",+Y,ORG)) S CHK=0 Q
"RTN","MMRSCRE",24,0)
 S I="",I=$O(^MMRS(104.1,"C",+Y,ORG,I))
"RTN","MMRSCRE",25,0)
 S LIEN=1_","_I_","
"RTN","MMRSCRE",26,0)
 S TST=$$GET1^DIQ(104.15,LIEN,.01,"I")
"RTN","MMRSCRE",27,0)
 I $G(TST)>0 Q
"RTN","MMRSCRE",28,0)
 S ETI=$$GET1^DIQ(104.109,LIEN,.01,"I")
"RTN","MMRSCRE",29,0)
 I $G(ETI)>0 Q
"RTN","MMRSCRE",30,0)
 S CHK=0
"RTN","MMRSCRE",31,0)
 Q
"RTN","MMRSCRE",32,0)
 ;
"RTN","MMRSCRE",33,0)
CHECK(L) ;Check if parameters are setup
"RTN","MMRSCRE",34,0)
 N DVSN
"RTN","MMRSCRE",35,0)
 S (SPCM,NUMDIV)=0
"RTN","MMRSCRE",36,0)
 S MMRSDIV=0 F  S MMRSDIV=$O(^MMRS(104,MMRSDIV)) Q:'MMRSDIV  D  Q:NUMDIV
"RTN","MMRSCRE",37,0)
 .I $D(^MMRS(104,MMRSDIV,0)) S NUMDIV=NUMDIV+1 Q
"RTN","MMRSCRE",38,0)
 I NUMDIV D
"RTN","MMRSCRE",39,0)
 .Q:'$D(^MMRS(104,"B",L))
"RTN","MMRSCRE",40,0)
 .S DVSN="",DVSN=$O(^MMRS(104,"B",L,DVSN))
"RTN","MMRSCRE",41,0)
 .Q:$G(DVSN)'>0
"RTN","MMRSCRE",42,0)
 .Q:'$D(^MMRS(104,DVSN,61))
"RTN","MMRSCRE",43,0)
 .Q:'$P(^MMRS(104,DVSN,61,0),"^",3)
"RTN","MMRSCRE",44,0)
 .S SPCM=1
"RTN","MMRSCRE",45,0)
 I 'NUMDIV!('SPCM) D
"RTN","MMRSCRE",46,0)
 .W !!,"   >>>Make sure a division and/or a Surveillance specimen has been "
"RTN","MMRSCRE",47,0)
 .W !,"         setup using the option: 'CRE Tools Site Parameter Setup'"
"RTN","MMRSCRE",48,0)
 .S EXTFLG=1
"RTN","MMRSCRE",49,0)
 Q
"RTN","MMRSCRE",50,0)
CHECK2 ;Check if lab tests and etiologies are setup
"RTN","MMRSCRE",51,0)
 N TST,MRSASTAP,MMRSET,MMRSI
"RTN","MMRSCRE",52,0)
 S (MDROETIO,TSTSTP)=0
"RTN","MMRSCRE",53,0)
 I $D(^MMRS(104.1)) D
"RTN","MMRSCRE",54,0)
 .S II=0 F  S II=$O(^MMRS(104.1,II)) Q:II'>0  D  Q:MDROETIO!(TSTSTP)
"RTN","MMRSCRE",55,0)
 ..Q:'$D(^MMRS(104.1,II,0))
"RTN","MMRSCRE",56,0)
 ..S ORGP=$P(^MMRS(104.1,II,0),"^")
"RTN","MMRSCRE",57,0)
 ..Q:$G(ORGP)'>0
"RTN","MMRSCRE",58,0)
 ..S ETIO=$$GET1^DIQ(104.2,ORGP,.01,"E")
"RTN","MMRSCRE",59,0)
 ..S ETIO=$$UPPER^DGUTL(ETIO)
"RTN","MMRSCRE",60,0)
 ..Q:ETIO'["CRB"
"RTN","MMRSCRE",61,0)
 ..S IX=0
"RTN","MMRSCRE",62,0)
 ..F  S IX=$O(^MMRS(104.1,II,3,IX)) Q:IX'>0  D  Q:TSTSTP
"RTN","MMRSCRE",63,0)
 ...I $G(IX)>0 D
"RTN","MMRSCRE",64,0)
 ....Q:'$D(^MMRS(104.1,II,3,IX,0))
"RTN","MMRSCRE",65,0)
 ....S III=IX_","_II_","
"RTN","MMRSCRE",66,0)
 ....Q:III=""
"RTN","MMRSCRE",67,0)
 ....S TST=$$GET1^DIQ(104.15,III,.01,"E")
"RTN","MMRSCRE",68,0)
 ....S TSTSTP=1
"RTN","MMRSCRE",69,0)
 ..I $D(^MMRS(104.1,II,6)) D
"RTN","MMRSCRE",70,0)
 ...S IXI=0 F  S IXI=$O(^MMRS(104.1,II,6,IXI)) Q:IXI'>0  D  Q:MDROETIO
"RTN","MMRSCRE",71,0)
 ....Q:IXI=""
"RTN","MMRSCRE",72,0)
 ....Q:'IXI
"RTN","MMRSCRE",73,0)
 ....S III=IXI_","_II_","
"RTN","MMRSCRE",74,0)
 ....S XX=$$GET1^DIQ(104.109,III,.01,"E")
"RTN","MMRSCRE",75,0)
 ....Q:XX=""
"RTN","MMRSCRE",76,0)
 ....S ETIONAME=XX,ORG=II,MDROETIO=ORG
"RTN","MMRSCRE",77,0)
ERROR ;
"RTN","MMRSCRE",78,0)
 I 'TSTSTP&'MDROETIO D
"RTN","MMRSCRE",79,0)
 .S EXTFLG=1
"RTN","MMRSCRE",80,0)
 .W !!,"    >>>The report cannot be run because the Etiology has not been "
"RTN","MMRSCRE",81,0)
 .W !,"        configured in the MDRO TOOLS LAB SEARCH/EXTRACT file, "
"RTN","MMRSCRE",82,0)
 .W !,"        (#104.1).  Use the MDRO Tools Lab Parameter Setup "
"RTN","MMRSCRE",83,0)
 .W !,"        option to configure."
"RTN","MMRSCRE",84,0)
 Q
"RTN","MMRSCRE",85,0)
 ;
"RTN","MMRSCRE",86,0)
CHECK3 ;Check if Ward Mappings have been setup for this division
"RTN","MMRSCRE",87,0)
 N NUMLOC,MMRSLOC,MMRSDIV
"RTN","MMRSCRE",88,0)
 S NUMLOC=0
"RTN","MMRSCRE",89,0)
 S MMRSDIV=0 F  S MMRSDIV=$O(^MMRS(104.3,MMRSDIV)) Q:'MMRSDIV  D
"RTN","MMRSCRE",90,0)
 .I $G(MMRSDIV) S NUMLOC=NUMLOC+1
"RTN","MMRSCRE",91,0)
 I NUMLOC=0 W !!,"   >>> Make sure the Ward Mappings for each Geographical Unit has been setup.",!! S EXTFLG=1
"RTN","MMRSCRE",92,0)
 Q
"RTN","MMRSCRE",93,0)
 ;
"RTN","MMRSCRE",94,0)
MAIN2 ; Entry for queuing
"RTN","MMRSCRE",95,0)
 D GETPARAM ; Load parameters in temp global
"RTN","MMRSCRE",96,0)
 D CLEAN ;Kill Temp Global
"RTN","MMRSCRE",97,0)
 Q
"RTN","MMRSCRE",98,0)
CLEAN ;
"RTN","MMRSCRE",99,0)
 K DFN,INDT,LIENS,LIEN,IN,ADMTDT,COLDT,LRIDT
"RTN","MMRSCRE",100,0)
 K ^TMP($J,"MMRSCRE"),TOTAL,DATA,DATA1,DIVARY,MDIV,DVSN
"RTN","MMRSCRE",101,0)
 K ^TMP($J,"MMRSCREPD"),TMPDATA
"RTN","MMRSCRE",102,0)
 Q
"RTN","MMRSCRE",103,0)
 ;
"RTN","MMRSCRE",104,0)
GETDIV() ;Prompt user to select Division
"RTN","MMRSCRE",105,0)
 N MMRSDIV,COUNT,DIV,DIC,Y,DLAYGO,X,DTOUT,DUOUT
"RTN","MMRSCRE",106,0)
 S MMRSDIV=""
"RTN","MMRSCRE",107,0)
 S COUNT=0,DIV=0 F  S DIV=$O(^MMRS(104,DIV)) Q:'DIV  S COUNT=COUNT+1
"RTN","MMRSCRE",108,0)
 I COUNT=1 S MMRSDIV=$O(^MMRS(104,0)) Q MMRSDIV
"RTN","MMRSCRE",109,0)
 S DIC="^DG(40.8,"
"RTN","MMRSCRE",110,0)
 S DIC(0)="AEMQ"
"RTN","MMRSCRE",111,0)
 S DIC("A")="Select the Division/Station: "
"RTN","MMRSCRE",112,0)
 S DIC("S")="I $D(^MMRS(104,""B"",Y))"
"RTN","MMRSCRE",113,0)
 D ^DIC K DIC
"RTN","MMRSCRE",114,0)
 I $D(DTOUT)!($D(DUOUT))!(Y=-1) S EXTFLG=1 Q ""
"RTN","MMRSCRE",115,0)
 S MMRSDIV=+Y
"RTN","MMRSCRE",116,0)
 S MMRSDIV=$O(^MMRS(104,"B",MMRSDIV,0))
"RTN","MMRSCRE",117,0)
 Q MMRSDIV
"RTN","MMRSCRE",118,0)
 ;
"RTN","MMRSCRE",119,0)
PROMPT ;Prompts user for start date, end date, locations, and if user wants to only print the Summary Report.
"RTN","MMRSCRE",120,0)
 S BYADM=1,PRMPTTXT="facility admission"
"RTN","MMRSCRE",121,0)
 ;
"RTN","MMRSCRE",122,0)
LOC ;Prompts user for division
"RTN","MMRSCRE",123,0)
 N STID,STNM,SIEN
"RTN","MMRSCRE",124,0)
 S (STP,ALL)=0
"RTN","MMRSCRE",125,0)
 W !
"RTN","MMRSCRE",126,0)
 S DIR(0)="YA",DIR("A")="Do you want to select all divisions: ",DIR("B")="NO"
"RTN","MMRSCRE",127,0)
 D ^DIR K DIR
"RTN","MMRSCRE",128,0)
 I $D(DIRUT) S EXTFLG=1 Q
"RTN","MMRSCRE",129,0)
 I Y=1 S ALL=1 D  Q:'CHK
"RTN","MMRSCRE",130,0)
 .S CHK=1
"RTN","MMRSCRE",131,0)
 .S DIV=0 F  S DIV=$O(^MMRS(104,DIV)) Q:$G(DIV)'>0  D  Q:STP!('CHK)
"RTN","MMRSCRE",132,0)
 ..D CHKPAR(ORGP,DIV,.CHK)
"RTN","MMRSCRE",133,0)
 ..I 'CHK S (MDROETIO,TSTSTP)=0 D ERROR  Q
"RTN","MMRSCRE",134,0)
 ..S WR=$$GET1^DIQ(104,DIV,.01,"I")
"RTN","MMRSCRE",135,0)
 ..S FID=$$GET1^DIQ(40.8,WR,1,"E"),STID=$$GET1^DIQ(40.8,WR,.01,"E")
"RTN","MMRSCRE",136,0)
 ..S MMRSLOC(FID)=STID,DIVARY(STID)=+DIV
"RTN","MMRSCRE",137,0)
 ..D CHECK(WR)
"RTN","MMRSCRE",138,0)
 ..I $G(NUMDIV)'>0 S STP=1 Q
"RTN","MMRSCRE",139,0)
 ..I $G(SPCM)'>0 S STP=1 Q
"RTN","MMRSCRE",140,0)
 Q:STP
"RTN","MMRSCRE",141,0)
 ;PROMPT FOR WARDS
"RTN","MMRSCRE",142,0)
 I 'Y D  Q:'CHK
"RTN","MMRSCRE",143,0)
 .S CHK=1
"RTN","MMRSCRE",144,0)
 .N DIC,DLAYGO,DTOUT,DUOUT
"RTN","MMRSCRE",145,0)
 .W !
"RTN","MMRSCRE",146,0)
 .S DIC("A")="Select Division: "
"RTN","MMRSCRE",147,0)
 .S DIC="^MMRS(104,",DIC(0)="QEAM" D ^DIC
"RTN","MMRSCRE",148,0)
 .I (Y=-1)!($D(DTOUT))!($D(DUOUT)) S EXTFLG=1 Q
"RTN","MMRSCRE",149,0)
 .D CHKPAR(ORGP,Y,.CHK)
"RTN","MMRSCRE",150,0)
 .I 'CHK S (MDROETIO,TSTSTP)=0 D ERROR  Q
"RTN","MMRSCRE",151,0)
 .S DPT=$P(Y,"^",2)
"RTN","MMRSCRE",152,0)
 .S STID=$$GET1^DIQ(40.8,DPT,.01,"E"),FID=$$GET1^DIQ(40.8,DPT,1,"E")
"RTN","MMRSCRE",153,0)
 .S MMRSLOC(FID)=STID,DIVARY(STID)=+Y
"RTN","MMRSCRE",154,0)
 .S WR=+Y
"RTN","MMRSCRE",155,0)
 .I $G(Y)>0 D CHECK(WR)
"RTN","MMRSCRE",156,0)
 .Q:$G(NUMDIV)'>0
"RTN","MMRSCRE",157,0)
 .Q:$G(SPCM)'>0
"RTN","MMRSCRE",158,0)
 .S CHK=1
"RTN","MMRSCRE",159,0)
 .S DIC("A")="Select another Division: " F  D ^DIC Q:Y=-1  D  Q:'CHK
"RTN","MMRSCRE",160,0)
 ..D CHKPAR(ORGP,Y,.CHK)
"RTN","MMRSCRE",161,0)
 ..I 'CHK S (MDROETIO,TSTSTP)=0 D ERROR  Q
"RTN","MMRSCRE",162,0)
 ..S STID=$$GET1^DIQ(104,+Y,.01,"E"),WR=$$GET1^DIQ(104,+Y,.01,"I")
"RTN","MMRSCRE",163,0)
 ..S FID=$$GET1^DIQ(40.8,WR,1,"E"),MMRSLOC(FID)=STID,DIVARY(STID)=+Y
"RTN","MMRSCRE",164,0)
 ..I $G(Y)>0 D CHECK(WR)
"RTN","MMRSCRE",165,0)
 ..I $G(NUMDIV)'>0 S STP=1 Q
"RTN","MMRSCRE",166,0)
 ..I $G(SPCM)'>0 S STP=1 Q
"RTN","MMRSCRE",167,0)
 .I ($D(DTOUT))!($D(DUOUT)) S EXTFLG=1 Q
"RTN","MMRSCRE",168,0)
 K DIC
"RTN","MMRSCRE",169,0)
 Q:$G(NUMDIV)'>0
"RTN","MMRSCRE",170,0)
 Q:$G(SPCM)'>0
"RTN","MMRSCRE",171,0)
 Q:$D(EXTFLG)
"RTN","MMRSCRE",172,0)
 I ($D(DTOUT))!($D(DUOUT)) S EXTFLG=1 Q
"RTN","MMRSCRE",173,0)
 ;
"RTN","MMRSCRE",174,0)
DATE ;Prompts user for date range
"RTN","MMRSCRE",175,0)
 N %DT,X
"RTN","MMRSCRE",176,0)
 K Y
"RTN","MMRSCRE",177,0)
 W ! S %DT="AEPX",%DT("A")="Begin with "_PRMPTTXT_" date: " D ^%DT
"RTN","MMRSCRE",178,0)
 I Y<0 S EXTFLG=1 Q
"RTN","MMRSCRE",179,0)
 S STRTDT=Y
"RTN","MMRSCRE",180,0)
 S %DT("A")="End with "_PRMPTTXT_" date: " D ^%DT
"RTN","MMRSCRE",181,0)
 I Y<0 S EXTFLG=1 Q
"RTN","MMRSCRE",182,0)
 S ENDDT=Y
"RTN","MMRSCRE",183,0)
 I '$P(ENDDT,".",2) S ENDDT=Y+.24
"RTN","MMRSCRE",184,0)
 I ENDDT<STRTDT W !!,"The ending date of the range must be later than the starting date." G DATE
"RTN","MMRSCRE",185,0)
 ;
"RTN","MMRSCRE",186,0)
SUMRPT ;Prompt user if should only run the summary report.
"RTN","MMRSCRE",187,0)
 I $G(MMRSSUM) S PRTSUM=1 Q  ; IF OPTION IS ONLY FOR SUMMARY REPORT...
"RTN","MMRSCRE",188,0)
 W !
"RTN","MMRSCRE",189,0)
 S DIR(0)="Y"
"RTN","MMRSCRE",190,0)
 S DIR("A")="Do you want to only print the summary report"
"RTN","MMRSCRE",191,0)
 S DIR("B")="NO"
"RTN","MMRSCRE",192,0)
 D ^DIR K DIR
"RTN","MMRSCRE",193,0)
 I $D(DIRUT) S EXTFLG=1 Q
"RTN","MMRSCRE",194,0)
 S PRTSUM=Y
"RTN","MMRSCRE",195,0)
 Q
"RTN","MMRSCRE",196,0)
ASKDVC ;Prompts user for device of output (allows queuing)
"RTN","MMRSCRE",197,0)
 N MMRSVAR,ZTSK
"RTN","MMRSCRE",198,0)
 W !! W:'PRTSUM !,"This report is designed for a 176 column format (landscape).",!
"RTN","MMRSCRE",199,0)
 S MMRSVAR("STRTDT")="",MMRSVAR("ENDDT")="",MMRSVAR("MMRSLOC(")=""
"RTN","MMRSCRE",200,0)
 S MMRSVAR("PRTSUM")="",MMRSVAR("BYADM")="",MMRSVAR("MMRSDIV")=""
"RTN","MMRSCRE",201,0)
 S MMRSVAR("DFLTDT")="",MMRSVAR("TSTSTP")="",MMRSVAR("MDROETIO")=""
"RTN","MMRSCRE",202,0)
 S MMRSVAR("ORG")="",MMRSVAR("DIVARY")="",MMRSVAR("DIVARY(")=""
"RTN","MMRSCRE",203,0)
 D EN^XUTMDEVQ("MAIN2^MMRSCRE","PRINT CRE Acute Care IPEC REPORT",.MMRSVAR,"QM",1)
"RTN","MMRSCRE",204,0)
 W:$D(ZTSK) !,"Report Queued to Print ("_ZTSK_").",!
"RTN","MMRSCRE",205,0)
 Q
"RTN","MMRSCRE",206,0)
 ;
"RTN","MMRSCRE",207,0)
GETPARAM ;(MDRO) ; Loads lab search/extract parameters from file 104.1
"RTN","MMRSCRE",208,0)
 N TSTNM,TST,MDRO,TEST,IEN,TIEN,ITOP,TOP,ETOP,IBACT,BACT,EBACT
"RTN","MMRSCRE",209,0)
 N ETIOL,ETIOLOGY,ANTI,ANTIM,INC,MRSASTAP,ETIONAME,MMRSI,MMRSET
"RTN","MMRSCRE",210,0)
 N MDRO
"RTN","MMRSCRE",211,0)
 S MMRSDIV=0,DIVSN="",LOC=""
"RTN","MMRSCRE",212,0)
 S MMRSMDRO=$O(^MMRS(104.2,"B","CRB-R",0))
"RTN","MMRSCRE",213,0)
 F  S LOC=$O(DIVARY(LOC)) Q:LOC=""  D
"RTN","MMRSCRE",214,0)
 .K ^TMP($J,"MMRSCRE","T")
"RTN","MMRSCRE",215,0)
 .K ^TMP($J,"MMRSCRE","ETIOL")
"RTN","MMRSCRE",216,0)
 .S Y=DIVARY(LOC)
"RTN","MMRSCRE",217,0)
 .S IEN="",IEN=$O(^MMRS(104.1,"C",+Y,MMRSMDRO,IEN))
"RTN","MMRSCRE",218,0)
 .Q:$G(IEN)'>0
"RTN","MMRSCRE",219,0)
 .;S MDROETIO=IEN
"RTN","MMRSCRE",220,0)
 .S MDRO=MMRSMDRO
"RTN","MMRSCRE",221,0)
 .S (FND,SUB,INC)=0
"RTN","MMRSCRE",222,0)
 .I $G(TSTSTP)'>0 S TSTSTP=1
"RTN","MMRSCRE",223,0)
 .I TSTSTP D
"RTN","MMRSCRE",224,0)
 ..S TIEN=0 F  S TIEN=$O(^MMRS(104.1,IEN,3,TIEN)) Q:'TIEN  D
"RTN","MMRSCRE",225,0)
 ...S LRIEN=TIEN_","_MDRO_","
"RTN","MMRSCRE",226,0)
 ...S TEST=$$GET1^DIQ(104.15,LRIEN,.01,"I")
"RTN","MMRSCRE",227,0)
 ...Q:'TEST
"RTN","MMRSCRE",228,0)
 ...S INC=INC+1
"RTN","MMRSCRE",229,0)
 ...S ^TMP($J,"MMRSCRE","T",MDRO,TEST_"_"_INC,0)=$P($G(^MMRS(104.1,MDRO,3,TIEN,0)),U,2,3)
"RTN","MMRSCRE",230,0)
 .I MDROETIO D
"RTN","MMRSCRE",231,0)
 ..S IBACT=0 F  S IBACT=$O(^MMRS(104.1,MDROETIO,4,IBACT)) Q:'IBACT  D
"RTN","MMRSCRE",232,0)
 ...S BACT=$G(^MMRS(104.1,MDROETIO,4,IBACT,0))
"RTN","MMRSCRE",233,0)
 ...I BACT'="" S ^TMP($J,"MMRSCD","BACT",MDROETIO,"INC_REMARK",IBACT)=BACT
"RTN","MMRSCRE",234,0)
 ..S EBACT=0 F  S EBACT=$O(^MMRS(104.1,MDROETIO,5,EBACT)) Q:'EBACT  D
"RTN","MMRSCRE",235,0)
 ...S BACT=$G(^MMRS(104.1,MDROETIO,5,EBACT,0))
"RTN","MMRSCRE",236,0)
 ..S ETIOL=0 F  S ETIOL=$O(^MMRS(104.1,MDROETIO,6,ETIOL)) Q:'ETIOL  D
"RTN","MMRSCRE",237,0)
 ...S ETIOLOGY=$G(^MMRS(104.1,MDROETIO,6,ETIOL,0))
"RTN","MMRSCRE",238,0)
 ...Q:'ETIOLOGY
"RTN","MMRSCRE",239,0)
 ...S ^TMP($J,"MMRSCRE","ETIOL",MDROETIO,+ETIOLOGY)=""
"RTN","MMRSCRE",240,0)
 .D GETMOVE^MMRSCRE2
"RTN","MMRSCRE",241,0)
 .D GETLABS^MMRSCRE3
"RTN","MMRSCRE",242,0)
 .D PRINT^MMRSCRE4
"RTN","MMRSCRE",243,0)
 Q
"RTN","MMRSCRE",244,0)
 ;
"RTN","MMRSCRE",245,0)
PATDAYS ;Gets 'PATIENT DAYS OF CARE'.
"RTN","MMRSCRE",246,0)
 N TTLRSLT,SDT,EDT,LOC,RSLT,WLOC,WARD,PATDAYS,RTOT
"RTN","MMRSCRE",247,0)
 S (FND,TTLRSLT,RTOT,TOTAL("PAT"),RSLT)=0
"RTN","MMRSCRE",248,0)
 S SDT=$P(STRTDT,".")
"RTN","MMRSCRE",249,0)
 S EDT=$P(ENDDT,".")
"RTN","MMRSCRE",250,0)
 Q:'$D(WRDLOC)
"RTN","MMRSCRE",251,0)
 S WARD=0 F  S WARD=$O(WRDLOC(WARD)) Q:$G(WARD)'>0  D
"RTN","MMRSCRE",252,0)
 .S LOC=$$GET1^DIQ(42,WARD,.015,"E")
"RTN","MMRSCRE",253,0)
 .Q:LOC'=LOCNAME
"RTN","MMRSCRE",254,0)
 .S PATDAYS=$$GETPATDY(WARD,SDT,EDT)
"RTN","MMRSCRE",255,0)
 .K WRDLOC(WARD)
"RTN","MMRSCRE",256,0)
 .;bdoc are calculated by  patients on ward @ midnight
"RTN","MMRSCRE",257,0)
 .;+ oneday admissions (patients admitted and discharged on same day).
"RTN","MMRSCRE",258,0)
 .;in order not to double-count oneday obs patient admitted to acute care
"RTN","MMRSCRE",259,0)
 .;on same day, adjus obs count.
"RTN","MMRSCRE",260,0)
 .I $G(ODOBS(WARD)) S PATDAYS=PATDAYS-ODOBS(WARD)
"RTN","MMRSCRE",261,0)
 .S RSLT=RSLT+PATDAYS,TTLRSLT=TTLRSLT+PATDAYS
"RTN","MMRSCRE",262,0)
 .S $P(^TMP($J,"MMRSCREPD","DSUM",LOCNAME),U,1)=RSLT
"RTN","MMRSCRE",263,0)
 S $P(^TMP($J,"MMRSCREPD","DSUM"),U,1)=TTLRSLT
"RTN","MMRSCRE",264,0)
 S TOTAL("PAT")=TTLRSLT
"RTN","MMRSCRE",265,0)
 Q
"RTN","MMRSCRE",266,0)
GETPATDY(WARD,SDT,EDT) ;Helper function for PATDAYS() - Gets Patient Days of care for specific ward
"RTN","MMRSCRE",267,0)
 N CENSUS,SCUMPD,ECUMPD
"RTN","MMRSCRE",268,0)
 I SDT>EDT Q 0
"RTN","MMRSCRE",269,0)
 I SDT<($$FY(EDT)_"1001") Q ($$GETPATDY(WARD,SDT,($$FY(EDT)_"0930"))+$$GETPATDY(WARD,($$FY(EDT)_"1001"),EDT))
"RTN","MMRSCRE",270,0)
 S CENSUS=$O(^DG(41.9,"B",WARD,0)) I 'CENSUS Q 0
"RTN","MMRSCRE",271,0)
 S SDT=$$FMADD^XLFDT(SDT,-1,0,0,0)
"RTN","MMRSCRE",272,0)
 S SCUMPD=$P($G(^DG(41.9,CENSUS,"C",SDT,0)),U,3)
"RTN","MMRSCRE",273,0)
 I EDT=$$DT^XLFDT S EDT=$$FMADD^XLFDT(EDT,-1,0,0,0)
"RTN","MMRSCRE",274,0)
 S ECUMPD=$P($G(^DG(41.9,CENSUS,"C",EDT,0)),U,3)
"RTN","MMRSCRE",275,0)
 I $E(SDT,4,7)="0930" S SCUMPD=0 ; IF LAST DAY OF FY
"RTN","MMRSCRE",276,0)
 I ECUMPD<SCUMPD Q 0
"RTN","MMRSCRE",277,0)
 Q ECUMPD-SCUMPD
"RTN","MMRSCRE",278,0)
FY(DATE) ;Helper function for GETPATDY - Gets fiscal year for the specified date
"RTN","MMRSCRE",279,0)
 I $E(DATE,4,7)>("1000"),$E(DATE,4,7)<("1232") Q $E(DATE,1,3)
"RTN","MMRSCRE",280,0)
 Q ($E(DATE,1,3)-1)
"RTN","MMRSCRE",281,0)
 ;
"RTN","MMRSCRE",282,0)
END ;
"RTN","MMRSCRE",283,0)
 K ALL,DIRUT,DIVSN,DPT,ETIO,FID,FND,II,III,IXI,LOCNME
"RTN","MMRSCRE",284,0)
 K LRIEN,MDROETIO,OBOBS,ORGP,PRMPTTXT,SPCM,STP,SUB,TSTSTP
"RTN","MMRSCRE",285,0)
 K WR,WRDLOC,XX,MMRSSUM,DIVARY,DVSN,MDIV
"RTN","MMRSCRE",286,0)
 Q
"RTN","MMRSCRE",287,0)
 ;
"RTN","MMRSCRE2")
0^13^B15423408^B12793206
"RTN","MMRSCRE2",1,0)
MMRSCRE2 ;TCK - Print CRE Report Cont. (Contains functions to collect patient movements) ; 3/3/17 10:37am
"RTN","MMRSCRE2",2,0)
 ;;1.0;MDRO PROGRAM TOOLS;**4,5**;Jun 01, 2016;Build 146
"RTN","MMRSCRE2",3,0)
 ;
"RTN","MMRSCRE2",4,0)
GETMOVE ;Collects ward movements for patients that were admitted or discharged in date range.
"RTN","MMRSCRE2",5,0)
 N DUPLOC,MMRSLOC2
"RTN","MMRSCRE2",6,0)
 D GETADM(LOC)
"RTN","MMRSCRE2",7,0)
 ;
"RTN","MMRSCRE2",8,0)
GETADM(LOC) ;
"RTN","MMRSCRE2",9,0)
 N TT,MOVDT,MOVIFN,TRANTYPE,INWARD,INDATE,INIFN,INTT,OUTDATE,OUTIFN,OUTTT,NEXTIEN,LOCNAME,VAIP,INLOC
"RTN","MMRSCRE2",10,0)
 N OUTWARD,PREVWARD
"RTN","MMRSCRE2",11,0)
 F TT=1,2 S MOVDT=STRTDT-.0000001 F  S MOVDT=$O(^DGPM("ATT"_TT,MOVDT)) Q:(MOVDT>ENDDT)!('MOVDT)  D
"RTN","MMRSCRE2",12,0)
 .S MOVIFN="" F  S MOVIFN=$O(^DGPM("ATT"_TT,MOVDT,MOVIFN)) Q:'MOVIFN  D
"RTN","MMRSCRE2",13,0)
 ..D KVA^VADPT S DFN=$P($G(^DGPM(MOVIFN,0)),"^",3),VAIP("E")=MOVIFN D IN5^VADPT
"RTN","MMRSCRE2",14,0)
 ..S TRANTYPE=$$TRANTYPE(+VAIP(4),+VAIP(2),VAIP(1),DFN)
"RTN","MMRSCRE2",15,0)
 ..S PREVWARD=$P(TRANTYPE,U,2)
"RTN","MMRSCRE2",16,0)
 ..I PREVWARD="" S PREVWARD=+VAIP(15,4)
"RTN","MMRSCRE2",17,0)
 ..S TRANTYPE=$P(TRANTYPE,U,1)
"RTN","MMRSCRE2",18,0)
 ..I TRANTYPE<1!(TRANTYPE=3) Q
"RTN","MMRSCRE2",19,0)
 ..S INWARD=+VAIP(5),WARD=$$GET1^DIQ(42,INWARD,.01,"E")
"RTN","MMRSCRE2",20,0)
 ..I $G(INWARD)>0 D
"RTN","MMRSCRE2",21,0)
 ...S HSPLC=$$GET1^DIQ(42,INWARD,44,"I")
"RTN","MMRSCRE2",22,0)
 ...S DIV=$$GET1^DIQ(44,HSPLC,3.5,"E")
"RTN","MMRSCRE2",23,0)
 ...S DIVS=$$GET1^DIQ(44,HSPLC,3.5,"I")
"RTN","MMRSCRE2",24,0)
 ...S DIVID=$$GET1^DIQ(40.8,DIVS,1,"I"),LOC=$$GET1^DIQ(40.8,DIVS,.01,"I")
"RTN","MMRSCRE2",25,0)
 ..;IS THIS WARD EXCLUDED FROM THIS REPORT
"RTN","MMRSCRE2",26,0)
 ..Q:DIV'=LOC
"RTN","MMRSCRE2",27,0)
 ..S LOCNAME=LOC
"RTN","MMRSCRE2",28,0)
 ..S WRDLOC(INWARD)=""
"RTN","MMRSCRE2",29,0)
 ..I TRANTYPE=2,'$$CNGWARD(LOC,PREVWARD,INWARD) Q
"RTN","MMRSCRE2",30,0)
 ..;SET GLOBAL
"RTN","MMRSCRE2",31,0)
 ..S INDATE=+VAIP(3)
"RTN","MMRSCRE2",32,0)
 ..S INIFN=MOVIFN
"RTN","MMRSCRE2",33,0)
 ..S INTT=TRANTYPE
"RTN","MMRSCRE2",34,0)
 ..S ADT=$$GET1^DIQ(405,MOVIFN,.04,"E")
"RTN","MMRSCRE2",35,0)
 ..S (OUTDATE,OUTIFN,OUTTT)=""
"RTN","MMRSCRE2",36,0)
 ..F  Q:(VAIP(16)="")!(OUTIFN)  D
"RTN","MMRSCRE2",37,0)
 ...S TRANTYPE=$$TRANTYPE(+VAIP(16,3),+VAIP(16,2),VAIP(16),DFN)
"RTN","MMRSCRE2",38,0)
 ...S OUTWARD=$P(TRANTYPE,U,2)
"RTN","MMRSCRE2",39,0)
 ...S NEXTIEN=$P(TRANTYPE,U,3)
"RTN","MMRSCRE2",40,0)
 ...S TRANTYPE=$P(TRANTYPE,U,1)
"RTN","MMRSCRE2",41,0)
 ...I OUTWARD="" S OUTWARD=+VAIP(16,4)
"RTN","MMRSCRE2",42,0)
 ...I TRANTYPE=3 S OUTDATE=+VAIP(16,1),OUTIFN=VAIP(16),OUTTT=3
"RTN","MMRSCRE2",43,0)
 ...;I TRANTYPE=2,$$CNGWARD(LOC,INWARD,OUTWARD) S OUTDATE=+VAIP(16,1),OUTIFN=VAIP(16),OUTTT=2
"RTN","MMRSCRE2",44,0)
 ...Q:OUTIFN
"RTN","MMRSCRE2",45,0)
 ...I NEXTIEN="" S NEXTIEN=VAIP(16)
"RTN","MMRSCRE2",46,0)
 ...D KVA^VADPT
"RTN","MMRSCRE2",47,0)
 ...S VAIP("E")=NEXTIEN
"RTN","MMRSCRE2",48,0)
 ...D IN5^VADPT
"RTN","MMRSCRE2",49,0)
 ..S INLOC=$G(INWARD)
"RTN","MMRSCRE2",50,0)
 ..S PATNM=$$GET1^DIQ(2,DFN,.01,"E")
"RTN","MMRSCRE2",51,0)
 ..S SSN=$$GET1^DIQ(2,DFN,.09,"E"),LAST4=$E(SSN,6,9)
"RTN","MMRSCRE2",52,0)
 ..S MASMOV=$$GET1^DIQ(405.1,TRANTYPE,.04,"E")
"RTN","MMRSCRE2",53,0)
 ..S ^TMP($J,"MMRSCRE","D",LOCNAME,DFN,INDATE)=INLOC_U_DFN_U_INDATE_U_INIFN_U_INTT_U_WARD_U_PATNM_U_LAST4_U_INDATE_U_OUTDATE
"RTN","MMRSCRE2",54,0)
 ..;S ^TMP($J,"MMRSCRE","DETAIL",LOCNAME,INDATE)=WARD_U_PATNM_U_LAST4_U_INDATE
"RTN","MMRSCRE2",55,0)
 D KVA^VADPT
"RTN","MMRSCRE2",56,0)
 Q
"RTN","MMRSCRE2",57,0)
CNGWARD(LOC,WARD1,WARD2) ;Did patient change wards?
"RTN","MMRSCRE2",58,0)
 I +$G(LOC)=0 S LOC=$$GETLOC(WARD1,.MMRSLOC2)
"RTN","MMRSCRE2",59,0)
 I $D(^MMRS(104.3,LOC,1,"B",WARD1)),$D(^MMRS(104.3,LOC,1,"B",WARD2)) Q 0
"RTN","MMRSCRE2",60,0)
 Q 1
"RTN","MMRSCRE2",61,0)
EXCWARD(LOC,WARD) ;Is this ward excluded from the reports?
"RTN","MMRSCRE2",62,0)
 I +$G(LOC)=0 S LOC=$$GETLOC(WARD,.MMRSLOC2)
"RTN","MMRSCRE2",63,0)
 I LOC=0 Q 1
"RTN","MMRSCRE2",64,0)
 I $D(^MMRS(104.3,LOC,1,"B",WARD)) Q 0
"RTN","MMRSCRE2",65,0)
 Q 1
"RTN","MMRSCRE2",66,0)
DUPLOC(LOC,LCTNS) ;
"RTN","MMRSCRE2",67,0)
 N RSLT,WARD,LOC2
"RTN","MMRSCRE2",68,0)
 S RSLT=0
"RTN","MMRSCRE2",69,0)
 S WARD=0 F  S WARD=$O(^MMRS(104.3,LOC,1,"B",WARD)) Q:'WARD  D
"RTN","MMRSCRE2",70,0)
 .S LOC2=0 F  S LOC2=$O(LCTNS(LOC2)) Q:'LOC2  D
"RTN","MMRSCRE2",71,0)
 ..Q:LOC2=LOC
"RTN","MMRSCRE2",72,0)
 ..I $D(^MMRS(104.3,LOC2,1,"B",WARD)) S RSLT=1
"RTN","MMRSCRE2",73,0)
 Q RSLT
"RTN","MMRSCRE2",74,0)
GETLOC(WARD,LCTNS) ;
"RTN","MMRSCRE2",75,0)
 N RSLT,LOC
"RTN","MMRSCRE2",76,0)
 S RSLT=0
"RTN","MMRSCRE2",77,0)
 S LOC=0 F  S LOC=$O(LCTNS(LOC)) Q:'LOC!(RSLT)  D
"RTN","MMRSCRE2",78,0)
 .I $D(^MMRS(104.3,LOC,1,"B",WARD)) S RSLT=LOC
"RTN","MMRSCRE2",79,0)
 Q RSLT
"RTN","MMRSCRE2",80,0)
TRANTYPE(MOVTYPE,TRANTYPE,MOVIEN,DFN) ;
"RTN","MMRSCRE2",81,0)
 I MOVTYPE=46!(MOVTYPE=5)!(MOVTYPE=6)!(MOVTYPE=7)!(MOVTYPE=47)!(MOVTYPE=27)!(MOVTYPE=33)!(MOVTYPE=3)!(MOVTYPE=22) Q -1 ;MIA/LMT - Removed MOVTYPE 29 ;4/15/10
"RTN","MMRSCRE2",82,0)
 I MOVTYPE=42!(MOVTYPE=20)!(MOVTYPE=1)!(MOVTYPE=45)!(MOVTYPE=23)!(MOVTYPE=25)!(MOVTYPE=26) Q -1
"RTN","MMRSCRE2",83,0)
 I MOVTYPE=2!(MOVTYPE=43)!(MOVTYPE=13) Q 3
"RTN","MMRSCRE2",84,0)
 I MOVTYPE=14!(MOVTYPE=24)!(MOVTYPE=44) Q 1
"RTN","MMRSCRE2",85,0)
 S TRANTYPE=$$CHKOBS^MMRSIPC2(DFN,MOVIEN,TRANTYPE)
"RTN","MMRSCRE2",86,0)
 Q TRANTYPE
"RTN","MMRSCRE2",87,0)
 ;
"RTN","MMRSCRE2",88,0)
END ;
"RTN","MMRSCRE2",89,0)
 K ADT,DIV,DIVID,DIVS,ENDDT,HLPLC,LAST4,MASMOV,PATNM,SSN
"RTN","MMRSCRE2",90,0)
 K STRTDT,WRDLOC,HSPLC
"RTN","MMRSCRE2",91,0)
 Q
"RTN","MMRSCRE2",92,0)
 ;
"RTN","MMRSCRE3")
0^14^B174713935^B160454267
"RTN","MMRSCRE3",1,0)
MMRSCRE3 ;LEIDOS/TCK - Print CRE Report Cont. (Contains functions to collect patient labs and swabbing rate) ; 3/3/17 10:47am
"RTN","MMRSCRE3",2,0)
 ;;1.0;MDRO PROGRAM TOOLS;**4,5**;Jun 01, 2016;Build 146
"RTN","MMRSCRE3",3,0)
 ;
"RTN","MMRSCRE3",4,0)
GETLABS ;Gets all lab data for the report.
"RTN","MMRSCRE3",5,0)
 N LRMDRO,LOC,INDT,DFN,OUTDT,NARES24,NARES48,SURV48,CULT48,MRSA365,CULT365,KNOWMRSA,KNOWCULT,NARES24A,NARES48ASURV48A,NARES48A
"RTN","MMRSCRE3",6,0)
 N MRSAFR,MRSATO,MRSA365A,CULT365A,SURV48A,NARES24D,NARES48D,SURV48D,MRSACPRD,TRANS,MMRSNOW
"RTN","MMRSCRE3",7,0)
 N CNTR
"RTN","MMRSCRE3",8,0)
 S CNTR=0
"RTN","MMRSCRE3",9,0)
 S MMRSNOW=$$NOW^XLFDT(),LREND=MMRSNOW
"RTN","MMRSCRE3",10,0)
 S LRMDRO="",LRMDRO=$O(^MMRS(104.2,"B","CRB-R",LRMDRO))
"RTN","MMRSCRE3",11,0)
 S ^TMP($J,"MMRSCRE","DSUM")="0^0^0^0^0^0^0^0^0"
"RTN","MMRSCRE3",12,0)
 S LOC="" F  S LOC=$O(^TMP($J,"MMRSCRE","D",LOC)) Q:LOC=""  D
"RTN","MMRSCRE3",13,0)
 .S ^TMP($J,"MMRSCRE","DSUM",LOC)="0^0^0^0^0^0^0^0^0"
"RTN","MMRSCRE3",14,0)
 .S DFN=0 F  S DFN=$O(^TMP($J,"MMRSCRE","D",LOC,DFN)) Q:'DFN  D
"RTN","MMRSCRE3",15,0)
 ..S INDT="" F  S INDT=$O(^TMP($J,"MMRSCRE","D",LOC,DFN,INDT)) Q:'INDT  D
"RTN","MMRSCRE3",16,0)
 ...S DIV="",DIV=$O(^DG(40.8,"B",LOC,DIV))
"RTN","MMRSCRE3",17,0)
 ...I DIV'="" S MDIV="",MDIV=$O(^MMRS(104,"B",DIV,MDIV))
"RTN","MMRSCRE3",18,0)
 ...Q:$G(MDIV)'>0
"RTN","MMRSCRE3",19,0)
 ...S (CR,MRSA)=""
"RTN","MMRSCRE3",20,0)
 ...S LOCSUM=$G(^TMP($J,"MMRSCRE","DSUM",LOC))
"RTN","MMRSCRE3",21,0)
 ...S SUM=$G(^TMP($J,"MMRSCRE","DSUM"))
"RTN","MMRSCRE3",22,0)
 ...S DATA=$G(^TMP($J,"MMRSCRE","D",LOC,DFN,INDT))
"RTN","MMRSCRE3",23,0)
 ...S OUTDT=$P(DATA,"^",10)
"RTN","MMRSCRE3",24,0)
 ...S ORDLOC=$P(^TMP($J,"MMRSCRE","D",LOC,DFN,INDT),"^")
"RTN","MMRSCRE3",25,0)
 ...I $G(ORDLOC)'="" S ORDLOC=$$GET1^DIQ(42,ORDLOC,.01,"E")
"RTN","MMRSCRE3",26,0)
 ...I $P(DATA,U,5)=1 D
"RTN","MMRSCRE3",27,0)
 ....S $P(^TMP($J,"MMRSCRE","DSUM",LOC),U,1)=$P(LOCSUM,U,1)+1,$P(^TMP($J,"MMRSCRE","DSUM"),U,1)=$P(SUM,U,1)+1
"RTN","MMRSCRE3",28,0)
 ...S MRSA=$$GETLAB(DFN,INDT,LRMDRO,LREND,"CD")
"RTN","MMRSCRE3",29,0)
 ...S (CR,I,COLDT)="",DONE=0
"RTN","MMRSCRE3",30,0)
 ...Q:MRSA=""
"RTN","MMRSCRE3",31,0)
 ...S CR=$P($P(MRSA,"^",2),";") I CR="" S CR="NEG"
"RTN","MMRSCRE3",32,0)
 ...Q:CR=""
"RTN","MMRSCRE3",33,0)
 ...S DTA=$P(MRSA,"^",2),LRD=$P(DTA,";",2),LRDT=$P(DTA,";",3),LIEN=LRDT_","_LRD_","
"RTN","MMRSCRE3",34,0)
 ...S LIENS=LRDT_","_LRD_","
"RTN","MMRSCRE3",35,0)
 ...S COLDT=$$GET1^DIQ(63.05,LIEN,.01,"I")
"RTN","MMRSCRE3",36,0)
 ...S SRCE=$P(MRSA,"^",3)
"RTN","MMRSCRE3",37,0)
 ...Q:SRCE=""
"RTN","MMRSCRE3",38,0)
 ...S SVC="N",CC="Y"
"RTN","MMRSCRE3",39,0)
 ...S DATA=$G(^TMP($J,"MMRSCRE","D",LOC,DFN,INDT))
"RTN","MMRSCRE3",40,0)
 ...Q:DATA=""
"RTN","MMRSCRE3",41,0)
 ...S ADMDT=$P(DATA,"^",3),MOVMENT=$P(DATA,"^",4)
"RTN","MMRSCRE3",42,0)
 ...S DTA=$P(MRSA,"^",2),LRD=$P(DTA,";",2),LRDT=$P(DTA,";",3),LRSS=$P(DTA,";",4),NEG=$P(DTA,";")
"RTN","MMRSCRE3",43,0)
 ...S LIENS=LRDT_","_LRD_","
"RTN","MMRSCRE3",44,0)
 ...S COLDT=$$GET1^DIQ(63.05,LIENS,.01,"I")
"RTN","MMRSCRE3",45,0)
 ...I $G(MOVMENT)>0 D
"RTN","MMRSCRE3",46,0)
 ....S TRNACT=$P(DATA,U,5) ;$$GET1^DIQ(405,MOVMENT,.02,"E")
"RTN","MMRSCRE3",47,0)
 ....I TRNACT'=1 S DONE=1 Q   ;"ADMISSION"
"RTN","MMRSCRE3",48,0)
 ....;S DSCHRGE=$$GET1^DIQ(405,MOVMENT,.17,"I")
"RTN","MMRSCRE3",49,0)
 ....S DSCHRGE=OUTDT  ;$$GET1^DIQ(405,DSCHRGE,.01,"I")
"RTN","MMRSCRE3",50,0)
 ....I $G(DSCHRGE)'="" D
"RTN","MMRSCRE3",51,0)
 .....S DTA=$P(MRSA,"^",2),LRD=$P(DTA,";",2),LRDT=$P(DTA,";",3),LRSS=$P(DTA,";",4),NEG=$P(DTA,";")
"RTN","MMRSCRE3",52,0)
 .....Q:$G(DTA)=""
"RTN","MMRSCRE3",53,0)
 .....S LIENS=LRDT_","_LRD_","
"RTN","MMRSCRE3",54,0)
 .....S COLDT=$$GET1^DIQ(63.05,LIENS,.01,"I")
"RTN","MMRSCRE3",55,0)
 .....I DSCHRGE<COLDT D
"RTN","MMRSCRE3",56,0)
 ......K ^TMP($J,"MMRSCRE","D",LOC,DFN,INDT)
"RTN","MMRSCRE3",57,0)
 ......K ^TMP($J,"MMRSCRE","DETAIL",LOC,INDT)
"RTN","MMRSCRE3",58,0)
 ......K LIENS S DONE=1
"RTN","MMRSCRE3",59,0)
 ...Q:DONE
"RTN","MMRSCRE3",60,0)
 ...I $D(^MMRS(104,MDIV,61,"B",SRCE)) S SVC="Y",CC="N"
"RTN","MMRSCRE3",61,0)
 ...I $D(^TMP($J,"MMRSCRE","D",LOC,DFN,INDT)) D
"RTN","MMRSCRE3",62,0)
 ....S DATA=$G(^TMP($J,"MMRSCRE","D",LOC,DFN,INDT))
"RTN","MMRSCRE3",63,0)
 ....S ACT=$P(DATA,"^",5)
"RTN","MMRSCRE3",64,0)
 ....Q:$P(^TMP($J,"MMRSCRE","D",LOC,DFN,INDT),"^",13)=""
"RTN","MMRSCRE3",65,0)
 ....S DTA=$P(MRSA,"^",2),LRD=$P(DTA,";",2),LRDT=$P(DTA,";",3),LRSS=$P(DTA,";",4),NEG=$P(DTA,";")
"RTN","MMRSCRE3",66,0)
 ....Q:$G(DTA)=""
"RTN","MMRSCRE3",67,0)
 ....S LIENS=LRDT_","_LRD_","
"RTN","MMRSCRE3",68,0)
 ....S COLDT=$$GET1^DIQ(63.05,LIENS,.01,"I")
"RTN","MMRSCRE3",69,0)
 ....S X=$$FMDIFF^XLFDT(COLDT,INDT,3),X=$P(X," ")
"RTN","MMRSCRE3",70,0)
 ....I X>2!('CR) D  Q
"RTN","MMRSCRE3",71,0)
 .....K MRSA
"RTN","MMRSCRE3",72,0)
 .....I $D(^TMP($J,"MMRSCRE","DETAIL",LOC,INDT)) K ^TMP($J,"MMRSCRE","DETAIL",LOC,INDT)
"RTN","MMRSCRE3",73,0)
 ....S SURV=$P(^TMP($J,"MMRSCRE","D",LOC,INDT,DFN),"^",13)
"RTN","MMRSCRE3",74,0)
 ....I SURV=SVC K MRSA(I) Q
"RTN","MMRSCRE3",75,0)
 ....I SURV'=SVC S $P(^TMP($J,"MMRSCRE","D",LOC,DFN,INDT),"^",13)="N",$P(^TMP($J,"MMRSCRE","D",LOC,DFN,INDT),"^",14)="Y" K MRSA(I)
"RTN","MMRSCRE3",76,0)
 ...Q:$G(MRSA)=""
"RTN","MMRSCRE3",77,0)
 ...I CR["POS",'PFLG D
"RTN","MMRSCRE3",78,0)
 ....Q:$D(^TMP($J,"MMRSCRE","DETAIL",LOC,INDT))
"RTN","MMRSCRE3",79,0)
 ....S ^TMP($J,"MMRSCRE","DETAIL",LOC,INDT)=$P(^TMP($J,"MMRSCRE","D",LOC,DFN,INDT),U,6,9)
"RTN","MMRSCRE3",80,0)
 ...I CR["POS",$D(^TMP($J,"MMRSCRE","DETAIL",LOC,INDT)),$P(^TMP($J,"MMRSCRE","DETAIL",LOC,INDT),U,13)="",'PFLG S ^TMP($J,"MMRSCRE","DETAIL",LOC,INDT)=^TMP($J,"MMRSCRE","DETAIL",LOC,INDT)_U_COLDT_U_SRCE_U_SVC_U_CC_U_CR
"RTN","MMRSCRE3",81,0)
 ...S MRSAFR=(INDT-10000) I STRTDT>INDT S MRSAFR=(STRTDT-10000) ;(ADM - 1 year) or  (START DT - 1 year) - whichever is later
"RTN","MMRSCRE3",82,0)
 ...D PREV ;Calculate prevalence measures
"RTN","MMRSCRE3",83,0)
 S X=""
"RTN","MMRSCRE3",84,0)
 Q
"RTN","MMRSCRE3",85,0)
 ;
"RTN","MMRSCRE3",86,0)
PREV ;Calculate prevalence measures (summary report)
"RTN","MMRSCRE3",87,0)
 N LOCSUM,SUM,DATA,IND
"RTN","MMRSCRE3",88,0)
 S LOCSUM=$G(^TMP($J,"MMRSCRE","DSUM",LOC))
"RTN","MMRSCRE3",89,0)
 S SUM=$G(^TMP($J,"MMRSCRE","DSUM"))
"RTN","MMRSCRE3",90,0)
 S DATA=$G(^TMP($J,"MMRSCRE","D",LOC,DFN,INDT))
"RTN","MMRSCRE3",91,0)
 I $P(DATA,U,5)'>2 D
"RTN","MMRSCRE3",92,0)
 .Q:MRSA'[";"
"RTN","MMRSCRE3",93,0)
 .S DTA=$P(MRSA,"^",2),LRD=$P(DTA,";",2),LRDT=$P(DTA,";",3),LRSS=$P(DTA,";",4),NEG=$P(DTA,";")
"RTN","MMRSCRE3",94,0)
 .Q:$G(DTA)=""
"RTN","MMRSCRE3",95,0)
 .S LIENS=LRDT_","_LRD_","
"RTN","MMRSCRE3",96,0)
 .S COLDT=$$GET1^DIQ(63.05,LIENS,.01,"I")
"RTN","MMRSCRE3",97,0)
 .Q:COLDT>ENDDT
"RTN","MMRSCRE3",98,0)
 .Q:COLDT<INDT
"RTN","MMRSCRE3",99,0)
 .S X=$$FMDIFF^XLFDT(COLDT,INDT,3),X=$P(X," ")
"RTN","MMRSCRE3",100,0)
 .I X<3 D
"RTN","MMRSCRE3",101,0)
 ..I SVC="Y" D
"RTN","MMRSCRE3",102,0)
 ...S $P(^TMP($J,"MMRSCRE","DSUM",LOC),U,2)=$P(LOCSUM,U,2)+1,$P(^TMP($J,"MMRSCRE","DSUM"),U,2)=$P(SUM,U,2)+1
"RTN","MMRSCRE3",103,0)
 ...I NEG="POS",'PFLG D
"RTN","MMRSCRE3",104,0)
 ....S $P(^TMP($J,"MMRSCRE","DSUM",LOC),U,3)=$P(LOCSUM,U,3)+1,$P(^TMP($J,"MMRSCRE","DSUM"),U,3)=$P(SUM,U,3)+1
"RTN","MMRSCRE3",105,0)
 ....S $P(^TMP($J,"MMRSCRE","DSUM",LOC),U,8)=$P(LOCSUM,U,8)+1,$P(^TMP($J,"MMRSCRE","DSUM"),U,8)=$P(SUM,U,8)+1
"RTN","MMRSCRE3",106,0)
 ..I SVC="N",NEG="POS",'PFLG D
"RTN","MMRSCRE3",107,0)
 ...S $P(^TMP($J,"MMRSCRE","DSUM",LOC),U,4)=$P(LOCSUM,U,4)+1,$P(^TMP($J,"MMRSCRE","DSUM"),U,4)=$P(SUM,U,4)+1
"RTN","MMRSCRE3",108,0)
 ...S $P(^TMP($J,"MMRSCRE","DSUM",LOC),U,8)=$P(LOCSUM,U,8)+1,$P(^TMP($J,"MMRSCRE","DSUM"),U,8)=$P(SUM,U,8)+1
"RTN","MMRSCRE3",109,0)
 .I X>2 D
"RTN","MMRSCRE3",110,0)
 ..I SVC="Y" D
"RTN","MMRSCRE3",111,0)
 ...S $P(^TMP($J,"MMRSCRE","DSUM",LOC),U,5)=$P(LOCSUM,U,5)+1,$P(^TMP($J,"MMRSCRE","DSUM"),U,5)=$P(SUM,U,5)+1
"RTN","MMRSCRE3",112,0)
 ...I NEG["POS",'PFLG D
"RTN","MMRSCRE3",113,0)
 ....S $P(^TMP($J,"MMRSCRE","DSUM",LOC),U,6)=$P(LOCSUM,U,6)+1,$P(^TMP($J,"MMRSCRE","DSUM"),U,6)=$P(SUM,U,6)+1
"RTN","MMRSCRE3",114,0)
 ....S $P(^TMP($J,"MMRSCRE","DSUM",LOC),U,8)=$P(LOCSUM,U,8)+1,$P(^TMP($J,"MMRSCRE","DSUM"),U,8)=$P(SUM,U,8)+1
"RTN","MMRSCRE3",115,0)
 ..I SVC="N",NEG["POS",'PFLG D
"RTN","MMRSCRE3",116,0)
 ...S $P(^TMP($J,"MMRSCRE","DSUM",LOC),U,7)=$P(LOCSUM,U,7)+1,$P(^TMP($J,"MMRSCRE","DSUM"),U,7)=$P(SUM,U,7)+1
"RTN","MMRSCRE3",117,0)
 ...S $P(^TMP($J,"MMRSCRE","DSUM",LOC),U,8)=$P(LOCSUM,U,8)+1,$P(^TMP($J,"MMRSCRE","DSUM"),U,8)=$P(SUM,U,8)+1
"RTN","MMRSCRE3",118,0)
 K MRSA
"RTN","MMRSCRE3",119,0)
 Q
"RTN","MMRSCRE3",120,0)
 ;
"RTN","MMRSCRE3",121,0)
CLNARY(LOC,DFN,MRSA) ;
"RTN","MMRSCRE3",122,0)
 N D,ST,VAL,XX,OUTDT
"RTN","MMRSCRE3",123,0)
 ;Q:'$D(MRSA(1)
"RTN","MMRSCRE3",124,0)
 S XX=9999,XX=$O(MRSA(XX),-1)
"RTN","MMRSCRE3",125,0)
 S D="" F  S D=$O(MRSA(D)) Q:D=""  D
"RTN","MMRSCRE3",126,0)
 .S IND=$P(MRSA(D),"^",4)
"RTN","MMRSCRE3",127,0)
 .S RES=$P($P(MRSA(D),"^",2),";")
"RTN","MMRSCRE3",128,0)
 .I RES=""!(RES["NEG") K MRSA(D) Q
"RTN","MMRSCRE3",129,0)
 .Q:'$D(^TMP($J,"MMRSCRE","D",LOC,IND,DFN))
"RTN","MMRSCRE3",130,0)
 .K ^TMP($J,"MMRSCRE","D",LOC,IND,DFN),MRSA(D)
"RTN","MMRSCRE3",131,0)
 .S DTA=MRSA(D)
"RTN","MMRSCRE3",132,0)
 .Q:DTA=""
"RTN","MMRSCRE3",133,0)
 .S LRD=$P(DTA,";",2),LRDT=$P(DTA,";",3)
"RTN","MMRSCRE3",134,0)
 .S DATA=$G(^TMP($J,"MMRSCRE","D",LOC,IND,DFN))
"RTN","MMRSCRE3",135,0)
 .S ADMDT=$P(DATA,"^",3),MOVMENT=$P(DATA,"^",4)
"RTN","MMRSCRE3",136,0)
 .S OUTDT=$P(DATA,"^",10)
"RTN","MMRSCRE3",137,0)
 .S DSCHRG=OUTDT  ;$$GET1^DIQ(405,MOVMENT,.17,"I")
"RTN","MMRSCRE3",138,0)
 .;I $G(DSCHRG)>0 S DSCHRG=$$GET1^DIQ(405,MOVMENT,.01,"I")
"RTN","MMRSCRE3",139,0)
 .I DSCHRG'="" D  Q
"RTN","MMRSCRE3",140,0)
 ..S LIENS=LRDT_","_LRD_","
"RTN","MMRSCRE3",141,0)
 ..S COLDT=$$GET1^DIQ(63.05,LIENS,.01,"I")
"RTN","MMRSCRE3",142,0)
 ..I DSCHRG<COLDT K ^TMP($J,"MMRSCRE","D",LOC,IND,DFN),MRSA(D) S DONE=1 Q
"RTN","MMRSCRE3",143,0)
 .S A=D-1 I $D(MRSA(A)) K MRSA(D) Q
"RTN","MMRSCRE3",144,0)
 Q
"RTN","MMRSCRE3",145,0)
GETLAB(DFN,LRSTART,LRMDRO,LREND,LRDTTYP) ;RETURN YES/NO^RESULT
"RTN","MMRSCRE3",146,0)
 N LRRSLT,LRTST,TMPRSLT
"RTN","MMRSCRE3",147,0)
 S LRRSLT="^",TMPRSLT=""
"RTN","MMRSCRE3",148,0)
 I $G(DFN)=""!($G(LRMDRO)="")!($G(LRSTART)="")!($G(LREND)="") Q LRRSLT
"RTN","MMRSCRE3",149,0)
 ;GET CH RSLTS
"RTN","MMRSCRE3",150,0)
 I MDROETIO D
"RTN","MMRSCRE3",151,0)
 .S TMPRSLT=$$GETMI(DFN,LRMDRO,LRSTART,LREND,LRDTTYP)
"RTN","MMRSCRE3",152,0)
 I TSTSTP D
"RTN","MMRSCRE3",153,0)
 .S LRTST=0 F  S LRTST=$O(^TMP($J,"MMRSCRE","T",LRMDRO,LRTST)) Q:'LRTST  D
"RTN","MMRSCRE3",154,0)
 .S SUBS=$$GET1^DIQ(60,+LRTST,4,"I")
"RTN","MMRSCRE3",155,0)
 .I SUBS="CH" S TMPRSLT=$$GETCH(DFN,LRMDRO,LRTST,LRSTART,LREND,LRDTTYP)
"RTN","MMRSCRE3",156,0)
 Q TMPRSLT
"RTN","MMRSCRE3",157,0)
 ;
"RTN","MMRSCRE3",158,0)
GETCH(DFN,LRMDRO,LRTST,LRSTART,LREND,LRDTTYP,MRSA) ;RETURN YES^RESULT
"RTN","MMRSCRE3",159,0)
 N LRRSLT,LRDFN,LRDATE,LRRADEND,DAS,LRIDT,LRSITE,TSTRSLT,LRRAD
"RTN","MMRSCRE3",160,0)
 S LRRSLT="^"
"RTN","MMRSCRE3",161,0)
 S LRDFN=$$LRDFN^LR7OR1(DFN)
"RTN","MMRSCRE3",162,0)
 Q:'LRDFN LRRSLT
"RTN","MMRSCRE3",163,0)
 S LRDATE=LRSTART-.0000001
"RTN","MMRSCRE3",164,0)
 I LRDTTYP="RAD" S LRDATE=0,LRRADEND=LREND,LREND=9999999
"RTN","MMRSCRE3",165,0)
 F  S LRDATE=$O(^PXRMINDX(63,"PI",DFN,+LRTST,LRDATE)) Q:'LRDATE!(LRDATE>LREND)  D
"RTN","MMRSCRE3",166,0)
 .Q:LRDATE>ENDDT
"RTN","MMRSCRE3",167,0)
 .Q:LRDATE<STRTDT
"RTN","MMRSCRE3",168,0)
 .S DAS=0 F  S DAS=$O(^PXRMINDX(63,"PI",DFN,+LRTST,LRDATE,DAS)) Q:'DAS  D
"RTN","MMRSCRE3",169,0)
 ..S LRIDT=$P(DAS,";",3)
"RTN","MMRSCRE3",170,0)
 ..I LRDTTYP="RAD" S LRRAD=$P($G(^LR(LRDFN,"CH",LRIDT,0)),U,3) I LRRAD<LRSTART!(LRRAD>LRRADEND) Q
"RTN","MMRSCRE3",171,0)
 ..Q:LRDATE<STRTDT
"RTN","MMRSCRE3",172,0)
 ..Q:LRDATE>ENDDT
"RTN","MMRSCRE3",173,0)
 ..Q:$P($G(^LR(LRDFN,"CH",LRIDT,0)),U,3)=""
"RTN","MMRSCRE3",174,0)
 ..;GET ORDER NUMBER FROM ORUT MODE
"RTN","MMRSCRE3",175,0)
 ..S LRSITE=$P($G(^LR(LRDFN,"CH",LRIDT,0)),U,5)
"RTN","MMRSCRE3",176,0)
 ..;Q:$$SCRNTOP(LRSITE,LRMDRO)
"RTN","MMRSCRE3",177,0)
 ..;I $D(^LR(LRDFN,"CH",LRIDT,0)),$P(^LR(LRDFN,"CH",LRIDT,0),U,3) D
"RTN","MMRSCRE3",178,0)
 ..S $P(LRRSLT,"^",1)="Y"
"RTN","MMRSCRE3",179,0)
 ..S TSTRSLT=$$CHRSLT(LRDFN,LRIDT,LRMDRO,LRTST)
"RTN","MMRSCRE3",180,0)
 ..I TSTRSLT["POS",(($P(LRRSLT,"^",2)="")!($P($P(LRRSLT,"^",2),";",3)>LRIDT)) D
"RTN","MMRSCRE3",181,0)
 ..I ($P(LRRSLT,"^",2)="")!($P($P(LRRSLT,"^",2),";",3)>LRIDT) D
"RTN","MMRSCRE3",182,0)
 ...S $P(LRRSLT,"^",2)=(TSTRSLT_";"_LRDFN_";"_LRIDT_";CH")
"RTN","MMRSCRE3",183,0)
 ...S LIEN=LRIDT_","_LRDFN_","
"RTN","MMRSCRE3",184,0)
 ...S SRCE=$$GET1^DIQ(63.04,LIEN,.05,"E")
"RTN","MMRSCRE3",185,0)
 ...S LRRSLT=LRRSLT_"^"_$G(SRCE)
"RTN","MMRSCRE3",186,0)
 Q LRRSLT
"RTN","MMRSCRE3",187,0)
 ;
"RTN","MMRSCRE3",188,0)
GETMI(DFN,LRMDRO,LRSTART,LREND,LRDTTYP) ;RETURN YES^RESULT
"RTN","MMRSCRE3",189,0)
 N LRRSLT,LRDFN,LRDATE,LRRADEND,DAS,LRIDT,LRSITE,TSTRSLT,LRRAD,LRIEND,CNTR
"RTN","MMRSCRE3",190,0)
 S LRRSLT="^",CNTR=0
"RTN","MMRSCRE3",191,0)
 I '$D(^TMP($J,"MMRSCRE","BACT",ORG,"INC_REMARK")),'$D(^TMP($J,"MMRSCRE","ETIOL",ORG)) Q LRRSLT
"RTN","MMRSCRE3",192,0)
 S LRDFN=$$LRDFN^LR7OR1(DFN)
"RTN","MMRSCRE3",193,0)
 Q:'LRDFN LRRSLT
"RTN","MMRSCRE3",194,0)
 S LRIDT=(9999999-LREND)-.0000001
"RTN","MMRSCRE3",195,0)
 S LRIEND=9999999-STRTDT
"RTN","MMRSCRE3",196,0)
 I LRDTTYP="RAD" S LRIDT=0,LRIEND=99999999
"RTN","MMRSCRE3",197,0)
 S (PFLG,DONE)=0
"RTN","MMRSCRE3",198,0)
 F  S LRIDT=$O(^LR(LRDFN,"MI",LRIDT)) Q:'LRIDT!(LRIDT>LRIEND)  D  Q:DONE
"RTN","MMRSCRE3",199,0)
 .I LRDTTYP="RAD" S LRRAD=$P($G(^LR(LRDFN,"MI",LRIDT,0)),U,3) I LRRAD<LRSTART!(LRRAD>LREND) Q
"RTN","MMRSCRE3",200,0)
 .S LRSITE=$P($G(^LR(LRDFN,"MI",LRIDT,0)),U,5)
"RTN","MMRSCRE3",201,0)
 .S $P(LRRSLT,"^",1)="Y"
"RTN","MMRSCRE3",202,0)
 .S TSTRSLT=$$MIRSLT(LRDFN,LRIDT,ORG)
"RTN","MMRSCRE3",203,0)
 .I $P($G(^LR(LRDFN,"MI",LRIDT,1)),U,2)="P" S PFLG=1
"RTN","MMRSCRE3",204,0)
 .I TSTRSLT="",$P(LRRSLT,"^")="Y" D
"RTN","MMRSCRE3",205,0)
 ..S LIEN=LRIDT_","_LRDFN_","
"RTN","MMRSCRE3",206,0)
 ..S SRCE=$$GET1^DIQ(63.05,LIEN,.05,"I")
"RTN","MMRSCRE3",207,0)
 ..S TSTRSLT="NEG",$P(LRRSLT,"^",2)=(TSTRSLT_";"_LRDFN_";"_LRIDT_";MI")
"RTN","MMRSCRE3",208,0)
 ..S LRRSLT=LRRSLT_"^"_$G(SRCE)_"^"_LRSTART,DONE=1 Q
"RTN","MMRSCRE3",209,0)
 .I TSTRSLT["POS",(($P(LRRSLT,"^",2)="")!($P($P(LRRSLT,"^",2),";",3)>LRIDT)) D
"RTN","MMRSCRE3",210,0)
 ..S $P(LRRSLT,"^",2)=(TSTRSLT_";"_LRDFN_";"_LRIDT_";MI")
"RTN","MMRSCRE3",211,0)
 ..I $G(DATA)'="" S MOVMENT=$P(DATA,U,4)
"RTN","MMRSCRE3",212,0)
 ..S DSCHMOV=$$GET1^DIQ(405,MOVMENT,.17,"I")
"RTN","MMRSCRE3",213,0)
 ..S DSCHRGE=$G(OUTDT)  ;$$GET1^DIQ(405,DSCHMOV,.01,"I")
"RTN","MMRSCRE3",214,0)
 ..S LIEN=LRIDT_","_LRDFN_","
"RTN","MMRSCRE3",215,0)
 ..S SRCE=$$GET1^DIQ(63.05,LIEN,.05,"I")
"RTN","MMRSCRE3",216,0)
 ..S COLDT=$$GET1^DIQ(63.05,LIEN,.01,"I")
"RTN","MMRSCRE3",217,0)
 ..I DSCHRGE>INDT,COLDT>DSCHRGE S LRRSLT="^" Q
"RTN","MMRSCRE3",218,0)
 ..S LRRSLT=LRRSLT_"^"_$G(SRCE)_"^"_LRSTART
"RTN","MMRSCRE3",219,0)
 ..I COLDT<LRSTART!(COLDT>ENDDT) S LRRSLT="^",TSTRSLT=LRRSLT Q
"RTN","MMRSCRE3",220,0)
 ..S CNTR=$G(CNTR)+1
"RTN","MMRSCRE3",221,0)
 ..S STOP=0
"RTN","MMRSCRE3",222,0)
 ..S RLOC=$$GET1^DIQ(63.05,LIEN,.111,"I")
"RTN","MMRSCRE3",223,0)
 ..S DIVLOC=$$GET1^DIQ(44,+RLOC,3.5,"E")
"RTN","MMRSCRE3",224,0)
 ..;Q:DIVLOC'=LOC
"RTN","MMRSCRE3",225,0)
 ..;S RLOC=$$GET1^DIQ(44,+RLOC,.01,"E")
"RTN","MMRSCRE3",226,0)
 ..S RLOC=$$GET1^DIQ(63.05,LIEN,.111,"I"),RLOC=+RLOC,RLOC=$$GET1^DIQ(44,RLOC,.01,"E")
"RTN","MMRSCRE3",227,0)
 ..I $G(RLOC)=ORDLOC,$G(CNTR)'>1,'$D(^MMRS(104,MDIV,61,"B",SRCE)) S DONE=1,STOP=1 Q
"RTN","MMRSCRE3",228,0)
 ..I $G(RLOC)=ORDLOC,$G(CNTR)'>1 M TMPDATA(DFN)=LRRSLT S LRRSLT="^" Q
"RTN","MMRSCRE3",229,0)
 ..I $G(RLOC)=ORDLOC,$G(CNTR)>1,'$D(^MMRS(104,MDIV,61,"B",SRCE)) D  Q
"RTN","MMRSCRE3",230,0)
 ...K TMPDATA S DONE=1 Q
"RTN","MMRSCRE3",231,0)
 ..Q:STOP
"RTN","MMRSCRE3",232,0)
 ..Q:DONE
"RTN","MMRSCRE3",233,0)
 ..I $G(RLOC)'=ORDLOC S MOVMENT=$P(DATA,"^",4)
"RTN","MMRSCRE3",234,0)
 ..I $G(MOVMENT)>0 D
"RTN","MMRSCRE3",235,0)
 ...S WRDLOC=$$GET1^DIQ(405,MOVMENT,.06,"E")
"RTN","MMRSCRE3",236,0)
 ...I WRDLOC=ORDLOC,$G(CNTR)'>1,'$D(^MMRS(104,MDIV,61,"B",SRCE)) S DONE=1 Q
"RTN","MMRSCRE3",237,0)
 ...I WRDLOC=ORDLOC,$G(CNTR)'>1 M TMPDATA(DFN)=LRRSLT S LRRSLT="^"
"RTN","MMRSCRE3",238,0)
 ...I WRDLOC=ORDLOC,$G(CNTR)>1,'$D(^MMRS(104,MDIV,61,"B",SRCE)) D
"RTN","MMRSCRE3",239,0)
 ....K TMPDATA S DONE=1 Q
"RTN","MMRSCRE3",240,0)
 ...I WRDLOC'=ORDLOC S (TSTRSLT,LRRSLT)="^"
"RTN","MMRSCRE3",241,0)
 I $D(TMPDATA(DFN)) M LRRSLT=TMPDATA(DFN)
"RTN","MMRSCRE3",242,0)
 Q LRRSLT
"RTN","MMRSCRE3",243,0)
 ;
"RTN","MMRSCRE3",244,0)
CHRSLT(LRDFN,LRIDT,LRMDRO,LRTST) ;RETURNS 'POS' OR NULL STRING (IF NOT POSITIVE)
"RTN","MMRSCRE3",245,0)
 N RESULT,LRLOC,LRND,LRPC,LRRES,LRIND,LRINDVAL,LRSPEC,LRLOW,LRHIG
"RTN","MMRSCRE3",246,0)
 S RESULT=""
"RTN","MMRSCRE3",247,0)
 S LRLOC=$P($G(^LAB(60,+LRTST,0)),U,5)
"RTN","MMRSCRE3",248,0)
 S LRND=$P(LRLOC,";",2) Q:+LRND'>0 RESULT
"RTN","MMRSCRE3",249,0)
 S LRPC=$P(LRLOC,";",3) Q:+LRPC'>0 RESULT
"RTN","MMRSCRE3",250,0)
 S LRRES=$P($G(^LR(LRDFN,"CH",LRIDT,LRND)),U,LRPC) Q:LRRES="" RESULT
"RTN","MMRSCRE3",251,0)
 S LRIND=$P($G(^TMP($J,"MMRSCRE","T",LRMDRO,LRTST,0)),U,1)
"RTN","MMRSCRE3",252,0)
 S LRINDVAL=$P($G(^TMP($J,"MMRSCRE","T",LRMDRO,LRTST,0)),U,2)
"RTN","MMRSCRE3",253,0)
 Q:LRIND="" RESULT
"RTN","MMRSCRE3",254,0)
 I LRIND=1 D  Q RESULT
"RTN","MMRSCRE3",255,0)
 .Q:'LRRES
"RTN","MMRSCRE3",256,0)
 .S LRSPEC=$P($G(^LR(LRDFN,"CH",LRIDT,0)),U,5) Q:LRSPEC=""
"RTN","MMRSCRE3",257,0)
 .Q:'$D(^LAB(60,LRTST,1,LRSPEC,0))
"RTN","MMRSCRE3",258,0)
 .S LRLOW=$P(^LAB(60,LRTST,1,LRSPEC,0),U,2),LRHIG=$P(^LAB(60,LRTST,1,LRSPEC,0),U,3)
"RTN","MMRSCRE3",259,0)
 .Q:'LRLOW!('LRHIG)
"RTN","MMRSCRE3",260,0)
 .I LRRES<LRLOW!(LRRES>LRHIG) S RESULT="POS" Q
"RTN","MMRSCRE3",261,0)
 I LRINDVAL="" Q RESULT
"RTN","MMRSCRE3",262,0)
 S LRRES=$$UP^XLFSTR(LRRES),LRINDVAL=$$UP^XLFSTR(LRINDVAL)
"RTN","MMRSCRE3",263,0)
 I LRIND=2,(LRRES[LRINDVAL) Q "POS"
"RTN","MMRSCRE3",264,0)
 I LRIND=3,(LRRES>LRINDVAL) Q "POS"
"RTN","MMRSCRE3",265,0)
 I LRIND=4,(LRRES<LRINDVAL) Q "POS"
"RTN","MMRSCRE3",266,0)
 I LRIND=5,(LRRES=LRINDVAL) Q "POS"
"RTN","MMRSCRE3",267,0)
 Q RESULT
"RTN","MMRSCRE3",268,0)
MIRSLT(LRDFN,LRIDT,LRMDRO) ;RETURNS 'POS' OR NULL STRING (IF NOT POSITIVE)
"RTN","MMRSCRE3",269,0)
 N RESULT,LRETND,LRETI,LRANTI,LRANTIND,LRANTINV,LRAND,LRRES,BACTRPT,RPTRMRK,LRANTIEN
"RTN","MMRSCRE3",270,0)
 S RESULT=""
"RTN","MMRSCRE3",271,0)
 ;Check Etiology
"RTN","MMRSCRE3",272,0)
 I $D(^TMP($J,"MMRSCRE","ETIOL",LRMDRO)) D  Q:RESULT="POS" RESULT
"RTN","MMRSCRE3",273,0)
 .S LRETND=0 F  S LRETND=$O(^LR(LRDFN,"MI",LRIDT,3,LRETND)) Q:'LRETND!(RESULT="POS")  D
"RTN","MMRSCRE3",274,0)
 ..S LRETI=$P($G(^LR(LRDFN,"MI",LRIDT,3,LRETND,0)),U)
"RTN","MMRSCRE3",275,0)
 ..Q:+LRETI'>0
"RTN","MMRSCRE3",276,0)
 ..I ('$O(^TMP($J,"MMRSCRE","ETIOL",LRMDRO,LRETI,0))) D  Q
"RTN","MMRSCRE3",277,0)
 ...I $D(^TMP($J,"MMRSCRE","ETIOL",LRMDRO,LRETI)) S RESULT="POS"
"RTN","MMRSCRE3",278,0)
 ..S LRANTI=0 F  S LRANTI=$O(^TMP($J,"MMRSCRE","ETIOL",LRMDRO,LRETI,LRANTI)) Q:'LRANTI  D
"RTN","MMRSCRE3",279,0)
 ...S LRANTIEN=$P(^TMP($J,"MMRSCRE","ETIOL",LRMDRO,LRETI,LRANTI),U,1)
"RTN","MMRSCRE3",280,0)
 ...S LRANTIND=$P(^TMP($J,"MMRSCRE","ETIOL",LRMDRO,LRETI,LRANTI),U,2)
"RTN","MMRSCRE3",281,0)
 ...S LRANTINV=$P(^TMP($J,"MMRSCRE","ETIOL",LRMDRO,LRETI,LRANTI),U,3)
"RTN","MMRSCRE3",282,0)
 ...;S LRAND=$P($G(^LAB(62.06,LRANTI,0)),U,2) Q:LRAND=""
"RTN","MMRSCRE3",283,0)
 ...S LRAND=$$ABDN^LRPXAPIU(LRANTIEN) Q:'LRAND
"RTN","MMRSCRE3",284,0)
 ...Q:$P($G(^LR(LRDFN,"MI",LRIDT,3,LRETND,LRAND)),U,2)=""
"RTN","MMRSCRE3",285,0)
 ...Q:$$UP^XLFSTR($E($P($G(^LR(LRDFN,"MI",LRIDT,3,LRETND,LRAND)),U,2),1,1))="S"
"RTN","MMRSCRE3",286,0)
 ...I LRANTIND=""!(LRANTINV="") Q
"RTN","MMRSCRE3",287,0)
 ...;S LRRES=$$UP^XLFSTR($E($P($G(^LR(LRDFN,"MI",LRIDT,3,LRETND,LRAND)),U,2),1,1))
"RTN","MMRSCRE3",288,0)
 ...S LRRES=$$UP^XLFSTR($P($G(^LR(LRDFN,"MI",LRIDT,3,LRETND,LRAND)),U,2))
"RTN","MMRSCRE3",289,0)
 ...S LRANTINV=$$UP^XLFSTR(LRANTINV)
"RTN","MMRSCRE3",290,0)
 ...S LRANTIND=$$UP^XLFSTR(LRANTIND)
"RTN","MMRSCRE3",291,0)
 ...I LRANTIND=1,(LRRES[LRANTINV) S RESULT="POS" Q
"RTN","MMRSCRE3",292,0)
 ...I LRANTIND=2,(LRRES>LRANTINV) S RESULT="POS" Q
"RTN","MMRSCRE3",293,0)
 ...I LRANTIND=3,(LRRES<LRANTINV) S RESULT="POS" Q
"RTN","MMRSCRE3",294,0)
 ...I LRANTIND=4,(LRRES=LRANTINV) S RESULT="POS" Q
"RTN","MMRSCRE3",295,0)
 Q:RESULT="POS" "POS"
"RTN","MMRSCRE3",296,0)
 ;Check Bacteriology Report Remarks
"RTN","MMRSCRE3",297,0)
 I '$D(^TMP($J,"MMRSCRE","BACT",LRMDRO,"INC_REMARK")) Q RESULT
"RTN","MMRSCRE3",298,0)
 S BACTRPT=0 F  S BACTRPT=$O(^LR(LRDFN,"MI",LRIDT,4,BACTRPT)) Q:'BACTRPT!(RESULT="POS")  D
"RTN","MMRSCRE3",299,0)
 .S RPTRMRK=$P($G(^LR(LRDFN,"MI",LRIDT,4,BACTRPT,0)),U,1)
"RTN","MMRSCRE3",300,0)
 .Q:RPTRMRK=""
"RTN","MMRSCRE3",301,0)
 .I $$BACTRPT(LRMDRO,"INC_REMARK",RPTRMRK)&('$$BACTRPT(LRMDRO,"EXC_REMARK",RPTRMRK)) S RESULT="POS"
"RTN","MMRSCRE3",302,0)
 Q RESULT
"RTN","MMRSCRE3",303,0)
 ;
"RTN","MMRSCRE3",304,0)
SCRNTOP(LRSITE,LRMDRO) ;CHECK TO SEE IF SCREEN ON SITE
"RTN","MMRSCRE3",305,0)
 Q:+LRSITE'>0 0
"RTN","MMRSCRE3",306,0)
 I $D(^TMP($J,"MMRSCRE","TOP",LRMDRO,"INC_TOP"))&$D(^TMP($J,"MMRSCRE","TOP",LRMDRO,"EXC_TOP")) Q 0
"RTN","MMRSCRE3",307,0)
 I '$D(^TMP($J,"MMRSCRE","TOP",LRMDRO,"INC_TOP"))&'$D(^TMP($J,"MMRSCRE","TOP",LRMDRO,"EXC_TOP")) Q 0
"RTN","MMRSCRE3",308,0)
 I ($D(^TMP($J,"MMRSCRE","TOP",LRMDRO,"INC_TOP")))&($D(^TMP($J,"MMRSCRE","TOP",LRMDRO,"INC_TOP",LRSITE))) Q 0
"RTN","MMRSCRE3",309,0)
 I ($D(^TMP($J,"MMRSCRE","TOP",LRMDRO,"EXC_TOP")))&('$D(^TMP($J,"MMRSCRE","TOP",LRMDRO,"EXC_TOP",LRSITE))) Q 0
"RTN","MMRSCRE3",310,0)
 Q 1
"RTN","MMRSCRE3",311,0)
BACTRPT(LRMDRO,RPTTYPE,RPTRMRK) ;Is this comment contained in the parameters
"RTN","MMRSCRE3",312,0)
 N RESULT,MMRSI,LRINDVAL
"RTN","MMRSCRE3",313,0)
 S RESULT=0
"RTN","MMRSCRE3",314,0)
 S MMRSI=0 F  S MMRSI=$O(^TMP($J,"MMRSCRE","BACT",LRMDRO,RPTTYPE,MMRSI)) Q:'MMRSI!(RESULT=1)  D
"RTN","MMRSCRE3",315,0)
 .S LRINDVAL=$G(^TMP($J,"MMRSCRE","BACT",LRMDRO,RPTTYPE,MMRSI))
"RTN","MMRSCRE3",316,0)
 .I ($$UP^XLFSTR(RPTRMRK))[($$UP^XLFSTR(LRINDVAL)) S RESULT=1
"RTN","MMRSCRE3",317,0)
 Q RESULT
"RTN","MMRSCRE3",318,0)
 ;
"RTN","MMRSCRE3",319,0)
END ;
"RTN","MMRSCRE3",320,0)
 K A,ACT,ADMDT,CC,COLDT,CR,DIV,DIVLOC,DONE,DSCHMOV,DSCHRGE,DTA
"RTN","MMRSCRE3",321,0)
 K ENDDT,I,LIEN,LRD,LRDT,LRSS,MDIV,MDROETIO,MOVEMENT,NEG
"RTN","MMRSCRE3",322,0)
 K ORDLOC,ORG,PFLG,RES,RLOC,SRCE,STOP,STRTDT,SUBS,SURV,SVC
"RTN","MMRSCRE3",323,0)
 K TRNACT,TSTSTP,WRDLOC,X,DSCHRG,MOVMENT
"RTN","MMRSCRE3",324,0)
 Q
"RTN","MMRSCRE3",325,0)
 ;
"RTN","MMRSCRE4")
0^15^B37634944^B34859922
"RTN","MMRSCRE4",1,0)
MMRSCRE4 ;TCK/LEIDOS - Print CRE Report Cont. (Contains functions to print report) ; 3/31/17 9:48am
"RTN","MMRSCRE4",2,0)
 ;;1.0;MDRO PROGRAM TOOLS;**4,5**;JUN 01, 2016;Build 146
"RTN","MMRSCRE4",3,0)
 ;
"RTN","MMRSCRE4",4,0)
PRINT ;Prints report data
"RTN","MMRSCRE4",5,0)
 N PG,MMRSNOW,NUMLOCS,LOCNAME,LN,PREVLOC,INDATE,DFN,OUTDATE,DATA
"RTN","MMRSCRE4",6,0)
 S PG=0
"RTN","MMRSCRE4",7,0)
 S MMRSNOW=$$NOW^XLFDT()
"RTN","MMRSCRE4",8,0)
 S NUMLOCS=0
"RTN","MMRSCRE4",9,0)
 S LOCNAME="" F  S LOCNAME=$O(^TMP($J,"MMRSCRE","D",LOCNAME)) Q:LOCNAME=""  S NUMLOCS=NUMLOCS+1
"RTN","MMRSCRE4",10,0)
 I PRTSUM S RPTYP="SUMMARY"
"RTN","MMRSCRE4",11,0)
 I 'PRTSUM S RPTYP="DETAILED"
"RTN","MMRSCRE4",12,0)
 S LOCNAME="" F  S LOCNAME=$O(^TMP($J,"MMRSCRE","D",LOCNAME)) Q:LOCNAME=""  D
"RTN","MMRSCRE4",13,0)
 .I '$D(DIVARY(LOCNAME)) K DIVARY(LOCNAME) Q
"RTN","MMRSCRE4",14,0)
 .I $D(DIVARY(LOCNAME)) K DIVARY(LOCNAME)
"RTN","MMRSCRE4",15,0)
 .Q:$G(LOCNAME)=""
"RTN","MMRSCRE4",16,0)
 .D PATDAYS^MMRSCRE
"RTN","MMRSCRE4",17,0)
 .D PRTSUMA(LOCNAME)
"RTN","MMRSCRE4",18,0)
 S $P(LN,"-",165)=""
"RTN","MMRSCRE4",19,0)
 Q:'$D(DIVARY)
"RTN","MMRSCRE4",20,0)
 S DVSN=0 F  S DVSN=$O(DIVARY(DVSN)) Q:DVSN=""  D
"RTN","MMRSCRE4",21,0)
 .Q:$G(DVSN)=""
"RTN","MMRSCRE4",22,0)
 .S LOC=DVSN
"RTN","MMRSCRE4",23,0)
 .D PRTHDRD
"RTN","MMRSCRE4",24,0)
 .W !!!,"NO RECORDS FOUND FOR REPORTING PERIOD."
"RTN","MMRSCRE4",25,0)
 .W !!!
"RTN","MMRSCRE4",26,0)
 W !!,"END OF REPORT"
"RTN","MMRSCRE4",27,0)
 D END
"RTN","MMRSCRE4",28,0)
 Q
"RTN","MMRSCRE4",29,0)
PRINTADM(LOC) ; Print cont.
"RTN","MMRSCRE4",30,0)
 S $P(LN,"-",165)=""
"RTN","MMRSCRE4",31,0)
 D PRTHDRD
"RTN","MMRSCRE4",32,0)
 N NODE,IN,WRD,PTN,L4,IND,ADT,MMV,SRC,SC,CC,VAL,INC
"RTN","MMRSCRE4",33,0)
 S IN=""
"RTN","MMRSCRE4",34,0)
 Q:LOC=""
"RTN","MMRSCRE4",35,0)
 I '$D(^TMP($J,"MMRSCRE","DETAIL",LOC)) D  Q
"RTN","MMRSCRE4",36,0)
 .W !!!,"NO RECORDS FOUND FOR REPORTING PERIOD."
"RTN","MMRSCRE4",37,0)
 F  S IN=$O(^TMP($J,"MMRSCRE","DETAIL",LOC,IN)) Q:IN=""  D
"RTN","MMRSCRE4",38,0)
 .S NODE=^TMP($J,"MMRSCRE","DETAIL",LOC,IN)
"RTN","MMRSCRE4",39,0)
 .S WRD=$P(NODE,"^"),PTN=$P(NODE,"^",2),L4=$P(NODE,"^",3)
"RTN","MMRSCRE4",40,0)
 .S IND=$P(NODE,"^",4),CLDT=$P(NODE,"^",5)
"RTN","MMRSCRE4",41,0)
 .S SRC=$P(NODE,"^",6),SRC=$$GET1^DIQ(61,SRC,.01,"E")
"RTN","MMRSCRE4",42,0)
 .S SC=$P(NODE,"^",7),CC=$P(NODE,"^",8)
"RTN","MMRSCRE4",43,0)
 .S VAL=$P(NODE,"^",9) I VAL="Y" S VAL="POS"
"RTN","MMRSCRE4",44,0)
 .S DTTE=$P(IND,"."),TIM=$P(IND,".",2),TIM=$E(TIM,1,4)
"RTN","MMRSCRE4",45,0)
 .S IND=DTTE_"."_TIM,IND=$$FMTE^XLFDT(IND)
"RTN","MMRSCRE4",46,0)
 .S DTTE=$P(CLDT,"."),TIM=$P(CLDT,".",2),TIM=$E(TIM,1,4)
"RTN","MMRSCRE4",47,0)
 .S CLDT=DTTE_"."_TIM,CLDT=$$FMTE^XLFDT(CLDT)
"RTN","MMRSCRE4",48,0)
 .S WD="",WD=$O(^DIC(42,"B",WRD,WD))
"RTN","MMRSCRE4",49,0)
 .I $G(WD)'="" S SPCTY=$$GET1^DIQ(42,WD,.017,"E")
"RTN","MMRSCRE4",50,0)
 .Q:$G(VAL)=""
"RTN","MMRSCRE4",51,0)
 .W !,WRD,?21,$G(SPCTY),?46,PTN,?70,L4,?77,IND,?97,CLDT,?122,SRC,?131,SC,?145,CC,?157,VAL
"RTN","MMRSCRE4",52,0)
 .I $Y+1>IOSL,LOC'="" D PRTHDRD
"RTN","MMRSCRE4",53,0)
 Q
"RTN","MMRSCRE4",54,0)
PRTHDRD ;
"RTN","MMRSCRE4",55,0)
 S PG=PG+1
"RTN","MMRSCRE4",56,0)
 W @IOF
"RTN","MMRSCRE4",57,0)
 S $P(LN,"-",165)=""
"RTN","MMRSCRE4",58,0)
 W ?13,"CRE ACUTE CARE IPEC REPORT - "_RPTYP
"RTN","MMRSCRE4",59,0)
 W !,?13,"Division: ",LOC
"RTN","MMRSCRE4",60,0)
 W !,?13,"Report period: ",$$FMTE^XLFDT(STRTDT)," to ",$$FMTE^XLFDT(ENDDT)
"RTN","MMRSCRE4",61,0)
 W !,?13,"Report printed on: ",$$FMTE^XLFDT(MMRSNOW),?70,"PAGE: ",PG
"RTN","MMRSCRE4",62,0)
 W !!
"RTN","MMRSCRE4",63,0)
 Q:PRTSUM
"RTN","MMRSCRE4",64,0)
 W ?77,"DATE",?97,"SPECIMEN COLLECTION",?131,"SURVEILLANCE",?145,"CLINICAL",?157,"CULTURE"
"RTN","MMRSCRE4",65,0)
 W !,"WARD",?21,"SERVICE",?46,"PATIENT",?70,"LAST4",?77,"ENTERED WARD",?97,"DATE/TIME",?122,"SOURCE",?131,"CULTURE",?145,"CULTURE",?157,"RESULT"
"RTN","MMRSCRE4",66,0)
 W !,LN
"RTN","MMRSCRE4",67,0)
 ;S PG=PG+1
"RTN","MMRSCRE4",68,0)
 Q
"RTN","MMRSCRE4",69,0)
PRTSUMA(LOC) ;
"RTN","MMRSCRE4",70,0)
 N II,L
"RTN","MMRSCRE4",71,0)
 W @IOF
"RTN","MMRSCRE4",72,0)
 S PG=$G(PG)+1
"RTN","MMRSCRE4",73,0)
 W ?13,"CRE ACUTE CARE IPEC REPORT - "_RPTYP
"RTN","MMRSCRE4",74,0)
 I $G(LOC)'="" W !,?13,"Division: ",LOC
"RTN","MMRSCRE4",75,0)
 I $G(LOC)="" W !,?13,"Divisions: " D  Q
"RTN","MMRSCRE4",76,0)
 .S II=1 S L="" F  S L=$O(^TMP($J,"MMRSCRE","DSUM",L)) Q:L=""  W:II>1&($X>37) ", " W L_"," S II=II+1 I $X>110 W !,?37
"RTN","MMRSCRE4",77,0)
 W !,?13,"Report period: ",$$FMTE^XLFDT(STRTDT)," to ",$$FMTE^XLFDT(ENDDT)
"RTN","MMRSCRE4",78,0)
 W !,?13,"Report printed on: ",$$FMTE^XLFDT(MMRSNOW),?70,"PAGE: ",PG
"RTN","MMRSCRE4",79,0)
 I $G(LOC)'="" S DATA=$G(^TMP($J,"MMRSCRE","DSUM",LOC))
"RTN","MMRSCRE4",80,0)
 I $G(LOC)="" S DATA=$G(^TMP($J,"MMRSCRE","DSUM"))
"RTN","MMRSCRE4",81,0)
 I $G(LOC)'="" S DATA1=$G(^TMP($J,"MMRSCREPD","DSUM",LOC))
"RTN","MMRSCRE4",82,0)
 I $G(LOC)="" S DATA1=$G(^TMP($J,"MMRSCREPD","DSUM"))
"RTN","MMRSCRE4",83,0)
 W !!,"Basic Measures and Device Days of Care"
"RTN","MMRSCRE4",84,0)
 W !,?3,"01 Total # of admissions to the acute care inpatient facility for the period: ",$P(DATA,"^")
"RTN","MMRSCRE4",85,0)
 W !,?3,"02 Total # of bed days of care for acute care for the period: ",DATA1
"RTN","MMRSCRE4",86,0)
 W !!,"Admission Prevalence Measures (Facility/Division Wide)"
"RTN","MMRSCRE4",87,0)
 W !,?3,"07 # of (01) with surveillance screens for CRE/CPE collected upon admission: ",$P(DATA,U,2)
"RTN","MMRSCRE4",88,0)
 W !,?3,"08 # of (07) that were positive for CRE/CPE based on surveillance screen: ",$P(DATA,U,3)
"RTN","MMRSCRE4",89,0)
 W !,?3,"09 # of (01) that were positive for CRE/CPE based on clinical cultures: ",$P(DATA,"^",4)
"RTN","MMRSCRE4",90,0)
 S (POS,CC,SC,SCPCT,CCPCT)=0
"RTN","MMRSCRE4",91,0)
 S TOTAL=$P(DATA,"^")
"RTN","MMRSCRE4",92,0)
 S TSC=$P(DATA,"^",2)
"RTN","MMRSCRE4",93,0)
 S SCPOS=$P(DATA,"^",3)
"RTN","MMRSCRE4",94,0)
 S CC=$P(DATA,"^",4)
"RTN","MMRSCRE4",95,0)
 I SCPOS=0 S SCPCT=0
"RTN","MMRSCRE4",96,0)
 I SCPOS>0 D
"RTN","MMRSCRE4",97,0)
 .I SCPOS=TSC S SCPCT=100 Q
"RTN","MMRSCRE4",98,0)
 .I SCPOS<TOTAL S SCPCT=(SCPOS/TSC)*100
"RTN","MMRSCRE4",99,0)
 .I SCPCT>0 D
"RTN","MMRSCRE4",100,0)
 ..I SCPCT["." D
"RTN","MMRSCRE4",101,0)
 ...S SPCT=$P(SCPCT,"."),SCDEC=$P(SCPCT,".",2),SCDEC=$E(SCDEC,1,2)
"RTN","MMRSCRE4",102,0)
 ...S SCPCT=SPCT_"."_SCDEC
"RTN","MMRSCRE4",103,0)
 ;I CC<TOTAL S CCPCT=(CC/TOTAL)*100
"RTN","MMRSCRE4",104,0)
 I CC=0 S CCPCT=0
"RTN","MMRSCRE4",105,0)
 I CC>0 D
"RTN","MMRSCRE4",106,0)
 .I CC=TOTAL S CCPCT=100 Q
"RTN","MMRSCRE4",107,0)
 .I CC<TOTAL S CCPCT=(CC/TOTAL)*100
"RTN","MMRSCRE4",108,0)
 .I CCPCT["." D
"RTN","MMRSCRE4",109,0)
 ..S PCT=$P(CCPCT,"."),CCDEC=$P(CCPCT,".",2),CCDEC=$E(CCDEC,1,2)
"RTN","MMRSCRE4",110,0)
 ..S CCPCT=PCT_"."_CCDEC
"RTN","MMRSCRE4",111,0)
 W !,?3,"10 % of (01) that were positive for CRE/CPE based on surveillance screening: ",$G(SCPCT)_"%"
"RTN","MMRSCRE4",112,0)
 W !,?3,"11 % of (01) that were positive for CRE/CPE based on clinical cultures: ",$G(CCPCT)_"%"
"RTN","MMRSCRE4",113,0)
 W !!,"Incidence Measures: Healthcare-Associated Colonized Cases"
"RTN","MMRSCRE4",114,0)
 W !,?3,"12 # of patients with screens for CRE/CPE collected 3 or more days after admission: ",$P(DATA,U,5)
"RTN","MMRSCRE4",115,0)
 W !,?3,"13 # of (12) that were positive for CRE/CPE based on surveillance screen collected 3 or more days after admission: ",$P(DATA,U,6)
"RTN","MMRSCRE4",116,0)
 W !,?3,"14 # of patients with clinical cultures positive for CRE/CPE 3 or more days after admission: ",$P(DATA,U,7)
"RTN","MMRSCRE4",117,0)
 S RATE=0
"RTN","MMRSCRE4",118,0)
 I DATA1>0 D
"RTN","MMRSCRE4",119,0)
 .S T=$P(DATA,U,6)+$P(DATA,U,7)
"RTN","MMRSCRE4",120,0)
 .I T>0 S RATE=(T/DATA1)*1000
"RTN","MMRSCRE4",121,0)
 .I RATE>0&(RATE[".") D
"RTN","MMRSCRE4",122,0)
 ..S RTE=$P(RATE,"."),RTDEC=$P(RATE,".",2),RTDEC=$E(RTDEC,1,2)
"RTN","MMRSCRE4",123,0)
 ..S RATE=RTE_"."_RTDEC
"RTN","MMRSCRE4",124,0)
 ;I $L(RATE)=1 S RA
"RTN","MMRSCRE4",125,0)
 W !,?3,"15 Rate of healthcare-associated colonized cases: ",$G(RATE)
"RTN","MMRSCRE4",126,0)
 W !!,"Infection Prevention and Control Measures"
"RTN","MMRSCRE4",127,0)
 W !,?3,"33 # of cases with CRE/CPE for the period: ",$P(DATA,U,8)
"RTN","MMRSCRE4",128,0)
 ;I PRTSUM W !!!,"END OF REPORT." Q
"RTN","MMRSCRE4",129,0)
 I 'PRTSUM D PRINTADM(LOCNAME)
"RTN","MMRSCRE4",130,0)
 I '$D(DIVARY) W !!!,"END OF REPORT"
"RTN","MMRSCRE4",131,0)
 Q
"RTN","MMRSCRE4",132,0)
 ;
"RTN","MMRSCRE4",133,0)
END ;
"RTN","MMRSCRE4",134,0)
 K CCDEC,CCPCT,CLDT,DATA1,DIVARY,DTTE,DVSN,ENDDT,PCT,POS,PRTSUM
"RTN","MMRSCRE4",135,0)
 K RATE,RPTYP,RTDEC,RTE,SCDEC,SCPCT,SCPOS,SPCT,SPCTY,STRTDT,T
"RTN","MMRSCRE4",136,0)
 K TIM,TOTAL,TSC,WD
"RTN","MMRSCRE4",137,0)
 Q
"RTN","MMRSCRE4",138,0)
 ;
"RTN","MMRSIPC")
0^18^B103279928^B96291150
"RTN","MMRSIPC",1,0)
MMRSIPC ;MIA/LMT - Print MRSA IPEC Report ;03/02/17  15:41
"RTN","MMRSIPC",2,0)
 ;;1.0;MRSA PROGRAM TOOLS;**3,5**;Mar 22, 2009;Build 146
"RTN","MMRSIPC",3,0)
 ;
"RTN","MMRSIPC",4,0)
 ;This is the main routine to print the MRSA IPEC Report.
"RTN","MMRSIPC",5,0)
 ;This routine uses functions contained in MMRSIPC2, MMRSIPC3, and MMRSIPC4.
"RTN","MMRSIPC",6,0)
MAIN ;
"RTN","MMRSIPC",7,0)
 N NUMDIV,MMRSDIV,MMRSLOC,EXTFLG,STRTDT,ENDDT,PRTSUM,BYADM
"RTN","MMRSIPC",8,0)
 D CHECK
"RTN","MMRSIPC",9,0)
 D CHECK2
"RTN","MMRSIPC",10,0)
 I $D(EXTFLG) W ! H 2 Q
"RTN","MMRSIPC",11,0)
 W !
"RTN","MMRSIPC",12,0)
 S MMRSDIV=$$GETDIV Q:$D(EXTFLG)!(MMRSDIV="")
"RTN","MMRSIPC",13,0)
 D CHECK3
"RTN","MMRSIPC",14,0)
 I $D(EXTFLG) W ! H 2 Q
"RTN","MMRSIPC",15,0)
 D PROMPT Q:$D(EXTFLG)
"RTN","MMRSIPC",16,0)
 D ASKDVC Q:$D(EXTFLG)
"RTN","MMRSIPC",17,0)
 K MMRSSUM
"RTN","MMRSIPC",18,0)
 Q
"RTN","MMRSIPC",19,0)
CHECK ;Check if parameters are setup
"RTN","MMRSIPC",20,0)
 N NUMDIV,MMRSDIV
"RTN","MMRSIPC",21,0)
 S NUMDIV=0
"RTN","MMRSIPC",22,0)
 S MMRSDIV=0 F  S MMRSDIV=$O(^MMRS(104,MMRSDIV)) Q:'MMRSDIV  I $D(^MMRS(104,MMRSDIV,0)) S NUMDIV=NUMDIV+1
"RTN","MMRSIPC",23,0)
 I NUMDIV=0 D
"RTN","MMRSIPC",24,0)
 .W !!,"   >>> Make sure a division has been setup using option:"
"RTN","MMRSIPC",25,0)
 .W !,"          'MRSA Tools Parameter Setup (Main)'"
"RTN","MMRSIPC",26,0)
 .S EXTFLG=1
"RTN","MMRSIPC",27,0)
 Q
"RTN","MMRSIPC",28,0)
CHECK2 ;Check if lab tests and etiologies are setup
"RTN","MMRSIPC",29,0)
 N TSTSTP,MRSAETIO,MRSASTAP,ORG,ETIONAME,MMRSET,MMRSI
"RTN","MMRSIPC",30,0)
 S TSTSTP=0
"RTN","MMRSIPC",31,0)
 I $D(^LAB(60,"B","MRSA SURVL NARES DNA"))!($D(^LAB(60,"B","MRSA SURVL NARES AGAR"))) S TSTSTP=1
"RTN","MMRSIPC",32,0)
 I $O(^LAB(60,"B","MRSA SURVL NARES DNA"))["MRSA SURVL NARES DNA" S TSTSTP=1
"RTN","MMRSIPC",33,0)
 I $O(^LAB(60,"B","MRSA SURVL NARES AGAR"))["MRSA SURVL NARES AGAR" S TSTSTP=1
"RTN","MMRSIPC",34,0)
 I 'TSTSTP D
"RTN","MMRSIPC",35,0)
 .S EXTFLG=1
"RTN","MMRSIPC",36,0)
 .W !!,"   >>> Make sure the MRSA CH-subscripted tests have been setup according"
"RTN","MMRSIPC",37,0)
 .W !,"       to the National Guidelines. Laboratory needs to setup at least"
"RTN","MMRSIPC",38,0)
 .W !,"       one of these lab tests in the system before generating reports:"
"RTN","MMRSIPC",39,0)
 .W !,"          1. 'MRSA SURVL NARES DNA'"
"RTN","MMRSIPC",40,0)
 .W !,"          2. 'MRSA SURVL NARES AGAR'"
"RTN","MMRSIPC",41,0)
 S MRSAETIO=0
"RTN","MMRSIPC",42,0)
 ;S MRSASTAP="STAPHYLOCOCCUS AUREUS METH" F  S MRSASTAP=$O(^LAB(61.2,"B",MRSASTAP)) Q:MRSASTAP=""!(MRSASTAP]"STAPHYLOCOCCUS AUREUSZ")  D
"RTN","MMRSIPC",43,0)
 ;.S ORG=0 F  S ORG=$O(^LAB(61.2,"B",MRSASTAP,ORG)) Q:'ORG  D
"RTN","MMRSIPC",44,0)
 ;..S ETIONAME=$P($G(^LAB(61.2,ORG,0)),U,1)
"RTN","MMRSIPC",45,0)
 ;..I ETIONAME["STAPHYLOCOCCUS AUREUS METHICILLIN RESISTANT (MRSA)" S MRSAETIO=ORG
"RTN","MMRSIPC",46,0)
 D FIND^DIC(61.2,,".01E;@","PM","STAPHYLOCOCCUS AUREUS METHICILLIN RESISTANT",,"B",,,"MMRSET")
"RTN","MMRSIPC",47,0)
 S MMRSI="" F  S MMRSI=$O(MMRSET("DILIST",MMRSI)) Q:MMRSI=""  I +MMRSI>0  D
"RTN","MMRSIPC",48,0)
 .S ETIONAME=$P($G(MMRSET("DILIST",MMRSI,0)),U,2)
"RTN","MMRSIPC",49,0)
 .S ORG=$P($G(MMRSET("DILIST",MMRSI,0)),U,1)
"RTN","MMRSIPC",50,0)
 .I ETIONAME["STAPHYLOCOCCUS AUREUS METHICILLIN RESISTANT" S MRSAETIO=ORG
"RTN","MMRSIPC",51,0)
 I 'MRSAETIO D
"RTN","MMRSIPC",52,0)
 .S EXTFLG=1
"RTN","MMRSIPC",53,0)
 .W !!,"   >>> Make sure the Etiology has been setup according "
"RTN","MMRSIPC",54,0)
 .W !,"       to the National Guidelines. The following etiology "
"RTN","MMRSIPC",55,0)
 .W !,"       must be added to the Etiology Field file (#61.2):"
"RTN","MMRSIPC",56,0)
 .W !,"          'STAPHYLOCOCCUS AUREUS METHICILLIN RESISTANT (MRSA)' "
"RTN","MMRSIPC",57,0)
 Q
"RTN","MMRSIPC",58,0)
CHECK3 ;Check if Ward Mappings have been setup for this division
"RTN","MMRSIPC",59,0)
 N NUMLOC,MMRSLOC
"RTN","MMRSIPC",60,0)
 S NUMLOC=0
"RTN","MMRSIPC",61,0)
 S MMRSLOC=0 F  S MMRSLOC=$O(^MMRS(104.3,MMRSLOC)) Q:'MMRSLOC  I $P($G(^MMRS(104.3,MMRSLOC,0)),U,2)=MMRSDIV S NUMLOC=NUMLOC+1
"RTN","MMRSIPC",62,0)
 I NUMLOC=0 W !!,"   >>> Make sure the Ward Mappings for each Geographical Unit has been setup.",!! S EXTFLG=1
"RTN","MMRSIPC",63,0)
 Q
"RTN","MMRSIPC",64,0)
MAIN2 ; Entry for queuing
"RTN","MMRSIPC",65,0)
 N ODOBS
"RTN","MMRSIPC",66,0)
 D CLEAN ;Kill Temp Global
"RTN","MMRSIPC",67,0)
 D GETPARAM ; Load parameters in temp global
"RTN","MMRSIPC",68,0)
 D GETMOVE^MMRSIPC2 ;Get movements and store in temp global
"RTN","MMRSIPC",69,0)
 D GETLABS^MMRSIPC3 ;Get swabbing rates and MRSA history and store in temp global
"RTN","MMRSIPC",70,0)
 I 'BYADM D PATDAYS ;Get patient days of care
"RTN","MMRSIPC",71,0)
 D PRINT^MMRSIPC4 ;Print report
"RTN","MMRSIPC",72,0)
 D CLEAN ;Kill Temp Global
"RTN","MMRSIPC",73,0)
 Q
"RTN","MMRSIPC",74,0)
CLEAN ;
"RTN","MMRSIPC",75,0)
 K ^TMP($J,"MMRSIPC")
"RTN","MMRSIPC",76,0)
 Q
"RTN","MMRSIPC",77,0)
GETDIV() ;Prompt user to select Division
"RTN","MMRSIPC",78,0)
 N MMRSDIV,COUNT,DIV,DIC,Y,DLAYGO,X,DTOUT,DUOUT
"RTN","MMRSIPC",79,0)
 S MMRSDIV=""
"RTN","MMRSIPC",80,0)
 S COUNT=0,DIV=0 F  S DIV=$O(^MMRS(104,DIV)) Q:'DIV  S COUNT=COUNT+1
"RTN","MMRSIPC",81,0)
 I COUNT=1 S MMRSDIV=$O(^MMRS(104,0)) Q MMRSDIV
"RTN","MMRSIPC",82,0)
 S DIC="^DG(40.8,"
"RTN","MMRSIPC",83,0)
 S DIC(0)="AEMQ"
"RTN","MMRSIPC",84,0)
 S DIC("A")="Select the Division: "
"RTN","MMRSIPC",85,0)
 S DIC("S")="I $D(^MMRS(104,""B"",Y))"
"RTN","MMRSIPC",86,0)
 D ^DIC K DIC
"RTN","MMRSIPC",87,0)
 I $D(DTOUT)!($D(DUOUT))!(Y=-1) S EXTFLG=1 Q ""
"RTN","MMRSIPC",88,0)
 S MMRSDIV=+Y
"RTN","MMRSIPC",89,0)
 S MMRSDIV=$O(^MMRS(104,"B",MMRSDIV,0))
"RTN","MMRSIPC",90,0)
 Q MMRSDIV
"RTN","MMRSIPC",91,0)
PROMPT ;Prompts user for start date, end date, locations, and if user wants to only print the Summary Report.
"RTN","MMRSIPC",92,0)
 ;Prompt if should run report by Admission or Discharge
"RTN","MMRSIPC",93,0)
 N DIR,DIRUT,PRMPTTXT,Y
"RTN","MMRSIPC",94,0)
 S DIR(0)="S^A:Admission Report;D:Discharge/Transmission Report"
"RTN","MMRSIPC",95,0)
 S DIR("A")="Run (A)dmission Or (D)ischarge/Transmission Report"
"RTN","MMRSIPC",96,0)
 D ^DIR K DIR
"RTN","MMRSIPC",97,0)
 I $D(DIRUT) S EXTFLG=1 Q
"RTN","MMRSIPC",98,0)
 I Y="A" S BYADM=1,PRMPTTXT="ward admission"
"RTN","MMRSIPC",99,0)
 I Y="D" S BYADM=0,PRMPTTXT="ward discharge"
"RTN","MMRSIPC",100,0)
DATE ;Prompts user for date range
"RTN","MMRSIPC",101,0)
 N %DT,X
"RTN","MMRSIPC",102,0)
 K Y
"RTN","MMRSIPC",103,0)
 W ! S %DT="AEPX",%DT("A")="Begin with "_PRMPTTXT_" date: " D ^%DT
"RTN","MMRSIPC",104,0)
 I Y<0 S EXTFLG=1 Q
"RTN","MMRSIPC",105,0)
 S STRTDT=Y
"RTN","MMRSIPC",106,0)
 S %DT("A")="End with "_PRMPTTXT_" date: " D ^%DT
"RTN","MMRSIPC",107,0)
 I Y<0 S EXTFLG=1 Q
"RTN","MMRSIPC",108,0)
 S ENDDT=Y
"RTN","MMRSIPC",109,0)
 I '$P(ENDDT,".",2) S ENDDT=Y+.24
"RTN","MMRSIPC",110,0)
 I ENDDT<STRTDT W !!,"The ending date of the range must be later than the starting date." G DATE
"RTN","MMRSIPC",111,0)
LOC ;Prompts user for locations
"RTN","MMRSIPC",112,0)
 W !
"RTN","MMRSIPC",113,0)
 S DIR(0)="YA",DIR("A")="Do you want to select all locations? ",DIR("B")="NO"
"RTN","MMRSIPC",114,0)
 D ^DIR K DIR
"RTN","MMRSIPC",115,0)
 I $D(DIRUT) S EXTFLG=1 Q
"RTN","MMRSIPC",116,0)
 I Y=1 D  G SUMRPT
"RTN","MMRSIPC",117,0)
 .S Y=0 F  S Y=$O(^MMRS(104.3,Y)) Q:'Y  I $P($G(^MMRS(104.3,Y,0)),U,2)=MMRSDIV S MMRSLOC(Y)=""
"RTN","MMRSIPC",118,0)
 ;PROMPT FOR WARDS
"RTN","MMRSIPC",119,0)
 N DIC,DLAYGO,DTOUT,DUOUT
"RTN","MMRSIPC",120,0)
 W !
"RTN","MMRSIPC",121,0)
 S DIC("A")="Select Geographical Location: "
"RTN","MMRSIPC",122,0)
 S DIC("S")="I $P($G(^MMRS(104.3,Y,0)),U,2)="_MMRSDIV
"RTN","MMRSIPC",123,0)
 S DIC="^MMRS(104.3,",DIC(0)="QEAM" D ^DIC
"RTN","MMRSIPC",124,0)
 I (Y=-1)!($D(DTOUT))!($D(DUOUT)) S EXTFLG=1 Q
"RTN","MMRSIPC",125,0)
 S MMRSLOC(+Y)=""
"RTN","MMRSIPC",126,0)
 S DIC("A")="Select another Geographical Location: " F  D ^DIC Q:Y=-1  S MMRSLOC(+Y)=""
"RTN","MMRSIPC",127,0)
 K DIC
"RTN","MMRSIPC",128,0)
 I ($D(DTOUT))!($D(DUOUT)) S EXTFLG=1 Q
"RTN","MMRSIPC",129,0)
SUMRPT ;Prompt user if should only run the summary report.
"RTN","MMRSIPC",130,0)
 I $G(MMRSSUM) S PRTSUM=1 Q  ; IF OPTION IS ONLY FOR SUMMARY REPORT...
"RTN","MMRSIPC",131,0)
 W !
"RTN","MMRSIPC",132,0)
 S DIR(0)="Y"
"RTN","MMRSIPC",133,0)
 S DIR("A")="Do you want to only print the summary report"
"RTN","MMRSIPC",134,0)
 S DIR("B")="NO"
"RTN","MMRSIPC",135,0)
 D ^DIR K DIR
"RTN","MMRSIPC",136,0)
 I $D(DIRUT) S EXTFLG=1 Q
"RTN","MMRSIPC",137,0)
 S PRTSUM=Y
"RTN","MMRSIPC",138,0)
 Q
"RTN","MMRSIPC",139,0)
ASKDVC ;Prompts user for device of output (allows queuing)
"RTN","MMRSIPC",140,0)
 N MMRSVAR,ZTSK
"RTN","MMRSIPC",141,0)
 W !! W:'PRTSUM !,"This report is designed for a 176 column format (landscape).",!
"RTN","MMRSIPC",142,0)
 S MMRSVAR("STRTDT")="",MMRSVAR("ENDDT")="",MMRSVAR("MMRSLOC(")=""
"RTN","MMRSIPC",143,0)
 S MMRSVAR("PRTSUM")="",MMRSVAR("BYADM")="",MMRSVAR("MMRSDIV")=""
"RTN","MMRSIPC",144,0)
 D EN^XUTMDEVQ("MAIN2^MMRSIPC","PRINT MRSA IPEC REPORT",.MMRSVAR,"QM",1)
"RTN","MMRSIPC",145,0)
 W:$D(ZTSK) !,"Report Queued to Print ("_ZTSK_").",!
"RTN","MMRSIPC",146,0)
 Q
"RTN","MMRSIPC",147,0)
GETPARAM ;(MDRO) ; Loads lab search/extract parameters from file 104.1
"RTN","MMRSIPC",148,0)
 N MRSAMDRO,TSTNM,TST,MDRO,TEST,IEN,TIEN,ITOP,TOP,ETOP,IBACT,BACT,EBACT
"RTN","MMRSIPC",149,0)
 N ETIOL,ETIOLOGY,ANTI,ANTIM,INC,MRSASTAP,ETIONAME,MMRSI,MMRSET,ORG
"RTN","MMRSIPC",150,0)
 S MRSAMDRO=$O(^MMRS(104.2,"B","MRSA",0))
"RTN","MMRSIPC",151,0)
 S INC=0
"RTN","MMRSIPC",152,0)
 S TSTNM="MRSA SURVL NARES DN"
"RTN","MMRSIPC",153,0)
 F  S TSTNM=$O(^LAB(60,"B",TSTNM)) Q:TSTNM=""!(TSTNM]"MRSA SURVL NARES DNA~zzz")  D
"RTN","MMRSIPC",154,0)
 .I TSTNM'["MRSA SURVL NARES DNA" Q
"RTN","MMRSIPC",155,0)
 .S TST=0 F  S TST=$O(^LAB(60,"B",TSTNM,TST)) Q:'TST  D
"RTN","MMRSIPC",156,0)
 ..S INC=INC+1
"RTN","MMRSIPC",157,0)
 ..S ^TMP($J,"MMRSIPC","T","MRSA_SCREEN",TST_"_"_INC,0)="2^POS"
"RTN","MMRSIPC",158,0)
 ..S ^TMP($J,"MMRSIPC","T",MRSAMDRO,TST_"_"_INC,0)="2^POS"
"RTN","MMRSIPC",159,0)
 S TSTNM="MRSA SURVL NARES AGA"
"RTN","MMRSIPC",160,0)
 F  S TSTNM=$O(^LAB(60,"B",TSTNM)) Q:TSTNM=""!(TSTNM]"MRSA SURVL NARES AGAR~zzz")  D
"RTN","MMRSIPC",161,0)
 .I TSTNM'["MRSA SURVL NARES AGAR" Q
"RTN","MMRSIPC",162,0)
 .S TST=0 F  S TST=$O(^LAB(60,"B",TSTNM,TST)) Q:'TST  D
"RTN","MMRSIPC",163,0)
 ..S INC=INC+1
"RTN","MMRSIPC",164,0)
 ..S ^TMP($J,"MMRSIPC","T","MRSA_SCREEN",TST_"_"_INC,0)="2^POS"
"RTN","MMRSIPC",165,0)
 ..S ^TMP($J,"MMRSIPC","T",MRSAMDRO,TST_"_"_INC,0)="2^POS"
"RTN","MMRSIPC",166,0)
 S TSTNM="MRSA SURVL OTHER DN"
"RTN","MMRSIPC",167,0)
 F  S TSTNM=$O(^LAB(60,"B",TSTNM)) Q:TSTNM=""!(TSTNM]"MRSA SURVL OTHER DNA~zzz")  D
"RTN","MMRSIPC",168,0)
 .I TSTNM'["MRSA SURVL OTHER DNA" Q
"RTN","MMRSIPC",169,0)
 .S TST=0 F  S TST=$O(^LAB(60,"B",TSTNM,TST)) Q:'TST  D
"RTN","MMRSIPC",170,0)
 ..S INC=INC+1
"RTN","MMRSIPC",171,0)
 ..S ^TMP($J,"MMRSIPC","T","MRSA_SURV",TST_"_"_INC,0)="2^POS"
"RTN","MMRSIPC",172,0)
 ..S ^TMP($J,"MMRSIPC","T",MRSAMDRO,TST_"_"_INC,0)="2^POS"
"RTN","MMRSIPC",173,0)
 S TSTNM="MRSA SURVL OTHER AGA"
"RTN","MMRSIPC",174,0)
 F  S TSTNM=$O(^LAB(60,"B",TSTNM)) Q:TSTNM=""!(TSTNM]"MRSA SURVL OTHER AGAR~zzz")  D
"RTN","MMRSIPC",175,0)
 .I TSTNM'["MRSA SURVL OTHER AGAR" Q
"RTN","MMRSIPC",176,0)
 .S TST=0 F  S TST=$O(^LAB(60,"B",TSTNM,TST)) Q:'TST  D
"RTN","MMRSIPC",177,0)
 ..S INC=INC+1
"RTN","MMRSIPC",178,0)
 ..S ^TMP($J,"MMRSIPC","T","MRSA_SURV",TST_"_"_INC,0)="2^POS"
"RTN","MMRSIPC",179,0)
 ..S ^TMP($J,"MMRSIPC","T",MRSAMDRO,TST_"_"_INC,0)="2^POS"
"RTN","MMRSIPC",180,0)
 S IEN="" F  S IEN=$O(^MMRS(104.1,"D",MMRSDIV,IEN)) Q:'IEN  D
"RTN","MMRSIPC",181,0)
 .S MDRO=$P($G(^MMRS(104.1,IEN,0)),U,1)
"RTN","MMRSIPC",182,0)
 .Q:'MDRO
"RTN","MMRSIPC",183,0)
 .S TIEN=0 F  S TIEN=$O(^MMRS(104.1,IEN,3,TIEN)) Q:'TIEN  D
"RTN","MMRSIPC",184,0)
 ..S TEST=$P($G(^MMRS(104.1,IEN,3,TIEN,0)),U,1)
"RTN","MMRSIPC",185,0)
 ..Q:'TEST
"RTN","MMRSIPC",186,0)
 ..S INC=INC+1
"RTN","MMRSIPC",187,0)
 ..S ^TMP($J,"MMRSIPC","T",MDRO,TEST_"_"_INC,0)=$P($G(^MMRS(104.1,IEN,3,TIEN,0)),U,2,3)
"RTN","MMRSIPC",188,0)
 .;S ITOP=0 F  S ITOP=$O(^MMRS(104.1,IEN,1,ITOP)) Q:'ITOP  D
"RTN","MMRSIPC",189,0)
 .;.S TOP=$G(^MMRS(104.1,IEN,1,ITOP,0))
"RTN","MMRSIPC",190,0)
 .;.I TOP S ^TMP($J,"MMRSIPC","TOP",MDRO,"INC_TOP",TOP)=""
"RTN","MMRSIPC",191,0)
 .;S ETOP=0 F  S ETOP=$O(^MMRS(104.1,IEN,2,ETOP)) Q:'ETOP  D
"RTN","MMRSIPC",192,0)
 .;.S TOP=$G(^MMRS(104.1,IEN,2,ETOP,0))
"RTN","MMRSIPC",193,0)
 .;.I TOP S ^TMP($J,"MMRSIPC","TOP",MDRO,"EXC_TOP",TOP)=""
"RTN","MMRSIPC",194,0)
 .S IBACT=0 F  S IBACT=$O(^MMRS(104.1,IEN,4,IBACT)) Q:'IBACT  D
"RTN","MMRSIPC",195,0)
 ..S BACT=$G(^MMRS(104.1,IEN,4,IBACT,0))
"RTN","MMRSIPC",196,0)
 ..I BACT'="" S ^TMP($J,"MMRSIPC","BACT",MDRO,"INC_REMARK",IBACT)=BACT
"RTN","MMRSIPC",197,0)
 .S EBACT=0 F  S EBACT=$O(^MMRS(104.1,IEN,5,EBACT)) Q:'EBACT  D
"RTN","MMRSIPC",198,0)
 ..S BACT=$G(^MMRS(104.1,IEN,5,EBACT,0))
"RTN","MMRSIPC",199,0)
 ..I BACT'="" S ^TMP($J,"MMRSIPC","BACT",MDRO,"EXC_REMARK",EBACT)=BACT
"RTN","MMRSIPC",200,0)
 .S ETIOL=0 F  S ETIOL=$O(^MMRS(104.1,IEN,6,ETIOL)) Q:'ETIOL  D
"RTN","MMRSIPC",201,0)
 ..S ETIOLOGY=$G(^MMRS(104.1,IEN,6,ETIOL,0))
"RTN","MMRSIPC",202,0)
 ..Q:'ETIOLOGY
"RTN","MMRSIPC",203,0)
 ..S ^TMP($J,"MMRSIPC","ETIOL",MDRO,+ETIOLOGY)=""
"RTN","MMRSIPC",204,0)
 ..S ANTI=0 F  S ANTI=$O(^MMRS(104.1,IEN,6,ETIOL,1,ANTI)) Q:'ANTI  D
"RTN","MMRSIPC",205,0)
 ...S ANTIM=$P($G(^MMRS(104.1,IEN,6,ETIOL,1,ANTI,0)),U)
"RTN","MMRSIPC",206,0)
 ...I ANTIM S ^TMP($J,"MMRSIPC","ETIOL",MDRO,ETIOLOGY,ANTI)=$G(^MMRS(104.1,IEN,6,ETIOL,1,ANTI,0))
"RTN","MMRSIPC",207,0)
 D FIND^DIC(61.2,,".01E;@","PM","STAPHYLOCOCCUS AUREUS METHICILLIN RESISTANT",,"B",,,"MMRSET")
"RTN","MMRSIPC",208,0)
 S MMRSI="" F  S MMRSI=$O(MMRSET("DILIST",MMRSI)) Q:MMRSI=""  I +MMRSI>0  D
"RTN","MMRSIPC",209,0)
 .S ETIONAME=$P($G(MMRSET("DILIST",MMRSI,0)),U,2)
"RTN","MMRSIPC",210,0)
 .S ORG=$P($G(MMRSET("DILIST",MMRSI,0)),U,1)
"RTN","MMRSIPC",211,0)
 .I ETIONAME'["STAPHYLOCOCCUS AUREUS METHICILLIN RESISTANT" Q
"RTN","MMRSIPC",212,0)
 .K ^TMP($J,"MMRSIPC","ETIOL",MRSAMDRO,ORG)
"RTN","MMRSIPC",213,0)
 .S ^TMP($J,"MMRSIPC","ETIOL","MRSA_CULTURE",ORG)=""
"RTN","MMRSIPC",214,0)
 .S ^TMP($J,"MMRSIPC","ETIOL",MRSAMDRO,ORG)=""
"RTN","MMRSIPC",215,0)
 Q
"RTN","MMRSIPC",216,0)
PATDAYS ;Gets 'PATIENT DAYS OF CARE'.
"RTN","MMRSIPC",217,0)
 N TTLRSLT,SDT,EDT,LOC,RSLT,WLOC,WARD,PATDAYS,LOCNAME
"RTN","MMRSIPC",218,0)
 S TTLRSLT=0
"RTN","MMRSIPC",219,0)
 S SDT=$P(STRTDT,".")
"RTN","MMRSIPC",220,0)
 S EDT=$P(ENDDT,".")
"RTN","MMRSIPC",221,0)
 S LOC=0 F  S LOC=$O(MMRSLOC(LOC)) Q:'LOC  D
"RTN","MMRSIPC",222,0)
 .S RSLT=0
"RTN","MMRSIPC",223,0)
 .S WLOC=0 F  S WLOC=$O(^MMRS(104.3,LOC,1,WLOC)) Q:'WLOC  D
"RTN","MMRSIPC",224,0)
 ..S WARD=$P($G(^MMRS(104.3,LOC,1,WLOC,0)),U,1) I 'WARD Q
"RTN","MMRSIPC",225,0)
 ..S PATDAYS=$$GETPATDY(WARD,SDT,EDT)
"RTN","MMRSIPC",226,0)
 ..;bdoc are calculated by  patients on ward @ midnight
"RTN","MMRSIPC",227,0)
 ..;+ oneday admissions (patients admitted and discharged on same day).
"RTN","MMRSIPC",228,0)
 ..;in order not to double-count oneday obs patient admitted to acute care
"RTN","MMRSIPC",229,0)
 ..;on same day, adjus obs count.
"RTN","MMRSIPC",230,0)
 ..I $G(ODOBS(WARD)) S PATDAYS=PATDAYS-ODOBS(WARD)
"RTN","MMRSIPC",231,0)
 ..S RSLT=RSLT+PATDAYS,TTLRSLT=TTLRSLT+PATDAYS
"RTN","MMRSIPC",232,0)
 ..S LOCNAME=$P($G(^MMRS(104.3,LOC,0)),U)
"RTN","MMRSIPC",233,0)
 ..S $P(^TMP($J,"MMRSIPC","DSUM",LOCNAME),U,1)=RSLT
"RTN","MMRSIPC",234,0)
 S $P(^TMP($J,"MMRSIPC","DSUM"),U,1)=TTLRSLT
"RTN","MMRSIPC",235,0)
 Q
"RTN","MMRSIPC",236,0)
GETPATDY(WARD,SDT,EDT) ;Helper function for PATDAYS() - Gets Patient Days of care for specific ward
"RTN","MMRSIPC",237,0)
 N CENSUS,SCUMPD,ECUMPD
"RTN","MMRSIPC",238,0)
 I SDT>EDT Q 0
"RTN","MMRSIPC",239,0)
 I SDT<($$FY(EDT)_"1001") Q ($$GETPATDY(WARD,SDT,($$FY(EDT)_"0930"))+$$GETPATDY(WARD,($$FY(EDT)_"1001"),EDT))
"RTN","MMRSIPC",240,0)
 S CENSUS=$O(^DG(41.9,"B",WARD,0)) I 'CENSUS Q 0
"RTN","MMRSIPC",241,0)
 S SDT=$$FMADD^XLFDT(SDT,-1,0,0,0)
"RTN","MMRSIPC",242,0)
 S SCUMPD=$P($G(^DG(41.9,CENSUS,"C",SDT,0)),U,3)
"RTN","MMRSIPC",243,0)
 I EDT=$$DT^XLFDT S EDT=$$FMADD^XLFDT(EDT,-1,0,0,0)
"RTN","MMRSIPC",244,0)
 S ECUMPD=$P($G(^DG(41.9,CENSUS,"C",EDT,0)),U,3)
"RTN","MMRSIPC",245,0)
 I $E(SDT,4,7)="0930" S SCUMPD=0 ; IF LAST DAY OF FY
"RTN","MMRSIPC",246,0)
 Q ECUMPD-SCUMPD
"RTN","MMRSIPC",247,0)
FY(DATE) ;Helper function for GETPATDY - Gets fiscal year for the specified date
"RTN","MMRSIPC",248,0)
 I $E(DATE,4,7)>("1000"),$E(DATE,4,7)<("1232") Q $E(DATE,1,3)
"RTN","MMRSIPC",249,0)
 Q ($E(DATE,1,3)-1)
"RTN","MMRSIPC2")
0^19^B111101050^B35335432
"RTN","MMRSIPC2",1,0)
MMRSIPC2 ;MIA/LMT - Print MRSA IPEC Report Cont. (Contains functions to collect patient movements) ;02/15/17  10:35
"RTN","MMRSIPC2",2,0)
 ;;1.0;MRSA PROGRAM TOOLS;**1,5**;Mar 22, 2009;Build 146
"RTN","MMRSIPC2",3,0)
 ;
"RTN","MMRSIPC2",4,0)
 ; Reference to ^DGPM("ATT"_X supported by ICR #1865
"RTN","MMRSIPC2",5,0)
 ; Reference to ^DGPM("APTT"_X supported by ICR #2090
"RTN","MMRSIPC2",6,0)
 ; Reference to ^DGPM(D0,0) supported by ICR #419
"RTN","MMRSIPC2",7,0)
 ; Reference to ^DGPM("AMV"_X supported by ICR #419
"RTN","MMRSIPC2",8,0)
 ; Reference to ^DPT("CN", supported by ICR #5431
"RTN","MMRSIPC2",9,0)
 ;
"RTN","MMRSIPC2",10,0)
 ;
"RTN","MMRSIPC2",11,0)
GETMOVE ;Collects ward movements for patients that were admitted or discharged in date range.
"RTN","MMRSIPC2",12,0)
 ;
"RTN","MMRSIPC2",13,0)
 ; ZEXCEPT: BYADM,MMRSLOC
"RTN","MMRSIPC2",14,0)
 ;
"RTN","MMRSIPC2",15,0)
 N LOC,DUPLOC,MMRSLOC2
"RTN","MMRSIPC2",16,0)
 ;
"RTN","MMRSIPC2",17,0)
 S LOC=0 F  S LOC=$O(MMRSLOC(LOC)) Q:'LOC  D
"RTN","MMRSIPC2",18,0)
 . S DUPLOC=$$DUPLOC(LOC,.MMRSLOC)
"RTN","MMRSIPC2",19,0)
 . I 'DUPLOC S MMRSLOC2(LOC)=""
"RTN","MMRSIPC2",20,0)
 . I DUPLOC D
"RTN","MMRSIPC2",21,0)
 . . I BYADM D GETADM(LOC)
"RTN","MMRSIPC2",22,0)
 . . I 'BYADM D GETDIS(LOC)
"RTN","MMRSIPC2",23,0)
 . . I 'BYADM D GETNODIS(LOC) ;For discharge\transmission report show list of patients that have not been discharged yet
"RTN","MMRSIPC2",24,0)
 I '$D(MMRSLOC2) Q
"RTN","MMRSIPC2",25,0)
 I BYADM D GETADM(0)
"RTN","MMRSIPC2",26,0)
 I 'BYADM D GETDIS(0)
"RTN","MMRSIPC2",27,0)
 I 'BYADM D GETNODIS(0) ;For discharge\transmission report show list of patients that have not been discharged yet
"RTN","MMRSIPC2",28,0)
 ;
"RTN","MMRSIPC2",29,0)
 Q
"RTN","MMRSIPC2",30,0)
 ;
"RTN","MMRSIPC2",31,0)
GETADM(LOC) ;
"RTN","MMRSIPC2",32,0)
 ;
"RTN","MMRSIPC2",33,0)
 ; ZEXCEPT: MMRSLOC2,STRTDT
"RTN","MMRSIPC2",34,0)
 ;
"RTN","MMRSIPC2",35,0)
 N TT,MOVDT,MOVIFN,DFN,TRANTYPE,INWARD,INDATE,INIFN,INTT,OUTDATE,OUTIFN,OUTTT,NEXTIEN,LOCNAME,VAIP,INLOC
"RTN","MMRSIPC2",36,0)
 N OUTWARD,PREVWARD
"RTN","MMRSIPC2",37,0)
 ;
"RTN","MMRSIPC2",38,0)
 F TT=1,2 S MOVDT=STRTDT-.0000001 F  S MOVDT=$O(^DGPM("ATT"_TT,MOVDT)) Q:(MOVDT>ENDDT)!('MOVDT)  D
"RTN","MMRSIPC2",39,0)
 . S MOVIFN="" F  S MOVIFN=$O(^DGPM("ATT"_TT,MOVDT,MOVIFN)) Q:'MOVIFN  D
"RTN","MMRSIPC2",40,0)
 . . D KVA^VADPT S DFN=$P($G(^DGPM(MOVIFN,0)),"^",3),VAIP("E")=MOVIFN D IN5^VADPT
"RTN","MMRSIPC2",41,0)
 . . S TRANTYPE=$$TRANTYPE(+VAIP(4),+VAIP(2),VAIP(1),DFN)
"RTN","MMRSIPC2",42,0)
 . . S PREVWARD=$P(TRANTYPE,U,2)
"RTN","MMRSIPC2",43,0)
 . . S TRANTYPE=$P(TRANTYPE,U,1)
"RTN","MMRSIPC2",44,0)
 . . I TRANTYPE<1!(TRANTYPE=3) Q
"RTN","MMRSIPC2",45,0)
 . . S INWARD=+VAIP(5)
"RTN","MMRSIPC2",46,0)
 . . I PREVWARD="" S PREVWARD=+VAIP(15,4)
"RTN","MMRSIPC2",47,0)
 . . I TRANTYPE=2,'$$CNGWARD(LOC,PREVWARD,INWARD) Q
"RTN","MMRSIPC2",48,0)
 . . Q:$$EXCWARD(LOC,INWARD)
"RTN","MMRSIPC2",49,0)
 . . ;SET GLOBAL
"RTN","MMRSIPC2",50,0)
 . . S INDATE=+VAIP(3)
"RTN","MMRSIPC2",51,0)
 . . S INIFN=MOVIFN
"RTN","MMRSIPC2",52,0)
 . . S INTT=TRANTYPE
"RTN","MMRSIPC2",53,0)
 . . ;
"RTN","MMRSIPC2",54,0)
 . . S (OUTDATE,OUTIFN,OUTTT)=" "
"RTN","MMRSIPC2",55,0)
 . . F  Q:(VAIP(16)="")!(OUTIFN)  D
"RTN","MMRSIPC2",56,0)
 . . . S TRANTYPE=$$TRANTYPE(+VAIP(16,3),+VAIP(16,2),VAIP(16),DFN)
"RTN","MMRSIPC2",57,0)
 . . . S OUTWARD=$P(TRANTYPE,U,2)
"RTN","MMRSIPC2",58,0)
 . . . S NEXTIEN=$P(TRANTYPE,U,3)
"RTN","MMRSIPC2",59,0)
 . . . S TRANTYPE=$P(TRANTYPE,U,1)
"RTN","MMRSIPC2",60,0)
 . . . I OUTWARD="" S OUTWARD=+VAIP(16,4)
"RTN","MMRSIPC2",61,0)
 . . . I TRANTYPE=3 S OUTDATE=+VAIP(16,1),OUTIFN=VAIP(16),OUTTT=3
"RTN","MMRSIPC2",62,0)
 . . . I TRANTYPE=2,$$CNGWARD(LOC,INWARD,OUTWARD) S OUTDATE=+VAIP(16,1),OUTIFN=VAIP(16),OUTTT=2
"RTN","MMRSIPC2",63,0)
 . . . Q:OUTIFN
"RTN","MMRSIPC2",64,0)
 . . . I NEXTIEN="" S NEXTIEN=VAIP(16)
"RTN","MMRSIPC2",65,0)
 . . . D KVA^VADPT
"RTN","MMRSIPC2",66,0)
 . . . S VAIP("E")=NEXTIEN
"RTN","MMRSIPC2",67,0)
 . . . D IN5^VADPT
"RTN","MMRSIPC2",68,0)
 . . ;
"RTN","MMRSIPC2",69,0)
 . . S INLOC=$G(LOC)
"RTN","MMRSIPC2",70,0)
 . . I +INLOC=0 S INLOC=$$GETLOC(INWARD,.MMRSLOC2)
"RTN","MMRSIPC2",71,0)
 . . S LOCNAME=$P($G(^MMRS(104.3,INLOC,0)),U)
"RTN","MMRSIPC2",72,0)
 . . S ^TMP($J,"MMRSIPC","D",LOCNAME,INDATE,DFN,OUTDATE)=INLOC_U_DFN_U_INDATE_U_INIFN_U_INTT_U_OUTDATE_U_OUTIFN_U_OUTTT
"RTN","MMRSIPC2",73,0)
 ;
"RTN","MMRSIPC2",74,0)
 D KVA^VADPT
"RTN","MMRSIPC2",75,0)
 ;
"RTN","MMRSIPC2",76,0)
 Q
"RTN","MMRSIPC2",77,0)
 ;
"RTN","MMRSIPC2",78,0)
GETDIS(LOC) ;
"RTN","MMRSIPC2",79,0)
 ;
"RTN","MMRSIPC2",80,0)
 ; ZEXCEPT: MMRSLOC2,STRTDT
"RTN","MMRSIPC2",81,0)
 ;
"RTN","MMRSIPC2",82,0)
 N TT,MOVDT,MOVIFN,DFN,TRANTYPE,OUTDATE,OUTIFN,OUTTT,INWARD,INDATE,INIFN,INTT,PREVIEN,INLOC,LOCNAME,VAIP
"RTN","MMRSIPC2",83,0)
 N NEXTWARD,PREVWARD
"RTN","MMRSIPC2",84,0)
 ;
"RTN","MMRSIPC2",85,0)
 F TT=2,3 S MOVDT=STRTDT-.0000001 F  S MOVDT=$O(^DGPM("ATT"_TT,MOVDT)) Q:(MOVDT>ENDDT)!('MOVDT)  D
"RTN","MMRSIPC2",86,0)
 . S MOVIFN="" F  S MOVIFN=$O(^DGPM("ATT"_TT,MOVDT,MOVIFN)) Q:'MOVIFN  D
"RTN","MMRSIPC2",87,0)
 . . D KVA^VADPT S DFN=$P($G(^DGPM(MOVIFN,0)),"^",3),VAIP("E")=MOVIFN D IN5^VADPT
"RTN","MMRSIPC2",88,0)
 . . I +VAIP(2)=3,+VAIP(15,3)=2 Q  ;Ignore discharges that are immediate following an Authorized Absence
"RTN","MMRSIPC2",89,0)
 . . S TRANTYPE=$$TRANTYPE(+VAIP(4),+VAIP(2),VAIP(1),DFN)
"RTN","MMRSIPC2",90,0)
 . . S NEXTWARD=$P(TRANTYPE,U,2)
"RTN","MMRSIPC2",91,0)
 . . S TRANTYPE=$P(TRANTYPE,U,1)
"RTN","MMRSIPC2",92,0)
 . . I NEXTWARD="" S NEXTWARD=+VAIP(5)
"RTN","MMRSIPC2",93,0)
 . . I TRANTYPE<2 Q
"RTN","MMRSIPC2",94,0)
 . . I TRANTYPE=2,'$$CNGWARD(LOC,+VAIP(15,4),NEXTWARD) Q
"RTN","MMRSIPC2",95,0)
 . . I $$EXCWARD(LOC,+VAIP(15,4)) Q
"RTN","MMRSIPC2",96,0)
 . . S OUTDATE=+VAIP(3)
"RTN","MMRSIPC2",97,0)
 . . S OUTIFN=MOVIFN
"RTN","MMRSIPC2",98,0)
 . . S OUTTT=TRANTYPE
"RTN","MMRSIPC2",99,0)
 . . ;
"RTN","MMRSIPC2",100,0)
 . . S INWARD=+VAIP(15,4)
"RTN","MMRSIPC2",101,0)
 . . S (INDATE,INIFN,INTT)=""
"RTN","MMRSIPC2",102,0)
 . . F  Q:(VAIP(15)="")!(INIFN)  D
"RTN","MMRSIPC2",103,0)
 . . . S TRANTYPE=$$TRANTYPE(+VAIP(15,3),+VAIP(15,2),VAIP(15),DFN)
"RTN","MMRSIPC2",104,0)
 . . . S PREVWARD=$P(TRANTYPE,U,2)
"RTN","MMRSIPC2",105,0)
 . . . S PREVIEN=$P(TRANTYPE,U,3)
"RTN","MMRSIPC2",106,0)
 . . . S TRANTYPE=$P(TRANTYPE,U,1)
"RTN","MMRSIPC2",107,0)
 . . . I PREVIEN="" S PREVIEN=VAIP(15)
"RTN","MMRSIPC2",108,0)
 . . . I TRANTYPE=1 S INDATE=+VAIP(15,1),INIFN=VAIP(15),INTT=1 ;,INWARD=+VAIP(15,4)
"RTN","MMRSIPC2",109,0)
 . . . I TRANTYPE=2,'PREVWARD D
"RTN","MMRSIPC2",110,0)
 . . . . D KVA^VADPT S VAIP("E")=PREVIEN D IN5^VADPT
"RTN","MMRSIPC2",111,0)
 . . . . I $$CNGWARD(LOC,+VAIP(5),+VAIP(15,4)) S INDATE=+VAIP(3),INIFN=VAIP(1),INTT=2 ;,INWARD=+VAIP(16,4)
"RTN","MMRSIPC2",112,0)
 . . . I TRANTYPE=2,PREVWARD,$$CNGWARD(LOC,PREVWARD,+VAIP(15,4)) S INDATE=+VAIP(15,1),INIFN=VAIP(15),INTT=2
"RTN","MMRSIPC2",113,0)
 . . . Q:INIFN
"RTN","MMRSIPC2",114,0)
 . . . D KVA^VADPT
"RTN","MMRSIPC2",115,0)
 . . . S VAIP("E")=PREVIEN
"RTN","MMRSIPC2",116,0)
 . . . D IN5^VADPT
"RTN","MMRSIPC2",117,0)
 . . ;
"RTN","MMRSIPC2",118,0)
 . . I '$G(INIFN) Q
"RTN","MMRSIPC2",119,0)
 . . S INLOC=$G(LOC)
"RTN","MMRSIPC2",120,0)
 . . I +INLOC=0 S INLOC=$$GETLOC(INWARD,.MMRSLOC2)
"RTN","MMRSIPC2",121,0)
 . . S LOCNAME=$P($G(^MMRS(104.3,INLOC,0)),U)
"RTN","MMRSIPC2",122,0)
 . . S ^TMP($J,"MMRSIPC","D",LOCNAME,INDATE,DFN,OUTDATE)=INLOC_U_DFN_U_INDATE_U_INIFN_U_INTT_U_OUTDATE_U_OUTIFN_U_OUTTT
"RTN","MMRSIPC2",123,0)
 ;
"RTN","MMRSIPC2",124,0)
 D KVA^VADPT
"RTN","MMRSIPC2",125,0)
 ;
"RTN","MMRSIPC2",126,0)
 Q
"RTN","MMRSIPC2",127,0)
 ;
"RTN","MMRSIPC2",128,0)
GETNODIS(LOC) ;For Discharge/Transmission report, it adds patients that have not been discharged from the wards to the report
"RTN","MMRSIPC2",129,0)
 ;
"RTN","MMRSIPC2",130,0)
 ; ZEXCEPT: ENDDT,MMRSLOC2
"RTN","MMRSIPC2",131,0)
 ;
"RTN","MMRSIPC2",132,0)
 N WARD,DFN,TMP,EDT,TT,SDT,INWARD,IEN,INDATE,INTT,INIFN,INLOC,LOCNAME,VAIP
"RTN","MMRSIPC2",133,0)
 N PREVIEN,PREVWARD
"RTN","MMRSIPC2",134,0)
 ;
"RTN","MMRSIPC2",135,0)
 S WARD="" F  S WARD=$O(^DPT("CN",WARD)) Q:WARD=""  D
"RTN","MMRSIPC2",136,0)
 . S DFN=0 F  S DFN=$O(^DPT("CN",WARD,DFN)) Q:'DFN  S TMP(DFN)=""
"RTN","MMRSIPC2",137,0)
 ;
"RTN","MMRSIPC2",138,0)
 S EDT=$$NOW^XLFDT
"RTN","MMRSIPC2",139,0)
 F TT=1:1:3 S SDT=ENDDT F  S SDT=$O(^DGPM("AMV"_TT,SDT)) Q:'SDT!(SDT>EDT)  D
"RTN","MMRSIPC2",140,0)
 . S DFN=0 F  S DFN=$O(^DGPM("AMV"_TT,SDT,DFN)) Q:'DFN  S TMP(DFN)=""
"RTN","MMRSIPC2",141,0)
 ;
"RTN","MMRSIPC2",142,0)
 S DFN=0 F  S DFN=$O(TMP(DFN)) Q:'DFN  D
"RTN","MMRSIPC2",143,0)
 . D KVA^VADPT
"RTN","MMRSIPC2",144,0)
 . S VAIP("D")=ENDDT
"RTN","MMRSIPC2",145,0)
 . D IN5^VADPT
"RTN","MMRSIPC2",146,0)
 . I 'VAIP(1) Q
"RTN","MMRSIPC2",147,0)
 . S INWARD=+VAIP(5)
"RTN","MMRSIPC2",148,0)
 . Q:$$EXCWARD(LOC,INWARD)
"RTN","MMRSIPC2",149,0)
 . ;
"RTN","MMRSIPC2",150,0)
 . S INTT=$$TRANTYPE(+VAIP(4),+VAIP(2),VAIP(1),DFN)
"RTN","MMRSIPC2",151,0)
 . S PREVWARD=$P(INTT,U,2)
"RTN","MMRSIPC2",152,0)
 . S PREVIEN=$P(INTT,U,4)
"RTN","MMRSIPC2",153,0)
 . S INTT=$P(INTT,U,1)
"RTN","MMRSIPC2",154,0)
 . I PREVWARD="" S PREVWARD=+VAIP(15,4)
"RTN","MMRSIPC2",155,0)
 . I PREVIEN="" S PREVIEN=VAIP(15)
"RTN","MMRSIPC2",156,0)
 . F  Q:(INTT=1)!(INTT=2&$$CNGWARD(LOC,+VAIP(5),PREVWARD))!(PREVIEN="")  D
"RTN","MMRSIPC2",157,0)
 . . S IEN=+PREVIEN
"RTN","MMRSIPC2",158,0)
 . . D KVA^VADPT
"RTN","MMRSIPC2",159,0)
 . . S VAIP("E")=IEN
"RTN","MMRSIPC2",160,0)
 . . D IN5^VADPT
"RTN","MMRSIPC2",161,0)
 . . S INTT=$$TRANTYPE(+VAIP(4),+VAIP(2),VAIP(1),DFN)
"RTN","MMRSIPC2",162,0)
 . . S PREVWARD=$P(INTT,U,2)
"RTN","MMRSIPC2",163,0)
 . . S PREVIEN=$P(INTT,U,4)
"RTN","MMRSIPC2",164,0)
 . . S INTT=$P(INTT,U,1)
"RTN","MMRSIPC2",165,0)
 . . I PREVWARD="" S PREVWARD=+VAIP(15,4)
"RTN","MMRSIPC2",166,0)
 . . I PREVIEN="" S PREVIEN=VAIP(15)
"RTN","MMRSIPC2",167,0)
 . ;
"RTN","MMRSIPC2",168,0)
 . I INTT<1!(INTT>2) Q
"RTN","MMRSIPC2",169,0)
 . S INDATE=+VAIP(3)
"RTN","MMRSIPC2",170,0)
 . S INIFN=+VAIP(1)
"RTN","MMRSIPC2",171,0)
 . I '$G(INIFN) Q
"RTN","MMRSIPC2",172,0)
 . S INLOC=$G(LOC)
"RTN","MMRSIPC2",173,0)
 . I +INLOC=0 S INLOC=$$GETLOC(INWARD,.MMRSLOC2)
"RTN","MMRSIPC2",174,0)
 . S LOCNAME=$P($G(^MMRS(104.3,INLOC,0)),U)
"RTN","MMRSIPC2",175,0)
 . S ^TMP($J,"MMRSIPC","D",LOCNAME,INDATE,DFN," ")=INLOC_U_DFN_U_INDATE_U_INIFN_U_INTT_U_" "_U_"0"_U_" "
"RTN","MMRSIPC2",176,0)
 ;
"RTN","MMRSIPC2",177,0)
 D KVA^VADPT
"RTN","MMRSIPC2",178,0)
 ;
"RTN","MMRSIPC2",179,0)
 Q
"RTN","MMRSIPC2",180,0)
 ;
"RTN","MMRSIPC2",181,0)
CNGWARD(LOC,WARD1,WARD2) ;Did patient change wards?
"RTN","MMRSIPC2",182,0)
 ;
"RTN","MMRSIPC2",183,0)
 ; ZEXCEPT: MMRSLOC2
"RTN","MMRSIPC2",184,0)
 ;
"RTN","MMRSIPC2",185,0)
 I +$G(LOC)=0 S LOC=$$GETLOC(WARD1,.MMRSLOC2)
"RTN","MMRSIPC2",186,0)
 I $D(^MMRS(104.3,LOC,1,"B",WARD1)),$D(^MMRS(104.3,LOC,1,"B",WARD2)) Q 0
"RTN","MMRSIPC2",187,0)
 Q 1
"RTN","MMRSIPC2",188,0)
 ;
"RTN","MMRSIPC2",189,0)
EXCWARD(LOC,WARD) ;Is this ward excluded from the reports?
"RTN","MMRSIPC2",190,0)
 ;
"RTN","MMRSIPC2",191,0)
 ; ZEXCEPT: MMRSLOC2
"RTN","MMRSIPC2",192,0)
 ;
"RTN","MMRSIPC2",193,0)
 I +$G(LOC)=0 S LOC=$$GETLOC(WARD,.MMRSLOC2)
"RTN","MMRSIPC2",194,0)
 I LOC=0 Q 1
"RTN","MMRSIPC2",195,0)
 I $D(^MMRS(104.3,LOC,1,"B",WARD)) Q 0
"RTN","MMRSIPC2",196,0)
 Q 1
"RTN","MMRSIPC2",197,0)
 ;
"RTN","MMRSIPC2",198,0)
DUPLOC(LOC,LCTNS) ;
"RTN","MMRSIPC2",199,0)
 ;
"RTN","MMRSIPC2",200,0)
 N RSLT,WARD,LOC2
"RTN","MMRSIPC2",201,0)
 ;
"RTN","MMRSIPC2",202,0)
 S RSLT=0
"RTN","MMRSIPC2",203,0)
 S WARD=0 F  S WARD=$O(^MMRS(104.3,LOC,1,"B",WARD)) Q:'WARD  D
"RTN","MMRSIPC2",204,0)
 .S LOC2=0 F  S LOC2=$O(LCTNS(LOC2)) Q:'LOC2  D
"RTN","MMRSIPC2",205,0)
 ..Q:LOC2=LOC
"RTN","MMRSIPC2",206,0)
 ..I $D(^MMRS(104.3,LOC2,1,"B",WARD)) S RSLT=1
"RTN","MMRSIPC2",207,0)
 Q RSLT
"RTN","MMRSIPC2",208,0)
 ;
"RTN","MMRSIPC2",209,0)
GETLOC(WARD,LCTNS) ;
"RTN","MMRSIPC2",210,0)
 ;
"RTN","MMRSIPC2",211,0)
 N RSLT,LOC
"RTN","MMRSIPC2",212,0)
 ;
"RTN","MMRSIPC2",213,0)
 S RSLT=0
"RTN","MMRSIPC2",214,0)
 S LOC=0 F  S LOC=$O(LCTNS(LOC)) Q:'LOC!(RSLT)  D
"RTN","MMRSIPC2",215,0)
 .I $D(^MMRS(104.3,LOC,1,"B",WARD)) S RSLT=LOC
"RTN","MMRSIPC2",216,0)
 Q RSLT
"RTN","MMRSIPC2",217,0)
 ;
"RTN","MMRSIPC2",218,0)
TRANTYPE(MOVTYPE,TRANTYPE,MOVIEN,DFN) ;
"RTN","MMRSIPC2",219,0)
 ;
"RTN","MMRSIPC2",220,0)
 I MOVTYPE=46!(MOVTYPE=5)!(MOVTYPE=6)!(MOVTYPE=7)!(MOVTYPE=47)!(MOVTYPE=27)!(MOVTYPE=33)!(MOVTYPE=3)!(MOVTYPE=22) Q -1 ;MIA/LMT - Removed MOVTYPE 29 ;4/15/10
"RTN","MMRSIPC2",221,0)
 I MOVTYPE=42!(MOVTYPE=20)!(MOVTYPE=1)!(MOVTYPE=45)!(MOVTYPE=23)!(MOVTYPE=25)!(MOVTYPE=26) Q -1
"RTN","MMRSIPC2",222,0)
 I MOVTYPE=2!(MOVTYPE=43)!(MOVTYPE=13) Q 3
"RTN","MMRSIPC2",223,0)
 I MOVTYPE=14!(MOVTYPE=24)!(MOVTYPE=44) Q 1
"RTN","MMRSIPC2",224,0)
 S TRANTYPE=$$CHKOBS(DFN,MOVIEN,TRANTYPE)
"RTN","MMRSIPC2",225,0)
 Q TRANTYPE
"RTN","MMRSIPC2",226,0)
 ;
"RTN","MMRSIPC2",227,0)
CHKOBS(DFN,MOVIEN,TRANTYPE) ;
"RTN","MMRSIPC2",228,0)
 ; Check if the patient is being discharged from a mixed observation ward (colocated with acute care
"RTN","MMRSIPC2",229,0)
 ; patients) and being immediately admitted to acute care. If yes, we want to consider this
"RTN","MMRSIPC2",230,0)
 ; discharge/admission as an interward transfer.
"RTN","MMRSIPC2",231,0)
 ;
"RTN","MMRSIPC2",232,0)
 ; ZEXCEPT: ODOBS,STRTDT
"RTN","MMRSIPC2",233,0)
 ;
"RTN","MMRSIPC2",234,0)
 N NEXTMOV,NEXTMOVDT,PREVMOV,PREVMOVDT,SPEC,TIMETOADM,VAIP,VAIP2
"RTN","MMRSIPC2",235,0)
 ;
"RTN","MMRSIPC2",236,0)
 I TRANTYPE=2 Q TRANTYPE
"RTN","MMRSIPC2",237,0)
 ;
"RTN","MMRSIPC2",238,0)
 S TIMETOADM=7200  ; 2HRS to allow between obs discharge and acute care admission
"RTN","MMRSIPC2",239,0)
 ;
"RTN","MMRSIPC2",240,0)
 D KVA^VADPT
"RTN","MMRSIPC2",241,0)
 S VAIP("E")=MOVIEN
"RTN","MMRSIPC2",242,0)
 D IN5^VADPT
"RTN","MMRSIPC2",243,0)
 ;
"RTN","MMRSIPC2",244,0)
 S SPEC=$$GET1^DIQ(45.7,+VAIP(8)_",",1,"I") ;ICR 1154 supported
"RTN","MMRSIPC2",245,0)
 I TRANTYPE=3,+$$SPEC^DGPMOBS(SPEC)=1,'$$ONLYOBS(+VAIP(5)) D   ;ICR 2664 supported
"RTN","MMRSIPC2",246,0)
 . S NEXTMOVDT=$O(^DGPM("APTT1",DFN,+VAIP(3)))  ;ICR 2090
"RTN","MMRSIPC2",247,0)
 . S NEXTMOV=$O(^DGPM("APTT1",DFN,+NEXTMOVDT,0))
"RTN","MMRSIPC2",248,0)
 . I 'NEXTMOV Q
"RTN","MMRSIPC2",249,0)
 . D CALLIN5("VAIP2",DFN,NEXTMOV)
"RTN","MMRSIPC2",250,0)
 . I $$FMDIFF^XLFDT(+VAIP2(3),+VAIP(3),2)<TIMETOADM D
"RTN","MMRSIPC2",251,0)
 . . S TRANTYPE=2_U_+VAIP2(5)_U_NEXTMOV_U_VAIP2(16)
"RTN","MMRSIPC2",252,0)
 ;
"RTN","MMRSIPC2",253,0)
 I TRANTYPE=1 D
"RTN","MMRSIPC2",254,0)
 . S PREVMOVDT=$O(^DGPM("APTT3",DFN,+VAIP(3)),-1)
"RTN","MMRSIPC2",255,0)
 . S PREVMOV=$O(^DGPM("APTT3",DFN,+PREVMOVDT,0))
"RTN","MMRSIPC2",256,0)
 . I 'PREVMOV Q
"RTN","MMRSIPC2",257,0)
 . D CALLIN5("VAIP2",DFN,PREVMOV)
"RTN","MMRSIPC2",258,0)
 . S SPEC=$$GET1^DIQ(45.7,+VAIP2(8)_",",1,"I") ;ICR 1154 supported
"RTN","MMRSIPC2",259,0)
 . I +$$SPEC^DGPMOBS(SPEC)=1,'$$ONLYOBS(+VAIP2(5)),$$FMDIFF^XLFDT(+VAIP(3),+VAIP2(3),2)<TIMETOADM D
"RTN","MMRSIPC2",260,0)
 . . S TRANTYPE=2_U_+VAIP2(5)_U_PREVMOV_U_VAIP2(15)
"RTN","MMRSIPC2",261,0)
 . . ; In order not to double count bdoc for one-day obs patients that are admitted to acute care
"RTN","MMRSIPC2",262,0)
 . . ; keep track of these in ODOBS for later adjustment of BDOC.
"RTN","MMRSIPC2",263,0)
 . . ; If patient admitted and discharged from mixed obs on same calendar day
"RTN","MMRSIPC2",264,0)
 . . ; and readmitted to acute care within two hours
"RTN","MMRSIPC2",265,0)
 . . ; and acute care admission is same calendar day as adm/dis from obs
"RTN","MMRSIPC2",266,0)
 . . ; and date falls within reporting period
"RTN","MMRSIPC2",267,0)
 . . I '$G(STRTDT) Q
"RTN","MMRSIPC2",268,0)
 . . I $P(+VAIP2(13,1),".")=$P(+VAIP2(3),"."),$P(+VAIP2(3),".")=$P(+VAIP(3),"."),(STRTDT-.000001)<+VAIP2(13,1) D  Q
"RTN","MMRSIPC2",269,0)
 . . . S ODOBS(+VAIP2(5))=$G(ODOBS(+VAIP2(5)))+1
"RTN","MMRSIPC2",270,0)
 . . ;
"RTN","MMRSIPC2",271,0)
 . . ; if patient admitted to obs on one calendar day and discharged on another
"RTN","MMRSIPC2",272,0)
 . . ; and readmitted to acute care within two hours
"RTN","MMRSIPC2",273,0)
 . . ; and acute care admission is same calendar day as adm/dis from obs
"RTN","MMRSIPC2",274,0)
 . . ; and admitted and discharged from acute care on same calendar day
"RTN","MMRSIPC2",275,0)
 . . ; and date falls within reporting period
"RTN","MMRSIPC2",276,0)
 . . ; deduct one from inpatient discharge ward
"RTN","MMRSIPC2",277,0)
 . . I $P(+VAIP2(13,1),".")'=$P(+VAIP2(3),"."),$P(+VAIP2(3),".")=$P(+VAIP(3),"."),$P(+VAIP(3),".")=$P(+VAIP(17,1),"."),(STRTDT-.000001)<+VAIP(3) D  Q
"RTN","MMRSIPC2",278,0)
 . . . S ODOBS(+VAIP(17,4))=$G(ODOBS(+VAIP(17,4)))+1
"RTN","MMRSIPC2",279,0)
 ;
"RTN","MMRSIPC2",280,0)
 Q TRANTYPE
"RTN","MMRSIPC2",281,0)
 ;
"RTN","MMRSIPC2",282,0)
CALLIN5(RESULT,DFN,MOVIEN) ;
"RTN","MMRSIPC2",283,0)
 ;
"RTN","MMRSIPC2",284,0)
 N VAIP
"RTN","MMRSIPC2",285,0)
 ;
"RTN","MMRSIPC2",286,0)
 S VAIP("E")=MOVIEN
"RTN","MMRSIPC2",287,0)
 S VAIP("V")=RESULT
"RTN","MMRSIPC2",288,0)
 D IN5^VADPT
"RTN","MMRSIPC2",289,0)
 Q
"RTN","MMRSIPC2",290,0)
 ;
"RTN","MMRSIPC2",291,0)
ONLYOBS(WARD) ;
"RTN","MMRSIPC2",292,0)
 ;
"RTN","MMRSIPC2",293,0)
 N ONLYOBS,MMRSLOC
"RTN","MMRSIPC2",294,0)
 ;
"RTN","MMRSIPC2",295,0)
 S ONLYOBS=1
"RTN","MMRSIPC2",296,0)
 ;
"RTN","MMRSIPC2",297,0)
 S MMRSLOC=0
"RTN","MMRSIPC2",298,0)
 F  S MMRSLOC=$O(^MMRS(104.3,MMRSLOC)) Q:'MMRSLOC!('ONLYOBS)  D
"RTN","MMRSIPC2",299,0)
 . I '$D(^MMRS(104.3,MMRSLOC,1,"B",WARD)) Q
"RTN","MMRSIPC2",300,0)
 . I $P($G(^MMRS(104.3,MMRSLOC,0)),U,3)?1(1"AC",1"CLC") S ONLYOBS=0
"RTN","MMRSIPC2",301,0)
 ;
"RTN","MMRSIPC2",302,0)
 Q ONLYOBS
"RTN","MMRSORD")
0^20^B47235280^B42758961
"RTN","MMRSORD",1,0)
MMRSORD ;MIA/LMT - Print ward census showing which patients need a nares swab ;02/15/17  08:34
"RTN","MMRSORD",2,0)
 ;;1.0;MRSA PROGRAM TOOLS;**1,5**;Mar 22, 2009;Build 146
"RTN","MMRSORD",3,0)
 ;
"RTN","MMRSORD",4,0)
MAIN ;
"RTN","MMRSORD",5,0)
 N EXTFLG,MMRSDIV,MMRSLOC
"RTN","MMRSORD",6,0)
 D CHECK^MMRSIPC
"RTN","MMRSORD",7,0)
 D CHECK2^MMRSIPC
"RTN","MMRSORD",8,0)
 I $D(EXTFLG) W ! H 2 Q
"RTN","MMRSORD",9,0)
 W !
"RTN","MMRSORD",10,0)
 S MMRSDIV=$$GETDIV^MMRSIPC Q:$D(EXTFLG)!(MMRSDIV="")
"RTN","MMRSORD",11,0)
 W !
"RTN","MMRSORD",12,0)
 D CHECK3^MMRSIPC
"RTN","MMRSORD",13,0)
 I $D(EXTFLG) W ! H 2 Q
"RTN","MMRSORD",14,0)
 D PROMPT^MMRSISL Q:$D(EXTFLG)
"RTN","MMRSORD",15,0)
 D ASKDVC Q:$D(EXTFLG)
"RTN","MMRSORD",16,0)
 Q
"RTN","MMRSORD",17,0)
MAIN2 ;
"RTN","MMRSORD",18,0)
 N MMRSNOW
"RTN","MMRSORD",19,0)
 D CLEAN
"RTN","MMRSORD",20,0)
 Q:'$D(MMRSDIV)!('$D(MMRSLOC))
"RTN","MMRSORD",21,0)
 S MMRSNOW=$$NOW^XLFDT()
"RTN","MMRSORD",22,0)
 D GETPARAM^MMRSIPC ; Load parameters in temp global
"RTN","MMRSORD",23,0)
 D SETDATA
"RTN","MMRSORD",24,0)
 D PRT
"RTN","MMRSORD",25,0)
 D CLEAN
"RTN","MMRSORD",26,0)
 Q
"RTN","MMRSORD",27,0)
CLEAN ;
"RTN","MMRSORD",28,0)
 K ^TMP($J,"MMRSIPC")
"RTN","MMRSORD",29,0)
 K ^TMP($J,"MMRSORD")
"RTN","MMRSORD",30,0)
 Q
"RTN","MMRSORD",31,0)
SETDATA ;
"RTN","MMRSORD",32,0)
 N LOCATION,LOCNAME,DFN,LOCTYPE,MMRSI,SDRESULT,Y,WLOC,WARD,WARDNAME,VAIP
"RTN","MMRSORD",33,0)
 I $G(MMRSLOC)="ALL" D  Q
"RTN","MMRSORD",34,0)
 .S LOCATION=0 F  S LOCATION=$O(^MMRS(104.3,LOCATION)) Q:'LOCATION  I $P($G(^MMRS(104.3,LOCATION,0)),U,2)=MMRSDIV D
"RTN","MMRSORD",35,0)
 ..S LOCNAME=$P($G(^MMRS(104.3,LOCATION,0)),U,1)
"RTN","MMRSORD",36,0)
 ..S WLOC=0 F  S WLOC=$O(^MMRS(104.3,LOCATION,1,WLOC)) Q:'WLOC  D
"RTN","MMRSORD",37,0)
 ...S WARD=$P($G(^MMRS(104.3,LOCATION,1,WLOC,0)),U,1)
"RTN","MMRSORD",38,0)
 ...Q:'WARD
"RTN","MMRSORD",39,0)
 ...;S WARDNAME=$P($G(^DIC(42,WARD,44)),U,1)
"RTN","MMRSORD",40,0)
 ...;S WARDNAME=$P($G(^SC(+WARDNAME,0)),U,1)
"RTN","MMRSORD",41,0)
 ...S WARDNAME=$P($G(^DIC(42,WARD,0)),U,1)
"RTN","MMRSORD",42,0)
 ...Q:WARDNAME=""
"RTN","MMRSORD",43,0)
 ...S DFN=0 F  S DFN=$O(^DPT("CN",WARDNAME,DFN)) Q:'DFN  D SETDATA2(DFN,LOCATION,LOCNAME)
"RTN","MMRSORD",44,0)
 S LOCATION=0 F  S LOCATION=$O(MMRSLOC(LOCATION)) Q:'LOCATION  D
"RTN","MMRSORD",45,0)
 .S LOCNAME=$P($G(^MMRS(104.3,LOCATION,0)),U,1)
"RTN","MMRSORD",46,0)
 .S WLOC=0 F  S WLOC=$O(^MMRS(104.3,LOCATION,1,WLOC)) Q:'WLOC  D
"RTN","MMRSORD",47,0)
 ..S WARD=$P($G(^MMRS(104.3,LOCATION,1,WLOC,0)),U,1)
"RTN","MMRSORD",48,0)
 ..Q:'WARD
"RTN","MMRSORD",49,0)
 ..;S WARDNAME=$P($G(^DIC(42,WARD,44)),U,1)
"RTN","MMRSORD",50,0)
 ..;S WARDNAME=$P($G(^SC(+WARDNAME,0)),U,1)
"RTN","MMRSORD",51,0)
 ..S WARDNAME=$P($G(^DIC(42,WARD,0)),U,1)
"RTN","MMRSORD",52,0)
 ..Q:WARDNAME=""
"RTN","MMRSORD",53,0)
 ..S DFN=0 F  S DFN=$O(^DPT("CN",WARDNAME,DFN)) Q:'DFN  D SETDATA2(DFN,LOCATION,LOCNAME)
"RTN","MMRSORD",54,0)
 Q
"RTN","MMRSORD",55,0)
SETDATA2(DFN,LOC,LOCNAME) ;
"RTN","MMRSORD",56,0)
 N INTT,IEN,INDATE,INIFN,MRSAMDRO,MRSA,MRSACULT,LABORDER,TSTNM,LABTEST,ORDITM,ORDTEMP,PATNM,VADM
"RTN","MMRSORD",57,0)
 N PREVIEN,PREVWARD
"RTN","MMRSORD",58,0)
 ;Get unit admission date and Transaction Type
"RTN","MMRSORD",59,0)
 D KVA^VADPT
"RTN","MMRSORD",60,0)
 S VAIP("D")=MMRSNOW
"RTN","MMRSORD",61,0)
 D IN5^VADPT
"RTN","MMRSORD",62,0)
 I 'VAIP(1) Q
"RTN","MMRSORD",63,0)
 S INTT=$$TRANTYPE^MMRSIPC2(+VAIP(4),+VAIP(2),VAIP(1),DFN)
"RTN","MMRSORD",64,0)
 S PREVWARD=$P(INTT,U,2)
"RTN","MMRSORD",65,0)
 S PREVIEN=$P(INTT,U,4)
"RTN","MMRSORD",66,0)
 S INTT=$P(INTT,U,1)
"RTN","MMRSORD",67,0)
 I PREVWARD="" S PREVWARD=+VAIP(15,4)
"RTN","MMRSORD",68,0)
 I PREVIEN="" S PREVIEN=VAIP(15)
"RTN","MMRSORD",69,0)
 F  Q:(INTT=1)!(INTT=2&$$CNGWARD^MMRSIPC2(LOC,+VAIP(5),PREVWARD))!(PREVIEN="")  D
"RTN","MMRSORD",70,0)
 .S IEN=+PREVIEN
"RTN","MMRSORD",71,0)
 .D KVA^VADPT
"RTN","MMRSORD",72,0)
 .S VAIP("E")=IEN
"RTN","MMRSORD",73,0)
 .D IN5^VADPT
"RTN","MMRSORD",74,0)
 .S INTT=$$TRANTYPE^MMRSIPC2(+VAIP(4),+VAIP(2),VAIP(1),DFN)
"RTN","MMRSORD",75,0)
 .S PREVWARD=$P(INTT,U,2)
"RTN","MMRSORD",76,0)
 .S PREVIEN=$P(INTT,U,4)
"RTN","MMRSORD",77,0)
 .S INTT=$P(INTT,U,1)
"RTN","MMRSORD",78,0)
 .I PREVWARD="" S PREVWARD=+VAIP(15,4)
"RTN","MMRSORD",79,0)
 .I PREVIEN="" S PREVIEN=VAIP(15)
"RTN","MMRSORD",80,0)
 I INTT<1!(INTT>2) Q
"RTN","MMRSORD",81,0)
 S INDATE=+VAIP(3)
"RTN","MMRSORD",82,0)
 S INIFN=+VAIP(1)
"RTN","MMRSORD",83,0)
 I '$G(INIFN) Q
"RTN","MMRSORD",84,0)
 ;Get MRSA history
"RTN","MMRSORD",85,0)
 S MRSAMDRO=1
"RTN","MMRSORD",86,0)
 S MRSA=$P($$GETLAB^MMRSIPC3(DFN,MRSAMDRO,$$FMADD^XLFDT(MMRSNOW,-365),MMRSNOW,"CD"),U,2)
"RTN","MMRSORD",87,0)
 ;Get Order info
"RTN","MMRSORD",88,0)
 S LABORDER="^^"
"RTN","MMRSORD",89,0)
 S TSTNM="MRSA SURVL NARES DN"
"RTN","MMRSORD",90,0)
 F  S TSTNM=$O(^LAB(60,"B",TSTNM)) Q:TSTNM=""!(TSTNM]"MRSA SURVL NARES DNA~zzz")  D
"RTN","MMRSORD",91,0)
 .I TSTNM'["MRSA SURVL NARES DNA" Q
"RTN","MMRSORD",92,0)
 .S LABTEST=0 F  S LABTEST=$O(^LAB(60,"B",TSTNM,LABTEST)) Q:'LABTEST  D
"RTN","MMRSORD",93,0)
 ..N TESTS D GORDITM(LABTEST,.LABORDER,.TESTS) ;MIA/LMT - Added with patch MMRS*1*1
"RTN","MMRSORD",94,0)
 S TSTNM="MRSA SURVL NARES AGA"
"RTN","MMRSORD",95,0)
 F  S TSTNM=$O(^LAB(60,"B",TSTNM)) Q:TSTNM=""!(TSTNM]"MRSA SURVL NARES AGAR~zzz")  D
"RTN","MMRSORD",96,0)
 .I TSTNM'["MRSA SURVL NARES AGAR" Q
"RTN","MMRSORD",97,0)
 .S LABTEST=0 F  S LABTEST=$O(^LAB(60,"B",TSTNM,LABTEST)) Q:'LABTEST  D
"RTN","MMRSORD",98,0)
 ..N TESTS D GORDITM(LABTEST,.LABORDER,.TESTS) ;MIA/LMT - Added with patch MMRS*1*1
"RTN","MMRSORD",99,0)
 D KVA^VADPT
"RTN","MMRSORD",100,0)
 D DEM^VADPT
"RTN","MMRSORD",101,0)
 S PATNM=VADM(1)
"RTN","MMRSORD",102,0)
 D KVA^VADPT
"RTN","MMRSORD",103,0)
 S ^TMP($J,"MMRSORD",LOCNAME,PATNM,DFN)=INDATE_U_INTT_U_MRSA_U_LABORDER
"RTN","MMRSORD",104,0)
 Q
"RTN","MMRSORD",105,0)
GORDITM(LABTEST,LABORDER,TESTS) ;MIA/LMT - Added with patch MMRS*1*1 - Include panels in search
"RTN","MMRSORD",106,0)
 N ORDITM,ORDTEMP,LABPANEL
"RTN","MMRSORD",107,0)
 I $D(TESTS(LABTEST)) Q  ;prevent infinite recursion; if site has Panel A within Panel B, and Panel B within Panel A
"RTN","MMRSORD",108,0)
 S TESTS(LABTEST)=1 ;mark that we have searched this test (to prevent infinite recursion)
"RTN","MMRSORD",109,0)
 S ORDITM=0 F  S ORDITM=$O(^ORD(101.43,"ID",LABTEST_";99LRT",ORDITM)) Q:'ORDITM  D
"RTN","MMRSORD",110,0)
 .S ORDTEMP=$$GETORD(DFN,ORDITM,INDATE)
"RTN","MMRSORD",111,0)
 .I $P(LABORDER,U,1)'="YES"!(($P(LABORDER,U,3)'="YES")&($P(ORDTEMP,U,3)="YES")) S LABORDER=ORDTEMP
"RTN","MMRSORD",112,0)
 S LABPANEL=0 F  S LABPANEL=$O(^LAB(60,"AB",LABTEST,LABPANEL)) Q:'LABPANEL  D
"RTN","MMRSORD",113,0)
 .D GORDITM(LABPANEL,.LABORDER,.TESTS) ;Recursive call to check for tests within panels
"RTN","MMRSORD",114,0)
 Q
"RTN","MMRSORD",115,0)
GETORD(DFN,ORDITM,INDATE) ;
"RTN","MMRSORD",116,0)
 N RESULT,START,STOP,DAS,STATUS,ORUPCHUK,LABREC
"RTN","MMRSORD",117,0)
 S RESULT="^^"
"RTN","MMRSORD",118,0)
 S START=$$FMADD^XLFDT(INDATE,-1)-.0000001
"RTN","MMRSORD",119,0)
 F  S START=$O(^PXRMINDX(100,"PI",DFN,ORDITM,START)) Q:'START  D
"RTN","MMRSORD",120,0)
 .S STOP="" F  S STOP=$O(^PXRMINDX(100,"PI",DFN,ORDITM,START,STOP)) Q:STOP=""  D
"RTN","MMRSORD",121,0)
 ..S DAS="" F  S DAS=$O(^PXRMINDX(100,"PI",DFN,ORDITM,START,STOP,DAS)) Q:DAS=""  D
"RTN","MMRSORD",122,0)
 ...D EN^ORX8(+DAS)
"RTN","MMRSORD",123,0)
 ...S STATUS=$P(ORUPCHUK("ORSTS"),U,1)
"RTN","MMRSORD",124,0)
 ...I STATUS'=2,STATUS'=5,STATUS'=6 Q
"RTN","MMRSORD",125,0)
 ...S LABREC="NO"
"RTN","MMRSORD",126,0)
 ...I STATUS=6!(STATUS=2) S LABREC="YES"
"RTN","MMRSORD",127,0)
 ...I $P(RESULT,U,3)'="YES" S RESULT="YES^"_START_U_LABREC
"RTN","MMRSORD",128,0)
 Q RESULT
"RTN","MMRSORD",129,0)
PRT ;
"RTN","MMRSORD",130,0)
 N LN,PG,LOCNAME,PATNM,DFN,NODE,LAST4,INTT,ADT,ORDDATE,VADM
"RTN","MMRSORD",131,0)
 ;^TMP($J,"MMRSORD",LOCNAME,PATNM,DFN)=INDATE_U_INTT_U_MRSA_U_LAB
"RTN","MMRSORD",132,0)
 S $P(LN,"-",101)=""
"RTN","MMRSORD",133,0)
 S PG=1
"RTN","MMRSORD",134,0)
 S LOCNAME="" F  S LOCNAME=$O(^TMP($J,"MMRSORD",LOCNAME)) Q:LOCNAME=""  D
"RTN","MMRSORD",135,0)
 .D PRTHDRS S PATNM="" F  S PATNM=$O(^TMP($J,"MMRSORD",LOCNAME,PATNM)) Q:PATNM=""  D
"RTN","MMRSORD",136,0)
 ..S DFN=0 F  S DFN=$O(^TMP($J,"MMRSORD",LOCNAME,PATNM,DFN)) Q:'DFN  D
"RTN","MMRSORD",137,0)
 ...S NODE=$G(^TMP($J,"MMRSORD",LOCNAME,PATNM,DFN))
"RTN","MMRSORD",138,0)
 ...D KVA^VADPT
"RTN","MMRSORD",139,0)
 ...D DEM^VADPT
"RTN","MMRSORD",140,0)
 ...S LAST4=$E($P(VADM(2),U),6,9)
"RTN","MMRSORD",141,0)
 ...D KVA^VADPT
"RTN","MMRSORD",142,0)
 ...S INTT=$P(NODE,U,2)
"RTN","MMRSORD",143,0)
 ...S ADT=$S(INTT=1:"A",INTT=2:"T",1:"")
"RTN","MMRSORD",144,0)
 ...S ORDDATE=$P(NODE,"^",5)
"RTN","MMRSORD",145,0)
 ...I ORDDATE S ORDDATE=$$FMTE^XLFDT(ORDDATE,"2M")
"RTN","MMRSORD",146,0)
 ...W !,$E(PATNM,1,23),?25,LAST4,?32,$$FMTE^XLFDT($P(NODE,"^",1),"2M"),?48,ADT,?53,$P($P(NODE,"^",3),";",1),?65,$P(NODE,"^",4)
"RTN","MMRSORD",147,0)
 ...W ?75,ORDDATE,?91,$P(NODE,"^",6)
"RTN","MMRSORD",148,0)
 ...I $Y+2>IOSL D PRTHDRS
"RTN","MMRSORD",149,0)
 Q
"RTN","MMRSORD",150,0)
PRTHDRS ; Helper Function for PRT - Prints report headers
"RTN","MMRSORD",151,0)
 W @IOF
"RTN","MMRSORD",152,0)
 W ?13,"NARES SWAB ORDER LIST"
"RTN","MMRSORD",153,0)
 W !,?13,"Geographical Location: ",LOCNAME
"RTN","MMRSORD",154,0)
 W !,?13,"Report printed on: ",$$FMTE^XLFDT(MMRSNOW),?75,"PAGE: ",PG
"RTN","MMRSORD",155,0)
 W !!,?32,"DATE",?53,"MRSA IN",?65,"NARES",?91,"LAB"
"RTN","MMRSORD",156,0)
 W !,"PATIENT",?25,"SSN",?32,"ENTERED WARD",?48,"ADT",?53,"PAST YEAR",?65,"ORDERED",?75,"ORDER DATE",?91,"RECEIVED"
"RTN","MMRSORD",157,0)
 W !,LN
"RTN","MMRSORD",158,0)
 S PG=PG+1
"RTN","MMRSORD",159,0)
 Q
"RTN","MMRSORD",160,0)
ASKDVC ;Prompts user for device of output (allows queuing)
"RTN","MMRSORD",161,0)
 N MMRSVAR,ZTSK
"RTN","MMRSORD",162,0)
 W !!!,"This report is designed for a 132 column format (compressed).",!
"RTN","MMRSORD",163,0)
 S MMRSVAR("MMRSLOC")="",MMRSVAR("MMRSLOC(")="",MMRSVAR("MMRSDIV")=""
"RTN","MMRSORD",164,0)
 D EN^XUTMDEVQ("MAIN2^MMRSORD","Print nares swab order list (MMRSORD)",.MMRSVAR,"QM",1)
"RTN","MMRSORD",165,0)
 W:$D(ZTSK) !,"Report Queued to Print ("_ZTSK_").",!
"RTN","MMRSORD",166,0)
 Q
"VER")
8.0^22.0
"BLD",9428,6)
^5
**END**
**END**

